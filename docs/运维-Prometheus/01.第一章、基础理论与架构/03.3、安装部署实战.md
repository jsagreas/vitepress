---
title: 3ã€å®‰è£…éƒ¨ç½²å®žæˆ˜
---
## ðŸ“š ç›®å½•

1. [å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ](#1-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ)
2. [äºŒè¿›åˆ¶å®‰è£…æ­¥éª¤è¯¦è§£](#2-äºŒè¿›åˆ¶å®‰è£…æ­¥éª¤è¯¦è§£)
3. [Dockerå®¹å™¨åŒ–éƒ¨ç½²](#3-Dockerå®¹å™¨åŒ–éƒ¨ç½²)
4. [Kubernetesé›†ç¾¤éƒ¨ç½²](#4-Kubernetesé›†ç¾¤éƒ¨ç½²)
5. [é…ç½®æ–‡ä»¶è¯¦è§£](#5-é…ç½®æ–‡ä»¶è¯¦è§£)
6. [å¯åŠ¨å‚æ•°ä¸Žè°ƒä¼˜](#6-å¯åŠ¨å‚æ•°ä¸Žè°ƒä¼˜)
7. [åŸºç¡€è¿ç»´æ“ä½œ](#7-åŸºç¡€è¿ç»´æ“ä½œ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ› ï¸ å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ


### 1.1 ç†è§£Prometheusæ˜¯ä»€ä¹ˆ


**ç®€å•æ¥è¯´**ï¼šPrometheuså°±åƒæ˜¯ä¸€ä¸ª"æ•°æ®æ”¶é›†å‘˜"ï¼Œå®ƒä¼šå®šæœŸåŽ»å„ä¸ªç³»ç»Ÿé‚£é‡Œ"é—®å€™"ä¸€ä¸‹ï¼š
- "ä½ å¥½ï¼ŒCPUçŽ°åœ¨ç”¨äº†å¤šå°‘ï¼Ÿ"
- "å†…å­˜è¿˜å‰©å¤šå°‘ï¼Ÿ"  
- "ç½‘ç»œæµé‡æ€Žä¹ˆæ ·ï¼Ÿ"

ç„¶åŽæŠŠè¿™äº›ç­”æ¡ˆè®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿æˆ‘ä»¬éšæ—¶æŸ¥çœ‹ç³»ç»Ÿçš„"å¥åº·çŠ¶å†µ"ã€‚

### 1.2 ç³»ç»ŸçŽ¯å¢ƒè¦æ±‚


**ðŸ”§ ç¡¬ä»¶å»ºè®®**
```
æœ€å°é…ç½®ï¼ˆå­¦ä¹ çŽ¯å¢ƒï¼‰ï¼š
CPU: 2æ ¸å¿ƒ
å†…å­˜: 4GB
ç£ç›˜: 20GB

ç”Ÿäº§çŽ¯å¢ƒå»ºè®®ï¼š
CPU: 4æ ¸å¿ƒæˆ–ä»¥ä¸Š
å†…å­˜: 8GBæˆ–ä»¥ä¸Š  
ç£ç›˜: 100GBæˆ–ä»¥ä¸Šï¼ˆæ•°æ®å¢žé•¿å¾ˆå¿«ï¼‰
```

**ðŸ’» æ“ä½œç³»ç»Ÿæ”¯æŒ**
| ç³»ç»Ÿ | ç‰ˆæœ¬è¦æ±‚ | æŽ¨èç¨‹åº¦ |
|------|----------|----------|
| `ðŸ§ Linux` | CentOS 7+, Ubuntu 16+ | â­â­â­â­â­ |
| `ðŸªŸ Windows` | Windows 10+ | â­â­â­ |
| `ðŸŽ macOS` | 10.14+ | â­â­â­â­ |

### 1.3 ç½‘ç»œç«¯å£è§„åˆ’


```
PrometheusæœåŠ¡ç«¯å£åˆ†é…ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9090  â†’ Prometheus Webç•Œé¢      â”‚
â”‚ 9091  â†’ Pushgateway            â”‚  
â”‚ 9093  â†’ Alertmanager           â”‚
â”‚ 9100  â†’ Node Exporter          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ðŸ’¡ **æ–°æ‰‹æç¤º**
> 
> è¿™äº›ç«¯å£å°±åƒæˆ¿é—´å·ç ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„"æˆ¿é—´"ã€‚ç¡®ä¿è¿™äº›ç«¯å£æ²¡æœ‰è¢«å…¶ä»–ç¨‹åºå ç”¨ï¼

---

## 2. ðŸ”§ äºŒè¿›åˆ¶å®‰è£…æ­¥éª¤è¯¦è§£


### 2.1 ä¸‹è½½Prometheus


**ç¬¬ä¸€æ­¥ï¼šèŽ·å–å®‰è£…åŒ…**

è®¿é—®å®˜ç½‘æˆ–ä½¿ç”¨å‘½ä»¤ä¸‹è½½ï¼š
```bash
# åˆ›å»ºå·¥ä½œç›®å½•ï¼ˆå°±åƒå‡†å¤‡ä¸€ä¸ªä¸“é—¨çš„æ–‡ä»¶å¤¹ï¼‰
mkdir -p /opt/prometheus
cd /opt/prometheus

# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆæ›¿æ¢ä¸ºå®žé™…ç‰ˆæœ¬å·ï¼‰
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**
> 
> å¦‚æžœç½‘ç»œä¸‹è½½æ…¢ï¼Œå¯ä»¥åœ¨æœ¬åœ°ç”µè„‘ä¸‹è½½åŽä¸Šä¼ åˆ°æœåŠ¡å™¨

### 2.2 è§£åŽ‹å’Œå®‰è£…


**ç¬¬äºŒæ­¥ï¼šè§£åŽ‹æ–‡ä»¶**
```bash
# è§£åŽ‹ä¸‹è½½çš„æ–‡ä»¶  
tar -zxvf prometheus-2.45.0.linux-amd64.tar.gz

# é‡å‘½åä¸ºç®€å•åç§°ï¼ˆæ–¹ä¾¿è®°å¿†ï¼‰
mv prometheus-2.45.0.linux-amd64 prometheus

# æŸ¥çœ‹è§£åŽ‹åŽçš„å†…å®¹
ls -la prometheus/
```

**ðŸ“ è§£åŽ‹åŽçš„æ–‡ä»¶ç»“æž„**
```
prometheus/
â”œâ”€â”€ ðŸ“„ prometheus          # ä¸»ç¨‹åºï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰
â”œâ”€â”€ ðŸ“„ promtool            # é…ç½®æ£€æŸ¥å·¥å…·  
â”œâ”€â”€ ðŸ“ console_libraries/  # Webç•Œé¢åº“æ–‡ä»¶
â”œâ”€â”€ ðŸ“ consoles/           # æŽ§åˆ¶å°æ¨¡æ¿
â”œâ”€â”€ ðŸ“„ prometheus.yml      # é…ç½®æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
â””â”€â”€ ðŸ“„ LICENSE             # è®¸å¯è¯æ–‡ä»¶
```

### 2.3 åˆ›å»ºç”¨æˆ·å’Œç›®å½•


**ç¬¬ä¸‰æ­¥ï¼šå®‰å…¨é…ç½®**
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
sudo useradd --no-create-home --shell /bin/false prometheus

# åˆ›å»ºå¿…è¦ç›®å½•
sudo mkdir -p /etc/prometheus       # é…ç½®æ–‡ä»¶ç›®å½•
sudo mkdir -p /var/lib/prometheus   # æ•°æ®å­˜å‚¨ç›®å½•

# è®¾ç½®ç›®å½•æƒé™
sudo chown prometheus:prometheus /etc/prometheus
sudo chown prometheus:prometheus /var/lib/prometheus
```

**ðŸ”’ ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼Ÿ**
- å°±åƒç»™Prometheusä¸€ä¸ªä¸“é—¨çš„"èº«ä»½è¯"
- æé«˜å®‰å…¨æ€§ï¼Œé™åˆ¶æƒé™èŒƒå›´
- é˜²æ­¢ç¨‹åºè®¿é—®ä¸è¯¥è®¿é—®çš„æ–‡ä»¶

### 2.4 å¤åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•


**ç¬¬å››æ­¥ï¼šæ–‡ä»¶éƒ¨ç½²**
```bash
# å¤åˆ¶ä¸»ç¨‹åºåˆ°ç³»ç»Ÿè·¯å¾„
sudo cp prometheus/prometheus /usr/local/bin/
sudo cp prometheus/promtool /usr/local/bin/

# å¤åˆ¶Webç•Œé¢æ–‡ä»¶
sudo cp -r prometheus/consoles /etc/prometheus/
sudo cp -r prometheus/console_libraries /etc/prometheus/

# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp prometheus/prometheus.yml /etc/prometheus/

# è®¾ç½®å¯æ‰§è¡Œæƒé™
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool
sudo chown -R prometheus:prometheus /etc/prometheus/
```

### 2.5 åˆ›å»ºç³»ç»ŸæœåŠ¡


**ç¬¬äº”æ­¥ï¼šå¼€æœºè‡ªå¯åŠ¨é…ç½®**

åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼š
```bash
sudo vim /etc/systemd/system/prometheus.service
```

æœåŠ¡é…ç½®å†…å®¹ï¼š
```ini
[Unit]
Description=Prometheus ç›‘æŽ§ç³»ç»Ÿ
Documentation=https://prometheus.io/docs/
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=prometheus
Group=prometheus
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --web.console.templates=/etc/prometheus/consoles \
  --web.console.libraries=/etc/prometheus/console_libraries \
  --web.listen-address=0.0.0.0:9090
  
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

**ðŸ“ é…ç½®è§£é‡Š**
| å‚æ•° | ä½œç”¨ | é€šä¿—è§£é‡Š |
|------|------|----------|
| `--config.file` | æŒ‡å®šé…ç½®æ–‡ä»¶ | å‘Šè¯‰Prometheusè§„åˆ™åœ¨å“ªé‡Œ |
| `--storage.tsdb.path` | æ•°æ®å­˜å‚¨ä½ç½® | æ•°æ®ä¿å­˜çš„"ä»“åº“"åœ°å€ |
| `--web.listen-address` | Webç•Œé¢åœ°å€ | æµè§ˆå™¨è®¿é—®çš„"é—¨ç‰Œå·" |

### 2.6 å¯åŠ¨å’ŒéªŒè¯æœåŠ¡


**ç¬¬å…­æ­¥ï¼šå¯åŠ¨æœåŠ¡**
```bash
# é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡é…ç½®
sudo systemctl daemon-reload

# å¯åŠ¨PrometheusæœåŠ¡
sudo systemctl start prometheus

# è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
sudo systemctl enable prometheus

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status prometheus
```

**âœ… éªŒè¯å®‰è£…æˆåŠŸ**

**æ–¹æ³•1ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€**
```bash
sudo systemctl status prometheus
```
çœ‹åˆ° `Active: active (running)` å°±è¡¨ç¤ºæˆåŠŸäº†ï¼

**æ–¹æ³•2ï¼šæ£€æŸ¥ç«¯å£ç›‘å¬**
```bash
sudo netstat -tlnp | grep 9090
```

**æ–¹æ³•3ï¼šè®¿é—®Webç•Œé¢**
- æ‰“å¼€æµè§ˆå™¨
- è®¿é—®ï¼š`http://ä½ çš„æœåŠ¡å™¨IP:9090`
- çœ‹åˆ°Prometheusç•Œé¢å°±æˆåŠŸäº†ï¼

---

## 3. ðŸ³ Dockerå®¹å™¨åŒ–éƒ¨ç½²


### 3.1 Dockeréƒ¨ç½²çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆé€‰æ‹©Dockerï¼Ÿ**
- ðŸš€ **éƒ¨ç½²ç®€å•**ï¼šä¸€æ¡å‘½ä»¤æžå®š
- ðŸ”„ **çŽ¯å¢ƒä¸€è‡´**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§çŽ¯å¢ƒå®Œå…¨ç›¸åŒ
- ðŸ“¦ **èµ„æºéš”ç¦»**ï¼šä¸ä¼šå½±å“å®¿ä¸»æœºå…¶ä»–æœåŠ¡
- ðŸ›¡ï¸ **æ˜“äºŽç®¡ç†**ï¼šå¯åŠ¨ã€åœæ­¢ã€æ›´æ–°éƒ½å¾ˆæ–¹ä¾¿

### 3.2 å•å®¹å™¨å¿«é€Ÿéƒ¨ç½²


**æœ€ç®€å•çš„å¯åŠ¨æ–¹å¼**
```bash
# ä¸€é”®å¯åŠ¨Prometheus
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  prom/prometheus:latest
```

**ðŸ’¡ å‘½ä»¤è§£é‡Š**
- `-d`: åŽå°è¿è¡Œï¼ˆdetached modeï¼‰
- `--name`: ç»™å®¹å™¨èµ·ä¸ªåå­—
- `-p 9090:9090`: ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰
- `prom/prometheus:latest`: å®˜æ–¹é•œåƒ

### 3.3 æŒ‚è½½é…ç½®æ–‡ä»¶éƒ¨ç½²


**æ›´å®žç”¨çš„éƒ¨ç½²æ–¹å¼**
```bash
# 1. åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /opt/prometheus/config
mkdir -p /opt/prometheus/data

# 2. åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/prometheus/config/prometheus.yml << EOF
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
EOF

# 3. å¯åŠ¨å®¹å™¨å¹¶æŒ‚è½½é…ç½®
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v /opt/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml \
  -v /opt/prometheus/data:/prometheus \
  prom/prometheus:latest \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/prometheus
```

### 3.4 Docker Composeéƒ¨ç½²


**ðŸ“„ åˆ›å»º docker-compose.yml**
```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    
  # å¯é€‰ï¼šæ·»åŠ Node Exporterç›‘æŽ§å®¿ä¸»æœº
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    restart: unless-stopped
```

**ðŸš€ å¯åŠ¨æœåŠ¡**
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs prometheus
```

---

## 4. â˜¸ï¸ Kubernetesé›†ç¾¤éƒ¨ç½²


### 4.1 å‘½åç©ºé—´åˆ›å»º


**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç‹¬ç«‹å‘½åç©ºé—´**
```yaml
# namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    name: monitoring
```

```bash
kubectl apply -f namespace.yaml
```

### 4.2 ConfigMapé…ç½®


**ç¬¬äºŒæ­¥ï¼šé…ç½®æ–‡ä»¶ç®¡ç†**
```yaml
# prometheus-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - source_labels: [__address__]
            regex: '(.*):10250'
            target_label: __address__
            replacement: '${1}:9100'
```

### 4.3 Deploymentéƒ¨ç½²


**ç¬¬ä¸‰æ­¥ï¼šåº”ç”¨éƒ¨ç½²**
```yaml
# prometheus-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config-volume
          mountPath: /etc/prometheus
        - name: storage-volume
          mountPath: /prometheus
        args:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--web.console.templates=/etc/prometheus/consoles'
          - '--web.console.libraries=/etc/prometheus/console_libraries'
          - '--web.enable-lifecycle'
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-config
      - name: storage-volume
        emptyDir: {}
```

### 4.4 Serviceæš´éœ²


**ç¬¬å››æ­¥ï¼šæœåŠ¡æš´éœ²**
```yaml
# prometheus-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus-service
  namespace: monitoring
spec:
  selector:
    app: prometheus
  ports:
    - protocol: TCP
      port: 9090
      targetPort: 9090
      nodePort: 30090
  type: NodePort
```

**ðŸš€ éƒ¨ç½²å‘½ä»¤**
```bash
# åº”ç”¨æ‰€æœ‰é…ç½®
kubectl apply -f prometheus-config.yaml
kubectl apply -f prometheus-deployment.yaml
kubectl apply -f prometheus-service.yaml

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
kubectl get pods -n monitoring
kubectl get svc -n monitoring
```

---

## 5. âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£


### 5.1 prometheus.ymlç»“æž„è§£æž


**ðŸ—ï¸ é…ç½®æ–‡ä»¶æž¶æž„**
```
prometheus.yml
â”œâ”€â”€ global          # å…¨å±€é…ç½®
â”œâ”€â”€ rule_files      # å‘Šè­¦è§„åˆ™æ–‡ä»¶  
â”œâ”€â”€ scrape_configs  # æ•°æ®é‡‡é›†é…ç½®
â””â”€â”€ alerting        # å‘Šè­¦ç®¡ç†é…ç½®
```

### 5.2 globalå…¨å±€é…ç½®


**åŸºç¡€å…¨å±€é…ç½®**
```yaml
global:
  # æ•°æ®é‡‡é›†é—´éš”ï¼ˆé»˜è®¤1åˆ†é’Ÿï¼‰
  scrape_interval: 15s
  
  # è§„åˆ™è¯„ä¼°é—´éš”  
  evaluation_interval: 15s
  
  # æ·»åŠ åˆ°æ‰€æœ‰æŒ‡æ ‡çš„æ ‡ç­¾
  external_labels:
    cluster: 'production'
    region: 'us-west-1'
```

**ðŸ“Š å‚æ•°è¯´æ˜Ž**
| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ | æ–°æ‰‹å»ºè®® |
|------|--------|------|----------|
| `scrape_interval` | 1m | å¤šä¹…é‡‡é›†ä¸€æ¬¡æ•°æ® | 15sï¼ˆæµ‹è¯•ï¼‰60sï¼ˆç”Ÿäº§ï¼‰ |
| `evaluation_interval` | 1m | å¤šä¹…è¯„ä¼°ä¸€æ¬¡è§„åˆ™ | ä¸Žscrape_intervalç›¸åŒ |
| `external_labels` | æ—  | æ ‡è¯†é›†ç¾¤ä¿¡æ¯ | ç”Ÿäº§çŽ¯å¢ƒå¿…é¡»é…ç½® |

### 5.3 scrape_configsé‡‡é›†é…ç½®


**ðŸ“¡ æ•°æ®é‡‡é›†æºé…ç½®**

**ç›‘æŽ§è‡ªèº«**
```yaml
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

**ç›‘æŽ§LinuxæœåŠ¡å™¨**
```yaml
  - job_name: 'linux-servers'
    static_configs:
      - targets: 
          - '192.168.1.10:9100'  # æœåŠ¡å™¨1
          - '192.168.1.11:9100'  # æœåŠ¡å™¨2
    scrape_interval: 30s
    metrics_path: /metrics
```

**ç›‘æŽ§Webåº”ç”¨**
```yaml
  - job_name: 'web-app'
    static_configs:
      - targets: ['app1.example.com:8080']
    scrape_interval: 10s
    scrape_timeout: 5s
```

### 5.4 é«˜çº§é…ç½®ç¤ºä¾‹


**ðŸ”§ å®Œæ•´ç”Ÿäº§é…ç½®æ¨¡æ¿**
```yaml
# ç”Ÿäº§çŽ¯å¢ƒé…ç½®ç¤ºä¾‹
global:
  scrape_interval: 30s
  evaluation_interval: 30s
  external_labels:
    cluster: 'prod-cluster'
    environment: 'production'

# å‘Šè­¦è§„åˆ™æ–‡ä»¶
rule_files:
  - "/etc/prometheus/rules/*.yml"

# å‘Šè­¦ç®¡ç†å™¨é…ç½®
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093

# æ•°æ®é‡‡é›†é…ç½®
scrape_configs:
  # Prometheusè‡ªç›‘æŽ§
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
  
  # æœåŠ¡å™¨ç›‘æŽ§
  - job_name: 'node-exporter'
    static_configs:
      - targets:
          - 'node1:9100'
          - 'node2:9100'
          - 'node3:9100'
    scrape_interval: 30s
    
  # åº”ç”¨ç›‘æŽ§
  - job_name: 'webapp'
    static_configs:
      - targets: ['webapp:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 15s
```

### 5.5 é…ç½®éªŒè¯


**ðŸ” æ£€æŸ¥é…ç½®æ­£ç¡®æ€§**
```bash
# éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
./promtool check config prometheus.yml

# æ£€æŸ¥è§„åˆ™æ–‡ä»¶
./promtool check rules /etc/prometheus/rules/*.yml

# é‡æ–°åŠ è½½é…ç½®ï¼ˆä¸é‡å¯æœåŠ¡ï¼‰
curl -X POST http://localhost:9090/-/reload
```

---

## 6. ðŸŽ›ï¸ å¯åŠ¨å‚æ•°ä¸Žè°ƒä¼˜


### 6.1 æ ¸å¿ƒå¯åŠ¨å‚æ•°


**ðŸ“‹ å¸¸ç”¨å¯åŠ¨å‚æ•°**
| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ | è°ƒä¼˜å»ºè®® |
|------|--------|------|----------|
| `--config.file` | prometheus.yml | é…ç½®æ–‡ä»¶è·¯å¾„ | å¿…é¡»æŒ‡å®š |
| `--storage.tsdb.path` | data/ | æ•°æ®å­˜å‚¨è·¯å¾„ | ä½¿ç”¨SSD |
| `--storage.tsdb.retention.time` | 15d | æ•°æ®ä¿ç•™æ—¶é—´ | æ ¹æ®ç£ç›˜å®¹é‡è°ƒæ•´ |
| `--web.listen-address` | :9090 | Webç›‘å¬åœ°å€ | ç”Ÿäº§çŽ¯å¢ƒç»‘å®šå…·ä½“IP |
| `--web.max-connections` | 512 | æœ€å¤§è¿žæŽ¥æ•° | é«˜å¹¶å‘æ—¶å¢žåŠ  |

### 6.2 å­˜å‚¨è°ƒä¼˜å‚æ•°


**ðŸ’¾ å­˜å‚¨æ€§èƒ½ä¼˜åŒ–**
```bash
prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/ \
  --storage.tsdb.retention.time=30d \
  --storage.tsdb.retention.size=10GB \
  --storage.tsdb.wal-compression \
  --web.listen-address=0.0.0.0:9090
```

**ðŸŽ¯ å­˜å‚¨å‚æ•°è§£é‡Š**
- `retention.time`: æ•°æ®ä¿ç•™30å¤©
- `retention.size`: æœ€å¤§å­˜å‚¨10GB
- `wal-compression`: å¯ç”¨WALåŽ‹ç¼©ï¼ˆèŠ‚çœç©ºé—´ï¼‰

### 6.3 å†…å­˜è°ƒä¼˜å‚æ•°


**ðŸ§  å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
```bash
# å¤§å†…å­˜çŽ¯å¢ƒä¼˜åŒ–
prometheus \
  --storage.tsdb.head-chunks-write-queue-size=10000 \
  --storage.tsdb.max-block-duration=2h \
  --storage.tsdb.min-block-duration=2h \
  --query.max-concurrency=20 \
  --query.max-samples=50000000
```

### 6.4 æ€§èƒ½ç›‘æŽ§æŒ‡æ ‡


**ðŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**
```
å†…å­˜ä½¿ç”¨ç›‘æŽ§ï¼š
prometheus_tsdb_head_series          # å†…å­˜ä¸­çš„æ—¶é—´åºåˆ—æ•°
prometheus_tsdb_head_samples_appended_total  # æ ·æœ¬è¿½åŠ é€ŸçŽ‡

å­˜å‚¨ç›‘æŽ§ï¼š
prometheus_tsdb_symbol_table_size_bytes      # ç¬¦å·è¡¨å¤§å°
prometheus_tsdb_wal_size_bytes               # WALæ–‡ä»¶å¤§å°

æŸ¥è¯¢æ€§èƒ½ï¼š
prometheus_engine_query_duration_seconds     # æŸ¥è¯¢è€—æ—¶
prometheus_engine_queries                    # å¹¶å‘æŸ¥è¯¢æ•°
```

---

## 7. ðŸ”§ åŸºç¡€è¿ç»´æ“ä½œ


### 7.1 æ—¥å¸¸ç»´æŠ¤å‘½ä»¤


**ðŸ”„ æœåŠ¡ç®¡ç†**
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status prometheus

# å¯åŠ¨/åœæ­¢/é‡å¯æœåŠ¡
sudo systemctl start prometheus
sudo systemctl stop prometheus  
sudo systemctl restart prometheus

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u prometheus -f

# é‡æ–°åŠ è½½é…ç½®ï¼ˆçƒ­æ›´æ–°ï¼‰
curl -X POST http://localhost:9090/-/reload
```

### 7.2 æ•°æ®å¤‡ä»½ç­–ç•¥


**ðŸ’¾ æ•°æ®å¤‡ä»½æ–¹æ¡ˆ**

**æ–¹æ¡ˆä¸€ï¼šå¿«ç…§å¤‡ä»½**
```bash
# åˆ›å»ºå¿«ç…§
curl -X POST http://localhost:9090/api/v1/admin/tsdb/snapshot

# å¿«ç…§å­˜å‚¨ä½ç½®
ls /var/lib/prometheus/snapshots/

# å¤‡ä»½å¿«ç…§
tar -czf prometheus-backup-$(date +%Y%m%d).tar.gz \
  /var/lib/prometheus/snapshots/latest/
```

**æ–¹æ¡ˆäºŒï¼šå®šæœŸæ•°æ®å¤‡ä»½**
```bash
#!/bin/bash
# backup_prometheus.sh

BACKUP_DIR="/backup/prometheus"
DATA_DIR="/var/lib/prometheus"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# åœæ­¢æœåŠ¡
systemctl stop prometheus

# å¤‡ä»½æ•°æ®
tar -czf $BACKUP_DIR/prometheus_backup_$DATE.tar.gz $DATA_DIR

# å¯åŠ¨æœåŠ¡
systemctl start prometheus

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "prometheus_backup_*.tar.gz" -mtime +7 -delete
```

### 7.3 ç›‘æŽ§å‘Šè­¦é…ç½®


**âš ï¸ åŸºç¡€å‘Šè­¦è§„åˆ™**
```yaml
# /etc/prometheus/rules/basic.yml
groups:
  - name: prometheus.basic
    rules:
      # PrometheusæœåŠ¡å¼‚å¸¸
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PrometheusæœåŠ¡å·²åœæ­¢"
          description: "Prometheuså·²ç»åœæ­¢è¿è¡Œè¶…è¿‡1åˆ†é’Ÿ"
      
      # æ•°æ®é‡‡é›†å¤±è´¥
      - alert: TargetDown
        expr: up == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ç›‘æŽ§ç›®æ ‡æ— æ³•è®¿é—®"
          description: "{{ $labels.instance }} æ— æ³•è®¿é—®è¶…è¿‡5åˆ†é’Ÿ"
```

### 7.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ æ€§èƒ½ä¼˜åŒ–æ¸…å•**

**å­˜å‚¨ä¼˜åŒ–**
- âœ… ä½¿ç”¨SSDå­˜å‚¨
- âœ… å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- âœ… å¯ç”¨æ•°æ®åŽ‹ç¼©
- âœ… åˆç†è§„åˆ’retentionç­–ç•¥

**é‡‡é›†ä¼˜åŒ–**
- âœ… è°ƒæ•´scrape_intervalåˆ°åˆç†å€¼
- âœ… ç§»é™¤ä¸å¿…è¦çš„æŒ‡æ ‡
- âœ… ä½¿ç”¨relabel_configsè¿‡æ»¤æ•°æ®
- âœ… é¿å…é«˜åŸºæ•°æ ‡ç­¾

**æŸ¥è¯¢ä¼˜åŒ–**
- âœ… é™åˆ¶æŸ¥è¯¢èŒƒå›´
- âœ… ä½¿ç”¨recording rulesé¢„è®¡ç®—
- âœ… é¿å…å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼
- âœ… åˆç†è®¾ç½®æŸ¥è¯¢è¶…æ—¶

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ å®‰è£…æ–¹å¼ï¼šäºŒè¿›åˆ¶ã€Dockerã€Kubernetesä¸‰ç§ä¸»æµæ–¹å¼
ðŸ”¸ é…ç½®æ–‡ä»¶ï¼šprometheus.ymlæ˜¯æ ¸å¿ƒï¼Œå†³å®šç›‘æŽ§ä»€ä¹ˆå’Œæ€Žä¹ˆç›‘æŽ§
ðŸ”¸ ç«¯å£è§„åˆ’ï¼š9090æ˜¯é»˜è®¤ç«¯å£ï¼Œç”Ÿäº§çŽ¯å¢ƒéœ€è¦é˜²ç«å¢™é…ç½®
ðŸ”¸ æ•°æ®å­˜å‚¨ï¼šTSDBæ—¶åºæ•°æ®åº“ï¼Œéœ€è¦è§„åˆ’å­˜å‚¨ç©ºé—´å’Œä¿ç•™ç­–ç•¥
ðŸ”¸ æœåŠ¡ç®¡ç†ï¼šsystemdç®¡ç†ï¼Œæ”¯æŒçƒ­é‡è½½é…ç½®
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ é€‰æ‹©åˆé€‚çš„å®‰è£…æ–¹å¼**
```
å­¦ä¹ çŽ¯å¢ƒï¼šDockerå¿«é€Ÿéƒ¨ç½²
ç”Ÿäº§çŽ¯å¢ƒï¼šäºŒè¿›åˆ¶å®‰è£…ï¼ˆç¨³å®šå¯æŽ§ï¼‰
å®¹å™¨åŒ–çŽ¯å¢ƒï¼šKuberneteséƒ¨ç½²
å¼€å‘çŽ¯å¢ƒï¼šæœ¬åœ°äºŒè¿›åˆ¶æˆ–Docker
```

**ðŸ”¹ é…ç½®æ–‡ä»¶çš„é‡è¦æ€§**
```
prometheus.ymlæ˜¯"æŒ‡æŒ¥ä¸­å¿ƒ"ï¼š
- å‘Šè¯‰PrometheusåŽ»å“ªé‡Œæ”¶é›†æ•°æ®
- å¤šä¹…æ”¶é›†ä¸€æ¬¡
- å¦‚ä½•å¤„ç†æ”¶é›†åˆ°çš„æ•°æ®
- å‡ºçŽ°é—®é¢˜æ—¶å¦‚ä½•å‘Šè­¦
```

**ðŸ”¹ å­˜å‚¨ç©ºé—´è§„åˆ’**
```
æ•°æ®å¢žé•¿é¢„ä¼°ï¼š
- 1000ä¸ªæ—¶é—´åºåˆ— Ã— 15sé‡‡é›†é—´éš” â‰ˆ 1GB/æœˆ
- æ ¹æ®ä¸šåŠ¡è§„æ¨¡è®¡ç®—å­˜å‚¨éœ€æ±‚
- è®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™ç­–ç•¥
```

### 8.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸŽ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è¿ç»´ç›‘æŽ§**ï¼šæœåŠ¡å™¨ã€ç½‘ç»œã€åº”ç”¨æ€§èƒ½ç›‘æŽ§
- **ä¸šåŠ¡ç›‘æŽ§**ï¼šè®¢å•é‡ã€ç”¨æˆ·è®¿é—®ã€æ”¯ä»˜æˆåŠŸçŽ‡
- **DevOps**ï¼šCI/CDæµæ°´çº¿ç›‘æŽ§ã€éƒ¨ç½²æˆåŠŸçŽ‡
- **SREå®žè·µ**ï¼šSLA/SLOæŒ‡æ ‡ç›‘æŽ§ã€é”™è¯¯é¢„ç®—ç®¡ç†

**ðŸ”§ è¿ç»´å®žè·µ**
- **æ ‡å‡†åŒ–éƒ¨ç½²**ï¼šç»Ÿä¸€çš„é…ç½®æ¨¡æ¿å’Œéƒ¨ç½²æµç¨‹
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šé…åˆAnsibleã€Terraformç­‰å·¥å…·
- **ç›‘æŽ§å³ä»£ç **ï¼šé…ç½®æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºŽåŽ†å²æ•°æ®é¢„æµ‹èµ„æºéœ€æ±‚

### 8.4 æ–°æ‰‹å¸¸è§é—®é¢˜


**â“ å¸¸è§é—®é¢˜è§£ç­”**

**Q: é…ç½®æ–‡ä»¶ä¿®æ”¹åŽä¸ç”Ÿæ•ˆï¼Ÿ**
```
A: éœ€è¦é‡æ–°åŠ è½½é…ç½®
æ–¹æ³•1: systemctl reload prometheus
æ–¹æ³•2: curl -X POST http://localhost:9090/-/reload
```

**Q: Webç•Œé¢æ— æ³•è®¿é—®ï¼Ÿ**
```
A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹
1. æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼šsystemctl status prometheus
2. ç«¯å£æ˜¯å¦ç›‘å¬ï¼šnetstat -tlnp | grep 9090
3. é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ï¼šfirewall-cmd --list-ports
```

**Q: æ•°æ®é‡‡é›†ä¸åˆ°ï¼Ÿ**
```
A: æŽ’æŸ¥æ­¥éª¤
1. æ£€æŸ¥ç›®æ ‡æœåŠ¡æ˜¯å¦è¿è¡Œ
2. ç¡®è®¤ç½‘ç»œè¿žé€šæ€§ï¼štelnet target_ip 9100
3. æŸ¥çœ‹Prometheusæ—¥å¿—ï¼šjournalctl -u prometheus
4. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼špromtool check config
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Prometheuså®‰è£…ç®€å•ï¼Œé…ç½®æ˜¯å…³é”®
- é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ–¹å¼ï¼Œè§„åˆ’å¥½å­˜å‚¨ç©ºé—´
- é…ç½®æ–‡ä»¶å†³å®šä¸€åˆ‡ï¼Œå¤‡ä»½å’Œç›‘æŽ§ä¸å¯å°‘
- ä»Žç®€å•å¼€å§‹ï¼Œé€æ­¥å®Œå–„ç›‘æŽ§ä½“ç³»