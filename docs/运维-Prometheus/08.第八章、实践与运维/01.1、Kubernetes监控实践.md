---
title: 1ã€Kubernetesç›‘æ§å®è·µ
---
## ğŸ“š ç›®å½•

1. [K8sç›‘æ§ä½“ç³»æ¦‚è¿°](#1-K8sç›‘æ§ä½“ç³»æ¦‚è¿°)
2. [kube-state-metricsè¯¦è§£](#2-kube-state-metricsè¯¦è§£)
3. [Podä¸Nodeç›‘æ§](#3-Podä¸Nodeç›‘æ§)
4. [ServiceæœåŠ¡ç›‘æ§](#4-ServiceæœåŠ¡ç›‘æ§)
5. [é›†ç¾¤äº‹ä»¶ç›‘æ§](#5-é›†ç¾¤äº‹ä»¶ç›‘æ§)
6. [èµ„æºé…é¢ç›‘æ§](#6-èµ„æºé…é¢ç›‘æ§)
7. [Ingressç½‘å…³ç›‘æ§](#7-Ingressç½‘å…³ç›‘æ§)
8. [å­˜å‚¨PV/PVCç›‘æ§](#8-å­˜å‚¨PV-PVCç›‘æ§)
9. [ç½‘ç»œç­–ç•¥ç›‘æ§](#9-ç½‘ç»œç­–ç•¥ç›‘æ§)
10. [ç›‘æ§é…ç½®æœ€ä½³å®è·µ](#10-ç›‘æ§é…ç½®æœ€ä½³å®è·µ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ K8sç›‘æ§ä½“ç³»æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦K8sç›‘æ§


æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ç®¡ç†ç€ä¸€ä¸ªæœ‰å‡ ç™¾ä¸ªå®¹å™¨çš„å¤§å‹åº”ç”¨ç³»ç»Ÿï¼Œå¦‚æœæ²¡æœ‰ç›‘æ§ï¼Œå°±åƒ**è’™ç€çœ¼ç›å¼€è½¦**ä¸€æ ·å±é™©ã€‚

**K8sç›‘æ§è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š**
```
åº”ç”¨å±‚é¢ï¼š
- æˆ‘çš„Podæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Ÿ
- æœåŠ¡å“åº”æ—¶é—´å¤šé•¿ï¼Ÿ
- å†…å­˜ä½¿ç”¨é‡æ˜¯å¦è¿‡é«˜ï¼Ÿ

é›†ç¾¤å±‚é¢ï¼š
- èŠ‚ç‚¹èµ„æºè¿˜å‰©å¤šå°‘ï¼Ÿ
- è°ƒåº¦æ˜¯å¦å‡è¡¡ï¼Ÿ
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ

ä¸šåŠ¡å±‚é¢ï¼š
- ç”¨æˆ·è¯·æ±‚æˆåŠŸç‡å¦‚ä½•ï¼Ÿ
- å…³é”®ä¸šåŠ¡æŒ‡æ ‡æ˜¯å¦å¼‚å¸¸ï¼Ÿ
- ç³»ç»Ÿå®¹é‡æ˜¯å¦å¤Ÿç”¨ï¼Ÿ
```

### 1.2 K8sç›‘æ§æ¶æ„å…¨æ™¯


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Prometheus ç›‘æ§æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Grafana   â”‚â”€â”€â”€â”€â”‚ Prometheus  â”‚â”€â”€â”€â”€â”‚ AlertManagerâ”‚     â”‚
â”‚  â”‚  (å¯è§†åŒ–)    â”‚    â”‚  (æ•°æ®æ”¶é›†)  â”‚    â”‚   (å‘Šè­¦)     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                æ•°æ®é‡‡é›†å±‚                            â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚kube-state    â”‚  â”‚node-exporter â”‚  â”‚cadvisor    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚-metrics      â”‚  â”‚ (èŠ‚ç‚¹ç›‘æ§)    â”‚  â”‚(å®¹å™¨ç›‘æ§)   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚(K8sçŠ¶æ€)     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                Kubernetes é›†ç¾¤                      â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Master  â”‚  â”‚ Node1   â”‚  â”‚ Node2   â”‚  â”‚ Node3   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚  â”‚         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â”‚Pod1 â”‚ â”‚  â”‚ â”‚Pod2 â”‚ â”‚  â”‚ â”‚Pod3 â”‚ â”‚  â”‚ â”‚Pod4 â”‚ â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰å¤§æ•°æ®é‡‡é›†ç»„ä»¶è¯´æ˜ï¼š**
- **`kube-state-metrics`**ï¼šä¸“é—¨æ”¶é›†K8så¯¹è±¡çŠ¶æ€ä¿¡æ¯ï¼ˆPodæ•°é‡ã€ServiceçŠ¶æ€ç­‰ï¼‰
- **`node-exporter`**ï¼šæ”¶é›†èŠ‚ç‚¹ç¡¬ä»¶æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰
- **`cadvisor`**ï¼šæ”¶é›†å®¹å™¨è¿è¡Œæ—¶æŒ‡æ ‡ï¼ˆå®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µï¼‰

---

## 2. ğŸ“Š kube-state-metricsè¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯kube-state-metrics


**ç®€å•ç†è§£**ï¼š`kube-state-metrics`å°±åƒæ˜¯K8sé›†ç¾¤çš„"ä½“æ£€åŒ»ç”Ÿ"ï¼Œå®ƒä¼šå®šæœŸæ£€æŸ¥é›†ç¾¤ä¸­å„ç§å¯¹è±¡çš„å¥åº·çŠ¶æ€ï¼Œç„¶åæŠŠæ£€æŸ¥ç»“æœå‘Šè¯‰Prometheusã€‚

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
```
ç›‘æ§å¯¹è±¡çŠ¶æ€ï¼š
âœ… Podï¼šè¿è¡ŒçŠ¶æ€ã€é‡å¯æ¬¡æ•°ã€èµ„æºè¯·æ±‚/é™åˆ¶
âœ… Deploymentï¼šå‰¯æœ¬æ•°ã€å¯ç”¨å‰¯æœ¬ã€æ›´æ–°çŠ¶æ€
âœ… Serviceï¼šç«¯ç‚¹æ•°é‡ã€è´Ÿè½½å‡è¡¡çŠ¶æ€
âœ… Nodeï¼šå°±ç»ªçŠ¶æ€ã€è°ƒåº¦èƒ½åŠ›ã€èµ„æºåˆ†é…
âœ… PV/PVCï¼šå­˜å‚¨çŠ¶æ€ã€ç»‘å®šæƒ…å†µã€å®¹é‡ä½¿ç”¨
```

### 2.2 éƒ¨ç½²kube-state-metrics


**æ–¹æ³•ä¸€ï¼šä½¿ç”¨å®˜æ–¹YAMLéƒ¨ç½²**
```yaml
# kube-state-metrics-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-state-metrics
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kube-state-metrics
  template:
    metadata:
      labels:
        app: kube-state-metrics
    spec:
      containers:
      - name: kube-state-metrics
        image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.10.0
        ports:
        - containerPort: 8080
          name: http-metrics
        - containerPort: 8081
          name: telemetry
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
---
apiVersion: v1
kind: Service
metadata:
  name: kube-state-metrics
  namespace: kube-system
  labels:
    app: kube-state-metrics
spec:
  ports:
  - port: 8080
    name: http-metrics
  selector:
    app: kube-state-metrics
```

**éƒ¨ç½²å‘½ä»¤ï¼š**
```bash
# ä¸‹è½½å®˜æ–¹é…ç½®æ–‡ä»¶
wget https://github.com/kubernetes/kube-state-metrics/archive/v2.10.0.tar.gz

# è§£å‹å¹¶éƒ¨ç½²
tar -xzf v2.10.0.tar.gz
kubectl apply -f kube-state-metrics-2.10.0/examples/standard/
```

### 2.3 éªŒè¯éƒ¨ç½²çŠ¶æ€


**æ£€æŸ¥PodçŠ¶æ€ï¼š**
```bash
# æŸ¥çœ‹kube-state-metricsæ˜¯å¦è¿è¡Œæ­£å¸¸
kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-state-metrics

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
kubectl get svc -n kube-system kube-state-metrics

# æŸ¥çœ‹æŒ‡æ ‡è¾“å‡º
kubectl port-forward -n kube-system svc/kube-state-metrics 8080:8080
curl http://localhost:8080/metrics | head -20
```

**å¸¸è§æŒ‡æ ‡ç¤ºä¾‹ï¼š**
```
# PodçŠ¶æ€æŒ‡æ ‡
kube_pod_status_phase{pod="nginx-pod", phase="Running"} 1
kube_pod_container_status_restarts_total{pod="nginx-pod"} 0

# DeploymentæŒ‡æ ‡  
kube_deployment_status_replicas{deployment="nginx-deployment"} 3
kube_deployment_status_replicas_available{deployment="nginx-deployment"} 3

# NodeæŒ‡æ ‡
kube_node_status_condition{node="worker-node-1", condition="Ready"} 1
```

---

## 3. ğŸ” Podä¸Nodeç›‘æ§


### 3.1 Podç›‘æ§æ ¸å¿ƒæŒ‡æ ‡


**PodçŠ¶æ€ç›‘æ§ï¼š**
```
Podç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š
- Pendingï¼šç­‰å¾…è°ƒåº¦æˆ–é•œåƒæ‹‰å–
- Runningï¼šæ­£å¸¸è¿è¡Œä¸­  
- Succeededï¼šæˆåŠŸå®Œæˆ
- Failedï¼šè¿è¡Œå¤±è´¥
- Unknownï¼šçŠ¶æ€æœªçŸ¥

å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- é‡å¯æ¬¡æ•°ï¼škube_pod_container_status_restarts_total
- èµ„æºä½¿ç”¨ï¼šcontainer_memory_usage_bytes
- ç½‘ç»œæµé‡ï¼šcontainer_network_receive_bytes_total
- å­˜å‚¨IOï¼šcontainer_fs_reads_total
```

**Podç›‘æ§Prometheusé…ç½®ï¼š**
```yaml
# prometheus.yml ä¸­çš„æŠ“å–é…ç½®
- job_name: 'kubernetes-pods'
  kubernetes_sd_configs:
  - role: pod
  relabel_configs:
  # åªç›‘æ§æœ‰prometheus.io/scrape=trueæ³¨è§£çš„Pod
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action: keep
    regex: true
  # è®¾ç½®ç›‘æ§è·¯å¾„
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    action: replace
    target_label: __metrics_path__
    regex: (.+)
  # è®¾ç½®ç›‘æ§ç«¯å£
  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
    action: replace
    regex: ([^:]+)(?::\d+)?;(\d+)
    replacement: $1:$2
    target_label: __address__
```

### 3.2 NodeèŠ‚ç‚¹ç›‘æ§


**Nodeç›‘æ§æ¶æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master Node   â”‚    â”‚   Worker Node1  â”‚    â”‚   Worker Node2  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚kube-apiserverâ”‚ â”‚    â”‚ â”‚node-exporterâ”‚ â”‚    â”‚ â”‚node-exporterâ”‚ â”‚
â”‚ â”‚kube-schedulerâ”‚ â”‚    â”‚ â”‚   (9100)    â”‚ â”‚    â”‚ â”‚   (9100)    â”‚ â”‚
â”‚ â”‚etcd         â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚                 â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                 â”‚    â”‚ â”‚  cadvisor   â”‚ â”‚    â”‚ â”‚  cadvisor   â”‚ â”‚
â”‚                 â”‚    â”‚ â”‚   (4194)    â”‚ â”‚    â”‚ â”‚   (4194)    â”‚ â”‚
â”‚                 â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Nodeç›‘æ§å…³é”®æŒ‡æ ‡ï¼š**
```
ç³»ç»Ÿèµ„æºï¼š
- CPUä½¿ç”¨ç‡ï¼š100 - (node_cpu_seconds_total{mode="idle"} * 100)
- å†…å­˜ä½¿ç”¨ç‡ï¼š(1 - node_memory_MemAvailable_bytes/node_memory_MemTotal_bytes) * 100
- ç£ç›˜ä½¿ç”¨ç‡ï¼š(1 - node_filesystem_avail_bytes/node_filesystem_size_bytes) * 100
- ç½‘ç»œæµé‡ï¼šnode_network_receive_bytes_total

èŠ‚ç‚¹çŠ¶æ€ï¼š
- èŠ‚ç‚¹å°±ç»ªçŠ¶æ€ï¼škube_node_status_condition{condition="Ready"}
- ç£ç›˜å‹åŠ›ï¼škube_node_status_condition{condition="DiskPressure"}  
- å†…å­˜å‹åŠ›ï¼škube_node_status_condition{condition="MemoryPressure"}
- PIDå‹åŠ›ï¼škube_node_status_condition{condition="PIDPressure"}
```

**éƒ¨ç½²node-exporterï¼š**
```yaml
# node-exporter-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: node-exporter
        image: prom/node-exporter:v1.6.1
        args:
        - '--path.rootfs=/host'
        - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)'
        ports:
        - containerPort: 9100
        volumeMounts:
        - name: root
          mountPath: /host
          readOnly: true
      volumes:
      - name: root
        hostPath:
          path: /
```

---

## 4. ğŸŒ ServiceæœåŠ¡ç›‘æ§


### 4.1 Serviceç›‘æ§åŸç†


**Serviceåœ¨K8sä¸­çš„ä½œç”¨ï¼š**
```
Service = æœåŠ¡å‘ç° + è´Ÿè½½å‡è¡¡

ä¾‹å¦‚ï¼š
å‰ç«¯Pod â”€â”€â”€â”€â”€â”€> Backend Service â”€â”€â”€â”€â”€â”€> å¤šä¸ªBackend Pod
        (é€šè¿‡Service)          (è‡ªåŠ¨è´Ÿè½½å‡è¡¡)

Serviceç›‘æ§é‡ç‚¹ï¼š
âœ… æœåŠ¡å¯è¾¾æ€§ï¼šServiceèƒ½å¦æ­£å¸¸å“åº”
âœ… ç«¯ç‚¹å¥åº·ï¼šåç«¯Podæ˜¯å¦å¯ç”¨
âœ… è´Ÿè½½å‡è¡¡ï¼šè¯·æ±‚åˆ†å‘æ˜¯å¦å‡åŒ€
âœ… å“åº”æ—¶é—´ï¼šæœåŠ¡å¤„ç†è¯·æ±‚çš„é€Ÿåº¦
```

### 4.2 Serviceç›‘æ§é…ç½®


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ï¼š**
```yaml
# Serviceç«¯ç‚¹ç›‘æ§
- kube_service_infoï¼šServiceåŸºæœ¬ä¿¡æ¯
- kube_endpoint_infoï¼šç«¯ç‚¹è¯¦ç»†ä¿¡æ¯
- kube_endpoint_address_availableï¼šå¯ç”¨ç«¯ç‚¹æ•°é‡
- kube_endpoint_address_not_readyï¼šä¸å¯ç”¨ç«¯ç‚¹æ•°é‡

# æœåŠ¡è´¨é‡ç›‘æ§  
- http_requests_totalï¼šHTTPè¯·æ±‚æ€»æ•°
- http_request_duration_secondsï¼šè¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
- http_requests_per_secondï¼šæ¯ç§’è¯·æ±‚æ•°
```

**PrometheusæŠ“å–ServiceæŒ‡æ ‡ï¼š**
```yaml
# prometheus.yml
- job_name: 'kubernetes-services'
  kubernetes_sd_configs:
  - role: service
  relabel_configs:
  # åªç›‘æ§æœ‰prometheus.io/scrape=trueæ³¨è§£çš„Service
  - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
    action: keep
    regex: true
  # è®¾ç½®Serviceåç§°æ ‡ç­¾
  - source_labels: [__meta_kubernetes_service_name]
    target_label: service_name
  # è®¾ç½®å‘½åç©ºé—´æ ‡ç­¾
  - source_labels: [__meta_kubernetes_namespace]
    target_label: kubernetes_namespace
```

### 4.3 Serviceå¥åº·æ£€æŸ¥ç¤ºä¾‹


**åº”ç”¨Serviceç›‘æ§æ³¨è§£ï¼š**
```yaml
# nginx-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9113"
    prometheus.io/path: "/metrics"
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  - port: 9113  # Prometheusç›‘æ§ç«¯å£
    targetPort: 9113
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.21
        ports:
        - containerPort: 80
      # æ·»åŠ nginx-prometheus-exporterè¾¹è½¦å®¹å™¨
      - name: nginx-exporter
        image: nginx/nginx-prometheus-exporter:0.10.0
        args:
        - -nginx.scrape-uri=http://localhost/nginx_status
        ports:
        - containerPort: 9113
```

---

## 5. ğŸ“… é›†ç¾¤äº‹ä»¶ç›‘æ§


### 5.1 K8säº‹ä»¶ç³»ç»Ÿç†è§£


**ä»€ä¹ˆæ˜¯K8säº‹ä»¶ï¼Ÿ**
K8säº‹ä»¶å°±åƒæ˜¯é›†ç¾¤çš„"æ—¥è®°æœ¬"ï¼Œè®°å½•ç€é›†ç¾¤ä¸­å‘ç”Ÿçš„å„ç§é‡è¦äº‹æƒ…ï¼š

```
æ­£å¸¸äº‹ä»¶ï¼š
âœ… Podåˆ›å»ºæˆåŠŸï¼šSuccessfully created pod
âœ… æœåŠ¡å¯åŠ¨ï¼šService has been created
âœ… å­˜å‚¨æŒ‚è½½ï¼šVolume mounted successfully

å¼‚å¸¸äº‹ä»¶ï¼š
âŒ é•œåƒæ‹‰å–å¤±è´¥ï¼šFailed to pull image
âŒ èµ„æºä¸è¶³ï¼šInsufficient memory
âŒ è°ƒåº¦å¤±è´¥ï¼šNo suitable node found
âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼šLiveness probe failed
```

### 5.2 äº‹ä»¶ç›‘æ§æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   K8s äº‹ä»¶ç›‘æ§æµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  K8s API    â”‚â”€â”€â”€â–¶â”‚kube-events  â”‚â”€â”€â”€â–¶â”‚ Prometheus  â”‚ â”‚
â”‚  â”‚   Events    â”‚    â”‚ -exporter   â”‚    â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                       â”‚       â”‚
â”‚         â–¼                                       â–¼       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   é›†ç¾¤ä¸­     â”‚                        â”‚  Grafana    â”‚ â”‚
â”‚  â”‚å„ç§å¯¹è±¡äº‹ä»¶  â”‚                        â”‚  å¯è§†åŒ–     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 éƒ¨ç½²äº‹ä»¶ç›‘æ§ç»„ä»¶


**éƒ¨ç½²kubernetes-event-exporterï¼š**
```yaml
# event-exporter-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-exporter
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: event-exporter
  template:
    metadata:
      labels:
        app: event-exporter
    spec:
      serviceAccountName: event-exporter
      containers:
      - name: event-exporter
        image: ghcr.io/resmoio/kubernetes-event-exporter:v1.4.0
        args:
        - -conf=/etc/config/config.yaml
        volumeMounts:
        - name: config
          mountPath: /etc/config
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: config
        configMap:
          name: event-exporter-config
---
# ServiceAccountå’Œæƒé™é…ç½®
apiVersion: v1
kind: ServiceAccount
metadata:
  name: event-exporter
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: event-exporter
rules:
- apiGroups: [""]
  resources: ["events"]
  verbs: ["list", "watch"]
- apiGroups: [""]
  resources: ["nodes", "pods", "services"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: event-exporter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: event-exporter
subjects:
- kind: ServiceAccount
  name: event-exporter
  namespace: kube-system
```

**äº‹ä»¶ç›‘æ§é…ç½®ï¼š**
```yaml
# event-exporter-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: event-exporter-config
  namespace: kube-system
data:
  config.yaml: |
    logLevel: error
    receivers:
    - name: "prometheus"
      prometheus:
        port: 9090
        path: /metrics
    route:
      routes:
      - match:
        - receiver: "prometheus"
        routes:
        # ç›‘æ§Podç›¸å…³äº‹ä»¶
        - match:
          - kind: "Pod"
            reason: "Failed"
          receiver: "prometheus"
        # ç›‘æ§Nodeç›¸å…³äº‹ä»¶  
        - match:
          - kind: "Node"
            reason: "NodeNotReady"
          receiver: "prometheus"
        # ç›‘æ§èµ„æºä¸è¶³äº‹ä»¶
        - match:
          - reason: "FailedScheduling"
          receiver: "prometheus"
```

### 5.4 å…³é”®äº‹ä»¶å‘Šè­¦è§„åˆ™


```yaml
# äº‹ä»¶å‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: kubernetes-events
  rules:
  # Podå¤±è´¥äº‹ä»¶å‘Šè­¦
  - alert: PodFailedEvents
    expr: increase(kubernetes_event_total{reason="Failed",involved_object_kind="Pod"}[5m]) > 0
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Podå¤±è´¥äº‹ä»¶é¢‘å‘"
      description: "åœ¨è¿‡å»5åˆ†é’Ÿå†…ï¼Œ{{$labels.involved_object_namespace}}/{{$labels.involved_object_name}} Podå‡ºç°äº†å¤±è´¥äº‹ä»¶"

  # é•œåƒæ‹‰å–å¤±è´¥
  - alert: ImagePullBackOffEvents  
    expr: increase(kubernetes_event_total{reason="FailedPullImage"}[5m]) > 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "é•œåƒæ‹‰å–å¤±è´¥"
      description: "{{$labels.involved_object_namespace}}/{{$labels.involved_object_name}} æ— æ³•æ‹‰å–é•œåƒ"

  # èŠ‚ç‚¹çŠ¶æ€å¼‚å¸¸
  - alert: NodeNotReadyEvents
    expr: increase(kubernetes_event_total{reason="NodeNotReady"}[5m]) > 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: "èŠ‚ç‚¹çŠ¶æ€å¼‚å¸¸"
      description: "èŠ‚ç‚¹ {{$labels.involved_object_name}} çŠ¶æ€å˜ä¸ºNotReady"
```

---

## 6. ğŸ’¾ èµ„æºé…é¢ç›‘æ§


### 6.1 K8sèµ„æºé…é¢æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯èµ„æºé…é¢ï¼Ÿ**
èµ„æºé…é¢å°±åƒæ˜¯ç»™æ¯ä¸ªéƒ¨é—¨åˆ†é…é¢„ç®—ä¸€æ ·ï¼Œé˜²æ­¢æŸä¸ªåº”ç”¨å ç”¨è¿‡å¤šèµ„æºå½±å“å…¶ä»–åº”ç”¨ï¼š

```
èµ„æºé…é¢ç±»å‹ï¼š

è®¡ç®—èµ„æºé…é¢ï¼š
- CPUè¯·æ±‚/é™åˆ¶ï¼šrequests.cpu, limits.cpu
- å†…å­˜è¯·æ±‚/é™åˆ¶ï¼šrequests.memory, limits.memory
- GPUé…é¢ï¼šrequests.nvidia.com/gpu

å¯¹è±¡æ•°é‡é…é¢ï¼š
- Podæ•°é‡ï¼špods
- Serviceæ•°é‡ï¼šservices  
- PVCæ•°é‡ï¼špersistentvolumeclaims
- Secretæ•°é‡ï¼šsecrets

å­˜å‚¨èµ„æºé…é¢ï¼š
- å­˜å‚¨è¯·æ±‚ï¼šrequests.storage
- ç‰¹å®šå­˜å‚¨ç±»ï¼š<storageclass>.storageclass.storage.k8s.io/requests.storage
```

### 6.2 èµ„æºé…é¢ç›‘æ§æŒ‡æ ‡


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ï¼š**
```yaml
é…é¢ä½¿ç”¨æƒ…å†µï¼š
- kube_resourcequotaï¼šé…é¢å®šä¹‰ä¿¡æ¯
- kube_resourcequota_usedï¼šå·²ä½¿ç”¨èµ„æºé‡
- kube_resourcequota_hardï¼šé…é¢ä¸Šé™

è®¡ç®—å…¬å¼ï¼š
ä½¿ç”¨ç‡ = kube_resourcequota_used / kube_resourcequota_hard * 100

å…³é”®ç›‘æ§ç‚¹ï¼š
âœ… CPUé…é¢ä½¿ç”¨ç‡ > 80%
âœ… å†…å­˜é…é¢ä½¿ç”¨ç‡ > 85%  
âœ… Podæ•°é‡æ¥è¿‘é…é¢ä¸Šé™
âœ… å­˜å‚¨é…é¢ä½¿ç”¨ç‡ > 90%
```

### 6.3 åˆ›å»ºèµ„æºé…é¢ç¤ºä¾‹


**å‘½åç©ºé—´èµ„æºé…é¢ï¼š**
```yaml
# resource-quota.yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: compute-quota
  namespace: production
spec:
  hard:
    # è®¡ç®—èµ„æºé…é¢
    requests.cpu: "4"          # CPUè¯·æ±‚æ€»é‡4æ ¸
    requests.memory: 8Gi       # å†…å­˜è¯·æ±‚æ€»é‡8GB
    limits.cpu: "8"            # CPUé™åˆ¶æ€»é‡8æ ¸  
    limits.memory: 16Gi        # å†…å­˜é™åˆ¶æ€»é‡16GB
    
    # å¯¹è±¡æ•°é‡é…é¢
    pods: "10"                 # æœ€å¤š10ä¸ªPod
    services: "5"              # æœ€å¤š5ä¸ªService
    persistentvolumeclaims: "4" # æœ€å¤š4ä¸ªPVC
    secrets: "10"              # æœ€å¤š10ä¸ªSecret
    
    # å­˜å‚¨é…é¢
    requests.storage: 100Gi    # å­˜å‚¨è¯·æ±‚æ€»é‡100GB

---
# åº”ç”¨åˆ°ç‰¹å®šå­˜å‚¨ç±»çš„é…é¢
apiVersion: v1
kind: ResourceQuota  
metadata:
  name: storage-quota
  namespace: production
spec:
  hard:
    # SSDå­˜å‚¨ç±»é…é¢
    ssd.storageclass.storage.k8s.io/requests.storage: 50Gi
    # æ™®é€šå­˜å‚¨ç±»é…é¢
    standard.storageclass.storage.k8s.io/requests.storage: 200Gi
```

### 6.4 èµ„æºé…é¢ç›‘æ§å‘Šè­¦


**Prometheuså‘Šè­¦è§„åˆ™ï¼š**
```yaml
# resource-quota-alerts.yaml
groups:
- name: resource-quota-alerts
  rules:
  # CPUé…é¢ä½¿ç”¨ç‡å‘Šè­¦
  - alert: NamespaceCPUQuotaHigh
    expr: (kube_resourcequota_used{resource="requests.cpu"} / kube_resourcequota{resource="requests.cpu"}) * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "å‘½åç©ºé—´CPUé…é¢ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å‘½åç©ºé—´ {{$labels.namespace}} çš„CPUé…é¢ä½¿ç”¨ç‡å·²è¾¾åˆ° {{$value}}%"

  # å†…å­˜é…é¢ä½¿ç”¨ç‡å‘Šè­¦  
  - alert: NamespaceMemoryQuotaHigh
    expr: (kube_resourcequota_used{resource="requests.memory"} / kube_resourcequota{resource="requests.memory"}) * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "å‘½åç©ºé—´å†…å­˜é…é¢ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å‘½åç©ºé—´ {{$labels.namespace}} çš„å†…å­˜é…é¢ä½¿ç”¨ç‡å·²è¾¾åˆ° {{$value}}%"

  # Podæ•°é‡é…é¢å‘Šè­¦
  - alert: NamespacePodQuotaHigh  
    expr: (kube_resourcequota_used{resource="pods"} / kube_resourcequota{resource="pods"}) * 100 > 90
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "å‘½åç©ºé—´Podæ•°é‡é…é¢å³å°†ç”¨å°½"
      description: "å‘½åç©ºé—´ {{$labels.namespace}} çš„Podæ•°é‡é…é¢ä½¿ç”¨ç‡å·²è¾¾åˆ° {{$value}}%"

  # å­˜å‚¨é…é¢å‘Šè­¦
  - alert: NamespaceStorageQuotaHigh
    expr: (kube_resourcequota_used{resource="requests.storage"} / kube_resourcequota{resource="requests.storage"}) * 100 > 90
    for: 5m
    labels:
      severity: warning  
    annotations:
      summary: "å‘½åç©ºé—´å­˜å‚¨é…é¢ä½¿ç”¨ç‡è¿‡é«˜"
      description: "å‘½åç©ºé—´ {{$labels.namespace}} çš„å­˜å‚¨é…é¢ä½¿ç”¨ç‡å·²è¾¾åˆ° {{$value}}%"
```

---

## 7. ğŸŒ‰ Ingressç½‘å…³ç›‘æ§


### 7.1 Ingressç›‘æ§é‡è¦æ€§


**Ingressåœ¨K8sä¸­çš„ä½œç”¨ï¼š**
```
å¤–éƒ¨æµé‡è¿›å…¥é›†ç¾¤çš„"å¤§é—¨"

æµé‡è·¯å¾„ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€> è´Ÿè½½å‡è¡¡å™¨ â”€â”€> Ingressæ§åˆ¶å™¨ â”€â”€> Service â”€â”€> Pod

Ingressç›‘æ§å…³æ³¨ç‚¹ï¼š
âœ… è¯·æ±‚é‡ï¼šQPSã€å¹¶å‘è¿æ¥æ•°
âœ… å“åº”è´¨é‡ï¼šå»¶è¿Ÿã€æˆåŠŸç‡ã€é”™è¯¯ç‡  
âœ… åç«¯å¥åº·ï¼šä¸Šæ¸¸æœåŠ¡çŠ¶æ€
âœ… å®‰å…¨æŒ‡æ ‡ï¼šSSLè¯ä¹¦æœ‰æ•ˆæœŸã€å¼‚å¸¸è®¿é—®
```

### 7.2 Nginx Ingressç›‘æ§é…ç½®


**å¯ç”¨Nginx Ingressç›‘æ§ï¼š**
```yaml
# nginx-ingress-controlleré…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
spec:
  template:
    spec:
      containers:
      - name: controller
        image: k8s.gcr.io/ingress-nginx/controller:v1.8.1
        args:
        - /nginx-ingress-controller
        - --configmap=$(POD_NAMESPACE)/nginx-configuration
        - --enable-metrics=true          # å¯ç”¨æŒ‡æ ‡æ”¶é›†
        - --metrics-per-host=true        # æŒ‰ä¸»æœºæ”¶é›†æŒ‡æ ‡
        ports:
        - containerPort: 80
        - containerPort: 443  
        - containerPort: 10254          # ç›‘æ§ç«¯å£
          name: metrics
        # å¥åº·æ£€æŸ¥é…ç½®
        livenessProbe:
          httpGet:
            path: /healthz
            port: 10254
        readinessProbe:
          httpGet:
            path: /healthz
            port: 10254
---
# ç›‘æ§Service
apiVersion: v1
kind: Service
metadata:
  name: nginx-ingress-metrics
  namespace: ingress-nginx
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "10254"
    prometheus.io/path: "/metrics"
spec:
  ports:
  - port: 10254
    name: metrics
  selector:
    app.kubernetes.io/name: ingress-nginx
```

### 7.3 Ingressç›‘æ§æŒ‡æ ‡è¯¦è§£


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ï¼š**
```yaml
è¯·æ±‚é‡æŒ‡æ ‡ï¼š
- nginx_ingress_controller_requests_totalï¼šæ€»è¯·æ±‚æ•°
- nginx_ingress_controller_request_rateï¼šè¯·æ±‚é€Ÿç‡
- nginx_ingress_controller_bytes_sent_totalï¼šå‘é€å­—èŠ‚æ•°

æ€§èƒ½æŒ‡æ ‡ï¼š
- nginx_ingress_controller_request_duration_secondsï¼šè¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
- nginx_ingress_controller_response_duration_secondsï¼šå“åº”æ—¶é—´
- nginx_ingress_controller_request_size_bytesï¼šè¯·æ±‚å¤§å°åˆ†å¸ƒ

é”™è¯¯æŒ‡æ ‡ï¼š
- nginx_ingress_controller_requests{status=~"4.."}ï¼š4XXé”™è¯¯æ•°
- nginx_ingress_controller_requests{status=~"5.."}ï¼š5XXé”™è¯¯æ•°

åç«¯å¥åº·æŒ‡æ ‡ï¼š
- nginx_ingress_controller_upstream_serversï¼šä¸Šæ¸¸æœåŠ¡å™¨æ•°é‡
- nginx_ingress_controller_ssl_certificate_infoï¼šSSLè¯ä¹¦ä¿¡æ¯
```

**å¸¸ç”¨ç›‘æ§æŸ¥è¯¢ï¼š**
```yaml
# æŒ‰Ingressç»Ÿè®¡QPS
sum(rate(nginx_ingress_controller_requests_total[5m])) by (ingress)

# è®¡ç®—é”™è¯¯ç‡
sum(rate(nginx_ingress_controller_requests_total{status=~"5.."}[5m])) by (ingress) / 
sum(rate(nginx_ingress_controller_requests_total[5m])) by (ingress) * 100

# P99å»¶è¿Ÿç›‘æ§
histogram_quantile(0.99, 
  sum(rate(nginx_ingress_controller_request_duration_seconds_bucket[5m])) by (le, ingress)
)

# SSLè¯ä¹¦è¿‡æœŸæ—¶é—´
nginx_ingress_controller_ssl_certificate_info - time()
```

### 7.4 Ingresså‘Šè­¦è§„åˆ™


```yaml
# ingress-alerts.yaml
groups:
- name: ingress-alerts
  rules:
  # é«˜é”™è¯¯ç‡å‘Šè­¦
  - alert: IngressHighErrorRate
    expr: |
      (
        sum(rate(nginx_ingress_controller_requests_total{status=~"5.."}[5m])) by (ingress) /
        sum(rate(nginx_ingress_controller_requests_total[5m])) by (ingress)
      ) * 100 > 5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Ingressé”™è¯¯ç‡è¿‡é«˜"
      description: "Ingress {{$labels.ingress}} çš„5XXé”™è¯¯ç‡åœ¨è¿‡å»5åˆ†é’Ÿå†…è¶…è¿‡äº†5%ï¼Œå½“å‰å€¼ï¼š{{$value}}%"

  # é«˜å»¶è¿Ÿå‘Šè­¦
  - alert: IngressHighLatency
    expr: |
      histogram_quantile(0.95,
        sum(rate(nginx_ingress_controller_request_duration_seconds_bucket[5m])) by (le, ingress)
      ) > 1
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "Ingresså“åº”å»¶è¿Ÿè¿‡é«˜"
      description: "Ingress {{$labels.ingress}} çš„P95å“åº”æ—¶é—´è¶…è¿‡1ç§’ï¼Œå½“å‰å€¼ï¼š{{$value}}ç§’"

  # SSLè¯ä¹¦å³å°†è¿‡æœŸ
  - alert: IngressSSLCertificateExpiring
    expr: (nginx_ingress_controller_ssl_certificate_info - time()) / 86400 < 30
    for: 1h
    labels:
      severity: warning
    annotations:
      summary: "SSLè¯ä¹¦å³å°†è¿‡æœŸ"
      description: "Ingress {{$labels.ingress}} çš„SSLè¯ä¹¦å°†åœ¨ {{$value}} å¤©åè¿‡æœŸ"

  # é«˜æµé‡å‘Šè­¦
  - alert: IngressHighTraffic
    expr: sum(rate(nginx_ingress_controller_requests_total[5m])) by (ingress) > 1000
    for: 5m
    labels:
      severity: info
    annotations:
      summary: "Ingressæµé‡å¼‚å¸¸é«˜"
      description: "Ingress {{$labels.ingress}} çš„QPSè¶…è¿‡1000ï¼Œå½“å‰å€¼ï¼š{{$value}}"
```

---

## 8. ğŸ’¿ å­˜å‚¨PV/PVCç›‘æ§


### 8.1 K8så­˜å‚¨ç›‘æ§æ¦‚å¿µ


**å­˜å‚¨æ¶æ„ç†è§£ï¼š**
```
K8så­˜å‚¨ä¸‰å±‚æ¦‚å¿µï¼š

StorageClass (å­˜å‚¨ç±»)
    â†“ (åŠ¨æ€ä¾›åº”)
PersistentVolume (æŒä¹…å·ï¼ŒPV)  
    â†“ (ç»‘å®šå…³ç³»)
PersistentVolumeClaim (æŒä¹…å·å£°æ˜ï¼ŒPVC)
    â†“ (æŒ‚è½½)
Pod (å®¹å™¨)

ç®€å•ç±»æ¯”ï¼š
StorageClass = æˆ¿å±‹ç±»å‹æ ‡å‡† (å¦‚ï¼šé«˜æ¡£å°åŒºã€ç»æµé€‚ç”¨æˆ¿)
PV = å…·ä½“æˆ¿å±‹ (æŸä¸ªç¡®åˆ‡çš„æˆ¿å­)
PVC = ç§Ÿæˆ¿ç”³è¯· (ç§Ÿæˆ·çš„éœ€æ±‚å£°æ˜)
Pod = ç§Ÿæˆ· (å®é™…ä½¿ç”¨è€…)
```

### 8.2 å­˜å‚¨ç›‘æ§æ ¸å¿ƒæŒ‡æ ‡


**PV/PVCçŠ¶æ€ç›‘æ§ï¼š**
```yaml
PVçŠ¶æ€æŒ‡æ ‡ï¼š
- kube_persistentvolume_infoï¼šPVåŸºæœ¬ä¿¡æ¯
- kube_persistentvolume_status_phaseï¼šPVçŠ¶æ€ (Available/Bound/Released/Failed)
- kube_persistentvolume_capacity_bytesï¼šPVå®¹é‡å¤§å°

PVCçŠ¶æ€æŒ‡æ ‡ï¼š
- kube_persistentvolumeclaim_infoï¼šPVCåŸºæœ¬ä¿¡æ¯
- kube_persistentvolumeclaim_status_phaseï¼šPVCçŠ¶æ€ (Pending/Bound/Lost)
- kube_persistentvolumeclaim_resource_requests_storage_bytesï¼šPVCè¯·æ±‚å­˜å‚¨å¤§å°

å­˜å‚¨ä½¿ç”¨ç‡æŒ‡æ ‡ï¼š
- kubelet_volume_stats_capacity_bytesï¼šå·æ€»å®¹é‡
- kubelet_volume_stats_available_bytesï¼šå·å¯ç”¨ç©ºé—´
- kubelet_volume_stats_used_bytesï¼šå·å·²ç”¨ç©ºé—´
```

### 8.3 å­˜å‚¨ç›‘æ§é…ç½®


**å­˜å‚¨ä½¿ç”¨ç‡è®¡ç®—ï¼š**
```yaml
# å·ä½¿ç”¨ç‡æŸ¥è¯¢
(kubelet_volume_stats_used_bytes / kubelet_volume_stats_capacity_bytes) * 100

# æŒ‰PVCç»Ÿè®¡ä½¿ç”¨ç‡
(
  kubelet_volume_stats_used_bytes{job="kubelet"} / 
  kubelet_volume_stats_capacity_bytes{job="kubelet"}
) * 100

# å‰©ä½™ç©ºé—´ç›‘æ§
kubelet_volume_stats_available_bytes / 1024 / 1024 / 1024  # è½¬æ¢ä¸ºGB
```

**ç›‘æ§ç¤ºä¾‹é…ç½®ï¼š**
```yaml
# åˆ›å»ºæµ‹è¯•PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
  namespace: default
  labels:
    app: test-storage
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
---
# ä½¿ç”¨PVCçš„Pod
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  labels:
    app: test-storage
spec:
  containers:
  - name: test-container
    image: busybox
    command: ['sh', '-c', 'while true; do echo "$(date): Writing data..." >> /data/test.log; sleep 60; done']
    volumeMounts:
    - name: test-volume
      mountPath: /data
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"
  volumes:
  - name: test-volume
    persistentVolumeClaim:
      claimName: test-pvc
```

### 8.4 å­˜å‚¨å‘Šè­¦è§„åˆ™


```yaml
# storage-alerts.yaml
groups:
- name: storage-alerts
  rules:
  # PVCä½¿ç”¨ç‡å‘Šè­¦
  - alert: PVCHighUsage
    expr: |
      (
        kubelet_volume_stats_used_bytes{job="kubelet"} / 
        kubelet_volume_stats_capacity_bytes{job="kubelet"}
      ) * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "PVCå­˜å‚¨ä½¿ç”¨ç‡è¿‡é«˜"
      description: "PVC {{$labels.persistentvolumeclaim}} (å‘½åç©ºé—´: {{$labels.namespace}}) çš„å­˜å‚¨ä½¿ç”¨ç‡å·²è¾¾åˆ° {{$value}}%"

  # PVCå‰©ä½™ç©ºé—´ä¸è¶³
  - alert: PVCLowSpace
    expr: kubelet_volume_stats_available_bytes{job="kubelet"} / 1024 / 1024 / 1024 < 2
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "PVCå‰©ä½™ç©ºé—´ä¸è¶³"
      description: "PVC {{$labels.persistentvolumeclaim}} (å‘½åç©ºé—´: {{$labels.namespace}}) å‰©ä½™ç©ºé—´ä¸è¶³2GBï¼Œå½“å‰å‰©ä½™: {{$value}}GB"

  # PVCçŠ¶æ€å¼‚å¸¸
  - alert: PVCStatusAbnormal
    expr: kube_persistentvolumeclaim_status_phase{phase!="Bound"} == 1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "PVCçŠ¶æ€å¼‚å¸¸"
      description: "PVC {{$labels.persistentvolumeclaim}} (å‘½åç©ºé—´: {{$labels.namespace}}) çŠ¶æ€ä¸º {{$labels.phase}}ï¼Œä¸æ˜¯æ­£å¸¸çš„BoundçŠ¶æ€"

  # PVçŠ¶æ€å¼‚å¸¸
  - alert: PVStatusAbnormal
    expr: kube_persistentvolume_status_phase{phase!="Bound",phase!="Available"} == 1
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "PVçŠ¶æ€å¼‚å¸¸"
      description: "PV {{$labels.persistentvolume}} çŠ¶æ€ä¸º {{$labels.phase}}ï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜"

  # å­˜å‚¨ç±»åŠ¨æ€ä¾›åº”å¤±è´¥
  - alert: StorageProvisioningFailed
    expr: increase(storage_operation_errors_total{operation_name="provision"}[10m]) > 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: "å­˜å‚¨åŠ¨æ€ä¾›åº”å¤±è´¥"
      description: "å­˜å‚¨ç±»åŠ¨æ€ä¾›åº”åœ¨è¿‡å»10åˆ†é’Ÿå†…å‡ºç°äº† {{$value}} æ¬¡å¤±è´¥"
```

---

## 9. ğŸ”’ ç½‘ç»œç­–ç•¥ç›‘æ§


### 9.1 ç½‘ç»œç­–ç•¥æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ç½‘ç»œç­–ç•¥ï¼Ÿ**
ç½‘ç»œç­–ç•¥å°±åƒæ˜¯é›†ç¾¤å†…éƒ¨çš„"é˜²ç«å¢™è§„åˆ™"ï¼Œæ§åˆ¶Podä¹‹é—´çš„ç½‘ç»œé€šä¿¡ï¼š

```
ç½‘ç»œç­–ç•¥ä½œç”¨ï¼š

é»˜è®¤è¡Œä¸ºï¼š
- æ²¡æœ‰ç½‘ç»œç­–ç•¥æ—¶ï¼Œæ‰€æœ‰Podä¹‹é—´å¯ä»¥è‡ªç”±é€šä¿¡
- å°±åƒä¸€ä¸ªå¤§æˆ¿å­é‡Œï¼Œæ‰€æœ‰æˆ¿é—´çš„é—¨éƒ½æ˜¯å¼€ç€çš„

åº”ç”¨ç½‘ç»œç­–ç•¥åï¼š
- åªæœ‰è¢«æ˜ç¡®å…è®¸çš„é€šä¿¡æ‰èƒ½è¿›è¡Œ
- å°±åƒç»™æˆ¿é—´å®‰è£…äº†é—¨é”ï¼Œåªæœ‰æœ‰é’¥åŒ™çš„äººæ‰èƒ½è¿›å…¥

å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
âœ… å‰ç«¯Podåªèƒ½è®¿é—®åç«¯Podï¼Œä¸èƒ½è®¿é—®æ•°æ®åº“Pod
âœ… æ•°æ®åº“Podåªå…è®¸åç«¯Podè®¿é—®ï¼Œæ‹’ç»å…¶ä»–è®¿é—®
âœ… ç®¡ç†å‘˜Podå¯ä»¥è®¿é—®æ‰€æœ‰èµ„æºï¼Œæ™®é€šç”¨æˆ·Podå—é™
```

### 9.2 ç½‘ç»œç­–ç•¥ç›‘æ§æŒ‡æ ‡


**æ ¸å¿ƒç›‘æ§å†…å®¹ï¼š**
```yaml
ç­–ç•¥çŠ¶æ€ç›‘æ§ï¼š
- kube_networkpolicy_infoï¼šç½‘ç»œç­–ç•¥åŸºæœ¬ä¿¡æ¯
- kube_networkpolicy_spec_*ï¼šç­–ç•¥è§„åˆ™è¯¦æƒ…

ç½‘ç»œè¿æ¥ç›‘æ§ï¼š
- è¿æ¥æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- ç­–ç•¥è¿è§„äº‹ä»¶
- ç½‘ç»œå»¶è¿Ÿå˜åŒ–

æµé‡æ¨¡å¼ç›‘æ§ï¼š
- Podé—´é€šä¿¡æµé‡
- æœåŠ¡é—´è®¿é—®æ¨¡å¼
- å¼‚å¸¸è®¿é—®æ£€æµ‹
```

### 9.3 ç½‘ç»œç­–ç•¥ç¤ºä¾‹ä¸ç›‘æ§


**åˆ›å»ºç½‘ç»œç­–ç•¥ç¤ºä¾‹ï¼š**
```yaml
# æ•°æ®åº“è®¿é—®æ§åˆ¶ç­–ç•¥
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-network-policy
  namespace: production
spec:
  # åº”ç”¨åˆ°mysql Pod
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # åªå…è®¸åç«¯åº”ç”¨è®¿é—®æ•°æ®åº“
  - from:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 3306
  egress:
  # æ•°æ®åº“åªèƒ½è®¿é—®DNSå’Œå¤–éƒ¨å¤‡ä»½æœåŠ¡
  - to: []
    ports:
    - protocol: UDP
      port: 53  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: backup-system
    ports:
    - protocol: TCP
      port: 443

---
# å‰ç«¯è®¿é—®æ§åˆ¶ç­–ç•¥  
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # å…è®¸æ¥è‡ªingress-nginxçš„è®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
  egress:
  # å‰ç«¯åªèƒ½è®¿é—®åç«¯APIï¼Œä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®åº“
  - to:
    - podSelector:
        matchLabels:
          app: backend
    ports:
    - protocol: TCP
      port: 8080
  # å…è®¸DNSæŸ¥è¯¢
  - to: []
    ports:
    - protocol: UDP
      port: 53
```

### 9.4 ç½‘ç»œç­–ç•¥ç›‘æ§é…ç½®


**ç›‘æ§ç½‘ç»œç­–ç•¥çŠ¶æ€ï¼š**
```yaml
# ç½‘ç»œç­–ç•¥ç›‘æ§æŸ¥è¯¢
# ç»Ÿè®¡æ¯ä¸ªå‘½åç©ºé—´çš„ç½‘ç»œç­–ç•¥æ•°é‡
count by (namespace) (kube_networkpolicy_info)

# æ£€æŸ¥ç½‘ç»œç­–ç•¥æ˜¯å¦æ­£ç¡®åº”ç”¨
kube_networkpolicy_info{namespace="production"}

# ç›‘æ§ç½‘ç»œç­–ç•¥è¦†ç›–çš„Podæ•°é‡
sum by (namespace, networkpolicy) (
  kube_pod_info * on (namespace, pod) 
  group_left(networkpolicy) kube_networkpolicy_info
)
```

### 9.5 ç½‘ç»œè¿æ¥ç›‘æ§


**ä½¿ç”¨ç½‘ç»œç›‘æ§å·¥å…·ï¼š**
```yaml
# éƒ¨ç½²ç½‘ç»œç›‘æ§ sidecar
apiVersion: apps/v1
kind: Deployment
metadata:
  name: network-monitor
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: network-monitor
  template:
    metadata:
      labels:
        app: network-monitor
    spec:
      containers:
      # ä¸»åº”ç”¨å®¹å™¨
      - name: app
        image: nginx:1.21
        ports:
        - containerPort: 80
      # ç½‘ç»œç›‘æ§ sidecar
      - name: network-exporter
        image: prom/blackbox-exporter:v0.24.0
        args:
        - '--config.file=/etc/blackbox/config.yml'
        ports:
        - containerPort: 9115
        volumeMounts:
        - name: blackbox-config
          mountPath: /etc/blackbox
      volumes:
      - name: blackbox-config
        configMap:
          name: blackbox-config
---
# Blackboxé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-config
  namespace: monitoring
data:
  config.yml: |
    modules:
      tcp_connect:
        prober: tcp
        timeout: 5s
        tcp:
          preferred_ip_protocol: "ip4"
      http_2xx:
        prober: http
        timeout: 5s
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
          valid_status_codes: []
          method: GET
          preferred_ip_protocol: "ip4"
```

**ç½‘ç»œè¿æ¥å‘Šè­¦è§„åˆ™ï¼š**
```yaml
# network-policy-alerts.yaml
groups:
- name: network-policy-alerts
  rules:
  # ç½‘ç»œè¿æ¥å¤±è´¥å‘Šè­¦
  - alert: NetworkConnectivityFailure
    expr: probe_success{job="blackbox"} == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "ç½‘ç»œè¿æ¥æ£€æµ‹å¤±è´¥"
      description: "ä» {{$labels.instance}} åˆ°ç›®æ ‡æœåŠ¡çš„ç½‘ç»œè¿æ¥æ£€æµ‹å¤±è´¥"

  # ç½‘ç»œç­–ç•¥å¯èƒ½é˜»æ–­äº†é¢„æœŸè¿æ¥
  - alert: NetworkPolicyBlocking
    expr: |
      increase(prometheus_rule_evaluation_failures_total[10m]) > 0
      and on() kube_networkpolicy_info
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ç½‘ç»œç­–ç•¥å¯èƒ½é˜»æ–­äº†è¿æ¥"
      description: "æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œå¯èƒ½ä¸ç½‘ç»œç­–ç•¥é…ç½®æœ‰å…³"

  # æ£€æµ‹æœªå—ç½‘ç»œç­–ç•¥ä¿æŠ¤çš„Pod
  - alert: PodsWithoutNetworkPolicy
    expr: |
      count by (namespace) (
        kube_pod_info{namespace!~"kube-system|kube-public|monitoring"}
      ) 
      > 
      count by (namespace) (
        kube_networkpolicy_info
      ) * 2
    for: 30m
    labels:
      severity: info
    annotations:
      summary: "å‘½åç©ºé—´ç¼ºå°‘ç½‘ç»œç­–ç•¥ä¿æŠ¤"
      description: "å‘½åç©ºé—´ {{$labels.namespace}} ä¸­æœ‰è¾ƒå¤šPodæœªå—ç½‘ç»œç­–ç•¥ä¿æŠ¤ï¼Œå»ºè®®æ£€æŸ¥å®‰å…¨é…ç½®"
```

---

## 10. âš™ï¸ ç›‘æ§é…ç½®æœ€ä½³å®è·µ


### 10.1 èµ„æºé…ç½®ä¼˜åŒ–


**Prometheusèµ„æºé…ç½®å»ºè®®ï¼š**
```yaml
# prometheus-deployment.yaml èµ„æºé…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  template:
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:v2.45.0
        resources:
          requests:
            memory: "2Gi"      # æ ¹æ®ç›‘æ§è§„æ¨¡è°ƒæ•´
            cpu: "500m"
          limits:
            memory: "4Gi"      # é¢„ç•™è¶³å¤Ÿå†…å­˜é˜²æ­¢OOM
            cpu: "2"
        # å­˜å‚¨é…ç½®
        volumeMounts:
        - name: prometheus-storage
          mountPath: /prometheus
        # å¯åŠ¨å‚æ•°ä¼˜åŒ–
        args:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--storage.tsdb.retention.time=30d'     # æ•°æ®ä¿ç•™30å¤©
        - '--storage.tsdb.retention.size=100GB'   # æœ€å¤§å­˜å‚¨100GB
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--web.enable-lifecycle'
        - '--web.enable-admin-api'
        - '--storage.tsdb.no-lockfile'
```

### 10.2 ç›‘æ§æ•°æ®é‡‡é›†ä¼˜åŒ–


**é‡‡é›†é¢‘ç‡é…ç½®ï¼š**
```yaml
# prometheus.yml é‡‡é›†é…ç½®ä¼˜åŒ–
global:
  scrape_interval: 30s        # å…¨å±€é‡‡é›†é—´éš”30ç§’
  evaluation_interval: 30s    # è§„åˆ™è¯„ä¼°é—´éš”30ç§’
  external_labels:
    cluster: 'production'     # é›†ç¾¤æ ‡è¯†

scrape_configs:
# é«˜é¢‘ç›‘æ§ï¼šå…³é”®ç»„ä»¶
- job_name: 'kubernetes-apiservers'
  scrape_interval: 15s        # APIæœåŠ¡å™¨15ç§’é‡‡é›†ä¸€æ¬¡
  kubernetes_sd_configs:
  - role: endpoints
    namespaces:
      names: [default]

# ä¸­é¢‘ç›‘æ§ï¼šä¸šåŠ¡åº”ç”¨
- job_name: 'kubernetes-pods'
  scrape_interval: 30s        # ä¸šåŠ¡Pod 30ç§’é‡‡é›†ä¸€æ¬¡
  kubernetes_sd_configs:
  - role: pod

# ä½é¢‘ç›‘æ§ï¼šèµ„æºçŠ¶æ€
- job_name: 'kube-state-metrics'
  scrape_interval: 60s        # çŠ¶æ€ä¿¡æ¯60ç§’é‡‡é›†ä¸€æ¬¡
  static_configs:
  - targets: ['kube-state-metrics:8080']

# æä½é¢‘ç›‘æ§ï¼šé…ç½®ä¿¡æ¯
- job_name: 'kubernetes-cluster-info'
  scrape_interval: 300s       # é›†ç¾¤ä¿¡æ¯5åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡
  kubernetes_sd_configs:
  - role: service
```

### 10.3 æ ‡ç­¾ç®¡ç†ç­–ç•¥


**ç»Ÿä¸€æ ‡ç­¾è§„èŒƒï¼š**
```yaml
# æ ‡ç­¾é‡å‘½åå’Œæ¸…ç†é…ç½®
relabel_configs:
# ä¿ç•™æœ‰ç”¨çš„K8sæ ‡ç­¾
- source_labels: [__meta_kubernetes_namespace]
  target_label: kubernetes_namespace
- source_labels: [__meta_kubernetes_pod_name]
  target_label: kubernetes_pod_name
- source_labels: [__meta_kubernetes_pod_label_app]
  target_label: app
- source_labels: [__meta_kubernetes_pod_label_version]
  target_label: version

# åˆ é™¤ä¸éœ€è¦çš„æ ‡ç­¾ä»¥èŠ‚çœå­˜å‚¨
- regex: '__meta_kubernetes_pod_label_pod_template_.*'
  action: labeldrop
- regex: '__meta_kubernetes_pod_annotation_.*'
  action: labeldrop

# æ·»åŠ è‡ªå®šä¹‰ä¸šåŠ¡æ ‡ç­¾
- source_labels: [__meta_kubernetes_pod_label_team]
  target_label: team
- source_labels: [__meta_kubernetes_pod_label_env]
  target_label: environment
```

### 10.4 å‘Šè­¦è§„åˆ™ç»„ç»‡


**å‘Šè­¦è§„åˆ™åˆ†å±‚ç®¡ç†ï¼š**
```yaml
# alerts/
â”œâ”€â”€ infrastructure/           # åŸºç¡€è®¾æ–½å‘Šè­¦
â”‚   â”œâ”€â”€ node-alerts.yaml
â”‚   â”œâ”€â”€ cluster-alerts.yaml
â”‚   â””â”€â”€ storage-alerts.yaml
â”œâ”€â”€ application/             # åº”ç”¨å±‚å‘Šè­¦
â”‚   â”œâ”€â”€ pod-alerts.yaml
â”‚   â”œâ”€â”€ service-alerts.yaml
â”‚   â””â”€â”€ ingress-alerts.yaml
â”œâ”€â”€ business/               # ä¸šåŠ¡å‘Šè­¦
â”‚   â”œâ”€â”€ api-alerts.yaml
â”‚   â”œâ”€â”€ database-alerts.yaml
â”‚   â””â”€â”€ queue-alerts.yaml
â””â”€â”€ security/              # å®‰å…¨å‘Šè­¦
    â”œâ”€â”€ network-policy-alerts.yaml
    â””â”€â”€ rbac-alerts.yaml
```

**å‘Šè­¦çº§åˆ«è§„èŒƒï¼š**
```yaml
# å‘Šè­¦çº§åˆ«å®šä¹‰
labels:
  severity: critical    # ç´§æ€¥ï¼šéœ€è¦ç«‹å³å¤„ç†ï¼Œå½±å“æœåŠ¡å¯ç”¨æ€§
  severity: warning     # è­¦å‘Šï¼šéœ€è¦å…³æ³¨ï¼Œå¯èƒ½å½±å“æœåŠ¡è´¨é‡  
  severity: info        # ä¿¡æ¯ï¼šä»…é€šçŸ¥ï¼Œä¸éœ€è¦ç«‹å³å¤„ç†

# å‘Šè­¦è·¯ç”±é…ç½®ç¤ºä¾‹
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default'
  routes:
  # ç´§æ€¥å‘Šè­¦ç«‹å³å‘é€
  - match:
      severity: critical
    receiver: 'critical-alerts'
    group_wait: 0s
    repeat_interval: 5m
  # è­¦å‘Šçº§åˆ«æ­£å¸¸å¤„ç†
  - match:
      severity: warning  
    receiver: 'warning-alerts'
    repeat_interval: 2h
  # ä¿¡æ¯çº§åˆ«æ‰¹é‡å‘é€
  - match:
      severity: info
    receiver: 'info-alerts'
    group_interval: 30m
    repeat_interval: 24h
```

### 10.5 ç›‘æ§æ•°æ®å¤‡ä»½ç­–ç•¥


**Prometheusæ•°æ®å¤‡ä»½ï¼š**
```yaml
# å¤‡ä»½CronJobé…ç½®
apiVersion: batch/v1
kind: CronJob
metadata:
  name: prometheus-backup
  namespace: monitoring
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: alpine:3.16
            command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache curl tar gzip aws-cli
              
              # åˆ›å»ºå¿«ç…§
              curl -XPOST http://prometheus:9090/api/v1/admin/tsdb/snapshot
              
              # æ‰“åŒ…å¤‡ä»½æ–‡ä»¶
              tar czf /backup/prometheus-$(date +%Y%m%d).tar.gz /prometheus/snapshots/
              
              # ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
              aws s3 cp /backup/prometheus-$(date +%Y%m%d).tar.gz s3://prometheus-backups/
              
              # æ¸…ç†æœ¬åœ°æ–‡ä»¶
              rm -f /backup/prometheus-$(date +%Y%m%d).tar.gz
            volumeMounts:
            - name: prometheus-storage
              mountPath: /prometheus
              readOnly: true
            - name: backup-storage
              mountPath: /backup
            env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
          restartPolicy: OnFailure
          volumes:
          - name: prometheus-storage
            persistentVolumeClaim:
              claimName: prometheus-storage
          - name: backup-storage
            emptyDir: {}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ K8sç›‘æ§ä¸‰å¤§æ”¯æŸ±ï¼škube-state-metricsã€node-exporterã€cadvisor
ğŸ”¸ Podç›‘æ§é‡ç‚¹ï¼šçŠ¶æ€ã€èµ„æºä½¿ç”¨ã€é‡å¯æ¬¡æ•°ã€ç½‘ç»œæµé‡
ğŸ”¸ Serviceç›‘æ§å…³æ³¨ï¼šç«¯ç‚¹å¥åº·ã€è´Ÿè½½å‡è¡¡ã€å“åº”æ—¶é—´
ğŸ”¸ äº‹ä»¶ç›‘æ§ä»·å€¼ï¼šå¿«é€Ÿå‘ç°é›†ç¾¤å¼‚å¸¸å’Œæ•…éšœæ ¹å› 
ğŸ”¸ èµ„æºé…é¢ç›‘æ§ï¼šé˜²æ­¢èµ„æºæ»¥ç”¨ï¼Œä¿éšœé›†ç¾¤ç¨³å®š
ğŸ”¸ Ingressç›‘æ§ç»´åº¦ï¼šQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ã€SSLè¯ä¹¦
ğŸ”¸ å­˜å‚¨ç›‘æ§è¦ç‚¹ï¼šPV/PVCçŠ¶æ€ã€ä½¿ç”¨ç‡ã€å‰©ä½™ç©ºé—´
ğŸ”¸ ç½‘ç»œç­–ç•¥ç›‘æ§ï¼šè¿æ¥çŠ¶æ€ã€ç­–ç•¥è¦†ç›–ã€å®‰å…¨åˆè§„
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚ç›‘æ§**
```
åŸºç¡€è®¾æ–½å±‚ï¼š
- ç¡®ä¿èŠ‚ç‚¹å’Œé›†ç¾¤åŸºç¡€ç»„ä»¶å¥åº·
- ç›‘æ§CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰èµ„æº

å¹³å°å±‚ï¼š
- ç›‘æ§K8så¯¹è±¡çŠ¶æ€å’Œé›†ç¾¤äº‹ä»¶
- ç¡®ä¿Podã€Serviceã€Deploymentç­‰æ­£å¸¸è¿è¡Œ

åº”ç”¨å±‚ï¼š
- ç›‘æ§ä¸šåŠ¡æŒ‡æ ‡å’Œç”¨æˆ·ä½“éªŒ
- å…³æ³¨æœåŠ¡è´¨é‡å’Œä¸šåŠ¡è¿ç»­æ€§

ä¸‰å±‚ç»“åˆæ‰èƒ½å…¨é¢æŒæ§ç³»ç»Ÿå¥åº·çŠ¶æ€
```

**ğŸ”¹ ç›‘æ§æ•°æ®çš„ä»·å€¼æŒ–æ˜**
```
æ•…éšœé¢„è­¦ï¼š
- é€šè¿‡è¶‹åŠ¿åˆ†ææå‰å‘ç°æ½œåœ¨é—®é¢˜
- è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼é¿å…è¯¯æŠ¥

æ€§èƒ½ä¼˜åŒ–ï¼š
- è¯†åˆ«èµ„æºç“¶é¢ˆå’Œæ€§èƒ½çƒ­ç‚¹
- æŒ‡å¯¼å®¹é‡è§„åˆ’å’Œæ‰©å®¹å†³ç­–

å®‰å…¨å®¡è®¡ï¼š
- ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼
- æ£€æŸ¥ç½‘ç»œç­–ç•¥åˆè§„æ€§

æˆæœ¬æ§åˆ¶ï¼š
- åˆ†æèµ„æºä½¿ç”¨æ•ˆç‡
- ä¼˜åŒ–èµ„æºé…ç½®å‡å°‘æµªè´¹
```

**ğŸ”¹ ç›‘æ§é…ç½®çš„å¹³è¡¡è‰ºæœ¯**
```
é‡‡é›†é¢‘ç‡ vs å­˜å‚¨æˆæœ¬ï¼š
- å…³é”®æŒ‡æ ‡é«˜é¢‘é‡‡é›†ï¼Œæ™®é€šæŒ‡æ ‡ä½é¢‘é‡‡é›†
- åˆç†è®¾ç½®æ•°æ®ä¿ç•™æœŸé™

ç›‘æ§è¦†ç›– vs ç³»ç»Ÿè´Ÿè½½ï¼š
- é‡è¦ç»„ä»¶å…¨é¢ç›‘æ§ï¼Œè¾¹ç¼˜ç»„ä»¶é‡ç‚¹ç›‘æ§
- é¿å…è¿‡åº¦ç›‘æ§å½±å“ç³»ç»Ÿæ€§èƒ½

å‘Šè­¦æ•æ„Ÿåº¦ vs å™ªéŸ³æ§åˆ¶ï¼š
- å…³é”®å‘Šè­¦ç«‹å³è§¦å‘ï¼Œä¸€èˆ¬å‘Šè­¦é€‚å½“å»¶è¿Ÿ
- è®¾ç½®å‘Šè­¦èšåˆå’ŒæŠ‘åˆ¶è§„åˆ™
```

### 11.3 å®è·µåº”ç”¨æŒ‡å¯¼


**ğŸ“Š ç›‘æ§å®æ–½è·¯çº¿å›¾**
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ç›‘æ§
âœ… éƒ¨ç½²kube-state-metricsã€node-exporter
âœ… é…ç½®åŸºæœ¬çš„Podã€Nodeç›‘æ§
âœ… è®¾ç½®å…³é”®èµ„æºå‘Šè­¦

ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡ç›‘æ§  
âœ… é…ç½®Serviceã€Ingressç›‘æ§
âœ… å®æ–½äº‹ä»¶ç›‘æ§å’Œæ—¥å¿—èšåˆ
âœ… å»ºç«‹ä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§
âœ… ç½‘ç»œç­–ç•¥å’Œå®‰å…¨ç›‘æ§
âœ… å­˜å‚¨å’Œèµ„æºé…é¢ç›‘æ§
âœ… è‡ªåŠ¨åŒ–è¿ç»´å’Œæ™ºèƒ½å‘Šè­¦

ç¬¬å››é˜¶æ®µï¼šæŒç»­ä¼˜åŒ–
âœ… ç›‘æ§æ•°æ®åˆ†æå’Œè¶‹åŠ¿é¢„æµ‹
âœ… æˆæœ¬ä¼˜åŒ–å’Œæ€§èƒ½è°ƒä¼˜
âœ… ç›‘æ§æ¶æ„æ‰©å±•å’Œå‡çº§
```

**ğŸ›  å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ**
```
æ•°æ®é‡‡é›†é—®é¢˜ï¼š
- kube-state-metricsè¿æ¥å¤±è´¥ï¼šæ£€æŸ¥RBACæƒé™é…ç½®
- æŒ‡æ ‡æ•°æ®ç¼ºå¤±ï¼šéªŒè¯Service Discoveryé…ç½®
- é‡‡é›†å»¶è¿Ÿè¿‡é«˜ï¼šè°ƒæ•´scrape_intervalå’Œè¶…æ—¶è®¾ç½®

å­˜å‚¨ç©ºé—´é—®é¢˜ï¼š
- Prometheuså­˜å‚¨æ»¡äº†ï¼šè°ƒæ•´retentionç­–ç•¥æˆ–å¢åŠ å­˜å‚¨
- æŸ¥è¯¢å“åº”æ…¢ï¼šä¼˜åŒ–PromQLæŸ¥è¯¢æˆ–å¢åŠ å†…å­˜
- æ•°æ®å‹ç¼©ç‡ä½ï¼šæ£€æŸ¥æ ‡ç­¾åŸºæ•°æ˜¯å¦è¿‡é«˜

å‘Šè­¦é…ç½®é—®é¢˜ï¼š
- å‘Šè­¦é£æš´ï¼šè®¾ç½®å‘Šè­¦èšåˆå’ŒæŠ‘åˆ¶è§„åˆ™
- è¯¯æŠ¥è¿‡å¤šï¼šè°ƒæ•´å‘Šè­¦é˜ˆå€¼å’ŒæŒç»­æ—¶é—´
- é‡è¦å‘Šè­¦é—æ¼ï¼šæ£€æŸ¥å‘Šè­¦è·¯ç”±é…ç½®
```

**ğŸ¯ ç›‘æ§æ•ˆæœè¯„ä¼°**
```
æŠ€æœ¯æŒ‡æ ‡ï¼š
- MTTR (å¹³å‡æ¢å¤æ—¶é—´)ï¼šæ•…éšœæ£€æµ‹åˆ°ä¿®å¤çš„æ—¶é—´
- MTTD (å¹³å‡æ£€æµ‹æ—¶é—´)ï¼šæ•…éšœå‘ç”Ÿåˆ°æ£€æµ‹çš„æ—¶é—´
- å‘Šè­¦å‡†ç¡®ç‡ï¼šçœŸå®å‘Šè­¦ / æ€»å‘Šè­¦æ•°
- ç›‘æ§è¦†ç›–ç‡ï¼šè¢«ç›‘æ§èµ„æº / æ€»èµ„æºæ•°

ä¸šåŠ¡ä»·å€¼ï¼š
- ç³»ç»Ÿå¯ç”¨æ€§æå‡ï¼šå‡å°‘æœåŠ¡ä¸­æ–­æ—¶é—´
- è¿ç»´æ•ˆç‡æå‡ï¼šè‡ªåŠ¨åŒ–å‘Šè­¦å’Œå¤„ç†
- æˆæœ¬æ§åˆ¶æ”¹å–„ï¼šèµ„æºä½¿ç”¨ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒæ”¹å–„ï¼šæ€§èƒ½é—®é¢˜å¿«é€Ÿå®šä½
```

### 11.4 è¿›é˜¶å­¦ä¹ å»ºè®®


**ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘**
```
ç›‘æ§æ¶æ„è®¾è®¡ï¼š
- å¤šé›†ç¾¤ç›‘æ§è”é‚¦
- é•¿æœŸå­˜å‚¨æ–¹æ¡ˆ (Thanosã€Cortex)
- ç›‘æ§æ•°æ®æ¹–æ„å»º

é«˜çº§æŸ¥è¯¢æŠ€å·§ï¼š
- å¤æ‚PromQLæŸ¥è¯¢ä¼˜åŒ–
- è‡ªå®šä¹‰æŒ‡æ ‡å¼€å‘
- ç›‘æ§æ•°æ®å¯è§†åŒ–

è‡ªåŠ¨åŒ–è¿ç»´ï¼š
- åŸºäºç›‘æ§çš„è‡ªåŠ¨æ‰©ç¼©å®¹
- æ™ºèƒ½å‘Šè­¦é™å™ª
- æ•…éšœè‡ªæ„ˆæœºåˆ¶

äº‘åŸç”Ÿç›‘æ§ï¼š
- æœåŠ¡ç½‘æ ¼ç›‘æ§ (Istio)
- Serverlessç›‘æ§
- å¤šäº‘ç¯å¢ƒç›‘æ§
```

**ğŸ”§ å®è·µé¡¹ç›®å»ºè®®**
```
åˆçº§é¡¹ç›®ï¼š
- æ­å»ºå®Œæ•´çš„K8sç›‘æ§ä½“ç³»
- é…ç½®å¸¸ç”¨çš„å‘Šè­¦è§„åˆ™
- åˆ¶ä½œç›‘æ§ä»ªè¡¨æ¿

ä¸­çº§é¡¹ç›®ï¼š
- å®ç°å¤šé›†ç¾¤ç›‘æ§
- å¼€å‘è‡ªå®šä¹‰exporter
- é›†æˆæ—¥å¿—å’Œé“¾è·¯è¿½è¸ª

é«˜çº§é¡¹ç›®ï¼š
- æ„å»ºç›‘æ§å³ä»£ç  (Monitoring as Code)
- å®ç°æ™ºèƒ½å¼‚å¸¸æ£€æµ‹
- è®¾è®¡ç›‘æ§æ¶æ„é«˜å¯ç”¨æ–¹æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
K8sç›‘æ§ä¸‰å¤§ä»¶ï¼ŒçŠ¶æ€æŒ‡æ ‡ä¸èƒ½ç¼º
PodèŠ‚ç‚¹æœåŠ¡é“¾ï¼Œäº‹ä»¶å­˜å‚¨ç½‘ç»œå…¨
é…é¢ç­–ç•¥è¦ç›‘æ§ï¼Œå‘Šè­¦è§„åˆ™åˆ†å±‚çº§
é‡‡é›†å­˜å‚¨è¦å¹³è¡¡ï¼Œå®è·µä¼˜åŒ–æ­¥æ­¥æ¥
```

**æœ€ç»ˆå»ºè®®**ï¼š
- **å¾ªåºæ¸è¿›**ï¼šä»åŸºç¡€ç›‘æ§å¼€å§‹ï¼Œé€æ­¥æ‰©å±•é«˜çº§åŠŸèƒ½
- **å®è·µå¯¼å‘**ï¼šç†è®ºå­¦ä¹ ä¸åŠ¨æ‰‹å®è·µç›¸ç»“åˆ
- **æŒç»­æ”¹è¿›**ï¼šå®šæœŸå›é¡¾å’Œä¼˜åŒ–ç›‘æ§é…ç½®
- **ç¤¾åŒºäº¤æµ**ï¼šå‚ä¸å¼€æºç¤¾åŒºï¼Œå­¦ä¹ æœ€ä½³å®è·µ

é€šè¿‡ç³»ç»Ÿå­¦ä¹ å’Œå®è·µK8sç›‘æ§ï¼Œä½ å°†èƒ½å¤Ÿæ„å»ºç¨³å®šå¯é çš„å®¹å™¨åŒ–åº”ç”¨ç›‘æ§ä½“ç³»ï¼Œä¸ºä¸šåŠ¡çš„ç¨³å®šè¿è¡Œæä¾›å¼ºæœ‰åŠ›çš„ä¿éšœã€‚