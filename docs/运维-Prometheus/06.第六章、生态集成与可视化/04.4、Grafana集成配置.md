---
title: 4、Grafana集成配置
---
## 📚 目录

1. [Grafana与Prometheus概述](#1-Grafana与Prometheus概述)
2. [Prometheus数据源配置](#2-Prometheus数据源配置)
3. [Dashboard仪表板创建](#3-Dashboard仪表板创建)
4. [Panel面板类型与应用](#4-Panel面板类型与应用)
5. [查询编辑器使用技巧](#5-查询编辑器使用技巧)
6. [变量与模板功能](#6-变量与模板功能)
7. [告警配置集成](#7-告警配置集成)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 Grafana与Prometheus概述


### 1.1 什么是Grafana


**简单理解**：Grafana就像是监控数据的"显示器"，把Prometheus收集的枯燥数字变成漂亮的图表

```
现实类比：
Prometheus = 体检设备（收集血压、心率等数据）
Grafana = 体检报告单（把数据做成图表展示）

没有Grafana：只能看到一串串数字
有了Grafana：数据变成直观的折线图、饼图、仪表盘
```

### 1.2 为什么需要Grafana


**核心价值**：让监控数据"说人话"

```
数据可视化的重要性：

❌ 原始数据展示：
cpu_usage 0.75
memory_usage 0.82
disk_usage 0.45

✅ Grafana图表展示：
┌─────────────────────────┐
│ CPU使用率趋势           │
│     ╭─╮                │
│    ╱   ╲     ╭╮        │
│   ╱     ╲   ╱  ╲       │
│  ╱       ╲ ╱    ╲      │
│ ╱         ╲╱      ╲─   │
└─────────────────────────┘
一眼就能看出CPU在下午2点出现了峰值！
```

### 1.3 Grafana核心功能


**🔸 主要能力**
```
数据展示：
• 折线图：趋势变化
• 饼图：比例分布  
• 仪表盘：实时状态
• 热力图：密度分布

交互功能：
• 时间范围选择
• 数据钻取查看
• 实时刷新
• 数据导出

管理功能：
• 用户权限控制
• 团队协作
• 数据源管理
• 告警通知
```

---

## 2. 🔗 Prometheus数据源配置


### 2.1 添加Prometheus数据源


**配置步骤**：就像给电视连接信号源

```
步骤流程：
1. 登录Grafana → 找到"Configuration"（配置）
2. 点击"Data Sources"（数据源）
3. 点击"Add data source"（添加数据源）
4. 选择"Prometheus"
5. 填写连接信息
```

### 2.2 关键配置参数


**基础连接配置**：

| 配置项 | 说明 | 示例值 | 作用 |
|--------|------|--------|------|
| **Name** | 数据源名称 | `Prometheus-Main` | 在Grafana中识别这个数据源 |
| **URL** | Prometheus地址 | `http://localhost:9090` | 告诉Grafana去哪里取数据 |
| **Access** | 访问方式 | `Server (default)` | 让Grafana服务器直接连接 |

```
💡 通俗理解：
Name = 给这个数据源起个名字，像"客厅电视"
URL = Prometheus的地址，像电视信号源的频道号  
Access = 连接方式，选默认就行
```

### 2.3 高级配置选项


**认证与安全设置**：

```
Auth（认证）：
☐ Basic auth：用户名密码认证
☐ TLS Client Auth：证书认证
☐ Skip TLS Verify：跳过证书验证（测试环境可用）

Custom HTTP Headers（自定义请求头）：
用于特殊的认证需求，一般不需要配置

Timeout（超时设置）：
HTTP Timeout: 60s（默认，够用了）
```

### 2.4 测试连接


**验证配置是否正确**：

```
测试步骤：
1. 配置完成后点击"Save & Test"
2. 看到绿色的"Data source is working"就成功了

常见错误处理：
❌ "Bad Gateway" → 检查Prometheus是否启动
❌ "Connection refused" → 检查URL地址是否正确
❌ "Timeout" → 检查网络连接或防火墙
```

---

## 3. 📊 Dashboard仪表板创建


### 3.1 Dashboard基本概念


**简单理解**：Dashboard就像汽车的仪表盘，把重要信息集中显示

```
汽车仪表盘类比：
┌─────────────────────────┐
│ 速度表  转速表  油量表   │
│   80     3000    ●●●○   │
│  km/h    rpm     3/4满   │
│                         │
│ 水温表     故障灯        │
│  ●●○○      ○○○○        │
└─────────────────────────┘

Grafana Dashboard：
┌─────────────────────────┐
│ CPU使用率  内存使用  磁盘空间│
│   75%      82%      45%   │
│                          │
│ 网络流量图  错误日志统计   │
│ 📈📈📈     ⚠️ 3个错误    │
└─────────────────────────┘
```

### 3.2 创建新Dashboard


**创建步骤**：

```
方法1：从零开始
1. 点击"+"号 → "Dashboard"
2. 点击"Add new panel"（添加新面板）
3. 配置数据查询和显示样式
4. 保存Dashboard

方法2：导入模板
1. 点击"+"号 → "Import"
2. 输入模板ID或上传JSON文件
3. 配置数据源
4. 导入完成
```

### 3.3 Dashboard基本结构


**🔸 组成部分**

```
Dashboard结构：
┌─────────────────────────────────┐
│ 标题栏：系统监控总览              │
├─────────────────────────────────┤
│ 时间选择器 [最近1小时 ▼] 🔄     │
├─────────────────────────────────┤
│ Panel 1    │ Panel 2    │Panel 3│
│ CPU使用率   │ 内存使用率  │磁盘空间│
│    75%     │    82%     │  45%  │
├─────────────────────────────────┤
│ Panel 4：网络流量趋势图          │
│ ████████████████████████        │
└─────────────────────────────────┘

核心要素：
• 标题：描述这个仪表盘的用途
• 时间范围：查看哪个时间段的数据
• Panel：具体的图表组件
• 布局：Panel的排列方式
```

### 3.4 Dashboard模板推荐


**常用模板ID**：

| 模板名称 | ID | 适用场景 | 特点 |
|----------|----|---------|----- |
| **Node Exporter Full** | `1860` | Linux服务器监控 | 全面的系统指标 |
| **Kubernetes Cluster** | `7249` | K8s集群监控 | 容器和Pod状态 |
| **MySQL Overview** | `7362` | MySQL数据库监控 | 数据库性能指标 |
| **NGINX** | `12708` | Web服务器监控 | 请求量和响应时间 |

```
💡 使用建议：
新手推荐先导入现成模板，熟悉后再自己创建
模板可以修改，不用担心弄坏
```

---

## 4. 📈 Panel面板类型与应用


### 4.1 Panel是什么


**简单理解**：Panel就是Dashboard上的每一块"小屏幕"，专门显示一种数据

```
生活类比：
Dashboard = 商场的信息大屏
Panel = 大屏上的每个小区域

┌─────────────────────────────┐
│ 商场信息大屏                 │
├─────────────────────────────┤
│天气Panel │ 时间Panel │客流Panel│
│ ☀️ 25°C  │ 14:30   │ 🚶‍♀️ 1205人│
├─────────────────────────────┤
│ 停车位Panel：剩余152个        │
│ 🅿️ ████████░░░░░░           │
└─────────────────────────────┘
```

### 4.2 常用Panel类型详解


#### 📊 Graph Panel（折线图）

```
适用场景：显示数据随时间的变化趋势
典型应用：
• CPU使用率变化
• 内存使用趋势  
• 网络流量变化
• 响应时间趋势

图表样式：
    CPU使用率(%)
100 │           ╭─╮
 80 │         ╱   ╲
 60 │       ╱       ╲
 40 │     ╱           ╲
 20 │   ╱               ╲
  0 └─────────────────────
    0h  1h  2h  3h  4h  5h
```

#### 🎯 Stat Panel（单值显示）

```
适用场景：显示当前状态或重要数值
典型应用：
• 当前CPU使用率：75%
• 在线用户数：1,205
• 错误计数：3
• 系统负载：2.1

显示样式：
┌─────────────┐
│   CPU使用率  │
│    75.2%    │
│     🔴      │  ← 颜色表示状态
└─────────────┘
```

#### 📈 Bar Gauge（条形进度条）

```
适用场景：显示百分比或进度
典型应用：
• 磁盘使用率
• 内存使用率  
• 网络带宽使用

显示样式：
磁盘使用率：
/root   ████████░░ 80%
/home   ██████░░░░ 60%
/var    ███░░░░░░░ 30%
```

#### 🥧 Pie Chart（饼图）

```
适用场景：显示组成部分的比例
典型应用：
• 各服务的资源占用
• 错误类型分布
• 用户来源分布

显示样式：
    服务资源占用
      ╱─╲
     ╱ A ╲ ← 服务A 40%
    ╱─────╲
   ╱   B   ╲ ← 服务B 35%
  ╱─────────╲
 ╱     C     ╲ ← 服务C 25%
```

#### 📋 Table Panel（表格）

```
适用场景：显示详细的列表数据
典型应用：
• 服务器列表及状态
• 错误日志记录
• 资源使用排行

显示样式：
┌──────────────────────────────┐
│ 主机名    │ CPU% │ 内存% │状态 │
├──────────────────────────────┤
│ web-01    │ 75   │ 82   │ ✅  │
│ web-02    │ 68   │ 76   │ ✅  │
│ db-01     │ 45   │ 90   │ ⚠️  │
└──────────────────────────────┘
```

### 4.3 Panel配置技巧


**🔸 选择合适的Panel类型**

```
数据类型决定Panel类型：

时间序列数据 → Graph Panel
当前状态值 → Stat Panel  
比例数据 → Bar Gauge / Pie Chart
列表数据 → Table Panel
地理数据 → Worldmap Panel
```

**🔸 颜色配置策略**

```
状态颜色约定：
🟢 绿色：正常状态（0-70%）
🟡 黄色：警告状态（70-85%）
🔴 红色：危险状态（85-100%）

配置示例：
Value mappings:
• 0-70: 绿色 "正常"
• 70-85: 黄色 "警告"  
• 85-100: 红色 "危险"
```

---

## 5. 🔍 查询编辑器使用技巧


### 5.1 查询编辑器界面


**界面组成**：就像搜索引擎的搜索框，但更专业

```
查询编辑器布局：
┌─────────────────────────────────────┐
│ Metrics: [cpu_usage_percent     ▼] │ ← 选择指标
├─────────────────────────────────────┤
│ Legend: {{instance}}                │ ← 图例显示
├─────────────────────────────────────┤
│ Query: rate(cpu[5m])               │ ← PromQL查询语句
├─────────────────────────────────────┤
│ [Run Query] [Add Query]             │ ← 操作按钮
└─────────────────────────────────────┘
```

### 5.2 基础查询语法


**🔸 简单查询**

```
直接查询指标：
cpu_usage_percent
↑ 这会显示所有服务器的CPU使用率

带标签过滤：
cpu_usage_percent{instance="web-01"}
↑ 只显示web-01服务器的CPU使用率

多标签过滤：
cpu_usage_percent{instance="web-01", job="node"}
↑ 更精确的过滤条件
```

**🔸 时间范围查询**

```
最近5分钟的平均值：
rate(cpu_usage_total[5m])

最近1小时的最大值：
max_over_time(cpu_usage_percent[1h])

💡 理解要点：
[5m] = 最近5分钟的数据
[1h] = 最近1小时的数据
rate() = 计算变化率
max_over_time() = 时间段内的最大值
```

### 5.3 常用查询函数


**📊 统计函数**

| 函数 | 作用 | 示例 | 通俗解释 |
|------|------|------|----------|
| `rate()` | 计算每秒变化率 | `rate(requests_total[5m])` | 每秒有多少个请求 |
| `avg()` | 计算平均值 | `avg(cpu_usage)` | 所有服务器CPU的平均值 |
| `sum()` | 求和 | `sum(memory_usage)` | 所有服务器内存使用总和 |
| `max()` | 最大值 | `max(response_time)` | 最慢的响应时间 |

```
实际应用示例：

监控网站QPS（每秒请求数）：
rate(http_requests_total[5m])

监控平均响应时间：
avg(http_request_duration_seconds)

监控总内存使用：
sum(node_memory_used_bytes) / 1024/1024/1024
↑ 除法是为了转换成GB单位
```

### 5.4 查询调试技巧


**🔧 常见问题排查**

```
问题1：查询无数据
排查步骤：
1. 检查指标名称是否正确
2. 检查时间范围是否合适
3. 确认Prometheus是否在收集这个指标

问题2：数据不准确
排查步骤：
1. 检查查询函数是否正确
2. 确认时间窗口大小是否合适
3. 验证标签过滤条件

问题3：查询太慢
优化方法：
1. 缩小时间范围
2. 增加标签过滤
3. 使用合适的聚合函数
```

---

## 6. 🎛️ 变量与模板功能


### 6.1 什么是Dashboard变量


**简单理解**：变量就像遥控器，让你能动态切换查看不同的数据

```
现实类比：
电视遥控器可以切换频道
Dashboard变量可以切换服务器

没有变量：
需要创建多个Dashboard
• web-01服务器监控
• web-02服务器监控  
• web-03服务器监控

有了变量：
一个Dashboard搞定
选择服务器：[web-01 ▼] [web-02] [web-03]
图表自动显示对应服务器的数据
```

### 6.2 创建变量


**配置步骤**：

```
创建过程：
1. 进入Dashboard设置（齿轮图标）
2. 点击"Variables"
3. 点击"Add variable"
4. 配置变量参数
5. 保存并应用
```

**🔸 变量类型选择**

| 变量类型 | 用途 | 示例 | 适用场景 |
|----------|------|------|----------|
| **Query** | 从Prometheus查询值 | `label_values(instance)` | 动态获取服务器列表 |
| **Custom** | 手动定义值 | `prod,test,dev` | 环境切换 |
| **Interval** | 时间间隔选择 | `1m,5m,1h` | 调整查询粒度 |
| **Datasource** | 数据源选择 | 多个Prometheus实例 | 切换数据源 |

### 6.3 Query变量详解


**最常用的变量类型**：

```
配置示例：
Name: instance
Type: Query  
Query: label_values(up, instance)
↑ 获取所有有up指标的instance标签值

结果：会自动生成下拉菜单
[web-01 ▼]
├ web-01
├ web-02  
├ web-03
└ db-01
```

**在查询中使用变量**：

```
使用方法：
原始查询：cpu_usage{instance="web-01"}
变量查询：cpu_usage{instance="$instance"}
                              ↑ 使用变量

多选变量：
cpu_usage{instance=~"$instance"}
                   ↑ =~ 支持多选和正则
```

### 6.4 变量的高级用法


**🔸 级联变量**

```
应用场景：先选择环境，再选择服务器

变量1 - 环境：
Name: env
Query: label_values(up, env)
Result: [prod, test, dev]

变量2 - 服务器：  
Name: instance
Query: label_values(up{env="$env"}, instance)
                         ↑ 依赖于环境变量
Result: 只显示选定环境的服务器
```

**🔸 变量的显示选项**

```
Multi-value: 允许多选
Include All option: 包含"全部"选项
Custom all value: 自定义全选的值

实际效果：
[实例选择 ▼]
├ All (选择全部)
├ ☑ web-01  
├ ☑ web-02
└ ☐ web-03
```

---

## 7. 🚨 告警配置集成


### 7.1 Grafana告警基础


**告警的作用**：就像烟雾报警器，在出现问题时及时通知你

```
告警工作流程：
监控数据 → 触发条件 → 发送通知 → 人工处理

例如：
CPU使用率 > 80% → 触发告警 → 发送邮件/短信 → 运维人员处理
```

### 7.2 创建告警规则


**配置步骤**：

```
创建过程：
1. 在Panel编辑界面点击"Alert"标签
2. 点击"Create Alert"
3. 配置告警条件
4. 设置通知渠道
5. 测试并保存

💡 注意：只有Graph Panel支持告警
```

**🔸 告警条件配置**

```
基本条件设置：
WHEN: avg()               ← 使用什么函数
OF: query(A, 5m, now)    ← 查询哪个Query，多长时间
IS ABOVE: 80             ← 阈值条件

通俗理解：
当CPU使用率的5分钟平均值超过80%时触发告警
```

### 7.3 通知渠道配置


**常用通知方式**：

| 通知类型 | 使用场景 | 配置要点 | 优缺点 |
|----------|----------|----------|--------|
| **Email** | 一般告警 | SMTP服务器 | 📧 容易配置，但可能延迟 |
| **Slack** | 团队协作 | Webhook URL | 💬 实时性好，适合团队 |
| **微信** | 移动通知 | 企业微信API | 📱 移动端友好 |
| **PagerDuty** | 严重告警 | 集成Key | 🚨 专业的值班通知 |

**📧 邮件通知配置示例**：

```
配置路径：Configuration → Notification channels

Name: 运维邮件组
Type: Email  
Email addresses: ops@company.com
Subject: 【告警】{{ruleName}}
Message: 
服务器：{{instance}}
告警时间：{{localTime}}
告警详情：{{message}}
```

### 7.4 告警最佳实践


**🔸 告警阈值设置原则**

```
CPU使用率告警：
Warning: 70%   ← 提醒注意
Critical: 85%  ← 需要处理
Emergency: 95% ← 紧急处理

内存使用率告警：
Warning: 80%
Critical: 90%  
Emergency: 95%

磁盘使用率告警：
Warning: 80%
Critical: 90%
Emergency: 95%
```

**🔸 告警策略建议**

```
告警分级处理：
🟢 信息级：记录日志，不发通知
🟡 警告级：邮件通知，非紧急
🟠 错误级：短信+邮件，需要关注  
🔴 致命级：电话+短信+邮件，立即处理

避免告警风暴：
• 设置告警间隔（如5分钟内不重复发送）
• 使用告警分组
• 设置静默时间（如维护窗口）
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 Grafana作用：将Prometheus数据可视化，让监控数据变得直观
🔸 数据源配置：连接Prometheus，是一切的基础
🔸 Dashboard：监控数据的集中展示界面，像汽车仪表盘
🔸 Panel类型：不同的图表适用于不同类型的数据展示
🔸 查询语法：掌握基本的PromQL，能查询想要的数据
🔸 变量功能：让Dashboard具备交互能力，提高复用性
🔸 告警集成：及时发现和通知问题，保障系统稳定
```

### 8.2 关键理解要点


**🔹 数据流转过程**
```
数据采集：Exporter收集指标
数据存储：Prometheus存储时序数据  
数据展示：Grafana读取并可视化
数据告警：异常时自动通知

完整链路：
应用系统 → Exporter → Prometheus → Grafana → 告警通知
```

**🔹 配置优先级**
```
1. 先配置数据源（连接Prometheus）
2. 再创建Dashboard（整体布局）
3. 然后添加Panel（具体图表）
4. 最后配置告警（异常通知）

记住：数据源是基础，没有数据源什么都做不了
```

**🔹 Panel选择技巧**
```
数据特征 → Panel类型：
趋势变化 → Graph Panel（折线图）
当前状态 → Stat Panel（数值显示）
比例关系 → Pie Chart（饼图）
列表数据 → Table Panel（表格）
进度状态 → Bar Gauge（进度条）
```

### 8.3 实际应用场景


**📊 典型监控Dashboard**
```
系统监控Dashboard：
┌─────────────────────────────────┐
│ 系统概览                        │
├─────────────────────────────────┤
│ CPU 75% │ 内存 82% │ 磁盘 45%   │
├─────────────────────────────────┤
│ 网络流量趋势图                   │
│ ████████████████████            │
├─────────────────────────────────┤
│ 服务状态列表                     │
│ Web服务 ✅ | DB服务 ✅ | API ⚠️│
└─────────────────────────────────┘
```

**🎯 告警策略实例**
```
网站监控告警：
• 响应时间 > 2秒：警告级
• 响应时间 > 5秒：错误级  
• 服务不可用：致命级

服务器监控告警：
• CPU > 80%：警告级
• 内存 > 90%：错误级
• 磁盘 > 95%：致命级
```

### 8.4 常见问题解决


**🔧 配置问题排查**
```
数据源连接失败：
1. 检查Prometheus是否启动
2. 确认URL地址是否正确
3. 检查网络连接

图表显示无数据：
1. 确认查询语句是否正确
2. 检查时间范围设置
3. 验证数据是否存在

告警不生效：
1. 确认告警规则是否正确
2. 检查通知渠道配置
3. 验证告警条件是否触发
```

### 8.5 学习建议


**📚 入门路径**
```
第1步：搭建基本环境
• 安装Grafana
• 配置Prometheus数据源
• 导入一个现成模板

第2步：理解基本概念  
• 熟悉Dashboard结构
• 了解不同Panel类型
• 学习基础查询语法

第3步：实践应用
• 创建自定义Dashboard
• 配置变量和告警
• 优化显示效果

第4步：深入优化
• 高级查询技巧
• 复杂告警策略
• 性能优化
```

**核心记忆**：
- Grafana是Prometheus的最佳搭档，让数据说话
- 数据源配置是基础，Dashboard是核心，Panel是关键
- 查询语法要掌握，变量功能很实用，告警配置保平安
- 多动手实践，从模板开始，逐步深入理解

**学习要点**：
```
理论结合实践：边学边做，加深理解
从简单到复杂：先用模板，再自己创建
关注用户体验：图表要直观，告警要及时
持续改进优化：根据实际需求调整配置
```