---
title: 2ã€è‡ªå®šä¹‰Exporterå¼€å‘
---
## ğŸ“š ç›®å½•

1. [ExporteråŸºç¡€æ¦‚å¿µ](#1-exporteråŸºç¡€æ¦‚å¿µ)
2. [å¼€å‘è§„èŒƒä¸æ ‡å‡†](#2-å¼€å‘è§„èŒƒä¸æ ‡å‡†)
3. [å®¢æˆ·ç«¯åº“ä½¿ç”¨](#3-å®¢æˆ·ç«¯åº“ä½¿ç”¨)
4. [æŒ‡æ ‡æš´éœ²æ ¼å¼](#4-æŒ‡æ ‡æš´éœ²æ ¼å¼)
5. [HTTPæœåŠ¡å®ç°](#5-httpæœåŠ¡å®ç°)
6. [æ€§èƒ½ä¼˜åŒ–è€ƒè™‘](#6-æ€§èƒ½ä¼˜åŒ–è€ƒè™‘)
7. [è°ƒè¯•ä¸æµ‹è¯•æ–¹æ³•](#7-è°ƒè¯•ä¸æµ‹è¯•æ–¹æ³•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ExporteråŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Exporter


**é€šä¿—ç†è§£**ï¼š
```
æƒ³è±¡ä¸€ä¸‹ï¼š
ä½ æœ‰ä¸€å°æœåŠ¡å™¨ â†’ è¿è¡Œç€å„ç§åº”ç”¨ â†’ äº§ç”Ÿå„ç§æ•°æ®
ä½†æ˜¯ Prometheus ä¸è®¤è¯†è¿™äº›æ•°æ® â†’ éœ€è¦ä¸€ä¸ª"ç¿»è¯‘å®˜"
è¿™ä¸ª"ç¿»è¯‘å®˜" = Exporter
```

**ğŸ”¸ Exporterçš„ä½œç”¨**
```
åŸå§‹æ•°æ®ï¼šæ•°æ®åº“è¿æ¥æ•°ã€APIè°ƒç”¨æ¬¡æ•°ã€æ–‡ä»¶å¤§å°...
    â†“ (Exporterç¿»è¯‘)
Prometheusæ ¼å¼ï¼šhttp_requests_total{method="GET"} 1247
```

> ğŸ’¡ **ç®€å•è¯´æ˜**ï¼šExporterå°±æ˜¯ä¸€ä¸ªå°ç¨‹åºï¼Œå®ƒçš„å·¥ä½œå°±æ˜¯æŠŠå„ç§ç³»ç»Ÿçš„æ•°æ®è½¬æ¢æˆPrometheusèƒ½ç†è§£çš„æ ¼å¼

### 1.2 ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰Exporter


**å¸¸è§åœºæ™¯**ï¼š
```
ğŸ“Š å·²æœ‰ç³»ç»Ÿç›‘æ§ï¼š
â€¢ è‡ªç ”ä¸šåŠ¡ç³»ç»Ÿ â†’ æ²¡æœ‰ç°æˆçš„Exporter
â€¢ ç‰¹æ®Šç¡¬ä»¶è®¾å¤‡ â†’ å‚å•†æ²¡æä¾›ç›‘æ§æ¥å£
â€¢ é—ç•™ç³»ç»Ÿ â†’ åªæœ‰æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“

ğŸ¯ ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ï¼š
â€¢ è®¢å•æ•°é‡ã€ç”¨æˆ·æ³¨å†Œæ•°
â€¢ æ”¯ä»˜æˆåŠŸç‡ã€åº“å­˜æ•°é‡
â€¢ è‡ªå®šä¹‰ä¸šåŠ¡KPIæŒ‡æ ‡
```

### 1.3 Exporterå·¥ä½œåŸç†


**æ¶æ„å›¾ç¤º**ï¼š
```
ä½ çš„åº”ç”¨/ç³»ç»Ÿ          è‡ªå®šä¹‰Exporter         Prometheus
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“    â”‚â”€â”€â”€â”€â†’ â”‚  æ•°æ®æ”¶é›†æ¨¡å—   â”‚ â†â”€â”€â”€â”€ â”‚ HTTPè¯·æ±‚     â”‚
â”‚   APIæ¥å£   â”‚      â”‚       â†“         â”‚      â”‚ /metrics     â”‚
â”‚   æ—¥å¿—æ–‡ä»¶   â”‚      â”‚  æ ¼å¼è½¬æ¢æ¨¡å—   â”‚      â”‚              â”‚
â”‚   é…ç½®æ–‡ä»¶   â”‚      â”‚       â†“         â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  HTTPæœåŠ¡æ¨¡å—   â”‚ â”€â”€â”€â†’ â”‚ æ‹‰å–æŒ‡æ ‡æ•°æ® â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹**ï¼š
1. **æ•°æ®é‡‡é›†**ï¼šä»ç›®æ ‡ç³»ç»Ÿè·å–åŸå§‹æ•°æ®
2. **æ•°æ®å¤„ç†**ï¼šæ¸…æ´—ã€è®¡ç®—ã€èšåˆæ•°æ®
3. **æ ¼å¼è½¬æ¢**ï¼šè½¬æ¢ä¸ºPrometheusæŒ‡æ ‡æ ¼å¼
4. **HTTPæš´éœ²**ï¼šé€šè¿‡HTTPæ¥å£æä¾›ç»™Prometheus

---

## 2. ğŸ“‹ å¼€å‘è§„èŒƒä¸æ ‡å‡†


### 2.1 å®˜æ–¹å¼€å‘æŒ‡å¯¼åŸåˆ™


**ğŸ”¸ æ ¸å¿ƒåŸåˆ™**
```
â–¶ ä¸€ä¸ªExporteråªç›‘æ§ä¸€ä¸ªæœåŠ¡
  âŒ é”™è¯¯ï¼šä¸€ä¸ªExporterç›‘æ§æ•°æ®åº“+Redis+åº”ç”¨
  âœ… æ­£ç¡®ï¼šæ•°æ®åº“Exporter + Redis Exporter + åº”ç”¨Exporter

â–¶ æŒ‡æ ‡åç§°è¦æœ‰æ„ä¹‰ä¸”ä¸€è‡´
  âŒ é”™è¯¯ï¼šcountã€numã€data
  âœ… æ­£ç¡®ï¼šhttp_requests_totalã€database_connections_active

â–¶ ä½¿ç”¨æ ‡å‡†çš„æŒ‡æ ‡ç±»å‹
  â€¢ Counterï¼šç´¯è®¡è®¡æ•°ï¼ˆè¯·æ±‚æ€»æ•°ï¼‰
  â€¢ Gaugeï¼šç¬æ—¶å€¼ï¼ˆå½“å‰è¿æ¥æ•°ï¼‰
  â€¢ Histogramï¼šåˆ†å¸ƒç»Ÿè®¡ï¼ˆå“åº”æ—¶é—´åˆ†å¸ƒï¼‰
  â€¢ Summaryï¼šåˆ†ä½æ•°ç»Ÿè®¡ï¼ˆP99å“åº”æ—¶é—´ï¼‰
```

### 2.2 å‘½åè§„èŒƒè¯¦è§£


**æŒ‡æ ‡å‘½åæ ‡å‡†**ï¼š
```
åŸºæœ¬æ ¼å¼ï¼š{namespace}_{subsystem}_{name}_{unit}

å®é™…ä¾‹å­ï¼š
â€¢ http_requests_total        â† æ€»HTTPè¯·æ±‚æ•°
â€¢ mysql_connections_active   â† MySQLæ´»è·ƒè¿æ¥æ•°
â€¢ disk_usage_bytes          â† ç£ç›˜ä½¿ç”¨å­—èŠ‚æ•°
â€¢ api_response_duration_seconds â† APIå“åº”æ—¶é—´ï¼ˆç§’ï¼‰
```

**æ ‡ç­¾å‘½åè§„èŒƒ**ï¼š
```
ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼š
âœ… method="GET"
âœ… status_code="200"  
âœ… instance_type="web"

é¿å…çš„å‘½åï¼š
âŒ Method="GET"      (å¤§å†™)
âŒ status-code="200" (è¿å­—ç¬¦)
âŒ type="web server" (ç©ºæ ¼)
```

### 2.3 æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ


**ğŸ¯ æŒ‡æ ‡é€‰æ‹©æŒ‡å¯¼**

| ä¸šåŠ¡åœºæ™¯ | **æ¨èæŒ‡æ ‡ç±»å‹** | **ç¤ºä¾‹** | **è¯´æ˜** |
|---------|----------------|----------|----------|
| `APIè°ƒç”¨æ¬¡æ•°` | `Counter` | `api_requests_total` | `åªå¢ä¸å‡çš„è®¡æ•°` |
| `å½“å‰åœ¨çº¿ç”¨æˆ·` | `Gauge` | `users_online_current` | `ä¼šå¢å‡çš„ç¬æ—¶å€¼` |
| `å“åº”æ—¶é—´åˆ†å¸ƒ` | `Histogram` | `response_duration_seconds` | `éœ€è¦åˆ†æ¡¶ç»Ÿè®¡` |
| `å¤„ç†å»¶è¿Ÿåˆ†ä½æ•°` | `Summary` | `request_latency_seconds` | `å…³æ³¨P95ã€P99ç­‰` |

---

## 3. ğŸ› ï¸ å®¢æˆ·ç«¯åº“ä½¿ç”¨


### 3.1 é€‰æ‹©åˆé€‚çš„å®¢æˆ·ç«¯åº“


**ä¸»æµè¯­è¨€æ”¯æŒ**ï¼š
```
å®˜æ–¹åº“ï¼š
â€¢ Goï¼šgithub.com/prometheus/client_golang
â€¢ Javaï¼šio.prometheus.simpleclient
â€¢ Pythonï¼šprometheus_client
â€¢ Node.jsï¼šprom-client

ç¬¬ä¸‰æ–¹åº“ï¼š
â€¢ .NETï¼šprometheus-net
â€¢ PHPï¼špromphp/prometheus_client_php
â€¢ Rustï¼šprometheus
```

### 3.2 Pythonå®¢æˆ·ç«¯å®æˆ˜ç¤ºä¾‹


**åŸºç¡€ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
from prometheus_client import Counter, Gauge, Histogram
from prometheus_client import start_http_server
import time
import random

# å®šä¹‰æŒ‡æ ‡
REQUEST_COUNT = Counter(
    'http_requests_total', 
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

ACTIVE_CONNECTIONS = Gauge(
    'active_connections', 
    'Current active connections'
)

REQUEST_DURATION = Histogram(
    'request_duration_seconds',
    'HTTP request duration in seconds',
    ['endpoint']
)

# ä½¿ç”¨æŒ‡æ ‡
def handle_request(method, endpoint):
    # è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
    start_time = time.time()
    
    # æ¨¡æ‹Ÿå¤„ç†è¯·æ±‚
    time.sleep(random.uniform(0.1, 0.5))
    
    # è®°å½•æŒ‡æ ‡
    REQUEST_COUNT.labels(
        method=method, 
        endpoint=endpoint, 
        status='200'
    ).inc()
    
    REQUEST_DURATION.labels(endpoint=endpoint).observe(
        time.time() - start_time
    )

# å¯åŠ¨HTTPæœåŠ¡å™¨æš´éœ²æŒ‡æ ‡
if __name__ == '__main__':
    start_http_server(8000)  # åœ¨8000ç«¯å£æä¾›/metricsæ¥å£
    print("Exporter started on :8000")
    
    # æ¨¡æ‹Ÿä¸šåŠ¡è¯·æ±‚
    while True:
        handle_request('GET', '/api/users')
        time.sleep(2)
```

### 3.3 Goå®¢æˆ·ç«¯å®æˆ˜ç¤ºä¾‹


**Goè¯­è¨€å®ç°**ï¼š
```go
package main

import (
    "fmt"
    "math/rand"
    "net/http"
    "time"
    
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

var (
    // å®šä¹‰æŒ‡æ ‡
    requestsTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total number of HTTP requests",
        },
        []string{"method", "endpoint"},
    )
    
    responseSize = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "response_size_bytes",
            Help: "Response size in bytes",
            Buckets: []float64{100, 500, 1000, 5000, 10000},
        },
        []string{"endpoint"},
    )
)

func init() {
    // æ³¨å†ŒæŒ‡æ ‡
    prometheus.MustRegister(requestsTotal)
    prometheus.MustRegister(responseSize)
}

func simulateTraffic() {
    endpoints := []string{"/api/users", "/api/orders", "/api/products"}
    
    for {
        endpoint := endpoints[rand.Intn(len(endpoints))]
        
        // è®°å½•è¯·æ±‚
        requestsTotal.WithLabelValues("GET", endpoint).Inc()
        
        // è®°å½•å“åº”å¤§å°
        size := float64(rand.Intn(5000) + 100)
        responseSize.WithLabelValues(endpoint).Observe(size)
        
        time.Sleep(time.Second)
    }
}

func main() {
    // å¯åŠ¨æ¨¡æ‹Ÿæµé‡
    go simulateTraffic()
    
    // æš´éœ²æŒ‡æ ‡æ¥å£
    http.Handle("/metrics", promhttp.Handler())
    
    fmt.Println("Exporter running on :8080/metrics")
    http.ListenAndServe(":8080", nil)
}
```

---

## 4. ğŸ“Š æŒ‡æ ‡æš´éœ²æ ¼å¼


### 4.1 PrometheusæŒ‡æ ‡æ ¼å¼è¯¦è§£


**åŸºæœ¬æ ¼å¼è§„èŒƒ**ï¼š
```
# HELP æŒ‡æ ‡åç§° æŒ‡æ ‡æè¿°
# TYPE æŒ‡æ ‡åç§° æŒ‡æ ‡ç±»å‹
æŒ‡æ ‡åç§°{æ ‡ç­¾å="æ ‡ç­¾å€¼"} æŒ‡æ ‡å€¼ æ—¶é—´æˆ³

å®é™…ä¾‹å­ï¼š
# HELP http_requests_total Total number of HTTP requests
# TYPE http_requests_total counter
http_requests_total{method="GET",endpoint="/api/users"} 1247
http_requests_total{method="POST",endpoint="/api/users"} 423
```

### 4.2 å„ç§æŒ‡æ ‡ç±»å‹çš„è¾“å‡ºæ ¼å¼


**Counterè®¡æ•°å™¨æ ¼å¼**ï¼š
```
# HELP api_requests_total Total API requests
# TYPE api_requests_total counter
api_requests_total{service="user",method="GET"} 12450
api_requests_total{service="user",method="POST"} 3201
api_requests_total{service="order",method="GET"} 8932
```

**Gaugeä»ªè¡¨ç›˜æ ¼å¼**ï¼š
```
# HELP memory_usage_bytes Current memory usage in bytes
# TYPE memory_usage_bytes gauge
memory_usage_bytes{instance="web-01"} 1024000000
memory_usage_bytes{instance="web-02"} 987600000
```

**Histogramç›´æ–¹å›¾æ ¼å¼**ï¼š
```
# HELP request_duration_seconds Request duration
# TYPE request_duration_seconds histogram
request_duration_seconds_bucket{le="0.1"} 1000
request_duration_seconds_bucket{le="0.5"} 1200
request_duration_seconds_bucket{le="1.0"} 1250
request_duration_seconds_bucket{le="+Inf"} 1300
request_duration_seconds_sum 230.4
request_duration_seconds_count 1300
```

### 4.3 å¸¸è§æ ¼å¼é”™è¯¯ä¸è§£å†³


> âš ï¸ **å¸¸è§é”™è¯¯ç¤ºä¾‹**

```
âŒ é”™è¯¯æ ¼å¼ï¼š
http_requests{method=GET} 100    # ç¼ºå°‘å¼•å·
HTTP_REQUESTS_TOTAL 100          # å¤§å†™å­—æ¯
requests total 100               # åŒ…å«ç©ºæ ¼

âœ… æ­£ç¡®æ ¼å¼ï¼š
http_requests_total{method="GET"} 100
```

---

## 5. ğŸŒ HTTPæœåŠ¡å®ç°


### 5.1 åŸºç¡€HTTPæœåŠ¡ç»“æ„


**æœåŠ¡æ¶æ„è®¾è®¡**ï¼š
```
HTTPæœåŠ¡ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTPè·¯ç”±å±‚        â”‚ â† å¤„ç†/metricsè¯·æ±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æŒ‡æ ‡æ”¶é›†å±‚        â”‚ â† ä»å„ä¸ªæ•°æ®æºæ”¶é›†æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®å¤„ç†å±‚        â”‚ â† æ¸…æ´—ã€è®¡ç®—ã€èšåˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ ¼å¼è¾“å‡ºå±‚        â”‚ â† è½¬æ¢ä¸ºPrometheusæ ¼å¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Flaskå®ç°å®Œæ•´ç¤ºä¾‹


```python
from flask import Flask, Response
from prometheus_client import Counter, Gauge, generate_latest
import psutil
import time

app = Flask(__name__)

# å®šä¹‰ç³»ç»Ÿç›‘æ§æŒ‡æ ‡
cpu_usage = Gauge('system_cpu_usage_percent', 'CPU usage percentage')
memory_usage = Gauge('system_memory_usage_bytes', 'Memory usage in bytes')
disk_usage = Gauge('system_disk_usage_bytes', 'Disk usage in bytes', ['device'])

def collect_system_metrics():
    """æ”¶é›†ç³»ç»ŸæŒ‡æ ‡æ•°æ®"""
    # CPUä½¿ç”¨ç‡
    cpu_usage.set(psutil.cpu_percent())
    
    # å†…å­˜ä½¿ç”¨
    memory = psutil.virtual_memory()
    memory_usage.set(memory.used)
    
    # ç£ç›˜ä½¿ç”¨
    for partition in psutil.disk_partitions():
        try:
            usage = psutil.disk_usage(partition.mountpoint)
            disk_usage.labels(device=partition.device).set(usage.used)
        except PermissionError:
            continue

@app.route('/metrics')
def metrics():
    """æš´éœ²PrometheusæŒ‡æ ‡"""
    # æ”¶é›†æœ€æ–°æ•°æ®
    collect_system_metrics()
    
    # è¿”å›Prometheusæ ¼å¼æ•°æ®
    return Response(
        generate_latest(), 
        mimetype='text/plain; charset=utf-8'
    )

@app.route('/health')
def health():
    """å¥åº·æ£€æŸ¥æ¥å£"""
    return {'status': 'healthy', 'timestamp': time.time()}

if __name__ == '__main__':
    print("System Exporter started on :9100/metrics")
    app.run(host='0.0.0.0', port=9100)
```

### 5.3 æ•°æ®åº“ç›‘æ§Exporterç¤ºä¾‹


```python
import pymysql
from prometheus_client import Gauge, Counter
import time

class MySQLExporter:
    def __init__(self, db_config):
        self.db_config = db_config
        
        # å®šä¹‰MySQLç›¸å…³æŒ‡æ ‡
        self.connections_active = Gauge(
            'mysql_connections_active', 
            'Active MySQL connections'
        )
        self.queries_total = Counter(
            'mysql_queries_total', 
            'Total MySQL queries',
            ['type']
        )
        self.slow_queries = Gauge(
            'mysql_slow_queries_total',
            'Total slow queries'
        )
    
    def collect_metrics(self):
        """æ”¶é›†MySQLæŒ‡æ ‡"""
        try:
            # è¿æ¥æ•°æ®åº“
            conn = pymysql.connect(**self.db_config)
            cursor = conn.cursor()
            
            # è·å–è¿æ¥æ•°
            cursor.execute("SHOW STATUS LIKE 'Threads_connected'")
            connections = cursor.fetchone()[1]
            self.connections_active.set(int(connections))
            
            # è·å–æŸ¥è¯¢ç»Ÿè®¡
            cursor.execute("SHOW STATUS LIKE 'Com_select'")
            select_count = cursor.fetchone()[1]
            self.queries_total.labels(type='select')._value._value = int(select_count)
            
            # è·å–æ…¢æŸ¥è¯¢æ•°
            cursor.execute("SHOW STATUS LIKE 'Slow_queries'")
            slow_count = cursor.fetchone()[1]
            self.slow_queries.set(int(slow_count))
            
            cursor.close()
            conn.close()
            
        except Exception as e:
            print(f"Error collecting MySQL metrics: {e}")

# ä½¿ç”¨ç¤ºä¾‹
db_config = {
    'host': 'localhost',
    'user': 'monitor',
    'password': 'password',
    'database': 'mysql'
}

mysql_exporter = MySQLExporter(db_config)

# åœ¨Flaskåº”ç”¨ä¸­é›†æˆ
@app.route('/metrics')
def metrics():
    mysql_exporter.collect_metrics()
    return Response(generate_latest(), mimetype='text/plain')
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–è€ƒè™‘


### 6.1 æ•°æ®æ”¶é›†ä¼˜åŒ–


**ğŸ”¸ é‡‡é›†é¢‘ç‡æ§åˆ¶**
```python
import threading
import time
from datetime import datetime, timedelta

class MetricsCollector:
    def __init__(self, collect_interval=30):
        self.collect_interval = collect_interval
        self.last_collect_time = None
        self.cached_data = {}
        self.lock = threading.Lock()
    
    def get_metrics(self):
        """è·å–æŒ‡æ ‡æ•°æ®ï¼Œå¸¦ç¼“å­˜æœºåˆ¶"""
        now = datetime.now()
        
        with self.lock:
            # å¦‚æœç¼“å­˜æ•°æ®ä»ç„¶æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
            if (self.last_collect_time and 
                now - self.last_collect_time < timedelta(seconds=self.collect_interval)):
                return self.cached_data
            
            # æ”¶é›†æ–°æ•°æ®
            self.cached_data = self._collect_fresh_data()
            self.last_collect_time = now
            
        return self.cached_data
    
    def _collect_fresh_data(self):
        """å®é™…çš„æ•°æ®æ”¶é›†é€»è¾‘"""
        # è¿™é‡Œæ”¾ç½®è€—æ—¶çš„æ•°æ®æ”¶é›†æ“ä½œ
        pass
```

### 6.2 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**é¿å…å†…å­˜æ³„æ¼**ï¼š
```python
# âŒ é”™è¯¯ï¼šæ ‡ç­¾å€¼åŠ¨æ€å˜åŒ–å¯¼è‡´å†…å­˜æ³„æ¼
request_counter = Counter('requests_total', 'Total requests', ['user_id'])

def handle_request(user_id):
    # å¦‚æœuser_idæ˜¯åŠ¨æ€çš„ï¼ˆå¦‚ï¼šç”¨æˆ·IDï¼‰ï¼Œä¼šåˆ›å»ºå¤§é‡æŒ‡æ ‡å®ä¾‹
    request_counter.labels(user_id=user_id).inc()  # å±é™©ï¼

# âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ‰é™çš„æ ‡ç­¾å€¼
request_counter = Counter('requests_total', 'Total requests', ['service', 'method'])

def handle_request(service, method):
    # serviceå’Œmethodæ˜¯æœ‰é™çš„å›ºå®šå€¼
    request_counter.labels(service=service, method=method).inc()  # å®‰å…¨
```

### 6.3 å¹¶å‘å¤„ç†ä¼˜åŒ–


**çº¿ç¨‹å®‰å…¨çš„æŒ‡æ ‡æ›´æ–°**ï¼š
```python
import threading
from prometheus_client import Counter, Gauge

class ThreadSafeExporter:
    def __init__(self):
        self.request_count = Counter('app_requests_total', 'Total requests')
        self.active_users = Gauge('app_active_users', 'Active users')
        self.lock = threading.Lock()
        self.user_sessions = set()
    
    def record_request(self):
        """çº¿ç¨‹å®‰å…¨çš„è¯·æ±‚è®°å½•"""
        self.request_count.inc()  # Counteræ˜¯çº¿ç¨‹å®‰å…¨çš„
    
    def add_user_session(self, user_id):
        """çº¿ç¨‹å®‰å…¨çš„ç”¨æˆ·ä¼šè¯ç®¡ç†"""
        with self.lock:
            self.user_sessions.add(user_id)
            self.active_users.set(len(self.user_sessions))
    
    def remove_user_session(self, user_id):
        """çº¿ç¨‹å®‰å…¨çš„ç”¨æˆ·ä¼šè¯ç§»é™¤"""
        with self.lock:
            self.user_sessions.discard(user_id)
            self.active_users.set(len(self.user_sessions))
```

### 6.4 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


> ğŸ“Š **Exporterè‡ªèº«æ€§èƒ½ç›‘æ§**

```python
from prometheus_client import Histogram, Counter
import time
import functools

# Exporteræ€§èƒ½æŒ‡æ ‡
collection_duration = Histogram(
    'exporter_collection_duration_seconds',
    'Time spent collecting metrics'
)

collection_errors = Counter(
    'exporter_collection_errors_total',
    'Total collection errors'
)

def monitor_collection_time(func):
    """è£…é¥°å™¨ï¼šç›‘æ§æ•°æ®æ”¶é›†æ—¶é—´"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = func(*args, **kwargs)
            return result
        except Exception as e:
            collection_errors.inc()
            raise
        finally:
            collection_duration.observe(time.time() - start_time)
    return wrapper

@monitor_collection_time
def collect_database_metrics():
    """è¢«ç›‘æ§çš„æ•°æ®æ”¶é›†å‡½æ•°"""
    # å®é™…çš„æ•°æ®æ”¶é›†é€»è¾‘
    pass
```

---

## 7. ğŸ” è°ƒè¯•ä¸æµ‹è¯•æ–¹æ³•


### 7.1 æœ¬åœ°è°ƒè¯•æŠ€å·§


**ğŸ”¸ è°ƒè¯•æ£€æŸ¥æ¸…å•**
```
â–¡ æŒ‡æ ‡åç§°ç¬¦åˆå‘½åè§„èŒƒ
â–¡ æ ‡ç­¾åç§°ä½¿ç”¨å°å†™å’Œä¸‹åˆ’çº¿
â–¡ æŒ‡æ ‡å€¼ç±»å‹æ­£ç¡®ï¼ˆæ•°å­—ï¼‰
â–¡ HTTPå“åº”å¤´Content-Typeæ­£ç¡®
â–¡ /metricsæ¥å£è¿”å›200çŠ¶æ€ç 
â–¡ è¾“å‡ºæ ¼å¼ç¬¦åˆPrometheusè§„èŒƒ
```

**éªŒè¯è¾“å‡ºæ ¼å¼**ï¼š
```bash
# 1. æ£€æŸ¥åŸºæœ¬è®¿é—®
curl http://localhost:8080/metrics

# 2. æ£€æŸ¥å“åº”å¤´
curl -I http://localhost:8080/metrics

# 3. éªŒè¯æŒ‡æ ‡æ ¼å¼
curl http://localhost:8080/metrics | head -20

# 4. æ£€æŸ¥ç‰¹å®šæŒ‡æ ‡
curl http://localhost:8080/metrics | grep "http_requests_total"
```

### 7.2 ä½¿ç”¨PrometheuséªŒè¯


**Prometheusé…ç½®æµ‹è¯•**ï¼š
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'custom-exporter'
    static_configs:
      - targets: ['localhost:8080']
    scrape_interval: 30s
    metrics_path: /metrics
```

**éªŒè¯æŒ‡æ ‡è¢«æ­£ç¡®æŠ“å–**ï¼š
```
1. å¯åŠ¨Prometheus
2. è®¿é—® http://localhost:9090/targets
3. æ£€æŸ¥è‡ªå®šä¹‰ExporterçŠ¶æ€æ˜¯å¦ä¸º"UP"
4. åœ¨Graphé¡µé¢æŸ¥è¯¢ä½ çš„æŒ‡æ ‡
```

### 7.3 å¸¸è§é—®é¢˜è¯Šæ–­


**é—®é¢˜è¯Šæ–­æµç¨‹å›¾**ï¼š
```
Exporteræ— æ³•è®¿é—®ï¼Ÿ
â”‚
â”œâ”€ æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®ç›‘å¬
â”‚   â””â”€ netstat -tulpn | grep :8080
â”‚
â”œâ”€ æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
â”‚   â””â”€ ç¡®ä¿ç«¯å£å¯¹Prometheuså¼€æ”¾
â”‚
â”œâ”€ æ£€æŸ¥HTTPå“åº”
â”‚   â””â”€ curl -v http://localhost:8080/metrics
â”‚
â””â”€ æ£€æŸ¥æ—¥å¿—è¾“å‡º
    â””â”€ æŸ¥çœ‹Exporterå’ŒPrometheusæ—¥å¿—
```

**å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| é”™è¯¯ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| `è¿æ¥è¢«æ‹’ç»` | `ç«¯å£æœªç›‘å¬æˆ–é˜²ç«å¢™é˜»å¡` | `æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œç½‘ç»œé…ç½®` |
| `404é”™è¯¯` | `è·¯å¾„é”™è¯¯æˆ–è·¯ç”±æœªé…ç½®` | `ç¡®è®¤/metricsè·¯å¾„æ­£ç¡®` |
| `æŒ‡æ ‡ä¸ºç©º` | `æ•°æ®æ”¶é›†å¤±è´¥æˆ–æ ¼å¼é”™è¯¯` | `æ£€æŸ¥æ•°æ®æºå’Œæ ¼å¼è½¬æ¢` |
| `è§£æé”™è¯¯` | `æŒ‡æ ‡æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ` | `éªŒè¯è¾“å‡ºæ ¼å¼å’Œè¯­æ³•` |

### 7.4 è‡ªåŠ¨åŒ–æµ‹è¯•ç¤ºä¾‹


```python
import unittest
import requests
from prometheus_client.parser import text_string_to_metric_families

class TestCustomExporter(unittest.TestCase):
    
    def setUp(self):
        self.base_url = "http://localhost:8080"
    
    def test_metrics_endpoint_accessible(self):
        """æµ‹è¯•/metricsæ¥å£å¯è®¿é—®"""
        response = requests.get(f"{self.base_url}/metrics")
        self.assertEqual(response.status_code, 200)
        self.assertIn('text/plain', response.headers.get('content-type', ''))
    
    def test_metrics_format_valid(self):
        """æµ‹è¯•æŒ‡æ ‡æ ¼å¼æœ‰æ•ˆæ€§"""
        response = requests.get(f"{self.base_url}/metrics")
        
        # å°è¯•è§£ææŒ‡æ ‡
        try:
            families = list(text_string_to_metric_families(response.text))
            self.assertGreater(len(families), 0, "No metrics found")
        except Exception as e:
            self.fail(f"Metrics parsing failed: {e}")
    
    def test_required_metrics_present(self):
        """æµ‹è¯•å¿…éœ€æŒ‡æ ‡å­˜åœ¨"""
        response = requests.get(f"{self.base_url}/metrics")
        content = response.text
        
        required_metrics = [
            'http_requests_total',
            'system_cpu_usage_percent'
        ]
        
        for metric in required_metrics:
            self.assertIn(metric, content, f"Missing metric: {metric}")

if __name__ == '__main__':
    unittest.main()
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Exporteræœ¬è´¨ï¼šæ•°æ®æ ¼å¼è½¬æ¢å™¨ï¼Œå°†ç³»ç»Ÿæ•°æ®è½¬ä¸ºPrometheusæ ¼å¼
ğŸ”¸ å¼€å‘è§„èŒƒï¼šéµå¾ªå‘½åè§„èŒƒã€æŒ‡æ ‡ç±»å‹é€‰æ‹©ã€æ ‡ç­¾è®¾è®¡åŸåˆ™
ğŸ”¸ å®¢æˆ·ç«¯åº“ï¼šé€‰æ‹©å®˜æ–¹åº“ï¼Œæ­£ç¡®ä½¿ç”¨Counterã€Gaugeã€Histogramç­‰
ğŸ”¸ HTTPæœåŠ¡ï¼šå®ç°/metricsæ¥å£ï¼Œè¿”å›æ­£ç¡®çš„Content-Type
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ§åˆ¶é‡‡é›†é¢‘ç‡ã€é¿å…å†…å­˜æ³„æ¼ã€ä¿è¯çº¿ç¨‹å®‰å…¨
ğŸ”¸ è°ƒè¯•æµ‹è¯•ï¼šæœ¬åœ°éªŒè¯ã€Prometheusé›†æˆæµ‹è¯•ã€è‡ªåŠ¨åŒ–æµ‹è¯•
```

### 8.2 å¼€å‘æµç¨‹æœ€ä½³å®è·µ


**ğŸ”¹ è®¾è®¡é˜¶æ®µ**
```
1. æ˜ç¡®ç›‘æ§ç›®æ ‡ï¼šè¦ç›‘æ§ä»€ä¹ˆæ•°æ®ï¼Ÿ
2. é€‰æ‹©æŒ‡æ ‡ç±»å‹ï¼šCounterã€Gaugeã€Histogramã€Summary
3. è®¾è®¡æ ‡ç­¾ç»´åº¦ï¼šè€ƒè™‘æŸ¥è¯¢å’Œèšåˆéœ€æ±‚
4. è§„åˆ’æ•°æ®æºï¼šä»å“ªé‡Œè·å–æ•°æ®ï¼Ÿ
```

**ğŸ”¹ å®ç°é˜¶æ®µ**
```
1. é€‰æ‹©åˆé€‚è¯­è¨€å’Œå®¢æˆ·ç«¯åº“
2. å®ç°æ•°æ®æ”¶é›†é€»è¾‘
3. è®¾è®¡HTTPæœåŠ¡æ¥å£
4. æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
```

**ğŸ”¹ æµ‹è¯•é˜¶æ®µ**
```
1. æœ¬åœ°åŠŸèƒ½æµ‹è¯•
2. æ ¼å¼éªŒè¯æµ‹è¯•  
3. Prometheusé›†æˆæµ‹è¯•
4. æ€§èƒ½å‹åŠ›æµ‹è¯•
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**å¸¸ç”¨ç›‘æ§åœºæ™¯æ¨¡æ¿**ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¸ **Webåº”ç”¨ç›‘æ§**                  â”‚
â”‚   â€¢ HTTPè¯·æ±‚æ•°å’Œå“åº”æ—¶é—´            â”‚
â”‚   â€¢ é”™è¯¯ç‡å’ŒçŠ¶æ€ç åˆ†å¸ƒ              â”‚
â”‚   â€¢ å¹¶å‘è¿æ¥æ•°                      â”‚
â”‚   â€¢ æ•°æ®åº“è¿æ¥æ± çŠ¶æ€                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¸ **ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§**                 â”‚
â”‚   â€¢ è®¢å•æ•°é‡å’Œé‡‘é¢                  â”‚
â”‚   â€¢ ç”¨æˆ·æ³¨å†Œå’Œæ´»è·ƒåº¦                â”‚
â”‚   â€¢ æ”¯ä»˜æˆåŠŸç‡                      â”‚
â”‚   â€¢ åº“å­˜é¢„è­¦                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¸ **ç³»ç»Ÿèµ„æºç›‘æ§**                 â”‚
â”‚   â€¢ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡           â”‚
â”‚   â€¢ ç½‘ç»œæµé‡                        â”‚
â”‚   â€¢ è¿›ç¨‹çŠ¶æ€                        â”‚
â”‚   â€¢ æ–‡ä»¶å¥æŸ„æ•°                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 8.4 é¿å…å¸¸è§é™·é˜±


> âš ï¸ **å…³é”®æ³¨æ„äº‹é¡¹**

```
æ€§èƒ½é™·é˜±ï¼š
â€¢ é¿å…é«˜åŸºæ•°æ ‡ç­¾ï¼ˆå¦‚ç”¨æˆ·IDã€IPåœ°å€ï¼‰
â€¢ æ§åˆ¶æ•°æ®æ”¶é›†é¢‘ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹
â€¢ ä½¿ç”¨ç¼“å­˜æœºåˆ¶å‡å°‘é‡å¤è®¡ç®—

æ ¼å¼é™·é˜±ï¼š
â€¢ ç¡®ä¿æŒ‡æ ‡åç§°ç¬¦åˆè§„èŒƒ
â€¢ æ­£ç¡®è®¾ç½®HTTPå“åº”å¤´
â€¢ éªŒè¯æ•°å€¼ç±»å‹å’ŒèŒƒå›´

æ¶æ„é™·é˜±ï¼š
â€¢ ä¸€ä¸ªExporterä¸“æ³¨ä¸€ä¸ªæœåŠ¡
â€¢ åˆç†è®¾è®¡æŒ‡æ ‡ç»´åº¦
â€¢ è€ƒè™‘Exporterè‡ªèº«çš„å¯ç”¨æ€§
```

### 8.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


```
ğŸš€ æ·±å…¥å­¦ä¹ ï¼š
â€¢ å¤æ‚æ•°æ®æºé›†æˆï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ã€æ—¶åºæ•°æ®åº“ï¼‰
â€¢ é«˜å¯ç”¨Exporterè®¾è®¡
â€¢ å¤§è§„æ¨¡æŒ‡æ ‡ä¼˜åŒ–
â€¢ è‡ªå®šä¹‰æ”¶é›†è§„åˆ™é…ç½®

ğŸ”§ å·¥å…·æ‰©å±•ï¼š
â€¢ ä½¿ç”¨Grafanaå¯è§†åŒ–
â€¢ ç»“åˆAlertManagerå‘Šè­¦
â€¢ é›†æˆæœåŠ¡å‘ç°
â€¢ å®¹å™¨åŒ–éƒ¨ç½²ä¼˜åŒ–
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Exporterç¿»è¯‘å®˜ï¼Œæ•°æ®æ ¼å¼è¦è§„èŒƒ
- æŒ‡æ ‡ç±»å‹é€‰æ‹©å¥½ï¼Œæ ‡ç­¾è®¾è®¡è¦åˆç†
- HTTPæœåŠ¡è¦ç¨³å®šï¼Œæ€§èƒ½ä¼˜åŒ–ä¸èƒ½å¿˜
- æµ‹è¯•éªŒè¯å¾ˆé‡è¦ï¼Œé—®é¢˜æ’æŸ¥æœ‰æ–¹æ³•