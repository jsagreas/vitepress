---
title: 1、Prometheus-API基础与认证
---
## 📚 目录

1. [什么是Prometheus API](#1-什么是prometheus-api)
2. [API基础概念](#2-api基础概念)
3. [认证机制详解](#3-认证机制详解)
4. [API调用实战](#4-api调用实战)
5. [错误处理与调试](#5-错误处理与调试)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🌐 什么是Prometheus API


### 1.1 通俗理解API


> **💡 简单类比**
> 把Prometheus想象成一个图书馆，而API就是图书管理员。你想要什么书（数据），不能直接进去拿，必须通过管理员（API）来获取。

**Prometheus HTTP API**是什么？
```
简单说：就是一套"对话规则"
- 你：发送HTTP请求（问问题）
- Prometheus：返回JSON数据（给答案）
- 目的：让外部程序能获取监控数据
```

### 1.2 为什么需要API


**🔸 实际应用场景：**
- **自定义看板**：把监控数据展示在自己的网页上
- **报警集成**：当系统出问题时自动发通知
- **数据分析**：导出监控数据做进一步分析
- **第三方工具**：让其他软件也能读取Prometheus的数据

---

## 2. 📋 API基础概念


### 2.1 API地址格式


**🔸 标准格式：**
```
http://prometheus服务器地址:端口/api/v1/功能路径
```

**实际例子：**
```
基础地址：http://localhost:9090/api/v1/
查询数据：http://localhost:9090/api/v1/query
获取指标：http://localhost:9090/api/v1/label/__name__/values
```

> **📝 理解要点**
> - `localhost:9090`：Prometheus默认运行地址
> - `/api/v1/`：API版本，目前主要用v1版本
> - 后面的路径：决定你要做什么操作

### 2.2 HTTP方法


| **方法** | **用途** | **例子** |
|---------|---------|---------|
| `GET` | **获取数据** | `查询CPU使用率` |
| `POST` | **提交复杂查询** | `发送长查询语句` |
| `DELETE` | **删除数据** | `删除指定时间段的数据` |

**⭐ 重点理解**：95%的情况下我们都用`GET`方法，就是最简单的"获取数据"。

### 2.3 响应格式


**所有API返回的都是JSON格式：**
```json
{
  "status": "success",     // 成功还是失败
  "data": {               // 实际数据内容
    "result": [...]
  }
}
```

---

## 3. 🔐 认证机制详解


### 3.1 无认证模式（默认）


**🔸 最简单的情况：**
```bash
# 直接访问，不需要任何认证
curl http://localhost:9090/api/v1/query?query=up
```

> **💡 新手提示**
> 如果你是在自己电脑上学习，通常不需要认证，可以直接访问。

### 3.2 基础认证（Basic Auth）


**什么是Basic Auth？**
```
就像进小区要刷门禁卡
- 用户名：门禁卡号
- 密码：门禁密码
- 每次请求都要带上
```

**🔧 实际使用：**
```bash
# 方法1：在URL中包含用户名密码
curl http://用户名:密码@localhost:9090/api/v1/query?query=up

# 方法2：使用-u参数（推荐）
curl -u admin:password http://localhost:9090/api/v1/query?query=up

# 方法3：手动设置认证头
curl -H "Authorization: Basic YWRtaW46cGFzc3dvcmQ=" \
     http://localhost:9090/api/v1/query?query=up
```

### 3.3 Token认证（Bearer Token）


**什么是Token认证？**
```
就像超市的购物卡
- Token：一串特殊的字符，代表你的身份
- 有效期：Token可能会过期
- 更安全：比用户名密码更安全
```

**🔧 实际使用：**
```bash
# 使用Bearer Token
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
     http://localhost:9090/api/v1/query?query=up
```

### 3.4 认证配置检查


**🔍 如何知道需要什么认证？**
```bash
# 测试1：先试试无认证
curl http://localhost:9090/api/v1/query?query=up

# 如果返回401错误，说明需要认证
# 如果返回正常数据，说明不需要认证
```

**常见响应状态：**
- `200`：成功 ✅
- `401`：需要认证 🔐
- `403`：权限不够 ❌
- `404`：地址错误 🔍

---

## 4. 🚀 API调用实战


### 4.1 最简单的查询


**🎯 目标：获取所有正在运行的服务**
```bash
# 查询所有服务的运行状态
curl "http://localhost:9090/api/v1/query?query=up"
```

**返回数据解释：**
```json
{
  "status": "success",
  "data": {
    "resultType": "vector",
    "result": [
      {
        "metric": {
          "__name__": "up",
          "instance": "localhost:9090",
          "job": "prometheus"
        },
        "value": [1632150000, "1"]  // [时间戳, 值]
      }
    ]
  }
}
```

> **📝 数据含义**
> - `up = 1`：服务正常运行
> - `up = 0`：服务不可用
> - `instance`：具体的服务地址
> - `job`：服务分组名称

### 4.2 带参数的查询


**🔸 查询特定时间的数据：**
```bash
# 查询指定时间点的数据
curl "http://localhost:9090/api/v1/query?query=up&time=2023-01-01T12:00:00Z"
```

**🔸 查询时间范围的数据：**
```bash
# 查询最近1小时的数据
curl "http://localhost:9090/api/v1/query_range?query=up&start=$(date -d '1 hour ago' -u +%Y-%m-%dT%H:%M:%SZ)&end=$(date -u +%Y-%m-%dT%H:%M:%SZ)&step=5m"
```

### 4.3 设置请求头


**🔧 完整的请求示例：**
```bash
curl -X GET \
  -H "Content-Type: application/json" \
  -H "Accept: application/json" \
  -H "User-Agent: MyApp/1.0" \
  --connect-timeout 10 \
  --max-time 30 \
  "http://localhost:9090/api/v1/query?query=up"
```

**参数解释：**
- `--connect-timeout 10`：连接超时10秒
- `--max-time 30`：总请求时间不超过30秒
- `-H`：设置请求头

---

## 5. 🐛 错误处理与调试


### 5.1 常见错误类型


| **错误代码** | **含义** | **解决方法** |
|-------------|---------|-------------|
| `400` | **请求格式错误** | `检查URL参数和查询语句` |
| `401` | **需要认证** | `添加用户名密码或Token` |
| `403` | **权限不够** | `检查用户权限设置` |
| `404` | **地址不存在** | `确认API路径是否正确` |
| `500` | **服务器内部错误** | `检查Prometheus服务状态` |

### 5.2 调试技巧


**🔸 查看详细信息：**
```bash
# 显示完整的请求和响应信息
curl -v "http://localhost:9090/api/v1/query?query=up"

# 只显示响应头
curl -I "http://localhost:9090/api/v1/query?query=up"
```

**🔸 保存响应到文件：**
```bash
# 保存完整响应
curl "http://localhost:9090/api/v1/query?query=up" > response.json

# 保存错误信息
curl "http://localhost:9090/api/v1/query?query=up" 2> error.log
```

### 5.3 常见问题解决


**❓ 问题1：连接被拒绝**
```bash
# 错误信息：Connection refused
# 解决方法：
1. 检查Prometheus是否启动：ps aux | grep prometheus
2. 检查端口是否正确：netstat -tlnp | grep 9090
3. 检查防火墙设置
```

**❓ 问题2：查询语法错误**
```bash
# 错误信息：parse error
# 解决方法：
1. 先在Prometheus Web界面测试查询
2. 检查特殊字符是否需要URL编码
3. 使用简单查询逐步复杂化
```

**❓ 问题3：返回数据为空**
```bash
# 可能原因：
1. 查询的指标不存在
2. 时间范围没有数据
3. 标签过滤条件太严格

# 调试方法：
curl "http://localhost:9090/api/v1/label/__name__/values" # 查看所有指标名
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 API本质：HTTP请求获取JSON数据的接口
🔸 基础地址：http://服务器:9090/api/v1/
🔸 主要方法：GET（获取数据）、POST（复杂查询）
🔸 认证方式：无认证、Basic Auth、Bearer Token
🔸 响应格式：JSON，包含status和data字段
```

### 6.2 实际应用记忆要点


**🧠 一句话总结**：
> API就是向Prometheus"问问题"的标准方式，用HTTP请求发问，用JSON数据回答。

**⭐ 必背要点**：
- 默认端口：`9090`
- API版本：`v1`
- 基础查询：`/api/v1/query?query=指标名`
- 认证方式：`-u 用户:密码` 或 `-H "Authorization: Bearer token"`

**🔑 关键操作流程**：
```
1. 确认Prometheus地址和端口
2. 选择合适的认证方式
3. 构造查询URL
4. 发送HTTP请求
5. 解析JSON响应数据
```

### 6.3 新手学习路径


**📚 学习顺序建议**：
1. **先学无认证**：在本地环境练习基础查询
2. **掌握curl命令**：熟悉命令行API调用
3. **理解JSON响应**：知道数据格式和含义
4. **学习认证方式**：根据实际环境选择认证
5. **练习错误处理**：学会调试和解决问题

**🎯 实践建议**：
- 先用Prometheus Web界面熟悉查询语句
- 再用API重现相同的查询
- 从简单查询开始，逐步增加复杂度
- 多练习错误处理和调试技巧

**核心记忆口诀**：
> API访问三步走：地址认证加查询  
> JSON响应要理解：状态数据分清楚  
> 错误调试不要慌：状态码里找答案