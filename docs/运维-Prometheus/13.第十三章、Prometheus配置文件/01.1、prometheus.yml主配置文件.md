---
title: 1ã€prometheus.ymlä¸»é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [Prometheusé…ç½®æ–‡ä»¶åŸºç¡€](#1-prometheusé…ç½®æ–‡ä»¶åŸºç¡€)
2. [å…¨å±€é…ç½®è¯¦è§£](#2-å…¨å±€é…ç½®è¯¦è§£)
3. [æŠ“å–é…ç½®æ ¸å¿ƒ](#3-æŠ“å–é…ç½®æ ¸å¿ƒ)
4. [ç›®æ ‡é…ç½®ä¸å‘ç°](#4-ç›®æ ‡é…ç½®ä¸å‘ç°)
5. [è®¤è¯ä¸å®‰å…¨é…ç½®](#5-è®¤è¯ä¸å®‰å…¨é…ç½®)
6. [æ ‡ç­¾é‡å†™æœºåˆ¶](#6-æ ‡ç­¾é‡å†™æœºåˆ¶)
7. [å®æˆ˜é…ç½®ç¤ºä¾‹](#7-å®æˆ˜é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ Prometheusé…ç½®æ–‡ä»¶åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Prometheusé…ç½®æ–‡ä»¶


**ç®€å•ç†è§£**ï¼šPrometheusé…ç½®æ–‡ä»¶å°±åƒæ˜¯ç›‘æ§ç³»ç»Ÿçš„"è¯´æ˜ä¹¦"ï¼Œå‘Šè¯‰Prometheusåº”è¯¥ç›‘æ§å“ªäº›æœåŠ¡ï¼Œå¤šä¹…ç›‘æ§ä¸€æ¬¡ï¼Œæ€ä¹ˆç›‘æ§ç­‰ç­‰ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
Prometheusé…ç½®æ–‡ä»¶ = ä½“æ£€è®¡åˆ’è¡¨
- ä½“æ£€é¡¹ç›® = ç›‘æ§ç›®æ ‡(targets)
- ä½“æ£€é¢‘ç‡ = æŠ“å–é—´éš”(scrape_interval)  
- ä½“æ£€åŒ»é™¢ = ç›‘æ§ä½œä¸š(job_name)
- ä½“æ£€æŠ¥å‘Šå­˜æ”¾ = æ•°æ®å­˜å‚¨é…ç½®
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ **å®šä¹‰ç›‘æ§ç›®æ ‡** - å‘Šè¯‰Prometheusè¦ç›‘æ§å“ªäº›æœåŠ¡
- â° **è®¾ç½®ç›‘æ§é¢‘ç‡** - å¤šä¹…é‡‡é›†ä¸€æ¬¡æ•°æ®
- ğŸ”§ **é…ç½®é‡‡é›†æ–¹å¼** - æ€ä¹ˆè·å–ç›‘æ§æ•°æ®
- ğŸ·ï¸ **ç®¡ç†æ ‡ç­¾ä¿¡æ¯** - ç»™ç›‘æ§æ•°æ®æ‰“æ ‡ç­¾åˆ†ç±»

### 1.2 é…ç½®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„


**é…ç½®æ–‡ä»¶æ¶æ„å›¾**ï¼š
```
prometheus.yml (ä¸»é…ç½®æ–‡ä»¶)
â”œâ”€â”€ global (å…¨å±€è®¾ç½®)
â”‚   â”œâ”€â”€ scrape_interval (æŠ“å–é—´éš”)
â”‚   â”œâ”€â”€ evaluation_interval (è§„åˆ™è¯„ä¼°é—´éš”)
â”‚   â””â”€â”€ external_labels (å¤–éƒ¨æ ‡ç­¾)
â”œâ”€â”€ rule_files (è§„åˆ™æ–‡ä»¶åˆ—è¡¨)
â”œâ”€â”€ alerting (å‘Šè­¦é…ç½®)
â””â”€â”€ scrape_configs (æŠ“å–é…ç½®)
    â”œâ”€â”€ job_name (ä½œä¸šåç§°)
    â”œâ”€â”€ scrape_interval (ä½œä¸šæŠ“å–é—´éš”)
    â”œâ”€â”€ static_configs (é™æ€ç›®æ ‡é…ç½®)
    â””â”€â”€ å…¶ä»–é…ç½®é¡¹...
```

**æ–‡ä»¶ä½ç½®å’Œå‘½å**ï¼š
- **é»˜è®¤è·¯å¾„**ï¼š`/etc/prometheus/prometheus.yml`
- **å¯åŠ¨æŒ‡å®š**ï¼š`prometheus --config.file=/path/to/config.yml`
- **æ ¼å¼è¦æ±‚**ï¼šå¿…é¡»æ˜¯æœ‰æ•ˆçš„YAMLæ ¼å¼

---

## 2. ğŸŒ å…¨å±€é…ç½®è¯¦è§£


### 2.1 å…¨å±€é…ç½®åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å…¨å±€é…ç½®**ï¼šå°±åƒå…¬å¸çš„é€šç”¨è§„åˆ™ï¼Œé€‚ç”¨äºæ‰€æœ‰éƒ¨é—¨ã€‚å…¨å±€é…ç½®æ˜¯Prometheusçš„é»˜è®¤è®¾ç½®ï¼Œå½±å“æ•´ä¸ªç›‘æ§ç³»ç»Ÿçš„è¡Œä¸ºã€‚

### 2.2 æ ¸å¿ƒå…¨å±€é…ç½®é¡¹


#### â±ï¸ scrape_interval - æŠ“å–é—´éš”


**é€šä¿—è§£é‡Š**ï¼šå¤šä¹…å»"é—®ä¸€æ¬¡"è¢«ç›‘æ§çš„æœåŠ¡"ä½ ç°åœ¨æ€ä¹ˆæ ·ï¼Ÿ"

```yaml
global:
  scrape_interval: 15s  # æ¯15ç§’æŠ“å–ä¸€æ¬¡æ•°æ®
```

**é…ç½®è¯´æ˜**ï¼š
- **é»˜è®¤å€¼**ï¼š`1m`ï¼ˆ1åˆ†é’Ÿï¼‰
- **å¸¸ç”¨å€¼**ï¼š`15s`ã€`30s`ã€`1m`
- **é€‰æ‹©åŸåˆ™**ï¼š
  - ğŸ”¥ **é«˜é¢‘ç›‘æ§**ï¼š`10s-15s` - å…³é”®æœåŠ¡
  - âš–ï¸ **å¸¸è§„ç›‘æ§**ï¼š`30s-1m` - ä¸€èˆ¬æœåŠ¡  
  - ğŸ’¾ **èŠ‚çœèµ„æº**ï¼š`2m-5m` - éå…³é”®æœåŠ¡

#### ğŸ“Š evaluation_interval - è§„åˆ™è¯„ä¼°é—´éš”


**é€šä¿—è§£é‡Š**ï¼šå¤šä¹…æ£€æŸ¥ä¸€æ¬¡å‘Šè­¦è§„åˆ™ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦å‘é€å‘Šè­¦ã€‚

```yaml
global:
  evaluation_interval: 15s  # æ¯15ç§’è¯„ä¼°ä¸€æ¬¡è§„åˆ™
```

**å®é™…æ„ä¹‰**ï¼š
- è¯„ä¼°é¢‘ç‡è¶Šé«˜ï¼Œå‘Šè­¦å“åº”è¶ŠåŠæ—¶
- ä½†ä¼šæ¶ˆè€—æ›´å¤šCPUèµ„æº
- é€šå¸¸è®¾ç½®ä¸ºä¸`scrape_interval`ç›¸åŒæˆ–ç¨å¤§

#### ğŸ·ï¸ external_labels - å¤–éƒ¨æ ‡ç­¾


**é€šä¿—è§£é‡Š**ï¼šç»™è¿™ä¸ªPrometheuså®ä¾‹è´´ä¸ª"èº«ä»½æ ‡ç­¾"ï¼Œåœ¨å¤šä¸ªPrometheusé›†ç¾¤ä¸­åŒºåˆ†å½¼æ­¤ã€‚

```yaml
global:
  external_labels:
    cluster: 'production'
    region: 'us-west-1'
    datacenter: 'dc01'
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- **å¤šé›†ç¾¤ç¯å¢ƒ** - åŒºåˆ†ä¸åŒçš„Prometheuså®ä¾‹
- **è”é‚¦é…ç½®** - ä¸Šçº§Prometheusè¯†åˆ«ä¸‹çº§æ¥æº
- **å‘Šè­¦èšåˆ** - å‘Šè­¦ä¿¡æ¯ä¸­åŒ…å«ç¯å¢ƒæ ‡è¯†

### 2.3 å…¨å±€é…ç½®å®Œæ•´ç¤ºä¾‹


```yaml
global:
  # åŸºç¡€æ—¶é—´é…ç½®
  scrape_interval: 15s          # é»˜è®¤æŠ“å–é—´éš”
  evaluation_interval: 15s      # è§„åˆ™è¯„ä¼°é—´éš”
  scrape_timeout: 10s           # æŠ“å–è¶…æ—¶æ—¶é—´
  
  # å¤–éƒ¨æ ‡ç­¾é…ç½®
  external_labels:
    cluster: 'production'       # é›†ç¾¤æ ‡è¯†
    region: 'asia-east1'        # åœ°åŒºæ ‡è¯†
    env: 'prod'                 # ç¯å¢ƒæ ‡è¯†
```

---

## 3. ğŸ¯ æŠ“å–é…ç½®æ ¸å¿ƒ


### 3.1 scrape_configsåŸºç¡€ç†è§£


**ç®€å•ç†è§£**ï¼š`scrape_configs`å°±æ˜¯å‘Šè¯‰Prometheus"å»å“ªé‡ŒæŠ“æ•°æ®ï¼Œæ€ä¹ˆæŠ“"çš„è¯¦ç»†æ¸…å•ã€‚

**é…ç½®ç»“æ„**ï¼š
```
scrape_configs:        # æŠ“å–é…ç½®åˆ—è¡¨
  - job_name: 'app1'   # ç¬¬ä¸€ä¸ªç›‘æ§ä½œä¸š
    ...é…ç½®é¡¹...
  - job_name: 'app2'   # ç¬¬äºŒä¸ªç›‘æ§ä½œä¸š
    ...é…ç½®é¡¹...
```

### 3.2 job_name - ä½œä¸šåç§°


**ä½œç”¨è¯´æ˜**ï¼šç»™æ¯ä¸ªç›‘æ§ä»»åŠ¡èµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿ç®¡ç†å’ŒåŒºåˆ†ã€‚

```yaml
scrape_configs:
  - job_name: 'web-servers'     # ç›‘æ§WebæœåŠ¡å™¨
  - job_name: 'databases'       # ç›‘æ§æ•°æ®åº“
  - job_name: 'message-queue'   # ç›‘æ§æ¶ˆæ¯é˜Ÿåˆ—
```

**å‘½åå»ºè®®**ï¼š
- ğŸ“ **æè¿°æ€§å‘½å** - ä¸€çœ‹å°±çŸ¥é“ç›‘æ§ä»€ä¹ˆ
- ğŸ”¤ **ä½¿ç”¨è‹±æ–‡å’Œè¿å­—ç¬¦** - é¿å…ç‰¹æ®Šå­—ç¬¦
- ğŸ“‹ **åˆ†ç±»æ¸…æ™°** - æŒ‰æœåŠ¡ç±»å‹æˆ–åŠŸèƒ½åˆ†ç»„

### 3.3 æ ¸å¿ƒæŠ“å–å‚æ•°è¯¦è§£


#### ğŸ“ static_configs - é™æ€ç›®æ ‡é…ç½®


**é€šä¿—è§£é‡Š**ï¼šæ‰‹åŠ¨æŒ‡å®šè¦ç›‘æ§çš„æœåŠ¡åœ°å€ï¼Œåƒé€šè®¯å½•ä¸€æ ·åˆ—å‡ºæ‰€æœ‰è”ç³»æ–¹å¼ã€‚

```yaml
scrape_configs:
  - job_name: 'web-app'
    static_configs:
      - targets: 
          - '192.168.1.10:8080'   # ç¬¬ä¸€å°WebæœåŠ¡å™¨
          - '192.168.1.11:8080'   # ç¬¬äºŒå°WebæœåŠ¡å™¨
          - '192.168.1.12:8080'   # ç¬¬ä¸‰å°WebæœåŠ¡å™¨
```

**é…ç½®è¦ç‚¹**ï¼š
- **æ ¼å¼è¦æ±‚**ï¼š`IP:ç«¯å£` æˆ– `åŸŸå:ç«¯å£`
- **å¤šç›®æ ‡æ”¯æŒ**ï¼šä¸€ä¸ªjobå¯ä»¥ç›‘æ§å¤šä¸ªç›®æ ‡
- **æ ‡ç­¾ç»§æ‰¿**ï¼šåŒä¸€ç»„targetså…±äº«ç›¸åŒæ ‡ç­¾

#### ğŸ›£ï¸ metrics_path - æŒ‡æ ‡è·¯å¾„


**é€šä¿—è§£é‡Š**ï¼šå‘Šè¯‰Prometheuså»ç›®æ ‡æœåŠ¡çš„å“ªä¸ª"æˆ¿é—´"è·å–ç›‘æ§æ•°æ®ã€‚

```yaml
scrape_configs:
  - job_name: 'custom-app'
    metrics_path: '/actuator/prometheus'  # Spring Bootåº”ç”¨
    static_configs:
      - targets: ['app.example.com:8080']

  - job_name: 'node-exporter'
    metrics_path: '/metrics'              # é»˜è®¤è·¯å¾„
    static_configs:
      - targets: ['server1:9100']
```

**å¸¸è§è·¯å¾„**ï¼š
- **é»˜è®¤è·¯å¾„**ï¼š`/metrics`
- **Spring Boot**ï¼š`/actuator/prometheus`
- **è‡ªå®šä¹‰åº”ç”¨**ï¼šå¯èƒ½æ˜¯`/stats`ã€`/health`ç­‰

#### â° scrape_interval - ä½œä¸šçº§æŠ“å–é—´éš”


**ä½œç”¨è¯´æ˜**ï¼šä¸ºç‰¹å®šä½œä¸šè®¾ç½®ä¸“é—¨çš„æŠ“å–é¢‘ç‡ï¼Œè¦†ç›–å…¨å±€è®¾ç½®ã€‚

```yaml
scrape_configs:
  - job_name: 'critical-service'
    scrape_interval: 5s           # å…³é”®æœåŠ¡ï¼Œ5ç§’æŠ“å–ä¸€æ¬¡
    static_configs:
      - targets: ['critical-app:8080']
      
  - job_name: 'batch-job'
    scrape_interval: 5m           # æ‰¹å¤„ç†ä»»åŠ¡ï¼Œ5åˆ†é’ŸæŠ“å–ä¸€æ¬¡
    static_configs:
      - targets: ['batch-server:8080']
```

#### â±ï¸ scrape_timeout - æŠ“å–è¶…æ—¶


**é€šä¿—è§£é‡Š**ï¼šç­‰å¤šä¹…æ²¡å“åº”å°±æ”¾å¼ƒï¼Œé¿å…ä¸€ç›´ç­‰å¾…å¡ä½ã€‚

```yaml
scrape_configs:
  - job_name: 'slow-service'
    scrape_timeout: 30s           # ç­‰å¾…30ç§’
    static_configs:
      - targets: ['slow-app:8080']
```

**è®¾ç½®åŸåˆ™**ï¼š
- å¿…é¡»å°äº`scrape_interval`
- ä¸€èˆ¬è®¾ç½®ä¸ºæŠ“å–é—´éš”çš„2/3
- ç½‘ç»œè¾ƒæ…¢ç¯å¢ƒé€‚å½“å»¶é•¿

---

## 4. ğŸ¯ ç›®æ ‡é…ç½®ä¸å‘ç°


### 4.1 æ ·æœ¬é™åˆ¶é…ç½®


#### ğŸ“Š sample_limit - æ ·æœ¬é™åˆ¶


**é€šä¿—è§£é‡Š**ï¼šé™åˆ¶æ¯æ¬¡æŠ“å–çš„æŒ‡æ ‡æ•°é‡ï¼Œé˜²æ­¢æŸä¸ªæœåŠ¡äº§ç”Ÿè¿‡å¤šæ•°æ®æŠŠPrometheusæ’‘çˆ†ã€‚

```yaml
scrape_configs:
  - job_name: 'high-cardinality-app'
    sample_limit: 5000            # æœ€å¤šæŠ“å–5000ä¸ªæŒ‡æ ‡
    static_configs:
      - targets: ['app:8080']
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- é˜²æ­¢æŒ‡æ ‡çˆ†ç‚¸
- ä¿æŠ¤Prometheusæ€§èƒ½
- å‘ç°å¼‚å¸¸æŒ‡æ ‡å¢é•¿

### 4.2 åè®®å’Œå‚æ•°é…ç½®


#### ğŸ” scheme - åè®®ç±»å‹


**ä½œç”¨è¯´æ˜**ï¼šæŒ‡å®šä½¿ç”¨HTTPè¿˜æ˜¯HTTPSåè®®æŠ“å–æ•°æ®ã€‚

```yaml
scrape_configs:
  - job_name: 'secure-service'
    scheme: https                 # ä½¿ç”¨HTTPSåè®®
    static_configs:
      - targets: ['secure-app:8443']
      
  - job_name: 'internal-service'
    scheme: http                  # ä½¿ç”¨HTTPåè®®ï¼ˆé»˜è®¤å€¼ï¼‰
    static_configs:
      - targets: ['internal-app:8080']
```

#### ğŸ“‹ params - æŸ¥è¯¢å‚æ•°


**é€šä¿—è§£é‡Š**ï¼šåœ¨æŠ“å–URLåé¢æ·»åŠ æŸ¥è¯¢å‚æ•°ï¼Œåƒç½‘å€åé¢çš„`?name=value`ã€‚

```yaml
scrape_configs:
  - job_name: 'custom-metrics'
    params:
      format: ['prometheus']      # æ·»åŠ  ?format=prometheus
      debug: ['true']             # æ·»åŠ  &debug=true
    static_configs:
      - targets: ['app:8080']
```

---

## 5. ğŸ” è®¤è¯ä¸å®‰å…¨é…ç½®


### 5.1 åŸºç¡€è®¤è¯é…ç½®


#### ğŸ”‘ basic_auth - åŸºç¡€è®¤è¯


**é€šä¿—è§£é‡Š**ï¼šå°±åƒç™»å½•ç½‘ç«™éœ€è¦ç”¨æˆ·åå’Œå¯†ç ï¼ŒPrometheusè®¿é—®å—ä¿æŠ¤çš„æœåŠ¡ä¹Ÿéœ€è¦æä¾›è®¤è¯ä¿¡æ¯ã€‚

```yaml
scrape_configs:
  - job_name: 'protected-service'
    basic_auth:
      username: 'prometheus'
      password: 'secret123'
    static_configs:
      - targets: ['protected-app:8080']
```

**å®‰å…¨å»ºè®®**ï¼š
- ğŸ” **é¿å…æ˜æ–‡å¯†ç ** - ä½¿ç”¨`password_file`
- ğŸ“ **æ–‡ä»¶æƒé™æ§åˆ¶** - å¯†ç æ–‡ä»¶è®¾ç½®ä¸¥æ ¼æƒé™
- ğŸ”„ **å®šæœŸè½®æ¢å¯†ç ** - å®šæœŸæ›´æ–°è®¤è¯ä¿¡æ¯

**ä½¿ç”¨æ–‡ä»¶å­˜å‚¨å¯†ç **ï¼š
```yaml
scrape_configs:
  - job_name: 'secure-app'
    basic_auth:
      username: 'prometheus'
      password_file: '/etc/prometheus/password.txt'
    static_configs:
      - targets: ['app:8080']
```

### 5.2 Tokenè®¤è¯é…ç½®


#### ğŸ« bearer_token - ä»¤ç‰Œè®¤è¯


**é€šä¿—è§£é‡Š**ï¼šåƒVIPå¡ä¸€æ ·ï¼Œæ‹¿ç€è¿™ä¸ªä»¤ç‰Œå°±èƒ½è®¿é—®æœåŠ¡ï¼Œæ¯”ç”¨æˆ·åå¯†ç æ›´æ–¹ä¾¿ã€‚

```yaml
scrape_configs:
  - job_name: 'api-service'
    bearer_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
    static_configs:
      - targets: ['api-server:8080']
```

**ä½¿ç”¨æ–‡ä»¶å­˜å‚¨Token**ï¼š
```yaml
scrape_configs:
  - job_name: 'k8s-pods'
    bearer_token_file: '/var/run/secrets/kubernetes.io/serviceaccount/token'
    static_configs:
      - targets: ['k8s-api:443']
```

### 5.3 TLSå®‰å…¨é…ç½®


#### ğŸ”’ tls_config - TLSé…ç½®


**é€šä¿—è§£é‡Š**ï¼šé…ç½®HTTPSè¿æ¥çš„å®‰å…¨è®¾ç½®ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«çªƒå¬æˆ–ç¯¡æ”¹ã€‚

```yaml
scrape_configs:
  - job_name: 'https-service'
    scheme: https
    tls_config:
      ca_file: '/etc/ssl/certs/ca.pem'           # CAè¯ä¹¦æ–‡ä»¶
      cert_file: '/etc/ssl/certs/client.pem'     # å®¢æˆ·ç«¯è¯ä¹¦
      key_file: '/etc/ssl/private/client.key'    # å®¢æˆ·ç«¯ç§é’¥
      insecure_skip_verify: false                # ä¸è·³è¿‡è¯ä¹¦éªŒè¯
    static_configs:
      - targets: ['secure-app:8443']
```

**é…ç½®é¡¹è¯´æ˜**ï¼š
- **ca_file** - éªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„CAè¯ä¹¦
- **cert_file/key_file** - åŒå‘è®¤è¯æ—¶çš„å®¢æˆ·ç«¯è¯ä¹¦
- **insecure_skip_verify** - æ˜¯å¦è·³è¿‡è¯ä¹¦éªŒè¯ï¼ˆä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰

---

## 6. ğŸ·ï¸ æ ‡ç­¾é‡å†™æœºåˆ¶


### 6.1 æ ‡ç­¾å¤„ç†åŸºç¡€


#### ğŸ·ï¸ honor_labels - æ ‡ç­¾å¤„ç†ç­–ç•¥


**é€šä¿—è§£é‡Š**ï¼šå½“ç›®æ ‡æœåŠ¡è¿”å›çš„æ ‡ç­¾å’ŒPrometheusè‡ªåŠ¨æ·»åŠ çš„æ ‡ç­¾å†²çªæ—¶ï¼Œå¬è°çš„ï¼Ÿ

```yaml
scrape_configs:
  - job_name: 'custom-app'
    honor_labels: true            # ä¼˜å…ˆä½¿ç”¨ç›®æ ‡æœåŠ¡çš„æ ‡ç­¾
    static_configs:
      - targets: ['app:8080']
```

**ä¸¤ç§æ¨¡å¼å¯¹æ¯”**ï¼š

| è®¾ç½® | **è¡Œä¸ºè¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|------|-------------|-------------|
| `honor_labels: true` | ä¿ç•™ç›®æ ‡æœåŠ¡çš„åŸå§‹æ ‡ç­¾ | è”é‚¦é…ç½®ã€ä»£ç†åœºæ™¯ |
| `honor_labels: false` | Prometheusæ ‡ç­¾ä¼˜å…ˆï¼Œå†²çªæ—¶é‡å‘½å | ä¸€èˆ¬ç›‘æ§åœºæ™¯ |

#### â° honor_timestamps - æ—¶é—´æˆ³å¤„ç†


**é€šä¿—è§£é‡Š**ï¼šä½¿ç”¨ç›®æ ‡æœåŠ¡æä¾›çš„æ—¶é—´æˆ³ï¼Œè¿˜æ˜¯ç”¨PrometheusæŠ“å–æ—¶çš„æ—¶é—´æˆ³ï¼Ÿ

```yaml
scrape_configs:
  - job_name: 'batch-metrics'
    honor_timestamps: true        # ä½¿ç”¨æœåŠ¡æä¾›çš„æ—¶é—´æˆ³
    static_configs:
      - targets: ['batch-job:8080']
```

### 6.2 æ ‡ç­¾é‡å†™é…ç½®


#### ğŸ”„ relabel_configs - é‡æ ‡ç­¾é…ç½®


**é€šä¿—è§£é‡Š**ï¼šåœ¨æŠ“å–æ•°æ®ä¹‹å‰ï¼Œå¯¹æ ‡ç­¾è¿›è¡Œ"ç¾å®¹æ•´å½¢"ï¼Œæ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ ‡ç­¾ã€‚

**åŸºæœ¬é‡æ ‡ç­¾ç¤ºä¾‹**ï¼š
```yaml
scrape_configs:
  - job_name: 'web-servers'
    static_configs:
      - targets: ['web1:8080', 'web2:8080']
        labels:
          env: 'production'       # æ·»åŠ ç¯å¢ƒæ ‡ç­¾
          team: 'backend'         # æ·»åŠ å›¢é˜Ÿæ ‡ç­¾
    relabel_configs:
      # æ ¹æ®å®ä¾‹åæ·»åŠ åŒºåŸŸæ ‡ç­¾
      - source_labels: [__address__]
        regex: 'web1:.*'
        target_label: 'zone'
        replacement: 'zone-a'
      - source_labels: [__address__]
        regex: 'web2:.*'
        target_label: 'zone'
        replacement: 'zone-b'
```

**å¸¸ç”¨é‡æ ‡ç­¾æ“ä½œ**ï¼š

| æ“ä½œç±»å‹ | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|
| `replace` | æ›¿æ¢æ ‡ç­¾å€¼ | æ ¼å¼åŒ–æ ‡ç­¾ã€æå–ä¿¡æ¯ |
| `keep` | ä¿ç•™åŒ¹é…çš„ç›®æ ‡ | è¿‡æ»¤ç›‘æ§ç›®æ ‡ |
| `drop` | ä¸¢å¼ƒåŒ¹é…çš„ç›®æ ‡ | æ’é™¤ç‰¹å®šæœåŠ¡ |
| `labelmap` | æ‰¹é‡æ˜ å°„æ ‡ç­¾ | Kubernetesæ ‡ç­¾è½¬æ¢ |

#### ğŸ“Š metric_relabel_configs - æŒ‡æ ‡é‡æ ‡ç­¾


**é€šä¿—è§£é‡Š**ï¼šåœ¨å­˜å‚¨æ•°æ®ä¹‹å‰ï¼Œå¯¹æŒ‡æ ‡è¿›è¡Œæœ€åçš„"æ•´ç†"ï¼Œé€šå¸¸ç”¨äºè¿‡æ»¤ä¸éœ€è¦çš„æŒ‡æ ‡ã€‚

```yaml
scrape_configs:
  - job_name: 'noisy-app'
    static_configs:
      - targets: ['app:8080']
    metric_relabel_configs:
      # ä¸¢å¼ƒè°ƒè¯•ç›¸å…³çš„æŒ‡æ ‡
      - source_labels: [__name__]
        regex: 'debug_.*'
        action: drop
      # ä¿ç•™é‡è¦çš„ä¸šåŠ¡æŒ‡æ ‡  
      - source_labels: [__name__]
        regex: 'business_.*'
        action: keep
```

---

## 7. ğŸ› ï¸ å®æˆ˜é…ç½®ç¤ºä¾‹


### 7.1 åŸºç¡€Webåº”ç”¨ç›‘æ§


```yaml
# å®Œæ•´çš„Webåº”ç”¨ç›‘æ§é…ç½®
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'web-cluster'
    env: 'production'

scrape_configs:
  # Webåº”ç”¨ç›‘æ§
  - job_name: 'web-application'
    scrape_interval: 10s          # å…³é”®æœåŠ¡ï¼Œé«˜é¢‘ç›‘æ§
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets:
          - 'web1.example.com:8080'
          - 'web2.example.com:8080'
        labels:
          service: 'frontend'
          version: 'v1.2.3'
    # æ·»åŠ å®ä¾‹æ ‡ç­¾
    relabel_configs:
      - source_labels: [__address__]
        target_label: 'instance_name'
        regex: '([^:]+):.*'
        replacement: '${1}'
```

### 7.2 æ•°æ®åº“ç›‘æ§é…ç½®


```yaml
scrape_configs:
  # MySQLæ•°æ®åº“ç›‘æ§
  - job_name: 'mysql-exporter'
    scrape_interval: 30s
    static_configs:
      - targets: ['mysql-exporter:9104']
    basic_auth:
      username: 'prometheus'
      password_file: '/etc/prometheus/mysql_password'
    relabel_configs:
      # æ·»åŠ æ•°æ®åº“ç±»å‹æ ‡ç­¾
      - target_label: 'db_type'
        replacement: 'mysql'
```

### 7.3 Kubernetesç¯å¢ƒç›‘æ§


```yaml
scrape_configs:
  # Kubernetes API Serverç›‘æ§
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      # åªç›‘æ§kube-systemå‘½åç©ºé—´çš„kubernetesæœåŠ¡
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: kube-system;kubernetes;https
```

### 7.4 å¤šç¯å¢ƒé…ç½®ç®¡ç†


```yaml
# å¼€å‘ç¯å¢ƒé…ç½®
scrape_configs:
  - job_name: 'dev-apps'
    scrape_interval: 30s          # å¼€å‘ç¯å¢ƒé¢‘ç‡å¯ä»¥ä½ä¸€äº›
    static_configs:
      - targets: ['dev-app1:8080', 'dev-app2:8080']
        labels:
          env: 'development'
          alert_level: 'low'      # å¼€å‘ç¯å¢ƒå‘Šè­¦çº§åˆ«è¾ƒä½

# ç”Ÿäº§ç¯å¢ƒé…ç½®          
  - job_name: 'prod-apps'
    scrape_interval: 15s          # ç”Ÿäº§ç¯å¢ƒé«˜é¢‘ç›‘æ§
    static_configs:
      - targets: ['prod-app1:8080', 'prod-app2:8080']
        labels:
          env: 'production'
          alert_level: 'critical' # ç”Ÿäº§ç¯å¢ƒå‘Šè­¦çº§åˆ«é«˜
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é…ç½®æ–‡ä»¶ç»“æ„ï¼šglobalå…¨å±€ + scrape_configsæŠ“å–é…ç½®
ğŸ”¸ ä½œä¸šæ¦‚å¿µï¼šjob_nameæ˜¯ç›‘æ§ä»»åŠ¡çš„åŸºæœ¬å•ä½
ğŸ”¸ ç›®æ ‡é…ç½®ï¼šstatic_configså®šä¹‰å…·ä½“ç›‘æ§çš„æœåŠ¡åœ°å€
ğŸ”¸ æ—¶é—´å‚æ•°ï¼šscrape_intervalæ§åˆ¶ç›‘æ§é¢‘ç‡
ğŸ”¸ æ ‡ç­¾ç³»ç»Ÿï¼šlabelsä¸ºç›‘æ§æ•°æ®åˆ†ç±»å’Œè¿‡æ»¤
ğŸ”¸ å®‰å…¨è®¤è¯ï¼šbasic_authã€bearer_tokenã€tls_config
```

### 8.2 å…³é”®é…ç½®åŸåˆ™


**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**ï¼š
```
ç›‘æ§é¢‘ç‡è®¾ç½®ï¼š
- å…³é”®æœåŠ¡ï¼š10-15ç§’
- æ™®é€šæœåŠ¡ï¼š30-60ç§’
- æ‰¹å¤„ç†ä»»åŠ¡ï¼š2-5åˆ†é’Ÿ

æ ·æœ¬æ•°é‡æ§åˆ¶ï¼š
- è®¾ç½®åˆç†çš„sample_limit
- ä½¿ç”¨metric_relabel_configsè¿‡æ»¤æ— ç”¨æŒ‡æ ‡
- é¿å…é«˜åŸºæ•°æ ‡ç­¾
```

**ğŸ”¹ å®‰å…¨é…ç½®åŸåˆ™**ï¼š
```
è®¤è¯ä¿¡æ¯ç®¡ç†ï¼š
- ä½¿ç”¨password_fileè€Œéæ˜æ–‡å¯†ç 
- Tokenå’Œè¯ä¹¦æ–‡ä»¶è®¾ç½®ä¸¥æ ¼æƒé™
- å®šæœŸè½®æ¢è®¤è¯å‡­æ®

ç½‘ç»œå®‰å…¨ï¼š
- ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨HTTPS
- åˆç†é…ç½®TLSè¯ä¹¦éªŒè¯
- ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
```

**ğŸ”¹ æ ‡ç­¾ç®¡ç†åŸåˆ™**ï¼š
```
æ ‡ç­¾è®¾è®¡ï¼š
- ä½¿ç”¨æè¿°æ€§çš„æ ‡ç­¾åç§°
- é¿å…é«˜åŸºæ•°æ ‡ç­¾ï¼ˆå¦‚ç”¨æˆ·IDï¼‰
- åˆç†ä½¿ç”¨relabel_configsä¼˜åŒ–æ ‡ç­¾
- ä¿æŒæ ‡ç­¾å‘½åçš„ä¸€è‡´æ€§
```

### 8.3 å¸¸è§é—®é¢˜è§£å†³


**â“ é…ç½®ä¸ç”Ÿæ•ˆ**ï¼š
- æ£€æŸ¥YAMLè¯­æ³•æ˜¯å¦æ­£ç¡®
- éªŒè¯é…ç½®æ–‡ä»¶æƒé™å’Œè·¯å¾„
- æŸ¥çœ‹Prometheusæ—¥å¿—é”™è¯¯ä¿¡æ¯
- ä½¿ç”¨`promtool check config`éªŒè¯é…ç½®

**â“ æŠ“å–å¤±è´¥**ï¼š
- ç¡®è®¤ç›®æ ‡æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œç«¯å£å¼€æ”¾
- éªŒè¯è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®
- ç¡®è®¤metrics_pathè·¯å¾„æ˜¯å¦å­˜åœ¨

**â“ æ€§èƒ½é—®é¢˜**ï¼š
- è°ƒæ•´scrape_intervalå‡å°‘æŠ“å–é¢‘ç‡
- è®¾ç½®sample_limité™åˆ¶æŒ‡æ ‡æ•°é‡
- ä½¿ç”¨relabel_configsè¿‡æ»¤ä¸éœ€è¦çš„æŒ‡æ ‡
- ä¼˜åŒ–targetæ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ é…ç½®ç®¡ç†**ï¼š
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®æ–‡ä»¶
- ä¸ºä¸åŒç¯å¢ƒç»´æŠ¤ç‹¬ç«‹é…ç½®
- å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
- å»ºç«‹é…ç½®å˜æ›´å®¡æ ¸æµç¨‹

**ğŸ”§ ç›‘æ§ç­–ç•¥**ï¼š
- æ ¹æ®æœåŠ¡é‡è¦æ€§è®¾ç½®ä¸åŒç›‘æ§é¢‘ç‡
- åˆç†è§„åˆ’job_nameå‘½åè§„èŒƒ
- ä½¿ç”¨æ ‡ç­¾è¿›è¡ŒæœåŠ¡åˆ†ç±»ç®¡ç†
- å»ºç«‹ç›‘æ§è¦†ç›–ç‡æ£€æŸ¥æœºåˆ¶

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å…¨å±€è®¾ç½®å®šåŸºè°ƒï¼Œä½œä¸šé…ç½®æ˜¯é‡ç‚¹
- ç›®æ ‡åœ°å€è¦å‡†ç¡®ï¼Œè®¤è¯å®‰å…¨ä¸èƒ½å¿˜
- æ ‡ç­¾è§„åˆ’è¦åˆç†ï¼Œæ€§èƒ½ä¼˜åŒ–éœ€è€ƒé‡
- é…ç½®æ£€æŸ¥è¦ä»”ç»†ï¼Œæ—¥å¿—æ’é”™æ˜¯å…³é”®