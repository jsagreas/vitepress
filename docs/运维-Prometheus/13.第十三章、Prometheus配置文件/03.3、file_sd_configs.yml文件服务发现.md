---
title: 3ã€file_sd_configs.ymlæ–‡ä»¶æœåŠ¡å‘ç°
---
## ğŸ“š ç›®å½•

1. [æ–‡ä»¶æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ](#1-æ–‡ä»¶æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ)
2. [file_sd_configsé…ç½®ç»“æ„](#2-file_sd_configsé…ç½®ç»“æ„)
3. [targetsç›®æ ‡åˆ—è¡¨é…ç½®](#3-targetsç›®æ ‡åˆ—è¡¨é…ç½®)
4. [labelsæ ‡ç­¾ç³»ç»Ÿè¯¦è§£](#4-labelsæ ‡ç­¾ç³»ç»Ÿè¯¦è§£)
5. [å…ƒæ•°æ®æ ‡ç­¾ä¸åœ°å€æ˜ å°„](#5-å…ƒæ•°æ®æ ‡ç­¾ä¸åœ°å€æ˜ å°„)
6. [åŠ¨æ€é…ç½®ä¸çƒ­æ›´æ–°æœºåˆ¶](#6-åŠ¨æ€é…ç½®ä¸çƒ­æ›´æ–°æœºåˆ¶)
7. [å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ](#7-å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ–‡ä»¶æœåŠ¡å‘ç°åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ–‡ä»¶æœåŠ¡å‘ç°


**ç®€å•ç†è§£**ï¼šå°±åƒé€šè®¯å½•ä¸€æ ·ï¼ŒPrometheuséœ€è¦çŸ¥é“å»å“ªé‡Œæ”¶é›†ç›‘æ§æ•°æ®

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨åœ¨é…ç½®æ–‡ä»¶ä¸­å†™æ­»æ¯ä¸ªç›®æ ‡åœ°å€
æ–‡ä»¶æœåŠ¡å‘ç°ï¼šæŠŠç›®æ ‡ä¿¡æ¯å†™åœ¨ç‹¬ç«‹çš„æ–‡ä»¶ä¸­ï¼ŒPrometheusè‡ªåŠ¨è¯»å–

æ¯”å¦‚ï¼š
æ‰‹åŠ¨é…ç½®ï¼šç›´æ¥åœ¨prometheus.ymlä¸­å†™ "192.168.1.10:9090"
æ–‡ä»¶å‘ç°ï¼šåˆ›å»ºtargets.ymlæ–‡ä»¶ï¼Œå†™å…¥ç›®æ ‡ä¿¡æ¯ï¼ŒPrometheusè‡ªåŠ¨åŠ è½½
```

**ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶æœåŠ¡å‘ç°**ï¼š
- ğŸ”„ **åŠ¨æ€ç®¡ç†**ï¼šæœåŠ¡å™¨å¢å‡ä¸ç”¨é‡å¯Prometheus
- ğŸ“ **é…ç½®åˆ†ç¦»**ï¼šç›‘æ§ç›®æ ‡å•ç‹¬ç®¡ç†ï¼Œä¸»é…ç½®æ–‡ä»¶æ›´æ¸…çˆ½
- ğŸš€ **è‡ªåŠ¨åŒ–**ï¼šå¯ä»¥ç”¨è„šæœ¬è‡ªåŠ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶
- ğŸ‘¥ **å›¢é˜Ÿåä½œ**ï¼šä¸åŒå›¢é˜Ÿç®¡ç†å„è‡ªçš„ç›‘æ§ç›®æ ‡

### 1.2 æ–‡ä»¶æœåŠ¡å‘ç°çš„å·¥ä½œåŸç†


**å·¥ä½œæµç¨‹å›¾ç¤º**ï¼š
```
Prometheusä¸»é…ç½®
        â†“
file_sd_configsæŒ‡å‘ç›®æ ‡æ–‡ä»¶
        â†“
è¯»å– targets.yml ç­‰æ–‡ä»¶
        â†“
è§£æ targets å’Œ labels
        â†“
å¼€å§‹ç›‘æ§è¿™äº›ç›®æ ‡
        â†“
æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½
```

**ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼š
- Prometheusä¼š**å®šæœŸæ£€æŸ¥**ç›®æ ‡æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
- æ–‡ä»¶å†…å®¹æ”¹å˜æ—¶ï¼Œ**è‡ªåŠ¨æ›´æ–°**ç›‘æ§ç›®æ ‡åˆ—è¡¨
- æ— éœ€é‡å¯PrometheusæœåŠ¡ï¼Œå®ç°**çƒ­æ›´æ–°**

---

## 2. ğŸ“‹ file_sd_configsé…ç½®ç»“æ„


### 2.1 åŸºæœ¬é…ç½®è¯­æ³•


**ä¸»é…ç½®æ–‡ä»¶ä¸­çš„å£°æ˜**ï¼š
```yaml
# prometheus.yml ä¸»é…ç½®æ–‡ä»¶
scrape_configs:
  - job_name: 'web-servers'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/web-servers.yml'
          - '/etc/prometheus/targets/web-*.yml'  # æ”¯æŒé€šé…ç¬¦
        refresh_interval: 30s  # æ£€æŸ¥æ–‡ä»¶å˜åŒ–çš„é—´éš”
```

**ğŸ” é…ç½®é¡¹è¯¦è§£**ï¼š

| é…ç½®é¡¹ | å«ä¹‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `files` | ç›®æ ‡æ–‡ä»¶è·¯å¾„åˆ—è¡¨ | å¿…å¡« | å¯ä»¥ä½¿ç”¨é€šé…ç¬¦ `*` `?` |
| `refresh_interval` | æ–‡ä»¶æ£€æŸ¥é—´éš” | 5m | å¤šä¹…æ£€æŸ¥ä¸€æ¬¡æ–‡ä»¶å˜åŒ– |

### 2.2 ç›®æ ‡æ–‡ä»¶çš„åŸºæœ¬ç»“æ„


**ç›®æ ‡æ–‡ä»¶æ ¼å¼ç¤ºä¾‹**ï¼š
```yaml
# web-servers.yml ç›®æ ‡æ–‡ä»¶
- targets:
    - '192.168.1.10:9090'
    - '192.168.1.11:9090'
  labels:
    env: 'production'
    team: 'backend'
    
- targets:
    - '192.168.2.10:9090'
    - '192.168.2.11:9090'
  labels:
    env: 'staging'
    team: 'backend'
```

**ğŸ“Š ç»“æ„è¯´æ˜**ï¼š
```
ç›®æ ‡æ–‡ä»¶ = ç›®æ ‡ç»„åˆ—è¡¨
æ¯ä¸ªç›®æ ‡ç»„åŒ…å«ï¼š
â”œâ”€â”€ targets: ç›‘æ§ç›®æ ‡åœ°å€åˆ—è¡¨
â””â”€â”€ labels: ç»™è¿™ç»„ç›®æ ‡æ·»åŠ çš„æ ‡ç­¾
```

---

## 3. ğŸ¯ targetsç›®æ ‡åˆ—è¡¨é…ç½®


### 3.1 ç›®æ ‡åœ°å€æ ¼å¼è¯¦è§£


**æ ‡å‡†æ ¼å¼**ï¼š`ä¸»æœº:ç«¯å£`

```yaml
targets:
  - '192.168.1.10:9090'     # IPåœ°å€:ç«¯å£
  - 'server01:9090'         # ä¸»æœºå:ç«¯å£
  - 'api.example.com:8080'  # åŸŸå:ç«¯å£
  - '[::1]:9090'            # IPv6åœ°å€:ç«¯å£
```

**âš ï¸ å¸¸è§é”™è¯¯ä¸æ­£ç¡®å†™æ³•**ï¼š
```yaml
# âŒ é”™è¯¯å†™æ³•
targets:
  - 'http://192.168.1.10:9090'  # ä¸è¦åŠ åè®®
  - '192.168.1.10'              # å¿…é¡»æŒ‡å®šç«¯å£
  
# âœ… æ­£ç¡®å†™æ³•  
targets:
  - '192.168.1.10:9090'
  - 'server01:9100'
```

### 3.2 ç›®æ ‡åˆ†ç»„ç­–ç•¥


**æŒ‰ç¯å¢ƒåˆ†ç»„**ï¼š
```yaml
# ç”Ÿäº§ç¯å¢ƒç›®æ ‡
- targets:
    - 'prod-web-01:9090'
    - 'prod-web-02:9090'
  labels:
    env: 'production'
    service: 'web'

# æµ‹è¯•ç¯å¢ƒç›®æ ‡    
- targets:
    - 'test-web-01:9090'
  labels:
    env: 'testing'
    service: 'web'
```

**æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„**ï¼š
```yaml
# WebæœåŠ¡å™¨ç»„
- targets:
    - 'web-01:9090'
    - 'web-02:9090'
  labels:
    service_type: 'web'
    port_name: 'metrics'

# æ•°æ®åº“æœåŠ¡å™¨ç»„
- targets:
    - 'db-01:9104'
    - 'db-02:9104'
  labels:
    service_type: 'database'
    db_type: 'mysql'
```

### 3.3 æ‰¹é‡ç›®æ ‡é…ç½®æŠ€å·§


**ç½‘æ®µæ‰¹é‡é…ç½®**ï¼š
```yaml
# ä¸ºæ•´ä¸ªç½‘æ®µé…ç½®ç›‘æ§
- targets:
    - '10.0.1.10:9100'
    - '10.0.1.11:9100'
    - '10.0.1.12:9100'
    - '10.0.1.13:9100'
    - '10.0.1.14:9100'
  labels:
    datacenter: 'dc1'
    rack: 'rack-a'
    exporter: 'node_exporter'
```

**ğŸ› ï¸ è‡ªåŠ¨åŒ–ç”Ÿæˆè„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# ç”Ÿæˆç›®æ ‡é…ç½®çš„ç®€å•è„šæœ¬
echo "- targets:" > targets.yml
for i in {10..20}; do
    echo "    - '192.168.1.$i:9100'" >> targets.yml
done
echo "  labels:" >> targets.yml
echo "    env: 'production'" >> targets.yml
```

---

## 4. ğŸ·ï¸ labelsæ ‡ç­¾ç³»ç»Ÿè¯¦è§£


### 4.1 æ ‡ç­¾çš„ä½œç”¨ä¸é‡è¦æ€§


**æ ‡ç­¾å°±åƒç»™ç›‘æ§ç›®æ ‡è´´æ ‡ç­¾**ï¼š
```
æƒ³è±¡ä½ åœ¨ç®¡ç†ä¸€ä¸ªå¤§å‹è¶…å¸‚ï¼š
- å•†å“éœ€è¦åˆ†ç±»æ ‡ç­¾ï¼šé£Ÿå“ã€æœè£…ã€ç”µå™¨
- ä»·æ ¼æ ‡ç­¾ï¼šä¾¿å®œã€ä¸­ç­‰ã€æ˜‚è´µ  
- äº§åœ°æ ‡ç­¾ï¼šå›½äº§ã€è¿›å£

Prometheusçš„æ ‡ç­¾ç³»ç»Ÿä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼š
- ç¯å¢ƒæ ‡ç­¾ï¼šproductionã€stagingã€development
- æœåŠ¡æ ‡ç­¾ï¼šwebã€databaseã€cache
- å›¢é˜Ÿæ ‡ç­¾ï¼šbackendã€frontendã€ops
```

**ğŸ“Š æ ‡ç­¾çš„æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ” **æ•°æ®ç­›é€‰**ï¼š`up{env="production"}` åªçœ‹ç”Ÿäº§ç¯å¢ƒ
- ğŸ“ˆ **åˆ†ç»„èšåˆ**ï¼šæŒ‰æœåŠ¡ç±»å‹ç»Ÿè®¡æŒ‡æ ‡
- ğŸš¨ **å‘Šè­¦è§„åˆ™**ï¼šä¸åŒç¯å¢ƒè®¾ç½®ä¸åŒçš„å‘Šè­¦é˜ˆå€¼
- ğŸ“‹ **Dashboardå±•ç¤º**ï¼šæŒ‰æ ‡ç­¾åˆ†ç»„æ˜¾ç¤ºå›¾è¡¨

### 4.2 æ ‡ç­¾é…ç½®è¯­æ³•


**åŸºæœ¬æ ‡ç­¾é…ç½®**ï¼š
```yaml
- targets:
    - 'web-01:9090'
  labels:
    env: 'production'      # ç¯å¢ƒæ ‡ç­¾
    service: 'web'         # æœåŠ¡ç±»å‹
    team: 'backend'        # è´Ÿè´£å›¢é˜Ÿ
    version: 'v1.2.3'      # ç‰ˆæœ¬ä¿¡æ¯
    datacenter: 'us-east'  # æ•°æ®ä¸­å¿ƒ
```

**ğŸ“‹ å¸¸ç”¨æ ‡ç­¾ç±»åˆ«**ï¼š

| æ ‡ç­¾ç±»å‹ | ç¤ºä¾‹ | ç”¨é€” |
|----------|------|------|
| **ç¯å¢ƒæ ‡ç­¾** | `env: production` | åŒºåˆ†ç”Ÿäº§/æµ‹è¯•ç¯å¢ƒ |
| **æœåŠ¡æ ‡ç­¾** | `service: web` | æ ‡è¯†æœåŠ¡ç±»å‹ |
| **åœ°ç†æ ‡ç­¾** | `region: us-east` | æ ‡è¯†åœ°ç†ä½ç½® |
| **å›¢é˜Ÿæ ‡ç­¾** | `team: backend` | æ ‡è¯†è´Ÿè´£å›¢é˜Ÿ |
| **ç‰ˆæœ¬æ ‡ç­¾** | `version: v1.0.0` | æ ‡è¯†è½¯ä»¶ç‰ˆæœ¬ |

### 4.3 æ ‡ç­¾ç»§æ‰¿ä¸è¦†ç›–è§„åˆ™


**æ ‡ç­¾ç»§æ‰¿æœºåˆ¶**ï¼š
```yaml
# prometheus.yml ä¸­çš„ job çº§æ ‡ç­¾
scrape_configs:
  - job_name: 'web-servers'  # è‡ªåŠ¨æ·»åŠ  job="web-servers" æ ‡ç­¾
    file_sd_configs:
      - files: ['web-targets.yml']
    scrape_interval: 15s      # å¯¹æ‰€æœ‰ç›®æ ‡ç”Ÿæ•ˆ

# web-targets.yml ä¸­çš„ç›®æ ‡çº§æ ‡ç­¾    
- targets: ['web-01:9090']
  labels:
    env: 'production'        # ç›®æ ‡ç‰¹æœ‰æ ‡ç­¾
```

**æœ€ç»ˆæ ‡ç­¾ç»“æœ**ï¼š
```
ç›®æ ‡ web-01:9090 çš„å®Œæ•´æ ‡ç­¾ï¼š
- job="web-servers"         # æ¥è‡ªjob_name
- instance="web-01:9090"    # è‡ªåŠ¨ç”Ÿæˆ
- env="production"          # æ¥è‡ªç›®æ ‡æ–‡ä»¶
```

**âš ï¸ æ ‡ç­¾å†²çªå¤„ç†**ï¼š
```yaml
# å¦‚æœæ ‡ç­¾åé‡å¤ï¼Œtargetçº§åˆ«çš„æ ‡ç­¾ä¼šè¦†ç›–jobçº§åˆ«çš„æ ‡ç­¾
scrape_configs:
  - job_name: 'servers'
    scrape_interval: 30s
    external_labels:
      env: 'default'         # jobçº§åˆ«æ ‡ç­¾
      
# targetsæ–‡ä»¶ä¸­
- targets: ['server-01:9090']
  labels:
    env: 'production'        # ä¼šè¦†ç›–jobçº§åˆ«çš„'default'
```

---

## 5. ğŸ”§ å…ƒæ•°æ®æ ‡ç­¾ä¸åœ°å€æ˜ å°„


### 5.1 __address__ç›®æ ‡åœ°å€è¯¦è§£


**__address__çš„æ ¸å¿ƒä½œç”¨**ï¼š
```
__address__ æ˜¯Prometheuså†…éƒ¨ä½¿ç”¨çš„ç‰¹æ®Šæ ‡ç­¾
ä½œç”¨ï¼šå‘Šè¯‰Prometheuså®é™…å»å“ªä¸ªåœ°å€é‡‡é›†æ•°æ®
```

**é»˜è®¤åœ°å€æ˜ å°„**ï¼š
```yaml
# ç›®æ ‡æ–‡ä»¶ä¸­
- targets:
    - 'web-01:9090'

# Prometheuså†…éƒ¨å¤„ç†å
__address__: 'web-01:9090'
instance: 'web-01:9090'      # é»˜è®¤å¤åˆ¶__address__çš„å€¼
```

**ğŸ”„ è‡ªå®šä¹‰åœ°å€æ˜ å°„**ï¼š
```yaml
# é«˜çº§ç”¨æ³•ï¼šåœ°å€å’Œå±•ç¤ºåç§°åˆ†ç¦»
- targets:
    - 'web-01:9090'
  labels:
    __address__: '192.168.1.10:9090'  # å®é™…é‡‡é›†åœ°å€
    instance: 'web-server-01'         # æ˜¾ç¤ºåç§°
    alias: 'main-web-server'          # åˆ«å
```

### 5.2 __meta_*å…ƒæ•°æ®æ ‡ç­¾ç³»ç»Ÿ


**å…ƒæ•°æ®æ ‡ç­¾çš„æ¦‚å¿µ**ï¼š
```
__meta_* æ ‡ç­¾æ˜¯Prometheuså†…éƒ¨ä½¿ç”¨çš„ä¸´æ—¶æ ‡ç­¾
ç‰¹ç‚¹ï¼š
- ä»¥__meta_å¼€å¤´
- ç”¨äºæ ‡ç­¾é‡å†™å’Œæ¡ä»¶åˆ¤æ–­
- ä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆçš„æŒ‡æ ‡ä¸­
- ä¸»è¦ç”¨äºé…ç½®å¤„ç†é˜¶æ®µ
```

**æ–‡ä»¶æœåŠ¡å‘ç°çš„å…ƒæ•°æ®æ ‡ç­¾**ï¼š
```yaml
# Prometheusè‡ªåŠ¨ä¸ºæ¯ä¸ªç›®æ ‡æ·»åŠ å…ƒæ•°æ®
__meta_filepath: '/etc/prometheus/targets/web.yml'  # ç›®æ ‡æ–‡ä»¶è·¯å¾„
__meta_refresh_interval: '30s'                      # åˆ·æ–°é—´éš”
```

**ğŸ› ï¸ å…ƒæ•°æ®æ ‡ç­¾çš„å®é™…åº”ç”¨**ï¼š
```yaml
# å¯ä»¥åŸºäºæ–‡ä»¶è·¯å¾„è®¾ç½®ä¸åŒçš„æ ‡ç­¾
relabel_configs:
  - source_labels: [__meta_filepath]
    regex: '.*/([^/]+)\.yml'
    target_label: config_file
    replacement: '${1}'
```

### 5.3 æ ‡ç­¾é‡å†™ä¸è½¬æ¢


**æ ‡ç­¾é‡å†™çš„å¸¸ç”¨åœºæ™¯**ï¼š
```yaml
# ä»ç›®æ ‡åœ°å€ä¸­æå–ä¸»æœºå
relabel_configs:
  - source_labels: [__address__]
    regex: '([^:]+):.*'           # æ­£åˆ™æå–ä¸»æœºåéƒ¨åˆ†
    target_label: hostname        # è®¾ç½®æ–°æ ‡ç­¾
    replacement: '${1}'

  - source_labels: [__address__]  
    regex: '.*:([0-9]+)'          # æå–ç«¯å£å·
    target_label: port
    replacement: '${1}'
```

**å®é™…è½¬æ¢ç¤ºä¾‹**ï¼š
```
åŸå§‹ç›®æ ‡ï¼šweb-server-01:9090
è½¬æ¢åæ ‡ç­¾ï¼š
- hostname: "web-server-01"
- port: "9090"
- instance: "web-server-01:9090"
```

---

## 6. ğŸ”„ åŠ¨æ€é…ç½®ä¸çƒ­æ›´æ–°æœºåˆ¶


### 6.1 æ–‡ä»¶ç›‘æ§æœºåˆ¶è¯¦è§£


**Prometheuså¦‚ä½•ç›‘æ§æ–‡ä»¶å˜åŒ–**ï¼š
```
ç›‘æ§åŸç†ï¼š
1. Prometheusæ¯éš”refresh_intervalæ£€æŸ¥ç›®æ ‡æ–‡ä»¶
2. æ¯”è¾ƒæ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´æˆ³
3. å¦‚æœå‘ç°å˜åŒ–ï¼Œé‡æ–°è§£ææ–‡ä»¶å†…å®¹
4. æ›´æ–°å†…å­˜ä¸­çš„ç›®æ ‡åˆ—è¡¨
5. å¼€å§‹ç›‘æ§æ–°ç›®æ ‡ï¼Œåœæ­¢ç›‘æ§å·²åˆ é™¤çš„ç›®æ ‡
```

**ğŸ“Š ç›‘æ§æµç¨‹å›¾ç¤º**ï¼š
```
å®šæ—¶å™¨è§¦å‘(æ¯30ç§’)
       â†“
æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
       â†“
æ–‡ä»¶æ˜¯å¦å˜åŒ–ï¼Ÿ â”€â”€NOâ”€â”€> ç»§ç»­ç­‰å¾…
       â†“ YES
é‡æ–°è§£ææ–‡ä»¶å†…å®¹
       â†“
å¯¹æ¯”ç›®æ ‡åˆ—è¡¨å·®å¼‚
       â†“
æ›´æ–°ç›‘æ§ç›®æ ‡
       â†“
è®°å½•æ—¥å¿—å¹¶ç»§ç»­ç›‘æ§
```

### 6.2 é…ç½®çƒ­æ›´æ–°å®è·µ


**é…ç½®refresh_intervalçš„è€ƒè™‘å› ç´ **ï¼š
```yaml
file_sd_configs:
  - files: ['targets.yml']
    refresh_interval: 30s    # 30ç§’æ£€æŸ¥ä¸€æ¬¡

# é€‰æ‹©å»ºè®®ï¼š
# 5-30ç§’ï¼šå¯¹å®æ—¶æ€§è¦æ±‚é«˜çš„ç¯å¢ƒ
# 1-5åˆ†é’Ÿï¼šä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒ
# 5-15åˆ†é’Ÿï¼šç¨³å®šç¯å¢ƒï¼Œç›®æ ‡å˜åŒ–ä¸é¢‘ç¹
```

**âš¡ æ€§èƒ½å½±å“åˆ†æ**ï¼š

| åˆ·æ–°é—´éš” | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **5-10ç§’** | å®æ—¶æ€§å¥½ | CPUå¼€é”€å¤§ | å¼€å‘æµ‹è¯•ç¯å¢ƒ |
| **30ç§’-1åˆ†é’Ÿ** | å¹³è¡¡æ€§å¥½ | å»¶è¿Ÿå¯æ¥å— | ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒ |
| **5-15åˆ†é’Ÿ** | å¼€é”€å° | å“åº”è¾ƒæ…¢ | ç¨³å®šç”Ÿäº§ç¯å¢ƒ |

### 6.3 æ‰¹é‡æ›´æ–°ç­–ç•¥


**å®‰å…¨çš„æ‰¹é‡æ›´æ–°æµç¨‹**ï¼š
```bash
#!/bin/bash
# å®‰å…¨æ›´æ–°ç›®æ ‡æ–‡ä»¶çš„è„šæœ¬

# 1. å¤‡ä»½åŸæ–‡ä»¶
cp /etc/prometheus/targets/web.yml /etc/prometheus/targets/web.yml.backup

# 2. ç”Ÿæˆæ–°çš„ç›®æ ‡æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
generate_targets.sh > /tmp/web.yml.new

# 3. éªŒè¯æ–°æ–‡ä»¶æ ¼å¼æ­£ç¡®
promtool check config /tmp/web.yml.new
if [ $? -eq 0 ]; then
    # 4. åŸå­æ€§æ›¿æ¢æ–‡ä»¶
    mv /tmp/web.yml.new /etc/prometheus/targets/web.yml
    echo "ç›®æ ‡æ–‡ä»¶æ›´æ–°æˆåŠŸ"
else
    echo "æ–°æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ›´æ–°å–æ¶ˆ"
    exit 1
fi
```

**ğŸš¨ æ›´æ–°æ³¨æ„äº‹é¡¹**ï¼š
- âœ… **åŸå­æ“ä½œ**ï¼šä½¿ç”¨mvå‘½ä»¤æ›¿æ¢ï¼Œé¿å…è¯»åˆ°åŠä¸ªæ–‡ä»¶
- âœ… **æ ¼å¼éªŒè¯**ï¼šæ›´æ–°å‰éªŒè¯YAMLæ ¼å¼æ­£ç¡®
- âœ… **å¤‡ä»½ç­–ç•¥**ï¼šä¿ç•™å†å²ç‰ˆæœ¬ä»¥ä¾¿å›æ»š
- âœ… **ç›‘æ§æ—¥å¿—**ï¼šå…³æ³¨Prometheusæ—¥å¿—ä¸­çš„åŠ è½½ä¿¡æ¯

---

## 7. ğŸš€ å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ


### 7.1 ä¼ä¸šçº§éƒ¨ç½²æ¶æ„


**åˆ†å±‚é…ç½®ç®¡ç†**ï¼š
```
é…ç½®æ–‡ä»¶ç»“æ„ï¼š
/etc/prometheus/
â”œâ”€â”€ prometheus.yml              # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ targets/                    # ç›®æ ‡æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ production/            # ç”Ÿäº§ç¯å¢ƒç›®æ ‡
â”‚   â”‚   â”œâ”€â”€ web-servers.yml
â”‚   â”‚   â”œâ”€â”€ databases.yml
â”‚   â”‚   â””â”€â”€ cache-servers.yml
â”‚   â”œâ”€â”€ staging/               # æµ‹è¯•ç¯å¢ƒç›®æ ‡
â”‚   â”‚   â”œâ”€â”€ web-servers.yml
â”‚   â”‚   â””â”€â”€ databases.yml
â”‚   â””â”€â”€ development/           # å¼€å‘ç¯å¢ƒç›®æ ‡
â”‚       â””â”€â”€ all-services.yml
```

**ä¸»é…ç½®æ–‡ä»¶è®¾ç½®**ï¼š
```yaml
# prometheus.yml
scrape_configs:
  # ç”Ÿäº§ç¯å¢ƒé…ç½®
  - job_name: 'prod-web'
    scrape_interval: 15s
    file_sd_configs:
      - files: ['/etc/prometheus/targets/production/web-*.yml']
        refresh_interval: 1m
        
  - job_name: 'prod-db'
    scrape_interval: 30s
    file_sd_configs:
      - files: ['/etc/prometheus/targets/production/db-*.yml']
        refresh_interval: 2m
        
  # æµ‹è¯•ç¯å¢ƒé…ç½®
  - job_name: 'staging-all'
    scrape_interval: 30s
    file_sd_configs:
      - files: ['/etc/prometheus/targets/staging/*.yml']
        refresh_interval: 30s
```

### 7.2 è‡ªåŠ¨åŒ–ç›®æ ‡ç®¡ç†


**åŸºäºå®¹å™¨ç¼–æ’çš„è‡ªåŠ¨å‘ç°**ï¼š
```bash
#!/bin/bash
# Kubernetes podè‡ªåŠ¨å‘ç°è„šæœ¬ç¤ºä¾‹

# è·å–æ‰€æœ‰è¿è¡Œä¸­çš„pod
kubectl get pods -o json | jq -r '
.items[] | 
select(.status.phase == "Running") | 
select(.metadata.annotations."prometheus.io/scrape" == "true") |
{
  targets: [(.status.podIP + ":" + .metadata.annotations."prometheus.io/port")],
  labels: {
    env: .metadata.namespace,
    app: .metadata.labels.app,
    version: .metadata.labels.version
  }
}' | yq -P > /etc/prometheus/targets/k8s-pods.yml
```

**æœåŠ¡æ³¨å†Œä¸­å¿ƒé›†æˆ**ï¼š
```python
# ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒç”ŸæˆPrometheusç›®æ ‡
import yaml
import consul

def generate_prometheus_targets():
    c = consul.Consul()
    services = c.health.service('web-service', passing=True)[1]
    
    targets = []
    for service in services:
        target = {
            'targets': [f"{service['Service']['Address']}:{service['Service']['Port']}"],
            'labels': {
                'service': service['Service']['Service'],
                'datacenter': service['Node']['Datacenter'],
                'node': service['Node']['Node']
            }
        }
        targets.append(target)
    
    with open('/etc/prometheus/targets/consul-services.yml', 'w') as f:
        yaml.dump(targets, f)

# å®šæ—¶æ‰§è¡Œ
if __name__ == "__main__":
    generate_prometheus_targets()
```

### 7.3 ç¯å¢ƒéš”ç¦»ä¸æ ‡ç­¾ç­–ç•¥


**å¤šç¯å¢ƒæ ‡ç­¾è§„èŒƒ**ï¼š
```yaml
# ç”Ÿäº§ç¯å¢ƒç›®æ ‡æ–‡ä»¶
- targets:
    - 'prod-web-01:9090'
    - 'prod-web-02:9090'
  labels:
    env: 'production'          # ç¯å¢ƒæ ‡è¯†
    tier: 'frontend'           # åº”ç”¨å±‚çº§
    region: 'us-east-1'        # åœ°ç†åŒºåŸŸ
    team: 'platform'           # è´Ÿè´£å›¢é˜Ÿ
    cost_center: 'engineering' # æˆæœ¬ä¸­å¿ƒ
    sla: 'high'               # æœåŠ¡ç­‰çº§
    backup: 'enabled'         # å¤‡ä»½ç­–ç•¥

# å¼€å‘ç¯å¢ƒç›®æ ‡æ–‡ä»¶    
- targets:
    - 'dev-web-01:9090'
  labels:
    env: 'development'
    tier: 'frontend'
    region: 'local'
    team: 'platform'
    cost_center: 'engineering'
    sla: 'low'
    backup: 'disabled'
```

**ğŸ¯ æ ‡ç­¾è®¾è®¡åŸåˆ™**ï¼š
- **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç›¸åŒçš„æ ‡ç­¾é”®
- **å±‚æ¬¡æ€§**ï¼šä»ç²—ç²’åº¦åˆ°ç»†ç²’åº¦çš„æ ‡ç­¾ç»„ç»‡
- **å¯æŸ¥è¯¢æ€§**ï¼šè®¾è®¡ä¾¿äºPromQLæŸ¥è¯¢çš„æ ‡ç­¾ç»“æ„
- **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™æ ‡ç­¾ç©ºé—´ç”¨äºæœªæ¥æ‰©å±•

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ–‡ä»¶æœåŠ¡å‘ç°æœ¬è´¨ï¼šå°†ç›‘æ§ç›®æ ‡é…ç½®ä»ä¸»æ–‡ä»¶ä¸­åˆ†ç¦»å‡ºæ¥
ğŸ”¸ targetsç›®æ ‡åˆ—è¡¨ï¼šå®šä¹‰Prometheusè¦ç›‘æ§çš„å…·ä½“åœ°å€
ğŸ”¸ labelsæ ‡ç­¾ç³»ç»Ÿï¼šä¸ºç›‘æ§ç›®æ ‡æ·»åŠ å…ƒæ•°æ®ï¼Œç”¨äºåˆ†ç±»å’ŒæŸ¥è¯¢
ğŸ”¸ çƒ­æ›´æ–°æœºåˆ¶ï¼šæ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ï¼Œæ— éœ€é‡å¯æœåŠ¡
ğŸ”¸ __address__æ˜ å°„ï¼šæ§åˆ¶Prometheuså®é™…è®¿é—®çš„åœ°å€
ğŸ”¸ æ‰¹é‡é…ç½®ç®¡ç†ï¼šé€šè¿‡æ–‡ä»¶ç»„ç»‡å’Œè„šæœ¬å®ç°å¤§è§„æ¨¡ç›®æ ‡ç®¡ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä½¿ç”¨æ–‡ä»¶æœåŠ¡å‘ç°**ï¼š
```
è§£å†³é—®é¢˜ï¼š
- é™æ€é…ç½®ç»´æŠ¤å›°éš¾
- æœåŠ¡æ‰©ç¼©å®¹éœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®
- å›¢é˜Ÿåä½œæ—¶é…ç½®å†²çª

æä¾›ä»·å€¼ï¼š
- é…ç½®ä¸æœåŠ¡åˆ†ç¦»
- æ”¯æŒåŠ¨æ€æ›´æ–°
- ä¾¿äºè‡ªåŠ¨åŒ–ç®¡ç†
- æé«˜è¿ç»´æ•ˆç‡
```

**ğŸ”¹ æ ‡ç­¾è®¾è®¡çš„é‡è¦æ€§**ï¼š
```
åˆç†çš„æ ‡ç­¾è®¾è®¡èƒ½å¤Ÿï¼š
- å¿«é€Ÿç­›é€‰å’Œå®šä½ç›®æ ‡
- çµæ´»ç»„ç»‡ç›‘æ§æ•°æ®
- æ”¯æŒå¤æ‚çš„æŸ¥è¯¢éœ€æ±‚
- ç®€åŒ–å‘Šè­¦è§„åˆ™é…ç½®
```

**ğŸ”¹ é…ç½®æ–‡ä»¶çš„ç®¡ç†ç­–ç•¥**ï¼š
```
æœ€ä½³å®è·µï¼š
- æŒ‰ç¯å¢ƒåˆ†ç›®å½•ç»„ç»‡
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®å˜æ›´
- å»ºç«‹é…ç½®éªŒè¯å’Œæµ‹è¯•æµç¨‹
- å®ç°é…ç½®çš„è‡ªåŠ¨åŒ–éƒ¨ç½²
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‰æ‹©åˆé€‚çš„åˆ·æ–°é—´éš”**ï¼š
```
è€ƒè™‘å› ç´ ï¼š
- ç›®æ ‡å˜åŒ–é¢‘ç‡ï¼šé¢‘ç¹å˜åŒ–â†’çŸ­é—´éš”
- ç³»ç»Ÿèµ„æºï¼šCPU/IOæ•æ„Ÿâ†’é•¿é—´éš”  
- ç›‘æ§å®æ—¶æ€§è¦æ±‚ï¼šå®æ—¶æ€§é«˜â†’çŸ­é—´éš”
- ç¯å¢ƒç¨³å®šæ€§ï¼šç¨³å®šç¯å¢ƒâ†’é•¿é—´éš”

æ¨èé…ç½®ï¼š
- å¼€å‘ç¯å¢ƒï¼š10-30ç§’
- æµ‹è¯•ç¯å¢ƒï¼š30ç§’-1åˆ†é’Ÿ
- ç”Ÿäº§ç¯å¢ƒï¼š1-5åˆ†é’Ÿ
```

**ğŸ› ï¸ æ–‡ä»¶ç»„ç»‡æœ€ä½³å®è·µ**ï¼š
```
ç›®å½•ç»“æ„å»ºè®®ï¼š
- æŒ‰ç¯å¢ƒåˆ†ç¦»ï¼ˆprod/staging/devï¼‰
- æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„ï¼ˆweb/db/cacheï¼‰
- ä½¿ç”¨ç»Ÿä¸€çš„å‘½åè§„èŒƒ
- ä¿æŒæ–‡ä»¶å¤§å°é€‚ä¸­ï¼ˆå»ºè®®<100ä¸ªç›®æ ‡/æ–‡ä»¶ï¼‰

æ–‡ä»¶å‘½åè§„èŒƒï¼š
- ç¯å¢ƒ-æœåŠ¡ç±»å‹-åºå·.yml
- ä¾‹ï¼šprod-web-01.yml, staging-db-all.yml
```

**ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š
```
é—®é¢˜1ï¼šé…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯
è§£å†³ï¼šä½¿ç”¨promtooléªŒè¯é…ç½®

é—®é¢˜2ï¼šç›®æ ‡æ— æ³•è®¿é—®
è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œç«¯å£å¼€æ”¾

é—®é¢˜3ï¼šæ ‡ç­¾å†²çªæˆ–è¦†ç›–
è§£å†³ï¼šäº†è§£æ ‡ç­¾ç»§æ‰¿è§„åˆ™ï¼Œåˆç†è®¾è®¡æ ‡ç­¾å±‚æ¬¡

é—®é¢˜4ï¼šçƒ­æ›´æ–°ä¸ç”Ÿæ•ˆ
è§£å†³ï¼šæ£€æŸ¥æ–‡ä»¶æƒé™å’Œrefresh_intervalé…ç½®
```

### 8.4 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ”— ç›¸å…³æŠ€æœ¯æ ˆ**ï¼š
- **æœåŠ¡å‘ç°æœºåˆ¶**ï¼šKubernetesã€Consulã€Eurekaé›†æˆ
- **é…ç½®ç®¡ç†**ï¼šAnsibleã€Terraformè‡ªåŠ¨åŒ–éƒ¨ç½²
- **ç›‘æ§å¯è§‚æµ‹æ€§**ï¼šGrafanaã€AlertManagerè”åŠ¨é…ç½®
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDockerã€K8sç¯å¢ƒä¸‹çš„é…ç½®ç®¡ç†

**ğŸ“š æ‰©å±•é˜…è¯»å»ºè®®**ï¼š
- Prometheuså®˜æ–¹æ–‡æ¡£ï¼šConfiguration
- äº‘åŸç”Ÿç›‘æ§æœ€ä½³å®è·µ
- å¤§è§„æ¨¡ç›‘æ§ç³»ç»Ÿæ¶æ„è®¾è®¡
- ç›‘æ§å³ä»£ç (Monitoring as Code)å®è·µ

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ–‡ä»¶å‘ç°è®©é…ç½®åŠ¨æ€åŒ–ï¼Œtargetså®šä¹‰ç›‘æ§ç›®æ ‡
- labelsæ ‡ç­¾æ˜¯æ•°æ®ç»„ç»‡çš„æ ¸å¿ƒï¼Œè®¾è®¡è¦è€ƒè™‘æŸ¥è¯¢éœ€æ±‚
- çƒ­æ›´æ–°æœºåˆ¶æä¾›è¿ç»´ä¾¿åˆ©ï¼Œä½†è¦æ³¨æ„é…ç½®éªŒè¯
- åˆç†çš„æ–‡ä»¶ç»„ç»‡å’Œæ ‡ç­¾è§„èŒƒæ˜¯å¤§è§„æ¨¡éƒ¨ç½²çš„åŸºç¡€