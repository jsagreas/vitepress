---
title: 2、选择器与过滤语法
---
## 📚 目录

1. [PromQL基础概念](#1-PromQL基础概念)
2. [指标选择器详解](#2-指标选择器详解)
3. [标签过滤器语法](#3-标签过滤器语法)
4. [多条件组合查询](#4-多条件组合查询)
5. [实战应用场景](#5-实战应用场景)
6. [优化技巧与最佳实践](#6-优化技巧与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 PromQL基础概念


### 1.1 什么是PromQL

**通俗理解**：想象你有一个巨大的仓库，里面存着各种监控数据，PromQL就像是仓库管理员的"查找语言"，帮你快速找到想要的数据。

```
现实比喻：
仓库货架 → Prometheus数据库
货物标签 → 指标名称和标签
查找条件 → PromQL查询语句
找到的货物 → 查询结果
```

> 💡 **核心理解**  
> PromQL = Prometheus Query Language（Prometheus查询语言）
> 就像SQL用于查询数据库，PromQL专门用于查询时间序列监控数据

### 1.2 时间序列数据模型

**什么是时间序列数据**：简单说就是"带时间戳的数据"，记录某个指标在不同时间点的值。

```
时间序列数据示例：
指标名称: cpu_usage_percent
时间戳       值    标签信息
10:00:00 → 45.2  {server="web1", env="prod"}
10:01:00 → 48.1  {server="web1", env="prod"}
10:02:00 → 52.3  {server="web1", env="prod"}
```

**数据结构组成**：
- **指标名称**（Metric Name）：告诉你这是什么数据，比如`cpu_usage`、`memory_used`
- **标签**（Labels）：详细描述这个数据的属性，比如哪台服务器、哪个环境
- **时间戳**：记录数据产生的时间
- **数值**：具体的监控数值

---

## 2. 🔍 指标选择器详解


### 2.1 基础指标选择

**最简单的查询**：直接写指标名称

```promql
# 查询CPU使用率（所有服务器）
cpu_usage_percent

# 查询内存使用量（所有实例）
memory_used_bytes
```

> 📖 **术语解释**  
> **指标选择器**：就像在图书馆里说"我要找所有关于历史的书"，它会返回所有相关的数据

### 2.2 瞬时向量 vs 区间向量

**瞬时向量**：某个时间点的数据快照
```promql
# 获取当前时刻的CPU使用率
cpu_usage_percent
```

**区间向量**：一段时间内的数据集合
```promql
# 获取过去5分钟的CPU使用率数据
cpu_usage_percent[5m]

# 获取过去1小时的内存使用数据
memory_used_bytes[1h]
```

**时间单位速查表**：
| 单位 | 含义 | 示例 | 说明 |
|------|------|------|------|
| `s` | 秒 | `[30s]` | 过去30秒 |
| `m` | 分钟 | `[5m]` | 过去5分钟 |
| `h` | 小时 | `[2h]` | 过去2小时 |
| `d` | 天 | `[7d]` | 过去7天 |
| `w` | 周 | `[2w]` | 过去2周 |
| `y` | 年 | `[1y]` | 过去1年 |

---

## 3. 🎛️ 标签过滤器语法


### 3.1 精确匹配（=）

**作用**：找到标签值完全相等的数据

```promql
# 查询生产环境的CPU使用率
cpu_usage_percent{env="production"}

# 查询web1服务器的内存使用
memory_used_bytes{server="web1"}

# 查询特定应用的错误率
error_rate{app="user-service"}
```

> 🎯 **实用技巧**  
> 精确匹配最常用，就像在通讯录里搜索确切的姓名

### 3.2 不等匹配（!=）

**作用**：排除某些标签值的数据

```promql
# 查询非测试环境的数据
cpu_usage_percent{env!="test"}

# 排除已停用的服务器
server_status{status!="inactive"}

# 查询非本地环境的数据库连接
db_connections{location!="localhost"}
```

### 3.3 正则匹配（=~）

**作用**：使用正则表达式灵活匹配标签值

```promql
# 查询所有web服务器（web1, web2, web3等）
cpu_usage_percent{server=~"web.*"}

# 查询开发和测试环境
memory_used_bytes{env=~"dev|test"}

# 查询以prod开头的所有环境
network_io{env=~"prod.*"}
```

**常用正则表达式**：
```
.     → 匹配任意单个字符
.*    → 匹配任意长度的字符
^web  → 以"web"开头
api$  → 以"api"结尾
a|b   → 匹配"a"或"b"
[0-9] → 匹配任意数字
```

> ⚠️ **注意事项**  
> 正则匹配比精确匹配慢，不要在高频查询中过度使用

### 3.4 正则排除（!~）

**作用**：排除匹配正则表达式的标签值

```promql
# 排除所有测试相关环境
cpu_usage_percent{env!~".*test.*"}

# 排除临时服务器
server_load{server!~"temp.*"}

# 排除内部IP地址
http_requests{client_ip!~"192\.168\..*"}
```

---

## 4. 🔗 多条件组合查询


### 4.1 AND逻辑（逗号分隔）

**语法**：多个条件用逗号分隔，表示"同时满足"

```promql
# 查询生产环境中web服务器的CPU使用率
cpu_usage_percent{env="production",server=~"web.*"}

# 查询特定应用在特定地区的错误率
error_rate{app="payment",region="us-east-1",env="prod"}

# 组合精确匹配和正则匹配
memory_usage{service="api",version=~"v[12]\..*"}
```

### 4.2 复杂过滤示例


**场景1：监控生产环境关键服务**
```promql
# 查询生产环境中重要服务的响应时间
http_request_duration{
  env="production",
  service=~"user-api|payment-api|order-api",
  status!~"5.."
}
```

**场景2：排除测试数据的真实监控**
```promql
# 获取真实用户的API调用量
api_requests_total{
  user_type!="test",
  env!~".*test.*|.*dev.*",
  path!~"/health|/metrics"
}
```

### 4.3 标签值枚举技巧


**查看所有可用标签值**：
```promql
# 查看env标签的所有值
{__name__=~".+",env=~".+"}

# 或者使用标签函数（后续章节详解）
label_values(env)
```

**基于已知标签快速筛选**：
```promql
# 如果知道有prod、dev、test三个环境
{env=~"prod|dev|test"}
```

---

## 5. 🚀 实战应用场景


### 5.1 服务器监控场景


**监控特定服务器组**：
```promql
# Web服务器集群CPU使用率
cpu_usage_percent{server=~"web[0-9]+"}

# 数据库服务器内存使用
memory_used_bytes{role="database"}

# 负载均衡器网络流量
network_bytes_total{service="nginx",direction="in"}
```

### 5.2 应用性能监控


**API性能监控**：
```promql
# 用户相关API的响应时间
http_request_duration{
  path=~"/api/user.*",
  method="GET",
  status=~"2.."
}

# 支付服务错误率
error_rate{service="payment"} > 0.05
```

### 5.3 业务指标监控


**电商业务监控**：
```promql
# 订单相关指标
order_total{status="completed",region!="test"}

# 用户活跃度
active_users{platform=~"web|mobile",env="production"}
```

---

## 6. ⚡ 优化技巧与最佳实践


### 6.1 查询性能优化


**优化原则**：
```
1. 尽量使用精确匹配（=）
2. 将选择性高的标签放在前面
3. 避免过于宽泛的正则表达式
4. 合理使用时间范围
```

**性能对比示例**：
```promql
# ❌ 性能较差：宽泛的正则在前
cpu_usage{server=~".*",env="prod"}

# ✅ 性能较好：精确匹配在前
cpu_usage{env="prod",server=~"web.*"}
```

### 6.2 查询可读性提升


**使用描述性变量**：
```promql
# 定义复杂的选择器
prod_web_servers = {env="production",role="web"}
cpu_usage_percent prod_web_servers
```

**分层查询策略**：
```promql
# 第一步：基础过滤
base_metrics = cpu_usage_percent{env!="test"}

# 第二步：细化条件
base_metrics{server=~"web.*"}
```

### 6.3 常见错误与避免


| 错误类型 | 错误示例 | 正确示例 | 说明 |
|----------|----------|----------|------|
| **标签名错误** | `{envionment="prod"}` | `{environment="prod"}` | 拼写错误导致查询失败 |
| **正则语法错误** | `{server=~"web*"}` | `{server=~"web.*"}` | 忘记转义或语法错误 |
| **引号使用错误** | `{env=production}` | `{env="production"}` | 标签值必须用引号 |
| **逻辑错误** | `{env="prod",env="dev"}` | `{env=~"prod\|dev"}` | 同一标签不能有多个值 |

### 6.4 空标签处理


**处理缺失标签**：
```promql
# 查询有region标签的数据
cpu_usage{region!=""}

# 查询没有设置region的数据  
cpu_usage{region=""}

# 使用or查询可能缺失的标签
cpu_usage{region="us-east-1"} or cpu_usage{region=""}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念

```
🔸 指标选择器：基础的数据查找方式
🔸 四种过滤器：=、!=、=~、!~ 各有用途
🔸 多条件组合：用逗号连接，表示AND关系
🔸 时间范围：[5m]表示区间向量，无括号表示瞬时向量
🔸 性能优化：精确匹配优于正则匹配
```

### 7.2 关键理解要点


**🔹 数据查找的逻辑**
```
思考路径：
1. 我要什么指标？ → 写指标名
2. 哪些特定条件？ → 加标签过滤
3. 什么时间范围？ → 加时间范围
4. 需要排除什么？ → 用!=或!~
```

**🔹 匹配方式的选择**
```
使用场景指导：
精确匹配（=）    → 已知确切值
不等匹配（!=）   → 排除特定值
正则匹配（=~）   → 模糊查找、批量匹配
正则排除（!~）   → 排除一类值
```

**🔹 查询复杂度控制**
```
复杂度递增：
指标名 < 精确过滤 < 正则过滤 < 复杂正则 < 多重组合
建议：从简单开始，逐步增加条件
```

### 7.3 实际应用指导


**🎯 日常监控查询模板**
```promql
# 基础模板
指标名{环境过滤,服务过滤,其他条件}

# 常用模式
cpu_usage{env="prod",service=~"web.*"}        # 服务器监控
error_rate{app="payment",env!="test"}         # 应用监控  
request_duration{path=~"/api.*",status="200"} # 接口监控
```

**🔧 查询调试步骤**
```
1. 先查询基础指标：cpu_usage
2. 添加环境过滤：cpu_usage{env="prod"}
3. 细化服务过滤：cpu_usage{env="prod",service="web"}
4. 验证数据正确性
5. 根据需要添加时间范围
```

### 7.4 进阶学习方向

- **聚合函数**：sum、avg、max等统计计算
- **运算符**：+、-、*、/等数学运算  
- **函数库**：rate、increase等时间序列函数
- **复杂查询**：子查询、向量匹配等高级特性

> 🔖 **学习建议**  
> 多动手练习，从简单查询开始，逐步掌握复杂语法。
> 建议在Prometheus Web UI中实际操作，观察查询结果。

**核心记忆口诀**：
```
选择器找指标，过滤器加条件
精确用等号，正则波浪线  
排除加感叹，组合用逗号
先简后繁，性能为先
```