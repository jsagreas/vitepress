---
title: 6、内置函数核心集合
---
## 📚 目录

1. [内置函数概述](#1-内置函数概述)
2. [速率计算函数](#2-速率计算函数)
3. [变化量计算函数](#3-变化量计算函数)
4. [直方图统计函数](#4-直方图统计函数)
5. [数学运算函数](#5-数学运算函数)
6. [时间相关函数](#6-时间相关函数)
7. [标签操作函数](#7-标签操作函数)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔧 内置函数概述


### 1.1 什么是PromQL内置函数


**简单理解：内置函数就是Prometheus自带的"小工具"**

```
想象一下：
你有一堆数字数据，想要：
• 计算平均速度 → 用rate()函数
• 算出增长了多少 → 用increase()函数  
• 取个整数 → 用round()函数

这些函数就像计算器上的按钮，
每个都有特定的功能，帮你处理数据
```

### 1.2 函数分类一览


**🎯 按用途分类：**

| 分类 | **主要用途** | **常用函数** | **使用场景** |
|------|-------------|-------------|-------------|
| 📈 **速率计算** | `计算变化速度` | `rate, irate` | `监控QPS、网络流量` |
| 📊 **变化量统计** | `计算增长差值` | `increase, delta` | `统计总量变化` |
| 📉 **直方图分析** | `百分位数计算` | `histogram_quantile` | `响应时间分析` |
| 🔢 **数学运算** | `数值处理` | `abs, round, sqrt` | `数据格式化` |
| ⏰ **时间处理** | `时间戳操作` | `time, now` | `时间相关计算` |
| 🏷️ **标签操作** | `标签处理` | `label_replace, label_join` | `数据标记和分组` |

---

## 2. 📈 速率计算函数


### 2.1 rate() - 平均速率计算


**🔸 这是什么：**
`rate()`函数用来计算指标在指定时间窗口内的平均变化速率。

**🔸 通俗解释：**
```
就像算汽车的平均速度：
• 1小时前，里程表显示100公里
• 现在，里程表显示200公里  
• 平均速度 = (200-100) ÷ 1小时 = 100公里/小时

rate()做的就是这个计算！
```

**💡 语法格式：**
```promql
rate(指标名[时间窗口])
```

**🎯 实用示例：**
```promql
# 计算HTTP请求的每秒平均速率
rate(http_requests_total[5m])

# 计算CPU使用率（每秒平均变化）
rate(cpu_usage_seconds_total[1m])

# 计算网络流量速率
rate(network_bytes_total[10m])
```

**⚠️ 重要特点：**
- **只适用于Counter类型**：因为需要计算增长
- **返回每秒速率**：结果单位是"/s"
- **抗重启影响**：服务重启导致的数据归零不会影响计算

### 2.2 irate() - 瞬时速率计算


**🔸 这是什么：**
`irate()`计算最近两个数据点之间的瞬时速率。

**🔸 与rate()的区别：**
```
rate()：看5分钟内的平均速度 → 平稳，但反应慢
irate()：看最后2个点的瞬时速度 → 敏感，反应快

类比：
rate() = 看一段路程的平均车速
irate() = 看当前时刻的瞬时车速
```

**🎯 实用示例：**
```promql
# 瞬时QPS监控（快速发现突发流量）
irate(http_requests_total[5m])

# 瞬时CPU使用率变化
irate(cpu_seconds_total[2m])
```

**📊 使用选择：**

| 场景 | **推荐函数** | **原因** |
|------|-------------|---------|
| **告警规则** | `rate()` | `平稳，避免误报` |
| **实时监控** | `irate()` | `反应快，及时发现问题` |
| **长期趋势** | `rate()` | `数据平滑，便于分析` |

---

## 3. 📊 变化量计算函数


### 3.1 increase() - 增长量计算


**🔸 这是什么：**
`increase()`计算指标在指定时间窗口内的总增长量。

**🔸 通俗解释：**
```
就像计算网站访问量增长：
• 早上9点：访问量1000次
• 下午5点：访问量5000次
• 今天增长了：5000 - 1000 = 4000次

increase()就是算这个"增长了多少"
```

**💡 语法与示例：**
```promql
# 过去1小时HTTP请求总增长量
increase(http_requests_total[1h])

# 过去24小时错误请求增长量  
increase(http_errors_total[24h])

# 过去5分钟内存分配增长量
increase(memory_allocated_bytes[5m])
```

**🔄 rate() vs increase() 关系：**
```
increase() = rate() × 时间窗口秒数

例如：
rate(metric[5m]) = 10/s
increase(metric[5m]) = 10 × 300 = 3000
```

### 3.2 delta() - 变化量计算


**🔸 这是什么：**
`delta()`计算Gauge类型指标的变化量（可正可负）。

**🔸 与increase()的区别：**
```
increase()：只能用于Counter（只增不减）
delta()：可以用于Gauge（可增可减）

类比：
increase() = 银行存款增加了多少（只看增长）
delta() = 体重变化了多少（可增可减）
```

**🎯 实用示例：**
```promql
# CPU温度变化量
delta(cpu_temperature[10m])

# 内存使用量变化
delta(memory_usage_bytes[1h])

# 磁盘可用空间变化
delta(disk_free_bytes[30m])
```

### 3.3 idelta() - 瞬时变化量


**🔸 简单理解：**
`idelta()`是`delta()`的瞬时版本，计算最近两个点的变化量。

```promql
# 瞬时内存使用变化
idelta(memory_usage_bytes[5m])
```

---

## 4. 📉 直方图统计函数


### 4.1 histogram_quantile() - 分位数计算


**🔸 这是什么：**
计算直方图数据的分位数，用来分析性能指标的分布情况。

**🔸 通俗解释：**
```
想象100个学生的考试成绩：
• 50分位数(中位数)：排名中间的学生分数
• 90分位数：比90%学生分数高的那个分数
• 99分位数：比99%学生分数高的那个分数

histogram_quantile就是算这个"排名位置的数值"
```

**💡 语法格式：**
```promql
histogram_quantile(分位数, 直方图指标)
```

**🎯 实用示例：**
```promql
# 计算HTTP请求响应时间的50分位数（中位数）
histogram_quantile(0.5, http_request_duration_seconds_bucket)

# 计算99%的请求响应时间
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))

# 计算90%的请求延迟
histogram_quantile(0.9, http_latency_seconds_bucket)
```

**📊 分位数含义：**

| 分位数 | **含义** | **监控价值** |
|-------|---------|-------------|
| `0.5 (50%)` | `中位数，一半请求的性能` | `了解典型性能` |
| `0.9 (90%)` | `90%请求的性能边界` | `大部分用户体验` |
| `0.95 (95%)` | `95%请求的性能边界` | `优秀用户体验标准` |
| `0.99 (99%)` | `99%请求的性能边界` | `发现性能问题` |

---

## 5. 🔢 数学运算函数


### 5.1 绝对值和取整函数


**🔸 abs() - 绝对值**
```promql
# 获取CPU温度差值的绝对值
abs(cpu_temp - 70)

# 内存使用率与目标值的差距绝对值
abs(memory_usage_percent - 80)
```

**🔸 round() - 四舍五入**
```promql
# 将CPU使用率四舍五入到整数
round(cpu_usage_percent)

# 四舍五入到小数点后1位
round(response_time_seconds, 0.1)
```

**🔸 floor() / ceil() - 向下/向上取整**
```promql
# 向下取整（去掉小数部分）
floor(memory_usage_gb)

# 向上取整（进位到整数）
ceil(disk_usage_percent)
```

### 5.2 其他数学函数


**🔸 sqrt() - 平方根**
```promql
# 计算某个指标的平方根
sqrt(request_count)
```

**💡 实际应用场景：**
```
这些数学函数主要用于：
• 数据展示美化（取整显示）
• 告警阈值计算（绝对值比较）
• 复杂指标计算（平方根等）
```

---

## 6. ⏰ 时间相关函数


### 6.1 time() - 当前时间戳


**🔸 这是什么：**
返回当前的Unix时间戳（从1970年1月1日开始的秒数）。

```promql
# 获取当前时间戳
time()

# 计算指标采集时间与当前时间的差值
time() - timestamp(up)
```

### 6.2 now() - 当前时间


**🔸 简单理解：**
`now()`与`time()`功能相同，都返回当前时间戳。

```promql
# 使用now()获取当前时间
now()
```

**🎯 实际应用：**
```promql
# 计算数据的"新鲜度"（多久没更新了）
now() - timestamp(last_update_time)

# 判断服务是否在工作时间（时间戳计算）
time() % 86400 > 28800 and time() % 86400 < 64800
```

---

## 7. 🏷️ 标签操作函数


### 7.1 label_replace() - 标签替换


**🔸 这是什么：**
基于现有标签的值，创建或修改标签。

**🔸 通俗解释：**
```
就像给文件重命名：
原来：server-web-01.log
规则：把"server-"替换成"host-"
结果：host-web-01.log

label_replace()就是做这种"标签改名"的工作
```

**💡 语法格式：**
```promql
label_replace(指标, "新标签名", "替换值", "源标签名", "匹配规则")
```

**🎯 实用示例：**
```promql
# 从instance标签中提取主机名创建新标签
label_replace(up, "hostname", "$1", "instance", "([^:]+):.*")

# 简化环境标签显示
label_replace(cpu_usage, "env", "$1", "environment", "(dev|test|prod).*")

# 创建简化的服务名标签
label_replace(http_requests, "service", "$1", "job", "(.+)-server")
```

### 7.2 label_join() - 标签连接


**🔸 这是什么：**
将多个标签的值连接起来，创建一个新标签。

**🔸 通俗解释：**
```
就像拼接字符串：
标签1：region = "us"
标签2：zone = "east" 
连接符："-"
结果：location = "us-east"
```

**💡 语法格式：**
```promql
label_join(指标, "新标签名", "连接符", "标签1", "标签2", ...)
```

**🎯 实用示例：**
```promql
# 组合区域和可用区信息
label_join(server_info, "location", "-", "region", "zone")

# 创建完整的服务标识
label_join(service_metrics, "full_name", "_", "namespace", "service", "version")

# 组合主机和端口信息
label_join(network_stats, "endpoint", ":", "host", "port")
```

### 7.3 vector() - 向量构造


**🔸 这是什么：**
创建一个包含指定值的向量，常用于阈值比较。

**🎯 实用示例：**
```promql
# 创建一个值为100的向量用于比较
cpu_usage > vector(80)

# 创建基准线
vector(95) - cpu_usage_percent
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心函数


**🟢 基础必会（新手优先）：**
```
🔸 rate() - 计算平均速率，用于QPS、流量监控
🔸 increase() - 计算增长量，用于计数统计
🔸 round() - 数值格式化，用于展示美化
🔸 histogram_quantile() - 分位数计算，用于性能分析
```

**🟡 进阶重要（深入使用）：**
```
🔸 irate() - 瞬时速率，用于实时监控
🔸 delta() - 变化量计算，用于Gauge指标
🔸 label_replace() - 标签处理，用于数据清洗
🔸 time()/now() - 时间处理，用于复杂计算
```

### 8.2 函数选择指导


**📊 按监控类型选择：**

| 监控需求 | **推荐函数** | **理由** |
|---------|-------------|---------|
| **QPS监控** | `rate()` | `平稳计算，适合告警` |
| **实时流量** | `irate()` | `快速响应，及时发现异常` |
| **错误统计** | `increase()` | `累计计算，便于统计分析` |
| **性能分析** | `histogram_quantile()` | `分位数分析，了解性能分布` |
| **资源变化** | `delta()` | `双向变化，适合Gauge类型` |

### 8.3 常见使用技巧


**💡 组合使用模式：**
```promql
# 模式1：速率+聚合
sum(rate(http_requests_total[5m])) by (service)

# 模式2：分位数+速率  
histogram_quantile(0.95, sum(rate(http_duration_bucket[5m])) by (le))

# 模式3：标签处理+计算
sum(label_replace(cpu_usage, "team", "$1", "service", "([^-]+).*")) by (team)
```

**⚠️ 注意事项：**
```
🔸 rate/irate只能用于Counter类型
🔸 delta/idelta主要用于Gauge类型
🔸 histogram_quantile需要配合rate()使用
🔸 时间窗口选择要合理（通常2-4倍采集间隔）
🔸 标签操作要注意正则表达式语法
```

### 8.4 学习路径建议


**📖 学习顺序：**
```
第1步：掌握 rate() 和 increase() → 基础速率计算
第2步：学习 histogram_quantile() → 性能分析
第3步：了解 delta() 和数学函数 → 扩展应用
第4步：掌握标签操作函数 → 高级数据处理
```

**🎯 实践建议：**
- **先用简单函数**：从rate()开始练习
- **结合实际场景**：用自己的监控数据练习
- **多看官方文档**：了解函数的详细参数
- **实验不同参数**：理解时间窗口对结果的影响

**🧠 记忆技巧：**
```
rate - 速率 - 像汽车速度表
increase - 增长 - 像银行账户余额增长
histogram_quantile - 分位数 - 像考试成绩排名
delta - 变化 - 像体重秤上的变化
```

**核心记忆：**
- PromQL内置函数是数据处理的工具箱
- 选择合适的函数比记住所有函数更重要  
- 实践是掌握函数的最好方法
- 组合使用能发挥更强大的功能