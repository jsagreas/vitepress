---
title: 3ã€æ–‡ä»¶æœåŠ¡å‘çŽ°
---
## ðŸ“š ç›®å½•

1. [æ–‡ä»¶æœåŠ¡å‘çŽ°æ¦‚è¿°](#1-æ–‡ä»¶æœåŠ¡å‘çŽ°æ¦‚è¿°)
2. [file_sd_configsé…ç½®è¯¦è§£](#2-file_sd_configsé…ç½®è¯¦è§£)
3. [JSONä¸ŽYAMLæ ¼å¼è§„èŒƒ](#3-JSONä¸ŽYAMLæ ¼å¼è§„èŒƒ)
4. [åŠ¨æ€æ›´æ–°æœºåˆ¶](#4-åŠ¨æ€æ›´æ–°æœºåˆ¶)
5. [æ–‡ä»¶ç›‘æŽ§åŽŸç†](#5-æ–‡ä»¶ç›‘æŽ§åŽŸç†)
6. [é…ç½®æ¨¡æ¿åŒ–](#6-é…ç½®æ¨¡æ¿åŒ–)
7. [è‡ªåŠ¨åŒ–é›†æˆæ–¹æ¡ˆ](#7-è‡ªåŠ¨åŒ–é›†æˆæ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ” æ–‡ä»¶æœåŠ¡å‘çŽ°æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ–‡ä»¶æœåŠ¡å‘çŽ°


**ðŸ¤” é€šä¿—ç†è§£**
æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå›¾ä¹¦ç®¡ç†å‘˜ï¼Œéœ€è¦å®šæœŸæ£€æŸ¥å“ªäº›æ–°ä¹¦åˆ°äº†ï¼Œå“ªäº›ä¹¦è¢«å€Ÿèµ°äº†ã€‚ä¼ ç»Ÿæ–¹å¼æ˜¯ä½ æ‰‹åŠ¨åŽ»ä¹¦æž¶æ£€æŸ¥ï¼Œä½†çŽ°åœ¨æœ‰äº†ä¸€ä¸ªç¥žå¥‡çš„æ¸…å•æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå‘Šè¯‰ä½ æ‰€æœ‰ä¹¦çš„çŠ¶æ€ã€‚Prometheusçš„æ–‡ä»¶æœåŠ¡å‘çŽ°å°±æ˜¯è¿™æ ·ä¸€ä¸ª"è‡ªåŠ¨æ›´æ–°çš„æ¸…å•"ã€‚

**ðŸ“‹ æŠ€æœ¯å®šä¹‰**
```
æ–‡ä»¶æœåŠ¡å‘çŽ°ï¼ˆFile Service Discoveryï¼‰æ˜¯Prometheusçš„ä¸€ç§æœåŠ¡å‘çŽ°æœºåˆ¶ï¼Œ
é€šè¿‡ç›‘æŽ§æŒ‡å®šçš„æ–‡ä»¶æ¥åŠ¨æ€èŽ·å–éœ€è¦ç›‘æŽ§çš„ç›®æ ‡åˆ—è¡¨ã€‚

æ ¸å¿ƒç‰¹ç‚¹ï¼š
â€¢ æ— éœ€é‡å¯Prometheuså³å¯æ·»åŠ /åˆ é™¤ç›‘æŽ§ç›®æ ‡
â€¢ æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼ˆJSONã€YAMLï¼‰
â€¢ è‡ªåŠ¨ç›‘æŽ§æ–‡ä»¶å˜åŒ–å¹¶å®žæ—¶æ›´æ–°
â€¢ å¯ä¸Žå¤–éƒ¨ç³»ç»Ÿé›†æˆç”Ÿæˆç›®æ ‡åˆ—è¡¨
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶æœåŠ¡å‘çŽ°


**ðŸš« ä¼ ç»Ÿé™æ€é…ç½®çš„ç—›ç‚¹**
```
ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨prometheus.ymlä¸­ç¡¬ç¼–ç ç›®æ ‡
é—®é¢˜ï¼š
1. æ¯æ¬¡æ·»åŠ æ–°æœåŠ¡éƒ½è¦ä¿®æ”¹é…ç½®æ–‡ä»¶
2. éœ€è¦é‡å¯Prometheusæ‰èƒ½ç”Ÿæ•ˆ
3. é…ç½®æ–‡ä»¶è¶Šæ¥è¶Šè‡ƒè‚¿
4. éš¾ä»¥ä¸Žè‡ªåŠ¨åŒ–ç³»ç»Ÿé›†æˆ

ç¤ºä¾‹å›°å¢ƒï¼š
scrape_configs:
  - job_name: 'web-servers'
    static_configs:
      - targets: 
        - '192.168.1.10:9100'
        - '192.168.1.11:9100'  # æ‰‹åŠ¨æ·»åŠ 
        - '192.168.1.12:9100'  # æ‰‹åŠ¨æ·»åŠ 
        # ... å‡ ç™¾ä¸ªæœåŠ¡å™¨ï¼Ÿ
```

**âœ… æ–‡ä»¶æœåŠ¡å‘çŽ°çš„ä¼˜åŠ¿**
```
åŠ¨æ€é…ç½®çš„å¥½å¤„ï¼š
ðŸ“„ çµæ´»æ€§ï¼šæ–‡ä»¶å†…å®¹å˜åŒ–è‡ªåŠ¨ç”Ÿæ•ˆ
ðŸ”„ å®žæ—¶æ€§ï¼šæ— éœ€é‡å¯Prometheus
ðŸ¤– è‡ªåŠ¨åŒ–ï¼šå¯é€šè¿‡è„šæœ¬/ç¨‹åºè‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶
ðŸ“Š å¯ç»´æŠ¤ï¼šé…ç½®ä¸Žä»£ç åˆ†ç¦»
ðŸ”— é›†æˆæ€§ï¼šæ˜“äºŽä¸ŽCMDBã€K8sç­‰ç³»ç»Ÿé›†æˆ
```

### 1.3 æ–‡ä»¶æœåŠ¡å‘çŽ°çš„å·¥ä½œæµç¨‹


**ðŸ”„ å·¥ä½œæµç¨‹å›¾ç¤º**
```
å¤–éƒ¨ç³»ç»Ÿ/è„šæœ¬          æ–‡ä»¶ç³»ç»Ÿ              Prometheus
     |                    |                      |
     |--[1]ç”Ÿæˆç›®æ ‡æ–‡ä»¶--->|                      |
     |   targets.json     |                      |
     |                    |<-[2]ç›‘æŽ§æ–‡ä»¶å˜åŒ–-----|
     |                    |                      |
     |--[3]æ›´æ–°æ–‡ä»¶------->|                      |
     |                    |--[4]æ£€æµ‹åˆ°å˜åŒ–------>|
     |                    |                      |
     |                    |<-[5]é‡æ–°è¯»å–æ–‡ä»¶-----|
     |                    |--[6]æ›´æ–°ç›®æ ‡åˆ—è¡¨---->|
```

**ðŸ“ å…·ä½“æ­¥éª¤è¯´æ˜Ž**
1. **å¤–éƒ¨ç³»ç»Ÿç”Ÿæˆ**ï¼šCMDBã€è„šæœ¬æˆ–ç¨‹åºç”ŸæˆåŒ…å«ç›®æ ‡ä¿¡æ¯çš„æ–‡ä»¶
2. **Prometheusç›‘æŽ§**ï¼šæŒç»­ç›‘æŽ§æŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å˜åŒ–
3. **è‡ªåŠ¨æ£€æµ‹**ï¼šå½“æ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶è‡ªåŠ¨æ£€æµ‹
4. **é‡æ–°åŠ è½½**ï¼šè¯»å–æ›´æ–°åŽçš„æ–‡ä»¶å†…å®¹
5. **æ›´æ–°ç›®æ ‡**ï¼šå°†æ–°çš„ç›®æ ‡åˆ—è¡¨åº”ç”¨åˆ°ç›‘æŽ§é…ç½®ä¸­

---

## 2. âš™ï¸ file_sd_configsé…ç½®è¯¦è§£


### 2.1 åŸºç¡€é…ç½®ç»“æž„


**ðŸ“‹ é…ç½®è¯­æ³•è§£æž**
```yaml
scrape_configs:
  - job_name: 'file-discovery-demo'
    file_sd_configs:
      - files:
          - '/path/to/targets/*.json'      # æ–‡ä»¶è·¯å¾„
          - '/path/to/targets/*.yml'       # æ”¯æŒé€šé…ç¬¦
        refresh_interval: 30s              # åˆ·æ–°é—´éš”
```

**ðŸ”§ å…³é”®å‚æ•°è¯´æ˜Ž**
- **`files`**ï¼šæŒ‡å®šè¦ç›‘æŽ§çš„æ–‡ä»¶è·¯å¾„åˆ—è¡¨
- **`refresh_interval`**ï¼šæ£€æŸ¥æ–‡ä»¶å˜åŒ–çš„æ—¶é—´é—´éš”ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰

### 2.2 æ–‡ä»¶è·¯å¾„é…ç½®


**ðŸ“ è·¯å¾„é…ç½®æŠ€å·§**
```yaml
# 1. å•ä¸ªæ–‡ä»¶
files:
  - '/etc/prometheus/targets/web-servers.json'

# 2. é€šé…ç¬¦åŒ¹é…
files:
  - '/etc/prometheus/targets/*.json'
  - '/etc/prometheus/targets/*.yml'

# 3. å¤šç›®å½•é…ç½®
files:
  - '/etc/prometheus/targets/prod/*.json'
  - '/etc/prometheus/targets/test/*.json'
  - '/etc/prometheus/targets/dev/*.yml'

# 4. é€’å½’ç›®å½•ï¼ˆä½¿ç”¨**ï¼‰
files:
  - '/etc/prometheus/targets/**/*.json'
```

**âš ï¸ è·¯å¾„é…ç½®æ³¨æ„äº‹é¡¹**
```
å®‰å…¨è€ƒè™‘ï¼š
â€¢ ç¡®ä¿Prometheusè¿›ç¨‹æœ‰è¯»å–æƒé™
â€¢ é¿å…ä½¿ç”¨è¿‡äºŽå®½æ³›çš„é€šé…ç¬¦
â€¢ å»ºè®®ä½¿ç”¨ä¸“é—¨çš„ç›®å½•å­˜æ”¾ç›®æ ‡æ–‡ä»¶

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ ä¸è¦ç›‘æŽ§åŒ…å«å¤§é‡æ–‡ä»¶çš„ç›®å½•
â€¢ åˆç†è®¾ç½®refresh_interval
â€¢ é¿å…é¢‘ç¹çš„æ–‡ä»¶å˜åŒ–
```

### 2.3 å®Œæ•´é…ç½®ç¤ºä¾‹


**ðŸŽ¯ å®žé™…é¡¹ç›®é…ç½®**
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  # WebæœåŠ¡å™¨ç›‘æŽ§
  - job_name: 'web-servers'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/web-*.json'
        refresh_interval: 30s
    scrape_interval: 10s
    metrics_path: '/metrics'
    
  # æ•°æ®åº“ç›‘æŽ§
  - job_name: 'databases'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/db-*.yml'
        refresh_interval: 60s
    scrape_interval: 30s
    
  # å¾®æœåŠ¡ç›‘æŽ§
  - job_name: 'microservices'
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/services/*.json'
        refresh_interval: 15s
```

---

## 3. ðŸ“„ JSONä¸ŽYAMLæ ¼å¼è§„èŒƒ


### 3.1 JSONæ ¼å¼è¯¦è§£


**ðŸ“‹ åŸºç¡€JSONç»“æž„**
```json
[
  {
    "targets": ["192.168.1.10:9100", "192.168.1.11:9100"],
    "labels": {
      "job": "web-server",
      "env": "production",
      "team": "backend"
    }
  }
]
```

**ðŸ” å­—æ®µè¯´æ˜Ž**
- **`targets`**ï¼šç›®æ ‡åœ°å€åˆ—è¡¨ï¼Œæ ¼å¼ä¸º`host:port`
- **`labels`**ï¼šé™„åŠ åˆ°æ¯ä¸ªç›®æ ‡çš„æ ‡ç­¾ï¼Œç”¨äºŽåˆ†ç±»å’Œè¿‡æ»¤

**ðŸŽ¯ å¤æ‚JSONé…ç½®ç¤ºä¾‹**
```json
[
  {
    "targets": [
      "web-01.example.com:9100",
      "web-02.example.com:9100"
    ],
    "labels": {
      "job": "web-server",
      "env": "production",
      "region": "us-east-1",
      "team": "frontend",
      "version": "v2.1.0"
    }
  },
  {
    "targets": [
      "api-01.example.com:8080",
      "api-02.example.com:8080"
    ],
    "labels": {
      "job": "api-server",
      "env": "production",
      "region": "us-east-1",
      "team": "backend",
      "service": "user-api"
    }
  }
]
```

### 3.2 YAMLæ ¼å¼è¯¦è§£


**ðŸ“‹ YAMLæ ¼å¼ä¼˜åŠ¿**
```
YAMLç›¸æ¯”JSONçš„ä¼˜ç‚¹ï¼š
â€¢ æ›´æ˜“è¯»æ˜“å†™
â€¢ æ”¯æŒæ³¨é‡Š
â€¢ å±‚æ¬¡ç»“æž„æ›´æ¸…æ™°
â€¢ é…ç½®ç®¡ç†æ›´å‹å¥½
```

**ðŸŽ¯ YAMLé…ç½®ç¤ºä¾‹**
```yaml
# web-servers.yml
- targets:
    - "web-01.example.com:9100"
    - "web-02.example.com:9100"
  labels:
    job: "web-server"
    env: "production"
    region: "us-east-1"
    team: "frontend"

- targets:
    - "web-03.example.com:9100"
    - "web-04.example.com:9100"
  labels:
    job: "web-server"
    env: "staging"
    region: "us-west-2"
    team: "frontend"
```

### 3.3 æ ¼å¼é€‰æ‹©å»ºè®®


**ðŸ¤” ä½•æ—¶ä½¿ç”¨JSON vs YAML**

| åœºæ™¯ | **æŽ¨èæ ¼å¼** | **åŽŸå› ** |
|------|-------------|---------|
| **è‡ªåŠ¨åŒ–ç”Ÿæˆ** | `JSON` | `ç¨‹åºç”Ÿæˆæ›´å®¹æ˜“ï¼Œè§£æžæ€§èƒ½æ›´å¥½` |
| **æ‰‹åŠ¨ç»´æŠ¤** | `YAML` | `æ›´æ˜“è¯»ï¼Œæ”¯æŒæ³¨é‡Šï¼Œç»´æŠ¤å‹å¥½` |
| **å¤§è§„æ¨¡ç›®æ ‡** | `JSON` | `æ–‡ä»¶æ›´å°ï¼Œè§£æžæ›´å¿«` |
| **å¤æ‚é…ç½®** | `YAML` | `å±‚æ¬¡ç»“æž„æ¸…æ™°ï¼Œå¯è¯»æ€§å¼º` |

### 3.4 æ ¼å¼éªŒè¯å·¥å…·


**ðŸ”§ JSONéªŒè¯**
```bash
# ä½¿ç”¨jqéªŒè¯JSONæ ¼å¼
cat targets.json | jq .

# éªŒè¯ç‰¹å®šç»“æž„
cat targets.json | jq '.[].targets[]'
```

**ðŸ”§ YAMLéªŒè¯**
```bash
# ä½¿ç”¨yqéªŒè¯YAMLæ ¼å¼
cat targets.yml | yq .

# éªŒè¯è¯­æ³•
yamllint targets.yml
```

---

## 4. ðŸ”„ åŠ¨æ€æ›´æ–°æœºåˆ¶


### 4.1 æ–‡ä»¶å˜åŒ–æ£€æµ‹åŽŸç†


**ðŸ” Prometheuså¦‚ä½•æ£€æµ‹æ–‡ä»¶å˜åŒ–**
```
æ£€æµ‹æœºåˆ¶ï¼š
1. å®šæ—¶è½®è¯¢ï¼šæ ¹æ®refresh_intervalå®šæœŸæ£€æŸ¥
2. æ–‡ä»¶å…ƒä¿¡æ¯æ¯”è¾ƒï¼šæ¯”è¾ƒä¿®æ”¹æ—¶é—´ã€æ–‡ä»¶å¤§å°ç­‰
3. å†…å®¹å“ˆå¸Œå¯¹æ¯”ï¼šç¡®ä¿å†…å®¹çœŸæ­£å‘ç”Ÿå˜åŒ–
4. å¢žé‡æ›´æ–°ï¼šåªå¤„ç†å˜åŒ–çš„éƒ¨åˆ†

æ£€æµ‹æµç¨‹ï¼š
æ—¶é—´ç‚¹T1 â”€â”€â”
            â”œâ”€ æ£€æŸ¥æ–‡ä»¶å…ƒä¿¡æ¯
æ—¶é—´ç‚¹T2 â”€â”€â”¤
            â”œâ”€ å‘çŽ°å˜åŒ–
æ—¶é—´ç‚¹T3 â”€â”€â”¤
            â””â”€ é‡æ–°åŠ è½½é…ç½®
```

### 4.2 æ›´æ–°æ—¶é—´é…ç½®


**â° refresh_intervalè¯¦è§£**
```yaml
file_sd_configs:
  - files: ['/path/to/targets.json']
    refresh_interval: 30s     # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
```

**ðŸŽ¯ æ—¶é—´é—´éš”é€‰æ‹©ç­–ç•¥**
```
é€‰æ‹©åŽŸåˆ™ï¼š
â€¢ é«˜é¢‘å˜åŒ–çŽ¯å¢ƒï¼š15-30ç§’
â€¢ ç¨³å®šçŽ¯å¢ƒï¼š5-10åˆ†é’Ÿ
â€¢ å¤§è§„æ¨¡çŽ¯å¢ƒï¼šæ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´

æ€§èƒ½å½±å“ï¼š
â€¢ é—´éš”å¤ªçŸ­ï¼šå¢žåŠ IOè´Ÿè½½
â€¢ é—´éš”å¤ªé•¿ï¼šæ›´æ–°ä¸åŠæ—¶
â€¢ å»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å¹³è¡¡
```

### 4.3 æ›´æ–°è¿‡ç¨‹æ¼”ç¤º


**ðŸ“ å®žé™…æ›´æ–°åœºæ™¯**
```bash
# åˆå§‹ç›®æ ‡æ–‡ä»¶
echo '[
  {
    "targets": ["server1:9100", "server2:9100"],
    "labels": {"env": "prod"}
  }
]' > /etc/prometheus/targets/web.json

# Prometheusæ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
# level=info msg="Loading configuration file" filename=prometheus.yml
# level=info msg="Completed loading of configuration file"

# æ·»åŠ æ–°ç›®æ ‡
echo '[
  {
    "targets": ["server1:9100", "server2:9100", "server3:9100"],
    "labels": {"env": "prod"}
  }
]' > /etc/prometheus/targets/web.json

# 30ç§’åŽPrometheusæ—¥å¿—ï¼š
# level=info msg="File SD refresh" discovery=file
# level=info msg="Targets updated" targets=3
```

### 4.4 æ›´æ–°å¤±è´¥å¤„ç†


**âš ï¸ å¸¸è§æ›´æ–°é—®é¢˜**
```
é—®é¢˜1ï¼šJSONæ ¼å¼é”™è¯¯
åŽŸå› ï¼šæ–‡ä»¶è¯­æ³•ä¸æ­£ç¡®
è§£å†³ï¼šä½¿ç”¨jqéªŒè¯æ ¼å¼

é—®é¢˜2ï¼šæ–‡ä»¶æƒé™é—®é¢˜
åŽŸå› ï¼šPrometheusæ— æ³•è¯»å–æ–‡ä»¶
è§£å†³ï¼šæ£€æŸ¥æ–‡ä»¶æƒé™

é—®é¢˜3ï¼šæ–‡ä»¶è·¯å¾„é”™è¯¯
åŽŸå› ï¼šæ–‡ä»¶ä¸å­˜åœ¨æˆ–è·¯å¾„ä¸å¯¹
è§£å†³ï¼šéªŒè¯æ–‡ä»¶è·¯å¾„å’Œé€šé…ç¬¦

é—®é¢˜4ï¼šæ–‡ä»¶é”å®š
åŽŸå› ï¼šå…¶ä»–è¿›ç¨‹æ­£åœ¨å†™å…¥æ–‡ä»¶
è§£å†³ï¼šä½¿ç”¨åŽŸå­å†™å…¥æ–¹å¼
```

---

## 5. ðŸ‘ï¸ æ–‡ä»¶ç›‘æŽ§åŽŸç†


### 5.1 ç›‘æŽ§æœºåˆ¶æ·±å…¥ç†è§£


**ðŸ” åº•å±‚ç›‘æŽ§æŠ€æœ¯**
```
Linuxç³»ç»Ÿï¼šä½¿ç”¨inotifyæœºåˆ¶
- ç›‘æŽ§æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶
- å®žæ—¶å“åº”æ–‡ä»¶å˜åŒ–
- é«˜æ•ˆçš„å†…æ ¸çº§ç›‘æŽ§

Windowsç³»ç»Ÿï¼šä½¿ç”¨ReadDirectoryChangesW
- ç›®å½•å˜åŒ–é€šçŸ¥
- å¼‚æ­¥äº‹ä»¶å¤„ç†

ç›‘æŽ§äº‹ä»¶ç±»åž‹ï¼š
â€¢ æ–‡ä»¶ä¿®æ”¹ï¼ˆIN_MODIFYï¼‰
â€¢ æ–‡ä»¶ç§»åŠ¨ï¼ˆIN_MOVEï¼‰
â€¢ æ–‡ä»¶åˆ é™¤ï¼ˆIN_DELETEï¼‰
â€¢ æ–‡ä»¶åˆ›å»ºï¼ˆIN_CREATEï¼‰
```

**ðŸ“Š ç›‘æŽ§æµç¨‹å›¾ç¤º**
```
æ–‡ä»¶ç³»ç»Ÿå±‚
    |
    | æ–‡ä»¶å˜åŒ–äº‹ä»¶
    â–¼
æ“ä½œç³»ç»Ÿå†…æ ¸
    |
    | inotifyäº‹ä»¶
    â–¼
Prometheusè¿›ç¨‹
    |
    | è§£æžæ–‡ä»¶å†…å®¹
    â–¼
ç›®æ ‡æ›´æ–°æœºåˆ¶
    |
    | åº”ç”¨æ–°é…ç½®
    â–¼
ç›‘æŽ§ç›®æ ‡åˆ—è¡¨
```

### 5.2 æ€§èƒ½ä¼˜åŒ–æœºåˆ¶


**âš¡ é«˜æ•ˆç›‘æŽ§ç­–ç•¥**
```
ä¼˜åŒ–æŠ€æœ¯ï¼š
1. æ‰¹é‡å¤„ç†ï¼šå¤šä¸ªå˜åŒ–åˆå¹¶å¤„ç†
2. é˜²æŠ–åŠ¨ï¼šé¿å…é¢‘ç¹çš„å°å˜åŒ–è§¦å‘æ›´æ–°
3. ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è¯»å–æœªå˜åŒ–çš„æ–‡ä»¶
4. å¢žé‡æ›´æ–°ï¼šåªæ›´æ–°å˜åŒ–çš„ç›®æ ‡

é˜²æŠ–åŠ¨ç¤ºä¾‹ï¼š
æ—¶é—´: 0s   1s   2s   3s   4s   5s
äº‹ä»¶: Ã—    Ã—    Ã—    -    -    âˆšå¤„ç†
è¯´æ˜Ž: è¿žç»­å˜åŒ–åœ¨5ç§’å†…åªå¤„ç†ä¸€æ¬¡
```

### 5.3 ç›‘æŽ§çŠ¶æ€æŸ¥çœ‹


**ðŸ” ç›‘æŽ§çŠ¶æ€æ£€æŸ¥æ–¹æ³•**
```bash
# 1. æŸ¥çœ‹Prometheusæ—¥å¿—
tail -f /var/log/prometheus/prometheus.log | grep "File SD"

# 2. æ£€æŸ¥ç›®æ ‡çŠ¶æ€
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[]'

# 3. ç›‘æŽ§é…ç½®é‡è½½
curl -X POST http://localhost:9090/-/reload
```

**ðŸ“Š ç›‘æŽ§æŒ‡æ ‡**
```
prometheus_sd_file_read_errors_total: æ–‡ä»¶è¯»å–é”™è¯¯æ•°
prometheus_sd_file_scan_duration_seconds: æ–‡ä»¶æ‰«æè€—æ—¶
prometheus_config_last_reload_successful: é…ç½®é‡è½½æ˜¯å¦æˆåŠŸ
```

---

## 6. ðŸŽ¨ é…ç½®æ¨¡æ¿åŒ–


### 6.1 æ¨¡æ¿åŒ–çš„å¿…è¦æ€§


**ðŸ¤” ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ¿åŒ–**
```
ç—›ç‚¹é—®é¢˜ï¼š
â€¢ å¤§é‡é‡å¤çš„é…ç½®
â€¢ éš¾ä»¥ç»Ÿä¸€ç®¡ç†æ ‡ç­¾
â€¢ çŽ¯å¢ƒå·®å¼‚åŒ–é…ç½®å¤æ‚
â€¢ æ‰‹åŠ¨ç»´æŠ¤å®¹æ˜“å‡ºé”™

æ¨¡æ¿åŒ–æ”¶ç›Šï¼š
âœ… é…ç½®æ ‡å‡†åŒ–
âœ… å‡å°‘é‡å¤å·¥ä½œ
âœ… æé«˜ç»´æŠ¤æ•ˆçŽ‡
âœ… é™ä½Žå‡ºé”™æ¦‚çŽ‡
```

### 6.2 ä½¿ç”¨æ¨¡æ¿å¼•æ“Ž


**ðŸ”§ Go Templateç¤ºä¾‹**
```go
// template/targets.tmpl
[
{{range .Services}}
  {
    "targets": [{{range .Instances}}"{{.Host}}:{{.Port}}"{{if not (isLast @index $.Services)}},{{end}}{{end}}],
    "labels": {
      "job": "{{.Name}}",
      "env": "{{.Environment}}",
      "region": "{{.Region}}",
      "team": "{{.Team}}"
    }
  }{{if not (isLast @index $.Services)}},{{end}}
{{end}}
]
```

**ðŸŽ¯ Jinja2æ¨¡æ¿ç¤ºä¾‹**
```jinja2
{# targets.j2 #}
[
{% for service in services %}
  {
    "targets": [
      {% for instance in service.instances %}
      "{{ instance.host }}:{{ instance.port }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    ],
    "labels": {
      "job": "{{ service.name }}",
      "env": "{{ service.environment }}",
      "region": "{{ service.region }}",
      "team": "{{ service.team }}"
    }
  }{% if not loop.last %},{% endif %}
{% endfor %}
]
```

### 6.3 æ¨¡æ¿æ•°æ®æº


**ðŸ“Š æ•°æ®æºé…ç½®ç¤ºä¾‹**
```yaml
# config.yml
services:
  - name: "web-server"
    environment: "production"
    region: "us-east-1"
    team: "frontend"
    instances:
      - host: "web-01.example.com"
        port: 9100
      - host: "web-02.example.com"
        port: 9100
        
  - name: "api-server"
    environment: "production"
    region: "us-east-1"
    team: "backend"
    instances:
      - host: "api-01.example.com"
        port: 8080
```

### 6.4 ç”Ÿæˆè„šæœ¬ç¤ºä¾‹


**ðŸ”§ Pythonç”Ÿæˆè„šæœ¬**
```python
#!/usr/bin/env python3
import yaml
import json
from jinja2 import Template

def generate_targets():
    # è¯»å–é…ç½®æ•°æ®
    with open('config.yml', 'r') as f:
        data = yaml.safe_load(f)
    
    # è¯»å–æ¨¡æ¿
    with open('targets.j2', 'r') as f:
        template = Template(f.read())
    
    # æ¸²æŸ“æ¨¡æ¿
    result = template.render(services=data['services'])
    
    # éªŒè¯JSONæ ¼å¼
    targets = json.loads(result)
    
    # å†™å…¥ç›®æ ‡æ–‡ä»¶
    with open('/etc/prometheus/targets/auto-generated.json', 'w') as f:
        json.dump(targets, f, indent=2)
    
    print(f"Generated {len(targets)} target groups")

if __name__ == '__main__':
    generate_targets()
```

---

## 7. ðŸ¤– è‡ªåŠ¨åŒ–é›†æˆæ–¹æ¡ˆ


### 7.1 ä¸ŽCMDBé›†æˆ


**ðŸ”— CMDBé›†æˆæž¶æž„**
```
CMDBæ•°æ®åº“
    |
    | APIæŸ¥è¯¢
    â–¼
æ•°æ®æå–è„šæœ¬
    |
    | æ ‡å‡†åŒ–å¤„ç†
    â–¼
ç›®æ ‡æ–‡ä»¶ç”Ÿæˆ
    |
    | å†™å…¥æ–‡ä»¶
    â–¼
Prometheusç›‘æŽ§
```

**ðŸ”§ CMDBé›†æˆè„šæœ¬ç¤ºä¾‹**
```python
#!/usr/bin/env python3
import requests
import json
import time

class CMDBIntegration:
    def __init__(self, cmdb_url, output_path):
        self.cmdb_url = cmdb_url
        self.output_path = output_path
    
    def fetch_servers(self):
        """ä»ŽCMDBèŽ·å–æœåŠ¡å™¨åˆ—è¡¨"""
        response = requests.get(f"{self.cmdb_url}/api/servers")
        return response.json()
    
    def transform_to_targets(self, servers):
        """è½¬æ¢ä¸ºPrometheusç›®æ ‡æ ¼å¼"""
        targets = []
        
        # æŒ‰æœåŠ¡åˆ†ç»„
        services = {}
        for server in servers:
            service_name = server.get('service', 'unknown')
            if service_name not in services:
                services[service_name] = []
            services[service_name].append(server)
        
        # ç”Ÿæˆç›®æ ‡é…ç½®
        for service_name, service_servers in services.items():
            target_group = {
                "targets": [
                    f"{server['ip']}:{server.get('port', 9100)}"
                    for server in service_servers
                ],
                "labels": {
                    "job": service_name,
                    "env": service_servers[0].get('environment', 'unknown'),
                    "region": service_servers[0].get('region', 'unknown')
                }
            }
            targets.append(target_group)
        
        return targets
    
    def write_targets(self, targets):
        """å†™å…¥ç›®æ ‡æ–‡ä»¶"""
        with open(self.output_path, 'w') as f:
            json.dump(targets, f, indent=2)
    
    def sync(self):
        """æ‰§è¡ŒåŒæ­¥"""
        servers = self.fetch_servers()
        targets = self.transform_to_targets(servers)
        self.write_targets(targets)
        print(f"Synced {len(targets)} service groups")

# å®šæ—¶åŒæ­¥
if __name__ == '__main__':
    integration = CMDBIntegration(
        cmdb_url='http://cmdb.company.com',
        output_path='/etc/prometheus/targets/cmdb-sync.json'
    )
    
    while True:
        try:
            integration.sync()
            time.sleep(300)  # æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
        except Exception as e:
            print(f"Sync failed: {e}")
            time.sleep(60)
```

### 7.2 ä¸ŽKubernetesé›†æˆ


**ðŸŽ¯ K8s Serviceå‘çŽ°**
```yaml
# k8s-targets-generator.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-targets
data:
  generate.py: |
    #!/usr/bin/env python3
    import kubernetes
    import json
    
    def generate_k8s_targets():
        kubernetes.config.load_incluster_config()
        v1 = kubernetes.client.CoreV1Api()
        
        targets = []
        
        # èŽ·å–æ‰€æœ‰Service
        services = v1.list_service_for_all_namespaces()
        
        for service in services.items:
            if 'prometheus.io/scrape' in service.metadata.annotations:
                target_group = {
                    "targets": [f"{service.spec.cluster_ip}:{service.spec.ports[0].port}"],
                    "labels": {
                        "job": service.metadata.name,
                        "namespace": service.metadata.namespace,
                        "service": service.metadata.name
                    }
                }
                targets.append(target_group)
        
        with open('/targets/k8s-services.json', 'w') as f:
            json.dump(targets, f, indent=2)
    
    generate_k8s_targets()
```

### 7.3 CI/CDé›†æˆ


**ðŸ”„ éƒ¨ç½²è‡ªåŠ¨åŒ–**
```yaml
# .gitlab-ci.yml
stages:
  - deploy
  - update-monitoring

deploy_app:
  stage: deploy
  script:
    - deploy_application.sh
    
update_prometheus_targets:
  stage: update-monitoring
  script:
    - |
      # ç”Ÿæˆæ–°çš„ç›‘æŽ§ç›®æ ‡
      cat > /tmp/new-targets.json << EOF
      [
        {
          "targets": ["${APP_HOST}:${APP_PORT}"],
          "labels": {
            "job": "${CI_PROJECT_NAME}",
            "env": "${CI_ENVIRONMENT_NAME}",
            "version": "${CI_COMMIT_TAG}"
          }
        }
      ]
      EOF
    
    - # æ›´æ–°ç›®æ ‡æ–‡ä»¶
    - scp /tmp/new-targets.json prometheus-server:/etc/prometheus/targets/${CI_PROJECT_NAME}.json
```

### 7.4 ç›‘æŽ§é›†æˆçš„æœ€ä½³å®žè·µ


**âœ… é›†æˆæœ€ä½³å®žè·µ**
```
è®¾è®¡åŽŸåˆ™ï¼š
1. åŽŸå­æ€§æ“ä½œï¼šä½¿ç”¨ä¸´æ—¶æ–‡ä»¶+ç§»åŠ¨çš„æ–¹å¼æ›´æ–°
2. é”™è¯¯å¤„ç†ï¼šé›†æˆå¤±è´¥ä¸å½±å“çŽ°æœ‰ç›‘æŽ§
3. æ—¥å¿—è®°å½•ï¼šè¯¦ç»†è®°å½•é›†æˆè¿‡ç¨‹å’Œé”™è¯¯
4. ç›‘æŽ§è‡ªç›‘æŽ§ï¼šç›‘æŽ§é›†æˆè„šæœ¬çš„è¿è¡ŒçŠ¶æ€

å®žçŽ°æŠ€å·§ï¼š
â€¢ ä½¿ç”¨æ–‡ä»¶é”é¿å…å¹¶å‘å†™å…¥
â€¢ å®žçŽ°é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶å¤±è´¥
â€¢ æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
â€¢ é…ç½®å‘Šè­¦ç›‘æŽ§é›†æˆçŠ¶æ€
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ æ–‡ä»¶æœåŠ¡å‘çŽ°æœ¬è´¨ï¼šé€šè¿‡ç›‘æŽ§æ–‡ä»¶å˜åŒ–åŠ¨æ€æ›´æ–°ç›‘æŽ§ç›®æ ‡
ðŸ”¸ é…ç½®ç»“æž„ï¼šfile_sd_configs + files + refresh_interval
ðŸ”¸ æ–‡ä»¶æ ¼å¼ï¼šJSONå’ŒYAMLä¸¤ç§æ ¼å¼ï¼Œå„æœ‰é€‚ç”¨åœºæ™¯
ðŸ”¸ åŠ¨æ€æ›´æ–°ï¼šæ— éœ€é‡å¯Prometheuså³å¯ç”Ÿæ•ˆ
ðŸ”¸ ç›‘æŽ§åŽŸç†ï¼šåŸºäºŽæ–‡ä»¶ç³»ç»Ÿäº‹ä»¶çš„å®žæ—¶ç›‘æŽ§æœºåˆ¶
ðŸ”¸ æ¨¡æ¿åŒ–ï¼šä½¿ç”¨æ¨¡æ¿å¼•æ“Žæ ‡å‡†åŒ–é…ç½®ç”Ÿæˆ
ðŸ”¸ è‡ªåŠ¨åŒ–é›†æˆï¼šä¸ŽCMDBã€K8sã€CI/CDç­‰ç³»ç»Ÿé›†æˆ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä½•æ—¶ä½¿ç”¨æ–‡ä»¶æœåŠ¡å‘çŽ°**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… ç›‘æŽ§ç›®æ ‡é¢‘ç¹å˜åŒ–
âœ… éœ€è¦ä¸Žå¤–éƒ¨ç³»ç»Ÿé›†æˆ
âœ… é…ç½®éœ€è¦è‡ªåŠ¨åŒ–ç®¡ç†
âœ… å¤šçŽ¯å¢ƒé…ç½®å·®å¼‚å¤§

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ç›‘æŽ§ç›®æ ‡åŸºæœ¬å›ºå®š
âŒ ç®€å•çš„å°è§„æ¨¡çŽ¯å¢ƒ
âŒ å¯¹å®žæ—¶æ€§è¦æ±‚æžé«˜çš„åœºæ™¯
```

**ðŸ”¹ æ–‡ä»¶æ ¼å¼é€‰æ‹©ç­–ç•¥**
```
JSONæ ¼å¼ï¼š
â€¢ ç¨‹åºè‡ªåŠ¨ç”Ÿæˆ
â€¢ å¤§è§„æ¨¡ç›®æ ‡é…ç½®
â€¢ æ€§èƒ½è¦æ±‚é«˜çš„åœºæ™¯

YAMLæ ¼å¼ï¼š
â€¢ æ‰‹åŠ¨ç»´æŠ¤é…ç½®
â€¢ éœ€è¦æ·»åŠ æ³¨é‡Šè¯´æ˜Ž
â€¢ å¯è¯»æ€§è¦æ±‚é«˜çš„åœºæ™¯
```

**ðŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
æ–‡ä»¶ç»„ç»‡ï¼š
â€¢ æŒ‰ä¸šåŠ¡åŸŸåˆ†ç¦»æ–‡ä»¶
â€¢ æŽ§åˆ¶å•æ–‡ä»¶å¤§å°
â€¢ ä½¿ç”¨åˆç†çš„ç›®å½•ç»“æž„

æ›´æ–°ç­–ç•¥ï¼š
â€¢ é€‰æ‹©åˆé€‚çš„refresh_interval
â€¢ é¿å…é¢‘ç¹çš„å°å˜åŒ–
â€¢ ä½¿ç”¨åŽŸå­æ›´æ–°æ“ä½œ
```

### 8.3 å®žé™…åº”ç”¨å»ºè®®


**ðŸŽ¯ ç”Ÿäº§çŽ¯å¢ƒå®žè·µ**
```
ç›®å½•è§„åˆ’ï¼š
/etc/prometheus/targets/
â”œâ”€â”€ prod/           # ç”Ÿäº§çŽ¯å¢ƒ
â”‚   â”œâ”€â”€ web-*.json
â”‚   â”œâ”€â”€ db-*.json
â”‚   â””â”€â”€ api-*.json
â”œâ”€â”€ staging/        # æµ‹è¯•çŽ¯å¢ƒ
â””â”€â”€ dev/           # å¼€å‘çŽ¯å¢ƒ

æ–‡ä»¶å‘½åè§„èŒƒï¼š
â€¢ ä½¿ç”¨æœ‰æ„ä¹‰çš„å‰ç¼€
â€¢ åŒ…å«çŽ¯å¢ƒä¿¡æ¯
â€¢ é¿å…ç‰¹æ®Šå­—ç¬¦
```

**ðŸ›¡ï¸ å®‰å…¨è€ƒè™‘**
```
æƒé™æŽ§åˆ¶ï¼š
â€¢ Prometheusè¿›ç¨‹åªéœ€è¯»æƒé™
â€¢ é™åˆ¶æ–‡ä»¶ä¿®æ”¹æƒé™
â€¢ ä½¿ç”¨ä¸“é—¨çš„æœåŠ¡è´¦æˆ·

æ–‡ä»¶éªŒè¯ï¼š
â€¢ ç”Ÿæˆå‰éªŒè¯JSON/YAMLæ ¼å¼
â€¢ ä½¿ç”¨schemaéªŒè¯å†…å®¹ç»“æž„
â€¢ æ·»åŠ å†…å®¹åˆç†æ€§æ£€æŸ¥
```

**ðŸ“Š ç›‘æŽ§è‡ªç›‘æŽ§**
```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ æ–‡ä»¶è¯»å–é”™è¯¯çŽ‡
â€¢ é…ç½®é‡è½½æˆåŠŸçŽ‡
â€¢ ç›®æ ‡å‘çŽ°å»¶è¿Ÿ
â€¢ æ–‡ä»¶æ›´æ–°é¢‘çŽ‡

å‘Šè­¦é…ç½®ï¼š
â€¢ æ–‡ä»¶æ ¼å¼é”™è¯¯å‘Šè­¦
â€¢ é…ç½®é‡è½½å¤±è´¥å‘Šè­¦
â€¢ ç›®æ ‡æ•°é‡å¼‚å¸¸å‘Šè­¦
```

### 8.4 æ•…éšœæŽ’æŸ¥æŒ‡å—


**ðŸ” å¸¸è§é—®é¢˜è¯Šæ–­**
```
é—®é¢˜1ï¼šç›®æ ‡ä¸æ›´æ–°
æ£€æŸ¥é¡¹ï¼š
â–¡ æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
â–¡ æ–‡ä»¶æƒé™æ˜¯å¦è¶³å¤Ÿ
â–¡ refresh_intervalæ˜¯å¦åˆç†
â–¡ Prometheusæ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

é—®é¢˜2ï¼šJSONæ ¼å¼é”™è¯¯
æ£€æŸ¥é¡¹ï¼š
â–¡ ä½¿ç”¨jqéªŒè¯æ ¼å¼
â–¡ æ£€æŸ¥é€—å·å’Œæ‹¬å·
â–¡ éªŒè¯å­—ç¬¦ç¼–ç 
â–¡ ç¡®è®¤æ–‡ä»¶å®Œæ•´æ€§

é—®é¢˜3ï¼šæ ‡ç­¾ä¸ç”Ÿæ•ˆ
æ£€æŸ¥é¡¹ï¼š
â–¡ æ ‡ç­¾åç§°æ˜¯å¦åˆæ³•
â–¡ æ ‡ç­¾å€¼æ˜¯å¦æ­£ç¡®
â–¡ æ˜¯å¦æœ‰æ ‡ç­¾å†²çª
â–¡ æ£€æŸ¥æ ‡ç­¾é‡å†™è§„åˆ™
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ–‡ä»¶æœåŠ¡å‘çŽ°æ˜¯åŠ¨æ€é…ç½®çš„åˆ©å™¨ï¼Œè®©ç›‘æŽ§ç›®æ ‡ç®¡ç†æ›´çµæ´»
- é€‰æ‹©åˆé€‚çš„æ–‡ä»¶æ ¼å¼å’Œæ›´æ–°ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œç»´æŠ¤æ€§
- é€šè¿‡æ¨¡æ¿åŒ–å’Œè‡ªåŠ¨åŒ–é›†æˆï¼Œå®žçŽ°ç›‘æŽ§é…ç½®çš„æ ‡å‡†åŒ–ç®¡ç†
- é‡è§†ç›‘æŽ§è‡ªç›‘æŽ§ï¼Œç¡®ä¿æ–‡ä»¶æœåŠ¡å‘çŽ°æœºåˆ¶çš„å¯é æ€§