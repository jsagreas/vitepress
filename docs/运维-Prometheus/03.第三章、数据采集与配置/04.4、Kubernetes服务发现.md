---
title: 4ã€KubernetesæœåŠ¡å‘ç°
---
## ğŸ“š ç›®å½•

1. [KubernetesæœåŠ¡å‘ç°æ¦‚è¿°](#1-KubernetesæœåŠ¡å‘ç°æ¦‚è¿°)
2. [kubernetes_sd_configsé…ç½®è¯¦è§£](#2-kubernetes_sd_configsé…ç½®è¯¦è§£)
3. [æœåŠ¡å‘ç°è§’è‰²ç±»å‹è¯¦è§£](#3-æœåŠ¡å‘ç°è§’è‰²ç±»å‹è¯¦è§£)
4. [æ ‡ç­¾æ˜ å°„æœºåˆ¶æ·±å…¥ç†è§£](#4-æ ‡ç­¾æ˜ å°„æœºåˆ¶æ·±å…¥ç†è§£)
5. [å‘½åç©ºé—´è¿‡æ»¤é…ç½®](#5-å‘½åç©ºé—´è¿‡æ»¤é…ç½®)
6. [RBACæƒé™é…ç½®å®æˆ˜](#6-RBACæƒé™é…ç½®å®æˆ˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ KubernetesæœåŠ¡å‘ç°æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯KubernetesæœåŠ¡å‘ç°


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
ç®€å•ç†è§£ï¼šPrometheusè‡ªåŠ¨æ‰¾åˆ°K8sé›†ç¾¤ä¸­éœ€è¦ç›‘æ§çš„ç›®æ ‡
å°±åƒï¼šä¸€ä¸ªæ™ºèƒ½é›·è¾¾ï¼Œè‡ªåŠ¨æ‰«æå¹¶é”å®šæ‰€æœ‰éœ€è¦ç›‘æ§çš„å®¹å™¨å’ŒæœåŠ¡

ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨åœ¨é…ç½®æ–‡ä»¶ä¸­å†™æ­»æ¯ä¸ªç›‘æ§ç›®æ ‡çš„IPå’Œç«¯å£
K8så‘ç°ï¼šPrometheusä¸»åŠ¨å»K8sé›†ç¾¤ä¸­æ‰¾åˆ°æ‰€æœ‰å¯ç›‘æ§çš„ç›®æ ‡
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡å‘ç°**
```
å®¹å™¨åŒ–ç¯å¢ƒçš„ç‰¹ç‚¹ï¼š
âœ… Podéšæ—¶åˆ›å»ºå’Œé”€æ¯ â†’ IPåœ°å€ç»å¸¸å˜åŒ–
âœ… æœåŠ¡æ•°é‡åºå¤§ â†’ æ‰‹åŠ¨ç®¡ç†ä¸ç°å®  
âœ… åŠ¨æ€æ‰©ç¼©å®¹ â†’ ç›‘æ§ç›®æ ‡æ•°é‡å˜åŒ–
âœ… å¤šç¯å¢ƒéƒ¨ç½² â†’ éœ€è¦çµæ´»çš„å‘ç°æœºåˆ¶

æœåŠ¡å‘ç°è§£å†³çš„é—®é¢˜ï¼š
ğŸ¯ è‡ªåŠ¨å‘ç°æ–°çš„ç›‘æ§ç›®æ ‡
ğŸ¯ è‡ªåŠ¨ç§»é™¤å·²é”€æ¯çš„ç›®æ ‡
ğŸ¯ è·å–ç›®æ ‡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ ‡ç­¾ã€æ³¨è§£ç­‰ï¼‰
ğŸ¯ æ”¯æŒåŸºäºè§„åˆ™çš„è¿‡æ»¤
```

### 1.2 KubernetesæœåŠ¡å‘ç°çš„å·¥ä½œåŸç†


**ğŸ”§ å·¥ä½œæµç¨‹å›¾ç¤º**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prometheus    â”‚â”€â”€â”€â”€â”‚  Kubernetes     â”‚â”€â”€â”€â”€â”‚   ç›‘æ§ç›®æ ‡      â”‚
â”‚   é…ç½®æ–‡ä»¶      â”‚    â”‚   API Server    â”‚    â”‚  (Pod/Service)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚ 1.è¯»å–é…ç½®            â”‚ 3.æŸ¥è¯¢èµ„æºä¿¡æ¯        â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡å‘ç°ç»„ä»¶    â”‚â”€â”€â”€â”€â”‚   èµ„æºåˆ—è¡¨      â”‚â”€â”€â”€â”€â”‚   ç›®æ ‡åœ°å€      â”‚
â”‚ (SD Component)  â”‚    â”‚  (Pods/SVCs)    â”‚    â”‚  (IP:Port)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚ 2.APIè°ƒç”¨             â”‚ 4.è½¬æ¢ä¸ºç›®æ ‡          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ 5.å®šæœŸæ›´æ–°
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç›‘æ§ç›®æ ‡åˆ—è¡¨   â”‚
                    â”‚  (Target List)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å…³é”®ç†è§£è¦ç‚¹**
- **APIé©±åŠ¨**ï¼šé€šè¿‡K8s APIè·å–èµ„æºä¿¡æ¯ï¼Œä¸éœ€è¦ç›´æ¥è®¿é—®èŠ‚ç‚¹
- **å®æ—¶æ›´æ–°**ï¼šç›‘å¬K8säº‹ä»¶ï¼Œå®æ—¶æ›´æ–°ç›‘æ§ç›®æ ‡
- **æ ‡ç­¾ä¸°å¯Œ**ï¼šè‡ªåŠ¨è·å–K8sèµ„æºçš„æ ‡ç­¾å’Œæ³¨è§£
- **è§’è‰²åˆ’åˆ†**ï¼šæ”¯æŒä¸åŒç±»å‹çš„å‘ç°ï¼ˆPodã€Serviceã€Nodeç­‰ï¼‰

---

## 2. âš™ï¸ kubernetes_sd_configsé…ç½®è¯¦è§£


### 2.1 åŸºç¡€é…ç½®ç»“æ„


**ğŸ“‹ é…ç½®æ¨¡æ¿**
```yaml
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - api_server: 'https://kubernetes.default.svc:443'
        role: pod
        namespaces:
          names: ['default', 'kube-system']
        kubeconfig_file: '/etc/prometheus/kubeconfig'
```

**ğŸ”¸ æ ¸å¿ƒå‚æ•°è¯´æ˜**

| å‚æ•°å | **ä½œç”¨** | **ç¤ºä¾‹å€¼** | **æ˜¯å¦å¿…éœ€** |
|--------|----------|------------|-------------|
| `api_server` | `K8s APIæœåŠ¡å™¨åœ°å€` | `https://k8s-api:6443` | `å¯é€‰` |
| `role` | `å‘ç°çš„èµ„æºç±»å‹` | `pod/service/node` | `å¿…éœ€` |
| `namespaces` | `é™åˆ¶å‘ç°çš„å‘½åç©ºé—´` | `[default, app]` | `å¯é€‰` |
| `kubeconfig_file` | `è®¤è¯é…ç½®æ–‡ä»¶è·¯å¾„` | `/etc/kubeconfig` | `å¯é€‰` |

### 2.2 è®¤è¯é…ç½®è¯¦è§£


**ğŸ” é›†ç¾¤å†…éƒ¨ç½²ï¼ˆæ¨èï¼‰**
```yaml
kubernetes_sd_configs:
  - role: pod
    # ä½¿ç”¨ServiceAccountè‡ªåŠ¨è®¤è¯
    # æ— éœ€é¢å¤–é…ç½®ï¼ŒPrometheusè‡ªåŠ¨ä½¿ç”¨Podçš„SA
```

**ğŸ” é›†ç¾¤å¤–éƒ¨ç½²**
```yaml
kubernetes_sd_configs:
  - api_server: 'https://your-k8s-cluster:6443'
    role: pod
    kubeconfig_file: '/etc/prometheus/kubeconfig'
    # æˆ–è€…ä½¿ç”¨è¯ä¹¦è®¤è¯
    tls_config:
      ca_file: '/etc/ssl/ca.crt'
      cert_file: '/etc/ssl/client.crt'
      key_file: '/etc/ssl/client.key'
```

**ğŸ” Tokenè®¤è¯**
```yaml
kubernetes_sd_configs:
  - api_server: 'https://k8s-api:6443'
    role: pod
    authorization:
      type: Bearer
      credentials_file: '/var/run/secrets/kubernetes.io/serviceaccount/token'
```

### 2.3 é«˜çº§é…ç½®é€‰é¡¹


**âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```yaml
kubernetes_sd_configs:
  - role: pod
    # é€‰æ‹©å™¨è¿‡æ»¤ï¼Œå‡å°‘APIè°ƒç”¨
    selectors:
      - role: pod
        label: "app=web"
        field: "status.phase=Running"
    
    # è°ƒæ•´åˆ·æ–°é—´éš”
    refresh_interval: 30s
    
    # å¯ç”¨ç¼“å­˜
    enable_http2: true
```

---

## 3. ğŸ­ æœåŠ¡å‘ç°è§’è‰²ç±»å‹è¯¦è§£


### 3.1 Podè§’è‰²å‘ç°


**ğŸ”¸ Podå‘ç°æ¦‚è¿°**
```
ä½œç”¨ï¼šå‘ç°é›†ç¾¤ä¸­çš„æ‰€æœ‰Podä½œä¸ºç›‘æ§ç›®æ ‡
é€‚ç”¨åœºæ™¯ï¼šç›‘æ§åº”ç”¨å®¹å™¨ã€sidecarå®¹å™¨ç­‰
ä¼˜ç‚¹ï¼šæœ€ç›´æ¥çš„ç›‘æ§æ–¹å¼ï¼Œå¯ä»¥è·å–Podçš„è¯¦ç»†ä¿¡æ¯
```

**ğŸ“ Podå‘ç°é…ç½®ç¤ºä¾‹**
```yaml
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    
    # åªç›‘æ§æœ‰ç‰¹å®šæ³¨è§£çš„Pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      
      # ä½¿ç”¨Podæ³¨è§£ä¸­çš„ç«¯å£
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)
        replacement: ${1}
```

**ğŸ·ï¸ Podå‘ç°å¯ç”¨çš„å…ƒæ ‡ç­¾**

| å…ƒæ ‡ç­¾ | **å«ä¹‰** | **ç¤ºä¾‹å€¼** |
|--------|----------|-----------|
| `__meta_kubernetes_pod_name` | `Podåç§°` | `web-app-abc123` |
| `__meta_kubernetes_pod_namespace` | `Podå‘½åç©ºé—´` | `default` |
| `__meta_kubernetes_pod_ip` | `Pod IPåœ°å€` | `10.244.1.5` |
| `__meta_kubernetes_pod_label_<labelname>` | `Podæ ‡ç­¾` | `app=web` |
| `__meta_kubernetes_pod_annotation_<annotationname>` | `Podæ³¨è§£` | `version=1.0` |
| `__meta_kubernetes_pod_container_port_number` | `å®¹å™¨ç«¯å£å·` | `8080` |
| `__meta_kubernetes_pod_ready` | `Podå°±ç»ªçŠ¶æ€` | `true/false` |

### 3.2 Serviceè§’è‰²å‘ç°


**ğŸ”¸ Serviceå‘ç°æ¦‚è¿°**
```
ä½œç”¨ï¼šå‘ç°K8s Serviceä½œä¸ºç›‘æ§ç›®æ ‡
é€‚ç”¨åœºæ™¯ï¼šç›‘æ§æœåŠ¡çº§åˆ«çš„æŒ‡æ ‡ï¼Œè´Ÿè½½å‡è¡¡åçš„ç»Ÿä¸€å…¥å£
ç‰¹ç‚¹ï¼šç›‘æ§çš„æ˜¯Serviceçš„VIPï¼Œè€Œä¸æ˜¯å…·ä½“çš„Pod IP
```

**ğŸ“ Serviceå‘ç°é…ç½®ç¤ºä¾‹**
```yaml
scrape_configs:
  - job_name: 'kubernetes-services'
    kubernetes_sd_configs:
      - role: service
    
    relabel_configs:
      # åªç›‘æ§æœ‰metricsæ³¨è§£çš„Service
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      
      # è®¾ç½®metricsè·¯å¾„
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
```

**ğŸ·ï¸ Serviceå‘ç°å¯ç”¨çš„å…ƒæ ‡ç­¾**

| å…ƒæ ‡ç­¾ | **å«ä¹‰** | **ç¤ºä¾‹å€¼** |
|--------|----------|-----------|
| `__meta_kubernetes_service_name` | `Serviceåç§°` | `web-service` |
| `__meta_kubernetes_service_namespace` | `Serviceå‘½åç©ºé—´` | `default` |
| `__meta_kubernetes_service_cluster_ip` | `Serviceé›†ç¾¤IP` | `10.96.1.100` |
| `__meta_kubernetes_service_port_number` | `Serviceç«¯å£å·` | `80` |
| `__meta_kubernetes_service_type` | `Serviceç±»å‹` | `ClusterIP` |

### 3.3 Nodeè§’è‰²å‘ç°


**ğŸ”¸ Nodeå‘ç°æ¦‚è¿°**
```
ä½œç”¨ï¼šå‘ç°K8sé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹
é€‚ç”¨åœºæ™¯ï¼šç›‘æ§èŠ‚ç‚¹çº§åˆ«çš„æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰
ç›‘æ§å¯¹è±¡ï¼šé€šå¸¸æ˜¯node-exporterç­‰èŠ‚ç‚¹çº§ç›‘æ§ç»„ä»¶
```

**ğŸ“ Nodeå‘ç°é…ç½®ç¤ºä¾‹**
```yaml
scrape_configs:
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    
    relabel_configs:
      # ä½¿ç”¨èŠ‚ç‚¹å†…ç½‘IP
      - source_labels: [__meta_kubernetes_node_address_InternalIP]
        target_label: __address__
        replacement: '${1}:9100'  # node-exporterç«¯å£
      
      # æ·»åŠ èŠ‚ç‚¹åç§°æ ‡ç­¾
      - source_labels: [__meta_kubernetes_node_name]
        target_label: instance
```

**ğŸ·ï¸ Nodeå‘ç°å¯ç”¨çš„å…ƒæ ‡ç­¾**

| å…ƒæ ‡ç­¾ | **å«ä¹‰** | **ç¤ºä¾‹å€¼** |
|--------|----------|-----------|
| `__meta_kubernetes_node_name` | `èŠ‚ç‚¹åç§°` | `worker-1` |
| `__meta_kubernetes_node_address_InternalIP` | `èŠ‚ç‚¹å†…ç½‘IP` | `192.168.1.10` |
| `__meta_kubernetes_node_address_ExternalIP` | `èŠ‚ç‚¹å¤–ç½‘IP` | `203.0.113.10` |
| `__meta_kubernetes_node_label_<labelname>` | `èŠ‚ç‚¹æ ‡ç­¾` | `zone=us-west-1a` |

### 3.4 Endpointsè§’è‰²å‘ç°


**ğŸ”¸ Endpointså‘ç°æ¦‚è¿°**
```
ä½œç”¨ï¼šå‘ç°ServiceèƒŒåçš„å®é™…ç«¯ç‚¹ï¼ˆPod IPï¼‰
é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ç›‘æ§Serviceä¸‹æ¯ä¸ªPodçš„ç‹¬ç«‹æŒ‡æ ‡
ä¸Podå‘ç°çš„åŒºåˆ«ï¼šé€šè¿‡Serviceå…³è”ï¼Œå¯ä»¥è·å–Serviceç›¸å…³ä¿¡æ¯
```

**ğŸ“ Endpointså‘ç°é…ç½®ç¤ºä¾‹**
```yaml
scrape_configs:
  - job_name: 'kubernetes-endpoints'
    kubernetes_sd_configs:
      - role: endpoints
    
    relabel_configs:
      # åªç›‘æ§æœ‰æ³¨è§£çš„endpoints
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      
      # è®¾ç½®jobæ ‡ç­¾ä¸ºserviceåç§°
      - source_labels: [__meta_kubernetes_service_name]
        target_label: job
```

---

## 4. ğŸ·ï¸ æ ‡ç­¾æ˜ å°„æœºåˆ¶æ·±å…¥ç†è§£


### 4.1 æ ‡ç­¾æ˜ å°„çš„å·¥ä½œåŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ ‡ç­¾æ˜ å°„**
```
ç®€å•ç†è§£ï¼šæŠŠK8sèµ„æºçš„ä¿¡æ¯"ç¿»è¯‘"æˆPrometheusèƒ½ç†è§£çš„æ ‡ç­¾
ä½œç”¨ï¼šè®©Prometheusèƒ½å¤Ÿæ ¹æ®K8sçš„æ ‡ç­¾ã€æ³¨è§£ç­‰ä¿¡æ¯è¿›è¡Œç›‘æ§å’Œå‘Šè­¦

K8sèµ„æºä¿¡æ¯ â†’ å…ƒæ ‡ç­¾ â†’ relabelå¤„ç† â†’ æœ€ç»ˆæ ‡ç­¾
    â†“              â†“           â†“          â†“
Podæ ‡ç­¾app=web â†’ __meta_... â†’ é‡æ–°æ ‡è®° â†’ job=web
```

**ğŸ“Š æ ‡ç­¾è½¬æ¢æµç¨‹å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   K8sèµ„æº       â”‚    â”‚     å…ƒæ ‡ç­¾      â”‚    â”‚   æœ€ç»ˆæ ‡ç­¾      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ labels:         â”‚â”€â”€â”€â–¶â”‚ __meta_k8s_     â”‚â”€â”€â”€â–¶â”‚ job: web        â”‚
â”‚   app: web      â”‚    â”‚ pod_label_app   â”‚    â”‚ instance: pod-1 â”‚
â”‚   version: 1.0  â”‚    â”‚ pod_label_ver   â”‚    â”‚ version: 1.0    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ annotations:    â”‚    â”‚ __meta_k8s_     â”‚    â”‚                 â”‚
â”‚   port: "8080"  â”‚    â”‚ pod_annotation  â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å¸¸ç”¨çš„relabelé…ç½®æ¨¡å¼


**ğŸ¯ ä¿ç•™ç‰¹å®šç›®æ ‡**
```yaml
relabel_configs:
  # åªç›‘æ§æœ‰scrapeæ³¨è§£ä¸”å€¼ä¸ºtrueçš„Pod
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
    action: keep
    regex: true
```

**ğŸ¯ æ›¿æ¢ç›®æ ‡åœ°å€**
```yaml
relabel_configs:
  # ä½¿ç”¨æ³¨è§£ä¸­æŒ‡å®šçš„ç«¯å£
  - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
    action: replace
    target_label: __address__
    regex: (.+);(.+)
    replacement: ${1}:${2}
```

**ğŸ¯ è®¾ç½®ç›‘æ§è·¯å¾„**
```yaml
relabel_configs:
  # ä½¿ç”¨æ³¨è§£ä¸­çš„metricsè·¯å¾„
  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
    action: replace
    target_label: __metrics_path__
    regex: (.+)
    replacement: ${1}
```

**ğŸ¯ åˆ›å»ºè‡ªå®šä¹‰æ ‡ç­¾**
```yaml
relabel_configs:
  # å°†Podåç§°è®¾ç½®ä¸ºinstanceæ ‡ç­¾
  - source_labels: [__meta_kubernetes_pod_name]
    action: replace
    target_label: instance
  
  # å°†åº”ç”¨åç§°è®¾ç½®ä¸ºjobæ ‡ç­¾
  - source_labels: [__meta_kubernetes_pod_label_app]
    action: replace
    target_label: job
```

### 4.3 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ“ å®Œæ•´çš„Podç›‘æ§é…ç½®**
```yaml
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    
    relabel_configs:
      # 1. åªç›‘æ§æœ‰prometheus.io/scrape=trueæ³¨è§£çš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      
      # 2. è·³è¿‡æ²¡æœ‰ç«¯å£æ³¨è§£çš„Pod
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_port]
        action: keep
        regex: .+
      
      # 3. è®¾ç½®ç›‘æ§åœ°å€ï¼ˆPod IP + æ³¨è§£ç«¯å£ï¼‰
      - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+);(.+)
        replacement: ${1}:${2}
      
      # 4. è®¾ç½®metricsè·¯å¾„
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
        replacement: ${1}
      
      # 5. è®¾ç½®jobæ ‡ç­¾ä¸ºåº”ç”¨åç§°
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: job
      
      # 6. æ·»åŠ å‘½åç©ºé—´æ ‡ç­¾
      - source_labels: [__meta_kubernetes_pod_namespace]
        action: replace
        target_label: kubernetes_namespace
      
      # 7. æ·»åŠ Podåç§°æ ‡ç­¾
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
```

**ğŸ“‹ å¯¹åº”çš„Podæ³¨è§£ç¤ºä¾‹**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-app
  labels:
    app: web
  annotations:
    prometheus.io/scrape: "true"    # å¯ç”¨ç›‘æ§
    prometheus.io/port: "8080"      # ç›‘æ§ç«¯å£
    prometheus.io/path: "/metrics"  # metricsè·¯å¾„
spec:
  containers:
  - name: web
    image: nginx
    ports:
    - containerPort: 8080
```

---

## 5. ğŸ“ å‘½åç©ºé—´è¿‡æ»¤é…ç½®


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦å‘½åç©ºé—´è¿‡æ»¤


**ğŸ¯ å‘½åç©ºé—´è¿‡æ»¤çš„å¿…è¦æ€§**
```
é—®é¢˜åœºæ™¯ï¼š
âŒ é›†ç¾¤ä¸­æœ‰å‡ åä¸ªå‘½åç©ºé—´ï¼Œä¸éœ€è¦å…¨éƒ¨ç›‘æ§
âŒ æŸäº›å‘½åç©ºé—´æ˜¯æµ‹è¯•ç¯å¢ƒï¼Œä¼šäº§ç”Ÿå™ªéŸ³
âŒ æ•æ„Ÿå‘½åç©ºé—´ä¸åº”è¯¥è¢«ç›‘æ§
âŒ ç›‘æ§æ‰€æœ‰å‘½åç©ºé—´ä¼šæ¶ˆè€—å¤§é‡èµ„æº

è§£å†³æ–¹æ¡ˆï¼š
âœ… åªç›‘æ§æŒ‡å®šçš„å‘½åç©ºé—´
âœ… æ’é™¤ç‰¹å®šçš„å‘½åç©ºé—´  
âœ… ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çµæ´»è¿‡æ»¤
âœ… é’ˆå¯¹ä¸åŒjobé…ç½®ä¸åŒçš„å‘½åç©ºé—´
```

### 5.2 å‘½åç©ºé—´è¿‡æ»¤é…ç½®æ–¹æ³•


**ğŸ”¸ æŒ‡å®šç›‘æ§çš„å‘½åç©ºé—´**
```yaml
kubernetes_sd_configs:
  - role: pod
    namespaces:
      names:
        - default
        - production
        - monitoring
```

**ğŸ”¸ æ’é™¤ç‰¹å®šå‘½åç©ºé—´**
```yaml
kubernetes_sd_configs:
  - role: pod
    # ç›‘æ§æ‰€æœ‰å‘½åç©ºé—´ï¼Œä½†é€šè¿‡relabelæ’é™¤
    
relabel_configs:
  # æ’é™¤kube-systemå‘½åç©ºé—´
  - source_labels: [__meta_kubernetes_pod_namespace]
    action: drop
    regex: kube-system
```

**ğŸ”¸ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤**
```yaml
relabel_configs:
  # åªç›‘æ§ä»¥prod-å¼€å¤´çš„å‘½åç©ºé—´
  - source_labels: [__meta_kubernetes_pod_namespace]
    action: keep
    regex: prod-.*
  
  # æˆ–è€…æ’é™¤ä»¥test-å¼€å¤´çš„å‘½åç©ºé—´
  - source_labels: [__meta_kubernetes_pod_namespace]
    action: drop
    regex: test-.*
```

### 5.3 å¤šç¯å¢ƒå‘½åç©ºé—´ç®¡ç†


**ğŸ“Š ç¯å¢ƒéš”ç¦»é…ç½®ç¤ºä¾‹**
```yaml
scrape_configs:
  # ç”Ÿäº§ç¯å¢ƒç›‘æ§
  - job_name: 'prod-apps'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['prod-web', 'prod-api', 'prod-db']
    
    relabel_configs:
      - target_label: environment
        replacement: production
  
  # æµ‹è¯•ç¯å¢ƒç›‘æ§
  - job_name: 'test-apps'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['test-web', 'test-api']
    
    relabel_configs:
      - target_label: environment
        replacement: testing
    
    # æµ‹è¯•ç¯å¢ƒé™ä½é‡‡é›†é¢‘ç‡
    scrape_interval: 60s
```

---

## 6. ğŸ” RBACæƒé™é…ç½®å®æˆ˜


### 6.1 RBACæƒé™çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦RBAC**
```
å®‰å…¨é—®é¢˜ï¼š
âŒ Prometheuséœ€è¦è®¿é—®K8s APIè·å–èµ„æºä¿¡æ¯
âŒ é»˜è®¤æƒ…å†µä¸‹Podæ²¡æœ‰è®¿é—®APIçš„æƒé™
âŒ è¿‡åº¦æˆæƒå¯èƒ½å¸¦æ¥å®‰å…¨é£é™©

è§£å†³æ–¹æ¡ˆï¼š
âœ… åˆ›å»ºä¸“ç”¨ServiceAccount
âœ… é…ç½®æœ€å°åŒ–æƒé™
âœ… ç»‘å®šåˆ°Prometheus Pod
âœ… å®šæœŸå®¡æŸ¥æƒé™
```

### 6.2 Prometheusç›‘æ§æ‰€éœ€çš„æœ€å°æƒé™


**ğŸ“‹ å¿…éœ€çš„APIæƒé™åˆ—è¡¨**

| èµ„æºç±»å‹ | **æƒé™** | **ç”¨é€”** |
|----------|----------|----------|
| `pods` | `get, list, watch` | `å‘ç°å’Œç›‘æ§Pod` |
| `services` | `get, list, watch` | `å‘ç°Service` |
| `endpoints` | `get, list, watch` | `å‘ç°Serviceç«¯ç‚¹` |
| `nodes` | `get, list, watch` | `å‘ç°å’Œç›‘æ§èŠ‚ç‚¹` |
| `namespaces` | `get, list, watch` | `å‘½åç©ºé—´ä¿¡æ¯` |

### 6.3 RBACé…ç½®å®æˆ˜


**ğŸ”§ å®Œæ•´çš„RBACé…ç½®**
```yaml
# 1. åˆ›å»ºServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring

---
# 2. åˆ›å»ºClusterRoleå®šä¹‰æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-role
rules:
- apiGroups: [""]
  resources:
    - nodes
    - nodes/proxy
    - nodes/metrics
    - services
    - endpoints
    - pods
    - namespaces
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources:
    - ingresses
  verbs: ["get", "list", "watch"]

---
# 3. ç»‘å®šæƒé™åˆ°ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-role
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring
```

**ğŸ”§ Prometheuséƒ¨ç½²é…ç½®**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  template:
    spec:
      # ä½¿ç”¨åˆ›å»ºçš„ServiceAccount
      serviceAccountName: prometheus
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        # Prometheusä¼šè‡ªåŠ¨ä½¿ç”¨Podçš„ServiceAccount Token
```

### 6.4 æƒé™éªŒè¯å’Œæ•…éšœæ’é™¤


**ğŸ” æƒé™éªŒè¯å‘½ä»¤**
```bash
# éªŒè¯ServiceAccountæ˜¯å¦æœ‰æ­£ç¡®æƒé™
kubectl auth can-i get pods --as=system:serviceaccount:monitoring:prometheus

# æ£€æŸ¥ServiceAccountç»‘å®š
kubectl describe clusterrolebinding prometheus-binding

# æŸ¥çœ‹ServiceAccountè¯¦æƒ…
kubectl describe serviceaccount prometheus -n monitoring
```

**âš ï¸ å¸¸è§æƒé™é—®é¢˜**

> **âŒ é”™è¯¯ï¼š403 Forbidden**
> 
> åŸå› ï¼šServiceAccountæ²¡æœ‰è¶³å¤Ÿæƒé™
> è§£å†³ï¼šæ£€æŸ¥ClusterRoleå’ŒClusterRoleBindingé…ç½®

> **âŒ é”™è¯¯ï¼šæ— æ³•å‘ç°ç›®æ ‡**
> 
> åŸå› ï¼šå¯èƒ½æ˜¯æƒé™é—®é¢˜æˆ–ç½‘ç»œé—®é¢˜
> è§£å†³ï¼šæ£€æŸ¥RBACé…ç½®å’Œç½‘ç»œç­–ç•¥

> **ğŸ’¡ æœ€ä½³å®è·µæç¤º**
> 
> - ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
> - å®šæœŸå®¡æŸ¥å’Œæ›´æ–°æƒé™
> - ä¸ºä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„ServiceAccount
> - è®°å½•æƒé™å˜æ›´å†å²

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡å‘ç°æœ¬è´¨ï¼šPrometheusè‡ªåŠ¨ä»K8sä¸­å‘ç°ç›‘æ§ç›®æ ‡
ğŸ”¸ å››ç§å‘ç°è§’è‰²ï¼šPodã€Serviceã€Nodeã€Endpointså„æœ‰ç”¨é€”
ğŸ”¸ æ ‡ç­¾æ˜ å°„æœºåˆ¶ï¼šå°†K8sèµ„æºä¿¡æ¯è½¬æ¢ä¸ºPrometheusæ ‡ç­¾
ğŸ”¸ å‘½åç©ºé—´è¿‡æ»¤ï¼šæ§åˆ¶ç›‘æ§èŒƒå›´ï¼Œæé«˜æ•ˆç‡
ğŸ”¸ RBACæƒé™ï¼šç¡®ä¿Prometheusæœ‰è¶³å¤Ÿä½†ä¸è¿‡åº¦çš„æƒé™
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è§’è‰²é€‰æ‹©æŒ‡å—**
```
é€‰æ‹©Podå‘ç°ï¼š
âœ… éœ€è¦ç›‘æ§æ¯ä¸ªå®¹å™¨çš„ç‹¬ç«‹æŒ‡æ ‡
âœ… éœ€è¦è·å–Podçº§åˆ«çš„è¯¦ç»†ä¿¡æ¯
âœ… ç›‘æ§åº”ç”¨å®¹å™¨ã€sidecarç­‰

é€‰æ‹©Serviceå‘ç°ï¼š
âœ… ç›‘æ§æœåŠ¡çº§åˆ«çš„ç»Ÿä¸€æŒ‡æ ‡
âœ… éœ€è¦è´Ÿè½½å‡è¡¡åçš„ç»Ÿä¸€å…¥å£
âœ… ç›‘æ§å¤–éƒ¨æš´éœ²çš„æœåŠ¡

é€‰æ‹©Nodeå‘ç°ï¼š
âœ… ç›‘æ§èŠ‚ç‚¹çº§åˆ«çš„ç³»ç»ŸæŒ‡æ ‡
âœ… ç›‘æ§node-exporterç­‰èŠ‚ç‚¹ç»„ä»¶
âœ… åŸºç¡€è®¾æ–½ç›‘æ§

é€‰æ‹©Endpointså‘ç°ï¼š
âœ… éœ€è¦Serviceä¿¡æ¯ä½†ç›‘æ§å…·ä½“Pod
âœ… å¤æ‚çš„æœåŠ¡æ‹“æ‰‘ç›‘æ§
âœ… å¾®æœåŠ¡æ¶æ„ç›‘æ§
```

**ğŸ”¹ é…ç½®ä¼˜åŒ–åŸåˆ™**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨å‘½åç©ºé—´è¿‡æ»¤å‡å°‘APIè°ƒç”¨
â€¢ åˆç†è®¾ç½®refresh_interval
â€¢ ä½¿ç”¨é€‰æ‹©å™¨é¢„è¿‡æ»¤èµ„æº

å®‰å…¨ä¼˜åŒ–ï¼š
â€¢ é…ç½®æœ€å°åŒ–RBACæƒé™
â€¢ ä½¿ç”¨ä¸“ç”¨ServiceAccount
â€¢ å®šæœŸå®¡æŸ¥æƒé™é…ç½®

ç®¡ç†ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨æ³¨è§£æ§åˆ¶ç›‘æ§è¡Œä¸º
â€¢ ç»Ÿä¸€æ ‡ç­¾å‘½åè§„èŒƒ
â€¢ åˆ†ç¯å¢ƒé…ç½®ä¸åŒç­–ç•¥
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š é…ç½®æ¨¡æ¿å‚è€ƒ**
```yaml
# é€šç”¨Podç›‘æ§æ¨¡æ¿
scrape_configs:
  - job_name: 'k8s-pods'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names: ['default', 'production']
    
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+);(.+)
        replacement: ${1}:${2}
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: job
```

**ğŸ¯ æ•…éšœæ’é™¤æ¸…å•**
- [ ] æ£€æŸ¥RBACæƒé™æ˜¯å¦æ­£ç¡®é…ç½®
- [ ] éªŒè¯ServiceAccountæ˜¯å¦ç»‘å®šåˆ°Pod
- [ ] ç¡®è®¤API Serveråœ°å€å’Œè®¤è¯é…ç½®
- [ ] æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™è§„åˆ™
- [ ] éªŒè¯ç›®æ ‡Podçš„æ³¨è§£é…ç½®
- [ ] æŸ¥çœ‹Prometheusæ—¥å¿—æ’æŸ¥å…·ä½“é”™è¯¯

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- ğŸ¯ ä»ç®€å•é…ç½®å¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¤æ‚è§„åˆ™
- ğŸ“Š ä½¿ç”¨Prometheus UIéªŒè¯å‘ç°çš„ç›®æ ‡
- ğŸ” å®šæœŸæ£€æŸ¥å’Œä¼˜åŒ–relabelè§„åˆ™
- ğŸ“ ä¸ºæ¯ä¸ªé…ç½®æ·»åŠ æ¸…æ™°çš„æ³¨é‡Š
- ğŸ”„ å»ºç«‹é…ç½®å˜æ›´çš„æµ‹è¯•æµç¨‹

**æ ¸å¿ƒè®°å¿†**ï¼š
- K8sæœåŠ¡å‘ç°è®©ç›‘æ§å˜å¾—æ™ºèƒ½å’Œè‡ªåŠ¨åŒ–
- å››ç§è§’è‰²coverä¸åŒçš„ç›‘æ§éœ€æ±‚
- æ ‡ç­¾æ˜ å°„æ˜¯è¿æ¥K8så’ŒPrometheusçš„æ¡¥æ¢
- æ­£ç¡®çš„RBACé…ç½®æ˜¯å®‰å…¨ç›‘æ§çš„åŸºç¡€