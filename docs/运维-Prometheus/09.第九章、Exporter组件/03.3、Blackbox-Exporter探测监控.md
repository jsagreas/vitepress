---
title: 3ã€Blackbox-Exporteræ¢æµ‹ç›‘æ§
---
## ğŸ“š ç›®å½•

1. [Blackbox-ExporteråŸºç¡€æ¦‚å¿µ](#1-Blackbox-ExporteråŸºç¡€æ¦‚å¿µ)
2. [æ ¸å¿ƒåŠŸèƒ½å’Œæ¢æµ‹ç±»å‹](#2-æ ¸å¿ƒåŠŸèƒ½å’Œæ¢æµ‹ç±»å‹)
3. [å®‰è£…å’ŒåŸºç¡€é…ç½®](#3-å®‰è£…å’ŒåŸºç¡€é…ç½®)
4. [HTTPæ¢æµ‹è¯¦è§£](#4-HTTPæ¢æµ‹è¯¦è§£)
5. [ICMP Pingç›‘æ§](#5-ICMP-Pingç›‘æ§)
6. [TCPç«¯å£æ£€æµ‹](#6-TCPç«¯å£æ£€æµ‹)
7. [DNSæŸ¥è¯¢ç›‘æ§](#7-DNSæŸ¥è¯¢ç›‘æ§)
8. [SSLè¯ä¹¦ç›‘æ§](#8-SSLè¯ä¹¦ç›‘æ§)
9. [é«˜çº§é…ç½®å’Œä¼˜åŒ–](#9-é«˜çº§é…ç½®å’Œä¼˜åŒ–)
10. [å‘Šè­¦è§„åˆ™å’ŒSLAç›‘æ§](#10-å‘Šè­¦è§„åˆ™å’ŒSLAç›‘æ§)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Blackbox-ExporteråŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Blackbox-Exporter


**ç®€å•ç†è§£ï¼šæ¢æµ‹å¤–éƒ¨æœåŠ¡çš„å¥åº·æ£€æŸ¥å·¥å…·**

æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªç½‘ç«™ç®¡ç†å‘˜ï¼Œéœ€è¦çŸ¥é“ï¼š
- ğŸ“± ç”¨æˆ·èƒ½å¦æ­£å¸¸è®¿é—®ä½ çš„ç½‘ç«™ï¼Ÿ
- âš¡ ç½‘ç«™å“åº”é€Ÿåº¦å¿«ä¸å¿«ï¼Ÿ
- ğŸ” SSLè¯ä¹¦æ˜¯å¦å³å°†è¿‡æœŸï¼Ÿ
- ğŸŒ DNSè§£ææ˜¯å¦æ­£å¸¸ï¼Ÿ

```
ä¼ ç»Ÿç›‘æ§ vs Blackboxç›‘æ§ï¼š

ä¼ ç»Ÿç›‘æ§ï¼ˆç™½ç›’ç›‘æ§ï¼‰ï¼š
çœ‹æœåŠ¡å™¨å†…éƒ¨ â†’ CPUã€å†…å­˜ã€ç£ç›˜
å°±åƒåŒ»ç”Ÿç”¨Xå…‰çœ‹èº«ä½“å†…éƒ¨

Blackboxç›‘æ§ï¼ˆé»‘ç›’ç›‘æ§ï¼‰ï¼š
ç«™åœ¨ç”¨æˆ·è§’åº¦ â†’ èƒ½å¦è®¿é—®ã€å“åº”å¿«æ…¢
å°±åƒç—…äººæè¿°ç—‡çŠ¶æ„Ÿå—
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Šï¼š**
- **Blackbox**ï¼šé»‘ç›’ï¼Œä¸å…³å¿ƒå†…éƒ¨å¦‚ä½•å·¥ä½œï¼Œåªçœ‹ç»“æœ
- **Exporter**ï¼šå¯¼å‡ºå™¨ï¼ŒæŠŠç›‘æ§æ•°æ®è½¬æ¢æˆPrometheusèƒ½ç†è§£çš„æ ¼å¼
- **æ¢æµ‹**ï¼šä¸»åŠ¨å»æ£€æŸ¥ç›®æ ‡æœåŠ¡æ˜¯å¦æ­£å¸¸

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Blackboxç›‘æ§


**çœŸå®åœºæ™¯ä¸¾ä¾‹ï¼š**

```
åœºæ™¯1ï¼šç”µå•†ç½‘ç«™
é—®é¢˜ï¼šæœåŠ¡å™¨CPUã€å†…å­˜éƒ½æ­£å¸¸ï¼Œä½†ç”¨æˆ·åæ˜ ç½‘ç«™æ‰“ä¸å¼€
åŸå› ï¼šDNSè§£ææ•…éšœï¼Œç”¨æˆ·æ— æ³•è®¿é—®
è§£å†³ï¼šç”¨Blackboxæ£€æµ‹DNSå’ŒHTTPå¯ç”¨æ€§

åœºæ™¯2ï¼šAPIæœåŠ¡
é—®é¢˜ï¼šåç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ï¼Œä½†å‰ç«¯æŠ¥é”™
åŸå› ï¼šç½‘ç»œå»¶è¿Ÿè¿‡é«˜ï¼ŒAPIå“åº”è¶…æ—¶
è§£å†³ï¼šç”¨Blackboxç›‘æ§APIå“åº”æ—¶é—´

åœºæ™¯3ï¼šHTTPSç½‘ç«™
é—®é¢˜ï¼šç”¨æˆ·è®¿é—®æç¤ºè¯ä¹¦é”™è¯¯
åŸå› ï¼šSSLè¯ä¹¦è¿‡æœŸäº†
è§£å†³ï¼šç”¨Blackboxæå‰ç›‘æ§è¯ä¹¦åˆ°æœŸæ—¶é—´
```

### 1.3 Blackboxç›‘æ§çš„ä»·å€¼


**ğŸ¯ ç›‘æ§ä»·å€¼å¯¹æ¯”ï¼š**

| ç›‘æ§ç±»å‹ | **å…³æ³¨ç‚¹** | **å‘ç°é—®é¢˜** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|-------------|-------------|
| **å†…éƒ¨ç›‘æ§** | `æœåŠ¡å™¨æŒ‡æ ‡` | `èµ„æºç“¶é¢ˆã€ç¨‹åºé”™è¯¯` | `è¿ç»´äººå‘˜æ’æŸ¥` |
| **Blackboxç›‘æ§** | `ç”¨æˆ·ä½“éªŒ` | `å¯ç”¨æ€§ã€æ€§èƒ½é—®é¢˜` | `ä¸šåŠ¡ç›‘æ§ã€SLA` |
| **ç»„åˆç›‘æ§** | `å…¨æ–¹ä½` | `å¿«é€Ÿå®šä½æ ¹å› ` | `ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ` |

---

## 2. âš™ï¸ æ ¸å¿ƒåŠŸèƒ½å’Œæ¢æµ‹ç±»å‹


### 2.1 äº”ç§ä¸»è¦æ¢æµ‹æ–¹å¼


**ğŸŒ HTTPæ¢æµ‹ï¼šç½‘ç«™å’ŒAPIç›‘æ§**
```
æ£€æŸ¥å†…å®¹ï¼š
âœ… ç½‘ç«™æ˜¯å¦èƒ½è®¿é—®
âœ… å“åº”çŠ¶æ€ç æ˜¯å¦æ­£ç¡®
âœ… å“åº”æ—¶é—´æ˜¯å¦åˆç†
âœ… é¡µé¢å†…å®¹æ˜¯å¦åŒ…å«å…³é”®å­—
âœ… SSLè¯ä¹¦æ˜¯å¦æœ‰æ•ˆ

å®é™…åº”ç”¨ï¼š
- ç”µå•†é¦–é¡µå¯ç”¨æ€§
- APIæ¥å£å“åº”æ£€æŸ¥
- ç™»å½•é¡µé¢åŠŸèƒ½éªŒè¯
```

**ğŸ“ ICMPæ¢æµ‹ï¼šç½‘ç»œè¿é€šæ€§æ£€æŸ¥**
```
æ£€æŸ¥å†…å®¹ï¼š
âœ… ç›®æ ‡ä¸»æœºæ˜¯å¦åœ¨çº¿
âœ… ç½‘ç»œå»¶è¿Ÿå¤šå°‘
âœ… æ•°æ®åŒ…ä¸¢å¤±ç‡
âœ… ç½‘ç»œè·¯å¾„æ˜¯å¦é€šç•…

å®é™…åº”ç”¨ï¼š
- æœåŠ¡å™¨ç½‘ç»œçŠ¶æ€
- è·¨æœºæˆ¿è¿é€šæ€§
- ç½‘ç»œæ•…éšœè¯Šæ–­
```

**ğŸ”Œ TCPæ¢æµ‹ï¼šç«¯å£æœåŠ¡æ£€æŸ¥**
```
æ£€æŸ¥å†…å®¹ï¼š
âœ… ç«¯å£æ˜¯å¦å¼€æ”¾
âœ… æœåŠ¡æ˜¯å¦åœ¨ç›‘å¬
âœ… è¿æ¥å»ºç«‹æ—¶é—´
âœ… è¿æ¥æ˜¯å¦ç¨³å®š

å®é™…åº”ç”¨ï¼š
- æ•°æ®åº“è¿æ¥æ£€æŸ¥
- æ¶ˆæ¯é˜Ÿåˆ—çŠ¶æ€
- å¾®æœåŠ¡ç«¯å£ç›‘æ§
```

**ğŸ“‹ DNSæ¢æµ‹ï¼šåŸŸåè§£æç›‘æ§**
```
æ£€æŸ¥å†…å®¹ï¼š
âœ… åŸŸåæ˜¯å¦èƒ½è§£æ
âœ… è§£æç»“æœæ˜¯å¦æ­£ç¡®
âœ… è§£ææ—¶é—´æ˜¯å¦æ­£å¸¸
âœ… DNSæœåŠ¡å™¨æ˜¯å¦å¯ç”¨

å®é™…åº”ç”¨ï¼š
- ç½‘ç«™åŸŸåè§£æ
- CDNè§£ææ£€æŸ¥
- å†…éƒ¨DNSæœåŠ¡
```

**ğŸ” SSLæ¢æµ‹ï¼šè¯ä¹¦å®‰å…¨æ£€æŸ¥**
```
æ£€æŸ¥å†…å®¹ï¼š
âœ… è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
âœ… è¯ä¹¦åˆ°æœŸæ—¶é—´
âœ… è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´
âœ… åŠ å¯†å¼ºåº¦æ˜¯å¦è¶³å¤Ÿ

å®é™…åº”ç”¨ï¼š
- HTTPSç½‘ç«™è¯ä¹¦
- APIæ¥å£å®‰å…¨
- è¯ä¹¦åˆ°æœŸæé†’
```

### 2.2 æ¢æµ‹å·¥ä½œåŸç†


**æ¢æµ‹æµç¨‹å›¾ç¤ºï¼š**

```
ç”¨æˆ·è¯·æ±‚ â†’ Blackbox-Exporter â†’ ç›®æ ‡æœåŠ¡
    â†‘              â†“                â†“
Prometheus â† æ¢æµ‹ç»“æœæŒ‡æ ‡ â† æ¢æµ‹å“åº”

è¯¦ç»†æ­¥éª¤ï¼š
1. Prometheusè°ƒç”¨Blackbox-Exporter
2. æŒ‡å®šæ¢æµ‹ç›®æ ‡å’Œæ¢æµ‹ç±»å‹
3. Blackboxæ‰§è¡Œå®é™…æ¢æµ‹
4. æ”¶é›†å“åº”æ—¶é—´ã€çŠ¶æ€ç­‰æ•°æ®
5. è½¬æ¢ä¸ºPrometheusæŒ‡æ ‡æ ¼å¼
6. è¿”å›ç»™Prometheuså­˜å‚¨
```

---

## 3. ğŸ“¦ å®‰è£…å’ŒåŸºç¡€é…ç½®


### 3.1 å®‰è£…Blackbox-Exporter


**Dockeræ–¹å¼å®‰è£…ï¼ˆæ¨èæ–°æ‰‹ï¼‰ï¼š**

```bash
# ä¸‹è½½å¹¶è¿è¡ŒBlackbox-Exporter
docker run -d \
  --name blackbox-exporter \
  -p 9115:9115 \
  prom/blackbox-exporter:latest
```

**äºŒè¿›åˆ¶å®‰è£…ï¼š**

```bash
# ä¸‹è½½
wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.24.0/blackbox_exporter-0.24.0.linux-amd64.tar.gz

# è§£å‹
tar -xzf blackbox_exporter-0.24.0.linux-amd64.tar.gz

# è¿è¡Œ
./blackbox_exporter --config.file=blackbox.yml
```

### 3.2 åŸºç¡€é…ç½®æ–‡ä»¶


**åˆ›å»ºblackbox.ymlé…ç½®æ–‡ä»¶ï¼š**

```yaml
modules:
  # HTTPæ¢æµ‹æ¨¡å— - æ£€æŸ¥ç½‘ç«™æ˜¯å¦æ­£å¸¸
  http_2xx:
    prober: http
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200]  # åªæ¥å—200çŠ¶æ€ç 
      method: GET
      
  # ICMPæ¢æµ‹æ¨¡å— - æ£€æŸ¥ç½‘ç»œè¿é€šæ€§  
  icmp:
    prober: icmp
    
  # TCPæ¢æµ‹æ¨¡å— - æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
  tcp_connect:
    prober: tcp
    
  # DNSæ¢æµ‹æ¨¡å— - æ£€æŸ¥åŸŸåè§£æ
  dns:
    prober: dns
    dns:
      query_name: "example.com"
      query_type: "A"
```

**é…ç½®æ–‡ä»¶è§£é‡Šï¼š**
- **modules**ï¼šå®šä¹‰ä¸åŒçš„æ¢æµ‹æ¨¡å—
- **prober**ï¼šæŒ‡å®šæ¢æµ‹ç±»å‹ï¼ˆhttpã€icmpã€tcpã€dnsï¼‰
- **http**ï¼šHTTPæ¢æµ‹çš„å…·ä½“é…ç½®
- **valid_status_codes**ï¼šæœŸæœ›çš„HTTPçŠ¶æ€ç 

### 3.3 éªŒè¯å®‰è£…


**æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š**

```bash
# è®¿é—®Webç•Œé¢
curl http://localhost:9115

# æµ‹è¯•HTTPæ¢æµ‹
curl "http://localhost:9115/probe?module=http_2xx&target=http://example.com"

# æ£€æŸ¥é…ç½®
curl http://localhost:9115/config
```

**ğŸ” éªŒè¯æˆåŠŸæ ‡å¿—ï¼š**
- èƒ½è®¿é—®`:9115`ç«¯å£
- æ¢æµ‹è¿”å›`probe_success 1`
- é…ç½®é¡µé¢æ˜¾ç¤ºæ­£å¸¸

---

## 4. ğŸŒ HTTPæ¢æµ‹è¯¦è§£


### 4.1 åŸºç¡€HTTPæ¢æµ‹é…ç½®


**ç®€å•ç½‘ç«™æ£€æŸ¥ï¼š**

```yaml
modules:
  # åŸºç¡€ç½‘ç«™æ£€æŸ¥
  http_2xx:
    prober: http
    timeout: 5s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200]
      method: GET
      no_follow_redirects: false  # è·Ÿéšé‡å®šå‘
      fail_if_ssl: false         # ä¸è¦æ±‚SSL
```

**é…ç½®è§£é‡Šï¼š**
- **timeout: 5s**ï¼š5ç§’å†…å¿…é¡»å“åº”ï¼Œå¦åˆ™ç®—å¤±è´¥
- **valid_status_codes: [200]**ï¼šåªæœ‰è¿”å›200æ‰ç®—æˆåŠŸ
- **no_follow_redirects: false**ï¼šè‡ªåŠ¨è·Ÿéš302è·³è½¬
- **fail_if_ssl: false**ï¼šHTTPå’ŒHTTPSéƒ½å¯ä»¥

### 4.2 é«˜çº§HTTPæ¢æµ‹åŠŸèƒ½


**å†…å®¹éªŒè¯æ¢æµ‹ï¼š**

```yaml
modules:
  # æ£€æŸ¥é¡µé¢å†…å®¹
  http_content_check:
    prober: http
    http:
      valid_status_codes: [200]
      fail_if_body_matches_regexp:
        - "error"
        - "404"
        - "æœåŠ¡å™¨é”™è¯¯"
      fail_if_body_not_matches_regexp:
        - "æ¬¢è¿"
        - "ç™»å½•"
```

**POSTè¯·æ±‚æ¢æµ‹ï¼š**

```yaml
modules:
  # API POSTè¯·æ±‚æ£€æŸ¥
  http_post_2xx:
    prober: http
    http:
      method: POST
      headers:
        Content-Type: application/json
      body: '{"username":"test","password":"test"}'
      valid_status_codes: [200, 201]
```

**è®¤è¯æ¢æµ‹ï¼š**

```yaml
modules:
  # å¸¦è®¤è¯çš„æ¢æµ‹
  http_auth:
    prober: http
    http:
      basic_auth:
        username: "admin"
        password: "password"
      valid_status_codes: [200]
```

### 4.3 å…³é”®æŒ‡æ ‡è§£è¯»


**HTTPæ¢æµ‹è¿”å›çš„é‡è¦æŒ‡æ ‡ï¼š**

```
probe_success{instance="http://example.com"}                    # æ¢æµ‹æ˜¯å¦æˆåŠŸ (0/1)
probe_duration_seconds{instance="http://example.com"}           # æ€»å“åº”æ—¶é—´
probe_http_status_code{instance="http://example.com"}          # HTTPçŠ¶æ€ç 
probe_http_redirects{instance="http://example.com"}            # é‡å®šå‘æ¬¡æ•°
probe_http_duration_seconds{phase="resolve"}                   # DNSè§£ææ—¶é—´
probe_http_duration_seconds{phase="connect"}                   # TCPè¿æ¥æ—¶é—´
probe_http_duration_seconds{phase="tls"}                       # TLSæ¡æ‰‹æ—¶é—´
probe_http_duration_seconds{phase="processing"}                # æœåŠ¡å™¨å¤„ç†æ—¶é—´
probe_http_duration_seconds{phase="transfer"}                  # æ•°æ®ä¼ è¾“æ—¶é—´
```

**æŒ‡æ ‡å«ä¹‰è§£é‡Šï¼š**
- **probe_success = 1**ï¼šæ¢æµ‹æˆåŠŸï¼Œç½‘ç«™æ­£å¸¸
- **probe_duration_seconds**ï¼šå®Œæ•´è¯·æ±‚è€—æ—¶
- **phase="resolve"**ï¼šDNSæŸ¥è¯¢èŠ±è´¹çš„æ—¶é—´
- **phase="connect"**ï¼šå»ºç«‹TCPè¿æ¥çš„æ—¶é—´
- **phase="processing"**ï¼šæœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æ—¶é—´

---

## 5. ğŸ“ ICMP Pingç›‘æ§


### 5.1 ICMPæ¢æµ‹é…ç½®


**åŸºç¡€Pingæ£€æŸ¥ï¼š**

```yaml
modules:
  # åŸºç¡€pingæ£€æŸ¥
  icmp:
    prober: icmp
    timeout: 5s
    icmp:
      preferred_ip_protocol: "ip4"  # ä¼˜å…ˆä½¿ç”¨IPv4
      source_ip_address: "0.0.0.0" # æºIPåœ°å€
```

**IPv6æ”¯æŒï¼š**

```yaml
modules:
  # IPv6 pingæ£€æŸ¥
  icmp_ipv6:
    prober: icmp
    timeout: 5s
    icmp:
      preferred_ip_protocol: "ip6"
```

### 5.2 Prometheusé…ç½®ICMPç›‘æ§


**åœ¨prometheus.ymlä¸­é…ç½®ï¼š**

```yaml
scrape_configs:
  - job_name: 'blackbox-icmp'
    metrics_path: /probe
    params:
      module: [icmp]  # ä½¿ç”¨icmpæ¨¡å—
    static_configs:
      - targets:
        - 8.8.8.8      # Google DNS
        - 114.114.114.114  # å›½å†…DNS
        - www.baidu.com    # ç½‘ç«™åŸŸå
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
```

### 5.3 ICMPç›‘æ§æŒ‡æ ‡


**å…³é”®æŒ‡æ ‡è¯´æ˜ï¼š**

```
probe_success{instance="8.8.8.8"}                    # pingæ˜¯å¦æˆåŠŸ (0/1)
probe_duration_seconds{instance="8.8.8.8"}           # pingå¾€è¿”æ—¶é—´(RTT)
probe_ip_protocol{instance="8.8.8.8"}               # ä½¿ç”¨çš„IPåè®®ç‰ˆæœ¬
probe_icmp_duration_seconds{instance="8.8.8.8"}     # ICMPå“åº”æ—¶é—´
```

**å®é™…åº”ç”¨åœºæ™¯ï¼š**
- **æœåŠ¡å™¨å­˜æ´»ç›‘æ§**ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿
- **ç½‘ç»œå»¶è¿Ÿç›‘æ§**ï¼šç›‘æ§ä¸åŒåœ°åŒºè®¿é—®å»¶è¿Ÿ
- **ç½‘ç»œæ•…éšœè¯Šæ–­**ï¼šå¿«é€Ÿå‘ç°ç½‘ç»œä¸­æ–­

---

## 6. ğŸ”Œ TCPç«¯å£æ£€æµ‹


### 6.1 åŸºç¡€TCPæ¢æµ‹


**ç«¯å£è¿é€šæ€§æ£€æŸ¥ï¼š**

```yaml
modules:
  # åŸºç¡€TCPè¿æ¥æ£€æŸ¥
  tcp_connect:
    prober: tcp
    timeout: 5s
    
  # å¸¦TLSçš„TCPæ£€æŸ¥
  tcp_tls:
    prober: tcp
    timeout: 5s
    tcp:
      tls: true
      tls_config:
        insecure_skip_verify: false
```

### 6.2 å¸¸è§æœåŠ¡ç«¯å£ç›‘æ§


**æ•°æ®åº“å’Œç¼“å­˜ç›‘æ§ï¼š**

```yaml
# MySQLæ•°æ®åº“
- targets: ['mysql-server:3306']
  labels:
    service: 'mysql'
    
# Redisç¼“å­˜
- targets: ['redis-server:6379']
  labels:
    service: 'redis'
    
# PostgreSQL
- targets: ['postgres-server:5432']
  labels:
    service: 'postgresql'
```

**WebæœåŠ¡ç›‘æ§ï¼š**

```yaml
# HTTPæœåŠ¡
- targets: ['web-server:80']
  labels:
    service: 'http'
    
# HTTPSæœåŠ¡  
- targets: ['web-server:443']
  labels:
    service: 'https'
    
# è‡ªå®šä¹‰åº”ç”¨
- targets: ['app-server:8080']
  labels:
    service: 'custom-app'
```

### 6.3 TCPç›‘æ§å®è·µ


**Prometheusé…ç½®ç¤ºä¾‹ï¼š**

```yaml
scrape_configs:
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
        - mysql-server:3306
        - redis-server:6379
        - app-server:8080
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
```

**TCPç›‘æ§å…³é”®æŒ‡æ ‡ï¼š**

```
probe_success{instance="mysql-server:3306"}           # ç«¯å£æ˜¯å¦å¯è¿æ¥
probe_duration_seconds{instance="mysql-server:3306"}  # è¿æ¥å»ºç«‹æ—¶é—´
probe_ip_protocol{instance="mysql-server:3306"}       # IPåè®®ç‰ˆæœ¬
```

---

## 7. ğŸ“‹ DNSæŸ¥è¯¢ç›‘æ§


### 7.1 DNSæ¢æµ‹é…ç½®


**åŸºç¡€DNSæŸ¥è¯¢ï¼š**

```yaml
modules:
  # Aè®°å½•æŸ¥è¯¢
  dns_a:
    prober: dns
    timeout: 5s
    dns:
      query_name: "example.com"
      query_type: "A"
      valid_rcodes: [NOERROR]
      
  # MXè®°å½•æŸ¥è¯¢
  dns_mx:
    prober: dns
    dns:
      query_name: "example.com"
      query_type: "MX"
      valid_rcodes: [NOERROR]
```

**æŒ‡å®šDNSæœåŠ¡å™¨ï¼š**

```yaml
modules:
  dns_google:
    prober: dns
    dns:
      query_name: "example.com"
      query_type: "A"
      dns_over_tcp: false        # ä½¿ç”¨UDP
      recursion_desired: true    # è¯·æ±‚é€’å½’æŸ¥è¯¢
      valid_rcodes: [NOERROR]
```

### 7.2 DNSç›‘æ§åœºæ™¯


**ç½‘ç«™åŸŸåè§£æç›‘æ§ï¼š**

```yaml
# ç›‘æ§ç½‘ç«™ä¸»åŸŸå
- targets: ['8.8.8.8']
  labels:
    query_name: 'www.example.com'
    query_type: 'A'
    
# ç›‘æ§CDNåŸŸå
- targets: ['8.8.8.8']  
  labels:
    query_name: 'cdn.example.com'
    query_type: 'CNAME'
```

**å¤šDNSæœåŠ¡å™¨å¯¹æ¯”ï¼š**

```yaml
# å¯¹æ¯”ä¸åŒDNSæœåŠ¡å™¨
- targets: 
  - '8.8.8.8'      # Google DNS
  - '114.114.114.114'  # 114 DNS
  - '223.5.5.5'    # é˜¿é‡ŒDNS
  labels:
    query_name: 'www.baidu.com'
```

### 7.3 DNSç›‘æ§æŒ‡æ ‡


**å…³é”®æŒ‡æ ‡è§£é‡Šï¼š**

```
probe_success{instance="8.8.8.8"}                    # DNSæŸ¥è¯¢æ˜¯å¦æˆåŠŸ
probe_duration_seconds{instance="8.8.8.8"}           # DNSæŸ¥è¯¢è€—æ—¶
probe_dns_lookup_time_seconds{instance="8.8.8.8"}    # DNSè§£ææ—¶é—´
probe_dns_answer_rrs{instance="8.8.8.8"}             # è¿”å›çš„è®°å½•æ•°é‡
```

**å®é™…ç›‘æ§ä»·å€¼ï¼š**
- **åŸŸåè§£æçŠ¶æ€**ï¼šç¡®ä¿ç½‘ç«™åŸŸåèƒ½æ­£å¸¸è§£æ
- **DNSæ€§èƒ½ç›‘æ§**ï¼šæ¯”è¾ƒä¸åŒDNSæœåŠ¡å™¨çš„å“åº”é€Ÿåº¦
- **è§£æç»“æœéªŒè¯**ï¼šç¡®ä¿åŸŸåè§£æåˆ°æ­£ç¡®çš„IPåœ°å€

---

## 8. ğŸ” SSLè¯ä¹¦ç›‘æ§


### 8.1 SSLè¯ä¹¦æ¢æµ‹é…ç½®


**HTTPSè¯ä¹¦æ£€æŸ¥ï¼š**

```yaml
modules:
  # HTTPSè¯ä¹¦ç›‘æ§
  http_ssl:
    prober: http
    timeout: 10s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: [200]
      method: GET
      tls_config:
        insecure_skip_verify: false  # éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
        
  # çº¯SSLè¯ä¹¦æ£€æŸ¥(ä¸å…³å¿ƒHTTPå†…å®¹)
  tcp_ssl_cert:
    prober: tcp
    timeout: 10s
    tcp:
      tls: true
      tls_config:
        insecure_skip_verify: false
```

### 8.2 è¯ä¹¦ç›‘æ§é‡ç‚¹


**è¯ä¹¦æœ‰æ•ˆæœŸç›‘æ§ï¼š**

```yaml
# ç›‘æ§HTTPSç½‘ç«™è¯ä¹¦
scrape_configs:
  - job_name: 'blackbox-ssl'
    metrics_path: /probe
    params:
      module: [http_ssl]
    static_configs:
      - targets:
        - https://www.example.com
        - https://api.example.com
        - https://admin.example.com
```

**è¯ä¹¦é“¾éªŒè¯ï¼š**

```yaml
modules:
  ssl_cert_verify:
    prober: tcp
    tcp:
      tls: true
      tls_config:
        insecure_skip_verify: false  # ä¸¥æ ¼éªŒè¯è¯ä¹¦é“¾
        ca_file: "/etc/ssl/certs/ca-certificates.crt"
```

### 8.3 SSLç›‘æ§å…³é”®æŒ‡æ ‡


**è¯ä¹¦ç›¸å…³æŒ‡æ ‡ï¼š**

```
probe_success{instance="https://example.com"}                     # SSLè¿æ¥æ˜¯å¦æˆåŠŸ
probe_ssl_earliest_cert_expiry{instance="https://example.com"}    # è¯ä¹¦æœ€æ—©è¿‡æœŸæ—¶é—´(Unixæ—¶é—´æˆ³)
probe_tls_version_info{instance="https://example.com"}            # TLSç‰ˆæœ¬ä¿¡æ¯
probe_ssl_last_chain_expiry_timestamp_seconds                     # è¯ä¹¦é“¾è¿‡æœŸæ—¶é—´
```

**å®ç”¨å‘Šè­¦è§„åˆ™ï¼š**

```yaml
# è¯ä¹¦30å¤©å†…è¿‡æœŸå‘Šè­¦
- alert: SSLCertExpiringSoon
  expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "SSLè¯ä¹¦å³å°†è¿‡æœŸ"
    description: "{{ $labels.instance }} çš„SSLè¯ä¹¦å°†åœ¨30å¤©å†…è¿‡æœŸ"
```

---

## 9. âš™ï¸ é«˜çº§é…ç½®å’Œä¼˜åŒ–


### 9.1 æ¢æµ‹è¶…æ—¶å’Œé‡è¯•


**è¶…æ—¶é…ç½®æœ€ä½³å®è·µï¼š**

```yaml
modules:
  http_slow_service:
    prober: http
    timeout: 30s  # æ…¢æœåŠ¡ç»™æ›´é•¿æ—¶é—´
    http:
      valid_status_codes: [200]
      
  http_fast_check:
    prober: http  
    timeout: 3s   # å¿«é€Ÿæ£€æŸ¥ç”¨çŸ­æ—¶é—´
    http:
      valid_status_codes: [200]
```

**ç½‘ç»œç¯å¢ƒé€‚é…ï¼š**

```yaml
modules:
  # å†…ç½‘ç¯å¢ƒ - å¿«é€Ÿå“åº”
  internal_http:
    prober: http
    timeout: 5s
    
  # å¤–ç½‘ç¯å¢ƒ - å®¹å¿è¾ƒæ…¢ç½‘ç»œ
  external_http:
    prober: http
    timeout: 15s
```

### 9.2 å¤šç›®æ ‡ç›‘æ§é…ç½®


**åŠ¨æ€ç›®æ ‡å‘ç°ï¼š**

```yaml
scrape_configs:
  - job_name: 'blackbox-multi'
    metrics_path: /probe
    params:
      module: [http_2xx]
    file_sd_configs:
      - files:
        - '/etc/prometheus/targets/web_targets.yml'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
```

**ç›®æ ‡æ–‡ä»¶ç¤ºä¾‹(/etc/prometheus/targets/web_targets.yml)ï¼š**

```yaml
- targets:
  - https://www.example.com
  - https://api.example.com
  - https://cdn.example.com
  labels:
    env: production
    team: frontend
    
- targets:
  - https://test.example.com
  - https://staging.example.com  
  labels:
    env: staging
    team: frontend
```

### 9.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**èµ„æºä½¿ç”¨ä¼˜åŒ–ï¼š**

```yaml
# 1. åˆç†è®¾ç½®æ¢æµ‹é—´éš”
scrape_configs:
  - job_name: 'critical-services'
    scrape_interval: 30s    # å…³é”®æœåŠ¡é¢‘ç¹æ£€æŸ¥
    
  - job_name: 'regular-services'  
    scrape_interval: 2m     # ä¸€èˆ¬æœåŠ¡é€‚ä¸­æ£€æŸ¥
    
  - job_name: 'batch-services'
    scrape_interval: 5m     # æ‰¹å¤„ç†æœåŠ¡è¾ƒå°‘æ£€æŸ¥
```

**å¹¶å‘æ§åˆ¶ï¼š**

```yaml
# Blackbox-Exporterå¯åŠ¨å‚æ•°
blackbox_exporter \
  --config.file=blackbox.yml \
  --web.listen-address=:9115 \
  --log.level=info \
  --timeout-offset=0.5s     # è¶…æ—¶åç§»é‡
```

---

## 10. ğŸš¨ å‘Šè­¦è§„åˆ™å’ŒSLAç›‘æ§


### 10.1 åŸºç¡€å‘Šè­¦è§„åˆ™


**æœåŠ¡å¯ç”¨æ€§å‘Šè­¦ï¼š**

```yaml
groups:
- name: blackbox-alerts
  rules:
  # æœåŠ¡ä¸å¯ç”¨å‘Šè­¦
  - alert: ServiceDown
    expr: probe_success == 0
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "æœåŠ¡ {{ $labels.instance }} ä¸å¯ç”¨"
      description: "æœåŠ¡å·²ç»è¿ç»­2åˆ†é’Ÿæ— æ³•è®¿é—®"
      
  # å“åº”æ—¶é—´è¿‡æ…¢å‘Šè­¦  
  - alert: SlowResponse
    expr: probe_duration_seconds > 5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "æœåŠ¡ {{ $labels.instance }} å“åº”è¿‡æ…¢"
      description: "å“åº”æ—¶é—´: {{ $value }}ç§’"
```

**HTTPçŠ¶æ€ç å‘Šè­¦ï¼š**

```yaml
  # HTTPé”™è¯¯çŠ¶æ€ç å‘Šè­¦
  - alert: HTTPError
    expr: probe_http_status_code >= 400
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "HTTPé”™è¯¯çŠ¶æ€ç "
      description: "{{ $labels.instance }} è¿”å›çŠ¶æ€ç : {{ $value }}"
      
  # SSLè¯ä¹¦è¿‡æœŸå‘Šè­¦
  - alert: SSLCertExpiry
    expr: (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "SSLè¯ä¹¦å³å°†è¿‡æœŸ"
      description: "è¯ä¹¦å°†åœ¨ {{ $value }} å¤©åè¿‡æœŸ"
```

### 10.2 SLAç›‘æ§å®è·µ


**å¯ç”¨æ€§SLAè®¡ç®—ï¼š**

```yaml
# è®¡ç®—99.9%å¯ç”¨æ€§SLA
  - record: service_availability_30d
    expr: |
      avg_over_time(probe_success[30d]) * 100
      
  - alert: SLABreach
    expr: service_availability_30d < 99.9
    labels:
      severity: critical
    annotations:
      summary: "SLAè¿è§„"
      description: "30å¤©å¯ç”¨æ€§: {{ $value }}%ï¼Œä½äº99.9%"
```

**æ€§èƒ½SLAç›‘æ§ï¼š**

```yaml
# 95%è¯·æ±‚åœ¨2ç§’å†…å“åº”
  - record: response_time_p95
    expr: |
      histogram_quantile(0.95, 
        rate(probe_duration_seconds_bucket[5m])
      )
      
  - alert: PerformanceSLA
    expr: response_time_p95 > 2
    labels:
      severity: warning
    annotations:
      summary: "æ€§èƒ½SLAå‘Šè­¦"
      description: "95%å“åº”æ—¶é—´: {{ $value }}ç§’"
```

### 10.3 å‘Šè­¦æœ€ä½³å®è·µ


**å‘Šè­¦åˆ†çº§ç­–ç•¥ï¼š**

```
ğŸ”´ Critical (ç´§æ€¥)ï¼š
- æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- SSLè¯ä¹¦å·²è¿‡æœŸ
- ä¸»è¦ä¸šåŠ¡åŠŸèƒ½æ•…éšœ

ğŸŸ¡ Warning (è­¦å‘Š)ï¼š
- å“åº”æ—¶é—´è¿‡æ…¢
- è¯ä¹¦å³å°†è¿‡æœŸ
- éå…³é”®åŠŸèƒ½å¼‚å¸¸

ğŸŸ¢ Info (ä¿¡æ¯)ï¼š
- æ€§èƒ½è¶‹åŠ¿å˜åŒ–
- é…ç½®å˜æ›´é€šçŸ¥
- å®šæœŸå¥åº·æŠ¥å‘Š
```

**å‘Šè­¦é™å™ªæŠ€å·§ï¼š**

```yaml
# 1. è®¾ç½®åˆç†çš„foræŒç»­æ—¶é—´
- alert: ServiceDown
  expr: probe_success == 0
  for: 2m  # é¿å…ç¬æ—¶æ•…éšœè¯¯æŠ¥
  
# 2. ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤
- alert: CriticalServiceDown
  expr: probe_success{env="production"} == 0
  
# 3. æ—¶é—´çª—å£è¿‡æ»¤
- alert: BusinessHoursAlert
  expr: probe_success == 0 and ON() hour() >= 9 and hour() <= 18
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Blackboxç›‘æ§æœ¬è´¨ï¼šç«™åœ¨ç”¨æˆ·è§’åº¦æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
ğŸ”¸ äº”ç§æ¢æµ‹ç±»å‹ï¼šHTTPã€ICMPã€TCPã€DNSã€SSLå„æœ‰ä¸“é•¿
ğŸ”¸ é…ç½®æ ¸å¿ƒï¼šmoduleså®šä¹‰æ¢æµ‹æ–¹å¼ï¼ŒPrometheusé…ç½®ç›‘æ§ç›®æ ‡
ğŸ”¸ å…³é”®æŒ‡æ ‡ï¼šprobe_success(æˆåŠŸç‡)ã€probe_duration_seconds(å“åº”æ—¶é—´)
ğŸ”¸ å‘Šè­¦ç­–ç•¥ï¼šåˆ†çº§å‘Šè­¦ã€SLAç›‘æ§ã€åˆç†é™å™ª
```

### 11.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¹ ç›‘æ§è§„åˆ’å»ºè®®ï¼š**
```
ç½‘ç«™ç›‘æ§ï¼š
âœ… HTTPæ¢æµ‹ - æ£€æŸ¥é¡µé¢å¯è®¿é—®æ€§
âœ… SSLè¯ä¹¦ - ç›‘æ§è¯ä¹¦æœ‰æ•ˆæœŸ
âœ… DNSè§£æ - ç¡®ä¿åŸŸåæ­£å¸¸è§£æ

APIç›‘æ§ï¼š
âœ… HTTP POST/GET - éªŒè¯æ¥å£åŠŸèƒ½
âœ… å“åº”æ—¶é—´ - ç›‘æ§æ€§èƒ½æŒ‡æ ‡
âœ… çŠ¶æ€ç æ£€æŸ¥ - ç¡®ä¿è¿”å›æ­£ç¡®

åŸºç¡€è®¾æ–½ï¼š
âœ… ICMP ping - æœåŠ¡å™¨å­˜æ´»æ£€æµ‹
âœ… TCPç«¯å£ - æœåŠ¡ç«¯å£å¯ç”¨æ€§
âœ… ç½‘ç»œå»¶è¿Ÿ - è·¨åŒºåŸŸè¿é€šæ€§
```

**ğŸ”¹ é…ç½®æœ€ä½³å®è·µï¼š**
```
1. è¶…æ—¶è®¾ç½®ï¼š
   - å†…ç½‘æœåŠ¡: 3-5ç§’
   - å¤–ç½‘æœåŠ¡: 10-15ç§’
   - æ…¢æœåŠ¡: 30ç§’ä»¥ä¸Š

2. æ£€æŸ¥é¢‘ç‡ï¼š
   - å…³é”®æœåŠ¡: 30ç§’-1åˆ†é’Ÿ
   - ä¸€èˆ¬æœåŠ¡: 2-5åˆ†é’Ÿ
   - æ‰¹å¤„ç†: 10-30åˆ†é’Ÿ

3. å‘Šè­¦ç­–ç•¥ï¼š
   - Critical: ç«‹å³é€šçŸ¥
   - Warning: æ±‡æ€»é€šçŸ¥
   - Info: æ—¥æŠ¥å½¢å¼
```

### 11.3 å¸¸è§é—®é¢˜å’Œè§£å†³


**ğŸ”¹ éƒ¨ç½²é—®é¢˜æ’æŸ¥ï¼š**
```
é—®é¢˜ï¼šæ¢æµ‹æ€»æ˜¯å¤±è´¥
æ£€æŸ¥ï¼š
1. ç½‘ç»œè¿é€šæ€§ - pingç›®æ ‡åœ°å€
2. é˜²ç«å¢™è®¾ç½® - ç¡®ä¿ç«¯å£å¼€æ”¾
3. DNSè§£æ - æ£€æŸ¥åŸŸåæ˜¯å¦æ­£ç¡®
4. é…ç½®æ–‡ä»¶ - éªŒè¯YAMLè¯­æ³•

é—®é¢˜ï¼šæŒ‡æ ‡æ•°æ®ç¼ºå¤±
æ£€æŸ¥ï¼š
1. Prometheusé…ç½® - scrape_configsæ­£ç¡®æ€§
2. relabelé…ç½® - æ ‡ç­¾è½¬æ¢é€»è¾‘
3. Blackboxæ—¥å¿— - æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
4. ç›®æ ‡å¯è¾¾æ€§ - æ‰‹åŠ¨æµ‹è¯•æ¢æµ‹
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š**
```
1. åˆç†è®¾ç½®å¹¶å‘æ•°
2. é¿å…æ¢æµ‹ç›®æ ‡è¿‡å¤š
3. ä¼˜åŒ–ç½‘ç»œè·¯å¾„
4. ä½¿ç”¨æœ¬åœ°DNSç¼“å­˜
5. å®šæœŸæ¸…ç†å†å²æ•°æ®
```

### 11.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ¯ æŒæ¡ç¨‹åº¦æ£€éªŒï¼š**
- [ ] èƒ½ç‹¬ç«‹å®‰è£…é…ç½®Blackbox-Exporter
- [ ] ç†è§£äº”ç§æ¢æµ‹ç±»å‹çš„åº”ç”¨åœºæ™¯
- [ ] ä¼šç¼–å†™åŸºç¡€çš„æ¢æµ‹é…ç½®æ–‡ä»¶
- [ ] èƒ½è®¾è®¡åˆç†çš„å‘Šè­¦è§„åˆ™
- [ ] æŒæ¡SLAç›‘æ§çš„è®¡ç®—æ–¹æ³•

**ğŸ“š è¿›é˜¶å­¦ä¹ æ–¹å‘ï¼š**
1. **æ·±å…¥Prometheus** - å­¦ä¹ æ›´å¤šç›‘æ§ç»„ä»¶
2. **Grafanaå¯è§†åŒ–** - åˆ¶ä½œç›‘æ§ä»ªè¡¨ç›˜
3. **AlertManager** - å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥
4. **ç›‘æ§æ¶æ„è®¾è®¡** - å¤§è§„æ¨¡ç›‘æ§ç³»ç»Ÿè§„åˆ’
5. **è‡ªå®šä¹‰Exporter** - å¼€å‘ä¸“ç”¨ç›‘æ§ç»„ä»¶

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- Blackboxç›‘æ§å…³æ³¨ç”¨æˆ·ä½“éªŒï¼Œä¸å…³å¿ƒå†…éƒ¨å®ç°
- äº”ç§æ¢æµ‹ç±»å‹è¦†ç›–äº†ç½‘ç»œæœåŠ¡çš„ä¸»è¦ç›‘æ§éœ€æ±‚
- é…ç½®æ–‡ä»¶çš„moduleséƒ¨åˆ†å®šä¹‰æ¢æµ‹è¡Œä¸º
- probe_successæ˜¯æœ€é‡è¦çš„ç›‘æ§æŒ‡æ ‡
- åˆç†çš„å‘Šè­¦ç­–ç•¥æ¯”å¤æ‚çš„é…ç½®æ›´é‡è¦