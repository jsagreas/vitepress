---
title: 1ã€é«˜å¯ç”¨æ¶æ„éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ](#1-é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ)
2. [å¤šå®ä¾‹HAéƒ¨ç½²æ–¹æ¡ˆ](#2-å¤šå®ä¾‹HAéƒ¨ç½²æ–¹æ¡ˆ)  
3. [è”é‚¦é›†ç¾¤Federationé…ç½®](#3-è”é‚¦é›†ç¾¤Federationé…ç½®)
4. [è´Ÿè½½å‡è¡¡ç­–ç•¥](#4-è´Ÿè½½å‡è¡¡ç­–ç•¥)
5. [Failoveræ•…éšœè½¬ç§»](#5-Failoveræ•…éšœè½¬ç§»)
6. [Kubernetesç¯å¢ƒHA](#6-Kubernetesç¯å¢ƒHA)
7. [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#7-æ•°æ®ä¸€è‡´æ€§ä¿è¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é«˜å¯ç”¨æ¶æ„


**ğŸ¯ é€šä¿—ç†è§£**
```
é«˜å¯ç”¨å°±åƒç»™ä½ çš„ç›‘æ§ç³»ç»Ÿä¹°ä¿é™©ï¼š
â€¢ æ­£å¸¸æƒ…å†µï¼šä¸€å°PrometheusæœåŠ¡å™¨å·¥ä½œ
â€¢ å¼‚å¸¸æƒ…å†µï¼šå¤‡ç”¨æœåŠ¡å™¨è‡ªåŠ¨æ¥ç®¡
â€¢ ç›®æ ‡ï¼š7Ã—24å°æ—¶ä¸é—´æ–­ç›‘æ§æœåŠ¡
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
é«˜å¯ç”¨æ€§ï¼ˆHigh Availabilityï¼ŒHAï¼‰ï¼š
â€¢ å«ä¹‰ï¼šç³»ç»ŸæŒç»­è¿è¡Œçš„èƒ½åŠ›
â€¢ æŒ‡æ ‡ï¼šé€šå¸¸ç”¨9çš„ä¸ªæ•°è¡¨ç¤ºå¯ç”¨æ€§
â€¢ 99.9%å¯ç”¨æ€§ = æ¯å¹´åœæœº8.76å°æ—¶
â€¢ 99.99%å¯ç”¨æ€§ = æ¯å¹´åœæœº52.56åˆ†é’Ÿ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Prometheusé«˜å¯ç”¨


**âŒ å•ç‚¹æ•…éšœçš„é—®é¢˜**
```
ä¼ ç»Ÿå•å®ä¾‹éƒ¨ç½²é£é™©ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Prometheus    â”‚ â† å¦‚æœè¿™å°æœºå™¨æŒ‚äº†...
â”‚   (å•ç‚¹)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   æ‰€æœ‰ç›‘æ§æ•°æ®ä¸¢å¤±ï¼
```

**âœ… é«˜å¯ç”¨æ¶æ„çš„å¥½å¤„**
```
HAæ¶æ„ä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prometheus  â”‚   â”‚ Prometheus  â”‚
â”‚   ä¸»å®ä¾‹    â”‚   â”‚   å¤‡å®ä¾‹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                 â†‘
      â””â”€â”€â”€â”€â”€äº’ç›¸å¤‡ä»½â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼š
ğŸ”¸ æ¶ˆé™¤å•ç‚¹æ•…éšœ
ğŸ”¸ æ•°æ®ä¸ä¼šä¸¢å¤±  
ğŸ”¸ æœåŠ¡æŒç»­å¯ç”¨
ğŸ”¸ ç»´æŠ¤æ—¶é›¶åœæœº
```

### 1.3 Prometheus HAçš„æŒ‘æˆ˜


**ğŸš¨ ä¸»è¦æŒ‘æˆ˜**
```
Prometheus HAé¢ä¸´çš„é—®é¢˜ï¼š

1ï¸âƒ£ æ•°æ®é‡å¤é—®é¢˜
æ¯ä¸ªå®ä¾‹éƒ½ä¼šæŠ“å–ç›¸åŒçš„æŒ‡æ ‡ â†’ é‡å¤æ•°æ®

2ï¸âƒ£ æŸ¥è¯¢ä¸€è‡´æ€§
ä¸åŒå®ä¾‹çš„æ•°æ®å¯èƒ½ä¸å®Œå…¨ä¸€è‡´

3ï¸âƒ£ å‘Šè­¦é‡å¤
å¤šä¸ªå®ä¾‹å¯èƒ½å‘é€ç›¸åŒçš„å‘Šè­¦

4ï¸âƒ£ å­˜å‚¨åŒæ­¥
å¦‚ä½•ä¿è¯å¤šä¸ªå®ä¾‹æ•°æ®åŒæ­¥
```

**ğŸ’¡ è§£å†³æ€è·¯**
```
å¸¸è§HAæ–¹æ¡ˆï¼š

æ–¹æ¡ˆä¸€ï¼šä¸»å¤‡æ¨¡å¼ï¼ˆActive-Passiveï¼‰
â€¢ ä¸€ä¸ªä¸»å®ä¾‹å·¥ä½œï¼Œå¤‡å®ä¾‹å¾…æœº
â€¢ ä¸»å®ä¾‹æ•…éšœæ—¶ï¼Œå¤‡å®ä¾‹æ¥ç®¡

æ–¹æ¡ˆäºŒï¼šåŒæ´»æ¨¡å¼ï¼ˆActive-Activeï¼‰  
â€¢ å¤šä¸ªå®ä¾‹åŒæ—¶å·¥ä½œ
â€¢ é€šè¿‡å»é‡æœºåˆ¶å¤„ç†é‡å¤æ•°æ®

æ–¹æ¡ˆä¸‰ï¼šè”é‚¦æ¨¡å¼ï¼ˆFederationï¼‰
â€¢ å¤šä¸ªPrometheuså½¢æˆé›†ç¾¤
â€¢ ä¸Šå±‚å®ä¾‹èšåˆä¸‹å±‚æ•°æ®
```

---

## 2. ğŸ”„ å¤šå®ä¾‹HAéƒ¨ç½²æ–¹æ¡ˆ


### 2.1 ä¸»å¤‡æ¨¡å¼éƒ¨ç½²


**ğŸ—ï¸ æ¶æ„è®¾è®¡**
```
ä¸»å¤‡æ¶æ„å›¾ï¼š
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚    å®¢æˆ·ç«¯    â”‚
                  â”‚  (Grafana)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚
                  â”‚ (HAProxy)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†™         â†˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Prometheus  â”‚   â”‚ Prometheus  â”‚
        â”‚   ä¸»å®ä¾‹    â”‚   â”‚   å¤‡å®ä¾‹    â”‚
        â”‚ (Active)    â”‚   â”‚ (Standby)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   å…±äº«å­˜å‚¨   â”‚   â”‚   å…±äº«å­˜å‚¨   â”‚
        â”‚    (NFS)    â”‚   â”‚    (NFS)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš™ï¸ é…ç½®ç¤ºä¾‹**

::: tip ä¸»å®ä¾‹é…ç½®
```yaml
# prometheus-master.yml
global:
  scrape_interval: 15s
  external_labels:
    cluster: 'production'
    replica: 'master'

rule_files:
  - "rules/*.yml"

scrape_configs:
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node1:9100', 'node2:9100']

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# æ•°æ®å­˜å‚¨è·¯å¾„
storage:
  tsdb:
    path: /shared-storage/prometheus-data
    retention.time: 30d
```
:::

::: warning å¤‡å®ä¾‹é…ç½®
```yaml
# prometheus-backup.yml  
global:
  scrape_interval: 15s
  external_labels:
    cluster: 'production'
    replica: 'backup'

# ç›¸åŒçš„ç›‘æ§é…ç½®
rule_files:
  - "rules/*.yml"

scrape_configs:
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node1:9100', 'node2:9100']

# å¤‡å®ä¾‹ä¸å‘é€å‘Šè­¦ï¼Œé¿å…é‡å¤
# alerting: {}

storage:
  tsdb:
    path: /shared-storage/prometheus-data-backup
    retention.time: 30d
```
:::

### 2.2 åŒæ´»æ¨¡å¼éƒ¨ç½²


**ğŸ“Š åŒæ´»æ¶æ„ä¼˜åŠ¿**
```
åŒæ´»æ¨¡å¼ç‰¹ç‚¹ï¼š
âœ… ä¸¤ä¸ªå®ä¾‹éƒ½åœ¨å·¥ä½œ
âœ… æé«˜æŸ¥è¯¢æ€§èƒ½  
âœ… æ•°æ®æ›´åŠ å¯é 
âŒ éœ€è¦å¤„ç†æ•°æ®é‡å¤
âŒ é…ç½®æ›´å¤æ‚
```

**ğŸ”§ åŒæ´»é…ç½®ç­–ç•¥**
```yaml
# å®ä¾‹1é…ç½®
global:
  external_labels:
    cluster: 'production'
    replica: 'prometheus-1'

# å®ä¾‹2é…ç½®  
global:
  external_labels:
    cluster: 'production'
    replica: 'prometheus-2'
```

**ğŸ¯ å»é‡æŸ¥è¯¢æŠ€å·§**
```promql
# åœ¨Grafanaä¸­ä½¿ç”¨groupå»é‡
# åŸå§‹æŸ¥è¯¢ï¼ˆä¼šæœ‰é‡å¤æ•°æ®ï¼‰
up

# å»é‡æŸ¥è¯¢ï¼ˆæ¨èï¼‰
group by (job, instance) (up)

# æˆ–è€…ä½¿ç”¨maxå»é‡
max by (job, instance) (up)
```

### 2.3 å¯åŠ¨è„šæœ¬ç¤ºä¾‹


**ğŸš€ æœåŠ¡å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# start-prometheus-ha.sh

INSTANCE_TYPE=${1:-master}  # master æˆ– backup
DATA_DIR="/data/prometheus-${INSTANCE_TYPE}"
CONFIG_FILE="/etc/prometheus/prometheus-${INSTANCE_TYPE}.yml"

# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p ${DATA_DIR}

# å¯åŠ¨Prometheus
prometheus \
  --config.file=${CONFIG_FILE} \
  --storage.tsdb.path=${DATA_DIR} \
  --web.listen-address=0.0.0.0:9090 \
  --web.enable-lifecycle \
  --web.enable-admin-api \
  --log.level=info
```

**ğŸ“ ä½¿ç”¨æ–¹æ³•**
```bash
# å¯åŠ¨ä¸»å®ä¾‹
./start-prometheus-ha.sh master

# å¯åŠ¨å¤‡å®ä¾‹  
./start-prometheus-ha.sh backup
```

---

## 3. ğŸŒ è”é‚¦é›†ç¾¤Federationé…ç½®


### 3.1 è”é‚¦æ¶æ„æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯Prometheusè”é‚¦**
```
è”é‚¦å°±åƒå…¬å¸çš„ç»„ç»‡æ¶æ„ï¼š
â€¢ æ€»éƒ¨ï¼ˆGlobal Prometheusï¼‰ï¼šæ”¶é›†å„åˆ†éƒ¨æ±‡æ€»æ•°æ®
â€¢ åˆ†éƒ¨ï¼ˆLocal Prometheusï¼‰ï¼šæ”¶é›†å…·ä½“ä¸šåŠ¡æ•°æ®
â€¢ å¥½å¤„ï¼šæ•°æ®åˆ†å±‚ï¼ŒèŒè´£æ¸…æ™°ï¼Œæ‰©å±•æ€§å¼º
```

**ğŸ—ï¸ è”é‚¦æ¶æ„å›¾**
```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  Globalé›†ç¾¤     â”‚
                â”‚ (è”é‚¦ä¸Šå±‚)      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘ Federation
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚         â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebæœåŠ¡   â”‚ â”‚  æ•°æ®åº“æœåŠ¡  â”‚ â”‚  åŸºç¡€è®¾æ–½   â”‚
â”‚ Prometheus  â”‚ â”‚ Prometheus  â”‚ â”‚ Prometheus  â”‚
â”‚ (æœ¬åœ°é›†ç¾¤)  â”‚ â”‚ (æœ¬åœ°é›†ç¾¤)  â”‚ â”‚ (æœ¬åœ°é›†ç¾¤)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åˆ†å±‚è”é‚¦é…ç½®


**ğŸ“‹ ä¸‹å±‚Prometheusé…ç½®**
```yaml
# local-prometheus-web.yml (WebæœåŠ¡ç›‘æ§)
global:
  scrape_interval: 15s
  external_labels:
    cluster: 'web-cluster'
    region: 'us-east-1'

scrape_configs:
  - job_name: 'web-servers'
    static_configs:
      - targets: 
        - 'web1:8080'
        - 'web2:8080'
        - 'web3:8080'

  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx1:9113', 'nginx2:9113']
```

**ğŸ” ä¸Šå±‚è”é‚¦é…ç½®**
```yaml
# global-prometheus.yml (è”é‚¦ä¸Šå±‚)
global:
  scrape_interval: 60s  # è”é‚¦æŠ“å–é—´éš”å¯ä»¥æ›´é•¿
  external_labels:
    monitor: 'global-monitor'

scrape_configs:
  # ä»Webé›†ç¾¤è”é‚¦æ•°æ®
  - job_name: 'federate-web'
    scrape_interval: 60s
    honor_labels: true
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job=~"web-servers|nginx"}'  # åªæŠ“å–ç‰¹å®šæŒ‡æ ‡
        - 'up'
        - 'instance:cpu_usage:rate5m'   # èšåˆæŒ‡æ ‡
    static_configs:
      - targets: ['web-prometheus:9090']

  # ä»æ•°æ®åº“é›†ç¾¤è”é‚¦æ•°æ®  
  - job_name: 'federate-db'
    scrape_interval: 60s
    honor_labels: true
    metrics_path: '/federate'
    params:
      'match[]':
        - '{job=~"mysql|redis"}'
        - 'mysql_up'
        - 'redis_connected_clients'
    static_configs:
      - targets: ['db-prometheus:9090']
```

### 3.3 è”é‚¦æœ€ä½³å®è·µ


**ğŸ¯ æ•°æ®é€‰æ‹©ç­–ç•¥**
```
è”é‚¦æ•°æ®é€‰æ‹©åŸåˆ™ï¼š

âœ… åº”è¯¥è”é‚¦çš„æ•°æ®ï¼š
â€¢ èšåˆåçš„æŒ‡æ ‡ï¼ˆå¦‚å¹³å‡CPUä½¿ç”¨ç‡ï¼‰
â€¢ å…³é”®ä¸šåŠ¡æŒ‡æ ‡ï¼ˆå¦‚è®¢å•é‡ã€é”™è¯¯ç‡ï¼‰
â€¢ åŸºç¡€è®¾æ–½çŠ¶æ€ï¼ˆå¦‚æœåŠ¡å­˜æ´»çŠ¶æ€ï¼‰
â€¢ SLAç›¸å…³æŒ‡æ ‡

âŒ ä¸åº”è¯¥è”é‚¦çš„æ•°æ®ï¼š
â€¢ åŸå§‹é«˜é¢‘æŒ‡æ ‡ï¼ˆå¦‚æ¯ç§’çš„CPUæ ·æœ¬ï¼‰
â€¢ å®ä¾‹çº§åˆ«çš„è¯¦ç»†æŒ‡æ ‡
â€¢ è°ƒè¯•ç”¨çš„ä¸´æ—¶æŒ‡æ ‡
â€¢ å¤§é‡æ—¶é—´åºåˆ—çš„è¯¦ç»†æ•°æ®
```

**âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```yaml
# è”é‚¦æ€§èƒ½ä¼˜åŒ–
scrape_configs:
  - job_name: 'federate-optimized'
    scrape_interval: 120s      # è¾ƒé•¿çš„æŠ“å–é—´éš”
    scrape_timeout: 60s        # åˆç†çš„è¶…æ—¶æ—¶é—´
    honor_labels: true         # ä¿ç•™åŸå§‹æ ‡ç­¾
    metrics_path: '/federate'
    params:
      'match[]':
        # åªæŠ“å–éœ€è¦çš„æŒ‡æ ‡ï¼Œä½¿ç”¨æ­£åˆ™åŒ¹é…
        - '{__name__=~"up|cpu_usage_avg|memory_usage_avg"}'
        - '{job="critical-services"}'
    static_configs:
      - targets: ['local-prometheus:9090']
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡ç­–ç•¥


### 4.1 è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©


**ğŸ”§ HAProxyé…ç½®ç¤ºä¾‹**
```
# /etc/haproxy/haproxy.cfg
global
    daemon
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Prometheusè´Ÿè½½å‡è¡¡
frontend prometheus_frontend
    bind *:9090
    default_backend prometheus_backend

backend prometheus_backend
    balance roundrobin
    option httpchk GET /api/v1/status/buildinfo
    
    # å¥åº·æ£€æŸ¥
    server prometheus1 192.168.1.10:9090 check
    server prometheus2 192.168.1.11:9090 check backup
    
# Grafanaè´Ÿè½½å‡è¡¡    
frontend grafana_frontend
    bind *:3000
    default_backend grafana_backend
    
backend grafana_backend
    balance roundrobin
    server grafana1 192.168.1.20:3000 check
    server grafana2 192.168.1.21:3000 check
```

**ğŸŒ Nginxé…ç½®ç¤ºä¾‹**
```nginx
# /etc/nginx/conf.d/prometheus.conf
upstream prometheus_cluster {
    # è´Ÿè½½å‡è¡¡ç­–ç•¥
    least_conn;  # æœ€å°‘è¿æ¥æ•°
    
    server 192.168.1.10:9090 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:9090 max_fails=3 fail_timeout=30s backup;
}

server {
    listen 9090;
    server_name prometheus.company.com;
    
    location / {
        proxy_pass http://prometheus_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # å¥åº·æ£€æŸ¥
        proxy_next_upstream error timeout invalid_header http_500;
    }
    
    # å¥åº·æ£€æŸ¥æ¥å£
    location /health {
        access_log off;
        return 200 "healthy\n";
    }
}
```

### 4.2 ä¼šè¯ä¿æŒç­–ç•¥


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯ä¿æŒ**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·åœ¨Grafanaä¸­æŸ¥è¯¢æ•°æ®
â†’ ç¬¬ä¸€æ¬¡è¯·æ±‚åˆ°Prometheus-1  
â†’ ç¬¬äºŒæ¬¡è¯·æ±‚åˆ°Prometheus-2ï¼ˆæ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼‰
â†’ ç”¨æˆ·çœ‹åˆ°çš„å›¾è¡¨ä¼šè·³åŠ¨
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**
```nginx
# Nginxä¼šè¯ä¿æŒé…ç½®
upstream prometheus_cluster {
    # åŸºäºIPçš„ä¼šè¯ä¿æŒ
    ip_hash;
    
    server 192.168.1.10:9090;
    server 192.168.1.11:9090;
}

# æˆ–è€…åŸºäºCookieçš„ä¼šè¯ä¿æŒ
map $cookie_prometheus_instance $pool {
    ~prometheus1 prometheus1;
    ~prometheus2 prometheus2;
    default prometheus1;
}
```

### 4.3 æ™ºèƒ½è´Ÿè½½å‡è¡¡


**ğŸ“Š åŸºäºæŸ¥è¯¢ç±»å‹çš„è´Ÿè½½å‡è¡¡**
```nginx
# æ ¹æ®æŸ¥è¯¢ç±»å‹åˆ†å‘è¯·æ±‚
location /api/v1/query {
    # å®æ—¶æŸ¥è¯¢èµ°æ€§èƒ½è¾ƒå¥½çš„å®ä¾‹
    proxy_pass http://prometheus_primary;
}

location /api/v1/query_range {
    # èŒƒå›´æŸ¥è¯¢å¯ä»¥åˆ†å‘åˆ°ä»»æ„å®ä¾‹
    proxy_pass http://prometheus_cluster;
}

location /api/v1/series {
    # å…ƒæ•°æ®æŸ¥è¯¢èµ°ä¸“é—¨çš„å®ä¾‹
    proxy_pass http://prometheus_metadata;
}
```

---

## 5. ğŸ”„ Failoveræ•…éšœè½¬ç§»


### 5.1 æ•…éšœæ£€æµ‹æœºåˆ¶


**ğŸš¨ å¥åº·æ£€æŸ¥é…ç½®**
```yaml
# health-check.yml (ç›‘æ§æ£€æŸ¥è„šæœ¬)
#!/bin/bash

PROMETHEUS_URL="http://localhost:9090"
CHECK_INTERVAL=30  # 30ç§’æ£€æŸ¥ä¸€æ¬¡

check_prometheus() {
    # æ£€æŸ¥APIå“åº”
    response=$(curl -s -o /dev/null -w "%{http_code}" \
               ${PROMETHEUS_URL}/api/v1/status/buildinfo)
    
    if [ "$response" = "200" ]; then
        echo "$(date): Prometheuså¥åº· âœ…"
        return 0
    else
        echo "$(date): Prometheuså¼‚å¸¸ âŒ (çŠ¶æ€ç : $response)"
        return 1
    fi
}

# æ£€æŸ¥æ•°æ®æ–°é²œåº¦
check_data_freshness() {
    # è·å–æœ€æ–°æ•°æ®çš„æ—¶é—´æˆ³
    latest_timestamp=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=up" | \
                      jq -r '.data.result[0].value[0]')
    
    current_time=$(date +%s)
    data_age=$((current_time - latest_timestamp))
    
    if [ $data_age -lt 300 ]; then  # 5åˆ†é’Ÿå†…çš„æ•°æ®ç®—æ–°é²œ
        echo "æ•°æ®æ–°é²œåº¦: ${data_age}ç§’ âœ…"
        return 0
    else
        echo "æ•°æ®è¿‡æœŸ: ${data_age}ç§’ âŒ"
        return 1
    fi
}
```

### 5.2 è‡ªåŠ¨æ•…éšœè½¬ç§»


**ğŸ”§ Keepalivedé…ç½®**
```bash
# /etc/keepalived/keepalived.conf
vrrp_script chk_prometheus {
    script "/opt/scripts/check_prometheus.sh"
    interval 10        # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    weight -20         # å¤±è´¥æ—¶æƒé‡å‡20
    fall 3            # è¿ç»­3æ¬¡å¤±è´¥æ‰è®¤ä¸ºdown
    rise 2            # è¿ç»­2æ¬¡æˆåŠŸæ‰è®¤ä¸ºup
}

vrrp_instance VI_1 {
    state MASTER           # ä¸»å®ä¾‹
    interface eth0
    virtual_router_id 51
    priority 120          # ä¼˜å…ˆçº§
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass prometheus_ha
    }
    
    virtual_ipaddress {
        192.168.1.100/24  # è™šæ‹ŸIP
    }
    
    track_script {
        chk_prometheus
    }
    
    # æ•…éšœè½¬ç§»é€šçŸ¥
    notify_master "/opt/scripts/prometheus_master.sh"
    notify_backup "/opt/scripts/prometheus_backup.sh"
    notify_fault "/opt/scripts/prometheus_fault.sh"
}
```

**ğŸ“§ æ•…éšœé€šçŸ¥è„šæœ¬**
```bash
#!/bin/bash
# prometheus_fault.sh

WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

send_alert() {
    local message="$1"
    local severity="$2"
    
    curl -X POST -H 'Content-type: application/json' \
         --data "{\"text\":\"ğŸš¨ Prometheusæ•…éšœ: $message\"}" \
         $WEBHOOK_URL
         
    # å‘é€é‚®ä»¶
    echo "$message" | mail -s "Prometheusæ•…éšœå‘Šè­¦" ops@company.com
}

case "$1" in
    master)
        send_alert "å®ä¾‹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹" "info"
        ;;
    backup)
        send_alert "å®ä¾‹åˆ‡æ¢ä¸ºå¤‡èŠ‚ç‚¹" "warning"
        ;;
    fault)
        send_alert "æ£€æµ‹åˆ°Prometheusæ•…éšœ" "critical"
        ;;
esac
```

### 5.3 æ‰‹åŠ¨æ•…éšœè½¬ç§»


**ğŸ”§ è¿ç»´æ“ä½œè„šæœ¬**
```bash
#!/bin/bash
# manual-failover.sh

PROMETHEUS_PRIMARY="192.168.1.10"
PROMETHEUS_BACKUP="192.168.1.11"
VIP="192.168.1.100"

failover_to_backup() {
    echo "ğŸ”„ å¼€å§‹æ•…éšœè½¬ç§»..."
    
    # 1. åœæ­¢ä¸»å®ä¾‹çš„VIP
    ssh root@$PROMETHEUS_PRIMARY "ip addr del $VIP/24 dev eth0"
    
    # 2. åœ¨å¤‡å®ä¾‹ä¸Šæ·»åŠ VIP  
    ssh root@$PROMETHEUS_BACKUP "ip addr add $VIP/24 dev eth0"
    
    # 3. æ›´æ–°DNSè®°å½•ï¼ˆå¦‚æœä½¿ç”¨DNSï¼‰
    # update_dns_record prometheus.company.com $PROMETHEUS_BACKUP
    
    # 4. å‘é€é€šçŸ¥
    echo "âœ… æ•…éšœè½¬ç§»å®Œæˆï¼Œå½“å‰æ´»è·ƒå®ä¾‹: $PROMETHEUS_BACKUP"
}

# æ‰§è¡Œæ•…éšœè½¬ç§»
failover_to_backup
```

---

## 6. â˜¸ï¸ Kubernetesç¯å¢ƒHA


### 6.1 Kubernetes HAæ¶æ„


**ğŸ—ï¸ K8séƒ¨ç½²æ¶æ„**
```
Kubernetesç¯å¢ƒHAéƒ¨ç½²ï¼š
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Ingress   â”‚
                â”‚ (nginx/lb)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Service   â”‚
                â”‚ (ClusterIP) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†™    â†˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Prometheus  â”‚ â”‚ Prometheus  â”‚
        â”‚   Pod-1     â”‚ â”‚   Pod-2     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    PVC      â”‚ â”‚    PVC      â”‚
        â”‚ (å­˜å‚¨å·)    â”‚ â”‚ (å­˜å‚¨å·)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 StatefulSetéƒ¨ç½²é…ç½®


**ğŸ“‹ StatefulSeté…ç½®**
```yaml
# prometheus-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: prometheus-ha
  namespace: monitoring
spec:
  serviceName: prometheus-ha
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:v2.40.0
        ports:
        - containerPort: 9090
        args:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--web.enable-lifecycle'
          - '--web.enable-admin-api'
          - '--storage.tsdb.retention.time=30d'
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus
        - name: prometheus-data
          mountPath: /prometheus
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi" 
            cpu: "2000m"
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
  volumeClaimTemplates:
  - metadata:
      name: prometheus-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 100Gi
```

**ğŸŒ Serviceé…ç½®**
```yaml
# prometheus-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus-ha
  namespace: monitoring
  labels:
    app: prometheus
spec:
  type: ClusterIP
  ports:
  - port: 9090
    targetPort: 9090
    name: prometheus
  selector:
    app: prometheus
---
# æ— å¤´æœåŠ¡ï¼Œç”¨äºStatefulSet
apiVersion: v1
kind: Service  
metadata:
  name: prometheus-headless
  namespace: monitoring
spec:
  clusterIP: None
  ports:
  - port: 9090
    name: prometheus
  selector:
    app: prometheus
```

### 6.3 ConfigMapé…ç½®ç®¡ç†


**âš™ï¸ åŠ¨æ€é…ç½®ç®¡ç†**
```yaml
# prometheus-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      external_labels:
        cluster: 'k8s-production'
        replica: '$(HOSTNAME)'  # ä½¿ç”¨Podåç§°ä½œä¸ºå‰¯æœ¬æ ‡è¯†
    
    rule_files:
      - /etc/prometheus/rules/*.yml
    
    scrape_configs:
      # Kubernetes API Server
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - default
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      # Kubeletç›‘æ§
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
        - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
          
    # è”é‚¦é…ç½®ï¼ˆå¦‚æœæ˜¯å¤šå±‚æ¶æ„ï¼‰
    - job_name: 'federate'
      scrape_interval: 60s
      honor_labels: true
      metrics_path: '/federate'
      params:
        'match[]':
          - '{job=~"kubernetes-.*"}'
          - '{__name__=~"up|container_.*"}'
      static_configs:
        - targets: ['prometheus-ha-0.prometheus-headless:9090']
      
  # å‘Šè­¦è§„åˆ™
  rules.yml: |
    groups:
    - name: prometheus-ha
      rules:
      - alert: PrometheusDown
        expr: up{job="prometheus"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Prometheuså®ä¾‹ä¸‹çº¿"
          description: "{{ $labels.instance }} å·²ç¦»çº¿è¶…è¿‡5åˆ†é’Ÿ"
```

### 6.4 è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®


**ğŸ“ˆ HPAé…ç½®**
```yaml
# prometheus-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: prometheus-hpa
  namespace: monitoring
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: prometheus-ha
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 300
```

---

## 7. ğŸ”„ æ•°æ®ä¸€è‡´æ€§ä¿è¯


### 7.1 æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜


**ğŸ¯ ä¸€è‡´æ€§é—®é¢˜åˆ†æ**
```
Prometheus HAæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼š

é—®é¢˜1ï¼šæ—¶é—´åŒæ­¥å·®å¼‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å®ä¾‹1: 10:00 â”‚    â”‚å®ä¾‹2: 10:01 â”‚
â”‚é‡‡é›†æ•°æ®A    â”‚    â”‚é‡‡é›†æ•°æ®A    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“               â†“
    æ—¶é—´æˆ³ä¸åŒï¼Œæ•°æ®çœ‹èµ·æ¥ä¸ä¸€è‡´

é—®é¢˜2ï¼šç½‘ç»œåˆ†åŒº
å®ä¾‹1 â†â†’ X â†â†’ ç›®æ ‡æœåŠ¡ â†â†’ âœ“ â†â†’ å®ä¾‹2
(ç½‘ç»œä¸­æ–­)              (æ­£å¸¸è¿æ¥)
å®ä¾‹1ä¸¢å¤±æ•°æ®ï¼Œå®ä¾‹2æ­£å¸¸æ”¶é›†

é—®é¢˜3ï¼šé‡‡é›†é¡ºåºå·®å¼‚  
å®ä¾‹1ï¼šå…ˆé‡‡é›†AæœåŠ¡ï¼Œå†é‡‡é›†BæœåŠ¡
å®ä¾‹2ï¼šå…ˆé‡‡é›†BæœåŠ¡ï¼Œå†é‡‡é›†AæœåŠ¡
åœ¨å¿«é€Ÿå˜åŒ–æ—¶ï¼Œæ•°æ®å¿«ç…§ä¸ä¸€è‡´
```

### 7.2 æ—¶é—´åŒæ­¥è§£å†³æ–¹æ¡ˆ


**â° NTPæ—¶é—´åŒæ­¥**
```bash
# æ—¶é—´åŒæ­¥é…ç½®è„šæœ¬
#!/bin/bash
# sync-time.sh

# å®‰è£…NTP
sudo apt-get update
sudo apt-get install -y ntp

# é…ç½®NTPæœåŠ¡å™¨
cat > /etc/ntp.conf << EOF
# ä½¿ç”¨å¤šä¸ªæ—¶é—´æº
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst  
server 2.pool.ntp.org iburst
server 3.pool.ntp.org iburst

# æœ¬åœ°æ—¶é—´æºï¼ˆå¤‡ç”¨ï¼‰
server 127.127.1.0
fudge 127.127.1.0 stratum 10

# å…¶ä»–é…ç½®
driftfile /var/lib/ntp/drift
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict -6 ::1
EOF

# é‡å¯NTPæœåŠ¡
sudo systemctl restart ntp
sudo systemctl enable ntp

# éªŒè¯æ—¶é—´åŒæ­¥
ntpq -p
```

**ğŸ“Š æ—¶é—´åç§»ç›‘æ§**
```yaml
# æ—¶é—´åç§»ç›‘æ§è§„åˆ™
groups:
- name: time_sync
  rules:
  - alert: TimeOffsetHigh
    expr: abs(prometheus_config_last_reload_success_timestamp_seconds - time()) > 60
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Prometheusæ—¶é—´åç§»è¿‡å¤§"
      description: "å®ä¾‹ {{ $labels.instance }} æ—¶é—´åç§» {{ $value }} ç§’"
```

### 7.3 æŸ¥è¯¢æ—¶æ•°æ®å»é‡


**ğŸ” æŸ¥è¯¢å±‚é¢å»é‡ç­–ç•¥**
```promql
# 1. ä½¿ç”¨groupå»é‡ï¼ˆæ¨èï¼‰
# åŸå§‹æŸ¥è¯¢å¯èƒ½æœ‰é‡å¤æ•°æ®
cpu_usage_percent

# å»é‡æŸ¥è¯¢
group by (instance, job) (cpu_usage_percent)

# 2. ä½¿ç”¨max/minå»é‡
max by (instance, job) (cpu_usage_percent)

# 3. ä½¿ç”¨avgå»é‡ï¼ˆé€‚åˆæ•°å€¼æŒ‡æ ‡ï¼‰
avg by (instance, job) (cpu_usage_percent)

# 4. å¤æ‚å»é‡ï¼ˆåŸºäºexternal_labelsï¼‰
cpu_usage_percent{replica="prometheus-1"} 
or 
cpu_usage_percent{replica="prometheus-2"} 
unless 
cpu_usage_percent{replica="prometheus-1"}
```

**ğŸ“ˆ Grafanaä¸­çš„å»é‡è®¾ç½®**
```json
{
  "targets": [
    {
      "expr": "group by (instance) (up)",
      "legendFormat": "{{instance}}",
      "refId": "A"
    }
  ],
  "options": {
    "reduceOptions": {
      "values": false,
      "calcs": ["lastNotNull"],
      "fields": ""
    }
  }
}
```

### 7.4 å­˜å‚¨å±‚æ•°æ®åŒæ­¥


**ğŸ’¾ å…±äº«å­˜å‚¨æ–¹æ¡ˆ**
```yaml
# ä½¿ç”¨NFSå…±äº«å­˜å‚¨
apiVersion: v1
kind: PersistentVolume
metadata:
  name: prometheus-shared-pv
spec:
  capacity:
    storage: 200Gi
  accessModes:
    - ReadWriteMany  # å¤šä¸ªPodå¯åŒæ—¶è¯»å†™
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: nfs-server.company.com
    path: /data/prometheus
---
apiVersion: v1  
kind: PersistentVolumeClaim
metadata:
  name: prometheus-shared-pvc
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 200Gi
```

**ğŸ”„ æ•°æ®å¤‡ä»½åŒæ­¥è„šæœ¬**
```bash
#!/bin/bash
# data-sync.sh

SOURCE_DIR="/data/prometheus-master"
BACKUP_DIR="/data/prometheus-backup"
REMOTE_HOST="prometheus-backup.company.com"

# å®æ—¶æ•°æ®åŒæ­¥ï¼ˆä½¿ç”¨rsyncï¼‰
rsync_data() {
    rsync -avz --delete \
          --exclude 'wal' \
          --exclude 'chunks_head' \
          $SOURCE_DIR/ \
          $REMOTE_HOST:$BACKUP_DIR/
          
    if [ $? -eq 0 ]; then
        echo "$(date): æ•°æ®åŒæ­¥æˆåŠŸ âœ…"
    else
        echo "$(date): æ•°æ®åŒæ­¥å¤±è´¥ âŒ"
        # å‘é€å‘Šè­¦
        curl -X POST -H 'Content-type: application/json' \
             --data '{"text":"Prometheusæ•°æ®åŒæ­¥å¤±è´¥"}' \
             $SLACK_WEBHOOK
    fi
}

# å®šæœŸæ‰§è¡ŒåŒæ­¥
while true; do
    rsync_data
    sleep 300  # æ¯5åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
done
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é«˜å¯ç”¨æ¶æ„ï¼šæ¶ˆé™¤å•ç‚¹æ•…éšœï¼Œä¿è¯7Ã—24å°æ—¶ç›‘æ§æœåŠ¡
ğŸ”¸ å¤šå®ä¾‹éƒ¨ç½²ï¼šä¸»å¤‡æ¨¡å¼ç®€å•å¯é ï¼ŒåŒæ´»æ¨¡å¼æ€§èƒ½æ›´å¥½
ğŸ”¸ è”é‚¦é›†ç¾¤ï¼šåˆ†å±‚æ¶æ„ï¼Œä¸Šå±‚èšåˆä¸‹å±‚æ•°æ®ï¼Œæé«˜æ‰©å±•æ€§
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šæ™ºèƒ½åˆ†å‘è¯·æ±‚ï¼Œæä¾›ç»Ÿä¸€è®¿é—®å…¥å£
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šè‡ªåŠ¨æ£€æµ‹æ•…éšœï¼Œå¿«é€Ÿåˆ‡æ¢åˆ°å¥åº·å®ä¾‹
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼šé€šè¿‡æ—¶é—´åŒæ­¥ã€æŸ¥è¯¢å»é‡ä¿è¯æ•°æ®å‡†ç¡®æ€§
```

### 8.2 æ¶æ„é€‰æ‹©æŒ‡å¯¼


**ğŸ¯ æ–¹æ¡ˆé€‰æ‹©ä¾æ®**
```
å°è§„æ¨¡ç¯å¢ƒï¼ˆ<1000ä¸ªç›®æ ‡ï¼‰ï¼š
âœ… ä¸»å¤‡æ¨¡å¼ + å…±äº«å­˜å‚¨
âœ… ç®€å•å¯é ï¼Œç»´æŠ¤æˆæœ¬ä½

ä¸­ç­‰è§„æ¨¡ç¯å¢ƒï¼ˆ1000-10000ä¸ªç›®æ ‡ï¼‰ï¼š
âœ… åŒæ´»æ¨¡å¼ + è´Ÿè½½å‡è¡¡
âœ… è”é‚¦æ¶æ„ + åˆ†å±‚éƒ¨ç½²

å¤§è§„æ¨¡ç¯å¢ƒï¼ˆ>10000ä¸ªç›®æ ‡ï¼‰ï¼š
âœ… å¤šå±‚è”é‚¦ + åŒºåŸŸåˆ†å¸ƒ
âœ… Kubernetes + è‡ªåŠ¨æ‰©ç¼©å®¹
```

**ğŸ“Š æˆæœ¬æ•ˆç›Šåˆ†æ**
| æ–¹æ¡ˆç±»å‹ | **å¤æ‚åº¦** | **å¯é æ€§** | **æ€§èƒ½** | **ç»´æŠ¤æˆæœ¬** |
|---------|-----------|-----------|---------|-------------|
| ä¸»å¤‡æ¨¡å¼ | â­â­ | â­â­â­â­ | â­â­â­ | â­â­ |
| åŒæ´»æ¨¡å¼ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| è”é‚¦æ¶æ„ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

### 8.3 å®æ–½æœ€ä½³å®è·µ


**ğŸ”§ éƒ¨ç½²å‡†å¤‡å·¥ä½œ**
```
å‰æœŸå‡†å¤‡ï¼š
1ï¸âƒ£ åˆ¶å®šè¯¦ç»†çš„éƒ¨ç½²è®¡åˆ’
2ï¸âƒ£ å‡†å¤‡å……è¶³çš„ç¡¬ä»¶èµ„æº
3ï¸âƒ£ å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
4ï¸âƒ£ ç¼–å†™æ•…éšœå¤„ç†æ‰‹å†Œ
5ï¸âƒ£ åŸ¹è®­è¿ç»´äººå‘˜
```

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
ç¡¬ä»¶ä¼˜åŒ–ï¼š
â€¢ SSDå­˜å‚¨ï¼šæé«˜TSDBè¯»å†™æ€§èƒ½
â€¢ å……è¶³å†…å­˜ï¼šå‡å°‘ç£ç›˜IOï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦
â€¢ å¤šæ ¸CPUï¼šæ”¯æŒå¹¶å‘æŸ¥è¯¢å’Œæ•°æ®å¤„ç†

é…ç½®ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®æŠ“å–é—´éš”ï¼šå¹³è¡¡æ•°æ®ç²¾åº¦å’Œæ€§èƒ½
â€¢ ä¼˜åŒ–å­˜å‚¨ä¿ç•™ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®ä¿ç•™æ—¶é—´
â€¢ è°ƒæ•´æŸ¥è¯¢å¹¶å‘ï¼šæ ¹æ®ç¡¬ä»¶èƒ½åŠ›è®¾ç½®å¹¶å‘é™åˆ¶
```

**ğŸ”„ è¿ç»´ç®¡ç†å»ºè®®**
```
æ—¥å¸¸è¿ç»´ï¼š
âœ… å®šæœŸæ£€æŸ¥ç£ç›˜ç©ºé—´
âœ… ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
âœ… éªŒè¯æ•°æ®ä¸€è‡´æ€§
âœ… æµ‹è¯•æ•…éšœè½¬ç§»æµç¨‹
âœ… æ›´æ–°å’Œç»´æŠ¤é…ç½®

æ•…éšœå¤„ç†ï¼š
ğŸš¨ å»ºç«‹æ ‡å‡†çš„æ•…éšœå“åº”æµç¨‹
ğŸš¨ å‡†å¤‡åº”æ€¥å¤„ç†è„šæœ¬
ğŸš¨ å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ
ğŸš¨ è®°å½•å’Œåˆ†ææ•…éšœåŸå› 
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**â“ æ•°æ®ä¸ä¸€è‡´æ€ä¹ˆåŠ**
```
è§£å†³æ€è·¯ï¼š
1. æ£€æŸ¥æ—¶é—´åŒæ­¥çŠ¶æ€
2. éªŒè¯ç½‘ç»œè¿é€šæ€§
3. æŸ¥çœ‹é‡‡é›†é…ç½®å·®å¼‚
4. ä½¿ç”¨æŸ¥è¯¢æ—¶å»é‡
```

**â“ æ•…éšœè½¬ç§»å¤±è´¥æ€ä¹ˆåŠ**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥å¥åº·æ£€æŸ¥è„šæœ¬
2. éªŒè¯ç½‘ç»œé…ç½®
3. æŸ¥çœ‹æ—¥å¿—é”™è¯¯ä¿¡æ¯
4. æ‰‹åŠ¨æ‰§è¡Œæ•…éšœè½¬ç§»
```

**â“ æŸ¥è¯¢æ€§èƒ½ä¸‹é™æ€ä¹ˆåŠ**
```
ä¼˜åŒ–æ–¹æ³•ï¼š
1. å¢åŠ å®ä¾‹æ•°é‡
2. ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
3. è°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥  
4. å‡çº§ç¡¬ä»¶é…ç½®
```

**ğŸ¯ å…³é”®è®°å¿†è¦ç‚¹**
- é«˜å¯ç”¨æ¶æ„çš„æ ¸å¿ƒæ˜¯æ¶ˆé™¤å•ç‚¹æ•…éšœ
- æ•°æ®ä¸€è‡´æ€§éœ€è¦åœ¨æ—¶é—´ã€ç½‘ç»œã€å­˜å‚¨å¤šå±‚é¢ä¿è¯
- æ•…éšœè½¬ç§»è¦åšåˆ°å¿«é€Ÿã€å‡†ç¡®ã€å¯é 
- è”é‚¦æ¶æ„é€‚åˆå¤§è§„æ¨¡ç¯å¢ƒçš„åˆ†å±‚ç®¡ç†
- Kubernetesç¯å¢ƒä¸‹çš„HAæ›´åŠ çµæ´»å’Œè‡ªåŠ¨åŒ–

**ğŸ’¡ ä¸€å¥è¯æ€»ç»“**
> Prometheusé«˜å¯ç”¨ä¸ä»…è¦ä¿è¯æœåŠ¡æŒç»­è¿è¡Œï¼Œæ›´è¦ä¿è¯ç›‘æ§æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ï¼Œè¿™æ ·æ‰èƒ½ä¸ºä¸šåŠ¡ç³»ç»Ÿæä¾›å¯é çš„ç›‘æ§ä¿éšœã€‚