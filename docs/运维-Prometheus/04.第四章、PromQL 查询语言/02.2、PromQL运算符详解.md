---
title: 2ã€PromQLè¿ç®—ç¬¦è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [PromQLè¿ç®—ç¬¦æ¦‚è¿°](#1-PromQLè¿ç®—ç¬¦æ¦‚è¿°)
2. [ç®—æœ¯è¿ç®—ç¬¦è¯¦è§£](#2-ç®—æœ¯è¿ç®—ç¬¦è¯¦è§£)
3. [æ¯”è¾ƒè¿ç®—ç¬¦æ·±å…¥](#3-æ¯”è¾ƒè¿ç®—ç¬¦æ·±å…¥)
4. [é€»è¾‘è¿ç®—ç¬¦å®æˆ˜](#4-é€»è¾‘è¿ç®—ç¬¦å®æˆ˜)
5. [é›†åˆè¿ç®—ç¬¦åº”ç”¨](#5-é›†åˆè¿ç®—ç¬¦åº”ç”¨)
6. [è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸ç»“åˆæ€§](#6-è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸ç»“åˆæ€§)
7. [å‘é‡åŒ¹é…è§„åˆ™](#7-å‘é‡åŒ¹é…è§„åˆ™)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ PromQLè¿ç®—ç¬¦æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯PromQLè¿ç®—ç¬¦


**ç®€å•ç†è§£**ï¼šè¿ç®—ç¬¦å°±åƒæ•°å­¦ä¸­çš„åŠ å‡ä¹˜é™¤ç¬¦å·ï¼Œç”¨æ¥å¯¹ç›‘æ§æ•°æ®è¿›è¡Œå„ç§è®¡ç®—å’Œæ¯”è¾ƒã€‚

```
æƒ³è±¡ä¸€ä¸‹ï¼š
æ•°å­¦ï¼š2 + 3 = 5
PromQLï¼šcpu_usage + memory_usageï¼ˆè®¡ç®—æ€»èµ„æºä½¿ç”¨ç‡ï¼‰

æ•°å­¦ï¼š5 > 3ï¼ˆæ¯”è¾ƒå¤§å°ï¼‰
PromQLï¼šcpu_usage > 0.8ï¼ˆæ£€æŸ¥CPUä½¿ç”¨ç‡æ˜¯å¦è¶…è¿‡80%ï¼‰
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¢ **æ•°æ®è®¡ç®—**ï¼šå¯¹ç›‘æ§æŒ‡æ ‡è¿›è¡Œæ•°å­¦è¿ç®—
- ğŸ” **æ¡ä»¶è¿‡æ»¤**ï¼šç­›é€‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®
- ğŸ”— **æ•°æ®ç»„åˆ**ï¼šå°†å¤šä¸ªæŒ‡æ ‡åˆå¹¶åˆ†æ
- ğŸ“Š **é€»è¾‘åˆ¤æ–­**ï¼šå®ç°å¤æ‚çš„ç›‘æ§é€»è¾‘

### 1.2 è¿ç®—ç¬¦åˆ†ç±»æ€»è§ˆ


```
PromQLè¿ç®—ç¬¦å®¶æ—ï¼š

ğŸ“Š ç®—æœ¯è¿ç®—ç¬¦ï¼ˆåšæ•°å­¦è®¡ç®—ï¼‰
â”œâ”€â”€ + åŠ æ³•     â”œâ”€â”€ - å‡æ³•
â”œâ”€â”€ * ä¹˜æ³•     â”œâ”€â”€ / é™¤æ³•
â”œâ”€â”€ % å–ä½™     â””â”€â”€ ^ ä¹˜æ–¹

ğŸ” æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆåšå¤§å°æ¯”è¾ƒï¼‰
â”œâ”€â”€ == ç­‰äº    â”œâ”€â”€ != ä¸ç­‰äº
â”œâ”€â”€ > å¤§äº     â”œâ”€â”€ < å°äº
â”œâ”€â”€ >= å¤§äºç­‰äº â””â”€â”€ <= å°äºç­‰äº

ğŸ§  é€»è¾‘è¿ç®—ç¬¦ï¼ˆåšé€»è¾‘åˆ¤æ–­ï¼‰
â”œâ”€â”€ and ä¸”     â”œâ”€â”€ or æˆ–
â””â”€â”€ unless æ’é™¤

ğŸ”— é›†åˆè¿ç®—ç¬¦ï¼ˆå¤„ç†æ ‡ç­¾åŒ¹é…ï¼‰
â”œâ”€â”€ on         â”œâ”€â”€ ignoring
â”œâ”€â”€ group_left â””â”€â”€ group_right
```

### 1.3 è¿ç®—ç¬¦çš„åŸºæœ¬å·¥ä½œæ–¹å¼


**å‘é‡è¿ç®—åŸç†**ï¼š
```
å•ä¸ªæŒ‡æ ‡å€¼ï¼š
cpu_usage{instance="server1"} = 0.8

ä¸¤ä¸ªæŒ‡æ ‡ç›¸åŠ ï¼š
cpu_usage{instance="server1"} + memory_usage{instance="server1"}
= 0.8 + 0.6 = 1.4

æ ‡ç­¾åŒ¹é…è§„åˆ™ï¼š
åªæœ‰æ ‡ç­¾å®Œå…¨ç›¸åŒçš„æ—¶åºæ•°æ®æ‰èƒ½è¿›è¡Œè¿ç®—
```

---

## 2. ğŸ”¢ ç®—æœ¯è¿ç®—ç¬¦è¯¦è§£


### 2.1 åŸºç¡€ç®—æœ¯è¿ç®—


**åŠ æ³•è¿ç®—ç¬¦ï¼ˆ+ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šè®¡ç®—æ€»å’Œã€ç´¯åŠ å€¼

```promql
# è®¡ç®—CPUå’Œå†…å­˜çš„æ€»ä½¿ç”¨ç‡
cpu_usage + memory_usage

# è®¡ç®—æœåŠ¡å™¨æ€»è´Ÿè½½
load1 + load5 + load15

# ç½‘ç»œæ€»æµé‡ï¼ˆå…¥ç«™+å‡ºç«™ï¼‰
network_receive_bytes + network_transmit_bytes
```

**å‡æ³•è¿ç®—ç¬¦ï¼ˆ-ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šè®¡ç®—å·®å€¼ã€å‰©ä½™é‡

```promql
# è®¡ç®—å¯ç”¨å†…å­˜
memory_total - memory_used

# è®¡ç®—ç£ç›˜å‰©ä½™ç©ºé—´
disk_total - disk_used

# è®¡ç®—æ€§èƒ½æå‡å¹…åº¦
current_response_time - baseline_response_time
```

**ä¹˜æ³•è¿ç®—ç¬¦ï¼ˆ*ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šè®¡ç®—ä¹˜ç§¯ã€è½¬æ¢å•ä½

```promql
# å°†å­—èŠ‚è½¬æ¢ä¸ºMBï¼ˆé™¤ä»¥1024*1024ï¼‰
disk_usage_bytes / 1024 / 1024

# è®¡ç®—ç™¾åˆ†æ¯”
(memory_used / memory_total) * 100

# è®¡ç®—æ¯ç§’è¯·æ±‚æ•°ä¹˜ä»¥å¹³å‡å“åº”æ—¶é—´
http_requests_per_sec * avg_response_time
```

**é™¤æ³•è¿ç®—ç¬¦ï¼ˆ/ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šè®¡ç®—æ¯”ç‡ã€å¹³å‡å€¼

```promql
# è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
memory_used / memory_total

# è®¡ç®—é”™è¯¯ç‡
http_errors / http_total_requests

# è®¡ç®—å¹³å‡å“åº”æ—¶é—´
sum(response_time) / count(requests)
```

### 2.2 é«˜çº§ç®—æœ¯è¿ç®—


**å–ä½™è¿ç®—ç¬¦ï¼ˆ%ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šå‘¨æœŸæ€§è®¡ç®—ã€å–æ¨¡è¿ç®—

```promql
# æ£€æŸ¥æ˜¯å¦ä¸ºå¶æ•°å°æ—¶ï¼ˆç”¨äºå®šæ—¶ä»»åŠ¡ï¼‰
hour() % 2

# è´Ÿè½½å‡è¡¡è½®è¯¢è®¡ç®—
instance_id % server_count

# æ—¶é—´åˆ†ç‰‡è®¡ç®—
timestamp() % 3600  # æ¯å°æ—¶å†…çš„ç§’æ•°
```

**ä¹˜æ–¹è¿ç®—ç¬¦ï¼ˆ^ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šæŒ‡æ•°è®¡ç®—ã€éçº¿æ€§å˜æ¢

```promql
# è®¡ç®—å¹³æ–¹ï¼ˆç”¨äºæ–¹å·®è®¡ç®—ï¼‰
(value - avg_value) ^ 2

# æŒ‡æ•°å¢é•¿è®¡ç®—
base_value ^ growth_factor

# éçº¿æ€§å‘Šè­¦é˜ˆå€¼
normal_threshold ^ severity_level
```

### 2.3 ç®—æœ¯è¿ç®—å®é™…åº”ç”¨


**ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šæœåŠ¡å™¨æ€§èƒ½è¯„åˆ†**

```promql
# æœåŠ¡å™¨ç»¼åˆæ€§èƒ½è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰
(
  (1 - cpu_usage) * 40 +           # CPUæƒé‡40%
  (memory_available / memory_total) * 30 +  # å†…å­˜æƒé‡30%
  (disk_available / disk_total) * 20 +      # ç£ç›˜æƒé‡20%
  (1 - network_usage_percent) * 10          # ç½‘ç»œæƒé‡10%
) * 100
```

**ğŸ”¥ å¸¸è§ä½¿ç”¨åœºæ™¯**

| åœºæ™¯ | è¿ç®—ç¬¦ | ç¤ºä¾‹ | è¯´æ˜ |
|------|--------|------|------|
| **å®¹é‡è§„åˆ’** | `/` | `disk_used / disk_total` | è®¡ç®—ä½¿ç”¨ç‡ |
| **æ€§èƒ½å¯¹æ¯”** | `-` | `current_latency - baseline_latency` | è®¡ç®—æ€§èƒ½å·®å¼‚ |
| **èµ„æºæ±‡æ€»** | `+` | `cpu_cores + memory_gb + disk_tb` | è®¡ç®—æ€»èµ„æº |
| **å•ä½è½¬æ¢** | `*` `/ ` | `bytes * 8 / 1000000` | å­—èŠ‚è½¬Mbps |
| **é˜ˆå€¼è®¡ç®—** | `^` | `base_threshold ^ alert_level` | åŠ¨æ€é˜ˆå€¼ |

---

## 3. ğŸ” æ¯”è¾ƒè¿ç®—ç¬¦æ·±å…¥


### 3.1 ç›¸ç­‰æ€§æ¯”è¾ƒ


**ç­‰äºè¿ç®—ç¬¦ï¼ˆ==ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šç­›é€‰ç‰¹å®šå€¼ã€çŠ¶æ€æ£€æŸ¥

```promql
# ç­›é€‰CPUä½¿ç”¨ç‡æ­£å¥½ä¸º50%çš„å®ä¾‹
cpu_usage == 0.5

# æ£€æŸ¥æœåŠ¡çŠ¶æ€ä¸º1ï¼ˆæ­£å¸¸ï¼‰çš„å®ä¾‹
service_status == 1

# ç­›é€‰ç‰¹å®šç«¯å£çš„è¿æ¥
connection_port == 80
```

**ä¸ç­‰äºè¿ç®—ç¬¦ï¼ˆ!=ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šæ’é™¤ç‰¹å®šå€¼ã€å¼‚å¸¸æ£€æµ‹

```promql
# æ’é™¤CPUä½¿ç”¨ç‡ä¸º0çš„å®ä¾‹ï¼ˆå¯èƒ½å·²ä¸‹çº¿ï¼‰
cpu_usage != 0

# æ£€æŸ¥éæ­£å¸¸çŠ¶æ€çš„æœåŠ¡
service_status != 1

# æ’é™¤æœ¬åœ°å›ç¯åœ°å€
connection_remote_addr != "127.0.0.1"
```

### 3.2 å¤§å°æ¯”è¾ƒ


**å¤§äºè¿ç®—ç¬¦ï¼ˆ>ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šå‘Šè­¦æ¡ä»¶ã€é˜ˆå€¼æ£€æŸ¥

```promql
# CPUä½¿ç”¨ç‡è¶…è¿‡80%å‘Šè­¦
cpu_usage > 0.8

# å“åº”æ—¶é—´è¶…è¿‡1ç§’
response_time > 1

# é”™è¯¯ç‡è¶…è¿‡5%
error_rate > 0.05
```

**å°äºè¿ç®—ç¬¦ï¼ˆ<ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šèµ„æºå……è¶³æ£€æŸ¥ã€æ€§èƒ½è‰¯å¥½åˆ¤æ–­

```promql
# å†…å­˜ä½¿ç”¨ç‡ä½äº20%ï¼ˆå¯èƒ½èµ„æºæµªè´¹ï¼‰
memory_usage < 0.2

# å“åº”æ—¶é—´å°äº100msï¼ˆæ€§èƒ½è‰¯å¥½ï¼‰
response_time < 0.1

# é˜Ÿåˆ—é•¿åº¦å°äº10ï¼ˆå¤„ç†åŠæ—¶ï¼‰
queue_length < 10
```

**å¤§äºç­‰äº/å°äºç­‰äºï¼ˆ>=ã€<=ï¼‰**

ğŸ¯ **ç”¨é€”**ï¼šèŒƒå›´æ£€æŸ¥ã€è¾¹ç•Œæ¡ä»¶

```promql
# CPUä½¿ç”¨ç‡åœ¨80%åŠä»¥ä¸Š
cpu_usage >= 0.8

# ç£ç›˜ä½¿ç”¨ç‡ä¸è¶…è¿‡90%
disk_usage <= 0.9

# æœåŠ¡å¯ç”¨æ€§è‡³å°‘99%
availability >= 0.99
```

### 3.3 æ¯”è¾ƒè¿ç®—å®é™…åº”ç”¨


**ğŸ“Š å‘Šè­¦è§„åˆ™ç¤ºä¾‹**

```promql
# ğŸ”´ ä¸¥é‡å‘Šè­¦ï¼šCPUä½¿ç”¨ç‡è¶…è¿‡90%
cpu_usage > 0.9

# ğŸŸ¡ è­¦å‘Šå‘Šè­¦ï¼šå†…å­˜ä½¿ç”¨ç‡åœ¨80%-90%ä¹‹é—´
memory_usage > 0.8 and memory_usage <= 0.9

# ğŸŸ¢ æ­£å¸¸çŠ¶æ€ï¼šå“åº”æ—¶é—´å°äº200ms
response_time <= 0.2
```

**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**

```
ç”µå•†ç½‘ç«™ç›‘æ§ï¼š

æ€§èƒ½ç›‘æ§ï¼š
â”œâ”€â”€ response_time > 1        # é¡µé¢å“åº”è¶…æ—¶
â”œâ”€â”€ error_rate > 0.01        # é”™è¯¯ç‡è¶…è¿‡1%
â””â”€â”€ concurrent_users > 10000 # å¹¶å‘ç”¨æˆ·è¿‡å¤š

èµ„æºç›‘æ§ï¼š
â”œâ”€â”€ cpu_usage > 0.8          # CPUå‹åŠ›å¤§
â”œâ”€â”€ memory_usage > 0.9       # å†…å­˜ä¸è¶³
â””â”€â”€ disk_free < 0.1          # ç£ç›˜ç©ºé—´ç´§å¼ 
```

---

## 4. ğŸ§  é€»è¾‘è¿ç®—ç¬¦å®æˆ˜


### 4.1 ANDè¿ç®—ç¬¦æ·±å…¥


**åŸºæœ¬æ¦‚å¿µ**ï¼š`and` è¡¨ç¤º"åŒæ—¶æ»¡è¶³"ï¼Œä¸¤ä¸ªæ¡ä»¶éƒ½ä¸ºçœŸæ—¶æ‰è¿”å›ç»“æœ

ğŸ¯ **å…¸å‹åº”ç”¨åœºæ™¯**

```promql
# åŒæ—¶æ»¡è¶³é«˜CPUå’Œé«˜å†…å­˜ä½¿ç”¨
cpu_usage > 0.8 and memory_usage > 0.8

# é«˜è´Ÿè½½ä¸”å“åº”æ—¶é—´é•¿çš„æœåŠ¡å™¨
load_average > 2 and response_time > 1

# é”™è¯¯ç‡é«˜ä¸”è¯·æ±‚é‡å¤§çš„æœåŠ¡
error_rate > 0.05 and request_rate > 1000
```

**ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šå¤åˆå‘Šè­¦æ¡ä»¶**

```promql
# æœåŠ¡å™¨å‹åŠ›å‘Šè­¦ï¼ˆéœ€è¦åŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶ï¼‰
(
  cpu_usage > 0.8 and
  memory_usage > 0.9 and
  load_average > 3
)

# æ•°æ®åº“æ€§èƒ½å‘Šè­¦
(
  db_connections > 80 and
  db_query_time > 5 and
  db_lock_waits > 100
)
```

### 4.2 ORè¿ç®—ç¬¦åº”ç”¨


**åŸºæœ¬æ¦‚å¿µ**ï¼š`or` è¡¨ç¤º"æ»¡è¶³å…¶ä¸€"ï¼Œä»»æ„ä¸€ä¸ªæ¡ä»¶ä¸ºçœŸå°±è¿”å›ç»“æœ

ğŸ¯ **å…¸å‹åº”ç”¨åœºæ™¯**

```promql
# CPUæˆ–å†…å­˜ä»»ä¸€èµ„æºç´§å¼ 
cpu_usage > 0.8 or memory_usage > 0.8

# ç½‘ç»œæˆ–ç£ç›˜IOå¼‚å¸¸
network_errors > 100 or disk_io_errors > 50

# å¤šç§é”™è¯¯ç±»å‹ç›‘æ§
http_5xx_errors > 10 or connection_errors > 5
```

**ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šå¤šæ¡ä»¶è§¦å‘**

```promql
# èµ„æºå‘Šè­¦ï¼ˆä»»ä¸€èµ„æºç´§å¼ å°±å‘Šè­¦ï¼‰
(
  cpu_usage > 0.9 or
  memory_usage > 0.95 or
  disk_usage > 0.95
)

# æœåŠ¡å¼‚å¸¸æ£€æµ‹
(
  service_status != 1 or
  health_check_failed > 0 or
  response_time > 10
)
```

### 4.3 UNLESSè¿ç®—ç¬¦å¦™ç”¨


**åŸºæœ¬æ¦‚å¿µ**ï¼š`unless` è¡¨ç¤º"æ’é™¤"ï¼Œä»å·¦è¾¹ç»“æœä¸­æ’é™¤å³è¾¹ä¸ºçœŸçš„éƒ¨åˆ†

ğŸ¯ **å…¸å‹åº”ç”¨åœºæ™¯**

```promql
# é«˜CPUä½¿ç”¨ä½†æ’é™¤å·²çŸ¥çš„æ‰¹å¤„ç†æœåŠ¡å™¨
cpu_usage > 0.8 unless job == "batch_processor"

# æ‰€æœ‰é”™è¯¯ä½†æ’é™¤é¢„æœŸçš„ç»´æŠ¤é”™è¯¯
http_errors unless error_type == "maintenance"

# é«˜å†…å­˜ä½¿ç”¨ä½†æ’é™¤ç¼“å­˜æœåŠ¡å™¨
memory_usage > 0.9 unless service_type == "cache"
```

**ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šæ™ºèƒ½è¿‡æ»¤**

```promql
# æ’é™¤æµ‹è¯•ç¯å¢ƒçš„å‘Šè­¦
(
  cpu_usage > 0.8 or memory_usage > 0.8
) unless env == "test"

# æ’é™¤å·²çŸ¥é—®é¢˜çš„ç›‘æ§
service_down == 1 unless (
  maintenance_mode == 1 or
  planned_downtime == 1
)
```

### 4.4 é€»è¾‘è¿ç®—ç¬¦ç»„åˆä½¿ç”¨


**å¤æ‚é€»è¾‘è¡¨è¾¾å¼**

```promql
# ä¸šåŠ¡é«˜å³°æœŸçš„æ€§èƒ½ç›‘æ§
(
  (cpu_usage > 0.7 and memory_usage > 0.7) or
  response_time > 2
) and hour() >= 9 and hour() <= 17  # å·¥ä½œæ—¶é—´

# åˆ†å±‚å‘Šè­¦é€»è¾‘
(
  # ç´§æ€¥å‘Šè­¦
  (cpu_usage > 0.9 and memory_usage > 0.9) or
  # è­¦å‘Šçº§åˆ«
  (cpu_usage > 0.8 or memory_usage > 0.8)
) unless maintenance_window == 1
```

**ğŸ”¥ å®ç”¨ç»„åˆæ¨¡å¼**

| æ¨¡å¼ | è¡¨è¾¾å¼ | åº”ç”¨åœºæ™¯ |
|------|--------|----------|
| **ä¸¥æ ¼æ¡ä»¶** | `A and B and C` | æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ‰å‘Šè­¦ |
| **å®½æ¾æ¡ä»¶** | `A or B or C` | ä»»ä¸€æ¡ä»¶æ»¡è¶³å°±å‘Šè­¦ |
| **æ’é™¤æ¨¡å¼** | `A unless B` | æ»¡è¶³Aä½†æ’é™¤Bçš„æƒ…å†µ |
| **åˆ†çº§åˆ¤æ–­** | `(A and B) or C` | å¤åˆæ¡ä»¶æˆ–å•ä¸€ä¸¥é‡æ¡ä»¶ |

---

## 5. ğŸ”— é›†åˆè¿ç®—ç¬¦åº”ç”¨


### 5.1 æ ‡ç­¾åŒ¹é…åŸºç¡€


**ä»€ä¹ˆæ˜¯æ ‡ç­¾åŒ¹é…**ï¼š
å½“ä¸¤ä¸ªæ—¶é—´åºåˆ—è¿›è¡Œè¿ç®—æ—¶ï¼ŒPrometheuséœ€è¦çŸ¥é“å“ªäº›æ•°æ®åº”è¯¥é…å¯¹è®¡ç®—ã€‚

```
ç†è§£æ ‡ç­¾åŒ¹é…ï¼š

æ—¶é—´åºåˆ—Aï¼šcpu_usage{instance="server1", job="web"}
æ—¶é—´åºåˆ—Bï¼šmemory_usage{instance="server1", job="web"}

åŒ¹é…æ¡ä»¶ï¼šinstanceå’Œjobæ ‡ç­¾éƒ½ç›¸åŒ
ç»“æœï¼šå¯ä»¥è¿›è¡Œè¿ç®—

ä¸åŒ¹é…ç¤ºä¾‹ï¼š
æ—¶é—´åºåˆ—Aï¼šcpu_usage{instance="server1", job="web"}
æ—¶é—´åºåˆ—Bï¼šmemory_usage{instance="server2", job="db"}
ç»“æœï¼šæ— æ³•é…å¯¹ï¼Œä¸å‚ä¸è¿ç®—
```

### 5.2 ONè¿ç®—ç¬¦è¯¦è§£


**åŸºæœ¬æ¦‚å¿µ**ï¼š`on` æŒ‡å®šä½¿ç”¨å“ªäº›æ ‡ç­¾è¿›è¡ŒåŒ¹é…

ğŸ¯ **ä½¿ç”¨åœºæ™¯**ï¼šå½“ä½ åªæƒ³åŸºäºç‰¹å®šæ ‡ç­¾è¿›è¡ŒåŒ¹é…æ—¶

```promql
# åªåŸºäºinstanceæ ‡ç­¾åŒ¹é…ï¼Œå¿½ç•¥å…¶ä»–æ ‡ç­¾å·®å¼‚
cpu_usage + memory_usage on (instance)

# åŸºäºå¤šä¸ªæ ‡ç­¾åŒ¹é…
network_in + network_out on (instance, device)

# åªå…³å¿ƒä¸»æœºååŒ¹é…
disk_read + disk_write on (hostname)
```

**ğŸ’¡ å®æˆ˜ç¤ºä¾‹**

```promql
# åœºæ™¯ï¼šè®¡ç®—æ¯å°æœåŠ¡å™¨çš„æ€»èµ„æºä½¿ç”¨ç‡
# é—®é¢˜ï¼šCPUå’Œå†…å­˜æŒ‡æ ‡å¯èƒ½æœ‰ä¸åŒçš„jobæ ‡ç­¾
# è§£å†³ï¼šåªåŸºäºinstanceåŒ¹é…

cpu_usage{job="node_exporter"} + 
memory_usage{job="memory_monitor"} on (instance)

# ç»“æœï¼šå¿½ç•¥jobæ ‡ç­¾å·®å¼‚ï¼Œåªè¦instanceç›¸åŒå°±é…å¯¹
```

### 5.3 IGNORINGè¿ç®—ç¬¦è¯¦è§£


**åŸºæœ¬æ¦‚å¿µ**ï¼š`ignoring` æŒ‡å®šå¿½ç•¥å“ªäº›æ ‡ç­¾ï¼Œä½¿ç”¨å…¶ä½™æ ‡ç­¾è¿›è¡ŒåŒ¹é…

ğŸ¯ **ä½¿ç”¨åœºæ™¯**ï¼šå½“æŸäº›æ ‡ç­¾ä¸é‡è¦ï¼Œæƒ³è¦å¿½ç•¥æ—¶

```promql
# å¿½ç•¥jobæ ‡ç­¾ï¼Œä½¿ç”¨å…¶ä»–æ ‡ç­¾åŒ¹é…
cpu_usage + memory_usage ignoring (job)

# å¿½ç•¥å¤šä¸ªæ ‡ç­¾
rate(http_requests_total[5m]) / 
rate(http_requests_total[5m]) ignoring (method, status)

# å¿½ç•¥æ—¶é—´æˆ³ç›¸å…³æ ‡ç­¾
current_value - previous_value ignoring (timestamp)
```

**ğŸ’¡ å®æˆ˜ç¤ºä¾‹**

```promql
# åœºæ™¯ï¼šæ¯”è¾ƒä¸åŒç›‘æ§ç³»ç»Ÿçš„ç›¸åŒæŒ‡æ ‡
# é—®é¢˜ï¼šä¸¤ä¸ªç³»ç»Ÿå¯èƒ½æœ‰ä¸åŒçš„sourceæ ‡ç­¾
# è§£å†³ï¼šå¿½ç•¥sourceæ ‡ç­¾

prometheus_cpu_usage ignoring (source) /
zabbix_cpu_usage ignoring (source)

# ç»“æœï¼šåªè¦å…¶ä»–æ ‡ç­¾åŒ¹é…å°±è¿›è¡Œè®¡ç®—
```

### 5.4 GROUP_LEFTå’ŒGROUP_RIGHT


**åŸºæœ¬æ¦‚å¿µ**ï¼šå¤„ç†ä¸€å¯¹å¤šçš„åŒ¹é…å…³ç³»

**GROUP_LEFT**ï¼šå·¦ä¾§æœ‰å¤šä¸ªåŒ¹é…é¡¹

```promql
# å·¦ä¾§æ¯ä¸ªå®ä¾‹çš„æŒ‡æ ‡ åŒ¹é… å³ä¾§æ±‡æ€»ä¿¡æ¯
instance_cpu_usage * on (cluster) group_left
cluster_cpu_limit

# ç†è§£ï¼š
# å·¦ä¾§ï¼šå¤šä¸ªinstanceçš„CPUä½¿ç”¨ç‡
# å³ä¾§ï¼šæ¯ä¸ªclusterçš„CPUé™åˆ¶ï¼ˆä¸€ä¸ªå€¼ï¼‰
# ç»“æœï¼šæ¯ä¸ªinstanceéƒ½ä¹˜ä»¥å…¶æ‰€åœ¨clusterçš„é™åˆ¶
```

**GROUP_RIGHT**ï¼šå³ä¾§æœ‰å¤šä¸ªåŒ¹é…é¡¹

```promql
# é›†ç¾¤æ€»é™åˆ¶ åŒ¹é… æ¯ä¸ªå®ä¾‹çš„ä½¿ç”¨ç‡
cluster_cpu_limit * on (cluster) group_right  
instance_cpu_usage

# ä½œç”¨ï¼šå°†é›†ç¾¤é™åˆ¶åˆ†é…ç»™æ¯ä¸ªå®ä¾‹è®¡ç®—
```

### 5.5 é›†åˆè¿ç®—å®æˆ˜æ¡ˆä¾‹


**ğŸ¢ ä¼ä¸šç›‘æ§åœºæ™¯**

```promql
# è®¡ç®—æ¯å°æœåŠ¡å™¨çš„èµ„æºä½¿ç”¨è¯„åˆ†
# è€ƒè™‘ä¸åŒçš„æƒé‡é…ç½®

# åŸºç¡€æŒ‡æ ‡ï¼ˆå¤šä¸ªå®ä¾‹ï¼‰
instance_cpu_usage * on (instance) group_left(weight)
instance_weight_config

# å¿½ç•¥ä¸é‡è¦çš„æ ‡ç­¾
(
  cpu_usage + memory_usage + disk_usage
) ignoring (collector, version) / 3

# åªåŸºäºå…³é”®æ ‡ç­¾åŒ¹é…
application_response_time / on (service, environment)
application_sla_target
```

**ğŸ“Š åŒ¹é…è§„åˆ™å¯¹æ¯”è¡¨**

| è¿ç®—ç¬¦ | ä½œç”¨ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|--------|------|----------|------|
| `on(labels)` | åªä½¿ç”¨æŒ‡å®šæ ‡ç­¾åŒ¹é… | æ ‡ç­¾ä¸ä¸€è‡´ä½†æ ¸å¿ƒç›¸åŒ | `A + B on (instance)` |
| `ignoring(labels)` | å¿½ç•¥æŒ‡å®šæ ‡ç­¾åŒ¹é… | æŸäº›æ ‡ç­¾ä¸é‡è¦ | `A + B ignoring (job)` |
| `group_left` | å·¦ä¾§å¤šå¯¹å³ä¾§å°‘ | å®ä¾‹å¯¹é›†ç¾¤é…ç½® | `A * on(cluster) group_left B` |
| `group_right` | å³ä¾§å¤šå¯¹å·¦ä¾§å°‘ | é…ç½®å¯¹å®ä¾‹åˆ†é… | `A * on(cluster) group_right B` |

---

## 6. âš¡ è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸ç»“åˆæ€§


### 6.1 ä¼˜å…ˆçº§è§„åˆ™


**PromQLè¿ç®—ç¬¦ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰**

```
ä¼˜å…ˆçº§æ’åºï¼š

1ï¸âƒ£ æœ€é«˜ï¼šä¹˜æ–¹ (^)
2ï¸âƒ£ ä¹˜é™¤ï¼š*, /, %
3ï¸âƒ£ åŠ å‡ï¼š+, -  
4ï¸âƒ£ æ¯”è¾ƒï¼š==, !=, <, <=, >, >=
5ï¸âƒ£ é€»è¾‘ï¼šand, unless
6ï¸âƒ£ æœ€ä½ï¼šor
```

**å®é™…è¿ç®—é¡ºåºç¤ºä¾‹**

```promql
# è¡¨è¾¾å¼ï¼š2 + 3 * 4 ^ 2
# è®¡ç®—é¡ºåºï¼š
# 1. 4 ^ 2 = 16 ï¼ˆä¹˜æ–¹æœ€ä¼˜å…ˆï¼‰
# 2. 3 * 16 = 48 ï¼ˆä¹˜æ³•æ¬¡ä¹‹ï¼‰
# 3. 2 + 48 = 50 ï¼ˆåŠ æ³•æœ€åï¼‰

# PromQLç¤ºä¾‹
cpu_usage + memory_usage * disk_usage ^ 2
# è®¡ç®—é¡ºåºï¼š
# 1. disk_usage ^ 2
# 2. memory_usage * (disk_usage ^ 2)
# 3. cpu_usage + (å‰é¢çš„ç»“æœ)
```

### 6.2 æ‹¬å·çš„é‡è¦æ€§


**ğŸ”§ ä½¿ç”¨æ‹¬å·æ”¹å˜ä¼˜å…ˆçº§**

```promql
# ä¸ä½¿ç”¨æ‹¬å·ï¼ˆæŒ‰é»˜è®¤ä¼˜å…ˆçº§ï¼‰
cpu_usage + memory_usage > 0.8
# å®é™…è®¡ç®—ï¼šcpu_usage + (memory_usage > 0.8)
# å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ç»“æœï¼

# ä½¿ç”¨æ‹¬å·æ˜ç¡®æ„å›¾
(cpu_usage + memory_usage) > 0.8
# å…ˆç®—æ€»å’Œï¼Œå†æ¯”è¾ƒ

# å¤æ‚è¡¨è¾¾å¼ä¸­çš„æ‹¬å·
(cpu_usage > 0.8 and memory_usage > 0.8) or 
(disk_usage > 0.9 and network_errors > 100)
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**

```promql
# âŒ ä¸æ¸…æ™°çš„è¡¨è¾¾å¼
cpu_usage > 0.8 and memory_usage > 0.7 or disk_usage > 0.9

# âœ… æ¸…æ™°çš„è¡¨è¾¾å¼
(cpu_usage > 0.8 and memory_usage > 0.7) or (disk_usage > 0.9)

# âŒ å¤æ‚è®¡ç®—æ— æ‹¬å·
a + b * c / d - e > threshold

# âœ… æ¸…æ™°çš„è®¡ç®—é¡ºåº
(a + (b * c / d) - e) > threshold
```

### 6.3 ç»“åˆæ€§è§„åˆ™


**å·¦ç»“åˆæ€§ï¼ˆå¤§éƒ¨åˆ†è¿ç®—ç¬¦ï¼‰**

```promql
# è¿ç»­ç›¸åŒä¼˜å…ˆçº§è¿ç®—ç¬¦ä»å·¦åˆ°å³è®¡ç®—
a - b - c 
# ç­‰ä»·äºï¼š(a - b) - c

a / b / c
# ç­‰ä»·äºï¼š(a / b) / c

# é€»è¾‘è¿ç®—ç¬¦ä¹Ÿæ˜¯å·¦ç»“åˆ
a and b and c
# ç­‰ä»·äºï¼š(a and b) and c
```

**å³ç»“åˆæ€§ï¼ˆä¹˜æ–¹è¿ç®—ç¬¦ï¼‰**

```promql
# ä¹˜æ–¹æ˜¯å³ç»“åˆçš„
a ^ b ^ c
# ç­‰ä»·äºï¼ša ^ (b ^ c)

# å®é™…ç¤ºä¾‹
2 ^ 3 ^ 2
# è®¡ç®—ï¼š2 ^ (3 ^ 2) = 2 ^ 9 = 512
# è€Œä¸æ˜¯ï¼š(2 ^ 3) ^ 2 = 8 ^ 2 = 64
```

### 6.4 å¤æ‚è¡¨è¾¾å¼è§£æ


**ğŸ§® å®æˆ˜å¤æ‚è¡¨è¾¾å¼åˆ†æ**

```promql
# å¤æ‚ç›‘æ§è¡¨è¾¾å¼
cpu_usage > 0.8 and memory_usage > 0.7 or 
disk_usage > 0.9 and network_errors_rate > 0.05 unless 
maintenance_mode == 1

# åŠ æ‹¬å·æ˜ç¡®æ„å›¾
(
  (cpu_usage > 0.8 and memory_usage > 0.7) or
  (disk_usage > 0.9 and network_errors_rate > 0.05)
) unless (maintenance_mode == 1)
```

**âš ï¸ å¸¸è§ä¼˜å…ˆçº§é™·é˜±**

```promql
# é™·é˜±1ï¼šæ¯”è¾ƒä¸ç®—æœ¯æ··åˆ
rate + 1 > 2
# å®é™…ï¼šrate + (1 > 2) âŒ
# æœŸæœ›ï¼š(rate + 1) > 2 âœ…

# é™·é˜±2ï¼šé€»è¾‘ä¸æ¯”è¾ƒæ··åˆ
cpu > 0.8 and memory > 0.7 or disk > 0.9
# å®é™…ï¼š((cpu > 0.8 and memory > 0.7) or disk) > 0.9 âŒ
# æœŸæœ›ï¼š(cpu > 0.8 and memory > 0.7) or (disk > 0.9) âœ…

# é™·é˜±3ï¼šç®—æœ¯ä¸é€»è¾‘æ··åˆ
a + b and c * d
# å®é™…ï¼š(a + b) and (c * d) âœ…ï¼ˆè¿™ä¸ªæ˜¯å¯¹çš„ï¼‰
```

---

## 7. ğŸ¯ å‘é‡åŒ¹é…è§„åˆ™


### 7.1 ä»€ä¹ˆæ˜¯å‘é‡åŒ¹é…


**åŸºæœ¬æ¦‚å¿µ**ï¼š
å‘é‡åŒ¹é…æ˜¯æŒ‡å½“ä¸¤ä¸ªå‘é‡ï¼ˆæ—¶é—´åºåˆ—é›†åˆï¼‰è¿›è¡Œè¿ç®—æ—¶ï¼Œå¦‚ä½•ç¡®å®šå“ªäº›æ—¶é—´åºåˆ—åº”è¯¥é…å¯¹è®¡ç®—ã€‚

```
ç®€å•ç†è§£ï¼š

æƒ³è±¡ä½ æœ‰ä¸¤ç»„æ•°æ®ï¼š
ç»„Aï¼š[æœåŠ¡å™¨1çš„CPU, æœåŠ¡å™¨2çš„CPU, æœåŠ¡å™¨3çš„CPU]
ç»„Bï¼š[æœåŠ¡å™¨1çš„å†…å­˜, æœåŠ¡å™¨2çš„å†…å­˜, æœåŠ¡å™¨3çš„å†…å­˜]

é…å¯¹è§„åˆ™ï¼š
æœåŠ¡å™¨1çš„CPU + æœåŠ¡å™¨1çš„å†…å­˜ âœ…
æœåŠ¡å™¨1çš„CPU + æœåŠ¡å™¨2çš„å†…å­˜ âŒï¼ˆä¸åŒ¹é…ï¼‰
```

### 7.2 ä¸€å¯¹ä¸€åŒ¹é…ï¼ˆ1:1ï¼‰


**é»˜è®¤åŒ¹é…æ¨¡å¼**ï¼šæ ‡ç­¾å®Œå…¨ç›¸åŒçš„æ—¶é—´åºåˆ—æ‰èƒ½é…å¯¹

```promql
# ç¤ºä¾‹æ•°æ®
cpu_usage{instance="web-1", job="nginx", env="prod"} 0.6
cpu_usage{instance="web-2", job="nginx", env="prod"} 0.8
memory_usage{instance="web-1", job="nginx", env="prod"} 0.4
memory_usage{instance="web-2", job="nginx", env="prod"} 0.7

# ä¸€å¯¹ä¸€åŒ¹é…è¿ç®—
cpu_usage + memory_usage

# åŒ¹é…ç»“æœï¼š
# web-1: 0.6 + 0.4 = 1.0
# web-2: 0.8 + 0.7 = 1.5
```

**ğŸ” åŒ¹é…æ¡ä»¶**ï¼š
- æ‰€æœ‰æ ‡ç­¾çš„é”®å’Œå€¼éƒ½å¿…é¡»å®Œå…¨ç›¸åŒ
- ç¼ºå°‘ä»»ä½•æ ‡ç­¾çš„æ—¶é—´åºåˆ—ä¸å‚ä¸åŒ¹é…
- å¤šä½™æ ‡ç­¾çš„æ—¶é—´åºåˆ—ä¹Ÿä¸å‚ä¸åŒ¹é…

### 7.3 ä¸€å¯¹å¤šåŒ¹é…ï¼ˆ1:Nï¼‰


**ä½¿ç”¨åœºæ™¯**ï¼šå½“ä¸€ä¸ªé…ç½®å€¼è¦åº”ç”¨åˆ°å¤šä¸ªå®ä¾‹æ—¶

```promql
# åœºæ™¯ï¼šæ¯ä¸ªé›†ç¾¤æœ‰ä¸€ä¸ªSLAé…ç½®ï¼Œå¤šä¸ªå®ä¾‹
cluster_sla_target{cluster="web", env="prod"} 0.99
instance_availability{instance="web-1", cluster="web", env="prod"} 0.98
instance_availability{instance="web-2", cluster="web", env="prod"} 0.97

# ä¸€å¯¹å¤šåŒ¹é…ï¼šæ¯ä¸ªå®ä¾‹æ¯”è¾ƒå„è‡ªé›†ç¾¤çš„SLA
instance_availability / on(cluster, env) group_left cluster_sla_target

# ç»“æœï¼š
# web-1: 0.98 / 0.99 = 0.989
# web-2: 0.97 / 0.99 = 0.979
```

**group_leftçš„å«ä¹‰**ï¼š
- å·¦ä¾§ï¼ˆinstance_availabilityï¼‰æœ‰å¤šä¸ªå€¼
- å³ä¾§ï¼ˆcluster_sla_targetï¼‰æœ‰ä¸€ä¸ªå€¼  
- å³ä¾§çš„å€¼ä¼šè¢«"å¤åˆ¶"ç»™å·¦ä¾§æ¯ä¸ªåŒ¹é…çš„å€¼

### 7.4 å¤šå¯¹ä¸€åŒ¹é…ï¼ˆN:1ï¼‰


**ä½¿ç”¨åœºæ™¯**ï¼šå¤šä¸ªå®ä¾‹çš„å€¼æ±‡æ€»åˆ°ä¸€ä¸ªç›®æ ‡

```promql
# åœºæ™¯ï¼šå¤šä¸ªå®ä¾‹çš„æŒ‡æ ‡æ±‡æ€»åˆ°é›†ç¾¤çº§åˆ«
sum(instance_cpu_usage) by (cluster) / on(cluster) group_right
cluster_cpu_limit

# group_rightçš„å«ä¹‰ï¼š
# å·¦ä¾§ï¼šé›†ç¾¤æ±‡æ€»å€¼ï¼ˆå°‘ï¼‰
# å³ä¾§ï¼šé›†ç¾¤é™åˆ¶å€¼ï¼ˆå¤šï¼Œæ¯ä¸ªå®ä¾‹ä¸€ä¸ªï¼‰
```

### 7.5 å‘é‡åŒ¹é…å®æˆ˜æŠ€å·§


**ğŸ› ï¸ å¸¸è§åŒ¹é…é—®é¢˜è§£å†³**

**é—®é¢˜1ï¼šæ ‡ç­¾ä¸åŒ¹é…**
```promql
# é—®é¢˜ï¼šæ ‡ç­¾åç§°ä¸åŒ
cpu_usage{host="web-1"} + memory_usage{instance="web-1"}
# è§£å†³ï¼šä½¿ç”¨label_replaceç»Ÿä¸€æ ‡ç­¾å

# é—®é¢˜ï¼šå¤šä½™æ ‡ç­¾å¯¼è‡´ä¸åŒ¹é…
cpu_usage{instance="web-1", job="nginx", version="1.0"}
memory_usage{instance="web-1", job="nginx"}
# è§£å†³ï¼šä½¿ç”¨ignoringå¿½ç•¥å¤šä½™æ ‡ç­¾
cpu_usage + memory_usage ignoring(version)
```

**é—®é¢˜2ï¼šåŒ¹é…ç²’åº¦æ§åˆ¶**
```promql
# åªæƒ³æŒ‰å®ä¾‹åŒ¹é…ï¼Œå¿½ç•¥å…¶ä»–æ ‡ç­¾å·®å¼‚
instance_metric_a + instance_metric_b on(instance)

# æƒ³è¦ç²¾ç¡®åŒ¹é…é™¤äº†æ—¶é—´æˆ³å¤–çš„æ‰€æœ‰æ ‡ç­¾
metric_a + metric_b ignoring(__name__)
```

**ğŸ’¡ åŒ¹é…ç­–ç•¥é€‰æ‹©**

| åœºæ™¯ | ç­–ç•¥ | è¡¨è¾¾å¼æ¨¡å¼ | è¯´æ˜ |
|------|------|------------|------|
| **ç›¸åŒæ ‡ç­¾é›†åˆ** | é»˜è®¤åŒ¹é… | `A + B` | æ ‡ç­¾å®Œå…¨ç›¸åŒæ‰åŒ¹é… |
| **éƒ¨åˆ†æ ‡ç­¾åŒ¹é…** | onæŒ‡å®š | `A + B on(instance)` | åªåŸºäºæŒ‡å®šæ ‡ç­¾åŒ¹é… |
| **å¿½ç•¥æŸäº›æ ‡ç­¾** | ignoring | `A + B ignoring(job)` | å¿½ç•¥æŒ‡å®šæ ‡ç­¾å·®å¼‚ |
| **é…ç½®åˆ†å‘** | group_left | `A / on(cluster) group_left B` | é…ç½®å€¼åº”ç”¨åˆ°å®ä¾‹ |
| **æ±‡æ€»è®¡ç®—** | group_right | `A * on(service) group_right B` | å®ä¾‹å€¼åº”ç”¨åˆ°æ±‡æ€» |

**âš ï¸ åŒ¹é…å¤±è´¥çš„å¸¸è§åŸå› **

```
1. æ ‡ç­¾é”®åä¸åŒï¼š
   cpu{host="web1"} vs memory{instance="web1"}
   
2. æ ‡ç­¾å€¼ä¸åŒï¼š
   cpu{instance="web-1"} vs memory{instance="web1"}
   
3. æ ‡ç­¾æ•°é‡ä¸åŒï¼š
   cpu{instance="web1", job="nginx"} vs memory{instance="web1"}
   
4. ç¼ºå°‘å¿…è¦æ ‡ç­¾ï¼š
   cpu{instance="web1"} vs memory{server="web1"}
   
5. æ—¶é—´åºåˆ—ä¸å­˜åœ¨ï¼š
   å…¶ä¸­ä¸€ä¸ªæŒ‡æ ‡åœ¨æŸä¸ªæ—¶é—´ç‚¹æ²¡æœ‰æ•°æ®
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿ç®—ç¬¦åˆ†ç±»ï¼šç®—æœ¯ã€æ¯”è¾ƒã€é€»è¾‘ã€é›†åˆå››å¤§ç±»
ğŸ”¸ ç®—æœ¯è¿ç®—ï¼š+ã€-ã€*ã€/ã€%ã€^ å¤„ç†æ•°å€¼è®¡ç®—
ğŸ”¸ æ¯”è¾ƒè¿ç®—ï¼š==ã€!=ã€>ã€<ã€>=ã€<= å¤„ç†æ¡ä»¶ç­›é€‰  
ğŸ”¸ é€»è¾‘è¿ç®—ï¼šandã€orã€unless å¤„ç†é€»è¾‘åˆ¤æ–­
ğŸ”¸ é›†åˆè¿ç®—ï¼šonã€ignoringã€group_left/right å¤„ç†æ ‡ç­¾åŒ¹é…
ğŸ”¸ ä¼˜å…ˆçº§ï¼šä¹˜æ–¹ > ä¹˜é™¤ > åŠ å‡ > æ¯”è¾ƒ > é€»è¾‘and > é€»è¾‘or
ğŸ”¸ å‘é‡åŒ¹é…ï¼šæ ‡ç­¾ç›¸åŒçš„æ—¶é—´åºåˆ—æ‰èƒ½é…å¯¹è¿ç®—
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿ç®—ç¬¦æœ¬è´¨ç†è§£**
```
ç®—æœ¯è¿ç®—ç¬¦ = æ•°å­¦è®¡ç®—å™¨
â”œâ”€â”€ åŠ å‡ä¹˜é™¤ï¼šåŸºç¡€æ•°å­¦è¿ç®—
â”œâ”€â”€ å–ä½™ä¹˜æ–¹ï¼šé«˜çº§æ•°å­¦å‡½æ•°
â””â”€â”€ åº”ç”¨ï¼šèµ„æºè®¡ç®—ã€å•ä½è½¬æ¢ã€è¯„åˆ†ç³»ç»Ÿ

æ¯”è¾ƒè¿ç®—ç¬¦ = æ¡ä»¶è¿‡æ»¤å™¨  
â”œâ”€â”€ ç­‰äºä¸ç­‰ï¼šç²¾ç¡®åŒ¹é…
â”œâ”€â”€ å¤§å°æ¯”è¾ƒï¼šé˜ˆå€¼åˆ¤æ–­
â””â”€â”€ åº”ç”¨ï¼šå‘Šè­¦æ¡ä»¶ã€çŠ¶æ€æ£€æŸ¥ã€æ€§èƒ½è¯„ä¼°

é€»è¾‘è¿ç®—ç¬¦ = é€»è¾‘åˆ¤æ–­å™¨
â”œâ”€â”€ andï¼šä¸¥æ ¼æ¡ä»¶ï¼ˆéƒ½è¦æ»¡è¶³ï¼‰
â”œâ”€â”€ orï¼šå®½æ¾æ¡ä»¶ï¼ˆæ»¡è¶³ä¸€ä¸ªå³å¯ï¼‰
â”œâ”€â”€ unlessï¼šæ’é™¤æ¡ä»¶ï¼ˆæ’é™¤ç‰¹å®šæƒ…å†µï¼‰
â””â”€â”€ åº”ç”¨ï¼šå¤åˆå‘Šè­¦ã€æ™ºèƒ½è¿‡æ»¤ã€åˆ†å±‚ç›‘æ§
```

**ğŸ”¹ å‘é‡åŒ¹é…æ ¸å¿ƒè§„å¾‹**
```
åŒ¹é…åŸåˆ™ï¼š
1. é»˜è®¤å¿…é¡»æ ‡ç­¾å®Œå…¨ç›¸åŒ
2. on() æŒ‡å®šä½¿ç”¨å“ªäº›æ ‡ç­¾åŒ¹é…
3. ignoring() æŒ‡å®šå¿½ç•¥å“ªäº›æ ‡ç­¾
4. group_left/right å¤„ç†ä¸€å¯¹å¤šå…³ç³»

è®°å¿†æ–¹æ³•ï¼š
- on = åªè¦è¿™äº›æ ‡ç­¾
- ignoring = å¿½ç•¥è¿™äº›æ ‡ç­¾  
- group_left = å·¦è¾¹å¤šï¼Œå³è¾¹å°‘
- group_right = å³è¾¹å¤šï¼Œå·¦è¾¹å°‘
```

**ğŸ”¹ ä¼˜å…ˆçº§è®°å¿†å£è¯€**
```
ä¹˜æ–¹æœ€ä¼˜å…ˆï¼Œä¹˜é™¤ç´§ç›¸éš
åŠ å‡æ’ç¬¬ä¸‰ï¼Œæ¯”è¾ƒåˆ†é«˜ä½
é€»è¾‘andåœ¨å‰ï¼Œoræœ€åè¿½
æ‹¬å·æ”¹ä¸€åˆ‡ï¼Œæ¸…æ™°æœ€é‡è¦
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç›‘æ§å‘Šè­¦åœºæ™¯**
- **ç®€å•å‘Šè­¦**ï¼š`cpu_usage > 0.8`ï¼ˆCPUä½¿ç”¨ç‡å‘Šè­¦ï¼‰
- **å¤åˆå‘Šè­¦**ï¼š`cpu_usage > 0.8 and memory_usage > 0.9`ï¼ˆå¤šèµ„æºå‘Šè­¦ï¼‰
- **æ’é™¤å‘Šè­¦**ï¼š`error_rate > 0.01 unless maintenance_mode == 1`ï¼ˆæ’é™¤ç»´æŠ¤æœŸï¼‰
- **åˆ†å±‚å‘Šè­¦**ï¼š`(cpu > 0.9) or (memory > 0.95 and disk > 0.9)`ï¼ˆåˆ†çº§æ¡ä»¶ï¼‰

**ğŸ“Š æ•°æ®åˆ†æåœºæ™¯**  
- **æ¯”ç‡è®¡ç®—**ï¼š`success_requests / total_requests`ï¼ˆæˆåŠŸç‡ï¼‰
- **å¢é•¿è®¡ç®—**ï¼š`current_value - previous_value`ï¼ˆå¢é•¿é‡ï¼‰
- **åŠ æƒè¯„åˆ†**ï¼š`cpu * 0.4 + memory * 0.3 + disk * 0.3`ï¼ˆç»¼åˆè¯„åˆ†ï¼‰
- **å®¹é‡è§„åˆ’**ï¼š`(total_capacity - used_capacity) / growth_rate`ï¼ˆå‰©ä½™æ—¶é—´ï¼‰

**ğŸ”§ è¿ç»´å®è·µåœºæ™¯**
- **èµ„æºç»Ÿè®¡**ï¼š`sum(cpu_cores) by (cluster)`ï¼ˆé›†ç¾¤èµ„æºæ±‡æ€»ï¼‰
- **å¼‚å¸¸æ£€æµ‹**ï¼š`abs(current - baseline) > threshold`ï¼ˆåå·®æ£€æµ‹ï¼‰
- **æ€§èƒ½å¯¹æ¯”**ï¼š`new_version_latency / old_version_latency`ï¼ˆç‰ˆæœ¬å¯¹æ¯”ï¼‰
- **SLAè®¡ç®—**ï¼š`availability >= sla_target`ï¼ˆSLAè¾¾æˆæƒ…å†µï¼‰

### 8.4 å¸¸è§é”™è¯¯é¿å…


**âŒ ä¼˜å…ˆçº§é”™è¯¯**
```promql
# é”™è¯¯ï¼šæ„å›¾ä¸æ˜ç¡®
cpu > 0.8 and memory > 0.7 or disk > 0.9

# æ­£ç¡®ï¼šä½¿ç”¨æ‹¬å·æ˜ç¡®æ„å›¾  
(cpu > 0.8 and memory > 0.7) or (disk > 0.9)
```

**âŒ æ ‡ç­¾åŒ¹é…é”™è¯¯**
```promql
# é”™è¯¯ï¼šæ ‡ç­¾ä¸åŒ¹é…å¯¼è‡´æ— ç»“æœ
cpu_usage{instance="web1"} + memory_usage{host="web1"}

# æ­£ç¡®ï¼šç»Ÿä¸€æ ‡ç­¾æˆ–ä½¿ç”¨åŒ¹é…è§„åˆ™
cpu_usage + memory_usage on (instance)
```

**âŒ å‘é‡åŒ¹é…è¯¯ç”¨**
```promql
# é”™è¯¯ï¼šgroup_left/rightä½¿ç”¨é”™è¯¯
instance_count * cluster_limit  # å¯èƒ½åŒ¹é…å¤±è´¥

# æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šåŒ¹é…è§„åˆ™
instance_count * on(cluster) group_left cluster_limit
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¿ç®—ç¬¦æ˜¯PromQLçš„è®¡ç®—å¼•æ“ï¼ŒæŒæ¡å¥½æ‰èƒ½å†™å‡ºå¼ºå¤§æŸ¥è¯¢
- ä¼˜å…ˆçº§å’Œæ‹¬å·å†³å®šè¿ç®—é¡ºåºï¼Œæ¸…æ™°è¡¨è¾¾é¿å…æ­§ä¹‰  
- å‘é‡åŒ¹é…æ˜¯å¤šæ—¶é—´åºåˆ—è¿ç®—çš„å…³é”®ï¼Œç†è§£æ ‡ç­¾åŒ¹é…è§„åˆ™
- å®é™…åº”ç”¨ä¸­è¦ç»“åˆä¸šåŠ¡åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„è¿ç®—ç¬¦ç»„åˆ