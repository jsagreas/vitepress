---
title: 2ã€WebSocketå®æ—¶é€šä¿¡å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [WebSocketåŸºç¡€ä¸å®‰å…¨æ¦‚è¿°](#1-websocketåŸºç¡€ä¸å®‰å…¨æ¦‚è¿°)
2. [WebSocketæ¡æ‰‹å®‰å…¨æœºåˆ¶](#2-websocketæ¡æ‰‹å®‰å…¨æœºåˆ¶)
3. [WebSocketè®¤è¯æˆæƒä½“ç³»](#3-websocketè®¤è¯æˆæƒä½“ç³»)
4. [è·¨åŸŸWebSocketå®‰å…¨ç­–ç•¥](#4-è·¨åŸŸwebsocketå®‰å…¨ç­–ç•¥)
5. [WebSocketæ¶ˆæ¯å®‰å…¨ä¿éšœ](#5-websocketæ¶ˆæ¯å®‰å…¨ä¿éšœ)
6. [è¿æ¥å®‰å…¨ç®¡ç†å®è·µ](#6-è¿æ¥å®‰å…¨ç®¡ç†å®è·µ)
7. [WebSocketæ”»å‡»é˜²æŠ¤ç­–ç•¥](#7-websocketæ”»å‡»é˜²æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ WebSocketåŸºç¡€ä¸å®‰å…¨æ¦‚è¿°


### 1.1 WebSocketæ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—ç†è§£**
WebSocketå°±åƒæ˜¯åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹äº†ä¸€ä¸ª"ç”µè¯çº¿"ï¼ŒåŒæ–¹å¯ä»¥éšæ—¶é€šè¯ï¼Œä¸åƒä¼ ç»ŸHTTPé‚£æ ·å¿…é¡»ä¸€é—®ä¸€ç­”ã€‚

```
ä¼ ç»ŸHTTPé€šä¿¡ï¼š                WebSocketé€šä¿¡ï¼š
å®¢æˆ·ç«¯ â†’ è¯·æ±‚ â†’ æœåŠ¡å™¨         å®¢æˆ·ç«¯ â†â†’ åŒå‘å®æ—¶ â†â†’ æœåŠ¡å™¨
å®¢æˆ·ç«¯ â† å“åº” â† æœåŠ¡å™¨         

å°±åƒå†™ä¿¡ vs æ‰“ç”µè¯çš„åŒºåˆ«
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦WebSocket**
- **å®æ—¶æ€§è¦æ±‚**ï¼šèŠå¤©åº”ç”¨ã€åœ¨çº¿æ¸¸æˆã€è‚¡ç¥¨äº¤æ˜“
- **åŒå‘é€šä¿¡**ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
- **æ•ˆç‡æ›´é«˜**ï¼šå»ºç«‹è¿æ¥åï¼Œæ¶ˆæ¯ä¼ è¾“æ²¡æœ‰HTTPå¤´éƒ¨å¼€é”€

### 1.2 WebSocketçš„å®‰å…¨æŒ‘æˆ˜


**ğŸš¨ ä¸»è¦å®‰å…¨é—®é¢˜**
```
å»ºç«‹è¿æ¥æ—¶çš„å®‰å…¨ï¼šæ¡æ‰‹éªŒè¯ã€èº«ä»½ç¡®è®¤
é€šä¿¡è¿‡ç¨‹ä¸­çš„å®‰å…¨ï¼šæ¶ˆæ¯åŠ å¯†ã€æ•°æ®å®Œæ•´æ€§
è¿æ¥ç®¡ç†çš„å®‰å…¨ï¼šæƒé™æ§åˆ¶ã€èµ„æºä¿æŠ¤
æ”»å‡»é˜²æŠ¤ï¼šæ¶æ„è¿æ¥ã€æ¶ˆæ¯æ´ªæ°´ã€è¿æ¥åŠ«æŒ
```

**âš ï¸ ä¸HTTPå®‰å…¨çš„åŒºåˆ«**
- HTTPæ˜¯"ä¸€æ¬¡æ€§"å®‰å…¨ï¼ŒWebSocketæ˜¯"æŒç»­æ€§"å®‰å…¨
- WebSocketè¿æ¥æ—¶é—´é•¿ï¼Œæ”»å‡»çª—å£æœŸæ›´å¤§
- å®æ—¶åŒå‘é€šä¿¡å¸¦æ¥æ–°çš„æ”»å‡»å¯èƒ½æ€§

---

## 2. ğŸ¤ WebSocketæ¡æ‰‹å®‰å…¨æœºåˆ¶


### 2.1 æ¡æ‰‹è¿‡ç¨‹è¯¦è§£


**ğŸ”¸ æ¡æ‰‹å°±æ˜¯"å¯¹æš—å·"**
WebSocketæ¡æ‰‹å°±åƒä¸¤ä¸ªç‰¹å·¥æ¥å¤´æ—¶å¯¹æš—å·ï¼Œç¡®ä¿å¯¹æ–¹æ˜¯å¯ä¿¡çš„ã€‚

```
å®¢æˆ·ç«¯å‘èµ·æ¡æ‰‹ï¼š
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket                    â† è¯´æ˜è¦å‡çº§åˆ°WebSocket
Connection: Upgrade                   â† è¿æ¥è¦å‡çº§
Sec-WebSocket-Key: x3JJHMbDL1E...    â† å®¢æˆ·ç«¯çš„"æš—å·"
Sec-WebSocket-Version: 13            â† WebSocketç‰ˆæœ¬

æœåŠ¡å™¨å“åº”ï¼š
HTTP/1.1 101 Switching Protocols     â† åŒæ„å‡çº§
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMl...    â† æœåŠ¡å™¨çš„"å›åº”æš—å·"
```

### 2.2 Sec-WebSocket-KeyéªŒè¯æœºåˆ¶


**ğŸ”‘ å¯†é’¥éªŒè¯åŸç†**
è¿™ä¸ªæœºåˆ¶é˜²æ­¢æ™®é€šHTTPå®¢æˆ·ç«¯æ„å¤–è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ã€‚

```javascript
// å®¢æˆ·ç«¯ç”ŸæˆéšæœºKey
const key = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));

// æœåŠ¡å™¨ç«¯éªŒè¯ï¼ˆNode.jsç¤ºä¾‹ï¼‰
const crypto = require('crypto');
const WEBSOCKET_MAGIC_STRING = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';

function generateAcceptKey(clientKey) {
    const acceptKey = crypto
        .createHash('sha1')
        .update(clientKey + WEBSOCKET_MAGIC_STRING)
        .digest('base64');
    return acceptKey;
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**
- é˜²æ­¢è·¨åè®®æ”»å‡»
- ç¡®ä¿å®¢æˆ·ç«¯çœŸçš„æ”¯æŒWebSocket
- é¿å…ç¼“å­˜æœåŠ¡å™¨çš„è¯¯æ“ä½œ

### 2.3 å­åè®®åå•†


**ğŸ”¸ å­åè®®çš„ä½œç”¨**
å­åè®®å°±åƒé€‰æ‹©"èŠå¤©çš„è¯­è¨€"ï¼Œæ¯”å¦‚é€‰æ‹©ç”¨ä¸­æ–‡è¿˜æ˜¯è‹±æ–‡äº¤æµã€‚

```javascript
// å®¢æˆ·ç«¯è¯·æ±‚ç‰¹å®šå­åè®®
const ws = new WebSocket('wss://example.com/chat', ['chat-v1', 'chat-v2']);

// æœåŠ¡å™¨é€‰æ‹©æ”¯æŒçš„å­åè®®
if (request.headers['sec-websocket-protocol']) {
    const protocols = request.headers['sec-websocket-protocol'].split(',');
    if (protocols.includes('chat-v1')) {
        response.setHeader('Sec-WebSocket-Protocol', 'chat-v1');
    }
}
```

---

## 3. ğŸ” WebSocketè®¤è¯æˆæƒä½“ç³»


### 3.1 è¿æ¥æ—¶è®¤è¯ç­–ç•¥


**ğŸ¯ è®¤è¯çš„æ—¶æœºé€‰æ‹©**

| è®¤è¯æ–¹å¼ | **æ—¶æœº** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|---------|-------------|
| ğŸ”‘ **æ¡æ‰‹æ—¶è®¤è¯** | `å»ºç«‹è¿æ¥æ—¶` | `å®‰å…¨æ€§é«˜ï¼Œæ‹’ç»æ— æ•ˆè¿æ¥` | `è®¤è¯å¤±è´¥éœ€é‡æ–°è¿æ¥` | `é«˜å®‰å…¨è¦æ±‚` |
| ğŸ« **é¦–æ¬¡æ¶ˆæ¯è®¤è¯** | `è¿æ¥åç¬¬ä¸€æ¡æ¶ˆæ¯` | `çµæ´»æ€§å¥½ï¼Œå¯é‡è¯•` | `çŸ­æš‚çš„æœªè®¤è¯çŠ¶æ€` | `ä¸€èˆ¬åº”ç”¨` |
| ğŸŒ **HTTPé¢„è®¤è¯** | `å‡çº§å‰çš„HTTPè¯·æ±‚` | `å¤ç”¨ç°æœ‰è®¤è¯ä½“ç³»` | `ä¾èµ–HTTP Session` | `Webåº”ç”¨é›†æˆ` |

### 3.2 Tokenä¼ é€’æœºåˆ¶


**ğŸ”¸ é€šè¿‡URLå‚æ•°ä¼ é€’**
```javascript
// ç®€å•ä½†ä¸å¤Ÿå®‰å…¨çš„æ–¹å¼
const ws = new WebSocket('wss://example.com/chat?token=your_jwt_token');
```

> âš ï¸ **æ³¨æ„**ï¼šURLå‚æ•°å¯èƒ½è¢«è®°å½•åœ¨æ—¥å¿—ä¸­ï¼Œå®‰å…¨æ€§è¾ƒä½

**ğŸ”¸ é€šè¿‡å­åè®®ä¼ é€’**
```javascript
// ç›¸å¯¹å®‰å…¨çš„æ–¹å¼
const ws = new WebSocket('wss://example.com/chat', ['token-' + jwt_token]);
```

**ğŸ”¸ é€šè¿‡é¦–æ¡æ¶ˆæ¯ä¼ é€’**
```javascript
// æœ€çµæ´»çš„æ–¹å¼
const ws = new WebSocket('wss://example.com/chat');

ws.onopen = function() {
    // è¿æ¥å»ºç«‹åç«‹å³å‘é€è®¤è¯æ¶ˆæ¯
    ws.send(JSON.stringify({
        type: 'auth',
        token: jwt_token
    }));
};
```

### 3.3 ä¼šè¯ç®¡ç†å®è·µ


**ğŸ”„ ä¼šè¯çŠ¶æ€ç®¡ç†**
```javascript
// æœåŠ¡å™¨ç«¯ä¼šè¯ç®¡ç†ç¤ºä¾‹
class WebSocketSession {
    constructor(ws) {
        this.ws = ws;
        this.authenticated = false;
        this.userId = null;
        this.permissions = [];
        this.lastActivity = Date.now();
    }
    
    authenticate(token) {
        try {
            const payload = jwt.verify(token, secret);
            this.authenticated = true;
            this.userId = payload.userId;
            this.permissions = payload.permissions || [];
            return true;
        } catch (error) {
            return false;
        }
    }
    
    hasPermission(action) {
        return this.authenticated && this.permissions.includes(action);
    }
}
```

---

## 4. ğŸŒ è·¨åŸŸWebSocketå®‰å…¨ç­–ç•¥


### 4.1 Originæ£€æŸ¥æœºåˆ¶


**ğŸ”¸ Originæ£€æŸ¥çš„é‡è¦æ€§**
Originæ£€æŸ¥å°±åƒé—¨å«æ£€æŸ¥æ¥è®¿è€…çš„èº«ä»½è¯ï¼Œç¡®ä¿åªæœ‰è¢«å…è®¸çš„ç½‘ç«™æ‰èƒ½å»ºç«‹WebSocketè¿æ¥ã€‚

```javascript
// æœåŠ¡å™¨ç«¯Originæ£€æŸ¥
const ALLOWED_ORIGINS = [
    'https://myapp.com',
    'https://admin.myapp.com',
    'https://localhost:3000'  // å¼€å‘ç¯å¢ƒ
];

function checkOrigin(request) {
    const origin = request.headers.origin;
    
    if (!origin) {
        return false;  // æ‹’ç»æ²¡æœ‰Originçš„è¯·æ±‚
    }
    
    return ALLOWED_ORIGINS.includes(origin);
}
```

### 4.2 CORSç­–ç•¥é…ç½®


**ğŸ”¸ WebSocketçš„CORSç‰¹æ®Šæ€§**
WebSocketä¸å®Œå…¨éµå¾ªä¼ ç»ŸCORSè§„åˆ™ï¼Œä½†Originæ£€æŸ¥ä»ç„¶é‡è¦ã€‚

```
WebSocketæ¡æ‰‹æµç¨‹ä¸­çš„å®‰å…¨æ£€æŸ¥ï¼š

å®¢æˆ·ç«¯è¯·æ±‚ï¼š
Origin: https://trusted-site.com      â† æµè§ˆå™¨è‡ªåŠ¨æ·»åŠ 

æœåŠ¡å™¨æ£€æŸ¥ï¼š
1. éªŒè¯Originæ˜¯å¦åœ¨ç™½åå•ä¸­
2. æ£€æŸ¥è¯·æ±‚å¤´æ ¼å¼æ˜¯å¦æ­£ç¡®
3. éªŒè¯åè®®å‡çº§è¯·æ±‚çš„åˆæ³•æ€§

å®‰å…¨å†³ç­–ï¼š
âœ… å…è®¸è¿æ¥ï¼šOriginåœ¨ç™½åå•ä¸­
âŒ æ‹’ç»è¿æ¥ï¼šè¿”å›403 Forbidden
```

### 4.3 ä»£ç†å’Œåå‘ä»£ç†é…ç½®


**ğŸ”§ Nginxä»£ç†é…ç½®ç¤ºä¾‹**
```nginx
# WebSocketä»£ç†é…ç½®
location /websocket/ {
    proxy_pass http://backend;
    
    # WebSocketå¿…éœ€çš„å¤´éƒ¨
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # å®‰å…¨ç›¸å…³å¤´éƒ¨
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # è¶…æ—¶è®¾ç½®
    proxy_read_timeout 86400;
}
```

---

## 5. ğŸ”’ WebSocketæ¶ˆæ¯å®‰å…¨ä¿éšœ


### 5.1 æ•°æ®æ ¼å¼éªŒè¯


**ğŸ”¸ æ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–**
åˆ¶å®šç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ï¼Œå°±åƒåˆ¶å®šé€šä¿¡åè®®ï¼Œé¿å…æ··ä¹±å’Œå®‰å…¨é£é™©ã€‚

```javascript
// æ ‡å‡†æ¶ˆæ¯æ ¼å¼
const MESSAGE_SCHEMA = {
    type: 'string',      // æ¶ˆæ¯ç±»å‹ï¼š'chat', 'notification', 'command'
    payload: 'object',   // æ¶ˆæ¯å†…å®¹
    timestamp: 'number', // æ—¶é—´æˆ³
    messageId: 'string'  // æ¶ˆæ¯ID
};

// æ¶ˆæ¯éªŒè¯å‡½æ•°
function validateMessage(message) {
    try {
        const parsed = JSON.parse(message);
        
        // æ£€æŸ¥å¿…éœ€å­—æ®µ
        if (!parsed.type || !parsed.payload) {
            return { valid: false, error: 'ç¼ºå°‘å¿…éœ€å­—æ®µ' };
        }
        
        // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
        const allowedTypes = ['chat', 'notification', 'command'];
        if (!allowedTypes.includes(parsed.type)) {
            return { valid: false, error: 'ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹' };
        }
        
        return { valid: true, message: parsed };
    } catch (error) {
        return { valid: false, error: 'æ¶ˆæ¯æ ¼å¼é”™è¯¯' };
    }
}
```

### 5.2 æ¶ˆæ¯åŠ å¯†ä¼ è¾“


**ğŸ”¸ ä¼ è¾“å±‚åŠ å¯†**
ä½¿ç”¨WSSï¼ˆWebSocket Secureï¼‰ç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«åŠ å¯†ã€‚

```
WS vs WSSçš„åŒºåˆ«ï¼š
ws://example.com/chat    â† æ˜æ–‡ä¼ è¾“ï¼Œå®¹æ˜“è¢«çªƒå¬
wss://example.com/chat   â† åŠ å¯†ä¼ è¾“ï¼Œä½¿ç”¨TLSä¿æŠ¤

å°±åƒæ‰“ç”µè¯ vs åŠ å¯†ç”µè¯çš„åŒºåˆ«
```

**ğŸ”¸ åº”ç”¨å±‚åŠ å¯†**
```javascript
// æ•æ„Ÿæ¶ˆæ¯çš„é¢å¤–åŠ å¯†
const CryptoJS = require('crypto-js');

function encryptMessage(message, secretKey) {
    const encrypted = CryptoJS.AES.encrypt(
        JSON.stringify(message), 
        secretKey
    ).toString();
    
    return {
        type: 'encrypted',
        payload: encrypted,
        timestamp: Date.now()
    };
}

function decryptMessage(encryptedMessage, secretKey) {
    try {
        const decrypted = CryptoJS.AES.decrypt(
            encryptedMessage.payload, 
            secretKey
        ).toString(CryptoJS.enc.Utf8);
        
        return JSON.parse(decrypted);
    } catch (error) {
        throw new Error('è§£å¯†å¤±è´¥');
    }
}
```

### 5.3 æ¶ˆæ¯å®Œæ•´æ€§æ ¡éªŒ


**ğŸ”¸ æ¶ˆæ¯ç­¾åæœºåˆ¶**
```javascript
// æ¶ˆæ¯ç­¾åéªŒè¯
function signMessage(message, secretKey) {
    const messageString = JSON.stringify(message);
    const signature = CryptoJS.HmacSHA256(messageString, secretKey).toString();
    
    return {
        ...message,
        signature: signature
    };
}

function verifyMessage(signedMessage, secretKey) {
    const { signature, ...message } = signedMessage;
    const expectedSignature = CryptoJS.HmacSHA256(
        JSON.stringify(message), 
        secretKey
    ).toString();
    
    return signature === expectedSignature;
}
```

---

## 6. ğŸ”§ è¿æ¥å®‰å…¨ç®¡ç†å®è·µ


### 6.1 è¿æ¥æ•°é™åˆ¶ç­–ç•¥


**ğŸ”¸ é˜²æ­¢èµ„æºè€—å°½**
é™åˆ¶è¿æ¥æ•°å°±åƒæ§åˆ¶é¤å…çš„åº§ä½æ•°ï¼Œé¿å…æœåŠ¡å™¨è¢«å‹å®ã€‚

```javascript
// è¿æ¥æ•°ç®¡ç†
class ConnectionManager {
    constructor() {
        this.connections = new Map();
        this.maxConnectionsPerIP = 10;
        this.maxTotalConnections = 1000;
    }
    
    canAcceptConnection(clientIP) {
        // æ£€æŸ¥æ€»è¿æ¥æ•°
        if (this.connections.size >= this.maxTotalConnections) {
            return { allowed: false, reason: 'æœåŠ¡å™¨è¿æ¥æ•°å·²æ»¡' };
        }
        
        // æ£€æŸ¥å•ä¸ªIPçš„è¿æ¥æ•°
        const ipConnections = Array.from(this.connections.values())
            .filter(conn => conn.clientIP === clientIP);
        
        if (ipConnections.length >= this.maxConnectionsPerIP) {
            return { allowed: false, reason: 'IPè¿æ¥æ•°è¶…é™' };
        }
        
        return { allowed: true };
    }
    
    addConnection(ws, clientIP) {
        const connectionId = this.generateId();
        this.connections.set(connectionId, {
            ws: ws,
            clientIP: clientIP,
            connectedAt: Date.now(),
            lastActivity: Date.now()
        });
        return connectionId;
    }
}
```

### 6.2 å¿ƒè·³æœºåˆ¶å®ç°


**ğŸ”¸ å¿ƒè·³çš„ä½œç”¨**
å¿ƒè·³æœºåˆ¶å°±åƒå®šæœŸçš„"ä½ å¥½å—ï¼Ÿ"ï¼Œç¡®ä¿è¿æ¥è¿˜æ´»ç€ã€‚

```javascript
// å®¢æˆ·ç«¯å¿ƒè·³
class WebSocketClient {
    constructor(url) {
        this.ws = new WebSocket(url);
        this.heartbeatInterval = 30000; // 30ç§’
        this.heartbeatTimer = null;
        
        this.ws.onopen = () => {
            this.startHeartbeat();
        };
        
        this.ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'pong') {
                // æ”¶åˆ°æœåŠ¡å™¨å›åº”ï¼Œè¿æ¥æ­£å¸¸
                this.lastPong = Date.now();
            }
        };
    }
    
    startHeartbeat() {
        this.heartbeatTimer = setInterval(() => {
            if (this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({ type: 'ping' }));
            }
        }, this.heartbeatInterval);
    }
    
    stopHeartbeat() {
        if (this.heartbeatTimer) {
            clearInterval(this.heartbeatTimer);
        }
    }
}
```

### 6.3 å¼‚å¸¸æ£€æµ‹æœºåˆ¶


**ğŸ”¸ å¼‚å¸¸è¿æ¥è¯†åˆ«**
```javascript
// å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
class AnomalyDetector {
    constructor() {
        this.messageRateLimit = 100; // æ¯åˆ†é’Ÿæœ€å¤§æ¶ˆæ¯æ•°
        this.suspiciousPatterns = [];
    }
    
    checkMessageRate(connectionId, message) {
        const now = Date.now();
        const oneMinuteAgo = now - 60000;
        
        // è·å–æœ€è¿‘ä¸€åˆ†é’Ÿçš„æ¶ˆæ¯
        const recentMessages = this.getRecentMessages(connectionId, oneMinuteAgo);
        
        if (recentMessages.length > this.messageRateLimit) {
            return {
                suspicious: true,
                reason: 'æ¶ˆæ¯å‘é€é¢‘ç‡è¿‡é«˜',
                action: 'rate_limit'
            };
        }
        
        return { suspicious: false };
    }
    
    checkMessageContent(message) {
        // æ£€æŸ¥å¯ç–‘å†…å®¹æ¨¡å¼
        const suspiciousKeywords = ['<script>', 'javascript:', 'eval('];
        const content = JSON.stringify(message);
        
        for (const keyword of suspiciousKeywords) {
            if (content.includes(keyword)) {
                return {
                    suspicious: true,
                    reason: 'æ¶ˆæ¯åŒ…å«å¯ç–‘å†…å®¹',
                    action: 'block_message'
                };
            }
        }
        
        return { suspicious: false };
    }
}
```

---

## 7. ğŸ›¡ï¸ WebSocketæ”»å‡»é˜²æŠ¤ç­–ç•¥


### 7.1 è¿æ¥åŠ«æŒé˜²æŠ¤


**ğŸ”¸ è¿æ¥åŠ«æŒçš„å¨èƒ**
è¿æ¥åŠ«æŒå°±åƒæœ‰äººå†’å……ä½ ç»™æœ‹å‹æ‰“ç”µè¯ï¼Œéœ€è¦éªŒè¯èº«ä»½ã€‚

```
æ”»å‡»åœºæ™¯åˆ†æï¼š
æ”»å‡»è€…ç›®æ ‡ â†’ è·å–ç”¨æˆ·çš„WebSocketè¿æ¥
æ”»å‡»æ‰‹æ®µ â†’ XSSæ³¨å…¥ã€ä¸­é—´äººæ”»å‡»ã€DNSåŠ«æŒ
æ”»å‡»åæœ â†’ çªƒå–æ•°æ®ã€å‘é€æ¶æ„æ¶ˆæ¯ã€ç”¨æˆ·å†’å……

é˜²æŠ¤æµç¨‹å›¾ï¼š
ç”¨æˆ·å‘èµ·è¿æ¥ â†’ Originæ£€æŸ¥ â†’ TokenéªŒè¯ â†’ å»ºç«‹å®‰å…¨è¿æ¥
     â†“             â†“          â†“           â†“
   æµè§ˆå™¨éªŒè¯    æœåŠ¡å™¨éªŒè¯   èº«ä»½éªŒè¯    æŒç»­ç›‘æ§
```

**ğŸ”§ é˜²æŠ¤å®ç°**
```javascript
// è¿æ¥å®‰å…¨éªŒè¯
function secureConnectionValidation(request, ws) {
    // 1. Originæ£€æŸ¥
    if (!checkOrigin(request)) {
        ws.close(1008, 'Invalid origin');
        return false;
    }
    
    // 2. User-Agentæ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
    const userAgent = request.headers['user-agent'];
    if (!isValidUserAgent(userAgent)) {
        ws.close(1008, 'Suspicious user agent');
        return false;
    }
    
    // 3. IPç™½åå•æ£€æŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
    const clientIP = getClientIP(request);
    if (isBlacklisted(clientIP)) {
        ws.close(1008, 'IP blacklisted');
        return false;
    }
    
    return true;
}
```

### 7.2 æ¶ˆæ¯æ³¨å…¥æ”»å‡»é˜²æŠ¤


**ğŸ”¸ æ³¨å…¥æ”»å‡»åŸç†**
æ”»å‡»è€…é€šè¿‡å‘é€æ¶æ„æ„é€ çš„æ¶ˆæ¯ï¼Œè¯•å›¾æ‰§è¡Œæœªæˆæƒçš„æ“ä½œã€‚

```javascript
// æ¶ˆæ¯å®‰å…¨è¿‡æ»¤
class MessageSanitizer {
    constructor() {
        this.maxMessageSize = 1024 * 10; // 10KB
        this.allowedTypes = ['chat', 'notification', 'command'];
    }
    
    sanitizeMessage(rawMessage) {
        // 1. å¤§å°æ£€æŸ¥
        if (rawMessage.length > this.maxMessageSize) {
            throw new Error('æ¶ˆæ¯è¿‡å¤§');
        }
        
        // 2. æ ¼å¼æ£€æŸ¥
        let message;
        try {
            message = JSON.parse(rawMessage);
        } catch (error) {
            throw new Error('æ¶ˆæ¯æ ¼å¼é”™è¯¯');
        }
        
        // 3. ç±»å‹æ£€æŸ¥
        if (!this.allowedTypes.includes(message.type)) {
            throw new Error('ä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹');
        }
        
        // 4. å†…å®¹è¿‡æ»¤
        if (message.type === 'chat') {
            message.payload.content = this.sanitizeText(message.payload.content);
        }
        
        return message;
    }
    
    sanitizeText(text) {
        // é˜²æ­¢XSSæ”»å‡»
        return text
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
    }
}
```

### 7.3 DoSæ”»å‡»é˜²æŠ¤


**ğŸ”¸ DoSæ”»å‡»åœºæ™¯**
```
å¸¸è§DoSæ”»å‡»æ–¹å¼ï¼š
1. è¿æ¥æ´ªæ°´ â†’ å¤§é‡å»ºç«‹è¿æ¥è€—å°½æœåŠ¡å™¨èµ„æº
2. æ¶ˆæ¯æ´ªæ°´ â†’ é«˜é¢‘å‘é€æ¶ˆæ¯å æ»¡å¸¦å®½
3. æ…¢é€Ÿæ”»å‡» â†’ å»ºç«‹è¿æ¥åä¸å‘é€æ•°æ®å ç”¨èµ„æº
4. å¤§æ¶ˆæ¯æ”»å‡» â†’ å‘é€è¶…å¤§æ¶ˆæ¯æ¶ˆè€—å†…å­˜
```

**ğŸ›¡ï¸ ç»¼åˆé˜²æŠ¤æ–¹æ¡ˆ**
```javascript
// DoSé˜²æŠ¤ç®¡ç†å™¨
class DoSProtection {
    constructor() {
        this.connectionLimits = new Map(); // IPè¿æ¥é™åˆ¶
        this.messageLimits = new Map();    // æ¶ˆæ¯é¢‘ç‡é™åˆ¶
        this.blacklist = new Set();        // IPé»‘åå•
    }
    
    // è¿æ¥é¢‘ç‡é™åˆ¶
    checkConnectionRate(clientIP) {
        const now = Date.now();
        const limit = this.connectionLimits.get(clientIP) || { count: 0, resetTime: now };
        
        // æ¯åˆ†é’Ÿé‡ç½®è®¡æ•°
        if (now > limit.resetTime + 60000) {
            limit.count = 0;
            limit.resetTime = now;
        }
        
        limit.count++;
        this.connectionLimits.set(clientIP, limit);
        
        if (limit.count > 10) { // æ¯åˆ†é’Ÿæœ€å¤š10ä¸ªè¿æ¥
            this.addToBlacklist(clientIP, 300000); // é»‘åå•5åˆ†é’Ÿ
            return false;
        }
        
        return true;
    }
    
    // æ¶ˆæ¯é¢‘ç‡é™åˆ¶
    checkMessageRate(connectionId) {
        const now = Date.now();
        const limit = this.messageLimits.get(connectionId) || { 
            messages: [], 
            violations: 0 
        };
        
        // æ¸…ç†è¶…è¿‡1åˆ†é’Ÿçš„æ¶ˆæ¯è®°å½•
        limit.messages = limit.messages.filter(time => now - time < 60000);
        limit.messages.push(now);
        
        if (limit.messages.length > 60) { // æ¯åˆ†é’Ÿæœ€å¤š60æ¡æ¶ˆæ¯
            limit.violations++;
            if (limit.violations > 3) {
                return { allowed: false, action: 'disconnect' };
            }
            return { allowed: false, action: 'throttle' };
        }
        
        this.messageLimits.set(connectionId, limit);
        return { allowed: true };
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å®‰å…¨è¦ç‚¹


```
ğŸ”¸ æ¡æ‰‹å®‰å…¨ï¼šOriginæ£€æŸ¥ã€KeyéªŒè¯ã€å­åè®®åå•†
ğŸ”¸ è®¤è¯ä½“ç³»ï¼šTokenä¼ é€’ã€ä¼šè¯ç®¡ç†ã€æƒé™æ§åˆ¶
ğŸ”¸ æ¶ˆæ¯å®‰å…¨ï¼šæ ¼å¼éªŒè¯ã€åŠ å¯†ä¼ è¾“ã€å®Œæ•´æ€§æ ¡éªŒ
ğŸ”¸ è¿æ¥ç®¡ç†ï¼šæ•°é‡é™åˆ¶ã€å¿ƒè·³æœºåˆ¶ã€å¼‚å¸¸æ£€æµ‹
ğŸ”¸ æ”»å‡»é˜²æŠ¤ï¼šåŠ«æŒé˜²æŠ¤ã€æ³¨å…¥é˜²æŠ¤ã€DoSé˜²æŠ¤
```

### 8.2 å®é™…éƒ¨ç½²å»ºè®®


**ğŸ”¹ å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ**
```
å¼€å‘ç¯å¢ƒï¼š
- å…è®¸localhost Origin
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å®½æ¾çš„è¿æ¥é™åˆ¶

ç”Ÿäº§ç¯å¢ƒï¼š
- ä¸¥æ ¼çš„Originç™½åå•
- å®Œæ•´çš„å®‰å…¨ç›‘æ§
- ä¸¥æ ¼çš„èµ„æºé™åˆ¶
```

**ğŸ”¹ ç›‘æ§å’Œå‘Šè­¦**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- è¿æ¥æ•°å˜åŒ–è¶‹åŠ¿
- æ¶ˆæ¯å‘é€é¢‘ç‡
- å¼‚å¸¸æ–­å¼€ç‡
- è®¤è¯å¤±è´¥ç‡

å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
- å•IPè¿æ¥æ•°è¶…è¿‡æ­£å¸¸å€¼çš„3å€
- æ¶ˆæ¯é¢‘ç‡è¶…è¿‡é™åˆ¶
- çŸ­æ—¶é—´å†…å¤§é‡è®¤è¯å¤±è´¥
```

### 8.3 æœ€ä½³å®è·µchecklist


> ğŸ“‹ **WebSocketå®‰å…¨checklist**
> 
> - [x] ä½¿ç”¨WSSåŠ å¯†ä¼ è¾“
> - [x] å®æ–½Originæ£€æŸ¥
> - [x] å»ºç«‹è®¤è¯æœºåˆ¶
> - [x] é™åˆ¶è¿æ¥æ•°é‡
> - [x] å®ç°å¿ƒè·³æ£€æµ‹
> - [x] æ¶ˆæ¯æ ¼å¼éªŒè¯
> - [x] DoSæ”»å‡»é˜²æŠ¤
> - [x] å¼‚å¸¸è¡Œä¸ºç›‘æ§
> - [x] å®‰å…¨æ—¥å¿—è®°å½•
> - [x] å®šæœŸå®‰å…¨å®¡è®¡

**ğŸ¯ è®°ä½é‡ç‚¹**ï¼š
- WebSocketå®‰å…¨æ˜¯æŒç»­æ€§çš„ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„
- å®æ—¶é€šä¿¡çš„å®‰å…¨æŒ‘æˆ˜æ¯”ä¼ ç»ŸHTTPæ›´å¤æ‚
- å¤šå±‚é˜²æŠ¤æ¯”å•ä¸€é˜²æŠ¤æ›´æœ‰æ•ˆ
- ç›‘æ§å’Œå“åº”ä¸é¢„é˜²åŒæ ·é‡è¦

**ğŸ’¡ å®è·µå»ºè®®**ï¼š
ä»ç®€å•çš„è®¤è¯å¼€å§‹ï¼Œé€æ­¥å®Œå–„å®‰å…¨æœºåˆ¶ã€‚å®‰å…¨ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ï¼Œè€Œæ˜¯åœ¨å®è·µä¸­ä¸æ–­æ”¹è¿›çš„è¿‡ç¨‹ã€‚é‡ç‚¹å…³æ³¨ä¸šåŠ¡åœºæ™¯ä¸­æœ€å¯èƒ½å‡ºç°çš„å®‰å…¨å¨èƒï¼Œæœ‰é’ˆå¯¹æ€§åœ°å®æ–½é˜²æŠ¤æªæ–½ã€‚