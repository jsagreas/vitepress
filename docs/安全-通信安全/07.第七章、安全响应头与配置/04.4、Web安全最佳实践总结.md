---
title: 4ã€Webå®‰å…¨æœ€ä½³å®è·µæ€»ç»“
---
## ğŸ“š ç›®å½•

1. [è®¤è¯å®‰å…¨æœ€ä½³å®è·µ](#1-è®¤è¯å®‰å…¨æœ€ä½³å®è·µ)
2. [é€šä¿¡åŠ å¯†æ ‡å‡†](#2-é€šä¿¡åŠ å¯†æ ‡å‡†)
3. [è·¨ç«™æ”»å‡»é˜²æŠ¤](#3-è·¨ç«™æ”»å‡»é˜²æŠ¤)
4. [XSSé˜²æŠ¤ç­–ç•¥](#4-XSSé˜²æŠ¤ç­–ç•¥)
5. [æ³¨å…¥æ”»å‡»é˜²æŠ¤](#5-æ³¨å…¥æ”»å‡»é˜²æŠ¤)
6. [æ¥å£å®‰å…¨é…ç½®](#6-æ¥å£å®‰å…¨é…ç½®)
7. [è·¨åŸŸå®‰å…¨æ§åˆ¶](#7-è·¨åŸŸå®‰å…¨æ§åˆ¶)
8. [å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•](#8-å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•)

---

## 1. ğŸ” è®¤è¯å®‰å…¨æœ€ä½³å®è·µ


### 1.1 JWT + Refresh Token åŒTokenæœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦åŒTokenï¼Ÿ**
```
å•JWTé—®é¢˜ï¼š
- ä¸€æ—¦æ³„éœ²ï¼Œæ— æ³•æ³¨é”€
- è¿‡æœŸæ—¶é—´é•¿ï¼šå®‰å…¨é£é™©å¤§
- è¿‡æœŸæ—¶é—´çŸ­ï¼šé¢‘ç¹é‡æ–°ç™»å½•

åŒTokenè§£å†³æ–¹æ¡ˆï¼š
AccessToken(çŸ­æœŸ) + RefreshToken(é•¿æœŸ)
```

**ğŸ”¹ åŒTokenå·¥ä½œåŸç†**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚â”€â”€â”€â†’â”‚   åç«¯   â”‚â”€â”€â”€â†’â”‚ æ•°æ®åº“  â”‚
â”‚è´¦å·å¯†ç  â”‚    â”‚éªŒè¯ç™»å½•  â”‚    â”‚å­˜å‚¨RT   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              è¿”å›ä¸¤ä¸ªTokenï¼š
              AT: 15åˆ†é’Ÿè¿‡æœŸ
              RT: 7å¤©è¿‡æœŸ

è®¿é—®æ¥å£æµç¨‹ï¼š
è¯·æ±‚å¤´æºå¸¦AT â†’ éªŒè¯æœ‰æ•ˆ â†’ æ­£å¸¸è®¿é—®
è¯·æ±‚å¤´æºå¸¦AT â†’ å·²è¿‡æœŸ â†’ ç”¨RTæ¢æ–°AT
```

**ğŸ”§ æ ¸å¿ƒå®ç°è¦ç‚¹**

```javascript
// JWTé…ç½®ç¤ºä¾‹
const jwtConfig = {
  accessToken: {
    secret: process.env.JWT_ACCESS_SECRET,
    expiresIn: '15m',           // çŸ­æœŸï¼š15åˆ†é’Ÿ
    algorithm: 'HS256'
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '7d',            // é•¿æœŸï¼š7å¤©
    algorithm: 'HS256'
  }
}

// ç”ŸæˆTokenå¯¹
function generateTokens(userId) {
  const payload = { userId, type: 'access' };
  
  const accessToken = jwt.sign(payload, jwtConfig.accessToken.secret, {
    expiresIn: jwtConfig.accessToken.expiresIn
  });
  
  const refreshToken = jwt.sign(
    { userId, type: 'refresh' }, 
    jwtConfig.refreshToken.secret,
    { expiresIn: jwtConfig.refreshToken.expiresIn }
  );
  
  return { accessToken, refreshToken };
}
```

### 1.2 HttpOnly + Secure Cookieé…ç½®


**ğŸ”¹ Cookieå®‰å…¨é…ç½®è¯¦è§£**

```javascript
// å®‰å…¨Cookieè®¾ç½®
app.use(session({
  name: 'sessionId',                // ä¸æš´éœ²æŠ€æœ¯æ ˆä¿¡æ¯
  secret: process.env.SESSION_SECRET,
  cookie: {
    httpOnly: true,                 // é˜²æ­¢XSSè¯»å–Cookie
    secure: true,                   // ä»…HTTPSä¼ è¾“
    sameSite: 'strict',            // é˜²æ­¢CSRFæ”»å‡»
    maxAge: 1000 * 60 * 15,        // 15åˆ†é’Ÿè¿‡æœŸ
    domain: '.example.com'          // é™åˆ¶åŸŸåèŒƒå›´
  },
  resave: false,
  saveUninitialized: false
}));
```

**å„å‚æ•°å«ä¹‰è¯´æ˜ï¼š**

| å‚æ•° | **ä½œç”¨** | **å®‰å…¨ä»·å€¼** |
|------|---------|-------------|
| `httpOnly: true` | `JavaScriptæ— æ³•è¯»å–Cookie` | `é˜²æ­¢XSSçªƒå–ç™»å½•å‡­è¯` |
| `secure: true` | `ä»…é€šè¿‡HTTPSä¼ è¾“` | `é˜²æ­¢ç½‘ç»œå—…æ¢è·å–Cookie` |
| `sameSite: 'strict'` | `ç¦æ­¢è·¨ç«™è¯·æ±‚æºå¸¦` | `é˜²æ­¢CSRFæ”»å‡»` |
| `domainé™åˆ¶` | `æŒ‡å®šæœ‰æ•ˆåŸŸå` | `é˜²æ­¢å­åŸŸåæ»¥ç”¨` |

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
å¼€å‘ç¯å¢ƒé…ç½®ï¼š
- secure: false (æœ¬åœ°HTTPæµ‹è¯•)
- sameSite: 'lax' (è°ƒè¯•æ–¹ä¾¿)

ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š
- secure: true (å¼ºåˆ¶HTTPS)
- sameSite: 'strict' (æœ€é«˜å®‰å…¨çº§åˆ«)
```

---

## 2. ğŸ”’ é€šä¿¡åŠ å¯†æ ‡å‡†


### 2.1 å…¨ç«™HTTPSéƒ¨ç½²


**ä¸ºä»€ä¹ˆå¿…é¡»å…¨ç«™HTTPSï¼Ÿ**
```
HTTPä¼ è¾“é—®é¢˜ï¼š
- æ•°æ®æ˜æ–‡ä¼ è¾“ï¼Œå®¹æ˜“è¢«çªƒå¬
- æ— æ³•éªŒè¯æœåŠ¡å™¨èº«ä»½
- æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹

HTTPSè§£å†³æ–¹æ¡ˆï¼š
- SSL/TLSåŠ å¯†ä¼ è¾“
- æœåŠ¡å™¨èº«ä»½éªŒè¯
- æ•°æ®å®Œæ•´æ€§ä¿æŠ¤
```

**ğŸ”¹ HTTPSé…ç½®å®ç°**

```nginx
# Nginx HTTPSé…ç½®
server {
    listen 443 ssl http2;
    server_name example.com;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/private.key;
    
    # TLSç‰ˆæœ¬é™åˆ¶
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    
    # å®‰å…¨å“åº”å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
}

# HTTPå¼ºåˆ¶è·³è½¬HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}
```

### 2.2 TLS 1.2+ æœ€ä½æ ‡å‡†


**TLSç‰ˆæœ¬å®‰å…¨å¯¹æ¯”ï¼š**

| TLSç‰ˆæœ¬ | **å‘å¸ƒæ—¶é—´** | **å®‰å…¨çŠ¶æ€** | **æ¨èä½¿ç”¨** |
|---------|-------------|-------------|-------------|
| `TLS 1.0` | `1999å¹´` | `âŒ å·²å¼ƒç”¨` | `ç¦æ­¢ä½¿ç”¨` |
| `TLS 1.1` | `2006å¹´` | `âŒ å·²å¼ƒç”¨` | `ç¦æ­¢ä½¿ç”¨` |
| `TLS 1.2` | `2008å¹´` | `âœ… å®‰å…¨` | `æœ€ä½æ ‡å‡†` |
| `TLS 1.3` | `2018å¹´` | `âœ… æœ€å®‰å…¨` | `ä¼˜å…ˆæ¨è` |

### 2.3 æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨


**ğŸ”¹ åˆ†å±‚åŠ å¯†ç­–ç•¥**

```javascript
// å¯†ç åŠ å¯†å­˜å‚¨
const bcrypt = require('bcrypt');

class PasswordManager {
  // å¯†ç å“ˆå¸Œï¼ˆä¸å¯é€†ï¼‰
  static async hashPassword(plainPassword) {
    const saltRounds = 12;  // è¶³å¤Ÿé«˜çš„å¤æ‚åº¦
    return await bcrypt.hash(plainPassword, saltRounds);
  }
  
  // å¯†ç éªŒè¯
  static async verifyPassword(plainPassword, hashedPassword) {
    return await bcrypt.compare(plainPassword, hashedPassword);
  }
}

// æ•æ„Ÿæ•°æ®åŠ å¯†ï¼ˆå¯é€†ï¼‰
const crypto = require('crypto');

class DataEncryption {
  // AESåŠ å¯†æ•æ„Ÿä¿¡æ¯
  static encrypt(text) {
    const algorithm = 'aes-256-gcm';
    const key = crypto.scryptSync(process.env.ENCRYPT_KEY, 'salt', 32);
    const iv = crypto.randomBytes(16);
    
    const cipher = crypto.createCipher(algorithm, key, iv);
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    return {
      iv: iv.toString('hex'),
      data: encrypted,
      tag: cipher.getAuthTag().toString('hex')
    };
  }
}
```

---

## 3. ğŸ›¡ï¸ è·¨ç«™æ”»å‡»é˜²æŠ¤


### 3.1 CSRF Token é˜²æŠ¤æœºåˆ¶


**CSRFæ”»å‡»åŸç†ï¼š**
```
æ¶æ„ç½‘ç«™åˆ©ç”¨ç”¨æˆ·å·²ç™»å½•çŠ¶æ€ï¼š

ç”¨æˆ·ç™»å½• â†’ é“¶è¡Œç½‘ç«™A â†’ è·å¾—Cookie
ç”¨æˆ·è®¿é—® â†’ æ¶æ„ç½‘ç«™B â†’ è‡ªåŠ¨æäº¤è½¬è´¦è¯·æ±‚åˆ°A
é“¶è¡Œç½‘ç«™A â†’ éªŒè¯Cookieæœ‰æ•ˆ â†’ æ‰§è¡Œè½¬è´¦ âŒ

CSRFæ”»å‡»æˆåŠŸï¼
```

**ğŸ”¹ CSRF Tokené˜²æŠ¤å®ç°**

```javascript
// ç”ŸæˆCSRF Token
const csrf = require('csurf');

// CSRFä¸­é—´ä»¶é…ç½®
const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: true,
    sameSite: 'strict'
  }
});

// åœ¨è¡¨å•ä¸­åŒ…å«CSRF Token
app.get('/transfer', csrfProtection, (req, res) => {
  res.render('transfer', { 
    csrfToken: req.csrfToken() 
  });
});

// éªŒè¯CSRF Token
app.post('/transfer', csrfProtection, (req, res) => {
  // TokenéªŒè¯é€šè¿‡æ‰èƒ½æ‰§è¡Œè½¬è´¦
  processTransfer(req.body);
});
```

**å‰ç«¯Tokenä½¿ç”¨ï¼š**
```html
<!-- è¡¨å•ä¸­åŒ…å«CSRF Token -->
<form action="/transfer" method="POST">
  <input type="hidden" name="_csrf" value="{{csrfToken}}">
  <input type="text" name="amount" placeholder="è½¬è´¦é‡‘é¢">
  <button type="submit">ç¡®è®¤è½¬è´¦</button>
</form>
```

### 3.2 SameSite Cookie é…ç½®


**SameSiteå±æ€§è¯¦è§£ï¼š**

```javascript
// ä¸åŒSameSiteè®¾ç½®çš„å®‰å…¨æ•ˆæœ
const cookieOptions = {
  sameSite: 'strict'    // æœ€ä¸¥æ ¼ï¼šå®Œå…¨ç¦æ­¢è·¨ç«™è¯·æ±‚æºå¸¦
  // sameSite: 'lax'    // é€‚ä¸­ï¼šGETè¯·æ±‚å¯æºå¸¦
  // sameSite: 'none'   // æœ€å®½æ¾ï¼šæ‰€æœ‰è¯·æ±‚éƒ½æºå¸¦ï¼ˆéœ€é…åˆsecureï¼‰
};
```

**å„æ¨¡å¼å¯¹æ¯”ï¼š**

| æ¨¡å¼ | **è·¨ç«™GETè¯·æ±‚** | **è·¨ç«™POSTè¯·æ±‚** | **å®‰å…¨çº§åˆ«** | **å…¼å®¹æ€§** |
|------|---------------|----------------|-------------|-----------|
| `strict` | `âŒ ä¸æºå¸¦` | `âŒ ä¸æºå¸¦` | `ğŸ”’ æœ€é«˜` | `å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ` |
| `lax` | `âœ… æºå¸¦` | `âŒ ä¸æºå¸¦` | `ğŸ” è¾ƒé«˜` | `å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ` |
| `none` | `âœ… æºå¸¦` | `âœ… æºå¸¦` | `âš ï¸ è¾ƒä½` | `éœ€è¦é…åˆHTTPS` |

### 3.3 Referer æ ¡éªŒ


```javascript
// Refereræ ¡éªŒä¸­é—´ä»¶
function validateReferer(req, res, next) {
  const referer = req.get('Referer');
  const allowedDomains = ['https://example.com', 'https://www.example.com'];
  
  if (!referer) {
    return res.status(403).json({ error: 'ç¼ºå°‘Refererå¤´' });
  }
  
  const refererDomain = new URL(referer).origin;
  if (!allowedDomains.includes(refererDomain)) {
    return res.status(403).json({ error: 'éæ³•æ¥æºè¯·æ±‚' });
  }
  
  next();
}

// åº”ç”¨åˆ°æ•æ„Ÿæ“ä½œ
app.post('/sensitive-action', validateReferer, csrfProtection, handler);
```

---

## 4. ğŸš« XSSé˜²æŠ¤ç­–ç•¥


### 4.1 è¾“å‡ºç¼–ç é˜²æŠ¤


**XSSæ”»å‡»åŸç†ï¼š**
```
æ¶æ„è„šæœ¬æ³¨å…¥ï¼š
ç”¨æˆ·è¾“å…¥ï¼š<script>alert('XSS')</script>
ç½‘ç«™ç›´æ¥è¾“å‡ºï¼šé¡µé¢æ‰§è¡Œæ¶æ„è„šæœ¬ âŒ

é˜²æŠ¤æ–¹æ³•ï¼š
ç”¨æˆ·è¾“å…¥ï¼š<script>alert('XSS')</script>
ç¼–ç è¾“å‡ºï¼š&lt;script&gt;alert('XSS')&lt;/script&gt; âœ…
```

**ğŸ”¹ è¾“å‡ºç¼–ç å®ç°**

```javascript
// HTMLå®ä½“ç¼–ç 
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// æ¨¡æ¿å¼•æ“è‡ªåŠ¨ç¼–ç ï¼ˆEJSç¤ºä¾‹ï¼‰
app.set('view engine', 'ejs');
// EJSé»˜è®¤ä¼šå¯¹ <%= %> è¿›è¡ŒHTMLç¼–ç 
// ä½¿ç”¨ <%- %> æ‰ä¼šè¾“å‡ºåŸå§‹HTMLï¼ˆå±é™©ï¼ï¼‰

// ä½¿ç”¨ç¤ºä¾‹
app.get('/profile', (req, res) => {
  const userInput = req.query.name;
  res.render('profile', { 
    safeName: escapeHtml(userInput)  // å®‰å…¨è¾“å‡º
  });
});
```

### 4.2 é¿å… innerHTML çš„å®‰å…¨æ›¿ä»£


```javascript
// âŒ å±é™©åšæ³•ï¼šç›´æ¥ä½¿ç”¨innerHTML
function unsafeUpdate(userContent) {
  document.getElementById('content').innerHTML = userContent;
  // å¦‚æœuserContentåŒ…å«<script>ï¼Œä¼šè¢«æ‰§è¡Œï¼
}

// âœ… å®‰å…¨åšæ³•ï¼šä½¿ç”¨textContent
function safeUpdate(userContent) {
  document.getElementById('content').textContent = userContent;
  // æ‰€æœ‰å†…å®¹éƒ½ä½œä¸ºçº¯æ–‡æœ¬å¤„ç†
}

// âœ… éœ€è¦HTMLæ—¶çš„å®‰å…¨åšæ³•
function safeHtmlUpdate(userContent) {
  // ä½¿ç”¨å¯ä¿¡çš„HTMLæ¸…ç†åº“
  const DOMPurify = require('dompurify');
  const cleanHtml = DOMPurify.sanitize(userContent);
  document.getElementById('content').innerHTML = cleanHtml;
}
```

### 4.3 CSP (Content Security Policy) ç­–ç•¥


**ğŸ”¹ CSPåŸºç¡€é…ç½®**

```javascript
// Expressä¸­é…ç½®CSP
const helmet = require('helmet');

app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],                    // é»˜è®¤åªå…è®¸åŒæº
    scriptSrc: ["'self'", "'unsafe-inline'"], // è„šæœ¬æ¥æºé™åˆ¶
    styleSrc: ["'self'", "'unsafe-inline'"],  // æ ·å¼æ¥æºé™åˆ¶
    imgSrc: ["'self'", "data:", "https:"],    // å›¾ç‰‡æ¥æºé™åˆ¶
    connectSrc: ["'self'"],                   // AJAXè¯·æ±‚é™åˆ¶
    fontSrc: ["'self'"],                      // å­—ä½“æ¥æºé™åˆ¶
    objectSrc: ["'none'"],                    // ç¦æ­¢æ’ä»¶
    upgradeInsecureRequests: []               // HTTPå‡çº§HTTPS
  }
}));
```

**CSPç­–ç•¥è§£é‡Šï¼š**

| æŒ‡ä»¤ | **å«ä¹‰** | **å®‰å…¨ä½œç”¨** |
|------|---------|-------------|
| `default-src 'self'` | `é»˜è®¤åªå…è®¸åŒæºèµ„æº` | `é˜»æ­¢å¤–éƒ¨æ¶æ„èµ„æº` |
| `script-src 'self'` | `åªå…è®¸åŒæºè„šæœ¬` | `é˜²æ­¢XSSæ³¨å…¥è„šæœ¬` |
| `object-src 'none'` | `ç¦æ­¢æ‰€æœ‰æ’ä»¶` | `é˜²æ­¢Flashç­‰æ’ä»¶æ¼æ´` |
| `upgrade-insecure-requests` | `HTTPè¯·æ±‚å‡çº§HTTPS` | `å¼ºåˆ¶åŠ å¯†ä¼ è¾“` |

---

## 5. ğŸ’‰ æ³¨å…¥æ”»å‡»é˜²æŠ¤


### 5.1 SQLé¢„ç¼–è¯‘é˜²æŠ¤


**SQLæ³¨å…¥æ”»å‡»åŸç†ï¼š**
```
æ¶æ„SQLæ³¨å…¥ï¼š
ç”¨æˆ·è¾“å…¥ï¼šadmin'; DROP TABLE users; --
æ‹¼æ¥SQLï¼šSELECT * FROM users WHERE username = 'admin'; DROP TABLE users; --'
ç»“æœï¼šåˆ é™¤æ•´ä¸ªç”¨æˆ·è¡¨ï¼âŒ

é¢„ç¼–è¯‘é˜²æŠ¤ï¼š
å‚æ•°åŒ–æŸ¥è¯¢å°†ç”¨æˆ·è¾“å…¥ä½œä¸ºå‚æ•°ï¼Œä¸ä¼šè¢«å½“ä½œSQLæ‰§è¡Œ âœ…
```

**ğŸ”¹ é¢„ç¼–è¯‘æŸ¥è¯¢å®ç°**

```javascript
// âŒ å±é™©åšæ³•ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
function unsafeLogin(username, password) {
  const sql = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;
  return db.query(sql);  // å®¹æ˜“è¢«æ³¨å…¥ï¼
}

// âœ… å®‰å…¨åšæ³•ï¼šå‚æ•°åŒ–æŸ¥è¯¢
function safeLogin(username, password) {
  const sql = 'SELECT * FROM users WHERE username = ? AND password = ?';
  return db.query(sql, [username, password]);  // å‚æ•°å•ç‹¬ä¼ é€’
}

// Node.js + MySQL ç¤ºä¾‹
const mysql = require('mysql2');
const connection = mysql.createConnection(dbConfig);

// ä½¿ç”¨å ä½ç¬¦
function getUserById(userId) {
  return new Promise((resolve, reject) => {
    const sql = 'SELECT * FROM users WHERE id = ?';
    connection.execute(sql, [userId], (err, results) => {
      if (err) reject(err);
      else resolve(results);
    });
  });
}
```

### 5.2 å‚æ•°åŒ–ç»‘å®šæœ€ä½³å®è·µ


```javascript
// ORMæ¡†æ¶çš„å®‰å…¨å®è·µï¼ˆSequelizeç¤ºä¾‹ï¼‰
const { User } = require('./models');

// âœ… ORMè‡ªåŠ¨å¤„ç†å‚æ•°åŒ–
async function findUser(username) {
  return await User.findOne({
    where: {
      username: username  // è‡ªåŠ¨å‚æ•°åŒ–ï¼Œå®‰å…¨
    }
  });
}

// âœ… åŸç”ŸSQLä¹Ÿè¦å‚æ•°åŒ–
async function customQuery(status, limit) {
  const [results] = await sequelize.query(
    'SELECT * FROM users WHERE status = ? LIMIT ?',
    {
      replacements: [status, limit],  // å‚æ•°æ•°ç»„
      type: QueryTypes.SELECT
    }
  );
  return results;
}
```

### 5.3 ç™½åå•æ ¡éªŒ


```javascript
// è¾“å…¥æ ¡éªŒä¸­é—´ä»¶
const validator = require('validator');

function validateInput(req, res, next) {
  const { username, email, age } = req.body;
  
  // ç”¨æˆ·åç™½åå•å­—ç¬¦
  if (!validator.isAlphanumeric(username)) {
    return res.status(400).json({ error: 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—' });
  }
  
  // é‚®ç®±æ ¼å¼æ ¡éªŒ
  if (!validator.isEmail(email)) {
    return res.status(400).json({ error: 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®' });
  }
  
  // å¹´é¾„èŒƒå›´æ ¡éªŒ
  if (!validator.isInt(age.toString(), { min: 1, max: 120 })) {
    return res.status(400).json({ error: 'å¹´é¾„å¿…é¡»åœ¨1-120ä¹‹é—´' });
  }
  
  next();
}

// æ–‡ä»¶ä¸Šä¼ ç™½åå•
const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/gif'];
const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif'];

function validateFileUpload(file) {
  const extension = path.extname(file.originalname).toLowerCase();
  
  if (!allowedMimeTypes.includes(file.mimetype)) {
    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
  }
  
  if (!allowedExtensions.includes(extension)) {
    throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å');
  }
  
  return true;
}
```

---

## 6. ğŸ” æ¥å£å®‰å…¨é…ç½®


### 6.1 é™æµä¸­é—´ä»¶é˜²æŠ¤


```javascript
// åŸºäºexpress-rate-limitçš„é™æµé…ç½®
const rateLimit = require('express-rate-limit');

// é€šç”¨æ¥å£é™æµ
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,    // 15åˆ†é’Ÿçª—å£
  max: 100,                    // æœ€å¤š100æ¬¡è¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,       // è¿”å›é€Ÿç‡é™åˆ¶ä¿¡æ¯åœ¨ `RateLimit-*` å¤´ä¸­
  legacyHeaders: false
});

// ç™»å½•æ¥å£ä¸¥æ ¼é™æµ
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,    // 15åˆ†é’Ÿçª—å£
  max: 5,                      // æœ€å¤š5æ¬¡ç™»å½•å°è¯•
  skipSuccessfulRequests: true, // æˆåŠŸè¯·æ±‚ä¸è®¡å…¥é™åˆ¶
  message: 'ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·15åˆ†é’Ÿåå†è¯•'
});

// APIæ¥å£é™æµ
const apiLimiter = rateLimit({
  windowMs: 1 * 60 * 1000,     // 1åˆ†é’Ÿçª—å£
  max: 20,                     // æœ€å¤š20æ¬¡APIè°ƒç”¨
  keyGenerator: (req) => {
    return req.user?.id || req.ip; // åŸºäºç”¨æˆ·IDæˆ–IPé™æµ
  }
});

// åº”ç”¨é™æµ
app.use('/api/', apiLimiter);
app.use('/auth/login', loginLimiter);
app.use(generalLimiter);
```

### 6.2 ç­¾åæ ¡éªŒæœºåˆ¶


```javascript
// APIç­¾åæ ¡éªŒ
const crypto = require('crypto');

class APISignature {
  // ç”Ÿæˆç­¾å
  static generateSignature(params, timestamp, secretKey) {
    // 1. å‚æ•°æ’åº
    const sortedParams = Object.keys(params)
      .sort()
      .map(key => `${key}=${params[key]}`)
      .join('&');
    
    // 2. æ„å»ºç­¾åå­—ç¬¦ä¸²
    const signString = `${sortedParams}&timestamp=${timestamp}&key=${secretKey}`;
    
    // 3. ç”ŸæˆMD5ç­¾å
    return crypto.createHash('md5').update(signString).digest('hex').toUpperCase();
  }
  
  // éªŒè¯ç­¾å
  static verifySignature(req, res, next) {
    const { signature, timestamp, ...params } = req.body;
    const secretKey = process.env.API_SECRET_KEY;
    
    // æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
    const now = Date.now();
    if (Math.abs(now - timestamp) > 300000) { // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
      return res.status(401).json({ error: 'è¯·æ±‚å·²è¿‡æœŸ' });
    }
    
    // éªŒè¯ç­¾å
    const expectedSignature = APISignature.generateSignature(params, timestamp, secretKey);
    if (signature !== expectedSignature) {
      return res.status(401).json({ error: 'ç­¾åéªŒè¯å¤±è´¥' });
    }
    
    next();
  }
}
```

### 6.3 æƒé™æ§åˆ¶ä¸­é—´ä»¶


```javascript
// è§’è‰²æƒé™æ§åˆ¶
const PERMISSIONS = {
  USER: ['read:profile', 'update:profile'],
  ADMIN: ['read:users', 'update:users', 'delete:users'],
  SUPER_ADMIN: ['*'] // æ‰€æœ‰æƒé™
};

function requirePermission(permission) {
  return (req, res, next) => {
    const userRole = req.user?.role;
    const userPermissions = PERMISSIONS[userRole] || [];
    
    // è¶…çº§ç®¡ç†å‘˜æœ‰æ‰€æœ‰æƒé™
    if (userPermissions.includes('*')) {
      return next();
    }
    
    // æ£€æŸ¥å…·ä½“æƒé™
    if (!userPermissions.includes(permission)) {
      return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
    }
    
    next();
  };
}

// ä½¿ç”¨æƒé™æ§åˆ¶
app.get('/api/users', 
  authenticateToken,           // å…ˆéªŒè¯ç™»å½•
  requirePermission('read:users'),  // å†éªŒè¯æƒé™
  getUserList
);

app.delete('/api/users/:id',
  authenticateToken,
  requirePermission('delete:users'),
  deleteUser
);
```

---

## 7. ğŸŒ è·¨åŸŸå®‰å…¨æ§åˆ¶


### 7.1 ç²¾ç¡® Origin é…ç½®


```javascript
// CORSé…ç½®æœ€ä½³å®è·µ
const cors = require('cors');

// âŒ å±é™©é…ç½®ï¼šå…è®¸æ‰€æœ‰æ¥æº
const unsafeCorsConfig = {
  origin: '*',                    // å…è®¸ä»»ä½•åŸŸå
  credentials: true               // å…è®¸æºå¸¦å‡­è¯
  // è¿™ç§ç»„åˆæå…¶å±é™©ï¼
};

// âœ… å®‰å…¨é…ç½®ï¼šç²¾ç¡®æ§åˆ¶æ¥æº
const safeCorsConfig = {
  origin: function (origin, callback) {
    // å…è®¸çš„åŸŸåç™½åå•
    const allowedOrigins = [
      'https://www.example.com',
      'https://app.example.com',
      'https://admin.example.com'
    ];
    
    // å…è®¸åŒæºè¯·æ±‚ï¼ˆoriginä¸ºundefinedï¼‰
    if (!origin) return callback(null, true);
    
    // æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ä¸­
    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('ä¸å…è®¸çš„è·¨åŸŸè¯·æ±‚æ¥æº'));
    }
  },
  credentials: true,              // å…è®¸æºå¸¦Cookie
  optionsSuccessStatus: 200,      // å…¼å®¹æ—§æµè§ˆå™¨
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With']
};

app.use(cors(safeCorsConfig));
```

### 7.2 ç¯å¢ƒåˆ†ç¦»é…ç½®


```javascript
// æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®CORS
function getCorsConfig() {
  const env = process.env.NODE_ENV;
  
  switch (env) {
    case 'development':
      return {
        origin: ['http://localhost:3000', 'http://localhost:8080'],
        credentials: true
      };
      
    case 'staging':
      return {
        origin: ['https://staging.example.com'],
        credentials: true
      };
      
    case 'production':
      return {
        origin: ['https://www.example.com', 'https://app.example.com'],
        credentials: true
      };
      
    default:
      return { origin: false }; // é»˜è®¤æ‹’ç»æ‰€æœ‰è·¨åŸŸ
  }
}

app.use(cors(getCorsConfig()));
```

### 7.3 ç¦æ­¢é€šé…ç¬¦+å‡­è¯ç»„åˆ


**ä¸ºä»€ä¹ˆè¿™ç§ç»„åˆå±é™©ï¼Ÿ**
```
å±é™©é…ç½®ï¼š
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true

æ”»å‡»åœºæ™¯ï¼š
1. æ¶æ„ç½‘ç«™ evil.com å‘èµ·è¯·æ±‚
2. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦ç”¨æˆ·çš„Cookie
3. æœåŠ¡å™¨å“åº”æ•°æ®ç»™æ¶æ„ç½‘ç«™
4. ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼
```

**ğŸ”¹ å®‰å…¨æ›¿ä»£æ–¹æ¡ˆ**

```javascript
// âŒ ç»å¯¹ç¦æ­¢çš„é…ç½®
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Credentials', 'true');
  // è¿™ç§ç»„åˆä¼šè¢«æµè§ˆå™¨æ‹’ç»ï¼
});

// âœ… æ­£ç¡®çš„åŠ¨æ€Originé…ç½®
app.use((req, res, next) => {
  const origin = req.headers.origin;
  const allowedOrigins = ['https://www.example.com', 'https://app.example.com'];
  
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);  // è¿”å›å…·ä½“åŸŸå
    res.header('Access-Control-Allow-Credentials', 'true');
  }
  
  next();
});
```

---

## 8. âœ… å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•


### 8.1 å¼€å‘ç¯å¢ƒå®‰å…¨è¦ç‚¹


```markdown
ğŸ”§ **å¼€å‘ç¯å¢ƒæ£€æŸ¥æ¸…å•**

**åŸºç¡€é…ç½®ï¼š**
- [ ] ä½¿ç”¨HTTPSï¼ˆè‡³å°‘è‡ªç­¾åè¯ä¹¦ï¼‰
- [ ] é…ç½®ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆ.envï¼‰
- [ ] æ·»åŠ .envåˆ°.gitignore
- [ ] è®¾ç½®åˆç†çš„CORSç­–ç•¥

**ä»£ç å®‰å…¨ï¼š**
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯
- [ ] æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–
- [ ] é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- [ ] æ·»åŠ åŸºç¡€çš„å®‰å…¨å“åº”å¤´

**è°ƒè¯•å®‰å…¨ï¼š**
- [ ] å…³é—­è¯¦ç»†é”™è¯¯ä¿¡æ¯è¾“å‡º
- [ ] é¿å…åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
- [ ] ä½¿ç”¨å®‰å…¨çš„è°ƒè¯•å·¥å…·
```

### 8.2 æµ‹è¯•ç¯å¢ƒå®‰å…¨é…ç½®


```markdown
ğŸ§ª **æµ‹è¯•ç¯å¢ƒæ£€æŸ¥æ¸…å•**

**ç¯å¢ƒéš”ç¦»ï¼š**
- [ ] ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“
- [ ] é…ç½®æµ‹è¯•ä¸“ç”¨çš„å¯†é’¥
- [ ] é™åˆ¶å¤–ç½‘è®¿é—®æƒé™
- [ ] ä½¿ç”¨æµ‹è¯•æ•°æ®ï¼Œé¿å…çœŸå®ç”¨æˆ·ä¿¡æ¯

**å®‰å…¨æµ‹è¯•ï¼š**
- [ ] è¿›è¡ŒåŸºç¡€çš„æ¸—é€æµ‹è¯•
- [ ] æ£€æŸ¥SQLæ³¨å…¥é˜²æŠ¤
- [ ] éªŒè¯XSSé˜²æŠ¤æ•ˆæœ
- [ ] æµ‹è¯•CSRFé˜²æŠ¤æœºåˆ¶

**æ€§èƒ½å®‰å…¨ï¼š**
- [ ] æµ‹è¯•é™æµåŠŸèƒ½
- [ ] éªŒè¯å¤§æ–‡ä»¶ä¸Šä¼ é™åˆ¶
- [ ] æ£€æŸ¥å†…å­˜æ³„æ¼é—®é¢˜
```

### 8.3 ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®


```markdown
ğŸš€ **ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**

**ç½‘ç»œå®‰å…¨ï¼š**
- [ ] å¼ºåˆ¶HTTPSï¼Œç¦ç”¨HTTP
- [ ] é…ç½®HSTSå“åº”å¤´
- [ ] ä½¿ç”¨CDNå’Œé˜²ç«å¢™
- [ ] éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯

**è®¤è¯æˆæƒï¼š**
- [ ] åŒå› å­è®¤è¯ï¼ˆ2FAï¼‰
- [ ] å¼ºå¯†ç ç­–ç•¥
- [ ] ä¼šè¯è¶…æ—¶é…ç½®
- [ ] å®šæœŸè½®æ¢å¯†é’¥

**ç›‘æ§å‘Šè­¦ï¼š**
- [ ] å¼‚å¸¸ç™»å½•ç›‘æ§
- [ ] APIè°ƒç”¨é¢‘ç‡ç›‘æ§
- [ ] å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•
- [ ] è‡ªåŠ¨å¤‡ä»½ç­–ç•¥

**åº”æ€¥å“åº”ï¼š**
- [ ] åˆ¶å®šå®‰å…¨äº‹ä»¶å“åº”æµç¨‹
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [ ] å»ºç«‹å®‰å…¨è”ç³»æœºåˆ¶
```

### 8.4 å®‰å…¨é…ç½®éªŒè¯å·¥å…·


```javascript
// è‡ªåŠ¨å®‰å…¨æ£€æŸ¥è„šæœ¬
class SecurityChecker {
  static checkBasicSecurity(app) {
    const issues = [];
    
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨HTTPS
    if (!app.get('trust proxy') && process.env.NODE_ENV === 'production') {
      issues.push('ç”Ÿäº§ç¯å¢ƒåº”è¯¥é…ç½®HTTPS');
    }
    
    // æ£€æŸ¥æ˜¯å¦è®¾ç½®å®‰å…¨å¤´
    const securityHeaders = [
      'X-Frame-Options',
      'X-Content-Type-Options',
      'Strict-Transport-Security'
    ];
    
    // æ£€æŸ¥ç¯å¢ƒå˜é‡
    const requiredEnvVars = [
      'JWT_SECRET',
      'DB_PASSWORD',
      'SESSION_SECRET'
    ];
    
    requiredEnvVars.forEach(envVar => {
      if (!process.env[envVar]) {
        issues.push(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${envVar}`);
      }
    });
    
    return issues;
  }
  
  // è¿è¡Œå®‰å…¨æ£€æŸ¥
  static runSecurityAudit() {
    console.log('ğŸ” å¼€å§‹å®‰å…¨é…ç½®æ£€æŸ¥...');
    const issues = this.checkBasicSecurity();
    
    if (issues.length === 0) {
      console.log('âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼');
    } else {
      console.log('âŒ å‘ç°å®‰å…¨é—®é¢˜ï¼š');
      issues.forEach(issue => console.log(`   - ${issue}`));
    }
  }
}

// åœ¨åº”ç”¨å¯åŠ¨æ—¶è¿è¡Œæ£€æŸ¥
if (process.env.NODE_ENV === 'production') {
  SecurityChecker.runSecurityAudit();
}
```

---

## ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### ğŸ” **è®¤è¯å®‰å…¨æ ¸å¿ƒ**

- **åŒTokenæœºåˆ¶**ï¼šçŸ­æœŸAccessToken + é•¿æœŸRefreshToken
- **Cookieå®‰å…¨**ï¼šHttpOnly + Secure + SameSiteé…ç½®
- **ä¼šè¯ç®¡ç†**ï¼šåˆç†çš„è¿‡æœŸæ—¶é—´å’Œåˆ·æ–°ç­–ç•¥

### ğŸ”’ **é€šä¿¡åŠ å¯†è¦ç‚¹**

- **å…¨ç«™HTTPS**ï¼šå¼ºåˆ¶åŠ å¯†ä¼ è¾“ï¼Œé…ç½®HSTS
- **TLSç‰ˆæœ¬**ï¼šæœ€ä½ä½¿ç”¨TLS 1.2ï¼Œæ¨èTLS 1.3
- **æ•°æ®åŠ å¯†**ï¼šå¯†ç å“ˆå¸Œå­˜å‚¨ï¼Œæ•æ„Ÿæ•°æ®AESåŠ å¯†

### ğŸ›¡ï¸ **æ”»å‡»é˜²æŠ¤ç­–ç•¥**

- **CSRFé˜²æŠ¤**ï¼šTokenéªŒè¯ + SameSite + Refereræ ¡éªŒ
- **XSSé˜²æŠ¤**ï¼šè¾“å‡ºç¼–ç  + é¿å…innerHTML + CSPç­–ç•¥
- **æ³¨å…¥é˜²æŠ¤**ï¼šå‚æ•°åŒ–æŸ¥è¯¢ + è¾“å…¥æ ¡éªŒ + ç™½åå•è¿‡æ»¤

### ğŸ”§ **æ¥å£å®‰å…¨é…ç½®**

- **é™æµä¿æŠ¤**ï¼šåˆ†çº§é™æµï¼Œç™»å½•æ¥å£ä¸¥æ ¼é™åˆ¶
- **ç­¾åæ ¡éªŒ**ï¼šAPIè¯·æ±‚ç­¾å + æ—¶é—´æˆ³é˜²é‡æ”¾
- **æƒé™æ§åˆ¶**ï¼šåŸºäºè§’è‰²çš„ç²¾ç»†åŒ–æƒé™ç®¡ç†

### ğŸŒ **è·¨åŸŸå®‰å…¨ç®¡ç†**

- **ç²¾ç¡®Origin**ï¼šç™½åå•æ§åˆ¶ï¼Œé¿å…é€šé…ç¬¦
- **ç¯å¢ƒåˆ†ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒCORSé…ç½®
- **å‡­è¯æ§åˆ¶**ï¼šè°¨æ…ä½¿ç”¨credentialsé€‰é¡¹

**å®‰å…¨å£è¯€è®°å¿†ï¼š**
- è®¤è¯ç”¨åŒTokenï¼ŒCookieè¦å®‰å…¨
- é€šä¿¡å¿…é¡»HTTPSï¼ŒåŠ å¯†ä¸èƒ½çœ
- è¾“å‡ºè¦ç¼–ç ï¼Œè¾“å…¥è¦æ ¡éªŒ  
- æ¥å£æ§æƒé™ï¼Œè·¨åŸŸè¦ç²¾ç¡®
- é…ç½®åˆ†ç¯å¢ƒï¼Œç›‘æ§ä¸èƒ½åœ