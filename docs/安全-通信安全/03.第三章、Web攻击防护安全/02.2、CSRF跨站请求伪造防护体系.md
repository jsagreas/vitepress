---
title: 2ã€CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ é˜²æŠ¤ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [CSRFæ”»å‡»æœ¬è´¨ç†è§£](#1-CSRFæ”»å‡»æœ¬è´¨ç†è§£)
2. [CSRFæ”»å‡»ç±»å‹è¯¦è§£](#2-CSRFæ”»å‡»ç±»å‹è¯¦è§£)
3. [CSRF Tokené˜²æŠ¤æœºåˆ¶](#3-CSRF-Tokené˜²æŠ¤æœºåˆ¶)
4. [SameSite Cookieç­–ç•¥](#4-SameSite-Cookieç­–ç•¥)
5. [RefereréªŒè¯æœºåˆ¶](#5-RefereréªŒè¯æœºåˆ¶)
6. [CSRFé˜²æŠ¤å®æˆ˜éƒ¨ç½²](#6-CSRFé˜²æŠ¤å®æˆ˜éƒ¨ç½²)
7. [ä¸šåŠ¡åœºæ™¯é˜²æŠ¤ç­–ç•¥](#7-ä¸šåŠ¡åœºæ™¯é˜²æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CSRFæ”»å‡»æœ¬è´¨ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**ğŸ”¸ ç®€å•ç†è§£**
CSRF (Cross-Site Request Forgery) ç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯"è·¨ç«™è¯·æ±‚ä¼ªé€ "ã€‚å¬èµ·æ¥å¤æ‚ï¼Œå…¶å®å¾ˆå¥½ç†è§£ï¼š

```
æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š
ä½ å·²ç»ç™»å½•äº†é“¶è¡Œç½‘ç«™Aï¼Œæµè§ˆå™¨è®°ä½äº†ä½ çš„èº«ä»½ï¼ˆCookieï¼‰
è¿™æ—¶ä½ è®¿é—®äº†æ¶æ„ç½‘ç«™B
æ¶æ„ç½‘ç«™Bå·å·å‘é“¶è¡Œç½‘ç«™Aå‘é€è½¬è´¦è¯·æ±‚
ç”±äºä½ å·²ç»ç™»å½•ï¼Œæµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸Šäº†ä½ çš„èº«ä»½ä¿¡æ¯
é“¶è¡Œç½‘ç«™Aä»¥ä¸ºæ˜¯ä½ æœ¬äººæ“ä½œï¼Œæ‰§è¡Œäº†è½¬è´¦
```

**ğŸ’¡ æ ¸å¿ƒåŸç†**
```
CSRFæ”»å‡»çš„ä¸‰ä¸ªå…³é”®è¦ç´ ï¼š
1. ç”¨æˆ·å·²ç»åœ¨ç›®æ ‡ç½‘ç«™ç™»å½•ï¼ˆæœ‰Cookieï¼‰
2. æ¶æ„ç½‘ç«™è¯±å¯¼ç”¨æˆ·è®¿é—®
3. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦Cookieå‘é€è¯·æ±‚

å°±åƒæœ‰äººå·ç”¨ä½ çš„èº«ä»½è¯å»åŠäº‹ï¼Œé“¶è¡Œçœ‹åˆ°èº«ä»½è¯æ˜¯çœŸçš„ï¼Œå°±è¯¯ä»¥ä¸ºæ˜¯ä½ æœ¬äºº
```

### 1.2 é€šä¿¡åŠ«æŒç‰¹ç‚¹æ·±å…¥è§£æ


**ğŸ” åŸºäºå·²è®¤è¯çŠ¶æ€çš„æ¬ºéª—**
```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ· â†’ ç™»å½•é“¶è¡Œç½‘ç«™ â†’ è·å¾—Cookieèº«ä»½å‡­è¯ â†’ è¿›è¡Œæ“ä½œ

CSRFæ”»å‡»æµç¨‹ï¼š
ç”¨æˆ· â†’ å·²ç™»å½•é“¶è¡Œç½‘ç«™ï¼ˆæœ‰Cookieï¼‰
     â†“
     è®¿é—®æ¶æ„ç½‘ç«™
     â†“
     æ¶æ„ç½‘ç«™å‘èµ·ä¼ªé€ è¯·æ±‚ â†’ æµè§ˆå™¨è‡ªåŠ¨å¸¦Cookie â†’ é“¶è¡Œæ‰§è¡Œæ“ä½œ
```

**âš ï¸ ç”¨æˆ·Cookieè‡ªåŠ¨å¸¦å…¥æ¼æ´**
```
æµè§ˆå™¨çš„"å¥½å¿ƒ"æˆäº†æ¼æ´ï¼š
- æµè§ˆå™¨è®¾è®¡ï¼šå‘åŒä¸€åŸŸåå‘è¯·æ±‚æ—¶è‡ªåŠ¨æºå¸¦è¯¥åŸŸåçš„Cookie
- æ”»å‡»è€…åˆ©ç”¨ï¼šåœ¨æ¶æ„é¡µé¢ä¸­å‘ç›®æ ‡ç½‘ç«™å‘è¯·æ±‚
- ç»“æœï¼šç›®æ ‡ç½‘ç«™æ”¶åˆ°å¸¦æœ‰ç”¨æˆ·èº«ä»½çš„ä¼ªé€ è¯·æ±‚

è¿™å°±åƒä½ çš„é’¥åŒ™è¢«å¤åˆ¶äº†ï¼Œåˆ«äººå¯ä»¥å†’å……ä½ å¼€é—¨
```

### 1.3 CSRFæ”»å‡»åœºæ™¯ç¤ºä¾‹


**ğŸ“Š æ”»å‡»ç¤ºæ„å›¾**
```
ç”¨æˆ·è®¾å¤‡                æ¶æ„ç½‘ç«™              ç›®æ ‡ç½‘ç«™(é“¶è¡Œ)
   â”‚                      â”‚                      â”‚
   â”‚â”€â”€ 1.å·²ç™»å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                      â”‚                      â”‚ï¼ˆç”¨æˆ·è·å¾—Cookieï¼‰
   â”‚â”€â”€ 2.è®¿é—®æ¶æ„ç½‘ç«™ â”€â”€â”€â”€â†’â”‚                      â”‚
   â”‚                      â”‚                      â”‚
   â”‚                      â”‚â”€â”€ 3.å·å·å‘èµ·è½¬è´¦è¯·æ±‚ â”€â”€â†’â”‚
   â”‚                      â”‚  (Cookieè‡ªåŠ¨æºå¸¦)     â”‚
   â”‚                      â”‚                      â”‚
   â”‚                      â”‚                âœ… 4.è½¬è´¦æˆåŠŸ â”‚
   â”‚                      â”‚   (ä»¥ä¸ºæ˜¯ç”¨æˆ·æœ¬äººæ“ä½œ)   â”‚
```

---

## 2. ğŸ­ CSRFæ”»å‡»ç±»å‹è¯¦è§£


### 2.1 GETå‹CSRFæ”»å‡»


**ğŸ”¸ æ”»å‡»åŸç†**
GETå‹CSRFæ˜¯æœ€ç®€å•çš„æ”»å‡»æ–¹å¼ï¼Œé€šè¿‡èƒ½å‘èµ·GETè¯·æ±‚çš„HTMLæ ‡ç­¾æ¥å®ç°æ”»å‡»ã€‚

**ğŸ’» imgæ ‡ç­¾æ”»å‡»ç¤ºä¾‹**
```html
<!-- æ¶æ„ç½‘ç«™é¡µé¢ -->
<h1>æ­å–œä½ ä¸­å¥–äº†ï¼</h1>
<p>ç‚¹å‡»ä¸‹æ–¹é“¾æ¥é¢†å–å¥–å“</p>

<!-- éšè—çš„æ¶æ„å›¾ç‰‡æ ‡ç­¾ -->
<img src="http://bank.com/transfer?to=hacker&amount=10000" 
     style="display:none">

<!-- 
å½“ç”¨æˆ·è®¿é—®è¿™ä¸ªé¡µé¢æ—¶ï¼š
1. æµè§ˆå™¨åŠ è½½å›¾ç‰‡ï¼Œå‘é“¶è¡Œç½‘ç«™å‘GETè¯·æ±‚
2. å¦‚æœç”¨æˆ·å·²ç™»å½•é“¶è¡Œï¼ŒCookieä¼šè‡ªåŠ¨æºå¸¦
3. é“¶è¡Œæ”¶åˆ°è¯·æ±‚ï¼Œä»¥ä¸ºæ˜¯ç”¨æˆ·è¦è½¬è´¦10000å…ƒç»™hacker
-->
```

**ğŸ”— linkæ ‡ç­¾æ”»å‡»ç¤ºä¾‹**
```html
<!-- é€šè¿‡linkæ ‡ç­¾é¢„åŠ è½½æ”»å‡» -->
<link rel="prefetch" href="http://bank.com/delete-account">

<!-- 
prefetchä¼šè®©æµè§ˆå™¨æå‰è¯·æ±‚èµ„æº
å¦‚æœè¿™ä¸ªURLæ˜¯å±é™©æ“ä½œï¼Œå°±ä¼šè¢«æ„å¤–æ‰§è¡Œ
-->
```

**âš ï¸ GETå‹æ”»å‡»ç‰¹ç‚¹**
- âœ… **å®æ–½ç®€å•**ï¼šåªéœ€è¦ä¸€ä¸ªURL
- âœ… **éšè”½æ€§å¼º**ï¼šç”¨æˆ·çœ‹ä¸åˆ°æ”»å‡»è¿‡ç¨‹
- âŒ **å±€é™æ€§å¤§**ï¼šåªèƒ½æ”»å‡»GETæ¥å£
- âŒ **å‚æ•°æš´éœ²**ï¼šæ”»å‡»å‚æ•°åœ¨URLä¸­å¯è§

### 2.2 POSTå‹CSRFæ”»å‡»


**ğŸ”¸ æ”»å‡»åŸç†**
POSTå‹CSRFé€šè¿‡è¡¨å•æˆ–Ajaxæ¥å‘èµ·POSTè¯·æ±‚ï¼Œèƒ½å¤Ÿæ”»å‡»æ›´å¤šç±»å‹çš„æ¥å£ã€‚

**ğŸ“ è¡¨å•æ”»å‡»ç¤ºä¾‹**
```html
<!-- æ¶æ„ç½‘ç«™çš„éšè—è¡¨å• -->
<form id="maliciousForm" 
      action="http://bank.com/transfer" 
      method="POST" 
      style="display:none">
    <input name="to" value="hacker">
    <input name="amount" value="50000">
    <input name="memo" value="ç”Ÿæ—¥ç¤¼ç‰©">
</form>

<script>
// é¡µé¢åŠ è½½åè‡ªåŠ¨æäº¤è¡¨å•
window.onload = function() {
    document.getElementById('maliciousForm').submit();
}
</script>

<!-- 
æ”»å‡»æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®æ¶æ„é¡µé¢
2. é¡µé¢è‡ªåŠ¨æäº¤éšè—è¡¨å•
3. æµè§ˆå™¨å‘é“¶è¡Œå‘POSTè¯·æ±‚ï¼Œæºå¸¦ç”¨æˆ·Cookie
4. é“¶è¡Œæ‰§è¡Œè½¬è´¦æ“ä½œ
-->
```

**âš¡ Ajaxæ”»å‡»ç¤ºä¾‹**
```javascript
// ç°ä»£æµè§ˆå™¨çš„Ajaxæ”»å‡»
fetch('http://bank.com/api/transfer', {
    method: 'POST',
    credentials: 'include',  // å…³é”®ï¼šåŒ…å«Cookie
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        to: 'hacker',
        amount: 100000,
        type: 'urgent'
    })
});

// æ³¨æ„ï¼š
// credentials: 'include' è®©æµè§ˆå™¨æºå¸¦Cookie
// è¿™æ˜¯Ajax CSRFæ”»å‡»çš„å…³é”®è®¾ç½®
```

**ğŸ¯ POSTå‹æ”»å‡»ç‰¹ç‚¹**
- âœ… **æ”»å‡»é¢å¹¿**ï¼šèƒ½æ”»å‡»POST/PUT/DELETEç­‰æ¥å£
- âœ… **å‚æ•°éšè”½**ï¼šå‚æ•°åœ¨è¯·æ±‚ä½“ä¸­ï¼Œä¸æ˜“è¢«å‘ç°
- âœ… **åŠŸèƒ½å¼ºå¤§**ï¼šå¯ä»¥å‘é€å¤æ‚çš„JSONæ•°æ®
- âŒ **å®æ–½å¤æ‚**ï¼šéœ€è¦æ„é€ è¡¨å•æˆ–ç¼–å†™JavaScript

---

## 3. ğŸ›¡ï¸ CSRF Tokené˜²æŠ¤æœºåˆ¶


### 3.1 Tokené˜²æŠ¤æ ¸å¿ƒæ€æƒ³


**ğŸ’¡ åŸºæœ¬ç†å¿µ**
```
é—®é¢˜ï¼šæµè§ˆå™¨ä¼šè‡ªåŠ¨æºå¸¦Cookieï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§
è§£å†³ï¼šå¢åŠ ä¸€ä¸ªæ”»å‡»è€…æ— æ³•è·å–çš„éšæœºä»¤ç‰Œ(Token)

å°±åƒé“¶è¡Œå¡å¯†ç ä¸€æ ·ï¼š
- Cookie = é“¶è¡Œå¡ï¼ˆå¯èƒ½è¢«å¤åˆ¶ï¼‰
- Token = å¯†ç ï¼ˆåªæœ‰æœ¬äººçŸ¥é“ï¼‰
- è½¬è´¦éœ€è¦åŒæ—¶æä¾›é“¶è¡Œå¡å’Œå¯†ç 
```

**ğŸ”„ Tokenå·¥ä½œæµç¨‹**
```
æœåŠ¡ç«¯ç”Ÿæˆ â†’ å‘é€ç»™å®¢æˆ·ç«¯ â†’ å®¢æˆ·ç«¯è¯·æ±‚æ—¶æºå¸¦ â†’ æœåŠ¡ç«¯éªŒè¯

è¯¦ç»†æ­¥éª¤ï¼š
1. ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ï¼ŒæœåŠ¡ç«¯ç”ŸæˆéšæœºToken
2. Tokené€šè¿‡é¡µé¢æˆ–Ajaxå“åº”å‘ç»™å®¢æˆ·ç«¯
3. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶å¿…é¡»æºå¸¦è¿™ä¸ªToken
4. æœåŠ¡ç«¯éªŒè¯Tokenæ˜¯å¦æ­£ç¡®ä¸”æœ‰æ•ˆ
```

### 3.2 éšæœºä»¤ç‰Œç”Ÿæˆæœºåˆ¶


**ğŸ² Tokenç”Ÿæˆè¦æ±‚**
```java
// Tokenå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼š
1. éšæœºæ€§ï¼šæ— æ³•é¢„æµ‹
2. å”¯ä¸€æ€§ï¼šæ¯æ¬¡éƒ½ä¸åŒ
3. æ—¶æ•ˆæ€§ï¼šæœ‰è¿‡æœŸæ—¶é—´
4. ç»‘å®šæ€§ï¼šä¸ç”¨æˆ·ä¼šè¯ç»‘å®š

// Javaç¤ºä¾‹ï¼šç”Ÿæˆå®‰å…¨Token
public class CSRFTokenGenerator {
    public static String generateToken() {
        // ä½¿ç”¨å¼ºéšæœºæ•°ç”Ÿæˆå™¨
        SecureRandom random = new SecureRandom();
        byte[] tokenBytes = new byte[32];
        random.nextBytes(tokenBytes);
        
        // è½¬æ¢ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²
        return ByteArrays.toHexString(tokenBytes);
    }
}
```

**ğŸ” Tokenå­˜å‚¨æ–¹å¼**
```javascript
// æ–¹å¼1ï¼šå­˜å‚¨åœ¨éšè—è¡¨å•å­—æ®µ
<input type="hidden" name="_csrf_token" value="abc123xyz">

// æ–¹å¼2ï¼šå­˜å‚¨åœ¨metaæ ‡ç­¾
<meta name="csrf-token" content="abc123xyz">

// æ–¹å¼3ï¼šé€šè¿‡Ajaxè·å–
fetch('/api/csrf-token')
    .then(response => response.json())
    .then(data => {
        window.csrfToken = data.token;
    });
```

### 3.3 åŒé‡æäº¤éªŒè¯è¯¦è§£


**ğŸ”„ åŒé‡éªŒè¯æµç¨‹**
```
æ­¥éª¤è¯¦è§£ï¼š

1. æœåŠ¡ç«¯ç”ŸæˆToken
   - ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
   - è®¾ç½®è¿‡æœŸæ—¶é—´
   - ç»‘å®šç”¨æˆ·ä¼šè¯

2. å®¢æˆ·ç«¯è·å–Token
   - é¡µé¢åŠ è½½æ—¶è·å–
   - å­˜å‚¨åœ¨é¡µé¢ä¸­ï¼ˆéšè—å­—æ®µ/metaæ ‡ç­¾ï¼‰
   - JavaScriptè¯»å–å¤‡ç”¨

3. å®¢æˆ·ç«¯æºå¸¦Token
   - è¡¨å•ï¼šéšè—å­—æ®µæäº¤
   - Ajaxï¼šè¯·æ±‚å¤´æˆ–å‚æ•°æºå¸¦
   - å¿…é¡»ä¸è¯·æ±‚ä¸€èµ·å‘é€

4. æœåŠ¡ç«¯éªŒè¯Token
   - æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
   - éªŒè¯Tokenæ˜¯å¦æ­£ç¡®
   - ç¡®è®¤Tokenæœªè¿‡æœŸ
   - éªŒè¯é€šè¿‡æ‰å¤„ç†è¯·æ±‚
```

**ğŸ’» åŒé‡éªŒè¯å®ç°ç¤ºä¾‹**
```html
<!-- å‰ç«¯ï¼šè¡¨å•ä¸­åŒ…å«Token -->
<form action="/transfer" method="POST">
    <input type="hidden" name="_csrf_token" 
           value="{{csrf_token}}">
    <input name="amount" value="1000">
    <button type="submit">è½¬è´¦</button>
</form>
```

```java
// åç«¯ï¼šéªŒè¯Token
@PostMapping("/transfer")
public String transfer(
    @RequestParam String _csrf_token,
    @RequestParam String amount,
    HttpSession session) {
    
    // 1. è·å–ä¼šè¯ä¸­å­˜å‚¨çš„Token
    String sessionToken = (String) session.getAttribute("csrf_token");
    
    // 2. éªŒè¯Token
    if (sessionToken == null || !sessionToken.equals(_csrf_token)) {
        throw new SecurityException("CSRF TokenéªŒè¯å¤±è´¥");
    }
    
    // 3. TokenéªŒè¯é€šè¿‡ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘
    return processTransfer(amount);
}
```

---

## 4. ğŸª SameSite Cookieç­–ç•¥


### 4.1 SameSiteå±æ€§è¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯SameSite**
SameSiteæ˜¯Cookieçš„ä¸€ä¸ªå±æ€§ï¼Œç”¨æ¥é™åˆ¶ç¬¬ä¸‰æ–¹Cookieçš„å‘é€ï¼Œæ˜¯é˜²æŠ¤CSRFæ”»å‡»çš„ç°ä»£åŒ–æ‰‹æ®µã€‚

```
ç†è§£SameSiteï¼š
- Same = ç›¸åŒ
- Site = ç«™ç‚¹
- SameSite = åŒä¸€ç«™ç‚¹

ç®€å•è¯´ï¼šåªæœ‰åŒä¸€ä¸ªç½‘ç«™æ‰èƒ½ä½¿ç”¨è¿™ä¸ªCookie
```

**âš™ï¸ SameSiteä¸‰ç§æ¨¡å¼**

**ğŸ”’ Strictï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰**
```
ç‰¹ç‚¹ï¼šæœ€ä¸¥æ ¼çš„é™åˆ¶
è§„åˆ™ï¼šåªæœ‰å®Œå…¨åŒä¸€ç«™ç‚¹æ‰å‘é€Cookie
é€‚ç”¨ï¼šé«˜å®‰å…¨è¦æ±‚çš„åœºæ™¯

ç¤ºä¾‹ï¼š
Set-Cookie: sessionId=abc123; SameSite=Strict

å½±å“ï¼š
- ç”¨æˆ·ä»å…¶ä»–ç½‘ç«™é“¾æ¥è·³è½¬è¿‡æ¥æ—¶ï¼Œä¸ä¼šæºå¸¦Cookie
- éœ€è¦é‡æ–°ç™»å½•
- å®‰å…¨æ€§æœ€é«˜ï¼Œä½†ç”¨æˆ·ä½“éªŒè¾ƒå·®
```

**ğŸ”“ Laxï¼ˆå®½æ¾æ¨¡å¼ï¼‰**
```
ç‰¹ç‚¹ï¼šå¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§
è§„åˆ™ï¼šå¯¼èˆªåˆ°ç›®æ ‡ç½‘ç«™æ—¶å¯ä»¥å‘é€Cookieï¼Œä½†åµŒå…¥èµ„æºä¸è¡Œ
é€‚ç”¨ï¼šå¤§å¤šæ•°ç½‘ç«™çš„é»˜è®¤é€‰æ‹©

ç¤ºä¾‹ï¼š
Set-Cookie: sessionId=abc123; SameSite=Lax

å…è®¸çš„æƒ…å†µï¼š
- ç‚¹å‡»é“¾æ¥è·³è½¬ï¼šâœ… å‘é€Cookie
- è¡¨å•GETæäº¤ï¼šâœ… å‘é€Cookie

ä¸å…è®¸çš„æƒ…å†µï¼š
- img/iframeåµŒå…¥ï¼šâŒ ä¸å‘é€Cookie  
- Ajaxè·¨ç«™è¯·æ±‚ï¼šâŒ ä¸å‘é€Cookie
- è¡¨å•POSTæäº¤ï¼šâŒ ä¸å‘é€Cookie
```

**ğŸŒ Noneï¼ˆæ— é™åˆ¶ï¼‰**
```
ç‰¹ç‚¹ï¼šå…è®¸è·¨ç«™å‘é€Cookie
è§„åˆ™ï¼šå¿…é¡»é…åˆSecureå±æ€§ä½¿ç”¨ï¼ˆä»…HTTPSï¼‰
é€‚ç”¨ï¼šéœ€è¦è·¨ç«™åŠŸèƒ½çš„åœºæ™¯

ç¤ºä¾‹ï¼š
Set-Cookie: sessionId=abc123; SameSite=None; Secure

ä½¿ç”¨åœºæ™¯ï¼š
- ç¬¬ä¸‰æ–¹åµŒå…¥ç»„ä»¶
- è·¨åŸŸå•ç‚¹ç™»å½•
- APIæ¥å£è°ƒç”¨
```

### 4.2 SameSiteé™åˆ¶è·¨ç«™æœºåˆ¶


**ğŸ” è·¨ç«™è¯·æ±‚é˜»æ–­åŸç†**
```
å½“è®¾ç½®SameSite=Laxæ—¶ï¼š

æ­£å¸¸è®¿é—®æµç¨‹ï¼š
ç”¨æˆ· â†’ ç›´æ¥è®¿é—®bank.com â†’ æµè§ˆå™¨å‘é€Cookie âœ…

CSRFæ”»å‡»æµç¨‹ï¼š
ç”¨æˆ· â†’ è®¿é—®evil.com â†’ evil.comå‘èµ·åˆ°bank.comçš„è¯·æ±‚ â†’ æµè§ˆå™¨ä¸å‘é€Cookie âŒ

é˜»æ–­åŸç†ï¼š
æµè§ˆå™¨æ£€æŸ¥è¯·æ±‚æ¥æºå’Œç›®æ ‡æ˜¯å¦åŒç«™
ä¸åŒç«™çš„è¯·æ±‚è¢«é™åˆ¶å‘é€Cookie
æ”»å‡»è¯·æ±‚å¤±æ•ˆï¼Œæ— æ³•è·å¾—ç”¨æˆ·èº«ä»½
```

**âš¡ é…ç½®ç¤ºä¾‹**
```javascript
// Express.jsé…ç½®SameSite
app.use(session({
    name: 'sessionId',
    secret: 'your-secret',
    cookie: {
        sameSite: 'lax',  // è®¾ç½®SameSite
        secure: true,     // HTTPSç¯å¢ƒä¸‹è®¾ç½®
        httpOnly: true    // é˜²æ­¢XSS
    }
}));
```

```java
// Spring Booté…ç½®SameSite
@Configuration
public class CookieConfig {
    
    @Bean
    public CookieSameSiteSupplier cookieSameSiteSupplier() {
        return CookieSameSiteSupplier.ofLax();
    }
}
```

---

## 5. ğŸ” RefereréªŒè¯æœºåˆ¶


### 5.1 Refererå¤´æ ¡éªŒåŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯Referer**
Refereræ˜¯HTTPè¯·æ±‚å¤´ï¼Œè®°å½•äº†å‘èµ·è¯·æ±‚çš„é¡µé¢åœ°å€ï¼Œå¯ä»¥ç”¨æ¥éªŒè¯è¯·æ±‚æ¥æºã€‚

```
ç†è§£Refererï¼š
å½“ä½ ä»Aé¡µé¢ç‚¹å‡»é“¾æ¥åˆ°Bé¡µé¢æ—¶
Bé¡µé¢çš„è¯·æ±‚ä¼šåŒ…å«ï¼šReferer: Aé¡µé¢çš„URL

å°±åƒå¿«é€’åŒ…è£¹ä¸Šçš„"å‘ä»¶åœ°å€"
```

**ğŸ“‹ RefereréªŒè¯æµç¨‹**
```
è¯·æ±‚æ¥æºéªŒè¯æ­¥éª¤ï¼š

1. ç”¨æˆ·åœ¨bank.comæ“ä½œ
   Referer: https://bank.com/dashboard
   âœ… æ¥æºæ­£ç¡®ï¼Œå…è®¸æ“ä½œ

2. æ”»å‡»è€…ä»evil.comå‘èµ·è¯·æ±‚
   Referer: https://evil.com/attack
   âŒ æ¥æºå¯ç–‘ï¼Œæ‹’ç»æ“ä½œ

3. æ²¡æœ‰Refererå¤´
   å¯èƒ½åŸå› ï¼šç›´æ¥è¾“å…¥URLã€ä¹¦ç­¾è®¿é—®
   âš ï¸ éœ€è¦é¢å¤–åˆ¤æ–­
```

### 5.2 è¯·æ±‚æ¥æºéªŒè¯å®ç°


**ğŸ’» æœåŠ¡ç«¯éªŒè¯ä»£ç **
```java
@Component
public class RefererValidator {
    
    private static final List<String> ALLOWED_ORIGINS = Arrays.asList(
        "https://bank.com",
        "https://www.bank.com",
        "https://m.bank.com"
    );
    
    public boolean validateReferer(HttpServletRequest request) {
        String referer = request.getHeader("Referer");
        
        // 1. æ£€æŸ¥Refereræ˜¯å¦å­˜åœ¨
        if (referer == null || referer.isEmpty()) {
            // å¯ä»¥é€‰æ‹©æ‹’ç»æˆ–å…è®¸ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰
            return false;
        }
        
        // 2. éªŒè¯Refereræ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
        try {
            URL refererUrl = new URL(referer);
            String origin = refererUrl.getProtocol() + "://" + refererUrl.getHost();
            
            return ALLOWED_ORIGINS.contains(origin);
        } catch (MalformedURLException e) {
            return false;
        }
    }
}
```

### 5.3 å¤´éƒ¨ä¼ªé€ æ£€æµ‹ä¸é˜²æŠ¤


**âš ï¸ RefereréªŒè¯çš„å±€é™æ€§**
```
Refererå¯èƒ½ç¼ºå¤±çš„æƒ…å†µï¼š
1. ç”¨æˆ·éšç§è®¾ç½®ï¼šæµè§ˆå™¨ç¦ç”¨Referer
2. HTTPSé™çº§ï¼šä»HTTPSåˆ°HTTPä¸å‘é€Referer
3. ç›´æ¥è®¿é—®ï¼šç”¨æˆ·ç›´æ¥è¾“å…¥URL
4. ç§»åŠ¨åº”ç”¨ï¼šæŸäº›APPå†…æµè§ˆå™¨ä¸å‘é€

Refererä¼ªé€ çš„å¯èƒ½ï¼š
1. æµè§ˆå™¨æ’ä»¶ï¼šå¯ä»¥ä¿®æ”¹è¯·æ±‚å¤´
2. ä»£ç†æœåŠ¡å™¨ï¼šå¯èƒ½ä¿®æ”¹æˆ–åˆ é™¤Referer
3. ä¸­é—´äººæ”»å‡»ï¼šç½‘ç»œå±‚é¢çš„ä¿®æ”¹
```

**ğŸ›¡ï¸ HTTPSé™çº§é£é™©é˜²æŠ¤**
```java
// ç»¼åˆéªŒè¯ç­–ç•¥
@Component  
public class SecurityValidator {
    
    public boolean validateRequest(HttpServletRequest request) {
        // 1. ä¼˜å…ˆä½¿ç”¨TokenéªŒè¯
        if (hasValidToken(request)) {
            return true;
        }
        
        // 2. å¤‡ç”¨RefereréªŒè¯
        if (validateReferer(request)) {
            return true;
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨çš„æ“ä½œç±»å‹
        if (isSafeOperation(request)) {
            return true;
        }
        
        return false;
    }
    
    private boolean isSafeOperation(HttpServletRequest request) {
        // GETã€HEADã€OPTIONSç­‰å®‰å…¨æ–¹æ³•
        String method = request.getMethod();
        return "GET".equals(method) || "HEAD".equals(method);
    }
}
```

---

## 6. ğŸš€ CSRFé˜²æŠ¤å®æˆ˜éƒ¨ç½²


### 6.1 å‰åç«¯Tokenä¼ é€’å®ç°


**ğŸ“ è¡¨å•Tokenä¼ é€’**
```html
<!-- åç«¯æ¨¡æ¿æ¸²æŸ“Token -->
<form action="/api/transfer" method="POST">
    <!-- éšè—å­—æ®µæºå¸¦Token -->
    <input type="hidden" name="_token" value="{{csrf_token}}">
    
    <div>
        <label>è½¬è´¦é‡‘é¢ï¼š</label>
        <input name="amount" type="number" required>
    </div>
    
    <button type="submit">ç¡®è®¤è½¬è´¦</button>
</form>
```

**âš¡ Ajaxè¯·æ±‚Tokenä¼ é€’**
```javascript
// æ–¹å¼1ï¼šä»metaæ ‡ç­¾è·å–Token
const token = document.querySelector('meta[name="csrf-token"]').content;

// æ–¹å¼2ï¼šä»å…¨å±€å˜é‡è·å–
const token = window.csrfToken;

// å‘é€Ajaxè¯·æ±‚
fetch('/api/transfer', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': token  // é€šè¿‡è¯·æ±‚å¤´ä¼ é€’
    },
    body: JSON.stringify({
        amount: 1000,
        to: 'friend123'
    })
});
```

### 6.2 è¡¨å•/Fetché˜²æŠ¤å®æˆ˜


**ğŸ”¸ è¡¨å•CSRFæ”»å‡»æ¨¡æ‹Ÿ**
```html
<!-- æ”»å‡»è€…ç½‘ç«™ï¼šæ¨¡æ‹Ÿæ¶æ„è¡¨å• -->
<!DOCTYPE html>
<html>
<head>
    <title>ä¸­å¥–é€šçŸ¥</title>
</head>
<body>
    <h1>æ­å–œä¸­å¥–ï¼ç‚¹å‡»é¢†å–å¥–é‡‘</h1>
    
    <!-- éšè—çš„æ¶æ„è¡¨å• -->
    <form id="attack" action="https://bank.com/transfer" method="POST">
        <input name="to" value="attacker">
        <input name="amount" value="10000">
    </form>
    
    <button onclick="document.getElementById('attack').submit()">
        é¢†å–å¥–é‡‘
    </button>
</body>
</html>
```

**ğŸ›¡ï¸ è¡¨å•CSRFé˜²æŠ¤å®ç°**
```html
<!-- é˜²æŠ¤åçš„æ­£å¸¸è¡¨å• -->
<form action="/transfer" method="POST" onsubmit="return validateForm()">
    <!-- å¿…é¡»åŒ…å«Token -->
    <input type="hidden" name="_token" value="{{csrf_token}}" required>
    
    <input name="amount" type="number" min="1" max="50000" required>
    <button type="submit">è½¬è´¦</button>
</form>

<script>
function validateForm() {
    // å‰ç«¯é¢å¤–éªŒè¯
    const token = document.querySelector('input[name="_token"]').value;
    if (!token) {
        alert('å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return false;
    }
    return true;
}
</script>
```

**âš¡ Fetch APIé˜²æŠ¤å®ç°**
```javascript
// å°è£…å®‰å…¨çš„fetchå‡½æ•°
class SecureFetch {
    constructor() {
        this.token = this.getCSRFToken();
    }
    
    getCSRFToken() {
        // ä»å¤šä¸ªåœ°æ–¹å°è¯•è·å–Token
        return document.querySelector('meta[name="csrf-token"]')?.content ||
               document.querySelector('input[name="_token"]')?.value ||
               window.csrfToken;
    }
    
    async post(url, data) {
        if (!this.token) {
            throw new Error('CSRF Token not found');
        }
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': this.token
            },
            credentials: 'same-origin',  // åªå‘é€åŒæºCookie
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const api = new SecureFetch();
api.post('/api/transfer', { amount: 1000, to: 'friend' })
   .then(result => console.log('è½¬è´¦æˆåŠŸ', result))
   .catch(error => console.error('è½¬è´¦å¤±è´¥', error));
```

---

## 7. ğŸ’¼ ä¸šåŠ¡åœºæ™¯é˜²æŠ¤ç­–ç•¥


### 7.1 æ”¯ä»˜æ¥å£é˜²æŠ¤


**ğŸ’³ æ”¯ä»˜æµç¨‹å®‰å…¨è®¾è®¡**
```
æ”¯ä»˜æ¥å£çš„ç‰¹æ®Šè¦æ±‚ï¼š
1. ç»å¯¹ä¸èƒ½å‡ºé”™ï¼šèµ„é‡‘å®‰å…¨ç¬¬ä¸€
2. å¤šé‡éªŒè¯ï¼šToken + çŸ­ä¿¡éªŒè¯ + æ”¯ä»˜å¯†ç 
3. é£é™©æ§åˆ¶ï¼šå¼‚å¸¸æ£€æµ‹ + é™é¢æ§åˆ¶

é˜²æŠ¤ç­–ç•¥ï¼š
- å¼ºåˆ¶TokenéªŒè¯
- æ”¯ä»˜å¯†ç äºŒæ¬¡ç¡®è®¤  
- çŸ­ä¿¡éªŒè¯ç 
- è®¾å¤‡æŒ‡çº¹éªŒè¯
- è¡Œä¸ºé£é™©åˆ†æ
```

**ğŸ” æ”¯ä»˜æ¥å£å®ç°**
```java
@PostMapping("/api/payment")
public ResponseEntity<?> processPayment(
    @RequestHeader("X-CSRF-TOKEN") String csrfToken,
    @RequestBody PaymentRequest request,
    HttpServletRequest httpRequest) {
    
    try {
        // 1. CSRF TokenéªŒè¯
        validateCSRFToken(csrfToken, httpRequest);
        
        // 2. æ”¯ä»˜å¯†ç éªŒè¯
        validatePaymentPassword(request.getPaymentPassword());
        
        // 3. çŸ­ä¿¡éªŒè¯ç éªŒè¯
        validateSMSCode(request.getSmsCode());
        
        // 4. é£é™©è¯„ä¼°
        RiskLevel risk = riskService.assessPayment(request);
        if (risk == RiskLevel.HIGH) {
            return ResponseEntity.status(403)
                .body("æ”¯ä»˜é£é™©è¿‡é«˜ï¼Œè¯·è”ç³»å®¢æœ");
        }
        
        // 5. æ‰§è¡Œæ”¯ä»˜
        PaymentResult result = paymentService.process(request);
        
        return ResponseEntity.ok(result);
        
    } catch (SecurityException e) {
        log.warn("æ”¯ä»˜å®‰å…¨éªŒè¯å¤±è´¥: {}", e.getMessage());
        return ResponseEntity.status(403)
            .body("å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}
```

### 7.2 åˆ é™¤æ“ä½œé˜²æŠ¤


**ğŸ—‘ï¸ å±é™©æ“ä½œä¿æŠ¤**
```
åˆ é™¤æ“ä½œçš„é£é™©ï¼š
- æ•°æ®æ— æ³•æ¢å¤
- å½±å“ä¸šåŠ¡è¿ç»­æ€§
- å¯èƒ½è¢«æ¶æ„åˆ©ç”¨

é˜²æŠ¤åŸåˆ™ï¼š
- äºŒæ¬¡ç¡®è®¤æœºåˆ¶
- è½¯åˆ é™¤ä¼˜å…ˆ
- æ“ä½œæ—¥å¿—è®°å½•
- æƒé™ä¸¥æ ¼æ§åˆ¶
```

**ğŸ’» åˆ é™¤æ¥å£å®ç°**
```javascript
// å‰ç«¯ï¼šåˆ é™¤ç¡®è®¤æµç¨‹
class DeleteConfirmation {
    async deleteAccount(accountId) {
        // 1. ç”¨æˆ·ç¡®è®¤
        const userConfirmed = await this.showConfirmDialog(
            'ç¡®å®šè¦åˆ é™¤è´¦æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼'
        );
        if (!userConfirmed) return;
        
        // 2. è¾“å…¥éªŒè¯ç 
        const verificationCode = await this.requestVerificationCode();
        if (!verificationCode) return;
        
        // 3. å‘é€åˆ é™¤è¯·æ±‚
        try {
            const result = await api.post('/api/accounts/delete', {
                accountId,
                verificationCode,
                confirmText: 'DELETE'  // é¢å¤–ç¡®è®¤
            });
            
            this.showSuccess('è´¦æˆ·åˆ é™¤æˆåŠŸ');
        } catch (error) {
            this.showError('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
    }
}
```

### 7.3 çŠ¶æ€å˜æ›´ä¸æ‰¹é‡æ“ä½œ


**ğŸ“Š çŠ¶æ€å˜æ›´é˜²æŠ¤**
```java
// é‡è¦çŠ¶æ€å˜æ›´æ¥å£
@PostMapping("/api/users/{userId}/status")
public ResponseEntity<?> changeUserStatus(
    @PathVariable Long userId,
    @RequestBody StatusChangeRequest request,
    @RequestHeader("X-CSRF-TOKEN") String token,
    HttpServletRequest httpRequest) {
    
    // 1. åŸºç¡€å®‰å…¨éªŒè¯
    validateCSRFToken(token, httpRequest);
    
    // 2. æƒé™éªŒè¯
    if (!hasPermission(getCurrentUser(), "CHANGE_USER_STATUS")) {
        throw new ForbiddenException("æ— æƒé™æ‰§è¡Œæ­¤æ“ä½œ");
    }
    
    // 3. çŠ¶æ€å˜æ›´åˆæ³•æ€§æ£€æŸ¥
    if (!isValidStatusTransition(request.getFromStatus(), request.getToStatus())) {
        throw new BusinessException("éæ³•çš„çŠ¶æ€å˜æ›´");
    }
    
    // 4. è®°å½•æ“ä½œæ—¥å¿—
    auditService.logStatusChange(userId, request, getCurrentUser());
    
    // 5. æ‰§è¡ŒçŠ¶æ€å˜æ›´
    userService.changeStatus(userId, request);
    
    return ResponseEntity.ok("çŠ¶æ€å˜æ›´æˆåŠŸ");
}
```

**ğŸ”„ æ‰¹é‡æ“ä½œå®‰å…¨æ§åˆ¶**
```java
@PostMapping("/api/users/batch-operation")
public ResponseEntity<?> batchOperation(
    @RequestBody BatchOperationRequest request,
    @RequestHeader("X-CSRF-TOKEN") String token) {
    
    // 1. TokenéªŒè¯
    validateCSRFToken(token);
    
    // 2. æ‰¹é‡é™åˆ¶
    if (request.getUserIds().size() > 100) {
        throw new BusinessException("å•æ¬¡æœ€å¤šæ“ä½œ100ä¸ªç”¨æˆ·");
    }
    
    // 3. æ“ä½œæƒé™éªŒè¯
    validateBatchPermission(request.getOperation());
    
    // 4. åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é•¿æ—¶é—´é”å®š
    List<BatchResult> results = new ArrayList<>();
    for (List<Long> batch : partition(request.getUserIds(), 10)) {
        BatchResult result = processBatch(batch, request.getOperation());
        results.add(result);
        
        // æ¯æ‰¹ä¹‹é—´çŸ­æš‚ä¼‘æ¯ï¼Œé¿å…ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
        Thread.sleep(100);
    }
    
    return ResponseEntity.ok(results);
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CSRFæœ¬è´¨ï¼šåˆ©ç”¨ç”¨æˆ·å·²ç™»å½•çŠ¶æ€ï¼Œä¼ªé€ è¯·æ±‚æ‰§è¡Œæ¶æ„æ“ä½œ
ğŸ”¸ æ”»å‡»æ¡ä»¶ï¼šç”¨æˆ·å·²ç™»å½• + è®¿é—®æ¶æ„ç½‘ç«™ + æµè§ˆå™¨è‡ªåŠ¨æºå¸¦Cookie
ğŸ”¸ æ”»å‡»ç±»å‹ï¼šGETå‹ï¼ˆimg/linkæ ‡ç­¾ï¼‰ã€POSTå‹ï¼ˆè¡¨å•/Ajaxï¼‰
ğŸ”¸ Tokené˜²æŠ¤ï¼šéšæœºä»¤ç‰Œ + åŒé‡éªŒè¯ + æœåŠ¡ç«¯æ ¡éªŒ
ğŸ”¸ SameSiteï¼šCookieè·¨ç«™é™åˆ¶ï¼Œç°ä»£æµè§ˆå™¨çš„é‡è¦é˜²æŠ¤æ‰‹æ®µ
ğŸ”¸ RefereréªŒè¯ï¼šè¯·æ±‚æ¥æºæ£€æŸ¥ï¼Œä½†æœ‰å±€é™æ€§éœ€è¦é…åˆä½¿ç”¨
```

### 8.2 é˜²æŠ¤ç­–ç•¥ä¼˜å…ˆçº§


**ğŸ† æ¨èçš„é˜²æŠ¤ç»„åˆ**
```
ç¬¬ä¸€å±‚ï¼šSameSite Cookie
- è®¾ç½® SameSite=Lax
- ç°ä»£æµè§ˆå™¨çš„åŸç”Ÿé˜²æŠ¤
- ç®€å•æœ‰æ•ˆï¼Œç”¨æˆ·ä½“éªŒå¥½

ç¬¬äºŒå±‚ï¼šCSRF Token
- æ‰€æœ‰çŠ¶æ€å˜æ›´æ“ä½œå¿…é¡»éªŒè¯Token
- éšæœºç”Ÿæˆï¼Œä¼šè¯ç»‘å®š
- æ”»å‡»è€…æ— æ³•è·å–

ç¬¬ä¸‰å±‚ï¼šRefereréªŒè¯
- ä½œä¸ºTokenéªŒè¯çš„è¡¥å……
- æ£€æŸ¥è¯·æ±‚æ¥æºåˆæ³•æ€§
- æ³¨æ„å¤„ç†Refererç¼ºå¤±æƒ…å†µ

ç¬¬å››å±‚ï¼šä¸šåŠ¡å±‚é˜²æŠ¤
- é‡è¦æ“ä½œäºŒæ¬¡ç¡®è®¤
- çŸ­ä¿¡/é‚®ä»¶éªŒè¯ç 
- æ“ä½œé¢‘ç‡é™åˆ¶
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æœ€ä½³å®è·µ**
- æ•æ„Ÿæ“ä½œå¿…é¡»ä½¿ç”¨POST/PUT/DELETEæ–¹æ³•
- æ‰€æœ‰çŠ¶æ€å˜æ›´æ“ä½œéƒ½è¦TokenéªŒè¯
- è®¾ç½®åˆé€‚çš„SameSiteå±æ€§
- é‡è¦æ“ä½œå¢åŠ é¢å¤–éªŒè¯æ‰‹æ®µ
- è®°å½•å®‰å…¨ç›¸å…³çš„æ“ä½œæ—¥å¿—

**âš ï¸ å¸¸è§è¯¯åŒº**
- è®¤ä¸ºHTTPSå°±è¶³å¤Ÿå®‰å…¨ï¼ˆCSRFæ”»å‡»ä¸ä¼ è¾“åŠ å¯†æ— å…³ï¼‰
- åªåœ¨å‰ç«¯éªŒè¯Tokenï¼ˆæ”»å‡»è€…å¯ä»¥ç»•è¿‡å‰ç«¯ï¼‰
- è¿‡åº¦ä¾èµ–RefereréªŒè¯ï¼ˆå¯èƒ½ç¼ºå¤±æˆ–è¢«ä¼ªé€ ï¼‰
- å¿½ç•¥ç§»åŠ¨åº”ç”¨ä¸­çš„CSRFé£é™©

**ğŸ¯ æ ¸å¿ƒè®°å¿†**
- CSRFæ”»å‡»å€Ÿç”¨æˆ·èº«ä»½ï¼ŒTokenéªŒè¯æ˜¯å…³é”®
- SameSiteæ˜¯ç°ä»£é˜²æŠ¤é¦–é€‰ï¼ŒLaxæ¨¡å¼æœ€å®ç”¨
- é‡è¦æ“ä½œå¤šé‡éªŒè¯ï¼Œå®‰å…¨æ°¸è¿œä¸å«Œå¤š
- å‰åç«¯é…åˆé˜²æŠ¤ï¼Œç¼ºä¸€ä¸å¯ä¿å®‰å…¨