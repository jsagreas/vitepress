---
title: 3ã€OAuth2æˆæƒä¸ç¬¬ä¸‰æ–¹ç™»å½•
---
## ğŸ“š ç›®å½•

1. [OAuth2åŸºç¡€æ¦‚å¿µ](#1-OAuth2åŸºç¡€æ¦‚å¿µ)
2. [OAuth2å››ç§æˆæƒæ¨¡å¼](#2-OAuth2å››ç§æˆæƒæ¨¡å¼)
3. [æˆæƒç æ¨¡å¼è¯¦è§£](#3-æˆæƒç æ¨¡å¼è¯¦è§£)
4. [ç¬¬ä¸‰æ–¹ç™»å½•å®è·µ](#4-ç¬¬ä¸‰æ–¹ç™»å½•å®è·µ)
5. [OAuth2å®‰å…¨é—®é¢˜ä¸é˜²æŠ¤](#5-OAuth2å®‰å…¨é—®é¢˜ä¸é˜²æŠ¤)
6. [OpenID Connectæ‰©å±•](#6-OpenID-Connectæ‰©å±•)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯OAuth2


**ç®€å•ç†è§£**ï¼šOAuth2å°±åƒæ˜¯ä¸€ä¸ª"ä»£å®¢æ³Šè½¦"çš„æœåŠ¡

```
ç°å®åœºæ™¯ï¼šä»£å®¢æ³Šè½¦
ä½ å¼€è½¦åˆ°é…’åº— â†’ æŠŠè½¦é’¥åŒ™ç»™æœåŠ¡å‘˜ â†’ æœåŠ¡å‘˜å»åœè½¦ â†’ ä½ è¿›é…’åº—

OAuth2åœºæ™¯ï¼šç¬¬ä¸‰æ–¹æˆæƒ
ä½ æƒ³ç”¨å¾®ä¿¡ç™»å½•æŸApp â†’ æˆæƒå¾®ä¿¡æä¾›ä½ çš„ä¿¡æ¯ â†’ Appè·å¾—ä½ çš„åŸºæœ¬ä¿¡æ¯ â†’ å®Œæˆç™»å½•
```

**æ ¸å¿ƒå«ä¹‰**ï¼šOAuth2æ˜¯ä¸€ä¸ª**æˆæƒæ¡†æ¶**ï¼Œè®©ç”¨æˆ·å¯ä»¥æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä»–ä»¬åœ¨å¦ä¸€ä¸ªæœåŠ¡ä¸Šçš„èµ„æºï¼Œ**è€Œä¸éœ€è¦æŠŠå¯†ç å‘Šè¯‰ç¬¬ä¸‰æ–¹åº”ç”¨**ã€‚

### 1.2 OAuth2è§£å†³çš„é—®é¢˜


**ä¼ ç»Ÿç™»å½•çš„é—®é¢˜**ï¼š
```
âŒ ç”¨æˆ·éœ€è¦æŠŠå¾®ä¿¡å¯†ç å‘Šè¯‰ç¬¬ä¸‰æ–¹App
âŒ ç¬¬ä¸‰æ–¹Appå¯ä»¥è®¿é—®ç”¨æˆ·å¾®ä¿¡çš„æ‰€æœ‰åŠŸèƒ½
âŒ ç”¨æˆ·æ— æ³•æ’¤é”€ç¬¬ä¸‰æ–¹Appçš„è®¿é—®æƒé™
âŒ å¯†ç æ³„éœ²é£é™©æé«˜
```

**OAuth2çš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
âœ… ç”¨æˆ·åªåœ¨å¾®ä¿¡å®˜æ–¹é¡µé¢è¾“å…¥å¯†ç 
âœ… ç¬¬ä¸‰æ–¹Appåªèƒ½è®¿é—®ç”¨æˆ·æˆæƒçš„ç‰¹å®šä¿¡æ¯
âœ… ç”¨æˆ·å¯ä»¥éšæ—¶æ’¤é”€æˆæƒ
âœ… å¯†ç å®Œå…¨ä¸ä¼šæ³„éœ²ç»™ç¬¬ä¸‰æ–¹
```

### 1.3 OAuth2æ ¸å¿ƒè§’è‰²


**å››ä¸ªå…³é”®è§’è‰²**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚    â”‚ç¬¬ä¸‰æ–¹åº”ç”¨    â”‚
â”‚ (Resource   â”‚    â”‚ (Client)    â”‚
â”‚  Owner)     â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚
       â”‚        æˆæƒ         â”‚
       â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æˆæƒæœåŠ¡å™¨    â”‚    â”‚èµ„æºæœåŠ¡å™¨    â”‚
â”‚(Authorizationâ”‚    â”‚ (Resource   â”‚
â”‚  Server)    â”‚    â”‚  Server)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ ç”¨æˆ·(Resource Owner)**
- **å«ä¹‰**ï¼šæ‹¥æœ‰èµ„æºçš„äººï¼Œæ¯”å¦‚ä½ çš„å¾®ä¿¡è´¦å·
- **ä½œç”¨**ï¼šå†³å®šæ˜¯å¦æˆæƒç¬¬ä¸‰æ–¹è®¿é—®è‡ªå·±çš„ä¿¡æ¯

**ğŸ”¸ ç¬¬ä¸‰æ–¹åº”ç”¨(Client)**  
- **å«ä¹‰**ï¼šæƒ³è¦è·å–ç”¨æˆ·ä¿¡æ¯çš„åº”ç”¨ï¼Œæ¯”å¦‚æŸä¸ªè´­ç‰©App
- **ä½œç”¨**ï¼šè¯·æ±‚æˆæƒï¼Œä½¿ç”¨Tokenè®¿é—®ç”¨æˆ·ä¿¡æ¯

**ğŸ”¸ æˆæƒæœåŠ¡å™¨(Authorization Server)**
- **å«ä¹‰**ï¼šè´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½å’Œå‘æ”¾æˆæƒçš„æœåŠ¡å™¨ï¼Œæ¯”å¦‚å¾®ä¿¡çš„æˆæƒæœåŠ¡å™¨
- **ä½œç”¨**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå‘æ”¾æˆæƒç å’ŒToken

**ğŸ”¸ èµ„æºæœåŠ¡å™¨(Resource Server)**
- **å«ä¹‰**ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡å™¨ï¼Œæ¯”å¦‚å¾®ä¿¡çš„ç”¨æˆ·ä¿¡æ¯API
- **ä½œç”¨**ï¼šéªŒè¯Tokenï¼Œæä¾›ç”¨æˆ·ä¿¡æ¯

---

## 2. ğŸ”„ OAuth2å››ç§æˆæƒæ¨¡å¼


### 2.1 æˆæƒæ¨¡å¼æ¦‚è§ˆ


| æˆæƒæ¨¡å¼ | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨çº§åˆ«** | **å¸¸è§åº”ç”¨** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **æˆæƒç æ¨¡å¼** | `æœ‰åç«¯çš„Webåº”ç”¨` | `æœ€é«˜` | `ç½‘ç«™ç¬¬ä¸‰æ–¹ç™»å½•` |
| ğŸ”¸ **éšå¼æ¨¡å¼** | `çº¯å‰ç«¯åº”ç”¨` | `ä¸­ç­‰` | `å•é¡µé¢åº”ç”¨` |
| ğŸ”¸ **å¯†ç æ¨¡å¼** | `é«˜åº¦ä¿¡ä»»çš„åº”ç”¨` | `ä½` | `è‡ªå®¶åº”ç”¨` |
| ğŸ”¸ **å®¢æˆ·ç«¯æ¨¡å¼** | `æœåŠ¡å™¨é—´é€šä¿¡` | `é«˜` | `APIè°ƒç”¨` |

### 2.2 å„æ¨¡å¼æ ¸å¿ƒåŒºåˆ«


**ğŸ”¹ å®‰å…¨æ€§å¯¹æ¯”**
```
æˆæƒç æ¨¡å¼ï¼šæˆæƒç  â†’ Tokenï¼ˆä¸¤æ­¥éªŒè¯ï¼Œæœ€å®‰å…¨ï¼‰
éšå¼æ¨¡å¼ï¼šç›´æ¥è¿”å›Tokenï¼ˆä¸€æ­¥éªŒè¯ï¼Œé£é™©è¾ƒé«˜ï¼‰
å¯†ç æ¨¡å¼ï¼šç›´æ¥ç”¨ç”¨æˆ·åå¯†ç ï¼ˆä¸æ¨èï¼‰
å®¢æˆ·ç«¯æ¨¡å¼ï¼šç”¨åº”ç”¨å‡­è¯ï¼ˆæœåŠ¡å™¨ä¸“ç”¨ï¼‰
```

**ğŸ”¹ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
æœ‰åç«¯æœåŠ¡å™¨ â†’ æˆæƒç æ¨¡å¼ï¼ˆæ¨èï¼‰
çº¯å‰ç«¯åº”ç”¨ â†’ éšå¼æ¨¡å¼
è‡ªå®¶äº§å“ â†’ å¯†ç æ¨¡å¼ï¼ˆæ…ç”¨ï¼‰
æœåŠ¡å™¨è°ƒç”¨API â†’ å®¢æˆ·ç«¯æ¨¡å¼
```

---

## 3. ğŸ¯ æˆæƒç æ¨¡å¼è¯¦è§£


### 3.1 ä¸ºä»€ä¹ˆæˆæƒç æ¨¡å¼æœ€å®‰å…¨


**æ ¸å¿ƒå®‰å…¨æœºåˆ¶**ï¼š**ä¸¤æ­¥éªŒè¯**

```
ç¬¬ä¸€æ­¥ï¼šè·å–æˆæƒç ï¼ˆåœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­ï¼‰
ç¬¬äºŒæ­¥ï¼šç”¨æˆæƒç æ¢Tokenï¼ˆåœ¨æœåŠ¡å™¨ä¸­ï¼‰

å…³é”®ä¼˜åŠ¿ï¼š
âœ… Tokenä¸ä¼šæš´éœ²åœ¨æµè§ˆå™¨ä¸­
âœ… æˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
âœ… æˆæƒç æœ‰æ—¶æ•ˆæ€§ï¼ˆå‡ åˆ†é’Ÿï¼‰
âœ… éœ€è¦åº”ç”¨å¯†é’¥æ‰èƒ½æ¢Token
```

### 3.2 æˆæƒç æ¨¡å¼å®Œæ•´æµç¨‹


**æµç¨‹å›¾è§£**ï¼š
```
ç”¨æˆ·æµè§ˆå™¨          ç¬¬ä¸‰æ–¹åº”ç”¨          æˆæƒæœåŠ¡å™¨          èµ„æºæœåŠ¡å™¨
     â”‚                  â”‚                  â”‚                  â”‚
     â”‚â”€â”€[1]è®¿é—®åº”ç”¨â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                  â”‚
     â”‚                  â”‚â”€â”€[2]é‡å®šå‘åˆ°æˆæƒâ”€â”€â–¶â”‚                  â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[3]æ˜¾ç¤ºæˆæƒé¡µé¢â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚â”€â”€[4]ç”¨æˆ·ç¡®è®¤æˆæƒâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[5]è¿”å›æˆæƒç â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚â”€â”€[6]æäº¤æˆæƒç â”€â”€â”€â”€â”€â–¶â”‚                  â”‚                  â”‚
     â”‚                  â”‚â”€â”€[7]æˆæƒç æ¢Tokenâ”€â”€â–¶â”‚                  â”‚
     â”‚                  â”‚â—€â”€[8]è¿”å›Tokenâ”€â”€â”€â”€â”€â”€â”‚                  â”‚
     â”‚                  â”‚â”€â”€[9]ä½¿ç”¨Tokenè®¿é—®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                  â”‚â—€â”€[10]è¿”å›ç”¨æˆ·ä¿¡æ¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚â—€â”€[11]ç™»å½•æˆåŠŸâ”€â”€â”€â”€â”€â”‚                  â”‚                  â”‚
```

### 3.3 å…³é”®æ­¥éª¤è¯¦è§£


**ğŸ”¸ æ­¥éª¤1-2ï¼šå‘èµ·æˆæƒè¯·æ±‚**
```
ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•" â†’ åº”ç”¨é‡å®šå‘åˆ°å¾®ä¿¡æˆæƒé¡µé¢

é‡å®šå‘URLç¤ºä¾‹ï¼š
https://open.weixin.qq.com/connect/oauth2/authorize?
  appid=ä½ çš„åº”ç”¨ID&
  redirect_uri=https://yourapp.com/callback&
  response_type=code&
  scope=snsapi_userinfo&
  state=éšæœºå­—ç¬¦ä¸²
```

**å‚æ•°å«ä¹‰**ï¼š
- `appid`ï¼šåº”ç”¨IDï¼ˆå‘Šè¯‰å¾®ä¿¡æ˜¯å“ªä¸ªåº”ç”¨ï¼‰
- `redirect_uri`ï¼šæˆæƒåçš„å›è°ƒåœ°å€ï¼ˆå¿…é¡»æå‰åœ¨å¾®ä¿¡é…ç½®ï¼‰
- `response_type=code`ï¼šå‘Šè¯‰å¾®ä¿¡è¿”å›æˆæƒç 
- `scope`ï¼šæƒé™èŒƒå›´ï¼ˆè¦è·å–ä»€ä¹ˆä¿¡æ¯ï¼‰
- `state`ï¼šé˜²CSRFæ”»å‡»çš„éšæœºå­—ç¬¦ä¸²

**ğŸ”¸ æ­¥éª¤3-5ï¼šç”¨æˆ·æˆæƒ**
```
å¾®ä¿¡æ˜¾ç¤ºæˆæƒé¡µé¢ â†’ ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æˆæƒ" â†’ å¾®ä¿¡è¿”å›æˆæƒç 

å›è°ƒURLç¤ºä¾‹ï¼š
https://yourapp.com/callback?code=æˆæƒç &state=ä¹‹å‰çš„éšæœºå­—ç¬¦ä¸²
```

**ğŸ”¸ æ­¥éª¤6-8ï¼šæˆæƒç æ¢Token**
```java
// åº”ç”¨æœåŠ¡å™¨æ”¶åˆ°æˆæƒç åï¼Œç”¨æˆæƒç æ¢Token
@GetMapping("/callback")
public String handleCallback(@RequestParam String code, @RequestParam String state) {
    // 1. éªŒè¯stateé˜²æ­¢CSRFæ”»å‡»
    if (!isValidState(state)) {
        throw new SecurityException("Invalid state");
    }
    
    // 2. ç”¨æˆæƒç æ¢å–è®¿é—®Token
    String tokenUrl = "https://api.weixin.qq.com/sns/oauth2/access_token?" +
            "appid=" + APP_ID +
            "&secret=" + APP_SECRET +  // åº”ç”¨å¯†é’¥ï¼Œåªæœ‰æœåŠ¡å™¨çŸ¥é“
            "&code=" + code +
            "&grant_type=authorization_code";
    
    TokenResponse tokenResponse = restTemplate.getForObject(tokenUrl, TokenResponse.class);
    
    // 3. ä½¿ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
    String userInfoUrl = "https://api.weixin.qq.com/sns/userinfo?" +
            "access_token=" + tokenResponse.getAccessToken() +
            "&openid=" + tokenResponse.getOpenId();
    
    UserInfo userInfo = restTemplate.getForObject(userInfoUrl, UserInfo.class);
    
    // 4. åˆ›å»ºç”¨æˆ·ä¼šè¯
    return createUserSession(userInfo);
}
```

### 3.4 PKCEå¢å¼ºå®‰å…¨æ€§


**ä»€ä¹ˆæ˜¯PKCE**ï¼šProof Key for Code Exchangeï¼ˆæˆæƒç äº¤æ¢éªŒè¯å¯†é’¥ï¼‰

**è§£å†³çš„é—®é¢˜**ï¼šé˜²æ­¢æˆæƒç è¢«æ‹¦æˆªåæ¶æ„ä½¿ç”¨

**å·¥ä½œåŸç†**ï¼š
```
1. åº”ç”¨ç”Ÿæˆéšæœºå­—ç¬¦ä¸² code_verifier
2. è®¡ç®— code_challenge = SHA256(code_verifier)
3. æˆæƒæ—¶å‘é€ code_challenge
4. æ¢Tokenæ—¶å‘é€ code_verifier
5. æˆæƒæœåŠ¡å™¨éªŒè¯ SHA256(code_verifier) == code_challenge
```

---

## 4. ğŸŒ ç¬¬ä¸‰æ–¹ç™»å½•å®è·µ


### 4.1 å¸¸è§ç¬¬ä¸‰æ–¹å¹³å°å¯¹æ¯”


| å¹³å° | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **ç”¨æˆ·ç¾¤ä½“** |
|------|---------|-------------|-------------|
| ğŸ”¸ **å¾®ä¿¡** | `ç§»åŠ¨ç«¯ä¸»æµï¼Œç”¨æˆ·åŸºæ•°å¤§` | `ç§»åŠ¨Appã€å°ç¨‹åº` | `å›½å†…ç”¨æˆ·` |
| ğŸ”¸ **QQ** | `PCç«¯è¾ƒå¤šï¼Œå¹´è½»ç”¨æˆ·` | `æ¸¸æˆã€ç¤¾äº¤åº”ç”¨` | `å¹´è½»ç¾¤ä½“` |
| ğŸ”¸ **æ”¯ä»˜å®** | `æ”¯ä»˜åœºæ™¯ï¼Œä¿¡ä»»åº¦é«˜` | `ç”µå•†ã€é‡‘èåº”ç”¨` | `æ¶ˆè´¹ç”¨æˆ·` |
| ğŸ”¸ **GitHub** | `å¼€å‘è€…èšé›†ï¼ŒæŠ€æœ¯å±æ€§å¼º` | `æŠ€æœ¯ç¤¾åŒºã€å¼€å‘å·¥å…·` | `ç¨‹åºå‘˜` |
| ğŸ”¸ **é’‰é’‰** | `ä¼ä¸šåŠå…¬ï¼ŒBç«¯åº”ç”¨` | `ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ` | `ä¼ä¸šç”¨æˆ·` |

### 4.2 å¾®ä¿¡ç™»å½•å®Œæ•´å®ç°


**ğŸ”¸ å‰ç«¯å‘èµ·æˆæƒ**
```javascript
// æ„å»ºå¾®ä¿¡æˆæƒé“¾æ¥
function loginWithWeChat() {
    const state = generateRandomString(); // ç”Ÿæˆéšæœºstate
    localStorage.setItem('oauth_state', state); // ä¿å­˜stateç”¨äºéªŒè¯
    
    const authUrl = 'https://open.weixin.qq.com/connect/qrconnect?' +
        'appid=' + WX_APP_ID +
        '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
        '&response_type=code' +
        '&scope=snsapi_login' +
        '&state=' + state;
    
    window.location.href = authUrl; // è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
}
```

**ğŸ”¸ åç«¯å¤„ç†å›è°ƒ**
```java
@RestController
public class OAuthController {
    
    @GetMapping("/auth/wechat/callback")
    public ResponseEntity<?> wechatCallback(
            @RequestParam String code,
            @RequestParam String state) {
        
        try {
            // 1. éªŒè¯stateé˜²CSRF
            if (!oauthService.validateState(state)) {
                return ResponseEntity.badRequest().body("Invalid state");
            }
            
            // 2. è·å–è®¿é—®ä»¤ç‰Œ
            WeChatTokenResponse tokenResponse = wechatService.getAccessToken(code);
            
            // 3. è·å–ç”¨æˆ·ä¿¡æ¯
            WeChatUserInfo userInfo = wechatService.getUserInfo(
                tokenResponse.getAccessToken(), 
                tokenResponse.getOpenid()
            );
            
            // 4. åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
            User user = userService.createOrUpdateUser(userInfo);
            
            // 5. ç”ŸæˆJWT Token
            String jwtToken = jwtService.generateToken(user);
            
            return ResponseEntity.ok(new LoginResponse(jwtToken, user));
            
        } catch (Exception e) {
            return ResponseEntity.status(500).body("Login failed: " + e.getMessage());
        }
    }
}
```

### 4.3 GitHubç™»å½•å®ç°


**GitHubæˆæƒæµç¨‹**ï¼š
```java
@Service
public class GitHubOAuthService {
    
    // è·å–GitHubè®¿é—®ä»¤ç‰Œ
    public GitHubTokenResponse getAccessToken(String code) {
        String tokenUrl = "https://github.com/login/oauth/access_token";
        
        Map<String, String> params = new HashMap<>();
        params.put("client_id", GITHUB_CLIENT_ID);
        params.put("client_secret", GITHUB_CLIENT_SECRET);
        params.put("code", code);
        
        // GitHubè¦æ±‚Acceptå¤´ä¸ºapplication/json
        HttpHeaders headers = new HttpHeaders();
        headers.set("Accept", "application/json");
        
        HttpEntity<Map<String, String>> request = new HttpEntity<>(params, headers);
        
        return restTemplate.postForObject(tokenUrl, request, GitHubTokenResponse.class);
    }
    
    // è·å–GitHubç”¨æˆ·ä¿¡æ¯
    public GitHubUserInfo getUserInfo(String accessToken) {
        String userUrl = "https://api.github.com/user";
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "token " + accessToken);
        headers.set("User-Agent", "YourApp"); // GitHubè¦æ±‚User-Agent
        
        HttpEntity<String> request = new HttpEntity<>(headers);
        
        return restTemplate.exchange(userUrl, HttpMethod.GET, request, GitHubUserInfo.class).getBody();
    }
}
```

### 4.4 å¤šå¹³å°ç™»å½•ç»Ÿä¸€å¤„ç†


**ç»Ÿä¸€ç”¨æˆ·æ¨¡å‹**ï¼š
```java
@Entity
public class User {
    private Long id;
    private String username;
    private String email;
    private String avatar;
    
    // ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®š
    private String wechatOpenId;
    private String qqOpenId;
    private String githubId;
    private String alipayUserId;
}

@Service
public class SocialLoginService {
    
    public User handleSocialLogin(SocialUserInfo socialUserInfo, SocialPlatform platform) {
        // 1. æ ¹æ®ç¬¬ä¸‰æ–¹IDæŸ¥æ‰¾å·²æœ‰ç”¨æˆ·
        User existingUser = findUserBySocialId(socialUserInfo.getId(), platform);
        
        if (existingUser != null) {
            // 2. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            updateUserInfo(existingUser, socialUserInfo);
            return existingUser;
        }
        
        // 3. åˆ›å»ºæ–°ç”¨æˆ·
        User newUser = new User();
        newUser.setUsername(socialUserInfo.getNickname());
        newUser.setEmail(socialUserInfo.getEmail());
        newUser.setAvatar(socialUserInfo.getAvatar());
        
        // 4. ç»‘å®šç¬¬ä¸‰æ–¹è´¦å·
        bindSocialAccount(newUser, socialUserInfo.getId(), platform);
        
        return userRepository.save(newUser);
    }
}
```

---

## 5. ğŸ›¡ï¸ OAuth2å®‰å…¨é—®é¢˜ä¸é˜²æŠ¤


### 5.1 å¸¸è§å®‰å…¨å¨èƒ


**ğŸ”¸ æˆæƒç æ³„éœ²é£é™©**

**å¨èƒåœºæ™¯**ï¼š
```
æ”»å‡»è€…é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æˆæƒç ï¼š
âŒ ç›‘å¬ç½‘ç»œæµé‡
âŒ æµè§ˆå™¨å†å²è®°å½•
âŒ æœåŠ¡å™¨æ—¥å¿—æ³„éœ²
âŒ é‡å®šå‘URIåŠ«æŒ
```

**é˜²æŠ¤æªæ–½**ï¼š
```java
// 1. HTTPSå¼ºåˆ¶ä½¿ç”¨
@Configuration
public class SecurityConfig {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.requiresChannel(channel -> 
            channel.anyRequest().requiresSecure()); // å¼ºåˆ¶HTTPS
        return http.build();
    }
}

// 2. æˆæƒç çŸ­æ—¶æœ‰æ•ˆ
@Component
public class AuthCodeService {
    private static final int CODE_EXPIRE_MINUTES = 5; // 5åˆ†é’Ÿè¿‡æœŸ
    
    public boolean isCodeValid(String code, LocalDateTime issuedAt) {
        return issuedAt.plusMinutes(CODE_EXPIRE_MINUTES).isAfter(LocalDateTime.now());
    }
}

// 3. ä¸€æ¬¡æ€§ä½¿ç”¨
@Service
public class AuthCodeValidator {
    private Set<String> usedCodes = new ConcurrentHashMap<>();
    
    public boolean validateAndMarkUsed(String code) {
        return usedCodes.add(code); // å¦‚æœå·²å­˜åœ¨è¿”å›false
    }
}
```

**ğŸ”¸ CSRFæ”»å‡»é˜²æŠ¤**

**æ”»å‡»åŸç†**ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·è®¿é—®æ¶æ„é“¾æ¥ï¼Œè‡ªåŠ¨å®Œæˆæˆæƒæµç¨‹

**Stateå‚æ•°é˜²æŠ¤**ï¼š
```java
@Service
public class CSRFProtectionService {
    
    // ç”Ÿæˆstateå‚æ•°
    public String generateState(HttpSession session) {
        String state = UUID.randomUUID().toString();
        session.setAttribute("oauth_state", state);
        return state;
    }
    
    // éªŒè¯stateå‚æ•°
    public boolean validateState(String receivedState, HttpSession session) {
        String storedState = (String) session.getAttribute("oauth_state");
        session.removeAttribute("oauth_state"); // ä¸€æ¬¡æ€§ä½¿ç”¨
        
        return storedState != null && storedState.equals(receivedState);
    }
}
```

**ğŸ”¸ é‡å®šå‘URIæ”»å‡»**

**æ”»å‡»æ–¹å¼**ï¼šæ”»å‡»è€…ä¿®æ”¹redirect_uriå‚æ•°ï¼Œå°†æˆæƒç å‘é€åˆ°æ¶æ„æœåŠ¡å™¨

**é˜²æŠ¤æªæ–½**ï¼š
```java
@Component
public class RedirectURIValidator {
    
    // é¢„æ³¨å†Œçš„åˆæ³•å›è°ƒåœ°å€
    private final Set<String> allowedRedirectURIs = Set.of(
        "https://yourapp.com/auth/callback",
        "https://yourapp.com/login/oauth/callback"
    );
    
    public boolean isValidRedirectURI(String redirectUri) {
        if (redirectUri == null) return false;
        
        // 1. ç²¾ç¡®åŒ¹é…
        if (allowedRedirectURIs.contains(redirectUri)) {
            return true;
        }
        
        // 2. å­è·¯å¾„åŒ¹é…ï¼ˆå¯é€‰ï¼‰
        return allowedRedirectURIs.stream()
                .anyMatch(allowed -> redirectUri.startsWith(allowed + "/"));
    }
}
```

### 5.2 Tokenå®‰å…¨ç®¡ç†


**ğŸ”¸ çŸ­æœŸToken + åˆ·æ–°æœºåˆ¶**

```java
@Service
public class TokenService {
    
    private static final int ACCESS_TOKEN_EXPIRE_MINUTES = 30;  // 30åˆ†é’Ÿ
    private static final int REFRESH_TOKEN_EXPIRE_DAYS = 30;    // 30å¤©
    
    public TokenPair generateTokens(User user) {
        // è®¿é—®Tokenï¼šçŸ­æœŸæœ‰æ•ˆ
        String accessToken = generateJWT(user, ACCESS_TOKEN_EXPIRE_MINUTES);
        
        // åˆ·æ–°Tokenï¼šé•¿æœŸæœ‰æ•ˆï¼Œç”¨äºè·å–æ–°çš„è®¿é—®Token
        String refreshToken = generateRefreshToken(user.getId());
        
        return new TokenPair(accessToken, refreshToken);
    }
    
    public String refreshAccessToken(String refreshToken) {
        // 1. éªŒè¯åˆ·æ–°Token
        if (!isValidRefreshToken(refreshToken)) {
            throw new InvalidTokenException("Invalid refresh token");
        }
        
        // 2. è·å–ç”¨æˆ·ä¿¡æ¯
        Long userId = getUserIdFromRefreshToken(refreshToken);
        User user = userService.findById(userId);
        
        // 3. ç”Ÿæˆæ–°çš„è®¿é—®Token
        return generateJWT(user, ACCESS_TOKEN_EXPIRE_MINUTES);
    }
}
```

**ğŸ”¸ Tokenå­˜å‚¨å®‰å…¨**

```javascript
// å‰ç«¯Tokenå®‰å…¨å­˜å‚¨
class TokenManager {
    constructor() {
        this.ACCESS_TOKEN_KEY = 'access_token';
        this.REFRESH_TOKEN_KEY = 'refresh_token';
    }
    
    // å­˜å‚¨Tokenï¼ˆä½¿ç”¨httpOnly cookieæ›´å®‰å…¨ï¼‰
    setTokens(accessToken, refreshToken) {
        // è®¿é—®Tokenå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆæœ€å®‰å…¨ï¼‰
        this.accessToken = accessToken;
        
        // åˆ·æ–°Tokenå­˜å‚¨åœ¨httpOnly cookieä¸­
        document.cookie = `${this.REFRESH_TOKEN_KEY}=${refreshToken}; ` +
                         `path=/; secure; httpOnly; samesite=strict`;
    }
    
    // è‡ªåŠ¨åˆ·æ–°Token
    async refreshTokenIfNeeded() {
        if (this.isTokenExpiringSoon(this.accessToken)) {
            try {
                const response = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    credentials: 'include' // åŒ…å«cookie
                });
                
                const data = await response.json();
                this.accessToken = data.accessToken;
            } catch (error) {
                this.logout(); // åˆ·æ–°å¤±è´¥ï¼Œå¼ºåˆ¶ç™»å‡º
            }
        }
    }
}
```

### 5.3 Scopeæƒé™æ§åˆ¶


**æƒé™èŒƒå›´ç®¡ç†**ï¼š
```java
@Component
public class ScopeValidator {
    
    // å®šä¹‰æƒé™èŒƒå›´
    public enum Scope {
        READ_BASIC("read:basic", "è¯»å–åŸºæœ¬ä¿¡æ¯"),
        READ_EMAIL("read:email", "è¯»å–é‚®ç®±åœ°å€"),
        READ_PROFILE("read:profile", "è¯»å–è¯¦ç»†èµ„æ–™"),
        WRITE_POST("write:post", "å‘å¸ƒå†…å®¹");
        
        private final String value;
        private final String description;
    }
    
    // éªŒè¯è¯·æ±‚çš„æƒé™èŒƒå›´
    public boolean validateScopes(String requestedScopes, String allowedScopes) {
        Set<String> requested = Set.of(requestedScopes.split(" "));
        Set<String> allowed = Set.of(allowedScopes.split(" "));
        
        return allowed.containsAll(requested);
    }
    
    // æ ¹æ®scopeè¿”å›å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
    public UserInfoResponse getUserInfoByScope(User user, String scopes) {
        UserInfoResponse response = new UserInfoResponse();
        Set<String> scopeSet = Set.of(scopes.split(" "));
        
        if (scopeSet.contains("read:basic")) {
            response.setId(user.getId());
            response.setUsername(user.getUsername());
        }
        
        if (scopeSet.contains("read:email")) {
            response.setEmail(user.getEmail());
        }
        
        if (scopeSet.contains("read:profile")) {
            response.setAvatar(user.getAvatar());
            response.setBio(user.getBio());
        }
        
        return response;
    }
}
```

---

## 6. ğŸ”— OpenID Connectæ‰©å±•


### 6.1 ä»€ä¹ˆæ˜¯OpenID Connect


**ç®€å•ç†è§£**ï¼šOpenID Connect (OIDC) = OAuth2 + èº«ä»½è®¤è¯

```
OAuth2ï¼šè§£å†³æˆæƒé—®é¢˜ï¼ˆ"æˆ‘èƒ½è®¿é—®ä»€ä¹ˆèµ„æºï¼Ÿ"ï¼‰
OIDCï¼šè§£å†³è®¤è¯é—®é¢˜ï¼ˆ"æˆ‘æ˜¯è°ï¼Ÿ"ï¼‰

OAuth2ï¼šè·å¾—è®¿é—®Tokenï¼Œç”¨æ¥è°ƒç”¨API
OIDCï¼šé¢å¤–è·å¾—ID Tokenï¼ŒåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **ID Token**ï¼šåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„JWT
- **UserInfoç«¯ç‚¹**ï¼šè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„API
- **å‘ç°æ–‡æ¡£**ï¼šè‡ªåŠ¨é…ç½®OIDCå®¢æˆ·ç«¯çš„å…ƒæ•°æ®

### 6.2 ID Tokenè§£æ


**ID Tokenç»“æ„**ï¼š
```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "iss": "https://accounts.google.com",        // é¢å‘è€…
    "sub": "ç”¨æˆ·å”¯ä¸€æ ‡è¯†",                        // ä¸»ä½“
    "aud": "ä½ çš„åº”ç”¨ID",                         // å—ä¼—
    "exp": 1234567890,                          // è¿‡æœŸæ—¶é—´
    "iat": 1234567890,                          // é¢å‘æ—¶é—´
    "name": "å¼ ä¸‰",                             // ç”¨æˆ·å§“å
    "email": "zhangsan@example.com",            // é‚®ç®±
    "picture": "https://example.com/avatar.jpg" // å¤´åƒ
  }
}
```

**ID TokenéªŒè¯**ï¼š
```java
@Service
public class IDTokenValidator {
    
    public Claims validateIDToken(String idToken, String expectedAudience) {
        try {
            // 1. è§£æJWT
            Claims claims = Jwts.parserBuilder()
                    .setSigningKey(getPublicKey()) // è·å–OIDCæä¾›å•†çš„å…¬é’¥
                    .build()
                    .parseClaimsJws(idToken)
                    .getBody();
            
            // 2. éªŒè¯å—ä¼—
            if (!expectedAudience.equals(claims.getAudience())) {
                throw new SecurityException("Invalid audience");
            }
            
            // 3. éªŒè¯è¿‡æœŸæ—¶é—´
            if (claims.getExpiration().before(new Date())) {
                throw new SecurityException("Token expired");
            }
            
            // 4. éªŒè¯é¢å‘è€…
            if (!TRUSTED_ISSUERS.contains(claims.getIssuer())) {
                throw new SecurityException("Untrusted issuer");
            }
            
            return claims;
            
        } catch (JwtException e) {
            throw new SecurityException("Invalid ID token", e);
        }
    }
}
```

### 6.3 å‘ç°æ–‡æ¡£ä¸è‡ªåŠ¨é…ç½®


**å‘ç°æ–‡æ¡£ç¤ºä¾‹**ï¼š
```json
{
  "issuer": "https://accounts.google.com",
  "authorization_endpoint": "https://accounts.google.com/oauth2/auth",
  "token_endpoint": "https://oauth2.googleapis.com/token",
  "userinfo_endpoint": "https://openidconnect.googleapis.com/v1/userinfo",
  "jwks_uri": "https://www.googleapis.com/oauth2/v3/certs",
  "response_types_supported": ["code", "token", "id_token"],
  "scopes_supported": ["openid", "email", "profile"]
}
```

**è‡ªåŠ¨é…ç½®å®ç°**ï¼š
```java
@Configuration
public class OIDCAutoConfig {
    
    @Value("${oidc.issuer}")
    private String issuer;
    
    @Bean
    public OIDCConfiguration loadOIDCConfiguration() {
        String discoveryUrl = issuer + "/.well-known/openid-configuration";
        
        RestTemplate restTemplate = new RestTemplate();
        OIDCConfiguration config = restTemplate.getForObject(discoveryUrl, OIDCConfiguration.class);
        
        return config;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ OAuth2æœ¬è´¨ï¼šæˆæƒæ¡†æ¶ï¼Œè®©ç”¨æˆ·å®‰å…¨æˆæƒç¬¬ä¸‰æ–¹è®¿é—®èµ„æº
ğŸ”¸ å››ç§æ¨¡å¼ï¼šæˆæƒç ï¼ˆæœ€å®‰å…¨ï¼‰ã€éšå¼ã€å¯†ç ã€å®¢æˆ·ç«¯
ğŸ”¸ å…³é”®è§’è‰²ï¼šç”¨æˆ·ã€ç¬¬ä¸‰æ–¹åº”ç”¨ã€æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨
ğŸ”¸ å®‰å…¨æœºåˆ¶ï¼šä¸¤æ­¥éªŒè¯ã€HTTPSã€çŸ­æœŸTokenã€stateé˜²CSRF
ğŸ”¸ å®é™…åº”ç”¨ï¼šå¾®ä¿¡/GitHub/QQç­‰ç¬¬ä¸‰æ–¹ç™»å½•
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆOAuth2æ¯”ä¼ ç»Ÿç™»å½•å®‰å…¨**
```
ä¼ ç»Ÿæ–¹å¼ï¼šç”¨æˆ·æŠŠå¯†ç ç»™ç¬¬ä¸‰æ–¹åº”ç”¨
OAuth2æ–¹å¼ï¼šç”¨æˆ·åªåœ¨å®˜æ–¹é¡µé¢è¾“å…¥å¯†ç ï¼Œç¬¬ä¸‰æ–¹è·å¾—ä¸´æ—¶Token

å®‰å…¨ä¼˜åŠ¿ï¼š
âœ… å¯†ç ä¸æ³„éœ²
âœ… æƒé™å¯æ§åˆ¶
âœ… æˆæƒå¯æ’¤é”€
âœ… Tokenæœ‰æ—¶æ•ˆ
```

**ğŸ”¹ æˆæƒç æ¨¡å¼ä¸ºä»€ä¹ˆæœ€å®‰å…¨**
```
ä¸¤æ­¥éªŒè¯æœºåˆ¶ï¼š
1. æµè§ˆå™¨è·å¾—æˆæƒç ï¼ˆä¸´æ—¶ã€ä¸€æ¬¡æ€§ï¼‰
2. æœåŠ¡å™¨ç”¨æˆæƒç +å¯†é’¥æ¢Tokenï¼ˆå®‰å…¨ï¼‰

å…³é”®ä¿æŠ¤ï¼š
- Tokenä¸æš´éœ²åœ¨æµè§ˆå™¨
- éœ€è¦åº”ç”¨å¯†é’¥æ‰èƒ½æ¢Token
- æˆæƒç çŸ­æ—¶æœ‰æ•ˆä¸”ä¸€æ¬¡æ€§
```

**ğŸ”¹ å¸¸è§å®‰å…¨å¨èƒä¸é˜²æŠ¤**
```
CSRFæ”»å‡» â†’ stateå‚æ•°é˜²æŠ¤
é‡å®šå‘åŠ«æŒ â†’ é¢„æ³¨å†Œå›è°ƒåœ°å€
æˆæƒç æ³„éœ² â†’ HTTPS + çŸ­æ—¶æ•ˆ + ä¸€æ¬¡æ€§
Tokenæ»¥ç”¨ â†’ çŸ­æœŸToken + åˆ·æ–°æœºåˆ¶
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ æŠ€æœ¯é€‰å‹å»ºè®®**
```
æœ‰åç«¯åº”ç”¨ â†’ æˆæƒç æ¨¡å¼ï¼ˆå¼ºçƒˆæ¨èï¼‰
çº¯å‰ç«¯åº”ç”¨ â†’ éšå¼æ¨¡å¼ + PKCEå¢å¼º
ä¼ä¸šå†…éƒ¨ â†’ å¯è€ƒè™‘å¯†ç æ¨¡å¼
æœåŠ¡é—´è°ƒç”¨ â†’ å®¢æˆ·ç«¯æ¨¡å¼
```

**ğŸ”¸ å®‰å…¨é…ç½®æ¸…å•**
```
âœ… å¼ºåˆ¶HTTPSä¼ è¾“
âœ… é¢„æ³¨å†Œå›è°ƒåœ°å€
âœ… ä½¿ç”¨stateå‚æ•°é˜²CSRF
âœ… TokençŸ­æ—¶æœ‰æ•ˆ
âœ… å®æ–½æƒé™èŒƒå›´æ§åˆ¶
âœ… å®‰å…¨å­˜å‚¨åº”ç”¨å¯†é’¥
âœ… å®šæœŸè½®æ¢å¯†é’¥
âœ… ç›‘æ§å¼‚å¸¸æˆæƒè¡Œä¸º
```

**ğŸ”¸ ç¬¬ä¸‰æ–¹å¹³å°é€‰æ‹©**
```
å›½å†…Cç«¯åº”ç”¨ï¼šå¾®ä¿¡ > QQ > æ”¯ä»˜å®
å›½å†…Bç«¯åº”ç”¨ï¼šé’‰é’‰ > ä¼ä¸šå¾®ä¿¡
å›½é™…åŒ–åº”ç”¨ï¼šGoogle > GitHub > Facebook
å¼€å‘è€…ç¤¾åŒºï¼šGitHub > GitLab
```

### 7.4 æœ€ä½³å®è·µ


```
ğŸ”§ å¼€å‘å®è·µï¼š
- ç»Ÿä¸€å°è£…OAuthå®¢æˆ·ç«¯
- å®ç°å¤šå¹³å°ç™»å½•é€‚é…å™¨
- å»ºç«‹ç”¨æˆ·è´¦å·ç»‘å®šæœºåˆ¶
- è®¾è®¡æƒé™æ˜ å°„è§„åˆ™

ğŸ›¡ï¸ å®‰å…¨å®è·µï¼š
- å®šæœŸæ£€æŸ¥æˆæƒåº”ç”¨
- ç›‘æ§Tokenä½¿ç”¨æƒ…å†µ
- å®æ–½å¼‚å¸¸æ£€æµ‹å‘Šè­¦
- å»ºç«‹åº”æ€¥å“åº”æœºåˆ¶

ğŸ“Š è¿ç»´å®è·µï¼š
- ç›‘æ§æˆæƒæˆåŠŸç‡
- åˆ†æç”¨æˆ·ç™»å½•åå¥½
- ä¼˜åŒ–æˆæƒæµç¨‹ä½“éªŒ
- æ”¶é›†å®‰å…¨äº‹ä»¶æ—¥å¿—
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- OAuth2æ˜¯æˆæƒè€Œéè®¤è¯ï¼Œè§£å†³çš„æ˜¯"èƒ½è®¿é—®ä»€ä¹ˆ"çš„é—®é¢˜
- æˆæƒç æ¨¡å¼é€šè¿‡ä¸¤æ­¥éªŒè¯ç¡®ä¿Tokenå®‰å…¨ï¼Œæ˜¯Webåº”ç”¨çš„é¦–é€‰
- å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒæ˜¯HTTPS + state + çŸ­æœŸToken + æƒé™æ§åˆ¶
- ç¬¬ä¸‰æ–¹ç™»å½•çš„æœ¬è´¨æ˜¯ç”¨OAuth2è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å®Œæˆæ³¨å†Œç™»å½•