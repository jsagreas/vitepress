---
title: 2、基础查询类型详解
---
## 📚 目录

1. [查询类型概述](#1-查询类型概述)
2. [全文搜索查询](#2-全文搜索查询)
3. [精确匹配查询](#3-精确匹配查询)
4. [范围和存在性查询](#4-范围和存在性查询)
5. [模式匹配查询](#5-模式匹配查询)
6. [模糊和高级查询](#6-模糊和高级查询)
7. [实践应用场景](#7-实践应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 查询类型概述


### 1.1 什么是Elasticsearch查询


**简单理解**：就像在图书馆找书一样，Elasticsearch查询就是告诉系统"我要找什么样的数据"

```
传统数据库：SELECT * FROM users WHERE name = '张三'
Elasticsearch：GET /users/_search { "query": { "match": { "name": "张三" } } }

区别：
🔸 数据库：精确查找，要完全匹配
🔸 ES：智能搜索，能理解你的意图
```

### 1.2 查询的两大类别


**🎯 全文搜索查询（Analyzed）**
```
特点：会分析文本，理解语义
场景：搜索文章、评论、描述等文本内容
例子：搜索"苹果手机"能找到"iPhone苹果智能手机"
```

**🎯 精确匹配查询（Not Analyzed）**  
```
特点：完全按照原样匹配
场景：搜索ID、状态、分类等固定值
例子：搜索状态"active"只能找到完全是"active"的记录
```

### 1.3 查询基础结构


**标准查询格式**：
```json
{
  "query": {
    "查询类型": {
      "字段名": "搜索内容"
    }
  }
}
```

**实际示例**：
```json
{
  "query": {
    "match": {
      "title": "手机"
    }
  }
}
```

> 💡 **新手提示**：所有查询都包在`query`里面，就像把搜索条件放在一个盒子里

---

## 2. 📝 全文搜索查询


### 2.1 Match查询 - 最常用的搜索


**🔸 作用**：在文本中找包含关键词的内容，是最智能的搜索方式

**基础用法**：
```json
{
  "query": {
    "match": {
      "title": "苹果手机"
    }
  }
}
```

**工作原理**：
```
用户搜索："苹果手机"
ES处理过程：
1. 分词：["苹果", "手机"] 
2. 搜索：找包含"苹果"或"手机"的文档
3. 评分：包含更多词汇的排名更高

能找到的内容：
✅ "苹果iPhone手机"
✅ "手机推荐苹果品牌" 
✅ "苹果公司新款手机"
❌ "香蕉水果很甜"
```

**常用参数**：
```json
{
  "query": {
    "match": {
      "title": {
        "query": "苹果手机",
        "operator": "and"  // 必须同时包含"苹果"和"手机"
      }
    }
  }
}
```

| 参数 | 作用 | 值 | 说明 |
|------|------|-----|------|
| `operator` | 词汇关系 | `or`/`and` | or=包含任一词，and=包含所有词 |
| `minimum_should_match` | 最少匹配 | `2`或`75%` | 至少匹配几个词或百分比 |

### 2.2 Match_phrase查询 - 短语完整匹配


**🔸 作用**：搜索完整的短语，词汇顺序必须正确

```json
{
  "query": {
    "match_phrase": {
      "content": "机器学习算法"
    }
  }
}
```

**与Match的区别**：
```
Match查询："机器学习算法"
能找到："学习机器相关的算法" ✅

Match_phrase查询："机器学习算法"  
能找到："机器学习算法很复杂" ✅
找不到："学习机器相关的算法" ❌ (顺序不对)
```

**容错设置**：
```json
{
  "query": {
    "match_phrase": {
      "content": {
        "query": "机器学习算法",
        "slop": 1  // 允许词汇间有1个其他词
      }
    }
  }
}
```

> 💡 **使用场景**：搜索品牌名、专业术语、完整句子时用match_phrase

### 2.3 Match_phrase_prefix查询 - 自动补全搜索


**🔸 作用**：实现搜索框的自动补全功能

```json
{
  "query": {
    "match_phrase_prefix": {
      "title": "机器学"
    }
  }
}
```

**能找到的内容**：
```
✅ "机器学习入门"
✅ "机器学习算法" 
✅ "机器学习框架"
❌ "学机器相关"  (顺序不对)
```

### 2.4 Multi_match查询 - 多字段搜索


**🔸 作用**：同时在多个字段中搜索，就像在多个地方找东西

```json
{
  "query": {
    "multi_match": {
      "query": "Python",
      "fields": ["title", "content", "tags"]
    }
  }
}
```

**权重设置**：
```json
{
  "query": {
    "multi_match": {
      "query": "Python编程",
      "fields": ["title^3", "content^1", "tags^2"]
    }
  }
}
```

**权重解释**：
```
title^3：标题匹配权重×3
content^1：内容匹配权重×1 (默认)
tags^2：标签匹配权重×2

结果：标题包含关键词的文档排名最高
```

### 2.5 Query_string查询 - 高级搜索语法


**🔸 作用**：支持类似Google的高级搜索语法

```json
{
  "query": {
    "query_string": {
      "query": "Python AND (教程 OR 入门)",
      "default_field": "content"
    }
  }
}
```

**搜索语法**：
```
AND：必须同时包含    "Python AND 教程"
OR：包含任一个      "Python OR Java"  
NOT：不能包含       "Python NOT 难"
""：完整短语        "Python教程"
*：通配符          "Pyth*"
```

> ⚠️ **注意**：Query_string功能强大但复杂，新手建议先掌握match查询

---

## 3. 🎯 精确匹配查询


### 3.1 Term查询 - 完全精确匹配


**🔸 作用**：像查字典一样，必须完全一致才能找到

```json
{
  "query": {
    "term": {
      "status": "published"
    }
  }
}
```

**精确匹配特点**：
```
搜索："published"
能找到：status字段值完全是"published"的文档 ✅
找不到：status字段值是"Published"的文档 ❌ (大小写不同)
找不到：status字段值是"published!"的文档 ❌ (多了符号)
```

**适用场景**：
- ✅ **状态字段**：`active`、`inactive`、`pending`
- ✅ **分类字段**：`electronics`、`books`、`clothing`  
- ✅ **ID字段**：`user123`、`order456`
- ✅ **布尔字段**：`true`、`false`

### 3.2 Terms查询 - 多值精确匹配


**🔸 作用**：在多个精确值中查找，相当于SQL的IN操作

```json
{
  "query": {
    "terms": {
      "status": ["published", "draft", "review"]
    }
  }
}
```

**等价SQL**：
```sql
SELECT * FROM articles WHERE status IN ('published', 'draft', 'review')
```

**实际应用**：
```json
{
  "query": {
    "terms": {
      "category": ["手机", "电脑", "平板"]
    }
  }
}
```

### 3.3 精确查询注意事项


**🚨 常见错误**：
```json
// ❌ 错误：用term查询分析过的文本字段
{
  "query": {
    "term": {
      "title": "机器学习"  // title是text类型，会被分词
    }
  }
}

// ✅ 正确：用match查询text字段
{
  "query": {
    "match": {
      "title": "机器学习"
    }
  }
}

// ✅ 正确：用term查询keyword字段  
{
  "query": {
    "term": {
      "title.keyword": "机器学习"
    }
  }
}
```

**字段类型对照表**：

| 字段类型 | 推荐查询 | 说明 |
|----------|----------|------|
| `text` | `match` | 会分词，用于全文搜索 |
| `keyword` | `term` | 不分词，用于精确匹配 |
| `integer`/`long` | `term`/`range` | 数字字段 |
| `date` | `range` | 日期字段 |
| `boolean` | `term` | 布尔字段 |

---

## 4. 📊 范围和存在性查询


### 4.1 Range查询 - 范围条件搜索


**🔸 作用**：找在某个范围内的数据，比如价格区间、日期范围

**基础语法**：
```json
{
  "query": {
    "range": {
      "price": {
        "gte": 100,    // 大于等于100
        "lte": 500     // 小于等于500
      }
    }
  }
}
```

**范围操作符**：
```
gte：>= (大于等于)    "价格至少100元"
gt：>  (大于)        "价格超过100元"  
lte：<= (小于等于)    "价格最多500元"
lt：<  (小于)        "价格低于500元"
```

**数字范围示例**：
```json
{
  "query": {
    "range": {
      "age": {
        "gte": 18,
        "lt": 65
      }
    }
  }
}
```

**日期范围示例**：
```json
{
  "query": {
    "range": {
      "publish_date": {
        "gte": "2024-01-01",
        "lte": "2024-12-31"
      }
    }
  }
}
```

**相对日期**：
```json
{
  "query": {
    "range": {
      "timestamp": {
        "gte": "now-7d",      // 7天前
        "lte": "now"          // 现在
      }
    }
  }
}
```

### 4.2 Exists查询 - 字段存在性检查


**🔸 作用**：找有某个字段的文档，相当于SQL的`IS NOT NULL`

```json
{
  "query": {
    "exists": {
      "field": "email"
    }
  }
}
```

**应用场景**：
```
✅ 找有邮箱的用户：exists email
✅ 找有头像的用户：exists avatar  
✅ 找有评分的商品：exists rating
✅ 找有标签的文章：exists tags
```

**与missing的区别**：
```json
// 有email字段的文档
{
  "query": {
    "exists": {
      "field": "email"
    }
  }
}

// 没有email字段的文档 (ES 7.0+用bool must_not)
{
  "query": {
    "bool": {
      "must_not": {
        "exists": {
          "field": "email"
        }
      }
    }
  }
}
```

---

## 5. 🔤 模式匹配查询


### 5.1 Prefix查询 - 前缀匹配


**🔸 作用**：找以某个字符开头的内容，像电话号码归属地查询

```json
{
  "query": {
    "prefix": {
      "phone": "138"
    }
  }
}
```

**应用场景**：
```
电话号码：找138开头的手机号
邮政编码：找100开头的北京地区邮编
商品编码：找IPHONE开头的产品
用户名：找admin开头的管理员账号
```

**性能提示**：
```
✅ 好：prefix查询短前缀 "13"
⚠️ 慢：prefix查询长前缀 "1388888"  
❌ 很慢：prefix查询keyword字段的长文本
```

### 5.2 Wildcard查询 - 通配符匹配


**🔸 作用**：使用通配符进行模糊匹配，类似文件名搜索

```json
{
  "query": {
    "wildcard": {
      "filename": "*.pdf"
    }
  }
}
```

**通配符规则**：
```
*：匹配任意长度字符    "doc*.pdf" → "doc1.pdf", "document.pdf"
?：匹配单个字符       "test?.txt" → "test1.txt", "testa.txt"
```

**实用示例**：
```json
// 找所有Excel文件
{
  "query": {
    "wildcard": {
      "filename": "*.xlsx"
    }
  }
}

// 找编号格式匹配的订单
{
  "query": {
    "wildcard": {
      "order_id": "ORD-2024-*"
    }
  }
}
```

> ⚠️ **性能警告**：通配符查询很慢，特别是以`*`开头的模式

### 5.3 Regexp查询 - 正则表达式匹配


**🔸 作用**：使用正则表达式进行复杂模式匹配

```json
{
  "query": {
    "regexp": {
      "phone": "1[3-9]\\d{9}"
    }
  }
}
```

**常用正则模式**：
```
手机号：1[3-9]\\d{9}
邮箱：[a-zA-Z0-9]+@[a-zA-Z0-9]+\\.[a-zA-Z]{2,}
身份证：\\d{17}[0-9Xx]
IP地址：\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}
```

**实际应用**：
```json
// 验证邮箱格式
{
  "query": {
    "regexp": {
      "email": "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"
    }
  }
}
```

> 🔥 **重要提示**：正则查询性能最差，只在必要时使用

---

## 6. 🌟 模糊和高级查询


### 6.1 Fuzzy查询 - 容错模糊搜索


**🔸 作用**：允许拼写错误的搜索，类似手机输入法的模糊匹配

```json
{
  "query": {
    "fuzzy": {
      "name": {
        "value": "elasticsearch",
        "fuzziness": 2
      }
    }
  }
}
```

**模糊度说明**：
```
fuzziness: 0  完全匹配 "elasticsearch"
fuzziness: 1  允许1个字符差异 "elastcsearch" ✅
fuzziness: 2  允许2个字符差异 "elastisearch" ✅  
fuzziness: AUTO  自动调整 (推荐)
```

**应用场景**：
```
✅ 用户搜索时的拼写错误："elasticsearh" → "elasticsearch"
✅ 姓名搜索的容错："张三" vs "张山"
✅ 产品名称的模糊匹配："Iphone" vs "iPhone"
```

**AUTO模糊度规则**：
```
字符长度 0-2：必须完全匹配
字符长度 3-5：允许1个编辑距离  
字符长度 >5：允许2个编辑距离
```

### 6.2 查询性能对比


**⚡ 性能排行榜（从快到慢）**：

| 排名 | 查询类型 | 性能 | 适用场景 |
|------|----------|------|----------|
| 🥇 | `term` | 最快 | 精确匹配：状态、ID、分类 |
| 🥈 | `range` | 很快 | 数字、日期范围查询 |
| 🥉 | `prefix` | 较快 | 短前缀匹配 |
| 4 | `match` | 一般 | 常规全文搜索 |
| 5 | `wildcard` | 较慢 | 通配符匹配 |
| 6 | `regexp` | 慢 | 复杂正则匹配 |
| 7 | `fuzzy` | 很慢 | 模糊容错搜索 |

**选择建议**：
```
🎯 优先选择：term、range查询（性能最好）
🎯 常用选择：match查询（平衡性能和功能）  
🎯 谨慎使用：wildcard、regexp、fuzzy（性能较差）
```

---

## 7. 🎬 实践应用场景


### 7.1 电商网站搜索实现


**商品搜索功能**：
```json
{
  "query": {
    "bool": {
      "must": [
        {"match": {"title": "手机"}},           // 标题包含手机
        {"term": {"status": "published"}},      // 已发布状态
        {"range": {"price": {"gte": 1000, "lte": 5000}}}  // 价格1000-5000
      ],
      "should": [
        {"match": {"brand": "苹果"}},           // 优先显示苹果品牌
        {"term": {"is_hot": true}}             // 优先显示热销商品
      ]
    }
  }
}
```

### 7.2 用户管理系统


**用户查询组合**：
```json
{
  "query": {
    "bool": {
      "must": [
        {"exists": {"field": "email"}},        // 必须有邮箱
        {"term": {"status": "active"}}         // 激活状态
      ],
      "should": [
        {"prefix": {"phone": "138"}},          // 优先138号段
        {"range": {"age": {"gte": 18, "lte": 35}}}  // 优先18-35岁
      ],
      "must_not": [
        {"term": {"is_banned": true}}          // 排除被封用户
      ]
    }
  }
}
```

### 7.3 日志分析系统


**错误日志搜索**：
```json
{
  "query": {
    "bool": {
      "must": [
        {"match": {"level": "ERROR"}},         // 错误级别
        {"range": {"timestamp": {"gte": "now-24h"}}}  // 最近24小时
      ],
      "should": [
        {"match_phrase": {"message": "数据库连接"}},    // 数据库相关错误
        {"wildcard": {"service": "*payment*"}}        // 支付服务错误
      ]
    }
  }
}
```

### 7.4 内容管理系统


**文章搜索功能**：
```json
{
  "query": {
    "bool": {
      "must": [
        {"multi_match": {
          "query": "机器学习",
          "fields": ["title^3", "content", "tags^2"]
        }},
        {"term": {"status": "published"}}
      ],
      "filter": [
        {"range": {"publish_date": {"gte": "2024-01-01"}}},
        {"terms": {"category": ["技术", "AI", "编程"]}}
      ]
    }
  }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基础查询


**🎯 新手必会三大查询**：
```
1. match查询：全文搜索，最常用
2. term查询：精确匹配，找固定值  
3. range查询：范围搜索，找区间数据
```

### 8.2 查询选择指南


**📊 按使用频率排序**：
```
🔥 超高频：match (60%) - 日常搜索
🔥 高频：term (20%) - 状态、分类查询
🔥 中频：range (10%) - 价格、日期查询
🔥 低频：exists (5%) - 字段存在检查
🔥 偶尔：prefix、wildcard (5%) - 特殊匹配需求
```

### 8.3 字段类型与查询匹配


**🎯 字段类型决定查询方式**：
```
text字段 → 用match系列查询
keyword字段 → 用term系列查询  
数字字段 → 用term或range查询
日期字段 → 用range查询
布尔字段 → 用term查询
```

### 8.4 性能优化要点


**⚡ 查询性能优化原则**：
```
1. 优先使用term、range等精确查询
2. 避免以通配符开头的wildcard查询
3. 谨慎使用regexp和fuzzy查询
4. 合理使用bool查询组合多个条件
5. 利用filter上下文避免计算相关性分数
```

### 8.5 实际应用建议


**🎨 查询设计最佳实践**：
```
✅ 简单场景：单一查询类型
✅ 复杂场景：bool查询组合
✅ 性能敏感：优先filter上下文
✅ 用户搜索：match + 容错处理
✅ 数据筛选：term + range组合
```

**💡 新手学习路径**：
```
第1阶段：掌握match、term、range
第2阶段：学会bool查询组合
第3阶段：了解性能优化技巧
第4阶段：实践复杂业务场景
```

> 🎯 **核心记忆**：match搜文本，term找精确，range查区间，bool组合用。选对查询类型，性能差十倍！