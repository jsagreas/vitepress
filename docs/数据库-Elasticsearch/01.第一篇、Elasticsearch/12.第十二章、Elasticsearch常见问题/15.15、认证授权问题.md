---
title: 15ã€è®¤è¯æˆæƒé—®é¢˜
---
## ğŸ“š ç›®å½•

1. [Elasticsearchå®‰å…¨è®¤è¯æ¦‚è¿°](#1-elasticsearchå®‰å…¨è®¤è¯æ¦‚è¿°)
2. [ç”¨æˆ·è®¤è¯å¤±è´¥é—®é¢˜](#2-ç”¨æˆ·è®¤è¯å¤±è´¥é—®é¢˜)
3. [æƒé™ä¸è¶³é”™è¯¯è¯Šæ–­](#3-æƒé™ä¸è¶³é”™è¯¯è¯Šæ–­)
4. [SSLè¯ä¹¦éªŒè¯é—®é¢˜](#4-sslè¯ä¹¦éªŒè¯é—®é¢˜)
5. [LDAPé›†æˆæ•…éšœæ’æŸ¥](#5-ldapé›†æˆæ•…éšœæ’æŸ¥)
6. [APIå¯†é’¥è®¤è¯é—®é¢˜](#6-apiå¯†é’¥è®¤è¯é—®é¢˜)
7. [SAMLè®¤è¯é…ç½®é—®é¢˜](#7-samlè®¤è¯é…ç½®é—®é¢˜)
8. [è§’è‰²æ˜ å°„é”™è¯¯å¤„ç†](#8-è§’è‰²æ˜ å°„é”™è¯¯å¤„ç†)
9. [åŒ¿åè®¿é—®é…ç½®](#9-åŒ¿åè®¿é—®é…ç½®)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Elasticsearchå®‰å…¨è®¤è¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Elasticsearchå®‰å…¨è®¤è¯


**ç®€å•ç†è§£**ï¼šå°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼Œç¡®ä¿åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½è¿›å…¥å¹¶æ“ä½œæ•°æ®ã€‚

```
Elasticsearchå®‰å…¨ä½“ç³»æ¶æ„ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ è®¤è¯éªŒè¯ â†’ æˆæƒæ£€æŸ¥ â†’ æ“ä½œæ‰§è¡Œ
    â†“         â†“         â†“         â†“
  èº«ä»½ç¡®è®¤   ç”¨æˆ·åˆæ³•æ€§   æƒé™èŒƒå›´   å…·ä½“åŠ¨ä½œ

è®¤è¯(Authentication)ï¼šä½ æ˜¯è°ï¼Ÿ
æˆæƒ(Authorization)ï¼šä½ èƒ½åšä»€ä¹ˆï¼Ÿ
å®¡è®¡(Auditing)ï¼šä½ åšäº†ä»€ä¹ˆï¼Ÿ
```

### 1.2 Elasticsearchå®‰å…¨åŠŸèƒ½ç»„ä»¶


**ğŸ”¸ X-Pack Securityæ ¸å¿ƒåŠŸèƒ½**
```
è®¤è¯æ–¹å¼ï¼š
â€¢ å†…ç½®ç”¨æˆ·è®¤è¯ - ESè‡ªå¸¦çš„ç”¨æˆ·ç®¡ç†
â€¢ LDAP/Active Directory - ä¼ä¸šçº§ç›®å½•æœåŠ¡
â€¢ SAMLå•ç‚¹ç™»å½• - ç¬¬ä¸‰æ–¹èº«ä»½æä¾›è€…
â€¢ APIå¯†é’¥è®¤è¯ - ç¨‹åºåŒ–è®¿é—®
â€¢ PKIè¯ä¹¦è®¤è¯ - åŸºäºè¯ä¹¦çš„è®¤è¯

æˆæƒæ§åˆ¶ï¼š
â€¢ åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
â€¢ ç´¢å¼•çº§æƒé™æ§åˆ¶
â€¢ å­—æ®µçº§æƒé™æ§åˆ¶
â€¢ æ–‡æ¡£çº§æƒé™æ§åˆ¶
```

### 1.3 å®‰å…¨é…ç½®å¯ç”¨


**ğŸ“‹ åŸºç¡€å®‰å…¨é…ç½®**
```yaml
# elasticsearch.yml å®‰å…¨é…ç½®
xpack.security.enabled: true
xpack.security.authc.realms.native.native1.order: 0

# ä¼ è¾“å±‚åŠ å¯†
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.keystore.path: elastic-certificates.p12

# HTTPå±‚åŠ å¯†
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: elastic-certificates.p12
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šé¦–æ¬¡å¯ç”¨å®‰å…¨åŠŸèƒ½æ—¶ï¼ŒElasticsearchä¼šè¦æ±‚è®¾ç½®è¶…çº§ç”¨æˆ·å¯†ç ï¼Œè¿™æ˜¯æœ€é«˜æƒé™è´¦æˆ·ï¼Œè¦å¦¥å–„ä¿ç®¡ã€‚

---

## 2. ğŸ‘¤ ç”¨æˆ·è®¤è¯å¤±è´¥é—®é¢˜


### 2.1 å¸¸è§è®¤è¯å¤±è´¥åœºæ™¯


**ğŸ”¸ ç”¨æˆ·åå¯†ç é”™è¯¯**
```
å…¸å‹é”™è¯¯ä¿¡æ¯ï¼š
{
  "error": {
    "type": "security_exception",
    "reason": "unable to authenticate user [username] for REST request"
  }
}

é—®é¢˜åŸå› ï¼š
â€¢ ç”¨æˆ·åæˆ–å¯†ç è¾“å…¥é”™è¯¯
â€¢ å¯†ç å·²è¿‡æœŸéœ€è¦æ›´æ–°
â€¢ ç”¨æˆ·è´¦æˆ·è¢«ç¦ç”¨
â€¢ è®¤è¯é…ç½®é”™è¯¯
```

### 2.2 è¯Šæ–­æ­¥éª¤


**ğŸ” ç¬¬ä¸€æ­¥ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨**
```bash
# æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
curl -X GET "localhost:9200/_security/user" \
  -H "Authorization: Basic ZWxhc3RpYzpwYXNzd29yZA=="

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·
curl -X GET "localhost:9200/_security/user/myuser"
```

**ğŸ” ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ç”¨æˆ·çŠ¶æ€**
```bash
# æŸ¥çœ‹ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
GET _security/user/myuser

# è¿”å›ç¤ºä¾‹
{
  "myuser": {
    "username": "myuser",
    "roles": ["kibana_user"],
    "full_name": "My User",
    "email": "myuser@example.com",
    "enabled": true  # ç¡®è®¤ç”¨æˆ·å·²å¯ç”¨
  }
}
```

### 2.3 è§£å†³æ–¹æ¡ˆ


**âœ… é‡ç½®ç”¨æˆ·å¯†ç **
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨è¶…çº§ç”¨æˆ·é‡ç½®
curl -X PUT "localhost:9200/_security/user/myuser/_password" \
  -H "Content-Type: application/json" \
  -d '{
    "password": "new_password_123"
  }'

# æ–¹æ³•2ï¼šç”¨æˆ·è‡ªå·±ä¿®æ”¹å¯†ç 
curl -X PUT "localhost:9200/_security/user/myuser/_password" \
  -u myuser:old_password \
  -H "Content-Type: application/json" \
  -d '{
    "password": "new_password_123"
  }'
```

**âœ… å¯ç”¨è¢«ç¦ç”¨çš„ç”¨æˆ·**
```bash
curl -X PUT "localhost:9200/_security/user/myuser" \
  -H "Content-Type: application/json" \
  -d '{
    "enabled": true,
    "roles": ["kibana_user"]
  }'
```

---

## 3. ğŸš« æƒé™ä¸è¶³é”™è¯¯è¯Šæ–­


### 3.1 æƒé™é”™è¯¯ç±»å‹åˆ†æ


**ğŸ”¸ å…¸å‹æƒé™é”™è¯¯**
```
ç´¢å¼•è®¿é—®è¢«æ‹’ç»ï¼š
{
  "error": {
    "type": "security_exception",
    "reason": "action [indices:data/read/search] is unauthorized for user [myuser]"
  }
}

é›†ç¾¤æ“ä½œè¢«æ‹’ç»ï¼š
{
  "error": {
    "type": "security_exception", 
    "reason": "action [cluster:monitor/nodes/info] is unauthorized for user [myuser]"
  }
}
```

### 3.2 æƒé™ä½“ç³»ç†è§£


**ğŸ“Š Elasticsearchæƒé™å±‚çº§**
```
é›†ç¾¤æƒé™ (Cluster Privileges)
â”œâ”€â”€ monitor - æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
â”œâ”€â”€ manage - ç®¡ç†é›†ç¾¤è®¾ç½®  
â”œâ”€â”€ manage_indices - ç®¡ç†æ‰€æœ‰ç´¢å¼•
â””â”€â”€ all - æ‰€æœ‰é›†ç¾¤æƒé™

ç´¢å¼•æƒé™ (Index Privileges)  
â”œâ”€â”€ read - è¯»å–æ–‡æ¡£å’Œå…ƒæ•°æ®
â”œâ”€â”€ write - å†™å…¥ã€æ›´æ–°ã€åˆ é™¤æ–‡æ¡£
â”œâ”€â”€ create - åˆ›å»ºæ–‡æ¡£å’Œç´¢å¼•
â”œâ”€â”€ index - ç´¢å¼•æ–‡æ¡£
â”œâ”€â”€ delete - åˆ é™¤æ–‡æ¡£
â”œâ”€â”€ manage - ç®¡ç†ç´¢å¼•è®¾ç½®
â””â”€â”€ all - æ‰€æœ‰ç´¢å¼•æƒé™

ç‰¹æ®Šæƒé™ï¼š
â”œâ”€â”€ run_as - ä»£ç†å…¶ä»–ç”¨æˆ·æ‰§è¡Œ
â”œâ”€â”€ kibana_admin - Kibanaç®¡ç†
â””â”€â”€ superuser - è¶…çº§ç”¨æˆ·æƒé™
```

### 3.3 æƒé™è¯Šæ–­æ–¹æ³•


**ğŸ” æ£€æŸ¥ç”¨æˆ·è§’è‰²**
```bash
# æŸ¥çœ‹ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
GET _security/user/myuser

# æŸ¥çœ‹è§’è‰²è¯¦ç»†æƒé™
GET _security/role/my_role

# ç¤ºä¾‹è¿”å›
{
  "my_role": {
    "cluster": ["monitor"],
    "indices": [
      {
        "names": ["logs-*"],
        "privileges": ["read", "view_index_metadata"]
      }
    ]
  }
}
```

**ğŸ” éªŒè¯å…·ä½“æƒé™**
```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
POST _security/user/_has_privileges
{
  "user": "myuser",
  "cluster": ["monitor"],
  "index": [
    {
      "names": ["my-index"],
      "privileges": ["read"]
    }
  ]
}
```

### 3.4 æƒé™é—®é¢˜è§£å†³


**âœ… ä¿®æ”¹ç”¨æˆ·è§’è‰²**
```bash
# ç»™ç”¨æˆ·æ·»åŠ æ›´å¤šè§’è‰²
PUT _security/user/myuser
{
  "roles": ["kibana_user", "monitoring_user", "my_custom_role"]
}
```

**âœ… åˆ›å»ºè‡ªå®šä¹‰è§’è‰²**
```bash
PUT _security/role/data_analyst
{
  "cluster": ["monitor"],
  "indices": [
    {
      "names": ["sales-*", "marketing-*"],
      "privileges": ["read", "view_index_metadata"]
    }
  ]
}
```

---

## 4. ğŸ”’ SSLè¯ä¹¦éªŒè¯é—®é¢˜


### 4.1 SSLè¯ä¹¦é”™è¯¯ç±»å‹


**ğŸ”¸ å¸¸è§SSLé”™è¯¯**
```
è¯ä¹¦è¿‡æœŸé”™è¯¯ï¼š
javax.net.ssl.SSLHandshakeException: 
sun.security.validator.ValidatorException: 
PKIX path validation failed: 
java.security.cert.CertPathValidatorException: validity check failed

è¯ä¹¦ä¸åŒ¹é…é”™è¯¯ï¼š
javax.net.ssl.SSLPeerUnverifiedException: 
peer not authenticated

è¯ä¹¦é“¾éªŒè¯å¤±è´¥ï¼š
sun.security.provider.certpath.SunCertPathBuilderException: 
unable to find valid certification path to requested target
```

### 4.2 SSLé…ç½®æ£€æŸ¥


**ğŸ” æ£€æŸ¥è¯ä¹¦çŠ¶æ€**
```bash
# æŸ¥çœ‹é›†ç¾¤SSLä¿¡æ¯
GET _ssl/certificates

# ä½¿ç”¨opensslæ£€æŸ¥è¯ä¹¦
openssl x509 -in elastic-certificates.crt -text -noout

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in elastic-certificates.crt -dates -noout
```

**ğŸ” éªŒè¯SSLè¿æ¥**
```bash
# æµ‹è¯•SSLè¿æ¥
curl -k -X GET "https://localhost:9200/_cluster/health"

# éªŒè¯è¯ä¹¦
openssl s_client -connect localhost:9200 -servername localhost
```

### 4.3 SSLé—®é¢˜è§£å†³


**âœ… é‡æ–°ç”Ÿæˆè¯ä¹¦**
```bash
# ä½¿ç”¨elasticsearch-certutilç”Ÿæˆæ–°è¯ä¹¦
bin/elasticsearch-certutil cert \
  --name elastic-certificates \
  --dns localhost \
  --ip 127.0.0.1,::1

# å¤åˆ¶è¯ä¹¦åˆ°é…ç½®ç›®å½•
cp elastic-certificates.p12 config/
```

**âœ… æ›´æ–°é…ç½®**
```yaml
# elasticsearch.yml
xpack.security.http.ssl.enabled: true
xpack.security.http.ssl.keystore.path: elastic-certificates.p12
xpack.security.http.ssl.truststore.path: elastic-certificates.p12

# å¦‚æœæ˜¯è‡ªç­¾åè¯ä¹¦ï¼Œå¯ä»¥ç¦ç”¨éªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
xpack.security.http.ssl.verification_mode: certificate
```

---

## 5. ğŸ¢ LDAPé›†æˆæ•…éšœæ’æŸ¥


### 5.1 LDAPè¿æ¥é—®é¢˜


**ğŸ”¸ å¸¸è§LDAPé”™è¯¯**
```
è¿æ¥è¶…æ—¶ï¼š
failed to authenticate user, LDAP connection timeout

è®¤è¯å¤±è´¥ï¼š
failed to authenticate user [username], 
bind failed for user template [cn={0},ou=users,dc=example,dc=com]

ç”¨æˆ·æœªæ‰¾åˆ°ï¼š
failed to authenticate user [username], 
user search failed
```

### 5.2 LDAPé…ç½®æ£€æŸ¥


**ğŸ“‹ LDAP Realmé…ç½®ç¤ºä¾‹**
```yaml
# elasticsearch.yml
xpack.security.authc.realms.ldap.ldap1:
  order: 0
  url: "ldap://ldap.example.com:389"
  bind_dn: "cn=admin,dc=example,dc=com"
  bind_password: "admin_password"
  user_search:
    base_dn: "ou=users,dc=example,dc=com"
    filter: "(cn={0})"
  group_search:
    base_dn: "ou=groups,dc=example,dc=com"
    filter: "(member=cn={0},ou=users,dc=example,dc=com)"
  files:
    role_mapping: "role_mapping.yml"
```

### 5.3 LDAPè¯Šæ–­æ–¹æ³•


**ğŸ” æµ‹è¯•LDAPè¿æ¥**
```bash
# ä½¿ç”¨ldapsearchæµ‹è¯•è¿æ¥
ldapsearch -x -H ldap://ldap.example.com:389 \
  -D "cn=admin,dc=example,dc=com" \
  -w admin_password \
  -b "ou=users,dc=example,dc=com" \
  "(cn=username)"

# æ£€æŸ¥ç”¨æˆ·æœç´¢
ldapsearch -x -H ldap://ldap.example.com:389 \
  -D "cn=admin,dc=example,dc=com" \
  -w admin_password \
  -b "ou=users,dc=example,dc=com" \
  "(cn=testuser)"
```

**ğŸ” éªŒè¯è§’è‰²æ˜ å°„**
```yaml
# role_mapping.yml
admin:
  - "cn=admin,ou=groups,dc=example,dc=com"

kibana_user:
  - "cn=kibana_users,ou=groups,dc=example,dc=com"
```

### 5.4 LDAPé—®é¢˜è§£å†³


**âœ… è°ƒæ•´è¿æ¥å‚æ•°**
```yaml
xpack.security.authc.realms.ldap.ldap1:
  timeout.tcp_connect: 30s
  timeout.tcp_read: 30s
  timeout.ldap_search: 30s
  follow_referrals: false
```

**âœ… å¯ç”¨è¯¦ç»†æ—¥å¿—**
```yaml
# log4j2.properties
logger.ldap.name = org.elasticsearch.xpack.security.authc.ldap
logger.ldap.level = DEBUG
```

---

## 6. ğŸ”‘ APIå¯†é’¥è®¤è¯é—®é¢˜


### 6.1 APIå¯†é’¥è®¤è¯æœºåˆ¶


**ğŸ”¸ APIå¯†é’¥çš„ä½œç”¨**
```
ä»€ä¹ˆæ˜¯APIå¯†é’¥ï¼Ÿ
å°±åƒæ˜¯ç¨‹åºä¸“ç”¨çš„é€šè¡Œè¯ï¼Œè®©åº”ç”¨ç¨‹åºå¯ä»¥è‡ªåŠ¨è®¿é—®Elasticsearch
è€Œä¸éœ€è¦ç”¨æˆ·åå¯†ç 

APIå¯†é’¥ä¼˜åŠ¿ï¼š
â€¢ æ›´å®‰å…¨ï¼šå¯ä»¥è®¾ç½®æœ‰æ•ˆæœŸå’Œæƒé™èŒƒå›´
â€¢ æ›´çµæ´»ï¼šå¯ä»¥ä¸ºä¸åŒåº”ç”¨ç”Ÿæˆä¸åŒå¯†é’¥
â€¢ æ›´æ–¹ä¾¿ï¼šç¨‹åºåŒ–è®¿é—®ä¸éœ€è¦ç”¨æˆ·äº¤äº’
â€¢ å¯æ’¤é”€ï¼šéšæ—¶å¯ä»¥ç¦ç”¨æˆ–åˆ é™¤
```

### 6.2 APIå¯†é’¥å¸¸è§é—®é¢˜


**ğŸ”¸ å¯†é’¥è®¤è¯å¤±è´¥**
```
é”™è¯¯ä¿¡æ¯ï¼š
{
  "error": {
    "type": "security_exception",
    "reason": "unable to authenticate with provided credentials"
  }
}

å¯èƒ½åŸå› ï¼š
â€¢ APIå¯†é’¥å·²è¿‡æœŸ
â€¢ å¯†é’¥æ ¼å¼é”™è¯¯
â€¢ å¯†é’¥æƒé™ä¸è¶³
â€¢ å¯†é’¥å·²è¢«æ’¤é”€
```

### 6.3 APIå¯†é’¥ç®¡ç†


**âœ… åˆ›å»ºAPIå¯†é’¥**
```bash
# åˆ›å»ºAPIå¯†é’¥
POST _security/api_key
{
  "name": "my-api-key",
  "expiration": "1d",
  "role_descriptors": {
    "my_role": {
      "cluster": ["monitor"],
      "indices": [
        {
          "names": ["logs-*"],
          "privileges": ["read"]
        }
      ]
    }
  }
}

# è¿”å›ç¤ºä¾‹
{
  "id": "abc123",
  "name": "my-api-key", 
  "api_key": "xyz789",
  "encoded": "YWJjMTIzOnh5ejc4OQ=="
}
```

**âœ… ä½¿ç”¨APIå¯†é’¥**
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Authorizationå¤´
curl -X GET "localhost:9200/_cluster/health" \
  -H "Authorization: ApiKey YWJjMTIzOnh5ejc4OQ=="

# æ–¹æ³•2ï¼šä½¿ç”¨åŸºç¡€è®¤è¯æ ¼å¼
curl -X GET "localhost:9200/_cluster/health" \
  -u abc123:xyz789
```

**ğŸ” æ£€æŸ¥APIå¯†é’¥çŠ¶æ€**
```bash
# æŸ¥çœ‹æ‰€æœ‰APIå¯†é’¥
GET _security/api_key

# æŸ¥çœ‹ç‰¹å®šAPIå¯†é’¥
GET _security/api_key?id=abc123

# æ£€æŸ¥å½“å‰APIå¯†é’¥ä¿¡æ¯
GET _security/_authenticate
```

**âœ… æ’¤é”€APIå¯†é’¥**
```bash
# æ’¤é”€ç‰¹å®šAPIå¯†é’¥
DELETE _security/api_key
{
  "ids": ["abc123"]
}

# æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰APIå¯†é’¥
DELETE _security/api_key
{
  "username": "myuser"
}
```

---

## 7. ğŸ« SAMLè®¤è¯é…ç½®é—®é¢˜


### 7.1 SAMLè®¤è¯æœºåˆ¶ç†è§£


**ğŸ”¸ SAMLå•ç‚¹ç™»å½•æµç¨‹**
```
SAMLè®¤è¯è¿‡ç¨‹ï¼š

ç”¨æˆ·è®¿é—®Kibana â†’ é‡å®šå‘åˆ°èº«ä»½æä¾›è€…(IdP) â†’ ç”¨æˆ·ç™»å½•IdP â†’ 
IdPç”ŸæˆSAMLå“åº” â†’ é‡å®šå‘å›Kibana â†’ ElasticsearchéªŒè¯SAML â†’ 
ç”¨æˆ·æˆåŠŸç™»å½•

å‚ä¸ç»„ä»¶ï¼š
â€¢ SP (Service Provider): Elasticsearch/Kibana
â€¢ IdP (Identity Provider): å¦‚ADFSã€Oktaã€Azure AD
â€¢ ç”¨æˆ·æµè§ˆå™¨: åœ¨SPå’ŒIdPé—´ä¼ é€’ä¿¡æ¯
```

### 7.2 SAMLé…ç½®ç¤ºä¾‹


**ğŸ“‹ SAML Realmé…ç½®**
```yaml
# elasticsearch.yml
xpack.security.authc.realms.saml.saml1:
  order: 2
  idp.metadata.path: saml/idp-metadata.xml
  idp.entity_id: "https://idp.example.com"
  sp.entity_id: "https://kibana.example.com"
  sp.acs: "https://kibana.example.com/api/security/saml/callback"
  sp.logout: "https://kibana.example.com/logout"
  attributes.principal: "nameid"
  attributes.groups: "groups"
```

### 7.3 SAMLå¸¸è§é—®é¢˜


**ğŸ”¸ SAMLæ–­è¨€éªŒè¯å¤±è´¥**
```
é”™è¯¯ç±»å‹ï¼š
â€¢ ç­¾åéªŒè¯å¤±è´¥ - IdPè¯ä¹¦é…ç½®é”™è¯¯
â€¢ æ—¶é—´åå·®é”™è¯¯ - æ—¶é’Ÿä¸åŒæ­¥
â€¢ AudienceéªŒè¯å¤±è´¥ - entity_idé…ç½®é”™è¯¯
â€¢ æ–­è¨€è¿‡æœŸ - ç”Ÿå‘½å‘¨æœŸé…ç½®é—®é¢˜
```

**ğŸ” SAMLè¯Šæ–­æ–¹æ³•**
```bash
# æ£€æŸ¥SAMLé…ç½®
GET _security/realm/saml1

# å¯ç”¨SAMLè°ƒè¯•æ—¥å¿—
# log4j2.properties
logger.saml.name = org.elasticsearch.xpack.security.authc.saml
logger.saml.level = TRACE
```

### 7.4 SAMLé—®é¢˜è§£å†³


**âœ… æ£€æŸ¥æ—¶é’ŸåŒæ­¥**
```bash
# ç¡®ä¿æœåŠ¡å™¨æ—¶é—´åŒæ­¥
ntpdate -s time.nist.gov

# æ£€æŸ¥æ—¶é—´åå·®å®¹å¿åº¦
xpack.security.authc.realms.saml.saml1:
  allowed_clock_skew: 3m
```

**âœ… éªŒè¯è¯ä¹¦é…ç½®**
```bash
# æ£€æŸ¥IdPè¯ä¹¦
openssl x509 -in idp-certificate.crt -text -noout

# éªŒè¯è¯ä¹¦æœ‰æ•ˆæœŸ
openssl x509 -in idp-certificate.crt -dates -noout
```

---

## 8. ğŸ­ è§’è‰²æ˜ å°„é”™è¯¯å¤„ç†


### 8.1 è§’è‰²æ˜ å°„æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯è§’è‰²æ˜ å°„**
```
è§’è‰²æ˜ å°„å°±åƒæ˜¯"ç¿»è¯‘å™¨"ï¼š
æŠŠå¤–éƒ¨ç³»ç»Ÿï¼ˆLDAPã€SAMLï¼‰çš„ç”¨æˆ·ç»„ä¿¡æ¯
ç¿»è¯‘æˆElasticsearchå†…éƒ¨çš„è§’è‰²

ä¾‹å¦‚ï¼š
LDAPç»„ "developers" â†’ ESè§’è‰² "dev_access"
SAMLç»„ "admins" â†’ ESè§’è‰² "superuser"
```

### 8.2 è§’è‰²æ˜ å°„é…ç½®


**ğŸ“‹ åŸºäºæ–‡ä»¶çš„è§’è‰²æ˜ å°„**
```yaml
# role_mapping.yml
admin:
  - "cn=admins,ou=groups,dc=example,dc=com"
  - distinguished_name: "cn=admin,ou=users,dc=example,dc=com"

developer:
  - "cn=developers,ou=groups,dc=example,dc=com"
  - groups: "dev-team"

analyst:
  - groups: "analysts"
  - metadata.department: "analytics"
```

**ğŸ“‹ åŸºäºAPIçš„è§’è‰²æ˜ å°„**
```bash
PUT _security/role_mapping/ldap_admin
{
  "roles": ["admin"],
  "rules": {
    "field": {
      "groups": "cn=admins,ou=groups,dc=example,dc=com"
    }
  }
}

PUT _security/role_mapping/saml_users
{
  "roles": ["kibana_user"],
  "rules": {
    "all": [
      {
        "field": {
          "realm.name": "saml1"
        }
      },
      {
        "field": {
          "groups": "kibana-users"
        }
      }
    ]
  }
}
```

### 8.3 è§’è‰²æ˜ å°„é—®é¢˜è¯Šæ–­


**ğŸ” æ£€æŸ¥æ˜ å°„è§„åˆ™**
```bash
# æŸ¥çœ‹æ‰€æœ‰è§’è‰²æ˜ å°„
GET _security/role_mapping

# æŸ¥çœ‹ç‰¹å®šæ˜ å°„
GET _security/role_mapping/ldap_admin

# æµ‹è¯•è§’è‰²æ˜ å°„
POST _security/role_mapping/_resolve
{
  "username": "john.doe",
  "groups": ["cn=developers,ou=groups,dc=example,dc=com"],
  "realm": {
    "name": "ldap1",
    "type": "ldap"
  }
}
```

### 8.4 è§’è‰²æ˜ å°„æ•…éšœè§£å†³


**âœ… æ›´æ–°æ˜ å°„è§„åˆ™**
```bash
# ä¿®å¤æ˜ å°„è§„åˆ™
PUT _security/role_mapping/corrected_mapping
{
  "roles": ["developer", "kibana_user"],
  "rules": {
    "any": [
      {
        "field": {
          "groups": "cn=developers,ou=groups,dc=example,dc=com"
        }
      },
      {
        "field": {
          "dn": "cn=john.doe,ou=users,dc=example,dc=com"
        }
      }
    ]
  }
}
```

**âœ… é‡æ–°åŠ è½½è§’è‰²æ˜ å°„**
```bash
# åˆ·æ–°æ–‡ä»¶å‹è§’è‰²æ˜ å°„ï¼ˆéœ€è¦é‡å¯ï¼‰
# æˆ–è€…è½¬æ¢ä¸ºAPIå‹æ˜ å°„
POST _security/role_mapping/_refresh
```

---

## 9. ğŸ‘¥ åŒ¿åè®¿é—®é…ç½®


### 9.1 åŒ¿åè®¿é—®æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯åŒ¿åè®¿é—®**
```
åŒ¿åè®¿é—®å…è®¸æœªè®¤è¯ç”¨æˆ·è®¿é—®Elasticsearch
é€šå¸¸ç”¨äºï¼š
â€¢ å…¬å¼€çš„ç›‘æ§ç«¯ç‚¹
â€¢ å¥åº·æ£€æŸ¥æ¥å£  
â€¢ åªè¯»çš„å…¬å¼€æ•°æ®
â€¢ å†…ç½‘ç¯å¢ƒçš„ç®€åŒ–è®¿é—®
```

### 9.2 åŒ¿åè®¿é—®é…ç½®


**ğŸ“‹ å¯ç”¨åŒ¿åè®¿é—®**
```yaml
# elasticsearch.yml
xpack.security.authc.anonymous:
  username: anonymous_user
  roles: anonymous_role
  authz_exception: true  # æƒé™ä¸è¶³æ—¶è¿”å›403è€Œä¸æ˜¯401
```

**ğŸ“‹ åˆ›å»ºåŒ¿åè§’è‰²**
```bash
PUT _security/role/anonymous_role
{
  "cluster": ["monitor"],
  "indices": [
    {
      "names": ["public-*"],
      "privileges": ["read"]
    }
  ]
}
```

### 9.3 åŒ¿åè®¿é—®é—®é¢˜


**ğŸ”¸ å¸¸è§é…ç½®é”™è¯¯**
```
è¿‡åº¦æƒé™ï¼š
ç»™åŒ¿åç”¨æˆ·åˆ†é…äº†è¿‡å¤šæƒé™ï¼Œå­˜åœ¨å®‰å…¨é£é™©

æƒé™ä¸è¶³ï¼š
åŒ¿åç”¨æˆ·æ— æ³•è®¿é—®å¿…è¦çš„ç›‘æ§ç«¯ç‚¹

é…ç½®å†²çªï¼š
åŒ¿åé…ç½®ä¸å…¶ä»–è®¤è¯æ–¹å¼å†²çª
```

### 9.4 åŒ¿åè®¿é—®æœ€ä½³å®è·µ


**âœ… å®‰å…¨é…ç½®åŸåˆ™**
```bash
# æœ€å°æƒé™åŸåˆ™
PUT _security/role/limited_anonymous
{
  "cluster": ["monitor"],
  "indices": [
    {
      "names": [".monitoring-*"],
      "privileges": ["read"]
    }
  ]
}

# é™åˆ¶IPè®¿é—®ï¼ˆå¦‚æœéœ€è¦ï¼‰
xpack.security.http.filter.allow: ["192.168.1.0/24"]
xpack.security.http.filter.deny: "_all"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ”¸ å®‰å…¨ä¸‰è¦ç´ ï¼šè®¤è¯(è°)ã€æˆæƒ(åšä»€ä¹ˆ)ã€å®¡è®¡(è®°å½•)
ğŸ”¸ è®¤è¯æ–¹å¼ï¼šå†…ç½®ç”¨æˆ·ã€LDAPã€SAMLã€APIå¯†é’¥ã€è¯ä¹¦
ğŸ”¸ æƒé™ä½“ç³»ï¼šé›†ç¾¤æƒé™ã€ç´¢å¼•æƒé™ã€å­—æ®µæƒé™ã€æ–‡æ¡£æƒé™
ğŸ”¸ è§’è‰²æ˜ å°„ï¼šå¤–éƒ¨èº«ä»½åˆ°å†…éƒ¨è§’è‰²çš„è½¬æ¢æœºåˆ¶
ğŸ”¸ SSL/TLSï¼šä¼ è¾“åŠ å¯†å’Œèº«ä»½éªŒè¯
```

### 10.2 æ•…éšœæ’æŸ¥æ€è·¯


**ğŸ”¹ è®¤è¯é—®é¢˜æ’æŸ¥æµç¨‹**
```
1. ç¡®è®¤ç”¨æˆ·å­˜åœ¨ä¸”å¯ç”¨
2. éªŒè¯å¯†ç æˆ–è®¤è¯ä¿¡æ¯æ­£ç¡®
3. æ£€æŸ¥è®¤è¯é…ç½®æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
5. æµ‹è¯•ç®€åŒ–é…ç½®
```

**ğŸ”¹ æƒé™é—®é¢˜æ’æŸ¥æµç¨‹**
```
1. ç¡®è®¤ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
2. æ£€æŸ¥è§’è‰²çš„å…·ä½“æƒé™
3. éªŒè¯æƒé™è¦†ç›–èŒƒå›´
4. æµ‹è¯•æœ€å°æƒé™é…ç½®
5. é€æ­¥å¢åŠ æƒé™éªŒè¯
```

### 10.3 å®‰å…¨é…ç½®æœ€ä½³å®è·µ


```
ğŸ”‘ å¯†ç å®‰å…¨ï¼š
â€¢ ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
â€¢ å®šæœŸæ›´æ¢å¯†ç 
â€¢ é¿å…ç¡¬ç¼–ç å¯†ç 

ğŸ” è¯ä¹¦ç®¡ç†ï¼š
â€¢ å®šæœŸæ›´æ–°SSLè¯ä¹¦
â€¢ ä½¿ç”¨å—ä¿¡ä»»çš„CA
â€¢ ç›‘æ§è¯ä¹¦æœ‰æ•ˆæœŸ

ğŸ‘¥ ç”¨æˆ·ç®¡ç†ï¼š
â€¢ æœ€å°æƒé™åŸåˆ™
â€¢ å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™
â€¢ åŠæ—¶ç¦ç”¨ç¦»èŒç”¨æˆ·

ğŸ“Š ç›‘æ§å®¡è®¡ï¼š
â€¢ å¯ç”¨å®‰å…¨å®¡è®¡æ—¥å¿—
â€¢ ç›‘æ§å¼‚å¸¸è®¿é—®
â€¢ å®šæœŸå®‰å…¨è¯„ä¼°
```

### 10.4 å¸¸ç”¨è¯Šæ–­å‘½ä»¤


**ğŸ”§ å¿«é€Ÿè¯Šæ–­å·¥å…·**
| å‘½ä»¤ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `GET _security/user` | æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ | æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ |
| `GET _security/role` | æŸ¥çœ‹è§’è‰²æƒé™ | ç¡®è®¤æƒé™é…ç½® |
| `GET _security/_authenticate` | å½“å‰è®¤è¯ä¿¡æ¯ | éªŒè¯ç™»å½•çŠ¶æ€ |
| `POST _security/user/_has_privileges` | æƒé™æ£€æŸ¥ | æµ‹è¯•å…·ä½“æƒé™ |
| `GET _security/api_key` | APIå¯†é’¥çŠ¶æ€ | æ£€æŸ¥å¯†é’¥æœ‰æ•ˆæ€§ |

### 10.5 åº”æ€¥å¤„ç†æ–¹æ¡ˆ


**ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†**
```
å¿˜è®°è¶…çº§ç”¨æˆ·å¯†ç ï¼š
1. åœæ­¢Elasticsearch
2. åˆ›å»ºä¸´æ—¶è¶…çº§ç”¨æˆ·
3. ä½¿ç”¨bootstrapå¯†ç é‡ç½®
4. é‡æ–°è®¾ç½®å¯†ç ç­–ç•¥

æƒé™é…ç½®é”™è¯¯é”æ­»ï¼š
1. ä½¿ç”¨è¶…çº§ç”¨æˆ·è´¦æˆ·
2. ä¸´æ—¶ç¦ç”¨å®‰å…¨åŠŸèƒ½  
3. ä¿®å¤æƒé™é…ç½®
4. é‡æ–°å¯ç”¨å®‰å…¨åŠŸèƒ½

SSLè¯ä¹¦è¿‡æœŸï¼š
1. ç”Ÿæˆæ–°è¯ä¹¦
2. æ›´æ–°é…ç½®æ–‡ä»¶
3. åˆ†æ‰¹é‡å¯èŠ‚ç‚¹
4. éªŒè¯è¿æ¥æ­£å¸¸
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Elasticsearchå®‰å…¨å°±æ˜¯"é—¨ç¦+æƒé™+ç›‘æ§"ä¸‰ä½ä¸€ä½“
- è®¤è¯è§£å†³"è°èƒ½è¿›"ï¼Œæˆæƒè§£å†³"èƒ½åšå•¥"
- è§’è‰²æ˜ å°„æ˜¯å¤–éƒ¨èº«ä»½å’Œå†…éƒ¨æƒé™çš„æ¡¥æ¢
- SSLè¯ä¹¦æ˜¯ç½‘ç»œé€šä¿¡çš„å®‰å…¨ä¿éšœ
- é‡åˆ°é—®é¢˜å…ˆçœ‹æ—¥å¿—ï¼Œå†æŸ¥é…ç½®ï¼Œæœ€åæµ‹æƒé™