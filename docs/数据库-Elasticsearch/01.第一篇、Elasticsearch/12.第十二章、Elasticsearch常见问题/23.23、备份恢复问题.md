---
title: 23ã€å¤‡ä»½æ¢å¤é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ](#1-å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ)
2. [å¿«ç…§åˆ›å»ºå¤±è´¥é—®é¢˜](#2-å¿«ç…§åˆ›å»ºå¤±è´¥é—®é¢˜)
3. [æ¢å¤è¿‡ç¨‹ä¸­æ–­é—®é¢˜](#3-æ¢å¤è¿‡ç¨‹ä¸­æ–­é—®é¢˜)
4. [å¢é‡å¤‡ä»½å¼‚å¸¸é—®é¢˜](#4-å¢é‡å¤‡ä»½å¼‚å¸¸é—®é¢˜)
5. [è·¨é›†ç¾¤æ¢å¤å¤±è´¥](#5-è·¨é›†ç¾¤æ¢å¤å¤±è´¥)
6. [å¤‡ä»½æ•°æ®æŸåé—®é¢˜](#6-å¤‡ä»½æ•°æ®æŸåé—®é¢˜)
7. [æ¢å¤æ—¶é—´è¿‡é•¿ä¼˜åŒ–](#7-æ¢å¤æ—¶é—´è¿‡é•¿ä¼˜åŒ–)
8. [å¤‡ä»½ç­–ç•¥é…ç½®é—®é¢˜](#8-å¤‡ä»½ç­–ç•¥é…ç½®é—®é¢˜)
9. [ç¾éš¾æ¢å¤æ¼”ç»ƒ](#9-ç¾éš¾æ¢å¤æ¼”ç»ƒ)
10. [è¿ç»´æœ€ä½³å®è·µ](#10-è¿ç»´æœ€ä½³å®è·µ)

---

## 1. ğŸ¯ å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Elasticsearchå¤‡ä»½æ¢å¤


**ç®€å•ç†è§£**ï¼šå°±åƒç»™ç”µè„‘åšå¤‡ä»½ä¸€æ ·ï¼ŒElasticsearchå¤‡ä»½æ¢å¤æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±è€Œåšçš„"ä¿é™©"

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å¤‡ä»½ = ç»™é‡è¦æ–‡ä»¶æ‹ç…§ä¿å­˜
æ¢å¤ = ç…§ç‰‡è¿˜åŸæˆåŸå§‹æ–‡ä»¶

Elasticsearchä¸­ï¼š
å¿«ç…§(Snapshot) = æ•°æ®å¤‡ä»½
æ¢å¤(Restore) = æ•°æ®è¿˜åŸ
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶è¯´æ˜**
- **å¿«ç…§ä»“åº“(Repository)**ï¼šå­˜æ”¾å¤‡ä»½æ–‡ä»¶çš„åœ°æ–¹ï¼Œå°±åƒä¿é™©æŸœ
- **å¿«ç…§(Snapshot)**ï¼šæŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å‰¯æœ¬ï¼Œå°±åƒç…§ç‰‡
- **æ¢å¤æ“ä½œ(Restore)**ï¼šæŠŠå¤‡ä»½æ•°æ®é‡æ–°å¯¼å…¥ï¼Œå°±åƒå†²æ´—ç…§ç‰‡

### 1.2 å¤‡ä»½æ¢å¤çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆå¿…é¡»åšå¤‡ä»½ï¼Ÿ**
```
ğŸ”¸ ç¡¬ä»¶æ•…éšœï¼šæœåŠ¡å™¨åäº†ï¼Œæ•°æ®å°±æ²¡äº†
ğŸ”¸ äººä¸ºè¯¯æ“ä½œï¼šä¸å°å¿ƒåˆ é™¤äº†é‡è¦æ•°æ®
ğŸ”¸ è½¯ä»¶bugï¼šç¨‹åºå‡ºé”™å¯¼è‡´æ•°æ®æŸå
ğŸ”¸ ç¾éš¾äº‹æ•…ï¼šæœºæˆ¿æ–­ç”µã€ç«ç¾ç­‰æç«¯æƒ…å†µ
ğŸ”¸ å®‰å…¨æ”»å‡»ï¼šé»‘å®¢æ¶æ„åˆ é™¤æ•°æ®
```

**ğŸ’¡ çœŸå®æ¡ˆä¾‹**
æŸç”µå•†å…¬å¸å› ä¸ºæ²¡æœ‰åŠæ—¶å¤‡ä»½ï¼Œç¡¬ç›˜æ•…éšœå¯¼è‡´ä¸¢å¤±äº†3ä¸ªæœˆçš„ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œç›´æ¥æŸå¤±ä¸Šç™¾ä¸‡å…ƒã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¤‡ä»½è¢«ç§°ä¸º"æ•°æ®çš„ç”Ÿå‘½çº¿"ã€‚

---

## 2. âš ï¸ å¿«ç…§åˆ›å»ºå¤±è´¥é—®é¢˜


### 2.1 å­˜å‚¨ç©ºé—´ä¸è¶³


**é—®é¢˜è¡¨ç°**ï¼š
```bash
# å…¸å‹é”™è¯¯ä¿¡æ¯
{
  "error": {
    "type": "snapshot_exception",
    "reason": "failed to create snapshot",
    "caused_by": {
      "type": "io_exception", 
      "reason": "No space left on device"
    }
  }
}
```

**ğŸ” è¯Šæ–­æ–¹æ³•**
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /path/to/backup

# æ£€æŸ¥ESæ•°æ®ç›®å½•å¤§å°
du -sh /var/lib/elasticsearch/

# æŸ¥çœ‹å¿«ç…§ä»“åº“é…ç½®
GET /_snapshot/my_backup_repo
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**
```
ç«‹å³å¤„ç†ï¼š
1. æ¸…ç†æ—§çš„å¿«ç…§æ–‡ä»¶
2. æ‰©å®¹å­˜å‚¨ç©ºé—´
3. è°ƒæ•´å¿«ç…§ä¿ç•™ç­–ç•¥

é•¿æœŸè§„åˆ’ï¼š
1. ç›‘æ§ç£ç›˜ä½¿ç”¨ç‡
2. è®¾ç½®è‡ªåŠ¨æ¸…ç†è§„åˆ™
3. é¢„ç•™å……è¶³çš„å­˜å‚¨ç©ºé—´(å»ºè®®é¢„ç•™50%ä»¥ä¸Š)
```

### 2.2 æƒé™é—®é¢˜


**é—®é¢˜è¡¨ç°**ï¼š
```bash
# æƒé™é”™è¯¯ç¤ºä¾‹
{
  "error": {
    "type": "access_denied_exception",
    "reason": "Access denied to snapshot repository"
  }
}
```

**ğŸ”§ è§£å†³æ­¥éª¤**
```bash
# 1. æ£€æŸ¥ç›®å½•æƒé™
ls -la /path/to/backup/

# 2. è®¾ç½®æ­£ç¡®æƒé™
sudo chown -R elasticsearch:elasticsearch /path/to/backup/
sudo chmod -R 755 /path/to/backup/

# 3. éªŒè¯ESè¿›ç¨‹ç”¨æˆ·
ps aux | grep elasticsearch
```

### 2.3 ç½‘ç»œè¿æ¥é—®é¢˜ï¼ˆäº‘å­˜å‚¨ï¼‰


**é—®é¢˜åœºæ™¯**ï¼šä½¿ç”¨äº‘å­˜å‚¨ï¼ˆå¦‚AWS S3ï¼‰ä½œä¸ºå¤‡ä»½ä»“åº“æ—¶

**ğŸ” è¯Šæ–­æ–¹æ³•**
```bash
# æµ‹è¯•ç½‘ç»œè¿æ¥
curl -I https://s3.amazonaws.com/your-bucket/

# æ£€æŸ¥ESæ—¥å¿—
tail -f /var/log/elasticsearch/elasticsearch.log
```

**è§£å†³æ–¹æ¡ˆ**
```yaml
# è°ƒæ•´ç½‘ç»œè¶…æ—¶é…ç½®
cluster.routing.allocation.node_concurrent_recoveries: 2
indices.recovery.max_bytes_per_sec: 40mb
```

---

## 3. ğŸ”„ æ¢å¤è¿‡ç¨‹ä¸­æ–­é—®é¢˜


### 3.1 ç½‘ç»œä¸­æ–­å¯¼è‡´çš„æ¢å¤å¤±è´¥


**é—®é¢˜ç°è±¡**ï¼š
- æ¢å¤è¿›åº¦æ¡å¡ä½ä¸åŠ¨
- æ—¥å¿—æ˜¾ç¤ºç½‘ç»œè¶…æ—¶é”™è¯¯
- éƒ¨åˆ†ç´¢å¼•æ¢å¤ä¸å®Œæ•´

**ğŸ› ï¸ æ•…éšœè¯Šæ–­æµç¨‹**
```bash
# 1. æ£€æŸ¥æ¢å¤çŠ¶æ€
GET /_recovery?active_only=true

# 2. æŸ¥çœ‹å…·ä½“é”™è¯¯
GET /_cluster/health?level=indices

# 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
ping backup-server-ip
telnet backup-server-ip 9200
```

**ğŸ’Š è§£å†³æ–¹æ¡ˆ**
```bash
# å–æ¶ˆå½“å‰æ¢å¤æ“ä½œ
DELETE /partially_restored_index

# è°ƒæ•´ç½‘ç»œè¶…æ—¶å‚æ•°
PUT /_cluster/settings
{
  "transient": {
    "indices.recovery.max_bytes_per_sec": "20mb",
    "cluster.routing.allocation.node_concurrent_recoveries": 1
  }
}

# é‡æ–°å¼€å§‹æ¢å¤
POST /_snapshot/my_backup/snapshot_1/_restore
{
  "indices": "my_index_*",
  "ignore_unavailable": true
}
```

### 3.2 èµ„æºä¸è¶³å¯¼è‡´æ¢å¤ç¼“æ…¢


**èµ„æºç›‘æ§æ£€æŸ¥**
```bash
# CPUä½¿ç”¨ç‡
top

# å†…å­˜ä½¿ç”¨æƒ…å†µ  
free -m

# ç£ç›˜IOçŠ¶å†µ
iostat -x 1

# ES JVMå †å†…å­˜
GET /_nodes/stats/jvm
```

**ğŸ¯ ä¼˜åŒ–ç­–ç•¥**
```
â”Œâ”€ æ¢å¤æ€§èƒ½ä¼˜åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è°ƒæ•´å¹¶å‘æ¢å¤æ•°é‡           â”‚
â”‚ 2. é™åˆ¶æ¢å¤å¸¦å®½é¿å…å½±å“ä¸šåŠ¡   â”‚
â”‚ 3. å¢åŠ JVMå †å†…å­˜              â”‚
â”‚ 4. ä½¿ç”¨SSDç£ç›˜æå‡IOæ€§èƒ½      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ“ˆ å¢é‡å¤‡ä»½å¼‚å¸¸é—®é¢˜


### 4.1 å¢é‡å¤‡ä»½åŸç†


**é€šä¿—è§£é‡Š**ï¼š
```
å…¨é‡å¤‡ä»½ = æŠŠæ•´ä¸ªæˆ¿å­éƒ½æ‹ç…§ä¿å­˜
å¢é‡å¤‡ä»½ = åªæ‹æˆ¿å­é‡Œæ–°å¢æˆ–æ”¹å˜çš„ä¸œè¥¿

å¥½å¤„ï¼š
âœ… èŠ‚çœå­˜å‚¨ç©ºé—´
âœ… å¤‡ä»½é€Ÿåº¦æ›´å¿«
âœ… ç½‘ç»œä¼ è¾“é‡å°
```

**ğŸ”¸ Elasticsearchå¢é‡å¤‡ä»½æœºåˆ¶**
- åŸºäºæ®µ(Segment)çº§åˆ«çš„å¢é‡
- åªå¤‡ä»½æ–°çš„æˆ–ä¿®æ”¹çš„æ®µæ–‡ä»¶
- é€šè¿‡å¿«ç…§å…ƒæ•°æ®è¿½è¸ªå˜åŒ–

### 4.2 å¿«ç…§ç­–ç•¥é…ç½®é”™è¯¯


**å¸¸è§é”™è¯¯é…ç½®**ï¼š
```json
{
  "policy": {
    "name": "daily-snapshots",
    "schedule": "0 30 1 * * ?",  // âŒ é”™è¯¯ï¼šå‡Œæ™¨1:30å¯èƒ½å½±å“ä¸šåŠ¡
    "repository": "my_backup",
    "config": {
      "indices": ["*"],
      "ignore_unavailable": false,  // âŒ å¯èƒ½å¯¼è‡´å¤‡ä»½å¤±è´¥
      "include_global_state": true
    },
    "retention": {
      "expire_after": "7d"  // âŒ ä¿ç•™æ—¶é—´å¤ªçŸ­
    }
  }
}
```

**âœ… æ¨èé…ç½®**ï¼š
```json
{
  "policy": {
    "name": "daily-snapshots", 
    "schedule": "0 0 3 * * ?",  // å‡Œæ™¨3ç‚¹ï¼Œä¸šåŠ¡ä½å³°æœŸ
    "repository": "my_backup",
    "config": {
      "indices": ["log-*", "data-*"],  // æŒ‡å®šé‡è¦ç´¢å¼•
      "ignore_unavailable": true,      // å®¹é”™å¤„ç†
      "include_global_state": false    // å‡å°‘å¤‡ä»½å¤§å°
    },
    "retention": {
      "expire_after": "30d",          // ä¿ç•™30å¤©
      "min_count": 7,                 // è‡³å°‘ä¿ç•™7ä¸ª
      "max_count": 50                 // æœ€å¤šä¿ç•™50ä¸ª
    }
  }
}
```

### 4.3 å­˜å‚¨ç©ºé—´è®¡ç®—é”™è¯¯


**å¢é‡å¤‡ä»½ç©ºé—´ä¼°ç®—å…¬å¼**ï¼š
```
é¢„ä¼°ç©ºé—´éœ€æ±‚ = æ•°æ®å˜åŒ–ç‡ Ã— æ•°æ®æ€»é‡ Ã— ä¿ç•™å¤©æ•°

ç¤ºä¾‹è®¡ç®—ï¼š
- æ•°æ®æ€»é‡ï¼š1TB
- æ—¥å˜åŒ–ç‡ï¼š5%
- ä¿ç•™30å¤©
- é¢„ä¼°ç©ºé—´ï¼š1TB Ã— 5% Ã— 30 = 1.5TB
```

**ğŸ” ç›‘æ§æŒ‡æ ‡**ï¼š
```bash
# æŸ¥çœ‹å¿«ç…§å¤§å°è¶‹åŠ¿
GET /_snapshot/my_backup/_all?verbose=true

# è®¡ç®—å¢é‡æ¯”ä¾‹
å¢é‡æ¯”ä¾‹ = æœ¬æ¬¡å¿«ç…§å¤§å° / å…¨é‡å¿«ç…§å¤§å° Ã— 100%
```

---

## 5. ğŸŒ è·¨é›†ç¾¤æ¢å¤å¤±è´¥


### 5.1 ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜


**ç‰ˆæœ¬å…¼å®¹è§„åˆ™**ï¼š
```
ğŸŸ¢ æ”¯æŒçš„æ¢å¤è·¯å¾„ï¼š
- åŒç‰ˆæœ¬æ¢å¤ï¼š7.x â†’ 7.x âœ…
- å‘ä¸Šå…¼å®¹ï¼š6.x â†’ 7.x âœ…  
- è·¨å°ç‰ˆæœ¬ï¼š7.1 â†’ 7.9 âœ…

ğŸ”´ ä¸æ”¯æŒçš„æ¢å¤è·¯å¾„ï¼š
- å‘ä¸‹æ¢å¤ï¼š7.x â†’ 6.x âŒ
- è·¨å¤§ç‰ˆæœ¬ï¼š5.x â†’ 7.x âŒ
- è·¨ä¸»ç‰ˆæœ¬ï¼š6.x â†’ 8.x âŒ
```

**ğŸ” ç‰ˆæœ¬æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥é›†ç¾¤ç‰ˆæœ¬
GET /

# æ£€æŸ¥å¿«ç…§ç‰ˆæœ¬ä¿¡æ¯
GET /_snapshot/my_backup/snapshot_name
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ–¹æ¡ˆ1ï¼šä½¿ç”¨å…¼å®¹ç‰ˆæœ¬çš„ä¸­é—´é›†ç¾¤
åŸé›†ç¾¤(6.x) â†’ ä¸­é—´é›†ç¾¤(7.x) â†’ ç›®æ ‡é›†ç¾¤(8.x)

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨reindex APIè¿ç§»æ•°æ®
POST /_reindex
{
  "source": {
    "remote": {
      "host": "http://old-cluster:9200"
    },
    "index": "old_index"
  },
  "dest": {
    "index": "new_index"
  }
}
```

### 5.2 é…ç½®å·®å¼‚é—®é¢˜


**å¸¸è§é…ç½®å†²çª**ï¼š
```yaml
# æºé›†ç¾¤é…ç½®
cluster.name: "production-cluster"
node.name: "prod-node-1"
discovery.seed_hosts: ["10.0.1.1", "10.0.1.2"]

# ç›®æ ‡é›†ç¾¤é…ç½®  
cluster.name: "staging-cluster"  # âŒ é›†ç¾¤åä¸åŒ
node.name: "stage-node-1"
discovery.seed_hosts: ["192.168.1.1", "192.168.1.2"]
```

**ğŸ› ï¸ é…ç½®å¯¹é½æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥å…³é”®é…ç½®é¡¹
GET /_cluster/settings

# 2. å¯¹æ¯”ç´¢å¼•è®¾ç½®
GET /my_index/_settings

# 3. è°ƒæ•´ç›®æ ‡é›†ç¾¤é…ç½®
PUT /_cluster/settings
{
  "persistent": {
    "indices.recovery.max_bytes_per_sec": "100mb"
  }
}
```

---

## 6. ğŸ’¥ å¤‡ä»½æ•°æ®æŸåé—®é¢˜


### 6.1 å­˜å‚¨ä»‹è´¨æ•…éšœ


**æ•…éšœç±»å‹åˆ†æ**ï¼š
```
ğŸ”¸ ç¡¬ç›˜åé“ï¼šéƒ¨åˆ†æ•°æ®æ— æ³•è¯»å–
ğŸ”¸ æ–‡ä»¶ç³»ç»ŸæŸåï¼šç›®å½•ç»“æ„ç ´å
ğŸ”¸ ç½‘ç»œå­˜å‚¨æ•…éšœï¼šNFSã€CIFSè¿æ¥é—®é¢˜
ğŸ”¸ äº‘å­˜å‚¨å¼‚å¸¸ï¼šAPIè°ƒç”¨å¤±è´¥ã€æƒé™å˜æ›´
```

**ğŸ” æŸåæ£€æµ‹æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥å¿«ç…§å®Œæ•´æ€§
GET /_snapshot/my_backup/snapshot_name/_verify

# æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
fsck /dev/sdb1

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶MD5
md5sum /backup/path/*.dat
```

**ğŸ’Š æ¢å¤ç­–ç•¥**ï¼š
```
çº§è”æ¢å¤æ–¹æ¡ˆï¼š
1. ä¼˜å…ˆä½¿ç”¨æœ€æ–°å®Œæ•´å¿«ç…§
2. ç»“åˆå¢é‡å¿«ç…§è¡¥å……æ•°æ®  
3. ä½¿ç”¨å‰¯æœ¬é›†ç¾¤æ•°æ®
4. ä»åº”ç”¨å±‚æ—¥å¿—é‡å»º
```

### 6.2 ä¼ è¾“è¿‡ç¨‹æ•°æ®æŸå


**é—®é¢˜åœºæ™¯**ï¼šç½‘ç»œä¼ è¾“æˆ–å­˜å‚¨è¿‡ç¨‹ä¸­æ–‡ä»¶è¢«ç¯¡æ”¹

**é¢„é˜²æªæ–½**ï¼š
```yaml
# å¯ç”¨ä¼ è¾“åŠ å¯†
xpack.security.transport.ssl.enabled: true
xpack.security.transport.ssl.verification_mode: certificate

# å¤‡ä»½æ–‡ä»¶æ ¡éªŒ
path.repo: ["/backup1", "/backup2"]  # å¤šé‡å¤‡ä»½
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æ¢å¤å‰éªŒè¯
POST /_snapshot/my_backup/snapshot_1/_restore
{
  "indices": "test_index",
  "wait_for_completion": true,
  "verify": true
}
```

---

## 7. â° æ¢å¤æ—¶é—´è¿‡é•¿ä¼˜åŒ–


### 7.1 å½±å“æ¢å¤é€Ÿåº¦çš„å› ç´ 


**ä¸»è¦å› ç´ åˆ†æ**ï¼š
```
â”Œâ”€ æ¢å¤é€Ÿåº¦å½±å“å› ç´  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ ç£ç›˜IOæ€§èƒ½ - æœ€å…³é”®å› ç´     â”‚
â”‚ ğŸŒ ç½‘ç»œå¸¦å®½ - è¿œç¨‹æ¢å¤é‡è¦    â”‚
â”‚ ğŸ§  å†…å­˜å¤§å° - å½±å“ç¼“å­˜æ•ˆæœ    â”‚
â”‚ ğŸ”§ å¹¶å‘è®¾ç½® - å¹³è¡¡æ€§èƒ½å’Œç¨³å®š  â”‚
â”‚ ğŸ“Š æ•°æ®é‡å¤§å° - çº¿æ€§å½±å“æ—¶é—´  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼š
```bash
# ç£ç›˜æ€§èƒ½æµ‹è¯•
fio -filename=/data/test -direct=1 -rw=read -bs=1M -size=10G -numjobs=1 -name=test

# ç½‘ç»œå¸¦å®½æµ‹è¯•  
iperf3 -c backup-server -t 60

# ESæ¢å¤æ€§èƒ½ç›‘æ§
GET /_recovery?active_only=true&detailed=true
```

### 7.2 æ¢å¤æ€§èƒ½è°ƒä¼˜


**ğŸš€ æ ¸å¿ƒä¼˜åŒ–å‚æ•°**ï¼š
```bash
# å¢åŠ æ¢å¤å¹¶å‘æ•°
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.node_concurrent_recoveries": 4,
    "cluster.routing.allocation.node_initial_primaries_recoveries": 8,
    "indices.recovery.max_bytes_per_sec": "200mb"
  }
}

# JVMå †å†…å­˜ä¼˜åŒ–
# åœ¨elasticsearch.ymlä¸­è®¾ç½®
-Xms8g
-Xmx8g
```

**åˆ†æ‰¹æ¢å¤ç­–ç•¥**ï¼š
```bash
# ç¬¬ä¸€æ‰¹ï¼šæ¢å¤æ ¸å¿ƒç´¢å¼•
POST /_snapshot/my_backup/snapshot_1/_restore
{
  "indices": "critical_index_*",
  "wait_for_completion": true
}

# ç¬¬äºŒæ‰¹ï¼šæ¢å¤æ¬¡è¦ç´¢å¼•
POST /_snapshot/my_backup/snapshot_1/_restore  
{
  "indices": "secondary_index_*",
  "wait_for_completion": false
}
```

**ğŸ’¡ å®ç”¨æŠ€å·§**ï¼š
```
å¿«é€Ÿæ¢å¤æŠ€å·§ï¼š
1. å…³é—­å‰¯æœ¬ï¼Œæ¢å¤å®Œæˆåå†å¼€å¯
2. ä¸´æ—¶å…³é—­refreshé—´éš”
3. å¢å¤§bulkè¯·æ±‚å¤§å°
4. ä½¿ç”¨æœ¬åœ°ç£ç›˜è€Œéç½‘ç»œå­˜å‚¨
```

---

## 8. âš™ï¸ å¤‡ä»½ç­–ç•¥é…ç½®é—®é¢˜


### 8.1 å¤‡ä»½é¢‘ç‡è®¾ç½®ä¸å½“


**å¸¸è§é”™è¯¯é…ç½®**ï¼š
```
âŒ é”™è¯¯ç¤ºä¾‹ï¼š
- æ¯å°æ—¶å¤‡ä»½ä¸€æ¬¡ â†’ èµ„æºæµªè´¹ï¼Œå½±å“æ€§èƒ½
- æ¯æœˆå¤‡ä»½ä¸€æ¬¡ â†’ æ•°æ®ä¸¢å¤±é£é™©é«˜
- æ‰€æœ‰ç´¢å¼•ä¸€èµ·å¤‡ä»½ â†’ å¤‡ä»½æ—¶é—´è¿‡é•¿

âœ… æ¨èé…ç½®ï¼š
- æ ¸å¿ƒæ•°æ®ï¼šæ¯å¤©å¤‡ä»½
- æ—¥å¿—æ•°æ®ï¼šæ¯å‘¨å¤‡ä»½  
- å†å²æ•°æ®ï¼šæ¯æœˆå¤‡ä»½
```

**åˆ†çº§å¤‡ä»½ç­–ç•¥**ï¼š
```json
{
  "policies": [
    {
      "name": "critical-data-policy",
      "schedule": "0 0 2 * * ?",     // æ¯å¤©å‡Œæ™¨2ç‚¹
      "repository": "fast_ssd_repo",
      "config": {
        "indices": ["user_*", "order_*", "payment_*"]
      },
      "retention": { "expire_after": "30d" }
    },
    {
      "name": "log-data-policy", 
      "schedule": "0 0 3 * * SUN",   // æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹
      "repository": "slow_disk_repo",
      "config": {
        "indices": ["log_*", "metric_*"]
      },
      "retention": { "expire_after": "90d" }
    }
  ]
}
```

### 8.2 ä¿ç•™ç­–ç•¥é…ç½®é”™è¯¯


**å®¹é‡è§„åˆ’å¤±è¯¯**ï¼š
```bash
# é”™è¯¯çš„è®¡ç®—æ–¹å¼
å¤‡ä»½ç©ºé—´ = æ•°æ®æ€»é‡

# æ­£ç¡®çš„è®¡ç®—æ–¹å¼  
å¤‡ä»½ç©ºé—´ = æ•°æ®æ€»é‡ Ã— (1 + å¢é•¿ç‡) Ã— ä¿ç•™å¤©æ•° Ã— 1.3(å®‰å…¨ç³»æ•°)

# å®ä¾‹è®¡ç®—
æ•°æ®æ€»é‡: 100GB
æ—¥å¢é•¿ç‡: 2%  
ä¿ç•™30å¤©
æ‰€éœ€ç©ºé—´: 100GB Ã— (1 + 0.02) Ã— 30 Ã— 1.3 â‰ˆ 4TB
```

**æ™ºèƒ½æ¸…ç†ç­–ç•¥**ï¼š
```json
{
  "retention": {
    "expire_after": "30d",           // 30å¤©åè¿‡æœŸ
    "min_count": 5,                  // æœ€å°‘ä¿ç•™5ä¸ª
    "max_count": 100                 // æœ€å¤šä¿ç•™100ä¸ª
  }
}
```

---

## 9. ğŸš¨ ç¾éš¾æ¢å¤æ¼”ç»ƒ


### 9.1 ç¾éš¾æ¢å¤è®¡åˆ’åˆ¶å®š


**RTOå’ŒRPOæŒ‡æ ‡å®šä¹‰**ï¼š
```
ğŸ¯ æ¢å¤ç›®æ ‡ï¼š
- RTO (Recovery Time Objective): æ¢å¤æ—¶é—´ç›®æ ‡
  â†’ æ ¸å¿ƒä¸šåŠ¡ï¼š2å°æ—¶å†…
  â†’ ä¸€èˆ¬ä¸šåŠ¡ï¼š24å°æ—¶å†…
  
- RPO (Recovery Point Objective): æ¢å¤ç‚¹ç›®æ ‡  
  â†’ æ ¸å¿ƒæ•°æ®ï¼šä¸¢å¤±<1å°æ—¶æ•°æ®
  â†’ æ—¥å¿—æ•°æ®ï¼šä¸¢å¤±<24å°æ—¶æ•°æ®
```

**ç¾éš¾åœºæ™¯åˆ†ç±»**ï¼š
```
â”Œâ”€ ç¾éš¾ç­‰çº§åˆ†ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ è½»å¾®æ•…éšœ: å•èŠ‚ç‚¹å¤±æ•ˆ         â”‚
â”‚ ğŸŸ¡ ä¸­ç­‰æ•…éšœ: å¤šèŠ‚ç‚¹å¤±æ•ˆ         â”‚  
â”‚ ğŸ”´ ä¸¥é‡æ•…éšœ: æ•´ä¸ªé›†ç¾¤å¤±æ•ˆ       â”‚
â”‚ âš« ç¾éš¾æ€§æ•…éšœ: æ•°æ®ä¸­å¿ƒå¤±æ•ˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ¼”ç»ƒå®æ–½æ­¥éª¤


**ğŸ”„ æ¼”ç»ƒæµç¨‹**ï¼š
```bash
# ç¬¬1æ­¥ï¼šå¤‡ä»½å½“å‰ç¯å¢ƒ
POST /_snapshot/disaster_drill_repo/pre_drill_backup
{
  "indices": "*",
  "ignore_unavailable": true,
  "include_global_state": true
}

# ç¬¬2æ­¥ï¼šæ¨¡æ‹Ÿæ•…éšœåœºæ™¯
systemctl stop elasticsearch  # æ¨¡æ‹ŸæœåŠ¡åœæ­¢
rm -rf /var/lib/elasticsearch/nodes  # æ¨¡æ‹Ÿæ•°æ®ä¸¢å¤±

# ç¬¬3æ­¥ï¼šæ‰§è¡Œæ¢å¤æµç¨‹
systemctl start elasticsearch
POST /_snapshot/my_backup/latest_snapshot/_restore

# ç¬¬4æ­¥ï¼šéªŒè¯æ•°æ®å®Œæ•´æ€§
GET /_cat/indices?v
GET /test_index/_count
```

**ğŸ“Š æ¼”ç»ƒè¯„ä¼°æŒ‡æ ‡**ï¼š
```
å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š
âœ“ æ¢å¤æ—¶é—´æ˜¯å¦æ»¡è¶³RTO
âœ“ æ•°æ®ä¸¢å¤±æ˜¯å¦è¶…è¿‡RPO  
âœ“ ä¸šåŠ¡åŠŸèƒ½æ˜¯å¦æ­£å¸¸
âœ“ æ¼”ç»ƒè¿‡ç¨‹æ˜¯å¦é¡ºç•…
âœ“ å›¢é˜Ÿåä½œæ˜¯å¦é«˜æ•ˆ
```

---

## 10. ğŸ“‹ è¿ç»´æœ€ä½³å®è·µ


### 10.1 ç›‘æ§å‘Šè­¦ä½“ç³»


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š
```yaml
# å¤‡ä»½ç›‘æ§
backup_success_rate: >95%      # å¤‡ä»½æˆåŠŸç‡
backup_duration: <2h           # å¤‡ä»½è€—æ—¶
backup_size_growth: <20%/month # å¤‡ä»½å¢é•¿ç‡

# æ¢å¤ç›‘æ§  
recovery_speed: >100MB/s       # æ¢å¤é€Ÿåº¦
recovery_success_rate: >99%    # æ¢å¤æˆåŠŸç‡

# å­˜å‚¨ç›‘æ§
disk_usage: <80%              # ç£ç›˜ä½¿ç”¨ç‡
available_space: >100GB       # å¯ç”¨ç©ºé—´
```

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```bash
# å¤‡ä»½å¤±è´¥å‘Šè­¦
if backup_failed_count > 0:
    alert("å¤‡ä»½å¤±è´¥", "critical")

# å­˜å‚¨ç©ºé—´å‘Šè­¦    
if disk_usage > 85%:
    alert("å­˜å‚¨ç©ºé—´ä¸è¶³", "warning")
    
# æ¢å¤æ—¶é—´å‘Šè­¦
if recovery_time > RTO:
    alert("æ¢å¤æ—¶é—´è¶…æ ‡", "critical")
```

### 10.2 è‡ªåŠ¨åŒ–è¿ç»´


**å¤‡ä»½è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```bash
#!/bin/bash
# backup_automation.sh

DATE=$(date +%Y%m%d_%H%M%S)
SNAPSHOT_NAME="auto_backup_${DATE}"

# åˆ›å»ºå¿«ç…§
curl -X PUT "localhost:9200/_snapshot/my_backup/${SNAPSHOT_NAME}" \
  -H 'Content-Type: application/json' \
  -d '{
    "indices": "*",
    "ignore_unavailable": true,
    "include_global_state": false
  }'

# æ£€æŸ¥å¤‡ä»½çŠ¶æ€
sleep 60
STATUS=$(curl -s "localhost:9200/_snapshot/my_backup/${SNAPSHOT_NAME}" | jq -r '.snapshots[0].state')

if [ "$STATUS" == "SUCCESS" ]; then
    echo "å¤‡ä»½æˆåŠŸ: ${SNAPSHOT_NAME}"
    # æ¸…ç†æ—§å¤‡ä»½
    OLD_SNAPSHOTS=$(curl -s "localhost:9200/_snapshot/my_backup/_all" | jq -r '.snapshots[] | select(.end_time < (now - 30*24*3600*1000)) | .snapshot')
    for snapshot in $OLD_SNAPSHOTS; do
        curl -X DELETE "localhost:9200/_snapshot/my_backup/${snapshot}"
    done
else
    echo "å¤‡ä»½å¤±è´¥: ${SNAPSHOT_NAME}"
    # å‘é€å‘Šè­¦é€šçŸ¥
    ./send_alert.sh "Elasticsearchå¤‡ä»½å¤±è´¥"
fi
```

### 10.3 æ•…éšœåº”æ€¥é¢„æ¡ˆ


**ğŸš¨ åº”æ€¥å“åº”æµç¨‹**ï¼š
```
æ•…éšœå‘ç° â†’ å½±å“è¯„ä¼° â†’ å¯åŠ¨é¢„æ¡ˆ â†’ æ‰§è¡Œæ¢å¤ â†’ éªŒè¯ç»“æœ â†’ æ€»ç»“æ”¹è¿›

è¯¦ç»†æ­¥éª¤ï¼š
1. æ¥åˆ°å‘Šè­¦å5åˆ†é’Ÿå†…å“åº”
2. 15åˆ†é’Ÿå†…å®Œæˆå½±å“èŒƒå›´è¯„ä¼°  
3. 30åˆ†é’Ÿå†…å†³å®šæ˜¯å¦å¯åŠ¨ç¾å¤‡
4. æ ¹æ®æ•…éšœç­‰çº§æ‰§è¡Œå¯¹åº”æ¢å¤ç­–ç•¥
5. æ¢å¤åè¿›è¡ŒåŠŸèƒ½éªŒè¯
6. 48å°æ—¶å†…è¾“å‡ºæ•…éšœæŠ¥å‘Š
```

**åº”æ€¥å·¥å…·ç®±**ï¼š
```bash
# å¸¸ç”¨å‘½ä»¤é›†åˆ
alias es-health="curl localhost:9200/_cluster/health?pretty"
alias es-nodes="curl localhost:9200/_cat/nodes?v"  
alias es-indices="curl localhost:9200/_cat/indices?v"
alias es-snapshots="curl localhost:9200/_cat/snapshots?v"

# å¿«é€Ÿæ¢å¤è„šæœ¬
function quick_restore() {
    local snapshot_name=$1
    local index_pattern=$2
    
    curl -X POST "localhost:9200/_snapshot/my_backup/${snapshot_name}/_restore" \
      -H 'Content-Type: application/json' \
      -d "{
        \"indices\": \"${index_pattern}\",
        \"ignore_unavailable\": true,
        \"wait_for_completion\": false
      }"
}
```

---

## ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### ğŸ¯ **å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ**


```
ğŸ”¸ å¤‡ä»½ä¸‰è¦ç´ ï¼šå¿«ç…§ä»“åº“ + å¿«ç…§ç­–ç•¥ + æ¢å¤æµç¨‹
ğŸ”¸ å¸¸è§æ•…éšœï¼šå­˜å‚¨é—®é¢˜ã€ç½‘ç»œä¸­æ–­ã€ç‰ˆæœ¬å…¼å®¹ã€é…ç½®å·®å¼‚
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šå¹¶å‘æ§åˆ¶ã€å¸¦å®½é™åˆ¶ã€èµ„æºåˆ†é…
ğŸ”¸ ç›‘æ§æŒ‡æ ‡ï¼šæˆåŠŸç‡ã€è€—æ—¶ã€å­˜å‚¨ä½¿ç”¨ç‡
ğŸ”¸ åº”æ€¥é¢„æ¡ˆï¼šRTO/RPOç›®æ ‡ã€åˆ†çº§å“åº”ã€è‡ªåŠ¨åŒ–å·¥å…·
```

### ğŸ’¡ **æ•…éšœé¢„é˜²æœ€ä½³å®è·µ**


```
é¢„é˜²ä¸ºä¸»ï¼š
âœ“ å®šæœŸå¤‡ä»½éªŒè¯
âœ“ ç›‘æ§å­˜å‚¨ç©ºé—´
âœ“ ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
âœ“ ç½‘ç»œç¨³å®šæ€§ä¿éšœ
âœ“ æƒé™é…ç½®è§„èŒƒ

åº”æ€¥å‡†å¤‡ï¼š
âœ“ å®Œå–„çš„ç›‘æ§å‘Šè­¦
âœ“ è‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬  
âœ“ å®šæœŸç¾éš¾æ¼”ç»ƒ
âœ“ è¯¦ç»†çš„æ“ä½œæ‰‹å†Œ
âœ“ 7x24å€¼ç­ä½“ç³»
```

### ğŸš€ **å®æˆ˜ç»éªŒåˆ†äº«**


```bash
ç”Ÿäº§ç¯å¢ƒç»éªŒï¼š
1. å¤‡ä»½å’Œä¸šåŠ¡åˆ†ç¦» - ç‹¬ç«‹çš„å¤‡ä»½ç½‘ç»œå’Œå­˜å‚¨
2. å¤šåœ°å¤šå‰¯æœ¬ - ä¸è¦æŠŠé¸¡è›‹æ”¾åœ¨ä¸€ä¸ªç¯®å­é‡Œ
3. å®šæœŸæ¼”ç»ƒ - çº¸ä¸Šè°ˆå…µä¸å¦‚å®æˆ˜æ£€éªŒ
4. ç›‘æ§å…ˆè¡Œ - é—®é¢˜æ—©å‘ç°æ—©å¤„ç†
5. æ–‡æ¡£é½å…¨ - å…³é”®æ—¶åˆ»é æ–‡æ¡£æ•‘å‘½
```

**ğŸ’ è®°ä½è¿™å¥è¯**ï¼šå¤‡ä»½ä¸æ˜¯ç›®çš„ï¼Œèƒ½å¿«é€Ÿæ¢å¤æ‰æ˜¯ç‹é“ï¼å¹³æ—¶å¤šæµæ±—ï¼Œæˆ˜æ—¶å°‘æµè¡€ã€‚åšå¥½å¤‡ä»½æ¢å¤ï¼Œè®©æ•°æ®æ°¸è¿œå®‰å…¨å¯é ï¼