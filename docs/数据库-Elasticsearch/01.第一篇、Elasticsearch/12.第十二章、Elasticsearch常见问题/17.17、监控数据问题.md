---
title: 17ã€ç›‘æ§æ•°æ®é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [ç›‘æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-ç›‘æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [ç›‘æ§æ•°æ®æ”¶é›†é—®é¢˜](#2-ç›‘æ§æ•°æ®æ”¶é›†é—®é¢˜)
3. [ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§é—®é¢˜](#3-ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§é—®é¢˜)
4. [ç›‘æ§ç´¢å¼•ç®¡ç†é—®é¢˜](#4-ç›‘æ§ç´¢å¼•ç®¡ç†é—®é¢˜)
5. [Kibanaä»ªè¡¨æ¿é—®é¢˜](#5-kibanaä»ªè¡¨æ¿é—®é¢˜)
6. [å†å²æ•°æ®ç®¡ç†é—®é¢˜](#6-å†å²æ•°æ®ç®¡ç†é—®é¢˜)
7. [ç›‘æ§æ€§èƒ½ä¼˜åŒ–](#7-ç›‘æ§æ€§èƒ½ä¼˜åŒ–)
8. [è·¨é›†ç¾¤ç›‘æ§é…ç½®](#8-è·¨é›†ç¾¤ç›‘æ§é…ç½®)
9. [å‘Šè­¦å»¶è¿Ÿé—®é¢˜è§£å†³](#9-å‘Šè­¦å»¶è¿Ÿé—®é¢˜è§£å†³)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç›‘æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Elasticsearchç›‘æ§


**ğŸ” ç®€å•ç†è§£**ï¼šå°±åƒç»™ä½ çš„è½¦è£…äº†å„ç§ä»ªè¡¨ç›˜ï¼Œéšæ—¶çŸ¥é“æ²¹é‡ã€æ°´æ¸©ã€è½¬é€Ÿä¸€æ ·ï¼ŒElasticsearchç›‘æ§å°±æ˜¯ç»™ä½ çš„æœç´¢å¼•æ“è£…äº†"ä»ªè¡¨ç›˜"ã€‚

```
ç›‘æ§ç³»ç»Ÿçš„ä½œç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ•°æ®     â”‚â”€â”€â”€â–¶â”‚    ç›‘æ§     â”‚â”€â”€â”€â–¶â”‚    å‘Šè­¦     â”‚
â”‚    æ”¶é›†     â”‚    â”‚    åˆ†æ     â”‚    â”‚    å¤„ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                   â†‘                   â†‘
  é‡‡é›†æŒ‡æ ‡           è®¡ç®—åˆ†æ           é—®é¢˜é€šçŸ¥
```

**ğŸ’¡ æ ¸å¿ƒç»„ä»¶**ï¼š
- **`ç›‘æ§Agent`**ï¼šè´Ÿè´£æ”¶é›†æ•°æ®çš„"æ¢é’ˆ"ï¼Œæ¯”å¦‚Metricbeatã€Filebeat
- **`ç›‘æ§ç´¢å¼•`**ï¼šå­˜æ”¾ç›‘æ§æ•°æ®çš„åœ°æ–¹ï¼Œç±»ä¼¼æ•°æ®åº“
- **`Kibanaä»ªè¡¨æ¿`**ï¼šå¯è§†åŒ–å±•ç¤ºç•Œé¢ï¼Œè®©ä½ çœ‹æ‡‚ç›‘æ§æ•°æ®
- **`å‘Šè­¦è§„åˆ™`**ï¼šè®¾å®šçš„é˜ˆå€¼ï¼Œè¶…è¿‡å°±é€šçŸ¥ä½ 

### 1.2 ç›‘æ§æ¶æ„å…¨æ™¯


```
å®Œæ•´çš„ç›‘æ§æ¶æ„ï¼š
åº”ç”¨æœåŠ¡å™¨              Elasticsearché›†ç¾¤           ç›‘æ§å±•ç¤º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡åº”ç”¨ â”‚            â”‚   ä¸»èŠ‚ç‚¹        â”‚         â”‚  Kibana  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚   æ•°æ®     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  æŸ¥è¯¢   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Agentâ”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ â”‚ç›‘æ§ç´¢å¼•     â”‚ â”‚ â—€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ä»ªè¡¨æ¿â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚   æ•°æ®èŠ‚ç‚¹      â”‚               â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—¥å¿—æ–‡ä»¶ â”‚   æ—¥å¿—     â”‚ â”‚æ—¥å¿—ç´¢å¼•     â”‚ â”‚         â”‚   å‘Šè­¦   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚   ç³»ç»Ÿ   â”‚
â”‚ â”‚Beat â”‚ â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å­¦ä¹ ç›®æ ‡**ï¼š
- âœ… ç†è§£ç›‘æ§ç³»ç»Ÿå„ç»„ä»¶çš„ä½œç”¨
- âœ… æŒæ¡å¸¸è§ç›‘æ§é—®é¢˜çš„æ’æŸ¥æ€è·¯
- âœ… å­¦ä¼šä¼˜åŒ–ç›‘æ§æ€§èƒ½å’Œå‡†ç¡®æ€§

---

## 2. ğŸ“Š ç›‘æ§æ•°æ®æ”¶é›†é—®é¢˜


### 2.1 ç›‘æ§Agentæ•…éšœè¯Šæ–­


**ğŸš¨ å¸¸è§é—®é¢˜**ï¼šAgentåœæ­¢å·¥ä½œï¼Œæ•°æ®æ”¶é›†ä¸­æ–­

**ğŸ’­ ä¸ºä»€ä¹ˆä¼šå‡ºç°**ï¼šå°±åƒä½“æ¸©è®¡åäº†å°±æµ‹ä¸åˆ°ä½“æ¸©ï¼ŒAgentå‡ºé—®é¢˜å°±æ”¶é›†ä¸åˆ°æ•°æ®ã€‚

**ğŸ”§ æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥AgentæœåŠ¡çŠ¶æ€
sudo systemctl status metricbeat
sudo systemctl status filebeat

# 2. æŸ¥çœ‹Agenté…ç½®æ–‡ä»¶
cat /etc/metricbeat/metricbeat.yml
cat /etc/filebeat/filebeat.yml

# 3. æ£€æŸ¥Agentæ—¥å¿—
sudo journalctl -u metricbeat -f
tail -f /var/log/filebeat/filebeat
```

**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**ï¼š

| æ£€æŸ¥é¡¹ç›® | æ£€æŸ¥å‘½ä»¤ | æ­£å¸¸çŠ¶æ€ |
|---------|---------|---------|
| **æœåŠ¡çŠ¶æ€** | `systemctl status metricbeat` | `Active: active (running)` |
| **ç½‘ç»œè¿æ¥** | `telnet es-host 9200` | `Connected` |
| **æƒé™é…ç½®** | `ls -la /etc/metricbeat/` | `é…ç½®æ–‡ä»¶å¯è¯»` |
| **è¾“å‡ºé…ç½®** | `metricbeat test output` | `è¿æ¥æˆåŠŸ` |

### 2.2 é…ç½®é—®é¢˜è§£å†³


**ğŸ”¸ è¾“å‡ºé…ç½®é”™è¯¯**ï¼š

```yaml
# âŒ é”™è¯¯é…ç½®ç¤ºä¾‹
output.elasticsearch:
  hosts: ["localhost:9200"]  # ä¸»æœºåœ°å€é”™è¯¯
  username: "wrong_user"     # ç”¨æˆ·åé”™è¯¯
  password: "wrong_pass"     # å¯†ç é”™è¯¯

# âœ… æ­£ç¡®é…ç½®ç¤ºä¾‹  
output.elasticsearch:
  hosts: ["elasticsearch-master:9200", "elasticsearch-data1:9200"]
  username: "elastic"
  password: "your_secure_password"
  index: "metricbeat-%{+yyyy.MM.dd}"
```

**ğŸ”¸ é‡‡é›†æ¨¡å—é…ç½®**ï¼š

```yaml
# å¯ç”¨ç³»ç»Ÿç›‘æ§æ¨¡å—
metricbeat.modules:
- module: system
  metricsets:
    - cpu
    - memory
    - network
    - diskio
  enabled: true
  period: 10s
  
- module: elasticsearch
  metricsets:
    - node
    - cluster
  enabled: true
  period: 10s
  hosts: ["localhost:9200"]
```

### 2.3 ç½‘ç»œè¿æ¥é—®é¢˜


**ğŸŒ ç½‘ç»œè¯Šæ–­å‘½ä»¤**ï¼š

```bash
# æµ‹è¯•ESè¿æ¥
curl -X GET "elasticsearch-host:9200/_cluster/health?pretty"

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo firewall-cmd --list-all

# æ£€æŸ¥DNSè§£æ
nslookup elasticsearch-host
ping elasticsearch-host
```

**ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ**ï¼š
- **é˜²ç«å¢™é—®é¢˜**ï¼šå¼€æ”¾9200ç«¯å£
- **DNSé—®é¢˜**ï¼šæ£€æŸ¥/etc/hostsæ–‡ä»¶
- **SSLè¯ä¹¦**ï¼šé…ç½®æ­£ç¡®çš„è¯ä¹¦è·¯å¾„

---

## 3. ğŸ“ˆ ç›‘æ§æŒ‡æ ‡å‡†ç¡®æ€§é—®é¢˜


### 3.1 æŒ‡æ ‡æ•°æ®ä¸å‡†ç¡®çš„åŸå› 


**ğŸ¤” ä¸ºä»€ä¹ˆæ•°æ®ä¸å‡†**ï¼šå°±åƒç§¤ä¸å‡†ä¼šæ˜¾ç¤ºé”™è¯¯çš„ä½“é‡ï¼Œç›‘æ§æŒ‡æ ‡ä¸å‡†ç¡®é€šå¸¸æœ‰è¿™äº›åŸå› ï¼š

**ğŸ“Š é‡‡é›†é¢‘ç‡é—®é¢˜**ï¼š

```
é‡‡é›†é¢‘ç‡å¤ªä½çš„é—®é¢˜ï¼š
æ—¶é—´è½´: 0s    10s    20s    30s    40s    50s
å®é™…å€¼: 50%   90%    45%    85%    40%    80%
é‡‡é›†å€¼: 50%          45%           40%        â† æ¼æ‰äº†å³°å€¼

é‡‡é›†é¢‘ç‡åˆé€‚ï¼š
æ—¶é—´è½´: 0s  5s  10s  15s  20s  25s  30s
å®é™…å€¼: 50% 70% 90%  60%  45%  65%  85%
é‡‡é›†å€¼: 50% 70% 90%  60%  45%  65%  85%  â† æ•è·åˆ°å³°å€¼
```

### 3.2 è°ƒæ•´é‡‡é›†é…ç½®


**âš¡ ä¼˜åŒ–é‡‡é›†é¢‘ç‡**ï¼š

```yaml
# æ ¹æ®ä¸åŒæŒ‡æ ‡è®¾ç½®ä¸åŒé‡‡é›†é¢‘ç‡
metricbeat.modules:
- module: system
  metricsets:
    - cpu          # CPUä½¿ç”¨ç‡å˜åŒ–å¿«ï¼Œé‡‡é›†é¢‘ç‡é«˜
    - memory       # å†…å­˜ç›¸å¯¹ç¨³å®šï¼Œé‡‡é›†é¢‘ç‡é€‚ä¸­
  period: 5s       # 5ç§’é‡‡é›†ä¸€æ¬¡

- module: elasticsearch  
  metricsets:
    - cluster      # é›†ç¾¤çŠ¶æ€å˜åŒ–æ…¢ï¼Œé‡‡é›†é¢‘ç‡ä½
  period: 30s      # 30ç§’é‡‡é›†ä¸€æ¬¡
```

**ğŸ“‹ ä¸åŒæŒ‡æ ‡çš„æ¨èé‡‡é›†é¢‘ç‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | æ¨èé¢‘ç‡ | åŸå›  |
|---------|---------|------|
| **CPUä½¿ç”¨ç‡** | `5-10ç§’` | å˜åŒ–å¿«ï¼Œéœ€è¦åŠæ—¶å‘ç°å³°å€¼ |
| **å†…å­˜ä½¿ç”¨** | `10-30ç§’` | ç›¸å¯¹ç¨³å®šï¼Œä¸­ç­‰é¢‘ç‡å³å¯ |
| **ç£ç›˜IO** | `10-30ç§’` | çªå‘æ€§å˜åŒ–ï¼Œéœ€è¦é€‚ä¸­ç›‘æ§ |
| **ç½‘ç»œæµé‡** | `5-10ç§’` | å˜åŒ–è¾ƒå¿«ï¼Œç‰¹åˆ«æ˜¯é«˜å³°æœŸ |
| **é›†ç¾¤çŠ¶æ€** | `30-60ç§’` | å˜åŒ–ç¼“æ…¢ï¼Œä½é¢‘ç‡ç›‘æ§ |

### 3.3 è®¡ç®—æ–¹æ³•æ ¡æ­£


**ğŸ” èšåˆè®¡ç®—é—®é¢˜**ï¼š

```json
// âŒ é”™è¯¯çš„èšåˆæŸ¥è¯¢ - åªçœ‹å¹³å‡å€¼ä¼šæ©ç›–é—®é¢˜
{
  "aggs": {
    "avg_cpu": {
      "avg": {
        "field": "system.cpu.total.pct"
      }
    }
  }
}

// âœ… æ­£ç¡®çš„èšåˆæŸ¥è¯¢ - åŒæ—¶çœ‹å¹³å‡å€¼ã€æœ€å¤§å€¼ã€95%åˆ†ä½
{
  "aggs": {
    "cpu_stats": {
      "stats": {
        "field": "system.cpu.total.pct"
      }
    },
    "cpu_percentiles": {
      "percentiles": {
        "field": "system.cpu.total.pct",
        "percents": [50, 95, 99]
      }
    }
  }
}
```

---

## 4. ğŸ’¾ ç›‘æ§ç´¢å¼•ç®¡ç†é—®é¢˜


### 4.1 ç›‘æ§ç´¢å¼•è¿‡å¤§é—®é¢˜


**ğŸ’­ ä¸ºä»€ä¹ˆç´¢å¼•ä¼šè¿‡å¤§**ï¼šå°±åƒæ‰‹æœºç›¸å†Œä¸æ¸…ç†ä¼šå æ»¡å­˜å‚¨ç©ºé—´ï¼Œç›‘æ§ç´¢å¼•ä¸ç®¡ç†ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ã€‚

**ğŸ“Š ç´¢å¼•å¤§å°æ£€æŸ¥**ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰ç›‘æ§ç›¸å…³ç´¢å¼•å¤§å°
curl -X GET "localhost:9200/_cat/indices/*beat*?v&h=index,store.size,docs.count&s=store.size:desc"

# æŸ¥çœ‹ç‰¹å®šæ—¥æœŸèŒƒå›´çš„ç´¢å¼•
curl -X GET "localhost:9200/_cat/indices/metricbeat-*?v&s=index"
```

**å…¸å‹è¾“å‡ºç¤ºä¾‹**ï¼š
```
index                     store.size docs.count
metricbeat-2024.09.20     2.3gb      12450000
metricbeat-2024.09.19     2.1gb      11890000  
metricbeat-2024.09.18     2.0gb      11200000
```

### 4.2 é…ç½®æ•°æ®ä¿ç•™ç­–ç•¥


**ğŸ”¸ Index Lifecycle Management (ILM) é…ç½®**ï¼š

```json
// åˆ›å»ºILMç­–ç•¥
PUT _ilm/policy/monitoring-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "1GB",        // å•ä¸ªç´¢å¼•æœ€å¤§1GB
            "max_age": "1d"           // æˆ–è€…æ¯å¤©æ»šåŠ¨
          }
        }
      },
      "warm": {
        "min_age": "7d",             // 7å¤©åè¿›å…¥warmé˜¶æ®µ
        "actions": {
          "shrink": {
            "number_of_shards": 1     // ç¼©å‡ä¸º1ä¸ªåˆ†ç‰‡
          }
        }
      },
      "delete": {
        "min_age": "30d"             // 30å¤©ååˆ é™¤
      }
    }
  }
}
```

**ğŸ”¸ åº”ç”¨ILMç­–ç•¥åˆ°ç´¢å¼•æ¨¡æ¿**ï¼š

```json
PUT _index_template/monitoring-template
{
  "index_patterns": ["metricbeat-*", "filebeat-*"],
  "template": {
    "settings": {
      "index.lifecycle.name": "monitoring-policy",
      "index.lifecycle.rollover_alias": "monitoring-alias"
    }
  }
}
```

### 4.3 æ‰‹åŠ¨æ¸…ç†å†å²æ•°æ®


**ğŸ§¹ æ‰¹é‡åˆ é™¤è€æ—§ç´¢å¼•**ï¼š

```bash
# åˆ é™¤30å¤©å‰çš„ç›‘æ§ç´¢å¼•
curl -X DELETE "localhost:9200/metricbeat-2024.08.*"
curl -X DELETE "localhost:9200/filebeat-2024.08.*"

# ä½¿ç”¨é€šé…ç¬¦åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
curl -X DELETE "localhost:9200/*beat-2024.0[1-8].*"
```

**âš ï¸ é‡è¦æé†’**ï¼šåˆ é™¤ç´¢å¼•æ˜¯ä¸å¯é€†æ“ä½œï¼ŒåŠ¡å¿…ç¡®è®¤æ—¥æœŸèŒƒå›´æ— è¯¯ï¼

---

## 5. ğŸ“Š Kibanaä»ªè¡¨æ¿é—®é¢˜


### 5.1 ä»ªè¡¨æ¿å¼‚å¸¸è¯Šæ–­


**ğŸ”¸ å¸¸è§ä»ªè¡¨æ¿é—®é¢˜**ï¼š

```
ä»ªè¡¨æ¿é—®é¢˜åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®æºé—®é¢˜    â”‚ â† ç´¢å¼•ä¸å­˜åœ¨ã€å­—æ®µæ˜ å°„é”™è¯¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æŸ¥è¯¢è¯­å¥é—®é¢˜  â”‚ â† KQLè¯­æ³•é”™è¯¯ã€æ—¶é—´èŒƒå›´è®¾ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   å¯è§†åŒ–é…ç½®    â”‚ â† èšåˆé…ç½®é”™è¯¯ã€å›¾è¡¨ç±»å‹ä¸å½“
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æƒé™é—®é¢˜      â”‚ â† ç”¨æˆ·æƒé™ä¸è¶³ã€è§’è‰²é…ç½®é”™è¯¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ•°æ®æºé—®é¢˜è§£å†³


**ğŸ” æ£€æŸ¥ç´¢å¼•æ¨¡å¼**ï¼š

```bash
# 1. ç¡®è®¤ç´¢å¼•æ˜¯å¦å­˜åœ¨
curl -X GET "localhost:9200/_cat/indices/metricbeat-*?v"

# 2. æ£€æŸ¥å­—æ®µæ˜ å°„
curl -X GET "localhost:9200/metricbeat-*/_mapping" | jq '.[] | keys'

# 3. éªŒè¯æ•°æ®æ ¼å¼
curl -X GET "localhost:9200/metricbeat-*/_search?size=1" | jq '.hits.hits[0]._source'
```

**ğŸ”§ åœ¨Kibanaä¸­ä¿®å¤**ï¼š

1. **æ›´æ–°ç´¢å¼•æ¨¡å¼**ï¼š
   ```
   Kibana â†’ Stack Management â†’ Index Patterns â†’ metricbeat-*
   â†’ Refresh field list
   ```

2. **æ£€æŸ¥å­—æ®µç±»å‹**ï¼š
   - ç¡®ä¿æ•°å€¼å­—æ®µæ˜¯`number`ç±»å‹
   - ç¡®ä¿æ—¶é—´å­—æ®µæ˜¯`date`ç±»å‹
   - ç¡®ä¿å…³é”®è¯å­—æ®µæ˜¯`keyword`ç±»å‹

### 5.3 æŸ¥è¯¢è¯­å¥ä¼˜åŒ–


**ğŸ”¸ KQLæŸ¥è¯¢è¯­æ³•**ï¼š

```
// âŒ é”™è¯¯çš„æŸ¥è¯¢è¯­æ³•
metricset:cpu AND system.cpu.total.pct > 80%

// âœ… æ­£ç¡®çš„æŸ¥è¯¢è¯­æ³•  
metricset.name:"cpu" AND system.cpu.total.pct > 0.8
```

**ğŸ“Š å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼**ï¼š

| æŸ¥è¯¢ç›®çš„ | KQLè¯­æ³•ç¤ºä¾‹ |
|---------|------------|
| **æŒ‰èŠ‚ç‚¹è¿‡æ»¤** | `host.name:"node-1"` |
| **CPUä½¿ç”¨ç‡é«˜** | `system.cpu.total.pct > 0.8` |
| **é”™è¯¯æ—¥å¿—** | `log.level:"ERROR"` |
| **æ—¶é—´èŒƒå›´** | `@timestamp >= "2024-09-20T00:00:00"` |
| **å¤šæ¡ä»¶ç»„åˆ** | `host.name:"node-1" AND system.cpu.total.pct > 0.5` |

---

## 6. ğŸ“š å†å²æ•°æ®ç®¡ç†é—®é¢˜


### 6.1 å†å²æ•°æ®ç¼ºå¤±æ’æŸ¥


**ğŸ•µï¸ æ•°æ®ç¼ºå¤±çš„å¸¸è§åŸå› **ï¼š

```
æ•°æ®ä¸¢å¤±åŸå› åˆ†æï¼š
åŸå› ä¸€ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³
â”œâ”€ ç£ç›˜æ»¡äº†ï¼Œæ–°æ•°æ®å†™ä¸è¿›å»
â””â”€ è§£å†³ï¼šæ‰©å®¹æˆ–æ¸…ç†æ—§æ•°æ®

åŸå› äºŒï¼šé…ç½®å˜æ›´
â”œâ”€ ç´¢å¼•æ¨¡æ¿è¢«ä¿®æ”¹
â””â”€ è§£å†³ï¼šæ£€æŸ¥é…ç½®å†å²

åŸå› ä¸‰ï¼šæœåŠ¡ä¸­æ–­  
â”œâ”€ AgentæœåŠ¡åœæ­¢
â””â”€ è§£å†³ï¼šæ£€æŸ¥æœåŠ¡æ—¥å¿—

åŸå› å››ï¼šç½‘ç»œé—®é¢˜
â”œâ”€ Agentä¸ESè¿æ¥ä¸­æ–­
â””â”€ è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§
```

**ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥æ¯æ—¥æ•°æ®é‡
curl -X GET "localhost:9200/metricbeat-*/_search?size=0" -H 'Content-Type: application/json' -d'
{
  "aggs": {
    "daily_docs": {
      "date_histogram": {
        "field": "@timestamp",
        "calendar_interval": "day"
      }
    }
  }
}'

# æ£€æŸ¥ç‰¹å®šæ—¶é—´æ®µæ•°æ®
curl -X GET "localhost:9200/metricbeat-*/_count" -H 'Content-Type: application/json' -d'
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "2024-09-20T00:00:00",
        "lt": "2024-09-21T00:00:00"
      }
    }
  }
}'
```

### 6.2 ç”Ÿå‘½å‘¨æœŸç­–ç•¥é…ç½®


**ğŸ”„ å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```json
// ç›‘æ§ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥
PUT _ilm/policy/monitoring-lifecycle
{
  "policy": {
    "phases": {
      "hot": {
        "min_age": "0ms",
        "actions": {
          "rollover": {
            "max_size": "2gb",
            "max_age": "1d",
            "max_docs": 10000000
          },
          "set_priority": {
            "priority": 100
          }
        }
      },
      "warm": {
        "min_age": "3d",
        "actions": {
          "set_priority": {
            "priority": 50
          },
          "allocate": {
            "number_of_replicas": 0
          },
          "shrink": {
            "number_of_shards": 1
          }
        }
      },
      "cold": {
        "min_age": "15d",
        "actions": {
          "set_priority": {
            "priority": 0
          },
          "allocate": {
            "number_of_replicas": 0
          }
        }
      },
      "delete": {
        "min_age": "30d"
      }
    }
  }
}
```

---

## 7. âš¡ ç›‘æ§æ€§èƒ½ä¼˜åŒ–


### 7.1 ç›‘æ§ç»„ä»¶èµ„æºæ¶ˆè€—


**ğŸ’» æ€§èƒ½é—®é¢˜è¯†åˆ«**ï¼š

```bash
# æŸ¥çœ‹Beatè¿›ç¨‹èµ„æºä½¿ç”¨
top -p $(pgrep metricbeat)
ps aux | grep filebeat

# æŸ¥çœ‹Beaté…ç½®çš„èµ„æºé™åˆ¶  
grep -r "queue.mem" /etc/metricbeat/
grep -r "output.workers" /etc/metricbeat/
```

**ğŸ“Š ç›‘æ§å¯¹ESé›†ç¾¤çš„å½±å“**ï¼š

```bash
# æŸ¥çœ‹ç›‘æ§ç›¸å…³çš„ç´¢å¼•å†™å…¥é€Ÿåº¦
curl -X GET "localhost:9200/_cat/indices/*beat*?v&h=index,indexing.index_total,indexing.index_time"

# æŸ¥çœ‹é›†ç¾¤æ•´ä½“æ€§èƒ½æŒ‡æ ‡
curl -X GET "localhost:9200/_cluster/stats?pretty" | jq '.indices.indexing'
```

### 7.2 ä¼˜åŒ–ç›‘æ§é…ç½®


**ğŸ”¸ å‡å°‘èµ„æºæ¶ˆè€—çš„é…ç½®**ï¼š

```yaml
# metricbeat.yml ä¼˜åŒ–é…ç½®
metricbeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 60s              # é™ä½é…ç½®é‡è½½é¢‘ç‡

output.elasticsearch:
  hosts: ["localhost:9200"]
  workers: 2                      # å‡å°‘å¹¶å‘å·¥ä½œçº¿ç¨‹
  bulk_max_size: 1000            # å‡å°‘æ‰¹é‡å¤§å°
  flush_interval: 30s            # å¢åŠ åˆ·æ–°é—´éš”

queue.mem:
  events: 2048                    # å‡å°‘å†…å­˜é˜Ÿåˆ—å¤§å°
  flush.min_events: 512
  flush.timeout: 5s

processors:
  - drop_fields:                  # åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
      fields: ["agent", "ecs", "host.architecture"]
```

**ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹**ï¼š

| é…ç½®é¡¹ | é»˜è®¤å€¼ | ä¼˜åŒ–å€¼ | è¯´æ˜ |
|-------|-------|--------|------|
| **bulk_max_size** | `50` | `1000-5000` | å¢å¤§æ‰¹é‡å†™å…¥å¤§å° |
| **workers** | `1` | `2-4` | é€‚åº¦å¢åŠ å·¥ä½œçº¿ç¨‹ |
| **queue.mem.events** | `4096` | `2048` | é™ä½å†…å­˜ä½¿ç”¨ |
| **period** | `10s` | `30s` | é™ä½é‡‡é›†é¢‘ç‡ |

---

## 8. ğŸŒ è·¨é›†ç¾¤ç›‘æ§é…ç½®


### 8.1 è·¨é›†ç¾¤ç›‘æ§æ¶æ„


**ğŸ—ï¸ ç›‘æ§æ¶æ„è®¾è®¡**ï¼š

```
è·¨é›†ç¾¤ç›‘æ§æ‹“æ‰‘ï¼š
ç”Ÿäº§é›†ç¾¤A              ç›‘æ§é›†ç¾¤              ç”Ÿäº§é›†ç¾¤B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ES Node 1   â”‚       â”‚ Monitor ES  â”‚       â”‚ ES Node 3   â”‚
â”‚ ES Node 2   â”‚ â”€â”€â”€â”€â”€ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”€â”€â”€â”€â”€ â”‚ ES Node 4   â”‚
â”‚             â”‚  ç›‘æ§  â”‚ â”‚ç›‘æ§ç´¢å¼• â”‚ â”‚  ç›‘æ§  â”‚             â”‚
â”‚ Metricbeat  â”‚ æ•°æ®   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ æ•°æ®   â”‚ Metricbeat  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚             â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚   Kibana    â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                      â”‚ â”‚ä»ªè¡¨æ¿   â”‚ â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ç½‘ç»œè¿æ¥é…ç½®


**ğŸ”§ è¿æ¥é…ç½®æ£€æŸ¥**ï¼š

```yaml
# è·¨é›†ç¾¤ç›‘æ§çš„metricbeaté…ç½®
output.elasticsearch:
  hosts: ["monitor-cluster:9200"]    # ç›‘æ§é›†ç¾¤åœ°å€
  username: "monitoring_user"        # ä¸“ç”¨ç›‘æ§ç”¨æˆ·
  password: "secure_password"
  
# å¦‚æœä½¿ç”¨SSL
  protocol: "https"
  ssl.certificate_authorities: ["/etc/ssl/certs/ca.crt"]
  ssl.verification_mode: "certificate"
```

**ğŸ” ç½‘ç»œè¿é€šæ€§æµ‹è¯•**ï¼š

```bash
# ä»ç”Ÿäº§é›†ç¾¤æµ‹è¯•åˆ°ç›‘æ§é›†ç¾¤çš„è¿æ¥
curl -k -u monitoring_user:password \
  "https://monitor-cluster:9200/_cluster/health"

# æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
ping monitor-cluster
traceroute monitor-cluster

# æµ‹è¯•ç«¯å£å¼€æ”¾
telnet monitor-cluster 9200
nmap -p 9200 monitor-cluster
```

### 8.3 æƒé™é…ç½®


**ğŸ” è®¾ç½®ä¸“ç”¨ç›‘æ§ç”¨æˆ·**ï¼š

```bash
# åœ¨ç›‘æ§é›†ç¾¤åˆ›å»ºç›‘æ§ç”¨æˆ·
curl -X POST "monitor-cluster:9200/_security/user/monitoring_user" \
-H 'Content-Type: application/json' -d'
{
  "password": "secure_monitoring_password",
  "roles": ["monitoring_writer"],
  "full_name": "Monitoring User"
}'

# åˆ›å»ºç›‘æ§å†™å…¥è§’è‰²
curl -X POST "monitor-cluster:9200/_security/role/monitoring_writer" \
-H 'Content-Type: application/json' -d'
{
  "indices": [
    {
      "names": ["metricbeat-*", "filebeat-*", ".monitoring-*"],
      "privileges": ["create", "write", "delete", "create_index"]
    }
  ]
}'
```

---

## 9. ğŸš¨ å‘Šè­¦å»¶è¿Ÿé—®é¢˜è§£å†³


### 9.1 å‘Šè­¦å»¶è¿ŸåŸå› åˆ†æ


**â° ä¸ºä»€ä¹ˆå‘Šè­¦ä¼šå»¶è¿Ÿ**ï¼š

```
å‘Šè­¦å»¶è¿Ÿé“¾è·¯åˆ†æï¼š
æ•°æ®äº§ç”Ÿ â†’ æ•°æ®é‡‡é›† â†’ æ•°æ®ä¼ è¾“ â†’ æ•°æ®å­˜å‚¨ â†’ æŸ¥è¯¢æ£€æµ‹ â†’ å‘Šè­¦è§¦å‘
   1s        10s       2s        3s        60s       5s
   â†‘         â†‘         â†‘         â†‘         â†‘         â†‘
é—®é¢˜åŸå› ï¼š é‡‡é›†å»¶è¿Ÿ   ç½‘ç»œå»¶è¿Ÿ   å†™å…¥å»¶è¿Ÿ   æ£€æŸ¥é¢‘ç‡   å¤„ç†å»¶è¿Ÿ

æ€»å»¶è¿Ÿï¼š1+10+2+3+60+5 = 81ç§’
```

**ğŸ¯ ä¼˜åŒ–ç›®æ ‡**ï¼šå°†å‘Šè­¦å»¶è¿Ÿæ§åˆ¶åœ¨30ç§’ä»¥å†…

### 9.2 ä¼˜åŒ–å‘Šè­¦å“åº”é€Ÿåº¦


**ğŸ”¸ å‡å°‘æ£€æŸ¥é¢‘ç‡**ï¼š

```json
// Watcherå‘Šè­¦é…ç½®ä¼˜åŒ–
PUT _watcher/watch/high_cpu_alert
{
  "trigger": {
    "schedule": {
      "interval": "30s"          // ä»60sæ”¹ä¸º30s
    }
  },
  "input": {
    "search": {
      "request": {
        "search_type": "query_then_fetch",
        "indices": ["metricbeat-*"],
        "body": {
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-2m"    // åªæŸ¥è¯¢æœ€è¿‘2åˆ†é’Ÿæ•°æ®
                    }
                  }
                },
                {
                  "range": {
                    "system.cpu.total.pct": {
                      "gte": 0.8        // CPUä½¿ç”¨ç‡è¶…è¿‡80%
                    }
                  }
                }
              ]
            }
          }
        }
      }
    }
  }
}
```

**ğŸ”¸ ä¼˜åŒ–æ•°æ®é‡‡é›†**ï¼š

```yaml
# é’ˆå¯¹å…³é”®æŒ‡æ ‡æé«˜é‡‡é›†é¢‘ç‡
metricbeat.modules:
- module: system
  metricsets: ["cpu"]
  period: 10s                    # å…³é”®æŒ‡æ ‡10ç§’é‡‡é›†
  
- module: system  
  metricsets: ["memory", "diskio"]
  period: 30s                    # ä¸€èˆ¬æŒ‡æ ‡30ç§’é‡‡é›†
```

### 9.3 å‘Šè­¦é˜ˆå€¼è°ƒä¼˜


**ğŸ“Š åˆç†è®¾ç½®å‘Šè­¦é˜ˆå€¼**ï¼š

| æŒ‡æ ‡ç±»å‹ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | æ£€æŸ¥é¢‘ç‡ |
|---------|---------|---------|---------|
| **CPUä½¿ç”¨ç‡** | `70%` | `85%` | `30ç§’` |
| **å†…å­˜ä½¿ç”¨ç‡** | `80%` | `90%` | `60ç§’` |
| **ç£ç›˜ä½¿ç”¨ç‡** | `80%` | `95%` | `300ç§’` |
| **ç½‘ç»œé”™è¯¯ç‡** | `1%` | `5%` | `60ç§’` |
| **å“åº”æ—¶é—´** | `1ç§’` | `3ç§’` | `30ç§’` |

**ğŸ›ï¸ é¿å…å‘Šè­¦é£æš´**ï¼š

```json
// è®¾ç½®å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
{
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gte": 3                 // è¿ç»­3æ¬¡æ£€æµ‹éƒ½è¶…è¿‡é˜ˆå€¼æ‰å‘Šè­¦
      }
    }
  },
  "throttle_period": "5m"        // 5åˆ†é’Ÿå†…æœ€å¤šå‘é€ä¸€æ¬¡ç›¸åŒå‘Šè­¦
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ ç›‘æ§ç³»ç»Ÿæ¶æ„ï¼šAgent â†’ Elasticsearch â†’ Kibana â†’ å‘Šè­¦
ğŸ”¸ æ•°æ®æ”¶é›†é—®é¢˜ï¼šé…ç½®ã€ç½‘ç»œã€æƒé™ä¸‰å¤§ç±»
ğŸ”¸ æŒ‡æ ‡å‡†ç¡®æ€§ï¼šé‡‡é›†é¢‘ç‡ã€è®¡ç®—æ–¹æ³•ã€èšåˆç­–ç•¥
ğŸ”¸ ç´¢å¼•ç®¡ç†ï¼šILMç­–ç•¥ã€æ•°æ®ä¿ç•™ã€æ€§èƒ½ä¼˜åŒ–
ğŸ”¸ å‘Šè­¦ä¼˜åŒ–ï¼šå“åº”é€Ÿåº¦ã€é˜ˆå€¼è®¾ç½®ã€æŠ‘åˆ¶ç­–ç•¥
```

### 10.2 æ•…éšœæ’æŸ¥æ€è·¯


**ğŸ› ï¸ é€šç”¨æ’æŸ¥æµç¨‹**ï¼š

```
1. ç¡®è®¤é—®é¢˜ç°è±¡
   â”œâ”€ æ•°æ®ç¼ºå¤±ï¼ŸæŒ‡æ ‡å¼‚å¸¸ï¼Ÿå‘Šè­¦å»¶è¿Ÿï¼Ÿ
   â””â”€ å½±å“èŒƒå›´å’Œä¸¥é‡ç¨‹åº¦

2. æ£€æŸ¥åŸºç¡€ç»„ä»¶
   â”œâ”€ AgentæœåŠ¡çŠ¶æ€
   â”œâ”€ ç½‘ç»œè¿é€šæ€§  
   â””â”€ ESé›†ç¾¤å¥åº·åº¦

3. åˆ†æé…ç½®é—®é¢˜
   â”œâ”€ æ£€æŸ¥é…ç½®æ–‡ä»¶
   â”œâ”€ éªŒè¯æƒé™è®¾ç½®
   â””â”€ ç¡®è®¤ç´¢å¼•æ¨¡æ¿

4. ä¼˜åŒ–æ€§èƒ½è®¾ç½®
   â”œâ”€ è°ƒæ•´é‡‡é›†é¢‘ç‡
   â”œâ”€ ä¼˜åŒ–èµ„æºé…ç½®
   â””â”€ è®¾ç½®åˆç†é˜ˆå€¼

5. éªŒè¯ä¿®å¤æ•ˆæœ
   â”œâ”€ ç›‘æ§æ•°æ®æ¢å¤
   â”œâ”€ æ€§èƒ½æŒ‡æ ‡æ­£å¸¸
   â””â”€ å‘Šè­¦åŠæ—¶å‡†ç¡®
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ† è¿ç»´ç»éªŒæ€»ç»“**ï¼š

- **ç›‘æ§ä¸æ˜¯è¶Šå¤šè¶Šå¥½**ï¼šé‡ç‚¹ç›‘æ§æ ¸å¿ƒæŒ‡æ ‡ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
- **å‘Šè­¦ä¸æ˜¯è¶Šå¿«è¶Šå¥½**ï¼šå¹³è¡¡å“åº”é€Ÿåº¦å’Œå‡†ç¡®æ€§ï¼Œé¿å…è¯¯æŠ¥
- **æ•°æ®ä¸æ˜¯å­˜è¶Šä¹…è¶Šå¥½**ï¼šæ ¹æ®å®é™…éœ€è¦è®¾ç½®ä¿ç•™æœŸï¼Œæ§åˆ¶æˆæœ¬
- **é…ç½®è¦æœ‰ç‰ˆæœ¬ç®¡ç†**ï¼šç›‘æ§é…ç½®å˜æ›´è¦æœ‰è®°å½•å’Œå›æ»šæœºåˆ¶

**ğŸ’¡ å®æˆ˜æŠ€å·§**ï¼š
- å»ºç«‹ç›‘æ§æ£€æŸ¥æ¸…å•ï¼Œå®šæœŸå·¡æ£€
- è®¾ç½®ç›‘æ§çš„ç›‘æ§ï¼Œç¡®ä¿ç›‘æ§ç³»ç»Ÿè‡ªèº«å¥åº·
- å‡†å¤‡åº”æ€¥é¢„æ¡ˆï¼Œæ˜ç¡®æ•…éšœå¤„ç†æµç¨‹
- å®šæœŸä¼˜åŒ–å‘Šè­¦è§„åˆ™ï¼Œå‡å°‘å™ªéŸ³æé«˜æ•ˆç‡

**ğŸ¯ æ ¸å¿ƒè®°å¿†**ï¼š
ç›‘æ§ç³»ç»Ÿåƒè½¦çš„ä»ªè¡¨ç›˜ï¼Œæ•°æ®è¦å‡†ç¡®ã€åŠæ—¶ã€æœ‰ç”¨ã€‚é—®é¢˜æ’æŸ¥è¦ç³»ç»Ÿæ€§ï¼Œä»Agentåˆ°å­˜å‚¨åˆ°å±•ç¤ºï¼Œä¸€ç¯æ‰£ä¸€ç¯åœ°æ£€æŸ¥ã€‚ä¼˜åŒ–è¦å¹³è¡¡æ€§èƒ½å’Œå‡†ç¡®æ€§ï¼Œä¸è¿½æ±‚æè‡´è€Œè¦è¿½æ±‚å®ç”¨ã€‚