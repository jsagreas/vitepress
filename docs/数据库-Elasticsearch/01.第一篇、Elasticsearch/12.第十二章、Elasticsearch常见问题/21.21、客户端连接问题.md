---
title: 21ã€å®¢æˆ·ç«¯è¿æ¥é—®é¢˜
---
## ğŸ“š ç›®å½•


1. [å®¢æˆ·ç«¯è¿æ¥åŸºç¡€æ¦‚å¿µ](#1-å®¢æˆ·ç«¯è¿æ¥åŸºç¡€æ¦‚å¿µ)
2. [è¿æ¥æ± é…ç½®é—®é¢˜](#2-è¿æ¥æ± é…ç½®é—®é¢˜)
3. [å®¢æˆ·ç«¯ç‰ˆæœ¬å…¼å®¹æ€§](#3-å®¢æˆ·ç«¯ç‰ˆæœ¬å…¼å®¹æ€§)
4. [è´Ÿè½½å‡è¡¡é…ç½®](#4-è´Ÿè½½å‡è¡¡é…ç½®)
5. [è¿æ¥è¶…æ—¶é—®é¢˜](#5-è¿æ¥è¶…æ—¶é—®é¢˜)
6. [åºåˆ—åŒ–é—®é¢˜](#6-åºåˆ—åŒ–é—®é¢˜)
7. [é‡è¯•æœºåˆ¶é…ç½®](#7-é‡è¯•æœºåˆ¶é…ç½®)
8. [è¿æ¥æ³„æ¼é—®é¢˜](#8-è¿æ¥æ³„æ¼é—®é¢˜)
9. [å¼‚æ­¥æ“ä½œå¤„ç†](#9-å¼‚æ­¥æ“ä½œå¤„ç†)
10. [ç»¼åˆæ•…éšœæ’æŸ¥æŒ‡å—](#10-ç»¼åˆæ•…éšœæ’æŸ¥æŒ‡å—)

---

## 1. ğŸ”Œ å®¢æˆ·ç«¯è¿æ¥åŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯è¿æ¥



**ç®€å•ç†è§£**ï¼šå°±åƒä½ ç”¨æ‰‹æœºAppè¿æ¥æœåŠ¡å™¨ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºéœ€è¦é€šè¿‡å®¢æˆ·ç«¯æ¥è¿æ¥ElasticsearchæœåŠ¡å™¨ã€‚

```
åº”ç”¨ç¨‹åº â†â†’ ESå®¢æˆ·ç«¯ â†â†’ ç½‘ç»œ â†â†’ ESæœåŠ¡å™¨

å°±åƒï¼š
ä½ çš„ç”µè„‘ â†â†’ æµè§ˆå™¨ â†â†’ äº’è”ç½‘ â†â†’ ç½‘ç«™æœåŠ¡å™¨
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶**ï¼š
- **å®¢æˆ·ç«¯åº“**ï¼šJavaã€Pythonã€JavaScriptç­‰è¯­è¨€çš„ESè¿æ¥å·¥å…·
- **è¿æ¥æ± **ï¼šç®¡ç†å¤šä¸ªè¿æ¥ï¼Œæé«˜æ•ˆç‡
- **ä¼ è¾“å±‚**ï¼šHTTP/HTTPSåè®®è¿›è¡Œæ•°æ®ä¼ è¾“
- **åºåˆ—åŒ–**ï¼šæŠŠæ•°æ®è½¬æ¢æˆESèƒ½ç†è§£çš„æ ¼å¼

### 1.2 è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ



```
è¿æ¥åˆ›å»º â†’ è®¤è¯éªŒè¯ â†’ è¯·æ±‚å‘é€ â†’ å“åº”æ¥æ”¶ â†’ è¿æ¥é‡Šæ”¾

è¯¦ç»†è¿‡ç¨‹ï¼š
1. å»ºç«‹TCPè¿æ¥
2. è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. å‘é€æœç´¢/ç´¢å¼•è¯·æ±‚
4. æ¥æ”¶ESè¿”å›çš„ç»“æœ
5. å…³é—­æˆ–å¤ç”¨è¿æ¥
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> å®¢æˆ·ç«¯è¿æ¥å°±æ˜¯åº”ç”¨ç¨‹åºå’ŒESä¹‹é—´çš„"ç”µè¯çº¿"ï¼Œå¦‚æœçº¿è·¯æœ‰é—®é¢˜ï¼Œé€šè¯å°±ä¼šæ–­æ–­ç»­ç»­æˆ–è€…æ‰“ä¸é€šã€‚

---

## 2. ğŸŠ è¿æ¥æ± é…ç½®é—®é¢˜



### 2.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± 



**ç”Ÿæ´»ç±»æ¯”**ï¼šè¿æ¥æ± å°±åƒåœè½¦åœºï¼Œæå‰å‡†å¤‡å¥½å¤šä¸ª"åœè½¦ä½"ï¼ˆè¿æ¥ï¼‰ï¼Œéœ€è¦æ—¶ç›´æ¥ç”¨ï¼Œç”¨å®Œå½’è¿˜ï¼Œé¿å…æ¯æ¬¡éƒ½è¦é‡æ–°"ä¿®è·¯"ï¼ˆå»ºç«‹è¿æ¥ï¼‰ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ¯æ¬¡æ–°å»ºè¿æ¥ï¼‰ï¼š
è¯·æ±‚1 â†’ å»ºç«‹è¿æ¥ â†’ ä½¿ç”¨ â†’ å…³é—­ â†’ é‡æ–°å¼€å§‹
è¯·æ±‚2 â†’ å»ºç«‹è¿æ¥ â†’ ä½¿ç”¨ â†’ å…³é—­ â†’ é‡æ–°å¼€å§‹

è¿æ¥æ± æ–¹å¼ï¼ˆå¤ç”¨è¿æ¥ï¼‰ï¼š
è¯·æ±‚1 â†’ ä»æ± ä¸­å–è¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜åˆ°æ± 
è¯·æ±‚2 â†’ ä»æ± ä¸­å–è¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜åˆ°æ± 
```

### 2.2 å¸¸è§è¿æ¥æ± é…ç½®é”™è¯¯



**âŒ é”™è¯¯é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "maxConnections": 5,        // å¤ªå°‘äº†ï¼
  "connectionTimeout": 1000,  // 1ç§’å¤ªçŸ­ï¼
  "maxIdleTime": 10000       // 10ç§’å¤ªçŸ­ï¼
}
```

**âœ… æ¨èé…ç½®**ï¼š
```json
{
  "maxConnections": 50,       // æ ¹æ®å¹¶å‘é‡è°ƒæ•´
  "connectionTimeout": 30000, // 30ç§’è¿æ¥è¶…æ—¶
  "socketTimeout": 60000,     // 60ç§’è¯»å–è¶…æ—¶
  "maxIdleTime": 300000,     // 5åˆ†é’Ÿç©ºé—²æ—¶é—´
  "retryOnTimeout": true      // è¶…æ—¶è‡ªåŠ¨é‡è¯•
}
```

### 2.3 è¿æ¥æ± é—®é¢˜è¯Šæ–­



**ğŸ” è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥è¿æ¥æ•°ä½¿ç”¨æƒ…å†µ**
   ```bash
#   # æŸ¥çœ‹å½“å‰è¿æ¥æ•°
   curl -X GET "localhost:9200/_nodes/stats/http"
   ```

2. **ç›‘æ§è¿æ¥æ± çŠ¶æ€**
   ```
   æ´»è·ƒè¿æ¥æ•° vs æœ€å¤§è¿æ¥æ•°
   ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
   è¿æ¥åˆ›å»º/é”€æ¯é¢‘ç‡
   ```

3. **è¯†åˆ«ç—‡çŠ¶**
   - `Connection pool exhausted` â†’ è¿æ¥æ•°ä¸å¤Ÿ
   - `Connection timeout` â†’ è¶…æ—¶æ—¶é—´å¤ªçŸ­
   - `Too many connections` â†’ å¹¶å‘è¿‡é«˜

> **âš ï¸ æ³¨æ„äº‹é¡¹**
> è¿æ¥æ± é…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡å¹¶å‘é‡æ¥è®¾ç½®ï¼Œä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œä¹Ÿä¸æ˜¯è¶Šå°è¶Šå¥½ã€‚

### 2.4 è¿æ¥æ± ä¼˜åŒ–ç­–ç•¥



| åœºæ™¯ | **è¿æ¥æ•°é…ç½®** | **è¶…æ—¶é…ç½®** | **é€‚ç”¨è¯´æ˜** |
|------|----------------|--------------|-------------|
| ğŸ”¸ **ä½å¹¶å‘åº”ç”¨** | `10-20ä¸ª` | `30ç§’` | `ä¸ªäººé¡¹ç›®ã€å°å›¢é˜Ÿ` |
| ğŸ”¸ **ä¸­ç­‰å¹¶å‘** | `50-100ä¸ª` | `60ç§’` | `ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ` |
| ğŸ”¸ **é«˜å¹¶å‘åº”ç”¨** | `200+ä¸ª` | `120ç§’` | `é¢å‘ç”¨æˆ·çš„äº§å“` |

---

## 3. ğŸ”„ å®¢æˆ·ç«¯ç‰ˆæœ¬å…¼å®¹æ€§



### 3.1 ç‰ˆæœ¬å…¼å®¹æ€§åŸºç¡€



**ç®€å•ç†è§£**ï¼šå°±åƒå¾®ä¿¡çš„ä¸åŒç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒæ—§ç‰ˆæœ¬çš„æŸäº›åŠŸèƒ½ï¼Œæˆ–è€…æ—§ç‰ˆæœ¬ä¸èƒ½ç”¨æ–°ç‰ˆæœ¬çš„ç‰¹æ€§ã€‚

```
ESç‰ˆæœ¬å‘å±•ï¼š
ES 7.x â† å½“å‰ä¸»æµ
ES 8.x â† æœ€æ–°ç‰ˆæœ¬ï¼Œæœ‰é‡å¤§å˜åŒ–
ES 6.x â† è€ç‰ˆæœ¬ï¼Œé€æ¸æ·˜æ±°

å®¢æˆ·ç«¯è¦åŒ¹é…ESç‰ˆæœ¬ï¼
```

### 3.2 ç‰ˆæœ¬ä¸åŒ¹é…çš„å…¸å‹é—®é¢˜



**ğŸš¨ å¸¸è§é”™è¯¯ä¿¡æ¯**ï¼š

```
âŒ "Unknown query type [match_phrase_prefix]"
åŸå› ï¼šå®¢æˆ·ç«¯ç‰ˆæœ¬å¤ªè€ï¼Œä¸æ”¯æŒæ–°çš„æŸ¥è¯¢è¯­æ³•

âŒ "Deprecated field [type] used in index template"
åŸå› ï¼šES 8.xç§»é™¤äº†æŸäº›å­—æ®µï¼Œä½†å®¢æˆ·ç«¯è¿˜åœ¨ä½¿ç”¨

âŒ "Security features are not enabled"
åŸå› ï¼šES 8.xé»˜è®¤å¼€å¯å®‰å…¨ï¼Œä½†å®¢æˆ·ç«¯æ²¡æœ‰é…ç½®è®¤è¯
```

### 3.3 ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥



**ğŸ“‹ æ£€æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤ESæœåŠ¡å™¨ç‰ˆæœ¬**
   ```bash
   curl -X GET "localhost:9200/"
   ```

2. **æ£€æŸ¥å®¢æˆ·ç«¯ç‰ˆæœ¬**
   ```java
   // Javaå®¢æˆ·ç«¯
   System.out.println(client.info().getVersion());
   ```

3. **æŸ¥çœ‹å…¼å®¹æ€§çŸ©é˜µ**

| ESç‰ˆæœ¬ | **Javaå®¢æˆ·ç«¯** | **Pythonå®¢æˆ·ç«¯** | **Node.jså®¢æˆ·ç«¯** |
|--------|----------------|------------------|-------------------|
| `7.17.x` | `7.17.x` | `7.17.x` | `7.17.x` |
| `8.0.x` | `8.0.x+` | `8.0.x+` | `8.0.x+` |
| `8.5.x` | `8.5.x+` | `8.5.x+` | `8.5.x+` |

> **ğŸ”§ å®è·µæŠ€å·§**
> å»ºè®®å®¢æˆ·ç«¯ç‰ˆæœ¬å’ŒESæœåŠ¡å™¨ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œè‡³å°‘ä¸»ç‰ˆæœ¬å·è¦ç›¸åŒã€‚

### 3.4 ç‰ˆæœ¬å‡çº§ç­–ç•¥



**ğŸ¯ å‡çº§æ­¥éª¤**ï¼š

1. **æµ‹è¯•ç¯å¢ƒéªŒè¯**
   - åœ¨æµ‹è¯•ç¯å¢ƒå…ˆå‡çº§å®¢æˆ·ç«¯
   - è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
   - æ£€æŸ¥APIå˜åŒ–

2. **å…¼å®¹æ€§ä»£ç **
   ```java
   // å¤„ç†ç‰ˆæœ¬å·®å¼‚çš„ä»£ç ç¤ºä¾‹
   if (esVersion.startsWith("8.")) {
       // ES 8.xçš„å†™æ³•
       request.setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE);
   } else {
       // ES 7.xçš„å†™æ³•
       request.setRefresh(true);
   }
   ```

3. **åˆ†é˜¶æ®µéƒ¨ç½²**
   - å…ˆå‡çº§éå…³é”®ä¸šåŠ¡
   - ç›‘æ§é”™è¯¯æ—¥å¿—
   - é€æ­¥å‡çº§æ‰€æœ‰åº”ç”¨

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡é…ç½®



### 4.1 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡



**ç”Ÿæ´»ç±»æ¯”**ï¼šè´Ÿè½½å‡è¡¡å°±åƒå•†åœºçš„å¤šä¸ªæ”¶é“¶å°ï¼Œé¡¾å®¢å¯ä»¥é€‰æ‹©æ’é˜Ÿäººå°‘çš„æ”¶é“¶å°ï¼Œè¿™æ ·æ•´ä½“æ•ˆç‡æ›´é«˜ã€‚

```
å•èŠ‚ç‚¹è®¿é—®ï¼ˆå®¹æ˜“è¿‡è½½ï¼‰ï¼š
åº”ç”¨ â†’ ESèŠ‚ç‚¹1 â† æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°è¿™é‡Œ

è´Ÿè½½å‡è¡¡ï¼ˆåˆ†æ•£å‹åŠ›ï¼‰ï¼š
        â†’ ESèŠ‚ç‚¹1 â† éƒ¨åˆ†è¯·æ±‚
åº”ç”¨ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ ESèŠ‚ç‚¹2 â† éƒ¨åˆ†è¯·æ±‚
        â†’ ESèŠ‚ç‚¹3 â† éƒ¨åˆ†è¯·æ±‚
```

### 4.2 ESé›†ç¾¤èŠ‚ç‚¹å‘ç°æœºåˆ¶



**ğŸ” èŠ‚ç‚¹å‘ç°è¿‡ç¨‹**ï¼š

```
1. å®¢æˆ·ç«¯è¿æ¥åˆ°ç§å­èŠ‚ç‚¹ï¼ˆseed nodesï¼‰
2. è·å–é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
3. è‡ªåŠ¨å‘ç°æ–°å¢/åˆ é™¤çš„èŠ‚ç‚¹
4. æ ¹æ®èŠ‚ç‚¹è§’è‰²é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹

èŠ‚ç‚¹è§’è‰²ï¼š
ğŸ“Š æ•°æ®èŠ‚ç‚¹ï¼ˆdata nodeï¼‰ï¼šå­˜å‚¨æ•°æ®ï¼Œå¤„ç†CRUDæ“ä½œ
ğŸ§  ä¸»èŠ‚ç‚¹ï¼ˆmaster nodeï¼‰ï¼šç®¡ç†é›†ç¾¤çŠ¶æ€
ğŸ” åè°ƒèŠ‚ç‚¹ï¼ˆcoordinating nodeï¼‰ï¼šå¤„ç†æœç´¢è¯·æ±‚
```

### 4.3 è´Ÿè½½å‡è¡¡é…ç½®é”™è¯¯



**âŒ å¸¸è§é”™è¯¯**ï¼š

```java
// é”™è¯¯ï¼šåªé…ç½®ä¸€ä¸ªèŠ‚ç‚¹
RestHighLevelClient client = new RestHighLevelClient(
    RestClient.builder(new HttpHost("localhost", 9200, "http"))
);

// é”™è¯¯ï¼šæ²¡æœ‰é…ç½®èŠ‚ç‚¹å‘ç°
// å½“æŸä¸ªèŠ‚ç‚¹å®•æœºæ—¶ï¼Œå®¢æˆ·ç«¯ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢
```

**âœ… æ­£ç¡®é…ç½®**ï¼š

```java
// æ­£ç¡®ï¼šé…ç½®å¤šä¸ªèŠ‚ç‚¹ï¼Œå¼€å¯å—…æ¢
RestHighLevelClient client = new RestHighLevelClient(
    RestClient.builder(
        new HttpHost("es-node1", 9200, "http"),
        new HttpHost("es-node2", 9200, "http"),
        new HttpHost("es-node3", 9200, "http")
    ).setNodeSelector(NodeSelector.SKIP_DEDICATED_MASTERS) // é¿å…è¿æ¥ä¸“ç”¨masterèŠ‚ç‚¹
     .setRequestConfigCallback(requestConfigBuilder ->
         requestConfigBuilder.setConnectTimeout(30000)
                            .setSocketTimeout(60000))
);
```

### 4.4 å¥åº·æ£€æŸ¥é…ç½®



**ğŸ“ˆ å¥åº·æ£€æŸ¥æœºåˆ¶**ï¼š

```
å®šæœŸæ£€æŸ¥ï¼šæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡èŠ‚ç‚¹çŠ¶æ€
å¤±è´¥å¤„ç†ï¼šè¿ç»­3æ¬¡å¤±è´¥åˆ™æ ‡è®°èŠ‚ç‚¹ä¸å¯ç”¨
æ¢å¤æ£€æµ‹ï¼šæ¯5åˆ†é’Ÿå°è¯•é‡æ–°è¿æ¥å¤±è´¥èŠ‚ç‚¹
```

**é…ç½®ç¤ºä¾‹**ï¼š
```java
// é…ç½®å¥åº·æ£€æŸ¥
client.setFailureListener(new RestClient.FailureListener() {
    @Override
    public void onFailure(Node node) {
        log.warn("èŠ‚ç‚¹ {} è¿æ¥å¤±è´¥", node.getHost());
    }
});
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> è´Ÿè½½å‡è¡¡ä¸æ˜¯é­”æ³•ï¼Œéœ€è¦ESé›†ç¾¤æœ¬èº«é…ç½®å¥½ï¼Œå®¢æˆ·ç«¯åªæ˜¯åˆ©ç”¨è¿™ä¸ªèƒ½åŠ›ã€‚

---

## 5. â° è¿æ¥è¶…æ—¶é—®é¢˜



### 5.1 è¶…æ—¶ç±»å‹è¯¦è§£



**æ—¶é—´è½´ç†è§£**ï¼š
```
è¯·æ±‚å‘èµ· â†’ å»ºç«‹è¿æ¥ â†’ å‘é€æ•°æ® â†’ ç­‰å¾…å“åº” â†’ æ¥æ”¶æ•°æ® â†’ è¯·æ±‚å®Œæˆ
   â†‘           â†‘           â†‘           â†‘
è¿æ¥è¶…æ—¶      è¿æ¥è¶…æ—¶    socketè¶…æ—¶   socketè¶…æ—¶
(3-30ç§’)     (ç¡®ç«‹è¿æ¥)   (30-300ç§’)   (æ•°æ®ä¼ è¾“)
```

**ğŸ”¸ ä¸‰ç§è¶…æ—¶ç±»å‹**ï¼š
- **è¿æ¥è¶…æ—¶**ï¼šå»ºç«‹TCPè¿æ¥çš„æ—¶é—´é™åˆ¶
- **Socketè¶…æ—¶**ï¼šæ•°æ®ä¼ è¾“çš„æ—¶é—´é™åˆ¶  
- **è¯·æ±‚è¶…æ—¶**ï¼šæ•´ä¸ªè¯·æ±‚çš„æ—¶é—´é™åˆ¶

### 5.2 è¶…æ—¶åŸå› åˆ†æ



**ğŸ“Š è¶…æ—¶åŸå› æ’æŸ¥**ï¼š

| è¶…æ—¶ç±»å‹ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** | **æ¨èæ—¶é—´** |
|----------|-------------|-------------|-------------|
| `è¿æ¥è¶…æ—¶` | `ç½‘ç»œå»¶è¿Ÿã€é˜²ç«å¢™` | `æ£€æŸ¥ç½‘ç»œã€å¢åŠ æ—¶é—´` | `10-30ç§’` |
| `Socketè¶…æ—¶` | `æŸ¥è¯¢å¤æ‚ã€æ•°æ®é‡å¤§` | `ä¼˜åŒ–æŸ¥è¯¢ã€åˆ†é¡µ` | `60-300ç§’` |
| `è¯·æ±‚è¶…æ—¶` | `ESè´Ÿè½½é«˜ã€èµ„æºä¸è¶³` | `å¢åŠ èŠ‚ç‚¹ã€ä¼˜åŒ–ç´¢å¼•` | `æ ¹æ®ä¸šåŠ¡éœ€æ±‚` |

### 5.3 è¶…æ—¶é…ç½®æœ€ä½³å®è·µ



**âš¡ å¿«é€Ÿè¯Šæ–­è¶…æ—¶é—®é¢˜**ï¼š

1. **æŸ¥çœ‹ESé›†ç¾¤çŠ¶æ€**
   ```bash
   curl -X GET "localhost:9200/_cluster/health"
   curl -X GET "localhost:9200/_nodes/stats"
   ```

2. **æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—**
   ```bash
#   # ESæ—¥å¿—ä¸­æŸ¥æ‰¾slow query
   grep "slow query" /var/log/elasticsearch/elasticsearch.log
   ```

3. **ç›‘æ§ç½‘ç»œå»¶è¿Ÿ**
   ```bash
   ping es-node1.example.com
   telnet es-node1.example.com 9200
   ```

**ğŸ”§ è¶…æ—¶é…ç½®å»ºè®®**ï¼š

```java
// æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯é…ç½®è¶…æ—¶
RequestConfig requestConfig = RequestConfig.custom()
    .setConnectTimeout(30000)      // è¿æ¥è¶…æ—¶ï¼š30ç§’
    .setSocketTimeout(120000)      // Socketè¶…æ—¶ï¼š2åˆ†é’Ÿï¼ˆæœç´¢ï¼‰
    .setConnectionRequestTimeout(10000) // ä»è¿æ¥æ± è·å–è¿æ¥ï¼š10ç§’
    .build();

// å¯¹äºä¸åŒç±»å‹çš„è¯·æ±‚ï¼Œå¯ä»¥è®¾ç½®ä¸åŒçš„è¶…æ—¶
if (isComplexAggregation(request)) {
    // å¤æ‚èšåˆæŸ¥è¯¢ï¼Œå…è®¸æ›´é•¿æ—¶é—´
    socketTimeout = 300000; // 5åˆ†é’Ÿ
} else if (isSimpleGet(request)) {
    // ç®€å•æ–‡æ¡£è·å–ï¼Œè¾ƒçŸ­æ—¶é—´
    socketTimeout = 30000;  // 30ç§’
}
```

### 5.4 è¶…æ—¶é—®é¢˜è§£å†³ç­–ç•¥



**ğŸ¯ è§£å†³æ­¥éª¤**ï¼š

1. **è¯†åˆ«è¶…æ—¶ç±»å‹**
   ```
   Connection timeout â†’ ç½‘ç»œæˆ–åŸºç¡€è®¾æ–½é—®é¢˜
   Read timeout â†’ æŸ¥è¯¢æ€§èƒ½é—®é¢˜
   Request timeout â†’ æ•´ä½“ç³»ç»Ÿè´Ÿè½½é—®é¢˜
   ```

2. **ä¼˜åŒ–ç­–ç•¥**
   - **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä½¿ç”¨è¿‡æ»¤å™¨ã€å‡å°‘è¿”å›å­—æ®µ
   - **åˆ†é¡µå¤„ç†**ï¼šå¤§æ•°æ®é‡åˆ†æ‰¹å¤„ç†
   - **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†è®¾è®¡mappingã€åˆ†ç‰‡
   - **ç¼“å­˜ç­–ç•¥**ï¼šå¸¸ç”¨æŸ¥è¯¢ç»“æœç¼“å­˜

> **âš ï¸ æ³¨æ„äº‹é¡¹**
> ä¸è¦ç›²ç›®å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œè¦æ‰¾åˆ°æ ¹æœ¬åŸå› ã€‚è¶…æ—¶å¾€å¾€æ˜¯æ€§èƒ½é—®é¢˜çš„è¡¨ç°ã€‚

---

## 6. ğŸ”„ åºåˆ—åŒ–é—®é¢˜



### 6.1 ä»€ä¹ˆæ˜¯åºåˆ—åŒ–



**ç®€å•ç†è§£**ï¼šåºåˆ—åŒ–å°±åƒ"ç¿»è¯‘"ï¼ŒæŠŠç¨‹åºä¸­çš„å¯¹è±¡ç¿»è¯‘æˆESèƒ½ç†è§£çš„JSONæ ¼å¼ï¼Œååºåˆ—åŒ–å°±æ˜¯æŠŠESè¿”å›çš„JSONç¿»è¯‘å›ç¨‹åºå¯¹è±¡ã€‚

```
ç¨‹åºå¯¹è±¡ â†â†’ åºåˆ—åŒ–/ååºåˆ—åŒ– â†â†’ JSON â†â†’ ç½‘ç»œä¼ è¾“ â†â†’ ES

ä¾‹å­ï¼š
Javaå¯¹è±¡ï¼šUser{name="å¼ ä¸‰", age=25}
åºåˆ—åŒ–åï¼š{"name":"å¼ ä¸‰","age":25}
```

### 6.2 å¸¸è§åºåˆ—åŒ–é”™è¯¯



**ğŸš¨ å…¸å‹é”™è¯¯ç±»å‹**ï¼š

```java
// é”™è¯¯1ï¼šæ—¥æœŸæ ¼å¼ä¸åŒ¹é…
class User {
    private Date birthDate; // ESæœŸæœ› "2023-01-01"ï¼Œä½†å‘é€äº† "Mon Jan 01 00:00:00 CST 2023"
}

// é”™è¯¯2ï¼šå­—æ®µåä¸åŒ¹é…
class Product {
    @JsonProperty("product_name") // ESä¸­å­—æ®µå« "productName"
    private String name;
}

// é”™è¯¯3ï¼šæ•°æ®ç±»å‹ä¸åŒ¹é…
class Order {
    private String price; // ESæ˜ å°„ä¸º numberï¼Œä½†å‘é€äº†å­—ç¬¦ä¸²
}
```

### 6.3 åºåˆ—åŒ–é…ç½®è§£å†³æ–¹æ¡ˆ



**âœ… æ­£ç¡®é…ç½®**ï¼š

```java
// 1. æ—¥æœŸæ ¼å¼ç»Ÿä¸€
@JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
private Date createTime;

// 2. å­—æ®µæ˜ å°„
@JsonProperty("create_time")
private LocalDateTime createTime;

// 3. å¿½ç•¥ç©ºå€¼
@JsonInclude(JsonInclude.Include.NON_NULL)
private String description;

// 4. è‡ªå®šä¹‰åºåˆ—åŒ–å™¨
@JsonSerialize(using = CustomPriceSerializer.class)
private BigDecimal price;
```

### 6.4 ç¼–ç é—®é¢˜è§£å†³



**ğŸŒ å­—ç¬¦ç¼–ç å¤„ç†**ï¼š

```java
// ç¡®ä¿UTF-8ç¼–ç 
RestClientBuilder builder = RestClient.builder(hosts)
    .setDefaultHeaders(new Header[]{
        new BasicHeader("Content-Type", "application/json; charset=UTF-8")
    });

// ä¸­æ–‡å¤„ç†ç¤ºä¾‹
String keyword = "æœç´¢å…³é”®è¯";
// ç¡®ä¿æ­£ç¡®ç¼–ç ï¼Œé¿å…ä¹±ç 
SearchRequest request = new SearchRequest()
    .source(SearchSourceBuilder.searchSource()
        .query(QueryBuilders.matchQuery("content", keyword)));
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> åºåˆ—åŒ–é—®é¢˜é€šå¸¸ä¸æ˜¯ESçš„é—®é¢˜ï¼Œè€Œæ˜¯æ•°æ®æ ¼å¼è½¬æ¢çš„é—®é¢˜ï¼Œè¦ä¿è¯"è¯´åŒä¸€ç§è¯­è¨€"ã€‚

---

## 7. ğŸ” é‡è¯•æœºåˆ¶é…ç½®



### 7.1 ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•æœºåˆ¶



**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒæ‰“ç”µè¯é‡åˆ°å¿™éŸ³è¦é‡æ–°æ‹¨å·ä¸€æ ·ï¼Œç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ä¹Ÿéœ€è¦é‡è¯•æœºåˆ¶æ¥æé«˜æˆåŠŸç‡ã€‚

```
æ— é‡è¯•ï¼š
è¯·æ±‚ â†’ å¤±è´¥ â†’ æŠ¥é”™ âŒ

æœ‰é‡è¯•ï¼š
è¯·æ±‚ â†’ å¤±è´¥ â†’ é‡è¯•1 â†’ å¤±è´¥ â†’ é‡è¯•2 â†’ æˆåŠŸ âœ…
```

### 7.2 é‡è¯•ç­–ç•¥ç±»å‹



**ğŸ“Š é‡è¯•ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ç±»å‹ | **é‡è¯•é—´éš”** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|----------|-------------|-------------|-----------|
| `å›ºå®šé—´éš”` | `æ¯æ¬¡é—´éš”ç›¸åŒ` | `ç½‘ç»œæŠ–åŠ¨` | `ç®€å•ï¼Œä½†å¯èƒ½é€ æˆå†²å‡»` |
| `æŒ‡æ•°é€€é¿` | `é€æ¬¡å¢åŠ é—´éš”` | `æœåŠ¡è¿‡è½½` | `å‡å°‘å‹åŠ›ï¼Œä½†å»¶è¿Ÿè¾ƒå¤§` |
| `éšæœºå»¶è¿Ÿ` | `éšæœºé—´éš”æ—¶é—´` | `å¤§é‡å¹¶å‘` | `é¿å…é›·ç¾¤æ•ˆåº”` |

### 7.3 é‡è¯•æœºåˆ¶é…ç½®



**âœ… æ¨èé…ç½®**ï¼š

```java
// é…ç½®é‡è¯•ç­–ç•¥
RetryPolicy retryPolicy = new RetryPolicy.Builder()
    .maxRetries(3)                    // æœ€å¤šé‡è¯•3æ¬¡
    .retryInterval(1000)              // åŸºç¡€é—´éš”1ç§’
    .exponentialBackoff(true)         // æŒ‡æ•°é€€é¿
    .maxRetryInterval(10000)          // æœ€å¤§é—´éš”10ç§’
    .retryOnTimeout(true)             // è¶…æ—¶æ—¶é‡è¯•
    .retryOnConnectionFailure(true)   // è¿æ¥å¤±è´¥æ—¶é‡è¯•
    .build();

// ä»€ä¹ˆæƒ…å†µä¸‹é‡è¯•
public boolean shouldRetry(Exception e) {
    if (e instanceof ConnectTimeoutException) {
        return true;  // è¿æ¥è¶…æ—¶ï¼Œé‡è¯•
    }
    if (e instanceof SocketTimeoutException) {
        return true;  // è¯»å–è¶…æ—¶ï¼Œé‡è¯•
    }
    if (e instanceof ElasticsearchStatusException) {
        int status = ((ElasticsearchStatusException) e).status().getStatus();
        return status == 502 || status == 503 || status == 504; // æœåŠ¡å™¨é”™è¯¯ï¼Œé‡è¯•
    }
    return false; // å…¶ä»–é”™è¯¯ä¸é‡è¯•
}
```

### 7.4 é‡è¯•æœ€ä½³å®è·µ



**ğŸ¯ é‡è¯•é…ç½®æŒ‡å—**ï¼š

1. **åŒºåˆ†é”™è¯¯ç±»å‹**
   ```
   ä¸´æ—¶æ€§é”™è¯¯ â†’ å¯ä»¥é‡è¯•
   - ç½‘ç»œè¶…æ—¶
   - æœåŠ¡å™¨å¿™ç¢Œ(503)
   - è¿æ¥å¤±è´¥
   
   æ°¸ä¹…æ€§é”™è¯¯ â†’ ä¸è¦é‡è¯•
   - è®¤è¯å¤±è´¥(401)
   - æƒé™ä¸è¶³(403)
   - è¯­æ³•é”™è¯¯(400)
   ```

2. **åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°**
   ```
   å¿«é€Ÿæ“ä½œï¼š1-3æ¬¡é‡è¯•
   é‡è¦æ“ä½œï¼š3-5æ¬¡é‡è¯•
   æ‰¹é‡æ“ä½œï¼šé€‚å½“å¢åŠ é‡è¯•æ¬¡æ•°
   ```

3. **ç›‘æ§é‡è¯•æ•ˆæœ**
   ```java
   // è®°å½•é‡è¯•ç»Ÿè®¡
   if (retryCount > 0) {
       log.warn("è¯·æ±‚é‡è¯• {} æ¬¡åæˆåŠŸï¼ŒåŸå› ï¼š{}", retryCount, lastError);
   }
   ```

> **âš ï¸ æ³¨æ„äº‹é¡¹**
> é‡è¯•æœºåˆ¶æ˜¯åŒåˆƒå‰‘ï¼Œé…ç½®ä¸å½“å¯èƒ½åŠ é‡ç³»ç»Ÿè´Ÿæ‹…ã€‚è¦æ ¹æ®å…·ä½“é”™è¯¯åŸå› å†³å®šæ˜¯å¦é‡è¯•ã€‚

---

## 8. ğŸ’§ è¿æ¥æ³„æ¼é—®é¢˜



### 8.1 ä»€ä¹ˆæ˜¯è¿æ¥æ³„æ¼



**ç”Ÿæ´»ç±»æ¯”**ï¼šè¿æ¥æ³„æ¼å°±åƒå€Ÿä¹¦ä¸è¿˜ï¼Œå›¾ä¹¦é¦†çš„ä¹¦è¶Šæ¥è¶Šå°‘ï¼Œæœ€åæ²¡ä¹¦å¯å€Ÿã€‚ç¨‹åºåˆ›å»ºè¿æ¥åä¸å…³é—­ï¼Œæœ€ç»ˆè€—å°½æ‰€æœ‰è¿æ¥ã€‚

```
æ­£å¸¸ä½¿ç”¨ï¼š
åˆ›å»ºè¿æ¥ â†’ ä½¿ç”¨ â†’ å…³é—­è¿æ¥ â†’ èµ„æºé‡Šæ”¾ âœ…

è¿æ¥æ³„æ¼ï¼š
åˆ›å»ºè¿æ¥ â†’ ä½¿ç”¨ â†’ å¿˜è®°å…³é—­ â†’ è¿æ¥ç§¯ç´¯ â†’ èµ„æºè€—å°½ âŒ
```

### 8.2 è¿æ¥æ³„æ¼çš„è¡¨ç°



**ğŸš¨ å…¸å‹ç—‡çŠ¶**ï¼š
- åº”ç”¨åˆšå¯åŠ¨æ­£å¸¸ï¼Œè¿è¡Œä¸€æ®µæ—¶é—´åè¿æ¥å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š`Connection pool exhausted`
- ESæœåŠ¡å™¨æ˜¾ç¤ºå¤§é‡`ESTABLISHED`çŠ¶æ€çš„è¿æ¥
- åº”ç”¨å†…å­˜æŒç»­å¢é•¿

### 8.3 è¿æ¥æ³„æ¼æ£€æµ‹



**ğŸ” æ£€æµ‹æ–¹æ³•**ï¼š

1. **æ£€æŸ¥ç³»ç»Ÿè¿æ¥æ•°**
   ```bash
#   # LinuxæŸ¥çœ‹è¿æ¥æ•°
   netstat -an | grep :9200 | grep ESTABLISHED | wc -l
   
#   # æŸ¥çœ‹å…·ä½“è¿æ¥
   netstat -an | grep :9200
   ```

2. **Javaåº”ç”¨æ£€æµ‹**
   ```java
   // ç›‘æ§è¿æ¥æ± çŠ¶æ€
   public void monitorConnectionPool() {
       PoolStats stats = httpClient.getConnectionManager().getTotalStats();
       log.info("è¿æ¥æ± çŠ¶æ€ - æ´»è·ƒ:{}, ç©ºé—²:{}, æœ€å¤§:{}", 
               stats.getLeased(), stats.getAvailable(), stats.getMax());
   }
   ```

3. **åº”ç”¨çº§ç›‘æ§**
   ```java
   // è®°å½•è¿æ¥åˆ›å»ºå’Œå…³é—­
   private final AtomicInteger connectionCount = new AtomicInteger(0);
   
   public void onConnectionCreated() {
       int current = connectionCount.incrementAndGet();
       log.debug("åˆ›å»ºè¿æ¥ï¼Œå½“å‰è¿æ¥æ•°ï¼š{}", current);
   }
   
   public void onConnectionClosed() {
       int current = connectionCount.decrementAndGet();
       log.debug("å…³é—­è¿æ¥ï¼Œå½“å‰è¿æ¥æ•°ï¼š{}", current);
   }
   ```

### 8.4 è¿æ¥æ³„æ¼è§£å†³æ–¹æ¡ˆ



**âœ… é¢„é˜²æªæ–½**ï¼š

```java
// 1. ä½¿ç”¨try-with-resourcesç¡®ä¿å…³é—­
try (RestHighLevelClient client = createClient()) {
    // æ‰§è¡ŒESæ“ä½œ
    SearchResponse response = client.search(request, RequestOptions.DEFAULT);
    return response;
} // è‡ªåŠ¨å…³é—­è¿æ¥

// 2. æ­£ç¡®çš„è¿æ¥ç®¡ç†
public class ElasticsearchService {
    private final RestHighLevelClient client;
    
    public ElasticsearchService() {
        this.client = createClient();
    }
    
    @PreDestroy // åº”ç”¨å…³é—­æ—¶è‡ªåŠ¨è°ƒç”¨
    public void cleanup() {
        try {
            if (client != null) {
                client.close();
            }
        } catch (IOException e) {
            log.error("å…³é—­ESå®¢æˆ·ç«¯å¤±è´¥", e);
        }
    }
}

// 3. è¿æ¥æ± é…ç½®
RestClientBuilder builder = RestClient.builder(hosts)
    .setRequestConfigCallback(requestConfigBuilder ->
        requestConfigBuilder
            .setConnectionRequestTimeout(10000)  // è·å–è¿æ¥è¶…æ—¶
            .setSocketTimeout(60000))            // Socketè¶…æ—¶
    .setHttpClientConfigCallback(httpClientBuilder ->
        httpClientBuilder
            .setMaxConnTotal(100)               // æœ€å¤§è¿æ¥æ•°
            .setMaxConnPerRoute(10)             // æ¯ä¸ªè·¯ç”±æœ€å¤§è¿æ¥æ•°
            .setConnectionTimeToLive(5, TimeUnit.MINUTES) // è¿æ¥å­˜æ´»æ—¶é—´
            .evictIdleConnections(1, TimeUnit.MINUTES));   // æ¸…ç†ç©ºé—²è¿æ¥
```

> **ğŸ”§ å®è·µæŠ€å·§**
> è¿æ¥æ³„æ¼é€šå¸¸æ˜¯ä»£ç é—®é¢˜ï¼Œä¸æ˜¯é…ç½®é—®é¢˜ã€‚è¦å…»æˆè‰¯å¥½çš„èµ„æºç®¡ç†ä¹ æƒ¯ã€‚

---

## 9. âš¡ å¼‚æ­¥æ“ä½œå¤„ç†



### 9.1 åŒæ­¥vså¼‚æ­¥æ“ä½œ



**ç®€å•ç†è§£**ï¼š
- **åŒæ­¥**ï¼šç­‰å¿«é€’å‘˜é€åˆ°æ‰‹é‡Œæ‰åšå…¶ä»–äº‹ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
- **å¼‚æ­¥**ï¼šå¿«é€’å‘˜è¯´"ä¸‹åˆé€åˆ°"ï¼Œä½ ç»§ç»­å¹²å…¶ä»–äº‹ï¼ˆéé˜»å¡ï¼‰

```
åŒæ­¥æ“ä½œï¼š
å‘é€è¯·æ±‚ â†’ ç­‰å¾…å“åº” â†’ å¤„ç†ç»“æœ â†’ ç»§ç»­ä¸‹ä¸€æ­¥
         â†‘ï¼ˆè¿™é‡Œä¼šä¸€ç›´ç­‰å¾…ï¼‰

å¼‚æ­¥æ“ä½œï¼š
å‘é€è¯·æ±‚ â†’ ç»§ç»­å…¶ä»–æ“ä½œ â†’ æ”¶åˆ°å›è°ƒ â†’ å¤„ç†ç»“æœ
         â†‘ï¼ˆä¸ä¼šé˜»å¡ï¼‰
```

### 9.2 å¼‚æ­¥æ“ä½œå¸¸è§é—®é¢˜



**ğŸš¨ å…¸å‹é”™è¯¯**ï¼š

```java
// é”™è¯¯1ï¼šå¿˜è®°å¤„ç†å¼‚æ­¥ç»“æœ
client.searchAsync(request, RequestOptions.DEFAULT, new ActionListener<SearchResponse>() {
    @Override
    public void onResponse(SearchResponse response) {
        // å¤„ç†æˆåŠŸç»“æœ
        processSearchResults(response);
    }
    
    @Override
    public void onFailure(Exception e) {
        // é—æ¼ï¼šæ²¡æœ‰å¤„ç†å¤±è´¥æƒ…å†µï¼
        // è¿™ä¼šå¯¼è‡´é”™è¯¯è¢«å¿½ç•¥
    }
});

// é”™è¯¯2ï¼šåœ¨å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œ
client.searchAsync(request, RequestOptions.DEFAULT, new ActionListener<SearchResponse>() {
    @Override
    public void onResponse(SearchResponse response) {
        // é”™è¯¯ï¼šåœ¨å›è°ƒçº¿ç¨‹ä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œï¼ˆé˜»å¡ï¼‰
        saveToDatabase(response); // ä¼šé˜»å¡ESå®¢æˆ·ç«¯çš„IOçº¿ç¨‹ï¼
    }
    
    @Override
    public void onFailure(Exception e) {
        log.error("æœç´¢å¤±è´¥", e);
    }
});
```

### 9.3 å¼‚æ­¥æ“ä½œæœ€ä½³å®è·µ



**âœ… æ­£ç¡®çš„å¼‚æ­¥å¤„ç†**ï¼š

```java
// 1. å®Œæ•´çš„é”™è¯¯å¤„ç†
CompletableFuture<SearchResponse> searchFuture = new CompletableFuture<>();

client.searchAsync(request, RequestOptions.DEFAULT, new ActionListener<SearchResponse>() {
    @Override
    public void onResponse(SearchResponse response) {
        searchFuture.complete(response);
    }
    
    @Override
    public void onFailure(Exception e) {
        searchFuture.completeExceptionally(e);
    }
});

// å¤„ç†ç»“æœ
searchFuture
    .thenApply(this::processSearchResults)    // å¤„ç†æˆåŠŸç»“æœ
    .exceptionally(throwable -> {             // å¤„ç†å¼‚å¸¸
        log.error("æœç´¢æ“ä½œå¤±è´¥", throwable);
        return Collections.emptyList();
    })
    .thenAccept(results -> {                  // ä½¿ç”¨æœ€ç»ˆç»“æœ
        updateUI(results);
    });

// 2. ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†è€—æ—¶æ“ä½œ
private final ExecutorService asyncProcessor = Executors.newFixedThreadPool(10);

client.searchAsync(request, RequestOptions.DEFAULT, new ActionListener<SearchResponse>() {
    @Override
    public void onResponse(SearchResponse response) {
        // å°†è€—æ—¶æ“ä½œæäº¤åˆ°ä¸“ç”¨çº¿ç¨‹æ± 
        asyncProcessor.submit(() -> {
            processSearchResults(response);
            saveToDatabase(response);
        });
    }
    
    @Override
    public void onFailure(Exception e) {
        log.error("æœç´¢å¤±è´¥", e);
    }
});
```

### 9.4 å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–



**ğŸš€ æ€§èƒ½æå‡ç­–ç•¥**ï¼š

```java
// æ‰¹é‡å¼‚æ­¥æ“ä½œ
public CompletableFuture<List<SearchResponse>> batchSearch(List<SearchRequest> requests) {
    List<CompletableFuture<SearchResponse>> futures = requests.stream()
        .map(request -> {
            CompletableFuture<SearchResponse> future = new CompletableFuture<>();
            client.searchAsync(request, RequestOptions.DEFAULT, new ActionListener<SearchResponse>() {
                @Override
                public void onResponse(SearchResponse response) {
                    future.complete(response);
                }
                
                @Override
                public void onFailure(Exception e) {
                    future.completeExceptionally(e);
                }
            });
            return future;
        })
        .collect(Collectors.toList());
    
    // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
    return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
        .thenApply(v -> futures.stream()
            .map(CompletableFuture::join)
            .collect(Collectors.toList()));
}
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒæ˜¯"ä¸è¦é˜»å¡"ï¼Œè¦æ­£ç¡®å¤„ç†å›è°ƒï¼Œé¿å…åœ¨å›è°ƒä¸­æ‰§è¡Œè€—æ—¶æ“ä½œã€‚

---

## 10. ğŸ› ï¸ ç»¼åˆæ•…éšœæ’æŸ¥æŒ‡å—



### 10.1 æ•…éšœè¯Šæ–­æµç¨‹



**ğŸ“‹ æ ‡å‡†è¯Šæ–­æ­¥éª¤**ï¼š

```
ç¬¬ä¸€æ­¥ï¼šæ”¶é›†é”™è¯¯ä¿¡æ¯
   â†“
ç¬¬äºŒæ­¥ï¼šç¡®å®šé—®é¢˜ç±»å‹
   â†“
ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥åŸºç¡€ç¯å¢ƒ
   â†“
ç¬¬å››æ­¥ï¼šåˆ†æé…ç½®é—®é¢˜
   â†“
ç¬¬äº”æ­¥ï¼šéªŒè¯è§£å†³æ–¹æ¡ˆ
```

### 10.2 å¿«é€Ÿè¯Šæ–­æ¸…å•



**âš¡ 5åˆ†é’Ÿå¿«é€Ÿæ£€æŸ¥**ï¼š

```bash
# 1. ESæœåŠ¡çŠ¶æ€

curl -X GET "localhost:9200/_cluster/health?pretty"

# 2. èŠ‚ç‚¹ä¿¡æ¯

curl -X GET "localhost:9200/_nodes/stats/http?pretty"

# 3. ç½‘ç»œè¿é€šæ€§

telnet your-es-host 9200

# 4. æ£€æŸ¥é…ç½®

cat your-app-config.yml | grep elasticsearch

# 5. æŸ¥çœ‹æœ€è¿‘æ—¥å¿—

tail -100 your-app.log | grep -i "elasticsearch\|connection\|timeout"
```

### 10.3 å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³



**ğŸ¯ é—®é¢˜-è§£å†³å¯¹ç…§è¡¨**ï¼š

| é”™è¯¯ä¿¡æ¯ | **é—®é¢˜ç±»å‹** | **å¿«é€Ÿè§£å†³** | **è¯¦ç»†è¯´æ˜** |
|----------|-------------|-------------|-------------|
| `Connection refused` | `æœåŠ¡æœªå¯åŠ¨` | `å¯åŠ¨ESæœåŠ¡` | `æ£€æŸ¥ESè¿›ç¨‹å’Œç«¯å£` |
| `Connection pool exhausted` | `è¿æ¥æ± ä¸å¤Ÿ` | `å¢åŠ è¿æ¥æ•°` | `è°ƒæ•´maxConnections` |
| `Read timeout` | `æŸ¥è¯¢å¤ªæ…¢` | `ä¼˜åŒ–æŸ¥è¯¢` | `æ£€æŸ¥æŸ¥è¯¢å¤æ‚åº¦` |
| `Unknown host` | `åŸŸåè§£æ` | `æ£€æŸ¥DNS` | `ç¡®è®¤ESåœ°å€æ­£ç¡®` |
| `401 Unauthorized` | `è®¤è¯å¤±è´¥` | `æ£€æŸ¥ç”¨æˆ·å¯†ç ` | `ç¡®è®¤å®‰å…¨é…ç½®` |

### 10.4 ç›‘æ§å’Œé¢„é˜²



**ğŸ“Š å»ºç«‹ç›‘æ§ä½“ç³»**ï¼š

```java
// 1. è¿æ¥çŠ¶æ€ç›‘æ§
@Component
public class ElasticsearchHealthMonitor {
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkHealth() {
        try {
            ClusterHealthResponse health = client.cluster()
                .health(ClusterHealthRequest.DEFAULT, RequestOptions.DEFAULT);
            
            if (health.getStatus() != ClusterHealthStatus.GREEN) {
                log.warn("ESé›†ç¾¤çŠ¶æ€å¼‚å¸¸ï¼š{}", health.getStatus());
                // å‘é€å‘Šè­¦
                alertService.sendAlert("ESé›†ç¾¤å¥åº·æ£€æŸ¥å¤±è´¥");
            }
        } catch (Exception e) {
            log.error("æ— æ³•è¿æ¥åˆ°ESé›†ç¾¤", e);
            // å‘é€å‘Šè­¦
            alertService.sendAlert("ESè¿æ¥å¤±è´¥");
        }
    }
}

// 2. æ€§èƒ½æŒ‡æ ‡æ”¶é›†
public class ConnectionMetrics {
    private final Counter connectionCreated = Counter.build()
        .name("es_connections_created_total")
        .help("åˆ›å»ºçš„ESè¿æ¥æ•°")
        .register();
    
    private final Counter connectionFailed = Counter.build()
        .name("es_connections_failed_total")
        .help("å¤±è´¥çš„ESè¿æ¥æ•°")
        .register();
    
    private final Histogram requestDuration = Histogram.build()
        .name("es_request_duration_seconds")
        .help("ESè¯·æ±‚è€—æ—¶")
        .register();
}
```

### 10.5 åº”æ€¥å¤„ç†æ–¹æ¡ˆ



**ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†**ï¼š

```
æƒ…å†µ1ï¼šESé›†ç¾¤å®Œå…¨ä¸å¯ç”¨
â†’ å¯ç”¨é™çº§ç­–ç•¥ï¼Œè¿”å›ç¼“å­˜æ•°æ®
â†’ åˆ‡æ¢åˆ°å¤‡ç”¨æœç´¢æœåŠ¡
â†’ è”ç³»è¿ç»´äººå‘˜æ¢å¤æœåŠ¡

æƒ…å†µ2ï¼šè¿æ¥æ•°è€—å°½
â†’ é‡å¯åº”ç”¨é‡Šæ”¾è¿æ¥
â†’ ä¸´æ—¶å¢åŠ è¿æ¥æ± å¤§å°
â†’ æ’æŸ¥è¿æ¥æ³„æ¼é—®é¢˜

æƒ…å†µ3ï¼šæŸ¥è¯¢è¶…æ—¶ä¸¥é‡
â†’ å¯ç”¨æŸ¥è¯¢ç¼“å­˜
â†’ æš‚åœå¤æ‚æŸ¥è¯¢
â†’ åˆ†ææ…¢æŸ¥è¯¢åŸå› 
```

**ğŸ”§ é™çº§ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class SearchService {
    
    public List<Document> search(String keyword) {
        try {
            // æ­£å¸¸ESæœç´¢
            return elasticsearchSearch(keyword);
        } catch (Exception e) {
            log.error("ESæœç´¢å¤±è´¥ï¼Œå¯ç”¨é™çº§ç­–ç•¥", e);
            
            // é™çº§æ–¹æ¡ˆ1ï¼šè¿”å›ç¼“å­˜ç»“æœ
            List<Document> cached = cacheService.get(keyword);
            if (cached != null) {
                return cached;
            }
            
            // é™çº§æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ•°æ®åº“æœç´¢
            return databaseSearch(keyword);
        }
    }
}
```

---

# ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


- **è¿æ¥æ± **ï¼šç®¡ç†ESè¿æ¥çš„èµ„æºæ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå…³é—­è¿æ¥
- **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šå®¢æˆ·ç«¯ç‰ˆæœ¬è¦ä¸ESç‰ˆæœ¬åŒ¹é…ï¼Œé¿å…APIä¸å…¼å®¹
- **è´Ÿè½½å‡è¡¡**ï¼šå¤šèŠ‚ç‚¹åˆ†æ•£è¯·æ±‚å‹åŠ›ï¼Œæé«˜å¯ç”¨æ€§
- **è¶…æ—¶é…ç½®**ï¼šåˆç†è®¾ç½®å„ç§è¶…æ—¶æ—¶é—´ï¼Œé¿å…è¯·æ±‚å¡æ­»
- **åºåˆ—åŒ–**ï¼šæ­£ç¡®å¤„ç†æ•°æ®æ ¼å¼è½¬æ¢ï¼Œé¿å…æ ¼å¼é”™è¯¯
- **é‡è¯•æœºåˆ¶**ï¼šä¸´æ—¶æ€§å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼Œæé«˜æˆåŠŸç‡
- **è¿æ¥ç®¡ç†**ï¼šé¿å…è¿æ¥æ³„æ¼ï¼Œæ­£ç¡®é‡Šæ”¾èµ„æº

## å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ é…ç½®ä¼˜åŒ–æ€è·¯**
```
æ€§èƒ½ä¼˜å…ˆï¼šå¢åŠ è¿æ¥æ•°ï¼Œå‡å°‘è¶…æ—¶æ—¶é—´
ç¨³å®šä¼˜å…ˆï¼šä¿å®ˆé…ç½®ï¼Œå¢åŠ é‡è¯•æœºåˆ¶
èµ„æºä¼˜å…ˆï¼šæ§åˆ¶è¿æ¥æ•°ï¼ŒåŠæ—¶é‡Šæ”¾èµ„æº
```

**ğŸ”¹ æ•…éšœå¤„ç†åŸåˆ™**
```
å¿«é€Ÿå®šä½ï¼šæ”¶é›†é”™è¯¯ä¿¡æ¯ï¼Œç¡®å®šé—®é¢˜ç±»å‹
åˆ†å±‚æ’æŸ¥ï¼šç½‘ç»œâ†’é…ç½®â†’ä»£ç â†’ESæœåŠ¡
é¢„é˜²ä¸ºä¸»ï¼šç›‘æ§å‘Šè­¦ï¼Œé™çº§ç­–ç•¥
```

## å®é™…åº”ç”¨ä»·å€¼


- **æé«˜ç³»ç»Ÿç¨³å®šæ€§**ï¼šé€šè¿‡æ­£ç¡®é…ç½®é¿å…è¿æ¥é—®é¢˜
- **ä¼˜åŒ–åº”ç”¨æ€§èƒ½**ï¼šåˆç†çš„è¿æ¥æ± å’Œè¶…æ—¶é…ç½®
- **é™ä½è¿ç»´æˆæœ¬**ï¼šå‡å°‘å› è¿æ¥é—®é¢˜å¼•èµ·çš„æ•…éšœ
- **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…å› æŠ€æœ¯é—®é¢˜å½±å“ä¸šåŠ¡åŠŸèƒ½

**ğŸ¯ ä¸€å¥è¯æ€»ç»“**ï¼šå®¢æˆ·ç«¯è¿æ¥æ˜¯åº”ç”¨å’ŒESä¹‹é—´çš„æ¡¥æ¢ï¼Œé…ç½®å¥½è¿™åº§æ¡¥æ¢ï¼Œæ‰èƒ½ä¿è¯æ•°æ®ä¼ è¾“çš„ç¨³å®šå¯é ã€‚

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¿æ¥æ± è¦é…å¤Ÿï¼Œè¶…æ—¶æ—¶é—´è¦åˆç†
- ç‰ˆæœ¬è¦åŒ¹é…ï¼Œæ ¼å¼è¦æ­£ç¡®  
- å¼‚å¸¸è¦å¤„ç†ï¼Œèµ„æºè¦é‡Šæ”¾
- ç›‘æ§è¦åˆ°ä½ï¼Œé™çº§è¦å‡†å¤‡