---
title: 3、分桶聚合与分组分析
---
## 📚 目录

1. [分桶聚合基础概念](#1-分桶聚合基础概念)
2. [Terms聚合-分组统计](#2-Terms聚合-分组统计)
3. [Histogram聚合-数值分段](#3-Histogram聚合-数值分段)
4. [Date_histogram聚合-时间分段](#4-Date_histogram聚合-时间分段)
5. [Range聚合-范围分组](#5-Range聚合-范围分组)
6. [特殊场景聚合](#6-特殊场景聚合)
7. [聚合嵌套与组合](#7-聚合嵌套与组合)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🧠 分桶聚合基础概念


### 1.1 什么是分桶聚合


**通俗理解**：想象你有一堆不同颜色的玻璃球，分桶聚合就是把相同颜色的球放到不同的桶里，然后数每个桶有多少个球。

```
原始数据：🔴🔵🔴🟡🔵🔴🟡🔵
分桶结果：
红色桶：🔴🔴🔴 (3个)
蓝色桶：🔵🔵🔵 (3个)  
黄色桶：🟡🟡 (2个)
```

**专业定义**：分桶聚合（Bucket Aggregations）是将文档按照某种规则分组到不同的"桶"中，每个桶包含满足特定条件的文档集合。

### 1.2 分桶聚合的核心作用


**🎯 主要用途**：
- **数据分组**：按字段值、数值范围、时间段等分组
- **统计分析**：统计每组的文档数量、求和、平均值等
- **数据洞察**：发现数据分布规律和趋势
- **报表生成**：为图表和报表提供数据基础

**💡 生活化例子**：
```
电商网站用户行为分析：
├── 按年龄分组：18-25岁、26-35岁、36-45岁...
├── 按地区分组：北京、上海、广州、深圳...
├── 按消费金额分组：0-100元、100-500元、500-1000元...
└── 按购买时间分组：本周、本月、本季度...
```

### 1.3 分桶聚合的基本语法


```json
{
  "size": 0,
  "aggs": {
    "聚合名称": {
      "聚合类型": {
        "field": "字段名",
        "其他参数": "参数值"
      }
    }
  }
}
```

**语法说明**：
- `size: 0`：不返回具体文档，只返回聚合结果
- `aggs`：聚合查询的关键字
- `聚合名称`：自定义的聚合名称，用于结果识别
- `聚合类型`：如terms、histogram、date_histogram等

---

## 2. 📊 Terms聚合-分组统计


### 2.1 Terms聚合基本概念


**通俗解释**：Terms聚合就像给学生按班级分组一样，把相同值的文档归为一类。

**应用场景**：
- 统计不同品牌的商品数量
- 分析用户访问来源分布
- 统计文章标签热度

### 2.2 Terms聚合基础用法


**示例数据准备**：
```json
# 商品数据示例
{
  "name": "iPhone 14",
  "brand": "Apple",
  "category": "手机",
  "price": 5999,
  "sales": 150
}
```

**基础Terms聚合**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "brand_count": {
      "terms": {
        "field": "brand.keyword",
        "size": 10
      }
    }
  }
}
```

**结果解读**：
```json
{
  "aggregations": {
    "brand_count": {
      "buckets": [
        {
          "key": "Apple",
          "doc_count": 25
        },
        {
          "key": "Samsung",
          "doc_count": 18
        },
        {
          "key": "Huawei", 
          "doc_count": 12
        }
      ]
    }
  }
}
```

> 💡 **提示**：`doc_count`表示该品牌下有多少个商品

### 2.3 Terms聚合进阶参数


**🔧 重要参数详解**：

| 参数 | **作用** | **示例值** | **说明** |
|------|----------|------------|----------|
| `size` | `控制返回桶的数量` | `10` | `默认返回前10个桶` |
| `order` | `排序方式` | `{"_count": "desc"}` | `按文档数量降序` |
| `min_doc_count` | `最小文档数` | `5` | `只显示至少有5个文档的桶` |
| `include` | `包含模式` | `"App.*"` | `只包含以App开头的值` |
| `exclude` | `排除模式` | `"test.*"` | `排除以test开头的值` |

**高级Terms聚合示例**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "top_brands": {
      "terms": {
        "field": "brand.keyword",
        "size": 5,
        "order": {"_count": "desc"},
        "min_doc_count": 3,
        "exclude": ["unknown", "test.*"]
      }
    }
  }
}
```

### 2.4 Terms聚合实际应用


**📈 用户行为分析**：
```json
# 分析用户访问设备类型分布
GET /user_logs/_search
{
  "size": 0,
  "aggs": {
    "device_stats": {
      "terms": {
        "field": "device_type.keyword",
        "size": 10,
        "order": {"_count": "desc"}
      }
    }
  }
}
```

**📊 商品销售分析**：
```json
# 统计各类别商品数量
GET /products/_search
{
  "size": 0,
  "aggs": {
    "category_distribution": {
      "terms": {
        "field": "category.keyword",
        "size": 20,
        "min_doc_count": 1
      }
    }
  }
}
```

---

## 3. 📏 Histogram聚合-数值分段


### 3.1 Histogram聚合基本概念


**通俗理解**：Histogram聚合就像制作身高分布图一样，把连续的数值按照固定间隔分成若干段。

```
学生身高分布示例：
150-160cm: |||||| (6人)
160-170cm: |||||||||| (10人)
170-180cm: |||| (4人)
180-190cm: || (2人)
```

**专业说明**：Histogram聚合将数值字段按照固定的间隔进行分桶，适用于分析数值型数据的分布情况。

### 3.2 Histogram聚合基础语法


```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "price_distribution": {
      "histogram": {
        "field": "price",
        "interval": 1000
      }
    }
  }
}
```

**参数说明**：
- `field`：要分析的数值字段
- `interval`：分桶间隔（每1000元一个区间）

**结果示例**：
```json
{
  "aggregations": {
    "price_distribution": {
      "buckets": [
        {
          "key": 0,
          "doc_count": 5
        },
        {
          "key": 1000,
          "doc_count": 12
        },
        {
          "key": 2000,
          "doc_count": 8
        }
      ]
    }
  }
}
```

### 3.3 Histogram聚合高级参数


**🎛️ 重要参数配置**：

```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "price_analysis": {
      "histogram": {
        "field": "price",
        "interval": 500,
        "min_doc_count": 1,
        "extended_bounds": {
          "min": 0,
          "max": 10000
        },
        "order": {"_key": "asc"}
      }
    }
  }
}
```

**参数详解**：
- `min_doc_count`：最小文档数量，为0则显示空桶
- `extended_bounds`：扩展边界，确保显示指定范围
- `order`：排序方式，`_key`按键值排序

### 3.4 Histogram实际应用场景


**💰 商品价格分布分析**：
```json
# 分析不同价格区间的商品分布
GET /products/_search
{
  "size": 0,
  "aggs": {
    "price_segments": {
      "histogram": {
        "field": "price",
        "interval": 1000,
        "min_doc_count": 0,
        "extended_bounds": {
          "min": 0,
          "max": 20000
        }
      }
    }
  }
}
```

**📊 用户年龄分布**：
```json
# 按年龄段分析用户分布
GET /users/_search
{
  "size": 0,
  "aggs": {
    "age_groups": {
      "histogram": {
        "field": "age",
        "interval": 10,
        "min_doc_count": 1
      }
    }
  }
}
```

---

## 4. 📅 Date_histogram聚合-时间分段


### 4.1 Date_histogram基本概念


**通俗理解**：Date_histogram就像制作月历一样，把时间按照年、月、周、日等固定时间间隔进行分组。

```
网站访问量时间分布：
2024-01: ████████ (800次)
2024-02: ██████ (600次)
2024-03: ██████████ (1000次)
2024-04: ████████████ (1200次)
```

**应用场景**：
- 分析网站流量趋势
- 统计销售额时间分布
- 监控系统性能指标

### 4.2 Date_histogram基础用法


**基本语法**：
```json
GET /orders/_search
{
  "size": 0,
  "aggs": {
    "sales_over_time": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1M"
      }
    }
  }
}
```

**时间间隔选项**：

| 间隔类型 | **说明** | **示例** |
|----------|----------|----------|
| `calendar_interval` | `日历间隔` | `1M`(月), `1w`(周), `1d`(日) |
| `fixed_interval` | `固定间隔` | `30d`(30天), `12h`(12小时) |

### 4.3 常用时间间隔


**📆 Calendar Interval（日历间隔）**：
```json
{
  "date_histogram": {
    "field": "timestamp",
    "calendar_interval": "1M"  // 按自然月分组
  }
}
```

**常用calendar_interval值**：
- `1y` - 按年
- `1q` - 按季度
- `1M` - 按月
- `1w` - 按周
- `1d` - 按日

**⏰ Fixed Interval（固定间隔）**：
```json
{
  "date_histogram": {
    "field": "timestamp", 
    "fixed_interval": "30d"  // 每30天一个间隔
  }
}
```

### 4.4 Date_histogram高级配置


**🔧 完整配置示例**：
```json
GET /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1M",
        "format": "yyyy-MM",
        "time_zone": "+08:00",
        "min_doc_count": 1,
        "extended_bounds": {
          "min": "2024-01-01",
          "max": "2024-12-31"
        }
      }
    }
  }
}
```

**参数说明**：
- `format`：日期显示格式
- `time_zone`：时区设置（东八区）
- `extended_bounds`：扩展时间范围

### 4.5 实际应用案例


**📈 网站流量分析**：
```json
# 按小时统计网站访问量
GET /access_logs/_search
{
  "size": 0,
  "aggs": {
    "hourly_traffic": {
      "date_histogram": {
        "field": "@timestamp",
        "fixed_interval": "1h",
        "format": "HH:mm",
        "time_zone": "+08:00"
      }
    }
  }
}
```

**💰 销售趋势分析**：
```json
# 按月统计销售额
GET /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_revenue": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1M",
        "format": "yyyy-MM"
      },
      "aggs": {
        "total_amount": {
          "sum": {
            "field": "amount"
          }
        }
      }
    }
  }
}
```

---

## 5. 📊 Range聚合-范围分组


### 5.1 Range聚合家族概述


**Range聚合类型对比**：

| 聚合类型 | **适用数据** | **典型场景** |
|----------|-------------|-------------|
| `Range` | `数值型` | `价格区间、年龄段` |
| `Date_range` | `日期型` | `时间段、活动周期` |
| `IP_range` | `IP地址` | `IP段、地理区域` |

### 5.2 Range聚合-数值范围


**通俗理解**：Range聚合就像给商品贴价格标签一样，把商品按照自定义的价格区间进行分类。

```
商品价格分类：
经济型: 0-1000元
中档型: 1000-3000元  
高端型: 3000-10000元
奢华型: 10000元以上
```

**基础Range聚合**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "price_ranges": {
      "range": {
        "field": "price",
        "ranges": [
          {"to": 1000},
          {"from": 1000, "to": 3000},
          {"from": 3000, "to": 10000},
          {"from": 10000}
        ]
      }
    }
  }
}
```

**结果解读**：
```json
{
  "aggregations": {
    "price_ranges": {
      "buckets": [
        {
          "key": "*-1000.0",
          "to": 1000.0,
          "doc_count": 15
        },
        {
          "key": "1000.0-3000.0", 
          "from": 1000.0,
          "to": 3000.0,
          "doc_count": 25
        }
      ]
    }
  }
}
```

### 5.3 Range聚合带自定义键名


**更清晰的分组标识**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "price_categories": {
      "range": {
        "field": "price",
        "ranges": [
          {"key": "经济型", "to": 1000},
          {"key": "中档型", "from": 1000, "to": 3000},
          {"key": "高端型", "from": 3000, "to": 10000},
          {"key": "奢华型", "from": 10000}
        ]
      }
    }
  }
}
```

### 5.4 Date_range聚合-时间范围


**时间段分析**：
```json
GET /orders/_search
{
  "size": 0,
  "aggs": {
    "time_periods": {
      "date_range": {
        "field": "order_date",
        "format": "yyyy-MM-dd",
        "ranges": [
          {
            "key": "本周",
            "from": "2024-09-14",
            "to": "2024-09-20"
          },
          {
            "key": "上周", 
            "from": "2024-09-07",
            "to": "2024-09-13"
          },
          {
            "key": "上月",
            "from": "2024-08-01",
            "to": "2024-08-31"
          }
        ]
      }
    }
  }
}
```

### 5.5 IP_range聚合-IP范围


**网络区域分析**：
```json
GET /access_logs/_search
{
  "size": 0,
  "aggs": {
    "ip_regions": {
      "ip_range": {
        "field": "client_ip",
        "ranges": [
          {
            "key": "内网",
            "from": "192.168.0.0",
            "to": "192.168.255.255"
          },
          {
            "key": "北京电信",
            "from": "219.232.0.0", 
            "to": "219.232.255.255"
          }
        ]
      }
    }
  }
}
```

---

## 6. 🔍 特殊场景聚合


### 6.1 Missing聚合-缺失值统计


**应用场景**：统计哪些文档缺少某个字段值，用于数据质量分析。

**基础Missing聚合**：
```json
GET /users/_search
{
  "size": 0,
  "aggs": {
    "users_without_email": {
      "missing": {
        "field": "email"
      }
    }
  }
}
```

**结果含义**：
```json
{
  "aggregations": {
    "users_without_email": {
      "doc_count": 25  // 有25个用户没有填写邮箱
    }
  }
}
```

**📊 数据完整性分析**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "data_completeness": {
      "missing": {"field": "description"},
      "aggs": {
        "missing_desc_by_category": {
          "terms": {"field": "category.keyword"}
        }
      }
    }
  }
}
```

### 6.2 Filter聚合-条件过滤


**通俗理解**：Filter聚合就像在人群中找出符合特定条件的人，比如找出所有年龄大于30岁的用户。

**基础Filter聚合**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "expensive_products": {
      "filter": {
        "range": {
          "price": {
            "gte": 5000
          }
        }
      }
    }
  }
}
```

**嵌套统计分析**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "high_end_products": {
      "filter": {
        "range": {"price": {"gte": 5000}}
      },
      "aggs": {
        "brand_distribution": {
          "terms": {"field": "brand.keyword"}
        },
        "avg_price": {
          "avg": {"field": "price"}
        }
      }
    }
  }
}
```

### 6.3 Filters聚合-多条件过滤


**多重条件分析**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "product_segments": {
      "filters": {
        "filters": {
          "低价商品": {
            "range": {"price": {"lt": 1000}}
          },
          "中价商品": {
            "range": {"price": {"gte": 1000, "lt": 5000}}
          },
          "高价商品": {
            "range": {"price": {"gte": 5000}}
          }
        }
      }
    }
  }
}
```

### 6.4 Global聚合-全局聚合


**突破查询限制**：当你需要在特定查询结果中比较全局数据时使用。

```json
GET /products/_search
{
  "query": {
    "term": {"category.keyword": "手机"}
  },
  "size": 0,
  "aggs": {
    "phone_avg_price": {
      "avg": {"field": "price"}
    },
    "all_products": {
      "global": {},
      "aggs": {
        "global_avg_price": {
          "avg": {"field": "price"}
        }
      }
    }
  }
}
```

> 💡 **使用场景**：对比手机类商品平均价格与全部商品平均价格

---

## 7. 🔗 聚合嵌套与组合


### 7.1 聚合嵌套基本概念


**通俗理解**：聚合嵌套就像俄罗斯套娃一样，在一个聚合里面再放一个聚合，层层深入分析。

```
嵌套分析示例：
按品牌分组 → 每个品牌按价格区间分组 → 每个价格区间计算平均销量
```

### 7.2 二级嵌套聚合


**品牌+价格区间分析**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "brands": {
      "terms": {
        "field": "brand.keyword",
        "size": 5
      },
      "aggs": {
        "price_ranges": {
          "range": {
            "field": "price",
            "ranges": [
              {"key": "低价", "to": 2000},
              {"key": "中价", "from": 2000, "to": 5000},
              {"key": "高价", "from": 5000}
            ]
          },
          "aggs": {
            "avg_sales": {
              "avg": {"field": "sales"}
            }
          }
        }
      }
    }
  }
}
```

**结果结构解读**：
```json
{
  "aggregations": {
    "brands": {
      "buckets": [
        {
          "key": "Apple",
          "doc_count": 25,
          "price_ranges": {
            "buckets": [
              {
                "key": "高价",
                "from": 5000.0,
                "doc_count": 20,
                "avg_sales": {
                  "value": 150.5
                }
              }
            ]
          }
        }
      ]
    }
  }
}
```

### 7.3 多维度组合分析


**时间+地区+品牌三维分析**：
```json
GET /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_analysis": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "by_region": {
          "terms": {
            "field": "region.keyword"
          },
          "aggs": {
            "by_brand": {
              "terms": {
                "field": "brand.keyword"
              },
              "aggs": {
                "total_revenue": {
                  "sum": {"field": "amount"}
                },
                "avg_order_value": {
                  "avg": {"field": "amount"}
                }
              }
            }
          }
        }
      }
    }
  }
}
```

### 7.4 聚合管道（Pipeline Aggregations）


**基于聚合结果的二次计算**：
```json
GET /products/_search
{
  "size": 0,
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1M"
      },
      "aggs": {
        "monthly_revenue": {
          "sum": {"field": "amount"}
        }
      }
    },
    "avg_monthly_revenue": {
      "avg_bucket": {
        "buckets_path": "monthly_sales>monthly_revenue"
      }
    }
  }
}
```

> 📊 **说明**：先按月统计销售额，然后计算月销售额的平均值

### 7.5 实战综合案例


**电商平台完整分析**：
```json
GET /orders/_search
{
  "size": 0,
  "query": {
    "range": {
      "order_date": {
        "gte": "2024-01-01",
        "lte": "2024-12-31"
      }
    }
  },
  "aggs": {
    "quarterly_analysis": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "1q",
        "format": "yyyy-qq"
      },
      "aggs": {
        "total_orders": {
          "value_count": {"field": "_id"}
        },
        "total_revenue": {
          "sum": {"field": "amount"}
        },
        "avg_order_value": {
          "avg": {"field": "amount"}
        },
        "top_products": {
          "terms": {
            "field": "product_name.keyword",
            "size": 3
          },
          "aggs": {
            "product_revenue": {
              "sum": {"field": "amount"}
            }
          }
        },
        "customer_segments": {
          "range": {
            "field": "customer_age",
            "ranges": [
              {"key": "年轻用户", "to": 30},
              {"key": "中年用户", "from": 30, "to": 50},
              {"key": "中老年用户", "from": 50}
            ]
          },
          "aggs": {
            "segment_revenue": {
              "sum": {"field": "amount"}
            }
          }
        }
      }
    }
  }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


**🎯 分桶聚合本质**：
- **Terms聚合**：相同值分组，类似SQL的`GROUP BY`
- **Histogram聚合**：数值区间分组，用于连续数据分析
- **Date_histogram聚合**：时间区间分组，用于时间序列分析
- **Range聚合**：自定义范围分组，更灵活的区间设置

**📊 特殊场景聚合**：
- **Missing聚合**：找出缺失字段的文档
- **Filter/Filters聚合**：在聚合中应用查询条件
- **Global聚合**：突破查询限制，获取全局统计

### 8.2 聚合选择指南


| 数据类型 | **推荐聚合** | **使用场景** |
|----------|-------------|-------------|
| **分类数据** | `Terms聚合` | `品牌统计、地区分布` |
| **连续数值** | `Histogram聚合` | `价格分布、年龄段` |
| **时间数据** | `Date_histogram聚合` | `时间趋势、周期分析` |
| **自定义区间** | `Range聚合` | `价格档次、评分等级` |

### 8.3 性能优化要点


**🚀 提升聚合性能**：
- **合理设置size**：只取需要的桶数量
- **使用keyword字段**：text字段需要fielddata，性能差
- **设置min_doc_count**：过滤掉文档数量少的桶
- **避免深度嵌套**：嵌套层级不要超过3层

**⚠️ 常见陷阱**：
```json
// ❌ 错误：对text字段聚合
{
  "terms": {
    "field": "brand"  // text字段，性能差
  }
}

// ✅ 正确：对keyword字段聚合  
{
  "terms": {
    "field": "brand.keyword"  // keyword字段，性能好
  }
}
```

### 8.4 实际应用建议


**📈 业务场景映射**：
- **用户画像分析**：Terms聚合按年龄、地区、职业分组
- **销售趋势分析**：Date_histogram按时间维度分析
- **商品定价策略**：Range聚合分析不同价格区间表现
- **数据质量监控**：Missing聚合检查数据完整性

**🔧 开发实践**：
1. **先简单后复杂**：从单一维度聚合开始，逐步增加嵌套
2. **结果可视化**：聚合结果要能直观展示给业务人员
3. **性能监控**：关注聚合查询的执行时间
4. **缓存策略**：对于相同聚合，考虑结果缓存

**💡 记忆口诀**：
- Terms按值分，Histogram按段分
- Date_histogram时间分，Range自定义分  
- Missing找缺失，Filter加条件
- 嵌套能组合，性能要注意

**🎯 核心理解**：
分桶聚合是数据分析的基础工具，通过不同的分桶策略可以从多个维度洞察数据规律，为业务决策提供数据支撑。掌握各种聚合类型的特点和适用场景，能够灵活组合使用，是进行有效数据分析的关键。