---
title: 5、地理聚合与空间分析
---
## 📚 目录

1. [地理数据基础概念](#1-地理数据基础概念)
2. [地理坐标存储与字段类型](#2-地理坐标存储与字段类型)
3. [地理查询操作详解](#3-地理查询操作详解)
4. [地理聚合分析实战](#4-地理聚合分析实战)
5. [地理数据可视化与分析](#5-地理数据可视化与分析)
6. [性能优化与最佳实践](#6-性能优化与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌍 地理数据基础概念


### 1.1 什么是地理数据


📍 **地理数据简单理解**：
想象你用手机导航，需要知道你在哪里，要去哪里，这些位置信息就是地理数据。在Elasticsearch中，我们可以存储和分析这类位置信息。

```
现实世界的例子：
📱 美团外卖：根据你的位置推荐附近餐厅
🚗 滴滴打车：匹配附近的司机
🏨 携程酒店：显示距离景点最近的酒店
📍 朋友圈定位：显示你在哪个商场、餐厅
```

**🔸 地理数据的核心概念**：
- **坐标点**：就像地图上的一个针📍，表示具体位置
- **经纬度**：经度是东西方向，纬度是南北方向
- **距离计算**：两个位置之间有多远
- **区域范围**：比如"北京市范围内"、"距离我3公里内"

### 1.2 地理数据在实际中的应用


💼 **常见应用场景**：

```
🏪 电商平台：
问题：用户想找"附近的便利店"
解决：存储店铺坐标，根据用户位置搜索

🚚 物流系统：
问题：司机要配送最优路线
解决：分析配送点位置，规划最短路径

📊 数据分析：
问题：分析用户分布热点
解决：统计不同区域的用户密度

🏢 房产网站：
问题：找"地铁站附近的房子"
解决：存储房源和地铁站坐标，距离查询
```

---

## 2. 📍 地理坐标存储与字段类型


### 2.1 Geo_point 类型详解


🎯 **Geo_point 是什么**：
就像在地图上标记一个点，用来存储具体的坐标位置。比如你家的位置、公司的位置等。

**📊 Geo_point 存储格式**：
```json
{
  "location": {
    "lat": 39.9042,    // 纬度：北纬39.9度（北京大概位置）
    "lon": 116.4074    // 经度：东经116.4度
  }
}
```

🔧 **创建包含地理字段的索引**：
```json
PUT /restaurants
{
  "mappings": {
    "properties": {
      "name": { "type": "text" },
      "location": { "type": "geo_point" },
      "rating": { "type": "float" }
    }
  }
}
```

**💡 多种坐标格式支持**：
```json
// 格式1：对象格式（推荐）
{ "location": { "lat": 39.9042, "lon": 116.4074 } }

// 格式2：字符串格式
{ "location": "39.9042,116.4074" }

// 格式3：数组格式 [经度, 纬度]
{ "location": [116.4074, 39.9042] }

// 格式4：Geohash格式
{ "location": "wx4g0ec1" }
```

### 2.2 Geo_shape 类型详解


🗺️ **Geo_shape 是什么**：
如果说geo_point是地图上的一个点📍，那geo_shape就是地图上的一个区域🔷，比如一个商圈、一个行政区、一条路线等。

```
实际应用理解：
📍 geo_point：某个商店的具体位置
🔷 geo_shape：整个商圈的范围、配送区域的边界
```

**🔧 创建geo_shape字段**：
```json
PUT /delivery_zones
{
  "mappings": {
    "properties": {
      "zone_name": { "type": "text" },
      "coverage_area": { "type": "geo_shape" }
    }
  }
}
```

**🗺️ 常用的shape类型**：
```json
// 点 - Point
{
  "coverage_area": {
    "type": "point",
    "coordinates": [116.4074, 39.9042]
  }
}

// 圆形区域 - Circle
{
  "coverage_area": {
    "type": "circle",
    "coordinates": [116.4074, 39.9042],
    "radius": "5km"
  }
}

// 多边形区域 - Polygon
{
  "coverage_area": {
    "type": "polygon",
    "coordinates": [[
      [116.3, 39.9],
      [116.5, 39.9], 
      [116.5, 40.0],
      [116.3, 40.0],
      [116.3, 39.9]
    ]]
  }
}
```

---

## 3. 🔍 地理查询操作详解


### 3.1 地理距离查询 (Geo_distance)


🎯 **距离查询的作用**：
就像问"我附近500米有什么餐厅？"，根据距离远近来筛选数据。

**📱 基础距离查询示例**：
```json
GET /restaurants/_search
{
  "query": {
    "geo_distance": {
      "distance": "1km",           // 距离范围
      "location": {               // 中心点位置
        "lat": 39.9042,
        "lon": 116.4074
      }
    }
  }
}
```

🧠 **记忆要点**：`geo_distance` = "地理距离"，三要素：**中心点 + 距离范围 + 字段名**

**💡 实用距离查询技巧**：
```json
// 距离排序：最近的在前面
GET /restaurants/_search
{
  "query": {
    "geo_distance": {
      "distance": "5km",
      "location": "39.9042,116.4074"
    }
  },
  "sort": [
    {
      "_geo_distance": {
        "location": "39.9042,116.4074",
        "order": "asc",           // 按距离升序
        "unit": "m"              // 单位：米
      }
    }
  ]
}
```

### 3.2 地理边界查询 (Geo_bounding_box)


📦 **边界查询的概念**：
想象一个矩形框，查询这个框里面的所有数据点。就像在地图上画一个方框，找框内的所有商店。

```
直观理解：
    top (上边界)
left ┌─────────┐ right
     │    📍   │  (边界框)
     │  📍 📍  │
     └─────────┘
   bottom (下边界)
```

**🔧 边界查询实现**：
```json
GET /restaurants/_search
{
  "query": {
    "geo_bounding_box": {
      "location": {
        "top_left": {           // 左上角坐标
          "lat": 40.0,
          "lon": 116.3
        },
        "bottom_right": {       // 右下角坐标
          "lat": 39.8,
          "lon": 116.5
        }
      }
    }
  }
}
```

💡 **边界查询使用场景**：
- **地图缩放**：用户拖拽地图时，查询当前显示区域内的数据
- **行政区划**：查询某个区县范围内的商户
- **配送范围**：查询配送区域内的订单

### 3.3 地理多边形查询 (Geo_polygon)


🔺 **多边形查询理解**：
如果边界查询是矩形框，多边形查询就是可以画任意形状的框，比如行政区划的复杂边界。

```json
GET /restaurants/_search
{
  "query": {
    "geo_polygon": {
      "location": {
        "points": [              // 多边形的各个顶点
          {"lat": 40.0, "lon": 116.3},
          {"lat": 40.1, "lon": 116.4},
          {"lat": 39.9, "lon": 116.5},
          {"lat": 39.8, "lon": 116.3}
        ]
      }
    }
  }
}
```

---

## 4. 📊 地理聚合分析实战


### 4.1 Geo_distance 聚合分析


🎯 **距离聚合的作用**：
把数据按距离远近分组统计，比如统计"1公里内有多少餐厅"、"1-3公里内有多少"。

```
现实应用场景：
🏪 分析用户分布：0-1km: 100人, 1-5km: 300人, 5km+: 50人
📊 配送数据统计：近距离配送 vs 远距离配送的订单量对比
```

**📈 距离聚合查询实现**：
```json
GET /restaurants/_search
{
  "size": 0,                    // 不返回具体文档，只要聚合结果
  "aggs": {
    "distance_ranges": {
      "geo_distance": {
        "field": "location",
        "origin": "39.9042,116.4074",    // 中心点
        "ranges": [
          { "to": 1000 },               // 0-1km
          { "from": 1000, "to": 3000 }, // 1-3km  
          { "from": 3000, "to": 5000 }, // 3-5km
          { "from": 5000 }              // 5km以上
        ]
      }
    }
  }
}
```

🔍 **聚合结果解读**：
```json
{
  "aggregations": {
    "distance_ranges": {
      "buckets": [
        {
          "key": "*-1000.0",     // 0-1km范围
          "from": 0.0,
          "to": 1000.0,
          "doc_count": 15        // 这个范围内有15家餐厅
        },
        {
          "key": "1000.0-3000.0", // 1-3km范围
          "from": 1000.0,
          "to": 3000.0,
          "doc_count": 32         // 这个范围内有32家餐厅
        }
      ]
    }
  }
}
```

### 4.2 Geo_hash_grid 聚合分析


🔲 **Geohash网格聚合理解**：
把地图按网格划分，统计每个网格里有多少数据。就像把地图切成豆腐块，数每块里有多少个点。

```
网格划分概念：
┌────┬────┬────┐
│ 5  │ 3  │ 1  │  数字表示该网格内的数据点数量
├────┼────┼────┤
│ 12 │ 8  │ 4  │
├────┼────┼────┤
│ 7  │ 15 │ 6  │
└────┴────┴────┘
```

**🗺️ Geohash网格聚合实现**：
```json
GET /restaurants/_search
{
  "size": 0,
  "aggs": {
    "restaurant_grid": {
      "geohash_grid": {
        "field": "location",
        "precision": 6           // 网格精度，数字越大网格越小
      }
    }
  }
}
```

📊 **精度等级理解**：
| 精度值 | 网格大小 | 实际应用 |
|-------|---------|----------|
| 1-3 | 很大(国家级) | 🌍 全球数据分析 |
| 4-6 | 中等(城市级) | 🏙️ 城市热力图 |
| 7-9 | 较小(街区级) | 🏘️ 社区分析 |
| 10+ | 很小(建筑级) | 🏢 精确定位 |

### 4.3 Geo_bounds 聚合分析


📐 **边界聚合的作用**：
找出所有数据点的边界范围，就像给所有点画一个"最小包围盒"。

```json
GET /restaurants/_search
{
  "size": 0,
  "aggs": {
    "map_bounds": {
      "geo_bounds": {
        "field": "location"
      }
    }
  }
}
```

💡 **边界聚合的应用场景**：
- **地图自适应**：自动调整地图显示范围，刚好包含所有数据点
- **数据范围分析**：了解数据的地理分布范围
- **区域规划**：确定服务覆盖的最大范围

### 4.4 Geo_centroid 聚合分析


📍 **中心点聚合理解**：
计算所有数据点的"重心"，就像找平衡点一样。

```json
GET /restaurants/_search
{
  "size": 0,
  "aggs": {
    "center_point": {
      "geo_centroid": {
        "field": "location"
      }
    }
  }
}
```

🎯 **中心点聚合应用**：
- **集中趋势分析**：业务主要集中在哪个区域
- **新店选址**：基于现有店铺分布确定新店位置
- **配送中心规划**：确定最优的仓库位置

---

## 5. 📊 地理数据可视化与分析


### 5.1 热力图分析实现


🔥 **热力图的概念**：
用颜色深浅表示数据密度，颜色越深（热）的地方数据越多，就像显示"人流量热点"。

```
热力图效果示意：
🟦🟦🟨🟨🟨  (蓝色=数据少，黄色=数据中等)
🟦🟨🟨🟧🟧  (橙色=数据较多，红色=数据最多)
🟨🟨🟧🟧🟥
🟨🟧🟧🟥🟥
🟧🟧🟥🟥🟥
```

**📈 热力图数据聚合**：
```json
GET /user_checkins/_search
{
  "size": 0,
  "aggs": {
    "heatmap": {
      "geohash_grid": {
        "field": "location",
        "precision": 7
      },
      "aggs": {
        "checkin_count": {
          "value_count": {
            "field": "user_id"
          }
        }
      }
    }
  }
}
```

### 5.2 GPS轨迹分析


🛣️ **轨迹分析应用场景**：
- **外卖配送**：分析配送员的行驶路线，优化配送效率
- **用户行为**：分析用户的移动模式和活动范围
- **车辆监控**：实时跟踪车辆位置和行驶轨迹

**🚗 轨迹数据存储结构**：
```json
{
  "driver_id": "D001",
  "timestamp": "2024-01-15T10:30:00",
  "location": {
    "lat": 39.9042,
    "lon": 116.4074
  },
  "speed": 35,              // 速度 km/h
  "heading": 90             // 行驶方向
}
```

**📊 轨迹分析查询**：
```json
// 查询某司机某时间段的轨迹
GET /driver_tracks/_search
{
  "query": {
    "bool": {
      "must": [
        { "term": { "driver_id": "D001" } },
        {
          "range": {
            "timestamp": {
              "gte": "2024-01-15T09:00:00",
              "lte": "2024-01-15T18:00:00"
            }
          }
        }
      ]
    }
  },
  "sort": [{ "timestamp": "asc" }]
}
```

### 5.3 地理围栏功能


🚧 **地理围栏概念**：
设定一个虚拟的地理边界，当目标进入或离开这个区域时触发相应动作。

```
应用场景举例：
🏫 学校围栏：学生进出校园自动签到
🏭 工厂围栏：员工进入危险区域自动报警
🚛 物流围栏：货车进入配送区域自动通知
```

**🔧 围栏设置和检测**：
```json
// 设置围栏区域
PUT /geofences/school_area
{
  "name": "学校围栏",
  "boundary": {
    "type": "circle",
    "coordinates": [116.4074, 39.9042],
    "radius": "500m"
  }
}

// 检测是否在围栏内
GET /student_locations/_search
{
  "query": {
    "geo_distance": {
      "distance": "500m",
      "location": {
        "lat": 39.9042,
        "lon": 116.4074
      }
    }
  }
}
```

---

## 6. ⚡ 性能优化与最佳实践


### 6.1 地理查询性能优化


📈 **性能优化核心原则**：

🔸 **索引优化策略**：
```json
PUT /restaurants
{
  "settings": {
    "index": {
      "number_of_shards": 3,
      "number_of_replicas": 1
    }
  },
  "mappings": {
    "properties": {
      "location": {
        "type": "geo_point",
        "doc_values": true,      // 启用doc_values提升聚合性能
        "index": true           // 启用索引提升查询性能
      }
    }
  }
}
```

🔸 **查询优化技巧**：
```json
// 优化1：使用filter而不是query（不计算相关性分数）
{
  "query": {
    "bool": {
      "filter": [              // 使用filter性能更好
        {
          "geo_distance": {
            "distance": "5km",
            "location": "39.9042,116.4074"
          }
        }
      ]
    }
  }
}

// 优化2：合理设置size限制
{
  "size": 100,               // 限制返回结果数量
  "query": { ... }
}
```

### 6.2 数据存储优化


💾 **存储优化建议**：

📊 **数据压缩与精度平衡**：
| 场景类型 | 精度需求 | 存储建议 | 应用示例 |
|---------|---------|----------|----------|
| 🏪 商户定位 | 高精度(米级) | 完整经纬度 | 导航、外卖 |
| 📊 用户分析 | 中精度(百米级) | 降低小数位 | 数据统计 |
| 🗺️ 区域分析 | 低精度(公里级) | Geohash编码 | 热力图 |

```json
// 根据应用场景选择合适的存储方式
{
  "precise_location": {         // 高精度存储
    "type": "geo_point",
    "lat": 39.904200123,
    "lon": 116.407400567
  },
  "approx_location": {          // 中精度存储
    "type": "geo_point", 
    "lat": 39.9042,
    "lon": 116.4074
  },
  "region_code": "wx4g0ec1"     // 低精度Geohash
}
```

### 6.3 监控与调优


📊 **性能监控指标**：

🔍 **关键监控项目**：
- **查询响应时间**：地理查询的平均耗时
- **聚合性能**：大规模地理聚合的执行时间
- **内存使用**：地理数据缓存占用情况
- **磁盘IO**：地理索引的读写性能

```json
// 查询性能分析
GET /restaurants/_search
{
  "profile": true,            // 开启性能分析
  "query": {
    "geo_distance": {
      "distance": "5km",
      "location": "39.9042,116.4074"
    }
  }
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


✅ **地理数据类型理解**：
```
🔸 geo_point：存储具体坐标点(餐厅位置、用户位置)
🔸 geo_shape：存储区域形状(配送范围、行政区划)
🔸 坐标格式：经纬度 [经度, 纬度] 的顺序要记住
🔸 距离单位：支持 m(米)、km(公里)、mi(英里) 等
```

✅ **核心查询操作**：
```
🔸 geo_distance：距离范围查询 "附近XX公里"
🔸 geo_bounding_box：矩形区域查询 "这个框内的数据"
🔸 geo_polygon：多边形区域查询 "不规则区域内的数据"
```

✅ **聚合分析掌握**：
```
🔸 geo_distance聚合：按距离分组统计
🔸 geohash_grid聚合：网格热力图分析
🔸 geo_bounds聚合：找出数据边界范围
🔸 geo_centroid聚合：计算数据中心点
```

### 7.2 实际应用价值


💼 **业务场景应用**：
- **O2O平台**：基于位置的商户推荐和搜索
- **物流配送**：配送路线优化和区域分析
- **数据分析**：用户地理分布和行为模式分析
- **智能推荐**：基于地理位置的个性化推荐

🛠️ **技术实践要点**：
- **数据建模**：根据业务需求选择合适的地理字段类型
- **查询优化**：使用filter提升地理查询性能
- **聚合分析**：结合业务场景设计有价值的地理统计
- **可视化展示**：将地理聚合结果用于地图和图表展示

### 7.3 学习检查点


✅ **基础掌握检查**：
- [ ] 能创建包含地理字段的索引映射
- [ ] 能执行基本的距离查询和范围查询
- [ ] 理解不同地理数据类型的应用场景
- [ ] 掌握基本的地理聚合操作

✅ **进阶应用检查**：
- [ ] 能设计复杂的地理聚合分析
- [ ] 能优化地理查询的性能
- [ ] 理解地理围栏和轨迹分析的实现
- [ ] 能结合业务需求进行地理数据建模

🧠 **核心记忆口诀**：
- **geo_point存坐标，geo_shape存区域**
- **distance查距离，bounds找边界**
- **聚合看分布，优化提性能**
- **经纬度顺序，先经后纬要记清**

🎯 **实战能力目标**：
通过本章学习，你应该能够独立完成基于地理位置的搜索功能开发，包括附近商户查询、配送范围分析、用户分布统计等常见的地理数据分析需求。