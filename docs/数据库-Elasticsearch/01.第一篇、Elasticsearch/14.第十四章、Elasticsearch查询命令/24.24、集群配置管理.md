---
title: 24、集群配置管理
---
## 📚 目录

1. [集群配置管理概述](#1-集群配置管理概述)
2. [集群设置基础操作](#2-集群设置基础操作)
3. [节点配置管理](#3-节点配置管理)
4. [安全设置管理](#4-安全设置管理)
5. [投票配置管理](#5-投票配置管理)
6. [实战应用场景](#6-实战应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🏗️ 集群配置管理概述


### 1.1 什么是集群配置管理


**🔸 通俗理解**
```
集群配置管理就像是管理一个大公司的各种规章制度：

现实中的公司管理：
- 制定公司规章制度
- 调整部门工作流程  
- 管理员工权限设置
- 处理紧急情况配置

Elasticsearch集群管理：
- 设置集群运行参数
- 调整节点工作方式
- 管理安全访问配置
- 处理集群异常情况
```

**💡 核心作用**
- **动态调整**：运行时修改集群行为，无需重启
- **统一管理**：所有节点共享相同的集群级别配置
- **安全控制**：管理访问权限和安全设置
- **性能优化**：根据实际情况调整性能参数

### 1.2 配置管理的重要性


**🎯 为什么需要配置管理**
```
问题场景：
❌ 集群运行缓慢，需要调整性能参数
❌ 磁盘空间不足，需要调整分片分配策略
❌ 安全配置需要更新，但不想重启服务
❌ 新节点加入集群，需要调整投票配置

解决方案：
✅ 使用动态配置管理快速调整
✅ 实时生效，无需服务中断
✅ 集群范围内统一配置
✅ 安全可控的配置变更
```

---

## 2. ⚙️ 集群设置基础操作


### 2.1 查看集群设置


#### 🔍 基础查看命令


**查看当前集群设置**
```bash
# 查看所有集群设置
GET /_cluster/settings

# 实际含义：查看集群当前的所有配置参数
# 就像查看公司的所有规章制度
```

**响应示例解读**
```json
{
  "persistent": {
    "cluster": {
      "max_shards_per_node": "1000"
    }
  },
  "transient": {
    "cluster": {
      "routing": {
        "allocation": {
          "enable": "all"
        }
      }
    }
  }
}
```

**🔸 配置类型说明**
```
persistent（持久化配置）：
- 重启后仍然保留
- 适用于长期的配置变更
- 优先级高于默认配置

transient（临时配置）：
- 重启后会丢失
- 适用于临时调试或测试
- 优先级最高，会覆盖persistent配置
```

#### 📊 扁平化查看设置


**扁平化显示配置**
```bash
# 以扁平化格式查看设置
GET /_cluster/settings?flat_settings=true

# 作用：将嵌套的JSON结构展平显示
# 更容易查看和理解配置路径
```

**扁平化响应示例**
```json
{
  "persistent": {
    "cluster.max_shards_per_node": "1000",
    "cluster.routing.allocation.disk.threshold.enabled": "true"
  },
  "transient": {
    "cluster.routing.allocation.enable": "all"
  }
}
```

**💡 实用技巧**
- 扁平化格式便于复制配置路径
- 适合在脚本中使用配置项
- 清晰显示配置的完整路径

#### 🔧 包含默认设置


**查看包含默认值的完整设置**
```bash
# 查看所有设置，包括默认值
GET /_cluster/settings?include_defaults=true

# 用途：了解所有可配置项及其默认值
# 帮助理解系统的完整配置情况
```

### 2.2 修改集群设置


#### ⚡ 基础设置命令


**动态修改集群设置**
```bash
# 基本语法
PUT /_cluster/settings
{
  "persistent": {
    "配置项": "配置值"
  }
}

# 实际示例：调整每个节点最大分片数
PUT /_cluster/settings
{
  "persistent": {
    "cluster.max_shards_per_node": "2000"
  }
}
```

**🎯 常用集群设置示例**
```bash
# 1. 调整分片分配设置
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "all",
    "cluster.routing.allocation.node_concurrent_recoveries": "4"
  }
}

# 2. 设置磁盘水位线
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.disk.threshold.enabled": true,
    "cluster.routing.allocation.disk.watermark.low": "85%",
    "cluster.routing.allocation.disk.watermark.high": "90%"
  }
}
```

**📈 配置解释**
```
cluster.max_shards_per_node: 
- 含义：每个节点最多能容纳多少个分片
- 作用：防止单个节点分片过多影响性能

cluster.routing.allocation.enable:
- all: 允许分配所有类型的分片
- primaries: 只允许分配主分片
- none: 禁止分片分配

cluster.routing.allocation.disk.watermark:
- low: 磁盘使用率达到此值时停止分配新分片
- high: 磁盘使用率达到此值时开始迁移分片
```

#### 🔄 临时配置与持久配置


**临时配置示例**
```bash
# 临时禁用分片分配（重启后恢复默认）
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.enable": "none"
  }
}

# 使用场景：
# - 集群维护期间临时禁用分片移动
# - 调试问题时临时修改配置
# - 测试新配置的效果
```

**持久配置示例**
```bash
# 永久调整集群性能参数
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.node_concurrent_recoveries": "6",
    "cluster.routing.allocation.cluster_concurrent_rebalance": "4"
  }
}

# 使用场景：
# - 生产环境的长期配置调整
# - 性能优化配置
# - 安全相关的配置
```

---

## 3. 🖥️ 节点配置管理


### 3.1 查看节点设置


**查看所有节点的配置**
```bash
# 获取集群中所有节点的配置信息
GET /_nodes/settings

# 作用：查看每个节点的具体配置
# 有助于排查节点间的配置差异
```

**💡 实用场景**
```
使用场景：
1. 检查节点配置一致性
2. 排查某个节点的配置问题
3. 了解节点的硬件配置情况
4. 验证配置更改是否生效
```

### 3.2 节点配置最佳实践


**🔸 重要配置项说明**
```bash
# 节点角色配置
node.roles: ["master", "data", "ingest"]

# 节点名称和集群名称
node.name: "es-node-1"
cluster.name: "my-cluster"

# 内存设置
ES_JAVA_OPTS: "-Xms2g -Xmx2g"

# 网络设置
network.host: "192.168.1.100"
http.port: 9200
transport.port: 9300
```

**📊 配置优化建议**
```
性能优化配置：
✅ 堆内存设置为物理内存的50%，但不超过32GB
✅ 禁用swap：bootstrap.memory_lock: true
✅ 增加文件描述符限制：至少65536
✅ 调整线程池大小：根据CPU核心数设置

安全性配置：
✅ 设置cluster.name避免意外加入其他集群
✅ 配置network.host限制访问来源
✅ 启用安全插件进行身份验证
```

---

## 4. 🔐 安全设置管理


### 4.1 重载安全设置


**动态重载安全配置**
```bash
# 重新加载安全设置（无需重启）
POST /_cluster/nodes/_reload_secure_settings

# 使用场景：
# - 更新了keystore中的密码
# - 修改了SSL证书
# - 更新了云服务的访问密钥
```

**🔄 重载流程说明**
```
安全设置重载过程：

1. 准备阶段：
   └── 更新elasticsearch.keystore文件
   └── 确保所有节点都有最新的安全配置

2. 执行重载：
   └── 发送重载命令到集群
   └── 各节点读取新的安全配置

3. 验证阶段：
   └── 检查重载是否成功
   └── 测试新配置是否生效
```

### 4.2 安全配置最佳实践


**常见安全配置项**
```bash
# 1. 启用SSL/TLS
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# 2. 配置用户认证
xpack.security.authc.realms.native.native1.order: 0

# 3. 设置角色和权限
PUT /_security/role/my_admin_role
{
  "cluster": ["all"],
  "indices": [
    {
      "names": ["*"],
      "privileges": ["all"]
    }
  ]
}
```

**🛡️ 安全管理技巧**
```
keystore管理：
- 使用elasticsearch-keystore工具管理敏感信息
- 定期轮换密钥和证书
- 确保keystore文件的权限设置正确

访问控制：
- 设置适当的用户角色和权限
- 使用最小权限原则
- 定期审核用户权限
```

---

## 5. 🗳️ 投票配置管理


### 5.1 投票配置基础


**🔸 什么是投票配置**
```
投票配置就像是公司董事会的组成：

现实中的董事会：
- 决定公司重大决策
- 某些成员可能临时无法参与
- 需要保证有足够的人参与决策

Elasticsearch投票配置：
- 决定集群的主节点选举
- 某些节点可能临时下线
- 需要保证集群的稳定运行
```

### 5.2 投票排除管理


**添加投票排除**
```bash
# 排除特定节点参与投票（维护时使用）
PUT /_cluster/voting_config_exclusions?node_names=node-1,node-2

# 使用场景：
# - 节点维护前排除投票权
# - 问题节点临时隔离
# - 集群拓扑变更时的安全操作
```

**删除投票排除**
```bash
# 恢复节点的投票权限
DELETE /_cluster/voting_config_exclusions

# 执行时机：
# - 节点维护完成后
# - 确认节点运行正常后
# - 集群拓扑变更完成后
```

**⚠️ 投票配置注意事项**
```
安全操作流程：

1. 维护前准备：
   ├── 检查集群健康状态
   ├── 确认有足够的投票节点在线
   └── 添加投票排除配置

2. 执行维护：
   ├── 安全关闭需要维护的节点
   ├── 执行必要的维护操作
   └── 重新启动节点

3. 维护后清理：
   ├── 确认节点重新加入集群
   ├── 检查集群状态正常
   └── 删除投票排除配置
```

---

## 6. 🚀 实战应用场景


### 6.1 集群性能优化场景


**场景：集群性能缓慢**
```bash
# 步骤1：诊断问题
GET /_cluster/health
GET /_cluster/stats
GET /_nodes/stats

# 步骤2：优化配置
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.node_concurrent_recoveries": "8",
    "cluster.routing.allocation.cluster_concurrent_rebalance": "6",
    "indices.recovery.max_bytes_per_sec": "100mb"
  }
}

# 步骤3：验证效果
GET /_cluster/pending_tasks
GET /_cat/recovery?v
```

**💡 性能优化要点**
```
常见性能瓶颈及解决方案：

1. 分片分配慢：
   ├── 增加concurrent_recoveries
   ├── 调整recovery速度限制
   └── 优化磁盘IO性能

2. 查询响应慢：
   ├── 检查分片分布是否均匀
   ├── 调整refresh间隔
   └── 优化查询语句

3. 索引写入慢：
   ├── 增加bulk线程池大小
   ├── 调整refresh_interval
   └── 优化文档结构
```

### 6.2 集群维护场景


**场景：节点滚动重启维护**
```bash
# 步骤1：禁用分片分配
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "primaries"
  }
}

# 步骤2：执行维护操作
# （重启节点、更新配置等）

# 步骤3：恢复分片分配
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.enable": "all"
  }
}

# 步骤4：检查集群恢复
GET /_cluster/health?wait_for_status=green&timeout=30s
```

### 6.3 紧急故障处理场景


**场景：磁盘空间不足**
```bash
# 步骤1：紧急调整磁盘水位线
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.disk.watermark.low": "95%",
    "cluster.routing.allocation.disk.watermark.high": "98%",
    "cluster.routing.allocation.disk.watermark.flood_stage": "99%"
  }
}

# 步骤2：清理旧数据或扩容

# 步骤3：恢复正常水位线
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.disk.watermark.low": null,
    "cluster.routing.allocation.disk.watermark.high": null,
    "cluster.routing.allocation.disk.watermark.flood_stage": null
  }
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心命令


```
🔸 基础查看命令
GET /_cluster/settings                    # 查看集群设置
GET /_cluster/settings?flat_settings=true # 扁平化查看
GET /_nodes/settings                      # 查看节点设置

🔸 配置修改命令  
PUT /_cluster/settings                    # 修改集群设置
POST /_cluster/nodes/_reload_secure_settings # 重载安全设置

🔸 投票管理命令
PUT /_cluster/voting_config_exclusions    # 添加投票排除
DELETE /_cluster/voting_config_exclusions # 删除投票排除
```

### 7.2 配置管理最佳实践


**🔹 配置变更原则**
```
安全性原则：
- 重要配置变更前先在测试环境验证
- 使用transient配置进行临时测试
- 确认效果后再改为persistent配置

监控原则：
- 配置变更后持续监控集群状态
- 记录配置变更的时间和原因
- 准备回滚方案应对异常情况
```

**🔹 常用配置场景**
```
性能优化：
- 调整分片分配并发数
- 设置磁盘水位线
- 优化恢复速度限制

维护操作：
- 禁用分片分配进行维护
- 排除节点投票权限
- 重载安全配置

故障处理：
- 紧急调整资源限制
- 临时禁用某些功能
- 快速恢复集群服务
```

### 7.3 实际应用价值


**💼 业务场景应用**
- **运维管理**：动态调整集群参数，无需重启服务
- **性能优化**：根据业务负载实时调整配置
- **故障处理**：快速应对各种紧急情况
- **安全管理**：动态更新安全配置和权限

**🔧 运维实践**
- **配置标准化**：建立配置管理规范和最佳实践
- **监控告警**：监控关键配置项的变化
- **自动化管理**：通过脚本实现常见配置操作
- **文档记录**：详细记录配置变更历史和原因

**核心记忆口诀**：
```
🧠 集群配置要记牢，动态调整很重要
   persistent长期用，transient临时好
   安全设置要重载，投票排除维护保
   性能优化看监控，故障处理要趁早
```