---
title: 13ã€èšåˆæŸ¥è¯¢å‘½ä»¤
---
## ğŸ“š ç›®å½•

1. [èšåˆæŸ¥è¯¢åŸºç¡€æ¦‚å¿µ](#1-èšåˆæŸ¥è¯¢åŸºç¡€æ¦‚å¿µ)
2. [åŸºç¡€èšåˆæŸ¥è¯¢å‘½ä»¤](#2-åŸºç¡€èšåˆæŸ¥è¯¢å‘½ä»¤)
3. [æ¡¶èšåˆè¯¦è§£](#3-æ¡¶èšåˆè¯¦è§£)
4. [æŒ‡æ ‡èšåˆè¯¦è§£](#4-æŒ‡æ ‡èšåˆè¯¦è§£)
5. [å¤šçº§èšåˆæ“ä½œ](#5-å¤šçº§èšåˆæ“ä½œ)
6. [ç®¡é“èšåˆé«˜çº§ç”¨æ³•](#6-ç®¡é“èšåˆé«˜çº§ç”¨æ³•)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ èšåˆæŸ¥è¯¢åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯èšåˆæŸ¥è¯¢


**ç®€å•ç†è§£**ï¼šèšåˆå°±æ˜¯æŠŠæ•°æ®"å½’ç±»æ•´ç†"å’Œ"ç»Ÿè®¡è®¡ç®—"çš„è¿‡ç¨‹

```
æƒ³è±¡ä¸€ä¸ªç”µå•†ç½‘ç«™çš„è®¢å•æ•°æ®ï¼š
åŸå§‹æ•°æ®ï¼šè®¢å•1ã€è®¢å•2ã€è®¢å•3...
èšåˆåï¼š
â€¢ æŒ‰åœ°åŒºåˆ†ç»„ï¼šåŒ—äº¬æœ‰100å•ï¼Œä¸Šæµ·æœ‰80å•
â€¢ ç»Ÿè®¡æ€»æ•°ï¼šæ€»å…±500å•
â€¢ è®¡ç®—å¹³å‡ï¼šå¹³å‡é‡‘é¢1200å…ƒ
```

**ğŸ”¸ èšåˆçš„æœ¬è´¨ä½œç”¨**
- **æ•°æ®åˆ†ç»„**ï¼šæŠŠç›¸ä¼¼çš„æ•°æ®æ”¾åœ¨ä¸€èµ·
- **ç»Ÿè®¡è®¡ç®—**ï¼šå¯¹åˆ†ç»„åçš„æ•°æ®è¿›è¡Œæ•°å­¦è¿ç®—
- **è¶‹åŠ¿åˆ†æ**ï¼šå‘ç°æ•°æ®ä¸­çš„è§„å¾‹å’Œè¶‹åŠ¿
- **æŠ¥è¡¨ç”Ÿæˆ**ï¼šä¸ºä¸šåŠ¡å†³ç­–æä¾›æ•°æ®æ”¯æ’‘

### 1.2 èšåˆæŸ¥è¯¢çš„ä¸‰å¤§ç±»å‹


**ğŸ“Š èšåˆç±»å‹å¯¹æ¯”è¡¨**

| èšåˆç±»å‹ | **é€šä¿—è§£é‡Š** | **ä¸»è¦ç”¨é€”** | **å…¸å‹ç¤ºä¾‹** |
|---------|------------|-------------|-------------|
| ğŸª£ **æ¡¶èšåˆ** | `æ•°æ®åˆ†ç»„ï¼ŒæŠŠç›¸ä¼¼æ•°æ®æ”¾ä¸€èµ·` | `åˆ†ç±»ç»Ÿè®¡` | `æŒ‰å¹´é¾„æ®µåˆ†ç»„ã€æŒ‰åœ°åŒºåˆ†ç»„` |
| ğŸ“ˆ **æŒ‡æ ‡èšåˆ** | `æ•°å­¦è®¡ç®—ï¼Œæ±‚å’Œå¹³å‡æœ€å¤§æœ€å°` | `æ•°å€¼ç»Ÿè®¡` | `æ€»é”€å”®é¢ã€å¹³å‡ä»·æ ¼ã€æœ€é«˜åˆ†æ•°` |
| ğŸ”„ **ç®¡é“èšåˆ** | `å¯¹èšåˆç»“æœå†æ¬¡å¤„ç†` | `äºŒæ¬¡è®¡ç®—` | `ç¯æ¯”å¢é•¿ç‡ã€ç§»åŠ¨å¹³å‡` |

### 1.3 èšåˆæŸ¥è¯¢çš„åŸºæœ¬è¯­æ³•ç»“æ„


```json
{
  "aggs": {                    // èšåˆæŸ¥è¯¢çš„å…³é”®å­—
    "èšåˆåç§°": {               // è‡ªå®šä¹‰çš„èšåˆåå­—
      "èšåˆç±»å‹": {             // termsã€avgã€sumç­‰
        "field": "å­—æ®µå"      // è¦èšåˆçš„å­—æ®µ
      }
    }
  }
}
```

**ğŸ”¸ è¯­æ³•è¯´æ˜**
- `aggs` æˆ– `aggregations`ï¼šå‘Šè¯‰ESè¿™æ˜¯èšåˆæŸ¥è¯¢
- `èšåˆåç§°`ï¼šä½ ç»™è¿™ä¸ªèšåˆèµ·çš„åå­—ï¼Œç»“æœä¸­ä¼šç”¨åˆ°
- `èšåˆç±»å‹`ï¼šå…·ä½“è¦åšä»€ä¹ˆæ“ä½œï¼ˆåˆ†ç»„ã€æ±‚å’Œç­‰ï¼‰
- `field`ï¼šå¯¹å“ªä¸ªå­—æ®µè¿›è¡Œèšåˆ

---

## 2. ğŸš€ åŸºç¡€èšåˆæŸ¥è¯¢å‘½ä»¤


### 2.1 æœ€åŸºç¡€çš„èšåˆæŸ¥è¯¢


**å‘½ä»¤æ ¼å¼**ï¼š`POST /{index}/_search`

```bash
# åŸºç¡€èšåˆæŸ¥è¯¢ - ç»Ÿè®¡å•†å“åˆ†ç±»æ•°é‡
POST /products/_search
{
  "size": 0,                    # ä¸è¿”å›åŸå§‹æ–‡æ¡£ï¼Œåªè¦èšåˆç»“æœ
  "aggs": {
    "category_count": {         # èšåˆåç§°
      "terms": {                # åˆ†ç»„èšåˆ
        "field": "category.keyword"
      }
    }
  }
}
```

**ğŸ”¸ å‘½ä»¤è§£æ**
- `size: 0`ï¼šåªè¦èšåˆç»“æœï¼Œä¸è¦åŸå§‹æ•°æ®ï¼ˆèŠ‚çœä¼ è¾“ï¼‰
- `terms`ï¼šæŒ‰å­—æ®µå€¼åˆ†ç»„ï¼Œç›¸å½“äºSQLçš„GROUP BY
- `category.keyword`ï¼šå¯¹categoryå­—æ®µçš„keywordç±»å‹è¿›è¡Œåˆ†ç»„

### 2.2 ä»…è·å–èšåˆç»“æœçš„æŸ¥è¯¢


**å‘½ä»¤æ ¼å¼**ï¼š`GET /{index}/_search?size=0`

```bash
# é€šè¿‡URLå‚æ•°è®¾ç½®åªè¿”å›èšåˆç»“æœ
GET /orders/_search?size=0
{
  "aggs": {
    "monthly_sales": {
      "date_histogram": {       # æ—¶é—´åˆ†ç»„èšåˆ
        "field": "order_date",
        "calendar_interval": "month"
      }
    }
  }
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦è®¾ç½®size=0ï¼Ÿ**
```
ä¸è®¾ç½®size=0çš„æƒ…å†µï¼š
â€¢ è¿”å›èšåˆç»“æœ + å‰10æ¡åŸå§‹æ–‡æ¡£
â€¢ æ•°æ®ä¼ è¾“é‡å¤§ï¼Œå“åº”æ…¢

è®¾ç½®size=0çš„æƒ…å†µï¼š
â€¢ åªè¿”å›èšåˆç»“æœ
â€¢ æ•°æ®ä¼ è¾“é‡å°ï¼Œå“åº”å¿«
â€¢ é€‚åˆçº¯ç»Ÿè®¡åˆ†æåœºæ™¯
```

### 2.3 å­—æ®µèƒ½åŠ›æŸ¥è¯¢å‘½ä»¤


**å‘½ä»¤æ ¼å¼**ï¼š`GET /{index}/_field_caps`

```bash
# æŸ¥è¯¢å­—æ®µçš„èšåˆèƒ½åŠ›
GET /products/_field_caps?fields=price,category,create_time
```

**ğŸ”¸ è¿”å›ç»“æœç¤ºä¾‹**
```json
{
  "fields": {
    "price": {
      "long": {
        "searchable": true,
        "aggregatable": true    # å¯ä»¥èšåˆ
      }
    },
    "category": {
      "text": {
        "searchable": true,
        "aggregatable": false   # textç±»å‹ä¸èƒ½ç›´æ¥èšåˆ
      },
      "keyword": {
        "searchable": true,
        "aggregatable": true    # keywordç±»å‹å¯ä»¥èšåˆ
      }
    }
  }
}
```

---

## 3. ğŸª£ æ¡¶èšåˆè¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯æ¡¶èšåˆ


**é€šä¿—ç†è§£**ï¼šæ¡¶èšåˆå°±åƒæ˜¯"åˆ†æ‹£é‚®ä»¶"

```
åŸå§‹æ•°æ®ï¼š           åˆ†æ‹£åï¼ˆæ¡¶èšåˆï¼‰ï¼š
é‚®ä»¶1-åŒ—äº¬           â”Œâ”€åŒ—äº¬æ¡¶â”€â”    â”Œâ”€ä¸Šæµ·æ¡¶â”€â”
é‚®ä»¶2-ä¸Šæµ·     â†’     â”‚é‚®ä»¶1  â”‚    â”‚é‚®ä»¶2  â”‚
é‚®ä»¶3-åŒ—äº¬           â”‚é‚®ä»¶3  â”‚    â”‚é‚®ä»¶5  â”‚
é‚®ä»¶4-å¹¿å·           â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜
é‚®ä»¶5-ä¸Šæµ·           â”Œâ”€å¹¿å·æ¡¶â”€â”
                     â”‚é‚®ä»¶4  â”‚
                     â””â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Termsèšåˆ - æŒ‰å€¼åˆ†ç»„


```bash
# ç»Ÿè®¡æ¯ä¸ªå•†å“åˆ†ç±»çš„æ•°é‡
POST /products/_search
{
  "size": 0,
  "aggs": {
    "popular_categories": {
      "terms": {
        "field": "category.keyword",
        "size": 10                    # è¿”å›å‰10ä¸ªåˆ†ç»„
      }
    }
  }
}
```

**ğŸ”¸ å¸¸ç”¨å‚æ•°**
- `size`ï¼šè¿”å›å¤šå°‘ä¸ªæ¡¶ï¼ˆé»˜è®¤10ä¸ªï¼‰
- `order`ï¼šæ’åºæ–¹å¼
- `min_doc_count`ï¼šæœ€å°æ–‡æ¡£æ•°é‡è¿‡æ»¤

### 3.3 Rangeèšåˆ - æŒ‰èŒƒå›´åˆ†ç»„


```bash
# æŒ‰ä»·æ ¼åŒºé—´åˆ†ç»„ç»Ÿè®¡
POST /products/_search
{
  "size": 0,
  "aggs": {
    "price_ranges": {
      "range": {
        "field": "price",
        "ranges": [
          { "to": 100 },           # 0-100
          { "from": 100, "to": 500 }, # 100-500
          { "from": 500 }          # 500ä»¥ä¸Š
        ]
      }
    }
  }
}
```

### 3.4 Date Histogramèšåˆ - æ—¶é—´åˆ†ç»„


```bash
# æŒ‰æœˆç»Ÿè®¡è®¢å•æ•°é‡
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_orders": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month",
        "format": "yyyy-MM"
      }
    }
  }
}
```

**ğŸ”¸ æ—¶é—´é—´éš”é€‰é¡¹**
- `day`ã€`week`ã€`month`ã€`year`ï¼šæ—¥å†é—´éš”
- `1h`ã€`30m`ã€`1d`ï¼šå›ºå®šé—´éš”
- `format`ï¼šæ§åˆ¶æ—¶é—´æ˜¾ç¤ºæ ¼å¼

---

## 4. ğŸ“ˆ æŒ‡æ ‡èšåˆè¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯æŒ‡æ ‡èšåˆ


**é€šä¿—ç†è§£**ï¼šæŒ‡æ ‡èšåˆå°±æ˜¯"æ•°å­¦è®¡ç®—å™¨"

```
æœ‰ä¸€å †å•†å“ä»·æ ¼ï¼š[100, 200, 150, 300, 250]

æŒ‡æ ‡èšåˆçš„ä½œç”¨ï¼š
â€¢ sumï¼šæ€»å’Œ = 100+200+150+300+250 = 1000
â€¢ avgï¼šå¹³å‡ = 1000Ã·5 = 200
â€¢ maxï¼šæœ€å¤§ = 300
â€¢ minï¼šæœ€å° = 100
â€¢ countï¼šæ•°é‡ = 5
```

### 4.2 åŸºç¡€æŒ‡æ ‡èšåˆ


```bash
# è®¡ç®—å•†å“ä»·æ ¼çš„å„ç§ç»Ÿè®¡æŒ‡æ ‡
POST /products/_search
{
  "size": 0,
  "aggs": {
    "price_stats": {
      "stats": {                # ä¸€æ¬¡æ€§è®¡ç®—å¤šä¸ªæŒ‡æ ‡
        "field": "price"
      }
    },
    "total_sales": {
      "sum": {                  # æ€»é”€å”®é¢
        "field": "sales_amount"
      }
    },
    "avg_price": {
      "avg": {                  # å¹³å‡ä»·æ ¼
        "field": "price"
      }
    },
    "max_price": {
      "max": {                  # æœ€é«˜ä»·æ ¼
        "field": "price"
      }
    }
  }
}
```

### 4.3 ç™¾åˆ†ä½æ•°èšåˆ


```bash
# è®¡ç®—ä»·æ ¼çš„ç™¾åˆ†ä½æ•°åˆ†å¸ƒ
POST /products/_search
{
  "size": 0,
  "aggs": {
    "price_percentiles": {
      "percentiles": {
        "field": "price",
        "percents": [25, 50, 75, 90, 95, 99]
      }
    }
  }
}
```

**ğŸ’¡ ç™¾åˆ†ä½æ•°çš„å«ä¹‰**
```
P50ï¼ˆä¸­ä½æ•°ï¼‰ï¼š50%çš„å•†å“ä»·æ ¼ä½äºè¿™ä¸ªå€¼
P90ï¼š90%çš„å•†å“ä»·æ ¼ä½äºè¿™ä¸ªå€¼
P99ï¼š99%çš„å•†å“ä»·æ ¼ä½äºè¿™ä¸ªå€¼

å®é™…åº”ç”¨ï¼š
â€¢ P50ï¼šäº†è§£ä»·æ ¼ä¸­ä½æ•°
â€¢ P90ï¼šè¯†åˆ«é«˜ä»·å•†å“
â€¢ P99ï¼šå‘ç°æç«¯ä»·æ ¼
```

### 4.4 å»é‡è®¡æ•°èšåˆ


```bash
# ç»Ÿè®¡ä¸é‡å¤çš„å®¢æˆ·æ•°é‡
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "unique_customers": {
      "cardinality": {          # å»é‡è®¡æ•°
        "field": "customer_id"
      }
    }
  }
}
```

---

## 5. ğŸ”— å¤šçº§èšåˆæ“ä½œ


### 5.1 ä»€ä¹ˆæ˜¯å¤šçº§èšåˆ


**é€šä¿—ç†è§£**ï¼šå¤šçº§èšåˆå°±åƒ"å¥—å¨ƒ"ï¼Œä¸€å±‚å¥—ä¸€å±‚

```
æ•°æ®æµå‘å›¾ï¼š
åŸå§‹æ•°æ® â†’ ç¬¬ä¸€çº§åˆ†ç»„ â†’ ç¬¬äºŒçº§åˆ†ç»„ â†’ è®¡ç®—æŒ‡æ ‡

å®ä¾‹ï¼š
è®¢å•æ•°æ® â†’ æŒ‰åœ°åŒºåˆ†ç»„ â†’ æŒ‰æœˆä»½åˆ†ç»„ â†’ è®¡ç®—é”€å”®é¢

ç»“æœç»“æ„ï¼š
åŒ—äº¬
â”œâ”€â”€ 2024-01: é”€å”®é¢10ä¸‡
â”œâ”€â”€ 2024-02: é”€å”®é¢12ä¸‡
â””â”€â”€ 2024-03: é”€å”®é¢15ä¸‡
ä¸Šæµ·
â”œâ”€â”€ 2024-01: é”€å”®é¢8ä¸‡
â”œâ”€â”€ 2024-02: é”€å”®é¢9ä¸‡
â””â”€â”€ 2024-03: é”€å”®é¢11ä¸‡
```

### 5.2 ä¸¤çº§èšåˆç¤ºä¾‹


```bash
# æŒ‰åœ°åŒºå’Œæœˆä»½ç»Ÿè®¡é”€å”®æƒ…å†µ
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "by_region": {              # ç¬¬ä¸€çº§ï¼šæŒ‰åœ°åŒºåˆ†ç»„
      "terms": {
        "field": "region.keyword"
      },
      "aggs": {                 # åµŒå¥—èšåˆ
        "monthly_sales": {      # ç¬¬äºŒçº§ï¼šæŒ‰æœˆä»½åˆ†ç»„
          "date_histogram": {
            "field": "order_date",
            "calendar_interval": "month"
          },
          "aggs": {             # å†æ¬¡åµŒå¥—
            "total_amount": {   # ç¬¬ä¸‰çº§ï¼šè®¡ç®—é”€å”®é¢
              "sum": {
                "field": "amount"
              }
            }
          }
        }
      }
    }
  }
}
```

### 5.3 å¤æ‚å¤šçº§èšåˆ


```bash
# å•†å“åˆ†æï¼šåˆ†ç±» â†’ ä»·æ ¼åŒºé—´ â†’ ç»Ÿè®¡æŒ‡æ ‡
POST /products/_search
{
  "size": 0,
  "aggs": {
    "by_category": {
      "terms": {
        "field": "category.keyword"
      },
      "aggs": {
        "price_ranges": {
          "range": {
            "field": "price",
            "ranges": [
              { "key": "ä½ä»·", "to": 100 },
              { "key": "ä¸­ä»·", "from": 100, "to": 500 },
              { "key": "é«˜ä»·", "from": 500 }
            ]
          },
          "aggs": {
            "stats": {
              "stats": {
                "field": "sales_count"
              }
            }
          }
        }
      }
    }
  }
}
```

---

## 6. ğŸ”„ ç®¡é“èšåˆé«˜çº§ç”¨æ³•


### 6.1 ä»€ä¹ˆæ˜¯ç®¡é“èšåˆ


**é€šä¿—ç†è§£**ï¼šç®¡é“èšåˆæ˜¯"äºŒæ¬¡åŠ å·¥"

```
ç”Ÿäº§æµæ°´çº¿æ¯”å–»ï¼š
åŸæ–™ â†’ ç¬¬ä¸€é“å·¥åº â†’ ç¬¬äºŒé“å·¥åº â†’ æˆå“

èšåˆç®¡é“ï¼š
åŸå§‹æ•°æ® â†’ åŸºç¡€èšåˆ â†’ ç®¡é“èšåˆ â†’ æœ€ç»ˆç»“æœ

å®ä¾‹ï¼š
è®¢å•æ•°æ® â†’ æŒ‰æœˆç»Ÿè®¡é”€å”®é¢ â†’ è®¡ç®—ç¯æ¯”å¢é•¿ç‡
```

### 6.2 Bucket Script - æ¡¶è„šæœ¬è®¡ç®—


```bash
# è®¡ç®—æ¯æœˆçš„åˆ©æ¶¦ç‡
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_data": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month"
      },
      "aggs": {
        "total_revenue": {       # æ€»æ”¶å…¥
          "sum": { "field": "revenue" }
        },
        "total_cost": {          # æ€»æˆæœ¬
          "sum": { "field": "cost" }
        },
        "profit_margin": {       # åˆ©æ¶¦ç‡è®¡ç®—
          "bucket_script": {
            "buckets_path": {
              "revenue": "total_revenue",
              "cost": "total_cost"
            },
            "script": "(params.revenue - params.cost) / params.revenue * 100"
          }
        }
      }
    }
  }
}
```

### 6.3 Moving Average - ç§»åŠ¨å¹³å‡


```bash
# è®¡ç®—é”€å”®é¢çš„3ä¸ªæœˆç§»åŠ¨å¹³å‡
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": { "field": "amount" }
        }
      }
    },
    "sales_moving_avg": {
      "moving_avg": {
        "buckets_path": "monthly_sales>sales",
        "window": 3,            # 3ä¸ªæœˆçª—å£
        "model": "simple"       # ç®€å•ç§»åŠ¨å¹³å‡
      }
    }
  }
}
```

### 6.4 Derivative - è®¡ç®—å˜åŒ–ç‡


```bash
# è®¡ç®—æœˆåº¦é”€å”®é¢çš„ç¯æ¯”å˜åŒ–
POST /orders/_search
{
  "size": 0,
  "aggs": {
    "monthly_sales": {
      "date_histogram": {
        "field": "order_date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": { "field": "amount" }
        },
        "sales_change": {        # ç¯æ¯”å˜åŒ–
          "derivative": {
            "buckets_path": "sales"
          }
        }
      }
    }
  }
}
```

---

## 7. ğŸ¯ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 ç”µå•†ä¸šåŠ¡åˆ†æåœºæ™¯


**ğŸ“Š å•†å“é”€å”®åˆ†æ**
```bash
# ç»¼åˆå•†å“åˆ†ææŠ¥è¡¨
POST /products/_search
{
  "size": 0,
  "aggs": {
    "category_analysis": {
      "terms": {
        "field": "category.keyword",
        "size": 10
      },
      "aggs": {
        "avg_price": {          # å¹³å‡ä»·æ ¼
          "avg": { "field": "price" }
        },
        "total_sales": {        # æ€»é”€é‡
          "sum": { "field": "sales_count" }
        },
        "price_distribution": { # ä»·æ ¼åˆ†å¸ƒ
          "histogram": {
            "field": "price",
            "interval": 100
          }
        }
      }
    }
  }
}
```

### 7.2 ç”¨æˆ·è¡Œä¸ºåˆ†æåœºæ™¯


**ğŸ“ˆ ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ**
```bash
# ç”¨æˆ·è®¿é—®æ—¶æ®µåˆ†æ
POST /user_logs/_search
{
  "size": 0,
  "aggs": {
    "hourly_activity": {
      "date_histogram": {
        "field": "timestamp",
        "calendar_interval": "hour"
      },
      "aggs": {
        "unique_users": {       # ç‹¬ç«‹ç”¨æˆ·æ•°
          "cardinality": {
            "field": "user_id"
          }
        },
        "page_views": {         # é¡µé¢æµè§ˆé‡
          "value_count": {
            "field": "page_url"
          }
        }
      }
    }
  }
}
```

### 7.3 æ€§èƒ½ç›‘æ§åœºæ™¯


**âš¡ ç³»ç»Ÿæ€§èƒ½åˆ†æ**
```bash
# APIå“åº”æ—¶é—´åˆ†æ
POST /api_logs/_search
{
  "size": 0,
  "aggs": {
    "by_endpoint": {
      "terms": {
        "field": "endpoint.keyword"
      },
      "aggs": {
        "response_time_stats": {
          "percentiles": {
            "field": "response_time",
            "percents": [50, 90, 95, 99]
          }
        },
        "error_rate": {
          "filter": {
            "range": {
              "status_code": { "gte": 400 }
            }
          }
        }
      }
    }
  }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ èšåˆæœ¬è´¨ï¼šæ•°æ®åˆ†ç»„ + ç»Ÿè®¡è®¡ç®—
ğŸ”¸ ä¸‰å¤§ç±»å‹ï¼šæ¡¶èšåˆ(åˆ†ç»„) + æŒ‡æ ‡èšåˆ(è®¡ç®—) + ç®¡é“èšåˆ(äºŒæ¬¡å¤„ç†)
ğŸ”¸ è¯­æ³•ç»“æ„ï¼šaggs + èšåˆåç§° + èšåˆç±»å‹ + å­—æ®µé…ç½®
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨size=0åªè¿”å›èšåˆç»“æœ
ğŸ”¸ å¤šçº§åµŒå¥—ï¼šé€šè¿‡aggsåµŒå¥—å®ç°å¤æ‚åˆ†æ
```

### 8.2 å¸¸ç”¨èšåˆå‘½ä»¤é€ŸæŸ¥


| èšåˆç±»å‹ | **å‘½ä»¤** | **ç”¨é€”** | **ç¤ºä¾‹åœºæ™¯** |
|---------|---------|---------|-------------|
| ğŸª£ **terms** | `"terms": {"field": "category.keyword"}` | `æŒ‰å€¼åˆ†ç»„` | `å•†å“åˆ†ç±»ç»Ÿè®¡` |
| ğŸ“ˆ **sum** | `"sum": {"field": "amount"}` | `æ±‚å’Œè®¡ç®—` | `æ€»é”€å”®é¢` |
| ğŸ“Š **avg** | `"avg": {"field": "price"}` | `å¹³å‡å€¼` | `å¹³å‡ä»·æ ¼` |
| ğŸ“… **date_histogram** | `"date_histogram": {"field": "date"}` | `æ—¶é—´åˆ†ç»„` | `æŒ‰æœˆç»Ÿè®¡` |
| ğŸ“ˆ **stats** | `"stats": {"field": "score"}` | `ç»¼åˆç»Ÿè®¡` | `ä¸€æ¬¡æ€§è·å–å¤šä¸ªæŒ‡æ ‡` |
| ğŸ”¢ **cardinality** | `"cardinality": {"field": "user_id"}` | `å»é‡è®¡æ•°` | `ç‹¬ç«‹ç”¨æˆ·æ•°` |

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼åŸåˆ™


**ğŸ”¹ é€‰æ‹©åˆé€‚çš„èšåˆç±»å‹**
```
éœ€è¦åˆ†ç»„åˆ†ç±» â†’ ä½¿ç”¨æ¡¶èšåˆï¼ˆtermsã€rangeã€date_histogramï¼‰
éœ€è¦æ•°å€¼è®¡ç®— â†’ ä½¿ç”¨æŒ‡æ ‡èšåˆï¼ˆsumã€avgã€maxã€minï¼‰
éœ€è¦é«˜çº§åˆ†æ â†’ ä½¿ç”¨ç®¡é“èšåˆï¼ˆderivativeã€moving_avgï¼‰
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
å¤§æ•°æ®é‡æŸ¥è¯¢ï¼š
â€¢ è®¾ç½® size: 0 åªè¿”å›èšåˆç»“æœ
â€¢ åˆç†è®¾ç½®èšåˆçš„ size å‚æ•°
â€¢ ä½¿ç”¨è¿‡æ»¤å™¨ç¼©å°æ•°æ®èŒƒå›´
â€¢ é¿å…è¿‡æ·±çš„åµŒå¥—èšåˆ

å­—æ®µé€‰æ‹©æ³¨æ„ï¼š
â€¢ textå­—æ®µä¸èƒ½ç›´æ¥èšåˆï¼Œè¦ç”¨keyword
â€¢ æ•°å€¼å­—æ®µé€‚åˆæŒ‡æ ‡èšåˆ
â€¢ æ—¥æœŸå­—æ®µé€‚åˆæ—¶é—´åˆ†ç»„èšåˆ
```

**ğŸ”¹ å¸¸è§é”™è¯¯é¿å…**
```
âŒ é”™è¯¯ï¼šå¯¹textå­—æ®µè¿›è¡Œtermsèšåˆ
âœ… æ­£ç¡®ï¼šå¯¹keywordå­—æ®µè¿›è¡Œtermsèšåˆ

âŒ é”™è¯¯ï¼šèšåˆåµŒå¥—å±‚çº§è¿‡æ·±ï¼ˆè¶…è¿‡3å±‚ï¼‰
âœ… æ­£ç¡®ï¼šåˆç†è§„åˆ’èšåˆå±‚çº§ï¼Œæ³¨æ„æ€§èƒ½

âŒ é”™è¯¯ï¼šè¿”å›å¤§é‡åŸå§‹æ–‡æ¡£å½±å“æ€§èƒ½
âœ… æ­£ç¡®ï¼šèšåˆæŸ¥è¯¢æ—¶è®¾ç½®size=0
```

### 8.4 å­¦ä¹ è¿›é˜¶è·¯çº¿


**ğŸ“š æŒæ¡é¡ºåºå»ºè®®**
1. **åŸºç¡€æ¦‚å¿µ** â†’ ç†è§£èšåˆçš„ä½œç”¨å’Œåˆ†ç±»
2. **ç®€å•èšåˆ** â†’ æŒæ¡termsã€sumã€avgç­‰åŸºç¡€èšåˆ
3. **æ—¶é—´èšåˆ** â†’ å­¦ä¼šdate_histogramæ—¶é—´åˆ†ç»„
4. **å¤šçº§èšåˆ** â†’ ç†è§£åµŒå¥—èšåˆçš„é€»è¾‘
5. **ç®¡é“èšåˆ** â†’ æŒæ¡é«˜çº§åˆ†ææ–¹æ³•
6. **å®æˆ˜åº”ç”¨** â†’ ç»“åˆä¸šåŠ¡åœºæ™¯ç»ƒä¹ 

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- èšåˆæŸ¥è¯¢æ˜¯ESçš„æ•°æ®åˆ†æåˆ©å™¨ï¼ŒæŒæ¡å®ƒå°±èƒ½åšå„ç§ç»Ÿè®¡æŠ¥è¡¨
- æ¡¶èšåˆè´Ÿè´£åˆ†ç»„ï¼ŒæŒ‡æ ‡èšåˆè´Ÿè´£è®¡ç®—ï¼Œç®¡é“èšåˆè´Ÿè´£é«˜çº§å¤„ç†
- å¤šçº§èšåˆé€šè¿‡åµŒå¥—å®ç°å¤æ‚åˆ†æï¼Œä½†è¦æ³¨æ„æ€§èƒ½å½±å“
- åˆç†ä½¿ç”¨size=0å’Œå­—æ®µç±»å‹é€‰æ‹©ï¼Œèƒ½æ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½