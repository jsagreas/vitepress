---
title: 2、节点管理与信息查询
---
## 📚 目录

1. [节点管理基础概念](#1-节点管理基础概念)
2. [节点信息查询命令](#2-节点信息查询命令)
3. [节点统计与监控](#3-节点统计与监控)
4. [节点管理操作](#4-节点管理操作)
5. [实战应用场景](#5-实战应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🌐 节点管理基础概念


### 1.1 什么是Elasticsearch节点


**🔸 通俗理解**
```
把Elasticsearch想象成一个图书馆系统：
- 整个图书馆 = ES集群
- 每个分馆 = ES节点
- 每个书架 = 索引
- 每本书 = 文档
```

**💡 节点的本质**
- **节点（Node）**：就是运行Elasticsearch的一台服务器
- **作用**：存储数据、处理搜索请求、参与集群协调
- **特点**：每个节点都有唯一的名称和ID

### 1.2 节点类型说明


```
📊 ES节点类型对比表

节点类型          |  主要职责               |  通俗比喻
----------------|----------------------|------------------
主节点(Master)   |  管理集群状态、协调操作    |  图书馆馆长
数据节点(Data)   |  存储数据、执行搜索       |  书库管理员  
协调节点(Coord)  |  转发请求、聚合结果       |  前台接待员
摄取节点(Ingest) |  数据预处理             |  图书分类员
```

**🎯 为什么要了解节点**
- **性能优化**：了解哪个节点负载高
- **故障排查**：快速定位问题节点
- **容量规划**：合理分配资源
- **集群扩展**：决定何时添加节点

---

## 2. 🔍 节点信息查询命令


### 2.1 查看所有节点基本信息


**🔧 GET /_nodes**

```bash
# 获取所有节点的详细信息
GET /_nodes

# 只获取特定信息
GET /_nodes?filter_path=nodes.*.name,nodes.*.ip
```

**📋 返回信息解读**
```json
{
  "nodes": {
    "节点ID": {
      "name": "节点名称",           // 节点的显示名称
      "transport_address": "IP:端口", // 节点通信地址
      "host": "主机名",             // 主机名
      "ip": "IP地址",               // IP地址
      "version": "7.10.0",         // ES版本
      "roles": ["master", "data"]   // 节点角色
    }
  }
}
```

**💡 实际应用场景**
- **集群巡检**：查看所有节点是否正常
- **版本检查**：确认集群版本一致性
- **角色确认**：了解节点分工

### 2.2 友好格式查看节点


**🔧 GET /_cat/nodes?v**

```bash
# 表格形式查看节点（推荐新手使用）
GET /_cat/nodes?v

# 查看特定字段
GET /_cat/nodes?v&h=name,ip,heap.percent,ram.percent,cpu,load_1m,master
```

**📊 输出示例解读**
```
ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
10.0.0.1           45          67   2    0.12    0.15     0.18 dilm      *      node-1
10.0.0.2           38          52   1    0.08    0.12     0.15 dilm      -      node-2
```

**🔍 字段含义说明**
- **heap.percent**：Java堆内存使用率（**重要监控指标**）
- **ram.percent**：系统内存使用率
- **cpu**：CPU使用率
- **load_1m**：1分钟平均负载
- **master**：`*`表示主节点，`-`表示非主节点
- **node.role**：节点角色（d=data, i=ingest, l=ml, m=master）

**⚠️ 关键监控阈值**
```
堆内存使用率 > 80%  →  需要关注，可能有内存压力
堆内存使用率 > 90%  →  警告，可能影响性能
CPU使用率 > 80%     →  节点负载较高
负载值 > CPU核心数   →  系统繁忙
```

---

## 3. 📊 节点统计与监控


### 3.1 节点统计信息


**🔧 GET /_nodes/stats**

```bash
# 获取所有节点统计信息
GET /_nodes/stats

# 获取特定节点统计
GET /_nodes/node-1/stats

# 只获取JVM统计
GET /_nodes/stats/jvm

# 获取多个指标
GET /_nodes/stats/jvm,os,process
```

**📈 统计信息分类**
```
🔸 JVM统计
- 堆内存使用情况
- 垃圾回收次数和时间
- 线程数量

🔸 操作系统统计  
- CPU使用率
- 内存使用情况
- 文件描述符

🔸 进程统计
- 进程CPU时间
- 内存使用
- 文件句柄数

🔸 传输统计
- 网络发送/接收字节数
- 连接数量

🔸 HTTP统计
- HTTP请求总数
- 当前打开连接数
```

### 3.2 节点热线程分析


**🔧 GET /_nodes/hot_threads**

```bash
# 查看消耗CPU最多的线程
GET /_nodes/hot_threads

# 查看特定节点的热线程
GET /_nodes/node-1/hot_threads

# 指定采样参数
GET /_nodes/hot_threads?threads=5&interval=500ms&snapshots=10
```

**🎯 使用场景**
- **性能问题排查**：CPU使用率突然升高
- **慢查询定位**：某些搜索请求特别慢
- **系统调优**：优化线程池配置

**📋 输出解读示例**
```
::: {node-1}{X1bOl2vBQdmA}{127.0.0.1}{127.0.0.1:9300}
Hot threads at 2024-01-20T10:30:00.000Z, interval=500ms, batchCount=10, exact=true:

99.8% (499.1ms out of 500ms) cpu usage by thread 'elasticsearch[node-1][search][T#1]'
  10/10 snapshots sharing following 3 elements
    app//org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:456)
    app//org.elasticsearch.search.SearchService.lambda$executeQueryPhase$0(SearchService.java:234)
```

**💡 关键信息解读**
- **99.8% CPU使用率**：这个线程占用了几乎所有CPU
- **search线程**：说明是搜索操作引起的
- **executeQueryPhase**：具体在执行查询阶段

### 3.3 节点使用情况统计


**🔧 GET /_nodes/usage**

```bash
# 查看节点功能使用情况
GET /_nodes/usage

# 查看特定节点
GET /_nodes/node-1/usage
```

**📊 返回信息说明**
```json
{
  "nodes": {
    "节点ID": {
      "timestamp": 1642665000000,
      "since": 1642620000000,        // 统计开始时间
      "rest_actions": {              // REST API使用统计
        "nodes_info_action": 15,     // 查看节点信息的次数
        "search_action": 1024,       // 搜索请求次数
        "index_action": 256          // 索引请求次数
      }
    }
  }
}
```

**🎯 实际应用**
- **API使用分析**：了解哪些功能使用频繁
- **性能优化**：识别热点操作
- **监控告警**：设置使用量阈值

---

## 4. ⚙️ 节点管理操作


### 4.1 重载安全设置


**🔧 POST /_cluster/nodes/_reload_secure_settings**

```bash
# 重载所有节点的安全设置
POST /_cluster/nodes/_reload_secure_settings
{
  "secure_settings_password": "密码"
}

# 重载特定节点
POST /_cluster/nodes/node-1/_reload_secure_settings
```

**🔒 使用场景**
- **密码更新**：更改keystore中的密码
- **证书更新**：SSL证书变更
- **配置热更新**：不重启节点更新安全配置

**⚠️ 注意事项**
```
🔸 只能重载keystore中的设置
🔸 需要提供keystore密码
🔸 某些设置仍需重启节点
🔸 建议在维护窗口期操作
```

### 4.2 节点关闭操作


**🔧 POST /_nodes/{node_id}/_shutdown**

```bash
# 优雅关闭指定节点（仅在特定版本支持）
POST /_nodes/node-1/_shutdown
```

**🚨 重要提醒**
```
节点关闭是危险操作！
- 会导致数据暂时不可用
- 可能触发分片重新分配
- 建议先排空节点数据
- 确保集群有足够的副本
```

**🔄 正确的节点下线流程**
```
步骤1: 停止分配分片到该节点
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.exclude._name": "node-1"
  }
}

步骤2: 等待分片迁移完成
GET /_cat/shards?v

步骤3: 确认节点无分片后关闭
POST /_nodes/node-1/_shutdown
```

---

## 5. 🎯 实战应用场景


### 5.1 日常集群巡检


**📋 巡检清单**
```bash
# 1. 检查所有节点状态
GET /_cat/nodes?v

# 2. 检查节点角色分配
GET /_cat/nodes?v&h=name,node.role,master

# 3. 检查资源使用情况
GET /_cat/nodes?v&h=name,heap.percent,ram.percent,cpu,load_1m

# 4. 检查磁盘使用
GET /_cat/nodes?v&h=name,disk.used_percent
```

**🚨 告警阈值参考**
```
⚠️  警告级别
- 堆内存使用率 > 75%
- CPU使用率 > 70%
- 磁盘使用率 > 80%

🔥 严重级别  
- 堆内存使用率 > 90%
- CPU使用率 > 90%
- 磁盘使用率 > 95%
```

### 5.2 性能问题排查


**🔍 排查步骤**
```bash
# 1. 确定问题节点
GET /_cat/nodes?v&s=cpu:desc

# 2. 查看热线程
GET /_nodes/problem-node/hot_threads

# 3. 检查详细统计
GET /_nodes/problem-node/stats

# 4. 查看JVM状态
GET /_nodes/problem-node/stats/jvm
```

### 5.3 集群扩容准备


**📊 容量评估**
```bash
# 1. 查看当前节点负载
GET /_cat/nodes?v&h=name,heap.percent,cpu,load_1m

# 2. 查看磁盘使用情况
GET /_cat/allocation?v

# 3. 评估数据分布
GET /_cat/shards?v&h=index,shard,prirep,node

# 4. 检查索引大小
GET /_cat/indices?v&h=index,store.size,docs.count
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的命令


**🔸 日常监控三剑客**
```bash
GET /_cat/nodes?v                    # 节点状态总览
GET /_nodes/stats                    # 详细统计信息  
GET /_nodes/hot_threads              # 性能问题排查
```

### 6.2 监控重点指标


**📊 关键监控指标**
```
🔸 堆内存使用率
- 正常：< 75%
- 警告：75% - 90%  
- 危险：> 90%

🔸 CPU使用率
- 正常：< 70%
- 警告：70% - 90%
- 危险：> 90%

🔸 磁盘使用率
- 正常：< 80%
- 警告：80% - 95%
- 危险：> 95%
```

### 6.3 实践建议


**✅ 最佳实践**
- **定期巡检**：每日检查节点状态
- **设置监控**：配置自动化监控告警
- **容量规划**：提前评估扩容需求
- **优雅下线**：遵循正确的节点下线流程

**❌ 常见误区**
- 直接杀进程关闭节点
- 忽略堆内存使用率告警
- 不了解节点角色就删除节点
- 在高峰期进行节点维护

**🎯 学习重点**
- 理解节点在集群中的作用
- 掌握基本的监控命令
- 学会读懂统计信息
- 熟悉安全的节点管理操作

**记忆口诀**：
```
节点管理要细心，状态监控是核心
堆内存、CPU、磁盘空间
三大指标时刻看
热线程帮你找问题，统计信息看详情
安全操作最重要，优雅下线保数据
```