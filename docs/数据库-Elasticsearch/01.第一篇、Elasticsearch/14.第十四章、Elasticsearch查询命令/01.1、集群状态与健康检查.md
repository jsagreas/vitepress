---
title: 1、集群状态与健康检查
---
## 📚 目录

1. [集群健康状态监控](#1-集群健康状态监控)
2. [集群信息查看](#2-集群信息查看)
3. [节点管理与监控](#3-节点管理与监控)
4. [集群设置与配置](#4-集群设置与配置)
5. [分片分配管理](#5-分片分配管理)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🏥 集群健康状态监控


### 1.1 什么是集群健康状态


**💡 基本概念**
> **集群健康状态**就像是给整个Elasticsearch集群做"体检"，告诉你集群是否运行正常，有没有"生病"。

想象一下，Elasticsearch集群就像一个大医院：
- **绿色(green)**：医院运行完美，所有科室都正常工作
- **黄色(yellow)**：医院基本正常，但某些科室人手不够（副本分片缺失）
- **红色(red)**：医院出现严重问题，某些科室无法工作（主分片丢失）

### 1.2 基础健康检查命令


**🔍 最常用的健康检查**

```bash
# 快速查看集群健康状态
GET /_cluster/health
```

**返回结果解读：**
```json
{
  "cluster_name": "my-cluster",
  "status": "green",              # 健康状态：green/yellow/red
  "timed_out": false,             # 是否超时
  "number_of_nodes": 3,           # 节点总数
  "number_of_data_nodes": 3,      # 数据节点数
  "active_primary_shards": 15,    # 活跃主分片数
  "active_shards": 30,            # 活跃分片总数
  "relocating_shards": 0,         # 正在迁移的分片
  "initializing_shards": 0,       # 正在初始化的分片
  "unassigned_shards": 0          # 未分配的分片
}
```

**🎯 关键指标含义**

| **字段** | **含义** | **正常值** | **异常表现** |
|---------|---------|-----------|-------------|
| `status` | 集群整体状态 | `green` | `yellow`或`red` |
| `active_primary_shards` | 可用主分片数 | 等于索引分片总数 | 小于预期值 |
| `unassigned_shards` | 未分配分片数 | `0` | 大于0表示有问题 |
| `relocating_shards` | 迁移中分片数 | `0`（稳定状态） | 长期大于0可能有问题 |

### 1.3 详细健康状态查看


**📊 查看具体索引的健康状态**

```bash
# 查看特定索引的健康状态
GET /_cluster/health/my-index

# 等待集群达到黄色状态（超时30秒）
GET /_cluster/health?wait_for_status=yellow&timeout=30s
```

**🔔 实用健康检查技巧**

```bash
# 简化显示，只看关键信息
GET /_cat/health?v

# 输出示例：
epoch      timestamp cluster   status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
1609459200 10:00:00  my-cluster green          3         3     30  15    0    0        0             0                  -                100.0%
```

> **💡 新手提示**：`/_cat/health?v` 是最适合新手的命令，`v`参数会显示列标题，让输出更容易理解。

---

## 2. 📈 集群信息查看


### 2.1 集群统计信息详解


**🔍 什么是集群统计信息**
> 集群统计信息就像是查看整个数据中心的"运营报告"，告诉你有多少数据、占用多少存储空间、处理了多少请求等等。

```bash
# 获取集群详细统计信息
GET /_cluster/stats
```

**📊 核心统计指标解读**

```
集群统计信息结构：

┌─────────────────────────────────────────────────────┐
│                   集群统计信息                       │
├─────────────────┬─────────────────┬─────────────────┤
│     节点信息     │     索引信息     │     硬件信息     │
├─────────────────┼─────────────────┼─────────────────┤
│• 节点总数       │• 索引数量       │• 内存使用       │
│• 节点类型分布   │• 文档总数       │• 磁盘使用       │
│• 节点版本       │• 存储大小       │• CPU信息        │
│• 节点角色       │• 分片统计       │• JVM信息        │
└─────────────────┴─────────────────┴─────────────────┘
```

**🎯 重要统计指标**

| **类别** | **关键指标** | **含义** | **关注点** |
|---------|-------------|---------|-----------|
| **节点** | `count.total` | 集群节点总数 | 节点是否在线 |
| **索引** | `count` | 索引总数 | 索引数量是否合理 |
| **文档** | `docs.count` | 文档总数 | 数据量大小 |
| **存储** | `store.size_in_bytes` | 存储空间使用 | 磁盘容量监控 |

### 2.2 集群状态详细信息


**🔍 集群状态vs集群健康的区别**
- **集群健康**：告诉你"身体好不好"
- **集群状态**：告诉你"身体各个部位的详细情况"

```bash
# 获取完整集群状态（信息很详细，慎用）
GET /_cluster/state

# 只获取特定信息（推荐）
GET /_cluster/state/metadata
GET /_cluster/state/routing_table
GET /_cluster/state/nodes
```

**⚠️ 新手注意**：
- `/_cluster/state` 返回的信息非常详细，在大集群中可能很大
- 建议使用过滤参数只获取需要的信息
- 生产环境中谨慎使用完整状态查询

---

## 3. 🖥️ 节点管理与监控


### 3.1 节点信息查看


**💻 什么是Elasticsearch节点**
> 节点就是运行Elasticsearch的一台服务器。想象一个公司，每个员工就是一个节点，不同员工有不同的职责。

```
Elasticsearch节点类型：

        主节点(Master)
         /     |     \
    数据节点    协调节点    摄取节点
   (Data)   (Coordinating) (Ingest)
      |          |          |
   存储数据    路由请求    预处理数据
```

**🔍 查看节点列表**

```bash
# 简洁显示所有节点
GET /_cat/nodes?v

# 输出示例：
ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
127.0.0.1           65          99  42    1.37    0.87     0.83 mdi       *      node-1
127.0.0.2           45          89  35    1.25    0.78     0.71 mdi       -      node-2
127.0.0.3           55          92  38    1.31    0.82     0.76 mdi       -      node-3
```

**📊 节点状态关键指标**

| **字段** | **含义** | **正常范围** | **需要关注** |
|---------|---------|-------------|-------------|
| `heap.percent` | JVM堆内存使用率 | <75% | >85%需要关注 |
| `ram.percent` | 系统内存使用率 | <90% | >95%需要关注 |
| `cpu` | CPU使用率 | <80% | 持续>90%需要关注 |
| `node.role` | 节点角色 | mdi等 | 确认角色正确 |
| `master` | 是否主节点 | *表示是 | 确保有主节点 |

### 3.2 节点详细信息查询


**🔍 获取节点详细信息**

```bash
# 查看所有节点的详细信息
GET /_nodes

# 查看特定节点信息
GET /_nodes/node-1

# 查看节点统计信息
GET /_nodes/stats
```

**💡 实用节点监控技巧**

```bash
# 查看节点的JVM信息
GET /_nodes/jvm

# 查看节点的操作系统信息
GET /_nodes/os

# 查看节点的进程信息
GET /_nodes/process
```

---

## 4. ⚙️ 集群设置与配置


### 4.1 集群设置基础概念


**🔧 什么是集群设置**
> 集群设置就像是调整整个数据中心的"运行参数"，比如调整空调温度、设置安全规则等。

Elasticsearch的设置分为两类：
- **持久设置**：重启后依然有效（写入配置文件）
- **临时设置**：重启后失效（仅内存中生效）

### 4.2 查看和修改集群设置


**🔍 查看当前集群设置**

```bash
# 查看所有集群设置
GET /_cluster/settings

# 查看设置的简化显示
GET /_cluster/settings?include_defaults=true
```

**⚙️ 修改集群设置**

```bash
# 修改持久设置（推荐用于生产环境）
PUT /_cluster/settings
{
  "persistent": {
    "cluster.routing.allocation.disk.watermark.low": "85%",
    "cluster.routing.allocation.disk.watermark.high": "90%"
  }
}

# 修改临时设置（适合临时调试）
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.disk.watermark.low": "85%"
  }
}
```

**📋 常用集群设置说明**

| **设置项** | **含义** | **默认值** | **建议值** |
|-----------|---------|-----------|-----------|
| `cluster.routing.allocation.disk.watermark.low` | 磁盘低水位线 | 85% | 80-85% |
| `cluster.routing.allocation.disk.watermark.high` | 磁盘高水位线 | 90% | 85-90% |
| `cluster.routing.allocation.enable` | 分片分配开关 | all | all/none |

> **⚠️ 重要提醒**：修改集群设置需要谨慎，建议先在测试环境验证，生产环境使用persistent设置。

---

## 5. 🔄 分片分配管理


### 5.1 分片分配基础概念


**🧩 什么是分片分配**
> 分片分配就像是把一本大书撕成很多页，然后把这些页分别放在不同的书架上（节点），确保每个书架的负载均衡。

```
分片分配示意图：

索引(Index)
    |
    ├── 主分片0 ────→ 节点1
    ├── 主分片1 ────→ 节点2  
    ├── 主分片2 ────→ 节点3
    |
    ├── 副本分片0 ──→ 节点2
    ├── 副本分片1 ──→ 节点3
    └── 副本分片2 ──→ 节点1
```

### 5.2 分片分配状态查看


**🔍 查看分片分配情况**

```bash
# 查看所有分片的分配状态
GET /_cat/shards?v

# 查看特定索引的分片状态
GET /_cat/shards/my-index?v

# 查看未分配的分片
GET /_cat/shards?h=index,shard,prirep,state,unassigned.reason&v
```

**📊 分片状态含义**

| **状态** | **含义** | **正常性** | **处理建议** |
|---------|---------|-----------|-------------|
| `STARTED` | 分片正常运行 | ✅ 正常 | 无需处理 |
| `INITIALIZING` | 分片正在初始化 | 🟡 临时状态 | 等待完成 |
| `RELOCATING` | 分片正在迁移 | 🟡 临时状态 | 等待完成 |
| `UNASSIGNED` | 分片未分配 | ❌ 异常 | 需要排查 |

### 5.3 分片分配问题诊断


**🔍 分析分片分配问题**

```bash
# 解释为什么分片没有分配（重要诊断工具）
GET /_cluster/allocation/explain
{
  "index": "my-index",
  "shard": 0,
  "primary": true
}
```

**🛠️ 常见分片分配问题**

| **问题** | **原因** | **解决方案** |
|---------|---------|-------------|
| 分片无法分配 | 磁盘空间不足 | 清理磁盘或添加节点 |
| 副本分片缺失 | 节点数量不够 | 增加节点或减少副本数 |
| 分片一直迁移 | 集群不稳定 | 检查网络和节点健康 |

**⚡ 手动控制分片分配**

```bash
# 启用/禁用分片分配
PUT /_cluster/settings
{
  "transient": {
    "cluster.routing.allocation.enable": "none"  # 禁用分配
  }
}

# 手动移动分片
POST /_cluster/reroute
{
  "commands": [
    {
      "move": {
        "index": "my-index",
        "shard": 0,
        "from_node": "node1",
        "to_node": "node2"
      }
    }
  ]
}
```

### 5.4 待执行任务查看


**📋 查看集群待执行任务**

```bash
# 查看集群中排队等待的任务
GET /_cluster/pending_tasks
```

> **💡 新手提示**：如果pending_tasks列表很长或某些任务等待时间很久，说明集群可能存在性能问题或配置问题。

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基础命令


```
🔸 健康检查：GET /_cluster/health - 最重要的集群监控命令
🔸 节点查看：GET /_cat/nodes?v - 了解集群节点状态
🔸 分片状态：GET /_cat/shards?v - 查看分片分配情况
🔸 集群统计：GET /_cluster/stats - 了解集群整体使用情况
🔸 设置修改：PUT /_cluster/settings - 调整集群配置参数
🔸 分配诊断：GET /_cluster/allocation/explain - 分片问题排查
```

### 6.2 关键理解要点


**🔹 集群健康状态理解**
```
绿色(Green)：完美状态，所有主分片和副本分片都正常
黄色(Yellow)：可用但不完美，主分片正常但部分副本缺失
红色(Red)：严重问题，部分主分片不可用，数据可能丢失
```

**🔹 节点角色理解**
```
主节点(Master)：管理集群状态，不存储数据
数据节点(Data)：存储数据和执行搜索
协调节点(Coordinating)：路由请求，不存储数据
混合节点：同时承担多种角色（常见于小集群）
```

**🔹 分片分配原则**
```
主分片：每个索引的主分片数量创建后不可修改
副本分片：可以动态调整数量，提供高可用性
分配均衡：Elasticsearch自动平衡各节点间的分片分布
```

### 6.3 实际应用价值


**💼 日常运维场景**
- **集群监控**：定期检查集群健康状态，及时发现问题
- **性能优化**：通过统计信息分析集群性能瓶颈
- **容量规划**：根据存储和节点使用情况规划扩容
- **故障排查**：使用分配解释命令快速定位分片问题

**🔧 运维最佳实践**
- **监控自动化**：建立集群健康状态的自动监控告警
- **设置管理**：使用persistent设置确保配置持久化
- **分片规划**：合理规划分片数量，避免过多小分片
- **节点管理**：定期检查节点状态，及时处理异常节点

### 6.4 新手常见问题


**⚠️ 典型错误**
```
误用transient设置导致重启后配置丢失
不理解分片分配机制导致数据倾斜
忽略集群健康状态监控导致问题扩大
过度使用完整state查询影响性能
```

**💡 学习建议**
```
从基础的health和nodes命令开始学习
理解集群、节点、分片的层次关系
在测试环境中练习各种设置修改
建立定期检查集群状态的习惯
```

**核心记忆口诀**：
```
健康检查第一位，green黄红要分清
节点状态常查看，CPU内存不能忘  
分片分配要均衡，未分配时找原因
集群设置需谨慎，持久配置保稳定
```