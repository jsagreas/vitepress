---
title: 5、索引映射管理
---
## 📚 目录

1. [什么是索引映射](#1-什么是索引映射)
2. [映射的基本概念](#2-映射的基本概念)
3. [创建和更新映射](#3-创建和更新映射)
4. [查看映射信息](#4-查看映射信息)
5. [字段映射详解](#5-字段映射详解)
6. [映射管理实战](#6-映射管理实战)
7. [常见问题与最佳实践](#7-常见问题与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🗺️ 什么是索引映射


### 1.1 映射的通俗理解


**简单理解**：映射就像是数据库中的"表结构定义"，告诉Elasticsearch每个字段是什么类型，应该怎么处理。

```
生活中的类比：
填写表单 → 每个字段都有要求
姓名：文本类型，需要精确匹配
年龄：数字类型，可以做数值计算  
生日：日期类型，可以按时间排序
简介：文本类型，需要分词搜索

Elasticsearch映射也是同样道理！
```

### 1.2 为什么需要映射


**🔸 数据类型识别**
- 告诉ES这个字段存储什么类型的数据
- 数字、文本、日期、布尔值等不同处理方式

**🔸 搜索行为控制**
- 文本字段：是否需要分词？用什么分词器？
- 数字字段：是否参与排序和聚合？
- 日期字段：用什么格式存储？

**🔸 存储优化**
- 不需要搜索的字段可以设置为不索引
- 节省存储空间和提升性能

### 1.3 映射的工作原理


```
数据写入过程：
JSON文档 → 映射分析 → 字段类型确定 → 索引存储

示例流程：
{
  "name": "张三",      ← 文本类型，需要分词
  "age": 25,          ← 数字类型，用于计算
  "birthday": "1998-05-15"  ← 日期类型，时间格式
}
```

---

## 2. 📋 映射的基本概念


### 2.1 映射的组成部分


**🔸 字段映射（Field Mapping）**
```
每个字段的定义包含：
• 数据类型（type）：text、keyword、integer、date等
• 分析器（analyzer）：如何分词和处理文本
• 索引设置（index）：是否建立索引用于搜索
• 存储设置（store）：是否单独存储原始值
```

**🔸 元数据映射（Meta Mapping）**
```
索引级别的设置：
• _source：是否存储原始JSON文档
• _id：文档唯一标识符的处理方式
• _routing：数据路由规则
• dynamic：动态映射的行为
```

### 2.2 映射类型说明


| 字段类型 | **用途说明** | **典型场景** | **是否分词** |
|---------|------------|-------------|------------|
| `text` | 全文搜索的文本 | 文章内容、描述信息 | ✅ 是 |
| `keyword` | 精确匹配的文本 | 用户名、标签、ID | ❌ 否 |
| `integer` | 整数数值 | 年龄、数量、评分 | ❌ 否 |
| `float` | 浮点数值 | 价格、百分比 | ❌ 否 |
| `date` | 日期时间 | 创建时间、生日 | ❌ 否 |
| `boolean` | 布尔值 | 是否激活、是否公开 | ❌ 否 |

### 2.3 动态映射vs静态映射


**🔸 动态映射（自动推断）**
```
ES自动根据数据推断字段类型：
"张三" → text类型
123 → long类型  
true → boolean类型
"2023-01-01" → date类型（如果格式匹配）

优点：使用简单，无需预先定义
缺点：可能推断错误，影响搜索效果
```

**🔸 静态映射（手动定义）**
```
提前明确定义每个字段的类型和行为
优点：完全可控，性能更好
缺点：需要提前规划，修改相对复杂
```

---

## 3. 🛠️ 创建和更新映射


### 3.1 创建索引时定义映射


**基本语法**：`PUT /{index}/_mapping`

```json
PUT /user_info/_mapping
{
  "properties": {
    "name": {
      "type": "text",
      "analyzer": "ik_smart"
    },
    "username": {
      "type": "keyword"
    },
    "age": {
      "type": "integer"
    },
    "email": {
      "type": "keyword"
    },
    "description": {
      "type": "text",
      "analyzer": "ik_max_word"
    },
    "created_at": {
      "type": "date",
      "format": "yyyy-MM-dd HH:mm:ss"
    },
    "is_active": {
      "type": "boolean"
    }
  }
}
```

**🔸 字段定义详解**
```
name字段分析：
• type: "text" → 用于全文搜索
• analyzer: "ik_smart" → 使用IK分词器进行中文分词

username字段分析：  
• type: "keyword" → 精确匹配，不分词
• 适合用户名、ID等需要完全匹配的场景

created_at字段分析：
• type: "date" → 日期类型
• format: "yyyy-MM-dd HH:mm:ss" → 指定日期格式
```

### 3.2 更新现有映射


**⚠️ 重要限制**：已存在字段的类型**不能修改**，只能添加新字段

```json
PUT /user_info/_mapping
{
  "properties": {
    "phone": {
      "type": "keyword"
    },
    "address": {
      "type": "text",
      "analyzer": "ik_smart"
    },
    "tags": {
      "type": "keyword"
    }
  }
}
```

**🔸 为什么不能修改字段类型？**
```
技术原因：
已经建立的索引结构无法更改
已存储的数据按原类型建立了索引

解决方案：
1. 重建索引（reindex）
2. 使用字段别名
3. 创建新字段逐步迁移
```

### 3.3 类型映射设置（历史用法）


**注意**：Elasticsearch 7.x后移除了类型概念，以下仅作了解

```json
PUT /old_index/_mapping/user_type
{
  "properties": {
    "name": {"type": "text"}
  }
}
```

---

## 4. 👀 查看映射信息


### 4.1 查看单个索引映射


**基本语法**：`GET /{index}/_mapping`

```bash
GET /user_info/_mapping
```

**响应示例**：
```json
{
  "user_info": {
    "mappings": {
      "properties": {
        "name": {
          "type": "text",
          "analyzer": "ik_smart"
        },
        "username": {
          "type": "keyword"
        },
        "age": {
          "type": "integer"
        }
      }
    }
  }
}
```

### 4.2 查看所有索引映射


**基本语法**：`GET /_mapping`

```bash
GET /_mapping
```

**🔸 实用技巧**：查看特定模式的索引
```bash
GET /user*/_mapping     # 查看以user开头的所有索引映射
GET /log-*/_mapping     # 查看以log-开头的所有索引映射
```

### 4.3 查看特定字段映射


**基本语法**：`GET /{index}/_mapping/field/{field}`

```bash
GET /user_info/_mapping/field/name
GET /user_info/_mapping/field/age,email  # 查看多个字段
```

**响应示例**：
```json
{
  "user_info": {
    "mappings": {
      "name": {
        "full_name": "name",
        "mapping": {
          "name": {
            "type": "text",
            "analyzer": "ik_smart"
          }
        }
      }
    }
  }
}
```

### 4.4 查看字段数据统计


**基本语法**：`GET /_cat/fielddata`

```bash
GET /_cat/fielddata?v
GET /_cat/fielddata?v&fields=name,age  # 查看特定字段
```

**输出说明**：
```
id    host      ip        node    field total
node1 localhost 127.0.0.1 node1   name  256kb
node1 localhost 127.0.0.1 node1   age   128kb
```

---

## 5. 🎯 字段映射详解


### 5.1 文本字段映射


**🔸 text类型 - 全文搜索**
```json
{
  "content": {
    "type": "text",
    "analyzer": "ik_max_word",    // 索引时分词器
    "search_analyzer": "ik_smart", // 搜索时分词器
    "fielddata": true             // 是否支持聚合排序
  }
}
```

**🔸 keyword类型 - 精确匹配**
```json
{
  "status": {
    "type": "keyword",
    "ignore_above": 256    // 超过256字符的值不索引
  }
}
```

**🔸 text+keyword多字段映射**
```json
{
  "title": {
    "type": "text",
    "analyzer": "ik_smart",
    "fields": {
      "raw": {
        "type": "keyword"  // title.raw用于精确匹配和排序
      }
    }
  }
}
```

### 5.2 数值字段映射


```json
{
  "price": {
    "type": "scaled_float",  // 适合价格等固定小数位
    "scaling_factor": 100    // 内部存储时放大100倍
  },
  "score": {
    "type": "float"
  },
  "count": {
    "type": "integer"
  },
  "view_count": {
    "type": "long"          // 大数值使用long
  }
}
```

**🔸 数值类型选择指南**
```
• integer：-2³¹ 到 2³¹-1，适合普通计数
• long：-2⁶³ 到 2⁶³-1，适合大数值
• float：32位浮点，适合一般小数
• double：64位浮点，适合高精度小数
• scaled_float：适合固定小数位的数值（如价格）
```

### 5.3 日期字段映射


```json
{
  "created_at": {
    "type": "date",
    "format": "yyyy-MM-dd HH:mm:ss||epoch_millis"
  },
  "birthday": {
    "type": "date",
    "format": "yyyy-MM-dd"
  }
}
```

**🔸 常用日期格式**
```
• "yyyy-MM-dd"：2023-12-25
• "yyyy-MM-dd HH:mm:ss"：2023-12-25 14:30:00
• "epoch_millis"：时间戳毫秒
• "strict_date_optional_time"：ISO 8601格式
```

### 5.4 复杂数据类型


**🔸 对象类型**
```json
{
  "user": {
    "properties": {
      "name": {"type": "text"},
      "age": {"type": "integer"}
    }
  }
}
```

**🔸 数组类型**
```json
{
  "tags": {
    "type": "keyword"  // 数组中每个元素都是keyword
  }
}
```

---

## 6. ⚡ 映射管理实战


### 6.1 完整的电商商品映射示例


```json
PUT /products/_mapping
{
  "properties": {
    "title": {
      "type": "text",
      "analyzer": "ik_max_word",
      "fields": {
        "raw": {"type": "keyword"}
      }
    },
    "description": {
      "type": "text",
      "analyzer": "ik_smart"
    },
    "price": {
      "type": "scaled_float",
      "scaling_factor": 100
    },
    "category": {
      "type": "keyword"
    },
    "brand": {
      "type": "keyword"
    },
    "tags": {
      "type": "keyword"
    },
    "created_at": {
      "type": "date",
      "format": "yyyy-MM-dd HH:mm:ss"
    },
    "is_available": {
      "type": "boolean"
    },
    "sales_count": {
      "type": "integer"
    },
    "rating": {
      "type": "float"
    }
  }
}
```

### 6.2 映射模板使用


**创建模板**：
```json
PUT /_template/product_template
{
  "index_patterns": ["product-*"],
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_smart"
      },
      "price": {
        "type": "scaled_float",
        "scaling_factor": 100
      }
    }
  }
}
```

### 6.3 动态映射配置


```json
PUT /dynamic_index/_mapping
{
  "dynamic": "strict",  // 禁止动态添加字段
  "properties": {
    "predefined_field": {
      "type": "text"
    }
  }
}
```

**🔸 dynamic参数说明**
```
• true（默认）：自动添加新字段
• false：忽略新字段，不报错不索引
• strict：遇到新字段直接报错
```

---

## 7. ❗ 常见问题与最佳实践


### 7.1 映射设计最佳实践


**🔸 字段类型选择原则**
```
✅ 推荐做法：
• 精确匹配用keyword（用户名、标签）
• 全文搜索用text（文章内容、描述）
• 数值计算用integer/float（价格、年龄）
• 日期排序用date（创建时间、截止日期）

❌ 避免做法：
• 数字存储为text类型
• 需要排序的字段设置为text无fielddata
• 不需要搜索的字段建立复杂分析器
```

**🔸 性能优化建议**
```
🚀 提升性能：
• 不需要搜索的字段设置"index": false
• 不需要返回的字段设置"store": false  
• 使用合适的数据类型减少存储空间
• 避免过多的嵌套对象
```

### 7.2 常见错误及解决方案


**🐛 错误1：字段类型冲突**
```bash
# 错误信息
"mapper_parsing_exception": "failed to parse field [age] of type [long] in document"

# 原因：数据类型与映射定义不匹配
# 解决：确保写入数据符合映射定义的类型
```

**🐛 错误2：无法修改字段类型**
```bash
# 错误信息  
"illegal_argument_exception": "mapper [name] cannot be changed from type [keyword] to [text]"

# 解决方案：
# 1. 重建索引
# 2. 添加新字段逐步迁移
# 3. 使用reindex API
```

**🐛 错误3：分词器不存在**
```bash
# 错误信息
"analyzer [ik_smart] not found"

# 解决：安装对应的分词器插件
```

### 7.3 映射维护策略


**🔄 索引生命周期管理**
```
开发阶段：
• 使用动态映射快速原型
• 频繁调整字段定义

测试阶段：  
• 固化映射配置
• 进行性能测试

生产阶段：
• 使用静态映射
• 通过模板管理新索引
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心命令


```bash
🔸 基础映射操作
PUT /{index}/_mapping          # 创建或更新映射
GET /{index}/_mapping          # 查看索引映射  
GET /_mapping                  # 查看所有映射

🔸 字段级别操作
GET /{index}/_mapping/field/{field}   # 查看字段映射
GET /_cat/fielddata?v                 # 字段数据统计

🔸 历史兼容命令（了解即可）
PUT /{index}/_mapping/{type}          # 类型映射设置
DELETE /{index}/_mapping/{type}       # 删除类型映射
```

### 8.2 关键理解要点


**🔹 映射的本质作用**
```
数据类型定义：告诉ES如何理解和处理每个字段
搜索行为控制：决定字段如何被索引和搜索
性能优化基础：合理的映射设计直接影响性能
```

**🔹 字段类型选择逻辑**
```
需要分词搜索 → text类型
需要精确匹配 → keyword类型  
需要数值计算 → integer/float/long类型
需要时间排序 → date类型
简单开关标志 → boolean类型
```

**🔹 映射修改限制**
```
可以做的：添加新字段、修改字段配置参数
不能做的：修改已存在字段的数据类型
解决方案：重建索引或创建新字段迁移
```

### 8.3 实际应用指导


**💡 设计阶段考虑**
- 提前规划字段类型和用途
- 考虑搜索、排序、聚合需求
- 预留扩展字段的空间

**⚡ 性能优化重点**
- 不需要搜索的字段禁用索引
- 合理使用multi-field映射
- 根据查询模式优化分词器配置

**🔧 运维管理要点**
- 使用模板统一管理映射
- 定期检查字段使用情况
- 及时清理无用字段和索引

**核心记忆要点**：
- 映射定义字段类型，控制搜索行为
- text分词搜索，keyword精确匹配
- 字段类型一旦确定不能修改
- 合理设计映射是性能优化基础