---
title: 30、跨集群操作
---
## 📚 目录

1. [跨集群操作基础概念](#1-跨集群操作基础概念)
2. [远程集群配置](#2-远程集群配置)
3. [跨集群搜索实战](#3-跨集群搜索实战)
4. [跨集群复制功能](#4-跨集群复制功能)
5. [远程集群监控与管理](#5-远程集群监控与管理)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🌐 跨集群操作基础概念


### 1.1 什么是跨集群操作


**🔸 核心定义**
跨集群操作就是让多个独立的Elasticsearch集群之间能够相互协作，就像不同公司的分部之间可以共享资源和信息一样。

```
现实生活类比：
总公司（本地集群）  ←→  分公司（远程集群）
    ↓                     ↓
可以查询分公司数据      可以同步总公司政策
可以备份到分公司        可以独立运营

Elasticsearch跨集群：
本地集群              远程集群
    ↓                     ↓
可以搜索远程数据      可以复制到本地
可以备份到远程        保持独立性
```

### 1.2 跨集群操作的核心价值


**💡 为什么需要跨集群**

🎯 **数据分布管理**
- **地理分布**：北京集群 + 上海集群，用户就近访问
- **业务隔离**：生产集群 + 测试集群，环境完全分离
- **容量扩展**：单集群容量不够时，扩展到多集群

🎯 **灾备与高可用**
- **异地备份**：主集群故障时，备集群顶上
- **数据同步**：重要数据实时同步到多地
- **风险分散**：不把鸡蛋放在一个篮子里

🎯 **性能优化**
- **负载分担**：搜索请求分散到多个集群
- **就近服务**：用户访问最近的集群节点
- **专业分工**：搜索集群 + 存储集群各司其职

### 1.3 跨集群操作类型


**📊 主要功能对比**

| 功能类型 | **作用** | **使用场景** | **数据流向** |
|---------|---------|-------------|-------------|
| 🔍 **跨集群搜索** | `在本地搜索远程数据` | `统一查询多地数据` | `远程 → 本地` |
| 📋 **跨集群复制** | `同步远程数据到本地` | `数据备份和同步` | `远程 → 本地(持续)` |
| 🔧 **远程集群管理** | `监控和配置远程集群` | `集群运维管理` | `双向通信` |

---

## 2. ⚙️ 远程集群配置


### 2.1 配置远程集群连接


**🔸 基本配置命令**

```bash
# 配置远程集群（持久化设置）
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.cluster1.seeds": ["192.168.1.100:9300", "192.168.1.101:9300"]
  }
}'
```

**💡 配置参数详解**

```
配置结构解释：
cluster.remote.{集群名}.seeds = [节点地址列表]

参数说明：
- cluster1: 远程集群的别名（自定义）
- seeds: 远程集群的种子节点（用于发现其他节点）
- 端口9300: Elasticsearch集群间通信端口（不是HTTP的9200）
```

🎯 **记忆技巧**
> **"persistent"（持久）** = 重启后配置仍然生效
> **"seeds"（种子）** = 就像种子发芽，通过这些节点发现整个集群

### 2.2 多集群配置示例


**📋 配置多个远程集群**

```bash
# 同时配置多个远程集群
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.beijing.seeds": ["beijing-es1:9300", "beijing-es2:9300"],
    "cluster.remote.shanghai.seeds": ["shanghai-es1:9300", "shanghai-es2:9300"],
    "cluster.remote.backup.seeds": ["backup-es:9300"]
  }
}'
```

**🔧 高级配置选项**

```bash
# 带连接配置的远程集群设置
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.production.seeds": ["prod-es1:9300"],
    "cluster.remote.production.transport.ping_schedule": "30s",
    "cluster.remote.production.connect_timeout": "10s"
  }
}'
```

**⚡ 配置参数说明**

| 参数 | **含义** | **默认值** | **建议值** |
|------|---------|-----------|-----------|
| `ping_schedule` | `心跳检测间隔` | `30s` | `网络稳定时可延长到60s` |
| `connect_timeout` | `连接超时时间` | `30s` | `网络较慢时设为30s` |
| `compress` | `是否压缩传输` | `false` | `跨网络时建议true` |

### 2.3 验证远程集群配置


**🔍 检查配置是否生效**

```bash
# 查看当前远程集群配置
curl -X GET "localhost:9200/_cluster/settings?include_defaults=true"

# 查看远程集群信息
curl -X GET "localhost:9200/_remote/info"
```

**📊 成功配置的响应示例**
```json
{
  "cluster1": {
    "connected": true,
    "mode": "sniff",
    "seeds": ["192.168.1.100:9300"],
    "num_nodes_connected": 3,
    "max_connections_per_cluster": 3,
    "initial_connect_timeout": "30s"
  }
}
```

**✅ 配置检查清单**
- [ ] `connected: true` - 连接成功
- [ ] `num_nodes_connected > 0` - 有节点连接
- [ ] `seeds` 配置正确
- [ ] 网络端口9300开放

---

## 3. 🔍 跨集群搜索实战


### 3.1 基本跨集群搜索


**🔸 搜索语法格式**

```
格式：{远程集群名}:{索引名}
示例：cluster1:my_index
```

**💡 简单搜索示例**

```bash
# 搜索远程集群的指定索引
curl -X GET "localhost:9200/cluster1:my_index/_search" \
-H "Content-Type: application/json" \
-d '{
  "query": {
    "match": {
      "title": "elasticsearch"
    }
  }
}'
```

**🎯 理解要点**
> `cluster1:my_index` 就像电话号码中的区号
> `cluster1` = 区号（集群标识）
> `my_index` = 本地号码（索引名称）

### 3.2 多集群联合搜索


**📊 搜索多个集群的数据**

```bash
# 同时搜索本地和多个远程集群
curl -X GET "localhost:9200/local_index,cluster1:remote_index,cluster2:another_index/_search" \
-H "Content-Type: application/json" \
-d '{
  "query": {
    "bool": {
      "must": [
        {"range": {"timestamp": {"gte": "2024-01-01"}}},
        {"match": {"status": "active"}}
      ]
    }
  }
}'
```

**🔸 搜索模式对比**

```
本地搜索：
GET /my_index/_search    ← 只搜索本地集群

跨集群搜索：
GET /cluster1:my_index/_search    ← 搜索远程集群

混合搜索：
GET /local_index,cluster1:remote_index/_search    ← 本地+远程一起搜索
```

### 3.3 跨集群聚合分析


**📈 跨集群数据统计**

```bash
# 跨集群聚合统计
curl -X GET "localhost:9200/beijing:sales,shanghai:sales/_search" \
-H "Content-Type: application/json" \
-d '{
  "size": 0,
  "aggs": {
    "total_sales": {
      "sum": {
        "field": "amount"
      }
    },
    "sales_by_city": {
      "terms": {
        "field": "city.keyword"
      }
    }
  }
}'
```

**💡 实际应用场景**
```
电商平台场景：
- 北京集群：北方用户数据
- 上海集群：南方用户数据
- 统一查询：全国销售报表

日志分析场景：
- 生产集群：当前业务日志
- 备份集群：历史归档日志  
- 联合搜索：完整时间线分析
```

### 3.4 跨集群搜索性能优化


**⚡ 优化技巧**

```bash
# 使用preference确保结果一致性
curl -X GET "localhost:9200/cluster1:logs/_search?preference=_local" \
-H "Content-Type: application/json" \
-d '{
  "query": {"match_all": {}},
  "size": 10
}'

# 指定超时时间
curl -X GET "localhost:9200/cluster1:logs/_search?timeout=10s" \
-H "Content-Type: application/json" \
-d '{
  "query": {"match_all": {}}
}'
```

**🔧 性能优化建议**

| 优化方向 | **具体做法** | **效果** |
|---------|-------------|---------|
| 🎯 **减少数据传输** | `只查询必要字段` | `降低网络开销` |
| ⏰ **设置合理超时** | `timeout=30s` | `避免长时间等待` |
| 📊 **分批查询** | `使用from/size分页` | `避免大结果集` |
| 🔍 **索引优化** | `使用日期索引分片` | `精确命中数据` |

---

## 4. 📋 跨集群复制功能


### 4.1 跨集群复制概念


**🔸 什么是跨集群复制（CCR）**

跨集群复制就像给重要文件做备份，把一个集群的数据实时同步到另一个集群。

```
文件备份类比：
重要文档.docx  →  复制  →  备份文档.docx
    ↓                       ↓
实时修改                 自动同步更新

CCR复制：
主集群（Leader）  →  复制  →  从集群（Follower）
    ↓                       ↓
新增/更新数据             自动同步数据
```

### 4.2 创建跨集群复制


**🔧 设置复制关系**

```bash
# 创建跨集群复制（从远程复制到本地）
curl -X PUT "localhost:9200/_ccr/follow/my_follower_index" \
-H "Content-Type: application/json" \
-d '{
  "remote_cluster": "cluster1",
  "leader_index": "my_leader_index",
  "settings": {
    "index.number_of_replicas": 0
  },
  "max_read_request_operation_count": 5120,
  "max_outstanding_read_requests": 12
}'
```

**💡 参数详解**

```
核心参数：
- remote_cluster: 远程集群名称（之前配置的cluster1）
- leader_index: 远程集群中的源索引
- my_follower_index: 本地集群中的目标索引

性能参数：
- max_read_request_operation_count: 每次读取的操作数
- max_outstanding_read_requests: 最大并发读请求数
```

### 4.3 自动跟随模式


**🔄 自动复制匹配的索引**

```bash
# 设置自动跟随模式
curl -X PUT "localhost:9200/_ccr/auto_follow/sales_pattern" \
-H "Content-Type: application/json" \
-d '{
  "remote_cluster": "cluster1",
  "leader_index_patterns": ["sales-*", "orders-*"],
  "follow_index_pattern": "copy-{{leader_index}}",
  "settings": {
    "index.number_of_replicas": 0
  }
}'
```

**🎯 模式匹配说明**
```
匹配规则：
- leader_index_patterns: ["sales-*"]  ← 匹配所有sales-开头的索引
- follow_index_pattern: "copy-{{leader_index}}"  ← 本地索引名加前缀

实际效果：
远程索引: sales-2024-01  →  本地索引: copy-sales-2024-01
远程索引: sales-2024-02  →  本地索引: copy-sales-2024-02
```

### 4.4 监控复制状态


**📊 检查复制进度**

```bash
# 查看跟随索引状态
curl -X GET "localhost:9200/_ccr/follow_stats"

# 查看特定索引的复制状态
curl -X GET "localhost:9200/my_follower_index/_ccr/stats"
```

**✅ 状态指标解读**
```json
{
  "indices": [{
    "index": "my_follower_index",
    "shards": [{
      "leader_global_checkpoint": 1500,
      "follower_global_checkpoint": 1500,
      "operations_read": 1500,
      "operations_written": 1500,
      "outstanding_read_requests": 0
    }]
  }]
}
```

**🔍 关键指标**
- `leader_global_checkpoint = follower_global_checkpoint` → 完全同步
- `outstanding_read_requests = 0` → 没有待处理请求
- `operations_read = operations_written` → 读写一致

### 4.5 复制管理操作


**⏸️ 暂停和恢复复制**

```bash
# 暂停复制
curl -X POST "localhost:9200/my_follower_index/_ccr/pause_follow"

# 恢复复制
curl -X POST "localhost:9200/my_follower_index/_ccr/resume_follow"

# 停止复制（不可恢复）
curl -X POST "localhost:9200/my_follower_index/_ccr/unfollow"
```

**🚨 注意事项**
> ⚠️ **unfollow操作不可逆**：停止后无法恢复，需要重新创建
> ⚠️ **pause期间数据差异**：暂停时间过长可能导致数据不一致
> ✅ **建议做法**：维护期间pause，完成后resume

---

## 5. 🔧 远程集群监控与管理


### 5.1 获取远程集群信息


**📊 查看远程集群详情**

```bash
# 获取所有远程集群信息
curl -X GET "localhost:9200/_remote/info"

# 检查远程集群健康状态
curl -X GET "localhost:9200/_cluster/remote/info"
```

**💡 响应信息解读**
```json
{
  "cluster1": {
    "connected": true,
    "mode": "sniff",
    "seeds": ["192.168.1.100:9300"],
    "num_nodes_connected": 3,
    "max_connections_per_cluster": 3,
    "initial_connect_timeout": "30s",
    "skip_unavailable": false
  }
}
```

**🔍 状态检查清单**
- [ ] `connected: true` - 连接正常
- [ ] `num_nodes_connected > 0` - 有可用节点
- [ ] `skip_unavailable: false` - 不跳过不可用节点

### 5.2 远程集群连接测试


**🔌 测试连接性**

```bash
# 测试远程集群连接
curl -X GET "localhost:9200/cluster1:_cluster/health"

# 测试远程集群搜索
curl -X GET "localhost:9200/cluster1:*/_count"
```

**⚡ 连接问题排查**

```
常见问题及解决：

❌ 连接超时
原因：网络不通或端口未开放
解决：检查9300端口和防火墙

❌ 认证失败  
原因：安全设置不匹配
解决：检查用户名密码或证书

❌ 版本不兼容
原因：集群版本差异过大
解决：升级到兼容版本
```

### 5.3 动态修改远程集群配置


**🔧 修改连接参数**

```bash
# 修改连接超时时间
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.cluster1.connect_timeout": "60s"
  }
}'

# 添加新的种子节点
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.cluster1.seeds": [
      "192.168.1.100:9300", 
      "192.168.1.101:9300",
      "192.168.1.102:9300"
    ]
  }
}'
```

### 5.4 移除远程集群


**🗑️ 删除远程集群配置**

```bash
# 移除特定远程集群
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.cluster1.seeds": null
  }
}'

# 清空所有远程集群配置
curl -X PUT "localhost:9200/_cluster/settings" \
-H "Content-Type: application/json" \
-d '{
  "persistent": {
    "cluster.remote.*": null
  }
}'
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 跨集群操作：多个独立ES集群间的协作功能
🔸 远程集群配置：通过seeds节点发现和连接远程集群
🔸 跨集群搜索：在本地搜索远程集群数据，语法cluster:index
🔸 跨集群复制：实时同步远程集群数据到本地
🔸 集群监控：检查连接状态和复制进度
```

### 6.2 关键命令速查


**🚀 快速上手命令**

```bash
# 1️⃣ 配置远程集群
curl -X PUT "localhost:9200/_cluster/settings" -d '{
  "persistent": {"cluster.remote.{集群名}.seeds": ["{IP}:9300"]}
}'

# 2️⃣ 跨集群搜索  
curl -X GET "localhost:9200/{集群名}:{索引名}/_search"

# 3️⃣ 创建复制
curl -X PUT "localhost:9200/_ccr/follow/{本地索引}" -d '{
  "remote_cluster": "{集群名}", "leader_index": "{远程索引}"
}'

# 4️⃣ 查看状态
curl -X GET "localhost:9200/_remote/info"
```

### 6.3 实际应用场景


**🎯 典型使用案例**

| 场景 | **跨集群搜索** | **跨集群复制** | **适用情况** |
|------|---------------|----------------|-------------|
| 🌍 **多地部署** | `统一查询各地数据` | `数据同步备份` | `地理分布业务` |
| 🔧 **环境隔离** | `测试环境查询生产数据` | `生产数据备份到测试` | `开发测试场景` |
| 📊 **数据分析** | `联合查询多业务数据` | `汇总数据到分析集群` | `BI报表需求` |
| 🚨 **灾备方案** | `切换到备份集群查询` | `实时备份关键数据` | `高可用架构` |

### 6.4 性能优化要点


**⚡ 优化策略**

🔸 **网络优化**
- 使用专网连接减少延迟
- 启用数据压缩节省带宽
- 合理设置超时时间

🔸 **搜索优化**  
- 只查询必要字段减少传输
- 使用分页避免大结果集
- 设置preference保证一致性

🔸 **复制优化**
- 调整批量读取大小
- 控制并发请求数量
- 监控复制延迟

### 6.5 常见问题及解决


**🚨 故障排查指南**

```
连接问题：
❌ 现象：connection timeout
✅ 检查：网络连通性和9300端口
✅ 解决：开放防火墙或修改网络配置

搜索问题：
❌ 现象：index not found  
✅ 检查：远程索引是否存在
✅ 解决：确认索引名称和集群名称

复制问题：
❌ 现象：复制延迟过大
✅ 检查：网络带宽和集群负载
✅ 解决：调整复制参数或增加网络带宽
```

### 6.6 最佳实践建议


**💡 生产环境指导**

🎯 **安全考虑**
- 配置SSL/TLS加密传输
- 设置访问控制和认证
- 定期检查连接状态

🎯 **运维管理**
- 监控跨集群网络质量
- 建立复制延迟告警
- 定期测试灾备切换

🎯 **容量规划**
- 预估跨集群流量
- 监控复制存储占用
- 规划网络带宽需求

**🔑 核心记忆口诀**
> **配置连接靠seeds，搜索格式cluster:index**
> **复制功能CCR，监控状态要及时**
> **网络稳定是基础，安全认证不能少**

---

**💪 实践建议**

跨集群操作虽然功能强大，但建议先在测试环境充分验证，确认网络稳定性和性能表现后再应用到生产环境。重点关注网络延迟对搜索性能的影响，以及复制延迟对数据一致性的影响。