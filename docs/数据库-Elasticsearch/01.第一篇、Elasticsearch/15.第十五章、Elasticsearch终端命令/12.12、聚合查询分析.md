---
title: 12ã€èšåˆæŸ¥è¯¢åˆ†æ
---
## ğŸ“š ç›®å½•

1. [èšåˆæŸ¥è¯¢æ˜¯ä»€ä¹ˆ](#1-èšåˆæŸ¥è¯¢æ˜¯ä»€ä¹ˆ)
2. [åŸºç¡€èšåˆç±»å‹è¯¦è§£](#2-åŸºç¡€èšåˆç±»å‹è¯¦è§£)
3. [è¯æ¡èšåˆå®æˆ˜](#3-è¯æ¡èšåˆå®æˆ˜)
4. [æ•°å€¼èšåˆæ“ä½œ](#4-æ•°å€¼èšåˆæ“ä½œ)
5. [æ—¥æœŸç›´æ–¹å›¾èšåˆ](#5-æ—¥æœŸç›´æ–¹å›¾èšåˆ)
6. [åŸºæ•°èšåˆåº”ç”¨](#6-åŸºæ•°èšåˆåº”ç”¨)
7. [åµŒå¥—èšåˆæŸ¥è¯¢](#7-åµŒå¥—èšåˆæŸ¥è¯¢)
8. [èšåˆç»“æœè§£æ](#8-èšåˆç»“æœè§£æ)
9. [å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ](#9-å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” èšåˆæŸ¥è¯¢æ˜¯ä»€ä¹ˆ


### 1.1 èšåˆçš„æœ¬è´¨ç†è§£


**ğŸ”¸ ç®€å•ç†è§£**
èšåˆå°±åƒExcelé‡Œçš„æ•°æ®é€è§†è¡¨ï¼Œå®ƒä¸æ˜¯è¿”å›å…·ä½“çš„æ–‡æ¡£æ•°æ®ï¼Œè€Œæ˜¯å¯¹æ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æã€‚

```
æƒ³è±¡ä½ æœ‰ä¸€ä¸ªå•†å“é”€å”®æ•°æ®è¡¨ï¼š
å•†å“åç§°    åˆ†ç±»     ä»·æ ¼    é”€å”®æ—¥æœŸ
è‹¹æœ       æ°´æœ     5å…ƒ     2024-01-01
é¦™è•‰       æ°´æœ     3å…ƒ     2024-01-01  
ç¬”è®°æœ¬     ç”µå­     5000å…ƒ  2024-01-02

æ™®é€šæŸ¥è¯¢ï¼šè¿”å›å…·ä½“å•†å“ä¿¡æ¯
èšåˆæŸ¥è¯¢ï¼šç»Ÿè®¡åˆ†æï¼Œæ¯”å¦‚ï¼š
- æ¯ä¸ªåˆ†ç±»æœ‰å¤šå°‘å•†å“ï¼Ÿ
- æ¯å¤©çš„å¹³å‡ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ
- é”€å”®é¢æœ€é«˜çš„æ˜¯å“ªå¤©ï¼Ÿ
```

### 1.2 èšåˆ vs æ™®é€šæŸ¥è¯¢


**å¯¹æ¯”ç†è§£**ï¼š
```
æ™®é€šæŸ¥è¯¢ (Search)ï¼š
é—®ï¼šç»™æˆ‘çœ‹çœ‹æ‰€æœ‰è‹¹æœçš„ä¿¡æ¯
ç­”ï¼šè‹¹æœï¼Œæ°´æœï¼Œ5å…ƒï¼Œ2024-01-01

èšåˆæŸ¥è¯¢ (Aggregation)ï¼š  
é—®ï¼šç»Ÿè®¡ä¸€ä¸‹æ¯ä¸ªåˆ†ç±»æœ‰å¤šå°‘ç§å•†å“ï¼Ÿ
ç­”ï¼šæ°´æœç±»ï¼š2ç§ï¼Œç”µå­ç±»ï¼š1ç§
```

### 1.3 èšåˆæŸ¥è¯¢çš„åº”ç”¨åœºæ™¯


**ğŸ¯ å®é™…åº”ç”¨**
- **ç”µå•†åˆ†æ**ï¼šç»Ÿè®¡æ¯ä¸ªå“ç‰Œçš„é”€é‡ã€å¹³å‡ä»·æ ¼
- **æ—¥å¿—åˆ†æ**ï¼šç»Ÿè®¡æ¯å°æ—¶çš„è®¿é—®é‡ã€é”™è¯¯æ•°é‡
- **ç”¨æˆ·è¡Œä¸º**ï¼šåˆ†æç”¨æˆ·å¹´é¾„åˆ†å¸ƒã€åœ°åŸŸåˆ†å¸ƒ
- **è´¢åŠ¡æŠ¥è¡¨**ï¼šæŒ‰æœˆç»Ÿè®¡æ”¶å…¥ã€æ”¯å‡ºæƒ…å†µ

---

## 2. ğŸ“Š åŸºç¡€èšåˆç±»å‹è¯¦è§£


### 2.1 èšåˆçš„åˆ†ç±»ä½“ç³»


```
Elasticsearchèšåˆå®¶æ—ï¼š

ğŸ“Š æŒ‡æ ‡èšåˆ (Metrics)ï¼šè®¡ç®—æ•°å€¼
â”œâ”€â”€ avgï¼šå¹³å‡å€¼
â”œâ”€â”€ sumï¼šæ€»å’Œ  
â”œâ”€â”€ min/maxï¼šæœ€å°å€¼/æœ€å¤§å€¼
â”œâ”€â”€ countï¼šè®¡æ•°
â””â”€â”€ cardinalityï¼šå»é‡è®¡æ•°

ğŸ“ˆ æ¡¶èšåˆ (Buckets)ï¼šåˆ†ç»„ç»Ÿè®¡
â”œâ”€â”€ termsï¼šæŒ‰è¯æ¡åˆ†ç»„
â”œâ”€â”€ date_histogramï¼šæŒ‰æ—¶é—´åˆ†ç»„
â”œâ”€â”€ rangeï¼šæŒ‰æ•°å€¼èŒƒå›´åˆ†ç»„
â””â”€â”€ histogramï¼šæŒ‰æ•°å€¼é—´éš”åˆ†ç»„

ğŸ”— ç®¡é“èšåˆ (Pipeline)ï¼šåŸºäºå…¶ä»–èšåˆç»“æœ
â””â”€â”€ å¯¹èšåˆç»“æœå†æ¬¡èšåˆ
```

### 2.2 èšåˆæŸ¥è¯¢çš„åŸºæœ¬ç»“æ„


**åŸºç¡€è¯­æ³•æ¨¡æ¿**ï¼š
```json
{
  "aggs": {                    // èšåˆå…³é”®å­—
    "èšåˆåç§°": {               // è‡ªå®šä¹‰åç§°
      "èšåˆç±»å‹": {             // terms/avg/date_histogramç­‰
        "field": "å­—æ®µå"      // è¦èšåˆçš„å­—æ®µ
      }
    }
  }
}
```

**ğŸ”¸ è¯­æ³•è§£é‡Š**
- `aggs`ï¼šå‘Šè¯‰ESè¿™æ˜¯èšåˆæŸ¥è¯¢
- `èšåˆåç§°`ï¼šä½ ç»™è¿™ä¸ªèšåˆèµ·çš„åå­—ï¼Œç»“æœé‡Œä¼šç”¨è¿™ä¸ªåå­—
- `èšåˆç±»å‹`ï¼šé€‰æ‹©ç”¨ä»€ä¹ˆæ–¹å¼èšåˆï¼ˆè®¡æ•°ã€æ±‚å¹³å‡ç­‰ï¼‰
- `field`ï¼šæŒ‡å®šå¯¹å“ªä¸ªå­—æ®µè¿›è¡Œèšåˆ

---

## 3. ğŸ·ï¸ è¯æ¡èšåˆå®æˆ˜


### 3.1 è¯æ¡èšåˆåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¯æ¡èšåˆ**
è¯æ¡èšåˆå°±æ˜¯"æŒ‰ç±»åˆ«åˆ†ç»„ç»Ÿè®¡"ï¼Œæ¯”å¦‚ç»Ÿè®¡æ¯ä¸ªå“ç‰Œæœ‰å¤šå°‘å•†å“ã€‚

```
åŸå§‹æ•°æ®ï¼š
å•†å“1ï¼šå“ç‰Œ=è‹¹æœ
å•†å“2ï¼šå“ç‰Œ=è‹¹æœ  
å•†å“3ï¼šå“ç‰Œ=åä¸º
å•†å“4ï¼šå“ç‰Œ=åä¸º
å•†å“5ï¼šå“ç‰Œ=åä¸º

è¯æ¡èšåˆç»“æœï¼š
è‹¹æœï¼š2ä¸ªå•†å“
åä¸ºï¼š3ä¸ªå•†å“
```

### 3.2 åŸºç¡€è¯æ¡èšåˆ


**curlå‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "my_agg": {
        "terms": {
          "field": "category.keyword"
        }
      }
    }
  }'
```

**ğŸ”¸ å‘½ä»¤è§£æ**
- `my_agg`ï¼šèšåˆç»“æœçš„åç§°ï¼Œå¯ä»¥è‡ªå·±å®šä¹‰
- `terms`ï¼šè¯æ¡èšåˆç±»å‹
- `category.keyword`ï¼šæŒ‰categoryå­—æ®µåˆ†ç»„

> **ğŸ’¡ ä¸ºä»€ä¹ˆç”¨ `.keyword`ï¼Ÿ**
> 
> ESä¸­æ–‡æœ¬å­—æ®µæœ‰ä¸¤ç§ç±»å‹ï¼š
> - `text`ï¼šç”¨äºå…¨æ–‡æœç´¢ï¼Œä¼šåˆ†è¯
> - `keyword`ï¼šç”¨äºç²¾ç¡®åŒ¹é…å’Œèšåˆï¼Œä¸åˆ†è¯
> 
> èšåˆæ—¶é€šå¸¸ç”¨ `.keyword` ç¡®ä¿ç²¾ç¡®åˆ†ç»„

### 3.3 è¯æ¡èšåˆè¿›é˜¶é…ç½®


**è®¾ç½®è¿”å›æ•°é‡**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "top_categories": {
        "terms": {
          "field": "category.keyword",
          "size": 10
        }
      }
    }
  }'
```

**æŒ‰æ–‡æ¡£æ•°é‡æ’åº**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "popular_brands": {
        "terms": {
          "field": "brand.keyword",
          "order": { "_count": "desc" }
        }
      }
    }
  }'
```

### 3.4 è¯æ¡èšåˆç»“æœè§£è¯»


**å…¸å‹è¿”å›ç»“æœ**ï¼š
```json
{
  "aggregations": {
    "my_agg": {
      "buckets": [
        {
          "key": "ç”µå­äº§å“",
          "doc_count": 150
        },
        {
          "key": "æœè£…",  
          "doc_count": 89
        }
      ]
    }
  }
}
```

**ğŸ”¸ ç»“æœè¯´æ˜**
- `buckets`ï¼šåˆ†ç»„ç»“æœæ•°ç»„
- `key`ï¼šåˆ†ç»„çš„å€¼ï¼ˆæ¯”å¦‚"ç”µå­äº§å“"ï¼‰
- `doc_count`ï¼šè¯¥ç»„å†…çš„æ–‡æ¡£æ•°é‡

---

## 4. ğŸ”¢ æ•°å€¼èšåˆæ“ä½œ


### 4.1 å¹³å‡å€¼èšåˆ


**åŸºæœ¬ç”¨æ³•**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "avg_price": {
        "avg": {
          "field": "price"
        }
      }
    }
  }'
```

**ğŸ”¸ åº”ç”¨åœºæ™¯**
- è®¡ç®—å•†å“å¹³å‡ä»·æ ¼
- ç»Ÿè®¡ç”¨æˆ·å¹³å‡å¹´é¾„
- åˆ†æå¹³å‡å“åº”æ—¶é—´

### 4.2 å¤šç§æ•°å€¼èšåˆç»„åˆ


**ä¸€æ¬¡è®¡ç®—å¤šä¸ªç»Ÿè®¡å€¼**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "price_stats": {
        "stats": {
          "field": "price"
        }
      }
    }
  }'
```

**statsèšåˆè¿”å›ç»“æœ**ï¼š
```json
{
  "aggregations": {
    "price_stats": {
      "count": 100,        // æ€»æ•°é‡
      "min": 10.0,         // æœ€å°å€¼
      "max": 999.0,        // æœ€å¤§å€¼
      "avg": 156.5,        // å¹³å‡å€¼
      "sum": 15650.0       // æ€»å’Œ
    }
  }
}
```

### 4.3 å•ç‹¬çš„æ•°å€¼èšåˆ


**æ±‚å’Œèšåˆ**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "total_sales": {
        "sum": {
          "field": "sales_amount"
        }
      }
    }
  }'
```

**æœ€å¤§å€¼èšåˆ**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "max_price": {
        "max": {
          "field": "price"
        }
      }
    }
  }'
```

---

## 5. ğŸ“… æ—¥æœŸç›´æ–¹å›¾èšåˆ


### 5.1 æ—¥æœŸç›´æ–¹å›¾çš„ä½œç”¨


**ğŸ”¸ ç®€å•ç†è§£**
æ—¥æœŸç›´æ–¹å›¾å°±æ˜¯"æŒ‰æ—¶é—´æ®µåˆ†ç»„ç»Ÿè®¡"ï¼Œæ¯”å¦‚ç»Ÿè®¡æ¯å¤©ã€æ¯æœˆçš„é”€å”®é‡ã€‚

```
æ—¶é—´è½´åˆ†æç¤ºä¾‹ï¼š
2024-01-01: 10ç¬”è®¢å•
2024-01-02: 15ç¬”è®¢å•  
2024-01-03: 8ç¬”è®¢å•
2024-01-04: 12ç¬”è®¢å•

è¿™å°±æ˜¯æŒ‰å¤©è¿›è¡Œçš„æ—¥æœŸç›´æ–¹å›¾èšåˆ
```

### 5.2 åŸºç¡€æ—¥æœŸç›´æ–¹å›¾


**æŒ‰å¤©ç»Ÿè®¡**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "daily_sales": {
        "date_histogram": {
          "field": "create_date",
          "calendar_interval": "day"
        }
      }
    }
  }'
```

**ğŸ”¸ æ—¶é—´é—´éš”é€‰é¡¹**
- `day`ï¼šæŒ‰å¤©åˆ†ç»„
- `week`ï¼šæŒ‰å‘¨åˆ†ç»„  
- `month`ï¼šæŒ‰æœˆåˆ†ç»„
- `hour`ï¼šæŒ‰å°æ—¶åˆ†ç»„

### 5.3 è‡ªå®šä¹‰æ—¶é—´é—´éš”


**æŒ‰å°æ—¶ç»Ÿè®¡**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "hourly_traffic": {
        "date_histogram": {
          "field": "timestamp",
          "fixed_interval": "1h"
        }
      }
    }
  }'
```

**è‡ªå®šä¹‰é—´éš”**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "custom_interval": {
        "date_histogram": {
          "field": "timestamp",
          "fixed_interval": "30m"
        }
      }
    }
  }'
```

### 5.4 æ—¥æœŸç›´æ–¹å›¾ç»“æœè§£è¯»


**å…¸å‹è¿”å›ç»“æœ**ï¼š
```json
{
  "aggregations": {
    "daily_sales": {
      "buckets": [
        {
          "key_as_string": "2024-01-01",
          "key": 1704067200000,
          "doc_count": 25
        },
        {
          "key_as_string": "2024-01-02", 
          "key": 1704153600000,
          "doc_count": 31
        }
      ]
    }
  }
}
```

**ğŸ”¸ å­—æ®µè¯´æ˜**
- `key_as_string`ï¼šäººç±»å¯è¯»çš„æ—¥æœŸæ ¼å¼
- `key`ï¼šæ—¶é—´æˆ³æ ¼å¼
- `doc_count`ï¼šè¯¥æ—¶é—´æ®µå†…çš„æ–‡æ¡£æ•°é‡

---

## 6. ğŸ¯ åŸºæ•°èšåˆåº”ç”¨


### 6.1 åŸºæ•°èšåˆçš„å«ä¹‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯åŸºæ•°èšåˆ**
åŸºæ•°èšåˆç”¨æ¥ç»Ÿè®¡"æœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼"ï¼Œç±»ä¼¼äºSQLçš„`COUNT(DISTINCT)`ã€‚

```
æ•°æ®ç¤ºä¾‹ï¼š
ç”¨æˆ·Aè®¿é—®äº†ç½‘ç«™
ç”¨æˆ·Bè®¿é—®äº†ç½‘ç«™
ç”¨æˆ·Aåˆè®¿é—®äº†ç½‘ç«™
ç”¨æˆ·Cè®¿é—®äº†ç½‘ç«™

åŸºæ•°èšåˆç»“æœï¼šç‹¬ç«‹è®¿å®¢æ•° = 3 (Aã€Bã€C)
è€Œä¸æ˜¯æ€»è®¿é—®æ¬¡æ•° 4
```

### 6.2 åŸºç¡€åŸºæ•°èšåˆ


**ç»Ÿè®¡ç‹¬ç«‹ç”¨æˆ·æ•°**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "unique_users": {
        "cardinality": {
          "field": "user_id"
        }
      }
    }
  }'
```

**ç»Ÿè®¡ç‹¬ç«‹IPæ•°é‡**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "unique_ips": {
        "cardinality": {
          "field": "client_ip.keyword"
        }
      }
    }
  }'
```

### 6.3 åŸºæ•°èšåˆçš„ç²¾åº¦æ§åˆ¶


**æé«˜ç²¾åº¦**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "precise_unique_users": {
        "cardinality": {
          "field": "user_id",
          "precision_threshold": 10000
        }
      }
    }
  }'
```

> **ğŸ’¡ ç²¾åº¦è¯´æ˜**
> 
> åŸºæ•°èšåˆä½¿ç”¨è¿‘ä¼¼ç®—æ³•ï¼Œ`precision_threshold`å¯ä»¥æé«˜ç²¾åº¦ï¼š
> - é»˜è®¤å€¼ï¼š3000
> - æœ€å¤§å€¼ï¼š40000  
> - å€¼è¶Šå¤§ç²¾åº¦è¶Šé«˜ï¼Œä½†æ¶ˆè€—å†…å­˜ä¹Ÿè¶Šå¤§

### 6.4 åŸºæ•°èšåˆåº”ç”¨åœºæ™¯


**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

| åœºæ™¯ | èšåˆå­—æ®µ | ä¸šåŠ¡å«ä¹‰ |
|------|---------|---------|
| **ç½‘ç«™åˆ†æ** | `user_id` | ç‹¬ç«‹è®¿å®¢æ•°UV |
| **ç”µå•†åˆ†æ** | `product_id` | æœ‰å¤šå°‘ç§ä¸åŒå•†å“ |
| **æ—¥å¿—åˆ†æ** | `client_ip` | ç‹¬ç«‹IPè®¿é—®æ•° |
| **å†…å®¹åˆ†æ** | `author_id` | æœ‰å¤šå°‘ä¸åŒä½œè€… |

---

## 7. ğŸ”— åµŒå¥—èšåˆæŸ¥è¯¢


### 7.1 åµŒå¥—èšåˆçš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯åµŒå¥—èšåˆ**
åµŒå¥—èšåˆå°±æ˜¯"åœ¨åˆ†ç»„çš„åŸºç¡€ä¸Šå†åˆ†ç»„"ï¼Œå®ç°å¤šç»´åº¦åˆ†æã€‚

```
ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹ï¼š
æˆ‘æƒ³çŸ¥é“æ¯ä¸ªå“ç‰Œä¸‹ï¼Œä¸åŒä»·æ ¼åŒºé—´çš„å•†å“æ•°é‡

ç¬¬ä¸€å±‚ï¼šæŒ‰å“ç‰Œåˆ†ç»„ (è‹¹æœã€åä¸ºã€å°ç±³)
ç¬¬äºŒå±‚ï¼šåœ¨æ¯ä¸ªå“ç‰Œå†…ï¼ŒæŒ‰ä»·æ ¼åŒºé—´åˆ†ç»„ (0-1000, 1000-3000, 3000+)

ç»“æœï¼š
è‹¹æœ:
  â”œâ”€â”€ 0-1000å…ƒ: 5ä»¶
  â”œâ”€â”€ 1000-3000å…ƒ: 15ä»¶  
  â””â”€â”€ 3000å…ƒ+: 25ä»¶
åä¸º:
  â”œâ”€â”€ 0-1000å…ƒ: 8ä»¶
  â””â”€â”€ 1000-3000å…ƒ: 12ä»¶
```

### 7.2 åŸºç¡€åµŒå¥—èšåˆ


**å“ç‰Œ+ä»·æ ¼åŒºé—´åˆ†æ**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "brands": {
        "terms": {
          "field": "brand.keyword"
        },
        "aggs": {
          "price_ranges": {
            "range": {
              "field": "price",
              "ranges": [
                { "to": 1000 },
                { "from": 1000, "to": 3000 },
                { "from": 3000 }
              ]
            }
          }
        }
      }
    }
  }'
```

### 7.3 å¤šå±‚åµŒå¥—èšåˆ


**ä¸‰å±‚åµŒå¥—ï¼šå“ç‰Œâ†’ç±»åˆ«â†’ä»·æ ¼ç»Ÿè®¡**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "brands": {
        "terms": {
          "field": "brand.keyword"
        },
        "aggs": {
          "categories": {
            "terms": {
              "field": "category.keyword"
            },
            "aggs": {
              "avg_price": {
                "avg": {
                  "field": "price"
                }
              }
            }
          }
        }
      }
    }
  }'
```

### 7.4 æ—¶é—´+æŒ‡æ ‡åµŒå¥—


**æŒ‰æ—¥æœŸåˆ†ç»„+è®¡ç®—æ¯æ—¥å¹³å‡å€¼**ï¼š
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "daily_analysis": {
        "date_histogram": {
          "field": "create_date",
          "calendar_interval": "day"
        },
        "aggs": {
          "daily_avg_price": {
            "avg": {
              "field": "price"
            }
          },
          "daily_total_sales": {
            "sum": {
              "field": "sales_amount"
            }
          }
        }
      }
    }
  }'
```

---

## 8. ğŸ“ˆ èšåˆç»“æœè§£æ


### 8.1 åµŒå¥—èšåˆç»“æœç»“æ„


**åµŒå¥—èšåˆè¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "aggregations": {
    "brands": {
      "buckets": [
        {
          "key": "è‹¹æœ",
          "doc_count": 45,
          "price_ranges": {
            "buckets": [
              {
                "key": "*-1000.0",
                "to": 1000.0,
                "doc_count": 5
              },
              {
                "key": "1000.0-3000.0", 
                "from": 1000.0,
                "to": 3000.0,
                "doc_count": 15
              }
            ]
          }
        }
      ]
    }
  }
}
```

### 8.2 ç»“æœè§£ææŠ€å·§


**ğŸ”¸ é€å±‚è§£è¯»æ–¹æ³•**
```
ç¬¬1å±‚ï¼šbrands.buckets[] 
  â†“
æ¯ä¸ªå“ç‰Œçš„ä¿¡æ¯ï¼škey=å“ç‰Œå, doc_count=è¯¥å“ç‰Œå•†å“æ€»æ•°
  â†“  
ç¬¬2å±‚ï¼šprice_ranges.buckets[]
  â†“
æ¯ä¸ªä»·æ ¼åŒºé—´ï¼škey=åŒºé—´åç§°, doc_count=è¯¥åŒºé—´å•†å“æ•°
```

### 8.3 æå–å…³é”®æ•°æ®


**è§£æè„šæœ¬ç¤ºä¾‹æ€è·¯**ï¼š
```bash
# å‡è®¾ä¿å­˜ç»“æœåˆ°result.jsonï¼Œå¯ä»¥ç”¨jqè§£æ
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d 'èšåˆæŸ¥è¯¢JSON' > result.json

# æå–å“ç‰Œå’Œå¯¹åº”å•†å“æ•°é‡
cat result.json | jq '.aggregations.brands.buckets[] | {brand: .key, count: .doc_count}'
```

---

## 9. ğŸš€ å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ


### 9.1 ç”µå•†é”€å”®åˆ†ææ¡ˆä¾‹


**ä¸šåŠ¡éœ€æ±‚**ï¼šåˆ†ææœ€è¿‘ä¸€ä¸ªæœˆçš„é”€å”®æƒ…å†µ
- æ¯æ—¥é”€å”®è¶‹åŠ¿
- çƒ­é—¨å•†å“ç±»åˆ«  
- å„ä»·æ ¼åŒºé—´é”€é‡

**ç»„åˆæŸ¥è¯¢**ï¼š
```bash
curl -X POST "localhost:9200/shop_orders/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "range": {
        "order_date": {
          "gte": "2024-08-01",
          "lte": "2024-08-31"
        }
      }
    },
    "aggs": {
      "daily_trend": {
        "date_histogram": {
          "field": "order_date", 
          "calendar_interval": "day"
        },
        "aggs": {
          "daily_revenue": {
            "sum": {
              "field": "total_amount"
            }
          }
        }
      },
      "top_categories": {
        "terms": {
          "field": "category.keyword",
          "size": 5
        }
      },
      "price_distribution": {
        "range": {
          "field": "product_price",
          "ranges": [
            { "key": "ä½ä»·ä½", "to": 100 },
            { "key": "ä¸­ä»·ä½", "from": 100, "to": 500 },
            { "key": "é«˜ä»·ä½", "from": 500 }
          ]
        }
      }
    }
  }'
```

### 9.2 ç½‘ç«™è®¿é—®åˆ†ææ¡ˆä¾‹


**ä¸šåŠ¡éœ€æ±‚**ï¼šåˆ†æç½‘ç«™è®¿é—®æ¨¡å¼
- æ¯å°æ—¶è®¿é—®é‡
- ç‹¬ç«‹è®¿å®¢æ•°
- çƒ­é—¨é¡µé¢

**è®¿é—®åˆ†ææŸ¥è¯¢**ï¼š
```bash
curl -X POST "localhost:9200/website_logs/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "hourly_visits": {
        "date_histogram": {
          "field": "timestamp",
          "fixed_interval": "1h"
        },
        "aggs": {
          "unique_visitors": {
            "cardinality": {
              "field": "user_id"
            }
          }
        }
      },
      "popular_pages": {
        "terms": {
          "field": "page_url.keyword",
          "size": 10,
          "order": { "_count": "desc" }
        }
      }
    }
  }'
```

### 9.3 ç”¨æˆ·è¡Œä¸ºåˆ†ææ¡ˆä¾‹


**å¤šç»´åº¦ç”¨æˆ·åˆ†æ**ï¼š
```bash
curl -X POST "localhost:9200/user_behavior/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "aggs": {
      "age_groups": {
        "range": {
          "field": "age",
          "ranges": [
            { "key": "18-25", "from": 18, "to": 25 },
            { "key": "26-35", "from": 26, "to": 35 },
            { "key": "36-45", "from": 36, "to": 45 }
          ]
        },
        "aggs": {
          "gender_breakdown": {
            "terms": {
              "field": "gender.keyword"
            },
            "aggs": {
              "avg_purchase_amount": {
                "avg": {
                  "field": "purchase_amount"
                }
              }
            }
          }
        }
      }
    }
  }'
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ èšåˆæœ¬è´¨ï¼šæ•°æ®ç»Ÿè®¡åˆ†æï¼Œä¸è¿”å›å…·ä½“æ–‡æ¡£
ğŸ”¸ åŸºç¡€è¯­æ³•ï¼š{"aggs": {"åç§°": {"ç±»å‹": {"field": "å­—æ®µ"}}}}
ğŸ”¸ ä¸»è¦ç±»å‹ï¼šterms(åˆ†ç»„)ã€avg(å¹³å‡)ã€cardinality(å»é‡)ã€date_histogram(æ—¶é—´)
ğŸ”¸ åµŒå¥—èšåˆï¼šåœ¨åˆ†ç»„åŸºç¡€ä¸Šå†åˆ†ç»„ï¼Œå®ç°å¤šç»´åˆ†æ
ğŸ”¸ ç»“æœè§£æï¼šç†è§£bucketsç»“æ„ï¼Œæå–keyå’Œdoc_count
```

### 10.2 å®ç”¨æŠ€å·§æ€»ç»“


**ğŸ”¹ èšåˆé€‰æ‹©æŒ‡å—**
```
æƒ³è¦åˆ†ç»„ç»Ÿè®¡ â†’ ä½¿ç”¨ terms èšåˆ
æƒ³è¦æ•°å€¼è®¡ç®— â†’ ä½¿ç”¨ avg/sum/max/min èšåˆ  
æƒ³è¦æ—¶é—´åˆ†æ â†’ ä½¿ç”¨ date_histogram èšåˆ
æƒ³è¦å»é‡è®¡æ•° â†’ ä½¿ç”¨ cardinality èšåˆ
æƒ³è¦å¤šç»´åˆ†æ â†’ ä½¿ç”¨åµŒå¥—èšåˆ
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
å­—æ®µé€‰æ‹©ï¼š
- æ–‡æœ¬å­—æ®µç”¨ .keyword åç¼€
- æ•°å€¼å’Œæ—¥æœŸå­—æ®µç›´æ¥ä½¿ç”¨

æŸ¥è¯¢ä¼˜åŒ–ï¼š
- å…ˆç”¨queryè¿‡æ»¤ï¼Œå†èšåˆ
- æ§åˆ¶èšåˆç»“æœæ•°é‡(sizeå‚æ•°)
- é¿å…è¿‡æ·±çš„åµŒå¥—å±‚çº§
```

### 10.3 å¸¸è§é”™è¯¯é¿å…


**âŒ å¸¸è§é”™è¯¯**
```
1. æ–‡æœ¬å­—æ®µå¿˜è®°ç”¨ .keyword
   é”™è¯¯ï¼š{"field": "category"}  
   æ­£ç¡®ï¼š{"field": "category.keyword"}

2. èšåˆå‘½åé‡å¤
   é”™è¯¯ï¼šå¤šä¸ªèšåˆéƒ½å«"my_agg"
   æ­£ç¡®ï¼šç”¨æè¿°æ€§åç§°å¦‚"brand_stats"

3. ç»“æœè§£æé”™è¯¯
   é”™è¯¯ï¼šç›´æ¥è¯»å– .key 
   æ­£ç¡®ï¼šå…ˆæ£€æŸ¥ buckets æ•°ç»„å­˜åœ¨
```

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ“š å­¦ä¹ é¡ºåºï¼š
1ï¸âƒ£ æŒæ¡åŸºç¡€èšåˆç±»å‹ (terms, avg, sum)
2ï¸âƒ£ ç†è§£æ—¥æœŸå’ŒåŸºæ•°èšåˆ 
3ï¸âƒ£ å­¦ä¹ åµŒå¥—èšåˆç»“æ„
4ï¸âƒ£ å®æˆ˜ä¸šåŠ¡åˆ†ææ¡ˆä¾‹
5ï¸âƒ£ ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

ğŸ¯ å®è·µå»ºè®®ï¼š
- å…ˆç”¨ç®€å•æ•°æ®ç»ƒä¹ åŸºç¡€èšåˆ
- é€æ­¥å¢åŠ åµŒå¥—å±‚çº§
- ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯æ€è€ƒåº”ç”¨
- å¤šçœ‹èšåˆç»“æœï¼Œç†è§£æ•°æ®å«ä¹‰
```

### 10.5 æ ¸å¿ƒå‘½ä»¤é€ŸæŸ¥


**å¿«é€Ÿå‚è€ƒè¡¨**ï¼š

| èšåˆç±»å‹ | å‘½ä»¤æ¨¡æ¿ | ç”¨é€”è¯´æ˜ |
|---------|---------|---------|
| **è¯æ¡èšåˆ** | `"terms": {"field": "category.keyword"}` | æŒ‰ç±»åˆ«åˆ†ç»„ç»Ÿè®¡ |
| **å¹³å‡å€¼** | `"avg": {"field": "price"}` | è®¡ç®—å¹³å‡ä»·æ ¼ |
| **åŸºæ•°èšåˆ** | `"cardinality": {"field": "user_id"}` | ç»Ÿè®¡ç‹¬ç«‹ç”¨æˆ·æ•° |
| **æ—¥æœŸç›´æ–¹å›¾** | `"date_histogram": {"field": "date", "calendar_interval": "day"}` | æŒ‰æ—¶é—´æ®µç»Ÿè®¡ |
| **åµŒå¥—èšåˆ** | `"aggs": {"å­èšåˆå": {...}}` | å¤šç»´åº¦åˆ†æ |

**è®°å¿†å£è¯€**ï¼š
```
èšåˆåˆ†æç”¨aggsï¼Œ
termsåˆ†ç»„å¾ˆå¸¸è§ï¼Œ
avgæ±‚å€¼cardinalityå»é‡ï¼Œ
date_histogramçœ‹è¶‹åŠ¿ï¼Œ
åµŒå¥—èšåˆå¤šç»´åº¦ï¼Œ
fieldå­—æ®µåˆ«å¿˜è®°ï¼
```