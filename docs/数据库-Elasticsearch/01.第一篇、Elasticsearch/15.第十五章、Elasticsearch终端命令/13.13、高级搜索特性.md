---
title: 13、高级搜索特性
---
## 📚 目录

1. [高亮搜索功能](#1-高亮搜索功能)
2. [搜索建议功能](#2-搜索建议功能)
3. [滚动搜索机制](#3-滚动搜索机制)
4. [搜索模板应用](#4-搜索模板应用)
5. [实战应用案例](#5-实战应用案例)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔍 高亮搜索功能


### 1.1 什么是高亮搜索


**💡 通俗理解**：高亮搜索就像在文档中用荧光笔标记关键词一样，让搜索结果中的匹配词汇以特殊样式显示出来。

```
普通搜索结果：
"Elasticsearch是一个强大的搜索引擎"

高亮搜索结果：
"<em>Elasticsearch</em>是一个强大的<em>搜索</em>引擎"
```

**🎯 核心作用**：
- 📌 **快速定位**：用户一眼就能看到匹配的关键词
- 🎨 **增强体验**：让搜索结果更直观易懂
- 📊 **提升效率**：减少用户查找时间

### 1.2 基础高亮操作


**🔧 基本语法**：
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "match": {
        "content": "搜索关键词"
      }
    },
    "highlight": {
      "fields": {
        "content": {}
      }
    }
  }'
```

**📋 实际示例**：
```bash
# 在商品索引中搜索"手机"并高亮显示
curl -X POST "localhost:9200/products/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "match": {
        "title": "手机"
      }
    },
    "highlight": {
      "fields": {
        "title": {},
        "description": {}
      }
    }
  }'
```

### 1.3 高亮自定义设置


**🎨 自定义高亮标签**：
```bash
curl -X POST "localhost:9200/articles/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "match": {
        "content": "elasticsearch"
      }
    },
    "highlight": {
      "pre_tags": ["<mark>"],
      "post_tags": ["</mark>"],
      "fields": {
        "content": {
          "fragment_size": 100,
          "number_of_fragments": 3
        }
      }
    }
  }'
```

**⚙️ 参数说明**：

| 参数 | 作用 | 示例值 |
|------|------|--------|
| `pre_tags` | 高亮开始标签 | `["<mark>"]` |
| `post_tags` | 高亮结束标签 | `["</mark>"]` |
| `fragment_size` | 片段大小（字符数） | `100` |
| `number_of_fragments` | 返回片段数量 | `3` |

---

## 2. 🔎 搜索建议功能


### 2.1 搜索建议的概念


**💡 简单理解**：搜索建议就像手机输入法的联想功能，当你输入几个字符时，系统会自动推荐可能的完整词汇。

```
用户输入：     系统建议：
"elas"    →   "elasticsearch"
                "elastic"
                "elasticity"
```

**🎯 主要用途**：
- 🔧 **纠错功能**：帮用户修正拼写错误
- ⚡ **自动补全**：提升输入效率
- 🎨 **提升体验**：减少用户思考成本

### 2.2 基础建议操作


**🔧 基本语法**：
```bash
curl -X POST "localhost:9200/my_index/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "suggest": {
      "my_suggestion": {
        "text": "用户输入的文本",
        "term": {
          "field": "字段名"
        }
      }
    }
  }'
```

**📋 实际示例**：
```bash
# 为用户输入"elasitc"提供拼写建议
curl -X POST "localhost:9200/products/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "suggest": {
      "title_suggest": {
        "text": "elasitc",
        "term": {
          "field": "title"
        }
      }
    }
  }'
```

### 2.3 不同类型的建议


**📝 建议类型对比**：

```
Term建议 - 词汇纠错：
输入："elasitc"
建议："elastic"

Phrase建议 - 短语纠错：
输入："quick brwon fox"
建议："quick brown fox"

Completion建议 - 自动补全：
输入："elas"
建议：["elasticsearch", "elastic search", "elasticity"]
```

**🔧 短语建议示例**：
```bash
curl -X POST "localhost:9200/articles/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "suggest": {
      "phrase_suggest": {
        "text": "quick brwon fox",
        "phrase": {
          "field": "content",
          "size": 3
        }
      }
    }
  }'
```

---

## 3. 📜 滚动搜索机制


### 3.1 为什么需要滚动搜索


**💡 现实比喻**：想象你要看一本1000页的书，你不可能一次性把所有页面都铺在桌子上看，而是一页一页地翻看。滚动搜索就是这个道理。

**🚫 普通搜索的问题**：
```
问题场景：需要获取100万条数据
普通方式：一次性返回所有数据
结果：    💥 内存爆炸、系统崩溃

解决方案：滚动搜索
方式：    分批次获取，每次1000条
结果：    ✅ 稳定高效
```

### 3.2 滚动搜索的工作流程


**📊 执行流程图**：
```
步骤1: 发起滚动搜索请求
   ↓
步骤2: ES创建搜索快照，返回scroll_id
   ↓
步骤3: 使用scroll_id获取下一批数据
   ↓
步骤4: 重复步骤3，直到数据获取完毕
   ↓
步骤5: 清理scroll_id，释放资源
```

### 3.3 滚动搜索实际操作


**🔧 第一步：发起滚动搜索**
```bash
curl -X GET "localhost:9200/products/_search?scroll=1m" \
  -H "Content-Type: application/json" \
  -d '{
    "size": 1000,
    "query": {
      "match_all": {}
    }
  }'
```

> 💡 **参数解释**：
> - `scroll=1m`：保持搜索上下文1分钟
> - `size: 1000`：每批返回1000条数据

**🔧 第二步：继续滚动获取**
```bash
curl -X POST "localhost:9200/_search/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "scroll": "1m",
    "scroll_id": "你从第一步获得的scroll_id"
  }'
```

**🔧 第三步：清理滚动上下文**
```bash
curl -X DELETE "localhost:9200/_search/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "scroll_id": "要清理的scroll_id"
  }'
```

### 3.4 滚动搜索注意事项


**⚠️ 重要提醒**：

| 注意点 | 说明 | 建议 |
|--------|------|------|
| **及时清理** | scroll_id会占用内存 | 用完立即清理 |
| **时间设置** | 过长浪费资源，过短可能中断 | 一般设置1-5分钟 |
| **批次大小** | 太大内存压力大，太小效率低 | 建议1000-5000条 |

---

## 4. 📋 搜索模板应用


### 4.1 搜索模板的概念


**💡 生活比喻**：搜索模板就像做菜的菜谱，你定义好步骤和配料清单，每次做菜时只需要准备具体的食材就行了。

```
传统方式：每次都写完整的搜索语句
模板方式：预定义搜索结构，使用时只传参数

好处：
✅ 复用性强     ✅ 减少错误
✅ 维护方便     ✅ 性能更好
```

### 4.2 创建搜索模板


**🔧 模板创建语法**：
```bash
curl -X PUT "localhost:9200/_scripts/my_search_template" \
  -H "Content-Type: application/json" \
  -d '{
    "script": {
      "lang": "mustache",
      "source": {
        "query": {
          "bool": {
            "must": [
              {
                "match": {
                  "{{field_name}}": "{{search_value}}"
                }
              }
            ],
            "filter": [
              {
                "range": {
                  "price": {
                    "gte": {{min_price}},
                    "lte": {{max_price}}
                  }
                }
              }
            ]
          }
        }
      }
    }
  }'
```

### 4.3 使用搜索模板


**🔧 模板使用示例**：
```bash
curl -X POST "localhost:9200/products/_search/template" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "my_search_template",
    "params": {
      "field_name": "title",
      "search_value": "手机",
      "min_price": 1000,
      "max_price": 5000
    }
  }'
```

**🎯 模板的优势**：

```
代码复用：
❌ 原来：每个搜索都写一遍完整查询
✅ 现在：定义一次，到处使用

参数化查询：
❌ 原来：硬编码搜索条件
✅ 现在：动态传入参数

性能优化：
❌ 原来：每次都要解析查询语句
✅ 现在：模板预编译，执行更快
```

---

## 5. 🏆 实战应用案例


### 5.1 电商搜索完整案例


**📊 业务场景**：用户在电商网站搜索商品，需要高亮显示、搜索建议、分页浏览

```bash
# 创建商品索引
curl -X PUT "localhost:9200/ecommerce" \
  -H "Content-Type: application/json" \
  -d '{
    "mappings": {
      "properties": {
        "title": {
          "type": "text",
          "analyzer": "ik_max_word"
        },
        "description": {
          "type": "text",
          "analyzer": "ik_max_word"
        },
        "price": {
          "type": "double"
        },
        "category": {
          "type": "keyword"
        }
      }
    }
  }'
```

**🔍 综合搜索请求**：
```bash
curl -X POST "localhost:9200/ecommerce/_search" \
  -H "Content-Type: application/json" \
  -d '{
    "query": {
      "bool": {
        "must": [
          {
            "multi_match": {
              "query": "智能手机",
              "fields": ["title^2", "description"]
            }
          }
        ],
        "filter": [
          {
            "range": {
              "price": {
                "gte": 1000,
                "lte": 8000
              }
            }
          }
        ]
      }
    },
    "highlight": {
      "fields": {
        "title": {},
        "description": {}
      }
    },
    "suggest": {
      "title_suggest": {
        "text": "智能手机",
        "term": {
          "field": "title"
        }
      }
    },
    "size": 20,
    "from": 0
  }'
```

### 5.2 大数据量处理案例


**📊 场景描述**：需要导出100万条日志数据进行分析

```bash
# 第一步：启动滚动搜索
curl -X GET "localhost:9200/logs/_search?scroll=5m" \
  -H "Content-Type: application/json" \
  -d '{
    "size": 5000,
    "query": {
      "range": {
        "timestamp": {
          "gte": "2024-01-01",
          "lte": "2024-12-31"
        }
      }
    },
    "_source": ["timestamp", "level", "message"]
  }'

# 第二步：处理返回的数据和scroll_id
# 第三步：继续获取下一批数据
curl -X POST "localhost:9200/_search/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "scroll": "5m",
    "scroll_id": "从上一步获得的scroll_id"
  }'

# 重复第三步直到没有更多数据
# 最后：清理资源
curl -X DELETE "localhost:9200/_search/scroll" \
  -H "Content-Type: application/json" \
  -d '{
    "scroll_id": "要清理的scroll_id"
  }'
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔍 高亮搜索：
• 作用：突出显示匹配的关键词
• 场景：提升用户体验的搜索功能
• 关键：pre_tags、post_tags配置

🔎 搜索建议：
• 作用：纠错和自动补全
• 类型：term、phrase、completion
• 场景：输入框智能提示

📜 滚动搜索：
• 作用：高效处理大量数据
• 流程：创建→获取→清理
• 注意：及时清理scroll_id

📋 搜索模板：
• 作用：复用查询逻辑
• 优势：参数化、高性能
• 语法：mustache模板引擎
```

### 6.2 关键操作命令


**🔧 核心命令总结**：

| 功能 | 命令格式 | 关键参数 |
|------|----------|----------|
| **高亮搜索** | `POST /index/_search` | `highlight.fields` |
| **搜索建议** | `POST /index/_search` | `suggest.text` |
| **开始滚动** | `GET /index/_search?scroll=1m` | `scroll`、`size` |
| **继续滚动** | `POST /_search/scroll` | `scroll_id` |
| **清理滚动** | `DELETE /_search/scroll` | `scroll_id` |
| **搜索模板** | `POST /index/_search/template` | `id`、`params` |

### 6.3 实际应用建议


**💡 最佳实践**：

```
高亮搜索：
✅ 合理设置片段大小（100-200字符）
✅ 限制高亮字段数量（避免性能问题）
✅ 自定义高亮标签适配前端需求

搜索建议：
✅ 根据业务选择合适的建议类型
✅ 设置合理的建议数量（通常3-5个）
✅ 考虑建议的相关性和准确性

滚动搜索：
✅ 处理大数据时的首选方案
✅ 及时清理scroll_id避免内存泄漏
✅ 合理设置批次大小平衡性能

搜索模板：
✅ 复杂查询场景下提升开发效率
✅ 统一团队的查询规范
✅ 便于查询逻辑的维护和优化
```

**核心记忆**：
- 高亮让关键词更醒目，提升用户体验
- 建议帮助用户快速找到想要的内容
- 滚动处理大数据，分批获取更稳定
- 模板复用查询逻辑，开发维护更高效