---
title: 22、快照仓库管理
---
## 📚 目录

1. [快照仓库基础概念](#1-快照仓库基础概念)
2. [创建快照仓库](#2-创建快照仓库)
3. [查看仓库信息](#3-查看仓库信息)
4. [验证仓库连接](#4-验证仓库连接)
5. [列出所有仓库](#5-列出所有仓库)
6. [删除快照仓库](#6-删除快照仓库)
7. [仓库类型与配置](#7-仓库类型与配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🗂️ 快照仓库基础概念


### 1.1 什么是快照仓库

**简单理解**：快照仓库就像是一个**专门存放备份文件的仓库**，类似云盘或网络硬盘。

```
生活中的类比：
📦 快照仓库 = 备份存储柜
📄 快照 = 某个时刻的文件备份
🏢 Elasticsearch = 你的办公室数据

过程：办公室数据 → 打包备份 → 存放到存储柜
```

### 1.2 为什么需要快照仓库

**核心目的**：保护数据安全，防止意外丢失

```
常见风险场景：
❌ 服务器硬盘损坏
❌ 误删重要索引
❌ 系统升级失败
❌ 恶意攻击破坏

解决方案：
✅ 定期备份到快照仓库
✅ 需要时快速恢复
✅ 多地存储保障安全
```

### 1.3 快照仓库的工作原理

```
工作流程图：
Elasticsearch集群 → 创建快照 → 存储到仓库 → 需要时恢复

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ES集群数据     │───▶│   快照仓库      │───▶│   恢复到集群    │
│  索引、文档     │    │   备份文件      │    │   原始数据      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 2. 🔧 创建快照仓库


### 2.1 基本创建命令

**命令语法**：
```bash
curl -X PUT "localhost:9200/_snapshot/仓库名称" -H 'Content-Type: application/json' -d'配置参数'
```

### 2.2 文件系统类型仓库（最常用）

```bash
# 创建本地文件系统仓库
curl -X PUT "localhost:9200/_snapshot/my_repository" \
-H 'Content-Type: application/json' -d'
{
  "type": "fs",
  "settings": {
    "location": "/backup/elasticsearch",
    "compress": true
  }
}'
```

**参数说明**：
- **`type: "fs"`**：文件系统类型，数据存储在本地磁盘
- **`location`**：备份文件存储路径，必须是ES可访问的目录
- **`compress: true`**：启用压缩，节省存储空间

> 💡 **注意**：`location`路径必须在`elasticsearch.yml`的`path.repo`配置中预先允许

### 2.3 创建成功响应

```json
{
  "acknowledged": true
}
```

---

## 3. 📋 查看仓库信息


### 3.1 查看单个仓库详情

```bash
# 查看指定仓库的详细信息
curl -X GET "localhost:9200/_snapshot/my_repository"
```

**响应示例**：
```json
{
  "my_repository": {
    "type": "fs",
    "settings": {
      "location": "/backup/elasticsearch",
      "compress": "true"
    }
  }
}
```

### 3.2 查看仓库中的快照列表

```bash
# 查看仓库中所有快照
curl -X GET "localhost:9200/_snapshot/my_repository/_all"
```

### 3.3 获取仓库统计信息

```bash
# 查看仓库使用情况
curl -X GET "localhost:9200/_snapshot/my_repository/_status"
```

---

## 4. ✅ 验证仓库连接


### 4.1 验证仓库是否正常工作

```bash
# 验证仓库连接和权限
curl -X POST "localhost:9200/_snapshot/my_repository/_verify"
```

**成功响应**：
```json
{
  "nodes": {
    "node-1": {
      "name": "node-1"
    },
    "node-2": {
      "name": "node-2"
    }
  }
}
```

### 4.2 验证的作用

**验证检查项目**：
- ✅ 仓库路径是否可访问
- ✅ 集群所有节点是否能写入
- ✅ 权限设置是否正确
- ✅ 网络连接是否正常

> ⚠️ **建议**：创建仓库后立即验证，确保配置正确

---

## 5. 📖 列出所有仓库


### 5.1 查看所有已配置的仓库

```bash
# 列出集群中所有快照仓库
curl -X GET "localhost:9200/_snapshot"
```

**响应示例**：
```json
{
  "my_repository": {
    "type": "fs",
    "settings": {
      "location": "/backup/elasticsearch",
      "compress": "true"
    }
  },
  "backup_repo_2": {
    "type": "fs", 
    "settings": {
      "location": "/backup/es_backup2"
    }
  }
}
```

### 5.2 简化查看（仅显示仓库名称）

```bash
# 只显示仓库名称列表
curl -X GET "localhost:9200/_snapshot/_all?format=txt"
```

---

## 6. 🗑️ 删除快照仓库


### 6.1 删除仓库命令

```bash
# 删除指定的快照仓库
curl -X DELETE "localhost:9200/_snapshot/my_repository"
```

**成功响应**：
```json
{
  "acknowledged": true
}
}
```

### 6.2 删除注意事项

**重要提醒**：
- ❌ **删除仓库不会删除快照文件**：物理文件仍在存储位置
- ❌ **仅移除ES中的仓库配置**：断开ES与存储位置的连接
- ✅ **如需删除快照数据**：需要手动删除存储目录中的文件

**安全操作流程**：
```
1. 确认不再需要该仓库 → 2. 备份重要快照 → 3. 删除仓库配置 → 4. 手动清理物理文件
```

---

## 7. 🏗️ 仓库类型与配置


### 7.1 常见仓库类型对比


| 仓库类型 | **说明** | **适用场景** | **配置复杂度** |
|---------|----------|-------------|---------------|
| 📁 **文件系统(fs)** | `存储在本地磁盘` | `单机或共享存储` | `简单` |
| ☁️ **云存储** | `AWS S3、Azure等` | `云环境部署` | `中等` |
| 🌐 **网络存储** | `NFS、CIFS等` | `企业网络环境` | `复杂` |

### 7.2 文件系统仓库详细配置

```bash
curl -X PUT "localhost:9200/_snapshot/advanced_repo" \
-H 'Content-Type: application/json' -d'
{
  "type": "fs",
  "settings": {
    "location": "/backup/elasticsearch",
    "compress": true,
    "chunk_size": "1gb",
    "max_restore_bytes_per_sec": "40mb",
    "max_snapshot_bytes_per_sec": "40mb"
  }
}'
```

**高级参数说明**：
- **`chunk_size`**：分块大小，大文件分割存储
- **`max_restore_bytes_per_sec`**：恢复时的速度限制
- **`max_snapshot_bytes_per_sec`**：备份时的速度限制

### 7.3 配置路径权限

**elasticsearch.yml配置**：
```yaml
# 允许的仓库路径
path.repo: ["/backup/elasticsearch", "/backup/es_backup2"]
```

> 🔒 **安全考虑**：ES只能访问预先配置的路径，防止任意目录访问

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本操作


```
🔸 创建仓库：PUT /_snapshot/仓库名 + 配置参数
🔸 查看仓库：GET /_snapshot/仓库名 查看详情
🔸 验证仓库：POST /_snapshot/仓库名/_verify 确保可用
🔸 列出仓库：GET /_snapshot 查看所有配置
🔸 删除仓库：DELETE /_snapshot/仓库名 移除配置
```

### 8.2 关键理解要点


**🔹 仓库vs快照的关系**
```
关系类比：
仓库 = 图书馆
快照 = 图书馆中的书籍

一个仓库可以存储多个快照
删除仓库不会删除快照文件
```

**🔹 文件系统仓库的路径要求**
```
必要条件：
1. ES配置文件中预先允许路径
2. ES进程有读写权限
3. 集群所有节点都能访问该路径
```

**🔹 验证仓库的重要性**
```
验证目的：
- 确保配置正确
- 避免备份时出错
- 检查集群节点连通性
- 验证权限设置
```

### 8.3 实际应用建议


**📦 仓库命名规范**
```bash
# 建议的命名方式
daily_backup          # 日常备份仓库
weekly_backup          # 周备份仓库  
migration_backup       # 迁移备份仓库
test_backup           # 测试备份仓库
```

**🛡️ 安全最佳实践**
- **路径隔离**：不同环境使用不同备份路径
- **权限最小化**：仅给ES必要的读写权限
- **定期验证**：定期检查仓库连接状态
- **备份备份**：重要数据多地备份

**⚡ 性能优化建议**
- **合理设置传输速度限制**：避免影响正常业务
- **选择合适的压缩方式**：平衡存储空间和CPU消耗
- **分时段备份**：在业务低峰期进行备份操作

**核心记忆**：
- 快照仓库是备份的基础设施，必须先有仓库才能创建快照
- 创建后立即验证，确保配置正确可用
- 删除仓库只是移除配置，不会删除实际备份文件
- 路径权限配置是成功的关键前提