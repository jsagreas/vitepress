---
title: 7、文档增删改查基础
---
## 📚 目录

1. [什么是Elasticsearch文档](#1-什么是Elasticsearch文档)
2. [创建文档的两种方式](#2-创建文档的两种方式)
3. [获取和查看文档](#3-获取和查看文档)
4. [更新文档操作](#4-更新文档操作)
5. [删除文档操作](#5-删除文档操作)
6. [文档存在性检查](#6-文档存在性检查)
7. [实际应用场景](#7-实际应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📄 什么是Elasticsearch文档


### 1.1 文档的本质理解


**🔸 简单理解**
```
想象一下：
- MySQL中的一行记录 = ES中的一个文档
- Word文档中的一篇文章 = ES中的一个文档
- 电商网站中的一个商品信息 = ES中的一个文档
```

**💡 文档就是一条完整的数据记录**

举个例子，一个用户的信息可以是这样一个文档：
```json
{
  "name": "张三",
  "age": 25,
  "city": "北京",
  "hobby": ["读书", "游泳"]
}
```

### 1.2 文档在ES中的位置


```
ES数据组织结构：
┌─────────────────┐
│   索引(Index)    │ ← 相当于数据库中的表
│  ┌─────────────┐ │
│  │ 文档(Doc)   │ │ ← 相当于表中的一行记录
│  │ 文档(Doc)   │ │
│  │ 文档(Doc)   │ │
│  └─────────────┘ │
└─────────────────┘
```

**🎯 核心概念**
- **索引(Index)**：存放同类文档的容器，像数据库中的表
- **文档(Document)**：一条具体的数据记录，像表中的一行
- **字段(Field)**：文档中的属性，像表中的列

---

## 2. ✏️ 创建文档的两种方式


### 2.1 自动生成ID方式（POST方法）


**🔸 基本语法**
```bash
curl -X POST "localhost:9200/索引名/_doc" \
  -H "Content-Type: application/json" \
  -d '{"字段名":"字段值"}'
```

**💼 实际示例**
```bash
# 创建一个用户文档，让ES自动生成ID
curl -X POST "localhost:9200/users/_doc" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三",
    "age": 25,
    "city": "北京"
  }'
```

**📋 返回结果解读**
```json
{
  "_index": "users",           # 文档存储在哪个索引
  "_type": "_doc",            # 文档类型（ES7+统一为_doc）
  "_id": "abc123xyz",         # ES自动生成的唯一ID
  "_version": 1,              # 文档版本号（每次更新+1）
  "result": "created",        # 操作结果：created表示新建成功
  "_shards": {                # 分片信息
    "total": 2,
    "successful": 1,
    "failed": 0
  }
}
```

> 💡 **提示**：用POST方法时，ES会自动生成一个像`abc123xyz`这样的随机ID，你不需要提前想好ID是什么

### 2.2 指定ID方式（PUT方法）


**🔸 基本语法**
```bash
curl -X PUT "localhost:9200/索引名/_doc/指定的ID" \
  -H "Content-Type: application/json" \
  -d '{"字段名":"字段值"}'
```

**💼 实际示例**
```bash
# 创建一个用户文档，指定ID为1
curl -X PUT "localhost:9200/users/_doc/1" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "李四",
    "age": 30,
    "city": "上海"
  }'
```

**🤔 什么时候用哪种方式？**

| 使用场景 | **推荐方式** | **原因** |
|---------|-------------|---------|
| 🆕 **新用户注册** | `POST自动生成ID` | `不知道用什么ID好，让ES决定` |
| 📋 **导入已有数据** | `PUT指定ID` | `原系统有ID，保持一致` |
| 🔄 **同步数据库** | `PUT指定ID` | `使用数据库主键作为ES的ID` |

---

## 3. 👀 获取和查看文档


### 3.1 获取单个文档


**🔸 基本语法**
```bash
curl -X GET "localhost:9200/索引名/_doc/文档ID"
```

**💼 实际示例**
```bash
# 获取ID为1的用户文档
curl -X GET "localhost:9200/users/_doc/1"
```

**📋 返回结果详解**
```json
{
  "_index": "users",
  "_type": "_doc", 
  "_id": "1",
  "_version": 1,
  "found": true,              # 是否找到文档
  "_source": {                # 原始文档内容
    "name": "李四",
    "age": 30,
    "city": "上海"
  }
}
```

> 📝 **重点理解**：`_source`里面就是你当初存进去的原始数据

### 3.2 只获取文档内容


**🔸 获取纯数据（不要元数据）**
```bash
curl -X GET "localhost:9200/users/_doc/1/_source"
```

**返回结果**（更简洁）：
```json
{
  "name": "李四",
  "age": 30,
  "city": "上海"
}
```

### 3.3 文档不存在的情况


```bash
# 查询一个不存在的文档
curl -X GET "localhost:9200/users/_doc/999"
```

**返回结果**：
```json
{
  "_index": "users",
  "_type": "_doc",
  "_id": "999",
  "found": false              # 明确告诉你没找到
}
```

> ⚠️ **注意**：ES不会报错，而是返回`found: false`，这是正常的返回

---

## 4. 🔄 更新文档操作


### 4.1 完整替换更新（PUT方法）


**🔸 工作原理**
```
PUT更新 = 删除旧文档 + 创建新文档
相当于：先把整个文档删掉，再放一个新的进去
```

**💼 实际示例**
```bash
# 完整替换ID为1的用户文档
curl -X PUT "localhost:9200/users/_doc/1" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "李四",
    "age": 31,
    "city": "深圳",
    "phone": "13800138000"
  }'
```

**⚠️ 重要提醒**：如果原文档有其他字段，PUT会把它们全部删除，只保留你现在提供的字段

### 4.2 部分字段更新（POST _update）


**🔸 工作原理**
```
POST _update = 只改你指定的字段，其他字段保持不变
相当于：只修改某几个属性，其他属性原封不动
```

**💼 实际示例**
```bash
# 只更新年龄，其他字段不变
curl -X POST "localhost:9200/users/_update/1" \
  -H "Content-Type: application/json" \
  -d '{
    "doc": {
      "age": 32
    }
  }'
```

**📊 两种更新方式对比**

| 更新方式 | **使用场景** | **特点** | **风险** |
|---------|-------------|---------|---------|
| 🔄 **PUT完整替换** | `重写整个文档` | `简单直接` | `容易丢失其他字段` |
| 🎯 **POST部分更新** | `只改几个字段` | `安全，不会丢数据` | `语法稍复杂` |

### 4.3 更新不存在的文档


**使用upsert（更新或插入）**
```bash
curl -X POST "localhost:9200/users/_update/999" \
  -H "Content-Type: application/json" \
  -d '{
    "doc": {
      "name": "王五",
      "age": 28
    },
    "upsert": {
      "name": "王五", 
      "age": 28,
      "city": "广州"
    }
  }'
```

> 💡 **解释**：如果ID为999的文档存在就更新，不存在就创建一个新的

---

## 5. 🗑️ 删除文档操作


### 5.1 删除单个文档


**🔸 基本语法**
```bash
curl -X DELETE "localhost:9200/索引名/_doc/文档ID"
```

**💼 实际示例**
```bash
# 删除ID为1的用户文档
curl -X DELETE "localhost:9200/users/_doc/1"
```

**📋 删除成功的返回**
```json
{
  "_index": "users",
  "_type": "_doc",
  "_id": "1",
  "_version": 2,              # 版本号会增加
  "result": "deleted",        # 删除成功
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  }
}
```

### 5.2 删除不存在的文档


```bash
# 删除一个不存在的文档
curl -X DELETE "localhost:9200/users/_doc/999"
```

**返回结果**：
```json
{
  "_index": "users",
  "_type": "_doc", 
  "_id": "999",
  "_version": 1,
  "result": "not_found"       # 没找到，但不报错
}
```

> 📝 **说明**：删除不存在的文档不会报错，ES会告诉你`not_found`

### 5.3 删除操作的注意事项


**🚨 重要提醒**
- 删除是**永久性**的，无法恢复
- 删除只是标记删除，真正清理需要等ES的段合并
- 频繁删除会影响性能

**最佳实践**
```bash
# 删除前先检查文档是否存在
curl -X HEAD "localhost:9200/users/_doc/1"
# 如果返回200表示存在，404表示不存在

# 然后再决定是否删除
curl -X DELETE "localhost:9200/users/_doc/1"
```

---

## 6. 🔍 文档存在性检查


### 6.1 使用HEAD方法检查


**🔸 基本语法**
```bash
curl -X HEAD "localhost:9200/索引名/_doc/文档ID"
```

**💼 实际示例**
```bash
# 检查ID为1的文档是否存在
curl -X HEAD "localhost:9200/users/_doc/1"
```

**📋 返回状态码含义**
- `200 OK`：文档存在
- `404 Not Found`：文档不存在

### 6.2 为什么要检查文档存在性？


**🎯 实际应用场景**

```bash
# 场景1：更新前检查
curl -X HEAD "localhost:9200/users/_doc/1"
if [ $? -eq 0 ]; then
  echo "文档存在，可以更新"
  # 执行更新操作
else
  echo "文档不存在，需要先创建"
  # 执行创建操作
fi
```

**📊 HEAD vs GET 的区别**

| 方法 | **返回内容** | **网络流量** | **使用场景** |
|-----|-------------|-------------|-------------|
| 🔍 **HEAD** | `只有状态码` | `很小` | `只想知道存在不存在` |
| 👀 **GET** | `完整文档内容` | `较大` | `需要查看文档内容` |

---

## 7. 🏢 实际应用场景


### 7.1 电商系统商品管理


**🛍️ 商品信息文档结构**
```json
{
  "product_id": "P001",
  "name": "iPhone 15",
  "price": 5999,
  "category": "手机",
  "stock": 100,
  "status": "在售"
}
```

**常用操作流程**
```bash
# 1. 新商品上架
curl -X PUT "localhost:9200/products/_doc/P001" \
  -H "Content-Type: application/json" \
  -d '{
    "product_id": "P001",
    "name": "iPhone 15",
    "price": 5999,
    "category": "手机",
    "stock": 100,
    "status": "在售"
  }'

# 2. 更新库存（只改库存，其他不变）
curl -X POST "localhost:9200/products/_update/P001" \
  -H "Content-Type: application/json" \
  -d '{
    "doc": {
      "stock": 95
    }
  }'

# 3. 商品下架
curl -X POST "localhost:9200/products/_update/P001" \
  -H "Content-Type: application/json" \
  -d '{
    "doc": {
      "status": "下架"
    }
  }'

# 4. 彻底删除商品
curl -X DELETE "localhost:9200/products/_doc/P001"
```

### 7.2 用户行为日志记录


**📊 日志文档结构**
```json
{
  "user_id": "U123",
  "action": "购买",
  "product_id": "P001", 
  "timestamp": "2024-01-01T10:30:00",
  "ip": "192.168.1.100"
}
```

**日志记录操作**
```bash
# 记录用户行为（自动生成ID，因为每条日志都是唯一的）
curl -X POST "localhost:9200/user_logs/_doc" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "U123",
    "action": "购买",
    "product_id": "P001",
    "timestamp": "2024-01-01T10:30:00",
    "ip": "192.168.1.100"
  }'
```

### 7.3 配置管理系统


**⚙️ 系统配置文档**
```json
{
  "config_key": "max_upload_size",
  "config_value": "10MB",
  "description": "最大上传文件大小",
  "last_updated": "2024-01-01"
}
```

**配置管理操作**
```bash
# 1. 检查配置是否存在
curl -X HEAD "localhost:9200/configs/_doc/max_upload_size"

# 2. 更新配置（如果存在就更新，不存在就创建）
curl -X PUT "localhost:9200/configs/_doc/max_upload_size" \
  -H "Content-Type: application/json" \
  -d '{
    "config_key": "max_upload_size",
    "config_value": "20MB",
    "description": "最大上传文件大小",
    "last_updated": "2024-01-02"
  }'
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的操作命令


**📝 创建文档**
```bash
# 自动ID
curl -X POST "localhost:9200/index/_doc" -d '{"field":"value"}'

# 指定ID  
curl -X PUT "localhost:9200/index/_doc/1" -d '{"field":"value"}'
```

**👀 查看文档**
```bash
# 获取完整文档
curl -X GET "localhost:9200/index/_doc/1"

# 只获取文档内容
curl -X GET "localhost:9200/index/_doc/1/_source"
```

**🔄 更新文档**
```bash
# 完整替换
curl -X PUT "localhost:9200/index/_doc/1" -d '{"field":"new_value"}'

# 部分更新
curl -X POST "localhost:9200/index/_update/1" -d '{"doc":{"field":"value"}}'
```

**🗑️ 删除文档**
```bash
curl -X DELETE "localhost:9200/index/_doc/1"
```

**🔍 检查存在**
```bash
curl -X HEAD "localhost:9200/index/_doc/1"
```

### 8.2 关键理解要点


**🔹 文档就是一条数据记录**
- 类似数据库中的一行数据
- 用JSON格式存储
- 每个文档都有唯一的ID

**🔹 两种创建方式的选择**
- `POST`：让ES自动生成ID，适合新数据
- `PUT`：自己指定ID，适合已有ID的数据

**🔹 两种更新方式的区别**
- `PUT`：完整替换，会覆盖整个文档
- `POST _update`：部分更新，只改指定字段

**🔹 操作的幂等性**
- `PUT`操作是幂等的（重复执行结果相同）
- `POST`操作不是幂等的（每次都创建新文档）

### 8.3 实际应用建议


**✅ 最佳实践**
- 重要操作前先用HEAD检查文档是否存在
- 优先使用部分更新而不是完整替换
- 为文档设计合理的ID规则
- 删除操作要谨慎，考虑是否真的需要物理删除

**⚠️ 常见错误**
- 忘记加`Content-Type: application/json`头
- PUT更新时丢失其他字段
- 删除重要数据没有备份
- 频繁的删除操作影响性能

**🎯 选择建议**
- **数据导入**：使用PUT指定ID
- **用户操作**：使用POST自动生成ID  
- **配置管理**：使用PUT便于管理
- **日志记录**：使用POST记录每次操作

**核心记忆**：
- 文档是ES中的基本数据单位，相当于数据库的一行记录
- POST自动ID，PUT指定ID；PUT完整替换，POST部分更新
- HEAD检查存在，GET获取内容，DELETE永久删除
- 选择合适的操作方式，关注数据安全和性能影响