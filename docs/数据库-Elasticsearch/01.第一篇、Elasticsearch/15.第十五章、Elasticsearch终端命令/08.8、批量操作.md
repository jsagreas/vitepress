---
title: 8、批量操作
---
## 📚 目录

1. [批量操作基础概念](#1-批量操作基础概念)
2. [批量API核心语法](#2-批量API核心语法)
3. [四种批量操作详解](#3-四种批量操作详解)
4. [批量获取操作](#4-批量获取操作)
5. [批量操作最佳实践](#5-批量操作最佳实践)
6. [性能优化与注意事项](#6-性能优化与注意事项)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🚀 批量操作基础概念


### 1.1 什么是批量操作


**🔸 简单理解**
批量操作就像是"打包处理"，一次性完成多个文档的增删改查，而不是一个一个地处理。

```
传统方式（逐个处理）：
添加文档1 → 等待响应 → 添加文档2 → 等待响应 → 添加文档3...

批量方式（打包处理）：
一次性发送：添加文档1 + 添加文档2 + 添加文档3 → 一次性获得响应
```

**💡 为什么需要批量操作**
- **提升性能**：减少网络往返次数，大大提高处理速度
- **减少开销**：降低HTTP请求的开销和服务器资源消耗
- **提高效率**：处理大量数据时，批量操作是必备技能

### 1.2 批量操作的应用场景


**🎯 典型使用场景**
```
数据导入：
- 从数据库导入大量历史数据
- 日志文件批量导入到ES
- CSV文件数据批量处理

数据同步：
- 定时同步其他系统的数据
- 数据库变更批量同步到ES
- 缓存数据批量更新

数据维护：
- 批量删除过期数据
- 批量更新文档字段
- 数据清理和整理
```

---

## 2. 📋 批量API核心语法


### 2.1 批量操作的基本命令


**🔸 全局批量操作**
```bash
curl -X POST "localhost:9200/_bulk"
```
> 💡 **含义解释**：`_bulk`是ES的批量操作端点，可以处理任何索引的文档

**🔸 指定索引的批量操作**
```bash
curl -X POST "localhost:9200/my_index/_bulk"
```
> 💡 **含义解释**：在`my_index`索引下进行批量操作，所有操作都默认在这个索引中执行

### 2.2 批量操作的数据格式


**📝 NDJSON格式说明**
批量操作使用特殊的**NDJSON**（换行分隔的JSON）格式：

```
操作指令行
数据内容行
操作指令行  
数据内容行
...
```

**🔹 格式要求**
- 每行必须是完整的JSON对象
- 每行以换行符结尾
- 操作指令和数据内容要配对出现
- 文件最后必须以换行符结尾

---

## 3. 🔧 四种批量操作详解


### 3.1 批量索引操作（index）


**🔸 操作含义**
`index`操作用于**添加或覆盖**文档，如果文档不存在就创建，存在就替换。

**📝 基本格式**
```json
{"index":{"_id":"1"}}
{"name":"张三","age":25,"city":"北京"}
{"index":{"_id":"2"}}
{"name":"李四","age":30,"city":"上海"}
```

**🛠️ 完整示例**
```bash
curl -X POST "localhost:9200/users/_bulk" \
-H "Content-Type: application/json" \
-d '
{"index":{"_id":"1"}}
{"name":"张三","age":25,"city":"北京","job":"工程师"}
{"index":{"_id":"2"}}
{"name":"李四","age":30,"city":"上海","job":"设计师"}
{"index":{"_id":"3"}}
{"name":"王五","age":28,"city":"广州","job":"产品经理"}
'
```

**🔹 字段说明**
- `{"index":{"_id":"1"}}`：操作指令，指定要索引的文档ID
- `{"name":"张三",...}`：实际的文档内容

### 3.2 批量更新操作（update）


**🔸 操作含义**
`update`操作用于**部分更新**已存在的文档，只修改指定字段，不影响其他字段。

**📝 基本格式**
```json
{"update":{"_id":"1"}}
{"doc":{"age":26}}
{"update":{"_id":"2"}}
{"doc":{"city":"深圳","job":"高级设计师"}}
```

**🛠️ 完整示例**
```bash
curl -X POST "localhost:9200/users/_bulk" \
-H "Content-Type: application/json" \
-d '
{"update":{"_id":"1"}}
{"doc":{"age":26,"department":"技术部"}}
{"update":{"_id":"2"}}
{"doc":{"salary":15000}}
'
```

**🔹 更新选项**
```json
{"update":{"_id":"1"}}
{"doc":{"age":27},"upsert":{"name":"新用户","age":27}}
```
> 💡 **upsert说明**：如果文档不存在，则使用upsert中的数据创建新文档

### 3.3 批量删除操作（delete）


**🔸 操作含义**
`delete`操作用于**删除**指定的文档。

**📝 基本格式**
```json
{"delete":{"_id":"1"}}
{"delete":{"_id":"2"}}
```

**🛠️ 完整示例**
```bash
curl -X POST "localhost:9200/users/_bulk" \
-H "Content-Type: application/json" \
-d '
{"delete":{"_id":"3"}}
{"delete":{"_id":"4"}}
'
```

> ⚠️ **注意**：删除操作只需要操作指令行，不需要数据内容行

### 3.4 混合批量操作


**🔸 操作含义**
可以在一次批量请求中混合使用多种操作类型。

**🛠️ 混合操作示例**
```bash
curl -X POST "localhost:9200/users/_bulk" \
-H "Content-Type: application/json" \
-d '
{"index":{"_id":"5"}}
{"name":"赵六","age":32,"city":"杭州"}
{"update":{"_id":"1"}}
{"doc":{"last_login":"2025-01-21"}}
{"delete":{"_id":"2"}}
{"index":{"_id":"6"}}
{"name":"钱七","age":29,"city":"成都"}
'
```

**📊 操作对比表**

| 操作类型 | **用途** | **需要数据行** | **文档不存在时** | **文档存在时** |
|---------|---------|---------------|-----------------|---------------|
| `index` | 添加/覆盖文档 | ✅ 需要 | 创建新文档 | 完全替换 |
| `update` | 部分更新文档 | ✅ 需要 | 报错(除非有upsert) | 部分更新 |
| `delete` | 删除文档 | ❌ 不需要 | 忽略操作 | 删除文档 |

---

## 4. 📥 批量获取操作


### 4.1 批量获取基础


**🔸 操作含义**
批量获取（`_mget`）用于一次性获取多个文档，比逐个获取效率更高。

**📝 全局批量获取**
```bash
curl -X GET "localhost:9200/_mget" \
-H "Content-Type: application/json" \
-d '
{
  "docs": [
    {"_index": "users", "_id": "1"},
    {"_index": "users", "_id": "2"},
    {"_index": "products", "_id": "100"}
  ]
}
'
```

### 4.2 指定索引的批量获取


**🔸 简化方式**
当所有文档都在同一个索引中时，可以使用简化语法：

```bash
curl -X POST "localhost:9200/users/_mget" \
-H "Content-Type: application/json" \
-d '
{
  "ids": ["1", "2", "3"]
}
'
```

**🔸 指定字段获取**
```bash
curl -X POST "localhost:9200/users/_mget" \
-H "Content-Type: application/json" \
-d '
{
  "docs": [
    {"_id": "1", "_source": ["name", "age"]},
    {"_id": "2", "_source": false},
    {"_id": "3"}
  ]
}
'
```

**🔹 参数说明**
- `"_source": ["name", "age"]`：只获取指定字段
- `"_source": false`：不获取文档内容，只获取元数据
- 不指定`_source`：获取完整文档

### 4.3 批量获取响应格式


**📄 响应示例**
```json
{
  "docs": [
    {
      "_index": "users",
      "_id": "1",
      "_version": 1,
      "_seq_no": 0,
      "_primary_term": 1,
      "found": true,
      "_source": {
        "name": "张三",
        "age": 25,
        "city": "北京"
      }
    },
    {
      "_index": "users",
      "_id": "999",
      "found": false
    }
  ]
}
```

**🔍 响应字段解释**
- `found: true`：文档存在
- `found: false`：文档不存在
- `_source`：文档的实际内容

---

## 5. 🎯 批量操作最佳实践


### 5.1 文件方式批量操作


**🔸 创建批量操作文件**
```bash
# 创建批量操作文件
cat > bulk_data.json << 'EOF'
{"index":{"_id":"1"}}
{"name":"张三","age":25,"department":"技术部"}
{"index":{"_id":"2"}}
{"name":"李四","age":30,"department":"市场部"}
{"update":{"_id":"1"}}
{"doc":{"salary":8000}}
{"delete":{"_id":"3"}}
EOF

# 执行批量操作
curl -X POST "localhost:9200/employees/_bulk" \
-H "Content-Type: application/json" \
--data-binary @bulk_data.json
```

> 💡 **使用`--data-binary`**：确保文件内容按原样发送，保持换行符

### 5.2 错误处理


**📊 响应中的错误信息**
```json
{
  "took": 5,
  "errors": true,
  "items": [
    {
      "index": {
        "_index": "users",
        "_id": "1",
        "_version": 1,
        "result": "created",
        "status": 201
      }
    },
    {
      "update": {
        "_index": "users",
        "_id": "999",
        "status": 404,
        "error": {
          "type": "document_missing_exception",
          "reason": "[999]: document missing"
        }
      }
    }
  ]
}
```

**🔍 错误处理策略**
- `errors: true`：表示有操作失败
- 检查`items`数组中每个操作的`status`
- 状态码`2xx`表示成功，`4xx/5xx`表示失败

### 5.3 批量大小建议


**📏 合理的批量大小**
```
文档数量：1000-5000个文档/批次
数据大小：5-15MB/批次
```

**⚡ 性能调优建议**
- **太小**：网络开销大，性能提升有限
- **太大**：可能导致内存不足或超时
- **测试优化**：根据实际环境测试最佳批量大小

---

## 6. ⚙️ 性能优化与注意事项


### 6.1 性能优化技巧


**🚀 提升性能的方法**

```bash
# 1. 调整刷新间隔
curl -X PUT "localhost:9200/users/_settings" \
-H "Content-Type: application/json" \
-d '{"refresh_interval": "30s"}'

# 2. 批量操作完成后手动刷新
curl -X POST "localhost:9200/users/_refresh"
```

**📊 性能对比**
```
单个操作：1000个文档 ≈ 60秒
批量操作：1000个文档 ≈ 3秒
性能提升：20倍+
```

### 6.2 常见问题与解决


**❌ 常见错误**

```bash
# 错误1：格式不正确（缺少换行符）
curl -X POST "localhost:9200/_bulk" -d '{"index":{"_id":"1"}}{"name":"test"}'

# 正确格式
curl -X POST "localhost:9200/_bulk" -d '
{"index":{"_id":"1"}}
{"name":"test"}
'
```

**⚠️ 注意事项**
- 每行必须以换行符结尾
- 不能有多余的空行
- JSON格式必须正确
- 使用正确的Content-Type头

### 6.3 监控与调试


**🔍 查看批量操作状态**
```bash
# 查看集群状态
curl -X GET "localhost:9200/_cluster/health"

# 查看节点统计
curl -X GET "localhost:9200/_nodes/stats/indices/indexing"
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基础概念


```
🔸 批量操作：一次性处理多个文档，大幅提升性能
🔸 NDJSON格式：操作指令行+数据行的配对格式
🔸 四种操作：index(添加/覆盖)、update(部分更新)、delete(删除)
🔸 批量获取：_mget实现多文档一次性获取
🔸 性能优化：合理的批量大小和错误处理
```

### 7.2 关键命令速查


**🔹 核心命令对照表**

| 操作类型 | **命令格式** | **主要用途** |
|---------|-------------|-------------|
| `全局批量` | `curl -X POST "localhost:9200/_bulk"` | 跨索引批量操作 |
| `索引批量` | `curl -X POST "localhost:9200/index/_bulk"` | 指定索引批量操作 |
| `批量获取` | `curl -X GET "localhost:9200/_mget"` | 批量查询文档 |
| `索引批量获取` | `curl -X POST "localhost:9200/index/_mget"` | 指定索引批量查询 |

### 7.3 实际应用建议


**🎯 使用场景选择**
- **数据导入**：使用`index`操作批量添加文档
- **数据同步**：使用`update`操作批量更新字段
- **数据清理**：使用`delete`操作批量删除
- **数据查询**：使用`_mget`批量获取多个文档

**💡 最佳实践记忆**
- 批量大小：1000-5000个文档
- 文件操作：使用`--data-binary`
- 错误检查：关注响应中的`errors`字段
- 性能优化：调整刷新间隔，批量完成后手动刷新

**核心记忆口诀**：
```
批量操作提效率，四种操作要分清
index覆盖update改，delete删除_mget查
NDJSON格式要规范，操作数据配对行
错误处理别忽视，性能优化是关键
```