---
title: 6、cluster集群配置
---
## 📚 目录导航

1. [什么是Elasticsearch集群](#1-什么是elasticsearch集群)
2. [集群基础配置详解](#2-集群基础配置详解)
3. [分片分配策略配置](#3-分片分配策略配置)
4. [磁盘空间管理配置](#4-磁盘空间管理配置)
5. [性能优化配置](#5-性能优化配置)
6. [实际配置示例](#6-实际配置示例)
7. [常见问题与解决方案](#7-常见问题与解决方案)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 什么是Elasticsearch集群


### 1.1 集群概念通俗理解


🌰 **生活类比**: Elasticsearch集群就像一个图书馆系统
- **单个节点** = 一个分馆
- **整个集群** = 所有分馆组成的图书馆系统
- **数据分片** = 把书籍分散存放在不同分馆
- **副本** = 热门书籍在多个分馆都有备份

### 1.2 为什么需要集群


**🔸 解决单机限制问题**
```
单机Elasticsearch的问题：
❌ 数据量大时性能下降
❌ 硬件故障导致数据丢失
❌ 查询压力大时响应慢
❌ 存储空间有限

集群解决方案：
✅ 多台机器分担数据存储
✅ 数据有备份，故障不丢失
✅ 多节点并行处理查询
✅ 可以随时添加新机器扩容
```

### 1.3 集群的基本组成


```
Elasticsearch集群架构：
         集群(Cluster)
              |
    ┌─────────┼─────────┐
    │         │         │
  节点1     节点2     节点3
(Node1)   (Node2)   (Node3)
    │         │         │
   索引A     索引A     索引B
  分片1     分片2     分片1
  分片1     分片2     分片2
  (副本)    (副本)    (主分片)
```

**🔹 核心概念解释**
- **集群(Cluster)**: 多台服务器组成的整体系统
- **节点(Node)**: 集群中的每台服务器
- **分片(Shard)**: 数据的一个片段，分布在不同节点
- **副本(Replica)**: 分片的备份，用于容错和提高查询性能

---

## 2. ⚙️ 集群基础配置详解


### 2.1 cluster.name - 集群唯一标识


**🎯 作用**: 给你的集群起个名字，相同名字的节点才能组成一个集群

```yaml
# 配置示例

cluster.name: my-elasticsearch-cluster
```

**🧠 通俗理解**: 
- 就像公司名称，只有同一个公司的员工才能在一起工作
- 不同集群名的节点不会互相干扰
- 建议使用有意义的名称，比如 `production-log-cluster`、`test-search-cluster`

**⚠️ 重要提醒**:
- 集群名一旦确定，不要随意修改
- 生产环境和测试环境要用不同的集群名
- 避免使用默认名称 `elasticsearch`

### 2.2 cluster.info.update.interval - 集群信息更新间隔


**🎯 作用**: 控制集群状态信息多久更新一次

```yaml
# 配置示例

cluster.info.update.interval: 30s
```

**🔹 参数说明**
- **默认值**: `30s` (30秒)
- **推荐设置**: 保持默认即可
- **调整场景**: 大集群可以适当调大，减少网络开销

**💡 新手建议**: 这个配置一般不需要修改，保持默认值就好

---

## 3. 🎯 分片分配策略配置


### 3.1 什么是分片分配


**🌰 生活类比**: 分片分配就像工厂分配生产任务
- **原材料** = 你的数据
- **生产线** = 不同的服务器节点
- **分配策略** = 决定哪个生产线处理哪些原材料

### 3.2 cluster.routing.allocation.enable - 分片分配控制


**🎯 作用**: 控制是否允许分片在节点间移动

```yaml
# 配置选项

cluster.routing.allocation.enable: all        # 默认值，允许所有分片分配
# cluster.routing.allocation.enable: primaries # 只允许主分片分配

# cluster.routing.allocation.enable: new_primaries # 只允许新索引的主分片分配

# cluster.routing.allocation.enable: none      # 禁止所有分片分配

```

**🔹 各选项详解**

| 配置值 | **含义** | **使用场景** | **新手建议** |
|--------|---------|-------------|-------------|
| `all` | `允许所有分片自由移动` | `正常运行状态` | `🟢 推荐使用` |
| `primaries` | `只允许主分片移动` | `维护期间减少网络负载` | `🟡 谨慎使用` |
| `new_primaries` | `只允许新索引主分片` | `集群恢复期间` | `🟡 谨慎使用` |
| `none` | `禁止分片移动` | `紧急维护` | `🔴 临时使用` |

### 3.3 cluster.routing.rebalance.enable - 再平衡控制


**🎯 作用**: 控制集群是否自动平衡各节点的分片数量

```yaml
# 配置选项

cluster.routing.rebalance.enable: all         # 默认值，允许所有再平衡
# cluster.routing.rebalance.enable: primaries # 只平衡主分片

# cluster.routing.rebalance.enable: replicas  # 只平衡副本分片

# cluster.routing.rebalance.enable: none      # 禁止再平衡

```

**🧠 通俗理解**: 
就像公司重新分配工作量，确保每个部门的工作量相对均衡

**💡 实际应用场景**
```
场景1: 新增节点
原来: 节点A(10个分片) 节点B(10个分片)
新增: 节点C(0个分片)
平衡后: 节点A(7个) 节点B(7个) 节点C(6个)

场景2: 节点下线
原来: 节点A(10个) 节点B(10个) 节点C(10个)
下线C后: 节点A(15个) 节点B(15个)
```

### 3.4 cluster.max_shards_per_node - 每节点最大分片数


**🎯 作用**: 限制单个节点最多能存储多少个分片

```yaml
# 配置示例

cluster.max_shards_per_node: 1000
```

**🔹 配置建议**

| 节点配置 | **推荐分片数** | **说明** |
|---------|---------------|---------|
| 🔰 **小型集群** | `500-1000` | `2-4核CPU，8-16GB内存` |
| 🔸 **中型集群** | `1000-2000` | `8-16核CPU，32-64GB内存` |
| ⭐ **大型集群** | `2000+` | `16+核CPU，64GB+内存` |

**⚠️ 注意事项**:
- 分片过多会消耗更多内存和CPU
- 分片过少可能导致数据分布不均
- 根据硬件配置合理设置

---

## 4. 💾 磁盘空间管理配置


### 4.1 磁盘水位线概念


**🌰 生活类比**: 磁盘水位线就像水库的警戒线
- **绿色区域** = 正常使用，放心存储数据
- **黄色区域** = 接近警戒线，开始转移数据
- **红色区域** = 超过警戒线，停止写入数据

```
磁盘使用情况示意图：
┌─────────────────────────────────────┐ 100%
│           红色危险区                 │
├─────────────────────────────────────┤ 95% ← 洪水阶段
│                                     │
│           黄色警告区                 │
│                                     │
├─────────────────────────────────────┤ 85% ← 高水位线
│                                     │
│                                     │
│           绿色安全区                 │
│                                     │
│                                     │
├─────────────────────────────────────┤ 80% ← 低水位线
│            正常使用区               │
└─────────────────────────────────────┘ 0%
```

### 4.2 cluster.routing.allocation.disk.threshold_enabled


**🎯 作用**: 开启或关闭磁盘空间阈值检查

```yaml
# 配置示例

cluster.routing.allocation.disk.threshold_enabled: true  # 默认值，建议保持
```

**💡 为什么要开启**: 
防止磁盘写满导致系统崩溃，就像汽车的油量报警器

### 4.3 cluster.routing.allocation.disk.watermark.low - 低水位线


**🎯 作用**: 设置磁盘使用率的第一个警戒线

```yaml
# 配置示例

cluster.routing.allocation.disk.watermark.low: 85%
# 或者使用绝对值

# cluster.routing.allocation.disk.watermark.low: 10gb

```

**🔹 触发行为**: 
当磁盘使用超过85%时，不再向该节点分配新的分片

**🧠 通俗理解**: 
就像停车场快满了，不再让新车进入，但已经停的车可以继续使用

### 4.4 cluster.routing.allocation.disk.watermark.high - 高水位线


**🎯 作用**: 设置磁盘使用率的第二个警戒线

```yaml
# 配置示例

cluster.routing.allocation.disk.watermark.high: 90%
```

**🔹 触发行为**: 
当磁盘使用超过90%时，开始将分片迁移到其他节点

**💡 实际效果**:
```
节点A磁盘使用率: 92% (超过高水位线)
系统行为: 
1. 停止向节点A分配新分片
2. 将节点A的部分分片迁移到其他节点
3. 降低节点A的磁盘使用率
```

### 4.5 cluster.routing.allocation.disk.watermark.flood_stage - 洪水阶段


**🎯 作用**: 设置磁盘使用率的最高警戒线

```yaml
# 配置示例

cluster.routing.allocation.disk.watermark.flood_stage: 95%
```

**🔹 触发行为**: 
当磁盘使用超过95%时，将该节点上的所有索引设置为只读

**🚨 严重后果**: 
- 无法写入新数据
- 只能查询现有数据
- 需要紧急清理磁盘空间

**⚠️ 紧急处理步骤**:
1. 删除不需要的索引或数据
2. 添加新的存储空间
3. 手动解除只读限制

---

## 5. ⚡ 性能优化配置


### 5.1 磁盘水位线配置建议


**🔸 生产环境推荐配置**
```yaml
# 保守配置 - 适合重要生产环境

cluster.routing.allocation.disk.watermark.low: 80%
cluster.routing.allocation.disk.watermark.high: 85%
cluster.routing.allocation.disk.watermark.flood_stage: 90%

# 平衡配置 - 适合一般生产环境

cluster.routing.allocation.disk.watermark.low: 85%
cluster.routing.allocation.disk.watermark.high: 90%
cluster.routing.allocation.disk.watermark.flood_stage: 95%
```

### 5.2 分片数量规划


**🎯 分片大小建议**
- **理想分片大小**: 10GB - 50GB
- **最大分片大小**: 不超过100GB
- **最小分片大小**: 不小于1GB

**📊 分片数量计算公式**
```
分片数量 = 总数据量 ÷ 目标分片大小

示例计算:
数据量: 500GB
目标分片大小: 25GB
建议分片数: 500 ÷ 25 = 20个分片
```

### 5.3 副本数量设置


**🔹 副本策略建议**

| 集群规模 | **节点数** | **推荐副本数** | **说明** |
|---------|-----------|--------------|---------|
| 🔰 **小型** | `1-2个` | `0-1个` | `测试环境可以不设副本` |
| 🔸 **中型** | `3-6个` | `1个` | `平衡性能和可靠性` |
| ⭐ **大型** | `7+个` | `1-2个` | `高可用要求可以设2个` |

---

## 6. 🛠️ 实际配置示例


### 6.1 小型集群配置 (3节点)


```yaml
# ===== 集群基础配置 =====

cluster.name: small-production-cluster
cluster.info.update.interval: 30s

# ===== 分片分配配置 =====

cluster.routing.allocation.enable: all
cluster.routing.rebalance.enable: all
cluster.max_shards_per_node: 800

# ===== 磁盘管理配置 =====

cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 80%
cluster.routing.allocation.disk.watermark.high: 85%
cluster.routing.allocation.disk.watermark.flood_stage: 90%
```

### 6.2 大型集群配置 (10+节点)


```yaml
# ===== 集群基础配置 =====

cluster.name: large-production-cluster
cluster.info.update.interval: 45s

# ===== 分片分配配置 =====

cluster.routing.allocation.enable: all
cluster.routing.rebalance.enable: all
cluster.max_shards_per_node: 1500

# ===== 磁盘管理配置 =====

cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 85%
cluster.routing.allocation.disk.watermark.high: 90%
cluster.routing.allocation.disk.watermark.flood_stage: 95%
```

### 6.3 开发测试环境配置


```yaml
# ===== 集群基础配置 =====

cluster.name: development-cluster
cluster.info.update.interval: 30s

# ===== 分片分配配置 =====

cluster.routing.allocation.enable: all
cluster.routing.rebalance.enable: all
cluster.max_shards_per_node: 500

# ===== 磁盘管理配置 =====

cluster.routing.allocation.disk.threshold_enabled: true
cluster.routing.allocation.disk.watermark.low: 90%
cluster.routing.allocation.disk.watermark.high: 95%
cluster.routing.allocation.disk.watermark.flood_stage: 98%
```

---

## 7. 🔧 常见问题与解决方案


### 7.1 分片分配失败问题


**🚨 问题现象**: 分片显示为未分配状态

**🔍 常见原因**:
- ✅ 检查 `cluster.routing.allocation.enable` 是否为 `all`
- ✅ 确认磁盘空间未超过水位线
- ✅ 验证节点数量足够分配副本

**💊 解决方案**:
```bash
# 1. 查看集群健康状态

GET _cluster/health

# 2. 查看未分配分片原因

GET _cluster/allocation/explain

# 3. 临时启用分片分配

PUT _cluster/settings
{
  "transient": {
    "cluster.routing.allocation.enable": "all"
  }
}
```

### 7.2 磁盘空间不足问题


**🚨 问题现象**: 索引变为只读状态

**🔍 排查步骤**:
1. 检查各节点磁盘使用率
2. 查看是否触发洪水阶段
3. 确认哪些索引受影响

**💊 解决方案**:
```bash
# 1. 查看磁盘使用情况

GET _cat/allocation?v

# 2. 删除旧数据或不需要的索引

DELETE old-index-name

# 3. 解除只读限制

PUT _all/_settings
{
  "index.blocks.read_only_allow_delete": null
}
```

### 7.3 集群重新平衡太慢


**🚨 问题现象**: 分片迁移进度缓慢

**💊 解决方案**:
```yaml
# 临时加快重新平衡速度

cluster.routing.allocation.cluster_concurrent_rebalance: 4
cluster.routing.allocation.node_concurrent_recoveries: 4
indices.recovery.max_bytes_per_sec: 100mb
```

**⚠️ 注意**: 加快速度会增加网络和磁盘负载，完成后要改回默认值

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的配置


**🔸 集群基本配置**
```
cluster.name - 集群唯一标识，同名才能组成集群
cluster.routing.allocation.enable - 控制分片是否可以移动
cluster.max_shards_per_node - 限制单节点分片数量
```

**🔸 磁盘管理配置**
```
低水位线(85%) - 停止分配新分片
高水位线(90%) - 开始迁移现有分片  
洪水阶段(95%) - 索引变为只读
```

### 8.2 生产环境最佳实践


**🎯 配置原则**
- ✅ 集群名称要有意义且唯一
- ✅ 磁盘水位线要保守设置
- ✅ 分片数量要合理规划
- ✅ 副本数量要根据集群规模设置

**🔧 监控要点**
- 📊 定期检查集群健康状态
- 📊 监控各节点磁盘使用率
- 📊 观察分片分布是否均衡
- 📊 关注查询和索引性能

### 8.3 新手学习路径


**🗺️ 学习建议**
```
第1步: 理解集群基本概念
第2步: 掌握核心配置含义
第3步: 实践小规模集群搭建
第4步: 学习问题排查方法
第5步: 优化性能配置
```

**💡 记忆口诀**
```
集群配置有门道，
分片分配要控好，
磁盘水位设三线，
故障排查有技巧。
低水位停新分配，
高水位忙迁移，
洪水阶段变只读，
紧急处理要及时。
```

**🔗 相关知识链接**
- 下一步学习: [节点配置详解](#节点配置)
- 深入了解: [索引模板配置](#索引模板)
- 性能优化: [查询优化策略](#查询优化)