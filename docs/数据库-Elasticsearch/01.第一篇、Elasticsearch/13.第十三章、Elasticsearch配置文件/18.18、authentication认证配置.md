---
title: 18ã€authenticationè®¤è¯é…ç½®
---
## ğŸ“š ç›®å½•

1. [è®¤è¯é…ç½®åŸºç¡€æ¦‚å¿µ](#1-è®¤è¯é…ç½®åŸºç¡€æ¦‚å¿µ)
2. [æœ¬åœ°è®¤è¯åŸŸé…ç½®](#2-æœ¬åœ°è®¤è¯åŸŸé…ç½®)
3. [LDAPè®¤è¯åŸŸé…ç½®](#3-LDAPè®¤è¯åŸŸé…ç½®)
4. [Active Directoryè®¤è¯é…ç½®](#4-Active-Directoryè®¤è¯é…ç½®)
5. [æ–‡ä»¶è®¤è¯åŸŸé…ç½®](#5-æ–‡ä»¶è®¤è¯åŸŸé…ç½®)
6. [SAMLè®¤è¯é…ç½®](#6-SAMLè®¤è¯é…ç½®)
7. [OpenID Connectè®¤è¯](#7-OpenID-Connectè®¤è¯)
8. [Kerberosè®¤è¯é…ç½®](#8-Kerberosè®¤è¯é…ç½®)
9. [PKIè®¤è¯é…ç½®](#9-PKIè®¤è¯é…ç½®)
10. [åŒ¿åè®¿é—®é…ç½®](#10-åŒ¿åè®¿é—®é…ç½®)
11. [è®¤è¯é…ç½®æœ€ä½³å®è·µ](#11-è®¤è¯é…ç½®æœ€ä½³å®è·µ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯é…ç½®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Elasticsearchè®¤è¯


**ğŸ”¸ è®¤è¯çš„æœ¬è´¨**
è®¤è¯å°±åƒæ˜¯è¿›å…¥å…¬å¸å¤§æ¥¼éœ€è¦åˆ·å·¥ç‰Œä¸€æ ·ï¼ŒElasticsearchéœ€è¦éªŒè¯"ä½ æ˜¯è°"æ‰èƒ½è®©ä½ è¿›å…¥ç³»ç»Ÿã€‚

```
ç°å®ä¸–ç•Œç±»æ¯”ï¼š
ğŸ¢ å…¬å¸å¤§æ¥¼ = Elasticsearché›†ç¾¤
ğŸ†” å·¥ç‰Œåˆ·å¡ = ç”¨æˆ·è®¤è¯
ğŸšª é—¨ç¦ç³»ç»Ÿ = è®¤è¯åŸŸï¼ˆRealmï¼‰
ğŸ‘® ä¿å®‰éªŒè¯ = è®¤è¯æœºåˆ¶
```

**ğŸ’¡ è®¤è¯åŸŸï¼ˆRealmï¼‰æ¦‚å¿µè§£é‡Š**
- **è®¤è¯åŸŸ**ï¼šå°±æ˜¯ä¸€å¥—å®Œæ•´çš„"èº«ä»½éªŒè¯è§„åˆ™"
- **å¤šåŸŸæ”¯æŒ**ï¼šä¸€ä¸ªESé›†ç¾¤å¯ä»¥åŒæ—¶æ”¯æŒå¤šç§éªŒè¯æ–¹å¼
- **ä¼˜å…ˆçº§é¡ºåº**ï¼šESä¼šæŒ‰ç…§é…ç½®çš„é¡ºåºä¾æ¬¡å°è¯•å„ç§è®¤è¯æ–¹å¼

### 1.2 X-Packå®‰å…¨æ¨¡å—ç»“æ„


```
Elasticsearchå®‰å…¨æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·è¯·æ±‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è®¤è¯å±‚ (Authentication)   â”‚ â† éªŒè¯èº«ä»½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æˆæƒå±‚ (Authorization)    â”‚ â† æ£€æŸ¥æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        å®¡è®¡å±‚ (Auditing)        â”‚ â† è®°å½•æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 è®¤è¯é…ç½®çš„åŸºæœ¬æ ¼å¼


**ğŸ“‹ é…ç½®æ–‡ä»¶ä½ç½®**
- **ä¸»é…ç½®**ï¼š`config/elasticsearch.yml`
- **ç”¨æˆ·æ•°æ®**ï¼š`config/users` å’Œ `config/users_roles`
- **è¯ä¹¦æ–‡ä»¶**ï¼š`config/certs/` ç›®å½•

**ğŸ”§ åŸºç¡€é…ç½®ç»“æ„**
```yaml
# å¯ç”¨å®‰å…¨åŠŸèƒ½
xpack.security.enabled: true

# è®¤è¯åŸŸé…ç½®åŸºæœ¬æ ¼å¼
xpack.security.authc:
  realms:
    è®¤è¯ç±»å‹:
      åŸŸåç§°:
        order: ä¼˜å…ˆçº§æ•°å­—
        enabled: true/false
        å…·ä½“é…ç½®å‚æ•°...
```

---

## 2. ğŸ‘¤ æœ¬åœ°è®¤è¯åŸŸé…ç½®


### 2.1 æœ¬åœ°è®¤è¯æ˜¯ä»€ä¹ˆ


**ğŸ”¸ æœ¬åœ°è®¤è¯çš„å«ä¹‰**
æœ¬åœ°è®¤è¯å°±åƒæ˜¯åœ¨è‡ªå·±å®¶é‡Œç®¡ç†é’¥åŒ™ä¸€æ ·ï¼Œæ‰€æœ‰çš„ç”¨æˆ·è´¦å·å’Œå¯†ç éƒ½å­˜å‚¨åœ¨Elasticsearchè‡ªå·±çš„æ•°æ®åº“é‡Œã€‚

**ğŸ’ª é€‚ç”¨åœºæ™¯**
- âœ… **å°å‹å›¢é˜Ÿ**ï¼šç”¨æˆ·æ•°é‡ä¸å¤šï¼Œç®¡ç†ç®€å•
- âœ… **ç‹¬ç«‹ç³»ç»Ÿ**ï¼šä¸éœ€è¦ä¸å…¶ä»–ç³»ç»Ÿå…±äº«ç”¨æˆ·
- âœ… **å¿«é€Ÿä¸Šæ‰‹**ï¼šé…ç½®ç®€å•ï¼Œé€‚åˆæ–°æ‰‹å­¦ä¹ 
- âœ… **æµ‹è¯•ç¯å¢ƒ**ï¼šå¼€å‘æµ‹è¯•æ—¶ä½¿ç”¨

### 2.2 æœ¬åœ°è®¤è¯é…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€é…ç½®**
```yaml
# elasticsearch.ymlæ–‡ä»¶é…ç½®
xpack.security.authc:
  realms:
    native:
      native1:  # åŸŸåç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
        order: 0  # ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
        enabled: true
```

**ğŸ”‘ åˆ›å»ºæœ¬åœ°ç”¨æˆ·çš„æ­¥éª¤**

**æ­¥éª¤1ï¸âƒ£ï¼šåˆ›å»ºç”¨æˆ·**
```bash
# ä½¿ç”¨elasticsearch-userså‘½ä»¤åˆ›å»ºç”¨æˆ·
bin/elasticsearch-users useradd ç”¨æˆ·å -p å¯†ç  -r è§’è‰²å

# å®é™…ç¤ºä¾‹
bin/elasticsearch-users useradd john -p mypassword123 -r superuser
```

**æ­¥éª¤2ï¸âƒ£ï¼šæŸ¥çœ‹ç”¨æˆ·**
```bash
# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
bin/elasticsearch-users list

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·ä¿¡æ¯
bin/elasticsearch-users users john
```

**æ­¥éª¤3ï¸âƒ£ï¼šä¿®æ”¹ç”¨æˆ·**
```bash
# ä¿®æ”¹å¯†ç 
bin/elasticsearch-users passwd john

# ä¿®æ”¹è§’è‰²
bin/elasticsearch-users roles john -a admin,kibana_user -r superuser
```

### 2.3 ç”¨æˆ·è§’è‰²ç®¡ç†


**ğŸ­ å†…ç½®è§’è‰²è¯´æ˜**

| è§’è‰²åç§° | **æƒé™è¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|
| `superuser` | `å®Œå…¨æ§åˆ¶æƒé™` | `ç³»ç»Ÿç®¡ç†å‘˜` |
| `kibana_admin` | `Kibanaå®Œå…¨è®¿é—®` | `Kibanaç®¡ç†å‘˜` |
| `logstash_system` | `Logstashç³»ç»Ÿè´¦å·` | `æ•°æ®å¯¼å…¥` |
| `beats_system` | `Beatsç³»ç»Ÿè´¦å·` | `æ•°æ®æ”¶é›†` |
| `monitoring_user` | `ç›‘æ§æ•°æ®è®¿é—®` | `è¿ç»´äººå‘˜` |
| `machine_learning_admin` | `æœºå™¨å­¦ä¹ ç®¡ç†` | `AIåˆ†æå¸ˆ` |

**ğŸ› ï¸ è‡ªå®šä¹‰è§’è‰²åˆ›å»º**
```bash
# é€šè¿‡APIåˆ›å»ºè‡ªå®šä¹‰è§’è‰²
curl -X POST "localhost:9200/_security/role/my_custom_role" \
-H 'Content-Type: application/json' -d'
{
  "cluster": ["monitor"],
  "indices": [
    {
      "names": ["my_index*"],
      "privileges": ["read", "write"]
    }
  ]
}'
```

---

## 3. ğŸ¢ LDAPè®¤è¯åŸŸé…ç½®


### 3.1 LDAPè®¤è¯æ¦‚å¿µè§£é‡Š


**ğŸ”¸ LDAPæ˜¯ä»€ä¹ˆ**
LDAPå°±åƒæ˜¯å…¬å¸çš„"å‘˜å·¥èŠ±åå†Œ"ï¼Œé‡Œé¢è®°å½•äº†æ‰€æœ‰å‘˜å·¥çš„ä¿¡æ¯ã€‚å½“ä½ è¦ç™»å½•ç³»ç»Ÿæ—¶ï¼Œç³»ç»Ÿä¼šå»è¿™ä¸ª"èŠ±åå†Œ"é‡ŒæŸ¥æ‰¾éªŒè¯ä½ çš„èº«ä»½ã€‚

```
LDAPè®¤è¯æµç¨‹ç¤ºæ„ï¼š

ç”¨æˆ·ç™»å½•è¯·æ±‚
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æŸ¥è¯¢ç”¨æˆ·    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Elasticsearchâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ LDAPæœåŠ¡å™¨  â”‚
â”‚    é›†ç¾¤      â”‚              â”‚  (èŠ±åå†Œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  è¿”å›ç”¨æˆ·ä¿¡æ¯
```

**ğŸ’¼ é€‚ç”¨åœºæ™¯**
- âœ… **ä¼ä¸šç¯å¢ƒ**ï¼šå…¬å¸å·²æœ‰LDAP/ADç³»ç»Ÿ
- âœ… **ç»Ÿä¸€è®¤è¯**ï¼šå¤šä¸ªç³»ç»Ÿå…±äº«ç”¨æˆ·è´¦å·
- âœ… **å¤§å‹å›¢é˜Ÿ**ï¼šç”¨æˆ·æ•°é‡å¤šï¼Œé›†ä¸­ç®¡ç†
- âœ… **å®‰å…¨è¦æ±‚é«˜**ï¼šéœ€è¦ä¼ä¸šçº§å®‰å…¨æ§åˆ¶

### 3.2 LDAPè®¤è¯é…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€LDAPé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    ldap:
      ldap1:  # LDAPåŸŸåç§°
        order: 1
        enabled: true
        url: "ldap://ldap.company.com:389"  # LDAPæœåŠ¡å™¨åœ°å€
        bind_dn: "cn=elasticsearch,ou=services,dc=company,dc=com"  # ç»‘å®šç”¨æˆ·
        bind_password: "password123"  # ç»‘å®šå¯†ç 
        user_search:
          base_dn: "ou=users,dc=company,dc=com"  # ç”¨æˆ·æœç´¢åŸºç¡€DN
          filter: "(cn={0})"  # ç”¨æˆ·æœç´¢è¿‡æ»¤å™¨
          attribute: cn  # ç”¨æˆ·åå±æ€§
        group_search:
          base_dn: "ou=groups,dc=company,dc=com"  # ç»„æœç´¢åŸºç¡€DN
          filter: "(uniqueMember={0})"  # ç»„æœç´¢è¿‡æ»¤å™¨
        files:
          role_mapping: "config/role_mapping.yml"  # è§’è‰²æ˜ å°„æ–‡ä»¶
```

**ğŸ”§ LDAPé…ç½®å‚æ•°è¯¦è§£**

**è¿æ¥é…ç½®ï¼š**
- `url`ï¼šLDAPæœåŠ¡å™¨åœ°å€å’Œç«¯å£
- `bind_dn`ï¼šç”¨äºè¿æ¥LDAPçš„æœåŠ¡è´¦å·
- `bind_password`ï¼šæœåŠ¡è´¦å·å¯†ç 
- `load_balance.type`ï¼šè´Ÿè½½å‡è¡¡ç±»å‹ï¼ˆfailover/round_robinï¼‰

**ç”¨æˆ·æœç´¢é…ç½®ï¼š**
- `base_dn`ï¼šæœç´¢ç”¨æˆ·çš„èµ·å§‹ä½ç½®
- `filter`ï¼šç”¨æˆ·æœç´¢æ¡ä»¶ï¼Œ`{0}`ä»£è¡¨ç”¨æˆ·å
- `attribute`ï¼šLDAPä¸­ç”¨æˆ·åå¯¹åº”çš„å±æ€§

**ç»„æœç´¢é…ç½®ï¼š**
- `base_dn`ï¼šæœç´¢ç»„çš„èµ·å§‹ä½ç½®  
- `filter`ï¼šç»„æœç´¢æ¡ä»¶ï¼Œ`{0}`ä»£è¡¨ç”¨æˆ·DN
- `user_attribute`ï¼šç”¨æˆ·æ‰€å±ç»„çš„å±æ€§

### 3.3 LDAPè§’è‰²æ˜ å°„é…ç½®


**ğŸ“‹ role_mapping.ymlæ–‡ä»¶ç¤ºä¾‹**
```yaml
# å°†LDAPç»„æ˜ å°„åˆ°ESè§’è‰²
superuser:  # ESè§’è‰²å
  - "cn=admin,ou=groups,dc=company,dc=com"  # LDAPç»„DN

kibana_admin:
  - "cn=kibana_admins,ou=groups,dc=company,dc=com"

developer:
  - "cn=developers,ou=groups,dc=company,dc=com"
  
# åŸºäºç”¨æˆ·DNçš„æ˜ å°„
monitoring_user:
  - "cn=john,ou=users,dc=company,dc=com"
  - "cn=jane,ou=users,dc=company,dc=com"
```

**ğŸ”„ åŠ¨æ€è§’è‰²æ˜ å°„ï¼ˆæ¨èï¼‰**
```bash
# é€šè¿‡APIåˆ›å»ºåŠ¨æ€è§’è‰²æ˜ å°„
curl -X POST "localhost:9200/_security/role_mapping/ldap_admins" \
-H 'Content-Type: application/json' -d'
{
  "roles": ["superuser"],
  "rules": {
    "field": {
      "groups": "cn=admin,ou=groups,dc=company,dc=com"
    }
  },
  "enabled": true
}'
```

---

## 4. ğŸ¢ Active Directoryè®¤è¯é…ç½®


### 4.1 ADè®¤è¯æ¦‚å¿µè¯´æ˜


**ğŸ”¸ Active Directoryæ˜¯ä»€ä¹ˆ**
ADå°±æ˜¯å¾®è½¯å…¬å¸çš„"è¶…çº§å‘˜å·¥ç®¡ç†ç³»ç»Ÿ"ï¼Œæ¯”LDAPåŠŸèƒ½æ›´å¼ºå¤§ã€‚å¦‚æœè¯´LDAPæ˜¯"å‘˜å·¥èŠ±åå†Œ"ï¼Œé‚£ADå°±æ˜¯"æ™ºèƒ½äººäº‹ç®¡ç†ç³»ç»Ÿ"ã€‚

**ğŸ”„ AD vs LDAPå¯¹æ¯”**

| ç‰¹æ€§ | **LDAP** | **Active Directory** |
|------|----------|---------------------|
| `å‚å•†` | `å¼€æ”¾æ ‡å‡†` | `å¾®è½¯ä¸“æœ‰` |
| `åŠŸèƒ½` | `ç›®å½•æœåŠ¡` | `ç›®å½•æœåŠ¡+åŸŸæ§åˆ¶` |
| `å®‰å…¨` | `åŸºç¡€è®¤è¯` | `Kerberos+NTLM` |
| `é›†æˆ` | `é€šç”¨æ€§å¥½` | `Windowsç¯å¢ƒä¼˜åŒ–` |

### 4.2 ADè®¤è¯é…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€ADé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    active_directory:
      ad1:  # ADåŸŸåç§°
        order: 1
        enabled: true
        domain_name: "company.local"  # ADåŸŸå
        url: "ldap://dc1.company.local:389"  # åŸŸæ§åˆ¶å™¨åœ°å€
        bind_dn: "elasticsearch@company.local"  # æœåŠ¡è´¦å·
        bind_password: "ServicePassword123"  # æœåŠ¡è´¦å·å¯†ç 
        user_search:
          base_dn: "cn=users,dc=company,dc=local"
          filter: "(&(objectClass=user)(sAMAccountName={0}))"  # ADç”¨æˆ·è¿‡æ»¤å™¨
        group_search:
          base_dn: "cn=users,dc=company,dc=local"
          filter: "(&(objectClass=group)(member={0}))"  # ADç»„è¿‡æ»¤å™¨
        files:
          role_mapping: "config/role_mapping.yml"
```

**ğŸ”§ ADç‰¹æœ‰é…ç½®å‚æ•°**

**åŸŸç›¸å…³é…ç½®ï¼š**
- `domain_name`ï¼šADåŸŸåï¼ˆå¦‚company.localï¼‰
- `url`ï¼šåŸŸæ§åˆ¶å™¨LDAPåœ°å€
- `load_balance.type`ï¼šå¤šåŸŸæ§åˆ¶å™¨è´Ÿè½½å‡è¡¡

**ADç‰¹æ®Šå±æ€§ï¼š**
- `sAMAccountName`ï¼šWindowsç™»å½•å
- `userPrincipalName`ï¼šç”¨æˆ·ä¸»ä½“åç§°ï¼ˆemailæ ¼å¼ï¼‰
- `memberOf`ï¼šç”¨æˆ·æ‰€å±ç»„ï¼ˆADè‡ªåŠ¨ç»´æŠ¤ï¼‰

### 4.3 ADé«˜çº§é…ç½®é€‰é¡¹


**ğŸ”’ å®‰å…¨è¿æ¥é…ç½®**
```yaml
xpack.security.authc:
  realms:
    active_directory:
      ad1:
        url: "ldaps://dc1.company.local:636"  # ä½¿ç”¨SSL
        ssl:
          verification_mode: certificate  # è¯ä¹¦éªŒè¯æ¨¡å¼
          truststore.path: "config/certs/ad-ca.p12"  # ä¿¡ä»»è¯ä¹¦åº“
          truststore.password: "truststorepass"
```

**âš¡ ç¼“å­˜ä¼˜åŒ–é…ç½®**
```yaml
xpack.security.authc:
  realms:
    active_directory:
      ad1:
        cache.ttl: "20m"  # ç¼“å­˜ç”Ÿå­˜æ—¶é—´
        cache.max_users: 100000  # æœ€å¤§ç¼“å­˜ç”¨æˆ·æ•°
        cache.hash_algo: "ssha256"  # å“ˆå¸Œç®—æ³•
```

---

## 5. ğŸ“ æ–‡ä»¶è®¤è¯åŸŸé…ç½®


### 5.1 æ–‡ä»¶è®¤è¯æ¦‚å¿µ


**ğŸ”¸ æ–‡ä»¶è®¤è¯çš„æœ¬è´¨**
æ–‡ä»¶è®¤è¯å°±åƒæ˜¯æŠŠæ‰€æœ‰å‘˜å·¥ä¿¡æ¯å†™åœ¨ä¸€æœ¬"é€šè®¯å½•"é‡Œï¼Œéœ€è¦éªŒè¯èº«ä»½æ—¶å°±ç¿»è¿™æœ¬é€šè®¯å½•æŸ¥æ‰¾ã€‚è¿™ç§æ–¹å¼ç®€å•ç›´æ¥ï¼Œä½†ç”¨æˆ·æ•°é‡å¤šæ—¶ç®¡ç†ä¼šæ¯”è¾ƒéº»çƒ¦ã€‚

**ğŸ“Š é€‚ç”¨åœºæ™¯è¯„ä¼°**

| åœºæ™¯ | **é€‚ç”¨æ€§** | **åŸå› è¯´æ˜** |
|------|-----------|-------------|
| `å°å‹å›¢é˜Ÿ` | `â­â­â­â­â­` | `ç”¨æˆ·å°‘ï¼Œç®¡ç†ç®€å•` |
| `æµ‹è¯•ç¯å¢ƒ` | `â­â­â­â­â­` | `å¿«é€Ÿæ­å»ºï¼Œæ˜“äºè°ƒè¯•` |
| `ä¸´æ—¶é¡¹ç›®` | `â­â­â­â­â˜†` | `æ— éœ€å¤æ‚åŸºç¡€è®¾æ–½` |
| `å¤§å‹ä¼ä¸š` | `â­â­â˜†â˜†â˜†` | `ç”¨æˆ·å¤šï¼Œç»´æŠ¤å›°éš¾` |

### 5.2 æ–‡ä»¶è®¤è¯é…ç½®æ­¥éª¤


**ğŸ“ é…ç½®æ–‡ä»¶è®¾ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    file:
      file1:  # æ–‡ä»¶åŸŸåç§°
        order: 2
        enabled: true
```

**ğŸ”§ ç”¨æˆ·æ–‡ä»¶æ ¼å¼ï¼ˆconfig/usersï¼‰**
```
# ç”¨æˆ·æ–‡ä»¶æ ¼å¼ï¼šç”¨æˆ·å:å¯†ç å“ˆå¸Œå€¼
john:$2a$10$xxxxxxxxxxxxxxxxxxxxxxxxxxx
jane:$2a$10$yyyyyyyyyyyyyyyyyyyyyyyyyyy
admin:$2a$10$zzzzzzzzzzzzzzzzzzzzzzzzzzz

# æ³¨æ„ï¼šå¯†ç æ˜¯ç»è¿‡bcryptåŠ å¯†çš„å“ˆå¸Œå€¼ï¼Œä¸æ˜¯æ˜æ–‡
```

**ğŸ‘¥ è§’è‰²æ–‡ä»¶æ ¼å¼ï¼ˆconfig/users_rolesï¼‰**
```
# è§’è‰²åˆ†é…æ ¼å¼ï¼šè§’è‰²å:ç”¨æˆ·1,ç”¨æˆ·2,ç”¨æˆ·3
superuser:admin
kibana_admin:john,jane
monitoring_user:john
developer:jane

# ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²
```

### 5.3 æ–‡ä»¶è®¤è¯ç”¨æˆ·ç®¡ç†


**ğŸ”‘ åˆ›å»ºç”¨æˆ·çš„æ–¹æ³•**

**æ–¹æ³•1ï¸âƒ£ï¼šä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·**
```bash
# æ·»åŠ æ–°ç”¨æˆ·
bin/elasticsearch-users useradd newuser -p newpassword123 -r kibana_user

# ä¿®æ”¹ç”¨æˆ·å¯†ç 
bin/elasticsearch-users passwd john

# åˆ é™¤ç”¨æˆ·
bin/elasticsearch-users userdel olduser
```

**æ–¹æ³•2ï¸âƒ£ï¼šæ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶**
```bash
# ç”Ÿæˆå¯†ç å“ˆå¸Œï¼ˆéœ€è¦bcryptå·¥å…·ï¼‰
echo -n "mypassword" | htpasswd -bnBC 10 "" | tr -d ':\n' | sed 's/$2y/$2a/'

# å°†ç”Ÿæˆçš„å“ˆå¸Œå€¼æ·»åŠ åˆ°usersæ–‡ä»¶
echo "newuser:$2a$10$generated_hash_here" >> config/users

# åœ¨users_rolesæ–‡ä»¶ä¸­åˆ†é…è§’è‰²
echo "developer:newuser" >> config/users_roles
```

**ğŸ“‹ ç”¨æˆ·ç®¡ç†æœ€ä½³å®è·µ**
- âœ… **å®šæœŸå¤‡ä»½**ï¼šå¤‡ä»½userså’Œusers_rolesæ–‡ä»¶
- âœ… **æƒé™æ§åˆ¶**ï¼šæ–‡ä»¶æƒé™è®¾ä¸º600ï¼ˆåªæœ‰ownerå¯è¯»å†™ï¼‰
- âœ… **å¯†ç ç­–ç•¥**ï¼šä½¿ç”¨å¼ºå¯†ç ï¼Œå®šæœŸæ›´æ–°
- âœ… **è§’è‰²æœ€å°åŒ–**ï¼šåªåˆ†é…å¿…è¦çš„è§’è‰²

---

## 6. ğŸ”— SAMLè®¤è¯é…ç½®


### 6.1 SAMLè®¤è¯æ¦‚å¿µè§£é‡Š


**ğŸ”¸ SAMLæ˜¯ä»€ä¹ˆ**
SAMLå°±åƒæ˜¯"å¯ä¿¡ä»»çš„ä»‹ç»äºº"ç³»ç»Ÿã€‚æ¯”å¦‚ä½ å»é“¶è¡ŒåŠäº‹ï¼Œé“¶è¡Œä¿¡ä»»æ”¿åºœé¢å‘çš„èº«ä»½è¯ï¼ŒSAMLå°±æ˜¯è¿™æ ·ä¸€ä¸ª"å¯ä¿¡ä»»çš„èº«ä»½è¯æ˜"æ ‡å‡†ã€‚

```
SAMLè®¤è¯æµç¨‹ï¼š

ç”¨æˆ· â”€â”€â‘ ç™»å½•è¯·æ±‚â”€â”€â–º Elasticsearch â”€â”€â‘¡é‡å®šå‘â”€â”€â–º SAMLèº«ä»½æä¾›å•†
                        â”‚                        â”‚
                        â”‚                        â”‚
ç”¨æˆ· â—„â”€â”€â‘¤è®¿é—®èµ„æºâ”€â”€â”€ Elasticsearch â—„â”€â”€â‘£SAMLæ–­è¨€â”€â”€â”€ èº«ä»½æä¾›å•†
                        â”‚                        â”‚
                        â–¼                        â–¼
                   â‘¢ç”¨æˆ·åœ¨IdPç™»å½•            éªŒè¯èº«ä»½
```

**ğŸ¢ å¸¸è§SAMLèº«ä»½æä¾›å•†**
- **Microsoft ADFS**ï¼šå¾®è½¯æ´»åŠ¨ç›®å½•è”åˆæœåŠ¡
- **Okta**ï¼šäº‘èº«ä»½ç®¡ç†æœåŠ¡
- **Azure AD**ï¼šå¾®è½¯äº‘èº«ä»½æœåŠ¡
- **Google Workspace**ï¼šè°·æ­Œä¼ä¸šæœåŠ¡
- **Auth0**ï¼šèº«ä»½è®¤è¯å³æœåŠ¡

### 6.2 SAMLé…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€SAMLé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    saml:
      saml1:  # SAMLåŸŸåç§°
        order: 1
        enabled: true
        idp.metadata.path: "config/saml/idp-metadata.xml"  # IdPå…ƒæ•°æ®æ–‡ä»¶
        idp.entity_id: "https://idp.company.com"  # èº«ä»½æä¾›å•†ID
        sp.entity_id: "https://elasticsearch.company.com"  # æœåŠ¡æä¾›å•†ID
        sp.acs: "https://elasticsearch.company.com:9200/_security/saml/authenticate"  # æ–­è¨€æ¶ˆè´¹æœåŠ¡
        sp.logout: "https://elasticsearch.company.com:9200/_security/saml/logout"  # ç™»å‡ºæœåŠ¡
        attributes.principal: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"  # ç”¨æˆ·åå±æ€§
        attributes.groups: "http://schemas.xmlsoap.org/claims/Group"  # ç»„å±æ€§
```

**ğŸ”§ SAMLé…ç½®å‚æ•°è¯´æ˜**

**èº«ä»½æä¾›å•†é…ç½®ï¼š**
- `idp.metadata.path`ï¼šIdPå…ƒæ•°æ®æ–‡ä»¶ä½ç½®
- `idp.entity_id`ï¼šèº«ä»½æä¾›å•†å”¯ä¸€æ ‡è¯†
- `idp.sso_url`ï¼šå•ç‚¹ç™»å½•URLï¼ˆå¦‚æœä¸åœ¨å…ƒæ•°æ®ä¸­ï¼‰

**æœåŠ¡æä¾›å•†é…ç½®ï¼š**
- `sp.entity_id`ï¼šElasticsearchä½œä¸ºSPçš„å”¯ä¸€æ ‡è¯†
- `sp.acs`ï¼šæ–­è¨€æ¶ˆè´¹æœåŠ¡URLï¼Œæ¥æ”¶SAMLå“åº”
- `sp.logout`ï¼šç™»å‡ºæœåŠ¡URL

**å±æ€§æ˜ å°„é…ç½®ï¼š**
- `attributes.principal`ï¼šç”¨æˆ·ä¸»ä½“åç§°å±æ€§
- `attributes.groups`ï¼šç”¨æˆ·ç»„å±æ€§
- `attributes.name`ï¼šæ˜¾ç¤ºåç§°å±æ€§
- `attributes.email`ï¼šé‚®ç®±å±æ€§

### 6.3 SAMLè¯ä¹¦é…ç½®


**ğŸ”’ è¯ä¹¦å®‰å…¨é…ç½®**
```yaml
xpack.security.authc:
  realms:
    saml:
      saml1:
        signing.keystore.path: "config/saml/saml.p12"  # ç­¾åè¯ä¹¦åº“
        signing.keystore.password: "keystorepass"  # è¯ä¹¦åº“å¯†ç 
        signing.keystore.alias: "saml"  # è¯ä¹¦åˆ«å
        encryption.keystore.path: "config/saml/saml-enc.p12"  # åŠ å¯†è¯ä¹¦åº“
        encryption.keystore.password: "enckeypass"
```

**ğŸ“‹ è¯ä¹¦ç®¡ç†æ­¥éª¤**
```bash
# 1. ç”ŸæˆSAMLç­¾åè¯ä¹¦
keytool -genkeypair -alias saml-signing \
  -keyalg RSA -keysize 2048 \
  -keystore config/saml/saml.p12 \
  -storetype PKCS12 \
  -validity 3650

# 2. å¯¼å‡ºå…¬é’¥è¯ä¹¦ï¼ˆæä¾›ç»™IdPï¼‰
keytool -export -alias saml-signing \
  -keystore config/saml/saml.p12 \
  -file config/saml/saml-signing.crt

# 3. ç”Ÿæˆå…ƒæ•°æ®æ–‡ä»¶
bin/elasticsearch-saml-metadata \
  --realm saml1 \
  --out config/saml/sp-metadata.xml
```

---

## 7. ğŸ”‘ OpenID Connectè®¤è¯


### 7.1 OpenID Connectæ¦‚å¿µ


**ğŸ”¸ OIDCæ˜¯ä»€ä¹ˆ**
OpenID Connectï¼ˆOIDCï¼‰å°±åƒæ˜¯"ç°ä»£ç‰ˆçš„èº«ä»½è¯ç³»ç»Ÿ"ã€‚å¦‚æœè¯´SAMLæ˜¯ä¼ ç»Ÿçš„çº¸è´¨è¯ä»¶ï¼Œé‚£OIDCå°±æ˜¯ç”µå­èº«ä»½è¯ï¼Œæ›´åŠ çµæ´»å’Œç°ä»£åŒ–ã€‚

**ğŸ”„ OIDC vs SAMLå¯¹æ¯”**

| ç‰¹æ€§ | **SAML** | **OpenID Connect** |
|------|----------|-------------------|
| `æŠ€æœ¯åŸºç¡€` | `XML` | `JSON + REST API` |
| `å¤æ‚åº¦` | `å¤æ‚é…ç½®` | `ç›¸å¯¹ç®€å•` |
| `ç§»åŠ¨ç«¯` | `æ”¯æŒè¾ƒå·®` | `åŸç”Ÿæ”¯æŒ` |
| `ç°ä»£åŒ–` | `ä¼ä¸šä¼ ç»Ÿ` | `äº‘åŸç”Ÿå‹å¥½` |

### 7.2 OIDCé…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€OIDCé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    oidc:
      oidc1:  # OIDCåŸŸåç§°
        order: 1
        enabled: true
        op.issuer: "https://auth.company.com"  # èº«ä»½æä¾›å•†å‘è¡Œè€…URL
        op.authorization_endpoint: "https://auth.company.com/auth"  # æˆæƒç«¯ç‚¹
        op.token_endpoint: "https://auth.company.com/token"  # ä»¤ç‰Œç«¯ç‚¹
        op.userinfo_endpoint: "https://auth.company.com/userinfo"  # ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹
        op.jwkset_path: "https://auth.company.com/.well-known/jwks.json"  # å…¬é’¥é›†åˆ
        rp.client_id: "elasticsearch-client"  # å®¢æˆ·ç«¯ID
        rp.client_secret: "client_secret_123"  # å®¢æˆ·ç«¯å¯†é’¥
        rp.redirect_uri: "https://elasticsearch.company.com:9200/_security/oidc/authenticate"  # å›è°ƒURI
        claims.principal: "email"  # ç”¨æˆ·ä¸»ä½“å£°æ˜
        claims.groups: "groups"  # ç»„å£°æ˜
```

**ğŸ”§ OIDCé…ç½®å‚æ•°è¯¦è§£**

**æä¾›å•†é…ç½®ï¼ˆOP - OpenID Providerï¼‰ï¼š**
- `op.issuer`ï¼šèº«ä»½æä¾›å•†æ ‡è¯†ç¬¦
- `op.authorization_endpoint`ï¼šè·å–æˆæƒç çš„ç«¯ç‚¹
- `op.token_endpoint`ï¼šäº¤æ¢è®¿é—®ä»¤ç‰Œçš„ç«¯ç‚¹
- `op.userinfo_endpoint`ï¼šè·å–ç”¨æˆ·ä¿¡æ¯çš„ç«¯ç‚¹

**ä¾èµ–æ–¹é…ç½®ï¼ˆRP - Relying Partyï¼‰ï¼š**
- `rp.client_id`ï¼šåœ¨IdPæ³¨å†Œçš„å®¢æˆ·ç«¯æ ‡è¯†
- `rp.client_secret`ï¼šå®¢æˆ·ç«¯å¯†é’¥ï¼ˆæœºå¯†å®¢æˆ·ç«¯ï¼‰
- `rp.redirect_uri`ï¼šæˆæƒåçš„å›è°ƒåœ°å€

**å£°æ˜æ˜ å°„é…ç½®ï¼š**
- `claims.principal`ï¼šç”¨æˆ·ä¸»ä½“æ ‡è¯†å£°æ˜
- `claims.groups`ï¼šç”¨æˆ·ç»„å£°æ˜
- `claims.name`ï¼šæ˜¾ç¤ºåç§°å£°æ˜

### 7.3 OIDCæµç¨‹é…ç½®


**ğŸ”„ æˆæƒç æµç¨‹é…ç½®**
```yaml
xpack.security.authc:
  realms:
    oidc:
      oidc1:
        rp.response_type: "code"  # æˆæƒç æ¨¡å¼
        rp.scope: "openid profile email groups"  # è¯·æ±‚èŒƒå›´
        op.end_session_endpoint: "https://auth.company.com/logout"  # ç™»å‡ºç«¯ç‚¹
        claims.mail: "email"  # é‚®ç®±å£°æ˜æ˜ å°„
        claims.name: "name"  # å§“åå£°æ˜æ˜ å°„
```

**ğŸ›¡ï¸ å®‰å…¨é…ç½®é€‰é¡¹**
```yaml
xpack.security.authc:
  realms:
    oidc:
      oidc1:
        op.jwkset_path: "config/oidc/jwks.json"  # æœ¬åœ°å…¬é’¥æ–‡ä»¶
        rp.post_logout_redirect_uri: "https://kibana.company.com"  # ç™»å‡ºåé‡å®šå‘
        ssl.verification_mode: "certificate"  # SSLéªŒè¯æ¨¡å¼
        ssl.truststore.path: "config/certs/oidc-ca.p12"  # ä¿¡ä»»è¯ä¹¦åº“
```

---

## 8. ğŸ« Kerberosè®¤è¯é…ç½®


### 8.1 Kerberosè®¤è¯æ¦‚å¿µ


**ğŸ”¸ Kerberosæ˜¯ä»€ä¹ˆ**
Kerberoså°±åƒæ˜¯ä¸€ä¸ª"å¯ä¿¡ä»»çš„ç¥¨åŠ¡ç³»ç»Ÿ"ã€‚å°±åƒä½ ä¹°äº†ç”µå½±ç¥¨ï¼Œå‡­ç¥¨è¿›å…¥ç”µå½±é™¢ä¸€æ ·ï¼ŒKerberosç»™ç”¨æˆ·å‘æ”¾"ç¥¨æ®"ï¼Œç”¨æˆ·å‡­ç¥¨æ®è®¿é—®å„ç§æœåŠ¡ã€‚

```
Kerberosè®¤è¯æµç¨‹ï¼š

ç”¨æˆ· â”€â”€â‘ è¯·æ±‚ç¥¨æ®â”€â”€â–º KDCè®¤è¯æœåŠ¡å™¨ â”€â”€â‘¡é¢å‘TGTâ”€â”€â–º ç”¨æˆ·
                      â”‚                     â”‚
                      â”‚                     â”‚
ç”¨æˆ· â”€â”€â‘£è®¿é—®ESâ”€â”€â–º Elasticsearch â—„â”€â”€â‘¢è¯·æ±‚æœåŠ¡ç¥¨æ®â”€â”€ ç”¨æˆ·
     (æŒç¥¨æ®)
```

**ğŸ¢ Kerberosé€‚ç”¨ç¯å¢ƒ**
- âœ… **WindowsåŸŸç¯å¢ƒ**ï¼šä¸ADæ·±åº¦é›†æˆ
- âœ… **æ··åˆç¯å¢ƒ**ï¼šWindows + Linuxç»Ÿä¸€è®¤è¯  
- âœ… **é«˜å®‰å…¨è¦æ±‚**ï¼šé‡‘èã€æ”¿åºœç­‰è¡Œä¸š
- âœ… **å•ç‚¹ç™»å½•**ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„é€šè¡Œ

### 8.2 Kerberosé…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€Kerberosé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    kerberos:
      kerb1:  # KerberosåŸŸåç§°
        order: 1
        enabled: true
        keytab.path: "config/kerberos/elasticsearch.keytab"  # å¯†é’¥è¡¨æ–‡ä»¶
        remove_realm_name: false  # æ˜¯å¦ç§»é™¤åŸŸååç¼€
        cache.ttl: "20m"  # ç¼“å­˜æ—¶é—´
        cache.max_users: 100000  # æœ€å¤§ç¼“å­˜ç”¨æˆ·æ•°
```

**ğŸ”§ Kerberosç¯å¢ƒå‡†å¤‡**

**æ­¥éª¤1ï¸âƒ£ï¼šå‡†å¤‡keytabæ–‡ä»¶**
```bash
# åœ¨åŸŸæ§åˆ¶å™¨ä¸Šåˆ›å»ºæœåŠ¡ä¸»ä½“
setspn -A HTTP/elasticsearch.company.com elasticsearch_service

# ç”Ÿæˆkeytabæ–‡ä»¶
ktpass -out elasticsearch.keytab \
  -princ HTTP/elasticsearch.company.com@COMPANY.COM \
  -mapUser elasticsearch_service \
  -crypto AES256-SHA1 \
  -pType KRB5_NT_PRINCIPAL
```

**æ­¥éª¤2ï¸âƒ£ï¼šé…ç½®krb5.conf**
```ini
# /etc/krb5.conf (Linux) æˆ– C:\Windows\krb5.ini (Windows)
[libdefaults]
    default_realm = COMPANY.COM
    dns_lookup_realm = false
    dns_lookup_kdc = false
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    COMPANY.COM = {
        kdc = dc1.company.com
        kdc = dc2.company.com
        admin_server = dc1.company.com
    }

[domain_realm]
    .company.com = COMPANY.COM
    company.com = COMPANY.COM
```

### 8.3 Kerberosè§’è‰²æ˜ å°„


**ğŸ“‹ Kerberosç”¨æˆ·æ˜ å°„é…ç½®**
```yaml
# role_mapping.ymlæ–‡ä»¶
superuser:
  - "admin@COMPANY.COM"
  - "elasticsearch_admin@COMPANY.COM"

kibana_admin:
  - "kibana_admins@COMPANY.COM"

developer:
  - "dev_team@COMPANY.COM"

# ä½¿ç”¨é€šé…ç¬¦åŒ¹é…
monitoring_user:
  - "*@COMPANY.COM"  # æ‰€æœ‰åŸŸç”¨æˆ·éƒ½æœ‰ç›‘æ§æƒé™
```

**ğŸ”„ åŠ¨æ€è§’è‰²æ˜ å°„ç¤ºä¾‹**
```bash
# é€šè¿‡APIåˆ›å»ºè§’è‰²æ˜ å°„
curl -X POST "localhost:9200/_security/role_mapping/kerberos_admins" \
-H 'Content-Type: application/json' -d'
{
  "roles": ["superuser"],
  "rules": {
    "field": {
      "username": "admin@COMPANY.COM"
    }
  },
  "enabled": true
}'
```

---

## 9. ğŸ” PKIè®¤è¯é…ç½®


### 9.1 PKIè®¤è¯æ¦‚å¿µ


**ğŸ”¸ PKIè®¤è¯æ˜¯ä»€ä¹ˆ**
PKIï¼ˆå…¬é’¥åŸºç¡€è®¾æ–½ï¼‰è®¤è¯å°±åƒæ˜¯"æ•°å­—èº«ä»½è¯"ç³»ç»Ÿã€‚æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸€å¼ "æ•°å­—èº«ä»½è¯"ï¼ˆè¯ä¹¦ï¼‰ï¼Œç³»ç»Ÿé€šè¿‡éªŒè¯è¿™å¼ "èº«ä»½è¯"çš„çœŸä¼ªæ¥ç¡®è®¤ç”¨æˆ·èº«ä»½ã€‚

```
PKIè®¤è¯ç»„æˆç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CAæ ¹è¯ä¹¦      â”‚ â† å¯ä¿¡ä»»çš„é¢å‘æœºæ„
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ é¢å‘
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¯ä¹¦      â”‚ â† ä¸ªäººæ•°å­—èº«ä»½è¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ éªŒè¯
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Elasticsearch  â”‚ â† éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”’ PKIè®¤è¯ä¼˜åŠ¿**
- âœ… **å®‰å…¨æ€§æé«˜**ï¼šåŸºäºå¯†ç å­¦ï¼Œéš¾ä»¥ä¼ªé€ 
- âœ… **æ— éœ€å¯†ç **ï¼šä½¿ç”¨è¯ä¹¦ä»£æ›¿å¯†ç 
- âœ… **æ”¯æŒæ’¤é”€**ï¼šå¯ä»¥æ’¤é”€è¢«ç›—ç”¨çš„è¯ä¹¦
- âœ… **æ³•å¾‹æ•ˆåŠ›**ï¼šå…·æœ‰æ³•å¾‹è®¤å¯çš„èº«ä»½è¯æ˜

### 9.2 PKIé…ç½®è¯¦è§£


**ğŸ“ åŸºç¡€PKIé…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  realms:
    pki:
      pki1:  # PKIåŸŸåç§°
        order: 1
        enabled: true
        certificate_authorities: "config/certs/ca.crt"  # CAè¯ä¹¦æ–‡ä»¶
        cache.ttl: "20m"  # ç¼“å­˜æ—¶é—´
        cache.max_users: 100000  # æœ€å¤§ç¼“å­˜ç”¨æˆ·æ•°
```

**ğŸ”§ PKI SSLé…ç½®**
```yaml
# å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
xpack.security.http.ssl:
  enabled: true
  keystore.path: "config/certs/elasticsearch.p12"  # æœåŠ¡å™¨è¯ä¹¦
  keystore.password: "serverpass"
  truststore.path: "config/certs/ca.p12"  # ä¿¡ä»»CAè¯ä¹¦
  truststore.password: "capass"
  client_authentication: "required"  # è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦

# ä¼ è¾“å±‚SSLé…ç½®
xpack.security.transport.ssl:
  enabled: true
  verification_mode: certificate
  keystore.path: "config/certs/elasticsearch.p12"
  keystore.password: "serverpass"
  truststore.path: "config/certs/ca.p12"
  truststore.password: "capass"
```

### 9.3 PKIè¯ä¹¦ç®¡ç†


**ğŸ”‘ CAè¯ä¹¦åˆ›å»º**
```bash
# 1. åˆ›å»ºCAç§é’¥
openssl genrsa -out ca-key.pem 4096

# 2. åˆ›å»ºCAè¯ä¹¦
openssl req -new -x509 -days 3650 -key ca-key.pem -out ca.crt \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/CN=Company CA"

# 3. è½¬æ¢ä¸ºPKCS12æ ¼å¼
openssl pkcs12 -export -out ca.p12 -inkey ca-key.pem -in ca.crt \
  -password pass:capass
```

**ğŸ‘¤ ç”¨æˆ·è¯ä¹¦åˆ›å»º**
```bash
# 1. åˆ›å»ºç”¨æˆ·ç§é’¥
openssl genrsa -out user-key.pem 2048

# 2. åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚
openssl req -new -key user-key.pem -out user.csr \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/CN=john.doe"

# 3. ä½¿ç”¨CAç­¾å‘ç”¨æˆ·è¯ä¹¦
openssl x509 -req -in user.csr -CA ca.crt -CAkey ca-key.pem \
  -CAcreateserial -out user.crt -days 365

# 4. è½¬æ¢ä¸ºPKCS12æ ¼å¼ï¼ˆç”¨äºæµè§ˆå™¨ï¼‰
openssl pkcs12 -export -out user.p12 -inkey user-key.pem -in user.crt \
  -certfile ca.crt -password pass:userpass
```

**ğŸ“‹ PKIè§’è‰²æ˜ å°„**
```yaml
# role_mapping.yml - åŸºäºè¯ä¹¦DNæ˜ å°„
superuser:
  - "CN=admin,O=Company,C=CN"

developer:
  - "CN=john.doe,O=Company,C=CN"
  - "CN=jane.smith,O=Company,C=CN"

# åŸºäºè¯ä¹¦å±æ€§çš„é€šé…ç¬¦æ˜ å°„
kibana_user:
  - "CN=*,OU=kibana_users,O=Company,C=CN"
```

---

## 10. ğŸ‘¤ åŒ¿åè®¿é—®é…ç½®


### 10.1 åŒ¿åè®¿é—®æ¦‚å¿µ


**ğŸ”¸ åŒ¿åè®¿é—®æ˜¯ä»€ä¹ˆ**
åŒ¿åè®¿é—®å°±åƒæ˜¯"å…è´¹è¯•ç”¨"æˆ–"è®¿å®¢æ¨¡å¼"ã€‚å°±åƒå•†åœºå…è®¸é¡¾å®¢è‡ªç”±å‚è§‚ï¼Œä½†è¦è´­ä¹°å•†å“éœ€è¦ä¼šå‘˜å¡ä¸€æ ·ï¼ŒESå¯ä»¥å…è®¸æœªè®¤è¯ç”¨æˆ·è®¿é—®éƒ¨åˆ†åŠŸèƒ½ã€‚

**âš–ï¸ åŒ¿åè®¿é—®æƒè¡¡**

| ä¼˜åŠ¿ | **åŠ£åŠ¿** |
|------|---------|
| `é™ä½ä½¿ç”¨é—¨æ§›` | `å®‰å…¨é£é™©å¢åŠ ` |
| `ä¾¿äºé›†æˆæµ‹è¯•` | `èµ„æºå¯èƒ½è¢«æ»¥ç”¨` |
| `æ”¯æŒå…¬å¼€API` | `å®¡è®¡è¿½è¸ªå›°éš¾` |
| `ç®€åŒ–å®¢æˆ·ç«¯å¼€å‘` | `æƒé™æ§åˆ¶å¤æ‚` |

### 10.2 åŒ¿åè®¿é—®é…ç½®


**ğŸ“ åŸºç¡€åŒ¿åè®¿é—®é…ç½®**
```yaml
# elasticsearch.ymlé…ç½®
xpack.security.authc:
  anonymous:
    username: "anonymous_user"  # åŒ¿åç”¨æˆ·å
    roles: ["anonymous_role"]  # åŒ¿åç”¨æˆ·è§’è‰²
    authz_exception: false  # æˆæƒå¤±è´¥æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸
```

**ğŸ”§ åŒ¿åè®¿é—®é«˜çº§é…ç½®**
```yaml
xpack.security.authc:
  anonymous:
    username: "guest"
    roles: ["guest", "monitoring"]  # å¤šä¸ªè§’è‰²
    authz_exception: true  # æƒé™ä¸è¶³æ—¶è¦æ±‚è®¤è¯
```

### 10.3 åŒ¿åç”¨æˆ·è§’è‰²è®¾è®¡


**ğŸ­ åŒ¿åè§’è‰²åˆ›å»º**
```bash
# åˆ›å»ºé™åˆ¶æ€§åŒ¿åè§’è‰²
curl -X POST "localhost:9200/_security/role/anonymous_role" \
-H 'Content-Type: application/json' -d'
{
  "cluster": ["monitor"],  # åªå…è®¸ç›‘æ§é›†ç¾¤çŠ¶æ€
  "indices": [
    {
      "names": ["public_logs*"],  # åªèƒ½è®¿é—®å…¬å¼€æ—¥å¿—
      "privileges": ["read"]  # åªè¯»æƒé™
    },
    {
      "names": ["demo_index"],
      "privileges": ["read", "view_index_metadata"]
    }
  ],
  "applications": [],
  "run_as": [],
  "metadata": {
    "description": "Anonymous users with limited read access"
  }
}'
```

**ğŸ“Š åŒ¿åè®¿é—®ç›‘æ§**
```bash
# æŸ¥çœ‹åŒ¿åç”¨æˆ·æ´»åŠ¨
curl -X GET "localhost:9200/_security/_authenticate" \
-H 'Content-Type: application/json'

# ç›‘æ§åŒ¿åç”¨æˆ·çš„APIè°ƒç”¨
curl -X GET "localhost:9200/_cat/indices?v&h=index,docs.count,store.size" \
--user anonymous_user:
```

**âš ï¸ åŒ¿åè®¿é—®å®‰å…¨å»ºè®®**
- ğŸ”’ **æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™äºˆå¿…è¦çš„æœ€å°æƒé™
- ğŸ“Š **è®¿é—®ç›‘æ§**ï¼šå¯†åˆ‡ç›‘æ§åŒ¿åç”¨æˆ·è¡Œä¸º
- ğŸš« **æ•æ„Ÿæ•°æ®éš”ç¦»**ï¼šæ•æ„Ÿç´¢å¼•ç¦æ­¢åŒ¿åè®¿é—®
- ğŸ”„ **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥åŒ¿åç”¨æˆ·æƒé™é…ç½®

---

## 11. ğŸ† è®¤è¯é…ç½®æœ€ä½³å®è·µ


### 11.1 å¤šåŸŸè®¤è¯ç­–ç•¥


**ğŸ”„ è®¤è¯åŸŸä¼˜å…ˆçº§è®¾è®¡**
```yaml
# æ¨èçš„å¤šåŸŸé…ç½®é¡ºåº
xpack.security.authc:
  realms:
    # 1. å†…éƒ¨ç®¡ç†å‘˜è´¦å·ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    file:
      emergency_admin:
        order: 0
        enabled: true
    
    # 2. PKIè¯ä¹¦è®¤è¯ï¼ˆé«˜å®‰å…¨æ€§ç”¨æˆ·ï¼‰
    pki:
      cert_users:
        order: 1
        enabled: true
    
    # 3. LDAPä¼ä¸šç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
    ldap:
      corporate:
        order: 2
        enabled: true
    
    # 4. æœ¬åœ°æµ‹è¯•è´¦å·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    native:
      local_dev:
        order: 3
        enabled: true
```

**ğŸ’¡ å¤šåŸŸé…ç½®åŸåˆ™**
- âœ… **åº”æ€¥è´¦å·**ï¼šå§‹ç»ˆä¿ç•™fileåŸŸçš„ç®¡ç†å‘˜è´¦å·
- âœ… **æŒ‰å®‰å…¨çº§åˆ«æ’åº**ï¼šé«˜å®‰å…¨æ€§è®¤è¯æ–¹å¼ä¼˜å…ˆ
- âœ… **ç¯å¢ƒéš”ç¦»**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ä½¿ç”¨ä¸åŒé…ç½®
- âœ… **æ•…éšœåˆ‡æ¢**ï¼šä¸€ä¸ªåŸŸå¤±è´¥æ—¶è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ª

### 11.2 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•


**ğŸ”’ å®‰å…¨é…ç½®æ ¸æŸ¥è¡¨**

| æ£€æŸ¥é¡¹ç›® | **é…ç½®è¦æ±‚** | **çŠ¶æ€** |
|---------|-------------|---------|
| `SSL/TLSåŠ å¯†` | `æ‰€æœ‰é€šä¿¡å¿…é¡»åŠ å¯†` | `â˜ å·²é…ç½®` |
| `å¼ºå¯†ç ç­–ç•¥` | `å¯†ç å¤æ‚åº¦è¦æ±‚` | `â˜ å·²é…ç½®` |
| `è¯ä¹¦éªŒè¯` | `å¯ç”¨è¯ä¹¦é“¾éªŒè¯` | `â˜ å·²é…ç½®` |
| `è§’è‰²æœ€å°åŒ–` | `æœ€å°æƒé™åŸåˆ™` | `â˜ å·²é…ç½®` |
| `å®¡è®¡æ—¥å¿—` | `å¯ç”¨è¯¦ç»†å®¡è®¡` | `â˜ å·²é…ç½®` |
| `è®¿é—®æ§åˆ¶` | `ç½‘ç»œè®¿é—®é™åˆ¶` | `â˜ å·²é…ç½®` |
| `å®šæœŸå¤‡ä»½` | `é…ç½®æ–‡ä»¶å¤‡ä»½` | `â˜ å·²é…ç½®` |

### 11.3 æ€§èƒ½ä¼˜åŒ–é…ç½®


**âš¡ è®¤è¯æ€§èƒ½è°ƒä¼˜**
```yaml
# ç¼“å­˜ä¼˜åŒ–é…ç½®
xpack.security.authc:
  realms:
    ldap:
      corporate:
        cache.ttl: "1h"  # å¢åŠ ç¼“å­˜æ—¶é—´
        cache.max_users: 50000  # æ ¹æ®ç”¨æˆ·è§„æ¨¡è°ƒæ•´
        cache.hash_algo: "ssha256"  # ä½¿ç”¨æ›´å¿«çš„å“ˆå¸Œç®—æ³•
        
        # è¿æ¥æ± ä¼˜åŒ–
        user_search.pool.enabled: true
        user_search.pool.size: 20
        user_search.pool.initial_size: 5
        user_search.pool.health_check.enabled: true
        user_search.pool.health_check.dn: "cn=healthcheck,ou=services"
```

**ğŸ“Š ç›‘æ§é…ç½®**
```yaml
# å¯ç”¨è®¤è¯ç›¸å…³ç›‘æ§
xpack.monitoring.collection.enabled: true
xpack.security.audit.enabled: true
xpack.security.audit.logfile.events.include: [
  "authentication_success",
  "authentication_failed",
  "realm_authentication_failed",
  "access_denied",
  "access_granted"
]
```

### 11.4 æ•…éšœæ’é™¤æŒ‡å—


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**

**é—®é¢˜1ï¸âƒ£ï¼šLDAPè®¤è¯å¤±è´¥**
```bash
# æ£€æŸ¥LDAPè¿æ¥
curl -X GET "localhost:9200/_security/_authenticate" \
-H 'Authorization: Basic base64(username:password)'

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
tail -f logs/elasticsearch.log | grep -i "ldap\|authc"

# æµ‹è¯•LDAPæŸ¥è¯¢
ldapsearch -H ldap://ldap.company.com:389 \
  -D "cn=elasticsearch,ou=services,dc=company,dc=com" \
  -w password123 \
  -b "ou=users,dc=company,dc=com" \
  "(cn=testuser)"
```

**é—®é¢˜2ï¸âƒ£ï¼šSSLè¯ä¹¦é—®é¢˜**
```bash
# éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
openssl x509 -in config/certs/elasticsearch.crt -text -noout

# æ£€æŸ¥è¯ä¹¦é“¾
openssl verify -CAfile config/certs/ca.crt config/certs/elasticsearch.crt

# æµ‹è¯•SSLè¿æ¥
openssl s_client -connect localhost:9200 -servername elasticsearch.company.com
```

**é—®é¢˜3ï¸âƒ£ï¼šè§’è‰²æ˜ å°„ä¸ç”Ÿæ•ˆ**
```bash
# æŸ¥çœ‹å½“å‰ç”¨æˆ·è§’è‰²
curl -X GET "localhost:9200/_security/_authenticate" \
-H 'Authorization: Basic base64(username:password)'

# æŸ¥çœ‹è§’è‰²æ˜ å°„é…ç½®
curl -X GET "localhost:9200/_security/role_mapping"

# æµ‹è¯•è§’è‰²æ˜ å°„è§„åˆ™
curl -X POST "localhost:9200/_security/role_mapping/_validate" \
-H 'Content-Type: application/json' -d'
{
  "username": "testuser",
  "groups": ["cn=developers,ou=groups,dc=company,dc=com"]
}'
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„è®¤è¯æ¦‚å¿µ


```
ğŸ”¸ è®¤è¯åŸŸ(Realm)ï¼šå®Œæ•´çš„èº«ä»½éªŒè¯è§„åˆ™é›†åˆ
ğŸ”¸ å¤šåŸŸæ”¯æŒï¼šESæ”¯æŒåŒæ—¶é…ç½®å¤šç§è®¤è¯æ–¹å¼
ğŸ”¸ ä¼˜å…ˆçº§é¡ºåºï¼šé€šè¿‡orderå‚æ•°æ§åˆ¶è®¤è¯å°è¯•é¡ºåº
ğŸ”¸ è§’è‰²æ˜ å°„ï¼šå°†å¤–éƒ¨ç”¨æˆ·/ç»„æ˜ å°„åˆ°ESå†…éƒ¨è§’è‰²
ğŸ”¸ ç¼“å­˜æœºåˆ¶ï¼šæé«˜è®¤è¯æ€§èƒ½ï¼Œå‡å°‘å¤–éƒ¨ç³»ç»Ÿå‹åŠ›
```

### 12.2 å„ç§è®¤è¯æ–¹å¼å¯¹æ¯”


| è®¤è¯æ–¹å¼ | **å¤æ‚åº¦** | **å®‰å…¨æ€§** | **é€‚ç”¨åœºæ™¯** | **ç»´æŠ¤æˆæœ¬** |
|---------|-----------|-----------|-------------|-------------|
| `Nativeæœ¬åœ°` | `â­â˜†â˜†â˜†â˜†` | `â­â­â­â˜†â˜†` | `å°å›¢é˜Ÿ/æµ‹è¯•` | `â­â­â˜†â˜†â˜†` |
| `Fileæ–‡ä»¶` | `â­â˜†â˜†â˜†â˜†` | `â­â­â˜†â˜†â˜†` | `é™æ€ç”¨æˆ·` | `â­â˜†â˜†â˜†â˜†` |
| `LDAP` | `â­â­â­â˜†â˜†` | `â­â­â­â­â˜†` | `ä¼ä¸šç¯å¢ƒ` | `â­â­â­â˜†â˜†` |
| `Active Directory` | `â­â­â­â˜†â˜†` | `â­â­â­â­â˜†` | `WindowsåŸŸ` | `â­â­â­â˜†â˜†` |
| `SAML` | `â­â­â­â­â˜†` | `â­â­â­â­â­` | `ä¼ä¸šSSO` | `â­â­â­â­â˜†` |
| `OIDC` | `â­â­â­â˜†â˜†` | `â­â­â­â­â˜†` | `ç°ä»£åº”ç”¨` | `â­â­â­â˜†â˜†` |
| `Kerberos` | `â­â­â­â­â­` | `â­â­â­â­â­` | `é«˜å®‰å…¨æ€§` | `â­â­â­â­â­` |
| `PKI` | `â­â­â­â­â­` | `â­â­â­â­â­` | `æé«˜å®‰å…¨` | `â­â­â­â­â­` |

### 12.3 é…ç½®é€‰æ‹©æŒ‡å¯¼


**ğŸ¯ æ–°æ‰‹å­¦ä¹ è·¯å¾„**
```
å…¥é—¨é˜¶æ®µï¼š
1ï¸âƒ£ Fileæ–‡ä»¶è®¤è¯ â†’ ç†è§£åŸºæœ¬æ¦‚å¿µ
2ï¸âƒ£ Nativeæœ¬åœ°è®¤è¯ â†’ å­¦ä¹ ç”¨æˆ·ç®¡ç†
3ï¸âƒ£ LDAPè®¤è¯ â†’ äº†è§£ä¼ä¸šé›†æˆ

è¿›é˜¶é˜¶æ®µï¼š
4ï¸âƒ£ SAML/OIDC â†’ æŒæ¡ç°ä»£SSO
5ï¸âƒ£ PKIè®¤è¯ â†’ å­¦ä¹ è¯ä¹¦ä½“ç³»
6ï¸âƒ£ å¤šåŸŸé…ç½® â†’ å¤æ‚ç¯å¢ƒå®æˆ˜
```

**ğŸ¢ ä¼ä¸šç¯å¢ƒå»ºè®®**
- **å°å‹å›¢é˜Ÿ**ï¼šNative + Fileå¤‡ç”¨
- **ä¸­å‹ä¼ä¸š**ï¼šLDAP + Nativeå¤‡ç”¨  
- **å¤§å‹ä¼ä¸š**ï¼šSAML/OIDC + LDAP + Fileåº”æ€¥
- **é«˜å®‰å…¨ç¯å¢ƒ**ï¼šPKI + Kerberos + å¤šå› å­è®¤è¯

### 12.4 å®é™…åº”ç”¨è®°å¿†è¦ç‚¹


**æ ¸å¿ƒé…ç½®è®°å¿†æ³•**ï¼š
- ğŸ”¢ **orderæ•°å­—**ï¼šè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼ˆ0æœ€é«˜ï¼‰
- ğŸ”§ **enabledå¼€å…³**ï¼šè®¤è¯åŸŸçš„æ€»å¼€å…³
- ğŸ“ **role_mapping**ï¼šå¤–éƒ¨èº«ä»½åˆ°å†…éƒ¨è§’è‰²çš„æ¡¥æ¢
- âš¡ **cacheç¼“å­˜**ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®é…ç½®

**å®‰å…¨é…ç½®ä¸‰è¦ç´ **ï¼š
- ğŸ”’ **åŠ å¯†ä¼ è¾“**ï¼šSSL/TLSä¿æŠ¤æ•°æ®ä¼ è¾“
- ğŸ‘¤ **èº«ä»½éªŒè¯**ï¼šç¡®è®¤ç”¨æˆ·èº«ä»½
- ğŸ›¡ï¸ **æƒé™æ§åˆ¶**ï¼šé™åˆ¶ç”¨æˆ·æ“ä½œèŒƒå›´

**æ•…éšœæ’é™¤æ€è·¯**ï¼š
- ğŸ“‹ **æŸ¥çœ‹æ—¥å¿—**ï¼šauthenticationç›¸å…³é”™è¯¯ä¿¡æ¯
- ğŸ” **æµ‹è¯•è¿æ¥**ï¼šéªŒè¯å¤–éƒ¨è®¤è¯ç³»ç»Ÿè¿é€šæ€§
- âš–ï¸ **æ£€æŸ¥æ˜ å°„**ï¼šç¡®è®¤è§’è‰²æ˜ å°„è§„åˆ™æ­£ç¡®æ€§
- ğŸ”„ **é€æ­¥æ’æŸ¥**ï¼šä»ç®€å•åˆ°å¤æ‚é€ä¸€éªŒè¯

**æ ¸å¿ƒè®°å¿†**ï¼š
- è®¤è¯é…ç½®è™½å¤æ‚ï¼Œç†è§£æ¦‚å¿µæ˜¯å…³é”®
- å¤šåŸŸé…ç½®æœ‰é¡ºåºï¼Œå®‰å…¨ä¼˜å…ˆè¦è®°ç‰¢
- å¤–éƒ¨é›†æˆéœ€æ˜ å°„ï¼Œè§’è‰²æƒé™è¦æ˜ç¡®
- ç¼“å­˜ç›‘æ§ä¸èƒ½å¿˜ï¼Œæ•…éšœæ’æŸ¥æœ‰æ–¹æ³•