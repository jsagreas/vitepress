---
title: 3ã€å®‰è£…ä¸å¯åŠ¨
---
## ğŸ“š ç›®å½•

1. [Logstash æ˜¯ä»€ä¹ˆ](#1-Logstash-æ˜¯ä»€ä¹ˆ)
2. [å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ](#2-å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ)
3. [å®‰è£…æ–¹å¼è¯¦è§£](#3-å®‰è£…æ–¹å¼è¯¦è§£)
4. [ç›®å½•ç»“æ„æ·±åº¦è§£æ](#4-ç›®å½•ç»“æ„æ·±åº¦è§£æ)
5. [å¯åŠ¨ä¸é…ç½®å®æˆ˜](#5-å¯åŠ¨ä¸é…ç½®å®æˆ˜)
6. [è¿›ç¨‹ç®¡ç†ä¸ç›‘æ§](#6-è¿›ç¨‹ç®¡ç†ä¸ç›‘æ§)
7. [æœåŠ¡åŒ–éƒ¨ç½²æŒ‡å—](#7-æœåŠ¡åŒ–éƒ¨ç½²æŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” Logstash æ˜¯ä»€ä¹ˆ


### 1.1 ç®€å•ç†è§£ Logstash


æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä¸€ä¸ªæ•°æ®æ¬è¿å·¥ï¼Œæ¯å¤©è¦æŠŠå„ç§å„æ ·çš„æ•°æ®ä»ä¸åŒçš„åœ°æ–¹æ¬åˆ°ä¸åŒçš„åœ°æ–¹ã€‚æœ‰çš„æ•°æ®æ¥è‡ªæ–‡ä»¶ï¼Œæœ‰çš„æ¥è‡ªæ•°æ®åº“ï¼Œæœ‰çš„æ¥è‡ªç½‘ç»œã€‚è€Œä¸”è¿™äº›æ•°æ®æ ¼å¼éƒ½ä¸ä¸€æ ·ï¼Œæœ‰çš„æ˜¯ JSONï¼Œæœ‰çš„æ˜¯çº¯æ–‡æœ¬ï¼Œæœ‰çš„æ˜¯ CSVã€‚

**Logstash å°±æ˜¯è¿™æ ·ä¸€ä¸ªè¶…çº§æ¬è¿å·¥**ï¼Œå®ƒèƒ½å¤Ÿï¼š

```
ğŸ“¥ æ”¶é›†æ•°æ® â†’ ğŸ”„ å¤„ç†è½¬æ¢ â†’ ğŸ“¤ è¾“å‡ºå­˜å‚¨
  (Input)      (Filter)      (Output)
```

### 1.2 æ ¸å¿ƒå·¥ä½œåŸç†


**ğŸ”¸ ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶**
```
è¾“å…¥æ’ä»¶ (Input)    â† ä»å„ç§æ•°æ®æºè¯»å–æ•°æ®
   â†“
è¿‡æ»¤æ’ä»¶ (Filter)   â† å¯¹æ•°æ®è¿›è¡Œå¤„ç†å’Œè½¬æ¢  
   â†“
è¾“å‡ºæ’ä»¶ (Output)   â† å°†å¤„ç†åçš„æ•°æ®å‘é€åˆ°ç›®æ ‡ä½ç½®
```

**ğŸ’¡ ç”Ÿæ´»åŒ–æ¯”å–»**
- **Input**ï¼šå°±åƒä½ çš„å˜´å·´ï¼Œè´Ÿè´£"åƒè¿›"å„ç§æ•°æ®
- **Filter**ï¼šå°±åƒä½ çš„èƒƒï¼Œè´Ÿè´£"æ¶ˆåŒ–"å’Œ"å¤„ç†"æ•°æ®
- **Output**ï¼šå°±åƒä½ çš„...ï¼Œè´Ÿè´£"è¾“å‡º"åˆ°éœ€è¦çš„åœ°æ–¹

### 1.3 åœ¨ ELK ç”Ÿæ€ä¸­çš„ä½ç½®


```
æ•°æ®æµå‘å›¾ï¼š
æ•°æ®æº â†’ Logstash â†’ Elasticsearch â†’ Kibana â†’ ç”¨æˆ·
  ğŸ“Š      ğŸ”„         ğŸ’¾           ğŸ“ˆ      ğŸ‘¨â€ğŸ’»
```

| ç»„ä»¶ | ä½œç”¨ | æ¯”å–» |
|------|------|------|
| **Logstash** | æ•°æ®æ”¶é›†å’Œå¤„ç† | ğŸšš æ•°æ®æ¬è¿å·¥ |
| **Elasticsearch** | æ•°æ®å­˜å‚¨å’Œæœç´¢ | ğŸª æ•°æ®ä»“åº“ |
| **Kibana** | æ•°æ®å¯è§†åŒ– | ğŸ“Š æ•°æ®å±•ç¤ºå° |

---

## 2. ğŸ“‹ å®‰è£…å‰çš„å‡†å¤‡å·¥ä½œ


### 2.1 ç³»ç»Ÿè¦æ±‚æ£€æŸ¥


**ğŸ” ç¡¬ä»¶è¦æ±‚**
```
æœ€ä½é…ç½®ï¼š
â”œâ”€ CPU: 2æ ¸å¿ƒ
â”œâ”€ å†…å­˜: 4GB RAM
â”œâ”€ ç£ç›˜: 20GB å¯ç”¨ç©ºé—´
â””â”€ ç½‘ç»œ: ç¨³å®šçš„ç½‘ç»œè¿æ¥

æ¨èé…ç½®ï¼š
â”œâ”€ CPU: 4æ ¸å¿ƒæˆ–æ›´å¤š
â”œâ”€ å†…å­˜: 8GB RAM æˆ–æ›´å¤š
â”œâ”€ ç£ç›˜: 100GB SSD
â””â”€ ç½‘ç»œ: é«˜é€Ÿç½‘ç»œè¿æ¥
```

### 2.2 Java ç¯å¢ƒä¾èµ–


> âš ï¸ **é‡è¦æé†’**
> 
> Logstash æ˜¯ç”¨ Java å¼€å‘çš„ï¼Œæ‰€ä»¥å¿…é¡»å…ˆå®‰è£… Javaï¼

**æ”¯æŒçš„ Java ç‰ˆæœ¬**
```
âœ… æ¨èç‰ˆæœ¬: OpenJDK 11 æˆ– Oracle JDK 11
âœ… æœ€ä½ç‰ˆæœ¬: Java 8
âŒ ä¸æ”¯æŒ: Java 7 åŠä»¥ä¸‹ç‰ˆæœ¬
```

**ğŸ”§ Java å®‰è£…æ£€æŸ¥**

åœ¨å‘½ä»¤è¡Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
java -version
```

**æœŸæœ›çš„è¾“å‡ºç¤ºä¾‹ï¼š**
```
java version "11.0.2" 2019-01-15 LTS
Java(TM) SE Runtime Environment 18.9 (build 11.0.2+9-LTS)
Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.2+9-LTS)
```

**ğŸ“ å¦‚æœæ²¡æœ‰å®‰è£… Java**

| æ“ä½œç³»ç»Ÿ | å®‰è£…å‘½ä»¤ |
|----------|----------|
| **Ubuntu/Debian** | `sudo apt update && sudo apt install openjdk-11-jdk` |
| **CentOS/RHEL** | `sudo yum install java-11-openjdk-devel` |
| **macOS** | `brew install openjdk@11` |
| **Windows** | ä¸‹è½½ JDK å®‰è£…åŒ…æ‰‹åŠ¨å®‰è£… |

### 2.3 ç½‘ç»œç¯å¢ƒå‡†å¤‡


**ğŸŒ ç½‘ç»œç«¯å£è§„åˆ’**

| ç«¯å£ | ç”¨é€” | æ˜¯å¦å¿…éœ€ |
|------|------|----------|
| `5044` | Beats è¾“å…¥ | å¸¸ç”¨ â­ |
| `9600` | HTTP API | ç®¡ç†æ¥å£ |
| `5000` | TCP è¾“å…¥ | å¯é€‰é…ç½® |

**é˜²ç«å¢™é…ç½®ç¤ºä¾‹**
```bash
# Ubuntu/Debian
sudo ufw allow 5044
sudo ufw allow 9600

# CentOS/RHEL  
sudo firewall-cmd --permanent --add-port=5044/tcp
sudo firewall-cmd --permanent --add-port=9600/tcp
sudo firewall-cmd --reload
```

---

## 3. ğŸ› ï¸ å®‰è£…æ–¹å¼è¯¦è§£


### 3.1 å®˜æ–¹åŒ…ç®¡ç†å™¨å®‰è£…ï¼ˆæ¨èï¼‰


**ä¸ºä»€ä¹ˆæ¨èè¿™ç§æ–¹å¼ï¼Ÿ**
- âœ… è‡ªåŠ¨å¤„ç†ä¾èµ–å…³ç³»
- âœ… ç³»ç»Ÿçº§æœåŠ¡é›†æˆ
- âœ… è‡ªåŠ¨æ›´æ–°æ”¯æŒ
- âœ… æ ‡å‡†åŒ–ç›®å½•ç»“æ„

#### ğŸ§ Linux ç³»ç»Ÿå®‰è£…


**Debian/Ubuntu ç³»ç»Ÿï¼š**

**æ­¥éª¤ 1ï¸âƒ£ï¼š** æ·»åŠ  Elastic å®˜æ–¹ä»“åº“
```bash
# ä¸‹è½½å¹¶å®‰è£… GPG å¯†é’¥
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -

# æ·»åŠ ä»“åº“æº
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list
```

**æ­¥éª¤ 2ï¸âƒ£ï¼š** æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
```bash
sudo apt update
sudo apt install logstash
```

**CentOS/RHEL ç³»ç»Ÿï¼š**

**æ­¥éª¤ 1ï¸âƒ£ï¼š** åˆ›å»ºä»“åº“é…ç½®æ–‡ä»¶
```bash
sudo tee /etc/yum.repos.d/elastic.repo << EOF
[elasticsearch]
name=Elasticsearch repository for 8.x packages
baseurl=https://artifacts.elastic.co/packages/8.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=0
autorefresh=1
type=rpm-md
EOF
```

**æ­¥éª¤ 2ï¸âƒ£ï¼š** å®‰è£… Logstash
```bash
sudo yum install --enablerepo=elasticsearch logstash
```

#### ğŸ macOS ç³»ç»Ÿå®‰è£…


ä½¿ç”¨ Homebrewï¼ˆæ¨èï¼‰ï¼š
```bash
# æ·»åŠ  Elastic tap
brew tap elastic/tap

# å®‰è£… Logstash
brew install elastic/tap/logstash-full
```

### 3.2 å‹ç¼©åŒ…å®‰è£…ï¼ˆé€‚åˆæµ‹è¯•ï¼‰


**é€‚ç”¨åœºæ™¯ï¼š**
- ğŸ§ª å¿«é€Ÿæµ‹è¯•å’Œä½“éªŒ
- ğŸ”§ è‡ªå®šä¹‰å®‰è£…ç›®å½•
- ğŸ“¦ ä¾¿æºå¼éƒ¨ç½²

**å®‰è£…æ­¥éª¤ï¼š**

**æ­¥éª¤ 1ï¸âƒ£ï¼š** ä¸‹è½½å‹ç¼©åŒ…
```bash
# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆæ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·ï¼‰
wget https://artifacts.elastic.co/downloads/logstash/logstash-8.15.0-linux-x86_64.tar.gz
```

**æ­¥éª¤ 2ï¸âƒ£ï¼š** è§£å‹å’Œé…ç½®
```bash
# è§£å‹åˆ°æŒ‡å®šç›®å½•
tar -xzf logstash-8.15.0-linux-x86_64.tar.gz

# ç§»åŠ¨åˆ°æ ‡å‡†ç›®å½•ï¼ˆå¯é€‰ï¼‰
sudo mv logstash-8.15.0 /opt/logstash

# åˆ›å»ºç¬¦å·é“¾æ¥æ–¹ä¾¿ä½¿ç”¨
sudo ln -s /opt/logstash/bin/logstash /usr/local/bin/logstash
```

### 3.3 Docker å®¹å™¨å®‰è£…ï¼ˆç°ä»£åŒ–éƒ¨ç½²ï¼‰


**é€‚ç”¨åœºæ™¯ï¼š**
- ğŸ³ å®¹å™¨åŒ–ç¯å¢ƒ
- â˜ï¸ äº‘åŸç”Ÿéƒ¨ç½²
- ğŸ”„ CI/CD é›†æˆ

**åŸºæœ¬ä½¿ç”¨ï¼š**
```bash
# æ‹‰å–å®˜æ–¹é•œåƒ
docker pull docker.elastic.co/logstash/logstash:8.15.0

# è¿è¡Œå®¹å™¨
docker run --rm -it \
  -v "$PWD/pipeline/":/usr/share/logstash/pipeline/ \
  -v "$PWD/config/":/usr/share/logstash/config/ \
  docker.elastic.co/logstash/logstash:8.15.0
```

**ğŸ¯ å®‰è£…æ–¹å¼é€‰æ‹©æŒ‡å—**

| åœºæ™¯ | æ¨èæ–¹å¼ | åŸå›  |
|------|----------|------|
| ç”Ÿäº§ç¯å¢ƒ | åŒ…ç®¡ç†å™¨ | ç¨³å®šã€æ˜“ç»´æŠ¤ |
| å¼€å‘æµ‹è¯• | å‹ç¼©åŒ… | çµæ´»ã€å¯ç§»æ¤ |
| å®¹å™¨ç¯å¢ƒ | Docker | äº‘åŸç”Ÿã€æ˜“æ‰©å±• |
| å­¦ä¹ ä½“éªŒ | å‹ç¼©åŒ… | ç®€å•ç›´æ¥ |

---

## 4. ğŸ“ ç›®å½•ç»“æ„æ·±åº¦è§£æ


### 4.1 æ ‡å‡†å®‰è£…ç›®å½•å¸ƒå±€


ç†è§£ç›®å½•ç»“æ„å¯¹äºåç»­é…ç½®å’Œç»´æŠ¤éå¸¸é‡è¦ï¼Œå°±åƒäº†è§£ä¸€åº§æˆ¿å­çš„æˆ¿é—´åˆ†å¸ƒä¸€æ ·ã€‚

```
logstash/
â”œâ”€â”€ ğŸ“ bin/              â† å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ğŸ”§ logstash      â† ä¸»ç¨‹åºå¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ ğŸ”§ logstash-plugin â† æ’ä»¶ç®¡ç†å·¥å…·
â”‚   â””â”€â”€ ğŸ”§ system-install â† ç³»ç»ŸæœåŠ¡å®‰è£…å·¥å…·
â”œâ”€â”€ ğŸ“ config/           â† é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ âš™ï¸ logstash.yml  â† ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ âš™ï¸ pipelines.yml â† ç®¡é“é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ âš™ï¸ jvm.options   â† JVM å‚æ•°é…ç½®
â”‚   â””â”€â”€ âš™ï¸ log4j2.properties â† æ—¥å¿—é…ç½®
â”œâ”€â”€ ğŸ“ data/             â† è¿è¡Œæ—¶æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“„ queue/        â† æŒä¹…åŒ–é˜Ÿåˆ—
â”‚   â””â”€â”€ ğŸ“„ dead_letter_queue/ â† æ­»ä¿¡é˜Ÿåˆ—
â”œâ”€â”€ ğŸ“ logs/             â† æ—¥å¿—æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ ğŸ“‹ logstash-plain.log â† æ™®é€šæ—¥å¿—
â”‚   â””â”€â”€ ğŸ“‹ logstash-slowlog-plain.log â† æ…¢æŸ¥è¯¢æ—¥å¿—
â”œâ”€â”€ ğŸ“ vendor/           â† ç¬¬ä¸‰æ–¹ä¾èµ–
â””â”€â”€ ğŸ“ lib/              â† æ ¸å¿ƒåº“æ–‡ä»¶
```

### 4.2 é‡è¦ç›®å½•è¯¦è§£


#### ğŸ”§ bin ç›®å½•ï¼šç¨‹åºå…¥å£


**ä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶ï¼š**

| æ–‡ä»¶å | ä½œç”¨ | ä½¿ç”¨é¢‘ç‡ |
|--------|------|----------|
| `logstash` | ä¸»å¯åŠ¨ç¨‹åº | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ |
| `logstash-plugin` | æ’ä»¶ç®¡ç† | ğŸŒŸğŸŒŸğŸŒŸ |
| `system-install` | ç³»ç»ŸæœåŠ¡å®‰è£… | ğŸŒŸğŸŒŸ |

**å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹ï¼š**
```bash
# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
./bin/logstash --version

# æµ‹è¯•é…ç½®æ–‡ä»¶
./bin/logstash -t -f /path/to/config.conf

# å¯åŠ¨ Logstash
./bin/logstash -f /path/to/config.conf
```

#### âš™ï¸ config ç›®å½•ï¼šé…ç½®ä¸­å¿ƒ


è¿™æ˜¯ Logstash çš„"å¤§è„‘"ï¼Œæ‰€æœ‰è¡Œä¸ºéƒ½ç”±è¿™é‡Œçš„é…ç½®æ–‡ä»¶æ§åˆ¶ã€‚

**ğŸ”¸ logstash.yml - ä¸»é…ç½®æ–‡ä»¶**

ä¸»è¦é…ç½®é¡¹è¯´æ˜ï¼š
```yaml
# èŠ‚ç‚¹åç§°ï¼ˆç”¨äºé›†ç¾¤ç¯å¢ƒè¯†åˆ«ï¼‰
node.name: "logstash-server-01"

# æ•°æ®ç›®å½•ä½ç½®
path.data: "/var/lib/logstash"

# ç®¡é“é…ç½®ç›®å½•
path.config: "/etc/logstash/conf.d"

# æ—¥å¿—æ–‡ä»¶ä½ç½®  
path.logs: "/var/log/logstash"

# HTTP API ç»‘å®šåœ°å€
http.host: "0.0.0.0"
http.port: 9600

# ç®¡é“è®¾ç½®
pipeline.workers: 4          # å·¥ä½œçº¿ç¨‹æ•°
pipeline.batch.size: 1000    # æ‰¹å¤„ç†å¤§å°
pipeline.batch.delay: 50     # æ‰¹å¤„ç†å»¶è¿Ÿ(æ¯«ç§’)
```

**ğŸ”¸ pipelines.yml - ç®¡é“é…ç½®**

ç”¨äºé…ç½®å¤šä¸ªæ•°æ®å¤„ç†ç®¡é“ï¼š
```yaml
# ç¬¬ä¸€ä¸ªç®¡é“ï¼šå¤„ç†åº”ç”¨æ—¥å¿—
- pipeline.id: "app-logs"
  path.config: "/etc/logstash/conf.d/app-logs.conf"
  pipeline.workers: 2

# ç¬¬äºŒä¸ªç®¡é“ï¼šå¤„ç†ç³»ç»Ÿæ—¥å¿—  
- pipeline.id: "system-logs"
  path.config: "/etc/logstash/conf.d/system-logs.conf"
  pipeline.workers: 1
```

**ğŸ”¸ jvm.options - Java è™šæ‹Ÿæœºé…ç½®**

å†…å­˜å’Œæ€§èƒ½è°ƒä¼˜çš„å…³é”®æ–‡ä»¶ï¼š
```
# å †å†…å­˜è®¾ç½®ï¼ˆæ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´ï¼‰
-Xms1g    # åˆå§‹å †å¤§å°
-Xmx1g    # æœ€å¤§å †å¤§å°

# åƒåœ¾å›æ”¶å™¨è®¾ç½®
-XX:+UseG1GC
-XX:+DisableExplicitGC

# æ€§èƒ½ç›‘æ§
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
```

> ğŸ’¡ **å†…å­˜é…ç½®å»ºè®®**
> 
> | æœåŠ¡å™¨å†…å­˜ | å»ºè®®å †å¤§å° | é…ç½®ç¤ºä¾‹ |
> |-----------|-----------|----------|
> | 4GB | 1-2GB | `-Xms1g -Xmx2g` |
> | 8GB | 2-4GB | `-Xms2g -Xmx4g` |
> | 16GB | 4-8GB | `-Xms4g -Xmx8g` |

#### ğŸ“„ data ç›®å½•ï¼šè¿è¡Œæ—¶æ•°æ®


**æŒä¹…åŒ–é˜Ÿåˆ— (Persistent Queue)**
- ä½œç”¨ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
- ä½ç½®ï¼š`data/queue/`
- åŸç†ï¼šå°†å¤„ç†ä¸­çš„æ•°æ®ä¸´æ—¶å­˜å‚¨åˆ°ç£ç›˜

**æ­»ä¿¡é˜Ÿåˆ— (Dead Letter Queue)**  
- ä½œç”¨ï¼šå­˜å‚¨å¤„ç†å¤±è´¥çš„æ•°æ®
- ä½ç½®ï¼š`data/dead_letter_queue/`
- ç”¨é€”ï¼šåç»­åˆ†æå’Œé‡æ–°å¤„ç†

#### ğŸ“‹ logs ç›®å½•ï¼šæ—¥å¿—æ–‡ä»¶


**æ—¥å¿—æ–‡ä»¶ç±»å‹ï¼š**

| æ—¥å¿—ç±»å‹ | æ–‡ä»¶å | å†…å®¹è¯´æ˜ |
|----------|--------|----------|
| æ™®é€šæ—¥å¿— | `logstash-plain.log` | å¯åŠ¨ã€è¿è¡Œã€é”™è¯¯ä¿¡æ¯ |
| æ…¢æŸ¥è¯¢æ—¥å¿— | `logstash-slowlog-plain.log` | å¤„ç†ç¼“æ…¢çš„äº‹ä»¶è®°å½• |
| GC æ—¥å¿— | `gc.log` | Java åƒåœ¾å›æ”¶ä¿¡æ¯ |

### 4.3 ä¸åŒå®‰è£…æ–¹å¼çš„ç›®å½•å·®å¼‚


**ğŸ“¦ åŒ…ç®¡ç†å™¨å®‰è£…çš„ç›®å½•åˆ†å¸ƒ**
```
ç³»ç»Ÿç›®å½•åˆ†å¸ƒï¼š
â”œâ”€â”€ /usr/share/logstash/     â† ç¨‹åºæ–‡ä»¶
â”œâ”€â”€ /etc/logstash/           â† é…ç½®æ–‡ä»¶  
â”œâ”€â”€ /var/lib/logstash/       â† æ•°æ®æ–‡ä»¶
â”œâ”€â”€ /var/log/logstash/       â† æ—¥å¿—æ–‡ä»¶
â””â”€â”€ /usr/bin/logstash        â† å¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥
```

**ğŸ“ å‹ç¼©åŒ…å®‰è£…çš„ç›®å½•ç»“æ„**
```
æ‰€æœ‰æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹ï¼š
/opt/logstash/
â”œâ”€â”€ bin/     â† å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ config/  â† é…ç½®æ–‡ä»¶
â”œâ”€â”€ data/    â† æ•°æ®æ–‡ä»¶
â”œâ”€â”€ logs/    â† æ—¥å¿—æ–‡ä»¶
â””â”€â”€ ...
```

---

## 5. ğŸš€ å¯åŠ¨ä¸é…ç½®å®æˆ˜


### 5.1 ç¬¬ä¸€æ¬¡å¯åŠ¨ Logstash


**ğŸ¯ ç›®æ ‡ï¼šæˆåŠŸå¯åŠ¨ Logstash å¹¶çœ‹åˆ°æ¬¢è¿ä¿¡æ¯**

#### ç®€å•å¯åŠ¨æµ‹è¯•


åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„é…ç½®æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼š

**æ­¥éª¤ 1ï¸âƒ£ï¼š** åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
```bash
# åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
sudo mkdir -p /etc/logstash/conf.d

# åˆ›å»ºæµ‹è¯•é…ç½®æ–‡ä»¶
sudo tee /etc/logstash/conf.d/test.conf << 'EOF'
input {
  stdin { }
}

output {
  stdout {
    codec => rubydebug
  }
}
EOF
```

**æ­¥éª¤ 2ï¸âƒ£ï¼š** å¯åŠ¨ Logstash
```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
sudo /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/test.conf
```

**æ­¥éª¤ 3ï¸âƒ£ï¼š** éªŒè¯å¯åŠ¨æˆåŠŸ

çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¿¡æ¯è¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š
```
[INFO ] [logstash.runner] Starting Logstash
[INFO ] [logstash.agent] Successfully started Logstash API endpoint
[INFO ] [logstash.pipeline] Pipeline started successfully
The stdin plugin is now waiting for input:
```

**æ­¥éª¤ 4ï¸âƒ£ï¼š** æµ‹è¯•æ•°æ®å¤„ç†

åœ¨å‘½ä»¤è¡Œè¾“å…¥ä¸€äº›æ–‡æœ¬ï¼š
```
Hello Logstash!
```

åº”è¯¥çœ‹åˆ°æ ¼å¼åŒ–çš„è¾“å‡ºï¼š
```json
{
    "@timestamp" => 2025-09-21T10:30:00.000Z,
      "@version" => "1",
       "message" => "Hello Logstash!",
          "host" => "your-hostname"
}
```

> ğŸ‰ **æ­å–œï¼**
> 
> å¦‚æœçœ‹åˆ°ä¸Šè¿°è¾“å‡ºï¼Œè¯´æ˜ Logstash å·²ç»æˆåŠŸè¿è¡Œï¼æŒ‰ <kbd>Ctrl</kbd> + <kbd>C</kbd> å¯ä»¥åœæ­¢ç¨‹åºã€‚

### 5.2 å¯åŠ¨å‚æ•°è¯¦è§£


Logstash æä¾›äº†ä¸°å¯Œçš„å¯åŠ¨å‚æ•°æ¥æ§åˆ¶å…¶è¡Œä¸ºï¼š

**ğŸ”¸ å¸¸ç”¨å¯åŠ¨å‚æ•°**

| å‚æ•° | é•¿æ ¼å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|--------|------|------|
| `-f` | `--path.config` | æŒ‡å®šé…ç½®æ–‡ä»¶ | `-f config.conf` |
| `-t` | `--config.test` | æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³• | `-t -f config.conf` |
| `-r` | `--config.reload.automatic` | è‡ªåŠ¨é‡è½½é…ç½® | `-r` |
| `-w` | `--pipeline.workers` | å·¥ä½œçº¿ç¨‹æ•° | `-w 4` |
| `-b` | `--pipeline.batch.size` | æ‰¹å¤„ç†å¤§å° | `-b 1000` |

**å®ç”¨å¯åŠ¨å‘½ä»¤ç»„åˆï¼š**

```bash
# 1. è¯­æ³•æ£€æŸ¥æ¨¡å¼
logstash -t -f /etc/logstash/conf.d/

# 2. å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½é…ç½®ï¼‰
logstash -f /etc/logstash/conf.d/ -r

# 3. è°ƒè¯•æ¨¡å¼ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
logstash -f /etc/logstash/conf.d/ --log.level debug

# 4. æ€§èƒ½è°ƒä¼˜æ¨¡å¼
logstash -f /etc/logstash/conf.d/ -w 8 -b 2000
```

### 5.3 é…ç½®æ–‡ä»¶è¯­æ³•åŸºç¡€


Logstash çš„é…ç½®æ–‡ä»¶ä½¿ç”¨ç±»ä¼¼ JSON çš„è¯­æ³•ï¼Œä½†æ›´åŠ çµæ´»ã€‚

**ğŸ”¸ åŸºæœ¬è¯­æ³•ç»“æ„**

```ruby
# è¾“å…¥éƒ¨åˆ†ï¼šå®šä¹‰æ•°æ®æ¥æº
input {
  æ’ä»¶åç§° {
    é…ç½®é€‰é¡¹ => å€¼
  }
}

# è¿‡æ»¤éƒ¨åˆ†ï¼šå®šä¹‰æ•°æ®å¤„ç†è§„åˆ™ï¼ˆå¯é€‰ï¼‰
filter {
  æ’ä»¶åç§° {
    é…ç½®é€‰é¡¹ => å€¼
  }
}

# è¾“å‡ºéƒ¨åˆ†ï¼šå®šä¹‰æ•°æ®è¾“å‡ºç›®æ ‡
output {
  æ’ä»¶åç§° {
    é…ç½®é€‰é¡¹ => å€¼
  }
}
```

**ğŸ”¸ æ•°æ®ç±»å‹è¯´æ˜**

| æ•°æ®ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| å­—ç¬¦ä¸² | `"hello"` æˆ– `'hello'` | æ–‡æœ¬æ•°æ® |
| æ•°å­— | `123` æˆ– `3.14` | æ•°å€¼æ•°æ® |
| å¸ƒå°”å€¼ | `true` æˆ– `false` | çœŸå‡å€¼ |
| æ•°ç»„ | `["a", "b", "c"]` | åˆ—è¡¨æ•°æ® |
| å“ˆå¸Œ | `{"key" => "value"}` | é”®å€¼å¯¹æ•°æ® |

**ğŸ”¸ å®é™…é…ç½®ç¤ºä¾‹**

```ruby
input {
  # ä»æ–‡ä»¶è¯»å–æ—¥å¿—
  file {
    path => "/var/log/apache2/access.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # è§£æ Apache è®¿é—®æ—¥å¿—
  grok {
    match => { 
      "message" => "%{COMBINEDAPACHELOG}" 
    }
  }
  
  # è½¬æ¢æ—¶é—´æ ¼å¼
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
}

output {
  # è¾“å‡ºåˆ° Elasticsearch
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "apache-logs-%{+YYYY.MM.dd}"
  }
  
  # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
  stdout {
    codec => rubydebug
  }
}
```

### 5.4 é…ç½®éªŒè¯ä¸è°ƒè¯•


**ğŸ” é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥**

åœ¨å¯åŠ¨å‰ï¼Œå…ˆæ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼š
```bash
# æ£€æŸ¥å•ä¸ªé…ç½®æ–‡ä»¶
logstash -t -f /path/to/config.conf

# æ£€æŸ¥é…ç½®ç›®å½•
logstash -t -f /etc/logstash/conf.d/
```

**æˆåŠŸçš„è¾“å‡ºç¤ºä¾‹ï¼š**
```
Configuration OK
```

**é”™è¯¯çš„è¾“å‡ºç¤ºä¾‹ï¼š**
```
[ERROR] Failed to read config file
[ERROR] Syntax error at line 15, column 20
```

**ğŸ› å¸¸è§é…ç½®é”™è¯¯**

| é”™è¯¯ç±»å‹ | å¸¸è§åŸå›  | è§£å†³æ–¹æ³• |
|----------|----------|----------|
| è¯­æ³•é”™è¯¯ | ç¼ºå°‘å¼•å·ã€æ‹¬å·ä¸åŒ¹é… | ä»”ç»†æ£€æŸ¥è¯­æ³• |
| æ’ä»¶ä¸å­˜åœ¨ | æ’ä»¶åæ‹¼å†™é”™è¯¯ | æ£€æŸ¥æ’ä»¶åç§° |
| é…ç½®é¡¹é”™è¯¯ | ä½¿ç”¨äº†ä¸å­˜åœ¨çš„é…ç½®é€‰é¡¹ | æŸ¥é˜…æ’ä»¶æ–‡æ¡£ |

---

## 6. ğŸ”„ è¿›ç¨‹ç®¡ç†ä¸ç›‘æ§


### 6.1 Logstash è¿›ç¨‹ç®¡ç†


**ğŸ”¸ è¿›ç¨‹çŠ¶æ€æŸ¥çœ‹**

```bash
# æŸ¥çœ‹ Logstash è¿›ç¨‹
ps aux | grep logstash

# æŸ¥çœ‹è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯
ps -ef | grep logstash

# ä½¿ç”¨ top ç›‘æ§èµ„æºä½¿ç”¨
top -p $(pgrep -f logstash)
```

**è¿›ç¨‹ä¿¡æ¯è§£è¯»ï¼š**
```
USER  PID  %CPU %MEM    VSZ   RSS TTY STAT START TIME COMMAND
logstash 1234 5.2 12.3 2048576 512000 ? Sl 10:30 0:05 java -jar logstash...
```

è§£é‡Šï¼š
- **PID**: è¿›ç¨‹ID
- **%CPU**: CPUä½¿ç”¨ç‡
- **%MEM**: å†…å­˜ä½¿ç”¨ç‡
- **VSZ**: è™šæ‹Ÿå†…å­˜å¤§å°
- **RSS**: ç‰©ç†å†…å­˜ä½¿ç”¨

**ğŸ”¸ è¿›ç¨‹æ§åˆ¶æ“ä½œ**

| æ“ä½œ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| å¯åŠ¨ | `systemctl start logstash` | å¯åŠ¨æœåŠ¡ |
| åœæ­¢ | `systemctl stop logstash` | åœæ­¢æœåŠ¡ |
| é‡å¯ | `systemctl restart logstash` | é‡å¯æœåŠ¡ |
| é‡è½½ | `systemctl reload logstash` | é‡è½½é…ç½® |
| çŠ¶æ€ | `systemctl status logstash` | æŸ¥çœ‹çŠ¶æ€ |

**ğŸ”¸ ä¼˜é›…åœæ­¢ Logstash**

Logstash æ”¯æŒä¼˜é›…åœæ­¢ï¼Œç¡®ä¿æ­£åœ¨å¤„ç†çš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼š

```bash
# å‘é€ TERM ä¿¡å·ï¼ˆæ¨èï¼‰
kill -TERM $(pgrep -f logstash)

# æˆ–è€…ä½¿ç”¨ systemctl
systemctl stop logstash
```

ä¼˜é›…åœæ­¢çš„è¿‡ç¨‹ï¼š
```
1. åœæ­¢æ¥æ”¶æ–°æ•°æ®
2. å¤„ç†å®Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ•°æ®  
3. ä¿å­˜çŠ¶æ€ä¿¡æ¯
4. å…³é—­æ‰€æœ‰è¿æ¥
5. é€€å‡ºè¿›ç¨‹
```

### 6.2 HTTP API ç›‘æ§


Logstash æä¾›äº† HTTP API ç”¨äºç›‘æ§å’Œç®¡ç†ã€‚

**ğŸ”¸ å¯ç”¨ HTTP API**

åœ¨ `logstash.yml` ä¸­é…ç½®ï¼š
```yaml
http.host: "0.0.0.0"
http.port: 9600
```

**ğŸ”¸ å¸¸ç”¨ API ç«¯ç‚¹**

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|------|
| `/_node` | GET | èŠ‚ç‚¹ä¿¡æ¯ | `curl localhost:9600/_node` |
| `/_node/stats` | GET | ç»Ÿè®¡ä¿¡æ¯ | `curl localhost:9600/_node/stats` |
| `/_node/hot_threads` | GET | çƒ­çº¿ç¨‹ä¿¡æ¯ | `curl localhost:9600/_node/hot_threads` |
| `/_node/plugins` | GET | æ’ä»¶åˆ—è¡¨ | `curl localhost:9600/_node/plugins` |

**ğŸ”¸ ç›‘æ§è„šæœ¬ç¤ºä¾‹**

åˆ›å»ºä¸€ä¸ªç®€å•çš„ç›‘æ§è„šæœ¬ï¼š

```bash
#!/bin/bash
# æ–‡ä»¶åï¼šmonitor_logstash.sh

API_URL="http://localhost:9600"

echo "=== Logstash ç›‘æ§ä¿¡æ¯ ==="
echo "æ—¶é—´ï¼š$(date)"
echo

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if curl -s "$API_URL" > /dev/null 2>&1; then
    echo "âœ… Logstash API å¯è®¿é—®"
else
    echo "âŒ Logstash API ä¸å¯è®¿é—®"
    exit 1
fi

# è·å–åŸºæœ¬ä¿¡æ¯
echo "ğŸ“Š åŸºæœ¬ä¿¡æ¯ï¼š"
curl -s "$API_URL/_node" | jq '.version, .name'

# è·å–ç»Ÿè®¡ä¿¡æ¯
echo "ğŸ“ˆ å¤„ç†ç»Ÿè®¡ï¼š"
curl -s "$API_URL/_node/stats" | jq '.events'

echo "ğŸ’¾ å†…å­˜ä½¿ç”¨ï¼š"
curl -s "$API_URL/_node/stats" | jq '.jvm.mem'
```

### 6.3 æ—¥å¿—ç›‘æ§ä¸åˆ†æ


**ğŸ”¸ æ—¥å¿—æ–‡ä»¶ä½ç½®**

æ ¹æ®å®‰è£…æ–¹å¼ï¼Œæ—¥å¿—æ–‡ä»¶ä½ç½®å¯èƒ½ä¸åŒï¼š

| å®‰è£…æ–¹å¼ | æ—¥å¿—ä½ç½® |
|----------|----------|
| åŒ…ç®¡ç†å™¨ | `/var/log/logstash/` |
| å‹ç¼©åŒ… | `å®‰è£…ç›®å½•/logs/` |
| Docker | å®¹å™¨å†… `/usr/share/logstash/logs/` |

**ğŸ”¸ é‡è¦æ—¥å¿—æ–‡ä»¶**

```
logs/
â”œâ”€â”€ ğŸ“‹ logstash-plain.log        â† ä¸»æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ ğŸ“‹ logstash-slowlog-plain.log â† æ…¢å¤„ç†æ—¥å¿—
â””â”€â”€ ğŸ“‹ gc.log                    â† GC æ—¥å¿—ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```

**ğŸ”¸ æ—¥å¿—çº§åˆ«é…ç½®**

åœ¨ `log4j2.properties` ä¸­é…ç½®ï¼š
```properties
# è®¾ç½®æ ¹æ—¥å¿—çº§åˆ«
logger.logstash.level = info

# è®¾ç½®ç‰¹å®šç»„ä»¶çš„æ—¥å¿—çº§åˆ«
logger.slowlog.level = trace
logger.licensereader.level = error

# è¾“å‡ºåˆ°æ–‡ä»¶
appender.rolling.type = RollingFile
appender.rolling.name = plain_rolling
appender.rolling.fileName = ${sys:ls.logs}/logstash-${sys:ls.log.format}.log
```

**ğŸ”¸ å®æ—¶æ—¥å¿—ç›‘æ§**

```bash
# å®æ—¶æŸ¥çœ‹ä¸»æ—¥å¿—
tail -f /var/log/logstash/logstash-plain.log

# è¿‡æ»¤é”™è¯¯ä¿¡æ¯
tail -f /var/log/logstash/logstash-plain.log | grep ERROR

# ä½¿ç”¨ journalctl æŸ¥çœ‹ç³»ç»ŸæœåŠ¡æ—¥å¿—
journalctl -u logstash -f
```

**ğŸ”¸ æ—¥å¿—åˆ†ææŠ€å·§**

å¸¸è§çš„æ—¥å¿—æ¨¡å¼ï¼š

```bash
# æŸ¥çœ‹å¯åŠ¨ä¿¡æ¯
grep "Starting Logstash" /var/log/logstash/logstash-plain.log

# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
grep "ERROR" /var/log/logstash/logstash-plain.log

# æŸ¥çœ‹ç®¡é“çŠ¶æ€
grep "Pipeline" /var/log/logstash/logstash-plain.log

# ç»Ÿè®¡å¤„ç†äº‹ä»¶æ•°é‡
grep "events filtered" /var/log/logstash/logstash-plain.log
```

---

## 7. âš™ï¸ æœåŠ¡åŒ–éƒ¨ç½²æŒ‡å—


### 7.1 systemd æœåŠ¡é…ç½®


å°† Logstash é…ç½®ä¸ºç³»ç»ŸæœåŠ¡ï¼Œå¯ä»¥å®ç°å¼€æœºè‡ªå¯åŠ¨å’Œæ›´å¥½çš„è¿›ç¨‹ç®¡ç†ã€‚

**ğŸ”¸ åˆ›å»ºç³»ç»ŸæœåŠ¡**

å¦‚æœä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œç³»ç»ŸæœåŠ¡ä¼šè‡ªåŠ¨åˆ›å»ºã€‚å¦‚æœæ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œéœ€è¦è‡ªå·±åˆ›å»ºï¼š

```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/logstash.service << 'EOF'
[Unit]
Description=Logstash
Documentation=https://www.elastic.co/guide/en/logstash/current/index.html
Wants=network-online.target
After=network-online.target
ConditionPathExists=/etc/logstash/logstash.yml

[Service]
Type=exec
User=logstash
Group=logstash
# å¯åŠ¨å‘½ä»¤
ExecStart=/usr/share/logstash/bin/logstash "--path.settings" "/etc/logstash"
# ä¼˜é›…åœæ­¢
KillMode=process
KillSignal=SIGTERM
SendSIGKILL=no
SuccessExitStatus=143
TimeoutStopSec=300
Restart=always
RestartSec=2
LimitNOFILE=16384
LimitNPROC=8192
LimitAS=infinity
LimitFSIZE=infinity
LimitMEMLOCK=infinity

[Install]
WantedBy=multi-user.target
EOF
```

**ğŸ”¸ æœåŠ¡ç®¡ç†æ“ä½œ**

```bash
# é‡è½½ systemd é…ç½®
sudo systemctl daemon-reload

# å¯ç”¨å¼€æœºè‡ªå¯åŠ¨
sudo systemctl enable logstash

# å¯åŠ¨æœåŠ¡
sudo systemctl start logstash

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status logstash

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u logstash -f
```

### 7.2 ç”¨æˆ·å’Œæƒé™é…ç½®


**ğŸ”¸ åˆ›å»ºä¸“ç”¨ç”¨æˆ·**

ä¸ºå®‰å…¨è€ƒè™‘ï¼Œå»ºè®®ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡Œ Logstashï¼š

```bash
# åˆ›å»º logstash ç”¨æˆ·å’Œç»„
sudo groupadd logstash
sudo useradd -r -g logstash -d /usr/share/logstash -s /bin/false logstash

# è®¾ç½®ç›®å½•æƒé™
sudo chown -R logstash:logstash /etc/logstash
sudo chown -R logstash:logstash /var/lib/logstash  
sudo chown -R logstash:logstash /var/log/logstash
sudo chmod 750 /etc/logstash
sudo chmod 755 /var/lib/logstash
sudo chmod 755 /var/log/logstash
```

**ğŸ”¸ æ–‡ä»¶æƒé™æœ€ä½³å®è·µ**

| ç›®å½•/æ–‡ä»¶ | æ‰€æœ‰è€… | æƒé™ | è¯´æ˜ |
|-----------|--------|------|------|
| `/etc/logstash/` | `logstash:logstash` | `750` | é…ç½®ç›®å½• |
| `/etc/logstash/logstash.yml` | `logstash:logstash` | `644` | ä¸»é…ç½®æ–‡ä»¶ |
| `/var/lib/logstash/` | `logstash:logstash` | `755` | æ•°æ®ç›®å½• |
| `/var/log/logstash/` | `logstash:logstash` | `755` | æ—¥å¿—ç›®å½• |

### 7.3 ç¯å¢ƒå˜é‡é…ç½®


**ğŸ”¸ è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡**

åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š
```bash
sudo tee /etc/default/logstash << 'EOF'
# JVM é…ç½®
LS_HEAP_SIZE="1g"
LS_JAVA_OPTS=""

# Logstash é…ç½®
LS_SETTINGS_DIR="/etc/logstash"
LS_OPTS="--config.reload.automatic"

# ç”¨æˆ·è®¾ç½®
LS_USER="logstash"
LS_GROUP="logstash"
EOF
```

**ğŸ”¸ åœ¨ systemd æœåŠ¡ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡**

ä¿®æ”¹æœåŠ¡æ–‡ä»¶ï¼š
```ini
[Service]
# åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶
EnvironmentFile=/etc/default/logstash

# ä½¿ç”¨ç¯å¢ƒå˜é‡
ExecStart=/usr/share/logstash/bin/logstash $LS_OPTS
User=${LS_USER}
Group=${LS_GROUP}
```

### 7.4 å¤šå®ä¾‹éƒ¨ç½²


å¯¹äºé«˜è´Ÿè½½åœºæ™¯ï¼Œå¯èƒ½éœ€è¦è¿è¡Œå¤šä¸ª Logstash å®ä¾‹ã€‚

**ğŸ”¸ å¤šå®ä¾‹é…ç½®ç­–ç•¥**

```
éƒ¨ç½²æ¶æ„ï¼š
è´Ÿè½½å‡è¡¡å™¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logstash å®ä¾‹1  â”‚  Logstash å®ä¾‹2  â”‚
â”‚  ç«¯å£ï¼š5044     â”‚  ç«¯å£ï¼š5045     â”‚
â”‚  é…ç½®ï¼šapp-logs  â”‚  é…ç½®ï¼šsys-logs  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Elasticsearch é›†ç¾¤
```

**å®ä¾‹1é…ç½®æ–‡ä»¶** (`/etc/logstash/instance1/logstash.yml`):
```yaml
node.name: "logstash-instance-1"
http.port: 9600
path.config: "/etc/logstash/instance1/conf.d"
path.data: "/var/lib/logstash/instance1"
path.logs: "/var/log/logstash/instance1"
```

**å®ä¾‹2é…ç½®æ–‡ä»¶** (`/etc/logstash/instance2/logstash.yml`):
```yaml
node.name: "logstash-instance-2"  
http.port: 9601
path.config: "/etc/logstash/instance2/conf.d"
path.data: "/var/lib/logstash/instance2"
path.logs: "/var/log/logstash/instance2"
```

**åˆ›å»ºå¤šä¸ªç³»ç»ŸæœåŠ¡ï¼š**
```bash
# å¤åˆ¶æœåŠ¡æ–‡ä»¶
sudo cp /etc/systemd/system/logstash.service /etc/systemd/system/logstash@.service

# ä¿®æ”¹ä¸ºæ¨¡æ¿æœåŠ¡
sudo sed -i 's|/etc/logstash|/etc/logstash/%i|g' /etc/systemd/system/logstash@.service

# å¯åŠ¨ä¸åŒå®ä¾‹
sudo systemctl start logstash@instance1
sudo systemctl start logstash@instance2
```

### 7.5 å®¹å™¨åŒ–éƒ¨ç½²


**ğŸ”¸ Docker Compose éƒ¨ç½²**

åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š
```yaml
version: '3.8'

services:
  logstash:
    image: docker.elastic.co/logstash/logstash:8.15.0
    container_name: logstash
    environment:
      - "LS_JAVA_OPTS=-Xmx1g -Xms1g"
    ports:
      - "5044:5044"
      - "9600:9600"
    volumes:
      - ./config:/usr/share/logstash/pipeline:ro
      - ./settings/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
      - logstash_data:/usr/share/logstash/data
    networks:
      - elk_network
    depends_on:
      - elasticsearch

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.15.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - elk_network

volumes:
  logstash_data:
  elasticsearch_data:

networks:
  elk_network:
    driver: bridge
```

**ğŸ”¸ å¯åŠ¨å®¹å™¨åŒ–ç¯å¢ƒ**

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f logstash

# åœæ­¢æœåŠ¡
docker-compose down
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ Logstash ä¸‰å¤§ç»„ä»¶ï¼šInput â†’ Filter â†’ Output
ğŸ”¸ Java ç¯å¢ƒä¾èµ–ï¼šå¿…é¡»å®‰è£… Java 8+ 
ğŸ”¸ é…ç½®æ–‡ä»¶è¯­æ³•ï¼šç±» JSON æ ¼å¼ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹
ğŸ”¸ ç›®å½•ç»“æ„ï¼šbinã€configã€dataã€logs å››å¤§æ ¸å¿ƒç›®å½•
ğŸ”¸ è¿›ç¨‹ç®¡ç†ï¼šsystemd æœåŠ¡åŒ–éƒ¨ç½²æ˜¯æœ€ä½³å®è·µ
```

### 8.2 å®‰è£…éƒ¨ç½²æœ€ä½³å®è·µ


**ğŸ”¹ å®‰è£…æ–¹å¼é€‰æ‹©**
```
ç”Ÿäº§ç¯å¢ƒ â†’ åŒ…ç®¡ç†å™¨å®‰è£…ï¼ˆç¨³å®šå¯é ï¼‰
æµ‹è¯•ç¯å¢ƒ â†’ å‹ç¼©åŒ…å®‰è£…ï¼ˆå¿«é€Ÿçµæ´»ï¼‰
å®¹å™¨ç¯å¢ƒ â†’ Docker éƒ¨ç½²ï¼ˆäº‘åŸç”Ÿï¼‰
å­¦ä¹ ç¯å¢ƒ â†’ ä»»æ„æ–¹å¼ï¼ˆç®€å•æ˜“ç”¨ï¼‰
```

**ğŸ”¹ å®‰å…¨é…ç½®è¦ç‚¹**
```
âœ… ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡Œ Logstash
âœ… æ­£ç¡®è®¾ç½®æ–‡ä»¶å’Œç›®å½•æƒé™
âœ… é…ç½®é˜²ç«å¢™è§„åˆ™
âœ… å¯ç”¨æ—¥å¿—ç›‘æ§
âœ… å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
å†…å­˜é…ç½®ï¼šæ ¹æ®æœåŠ¡å™¨å†…å­˜åˆç†è®¾ç½® JVM å †å¤§å°
å·¥ä½œçº¿ç¨‹ï¼špipeline.workers = CPU æ ¸å¿ƒæ•°
æ‰¹å¤„ç†ï¼šé€‚å½“è°ƒæ•´ batch.size å’Œ batch.delay
ç£ç›˜ I/Oï¼šä½¿ç”¨ SSD æå‡æ€§èƒ½
ç½‘ç»œä¼˜åŒ–ï¼šç¡®ä¿ç¨³å®šçš„ç½‘ç»œè¿æ¥
```

### 8.3 å¸¸è§é—®é¢˜è§£å†³


**ğŸ› å¯åŠ¨å¤±è´¥æ’æŸ¥**
```
1. æ£€æŸ¥ Java ç¯å¢ƒï¼šjava -version
2. éªŒè¯é…ç½®è¯­æ³•ï¼šlogstash -t -f config.conf  
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼štail -f /var/log/logstash/logstash-plain.log
4. æ£€æŸ¥ç«¯å£å†²çªï¼šnetstat -tlnp | grep 9600
5. éªŒè¯æƒé™è®¾ç½®ï¼šls -la /etc/logstash/
```

**âš¡ æ€§èƒ½é—®é¢˜è¯Šæ–­**
```
CPU ä½¿ç”¨ç‡é«˜ï¼š
â†’ å‡å°‘ filter å¤æ‚åº¦
â†’ è°ƒæ•´å·¥ä½œçº¿ç¨‹æ•°
â†’ ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼

å†…å­˜ä½¿ç”¨ç‡é«˜ï¼š
â†’ è°ƒæ•´ JVM å †å¤§å°
â†’ æ£€æŸ¥å†…å­˜æ³„æ¼
â†’ ä¼˜åŒ–æ‰¹å¤„ç†å‚æ•°

å¤„ç†å»¶è¿Ÿé«˜ï¼š
â†’ å¢åŠ å·¥ä½œçº¿ç¨‹
â†’ è°ƒæ•´æ‰¹å¤„ç†å¤§å°
â†’ æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
```

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š æ–°æ‰‹å­¦ä¹ é¡ºåº**
```
ç¬¬1æ­¥ï¼šç†è§£ Logstash åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
ç¬¬2æ­¥ï¼šå®ŒæˆåŸºç¡€å®‰è£…å’Œå¯åŠ¨æµ‹è¯•  
ç¬¬3æ­¥ï¼šå­¦ä¹ é…ç½®æ–‡ä»¶è¯­æ³•å’Œå¸¸ç”¨æ’ä»¶
ç¬¬4æ­¥ï¼šå®è·µæ•°æ®æ”¶é›†å’Œå¤„ç†åœºæ™¯
ç¬¬5æ­¥ï¼šæŒæ¡ç›‘æ§ã€è°ƒä¼˜å’Œæ•…éšœæ’é™¤
ç¬¬6æ­¥ï¼šå­¦ä¹ é«˜çº§ç‰¹æ€§å’Œé›†ç¾¤éƒ¨ç½²
```

**ğŸ¯ å®è·µç»ƒä¹ å»ºè®®**
```
ç»ƒä¹ 1ï¼šé…ç½®æ–‡ä»¶æ—¥å¿—æ”¶é›†
ç»ƒä¹ 2ï¼šç³»ç»Ÿæ—¥å¿—è§£æå’Œæ ¼å¼åŒ–
ç»ƒä¹ 3ï¼šå¤šæ•°æ®æºæ•´åˆå¤„ç†
ç»ƒä¹ 4ï¼šé”™è¯¯å¤„ç†å’Œæ­»ä¿¡é˜Ÿåˆ—
ç»ƒä¹ 5ï¼šæ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
ç»ƒä¹ 6ï¼šé«˜å¯ç”¨é›†ç¾¤æ­å»º
```

### 8.5 æ‰©å±•å­¦ä¹ èµ„æº


**ğŸ“– å®˜æ–¹æ–‡æ¡£**
- Logstash å®˜æ–¹æŒ‡å—ï¼šhttps://www.elastic.co/guide/en/logstash/
- æ’ä»¶æ–‡æ¡£ï¼šhttps://www.elastic.co/guide/en/logstash/plugins/
- æœ€ä½³å®è·µï¼šhttps://www.elastic.co/blog/logstash-best-practices

**ğŸ› ï¸ å®ç”¨å·¥å…·**
- Grok è°ƒè¯•å™¨ï¼šhttps://grokdebug.herokuapp.com/
- é…ç½®éªŒè¯å·¥å…·ï¼šLogstash å†…ç½® `-t` å‚æ•°
- æ€§èƒ½ç›‘æ§ï¼šElasticsearch ç›‘æ§æ’ä»¶

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å®‰è£…ç®€å•é…ç½®æ´»ï¼Œä¸‰å¤§ç»„ä»¶è¦è®°ç‰¢
Input Filter Outputï¼Œæ•°æ®æµè½¬ä¸ä¼šä¹±
Javaç¯å¢ƒæ˜¯åŸºç¡€ï¼Œç›®å½•ç»“æ„è¦ç†æ¸…
æœåŠ¡åŒ–éƒ¨ç½²æœ€ç¨³å¦¥ï¼Œç›‘æ§æ—¥å¿—ä¸èƒ½å°‘
```

> ğŸ‰ **æ­å–œå®Œæˆå­¦ä¹ ï¼**
> 
> ç°åœ¨ä½ å·²ç»æŒæ¡äº† Logstash çš„å®‰è£…ä¸å¯åŠ¨ï¼æ¥ä¸‹æ¥å¯ä»¥ç»§ç»­å­¦ä¹ å…·ä½“çš„é…ç½®è¯­æ³•å’Œæ’ä»¶ä½¿ç”¨ã€‚è®°ä½ï¼Œå®è·µæ˜¯æœ€å¥½çš„è€å¸ˆï¼Œå¤šåŠ¨æ‰‹æ“ä½œæ‰èƒ½çœŸæ­£æŒæ¡è¿™ä¸ªå¼ºå¤§çš„æ•°æ®å¤„ç†å·¥å…·ï¼