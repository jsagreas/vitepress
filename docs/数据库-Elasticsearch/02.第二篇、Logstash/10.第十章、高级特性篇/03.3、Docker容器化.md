---
title: 3ã€Dockerå®¹å™¨åŒ–
---
## ðŸ“š ç›®å½•

1. [Dockerå®¹å™¨åŒ–åŸºç¡€æ¦‚å¿µ](#1-Dockerå®¹å™¨åŒ–åŸºç¡€æ¦‚å¿µ)
2. [Logstash Dockeré•œåƒæž„å»º](#2-Logstash-Dockeré•œåƒæž„å»º)
3. [å®¹å™¨é…ç½®ç®¡ç†ç­–ç•¥](#3-å®¹å™¨é…ç½®ç®¡ç†ç­–ç•¥)
4. [Kubernetesé›†ç¾¤éƒ¨ç½²](#4-Kubernetesé›†ç¾¤éƒ¨ç½²)
5. [å®¹å™¨ç›‘æŽ§ä¸Žæ—¥å¿—ç®¡ç†](#5-å®¹å™¨ç›‘æŽ§ä¸Žæ—¥å¿—ç®¡ç†)
6. [å®¹å™¨æ‰©ç¼©å®¹å®žè·µ](#6-å®¹å™¨æ‰©ç¼©å®¹å®žè·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ³ Dockerå®¹å™¨åŒ–åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Dockerå®¹å™¨åŒ–


**ðŸ”¸ ç®€å•ç†è§£Docker**
```
ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š
æœåŠ¡å™¨ â†’ å®‰è£…æ“ä½œç³»ç»Ÿ â†’ å®‰è£…Java â†’ å®‰è£…Logstash â†’ é…ç½®çŽ¯å¢ƒ

Dockerå®¹å™¨åŒ–æ–¹å¼ï¼š
æœåŠ¡å™¨ â†’ å®‰è£…Docker â†’ è¿è¡ŒLogstashå®¹å™¨
```

**ðŸ’¡ Dockerçš„æ ¸å¿ƒä¼˜åŠ¿**
- **çŽ¯å¢ƒä¸€è‡´æ€§**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§çŽ¯å¢ƒå®Œå…¨ç›¸åŒ
- **å¿«é€Ÿéƒ¨ç½²**ï¼šå‡ ç§’é’Ÿå¯åŠ¨ä¸€ä¸ªLogstashå®žä¾‹
- **èµ„æºéš”ç¦»**ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
- **ç‰ˆæœ¬ç®¡ç†**ï¼šè½»æ¾åˆ‡æ¢ä¸åŒç‰ˆæœ¬çš„Logstash

### 1.2 ä¸ºä»€ä¹ˆè¦å®¹å™¨åŒ–Logstash


**ðŸŽ¯ è§£å†³çš„å®žé™…é—®é¢˜**

| ä¼ ç»Ÿéƒ¨ç½²ç—›ç‚¹ | Dockerå®¹å™¨åŒ–è§£å†³æ–¹æ¡ˆ |
|-------------|-------------------|
| **çŽ¯å¢ƒä¾èµ–å¤æ‚** | `æ‰“åŒ…æ‰€æœ‰ä¾èµ–åˆ°é•œåƒä¸­` |
| **ç‰ˆæœ¬å‡çº§å›°éš¾** | `æ‹‰å–æ–°é•œåƒå³å¯å‡çº§` |
| **æ‰©å®¹è´¹æ—¶è´¹åŠ›** | `å‡ ç§’é’Ÿå¯åŠ¨æ–°å®¹å™¨` |
| **é…ç½®ç®¡ç†æ··ä¹±** | `ç»Ÿä¸€çš„é…ç½®ç®¡ç†æœºåˆ¶` |
| **èµ„æºåˆ©ç”¨çŽ‡ä½Ž** | `å®¹å™¨è½»é‡çº§ï¼Œèµ„æºå…±äº«` |

### 1.3 Logstashå®¹å™¨åŒ–æž¶æž„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¿ä¸»æœºæœåŠ¡å™¨                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Logstashå®¹å™¨1   â”‚   Logstashå®¹å™¨2   â”‚    Logstashå®¹å™¨3     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é…ç½®æ–‡ä»¶     â”‚ â”‚  â”‚ é…ç½®æ–‡ä»¶     â”‚ â”‚   â”‚ é…ç½®æ–‡ä»¶     â”‚  â”‚
â”‚  â”‚ æ’ä»¶       â”‚ â”‚  â”‚ æ’ä»¶       â”‚ â”‚   â”‚ æ’ä»¶       â”‚  â”‚
â”‚  â”‚ æ—¥å¿—æ•°æ®     â”‚ â”‚  â”‚ æ—¥å¿—æ•°æ®     â”‚ â”‚   â”‚ æ—¥å¿—æ•°æ®     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Dockerå¼•æ“Ž                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  å®¿ä¸»æœºæ“ä½œç³»ç»Ÿ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ðŸ”§ Logstash Dockeré•œåƒæž„å»º


### 2.1 å®˜æ–¹é•œåƒçš„ä½¿ç”¨


**ðŸƒâ€â™‚ï¸ å¿«é€Ÿå¯åŠ¨å®˜æ–¹é•œåƒ**

```bash
# æ‹‰å–å®˜æ–¹Logstashé•œåƒ
docker pull docker.elastic.co/logstash/logstash:8.10.0

# ç®€å•å¯åŠ¨å®¹å™¨
docker run -d \
  --name my-logstash \
  -p 5044:5044 \
  docker.elastic.co/logstash/logstash:8.10.0
```

**ðŸ“ æŒ‚è½½é…ç½®æ–‡ä»¶å¯åŠ¨**

```bash
# åˆ›å»ºæœ¬åœ°é…ç½®ç›®å½•
mkdir -p /opt/logstash/{config,pipeline}

# å¯åŠ¨å®¹å™¨å¹¶æŒ‚è½½é…ç½®
docker run -d \
  --name logstash-with-config \
  -p 5044:5044 \
  -v /opt/logstash/config:/usr/share/logstash/config \
  -v /opt/logstash/pipeline:/usr/share/logstash/pipeline \
  docker.elastic.co/logstash/logstash:8.10.0
```

### 2.2 è‡ªå®šä¹‰Dockeré•œåƒæž„å»º


**ðŸ› ï¸ åˆ›å»ºè‡ªå®šä¹‰Dockerfile**

```dockerfile
# åŸºäºŽå®˜æ–¹é•œåƒ
FROM docker.elastic.co/logstash/logstash:8.10.0

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /usr/share/logstash

# å®‰è£…å¸¸ç”¨æ’ä»¶
RUN bin/logstash-plugin install logstash-input-jdbc
RUN bin/logstash-plugin install logstash-filter-translate

# å¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
COPY pipeline/ /usr/share/logstash/pipeline/
COPY config/ /usr/share/logstash/config/

# å¤åˆ¶è‡ªå®šä¹‰è„šæœ¬
COPY scripts/entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

# è®¾ç½®çŽ¯å¢ƒå˜é‡
ENV LS_JAVA_OPTS="-Xms512m -Xmx512m"

# æš´éœ²ç«¯å£
EXPOSE 5044 9600

# è®¾ç½®å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
```

**ðŸ” è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬**

```bash
#!/bin/bash
# entrypoint.sh - è‡ªå®šä¹‰å¯åŠ¨è„šæœ¬

echo "=== Logstashå®¹å™¨å¯åŠ¨ ==="

# æ£€æŸ¥Elasticsearchè¿žæŽ¥
echo "æ£€æŸ¥Elasticsearchè¿žæŽ¥..."
until curl -s "http://${ES_HOST:-elasticsearch:9200}/_cluster/health" >/dev/null; do
  echo "ç­‰å¾…Elasticsearchå¯åŠ¨..."
  sleep 5
done

echo "Elasticsearchè¿žæŽ¥æˆåŠŸï¼"

# å¯åŠ¨Logstash
echo "å¯åŠ¨Logstash..."
exec /usr/local/bin/docker-entrypoint "$@"
```

### 2.3 é•œåƒæž„å»ºä¸Žä¼˜åŒ–


**ðŸ—ï¸ æž„å»ºé•œåƒå‘½ä»¤**

```bash
# æž„å»ºè‡ªå®šä¹‰é•œåƒ
docker build -t my-logstash:1.0 .

# æŸ¥çœ‹é•œåƒå¤§å°
docker images | grep my-logstash

# è¿è¡Œè‡ªå®šä¹‰é•œåƒ
docker run -d \
  --name custom-logstash \
  -p 5044:5044 \
  -e ES_HOST=elasticsearch \
  my-logstash:1.0
```

**âš¡ é•œåƒä¼˜åŒ–æŠ€å·§**

| ä¼˜åŒ–ç­–ç•¥ | å…·ä½“åšæ³• | æ•ˆæžœ |
|---------|---------|------|
| **å¤šé˜¶æ®µæž„å»º** | `ä½¿ç”¨Builderæ¨¡å¼` | `å‡å°é•œåƒä½“ç§¯50%+` |
| **å±‚ç¼“å­˜åˆ©ç”¨** | `åˆç†å®‰æŽ’COPYé¡ºåº` | `åŠ å¿«æž„å»ºé€Ÿåº¦` |
| **æ¸…ç†ä¸´æ—¶æ–‡ä»¶** | `RUNåŽåˆ é™¤ç¼“å­˜` | `å‡å°é•œåƒä½“ç§¯` |
| **åŸºç¡€é•œåƒé€‰æ‹©** | `ä½¿ç”¨Alpineç‰ˆæœ¬` | `é•œåƒæ›´è½»é‡` |

---

## 3. ðŸ“Š å®¹å™¨é…ç½®ç®¡ç†ç­–ç•¥


### 3.1 é…ç½®æ–‡ä»¶å¤–éƒ¨åŒ–


**ðŸ’¼ ä¸ºä»€ä¹ˆè¦å¤–éƒ¨åŒ–é…ç½®**

```
é—®é¢˜ï¼šé…ç½®å†™æ­»åœ¨é•œåƒé‡Œ
- ä¿®æ”¹é…ç½®éœ€è¦é‡æ–°æž„å»ºé•œåƒ
- ä¸åŒçŽ¯å¢ƒæ— æ³•ä½¿ç”¨åŒä¸€é•œåƒ
- é…ç½®ç‰ˆæœ¬ç®¡ç†å›°éš¾

è§£å†³ï¼šé…ç½®æ–‡ä»¶å¤–éƒ¨åŒ–
- é…ç½®ä¸Žé•œåƒåˆ†ç¦»
- åŒä¸€é•œåƒé€‚ç”¨å¤šçŽ¯å¢ƒ
- é…ç½®å¯ç‹¬ç«‹ç‰ˆæœ¬ç®¡ç†
```

**ðŸ“ ç›®å½•ç»“æž„è§„åˆ’**

```
logstash-docker/
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ logstash.yml           # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ jvm.options            # JVMå‚æ•°é…ç½®
â”‚   â””â”€â”€ log4j2.properties      # æ—¥å¿—é…ç½®
â”œâ”€â”€ pipeline/                  # ç®¡é“é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ input.conf             # è¾“å…¥é…ç½®
â”‚   â”œâ”€â”€ filter.conf            # è¿‡æ»¤é…ç½®
â”‚   â””â”€â”€ output.conf            # è¾“å‡ºé…ç½®
â”œâ”€â”€ data/                      # æ•°æ®ç›®å½•
â”œâ”€â”€ logs/                      # æ—¥å¿—ç›®å½•
â””â”€â”€ docker-compose.yml         # ç¼–æŽ’æ–‡ä»¶
```

### 3.2 Docker Composeé…ç½®ç®¡ç†


**ðŸš€ å®Œæ•´çš„docker-compose.yml**

```yaml
version: '3.8'

services:
  logstash:
    image: docker.elastic.co/logstash/logstash:8.10.0
    container_name: logstash-server
    
    # çŽ¯å¢ƒå˜é‡é…ç½®
    environment:
      - LS_JAVA_OPTS=-Xms512m -Xmx1g
      - PIPELINE_WORKERS=2
      - PIPELINE_BATCH_SIZE=125
      - ES_HOST=elasticsearch:9200
    
    # ç«¯å£æ˜ å°„
    ports:
      - "5044:5044"    # Beatsè¾“å…¥
      - "9600:9600"    # HTTP API
      - "5000:5000"    # TCPè¾“å…¥
    
    # ç›®å½•æŒ‚è½½
    volumes:
      - ./config:/usr/share/logstash/config:ro
      - ./pipeline:/usr/share/logstash/pipeline:ro
      - ./data:/usr/share/logstash/data
      - ./logs:/usr/share/logstash/logs
    
    # ç½‘ç»œé…ç½®
    networks:
      - elk-network
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9600"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # é‡å¯ç­–ç•¥
    restart: unless-stopped
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

networks:
  elk-network:
    driver: bridge
```

### 3.3 çŽ¯å¢ƒå˜é‡ç®¡ç†


**ðŸ”§ çŽ¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶(.env)**

```bash
# .envæ–‡ä»¶ - çŽ¯å¢ƒå˜é‡é…ç½®

# Logstashé…ç½®
LOGSTASH_VERSION=8.10.0
LOGSTASH_HEAP_SIZE=1g
PIPELINE_WORKERS=2
PIPELINE_BATCH_SIZE=125

# Elasticsearché…ç½®
ES_HOST=elasticsearch
ES_PORT=9200
ES_USERNAME=elastic
ES_PASSWORD=changeme

# ç½‘ç»œé…ç½®
LOGSTASH_PORT_BEATS=5044
LOGSTASH_PORT_TCP=5000
LOGSTASH_PORT_HTTP=5001

# ç›®å½•é…ç½®
CONFIG_DIR=./config
PIPELINE_DIR=./pipeline
DATA_DIR=./data
LOGS_DIR=./logs
```

**ðŸ“ é…ç½®æ–‡ä»¶æ¨¡æ¿åŒ–**

```yaml
# logstash.ymlæ¨¡æ¿
http.host: "0.0.0.0"
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch.hosts: ["${ES_HOST}:${ES_PORT}"]
xpack.monitoring.elasticsearch.username: "${ES_USERNAME}"
xpack.monitoring.elasticsearch.password: "${ES_PASSWORD}"

pipeline.workers: ${PIPELINE_WORKERS}
pipeline.batch.size: ${PIPELINE_BATCH_SIZE}
```

---

## 4. â˜¸ï¸ Kubernetesé›†ç¾¤éƒ¨ç½²


### 4.1 Kuberneteséƒ¨ç½²æž¶æž„


**ðŸ—ï¸ Kubernetesä¸­çš„Logstashæž¶æž„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Kubernetesé›†ç¾¤                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Namespace: logging                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Logstash Pod1 â”‚  â”‚ Logstash Pod2 â”‚  â”‚ ConfigMap   â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚ Container â”‚ â”‚  â”‚ â”‚ Container â”‚ â”‚  â”‚ â”‚ é…ç½®æ–‡ä»¶  â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†‘                  â†‘               â†‘          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Service (è´Ÿè½½å‡è¡¡)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ConfigMapé…ç½®ç®¡ç†


**ðŸ“‹ åˆ›å»ºConfigMap**

```yaml
# logstash-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  namespace: logging
data:
  logstash.yml: |
    http.host: "0.0.0.0"
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.hosts: ["elasticsearch:9200"]
    
    pipeline.workers: 2
    pipeline.batch.size: 125
    
  pipeline.conf: |
    input {
      beats {
        port => 5044
      }
    }
    
    filter {
      if [fields][log_type] == "nginx" {
        grok {
          match => { "message" => "%{NGINXACCESS}" }
        }
      }
    }
    
    output {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "logstash-%{+YYYY.MM.dd}"
      }
    }
    
  jvm.options: |
    -Xms512m
    -Xmx1g
    -XX:+UseG1GC
```

### 4.3 Deploymentéƒ¨ç½²é…ç½®


**ðŸš€ Logstash Deployment**

```yaml
# logstash-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: logstash
  namespace: logging
  labels:
    app: logstash
spec:
  replicas: 2
  selector:
    matchLabels:
      app: logstash
  template:
    metadata:
      labels:
        app: logstash
    spec:
      containers:
      - name: logstash
        image: docker.elastic.co/logstash/logstash:8.10.0
        
        # ç«¯å£é…ç½®
        ports:
        - containerPort: 5044
          name: beats
        - containerPort: 9600
          name: http
        
        # çŽ¯å¢ƒå˜é‡
        env:
        - name: LS_JAVA_OPTS
          value: "-Xms512m -Xmx1g"
        
        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        
        # é…ç½®æ–‡ä»¶æŒ‚è½½
        volumeMounts:
        - name: config-volume
          mountPath: /usr/share/logstash/config/logstash.yml
          subPath: logstash.yml
        - name: config-volume
          mountPath: /usr/share/logstash/pipeline/pipeline.conf
          subPath: pipeline.conf
        - name: config-volume
          mountPath: /usr/share/logstash/config/jvm.options
          subPath: jvm.options
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /
            port: 9600
          initialDelaySeconds: 60
          periodSeconds: 30
        
        readinessProbe:
          httpGet:
            path: /
            port: 9600
          initialDelaySeconds: 30
          periodSeconds: 10
      
      # é…ç½®å·
      volumes:
      - name: config-volume
        configMap:
          name: logstash-config
```

### 4.4 ServiceæœåŠ¡æš´éœ²


**ðŸŒ åˆ›å»ºService**

```yaml
# logstash-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: logstash-service
  namespace: logging
  labels:
    app: logstash
spec:
  type: ClusterIP
  ports:
  - port: 5044
    targetPort: 5044
    protocol: TCP
    name: beats
  - port: 9600
    targetPort: 9600
    protocol: TCP
    name: http
  selector:
    app: logstash

---
# å¦‚æžœéœ€è¦å¤–éƒ¨è®¿é—®ï¼Œåˆ›å»ºNodePort Service
apiVersion: v1
kind: Service
metadata:
  name: logstash-nodeport
  namespace: logging
spec:
  type: NodePort
  ports:
  - port: 5044
    targetPort: 5044
    nodePort: 30044
    name: beats
  selector:
    app: logstash
```

---

## 5. ðŸ“Š å®¹å™¨ç›‘æŽ§ä¸Žæ—¥å¿—ç®¡ç†


### 5.1 å®¹å™¨å¥åº·ç›‘æŽ§


**â¤ï¸ å¥åº·æ£€æŸ¥é…ç½®**

```yaml
# Dockerå®¹å™¨å¥åº·æ£€æŸ¥
healthcheck:
  test: |
    curl -f http://localhost:9600/_node/hot_threads || 
    curl -f http://localhost:9600/_node/stats ||
    exit 1
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s
```

**ðŸ“ˆ ç›‘æŽ§æŒ‡æ ‡æ”¶é›†**

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
docker stats logstash-container

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f logstash-container

# è¿›å…¥å®¹å™¨æ£€æŸ¥çŠ¶æ€
docker exec -it logstash-container bash
curl http://localhost:9600/_node/stats
```

### 5.2 æ—¥å¿—ç®¡ç†ç­–ç•¥


**ðŸ“ æ—¥å¿—è¾“å‡ºé…ç½®**

```yaml
# docker-compose.ymlä¸­çš„æ—¥å¿—é…ç½®
services:
  logstash:
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
        compress: "true"
```

**ðŸ” æ—¥å¿—çº§åˆ«æŽ§åˆ¶**

```yaml
# log4j2.properties
status = error
name = LogstashPropertiesConfig

appender.console.type = Console
appender.console.name = plain_console
appender.console.layout.type = PatternLayout
appender.console.layout.pattern = [%d{ISO8601}][%-5p][%-25c] %m%n

appender.json_console.type = Console
appender.json_console.name = json_console
appender.json_console.layout.type = JSONLayout
appender.json_console.layout.compact = true

rootLogger.level = info
rootLogger.appenderRef.console.ref = ${LOGSTASH_LOG_FORMAT}_console
```

### 5.3 ç›‘æŽ§å‘Šè­¦é›†æˆ


**âš ï¸ Prometheusç›‘æŽ§é…ç½®**

```yaml
# logstash-servicemonitor.yaml (å¦‚æžœä½¿ç”¨Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: logstash-monitor
  namespace: logging
spec:
  selector:
    matchLabels:
      app: logstash
  endpoints:
  - port: http
    path: /_node/stats
    interval: 30s
```

---

## 6. ðŸ“ å®¹å™¨æ‰©ç¼©å®¹å®žè·µ


### 6.1 æ‰‹åŠ¨æ‰©ç¼©å®¹


**â¬†ï¸ Docker Composeæ‰©å®¹**

```bash
# æ‰©å®¹åˆ°3ä¸ªå®žä¾‹
docker-compose up -d --scale logstash=3

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker-compose ps

# ç¼©å®¹åˆ°1ä¸ªå®žä¾‹
docker-compose up -d --scale logstash=1
```

**â˜¸ï¸ Kubernetesæ‰‹åŠ¨æ‰©å®¹**

```bash
# æ‰©å®¹åˆ°5ä¸ªå‰¯æœ¬
kubectl scale deployment logstash --replicas=5 -n logging

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n logging -l app=logstash

# æŸ¥çœ‹æ‰©å®¹è¿‡ç¨‹
kubectl get events -n logging --sort-by='.lastTimestamp'
```

### 6.2 è‡ªåŠ¨æ‰©ç¼©å®¹(HPA)


**ðŸ¤– Horizontal Pod Autoscaleré…ç½®**

```yaml
# logstash-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: logstash-hpa
  namespace: logging
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: logstash
  
  minReplicas: 2
  maxReplicas: 10
  
  metrics:
  # CPUä½¿ç”¨çŽ‡æŒ‡æ ‡
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  # å†…å­˜ä½¿ç”¨çŽ‡æŒ‡æ ‡  
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  
  # è‡ªå®šä¹‰æŒ‡æ ‡ - å¾…å¤„ç†é˜Ÿåˆ—é•¿åº¦
  - type: Pods
    pods:
      metric:
        name: logstash_queue_events
      target:
        type: AverageValue
        averageValue: "100"
  
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
```

### 6.3 æ‰©ç¼©å®¹æœ€ä½³å®žè·µ


**ðŸŽ¯ æ‰©ç¼©å®¹ç­–ç•¥æŒ‡å¯¼**

| åœºæ™¯ | æ‰©å®¹è§¦å‘æ¡ä»¶ | ç¼©å®¹è§¦å‘æ¡ä»¶ | æ³¨æ„äº‹é¡¹ |
|------|-------------|-------------|----------|
| **CPUå¯†é›†åž‹å¤„ç†** | `CPU > 70%` | `CPU < 30%` | `é¿å…é¢‘ç¹æ‰©ç¼©å®¹` |
| **å†…å­˜å¯†é›†åž‹å¤„ç†** | `å†…å­˜ > 80%` | `å†…å­˜ < 40%` | `é˜²æ­¢OOMæ€æ­»å®¹å™¨` |
| **é˜Ÿåˆ—ç§¯åŽ‹ä¸¥é‡** | `é˜Ÿåˆ—é•¿åº¦ > 1000` | `é˜Ÿåˆ—é•¿åº¦ < 100` | `è€ƒè™‘å¤„ç†å»¶è¿Ÿ` |
| **ç½‘ç»œIOç“¶é¢ˆ** | `ç½‘ç»œåˆ©ç”¨çŽ‡ > 80%` | `ç½‘ç»œåˆ©ç”¨çŽ‡ < 30%` | `å¸¦å®½æ˜¯å¦è¶³å¤Ÿ` |

**âš¡ å¿«é€Ÿæ‰©å®¹åº”æ€¥é¢„æ¡ˆ**

```bash
#!/bin/bash
# emergency-scale.sh - åº”æ€¥æ‰©å®¹è„šæœ¬

NAMESPACE="logging"
DEPLOYMENT="logstash"
CURRENT_REPLICAS=$(kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.replicas}')

echo "å½“å‰å‰¯æœ¬æ•°: $CURRENT_REPLICAS"

# ç´§æ€¥æƒ…å†µä¸‹å¿«é€Ÿæ‰©å®¹åˆ°å½“å‰çš„2å€
EMERGENCY_REPLICAS=$((CURRENT_REPLICAS * 2))

echo "ç´§æ€¥æ‰©å®¹åˆ°: $EMERGENCY_REPLICAS ä¸ªå‰¯æœ¬"

kubectl scale deployment $DEPLOYMENT --replicas=$EMERGENCY_REPLICAS -n $NAMESPACE

# ç›‘æŽ§æ‰©å®¹è¿›åº¦
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE

echo "æ‰©å®¹å®Œæˆï¼"
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ Dockerå®¹å™¨åŒ–ï¼šçŽ¯å¢ƒä¸€è‡´æ€§ã€å¿«é€Ÿéƒ¨ç½²ã€èµ„æºéš”ç¦»
ðŸ”¸ é•œåƒæž„å»ºï¼šå®˜æ–¹é•œåƒä½¿ç”¨ã€è‡ªå®šä¹‰é•œåƒæž„å»ºã€é•œåƒä¼˜åŒ–
ðŸ”¸ é…ç½®ç®¡ç†ï¼šé…ç½®å¤–éƒ¨åŒ–ã€çŽ¯å¢ƒå˜é‡ç®¡ç†ã€æ¨¡æ¿åŒ–é…ç½®
ðŸ”¸ Kuberneteséƒ¨ç½²ï¼šConfigMapã€Deploymentã€Serviceé…ç½®
ðŸ”¸ ç›‘æŽ§æ—¥å¿—ï¼šå¥åº·æ£€æŸ¥ã€æ—¥å¿—ç®¡ç†ã€ç›‘æŽ§å‘Šè­¦
ðŸ”¸ æ‰©ç¼©å®¹ï¼šæ‰‹åŠ¨æ‰©ç¼©å®¹ã€HPAè‡ªåŠ¨æ‰©ç¼©å®¹ã€æ‰©å®¹ç­–ç•¥
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ å®¹å™¨åŒ–çš„æœ¬è´¨ä¼˜åŠ¿**
```
ä¼ ç»Ÿéƒ¨ç½²çš„é—®é¢˜ï¼š
- çŽ¯å¢ƒä¸ä¸€è‡´å¯¼è‡´çš„"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"é—®é¢˜
- ä¾èµ–ç®¡ç†å¤æ‚ï¼Œç‰ˆæœ¬å†²çªé¢‘ç¹
- æ‰©å®¹å¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®æ¯å°æœºå™¨

å®¹å™¨åŒ–è§£å†³æ–¹æ¡ˆï¼š
- æ‰“åŒ…åº”ç”¨åŠå…¶ä¾èµ–ï¼Œç¡®ä¿çŽ¯å¢ƒä¸€è‡´
- é•œåƒç‰ˆæœ¬åŒ–ç®¡ç†ï¼Œå›žæ»šå‡çº§ç®€å•
- å¿«é€Ÿå¯åŠ¨æ–°å®žä¾‹ï¼Œè‡ªåŠ¨åŒ–æ‰©ç¼©å®¹
```

**ðŸ”¹ é…ç½®ç®¡ç†çš„æœ€ä½³å®žè·µ**
```
é…ç½®åˆ†ç¦»åŽŸåˆ™ï¼š
- é…ç½®ä¸Žä»£ç åˆ†ç¦»ï¼Œé•œåƒé€šç”¨åŒ–
- æ•æ„Ÿä¿¡æ¯å¤–éƒ¨åŒ–ï¼Œä½¿ç”¨Secretç®¡ç†
- çŽ¯å¢ƒå˜é‡æ¨¡æ¿åŒ–ï¼Œæ”¯æŒå¤šçŽ¯å¢ƒéƒ¨ç½²

ç‰ˆæœ¬ç®¡ç†ç­–ç•¥ï¼š
- é…ç½®æ–‡ä»¶ç‰ˆæœ¬åŒ–ç®¡ç†
- é…ç½®å˜æ›´å¯è¿½æº¯
- æ”¯æŒé…ç½®çƒ­æ›´æ–°
```

**ðŸ”¹ Kuberneteséƒ¨ç½²çš„æ ¸å¿ƒæ€æƒ³**
```
å£°æ˜Žå¼ç®¡ç†ï¼š
- æè¿°æœŸæœ›çŠ¶æ€ï¼Œè€Œéžæ‰§è¡Œæ­¥éª¤
- ç³»ç»Ÿè‡ªåŠ¨ç»´æŠ¤æœŸæœ›çŠ¶æ€
- é…ç½®å³ä»£ç ï¼Œä¾¿äºŽç‰ˆæœ¬ç®¡ç†

æœåŠ¡å‘çŽ°æœºåˆ¶ï¼š
- Serviceæä¾›ç¨³å®šçš„ç½‘ç»œè®¿é—®å…¥å£
- DNSè‡ªåŠ¨è§£æžæœåŠ¡ååˆ°Pod IP
- è´Ÿè½½å‡è¡¡è‡ªåŠ¨åˆ†å‘è¯·æ±‚
```

### 7.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸ’¼ ç”Ÿäº§çŽ¯å¢ƒåº”ç”¨åœºæ™¯**

- **å¾®æœåŠ¡æž¶æž„**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹å®¹å™¨åŒ–ï¼Œä¾¿äºŽç®¡ç†å’Œæ‰©å±•
- **å¤šçŽ¯å¢ƒéƒ¨ç½²**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ç›¸åŒé•œåƒ
- **å¼¹æ€§ä¼¸ç¼©**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´Logstashå®žä¾‹æ•°é‡
- **æ•…éšœéš”ç¦»**ï¼šå•ä¸ªå®¹å™¨æ•…éšœä¸å½±å“å…¶ä»–å®žä¾‹
- **ç‰ˆæœ¬ç®¡ç†**ï¼šå¿«é€Ÿå‡çº§å›žæ»šï¼ŒA/Bæµ‹è¯•éƒ¨ç½²

**ðŸ”§ è¿ç»´å®žè·µè¦ç‚¹**

- **ç›‘æŽ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„å®¹å™¨ç›‘æŽ§ä½“ç³»
- **æ—¥å¿—æ”¶é›†**ï¼šç»Ÿä¸€æ”¶é›†å’Œç®¡ç†å®¹å™¨æ—¥å¿—
- **èµ„æºç®¡ç†**ï¼šåˆç†é…ç½®CPUã€å†…å­˜é™åˆ¶
- **å®‰å…¨åŠ å›º**ï¼šæœ€å°æƒé™åŽŸåˆ™ï¼Œé•œåƒå®‰å…¨æ‰«æ
- **å¤‡ä»½æ¢å¤**ï¼šæ•°æ®å·å¤‡ä»½ï¼Œé…ç½®æ–‡ä»¶å¤‡ä»½

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®¹å™¨åŒ–è§£å†³çŽ¯å¢ƒä¸€è‡´æ€§é—®é¢˜ï¼Œè®©éƒ¨ç½²å˜å¾—ç®€å•
- é…ç½®å¤–éƒ¨åŒ–æ˜¯å®¹å™¨åŒ–æˆåŠŸçš„å…³é”®ï¼Œåˆ†ç¦»å…³æ³¨ç‚¹
- Kubernetesæä¾›äº†å¼ºå¤§çš„ç¼–æŽ’èƒ½åŠ›ï¼Œå£°æ˜Žå¼ç®¡ç†
- ç›‘æŽ§å’Œæ—¥å¿—æ˜¯ç”Ÿäº§çŽ¯å¢ƒå¿…ä¸å¯å°‘çš„è¿ç»´æ‰‹æ®µ
- è‡ªåŠ¨æ‰©ç¼©å®¹è®©ç³»ç»Ÿå…·å¤‡åº”å¯¹è´Ÿè½½å˜åŒ–çš„å¼¹æ€§èƒ½åŠ›