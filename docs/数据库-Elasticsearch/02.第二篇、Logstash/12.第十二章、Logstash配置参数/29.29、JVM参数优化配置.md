---
title: 29ã€JVMå‚æ•°ä¼˜åŒ–é…ç½®
---
## ğŸ“š ç›®å½•


1. [JVMå‚æ•°ä¼˜åŒ–åŸºç¡€æ¦‚å¿µ](#1-JVMå‚æ•°ä¼˜åŒ–åŸºç¡€æ¦‚å¿µ)
2. [å †å†…å­˜é…ç½®è¯¦è§£](#2-å †å†…å­˜é…ç½®è¯¦è§£)
3. [åƒåœ¾æ”¶é›†å™¨é€‰æ‹©ä¸é…ç½®](#3-åƒåœ¾æ”¶é›†å™¨é€‰æ‹©ä¸é…ç½®)
4. [çº¿ç¨‹ä¸ç›´æ¥å†…å­˜é…ç½®](#4-çº¿ç¨‹ä¸ç›´æ¥å†…å­˜é…ç½®)
5. [ç›‘æ§ä¸è¯Šæ–­å‚æ•°](#5-ç›‘æ§ä¸è¯Šæ–­å‚æ•°)
6. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#6-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¡ JVMå‚æ•°ä¼˜åŒ–åŸºç¡€æ¦‚å¿µ



### 1.1 ä¸ºä»€ä¹ˆéœ€è¦JVMä¼˜åŒ–


**ç®€å•ç†è§£**ï¼šæŠŠJVMæƒ³è±¡æˆä½ çš„å·¥ä½œå°ï¼Œä¼˜åŒ–å°±æ˜¯æ•´ç†å·¥ä½œå°è®©å·¥ä½œæ›´é«˜æ•ˆ

```
æœªä¼˜åŒ–çš„Logstashï¼š
ğŸŒ å¤„ç†é€Ÿåº¦æ…¢ï¼Œç»å¸¸å¡é¡¿
ğŸ’¥ å†…å­˜æº¢å‡ºï¼Œç¨‹åºå´©æºƒ
ğŸ”¥ CPUä½¿ç”¨ç‡è¿‡é«˜
â±ï¸ åƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿ï¼Œå½±å“æ•°æ®å¤„ç†

ä¼˜åŒ–åçš„Logstashï¼š
âš¡ æ•°æ®å¤„ç†æµç•…ï¼Œååé‡é«˜
ğŸ¯ å†…å­˜ä½¿ç”¨åˆç†ï¼Œç¨³å®šè¿è¡Œ
ğŸ”§ èµ„æºåˆ©ç”¨ç‡æœ€ä¼˜
â° åƒåœ¾å›æ”¶å½±å“æœ€å°
```

### 1.2 JVMå†…å­˜ç»“æ„å¿«é€Ÿç†è§£



**å†…å­˜åŒºåŸŸåˆ’åˆ†**ï¼šæƒ³è±¡JVMå†…å­˜å°±åƒä¸€æ ‹åŠå…¬æ¥¼

```
JVMå†…å­˜ç»“æ„ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å †å†…å­˜ (Heap)          â”‚ â† ä¸»è¦å·¥ä½œåŒºåŸŸï¼Œå­˜æ”¾æ•°æ®å¯¹è±¡
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   å¹´è½»ä»£     â”‚    è€å¹´ä»£    â”‚   â”‚
â”‚  â”‚ (Young Gen) â”‚  (Old Gen)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æ–¹æ³•åŒº (Method Area)       â”‚ â† å­˜æ”¾ç±»ä¿¡æ¯ã€å¸¸é‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ç›´æ¥å†…å­˜ (Direct Memory)    â”‚ â† å †å¤–å†…å­˜ï¼Œç½‘ç»œI/Oç¼“å†²
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æ ˆå†…å­˜ (Stack)            â”‚ â† çº¿ç¨‹ç§æœ‰ï¼Œæ–¹æ³•è°ƒç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ“Œ **æ ¸å¿ƒç†è§£**  
> å †å†…å­˜å°±åƒä½ çš„åŠå…¬æ¡Œï¼Œè¶Šå¤§èƒ½æ”¾çš„ä¸œè¥¿è¶Šå¤šï¼Œä½†æ•´ç†ï¼ˆåƒåœ¾å›æ”¶ï¼‰ä¹Ÿè¶Šè´¹æ—¶é—´

### 1.3 Logstash JVMé…ç½®æ–‡ä»¶ä½ç½®



**é…ç½®æ–‡ä»¶è·¯å¾„**ï¼š
```bash
# ä¸»è¦é…ç½®æ–‡ä»¶

/etc/logstash/jvm.options          # â† ä¸»è¦JVMå‚æ•°é…ç½®
/etc/logstash/logstash.yml         # â† Logstashä¸»é…ç½®
/etc/logstash/startup.options      # â† å¯åŠ¨é€‰é¡¹é…ç½®

# ç¯å¢ƒå˜é‡æ–‡ä»¶

/etc/default/logstash              # â† Ubuntu/Debian
/etc/sysconfig/logstash            # â† CentOS/RHEL
```

---

## 2. ğŸ§  å †å†…å­˜é…ç½®è¯¦è§£



### 2.1 å †å†…å­˜åŸºæœ¬å‚æ•°



**æ ¸å¿ƒå‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | **å«ä¹‰** | **æ¨èè®¾ç½®** | **è¯´æ˜** |
|------|---------|-------------|----------|
| `-Xms` | `åˆå§‹å †å¤§å°` | `ä¸-Xmxç›¸åŒ` | `å¯åŠ¨æ—¶å°±åˆ†é…ï¼Œé¿å…åŠ¨æ€æ‰©å±•` |
| `-Xmx` | `æœ€å¤§å †å¤§å°` | `ç³»ç»Ÿå†…å­˜çš„25-50%` | `ä¸è¶…è¿‡32GBï¼ˆå‹ç¼©æŒ‡é’ˆé™åˆ¶ï¼‰` |
| `-XX:NewRatio` | `è€å¹´ä»£/å¹´è½»ä»£æ¯”ä¾‹` | `2-4` | `è€å¹´ä»£æ˜¯å¹´è½»ä»£çš„2-4å€` |
| `-XX:SurvivorRatio` | `Eden/Survivoræ¯”ä¾‹` | `6-8` | `EdenåŒºæ˜¯SurvivoråŒºçš„6-8å€` |

### 2.2 å †å†…å­˜å¤§å°è®¾ç½®ç­–ç•¥



**ğŸ¯ è®¾ç½®åŸåˆ™**ï¼š

```bash
# 1. å°å‹Logstashå®ä¾‹ï¼ˆæ—¥å¿—é‡ < 1GB/å¤©ï¼‰

-Xms1g
-Xmx1g

# 2. ä¸­å‹Logstashå®ä¾‹ï¼ˆæ—¥å¿—é‡ 1-10GB/å¤©ï¼‰

-Xms4g
-Xmx4g

# 3. å¤§å‹Logstashå®ä¾‹ï¼ˆæ—¥å¿—é‡ > 10GB/å¤©ï¼‰

-Xms8g
-Xmx8g

# 4. è¶…å¤§å‹Logstashå®ä¾‹ï¼ˆæ—¥å¿—é‡ > 100GB/å¤©ï¼‰

-Xms16g
-Xmx16g
```

> âš ï¸ **é‡è¦æé†’**  
> å †å†…å­˜è¶…è¿‡32GBä¼šå¤±å»å‹ç¼©æŒ‡é’ˆä¼˜åŒ–ï¼Œåè€Œæ€§èƒ½ä¸‹é™ã€‚è¶…å¤§æ•°æ®é‡æ—¶å»ºè®®ä½¿ç”¨å¤šä¸ªLogstashå®ä¾‹

### 2.3 å †å†…å­˜é…ç½®å®ä¾‹



**å®é™…é…ç½®ç¤ºä¾‹**ï¼š

```bash
# /etc/logstash/jvm.options é…ç½®

###############################################################


# ä¸“å®¶çº§å»ºè®®é…ç½®ï¼šç”Ÿäº§ç¯å¢ƒ8GBå†…å­˜æœåŠ¡å™¨


###############################################################



# å †å†…å­˜è®¾ç½® - 4GBå †å†…å­˜

-Xms4g
-Xmx4g

# å¹´è½»ä»£é…ç½® - è€å¹´ä»£æ˜¯å¹´è½»ä»£çš„3å€

-XX:NewRatio=3

# Edenå’ŒSurvivoræ¯”ä¾‹ - Edenæ˜¯Survivorçš„8å€  

-XX:SurvivorRatio=8

# ä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨ï¼ˆæ¨èï¼‰

-XX:+UseG1GC

# G1ç›¸å…³å‚æ•°

-XX:MaxGCPauseMillis=200    # æœ€å¤§GCæš‚åœæ—¶é—´200ms
-XX:G1HeapRegionSize=16m    # G1åŒºåŸŸå¤§å°16MB
```

---

## 3. ğŸ—‘ï¸ åƒåœ¾æ”¶é›†å™¨é€‰æ‹©ä¸é…ç½®



### 3.1 åƒåœ¾æ”¶é›†å™¨å¯¹æ¯”åˆ†æ



**ä¸»è¦åƒåœ¾æ”¶é›†å™¨ç‰¹ç‚¹**ï¼š

| æ”¶é›†å™¨ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **æ¨èåº¦** |
|-------|-------------|---------|---------|-----------|
| `Serial GC` | `å°å‹åº”ç”¨` | `ç®€å•ç¨³å®š` | `å•çº¿ç¨‹ï¼Œåœé¡¿æ—¶é—´é•¿` | `â­` |
| `Parallel GC` | `ååé‡ä¼˜å…ˆ` | `å¤šçº¿ç¨‹ï¼Œååé‡é«˜` | `åœé¡¿æ—¶é—´è¾ƒé•¿` | `â­â­â­` |
| `CMS GC` | `ä½å»¶è¿Ÿéœ€æ±‚` | `å¹¶å‘æ”¶é›†ï¼Œåœé¡¿çŸ­` | `å†…å­˜ç¢ç‰‡ï¼Œå·²åºŸå¼ƒ` | `â­â­` |
| `G1 GC` | `å¤§å†…å­˜åº”ç”¨` | `ä½åœé¡¿ï¼Œå¯é¢„æµ‹` | `é…ç½®å¤æ‚` | `â­â­â­â­â­` |
| `ZGC/Shenandoah` | `è¶…ä½å»¶è¿Ÿ` | `åœé¡¿æçŸ­` | `ååé‡ç•¥ä½` | `â­â­â­â­` |

### 3.2 G1åƒåœ¾æ”¶é›†å™¨æ·±åº¦é…ç½®



**G1æ”¶é›†å™¨åŸç†**ï¼šæŠŠå †å†…å­˜åˆ†æˆå¾ˆå¤šå°åŒºåŸŸï¼Œä¼˜å…ˆå›æ”¶åƒåœ¾æœ€å¤šçš„åŒºåŸŸ

```bash
# G1åƒåœ¾æ”¶é›†å™¨å®Œæ•´é…ç½®

###############################################################


# G1 GC ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®


###############################################################



# å¯ç”¨G1æ”¶é›†å™¨

-XX:+UseG1GC

# æ ¸å¿ƒæ€§èƒ½å‚æ•°

-XX:MaxGCPauseMillis=200           # ç›®æ ‡æš‚åœæ—¶é—´200ms
-XX:G1HeapRegionSize=16m           # åŒºåŸŸå¤§å°16MB
-XX:G1NewSizePercent=20            # å¹´è½»ä»£åˆå§‹å æ¯”20%
-XX:G1MaxNewSizePercent=30         # å¹´è½»ä»£æœ€å¤§å æ¯”30%
-XX:G1MixedGCCountTarget=8         # æ··åˆGCç›®æ ‡æ¬¡æ•°
-XX:G1MixedGCLiveThresholdPercent=85  # æ··åˆGCå­˜æ´»é˜ˆå€¼

# å†…å­˜å›æ”¶è§¦å‘æ¡ä»¶

-XX:G1HeapWastePercent=5           # å †åºŸæ–™ç™¾åˆ†æ¯”
-XX:G1OldCSetRegionThresholdPercent=10  # è€å¹´ä»£æ”¶é›†é›†åˆé˜ˆå€¼

# å¹¶å‘çº¿ç¨‹æ•°ï¼ˆå»ºè®®è®¾ä¸ºCPUæ ¸å¿ƒæ•°çš„1/4ï¼‰

-XX:ConcGCThreads=2                # å¹¶å‘GCçº¿ç¨‹æ•°
-XX:ParallelGCThreads=8            # å¹¶è¡ŒGCçº¿ç¨‹æ•°
```

### 3.3 ä¸åŒåœºæ™¯çš„åƒåœ¾æ”¶é›†å™¨é€‰æ‹©



**ğŸ¯ é€‰æ‹©ç­–ç•¥**ï¼š

```
æ•°æ®å¤„ç†åœºæ™¯åˆ†æï¼š

ğŸ“Š é«˜ååé‡åœºæ™¯ï¼ˆæ‰¹å¤„ç†ï¼‰ï¼š
æ¨èï¼šParallel GC
é…ç½®ï¼š-XX:+UseParallelGC -XX:ParallelGCThreads=8

ğŸš€ å®æ—¶å¤„ç†åœºæ™¯ï¼ˆå»¶è¿Ÿæ•æ„Ÿï¼‰ï¼š
æ¨èï¼šG1 GC  
é…ç½®ï¼š-XX:+UseG1GC -XX:MaxGCPauseMillis=100

âš¡ è¶…å¤§å†…å­˜åœºæ™¯ï¼ˆå †å†…å­˜>8GBï¼‰ï¼š
æ¨èï¼šG1 GC æˆ– ZGC
é…ç½®ï¼š-XX:+UseG1GC æˆ– -XX:+UseZGC

ğŸ”§ å°å†…å­˜åœºæ™¯ï¼ˆå †å†…å­˜<2GBï¼‰ï¼š
æ¨èï¼šParallel GC
é…ç½®ï¼šé»˜è®¤é…ç½®å³å¯
```

---

## 4. ğŸ§µ çº¿ç¨‹ä¸ç›´æ¥å†…å­˜é…ç½®



### 4.1 çº¿ç¨‹æ ˆå¤§å°é…ç½®



**çº¿ç¨‹æ ˆä½œç”¨**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œå­˜å‚¨æ–¹æ³•è°ƒç”¨ä¿¡æ¯

```bash
# çº¿ç¨‹æ ˆé…ç½®

-Xss1m                    # æ¯ä¸ªçº¿ç¨‹æ ˆå¤§å°1MBï¼ˆé»˜è®¤å€¼ï¼‰

# ä¸åŒåœºæ™¯çš„æ ˆå¤§å°è®¾ç½®

-Xss512k                  # å°å‹åº”ç”¨ï¼ŒèŠ‚çœå†…å­˜
-Xss1m                    # æ ‡å‡†åº”ç”¨ï¼Œæ¨èè®¾ç½®
-Xss2m                    # å¤æ‚é€’å½’è°ƒç”¨çš„åº”ç”¨
```

> ğŸ’¡ **è®¡ç®—æŠ€å·§**  
> æ€»æ ˆå†…å­˜ = çº¿ç¨‹æ•° Ã— å•çº¿ç¨‹æ ˆå¤§å°  
> ä¾‹å¦‚ï¼š100ä¸ªçº¿ç¨‹ Ã— 1MB = 100MBæ ˆå†…å­˜

### 4.2 ç›´æ¥å†…å­˜é…ç½®



**ç›´æ¥å†…å­˜è¯´æ˜**ï¼šå †å¤–å†…å­˜ï¼Œä¸»è¦ç”¨äºç½‘ç»œI/Oç¼“å†²ï¼Œä¸å—GCå½±å“

```bash
# ç›´æ¥å†…å­˜é…ç½®

-XX:MaxDirectMemorySize=1g    # æœ€å¤§ç›´æ¥å†…å­˜1GB

# ä¸åŒè§„æ¨¡çš„ç›´æ¥å†…å­˜è®¾ç½®

# å°å‹Logstashå®ä¾‹

-XX:MaxDirectMemorySize=512m

# ä¸­å‹Logstashå®ä¾‹  

-XX:MaxDirectMemorySize=1g

# å¤§å‹Logstashå®ä¾‹

-XX:MaxDirectMemorySize=2g

# é«˜ç½‘ç»œI/Oåœºæ™¯

-XX:MaxDirectMemorySize=4g
```

### 4.3 çº¿ç¨‹æ± ç›¸å…³å‚æ•°



**çº¿ç¨‹ç®¡ç†é…ç½®**ï¼š

```bash
# Logstashçº¿ç¨‹ç›¸å…³å‚æ•°

###############################################################


# pipeline.ymlä¸­çš„çº¿ç¨‹é…ç½®


###############################################################



# ç®¡é“çº¿ç¨‹æ•°ï¼ˆé€šå¸¸è®¾ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰

pipeline.workers: 8

# æ‰¹å¤„ç†å¤§å°

pipeline.batch.size: 125

# æ‰¹å¤„ç†å»¶è¿Ÿ

pipeline.batch.delay: 50

# è¾“å‡ºçº¿ç¨‹æ•°

pipeline.output.workers: 1
```

---

## 5. ğŸ“Š ç›‘æ§ä¸è¯Šæ–­å‚æ•°



### 5.1 GCæ—¥å¿—é…ç½®



**åƒåœ¾æ”¶é›†æ—¥å¿—æ˜¯æ€§èƒ½è°ƒä¼˜çš„å…³é”®ä¿¡æ¯æ¥æº**

```bash
# GCæ—¥å¿—é…ç½®ï¼ˆJava 11+æ¨èé…ç½®ï¼‰

###############################################################


# ç”Ÿäº§ç¯å¢ƒGCæ—¥å¿—é…ç½®


###############################################################



# å¯ç”¨GCæ—¥å¿—

-Xlog:gc*:logs/logstash-gc.log:time,level,tags

# è¯¦ç»†GCæ—¥å¿—é…ç½®

-Xlog:gc*,heap*,ergo*:logs/logstash-gc.log:time,level,tags

# GCæ—¥å¿—è½®è½¬ï¼ˆé˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼‰

-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles=5
-XX:GCLogFileSize=100M
```

**Java 8 GCæ—¥å¿—é…ç½®**ï¼š
```bash
# Java 8çš„GCæ—¥å¿—é…ç½®

-XX:+PrintGC
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-XX:+PrintGCApplicationStoppedTime
-Xloggc:logs/logstash-gc.log
```

### 5.2 JVMç›‘æ§å‚æ•°



**å†…å­˜å’Œæ€§èƒ½ç›‘æ§é…ç½®**ï¼š

```bash
# JVMç›‘æ§å‚æ•°

###############################################################


# JVMæ€§èƒ½ç›‘æ§é…ç½®


###############################################################



# å¯ç”¨JFRï¼ˆJava Flight Recorderï¼‰

-XX:+FlightRecorder
-XX:StartFlightRecording=duration=3600s,filename=logstash-perf.jfr

# å¯ç”¨JMXè¿œç¨‹ç›‘æ§

-Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false

# å†…å­˜è½¬å‚¨é…ç½®ï¼ˆOOMæ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰

-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=logs/logstash-heap-dump.hprof

# æ€§èƒ½è°ƒè¯•å‚æ•°

-XX:+PrintCompilation        # æ‰“å°JITç¼–è¯‘ä¿¡æ¯
-XX:+UnlockDiagnosticVMOptions  # è§£é”è¯Šæ–­é€‰é¡¹
-XX:+TraceClassLoading       # è·Ÿè¸ªç±»åŠ è½½
```

### 5.3 æ€§èƒ½åˆ†æå·¥å…·é›†æˆ



**å¸¸ç”¨ç›‘æ§å·¥å…·é…ç½®**ï¼š

```bash
# åº”ç”¨æ€§èƒ½ç›‘æ§(APM)é›†æˆ

###############################################################


# æ€§èƒ½ç›‘æ§å·¥å…·é…ç½®


###############################################################



# Elasticsearch APM Agent

-javaagent:elastic-apm-agent.jar
-Delastic.apm.service_name=logstash
-Delastic.apm.server_urls=http://apm-server:8200

# Prometheus JMXç›‘æ§

-javaagent:jmx_prometheus_javaagent.jar=8080:jmx_config.yaml

# å†…å­˜åˆ†æå·¥å…·

-XX:NativeMemoryTracking=summary  # å¯ç”¨æœ¬åœ°å†…å­˜è·Ÿè¸ª
```

---

## 6. ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ



### 6.1 ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®æ¨¡æ¿



**å°å‹ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼ˆå¤„ç†é‡ < 10GB/å¤©ï¼‰ï¼š

```bash
# /etc/logstash/jvm.options - å°å‹ç”Ÿäº§ç¯å¢ƒ

###############################################################


# å°å‹ç”Ÿäº§ç¯å¢ƒJVMé…ç½®ï¼ˆ4æ ¸8GBæœåŠ¡å™¨ï¼‰


###############################################################



# åŸºç¡€å†…å­˜é…ç½®

-Xms2g
-Xmx2g

# G1åƒåœ¾æ”¶é›†å™¨é…ç½®

-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=8m

# ç›‘æ§å’Œæ—¥å¿—

-Xlog:gc*:logs/logstash-gc.log:time,level,tags
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=logs/

# çº¿ç¨‹é…ç½®

-Xss1m
-XX:MaxDirectMemorySize=512m

# æ€§èƒ½ä¼˜åŒ–

-XX:+UseBiasedLocking
-XX:+OptimizeStringConcat
```

**å¤§å‹ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼ˆå¤„ç†é‡ > 50GB/å¤©ï¼‰ï¼š

```bash
# /etc/logstash/jvm.options - å¤§å‹ç”Ÿäº§ç¯å¢ƒ

###############################################################  


# å¤§å‹ç”Ÿäº§ç¯å¢ƒJVMé…ç½®ï¼ˆ16æ ¸32GBæœåŠ¡å™¨ï¼‰


###############################################################



# åŸºç¡€å†…å­˜é…ç½®

-Xms16g
-Xmx16g

# G1åƒåœ¾æ”¶é›†å™¨ä¼˜åŒ–é…ç½®

-XX:+UseG1GC
-XX:MaxGCPauseMillis=100
-XX:G1HeapRegionSize=32m
-XX:G1NewSizePercent=15
-XX:G1MaxNewSizePercent=25
-XX:G1MixedGCCountTarget=8
-XX:G1HeapWastePercent=5

# å¹¶å‘çº¿ç¨‹é…ç½®

-XX:ConcGCThreads=4
-XX:ParallelGCThreads=16

# å¤§å†…å­˜ä¼˜åŒ–

-XX:+UseLargePages              # å¯ç”¨å¤§é¡µå†…å­˜
-XX:LargePageSizeInBytes=2m     # å¤§é¡µå¤§å°2MB

# ç›‘æ§é…ç½®

-Xlog:gc*,heap*:logs/logstash-gc.log:time,level,tags
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=logs/

# é«˜æ€§èƒ½ä¼˜åŒ–

-XX:MaxDirectMemorySize=4g
-XX:+UseTransparentHugePages
-XX:+UnlockExperimentalVMOptions
```

### 6.2 é…ç½®éªŒè¯ä¸è°ƒä¼˜æµç¨‹



**ğŸ“‹ é…ç½®éªŒè¯æ¸…å•**ï¼š

```
é…ç½®éªŒè¯æ­¥éª¤ï¼š

âœ… 1. å†…å­˜é…ç½®æ£€æŸ¥
   - å †å†…å­˜ä¸è¶…è¿‡ç‰©ç†å†…å­˜çš„75%
   - -Xmså’Œ-Xmxè®¾ä¸ºç›¸åŒå€¼
   - ç›´æ¥å†…å­˜é€‚é…ç½‘ç»œI/Oéœ€æ±‚

âœ… 2. GCé…ç½®éªŒè¯  
   - é€‰æ‹©åˆé€‚çš„åƒåœ¾æ”¶é›†å™¨
   - GCåœé¡¿æ—¶é—´ç¬¦åˆä¸šåŠ¡è¦æ±‚
   - GCé¢‘ç‡åœ¨åˆç†èŒƒå›´å†…

âœ… 3. ç›‘æ§é…ç½®ç¡®è®¤
   - GCæ—¥å¿—æ­£å¸¸è¾“å‡º
   - JMXç›‘æ§ç«¯å£å¯è®¿é—®
   - å†…å­˜è½¬å‚¨è·¯å¾„æœ‰å†™æƒé™

âœ… 4. æ€§èƒ½åŸºå‡†æµ‹è¯•
   - ååé‡æ»¡è¶³ä¸šåŠ¡éœ€æ±‚
   - å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´å†…
   - èµ„æºåˆ©ç”¨ç‡åˆç†
```

### 6.3 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ



**ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—**ï¼š

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| `å†…å­˜æº¢å‡ºOOM` | `å †å†…å­˜ä¸è¶³` | `å¢å¤§-Xmxå‚æ•°` |
| `GCåœé¡¿è¿‡é•¿` | `å †å†…å­˜è¿‡å¤§æˆ–æ”¶é›†å™¨ä¸å½“` | `è°ƒæ•´å †å¤§å°æˆ–æ¢ç”¨G1GC` |
| `ååé‡ä½` | `GCé¢‘ç¹æˆ–çº¿ç¨‹ä¸è¶³` | `ä¼˜åŒ–GCå‚æ•°ï¼Œå¢åŠ pipeline.workers` |
| `CPUä½¿ç”¨ç‡é«˜` | `GCçº¿ç¨‹è¿‡å¤š` | `è°ƒæ•´ParallelGCThreadså‚æ•°` |

> ğŸ” **è°ƒä¼˜æŠ€å·§**  
> æ€§èƒ½è°ƒä¼˜æ˜¯ä¸ªæ¸è¿›è¿‡ç¨‹ï¼Œæ¯æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœåå†ç»§ç»­ä¼˜åŒ–

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 7.1 å¿…é¡»æŒæ¡çš„å…³é”®é…ç½®



```
ğŸ”¸ å †å†…å­˜è®¾ç½®ï¼š-Xmså’Œ-Xmxç›¸ç­‰ï¼Œä¸è¶…è¿‡32GB
ğŸ”¸ åƒåœ¾æ”¶é›†å™¨ï¼šæ¨èG1GCï¼Œé…ç½®MaxGCPauseMillis
ğŸ”¸ ç›‘æ§æ—¥å¿—ï¼šå¯ç”¨GCæ—¥å¿—ï¼Œé…ç½®å†…å­˜è½¬å‚¨
ğŸ”¸ ç›´æ¥å†…å­˜ï¼šæ ¹æ®ç½‘ç»œI/Oéœ€æ±‚è®¾ç½®MaxDirectMemorySize
ğŸ”¸ çº¿ç¨‹é…ç½®ï¼šçº¿ç¨‹æ ˆå¤§å°1MBï¼Œçº¿ç¨‹æ•°ç­‰äºCPUæ ¸å¿ƒæ•°
```

### 7.2 ç”Ÿäº§ç¯å¢ƒé…ç½®è¦ç‚¹



**ğŸ¯ é…ç½®åŸåˆ™è®°å¿†**ï¼š
```
å†…å­˜é…ç½®ä¸‰è¦ç´ ï¼š
- å †å†…å­˜ = ç³»ç»Ÿå†…å­˜çš„25-50%
- ç›´æ¥å†…å­˜ = ç½‘ç»œI/Oç¼“å†²éœ€æ±‚
- æ ˆå†…å­˜ = çº¿ç¨‹æ•° Ã— 1MB

GCé…ç½®ä¸‰æ­¥èµ°ï¼š  
- é€‰æ‹©G1GCï¼ˆå¤§å†…å­˜ï¼‰æˆ–ParallelGCï¼ˆé«˜ååé‡ï¼‰
- è®¾ç½®åˆç†çš„åœé¡¿æ—¶é—´ç›®æ ‡
- å¯ç”¨GCæ—¥å¿—ç›‘æ§

ç›‘æ§é…ç½®ä¸‰ä»¶å¥—ï¼š
- GCæ—¥å¿—è®°å½•æ€§èƒ½æ•°æ®
- JMXç›‘æ§å®æ—¶çŠ¶æ€  
- å†…å­˜è½¬å‚¨åˆ†æé—®é¢˜
```

### 7.3 æ€§èƒ½è°ƒä¼˜å®æˆ˜å»ºè®®



**ğŸš€ è°ƒä¼˜æ­¥éª¤**ï¼š
1. **å»ºç«‹åŸºå‡†**ï¼šè®°å½•å½“å‰æ€§èƒ½æŒ‡æ ‡
2. **å•ä¸€å˜é‡**ï¼šæ¯æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°
3. **å……åˆ†æµ‹è¯•**ï¼šè§‚å¯Ÿè‡³å°‘24å°æ—¶çš„è¿è¡Œæ•ˆæœ
4. **å›æ»šæœºåˆ¶**ï¼šä¿ç•™é…ç½®å¤‡ä»½ï¼Œé—®é¢˜æ—¶å¿«é€Ÿå›æ»š
5. **æŒç»­ç›‘æ§**ï¼šé•¿æœŸè·Ÿè¸ªGCå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ

> ğŸ’¡ **æœ€ä½³å®è·µæé†’**  
> JVMè°ƒä¼˜æ²¡æœ‰ä¸‡èƒ½é…ç½®ï¼Œéœ€è¦æ ¹æ®å®é™…æ•°æ®å¤„ç†ç‰¹ç‚¹å’Œç¡¬ä»¶ç¯å¢ƒæ¥å®šåˆ¶åŒ–é…ç½®

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å†…å­˜è®¾ç½®è¦åˆç†ï¼ŒGCé€‰æ‹©å¾ˆå…³é”®
- ç›‘æ§æ—¥å¿—ä¸èƒ½å°‘ï¼Œæ€§èƒ½é—®é¢˜æ—©å‘ç°  
- å‚æ•°è°ƒä¼˜éœ€è°¨æ…ï¼Œå•ä¸€å˜é‡é€æ­¥éªŒ
- ç”Ÿäº§é…ç½®è¦ç¨³å®šï¼Œå¤‡ä»½å›æ»šæ˜¯å¿…éœ€