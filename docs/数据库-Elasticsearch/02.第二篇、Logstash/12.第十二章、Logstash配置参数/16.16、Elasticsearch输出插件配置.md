---
title: 16、Elasticsearch输出插件配置
---
## 📚 目录

1. [Elasticsearch输出插件概述](#1-elasticsearch输出插件概述)
2. [基础连接配置](#2-基础连接配置)
3. [索引与文档配置](#3-索引与文档配置)
4. [认证与安全配置](#4-认证与安全配置)
5. [模板配置](#5-模板配置)
6. [性能优化配置](#6-性能优化配置)
7. [完整配置示例](#7-完整配置示例)
8. [常见问题与解决方案](#8-常见问题与解决方案)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 Elasticsearch输出插件概述


### 1.1 什么是Elasticsearch输出插件


**简单理解**：Elasticsearch输出插件就像一个"快递员"，负责把Logstash处理好的数据送到Elasticsearch这个"仓库"里存储起来。

```
数据流向：
原始数据 → Logstash处理 → Elasticsearch输出插件 → Elasticsearch存储

就像这样：
日志文件 → Logstash过滤整理 → 输出插件包装 → ES数据库保存
```

### 1.2 为什么要用Elasticsearch输出插件


**核心作用**：
- 🔸 **数据传输**：安全可靠地把数据传送到ES
- 🔸 **格式转换**：把Logstash的数据格式转换成ES能理解的格式  
- 🔸 **批量处理**：一次性传送多条数据，提高效率
- 🔸 **错误重试**：传送失败时自动重试

**简单类比**：
```
就像寄快递一样：
- 你要寄的东西（原始数据）
- 快递员打包（Logstash处理）
- 选择快递公司（输出插件）
- 送到目的地（Elasticsearch）
```

### 1.3 插件的基本语法结构


```ruby
output {
  elasticsearch {
    # 在这里写各种配置参数
    hosts => ["localhost:9200"]
    index => "my-logs"
  }
}
```

**语法解释**：
- `output` 表示这是输出配置
- `elasticsearch` 指定使用ES输出插件
- 大括号里面写具体的配置参数
- 每个参数用 `=>` 连接参数名和参数值

---

## 2. 🌐 基础连接配置


### 2.1 hosts参数 - 告诉插件ES在哪里


**参数含义**：`hosts` 就是告诉Logstash你的Elasticsearch服务器在哪个地址。

**基础用法**：
```ruby
# 单个ES服务器
output {
  elasticsearch {
    hosts => ["192.168.1.100:9200"]
  }
}

# 多个ES服务器（集群）
output {
  elasticsearch {
    hosts => [
      "192.168.1.100:9200",
      "192.168.1.101:9200", 
      "192.168.1.102:9200"
    ]
  }
}
```

**参数详解**：

| 🔸 **配置方式** | **含义说明** | **使用场景** |
|----------------|-------------|-------------|
| `["localhost:9200"]` | ES就在本机的9200端口 | 🟢 测试环境 |
| `["192.168.1.100:9200"]` | ES在指定服务器 | 🟡 单机生产环境 |
| `["server1:9200", "server2:9200"]` | ES集群多台服务器 | 🔴 高可用生产环境 |

**实际场景举例**：
```ruby
# 开发环境 - ES就在本机
hosts => ["localhost:9200"]

# 生产环境 - ES集群
hosts => [
  "es-node1.company.com:9200",
  "es-node2.company.com:9200",
  "es-node3.company.com:9200"
]
```

### 2.2 连接超时配置


**为什么需要超时配置**：网络不稳定时，避免Logstash一直等待ES响应。

```ruby
output {
  elasticsearch {
    hosts => ["192.168.1.100:9200"]
    timeout => 60                    # 等待60秒后超时
    connect_timeout => 10            # 连接超时10秒
  }
}
```

---

## 3. 📋 索引与文档配置


### 3.1 index参数 - 数据存储的"文件夹"


**通俗理解**：`index` 就像给你的数据选择存放在哪个"文件夹"里。不同类型的数据可以放在不同的文件夹中。

**基础语法**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-2025-01-15"      # 固定索引名
  }
}
```

**动态索引名（推荐）**：
```ruby
# 按日期自动创建索引
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"  # 每天一个新索引
  }
}
```

**索引命名模式对比**：

| 🔸 **命名方式** | **结果示例** | **适用场景** |
|----------------|-------------|-------------|
| `"logs"` | logs | 🟢 测试环境，数据量小 |
| `"logs-%{+YYYY.MM.dd}"` | logs-2025.01.15 | 🟡 按天分割，便于管理 |
| `"logs-%{+YYYY.MM}"` | logs-2025.01 | 🟡 按月分割，中等数据量 |
| `"%{[fields][logtype]}-%{+YYYY.MM.dd}"` | nginx-2025.01.15 | 🔴 按类型+日期分割 |

### 3.2 document_type参数 - 文档类型（7.x版本后废弃）


**重要说明**：ES 7.x版本后不再需要文档类型，但老版本仍需要配置。

```ruby
# ES 6.x及以下版本
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    document_type => "_doc"           # 统一使用_doc即可
  }
}

# ES 7.x及以上版本
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    # 不需要配置document_type
  }
}
```

### 3.3 document_id参数 - 给每条数据一个"身份证"


**作用说明**：`document_id` 就是给每条数据分配一个唯一的"身份证号码"。

**基础用法**：
```ruby
# 让ES自动生成ID（推荐）
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    # 不配置document_id，ES会自动生成
  }
}

# 手动指定ID
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][fingerprint]}"
  }
}
```

**什么时候需要手动指定ID**：
- ✅ **去重需求**：相同ID的数据会覆盖，实现去重
- ✅ **数据更新**：需要更新已存在的数据
- ❌ **一般日志**：让ES自动生成即可

---

## 4. 🔒 认证与安全配置


### 4.1 用户名密码认证


**使用场景**：当你的Elasticsearch开启了安全认证，就需要提供用户名和密码。

```ruby
output {
  elasticsearch {
    hosts => ["https://es-server:9200"]
    user => "logstash_user"           # 用户名
    password => "your_password"       # 密码
    index => "logs-%{+YYYY.MM.dd}"
  }
}
```

**安全建议**：
```ruby
# 不推荐：密码直接写在配置文件中
password => "123456"

# 推荐：使用环境变量
password => "${ES_PASSWORD}"

# 推荐：使用keystore
password => "${ES_PASSWORD:default_password}"
```

### 4.2 SSL/TLS加密连接


**为什么需要SSL**：保护数据在网络传输过程中不被窃取或篡改。

```ruby
# 基础SSL配置
output {
  elasticsearch {
    hosts => ["https://es-server:9200"]    # 注意使用https
    ssl => true                            # 启用SSL
    ssl_certificate_verification => true   # 验证证书
    cacert => "/path/to/ca.crt"           # CA证书路径
  }
}
```

**SSL配置参数说明**：

| 🔸 **参数名** | **作用** | **推荐值** |
|--------------|---------|-----------|
| `ssl` | 是否启用SSL | `true` |
| `ssl_certificate_verification` | 是否验证证书 | `true`（生产环境） |
| `cacert` | CA证书文件路径 | 具体路径 |

### 4.3 ca_file参数详解


**ca_file的作用**：就像身份证验证一样，确认ES服务器是可信的。

```ruby
output {
  elasticsearch {
    hosts => ["https://es-cluster:9200"]
    ssl => true
    ca_file => "/etc/logstash/certs/ca.crt"  # CA证书文件
    user => "logstash_user"
    password => "${LOGSTASH_PASSWORD}"
  }
}
```

**证书文件获取方式**：
```
1️⃣ 从ES管理员那里获取ca.crt文件
2️⃣ 放到Logstash服务器的安全目录
3️⃣ 配置文件中写上完整路径
```

---

## 5. 📄 模板配置


### 5.1 什么是索引模板


**通俗解释**：索引模板就像一个"装修方案"，告诉ES新创建的索引应该按什么格式来设计。

```
类比理解：
索引模板 = 房屋装修图纸
新索引 = 按图纸装修的房子
数据字段 = 房间里的家具摆放
```

### 5.2 template参数 - 指定模板内容


```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    template => "/etc/logstash/templates/logstash-template.json"
    template_name => "logstash-logs"
  }
}
```

**模板文件示例** (`logstash-template.json`)：
```json
{
  "index_patterns": ["logs-*"],
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "@timestamp": {
        "type": "date"
      },
      "message": {
        "type": "text"
      },
      "level": {
        "type": "keyword"
      }
    }
  }
}
```

### 5.3 template_name参数 - 模板名称


**作用**：给模板起个名字，方便管理。

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "nginx-logs-%{+YYYY.MM.dd}"
    template_name => "nginx-logs-template"    # 模板名称
    template => "/etc/logstash/nginx-template.json"
    template_overwrite => true               # 覆盖已存在的模板
  }
}
```

**模板管理最佳实践**：
- 🔸 **命名规范**：模板名要能体现用途
- 🔸 **版本控制**：模板文件要做版本管理
- 🔸 **测试验证**：新模板先在测试环境验证

---

## 6. ⚡ 性能优化配置


### 6.1 批量处理配置


**为什么要批量处理**：一次发送多条数据比一条一条发送效率更高，就像批发比零售便宜一样。

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    
    # 批量处理配置
    flush_size => 1000              # 1000条数据批量发送一次
    idle_flush_time => 10           # 10秒内没有新数据也发送
  }
}
```

### 6.2 性能参数对比


| 🔸 **参数名** | **默认值** | **推荐值** | **作用说明** |
|--------------|-----------|-----------|-------------|
| `flush_size` | 500 | 1000-5000 | 🟢 批量大小，数据量大可调高 |
| `idle_flush_time` | 1 | 5-10 | 🟡 空闲等待时间（秒） |
| `workers` | 1 | 2-4 | 🔴 并发工作线程数 |

### 6.3 高性能配置示例


```ruby
# 高吞吐量配置
output {
  elasticsearch {
    hosts => [
      "es-node1:9200",
      "es-node2:9200", 
      "es-node3:9200"
    ]
    index => "high-volume-logs-%{+YYYY.MM.dd}"
    
    # 性能优化参数
    flush_size => 5000
    idle_flush_time => 5
    workers => 4
    
    # 重试配置
    retry_on_conflict => 3
    retry_max_interval => 5
  }
}
```

---

## 7. 📝 完整配置示例


### 7.1 基础生产环境配置


```ruby
output {
  elasticsearch {
    # 基础连接
    hosts => [
      "es-prod1.company.com:9200",
      "es-prod2.company.com:9200",
      "es-prod3.company.com:9200"
    ]
    
    # 索引配置
    index => "application-logs-%{+YYYY.MM.dd}"
    
    # 安全认证
    user => "logstash_writer"
    password => "${ELASTICSEARCH_PASSWORD}"
    ssl => true
    ca_file => "/etc/logstash/certs/elasticsearch-ca.pem"
    
    # 模板配置
    template_name => "application-logs-template"
    template => "/etc/logstash/templates/app-logs.json"
    template_overwrite => false
    
    # 性能优化
    flush_size => 2000
    idle_flush_time => 10
    workers => 2
    
    # 错误处理
    retry_on_conflict => 3
    retry_max_interval => 5
  }
}
```

### 7.2 开发测试环境配置


```ruby
output {
  elasticsearch {
    # 简单连接
    hosts => ["localhost:9200"]
    
    # 索引配置
    index => "dev-logs-%{+YYYY.MM.dd}"
    
    # 基础性能
    flush_size => 500
    idle_flush_time => 5
  }
}
```

### 7.3 多环境配置切换


```ruby
output {
  if [environment] == "production" {
    elasticsearch {
      hosts => ["es-prod1:9200", "es-prod2:9200"]
      index => "prod-logs-%{+YYYY.MM.dd}"
      user => "${PROD_ES_USER}"
      password => "${PROD_ES_PASSWORD}"
      ssl => true
    }
  } else {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "dev-logs-%{+YYYY.MM.dd}"
    }
  }
}
```

---

## 8. ❗ 常见问题与解决方案


### 8.1 连接问题


**问题**: 连接ES失败
```
错误信息：Connection refused [Errno 111]
```

**解决步骤**：
```
1️⃣ 检查ES服务是否启动
   $ curl -X GET "localhost:9200"

2️⃣ 检查网络连通性
   $ ping es-server

3️⃣ 检查端口是否开放
   $ telnet es-server 9200

4️⃣ 检查防火墙设置
```

### 8.2 认证问题


**问题**: 认证失败
```
错误信息：[403] Forbidden
```

**解决方案**：
```ruby
# 检查用户名密码是否正确
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    user => "correct_username"        # 确认用户名
    password => "correct_password"    # 确认密码
  }
}
```

### 8.3 SSL证书问题


**问题**: SSL证书验证失败
```
错误信息：SSL certificate verification failed
```

**解决方案**：
```ruby
# 临时禁用证书验证（仅测试用）
output {
  elasticsearch {
    hosts => ["https://es-server:9200"]
    ssl => true
    ssl_certificate_verification => false  # 仅测试环境
  }
}

# 正确配置证书（生产环境）
output {
  elasticsearch {
    hosts => ["https://es-server:9200"]
    ssl => true
    ca_file => "/path/to/correct/ca.crt"   # 正确的证书路径
  }
}
```

### 8.4 性能问题


**问题**: 数据写入太慢

**优化方案**：
```ruby
output {
  elasticsearch {
    hosts => ["es-server:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    
    # 增大批量大小
    flush_size => 5000              # 从500增加到5000
    
    # 增加工作线程
    workers => 4                    # 从1增加到4
    
    # 减少等待时间
    idle_flush_time => 5            # 从10减少到5
  }
}
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心参数


```
🔸 hosts: ES服务器地址，支持集群配置
🔸 index: 索引名称，建议使用日期模式
🔸 user/password: 认证信息，生产环境必须配置
🔸 ssl/ca_file: SSL安全连接配置
🔸 template/template_name: 索引模板配置
```

### 9.2 配置优先级指南


**🟢 基础必配**：
- `hosts` - 服务器地址
- `index` - 索引名称

**🟡 生产必配**：
- `user`/`password` - 认证信息
- `ssl`/`ca_file` - 安全连接
- 性能优化参数

**🔴 高级选配**：
- `document_id` - 特殊需求时配置
- `template` - 自定义字段映射时配置

### 9.3 环境配置建议


**开发环境**：
```ruby
# 简单配置，重点是快速验证功能
hosts => ["localhost:9200"]
index => "dev-logs"
```

**测试环境**：
```ruby
# 接近生产，但可以放宽安全要求
hosts => ["test-es:9200"]
index => "test-logs-%{+YYYY.MM.dd}"
ssl => false  # 可以关闭SSL简化配置
```

**生产环境**：
```ruby
# 完整安全配置，性能优化
hosts => ["es1:9200", "es2:9200", "es3:9200"]
index => "prod-logs-%{+YYYY.MM.dd}"
user => "${ES_USER}"
password => "${ES_PASSWORD}"
ssl => true
ca_file => "/etc/certs/ca.pem"
flush_size => 2000
workers => 2
```

### 9.4 最佳实践checklist


✅ **安全方面**：
- [ ] 生产环境必须启用SSL
- [ ] 用户密码使用环境变量
- [ ] 定期更新证书文件

✅ **性能方面**：
- [ ] 根据数据量调整batch_size
- [ ] 多节点环境配置多个hosts
- [ ] 监控ES集群健康状态

✅ **运维方面**：
- [ ] 索引按时间分割便于管理
- [ ] 配置模板统一字段映射
- [ ] 设置合理的重试机制

**核心记忆**：
- Elasticsearch输出插件是数据的"最后一公里"
- 安全认证在生产环境不可忽视
- 性能调优要结合实际数据量情况
- 模板配置决定了数据存储的效果