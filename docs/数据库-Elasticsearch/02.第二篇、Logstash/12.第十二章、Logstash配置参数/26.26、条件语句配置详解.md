---
title: 26ã€æ¡ä»¶è¯­å¥é…ç½®è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [æ¡ä»¶è¯­å¥åŸºç¡€æ¦‚å¿µ](#1-æ¡ä»¶è¯­å¥åŸºç¡€æ¦‚å¿µ)
2. [ifæ¡ä»¶è¯­å¥è¯­æ³•è¯¦è§£](#2-ifæ¡ä»¶è¯­å¥è¯­æ³•è¯¦è§£)
3. [å­—æ®µåˆ¤æ–­ä¸æ¯”è¾ƒæ“ä½œ](#3-å­—æ®µåˆ¤æ–­ä¸æ¯”è¾ƒæ“ä½œ)
4. [æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…](#4-æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…)
5. [é€»è¾‘è¿ç®—ç¬¦è¯¦è§£](#5-é€»è¾‘è¿ç®—ç¬¦è¯¦è§£)
6. [å¤æ‚æ¡ä»¶ç»„åˆå®æˆ˜](#6-å¤æ‚æ¡ä»¶ç»„åˆå®æˆ˜)
7. [æ¡ä»¶è¯­å¥æœ€ä½³å®è·µ](#7-æ¡ä»¶è¯­å¥æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¡ä»¶è¯­å¥åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¡ä»¶è¯­å¥


**ğŸ”¸ é€šä¿—ç†è§£**
```
æ¡ä»¶è¯­å¥å°±åƒç”Ÿæ´»ä¸­çš„"å¦‚æœ...é‚£ä¹ˆ..."é€»è¾‘ï¼š
- å¦‚æœä»Šå¤©ä¸‹é›¨ï¼Œé‚£ä¹ˆå¸¦é›¨ä¼
- å¦‚æœæ¸©åº¦è¶…è¿‡30åº¦ï¼Œé‚£ä¹ˆå¼€ç©ºè°ƒ

åœ¨Logstashä¸­ï¼š
- å¦‚æœæ—¥å¿—åŒ…å«"ERROR"ï¼Œé‚£ä¹ˆå‘é€åˆ°é”™è¯¯é˜Ÿåˆ—
- å¦‚æœæ¥æºæ˜¯Apacheï¼Œé‚£ä¹ˆç”¨Apacheè§£æå™¨å¤„ç†
```

**ğŸ“‹ æ ¸å¿ƒä½œç”¨**
- **æ™ºèƒ½åˆ†æµ**ï¼šæ ¹æ®ä¸åŒæ¡ä»¶å°†æ•°æ®é€åˆ°ä¸åŒåœ°æ–¹
- **åŠ¨æ€å¤„ç†**ï¼šé’ˆå¯¹ä¸åŒç±»å‹çš„æ•°æ®ä½¿ç”¨ä¸åŒçš„å¤„ç†æ–¹å¼
- **é”™è¯¯æ§åˆ¶**ï¼šåœ¨æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶è·³è¿‡æŸäº›å¤„ç†æ­¥éª¤

### 1.2 æ¡ä»¶è¯­å¥çš„åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯**
```
â”Œâ”€ æ—¥å¿—åˆ†ç±»å¤„ç† â”€â”    â”Œâ”€ é”™è¯¯æ—¥å¿— â†’ å‘Šè­¦ç³»ç»Ÿ
â”‚ æ··åˆæ—¥å¿—è¾“å…¥   â”‚â”€â”€â”€â”€â”¼â”€ è®¿é—®æ—¥å¿— â†’ åˆ†æç³»ç»Ÿ  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€ è°ƒè¯•æ—¥å¿— â†’ å¼€å‘ç¯å¢ƒ

â”Œâ”€ æ•°æ®è´¨é‡æ§åˆ¶ â”€â”    â”Œâ”€ å®Œæ•´æ•°æ® â†’ æ­£å¸¸å¤„ç†
â”‚ åŸå§‹æ•°æ®è¾“å…¥   â”‚â”€â”€â”€â”€â”¼â”€ ç¼ºå¤±å­—æ®µ â†’ è¡¥å……é»˜è®¤å€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€ æ ¼å¼é”™è¯¯ â†’ ä¸¢å¼ƒå¤„ç†
```

> ğŸ’¡ **æ–°æ‰‹ç†è§£**: æ¡ä»¶è¯­å¥è®©Logstashå˜å¾—"èªæ˜"ï¼Œèƒ½å¤Ÿåƒäººä¸€æ ·æ ¹æ®ä¸åŒæƒ…å†µåšå‡ºä¸åŒçš„å†³ç­–

---

## 2. ğŸ“ ifæ¡ä»¶è¯­å¥è¯­æ³•è¯¦è§£


### 2.1 åŸºæœ¬ifè¯­æ³•ç»“æ„


**ğŸ”¸ åŸºç¡€è¯­æ³•æ ¼å¼**
```ruby
# æœ€ç®€å•çš„ifè¯­å¥
if [å­—æ®µå] {
  # å½“å­—æ®µå­˜åœ¨æ—¶æ‰§è¡Œçš„æ“ä½œ
}

# å®Œæ•´çš„if-elseç»“æ„
if æ¡ä»¶ {
  # æ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œ
} else if å¦ä¸€ä¸ªæ¡ä»¶ {
  # ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸ºå‡ï¼Œç¬¬äºŒä¸ªæ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œ
} else {
  # æ‰€æœ‰æ¡ä»¶éƒ½ä¸ºå‡æ—¶æ‰§è¡Œ
}
```

**ğŸ“– å®é™…åº”ç”¨ç¤ºä¾‹**
```ruby
filter {
  # æ£€æŸ¥æ—¥å¿—çº§åˆ«ï¼Œå†³å®šå¦‚ä½•å¤„ç†
  if [level] == "ERROR" {
    # é”™è¯¯æ—¥å¿—åŠ ä¸Šç´§æ€¥æ ‡ç­¾
    mutate {
      add_tag => ["urgent", "needs_attention"]
    }
  } else if [level] == "WARN" {
    # è­¦å‘Šæ—¥å¿—åŠ ä¸Šç›‘æ§æ ‡ç­¾
    mutate {
      add_tag => ["monitor"]
    }
  } else {
    # æ™®é€šæ—¥å¿—åŠ ä¸Šå¸¸è§„æ ‡ç­¾
    mutate {
      add_tag => ["normal"]
    }
  }
}
```

### 2.2 æ¡ä»¶è¯­å¥çš„æ‰§è¡Œä½ç½®


**ğŸ—ï¸ åœ¨ä¸åŒé˜¶æ®µä½¿ç”¨æ¡ä»¶è¯­å¥**
```ruby
# Inputé˜¶æ®µçš„æ¡ä»¶åˆ¤æ–­ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰
input {
  if [source] == "app1" {
    file {
      path => "/var/log/app1/*.log"
    }
  }
}

# Filteré˜¶æ®µçš„æ¡ä»¶åˆ¤æ–­ï¼ˆæœ€å¸¸ç”¨ï¼‰
filter {
  if [type] == "apache" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
  }
}

# Outputé˜¶æ®µçš„æ¡ä»¶åˆ¤æ–­ï¼ˆå¾ˆå¸¸ç”¨ï¼‰
output {
  if [level] == "ERROR" {
    elasticsearch {
      index => "errors-%{+YYYY.MM.dd}"
    }
  } else {
    elasticsearch {
      index => "logs-%{+YYYY.MM.dd}"
    }
  }
}
```

> âš ï¸ **é‡è¦æé†’**: æ¡ä»¶è¯­å¥åœ¨Filteré˜¶æ®µæœ€å¸¸ç”¨ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æ•°æ®å¤„ç†å’Œè½¬æ¢çš„ä¸»è¦åœºæ‰€

---

## 3. ğŸ” å­—æ®µåˆ¤æ–­ä¸æ¯”è¾ƒæ“ä½œ


### 3.1 å­—æ®µå­˜åœ¨æ€§åˆ¤æ–­


**ğŸ”¸ æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨**
```ruby
# åŸºæœ¬è¯­æ³•ï¼š[field] è¡¨ç¤ºå­—æ®µå­˜åœ¨ä¸”ä¸ä¸ºç©º
if [username] {
  # usernameå­—æ®µå­˜åœ¨æ—¶æ‰§è¡Œ
  mutate {
    add_field => { "has_user" => "true" }
  }
}

# æ£€æŸ¥å­—æ®µä¸å­˜åœ¨
if ![email] {
  # emailå­—æ®µä¸å­˜åœ¨æ—¶æ‰§è¡Œ
  mutate {
    add_field => { "email" => "unknown@example.com" }
  }
}
```

**ğŸ“Š å®æˆ˜æ¡ˆä¾‹ï¼šå¤„ç†å¯é€‰å­—æ®µ**
```ruby
filter {
  # å¤„ç†ç”¨æˆ·æ³¨å†Œæ—¥å¿—ï¼Œemailæ˜¯å¯é€‰å­—æ®µ
  if [user_type] == "registration" {
    if [email] {
      # å¦‚æœæœ‰é‚®ç®±ï¼ŒéªŒè¯æ ¼å¼
      if [email] =~ /@/ {
        mutate { add_tag => ["valid_email"] }
      } else {
        mutate { add_tag => ["invalid_email"] }
      }
    } else {
      # å¦‚æœæ²¡æœ‰é‚®ç®±ï¼Œæ ‡è®°ä¸ºåŒ¿åç”¨æˆ·
      mutate {
        add_field => { "email" => "anonymous" }
        add_tag => ["anonymous_user"]
      }
    }
  }
}
```

### 3.2 å­—æ®µå€¼æ¯”è¾ƒæ“ä½œ


**ğŸ”¸ æ•°å€¼æ¯”è¾ƒè¿ç®—ç¬¦**
```ruby
# ç­‰äºæ¯”è¾ƒ
if [status_code] == 200 {
  mutate { add_tag => ["success"] }
}

# ä¸ç­‰äºæ¯”è¾ƒ
if [status_code] != 200 {
  mutate { add_tag => ["non_success"] }
}

# æ•°å€¼å¤§å°æ¯”è¾ƒ
if [response_time] > 1000 {
  mutate { add_tag => ["slow_response"] }
}

if [user_age] >= 18 {
  mutate { add_tag => ["adult"] }
}

# å­—ç¬¦ä¸²æ¯”è¾ƒ
if [log_level] == "DEBUG" {
  drop { }  # ä¸¢å¼ƒè°ƒè¯•æ—¥å¿—
}
```

**ğŸ“‹ æ¯”è¾ƒè¿ç®—ç¬¦å®Œæ•´åˆ—è¡¨**
```
==  ç­‰äº
!=  ä¸ç­‰äº
<   å°äº
<=  å°äºç­‰äº
>   å¤§äº
>=  å¤§äºç­‰äº
=~  æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
!~  æ­£åˆ™è¡¨è¾¾å¼ä¸åŒ¹é…
in  åŒ…å«åœ¨æ•°ç»„ä¸­
not in  ä¸åŒ…å«åœ¨æ•°ç»„ä¸­
```

### 3.3 inæ“ä½œç¬¦çš„ä½¿ç”¨


**ğŸ”¸ æ£€æŸ¥å€¼æ˜¯å¦åœ¨æŒ‡å®šåˆ—è¡¨ä¸­**
```ruby
# æ£€æŸ¥çŠ¶æ€ç æ˜¯å¦ä¸ºå®¢æˆ·ç«¯é”™è¯¯
if [status_code] in [400, 401, 403, 404] {
  mutate {
    add_field => { "error_type" => "client_error" }
    add_tag => ["4xx_error"]
  }
}

# æ£€æŸ¥æ—¥å¿—æ¥æºæ˜¯å¦ä¸ºé‡è¦æœåŠ¡
if [service_name] in ["user-service", "payment-service", "order-service"] {
  mutate {
    add_field => { "priority" => "high" }
    add_tag => ["critical_service"]
  }
}

# å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ä½¿ç”¨inæ“ä½œ
if [log_level] in ["ERROR", "FATAL", "CRITICAL"] {
  # ä¸¥é‡é”™è¯¯æ—¥å¿—çš„å¤„ç†
  mutate { add_tag => ["severe_error"] }
}
```

---

## 4. ğŸ¨ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…


### 4.1 æ­£åˆ™åŒ¹é…åŸºç¡€è¯­æ³•


**ğŸ”¸ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç¬¦å·**
```ruby
# =~ è¡¨ç¤ºåŒ¹é…
if [message] =~ /ERROR/ {
  # æ¶ˆæ¯ä¸­åŒ…å«ERRORå­—æ ·
  mutate { add_tag => ["has_error"] }
}

# !~ è¡¨ç¤ºä¸åŒ¹é…
if [user_agent] !~ /bot|crawler|spider/i {
  # ä¸æ˜¯æœºå™¨äººè®¿é—®
  mutate { add_tag => ["human_visitor"] }
}
```

**ğŸ’¡ æ­£åˆ™è¡¨è¾¾å¼æ ‡å¿—è¯´æ˜**
```ruby
# i æ ‡å¿—ï¼šå¿½ç•¥å¤§å°å†™
if [message] =~ /error/i {
  # åŒ¹é… ERRORã€Errorã€error ç­‰
}

# m æ ‡å¿—ï¼šå¤šè¡Œæ¨¡å¼
if [message] =~ /^ERROR/m {
  # åŒ¹é…ä»¥ERRORå¼€å¤´çš„è¡Œ
}
```

### 4.2 å¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼


**ğŸ” å®ç”¨æ­£åˆ™è¡¨è¾¾å¼ç¤ºä¾‹**
```ruby
filter {
  # åŒ¹é…IPåœ°å€
  if [client_ip] =~ /^192\.168\./ {
    mutate { add_tag => ["internal_network"] }
  }
  
  # åŒ¹é…é‚®ç®±æ ¼å¼
  if [email] =~ /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/ {
    mutate { add_tag => ["valid_email_format"] }
  }
  
  # åŒ¹é…æ‰‹æœºå·ï¼ˆç®€å•æ¨¡å¼ï¼‰
  if [phone] =~ /^1[3-9]\d{9}$/ {
    mutate { add_tag => ["valid_mobile"] }
  }
  
  # åŒ¹é…åŒ…å«SQLæ³¨å…¥ç‰¹å¾
  if [request_uri] =~ /(union|select|insert|update|delete|drop)/i {
    mutate { 
      add_tag => ["potential_sql_injection"]
      add_field => { "security_alert" => "true" }
    }
  }
}
```

### 4.3 å¤æ‚æ­£åˆ™åŒ¹é…åœºæ™¯


**ğŸ¯ å¤šæ¡ä»¶æ­£åˆ™ç»„åˆ**
```ruby
filter {
  # è¯†åˆ«ä¸åŒç±»å‹çš„å¼‚å¸¸
  if [stack_trace] =~ /java\.lang\.NullPointerException/ {
    mutate {
      add_field => { "exception_type" => "NullPointer" }
      add_tag => ["java_exception", "null_pointer"]
    }
  } else if [stack_trace] =~ /java\.sql\.SQLException/ {
    mutate {
      add_field => { "exception_type" => "Database" }
      add_tag => ["java_exception", "database_error"]
    }
  } else if [stack_trace] =~ /java\.net\.ConnectException/ {
    mutate {
      add_field => { "exception_type" => "Connection" }
      add_tag => ["java_exception", "connection_error"]
    }
  }
}
```

---

## 5. âš¡ é€»è¾‘è¿ç®—ç¬¦è¯¦è§£


### 5.1 andé€»è¾‘è¿ç®—


**ğŸ”¸ andè¿ç®—ç¬¦ï¼šæ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»ä¸ºçœŸ**
```ruby
# åŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶
if [status_code] >= 400 and [status_code] < 500 {
  mutate {
    add_field => { "error_category" => "client_error" }
    add_tag => ["4xx_error"]
  }
}

# å¤æ‚æ¡ä»¶ç»„åˆ
if [service] == "user-api" and [response_time] > 2000 and [status_code] == 200 {
  mutate {
    add_field => { "performance_issue" => "slow_but_successful" }
    add_tag => ["performance_warning"]
  }
}
```

**ğŸ“Š å®æˆ˜æ¡ˆä¾‹ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ**
```ruby
filter {
  # è¯†åˆ«å¯ç–‘çš„ç”¨æˆ·è¡Œä¸º
  if [request_count] > 100 and [time_window] < 60 and [user_type] == "guest" {
    mutate {
      add_field => { "risk_level" => "high" }
      add_tag => ["potential_abuse", "rate_limit_candidate"]
    }
  }
}
```

### 5.2 oré€»è¾‘è¿ç®—


**ğŸ”¸ orè¿ç®—ç¬¦ï¼šä»»ä¸€æ¡ä»¶ä¸ºçœŸå³å¯**
```ruby
# æ•è·æ‰€æœ‰é”™è¯¯çº§åˆ«çš„æ—¥å¿—
if [level] == "ERROR" or [level] == "FATAL" or [level] == "CRITICAL" {
  mutate { add_tag => ["error_log"] }
}

# è¯†åˆ«ç§»åŠ¨è®¾å¤‡è®¿é—®
if [user_agent] =~ /iPhone/i or [user_agent] =~ /Android/i or [user_agent] =~ /Mobile/i {
  mutate {
    add_field => { "device_type" => "mobile" }
    add_tag => ["mobile_access"]
  }
}
```

### 5.3 noté€»è¾‘è¿ç®—


**ğŸ”¸ notè¿ç®—ç¬¦ï¼šæ¡ä»¶å–å**
```ruby
# æ’é™¤æˆåŠŸçš„è¯·æ±‚
if not [status_code] == 200 {
  mutate { add_tag => ["non_success"] }
}

# æ’é™¤å†…ç½‘è®¿é—®
if not [client_ip] =~ /^(192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01]))/ {
  mutate { add_tag => ["external_access"] }
}
```

### 5.4 å¤æ‚é€»è¾‘ç»„åˆ


**ğŸ¯ ä½¿ç”¨æ‹¬å·æ§åˆ¶è¿ç®—ä¼˜å…ˆçº§**
```ruby
filter {
  # å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
  if ([level] == "ERROR" or [level] == "WARN") and [service] in ["payment", "order"] {
    # æ”¯ä»˜æˆ–è®¢å•æœåŠ¡çš„é”™è¯¯/è­¦å‘Šæ—¥å¿—
    mutate {
      add_field => { "business_impact" => "high" }
      add_tag => ["business_critical"]
    }
  }
  
  # å®‰å…¨ç›¸å…³çš„å¤æ‚åˆ¤æ–­
  if ([status_code] == 401 or [status_code] == 403) and not [user_type] == "bot" {
    # çœŸå®ç”¨æˆ·çš„è®¤è¯å¤±è´¥
    mutate {
      add_field => { "security_event" => "auth_failure" }
      add_tag => ["security_alert"]
    }
  }
}
```

---

## 6. ğŸš€ å¤æ‚æ¡ä»¶ç»„åˆå®æˆ˜


### 6.1 å¤šå±‚åµŒå¥—æ¡ä»¶ç»“æ„


**ğŸ—ï¸ å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘**
```ruby
filter {
  # æ ¹æ®ä¸åŒæœåŠ¡ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
  if [service_type] == "web" {
    if [path] =~ /^\/api\// {
      # APIè¯·æ±‚çš„å¤„ç†
      if [method] == "POST" and [status_code] >= 400 {
        mutate {
          add_field => { "issue_type" => "api_post_error" }
          add_tag => ["api_error", "post_failure"]
        }
      } else if [response_time] > 5000 {
        mutate {
          add_field => { "issue_type" => "api_slow_response" }
          add_tag => ["performance_issue"]
        }
      }
    } else {
      # é™æ€èµ„æºè¯·æ±‚çš„å¤„ç†
      if [status_code] == 404 {
        mutate { add_tag => ["missing_resource"] }
      }
    }
  } else if [service_type] == "database" {
    # æ•°æ®åº“æ—¥å¿—çš„å¤„ç†
    if [query_time] > 1000 {
      mutate { add_tag => ["slow_query"] }
    }
  }
}
```

### 6.2 æ¡ä»¶åˆ¤æ–­ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–çš„æ¡ä»¶æ’åº**
```ruby
filter {
  # å…ˆåˆ¤æ–­æœ€å¸¸è§çš„æ¡ä»¶ï¼Œæé«˜å¤„ç†æ•ˆç‡
  if [level] == "INFO" {
    # å¤§éƒ¨åˆ†æ˜¯INFOçº§åˆ«æ—¥å¿—ï¼Œä¼˜å…ˆå¤„ç†
    mutate { add_tag => ["info_log"] }
  } else if [level] == "ERROR" {
    # é”™è¯¯æ—¥å¿—éœ€è¦ç‰¹æ®Šå¤„ç†
    if [service] in ["payment", "user", "order"] {
      # å…³é”®æœåŠ¡çš„é”™è¯¯
      mutate {
        add_field => { "priority" => "critical" }
        add_tag => ["critical_error"]
      }
    } else {
      # æ™®é€šæœåŠ¡çš„é”™è¯¯
      mutate { add_tag => ["general_error"] }
    }
  }
}
```

### 6.3 æ¡ä»¶åˆ¤æ–­ä¸å­—æ®µæ“ä½œç»“åˆ


**ğŸ”§ åŠ¨æ€å­—æ®µå¤„ç†**
```ruby
filter {
  # æ ¹æ®æ¡ä»¶åŠ¨æ€æ·»åŠ å­—æ®µ
  if [request_id] {
    # å¦‚æœæœ‰è¯·æ±‚IDï¼Œæ·»åŠ è¿½è¸ªä¿¡æ¯
    mutate {
      add_field => { "traceable" => "true" }
    }
    
    if [user_id] {
      # å¦‚æœåŒæ—¶æœ‰ç”¨æˆ·IDï¼Œå»ºç«‹å…³è”
      mutate {
        add_field => { "user_request" => "%{user_id}_%{request_id}" }
      }
    }
  }
  
  # æ ¹æ®æ¡ä»¶æ¸…ç†å­—æ®µ
  if [debug_info] and [environment] != "development" {
    # ç”Ÿäº§ç¯å¢ƒåˆ é™¤è°ƒè¯•ä¿¡æ¯
    mutate {
      remove_field => ["debug_info", "internal_trace"]
    }
  }
}
```

---

## 7. ğŸ¯ æ¡ä»¶è¯­å¥æœ€ä½³å®è·µ


### 7.1 å¯è¯»æ€§ä¼˜åŒ–


**ğŸ“ ä»£ç ç»„ç»‡å»ºè®®**
```ruby
filter {
  # âœ… å¥½çš„åšæ³•ï¼šæ¡ä»¶æ¸…æ™°ï¼Œé€»è¾‘ç®€å•
  if [service] == "user-api" {
    if [endpoint] == "/login" {
      mutate { add_tag => ["login_attempt"] }
    } else if [endpoint] == "/register" {
      mutate { add_tag => ["registration_attempt"] }
    }
  }
  
  # âŒ é¿å…çš„åšæ³•ï¼šæ¡ä»¶è¿‡äºå¤æ‚
  # if ([service] == "user-api" and [endpoint] == "/login" and [status_code] == 200) or ([service] == "user-api" and [endpoint] == "/register" and [user_type] == "new") { ... }
}
```

### 7.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**âš¡ æ¡ä»¶åˆ¤æ–­ä¼˜åŒ–**
```ruby
filter {
  # âœ… å…ˆæ£€æŸ¥é«˜é¢‘æ¡ä»¶
  if [level] == "INFO" {
    # å¤„ç†æœ€å¸¸è§çš„INFOæ—¥å¿—
  } else if [level] == "ERROR" {
    # å¤„ç†ç›¸å¯¹å°‘è§çš„é”™è¯¯æ—¥å¿—
  }
  
  # âœ… ä½¿ç”¨å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥é¿å…é”™è¯¯
  if [user_id] and [user_id] != "" {
    # ç¡®ä¿å­—æ®µå­˜åœ¨ä¸”ä¸ä¸ºç©º
    mutate { add_tag => ["authenticated"] }
  }
  
  # âœ… åˆç†ä½¿ç”¨inæ“ä½œç¬¦
  if [status_code] in [200, 201, 202] {
    mutate { add_tag => ["success"] }
  }
}
```

### 7.3 é”™è¯¯å¤„ç†å’Œè°ƒè¯•


**ğŸ” è°ƒè¯•æ¡ä»¶è¯­å¥**
```ruby
filter {
  # æ·»åŠ è°ƒè¯•ä¿¡æ¯
  if [debug] == "true" {
    mutate {
      add_field => { 
        "debug_info" => "Processing event: %{service} - %{level}"
      }
    }
  }
  
  # å¤„ç†å¼‚å¸¸æƒ…å†µ
  if [timestamp] {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      target => "@timestamp"
    }
  } else {
    # å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
    mutate {
      add_field => { "timestamp_missing" => "true" }
    }
  }
}
```

### 7.4 å¸¸è§é™·é˜±é¿å…


**âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜**
```ruby
filter {
  # âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²å’Œæ•°å­—æ¯”è¾ƒ
  # if [count] > "10" { ... }  # å¯èƒ½å¯¼è‡´æ„å¤–ç»“æœ
  
  # âœ… æ­£ç¡®ï¼šç¡®ä¿ç±»å‹ä¸€è‡´
  if [count] and [count] > 10 {
    mutate { add_tag => ["high_count"] }
  }
  
  # âŒ é”™è¯¯ï¼šä¸æ£€æŸ¥å­—æ®µå­˜åœ¨æ€§
  # if [user_name] == "admin" { ... }  # å¦‚æœå­—æ®µä¸å­˜åœ¨ä¼šæŠ¥é”™
  
  # âœ… æ­£ç¡®ï¼šå…ˆæ£€æŸ¥å­˜åœ¨æ€§
  if [user_name] and [user_name] == "admin" {
    mutate { add_tag => ["admin_user"] }
  }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¡ä»¶è¯­å¥æœ¬è´¨ï¼šè®©Logstashèƒ½å¤Ÿæ™ºèƒ½åœ°æ ¹æ®æ•°æ®å†…å®¹åšå‡ºå¤„ç†å†³ç­–
ğŸ”¸ åŸºæœ¬è¯­æ³•ï¼šif/else if/elseç»“æ„ï¼Œæ”¯æŒåµŒå¥—å’Œå¤æ‚é€»è¾‘
ğŸ”¸ å­—æ®µåˆ¤æ–­ï¼š[field]æ£€æŸ¥å­˜åœ¨æ€§ï¼Œæ¯”è¾ƒè¿ç®—ç¬¦æ£€æŸ¥å€¼
ğŸ”¸ æ­£åˆ™åŒ¹é…ï¼š=~ å’Œ !~ ç”¨äºæ¨¡å¼åŒ¹é…
ğŸ”¸ é€»è¾‘è¿ç®—ï¼šandã€orã€notå’Œæ‹¬å·æ§åˆ¶ä¼˜å…ˆçº§
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šæ•°æ®åˆ†æµã€é”™è¯¯å¤„ç†ã€åŠ¨æ€å­—æ®µæ“ä½œ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¡ä»¶è¯­å¥çš„æ‰§è¡Œæ—¶æœº**
```
Inputé˜¶æ®µï¼šè¾ƒå°‘ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºè¾“å…¥æºé€‰æ‹©
Filteré˜¶æ®µï¼šæœ€å¸¸ç”¨ï¼Œæ•°æ®å¤„ç†å’Œè½¬æ¢çš„æ ¸å¿ƒ
Outputé˜¶æ®µï¼šå¸¸ç”¨ï¼Œæ ¹æ®æ¡ä»¶å†³å®šè¾“å‡ºç›®æ ‡
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
å…ˆåˆ¤æ–­é«˜é¢‘æ¡ä»¶ï¼šæé«˜æ•´ä½“å¤„ç†æ•ˆç‡
é¿å…è¿‡åº¦åµŒå¥—ï¼šä¿æŒé€»è¾‘æ¸…æ™°ç®€å•
åˆç†ä½¿ç”¨è¿ç®—ç¬¦ï¼šé€‰æ‹©æœ€åˆé€‚çš„æ¯”è¾ƒæ–¹å¼
å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥ï¼šé¿å…å› å­—æ®µä¸å­˜åœ¨å¯¼è‡´çš„é”™è¯¯
```

**ğŸ”¹ å¸¸ç”¨æ¡ä»¶æ¨¡å¼**
```
å­˜åœ¨æ€§åˆ¤æ–­ï¼šif [field] { ... }
å€¼æ¯”è¾ƒï¼šif [field] == "value" { ... }
èŒƒå›´åˆ¤æ–­ï¼šif [field] > 100 and [field] < 1000 { ... }
æ¨¡å¼åŒ¹é…ï¼šif [field] =~ /pattern/ { ... }
åˆ—è¡¨åŒ…å«ï¼šif [field] in ["a", "b", "c"] { ... }
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **æ—¥å¿—åˆ†ç±»**ï¼šæ ¹æ®æ—¥å¿—çº§åˆ«ã€æ¥æºã€ç±»å‹è¿›è¡Œæ™ºèƒ½åˆ†ç±»
- **å¼‚å¸¸æ£€æµ‹**ï¼šè¯†åˆ«é”™è¯¯ã€æ€§èƒ½é—®é¢˜ã€å®‰å…¨å¨èƒ
- **æ•°æ®è´¨é‡**ï¼šå¤„ç†ç¼ºå¤±å­—æ®µã€æ ¼å¼é”™è¯¯ã€å¼‚å¸¸å€¼
- **ä¸šåŠ¡åˆ†æ**ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€æ€§èƒ½ç›‘æ§ã€ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—

**ğŸ”§ æŠ€æœ¯å®è·µ**
- **é…ç½®ç®¡ç†**ï¼šå°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘è½¬åŒ–ä¸ºæ¸…æ™°çš„é…ç½®
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡æ¡ä»¶åˆ¤æ–­å‡å°‘ä¸å¿…è¦çš„å¤„ç†
- **é”™è¯¯å¤„ç†**ï¼šä¼˜é›…åœ°å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- **è°ƒè¯•æ”¯æŒ**ï¼šæ·»åŠ è°ƒè¯•ä¿¡æ¯å¸®åŠ©é—®é¢˜å®šä½

**ğŸ’¡ å­¦ä¹ å»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬çš„if/elseè¯­æ³•
- **å¤šåšç»ƒä¹ **ï¼šé€šè¿‡å®é™…æ¡ˆä¾‹åŠ æ·±ç†è§£
- **æ³¨æ„ç»†èŠ‚**ï¼šå­—æ®µå­˜åœ¨æ€§ã€ç±»å‹åŒ¹é…ã€æ€§èƒ½å½±å“
- **é€æ­¥å¤æ‚**ï¼šä»ç®€å•æ¡ä»¶åˆ°å¤æ‚é€»è¾‘ç»„åˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ¡ä»¶åˆ¤æ–­æ§åˆ¶æµï¼Œif-elseåˆ†æ”¯è¦æ¸…æ¥š
- å­—æ®µå­˜åœ¨å…ˆæ£€æŸ¥ï¼Œæ¯”è¾ƒè¿ç®—è¦å‡†ç¡®  
- æ­£åˆ™åŒ¹é…åŠŸèƒ½å¼ºï¼Œé€»è¾‘è¿ç®—ç»„åˆæ£’
- æ€§èƒ½ä¼˜åŒ–å¾ˆé‡è¦ï¼Œç®€å•æ¸…æ™°æ˜¯ç‹é“