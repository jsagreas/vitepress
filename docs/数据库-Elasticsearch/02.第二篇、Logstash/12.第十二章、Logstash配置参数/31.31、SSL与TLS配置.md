---
title: 31、SSL与TLS配置
---
## 📚 目录

1. [SSL/TLS基础概念](#1-ssltls基础概念)
2. [证书文件配置](#2-证书文件配置)
3. [私钥文件设置](#3-私钥文件设置)
4. [CA证书验证](#4-ca证书验证)
5. [客户端证书认证](#5-客户端证书认证)
6. [SSL协议版本选择](#6-ssl协议版本选择)
7. [加密套件配置](#7-加密套件配置)
8. [实际应用场景](#8-实际应用场景)
9. [故障排查指南](#9-故障排查指南)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔐 SSL/TLS基础概念


### 1.1 什么是SSL/TLS


> 💡 **通俗理解**  
> SSL/TLS就像给数据传输加了一个**密码信封**，确保数据在网络中传输时不被偷看或篡改

**核心概念解释**：
```
SSL (Secure Sockets Layer) - 安全套接层
TLS (Transport Layer Security) - 传输层安全协议

简单理解：
🔓 没有SSL/TLS：数据明文传输，就像明信片，谁都能看到
🔐 有了SSL/TLS：数据加密传输，就像密封信件，只有收件人能看到
```

### 1.2 在Logstash中的作用


**为什么Logstash需要SSL/TLS？**
```
数据安全场景：
📊 日志数据可能包含敏感信息：用户行为、系统状态、错误信息
🌐 网络传输过程中可能被窃听
🏢 企业环境要求数据传输必须加密
🔒 合规要求：GDPR、SOX等法规要求数据保护
```

**实际应用示例**：
```
场景1：从Web服务器收集日志
Web服务器 ──[加密传输]──> Logstash ──> Elasticsearch

场景2：向远程Elasticsearch发送数据  
Logstash ──[HTTPS]──> 远程Elasticsearch集群

场景3：接收来自Beats的数据
Filebeat/Metricbeat ──[SSL]──> Logstash
```

---

## 2. 📜 证书文件配置


### 2.1 证书文件基础知识


> 📖 **证书简单理解**  
> 数字证书就像**身份证**，证明"我就是我"，防止有人冒充

**证书文件类型详解**：
```
常见证书格式：
.pem  ← 最常用，文本格式，可以直接查看
.crt  ← 证书文件，通常是PEM格式
.cer  ← 证书文件，可能是PEM或DER格式
.p12  ← PKCS#12格式，包含证书和私钥
.jks  ← Java密钥库格式
```

### 2.2 证书文件配置实例


**Input插件中的证书配置**：
```ruby
input {
  beats {
    port => 5044
    # 服务器证书文件路径
    ssl_certificate => "/etc/logstash/certs/logstash.crt"
    ssl_key => "/etc/logstash/certs/logstash.key"
    ssl => true
  }
}
```

**Output插件中的证书配置**：
```ruby
output {
  elasticsearch {
    hosts => ["https://es-node1:9200"]
    # 客户端证书配置
    ssl_certificate => "/etc/logstash/certs/client.crt"
    ssl_key => "/etc/logstash/certs/client.key"
    # CA证书配置
    cacert => "/etc/logstash/certs/ca.crt"
  }
}
```

### 2.3 证书文件获取方式


**🔧 三种主要获取方式**：

**方式1：自签名证书（测试环境）**
```bash
# 生成私钥
openssl genrsa -out logstash.key 2048

# 生成证书
openssl req -new -x509 -key logstash.key -out logstash.crt -days 365
```

**方式2：权威CA证书（生产环境）**
```
📋 购买步骤：
1. 从权威CA机构购买（如DigiCert、Let's Encrypt）
2. 生成CSR（证书签名请求）
3. 提交给CA进行验证
4. 下载签发的证书
```

**方式3：企业内部CA**
```
🏢 企业环境：
1. 使用企业内部PKI系统
2. 从企业CA服务器申请证书
3. 自动化证书管理和更新
```

---

## 3. 🔑 私钥文件设置


### 3.1 私钥基础概念


> 🔐 **私钥通俗理解**  
> 私钥就像**开锁的钥匙**，必须严格保密，只有拥有私钥才能解密对应的数据

**私钥的重要性**：
```
安全原理：
🔑 私钥 + 公钥 = 密钥对
📤 公钥：可以公开，用于加密数据
📥 私钥：必须保密，用于解密数据

实际作用：
✅ 证明身份：只有拥有私钥的人才是真正的所有者
✅ 解密数据：解密别人用公钥加密的数据
✅ 数字签名：证明数据确实来自私钥拥有者
```

### 3.2 私钥文件配置


**基本私钥配置**：
```ruby
input {
  http {
    port => 8080
    ssl => true
    # 私钥文件路径
    ssl_key => "/etc/logstash/ssl/server.key"
    ssl_certificate => "/etc/logstash/ssl/server.crt"
  }
}
```

**带密码保护的私钥**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_key => "/etc/logstash/ssl/server.key"
    # 私钥密码
    ssl_key_passphrase => "your_private_key_password"
    ssl_certificate => "/etc/logstash/ssl/server.crt"
  }
}
```

### 3.3 私钥安全管理


**🔒 私钥安全最佳实践**：

| 安全措施 | **具体操作** | **重要性** |
|---------|------------|-----------|
| **文件权限** | `chmod 600 private.key` | `防止其他用户读取` |
| **所有者设置** | `chown logstash:logstash private.key` | `确保只有logstash用户可访问` |
| **存储位置** | `放在安全目录如/etc/ssl/private/` | `避免意外暴露` |
| **备份加密** | `使用加密备份私钥文件` | `防止备份泄露` |
| **定期轮换** | `定期更换密钥对` | `降低长期风险` |

**私钥文件权限设置示例**：
```bash
# 设置正确的文件权限
sudo chmod 600 /etc/logstash/ssl/server.key
sudo chown logstash:logstash /etc/logstash/ssl/server.key

# 验证权限设置
ls -la /etc/logstash/ssl/server.key
# 应该显示：-rw------- 1 logstash logstash
```

---

## 4. 🏛️ CA证书验证


### 4.1 CA证书概念


> 🏛️ **CA证书通俗理解**  
> CA就像**政府机构**，专门给别人的身份证做认证盖章，大家都信任它的权威性

**CA证书验证流程**：
```
认证链条：
🏛️ 根CA ← 最顶级，所有人都信任
   ↓
🏢 中间CA ← 根CA认证的下级机构  
   ↓
📜 服务器证书 ← 中间CA签发的具体证书

验证过程：
1. 收到服务器证书
2. 检查是否由可信CA签发
3. 验证证书链的完整性
4. 确认证书未过期且未被吊销
```

### 4.2 CA证书配置方式


**方式1：使用系统默认CA证书**
```ruby
output {
  elasticsearch {
    hosts => ["https://es-node1:9200"]
    # 使用系统默认CA证书库
    ssl_certificate_verification => true
  }
}
```

**方式2：指定自定义CA证书**
```ruby
output {
  elasticsearch {
    hosts => ["https://es-node1:9200"]
    # 指定CA证书文件
    cacert => "/etc/logstash/certs/my-ca.crt"
    ssl_certificate_verification => true
  }
}
```

**方式3：禁用CA验证（仅测试环境）**
```ruby
output {
  elasticsearch {
    hosts => ["https://es-node1:9200"]
    # ⚠️ 警告：仅用于测试环境
    ssl_certificate_verification => false
  }
}
```

### 4.3 CA证书验证级别


**🎯 三种验证级别对比**：

| 验证级别 | **安全性** | **适用场景** | **配置难度** |
|---------|-----------|-------------|-------------|
| **完全验证** | `🔒 最高` | `生产环境` | `🔴 复杂` |
| **跳过验证** | `⚠️ 最低` | `开发测试` | `🟢 简单` |
| **自定义验证** | `🔐 中等` | `特殊需求` | `🟡 中等` |

**生产环境推荐配置**：
```ruby
output {
  elasticsearch {
    hosts => ["https://production-es:9200"]
    # 完整安全配置
    cacert => "/etc/logstash/certs/production-ca.crt"
    ssl_certificate_verification => true
    ssl_certificate => "/etc/logstash/certs/logstash-client.crt"
    ssl_key => "/etc/logstash/certs/logstash-client.key"
  }
}
```

---

## 5. 👤 客户端证书认证


### 5.1 客户端证书认证原理


> 🤝 **双向认证通俗理解**  
> 就像**门禁卡系统**，不仅要验证门禁卡是真的，还要验证这张卡确实属于你

**认证类型对比**：
```
单向认证（服务器认证）：
客户端 ──验证服务器身份──> 服务器
例如：浏览器访问HTTPS网站

双向认证（客户端+服务器认证）：
客户端 ←──互相验证身份──→ 服务器  
例如：企业VPN、银行系统
```

### 5.2 客户端证书配置


**Input端接收客户端证书**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # 要求客户端提供证书
    ssl_verify_mode => "force_peer"
    ssl_client_authentication => "required"
    
    # 验证客户端证书的CA
    ssl_certificate_authorities => [
      "/etc/logstash/certs/client-ca.crt"
    ]
  }
}
```

**Output端提供客户端证书**：
```ruby
output {
  elasticsearch {
    hosts => ["https://secure-es:9200"]
    
    # 提供客户端证书进行身份认证
    ssl_certificate => "/etc/logstash/certs/logstash-client.crt"
    ssl_key => "/etc/logstash/certs/logstash-client.key"
    
    # 验证服务器证书
    cacert => "/etc/logstash/certs/server-ca.crt"
  }
}
```

### 5.3 客户端证书验证模式


**🔐 验证模式详解**：

| 验证模式 | **说明** | **安全级别** | **使用场景** |
|---------|---------|-------------|-------------|
| **none** | `不验证客户端证书` | `🔓 低` | `公开服务` |
| **peer** | `验证但不强制` | `🔐 中` | `兼容性要求高` |
| **force_peer** | `强制验证客户端证书` | `🔒 高` | `高安全要求` |

**配置示例**：
```ruby
input {
  http {
    port => 8443
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # 根据安全需求选择验证模式
    ssl_verify_mode => "force_peer"  # 强制验证
    # ssl_verify_mode => "peer"      # 可选验证
    # ssl_verify_mode => "none"      # 不验证
  }
}
```

---

## 6. 🔢 SSL协议版本选择


### 6.1 SSL/TLS版本演进


> 📈 **版本演进通俗理解**  
> 就像**手机系统升级**，新版本修复了旧版本的安全漏洞，功能更强大

**版本历史与安全性**：
```
🔴 SSL 2.0 (1995) ← 已废弃，严重安全漏洞
🔴 SSL 3.0 (1996) ← 已废弃，POODLE攻击
🟡 TLS 1.0 (1999) ← 不推荐，存在安全问题
🟡 TLS 1.1 (2006) ← 不推荐，CBC攻击风险
🟢 TLS 1.2 (2008) ← 推荐使用，主流版本
🟢 TLS 1.3 (2018) ← 最佳选择，最新最安全
```

### 6.2 协议版本配置


**推荐的安全配置**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # 🟢 推荐：只允许TLS 1.2和1.3
    ssl_supported_protocols => ["TLSv1.2", "TLSv1.3"]
  }
}
```

**兼容性配置（不推荐）**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # ⚠️ 为了兼容旧系统，但安全性降低
    ssl_supported_protocols => ["TLSv1.1", "TLSv1.2", "TLSv1.3"]
  }
}
```

### 6.3 版本选择建议


**🎯 不同环境的版本选择策略**：

| 环境类型 | **推荐版本** | **原因** | **配置要点** |
|---------|-------------|---------|-------------|
| **生产环境** | `TLS 1.3优先` | `最高安全性` | `禁用旧版本协议` |
| **测试环境** | `TLS 1.2+` | `平衡安全与兼容` | `可启用多版本测试` |
| **遗留系统** | `TLS 1.2最低` | `兼容性考虑` | `逐步升级计划` |

**检查支持的协议版本**：
```bash
# 测试服务器支持的TLS版本
openssl s_client -connect localhost:5044 -tls1_2
openssl s_client -connect localhost:5044 -tls1_3

# 查看Logstash日志确认使用的协议版本
tail -f /var/log/logstash/logstash-plain.log | grep -i tls
```

---

## 7. 🔐 加密套件配置


### 7.1 加密套件基础概念


> 🔧 **加密套件通俗理解**  
> 加密套件就像**密码锁的规格**，决定了用什么算法、多长的密钥来加密数据

**加密套件组成部分**：
```
完整的加密套件包含四个部分：
🔑 密钥交换算法：如RSA、ECDHE（如何安全交换密钥）
🔏 身份认证算法：如RSA、ECDSA（如何验证身份）
🔐 对称加密算法：如AES（如何加密数据）
🔒 消息认证算法：如SHA256（如何验证数据完整性）

示例：ECDHE-RSA-AES256-GCM-SHA384
↑       ↑   ↑      ↑   ↑
密钥交换 认证 加密算法 模式 哈希
```

### 7.2 加密套件配置实例


**高安全级别配置**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # 🔒 高安全：只允许强加密套件
    ssl_cipher_suites => [
      "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
      "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
      "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
    ]
  }
}
```

**平衡配置（推荐）**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    
    # 🔐 平衡：安全性与兼容性并重
    ssl_cipher_suites => [
      "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384",
      "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
      "TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384",
      "TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256"
    ]
  }
}
```

### 7.3 加密强度对比


**🛡️ 不同加密算法安全性对比**：

| 加密算法 | **密钥长度** | **安全级别** | **性能** | **推荐度** |
|---------|-------------|-------------|---------|-----------|
| **AES-256** | `256位` | `🔒 极高` | `🟢 良好` | `⭐⭐⭐⭐⭐` |
| **AES-128** | `128位` | `🔐 高` | `🟢 优秀` | `⭐⭐⭐⭐` |
| **ChaCha20** | `256位` | `🔒 极高` | `🟢 优秀` | `⭐⭐⭐⭐⭐` |
| **3DES** | `168位` | `🟡 中` | `🔴 较差` | `❌ 不推荐` |

**性能考虑**：
- **AES-256**：最高安全性，CPU开销适中
- **AES-128**：高安全性，性能最佳
- **ChaCha20**：移动设备友好，无硬件加速时性能更好

---

## 8. 🌟 实际应用场景


### 8.1 场景1：ELK Stack内部通信加密


**架构图**：
```
Filebeat ──[TLS]──> Logstash ──[HTTPS]──> Elasticsearch ──[HTTPS]──> Kibana
    |                   |                      |                      |
   Web服务器           数据处理中心            数据存储               数据展示
```

**完整配置示例**：

**Filebeat配置**：
```yaml
output.logstash:
  hosts: ["logstash.company.com:5044"]
  ssl.certificate: "/etc/filebeat/certs/client.crt"
  ssl.key: "/etc/filebeat/certs/client.key"
  ssl.certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
```

**Logstash配置**：
```ruby
input {
  beats {
    port => 5044
    ssl => true
    ssl_certificate => "/etc/logstash/certs/server.crt"
    ssl_key => "/etc/logstash/certs/server.key"
    ssl_certificate_authorities => ["/etc/logstash/certs/ca.crt"]
    ssl_verify_mode => "force_peer"
  }
}

output {
  elasticsearch {
    hosts => ["https://es-node1:9200", "https://es-node2:9200"]
    ssl_certificate => "/etc/logstash/certs/client.crt"
    ssl_key => "/etc/logstash/certs/client.key"
    cacert => "/etc/logstash/certs/ca.crt"
  }
}
```

### 8.2 场景2：跨网络环境数据传输


**应用背景**：
```
🏢 总部Logstash ←──[Internet]──→ 🏭 分支机构Logstash
需要通过公网传输敏感业务日志数据
```

**安全配置要点**：
```ruby
# 总部接收端配置
input {
  http {
    port => 8443
    ssl => true
    ssl_certificate => "/etc/logstash/certs/headquarter.crt"
    ssl_key => "/etc/logstash/certs/headquarter.key"
    
    # 🔒 高安全要求
    ssl_supported_protocols => ["TLSv1.3"]
    ssl_verify_mode => "force_peer"
    ssl_certificate_authorities => ["/etc/logstash/certs/branch-ca.crt"]
    
    # IP白名单
    ssl_peer_metadata => true
  }
}

# 分支机构发送端配置  
output {
  http {
    url => "https://logstash.headquarter.com:8443"
    http_method => "post"
    
    ssl_certificate => "/etc/logstash/certs/branch.crt"
    ssl_key => "/etc/logstash/certs/branch.key"
    cacert => "/etc/logstash/certs/headquarter-ca.crt"
  }
}
```

### 8.3 场景3：云环境混合部署


**部署架构**：
```
🌥️ 云端Elasticsearch
         ↑ [HTTPS]
🏢 本地Logstash集群
         ↑ [TLS]  
💻 各种数据源
```

**云端兼容配置**：
```ruby
output {
  elasticsearch {
    # 云服务商提供的端点
    hosts => ["https://vpc-prod-es-xxx.us-east-1.es.amazonaws.com:443"]
    
    # 云端通常使用权威CA证书
    ssl_certificate_verification => true
    
    # 如果需要客户端证书认证
    ssl_certificate => "/etc/logstash/certs/cloud-client.crt"
    ssl_key => "/etc/logstash/certs/cloud-client.key"
    
    # 云端身份认证
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
  }
}
```

---

## 9. 🔍 故障排查指南


### 9.1 常见SSL错误类型


**🚨 SSL握手失败**：
```
错误信息：SSL handshake failed
可能原因：
❌ 证书过期或无效
❌ 私钥与证书不匹配  
❌ CA证书验证失败
❌ 协议版本不兼容
❌ 加密套件不匹配
```

**🚨 证书验证失败**：
```
错误信息：Certificate verification failed
可能原因：
❌ 证书链不完整
❌ 主机名不匹配
❌ 证书已被吊销
❌ 时间不同步导致证书"未来"生效
```

### 9.2 诊断工具和方法


**🔧 OpenSSL诊断工具**：
```bash
# 测试SSL连接
openssl s_client -connect logstash.example.com:5044 -servername logstash.example.com

# 查看证书信息
openssl x509 -in /etc/logstash/certs/server.crt -text -noout

# 验证私钥和证书匹配
openssl rsa -in server.key -pubout | openssl md5
openssl x509 -in server.crt -pubkey -noout | openssl md5

# 验证证书链
openssl verify -CAfile ca.crt server.crt
```

**📊 Logstash日志分析**：
```bash
# 查看SSL相关错误
grep -i "ssl\|tls\|certificate" /var/log/logstash/logstash-plain.log

# 实时监控SSL连接
tail -f /var/log/logstash/logstash-plain.log | grep -i ssl

# 查看详细调试信息（需开启debug模式）
grep "javax.net.ssl" /var/log/logstash/logstash-plain.log
```

### 9.3 故障排查步骤


**🔍 系统化排查流程**：

**步骤1：基础检查**
```bash
# 检查证书文件是否存在和权限
ls -la /etc/logstash/certs/
# 应该看到正确的权限：-rw-r--r-- 或 -rw-------

# 检查证书有效期
openssl x509 -in /etc/logstash/certs/server.crt -dates -noout

# 检查服务监听状态
netstat -tlnp | grep :5044
```

**步骤2：连接测试**
```bash
# 简单连接测试
telnet logstash.example.com 5044

# SSL连接测试
openssl s_client -connect logstash.example.com:5044 -verify 1
```

**步骤3：配置验证**
```bash
# 验证Logstash配置语法
/usr/share/logstash/bin/logstash --config.test_and_exit --path.config=/etc/logstash/conf.d/

# 启用详细日志模式
# 在logstash.yml中设置：
# log.level: debug
```

### 9.4 问题解决方案


**🛠️ 常见问题及解决方案**：

| 问题类型 | **解决方案** | **预防措施** |
|---------|-------------|-------------|
| **证书过期** | `更新证书并重启服务` | `设置证书到期提醒` |
| **权限错误** | `chmod 600 私钥文件` | `使用正确的用户运行` |
| **主机名不匹配** | `使用正确的域名或IP` | `申请包含所有域名的证书` |
| **协议不兼容** | `更新协议版本配置` | `统一协议版本要求` |

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 SSL/TLS本质：为数据传输提供加密、认证、完整性保护
🔸 证书作用：数字身份证，证明"我是谁"
🔸 私钥重要性：必须严格保密的解密钥匙
🔸 CA验证：权威机构对身份的认证
🔸 双向认证：服务器和客户端互相验证身份
🔸 协议版本：推荐TLS 1.2以上，优选TLS 1.3
🔸 加密套件：决定加密强度和性能的核心配置
```

### 10.2 实践要点记忆


**🔹 配置文件安全三要素**：
```
正确性：证书和私钥必须匹配
安全性：私钥权限600，只有owner可读写
完整性：CA证书链必须完整可验证
```

**🔹 生产环境配置原则**：
```
安全优先：使用强加密套件和新协议版本  
性能兼顾：根据硬件能力选择合适算法
监控必备：启用SSL相关日志和监控
定期维护：及时更新证书和配置
```

**🔹 故障排查思路**：
```
从简到繁：先检查基础配置，再查复杂问题
从外到内：先测试网络连通性，再查应用配置  
工具助力：善用openssl等工具诊断问题
日志先行：SSL问题通常在日志中有明确提示
```

### 10.3 实际应用价值


**💼 业务价值**：
- **数据安全**：保护敏感日志数据不被窃取
- **合规要求**：满足行业安全规范和法规要求
- **信任建立**：为系统间通信建立可信关系
- **风险控制**：降低数据泄露和篡改风险

**🛠️ 技术价值**：
- **架构安全**：为整个ELK架构提供安全基础
- **扩展性**：支持跨网络、跨云的部署架构
- **运维便利**：标准化的安全配置和管理流程
- **故障诊断**：掌握SSL问题的系统排查方法

**🧠 核心记忆口诀**：
```
证书私钥配对好，权限设置不能少
CA验证要开启，协议版本选最新  
加密套件要够强，日志监控不能忘
SSL握手若失败，工具诊断找根源
```

**⚡ 快速检查清单**：
- [ ] 证书文件路径正确且存在
- [ ] 私钥文件权限设置为600
- [ ] CA证书配置并可验证
- [ ] SSL协议版本为TLS 1.2+
- [ ] 加密套件配置安全强度适当
- [ ] Logstash SSL相关日志无错误
- [ ] 网络连接和端口正常开放
- [ ] 证书有效期充足未过期