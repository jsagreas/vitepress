---
title: 2、Beats输入插件配置
---
## 📚 目录

1. [Beats输入插件概述](#1-beats输入插件概述)
2. [基础连接配置](#2-基础连接配置)
3. [SSL安全配置](#3-ssl安全配置)
4. [性能与超时配置](#4-性能与超时配置)
5. [高级配置选项](#5-高级配置选项)
6. [实际应用场景](#6-实际应用场景)
7. [常见问题排查](#7-常见问题排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔌 Beats输入插件概述


### 1.1 什么是Beats输入插件


**简单理解**：Beats输入插件就像Logstash的"接收器"，专门用来接收Beats家族产品发送过来的数据。

```
数据流向简图：
Filebeat/Metricbeat → 网络传输 → Logstash(Beats插件) → 处理 → Elasticsearch

就像快递员(Beats) → 快递站(Logstash) → 分拣处理 → 仓库(ES)
```

**核心作用**：
- **接收数据** - 监听指定端口，等待Beats发送数据
- **解析协议** - 理解Beats专用的通信协议
- **建立连接** - 与多个Beats客户端同时通信
- **安全传输** - 支持SSL加密保护数据安全

### 1.2 为什么需要专门的Beats插件


**通俗解释**：就像不同品牌的手机需要不同的充电器接口一样，Beats产品有自己的"数据接口"协议。

```
对比理解：
TCP输入插件：接收原始TCP数据流（像收邮件）
HTTP输入插件：接收HTTP请求（像网页表单提交）
Beats输入插件：接收Beats专用协议（像专用API接口）
```

**Beats协议优势**：
- ⚡ **高效传输** - 专门优化的二进制协议，传输效率高
- 🔄 **自动重试** - 网络中断时自动重连和重传
- 📊 **批量发送** - 一次发送多条日志，减少网络开销
- 🔐 **内置安全** - 原生支持SSL加密和身份验证

---

## 2. 🌐 基础连接配置


### 2.1 port参数 - 监听端口设置


**含义解释**：port就是Logstash"开门"等待Beats连接的门牌号。

```ruby
input {
  beats {
    port => 5044    # 最常用的Beats默认端口
  }
}
```

**通俗理解**：
- 就像你家的门牌号，Beats知道要敲哪扇门
- 默认5044端口，就像HTTP默认用80端口一样
- 端口必须在Beats配置中保持一致

**选择建议**：
```
生产环境推荐端口：
✅ 5044 - Beats官方默认端口
✅ 5045 - 备用端口
✅ 9000-9999 - 自定义范围

避免使用端口：
❌ 80/443 - Web服务占用
❌ 22 - SSH服务占用  
❌ 3306 - MySQL占用
❌ 1-1024 - 系统保留端口
```

### 2.2 host参数 - 绑定地址配置


**含义解释**：host决定Logstash在哪个网络接口上"开门迎客"。

```ruby
input {
  beats {
    port => 5044
    host => "0.0.0.0"    # 监听所有网络接口
  }
}
```

**配置选项说明**：

| 配置值 | **含义** | **适用场景** | **安全级别** |
|--------|----------|-------------|-------------|
| `"0.0.0.0"` | `监听所有网络接口` | `生产环境，接收远程连接` | `需要防火墙保护` |
| `"127.0.0.1"` | `只监听本机回环接口` | `测试环境，本机调试` | `最安全，仅本机访问` |
| `"192.168.1.100"` | `监听指定IP接口` | `多网卡服务器` | `中等安全性` |

**实际应用示例**：
```
开发测试环境：
host => "127.0.0.1"  # 只接受本机连接，安全调试

生产环境：
host => "0.0.0.0"    # 接受所有来源连接，配合防火墙使用

多网卡服务器：
host => "10.0.1.100" # 只在内网接口监听，外网无法访问
```

---

## 3. 🔐 SSL安全配置


### 3.1 ssl参数 - 启用SSL加密


**通俗解释**：SSL就像给数据传输加了一个"保险箱"，即使被偷看也看不懂内容。

```ruby
input {
  beats {
    port => 5044
    ssl => true          # 开启SSL加密传输
    ssl_certificate => "/path/to/logstash.crt"
    ssl_key => "/path/to/logstash.key"
  }
}
```

**为什么需要SSL**：
```
不加密传输的风险：
👤 网络监听者 → 📡 明文日志数据 → 😱 敏感信息泄露

SSL加密后：
👤 网络监听者 → 🔒 加密数据流 → ✅ 无法解读内容
```

### 3.2 ssl_certificate参数 - 证书文件配置


**含义解释**：SSL证书就像身份证，证明"我就是那个可信的Logstash服务器"。

```ruby
input {
  beats {
    ssl_certificate => "/etc/logstash/ssl/logstash.crt"
  }
}
```

**证书文件类型**：
- **`.crt`文件** - 证书文件，包含公钥和身份信息
- **`.pem`文件** - 另一种证书格式，内容相同
- **自签名证书** - 自己生成，适合内部使用
- **CA证书** - 权威机构签发，适合公网使用

**生成自签名证书示例**：
```bash
# 生成私钥
openssl genrsa -out logstash.key 2048

# 生成证书
openssl req -new -x509 -key logstash.key -out logstash.crt -days 365
```

### 3.3 ssl_key参数 - 私钥文件配置


**含义解释**：私钥就像保险箱的钥匙，必须严格保密，只有Logstash服务器知道。

```ruby
input {
  beats {
    ssl_key => "/etc/logstash/ssl/logstash.key"
  }
}
```

**私钥安全要求**：
```
文件权限设置：
chmod 600 logstash.key    # 只有owner可读写
chown logstash:logstash logstash.key  # 设置正确的所有者

目录权限：
chmod 700 /etc/logstash/ssl/  # 只有owner可访问目录
```

⚠️ **安全警告**：私钥文件绝对不能泄露！就像银行卡密码一样重要。

### 3.4 ssl_verify_mode参数 - 验证模式配置


**含义解释**：决定Logstash对客户端身份验证的"严格程度"。

```ruby
input {
  beats {
    ssl_verify_mode => "none"    # 不验证客户端证书
  }
}
```

**验证模式详解**：

| 模式 | **验证级别** | **适用场景** | **安全性** |
|------|-------------|-------------|-----------|
| `"none"` | `不验证客户端` | `内网环境，信任所有连接` | `低安全性` |
| `"peer"` | `验证客户端证书` | `高安全环境，双向认证` | `高安全性` |
| `"force_peer"` | `强制验证客户端` | `极高安全要求` | `最高安全性` |

**实际选择建议**：
```
内网测试环境：
ssl_verify_mode => "none"     # 简单快速，无需客户端证书

生产内网环境：
ssl_verify_mode => "peer"     # 平衡安全性和便利性

互联网暴露环境：
ssl_verify_mode => "force_peer"  # 最高安全级别
```

---

## 4. ⏱️ 性能与超时配置


### 4.1 client_inactivity_timeout参数详解


**通俗解释**：这个参数就像"耐心值"，决定Logstash等待"不说话"的客户端多长时间。

```ruby
input {
  beats {
    client_inactivity_timeout => 60    # 60秒无活动就断开连接
  }
}
```

**为什么需要超时机制**：
```
没有超时的问题：
Beats客户端 → 建立连接 → 突然断网/崩溃 → Logstash一直等待 → 资源浪费

有超时的好处：
Beats客户端 → 建立连接 → 60秒无响应 → Logstash主动断开 → 释放资源
```

**超时时间设置建议**：

| 环境类型 | **推荐值** | **原因说明** |
|---------|-----------|-------------|
| **本地测试** | `30秒` | `快速发现连接问题` |
| **局域网** | `60秒` | `网络稳定，适中设置` |
| **广域网** | `120秒` | `网络可能不稳定，留足时间` |
| **移动网络** | `180秒` | `网络波动大，需要更长容忍` |

### 4.2 超时机制的工作原理


**简化理解**：
```
连接生命周期：
1. Beats连接到Logstash ✅
2. 发送数据，重置计时器 🔄
3. 如果60秒内无新数据 ⏰
4. Logstash主动断开连接 ❌
5. 释放内存和网络资源 🧹
```

**实际应用场景**：
```ruby
# 高并发环境 - 快速释放死连接
input {
  beats {
    client_inactivity_timeout => 30
  }
}

# 网络不稳定环境 - 容忍网络波动
input {
  beats {
    client_inactivity_timeout => 300    # 5分钟
  }
}
```

---

## 5. 🏷️ 高级配置选项


### 5.1 include_codec_tag参数


**含义解释**：这个参数决定是否给每条日志加上"标签贴纸"，说明数据是怎么解码的。

```ruby
input {
  beats {
    include_codec_tag => false    # 不添加编码标签（默认值）
  }
}
```

**标签的作用**：
```
当设置为true时，每条日志会添加：
{
  "@timestamp": "2025-01-21T10:30:00.000Z",
  "message": "用户登录成功",
  "tags": ["_jsonparsefailure", "beats_input_codec_plain_applied"]
}
```

**使用建议**：
- **调试阶段** - 设置为`true`，帮助排查解析问题
- **生产环境** - 设置为`false`，减少不必要的字段

### 5.2 完整配置示例


**生产环境推荐配置**：
```ruby
input {
  beats {
    # 基础连接配置
    port => 5044
    host => "0.0.0.0"
    
    # SSL安全配置
    ssl => true
    ssl_certificate => "/etc/logstash/ssl/logstash.crt"
    ssl_key => "/etc/logstash/ssl/logstash.key"
    ssl_verify_mode => "none"
    
    # 性能配置
    client_inactivity_timeout => 60
    
    # 调试配置
    include_codec_tag => false
  }
}
```

**开发测试配置**：
```ruby
input {
  beats {
    # 简化配置，快速开始
    port => 5044
    host => "127.0.0.1"
    
    # 调试模式
    include_codec_tag => true
  }
}
```

---

## 6. 🎯 实际应用场景


### 6.1 单机日志收集


**场景描述**：一台服务器上的应用日志收集到本地Elasticsearch。

```
架构图：
应用程序 → 日志文件 → Filebeat → Logstash → Elasticsearch
         (写入)      (读取)    (传输)   (处理)
```

**配置示例**：
```ruby
# Logstash配置
input {
  beats {
    port => 5044
    host => "127.0.0.1"    # 本机传输，无需SSL
  }
}

# Filebeat配置对应
output.logstash:
  hosts: ["127.0.0.1:5044"]
```

### 6.2 集中式日志收集


**场景描述**：多台服务器的日志统一收集到中央Logstash处理。

```
多服务器架构：
服务器A → Filebeat → 
服务器B → Filebeat → → Logstash → Elasticsearch
服务器C → Filebeat → 
            (网络传输)    (中央处理)
```

**安全配置示例**：
```ruby
input {
  beats {
    port => 5044
    host => "0.0.0.0"
    
    # 启用SSL保护网络传输
    ssl => true
    ssl_certificate => "/etc/logstash/ssl/logstash.crt"
    ssl_key => "/etc/logstash/ssl/logstash.key"
    
    # 网络环境容忍度更高
    client_inactivity_timeout => 120
  }
}
```

### 6.3 高可用部署


**场景描述**：多个Logstash实例提供高可用服务。

```
高可用架构：
Filebeat → 负载均衡器 → Logstash-1 → 
                   → Logstash-2 → → Elasticsearch集群
                   → Logstash-3 → 
```

**配置考虑**：
```ruby
# 每个Logstash实例相同配置
input {
  beats {
    port => 5044
    host => "0.0.0.0"
    
    # 快速检测故障连接
    client_inactivity_timeout => 30
    
    # SSL配置确保安全性
    ssl => true
    ssl_certificate => "/etc/logstash/ssl/logstash.crt"
    ssl_key => "/etc/logstash/ssl/logstash.key"
  }
}
```

---

## 7. 🔍 常见问题排查


### 7.1 连接问题诊断


**问题症状**：Filebeat无法连接到Logstash

**排查步骤**：
```bash
# 1. 检查端口是否监听
netstat -tlnp | grep 5044

# 2. 检查防火墙设置
iptables -L | grep 5044

# 3. 测试网络连通性
telnet logstash-server 5044
```

**常见原因与解决**：
- **端口被占用** - 更换端口或停止占用进程
- **防火墙阻挡** - 开放5044端口访问权限
- **IP绑定错误** - 检查host参数配置

### 7.2 SSL证书问题


**问题症状**：SSL连接失败，证书验证错误

**诊断命令**：
```bash
# 验证证书文件
openssl x509 -in logstash.crt -text -noout

# 检查私钥匹配
openssl rsa -in logstash.key -check
```

**解决方法**：
```ruby
# 临时禁用SSL调试
input {
  beats {
    ssl => false    # 先确保基础连接正常
  }
}

# 证书路径问题
ssl_certificate => "/etc/logstash/ssl/logstash.crt"  # 绝对路径
ssl_key => "/etc/logstash/ssl/logstash.key"
```

### 7.3 性能问题排查


**问题症状**：数据传输缓慢，连接经常断开

**性能优化配置**：
```ruby
input {
  beats {
    port => 5044
    
    # 增加超时时间
    client_inactivity_timeout => 300
    
    # 添加调试标签
    include_codec_tag => true
  }
}
```

**监控命令**：
```bash
# 查看连接状态
ss -tuln | grep 5044

# 监控Logstash性能
top -p $(pgrep -f logstash)
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心配置


```ruby
# 最基础配置 - 新手必会
input {
  beats {
    port => 5044           # 监听端口
    host => "0.0.0.0"      # 绑定地址
  }
}

# 安全配置 - 生产必需
input {
  beats {
    ssl => true            # 启用SSL
    ssl_certificate => "/path/to/cert.crt"
    ssl_key => "/path/to/key.key"
    ssl_verify_mode => "none"
  }
}

# 性能配置 - 稳定运行
input {
  beats {
    client_inactivity_timeout => 60
    include_codec_tag => false
  }
}
```

### 8.2 关键理解要点


**🔹 端口和地址的关系**：
- `port` = 门牌号，决定Beats敲哪扇门
- `host` = 开门位置，决定在哪个网络接口等客户

**🔹 SSL配置的必要性**：
- 生产环境必须启用SSL保护数据传输安全
- 证书和私钥文件权限必须正确设置
- 验证模式根据安全需求选择

**🔹 超时机制的作用**：
- 防止死连接占用系统资源
- 根据网络环境调整超时时间
- 平衡资源释放和连接稳定性

### 8.3 实际应用指导


**环境选择建议**：
```
开发测试：
✅ host => "127.0.0.1" (本机访问)
✅ ssl => false (简化调试)
✅ include_codec_tag => true (便于调试)

生产环境：
✅ host => "0.0.0.0" (接受远程连接)
✅ ssl => true (数据加密)
✅ client_inactivity_timeout => 60 (稳定性)
```

**常见配置模板**：
```ruby
# 内网环境模板
input {
  beats {
    port => 5044
    host => "0.0.0.0"
    client_inactivity_timeout => 60
  }
}

# 公网环境模板  
input {
  beats {
    port => 5044
    host => "0.0.0.0"
    ssl => true
    ssl_certificate => "/etc/ssl/logstash.crt"
    ssl_key => "/etc/ssl/logstash.key"
    ssl_verify_mode => "none"
    client_inactivity_timeout => 120
  }
}
```

### 8.4 学习检查清单


**基础知识掌握**：
- ✅ 理解Beats输入插件的作用和工作原理
- ✅ 掌握port和host参数的配置方法
- ✅ 了解SSL配置的基本步骤

**进阶配置能力**：
- ✅ 能根据环境选择合适的SSL验证模式
- ✅ 能合理设置client_inactivity_timeout参数
- ✅ 掌握include_codec_tag的使用场景

**故障排查技能**：
- ✅ 能诊断常见的连接问题
- ✅ 能排查SSL证书相关问题
- ✅ 能优化性能相关配置

**核心记忆**：
- Beats插件是Logstash接收Beats数据的专用通道
- port和host决定了服务监听的位置
- SSL配置是生产环境的必需安全措施
- 超时配置影响连接稳定性和资源使用