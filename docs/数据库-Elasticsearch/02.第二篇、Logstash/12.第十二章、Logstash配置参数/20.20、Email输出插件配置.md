---
title: 20、Email输出插件配置
---
## 📚 目录

1. [Email输出插件概述](#1-Email输出插件概述)
2. [基础配置参数详解](#2-基础配置参数详解)
3. [SMTP服务器配置](#3-SMTP服务器配置)
4. [邮件内容定制](#4-邮件内容定制)
5. [安全认证配置](#5-安全认证配置)
6. [实际应用场景](#6-实际应用场景)
7. [常见问题与解决方案](#7-常见问题与解决方案)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📧 Email输出插件概述


### 1.1 什么是Email输出插件


**🔸 核心定义**
```
Email输出插件：将Logstash处理后的数据通过邮件发送出去
主要用途：系统监控告警、日志异常通知、数据报告发送
工作原理：当满足特定条件时，自动发送邮件到指定收件人
```

**💡 为什么需要Email输出**
- **实时告警**：系统出现问题时立即通知相关人员
- **定期报告**：自动发送系统状态报告
- **异常监控**：检测到异常日志时发送告警邮件
- **数据分享**：将处理结果发送给业务团队

### 1.2 Email插件的工作流程


```
日志数据流转过程：

输入数据 → 过滤处理 → 条件判断 → 邮件发送
    ↓         ↓         ↓         ↓
  原始日志   数据清洗   触发条件   SMTP发送

实际场景：
错误日志 → 提取关键信息 → 错误级别>=ERROR → 发送告警邮件
```

### 1.3 Email插件的优势特点


**🌟 主要优势**
```
🔸 即时性：问题发生时立即通知
🔸 灵活性：支持多种邮件格式和内容定制
🔸 可靠性：基于成熟的SMTP协议
🔸 易用性：配置简单，与现有邮件系统无缝集成
```

---

## 2. ⚙️ 基础配置参数详解


### 2.1 收发件人配置


#### 📮 to参数 - 收件人地址


**🔸 基本语法**
```ruby
output {
  email {
    to => "admin@company.com"  # 单个收件人
  }
}
```

**📋 多收件人配置**
```ruby
output {
  email {
    # 方式1：数组形式
    to => ["admin@company.com", "ops@company.com", "dev@company.com"]
    
    # 方式2：逗号分隔
    to => "admin@company.com,ops@company.com,dev@company.com"
  }
}
```

**💡 动态收件人设置**
```ruby
output {
  email {
    # 根据日志内容动态设置收件人
    to => "%{[notification_email]}"  # 从日志字段中获取
  }
}
```

#### 📤 from参数 - 发件人地址


**🔸 基本配置**
```ruby
output {
  email {
    from => "logstash-alert@company.com"  # 发件人地址
    to => "admin@company.com"
  }
}
```

**🎯 重要说明**
- **发件人地址**要与SMTP服务器的认证账户匹配
- **显示名称**可以包含在发件人信息中：`"Logstash Alert <alert@company.com>"`
- **建议使用**专门的监控邮箱作为发件人

### 2.2 邮件主题配置


#### 📋 subject参数 - 邮件主题


**🔸 静态主题**
```ruby
output {
  email {
    subject => "系统告警通知"
  }
}
```

**🎨 动态主题模板**
```ruby
output {
  email {
    # 包含时间戳的主题
    subject => "[告警] %{+YYYY-MM-dd HH:mm:ss} 系统异常"
    
    # 包含日志级别的主题
    subject => "[%{[level]}] %{[service_name]} 服务告警"
    
    # 包含主机信息的主题
    subject => "服务器 %{[host]} 发生 %{[event_type]} 事件"
  }
}
```

**📊 主题模板示例对比**

| 模板类型 | **配置示例** | **生成结果** |
|---------|------------|-------------|
| **静态主题** | `"系统告警"` | `系统告警` |
| **带时间** | `"[告警] %{+YYYY-MM-dd} 异常"` | `[告警] 2025-09-21 异常` |
| **带级别** | `"[%{[level]}] 服务异常"` | `[ERROR] 服务异常` |
| **多字段** | `"%{[host]}-%{[service]} 告警"` | `web01-nginx 告警` |

### 2.3 邮件正文配置


#### 📝 body参数 - 邮件正文模板


**🔸 简单文本正文**
```ruby
output {
  email {
    body => "检测到系统异常，请及时处理！"
  }
}
```

**📋 详细信息模板**
```ruby
output {
  email {
    body => "
告警时间: %{+YYYY-MM-dd HH:mm:ss}
告警主机: %{[host]}
服务名称: %{[service_name]}
错误级别: %{[level]}
错误信息: %{[message]}
错误详情: %{[error_detail]}

请及时查看并处理相关问题。
"
  }
}
```

**🎨 HTML格式正文**
```ruby
output {
  email {
    htmlbody => "
<html>
<body>
<h2 style='color: red;'>系统告警通知</h2>
<table border='1' style='border-collapse: collapse;'>
  <tr><td><b>告警时间</b></td><td>%{+YYYY-MM-dd HH:mm:ss}</td></tr>
  <tr><td><b>主机名称</b></td><td>%{[host]}</td></tr>
  <tr><td><b>服务名称</b></td><td>%{[service_name]}</td></tr>
  <tr><td><b>错误级别</b></td><td style='color: red;'><b>%{[level]}</b></td></tr>
  <tr><td><b>错误信息</b></td><td>%{[message]}</td></tr>
</table>
</body>
</html>
"
  }
}
```

---

## 3. 🌐 SMTP服务器配置


### 3.1 SMTP主机配置


#### 🏢 smtp_host参数 - SMTP服务器地址


**🔸 常用SMTP服务器配置**

```ruby
# Gmail SMTP配置
output {
  email {
    smtp_host => "smtp.gmail.com"
    smtp_port => 587
  }
}

# 企业邮箱SMTP配置
output {
  email {
    smtp_host => "smtp.company.com"
    smtp_port => 25
  }
}

# 163邮箱SMTP配置
output {
  email {
    smtp_host => "smtp.163.com"
    smtp_port => 465
  }
}
```

**📊 常用邮件服务商SMTP配置表**

| 邮件服务商 | **SMTP地址** | **端口** | **加密方式** |
|-----------|-------------|---------|-------------|
| **Gmail** | `smtp.gmail.com` | `587` | `TLS` |
| **Outlook** | `smtp-mail.outlook.com` | `587` | `TLS` |
| **163邮箱** | `smtp.163.com` | `465` | `SSL` |
| **QQ邮箱** | `smtp.qq.com` | `587` | `TLS` |
| **企业邮箱** | `mail.company.com` | `25/587` | `TLS/SSL` |

### 3.2 SMTP端口配置


#### 🔌 smtp_port参数 - SMTP端口号


**🔸 端口选择说明**
```ruby
output {
  email {
    # 标准SMTP端口（无加密）
    smtp_port => 25
    
    # TLS加密端口（推荐）
    smtp_port => 587
    
    # SSL加密端口
    smtp_port => 465
  }
}
```

**⚡ 端口使用场景**
- **端口25**：传统SMTP，无加密，企业内网常用
- **端口587**：SMTP with TLS，安全加密，互联网推荐
- **端口465**：SMTP over SSL，完全加密连接

---

## 4. 🔐 安全认证配置


### 4.1 TLS加密配置


#### 🛡️ use_tls参数 - 启用TLS加密


**🔸 TLS加密配置**
```ruby
output {
  email {
    smtp_host => "smtp.gmail.com"
    smtp_port => 587
    use_tls => true  # 启用TLS加密
  }
}
```

**💡 加密方式选择**
```ruby
# TLS加密（推荐）
output {
  email {
    use_tls => true
    smtp_port => 587
  }
}

# SSL加密
output {
  email {
    use_tls => false
    smtp_port => 465
  }
}
```

### 4.2 SMTP认证配置


#### 👤 username参数 - SMTP认证用户名


```ruby
output {
  email {
    username => "alert@company.com"  # SMTP认证用户名
  }
}
```

#### 🔑 password参数 - SMTP认证密码


```ruby
output {
  email {
    password => "your_email_password"  # SMTP认证密码
  }
}
```

**🚨 安全配置建议**
```ruby
output {
  email {
    # 使用环境变量存储敏感信息
    username => "${SMTP_USERNAME}"
    password => "${SMTP_PASSWORD}"
  }
}
```

**🔧 完整认证配置示例**
```ruby
output {
  email {
    smtp_host => "smtp.company.com"
    smtp_port => 587
    use_tls => true
    username => "${SMTP_USER}"
    password => "${SMTP_PASS}"
    from => "logstash@company.com"
    to => ["ops@company.com", "admin@company.com"]
    subject => "[告警] %{[service]} 服务异常"
    body => "详细信息请查看附件或日志系统"
  }
}
```

---

## 5. 🎯 实际应用场景


### 5.1 错误日志告警配置


**📋 场景描述**：当系统出现ERROR级别日志时发送邮件告警

```ruby
input {
  file {
    path => "/var/log/application.log"
    start_position => "beginning"
  }
}

filter {
  # 解析日志格式
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:level}\] %{GREEDYDATA:log_message}" }
  }
  
  # 添加主机信息
  mutate {
    add_field => { "hostname" => "%{host}" }
  }
}

output {
  # 只有ERROR级别才发送邮件
  if [level] == "ERROR" {
    email {
      smtp_host => "smtp.company.com"
      smtp_port => 587
      use_tls => true
      username => "${SMTP_USER}"
      password => "${SMTP_PASS}"
      from => "logstash-alert@company.com"
      to => ["ops@company.com", "dev@company.com"]
      subject => "[紧急告警] %{hostname} 发生ERROR级别错误"
      body => "
告警时间: %{+YYYY-MM-dd HH:mm:ss}
告警主机: %{hostname}
错误级别: %{level}
错误信息: %{log_message}

请立即查看并处理该错误！
"
    }
  }
}
```

### 5.2 服务健康检查告警


**📋 场景描述**：监控服务状态，服务不可用时发送告警

```ruby
input {
  http_poller {
    urls => {
      service_health => "http://api.company.com/health"
    }
    interval => 60
  }
}

filter {
  # 检查服务状态
  if [response][status] != 200 {
    mutate {
      add_field => { "alert_type" => "service_down" }
      add_field => { "service_name" => "API服务" }
    }
  }
}

output {
  if [alert_type] == "service_down" {
    email {
      smtp_host => "smtp.company.com"
      smtp_port => 587
      use_tls => true
      username => "${SMTP_USER}"
      password => "${SMTP_PASS}"
      from => "monitor@company.com"
      to => ["ops@company.com", "oncall@company.com"]
      subject => "[严重告警] %{service_name} 服务不可用"
      htmlbody => "
<html>
<body>
<h2 style='color: red;'>服务告警通知</h2>
<p><strong>告警时间:</strong> %{+YYYY-MM-dd HH:mm:ss}</p>
<p><strong>服务名称:</strong> %{service_name}</p>
<p><strong>告警类型:</strong> 服务不可用</p>
<p><strong>响应状态:</strong> %{[response][status]}</p>
<p style='color: red;'><strong>请立即检查服务状态并恢复服务！</strong></p>
</body>
</html>
"
    }
  }
}
```

### 5.3 定期报告发送


**📋 场景描述**：每日定时发送系统状态报告

```ruby
input {
  jdbc {
    jdbc_driver_library => "/path/to/mysql-connector.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_connection_string => "jdbc:mysql://localhost:3306/logs"
    jdbc_user => "loguser"
    jdbc_password => "password"
    statement => "SELECT COUNT(*) as total_logs, 
                         SUM(CASE WHEN level='ERROR' THEN 1 ELSE 0 END) as error_count,
                         SUM(CASE WHEN level='WARN' THEN 1 ELSE 0 END) as warn_count
                  FROM daily_logs WHERE date = CURDATE()"
    schedule => "0 8 * * *"  # 每天早上8点执行
  }
}

output {
  email {
    smtp_host => "smtp.company.com"
    smtp_port => 587
    use_tls => true
    username => "${SMTP_USER}"
    password => "${SMTP_PASS}"
    from => "report@company.com"
    to => ["manager@company.com", "ops@company.com"]
    subject => "每日系统状态报告 - %{+YYYY-MM-dd}"
    htmlbody => "
<html>
<body>
<h2>每日系统状态报告</h2>
<p><strong>报告日期:</strong> %{+YYYY-MM-dd}</p>
<table border='1' style='border-collapse: collapse;'>
  <tr style='background-color: #f0f0f0;'>
    <th>统计项目</th>
    <th>数量</th>
  </tr>
  <tr>
    <td>总日志条数</td>
    <td>%{total_logs}</td>
  </tr>
  <tr>
    <td>错误日志数</td>
    <td style='color: red;'>%{error_count}</td>
  </tr>
  <tr>
    <td>警告日志数</td>
    <td style='color: orange;'>%{warn_count}</td>
  </tr>
</table>
<p>如有异常请及时处理。</p>
</body>
</html>
"
  }
}
```

---

## 6. 🚨 常见问题与解决方案


### 6.1 连接问题解决


**❌ 常见错误：连接超时**
```
错误信息：Connection timed out
可能原因：
- SMTP服务器地址错误
- 端口号配置错误
- 网络连接问题
- 防火墙阻拦
```

**✅ 解决方案**
```ruby
# 1. 检查SMTP配置
output {
  email {
    smtp_host => "smtp.company.com"  # 确认服务器地址正确
    smtp_port => 587                  # 确认端口号正确
    use_tls => true                   # 确认加密方式正确
  }
}

# 2. 添加连接超时配置
output {
  email {
    smtp_host => "smtp.company.com"
    smtp_port => 587
    use_tls => true
    # 增加超时时间
    timeout => 60
  }
}
```

### 6.2 认证问题解决


**❌ 常见错误：认证失败**
```
错误信息：Authentication failed
可能原因：
- 用户名密码错误
- 邮箱未开启SMTP服务
- 需要应用专用密码
```

**✅ 解决方案**
```ruby
# 1. 确认认证信息
output {
  email {
    username => "correct_username@company.com"  # 完整邮箱地址
    password => "correct_password"               # 正确密码或应用密码
  }
}

# 2. 对于Gmail等服务，使用应用专用密码
output {
  email {
    smtp_host => "smtp.gmail.com"
    smtp_port => 587
    use_tls => true
    username => "your_email@gmail.com"
    password => "app_specific_password"  # 应用专用密码，不是登录密码
  }
}
```

### 6.3 邮件格式问题


**❌ 常见问题：中文乱码**
```ruby
# 解决中文乱码问题
output {
  email {
    # 设置字符编码
    charset => "UTF-8"
    subject => "测试中文主题"
    body => "这是中文邮件内容测试"
  }
}
```

**✅ HTML邮件格式优化**
```ruby
output {
  email {
    htmlbody => "
<html>
<head>
  <meta charset='UTF-8'>
  <style>
    body { font-family: Arial, sans-serif; }
    .alert { color: red; font-weight: bold; }
    .info { color: blue; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
  </style>
</head>
<body>
  <h2 class='alert'>系统告警</h2>
  <p class='info'>详细信息如下：</p>
  <!-- 邮件内容 -->
</body>
</html>
"
  }
}
```

---

## 7. 🔧 高级配置技巧


### 7.1 条件发送配置


**🎯 基于条件的邮件发送**
```ruby
output {
  # 只在工作时间发送邮件
  if [timestamp] {
    ruby {
      code => "
        time = event.get('@timestamp')
        hour = time.hour
        day_of_week = time.wday
        # 工作日(1-5) 且 工作时间(9-18)
        if day_of_week >= 1 and day_of_week <= 5 and hour >= 9 and hour <= 18
          event.set('send_email', true)
        else
          event.set('send_email', false)
        end
      "
    }
  }
  
  if [send_email] == true {
    email {
      # 邮件配置
    }
  }
}
```

### 7.2 邮件频率控制


**⏱️ 防止邮件轰炸**
```ruby
filter {
  # 使用throttle插件控制邮件频率
  throttle {
    before_count => -1
    after_count => 1
    period => 300  # 5分钟内同样的告警只发送一次
    key => "%{[host]}-%{[service]}-%{[level]}"
    add_tag => ["throttled"]
  }
}

output {
  if "throttled" not in [tags] {
    email {
      # 邮件配置
    }
  }
}
```

### 7.3 邮件附件配置


**📎 添加日志文件作为附件**
```ruby
output {
  email {
    smtp_host => "smtp.company.com"
    smtp_port => 587
    use_tls => true
    username => "${SMTP_USER}"
    password => "${SMTP_PASS}"
    from => "logstash@company.com"
    to => "admin@company.com"
    subject => "系统日志报告"
    body => "请查看附件中的详细日志"
    # 添加附件
    attachments => ["/var/log/error.log", "/var/log/access.log"]
  }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心配置


```
🔸 基础参数：to、from、subject、body - 邮件的基本要素
🔸 SMTP配置：smtp_host、smtp_port - 邮件服务器连接
🔸 安全认证：username、password、use_tls - 安全发送保障
🔸 内容定制：动态模板、HTML格式 - 丰富的邮件内容
🔸 条件控制：基于日志内容的条件发送 - 精准告警
```

### 8.2 关键理解要点


**🔹 Email插件的核心价值**
```
实时通知：
- 系统异常时立即获得通知
- 避免问题扩大造成更大损失
- 提高运维响应速度

灵活配置：
- 支持多种邮件格式（文本/HTML）
- 可以根据日志内容动态生成邮件
- 支持多收件人和条件发送
```

**🔹 配置要点理解**
```
SMTP配置：
- 不同邮件服务商的SMTP配置不同
- 端口和加密方式要匹配
- 企业邮箱通常需要特殊配置

安全考虑：
- 密码信息使用环境变量存储
- 启用TLS/SSL加密传输
- 定期更新认证信息
```

**🔹 实际应用建议**
```
告警策略：
- 根据日志级别设置不同的通知策略
- 避免邮件轰炸，设置合理的发送频率
- 重要告警使用多种通知方式

内容设计：
- 邮件主题要简洁明了
- 邮件内容包含足够的上下文信息
- 使用HTML格式提高可读性
```

### 8.3 实际应用价值


**🎯 运维监控场景**
- **系统告警**：服务异常、资源不足时及时通知
- **性能监控**：响应时间超阈值时发送报告
- **安全告警**：检测到可疑活动时立即通知
- **定期报告**：每日/周/月系统状态汇总

**🔧 配置最佳实践**
- **环境隔离**：开发、测试、生产环境使用不同邮件配置
- **分级通知**：不同级别的问题通知不同的人员
- **备份通知**：配置多个SMTP服务器避免单点故障
- **日志记录**：记录邮件发送状态便于故障排查

**核心记忆**：
- Email输出插件是Logstash实现实时告警的重要工具
- SMTP配置是邮件发送的基础，要根据邮件服务商正确配置
- 邮件内容可以使用模板动态生成，提供丰富的上下文信息
- 合理的条件控制和频率限制避免告警风暴
- 安全配置保护认证信息，使用加密传输保障安全