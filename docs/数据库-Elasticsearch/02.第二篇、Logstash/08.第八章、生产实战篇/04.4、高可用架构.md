---
title: 4ã€é«˜å¯ç”¨æ¶æ„
---
## ğŸ“š ç›®å½•

1. [é«˜å¯ç”¨æ¶æ„æ¦‚è¿°](#1-é«˜å¯ç”¨æ¶æ„æ¦‚è¿°)
2. [å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥](#2-å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥)
3. [è´Ÿè½½å‡è¡¡é…ç½®](#3-è´Ÿè½½å‡è¡¡é…ç½®)
4. [æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶](#4-æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶)
5. [æ•°æ®ä¸ä¸¢å¤±ä¿è¯](#5-æ•°æ®ä¸ä¸¢å¤±ä¿è¯)
6. [é›†ç¾¤æ‰©å±•ç­–ç•¥](#6-é›†ç¾¤æ‰©å±•ç­–ç•¥)
7. [ç¾éš¾æ¢å¤æ–¹æ¡ˆ](#7-ç¾éš¾æ¢å¤æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ é«˜å¯ç”¨æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é«˜å¯ç”¨æ¶æ„


**é«˜å¯ç”¨(HA)**ï¼šHigh Availabilityçš„ç®€ç§°ï¼Œé€šä¿—åœ°è¯´å°±æ˜¯è®©ç³»ç»Ÿ**"æ°¸è¿œä¸åœæœº"**ã€‚

```
ç®€å•ç†è§£ï¼š
æ™®é€šæ¶æ„ï¼šåªæœ‰ä¸€å°LogstashæœåŠ¡å™¨
    â†“ å¦‚æœè¿™å°æœåŠ¡å™¨æŒ‚äº†ï¼Œæ•´ä¸ªæ—¥å¿—å¤„ç†å°±åœäº†

é«˜å¯ç”¨æ¶æ„ï¼šå¤šå°LogstashæœåŠ¡å™¨åŒæ—¶å·¥ä½œ
    â†“ å…¶ä¸­ä¸€å°æŒ‚äº†ï¼Œå…¶ä»–æœåŠ¡å™¨ç»§ç»­å·¥ä½œï¼Œç”¨æˆ·æ„Ÿè§‰ä¸åˆ°
```

**é«˜å¯ç”¨çš„æ ¸å¿ƒç›®æ ‡**ï¼š
- **å¯ç”¨æ€§**ï¼šç³»ç»Ÿ99.9%ä»¥ä¸Šæ—¶é—´éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- **å¯é æ€§**ï¼šæ•°æ®ä¸ä¸¢å¤±ï¼Œå¤„ç†ä¸å‡ºé”™
- **å¯æ‰©å±•æ€§**ï¼šä¸šåŠ¡å¢é•¿æ—¶èƒ½å¿«é€Ÿæ‰©å®¹
- **æ•…éšœæ¢å¤**ï¼šå‡ºé—®é¢˜èƒ½å¿«é€Ÿæ¢å¤

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é«˜å¯ç”¨æ¶æ„


**ç°å®é—®é¢˜åœºæ™¯**ï¼š
```
ğŸ”¸ å•ç‚¹æ•…éšœï¼š
   ä¸€å°LogstashæŒ‚äº† â†’ æ‰€æœ‰æ—¥å¿—å¤„ç†åœæ­¢ â†’ ä¸šåŠ¡ç›‘æ§å¤±æ•ˆ

ğŸ”¸ æ€§èƒ½ç“¶é¢ˆï¼š
   æ•°æ®é‡æš´å¢ â†’ å•å°æœåŠ¡å™¨å¤„ç†ä¸è¿‡æ¥ â†’ æ—¥å¿—ç§¯å‹å»¶è¿Ÿ

ğŸ”¸ ç»´æŠ¤å‡çº§ï¼š
   éœ€è¦å‡çº§Logstash â†’ å¿…é¡»åœæœº â†’ å½±å“ä¸šåŠ¡ç›‘æ§

ğŸ”¸ ç¡¬ä»¶æ•…éšœï¼š
   æœåŠ¡å™¨ç¡¬ç›˜åäº† â†’ æ•°æ®ä¸¢å¤± â†’ å†å²æ—¥å¿—æ— æ³•æ‰¾å›
```

**é«˜å¯ç”¨æ¶æ„çš„ä»·å€¼**ï¼š
```
âœ… æœåŠ¡ä¸ä¸­æ–­ï¼š7Ã—24å°æ—¶æŒç»­è¿è¡Œ
âœ… æ•°æ®ä¸ä¸¢å¤±ï¼šå¤šé‡å¤‡ä»½å’Œå®¹é”™æœºåˆ¶
âœ… æ€§èƒ½å¯æ‰©å±•ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´èµ„æº
âœ… æ•…éšœå¿«æ¢å¤ï¼šè‡ªåŠ¨æ£€æµ‹å’Œåˆ‡æ¢
```

### 1.3 é«˜å¯ç”¨æ¶æ„è®¾è®¡åŸåˆ™


**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼š
```
ğŸ¯ æ¶ˆé™¤å•ç‚¹æ•…éšœ (No Single Point of Failure)
   åŸç†ï¼šä»»ä½•ç»„ä»¶éƒ½ä¸èƒ½æˆä¸ºç³»ç»Ÿçš„å”¯ä¸€ä¾èµ–ç‚¹
   å®ç°ï¼šå…³é”®ç»„ä»¶éƒ½è¦æœ‰å†—ä½™å¤‡ä»½

ğŸ¯ æ•…éšœå¿«é€Ÿæ£€æµ‹ (Fast Failure Detection)  
   åŸç†ï¼šå°½å¿«å‘ç°é—®é¢˜ï¼Œå‡å°‘å½±å“æ—¶é—´
   å®ç°ï¼šå¥åº·æ£€æŸ¥ã€ç›‘æ§å‘Šè­¦

ğŸ¯ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ (Automatic Failover)
   åŸç†ï¼šæ— éœ€äººå·¥å¹²é¢„ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†æ•…éšœ
   å®ç°ï¼šè´Ÿè½½å‡è¡¡å™¨ã€é›†ç¾¤ç®¡ç†

ğŸ¯ æ•°æ®ä¸€è‡´æ€§ä¿è¯ (Data Consistency)
   åŸç†ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
   å®ç°ï¼šäº‹åŠ¡æœºåˆ¶ã€æ•°æ®åŒæ­¥
```

---

## 2. ğŸš€ å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥


### 2.1 éƒ¨ç½²æ¶æ„æ¨¡å¼


#### ğŸ“Š ä¸»ä»æ¨¡å¼ (Master-Slave)


**å·¥ä½œåŸç†**ï¼šä¸€ä¸»å¤šä»ï¼Œä¸»èŠ‚ç‚¹å¤„ç†å†™å…¥ï¼Œä»èŠ‚ç‚¹å¤„ç†è¯»å–

```
æ¶æ„ç¤ºæ„å›¾ï¼š
        è´Ÿè½½å‡è¡¡å™¨
            |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
    |       |       |
ä¸»èŠ‚ç‚¹    ä»èŠ‚ç‚¹1   ä»èŠ‚ç‚¹2
(å†™å…¥)    (è¯»å–)   (è¯»å–)
    |       |       |
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
         æ•°æ®åŒæ­¥
```

**é…ç½®è¦ç‚¹**ï¼š
```yaml
# ä¸»èŠ‚ç‚¹é…ç½® (master.conf)
input {
  beats {
    port => 5044
  }
}

output {
  elasticsearch {
    hosts => ["es1:9200", "es2:9200"]
  }
  # åŒæ­¥åˆ°ä»èŠ‚ç‚¹
  redis {
    host => "redis-cluster"
    key => "logstash-sync"
  }
}

# ä»èŠ‚ç‚¹é…ç½® (slave.conf)  
input {
  redis {
    host => "redis-cluster"
    key => "logstash-sync"
  }
}

output {
  elasticsearch {
    hosts => ["es1:9200", "es2:9200"]
  }
}
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
```
âœ… ä¼˜ç‚¹ï¼š
- æ¶æ„ç®€å•æ˜“ç†è§£
- æ•°æ®ä¸€è‡´æ€§å¥½
- æ•…éšœå½±å“èŒƒå›´å¯æ§

âŒ ç¼ºç‚¹ï¼š
- ä¸»èŠ‚ç‚¹å‹åŠ›å¤§
- æ‰©å±•èƒ½åŠ›æœ‰é™
- ä¸»èŠ‚ç‚¹æ•…éšœå½±å“å†™å…¥
```

#### âš–ï¸ å¤šä¸»æ¨¡å¼ (Multi-Master)


**å·¥ä½œåŸç†**ï¼šå¤šä¸ªèŠ‚ç‚¹éƒ½èƒ½å¤„ç†å†™å…¥å’Œè¯»å–ï¼Œè´Ÿè½½åˆ†æ•£

```
æ¶æ„ç¤ºæ„å›¾ï¼š
        è´Ÿè½½å‡è¡¡å™¨
      /      |      \
  èŠ‚ç‚¹1    èŠ‚ç‚¹2    èŠ‚ç‚¹3
 (è¯»å†™)   (è¯»å†™)   (è¯»å†™)
     \      |      /
      \     |     /
    å…±äº«å­˜å‚¨/æ¶ˆæ¯é˜Ÿåˆ—
```

**å®ç°æ–¹æ¡ˆ**ï¼š
```yaml
# èŠ‚ç‚¹1é…ç½®
input {
  beats {
    port => 5044
  }
}

filter {
  # æ·»åŠ èŠ‚ç‚¹æ ‡è¯†
  mutate {
    add_field => { "logstash_node" => "node1" }
  }
}

output {
  elasticsearch {
    hosts => ["es-cluster:9200"]
    # ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç¡®ä¿æ•°æ®åˆ†å¸ƒ
    routing => "%{[beat][hostname]}"
  }
}
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
```
âœ… ä¼˜ç‚¹ï¼š
- æ— å•ç‚¹æ•…éšœ
- æ‰©å±•æ€§å¼º
- è´Ÿè½½åˆ†æ•£å‡åŒ€

âŒ ç¼ºç‚¹ï¼š
- é…ç½®å¤æ‚
- æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
- éœ€è¦é¢å¤–çš„åè°ƒæœºåˆ¶
```

### 2.2 èŠ‚ç‚¹è§„åˆ’ç­–ç•¥


#### ğŸ¯ æŒ‰åŠŸèƒ½åˆ†å±‚éƒ¨ç½²


**åˆ†å±‚æ¶æ„è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ”¶é›†å±‚ (Shipper)     â”‚ â† è½»é‡çº§ï¼Œéƒ¨ç½²åœ¨ä¸šåŠ¡æœåŠ¡å™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     å¤„ç†å±‚ (Indexer)     â”‚ â† é‡å¤„ç†ï¼Œç‹¬ç«‹æœåŠ¡å™¨é›†ç¾¤  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     å­˜å‚¨å±‚ (Storage)     â”‚ â† Elasticsearché›†ç¾¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“éƒ¨ç½²æ–¹æ¡ˆ**ï¼š
```bash
# æ”¶é›†å±‚ï¼šæ¯å°ä¸šåŠ¡æœåŠ¡å™¨éƒ¨ç½²
# é…ç½®ç®€å•ï¼Œåªè´Ÿè´£æ”¶é›†å’Œè½¬å‘
shipper_nodes=(web1 web2 web3 app1 app2)

# å¤„ç†å±‚ï¼šä¸“ç”¨æœåŠ¡å™¨é›†ç¾¤
# è´Ÿè´£å¤æ‚çš„æ•°æ®å¤„ç†å’Œè¿‡æ»¤
indexer_nodes=(logstash1 logstash2 logstash3)

# å­˜å‚¨å±‚ï¼šElasticsearché›†ç¾¤  
# è´Ÿè´£æ•°æ®å­˜å‚¨å’Œæ£€ç´¢
storage_nodes=(es1 es2 es3)
```

#### ğŸ“ˆ æŒ‰è´Ÿè½½åˆ†åŒºéƒ¨ç½²


**æ°´å¹³åˆ†åŒºç­–ç•¥**ï¼š
```
åº”ç”¨æ—¥å¿— â†’ Logstashé›†ç¾¤A (3èŠ‚ç‚¹)
ç³»ç»Ÿæ—¥å¿— â†’ Logstashé›†ç¾¤B (2èŠ‚ç‚¹)  
å®‰å…¨æ—¥å¿— â†’ Logstashé›†ç¾¤C (2èŠ‚ç‚¹)
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# åº”ç”¨æ—¥å¿—é›†ç¾¤é…ç½®
input {
  beats {
    port => 5044
    type => "application"
  }
}

filter {
  if [type] == "application" {
    # åº”ç”¨æ—¥å¿—ä¸“ç”¨å¤„ç†
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
  }
}

# ç³»ç»Ÿæ—¥å¿—é›†ç¾¤é…ç½®
input {
  syslog {
    port => 514
    type => "system"
  }
}

filter {
  if [type] == "system" {
    # ç³»ç»Ÿæ—¥å¿—ä¸“ç”¨å¤„ç†
    grok {
      match => { "message" => "%{SYSLOGBASE}" }
    }
  }
}
```

### 2.3 èµ„æºé…ç½®æœ€ä½³å®è·µ


**ç¡¬ä»¶é…ç½®å»ºè®®**ï¼š
```
ğŸ”¸ å°å‹ç¯å¢ƒ (æ—¥å¿—é‡ < 1GB/å¤©)ï¼š
  CPU: 4æ ¸å¿ƒ
  å†…å­˜: 8GB  
  ç£ç›˜: 100GB SSD
  ç½‘ç»œ: 1Gbps

ğŸ”¸ ä¸­å‹ç¯å¢ƒ (æ—¥å¿—é‡ 1-10GB/å¤©)ï¼š
  CPU: 8æ ¸å¿ƒ
  å†…å­˜: 16GB
  ç£ç›˜: 500GB SSD  
  ç½‘ç»œ: 1Gbps

ğŸ”¸ å¤§å‹ç¯å¢ƒ (æ—¥å¿—é‡ > 10GB/å¤©)ï¼š
  CPU: 16æ ¸å¿ƒ+
  å†…å­˜: 32GB+
  ç£ç›˜: 1TB+ SSD
  ç½‘ç»œ: 10Gbps
```

**JVMå‚æ•°ä¼˜åŒ–**ï¼š
```bash
# å°å‹ç¯å¢ƒ
export LS_JAVA_OPTS="-Xms2g -Xmx2g"

# ä¸­å‹ç¯å¢ƒ  
export LS_JAVA_OPTS="-Xms4g -Xmx4g -XX:+UseG1GC"

# å¤§å‹ç¯å¢ƒ
export LS_JAVA_OPTS="-Xms8g -Xmx8g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

---

## 3. âš–ï¸ è´Ÿè½½å‡è¡¡é…ç½®


### 3.1 è´Ÿè½½å‡è¡¡å™¨é€‰æ‹©


#### ğŸŒ Nginxè´Ÿè½½å‡è¡¡


**ä¸ºä»€ä¹ˆé€‰æ‹©Nginx**ï¼š
- æ€§èƒ½é«˜ï¼Œèµ„æºå ç”¨å°‘
- é…ç½®ç®€å•çµæ´»
- æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•
- æœ‰è‰¯å¥½çš„å¥åº·æ£€æŸ¥åŠŸèƒ½

**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š
```nginx
# /etc/nginx/conf.d/logstash-lb.conf
upstream logstash_cluster {
    # è½®è¯¢ç®—æ³•ï¼Œé»˜è®¤æ–¹å¼
    server 192.168.1.10:5044 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:5044 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:5044 weight=1 max_fails=3 fail_timeout=30s;
}

server {
    listen 5044;
    
    location / {
        proxy_pass http://logstash_cluster;
        proxy_timeout 30s;
        proxy_connect_timeout 5s;
        
        # ä¿æŒå®¢æˆ·ç«¯IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**è´Ÿè½½å‡è¡¡ç®—æ³•å¯¹æ¯”**ï¼š
| ç®—æ³•ç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| `è½®è¯¢ (round-robin)` | æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ | ç®€å•ï¼Œåˆ†å¸ƒå‡åŒ€ | ä¸è€ƒè™‘æœåŠ¡å™¨è´Ÿè½½ |
| `åŠ æƒè½®è¯¢ (weighted)` | æœåŠ¡å™¨æ€§èƒ½ä¸åŒ | æ ¹æ®æ€§èƒ½åˆ†é… | éœ€è¦æ‰‹åŠ¨è°ƒæ•´æƒé‡ |
| `æœ€å°‘è¿æ¥ (least_conn)` | é•¿è¿æ¥æœåŠ¡ | åŠ¨æ€è´Ÿè½½å‡è¡¡ | ç®—æ³•å¤æ‚åº¦é«˜ |
| `IPå“ˆå¸Œ (ip_hash)` | éœ€è¦ä¼šè¯ä¿æŒ | åŒä¸€å®¢æˆ·ç«¯å›ºå®šæœåŠ¡å™¨ | åˆ†å¸ƒå¯èƒ½ä¸å‡ |

#### ğŸ”„ HAProxyè´Ÿè½½å‡è¡¡


**HAProxyçš„ä¼˜åŠ¿**ï¼š
- ä¸“ä¸šçš„è´Ÿè½½å‡è¡¡å™¨
- æ›´ä¸°å¯Œçš„å¥åº·æ£€æŸ¥
- æ”¯æŒTCPå’ŒHTTPåè®®
- è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯

**é…ç½®ç¤ºä¾‹**ï¼š
```haproxy
# /etc/haproxy/haproxy.cfg
global
    maxconn 4096
    daemon

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# Logstashé›†ç¾¤é…ç½®
backend logstash_cluster
    balance roundrobin
    option tcpcheck
    
    server logstash1 192.168.1.10:5044 check port 9600 inter 30s
    server logstash2 192.168.1.11:5044 check port 9600 inter 30s  
    server logstash3 192.168.1.12:5044 check port 9600 inter 30s

frontend logstash_frontend
    bind *:5044
    default_backend logstash_cluster

# ç›‘æ§é¡µé¢
listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 30s
```

### 3.2 å¥åº·æ£€æŸ¥é…ç½®


**å¥åº·æ£€æŸ¥çš„é‡è¦æ€§**ï¼š
```
ç›®çš„ï¼šåŠæ—¶å‘ç°æ•…éšœèŠ‚ç‚¹ï¼Œé¿å…å°†è¯·æ±‚å‘é€ç»™ä¸å¯ç”¨æœåŠ¡å™¨
æ–¹å¼ï¼šå®šæœŸæ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼Œè‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹
å¥½å¤„ï¼šæé«˜ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘é”™è¯¯è¯·æ±‚
```

**Logstashå¥åº·æ£€æŸ¥API**ï¼š
```bash
# Logstashé»˜è®¤æä¾›ç›‘æ§API
curl -X GET "http://logstash1:9600/_node/stats"

# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€  
curl -X GET "http://logstash1:9600/_node/hot_threads"

# æ£€æŸ¥ç®¡é“çŠ¶æ€
curl -X GET "http://logstash1:9600/_node/stats/pipeline"
```

**Nginxå¥åº·æ£€æŸ¥é…ç½®**ï¼š
```nginx
upstream logstash_cluster {
    server 192.168.1.10:5044 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:5044 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:5044 max_fails=3 fail_timeout=30s;
}

# å¥åº·æ£€æŸ¥å‚æ•°è¯´æ˜ï¼š
# max_fails=3    : è¿ç»­å¤±è´¥3æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨
# fail_timeout=30s : 30ç§’åé‡æ–°å°è¯•æ£€æŸ¥
```

### 3.3 ä¼šè¯ä¿æŒç­–ç•¥


**ä»€ä¹ˆæ˜¯ä¼šè¯ä¿æŒ**ï¼š
```
é—®é¢˜ï¼šæŸäº›åœºæ™¯ä¸‹ï¼Œæ¥è‡ªåŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚éœ€è¦å‘é€åˆ°åŒä¸€å°æœåŠ¡å™¨
ä¾‹å¦‚ï¼šæ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œç»­ä¼ éœ€è¦å‘é€åˆ°åŒä¸€èŠ‚ç‚¹

è§£å†³ï¼šä¼šè¯ä¿æŒï¼ˆSession Persistence/Sticky Sessionï¼‰
æ–¹æ³•ï¼šæ ¹æ®å®¢æˆ·ç«¯IPæˆ–å…¶ä»–æ ‡è¯†ï¼Œå°†è¯·æ±‚å›ºå®šè·¯ç”±åˆ°ç‰¹å®šæœåŠ¡å™¨
```

**IP Hashé…ç½®**ï¼š
```nginx
upstream logstash_cluster {
    ip_hash;  # å¯ç”¨IPå“ˆå¸Œ
    server 192.168.1.10:5044;
    server 192.168.1.11:5044;
    server 192.168.1.12:5044;
}
```

**åŸºäºCookieçš„ä¼šè¯ä¿æŒ**ï¼š
```nginx
upstream logstash_cluster {
    server 192.168.1.10:5044 route=node1;
    server 192.168.1.11:5044 route=node2;
    server 192.168.1.12:5044 route=node3;
}

server {
    location / {
        proxy_pass http://logstash_cluster;
        
        # åŸºäºCookieè·¯ç”±
        set $route $cookie_route;
        if ($route = "") {
            set $route "node1";  # é»˜è®¤è·¯ç”±
        }
    }
}
```

---

## 4. ğŸ”„ æ•…éšœè‡ªåŠ¨åˆ‡æ¢æœºåˆ¶


### 4.1 æ•…éšœæ£€æµ‹åŸç†


**æ•…éšœæ£€æµ‹çš„å±‚æ¬¡**ï¼š
```
ğŸ”¸ ç½‘ç»œå±‚æ£€æµ‹ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å“åº”ç½‘ç»œè¯·æ±‚
ğŸ”¸ æœåŠ¡å±‚æ£€æµ‹ï¼šæ£€æŸ¥LogstashæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ  
ğŸ”¸ åº”ç”¨å±‚æ£€æµ‹ï¼šæ£€æŸ¥Logstashæ˜¯å¦èƒ½æ­£å¸¸å¤„ç†æ•°æ®
ğŸ”¸ ä¸šåŠ¡å±‚æ£€æµ‹ï¼šæ£€æŸ¥æ•°æ®å¤„ç†è´¨é‡æ˜¯å¦ç¬¦åˆè¦æ±‚
```

**æ£€æµ‹æ–¹æ³•å¯¹æ¯”**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£€æµ‹æ–¹æ³•    â”‚  æ£€æµ‹æ·±åº¦  â”‚  å“åº”é€Ÿåº¦ â”‚  å‡†ç¡®æ€§  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pingæ£€æµ‹    â”‚    ä½     â”‚   å¾ˆå¿«   â”‚   ä¸€èˆ¬   â”‚
â”‚ ç«¯å£æ£€æµ‹    â”‚    ä¸­     â”‚   å¿«     â”‚   è‰¯å¥½   â”‚
â”‚ HTTPæ£€æµ‹    â”‚    é«˜     â”‚   ä¸­ç­‰   â”‚   å¾ˆå¥½   â”‚
â”‚ è‡ªå®šä¹‰æ£€æµ‹  â”‚   å¾ˆé«˜    â”‚   æ…¢     â”‚   æœ€å¥½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è‡ªåŠ¨åˆ‡æ¢å®ç°


#### ğŸ¯ åŸºäºè´Ÿè½½å‡è¡¡å™¨çš„åˆ‡æ¢


**å·¥ä½œæµç¨‹**ï¼š
```
1. è´Ÿè½½å‡è¡¡å™¨å®šæœŸæ£€æŸ¥åç«¯æœåŠ¡å™¨å¥åº·çŠ¶æ€
2. å‘ç°æ•…éšœæœåŠ¡å™¨åï¼Œå°†å…¶æ ‡è®°ä¸ºä¸å¯ç”¨
3. å°†æ–°è¯·æ±‚è·¯ç”±åˆ°å¥åº·çš„æœåŠ¡å™¨
4. å®šæœŸé‡è¯•æ•…éšœæœåŠ¡å™¨ï¼Œæ¢å¤åè‡ªåŠ¨åŠ å…¥
```

**Nginxè‡ªåŠ¨åˆ‡æ¢é…ç½®**ï¼š
```nginx
upstream logstash_cluster {
    server 192.168.1.10:5044 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:5044 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:5044 max_fails=3 fail_timeout=30s backup;
}

# backupå‚æ•°è¯´æ˜ï¼š
# åªæœ‰å½“å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶ï¼Œæ‰ä¼šä½¿ç”¨backupæœåŠ¡å™¨
```

#### ğŸ”„ åŸºäºKeepalivedçš„åˆ‡æ¢


**Keepalivedä»‹ç»**ï¼š
```
ä½œç”¨ï¼šå®ç°æœåŠ¡å™¨ä¹‹é—´çš„æ•…éšœåˆ‡æ¢
åŸç†ï¼šé€šè¿‡VRRPåè®®å®ç°è™šæ‹ŸIPæ¼‚ç§»
ä¼˜åŠ¿ï¼šç§’çº§åˆ‡æ¢ï¼Œå¯¹å®¢æˆ·ç«¯é€æ˜
```

**é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ä¸»æœåŠ¡å™¨é…ç½® (/etc/keepalived/keepalived.conf)
vrrp_script chk_logstash {
    script "/usr/local/bin/check_logstash.sh"
    interval 5
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    
    virtual_ipaddress {
        192.168.1.100
    }
    
    track_script {
        chk_logstash
    }
}

# æ£€æŸ¥è„šæœ¬ (/usr/local/bin/check_logstash.sh)
#!/bin/bash
curl -f http://localhost:9600/_node/stats > /dev/null 2>&1
exit $?
```

### 4.3 æ•…éšœæ¢å¤ç­–ç•¥


**æ¢å¤æ£€æµ‹æœºåˆ¶**ï¼š
```bash
#!/bin/bash
# æ•…éšœæ¢å¤æ£€æµ‹è„šæœ¬

LOGSTASH_HOST="192.168.1.10"
LOGSTASH_PORT="9600"
MAX_RETRIES=3
RETRY_INTERVAL=10

check_logstash_health() {
    local retries=0
    
    while [ $retries -lt $MAX_RETRIES ]; do
        # æ£€æŸ¥APIå“åº”
        if curl -f "http://${LOGSTASH_HOST}:${LOGSTASH_PORT}/_node/stats" > /dev/null 2>&1; then
            # æ£€æŸ¥ç®¡é“çŠ¶æ€
            pipeline_status=$(curl -s "http://${LOGSTASH_HOST}:${LOGSTASH_PORT}/_node/stats/pipeline" | jq -r '.pipeline.main.reloads.failures')
            
            if [ "$pipeline_status" = "0" ]; then
                echo "Logstashå¥åº·çŠ¶æ€è‰¯å¥½"
                return 0
            fi
        fi
        
        retries=$((retries + 1))
        sleep $RETRY_INTERVAL
    done
    
    echo "Logstashå¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}
```

**æ¸è¿›å¼æ¢å¤**ï¼š
```
åŸç†ï¼šæ•…éšœèŠ‚ç‚¹æ¢å¤åï¼Œä¸ç«‹å³æ‰¿æ‹…å…¨éƒ¨è´Ÿè½½
è¿‡ç¨‹ï¼š
1. æ¢å¤åå…ˆæ ‡è®°ä¸º"è§‚å¯ŸçŠ¶æ€"
2. åˆ†é…å°‘é‡æµé‡è¿›è¡Œæµ‹è¯•
3. é€æ­¥å¢åŠ æµé‡æ¯”ä¾‹  
4. ç¡®è®¤ç¨³å®šåæ¢å¤æ­£å¸¸æƒé‡

å¥½å¤„ï¼šé¿å…æ¢å¤è¿‡ç¨‹ä¸­çš„äºŒæ¬¡æ•…éšœ
```

---

## 5. ğŸ›¡ï¸ æ•°æ®ä¸ä¸¢å¤±ä¿è¯


### 5.1 æ•°æ®ä¸¢å¤±çš„é£é™©ç‚¹


**å¸¸è§æ•°æ®ä¸¢å¤±åœºæ™¯**ï¼š
```
ğŸ”¸ æœåŠ¡å™¨çªç„¶å®•æœº
  é£é™©ï¼šå†…å­˜ä¸­çš„æ•°æ®æ¥ä¸åŠå†™å…¥ç£ç›˜
  å½±å“ï¼šæ­£åœ¨å¤„ç†çš„æ•°æ®ä¸¢å¤±

ğŸ”¸ ç½‘ç»œè¿æ¥ä¸­æ–­  
  é£é™©ï¼šæ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ç½‘ç»œæ–­å¼€
  å½±å“ï¼šä¼ è¾“ä¸­çš„æ•°æ®åŒ…ä¸¢å¤±

ğŸ”¸ å­˜å‚¨è®¾å¤‡æ•…éšœ
  é£é™©ï¼šç¡¬ç›˜æŸåæˆ–æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
  å½±å“ï¼šå·²å­˜å‚¨çš„æ•°æ®æ— æ³•è¯»å–

ğŸ”¸ é…ç½®é”™è¯¯å¯¼è‡´
  é£é™©ï¼šé”™è¯¯çš„è¿‡æ»¤è§„åˆ™ä¸¢å¼ƒé‡è¦æ•°æ®
  å½±å“ï¼šç¬¦åˆæ¡ä»¶çš„æ•°æ®è¢«æ„å¤–åˆ é™¤
```

### 5.2 æŒä¹…åŒ–é˜Ÿåˆ—æœºåˆ¶


**ä»€ä¹ˆæ˜¯æŒä¹…åŒ–é˜Ÿåˆ—**ï¼š
```
æ™®é€šé˜Ÿåˆ—ï¼šæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ–­ç”µä¸¢å¤±
æŒä¹…åŒ–é˜Ÿåˆ—ï¼šæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œæ–­ç”µä¸ä¸¢å¤±

ä½œç”¨ï¼šåœ¨LogstashèŠ‚ç‚¹æ•…éšœæ—¶ä¿æŠ¤æ•°æ®
ä½ç½®ï¼šinputå’Œfilterä¹‹é—´çš„ç¼“å†²åŒº
```

**å¯ç”¨æŒä¹…åŒ–é˜Ÿåˆ—**ï¼š
```yaml
# logstash.yml
queue.type: persisted
queue.max_bytes: 1gb
queue.max_events: 0
queue.checkpoint.writes: 1024
queue.checkpoint.interval: 1000

# å‚æ•°è¯´æ˜ï¼š
# queue.max_bytes: é˜Ÿåˆ—æœ€å¤§å ç”¨ç£ç›˜ç©ºé—´
# queue.checkpoint.writes: æ¯å¤„ç†å¤šå°‘äº‹ä»¶å†™ä¸€æ¬¡æ£€æŸ¥ç‚¹
# queue.checkpoint.interval: æ£€æŸ¥ç‚¹å†™å…¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
```

**ç›‘æ§é˜Ÿåˆ—çŠ¶æ€**ï¼š
```bash
# æŸ¥çœ‹é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
curl -X GET "http://localhost:9600/_node/stats/pipeline"

# å…³é”®æŒ‡æ ‡ï¼š
# queue.events: é˜Ÿåˆ—ä¸­çš„äº‹ä»¶æ•°é‡
# queue.size_in_bytes: é˜Ÿåˆ—å ç”¨ç£ç›˜å¤§å°
# queue.capacity.page_capacity_in_bytes: é¡µé¢å®¹é‡
```

### 5.3 æ•°æ®å¤‡ä»½ç­–ç•¥


#### ğŸ“‹ å¤šå‰¯æœ¬å­˜å‚¨


**å®ç°åŸç†**ï¼š
```
æ•°æ®å†™å…¥å¤šä¸ªä½ç½®ï¼š
1. ä¸»å­˜å‚¨ï¼šElasticsearchä¸»é›†ç¾¤
2. å¤‡ä»½å­˜å‚¨ï¼šElasticsearchå¤‡ä»½é›†ç¾¤  
3. å½’æ¡£å­˜å‚¨ï¼šæ–‡ä»¶ç³»ç»Ÿæˆ–å¯¹è±¡å­˜å‚¨
```

**é…ç½®å¤šè¾“å‡º**ï¼š
```yaml
output {
  # ä¸»è¾“å‡ºï¼šç”Ÿäº§ESé›†ç¾¤
  elasticsearch {
    hosts => ["es-prod1:9200", "es-prod2:9200"]
    index => "logs-prod-%{+YYYY.MM.dd}"
  }
  
  # å¤‡ä»½è¾“å‡ºï¼šå¤‡ä»½ESé›†ç¾¤
  elasticsearch {
    hosts => ["es-backup1:9200", "es-backup2:9200"] 
    index => "logs-backup-%{+YYYY.MM.dd}"
  }
  
  # å½’æ¡£è¾“å‡ºï¼šæ–‡ä»¶ç³»ç»Ÿ
  file {
    path => "/data/logs-archive/logs-%{+YYYY.MM.dd}.json"
    codec => json_lines
  }
}
```

#### ğŸ”„ æ–­ç‚¹ç»­ä¼ æœºåˆ¶


**åŸç†è¯´æ˜**ï¼š
```
é—®é¢˜ï¼šç½‘ç»œä¸­æ–­å¯¼è‡´æ•°æ®ä¼ è¾“å¤±è´¥
è§£å†³ï¼šè®°å½•ä¼ è¾“è¿›åº¦ï¼Œä¸­æ–­åä»æ–­ç‚¹ç»§ç»­

å®ç°æ–¹å¼ï¼š
1. ä½¿ç”¨sincedbè®°å½•æ–‡ä»¶è¯»å–ä½ç½®
2. ä½¿ç”¨offsetè·Ÿè¸ªå¤„ç†è¿›åº¦
3. å¼‚å¸¸æ¢å¤æ—¶ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
```

**File inputçš„æ–­ç‚¹ç»­ä¼ **ï¼š
```yaml
input {
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/data/logstash/sincedb"
    # sincedbæ–‡ä»¶è®°å½•æ¯ä¸ªæ–‡ä»¶çš„è¯»å–ä½ç½®
  }
}
```

### 5.4 äº‹åŠ¡æ€§ä¿è¯


**At-least-onceè¯­ä¹‰**ï¼š
```
ä¿è¯ï¼šæ¯ä¸ªäº‹ä»¶è‡³å°‘è¢«å¤„ç†ä¸€æ¬¡
ä»£ä»·ï¼šå¯èƒ½å‡ºç°é‡å¤å¤„ç†
é€‚ç”¨ï¼šå¯¹æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜çš„åœºæ™¯
```

**å¹‚ç­‰æ€§è®¾è®¡**ï¼š
```yaml
filter {
  # ç”Ÿæˆå”¯ä¸€IDç¡®ä¿å¹‚ç­‰æ€§
  fingerprint {
    source => ["@timestamp", "host", "message"]
    target => "[@metadata][fingerprint]"
    method => "SHA256"
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    document_id => "%{[@metadata][fingerprint]}"
    # ä½¿ç”¨å›ºå®šIDï¼Œé‡å¤æ•°æ®ä¼šè¦†ç›–è€Œä¸æ˜¯é‡å¤æ’å…¥
  }
}
```

---

## 6. ğŸ“ˆ é›†ç¾¤æ‰©å±•ç­–ç•¥


### 6.1 æ°´å¹³æ‰©å±•å®è·µ


**ä»€ä¹ˆæ˜¯æ°´å¹³æ‰©å±•**ï¼š
```
å‚ç›´æ‰©å±•ï¼šå¢åŠ å•å°æœåŠ¡å™¨çš„é…ç½®ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
æ°´å¹³æ‰©å±•ï¼šå¢åŠ æœåŠ¡å™¨çš„æ•°é‡

æ°´å¹³æ‰©å±•çš„ä¼˜åŠ¿ï¼š
âœ… æˆæœ¬æ§åˆ¶æ›´å¥½
âœ… æ‰©å±•ä¸Šé™æ›´é«˜
âœ… å•ç‚¹æ•…éšœå½±å“æ›´å°
âœ… å¯ä»¥æ¸è¿›å¼æ‰©å±•
```

**æ‰©å±•å†³ç­–æŒ‡æ ‡**ï¼š
```
ğŸ“Š æ€§èƒ½æŒ‡æ ‡ï¼š
- CPUä½¿ç”¨ç‡ > 80%
- å†…å­˜ä½¿ç”¨ç‡ > 85%
- é˜Ÿåˆ—ç§¯å‹ä¸¥é‡
- å¤„ç†å»¶è¿Ÿå¢åŠ 

ğŸ“Š ä¸šåŠ¡æŒ‡æ ‡ï¼š
- æ—¥å¿—é‡å¢é•¿
- æ–°ä¸šåŠ¡ç³»ç»Ÿæ¥å…¥
- å¤„ç†å¤æ‚åº¦æå‡
- SLAè¦æ±‚æé«˜
```

**æ‰©å±•å®æ–½æ­¥éª¤**ï¼š
```
1ï¸âƒ£ å‡†å¤‡æ–°èŠ‚ç‚¹
   â†’ å®‰è£…Logstash
   â†’ é…ç½®ä¸ç°æœ‰èŠ‚ç‚¹ç›¸åŒ
   â†’ æµ‹è¯•è¿é€šæ€§

2ï¸âƒ£ åŠ å…¥è´Ÿè½½å‡è¡¡
   â†’ æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®
   â†’ è®¾ç½®è¾ƒå°çš„æƒé‡
   â†’ è§‚å¯Ÿè¿è¡ŒçŠ¶æ€

3ï¸âƒ£ é€æ­¥å¢åŠ è´Ÿè½½
   â†’ æé«˜æ–°èŠ‚ç‚¹æƒé‡
   â†’ ç›‘æ§æ€§èƒ½æŒ‡æ ‡
   â†’ ç¡®è®¤ç¨³å®šæ€§

4ï¸âƒ£ å®Œæˆæ‰©å±•
   â†’ è°ƒæ•´æƒé‡åˆ°ç›®æ ‡å€¼
   â†’ æ›´æ–°ç›‘æ§é…ç½®
   â†’ æ–‡æ¡£æ›´æ–°
```

### 6.2 åŠ¨æ€é…ç½®ç®¡ç†


**é…ç½®ç®¡ç†çš„æŒ‘æˆ˜**ï¼š
```
é—®é¢˜ï¼šé›†ç¾¤è§„æ¨¡å¤§äº†åï¼Œé…ç½®ç®¡ç†å¾ˆå¤æ‚
- å¤šä¸ªèŠ‚ç‚¹çš„é…ç½®è¦ä¿æŒä¸€è‡´
- é…ç½®å˜æ›´éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
- ä¸åŒç¯å¢ƒçš„é…ç½®å·®å¼‚ç®¡ç†
```

**é›†ä¸­åŒ–é…ç½®æ–¹æ¡ˆ**ï¼š
```yaml
# ä½¿ç”¨é…ç½®ä¸­å¿ƒï¼ˆå¦‚Consulï¼‰
input {
  http_poller {
    urls => {
      config_url => "http://consul:8500/v1/kv/logstash/config"
    }
    request_timeout => 60
    interval => 300
    codec => "json"
    metadata_target => "http_config"
  }
}

filter {
  # æ ¹æ®é…ç½®ä¸­å¿ƒçš„é…ç½®åŠ¨æ€å¤„ç†
  if [http_config][enable_grok] == "true" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
  }
}
```

**æ¨¡æ¿åŒ–é…ç½®**ï¼š
```bash
# é…ç½®æ¨¡æ¿ (logstash.conf.template)
input {
  beats {
    port => ${BEATS_PORT}
  }
}

filter {
  if [fields][env] == "${ENVIRONMENT}" {
    # ç¯å¢ƒç‰¹å®šçš„å¤„ç†é€»è¾‘
  }
}

output {
  elasticsearch {
    hosts => [${ES_HOSTS}]
    index => "${INDEX_PREFIX}-%{+YYYY.MM.dd}"
  }
}

# ç”Ÿæˆé…ç½®è„šæœ¬
envsubst < logstash.conf.template > logstash.conf
```

### 6.3 å¼¹æ€§ä¼¸ç¼©


**è‡ªåŠ¨ä¼¸ç¼©åŸç†**ï¼š
```
ç›®æ ‡ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´é›†ç¾¤è§„æ¨¡
ç›‘æ§ï¼šCPUã€å†…å­˜ã€é˜Ÿåˆ—é•¿åº¦ç­‰æŒ‡æ ‡
ç­–ç•¥ï¼š
- è´Ÿè½½é«˜æ—¶è‡ªåŠ¨å¢åŠ èŠ‚ç‚¹
- è´Ÿè½½ä½æ—¶è‡ªåŠ¨å‡å°‘èŠ‚ç‚¹
- é¿å…é¢‘ç¹ä¼¸ç¼©æŠ–åŠ¨
```

**åŸºäºç›‘æ§çš„ä¼¸ç¼©è„šæœ¬**ï¼š
```bash
#!/bin/bash
# è‡ªåŠ¨ä¼¸ç¼©è„šæœ¬

NAMESPACE="logstash"
MIN_REPLICAS=2
MAX_REPLICAS=10
CPU_THRESHOLD=80
MEMORY_THRESHOLD=85

get_current_load() {
    # è·å–å½“å‰å¹³å‡CPUä½¿ç”¨ç‡
    kubectl top nodes --selector=app=logstash --no-headers | \
    awk '{sum+=$3} END {print sum/NR}' | sed 's/%//'
}

get_current_replicas() {
    kubectl get deployment logstash -n $NAMESPACE -o jsonpath='{.spec.replicas}'
}

scale_cluster() {
    local target_replicas=$1
    echo "æ‰©å±•é›†ç¾¤åˆ° $target_replicas ä¸ªå‰¯æœ¬"
    kubectl scale deployment logstash -n $NAMESPACE --replicas=$target_replicas
}

# ä¸»é€»è¾‘
current_load=$(get_current_load)
current_replicas=$(get_current_replicas)

if (( $(echo "$current_load > $CPU_THRESHOLD" | bc -l) )); then
    # è´Ÿè½½é«˜ï¼Œæ‰©å®¹
    if [ $current_replicas -lt $MAX_REPLICAS ]; then
        new_replicas=$((current_replicas + 1))
        scale_cluster $new_replicas
    fi
elif (( $(echo "$current_load < 30" | bc -l) )); then
    # è´Ÿè½½ä½ï¼Œç¼©å®¹
    if [ $current_replicas -gt $MIN_REPLICAS ]; then
        new_replicas=$((current_replicas - 1))
        scale_cluster $new_replicas
    fi
fi
```

---

## 7. ğŸš¨ ç¾éš¾æ¢å¤æ–¹æ¡ˆ


### 7.1 ç¾éš¾åœºæ™¯åˆ†æ


**ç¾éš¾ç±»å‹åˆ†çº§**ï¼š
```
ğŸ”¸ Level 1 - å•èŠ‚ç‚¹æ•…éšœ
  å½±å“ï¼šéƒ¨åˆ†å¤„ç†èƒ½åŠ›ä¸¢å¤±
  æ¢å¤ï¼šè‡ªåŠ¨æ•…éšœåˆ‡æ¢
  æ—¶é—´ï¼šç§’çº§åˆ°åˆ†é’Ÿçº§

ğŸ”¸ Level 2 - æœºæˆ¿ç½‘ç»œæ•…éšœ  
  å½±å“ï¼šæ•´ä¸ªæœºæˆ¿ä¸å¯ç”¨
  æ¢å¤ï¼šåˆ‡æ¢åˆ°å¤‡ç”¨æœºæˆ¿
  æ—¶é—´ï¼šåˆ†é’Ÿçº§åˆ°å°æ—¶çº§

ğŸ”¸ Level 3 - æ•°æ®ä¸­å¿ƒæ•…éšœ
  å½±å“ï¼šä¸»è¦æ•°æ®ä¸­å¿ƒä¸å¯ç”¨
  æ¢å¤ï¼šå¯ç”¨å¼‚åœ°ç¾å¤‡
  æ—¶é—´ï¼šå°æ—¶çº§åˆ°å¤©çº§

ğŸ”¸ Level 4 - ä¸¥é‡è‡ªç„¶ç¾å®³
  å½±å“ï¼šåŒºåŸŸæ€§åŸºç¡€è®¾æ–½æŸå
  æ¢å¤ï¼šå®Œå…¨é‡å»º
  æ—¶é—´ï¼šå¤©çº§åˆ°å‘¨çº§
```

### 7.2 å¤‡ä»½æ¢å¤ç­–ç•¥


#### ğŸ’¾ é…ç½®å¤‡ä»½


**å¤‡ä»½å†…å®¹æ¸…å•**ï¼š
```bash
# éœ€è¦å¤‡ä»½çš„é…ç½®æ–‡ä»¶
BACKUP_FILES=(
    "/etc/logstash/logstash.yml"
    "/etc/logstash/pipelines.yml" 
    "/etc/logstash/conf.d/*.conf"
    "/etc/logstash/patterns/*"
    "/etc/nginx/conf.d/logstash-*.conf"
    "/etc/keepalived/keepalived.conf"
)

# å¤‡ä»½è„šæœ¬
backup_config() {
    local backup_dir="/backup/$(date +%Y%m%d_%H%M%S)"
    mkdir -p $backup_dir
    
    for file in "${BACKUP_FILES[@]}"; do
        if [ -f "$file" ]; then
            cp "$file" "$backup_dir/"
            echo "å·²å¤‡ä»½: $file"
        fi
    done
    
    # å‹ç¼©å¹¶ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨
    tar -czf "${backup_dir}.tar.gz" "$backup_dir"
    aws s3 cp "${backup_dir}.tar.gz" s3://logstash-backup/
}
```

#### ğŸ”„ æ•°æ®å¤‡ä»½


**åˆ†å±‚å¤‡ä»½ç­–ç•¥**ï¼š
```
ğŸ”¸ å®æ—¶å¤‡ä»½ï¼š
  æ–¹æ³•ï¼šåŒå†™åˆ°å¤šä¸ªElasticsearché›†ç¾¤
  RPOï¼š0ï¼ˆæ— æ•°æ®ä¸¢å¤±ï¼‰
  æˆæœ¬ï¼šé«˜

ğŸ”¸ è¿‘å®æ—¶å¤‡ä»½ï¼š
  æ–¹æ³•ï¼šé€šè¿‡reindex APIå®šæœŸåŒæ­¥
  RPOï¼šåˆ†é’Ÿçº§
  æˆæœ¬ï¼šä¸­ç­‰

ğŸ”¸ å®šæœŸå¤‡ä»½ï¼š
  æ–¹æ³•ï¼šsnapshotå¿«ç…§å¤‡ä»½
  RPOï¼šå°æ—¶çº§æˆ–å¤©çº§
  æˆæœ¬ï¼šä½
```

**å¿«ç…§å¤‡ä»½å®ç°**ï¼š
```bash
#!/bin/bash
# Elasticsearchå¿«ç…§å¤‡ä»½è„šæœ¬

ES_HOST="localhost:9200"
REPO_NAME="logstash_backup"
INDEX_PATTERN="logs-*"

# åˆ›å»ºå¿«ç…§
create_snapshot() {
    local snapshot_name="snapshot_$(date +%Y%m%d_%H%M%S)"
    
    curl -X PUT "${ES_HOST}/_snapshot/${REPO_NAME}/${snapshot_name}?wait_for_completion=true" \
    -H "Content-Type: application/json" \
    -d "{
        \"indices\": \"${INDEX_PATTERN}\",
        \"ignore_unavailable\": true,
        \"include_global_state\": false,
        \"metadata\": {
            \"taken_by\": \"logstash_backup_script\",
            \"taken_because\": \"scheduled_backup\"
        }
    }"
}

# æ¸…ç†è¿‡æœŸå¿«ç…§
cleanup_old_snapshots() {
    local keep_days=30
    local cutoff_date=$(date -d "${keep_days} days ago" +%Y%m%d)
    
    # è·å–æ‰€æœ‰å¿«ç…§å¹¶åˆ é™¤è¿‡æœŸçš„
    curl -s "${ES_HOST}/_snapshot/${REPO_NAME}/_all" | \
    jq -r ".snapshots[] | select(.start_time_in_millis < $(date -d "${keep_days} days ago" +%s)000) | .snapshot" | \
    while read snapshot; do
        curl -X DELETE "${ES_HOST}/_snapshot/${REPO_NAME}/${snapshot}"
        echo "åˆ é™¤è¿‡æœŸå¿«ç…§: $snapshot"
    done
}
```

### 7.3 æ¢å¤æµç¨‹


**æ¢å¤ä¼˜å…ˆçº§**ï¼š
```
1ï¸âƒ£ æ¢å¤æ ¸å¿ƒæœåŠ¡
   â†’ å¯åŠ¨åŸºç¡€LogstashæœåŠ¡
   â†’ ç¡®ä¿åŸºæœ¬æ—¥å¿—å¤„ç†åŠŸèƒ½

2ï¸âƒ£ æ¢å¤å…³é”®æ•°æ®
   â†’ æ¢å¤æœ€è¿‘çš„æ•°æ®å¤‡ä»½
   â†’ éªŒè¯æ•°æ®å®Œæ•´æ€§

3ï¸âƒ£ æ¢å¤å®Œæ•´åŠŸèƒ½
   â†’ æ¢å¤æ‰€æœ‰é…ç½®
   â†’ é‡å»ºç›‘æ§å’Œå‘Šè­¦

4ï¸âƒ£ æ¢å¤æ€§èƒ½ä¼˜åŒ–
   â†’ è°ƒæ•´æ€§èƒ½å‚æ•°
   â†’ éªŒè¯å¤„ç†èƒ½åŠ›
```

**å¿«é€Ÿæ¢å¤è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ç¾éš¾æ¢å¤è„šæœ¬

RECOVERY_MODE=${1:-"basic"}  # basic, full, emergency

emergency_recovery() {
    echo "å¯åŠ¨ç´§æ€¥æ¢å¤æ¨¡å¼..."
    
    # ä½¿ç”¨æœ€å°é…ç½®å¯åŠ¨Logstash
    cat > /tmp/emergency.conf << EOF
input {
  beats { port => 5044 }
}
output {
  elasticsearch {
    hosts => ["${EMERGENCY_ES_HOST}:9200"]
    index => "emergency-logs-%{+YYYY.MM.dd}"
  }
}
EOF
    
    sudo systemctl stop logstash
    sudo /usr/share/logstash/bin/logstash -f /tmp/emergency.conf &
    echo "ç´§æ€¥æ¨¡å¼å·²å¯åŠ¨ï¼ŒåŸºæœ¬æ—¥å¿—æ”¶é›†åŠŸèƒ½å¯ç”¨"
}

full_recovery() {
    echo "å¯åŠ¨å®Œæ•´æ¢å¤æµç¨‹..."
    
    # 1. åœæ­¢æœåŠ¡
    sudo systemctl stop logstash
    
    # 2. æ¢å¤é…ç½®
    aws s3 cp s3://logstash-backup/latest.tar.gz /tmp/
    tar -xzf /tmp/latest.tar.gz -C /etc/logstash/
    
    # 3. æ¢å¤æ•°æ®
    restore_elasticsearch_snapshot
    
    # 4. å¯åŠ¨æœåŠ¡
    sudo systemctl start logstash
    
    # 5. éªŒè¯åŠŸèƒ½
    validate_recovery
}

case $RECOVERY_MODE in
    "emergency")
        emergency_recovery
        ;;
    "full")
        full_recovery
        ;;
    *)
        echo "ä½¿ç”¨æ–¹å¼: $0 [emergency|full]"
        exit 1
        ;;
esac
```

### 7.4 ç¾éš¾é¢„é˜²æªæ–½


**é¢„é˜²æ€§ç›‘æ§**ï¼š
```yaml
# å…³é”®æŒ‡æ ‡ç›‘æ§
alerts:
  - name: "LogstashèŠ‚ç‚¹ä¸‹çº¿"
    condition: "up{job='logstash'} == 0"
    for: "1m"
    severity: "critical"
    
  - name: "å¤„ç†å»¶è¿Ÿè¿‡é«˜"
    condition: "logstash_pipeline_events_duration_in_millis > 5000"
    for: "5m"
    severity: "warning"
    
  - name: "ç£ç›˜ç©ºé—´ä¸è¶³"
    condition: "disk_free_percent < 10"
    for: "2m"
    severity: "critical"
```

**å®šæœŸæ¼”ç»ƒ**ï¼š
```bash
#!/bin/bash
# ç¾éš¾æ¢å¤æ¼”ç»ƒè„šæœ¬

conduct_drill() {
    echo "å¼€å§‹ç¾éš¾æ¢å¤æ¼”ç»ƒ..."
    
    # 1. æ¨¡æ‹Ÿæ•…éšœ
    echo "æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœ..."
    sudo systemctl stop logstash
    
    # 2. éªŒè¯åˆ‡æ¢
    echo "éªŒè¯è‡ªåŠ¨åˆ‡æ¢..."
    check_failover_success
    
    # 3. æµ‹è¯•æ¢å¤
    echo "æµ‹è¯•æ¢å¤æµç¨‹..."
    test_recovery_procedure
    
    # 4. æ¢å¤æ­£å¸¸
    echo "æ¢å¤æ­£å¸¸æœåŠ¡..."
    sudo systemctl start logstash
    
    # 5. ç”ŸæˆæŠ¥å‘Š
    generate_drill_report
}

# æ¯æœˆè‡ªåŠ¨æ‰§è¡Œ
if [ "$(date +%d)" = "01" ]; then
    conduct_drill
fi
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é«˜å¯ç”¨æœ¬è´¨ï¼šé€šè¿‡å†—ä½™è®¾è®¡æ¶ˆé™¤å•ç‚¹æ•…éšœï¼Œä¿è¯æœåŠ¡è¿ç»­æ€§
ğŸ”¸ å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼šä¸»ä»æ¨¡å¼vså¤šä¸»æ¨¡å¼ï¼ŒæŒ‰åŠŸèƒ½åˆ†å±‚vsæŒ‰è´Ÿè½½åˆ†åŒº
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šåˆ†å‘è¯·æ±‚ï¼Œå¥åº·æ£€æŸ¥ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢
ğŸ”¸ æ•°æ®ä¿æŠ¤ï¼šæŒä¹…åŒ–é˜Ÿåˆ—ï¼Œå¤šå‰¯æœ¬å­˜å‚¨ï¼Œæ–­ç‚¹ç»­ä¼ 
ğŸ”¸ é›†ç¾¤æ‰©å±•ï¼šæ°´å¹³æ‰©å±•ï¼ŒåŠ¨æ€é…ç½®ï¼Œå¼¹æ€§ä¼¸ç¼©
ğŸ”¸ ç¾éš¾æ¢å¤ï¼šåˆ†çº§å“åº”ï¼Œå¤‡ä»½ç­–ç•¥ï¼Œå¿«é€Ÿæ¢å¤
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é«˜å¯ç”¨ä¸æ˜¯é“¶å¼¹**
```
å¹³è¡¡è€ƒè™‘ï¼š
- å¯ç”¨æ€§ vs æˆæœ¬ï¼šæ›´é«˜å¯ç”¨æ€§éœ€è¦æ›´å¤šèµ„æºæŠ•å…¥
- å¤æ‚æ€§ vs æ”¶ç›Šï¼šè¿‡åº¦è®¾è®¡ä¼šå¢åŠ è¿ç»´å¤æ‚åº¦
- ä¸€è‡´æ€§ vs æ€§èƒ½ï¼šå¼ºä¸€è‡´æ€§å¯èƒ½å½±å“å¤„ç†æ€§èƒ½

å®é™…é€‰æ‹©ï¼š
- æ ¹æ®ä¸šåŠ¡SLAè¦æ±‚ç¡®å®šå¯ç”¨æ€§ç›®æ ‡
- è¯„ä¼°æ•…éšœæˆæœ¬ç¡®å®šæŠ•å…¥æ°´å¹³
- å¾ªåºæ¸è¿›ï¼Œé¿å…è¿‡åº¦è®¾è®¡
```

**ğŸ”¹ ç›‘æ§æ˜¯é«˜å¯ç”¨çš„åŸºç¡€**
```
ç›‘æ§å±‚æ¬¡ï¼š
- åŸºç¡€è®¾æ–½ç›‘æ§ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- æœåŠ¡ç›‘æ§ï¼šè¿›ç¨‹çŠ¶æ€ã€ç«¯å£ç›‘å¬ã€APIå“åº”
- ä¸šåŠ¡ç›‘æ§ï¼šå¤„ç†å»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡
- ç”¨æˆ·ä½“éªŒç›‘æ§ï¼šç«¯åˆ°ç«¯å¤„ç†æ—¶é—´

å‘Šè­¦ç­–ç•¥ï¼š
- åˆ†çº§å‘Šè­¦ï¼šinfoã€warningã€critical
- é™å™ªæœºåˆ¶ï¼šé¿å…å‘Šè­¦é£æš´
- è‡ªåŠ¨å¤„ç†ï¼šç®€å•æ•…éšœè‡ªåŠ¨æ¢å¤
```

**ğŸ”¹ æ•…éšœæ˜¯å¸¸æ€ï¼Œå‡†å¤‡æ˜¯å…³é”®**
```
æ•…éšœå‡†å¤‡ï¼š
- æ–‡æ¡£åŒ–çš„åº”æ€¥æµç¨‹
- å®šæœŸçš„æ•…éšœæ¼”ç»ƒ
- è‡ªåŠ¨åŒ–çš„æ¢å¤è„šæœ¬
- å®Œå–„çš„å¤‡ä»½ç­–ç•¥

å“åº”åŸåˆ™ï¼š
- å¿«é€Ÿå®šä½ï¼šå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—
- å¿«é€Ÿæ¢å¤ï¼šè‡ªåŠ¨åŒ–å·¥å…·å’Œè„šæœ¬
- å¤ç›˜æ”¹è¿›ï¼šæ•…éšœåçš„ç»éªŒæ€»ç»“
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼**
- **æœåŠ¡è¿ç»­æ€§**ï¼š7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡
- **æ•°æ®å®‰å…¨æ€§**ï¼šå¤šé‡ä¿æŠ¤ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
- **æ‰©å±•çµæ´»æ€§**ï¼šæ ¹æ®ä¸šåŠ¡å¢é•¿çµæ´»æ‰©å®¹
- **è¿ç»´æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–å‡å°‘äººå·¥å¹²é¢„

**ğŸ”§ æŠ€æœ¯ä»·å€¼**  
- **æ¶æ„èƒ½åŠ›**ï¼šè®¾è®¡å¯æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿ
- **è¿ç»´èƒ½åŠ›**ï¼šæŒæ¡ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
- **æ•…éšœå¤„ç†**ï¼šå…·å¤‡å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜çš„èƒ½åŠ›
- **å·¥å…·ä½¿ç”¨**ï¼šç†Ÿç»ƒä½¿ç”¨è´Ÿè½½å‡è¡¡ã€ç›‘æ§ç­‰å·¥å…·

### 8.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸš€ éƒ¨ç½²æœ€ä½³å®è·µ**
```
âœ… åˆ†å±‚éƒ¨ç½²ï¼šæ”¶é›†å±‚ã€å¤„ç†å±‚ã€å­˜å‚¨å±‚èŒè´£åˆ†ç¦»
âœ… å†—ä½™è®¾è®¡ï¼šå…³é”®ç»„ä»¶éƒ½è¦æœ‰å¤‡ä»½
âœ… æ¸è¿›æ‰©å±•ï¼šä»å°è§„æ¨¡å¼€å§‹ï¼Œé€æ­¥æ‰©å¤§
âœ… é…ç½®ç®¡ç†ï¼šé›†ä¸­åŒ–é…ç½®ï¼Œç‰ˆæœ¬æ§åˆ¶
```

**ğŸ” ç›‘æ§æœ€ä½³å®è·µ**
```
âœ… å…¨é“¾è·¯ç›‘æ§ï¼šä»æ•°æ®äº§ç”Ÿåˆ°æœ€ç»ˆå­˜å‚¨çš„å®Œæ•´é“¾è·¯
âœ… å¤šç»´åº¦æŒ‡æ ‡ï¼šæŠ€æœ¯æŒ‡æ ‡+ä¸šåŠ¡æŒ‡æ ‡
âœ… é¢„è­¦æœºåˆ¶ï¼šæå‰å‘ç°é—®é¢˜è¶‹åŠ¿
âœ… è‡ªåŠ¨æ¢å¤ï¼šç®€å•æ•…éšœè‡ªåŠ¨å¤„ç†
```

**ğŸ’¾ å¤‡ä»½æœ€ä½³å®è·µ**
```
âœ… 3-2-1åŸåˆ™ï¼š3ä¸ªå‰¯æœ¬ï¼Œ2ç§ä»‹è´¨ï¼Œ1ä¸ªå¼‚åœ°
âœ… å®šæœŸæµ‹è¯•ï¼šéªŒè¯å¤‡ä»½æ•°æ®çš„å¯ç”¨æ€§
âœ… åˆ†å±‚å¤‡ä»½ï¼šå®æ—¶+è¿‘å®æ—¶+å®šæœŸå¤‡ä»½
âœ… è‡ªåŠ¨åŒ–ï¼šå¤‡ä»½å’Œæ¢å¤è¿‡ç¨‹è‡ªåŠ¨åŒ–
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é«˜å¯ç”¨è®¾è®¡é˜²å•ç‚¹ï¼Œå¤šèŠ‚ç‚¹éƒ¨ç½²è¦å‡è¡¡
- è´Ÿè½½å‡è¡¡åŠ æ£€æŸ¥ï¼Œæ•…éšœåˆ‡æ¢è¦è‡ªåŠ¨  
- æ•°æ®æŒä¹…ä¸ä¸¢å¤±ï¼Œå¤‡ä»½æ¢å¤è¦å®Œå–„
- ç›‘æ§å‘Šè­¦æ˜¯åŸºç¡€ï¼Œæ¼”ç»ƒä¼˜åŒ–ä¿å¯ç”¨

**å®æ–½è¦ç‚¹**ï¼š
1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆå®ç°åŸºç¡€çš„ä¸»ä»æ¶æ„
2. **é€æ­¥å®Œå–„**ï¼šæ ¹æ®å®é™…éœ€æ±‚å¢åŠ åŠŸèƒ½
3. **é‡è§†ç›‘æ§**ï¼šå®Œå–„çš„ç›‘æ§æ˜¯é«˜å¯ç”¨çš„åŸºç¡€
4. **å®šæœŸæ¼”ç»ƒ**ï¼šé€šè¿‡æ¼”ç»ƒéªŒè¯å’Œæ”¹è¿›æ–¹æ¡ˆ