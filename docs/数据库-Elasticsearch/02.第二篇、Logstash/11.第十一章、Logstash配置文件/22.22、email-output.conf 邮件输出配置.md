---
title: 22、email-output.conf 邮件输出配置
---
## 📚 目录

1. [邮件输出插件概述](#1-邮件输出插件概述)
2. [SMTP服务器配置详解](#2-SMTP服务器配置详解)
3. [认证与安全配置](#3-认证与安全配置)
4. [邮件内容定制](#4-邮件内容定制)
5. [发送控制与优化](#5-发送控制与优化)
6. [实际应用场景配置](#6-实际应用场景配置)
7. [故障排查与最佳实践](#7-故障排查与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📧 邮件输出插件概述


### 1.1 什么是邮件输出插件


**简单理解**：就像你的手机可以发短信一样，Logstash的邮件输出插件可以自动发送邮件

```
数据流向示意：
日志数据 → Logstash处理 → 触发条件 → 发送邮件 → 运维人员收到通知

实际场景：
服务器出错 → 错误日志 → Logstash检测到错误 → 自动发邮件通知管理员
```

**核心作用**：
- **🚨 自动告警**：系统出问题时自动发邮件通知
- **📊 定期报告**：定时发送系统状态报告
- **📝 事件通知**：重要事件发生时及时通知相关人员

### 1.2 邮件输出的工作原理


```
工作流程图：
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  输入数据   │───▶│  条件判断   │───▶│  发送邮件   │
│ (日志事件)  │    │ (是否告警)  │    │ (SMTP发送)  │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │  邮件模板   │
                   │ (主题+内容) │
                   └─────────────┘
```

**工作步骤**：
1. **接收数据**：从input或filter传来的事件数据
2. **条件判断**：检查是否满足发送邮件的条件
3. **内容生成**：根据模板生成邮件主题和正文
4. **SMTP发送**：通过邮件服务器发送邮件

---

## 2. 🔧 SMTP服务器配置详解


### 2.1 基础SMTP配置


**什么是SMTP**：就像邮局一样，SMTP服务器负责把你的邮件送到收件人那里

```ruby
output {
  email {
    # SMTP服务器地址（就像邮局的地址）
    host => "smtp.qq.com"
    
    # SMTP端口（就像邮局的门牌号）
    port => 587
    
    # 发件人邮箱（你的邮箱地址）
    from => "your-logstash@qq.com"
    
    # 收件人邮箱（通知谁）
    to => ["admin@company.com", "ops@company.com"]
  }
}
```

### 2.2 常用邮件服务商配置


**📮 QQ邮箱配置**
```ruby
output {
  email {
    host => "smtp.qq.com"
    port => 587              # 使用TLS加密
    # port => 465            # 使用SSL加密
    use_tls => true
    
    from => "your-qq@qq.com"
    username => "your-qq@qq.com"
    password => "你的授权码"    # 注意：不是QQ密码，是授权码
  }
}
```

**📮 163邮箱配置**
```ruby
output {
  email {
    host => "smtp.163.com"
    port => 587
    use_tls => true
    
    from => "your-163@163.com"
    username => "your-163@163.com"
    password => "你的客户端密码"
  }
}
```

**📮 Gmail配置**
```ruby
output {
  email {
    host => "smtp.gmail.com"
    port => 587
    use_tls => true
    
    from => "your-email@gmail.com"
    username => "your-email@gmail.com"
    password => "应用专用密码"    # 需要开启两步验证
  }
}
```

### 2.3 端口选择说明


| 端口号 | 加密方式 | 使用场景 | 安全性 |
|--------|----------|----------|--------|
| **25** | 无加密 | `内网环境` | ⚠️ 不安全 |
| **587** | STARTTLS | `推荐使用` | ✅ 安全 |
| **465** | SSL/TLS | `传统加密` | ✅ 安全 |

> 💡 **新手建议**：优先使用587端口配合`use_tls => true`，这是目前最通用的配置

---

## 3. 🔐 认证与安全配置


### 3.1 用户名密码认证


```ruby
output {
  email {
    # 基础认证信息
    username => "your-email@domain.com"    # 登录用户名
    password => "your-password"            # 登录密码
    
    # 认证方式（一般自动检测，不用手动设置）
    # auth => "login"                      # 可选：login, plain, cram_md5
  }
}
```

**🔑 密码获取方法**：

**QQ邮箱**：
```
步骤：QQ邮箱 → 设置 → 账户 → POP3/IMAP服务 → 开启 → 获取授权码
注意：不是QQ密码，是16位的授权码
```

**163邮箱**：
```
步骤：163邮箱 → 设置 → POP3/SMTP服务 → 开启 → 设置客户端密码
注意：需要设置独立的客户端密码
```

### 3.2 TLS/SSL加密配置


```ruby
output {
  email {
    # TLS加密（推荐）
    use_tls => true                 # 启用TLS加密
    port => 587                     # TLS常用端口
    
    # 或者SSL加密
    # use_ssl => true               # 启用SSL加密  
    # port => 465                   # SSL常用端口
    
    # 证书验证（生产环境建议开启）
    enable_starttls_auto => true    # 自动启用STARTTLS
  }
}
```

**🔒 安全级别对比**：
- **无加密**：密码明文传输，极不安全
- **TLS加密**：现代标准，安全可靠
- **SSL加密**：传统方式，同样安全

---

## 4. ✉️ 邮件内容定制


### 4.1 邮件主题配置


```ruby
output {
  email {
    # 静态主题
    subject => "系统告警通知"
    
    # 动态主题（根据日志内容变化）
    subject => "[%{level}] %{host} 系统告警"
    
    # 复杂主题模板
    subject => "🚨 [%{level}] %{timestamp} - %{service_name} 异常"
  }
}
```

**📝 主题模板示例**：
```ruby
# 根据告警级别显示不同emoji
subject => "%{level == 'ERROR' ? '🔴' : level == 'WARN' ? '🟡' : '🟢'} [%{level}] %{host} 告警"

# 包含时间戳
subject => "[告警] %{+YYYY-MM-dd HH:mm:ss} - %{message}"
```

### 4.2 邮件正文格式


**📄 纯文本格式**：
```ruby
output {
  email {
    body => "告警时间: %{@timestamp}
服务器: %{host}
级别: %{level}
详细信息: %{message}

请及时处理！"
  }
}
```

**🎨 HTML格式**：
```ruby
output {
  email {
    htmlbody => "<html>
<head><title>系统告警</title></head>
<body>
<h2 style='color: red;'>🚨 系统告警通知</h2>
<table border='1' style='border-collapse: collapse;'>
  <tr><td><b>告警时间</b></td><td>%{@timestamp}</td></tr>
  <tr><td><b>服务器</b></td><td>%{host}</td></tr>
  <tr><td><b>级别</b></td><td style='color: red;'>%{level}</td></tr>
  <tr><td><b>详细信息</b></td><td>%{message}</td></tr>
</table>
<p>请及时处理此告警！</p>
</body>
</html>"
  }
}
```

### 4.3 收发件人设置


```ruby
output {
  email {
    # 发件人信息
    from => "logstash-alert@company.com"        # 发件人邮箱
    replyto => "no-reply@company.com"           # 回复邮箱
    
    # 收件人设置
    to => ["admin@company.com"]                 # 主要收件人
    cc => ["manager@company.com"]               # 抄送
    bcc => ["backup@company.com"]               # 密送
    
    # 动态收件人（根据条件发送给不同的人）
    to => "%{department}@company.com"
  }
}
```

**👥 多收件人配置**：
```ruby
output {
  email {
    # 多个固定收件人
    to => [
      "ops-team@company.com",
      "dev-team@company.com", 
      "manager@company.com"
    ]
    
    # 根据告警级别发送给不同的人
    to => "%{level == 'CRITICAL' ? 'emergency@company.com' : 'normal@company.com'}"
  }
}
```

---

## 5. ⏱️ 发送控制与优化


### 5.1 发送频率控制


**为什么需要频率控制**：避免邮件轰炸，防止同一个问题发送太多邮件

```ruby
output {
  email {
    # 发送间隔控制（单位：秒）
    throttle_time => 300              # 5分钟内相同内容只发送一次
    
    # 基于特定字段的去重
    throttle_key => "%{host}_%_{level}"   # 相同主机相同级别的告警合并
  }
}
```

### 5.2 条件发送配置


```ruby
output {
  # 只有ERROR级别才发邮件
  if [level] == "ERROR" {
    email {
      to => "emergency@company.com"
      subject => "🔴 紧急告警：%{message}"
    }
  }
  
  # WARN级别发给不同的人
  if [level] == "WARN" {
    email {
      to => "warning@company.com"
      subject => "🟡 警告信息：%{message}"
    }
  }
}
```

### 5.3 邮件大小控制


```ruby
output {
  email {
    # 限制邮件正文长度
    body => "%{message}".length > 1000 ? "%{message}"[0..1000] + "..." : "%{message}"
    
    # 使用简化模板减少邮件大小
    htmlbody => "<h3>告警</h3><p>%{@timestamp}</p><p>%{message}</p>"
  }
}
```

---

## 6. 🎯 实际应用场景配置


### 6.1 系统错误告警配置


```ruby
input {
  file {
    path => "/var/log/application.log"
    start_position => "end"
  }
}

filter {
  # 解析日志级别
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:level}\] %{GREEDYDATA:msg}" }
  }
  
  # 添加主机信息
  mutate {
    add_field => { "host" => "%{HOST}" }
  }
}

output {
  # 只对ERROR和FATAL级别发送邮件
  if [level] in ["ERROR", "FATAL"] {
    email {
      host => "smtp.qq.com"
      port => 587
      use_tls => true
      
      username => "alert@company.com"
      password => "your-auth-code"
      
      from => "logstash-alert@company.com"
      to => ["ops@company.com", "dev@company.com"]
      
      subject => "🚨 [%{level}] %{host} 系统错误告警"
      
      htmlbody => "
<html>
<body>
<h2 style='color: red;'>系统错误告警</h2>
<table border='1' style='border-collapse: collapse; width: 100%;'>
  <tr><td><b>告警时间</b></td><td>%{@timestamp}</td></tr>
  <tr><td><b>服务器</b></td><td>%{host}</td></tr>
  <tr><td><b>错误级别</b></td><td style='color: red; font-weight: bold;'>%{level}</td></tr>
  <tr><td><b>错误信息</b></td><td>%{msg}</td></tr>
</table>
<p style='color: red;'><b>请立即检查并处理此错误！</b></p>
</body>
</html>"
      
      # 5分钟内相同错误只发一次
      throttle_time => 300
      throttle_key => "%{host}_%{level}_%{msg}"
    }
  }
}
```

### 6.2 定期状态报告配置


```ruby
input {
  # 使用定时器触发
  heartbeat {
    interval => 3600    # 每小时触发一次
  }
}

filter {
  # 收集系统状态信息
  ruby {
    code => "
      require 'sys/filesystem'
      require 'sys/cpu'
      
      # 获取磁盘使用率
      stat = Sys::Filesystem.stat('/')
      disk_usage = ((stat.bytes - stat.bytes_available).to_f / stat.bytes * 100).round(2)
      
      # 获取负载信息
      load_avg = File.read('/proc/loadavg').split[0].to_f
      
      event.set('disk_usage', disk_usage)
      event.set('load_average', load_avg)
      event.set('report_time', Time.now.strftime('%Y-%m-%d %H:%M:%S'))
    "
  }
}

output {
  email {
    host => "smtp.163.com"
    port => 587
    use_tls => true
    
    username => "monitor@163.com"
    password => "your-password"
    
    from => "system-monitor@company.com"
    to => "admin@company.com"
    
    subject => "📊 系统状态报告 - %{report_time}"
    
    htmlbody => "
<html>
<body>
<h2>🖥️ 系统状态报告</h2>
<p><b>报告时间：</b>%{report_time}</p>

<h3>📈 系统指标</h3>
<ul>
  <li><b>磁盘使用率：</b>%{disk_usage}%</li>
  <li><b>系统负载：</b>%{load_average}</li>
  <li><b>服务器：</b>%{host}</li>
</ul>

<h3>🟢 状态说明</h3>
<p>系统运行正常，各项指标在正常范围内。</p>
</body>
</html>"
  }
}
```

### 6.3 业务异常监控配置


```ruby
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "payment" {
    # 解析支付日志
    json {
      source => "message"
    }
    
    # 检测支付失败
    if [status] == "failed" and [amount] {
      mutate {
        add_field => { "alert_type" => "payment_failure" }
        add_field => { "severity" => "high" }
      }
    }
  }
}

output {
  if [alert_type] == "payment_failure" {
    email {
      host => "smtp.gmail.com"
      port => 587
      use_tls => true
      
      username => "alerts@company.com"
      password => "app-specific-password"
      
      from => "payment-monitor@company.com"
      to => ["finance@company.com", "tech@company.com"]
      cc => "manager@company.com"
      
      subject => "💳 支付系统异常告警 - 金额 ¥%{amount}"
      
      htmlbody => "
<html>
<body>
<h2 style='color: red;'>💳 支付系统异常告警</h2>

<div style='background-color: #ffebee; padding: 15px; border-left: 5px solid #f44336;'>
  <h3>📋 异常详情</h3>
  <p><b>时间：</b>%{@timestamp}</p>
  <p><b>订单号：</b>%{order_id}</p>
  <p><b>金额：</b>¥%{amount}</p>
  <p><b>用户ID：</b>%{user_id}</p>
  <p><b>失败原因：</b>%{error_message}</p>
</div>

<h3>🔧 建议处理步骤</h3>
<ol>
  <li>检查支付网关状态</li>
  <li>验证用户账户余额</li>
  <li>联系客户确认支付意图</li>
  <li>必要时进行人工处理</li>
</ol>

<p style='color: red;'><b>请在30分钟内处理此异常！</b></p>
</body>
</html>"
      
      # 防止重复发送
      throttle_time => 600    # 10分钟内相同订单只发一次
      throttle_key => "%{order_id}"
    }
  }
}
```

---

## 7. 🔍 故障排查与最佳实践


### 7.1 常见问题排查


**📧 邮件发送失败**

> ⚠️ **问题**：邮件无法发送

**排查步骤**：
```ruby
output {
  email {
    # 开启调试模式
    debug => true
    
    # 检查配置
    host => "smtp.qq.com"      # 确认SMTP服务器地址正确
    port => 587                # 确认端口号正确
    use_tls => true            # 确认加密方式
    
    username => "your@qq.com"  # 确认用户名格式
    password => "auth-code"    # 确认使用授权码而非登录密码
  }
}
```

**🔐 认证失败问题**

```bash
# 检查Logstash日志
tail -f /var/log/logstash/logstash-plain.log | grep -i email

# 常见错误信息：
# "535 Error: authentication failed" - 密码错误
# "553 Mail from must equal authorized user" - 发件人设置错误
# "Connection refused" - 网络连接问题
```

### 7.2 性能优化建议


**⚡ 减少邮件发送量**：
```ruby
output {
  # 使用聚合减少邮件数量
  if [level] == "ERROR" {
    aggregate {
      task_id => "%{host}"
      code => "
        map['error_count'] ||= 0
        map['error_count'] += 1
        map['first_error'] ||= event.get('@timestamp')
        map['last_error'] = event.get('@timestamp')
        map['errors'] ||= []
        map['errors'] << event.get('message')
      "
      push_previous_map_as_event => true
      timeout => 300    # 5分钟聚合一次
    }
    
    email {
      subject => "📊 错误汇总报告 - %{host} (%{error_count}个错误)"
      body => "时间范围: %{first_error} 到 %{last_error}
错误总数: %{error_count}
错误列表: %{errors}"
    }
  }
}
```

### 7.3 最佳实践建议


**✅ 配置规范**：

1. **使用环境变量存储密码**：
```ruby
output {
  email {
    username => "${SMTP_USERNAME}"
    password => "${SMTP_PASSWORD}"
  }
}
```

2. **设置合理的发送频率**：
```ruby
output {
  email {
    # 避免邮件轰炸
    throttle_time => 300              # 最短5分钟间隔
    
    # 重要告警缩短间隔
    throttle_time => "%{level == 'CRITICAL' ? 60 : 300}"
  }
}
```

3. **邮件内容优化**：
```ruby
output {
  email {
    # 主题简洁明了
    subject => "[%{level}] %{host} - %{service}"
    
    # 正文包含关键信息
    body => "时间: %{@timestamp}
级别: %{level}
主机: %{host}
服务: %{service}
消息: %{message}

处理链接: http://dashboard.company.com/alerts/%{alert_id}"
  }
}
```

**🛡️ 安全建议**：
- 使用应用专用密码而非主密码
- 启用TLS/SSL加密传输
- 定期更换邮箱密码
- 限制发件人IP地址（如有条件）

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基础配置


```ruby
# 最简单的邮件配置模板
output {
  email {
    # SMTP服务器设置
    host => "smtp.qq.com"           # 邮件服务商SMTP地址
    port => 587                     # 推荐使用587端口
    use_tls => true                 # 启用TLS加密
    
    # 认证信息
    username => "your@qq.com"       # 发件邮箱
    password => "authorization-code" # 授权码（不是登录密码）
    
    # 邮件信息
    from => "logstash@company.com"  # 发件人
    to => "admin@company.com"       # 收件人
    subject => "系统告警"            # 邮件主题
    body => "%{message}"            # 邮件内容
  }
}
```

### 8.2 关键理解要点


**🔹 SMTP配置本质**
```
理解要点：
- SMTP就像邮局，需要告诉它地址(host)和门牌号(port)
- 认证就像寄快递要登记身份证
- 加密就像给邮件上锁，防止别人偷看
```

**🔹 邮件模板的作用**
```
模板价值：
- 统一格式：所有告警邮件格式一致，便于识别
- 动态内容：根据实际情况填入不同的值
- 易于维护：修改一次模板，所有邮件都会更新
```

**🔹 频率控制的重要性**
```
为什么需要：
- 防止邮件轰炸：同一个问题不要发太多邮件
- 提高效率：运维人员不被无用邮件淹没
- 节省资源：减少网络和服务器负担
```

### 8.3 实际应用价值


**🎯 监控告警场景**
- **系统错误**：服务器出错时自动通知运维团队
- **性能异常**：CPU、内存、磁盘使用率过高时告警
- **业务异常**：支付失败、用户登录异常等业务问题

**📊 报告统计场景**
- **定期报告**：每日/每周系统状态汇总
- **数据统计**：访问量、错误率等关键指标报告
- **合规报告**：安全日志、审计信息定期发送

**🔧 运维实践价值**
- **提高效率**：自动化告警减少人工监控工作量
- **快速响应**：问题发生时第一时间收到通知
- **团队协作**：相关人员同时收到信息，便于协作处理

### 8.4 配置要点记忆


> 💡 **配置口诀**：
> - 服务器端口要选对，TLS加密不能少
> - 用户密码要正确，授权码比密码好  
> - 主题内容要清晰，模板变量巧使用
> - 频率控制很重要，避免邮件满天飞

**核心记忆**：
- 邮件输出就是自动发邮件通知系统
- SMTP配置就像设置邮局地址和身份认证
- 模板让邮件内容动态变化，包含实际的告警信息
- 频率控制防止同一问题发送太多邮件
- 通过条件判断控制什么情况下才发邮件