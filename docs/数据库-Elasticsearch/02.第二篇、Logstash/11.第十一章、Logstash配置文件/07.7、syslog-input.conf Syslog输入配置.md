---
title: 7、syslog-input.conf Syslog输入配置
---
## 📚 目录

1. [什么是Syslog输入](#1-什么是syslog输入)
2. [Syslog基础概念](#2-syslog基础概念)
3. [UDP与TCP协议选择](#3-udp与tcp协议选择)
4. [监听配置详解](#4-监听配置详解)
5. [标签映射系统](#5-标签映射系统)
6. [时间和地区设置](#6-时间和地区设置)
7. [解析模式配置](#7-解析模式配置)
8. [完整配置示例](#8-完整配置示例)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🌐 什么是Syslog输入


### 1.1 Syslog的本质


**通俗理解**：想象一下，Syslog就像是一个"日志邮递员"，专门负责收集和传递各种设备的日志消息。

```
现实场景类比：
邮递员收信 → Syslog收集日志
邮局分拣信件 → Logstash处理日志
按地址投递 → 发送到指定存储

设备日志流向：
服务器/路由器/防火墙 → Syslog协议 → Logstash → Elasticsearch
```

**核心作用**：
- 📨 **统一收集**：把分散在各个设备上的日志统一收集
- 🏷️ **标准格式**：将不同格式的日志转换为标准格式
- 🚀 **实时传输**：支持实时日志传输，不会丢失重要信息

### 1.2 为什么需要Syslog输入


**问题场景**：
```
传统方式的困扰：
❌ 登录每台服务器查看日志 → 效率低下
❌ 日志格式不统一 → 难以分析
❌ 重要日志可能丢失 → 故障排查困难
❌ 无法实时监控 → 问题发现滞后

Syslog解决方案：
✅ 集中收集所有日志 → 一站式查看
✅ 统一日志格式 → 便于分析处理
✅ 可靠传输机制 → 减少日志丢失
✅ 实时处理能力 → 及时发现问题
```

---

## 2. 📋 Syslog基础概念


### 2.1 Syslog协议原理


**工作机制**：
```
发送端(Client)                    接收端(Server)
    |                                 |
    |--发送日志消息----------------->|
    |  (包含设施+严重性+内容)        |
    |                                 |
    |<------确认收到(TCP模式)--------|
```

### 2.2 设施（Facility）概念


**什么是设施**：设施就像是"日志的分类标签"，告诉我们这条日志来自哪个系统组件。

| 设施编号 | **设施名称** | **通俗含义** | **典型来源** |
|---------|-------------|-------------|-------------|
| 0 | `kernel` | `内核消息` | `系统内核、驱动程序` |
| 1 | `user` | `用户程序` | `用户空间的应用程序` |
| 2 | `mail` | `邮件系统` | `邮件服务器、邮件客户端` |
| 3 | `daemon` | `系统守护进程` | `SSH、FTP等系统服务` |
| 4 | `auth` | `安全认证` | `登录、权限验证` |
| 5 | `syslog` | `Syslog自身` | `Syslog服务本身的消息` |
| 16-23 | `local0-7` | `自定义用途` | `用户自定义的应用程序` |

### 2.3 严重性（Severity）级别


**严重性的作用**：就像医院的"病情严重程度"分级，帮助我们快速判断日志的重要性。

| 级别 | **名称** | **含义** | **何时使用** |
|-----|---------|---------|-------------|
| 0 | `emergency` | `系统完全不可用` | `整个系统崩溃` |
| 1 | `alert` | `必须立即处理` | `数据库连接失败` |
| 2 | `critical` | `严重错误` | `硬盘空间不足` |
| 3 | `error` | `一般错误` | `应用程序报错` |
| 4 | `warning` | `警告信息` | `配置问题提醒` |
| 5 | `notice` | `正常但重要` | `服务启动停止` |
| 6 | `info` | `一般信息` | `用户登录记录` |
| 7 | `debug` | `调试信息` | `开发调试日志` |

---

## 3. 🔗 UDP与TCP协议选择


### 3.1 UDP协议特点


**UDP的本质**：就像"发短信"，发出去就不管了，速度快但不保证对方收到。

```
UDP协议特点：
📤 发送方式：发完就走，不等确认
🚀 传输速度：非常快速
📊 系统开销：很小
⚠️ 可靠性：可能丢失数据
🔢 连接方式：无连接状态
```

**适用场景**：
- ✅ **高频日志**：每秒成千上万条日志
- ✅ **性能优先**：系统资源紧张的环境  
- ✅ **可容忍丢失**：少量日志丢失影响不大
- ✅ **网络稳定**：内网环境，网络质量好

### 3.2 TCP协议特点


**TCP的本质**：就像"挂号信"，必须确认对方收到才算完成，可靠但稍慢。

```
TCP协议特点：
🤝 发送方式：握手确认，保证送达
🔒 传输可靠：几乎不会丢失数据
📈 系统开销：相对较大
⏱️ 传输速度：比UDP稍慢
🔗 连接方式：维护连接状态
```

**适用场景**：
- ✅ **重要日志**：安全日志、审计日志
- ✅ **可靠性优先**：不能容忍数据丢失
- ✅ **跨网传输**：通过互联网传输日志
- ✅ **连接稳定**：需要长期稳定连接

### 3.3 协议选择指南


```
选择决策树：

日志是否非常重要？
├─ 是 → 选择TCP（如：安全审计日志）
└─ 否 → 继续判断

网络环境是否稳定？
├─ 不稳定 → 选择TCP（如：跨网传输）
└─ 稳定 → 继续判断

日志量是否巨大？
├─ 是 → 选择UDP（如：调试日志）
└─ 否 → 选择TCP（更安全）
```

---

## 4. 🔧 监听配置详解


### 4.1 端口和地址绑定


**基础配置语法**：
```ruby
input {
  syslog {
    port => 514          # 监听端口
    host => "0.0.0.0"    # 监听地址
    protocol => "udp"    # 协议类型
  }
}
```

**地址绑定详解**：

| 地址配置 | **含义** | **使用场景** |
|---------|---------|-------------|
| `"0.0.0.0"` | `监听所有网卡` | `接收来自任何地址的日志` |
| `"127.0.0.1"` | `只监听本机` | `只处理本机日志` |
| `"192.168.1.100"` | `监听指定IP` | `只接收特定网段的日志` |

**端口选择建议**：
- 🔸 **514**：Syslog标准端口（需要root权限）
- 🔸 **5514**：常用的非特权端口
- 🔸 **自定义**：根据网络规划选择

### 4.2 高级监听配置


```ruby
input {
  syslog {
    # 基础连接配置
    port => 5514
    host => "0.0.0.0"
    protocol => "tcp"
    
    # TCP专有配置
    tcp_keep_alive => true     # 保持连接活跃
    
    # 缓冲区配置
    receive_buffer_bytes => 1048576  # 1MB接收缓冲区
  }
}
```

---

## 5. 🏷️ 标签映射系统


### 5.1 设施标签映射


**什么是facility_labels**：就像给数字编号贴上"名字标签"，让人一眼就知道日志来源。

```ruby
input {
  syslog {
    port => 514
    
    # 设施标签映射
    facility_labels => {
      "0"  => "kernel"        # 内核消息
      "1"  => "user"          # 用户程序
      "2"  => "mail"          # 邮件系统
      "3"  => "daemon"        # 系统服务
      "4"  => "auth"          # 认证系统
      "16" => "local0"        # 自定义应用1
      "17" => "local1"        # 自定义应用2
    }
  }
}
```

**实际效果对比**：
```
不使用标签映射：
facility => 16              # 看到数字，不知道含义

使用标签映射后：
facility => 16
facility_label => "local0"  # 一眼明了是自定义应用
```

### 5.2 严重性标签映射


```ruby
input {
  syslog {
    port => 514
    
    # 严重性标签映射
    severity_labels => {
      "0" => "emergency"      # 紧急情况
      "1" => "alert"          # 警报
      "2" => "critical"       # 严重
      "3" => "error"          # 错误
      "4" => "warning"        # 警告
      "5" => "notice"         # 通知
      "6" => "info"           # 信息
      "7" => "debug"          # 调试
    }
  }
}
```

### 5.3 标签使用开关


**use_labels参数**：控制是否生成友好的标签字段。

```ruby
input {
  syslog {
    port => 514
    use_labels => true      # 开启标签生成
    facility_labels => { ... }
    severity_labels => { ... }
  }
}
```

**对比效果**：
```
use_labels => false 时：
{
  "facility" => 16,
  "severity" => 6
}

use_labels => true 时：
{
  "facility" => 16,
  "facility_label" => "local0",
  "severity" => 6,
  "severity_label" => "info"
}
```

---

## 6. ⏰ 时间和地区设置


### 6.1 时区设置详解


**timezone参数**：告诉Logstash如何理解日志中的时间戳。

```ruby
input {
  syslog {
    port => 514
    timezone => "Asia/Shanghai"    # 中国时区
  }
}
```

**常用时区配置**：
- `"Asia/Shanghai"` - 中国时区
- `"UTC"` - 世界标准时间
- `"America/New_York"` - 纽约时区
- `"Europe/London"` - 伦敦时区

**时区的重要性**：
```
错误时区设置的后果：
📅 时间戳错乱 → 日志时间线混乱
🔍 查询困难 → 无法准确定位问题时间
📊 统计偏差 → 时间统计图表错误
```

### 6.2 地区设置


**locale参数**：控制日期格式的解析方式。

```ruby
input {
  syslog {
    port => 514
    locale => "en_US.UTF-8"    # 美式英语，UTF-8编码
  }
}
```

**locale的作用**：
```
影响内容：
📅 日期格式解析 (MM/DD vs DD/MM)
🔤 字符编码处理 (UTF-8, GBK等)
🌐 本地化数字格式
```

---

## 7. 🎯 解析模式配置


### 7.1 grok_pattern基础


**什么是Grok模式**：就像"翻译器"，把复杂的日志文本拆解成结构化的字段。

```ruby
input {
  syslog {
    port => 514
    
    # 自定义解析模式
    grok_pattern => "%{TIMESTAMP_ISO8601:timestamp} %{WORD:hostname} %{WORD:program}: %{GREEDYDATA:message}"
  }
}
```

### 7.2 常用Grok模式


**基础模式组件**：
- `%{TIMESTAMP_ISO8601:timestamp}` - 解析时间戳
- `%{WORD:hostname}` - 解析主机名
- `%{WORD:program}` - 解析程序名
- `%{GREEDYDATA:message}` - 解析剩余内容

### 7.3 自定义解析示例


```ruby
# 解析Nginx访问日志格式的Syslog
input {
  syslog {
    port => 514
    grok_pattern => '%{SYSLOGTIMESTAMP:syslog_timestamp} %{WORD:hostname} %{WORD:program}: %{IPORHOST:client_ip} - - \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{URIPATH:request} HTTP/%{NUMBER:http_version}" %{NUMBER:response_code} %{NUMBER:bytes}'
  }
}
```

---

## 8. 📋 完整配置示例


### 8.1 基础UDP配置


```ruby
# 07-syslog-input.conf - 基础UDP配置
input {
  syslog {
    # 基础连接设置
    port => 514
    host => "0.0.0.0"
    protocol => "udp"
    
    # 标签映射
    use_labels => true
    facility_labels => {
      "0"  => "kernel"
      "1"  => "user"
      "2"  => "mail"
      "3"  => "daemon"
      "4"  => "auth"
      "5"  => "syslog"
      "16" => "local0"
      "17" => "local1"
      "18" => "local2"
      "19" => "local3"
    }
    
    severity_labels => {
      "0" => "emergency"
      "1" => "alert"
      "2" => "critical"
      "3" => "error"
      "4" => "warning"
      "5" => "notice"
      "6" => "info"
      "7" => "debug"
    }
    
    # 时区和地区设置
    timezone => "Asia/Shanghai"
    locale => "en_US.UTF-8"
  }
}

# 输出到控制台查看效果
output {
  stdout {
    codec => rubydebug
  }
}
```

### 8.2 高可用TCP配置


```ruby
# 高可用TCP Syslog配置
input {
  syslog {
    # TCP连接设置
    port => 5514
    host => "0.0.0.0"
    protocol => "tcp"
    
    # TCP优化参数
    tcp_keep_alive => true
    
    # 标签和解析设置
    use_labels => true
    facility_labels => {
      "16" => "webapp"
      "17" => "database"
      "18" => "nginx"
      "19" => "redis"
    }
    
    severity_labels => {
      "0" => "emergency"
      "1" => "alert"
      "2" => "critical"
      "3" => "error"
      "4" => "warning"
      "5" => "notice"
      "6" => "info"
      "7" => "debug"
    }
    
    # 时区设置
    timezone => "Asia/Shanghai"
    locale => "zh_CN.UTF-8"
  }
}

filter {
  # 添加自定义字段
  mutate {
    add_field => { "log_source" => "syslog" }
    add_tag => [ "syslog_processed" ]
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "syslog-logs-%{+YYYY.MM.dd}"
  }
}
```

### 8.3 多端口监听配置


```ruby
# 同时监听多个端口和协议
input {
  # 标准UDP Syslog
  syslog {
    port => 514
    protocol => "udp"
    type => "syslog_udp"
    use_labels => true
    timezone => "Asia/Shanghai"
  }
  
  # 安全TCP Syslog
  syslog {
    port => 6514
    protocol => "tcp"
    type => "syslog_tcp_secure"
    use_labels => true
    timezone => "Asia/Shanghai"
  }
  
  # 应用专用端口
  syslog {
    port => 10514
    protocol => "udp"
    type => "syslog_app"
    use_labels => true
    timezone => "Asia/Shanghai"
    
    # 应用专用标签
    facility_labels => {
      "16" => "web_frontend"
      "17" => "api_backend" 
      "18" => "message_queue"
      "19" => "cache_layer"
    }
  }
}

filter {
  # 根据类型添加不同标签
  if [type] == "syslog_udp" {
    mutate { add_tag => ["standard_syslog"] }
  } else if [type] == "syslog_tcp_secure" {
    mutate { add_tag => ["secure_syslog"] }
  } else if [type] == "syslog_app" {
    mutate { add_tag => ["application_syslog"] }
  }
}
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 Syslog本质：统一的日志收集和传输协议
🔸 协议选择：UDP速度快，TCP更可靠
🔸 设施/严重性：日志的分类和重要性标识
🔸 标签映射：将数字编号转换为易懂的名称
🔸 时区设置：确保时间戳的正确解析
🔸 解析模式：将非结构化日志转为结构化数据
```

### 9.2 配置要点记忆


**🔹 端口和协议配置**
```
记忆要点：
- 514是标准端口，需要root权限
- UDP适合高频日志，TCP适合重要日志  
- 0.0.0.0监听所有地址，127.0.0.1只监听本机
```

**🔹 标签系统的价值**
```
核心作用：
- facility_labels：告诉你日志来源（哪个系统组件）
- severity_labels：告诉你日志重要性（紧急程度）
- use_labels：控制是否生成友好标签
```

**🔹 时间处理的重要性**
```
关键配置：
- timezone：设置正确的时区，避免时间混乱
- locale：设置正确的地区格式，确保解析准确
```

### 9.3 实际应用建议


**配置选择策略**：
- 🎯 **小型环境**：使用UDP，单端口监听
- 🎯 **企业环境**：使用TCP，多端口分类接收
- 🎯 **混合环境**：UDP+TCP同时配置，按需分流

**监控和维护**：
- 📊 定期检查日志接收量和处理性能
- 🔍 监控端口连接状态和网络质量
- ⚙️ 根据实际使用情况优化缓冲区大小

**故障排查技巧**：
- 🔸 使用`stdout`输出验证配置正确性
- 🔸 检查防火墙和端口开放状态
- 🔸 确认客户端和服务端时区设置一致

**核心记忆**：
- Syslog是日志的"邮递员"，负责收集和传递
- UDP像发短信速度快，TCP像挂号信更可靠
- 标签映射让数字变成有意义的名称
- 时区设置决定时间戳是否正确