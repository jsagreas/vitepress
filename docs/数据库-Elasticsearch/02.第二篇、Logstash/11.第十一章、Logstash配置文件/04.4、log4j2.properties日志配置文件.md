---
title: 4、log4j2.properties日志配置文件
---
## 📚 目录

1. [什么是log4j2.properties配置文件](#1-什么是log4j2properties配置文件)
2. [rootLogger根日志级别配置](#2-rootlogger根日志级别配置)
3. [控制台输出器配置详解](#3-控制台输出器配置详解)
4. [滚动文件输出器配置](#4-滚动文件输出器配置)
5. [Logstash专用日志配置](#5-logstash专用日志配置)
6. [慢日志配置与监控](#6-慢日志配置与监控)
7. [滚动策略与文件管理](#7-滚动策略与文件管理)
8. [日志格式模式定制](#8-日志格式模式定制)
9. [文件删除策略配置](#9-文件删除策略配置)
10. [完整配置示例与最佳实践](#10-完整配置示例与最佳实践)

---

## 1. 📝 什么是log4j2.properties配置文件


### 1.1 基本概念理解


**简单来说**：log4j2.properties就是告诉Logstash"把日志写到哪里、怎么写、写什么内容"的配置文件。

```
想象一下记日记：
📖 你要决定：
  - 在哪里写？(控制台 or 文件)
  - 写多详细？(级别控制)
  - 怎么分类？(不同组件不同处理)
  - 什么时候换本？(文件滚动)

log4j2.properties就是这个"写日记规则书"
```

### 1.2 为什么需要日志配置


**核心作用**：
- 🔍 **故障排查**：出问题时能快速定位原因
- 📊 **性能监控**：了解Logstash运行状况
- 🛡️ **安全审计**：记录重要操作和异常
- 📈 **优化指导**：分析慢操作，优化配置

### 1.3 配置文件位置


```
Logstash安装目录结构：
logstash/
├── config/
│   ├── log4j2.properties    ← 主要日志配置文件
│   ├── logstash.yml         ← Logstash主配置
│   └── startup.options      ← 启动选项
├── logs/                    ← 日志文件目录
└── bin/logstash            ← 启动脚本
```

> 💡 **新手提示**：配置文件路径通常是 `${LOGSTASH_HOME}/config/log4j2.properties`

---

## 2. ⚙️ rootLogger根日志级别配置


### 2.1 什么是rootLogger


**通俗解释**：rootLogger就像是"总管家"，控制整个Logstash的日志输出总开关。

```
日志级别从高到低：
ERROR  ← 只记录错误，最安静
WARN   ← 记录警告+错误
INFO   ← 记录信息+警告+错误，默认级别
DEBUG  ← 记录调试+所有上级，很详细
TRACE  ← 记录跟踪+所有，最详细但影响性能
```

### 2.2 配置语法说明


```properties
# 基本格式：级别, 输出器1, 输出器2...
rootLogger.level = INFO
rootLogger.appenderRef.console.ref = console
rootLogger.appenderRef.rolling.ref = rolling
```

**含义解读**：
- `level = INFO`：只记录INFO及以上级别的日志
- `appenderRef.console.ref`：把日志发送到控制台输出器
- `appenderRef.rolling.ref`：同时发送到滚动文件输出器

### 2.3 不同环境的级别选择


| 环境类型 | 推荐级别 | 说明 | 优缺点 |
|---------|---------|------|--------|
| **开发环境** | `DEBUG` | 看到详细执行过程 | ✅ 便于调试 ❌ 日志多 |
| **测试环境** | `INFO` | 平衡信息量和性能 | ✅ 信息适中 ⚖️ 均衡 |
| **生产环境** | `WARN` | 只关注问题和警告 | ✅ 性能好 ❌ 信息少 |
| **故障排查** | `DEBUG` | 临时开启详细日志 | ✅ 信息全 ⚠️ 临时使用 |

---

## 3. 🖥️ 控制台输出器配置详解


### 3.1 控制台输出器的作用


**简单理解**：就是把日志直接显示在命令行窗口里，方便实时查看。

```
启动Logstash时看到的滚动文字：
[2025-01-20T10:30:45,123][INFO ][logstash.runner] Starting...
[2025-01-20T10:30:46,456][INFO ][logstash.pipeline] Pipeline started

这些就是控制台输出器的效果
```

### 3.2 基础配置语法


```properties
# 定义控制台输出器
appender.console.type = Console
appender.console.name = console
appender.console.layout.type = PatternLayout
appender.console.layout.pattern = [%d{yyyy-MM-dd HH:mm:ss,SSS}][%-5level][%-25logger] %msg%n
```

**配置项解释**：
- `type = Console`：指定这是控制台类型的输出器
- `name = console`：给这个输出器起个名字，供rootLogger引用
- `layout.type = PatternLayout`：使用模式化布局
- `layout.pattern`：定义日志的显示格式

### 3.3 控制台输出的优缺点


```
✅ 优点：
- 实时看到日志，便于调试
- 启动问题能立即发现
- 不占用磁盘空间

❌ 缺点：
- 关闭窗口日志就丢失了
- 日志太多时刷屏很快
- 不适合长期运行的生产环境

🎯 适用场景：
- 开发调试阶段
- 短期测试运行
- 启动故障排查
```

---

## 4. 📁 滚动文件输出器配置


### 4.1 什么是滚动文件输出器


**形象比喻**：就像写日记，写满一本就换新本，旧本按日期保存。

```
滚动文件示例：
logs/
├── logstash-plain.log          ← 当前正在写的日志
├── logstash-plain-2025-01-19.log ← 昨天的日志
├── logstash-plain-2025-01-18.log ← 前天的日志
└── logstash-plain-2025-01-17.log ← 大前天的日志
```

### 4.2 基础配置详解


```properties
# 滚动文件输出器配置
appender.rolling.type = RollingFile
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:ls.logs}/logstash-plain.log
appender.rolling.filePattern = ${sys:ls.logs}/logstash-plain-%d{yyyy-MM-dd}-%i.log
appender.rolling.layout.type = PatternLayout
appender.rolling.layout.pattern = [%d{yyyy-MM-dd HH:mm:ss,SSS}][%-5level][%-25logger] %msg%n
```

**关键参数说明**：

| 参数 | 含义 | 示例 |
|------|------|------|
| `fileName` | 当前日志文件名 | `logstash-plain.log` |
| `filePattern` | 滚动后的文件名模式 | `logstash-plain-2025-01-20-1.log` |
| `%d{yyyy-MM-dd}` | 按日期滚动 | 每天生成新文件 |
| `%i` | 序号占位符 | 同一天多个文件时编号 |

### 4.3 滚动触发条件配置


```properties
# 滚动策略配置
appender.rolling.policies.type = Policies
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.rolling.policies.time.interval = 1
appender.rolling.policies.time.modulate = true
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.rolling.policies.size.size = 100MB
```

**触发条件解释**：
- `TimeBasedTriggeringPolicy`：基于时间滚动（每天）
- `interval = 1`：间隔1个单位（1天）
- `modulate = true`：在整点时刻滚动
- `SizeBasedTriggeringPolicy`：基于文件大小滚动
- `size = 100MB`：文件达到100MB就滚动

---

## 5. 🔧 Logstash专用日志配置


### 5.1 为什么需要专门配置


**核心原因**：Logstash内部有很多组件，不同组件的日志重要性不同，需要分别控制。

```
Logstash主要组件：
🔄 Pipeline (管道处理)    ← 最重要，建议INFO级别
📥 Input plugins (输入插件) ← 重要，建议INFO级别  
🔄 Filter plugins (过滤插件) ← 重要，建议INFO级别
📤 Output plugins (输出插件) ← 重要，建议INFO级别
⚙️ Runner (运行器)        ← 一般，建议WARN级别
🌐 Api (API服务)         ← 一般，建议WARN级别
```

### 5.2 基础Logstash日志配置


```properties
# Logstash核心组件日志配置
logger.logstash.name = logstash
logger.logstash.level = INFO
logger.logstash.additivity = false
logger.logstash.appenderRef.rolling.ref = rolling
```

**配置解释**：
- `name = logstash`：针对所有以"logstash"开头的日志器
- `level = INFO`：设置日志级别为INFO
- `additivity = false`：不继承父级日志器配置，避免重复
- `appenderRef.rolling.ref = rolling`：使用滚动文件输出器

### 5.3 细分组件日志配置


```properties
# 管道相关日志 - 最重要的部分
logger.pipeline.name = logstash.pipeline
logger.pipeline.level = INFO

# 输入插件日志
logger.inputs.name = logstash.inputs
logger.inputs.level = INFO

# 输出插件日志  
logger.outputs.name = logstash.outputs
logger.outputs.level = INFO

# 运行器日志 - 可以设置更高级别
logger.runner.name = logstash.runner
logger.runner.level = WARN
```

---

## 6. 🐌 慢日志配置与监控


### 6.1 什么是慢日志


**通俗解释**：慢日志就像是"性能监督员"，专门记录那些处理太慢的操作，帮你找出性能瓶颈。

```
正常处理：     事件 → [处理 0.1秒] → 输出 ✅
慢速处理：     事件 → [处理 5.2秒] → 输出 ⚠️ 记录慢日志

慢日志作用：
- 发现性能问题
- 定位慢的插件或配置  
- 优化处理流程
```

### 6.2 慢日志配置语法


```properties
# 慢日志配置
logger.slowlog.name = slowlog
logger.slowlog.level = TRACE
logger.slowlog.additivity = false
logger.slowlog.appenderRef.console.ref = console
logger.slowlog.appenderRef.rolling.ref = rolling
```

**配置说明**：
- `name = slowlog`：专门处理慢日志
- `level = TRACE`：使用TRACE级别捕获详细信息
- `additivity = false`：独立输出，不重复

### 6.3 慢日志阈值设置


在 `logstash.yml` 中配置慢日志阈值：

```yaml
# 设置慢日志阈值（毫秒）
slowlog.threshold.warn: 2000    # 超过2秒记录警告
slowlog.threshold.info: 1000    # 超过1秒记录信息
slowlog.threshold.debug: 500    # 超过0.5秒记录调试
slowlog.threshold.trace: 100    # 超过0.1秒记录跟踪
```

### 6.4 慢日志分析示例


```
慢日志输出示例：
[2025-01-20T14:30:45,123][WARN ][slowlog] event processing time 
{:plugin=>"elasticsearch", :took_in_millis=>3456, :event=>{...}}

分析要点：
- plugin: elasticsearch ← 是ES输出插件慢了
- took_in_millis: 3456  ← 耗时3.4秒
- event: {...}          ← 具体的事件数据
```

---

## 7. 🔄 滚动策略与文件管理


### 7.1 滚动策略类型对比


```
📅 时间滚动 vs 📏 大小滚动：

时间滚动：
⏰ 每天午夜0点生成新文件
✅ 便于按日期查找日志
✅ 文件数量可预期
❌ 单个文件可能过大

大小滚动：  
📏 文件达到指定大小就滚动
✅ 控制单个文件大小
✅ 便于文件传输和处理
❌ 文件数量不可预期
```

### 7.2 组合滚动策略配置


```properties
# 组合策略：同时按时间和大小滚动
appender.rolling.policies.type = Policies

# 时间策略：每天滚动
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.rolling.policies.time.interval = 1
appender.rolling.policies.time.modulate = true

# 大小策略：100MB滚动  
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.rolling.policies.size.size = 100MB
```

**触发逻辑**：满足任一条件就滚动
- 到了新的一天 **OR** 文件大小超过100MB

### 7.3 文件保留数量控制


```properties
# 默认滚动策略
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.max = 30
appender.rolling.strategy.fileIndex = nomax
```

**参数含义**：
- `max = 30`：最多保留30个历史文件
- `fileIndex = nomax`：文件索引没有上限
- 超过30个文件时，最老的文件会被自动删除

---

## 8. 🎨 日志格式模式定制


### 8.1 日志格式模式语法


**基本理解**：格式模式就像是"日志的样式表"，决定日志长什么样。

```
常用格式占位符：
%d{yyyy-MM-dd HH:mm:ss,SSS}  ← 时间戳
%-5level                     ← 日志级别（左对齐5位）
%-25logger                   ← 日志器名称（左对齐25位）
%msg                         ← 日志消息内容
%n                           ← 换行符
%thread                      ← 线程名
%file                        ← 文件名
%line                        ← 行号
```

### 8.2 常用格式模式示例


```properties
# 简洁格式 - 适合开发环境
layout.pattern = %d{HH:mm:ss} %-5level %logger{36} - %msg%n
# 输出：10:30:45 INFO  logstash.pipeline - Pipeline started

# 详细格式 - 适合生产环境  
layout.pattern = [%d{yyyy-MM-dd HH:mm:ss,SSS}][%-5level][%-25logger][%thread] %msg%n
# 输出：[2025-01-20 10:30:45,123][INFO ][logstash.pipeline        ][main] Pipeline started

# 调试格式 - 包含文件和行号
layout.pattern = %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36}:%line - %msg%n
# 输出：10:30:45.123 [main] INFO  logstash.pipeline:156 - Pipeline started
```

### 8.3 格式定制最佳实践


| 环境 | 推荐格式 | 重点信息 |
|------|---------|---------|
| **开发调试** | 时间+级别+消息 | 简洁清晰 |
| **生产监控** | 完整时间戳+级别+组件 | 便于追踪 |
| **故障排查** | 包含线程+文件行号 | 详细定位 |

---

## 9. 🗑️ 文件删除策略配置


### 9.1 为什么需要删除策略


**核心问题**：日志文件会不断增长，不清理的话硬盘会被撑爆。

```
没有删除策略的后果：
第1天：logstash-plain.log (100MB)
第7天：7个文件 (700MB)
第30天：30个文件 (3GB)
第365天：365个文件 (36GB) 💥 硬盘爆满
```

### 9.2 基于数量的删除策略


```properties
# 保留文件数量限制
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.max = 10
```

**效果**：只保留最新的10个日志文件，第11个文件生成时删除最老的。

### 9.3 基于时间的删除策略


```properties
# 基于时间的删除策略
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.delete.type = Delete
appender.rolling.strategy.delete.basePath = ${sys:ls.logs}
appender.rolling.strategy.delete.maxDepth = 1
appender.rolling.strategy.delete.ifFileName.type = IfFileName
appender.rolling.strategy.delete.ifFileName.glob = logstash-plain-*.log
appender.rolling.strategy.delete.ifLastModified.type = IfLastModified
appender.rolling.strategy.delete.ifLastModified.age = 7d
```

**配置解释**：
- `basePath`：删除操作的基础路径
- `maxDepth = 1`：只查找当前目录，不递归子目录
- `glob = logstash-plain-*.log`：只删除匹配模式的文件
- `age = 7d`：删除7天前的文件

### 9.4 删除策略选择指南


```
💾 磁盘空间充足：按数量保留（如30个文件）
⏰ 合规要求：按时间保留（如90天）
🔄 高频日志：组合策略（15个文件且不超过30天）

常见配置：
开发环境：保留3-7天
测试环境：保留7-14天  
生产环境：保留30-90天
```

---

## 10. 📋 完整配置示例与最佳实践


### 10.1 开发环境完整配置


```properties
# 开发环境 log4j2.properties 配置示例

# 根日志器配置 - 开发环境使用DEBUG级别
rootLogger.level = DEBUG
rootLogger.appenderRef.console.ref = console
rootLogger.appenderRef.rolling.ref = rolling

# 控制台输出器 - 开发时便于实时查看
appender.console.type = Console
appender.console.name = console
appender.console.layout.type = PatternLayout
appender.console.layout.pattern = %d{HH:mm:ss.SSS} %-5level %logger{36} - %msg%n

# 滚动文件输出器 - 保存详细日志
appender.rolling.type = RollingFile
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:ls.logs}/logstash-dev.log
appender.rolling.filePattern = ${sys:ls.logs}/logstash-dev-%d{yyyy-MM-dd}-%i.log
appender.rolling.layout.type = PatternLayout
appender.rolling.layout.pattern = [%d{yyyy-MM-dd HH:mm:ss,SSS}][%-5level][%-30logger] %msg%n

# 滚动策略 - 开发环境不需要太多历史文件
appender.rolling.policies.type = Policies
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.rolling.policies.size.size = 50MB

# 删除策略 - 只保留5个文件
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.max = 5

# Logstash组件日志配置
logger.logstash.name = logstash
logger.logstash.level = DEBUG
logger.logstash.additivity = false
logger.logstash.appenderRef.rolling.ref = rolling

# 慢日志配置 - 开发环境关注性能
logger.slowlog.name = slowlog
logger.slowlog.level = TRACE
logger.slowlog.additivity = false
logger.slowlog.appenderRef.console.ref = console
```

### 10.2 生产环境完整配置


```properties
# 生产环境 log4j2.properties 配置示例

# 根日志器配置 - 生产环境使用WARN级别，减少日志量
rootLogger.level = WARN
rootLogger.appenderRef.rolling.ref = rolling

# 不配置控制台输出器 - 生产环境通常后台运行

# 滚动文件输出器 - 生产环境重点配置
appender.rolling.type = RollingFile
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:ls.logs}/logstash-prod.log
appender.rolling.filePattern = ${sys:ls.logs}/logstash-prod-%d{yyyy-MM-dd}-%i.log
appender.rolling.layout.type = PatternLayout
appender.rolling.layout.pattern = [%d{yyyy-MM-dd HH:mm:ss,SSS}][%-5level][%-25logger][%thread] %msg%n

# 生产环境滚动策略 - 按天滚动，单文件最大200MB
appender.rolling.policies.type = Policies
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.rolling.policies.time.interval = 1
appender.rolling.policies.time.modulate = true
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.rolling.policies.size.size = 200MB

# 生产环境删除策略 - 保留30天的日志
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.delete.type = Delete
appender.rolling.strategy.delete.basePath = ${sys:ls.logs}
appender.rolling.strategy.delete.maxDepth = 1
appender.rolling.strategy.delete.ifFileName.type = IfFileName
appender.rolling.strategy.delete.ifFileName.glob = logstash-prod-*.log
appender.rolling.strategy.delete.ifLastModified.type = IfLastModified
appender.rolling.strategy.delete.ifLastModified.age = 30d

# Logstash组件日志配置 - 生产环境只记录重要信息
logger.logstash.name = logstash
logger.logstash.level = INFO
logger.logstash.additivity = false
logger.logstash.appenderRef.rolling.ref = rolling

# 管道日志单独配置 - 管道是核心，需要详细日志
logger.pipeline.name = logstash.pipeline
logger.pipeline.level = INFO
logger.pipeline.additivity = false
logger.pipeline.appenderRef.rolling.ref = rolling

# 慢日志配置 - 生产环境重点关注性能问题
logger.slowlog.name = slowlog
logger.slowlog.level = INFO
logger.slowlog.additivity = false
logger.slowlog.appenderRef.rolling.ref = rolling
```

### 10.3 配置最佳实践总结


```
🎯 环境差异化配置：
开发环境：DEBUG级别 + 控制台输出 + 短期保留
测试环境：INFO级别 + 文件输出 + 中期保留  
生产环境：WARN级别 + 文件输出 + 长期保留

📏 文件大小建议：
小型系统：50-100MB单文件
中型系统：100-200MB单文件
大型系统：200-500MB单文件

⏰ 保留时间建议：
开发环境：3-7天
测试环境：7-15天
生产环境：30-90天（根据合规要求）

🔧 性能优化要点：
- 生产环境避免DEBUG级别
- 使用异步输出器提高性能
- 合理设置文件滚动阈值
- 定期清理过期日志文件
```

### 10.4 常见问题排查


**问题1：日志文件不生成**
```
排查步骤：
1. 检查目录权限：ls -la ${LOGSTASH_HOME}/logs/
2. 检查配置语法：bin/logstash --config.test_and_exit
3. 检查路径变量：echo ${sys:ls.logs}
```

**问题2：日志级别不生效**
```
可能原因：
- additivity=true导致继承父级配置
- 多个logger配置冲突
- 级别设置错误（大小写敏感）

解决方法：
- 设置additivity=false
- 检查logger名称匹配规则
- 确认级别拼写正确
```

**问题3：磁盘空间不足**
```
紧急处理：
1. 立即清理旧日志：find logs/ -name "*.log" -mtime +7 -delete
2. 调整删除策略，缩短保留时间
3. 减小文件滚动阈值

长期方案：
- 配置自动删除策略
- 监控磁盘使用率
- 考虑日志压缩存储
```

> 💡 **新手总结**：log4j2.properties就是Logstash的"日志管家"，通过合理配置能让你的Logstash运行更稳定，问题更好排查。记住：开发用DEBUG看详情，生产用WARN保性能，日志文件要定期清理，别把硬盘撑爆了！