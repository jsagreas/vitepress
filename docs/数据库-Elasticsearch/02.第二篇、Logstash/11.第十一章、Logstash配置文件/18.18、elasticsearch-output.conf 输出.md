---
title: 18、elasticsearch-output.conf 输出
---
## 📚 目录

1. [Elasticsearch输出基础概念](#1-elasticsearch输出基础概念)
2. [ES集群连接配置](#2-es集群连接配置)
3. [索引和文档配置](#3-索引和文档配置)
4. [认证和安全配置](#4-认证和安全配置)
5. [性能优化配置](#5-性能优化配置)
6. [高级功能配置](#6-高级功能配置)
7. [完整配置示例](#7-完整配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔌 Elasticsearch输出基础概念


### 1.1 什么是Elasticsearch输出插件


**💡 简单理解**：就像一个**数据搬运工**，把Logstash处理好的数据送到Elasticsearch存储起来

```
数据流向示意：
输入数据 → Logstash处理 → Elasticsearch输出插件 → ES集群存储

比如：
日志文件 → 解析清洗 → elasticsearch输出 → 存入ES索引
```

**🎯 核心作用**：
- **数据传输**：将处理后的数据发送到ES集群
- **索引管理**：自动创建和管理ES索引
- **批量写入**：提高数据写入效率
- **错误处理**：处理网络异常和写入失败

### 1.2 为什么需要ES输出插件


**🔄 传统方式的问题**：
```
手动方式：程序直接调用ES API → 复杂、容易出错
脚本方式：写脚本批量导入 → 不够灵活、维护困难
```

**✅ ES输出插件的优势**：
- **自动化**：无需手动操作，数据自动流转
- **高效率**：批量写入，性能更好
- **高可靠**：自动重试，保证数据不丢失
- **易配置**：简单配置即可完成复杂功能

---

## 2. 🌐 ES集群连接配置


### 2.1 单节点连接配置


**基础连接配置**：
```ruby
output {
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "my-logs-%{+YYYY.MM.dd}"
  }
}
```

**📋 配置说明**：
- `hosts`：ES节点地址，支持HTTP/HTTPS
- `index`：目标索引名称，支持动态命名

### 2.2 多节点集群配置


**集群连接示例**：
```ruby
output {
  elasticsearch {
    # 配置多个ES节点
    hosts => [
      "http://es-node1:9200",
      "http://es-node2:9200", 
      "http://es-node3:9200"
    ]
    
    # 集群相关配置
    sniffing => true              # 自动发现集群节点
    sniffing_delay => 5           # 节点发现间隔(秒)
    resurrect_delay => 5          # 故障节点重试间隔
    
    index => "app-logs-%{+YYYY.MM.dd}"
  }
}
```

**🔧 集群配置详解**：

| 参数名称 | **作用说明** | **推荐值** | **注意事项** |
|---------|------------|-----------|-------------|
| `sniffing` | `自动发现集群新节点` | `true` | `生产环境建议开启` |
| `sniffing_delay` | `节点发现检查间隔` | `5-10秒` | `太频繁会增加网络开销` |
| `resurrect_delay` | `故障节点重连间隔` | `5-30秒` | `根据网络环境调整` |

### 2.3 负载均衡策略


**连接策略配置**：
```ruby
output {
  elasticsearch {
    hosts => ["es1:9200", "es2:9200", "es3:9200"]
    
    # 负载均衡配置
    pool_max => 1000             # 连接池最大连接数
    pool_max_per_route => 100    # 每个路由最大连接数
    
    # 超时配置
    timeout => 60                # 请求超时时间(秒)
    
    index => "balanced-logs-%{+YYYY.MM}"
  }
}
```

---

## 3. 📋 索引和文档配置


### 3.1 索引名称模式设置


**📅 时间基础的索引命名**：

```ruby
output {
  elasticsearch {
    hosts => ["http://localhost:9200"]
    
    # 不同时间粒度的索引命名
    index => "logs-%{+YYYY.MM.dd}"        # 按天分割
    # index => "logs-%{+YYYY.MM}"         # 按月分割  
    # index => "logs-%{+YYYY-WW}"         # 按周分割
  }
}
```

**🏷️ 业务字段动态索引**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    
    # 根据日志类型分索引
    index => "%{[fields][logtype]}-%{+YYYY.MM.dd}"
    
    # 根据服务名分索引  
    index => "%{[service_name]}-logs-%{+YYYY.MM.dd}"
  }
}
```

**💡 索引命名最佳实践**：
- ✅ **使用小写字母**：避免大小写问题
- ✅ **时间后缀**：便于数据管理和清理
- ✅ **业务前缀**：便于区分不同类型数据
- ❌ **避免特殊字符**：如空格、中文等

### 3.2 文档类型和ID配置


**文档ID配置**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "user-actions-%{+YYYY.MM.dd}"
    
    # 自定义文档ID(避免重复数据)
    document_id => "%{user_id}_%{action_time}"
    
    # 文档类型(ES 7.x后不再需要)
    # document_type => "_doc"
  }
}
```

**🔑 文档ID设计原则**：
- **唯一性**：确保ID在索引中唯一
- **业务意义**：ID包含业务信息，便于查找
- **避免冲突**：使用复合字段避免ID重复

---

## 4. 🔒 认证和安全配置


### 4.1 用户名密码认证


**基础认证配置**：
```ruby
output {
  elasticsearch {
    hosts => ["https://es-cluster.company.com:9200"]
    
    # 用户认证
    user => "logstash_writer"
    password => "secure_password_123"
    
    index => "secure-logs-%{+YYYY.MM.dd}"
  }
}
```

**🔐 认证安全建议**：
- **专用账号**：为Logstash创建专门的ES用户
- **最小权限**：只授予必要的索引写入权限  
- **密码管理**：使用环境变量存储密码

### 4.2 SSL/TLS加密配置


**HTTPS连接配置**：
```ruby
output {
  elasticsearch {
    hosts => ["https://secure-es.company.com:9200"]
    
    # SSL配置
    ssl => true                          # 启用SSL
    ssl_certificate_verification => true # 验证证书
    
    # 自定义证书(可选)
    cacert => "/path/to/ca-cert.pem"    # CA证书路径
    
    # 客户端证书(双向认证)
    keystore => "/path/to/client.p12"    # 客户端证书
    keystore_password => "cert_password"  # 证书密码
    
    user => "logstash_user"
    password => "secure_password"
    index => "https-logs-%{+YYYY.MM.dd}"
  }
}
```

### 4.3 API Key认证


**API Key配置方式**：
```ruby
output {
  elasticsearch {
    hosts => ["https://cloud-es.elastic.co:9200"]
    
    # API Key认证(推荐方式)
    api_key => "your_api_key_id:your_api_key_secret"
    
    index => "cloud-logs-%{+YYYY.MM.dd}"
  }
}
```

---

## 5. ⚡ 性能优化配置


### 5.1 批量写入配置


**批量处理优化**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "high-volume-logs-%{+YYYY.MM.dd}"
    
    # 批量写入配置  
    flush_size => 1000              # 批量大小(文档数)
    idle_flush_time => 1            # 空闲刷新时间(秒)
    
    # 并发配置
    workers => 4                    # 工作线程数
    
    # 缓冲区配置
    pipeline_batch_size => 1000     # 管道批处理大小
    pipeline_batch_delay => 50      # 批处理延迟(毫秒)
  }
}
```

**📊 批量参数调优指南**：

| 场景类型 | **flush_size** | **workers** | **说明** |
|---------|---------------|-------------|----------|
| `高吞吐量` | `2000-5000` | `4-8` | `大批量提高效率` |
| `低延迟` | `100-500` | `2-4` | `小批量快速写入` |
| `平衡型` | `1000` | `4` | `通用推荐配置` |

### 5.2 重试机制设置


**重试和容错配置**：
```ruby
output {
  elasticsearch {
    hosts => ["es1:9200", "es2:9200"]
    index => "reliable-logs-%{+YYYY.MM.dd}"
    
    # 重试配置
    retry_max_items => 5000         # 单次重试最大项目数
    retry_max_interval => 5         # 最大重试间隔(秒)
    retry_initial_interval => 2     # 初始重试间隔(秒)
    
    # 故障处理
    retry_on_conflict => 3          # 冲突重试次数
    
    # 死信队列(失败数据处理)
    dead_letter_queue => {
      enable => true
      max_bytes => "1gb"
    }
  }
}
```

### 5.3 内存和连接优化


**资源使用优化**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "optimized-logs-%{+YYYY.MM.dd}"
    
    # 连接池优化
    http_compression => true         # 启用HTTP压缩
    pool_max => 1000                # 最大连接数
    pool_max_per_route => 100       # 每个路由最大连接
    
    # 超时配置
    timeout => 30                   # 请求超时
    
    # 健康检查
    healthcheck_url => "http://localhost:9200/_cluster/health"
  }
}
```

---

## 6. 🔧 高级功能配置


### 6.1 模板管理设置


**索引模板配置**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "template-logs-%{+YYYY.MM.dd}"
    
    # 模板管理
    manage_template => true         # 自动管理模板
    template_name => "logstash-template"
    template_pattern => ["logstash-*", "logs-*"]
    
    # 自定义模板路径
    template => "/path/to/custom-template.json"
    template_overwrite => true      # 覆盖已存在模板
    
    # 模板版本控制
    template_api => "legacy"        # 使用legacy模板API
  }
}
```

### 6.2 条件输出配置


**基于条件的多输出**：
```ruby
output {
  # 错误日志写入专门索引
  if [level] == "ERROR" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
      
      # 错误日志特殊配置
      flush_size => 100            # 小批量快速处理
      workers => 2
    }
  }
  
  # 普通日志写入常规索引
  else {
    elasticsearch {
      hosts => ["localhost:9200"] 
      index => "app-logs-%{+YYYY.MM.dd}"
      
      # 常规日志配置
      flush_size => 1000
      workers => 4
    }
  }
}
```

### 6.3 数据生命周期管理


**ILM集成配置**：
```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "ilm-logs-%{+YYYY.MM.dd}"
    
    # ILM策略配置
    ilm_enabled => true             # 启用ILM
    ilm_rollover_alias => "logs-active"
    ilm_pattern => "000001"         # 索引模式
    ilm_policy => "logs-policy"     # ILM策略名称
  }
}
```

---

## 7. 📝 完整配置示例


### 7.1 生产环境完整配置


```ruby
# 18-elasticsearch-output.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][logtype] {
    mutate {
      add_field => { "index_prefix" => "%{[fields][logtype]}" }
    }
  } else {
    mutate {
      add_field => { "index_prefix" => "general" }
    }
  }
  
  # 添加时间戳
  date {
    match => [ "timestamp", "ISO8601" ]
  }
}

output {
  elasticsearch {
    # === 集群连接配置 ===
    hosts => [
      "http://es-master-1:9200",
      "http://es-master-2:9200", 
      "http://es-master-3:9200"
    ]
    
    # 集群发现
    sniffing => true
    sniffing_delay => 5
    resurrect_delay => 5
    
    # === 认证配置 ===
    user => "${ES_USERNAME:logstash_writer}"
    password => "${ES_PASSWORD}"
    
    # === 索引配置 ===
    index => "%{index_prefix}-logs-%{+YYYY.MM.dd}"
    document_id => "%{[@metadata][beat]}_%{[@metadata][version]}_%{+HH.mm.ss.SSS}"
    
    # === 性能优化 ===
    # 批量写入配置
    flush_size => 1000
    idle_flush_time => 1
    workers => 4
    
    # 重试配置
    retry_max_items => 5000
    retry_max_interval => 5
    retry_initial_interval => 2
    
    # 连接优化
    http_compression => true
    pool_max => 500
    pool_max_per_route => 100
    timeout => 30
    
    # === 模板管理 ===
    manage_template => true
    template_name => "production-logs"
    template_pattern => ["*-logs-*"]
    template_overwrite => false
    
    # === 错误处理 ===
    dead_letter_queue => {
      enable => true
      max_bytes => "1gb"
    }
  }
  
  # 输出到stdout用于调试(生产环境可删除)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
}
```

### 7.2 开发环境简化配置


```ruby
# 开发环境配置
input {
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
  }
}

filter {
  grok {
    match => { 
      "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:content}" 
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "dev-logs-%{+YYYY.MM.dd}"
    
    # 开发环境简化配置
    flush_size => 100
    workers => 1
  }
  
  stdout { 
    codec => rubydebug 
  }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的配置要点


```
🔸 基础连接：hosts配置，支持多节点集群
🔸 索引设计：时间模式命名，业务字段动态索引  
🔸 认证安全：用户密码、SSL加密、API Key
🔸 性能优化：批量写入、重试机制、连接池配置
🔸 高级功能：模板管理、条件输出、生命周期管理
```

### 8.2 关键理解要点


**🔹 连接配置的选择**
```
单节点测试：hosts => ["localhost:9200"]
集群生产：hosts => ["node1:9200", "node2:9200", "node3:9200"]
云服务：hosts => ["https://cloud-endpoint.com:9200"] + 认证
```

**🔹 索引命名策略**
```
时间维度：按天、按月、按周分割索引
业务维度：按应用、按日志类型分割索引
混合策略：应用名-日志类型-时间模式
```

**🔹 性能调优原则**
```
高吞吐量场景：增大flush_size和workers
低延迟需求：减小flush_size，增加flush频率
网络不稳定：增强重试配置，启用压缩
```

### 8.3 常见问题和解决方案


**❓ 连接失败问题**
```yaml
症状：Connection refused或timeout
解决：
✅ 检查ES服务状态和端口
✅ 验证网络连通性
✅ 确认认证信息正确
✅ 检查防火墙设置
```

**❓ 写入性能问题**  
```yaml
症状：数据写入慢，积压严重
解决：
✅ 调大flush_size参数
✅ 增加workers数量  
✅ 优化ES集群配置
✅ 启用HTTP压缩
```

**❓ 索引管理问题**
```yaml
症状：索引过多，存储空间不足
解决：
✅ 配置ILM生命周期策略
✅ 设置合理的时间分割粒度
✅ 定期清理历史数据
✅ 使用索引模板统一配置
```

### 8.4 最佳实践建议


**🎯 生产环境配置建议**
- **安全第一**：启用认证和SSL加密
- **监控重要**：配置健康检查和死信队列
- **性能优化**：根据数据量调整批量参数
- **容灾准备**：配置多节点和重试机制

**🔧 配置管理建议**  
- **环境分离**：开发、测试、生产使用不同配置
- **参数外化**：敏感信息使用环境变量
- **版本控制**：配置文件纳入版本管理
- **文档维护**：记录配置变更和原因

**核心记忆**：
- Elasticsearch输出是数据流转的最后一站，配置要稳定可靠
- 集群连接配置决定高可用性，认证配置保证安全性
- 批量写入和重试机制是性能和可靠性的关键
- 索引命名和模板管理影响后续数据查询和维护效率