---
title: 30ã€ beats-integration.conf Beatsç”Ÿæ€é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Beatsç”Ÿæ€ç³»ç»Ÿæ¦‚è¿°](#1-beatsç”Ÿæ€ç³»ç»Ÿæ¦‚è¿°)
2. [Filebeatæ–‡ä»¶æ—¥å¿—é›†æˆ](#2-filebeatæ–‡ä»¶æ—¥å¿—é›†æˆ)
3. [Metricbeatç³»ç»ŸæŒ‡æ ‡é›†æˆ](#3-metricbeatç³»ç»ŸæŒ‡æ ‡é›†æˆ)
4. [Packetbeatç½‘ç»œç›‘æ§é›†æˆ](#4-packetbeatç½‘ç»œç›‘æ§é›†æˆ)
5. [Winlogbeat Windowsæ—¥å¿—é›†æˆ](#5-winlogbeat-windowsæ—¥å¿—é›†æˆ)
6. [HeartbeatæœåŠ¡ç›‘æ§é›†æˆ](#6-heartbeatæœåŠ¡ç›‘æ§é›†æˆ)
7. [å¤šBeatæ•°æ®èåˆé…ç½®](#7-å¤šbeatæ•°æ®èåˆé…ç½®)
8. [ç»Ÿä¸€å­—æ®µæ˜ å°„ç®¡ç†](#8-ç»Ÿä¸€å­—æ®µæ˜ å°„ç®¡ç†)
9. [ä¸­å¤®åŒ–ç®¡ç†æœ€ä½³å®è·µ](#9-ä¸­å¤®åŒ–ç®¡ç†æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ Beatsç”Ÿæ€ç³»ç»Ÿæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Beats


**Beatsç®€å•ç†è§£**ï¼š
> æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰å¾ˆå¤šä¸åŒç±»å‹çš„æ•°æ®éœ€è¦æ”¶é›†ï¼šæœåŠ¡å™¨æ—¥å¿—ã€ç³»ç»Ÿæ€§èƒ½ã€ç½‘ç»œæµé‡ç­‰ã€‚Beatså°±åƒæ˜¯ä¸€ç¾¤ä¸“ä¸šçš„"æ•°æ®æ¬è¿å·¥"ï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„ä¸“é•¿ï¼Œè´Ÿè´£æŠŠç‰¹å®šç±»å‹çš„æ•°æ®æ¬åˆ°Logstashè¿›è¡Œå¤„ç†ã€‚

```
æ•°æ®æ”¶é›†å…¨æ™¯å›¾ï¼š
åº”ç”¨æœåŠ¡å™¨ â”€â”€Filebeatâ”€â”€â”
ç³»ç»Ÿç›‘æ§   â”€â”€Metricbeatâ”€â”¤
ç½‘ç»œæµé‡   â”€â”€Packetbeatâ”€â”¼â”€â”€> Logstash â”€â”€> Elasticsearch
Windowsæœºå™¨â”€â”€Winlogbeatâ”€â”¤
æœåŠ¡ç›‘æ§   â”€â”€Heartbeatâ”€â”€â”˜
```

### 1.2 Beatså®¶æ—æˆå‘˜ä»‹ç»


| Beatç±»å‹ | **ä¸“ä¸šé¢†åŸŸ** | **æ”¶é›†ä»€ä¹ˆ** | **å…¸å‹åœºæ™¯** |
|---------|------------|-------------|-------------|
| ğŸ“„ **Filebeat** | `æ–‡ä»¶æ—¥å¿—` | `åº”ç”¨æ—¥å¿—ã€ç³»ç»Ÿæ—¥å¿—ã€è®¿é—®æ—¥å¿—` | `WebæœåŠ¡å™¨ã€åº”ç”¨ç¨‹åºç›‘æ§` |
| ğŸ“Š **Metricbeat** | `ç³»ç»ŸæŒ‡æ ‡` | `CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œä½¿ç”¨ç‡` | `æ€§èƒ½ç›‘æ§ã€å®¹é‡è§„åˆ’` |
| ğŸŒ **Packetbeat** | `ç½‘ç»œæµé‡` | `HTTPè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ã€ç½‘ç»œåŒ…` | `APMã€ç½‘ç»œå®‰å…¨åˆ†æ` |
| ğŸªŸ **Winlogbeat** | `Windowsäº‹ä»¶` | `Windowsäº‹ä»¶æ—¥å¿—ã€å®‰å…¨æ—¥å¿—` | `Windowsç¯å¢ƒç›‘æ§` |
| â¤ï¸ **Heartbeat** | `æœåŠ¡å¯ç”¨æ€§` | `æœåŠ¡å“åº”æ—¶é—´ã€å¯ç”¨æ€§çŠ¶æ€` | `æœåŠ¡å¥åº·æ£€æŸ¥` |

### 1.3 ä¸ºä»€ä¹ˆè¦é›†æˆBeats


**ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
æ¯ä¸ªæœåŠ¡å™¨ â†’ å•ç‹¬é…ç½® â†’ å„è‡ªä¸ºæ”¿ â†’ ç®¡ç†æ··ä¹±

Beats + Logstashæ–¹å¼ï¼š
å¤šä¸ªBeats â†’ ç»Ÿä¸€Logstash â†’ é›†ä¸­å¤„ç† â†’ ç»Ÿä¸€å­˜å‚¨
```

**ğŸ¯ å®é™…å¥½å¤„**ï¼š
- **ä¸“ä¸šåˆ†å·¥**ï¼šæ¯ä¸ªBeatä¸“æ³¨è‡ªå·±æ“…é•¿çš„æ•°æ®ç±»å‹
- **è½»é‡çº§**ï¼šBeatæ¯”Logstashå ç”¨èµ„æºå°‘ï¼Œé€‚åˆéƒ¨ç½²åœ¨ç”Ÿäº§æœåŠ¡å™¨
- **ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰æ•°æ®æ±‡èšåˆ°Logstashç»Ÿä¸€æ¸…æ´—å’Œè·¯ç”±
- **é…ç½®å¤ç”¨**ï¼šç›¸åŒç±»å‹çš„æœåŠ¡å™¨å¯ä»¥å¤ç”¨Beaté…ç½®

---

## 2. ğŸ“„ Filebeatæ–‡ä»¶æ—¥å¿—é›†æˆ


### 2.1 FilebeatåŸºç¡€é›†æˆé…ç½®


**åœºæ™¯è¯´æ˜**ï¼šæ”¶é›†WebæœåŠ¡å™¨çš„è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—

```ruby
# 30-beats-integration.conf - Filebeatéƒ¨åˆ†
input {
  beats {
    port => 5044
    type => "filebeat"
  }
}

filter {
  # åªå¤„ç†æ¥è‡ªFilebeatçš„æ•°æ®
  if [agent][type] == "filebeat" {
    
    # æ ¹æ®æ—¥å¿—æ–‡ä»¶ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
    if [fields][log_type] == "nginx_access" {
      grok {
        match => { 
          "message" => "%{NGINXACCESS}" 
        }
        tag_on_failure => ["_grokparsefailure_nginx"]
      }
      
      # è½¬æ¢å“åº”æ—¶é—´ä¸ºæ•°å­—
      mutate {
        convert => { 
          "response_time" => "float"
          "status" => "integer"
        }
      }
      
    } else if [fields][log_type] == "application_log" {
      grok {
        match => { 
          "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{LOGLEVEL:level}: %{GREEDYDATA:log_message}" 
        }
      }
    }
    
    # æ·»åŠ å¤„ç†æ ‡è¯†
    mutate {
      add_tag => ["filebeat_processed"]
    }
  }
}
```

### 2.2 å¤šç§æ—¥å¿—ç±»å‹å¤„ç†


**ğŸ” æ·±å…¥ç†è§£**ï¼š
> å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸€å°æœåŠ¡å™¨å¯èƒ½æœ‰å¤šç§æ—¥å¿—ï¼šNginxè®¿é—®æ—¥å¿—ã€åº”ç”¨ç¨‹åºæ—¥å¿—ã€ç³»ç»Ÿæ—¥å¿—ç­‰ã€‚æˆ‘ä»¬éœ€è¦åœ¨Logstashä¸­æ ¹æ®ä¸åŒç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†ã€‚

```ruby
filter {
  if [agent][type] == "filebeat" {
    
    # ä½¿ç”¨log_typeå­—æ®µåŒºåˆ†æ—¥å¿—ç±»å‹
    case [fields][log_type] {
      
      # WebæœåŠ¡å™¨è®¿é—®æ—¥å¿—
      when "nginx_access" {
        grok {
          match => { 
            "message" => '%{IPORHOST:remote_ip} - %{USER:remote_user} \[%{HTTPDATE:timestamp}\] "%{WORD:method} %{URIPATH:request_path}(?:%{URIPARAM:request_params})? HTTP/%{NUMBER:http_version}" %{NUMBER:status} %{NUMBER:body_bytes_sent} "%{DATA:http_referer}" "%{DATA:http_user_agent}" "%{DATA:http_x_forwarded_for}"'
          }
        }
        
        # è§£æè®¿é—®æ—¶é—´
        date {
          match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
        }
        
        # åœ°ç†ä½ç½®è§£æ
        geoip {
          source => "remote_ip"
          target => "geoip"
        }
      }
      
      # åº”ç”¨ç¨‹åºé”™è¯¯æ—¥å¿—  
      when "app_error" {
        grok {
          match => { 
            "message" => "\[%{TIMESTAMP_ISO8601:log_time}\] %{LOGLEVEL:level} %{GREEDYDATA:error_message}"
          }
        }
        
        # é”™è¯¯çº§åˆ«æ ‡å‡†åŒ–
        translate {
          field => "level"
          destination => "severity"
          dictionary => {
            "ERROR" => "high"
            "WARN"  => "medium"
            "INFO"  => "low"
          }
        }
      }
      
      # ç³»ç»Ÿæ—¥å¿—
      when "syslog" {
        grok {
          match => { 
            "message" => "%{SYSLOGLINE}"
          }
        }
      }
    }
  }
}
```

### 2.3 Filebeaté…ç½®æ–‡ä»¶ç¤ºä¾‹


**ğŸ“ å¯¹åº”çš„Filebeaté…ç½®**ï¼š
```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  fields:
    log_type: nginx_access
    environment: production
  fields_under_root: false

- type: log
  enabled: true
  paths:
    - /var/log/app/error.log
  fields:
    log_type: app_error
    environment: production

output.logstash:
  hosts: ["logstash-server:5044"]
```

---

## 3. ğŸ“Š Metricbeatç³»ç»ŸæŒ‡æ ‡é›†æˆ


### 3.1 ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å¤„ç†


**åœºæ™¯è¯´æ˜**ï¼šæ”¶é›†æœåŠ¡å™¨çš„CPUã€å†…å­˜ã€ç£ç›˜ç­‰æ€§èƒ½æŒ‡æ ‡

```ruby
filter {
  if [agent][type] == "metricbeat" {
    
    # ç³»ç»ŸæŒ‡æ ‡å¤„ç†
    if [metricset][module] == "system" {
      
      # CPUæŒ‡æ ‡å¤„ç†
      if [metricset][name] == "cpu" {
        
        # è®¡ç®—CPUä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        ruby {
          code => '
            if event.get("[system][cpu][user][pct]")
              total_cpu = event.get("[system][cpu][user][pct]").to_f + 
                         event.get("[system][cpu][system][pct]").to_f
              event.set("cpu_usage_percent", (total_cpu * 100).round(2))
            end
          '
        }
        
        # æ·»åŠ å‘Šè­¦æ ‡ç­¾
        if [cpu_usage_percent] and [cpu_usage_percent] > 80 {
          mutate {
            add_tag => ["high_cpu_usage", "alert"]
          }
        }
      }
      
      # å†…å­˜æŒ‡æ ‡å¤„ç†
      else if [metricset][name] == "memory" {
        
        # è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
        ruby {
          code => '
            total = event.get("[system][memory][total]").to_f
            used = event.get("[system][memory][used][bytes]").to_f
            if total > 0
              usage_percent = (used / total * 100).round(2)
              event.set("memory_usage_percent", usage_percent)
            end
          '
        }
        
        # å†…å­˜å‘Šè­¦
        if [memory_usage_percent] and [memory_usage_percent] > 85 {
          mutate {
            add_tag => ["high_memory_usage", "alert"]
          }
        }
      }
      
      # ç£ç›˜æŒ‡æ ‡å¤„ç†
      else if [metricset][name] == "filesystem" {
        
        # æ’é™¤ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ
        if [system][filesystem][device_name] !~ /^(tmpfs|devtmpfs|proc)/ {
          
          # è®¡ç®—ç£ç›˜ä½¿ç”¨ç‡
          ruby {
            code => '
              total = event.get("[system][filesystem][total]").to_f
              used = event.get("[system][filesystem][used][bytes]").to_f
              if total > 0
                usage_percent = (used / total * 100).round(2)
                event.set("disk_usage_percent", usage_percent)
              end
            '
          }
          
          # ç£ç›˜å‘Šè­¦
          if [disk_usage_percent] and [disk_usage_percent] > 90 {
            mutate {
              add_tag => ["high_disk_usage", "critical_alert"]
            }
          }
        } else {
          # ä¸¢å¼ƒç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿæ•°æ®
          drop { }
        }
      }
    }
    
    # Dockerå®¹å™¨æŒ‡æ ‡
    else if [metricset][module] == "docker" {
      
      # å®¹å™¨CPUä½¿ç”¨ç‡
      if [metricset][name] == "cpu" {
        ruby {
          code => '
            cpu_percent = event.get("[docker][cpu][total][pct]").to_f
            event.set("container_cpu_percent", (cpu_percent * 100).round(2))
          '
        }
      }
      
      # å®¹å™¨å†…å­˜ä½¿ç”¨ç‡
      else if [metricset][name] == "memory" {
        ruby {
          code => '
            usage = event.get("[docker][memory][usage][bytes]").to_f
            limit = event.get("[docker][memory][limit]").to_f
            if limit > 0
              usage_percent = (usage / limit * 100).round(2)
              event.set("container_memory_percent", usage_percent)
            end
          '
        }
      }
    }
    
    # æ·»åŠ æ—¶é—´æˆ³
    date {
      match => [ "@timestamp", "ISO8601" ]
    }
  }
}
```

### 3.2 æ€§èƒ½é˜ˆå€¼ç›‘æ§é…ç½®


**âš ï¸ æ€§èƒ½å‘Šè­¦è§„åˆ™**ï¼š
```ruby
filter {
  if [agent][type] == "metricbeat" {
    
    # ç»¼åˆæ€§èƒ½è¯„ä¼°
    ruby {
      code => '
        alerts = []
        
        # CPUå‘Šè­¦
        cpu = event.get("cpu_usage_percent")
        if cpu && cpu > 90
          alerts << "CPU Critical"
        elsif cpu && cpu > 75
          alerts << "CPU Warning"
        end
        
        # å†…å­˜å‘Šè­¦
        memory = event.get("memory_usage_percent")
        if memory && memory > 95
          alerts << "Memory Critical"
        elsif memory && memory > 80
          alerts << "Memory Warning"
        end
        
        # ç£ç›˜å‘Šè­¦
        disk = event.get("disk_usage_percent")
        if disk && disk > 95
          alerts << "Disk Critical"
        elsif disk && disk > 85
          alerts << "Disk Warning"
        end
        
        # è®¾ç½®å‘Šè­¦çº§åˆ«
        if alerts.length > 0
          event.set("performance_alerts", alerts)
          
          # è®¾ç½®å‘Šè­¦çº§åˆ«
          if alerts.any? { |alert| alert.include?("Critical") }
            event.set("alert_level", "critical")
          else
            event.set("alert_level", "warning")
          end
        end
      '
    }
  }
}
```

---

## 4. ğŸŒ Packetbeatç½‘ç»œç›‘æ§é›†æˆ


### 4.1 HTTPæµé‡åˆ†æ


**åœºæ™¯è¯´æ˜**ï¼šåˆ†æåº”ç”¨ç¨‹åºçš„HTTPè¯·æ±‚æ€§èƒ½å’Œå¼‚å¸¸

```ruby
filter {
  if [agent][type] == "packetbeat" {
    
    # HTTPåè®®åˆ†æ
    if [type] == "http" {
      
      # å“åº”æ—¶é—´åˆ†ç±»
      if [http][response_time] {
        ruby {
          code => '
            response_time = event.get("[http][response_time]").to_f
            
            if response_time < 100
              event.set("response_category", "fast")
            elsif response_time < 500
              event.set("response_category", "normal")
            elsif response_time < 2000
              event.set("response_category", "slow")
            else
              event.set("response_category", "very_slow")
            end
          '
        }
      }
      
      # HTTPçŠ¶æ€ç åˆ†ç±»
      if [http][response][status_code] {
        ruby {
          code => '
            status = event.get("[http][response][status_code]").to_i
            
            case status
            when 200..299
              event.set("status_category", "success")
            when 300..399
              event.set("status_category", "redirect")
            when 400..499
              event.set("status_category", "client_error")
            when 500..599
              event.set("status_category", "server_error")
            end
          '
        }
      }
      
      # æ…¢è¯·æ±‚å‘Šè­¦
      if [response_category] == "very_slow" or [status_category] == "server_error" {
        mutate {
          add_tag => ["performance_issue"]
        }
      }
      
      # URLè·¯å¾„æå–
      if [http][request][path] {
        grok {
          match => { 
            "[http][request][path]" => "(?<api_endpoint>/api/[^/]+)" 
          }
          tag_on_failure => []
        }
      }
    }
    
    # æ•°æ®åº“æŸ¥è¯¢åˆ†æ
    else if [type] == "mysql" {
      
      # æ…¢æŸ¥è¯¢æ£€æµ‹
      if [mysql][query_time] and [mysql][query_time] > 1000 {
        mutate {
          add_tag => ["slow_query", "database_performance"]
        }
      }
      
      # SQLç±»å‹åˆ†æ
      if [mysql][query] {
        grok {
          match => { 
            "[mysql][query]" => "^(?<sql_operation>SELECT|INSERT|UPDATE|DELETE)" 
          }
          tag_on_failure => []
        }
      }
    }
  }
}
```

### 4.2 ç½‘ç»œå®‰å…¨åˆ†æ


**ğŸ”’ å®‰å…¨ç›‘æ§é…ç½®**ï¼š
```ruby
filter {
  if [agent][type] == "packetbeat" and [type] == "http" {
    
    # å¯ç–‘è¯·æ±‚æ£€æµ‹
    if [http][request][path] {
      
      # SQLæ³¨å…¥æ£€æµ‹
      if [http][request][path] =~ /(\bunion\b|\bselect\b|\binsert\b|\bupdate\b|\bdelete\b|\'|\-\-)/i {
        mutate {
          add_tag => ["potential_sql_injection", "security_alert"]
        }
      }
      
      # XSSæ”»å‡»æ£€æµ‹
      if [http][request][path] =~ /(<script|javascript:|onload=|onerror=)/i {
        mutate {
          add_tag => ["potential_xss", "security_alert"]
        }
      }
      
      # ç›®å½•éå†æ£€æµ‹
      if [http][request][path] =~ /(\.\.\/|\.\.\\)/i {
        mutate {
          add_tag => ["directory_traversal", "security_alert"]
        }
      }
    }
    
    # å¼‚å¸¸User-Agentæ£€æµ‹
    if [http][request][headers][user-agent] {
      if [http][request][headers][user-agent] =~ /(sqlmap|nikto|nmap|masscan)/i {
        mutate {
          add_tag => ["scanning_tool", "security_alert"]
        }
      }
    }
    
    # é¢‘ç¹è¯·æ±‚æ£€æµ‹ï¼ˆéœ€è¦é…åˆaggregationæ’ä»¶ï¼‰
    fingerprint {
      source => ["[source][ip]"]
      target => "[@metadata][fingerprint]"
    }
  }
}
```

---

## 5. ğŸªŸ Winlogbeat Windowsæ—¥å¿—é›†æˆ


### 5.1 Windowså®‰å…¨äº‹ä»¶åˆ†æ


**åœºæ™¯è¯´æ˜**ï¼šç›‘æ§WindowsæœåŠ¡å™¨çš„å®‰å…¨äº‹ä»¶å’Œç³»ç»ŸçŠ¶æ€

```ruby
filter {
  if [agent][type] == "winlogbeat" {
    
    # Windowså®‰å…¨æ—¥å¿—å¤„ç†
    if [winlog][channel] == "Security" {
      
      # ç™»å½•äº‹ä»¶åˆ†æ
      if [winlog][event_id] in [4624, 4625, 4634] {
        
        # ç™»å½•æˆåŠŸ
        if [winlog][event_id] == 4624 {
          mutate {
            add_field => { "event_type" => "login_success" }
            add_tag => ["windows_login", "security_audit"]
          }
          
          # æå–ç™»å½•ç±»å‹
          if [winlog][event_data][LogonType] {
            translate {
              field => "[winlog][event_data][LogonType]"
              destination => "logon_type_description"
              dictionary => {
                "2"  => "Interactive"
                "3"  => "Network"
                "4"  => "Batch"
                "5"  => "Service"
                "7"  => "Unlock"
                "8"  => "NetworkCleartext"
                "9"  => "NewCredentials"
                "10" => "RemoteInteractive"
                "11" => "CachedInteractive"
              }
            }
          }
        }
        
        # ç™»å½•å¤±è´¥
        else if [winlog][event_id] == 4625 {
          mutate {
            add_field => { "event_type" => "login_failure" }
            add_tag => ["windows_login_failure", "security_alert"]
          }
          
          # å¤±è´¥åŸå› åˆ†æ
          if [winlog][event_data][FailureReason] {
            mutate {
              add_field => { "failure_reason" => "%{[winlog][event_data][FailureReason]}" }
            }
          }
        }
        
        # æ³¨é”€äº‹ä»¶
        else if [winlog][event_id] == 4634 {
          mutate {
            add_field => { "event_type" => "logout" }
            add_tag => ["windows_logout", "security_audit"]
          }
        }
      }
      
      # è´¦æˆ·ç®¡ç†äº‹ä»¶
      else if [winlog][event_id] in [4720, 4722, 4723, 4724, 4725, 4726] {
        mutate {
          add_tag => ["account_management", "security_audit"]
        }
        
        case [winlog][event_id] {
          when 4720 { mutate { add_field => { "event_type" => "user_created" } } }
          when 4722 { mutate { add_field => { "event_type" => "user_enabled" } } }
          when 4723 { mutate { add_field => { "event_type" => "password_change_attempt" } } }
          when 4724 { mutate { add_field => { "event_type" => "password_reset_attempt" } } }
          when 4725 { mutate { add_field => { "event_type" => "user_disabled" } } }
          when 4726 { mutate { add_field => { "event_type" => "user_deleted" } } }
        }
      }
    }
    
    # åº”ç”¨ç¨‹åºæ—¥å¿—å¤„ç†
    else if [winlog][channel] == "Application" {
      
      # åº”ç”¨ç¨‹åºé”™è¯¯
      if [winlog][level] == "Error" {
        mutate {
          add_tag => ["application_error", "windows_application"]
        }
      }
      
      # åº”ç”¨ç¨‹åºå¯åŠ¨/åœæ­¢
      if [winlog][event_id] in [1000, 1001, 1002] {
        mutate {
          add_tag => ["application_lifecycle", "windows_application"]
        }
      }
    }
    
    # ç³»ç»Ÿæ—¥å¿—å¤„ç†
    else if [winlog][channel] == "System" {
      
      # ç³»ç»Ÿå¯åŠ¨/å…³é—­
      if [winlog][event_id] in [6005, 6006, 6008, 6009] {
        mutate {
          add_tag => ["system_lifecycle", "windows_system"]
        }
        
        case [winlog][event_id] {
          when 6005 { mutate { add_field => { "event_type" => "system_start" } } }
          when 6006 { mutate { add_field => { "event_type" => "system_shutdown" } } }
          when 6008 { mutate { add_field => { "event_type" => "unexpected_shutdown" } } }
          when 6009 { mutate { add_field => { "event_type" => "system_boot" } } }
        }
      }
      
      # æœåŠ¡ç›¸å…³äº‹ä»¶
      if [winlog][event_id] in [7034, 7035, 7036] {
        mutate {
          add_tag => ["service_management", "windows_system"]
        }
      }
    }
  }
}
```

### 5.2 Windowsæ€§èƒ½ç›‘æ§


**ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡å¤„ç†**ï¼š
```ruby
filter {
  if [agent][type] == "winlogbeat" {
    
    # æ€§èƒ½è®¡æ•°å™¨å¤„ç†
    if [winlog][channel] == "Microsoft-Windows-Kernel-Process/Analytic" {
      
      # è¿›ç¨‹åˆ›å»ºç›‘æ§
      if [winlog][event_id] == 1 {
        mutate {
          add_tag => ["process_creation", "windows_process"]
        }
        
        # æå–è¿›ç¨‹ä¿¡æ¯
        if [winlog][event_data][ProcessName] {
          mutate {
            add_field => { "process_name" => "%{[winlog][event_data][ProcessName]}" }
          }
        }
        
        # å¯ç–‘è¿›ç¨‹æ£€æµ‹
        if [process_name] and [process_name] =~ /(powershell|cmd|wmic|net|ping|nslookup)\.exe$/i {
          mutate {
            add_tag => ["suspicious_process", "security_monitoring"]
          }
        }
      }
    }
    
    # ç»Ÿä¸€æ—¶é—´æ ¼å¼
    date {
      match => [ "[winlog][time_created]", "ISO8601" ]
    }
  }
}
```

---

## 6. â¤ï¸ HeartbeatæœåŠ¡ç›‘æ§é›†æˆ


### 6.1 æœåŠ¡å¯ç”¨æ€§ç›‘æ§


**åœºæ™¯è¯´æ˜**ï¼šç›‘æ§å…³é”®æœåŠ¡çš„å¥åº·çŠ¶æ€å’Œå“åº”æ—¶é—´

```ruby
filter {
  if [agent][type] == "heartbeat" {
    
    # HTTPæœåŠ¡ç›‘æ§
    if [monitor][type] == "http" {
      
      # å“åº”æ—¶é—´åˆ†æ
      if [http][rtt][total][us] {
        ruby {
          code => '
            rtt_ms = event.get("[http][rtt][total][us]").to_f / 1000
            event.set("response_time_ms", rtt_ms.round(2))
            
            # å“åº”æ—¶é—´ç­‰çº§
            if rtt_ms < 200
              event.set("performance_level", "excellent")
            elsif rtt_ms < 500
              event.set("performance_level", "good")
            elsif rtt_ms < 1000
              event.set("performance_level", "acceptable")
            else
              event.set("performance_level", "poor")
            end
          '
        }
      }
      
      # å¯ç”¨æ€§çŠ¶æ€
      if [monitor][status] == "up" {
        mutate {
          add_tag => ["service_available"]
          add_field => { "availability_status" => "healthy" }
        }
      } else {
        mutate {
          add_tag => ["service_unavailable", "alert"]
          add_field => { "availability_status" => "unhealthy" }
        }
        
        # é”™è¯¯è¯¦æƒ…
        if [error][message] {
          mutate {
            add_field => { "error_details" => "%{[error][message]}" }
          }
        }
      }
      
      # SSLè¯ä¹¦æ£€æŸ¥
      if [tls][certificate_not_valid_after] {
        ruby {
          code => '
            cert_expiry = Time.parse(event.get("[tls][certificate_not_valid_after]"))
            days_until_expiry = ((cert_expiry - Time.now) / 86400).to_i
            event.set("ssl_days_until_expiry", days_until_expiry)
            
            if days_until_expiry < 30
              event.set("ssl_status", "expires_soon")
              event.get("tags") << "ssl_expiring"
            elsif days_until_expiry < 7
              event.set("ssl_status", "critical_expiry")
              event.get("tags") << "ssl_critical"
            end
          '
        }
      }
    }
    
    # TCPæœåŠ¡ç›‘æ§
    else if [monitor][type] == "tcp" {
      
      if [monitor][status] == "up" {
        mutate {
          add_tag => ["tcp_service_available"]
        }
        
        # TCPè¿æ¥æ—¶é—´
        if [tcp][rtt][connect][us] {
          ruby {
            code => '
              connect_time = event.get("[tcp][rtt][connect][us]").to_f / 1000
              event.set("tcp_connect_time_ms", connect_time.round(2))
            '
          }
        }
      } else {
        mutate {
          add_tag => ["tcp_service_unavailable", "alert"]
        }
      }
    }
    
    # ICMP pingç›‘æ§
    else if [monitor][type] == "icmp" {
      
      if [monitor][status] == "up" {
        mutate {
          add_tag => ["host_reachable"]
        }
        
        # Pingå“åº”æ—¶é—´
        if [icmp][rtt][us] {
          ruby {
            code => '
              ping_time = event.get("[icmp][rtt][us]").to_f / 1000
              event.set("ping_time_ms", ping_time.round(2))
            '
          }
        }
      } else {
        mutate {
          add_tag => ["host_unreachable", "connectivity_alert"]
        }
      }
    }
    
    # æœåŠ¡åˆ†ç»„
    if [monitor][name] {
      ruby {
        code => '
          service_name = event.get("[monitor][name]")
          
          # æ ¹æ®æœåŠ¡åç§°åˆ†ç»„
          if service_name.include?("web")
            event.set("service_category", "web_services")
          elsif service_name.include?("db") || service_name.include?("database")
            event.set("service_category", "database_services")
          elsif service_name.include?("api")
            event.set("service_category", "api_services")
          else
            event.set("service_category", "other_services")
          end
        '
      }
    }
  }
}
```

### 6.2 SLAç›‘æ§é…ç½®


**ğŸ“Š æœåŠ¡æ°´å¹³åè®®ç›‘æ§**ï¼š
```ruby
filter {
  if [agent][type] == "heartbeat" {
    
    # SLAè®¡ç®—å’Œç›‘æ§
    ruby {
      code => '
        # è®¾ç½®SLAç›®æ ‡ï¼ˆ99.9%å¯ç”¨æ€§ï¼‰
        sla_target = 99.9
        
        # æ ¹æ®ç›‘æ§ç»“æœè®¡ç®—å¯ç”¨æ€§
        if event.get("[monitor][status]") == "up"
          event.set("uptime_contribution", 1)
        else
          event.set("uptime_contribution", 0)
          
          # SLAè¿åå‘Šè­¦
          event.set("sla_violation", true)
          event.get("tags") << "sla_breach"
        end
        
        # å“åº”æ—¶é—´SLAæ£€æŸ¥
        response_time = event.get("response_time_ms")
        if response_time && response_time > 2000
          event.set("response_sla_violation", true)
          event.get("tags") << "response_time_sla_breach"
        end
      '
    }
    
    # ä¸šåŠ¡å½±å“è¯„ä¼°
    if [monitor][name] {
      translate {
        field => "[monitor][name]"
        destination => "business_impact"
        dictionary => {
          "production-web-server"    => "critical"
          "payment-api"             => "critical"
          "user-database"           => "critical"
          "admin-dashboard"         => "high"
          "monitoring-system"       => "medium"
          "development-server"      => "low"
        }
        fallback => "unknown"
      }
    }
  }
}
```

---

## 7. ğŸ”— å¤šBeatæ•°æ®èåˆé…ç½®


### 7.1 å…³è”åˆ†æé…ç½®


**åœºæ™¯è¯´æ˜**ï¼šå°†æ¥è‡ªä¸åŒBeatçš„æ•°æ®è¿›è¡Œå…³è”åˆ†æï¼Œå½¢æˆå®Œæ•´çš„ç³»ç»Ÿè§†å›¾

```ruby
filter {
  # ç»Ÿä¸€ä¸»æœºæ ‡è¯†
  if [host][name] {
    mutate {
      add_field => { "host_identifier" => "%{[host][name]}" }
    }
  } else if [agent][hostname] {
    mutate {
      add_field => { "host_identifier" => "%{[agent][hostname]}" }
    }
  }
  
  # æ ¹æ®Beatç±»å‹æ·»åŠ æ•°æ®æºæ ‡ç­¾
  if [agent][type] {
    mutate {
      add_field => { "data_source" => "%{[agent][type]}" }
    }
  }
  
  # æœåŠ¡å…³è”
  ruby {
    code => '
      host = event.get("host_identifier")
      beat_type = event.get("[agent][type]")
      
      if host && beat_type
        # åˆ›å»ºæœåŠ¡æ ‡è¯†
        service_key = "#{host}_#{beat_type}"
        event.set("service_correlation_key", service_key)
        
        # è®¾ç½®æ•°æ®ä¼˜å…ˆçº§
        case beat_type
        when "heartbeat"
          event.set("data_priority", "high")      # å¯ç”¨æ€§æ•°æ®ä¼˜å…ˆçº§æœ€é«˜
        when "metricbeat"
          event.set("data_priority", "high")      # æ€§èƒ½æ•°æ®ä¹Ÿå¾ˆé‡è¦
        when "filebeat"
          event.set("data_priority", "medium")    # æ—¥å¿—æ•°æ®ä¸­ç­‰ä¼˜å…ˆçº§
        when "packetbeat"
          event.set("data_priority", "medium")    # ç½‘ç»œæ•°æ®ä¸­ç­‰ä¼˜å…ˆçº§
        when "winlogbeat"
          event.set("data_priority", "medium")    # Windowsæ—¥å¿—ä¸­ç­‰ä¼˜å…ˆçº§
        else
          event.set("data_priority", "low")
        end
      end
    '
  }
  
  # ä¸šåŠ¡æœåŠ¡æ˜ å°„
  if [host_identifier] {
    translate {
      field => "host_identifier"
      destination => "business_service"
      dictionary => {
        "web-server-01"    => "frontend"
        "web-server-02"    => "frontend"
        "api-server-01"    => "backend_api"
        "api-server-02"    => "backend_api"
        "db-server-01"     => "database"
        "cache-server-01"  => "cache_layer"
        "lb-server-01"     => "load_balancer"
      }
      fallback => "unknown_service"
    }
  }
}
```

### 7.2 è·¨Beatäº‹ä»¶å…³è”


**ğŸ” æ™ºèƒ½å…³è”é…ç½®**ï¼š
```ruby
filter {
  # åˆ›å»ºäº‹ä»¶æŒ‡çº¹ç”¨äºå…³è”
  fingerprint {
    source => ["host_identifier", "@timestamp"]
    target => "[@metadata][correlation_id]"
    method => "SHA256"
  }
  
  # å¼‚å¸¸äº‹ä»¶å…³è”åˆ†æ
  if "alert" in [tags] or "security_alert" in [tags] {
    
    # è®¾ç½®å…³è”çª—å£ï¼ˆ5åˆ†é’Ÿå†…çš„ç›¸å…³äº‹ä»¶ï¼‰
    ruby {
      code => '
        event_time = event.get("@timestamp")
        correlation_window = 300  # 5åˆ†é’Ÿ
        
        window_start = (event_time.to_f - correlation_window).to_i
        window_end = (event_time.to_f + correlation_window).to_i
        
        event.set("correlation_window_start", Time.at(window_start).iso8601)
        event.set("correlation_window_end", Time.at(window_end).iso8601)
      '
    }
    
    # æ·»åŠ å…³è”æ ‡ç­¾
    mutate {
      add_tag => ["requires_correlation"]
    }
  }
  
  # æœåŠ¡çŠ¶æ€ç»¼åˆè¯„ä¼°
  if [business_service] != "unknown_service" {
    ruby {
      code => '
        service = event.get("business_service")
        beat_type = event.get("[agent][type]")
        
        # åˆå§‹åŒ–æœåŠ¡å¥åº·è¯„åˆ†
        health_score = 100
        
        # æ ¹æ®ä¸åŒBeatçš„æ•°æ®è°ƒæ•´å¥åº·è¯„åˆ†
        case beat_type
        when "heartbeat"
          if event.get("[monitor][status]") != "up"
            health_score = 0  # æœåŠ¡ä¸å¯ç”¨ï¼Œå¥åº·è¯„åˆ†ä¸º0
          elsif event.get("response_time_ms") && event.get("response_time_ms") > 1000
            health_score = 60  # å“åº”æ…¢ï¼Œè¯„åˆ†é™ä½
          end
          
        when "metricbeat"
          cpu_usage = event.get("cpu_usage_percent")
          memory_usage = event.get("memory_usage_percent")
          
          if cpu_usage && cpu_usage > 90
            health_score -= 30
          elsif cpu_usage && cpu_usage > 75
            health_score -= 15
          end
          
          if memory_usage && memory_usage > 95
            health_score -= 30
          elsif memory_usage && memory_usage > 80
            health_score -= 15
          end
          
        when "filebeat"
          if "ERROR" in event.get("message").to_s
            health_score -= 10
          end
          
        when "packetbeat"
          if event.get("status_category") == "server_error"
            health_score -= 20
          end
        end
        
        health_score = [health_score, 0].max  # ç¡®ä¿ä¸ä¸ºè´Ÿæ•°
        event.set("service_health_score", health_score)
        
        # è®¾ç½®å¥åº·çŠ¶æ€
        if health_score >= 80
          event.set("service_health_status", "healthy")
        elsif health_score >= 60
          event.set("service_health_status", "degraded")
        elsif health_score >= 30
          event.set("service_health_status", "unhealthy")
        else
          event.set("service_health_status", "critical")
        end
      '
    }
  }
}
```

---

## 8. ğŸ—ºï¸ ç»Ÿä¸€å­—æ®µæ˜ å°„ç®¡ç†


### 8.1 å­—æ®µæ ‡å‡†åŒ–é…ç½®


**åœºæ™¯è¯´æ˜**ï¼šä¸åŒBeatäº§ç”Ÿçš„å­—æ®µåç§°å¯èƒ½ä¸ä¸€è‡´ï¼Œéœ€è¦ç»Ÿä¸€æ˜ å°„åˆ°æ ‡å‡†å­—æ®µ

```ruby
filter {
  # æ—¶é—´æˆ³æ ‡å‡†åŒ–
  if [@timestamp] {
    mutate {
      add_field => { "event_timestamp" => "%{@timestamp}" }
    }
  }
  
  # ä¸»æœºä¿¡æ¯æ ‡å‡†åŒ–
  if [host][name] {
    mutate {
      add_field => { "hostname" => "%{[host][name]}" }
    }
  } else if [beat][hostname] {
    mutate {
      add_field => { "hostname" => "%{[beat][hostname]}" }
    }
  } else if [agent][hostname] {
    mutate {
      add_field => { "hostname" => "%{[agent][hostname]}" }
    }
  }
  
  # IPåœ°å€æ ‡å‡†åŒ–
  if [host][ip] and [host][ip][0] {
    mutate {
      add_field => { "host_ip" => "%{[host][ip][0]}" }
    }
  } else if [beat][ip] {
    mutate {
      add_field => { "host_ip" => "%{[beat][ip]}" }
    }
  }
  
  # æ“ä½œç³»ç»Ÿä¿¡æ¯æ ‡å‡†åŒ–
  if [host][os][name] {
    mutate {
      add_field => { "os_name" => "%{[host][os][name]}" }
      add_field => { "os_version" => "%{[host][os][version]}" }
    }
  }
  
  # æ ¹æ®Beatç±»å‹è¿›è¡Œç‰¹å®šå­—æ®µæ˜ å°„
  case [agent][type] {
    
    # Filebeatå­—æ®µæ˜ å°„
    when "filebeat" {
      if [log][file][path] {
        mutate {
          add_field => { "log_source_file" => "%{[log][file][path]}" }
        }
      }
      
      if [fields][log_type] {
        mutate {
          add_field => { "log_category" => "%{[fields][log_type]}" }
        }
      }
    }
    
    # Metricbeatå­—æ®µæ˜ å°„
    when "metricbeat" {
      if [metricset][module] {
        mutate {
          add_field => { "metric_module" => "%{[metricset][module]}" }
          add_field => { "metric_name" => "%{[metricset][name]}" }
        }
      }
    }
    
    # Packetbeatå­—æ®µæ˜ å°„
    when "packetbeat" {
      if [type] {
        mutate {
          add_field => { "protocol_type" => "%{type}" }
        }
      }
      
      if [source][ip] {
        mutate {
          add_field => { "source_ip" => "%{[source][ip]}" }
        }
      }
      
      if [dest][ip] {
        mutate {
          add_field => { "destination_ip" => "%{[dest][ip]}" }
        }
      }
    }
    
    # Winlogbeatå­—æ®µæ˜ å°„
    when "winlogbeat" {
      if [winlog][channel] {
        mutate {
          add_field => { "windows_log_channel" => "%{[winlog][channel]}" }
        }
      }
      
      if [winlog][event_id] {
        mutate {
          add_field => { "windows_event_id" => "%{[winlog][event_id]}" }
        }
      }
    }
    
    # Heartbeatå­—æ®µæ˜ å°„
    when "heartbeat" {
      if [monitor][name] {
        mutate {
          add_field => { "monitor_name" => "%{[monitor][name]}" }
          add_field => { "monitor_type" => "%{[monitor][type]}" }
        }
      }
      
      if [monitor][status] {
        mutate {
          add_field => { "service_status" => "%{[monitor][status]}" }
        }
      }
    }
  }
}
```

### 8.2 æ•°æ®è´¨é‡ç®¡ç†


**âœ… æ•°æ®éªŒè¯å’Œæ¸…ç†**ï¼š
```ruby
filter {
  # å¿…éœ€å­—æ®µæ£€æŸ¥
  if ![hostname] or ![agent][type] {
    mutate {
      add_tag => ["missing_required_fields", "data_quality_issue"]
    }
  }
  
  # æ•°æ®ç±»å‹éªŒè¯å’Œè½¬æ¢
  ruby {
    code => '
      # ç¡®ä¿æ•°å€¼å­—æ®µæ˜¯æ•°å­—ç±»å‹
      numeric_fields = [
        "cpu_usage_percent", "memory_usage_percent", "disk_usage_percent",
        "response_time_ms", "ping_time_ms", "service_health_score"
      ]
      
      numeric_fields.each do |field|
        value = event.get(field)
        if value && !value.is_a?(Numeric)
          begin
            event.set(field, value.to_f)
          rescue
            event.get("tags") << "invalid_numeric_field_#{field}"
          end
        end
      end
      
      # ç¡®ä¿ç™¾åˆ†æ¯”å­—æ®µåœ¨åˆç†èŒƒå›´å†…
      percentage_fields = ["cpu_usage_percent", "memory_usage_percent", "disk_usage_percent"]
      percentage_fields.each do |field|
        value = event.get(field)
        if value && value.is_a?(Numeric)
          if value < 0 || value > 100
            event.get("tags") << "invalid_percentage_#{field}"
          end
        end
      end
    '
  }
  
  # æ¸…ç†ç©ºå€¼å’Œæ— æ•ˆå­—æ®µ
  ruby {
    code => '
      # ç§»é™¤ç©ºå­—ç¬¦ä¸²å’Œnilå€¼
      event.to_hash.each do |key, value|
        if value.nil? || (value.is_a?(String) && value.strip.empty?)
          event.remove(key)
        end
      end
    '
  }
  
  # æ•°æ®å®Œæ•´æ€§è¯„åˆ†
  ruby {
    code => '
      required_fields = ["hostname", "agent.type", "event_timestamp"]
      optional_fields = ["host_ip", "os_name", "business_service"]
      
      score = 0
      total_possible = required_fields.length * 2 + optional_fields.length
      
      # å¿…éœ€å­—æ®µæ£€æŸ¥ï¼ˆæƒé‡2ï¼‰
      required_fields.each do |field|
        if event.get(field)
          score += 2
        end
      end
      
      # å¯é€‰å­—æ®µæ£€æŸ¥ï¼ˆæƒé‡1ï¼‰
      optional_fields.each do |field|
        if event.get(field)
          score += 1
        end
      end
      
      completeness_percent = (score.to_f / total_possible * 100).round(2)
      event.set("data_completeness_percent", completeness_percent)
      
      if completeness_percent < 60
        event.get("tags") << "low_data_quality"
      end
    '
  }
}
```

---

## 9. ğŸ›ï¸ ä¸­å¤®åŒ–ç®¡ç†æœ€ä½³å®è·µ


### 9.1 ç¯å¢ƒé…ç½®ç®¡ç†


**ğŸ“‹ å¤šç¯å¢ƒé…ç½®ç¤ºä¾‹**ï¼š

```ruby
filter {
  # ç¯å¢ƒè¯†åˆ«
  if [fields][environment] {
    mutate {
      add_field => { "deployment_environment" => "%{[fields][environment]}" }
    }
  } else {
    # æ ¹æ®ä¸»æœºåæ¨æ–­ç¯å¢ƒ
    if [hostname] =~ /^prod-/ {
      mutate {
        add_field => { "deployment_environment" => "production" }
      }
    } else if [hostname] =~ /^stage-/ {
      mutate {
        add_field => { "deployment_environment" => "staging" }
      }
    } else if [hostname] =~ /^dev-/ {
      mutate {
        add_field => { "deployment_environment" => "development" }
      }
    } else {
      mutate {
        add_field => { "deployment_environment" => "unknown" }
      }
    }
  }
  
  # ç¯å¢ƒç‰¹å®šé…ç½®
  if [deployment_environment] == "production" {
    # ç”Ÿäº§ç¯å¢ƒï¼šæ›´ä¸¥æ ¼çš„ç›‘æ§
    mutate {
      add_field => { 
        "alert_threshold_cpu" => "80"
        "alert_threshold_memory" => "85"
        "alert_threshold_disk" => "90"
        "alert_threshold_response_time" => "1000"
      }
    }
  } else if [deployment_environment] == "staging" {
    # æµ‹è¯•ç¯å¢ƒï¼šå®½æ¾ä¸€äº›çš„é˜ˆå€¼
    mutate {
      add_field => { 
        "alert_threshold_cpu" => "90"
        "alert_threshold_memory" => "90"
        "alert_threshold_disk" => "95"
        "alert_threshold_response_time" => "2000"
      }
    }
  } else if [deployment_environment] == "development" {
    # å¼€å‘ç¯å¢ƒï¼šå¾ˆå®½æ¾çš„é˜ˆå€¼
    mutate {
      add_field => { 
        "alert_threshold_cpu" => "95"
        "alert_threshold_memory" => "95"
        "alert_threshold_disk" => "98"
        "alert_threshold_response_time" => "5000"
      }
    }
  }
  
  # åº”ç”¨ç¯å¢ƒç‰¹å®šçš„å‘Šè­¦è§„åˆ™
  if [cpu_usage_percent] and [alert_threshold_cpu] {
    if [cpu_usage_percent] > [alert_threshold_cpu] {
      mutate {
        add_tag => ["cpu_threshold_exceeded"]
      }
    }
  }
}
```

### 9.2 é›†ä¸­é…ç½®ç®¡ç†


**ğŸ”§ é…ç½®æ¨¡æ¿åŒ–**ï¼š

```ruby
# é€šç”¨Beatå¤„ç†æ¨¡æ¿
filter {
  # é€šç”¨å…ƒæ•°æ®æ·»åŠ 
  mutate {
    add_field => { 
      "config_version" => "1.0"
      "processed_by" => "logstash-central"
      "processing_timestamp" => "%{@timestamp}"
    }
  }
  
  # é€šç”¨æ ‡ç­¾æ ‡å‡†åŒ–
  if [tags] {
    ruby {
      code => '
        tags = event.get("tags")
        if tags.is_a?(Array)
          # ç§»é™¤é‡å¤æ ‡ç­¾
          event.set("tags", tags.uniq)
          
          # æ·»åŠ æ±‡æ€»æ ‡ç­¾
          if tags.any? { |tag| tag.include?("alert") }
            event.get("tags") << "requires_attention"
          end
          
          if tags.any? { |tag| tag.include?("security") }
            event.get("tags") << "security_event"
          end
          
          if tags.any? { |tag| tag.include?("performance") }
            event.get("tags") << "performance_event"
          end
        end
      '
    }
  }
  
  # æ•°æ®è·¯ç”±å†³ç­–
  ruby {
    code => '
      environment = event.get("deployment_environment")
      beat_type = event.get("[agent][type]")
      
      # ç¡®å®šç´¢å¼•åç§°
      date_suffix = Time.now.strftime("%Y.%m.%d")
      
      case environment
      when "production"
        index_prefix = "prod"
      when "staging"
        index_prefix = "stage"
      when "development"
        index_prefix = "dev"
      else
        index_prefix = "misc"
      end
      
      index_name = "#{index_prefix}-#{beat_type}-#{date_suffix}"
      event.set("[@metadata][target_index]", index_name)
      
      # æ•°æ®ä¿ç•™ç­–ç•¥
      case environment
      when "production"
        event.set("[@metadata][retention_days]", 90)
      when "staging"
        event.set("[@metadata][retention_days]", 30)
      when "development"
        event.set("[@metadata][retention_days]", 7)
      end
    '
  }
}
```

### 9.3 ç›‘æ§å’Œå‘Šè­¦é›†æˆ


**ğŸ“Š ç»Ÿä¸€å‘Šè­¦é…ç½®**ï¼š

```ruby
filter {
  # å‘Šè­¦çº§åˆ«æ ‡å‡†åŒ–
  if "alert" in [tags] or "security_alert" in [tags] {
    
    # åŸºç¡€å‘Šè­¦çº§åˆ«
    mutate {
      add_field => { "alert_severity" => "info" }
    }
    
    # æ ¹æ®æ¡ä»¶æå‡å‘Šè­¦çº§åˆ«
    if "critical" in [tags] or "security_alert" in [tags] {
      mutate {
        replace => { "alert_severity" => "critical" }
      }
    } else if "high_cpu_usage" in [tags] or "high_memory_usage" in [tags] or "service_unavailable" in [tags] {
      mutate {
        replace => { "alert_severity" => "high" }
      }
    } else if "performance_issue" in [tags] or "slow_query" in [tags] {
      mutate {
        replace => { "alert_severity" => "medium" }
      }
    }
    
    # å‘Šè­¦å»é‡æ ‡è¯†
    fingerprint {
      source => ["hostname", "alert_severity", "business_service"]
      target => "[@metadata][alert_fingerprint]"
      method => "SHA256"
    }
    
    # å‘Šè­¦å†…å®¹æ„å»º
    ruby {
      code => '
        alert_details = {
          "timestamp" => event.get("@timestamp"),
          "hostname" => event.get("hostname"),
          "service" => event.get("business_service"),
          "environment" => event.get("deployment_environment"),
          "severity" => event.get("alert_severity"),
          "source" => event.get("[agent][type]"),
          "tags" => event.get("tags")
        }
        
        # æ·»åŠ å…·ä½“æŒ‡æ ‡ä¿¡æ¯
        case event.get("[agent][type]")
        when "metricbeat"
          alert_details["cpu_usage"] = event.get("cpu_usage_percent")
          alert_details["memory_usage"] = event.get("memory_usage_percent")
          alert_details["disk_usage"] = event.get("disk_usage_percent")
        when "heartbeat"
          alert_details["service_status"] = event.get("service_status")
          alert_details["response_time"] = event.get("response_time_ms")
        when "packetbeat"
          alert_details["response_category"] = event.get("response_category")
          alert_details["status_category"] = event.get("status_category")
        end
        
        event.set("alert_payload", alert_details)
      '
    }
  }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Beatsç”Ÿæ€ç³»ç»Ÿï¼šä¸“ä¸šåŒ–çš„è½»é‡çº§æ•°æ®æ”¶é›†å™¨å®¶æ—
ğŸ”¸ æ•°æ®æºè¯†åˆ«ï¼šé€šè¿‡agent.typeå­—æ®µåŒºåˆ†ä¸åŒBeatæ•°æ®
ğŸ”¸ å­—æ®µæ ‡å‡†åŒ–ï¼šç»Ÿä¸€ä¸åŒBeatçš„å­—æ®µåç§°å’Œæ ¼å¼
ğŸ”¸ å…³è”åˆ†æï¼šè·¨Beatæ•°æ®çš„æ™ºèƒ½å…³è”å’Œèåˆ
ğŸ”¸ é›†ä¸­ç®¡ç†ï¼šç»Ÿä¸€é…ç½®ã€ç›‘æ§å’Œå‘Šè­¦ç­–ç•¥
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦Beatsé›†æˆ**
```
ä¸“ä¸šåˆ†å·¥ï¼š
- æ¯ä¸ªBeatä¸“æ³¨ç‰¹å®šæ•°æ®ç±»å‹
- è½»é‡çº§ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- ç»Ÿä¸€æ±‡èšåˆ°Logstashå¤„ç†

æ•°æ®èåˆä»·å€¼ï¼š
- å•ä¸€Beatæä¾›å±€éƒ¨è§†å›¾
- å¤šBeatèåˆæä¾›å…¨å±€è§†å›¾
- å…³è”åˆ†æå‘ç°æ½œåœ¨é—®é¢˜
```

**ğŸ”¹ é…ç½®è®¾è®¡åŸåˆ™**
```
å¯æ‰©å±•æ€§ï¼š
- æ¨¡å—åŒ–é…ç½®è®¾è®¡
- ä¾¿äºæ·»åŠ æ–°çš„Beatç±»å‹
- é…ç½®æ¨¡æ¿åŒ–ç®¡ç†

æ•°æ®è´¨é‡ï¼š
- å­—æ®µéªŒè¯å’Œæ¸…ç†
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- é”™è¯¯å¤„ç†å’Œæ ‡è®°

æ€§èƒ½ä¼˜åŒ–ï¼š
- åˆç†çš„å­—æ®µæ˜ å°„
- é¿å…è¿‡åº¦å¤„ç†
- ç´¢å¼•ç­–ç•¥ä¼˜åŒ–
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ“Š ç›‘æ§åœºæ™¯**ï¼š
- **å…¨æ ˆç›‘æ§**ï¼šä»åŸºç¡€è®¾æ–½åˆ°åº”ç”¨å±‚çš„å®Œæ•´è§†å›¾
- **æ•…éšœåˆ†æ**ï¼šå¿«é€Ÿå®šä½é—®é¢˜æ ¹å› 
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºå¤šç»´åº¦æ•°æ®çš„æ€§èƒ½è°ƒä¼˜
- **å®‰å…¨åˆ†æ**ï¼šç»¼åˆå®‰å…¨äº‹ä»¶çš„å¨èƒæ£€æµ‹

**ğŸ”§ è¿ç»´å®è·µ**ï¼š
- **ç»Ÿä¸€Dashboard**ï¼šæ‰€æœ‰ç›‘æ§æ•°æ®çš„å•ä¸€è§†å›¾
- **æ™ºèƒ½å‘Šè­¦**ï¼šåŸºäºå¤šæ•°æ®æºçš„æ™ºèƒ½å‘Šè­¦è§„åˆ™
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå†å²è¶‹åŠ¿çš„å®¹é‡é¢„æµ‹
- **åˆè§„å®¡è®¡**ï¼šå®Œæ•´çš„æ“ä½œå’Œè®¿é—®å®¡è®¡æ—¥å¿—

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ é…ç½®ç®¡ç†**ï¼š
```
ç‰ˆæœ¬æ§åˆ¶ï¼š
âœ… é…ç½®æ–‡ä»¶ç‰ˆæœ¬åŒ–ç®¡ç†
âœ… å˜æ›´è®°å½•å’Œå›æ»šç­–ç•¥
âœ… æµ‹è¯•ç¯å¢ƒéªŒè¯åå‘å¸ƒ

æ ‡å‡†åŒ–ï¼š
âœ… ç»Ÿä¸€å­—æ®µå‘½åè§„èŒƒ
âœ… æ ‡å‡†åŒ–çš„æ ‡ç­¾ä½“ç³»
âœ… ä¸€è‡´çš„ç´¢å¼•ç­–ç•¥

ç›‘æ§ï¼š
âœ… é…ç½®æ€§èƒ½ç›‘æ§
âœ… æ•°æ®è´¨é‡ç›‘æ§
âœ… å¤„ç†å»¶è¿Ÿç›‘æ§
```

**âš ï¸ å¸¸è§é™·é˜±**ï¼š
```
æ€§èƒ½é—®é¢˜ï¼š
âŒ è¿‡åº¦å¤æ‚çš„è¿‡æ»¤è§„åˆ™
âŒ å¤§é‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
âŒ æœªä¼˜åŒ–çš„å­—æ®µæ˜ å°„

æ•°æ®è´¨é‡ï¼š
âŒ ç¼ºå°‘å­—æ®µéªŒè¯
âŒ é‡å¤æ•°æ®å¤„ç†
âŒ ä¸ä¸€è‡´çš„æ—¶é—´æ ¼å¼

è¿ç»´é—®é¢˜ï¼š
âŒ é…ç½®è¿‡äºé›†ä¸­åŒ–
âŒ ç¼ºå°‘é”™è¯¯å¤„ç†
âŒ æ²¡æœ‰ç›‘æ§é…ç½®æœ¬èº«
```

### 10.5 å­¦ä¹ æ£€æŸ¥ç‚¹


ğŸ“ **è‡ªæˆ‘æ£€æµ‹**ï¼š
- [ ] èƒ½å¤Ÿè§£é‡Šæ¯ä¸ªBeatçš„ä¸“ä¸šç”¨é€”
- [ ] ç†è§£å­—æ®µæ ‡å‡†åŒ–çš„é‡è¦æ€§
- [ ] æŒæ¡å¤šBeatæ•°æ®å…³è”æ–¹æ³•
- [ ] èƒ½å¤Ÿè®¾è®¡ç¯å¢ƒç‰¹å®šçš„é…ç½®
- [ ] äº†è§£é›†ä¸­åŒ–ç®¡ç†çš„æœ€ä½³å®è·µ

ğŸ¯ **å®è·µæŒ‘æˆ˜**ï¼š
å°è¯•è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š
1. é€‰æ‹©åˆé€‚çš„Beatç»„åˆ
2. è®¾è®¡å­—æ®µæ˜ å°„è§„åˆ™
3. é…ç½®å‘Šè­¦ç­–ç•¥
4. è§„åˆ’ç´¢å¼•å’Œä¿ç•™ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Beatä¸“ä¸šåˆ†å·¥å„å¸èŒï¼Œæ•°æ®æ±‡èšLogstashå¤„
- å­—æ®µæ ‡å‡†åŒ–æ˜ å°„é½ï¼Œå…³è”åˆ†æè§å…¨å±€
- ç¯å¢ƒé…ç½®è¦åˆ†ç¦»ï¼Œé›†ä¸­ç®¡ç†æ•ˆç‡é«˜
- ç›‘æ§å‘Šè­¦æ ‡å‡†åŒ–ï¼Œè¿ç»´ç®¡ç†ä¸€ä½“åŒ–

---

> ğŸ’¡ **å…³é”®æ´å¯Ÿ**ï¼šBeatsç”Ÿæ€é›†æˆä¸ä»…ä»…æ˜¯æ•°æ®æ”¶é›†ï¼Œæ›´æ˜¯æ„å»ºç°ä»£åŒ–ç›‘æ§ä½“ç³»çš„åŸºç¡€ã€‚é€šè¿‡ä¸“ä¸šåŒ–çš„æ•°æ®æ”¶é›†ã€æ ‡å‡†åŒ–çš„å­—æ®µæ˜ å°„ã€æ™ºèƒ½åŒ–çš„å…³è”åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ä»æµ·é‡çš„ç›‘æ§æ•°æ®ä¸­è·å¾—çœŸæ­£æœ‰ä»·å€¼çš„æ´å¯Ÿï¼Œæå‡ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œå¯é æ€§ã€‚