---
title: 11、tcp-input.conf TCP输入配置
---
## 📚 目录

1. [TCP输入插件基础概念](#1-TCP输入插件基础概念)
2. [核心配置参数详解](#2-核心配置参数详解)
3. [实际配置样例详解](#3-实际配置样例详解)
4. [SSL加密连接配置](#4-SSL加密连接配置)
5. [性能优化配置](#5-性能优化配置)
6. [常见问题与解决方案](#6-常见问题与解决方案)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌐 TCP输入插件基础概念


### 1.1 什么是TCP输入插件


**🔸 简单理解**
TCP输入插件就像是Logstash的"网络接收器"，专门用来接收通过TCP协议传输过来的数据。

```
想象场景：
你的应用程序 → 通过网络 → 发送日志数据 → Logstash TCP输入插件接收
就像邮递员(应用)通过邮路(TCP网络)把信件(日志)投递到邮箱(Logstash)
```

**💡 核心作用**
- **数据接收**：监听指定端口，等待数据传入
- **格式解析**：将收到的数据按指定格式解析
- **连接管理**：管理多个客户端的连接状态
- **数据传递**：将处理好的数据传给下一个处理环节

### 1.2 TCP vs其他输入方式对比


| 输入方式 | **适用场景** | **优势** | **劣势** |
|---------|------------|---------|---------|
| 🌐 **TCP输入** | `实时数据传输` | `速度快、连接稳定` | `需要网络配置` |
| 📁 **文件输入** | `读取本地日志文件` | `简单可靠` | `不够实时` |
| 🔄 **HTTP输入** | `Web API数据接收` | `标准协议` | `开销较大` |

### 1.3 工作原理图解


```
TCP数据流向：
应用A → 
应用B → TCP网络 → Logstash监听端口 → 数据解析 → 后续处理
应用C → 

详细过程：
1. Logstash启动，开始监听指定端口(如5000)
2. 应用程序连接到该端口
3. 应用发送数据到端口
4. Logstash接收并解析数据
5. 数据进入Logstash处理管道
```

---

## 2. 🔧 核心配置参数详解


### 2.1 基本连接参数


**🔸 port - 监听端口**
```ruby
input {
  tcp {
    port => 5000
  }
}
```

> 💡 **通俗解释**：就像给你家门牌号码，告诉别人数据要发到哪个"门"

**🔸 host - 监听地址**
```ruby
input {
  tcp {
    host => "0.0.0.0"  # 监听所有网络接口
    port => 5000
  }
}
```

> 📝 **地址含义说明**：
> - `0.0.0.0` = 接受来自任何IP的连接
> - `127.0.0.1` = 只接受本机连接
> - `192.168.1.100` = 只接受指定IP的连接

### 2.2 数据处理参数


**🔸 codec - 数据编解码器**

这是**决定如何理解收到数据**的关键设置：

```ruby
# 按行分割数据(最常用)
input {
  tcp {
    port => 5000
    codec => "line"
  }
}

# JSON格式数据
input {
  tcp {
    port => 5001
    codec => "json"
  }
}

# 原始数据不做处理
input {
  tcp {
    port => 5002
    codec => "plain"
  }
}
```

> 🤔 **如何选择codec**：
> - 发送的是**文本日志** → 用 `line`
> - 发送的是**JSON数据** → 用 `json`  
> - 发送的是**二进制数据** → 用 `plain`

### 2.3 连接控制参数


**🔸 mode - 连接模式**

```ruby
# 服务器模式(默认) - Logstash等待别人连接
input {
  tcp {
    port => 5000
    mode => "server"
  }
}

# 客户端模式 - Logstash主动连接别人
input {
  tcp {
    host => "192.168.1.100"
    port => 5000
    mode => "client"
  }
}
```

> 💭 **模式选择思路**：
> - **大多数情况**用server模式（应用连接Logstash）
> - **特殊情况**用client模式（Logstash连接远程服务）

**🔸 tcp_keep_alive - 心跳检测**

```ruby
input {
  tcp {
    port => 5000
    tcp_keep_alive => true  # 开启心跳检测
  }
}
```

> ❤️ **心跳检测作用**：定期检查连接是否还活着，断线及时发现

---

## 3. 💻 实际配置样例详解


### 3.1 基础日志接收配置


```ruby
# 文件名：basic-tcp-input.conf
input {
  tcp {
    port => 5000
    host => "0.0.0.0"
    codec => "line"
    type => "application_log"
  }
}

filter {
  # 给所有通过TCP收到的日志打标签
  mutate {
    add_tag => ["tcp_input", "realtime"]
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "tcp-logs-%{+YYYY.MM.dd}"
  }
}
```

> 📋 **配置说明**：
> - `port => 5000`：监听5000端口
> - `type => "application_log"`：给数据打类型标签
> - `add_tag`：添加自定义标签便于后续筛选

### 3.2 多端口多用途配置


```ruby
# 文件名：multi-port-tcp.conf
input {
  # 应用日志端口
  tcp {
    port => 5000
    codec => "line"
    type => "app_log"
    tags => ["application"]
  }
  
  # 系统监控数据端口
  tcp {
    port => 5001
    codec => "json"
    type => "metrics"
    tags => ["monitoring"]
  }
  
  # 错误日志专用端口
  tcp {
    port => 5002
    codec => "json_lines"
    type => "error_log"
    tags => ["errors"]
  }
}

filter {
  # 根据不同类型做不同处理
  if [type] == "error_log" {
    mutate {
      add_field => { "priority" => "high" }
    }
  }
}

output {
  # 错误日志单独存储
  if [type] == "error_log" {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  } else {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "general-logs-%{+YYYY.MM.dd}"
    }
  }
}
```

### 3.3 带数据验证的配置


```ruby
# 文件名：validated-tcp-input.conf
input {
  tcp {
    port => 5000
    codec => "json"
    tcp_keep_alive => true
  }
}

filter {
  # 验证必要字段是否存在
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # 验证日志级别
  if ![level] {
    mutate {
      add_field => { "level" => "INFO" }
    }
  }
  
  # 数据清洗
  mutate {
    strip => ["message"]  # 去除首尾空格
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "validated-logs-%{+YYYY.MM.dd}"
  }
}
```

---

## 4. 🔒 SSL加密连接配置


### 4.1 SSL基础概念


**🔸 为什么需要SSL**
数据在网络传输时可能被截取，SSL加密确保：
- **数据加密**：即使被截取也无法读取
- **身份验证**：确认连接的是可信的服务器
- **数据完整性**：确保数据传输过程中未被篡改

### 4.2 SSL证书准备


**🔸 生成自签名证书（测试用）**

```bash
# 生成私钥
openssl genrsa -out logstash.key 2048

# 生成证书
openssl req -new -x509 -key logstash.key -out logstash.crt -days 365
```

### 4.3 SSL服务器配置


```ruby
# 文件名：ssl-tcp-server.conf
input {
  tcp {
    port => 5000
    ssl_enable => true
    ssl_cert => "/path/to/logstash.crt"
    ssl_key => "/path/to/logstash.key"
    ssl_verify => false  # 不验证客户端证书
  }
}

output {
  stdout { codec => rubydebug }
}
```

### 4.4 双向SSL认证配置


```ruby
# 文件名：mutual-ssl-tcp.conf
input {
  tcp {
    port => 5000
    ssl_enable => true
    ssl_cert => "/path/to/server.crt"
    ssl_key => "/path/to/server.key"
    ssl_cacert => "/path/to/ca.crt"
    ssl_verify => true  # 验证客户端证书
  }
}
```

> ⚠️ **SSL配置注意事项**：
> - 证书路径必须是绝对路径
> - 确保Logstash进程有读取证书文件的权限
> - 生产环境建议使用正式CA签发的证书

---

## 5. ⚡ 性能优化配置


### 5.1 缓冲区优化


**🔸 缓冲区大小设置**

```ruby
input {
  tcp {
    port => 5000
    receive_buffer_bytes => 1048576  # 1MB接收缓冲区
    send_buffer_bytes => 1048576     # 1MB发送缓冲区
  }
}
```

> 📊 **缓冲区作用**：
> - **接收缓冲区**：暂存收到的数据，避免数据丢失
> - **发送缓冲区**：暂存要发送的数据，提高发送效率

### 5.2 连接池管理


```ruby
input {
  tcp {
    port => 5000
    tcp_keep_alive => true
    so_keepalive => true     # 操作系统级心跳
    proxy_protocol => false  # 关闭代理协议以提高性能
  }
}
```

### 5.3 高并发优化配置


```ruby
# 文件名：high-performance-tcp.conf
input {
  tcp {
    port => 5000
    host => "0.0.0.0"
    codec => "json"
    
    # 性能优化参数
    tcp_keep_alive => true
    receive_buffer_bytes => 2097152  # 2MB
    send_buffer_bytes => 2097152     # 2MB
    
    # 连接管理
    so_keepalive => true
    
    # 数据处理优化
    type => "high_volume_logs"
  }
}

filter {
  # 简化过滤器，减少处理时间
  if [level] == "DEBUG" {
    drop { }  # 丢弃调试日志
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "high-volume-%{+YYYY.MM.dd}"
    
    # 批量提交优化
    flush_size => 1000
    idle_flush_time => 5
  }
}
```

---

## 6. 🐛 常见问题与解决方案


### 6.1 连接问题排查


**🔸 问题：无法连接到TCP端口**

**解决步骤**：
1. **检查端口是否被占用**
```bash
netstat -tulpn | grep :5000
```

2. **检查防火墙设置**
```bash
# Ubuntu/Debian
sudo ufw allow 5000/tcp

# CentOS/RHEL
sudo firewall-cmd --add-port=5000/tcp --permanent
```

3. **检查Logstash配置语法**
```bash
/usr/share/logstash/bin/logstash --config.test_and_exit --path.config=/etc/logstash/conf.d/
```

### 6.2 数据接收问题


**🔸 问题：收到数据但解析错误**

| 问题现象 | **可能原因** | **解决方案** |
|---------|------------|-------------|
| `数据乱码` | `编码不匹配` | `添加charset设置` |
| `JSON解析失败` | `数据格式问题` | `使用json_lines codec` |
| `数据截断` | `缓冲区太小` | `增大receive_buffer_bytes` |

**解决配置示例**：
```ruby
input {
  tcp {
    port => 5000
    codec => json_lines {
      charset => "UTF-8"
    }
    receive_buffer_bytes => 1048576
  }
}
```

### 6.3 性能问题优化


**🔸 问题：数据处理速度慢**

**优化策略**：
```ruby
# 性能优化配置
input {
  tcp {
    port => 5000
    threads => 4  # 增加处理线程
  }
}

# 在logstash.yml中设置
pipeline.workers: 4
pipeline.batch.size: 1000
```

### 6.4 SSL连接问题


**🔸 常见SSL错误及解决**

```ruby
# 解决证书验证问题
input {
  tcp {
    port => 5000
    ssl_enable => true
    ssl_cert => "/path/to/cert.crt"
    ssl_key => "/path/to/cert.key"
    ssl_verify => false  # 临时关闭验证
    ssl_supported_protocols => ["TLSv1.2", "TLSv1.3"]
  }
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 TCP输入插件：Logstash的网络数据接收器
🔸 核心参数：host、port、codec、mode
🔸 数据编码：line(文本)、json(JSON)、plain(原始)
🔸 连接模式：server(被动等待)、client(主动连接)
🔸 SSL加密：保障数据传输安全
```

### 7.2 关键配置要点


**🔹 基础配置三要素**
```ruby
port => 5000      # 监听端口
host => "0.0.0.0" # 监听地址  
codec => "line"   # 数据格式
```

**🔹 性能优化要点**
- 🔸 **合理设置缓冲区大小**：避免数据丢失
- 🔸 **开启心跳检测**：及时发现断线
- 🔸 **根据数据量调整线程数**：提高处理能力

**🔹 安全配置要点**
- 🔸 **生产环境使用SSL**：保护数据安全
- 🔸 **限制监听地址**：避免不必要的安全风险
- 🔸 **数据验证**：确保接收到的数据格式正确

### 7.3 实际应用指导


**🎯 使用场景选择**
```
实时日志收集 → TCP输入 + line codec
API数据接收 → TCP输入 + json codec
安全环境 → TCP输入 + SSL配置
高并发场景 → 增加缓冲区 + 多线程
```

**🔧 故障排查思路**
```
连接问题 → 检查端口、防火墙、网络
解析问题 → 检查codec设置、数据格式
性能问题 → 检查缓冲区、线程配置
安全问题 → 检查SSL证书、权限设置
```

**💡 最佳实践建议**
- **开发测试**：使用简单配置，便于调试
- **生产环境**：启用SSL、监控、日志记录
- **高可用**：配置多个Logstash实例，负载均衡
- **维护管理**：定期检查证书有效期，监控连接状态

**核心记忆**：
- TCP输入是Logstash的网络接收器
- 基础三要素：端口、地址、编码格式
- 安全传输记得配SSL
- 性能调优看缓冲区和线程数