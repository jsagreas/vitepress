---
title: 14、mutate-filter.conf 字段变更过滤器
---
## 📚 目录

1. [Mutate过滤器基础概念](#1-mutate过滤器基础概念)
2. [字段重命名映射操作](#2-字段重命名映射操作)
3. [字段类型转换处理](#3-字段类型转换处理)
4. [字符串替换与处理](#4-字符串替换与处理)
5. [字段分割和连接操作](#5-字段分割和连接操作)
6. [大小写转换功能](#6-大小写转换功能)
7. [字段添加与删除管理](#7-字段添加与删除管理)
8. [数组操作处理](#8-数组操作处理)
9. [条件字段操作](#9-条件字段操作)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔧 Mutate过滤器基础概念


### 1.1 什么是Mutate过滤器


**💡 核心定义**
Mutate过滤器是Logstash中最常用的数据处理工具，专门用来**修改、转换和操作日志事件中的字段**。

```
通俗理解：
就像是一个"数据加工厂"，把原始日志数据按照你的要求进行各种改造
- 改字段名字
- 改数据类型  
- 修改内容
- 添加删除字段
```

### 1.2 Mutate过滤器的作用


**🎯 主要功能**
- **字段改名**：把复杂的字段名改成简单易懂的名字
- **类型转换**：把字符串转成数字，把数字转成字符串等
- **内容修改**：替换、分割、合并字段内容
- **字段管理**：添加新字段、删除不需要的字段

### 1.3 Mutate在ELK架构中的位置


```
数据流程图：
输入源 → Input插件 → Filter过滤器 → Output插件 → 存储
        (采集)     (处理加工)     (输出)

                  ↓
            Mutate过滤器在这里工作
            对数据进行各种变换操作
```

---

## 2. 🏷️ 字段重命名映射操作


### 2.1 基本重命名语法


**🔸 基础重命名操作**
```ruby
filter {
  mutate {
    rename => { "old_field_name" => "new_field_name" }
  }
}
```

**💡 实际应用场景**
假设你有一个日志字段叫`user_login_timestamp`，太长了不好用，可以改成`login_time`：

```ruby
filter {
  mutate {
    rename => { "user_login_timestamp" => "login_time" }
  }
}
```

### 2.2 批量重命名操作


**🔸 一次重命名多个字段**
```ruby
filter {
  mutate {
    rename => { 
      "src_ip" => "source_ip",
      "dst_ip" => "destination_ip",
      "usr" => "username",
      "pwd" => "password_field"
    }
  }
}
```

### 2.3 重命名的实际用途


**📋 常见使用场景**

| 原字段名 | 新字段名 | 说明 |
|---------|---------|------|
| `@timestamp` | `event_time` | 更明确的时间字段名 |
| `message` | `log_content` | 更清晰的日志内容字段 |
| `host.name` | `hostname` | 简化嵌套字段名 |
| `user.id` | `user_id` | 扁平化字段结构 |

**✅ 重命名的好处**
- 让字段名更容易理解
- 统一不同数据源的字段命名
- 简化复杂的嵌套字段名

---

## 3. 🔄 字段类型转换处理


### 3.1 支持的数据类型


**📊 Logstash支持的基本类型**
- **string** - 字符串类型（默认）
- **integer** - 整数类型
- **float** - 浮点数类型
- **boolean** - 布尔类型（true/false）

### 3.2 类型转换语法


**🔸 基本转换格式**
```ruby
filter {
  mutate {
    convert => { "字段名" => "目标类型" }
  }
}
```

### 3.3 常见类型转换示例


**💡 字符串转数字**
```ruby
# 把字符串 "123" 转换成数字 123
filter {
  mutate {
    convert => { "user_age" => "integer" }
  }
}

# 处理前: user_age: "25" (字符串)
# 处理后: user_age: 25 (数字)
```

**💡 数字转字符串**
```ruby
filter {
  mutate {
    convert => { "error_code" => "string" }
  }
}

# 处理前: error_code: 404 (数字)
# 处理后: error_code: "404" (字符串)
```

**💡 字符串转布尔值**
```ruby
filter {
  mutate {
    convert => { "is_admin" => "boolean" }
  }
}

# 处理前: is_admin: "true" (字符串)
# 处理后: is_admin: true (布尔值)
```

### 3.4 批量类型转换


```ruby
filter {
  mutate {
    convert => { 
      "response_time" => "float",
      "status_code" => "integer",
      "user_id" => "integer",
      "is_success" => "boolean"
    }
  }
}
```

### 3.5 类型转换注意事项


> ⚠️ **重要提醒**
> 
> - 如果转换失败，字段会保持原来的类型
> - 字符串 "abc" 无法转换成数字，会保持字符串
> - 空值（null）转换后还是空值

**🔍 转换失败的处理**
```ruby
# 原始数据: response_time: "invalid_number"
filter {
  mutate {
    convert => { "response_time" => "float" }
  }
}
# 结果: response_time 仍然是 "invalid_number" (字符串)
```

---

## 4. ✏️ 字符串替换与处理


### 4.1 字符串替换语法


**🔸 基本替换操作**
```ruby
filter {
  mutate {
    gsub => [
      "字段名", "要替换的内容", "替换成的内容"
    ]
  }
}
```

### 4.2 简单字符替换


**💡 替换特殊字符**
```ruby
filter {
  mutate {
    gsub => [
      "log_message", " ", "_"  # 把空格替换成下划线
    ]
  }
}

# 处理前: log_message: "user login failed"
# 处理后: log_message: "user_login_failed"
```

**💡 清理敏感信息**
```ruby
filter {
  mutate {
    gsub => [
      "log_content", "password=\w+", "password=***"
    ]
  }
}

# 处理前: log_content: "login attempt password=secret123"  
# 处理后: log_content: "login attempt password=***"
```

### 4.3 正则表达式替换


**🔸 使用正则表达式**
```ruby
filter {
  mutate {
    gsub => [
      "phone_number", "(\d{3})\d{4}(\d{4})", "\1****\2"
    ]
  }
}

# 处理前: phone_number: "13812345678"
# 处理后: phone_number: "138****5678"
```

### 4.4 多个替换操作


```ruby
filter {
  mutate {
    gsub => [
      "user_input", "<", "&lt;",    # 转义 < 符号
      "user_input", ">", "&gt;",    # 转义 > 符号  
      "log_level", "ERROR", "错误"   # 替换英文为中文
    ]
  }
}
```

### 4.5 常见替换场景


**📋 实用替换示例**

| 替换目的 | 原内容 | 替换后 | 说明 |
|---------|--------|--------|------|
| 清理路径 | `/var/log/app.log` | `app.log` | 只保留文件名 |
| 隐藏IP | `192.168.1.100` | `192.168.1.***` | 保护隐私 |
| 格式统一 | `True/False` | `true/false` | 统一大小写 |
| 清理标记 | `[INFO]` | `INFO` | 去掉方括号 |

---

## 5. ✂️ 字段分割和连接操作


### 5.1 字段分割操作


**🔸 split - 分割字符串成数组**
```ruby
filter {
  mutate {
    split => { "字段名" => "分割符" }
  }
}
```

**💡 分割实际示例**
```ruby
filter {
  mutate {
    split => { "full_name" => " " }
  }
}

# 处理前: full_name: "张三 李四"
# 处理后: full_name: ["张三", "李四"] (数组)
```

**💡 分割CSV数据**
```ruby
filter {
  mutate {
    split => { "csv_data" => "," }
  }
}

# 处理前: csv_data: "name,age,city"
# 处理后: csv_data: ["name", "age", "city"]
```

### 5.2 字段连接操作


**🔸 join - 把数组连接成字符串**
```ruby
filter {
  mutate {
    join => { "字段名" => "连接符" }
  }
}
```

**💡 连接实际示例**
```ruby
filter {
  mutate {
    join => { "tags" => " | " }
  }
}

# 处理前: tags: ["error", "login", "database"]
# 处理后: tags: "error | login | database"
```

### 5.3 分割连接组合使用


**🔸 先分割再连接**
```ruby
filter {
  mutate {
    # 先分割
    split => { "log_path" => "/" }
  }
  
  mutate {
    # 再连接，用下划线
    join => { "log_path" => "_" }
  }
}

# 处理前: log_path: "/var/log/nginx/access.log"
# 中间状态: log_path: ["", "var", "log", "nginx", "access.log"]  
# 处理后: log_path: "_var_log_nginx_access.log"
```

### 5.4 分割操作的实际应用


**📋 常见分割场景**

| 数据类型 | 原数据 | 分割符 | 结果 |
|---------|--------|--------|------|
| 文件路径 | `/home/user/file.txt` | `/` | `["", "home", "user", "file.txt"]` |
| 标签列表 | `web,api,error` | `,` | `["web", "api", "error"]` |
| 版本号 | `1.2.3` | `.` | `["1", "2", "3"]` |
| 邮箱地址 | `user@domain.com` | `@` | `["user", "domain.com"]` |

---

## 6. 🔤 大小写转换功能


### 6.1 大小写转换选项


**📊 支持的转换类型**
- **lowercase** - 转换成小写
- **uppercase** - 转换成大写
- **capitalize** - 首字母大写

### 6.2 转换为小写


**🔸 lowercase用法**
```ruby
filter {
  mutate {
    lowercase => [ "username", "email" ]
  }
}

# 处理前: username: "JohnSmith", email: "John@Gmail.COM"
# 处理后: username: "johnsmith", email: "john@gmail.com"
```

### 6.3 转换为大写


**🔸 uppercase用法**
```ruby
filter {
  mutate {
    uppercase => [ "log_level", "country_code" ]
  }
}

# 处理前: log_level: "error", country_code: "cn"
# 处理后: log_level: "ERROR", country_code: "CN"
```

### 6.4 首字母大写


**🔸 capitalize用法**
```ruby
filter {
  mutate {
    capitalize => [ "user_name", "city_name" ]
  }
}

# 处理前: user_name: "john smith", city_name: "beijing"
# 处理后: user_name: "John smith", city_name: "Beijing"
```

### 6.5 大小写转换的实际用途


**✅ 常见应用场景**
- **邮箱标准化**：统一转成小写便于查询
- **日志级别统一**：ERROR、WARN、INFO等统一格式
- **用户名规范**：用户输入的用户名统一小写
- **国家代码**：CN、US、JP等统一大写

---

## 7. ➕ 字段添加与删除管理


### 7.1 添加新字段


**🔸 add_field - 添加静态字段**
```ruby
filter {
  mutate {
    add_field => { "new_field" => "value" }
  }
}
```

**💡 添加固定值字段**
```ruby
filter {
  mutate {
    add_field => { 
      "data_source" => "nginx_log",
      "processed_by" => "logstash",
      "version" => "1.0"
    }
  }
}
```

**💡 添加动态字段**
```ruby
filter {
  mutate {
    add_field => { 
      "full_info" => "%{username} from %{source_ip}"
    }
  }
}

# 如果 username="admin", source_ip="192.168.1.1"
# 结果: full_info: "admin from 192.168.1.1"
```

### 7.2 删除字段


**🔸 remove_field - 删除不需要的字段**
```ruby
filter {
  mutate {
    remove_field => [ "field1", "field2", "field3" ]
  }
}
```

**💡 删除敏感字段**
```ruby
filter {
  mutate {
    remove_field => [ "password", "credit_card", "ssn" ]
  }
}
```

**💡 删除临时处理字段**
```ruby
filter {
  # 先做一些处理...
  
  mutate {
    # 删除处理过程中产生的临时字段
    remove_field => [ "temp_field", "raw_data", "@metadata" ]
  }
}
```

### 7.3 字段复制


**🔸 copy_field - 复制字段内容**
```ruby
filter {
  mutate {
    copy => { "original_message" => "backup_message" }
  }
}
```

### 7.4 字段管理的最佳实践


**📋 字段管理策略**

| 操作类型 | 使用场景 | 示例 |
|---------|---------|------|
| 添加标识字段 | 标记数据来源 | `data_source: "apache"` |
| 删除敏感字段 | 保护隐私信息 | 删除 `password` 字段 |
| 复制重要字段 | 备份关键数据 | 复制 `message` 到 `original` |
| 删除无用字段 | 减少存储空间 | 删除空值和临时字段 |

---

## 8. 📊 数组操作处理


### 8.1 数组字段的特点


**💡 什么是数组字段**
数组就是包含多个值的字段，比如：
```json
{
  "tags": ["web", "error", "nginx"],
  "user_roles": ["admin", "editor"],
  "ip_list": ["192.168.1.1", "10.0.0.1"]
}
```

### 8.2 数组分割操作


**🔸 把字符串分割成数组**
```ruby
filter {
  mutate {
    split => { "tags_string" => "," }
  }
}

# 处理前: tags_string: "web,api,error"
# 处理后: tags_string: ["web", "api", "error"]
```

### 8.3 数组连接操作


**🔸 把数组连接成字符串**
```ruby
filter {
  mutate {
    join => { "error_codes" => " | " }
  }
}

# 处理前: error_codes: [404, 500, 503]
# 处理后: error_codes: "404 | 500 | 503"
```

### 8.4 数组元素操作


**🔸 访问数组的特定元素**
```ruby
filter {
  mutate {
    add_field => { 
      "first_tag" => "%{[tags][0]}",     # 第一个元素
      "second_tag" => "%{[tags][1]}"     # 第二个元素
    }
  }
}
```

### 8.5 数组实际应用场景


**📋 数组操作的常见用途**

| 场景 | 原数据 | 操作 | 结果 |
|------|--------|------|------|
| 标签分离 | `"error,web,nginx"` | split | `["error", "web", "nginx"]` |
| 路径处理 | `"/var/log/app.log"` | split → join | `"var_log_app.log"` |
| 错误代码 | `[404, 500, 502]` | join | `"404,500,502"` |
| 角色列表 | `["admin", "user"]` | join | `"admin\|user"` |

---

## 9. 🎯 条件字段操作


### 9.1 条件操作的概念


**💡 什么是条件操作**
根据某些条件来决定是否执行mutate操作，就像编程中的if语句一样。

```
通俗理解：
如果日志级别是ERROR，就添加一个紧急标记
如果用户名是admin，就添加管理员标签
```

### 9.2 基本条件语法


**🔸 条件判断结构**
```ruby
filter {
  if [字段名] == "值" {
    mutate {
      # 执行的操作
    }
  }
}
```

### 9.3 条件操作实际示例


**💡 根据日志级别添加字段**
```ruby
filter {
  if [log_level] == "ERROR" {
    mutate {
      add_field => { "alert_needed" => "true" }
      add_field => { "priority" => "high" }
    }
  }
}
```

**💡 根据状态码分类**
```ruby
filter {
  if [status_code] >= 400 {
    mutate {
      add_field => { "is_error" => "true" }
      uppercase => [ "log_level" ]
    }
  } else {
    mutate {
      add_field => { "is_error" => "false" }
    }
  }
}
```

### 9.4 复杂条件判断


**🔸 多条件组合**
```ruby
filter {
  if [source_ip] =~ /^192\.168\./ and [user_type] == "admin" {
    mutate {
      add_field => { "access_type" => "internal_admin" }
    }
  }
}
```

**🔸 条件存在性检查**
```ruby
filter {
  if [username] {  # 检查字段是否存在且不为空
    mutate {
      lowercase => [ "username" ]
    }
  }
}
```

### 9.5 条件操作的实际用途


**📋 常见条件操作场景**

| 条件 | 操作 | 用途 |
|------|------|------|
| `status_code >= 500` | 添加 `severity: critical` | 标记严重错误 |
| `user_agent =~ /bot/` | 添加 `is_bot: true` | 识别爬虫访问 |
| `response_time > 5000` | 添加 `slow_request: true` | 标记慢请求 |
| `[username] !~ /.+/` | 添加 `anonymous: true` | 标记匿名用户 |

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 Mutate过滤器本质：Logstash中的数据加工工具
🔸 基本功能：重命名、类型转换、字符串处理、字段管理
🔸 操作特点：在filter阶段对事件字段进行各种变换
🔸 应用场景：数据清洗、格式统一、字段标准化
🔸 配置原则：根据实际需求选择合适的操作类型
```

### 10.2 关键操作速查表


| 操作类型 | 语法 | 常用场景 |
|---------|------|---------|
| **重命名** | `rename => { "old" => "new" }` | 字段名标准化 |
| **类型转换** | `convert => { "field" => "integer" }` | 数据类型统一 |
| **字符替换** | `gsub => ["field", "old", "new"]` | 内容清理 |
| **分割连接** | `split => { "field" => "," }` | 数组处理 |
| **大小写** | `lowercase => ["field"]` | 格式统一 |
| **添加字段** | `add_field => { "new" => "value" }` | 数据标记 |
| **删除字段** | `remove_field => ["field"]` | 数据清理 |

### 10.3 最佳实践建议


**✅ 配置建议**
- **先测试**：在小数据集上测试配置文件
- **分步骤**：复杂操作分解成多个mutate块
- **加注释**：在配置文件中添加操作说明
- **备份字段**：重要字段修改前先备份

**⚠️ 注意事项**
- 类型转换失败不会报错，字段保持原类型
- 字段不存在时操作会被忽略
- 正则表达式要正确转义特殊字符
- 条件判断要考虑字段不存在的情况

### 10.4 实际应用价值


**🎯 业务价值**
- **数据标准化**：统一不同来源的数据格式
- **查询优化**：合适的数据类型提高查询效率  
- **存储优化**：删除无用字段减少存储空间
- **分析便利**：清理后的数据更容易分析

**核心记忆**：
- Mutate是数据加工的瑞士军刀
- 重命名让字段更好理解
- 类型转换让数据更规范
- 条件操作让处理更智能