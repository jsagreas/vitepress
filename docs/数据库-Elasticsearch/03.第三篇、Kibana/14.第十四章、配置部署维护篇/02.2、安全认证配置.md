---
title: 2ã€å®‰å…¨è®¤è¯é…ç½®
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ](#1-å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [ç”¨æˆ·åå¯†ç é…ç½®](#2-ç”¨æˆ·åå¯†ç é…ç½®)
3. [HTTPSå®‰å…¨è¿æ¥é…ç½®](#3-HTTPSå®‰å…¨è¿æ¥é…ç½®)
4. [X-Packå®‰å…¨åŠŸèƒ½å¯ç”¨](#4-X-Packå®‰å…¨åŠŸèƒ½å¯ç”¨)
5. [åŠ å¯†å¯†é’¥ä¸ä¼šè¯é…ç½®](#5-åŠ å¯†å¯†é’¥ä¸ä¼šè¯é…ç½®)
6. [CSRFä¿æŠ¤é…ç½®](#6-CSRFä¿æŠ¤é…ç½®)
7. [å®æˆ˜é…ç½®ç¤ºä¾‹](#7-å®æˆ˜é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Kibanaå®‰å…¨è®¤è¯


**ç®€å•ç†è§£**ï¼šå°±åƒç»™ä½ å®¶é—¨ä¸ŠåŠ æŠŠé”ä¸€æ ·ï¼ŒKibanaå®‰å…¨è®¤è¯å°±æ˜¯ç»™ä½ çš„æ•°æ®å¯è§†åŒ–å¹³å°åŠ ä¸Šå„ç§"é”"

```
æ²¡æœ‰å®‰å…¨è®¤è¯çš„Kibanaï¼š
ä»»ä½•äºº â†’ ç›´æ¥è®¿é—® â†’ çœ‹åˆ°æ‰€æœ‰æ•°æ®
å°±åƒå®¶é—¨ä¸é”ï¼Œä»»ä½•äººéƒ½èƒ½è¿›æ¥

æœ‰å®‰å…¨è®¤è¯çš„Kibanaï¼š
ç”¨æˆ· â†’ è¾“å…¥ç”¨æˆ·åå¯†ç  â†’ éªŒè¯èº«ä»½ â†’ è®¿é—®å¯¹åº”æ•°æ®
å°±åƒéœ€è¦é’¥åŒ™æ‰èƒ½å¼€é—¨
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨è®¤è¯


**æ ¸å¿ƒåŸå› **ï¼š
- ğŸ›¡ï¸ **ä¿æŠ¤æ•°æ®**ï¼šé˜²æ­¢æ•æ„Ÿä¿¡æ¯è¢«éšæ„æŸ¥çœ‹
- ğŸ‘¥ **ç”¨æˆ·ç®¡ç†**ï¼šä¸åŒç”¨æˆ·çœ‹ä¸åŒçš„æ•°æ®
- ğŸ“Š **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶è°èƒ½åšä»€ä¹ˆæ“ä½œ
- ğŸ”’ **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³ä¼ä¸šå®‰å…¨è§„èŒƒ

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
ç”µå•†å…¬å¸çš„Kibanaï¼š
- é”€å”®äººå‘˜ï¼šåªèƒ½çœ‹é”€å”®æ•°æ®
- è¿ç»´äººå‘˜ï¼šåªèƒ½çœ‹ç³»ç»Ÿç›‘æ§æ•°æ®  
- ç®¡ç†å±‚ï¼šå¯ä»¥çœ‹æ‰€æœ‰æ•°æ®
- å¤–éƒ¨äººå‘˜ï¼šå®Œå…¨æ— æ³•è®¿é—®
```

### 1.3 Kibanaå®‰å…¨æ¶æ„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ç”¨æˆ·æµè§ˆå™¨                    â”‚
â”‚                                         â”‚
â”‚  https://kibana.company.com             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTPSåŠ å¯†ä¼ è¾“
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             KibanaæœåŠ¡å™¨                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        èº«ä»½éªŒè¯æ¨¡å—                  â”‚â”‚
â”‚  â”‚   - ç”¨æˆ·åå¯†ç æ£€æŸ¥                   â”‚â”‚
â”‚  â”‚   - ä¼šè¯ç®¡ç†                        â”‚â”‚
â”‚  â”‚   - CSRFä¿æŠ¤                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ è®¤è¯è¯·æ±‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Elasticsearché›†ç¾¤                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        X-Pack Security              â”‚â”‚
â”‚  â”‚   - ç”¨æˆ·è§’è‰²ç®¡ç†                     â”‚â”‚
â”‚  â”‚   - æƒé™æ§åˆ¶                        â”‚â”‚
â”‚  â”‚   - æ•°æ®è®¿é—®æ§åˆ¶                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ‘¤ ç”¨æˆ·åå¯†ç é…ç½®


### 2.1 elasticsearch.usernameé…ç½®è¯¦è§£


**ä½œç”¨è¯´æ˜**ï¼šå‘Šè¯‰Kibanaç”¨å“ªä¸ªç”¨æˆ·èº«ä»½å»è¿æ¥Elasticsearch

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒä½ å»é“¶è¡ŒåŠäº‹ï¼Œéœ€è¦å‘Šè¯‰å·¥ä½œäººå‘˜ä½ æ˜¯è°ï¼ŒKibanaä¹Ÿéœ€è¦å‘Šè¯‰Elasticsearch"æˆ‘æ˜¯xxxç”¨æˆ·"

**é…ç½®ä½ç½®**ï¼š`kibana.yml`æ–‡ä»¶ä¸­

```yaml
# åŸºç¡€ç”¨æˆ·åé…ç½®
elasticsearch.username: "kibana_system"

# å¸¸è§ç”¨æˆ·åç±»å‹
elasticsearch.username: "elastic"          # è¶…çº§ç®¡ç†å‘˜ï¼ˆæ…ç”¨ï¼‰
elasticsearch.username: "kibana_system"    # Kibanaä¸“ç”¨ç”¨æˆ·ï¼ˆæ¨èï¼‰
elasticsearch.username: "readonly_user"    # åªè¯»ç”¨æˆ·
```

**é€‰æ‹©ç”¨æˆ·åçš„åŸåˆ™**ï¼š

| ç”¨æˆ·ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **æƒé™èŒƒå›´** | **å®‰å…¨çº§åˆ«** |
|---------|------------|-------------|-------------|
| `elastic` | åˆå§‹é…ç½®ã€ç´§æ€¥æƒ…å†µ | è¶…çº§ç®¡ç†å‘˜æƒé™ | âš ï¸ é«˜é£é™© |
| `kibana_system` | ç”Ÿäº§ç¯å¢ƒæ ‡å‡†é…ç½® | Kibanaè¿è¡Œå¿…éœ€æƒé™ | âœ… æ¨è |
| `è‡ªå®šä¹‰ç”¨æˆ·` | ç‰¹å®šéœ€æ±‚åœºæ™¯ | æŒ‰éœ€åˆ†é…æƒé™ | ğŸ”§ çµæ´»é…ç½® |

### 2.2 elasticsearch.passwordé…ç½®è¯¦è§£


**ä½œç”¨è¯´æ˜**ï¼šæä¾›ç”¨æˆ·åå¯¹åº”çš„å¯†ç ï¼Œè¯æ˜ä½ çœŸçš„æ˜¯è¿™ä¸ªç”¨æˆ·

**é…ç½®æ–¹å¼**ï¼š

```yaml
# æ–¹å¼1ï¼šç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­å†™å¯†ç ï¼ˆä¸æ¨èï¼‰
elasticsearch.password: "your_password_here"

# æ–¹å¼2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰
elasticsearch.password: "${KIBANA_PASSWORD}"

# æ–¹å¼3ï¼šä»æ–‡ä»¶è¯»å–å¯†ç ï¼ˆæœ€å®‰å…¨ï¼‰
elasticsearch.password: "${file:/path/to/password/file}"
```

**å®‰å…¨æœ€ä½³å®è·µ**ï¼š

```bash
# æ­¥éª¤1ï¼šåˆ›å»ºå¯†ç æ–‡ä»¶
echo "your_secure_password" > /etc/kibana/password.txt

# æ­¥éª¤2ï¼šè®¾ç½®æ–‡ä»¶æƒé™ï¼ˆåªæœ‰kibanaç”¨æˆ·èƒ½è¯»ï¼‰
chmod 600 /etc/kibana/password.txt
chown kibana:kibana /etc/kibana/password.txt

# æ­¥éª¤3ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨
elasticsearch.password: "${file:/etc/kibana/password.txt}"
```

### 2.3 ç”¨æˆ·å¯†ç ç®¡ç†å®æˆ˜


**åˆ›å»ºKibanaä¸“ç”¨ç”¨æˆ·**ï¼š

```bash
# 1. ä½¿ç”¨curlåˆ›å»ºç”¨æˆ·ï¼ˆåœ¨Elasticsearchä¸­ï¼‰
curl -X POST "localhost:9200/_security/user/kibana_user" \
-H "Content-Type: application/json" \
-d '{
  "password": "strong_password_123",
  "roles": ["kibana_system"],
  "full_name": "Kibana Service User"
}'

# 2. éªŒè¯ç”¨æˆ·åˆ›å»ºæˆåŠŸ
curl -X GET "localhost:9200/_security/user/kibana_user"
```

**å¯†ç å¤æ‚åº¦è¦æ±‚**ï¼š
- âœ… è‡³å°‘8ä½å­—ç¬¦
- âœ… åŒ…å«å¤§å°å†™å­—æ¯
- âœ… åŒ…å«æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
- âŒ é¿å…ä½¿ç”¨å¸¸è§è¯æ±‡
- âŒ ä¸è¦åŒ…å«ç”¨æˆ·åä¿¡æ¯

---

## 3. ğŸ”’ HTTPSå®‰å…¨è¿æ¥é…ç½®


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦HTTPS


**HTTP vs HTTPSå¯¹æ¯”**ï¼š

```
HTTPä¼ è¾“ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
ç”¨æˆ·æµè§ˆå™¨ ----æ˜æ–‡ä¼ è¾“----> KibanaæœåŠ¡å™¨
ç”¨æˆ·åï¼šadmin              â† ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°
å¯†ç ï¼š123456              â† å¯†ç å®Œå…¨æš´éœ²

HTTPSä¼ è¾“ï¼ˆå®‰å…¨ï¼‰ï¼š
ç”¨æˆ·æµè§ˆå™¨ ----åŠ å¯†ä¼ è¾“----> KibanaæœåŠ¡å™¨  
åŠ å¯†æ•°æ®ï¼š#@$%^&*()        â† å³ä½¿è¢«æˆªè·ä¹Ÿæ— æ³•è§£è¯»
```

> âš ï¸ **é‡è¦æé†’**ï¼šå¦‚æœä¸ä½¿ç”¨HTTPSï¼Œä½ çš„ç”¨æˆ·åå¯†ç å°±åƒåœ¨å¤§è¡—ä¸Šå–Šè¯ä¸€æ ·ï¼Œä»»ä½•äººéƒ½èƒ½å¬åˆ°ï¼

### 3.2 server.sslåŸºç¡€é…ç½®


**å¯ç”¨HTTPSçš„æ ¸å¿ƒé…ç½®**ï¼š

```yaml
# å¯ç”¨HTTPS
server.ssl.enabled: true

# æŒ‡å®šHTTPSç«¯å£ï¼ˆé»˜è®¤5601ï¼‰
server.port: 5601

# SSLè¯ä¹¦æ–‡ä»¶è·¯å¾„
server.ssl.certificate: "/path/to/your/certificate.crt"

# SSLç§é’¥æ–‡ä»¶è·¯å¾„  
server.ssl.key: "/path/to/your/private.key"
```

### 3.3 SSLè¯ä¹¦é…ç½®è¯¦è§£


**è¯ä¹¦ç±»å‹é€‰æ‹©**ï¼š

```
è‡ªç­¾åè¯ä¹¦ï¼š
ä¼˜ç‚¹ï¼šå…è´¹ã€å¿«é€Ÿç”Ÿæˆ
ç¼ºç‚¹ï¼šæµè§ˆå™¨ä¼šæ˜¾ç¤º"ä¸å®‰å…¨"è­¦å‘Š
é€‚ç”¨ï¼šå¼€å‘æµ‹è¯•ç¯å¢ƒ

æƒå¨æœºæ„è¯ä¹¦ï¼š
ä¼˜ç‚¹ï¼šæµè§ˆå™¨ä¿¡ä»»ã€ç”¨æˆ·ä½“éªŒå¥½
ç¼ºç‚¹ï¼šéœ€è¦è´­ä¹°ã€é…ç½®å¤æ‚
é€‚ç”¨ï¼šç”Ÿäº§ç¯å¢ƒ
```

**ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ç¤ºä¾‹**ï¼š

```bash
# 1. ç”Ÿæˆç§é’¥
openssl genrsa -out kibana.key 2048

# 2. ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚
openssl req -new -key kibana.key -out kibana.csr

# 3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl x509 -req -days 365 -in kibana.csr -signkey kibana.key -out kibana.crt

# 4. è®¾ç½®æ–‡ä»¶æƒé™
chmod 600 kibana.key kibana.crt
```

**å®Œæ•´SSLé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# HTTPSæœåŠ¡å™¨é…ç½®
server.ssl.enabled: true
server.ssl.certificate: "/etc/kibana/certs/kibana.crt"
server.ssl.key: "/etc/kibana/certs/kibana.key"

# å¯é€‰ï¼šè¯ä¹¦å¯†ç ä¿æŠ¤
server.ssl.keyPassphrase: "your_key_password"

# å¯é€‰ï¼šå®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
server.ssl.certificateAuthorities: ["/etc/kibana/certs/ca.crt"]
server.ssl.clientAuthentication: "optional"
```

---

## 4. âš¡ X-Packå®‰å…¨åŠŸèƒ½å¯ç”¨


### 4.1 ä»€ä¹ˆæ˜¯X-Pack Security


**ç®€å•ç†è§£**ï¼šX-Pack Securityå°±åƒä¸€ä¸ª"è¶…çº§ä¿å®‰ç³»ç»Ÿ"ï¼Œä¸“é—¨è´Ÿè´£ç®¡ç†è°èƒ½è®¿é—®ä»€ä¹ˆæ•°æ®

```
æ²¡æœ‰X-Pack Securityï¼š
æ‰€æœ‰ç”¨æˆ· â†’ çœ‹åˆ°ç›¸åŒå†…å®¹ â†’ æ²¡æœ‰æƒé™åŒºåˆ†

æœ‰X-Pack Securityï¼š
ç®¡ç†å‘˜   â†’ çœ‹æ‰€æœ‰æ•°æ®     â†’ å®Œå…¨æƒé™
æ™®é€šç”¨æˆ· â†’ çœ‹éƒ¨åˆ†æ•°æ®     â†’ å—é™æƒé™  
è®¿å®¢     â†’ çœ‹å…¬å¼€æ•°æ®     â†’ æœ€å°æƒé™
```

### 4.2 xpack.security.enabledé…ç½®


**åŸºç¡€å¯ç”¨é…ç½®**ï¼š

```yaml
# åœ¨kibana.ymlä¸­å¯ç”¨X-Packå®‰å…¨åŠŸèƒ½
xpack.security.enabled: true

# å¯é€‰ï¼šé…ç½®ç™»å½•é¡µé¢
xpack.security.loginAssistanceMessage: "è¯·è”ç³»ç®¡ç†å‘˜è·å–ç™»å½•å‡­æ®"

# å¯é€‰ï¼šé…ç½®ç”¨æˆ·ä¼šè¯
xpack.security.session.idleTimeout: "1h"
xpack.security.session.lifespan: "30d"
```

### 4.3 å®‰å…¨åŠŸèƒ½é…ç½®è¯¦è§£


**æ ¸å¿ƒå®‰å…¨é…ç½®é€‰é¡¹**ï¼š

| é…ç½®é¡¹ | **ä½œç”¨** | **æ¨èè®¾ç½®** | **è¯´æ˜** |
|-------|---------|-------------|---------|
| `xpack.security.enabled` | å¯ç”¨å®‰å…¨åŠŸèƒ½ | `true` | ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ |
| `xpack.security.encryptionKey` | ä¼šè¯åŠ å¯†å¯†é’¥ | 32ä½éšæœºå­—ç¬¦ä¸² | ä¿æŠ¤ç”¨æˆ·ä¼šè¯å®‰å…¨ |
| `xpack.security.session.idleTimeout` | ç©ºé—²è¶…æ—¶ | `1h` | é˜²æ­¢ä¼šè¯è¢«ç›—ç”¨ |
| `xpack.security.secureCookies` | å®‰å…¨Cookie | `true` | HTTPSç¯å¢ƒä¸‹å¯ç”¨ |

**å®‰å…¨çº§åˆ«é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# é«˜å®‰å…¨çº§åˆ«é…ç½®ï¼ˆé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
xpack.security.enabled: true
xpack.security.encryptionKey: "a_very_long_random_string_of_32_characters"
xpack.security.session.idleTimeout: "30m"
xpack.security.session.lifespan: "8h"
xpack.security.secureCookies: true

# ä¸­ç­‰å®‰å…¨çº§åˆ«é…ç½®ï¼ˆé€‚ç”¨äºå†…ç½‘ç¯å¢ƒï¼‰
xpack.security.enabled: true
xpack.security.session.idleTimeout: "2h"
xpack.security.session.lifespan: "24h"

# åŸºç¡€å®‰å…¨çº§åˆ«é…ç½®ï¼ˆé€‚ç”¨äºå¼€å‘ç¯å¢ƒï¼‰
xpack.security.enabled: true
xpack.security.session.idleTimeout: "4h"
```

---

## 5. ğŸ”‘ åŠ å¯†å¯†é’¥ä¸ä¼šè¯é…ç½®


### 5.1 åŠ å¯†å¯†é’¥çš„ä½œç”¨


**é€šä¿—è§£é‡Š**ï¼šå°±åƒä½ å®¶ä¿é™©ç®±çš„å¯†ç ï¼ŒåŠ å¯†å¯†é’¥ç”¨æ¥ä¿æŠ¤Kibanaä¸­å­˜å‚¨çš„æ•æ„Ÿä¿¡æ¯

```
ç”¨æˆ·ç™»å½•è¿‡ç¨‹ï¼š
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç  â†’ 
2. KibanaéªŒè¯æˆåŠŸ â†’ 
3. ç”Ÿæˆä¼šè¯ä¿¡æ¯ â†’ 
4. ç”¨åŠ å¯†å¯†é’¥åŠ å¯†ä¼šè¯ä¿¡æ¯ â†’ 
5. å­˜å‚¨åˆ°æµè§ˆå™¨Cookieä¸­

æ²¡æœ‰æ­£ç¡®çš„åŠ å¯†å¯†é’¥ = æ— æ³•è§£å¯†ä¼šè¯ä¿¡æ¯ = ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
```

### 5.2 xpack.security.encryptionKeyé…ç½®


**ç”Ÿæˆå®‰å…¨çš„åŠ å¯†å¯†é’¥**ï¼š

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨opensslç”Ÿæˆ32å­—èŠ‚éšæœºå¯†é’¥
openssl rand -base64 32

# æ–¹æ³•2ï¼šä½¿ç”¨Elasticsearchå·¥å…·ç”Ÿæˆ
bin/elasticsearch-keystore create
bin/elasticsearch-keystore add xpack.security.encryptionKey

# æ–¹æ³•3ï¼šä½¿ç”¨åœ¨çº¿å·¥å…·æˆ–è‡ªå®šä¹‰è„šæœ¬
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# ç›´æ¥é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
xpack.security.encryptionKey: "aBcDeFgHiJkLmNoPqRsTuVwXyZ1234567890"

# ç¯å¢ƒå˜é‡é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
xpack.security.encryptionKey: "${KIBANA_ENCRYPTION_KEY}"

# æ–‡ä»¶é…ç½®ï¼ˆæœ€å®‰å…¨ï¼‰
xpack.security.encryptionKey: "${file:/etc/kibana/encryption.key}"
```

### 5.3 ä¼šè¯è¶…æ—¶é…ç½®è¯¦è§£


**session.idleTimeout ç©ºé—²è¶…æ—¶**ï¼š

```yaml
# ç”¨æˆ·åœ¨æŒ‡å®šæ—¶é—´å†…æ— æ“ä½œï¼Œè‡ªåŠ¨é€€å‡ºç™»å½•
xpack.security.session.idleTimeout: "30m"    # 30åˆ†é’Ÿ
xpack.security.session.idleTimeout: "1h"     # 1å°æ—¶  
xpack.security.session.idleTimeout: "2h"     # 2å°æ—¶
```

**session.lifespan ä¼šè¯ç”Ÿå‘½å‘¨æœŸ**ï¼š

```yaml
# æ— è®ºç”¨æˆ·æ˜¯å¦æ´»è·ƒï¼Œåˆ°æ—¶é—´å°±å¼ºåˆ¶é€€å‡º
xpack.security.session.lifespan: "8h"        # 8å°æ—¶
xpack.security.session.lifespan: "24h"       # 24å°æ—¶
xpack.security.session.lifespan: "7d"        # 7å¤©
```

**æ¨èé…ç½®ç»„åˆ**ï¼š

| ç¯å¢ƒç±»å‹ | **ç©ºé—²è¶…æ—¶** | **ä¼šè¯ç”Ÿå‘½å‘¨æœŸ** | **åº”ç”¨åœºæ™¯** |
|---------|-------------|----------------|-------------|
| é«˜å®‰å…¨ç¯å¢ƒ | 15-30åˆ†é’Ÿ | 4-8å°æ—¶ | é‡‘èã€åŒ»ç–—ç­‰æ•æ„Ÿè¡Œä¸š |
| æ™®é€šåŠå…¬ç¯å¢ƒ | 1-2å°æ—¶ | 8-24å°æ—¶ | ä¸€èˆ¬ä¼ä¸šå†…éƒ¨ä½¿ç”¨ |
| å¼€å‘æµ‹è¯•ç¯å¢ƒ | 2-4å°æ—¶ | 24å°æ—¶-7å¤© | å¼€å‘äººå‘˜ä½¿ç”¨ |

---

## 6. ğŸ›¡ï¸ CSRFä¿æŠ¤é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ç®€å•ç†è§£**ï¼š

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·ç™»å½•Kibana â†’ æµè§ˆå™¨ä¿å­˜ç™»å½•çŠ¶æ€ â†’ ç”¨æˆ·åœ¨Kibanaä¸­æ“ä½œ

CSRFæ”»å‡»ï¼š
ç”¨æˆ·ç™»å½•Kibana â†’ æµè§ˆå™¨ä¿å­˜ç™»å½•çŠ¶æ€ â†’ 
ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™ â†’ æ¶æ„ç½‘ç«™è‡ªåŠ¨å‘Kibanaå‘é€è¯·æ±‚ â†’ 
Kibanaä»¥ä¸ºæ˜¯ç”¨æˆ·æ“ä½œ â†’ æ‰§è¡Œå±é™©æ“ä½œ
```

> âš ï¸ **å±é™©ç¤ºä¾‹**ï¼šä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™ï¼Œç„¶åè®¿é—®äº†ä¸€ä¸ªæ¶æ„ç½‘ç«™ï¼Œæ¶æ„ç½‘ç«™å¯èƒ½ä¼šè‡ªåŠ¨å¸®ä½ è½¬è´¦ï¼

### 6.2 Kibanaçš„CSRFä¿æŠ¤æœºåˆ¶


**ä¿æŠ¤åŸç†**ï¼š

```
å¯ç”¨CSRFä¿æŠ¤åï¼š
1. Kibanaç”Ÿæˆéšæœºtoken
2. æ¯ä¸ªè¯·æ±‚éƒ½å¿…é¡»æºå¸¦è¿™ä¸ªtoken
3. æ¶æ„ç½‘ç«™æ— æ³•è·å–è¿™ä¸ªtoken
4. æ²¡æœ‰tokençš„è¯·æ±‚è¢«æ‹’ç»
```

**é…ç½®CSRFä¿æŠ¤**ï¼š

```yaml
# å¯ç”¨CSRFä¿æŠ¤ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
server.csrf.enabled: true

# é…ç½®CSRFç™½åå•ï¼ˆå¯é€‰ï¼‰
server.csrf.whitelist: [
  "/api/status",
  "/api/health"
]

# é…ç½®è‡ªå®šä¹‰CSRFå¤´ï¼ˆé«˜çº§é€‰é¡¹ï¼‰
server.csrf.requiredHeaders: ["kbn-xsrf"]
```

### 6.3 CSRFé…ç½®æœ€ä½³å®è·µ


**ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**ï¼š

```yaml
# ä¸¥æ ¼çš„CSRFä¿æŠ¤
server.csrf.enabled: true
server.csrf.strict: true

# å®‰å…¨çš„cookieè®¾ç½®
server.csrf.secureCookies: true  # ä»…åœ¨HTTPSä¸‹ä¼ è¾“
server.csrf.sameSite: "strict"   # é˜²æ­¢è·¨ç«™è¯·æ±‚
```

**å¼€å‘ç¯å¢ƒé…ç½®**ï¼š

```yaml
# ç›¸å¯¹å®½æ¾çš„é…ç½®ï¼Œä¾¿äºå¼€å‘è°ƒè¯•
server.csrf.enabled: true
server.csrf.strict: false
server.csrf.whitelist: [
  "/api/dev/*",
  "/api/test/*"
]
```

---

## 7. ğŸš€ å®æˆ˜é…ç½®ç¤ºä¾‹


### 7.1 å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé…ç½®


```yaml
# ================================
# Kibanaç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®ç¤ºä¾‹
# ================================

# æœåŠ¡å™¨åŸºç¡€é…ç½®
server.port: 5601
server.host: "0.0.0.0"
server.name: "kibana-prod"

# HTTPSé…ç½®
server.ssl.enabled: true
server.ssl.certificate: "/etc/kibana/certs/kibana.crt"
server.ssl.key: "/etc/kibana/certs/kibana.key"

# Elasticsearchè¿æ¥é…ç½®
elasticsearch.hosts: ["https://es-node1:9200", "https://es-node2:9200"]
elasticsearch.username: "kibana_system"
elasticsearch.password: "${file:/etc/kibana/secrets/es_password}"
elasticsearch.ssl.certificateAuthorities: ["/etc/kibana/certs/ca.crt"]

# X-Packå®‰å…¨é…ç½®
xpack.security.enabled: true
xpack.security.encryptionKey: "${file:/etc/kibana/secrets/encryption.key}"
xpack.security.session.idleTimeout: "30m"
xpack.security.session.lifespan: "8h"
xpack.security.secureCookies: true

# CSRFä¿æŠ¤é…ç½®
server.csrf.enabled: true
server.csrf.strict: true

# æ—¥å¿—é…ç½®
logging.appenders.file.type: file
logging.appenders.file.fileName: /var/log/kibana/kibana.log
logging.root.level: info
```

### 7.2 å¼€å‘ç¯å¢ƒå¿«é€Ÿé…ç½®


```yaml
# ================================
# Kibanaå¼€å‘ç¯å¢ƒé…ç½®ç¤ºä¾‹
# ================================

# åŸºç¡€é…ç½®
server.port: 5601
server.host: "localhost"

# Elasticsearchè¿æ¥
elasticsearch.hosts: ["http://localhost:9200"]
elasticsearch.username: "elastic"
elasticsearch.password: "changeme"

# åŸºç¡€å®‰å…¨é…ç½®
xpack.security.enabled: true
xpack.security.encryptionKey: "development_key_32_characters_long"
xpack.security.session.idleTimeout: "4h"

# å¼€å‘å‹å¥½é…ç½®
server.csrf.enabled: true
server.csrf.strict: false
```

### 7.3 é…ç½®æ–‡ä»¶å®‰å…¨æ£€æŸ¥æ¸…å•


**ğŸ” é…ç½®éªŒè¯æ­¥éª¤**ï¼š

- [ ] âœ… HTTPSå·²å¯ç”¨ä¸”è¯ä¹¦æœ‰æ•ˆ
- [ ] âœ… ç”¨æˆ·åä¸ä½¿ç”¨é»˜è®¤çš„"elastic"  
- [ ] âœ… å¯†ç å¤æ‚åº¦ç¬¦åˆè¦æ±‚
- [ ] âœ… åŠ å¯†å¯†é’¥ä¸º32ä½éšæœºå­—ç¬¦ä¸²
- [ ] âœ… ä¼šè¯è¶…æ—¶æ—¶é—´åˆç†è®¾ç½®
- [ ] âœ… CSRFä¿æŠ¤å·²å¯ç”¨
- [ ] âœ… æ•æ„Ÿä¿¡æ¯ä½¿ç”¨æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡å­˜å‚¨
- [ ] âœ… é…ç½®æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡®ï¼ˆ600ï¼‰

**éªŒè¯é…ç½®å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
bin/kibana --config /etc/kibana/kibana.yml --validate

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /etc/kibana/kibana.yml

# æµ‹è¯•HTTPSè¿æ¥
curl -k https://localhost:5601/api/status

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
tail -f /var/log/kibana/kibana.log
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç”¨æˆ·è®¤è¯ï¼šé€šè¿‡ç”¨æˆ·åå¯†ç éªŒè¯èº«ä»½ï¼Œå°±åƒé—¨ç¦å¡
ğŸ”¸ HTTPSåŠ å¯†ï¼šä¿æŠ¤æ•°æ®ä¼ è¾“å®‰å…¨ï¼Œé˜²æ­¢è¢«çªƒå¬
ğŸ”¸ X-Pack Securityï¼šKibanaçš„"ä¿å®‰ç³»ç»Ÿ"ï¼Œç®¡ç†ç”¨æˆ·æƒé™
ğŸ”¸ ä¼šè¯ç®¡ç†ï¼šæ§åˆ¶ç”¨æˆ·ç™»å½•æ—¶é•¿ï¼Œé˜²æ­¢è´¦å·è¢«ç›—ç”¨
ğŸ”¸ CSRFä¿æŠ¤ï¼šé˜²æ­¢æ¶æ„ç½‘ç«™å†’å……ç”¨æˆ·æ“ä½œ
```

### 8.2 é…ç½®ä¼˜å…ˆçº§è®°å¿†


**ğŸ”¹ å®‰å…¨é…ç½®çš„é‡è¦æ€§æ’åº**ï¼š
```
1. HTTPSå¯ç”¨ï¼ˆæœ€é‡è¦ï¼‰
   â†“
2. ç”¨æˆ·åå¯†ç é…ç½®ï¼ˆåŸºç¡€è®¤è¯ï¼‰
   â†“  
3. X-Pack Securityå¯ç”¨ï¼ˆæƒé™ç®¡ç†ï¼‰
   â†“
4. åŠ å¯†å¯†é’¥è®¾ç½®ï¼ˆä¼šè¯ä¿æŠ¤ï¼‰
   â†“
5. CSRFä¿æŠ¤ï¼ˆæ”»å‡»é˜²æŠ¤ï¼‰
```

**ğŸ”¹ ç¯å¢ƒé…ç½®å·®å¼‚**ï¼š
```
å¼€å‘ç¯å¢ƒï¼š
- å¯ä»¥ä½¿ç”¨HTTP
- å¯†ç å¯ä»¥ç®€å•ä¸€äº›
- ä¼šè¯æ—¶é—´å¯ä»¥é•¿ä¸€äº›

ç”Ÿäº§ç¯å¢ƒï¼š
- å¿…é¡»ä½¿ç”¨HTTPS
- å¯†ç å¿…é¡»å¤æ‚
- ä¼šè¯æ—¶é—´è¦çŸ­
- æ‰€æœ‰å®‰å…¨åŠŸèƒ½éƒ½è¦å¯ç”¨
```

### 8.3 å¸¸è§é—®é¢˜è§£å†³


| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| æ— æ³•ç™»å½• | ç”¨æˆ·åå¯†ç é”™è¯¯ | æ£€æŸ¥ESä¸­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ |
| HTTPSæ— æ³•è®¿é—® | è¯ä¹¦é…ç½®é”™è¯¯ | æ£€æŸ¥è¯ä¹¦è·¯å¾„å’Œæƒé™ |
| é¢‘ç¹æ‰çº¿ | ä¼šè¯è¶…æ—¶å¤ªçŸ­ | è°ƒæ•´sessioné…ç½® |
| é¡µé¢æŠ¥é”™ | CSRFä¿æŠ¤è¿‡ä¸¥ | æ£€æŸ¥CSRFé…ç½® |

### 8.4 å®‰å…¨é…ç½®æœ€ä½³å®è·µ


**ğŸ“ ç”Ÿäº§ç¯å¢ƒå¿…åšæ¸…å•**ï¼š
- âœ… å¯ç”¨HTTPSï¼Œä½¿ç”¨æœ‰æ•ˆè¯ä¹¦
- âœ… åˆ›å»ºä¸“ç”¨kibana_systemç”¨æˆ·
- âœ… ä½¿ç”¨å¼ºå¯†ç å’ŒåŠ å¯†å¯†é’¥
- âœ… è®¾ç½®åˆç†çš„ä¼šè¯è¶…æ—¶
- âœ… å¯ç”¨æ‰€æœ‰å®‰å…¨ä¿æŠ¤åŠŸèƒ½
- âœ… å®šæœŸæ›´æ¢å¯†ç å’Œå¯†é’¥
- âœ… ç›‘æ§å®‰å…¨æ—¥å¿—

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨é…ç½®å°±åƒç»™æˆ¿å­è£…é˜²ç›—é—¨ï¼Œæ¯ä¸€å±‚ä¿æŠ¤éƒ½å¾ˆé‡è¦
- HTTPSæ˜¯åŸºç¡€ï¼Œå°±åƒæˆ¿å­çš„å¢™
- ç”¨æˆ·è®¤è¯æ˜¯é—¨é”ï¼ŒX-Packæ˜¯ä¿å®‰
- ä¼šè¯ç®¡ç†æ˜¯ç›‘æ§ï¼ŒCSRFæ˜¯é˜²ç«å¢™
- é…ç½®è¦åˆ†ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒå®‰å…¨ç¬¬ä¸€