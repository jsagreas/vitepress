---
title: 2、Maps地理可视化
---
## 📚 目录

1. [地图可视化基础概念](#1-地图可视化基础概念)
2. [地理坐标数据准备](#2-地理坐标数据准备)
3. [Maps应用操作实践](#3-maps应用操作实践)
4. [地图图层配置详解](#4-地图图层配置详解)
5. [高级地图功能应用](#5-高级地图功能应用)
6. [实际应用场景案例](#6-实际应用场景案例)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🗺️ 地图可视化基础概念


### 1.1 什么是Kibana Maps


**简单理解**：Maps就是Kibana提供的"电子地图"功能，能把你的数据在地图上显示出来

```
传统数据展示：          地图数据展示：
用户IP: 192.168.1.1     用户IP在地图上显示为北京的一个点
销售额: 10000元         销售额显示为北京区域的颜色深浅
                       
普通表格很难看出地理规律   地图上一眼就能看出哪个地区业务好
```

**核心作用**：
- **地理分析**：看出数据的地域分布规律
- **空间洞察**：发现传统图表看不出的空间关系
- **直观展示**：用地图这种最直观的方式展示位置数据

### 1.2 Maps适用的业务场景


**典型应用场景**：

```
🌐 网站访问分析：
- 用户来源地域分布
- 不同地区的访问量对比
- 热门内容的地域偏好

📊 业务运营分析：
- 销售业绩的地域分布
- 门店效益地图展示
- 物流配送路径优化

🔒 安全监控场景：
- 攻击来源地理分布
- 异常登录位置检测
- 网络威胁态势感知

📱 IoT设备监控：
- 传感器设备分布图
- 设备状态地理展示
- 环境数据空间分析
```

### 1.3 Maps的核心优势


**为什么要用地图可视化**：

> 💡 **核心理念**：空间数据需要空间展示方式

```
优势对比：

传统图表：
✅ 数据精确
❌ 缺乏空间感
❌ 难以发现地理规律

地图可视化：
✅ 空间直观
✅ 地理规律清晰
✅ 交互性强
✅ 信息密度高
```

---

## 2. 📍 地理坐标数据准备


### 2.1 地理数据类型详解


**geo_point字段类型**：存储地球上的精确点位置

```json
// geo_point字段的数据格式
{
  "location": {
    "lat": 39.9042,    // 纬度：-90到90
    "lon": 116.4074    // 经度：-180到180
  }
}

// 或者更简洁的格式
{
  "location": "39.9042,116.4074"  // 纬度,经度
}
```

**geo_shape字段类型**：存储复杂的地理形状

```json
// 多边形区域（比如行政区域边界）
{
  "region": {
    "type": "polygon",
    "coordinates": [
      [
        [116.3, 39.9], [116.4, 39.9],
        [116.4, 40.0], [116.3, 40.0],
        [116.3, 39.9]  // 闭合多边形
      ]
    ]
  }
}
```

### 2.2 GeoIP功能详解


**什么是GeoIP**：自动将IP地址转换为地理位置

> 🔧 **工作原理**：Elasticsearch内置了IP地址到地理位置的映射数据库

**GeoIP处理流程**：
```
原始日志：                    GeoIP处理后：
IP: 203.208.60.1             IP: 203.208.60.1
                             ↓
                             country: China
                             city: Beijing
                             location: 39.9042,116.4074
```

**GeoIP管道配置示例**：
```json
PUT _ingest/pipeline/geoip-pipeline
{
  "processors": [
    {
      "geoip": {
        "field": "client_ip",
        "target_field": "geo_info"
      }
    }
  ]
}
```

### 2.3 数据准备实践


**第一步：准备示例数据**

```json
// 网站访问日志示例
POST sales_geo/_bulk
{"index":{}}
{"timestamp":"2024-01-15T10:30:00","client_ip":"203.208.60.1","sales_amount":15000,"product":"手机"}
{"index":{}}
{"timestamp":"2024-01-15T11:20:00","client_ip":"59.108.54.37","sales_amount":8500,"product":"笔记本"}
{"index":{}}
{"timestamp":"2024-01-15T12:10:00","client_ip":"219.142.68.23","sales_amount":12000,"product":"平板"}
```

**第二步：创建索引映射**

```json
PUT sales_geo
{
  "mappings": {
    "properties": {
      "timestamp": {"type": "date"},
      "client_ip": {"type": "ip"},
      "geo_info": {
        "properties": {
          "location": {"type": "geo_point"}
        }
      },
      "sales_amount": {"type": "integer"},
      "product": {"type": "keyword"}
    }
  }
}
```

> ⚠️ **重要提醒**：geo_point字段必须在索引映射中明确定义，否则无法在地图上正确显示

---

## 3. 🎯 Maps应用操作实践


### 3.1 创建第一个地图


**操作步骤**：

1. **进入Maps应用**
   ```
   Kibana首页 → 侧边栏 → Analytics → Maps
   ```

2. **创建新地图**
   ```
   点击 "Create map" → 进入地图编辑界面
   ```

3. **基础地图界面说明**
   ```
   ┌─────────────────────────────────────┐
   │ 工具栏：保存、分享、设置              │
   ├─────────────────────────────────────┤
   │ 图层面板  │        地图显示区域     │
   │ (左侧)   │                        │
   │          │        🗺️              │
   │ + 添加图层 │                        │
   │          │                        │
   │ 图层列表  │                        │
   └─────────────────────────────────────┘
   ```

### 3.2 添加数据图层


**添加Elasticsearch数据图层**：

1. **点击"Add layer"**
   ```
   选择 "Documents" → 这是最常用的数据图层类型
   ```

2. **配置数据源**
   ```
   Index pattern: sales_geo*
   Geospatial field: geo_info.location
   ```

3. **设置显示样式**
   ```
   Icon: 可以选择圆点、方块等标记
   Size: 固定大小或根据数据动态调整
   Color: 固定颜色或根据字段值着色
   ```

> 💡 **新手提示**：第一次使用建议选择最简单的圆点标记，颜色选择固定颜色，先看到效果再调整

### 3.3 地图基本操作


**地图交互操作**：

| 操作 | 方法 | 作用 |
|------|------|------|
| **缩放** | 鼠标滚轮 | 放大缩小地图 |
| **平移** | 鼠标拖拽 | 移动地图视角 |
| **信息查看** | 点击数据点 | 查看详细信息 |
| **框选过滤** | <kbd>Ctrl</kbd> + 拖拽 | 选择区域过滤数据 |

**地图控件说明**：
```
┌─ + / - ─┐  缩放控件
│  🧭    │  方向控件  
│  📍    │  定位控件
│  🔧    │  工具栏
└────────┘
```

---

## 4. 🎨 地图图层配置详解


### 4.1 点图层配置


**点图层**：在地图上显示精确位置的数据点

**配置选项详解**：

```
图标设置：
├─ Symbol: circle（圆点）、square（方块）、triangle（三角）
├─ Size: 固定大小 6-50px，或基于字段动态调整
└─ Color: 固定颜色，或基于字段值映射颜色

标签设置：
├─ Label field: 选择要显示的字段
├─ Font size: 标签字体大小
└─ Label position: 标签显示位置
```

**动态大小配置示例**：
```
Size by: sales_amount
Min size: 8px
Max size: 32px

结果：销售额大的点显示更大，直观看出业绩差异
```

### 4.2 热力图图层


**热力图**：用颜色密度显示数据分布情况

> 🔥 **适用场景**：当数据点密集时，热力图比散点图更清晰

**热力图配置**：
```
Radius: 30-100px（影响范围大小）
Blur: 1-20（模糊程度，数值越大越平滑）
Max intensity: 自动计算或手动设置
Color ramp: 颜色渐变方案（蓝→红，绿→黄→红等）
```

**热力图vs点图层对比**：
```
数据量少（<1000点）： 建议用点图层，信息更精确
数据量多（>1000点）： 建议用热力图，趋势更明显
```

### 4.3 聚合气泡图


**聚合气泡图**：将相近的数据点合并显示

**配置流程**：
1. **添加图层** → 选择 "Clusters and grids"
2. **设置聚合方式**：
   ```
   Grid aggregation: geohash_grid（地理网格聚合）
   Precision: 1-12（数字越大网格越细）
   ```

3. **设置气泡样式**：
   ```
   Size by: doc_count（文档数量）或其他聚合指标
   Color by: 平均值、最大值、总和等聚合结果
   ```

**聚合精度对比**：
```
Precision 2: 全国几个大区域
Precision 5: 省级级别区域  
Precision 8: 城市级别区域
Precision 12: 街道级别区域
```

### 4.4 分级着色地图


**分级着色地图**：用不同颜色填充地理区域

**应用场景**：
```
✅ 展示各省销售业绩
✅ 显示各地区用户密度
✅ 对比不同区域的指标数据
```

**配置步骤**：
1. **选择边界数据**：
   ```
   Elastic Maps Service → China provinces
   或上传自定义边界文件（GeoJSON格式）
   ```

2. **设置数据关联**：
   ```
   Join field: province_name（边界数据中的字段）
   Index pattern: 你的数据索引
   Term field: province（数据中的省份字段）
   ```

3. **配置着色规则**：
   ```
   Metric: 要显示的指标（销售额、用户数等）
   Color ramp: 颜色方案
   Classification: 数据分级方式
   ```

---

## 5. 🚀 高级地图功能应用


### 5.1 底图服务配置


**什么是底图**：地图的背景图层，提供地理参考信息

**内置底图选项**：
```
🗺️ Road map: 道路地图，显示街道和地名
🛰️ Satellite: 卫星图像，真实地貌
🗂️ Dark mode: 深色主题，突出数据层
📋 Light mode: 浅色主题，简洁清爽
```

**切换底图方法**：
```
地图右上角 → 图层控制 → Base layer → 选择底图类型
```

**自定义底图服务**：
```json
// 在kibana.yml中配置自定义地图服务
map.tilemap.url: "https://your-tile-server/{z}/{x}/{y}.png"
map.tilemap.options.attribution: "© Your Map Provider"
```

### 5.2 坐标系设置


**常用坐标系统**：

| 坐标系 | 说明 | 适用场景 |
|--------|------|----------|
| **WGS84** | 全球标准，GPS使用 | 国际业务，精确定位 |
| **GCJ02** | 中国偏移坐标系 | 中国地区业务 |
| **BD09** | 百度坐标系 | 使用百度地图API |

> ⚠️ **坐标系提醒**：如果你的数据来源于国内地图API，可能需要坐标转换

**坐标转换示例**：
```javascript
// GCJ02 转 WGS84 的简化公式（仅示意）
function gcj02ToWgs84(gcjLat, gcjLon) {
  // 实际转换需要复杂的算法
  // 建议使用专门的坐标转换库
  return [adjustedLat, adjustedLon];
}
```

### 5.3 时间动画功能


**时间动画**：展示数据随时间的变化过程

**配置时间动画**：
1. **数据要求**：必须有时间字段
2. **启用动画**：
   ```
   地图设置 → Time slider → 启用
   设置时间字段和播放间隔
   ```

3. **动画效果**：
   ```
   播放控制：播放/暂停/快进/后退
   时间显示：当前时间范围显示
   数据变化：地图上数据点动态出现/消失
   ```

**实际应用示例**：
```
疫情传播动画：显示确诊病例随时间的地理扩散
销售趋势动画：展示各地区销售业绩的月度变化
用户增长动画：观察新用户注册的地域扩张
```

---

## 6. 📊 实际应用场景案例


### 6.1 网站访问来源分析


**业务需求**：分析网站用户的地理来源分布

**实现步骤**：

1. **数据准备**：
   ```json
   // 访问日志包含IP地址
   {
     "timestamp": "2024-01-15T10:30:00",
     "client_ip": "203.208.60.1",
     "page_url": "/products",
     "user_agent": "Chrome/91.0"
   }
   ```

2. **GeoIP处理**：
   ```json
   // 使用ingest pipeline添加地理信息
   PUT _ingest/pipeline/web-geoip
   {
     "processors": [
       {
         "geoip": {
           "field": "client_ip",
           "target_field": "geo"
         }
       }
     ]
   }
   ```

3. **地图配置**：
   ```
   图层类型：热力图
   数据源：web_logs*
   地理字段：geo.location
   时间字段：timestamp
   
   结果：清晰显示用户访问热点区域
   ```

### 6.2 销售业绩地域分析


**业务需求**：对比各地区销售业绩，找出潜力市场

**地图设计方案**：

```
方案一：聚合气泡图
├─ 优点：可以同时显示销售额和订单量
├─ 配置：气泡大小=销售额，颜色=平均客单价
└─ 适用：详细分析各城市表现

方案二：分级着色地图  
├─ 优点：省级对比一目了然
├─ 配置：颜色深浅=省份总销售额
└─ 适用：宏观区域对比分析
```

**核心指标设置**：
```
销售额聚合：sum(sales_amount)
订单量聚合：doc_count
平均客单价：avg(order_value)
增长率计算：通过时间对比实现
```

### 6.3 IoT设备监控地图


**业务需求**：实时监控分布在各地的IoT设备状态

**地图功能设计**：

```
设备状态显示：
🟢 正常：绿色圆点
🟡 警告：黄色三角
🔴 故障：红色方块
⚫ 离线：灰色圆点
```

**实时更新配置**：
```
刷新间隔：30秒自动更新
过滤条件：只显示过去5分钟的数据
告警联动：异常设备弹出详细信息
```

**设备详情面板**：
```javascript
// 点击设备显示详细信息
{
  "device_id": "sensor_001",
  "location": "北京市朝阳区",
  "status": "warning", 
  "temperature": 85.2,
  "last_report": "2024-01-15T14:30:00"
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 地图可视化本质：用空间展示方式分析地理数据
🔸 数据类型：geo_point（点位置）、geo_shape（区域形状）
🔸 GeoIP功能：自动将IP地址转换为地理位置
🔸 图层类型：点图层、热力图、聚合气泡、分级着色
🔸 坐标系统：WGS84、GCJ02等不同标准要注意
```

### 7.2 关键操作技能


**🔹 数据准备流程**
```
1. 确保数据包含地理信息（坐标或IP地址）
2. 正确设置geo_point字段映射
3. 配置GeoIP pipeline处理IP地址
4. 验证地理数据格式正确性
```

**🔹 图层选择原则**
```
数据点少且精确 → 点图层
数据点多且密集 → 热力图  
需要区域汇总 → 聚合气泡图
对比行政区域 → 分级着色地图
```

**🔹 性能优化要点**
```
大数据量：使用聚合而非原始文档
合适精度：根据分析需求选择聚合精度
时间过滤：避免加载过多历史数据
图层控制：只显示必要的图层
```

### 7.3 实际应用价值


**📊 业务洞察能力**
- **空间模式发现**：识别地理分布规律
- **区域对比分析**：快速对比不同地区表现  
- **异常检测**：发现地理异常和热点
- **趋势预测**：基于地理扩散预测趋势

**🎯 适用业务场景**
```
✅ 电商平台：用户分布、销售热点、物流优化
✅ 金融行业：网点分布、风险区域、客户密度
✅ 安全监控：攻击来源、异常登录、威胁分布
✅ IoT应用：设备监控、环境感知、故障定位
```

### 7.4 学习进阶路线


**🎚️ 学习阶段规划**

```
入门阶段（1-2周）：
├─ 掌握基本操作：创建地图、添加图层
├─ 理解数据准备：geo_point、GeoIP配置
└─ 熟悉基础图层：点图层、热力图

进阶阶段（2-3周）：
├─ 高级图层：聚合气泡、分级着色
├─ 样式配置：动态大小、颜色映射
└─ 性能优化：聚合策略、数据过滤

高级阶段（持续学习）：
├─ 自定义功能：底图服务、坐标转换
├─ 业务整合：仪表板集成、告警联动
└─ 深度分析：空间统计、地理模型
```

> 🧠 **核心记忆口诀**：
> 
> *地图展示有空间，坐标数据是关键*  
> *点热聚合选对象，图层配置要熟练*  
> *GeoIP转换很神奇，业务场景定策略*  
> *空间分析见规律，可视洞察更直观*

**⏱️ 学习建议**：
- **动手实践**：每个概念都要亲自操作一遍
- **数据驱动**：用真实业务数据练习更有效果  
- **场景导向**：结合具体业务场景理解功能价值
- **循序渐进**：先掌握基础再学高级功能