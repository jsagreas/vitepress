---
title: 18ã€Watcherå‘Šè­¦è§„åˆ™è®¾ç½®
---
## ğŸ“š ç›®å½•

1. [WatcheråŸºç¡€æ¦‚å¿µ](#1-WatcheråŸºç¡€æ¦‚å¿µ)
2. [å‘Šè­¦æ¡ä»¶é…ç½®](#2-å‘Šè­¦æ¡ä»¶é…ç½®)
3. [æŸ¥è¯¢è§¦å‘å™¨è®¾ç½®](#3-æŸ¥è¯¢è§¦å‘å™¨è®¾ç½®)
4. [é˜ˆå€¼è§„åˆ™å®šä¹‰](#4-é˜ˆå€¼è§„åˆ™å®šä¹‰)
5. [æ—¶é—´çª—å£é…ç½®](#5-æ—¶é—´çª—å£é…ç½®)
6. [å‘Šè­¦é¢‘ç‡æ§åˆ¶](#6-å‘Šè­¦é¢‘ç‡æ§åˆ¶)
7. [å‘Šè­¦çŠ¶æ€ç®¡ç†](#7-å‘Šè­¦çŠ¶æ€ç®¡ç†)
8. [è§„åˆ™æµ‹è¯•éªŒè¯](#8-è§„åˆ™æµ‹è¯•éªŒè¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” WatcheråŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Watcher


**é€šä¿—ç†è§£**ï¼šWatcherå°±åƒæ˜¯ä¸€ä¸ª"æ•°æ®ç›‘è§†å‘˜"ï¼Œå®ƒä¼šå®šæœŸæ£€æŸ¥ä½ çš„æ•°æ®ï¼Œä¸€æ—¦å‘ç°å¼‚å¸¸æƒ…å†µå°±ç«‹å³å‘å‡ºè­¦æŠ¥ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
å®¶é‡Œçš„çƒŸé›¾æŠ¥è­¦å™¨ â†’ ç›‘æµ‹çƒŸé›¾æµ“åº¦
é“¶è¡Œçš„é£æ§ç³»ç»Ÿ   â†’ ç›‘æµ‹å¼‚å¸¸äº¤æ˜“
ç½‘ç«™çš„ç›‘æ§ç³»ç»Ÿ   â†’ ç›‘æµ‹è®¿é—®é‡å¼‚å¸¸

Kibanaçš„Watcher â†’ ç›‘æµ‹æ—¥å¿—æ•°æ®å¼‚å¸¸
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **è‡ªåŠ¨ç›‘æ§**ï¼šæ— éœ€äººå·¥å€¼å®ˆï¼Œ24å°æ—¶è‡ªåŠ¨æ£€æŸ¥
- ğŸ”¸ **åŠæ—¶å‘Šè­¦**ï¼šé—®é¢˜å‘ç”Ÿæ—¶ç«‹å³é€šçŸ¥ç›¸å…³äººå‘˜
- ğŸ”¸ **æ•°æ®é©±åŠ¨**ï¼šåŸºäºçœŸå®æ•°æ®å˜åŒ–è¿›è¡Œåˆ¤æ–­
- ğŸ”¸ **çµæ´»é…ç½®**ï¼šå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚å®šåˆ¶è§„åˆ™

### 1.2 Watcherçš„å·¥ä½œåŸç†


```
Watcherå·¥ä½œæµç¨‹ï¼š
å®šæ—¶ä»»åŠ¡ â†’ æ‰§è¡ŒæŸ¥è¯¢ â†’ æ£€æŸ¥æ¡ä»¶ â†’ è§¦å‘å‘Šè­¦ â†’ å‘é€é€šçŸ¥

å…·ä½“æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®šæ—¶æ£€æŸ¥    â”‚â”€â”€â”€â†’â”‚  æŸ¥è¯¢æ•°æ®    â”‚â”€â”€â”€â†’â”‚  åˆ¤æ–­æ¡ä»¶    â”‚
â”‚(æ¯5åˆ†é’Ÿä¸€æ¬¡) â”‚    â”‚(æœ€è¿‘5åˆ†é’Ÿ)   â”‚    â”‚(é”™è¯¯ç‡>10%) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  å‘é€é‚®ä»¶    â”‚â†â”€â”€â”€â”‚  è§¦å‘å‘Šè­¦    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚(é€šçŸ¥è¿ç»´)    â”‚    â”‚(è®°å½•æ—¥å¿—)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Watcherçš„æ ¸å¿ƒç»„ä»¶


**Watchç»“æ„è§£æ**ï¼š
```
ä¸€ä¸ªWatchåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š

è§¦å‘å™¨(Trigger)ï¼šä»€ä¹ˆæ—¶å€™æ£€æŸ¥ï¼Ÿ
â”œâ”€â”€ å®šæ—¶è§¦å‘ï¼šæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥
â””â”€â”€ äº‹ä»¶è§¦å‘ï¼šç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶æ£€æŸ¥

è¾“å…¥(Input)ï¼šæ£€æŸ¥ä»€ä¹ˆæ•°æ®ï¼Ÿ
â”œâ”€â”€ æŸ¥è¯¢Elasticsearchæ•°æ®
â”œâ”€â”€ HTTPè¯·æ±‚è·å–å¤–éƒ¨æ•°æ®
â””â”€â”€ ç®€å•çš„é™æ€æ•°æ®

æ¡ä»¶(Condition)ï¼šä»€ä¹ˆæƒ…å†µä¸‹å‘Šè­¦ï¼Ÿ
â”œâ”€â”€ æ•°å€¼æ¯”è¾ƒï¼šå¤§äºã€å°äºã€ç­‰äº
â”œâ”€â”€ èŒƒå›´åˆ¤æ–­ï¼šåœ¨æŸä¸ªåŒºé—´å†…
â””â”€â”€ å¤æ‚é€»è¾‘ï¼šå¤šä¸ªæ¡ä»¶ç»„åˆ

åŠ¨ä½œ(Actions)ï¼šå‘Šè­¦ååšä»€ä¹ˆï¼Ÿ
â”œâ”€â”€ å‘é€é‚®ä»¶é€šçŸ¥
â”œâ”€â”€ å†™å…¥æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ è°ƒç”¨Webhookæ¥å£
â””â”€â”€ åˆ›å»ºç´¢å¼•è®°å½•
```

---

## 2. âš™ï¸ å‘Šè­¦æ¡ä»¶é…ç½®


### 2.1 æ¡ä»¶ç±»å‹è¯¦è§£


**ğŸ”¸ æ•°å€¼æ¯”è¾ƒæ¡ä»¶**
```javascript
// ç¤ºä¾‹ï¼šæ£€æŸ¥é”™è¯¯æ—¥å¿—æ•°é‡
{
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gt": 100  // å¤§äº100æ¡é”™è¯¯æ—¥å¿—æ—¶å‘Šè­¦
      }
    }
  }
}

é€šä¿—è§£é‡Šï¼š
- gtï¼šgreater thanï¼Œå¤§äº
- gteï¼šgreater than or equalï¼Œå¤§äºç­‰äº
- ltï¼šless thanï¼Œå°äº
- lteï¼šless than or equalï¼Œå°äºç­‰äº
- eqï¼šequalï¼Œç­‰äº
```

**ğŸ”¸ èŒƒå›´åˆ¤æ–­æ¡ä»¶**
```javascript
// ç¤ºä¾‹ï¼šæ£€æŸ¥å“åº”æ—¶é—´æ˜¯å¦å¼‚å¸¸
{
  "condition": {
    "script": {
      "source": """
        def avgResponseTime = ctx.payload.aggregations.avg_response_time.value;
        return avgResponseTime > 1000 || avgResponseTime < 10;
      """
    }
  }
}

ä¸šåŠ¡å«ä¹‰ï¼š
å“åº”æ—¶é—´è¶…è¿‡1ç§’æˆ–å°äº10æ¯«ç§’æ—¶å‘Šè­¦
ï¼ˆå¯èƒ½æ˜¯ç³»ç»Ÿå¼‚å¸¸æˆ–æ•°æ®é”™è¯¯ï¼‰
```

### 2.2 å¤åˆæ¡ä»¶é…ç½®


**å¤šæ¡ä»¶ç»„åˆ**ï¼š
```javascript
{
  "condition": {
    "script": {
      "source": """
        // è·å–å„é¡¹æŒ‡æ ‡
        def errorCount = ctx.payload.aggregations.error_count.doc_count;
        def avgResponseTime = ctx.payload.aggregations.avg_response_time.value;
        def hour = ctx.execution_time.getHourOfDay();
        
        // ä¸šåŠ¡æ—¶é—´ï¼ˆ9-18ç‚¹ï¼‰æ›´ä¸¥æ ¼çš„æ ‡å‡†
        if (hour >= 9 && hour <= 18) {
          return errorCount > 50 || avgResponseTime > 500;
        }
        // éä¸šåŠ¡æ—¶é—´ç›¸å¯¹å®½æ¾
        else {
          return errorCount > 100 || avgResponseTime > 1000;
        }
      """
    }
  }
}
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
- ğŸ”¹ **ä¸šåŠ¡é«˜å³°æœŸ**ï¼šæ›´ä¸¥æ ¼çš„ç›‘æ§æ ‡å‡†
- ğŸ”¹ **éä¸šåŠ¡æ—¶é—´**ï¼šé€‚åº¦æ”¾å®½å‘Šè­¦é˜ˆå€¼
- ğŸ”¹ **ä¸åŒæœåŠ¡**ï¼šé‡‡ç”¨ä¸åŒçš„åˆ¤æ–­é€»è¾‘

---

## 3. ğŸ¯ æŸ¥è¯¢è§¦å‘å™¨è®¾ç½®


### 3.1 å®šæ—¶è§¦å‘å™¨é…ç½®


**åŸºç¡€å®šæ—¶é…ç½®**ï¼š
```javascript
{
  "trigger": {
    "schedule": {
      "interval": "5m"  // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    }
  }
}

å¸¸ç”¨æ—¶é—´é—´éš”ï¼š
- "30s"  ï¼š30ç§’
- "1m"   ï¼š1åˆ†é’Ÿ  
- "5m"   ï¼š5åˆ†é’Ÿ
- "1h"   ï¼š1å°æ—¶
- "1d"   ï¼š1å¤©
```

**Cronè¡¨è¾¾å¼å®šæ—¶**ï¼š
```javascript
{
  "trigger": {
    "schedule": {
      "cron": "0 */5 * * * ?"  // æ¯5åˆ†é’Ÿçš„æ•´ç‚¹æ‰§è¡Œ
    }
  }
}

Cronè¡¨è¾¾å¼è§£é‡Šï¼š
ç§’ åˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
0  */5 *  *  *  ?

å®ç”¨ç¤ºä¾‹ï¼š
- "0 0 9 * * ?"     ï¼šæ¯å¤©ä¸Šåˆ9ç‚¹
- "0 */15 * * * ?"  ï¼šæ¯15åˆ†é’Ÿ
- "0 0 */2 * * ?"   ï¼šæ¯2å°æ—¶
- "0 0 0 * * MON"   ï¼šæ¯å‘¨ä¸€åˆå¤œ
```

### 3.2 æŸ¥è¯¢è¾“å…¥é…ç½®


**åŸºç¡€æŸ¥è¯¢é…ç½®**ï¼š
```javascript
{
  "input": {
    "search": {
      "request": {
        "search_type": "query_then_fetch",
        "indices": ["logs-*"],
        "body": {
          "size": 0,
          "query": {
            "bool": {
              "must": [
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"  // æŸ¥è¯¢æœ€è¿‘5åˆ†é’Ÿçš„æ•°æ®
                    }
                  }
                },
                {
                  "term": {
                    "level": "ERROR"  // åªæŸ¥è¯¢é”™è¯¯çº§åˆ«æ—¥å¿—
                  }
                }
              ]
            }
          },
          "aggs": {
            "error_count": {
              "cardinality": {
                "field": "message.keyword"
              }
            }
          }
        }
      }
    }
  }
}
```

**æŸ¥è¯¢å‚æ•°è¯´æ˜**ï¼š
- ğŸ”¸ **indices**ï¼šæŒ‡å®šè¦æŸ¥è¯¢çš„ç´¢å¼•æ¨¡å¼
- ğŸ”¸ **size: 0**ï¼šä¸è¿”å›å…·ä½“æ–‡æ¡£ï¼Œåªè¦èšåˆç»“æœ
- ğŸ”¸ **query**ï¼šå®šä¹‰æŸ¥è¯¢æ¡ä»¶
- ğŸ”¸ **aggs**ï¼šå®šä¹‰èšåˆç»Ÿè®¡

---

## 4. ğŸ“Š é˜ˆå€¼è§„åˆ™å®šä¹‰


### 4.1 é™æ€é˜ˆå€¼è®¾ç½®


**é”™è¯¯æ•°é‡å‘Šè­¦**ï¼š
```javascript
{
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gte": 10  // é”™è¯¯æ•°é‡è¶…è¿‡10æ¡
      }
    }
  },
  "actions": {
    "send_email": {
      "email": {
        "to": ["admin@company.com"],
        "subject": "ç³»ç»Ÿé”™è¯¯å‘Šè­¦",
        "body": "æ£€æµ‹åˆ°ç³»ç»Ÿé”™è¯¯æ•°é‡å¼‚å¸¸ï¼š{{ctx.payload.hits.total}}æ¡"
      }
    }
  }
}
```

**å“åº”æ—¶é—´å‘Šè­¦**ï¼š
```javascript
{
  "input": {
    "search": {
      "request": {
        "indices": ["performance-*"],
        "body": {
          "query": {
            "range": {
              "@timestamp": {
                "gte": "now-10m"
              }
            }
          },
          "aggs": {
            "avg_response_time": {
              "avg": {
                "field": "response_time"
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.aggregations.avg_response_time.value": {
        "gt": 1000  // å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ç§’
      }
    }
  }
}
```

### 4.2 åŠ¨æ€é˜ˆå€¼è®¾ç½®


**åŸºäºå†å²æ•°æ®çš„åŠ¨æ€é˜ˆå€¼**ï¼š
```javascript
{
  "input": {
    "chain": {
      "inputs": [
        {
          "current": {
            "search": {
              "request": {
                "indices": ["metrics-*"],
                "body": {
                  "query": {
                    "range": {
                      "@timestamp": {
                        "gte": "now-5m"
                      }
                    }
                  },
                  "aggs": {
                    "current_avg": {
                      "avg": {
                        "field": "cpu_usage"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        {
          "historical": {
            "search": {
              "request": {
                "indices": ["metrics-*"],
                "body": {
                  "query": {
                    "range": {
                      "@timestamp": {
                        "gte": "now-7d",
                        "lt": "now-5m"
                      }
                    }
                  },
                  "aggs": {
                    "historical_avg": {
                      "avg": {
                        "field": "cpu_usage"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      ]
    }
  },
  "condition": {
    "script": {
      "source": """
        def current = ctx.payload.current.aggregations.current_avg.value;
        def historical = ctx.payload.historical.aggregations.historical_avg.value;
        // å½“å‰å€¼æ¯”å†å²å¹³å‡å€¼é«˜50%æ—¶å‘Šè­¦
        return current > historical * 1.5;
      """
    }
  }
}
```

---

## 5. â° æ—¶é—´çª—å£é…ç½®


### 5.1 æ»‘åŠ¨æ—¶é—´çª—å£


**æ¦‚å¿µè§£é‡Š**ï¼š
```
æ»‘åŠ¨çª—å£å°±åƒä¸€ä¸ªç§»åŠ¨çš„"æ—¶é—´é•œå¤´"

å›ºå®šçª—å£ï¼ˆæ¯å°æ—¶ç»Ÿè®¡ï¼‰ï¼š
09:00-10:00 | 10:00-11:00 | 11:00-12:00
     çª—å£1   |     çª—å£2   |     çª—å£3

æ»‘åŠ¨çª—å£ï¼ˆè¿‡å»1å°æ—¶çš„æ•°æ®ï¼‰ï¼š
09:15çš„çª—å£ï¼š08:15-09:15
09:30çš„çª—å£ï¼š08:30-09:30  
09:45çš„çª—å£ï¼š08:45-09:45
```

**å®é™…é…ç½®ç¤ºä¾‹**ï¼š
```javascript
{
  "input": {
    "search": {
      "request": {
        "body": {
          "query": {
            "range": {
              "@timestamp": {
                "gte": "now-15m",  // 15åˆ†é’Ÿæ»‘åŠ¨çª—å£
                "lte": "now"
              }
            }
          }
        }
      }
    }
  }
}

æ—¶é—´çª—å£é€‰æ‹©å»ºè®®ï¼š
- çŸ­æœŸå‘Šè­¦ï¼š5-15åˆ†é’Ÿï¼ˆå¿«é€Ÿå“åº”ï¼‰
- ä¸­æœŸè¶‹åŠ¿ï¼š30åˆ†é’Ÿ-2å°æ—¶ï¼ˆé¿å…çŸ­æœŸæ³¢åŠ¨ï¼‰
- é•¿æœŸåˆ†æï¼š4å°æ—¶-1å¤©ï¼ˆå‘ç°æ•´ä½“è¶‹åŠ¿ï¼‰
```

### 5.2 ä¸šåŠ¡æ—¶é—´çª—å£


**å·¥ä½œæ—¶é—´ç›‘æ§**ï¼š
```javascript
{
  "condition": {
    "script": {
      "source": """
        // è·å–å½“å‰æ—¶é—´
        def now = ctx.execution_time;
        def hour = now.getHourOfDay();
        def dayOfWeek = now.getDayOfWeek();
        
        // åªåœ¨å·¥ä½œæ—¥çš„å·¥ä½œæ—¶é—´è¿›è¡Œä¸¥æ ¼ç›‘æ§
        boolean isWorkingHours = (dayOfWeek >= 1 && dayOfWeek <= 5) && 
                                (hour >= 9 && hour <= 18);
        
        def errorCount = ctx.payload.hits.total;
        
        if (isWorkingHours) {
          return errorCount > 5;  // å·¥ä½œæ—¶é—´ï¼šä¸¥æ ¼æ ‡å‡†
        } else {
          return errorCount > 20; // éå·¥ä½œæ—¶é—´ï¼šå®½æ¾æ ‡å‡†
        }
      """
    }
  }
}
```

---

## 6. ğŸ”„ å‘Šè­¦é¢‘ç‡æ§åˆ¶


### 6.1 å‘Šè­¦æŠ‘åˆ¶é…ç½®


**é¿å…å‘Šè­¦è½°ç‚¸**ï¼š
```javascript
{
  "throttle_period": "15m",  // 15åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªå‘é€ä¸€æ¬¡
  "actions": {
    "send_email": {
      "throttle_period": "1h",  // é‚®ä»¶å‘Šè­¦1å°æ—¶é™åˆ¶ä¸€æ¬¡
      "email": {
        "to": ["admin@company.com"],
        "subject": "ç³»ç»Ÿå‘Šè­¦",
        "body": "æ£€æµ‹åˆ°ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·åŠæ—¶å¤„ç†"
      }
    },
    "send_slack": {
      "throttle_period": "5m",   // Slacké€šçŸ¥5åˆ†é’Ÿé™åˆ¶ä¸€æ¬¡
      "slack": {
        "message": {
          "to": ["#alerts"],
          "text": "ğŸš¨ ç³»ç»Ÿå‘Šè­¦ï¼š{{ctx.watch_id}}"
        }
      }
    }
  }
}
```

### 6.2 å‘Šè­¦å‡çº§æœºåˆ¶


**åˆ†çº§å‘Šè­¦ç­–ç•¥**ï¼š
```javascript
{
  "condition": {
    "script": {
      "source": """
        def errorCount = ctx.payload.hits.total;
        
        // è®¾ç½®å‘Šè­¦çº§åˆ«
        if (errorCount > 100) {
          ctx.vars.alert_level = 'critical';
          ctx.vars.recipients = ['admin@company.com', 'cto@company.com'];
        } else if (errorCount > 50) {
          ctx.vars.alert_level = 'warning';
          ctx.vars.recipients = ['admin@company.com'];
        } else if (errorCount > 10) {
          ctx.vars.alert_level = 'info';
          ctx.vars.recipients = ['monitor@company.com'];
        }
        
        return errorCount > 10;
      """
    }
  },
  "actions": {
    "send_email": {
      "email": {
        "to": "{{ctx.vars.recipients}}",
        "subject": "{{ctx.vars.alert_level}}çº§åˆ«å‘Šè­¦",
        "body": """
          å‘Šè­¦çº§åˆ«ï¼š{{ctx.vars.alert_level}}
          é”™è¯¯æ•°é‡ï¼š{{ctx.payload.hits.total}}
          å‘ç”Ÿæ—¶é—´ï¼š{{ctx.execution_time}}
        """
      }
    }
  }
}
```

---

## 7. ğŸ“ˆ å‘Šè­¦çŠ¶æ€ç®¡ç†


### 7.1 å‘Šè­¦çŠ¶æ€è·Ÿè¸ª


**çŠ¶æ€å®šä¹‰**ï¼š
```
å‘Šè­¦ç”Ÿå‘½å‘¨æœŸï¼š

è§¦å‘ â†’ æ¿€æ´» â†’ ç¡®è®¤ â†’ å¤„ç†ä¸­ â†’ è§£å†³ â†’ å…³é—­
  â†“      â†“      â†“        â†“       â†“      â†“
å‘ç°é—®é¢˜ å¼€å§‹å‘Šè­¦ äººå·¥ç¡®è®¤  æ­£åœ¨ä¿®å¤  é—®é¢˜è§£å†³ å‘Šè­¦ç»“æŸ

æ¯ä¸ªçŠ¶æ€çš„å«ä¹‰ï¼š
- è§¦å‘ï¼šæ»¡è¶³å‘Šè­¦æ¡ä»¶
- æ¿€æ´»ï¼šå¼€å§‹å‘é€é€šçŸ¥
- ç¡®è®¤ï¼šç›¸å…³äººå‘˜å·²çŸ¥æ™“
- å¤„ç†ä¸­ï¼šæ­£åœ¨è§£å†³é—®é¢˜
- è§£å†³ï¼šé—®é¢˜å·²ä¿®å¤
- å…³é—­ï¼šå‘Šè­¦å‘¨æœŸç»“æŸ
```

**çŠ¶æ€è®°å½•é…ç½®**ï¼š
```javascript
{
  "actions": {
    "index_alert": {
      "index": {
        "index": "watcher-alerts",
        "doc_type": "alert",
        "body": {
          "alert_id": "{{ctx.watch_id}}-{{ctx.execution_time}}",
          "watch_id": "{{ctx.watch_id}}",
          "execution_time": "{{ctx.execution_time}}",
          "alert_level": "{{ctx.vars.alert_level}}",
          "error_count": "{{ctx.payload.hits.total}}",
          "status": "triggered",  // åˆå§‹çŠ¶æ€ä¸ºè§¦å‘
          "acknowledged": false,
          "resolved": false
        }
      }
    }
  }
}
```

### 7.2 å‘Šè­¦æ¢å¤æ£€æµ‹


**æ¢å¤æ¡ä»¶é…ç½®**ï¼š
```javascript
{
  "input": {
    "search": {
      "request": {
        "indices": ["logs-*"],
        "body": {
          "query": {
            "range": {
              "@timestamp": {
                "gte": "now-5m"
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "script": {
      "source": """
        def errorCount = ctx.payload.hits.total;
        
        // æ£€æŸ¥æ˜¯å¦æ¢å¤æ­£å¸¸
        if (errorCount < 5) {
          ctx.vars.alert_type = 'recovery';
          ctx.vars.message = 'ç³»ç»Ÿå·²æ¢å¤æ­£å¸¸';
          return true;
        }
        
        return false;
      """
    }
  },
  "actions": {
    "send_recovery_email": {
      "email": {
        "to": ["admin@company.com"],
        "subject": "ç³»ç»Ÿæ¢å¤é€šçŸ¥",
        "body": "ç³»ç»Ÿå‘Šè­¦å·²æ¢å¤ï¼Œå½“å‰é”™è¯¯æ•°é‡ï¼š{{ctx.payload.hits.total}}"
      }
    }
  }
}
```

---

## 8. ğŸ§ª è§„åˆ™æµ‹è¯•éªŒè¯


### 8.1 æ¨¡æ‹Ÿæµ‹è¯•


**åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•**ï¼š
```javascript
// 1. åˆ›å»ºæµ‹è¯•æ•°æ®
PUT /test-logs/_doc/1
{
  "@timestamp": "now",
  "level": "ERROR",
  "message": "æµ‹è¯•é”™è¯¯ä¿¡æ¯",
  "service": "test-service"
}

// 2. æ‰‹åŠ¨æ‰§è¡ŒWatchæµ‹è¯•
POST _watcher/watch/test-watch/_execute
{
  "trigger_data": {
    "triggered_time": "now"
  },
  "alternative_input": {
    "search": {
      "request": {
        "indices": ["test-logs"],
        "body": {
          "query": {
            "match_all": {}
          }
        }
      }
    }
  }
}
```

### 8.2 æµ‹è¯•æœ€ä½³å®è·µ


**æ¸è¿›å¼æµ‹è¯•æ–¹æ³•**ï¼š

```
ç¬¬ä¸€æ­¥ï¼šæ•°æ®éªŒè¯
â”œâ”€â”€ ç¡®è®¤æŸ¥è¯¢è¿”å›é¢„æœŸæ•°æ®
â”œâ”€â”€ æ£€æŸ¥èšåˆç»“æœæ­£ç¡®æ€§
â””â”€â”€ éªŒè¯æ—¶é—´èŒƒå›´å‡†ç¡®æ€§

ç¬¬äºŒæ­¥ï¼šæ¡ä»¶æµ‹è¯•  
â”œâ”€â”€ æµ‹è¯•å„ç§è¾¹ç•Œå€¼
â”œâ”€â”€ éªŒè¯é€»è¾‘è¡¨è¾¾å¼
â””â”€â”€ ç¡®è®¤å˜é‡è®¡ç®—æ­£ç¡®

ç¬¬ä¸‰æ­¥ï¼šåŠ¨ä½œæµ‹è¯•
â”œâ”€â”€ æµ‹è¯•é‚®ä»¶å‘é€åŠŸèƒ½
â”œâ”€â”€ éªŒè¯æ¶ˆæ¯æ ¼å¼æ­£ç¡®
â””â”€â”€ ç¡®è®¤æ”¶ä»¶äººå‡†ç¡®

ç¬¬å››æ­¥ï¼šå®Œæ•´æµç¨‹æµ‹è¯•
â”œâ”€â”€ ç«¯åˆ°ç«¯åŠŸèƒ½éªŒè¯
â”œâ”€â”€ å‹åŠ›æµ‹è¯•å‘Šè­¦é¢‘ç‡
â””â”€â”€ å¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•
```

**æµ‹è¯•æ£€æŸ¥æ¸…å•**ï¼š
- âœ… **æŸ¥è¯¢è¯­æ³•**ï¼šç¡®ä¿æŸ¥è¯¢è¯­å¥æ­£ç¡®æ‰§è¡Œ
- âœ… **æ—¶é—´èŒƒå›´**ï¼šéªŒè¯æ—¶é—´çª—å£è®¾ç½®åˆç†
- âœ… **æ¡ä»¶é€»è¾‘**ï¼šæµ‹è¯•å„ç§ä¸´ç•Œå€¼æƒ…å†µ
- âœ… **å‘Šè­¦å†…å®¹**ï¼šç¡®è®¤æ¶ˆæ¯å†…å®¹å‡†ç¡®å®Œæ•´
- âœ… **æ¥æ”¶æ–¹å¼**ï¼šéªŒè¯é€šçŸ¥æ¸ é“æ­£å¸¸å·¥ä½œ
- âœ… **é¢‘ç‡æ§åˆ¶**ï¼šæµ‹è¯•å‘Šè­¦æŠ‘åˆ¶æ˜¯å¦æœ‰æ•ˆ

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Watcheræœ¬è´¨ï¼šè‡ªåŠ¨åŒ–çš„æ•°æ®ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šè§¦å‘å™¨ + æŸ¥è¯¢è¾“å…¥ + æ¡ä»¶åˆ¤æ–­ + å‘Šè­¦åŠ¨ä½œ
ğŸ”¸ æ—¶é—´çª—å£ï¼šæ»‘åŠ¨çª—å£æä¾›è¿ç»­ç›‘æ§èƒ½åŠ›
ğŸ”¸ é˜ˆå€¼è®¾ç½®ï¼šé™æ€é˜ˆå€¼ç®€å•ï¼ŒåŠ¨æ€é˜ˆå€¼æ›´æ™ºèƒ½
ğŸ”¸ é¢‘ç‡æ§åˆ¶ï¼šé¿å…å‘Šè­¦è½°ç‚¸ï¼Œæé«˜å‘Šè­¦è´¨é‡
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šè·Ÿè¸ªå‘Šè­¦ç”Ÿå‘½å‘¨æœŸï¼Œä¾¿äºé—®é¢˜è·Ÿè¸ª
```

### 9.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ è§¦å‘å™¨é…ç½®åŸåˆ™**ï¼š
```
æ£€æŸ¥é¢‘ç‡é€‰æ‹©ï¼š
- ç´§æ€¥åœºæ™¯ï¼š1-5åˆ†é’Ÿï¼ˆèµ„æºæ¶ˆè€—å‘Šè­¦ï¼‰
- ä¸€èˆ¬åœºæ™¯ï¼š5-15åˆ†é’Ÿï¼ˆä¸šåŠ¡æŒ‡æ ‡ç›‘æ§ï¼‰  
- è¶‹åŠ¿åˆ†æï¼š30åˆ†é’Ÿ-1å°æ—¶ï¼ˆé•¿æœŸè¶‹åŠ¿ï¼‰

æ—¶é—´é€‰æ‹©è€ƒè™‘ï¼š
- ä¸šåŠ¡ç‰¹ç‚¹ï¼šé«˜å³°æœŸæ›´é¢‘ç¹æ£€æŸ¥
- ç³»ç»Ÿè´Ÿè½½ï¼šé¿å…ç»™ESé€ æˆè¿‡å¤§å‹åŠ›
- å‘Šè­¦éœ€æ±‚ï¼šç´§æ€¥ç¨‹åº¦å†³å®šæ£€æŸ¥é¢‘ç‡
```

**ğŸ”¹ æ¡ä»¶è®¾ç½®æŠ€å·§**ï¼š
```
é˜ˆå€¼è®¾å®šç­–ç•¥ï¼š
- ä»å®½æ¾å¼€å§‹ï¼šå…ˆè®¾ç½®è¾ƒå®½æ¾çš„é˜ˆå€¼
- é€æ­¥æ”¶ç´§ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
- åˆ†çº§è®¾ç½®ï¼šä¸åŒçº§åˆ«é‡‡ç”¨ä¸åŒæ ‡å‡†
- åŠ¨æ€è°ƒæ•´ï¼šç»“åˆå†å²æ•°æ®è‡ªåŠ¨ä¼˜åŒ–
```

**ğŸ”¹ å‘Šè­¦è´¨é‡ä¿è¯**ï¼š
```
å‡å°‘è¯¯æŠ¥ï¼š
- åˆç†çš„æ—¶é—´çª—å£é¿å…å¶å‘æ³¢åŠ¨
- å¤šæ¡ä»¶ç»„åˆæé«˜åˆ¤æ–­å‡†ç¡®æ€§
- å†å²æ•°æ®å¯¹æ¯”è¯†åˆ«çœŸæ­£å¼‚å¸¸

æé«˜å“åº”ï¼š
- æ¸…æ™°çš„å‘Šè­¦å†…å®¹ä¾¿äºå¿«é€Ÿå®šä½
- åˆ†çº§é€šçŸ¥ç¡®ä¿é‡è¦å‘Šè­¦åŠæ—¶å¤„ç†
- æ¢å¤é€šçŸ¥è®©å›¢é˜Ÿäº†è§£é—®é¢˜çŠ¶æ€
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯**ï¼š
- **ç³»ç»Ÿç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
- **ä¸šåŠ¡ç›‘æ§**ï¼šè®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ã€ç”¨æˆ·æ´»è·ƒåº¦
- **å®‰å…¨ç›‘æ§**ï¼šç™»å½•å¤±è´¥ã€å¼‚å¸¸è®¿é—®ã€æƒé™å˜æ›´
- **æ€§èƒ½ç›‘æ§**ï¼šå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡

**ğŸ”§ é…ç½®å»ºè®®**ï¼š
- **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨è¾ƒå®½æ¾çš„é˜ˆå€¼ï¼Œé‡ç‚¹éªŒè¯åŠŸèƒ½
- **æµ‹è¯•é˜¶æ®µ**ï¼šæ¨¡æ‹Ÿå„ç§åœºæ™¯ï¼Œå®Œå–„å‘Šè­¦é€»è¾‘
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´ï¼ŒæŒç»­ä¼˜åŒ–

**ğŸ“Š ç›‘æ§ç­–ç•¥**ï¼š
- **åˆ†å±‚ç›‘æ§**ï¼šç³»ç»Ÿå±‚ + åº”ç”¨å±‚ + ä¸šåŠ¡å±‚
- **å…¨é¢è¦†ç›–**ï¼šå…³é”®æŒ‡æ ‡ä¸é—æ¼ï¼Œé¿å…ç›‘æ§ç›²ç‚¹
- **å¹³è¡¡å…¼é¡¾**ï¼šå‘Šè­¦å®Œæ•´æ€§ä¸è¿ç»´è´Ÿæ‹…çš„å¹³è¡¡

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Watcherç›‘æ§å¾ˆæ™ºèƒ½ï¼Œå®šæ—¶æŸ¥è¯¢åˆ¤æ¡ä»¶
- é˜ˆå€¼è®¾ç½®è¦åˆç†ï¼Œå‘Šè­¦é¢‘ç‡éœ€æ§åˆ¶  
- æµ‹è¯•éªŒè¯ä¸å¯å°‘ï¼ŒæŒç»­ä¼˜åŒ–ä¿è´¨é‡
- åˆ†çº§é€šçŸ¥è´£ä»»æ¸…ï¼Œé—®é¢˜è§£å†³æœ‰è·Ÿè¸ª