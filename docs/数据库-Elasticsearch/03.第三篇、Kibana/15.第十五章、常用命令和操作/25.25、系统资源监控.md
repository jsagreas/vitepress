---
title: 25、系统资源监控
---
## 📚 目录


1. [系统监控基础概念](#1-系统监控基础概念)
2. [Kibana服务状态检查](#2-kibana服务状态检查)
3. [内存使用情况监控](#3-内存使用情况监控)
4. [CPU使用率观察](#4-cpu使用率观察)
5. [网络连接状态检查](#5-网络连接状态检查)
6. [磁盘空间使用监控](#6-磁盘空间使用监控)
7. [ES集群健康状态](#7-es集群健康状态)
8. [查询队列状态](#8-查询队列状态)
9. [系统日志分析](#9-系统日志分析)
10. [核心要点总结](#10-核心要点总结)

---

# 🎯 **学习路径导航**


**前置知识**：需要掌握Kibana基础操作、Linux系统命令 → **当前内容**：系统资源监控 → **后续学习**：建议学习性能调优策略

⏱️ **预计学习时间**：本章预计90分钟 | 实践操作60分钟

🎯 **学习目标**
- [ ] 掌握Kibana服务状态检查方法
- [ ] 学会监控系统资源使用情况
- [ ] 理解ES集群健康指标含义
- [ ] 能够分析和排查常见性能问题

---

## 1. 🔍 系统监控基础概念



### 1.1 什么是系统资源监控



**🔸 核心定义**
```
系统监控：实时观察Kibana和相关服务的运行状态
目的：及早发现问题，确保系统稳定运行
监控对象：CPU、内存、磁盘、网络、应用服务
```

**💡 通俗理解**
就像给汽车装了仪表盘：
- **油表**：对应内存使用率
- **水温表**：对应CPU使用率  
- **速度表**：对应查询响应时间
- **故障灯**：对应错误日志提醒

### 1.2 监控的重要性



**🎯 监控价值**
```
🔸 预警功能：问题发生前给出警告
🔸 性能优化：找出系统瓶颈所在
🔸 故障定位：快速找到问题根源
🔸 容量规划：为扩容提供数据依据
🔸 用户体验：确保查询响应速度
```

### 1.3 监控指标体系



| **监控类别** | **关键指标** | **正常范围** | **告警阈值** |
|-------------|-------------|-------------|-------------|
| **🖥️ 系统资源** | CPU使用率 | < 70% | > 85% |
| **💾 内存** | 内存使用率 | < 80% | > 90% |
| **💿 磁盘** | 磁盘使用率 | < 80% | > 90% |
| **🌐 网络** | 连接数量 | < 1000 | > 5000 |
| **⚡ 应用性能** | 响应时间 | < 2秒 | > 5秒 |

---

## 2. 🚀 Kibana服务状态检查



### 2.1 基础服务状态检查



**🔍 检查Kibana是否运行**

使用系统命令检查：
```bash
# 检查Kibana进程

ps aux | grep kibana

# 检查服务状态（systemd）

sudo systemctl status kibana

# 检查端口是否监听

netstat -tlnp | grep 5601
```

**💡 解读结果**
- **进程存在**：说明Kibana服务正在运行
- **状态为active**：服务正常启动
- **端口5601监听**：可以接受外部连接

### 2.2 Kibana健康检查API



**🌐 使用API检查服务状态**

访问健康检查端点：
```bash
# 基础健康检查

curl -X GET "localhost:5601/api/status"

# 详细状态信息

curl -X GET "localhost:5601/api/stats"
```

**📊 状态信息解读**
```json
{
  "status": {
    "overall": {
      "state": "green",     // 绿色=正常，黄色=警告，红色=错误
      "title": "Green",
      "nickname": "Looking good"
    }
  }
}
```

### 2.3 Web界面状态检查



**🖥️ 通过浏览器检查**

访问管理界面路径：
- **主页访问**：`http://localhost:5601`
- **状态页面**：`http://localhost:5601/status`
- **监控页面**：Stack Monitoring（如果已配置）

**⚠️ 常见状态问题**
```
连接超时：
- 检查网络连接
- 确认端口配置
- 查看防火墙设置

服务无响应：
- 检查内存是否不足
- 查看错误日志
- 重启服务尝试
```

---

## 3. 💾 内存使用情况监控



### 3.1 系统内存监控



**🔍 查看整体内存使用**

使用系统命令：
```bash
# 查看内存使用概况

free -h

# 持续监控内存变化

watch -n 2 free -h

# 详细内存信息

cat /proc/meminfo | head -10
```

**📊 内存使用解读**
```
              total        used        free      shared  buff/cache   available
Mem:           15Gi       8.2Gi       1.2Gi       145Mi       6.1Gi       6.8Gi

关键指标说明：
- total：总内存容量
- used：已使用内存（包括应用程序）
- available：实际可用内存（考虑了缓存可释放部分）
- buff/cache：系统缓存（可以释放给应用使用）
```

### 3.2 Kibana进程内存监控



**🎯 专门监控Kibana内存使用**

查看Kibana进程资源使用：
```bash
# 找到Kibana进程ID

pgrep -f kibana

# 查看指定进程内存使用

ps -p <kibana_pid> -o pid,ppid,cmd,%mem,%cpu --sort=-%mem

# 实时监控进程资源

top -p <kibana_pid>
```

### 3.3 Node.js内存监控



**⚡ Kibana内部内存状态**

通过API获取Node.js内存信息：
```bash
# 获取进程内存统计

curl -X GET "localhost:5601/api/stats" | jq '.process.memory'
```

**🔧 内存优化建议**
```
内存不足症状：
• 响应变慢
• 页面加载失败
• 服务经常重启

优化措施：
• 增加Node.js内存限制
• 优化仪表板复杂度
• 减少同时打开的标签页
• 定期清理浏览器缓存
```

---

## 4. ⚡ CPU使用率观察



### 4.1 系统CPU监控



**📊 整体CPU使用情况**

实时CPU监控命令：
```bash
# 实时查看CPU使用率

htop

# 简单的CPU使用率查看

top

# 查看CPU平均负载

uptime

# 详细CPU信息

lscpu
```

**💡 CPU指标解读**
```
load average: 0.45, 0.52, 0.48
               1分钟  5分钟  15分钟平均负载

负载评估标准：
- < 0.7：轻负载
- 0.7-1.0：中等负载  
- > 1.0：高负载（需要关注）
- > 2.0：严重负载（需要优化）
```

### 4.2 Kibana进程CPU使用



**🎯 监控Kibana CPU消耗**

专门查看Kibana进程：
```bash
# 查看Kibana进程CPU使用率

ps aux | grep kibana | grep -v grep

# 持续监控CPU使用变化

watch -n 2 "ps aux | grep kibana | grep -v grep"

# 使用pidstat监控（需要安装sysstat）

pidstat -p <kibana_pid> 2
```

### 4.3 CPU性能分析



**🔍 CPU瓶颈识别**

| **CPU使用率** | **系统状态** | **建议措施** |
|--------------|-------------|-------------|
| **< 30%** | 正常运行 | 无需处理 |
| **30-70%** | 中等负载 | 监控观察 |
| **70-90%** | 高负载 | 检查查询复杂度 |
| **> 90%** | 严重负载 | 立即优化或扩容 |

**⚠️ 高CPU使用原因分析**
```
常见原因：
• 复杂的聚合查询
• 大量并发用户访问
• 仪表板刷新频率过高
• 数据索引过程

解决方案：
• 优化查询语句
• 设置合理的刷新间隔
• 增加硬件资源
• 使用查询缓存
```

---

## 5. 🌐 网络连接状态检查



### 5.1 网络连接监控



**🔍 查看网络连接状态**

监控网络连接：
```bash
# 查看所有网络连接

netstat -tulnp

# 查看Kibana相关连接

netstat -tulnp | grep 5601

# 查看TCP连接统计

ss -s

# 监控网络流量

iftop  # 需要安装
```

### 5.2 连接质量检查



**📡 网络连通性测试**

测试网络连接：
```bash
# 测试到Elasticsearch的连接

curl -X GET "localhost:9200/_cluster/health"

# 测试Kibana API响应

curl -w "@curl-format.txt" -X GET "localhost:5601/api/status"

# ping测试延迟

ping -c 4 elasticsearch-server
```

**📋 创建curl测试模板**
```bash
# 创建curl-format.txt文件

cat > curl-format.txt << EOF
     time_namelookup:  %{time_namelookup}\n
        time_connect:  %{time_connect}\n
     time_appconnect:  %{time_appconnect}\n
    time_pretransfer:  %{time_pretransfer}\n
       time_redirect:  %{time_redirect}\n
  time_starttransfer:  %{time_starttransfer}\n
                     ----------\n
          time_total:  %{time_total}\n
EOF
```

### 5.3 防火墙和安全检查



**🛡️ 网络安全配置检查**

检查防火墙设置：
```bash
# 检查防火墙状态

sudo ufw status

# 检查iptables规则

sudo iptables -L

# 检查开放端口

sudo nmap -p 5601,9200 localhost
```

---

## 6. 💿 磁盘空间使用监控



### 6.1 磁盘空间检查



**📊 整体磁盘使用情况**

查看磁盘使用：
```bash
# 查看磁盘使用概况

df -h

# 查看inode使用情况

df -i

# 查看目录大小

du -sh /path/to/kibana

# 找出大文件

find /var/log -type f -size +100M
```

### 6.2 Kibana相关目录监控



**🎯 重点监控目录**

| **目录路径** | **作用** | **监控重点** |
|-------------|---------|-------------|
| `/var/log/kibana/` | 日志文件 | 日志轮转是否正常 |
| `/usr/share/kibana/` | 程序文件 | 占用空间变化 |
| `/etc/kibana/` | 配置文件 | 配置备份 |
| `/tmp/` | 临时文件 | 临时文件清理 |

监控这些目录：
```bash
# 监控关键目录大小

watch -n 10 "du -sh /var/log/kibana/ /usr/share/kibana/"

# 检查日志文件大小

ls -lh /var/log/kibana/

# 清理老旧日志（谨慎操作）

find /var/log/kibana/ -name "*.log" -mtime +7 -delete
```

### 6.3 磁盘性能监控



**⚡ 磁盘I/O性能检查**

监控磁盘I/O：
```bash
# 查看磁盘I/O统计

iostat -x 2

# 监控磁盘使用率

iotop

# 查看磁盘读写速度

hdparm -tT /dev/sda
```

---

## 7. 🔗 ES集群健康状态



### 7.1 集群整体健康检查



**🌡️ 集群健康状态API**

基础健康检查：
```bash
# 快速健康检查

curl -X GET "localhost:9200/_cluster/health?pretty"

# 详细健康信息

curl -X GET "localhost:9200/_cluster/health?level=indices&pretty"
```

**📊 健康状态解读**
```json
{
  "cluster_name": "elasticsearch",
  "status": "green",                    // 绿色=健康，黄色=警告，红色=错误
  "timed_out": false,
  "number_of_nodes": 3,                // 节点数量
  "number_of_data_nodes": 3,           // 数据节点数量
  "active_primary_shards": 15,         // 活跃主分片
  "active_shards": 30,                 // 活跃分片总数
  "relocating_shards": 0,              // 正在迁移的分片
  "initializing_shards": 0,            // 正在初始化的分片
  "unassigned_shards": 0               // 未分配的分片
}
```

### 7.2 节点状态监控



**🖥️ 查看集群节点信息**

节点详细信息：
```bash
# 查看所有节点

curl -X GET "localhost:9200/_cat/nodes?v"

# 查看节点统计信息

curl -X GET "localhost:9200/_nodes/stats?pretty"

# 查看节点磁盘使用

curl -X GET "localhost:9200/_cat/allocation?v"
```

### 7.3 索引健康状态



**📋 索引级别监控**

索引状态检查：
```bash
# 查看所有索引状态

curl -X GET "localhost:9200/_cat/indices?v"

# 查看分片分布

curl -X GET "localhost:9200/_cat/shards?v"

# 查看索引设置

curl -X GET "localhost:9200/your-index/_settings?pretty"
```

**⚠️ 常见集群问题**
```
黄色状态原因：
• 副本分片未分配
• 节点数量不足
• 磁盘空间不足

红色状态原因：
• 主分片丢失
• 节点宕机
• 网络分区问题

解决建议：
• 增加节点数量
• 释放磁盘空间
• 检查网络连接
• 重启有问题的节点
```

---

## 8. 📊 查询队列状态



### 8.1 查询性能监控



**⚡ 查询执行统计**

监控查询性能：
```bash
# 查看搜索统计

curl -X GET "localhost:9200/_stats/search?pretty"

# 查看慢查询日志

curl -X GET "localhost:9200/_cat/thread_pool/search?v"

# 监控查询队列

curl -X GET "localhost:9200/_cat/thread_pool?v"
```

### 8.2 Kibana查询监控



**🎯 在Kibana中监控查询**

通过Dev Tools查看：
```json
// 查看正在执行的任务
GET _tasks?detailed=true&actions=*search*

// 查看搜索统计
GET _stats/search

// 查看慢查询
GET _cluster/settings
```

### 8.3 查询队列优化



**🔧 队列管理建议**

| **队列类型** | **默认大小** | **建议值** | **调整方法** |
|-------------|-------------|-----------|-------------|
| **search** | 1000 | 1000-5000 | 根据并发需求调整 |
| **index** | 200 | 200-1000 | 根据写入频率调整 |
| **bulk** | 200 | 200-1000 | 根据批量操作调整 |

**📈 性能优化策略**
```
查询优化：
• 使用filter替代query
• 合理设置size参数
• 避免深度分页
• 使用缓存机制

索引优化：
• 合理设置refresh_interval
• 使用bulk批量操作
• 优化mapping设计
• 定期合并segment
```

---

## 9. 📝 系统日志分析



### 9.1 Kibana日志文件



**📋 日志文件位置**

主要日志文件：
```bash
# Kibana主日志

tail -f /var/log/kibana/kibana.log

# 系统服务日志

journalctl -u kibana -f

# 错误日志过滤

grep ERROR /var/log/kibana/kibana.log

# 警告日志查看

grep WARN /var/log/kibana/kibana.log
```

### 9.2 常见日志分析



**🔍 日志级别说明**

| **日志级别** | **含义** | **关注程度** | **处理建议** |
|-------------|---------|-------------|-------------|
| **ERROR** | 错误信息 | 🔴 高 | 立即处理 |
| **WARN** | 警告信息 | 🟡 中 | 定期检查 |
| **INFO** | 一般信息 | 🟢 低 | 了解即可 |
| **DEBUG** | 调试信息 | ⚪ 极低 | 开发调试用 |

### 9.3 日志轮转管理



**🔄 日志轮转配置**

配置日志轮转防止磁盘占满：
```bash
# 创建logrotate配置

sudo vim /etc/logrotate.d/kibana

# 配置内容示例

/var/log/kibana/*.log {
    daily                # 每天轮转
    missingok           # 文件不存在不报错
    rotate 52           # 保留52个文件
    compress            # 压缩旧文件
    notifempty          # 空文件不轮转
    create 644 kibana kibana  # 创建新文件权限
    postrotate          # 轮转后执行
        systemctl reload kibana > /dev/null 2>&1 || true
    endscript
}
```

**🧹 手动清理日志**
```bash
# 查看日志文件大小

ls -lh /var/log/kibana/

# 清理超过7天的日志

find /var/log/kibana/ -name "*.log" -mtime +7 -delete

# 压缩大日志文件

gzip /var/log/kibana/kibana.log.1
```

---

## 10. 📋 核心要点总结



### 10.1 必须掌握的核心概念



```
🔸 系统监控本质：实时观察Kibana运行状态，预防问题发生
🔸 关键监控指标：CPU、内存、磁盘、网络、ES集群健康
🔸 服务状态检查：进程、端口、API响应、Web界面访问
🔸 性能瓶颈识别：资源使用超过阈值时的分析和处理
🔸 日志分析重要性：通过日志快速定位和解决问题
```

### 10.2 关键理解要点



**🔹 为什么要做系统监控**
```
预防胜于治疗：
• 提前发现潜在问题
• 避免服务突然中断
• 提升用户使用体验
• 为系统优化提供数据

监控的价值：
• 保障业务连续性
• 提高运维效率
• 降低故障影响
• 支持容量规划
```

**🔹 监控数据的含义**
```
CPU使用率：
• 70%以下：正常运行
• 70-90%：需要关注
• 90%以上：紧急处理

内存使用率：
• 80%以下：健康状态
• 80-90%：密切监控
• 90%以上：扩容或优化

磁盘使用率：
• 80%以下：充足空间
• 80-90%：计划扩容
• 90%以上：立即清理
```

### 10.3 实际应用价值



**🎯 日常运维应用**
- **健康检查**：定期检查系统各项指标
- **问题诊断**：根据监控数据快速定位问题
- **性能优化**：基于监控结果调整系统配置
- **容量规划**：根据趋势预测资源需求

**🛠️ 最佳实践建议**
```
监控策略：
• 设置合理的告警阈值
• 建立监控检查清单
• 定期分析监控趋势
• 保持监控数据历史记录

故障处理：
• 建立应急响应流程
• 记录常见问题解决方案
• 定期演练故障恢复
• 持续优化监控策略
```

### 10.4 学习检查清单



- [ ] 能够检查Kibana服务运行状态
- [ ] 会监控系统资源使用情况
- [ ] 理解ES集群健康指标含义
- [ ] 掌握查询性能监控方法
- [ ] 能分析系统日志发现问题
- [ ] 会配置基础的告警机制

**💡 故障排查思路**
```
遇到问题时的检查顺序：
1. 检查服务是否运行
2. 查看系统资源使用
3. 检查网络连接状态
4. 查看ES集群健康
5. 分析相关日志信息
6. 根据发现采取措施
```

**🔑 核心记忆要点**
> 监控如体检，预防胜治疗
> CPU内存要关注，磁盘网络别忽略
> ES集群是根本，查询队列看性能
> 日志分析找问题，及时处理保稳定

**🚀 进阶学习建议**
- 学习Prometheus+Grafana监控方案
- 了解ELK Stack监控最佳实践
- 研究自动化告警和故障恢复
- 掌握性能调优的高级技巧