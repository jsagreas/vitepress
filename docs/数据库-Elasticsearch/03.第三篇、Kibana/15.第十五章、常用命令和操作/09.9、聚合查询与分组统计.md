---
title: 9、聚合查询与分组统计
---
## 📚 目录

1. [聚合查询基础概念](#1-聚合查询基础概念)
2. [Metrics聚合配置详解](#2-Metrics聚合配置详解)
3. [常用聚合类型实战](#3-常用聚合类型实战)
4. [分组统计与Bucket聚合](#4-分组统计与Bucket聚合)
5. [高级聚合应用场景](#5-高级聚合应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 聚合查询基础概念


### 1.1 什么是聚合查询


**📖 通俗理解**：
聚合查询就像是给一堆数据做"统计分析"。想象你有一本学生成绩册，聚合查询能帮你：
- **统计总人数**（Count）
- **计算平均分**（Average）  
- **找出最高分**（Max）
- **按班级分组统计**（Terms聚合）

```
🎓 现实类比：
Excel表格中的统计函数 = Kibana中的聚合查询
SUM()函数 → Sum聚合
AVERAGE()函数 → Average聚合  
COUNT()函数 → Count聚合
透视表 → Terms聚合分组
```

### 1.2 聚合查询的核心价值


**🎯 解决的问题**：
```
❓ 原始问题：海量日志数据，人工分析困难
✅ 聚合解决：自动统计分析，秒出结果

具体应用：
• 网站访问量统计 → Count聚合
• 服务响应时间分析 → Average聚合  
• 错误率监控 → 条件统计
• 用户行为分析 → 多维度分组
```

### 1.3 聚合查询的两大类型


**📊 聚合分类框架**：
```
Kibana聚合类型
├── Metrics聚合（度量聚合）
│   ├── Count（计数）
│   ├── Average（平均值）
│   ├── Sum（求和）
│   ├── Min/Max（极值）
│   └── Percentiles（百分位）
└── Bucket聚合（分桶聚合）
    ├── Terms（词条分组）
    ├── Date Histogram（时间分组）
    └── Range（范围分组）
```

**💡 理解要点**：
- **Metrics聚合**：计算数值（像计算器）
- **Bucket聚合**：数据分组（像分类整理）

---

## 2. ⚙️ Metrics聚合配置详解


### 2.1 访问聚合配置界面


**🚀 操作步骤**：
```
第一步：创建可视化
Kibana首页 → Visualize → Create visualization

第二步：选择图表类型  
推荐选择：Vertical Bar（柱状图）或 Data Table（数据表）

第三步：选择索引模式
选择你要分析的数据索引

第四步：配置聚合
左侧面板 → Metrics区域 → Add metric
```

### 2.2 Metrics聚合界面详解


**🔧 界面组成**：
```
Metrics配置区域
├── 聚合类型选择器
│   └── 下拉菜单：Count、Average、Sum等
├── 字段选择器  
│   └── 选择要统计的数据字段
├── 自定义标签
│   └── 给统计结果起个名字
└── 高级设置
    └── 精度、缺失值处理等
```

**💻 具体配置示例**：
```
聚合类型：Average（平均值）
字段：response_time（响应时间字段）
自定义标签：平均响应时间
单位：毫秒
```

---

## 3. 📈 常用聚合类型实战


### 3.1 Count文档计数


**🔍 用途说明**：
Count是最基础的聚合，用来统计文档数量。就像数人头一样简单直接。

**⚡ 应用场景**：
```
📊 网站分析：
• 今天有多少访客？
• 某个页面被访问了多少次？
• 错误日志出现了多少条？

🛒 电商分析：
• 今日订单总数
• 某商品购买次数
• 退款申请数量
```

**🔧 配置方法**：
```
Aggregation：Count
Label：访问总数
Result：显示文档总数（无需选择字段）
```

### 3.2 Average平均值计算


**🔍 用途说明**：
Average聚合计算数值字段的平均值，帮你了解数据的整体水平。

**⚡ 应用场景**：
```
🌐 性能监控：
• 平均响应时间：response_time字段
• 平均CPU使用率：cpu_usage字段  
• 平均内存占用：memory_usage字段

💰 业务分析：
• 平均订单金额：order_amount字段
• 平均客单价：customer_spending字段
• 平均评分：rating字段
```

**🔧 配置方法**：
```
Aggregation：Average
Field：response_time（选择数值类型字段）
Label：平均响应时间
格式：可设置小数位数
```

**💡 实用技巧**：
```
选择字段时注意：
✅ 数值类型字段：可以计算平均值
❌ 文本类型字段：无法计算平均值
❌ 日期类型字段：需要特殊处理
```

### 3.3 Sum求和聚合


**🔍 用途说明**：
Sum聚合将所有文档中指定字段的数值相加，得出总和。

**⚡ 应用场景**：
```
💹 财务统计：
• 总销售额：sum(order_amount)
• 总利润：sum(profit)
• 总成本：sum(cost)

📊 流量统计：
• 总下载量：sum(download_count)
• 总流量消耗：sum(traffic_bytes)
• 总点击数：sum(click_count)
```

**🔧 配置方法**：
```
Aggregation：Sum
Field：order_amount
Label：总销售额
格式：可设置货币符号、千分位分隔符
```

### 3.4 Min/Max极值统计


**🔍 用途说明**：
- **Min**：找出最小值（最快响应时间、最低价格等）
- **Max**：找出最大值（最慢响应时间、最高价格等）

**⚡ 应用场景**：
```
🎯 性能监控：
• 最快响应时间：min(response_time)
• 最慢响应时间：max(response_time)
• 峰值CPU使用率：max(cpu_usage)

💰 价格分析：  
• 最低价格：min(price)
• 最高价格：max(price)
• 最大订单金额：max(order_amount)
```

**🔧 配置方法**：
```
Min聚合：
Aggregation：Min
Field：response_time
Label：最快响应时间

Max聚合：
Aggregation：Max  
Field：response_time
Label：最慢响应时间
```

### 3.5 Unique Count去重计数


**🔍 用途说明**：
Unique Count统计字段中不重复值的数量。比如统计有多少个不同的用户访问了网站。

**⚡ 应用场景**：
```
👥 用户分析：
• 独立访客数：unique_count(user_id)
• 活跃用户数：unique_count(session_id)  
• 不同IP地址数：unique_count(client_ip)

🏷️ 内容分析：
• 不同商品数：unique_count(product_id)
• 涉及页面数：unique_count(page_url)
• 错误类型数：unique_count(error_type)
```

**🔧 配置方法**：
```
Aggregation：Unique Count
Field：user_id
Label：独立用户数
精度：可调整精度阈值（影响性能）
```

**⚠️ 重要提醒**：
```
精度说明：
• 精度越高 → 结果越准确，但性能越慢
• 精度越低 → 性能越好，但可能有误差
• 默认值3000通常够用
```

### 3.6 Percentiles百分位数


**🔍 用途说明**：
百分位数告诉你：有百分之多少的数据小于某个值。比如90%分位数是500ms，意思是90%的请求响应时间都在500ms以内。

**⚡ 应用场景**：
```
🎯 性能分析（最常用）：
• P50（中位数）：50%请求的响应时间
• P90：90%请求的响应时间  
• P95：95%请求的响应时间
• P99：99%请求的响应时间

📊 业务分析：
• 用户停留时长分布
• 订单金额分布
• 文件大小分布
```

**🔧 配置方法**：
```
Aggregation：Percentiles
Field：response_time
Label：响应时间分布
Percentiles：50,90,95,99（可自定义）
```

**💡 理解技巧**：
```
百分位数解读：
P50 = 100ms → 一半用户响应时间≤100ms
P90 = 500ms → 九成用户响应时间≤500ms  
P99 = 2000ms → 99%用户响应时间≤2000ms

为什么P99很重要？
→ 它反映了"最糟糕1%用户"的体验
```

### 3.7 Standard Deviation标准差


**🔍 用途说明**：
标准差衡量数据的离散程度。标准差越大，说明数据变化越不稳定。

**⚡ 应用场景**：
```
📊 稳定性分析：
• 响应时间稳定性：std_dev(response_time)
• 负载均衡效果：std_dev(server_load)
• 数据质量评估：std_dev(sensor_reading)

💹 业务分析：
• 销售波动性：std_dev(daily_sales)
• 用户行为一致性：std_dev(session_duration)
```

**🔧 配置方法**：
```
Aggregation：Standard Deviation
Field：response_time  
Label：响应时间波动性
模式：可选择总体标准差或样本标准差
```

---

## 4. 🗂️ 分组统计与Bucket聚合


### 4.1 Bucket聚合基本概念


**📖 通俗理解**：
Bucket聚合就像给数据"分类装箱"。想象你有一堆水果，可以按颜色分箱、按大小分箱、按种类分箱。

```
🍎 现实类比：
超市商品分类 = Bucket聚合
├── 按品牌分类 → Terms聚合
├── 按价格区间分类 → Range聚合  
└── 按上架时间分类 → Date Histogram聚合
```

### 4.2 Terms聚合分组


**🔍 用途说明**：
Terms聚合按照字段的不同值进行分组，是最常用的分组方式。

**⚡ 应用场景**：
```
🌐 网站分析：
• 按浏览器类型分组：browser.keyword
• 按来源网站分组：referrer.keyword  
• 按页面URL分组：url.keyword

🏢 业务分析：
• 按商品类别分组：category.keyword
• 按用户地区分组：region.keyword
• 按错误类型分组：error_type.keyword
```

**🔧 配置方法**：
```
在Buckets区域：
Aggregation：Terms
Field：browser.keyword（注意选择.keyword字段）
Size：10（显示前10个分组）
Order：Metric - Count（按文档数排序）
Label：浏览器分布
```

**⚠️ 字段选择要点**：
```
正确选择：
✅ text_field.keyword → 用于精确分组
✅ 数值字段 → 可以直接分组

错误选择：  
❌ 纯text字段 → 会被分词，结果混乱
❌ 长文本字段 → 分组无意义
```

### 4.3 Date Histogram时间分组


**🔍 用途说明**：
Date Histogram按时间间隔对数据进行分组，用于分析数据的时间趋势。

**⚡ 应用场景**：
```
📈 趋势分析：
• 每小时访问量趋势
• 每天销售额变化
• 每周错误数统计
• 每月用户增长

🕒 时间模式：
• 找出访问高峰时段
• 分析季节性规律
• 监控异常时间点
```

**🔧 配置方法**：
```
Aggregation：Date Histogram
Field：@timestamp（时间字段）
Interval：1h（时间间隔）
  ├── 1m：每分钟
  ├── 1h：每小时  
  ├── 1d：每天
  └── 1w：每周
Label：时间趋势
```

### 4.4 Range范围分组


**🔍 用途说明**：
Range聚合按数值范围对数据进行分组，适用于分析数据分布。

**⚡ 应用场景**：
```
💰 价格分析：
• 低端：0-100元
• 中端：100-500元  
• 高端：500-1000元
• 豪华：1000元以上

⏱️ 性能分析：
• 快速：0-100ms
• 正常：100-500ms
• 慢速：500-1000ms  
• 超慢：1000ms以上
```

**🔧 配置方法**：
```
Aggregation：Range
Field：price
Ranges：
  ├── From: 0, To: 100
  ├── From: 100, To: 500
  ├── From: 500, To: 1000
  └── From: 1000（无上限）
Label：价格分布
```

---

## 5. 🚀 高级聚合应用场景


### 5.1 多层聚合组合


**🎯 实战场景**：分析不同浏览器的平均响应时间

**🔧 配置步骤**：
```
第一层：Bucket聚合
├── Terms聚合：browser.keyword
└── 按浏览器分组

第二层：Metrics聚合  
├── Average聚合：response_time
└── 计算每组的平均响应时间

结果：
Chrome: 平均120ms
Firefox: 平均150ms  
Safari: 平均110ms
```

### 5.2 时间序列分析


**🎯 实战场景**：监控网站每小时的访问量和平均响应时间

**🔧 配置步骤**：
```
X轴：Date Histogram
├── Field：@timestamp
├── Interval：1h
└── 时间分组

Y轴：Multiple Metrics
├── Count：访问量
└── Average(response_time)：平均响应时间

图表类型：Line Chart（折线图）
```

### 5.3 用户行为分析


**🎯 实战场景**：分析不同页面的用户停留时长分布

**🔧 配置步骤**：
```
行分组：Terms聚合
├── Field：page_url.keyword  
└── 按页面分组

列分组：Range聚合
├── Field：session_duration
└── 按停留时长分组

Metrics：Count
└── 统计每个组合的用户数量
```

### 5.4 错误监控仪表板


**🎯 实战场景**：构建完整的错误监控视图

**📊 组合指标**：
```
总体指标：
• 错误总数：Count聚合
• 错误率：Calculated Field  
• 平均错误间隔：Average聚合

分组分析：
• 按错误类型分组：Terms聚合
• 按时间趋势分析：Date Histogram
• 按严重程度分组：Terms聚合

性能影响：
• 错误对响应时间的影响
• 错误的地理分布
• 错误的用户群体分析
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的聚合类型


```
🎯 基础必会（5个）：
✅ Count：统计文档数量 → 访问量、订单数
✅ Average：计算平均值 → 平均响应时间、平均价格  
✅ Sum：计算总和 → 总销售额、总流量
✅ Min/Max：找极值 → 最快/最慢响应时间
✅ Terms：分组统计 → 按类别、地区、浏览器分组

🚀 进阶掌握（3个）：
✅ Unique Count：去重计数 → 独立用户数
✅ Percentiles：百分位数 → P95响应时间  
✅ Date Histogram：时间分组 → 趋势分析
```

### 6.2 聚合配置核心技巧


**🔹 字段选择要点**：
```
文本字段 → 选择.keyword后缀
数值字段 → 直接选择原字段
时间字段 → 通常是@timestamp
空值处理 → 在高级设置中配置
```

**🔹 性能优化建议**：
```
限制结果数量：
• Terms聚合：Size设置合理值（如10-50）
• 时间范围：缩小查询时间范围
• 字段选择：避免不必要的复杂聚合

提升查询速度：
• 使用索引模式的时间过滤
• 合理设置刷新间隔
• 避免过深的嵌套聚合
```

### 6.3 实际应用指导


**🎯 选择聚合类型的决策树**：
```
要统计什么？
├── 数量相关
│   ├── 总数量 → Count
│   └── 不重复数量 → Unique Count
├── 数值计算
│   ├── 平均水平 → Average  
│   ├── 总和 → Sum
│   ├── 极值 → Min/Max
│   └── 分布情况 → Percentiles
└── 分组分析
    ├── 按类别分组 → Terms
    ├── 按时间分组 → Date Histogram
    └── 按范围分组 → Range
```

**🔹 常见业务场景映射**：
```
网站分析师：
• 访问量监控 → Count + Date Histogram
• 用户行为 → Terms + Unique Count
• 性能监控 → Average + Percentiles

电商分析师：  
• 销售统计 → Sum + Terms聚合
• 商品分析 → Average + Range聚合
• 用户画像 → Multiple Terms聚合

运维工程师：
• 系统监控 → Average + Max + Date Histogram  
• 错误分析 → Count + Terms聚合
• 性能调优 → Percentiles + Standard Deviation
```

### 6.4 学习建议与进阶路径


**🛤️ 学习路径**：
```
第一阶段：基础掌握
└── 熟练使用Count、Average、Sum、Terms聚合

第二阶段：场景应用
└── 结合实际业务需求，构建监控仪表板

第三阶段：高级技巧  
└── 多层嵌套聚合、复杂业务指标计算

第四阶段：性能优化
└── 大数据量下的聚合查询优化
```

**💡 实践建议**：
```
动手练习：
• 用样本数据练习每种聚合类型
• 尝试不同聚合的组合使用
• 观察不同配置对结果的影响

解决问题：
• 从实际业务问题出发
• 思考用哪种聚合能解决问题
• 逐步构建复杂的分析视图

持续优化：
• 关注查询性能表现
• 收集用户反馈改进可视化
• 学习更高级的聚合特性
```

**🧠 记忆口诀**：
```
"数量用Count，平均用Average，
求和用Sum，分组用Terms，
时间趋势Date Histogram，
百分位数看分布，
组合使用解难题！"
```

---

## 🎓 学习检查点


**✅ 基础掌握检验**：
- [ ] 能独立配置Count、Average、Sum聚合
- [ ] 理解Metrics和Bucket聚合的区别
- [ ] 会选择正确的字段类型进行聚合
- [ ] 能解释百分位数的含义

**✅ 应用能力检验**：
- [ ] 能设计网站访问量监控方案
- [ ] 能分析用户行为数据
- [ ] 能构建性能监控仪表板
- [ ] 能进行多维度数据分析

**✅ 优化能力检验**：
- [ ] 了解聚合查询的性能影响因素
- [ ] 能合理设置聚合参数
- [ ] 会根据业务需求选择合适的聚合类型
- [ ] 能troubleshoot聚合查询问题