---
title: 8、TCP与UDP网络输入配置
---
## 📚 目录

1. [TCP/UDP网络输入概述](#1-TCPUDP网络输入概述)
2. [基础网络监听配置](#2-基础网络监听配置)
3. [连接管理与性能调优](#3-连接管理与性能调优)
4. [安全与加密配置](#4-安全与加密配置)
5. [数据格式处理](#5-数据格式处理)
6. [实际应用场景](#6-实际应用场景)
7. [故障排查与监控](#7-故障排查与监控)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 TCP/UDP网络输入概述


### 1.1 什么是网络输入


**🔸 简单理解**
```
想象Filebeat就像一个"网络邮递员"：
- TCP输入：像挂号信，确保每条消息都能安全送达
- UDP输入：像普通邮件，速度快但不保证一定送到
- Filebeat在指定的"门牌号"(端口)等待接收数据
```

**💡 核心作用**
- **数据收集**：从网络上接收其他应用发送的日志数据
- **协议支持**：支持TCP(可靠传输)和UDP(快速传输)两种方式
- **实时处理**：收到数据后立即转发给Elasticsearch等目标系统

### 1.2 TCP vs UDP 的区别


```
生活类比：
TCP = 打电话
- 建立连接后双方确认能听到
- 消息按顺序传递，丢失会重发
- 可靠但相对较慢

UDP = 发短信
- 直接发送，不确认对方是否收到
- 速度快但可能丢失
- 适合大量数据快速传输
```

**📊 特性对比**

| 特性 | **TCP** | **UDP** | **适用场景** |
|------|---------|---------|-------------|
| 可靠性 | 🟢 高 | 🟡 中等 | TCP: 重要日志<br>UDP: 监控指标 |
| 速度 | 🟡 中等 | 🟢 快 | TCP: 审计日志<br>UDP: 性能数据 |
| 资源消耗 | 🔴 较高 | 🟢 低 | TCP: 少量重要数据<br>UDP: 大量数据 |
| 连接管理 | 🔴 复杂 | 🟢 简单 | TCP: 长期连接<br>UDP: 短期传输 |

### 1.3 应用场景举例


**🎯 TCP适用场景**
- **应用日志收集**：Web服务器、数据库的错误日志
- **安全审计**：登录记录、权限变更日志
- **业务数据**：订单信息、用户行为记录

**⚡ UDP适用场景**
- **系统监控**：CPU、内存、网络使用率
- **性能指标**：响应时间、吞吐量数据
- **实时数据流**：传感器数据、股价信息

---

## 2. 🔧 基础网络监听配置


### 2.1 输入类型配置


**🔸 TCP输入配置**
```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"    # 监听所有网卡的9000端口
  enabled: true
```

**🔸 UDP输入配置**
```yaml
filebeat.inputs:
- type: udp
  host: "127.0.0.1:5140"  # 只监听本地5140端口
  enabled: true
```

💡 **参数解释**
- `type`: 指定输入类型，必须是tcp或udp
- `host`: 监听地址和端口，格式为"IP地址:端口号"
- `enabled`: 是否启用此输入，true表示启用

### 2.2 监听地址详细配置


**🏠 host参数的不同写法**

```yaml
# 方式1：监听所有网卡
host: "0.0.0.0:9000"      # 所有人都能连接

# 方式2：只监听本地
host: "127.0.0.1:9000"    # 只有本机能连接

# 方式3：监听指定网卡
host: "192.168.1.100:9000" # 只监听特定IP

# 方式4：只指定端口(默认监听所有网卡)
host: ":9000"             # 等同于 0.0.0.0:9000
```

**🔍 选择指南**
- **开发测试**：使用`127.0.0.1`，只允许本机连接
- **内网部署**：使用`0.0.0.0`，允许内网机器连接
- **安全环境**：使用具体IP，限制连接来源

### 2.3 端口选择策略


**📋 常用端口规划**

```
系统日志：
- TCP 514  : 传统syslog
- UDP 514  : syslog UDP模式
- TCP 601  : syslog-ng
- UDP 5140 : rsyslog

应用日志：
- TCP 9000-9999 : 应用自定义日志
- TCP 10000+    : 业务系统日志

监控数据：
- UDP 8125 : StatsD指标
- UDP 8086 : InfluxDB
```

⚠️ **端口选择注意事项**
- 避免使用知名端口(1-1023)，需要root权限
- 选择未被其他服务占用的端口
- 企业环境需要考虑防火墙策略

---

## 3. ⚙️ 连接管理与性能调优


### 3.1 消息大小限制


**📏 max_message_size 配置**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  max_message_size: 10MiB    # 限制单条消息最大10MB
```

**🔸 大小单位说明**
```
支持的单位：
- B, KiB, MiB, GiB : 二进制单位 (1024进制)
- KB, MB, GB       : 十进制单位 (1000进制)

常用设置：
- 普通日志：1MiB - 10MiB
- 大文件传输：100MiB+
- 默认值：20MiB
```

💡 **为什么要限制消息大小？**
```
防止问题：
✅ 避免内存占用过大
✅ 防止恶意攻击
✅ 保护系统稳定性

实际考虑：
- 单行日志通常几KB到几MB
- 堆栈信息可能较大
- JSON格式可能包含大量数据
```

### 3.2 网络超时设置


**⏱️ timeout 超时配置**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  timeout: 300s              # 5分钟超时
```

**📊 超时策略**

| 场景 | **推荐值** | **说明** |
|------|-----------|----------|
| 快速应用 | 30s-60s | Web应用日志 |
| 普通应用 | 300s(5分钟) | 一般业务系统 |
| 长连接 | 3600s(1小时) | 数据库连接 |
| 调试模式 | 0(无限制) | 开发测试环境 |

### 3.3 TCP连接数管理


**🔗 max_connections 配置**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  max_connections: 100       # 最多同时100个连接
```

**💭 连接数规划思路**

```
计算公式：
max_connections = 预期客户端数量 × 1.2 (留20%余量)

实际考虑：
• 每个连接占用内存约几KB到几MB
• 连接过多影响性能
• 连接过少可能拒绝客户端

推荐配置：
- 小型环境：10-50
- 中型环境：50-200  
- 大型环境：200-1000
```

### 3.4 完整性能优化配置示例


```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  enabled: true
  
  # 性能相关
  max_message_size: 5MiB     # 限制消息大小
  timeout: 300s              # 5分钟超时
  max_connections: 200       # 最大连接数
  
  # 标识字段
  fields:
    service: "app-logs"      # 添加服务标识
    environment: "production" # 环境标识
  fields_under_root: false   # 字段放在fields下
```

---

## 4. 🔒 安全与加密配置


### 4.1 TLS/SSL加密启用


**🔐 基础加密配置**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9443"       # 使用HTTPS端口
  ssl.enabled: true          # 启用SSL/TLS
  ssl.certificate: "/path/to/server.crt"
  ssl.key: "/path/to/server.key"
```

**🏠 生活类比理解**
```
不加密 = 明信片
- 内容任何人都能看到
- 传输过程可能被窃听
- 适合不敏感的数据

加密 = 密封信件
- 只有收件人能看到内容
- 传输过程无法窃听
- 适合敏感或重要数据
```

### 4.2 证书配置详解


**📜 证书文件准备**

```bash
# 1. 生成私钥
openssl genrsa -out server.key 2048

# 2. 生成证书请求
openssl req -new -key server.key -out server.csr

# 3. 生成自签名证书(测试用)
openssl x509 -req -in server.csr -signkey server.key -out server.crt
```

**🔧 完整SSL配置**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9443"
  ssl.enabled: true
  
  # 证书配置
  ssl.certificate: "/etc/filebeat/certs/server.crt"
  ssl.key: "/etc/filebeat/certs/server.key"
  ssl.certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
  
  # 安全策略
  ssl.verification_mode: "strict"    # 严格验证客户端证书
  ssl.client_authentication: "required" # 要求客户端证书
  ssl.supported_protocols: ["TLSv1.2", "TLSv1.3"] # 支持的TLS版本
```

### 4.3 客户端认证配置


**🆔 验证模式选择**

```yaml
# 模式1：不验证客户端证书
ssl.client_authentication: "none"

# 模式2：可选验证(有证书就验证)
ssl.client_authentication: "optional"  

# 模式3：必须验证客户端证书
ssl.client_authentication: "required"
```

💡 **选择建议**
- **测试环境**：使用"none"，简单快速
- **内网环境**：使用"optional"，灵活性好
- **生产环境**：使用"required"，安全性高

---

## 5. 📝 数据格式处理


### 5.1 帧格式配置


**🔸 framing 帧格式类型**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  framing: delimiter         # 使用分隔符模式
  line_delimiter: "\n"       # 换行符分隔
```

**📋 支持的帧格式**

| 格式 | **说明** | **适用场景** | **示例** |
|------|----------|-------------|----------|
| `delimiter` | 分隔符分帧 | 文本日志 | 每行一条日志 |
| `rfc6587` | RFC6587标准 | syslog | 标准日志格式 |
| `byte-count` | 字节计数 | 二进制数据 | 固定长度消息 |

### 5.2 分隔符详细配置


**🔤 line_delimiter 分隔符选项**

```yaml
# 常用分隔符
line_delimiter: "\n"          # Unix换行符
line_delimiter: "\r\n"        # Windows换行符  
line_delimiter: "\n\r"        # 某些旧系统
line_delimiter: ";"           # 自定义分隔符
line_delimiter: "||"          # 多字符分隔符
```

**💻 实际应用示例**

```yaml
# Web服务器日志(每行一条)
- type: tcp
  host: "0.0.0.0:9001"
  framing: delimiter
  line_delimiter: "\n"

# Windows事件日志(CRLF结尾)  
- type: tcp
  host: "0.0.0.0:9002"
  framing: delimiter
  line_delimiter: "\r\n"

# 自定义格式日志
- type: tcp
  host: "0.0.0.0:9003" 
  framing: delimiter
  line_delimiter: "---END---"
```

### 5.3 数据预处理


**🔧 字段添加和处理**

```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  
  # 添加自定义字段
  fields:
    log_type: "application"    # 日志类型
    datacenter: "beijing"      # 数据中心
    team: "backend"           # 负责团队
  
  # 字段位置配置
  fields_under_root: false    # false: 放在fields下，true: 放在根级别
  
  # 多行处理(如果需要)
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'  # 以日期开头
  multiline.negate: true
  multiline.match: after
```

---

## 6. 🎯 实际应用场景


### 6.1 应用日志收集场景


**📱 Java应用日志收集**

```yaml
# Filebeat配置
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9000"
  enabled: true
  fields:
    service: "user-service"
    environment: "production"
  
# Java应用通过Logback发送日志
```

**☕ Logback配置示例**
```xml
<!-- logback-spring.xml -->
<appender name="TCP" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <destination>filebeat-server:9000</destination>
    <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
        <providers>
            <timestamp/>
            <logLevel/>
            <loggerName/>
            <message/>
            <mdc/>
        </providers>
    </encoder>
</appender>
```

### 6.2 系统监控数据收集


**📊 系统指标收集(UDP)**

```yaml
# Filebeat UDP输入配置
filebeat.inputs:
- type: udp
  host: "0.0.0.0:8125"       # StatsD标准端口
  enabled: true
  fields:
    metric_type: "system"
    source: "monitoring"
```

**📈 发送监控数据**
```bash
# 使用netcat发送UDP数据
echo "cpu.usage:85|g" | nc -u filebeat-server 8125
echo "memory.used:2048|g" | nc -u filebeat-server 8125
echo "disk.io:156|c" | nc -u filebeat-server 8125
```

### 6.3 Nginx日志收集


**🌐 Nginx日志实时收集**

```yaml
# Filebeat配置
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  enabled: true
  fields:
    service: "nginx"
    log_type: "access"
```

**⚙️ Nginx配置**
```nginx
# nginx.conf
log_format json_log escape=json '{'
  '"@timestamp":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"request":"$request",'
  '"status":$status,'
  '"body_bytes_sent":$body_bytes_sent,'
  '"request_time":$request_time'
'}';

# 发送到Filebeat(需要额外配置syslog模块)
access_log syslog:server=filebeat-server:9001 json_log;
```

---

## 7. 🔍 故障排查与监控


### 7.1 常见问题诊断


**⚠️ 连接问题排查**

```bash
# 1. 检查端口是否监听
netstat -tlnp | grep 9000

# 2. 测试网络连通性
telnet filebeat-server 9000

# 3. 检查防火墙
firewall-cmd --list-ports
iptables -L

# 4. 查看Filebeat日志
tail -f /var/log/filebeat/filebeat.log
```

**🔧 配置验证命令**
```bash
# 验证配置文件语法
filebeat test config

# 测试输出连接
filebeat test output

# 启动时检查配置
filebeat run -e -d "*"
```

### 7.2 性能监控指标


**📊 关键监控指标**

```yaml
# 在Filebeat配置中启用监控
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["localhost:9200"]

# 重要指标：
# - input.tcp.messages.received_total : 接收消息总数
# - input.tcp.connections.active     : 活跃连接数  
# - input.tcp.messages.dropped_total : 丢弃消息数
# - system.cpu.total.pct             : CPU使用率
# - system.memory.actual.used.bytes  : 内存使用量
```

### 7.3 日志级别调整


**🔍 调试模式配置**

```yaml
# filebeat.yml
logging.level: debug          # 详细日志
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# 特定组件日志级别
logging.selectors: ["input", "tcp"]
```

**📋 日志级别说明**
- `error`: 只显示错误
- `warning`: 显示警告和错误
- `info`: 显示基本信息(默认)
- `debug`: 显示详细调试信息

### 7.4 常见错误解决


**🚨 典型错误及解决方案**

```
错误1: "bind: address already in use"
原因：端口被占用
解决：更换端口或停止占用进程

错误2: "connection refused"  
原因：Filebeat未启动或端口未开放
解决：启动服务并检查防火墙

错误3: "message too large"
原因：消息超过max_message_size限制
解决：增大限制或分割消息

错误4: "ssl handshake failed"
原因：SSL证书配置错误
解决：检查证书路径和权限
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 网络输入类型：TCP(可靠)和UDP(快速)的选择原则
🔸 监听配置：host地址绑定和端口选择策略  
🔸 性能参数：消息大小、超时时间、连接数限制
🔸 安全配置：SSL/TLS加密和客户端认证
🔸 数据处理：帧格式和分隔符配置
🔸 故障排查：常见问题的诊断和解决方法
```

### 8.2 关键理解要点


**🔹 TCP vs UDP的实用选择**
```
TCP选择场景：
✅ 重要业务日志(不能丢失)
✅ 安全审计数据
✅ 错误和异常信息
✅ 需要保证顺序的数据

UDP选择场景：  
✅ 大量监控指标
✅ 系统性能数据
✅ 实时数据流
✅ 对速度要求高的场景
```

**🔹 性能调优的平衡点**
```
内存 vs 连接数：
- 连接数过多占用内存
- 连接数过少影响并发

安全 vs 性能：
- SSL加密增加CPU开销
- 认证验证增加延迟

可靠性 vs 速度：
- TCP可靠但较慢
- UDP快速但可能丢失
```

### 8.3 实际应用价值


**🎯 业务场景应用**
- **微服务架构**：各服务通过TCP发送日志到Filebeat
- **监控系统**：通过UDP收集大量性能指标
- **安全审计**：通过加密TCP收集敏感日志
- **实时分析**：快速收集数据用于实时计算

**🔧 运维实践**
- **配置管理**：根据业务需求选择合适的网络输入类型
- **性能优化**：基于实际负载调整连接数和超时参数
- **安全加固**：在生产环境启用SSL和客户端认证
- **监控告警**：建立完善的性能监控和故障报警机制

### 8.4 学习进阶路径


```
初级掌握：
□ 理解TCP/UDP基本区别
□ 配置基础网络监听
□ 掌握常用参数含义

中级提升：
□ 性能参数调优
□ SSL安全配置
□ 多种数据格式处理

高级应用：
□ 大规模部署架构设计
□ 复杂场景故障排查
□ 与其他组件集成优化
```

**核心记忆口诀**：
- TCP可靠UDP快，根据需求来选择
- 监听地址要绑对，端口冲突要避免  
- 性能参数需调优，连接消息有限制
- 安全加密别忘记，证书配置要正确
- 数据格式要处理，分隔符号定规则
- 故障排查有方法，日志监控是关键