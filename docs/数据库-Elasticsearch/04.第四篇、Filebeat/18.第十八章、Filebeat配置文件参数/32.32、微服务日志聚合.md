---
title: 32ã€å¾®æœåŠ¡æ—¥å¿—èšåˆ
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡æ—¥å¿—èšåˆæ¦‚è¿°](#1-å¾®æœåŠ¡æ—¥å¿—èšåˆæ¦‚è¿°)
2. [å®¹å™¨åŒ–åº”ç”¨æ—¥å¿—æ”¶é›†](#2-å®¹å™¨åŒ–åº”ç”¨æ—¥å¿—æ”¶é›†)
3. [Kuberneteså…ƒæ•°æ®å¤„ç†](#3-kuberneteså…ƒæ•°æ®å¤„ç†)
4. [æœåŠ¡æ ‡è¯†ä¸å‘½åç©ºé—´é…ç½®](#4-æœåŠ¡æ ‡è¯†ä¸å‘½åç©ºé—´é…ç½®)
5. [JSONæ—¥å¿—æ ¼å¼å¤„ç†](#5-jsonæ—¥å¿—æ ¼å¼å¤„ç†)
6. [å…³è”IDè·Ÿè¸ªé…ç½®](#6-å…³è”idè·Ÿè¸ªé…ç½®)
7. [å®Œæ•´é…ç½®ç¤ºä¾‹](#7-å®Œæ•´é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¾®æœåŠ¡æ—¥å¿—èšåˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ—¥å¿—èšåˆ


**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¿é”é¤å…ï¼Œæ¯ä¸ªåˆ†åº—éƒ½åœ¨è®°å½•è‡ªå·±çš„è¥ä¸šæ—¥å¿—ã€‚å¾®æœåŠ¡æ—¥å¿—èšåˆå°±åƒæ˜¯æŠŠæ‰€æœ‰åˆ†åº—çš„æ—¥å¿—æ”¶é›†åˆ°æ€»éƒ¨ï¼Œç»Ÿä¸€æŸ¥çœ‹å’Œåˆ†æã€‚

```
ä¼ ç»Ÿåº”ç”¨ vs å¾®æœåŠ¡åº”ç”¨æ—¥å¿—å¤„ç†ï¼š

ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
åº”ç”¨ â†’ ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ â†’ ç›´æ¥æŸ¥çœ‹
ç®€å•æ˜äº†ï¼Œæ‰€æœ‰ä¿¡æ¯åœ¨ä¸€ä¸ªåœ°æ–¹

å¾®æœåŠ¡åº”ç”¨ï¼š
ç”¨æˆ·æœåŠ¡ â†’ ç”¨æˆ·æ—¥å¿—
è®¢å•æœåŠ¡ â†’ è®¢å•æ—¥å¿—  
æ”¯ä»˜æœåŠ¡ â†’ æ”¯ä»˜æ—¥å¿—
åº“å­˜æœåŠ¡ â†’ åº“å­˜æ—¥å¿—
...
éœ€è¦ç»Ÿä¸€æ”¶é›†ï¼Œæ‰èƒ½çœ‹åˆ°å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
```

### 1.2 å¾®æœåŠ¡æ—¥å¿—èšåˆçš„æŒ‘æˆ˜


**ğŸ”¸ åˆ†æ•£æ€§é—®é¢˜**
- **å¤šä¸ªæœåŠ¡**ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±çš„æ—¥å¿—
- **å¤šä¸ªå®ä¾‹**ï¼šåŒä¸€æœåŠ¡å¯èƒ½æœ‰å¤šä¸ªè¿è¡Œå®ä¾‹
- **å¤šä¸ªå®¹å™¨**ï¼šå®¹å™¨åŒ–éƒ¨ç½²åæ—¥å¿—æ›´åŠ åˆ†æ•£

**ğŸ”¸ å…³è”æ€§é—®é¢˜**
- **è·¨æœåŠ¡è¿½è¸ª**ï¼šä¸€ä¸ªç”¨æˆ·è¯·æ±‚å¯èƒ½ç»è¿‡å¤šä¸ªæœåŠ¡
- **æ—¶é—´åŒæ­¥**ï¼šä¸åŒæœåŠ¡çš„æ—¶é—´å¯èƒ½ä¸ä¸€è‡´
- **ä¸Šä¸‹æ–‡ä¸¢å¤±**ï¼šæœåŠ¡é—´è°ƒç”¨æ—¶ä¸Šä¸‹æ–‡ä¿¡æ¯å®¹æ˜“ä¸¢å¤±

### 1.3 Filebeatåœ¨å¾®æœåŠ¡ä¸­çš„ä½œç”¨


**ğŸ“Š Filebeatçš„ä»·å€¼**
```
å¾®æœåŠ¡æ¶æ„å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æœåŠ¡   â”‚  â”‚   è®¢å•æœåŠ¡   â”‚  â”‚   æ”¯ä»˜æœåŠ¡   â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚  Filebeat   â”‚  â”‚  Filebeat   â”‚  â”‚  Filebeat   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   Elasticsearch   â”‚
              â”‚     é›†ä¸­å­˜å‚¨      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªæœåŠ¡éƒ½æœ‰Filebeatä»£ç†ï¼Œè´Ÿè´£ï¼š
- æ”¶é›†æœ¬åœ°æ—¥å¿—
- æ·»åŠ æœåŠ¡æ ‡è¯†
- å‘é€åˆ°ç»Ÿä¸€å­˜å‚¨
```

---

## 2. ğŸ“¦ å®¹å™¨åŒ–åº”ç”¨æ—¥å¿—æ”¶é›†


### 2.1 å®¹å™¨æ—¥å¿—çš„ç‰¹ç‚¹


**ğŸ”¸ å®¹å™¨æ—¥å¿—ä¸ä¼ ç»Ÿæ—¥å¿—çš„åŒºåˆ«**

```
ä¼ ç»Ÿè™šæ‹Ÿæœºæ—¥å¿—ï¼š
/var/log/app.log    â† å›ºå®šè·¯å¾„ï¼ŒæŒä¹…å­˜å‚¨
/var/log/error.log  â† å¯ä»¥ç›´æ¥è®¿é—®

å®¹å™¨åŒ–æ—¥å¿—ï¼š
å®¹å™¨å†…: /app/logs/app.log    â† å®¹å™¨åœæ­¢åæ¶ˆå¤±
å®¿ä¸»æœº: /var/lib/docker/...  â† å¤æ‚çš„å­˜å‚¨è·¯å¾„
stdout: docker logs å‘½ä»¤æŸ¥çœ‹  â† æ ‡å‡†è¾“å‡º
```

**ğŸ”¸ å®¹å™¨æ—¥å¿—æ”¶é›†çš„æŒ‘æˆ˜**
- **ç”Ÿå‘½å‘¨æœŸçŸ­æš‚**ï¼šå®¹å™¨é‡å¯åæ—¥å¿—å¯èƒ½ä¸¢å¤±
- **è·¯å¾„åŠ¨æ€**ï¼šå®¹å™¨IDå’Œè·¯å¾„ä¼šå˜åŒ–
- **æƒé™é—®é¢˜**ï¼šéœ€è¦è®¿é—®Dockerå®ˆæŠ¤è¿›ç¨‹
- **æ ¼å¼å¤šæ ·**ï¼šæ ‡å‡†è¾“å‡ºã€æ–‡ä»¶ã€syslogç­‰

### 2.2 Dockerå®¹å™¨æ—¥å¿—æ”¶é›†é…ç½®


**ğŸ’¡ åŸºç¡€Dockerå®¹å™¨é…ç½®**

```yaml
# filebeat.yml - Dockerå®¹å™¨æ—¥å¿—æ”¶é›†
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # è§£æDockeræ—¥å¿—æ ¼å¼
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      match_fields: ["container.id"]
      
  # æ’é™¤ç³»ç»Ÿå®¹å™¨
  exclude_lines: ['^DEBUG', '^TRACE']
  
  # å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆJavaå¼‚å¸¸å †æ ˆï¼‰
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
```

**ğŸ“‹ é…ç½®å‚æ•°è¯´æ˜**

| å‚æ•° | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| `type: container` | å®¹å™¨ç±»å‹è¾“å…¥ | ä¸“é—¨ç”¨äºæ”¶é›†å®¹å™¨æ—¥å¿— |
| `paths` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | Dockeré»˜è®¤æ—¥å¿—å­˜å‚¨ä½ç½® |
| `add_docker_metadata` | æ·»åŠ Dockerå…ƒæ•°æ® | è‡ªåŠ¨æ·»åŠ å®¹å™¨ä¿¡æ¯ |
| `exclude_lines` | æ’é™¤è¡Œ | è¿‡æ»¤æ‰è°ƒè¯•ä¿¡æ¯ |
| `multiline` | å¤šè¡Œå¤„ç† | å¤„ç†å¼‚å¸¸å †æ ˆç­‰å¤šè¡Œæ—¥å¿— |

### 2.3 å®¹å™¨æ ‡ç­¾ä¸è¿‡æ»¤


**ğŸ·ï¸ ä½¿ç”¨Dockeræ ‡ç­¾è¿›è¡Œè¿‡æ»¤**

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      
  # æ ¹æ®å®¹å™¨æ ‡ç­¾è¿‡æ»¤
  - drop_event:
      when:
        not:
          contains:
            container.labels.collect_logs: "true"
            
  # æ·»åŠ ç¯å¢ƒæ ‡è¯†
  - add_fields:
      target: env
      fields:
        environment: "${ENVIRONMENT:production}"
        datacenter: "${DATACENTER:dc1}"
```

**ğŸ”§ Docker Composeé…ç½®ç¤ºä¾‹**

```yaml
# docker-compose.yml
version: '3.8'
services:
  user-service:
    image: user-service:latest
    labels:
      - "collect_logs=true"
      - "service_name=user-service"
      - "service_version=1.2.0"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

## 3. â˜¸ï¸ Kuberneteså…ƒæ•°æ®å¤„ç†


### 3.1 Kubernetesç¯å¢ƒä¸‹çš„æ—¥å¿—æ”¶é›†


**ğŸ¯ K8sæ—¥å¿—æ”¶é›†çš„å¤æ‚æ€§**

```
Kubernetesæ—¥å¿—å±‚æ¬¡ï¼š

Pod (å®¹å™¨ç»„)
â”œâ”€â”€ Container 1 (åº”ç”¨å®¹å™¨)
â”‚   â”œâ”€â”€ stdout æ ‡å‡†è¾“å‡º
â”‚   â””â”€â”€ stderr é”™è¯¯è¾“å‡º
â”œâ”€â”€ Container 2 (sidecarå®¹å™¨)
â”‚   â””â”€â”€ æ—¥å¿—æ–‡ä»¶
â””â”€â”€ InitContainer (åˆå§‹åŒ–å®¹å™¨)
    â””â”€â”€ åˆå§‹åŒ–æ—¥å¿—

æ¯ä¸ªå±‚æ¬¡éƒ½æœ‰å…ƒæ•°æ®ä¿¡æ¯éœ€è¦æ”¶é›†
```

**ğŸ“Š Kuberneteså…ƒæ•°æ®çš„ä»·å€¼**
- **Podä¿¡æ¯**ï¼šPodåç§°ã€å‘½åç©ºé—´ã€åˆ›å»ºæ—¶é—´
- **Containerä¿¡æ¯**ï¼šå®¹å™¨åã€é•œåƒã€é‡å¯æ¬¡æ•°
- **Nodeä¿¡æ¯**ï¼šè¿è¡ŒèŠ‚ç‚¹ã€èŠ‚ç‚¹æ ‡ç­¾
- **Labels/Annotations**ï¼šä¸šåŠ¡æ ‡ç­¾å’Œæ³¨è§£ä¿¡æ¯

### 3.2 Kuberneteså…ƒæ•°æ®é…ç½®


**âš™ï¸ åŸºç¡€K8så…ƒæ•°æ®é…ç½®**

```yaml
filebeat.inputs:
- type: container
  paths:
    - /var/log/containers/*.log
  
  processors:
  # æ·»åŠ Kuberneteså…ƒæ•°æ®
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      matchers:
      - logs_path:
          logs_path: "/var/log/containers/"
          resource_type: "container"
      
      # æŒ‡å®šè¦åŒ…å«çš„å…ƒæ•°æ®
      include_annotations: ["app.version", "config.hash"]
      include_labels: ["app", "version", "environment"]
      
      # å…ƒæ•°æ®æ¥æº
      kube_config: ${HOME}/.kube/config
      # æˆ–è€…ä½¿ç”¨ in_cluster: true ï¼ˆåœ¨é›†ç¾¤å†…è¿è¡Œæ—¶ï¼‰
```

**ğŸ—ï¸ DaemonSetéƒ¨ç½²é…ç½®**

```yaml
# filebeat-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
spec:
  template:
    spec:
      serviceAccountName: filebeat
      containers:
      - name: filebeat
        image: elastic/filebeat:8.11.0
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: config
          mountPath: /usr/share/filebeat/filebeat.yml
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: varlogcontainers
          mountPath: /var/log/containers
          readOnly: true
```

### 3.3 é«˜çº§å…ƒæ•°æ®å¤„ç†


**ğŸ”„ åŠ¨æ€å…ƒæ•°æ®å¤„ç†**

```yaml
processors:
- add_kubernetes_metadata:
    # è‡ªå®šä¹‰å…ƒæ•°æ®å­—æ®µæ˜ å°„
    default_matchers.enabled: false
    matchers:
    - logs_path:
        logs_path: "/var/log/containers/"
        resource_type: "container"
    
    # ç´¢å¼•å™¨é…ç½®
    indexers:
    - container:
    - pod_name:
        resource_type: pod
        field: "kubernetes.pod.name"
    - pod_uid:
        resource_type: pod
        field: "kubernetes.pod.uid"

# æ ¹æ®å‘½åç©ºé—´å¤„ç†ä¸åŒçš„ç´¢å¼•
- if:
    contains:
      kubernetes.namespace: "production"
  then:
  - add_fields:
      target: "@metadata"
      fields:
        index_prefix: "prod-logs"
- if:
    contains:
      kubernetes.namespace: "staging"
  then:
  - add_fields:
      target: "@metadata"
      fields:
        index_prefix: "staging-logs"
```

---

## 4. ğŸ·ï¸ æœåŠ¡æ ‡è¯†ä¸å‘½åç©ºé—´é…ç½®


### 4.1 ServiceæœåŠ¡æ ‡è¯†


**ğŸ¯ ä»€ä¹ˆæ˜¯Serviceæ ‡è¯†**

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒServiceæ ‡è¯†å°±åƒæ¯ä¸ªæœåŠ¡çš„"èº«ä»½è¯"ï¼Œå¸®åŠ©æˆ‘ä»¬è¯†åˆ«æ—¥å¿—æ¥è‡ªå“ªä¸ªå…·ä½“çš„æœåŠ¡ã€‚

```
æœåŠ¡æ ‡è¯†å±‚æ¬¡ç»“æ„ï¼š

åº”ç”¨å±‚çº§ï¼š
â”œâ”€â”€ åº”ç”¨åç§°: "e-commerce-platform"
â”œâ”€â”€ æœåŠ¡åç§°: "user-service"
â”œâ”€â”€ æœåŠ¡ç‰ˆæœ¬: "v1.2.3"
â””â”€â”€ å®ä¾‹ID: "user-service-pod-abc123"

ä¸šåŠ¡å±‚çº§ï¼š
â”œâ”€â”€ ä¸šåŠ¡åŸŸ: "user-management"
â”œâ”€â”€ åŠŸèƒ½æ¨¡å—: "authentication"
â””â”€â”€ APIç‰ˆæœ¬: "v2"
```

**ğŸ”§ Serviceæ ‡è¯†é…ç½®**

```yaml
filebeat.inputs:
- type: container
  paths:
    - /var/log/containers/*.log
  
  processors:
  - add_kubernetes_metadata:
      include_labels: ["app", "version", "component"]
      
  # æå–æœåŠ¡ä¿¡æ¯
  - script:
      lang: javascript
      source: >
        function process(event) {
          var labels = event.Get("kubernetes.labels");
          if (labels) {
            // è®¾ç½®æœåŠ¡æ ‡è¯†
            event.Put("service.name", labels.app || "unknown");
            event.Put("service.version", labels.version || "unknown");
            event.Put("service.environment", labels.environment || "unknown");
            
            // è®¾ç½®ä¸šåŠ¡æ ‡è¯†
            if (labels.component) {
              event.Put("business.component", labels.component);
            }
          }
        }
```

### 4.2 Namespaceå‘½åç©ºé—´é…ç½®


**ğŸ“‹ å‘½åç©ºé—´çš„ä½œç”¨**

å‘½åç©ºé—´å°±åƒå…¬å¸é‡Œçš„ä¸åŒéƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨æœ‰è‡ªå·±çš„èµ„æºå’ŒèŒè´£èŒƒå›´ã€‚

```
å‘½åç©ºé—´åˆ’åˆ†ç¤ºä¾‹ï¼š

â”œâ”€â”€ production          (ç”Ÿäº§ç¯å¢ƒ)
â”‚   â”œâ”€â”€ user-service
â”‚   â”œâ”€â”€ order-service
â”‚   â””â”€â”€ payment-service
â”œâ”€â”€ staging            (æµ‹è¯•ç¯å¢ƒ)
â”‚   â”œâ”€â”€ user-service
â”‚   â””â”€â”€ order-service
â”œâ”€â”€ development        (å¼€å‘ç¯å¢ƒ)
â”‚   â””â”€â”€ user-service
â””â”€â”€ monitoring         (ç›‘æ§ç³»ç»Ÿ)
    â”œâ”€â”€ prometheus
    â””â”€â”€ grafana
```

**âš™ï¸ å‘½åç©ºé—´å¤„ç†é…ç½®**

```yaml
processors:
- add_kubernetes_metadata:
    include_annotations: ["deployment.version"]
    
# æ ¹æ®å‘½åç©ºé—´æ·»åŠ ç¯å¢ƒæ ‡è¯†
- if:
    equals:
      kubernetes.namespace: "production"
  then:
  - add_fields:
      target: environment
      fields:
        type: "prod"
        criticality: "high"
        alerting: "enabled"
        
- if:
    equals:
      kubernetes.namespace: "staging"
  then:
  - add_fields:
      target: environment
      fields:
        type: "staging"
        criticality: "medium"
        alerting: "disabled"

# è®¾ç½®ç´¢å¼•æ¨¡å¼
- if:
    regexp:
      kubernetes.namespace: "^(production|prod)$"
  then:
  - add_fields:
      target: "@metadata"
      fields:
        index_pattern: "prod-logs-%{+yyyy.MM.dd}"
```

### 4.3 Podå®¹å™¨ç»„ä¿¡æ¯æå–


**ğŸ—ï¸ Podä¿¡æ¯çš„é‡è¦æ€§**

Podæ˜¯Kubernetesä¸­çš„æœ€å°éƒ¨ç½²å•å…ƒï¼ŒåŒ…å«äº†ä¸°å¯Œçš„è¿è¡Œæ—¶ä¿¡æ¯ã€‚

```
Podä¿¡æ¯ç»“æ„ï¼š

Pod: user-service-deployment-abc123
â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ åç§°: user-service-deployment-abc123
â”‚   â”œâ”€â”€ å‘½åç©ºé—´: production
â”‚   â”œâ”€â”€ åˆ›å»ºæ—¶é—´: 2024-01-15T10:30:00Z
â”‚   â””â”€â”€ çŠ¶æ€: Running
â”œâ”€â”€ æ ‡ç­¾ä¿¡æ¯
â”‚   â”œâ”€â”€ app: user-service
â”‚   â”œâ”€â”€ version: v1.2.3
â”‚   â””â”€â”€ tier: backend
â”œâ”€â”€ æ³¨è§£ä¿¡æ¯
â”‚   â”œâ”€â”€ deployment.kubernetes.io/revision: "3"
â”‚   â””â”€â”€ prometheus.io/scrape: "true"
â””â”€â”€ å®¹å™¨ä¿¡æ¯
    â”œâ”€â”€ user-service (ä¸»å®¹å™¨)
    â””â”€â”€ filebeat (sidecarå®¹å™¨)
```

**ğŸ” Podä¿¡æ¯æå–é…ç½®**

```yaml
processors:
- add_kubernetes_metadata:
    # å®Œæ•´çš„Podä¿¡æ¯æå–
    include_pod_uid: true
    include_annotations: ["*"]
    include_labels: ["*"]
    
    # è‡ªå®šä¹‰å­—æ®µæ˜ å°„
    labels_dedot: true
    annotations_dedot: true

# æå–å…³é”®Podä¿¡æ¯
- script:
    lang: javascript
    source: >
      function process(event) {
        var k8s = event.Get("kubernetes");
        if (k8s && k8s.pod) {
          // æå–PodåŸºæœ¬ä¿¡æ¯
          event.Put("pod.name", k8s.pod.name);
          event.Put("pod.uid", k8s.pod.uid);
          event.Put("pod.ip", k8s.pod.ip);
          
          // æå–é‡å¯æ¬¡æ•°ç­‰è¿è¡ŒçŠ¶æ€
          if (k8s.container) {
            event.Put("container.restart_count", 
              k8s.container.restart_count || 0);
          }
          
          // æå–èŠ‚ç‚¹ä¿¡æ¯
          if (k8s.node) {
            event.Put("node.name", k8s.node.name);
          }
        }
      }
```

### 4.4 Labelsæ ‡ç­¾ä¿¡æ¯å¤„ç†


**ğŸ·ï¸ æ ‡ç­¾çš„ä¸šåŠ¡ä»·å€¼**

Kubernetesæ ‡ç­¾æ˜¯key-valueå½¢å¼çš„å…ƒæ•°æ®ï¼Œç”¨äºæ ‡è¯†å’Œé€‰æ‹©èµ„æºã€‚

```yaml
# å¸¸è§æ ‡ç­¾ç¤ºä¾‹
labels:
  # åº”ç”¨æ ‡è¯†
  app: "user-service"
  version: "v1.2.3"
  component: "authentication"
  
  # ç¯å¢ƒæ ‡è¯†  
  environment: "production"
  tier: "backend"
  
  # éƒ¨ç½²æ ‡è¯†
  release: "stable"
  track: "canary"
  
  # ä¸šåŠ¡æ ‡è¯†
  team: "platform"
  cost-center: "engineering"
```

**âš™ï¸ æ ‡ç­¾å¤„ç†é…ç½®**

```yaml
processors:
- add_kubernetes_metadata:
    # é€‰æ‹©æ€§åŒ…å«æ ‡ç­¾
    include_labels: 
      - "app"
      - "version" 
      - "environment"
      - "component"
      - "team"
    
    # æ ‡ç­¾ç‚¹å·å¤„ç†ï¼ˆk8sæ ‡ç­¾å¯èƒ½åŒ…å«ç‚¹å·ï¼‰
    labels_dedot: true

# æ ‡ç­¾å€¼è§„èŒƒåŒ–å¤„ç†
- if:
    has_fields: ["kubernetes.labels.environment"]
  then:
  - lowercase:
      field: "kubernetes.labels.environment"
      target_field: "env.name"
      
- if:
    has_fields: ["kubernetes.labels.app"]
  then:
  - copy_fields:
      fields:
        - from: "kubernetes.labels.app"
          to: "service.name"
      fail_on_error: false

# åŸºäºæ ‡ç­¾çš„è·¯ç”±é…ç½®
- if:
    equals:
      kubernetes.labels.tier: "frontend"
  then:
  - add_tags:
      tags: ["frontend", "web"]
      
- if:
    equals:
      kubernetes.labels.tier: "backend"
  then:
  - add_tags:
      tags: ["backend", "api"]
```

---

## 5. ğŸ“„ JSONæ—¥å¿—æ ¼å¼å¤„ç†


### 5.1 JSONæ—¥å¿—çš„ä¼˜åŠ¿


**ğŸ’¡ ä¸ºä»€ä¹ˆä½¿ç”¨JSONæ ¼å¼**

JSONæ ¼å¼å°±åƒæ˜¯ç»™æ—¥å¿—ä¿¡æ¯è£…è¿›äº†ä¸€ä¸ªæœ‰åºçš„æ–‡ä»¶æŸœï¼Œæ¯ä¸ªä¿¡æ¯éƒ½æœ‰æ˜ç¡®çš„æ ‡ç­¾å’Œä½ç½®ã€‚

```
ä¼ ç»Ÿæ–‡æœ¬æ—¥å¿— vs JSONæ—¥å¿—ï¼š

ä¼ ç»Ÿæ–‡æœ¬æ—¥å¿—ï¼š
2024-01-15 10:30:15 ERROR UserService - User login failed for john@example.com

JSONæ—¥å¿—ï¼š
{
  "timestamp": "2024-01-15T10:30:15.123Z",
  "level": "ERROR",
  "service": "UserService",
  "message": "User login failed",
  "user": {
    "email": "john@example.com",
    "id": "12345"
  },
  "trace_id": "abc-def-123",
  "duration_ms": 250
}

JSONçš„ä¼˜åŠ¿ï¼š
âœ… ç»“æ„åŒ–ï¼šå­—æ®µæ˜ç¡®ï¼Œæ˜“äºæŸ¥è¯¢
âœ… å¯æ‰©å±•ï¼šå¯ä»¥æ·»åŠ ä»»æ„å­—æ®µ
âœ… æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„æ ¼å¼è§„èŒƒ
âœ… æœºå™¨å‹å¥½ï¼šç¨‹åºå®¹æ˜“è§£æ
```

### 5.2 JSONæ—¥å¿—è§£æé…ç½®


**ğŸ”§ åŸºç¡€JSONè§£æ**

```yaml
filebeat.inputs:
- type: container
  paths:
    - /var/log/containers/*.log
  
  processors:
  # Dockerå®¹å™¨ä¼šåŒ…è£…æ—¥å¿—ï¼Œéœ€è¦å…ˆè§£æDockeræ ¼å¼
  - decode_json_fields:
      fields: ["message"]
      target: ""
      overwrite_keys: true
      add_error_key: true
      
  # è§£æåº”ç”¨å±‚çš„JSONæ—¥å¿—
  - decode_json_fields:
      fields: ["log"]  # DockeråŒ…è£…åçš„å­—æ®µå
      target: "app"    # è§£æåå­˜å‚¨çš„ç›®æ ‡å­—æ®µ
      overwrite_keys: false
      add_error_key: true
      
  # æ—¶é—´æˆ³å¤„ç†
  - timestamp:
      field: app.timestamp
      layouts:
        - '2006-01-02T15:04:05.000Z'
        - '2006-01-02T15:04:05Z'
      test:
        - '2024-01-15T10:30:15.123Z'
```

**ğŸ“‹ å¤æ‚JSONç»“æ„å¤„ç†**

```yaml
# å¤šå±‚åµŒå¥—JSONå¤„ç†
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    
# æå–åµŒå¥—å­—æ®µ
- script:
    lang: javascript
    source: >
      function process(event) {
        var log = event.Get("log");
        if (log && typeof log === 'string') {
          try {
            var parsed = JSON.parse(log);
            
            // æå–åŸºç¡€å­—æ®µ
            if (parsed.level) {
              event.Put("log.level", parsed.level.toUpperCase());
            }
            
            if (parsed.service) {
              event.Put("service.name", parsed.service);
            }
            
            // æå–ç”¨æˆ·ä¿¡æ¯
            if (parsed.user) {
              event.Put("user.id", parsed.user.id);
              event.Put("user.email", parsed.user.email);
            }
            
            // æå–æ€§èƒ½æŒ‡æ ‡
            if (parsed.duration_ms) {
              event.Put("performance.duration", parsed.duration_ms);
            }
            
            // æå–è·Ÿè¸ªä¿¡æ¯
            if (parsed.trace_id) {
              event.Put("trace.id", parsed.trace_id);
            }
            
          } catch (e) {
            event.Put("json_parse_error", e.toString());
          }
        }
      }
```

### 5.3 JSONå­—æ®µæ˜ å°„å’Œæ¸…ç†


**ğŸ§¹ å­—æ®µæ ‡å‡†åŒ–å¤„ç†**

```yaml
processors:
# JSONè§£æåçš„å­—æ®µæ˜ å°„
- rename:
    fields:
      - from: "app.@timestamp"
        to: "event.created"
      - from: "app.msg"
        to: "message"
      - from: "app.level"
        to: "log.level"
        
# å­—æ®µç±»å‹è½¬æ¢
- convert:
    fields:
      - {from: "app.duration_ms", to: "performance.duration", type: "integer"}
      - {from: "app.status_code", to: "http.response.status_code", type: "integer"}
      - {from: "app.user_id", to: "user.id", type: "string"}

# åˆ é™¤åŸå§‹å­—æ®µï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- drop_fields:
    fields: ["app", "log", "stream", "time"]
    ignore_missing: true

# æ¡ä»¶å­—æ®µå¤„ç†
- if:
    has_fields: ["http.response.status_code"]
  then:
  - add_fields:
      target: "http.response"
      fields:
        status_class: "2xx"
  - if:
      range:
        http.response.status_code:
          gte: 400
          lt: 500
    then:
    - add_fields:
        target: "http.response"
        fields:
          status_class: "4xx"
```

---

## 6. ğŸ”— å…³è”IDè·Ÿè¸ªé…ç½®


### 6.1 ä»€ä¹ˆæ˜¯Correlation ID


**ğŸ’¡ å…³è”IDçš„æ¦‚å¿µ**

å…³è”IDå°±åƒæ˜¯ä¸€å¼ "é€šè¡Œè¯"ï¼Œè®°å½•äº†ç”¨æˆ·è¯·æ±‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­çš„å®Œæ•´æ—…ç¨‹ã€‚

```
ç”¨æˆ·è¯·æ±‚çš„å¾®æœåŠ¡è°ƒç”¨é“¾ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡
    â†“         â†“         â†“         â†“         â†“
correlation_id: req_20240115_103015_abc123

æ¯ä¸ªæœåŠ¡çš„æ—¥å¿—éƒ½åŒ…å«è¿™ä¸ªIDï¼š
ç½‘å…³: [req_20240115_103015_abc123] æ¥æ”¶ç”¨æˆ·ç™»å½•è¯·æ±‚
ç”¨æˆ·: [req_20240115_103015_abc123] éªŒè¯ç”¨æˆ·å¯†ç 
è®¢å•: [req_20240115_103015_abc123] æŸ¥è¯¢ç”¨æˆ·è®¢å•
æ”¯ä»˜: [req_20240115_103015_abc123] å¤„ç†æ”¯ä»˜è¯·æ±‚

é€šè¿‡è¿™ä¸ªIDï¼Œæˆ‘ä»¬å¯ä»¥è¿½è¸ªæ•´ä¸ªè¯·æ±‚æµç¨‹
```

**ğŸ¯ å…³è”IDçš„ä»·å€¼**
- **é—®é¢˜è¿½è¸ª**ï¼šå¿«é€Ÿå®šä½é—®é¢˜å‘ç”Ÿåœ¨å“ªä¸ªæœåŠ¡
- **æ€§èƒ½åˆ†æ**ï¼šåˆ†ææ•´ä¸ªè¯·æ±‚é“¾çš„è€—æ—¶
- **ä¸šåŠ¡ç›‘æ§**ï¼šç›‘æ§ä¸šåŠ¡æµç¨‹çš„å®Œæ•´æ€§
- **æ•…éšœæ¢å¤**ï¼šäº†è§£æ•…éšœå½±å“èŒƒå›´

### 6.2 å…³è”IDæå–é…ç½®


**ğŸ” ä»æ—¥å¿—ä¸­æå–å…³è”ID**

```yaml
processors:
# ä»JSONæ—¥å¿—ä¸­æå–å…³è”ID
- if:
    has_fields: ["app.correlation_id"]
  then:
  - copy_fields:
      fields:
        - from: "app.correlation_id"
          to: "trace.id"
      fail_on_error: false

# ä»æ—¥å¿—æ¶ˆæ¯ä¸­æå–å…³è”IDï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- dissect:
    tokenizer: "%{timestamp} %{level} [%{trace_id}] %{service} - %{message}"
    field: "message"
    target_prefix: "parsed"
    
- if:
    has_fields: ["parsed.trace_id"]
  then:
  - copy_fields:
      fields:
        - from: "parsed.trace_id"
          to: "trace.id"

# ä½¿ç”¨Grokæ¨¡å¼æå–ï¼ˆæ›´å¤æ‚çš„æ ¼å¼ï¼‰
- grok:
    field: message
    patterns:
      - '\[%{DATA:trace.id}\].*%{GREEDYDATA:log.message}'
      - 'traceId=%{DATA:trace.id}.*'
      - 'correlation-id:%{SPACE}*%{DATA:trace.id}'
    ignore_missing: true
```

**ğŸ“Š å¤šç§IDæ ¼å¼æ”¯æŒ**

```yaml
# æ”¯æŒå¤šç§å…³è”IDå‘½å
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var traceId = null;
        
        // å°è¯•ä»å¤šä¸ªå¯èƒ½çš„å­—æ®µæå–
        var possibleFields = [
          "app.correlation_id",
          "app.trace_id", 
          "app.request_id",
          "app.transaction_id",
          "parsed.correlation_id",
          "parsed.trace_id"
        ];
        
        for (var i = 0; i < possibleFields.length; i++) {
          var value = event.Get(possibleFields[i]);
          if (value && value.length > 0) {
            traceId = value;
            break;
          }
        }
        
        if (traceId) {
          event.Put("trace.id", traceId);
          // æ ‡è®°è¿™æ˜¯ä¸€ä¸ªå¯è¿½è¸ªçš„äº‹ä»¶
          event.Put("event.traceable", true);
        }
      }
```

### 6.3 å…³è”IDéªŒè¯å’Œæ ‡å‡†åŒ–


**âœ… IDæ ¼å¼éªŒè¯**

```yaml
processors:
# éªŒè¯å…³è”IDæ ¼å¼
- if:
    has_fields: ["trace.id"]
  then:
  - script:
      lang: javascript
      source: >
        function process(event) {
          var traceId = event.Get("trace.id");
          
          // éªŒè¯IDæ ¼å¼ï¼ˆä¾‹å¦‚ï¼šUUIDæ ¼å¼ï¼‰
          var uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
          
          if (uuidRegex.test(traceId)) {
            event.Put("trace.id_format", "uuid");
            event.Put("trace.valid", true);
          } else if (traceId.length >= 16) {
            event.Put("trace.id_format", "custom");
            event.Put("trace.valid", true);
          } else {
            event.Put("trace.valid", false);
            event.Put("trace.validation_error", "invalid_format");
          }
        }

# ä¸ºæ²¡æœ‰å…³è”IDçš„æ—¥å¿—ç”Ÿæˆä¸´æ—¶ID
- if:
    not:
      has_fields: ["trace.id"]
  then:
  - add_fields:
      target: "trace"
      fields:
        id: "no-trace-${kubernetes.pod.name}-${agent.id}"
        generated: true
```

### 6.4 åŸºäºå…³è”IDçš„æ—¥å¿—èšåˆ


**ğŸ“ˆ å…³è”IDèšåˆåˆ†æ**

```yaml
# æ·»åŠ å…³è”IDçš„ç»Ÿè®¡ä¿¡æ¯
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var traceId = event.Get("trace.id");
        var level = event.Get("log.level");
        var service = event.Get("service.name");
        
        if (traceId && service) {
          // ä¸ºèšåˆåˆ†ææ·»åŠ æ ‡è¯†
          event.Put("trace.service_key", traceId + "-" + service);
          
          // è®°å½•æœåŠ¡è°ƒç”¨é¡ºåº
          var timestamp = event.Get("@timestamp");
          if (timestamp) {
            event.Put("trace.event_order", timestamp);
          }
          
          // é”™è¯¯è¿½è¸ª
          if (level && (level === "ERROR" || level === "FATAL")) {
            event.Put("trace.has_error", true);
            event.Put("trace.error_service", service);
          }
        }
      }

# åŸºäºå…³è”IDçš„ç´¢å¼•ç­–ç•¥
- if:
    equals:
      trace.has_error: true
  then:
  - add_fields:
      target: "@metadata"
      fields:
        index_suffix: "errors"
        
- if:
    equals:
      trace.generated: true
  then:
  - add_fields:
      target: "@metadata"
      fields:
        index_suffix: "no-trace"
```

---

## 7. ğŸ“ å®Œæ•´é…ç½®ç¤ºä¾‹


### 7.1 ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®


```yaml
# filebeat.yml - å¾®æœåŠ¡æ—¥å¿—èšåˆå®Œæ•´é…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*.log'
  
  # åŸºç¡€è¿‡æ»¤
  exclude_lines: ['^DEBUG', '^TRACE', 'health-check']
  include_lines: ['ERROR', 'WARN', 'INFO', 'FATAL']
  
  # å¤šè¡Œæ—¥å¿—å¤„ç†
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500
  
  processors:
  # 1. æ·»åŠ Kuberneteså…ƒæ•°æ®
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      matchers:
      - logs_path:
          logs_path: "/var/log/containers/"
          resource_type: "container"
      include_labels: ["app", "version", "environment", "tier", "team"]
      include_annotations: ["deployment.version", "config.hash"]
      
  # 2. è§£æDockeræ—¥å¿—æ ¼å¼
  - decode_json_fields:
      fields: ["message"]
      target: ""
      overwrite_keys: true
      add_error_key: true
      
  # 3. è§£æåº”ç”¨JSONæ—¥å¿—
  - decode_json_fields:
      fields: ["log"]
      target: "app"
      overwrite_keys: false
      add_error_key: true
      
  # 4. æ ‡å‡†åŒ–æœåŠ¡ä¿¡æ¯
  - script:
      lang: javascript
      source: |
        function process(event) {
          var k8s = event.Get("kubernetes");
          if (k8s && k8s.labels) {
            // æœåŠ¡æ ‡è¯†
            event.Put("service.name", k8s.labels.app || "unknown");
            event.Put("service.version", k8s.labels.version || "unknown");
            event.Put("service.environment", k8s.labels.environment || "unknown");
            event.Put("service.tier", k8s.labels.tier || "unknown");
            event.Put("service.team", k8s.labels.team || "unknown");
            
            // å®¹å™¨ä¿¡æ¯
            if (k8s.container) {
              event.Put("container.name", k8s.container.name);
              event.Put("container.image", k8s.container.image);
            }
            
            // Podä¿¡æ¯
            if (k8s.pod) {
              event.Put("pod.name", k8s.pod.name);
              event.Put("pod.namespace", k8s.namespace);
              event.Put("pod.ip", k8s.pod.ip);
            }
          }
          
          // å¤„ç†åº”ç”¨æ—¥å¿—
          var app = event.Get("app");
          if (app) {
            // æ—¥å¿—çº§åˆ«æ ‡å‡†åŒ–
            if (app.level) {
              event.Put("log.level", app.level.toUpperCase());
            }
            
            // æå–å…³è”ID
            var traceId = app.correlation_id || app.trace_id || app.request_id;
            if (traceId) {
              event.Put("trace.id", traceId);
            }
            
            // æå–ç”¨æˆ·ä¿¡æ¯
            if (app.user) {
              event.Put("user.id", app.user.id);
              event.Put("user.email", app.user.email);
            }
            
            // æå–HTTPä¿¡æ¯
            if (app.http) {
              event.Put("http.request.method", app.http.method);
              event.Put("http.request.url", app.http.url);
              event.Put("http.response.status_code", app.http.status);
              event.Put("http.response.duration_ms", app.http.duration);
            }
            
            // æå–é”™è¯¯ä¿¡æ¯
            if (app.error) {
              event.Put("error.type", app.error.type);
              event.Put("error.message", app.error.message);
              event.Put("error.stack_trace", app.error.stack);
            }
          }
        }
        
  # 5. ç¯å¢ƒæ ‡è¯†å¤„ç†
  - if:
      equals:
        service.environment: "production"
    then:
    - add_fields:
        target: "deployment"
        fields:
          env_type: "prod"
          criticality: "high"
          alerting: "enabled"
    - add_tags:
        tags: ["production", "critical"]
        
  - if:
      equals:
        service.environment: "staging"
    then:
    - add_fields:
        target: "deployment"
        fields:
          env_type: "staging"
          criticality: "medium"
          alerting: "disabled"
    - add_tags:
        tags: ["staging", "testing"]
        
  # 6. æ€§èƒ½æŒ‡æ ‡å¤„ç†
  - if:
      has_fields: ["http.response.duration_ms"]
    then:
    - if:
        range:
          http.response.duration_ms:
            gte: 1000
      then:
      - add_tags:
          tags: ["slow_request"]
      - add_fields:
          target: "performance"
          fields:
            category: "slow"
            
  # 7. é”™è¯¯åˆ†ç±»
  - if:
      or:
        - equals:
            log.level: "ERROR"
        - equals:
            log.level: "FATAL"
    then:
    - add_tags:
        tags: ["error"]
    - if:
        has_fields: ["http.response.status_code"]
      then:
      - if:
          range:
            http.response.status_code:
              gte: 500
        then:
        - add_tags:
            tags: ["server_error"]
        - add_fields:
            target: "error"
            fields:
              category: "server_error"
              severity: "high"
              
  # 8. æ¸…ç†å­—æ®µ
  - drop_fields:
      fields: ["app", "log", "stream", "time", "kubernetes.labels", "message"]
      ignore_missing: true
      
  # 9. ç´¢å¼•è·¯ç”±
  - if:
      equals:
        service.environment: "production"
    then:
    - add_fields:
        target: "@metadata"
        fields:
          index_prefix: "prod-microservices"
  - if:
      equals:
        service.environment: "staging"
    then:
    - add_fields:
        target: "@metadata"
        fields:
          index_prefix: "staging-microservices"

# è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
  username: "${ELASTICSEARCH_USERNAME:}"
  password: "${ELASTICSEARCH_PASSWORD:}"
  
  # åŠ¨æ€ç´¢å¼•
  index: "%{[@metadata.index_prefix]:filebeat}-%{+yyyy.MM.dd}"
  
  # æ¨¡æ¿é…ç½®
  template.name: "microservices-logs"
  template.pattern: "*microservices*"
  template.settings:
    index.number_of_shards: 3
    index.number_of_replicas: 1
    index.refresh_interval: "5s"

# æ—¥å¿—è¾“å‡º
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
```

### 7.2 Kuberneteséƒ¨ç½²é…ç½®


```yaml
# kubernetes/filebeat-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: kube-system
data:
  filebeat.yml: |
    # ä¸Šé¢çš„å®Œæ•´é…ç½®å†…å®¹
    
---
# kubernetes/filebeat-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
spec:
  selector:
    matchLabels:
      app: filebeat
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      serviceAccountName: filebeat
      terminationGracePeriodSeconds: 30
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: filebeat
        image: elastic/filebeat:8.11.0
        args: [
          "-c", "/etc/filebeat.yml",
          "-e",
        ]
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: ELASTICSEARCH_HOSTS
          value: "elasticsearch-master:9200"
        - name: ELASTICSEARCH_USERNAME
          value: "elastic"
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-credentials
              key: password
        securityContext:
          runAsUser: 0
          privileged: true
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - name: config
          mountPath: /etc/filebeat.yml
          readOnly: true
          subPath: filebeat.yml
        - name: data
          mountPath: /usr/share/filebeat/data
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: varlogcontainers
          mountPath: /var/log/containers
          readOnly: true
        - name: varlogpods
          mountPath: /var/log/pods
          readOnly: true
      volumes:
      - name: config
        configMap:
          defaultMode: 0640
          name: filebeat-config
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: varlogcontainers
        hostPath:
          path: /var/log/containers
      - name: varlogpods
        hostPath:
          path: /var/log/pods
      - name: data
        hostPath:
          path: /var/lib/filebeat-data
          type: DirectoryOrCreate

---
# kubernetes/filebeat-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: filebeat
rules:
- apiGroups: [""]
  resources:
  - nodes
  - namespaces
  - pods
  - services
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources:
  - replicasets
  verbs: ["get", "list", "watch"]

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: filebeat
  namespace: kube-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: filebeat
subjects:
- kind: ServiceAccount
  name: filebeat
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: filebeat
  apiGroup: rbac.authorization.k8s.io
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¾®æœåŠ¡æ—¥å¿—èšåˆï¼šç»Ÿä¸€æ”¶é›†åˆ†æ•£çš„å¾®æœåŠ¡æ—¥å¿—
ğŸ”¸ å®¹å™¨åŒ–æ—¥å¿—æ”¶é›†ï¼šå¤„ç†Dockerå’ŒKubernetesç¯å¢ƒçš„æ—¥å¿—
ğŸ”¸ å…ƒæ•°æ®å¢å¼ºï¼šæ·»åŠ æœåŠ¡ã€Podã€å®¹å™¨ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯
ğŸ”¸ JSONæ—¥å¿—å¤„ç†ï¼šè§£æå’Œæ ‡å‡†åŒ–ç»“æ„åŒ–æ—¥å¿—
ğŸ”¸ å…³è”IDè·Ÿè¸ªï¼šé€šè¿‡å”¯ä¸€æ ‡è¯†ç¬¦è¿½è¸ªè¯·æ±‚é“¾è·¯
ğŸ”¸ æ ‡ç­¾ä¸å‘½åç©ºé—´ï¼šåŸºäºK8sæ ‡ç­¾è¿›è¡Œæ—¥å¿—åˆ†ç±»å’Œè·¯ç”±
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ å®¹å™¨æ—¥å¿—æ”¶é›†**
```
é‡è¦é…ç½®ï¼š
- æ­£ç¡®çš„æ—¥å¿—è·¯å¾„ï¼š/var/log/containers/*.log
- Dockerå…ƒæ•°æ®ï¼šadd_docker_metadataå¤„ç†å™¨
- å¤šè¡Œæ—¥å¿—ï¼šmultilineé…ç½®å¤„ç†å¼‚å¸¸å †æ ˆ
- å®¹å™¨è¿‡æ»¤ï¼šåŸºäºæ ‡ç­¾é€‰æ‹©è¦æ”¶é›†çš„å®¹å™¨
```

**ğŸ”¹ Kubernetesé›†æˆ**
```
æ ¸å¿ƒç»„ä»¶ï¼š
- add_kubernetes_metadataï¼šè‡ªåŠ¨æ·»åŠ K8så…ƒæ•°æ®
- DaemonSetéƒ¨ç½²ï¼šç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰Filebeat
- RBACæƒé™ï¼šè®¿é—®K8s APIçš„å¿…è¦æƒé™
- èŠ‚ç‚¹ä¿¡æ¯ï¼šNODE_NAMEç¯å¢ƒå˜é‡è·å–èŠ‚ç‚¹ä¿¡æ¯
```

**ğŸ”¹ æœåŠ¡æ ‡è¯†å¤„ç†**
```
æ ‡è¯†å±‚æ¬¡ï¼š
- åº”ç”¨çº§åˆ«ï¼šåº”ç”¨åã€ç‰ˆæœ¬ã€ç¯å¢ƒ
- æœåŠ¡çº§åˆ«ï¼šæœåŠ¡åã€ç»„ä»¶ã€å›¢é˜Ÿ
- å®ä¾‹çº§åˆ«ï¼šPodåã€å®¹å™¨åã€èŠ‚ç‚¹å
- ä¸šåŠ¡çº§åˆ«ï¼šåŠŸèƒ½æ¨¡å—ã€APIç‰ˆæœ¬
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è¿ç»´ç›‘æ§**
- **é›†ä¸­æ—¥å¿—**ï¼šæ‰€æœ‰å¾®æœåŠ¡æ—¥å¿—ç»Ÿä¸€æŸ¥çœ‹
- **é—®é¢˜å®šä½**ï¼šé€šè¿‡å…³è”IDå¿«é€Ÿè¿½è¸ªé—®é¢˜
- **æ€§èƒ½ç›‘æ§**ï¼šåˆ†ææœåŠ¡å“åº”æ—¶é—´å’Œé”™è¯¯ç‡
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºæ—¥å¿—é‡å’Œè®¿é—®æ¨¡å¼è§„åˆ’èµ„æº

**ğŸ”§ å¼€å‘è°ƒè¯•**
- **é“¾è·¯è¿½è¸ª**ï¼šæŸ¥çœ‹è¯·æ±‚åœ¨æœåŠ¡é—´çš„å®Œæ•´è·¯å¾„
- **é”™è¯¯è¯Šæ–­**ï¼šå¿«é€Ÿå®šä½é”™è¯¯å‘ç”Ÿçš„å…·ä½“æœåŠ¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè¯†åˆ«æ…¢è¯·æ±‚å’Œæ€§èƒ½ç“¶é¢ˆ
- **åŠŸèƒ½éªŒè¯**ï¼šéªŒè¯æ–°åŠŸèƒ½åœ¨å¤šæœåŠ¡ç¯å¢ƒä¸­çš„è¡¨ç°

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“Š é…ç½®ä¼˜åŒ–**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
- åˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°
- ä½¿ç”¨include_linesè¿‡æ»¤æ— ç”¨æ—¥å¿—
- é¿å…è¿‡åº¦çš„æ­£åˆ™è¡¨è¾¾å¼å¤„ç†
- å®šæœŸæ¸…ç†æ—§çš„æ—¥å¿—æ–‡ä»¶

èµ„æºç®¡ç†ï¼š
- è®¾ç½®åˆé€‚çš„CPUå’Œå†…å­˜é™åˆ¶
- ç›‘æ§Filebeatçš„èµ„æºä½¿ç”¨æƒ…å†µ
- é¿å…æ—¥å¿—çˆ†å‘å¯¼è‡´çš„èµ„æºè€—å°½
```

**ğŸ”’ å®‰å…¨è€ƒè™‘**
```
æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ï¼š
- è¿‡æ»¤æ•æ„Ÿå­—æ®µï¼ˆå¯†ç ã€tokenç­‰ï¼‰
- ä½¿ç”¨å­—æ®µæ©ç å¤„ç†ä¸ªäººä¿¡æ¯
- é…ç½®é€‚å½“çš„ç½‘ç»œè®¿é—®æ§åˆ¶
- å®šæœŸè½®æ¢è®¿é—®å‡­è¯
```

**ğŸ“ˆ ç›‘æ§å‘Šè­¦**
```
å…³é”®æŒ‡æ ‡ï¼š
- Filebeatå­˜æ´»çŠ¶æ€
- æ—¥å¿—å¤„ç†é€Ÿåº¦
- é”™è¯¯ç‡å’Œä¸¢å¤±ç‡
- Elasticsearchè¿æ¥çŠ¶æ€
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¾®æœåŠ¡æ—¥å¿—èšåˆæ˜¯ç°ä»£åº”ç”¨ç›‘æ§çš„åŸºç¡€
- Kuberneteså…ƒæ•°æ®ä¸ºæ—¥å¿—æä¾›äº†ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- å…³è”IDæ˜¯è¿½è¸ªåˆ†å¸ƒå¼è¯·æ±‚çš„å…³é”®
- JSONæ ¼å¼æ—¥å¿—æä¾›äº†æœ€å¥½çš„ç»“æ„åŒ–æ•°æ®æ”¯æŒ
- åˆç†çš„é…ç½®å’Œç›‘æ§æ˜¯ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œçš„ä¿éšœ