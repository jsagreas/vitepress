---
title: 28ã€å¤šèŠ‚ç‚¹é…ç½®ä¸è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤é…ç½®åŸºç¡€æ¦‚å¿µ](#1-é›†ç¾¤é…ç½®åŸºç¡€æ¦‚å¿µ)
2. [å¤šèŠ‚ç‚¹åœ°å€é…ç½®è¯¦è§£](#2-å¤šèŠ‚ç‚¹åœ°å€é…ç½®è¯¦è§£)
3. [è´Ÿè½½å‡è¡¡æœºåˆ¶é…ç½®](#3-è´Ÿè½½å‡è¡¡æœºåˆ¶é…ç½®)
4. [å·¥ä½œçº¿ç¨‹ä¼˜åŒ–é…ç½®](#4-å·¥ä½œçº¿ç¨‹ä¼˜åŒ–é…ç½®)
5. [èŠ‚ç‚¹å‘ç°ä¸å—…æ¢åŠŸèƒ½](#5-èŠ‚ç‚¹å‘ç°ä¸å—…æ¢åŠŸèƒ½)
6. [åˆ†å¸ƒå¼ç®¡é“ä¸ç´¢å¼•è®¾ç½®](#6-åˆ†å¸ƒå¼ç®¡é“ä¸ç´¢å¼•è®¾ç½®)
7. [å®æˆ˜é…ç½®ç¤ºä¾‹](#7-å®æˆ˜é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ é›†ç¾¤é…ç½®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Filebeaté›†ç¾¤é…ç½®


**é€šä¿—ç†è§£**ï¼šå°±åƒå¿«é€’å…¬å¸æœ‰å¤šä¸ªåˆ†æ‹£ä¸­å¿ƒï¼ŒFilebeaté›†ç¾¤å°±æ˜¯è®©æ—¥å¿—æ•°æ®å¯ä»¥å‘é€åˆ°å¤šä¸ªElasticsearchèŠ‚ç‚¹ï¼Œç¡®ä¿æœåŠ¡ä¸ä¼šå› ä¸ºå•ç‚¹æ•…éšœè€Œä¸­æ–­ã€‚

```
å•èŠ‚ç‚¹æ¨¡å¼ï¼ˆæœ‰é£é™©ï¼‰ï¼š
æ—¥å¿—æ–‡ä»¶ â†’ Filebeat â†’ å•ä¸ªESèŠ‚ç‚¹
                      â†“
                   æœåŠ¡å™¨æŒ‚äº† = æ•°æ®ä¸¢å¤±

é›†ç¾¤æ¨¡å¼ï¼ˆæ›´å®‰å…¨ï¼‰ï¼š
              â”Œâ†’ ESèŠ‚ç‚¹1
æ—¥å¿—æ–‡ä»¶ â†’ Filebeat â”¼â†’ ESèŠ‚ç‚¹2  
              â””â†’ ESèŠ‚ç‚¹3
            ä»»ä½•ä¸€ä¸ªæŒ‚äº†ï¼Œå…¶ä»–è¿˜èƒ½å·¥ä½œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤é…ç½®


**æ ¸å¿ƒåŸå› **ï¼š
- ğŸ”¸ **é«˜å¯ç”¨æ€§**ï¼šä¸€å°æœåŠ¡å™¨æŒ‚äº†ï¼Œå…¶ä»–è¿˜èƒ½ç»§ç»­å·¥ä½œ
- ğŸ”¸ **è´Ÿè½½åˆ†æ•£**ï¼šå¤šå°æœåŠ¡å™¨åˆ†æ‹…å‹åŠ›ï¼Œæ€§èƒ½æ›´å¥½
- ğŸ”¸ **æ•°æ®å®‰å…¨**ï¼šä¸ä¼šå› ä¸ºå•ç‚¹æ•…éšœä¸¢å¤±é‡è¦æ—¥å¿—
- ğŸ”¸ **æ‰©å±•æ€§å¼º**ï¼šä¸šåŠ¡å¢é•¿æ—¶å¯ä»¥éšæ—¶æ·»åŠ æ–°èŠ‚ç‚¹

**ç”Ÿæ´»åŒ–ç±»æ¯”**ï¼š
```
å°±åƒé“¶è¡Œå¼€å¤šä¸ªç½‘ç‚¹ï¼š
â€¢ ä¸€ä¸ªç½‘ç‚¹æ’é˜Ÿå¤ªé•¿ â†’ å¯ä»¥å»å…¶ä»–ç½‘ç‚¹
â€¢ ä¸€ä¸ªç½‘ç‚¹è®¾å¤‡æ•…éšœ â†’ å…¶ä»–ç½‘ç‚¹æ­£å¸¸è¥ä¸š  
â€¢ å®¢æˆ·å¤šäº† â†’ å¯ä»¥æ–°å¼€ç½‘ç‚¹åˆ†æµ
```

---

## 2. ğŸ“¡ å¤šèŠ‚ç‚¹åœ°å€é…ç½®è¯¦è§£


### 2.1 hostså¤šèŠ‚ç‚¹é…ç½®åŸç†


**hostså‚æ•°çš„ä½œç”¨**ï¼šå‘Šè¯‰Filebeatæœ‰å“ªäº›ElasticsearchèŠ‚ç‚¹å¯ä»¥è¿æ¥ï¼Œå°±åƒé€šè®¯å½•é‡Œå­˜äº†å¤šä¸ªè”ç³»æ–¹å¼ã€‚

**åŸºç¡€é…ç½®æ ¼å¼**ï¼š
```yaml
output.elasticsearch:
  hosts: ["http://es1:9200", "http://es2:9200", "http://es3:9200"]
```

### 2.2 è¯¦ç»†é…ç½®è¯´æ˜


**ğŸ”¸ æ ‡å‡†IPåœ°å€é…ç½®**
```yaml
output.elasticsearch:
  hosts: 
    - "http://192.168.1.10:9200"
    - "http://192.168.1.11:9200" 
    - "http://192.168.1.12:9200"
  
  # è¿æ¥è¶…æ—¶è®¾ç½®ï¼ˆç­‰å¤šä¹…ç®—è¿ä¸ä¸Šï¼‰
  timeout: 90s
  
  # æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆè¿ä¸ä¸Šé‡è¯•å‡ æ¬¡ï¼‰
  max_retries: 3
```

**ğŸ”¸ åŸŸåé…ç½®æ–¹å¼**
```yaml
output.elasticsearch:
  hosts:
    - "https://es-node1.company.com:9200"
    - "https://es-node2.company.com:9200"
    - "https://es-node3.company.com:9200"
```

### 2.3 è¿æ¥ä¼˜å…ˆçº§ä¸æ•…éšœè½¬ç§»


**è¿æ¥é€»è¾‘è§£é‡Š**ï¼š
```
Filebeatçš„æ™ºèƒ½è¿æ¥æœºåˆ¶ï¼š
1. æŒ‰é¡ºåºå°è¯•è¿æ¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
2. å¦‚æœç¬¬ä¸€ä¸ªè¿ä¸ä¸Šï¼Œè‡ªåŠ¨å°è¯•ç¬¬äºŒä¸ª
3. å¦‚æœéƒ½è¿ä¸ä¸Šï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡æ–°å°è¯•
4. ä¸€æ—¦æŸä¸ªèŠ‚ç‚¹æ¢å¤ï¼Œç«‹å³æ¢å¤è¿æ¥

è¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œä¸éœ€è¦äººå·¥å¹²é¢„ï¼
```

**é«˜çº§é…ç½®ç¤ºä¾‹**ï¼š
```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  
  # è¿æ¥å¤±è´¥åçš„é‡è¯•é—´éš”
  backoff.init: 1s      # åˆå§‹ç­‰å¾…1ç§’
  backoff.max: 60s      # æœ€å¤§ç­‰å¾…60ç§’
  
  # å¥åº·æ£€æŸ¥ï¼ˆå®šæœŸæµ‹è¯•è¿æ¥ï¼‰
  check_es_ready: true
```

---

## 3. âš–ï¸ è´Ÿè½½å‡è¡¡æœºåˆ¶é…ç½®


### 3.1 loadbalanceå‚æ•°è¯¦è§£


**è´Ÿè½½å‡è¡¡çš„é€šä¿—ç†è§£**ï¼šå°±åƒè¶…å¸‚å¼€å¤šä¸ªæ”¶é“¶å°ï¼Œé¡¾å®¢å¯ä»¥é€‰æ‹©æ’é˜Ÿäººå°‘çš„é‚£ä¸ªï¼Œè¿™æ ·æ•´ä½“æ•ˆç‡æ›´é«˜ã€‚

```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  loadbalance: true  # å¼€å¯è´Ÿè½½å‡è¡¡
```

### 3.2 è´Ÿè½½å‡è¡¡å·¥ä½œåŸç†


**é»˜è®¤è¡Œä¸ºï¼ˆä¸å¼€å¯è´Ÿè½½å‡è¡¡ï¼‰**ï¼š
```
å›ºå®šé¡ºåºè¿æ¥ï¼š
Filebeat â†’ æ€»æ˜¯å…ˆè¿es1 â†’ es1æŒ‚äº†æ‰è¿es2 â†’ es2æŒ‚äº†æ‰è¿es3

é—®é¢˜ï¼šes1å‹åŠ›å¤§ï¼Œes2å’Œes3é—²ç€
```

**å¼€å¯è´Ÿè½½å‡è¡¡å**ï¼š
```
è½®æµåˆ†é…è¿æ¥ï¼š
ç¬¬1æ¬¡å‘é€ â†’ es1
ç¬¬2æ¬¡å‘é€ â†’ es2  
ç¬¬3æ¬¡å‘é€ â†’ es3
ç¬¬4æ¬¡å‘é€ â†’ es1 (å¾ªç¯ç»§ç»­)

ç»“æœï¼šä¸‰å°æœåŠ¡å™¨å‹åŠ›å¹³å‡åˆ†æ‹…
```

### 3.3 è´Ÿè½½å‡è¡¡ç­–ç•¥é…ç½®


**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```yaml
output.elasticsearch:
  hosts: 
    - "http://es1:9200"
    - "http://es2:9200"
    - "http://es3:9200"
  
  # å¯ç”¨è´Ÿè½½å‡è¡¡
  loadbalance: true
  
  # æ‰¹é‡å‘é€è®¾ç½®ï¼ˆæé«˜æ•ˆç‡ï¼‰
  bulk_max_size: 3200      # ä¸€æ¬¡æœ€å¤šå‘é€3200æ¡è®°å½•
  flush_interval: 1s       # æœ€é•¿1ç§’å‘é€ä¸€æ¬¡
```

**è´Ÿè½½å‡è¡¡ä¸æ€§èƒ½å…³ç³»**ï¼š
```
ä¸å‡è¡¡çš„åæœï¼š
es1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (è¿‡è½½ï¼Œå“åº”æ…¢)
es2: â–ˆâ–ˆâ–ˆâ–ˆ         (è½»æ¾ï¼Œèµ„æºæµªè´¹)
es3: â–ˆâ–ˆâ–ˆâ–ˆ         (è½»æ¾ï¼Œèµ„æºæµªè´¹)

è´Ÿè½½å‡è¡¡åï¼š
es1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (åˆç†è´Ÿè½½)
es2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (åˆç†è´Ÿè½½)  
es3: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     (åˆç†è´Ÿè½½)
```

---

## 4. ğŸ”§ å·¥ä½œçº¿ç¨‹ä¼˜åŒ–é…ç½®


### 4.1 workerå‚æ•°çš„ä½œç”¨


**é€šä¿—è§£é‡Š**ï¼šworkerå°±åƒå·¥å‚é‡Œçš„å·¥äººæ•°é‡ï¼Œå·¥äººå¤šäº†ç”Ÿäº§æ•ˆç‡é«˜ï¼Œä½†å¤ªå¤šäº†ä¹Ÿä¼šäº’ç›¸å¹²æ‰°ã€‚

```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  worker: 2  # è®¾ç½®2ä¸ªå·¥ä½œçº¿ç¨‹
```

### 4.2 å¦‚ä½•é€‰æ‹©workeræ•°é‡


**é€‰æ‹©åŸåˆ™**ï¼š
```
æœåŠ¡å™¨é…ç½®å‚è€ƒï¼š
â€¢ 2æ ¸CPU    â†’ worker: 1-2
â€¢ 4æ ¸CPU    â†’ worker: 2-4  
â€¢ 8æ ¸CPU    â†’ worker: 4-6
â€¢ 16æ ¸ä»¥ä¸Š  â†’ worker: 6-8

ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼å¤ªå¤šåè€Œä¼šï¼š
âœ— å¢åŠ CPUåˆ‡æ¢å¼€é”€
âœ— å†…å­˜å ç”¨å¢åŠ 
âœ— ç½‘ç»œè¿æ¥è¿‡å¤š
```

**å®é™…é…ç½®å»ºè®®**ï¼š
```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  
  # æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´
  worker: 4
  
  # é…åˆæ‰¹å¤„ç†ä¼˜åŒ–
  bulk_max_size: 1600    # æ¯ä¸ªworkerå‘é€1600æ¡
  compression_level: 1   # è½»åº¦å‹ç¼©ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
```

### 4.3 workerä¸å†…å­˜å…³ç³»


**å†…å­˜è®¡ç®—å…¬å¼**ï¼š
```
å¤§æ¦‚å†…å­˜ä½¿ç”¨ = workeræ•°é‡ Ã— bulk_max_size Ã— å¹³å‡æ—¥å¿—å¤§å°

ç¤ºä¾‹è®¡ç®—ï¼š
worker: 4
bulk_max_size: 1600
å¹³å‡æ—¥å¿—: 500å­—èŠ‚
å†…å­˜ä½¿ç”¨ â‰ˆ 4 Ã— 1600 Ã— 500å­—èŠ‚ â‰ˆ 3.2MB

è¿™æ˜¯æ¯æ‰¹æ¬¡çš„å†…å­˜ä½¿ç”¨é‡
```

---

## 5. ğŸ” èŠ‚ç‚¹å‘ç°ä¸å—…æ¢åŠŸèƒ½


### 5.1 discoveryèŠ‚ç‚¹å‘ç°é…ç½®


**èŠ‚ç‚¹å‘ç°çš„ä½œç”¨**ï¼šè®©Filebeatè‡ªåŠ¨æ‰¾åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œå°±åƒå¾®ä¿¡ä¼šè‡ªåŠ¨å‘ç°é™„è¿‘çš„æœ‹å‹ã€‚

```yaml
output.elasticsearch:
  hosts: ["es1:9200"]  # åªéœ€è¦é…ç½®ä¸€ä¸ªå…¥å£èŠ‚ç‚¹
  
  # å¯ç”¨èŠ‚ç‚¹å‘ç°
  sniffing: true
  sniff_interval: 5m    # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ–°èŠ‚ç‚¹
```

### 5.2 sniffingå—…æ¢åŠŸèƒ½è¯¦è§£


**å·¥ä½œåŸç†è¯´æ˜**ï¼š
```
ä¼ ç»Ÿé…ç½®ï¼š
hosts: ["es1:9200", "es2:9200", "es3:9200"]
â†“
éœ€è¦æ‰‹åŠ¨é…ç½®æ‰€æœ‰èŠ‚ç‚¹åœ°å€

å¯ç”¨å—…æ¢åï¼š
hosts: ["es1:9200"]  # åªé…ç½®ä¸€ä¸ª
â†“
Filebeatè‡ªåŠ¨å‘ç°ï¼šes1, es2, es3, es4...
â†“  
åŠ¨æ€æ›´æ–°èŠ‚ç‚¹åˆ—è¡¨
```

**å®Œæ•´å—…æ¢é…ç½®**ï¼š
```yaml
output.elasticsearch:
  hosts: ["http://es-master:9200"]
  
  # å—…æ¢é…ç½®
  sniffing: true
  sniff_interval: 5m           # æ£€æŸ¥é¢‘ç‡
  sniff_retries: 3             # å‘ç°å¤±è´¥é‡è¯•æ¬¡æ•°
  sniff_timeout: 2s            # å—…æ¢è¶…æ—¶æ—¶é—´
```

### 5.3 å—…æ¢åŠŸèƒ½çš„ä¼˜ç¼ºç‚¹


**ä¼˜åŠ¿åˆ†æ**ï¼š
- âœ… **è‡ªåŠ¨å‘ç°**ï¼šæ–°å¢èŠ‚ç‚¹æ— éœ€ä¿®æ”¹é…ç½®
- âœ… **æ•…éšœæ„ŸçŸ¥**ï¼šè‡ªåŠ¨å‰”é™¤æ•…éšœèŠ‚ç‚¹
- âœ… **é…ç½®ç®€åŒ–**ï¼šåªéœ€é…ç½®ä¸€ä¸ªå…¥å£èŠ‚ç‚¹

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ **ç½‘ç»œå®‰å…¨**ï¼šç¡®ä¿ç½‘ç»œç¯å¢ƒå®‰å…¨
- âš ï¸ **æƒé™æ§åˆ¶**ï¼šå—…æ¢éœ€è¦ç›¸åº”æƒé™
- âš ï¸ **ç½‘ç»œå»¶è¿Ÿ**ï¼šé¢‘ç¹å—…æ¢å¯èƒ½å¢åŠ ç½‘ç»œå¼€é”€

```yaml
# ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½®
output.elasticsearch:
  hosts: ["https://es-lb.company.com:9200"]
  
  # è°¨æ…å¯ç”¨å—…æ¢
  sniffing: false              # ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­
  loadbalance: true            # æ‰‹åŠ¨é…ç½®è´Ÿè½½å‡è¡¡
  
  # å®‰å…¨é…ç½®
  ssl.verification_mode: full
  username: "filebeat_user"
  password: "${ELASTIC_PASSWORD}"
```

---

## 6. ğŸ”„ åˆ†å¸ƒå¼ç®¡é“ä¸ç´¢å¼•è®¾ç½®


### 6.1 pipelineåˆ†å¸ƒå¼ç®¡é“é…ç½®


**ç®¡é“çš„ä½œç”¨**ï¼šå°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œå¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†åå†å­˜å‚¨ã€‚

```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  
  # æŒ‡å®šå¤„ç†ç®¡é“
  pipeline: "filebeat-nginx-pipeline"
```

**ç®¡é“å¤„ç†æµç¨‹**ï¼š
```
åŸå§‹æ—¥å¿— â†’ Filebeat â†’ ESç®¡é“å¤„ç† â†’ æ ¼å¼åŒ–å­˜å‚¨

ä¾‹å¦‚Nginxæ—¥å¿—ï¼š
192.168.1.1 - - [21/Sep/2025:10:30:25] "GET /api/users" 200
        â†“ ç®¡é“å¤„ç†å â†“
{
  "client_ip": "192.168.1.1",
  "timestamp": "2025-09-21T10:30:25",
  "method": "GET",
  "url": "/api/users",
  "status": 200
}
```

### 6.2 template.settingsç´¢å¼•è®¾ç½®


**ç´¢å¼•æ¨¡æ¿çš„ä½œç”¨**ï¼šé¢„å…ˆå®šä¹‰æ•°æ®çš„å­˜å‚¨è§„åˆ™ï¼Œå°±åƒæå‰è®¾è®¡å¥½æ•°æ®åº“çš„è¡¨ç»“æ„ã€‚

```yaml
setup.template.enabled: true
setup.template.settings:
  # ç´¢å¼•åˆ†ç‰‡è®¾ç½®
  index.number_of_shards: 3      # æ•°æ®åˆ†æˆ3ç‰‡å­˜å‚¨
  index.number_of_replicas: 1    # æ¯ç‰‡æ•°æ®å¤‡ä»½1ä»½
  
  # æ€§èƒ½ä¼˜åŒ–è®¾ç½®
  index.refresh_interval: "30s"  # 30ç§’åˆ·æ–°ä¸€æ¬¡ç´¢å¼•
  index.codec: "best_compression" # ä½¿ç”¨æœ€ä½³å‹ç¼©
```

**åˆ†ç‰‡ä¸å‰¯æœ¬å›¾è§£**ï¼š
```
3ä¸ªåˆ†ç‰‡ + 1ä¸ªå‰¯æœ¬çš„åˆ†å¸ƒï¼š

Node1: [åˆ†ç‰‡1] [åˆ†ç‰‡2å‰¯æœ¬] [åˆ†ç‰‡3å‰¯æœ¬]
Node2: [åˆ†ç‰‡2] [åˆ†ç‰‡3å‰¯æœ¬] [åˆ†ç‰‡1å‰¯æœ¬]  
Node3: [åˆ†ç‰‡3] [åˆ†ç‰‡1å‰¯æœ¬] [åˆ†ç‰‡2å‰¯æœ¬]

å¥½å¤„ï¼š
â€¢ æ•°æ®åˆ†æ•£å­˜å‚¨ï¼ŒæŸ¥è¯¢å¹¶è¡Œå¤„ç†
â€¢ ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œæ•°æ®ä¸ä¸¢å¤±
â€¢ è¯»å–æ€§èƒ½æå‡ï¼ˆå¯ä»¥ä»å‰¯æœ¬è¯»å–ï¼‰
```

### 6.3 å®Œæ•´çš„æ¨¡æ¿é…ç½®ç¤ºä¾‹


```yaml
# ç´¢å¼•æ¨¡æ¿é…ç½®
setup.template.enabled: true
setup.template.name: "filebeat-nginx"
setup.template.pattern: "filebeat-nginx-*"

setup.template.settings:
  # åŸºç¡€è®¾ç½®
  index.number_of_shards: 3
  index.number_of_replicas: 1
  
  # æ€§èƒ½è°ƒä¼˜
  index.refresh_interval: "30s"
  index.max_result_window: 50000
  
  # ç”Ÿå‘½å‘¨æœŸç®¡ç†
  index.lifecycle.name: "filebeat-policy"
  index.lifecycle.rollover_alias: "filebeat-nginx"

# å­—æ®µæ˜ å°„
setup.template.mappings:
  properties:
    "@timestamp":
      type: "date"
    message:
      type: "text"
      analyzer: "standard"
```

---

## 7. ğŸ› ï¸ å®æˆ˜é…ç½®ç¤ºä¾‹


### 7.1 ä¸­å°å‹ä¼ä¸šé…ç½®


**åœºæ™¯æè¿°**ï¼š3å°ElasticsearchèŠ‚ç‚¹ï¼Œå¤„ç†ç½‘ç«™å’Œåº”ç”¨æ—¥å¿—

```yaml
# filebeat.yml - ä¸­å°ä¼ä¸šæ ‡å‡†é…ç½®
filebeat.inputs:
- type: filestream
  id: nginx-logs
  paths:
    - "/var/log/nginx/*.log"
  fields:
    logtype: nginx
    environment: production

output.elasticsearch:
  # å¤šèŠ‚ç‚¹é…ç½®
  hosts: 
    - "http://es-node1.company.local:9200"
    - "http://es-node2.company.local:9200"
    - "http://es-node3.company.local:9200"
  
  # è´Ÿè½½å‡è¡¡è®¾ç½®
  loadbalance: true
  worker: 2
  
  # æ‰¹å¤„ç†ä¼˜åŒ–
  bulk_max_size: 1600
  flush_interval: 1s
  timeout: 60s
  
  # é‡è¯•æœºåˆ¶
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s

# ç´¢å¼•ç®¡ç†
setup.template.enabled: true
setup.template.settings:
  index.number_of_shards: 1
  index.number_of_replicas: 1
  index.refresh_interval: "30s"

# ç›‘æ§é…ç½®
monitoring.enabled: true
logging.level: info
```

### 7.2 å¤§å‹ä¼ä¸šé«˜å¯ç”¨é…ç½®


**åœºæ™¯æè¿°**ï¼š6å°ESèŠ‚ç‚¹ï¼Œé«˜å¹¶å‘ç¯å¢ƒï¼Œéœ€è¦æœ€é«˜å¯ç”¨æ€§

```yaml
# filebeat.yml - å¤§å‹ä¼ä¸šé«˜å¯ç”¨é…ç½®
filebeat.inputs:
- type: filestream
  id: application-logs
  paths:
    - "/opt/apps/*/logs/*.log"
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after

output.elasticsearch:
  # 6èŠ‚ç‚¹é›†ç¾¤é…ç½®
  hosts:
    - "https://es-data1.corp.com:9200"
    - "https://es-data2.corp.com:9200" 
    - "https://es-data3.corp.com:9200"
    - "https://es-data4.corp.com:9200"
    - "https://es-data5.corp.com:9200"
    - "https://es-data6.corp.com:9200"
  
  # é«˜æ€§èƒ½é…ç½®
  loadbalance: true
  worker: 4
  bulk_max_size: 3200
  flush_interval: 500ms
  compression_level: 1
  
  # å®‰å…¨é…ç½®
  ssl.verification_mode: "certificate"
  ssl.certificate_authorities: ["/etc/filebeat/ca.crt"]
  username: "filebeat_writer"
  password: "${ES_PASSWORD}"
  
  # ç®¡é“å¤„ç†
  pipeline: "enterprise-log-pipeline"

# é«˜çº§ç´¢å¼•è®¾ç½®
setup.template.enabled: true
setup.template.settings:
  index.number_of_shards: 6
  index.number_of_replicas: 2
  index.refresh_interval: "10s"
  index.codec: "best_compression"
  
# ILMç”Ÿå‘½å‘¨æœŸç®¡ç†
setup.ilm.enabled: true
setup.ilm.policy: {
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "5GB",
            "max_age": "1d"
          }
        }
      },
      "warm": {
        "min_age": "7d",
        "actions": {
          "allocate": {
            "number_of_replicas": 0
          }
        }
      },
      "delete": {
        "min_age": "30d"
      }
    }
  }
}
```

### 7.3 äº‘ç¯å¢ƒé…ç½®ç¤ºä¾‹


**åœºæ™¯æè¿°**ï¼šä½¿ç”¨äº‘æœåŠ¡å•†çš„Elasticsearché›†ç¾¤

```yaml
# äº‘ç¯å¢ƒé…ç½® - å¼¹æ€§ä¼¸ç¼©
output.elasticsearch:
  # äº‘ç«¯è´Ÿè½½å‡è¡¡åœ°å€
  hosts: ["https://es-cluster.region.cloud.com:9200"]
  
  # è‡ªåŠ¨å‘ç°é…ç½®
  sniffing: true
  sniff_interval: 10m
  sniff_retries: 5
  
  # äº‘ç¯å¢ƒä¼˜åŒ–
  worker: 3
  bulk_max_size: 2048
  timeout: 120s
  
  # APIå¯†é’¥è®¤è¯
  api_key: "${ELASTIC_API_KEY}"
  
  # äº‘ç«¯ç®¡é“
  pipeline: "cloud-processing-pipeline"

# äº‘ç›‘æ§é›†æˆ
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["https://monitoring.cloud.com:9200"]
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤é…ç½®æœ¬è´¨ï¼šå¤šèŠ‚ç‚¹åä½œï¼Œæä¾›é«˜å¯ç”¨å’Œé«˜æ€§èƒ½
ğŸ”¸ hostsé…ç½®ï¼šå‘Šè¯‰Filebeatæœ‰å“ªäº›ESèŠ‚ç‚¹å¯è¿æ¥
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šè®©å¤šä¸ªèŠ‚ç‚¹å¹³å‡åˆ†æ‹…å·¥ä½œå‹åŠ›
ğŸ”¸ å·¥ä½œçº¿ç¨‹ï¼šæ§åˆ¶å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œéœ€è¦æ ¹æ®ç¡¬ä»¶è°ƒä¼˜
ğŸ”¸ èŠ‚ç‚¹å‘ç°ï¼šè‡ªåŠ¨æ‰¾åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹
ğŸ”¸ ç´¢å¼•æ¨¡æ¿ï¼šé¢„å®šä¹‰æ•°æ®å­˜å‚¨ç»“æ„å’Œä¼˜åŒ–ç­–ç•¥
```

### 8.2 é…ç½®é€‰æ‹©å†³ç­–è¡¨


| ç¯å¢ƒè§„æ¨¡ | **èŠ‚ç‚¹æ•°é‡** | **workerè®¾ç½®** | **è´Ÿè½½å‡è¡¡** | **å—…æ¢åŠŸèƒ½** |
|---------|------------|--------------|------------|------------|
| **å°å‹** | `2-3ä¸ª` | `1-2` | `å¯ç”¨` | `å¯é€‰` |
| **ä¸­å‹** | `3-6ä¸ª` | `2-4` | `å¯ç”¨` | `å»ºè®®å¯ç”¨` |
| **å¤§å‹** | `6+ä¸ª` | `4-8` | `å¿…é¡»å¯ç”¨` | `è°¨æ…å¯ç”¨` |
| **äº‘ç«¯** | `å¼¹æ€§` | `3-6` | `å¯ç”¨` | `æ¨èå¯ç”¨` |

### 8.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**å…³é”®å‚æ•°é…ç½®å»ºè®®**ï¼š
```yaml
# é€šç”¨é«˜æ€§èƒ½é…ç½®æ¨¡æ¿
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  
  # æ ¸å¿ƒæ€§èƒ½å‚æ•°
  loadbalance: true        # å¿…é¡»å¯ç”¨
  worker: 4               # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
  bulk_max_size: 1600     # æ‰¹é‡å¤§å°
  flush_interval: 1s      # åˆ·æ–°é—´éš”
  compression_level: 1    # è½»å‹ç¼©
  
  # ç¨³å®šæ€§ä¿éšœ
  timeout: 60s
  max_retries: 3
  backoff.max: 60s
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**é—®é¢˜è¯Šæ–­æŒ‡å—**ï¼š
```
è¿æ¥é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šunable to connect to any of the configured elasticsearch hosts
è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼ŒéªŒè¯ç«¯å£å¼€æ”¾

æ€§èƒ½é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šæ•°æ®å¤„ç†ç¼“æ…¢ï¼Œå †ç§¯ä¸¥é‡
è§£å†³ï¼šå¢åŠ workeræ•°é‡ï¼Œè°ƒæ•´bulk_max_size

å†…å­˜é—®é¢˜ï¼š
ç—‡çŠ¶ï¼šOOMé”™è¯¯ï¼Œå†…å­˜å ç”¨è¿‡é«˜
è§£å†³ï¼šå‡å°‘workeræˆ–bulk_max_size

è´Ÿè½½ä¸å‡ï¼š
ç—‡çŠ¶ï¼šæŸäº›èŠ‚ç‚¹å‹åŠ›å¤§ï¼Œå…¶ä»–èŠ‚ç‚¹ç©ºé—²
è§£å†³ï¼šå¯ç”¨loadbalanceï¼Œæ£€æŸ¥èŠ‚ç‚¹é…ç½®
```

### 8.5 æœ€ä½³å®è·µå»ºè®®


**ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**ï¼š
- âœ… **é…ç½®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§
- âœ… **å®‰å…¨è®¤è¯**ï¼šä½¿ç”¨SSLå’Œèº«ä»½éªŒè¯
- âœ… **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®æ—¥å¿—é‡è§„åˆ’èµ„æº
- âœ… **æ•…éšœæ¼”ç»ƒ**ï¼šå®šæœŸæµ‹è¯•æ•…éšœæ¢å¤èƒ½åŠ›

**è®°å¿†è¦ç‚¹**ï¼š
- é›†ç¾¤é…ç½®çš„æ ¸å¿ƒæ˜¯**é«˜å¯ç”¨**å’Œ**è´Ÿè½½åˆ†æ•£**
- hostsã€loadbalanceã€workeræ˜¯ä¸‰å¤§æ ¸å¿ƒå‚æ•°
- ç”Ÿäº§ç¯å¢ƒä¼˜å…ˆè€ƒè™‘**ç¨³å®šæ€§**ï¼Œå†è€ƒè™‘æ€§èƒ½
- ç›‘æ§å’Œå‘Šè­¦æ˜¯é›†ç¾¤è¿ç»´çš„é‡è¦ä¿éšœ
- é…ç½®è¦æ ¹æ®å®é™…ç¯å¢ƒè°ƒä¼˜ï¼Œæ²¡æœ‰ä¸‡èƒ½æ¨¡æ¿