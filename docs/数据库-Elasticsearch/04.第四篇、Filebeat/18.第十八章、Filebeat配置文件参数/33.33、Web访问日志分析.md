---
title: 33ã€Webè®¿é—®æ—¥å¿—åˆ†æ
---
## ğŸ“š ç›®å½•

1. [Webè®¿é—®æ—¥å¿—æ¦‚è¿°](#1-Webè®¿é—®æ—¥å¿—æ¦‚è¿°)
2. [Nginxè®¿é—®æ—¥å¿—åˆ†æ](#2-Nginxè®¿é—®æ—¥å¿—åˆ†æ)
3. [Apacheè®¿é—®æ—¥å¿—åˆ†æ](#3-Apacheè®¿é—®æ—¥å¿—åˆ†æ)
4. [ç”¨æˆ·ä»£ç†è§£æé…ç½®](#4-ç”¨æˆ·ä»£ç†è§£æé…ç½®)
5. [åœ°ç†ä½ç½®åˆ†æé…ç½®](#5-åœ°ç†ä½ç½®åˆ†æé…ç½®)
6. [å“åº”æ—¶é—´ç›‘æ§é…ç½®](#6-å“åº”æ—¶é—´ç›‘æ§é…ç½®)
7. [çŠ¶æ€ç åˆ†æé…ç½®](#7-çŠ¶æ€ç åˆ†æé…ç½®)
8. [æ¥æºé¡µé¢åˆ†æé…ç½®](#8-æ¥æºé¡µé¢åˆ†æé…ç½®)
9. [çœŸå®IPæå–é…ç½®](#9-çœŸå®IPæå–é…ç½®)
10. [ç»¼åˆå®æˆ˜é…ç½®](#10-ç»¼åˆå®æˆ˜é…ç½®)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Webè®¿é—®æ—¥å¿—æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Webè®¿é—®æ—¥å¿—


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
Webè®¿é—®æ—¥å¿—å°±åƒç½‘ç«™çš„"è®¿å®¢è®°å½•æœ¬"ï¼Œè®°å½•äº†æ¯ä¸ªç”¨æˆ·è®¿é—®ç½‘ç«™æ—¶çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
æƒ³è±¡ä¸€ä¸‹å®ä½“åº—çš„å®¢æµè®°å½•ï¼š
- è°æ¥äº†ï¼ˆIPåœ°å€ï¼‰
- ä»€ä¹ˆæ—¶å€™æ¥çš„ï¼ˆè®¿é—®æ—¶é—´ï¼‰
- ä¹°äº†ä»€ä¹ˆï¼ˆè®¿é—®çš„é¡µé¢ï¼‰
- ä»å“ªé‡Œæ¥çš„ï¼ˆæ¥æºç½‘ç«™ï¼‰
- ç”¨ä»€ä¹ˆäº¤é€šå·¥å…·ï¼ˆæµè§ˆå™¨ç±»å‹ï¼‰
- åœç•™å¤šä¹…ï¼ˆå“åº”æ—¶é—´ï¼‰
- æ˜¯å¦æˆåŠŸè´­ä¹°ï¼ˆçŠ¶æ€ç ï¼‰
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åˆ†æWebæ—¥å¿—**
- **ğŸ¯ ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šäº†è§£ç”¨æˆ·å–œæ¬¢è®¿é—®å“ªäº›é¡µé¢
- **âš¡ æ€§èƒ½ç›‘æ§**ï¼šå‘ç°ç½‘ç«™å“åº”æ…¢çš„é—®é¢˜
- **ğŸ”’ å®‰å…¨é˜²æŠ¤**ï¼šè¯†åˆ«æ¶æ„æ”»å‡»å’Œå¼‚å¸¸è®¿é—®
- **ğŸ“Š ä¸šåŠ¡åˆ†æ**ï¼šåˆ†ææµé‡è¶‹åŠ¿å’Œç”¨æˆ·æ¥æº

### 1.2 å¸¸è§çš„WebæœåŠ¡å™¨æ—¥å¿—æ ¼å¼


**Nginxé»˜è®¤è®¿é—®æ—¥å¿—æ ¼å¼**
```
192.168.1.100 - - [21/Sep/2025:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1024 "https://google.com" "Mozilla/5.0 Chrome/91.0"
```

**Apacheé»˜è®¤è®¿é—®æ—¥å¿—æ ¼å¼**
```
192.168.1.100 - - [21/Sep/2025:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1024
```

### 1.3 æ—¥å¿—å­—æ®µè§£æ


| å­—æ®µåç§° | **å«ä¹‰è¯´æ˜** | **ç¤ºä¾‹å€¼** |
|---------|-------------|-----------|
| **å®¢æˆ·ç«¯IP** | `è®¿é—®è€…çš„IPåœ°å€` | `192.168.1.100` |
| **è®¿é—®æ—¶é—´** | `è¯·æ±‚å‘ç”Ÿçš„æ—¶é—´` | `[21/Sep/2025:10:30:45 +0800]` |
| **è¯·æ±‚æ–¹æ³•** | `HTTPæ–¹æ³•å’Œè·¯å¾„` | `"GET /index.html HTTP/1.1"` |
| **çŠ¶æ€ç ** | `æœåŠ¡å™¨å“åº”çŠ¶æ€` | `200ï¼ˆæˆåŠŸï¼‰, 404ï¼ˆæœªæ‰¾åˆ°ï¼‰` |
| **å“åº”å¤§å°** | `è¿”å›å†…å®¹çš„å­—èŠ‚æ•°` | `1024` |
| **æ¥æºé¡µé¢** | `ä»å“ªä¸ªé¡µé¢è·³è½¬æ¥çš„` | `"https://google.com"` |
| **ç”¨æˆ·ä»£ç†** | `æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿä¿¡æ¯` | `"Mozilla/5.0 Chrome/91.0"` |

---

## 2. ğŸ”§ Nginxè®¿é—®æ—¥å¿—åˆ†æ


### 2.1 Nginxè®¿é—®æ—¥å¿—é…ç½®


**ğŸ”¸ åŸºç¡€é…ç½®ç»“æ„**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  
  # ğŸ¯ å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆä¸€èˆ¬ä¸éœ€è¦ï¼Œå› ä¸ºæ¯è¡Œæ˜¯ä¸€æ¡å®Œæ•´è®°å½•ï¼‰
  multiline.pattern: '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'
  multiline.negate: true
  multiline.match: after
  
  # ğŸ“ æ·»åŠ å­—æ®µæ ‡è¯†
  fields:
    log_type: nginx_access
    service: web_frontend
  fields_under_root: true
```

### 2.2 Nginxæ—¥å¿—æ ¼å¼è§£æ


**è‡ªå®šä¹‰Nginxæ—¥å¿—æ ¼å¼ï¼ˆæ¨èï¼‰**
```nginx
# nginx.conf ä¸­çš„æ—¥å¿—æ ¼å¼å®šä¹‰
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time';

access_log /var/log/nginx/access.log detailed;
```

**å¯¹åº”çš„Filebeatè§£æé…ç½®**
```yaml
processors:
- dissect:
    tokenizer: '%{client_ip} - %{user} [%{timestamp}] "%{method} %{url} %{http_version}" %{status_code} %{response_size} "%{referrer}" "%{user_agent}" %{request_time} %{upstream_time}'
    field: "message"
    target_prefix: "nginx"

# ğŸ”„ æ•°æ®ç±»å‹è½¬æ¢
- convert:
    fields:
      - {from: "nginx.status_code", to: "nginx.status_code", type: "integer"}
      - {from: "nginx.response_size", to: "nginx.response_size", type: "integer"}
      - {from: "nginx.request_time", to: "nginx.request_time", type: "float"}
```

### 2.3 æ—¶é—´æˆ³å¤„ç†


**æ—¶é—´æˆ³è§£æé…ç½®**
```yaml
processors:
- timestamp:
    field: nginx.timestamp
    layouts:
      - '02/Jan/2006:15:04:05 -0700'
    test:
      - '21/Sep/2025:10:30:45 +0800'
```

---

## 3. ğŸŒ Apacheè®¿é—®æ—¥å¿—åˆ†æ


### 3.1 Apacheæ—¥å¿—æ ¼å¼é…ç½®


**Apacheè™šæ‹Ÿä¸»æœºé…ç½®**
```apache
# httpd.conf æˆ–è™šæ‹Ÿä¸»æœºé…ç½®
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" combined_with_time
CustomLog /var/log/apache2/access.log combined_with_time
```

**Filebeat Apacheæ—¥å¿—é…ç½®**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/apache2/access.log
    - /var/log/httpd/access_log
  
  fields:
    log_type: apache_access
    service: web_backend
  fields_under_root: true

processors:
- dissect:
    tokenizer: '%{client_ip} %{identity} %{user} [%{timestamp}] "%{request}" %{status} %{size} "%{referer}" "%{user_agent}" %{response_time_microseconds}'
    field: "message"
    target_prefix: "apache"
```

### 3.2 Apacheç‰¹æœ‰å­—æ®µå¤„ç†


**å“åº”æ—¶é—´è½¬æ¢ï¼ˆå¾®ç§’åˆ°æ¯«ç§’ï¼‰**
```yaml
processors:
- script:
    lang: javascript
    id: convert_apache_response_time
    source: >
      function process(event) {
        var microseconds = event.Get("apache.response_time_microseconds");
        if (microseconds) {
          var milliseconds = parseInt(microseconds) / 1000;
          event.Put("apache.response_time_ms", milliseconds);
        }
      }
```

---

## 4. ğŸ” ç”¨æˆ·ä»£ç†è§£æé…ç½®


### 4.1 ä»€ä¹ˆæ˜¯User-Agent


**ğŸ”¸ ç”¨æˆ·ä»£ç†ï¼ˆUser-Agentï¼‰è§£é‡Š**
User-Agentå°±åƒè®¿å®¢çš„"èº«ä»½è¯"ï¼Œå‘Šè¯‰æœåŠ¡å™¨ï¼š
- **æµè§ˆå™¨ç±»å‹**ï¼šChromeã€Firefoxã€Safariç­‰
- **æ“ä½œç³»ç»Ÿ**ï¼šWindowsã€macOSã€Androidç­‰
- **è®¾å¤‡ç±»å‹**ï¼šæ‰‹æœºã€å¹³æ¿ã€ç”µè„‘ç­‰

```
å…¸å‹çš„User-Agentç¤ºä¾‹ï¼š
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36

è§£æç»“æœï¼š
- æ“ä½œç³»ç»Ÿï¼šWindows 10 64ä½
- æµè§ˆå™¨ï¼šChrome 91.0
- è®¾å¤‡ç±»å‹ï¼šæ¡Œé¢ç”µè„‘
```

### 4.2 ç”¨æˆ·ä»£ç†è§£æé…ç½®


**ä½¿ç”¨å†…ç½®user_agentå¤„ç†å™¨**
```yaml
processors:
- user_agent:
    field: nginx.user_agent
    target_field: user_agent_parsed
    properties:
      - name
      - version  
      - os
      - os_version
      - device
```

**è§£æç»“æœç¤ºä¾‹**
```json
{
  "user_agent_parsed": {
    "name": "Chrome",
    "version": "91.0.4472.124", 
    "os": "Windows",
    "os_version": "10",
    "device": "Desktop"
  }
}
```

### 4.3 è®¾å¤‡ç±»å‹åˆ†ç±»


**è®¾å¤‡ç±»å‹åˆ¤æ–­è„šæœ¬**
```yaml
processors:
- script:
    lang: javascript
    id: classify_device_type
    source: >
      function process(event) {
        var userAgent = event.Get("nginx.user_agent");
        var deviceType = "desktop";
        
        if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
          deviceType = "mobile";
        } else if (/Tablet|iPad/.test(userAgent)) {
          deviceType = "tablet";
        } else if (/bot|crawler|spider/i.test(userAgent)) {
          deviceType = "bot";
        }
        
        event.Put("device_category", deviceType);
      }
```

---

## 5. ğŸŒ åœ°ç†ä½ç½®åˆ†æé…ç½®


### 5.1 GeoIPæ•°æ®åº“é…ç½®


**ğŸ”¸ åœ°ç†ä½ç½®åˆ†æçš„ä½œç”¨**
é€šè¿‡IPåœ°å€å¯ä»¥å¤§æ¦‚çŸ¥é“è®¿é—®è€…æ¥è‡ªå“ªä¸ªï¼š
- **å›½å®¶/åœ°åŒº**ï¼šä¸­å›½ã€ç¾å›½ã€æ—¥æœ¬ç­‰
- **åŸå¸‚**ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€çº½çº¦ç­‰  
- **ISPæä¾›å•†**ï¼šç”µä¿¡ã€è”é€šã€ç§»åŠ¨ç­‰

**GeoIPå¤„ç†å™¨é…ç½®**
```yaml
processors:
- add_host_metadata:
    when.not.contains.tags: forwarded

- geoip:
    source: nginx.client_ip
    target: geoip
    properties:
      - continent_name
      - country_name
      - city_name
      - region_name
      - location
```

### 5.2 CDNå’Œä»£ç†IPå¤„ç†


**çœŸå®IPæå–ï¼ˆé€‚ç”¨äºä½¿ç”¨CDNçš„æƒ…å†µï¼‰**
```yaml
processors:
- script:
    lang: javascript
    id: extract_real_ip
    source: >
      function process(event) {
        // ä¼˜å…ˆçº§ï¼šX-Forwarded-For > X-Real-IP > remote_addr
        var xForwardedFor = event.Get("nginx.x_forwarded_for");
        var xRealIp = event.Get("nginx.x_real_ip");
        var remoteAddr = event.Get("nginx.client_ip");
        
        var realIp = remoteAddr; // é»˜è®¤å€¼
        
        if (xRealIp && xRealIp !== "-") {
          realIp = xRealIp;
        }
        
        if (xForwardedFor && xForwardedFor !== "-") {
          // X-Forwarded-Forå¯èƒ½åŒ…å«å¤šä¸ªIPï¼Œå–ç¬¬ä¸€ä¸ª
          realIp = xForwardedFor.split(',')[0].trim();
        }
        
        event.Put("real_client_ip", realIp);
      }
```

### 5.3 åœ°ç†ä½ç½®å­—æ®µæ˜ å°„


**GeoIPå­—æ®µé‡å‘½å**
```yaml
processors:
- rename:
    fields:
      - from: "geoip.country_name"
        to: "location.country"
      - from: "geoip.city_name" 
        to: "location.city"
      - from: "geoip.continent_name"
        to: "location.continent"
```

---

## 6. âš¡ å“åº”æ—¶é—´ç›‘æ§é…ç½®


### 6.1 å“åº”æ—¶é—´çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦ç›‘æ§å“åº”æ—¶é—´**
å“åº”æ—¶é—´å°±åƒé¤å…ä¸Šèœé€Ÿåº¦ï¼š
- **ç”¨æˆ·ä½“éªŒ**ï¼šç½‘é¡µåŠ è½½å¤ªæ…¢ç”¨æˆ·ä¼šç¦»å¼€
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šæ‰¾å‡ºæœ€æ…¢çš„é¡µé¢è¿›è¡Œä¼˜åŒ–
- **æœåŠ¡è´¨é‡**ï¼šç›‘æ§æœåŠ¡å™¨æ€§èƒ½æ˜¯å¦ç¨³å®š

```
å“åº”æ—¶é—´åˆ†çº§æ ‡å‡†ï¼š
âš¡ ä¼˜ç§€ï¼š< 100ms
ğŸŸ¢ è‰¯å¥½ï¼š100ms - 300ms  
ğŸŸ¡ ä¸€èˆ¬ï¼š300ms - 1000ms
ğŸŸ  è¾ƒæ…¢ï¼š1000ms - 3000ms
ğŸ”´ å¾ˆæ…¢ï¼š> 3000ms
```

### 6.2 å“åº”æ—¶é—´å­—æ®µå¤„ç†


**å“åº”æ—¶é—´åˆ†ç±»è„šæœ¬**
```yaml
processors:
- script:
    lang: javascript
    id: categorize_response_time
    source: >
      function process(event) {
        var responseTime = parseFloat(event.Get("nginx.request_time"));
        var category = "unknown";
        var level = 0;
        
        if (responseTime < 0.1) {
          category = "excellent";
          level = 1;
        } else if (responseTime < 0.3) {
          category = "good"; 
          level = 2;
        } else if (responseTime < 1.0) {
          category = "average";
          level = 3;
        } else if (responseTime < 3.0) {
          category = "slow";
          level = 4;
        } else {
          category = "very_slow";
          level = 5;
        }
        
        event.Put("performance.response_category", category);
        event.Put("performance.response_level", level);
        event.Put("performance.response_time_ms", responseTime * 1000);
      }
```

### 6.3 æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡


**æ…¢è¯·æ±‚æ ‡è®°**
```yaml
processors:
- add_tags:
    tags: ["slow_request"]
    when:
      range:
        nginx.request_time:
          gte: 2.0

- add_tags:
    tags: ["very_slow_request"] 
    when:
      range:
        nginx.request_time:
          gte: 5.0
```

---

## 7. ğŸ“Š çŠ¶æ€ç åˆ†æé…ç½®


### 7.1 HTTPçŠ¶æ€ç å«ä¹‰


**ğŸ”¸ çŠ¶æ€ç å°±åƒæœåŠ¡å™¨çš„"å›å¤"**

```
ğŸ“¨ çŠ¶æ€ç åˆ†ç±»è¯´æ˜ï¼š

2xx æˆåŠŸç±»ï¼š
âœ… 200 OK - è¯·æ±‚æˆåŠŸï¼Œä¸€åˆ‡æ­£å¸¸
âœ… 201 Created - åˆ›å»ºæˆåŠŸï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œï¼‰
âœ… 204 No Content - æˆåŠŸä½†æ— å†…å®¹è¿”å›

3xx é‡å®šå‘ç±»ï¼š  
ğŸ”„ 301 Moved Permanently - æ°¸ä¹…é‡å®šå‘
ğŸ”„ 302 Found - ä¸´æ—¶é‡å®šå‘
ğŸ”„ 304 Not Modified - å†…å®¹æœªä¿®æ”¹ï¼ˆç¼“å­˜æœ‰æ•ˆï¼‰

4xx å®¢æˆ·ç«¯é”™è¯¯ï¼š
âŒ 400 Bad Request - è¯·æ±‚æ ¼å¼é”™è¯¯
âŒ 401 Unauthorized - éœ€è¦ç™»å½•
âŒ 403 Forbidden - ç¦æ­¢è®¿é—®
âŒ 404 Not Found - é¡µé¢ä¸å­˜åœ¨
âŒ 429 Too Many Requests - è¯·æ±‚è¿‡äºé¢‘ç¹

5xx æœåŠ¡å™¨é”™è¯¯ï¼š
ğŸ’¥ 500 Internal Server Error - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
ğŸ’¥ 502 Bad Gateway - ç½‘å…³é”™è¯¯
ğŸ’¥ 503 Service Unavailable - æœåŠ¡ä¸å¯ç”¨
ğŸ’¥ 504 Gateway Timeout - ç½‘å…³è¶…æ—¶
```

### 7.2 çŠ¶æ€ç åˆ†ç±»é…ç½®


**çŠ¶æ€ç åˆ†ç±»å¤„ç†**
```yaml
processors:
- script:
    lang: javascript
    id: categorize_status_code
    source: >
      function process(event) {
        var statusCode = parseInt(event.Get("nginx.status_code"));
        var category = "unknown";
        var isError = false;
        var severity = "info";
        
        if (statusCode >= 200 && statusCode < 300) {
          category = "success";
          severity = "info";
        } else if (statusCode >= 300 && statusCode < 400) {
          category = "redirect";
          severity = "info";
        } else if (statusCode >= 400 && statusCode < 500) {
          category = "client_error";
          isError = true;
          severity = "warning";
        } else if (statusCode >= 500) {
          category = "server_error";
          isError = true;
          severity = "error";
        }
        
        event.Put("http.status_category", category);
        event.Put("http.is_error", isError);
        event.Put("log.level", severity);
      }
```

### 7.3 é”™è¯¯è¯·æ±‚ç‰¹æ®Šå¤„ç†


**é«˜é¢‘é”™è¯¯æ ‡è®°**
```yaml
processors:
- add_tags:
    tags: ["page_not_found"]
    when:
      equals:
        nginx.status_code: 404

- add_tags:
    tags: ["server_error"]
    when:
      range:
        nginx.status_code:
          gte: 500
          lt: 600

- add_tags: 
    tags: ["security_issue"]
    when:
      or:
        - equals:
            nginx.status_code: 401
        - equals:
            nginx.status_code: 403
```

---

## 8. ğŸ”— æ¥æºé¡µé¢åˆ†æé…ç½®


### 8.1 Referrerå­—æ®µè§£æ


**ğŸ”¸ æ¥æºé¡µé¢ï¼ˆReferrerï¼‰çš„ä½œç”¨**
Referrerå‘Šè¯‰æˆ‘ä»¬ç”¨æˆ·æ˜¯ä»å“ªé‡Œæ¥åˆ°æˆ‘ä»¬ç½‘ç«™çš„ï¼š
- **æœç´¢å¼•æ“**ï¼šGoogleã€ç™¾åº¦ã€Bing
- **ç¤¾äº¤åª’ä½“**ï¼šå¾®åšã€å¾®ä¿¡ã€Facebook  
- **ç›´æ¥è®¿é—®**ï¼šç”¨æˆ·ç›´æ¥è¾“å…¥ç½‘å€
- **å…¶ä»–ç½‘ç«™**ï¼šå‹æƒ…é“¾æ¥ã€å¹¿å‘Šç­‰

```
Referrerç¤ºä¾‹åˆ†æï¼š

https://www.google.com/search?q=å­¦ä¹ elasticsearch
â†’ ç”¨æˆ·é€šè¿‡Googleæœç´¢æ¥åˆ°ç½‘ç«™

https://weibo.com/
â†’ ç”¨æˆ·ä»å¾®åšç‚¹å‡»é“¾æ¥è¿‡æ¥

(empty) æˆ– "-"
â†’ ç”¨æˆ·ç›´æ¥è®¿é—®ï¼ˆæ”¶è—å¤¹ã€ç›´æ¥è¾“å…¥ç½‘å€ï¼‰
```

### 8.2 æ¥æºåŸŸåæå–


**æ¥æºåŸŸåè§£æè„šæœ¬**
```yaml
processors:
- script:
    lang: javascript
    id: parse_referrer
    source: >
      function process(event) {
        var referrer = event.Get("nginx.referrer");
        
        if (!referrer || referrer === "-" || referrer === "") {
          event.Put("referrer.type", "direct");
          event.Put("referrer.domain", "direct");
          return;
        }
        
        try {
          var url = new URL(referrer);
          var domain = url.hostname.toLowerCase();
          var type = "external";
          
          // åˆ¤æ–­æ¥æºç±»å‹
          if (domain.includes("google")) {
            type = "search_engine";
            event.Put("referrer.search_engine", "google");
          } else if (domain.includes("baidu")) {
            type = "search_engine";
            event.Put("referrer.search_engine", "baidu");
          } else if (domain.includes("weibo") || domain.includes("qq.com") || domain.includes("weixin")) {
            type = "social_media";
          } else if (domain === event.Get("host.name")) {
            type = "internal";
          }
          
          event.Put("referrer.type", type);
          event.Put("referrer.domain", domain);
          event.Put("referrer.full_url", referrer);
          
        } catch (e) {
          event.Put("referrer.type", "invalid");
        }
      }
```

### 8.3 æœç´¢å…³é”®è¯æå–


**ä»æœç´¢å¼•æ“URLæå–å…³é”®è¯**
```yaml
processors:
- script:
    lang: javascript
    id: extract_search_keywords  
    source: >
      function process(event) {
        var referrer = event.Get("nginx.referrer");
        var referrerType = event.Get("referrer.type");
        
        if (referrerType !== "search_engine" || !referrer) {
          return;
        }
        
        try {
          var url = new URL(referrer);
          var params = new URLSearchParams(url.search);
          
          // Google: qå‚æ•°
          // ç™¾åº¦: wdå‚æ•°  
          // Bing: qå‚æ•°
          var keyword = params.get("q") || params.get("wd") || params.get("query");
          
          if (keyword) {
            event.Put("referrer.search_keyword", decodeURIComponent(keyword));
          }
        } catch (e) {
          // URLè§£æå¤±è´¥ï¼Œå¿½ç•¥
        }
      }
```

---

## 9. ğŸŒ çœŸå®IPæå–é…ç½®


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æå–çœŸå®IP


**ğŸ”¸ CDNå’Œä»£ç†çš„å½±å“**
å½“ç½‘ç«™ä½¿ç”¨CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰æˆ–è´Ÿè½½å‡è¡¡å™¨æ—¶ï¼š

```
ç”¨æˆ·è¯·æ±‚è·¯å¾„ï¼š
ç”¨æˆ· â†’ CDNèŠ‚ç‚¹ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ WebæœåŠ¡å™¨

é—®é¢˜ï¼š
- WebæœåŠ¡å™¨çœ‹åˆ°çš„IPæ˜¯CDNçš„IP
- ä¸æ˜¯ç”¨æˆ·çš„çœŸå®IP
- å½±å“åœ°ç†ä½ç½®åˆ†æå’Œå®‰å…¨é˜²æŠ¤

è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨HTTPå¤´ä¿¡æ¯ä¼ é€’çœŸå®IP
- X-Forwarded-For: åŸå§‹å®¢æˆ·ç«¯IP
- X-Real-IP: çœŸå®å®¢æˆ·ç«¯IP
```

### 9.2 å¤šå±‚ä»£ç†IPå¤„ç†


**å¤æ‚ä»£ç†ç¯å¢ƒä¸‹çš„çœŸå®IPæå–**
```yaml
processors:
- script:
    lang: javascript
    id: extract_real_client_ip
    source: >
      function process(event) {
        // è·å–å„ç§IPå¤´ä¿¡æ¯
        var xForwardedFor = event.Get("nginx.x_forwarded_for");
        var xRealIp = event.Get("nginx.x_real_ip");
        var xOriginalForwardedFor = event.Get("nginx.x_original_forwarded_for");
        var remoteAddr = event.Get("nginx.client_ip");
        
        var realIp = remoteAddr; // é»˜è®¤ä½¿ç”¨ç›´è¿IP
        
        // å¤„ç†X-Forwarded-Forï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªIPï¼‰
        if (xForwardedFor && xForwardedFor !== "-") {
          var ips = xForwardedFor.split(',');
          for (var i = 0; i < ips.length; i++) {
            var ip = ips[i].trim();
            // è·³è¿‡å†…ç½‘IPå’ŒCDN IP
            if (!isPrivateIP(ip) && !isCDNIP(ip)) {
              realIp = ip;
              break;
            }
          }
        }
        
        // X-Real-IPä¼˜å…ˆçº§è¾ƒé«˜
        if (xRealIp && xRealIp !== "-" && !isPrivateIP(xRealIp)) {
          realIp = xRealIp;
        }
        
        event.Put("client.real_ip", realIp);
        event.Put("client.is_proxied", realIp !== remoteAddr);
      }
      
      function isPrivateIP(ip) {
        return /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.)/.test(ip);
      }
      
      function isCDNIP(ip) {
        // å¯ä»¥æ·»åŠ å·²çŸ¥CDN IPæ®µçš„åˆ¤æ–­
        return false;
      }
```

### 9.3 IPåœ°å€éªŒè¯


**IPåœ°å€æ ¼å¼éªŒè¯**
```yaml
processors:
- script:
    lang: javascript
    id: validate_ip_address
    source: >
      function process(event) {
        var realIp = event.Get("client.real_ip");
        
        if (realIp && isValidIP(realIp)) {
          event.Put("client.ip_valid", true);
          
          // åˆ¤æ–­IPç±»å‹
          if (isPrivateIP(realIp)) {
            event.Put("client.ip_type", "private");
          } else {
            event.Put("client.ip_type", "public");
          }
        } else {
          event.Put("client.ip_valid", false);
          event.Put("client.ip_type", "invalid");
        }
      }
      
      function isValidIP(ip) {
        var ipRegex = /^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        return ipRegex.test(ip);
      }
      
      function isPrivateIP(ip) {
        return /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.)/.test(ip);
      }
```

---

## 10. ğŸš€ ç»¼åˆå®æˆ˜é…ç½®


### 10.1 å®Œæ•´çš„Webæ—¥å¿—åˆ†æé…ç½®


**ğŸ“‹ ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
    - /var/log/nginx/*.access.log
  
  # ğŸ·ï¸ åŸºç¡€å­—æ®µæ ‡è¯†
  fields:
    log_type: nginx_access
    service: web_frontend
    environment: production
  fields_under_root: true
  
  # ğŸ“ æ’é™¤é™æ€èµ„æºæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
  exclude_lines: ['\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)']

processors:
# ğŸ” 1. åŸºç¡€æ—¥å¿—è§£æ
- dissect:
    tokenizer: '%{client_ip} - %{user} [%{timestamp}] "%{method} %{url} %{http_version}" %{status_code} %{response_size} "%{referrer}" "%{user_agent}" %{request_time}'
    field: "message"
    target_prefix: "nginx"

# â° 2. æ—¶é—´æˆ³å¤„ç†
- timestamp:
    field: nginx.timestamp
    layouts:
      - '02/Jan/2006:15:04:05 -0700'

# ğŸ”¢ 3. æ•°æ®ç±»å‹è½¬æ¢
- convert:
    fields:
      - {from: "nginx.status_code", to: "nginx.status_code", type: "integer"}
      - {from: "nginx.response_size", to: "nginx.response_size", type: "integer"} 
      - {from: "nginx.request_time", to: "nginx.request_time", type: "float"}

# ğŸŒ 4. çœŸå®IPæå–
- script:
    lang: javascript
    id: extract_real_ip
    source: >
      function process(event) {
        var clientIp = event.Get("nginx.client_ip");
        event.Put("client.real_ip", clientIp);
        event.Put("client.ip_type", isPrivateIP(clientIp) ? "private" : "public");
      }
      function isPrivateIP(ip) {
        return /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.|127\.)/.test(ip);
      }

# ğŸ—ºï¸ 5. åœ°ç†ä½ç½®åˆ†æ
- geoip:
    source: client.real_ip
    target: geoip
    properties:
      - continent_name
      - country_name
      - city_name
      - location

# ğŸ–¥ï¸ 6. ç”¨æˆ·ä»£ç†è§£æ
- user_agent:
    field: nginx.user_agent
    target_field: user_agent_parsed

# ğŸ“Š 7. çŠ¶æ€ç åˆ†ç±»
- script:
    lang: javascript
    id: categorize_status
    source: >
      function process(event) {
        var status = event.Get("nginx.status_code");
        var category = "unknown";
        if (status >= 200 && status < 300) category = "success";
        else if (status >= 300 && status < 400) category = "redirect";
        else if (status >= 400 && status < 500) category = "client_error";
        else if (status >= 500) category = "server_error";
        
        event.Put("http.status_category", category);
        event.Put("http.is_error", status >= 400);
      }

# âš¡ 8. æ€§èƒ½åˆ†ç±»
- script:
    lang: javascript
    id: performance_category
    source: >
      function process(event) {
        var responseTime = event.Get("nginx.request_time");
        var category = "excellent";
        if (responseTime > 3) category = "very_slow";
        else if (responseTime > 1) category = "slow";
        else if (responseTime > 0.3) category = "average";
        else if (responseTime > 0.1) category = "good";
        
        event.Put("performance.category", category);
        event.Put("performance.response_time_ms", responseTime * 1000);
      }

# ğŸ”— 9. æ¥æºåˆ†æ
- script:
    lang: javascript  
    id: analyze_referrer
    source: >
      function process(event) {
        var referrer = event.Get("nginx.referrer");
        if (!referrer || referrer === "-") {
          event.Put("referrer.type", "direct");
          return;
        }
        
        var type = "external";
        if (referrer.includes("google")) type = "search_engine";
        else if (referrer.includes("baidu")) type = "search_engine";
        else if (referrer.includes("weibo") || referrer.includes("qq.com")) type = "social_media";
        
        event.Put("referrer.type", type);
      }

# ğŸ·ï¸ 10. æ·»åŠ æ ‡ç­¾
- add_tags:
    tags: ["slow_request"]
    when:
      range:
        nginx.request_time:
          gte: 2.0

- add_tags:
    tags: ["error_request"]
    when:
      range:
        nginx.status_code:
          gte: 400

# ğŸ§¹ 11. æ¸…ç†ä¸éœ€è¦çš„å­—æ®µ
- drop_fields:
    fields: ["host", "agent", "ecs", "input"]

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "filebeat-nginx-access-%{+yyyy.MM.dd}"
  template.name: "nginx-access"
  template.pattern: "filebeat-nginx-access-*"
```

### 10.2 Kibanaå¯è§†åŒ–å»ºè®®


**ğŸ“Š æ¨èçš„ä»ªè¡¨æ¿å›¾è¡¨**

```
ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ï¼š

1. è®¿é—®é‡è¶‹åŠ¿å›¾
   - æ—¶é—´åºåˆ—å›¾æ˜¾ç¤ºæ¯å°æ—¶/æ¯å¤©è®¿é—®é‡

2. çŠ¶æ€ç åˆ†å¸ƒé¥¼å›¾  
   - 2xxã€3xxã€4xxã€5xxçŠ¶æ€ç æ¯”ä¾‹

3. å“åº”æ—¶é—´åˆ†å¸ƒç›´æ–¹å›¾
   - å±•ç¤ºå“åº”æ—¶é—´åˆ†å¸ƒæƒ…å†µ

4. Top 10 è®¿é—®é¡µé¢
   - æœ€å—æ¬¢è¿çš„é¡µé¢æ’è¡Œ

5. åœ°ç†ä½ç½®åˆ†å¸ƒåœ°å›¾
   - å…¨çƒç”¨æˆ·è®¿é—®åˆ†å¸ƒ

6. æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿç»Ÿè®¡
   - ç”¨æˆ·è®¾å¤‡ç¯å¢ƒåˆ†æ

7. æ¥æºç½‘ç«™Top 10
   - ä¸»è¦æµé‡æ¥æºåˆ†æ

8. é”™è¯¯æ—¥å¿—ç›‘æ§
   - 4xxã€5xxé”™è¯¯è¶‹åŠ¿å’Œè¯¦æƒ…
```

### 10.3 å‘Šè­¦é…ç½®å»ºè®®


**âš ï¸ å…³é”®å‘Šè­¦è§„åˆ™**
```yaml
# Watcherå‘Šè­¦ç¤ºä¾‹ï¼ˆéœ€è¦Elastic Stacké‡‘ç‰Œç‰ˆæœ¬ï¼‰

# 1. é”™è¯¯ç‡è¿‡é«˜å‘Šè­¦
PUT _watcher/watch/high_error_rate
{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["filebeat-nginx-access-*"],
        "body": {
          "query": {
            "bool": {
              "filter": [
                {"range": {"@timestamp": {"gte": "now-5m"}}},
                {"range": {"nginx.status_code": {"gte": 400}}}
              ]
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gt": 100
      }
    }
  }
}

# 2. å“åº”æ—¶é—´è¿‡æ…¢å‘Šè­¦  
PUT _watcher/watch/slow_response_time
{
  "trigger": {
    "schedule": {
      "interval": "5m" 
    }
  },
  "input": {
    "search": {
      "request": {
        "indices": ["filebeat-nginx-access-*"],
        "body": {
          "query": {
            "bool": {
              "filter": [
                {"range": {"@timestamp": {"gte": "now-5m"}}},
                {"range": {"nginx.request_time": {"gte": 5}}}
              ]
            }
          }
        }
      }
    }
  },
  "condition": {
    "compare": {
      "ctx.payload.hits.total": {
        "gt": 10
      }
    }
  }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Webè®¿é—®æ—¥å¿—ï¼šç½‘ç«™è®¿å®¢çš„è¯¦ç»†è®°å½•ï¼ŒåŒ…å«è®¿é—®æ—¶é—´ã€IPã€é¡µé¢ã€çŠ¶æ€ç­‰ä¿¡æ¯
ğŸ”¸ æ—¥å¿—å­—æ®µè§£æï¼šå°†ä¸€è¡Œæ—¥å¿—æ–‡æœ¬æ‹†åˆ†æˆç»“æ„åŒ–çš„å­—æ®µæ•°æ®
ğŸ”¸ ç”¨æˆ·ä»£ç†åˆ†æï¼šä»User-Agentè¯†åˆ«æµè§ˆå™¨ã€æ“ä½œç³»ç»Ÿã€è®¾å¤‡ç±»å‹
ğŸ”¸ åœ°ç†ä½ç½®åˆ†æï¼šé€šè¿‡IPåœ°å€ç¡®å®šè®¿é—®è€…çš„å¤§è‡´åœ°ç†ä½ç½®
ğŸ”¸ çŠ¶æ€ç åˆ†ç±»ï¼šHTTPçŠ¶æ€ç åæ˜ è¯·æ±‚å¤„ç†ç»“æœï¼Œéœ€è¦åˆ†ç±»ç›‘æ§
ğŸ”¸ å“åº”æ—¶é—´ç›‘æ§ï¼šç½‘ç«™æ€§èƒ½çš„é‡è¦æŒ‡æ ‡ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
ğŸ”¸ æ¥æºé¡µé¢åˆ†æï¼šäº†è§£ç”¨æˆ·ä»å“ªé‡Œæ¥åˆ°ç½‘ç«™ï¼Œåˆ†ææµé‡æ¥æº
ğŸ”¸ çœŸå®IPæå–ï¼šåœ¨CDN/ä»£ç†ç¯å¢ƒä¸‹è·å–ç”¨æˆ·çœŸå®IPåœ°å€
```

### 11.2 é…ç½®è¦ç‚¹é€ŸæŸ¥


**ğŸ¯ é…ç½®æ ¸å¿ƒè¦ç´ **

| é…ç½®é¡¹ | **ä½œç”¨** | **å…³é”®å‚æ•°** |
|--------|---------|-------------|
| **dissectå¤„ç†å™¨** | `è§£ææ—¥å¿—æ ¼å¼` | `tokenizeræ¨¡å¼å®šä¹‰` |
| **timestampå¤„ç†å™¨** | `æ—¶é—´å­—æ®µè§£æ` | `layoutsæ—¶é—´æ ¼å¼` |
| **geoipå¤„ç†å™¨** | `åœ°ç†ä½ç½®åˆ†æ` | `source IPå­—æ®µ` |
| **user_agentå¤„ç†å™¨** | `ç”¨æˆ·ä»£ç†è§£æ` | `fieldå’Œtarget_field` |
| **scriptå¤„ç†å™¨** | `è‡ªå®šä¹‰é€»è¾‘` | `JavaScriptè„šæœ¬` |
| **convertå¤„ç†å™¨** | `æ•°æ®ç±»å‹è½¬æ¢` | `å­—æ®µç±»å‹æ˜ å°„` |

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**
- **ğŸ¯ ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šäº†è§£ç”¨æˆ·è®¿é—®ä¹ æƒ¯ï¼Œä¼˜åŒ–ç½‘ç«™ç»“æ„
- **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šè¯†åˆ«æ…¢é¡µé¢ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ  
- **ğŸ”’ å®‰å…¨é˜²æŠ¤**ï¼šå‘ç°å¼‚å¸¸è®¿é—®æ¨¡å¼ï¼Œé˜²èŒƒæ”»å‡»
- **ğŸ“Š è¿è¥å†³ç­–**ï¼šåŸºäºæ•°æ®åˆ¶å®šè¿è¥ç­–ç•¥
- **ğŸš¨ æ•…éšœé¢„è­¦**ï¼šåŠæ—¶å‘ç°å’Œè§£å†³æœåŠ¡é—®é¢˜

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- **ç»Ÿä¸€æ—¥å¿—æ ¼å¼**ï¼šè§„èŒƒåŒ–çš„æ—¥å¿—å¤„ç†æµç¨‹
- **è‡ªåŠ¨åŒ–åˆ†æ**ï¼šå‡å°‘äººå·¥æ—¥å¿—åˆ†æå·¥ä½œé‡
- **å®æ—¶ç›‘æ§**ï¼šå¿«é€Ÿå“åº”ç³»ç»Ÿå¼‚å¸¸
- **å†å²è¿½æº¯**ï¼šå®Œæ•´çš„è®¿é—®è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥

### 11.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“ é…ç½®æœ€ä½³å®è·µ**
```
âœ… å»ºè®®åšæ³•ï¼š
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µå‘½å
- åˆç†è®¾ç½®æ—¥å¿—ä¿ç•™å‘¨æœŸ  
- é…ç½®é€‚å½“çš„é‡‡æ ·ç‡ï¼ˆé«˜æµé‡ç½‘ç«™ï¼‰
- å®šæœŸä¼˜åŒ–è§£æè§„åˆ™
- è®¾ç½®å…³é”®æŒ‡æ ‡å‘Šè­¦

âŒ é¿å…åšæ³•ï¼š
- è¿‡åº¦è§£æä¸é‡è¦çš„å­—æ®µ
- å¿½ç•¥æ•°æ®ç±»å‹è½¬æ¢
- ç¼ºå°‘é”™è¯¯å¤„ç†æœºåˆ¶
- æ²¡æœ‰é…ç½®ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

**ğŸ¯ ç›‘æ§é‡ç‚¹**
- **ğŸ“ˆ æ ¸å¿ƒæŒ‡æ ‡**ï¼šè®¿é—®é‡ã€é”™è¯¯ç‡ã€å“åº”æ—¶é—´ã€çŠ¶æ€ç åˆ†å¸ƒ
- **ğŸ” å¼‚å¸¸æ£€æµ‹**ï¼šçªå‘æµé‡ã€é”™è¯¯æ¿€å¢ã€å¼‚å¸¸IPè®¿é—®
- **ğŸ“Š è¶‹åŠ¿åˆ†æ**ï¼šè®¿é—®æ¨¡å¼å˜åŒ–ã€ç”¨æˆ·è¡Œä¸ºè¶‹åŠ¿
- **âš¡ æ€§èƒ½ç›‘æ§**ï¼šé¡µé¢åŠ è½½é€Ÿåº¦ã€æœåŠ¡å™¨å“åº”æ—¶é—´

**æ ¸å¿ƒè®°å¿†**ï¼š
- Webæ—¥å¿—åˆ†ææ˜¯ç½‘ç«™è¿ç»´çš„é‡è¦ç¯èŠ‚
- åˆç†çš„å­—æ®µè§£æå’Œåˆ†ç±»æ˜¯åˆ†æçš„åŸºç¡€
- å®æ—¶ç›‘æ§å’Œå†å²åˆ†æç›¸ç»“åˆ
- å…³æ³¨ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡