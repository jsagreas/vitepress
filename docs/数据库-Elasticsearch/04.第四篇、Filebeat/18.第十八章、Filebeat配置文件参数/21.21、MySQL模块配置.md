---
title: 21、MySQL模块配置
---
## 📚 目录

1. [MySQL模块概述](#1-MySQL模块概述)
2. [模块启用与基础配置](#2-模块启用与基础配置)
3. [错误日志配置详解](#3-错误日志配置详解)
4. [慢查询日志配置](#4-慢查询日志配置)
5. [二进制日志配置](#5-二进制日志配置)
6. [日志格式与多行处理](#6-日志格式与多行处理)
7. [完整配置示例](#7-完整配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🗄️ MySQL模块概述


### 1.1 什么是MySQL模块


**🔸 简单理解**
```
MySQL模块就像一个专门的"翻译官"：
• 普通Filebeat：需要手动告诉它怎么读MySQL日志
• MySQL模块：已经预设好了MySQL日志的读取规则

就像：
❌ 自己写说明书：复杂、容易出错
✅ 用现成说明书：简单、已验证
```

> **💡 核心理解**
> MySQL模块是Filebeat预配置的模板，专门用来收集和解析MySQL数据库的各种日志。它已经知道MySQL日志的格式，你只需要告诉它日志文件在哪里就行了。

**🎯 支持的日志类型**
```
三大核心日志：
📋 错误日志 (Error Log)    ← 数据库启动、运行错误
🐌 慢查询日志 (Slow Log)   ← 执行慢的SQL语句  
📊 二进制日志 (Binary Log) ← 数据变更记录
```

### 1.2 为什么要用MySQL模块


**传统方式 vs 模块方式对比**：

| 方面 | **传统手动配置** | **MySQL模块** |
|------|-----------------|---------------|
| 🔧 **配置复杂度** | `需要写复杂的正则表达式` | `几行配置搞定` |
| ⏱️ **部署时间** | `数小时调试` | `几分钟完成` |
| 🎯 **准确性** | `容易出错，需要测试` | `经过验证，开箱即用` |
| 📈 **维护成本** | `需要持续维护规则` | `官方维护，自动更新` |

---

## 2. ⚙️ 模块启用与基础配置


### 2.1 启用MySQL模块


**🔸 命令行启用方式**
```bash
# 启用MySQL模块
filebeat modules enable mysql

# 查看已启用的模块
filebeat modules list

# 禁用MySQL模块（如果需要）
filebeat modules disable mysql
```

> **⚠️ 注意事项**
> 启用模块后，Filebeat会在`modules.d/`目录下生成`mysql.yml`配置文件

### 2.2 基础模块配置


**📋 基本配置结构**
```yaml
# modules.d/mysql.yml
- module: mysql
  # 错误日志配置
  error:
    enabled: true
    var.paths:
      - /var/log/mysql/error.log
      
  # 慢查询日志配置  
  slowlog:
    enabled: true
    var.paths:
      - /var/log/mysql/slow.log
      
  # 二进制日志配置
  binlog:
    enabled: false
    var.paths:
      - /var/log/mysql/mysql-bin.*
```

**🔍 配置说明**
```
module: mysql          ← 指定使用MySQL模块
error/slowlog/binlog   ← 三种日志类型
enabled: true/false    ← 是否启用该类型日志
var.paths             ← 日志文件路径（支持通配符）
```

---

## 3. 📋 错误日志配置详解


### 3.1 错误日志基本概念


**🔸 什么是MySQL错误日志**
```
错误日志记录内容：
🚨 数据库启动和关闭信息
❌ 运行过程中的错误信息
⚠️ 警告和注意事项
🔧 重要的系统事件

作用：
• 故障诊断的第一手资料
• 系统健康状态监控  
• 安全问题追踪
```

### 3.2 错误日志配置参数


**📊 完整配置选项**
```yaml
- module: mysql
  error:
    enabled: true                    # 是否启用错误日志收集
    var.paths:                       # 错误日志文件路径
      - /var/log/mysql/error.log
      - /var/log/mysqld.log          # CentOS/RHEL默认路径
      - /var/log/mysql/mysqld.err    # 其他可能路径
    
    # 高级配置（可选）
    input:
      close_inactive: 5m             # 文件无活动5分钟后关闭
      scan_frequency: 10s            # 扫描新文件频率
      harvester_buffer_size: 16384   # 读取缓冲区大小
```

**🎯 路径配置最佳实践**
```yaml
# 方法1：具体路径（推荐生产环境）
var.paths:
  - /var/log/mysql/error.log

# 方法2：通配符路径（适合多实例）  
var.paths:
  - /var/log/mysql*/error.log
  - /data/mysql*/logs/error.log

# 方法3：多路径覆盖（兼容性最好）
var.paths:
  - /var/log/mysql/error.log
  - /var/log/mysqld.log
  - /usr/local/mysql/data/*.err
```

### 3.3 错误日志格式示例


**📄 典型错误日志内容**
```
2025-09-21T10:30:15.123456Z 0 [System] [MY-010116] [Server] /usr/sbin/mysqld starting as process 1234
2025-09-21T10:30:15.234567Z 0 [Warning] [MY-010068] [Server] CA certificate ca.pem is self signed.
2025-09-21T10:30:15.345678Z 0 [System] [MY-013576] [InnoDB] InnoDB initialization has started.
2025-09-21T10:30:16.456789Z 0 [ERROR] [MY-012345] [InnoDB] Cannot allocate memory for the buffer pool
```

> **💡 日志解读**
> - `时间戳`：事件发生时间
> - `线程ID`：处理线程编号（0表示系统线程）
> - `级别`：System/Warning/Error等
> - `错误码`：MY-XXXXXX格式的错误代码
> - `组件`：Server/InnoDB等组件名
> - `消息`：具体错误描述

---

## 4. 🐌 慢查询日志配置


### 4.1 慢查询日志基本概念


**🔸 什么是慢查询日志**
```
慢查询日志用途：
📊 记录执行时间超过阈值的SQL语句
🔍 性能优化的重要依据
📈 数据库调优的指南针

典型慢查询场景：
• 没有索引的全表扫描
• 复杂的多表关联查询
• 大数据量排序操作
• 锁等待时间过长的查询
```

### 4.2 慢查询日志配置


**📊 配置参数详解**
```yaml
- module: mysql
  slowlog:
    enabled: true                    # 启用慢查询日志收集
    var.paths:
      - /var/log/mysql/slow.log      # 慢查询日志路径
      - /var/lib/mysql/slow.log      # 可能的其他路径
    
    # 多行处理配置（重要！）
    multiline:
      pattern: '^# Time:'            # 慢查询开始标志
      negate: true                   # 取反匹配
      match: after                   # 匹配位置
      max_lines: 500                 # 最大行数限制
      timeout: 5s                    # 超时设置
```

> **⚠️ 重要提醒**
> 慢查询日志通常是多行格式，一个查询可能跨越多行，所以必须配置`multiline`参数正确处理

### 4.3 慢查询日志格式解析


**📄 典型慢查询日志格式**
```
# Time: 2025-09-21T10:45:30.123456Z
# User@Host: root[root] @ localhost []  Id:    12
# Query_time: 2.123456  Lock_time: 0.000234 Rows_sent: 1000  Rows_examined: 50000
# Thread_id: 12  Schema: mydb  QC_hit: No
# Errno: 0  Killed: 0  Bytes_received: 0  Bytes_sent: 25678
SET timestamp=1695285930;
SELECT * FROM large_table WHERE name LIKE '%test%' ORDER BY created_at DESC LIMIT 1000;
```

**🔍 字段含义解释**
```
关键性能指标：
🕐 Query_time: 2.123456    ← SQL执行耗时（秒）
🔒 Lock_time: 0.000234     ← 锁等待时间
📤 Rows_sent: 1000         ← 返回行数  
👀 Rows_examined: 50000    ← 扫描行数

重要提醒：
如果 Rows_examined >> Rows_sent，说明查询效率很低！
```

---

## 5. 📊 二进制日志配置


### 5.1 二进制日志基本概念


**🔸 什么是二进制日志（Binlog）**
```
二进制日志作用：
📝 记录所有数据变更操作（INSERT/UPDATE/DELETE）
🔄 主从复制的基础
💾 数据恢复的重要依据
🕐 点对点时间恢复

注意事项：
⚠️ 二进制日志文件通常很大
⚠️ 对磁盘IO有一定影响
⚠️ 需要定期清理避免磁盘满
```

### 5.2 二进制日志配置


**📊 配置参数**
```yaml
- module: mysql
  binlog:
    enabled: false                   # 默认关闭（谨慎开启）
    var.paths:
      - /var/log/mysql/mysql-bin.*   # 二进制日志路径
      - /var/lib/mysql/mysql-bin.*   # 默认数据目录路径
    
    # 性能优化配置
    input:
      close_inactive: 2m             # 更短的关闭时间
      scan_frequency: 30s            # 降低扫描频率
      max_bytes: 10485760           # 限制单次读取大小(10MB)
      multiline.max_lines: 1000     # 限制多行数量
```

> **⚠️ 生产环境建议**
> 二进制日志文件通常很大，在生产环境中建议：
> 1. 仔细评估是否真的需要收集
> 2. 如果需要，要配置合适的过滤规则
> 3. 确保Elasticsearch有足够存储空间

### 5.3 二进制日志格式类型


**📋 MySQL二进制日志格式**
```
三种主要格式：
🔸 STATEMENT：记录SQL语句本身
🔸 ROW：记录每行数据的变更
🔸 MIXED：混合模式，自动选择

Filebeat处理方式：
• 解析二进制格式为可读文本
• 提取关键元数据信息
• 保留时间戳和事务信息
```

---

## 6. 🎨 日志格式与多行处理


### 6.1 日志格式设置


**🔸 log_format参数说明**
```yaml
- module: mysql
  error:
    enabled: true
    var.paths: ["/var/log/mysql/error.log"]
    # log_format通常不需要手动设置，模块自动识别
    
  slowlog:
    enabled: true  
    var.paths: ["/var/log/mysql/slow.log"]
    # 慢查询日志格式由MySQL配置决定
    input:
      # 如果MySQL使用了特殊的慢查询格式，可以自定义解析
      processors:
        - script:
            lang: javascript
            source: >
              // 自定义日志解析逻辑（高级用法）
```

### 6.2 多行配置详解


**🔄 多行处理原理**
```
问题：一个SQL查询可能分多行记录
# Time: 2025-09-21T10:45:30.123456Z    ← 第1行
# User@Host: root[root] @ localhost []   ← 第2行  
# Query_time: 2.123456                   ← 第3行
SET timestamp=1695285930;               ← 第4行
SELECT * FROM table WHERE...           ← 第5行

解决：使用multiline将多行合并为一个事件
```

**📊 多行配置参数详解**
```yaml
multiline:
  pattern: '^# Time:'          # 正则匹配模式
  negate: true                 # 是否取反
  match: after                 # 匹配位置
  max_lines: 500              # 最大行数
  timeout: 5s                 # 超时时间
  
# 配置含义：
# 以"# Time:"开头的行作为新事件开始
# negate: true表示不匹配pattern的行追加到前一个事件
# match: after表示匹配的行追加到后面
```

**🔍 常用多行模式**
```yaml
# MySQL慢查询日志（推荐）
multiline:
  pattern: '^# Time:|^# User@Host:'
  negate: true  
  match: after
  max_lines: 500

# MySQL错误日志（一般不需要，单行即可）
# 如果错误信息跨行，可以使用：
multiline:
  pattern: '^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}'
  negate: true
  match: after
```

---

## 7. 📝 完整配置示例


### 7.1 生产环境配置模板


```yaml
# modules.d/mysql.yml - 生产环境推荐配置
- module: mysql
  
  # 错误日志 - 必须启用
  error:
    enabled: true
    var.paths:
      - /var/log/mysql/error.log
      - /var/log/mysqld.log              # 兼容不同发行版
    input:
      close_inactive: 5m                 # 5分钟无活动关闭文件
      scan_frequency: 10s                # 10秒扫描一次
      ignore_older: 24h                  # 忽略24小时前的文件
      
  # 慢查询日志 - 强烈推荐  
  slowlog:
    enabled: true
    var.paths:
      - /var/log/mysql/slow.log
    input:
      close_inactive: 10m                # 慢查询文件可能更新较慢
      multiline:
        pattern: '^# Time:'
        negate: true
        match: after
        max_lines: 1000                  # 复杂查询可能很长
        timeout: 10s
      fields:
        environment: production          # 添加环境标识
        mysql_instance: main            # 实例标识
        
  # 二进制日志 - 按需启用
  binlog:
    enabled: false                       # 谨慎启用
    var.paths:
      - /var/lib/mysql/mysql-bin.*
    input:
      close_inactive: 1m
      scan_frequency: 60s                # 降低扫描频率
      max_bytes: 10485760               # 限制读取大小
      include_lines: ['GTID', 'BEGIN', 'COMMIT']  # 只收集关键行
      fields:
        log_type: binlog
```

### 7.2 开发环境简化配置


```yaml
# modules.d/mysql.yml - 开发环境配置
- module: mysql
  
  # 开发环境主要关注错误和慢查询
  error:
    enabled: true
    var.paths:
      - /usr/local/mysql/data/*.err      # Mac开发环境
      - /var/log/mysql/error.log         # Linux开发环境
      
  slowlog:
    enabled: true
    var.paths:
      - /usr/local/mysql/data/*slow.log
      - /var/log/mysql/slow.log
    input:
      multiline:
        pattern: '^# Time:'
        negate: true
        match: after
        max_lines: 500
      fields:
        environment: development
        
  # 开发环境不需要binlog
  binlog:
    enabled: false
```

### 7.3 多实例配置示例


```yaml
# 多个MySQL实例的配置
- module: mysql
  error:
    enabled: true
    var.paths:
      - /data/mysql-3306/logs/error.log
    input:
      fields:
        mysql_instance: "mysql-3306"
        mysql_port: 3306
        
- module: mysql  
  error:
    enabled: true
    var.paths:
      - /data/mysql-3307/logs/error.log
    input:
      fields:
        mysql_instance: "mysql-3307"  
        mysql_port: 3307
        
  slowlog:
    enabled: true
    var.paths:
      - /data/mysql-3307/logs/slow.log
    input:
      multiline:
        pattern: '^# Time:'
        negate: true  
        match: after
      fields:
        mysql_instance: "mysql-3307"
        mysql_port: 3307
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 MySQL模块本质：预配置的日志收集模板，简化配置过程
🔸 三种日志类型：错误日志（必需）、慢查询日志（推荐）、二进制日志（按需）
🔸 关键配置项：enabled开关、var.paths路径、multiline多行处理
🔸 生产建议：错误日志必开，慢查询强烈推荐，二进制日志谨慎使用
```

### 8.2 配置最佳实践


**🎯 配置选择指南**

| 环境类型 | **错误日志** | **慢查询日志** | **二进制日志** | **建议理由** |
|----------|-------------|---------------|---------------|-------------|
| 🏭 **生产环境** | `✅ 必须启用` | `✅ 强烈推荐` | `⚠️ 谨慎启用` | `性能监控为主，避免过载` |
| 🔧 **测试环境** | `✅ 必须启用` | `✅ 推荐启用` | `✅ 可以启用` | `完整测试，验证功能` |
| 💻 **开发环境** | `✅ 必须启用` | `✅ 推荐启用` | `❌ 不建议` | `关注错误和性能` |

**🔧 关键配置技巧**
```
路径配置：
• 使用绝对路径，避免相对路径问题
• 支持通配符，但要注意性能影响
• 多路径配置提高兼容性

多行处理：
• 慢查询日志必须配置multiline
• pattern匹配要准确，避免误合并
• 设置合理的max_lines和timeout

性能优化：
• 合理设置scan_frequency避免过于频繁
• 使用close_inactive及时关闭文件句柄  
• 二进制日志要限制max_bytes和include_lines
```

### 8.3 常见问题与解决


> **🤔 问题1：慢查询日志没有被正确解析**
> 
> **原因**：缺少multiline配置或pattern不匹配
> 
> **解决**：
> ```yaml
> multiline:
>   pattern: '^# Time:|^# User@Host:'
>   negate: true
>   match: after
> ```

> **🤔 问题2：二进制日志导致Filebeat性能下降**
> 
> **原因**：二进制日志文件太大，扫描频率过高
> 
> **解决**：
> ```yaml
> binlog:
>   input:
>     scan_frequency: 60s      # 降低扫描频率
>     max_bytes: 10485760     # 限制读取大小
>     include_lines: ['GTID']  # 只收集关键内容
> ```

> **🤔 问题3：找不到MySQL日志文件**
> 
> **原因**：不同系统的MySQL日志路径不同
> 
> **解决**：
> ```bash
> # 查找MySQL配置文件
> mysql --help | grep "Default options"
> 
> # 查看当前日志配置
> SHOW VARIABLES LIKE '%log%';
> ```

### 8.4 实际应用价值


**📊 监控与告警场景**
- **故障诊断**：通过错误日志快速定位数据库问题
- **性能优化**：分析慢查询日志优化SQL性能
- **容量规划**：监控日志增长趋势预测存储需求
- **安全审计**：跟踪数据库访问和操作记录

**🔧 运维实践价值**
- **自动化运维**：结合ELK搭建自动化监控平台
- **问题预警**：设置基于日志的告警规则
- **性能基线**：建立数据库性能基线和趋势分析
- **故障回溯**：快速定位和复现历史问题

**核心记忆口诀**：
- MySQL模块三日志，错误慢查二进制
- 错误必开慢推荐，二进制要看情况
- 多行处理很重要，慢查询用pattern
- 路径配置要准确，性能调优记心上