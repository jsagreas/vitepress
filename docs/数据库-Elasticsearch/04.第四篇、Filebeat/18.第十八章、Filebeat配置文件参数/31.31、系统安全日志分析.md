---
title: 31ã€ç³»ç»Ÿå®‰å…¨æ—¥å¿—åˆ†æ
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨æ—¥å¿—åˆ†ææ¦‚è¿°](#1-å®‰å…¨æ—¥å¿—åˆ†ææ¦‚è¿°)
2. [å®‰å…¨æ—¥å¿—æ”¶é›†é…ç½®](#2-å®‰å…¨æ—¥å¿—æ”¶é›†é…ç½®)
3. [å®‰å…¨äº‹ä»¶è¿‡æ»¤ä¸æ ‡è®°](#3-å®‰å…¨äº‹ä»¶è¿‡æ»¤ä¸æ ‡è®°)
4. [æ—¥å¿—è§£æä¸åœ°ç†ä½ç½®åˆ†æ](#4-æ—¥å¿—è§£æä¸åœ°ç†ä½ç½®åˆ†æ)
5. [å¨èƒæƒ…æŠ¥é›†æˆ](#5-å¨èƒæƒ…æŠ¥é›†æˆ)
6. [å‘Šè­¦ä¸ä»ªè¡¨æ¿é…ç½®](#6-å‘Šè­¦ä¸ä»ªè¡¨æ¿é…ç½®)
7. [æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤](#7-æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®‰å…¨æ—¥å¿—åˆ†ææ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®‰å…¨æ—¥å¿—åˆ†æ


**ç®€å•ç†è§£**ï¼šå°±åƒç»™ä½ çš„ç³»ç»Ÿå®‰è£…äº†ä¸€ä¸ª"å®‰å…¨ç›‘æ§æ‘„åƒå¤´"ï¼Œéšæ—¶è®°å½•å’Œåˆ†æå¯ç–‘æ´»åŠ¨ã€‚

```
ä¼ ç»Ÿå®‰å…¨ç®¡ç† vs ç°ä»£å®‰å…¨æ—¥å¿—åˆ†æ

ä¼ ç»Ÿæ–¹å¼ï¼š               ç°ä»£æ–¹å¼ï¼š
æ‰‹å·¥æŸ¥çœ‹æ—¥å¿—    â†’      è‡ªåŠ¨æ”¶é›†åˆ†æ
äº‹åå‘ç°é—®é¢˜    â†’      å®æ—¶ç›‘æ§é¢„è­¦  
å•ç‚¹åˆ†æ       â†’      å…¨å±€å…³è”åˆ†æ
ç»éªŒåˆ¤æ–­       â†’      æ™ºèƒ½å¨èƒæ£€æµ‹
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼**
- **å®æ—¶ç›‘æ§**ï¼š7Ã—24å°æ—¶ä¸é—´æ–­ç›‘æ§ç³»ç»Ÿå®‰å…¨çŠ¶æ€
- **å¿«é€Ÿå“åº”**ï¼šç§’çº§å‘ç°å’Œé€šæŠ¥å®‰å…¨å¨èƒ
- **å…¨å±€è§†è§’**ï¼šä»å¤šä¸ªç»´åº¦åˆ†æå®‰å…¨æ€åŠ¿
- **åˆè§„å®¡è®¡**ï¼šæ»¡è¶³å®‰å…¨åˆè§„è¦æ±‚

### 1.2 å¸¸è§å®‰å…¨æ—¥å¿—ç±»å‹


**ğŸ“‹ ä¸»è¦æ—¥å¿—æº**
```
ç³»ç»Ÿå±‚é¢ï¼š
â”œâ”€â”€ SSHç™»å½•æ—¥å¿— (/var/log/auth.log)
â”œâ”€â”€ ç³»ç»Ÿè°ƒç”¨æ—¥å¿— (/var/log/syslog) 
â”œâ”€â”€ é˜²ç«å¢™æ—¥å¿— (/var/log/ufw.log)
â””â”€â”€ å†…æ ¸å®‰å…¨æ—¥å¿— (/var/log/kern.log)

åº”ç”¨å±‚é¢ï¼š
â”œâ”€â”€ Webè®¿é—®æ—¥å¿— (Apache/Nginx)
â”œâ”€â”€ æ•°æ®åº“å®¡è®¡æ—¥å¿— (MySQL/PostgreSQL)
â”œâ”€â”€ åº”ç”¨ç¨‹åºæ—¥å¿— (è‡ªå®šä¹‰æ ¼å¼)
â””â”€â”€ APIè®¿é—®æ—¥å¿— (REST/GraphQL)

ç½‘ç»œå±‚é¢ï¼š
â”œâ”€â”€ é˜²ç«å¢™è§„åˆ™æ—¥å¿—
â”œâ”€â”€ å…¥ä¾µæ£€æµ‹æ—¥å¿— (IDS/IPS)
â”œâ”€â”€ ç½‘ç»œæµé‡æ—¥å¿— (NetFlow)
â””â”€â”€ DNSæŸ¥è¯¢æ—¥å¿—
```

### 1.3 å®‰å…¨åˆ†æçš„æ ¸å¿ƒæŒ‡æ ‡


**ğŸ” å…³é”®ç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§å†…å®¹** | **å¨èƒç­‰çº§** | **å“åº”æ—¶é—´** |
|---------|-------------|-------------|-------------|
| ğŸ”´ **é«˜å±** | `æš´åŠ›ç ´è§£æ”»å‡»` | `Critical` | `ç«‹å³å¤„ç†` |
| ğŸŸ¡ **ä¸­å±** | `å¼‚å¸¸ç™»å½•ä½ç½®` | `Warning` | `1å°æ—¶å†…` |
| ğŸŸ¢ **ä½å±** | `é¢‘ç¹è®¿é—®å¤±è´¥` | `Info` | `24å°æ—¶å†…` |
| ğŸ”µ **ä¿¡æ¯** | `æ­£å¸¸ç”¨æˆ·è¡Œä¸º` | `Normal` | `å®šæœŸå›é¡¾` |

---

## 2. ğŸ“ å®‰å…¨æ—¥å¿—æ”¶é›†é…ç½®


### 2.1 åŸºç¡€æ”¶é›†é…ç½®


**ğŸ”§ SSHå®‰å…¨æ—¥å¿—æ”¶é›†**

```yaml
# filebeat.yml - SSHç™»å½•ç›‘æ§é…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/auth.log          # Ubuntu/Debian
    - /var/log/secure            # CentOS/RHEL
  
  # ğŸ·ï¸ ä¸ºSSHæ—¥å¿—æ·»åŠ æ ‡è¯†
  fields:
    log_type: ssh_security
    service: authentication
    environment: production
  fields_under_root: true
  
  # ğŸ“ æ’é™¤æ­£å¸¸çš„ç³»ç»Ÿæ¶ˆæ¯
  exclude_lines:
    - 'CRON'                     # å®šæ—¶ä»»åŠ¡æ—¥å¿—
    - 'systemd'                  # ç³»ç»ŸæœåŠ¡æ—¥å¿—
    - 'sudo.*session opened'     # æ­£å¸¸sudoæ“ä½œ
```

**ğŸŒ WebæœåŠ¡å™¨å®‰å…¨æ—¥å¿—**

```yaml
# Webè®¿é—®æ—¥å¿—å®‰å…¨ç›‘æ§
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
    - /var/log/nginx/error.log
    - /var/log/apache2/access.log
  
  fields:
    log_type: web_security
    service: webserver
  fields_under_root: true
  
  # ğŸ¯ å¤šè¡Œæ—¥å¿—åˆå¹¶ (å¤„ç†å †æ ˆè·Ÿè¸ª)
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
```

### 2.2 é«˜çº§æ”¶é›†é…ç½®


**ğŸ”„ åŠ¨æ€æ–‡ä»¶å‘ç°**

```yaml
# ç›‘æ§å¤šä¸ªæœåŠ¡çš„æ—¥å¿—ç›®å½•
- type: log
  enabled: true
  paths:
    - /var/log/*/security.log    # é€šé…ç¬¦åŒ¹é…
    - /opt/apps/*/logs/audit.log # åº”ç”¨å®¡è®¡æ—¥å¿—
  
  # ğŸ“Š æ–‡ä»¶å…ƒæ•°æ®æ”¶é›†
  scan_frequency: 5s             # 5ç§’æ‰«æä¸€æ¬¡æ–°æ–‡ä»¶
  harvester_buffer_size: 32768   # 32KBç¼“å†²åŒº
  max_bytes: 10485760           # å•è¡Œæœ€å¤§10MB
  
  # ğŸƒâ€â™‚ï¸ æ€§èƒ½ä¼˜åŒ–
  close_inactive: 1h            # 1å°æ—¶æ— æ´»åŠ¨å…³é—­æ–‡ä»¶
  clean_inactive: 48h           # 48å°æ—¶åæ¸…ç†æ–‡ä»¶çŠ¶æ€
```

**ğŸ” æ•æ„Ÿä¿¡æ¯å¤„ç†**

```yaml
# å¤„ç†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ—¥å¿—
processors:
- drop_fields:
    fields: ["beat", "input", "ecs", "host.mac"]  # ç§»é™¤ä¸å¿…è¦å­—æ®µ

- dissect:
    tokenizer: "%{timestamp} %{hostname} %{process}: %{message}"
    field: "message"
    target_prefix: "dissect"

# ğŸ”’ å¯†ç å’Œå¯†é’¥è„±æ•
- script:
    lang: javascript
    source: >
      function process(event) {
        var msg = event.Get("message");
        if (msg) {
          // è„±æ•å¯†ç å­—æ®µ
          msg = msg.replace(/password=\w+/gi, "password=***");
          msg = msg.replace(/token=[\w\-]+/gi, "token=***");
          event.Put("message", msg);
        }
      }
```

---

## 3. ğŸ” å®‰å…¨äº‹ä»¶è¿‡æ»¤ä¸æ ‡è®°


### 3.1 å®‰å…¨äº‹ä»¶è¯†åˆ«


**âš ï¸ åŸºäºå…³é”®è¯çš„å¨èƒæ£€æµ‹**

```yaml
# æ£€æµ‹SSHæš´åŠ›ç ´è§£æ”»å‡»
- type: log
  enabled: true
  paths:
    - /var/log/auth.log
  
  # ğŸ¯ åªæ”¶é›†å®‰å…¨ç›¸å…³äº‹ä»¶
  include_lines:
    - 'Failed password'          # å¯†ç å¤±è´¥
    - 'Invalid user'             # æ— æ•ˆç”¨æˆ·
    - 'authentication failure'   # è®¤è¯å¤±è´¥
    - 'sudo.*FAILED'            # sudoå¤±è´¥
    - 'session opened for user root'  # rootç™»å½•
  
  # âŒ æ’é™¤æ­£å¸¸äº‹ä»¶
  exclude_lines:
    - 'session opened for user.*from'   # æ­£å¸¸ç”¨æˆ·ç™»å½•
    - 'sudo.*session opened'           # æ­£å¸¸sudo
```

**ğŸ·ï¸ åŠ¨æ€æ ‡ç­¾æ·»åŠ **

```yaml
processors:
# ğŸš¨ æ ¹æ®å†…å®¹æ·»åŠ å¨èƒç­‰çº§æ ‡ç­¾
- add_tags:
    tags: ["high_risk", "brute_force"]
    when:
      regexp:
        message: "Failed password.*from (?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}"
        
- add_tags:
    tags: ["medium_risk", "privilege_escalation"]  
    when:
      contains:
        message: "sudo"

- add_tags:
    tags: ["critical", "root_access"]
    when:
      and:
        - contains:
            message: "session opened for user root"
        - not:
            contains:
              source: "localhost"
```

### 3.2 åœ°ç†ä½ç½®è¿‡æ»¤


**ğŸŒ åŸºäºIPåœ°ç†ä½ç½®çš„å¨èƒè¯„ä¼°**

```yaml
# IPåœ°å€æå–å’Œåœ°ç†ä½ç½®åˆ†æ
processors:
- dissect:
    tokenizer: "%{} from %{source_ip} %{}"
    field: "message"
    
# ğŸ—ºï¸ åœ°ç†ä½ç½®ä¿¡æ¯æ·»åŠ   
- add_locale:
    format: "en-US"
    
- script:
    lang: javascript
    source: >
      function process(event) {
        var sourceIp = event.Get("source_ip");
        if (sourceIp) {
          // æ£€æŸ¥æ˜¯å¦ä¸ºå†…ç½‘IP
          if (sourceIp.match(/^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/)) {
            event.Put("network_location", "internal");
            event.Put("risk_level", "low");
          } else {
            event.Put("network_location", "external");
            event.Put("risk_level", "medium");
          }
          
          // å·²çŸ¥æ¶æ„IPæ£€æµ‹
          var maliciousIPs = ["1.2.3.4", "5.6.7.8"];
          if (maliciousIPs.includes(sourceIp)) {
            event.Put("threat_type", "known_malicious");
            event.Put("risk_level", "critical");
          }
        }
      }
```

### 3.3 é¢‘ç‡æ£€æµ‹é…ç½®


**ğŸ“Š åŸºäºæ—¶é—´çª—å£çš„å¼‚å¸¸æ£€æµ‹**

```yaml
# æ£€æµ‹çŸ­æ—¶é—´å†…çš„é‡å¤å¤±è´¥ç™»å½•
processors:
- fingerprint:
    fields: ["source_ip", "@timestamp"]
    target_field: "event_fingerprint"
    
- script:
    lang: javascript
    source: >
      function process(event) {
        var sourceIp = event.Get("source_ip");
        var timestamp = event.Get("@timestamp");
        
        // ç®€å•çš„å†…å­˜è®¡æ•°å™¨ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Redis)
        if (!global.failureCount) {
          global.failureCount = {};
        }
        
        if (!global.failureCount[sourceIp]) {
          global.failureCount[sourceIp] = [];
        }
        
        // æ·»åŠ å½“å‰æ—¶é—´æˆ³
        global.failureCount[sourceIp].push(timestamp);
        
        // æ¸…ç†5åˆ†é’Ÿå‰çš„è®°å½•
        var fiveMinutesAgo = new Date(Date.now() - 5*60*1000);
        global.failureCount[sourceIp] = global.failureCount[sourceIp]
          .filter(t => new Date(t) > fiveMinutesAgo);
        
        // å¦‚æœ5åˆ†é’Ÿå†…è¶…è¿‡5æ¬¡å¤±è´¥ï¼Œæ ‡è®°ä¸ºæš´åŠ›ç ´è§£
        if (global.failureCount[sourceIp].length >= 5) {
          event.Put("attack_type", "brute_force");
          event.Put("failure_count", global.failureCount[sourceIp].length);
          event.Put("risk_level", "critical");
        }
      }
```

---

## 4. ğŸ§© æ—¥å¿—è§£æä¸åœ°ç†ä½ç½®åˆ†æ


### 4.1 Grokæ¨¡å¼è§£æ


**ğŸ”§ SSHæ—¥å¿—è§£æ**

```yaml
# ä½¿ç”¨grokè§£æSSHæ—¥å¿—æ ¼å¼
processors:
- dissect:
    tokenizer: "%{timestamp} %{hostname} %{process}[%{pid}]: %{message}"
    field: "message"
    target_prefix: "ssh"

# ğŸ“ æ›´è¯¦ç»†çš„SSHäº‹ä»¶è§£æ
- script:
    lang: javascript
    source: >
      function process(event) {
        var msg = event.Get("ssh.message");
        if (!msg) return;
        
        // è§£æä¸åŒç±»å‹çš„SSHäº‹ä»¶
        var patterns = {
          // Failed password for root from 192.168.1.100 port 22 ssh2
          failed_password: /Failed password for (\w+) from ([\d.]+) port (\d+)/,
          
          // Accepted password for user from 192.168.1.100 port 22 ssh2  
          successful_login: /Accepted password for (\w+) from ([\d.]+) port (\d+)/,
          
          // Invalid user admin from 192.168.1.100
          invalid_user: /Invalid user (\w+) from ([\d.]+)/
        };
        
        for (var type in patterns) {
          var match = msg.match(patterns[type]);
          if (match) {
            event.Put("event_type", type);
            event.Put("username", match[1]);
            event.Put("source_ip", match[2]);
            if (match[3]) event.Put("source_port", parseInt(match[3]));
            break;
          }
        }
      }
```

**ğŸŒ Webè®¿é—®æ—¥å¿—è§£æ**

```yaml
# Apache/Nginxè®¿é—®æ—¥å¿—è§£æ
- dissect:
    tokenizer: '%{client_ip} - - [%{timestamp}] "%{method} %{url} %{http_version}" %{status_code} %{response_size} "%{referrer}" "%{user_agent}"'
    field: "message"
    target_prefix: "http"

# ğŸ” Webæ”»å‡»æ£€æµ‹
- script:
    lang: javascript
    source: >
      function process(event) {
        var url = event.Get("http.url");
        var userAgent = event.Get("http.user_agent");
        var statusCode = event.Get("http.status_code");
        
        if (!url) return;
        
        // æ£€æµ‹å¸¸è§Webæ”»å‡»
        var attacks = {
          sql_injection: /['";]|(\bunion\b|\bselect\b|\binsert\b|\bdelete\b|\bdrop\b)/i,
          xss: /(<script|javascript:|onload=|onerror=)/i,
          directory_traversal: /(\.\.[\/\\]){2,}/,
          command_injection: /[;&|`$()]/
        };
        
        for (var attack in attacks) {
          if (attacks[attack].test(url)) {
            event.Put("attack_type", attack);
            event.Put("risk_level", "high");
            break;
          }
        }
        
        // æ£€æµ‹å¼‚å¸¸User-Agent
        if (userAgent) {
          if (userAgent.includes("sqlmap") || userAgent.includes("nmap")) {
            event.Put("attack_type", "scanning_tool");
            event.Put("risk_level", "medium");
          }
        }
        
        // æ£€æµ‹å¼‚å¸¸çŠ¶æ€ç 
        if (statusCode >= 400) {
          event.Put("error_type", "client_error");
          if (statusCode >= 500) {
            event.Put("error_type", "server_error");
          }
        }
      }
```

### 4.2 GeoIPåœ°ç†ä½ç½®åˆ†æ


**ğŸ—ºï¸ IPåœ°ç†ä½ç½®é…ç½®**

```yaml
# ä¸‹è½½GeoIPæ•°æ®åº“ (éœ€è¦å…ˆä¸‹è½½GeoLite2æ•°æ®åº“)
# wget https://download.maxmind.com/app/geoip_download?edition_id=GeoLite2-City&license_key=YOUR_KEY&suffix=tar.gz

processors:
- add_host_metadata:
    when.not.contains.tags: geoip_processed

# ğŸŒ åœ°ç†ä½ç½®ä¿¡æ¯æ·»åŠ 
- script:
    lang: javascript
    source: >
      function process(event) {
        var sourceIp = event.Get("source_ip");
        if (!sourceIp || sourceIp.match(/^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/)) {
          // å†…ç½‘IPï¼Œè·³è¿‡GeoIPæŸ¥è¯¢
          event.Put("geoip.location", "internal_network");
          event.Put("geoip.country_name", "Internal");
          return;
        }
        
        // æ¨¡æ‹ŸGeoIPæŸ¥è¯¢ (å®é™…åº”ä½¿ç”¨MaxMindåº“)
        var geoData = mockGeoIPLookup(sourceIp);
        if (geoData) {
          event.Put("geoip.country_name", geoData.country);
          event.Put("geoip.city_name", geoData.city);
          event.Put("geoip.latitude", geoData.lat);
          event.Put("geoip.longitude", geoData.lon);
          
          // ğŸš¨ æ£€æµ‹å¼‚å¸¸åœ°ç†ä½ç½®
          var suspiciousCountries = ["XX", "YY"]; // æ ¹æ®ä¸šåŠ¡è°ƒæ•´
          if (suspiciousCountries.includes(geoData.country_code)) {
            event.Put("geo_risk", "high");
            event.Put("risk_level", "medium");
          }
        }
      }
      
      function mockGeoIPLookup(ip) {
        // å®é™…ç¯å¢ƒä¸­åº”ä½¿ç”¨çœŸå®çš„GeoIPæœåŠ¡
        return {
          country: "Unknown",
          city: "Unknown", 
          lat: 0,
          lon: 0,
          country_code: "UN"
        };
      }
```

---

## 5. ğŸ”— å¨èƒæƒ…æŠ¥é›†æˆ


### 5.1 å¨èƒæƒ…æŠ¥æºé…ç½®


**ğŸ“¡ å¤–éƒ¨å¨èƒæƒ…æŠ¥é›†æˆ**

```yaml
# å¨èƒæƒ…æŠ¥æ£€æŸ¥å¤„ç†å™¨
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var sourceIp = event.Get("source_ip");
        if (!sourceIp) return;
        
        // ğŸ›¡ï¸ å¨èƒæƒ…æŠ¥æºæ£€æŸ¥
        var threatIntelSources = {
          // æ¶æ„IPé»‘åå• (ç¤ºä¾‹æ•°æ®)
          malicious_ips: [
            "198.51.100.1",
            "203.0.113.1", 
            "192.0.2.1"
          ],
          
          // å·²çŸ¥åƒµå°¸ç½‘ç»œC&CæœåŠ¡å™¨
          botnet_cc: [
            "198.51.100.2",
            "203.0.113.2"
          ],
          
          // TORå‡ºå£èŠ‚ç‚¹ (å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†)
          tor_exits: [
            "198.51.100.3"
          ]
        };
        
        // æ£€æŸ¥IPæ˜¯å¦åœ¨å¨èƒæƒ…æŠ¥ä¸­
        for (var category in threatIntelSources) {
          if (threatIntelSources[category].includes(sourceIp)) {
            event.Put("threat_intel.category", category);
            event.Put("threat_intel.source", "internal_db");
            event.Put("risk_level", "critical");
            
            // æ ¹æ®å¨èƒç±»å‹è®¾ç½®ä¸åŒçš„å¤„ç†ç­–ç•¥
            switch(category) {
              case "malicious_ips":
                event.Put("recommended_action", "block_immediately");
                break;
              case "botnet_cc":
                event.Put("recommended_action", "isolate_and_investigate");
                break;
              case "tor_exits":
                event.Put("recommended_action", "monitor_closely");
                break;
            }
            break;
          }
        }
        
        // ğŸ” åŸŸåä¿¡èª‰æ£€æŸ¥ (å¦‚æœæœ‰åŸŸåä¿¡æ¯)
        var hostname = event.Get("hostname");
        if (hostname) {
          var suspiciousDomains = ["malware.example.com", "phishing.test"];
          if (suspiciousDomains.some(domain => hostname.includes(domain))) {
            event.Put("threat_intel.category", "malicious_domain");
            event.Put("risk_level", "high");
          }
        }
      }
```

### 5.2 åŠ¨æ€å¨èƒæƒ…æŠ¥æ›´æ–°


**ğŸ”„ å®æ—¶å¨èƒæƒ…æŠ¥åŒæ­¥**

```yaml
# å®šæœŸæ›´æ–°å¨èƒæƒ…æŠ¥çš„é…ç½®
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        // æ£€æŸ¥å¨èƒæƒ…æŠ¥æ›´æ–°æ—¶é—´
        var now = new Date();
        if (!global.threatIntelLastUpdate || 
            (now - global.threatIntelLastUpdate) > 3600000) { // 1å°æ—¶æ›´æ–°ä¸€æ¬¡
          
          // æ¨¡æ‹Ÿä»å¤–éƒ¨APIè·å–å¨èƒæƒ…æŠ¥
          global.threatIntel = updateThreatIntelligence();
          global.threatIntelLastUpdate = now;
        }
        
        // ä½¿ç”¨æœ€æ–°çš„å¨èƒæƒ…æŠ¥è¿›è¡Œæ£€æŸ¥
        var sourceIp = event.Get("source_ip");
        if (sourceIp && global.threatIntel && global.threatIntel.malicious_ips) {
          if (global.threatIntel.malicious_ips.includes(sourceIp)) {
            event.Put("threat_intel.status", "malicious");
            event.Put("threat_intel.last_updated", global.threatIntelLastUpdate.toISOString());
            event.Put("risk_level", "critical");
          }
        }
      }
      
      function updateThreatIntelligence() {
        // å®é™…ç¯å¢ƒä¸­åº”ä»çœŸå®çš„å¨èƒæƒ…æŠ¥æºè·å–
        return {
          malicious_ips: ["1.2.3.4", "5.6.7.8"],
          last_update: new Date()
        };
      }
```

---

## 6. ğŸš¨ å‘Šè­¦ä¸ä»ªè¡¨æ¿é…ç½®


### 6.1 å‘Šè­¦è§„åˆ™é…ç½®


**âš¡ å®æ—¶å‘Šè­¦è¾“å‡º**

```yaml
# è¾“å‡ºåˆ°Elasticsearchï¼Œç”¨äºKibanaå‘Šè­¦
output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  
  # ğŸ¯ æŒ‰é£é™©ç­‰çº§åˆ›å»ºä¸åŒç´¢å¼•
  indices:
    - index: "security-critical-%{+yyyy.MM.dd}"
      when.equals:
        risk_level: "critical"
        
    - index: "security-high-%{+yyyy.MM.dd}"  
      when.equals:
        risk_level: "high"
        
    - index: "security-medium-%{+yyyy.MM.dd}"
      when.equals:
        risk_level: "medium"
        
    - index: "security-low-%{+yyyy.MM.dd}"
      when.or:
        - equals:
            risk_level: "low"
        - not:
            exists: "risk_level"

# ğŸ“§ å…³é”®å‘Šè­¦é‚®ä»¶é€šçŸ¥ (éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡å™¨)
output.email:
  host: "smtp.company.com"
  port: 587
  username: "alerts@company.com"
  password: "${SMTP_PASSWORD}"
  
  # åªå‘é€å…³é”®å‘Šè­¦
  when.equals:
    risk_level: "critical"
    
  to: ["security-team@company.com"]
  subject: "ğŸš¨ å®‰å…¨å‘Šè­¦: %{event_type} æ¥è‡ª %{source_ip}"
  body: |
    æ£€æµ‹åˆ°é«˜å±å®‰å…¨äº‹ä»¶ï¼š
    
    äº‹ä»¶ç±»å‹: %{event_type}
    æ¥æºIP: %{source_ip}
    ç”¨æˆ·å: %{username}
    æ—¶é—´: %{@timestamp}
    å¨èƒç­‰çº§: %{risk_level}
    
    è¯¦ç»†ä¿¡æ¯: %{message}
```

### 6.2 Webhookå‘Šè­¦é›†æˆ


**ğŸ”— é›†æˆç¬¬ä¸‰æ–¹å‘Šè­¦ç³»ç»Ÿ**

```yaml
# å‘é€åˆ°Slack/é’‰é’‰ç­‰å³æ—¶é€šè®¯å·¥å…·
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var riskLevel = event.Get("risk_level");
        
        // åªå¤„ç†ä¸­å±åŠä»¥ä¸Šçš„äº‹ä»¶
        if (["medium", "high", "critical"].includes(riskLevel)) {
          
          // æ„é€ å‘Šè­¦æ¶ˆæ¯
          var alertMessage = {
            "timestamp": event.Get("@timestamp"),
            "event_type": event.Get("event_type"),
            "source_ip": event.Get("source_ip"),
            "risk_level": riskLevel,
            "details": event.Get("message"),
            "recommended_action": event.Get("recommended_action")
          };
          
          // è®¾ç½®å‘Šè­¦é¢œè‰²
          var color = {
            "critical": "#FF0000",  // çº¢è‰²
            "high": "#FF8C00",      // æ©™è‰²  
            "medium": "#FFD700"     // é»„è‰²
          }[riskLevel] || "#808080";
          
          event.Put("webhook.payload", JSON.stringify({
            "attachments": [{
              "color": color,
              "title": "ğŸš¨ å®‰å…¨å‘Šè­¦",
              "fields": [
                {"title": "äº‹ä»¶ç±»å‹", "value": alertMessage.event_type, "short": true},
                {"title": "æ¥æºIP", "value": alertMessage.source_ip, "short": true},
                {"title": "é£é™©ç­‰çº§", "value": alertMessage.risk_level, "short": true},
                {"title": "å»ºè®®æªæ–½", "value": alertMessage.recommended_action, "short": true}
              ],
              "footer": "Filebeat Security Monitor",
              "ts": Math.floor(Date.now() / 1000)
            }]
          }));
        }
      }

# HTTPè¾“å‡ºåˆ°Webhook
output.http:
  hosts: ["https://hooks.slack.com/services/YOUR/WEBHOOK/URL"]
  headers:
    Content-Type: "application/json"
  
  # åªå‘é€æœ‰webhookè½½è·çš„äº‹ä»¶
  when.has_fields: ["webhook.payload"]
```

### 6.3 ä»ªè¡¨æ¿æ¨¡æ¿


**ğŸ“Š Kibanaä»ªè¡¨æ¿é…ç½®**

```yaml
# ä¸ºKibanaå‡†å¤‡çš„å­—æ®µæ˜ å°„
processors:
- add_fields:
    target: "dashboard"
    fields:
      # ğŸ“ˆ è¶‹åŠ¿åˆ†æå­—æ®µ
      hour_of_day: 
        script: "new Date(params._source['@timestamp']).getHours()"
      day_of_week:
        script: "new Date(params._source['@timestamp']).getDay()"
      
      # ğŸ—ºï¸ åœ°ç†ä½ç½®å¯è§†åŒ–
      geo_point:
        script: "params._source.geoip?.latitude + ',' + params._source.geoip?.longitude"

# ğŸ¨ ä»ªè¡¨æ¿å…³é”®æŒ‡æ ‡
- script:
    lang: javascript  
    source: >
      function process(event) {
        // è®¡ç®—ä»ªè¡¨æ¿å±•ç¤ºæŒ‡æ ‡
        var metrics = {
          // æ”»å‡»å¼ºåº¦è¯„åˆ† (1-10)
          attack_intensity: calculateAttackIntensity(event),
          
          // åœ°ç†ä½ç½®é£é™©è¯„åˆ†
          geo_risk_score: calculateGeoRisk(event),
          
          // æ—¶é—´å¼‚å¸¸è¯„åˆ†
          time_anomaly_score: calculateTimeAnomaly(event)
        };
        
        // ç»¼åˆé£é™©è¯„åˆ†
        var totalRisk = (metrics.attack_intensity + 
                        metrics.geo_risk_score + 
                        metrics.time_anomaly_score) / 3;
        
        event.Put("dashboard.risk_score", Math.round(totalRisk));
        event.Put("dashboard.metrics", metrics);
      }
      
      function calculateAttackIntensity(event) {
        var eventType = event.Get("event_type");
        var threatIntel = event.Get("threat_intel.category");
        
        var scores = {
          "brute_force": 8,
          "sql_injection": 9,
          "command_injection": 10,
          "failed_password": 3,
          "invalid_user": 2
        };
        
        var baseScore = scores[eventType] || 1;
        
        // å¨èƒæƒ…æŠ¥åŠ æƒ
        if (threatIntel) baseScore += 3;
        
        return Math.min(baseScore, 10);
      }
      
      function calculateGeoRisk(event) {
        var geoRisk = event.Get("geo_risk");
        var networkLocation = event.Get("network_location");
        
        if (networkLocation === "internal") return 1;
        if (geoRisk === "high") return 8;
        return 3;
      }
      
      function calculateTimeAnomaly(event) {
        var hour = new Date(event.Get("@timestamp")).getHours();
        
        // éå·¥ä½œæ—¶é—´ (å¤œé—´) é£é™©è¾ƒé«˜
        if (hour < 6 || hour > 22) return 6;
        return 2;
      }
```

---

## 7. ğŸ› ï¸ æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤


### 7.1 æ€§èƒ½ä¼˜åŒ–é…ç½®


**âš¡ é«˜æ€§èƒ½é‡‡é›†é…ç½®**

```yaml
# æ€§èƒ½ä¼˜åŒ–é…ç½®
filebeat.config:
  modules:
    path: ${path.config}/modules.d/*.yml
    reload.enabled: true
    reload.period: 30s

# ğŸš€ æ€§èƒ½è°ƒä¼˜å‚æ•°
queue.mem:
  events: 8192           # å†…å­˜é˜Ÿåˆ—å¤§å°
  flush.min_events: 512  # æœ€å°åˆ·æ–°äº‹ä»¶æ•°
  flush.timeout: 1s      # åˆ·æ–°è¶…æ—¶æ—¶é—´

# ğŸ“Š ç›‘æ§å’Œè°ƒè¯•
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# ğŸ” æ€§èƒ½ç›‘æ§
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["elasticsearch:9200"]
    index: "filebeat-monitoring"
```

### 7.2 å¸¸è§é—®é¢˜æ’æŸ¥


**â— æ•…éšœæ’é™¤æŒ‡å—**

```bash
# ğŸ”§ å¸¸è§é—®é¢˜æ£€æŸ¥æ¸…å•

# 1. æ£€æŸ¥FilebeatçŠ¶æ€
sudo systemctl status filebeat

# 2. æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo tail -f /var/log/filebeat/filebeat

# 3. éªŒè¯é…ç½®æ–‡ä»¶
sudo filebeat test config

# 4. æµ‹è¯•è¾“å‡ºè¿æ¥
sudo filebeat test output

# 5. æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /var/log/auth.log
# åº”è¯¥æ˜¾ç¤º: -rw-r--r-- 1 syslog adm

# 6. éªŒè¯æ—¥å¿—æ ¼å¼
sudo filebeat export template > template.json
```

**ğŸ› å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**

| é”™è¯¯ç±»å‹ | **ç—‡çŠ¶** | **è§£å†³æ–¹æ¡ˆ** |
|---------|---------|-------------|
| ğŸ”´ **æƒé™é”™è¯¯** | `permission denied` | `sudo chown root:root filebeat.yml` |
| ğŸŸ¡ **è¿æ¥å¤±è´¥** | `connection refused` | `æ£€æŸ¥ElasticsearchçŠ¶æ€` |
| ğŸ”µ **è§£æé”™è¯¯** | `grok parse failure` | `éªŒè¯æ—¥å¿—æ ¼å¼å’Œè§£æè§„åˆ™` |
| ğŸŸ¢ **æ€§èƒ½é—®é¢˜** | `events dropping` | `è°ƒæ•´é˜Ÿåˆ—å¤§å°å’Œåˆ·æ–°å‚æ•°` |

### 7.3 å®‰å…¨é…ç½®å»ºè®®


**ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ**

```yaml
# å®‰å…¨é…ç½®å»ºè®®
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true

# ğŸ›¡ï¸ ä¼ è¾“åŠ å¯†
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  protocol: "https"
  ssl.certificate_authorities: ["/etc/filebeat/ca.crt"]
  ssl.certificate: "/etc/filebeat/client.crt"
  ssl.key: "/etc/filebeat/client.key"
  ssl.verification_mode: "certificate"

# ğŸ” è®¤è¯é…ç½®  
  username: "filebeat_user"
  password: "${ELASTIC_PASSWORD}"

# ğŸ“ æ—¥å¿—è½®è½¬é…ç½®
logging.files:
  rotateeverybytes: 104857600  # 100MB
  keepfiles: 5
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```yaml
ğŸ”¸ å®‰å…¨æ—¥å¿—åˆ†æï¼šå®æ—¶ç›‘æ§ç³»ç»Ÿå®‰å…¨çŠ¶æ€ï¼Œå¿«é€Ÿå‘ç°å¨èƒ
ğŸ”¸ å¤šå±‚è¿‡æ»¤æœºåˆ¶ï¼šå…³é”®è¯è¿‡æ»¤ â†’ åœ°ç†ä½ç½®åˆ†æ â†’ å¨èƒæƒ…æŠ¥æ£€æŸ¥
ğŸ”¸ æ™ºèƒ½æ ‡ç­¾ç³»ç»Ÿï¼šè‡ªåŠ¨æ ‡è®°å¨èƒç­‰çº§å’Œæ”»å‡»ç±»å‹
ğŸ”¸ åœ°ç†ä½ç½®åˆ†æï¼šåŸºäºIPåœ°å€è¯†åˆ«å¼‚å¸¸ç™»å½•ä½ç½®
ğŸ”¸ å¨èƒæƒ…æŠ¥é›†æˆï¼šç»“åˆå¤–éƒ¨å¨èƒæƒ…æŠ¥æå‡æ£€æµ‹å‡†ç¡®æ€§
ğŸ”¸ å®æ—¶å‘Šè­¦æœºåˆ¶ï¼šå¤šæ¸ é“å‘Šè­¦ç¡®ä¿åŠæ—¶å“åº”
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®‰å…¨æ—¥å¿—æ”¶é›†ç­–ç•¥**
```
å…¨é¢æ€§ï¼šè¦†ç›–ç³»ç»Ÿã€åº”ç”¨ã€ç½‘ç»œå¤šä¸ªå±‚é¢
å®æ—¶æ€§ï¼šç§’çº§æ”¶é›†å’Œåˆ†æï¼ŒåŠæ—¶å‘ç°å¨èƒ  
å‡†ç¡®æ€§ï¼šå‡å°‘è¯¯æŠ¥ï¼Œæé«˜å‘Šè­¦è´¨é‡
å¯è¿½æº¯ï¼šå®Œæ•´è®°å½•å®‰å…¨äº‹ä»¶ï¼Œæ”¯æŒåç»­è°ƒæŸ¥
```

**ğŸ”¹ é£é™©ç­‰çº§è¯„ä¼°æ¨¡å‹**
```
Critical (ä¸¥é‡)ï¼šå·²çŸ¥æ¶æ„IPã€æˆåŠŸçš„æ”»å‡»è¡Œä¸º
High (é«˜å±)ï¼šæš´åŠ›ç ´è§£ã€ä»£ç æ³¨å…¥å°è¯•
Medium (ä¸­å±)ï¼šå¼‚å¸¸åœ°ç†ä½ç½®ã€é¢‘ç¹å¤±è´¥
Low (ä½å±)ï¼šä¸€èˆ¬æ€§é”™è¯¯ã€ä¿¡æ¯æ”¶é›†è¡Œä¸º
```

**ğŸ”¹ å“åº”å¤„ç†æµç¨‹**
```
æ£€æµ‹ â†’ åˆ†æ â†’ è¯„ä¼° â†’ å‘Šè­¦ â†’ å“åº” â†’ è·Ÿè¸ª

è‡ªåŠ¨åŒ–å¤„ç†ï¼š
- ä½é£é™©ï¼šè®°å½•å’Œç›‘æ§
- ä¸­é£é™©ï¼šå‘Šè­¦é€šçŸ¥  
- é«˜é£é™©ï¼šç«‹å³é˜»æ–­
- ä¸¥é‡ï¼šç´§æ€¥å“åº”
```

### 8.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯**
- **ä¼ä¸šç½‘ç»œå®‰å…¨**ï¼šç›‘æ§å‘˜å·¥ç™»å½•è¡Œä¸ºï¼Œé˜²èŒƒå†…éƒ¨å¨èƒ
- **Webåº”ç”¨ä¿æŠ¤**ï¼šæ£€æµ‹SQLæ³¨å…¥ã€XSSç­‰Webæ”»å‡»
- **åˆè§„å®¡è®¡**ï¼šæ»¡è¶³ç­‰ä¿ã€ISO27001ç­‰åˆè§„è¦æ±‚
- **å¨èƒç‹©çŒ**ï¼šä¸»åŠ¨æœç´¢é«˜çº§æŒç»­å¨èƒ(APT)

**ğŸ“Š å®æ–½æ•ˆæœè¯„ä¼°**
```
å®‰å…¨æŒ‡æ ‡æå‡ï¼š
â”œâ”€â”€ å¨èƒæ£€æµ‹æ—¶é—´ï¼šå°æ—¶çº§ â†’ ç§’çº§  
â”œâ”€â”€ è¯¯æŠ¥ç‡ä¸‹é™ï¼š30% â†’ 5%
â”œâ”€â”€ å“åº”é€Ÿåº¦ï¼š1å¤© â†’ 15åˆ†é’Ÿ
â””â”€â”€ åˆè§„è¦†ç›–ç‡ï¼š60% â†’ 95%
```

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š ä»æ–°æ‰‹åˆ°ä¸“å®¶**
```
ç¬¬1é˜¶æ®µ - åŸºç¡€é…ç½®ï¼š
â”œâ”€â”€ æŒæ¡åŸºæœ¬çš„æ—¥å¿—æ”¶é›†é…ç½®
â”œâ”€â”€ ç†è§£ä¸åŒæ—¥å¿—æ ¼å¼å’Œå­—æ®µ
â””â”€â”€ å­¦ä¼šç®€å•çš„è¿‡æ»¤å’Œæ ‡è®°

ç¬¬2é˜¶æ®µ - é«˜çº§åˆ†æï¼š  
â”œâ”€â”€ å­¦ä¹ grokæ¨¡å¼å’Œå­—æ®µè§£æ
â”œâ”€â”€ æŒæ¡åœ°ç†ä½ç½®å’Œå¨èƒæƒ…æŠ¥
â””â”€â”€ é…ç½®å¤æ‚çš„å¤„ç†å™¨é“¾

ç¬¬3é˜¶æ®µ - ä¼ä¸šçº§åº”ç”¨ï¼š
â”œâ”€â”€ è®¾è®¡å®Œæ•´çš„å®‰å…¨ç›‘æ§ä½“ç³»
â”œâ”€â”€ é›†æˆå¤šç§å‘Šè­¦å’Œé€šçŸ¥æ¸ é“  
â””â”€â”€ ä¼˜åŒ–æ€§èƒ½å’Œæ•…éšœæ’é™¤
```

**ğŸ“ å®è·µå»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆé…ç½®SSHç™»å½•ç›‘æ§ï¼Œé€æ­¥æ‰©å±•
- **é‡è§†æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ‰€æœ‰é…ç½®
- **ç›‘æ§æ€§èƒ½**ï¼šå…³æ³¨ç³»ç»Ÿèµ„æºæ¶ˆè€—å’Œå¤„ç†å»¶è¿Ÿ
- **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…å¨èƒè°ƒæ•´æ£€æµ‹è§„åˆ™

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨æ—¥å¿—åˆ†ææ˜¯ç°ä»£ç½‘ç»œå®‰å…¨çš„åŸºç¡€è®¾æ–½
- å¤šå±‚æ£€æµ‹æœºåˆ¶ç¡®ä¿å¨èƒä¸ä¼šé—æ¼
- è‡ªåŠ¨åŒ–å’Œæ™ºèƒ½åŒ–æ˜¯æå‡æ•ˆç‡çš„å…³é”®
- å®æ—¶å“åº”èƒ½åŠ›å†³å®šå®‰å…¨äº‹ä»¶çš„å½±å“èŒƒå›´