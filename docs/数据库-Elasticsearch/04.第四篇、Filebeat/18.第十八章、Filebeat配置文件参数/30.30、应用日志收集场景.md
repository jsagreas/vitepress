---
title: 30ã€åº”ç”¨æ—¥å¿—æ”¶é›†åœºæ™¯
---
## ğŸ“š ç›®å½•

1. [åº”ç”¨æ—¥å¿—æ”¶é›†åŸºæœ¬æ¦‚å¿µ](#1-åº”ç”¨æ—¥å¿—æ”¶é›†åŸºæœ¬æ¦‚å¿µ)
2. [Javaåº”ç”¨æ—¥å¿—é…ç½®å®æˆ˜](#2-Javaåº”ç”¨æ—¥å¿—é…ç½®å®æˆ˜)
3. [å¤šè¡Œæ—¥å¿—å¤„ç†æŠ€å·§](#3-å¤šè¡Œæ—¥å¿—å¤„ç†æŠ€å·§)
4. [åº”ç”¨æ ‡è¯†ä¸ä¸»æœºä¿¡æ¯](#4-åº”ç”¨æ ‡è¯†ä¸ä¸»æœºä¿¡æ¯)
5. [æ–‡ä»¶è¿‡æ»¤ä¸JSONå¤„ç†](#5-æ–‡ä»¶è¿‡æ»¤ä¸JSONå¤„ç†)
6. [ç®¡é“æ¨¡æ¿é…ç½®](#6-ç®¡é“æ¨¡æ¿é…ç½®)
7. [å®Œæ•´é…ç½®ç¤ºä¾‹](#7-å®Œæ•´é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“± åº”ç”¨æ—¥å¿—æ”¶é›†åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åº”ç”¨æ—¥å¿—æ”¶é›†


**ğŸ”¸ é€šä¿—ç†è§£**
åº”ç”¨æ—¥å¿—æ”¶é›†å°±åƒæ˜¯ç»™ä½ çš„ç¨‹åºå®‰è£…ä¸€ä¸ª"è®°å½•å‘˜"ï¼Œä¸“é—¨è´Ÿè´£æŠŠç¨‹åºè¿è¡Œæ—¶äº§ç”Ÿçš„å„ç§ä¿¡æ¯æ”¶é›†èµ·æ¥ï¼Œç„¶åç»Ÿä¸€é€åˆ°æŒ‡å®šåœ°æ–¹è¿›è¡Œåˆ†æã€‚

```
æ—¥å¸¸ç”Ÿæ´»ç±»æ¯”ï¼š
å¿«é€’å‘˜æ”¶é›†åŒ…è£¹ â†’ Filebeatæ”¶é›†æ—¥å¿—
åˆ†æ‹£ä¸­å¿ƒå¤„ç†   â†’ Elasticsearchå¤„ç†
é…é€åˆ°ç”¨æˆ·     â†’ Kibanaå±•ç¤ºç»™ä½ 

ç¨‹åºè¿è¡Œäº§ç”Ÿæ—¥å¿— â†’ Filebeatå®æ—¶æ”¶é›† â†’ å‘é€åˆ°ELK â†’ å¯è§†åŒ–åˆ†æ
```

**ğŸ¯ åº”ç”¨æ—¥å¿—çš„ç‰¹ç‚¹**
- **å®æ—¶äº§ç”Ÿ**ï¼šç¨‹åºè¿è¡Œæ—¶æŒç»­ç”Ÿæˆ
- **æ ¼å¼å¤šæ ·**ï¼šçº¯æ–‡æœ¬ã€JSONã€XMLç­‰å¤šç§æ ¼å¼
- **ä¿¡æ¯ä¸°å¯Œ**ï¼šåŒ…å«é”™è¯¯ã€è­¦å‘Šã€è°ƒè¯•ç­‰å¤šç§çº§åˆ«
- **æ•°é‡åºå¤§**ï¼šå¤§å‹åº”ç”¨æ¯å¤©å¯èƒ½äº§ç”ŸGBçº§åˆ«çš„æ—¥å¿—

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ”¶é›†


**âŒ ä¼ ç»Ÿé—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
- æœåŠ¡å™¨Aï¼šåº”ç”¨æ—¥å¿—æ•£è½åœ¨/var/log/app1/
- æœåŠ¡å™¨Bï¼šåº”ç”¨æ—¥å¿—åœ¨/opt/tomcat/logs/
- æœåŠ¡å™¨Cï¼šæ—¥å¿—åˆåœ¨å¦ä¸€ä¸ªä½ç½®
- å‡ºé—®é¢˜æ—¶éœ€è¦é€å°ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—
```

**âœ… ç»Ÿä¸€æ”¶é›†çš„å¥½å¤„**
- **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰æ—¥å¿—éƒ½æ±‡èšåˆ°ä¸€ä¸ªåœ°æ–¹
- **å®æ—¶ç›‘æ§**ï¼šå¯ä»¥å®æ—¶å‘ç°é—®é¢˜
- **å¿«é€Ÿå®šä½**ï¼šé€šè¿‡æœç´¢å¿«é€Ÿæ‰¾åˆ°ç›¸å…³æ—¥å¿—
- **è¶‹åŠ¿åˆ†æ**ï¼šåˆ†æåº”ç”¨è¿è¡Œè¶‹åŠ¿å’Œæ€§èƒ½

---

## 2. â˜• Javaåº”ç”¨æ—¥å¿—é…ç½®å®æˆ˜


### 2.1 Javaåº”ç”¨æ—¥å¿—çš„ç‰¹ç‚¹


**ğŸ”¸ Javaæ—¥å¿—ç‰¹å¾åˆ†æ**
```
å…¸å‹Javaåº”ç”¨æ—¥å¿—ç¤ºä¾‹ï¼š
2024-09-21 10:30:15.123 INFO  [main] com.example.UserService - ç”¨æˆ·ç™»å½•æˆåŠŸ: user123
2024-09-21 10:30:16.456 ERROR [http-pool-1] com.example.OrderService - è®¢å•å¤„ç†å¤±è´¥
java.lang.NullPointerException: è®¢å•ä¿¡æ¯ä¸ºç©º
    at com.example.OrderService.processOrder(OrderService.java:45)
    at com.example.OrderController.createOrder(OrderController.java:23)
    ...å †æ ˆä¿¡æ¯ç»§ç»­å¤šè¡Œ...

ç‰¹ç‚¹ï¼š
âœ“ æœ‰æ—¶é—´æˆ³
âœ“ æœ‰æ—¥å¿—çº§åˆ«(INFOã€ERRORã€DEBUGç­‰)
âœ“ æœ‰çº¿ç¨‹ä¿¡æ¯
âœ“ æœ‰ç±»åå’Œæ–¹æ³•å
âœ“ å¼‚å¸¸ä¼šæœ‰å¤šè¡Œå †æ ˆä¿¡æ¯
```

### 2.2 åŸºç¡€Javaåº”ç”¨é…ç½®


```yaml
# filebeat.yml - Javaåº”ç”¨æ—¥å¿—æ”¶é›†é…ç½®
filebeat.inputs:
- type: log
  enabled: true
  
  # æŒ‡å®šJavaåº”ç”¨æ—¥å¿—æ–‡ä»¶è·¯å¾„
  paths:
    - /var/log/myapp/*.log
    - /opt/tomcat/logs/catalina.out
  
  # ç»™è¿™ä¸ªè¾“å…¥æºæ‰“æ ‡ç­¾ï¼Œæ–¹ä¾¿åŒºåˆ†
  fields:
    app: "my-java-app"        # åº”ç”¨åç§°æ ‡è¯†
    env: "production"         # ç¯å¢ƒæ ‡è¯†
    log_type: "application"   # æ—¥å¿—ç±»å‹
  fields_under_root: true     # å­—æ®µæ”¾åœ¨æ ¹çº§åˆ«ï¼Œä¸åµŒå¥—
  
  # æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
  exclude_files: ['\.gz$', '\.zip$', '\.bak$']
```

**ğŸ” é…ç½®è§£è¯»**
- **`paths`**ï¼šå‘Šè¯‰Filebeatå»å“ªé‡Œæ‰¾æ—¥å¿—æ–‡ä»¶ï¼Œæ”¯æŒé€šé…ç¬¦
- **`fields`**ï¼šç»™æ—¥å¿—æ·»åŠ é¢å¤–æ ‡è¯†ä¿¡æ¯ï¼Œå°±åƒç»™åŒ…è£¹è´´æ ‡ç­¾
- **`exclude_files`**ï¼šæ’é™¤å‹ç¼©æ–‡ä»¶å’Œå¤‡ä»½æ–‡ä»¶ï¼Œé¿å…é‡å¤æ”¶é›†

### 2.3 æ—¥å¿—çº§åˆ«è¿‡æ»¤é…ç½®


```yaml
# é«˜çº§è¿‡æ»¤ï¼šåªæ”¶é›†ERRORå’ŒWARNçº§åˆ«çš„æ—¥å¿—
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/application.log
  
  # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
  include_lines: ['^.*\s(ERROR|WARN)\s.*$']
  
  fields:
    app: "critical-monitor"
    severity: "high"
  fields_under_root: true
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šåªå…³æ³¨ERRORå’ŒWARNï¼Œå‡å°‘æ•°æ®é‡
- **å¼€å‘ç¯å¢ƒ**ï¼šæ”¶é›†æ‰€æœ‰çº§åˆ«ï¼Œæ–¹ä¾¿è°ƒè¯•
- **ç›‘æ§å‘Šè­¦**ï¼šåŸºäºERRORæ—¥å¿—è§¦å‘å‘Šè­¦

---

## 3. ğŸ“„ å¤šè¡Œæ—¥å¿—å¤„ç†æŠ€å·§


### 3.1 ä»€ä¹ˆæ˜¯å¤šè¡Œæ—¥å¿—é—®é¢˜


**ğŸ¤” é—®é¢˜æè¿°**
Javaå¼‚å¸¸å †æ ˆä¿¡æ¯ä¼šè·¨è¶Šå¤šè¡Œï¼Œå¦‚æœä¸æ­£ç¡®å¤„ç†ï¼ŒFilebeatä¼šæŠŠæ¯ä¸€è¡Œå½“ä½œç‹¬ç«‹çš„æ—¥å¿—äº‹ä»¶ã€‚

```
é”™è¯¯çš„å¤„ç†æ–¹å¼ï¼š
äº‹ä»¶1: 2024-09-21 10:30:16.456 ERROR [http-pool-1] com.example.OrderService - è®¢å•å¤„ç†å¤±è´¥
äº‹ä»¶2: java.lang.NullPointerException: è®¢å•ä¿¡æ¯ä¸ºç©º
äº‹ä»¶3:     at com.example.OrderService.processOrder(OrderService.java:45)
äº‹ä»¶4:     at com.example.OrderController.createOrder(OrderController.java:23)

æ­£ç¡®çš„å¤„ç†æ–¹å¼ï¼š
äº‹ä»¶1: [å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯ä½œä¸ºä¸€ä¸ªäº‹ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å †æ ˆè¡Œ]
```

### 3.2 multiline.patterné…ç½®è¯¦è§£


```yaml
# å¤šè¡Œæ—¥å¿—åˆå¹¶é…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
  
  # å¤šè¡Œå¤„ç†é…ç½®
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-9]{2}:[0-9]{2}:[0-9]{2}'
  multiline.negate: true      # å–åæ¨¡å¼
  multiline.match: after      # åŒ¹é…çš„è¡Œä¹‹åçš„å†…å®¹åˆå¹¶
  multiline.max_lines: 500    # æœ€å¤§åˆå¹¶è¡Œæ•°
  multiline.timeout: 5s       # è¶…æ—¶æ—¶é—´
  
  fields:
    app: "java-multiline-app"
  fields_under_root: true
```

**ğŸ”§ å‚æ•°è¯¦ç»†è¯´æ˜**

| å‚æ•° | ä½œç”¨ | é€šä¿—è§£é‡Š |
|------|------|----------|
| `multiline.pattern` | å®šä¹‰ä»€ä¹ˆæ ·çš„è¡Œç®—æ˜¯"æ–°æ—¥å¿—çš„å¼€å§‹" | å°±åƒæ®µè½çš„å¼€å¤´ï¼Œè¯†åˆ«æ ‡å¿— |
| `multiline.negate: true` | ä¸åŒ¹é…patternçš„è¡Œè¦åˆå¹¶åˆ°å‰é¢ | æ²¡æœ‰æ—¶é—´æˆ³çš„è¡Œéƒ½æ˜¯ä¸Šä¸€æ¡æ—¥å¿—çš„å»¶ç»­ |
| `multiline.match: after` | åˆå¹¶æ–¹å‘ | æŠŠåé¢çš„è¡Œåˆå¹¶åˆ°å‰é¢çš„æ—¥å¿—é‡Œ |
| `multiline.max_lines` | æœ€å¤šåˆå¹¶å¤šå°‘è¡Œ | é˜²æ­¢å¼‚å¸¸è¿‡é•¿å ç”¨å¤ªå¤šèµ„æº |
| `multiline.timeout` | å¤šé•¿æ—¶é—´æ²¡æ–°è¡Œå°±ç»“æŸåˆå¹¶ | é¿å…ä¸€ç›´ç­‰å¾…ï¼Œå½±å“å®æ—¶æ€§ |

### 3.3 å¸¸è§å¤šè¡Œæ¨¡å¼é…ç½®


```yaml
# åœºæ™¯1ï¼šJavaæ ‡å‡†æ—¥å¿—æ ¼å¼
multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
multiline.negate: true
multiline.match: after

# åœºæ™¯2ï¼šä»¥ç©ºæ ¼æˆ–åˆ¶è¡¨ç¬¦å¼€å¤´çš„è¡Œåˆå¹¶ï¼ˆå…¸å‹çš„å †æ ˆä¿¡æ¯ï¼‰
multiline.pattern: '^[\s]+'
multiline.negate: false
multiline.match: after

# åœºæ™¯3ï¼šTomcat catalina.out æ ¼å¼
multiline.pattern: '^[A-Za-z]+ [0-9]{1,2}, [0-9]{4}'
multiline.negate: true
multiline.match: after
```

**ğŸ“Š å¤šè¡Œå¤„ç†æµç¨‹å›¾**
```
åŸå§‹æ—¥å¿—æµï¼š
2024-09-21 10:30:16 ERROR OrderService - å¤„ç†å¤±è´¥    â† å¼€å§‹è¡Œ(åŒ¹é…pattern)
java.lang.NullPointerException: null               â† åˆå¹¶è¡Œ
    at OrderService.process(OrderService.java:45)   â† åˆå¹¶è¡Œ
    at OrderController.create(OrderController.java) â† åˆå¹¶è¡Œ
2024-09-21 10:30:17 INFO  UserService - ç”¨æˆ·ç™»å½•     â† æ–°å¼€å§‹è¡Œ

å¤„ç†åç»“æœï¼š
äº‹ä»¶1: [åŒ…å«å®Œæ•´å¼‚å¸¸ä¿¡æ¯çš„å•ä¸ªäº‹ä»¶]
äº‹ä»¶2: [ç”¨æˆ·ç™»å½•ä¿¡æ¯]
```

---

## 4. ğŸ·ï¸ åº”ç”¨æ ‡è¯†ä¸ä¸»æœºä¿¡æ¯


### 4.1 fieldså­—æ®µåº”ç”¨æ ‡è¯†


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦åº”ç”¨æ ‡è¯†**
åœ¨ä¼ä¸šç¯å¢ƒä¸­ï¼Œå¯èƒ½æœ‰å‡ åä¸ªä¸åŒçš„åº”ç”¨äº§ç”Ÿæ—¥å¿—ï¼Œéœ€è¦é€šè¿‡æ ‡è¯†å­—æ®µæ¥åŒºåˆ†ï¼š

```
åœºæ™¯ä¸¾ä¾‹ï¼š
- ç”¨æˆ·æœåŠ¡(user-service)
- è®¢å•æœåŠ¡(order-service)  
- æ”¯ä»˜æœåŠ¡(payment-service)
- åº“å­˜æœåŠ¡(inventory-service)

å¦‚æœä¸åŠ æ ‡è¯†ï¼Œæ‰€æœ‰æ—¥å¿—æ··åœ¨ä¸€èµ·ï¼Œå¾ˆéš¾åˆ†æå…·ä½“æŸä¸ªæœåŠ¡çš„é—®é¢˜
```

### 4.2 fieldsé…ç½®è¯¦è§£


```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/user-service/*.log
  
  # åº”ç”¨æ ‡è¯†å­—æ®µé…ç½®
  fields:
    app: "user-service"           # åº”ç”¨åç§°
    component: "authentication"   # åº”ç”¨ç»„ä»¶
    team: "backend-team"         # è´Ÿè´£å›¢é˜Ÿ
    version: "v2.1.0"            # åº”ç”¨ç‰ˆæœ¬
    datacenter: "dc-beijing"     # æ•°æ®ä¸­å¿ƒ
    env: "production"            # ç¯å¢ƒæ ‡è¯†
  
  # é‡è¦ï¼šå­—æ®µæ”¾åœ¨æ ¹çº§åˆ«ï¼Œä¾¿äºæŸ¥è¯¢
  fields_under_root: true
```

**ğŸ” å­—æ®µè®¾è®¡æœ€ä½³å®è·µ**

| å­—æ®µå | ä½œç”¨ | ç¤ºä¾‹å€¼ | æŸ¥è¯¢ç”¨é€” |
|--------|------|--------|----------|
| `app` | åº”ç”¨åç§°æ ‡è¯† | "user-service" | æŒ‰åº”ç”¨è¿‡æ»¤æ—¥å¿— |
| `env` | ç¯å¢ƒæ ‡è¯† | "prod/test/dev" | åŒºåˆ†ä¸åŒç¯å¢ƒ |
| `version` | åº”ç”¨ç‰ˆæœ¬ | "v2.1.0" | ç‰ˆæœ¬é—®é¢˜æ’æŸ¥ |
| `team` | è´Ÿè´£å›¢é˜Ÿ | "backend-team" | é—®é¢˜åˆ†é…è´£ä»» |
| `component` | åŠŸèƒ½æ¨¡å— | "login/payment" | ç»†ç²’åº¦å®šä½ |

### 4.3 processors.add_host_metadataä¸»æœºä¿¡æ¯


**ğŸ–¥ï¸ ä¸»æœºä¿¡æ¯çš„é‡è¦æ€§**
å½“åº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šæ—¶ï¼Œéœ€è¦çŸ¥é“æ—¥å¿—æ¥è‡ªå“ªå°æœºå™¨ï¼Œè¿™å¯¹é—®é¢˜å®šä½éå¸¸é‡è¦ã€‚

```yaml
# ä¸»æœºä¿¡æ¯å¢å¼ºé…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
  
  fields:
    app: "my-distributed-app"
  fields_under_root: true

# å…¨å±€å¤„ç†å™¨ï¼šæ·»åŠ ä¸»æœºå…ƒæ•°æ®
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
      # åŒ…å«çš„ä¸»æœºä¿¡æ¯å­—æ®µ
      include_fields: 
        - "host.name"           # ä¸»æœºå
        - "host.ip"             # IPåœ°å€  
        - "host.os.platform"    # æ“ä½œç³»ç»Ÿ
        - "host.architecture"   # æ¶æ„ä¿¡æ¯
```

**ğŸ“‹ ä¸»æœºä¿¡æ¯å­—æ®µè¯´æ˜**

```
æ·»åŠ åçš„æ—¥å¿—äº‹ä»¶ä¼šåŒ…å«ï¼š
{
  "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
  "app": "my-distributed-app",
  "host": {
    "name": "web-server-01",
    "ip": ["192.168.1.100", "10.0.0.1"],
    "os": {
      "platform": "linux"
    },
    "architecture": "x86_64"
  }
}
```

**ğŸ’¡ å®é™…åº”ç”¨ä»·å€¼**
- **é—®é¢˜å®šä½**ï¼šå¿«é€Ÿæ‰¾åˆ°å‡ºé—®é¢˜çš„æœåŠ¡å™¨
- **è´Ÿè½½åˆ†æ**ï¼šäº†è§£ä¸åŒæœåŠ¡å™¨çš„æ—¥å¿—äº§ç”Ÿé‡
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºæœåŠ¡å™¨ç»´åº¦åˆ†æèµ„æºä½¿ç”¨

---

## 5. ğŸ” æ–‡ä»¶è¿‡æ»¤ä¸JSONå¤„ç†


### 5.1 exclude_filesæ’é™¤æ–‡ä»¶é…ç½®


**ğŸ—‚ï¸ ä¸ºä»€ä¹ˆéœ€è¦æ’é™¤æ–‡ä»¶**
æ—¥å¿—ç›®å½•ä¸­ç»å¸¸æœ‰å„ç§æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰éƒ½éœ€è¦æ”¶é›†ï¼š

```
å…¸å‹æ—¥å¿—ç›®å½•ç»“æ„ï¼š
/var/log/myapp/
â”œâ”€â”€ application.log          â† éœ€è¦æ”¶é›†
â”œâ”€â”€ application.log.1        â† éœ€è¦æ”¶é›†  
â”œâ”€â”€ application.log.2.gz     â† ä¸éœ€è¦(å‹ç¼©æ–‡ä»¶)
â”œâ”€â”€ application.log.bak      â† ä¸éœ€è¦(å¤‡ä»½æ–‡ä»¶)
â”œâ”€â”€ debug.log               â† å¯èƒ½éœ€è¦
â”œâ”€â”€ access.log              â† éœ€è¦æ”¶é›†
â”œâ”€â”€ error.log               â† éœ€è¦æ”¶é›†
â””â”€â”€ temp.tmp                â† ä¸éœ€è¦(ä¸´æ—¶æ–‡ä»¶)
```

### 5.2 æ–‡ä»¶è¿‡æ»¤é…ç½®å®ä¾‹


```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
    - /var/log/myapp/*.log.[0-9]    # åŒ…å«è½®è½¬çš„æ—¥å¿—æ–‡ä»¶
  
  # æ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ç±»å‹
  exclude_files: 
    - '\.gz$'          # æ’é™¤gzipå‹ç¼©æ–‡ä»¶
    - '\.zip$'         # æ’é™¤zipå‹ç¼©æ–‡ä»¶  
    - '\.bak$'         # æ’é™¤å¤‡ä»½æ–‡ä»¶
    - '\.tmp$'         # æ’é™¤ä¸´æ—¶æ–‡ä»¶
    - '\.swp$'         # æ’é™¤vimäº¤æ¢æ–‡ä»¶
    - 'debug\.log$'    # æ’é™¤debugæ—¥å¿—(å¦‚æœä¸éœ€è¦)
  
  # åªåŒ…å«ç‰¹å®šæ–‡ä»¶(å¯é€‰)
  include_lines: ['INFO', 'WARN', 'ERROR']  # åªåŒ…å«ç‰¹å®šçº§åˆ«
  
  fields:
    app: "filtered-app"
  fields_under_root: true
```

**âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
- **å‡å°‘æ–‡ä»¶æ‰«æ**ï¼šç²¾ç¡®çš„è·¯å¾„é…ç½®å‡å°‘ä¸å¿…è¦çš„æ–‡ä»¶æ‰«æ
- **åˆç†æ’é™¤**ï¼šæ’é™¤å¤§æ–‡ä»¶å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½
- **æ­£åˆ™ä¼˜åŒ–**ï¼šç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼æ€§èƒ½æ›´å¥½

### 5.3 JSONæ—¥å¿—å¤„ç†è¯¦è§£


**ğŸ“ ä»€ä¹ˆæ˜¯JSONæ ¼å¼æ—¥å¿—**
ç°ä»£åº”ç”¨è¶Šæ¥è¶Šå¤šä½¿ç”¨JSONæ ¼å¼è®°å½•æ—¥å¿—ï¼Œå› ä¸ºç»“æ„åŒ–æ•°æ®æ›´ä¾¿äºåˆ†æï¼š

```json
// ä¼ ç»Ÿæ–‡æœ¬æ—¥å¿—
2024-09-21 10:30:15 INFO UserService - ç”¨æˆ·user123ç™»å½•æˆåŠŸï¼Œæ¥æºIPï¼š192.168.1.100

// JSONæ ¼å¼æ—¥å¿—  
{
  "timestamp": "2024-09-21T10:30:15.123Z",
  "level": "INFO", 
  "logger": "UserService",
  "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
  "user_id": "user123",
  "source_ip": "192.168.1.100",
  "response_time": 45
}
```

### 5.4 json.keys_under_rooté…ç½®


```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/app.json.log
  
  # JSONè§£æé…ç½®
  json.keys_under_root: true        # JSONå­—æ®µæ”¾åœ¨æ ¹çº§åˆ«
  json.add_error_key: true          # è§£æé”™è¯¯æ—¶æ·»åŠ errorå­—æ®µ
  json.message_key: "message"       # æŒ‡å®šæ¶ˆæ¯å­—æ®µå
  json.ignore_decoding_error: false # è§£æå¤±è´¥æ—¶ä¸å¿½ç•¥
  
  fields:
    app: "json-app"
    log_format: "json"
  fields_under_root: true
```

**ğŸ”§ JSONé…ç½®å‚æ•°è¯¦è§£**

| å‚æ•° | ä½œç”¨ | é€šä¿—è¯´æ˜ |
|------|------|----------|
| `keys_under_root: true` | JSONå­—æ®µç›´æ¥æ”¾åœ¨äº‹ä»¶æ ¹éƒ¨ | ä¸åµŒå¥—ï¼Œä¾¿äºæŸ¥è¯¢ |
| `add_error_key: true` | è§£æå¤±è´¥æ—¶æ·»åŠ é”™è¯¯ä¿¡æ¯ | å¸®åŠ©è°ƒè¯•è§£æé—®é¢˜ |
| `message_key` | æŒ‡å®šå“ªä¸ªå­—æ®µä½œä¸ºä¸»æ¶ˆæ¯ | å‘Šè¯‰Filebeaté‡ç‚¹å…³æ³¨å“ªä¸ªå­—æ®µ |
| `ignore_decoding_error` | æ˜¯å¦å¿½ç•¥è§£æé”™è¯¯ | false=ä¸¥æ ¼æ¨¡å¼ï¼Œæœ‰é”™å°±æŠ¥å‘Š |

**ğŸ“Š JSONå¤„ç†å‰åå¯¹æ¯”**
```
å¤„ç†å‰ï¼ˆåŸå§‹JSONå­—ç¬¦ä¸²ï¼‰ï¼š
{
  "message": "{\"level\":\"INFO\",\"user\":\"john\",\"action\":\"login\"}"
}

å¤„ç†åï¼ˆkeys_under_root: trueï¼‰ï¼š
{
  "level": "INFO",
  "user": "john", 
  "action": "login",
  "app": "json-app"
}
```

---

## 6. ğŸ”§ ç®¡é“æ¨¡æ¿é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯Pipelineç®¡é“


**ğŸ”„ Pipelineçš„ä½œç”¨**
Pipelineå°±åƒæ˜¯æµæ°´çº¿ï¼Œå¯¹æ”¶é›†åˆ°çš„æ—¥å¿—è¿›è¡Œè¿›ä¸€æ­¥çš„åŠ å·¥å¤„ç†ï¼Œæ¯”å¦‚è§£æã€è½¬æ¢ã€ä¸°å¯Œæ•°æ®ç­‰ã€‚

```
æ•°æ®æµå‘å›¾ï¼š
åº”ç”¨äº§ç”Ÿæ—¥å¿— â†’ Filebeatæ”¶é›† â†’ Pipelineå¤„ç† â†’ Elasticsearchå­˜å‚¨ â†’ Kibanaå±•ç¤º

Pipelineå¤„ç†ç¤ºä¾‹ï¼š
åŸå§‹æ—¥å¿—: "ç”¨æˆ·user123åœ¨2024-09-21ç™»å½•"
â†“ è§£æå¤„ç†
ç»“æ„åŒ–æ•°æ®: {user: "user123", action: "login", date: "2024-09-21"}
```

### 6.2 åº”ç”¨æ—¥å¿—ç®¡é“é…ç½®


```yaml
# Filebeatä¸­æŒ‡å®špipeline
output.elasticsearch:
  hosts: ["localhost:9200"]
  # æŒ‡å®šä½¿ç”¨çš„pipelineåç§°
  pipeline: "application-log-pipeline"
  
# æˆ–è€…åœ¨inputçº§åˆ«æŒ‡å®šä¸åŒçš„pipeline
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/user-service/*.log
  fields:
    app: "user-service"
    pipeline: "user-service-pipeline"  # ä¸ºç‰¹å®šåº”ç”¨æŒ‡å®šä¸“ç”¨pipeline
  fields_under_root: true
```

### 6.3 Pipelineå®šä¹‰ç¤ºä¾‹


```json
# åœ¨Elasticsearchä¸­å®šä¹‰pipeline
PUT _ingest/pipeline/application-log-pipeline
{
  "description": "å¤„ç†åº”ç”¨æ—¥å¿—çš„pipeline",
  "processors": [
    {
      "grok": {
        "field": "message",
        "patterns": [
          "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} \\[%{DATA:thread}\\] %{DATA:logger} - %{GREEDYDATA:log_message}"
        ]
      }
    },
    {
      "date": {
        "field": "timestamp",
        "formats": ["yyyy-MM-dd HH:mm:ss.SSS"]
      }
    },
    {
      "remove": {
        "field": "timestamp"
      }
    }
  ]
}
```

**ğŸ” Pipelineå¤„ç†æ­¥éª¤è§£æ**
1. **Grokè§£æ**ï¼šä»åŸå§‹æ¶ˆæ¯ä¸­æå–ç»“æ„åŒ–å­—æ®µ
2. **æ—¥æœŸå¤„ç†**ï¼šå°†å­—ç¬¦ä¸²æ—¶é—´è½¬æ¢ä¸ºæ ‡å‡†æ—¶é—´æ ¼å¼
3. **å­—æ®µæ¸…ç†**ï¼šåˆ é™¤ä¸éœ€è¦çš„ä¸´æ—¶å­—æ®µ

### 6.4 Templateæ¨¡æ¿é…ç½®


**ğŸ“‹ ä»€ä¹ˆæ˜¯ç´¢å¼•æ¨¡æ¿**
ç´¢å¼•æ¨¡æ¿å®šä¹‰äº†æ•°æ®åœ¨Elasticsearchä¸­çš„å­˜å‚¨ç»“æ„ï¼Œå°±åƒæ•°æ®åº“çš„è¡¨ç»“æ„å®šä¹‰ã€‚

```yaml
# Filebeatæ¨¡æ¿é…ç½®
setup.template.settings:
  index.number_of_shards: 3
  index.number_of_replicas: 1
  index.codec: best_compression
  
setup.template.mappings:
  properties:
    app:
      type: keyword    # åº”ç”¨åç§°ï¼Œç”¨äºç²¾ç¡®åŒ¹é…
    level:
      type: keyword    # æ—¥å¿—çº§åˆ«
    message:
      type: text       # æ—¥å¿—æ¶ˆæ¯ï¼Œç”¨äºå…¨æ–‡æœç´¢
      analyzer: standard
    "@timestamp":
      type: date       # æ—¶é—´æˆ³
    host.name:
      type: keyword    # ä¸»æœºå
```

**ğŸ¯ æ¨¡æ¿é…ç½®çš„ä½œç”¨**
- **å­—æ®µç±»å‹**ï¼šå®šä¹‰æ¯ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹
- **åˆ†æå™¨**ï¼šå®šä¹‰æ–‡æœ¬å¦‚ä½•è¢«åˆ†è¯å’Œæœç´¢
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè®¾ç½®åˆ†ç‰‡æ•°é‡å’Œå‹ç¼©æ–¹å¼
- **å­˜å‚¨ç­–ç•¥**ï¼šå®šä¹‰æ•°æ®ä¿ç•™å’Œå½’æ¡£è§„åˆ™

---

## 7. ğŸ“‹ å®Œæ•´é…ç½®ç¤ºä¾‹


### 7.1 ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®


```yaml
# filebeat.yml - ç”Ÿäº§ç¯å¢ƒåº”ç”¨æ—¥å¿—æ”¶é›†é…ç½®
# ==================== Filebeaté…ç½® ====================

# æ—¥å¿—æ”¶é›†è¾“å…¥é…ç½®
filebeat.inputs:

# ç”¨æˆ·æœåŠ¡æ—¥å¿—æ”¶é›†
- type: log
  enabled: true
  paths:
    - /var/log/user-service/*.log
    - /var/log/user-service/*.log.[0-9]*
  
  # å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆJavaå¼‚å¸¸å †æ ˆï¼‰
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}\s[0-9]{2}:[0-9]{2}:[0-9]{2}'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500
  multiline.timeout: 5s
  
  # æ–‡ä»¶è¿‡æ»¤
  exclude_files: ['\.gz$', '\.zip$', '\.bak$', '\.tmp$']
  
  # åº”ç”¨æ ‡è¯†å­—æ®µ
  fields:
    app: "user-service"
    component: "authentication"
    env: "production"
    team: "backend"
  fields_under_root: true
  
  # åªæ”¶é›†é‡è¦çº§åˆ«æ—¥å¿—
  include_lines: ['^.*\s(INFO|WARN|ERROR)\s.*$']

# è®¢å•æœåŠ¡JSONæ—¥å¿—æ”¶é›†  
- type: log
  enabled: true
  paths:
    - /var/log/order-service/app.json.log
  
  # JSONè§£æé…ç½®
  json.keys_under_root: true
  json.add_error_key: true
  json.message_key: "message"
  
  fields:
    app: "order-service"
    component: "order-processing"
    env: "production"
    team: "business"
    log_format: "json"
  fields_under_root: true

# ==================== å¤„ç†å™¨é…ç½® ====================
processors:
  # æ·»åŠ ä¸»æœºä¿¡æ¯
  - add_host_metadata:
      when.not.contains.tags: forwarded
      include_fields:
        - "host.name"
        - "host.ip"
        - "host.os.platform"
  
  # æ·»åŠ Dockerå®¹å™¨ä¿¡æ¯ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"

# ==================== è¾“å‡ºé…ç½® ====================
output.elasticsearch:
  hosts: ["elasticsearch-01:9200", "elasticsearch-02:9200"]
  
  # ç´¢å¼•å‘½åè§„åˆ™  
  index: "application-logs-%{[app]}-%{+yyyy.MM.dd}"
  
  # ä½¿ç”¨pipelineå¤„ç†
  pipeline: "application-log-pipeline"
  
  # è®¤è¯é…ç½®
  username: "filebeat_user"
  password: "your_password"
  
  # æ‰¹é‡å‘é€ä¼˜åŒ–
  bulk_max_size: 3200
  flush_interval: 5s
  
# ==================== æ¨¡æ¿é…ç½® ====================
setup.template.name: "application-logs"
setup.template.pattern: "application-logs-*"
setup.template.settings:
  index.number_of_shards: 3
  index.number_of_replicas: 1
  index.codec: best_compression
  
# ==================== æ—¥å¿—é…ç½® ====================
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# ==================== ç›‘æ§é…ç½® ====================
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["elasticsearch-01:9200"]
```

### 7.2 å¼€å‘ç¯å¢ƒç®€åŒ–é…ç½®


```yaml
# filebeat-dev.yml - å¼€å‘ç¯å¢ƒé…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/myapp/*.log
  
  # å¼€å‘ç¯å¢ƒæ”¶é›†æ‰€æœ‰çº§åˆ«æ—¥å¿—
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
  multiline.negate: true
  multiline.match: after
  
  fields:
    app: "my-dev-app"
    env: "development"
  fields_under_root: true

# ç®€åŒ–è¾“å‡ºï¼Œç›´æ¥åˆ°æœ¬åœ°ES
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "dev-logs-%{+yyyy.MM.dd}"

# å¯ç”¨è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•
logging.level: debug
```

### 7.3 é…ç½®æ–‡ä»¶ç»„ç»‡ç»“æ„


```
é…ç½®æ–‡ä»¶ç›®å½•ç»“æ„ï¼š
/etc/filebeat/
â”œâ”€â”€ filebeat.yml              # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ conf.d/                   # é…ç½®ç‰‡æ®µç›®å½•
â”‚   â”œâ”€â”€ inputs-apps.yml       # åº”ç”¨æ—¥å¿—è¾“å…¥é…ç½®
â”‚   â”œâ”€â”€ inputs-system.yml     # ç³»ç»Ÿæ—¥å¿—è¾“å…¥é…ç½®
â”‚   â””â”€â”€ processors.yml        # å¤„ç†å™¨é…ç½®
â”œâ”€â”€ templates/                # æ¨¡æ¿ç›®å½•
â”‚   â””â”€â”€ app-logs-template.json
â””â”€â”€ pipelines/                # ç®¡é“å®šä¹‰ç›®å½•
    â””â”€â”€ app-logs-pipeline.json
```

---

## 8. ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„é…ç½®è¦ç‚¹


```
ğŸ”¸ åº”ç”¨æ—¥å¿—æ”¶é›†ï¼špathsè·¯å¾„é…ç½®ï¼Œæ”¯æŒé€šé…ç¬¦å’Œè½®è½¬æ–‡ä»¶
ğŸ”¸ å¤šè¡Œå¤„ç†ï¼šmultiline.patternè§£å†³Javaå¼‚å¸¸å †æ ˆåˆå¹¶é—®é¢˜  
ğŸ”¸ åº”ç”¨æ ‡è¯†ï¼šfieldså­—æ®µæ ‡è®°ä¸åŒåº”ç”¨å’Œç¯å¢ƒ
ğŸ”¸ ä¸»æœºä¿¡æ¯ï¼šadd_host_metadataå¤„ç†å™¨å¢åŠ æœåŠ¡å™¨ä¿¡æ¯
ğŸ”¸ æ–‡ä»¶è¿‡æ»¤ï¼šexclude_filesæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ç±»å‹
ğŸ”¸ JSONå¤„ç†ï¼škeys_under_rootå¤„ç†ç»“æ„åŒ–æ—¥å¿—
ğŸ”¸ ç®¡é“æ¨¡æ¿ï¼špipelineå’Œtemplateä¼˜åŒ–æ•°æ®å¤„ç†å’Œå­˜å‚¨
```

### 8.2 å®é™…åº”ç”¨ç»éªŒæ€»ç»“


**ğŸ¯ é…ç½®ç­–ç•¥å»ºè®®**

| ç¯å¢ƒç±»å‹ | é…ç½®é‡ç‚¹ | æ³¨æ„äº‹é¡¹ |
|----------|----------|----------|
| **ç”Ÿäº§ç¯å¢ƒ** | æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯æ—¥å¿—é‡ç‚¹å…³æ³¨ | æ§åˆ¶æ—¥å¿—é‡ï¼Œè®¾ç½®åˆç†çš„include_lines |
| **æµ‹è¯•ç¯å¢ƒ** | å®Œæ•´æ—¥å¿—æ”¶é›†ã€ä¾¿äºè°ƒè¯• | å¯ä»¥æ”¶é›†DEBUGçº§åˆ«ï¼Œä½†æ³¨æ„å­˜å‚¨æˆæœ¬ |
| **å¼€å‘ç¯å¢ƒ** | ç®€åŒ–é…ç½®ã€å¿«é€Ÿåé¦ˆ | æœ¬åœ°ESï¼Œå®æ—¶æŸ¥çœ‹æ—¥å¿— |

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
- **æ–‡ä»¶è·¯å¾„**ï¼šç²¾ç¡®çš„è·¯å¾„é…ç½®å‡å°‘æ‰«æå¼€é”€
- **å¤šè¡Œè¶…æ—¶**ï¼šåˆç†è®¾ç½®timeouté¿å…å†…å­˜å ç”¨
- **æ‰¹é‡å¤§å°**ï¼šæ ¹æ®ç½‘ç»œå’ŒESæ€§èƒ½è°ƒæ•´bulk_max_size
- **å­—æ®µæ•°é‡**ï¼šé¿å…è¿‡å¤šè‡ªå®šä¹‰å­—æ®µå½±å“æ€§èƒ½

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**

```
é—®é¢˜1ï¼šå¤šè¡Œæ—¥å¿—æ²¡æœ‰æ­£ç¡®åˆå¹¶
è§£å†³ï¼šæ£€æŸ¥multiline.patternæ­£åˆ™è¡¨è¾¾å¼æ˜¯å¦åŒ¹é…æ—¥å¿—å¼€å¤´æ ¼å¼

é—®é¢˜2ï¼šJSONæ—¥å¿—è§£æå¤±è´¥  
è§£å†³ï¼šå¼€å¯json.add_error_keyæŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

é—®é¢˜3ï¼šæ—¥å¿—æ”¶é›†å»¶è¿Ÿé«˜
è§£å†³ï¼šè°ƒæ•´scan_frequencyå’Œclose_timeoutå‚æ•°

é—®é¢˜4ï¼šç£ç›˜ç©ºé—´å ç”¨è¿‡å¤§
è§£å†³ï¼šè®¾ç½®åˆç†çš„æ—¥å¿—è½®è½¬å’Œæ¸…ç†ç­–ç•¥
```

**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**
- âœ… è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
- âœ… å¤šè¡Œæ¨¡å¼æ˜¯å¦é€‚åˆå®é™…æ—¥å¿—æ ¼å¼  
- âœ… å­—æ®µæ ‡è¯†æ˜¯å¦å®Œæ•´ï¼Œä¾¿äºåç»­æŸ¥è¯¢
- âœ… æ’é™¤è§„åˆ™æ˜¯å¦åˆç†ï¼Œé¿å…ä¸å¿…è¦çš„æ–‡ä»¶
- âœ… è¾“å‡ºé…ç½®æ˜¯å¦æ­£ç¡®ï¼ŒESè¿æ¥æ˜¯å¦æ­£å¸¸
- âœ… æ€§èƒ½å‚æ•°æ˜¯å¦é€‚åˆå®é™…è´Ÿè½½æƒ…å†µ

**ğŸ’¡ æœ€ä½³å®è·µè¦ç‚¹**
- **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„åº”ç”¨æ ‡è¯†å’Œæ—¥å¿—æ ¼å¼è§„èŒƒ
- **åˆ†å±‚é…ç½®**ï¼šæŒ‰ç¯å¢ƒå’Œåº”ç”¨ç±»å‹åˆ†å±‚ç®¡ç†é…ç½®
- **ç›‘æ§å‘Šè­¦**ï¼šå¯¹Filebeatè‡ªèº«è¿è¡ŒçŠ¶æ€è¿›è¡Œç›‘æ§
- **æ–‡æ¡£ç»´æŠ¤**ï¼šé…ç½®å˜æ›´è¦åŠæ—¶æ›´æ–°æ–‡æ¡£è¯´æ˜

**æ ¸å¿ƒè®°å¿†**ï¼š
- åº”ç”¨æ—¥å¿—æ”¶é›†é‡åœ¨æ ‡è¯†åŒºåˆ†ï¼Œå¤šè¡Œå¤„ç†è§£å†³å †æ ˆé—®é¢˜
- JSONæ ¼å¼æå‡åˆ†ææ•ˆç‡ï¼Œå­—æ®µæ ‡è¯†ä¾¿äºåç»­æŸ¥è¯¢
- æ€§èƒ½ä¼˜åŒ–å¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€—
- é…ç½®ç®¡ç†è¦è§„èŒƒåŒ–ã€æ–‡æ¡£åŒ–ï¼Œä¾¿äºç»´æŠ¤