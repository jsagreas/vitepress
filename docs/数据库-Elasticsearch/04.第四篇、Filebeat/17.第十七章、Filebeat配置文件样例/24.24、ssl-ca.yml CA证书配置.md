---
title: 24、ssl-ca.yml CA证书配置
---
## 📚 目录

1. [SSL证书基础概念](#1-SSL证书基础概念)
2. [CA证书配置原理](#2-CA证书配置原理)
3. [基础CA证书配置](#3-基础CA证书配置)
4. [高级安全配置](#4-高级安全配置)
5. [多环境部署配置](#5-多环境部署配置)
6. [证书管理最佳实践](#6-证书管理最佳实践)
7. [故障排查与监控](#7-故障排查与监控)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔐 SSL证书基础概念


### 1.1 什么是SSL证书


> 📖 **核心概念**  
> SSL证书就像网络世界的"身份证"，用来证明服务器的身份真实性，并为数据传输加密

**💡 生活类比**：
```
现实生活中：
身份证 → 证明你的身份
银行卡密码 → 保护资金安全

网络世界中：
SSL证书 → 证明服务器身份
数据加密 → 保护传输安全
```

**🔍 SSL证书的作用**：
- **身份验证**：确认服务器就是它声称的那个服务器
- **数据加密**：让传输的数据变成密文，防止被窃听
- **数据完整性**：确保数据在传输过程中没有被篡改

### 1.2 CA证书的特殊地位


**📋 证书层级关系**：
```
根CA证书 (最高权威)
    ├─ 中间CA证书 (中级权威)
    │   ├─ 服务器证书1
    │   └─ 服务器证书2
    └─ 中间CA证书 (中级权威)
        ├─ 服务器证书3
        └─ 服务器证书4
```

**🎯 CA证书的核心价值**：
- **信任根源**：所有其他证书的可信度都来源于CA
- **签名验证**：验证其他证书是否由可信CA签发
- **安全基石**：整个SSL安全体系的基础

---

## 2. ⚙️ CA证书配置原理


### 2.1 Filebeat中证书验证流程


**🔄 证书验证过程**：
```
Filebeat启动
    ↓
读取CA证书文件
    ↓
连接Elasticsearch/Logstash
    ↓
接收服务器证书
    ↓
使用CA证书验证服务器证书
    ↓
验证通过 → 建立安全连接
验证失败 → 拒绝连接
```

### 2.2 证书配置的关键参数


**📊 核心配置项说明**：

| 配置项 | **作用** | **重要性** |
|-------|---------|-----------|
| `certificate_authorities` | 指定CA证书文件路径 | `🔥 必须` |
| `verification_mode` | 设置验证模式 | `⭐ 重要` |
| `supported_protocols` | 指定支持的TLS版本 | `💫 建议` |
| `cipher_suites` | 指定加密套件 | `💫 建议` |

---

## 3. 🛠️ 基础CA证书配置


### 3.1 最简单的CA证书配置


> 💡 **适用场景**：开发环境、内部测试

```yaml
# 24-ssl-ca-basic.yml - 基础CA证书配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log

output.elasticsearch:
  hosts: ["https://es-node1:9200"]
  
  # 🔐 基础SSL配置
  ssl:
    # CA证书文件路径
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    
    # 验证模式：full表示完整验证
    verification_mode: full

# 📝 日志配置
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
```

**🎯 配置说明**：
- `certificate_authorities`: 指向CA证书文件的完整路径
- `verification_mode: full`: 进行完整的证书验证（包括主机名）

### 3.2 带密码保护的CA证书配置


> 🔒 **适用场景**：生产环境、高安全要求

```yaml
# 24-ssl-ca-password.yml - 密码保护的CA证书配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/secure.log
    - /var/log/auth.log

output.elasticsearch:
  hosts: ["https://prod-es-cluster:9200"]
  
  ssl:
    # 多个CA证书文件
    certificate_authorities: 
      - "/etc/pki/ca-trust/ca-bundle.crt"
      - "/etc/ssl/private/company-ca.crt"
    
    # 客户端证书（如果需要双向认证）
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    
    # 私钥密码
    key_passphrase: "${FILEBEAT_KEY_PASS}"
    
    # 完整验证模式
    verification_mode: full

# 🔧 高级设置
processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
```

**💡 安全提示**：
- 使用环境变量存储密码，避免明文写在配置文件中
- 确保证书文件权限设置正确（600或400）

### 3.3 灵活验证模式配置


```yaml
# 24-ssl-ca-flexible.yml - 灵活验证模式配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log

output.elasticsearch:
  hosts: ["https://elasticsearch.internal:9200"]
  
  ssl:
    certificate_authorities: ["/opt/certs/internal-ca.pem"]
    
    # 🎯 不同的验证模式选择
    # full: 完整验证（证书+主机名）
    # certificate: 只验证证书，不验证主机名  
    # none: 不验证（仅用于测试）
    verification_mode: certificate
    
    # 支持的TLS协议版本
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
    
    # 自定义加密套件
    cipher_suites:
      - "ECDHE-RSA-AES256-GCM-SHA384"
      - "ECDHE-RSA-AES128-GCM-SHA256"

# 📊 监控配置
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["https://monitoring-es:9200"]
    ssl:
      certificate_authorities: ["/opt/certs/monitoring-ca.pem"]
      verification_mode: full
```

---

## 4. 🔧 高级安全配置


### 4.1 证书撤销列表(CRL)配置


> 📋 **核心概念**  
> CRL(Certificate Revocation List)是已被撤销证书的黑名单，用于检查证书是否仍然有效

```yaml
# 24-ssl-ca-crl.yml - 证书撤销列表配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/security/*.log

output.elasticsearch:
  hosts: ["https://secure-es:9200"]
  
  ssl:
    certificate_authorities: ["/etc/ssl/ca/root-ca.crt"]
    
    # 🔍 证书撤销列表配置
    certificate_revocation_lists: 
      - "/etc/ssl/crl/ca.crl"
    
    # 严格的证书验证
    verification_mode: strict
    
    # 证书有效期检查
    ca_sha256: "a1b2c3d4e5f6..." # CA证书的SHA256指纹
    
# 🛡️ 安全增强设置
processors:
- add_tags:
    tags: [secured, crl-checked]
    target: security
```

**🎯 CRL配置要点**：
- CRL文件需要定期更新（建议每天检查）
- 配置自动下载CRL的定时任务
- 监控CRL文件的时效性

### 4.2 多CA证书链配置


```yaml
# 24-ssl-ca-chain.yml - 多CA证书链配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log

output.elasticsearch:
  hosts: ["https://multi-ca-es:9200"]
  
  ssl:
    # 🔗 完整的证书链配置
    certificate_authorities:
      # 根CA证书
      - "/etc/pki/ca/root-ca.crt"
      # 中间CA证书1  
      - "/etc/pki/ca/intermediate-ca-1.crt"
      # 中间CA证书2
      - "/etc/pki/ca/intermediate-ca-2.crt"
      # 企业内部CA
      - "/etc/pki/ca/company-ca.crt"
    
    # 证书链验证设置
    verification_mode: full
    
    # 🕐 证书时间验证
    renegotiation: never
    
    # 📏 密钥长度要求
    min_version: "1.2"
    max_version: "1.3"

# 📝 详细日志记录
logging:
  level: debug
  selectors: ["*"]
```

### 4.3 主机名验证自定义配置


```yaml
# 24-ssl-ca-hostname.yml - 主机名验证配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/*.log

output.elasticsearch:
  hosts: ["https://es-cluster.company.com:9200"]
  
  ssl:
    certificate_authorities: ["/etc/certs/company-ca.pem"]
    
    # 🏷️ 主机名验证策略
    verification_mode: full
    
    # 服务器名称指示 (SNI)
    server_name: "es-cluster.company.com"
    
    # 🔍 自定义主机名验证
    # 当证书中的主机名与实际主机名不匹配时使用
    hostname_verification: true
    
# ⚡ 性能优化配置
queue.mem:
  events: 4096
  flush.min_events: 512
```

---

## 5. 🌐 多环境部署配置


### 5.1 开发环境配置


> 🎯 **特点**：简化配置，便于调试

```yaml
# 24-ssl-ca-dev.yml - 开发环境配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/dev-app/*.log
  fields:
    environment: development
    
output.elasticsearch:
  hosts: ["https://dev-es.local:9200"]
  
  ssl:
    # 开发环境使用自签名证书
    certificate_authorities: ["/opt/dev-certs/dev-ca.crt"]
    
    # 🔧 宽松的验证模式（仅开发使用）
    verification_mode: certificate
    
    # 允许自签名证书
    verification_mode: none  # ⚠️ 仅开发环境使用

# 🐛 开发调试配置
logging:
  level: debug
  to_stderr: true
```

**⚠️ 开发环境注意事项**：
- 不要在生产环境使用 `verification_mode: none`
- 自签名证书仅适用于内部开发
- 定期更新开发环境证书

### 5.2 测试环境配置


```yaml
# 24-ssl-ca-test.yml - 测试环境配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/test-apps/*.log
  fields:
    environment: testing
    datacenter: test-dc1

output.elasticsearch:
  hosts: 
    - "https://test-es-1.internal:9200"
    - "https://test-es-2.internal:9200"
  
  ssl:
    # 测试环境CA证书
    certificate_authorities: 
      - "/etc/ssl/test-ca.crt"
      - "/etc/ssl/backup-ca.crt"
    
    # 🧪 测试环境验证设置
    verification_mode: full
    
    # 测试环境特定配置
    supported_protocols: ["TLSv1.2", "TLSv1.3"]

# 📊 测试监控
monitoring:
  enabled: true
  cluster_uuid: "test-cluster-001"
```

### 5.3 生产环境配置


> 🔥 **特点**：最高安全级别，完整监控

```yaml
# 24-ssl-ca-prod.yml - 生产环境配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/prod-apps/*.log
    - /var/log/nginx/access.log
    - /var/log/nginx/error.log
  fields:
    environment: production
    datacenter: prod-dc1

output.elasticsearch:
  hosts: 
    - "https://prod-es-1.company.com:9200"
    - "https://prod-es-2.company.com:9200"
    - "https://prod-es-3.company.com:9200"
  
  ssl:
    # 🏢 企业级CA证书配置
    certificate_authorities: 
      - "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem"
      - "/etc/ssl/company/prod-ca.crt"
    
    # 客户端证书（双向认证）
    certificate: "/etc/filebeat/ssl/prod-client.crt"
    key: "/etc/filebeat/ssl/prod-client.key"
    key_passphrase: "${PROD_SSL_KEY_PASS}"
    
    # 🔒 最严格的安全设置
    verification_mode: strict
    
    # 证书指纹验证（额外安全层）
    ca_sha256: "${PROD_CA_FINGERPRINT}"
    
    # 高级安全协议
    supported_protocols: ["TLSv1.3"]
    cipher_suites:
      - "TLS_AES_256_GCM_SHA384"
      - "TLS_CHACHA20_POLY1305_SHA256"
      - "TLS_AES_128_GCM_SHA256"

# 🚨 生产环境监控
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["https://monitoring.company.com:9200"]
    ssl:
      certificate_authorities: ["/etc/ssl/monitoring-ca.crt"]
      verification_mode: strict

# 📝 生产日志配置
logging:
  level: warn
  to_files: true
  files:
    path: /var/log/filebeat
    name: filebeat
    rotateeverybytes: 10485760 # 10MB
    keepfiles: 7
```

---

## 6. 📋 证书管理最佳实践


### 6.1 证书自动更新配置


```yaml
# 24-ssl-ca-auto-renewal.yml - 证书自动更新配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log

output.elasticsearch:
  hosts: ["https://es.company.com:9200"]
  
  ssl:
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    
    # 🔄 证书监控和自动重载
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    
    # 证书变更自动检测
    verification_mode: full
    
    # 🕐 证书有效期检查
    ca_trusted_fingerprint: "${CA_FINGERPRINT}"

# 🤖 自动化配置
processors:
- script:
    lang: javascript
    id: cert_monitor
    source: >
      function process(event) {
        // 证书到期检查逻辑
        var now = new Date();
        event.Put("cert_check_time", now.toISOString());
        return event;
      }
```

**🔧 证书更新脚本示例**：
```bash
#!/bin/bash
# 证书更新检查脚本
CERT_PATH="/etc/filebeat/certs"
CA_CERT="$CERT_PATH/ca.crt"

# 检查证书到期时间
check_cert_expiry() {
    expiry_date=$(openssl x509 -in "$CA_CERT" -noout -enddate | cut -d= -f2)
    expiry_epoch=$(date -d "$expiry_date" +%s)
    current_epoch=$(date +%s)
    days_left=$(( (expiry_epoch - current_epoch) / 86400 ))
    
    if [ $days_left -lt 30 ]; then
        echo "证书将在 $days_left 天后到期，需要更新"
        # 触发证书更新流程
        renew_certificate
    fi
}
```

### 6.2 证书安全存储配置


```yaml
# 24-ssl-ca-secure-storage.yml - 安全存储配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/secure/*.log

output.elasticsearch:
  hosts: ["https://secure-es:9200"]
  
  ssl:
    # 🔐 使用密钥库存储证书
    keystore: "/etc/filebeat/keystore/filebeat.p12"
    keystore_password: "${KEYSTORE_PASSWORD}"
    
    # 或使用传统PEM格式
    certificate_authorities: ["/etc/ssl/private/ca.pem"]
    certificate: "/etc/ssl/private/client.pem"
    key: "/etc/ssl/private/client.key"
    
    # 🛡️ 高级安全设置
    verification_mode: strict
    renegotiation: never
    
# 🔒 文件权限检查
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        // 记录安全相关事件
        event.Put("security_level", "high");
        event.Put("ssl_enabled", true);
        return event;
      }
```

### 6.3 多证书轮换配置


```yaml
# 24-ssl-ca-rotation.yml - 证书轮换配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/apps/*.log

output.elasticsearch:
  hosts: ["https://ha-es:9200"]
  
  ssl:
    # 🔄 支持多证书轮换
    certificate_authorities:
      # 当前有效证书
      - "/etc/certs/current/ca.crt"
      # 备用证书（轮换期间使用）
      - "/etc/certs/backup/ca.crt"
      # 新证书（准备轮换）
      - "/etc/certs/new/ca.crt"
    
    # 客户端证书轮换
    certificate: "/etc/certs/current/client.crt"
    key: "/etc/certs/current/client.key"
    
    verification_mode: full

# 📈 轮换监控
monitoring:
  enabled: true
  cluster_uuid: "rotation-test-cluster"
```

---

## 7. 🔍 故障排查与监控


### 7.1 SSL诊断配置


```yaml
# 24-ssl-ca-debug.yml - SSL诊断配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/debug/*.log

output.elasticsearch:
  hosts: ["https://debug-es:9200"]
  
  ssl:
    certificate_authorities: ["/etc/certs/debug-ca.crt"]
    verification_mode: full
    
    # 🔍 SSL调试设置
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
    
# 📊 详细SSL日志
logging:
  level: debug
  selectors: ["*"]
  to_stderr: true
  
# 🛠️ 诊断处理器
processors:
- add_fields:
    target: ssl_debug
    fields:
      ssl_enabled: true
      ca_file: "/etc/certs/debug-ca.crt"
      verification_mode: "full"
      
- timestamp:
    field: ssl_debug.timestamp
    layouts:
      - '2006-01-02T15:04:05.000Z'
    test:
      - '2023-01-01T12:00:00.000Z'
```

### 7.2 连接监控配置


```yaml
# 24-ssl-ca-monitoring.yml - SSL连接监控
filebeat.inputs:
- type: log
  paths:
    - /var/log/monitoring/*.log

output.elasticsearch:
  hosts: ["https://monitor-es:9200"]
  
  ssl:
    certificate_authorities: ["/etc/certs/monitor-ca.crt"]
    verification_mode: full
    
    # 📡 连接超时配置
    timeout: 30s
    
# 💓 健康检查配置  
http:
  enabled: true
  host: "0.0.0.0"
  port: 5066
  
# 📊 自定义监控指标
processors:
- add_fields:
    target: monitoring
    fields:
      ssl_connection_status: "active"
      ca_verification: "enabled"
      
- drop_event:
    when:
      not:
        contains:
          message: "ERROR"
```

### 7.3 错误处理和重试配置


```yaml
# 24-ssl-ca-error-handling.yml - 错误处理配置
filebeat.inputs:
- type: log
  paths:
    - /var/log/critical/*.log

output.elasticsearch:
  hosts: ["https://critical-es:9200"]
  
  ssl:
    certificate_authorities: ["/etc/certs/critical-ca.crt"]
    verification_mode: full
    
  # 🔄 错误重试配置
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s
  
  # 📋 批量配置
  bulk_max_size: 1000
  timeout: 30s

# 🚨 错误处理
processors:
- add_fields:
    target: error_handling
    fields:
      max_retries: 3
      ssl_required: true
      
when.or:
  - contains:
      message: "SSL"
  - contains: 
      message: "certificate"
      
# 📝 错误日志增强
logging:
  metrics.enabled: true
  metrics.period: 30s
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


> 🎯 **SSL证书配置核心原理**

```
🔸 CA证书作用：验证服务器身份的信任根源
🔸 验证模式：full > certificate > none（安全级别递减）
🔸 证书链：根CA → 中间CA → 服务器证书的信任链条
🔸 文件权限：证书文件必须设置正确的访问权限
🔸 环境区分：开发、测试、生产环境使用不同的证书策略
```

### 8.2 关键配置要点


**🔹 基础配置三要素**：
```yaml
ssl:
  certificate_authorities: ["/path/to/ca.crt"]  # CA证书路径
  verification_mode: full                       # 验证模式  
  supported_protocols: ["TLSv1.2", "TLSv1.3"] # 协议版本
```

**🔹 安全级别对照**：

| 环境类型 | **验证模式** | **证书类型** | **监控级别** |
|---------|-------------|-------------|-------------|
| `开发环境` | `certificate/none` | `自签名证书` | `基础监控` |
| `测试环境` | `full` | `内部CA证书` | `详细监控` |
| `生产环境` | `strict` | `权威CA证书` | `完整监控` |

### 8.3 实际应用指导


**🛠️ 配置文件选择指南**：

```
📋 快速起步：
→ 使用 24-ssl-ca-basic.yml
→ 适合开发测试，快速验证连接

🔒 生产部署：
→ 使用 24-ssl-ca-prod.yml  
→ 完整安全配置，双向认证

🔍 问题诊断：
→ 使用 24-ssl-ca-debug.yml
→ 详细日志，便于排查SSL问题

🔄 证书轮换：
→ 使用 24-ssl-ca-rotation.yml
→ 支持平滑的证书更新
```

### 8.4 常见问题及解决方案


**❓ 常见SSL连接问题**：

| 问题症状 | **可能原因** | **解决方案** |
|---------|-------------|-------------|
| `证书验证失败` | `CA证书不正确` | `检查CA证书文件路径和内容` |
| `主机名不匹配` | `证书CN与主机名不符` | `使用verification_mode: certificate` |
| `连接超时` | `SSL握手失败` | `检查支持的协议版本` |
| `权限错误` | `证书文件权限不当` | `设置证书文件权限为600` |

### 8.5 最佳实践检查清单


**📋 生产环境部署检查**：
- [ ] 使用权威CA签发的证书
- [ ] 设置 `verification_mode: full` 或 `strict`
- [ ] 配置客户端证书（双向认证）
- [ ] 使用环境变量存储密码
- [ ] 设置证书文件正确权限（600）
- [ ] 配置证书到期监控
- [ ] 启用SSL连接日志记录
- [ ] 定期更新CA证书

**🧠 记忆口诀**：
```
CA证书验身份，全链验证最安全
开发宽松测试严，生产环境要最严
文件权限六零零，密码变量不明文
监控轮换要及时，SSL安全记心间
```
