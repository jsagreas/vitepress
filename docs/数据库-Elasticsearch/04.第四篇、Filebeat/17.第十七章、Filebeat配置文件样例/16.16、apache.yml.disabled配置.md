---
title: 16ã€apache.yml.disabledé…ç½®
---
## ğŸ“š ç›®å½•

1. [Apacheæ¨¡å—åŸºç¡€æ¦‚å¿µ](#1-Apacheæ¨¡å—åŸºç¡€æ¦‚å¿µ)
2. [Apacheè®¿é—®æ—¥å¿—é…ç½®](#2-Apacheè®¿é—®æ—¥å¿—é…ç½®)
3. [Apacheé”™è¯¯æ—¥å¿—é…ç½®](#3-Apacheé”™è¯¯æ—¥å¿—é…ç½®)
4. [æ—¥å¿—æ ¼å¼è§£æè®¾ç½®](#4-æ—¥å¿—æ ¼å¼è§£æè®¾ç½®)
5. [è™šæ‹Ÿä¸»æœºæ—¥å¿—é…ç½®](#5-è™šæ‹Ÿä¸»æœºæ—¥å¿—é…ç½®)
6. [SSLè®¿é—®æ—¥å¿—å¤„ç†](#6-SSLè®¿é—®æ—¥å¿—å¤„ç†)
7. [è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼æ”¯æŒ](#7-è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼æ”¯æŒ)
8. [æ€§èƒ½ç›‘æ§ä¸æ•…éšœæ’æŸ¥](#8-æ€§èƒ½ç›‘æ§ä¸æ•…éšœæ’æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Apacheæ¨¡å—åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Filebeat Apacheæ¨¡å—


**ç®€å•ç†è§£**ï¼šæŠŠFilebeatçš„Apacheæ¨¡å—æƒ³è±¡æˆä¸€ä¸ª"ä¸“ä¸šç¿»è¯‘å®˜"ï¼Œå®ƒä¸“é—¨è´Ÿè´£è¯»å–Apache WebæœåŠ¡å™¨äº§ç”Ÿçš„å„ç§æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åæŠŠè¿™äº›æ—¥å¿—ç¿»è¯‘æˆElasticsearchèƒ½ç†è§£çš„æ ¼å¼ã€‚

```
ğŸ¯ Apacheæ¨¡å—çš„ä½œç”¨ï¼š
åŸå§‹Apacheæ—¥å¿— â†’ Apacheæ¨¡å—è§£æ â†’ ç»“æ„åŒ–æ•°æ® â†’ Elasticsearchå­˜å‚¨

å°±åƒè¿™æ ·çš„è½¬æ¢ï¼š
192.168.1.100 - - [21/Sep/2025:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1234
                        â†“ Apacheæ¨¡å—å¤„ç†
{
  "client_ip": "192.168.1.100",
  "timestamp": "2025-09-21T10:30:45+08:00", 
  "method": "GET",
  "url": "/index.html",
  "response_code": 200,
  "bytes": 1234
}
```

### 1.2 Apacheæ¨¡å—çš„æ ¸å¿ƒä¼˜åŠ¿


**ä¸ºä»€ä¹ˆè¦ç”¨Apacheæ¨¡å—è€Œä¸æ˜¯é€šç”¨é‡‡é›†ï¼Ÿ**

```
ğŸ“Š å¯¹æ¯”åˆ†æï¼š

é€šç”¨æ—¥å¿—é‡‡é›†ï¼š
âŒ éœ€è¦æ‰‹å†™å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼
âŒ å®¹æ˜“å‡ºé”™ï¼Œç»´æŠ¤å›°éš¾  
âŒ æ€§èƒ½è¾ƒä½
âŒ ç¼ºå°‘ä¸“ä¸šçš„å­—æ®µæ˜ å°„

Apacheæ¨¡å—ï¼š
âœ… å†…ç½®ä¸“ä¸šçš„Apacheæ—¥å¿—è§£æå™¨
âœ… è‡ªåŠ¨è¯†åˆ«æ ‡å‡†æ—¥å¿—æ ¼å¼
âœ… æ€§èƒ½ä¼˜åŒ–ï¼Œå¤„ç†é€Ÿåº¦å¿«
âœ… æä¾›ä¸°å¯Œçš„å­—æ®µæ˜ å°„å’Œæ•°æ®è½¬æ¢
âœ… æ”¯æŒå¤šç§Apacheæ—¥å¿—æ ¼å¼
```

### 1.3 Apacheæ¨¡å—æ–‡ä»¶ç»“æ„


**ğŸ“ æ¨¡å—æ–‡ä»¶ä½ç½®**ï¼š
```
Filebeatå®‰è£…ç›®å½•ï¼š
/etc/filebeat/
â”œâ”€â”€ filebeat.yml          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ modules.d/             # æ¨¡å—é…ç½®ç›®å½•  
â”‚   â”œâ”€â”€ apache.yml         # Apacheæ¨¡å—é…ç½®ï¼ˆå¯èƒ½æ˜¯.disabledçŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ nginx.yml.disabled
â”‚   â””â”€â”€ system.yml.disabled
â””â”€â”€ module/
    â””â”€â”€ apache/            # Apacheæ¨¡å—å®šä¹‰æ–‡ä»¶
        â”œâ”€â”€ access/        # è®¿é—®æ—¥å¿—å¤„ç†
        â””â”€â”€ error/         # é”™è¯¯æ—¥å¿—å¤„ç†
```

**ğŸ”§ å¯ç”¨Apacheæ¨¡å—**ï¼š
```bash
# æ–¹æ³•ä¸€ï¼šé‡å‘½åæ–‡ä»¶å¯ç”¨
sudo mv /etc/filebeat/modules.d/apache.yml.disabled \
        /etc/filebeat/modules.d/apache.yml

# æ–¹æ³•äºŒï¼šä½¿ç”¨å‘½ä»¤å¯ç”¨
sudo filebeat modules enable apache

# éªŒè¯æ¨¡å—çŠ¶æ€
sudo filebeat modules list
```

---

## 2. ğŸ“„ Apacheè®¿é—®æ—¥å¿—é…ç½®


### 2.1 åŸºç¡€è®¿é—®æ—¥å¿—é…ç½®


**è®¿é—®æ—¥å¿—æ˜¯ä»€ä¹ˆï¼Ÿ**
è®¿é—®æ—¥å¿—å°±åƒç½‘ç«™çš„"è®¿å®¢è®°å½•æœ¬"ï¼Œè®°å½•äº†æ¯ä¸ªç”¨æˆ·è®¿é—®ç½‘ç«™çš„è¯¦ç»†ä¿¡æ¯ï¼šè°æ¥äº†ã€ä»€ä¹ˆæ—¶å€™æ¥çš„ã€çœ‹äº†ä»€ä¹ˆé¡µé¢ã€ç»“æœå¦‚ä½•ç­‰ã€‚

**ğŸ”§ åŸºæœ¬é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# /etc/filebeat/modules.d/apache.yml
- module: apache
  # è®¿é—®æ—¥å¿—é…ç½®
  access:
    enabled: true
    
    # æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
    var.paths:
      - /var/log/apache2/access.log
      - /var/log/apache2/access.log.*
      - /var/log/httpd/access_log
    
    # æ’é™¤ç‰¹å®šæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    exclude_files: 
      - '\.gz$'        # æ’é™¤å‹ç¼©æ–‡ä»¶
      - '\.bak$'       # æ’é™¤å¤‡ä»½æ–‡ä»¶
```

**ğŸ“ ä¸åŒç³»ç»Ÿçš„é»˜è®¤æ—¥å¿—è·¯å¾„**ï¼š
```
Ubuntu/Debianç³»ç»Ÿï¼š
ğŸ“‚ /var/log/apache2/access.log
ğŸ“‚ /var/log/apache2/error.log

CentOS/RHELç³»ç»Ÿï¼š  
ğŸ“‚ /var/log/httpd/access_log
ğŸ“‚ /var/log/httpd/error_log

è‡ªå®šä¹‰è·¯å¾„ï¼š
ğŸ“‚ /opt/apache/logs/access.log
ğŸ“‚ /home/websites/logs/domain.com-access.log
```

### 2.2 é«˜çº§è®¿é—®æ—¥å¿—é…ç½®


**ğŸ“Š å®Œæ•´çš„è®¿é—®æ—¥å¿—é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    
    # å¤šè·¯å¾„é…ç½®
    var.paths:
      - /var/log/apache2/access.log
      - /var/log/apache2/sites-available/*/access.log
      - /var/log/apache2/vhosts/*/access.log
    
    # æ–‡ä»¶ç¼–ç è®¾ç½®
    encoding: utf-8
    
    # æ—¥å¿—æ ¼å¼ï¼ˆApacheæ ‡å‡†æ ¼å¼ï¼‰
    var.format: common  # å¯é€‰ï¼šcommon, combined, custom
    
    # æ—¶åŒºè®¾ç½®
    var.timezone: Asia/Shanghai
    
    # åŒ…å«é¢å¤–å­—æ®µ
    fields:
      logtype: apache_access
      environment: production
      datacenter: beijing
    
    # å­—æ®µæ·»åŠ åˆ°æ ¹çº§åˆ«
    fields_under_root: false
    
    # å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆé€šå¸¸è®¿é—®æ—¥å¿—æ˜¯å•è¡Œï¼‰
    multiline.pattern: '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'
    multiline.negate: true
    multiline.match: after
```

### 2.3 è®¿é—®æ—¥å¿—å­—æ®µè§£æ


**ğŸ” Apacheè®¿é—®æ—¥å¿—åŒ…å«çš„ä¿¡æ¯**ï¼š
```
æ ‡å‡†è®¿é—®æ—¥å¿—æ ¼å¼è§£æï¼š
192.168.1.100 - - [21/Sep/2025:10:30:45 +0800] "GET /index.html HTTP/1.1" 200 1234

è§£æåçš„å­—æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­—æ®µå          â”‚ å«ä¹‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ apache.access.  â”‚                                  â”‚
â”‚ remote_ip       â”‚ å®¢æˆ·ç«¯IPåœ°å€ï¼š192.168.1.100      â”‚
â”‚ user_name       â”‚ è®¤è¯ç”¨æˆ·åï¼š- (åŒ¿åè®¿é—®)          â”‚
â”‚ time_local      â”‚ è®¿é—®æ—¶é—´ï¼š21/Sep/2025:10:30:45   â”‚
â”‚ method          â”‚ HTTPæ–¹æ³•ï¼šGET                    â”‚
â”‚ url             â”‚ è¯·æ±‚URLï¼š/index.html             â”‚
â”‚ http_version    â”‚ HTTPç‰ˆæœ¬ï¼š1.1                    â”‚
â”‚ response_code   â”‚ å“åº”çŠ¶æ€ç ï¼š200                  â”‚
â”‚ body_sent.bytes â”‚ å‘é€å­—èŠ‚æ•°ï¼š1234                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ çŠ¶æ€ç å«ä¹‰é€ŸæŸ¥**ï¼š
```
ğŸŸ¢ 2xx æˆåŠŸå“åº”ï¼š
200 OK - è¯·æ±‚æˆåŠŸ
201 Created - èµ„æºåˆ›å»ºæˆåŠŸ  
204 No Content - è¯·æ±‚æˆåŠŸä½†æ— å†…å®¹è¿”å›

ğŸŸ¡ 3xx é‡å®šå‘ï¼š
301 Moved Permanently - æ°¸ä¹…é‡å®šå‘
302 Found - ä¸´æ—¶é‡å®šå‘
304 Not Modified - èµ„æºæœªä¿®æ”¹

ğŸ”´ 4xx å®¢æˆ·ç«¯é”™è¯¯ï¼š
400 Bad Request - è¯·æ±‚è¯­æ³•é”™è¯¯
401 Unauthorized - éœ€è¦è®¤è¯
403 Forbidden - ç¦æ­¢è®¿é—®
404 Not Found - èµ„æºä¸å­˜åœ¨

ğŸ”´ 5xx æœåŠ¡å™¨é”™è¯¯ï¼š
500 Internal Server Error - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
502 Bad Gateway - ç½‘å…³é”™è¯¯
503 Service Unavailable - æœåŠ¡ä¸å¯ç”¨
```

---

## 3. âš ï¸ Apacheé”™è¯¯æ—¥å¿—é…ç½®


### 3.1 é”™è¯¯æ—¥å¿—åŸºç¡€é…ç½®


**é”™è¯¯æ—¥å¿—æ˜¯ä»€ä¹ˆï¼Ÿ**
é”™è¯¯æ—¥å¿—å°±åƒæ˜¯Apacheçš„"é—®é¢˜æŠ¥å‘Šä¹¦"ï¼Œè®°å½•äº†æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§é—®é¢˜å’Œå¼‚å¸¸æƒ…å†µã€‚

**ğŸ”§ åŸºæœ¬é”™è¯¯æ—¥å¿—é…ç½®**ï¼š
```yaml
- module: apache
  # é”™è¯¯æ—¥å¿—é…ç½®
  error:
    enabled: true
    
    # é”™è¯¯æ—¥å¿—æ–‡ä»¶è·¯å¾„
    var.paths:
      - /var/log/apache2/error.log
      - /var/log/apache2/error.log.*
      - /var/log/httpd/error_log
    
    # é”™è¯¯çº§åˆ«è¿‡æ»¤
    var.loglevel: warn  # åªæ”¶é›†warnçº§åˆ«åŠä»¥ä¸Šçš„é”™è¯¯
```

### 3.2 é”™è¯¯çº§åˆ«è¯¦è§£


**ğŸ“Š Apacheé”™è¯¯çº§åˆ«åˆ†ç±»**ï¼š
```
é”™è¯¯çº§åˆ«ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº§åˆ«    â”‚ æ•°å­—ä»£ç   â”‚ æè¿°                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ emerg   â”‚ 0        â”‚ ç´§æ€¥æƒ…å†µï¼Œç³»ç»Ÿä¸å¯ç”¨        â”‚
â”‚ alert   â”‚ 1        â”‚ éœ€è¦ç«‹å³å¤„ç†çš„é—®é¢˜          â”‚
â”‚ crit    â”‚ 2        â”‚ ä¸¥é‡é”™è¯¯ï¼Œå½±å“åŠŸèƒ½          â”‚
â”‚ error   â”‚ 3        â”‚ ä¸€èˆ¬é”™è¯¯ï¼Œéœ€è¦å…³æ³¨          â”‚
â”‚ warn    â”‚ 4        â”‚ è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½æœ‰é—®é¢˜        â”‚
â”‚ notice  â”‚ 5        â”‚ æ­£å¸¸ä½†é‡è¦çš„ä¿¡æ¯            â”‚
â”‚ info    â”‚ 6        â”‚ ä¸€èˆ¬ä¿¡æ¯                   â”‚
â”‚ debug   â”‚ 7        â”‚ è°ƒè¯•ä¿¡æ¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…åº”ç”¨å»ºè®®ï¼š
ğŸ”´ ç”Ÿäº§ç¯å¢ƒï¼šè®¾ç½®ä¸º warn æˆ– error
ğŸŸ¡ æµ‹è¯•ç¯å¢ƒï¼šè®¾ç½®ä¸º info  
ğŸ”µ å¼€å‘ç¯å¢ƒï¼šè®¾ç½®ä¸º debug
```

### 3.3 é”™è¯¯æ—¥å¿—é«˜çº§é…ç½®


**âš™ï¸ å®Œæ•´é”™è¯¯æ—¥å¿—é…ç½®**ï¼š
```yaml
- module: apache
  error:
    enabled: true
    
    var.paths:
      - /var/log/apache2/error.log
      - /var/log/apache2/sites-available/*/error.log
    
    # é”™è¯¯çº§åˆ«è¿‡æ»¤
    var.loglevel: error
    
    # å¤šè¡Œé”™è¯¯æ—¥å¿—å¤„ç†
    multiline.pattern: '^\[[A-Za-z]{3} [A-Za-z]{3}'
    multiline.negate: true
    multiline.match: after
    multiline.max_lines: 10
    
    # å¤„ç†å™¨é…ç½®ï¼ˆå¯é€‰ï¼‰
    processors:
      - add_fields:
          target: apache.error
          fields:
            server_name: web-server-01
            
      - drop_event:
          when:
            contains:
              message: "client denied by server configuration"
```

### 3.4 å¸¸è§é”™è¯¯ç±»å‹è§£æ


**ğŸ” å…¸å‹é”™è¯¯æ—¥å¿—åˆ†æ**ï¼š
```
ç¤ºä¾‹é”™è¯¯æ—¥å¿—ï¼š
[Wed Sep 21 10:30:45.123456 2025] [php7:error] [pid 12345] [client 192.168.1.100:54321] PHP Fatal error: Uncaught Error

è§£æåçš„å­—æ®µï¼š
apache.error.timestamp: 2025-09-21T10:30:45.123456+08:00
apache.error.level: error  
apache.error.module: php7
apache.error.pid: 12345
apache.error.client: 192.168.1.100:54321
apache.error.message: PHP Fatal error: Uncaught Error
```

**ğŸš¨ å¸¸è§é”™è¯¯ç±»å‹åŠå¤„ç†**ï¼š
```
æ–‡ä»¶æƒé™é”™è¯¯ï¼š
[error] [client IP] (13)Permission denied: access to /file denied
å¤„ç†ï¼šæ£€æŸ¥æ–‡ä»¶æƒé™å’ŒApacheç”¨æˆ·æƒé™

é…ç½®è¯­æ³•é”™è¯¯ï¼š
[error] [client IP] Invalid command 'SSLEngine'
å¤„ç†ï¼šæ£€æŸ¥Apacheé…ç½®æ–‡ä»¶è¯­æ³•ï¼Œç¡®è®¤æ¨¡å—å·²åŠ è½½

èµ„æºä¸è¶³é”™è¯¯ï¼š
[error] server reached MaxRequestWorkers setting
å¤„ç†ï¼šè°ƒæ•´Apacheè¿›ç¨‹/çº¿ç¨‹é…ç½®

SSLè¯ä¹¦é”™è¯¯ï¼š
[error] SSL: error:140AB18F:SSL routines
å¤„ç†ï¼šæ£€æŸ¥SSLè¯ä¹¦é…ç½®å’Œæœ‰æ•ˆæ€§
```

---

## 4. ğŸ”§ æ—¥å¿—æ ¼å¼è§£æè®¾ç½®


### 4.1 Apacheæ ‡å‡†æ—¥å¿—æ ¼å¼


**Apacheæœ‰å“ªäº›æ ‡å‡†æ ¼å¼ï¼Ÿ**
Apacheå°±åƒæœ‰å‡ ç§"è®°å½•æ¨¡æ¿"ï¼Œæ¯ç§æ¨¡æ¿è®°å½•çš„ä¿¡æ¯è¯¦ç»†ç¨‹åº¦ä¸åŒã€‚

**ğŸ“‹ æ ‡å‡†æ ¼å¼å¯¹æ¯”**ï¼š
```
Common Log Format (CLF)ï¼š
æ ¼å¼ï¼š%h %l %u %t "%r" %>s %O
ç¤ºä¾‹ï¼š192.168.1.1 - frank [10/Oct/2000:13:55:36 -0700] "GET /apache_pb.gif HTTP/1.0" 200 2326

Combined Log Formatï¼š
æ ¼å¼ï¼š%h %l %u %t "%r" %>s %O "%{Referer}i" "%{User-Agent}i"  
ç¤ºä¾‹ï¼š192.168.1.1 - frank [10/Oct/2000:13:55:36 -0700] "GET /apache_pb.gif HTTP/1.0" 200 2326 "http://www.example.com/start.html" "Mozilla/4.08"

å­—æ®µè¯´æ˜ï¼š
%h - å®¢æˆ·ç«¯IPåœ°å€
%l - å®¢æˆ·ç«¯èº«ä»½ï¼ˆé€šå¸¸ä¸º -ï¼‰
%u - è®¤è¯ç”¨æˆ·å
%t - è¯·æ±‚æ—¶é—´
%r - è¯·æ±‚è¡Œï¼ˆæ–¹æ³• URL åè®®ï¼‰
%>s - å“åº”çŠ¶æ€ç 
%O - å‘é€å­—èŠ‚æ•°
%{Referer}i - æ¥æºé¡µé¢
%{User-Agent}i - ç”¨æˆ·ä»£ç†
```

### 4.2 è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼é…ç½®


**âš™ï¸ åœ¨Apacheä¸­é…ç½®è‡ªå®šä¹‰æ ¼å¼**ï¼š
```apache
# Apacheé…ç½®æ–‡ä»¶ä¸­å®šä¹‰è‡ªå®šä¹‰æ ¼å¼
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" custom_format

# åº”ç”¨è‡ªå®šä¹‰æ ¼å¼
CustomLog /var/log/apache2/access.log custom_format
```

**ğŸ“Š Filebeatä¸­å¤„ç†è‡ªå®šä¹‰æ ¼å¼**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    var.paths:
      - /var/log/apache2/access.log
    
    # è‡ªå®šä¹‰æ ¼å¼é…ç½®
    var.format: custom
    
    # è‡ªå®šä¹‰æ ¼å¼æ¨¡å¼
    var.pattern: >
      %{IPORHOST:apache.access.remote_ip}
      %{USER:apache.access.remote_user}
      %{USER:apache.access.user_name}
      \[%{HTTPDATE:apache.access.time}\]
      "%{WORD:apache.access.method} %{URIPATH:apache.access.url}(?:%{URIPARAM:apache.access.url_params})? HTTP/%{NUMBER:apache.access.http_version}"
      %{INT:apache.access.response_code}
      (?:%{INT:apache.access.body_sent.bytes}|-)
      %{INT:apache.access.request_time_us}
```

### 4.3 ç‰¹æ®Šå­—æ®µå¤„ç†


**ğŸ¯ å¸¸ç”¨çš„ç‰¹æ®Šå­—æ®µé…ç½®**ï¼š
```yaml
# å¤„ç†å“åº”æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
- module: apache
  access:
    enabled: true
    var.paths: ["/var/log/apache2/access.log"]
    
    processors:
      # å°†å“åº”æ—¶é—´ä»å¾®ç§’è½¬æ¢ä¸ºæ¯«ç§’
      - script:
          lang: javascript
          source: >
            if (event.Get("apache.access.request_time_us")) {
              var timeUs = event.Get("apache.access.request_time_us");
              event.Put("apache.access.request_time_ms", timeUs / 1000);
            }
      
      # æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯ï¼ˆéœ€è¦GeoIPé…ç½®ï¼‰
      - add_host_metadata:
          when.not.contains.tags: forwarded
          
      # ç”¨æˆ·ä»£ç†è§£æ
      - add_fields:
          target: user_agent
          fields:
            original: "%{[apache][access][user_agent]}"
```

---

## 5. ğŸ  è™šæ‹Ÿä¸»æœºæ—¥å¿—é…ç½®


### 5.1 è™šæ‹Ÿä¸»æœºæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è™šæ‹Ÿä¸»æœºï¼Ÿ**
æƒ³è±¡ä¸€æ ‹å¤§æ¥¼é‡Œæœ‰å¾ˆå¤šå…¬å¸ï¼Œæ¯ä¸ªå…¬å¸éƒ½æœ‰è‡ªå·±çš„é—¨ç‰Œå·ã€‚è™šæ‹Ÿä¸»æœºå°±æ˜¯è®©ä¸€å°ApacheæœåŠ¡å™¨åŒæ—¶ä¸ºå¤šä¸ªç½‘ç«™æä¾›æœåŠ¡ï¼Œæ¯ä¸ªç½‘ç«™å°±åƒæ¥¼é‡Œçš„ä¸€ä¸ªå…¬å¸ã€‚

```
ğŸ¢ è™šæ‹Ÿä¸»æœºç¤ºä¾‹ï¼š
ä¸€å°æœåŠ¡å™¨æ‰˜ç®¡å¤šä¸ªç½‘ç«™ï¼š
â”œâ”€â”€ www.company-a.com     # å…¬å¸Açš„ç½‘ç«™
â”œâ”€â”€ www.company-b.com     # å…¬å¸Bçš„ç½‘ç«™  
â”œâ”€â”€ blog.company-a.com    # å…¬å¸Açš„åšå®¢
â””â”€â”€ api.company-b.com     # å…¬å¸Bçš„API

æ¯ä¸ªè™šæ‹Ÿä¸»æœºéƒ½æœ‰ï¼š
âœ… ç‹¬ç«‹çš„åŸŸå
âœ… ç‹¬ç«‹çš„ç½‘ç«™å†…å®¹
âœ… ç‹¬ç«‹çš„æ—¥å¿—æ–‡ä»¶
âœ… ç‹¬ç«‹çš„é…ç½®é€‰é¡¹
```

### 5.2 è™šæ‹Ÿä¸»æœºæ—¥å¿—è·¯å¾„é…ç½®


**ğŸ“ å…¸å‹çš„è™šæ‹Ÿä¸»æœºæ—¥å¿—ç»“æ„**ï¼š
```bash
# æ–¹å¼ä¸€ï¼šæŒ‰åŸŸååˆ†ç›®å½•
/var/log/apache2/
â”œâ”€â”€ vhosts/
â”‚   â”œâ”€â”€ company-a.com/
â”‚   â”‚   â”œâ”€â”€ access.log
â”‚   â”‚   â””â”€â”€ error.log
â”‚   â”œâ”€â”€ company-b.com/  
â”‚   â”‚   â”œâ”€â”€ access.log
â”‚   â”‚   â””â”€â”€ error.log
â”‚   â””â”€â”€ api.example.com/
â”‚       â”œâ”€â”€ access.log
â”‚       â””â”€â”€ error.log

# æ–¹å¼äºŒï¼šæ–‡ä»¶ååŒ…å«åŸŸå
/var/log/apache2/
â”œâ”€â”€ company-a.com-access.log
â”œâ”€â”€ company-a.com-error.log
â”œâ”€â”€ company-b.com-access.log
â””â”€â”€ company-b.com-error.log
```

**âš™ï¸ è™šæ‹Ÿä¸»æœºæ—¥å¿—é‡‡é›†é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    
    # æ–¹æ³•ä¸€ï¼šé€šé…ç¬¦åŒ¹é…æ‰€æœ‰è™šæ‹Ÿä¸»æœº
    var.paths:
      - /var/log/apache2/vhosts/*/access.log
      - /var/log/apache2/*-access.log
      - /var/log/apache2/sites-available/*/access.log
    
    # æ·»åŠ è™šæ‹Ÿä¸»æœºä¿¡æ¯åˆ°å­—æ®µ
    processors:
      - add_fields:
          target: apache.access
          fields:
            vhost: "%{[log][file][path]}"
            
      # ä»æ–‡ä»¶è·¯å¾„æå–åŸŸå
      - script:
          lang: javascript
          source: >
            var path = event.Get("log.file.path");
            if (path) {
              var matches = path.match(/\/([^\/]+)\/access\.log$/);
              if (matches) {
                event.Put("apache.access.vhost", matches[1]);
              }
            }
  
  error:
    enabled: true
    var.paths:
      - /var/log/apache2/vhosts/*/error.log
      - /var/log/apache2/*-error.log
```

### 5.3 å¤šè™šæ‹Ÿä¸»æœºç®¡ç†ç­–ç•¥


**ğŸ¯ æ¨èçš„è™šæ‹Ÿä¸»æœºæ—¥å¿—ç®¡ç†**ï¼š
```yaml
# ä¸ºä¸åŒé‡è¦çº§åˆ«çš„è™šæ‹Ÿä¸»æœºè®¾ç½®ä¸åŒçš„é‡‡é›†ç­–ç•¥
- module: apache
  access:
    enabled: true
    
    # é‡è¦çš„ç”Ÿäº§ç¯å¢ƒç½‘ç«™
    var.paths:
      - /var/log/apache2/vhosts/production-*.com/access.log
    
    fields:
      environment: production
      priority: high
      
    processors:
      - add_fields:
          target: ""
          fields:
            log_retention_days: 365
            alert_enabled: true

# æµ‹è¯•ç¯å¢ƒè™šæ‹Ÿä¸»æœº
- module: apache  
  access:
    enabled: true
    
    var.paths:
      - /var/log/apache2/vhosts/test-*.com/access.log
      - /var/log/apache2/vhosts/dev-*.com/access.log
    
    fields:
      environment: testing
      priority: low
      
    processors:
      - add_fields:
          target: ""
          fields:
            log_retention_days: 30
            alert_enabled: false
```

---

## 6. ğŸ”’ SSLè®¿é—®æ—¥å¿—å¤„ç†


### 6.1 SSLæ—¥å¿—ç‰¹ç‚¹


**SSLæ—¥å¿—æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ**
SSLæ—¥å¿—å°±åƒæ˜¯"åŠ å¯†é€šä¿¡è®°å½•"ï¼Œé™¤äº†è®°å½•æ™®é€šçš„è®¿é—®ä¿¡æ¯ï¼Œè¿˜ä¼šè®°å½•åŠ å¯†ç›¸å…³çš„è¯¦ç»†ä¿¡æ¯ã€‚

**ğŸ” SSLæ—¥å¿—åŒ…å«çš„é¢å¤–ä¿¡æ¯**ï¼š
```
æ ‡å‡†è®¿é—®æ—¥å¿—å­—æ®µï¼š
+ IPåœ°å€ã€æ—¶é—´ã€è¯·æ±‚æ–¹æ³•ã€URLã€çŠ¶æ€ç 

SSLç‰¹æœ‰å­—æ®µï¼š
+ SSLåè®®ç‰ˆæœ¬ (TLSv1.2, TLSv1.3)
+ åŠ å¯†å¥—ä»¶ (cipher suite)
+ å®¢æˆ·ç«¯è¯ä¹¦ä¿¡æ¯
+ SSLæ¡æ‰‹æ—¶é—´
+ SNI (Server Name Indication)
```

### 6.2 SSLæ—¥å¿—é…ç½®


**âš™ï¸ Apache SSLæ—¥å¿—æ ¼å¼é…ç½®**ï¼š
```apache
# åœ¨Apacheé…ç½®ä¸­å®šä¹‰SSLæ—¥å¿—æ ¼å¼
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{SSL_CLIENT_S_DN}x" ssl_combined

# SSLè™šæ‹Ÿä¸»æœºé…ç½®
<VirtualHost *:443>
    ServerName secure.example.com
    SSLEngine on
    SSLCertificateFile /path/to/cert.pem
    SSLCertificateKeyFile /path/to/private.key
    
    # SSLä¸“ç”¨æ—¥å¿—
    CustomLog /var/log/apache2/ssl-access.log ssl_combined
    ErrorLog /var/log/apache2/ssl-error.log
</VirtualHost>
```

**ğŸ“Š Filebeat SSLæ—¥å¿—é‡‡é›†é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    
    # SSLæ—¥å¿—æ–‡ä»¶
    var.paths:
      - /var/log/apache2/ssl-access.log
      - /var/log/apache2/vhosts/*/ssl-access.log
    
    # SSLæ—¥å¿—æ ¼å¼
    var.format: custom
    
    # æ·»åŠ SSLç›¸å…³å­—æ®µ
    fields:
      log_type: ssl_access
      protocol: https
      
    processors:
      # è§£æSSLåè®®ä¿¡æ¯
      - script:
          lang: javascript
          source: >
            var message = event.Get("message");
            if (message) {
              // æå–SSLåè®®ç‰ˆæœ¬
              var sslMatch = message.match(/TLSv[\d\.]+/);
              if (sslMatch) {
                event.Put("apache.access.ssl.protocol", sslMatch[0]);
              }
              
              // æå–åŠ å¯†å¥—ä»¶
              var cipherMatch = message.match(/ECDHE-[A-Z0-9-]+/);
              if (cipherMatch) {
                event.Put("apache.access.ssl.cipher", cipherMatch[0]);
              }
            }
      
      # æ ‡è®°å®‰å…¨ç­‰çº§
      - add_fields:
          target: security
          fields:
            level: high
            encrypted: true
```

### 6.3 SSLæ€§èƒ½ç›‘æ§


**ğŸ“ˆ SSLæ€§èƒ½æŒ‡æ ‡é‡‡é›†**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    var.paths: ["/var/log/apache2/ssl-access.log"]
    
    processors:
      # SSLæ¡æ‰‹æ—¶é—´ç›‘æ§
      - script:
          lang: javascript
          source: >
            var requestTime = event.Get("apache.access.request_time_us");
            if (requestTime) {
              // SSLæ¡æ‰‹é€šå¸¸å ç”¨è¾ƒå¤šæ—¶é—´
              if (requestTime > 1000000) { // å¤§äº1ç§’
                event.Put("ssl.handshake.slow", true);
                event.Put("ssl.performance.warning", "slow_handshake");
              }
            }
      
      # SSLé”™è¯¯æ£€æµ‹  
      - add_fields:
          when:
            range:
              apache.access.response_code:
                gte: 400
                lt: 500
          target: ssl.error
          fields:
            type: client_error
            
      - add_fields:
          when:
            range:
              apache.access.response_code:
                gte: 500
          target: ssl.error
          fields:
            type: server_error
```

---

## 7. ğŸ¨ è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼æ”¯æŒ


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ ¼å¼


**å®é™…éœ€æ±‚åœºæ™¯**ï¼š
```
é»˜è®¤æ ¼å¼çš„å±€é™æ€§ï¼š
âŒ ç¼ºå°‘ä¸šåŠ¡ç›¸å…³å­—æ®µ
âŒ ç¼ºå°‘æ€§èƒ½ç›‘æ§æŒ‡æ ‡  
âŒ ç¼ºå°‘å®‰å…¨å®¡è®¡ä¿¡æ¯
âŒ æ ¼å¼ä¸ç¬¦åˆä¼ä¸šæ ‡å‡†

è‡ªå®šä¹‰æ ¼å¼çš„ä¼˜åŠ¿ï¼š
âœ… æ·»åŠ ä¸šåŠ¡IDã€ç”¨æˆ·IDç­‰ä¸šåŠ¡å­—æ®µ
âœ… åŒ…å«å“åº”æ—¶é—´ã€å¤„ç†æ—¶é—´ç­‰æ€§èƒ½æŒ‡æ ‡
âœ… è®°å½•å®‰å…¨ç›¸å…³ä¿¡æ¯
âœ… ç¬¦åˆä¼ä¸šæ—¥å¿—æ ‡å‡†
```

### 7.2 è‡ªå®šä¹‰æ ¼å¼è®¾è®¡


**ğŸ¯ å®ç”¨çš„è‡ªå®šä¹‰æ ¼å¼ç¤ºä¾‹**ï¼š
```apache
# ä¸šåŠ¡å¯¼å‘çš„è‡ªå®šä¹‰æ ¼å¼
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D %{X-Request-ID}i %{X-User-ID}i %{X-Session-ID}i" business_format

å­—æ®µå«ä¹‰ï¼š
%D - è¯·æ±‚å¤„ç†æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
%{X-Request-ID}i - è¯·æ±‚è·Ÿè¸ªID
%{X-User-ID}i - ç”¨æˆ·ID  
%{X-Session-ID}i - ä¼šè¯ID

# å®‰å…¨å¯¼å‘çš„è‡ªå®šä¹‰æ ¼å¼
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{X-Forwarded-For}i" security_format

å®‰å…¨å­—æ®µï¼š
%{SSL_PROTOCOL}x - SSLåè®®ç‰ˆæœ¬
%{SSL_CIPHER}x - åŠ å¯†å¥—ä»¶
%{X-Forwarded-For}i - çœŸå®å®¢æˆ·ç«¯IPï¼ˆä»£ç†ç¯å¢ƒï¼‰
```

### 7.3 Filebeatè‡ªå®šä¹‰æ ¼å¼é…ç½®


**âš™ï¸ å¤„ç†å¤æ‚è‡ªå®šä¹‰æ ¼å¼**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    var.paths: ["/var/log/apache2/custom-access.log"]
    
    # ç¦ç”¨å†…ç½®è§£æå™¨ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¤„ç†
    var.format: custom
    
    processors:
      # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æè‡ªå®šä¹‰æ ¼å¼
      - dissect:
          tokenizer: '%{client_ip} %{ident} %{auth} [%{timestamp}] "%{method} %{url} %{http_version}" %{response_code} %{bytes} "%{referrer}" "%{user_agent}" %{request_time} %{request_id} %{user_id} %{session_id}'
          field: "message"
          target_prefix: "apache.access"
      
      # æ•°æ®ç±»å‹è½¬æ¢
      - convert:
          fields:
            - {from: "apache.access.response_code", type: "integer"}
            - {from: "apache.access.bytes", type: "integer"}  
            - {from: "apache.access.request_time", type: "integer"}
          ignore_missing: true
      
      # æ—¶é—´å­—æ®µå¤„ç†
      - timestamp:
          field: apache.access.timestamp
          layouts:
            - '02/Jan/2006:15:04:05 -0700'
          test:
            - '21/Sep/2025:10:30:45 +0800'
      
      # ä¸šåŠ¡å­—æ®µå¤„ç†
      - script:
          lang: javascript
          source: >
            // å¤„ç†ç”¨æˆ·ID
            var userId = event.Get("apache.access.user_id");
            if (userId && userId !== "-") {
              event.Put("user.id", userId);
              event.Put("user.authenticated", true);
            } else {
              event.Put("user.authenticated", false);
            }
            
            // å¤„ç†è¯·æ±‚è·Ÿè¸ª
            var requestId = event.Get("apache.access.request_id");
            if (requestId && requestId !== "-") {
              event.Put("trace.id", requestId);
            }
```

### 7.4 JSONæ ¼å¼æ—¥å¿—å¤„ç†


**ğŸ”§ ç°ä»£åŒ–çš„JSONæ—¥å¿—æ ¼å¼**ï¼š
```apache
# Apacheé…ç½®è¾“å‡ºJSONæ ¼å¼æ—¥å¿—
LogFormat "{ \"timestamp\": \"%{%Y-%m-%dT%H:%M:%S}t.%{msec_frac}t%{%z}t\", \"client_ip\": \"%h\", \"method\": \"%m\", \"url\": \"%U\", \"query\": \"%q\", \"protocol\": \"%H\", \"status\": \"%>s\", \"bytes\": \"%O\", \"referer\": \"%{Referer}i\", \"user_agent\": \"%{User-Agent}i\", \"request_time\": %D, \"server_name\": \"%v\" }" json_format

CustomLog /var/log/apache2/access-json.log json_format
```

**ğŸ“Š Filebeat JSONæ—¥å¿—é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: false  # ç¦ç”¨Apacheæ¨¡å—çš„è®¿é—®æ—¥å¿—å¤„ç†

# ä½¿ç”¨é€šç”¨æ—¥å¿—å¤„ç†JSONæ ¼å¼
filebeat.inputs:
- type: log
  paths:
    - /var/log/apache2/access-json.log
  
  # JSONè§£æ
  json.keys_under_root: true
  json.add_error_key: true
  
  fields:
    logtype: apache_json
    service: web
  
  processors:
    # æ ‡å‡†åŒ–å­—æ®µå
    - rename:
        fields:
          - from: "client_ip"
            to: "source.ip"
          - from: "user_agent"  
            to: "user_agent.original"
          - from: "request_time"
            to: "event.duration"
            
    # æ·»åŠ è®¡ç®—å­—æ®µ
    - script:
        lang: javascript
        source: >
          // è½¬æ¢å“åº”æ—¶é—´å•ä½
          var duration = event.Get("event.duration");
          if (duration) {
            event.Put("event.duration_ms", duration / 1000);
          }
          
          // åˆ†ç±»å“åº”çŠ¶æ€
          var status = event.Get("status");
          if (status) {
            if (status >= 200 && status < 300) {
              event.Put("http.response.status_class", "success");
            } else if (status >= 400 && status < 500) {
              event.Put("http.response.status_class", "client_error");
            } else if (status >= 500) {
              event.Put("http.response.status_class", "server_error");
            }
          }
```

---

## 8. ğŸ“Š æ€§èƒ½ç›‘æ§ä¸æ•…éšœæ’æŸ¥


### 8.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§


**å…³é”®æ€§èƒ½æŒ‡æ ‡è¯†åˆ«**ï¼š
```
ğŸ¯ é‡è¦æ€§èƒ½æŒ‡æ ‡ï¼š

å“åº”æ—¶é—´æŒ‡æ ‡ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´
â€¢ 95%åˆ†ä½å“åº”æ—¶é—´  
â€¢ 99%åˆ†ä½å“åº”æ—¶é—´
â€¢ è¶…æ—¶è¯·æ±‚æ•°é‡

ååé‡æŒ‡æ ‡ï¼š
â€¢ æ¯ç§’è¯·æ±‚æ•°(RPS)
â€¢ æ¯åˆ†é’Ÿé¡µé¢æµè§ˆé‡(PV)
â€¢ å¸¦å®½ä½¿ç”¨æƒ…å†µ

é”™è¯¯ç‡æŒ‡æ ‡ï¼š
â€¢ 4xxé”™è¯¯ç‡
â€¢ 5xxé”™è¯¯ç‡
â€¢ è¶…æ—¶é”™è¯¯ç‡
```

**ğŸ“ˆ æ€§èƒ½ç›‘æ§é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    var.paths: ["/var/log/apache2/access.log"]
    
    processors:
      # æ€§èƒ½åˆ†ç±»æ ‡è®°
      - script:
          lang: javascript
          source: >
            var responseTime = event.Get("apache.access.request_time_us");
            var status = event.Get("apache.access.response_code");
            
            // å“åº”æ—¶é—´åˆ†ç±»
            if (responseTime) {
              if (responseTime > 5000000) { // >5ç§’
                event.Put("performance.category", "very_slow");
                event.Put("performance.alert", true);
              } else if (responseTime > 2000000) { // >2ç§’
                event.Put("performance.category", "slow");  
              } else if (responseTime > 1000000) { // >1ç§’
                event.Put("performance.category", "normal");
              } else {
                event.Put("performance.category", "fast");
              }
            }
            
            // çŠ¶æ€åˆ†ç±»
            if (status) {
              if (status >= 500) {
                event.Put("error.category", "server_error");
                event.Put("error.severity", "high");
              } else if (status >= 400) {
                event.Put("error.category", "client_error");
                event.Put("error.severity", "medium");
              }
            }
      
      # é«˜æµé‡æ£€æµ‹
      - script:
          lang: javascript  
          source: >
            // æ£€æµ‹å¯ç–‘çš„é«˜é¢‘è®¿é—®
            var ip = event.Get("source.ip");
            var url = event.Get("url.path");
            
            if (ip && url) {
              // æ ‡è®°å¯èƒ½çš„çˆ¬è™«æˆ–æ”»å‡»
              if (url.includes("admin") || url.includes("wp-admin")) {
                event.Put("security.suspicious", true);
                event.Put("security.type", "admin_access_attempt");
              }
            }
```

### 8.2 æ•…éšœæ’æŸ¥é…ç½®


**ğŸ” æ•…éšœæ¨¡å¼è¯†åˆ«**ï¼š
```yaml
- module: apache
  error:
    enabled: true
    var.paths: ["/var/log/apache2/error.log"]
    
    processors:
      # é”™è¯¯åˆ†ç±»å’Œå‘Šè­¦
      - script:
          lang: javascript
          source: >
            var message = event.Get("message");
            var level = event.Get("log.level");
            
            if (message) {
              // å†…å­˜ä¸è¶³é”™è¯¯
              if (message.includes("Cannot allocate memory")) {
                event.Put("error.type", "memory_exhaustion");
                event.Put("alert.severity", "critical");
                event.Put("alert.action", "restart_required");
              }
              
              // æ–‡ä»¶æè¿°ç¬¦ä¸è¶³
              else if (message.includes("Too many open files")) {
                event.Put("error.type", "fd_exhaustion");
                event.Put("alert.severity", "high");
                event.Put("alert.action", "check_limits");
              }
              
              // SSLé”™è¯¯
              else if (message.includes("SSL") && level === "error") {
                event.Put("error.type", "ssl_error");
                event.Put("alert.severity", "medium");
                event.Put("alert.action", "check_certificates");
              }
              
              // æƒé™é”™è¯¯
              else if (message.includes("Permission denied")) {
                event.Put("error.type", "permission_error");
                event.Put("alert.severity", "medium");
                event.Put("alert.action", "check_permissions");
              }
            }
      
      # é”™è¯¯é¢‘ç‡æ£€æµ‹
      - fingerprint:
          fields: ["apache.error.message"]
          target_field: "error.fingerprint"
```

### 8.3 å®‰å…¨äº‹ä»¶æ£€æµ‹


**ğŸ›¡ï¸ å®‰å…¨ç›‘æ§é…ç½®**ï¼š
```yaml
- module: apache
  access:
    enabled: true
    var.paths: ["/var/log/apache2/access.log"]
    
    processors:
      # æ”»å‡»æ¨¡å¼æ£€æµ‹
      - script:
          lang: javascript
          source: >
            var url = event.Get("url.path");
            var userAgent = event.Get("user_agent.original");
            var status = event.Get("http.response.status_code");
            
            if (url) {
              // SQLæ³¨å…¥æ£€æµ‹
              if (/select|union|insert|update|delete|script|alert/i.test(url)) {
                event.Put("security.attack.type", "sql_injection");
                event.Put("security.threat_level", "high");
              }
              
              // ç›®å½•éå†æ£€æµ‹
              else if (/\.\.\/|\.\.\\/.test(url)) {
                event.Put("security.attack.type", "directory_traversal");
                event.Put("security.threat_level", "medium");
              }
              
              // æ•æ„Ÿæ–‡ä»¶è®¿é—®
              else if (/\.(config|env|sql|bak)$/i.test(url)) {
                event.Put("security.attack.type", "sensitive_file_access");
                event.Put("security.threat_level", "medium");
              }
            }
            
            // çˆ¬è™«æ£€æµ‹
            if (userAgent) {
              if (/bot|crawler|spider|scraper/i.test(userAgent)) {
                event.Put("client.type", "bot");
              } else if (!userAgent || userAgent.length < 10) {
                event.Put("client.type", "suspicious");
                event.Put("security.suspicious_user_agent", true);
              }
            }
            
            // å¼‚å¸¸çŠ¶æ€ç æ¨¡å¼
            if (status === 404) {
              event.Put("security.recon_attempt", true);
            }
      
      # IPåœ°ç†ä½ç½®åˆ†æ
      - add_host_metadata:
          when.not.contains.tags: forwarded
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Apacheæ¨¡å—æœ¬è´¨ï¼šä¸“é—¨ä¸ºApacheæ—¥å¿—è®¾è®¡çš„è§£æå™¨ï¼Œæ¯”é€šç”¨æ–¹æ³•æ›´é«˜æ•ˆ
ğŸ”¸ è®¿é—®æ—¥å¿—ä½œç”¨ï¼šè®°å½•æ‰€æœ‰HTTPè¯·æ±‚ï¼Œç”¨äºåˆ†æç”¨æˆ·è¡Œä¸ºå’Œæ€§èƒ½ç›‘æ§
ğŸ”¸ é”™è¯¯æ—¥å¿—ä½œç”¨ï¼šè®°å½•æœåŠ¡å™¨é—®é¢˜ï¼Œç”¨äºæ•…éšœæ’æŸ¥å’Œç³»ç»Ÿç›‘æ§
ğŸ”¸ è™šæ‹Ÿä¸»æœºæ”¯æŒï¼šå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªç½‘ç«™çš„æ—¥å¿—ï¼Œæ”¯æŒçµæ´»çš„è·¯å¾„é…ç½®
ğŸ”¸ SSLæ—¥å¿—ç‰¹ç‚¹ï¼šåŒ…å«åŠ å¯†ç›¸å…³ä¿¡æ¯ï¼Œå¯¹å®‰å…¨ç›‘æ§å¾ˆé‡è¦
ğŸ”¸ è‡ªå®šä¹‰æ ¼å¼ï¼šå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚æ·»åŠ ç‰¹å®šå­—æ®µ
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šé€šè¿‡æ—¥å¿—åˆ†æè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œå¼‚å¸¸æƒ…å†µ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©Apacheæ¨¡å—è€Œä¸æ˜¯é€šç”¨æ—¥å¿—é‡‡é›†**ï¼š
```
æ•ˆç‡ä¼˜åŠ¿ï¼š
â€¢ å†…ç½®é«˜æ•ˆçš„æ—¥å¿—è§£æå™¨
â€¢ é’ˆå¯¹Apacheæ ¼å¼ä¼˜åŒ–
â€¢ å‡å°‘CPUå’Œå†…å­˜ä½¿ç”¨

åŠŸèƒ½ä¼˜åŠ¿ï¼š
â€¢ è‡ªåŠ¨å­—æ®µæ˜ å°„
â€¢ æ ‡å‡†æ ¼å¼è¯†åˆ«
â€¢ ä¸°å¯Œçš„å¤„ç†é€‰é¡¹

ç»´æŠ¤ä¼˜åŠ¿ï¼š
â€¢ é…ç½®ç®€å•ç›´è§‚
â€¢ é”™è¯¯å¤„ç†æ›´å®Œå–„
â€¢ ç¤¾åŒºæ”¯æŒæ›´å¥½
```

**ğŸ”¹ å¦‚ä½•è®¾è®¡åˆç†çš„æ—¥å¿—é‡‡é›†ç­–ç•¥**ï¼š
```
åˆ†å±‚ç­–ç•¥ï¼š
1. ç³»ç»Ÿæ—¥å¿—ï¼šåŸºç¡€çš„è®¿é—®å’Œé”™è¯¯æ—¥å¿—
2. ä¸šåŠ¡æ—¥å¿—ï¼šåŒ…å«ä¸šåŠ¡ç›¸å…³å­—æ®µçš„è‡ªå®šä¹‰æ—¥å¿—
3. å®‰å…¨æ—¥å¿—ï¼šä¸“é—¨ç”¨äºå®‰å…¨ç›‘æ§çš„æ—¥å¿—
4. æ€§èƒ½æ—¥å¿—ï¼šä¸“é—¨ç”¨äºæ€§èƒ½åˆ†æçš„æ—¥å¿—

å­˜å‚¨ç­–ç•¥ï¼š
â€¢ çƒ­æ•°æ®ï¼šè¿‘æœŸæ—¥å¿—ï¼Œå¿«é€ŸæŸ¥è¯¢
â€¢ æ¸©æ•°æ®ï¼šå†å²æ—¥å¿—ï¼Œå®šæœŸåˆ†æ
â€¢ å†·æ•°æ®ï¼šå½’æ¡£æ—¥å¿—ï¼Œåˆè§„è¦æ±‚
```

**ğŸ”¹ æ€§èƒ½å’Œå®‰å…¨ç›‘æ§çš„é‡è¦æ€§**ï¼š
```
æ€§èƒ½ç›‘æ§ä»·å€¼ï¼š
â€¢ æå‰å‘ç°æ€§èƒ½é—®é¢˜
â€¢ ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
â€¢ æŒ‡å¯¼å®¹é‡è§„åˆ’
â€¢ æ”¯æŒæ•…éšœæ’æŸ¥

å®‰å…¨ç›‘æ§ä»·å€¼ï¼š
â€¢ åŠæ—¶å‘ç°æ”»å‡»è¡Œä¸º
â€¢ ä¿æŠ¤æ•æ„Ÿæ•°æ®
â€¢ æ»¡è¶³åˆè§„è¦æ±‚
â€¢ æä¾›å®¡è®¡è¯æ®
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ éƒ¨ç½²æœ€ä½³å®è·µ**ï¼š
```
é…ç½®æ–‡ä»¶ç®¡ç†ï¼š
âœ… ç‰ˆæœ¬æ§åˆ¶ï¼šå°†é…ç½®æ–‡ä»¶çº³å…¥ç‰ˆæœ¬ç®¡ç†
âœ… ç¯å¢ƒåˆ†ç¦»ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
âœ… é…ç½®éªŒè¯ï¼šéƒ¨ç½²å‰éªŒè¯é…ç½®è¯­æ³•
âœ… å›æ»šå‡†å¤‡ï¼šä¿ç•™é…ç½®æ–‡ä»¶å¤‡ä»½

ç›‘æ§å‘Šè­¦ï¼š
âœ… è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
âœ… åˆ†çº§å‘Šè­¦æœºåˆ¶ï¼ˆä¸¥é‡ç¨‹åº¦ï¼‰
âœ… å‘Šè­¦èšåˆï¼Œé¿å…å‘Šè­¦é£æš´
âœ… å®šæœŸå›é¡¾å’Œè°ƒä¼˜å‘Šè­¦è§„åˆ™
```

**ğŸ› ï¸ æ•…éšœæ’æŸ¥æµç¨‹**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥FilebeatçŠ¶æ€
sudo systemctl status filebeat
sudo filebeat test config

ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ—¥å¿—æ–‡ä»¶æƒé™
ls -la /var/log/apache2/
sudo usermod -a -G adm filebeat

ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æ—¥å¿—æ ¼å¼
tail -f /var/log/apache2/access.log
sudo filebeat test output

ç¬¬å››æ­¥ï¼šæŸ¥çœ‹Filebeatæ—¥å¿—
sudo journalctl -u filebeat -f
tail -f /var/log/filebeat/filebeat.log
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
é‡‡é›†ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®é‡‡é›†é¢‘ç‡
â€¢ ä½¿ç”¨åˆé€‚çš„bufferå¤§å°
â€¢ é¿å…é‡‡é›†ä¸å¿…è¦çš„æ—¥å¿—

å¤„ç†ä¼˜åŒ–ï¼š
â€¢ ç®€åŒ–processoré…ç½®
â€¢ é¿å…å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼
â€¢ ä½¿ç”¨æ¡ä»¶å¤„ç†å‡å°‘æ— æ•ˆæ“ä½œ

ä¼ è¾“ä¼˜åŒ–ï¼š
â€¢ å¯ç”¨å‹ç¼©ä¼ è¾“
â€¢ åˆç†è®¾ç½®batchå¤§å°
â€¢ é…ç½®åˆé€‚çš„è¾“å‡ºbuffer
```

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å­¦ä¹ è·¯å¾„**ï¼š
```
åŸºç¡€é˜¶æ®µï¼š
â–¡ ç†è§£Apacheæ—¥å¿—æ ¼å¼
â–¡ æŒæ¡åŸºæœ¬çš„æ¨¡å—é…ç½®
â–¡ å­¦ä¼šæŸ¥çœ‹å’Œåˆ†ææ—¥å¿—

è¿›é˜¶é˜¶æ®µï¼š
â–¡ è‡ªå®šä¹‰æ ¼å¼é…ç½®
â–¡ æ€§èƒ½å’Œå®‰å…¨ç›‘æ§
â–¡ æ•…éšœæ’æŸ¥æŠ€èƒ½

é«˜çº§é˜¶æ®µï¼š
â–¡ å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–
â–¡ ä¸å…¶ä»–å·¥å…·é›†æˆ
â–¡ è‡ªåŠ¨åŒ–è¿ç»´å®è·µ
```

**ğŸ”§ å®è·µé¡¹ç›®å»ºè®®**ï¼š
```
é¡¹ç›®ä¸€ï¼šåŸºç¡€æ—¥å¿—é‡‡é›†
â€¢ é…ç½®Apacheè®¿é—®å’Œé”™è¯¯æ—¥å¿—é‡‡é›†
â€¢ è®¾ç½®åŸºæœ¬çš„å­—æ®µæ˜ å°„
â€¢ éªŒè¯æ•°æ®åœ¨Elasticsearchä¸­çš„å­˜å‚¨

é¡¹ç›®äºŒï¼šæ€§èƒ½ç›‘æ§ç³»ç»Ÿ
â€¢ é…ç½®å“åº”æ—¶é—´ç›‘æ§
â€¢ è®¾ç½®æ€§èƒ½å‘Šè­¦è§„åˆ™
â€¢ åˆ›å»ºæ€§èƒ½åˆ†æä»ªè¡¨æ¿

é¡¹ç›®ä¸‰ï¼šå®‰å…¨ç›‘æ§ç³»ç»Ÿ
â€¢ é…ç½®æ”»å‡»æ£€æµ‹è§„åˆ™
â€¢ è®¾ç½®å®‰å…¨äº‹ä»¶å‘Šè­¦
â€¢ å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æµç¨‹
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- Apacheæ¨¡å—ä¸“ä¸ºApacheè®¾è®¡ï¼Œæ•ˆç‡é«˜åŠŸèƒ½å…¨
- è®¿é—®æ—¥å¿—çœ‹è¡Œä¸ºï¼Œé”™è¯¯æ—¥å¿—æŸ¥é—®é¢˜
- è™šæ‹Ÿä¸»æœºå„è‡ªç‹¬ç«‹ï¼Œé€šé…ç¬¦æ‰¹é‡å¤„ç†
- SSLæ—¥å¿—å«å®‰å…¨ä¿¡æ¯ï¼Œè‡ªå®šä¹‰æ ¼å¼æ‰©å±•çµæ´»
- æ€§èƒ½å®‰å…¨ç›‘æ§é‡è¦ï¼Œæ•…éšœæ’æŸ¥æœ‰ç« æ³•

**æ ¸å¿ƒç†å¿µ**ï¼šæ—¥å¿—ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯æ´å¯Ÿä¸šåŠ¡è¿è¡ŒçŠ¶å†µçš„çª—å£ã€‚åˆç†é…ç½®Apacheæ¨¡å—ï¼Œèƒ½å¤Ÿå°†åŸå§‹æ—¥å¿—è½¬åŒ–ä¸ºæœ‰ä»·å€¼çš„ä¸šåŠ¡æ´å¯Ÿå’Œè¿ç»´æ”¯æ’‘ï¼