---
title: 22ã€processors-json.ymlé…ç½®
---
## ğŸ“š ç›®å½•

1. [JSONå¤„ç†å™¨åŸºç¡€æ¦‚å¿µ](#1-JSONå¤„ç†å™¨åŸºç¡€æ¦‚å¿µ)
2. [JSONå­—æ®µè§£æé…ç½®](#2-JSONå­—æ®µè§£æé…ç½®)
3. [åµŒå¥—JSONå¤„ç†](#3-åµŒå¥—JSONå¤„ç†)
4. [JSONæ•°ç»„å¤„ç†](#4-JSONæ•°ç»„å¤„ç†)
5. [é”™è¯¯JSONå¤„ç†ç­–ç•¥](#5-é”™è¯¯JSONå¤„ç†ç­–ç•¥)
6. [å­—æ®µæ˜ å°„ä¸è½¬æ¢](#6-å­—æ®µæ˜ å°„ä¸è½¬æ¢)
7. [æ€§èƒ½ä¼˜åŒ–é…ç½®](#7-æ€§èƒ½ä¼˜åŒ–é…ç½®)
8. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#8-å®æˆ˜é…ç½®æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§© JSONå¤„ç†å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JSONå¤„ç†å™¨


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> JSONå¤„ç†å™¨å°±åƒä¸€ä¸ª**æ™ºèƒ½è§£æå™¨**ï¼Œä¸“é—¨ç”¨æ¥åˆ†è§£å’Œå¤„ç†JSONæ ¼å¼çš„æ—¥å¿—æ•°æ®

**é€šä¿—ç†è§£**ï¼š
```
æƒ³è±¡ä½ æ”¶åˆ°ä¸€ä¸ªåŒ…è£¹ï¼š
ğŸ“¦ åŸå§‹åŒ…è£¹ = JSONæ ¼å¼çš„æ—¥å¿—è¡Œ
ğŸ”§ JSONå¤„ç†å™¨ = æ‹†åŒ…å·¥å…·
ğŸ“‹ æ‹†åŒ…ç»“æœ = ç»“æ„åŒ–çš„å­—æ®µæ•°æ®

åŸå§‹æ—¥å¿—ï¼š{"user":"å¼ ä¸‰","action":"ç™»å½•","time":"2025-09-21"}
å¤„ç†åï¼šuser=å¼ ä¸‰, action=ç™»å½•, time=2025-09-21
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦JSONå¤„ç†å™¨


**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- **åŸå§‹JSON**ï¼šä¸€æ•´è¡Œæ–‡æœ¬ï¼Œéš¾ä»¥æœç´¢å’Œåˆ†æ
- **å¤„ç†å**ï¼šç‹¬ç«‹å­—æ®µï¼Œå¯ä»¥ç²¾ç¡®æŸ¥è¯¢å’Œç»Ÿè®¡

```
å®é™…åœºæ™¯å¯¹æ¯”ï¼š

âŒ æ²¡æœ‰JSONå¤„ç†å™¨ï¼š
æœç´¢æ¡ä»¶ï¼šmessage contains "å¼ ä¸‰"
ç»“æœï¼šæ¨¡ç³ŠåŒ¹é…ï¼Œå¯èƒ½è¯¯åŒ¹é…

âœ… ä½¿ç”¨JSONå¤„ç†å™¨ï¼š  
æœç´¢æ¡ä»¶ï¼šuser.keyword = "å¼ ä¸‰"
ç»“æœï¼šç²¾ç¡®åŒ¹é…ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
```

### 1.3 JSONå¤„ç†å™¨çš„å·¥ä½œåŸç†


```
æ•°æ®æµè½¬è¿‡ç¨‹ï¼š

åŸå§‹æ—¥å¿—è¡Œ â†’ JSONè§£æå™¨ â†’ å­—æ®µæå– â†’ ç±»å‹è½¬æ¢ â†’ è¾“å‡ºåˆ°ES
    â†“           â†“          â†“         â†“         â†“
 æ–‡æœ¬æ ¼å¼    JSONå¯¹è±¡    ç‹¬ç«‹å­—æ®µ   æ­£ç¡®ç±»å‹   å¯æœç´¢æ•°æ®
```

---

## 2. ğŸ” JSONå­—æ®µè§£æé…ç½®


### 2.1 åŸºç¡€JSONè§£æé…ç½®


> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> æœ€ç®€å•çš„JSONè§£æï¼Œåªéœ€è¦æŒ‡å®š`decode_json_fields`å¤„ç†å™¨

**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  # JSONæ—¥å¿—é€šå¸¸æ˜¯ä¸€è¡Œä¸€ä¸ªå®Œæ•´JSON
  multiline.pattern: '^{'
  multiline.negate: true
  multiline.match: after

processors:
- decode_json_fields:
    fields: ["message"]        # è¦è§£æçš„å­—æ®µ
    target: ""                 # è§£æç»“æœæ”¾åœ¨æ ¹çº§åˆ«
    overwrite_keys: true       # è¦†ç›–åŒåå­—æ®µ
```

**é…ç½®å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | å«ä¹‰ | æ¨èå€¼ | è¯´æ˜ |
|------|------|--------|------|
| `fields` | éœ€è¦è§£æçš„å­—æ®µå | `["message"]` | é€šå¸¸æ˜¯messageå­—æ®µåŒ…å«JSON |
| `target` | è§£æç»“æœå­˜æ”¾ä½ç½® | `""` | ç©ºå€¼è¡¨ç¤ºæ ¹çº§åˆ« |
| `overwrite_keys` | æ˜¯å¦è¦†ç›–å·²å­˜åœ¨å­—æ®µ | `true` | é¿å…å­—æ®µå†²çª |
| `add_error_key` | è§£æé”™è¯¯æ—¶æ·»åŠ é”™è¯¯ä¿¡æ¯ | `true` | ä¾¿äºæ’æŸ¥é—®é¢˜ |

### 2.2 æŒ‡å®šç›®æ ‡å­—æ®µçš„è§£æ


**åœºæ™¯**ï¼šå°†JSONå†…å®¹è§£æåˆ°æŒ‡å®šçš„å­å­—æ®µä¸­

```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: "json_data"        # è§£æç»“æœæ”¾åœ¨json_dataå­—æ®µä¸‹
    overwrite_keys: false
    add_error_key: true
```

**æ•ˆæœå¯¹æ¯”**ï¼š
```
åŸå§‹æ•°æ®ï¼š
message: '{"user":"å¼ ä¸‰","action":"ç™»å½•"}'

target: "" çš„ç»“æœï¼š
user: "å¼ ä¸‰"
action: "ç™»å½•"

target: "json_data" çš„ç»“æœï¼š
json_data:
  user: "å¼ ä¸‰"  
  action: "ç™»å½•"
```

### 2.3 å¤šå­—æ®µJSONè§£æ


**åœºæ™¯**ï¼šåŒæ—¶è§£æå¤šä¸ªå­—æ®µä¸­çš„JSONæ•°æ®

```yaml
processors:
- decode_json_fields:
    fields: ["message", "extra_data", "metadata"]
    target: ""
    overwrite_keys: true
    add_error_key: true
    max_depth: 10              # æœ€å¤§è§£ææ·±åº¦ï¼Œé˜²æ­¢æ— é™é€’å½’
```

---

## 3. ğŸ—ï¸ åµŒå¥—JSONå¤„ç†


### 3.1 åµŒå¥—JSONçš„æŒ‘æˆ˜


> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> åµŒå¥—JSONå°±åƒ**ä¿„ç½—æ–¯å¥—å¨ƒ**ï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œéœ€è¦é€å±‚è§£æ

**åµŒå¥—JSONç¤ºä¾‹**ï¼š
```json
{
  "user": {
    "profile": {
      "name": "å¼ ä¸‰",
      "age": 25,
      "address": {
        "city": "åŒ—äº¬",
        "district": "æœé˜³åŒº"
      }
    }
  },
  "event": {
    "type": "login",
    "timestamp": "2025-09-21T10:30:00Z"
  }
}
```

### 3.2 åµŒå¥—JSONè§£æé…ç½®


```yaml
processors:
# ç¬¬ä¸€æ­¥ï¼šè§£æä¸»JSON
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true
    add_error_key: true

# ç¬¬äºŒæ­¥ï¼šå±•å¹³åµŒå¥—ç»“æ„ï¼ˆå¯é€‰ï¼‰
- script:
    lang: javascript
    source: >
      function process(event) {
        // å°†user.profile.nameæå–ä¸ºuser_name
        if (event.Get("user.profile.name")) {
          event.Put("user_name", event.Get("user.profile.name"));
        }
        // å°†user.profile.address.cityæå–ä¸ºuser_city
        if (event.Get("user.profile.address.city")) {
          event.Put("user_city", event.Get("user.profile.address.city"));
        }
      }
```

### 3.3 ä½¿ç”¨dot notationè®¿é—®åµŒå¥—å­—æ®µ


> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> Elasticsearchæ”¯æŒç‚¹å·è¡¨ç¤ºæ³•ï¼Œæ— éœ€å±•å¹³ä¹Ÿèƒ½æŸ¥è¯¢åµŒå¥—å­—æ®µ

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```json
# æŸ¥è¯¢ä½åœ¨åŒ—äº¬çš„ç”¨æˆ·
{
  "query": {
    "term": {
      "user.profile.address.city.keyword": "åŒ—äº¬"
    }
  }
}
```

**æ˜ å°„é…ç½®ä¼˜åŒ–**ï¼š
```yaml
# åœ¨index templateä¸­å®šä¹‰åµŒå¥—å¯¹è±¡æ˜ å°„
{
  "mappings": {
    "properties": {
      "user": {
        "properties": {
          "profile": {
            "properties": {
              "address": {
                "properties": {
                  "city": {
                    "type": "keyword"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
```

---

## 4. ğŸ“‹ JSONæ•°ç»„å¤„ç†


### 4.1 JSONæ•°ç»„çš„ç‰¹ç‚¹


> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> JSONæ•°ç»„å°±åƒ**è´­ç‰©æ¸…å•**ï¼ŒåŒ…å«å¤šä¸ªç›¸åŒç±»å‹çš„é¡¹ç›®

**å¸¸è§æ•°ç»„JSON**ï¼š
```json
{
  "user": "å¼ ä¸‰",
  "tags": ["VIP", "è€å®¢æˆ·", "é«˜æ¶ˆè´¹"],
  "orders": [
    {"id": "001", "amount": 100},
    {"id": "002", "amount": 200}
  ],
  "ip_list": ["192.168.1.1", "10.0.0.1"]
}
```

### 4.2 ç®€å•æ•°ç»„å¤„ç†é…ç½®


```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# å¦‚æœéœ€è¦å°†æ•°ç»„å±•å¼€ä¸ºå¤šä¸ªäº‹ä»¶
- script:
    lang: javascript
    source: >
      function process(event) {
        var tags = event.Get("tags");
        if (tags && Array.isArray(tags)) {
          // å°†æ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
          event.Put("tags_string", tags.join(","));
          // æˆ–è€…ä¿æŒæ•°ç»„æ ¼å¼ï¼ˆESä¼šè‡ªåŠ¨å¤„ç†ï¼‰
        }
      }
```

### 4.3 å¤æ‚æ•°ç»„å¯¹è±¡å¤„ç†


**åœºæ™¯**ï¼šå¤„ç†åŒ…å«å¯¹è±¡çš„æ•°ç»„

```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# æå–æ•°ç»„ä¸­çš„ç‰¹å®šå­—æ®µ
- script:
    lang: javascript
    source: >
      function process(event) {
        var orders = event.Get("orders");
        if (orders && Array.isArray(orders)) {
          var totalAmount = 0;
          var orderIds = [];
          
          for (var i = 0; i < orders.length; i++) {
            if (orders[i].amount) {
              totalAmount += orders[i].amount;
            }
            if (orders[i].id) {
              orderIds.push(orders[i].id);
            }
          }
          
          event.Put("total_amount", totalAmount);
          event.Put("order_ids", orderIds);
          event.Put("order_count", orders.length);
        }
      }
```

### 4.4 æ•°ç»„åˆ†å‰²ä¸ºå¤šä¸ªäº‹ä»¶


> ğŸ”¥ **é¢è¯•é‡ç‚¹**  
> æœ‰æ—¶éœ€è¦å°†ä¸€ä¸ªåŒ…å«æ•°ç»„çš„äº‹ä»¶åˆ†å‰²ä¸ºå¤šä¸ªäº‹ä»¶ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ ä¸€ä¸ªäº‹ä»¶

```yaml
# è¿™ç§åœºæ™¯é€šå¸¸åœ¨Logstashä¸­å¤„ç†æ›´æ–¹ä¾¿
# Filebeatä¸­å¯ä»¥è€ƒè™‘ä»¥ä¸‹æ–¹æ¡ˆï¼š

processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var items = event.Get("items");
        if (items && Array.isArray(items) && items.length > 1) {
          // æ ‡è®°ä¸ºéœ€è¦åœ¨Logstashä¸­è¿›ä¸€æ­¥å¤„ç†
          event.Put("needs_split", true);
          event.Put("items_count", items.length);
        }
      }

# ç„¶ååœ¨Logstashä¸­ä½¿ç”¨split filter
# split { field => "items" }
```

---

## 5. ğŸš¨ é”™è¯¯JSONå¤„ç†ç­–ç•¥


### 5.1 å¸¸è§JSONé”™è¯¯ç±»å‹


> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> çœŸå®ç¯å¢ƒä¸­ï¼ŒJSONæ ¼å¼å¯èƒ½ä¸å®Œç¾ï¼Œéœ€è¦å®¹é”™å¤„ç†

**å¸¸è§é”™è¯¯æƒ…å†µ**ï¼š
```
1. æ ¼å¼é”™è¯¯ï¼š{"user":"å¼ ä¸‰",}  # å¤šä½™çš„é€—å·
2. å¼•å·é”™è¯¯ï¼š{'user':'å¼ ä¸‰'}   # å•å¼•å·
3. è½¬ä¹‰é”™è¯¯ï¼š{"msg":"è¯´\"ä½ å¥½\""}
4. æˆªæ–­é”™è¯¯ï¼š{"user":"å¼ ä¸‰     # ä¸å®Œæ•´
5. ç¼–ç é”™è¯¯ï¼šåŒ…å«éUTF-8å­—ç¬¦
```

### 5.2 é”™è¯¯å¤„ç†é…ç½®


```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true
    add_error_key: true        # æ·»åŠ é”™è¯¯ä¿¡æ¯å­—æ®µ
    max_depth: 10              # é™åˆ¶è§£ææ·±åº¦
    
# é”™è¯¯æ—¥å¿—å•ç‹¬å¤„ç†
- if:
    contains:
      json.error: "failed to decode JSON"
  then:
    - add_fields:
        target: ""
        fields:
          log_type: "json_parse_error"
          needs_manual_check: true
    
    # ä¿ç•™åŸå§‹æ¶ˆæ¯ç”¨äºè°ƒè¯•
    - rename:
        fields:
          - from: "message"
            to: "raw_message"
```

### 5.3 éƒ¨åˆ†JSONå¤„ç†


**åœºæ™¯**ï¼šæ—¥å¿—è¡ŒåŒ…å«JSONä½†ä¸æ˜¯çº¯JSONæ ¼å¼

```
ç¤ºä¾‹æ—¥å¿—ï¼š
2025-09-21 10:30:00 INFO: User action: {"user":"å¼ ä¸‰","action":"ç™»å½•"}
```

```yaml
processors:
# å…ˆæå–JSONéƒ¨åˆ†
- script:
    lang: javascript
    source: >
      function process(event) {
        var msg = event.Get("message");
        if (msg) {
          // æ­£åˆ™æå–JSONéƒ¨åˆ†
          var jsonMatch = msg.match(/\{.*\}/);
          if (jsonMatch) {
            event.Put("json_part", jsonMatch[0]);
          }
        }
      }

# å†è§£ææå–çš„JSON
- decode_json_fields:
    fields: ["json_part"]
    target: ""
    overwrite_keys: true
    add_error_key: true

# æ¸…ç†ä¸´æ—¶å­—æ®µ
- drop_fields:
    fields: ["json_part"]
```

### 5.4 JSONä¿®å¤å¤„ç†


```yaml
# å°è¯•ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var msg = event.Get("message");
        if (msg && typeof msg === "string") {
          // ä¿®å¤å•å¼•å·ä¸ºåŒå¼•å·
          msg = msg.replace(/'/g, '"');
          
          // ç§»é™¤æœ«å°¾å¤šä½™çš„é€—å·
          msg = msg.replace(/,(\s*[}\]])/g, '$1');
          
          // ä¿®å¤æœªå¼•ç”¨çš„é”®å
          msg = msg.replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":');
          
          event.Put("message_fixed", msg);
        }
      }

- decode_json_fields:
    fields: ["message_fixed"]
    target: ""
    overwrite_keys: true
    add_error_key: true

- drop_fields:
    fields: ["message_fixed"]
```

---

## 6. ğŸ”„ å­—æ®µæ˜ å°„ä¸è½¬æ¢


### 6.1 å­—æ®µé‡å‘½åé…ç½®


> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> å­—æ®µé‡å‘½åå°±åƒç»™æ–‡ä»¶æ”¹åï¼Œè®©å­—æ®µåæ›´ç¬¦åˆä½ çš„å‘½åè§„èŒƒ

```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# å­—æ®µé‡å‘½å
- rename:
    fields:
      - from: "user"
        to: "username"
      - from: "ts"
        to: "timestamp"
      - from: "lvl"
        to: "log_level"
    ignore_missing: true       # å¿½ç•¥ä¸å­˜åœ¨çš„å­—æ®µ
    fail_on_error: false       # é‡å‘½åå¤±è´¥ä¸ä¸­æ–­å¤„ç†
```

### 6.2 æ•°æ®ç±»å‹è½¬æ¢


**åœºæ™¯**ï¼šJSONä¸­çš„æ•°å­—å¯èƒ½è¢«è§£æä¸ºå­—ç¬¦ä¸²ï¼Œéœ€è¦ç±»å‹è½¬æ¢

```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# æ•°æ®ç±»å‹è½¬æ¢
- convert:
    fields:
      - {from: "user_id", to: "user_id", type: "integer"}
      - {from: "amount", to: "amount", type: "float"}
      - {from: "is_active", to: "is_active", type: "boolean"}
      - {from: "created_at", to: "created_at", type: "long"}
    ignore_missing: true
    fail_on_error: false
```

### 6.3 æ—¶é—´æˆ³å¤„ç†


```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# æ—¶é—´æˆ³è§£æå’Œè½¬æ¢
- timestamp:
    field: timestamp
    layouts:
      - '2006-01-02T15:04:05.999Z'      # RFC3339
      - '2006-01-02 15:04:05'            # å¸¸è§æ ¼å¼
      - 'unix'                           # Unixæ—¶é—´æˆ³
      - 'unix_ms'                        # æ¯«ç§’æ—¶é—´æˆ³
    test:
      - '2025-09-21T10:30:00.123Z'
```

### 6.4 å­—æ®µå€¼æ˜ å°„è½¬æ¢


```yaml
# å°†çŠ¶æ€ç è½¬æ¢ä¸ºå¯è¯»æ–‡æœ¬
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        var statusCode = event.Get("status_code");
        var statusMap = {
          "200": "æˆåŠŸ",
          "404": "æœªæ‰¾åˆ°", 
          "500": "æœåŠ¡å™¨é”™è¯¯"
        };
        
        if (statusCode && statusMap[statusCode]) {
          event.Put("status_text", statusMap[statusCode]);
        }
        
        // æ ¹æ®å“åº”æ—¶é—´è®¾ç½®æ€§èƒ½ç­‰çº§
        var responseTime = event.Get("response_time");
        if (responseTime) {
          if (responseTime < 100) {
            event.Put("performance", "ä¼˜ç§€");
          } else if (responseTime < 500) {
            event.Put("performance", "è‰¯å¥½");
          } else {
            event.Put("performance", "éœ€ä¼˜åŒ–");
          }
        }
      }
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®


### 7.1 è§£ææ€§èƒ½ä¼˜åŒ–


> ğŸ“Š **æ€§èƒ½å¯¹æ¯”**ï¼š
> ```
> åŸºç¡€é…ç½®: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     80% å¤„ç†èƒ½åŠ›
> ä¼˜åŒ–é…ç½®: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% å¤„ç†èƒ½åŠ›
> ```

```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true
    max_depth: 3               # é™åˆ¶è§£ææ·±åº¦ï¼Œæå‡æ€§èƒ½
    add_error_key: false       # ç”Ÿäº§ç¯å¢ƒå¯å…³é—­é”™è¯¯å­—æ®µ
    
# åªä¿ç•™éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®é‡
- include_fields:
    fields: ["@timestamp", "user", "action", "ip", "response_time"]

# åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
- drop_fields:
    fields: ["agent", "ecs", "input", "log"]
```

### 7.2 æ¡ä»¶å¤„ç†ä¼˜åŒ–


```yaml
# åªå¯¹åŒ…å«JSONçš„æ—¥å¿—è¡Œè¿›è¡Œå¤„ç†
processors:
- if:
    regexp:
      message: '^\s*\{'         # ä»¥{å¼€å¤´çš„è¡Œæ‰æ˜¯JSON
  then:
    - decode_json_fields:
        fields: ["message"]
        target: ""
        overwrite_keys: true
  else:
    # éJSONæ—¥å¿—çš„å¤„ç†
    - add_fields:
        target: ""
        fields:
          log_type: "plain_text"
```

### 7.3 æ‰¹é‡å¤„ç†ä¼˜åŒ–


```yaml
# åœ¨filebeat.ymlä¸­è®¾ç½®æ‰¹é‡å‚æ•°
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "app-logs-%{+yyyy.MM.dd}"
  
  # æ‰¹é‡ä¼˜åŒ–è®¾ç½®
  bulk_max_size: 3200          # æ¯æ‰¹æœ€å¤§äº‹ä»¶æ•°
  flush_interval: 1s           # åˆ·æ–°é—´éš”
  worker: 2                    # å·¥ä½œçº¿ç¨‹æ•°
  compression_level: 1         # å‹ç¼©çº§åˆ«
  
  # è¿æ¥æ± ä¼˜åŒ–
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s
```

### 7.4 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


```yaml
# å‡å°‘å†…å­˜å ç”¨
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  scan_frequency: 10s          # é™ä½æ‰«æé¢‘ç‡
  harvester_buffer_size: 16384 # è°ƒæ•´ç¼“å†²åŒºå¤§å°
  max_bytes: 10485760          # é™åˆ¶å•è¡Œå¤§å° (10MB)
  
  # å¤šè¡Œå¤„ç†ä¼˜åŒ–
  multiline.pattern: '^{'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500     # é™åˆ¶å¤šè¡Œæ•°é‡
```

---

## 8. ğŸ¯ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 8.1 Webè®¿é—®æ—¥å¿—JSONå¤„ç†


**æ—¥å¿—æ ¼å¼**ï¼š
```json
{"timestamp":"2025-09-21T10:30:00Z","method":"GET","url":"/api/users","status":200,"response_time":45,"user_agent":"Chrome/91.0","ip":"192.168.1.100","user_id":12345}
```

**å®Œæ•´é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/access.log
  fields:
    service: "web-api"
    environment: "production"

processors:
# JSONè§£æ
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true
    add_error_key: true

# æ—¶é—´æˆ³å¤„ç†
- timestamp:
    field: timestamp
    layouts:
      - '2006-01-02T15:04:05Z'

# å­—æ®µç±»å‹è½¬æ¢
- convert:
    fields:
      - {from: "status", to: "status", type: "integer"}
      - {from: "response_time", to: "response_time", type: "integer"}
      - {from: "user_id", to: "user_id", type: "integer"}

# æ·»åŠ è®¡ç®—å­—æ®µ
- script:
    lang: javascript
    source: >
      function process(event) {
        var status = event.Get("status");
        var responseTime = event.Get("response_time");
        
        // çŠ¶æ€åˆ†ç±»
        if (status >= 200 && status < 300) {
          event.Put("status_category", "success");
        } else if (status >= 400 && status < 500) {
          event.Put("status_category", "client_error");
        } else if (status >= 500) {
          event.Put("status_category", "server_error");
        }
        
        // æ€§èƒ½åˆ†çº§
        if (responseTime < 100) {
          event.Put("performance_level", "fast");
        } else if (responseTime < 1000) {
          event.Put("performance_level", "normal");
        } else {
          event.Put("performance_level", "slow");
        }
      }

# æ¸…ç†ä¸éœ€è¦çš„å­—æ®µ
- drop_fields:
    fields: ["message", "timestamp"]

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "web-access-logs-%{+yyyy.MM.dd}"
```

### 8.2 åº”ç”¨é”™è¯¯æ—¥å¿—JSONå¤„ç†


**æ—¥å¿—æ ¼å¼**ï¼š
```json
{"level":"ERROR","logger":"com.app.Service","message":"Database connection failed","exception":{"class":"SQLException","message":"Connection timeout","stack_trace":"..."}}
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# å¤„ç†åµŒå¥—çš„å¼‚å¸¸ä¿¡æ¯
- script:
    lang: javascript
    source: >
      function process(event) {
        var exception = event.Get("exception");
        if (exception) {
          // æå–å¼‚å¸¸ç±»å‹å’Œæ¶ˆæ¯
          if (exception.class) {
            event.Put("exception_type", exception.class);
          }
          if (exception.message) {
            event.Put("exception_message", exception.message);
          }
          // ç®€åŒ–å †æ ˆä¿¡æ¯ï¼ˆåªä¿ç•™å‰3è¡Œï¼‰
          if (exception.stack_trace) {
            var lines = exception.stack_trace.split('\n');
            event.Put("exception_stack_short", lines.slice(0, 3).join('\n'));
          }
        }
      }

# é”™è¯¯çº§åˆ«æ ‡å‡†åŒ–
- if:
    equals:
      level: "ERROR"
  then:
    - add_fields:
        target: ""
        fields:
          alert_level: "high"
          needs_notification: true

- drop_fields:
    fields: ["exception", "message"]
```

### 8.3 ä¸šåŠ¡å®¡è®¡æ—¥å¿—JSONå¤„ç†


**æ—¥å¿—æ ¼å¼**ï¼š
```json
{"audit_id":"AUD001","user":"admin","action":"DELETE","resource":"user_account","resource_id":"12345","ip":"192.168.1.100","timestamp":"2025-09-21T10:30:00Z","result":"SUCCESS"}
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true

# å®¡è®¡æ—¥å¿—ç‰¹æ®Šå¤„ç†
- script:
    lang: javascript
    source: >
      function process(event) {
        var action = event.Get("action");
        var resource = event.Get("resource");
        
        // é£é™©çº§åˆ«è¯„ä¼°
        var riskActions = ["DELETE", "UPDATE", "ADMIN"];
        var sensitiveResources = ["user_account", "payment", "config"];
        
        var riskScore = 0;
        if (riskActions.includes(action)) riskScore += 5;
        if (sensitiveResources.includes(resource)) riskScore += 3;
        
        if (riskScore >= 8) {
          event.Put("risk_level", "high");
        } else if (riskScore >= 5) {
          event.Put("risk_level", "medium");
        } else {
          event.Put("risk_level", "low");
        }
        
        // ç”Ÿæˆå®¡è®¡æ‘˜è¦
        var summary = event.Get("user") + " " + action + " " + resource;
        event.Put("audit_summary", summary);
      }

# é«˜é£é™©æ“ä½œç‰¹æ®Šæ ‡è®°
- if:
    equals:
      risk_level: "high"
  then:
    - add_fields:
        target: ""
        fields:
          alert_required: true
          compliance_check: true

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "audit-logs-%{+yyyy.MM.dd}"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JSONå¤„ç†å™¨æœ¬è´¨ï¼šå°†JSONæ–‡æœ¬è½¬æ¢ä¸ºç»“æ„åŒ–å­—æ®µçš„å·¥å…·
ğŸ”¸ åŸºç¡€é…ç½®ï¼šdecode_json_fieldså¤„ç†å™¨æ˜¯JSONè§£æçš„æ ¸å¿ƒ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šçœŸå®ç¯å¢ƒä¸­JSONå¯èƒ½ä¸å®Œç¾ï¼Œéœ€è¦å®¹é”™æœºåˆ¶
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé™åˆ¶è§£ææ·±åº¦ã€æ¡ä»¶å¤„ç†ã€æ‰¹é‡ä¼˜åŒ–
ğŸ”¸ å­—æ®µç®¡ç†ï¼šé‡å‘½åã€ç±»å‹è½¬æ¢ã€æ˜ å°„æ˜¯å¸¸è§éœ€æ±‚
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JSONå¤„ç†çš„æ ¸å¿ƒä»·å€¼**
```
æ•°æ®ç»“æ„åŒ–ï¼šä»æ–‡æœ¬å˜ä¸ºå¯æŸ¥è¯¢çš„å­—æ®µ
æŸ¥è¯¢ä¼˜åŒ–ï¼šæ”¯æŒç²¾ç¡®åŒ¹é…å’Œå¤æ‚èšåˆ
å­˜å‚¨æ•ˆç‡ï¼šåˆç†çš„å­—æ®µæ˜ å°„å‡å°‘å­˜å‚¨ç©ºé—´
åˆ†æä¾¿åˆ©ï¼šç»“æ„åŒ–æ•°æ®ä¾¿äºç»Ÿè®¡åˆ†æ
```

**ğŸ”¹ é…ç½®ä¼˜åŒ–ç­–ç•¥**
```
è§£æç­–ç•¥ï¼š
- æ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©è§£ææ·±åº¦
- ä½¿ç”¨æ¡ä»¶å¤„ç†é¿å…æ— æ•ˆè§£æ
- åˆç†è®¾ç½®é”™è¯¯å¤„ç†æœºåˆ¶

æ€§èƒ½ç­–ç•¥ï¼š
- åªä¿ç•™å¿…è¦å­—æ®µï¼Œåˆ é™¤å†—ä½™æ•°æ®
- è®¾ç½®åˆé€‚çš„æ‰¹é‡å¤„ç†å‚æ•°
- ä½¿ç”¨è„šæœ¬å¤„ç†å™¨è¿›è¡Œæ•°æ®è®¡ç®—
```

**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**
```
æ ¼å¼é—®é¢˜ï¼šä½¿ç”¨è„šæœ¬ä¿®å¤å¸¸è§JSONæ ¼å¼é”™è¯¯
åµŒå¥—é—®é¢˜ï¼šåˆç†ä½¿ç”¨dot notationæˆ–å­—æ®µå±•å¹³
æ•°ç»„é—®é¢˜ï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦é€‰æ‹©ä¿æŒæˆ–å±•å¼€
ç±»å‹é—®é¢˜ï¼šä½¿ç”¨convertå¤„ç†å™¨è¿›è¡Œç±»å‹è½¬æ¢
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


âœ… **é€‚ç”¨åœºæ™¯åˆ¤æ–­**ï¼š
- **JSONæ ¼å¼æ—¥å¿—**ï¼šåº”ç”¨æ—¥å¿—ã€APIè°ƒç”¨æ—¥å¿—ã€å®¡è®¡æ—¥å¿—
- **ç»“æ„åŒ–éœ€æ±‚**ï¼šéœ€è¦æŒ‰å­—æ®µæŸ¥è¯¢å’Œç»Ÿè®¡çš„åœºæ™¯
- **æ•°æ®åˆ†æ**ï¼šéœ€è¦å¯¹JSONä¸­çš„æ•°å€¼è¿›è¡Œèšåˆè®¡ç®—
- **ç›‘æ§å‘Šè­¦**ï¼šåŸºäºJSONå­—æ®µå€¼è¿›è¡Œé˜ˆå€¼ç›‘æ§

âŒ **ä¸é€‚ç”¨åœºæ™¯**ï¼š
- **çº¯æ–‡æœ¬æ—¥å¿—**ï¼šéJSONæ ¼å¼çš„æ—¥å¿—
- **äºŒè¿›åˆ¶æ•°æ®**ï¼šå›¾ç‰‡ã€è§†é¢‘ç­‰äºŒè¿›åˆ¶æ–‡ä»¶
- **è¶…å¤§JSON**ï¼šå•æ¡è®°å½•è¶…è¿‡10MBçš„æ•°æ®
- **å®æ—¶è¦æ±‚æé«˜**ï¼šæ¯«ç§’çº§å»¶è¿Ÿè¦æ±‚çš„åœºæ™¯

### 9.4 æœ€ä½³å®è·µå»ºè®®


> ğŸ¢ **ä¼ä¸šåœºæ™¯**ï¼šå¤§å‹ç”µå•†ç½‘ç«™çš„ç”¨æˆ·è¡Œä¸ºæ—¥å¿—åˆ†æ
> ğŸ“± **ç§»åŠ¨åœºæ™¯**ï¼šAPPé”™è¯¯æ—¥å¿—çš„ç»“æ„åŒ–å¤„ç†å’Œç›‘æ§
> ğŸ® **æ¸¸æˆåœºæ™¯**ï¼šæ¸¸æˆå†…äº‹ä»¶æ•°æ®çš„å®æ—¶åˆ†æå’Œç»Ÿè®¡

**é…ç½®å»ºè®®**ï¼š
1. **æµ‹è¯•ä¼˜å…ˆ**ï¼šåœ¨å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•JSONè§£æé…ç½®
2. **ç›‘æ§è§£æ**ï¼šå…³æ³¨è§£æé”™è¯¯ç‡å’Œæ€§èƒ½æŒ‡æ ‡
3. **å­—æ®µè§„åˆ’**ï¼šç»Ÿä¸€å­—æ®µå‘½åè§„èŒƒï¼Œä¾¿äºåç»­åˆ†æ
4. **ç‰ˆæœ¬ç®¡ç†**ï¼šJSONæ ¼å¼å˜æ›´æ—¶åŠæ—¶æ›´æ–°é…ç½®

**æ€§èƒ½å»ºè®®**ï¼š
1. **åˆç†åˆ†å·¥**ï¼šç®€å•è§£æåœ¨Filebeatï¼Œå¤æ‚å¤„ç†åœ¨Logstash
2. **èµ„æºè§„åˆ’**ï¼šæ ¹æ®æ—¥å¿—é‡é…ç½®åˆé€‚çš„ç¡¬ä»¶èµ„æº
3. **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨å­—æ®µåˆ›å»ºåˆé€‚çš„æ˜ å°„å’Œç´¢å¼•
4. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®è§£æå¤±è´¥å’Œæ€§èƒ½å¼‚å¸¸çš„å‘Šè­¦

**æ ¸å¿ƒè®°å¿†**ï¼š
- JSONå¤„ç†å™¨åŒ–è…æœ½ä¸ºç¥å¥‡ï¼Œæ–‡æœ¬æ—¥å¿—å˜ç»“æ„æ•°æ®
- decode_json_fieldsæ˜¯æ ¸å¿ƒï¼Œé…ç½®ç®€å•åŠŸèƒ½å¼ºå¤§
- é”™è¯¯å¤„ç†å¾ˆé‡è¦ï¼ŒçœŸå®ç¯å¢ƒJSONä¸å®Œç¾
- æ€§èƒ½ä¼˜åŒ–éœ€è€ƒè™‘ï¼Œåˆç†é…ç½®æå‡æ•ˆç‡