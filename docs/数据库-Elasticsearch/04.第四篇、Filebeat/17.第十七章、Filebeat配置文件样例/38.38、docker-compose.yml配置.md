---
title: 38、docker-compose.yml配置
---
## 📚 目录

1. [Docker Compose基础概念](#1-docker-compose基础概念)
2. [Filebeat容器编排架构](#2-filebeat容器编排架构)
3. [基础服务配置](#3-基础服务配置)
4. [网络配置详解](#4-网络配置详解)
5. [数据卷挂载配置](#5-数据卷挂载配置)
6. [环境变量与参数设置](#6-环境变量与参数设置)
7. [高级配置特性](#7-高级配置特性)
8. [完整配置实例](#8-完整配置实例)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🐳 Docker Compose基础概念


### 1.1 什么是Docker Compose


> **💡 核心理解**
> Docker Compose就像是一个"乐队指挥"，它能够同时管理多个容器，让它们协调工作

**简单来说：**
- **单容器**：就像一个人独奏，只能做一件事
- **Docker Compose**：就像一个乐队，多个乐手(容器)一起演奏
- **编排**：指挥告诉每个乐手什么时候开始、用什么节奏

```
传统部署方式：
应用程序 ← 手动安装配置
数据库   ← 手动安装配置  
日志收集 ← 手动安装配置

Docker Compose方式：
一个配置文件 → 自动启动所有服务
              → 自动配置网络连接
              → 自动处理依赖关系
```

### 1.2 为什么要用Docker Compose部署Filebeat


**🎯 实际场景：**
假设你要搭建一个完整的日志系统：

```
网站应用(产生日志) → Filebeat(收集) → Elasticsearch(存储) → Kibana(展示)
```

**传统方式的痛点：**
- 需要分别安装4个软件
- 手动配置网络连接
- 服务启动顺序要手动控制
- 配置文件分散在不同地方

**Docker Compose的优势：**
- 一个配置文件管理所有服务
- 自动处理服务间通信
- 一条命令启动整个系统
- 配置集中管理，易于维护

---

## 2. 🏗️ Filebeat容器编排架构


### 2.1 典型的ELK架构


```
┌─────────────────────────────────────────────────────────┐
│                Docker Compose环境                       │
├─────────────────┬─────────────────┬─────────────────────┤
│   Web应用容器    │   Filebeat容器   │   ELK Stack容器      │
│                │                │                     │
│  ┌───────────┐  │  ┌───────────┐  │  ┌───────────────┐  │
│  │  Nginx    │  │  │ Filebeat  │  │  │ Elasticsearch │  │
│  │           │  │  │           │  │  │               │  │
│  │ 产生日志   │──┼─→│ 收集日志   │──┼─→│   存储日志     │  │
│  └───────────┘  │  └───────────┘  │  └───────────────┘  │
│                │                │  ┌───────────────┐  │
│                │                │  │    Kibana     │  │
│                │                │  │   可视化展示   │  │
│                │                │  └───────────────┘  │
└─────────────────┴─────────────────┴─────────────────────┘
```

### 2.2 服务角色说明


| 🏷️ 服务名称 | **作用** | **比喻** |
|------------|---------|---------|
| `web-app` | `产生业务日志` | `工厂生产产品` |
| `filebeat` | `收集转发日志` | `物流快递员` |
| `elasticsearch` | `存储搜索日志` | `大型仓库` |
| `kibana` | `可视化展示` | `数据看板` |

---

## 3. ⚙️ 基础服务配置


### 3.1 最简单的Filebeat服务配置


> **🔧 实践技巧**
> 先从最简单的配置开始，逐步增加复杂功能

```yaml
version: '3.8'

services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: my-filebeat
    user: root
    command: filebeat -e -strict.perms=false
```

**📋 配置解释：**

**`version: '3.8'`**
- 指定Docker Compose文件格式版本
- 就像软件版本号，不同版本支持不同功能

**`services:`**
- 定义所有要运行的服务
- 每个服务就是一个容器

**`image:`**
- 指定要使用的Docker镜像
- 就像选择要安装的软件版本

**`container_name:`**
- 给容器起个名字，方便识别
- 不设置的话会自动生成一个随机名字

**`user: root`**
- 以root用户身份运行容器
- Filebeat需要读取系统日志，需要足够权限

**`command:`**
- 容器启动时执行的命令
- `-e`：输出日志到控制台
- `-strict.perms=false`：忽略文件权限检查

### 3.2 添加基础配置文件


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat
    user: root
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/log:/var/log:ro
    command: filebeat -e -strict.perms=false
```

**💡 新增配置说明：**

**`volumes:`**
- 把宿主机的文件或目录挂载到容器内
- `./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro`
  - 左边：宿主机的配置文件路径
  - 右边：容器内的配置文件路径  
  - `:ro`：只读模式，防止容器修改配置

**`:ro` vs `:rw`**
- `:ro` (read-only)：只能读取，不能修改
- `:rw` (read-write)：可读可写（默认）

---

## 4. 🌐 网络配置详解


### 4.1 默认网络行为


> **💡 核心理解**
> Docker Compose会自动创建一个网络，同一个compose文件中的服务可以通过服务名互相访问

```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat
    user: root
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
    command: filebeat -e -strict.perms=false
```

**自动网络连接：**
```
Filebeat容器内的配置文件可以这样写：
output.elasticsearch:
  hosts: ["elasticsearch:9200"]
        ↑
    直接用服务名，不需要IP地址！
```

### 4.2 自定义网络配置


```yaml
version: '3.8'

networks:
  elk-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    networks:
      elk-network:
        ipv4_address: 172.20.0.10

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    networks:
      elk-network:
        ipv4_address: 172.20.0.20
```

**🔗 相关知识点：**
- **bridge网络**：最常用的网络模式，容器间可以互相通信
- **subnet**：子网段，定义IP地址范围
- **ipv4_address**：给容器分配固定IP

### 4.3 端口映射配置


```yaml
services:
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    # Filebeat通常不需要暴露端口
    # 因为它是主动推送数据，不接收外部连接
```

**📝 端口映射说明：**
- `"5601:5601"`：宿主机端口:容器端口
- 左边5601：外部访问端口
- 右边5601：容器内服务端口

---

## 5. 💾 数据卷挂载配置


### 5.1 日志文件挂载


> **⚠️ 注意事项**
> Filebeat需要读取宿主机的日志文件，所以必须正确配置volume挂载

```yaml
services:
  web-app:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - web-logs:/var/log/nginx

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    volumes:
      # 配置文件挂载
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      
      # 日志文件挂载
      - web-logs:/var/log/nginx:ro
      - /var/log:/host-logs:ro
      
      # Filebeat数据目录
      - filebeat-data:/usr/share/filebeat/data

volumes:
  web-logs:
  filebeat-data:
```

**📊 挂载类型对比：**

| 挂载方式 | **格式** | **用途** | **特点** |
|---------|---------|---------|---------|
| `命名卷` | `volume-name:/path` | `持久化数据` | `Docker管理，数据持久` |
| `绑定挂载` | `./host-path:/container-path` | `配置文件` | `直接映射宿主机路径` |
| `匿名卷` | `/container-path` | `临时数据` | `Docker自动创建` |

### 5.2 配置文件最佳实践


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    volumes:
      # 主配置文件
      - ./config/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      
      # 模块配置目录
      - ./config/modules.d:/usr/share/filebeat/modules.d:ro
      
      # 自定义配置
      - ./config/inputs.d:/usr/share/filebeat/inputs.d:ro
      
      # 日志目录
      - /var/log:/var/log:ro
      - ./app-logs:/app-logs:ro
      
      # 数据持久化
      - filebeat-data:/usr/share/filebeat/data
      - filebeat-logs:/usr/share/filebeat/logs

volumes:
  filebeat-data:
    driver: local
  filebeat-logs:
    driver: local
```

**目录结构建议：**
```
project/
├── docker-compose.yml
├── config/
│   ├── filebeat.yml
│   ├── modules.d/
│   └── inputs.d/
├── app-logs/
└── data/
```

---

## 6. 🔧 环境变量与参数设置


### 6.1 基础环境变量


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat
    user: root
    environment:
      # Elasticsearch连接配置
      - ELASTICSEARCH_HOSTS=elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=changeme
      
      # Kibana连接配置
      - KIBANA_HOST=kibana:5601
      
      # 日志级别
      - LOGGING_LEVEL=info
      
      # 其他配置
      - STRICT_PERMS=false
      - MONITORING_ENABLED=true
```

### 6.2 使用.env文件管理环境变量


**创建 `.env` 文件：**
```bash
# Elasticsearch配置
ES_VERSION=8.11.0
ES_HOST=elasticsearch
ES_PORT=9200
ES_USER=elastic
ES_PASSWORD=your-secure-password

# Kibana配置
KIBANA_PORT=5601

# Filebeat配置
FILEBEAT_LOG_LEVEL=info
```

**在docker-compose.yml中使用：**
```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION}
    environment:
      - ELASTIC_PASSWORD=${ES_PASSWORD}

  filebeat:
    image: docker.elastic.co/beats/filebeat:${ES_VERSION}
    environment:
      - ELASTICSEARCH_HOSTS=${ES_HOST}:${ES_PORT}
      - ELASTICSEARCH_USERNAME=${ES_USER}
      - ELASTICSEARCH_PASSWORD=${ES_PASSWORD}
      - LOGGING_LEVEL=${FILEBEAT_LOG_LEVEL}
```

> **🔧 实践技巧**
> 使用.env文件的好处：敏感信息不会暴露在配置文件中，不同环境可以使用不同的.env文件

### 6.3 动态配置替换


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    environment:
      - ELASTICSEARCH_HOSTS=${ES_HOSTS:-localhost:9200}
      - ELASTICSEARCH_USERNAME=${ES_USERNAME:-elastic}
      - ELASTICSEARCH_PASSWORD=${ES_PASSWORD:-changeme}
    volumes:
      - ./filebeat.yml.template:/usr/share/filebeat/filebeat.yml.template:ro
      - filebeat-data:/usr/share/filebeat/data
    command: >
      bash -c "
        envsubst < /usr/share/filebeat/filebeat.yml.template > /usr/share/filebeat/filebeat.yml &&
        filebeat -e -strict.perms=false
      "
```

**filebeat.yml.template 文件示例：**
```yaml
output.elasticsearch:
  hosts: ["$ELASTICSEARCH_HOSTS"]
  username: "$ELASTICSEARCH_USERNAME"
  password: "$ELASTICSEARCH_PASSWORD"

logging.level: ${LOGGING_LEVEL:-info}
```

---

## 7. 🚀 高级配置特性


### 7.1 健康检查配置


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/log:/var/log:ro
    healthcheck:
      test: ["CMD-SHELL", "filebeat test config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: filebeat -e -strict.perms=false
```

**🔍 健康检查参数说明：**
- **test**：检查命令，用来判断服务是否正常
- **interval**：检查间隔时间
- **timeout**：单次检查超时时间
- **retries**：失败重试次数
- **start_period**：启动等待时间

### 7.2 资源限制配置


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
```

### 7.3 重启策略配置


```yaml
services:
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    restart: unless-stopped
    # 可选值：
    # no: 不自动重启
    # always: 总是重启
    # on-failure: 只在失败时重启
    # unless-stopped: 除非手动停止，否则总是重启
```

### 7.4 依赖关系配置


```yaml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    depends_on:
      - elasticsearch
      
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_started
```

**📋 依赖条件类型：**
- **service_started**：服务启动即可
- **service_healthy**：服务健康检查通过
- **service_completed_successfully**：服务成功完成

---

## 8. 📋 完整配置实例


### 8.1 生产环境完整配置


```yaml
version: '3.8'

networks:
  elk-network:
    driver: bridge

volumes:
  elasticsearch-data:
    driver: local
  filebeat-data:
    driver: local
  filebeat-logs:
    driver: local

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - node.name=elasticsearch
      - cluster.name=elk-cluster
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.security.enabled=true
      - ELASTIC_PASSWORD=your-secure-password
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - elk-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=your-secure-password
    ports:
      - "5601:5601"
    networks:
      - elk-network
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped

  web-app:
    image: nginx:alpine
    container_name: web-app
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - web-logs:/var/log/nginx
    ports:
      - "80:80"
    networks:
      - elk-network
    restart: unless-stopped

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: filebeat
    user: root
    environment:
      - ELASTICSEARCH_HOSTS=elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=your-secure-password
      - KIBANA_HOST=kibana:5601
    volumes:
      # 配置文件
      - ./config/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./config/modules.d:/usr/share/filebeat/modules.d:ro
      
      # 日志文件
      - web-logs:/var/log/nginx:ro
      - /var/log:/host-logs:ro
      
      # 数据持久化
      - filebeat-data:/usr/share/filebeat/data
      - filebeat-logs:/usr/share/filebeat/logs
      
      # Docker socket（如果需要收集容器日志）
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - elk-network
    depends_on:
      elasticsearch:
        condition: service_healthy
      web-app:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "filebeat test config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: filebeat -e -strict.perms=false

volumes:
  web-logs:
    driver: local
```

### 8.2 开发环境简化配置


```yaml
version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    user: root
    volumes:
      - ./filebeat-dev.yml:/usr/share/filebeat/filebeat.yml:ro
      - ./logs:/logs:ro
    depends_on:
      - elasticsearch
    command: filebeat -e -strict.perms=false
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 Docker Compose本质：一个配置文件管理多个容器的工具
🔸 服务编排：让多个容器协调工作，自动处理依赖关系
🔸 网络配置：容器间通过服务名通信，无需关心IP地址
🔸 数据卷挂载：让容器能访问宿主机文件，实现数据持久化
🔸 环境变量：动态配置容器参数，提高配置灵活性
```

### 9.2 关键理解要点


> **💡 核心理解**
> Docker Compose让复杂的多服务部署变得像搭积木一样简单

**🔹 为什么要用Docker Compose部署Filebeat**
```
传统部署痛点：
- 多个软件分别安装配置复杂
- 网络连接配置容易出错
- 服务启动顺序难以控制

Docker Compose优势：
- 一个配置文件管理所有服务
- 自动处理网络和依赖关系
- 一条命令启动整个系统
```

**🔹 配置文件的层次结构**
```
version: 声明文件格式版本
services: 定义所有要运行的服务
  - image: 使用哪个Docker镜像
  - volumes: 挂载哪些文件和目录
  - environment: 设置环境变量
  - depends_on: 依赖哪些服务
networks: 定义网络配置
volumes: 定义数据卷
```

**🔹 最佳实践原则**
```
配置文件管理：
- 敏感信息使用.env文件
- 配置文件统一放在config目录
- 不同环境使用不同的compose文件

数据持久化：
- 重要数据使用命名卷
- 配置文件使用绑定挂载
- 日志文件注意权限设置

网络安全：
- 生产环境启用认证
- 不暴露不必要的端口
- 使用自定义网络隔离服务
```

### 9.3 常用命令操作


**⚡ 快速参考：**
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs filebeat

# 停止所有服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build

# 只启动特定服务
docker-compose up -d filebeat
```

### 9.4 故障排查要点


**❓ 常见疑问：**

**Q：Filebeat连接不上Elasticsearch怎么办？**
**A：** 检查以下几点：
- 确认services在同一个网络中
- 检查depends_on配置是否正确
- 验证environment中的连接地址
- 查看docker-compose logs确认启动顺序

**Q：配置文件修改后不生效？**
**A：** 需要重启容器：
```bash
docker-compose restart filebeat
```

**Q：数据丢失了怎么办？**
**A：** 检查volume配置：
- 确认使用了命名卷而不是匿名卷
- 检查挂载路径是否正确
- 验证容器有足够的读写权限

**🔑 关键记忆要点：**
- Docker Compose = 多容器管理工具
- 服务名 = 容器间通信地址  
- volumes = 数据持久化关键
- depends_on = 启动顺序控制
- environment = 动态配置参数

**核心记忆口诀**：
- 编排容器用Compose，一个文件管全局
- 服务通信靠网络，服务名称做地址
- 数据持久挂载卷，配置灵活环境变量