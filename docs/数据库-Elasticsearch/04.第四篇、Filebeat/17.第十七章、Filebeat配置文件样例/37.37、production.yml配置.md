---
title: 37ã€production.ymlé…ç½®
---
## ðŸ“š ç›®å½•

1. [ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ¦‚è¿°](#1-ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ¦‚è¿°)
2. [å®‰å…¨é…ç½®è¯¦è§£](#2-å®‰å…¨é…ç½®è¯¦è§£)
3. [æ€§èƒ½ä¼˜åŒ–è®¾ç½®](#3-æ€§èƒ½ä¼˜åŒ–è®¾ç½®)
4. [é«˜å¯ç”¨é…ç½®](#4-é«˜å¯ç”¨é…ç½®)
5. [ç›‘æŽ§å‘Šè­¦é…ç½®](#5-ç›‘æŽ§å‘Šè­¦é…ç½®)
6. [å®¹é”™æœºåˆ¶é…ç½®](#6-å®¹é”™æœºåˆ¶é…ç½®)
7. [å®Œæ•´ç”Ÿäº§é…ç½®ç¤ºä¾‹](#7-å®Œæ•´ç”Ÿäº§é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ­ ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç”Ÿäº§çŽ¯å¢ƒé…ç½®


**é€šä¿—ç†è§£**ï¼šç”Ÿäº§çŽ¯å¢ƒå°±åƒæ˜¯æ­£å¼è¥ä¸šçš„é¤åŽ…ï¼Œä¸åŒäºŽæµ‹è¯•çŽ¯å¢ƒçš„"è¯•èœé˜¶æ®µ"

```
å¼€å‘çŽ¯å¢ƒ = åŽ¨å¸ˆåœ¨å®¶ç»ƒæ‰‹    â†’ å¯ä»¥éšä¾¿è¯•é”™
æµ‹è¯•çŽ¯å¢ƒ = é¤åŽ…è¯•è¥ä¸š      â†’ å°èŒƒå›´éªŒè¯  
ç”Ÿäº§çŽ¯å¢ƒ = æ­£å¼å¯¹å¤–è¥ä¸š    â†’ å¿…é¡»ç¨³å®šå¯é 
```

**ç”Ÿäº§çŽ¯å¢ƒçš„ç‰¹ç‚¹**ï¼š
- **é›¶å®¹é”™**ï¼šä»»ä½•æ•…éšœéƒ½å¯èƒ½å½±å“ä¸šåŠ¡
- **é«˜è¦æ±‚**ï¼šæ€§èƒ½ã€å®‰å…¨ã€ç¨³å®šæ€§éƒ½è¦æœ€ä½³
- **ä¸¥ç›‘æŽ§**ï¼šéœ€è¦å…¨æ–¹ä½ç›‘æŽ§å’Œå‘Šè­¦
- **å¯è¿½æº¯**ï¼šæ‰€æœ‰æ“ä½œéƒ½è¦æœ‰æ—¥å¿—è®°å½•

### 1.2 ç”Ÿäº§çŽ¯å¢ƒé…ç½®æ ¸å¿ƒè¦ç´ 


**ðŸ”¸ å®‰å…¨ç¬¬ä¸€**
```
å°±åƒé“¶è¡Œçš„ä¿é™©æŸœï¼š
- å¤šé‡è®¤è¯ï¼šç”¨æˆ·åå¯†ç  + è¯ä¹¦è®¤è¯
- åŠ å¯†ä¼ è¾“ï¼šæ‰€æœ‰æ•°æ®éƒ½åŠ å¯†
- è®¿é—®æŽ§åˆ¶ï¼šåªæœ‰æŽˆæƒç”¨æˆ·æ‰èƒ½æ“ä½œ
- å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰è®¿é—®è¡Œä¸º
```

**ðŸ”¸ æ€§èƒ½ä¼˜åŒ–**
```
å°±åƒé«˜é€Ÿå…¬è·¯ï¼š
- è¶³å¤Ÿå®½åº¦ï¼šæ‰¹å¤„ç†å¤§å°è¦åˆç†
- æµç•…é€šè¡Œï¼šé¿å…é˜»å¡žå’Œå»¶è¿Ÿ
- åˆç†åˆ†æµï¼šå¤šä¸ªè¾“å‡ºåˆ†æ‹…åŽ‹åŠ›
- å®šæœŸç»´æŠ¤ï¼šæ¸…ç†æ— ç”¨æ•°æ®
```

**ðŸ”¸ é«˜å¯ç”¨ä¿éšœ**
```
å°±åƒåŒ»é™¢çš„å¤‡ç”¨ç”µæºï¼š
- å¤šé‡å¤‡ä»½ï¼šå¤šä¸ªElasticsearchèŠ‚ç‚¹
- æ•…éšœåˆ‡æ¢ï¼šä¸»èŠ‚ç‚¹æ•…éšœè‡ªåŠ¨åˆ‡æ¢
- å¥åº·æ£€æŸ¥ï¼šå®šæœŸæ£€æµ‹æœåŠ¡çŠ¶æ€
- å¿«é€Ÿæ¢å¤ï¼šæ•…éšœåŽå¿«é€Ÿæ¢å¤æœåŠ¡
```

---

## 2. ðŸ”’ å®‰å…¨é…ç½®è¯¦è§£


### 2.1 TLSåŠ å¯†é…ç½®


**ä¸ºä»€ä¹ˆéœ€è¦TLSåŠ å¯†ï¼Ÿ**
```
æ²¡æœ‰åŠ å¯† = æ˜Žä¿¡ç‰‡å¯„é€ï¼šä»»ä½•äººéƒ½èƒ½çœ‹åˆ°å†…å®¹
æœ‰äº†åŠ å¯† = å¯†å°ä¿¡ä»¶ï¼šåªæœ‰æ”¶ä»¶äººèƒ½çœ‹åˆ°å†…å®¹

æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯ --[æ˜Žæ–‡æ•°æ®]--> ç½‘ç»œ --[å¯èƒ½è¢«çªƒå–]--> æœåŠ¡ç«¯  âŒ
å®¢æˆ·ç«¯ --[åŠ å¯†æ•°æ®]--> ç½‘ç»œ --[å®‰å…¨ä¼ è¾“]----> æœåŠ¡ç«¯  âœ…
```

**TLSé…ç½®è¦ç‚¹**ï¼š
```yaml
output.elasticsearch:
  hosts: ["https://es-node1:9200", "https://es-node2:9200"]
  
  # SSL/TLS è¯ä¹¦é…ç½®
  ssl:
    # å¯ç”¨SSLéªŒè¯
    verification_mode: "strict"
    
    # CAè¯ä¹¦è·¯å¾„ï¼ˆç”¨äºŽéªŒè¯æœåŠ¡ç«¯è¯ä¹¦ï¼‰
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    
    # å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆåŒå‘è®¤è¯ï¼‰
    certificate: "/etc/filebeat/certs/client.crt"
    certificate_key: "/etc/filebeat/certs/client.key"
    
    # æ”¯æŒçš„TLSç‰ˆæœ¬ï¼ˆåªå…è®¸å®‰å…¨ç‰ˆæœ¬ï¼‰
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
```

### 2.2 ç”¨æˆ·è®¤è¯é…ç½®


**è®¤è¯é…ç½®è¯¦è§£**ï¼š
```yaml
output.elasticsearch:
  # åŸºæœ¬è®¤è¯
  username: "filebeat_user"
  password: "${FILEBEAT_PASSWORD}"  # ä»ŽçŽ¯å¢ƒå˜é‡è¯»å–
  
  # APIå¯†é’¥è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰
  api_key: "${ELASTICSEARCH_API_KEY}"
  
  # äº‘æœåŠ¡è®¤è¯
  cloud.auth: "elastic:${ELASTIC_CLOUD_PASSWORD}"
```

**ðŸ”¸ çŽ¯å¢ƒå˜é‡è®¾ç½®**ï¼š
```bash
# è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆé¿å…å¯†ç å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
export FILEBEAT_PASSWORD="your_secure_password"
export ELASTICSEARCH_API_KEY="your_api_key"
```

### 2.3 è®¿é—®æŽ§åˆ¶é…ç½®


**è§’è‰²æƒé™è®¾ç½®**ï¼š
```
ç”¨æˆ·æƒé™å°±åƒé—¨ç¦å¡ï¼š
- æ™®é€šå‘˜å·¥ï¼šåªèƒ½è¿›åŠžå…¬å®¤
- éƒ¨é—¨ç»ç†ï¼šèƒ½è¿›åŠžå…¬å®¤å’Œä¼šè®®å®¤  
- ç³»ç»Ÿç®¡ç†å‘˜ï¼šèƒ½è¿›æ‰€æœ‰åŒºåŸŸ

Filebeatç”¨æˆ·æƒé™ï¼š
- å†™å…¥æƒé™ï¼šèƒ½å‘ç‰¹å®šç´¢å¼•å†™æ•°æ®
- æ¨¡æ¿æƒé™ï¼šèƒ½åˆ›å»ºå’Œæ›´æ–°ç´¢å¼•æ¨¡æ¿
- ç›‘æŽ§æƒé™ï¼šèƒ½è®¿é—®é›†ç¾¤å¥åº·çŠ¶æ€
```

---

## 3. âš¡ æ€§èƒ½ä¼˜åŒ–è®¾ç½®


### 3.1 æ‰¹å¤„ç†ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯æ‰¹å¤„ç†ï¼Ÿ**
```
å•ä¸ªå¤„ç† = ä¸€æ¬¡åªèƒ½æ¬ä¸€å—ç –    â†’ æ•ˆçŽ‡ä½Ž
æ‰¹é‡å¤„ç† = ä¸€æ¬¡æ¬ä¸€è½¦ç –        â†’ æ•ˆçŽ‡é«˜

æ•°æ®ä¼ è¾“ç±»æ¯”ï¼š
- ä¸€æ¡ä¸€æ¡å‘é€æ—¥å¿— â†’ ç½‘ç»œå¼€é”€å¤§
- æ‰¹é‡å‘é€æ—¥å¿—     â†’ ç½‘ç»œå¼€é”€å°ï¼Œåžåé‡å¤§
```

**æ‰¹å¤„ç†é…ç½®**ï¼š
```yaml
output.elasticsearch:
  # æ‰¹å¤„ç†å¤§å°ï¼ˆä¸€æ¬¡å‘é€å¤šå°‘æ¡æ•°æ®ï¼‰
  bulk_max_size: 3200
  
  # æ‰¹å¤„ç†è¶…æ—¶ï¼ˆå³ä½¿æ²¡å‡‘å¤Ÿæ•°é‡ä¹Ÿè¦å‘é€ï¼‰
  flush_timeout: 10s
  
  # å¹¶å‘è¿žæŽ¥æ•°ï¼ˆåŒæ—¶èƒ½å¼€å‡ ä¸ªé€šé“å‘é€ï¼‰
  worker: 4
  
  # æ¯ä¸ªè¿žæŽ¥çš„æœ€å¤§æ‰¹å¤„ç†æ•°
  max_retries: 3
```

**ðŸŽ¯ å‚æ•°è°ƒä¼˜æŒ‡å—**ï¼š
```
bulk_max_size è°ƒä¼˜ï¼š
- å¤ªå°(100) â†’ ç½‘ç»œå¼€é”€å¤§ï¼Œæ€§èƒ½å·®
- å¤ªå¤§(10000) â†’ å†…å­˜å ç”¨å¤šï¼Œå»¶è¿Ÿé«˜  
- æŽ¨è(1000-5000) â†’ å¹³è¡¡æ€§èƒ½å’Œèµ„æº

worker è°ƒä¼˜ï¼š
- CPUæ ¸æ•° Ã— 2 ä¸ºèµ·ç‚¹
- ç›‘æŽ§CPUä½¿ç”¨çŽ‡è°ƒæ•´
- ç½‘ç»œå¸¦å®½ä¹Ÿè¦è€ƒè™‘
```

### 3.2 å†…å­˜ç®¡ç†é…ç½®


**å†…å­˜ä¼˜åŒ–è®¾ç½®**ï¼š
```yaml
# é˜Ÿåˆ—é…ç½®ï¼ˆå†…å­˜ä¸­æš‚å­˜æ•°æ®ï¼‰
queue.mem:
  events: 8192          # é˜Ÿåˆ—ä¸­æœ€å¤šå­˜æ”¾å¤šå°‘äº‹ä»¶
  flush.min_events: 2048 # è¾¾åˆ°è¿™ä¸ªæ•°é‡å°±åˆ·æ–°
  flush.timeout: 5s      # è¶…æ—¶ä¹Ÿè¦åˆ·æ–°

# æ—¥å¿—è½®è½¬é…ç½®ï¼ˆé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼‰
logging:
  level: info
  to_files: true
  files:
    path: /var/log/filebeat
    name: filebeat.log
    keepfiles: 7        # ä¿ç•™7ä¸ªæ—¥å¿—æ–‡ä»¶
    rotateeverybytes: 10485760  # 10MBè½®è½¬ä¸€æ¬¡
```

### 3.3 ç½‘ç»œä¼˜åŒ–é…ç½®


**ç½‘ç»œè¿žæŽ¥ä¼˜åŒ–**ï¼š
```yaml
output.elasticsearch:
  # è¿žæŽ¥è¶…æ—¶
  timeout: 90s
  
  # HTTPè®¾ç½®
  compression_level: 1    # åŽ‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŽ‹ç¼©çŽ‡ï¼‰
  
  # è¿žæŽ¥æ± è®¾ç½®
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s
```

---

## 4. ðŸ”„ é«˜å¯ç”¨é…ç½®


### 4.1 å¤šèŠ‚ç‚¹é…ç½®


**é«˜å¯ç”¨çš„æ¦‚å¿µ**ï¼š
```
å•ç‚¹æ•…éšœ = åªæœ‰ä¸€æ¡è·¯å›žå®¶ï¼š
è·¯ä¿®äº†å°±å›žä¸äº†å®¶ âŒ

é«˜å¯ç”¨ = æœ‰å¤šæ¡è·¯å›žå®¶ï¼š
ä¸€æ¡è·¯å µäº†æ¢å¦ä¸€æ¡ âœ…

Elasticsearché›†ç¾¤ï¼š
èŠ‚ç‚¹1æŒ‚äº† â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°èŠ‚ç‚¹2
èŠ‚ç‚¹2æŒ‚äº† â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°èŠ‚ç‚¹3
```

**å¤šèŠ‚ç‚¹é…ç½®ç¤ºä¾‹**ï¼š
```yaml
output.elasticsearch:
  # å¤šä¸ªèŠ‚ç‚¹åœ°å€
  hosts: [
    "https://es-master-1:9200",
    "https://es-master-2:9200", 
    "https://es-master-3:9200"
  ]
  
  # è´Ÿè½½å‡è¡¡ç­–ç•¥
  loadbalance: true
  
  # èŠ‚ç‚¹é€‰æ‹©ç­–ç•¥
  worker: 3
```

### 4.2 æ•…éšœè½¬ç§»é…ç½®


**æ•…éšœå¤„ç†æœºåˆ¶**ï¼š
```yaml
output.elasticsearch:
  # é‡è¯•é…ç½®
  max_retries: 5
  backoff.init: 1s      # é¦–æ¬¡é‡è¯•ç­‰å¾…æ—¶é—´
  backoff.max: 300s     # æœ€å¤§é‡è¯•ç­‰å¾…æ—¶é—´
  
  # å¥åº·æ£€æŸ¥
  template.settings:
    index.number_of_replicas: 2  # æ¯ä¸ªåˆ†ç‰‡2ä¸ªå‰¯æœ¬
    
# è¾“å‡ºå¤‡ä»½é…ç½®
output:
  # ä¸»è¾“å‡º
  elasticsearch:
    hosts: ["https://primary-es:9200"]
  
  # å¤‡ç”¨è¾“å‡ºï¼ˆå½“ä¸»è¾“å‡ºå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
  file:
    path: "/var/backup/filebeat"
    filename: "backup-%{+yyyy-MM-dd}.log"
    enabled: false  # é»˜è®¤å…³é—­ï¼Œæ•…éšœæ—¶å¯ç”¨
```

---

## 5. ðŸ“Š ç›‘æŽ§å‘Šè­¦é…ç½®


### 5.1 ç›‘æŽ§æŒ‡æ ‡é…ç½®


**ç›‘æŽ§å°±åƒä½“æ£€**ï¼š
```
å®šæœŸä½“æ£€ï¼š
- æµ‹é‡è¡€åŽ‹ã€å¿ƒçŽ‡ã€ä½“æ¸©
- åŠæ—¶å‘çŽ°å¥åº·é—®é¢˜
- é¢„é˜²ä¸¥é‡ç–¾ç—…

Filebeatç›‘æŽ§ï¼š
- æ£€æŸ¥æ•°æ®å‘é€é‡ã€é”™è¯¯çŽ‡
- åŠæ—¶å‘çŽ°ä¼ è¾“é—®é¢˜  
- é¢„é˜²æ•°æ®ä¸¢å¤±
```

**ç›‘æŽ§é…ç½®è®¾ç½®**ï¼š
```yaml
# å¯ç”¨ç›‘æŽ§
monitoring:
  enabled: true
  
  # ç›‘æŽ§æ•°æ®å‘é€åˆ°ä¸“é—¨çš„ç›‘æŽ§é›†ç¾¤
  elasticsearch:
    hosts: ["https://monitoring-es:9200"]
    username: "monitoring_user"
    password: "${MONITORING_PASSWORD}"
    
  # ç›‘æŽ§æ•°æ®æ”¶é›†é—´éš”
  collection.interval: 10s

# HTTPç›‘æŽ§ç«¯ç‚¹
http:
  enabled: true
  host: "0.0.0.0"
  port: 5066
  
  # ç›‘æŽ§è·¯å¾„
  # http://filebeat-host:5066/stats - æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
  # http://filebeat-host:5066/state - æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
```

### 5.2 æ—¥å¿—å‘Šè­¦é…ç½®


**å‘Šè­¦é…ç½®**ï¼š
```yaml
# è¯¦ç»†æ—¥å¿—é…ç½®
logging:
  level: info
  selectors: ["*"]
  
  # è¾“å‡ºåˆ°æ–‡ä»¶
  to_files: true
  files:
    path: /var/log/filebeat
    name: filebeat.log
    keepfiles: 10
    rotateeverybytes: 100MB
    
  # åŒæ—¶è¾“å‡ºåˆ°syslogï¼ˆä¾¿äºŽé›†ä¸­ç›‘æŽ§ï¼‰
  to_syslog: true
  syslog:
    facility: local0
```

---

## 6. ðŸ›¡ï¸ å®¹é”™æœºåˆ¶é…ç½®


### 6.1 æ•°æ®æŒä¹…åŒ–é…ç½®


**æ•°æ®æŒä¹…åŒ–çš„é‡è¦æ€§**ï¼š
```
æ²¡æœ‰æŒä¹…åŒ– = åœç”µåŽæ‰€æœ‰æ­£åœ¨å¤„ç†çš„æ•°æ®éƒ½ä¸¢å¤± âŒ
æœ‰äº†æŒä¹…åŒ– = é‡å¯åŽèƒ½ä»Žä¸Šæ¬¡ä½ç½®ç»§ç»­å¤„ç†     âœ…

å°±åƒå­˜æ¡£æ¸¸æˆï¼š
- æ²¡å­˜æ¡£ï¼šæ­»äº†é‡æ–°å¼€å§‹
- æœ‰å­˜æ¡£ï¼šæ­»äº†ä»Žå­˜æ¡£ç‚¹ç»§ç»­
```

**æŒä¹…åŒ–é…ç½®**ï¼š
```yaml
# æ³¨å†Œè¡¨é…ç½®ï¼ˆè®°å½•æ–‡ä»¶è¯»å–ä½ç½®ï¼‰
filebeat.registry:
  path: "/var/lib/filebeat/registry"
  file_permissions: 0600
  flush: 1s  # æ¯ç§’åˆ·æ–°ä¸€æ¬¡æ³¨å†Œè¡¨

# é˜Ÿåˆ—æŒä¹…åŒ–
queue.disk:
  path: "/var/lib/filebeat/queue"
  max_size: 10GB
  segment_size: 1GB
  
# æ•°æ®è·¯å¾„æƒé™è®¾ç½®
path.data: "/var/lib/filebeat"
path.logs: "/var/log/filebeat"
```

### 6.2 é”™è¯¯å¤„ç†é…ç½®


**é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š
```yaml
# å¤„ç†å™¨é”™è¯¯å¤„ç†
processors:
  - drop_event:
      when:
        # ä¸¢å¼ƒæ— æ•ˆæ—¥å¿—ï¼ˆé¿å…å‘é€åžƒåœ¾æ•°æ®ï¼‰
        regexp:
          message: "^DEBUG.*"
          
# è¾“å‡ºé”™è¯¯å¤„ç†
output.elasticsearch:
  # æ–‡æ¡£å‘é€å¤±è´¥å¤„ç†
  max_retries: 5
  
  # æ‰¹é‡æ“ä½œå¤±è´¥å¤„ç†
  bulk_max_size: 1000
  
  # ç½‘ç»œé”™è¯¯é‡è¯•
  backoff.init: 1s
  backoff.max: 60s
```

---

## 7. ðŸ“ å®Œæ•´ç”Ÿäº§é…ç½®ç¤ºä¾‹


### 7.1 å®Œæ•´é…ç½®æ–‡ä»¶


```yaml
##################### Filebeat ç”Ÿäº§çŽ¯å¢ƒé…ç½® ######################


#============================== åŸºç¡€é…ç½® ==============================
name: "filebeat-prod-${hostname}"
tags: ["production", "web-logs", "app-logs"]

#============================== è¾“å…¥é…ç½® ==============================
filebeat.inputs:
# WebæœåŠ¡å™¨æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
    - /var/log/nginx/error.log
  fields:
    service: "nginx"
    environment: "production"
  fields_under_root: true
  
  # å¤šè¡Œæ—¥å¿—å¤„ç†
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500

# åº”ç”¨ç¨‹åºæ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/app/*.log
  fields:
    service: "application"
    environment: "production"
  fields_under_root: true
  
  # æ—¥å¿—è§£æž
  json.keys_under_root: true
  json.add_error_key: true

#============================== å¤„ç†å™¨é…ç½® ==============================
processors:
# æ·»åŠ ä¸»æœºä¿¡æ¯
- add_host_metadata:
    when.not.contains.tags: "forwarded"
    
# æ·»åŠ è¿›ç¨‹ä¿¡æ¯  
- add_process_metadata:
    match_pids: ["process.pid", "process.parent.pid"]
    
# æ•°æ®æ¸…ç†
- drop_fields:
    fields: ["agent.ephemeral_id", "ecs.version", "input.type"]
    
# æ•æ„Ÿä¿¡æ¯è„±æ•
- dissect:
    tokenizer: "%{key}=%{value}"
    field: "message"
    target_prefix: "dissect"
    when:
      contains:
        message: "password"
        
#============================== è¾“å‡ºé…ç½® ==============================
output.elasticsearch:
  # é›†ç¾¤åœ°å€
  hosts: [
    "https://es-prod-1.company.com:9200",
    "https://es-prod-2.company.com:9200", 
    "https://es-prod-3.company.com:9200"
  ]
  
  # è®¤è¯é…ç½®
  username: "filebeat_prod"
  password: "${ELASTICSEARCH_PASSWORD}"
  
  # SSLé…ç½®
  ssl:
    verification_mode: "strict"
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    certificate: "/etc/filebeat/certs/client.crt"
    certificate_key: "/etc/filebeat/certs/client.key"
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
  
  # æ€§èƒ½ä¼˜åŒ–
  bulk_max_size: 3200
  flush_timeout: 10s
  worker: 4
  compression_level: 1
  
  # å®¹é”™é…ç½®
  max_retries: 5
  backoff.init: 1s
  backoff.max: 300s
  timeout: 90s
  
  # ç´¢å¼•é…ç½®
  index: "filebeat-prod-%{[fields.service]:unknown}-%{+yyyy.MM.dd}"
  
  # ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†
  ilm:
    enabled: true
    rollover_alias: "filebeat-prod"
    pattern: "{now/d}-000001"
    policy: "filebeat-prod-policy"

#============================== ç´¢å¼•æ¨¡æ¿é…ç½® ==============================
setup.template:
  enabled: true
  name: "filebeat-prod"
  pattern: "filebeat-prod-*"
  settings:
    index:
      number_of_shards: 3
      number_of_replicas: 2
      codec: "best_compression"
      refresh_interval: "30s"
      
    # æ€§èƒ½ä¼˜åŒ–è®¾ç½®  
    index.mapping.total_fields.limit: 2000
    index.max_result_window: 50000

#============================== é˜Ÿåˆ—é…ç½® ==============================
queue.mem:
  events: 8192
  flush.min_events: 2048  
  flush.timeout: 5s

#============================== ç›‘æŽ§é…ç½® ==============================
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["https://monitoring-es.company.com:9200"]
    username: "monitoring_user"
    password: "${MONITORING_PASSWORD}"
    ssl:
      verification_mode: "strict"
      certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
  
# HTTPç›‘æŽ§ç«¯ç‚¹
http:
  enabled: true
  host: "0.0.0.0"
  port: 5066

#============================== æ—¥å¿—é…ç½® ==============================
logging:
  level: info
  to_files: true
  files:
    path: /var/log/filebeat
    name: filebeat.log
    keepfiles: 7
    rotateeverybytes: 100MB
    permissions: 0644
  
  # è¾“å‡ºåˆ°syslog
  to_syslog: true
  syslog:
    facility: local0

#============================== è·¯å¾„é…ç½® ==============================
path.data: "/var/lib/filebeat"
path.logs: "/var/log/filebeat"
path.home: "/usr/share/filebeat"
path.config: "/etc/filebeat"

#============================== æ³¨å†Œè¡¨é…ç½® ==============================
filebeat.registry:
  path: "/var/lib/filebeat/registry"
  file_permissions: 0600
  flush: 1s

#============================== å®‰å…¨é…ç½® ==============================
# è¿›ç¨‹æ ‡è¯†
name: "filebeat-${hostname}"
tags: ["production", "secure"]

# å…³é—­ä¸å¿…è¦çš„åŠŸèƒ½
setup.dashboards.enabled: false
setup.kibana.host: ""  # ç”Ÿäº§çŽ¯å¢ƒä¸ç›´è¿žKibana
```

### 7.2 çŽ¯å¢ƒå˜é‡é…ç½®


**å®‰å…¨çš„çŽ¯å¢ƒå˜é‡è®¾ç½®**ï¼š
```bash
#!/bin/bash
# /etc/filebeat/filebeat-env.sh

# Elasticsearchè®¤è¯
export ELASTICSEARCH_PASSWORD="your_secure_es_password"
export MONITORING_PASSWORD="your_monitoring_password"

# SSLè¯ä¹¦è·¯å¾„
export FILEBEAT_CERT_PATH="/etc/filebeat/certs"

# è®¾ç½®æ–‡ä»¶æƒé™ï¼ˆåªæœ‰filebeatç”¨æˆ·èƒ½è¯»å–ï¼‰
chmod 600 /etc/filebeat/filebeat-env.sh
chown filebeat:filebeat /etc/filebeat/filebeat-env.sh
```

### 7.3 ç³»ç»ŸæœåŠ¡é…ç½®


**systemdæœåŠ¡æ–‡ä»¶**ï¼š
```ini
# /etc/systemd/system/filebeat.service
[Unit]
Description=Filebeat Log Shipper
Documentation=https://www.elastic.co/beats/filebeat
Wants=network-online.target
After=network-online.target

[Service]
Type=notify
Environment="GOMAXPROCS=4"
EnvironmentFile=/etc/filebeat/filebeat-env.sh
User=filebeat
Group=filebeat
ExecStart=/usr/share/filebeat/bin/filebeat -c /etc/filebeat/filebeat.yml
Restart=always
RestartSec=5s
StartLimitInterval=60s
StartLimitBurst=3

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/filebeat /var/log/filebeat

[Install]
WantedBy=multi-user.target
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„é…ç½®è¦ç‚¹


```
ðŸ”¸ å®‰å…¨é…ç½®ï¼šTLSåŠ å¯†ã€ç”¨æˆ·è®¤è¯ã€è®¿é—®æŽ§åˆ¶æ˜¯åŸºç¡€
ðŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹å¤„ç†å¤§å°ã€å¹¶å‘æ•°ã€å†…å­˜ç®¡ç†è¦è°ƒä¼˜  
ðŸ”¸ é«˜å¯ç”¨æ€§ï¼šå¤šèŠ‚ç‚¹éƒ¨ç½²ã€æ•…éšœè½¬ç§»ã€è´Ÿè½½å‡è¡¡å¿…ä¸å¯å°‘
ðŸ”¸ ç›‘æŽ§å‘Šè­¦ï¼šå®žæ—¶ç›‘æŽ§ã€æ—¥å¿—è®°å½•ã€å‘Šè­¦é€šçŸ¥è¦å®Œå–„
ðŸ”¸ å®¹é”™æœºåˆ¶ï¼šæ•°æ®æŒä¹…åŒ–ã€é”™è¯¯é‡è¯•ã€å¤‡ä»½ç­–ç•¥è¦å¥å…¨
```

### 8.2 ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ


**ðŸ”¹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•**
```
âœ… è¯ä¹¦æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡®ï¼ˆ600æˆ–400ï¼‰
âœ… æ•æ„Ÿä¿¡æ¯ä½¿ç”¨çŽ¯å¢ƒå˜é‡å­˜å‚¨
âœ… ç´¢å¼•æ¨¡æ¿å’Œç”Ÿå‘½å‘¨æœŸç­–ç•¥å·²é…ç½®
âœ… ç›‘æŽ§å’Œæ—¥å¿—æ”¶é›†å·²å¯ç”¨
âœ… å¤‡ä»½å’Œæ¢å¤æµç¨‹å·²éªŒè¯
âœ… æ•…éšœåˆ‡æ¢æœºåˆ¶å·²æµ‹è¯•
```

**ðŸ”¹ è¿ç»´ç›‘æŽ§è¦ç‚¹**
```
ðŸ“Š å…³é”®æŒ‡æ ‡ç›‘æŽ§ï¼š
- æ•°æ®å‘é€é€ŸçŽ‡å’Œå»¶è¿Ÿ
- é”™è¯¯çŽ‡å’Œé‡è¯•æ¬¡æ•°
- å†…å­˜å’ŒCPUä½¿ç”¨çŽ‡
- ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ

âš ï¸ å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
- é”™è¯¯çŽ‡ > 1% å‘Šè­¦
- å»¶è¿Ÿ > 30ç§’å‘Šè­¦  
- ç£ç›˜ä½¿ç”¨ > 80% å‘Šè­¦
- æœåŠ¡ä¸å¯ç”¨ç«‹å³å‘Šè­¦
```

**ðŸ”¹ å®‰å…¨åŠ å›ºå»ºè®®**
```
ðŸ”’ ç½‘ç»œå®‰å…¨ï¼š
- ä½¿ç”¨VPNæˆ–ä¸“çº¿è¿žæŽ¥
- é™åˆ¶è®¿é—®æ¥æºIP
- å®šæœŸæ›´æ–°SSLè¯ä¹¦

ðŸ”’ ç³»ç»Ÿå®‰å…¨ï¼š
- ä½¿ç”¨ä¸“ç”¨ç”¨æˆ·è¿è¡ŒæœåŠ¡
- é™åˆ¶æ–‡ä»¶ç³»ç»Ÿè®¿é—®æƒé™
- å®šæœŸå®‰å…¨æ‰«æå’Œæ›´æ–°
```

### 8.3 æ•…éšœæŽ’æŸ¥æŒ‡å—


**å¸¸è§é—®é¢˜å¿«é€Ÿè¯Šæ–­**ï¼š

| é—®é¢˜çŽ°è±¡ | å¯èƒ½åŽŸå›  | è§£å†³æ–¹æ³• |
|---------|---------|---------|
| **æ•°æ®å‘é€ç¼“æ…¢** | æ‰¹å¤„ç†é…ç½®ä¸å½“ | è°ƒæ•´`bulk_max_size`å’Œ`worker`æ•°é‡ |
| **è¿žæŽ¥å¤±è´¥** | SSLè¯ä¹¦é—®é¢˜ | æ£€æŸ¥è¯ä¹¦è·¯å¾„å’Œæƒé™ |
| **å†…å­˜å ç”¨é«˜** | é˜Ÿåˆ—é…ç½®è¿‡å¤§ | å‡å°‘`queue.mem.events`æ•°é‡ |
| **æ—¥å¿—ä¸¢å¤±** | æ³¨å†Œè¡¨æŸå | æ¸…ç†å¹¶é‡å»ºæ³¨å†Œè¡¨æ–‡ä»¶ |

**ðŸŽ¯ è®°å¿†è¦ç‚¹**
- ç”Ÿäº§çŽ¯å¢ƒé…ç½®è¦**å®‰å…¨ç¬¬ä¸€ã€æ€§èƒ½å¹¶é‡ã€ç›‘æŽ§å®Œå–„**
- æ‰€æœ‰æ•æ„Ÿä¿¡æ¯éƒ½è¦ç”¨**çŽ¯å¢ƒå˜é‡**å­˜å‚¨
- å¤šèŠ‚ç‚¹éƒ¨ç½²å®žçŽ°**é«˜å¯ç”¨**ï¼Œå®šæœŸæ¼”ç»ƒ**æ•…éšœåˆ‡æ¢**
- å®Œå–„çš„**ç›‘æŽ§å‘Šè­¦**æ˜¯è¿ç»´çš„çœ¼ç›ï¼Œä¸èƒ½ç¼ºå¤±

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> å®‰å…¨è®¤è¯SSLï¼Œæ€§èƒ½æ‰¹å¤„ç†
> é«˜å¯ç”¨å¤šèŠ‚ç‚¹ï¼Œç›‘æŽ§å‘Šè­¦å…¨
> å®¹é”™æœ‰å¤‡ä»½ï¼Œç”Ÿäº§ç¨³å¦‚å±±