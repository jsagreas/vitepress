---
title: 6ã€container-input.ymlå®¹å™¨æ—¥å¿—é…ç½®
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ](#1-å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ)
2. [Dockerå®¹å™¨æ—¥å¿—é…ç½®](#2-Dockerå®¹å™¨æ—¥å¿—é…ç½®)
3. [Kuberneteså®¹å™¨æ—¥å¿—é…ç½®](#3-Kuberneteså®¹å™¨æ—¥å¿—é…ç½®)
4. [å®¹å™¨è¿‡æ»¤ä¸å…ƒæ•°æ®](#4-å®¹å™¨è¿‡æ»¤ä¸å…ƒæ•°æ®)
5. [JSONæ—¥å¿—è§£æé…ç½®](#5-JSONæ—¥å¿—è§£æé…ç½®)
6. [å¤šå®¹å™¨ç¯å¢ƒé…ç½®](#6-å¤šå®¹å™¨ç¯å¢ƒé…ç½®)
7. [å®æˆ˜é…ç½®ç¤ºä¾‹](#7-å®æˆ˜é…ç½®ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ—¥å¿—æ”¶é›†


**ğŸ’¡ ç®€å•ç†è§£**ï¼šå°±åƒå¿«é€’å‘˜è¦æ”¶é›†å„ä¸ªå°åŒºçš„åŒ…è£¹ä¸€æ ·ï¼ŒFilebeatè¦æ”¶é›†å„ä¸ªå®¹å™¨äº§ç”Ÿçš„æ—¥å¿—æ–‡ä»¶ã€‚

```
ä¼ ç»ŸæœåŠ¡å™¨æ—¥å¿—æ”¶é›†ï¼š
æœåŠ¡å™¨ â†’ å›ºå®šè·¯å¾„æ—¥å¿—æ–‡ä»¶ â†’ Filebeatè¯»å–

å®¹å™¨æ—¥å¿—æ”¶é›†ï¼š
å®¹å™¨1 â†’ æ—¥å¿—è¾“å‡º â†’ Docker/K8sç®¡ç† â†’ Filebeatæ”¶é›†
å®¹å™¨2 â†’ æ—¥å¿—è¾“å‡º â†’ Docker/K8sç®¡ç† â†’ Filebeatæ”¶é›†
å®¹å™¨3 â†’ æ—¥å¿—è¾“å‡º â†’ Docker/K8sç®¡ç† â†’ Filebeatæ”¶é›†
```

### 1.2 å®¹å™¨æ—¥å¿—çš„ç‰¹æ®Šæ€§


**ğŸ”¸ ä¸ä¼ ç»Ÿæ—¥å¿—çš„åŒºåˆ«**ï¼š
- **åŠ¨æ€æ€§**ï¼šå®¹å™¨éšæ—¶åˆ›å»ºå’Œé”€æ¯ï¼Œæ—¥å¿—ä½ç½®ä¼šå˜åŒ–
- **ä¸´æ—¶æ€§**ï¼šå®¹å™¨é‡å¯åæ—¥å¿—å¯èƒ½ä¸¢å¤±
- **æ ‡å‡†åŒ–**ï¼šå®¹å™¨é€šå¸¸ä½¿ç”¨æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯
- **å…ƒæ•°æ®ä¸°å¯Œ**ï¼šåŒ…å«å®¹å™¨åã€é•œåƒã€æ ‡ç­¾ç­‰ä¿¡æ¯

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨é…ç½®**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
- å®¹å™¨Aè¿è¡Œnginxï¼Œè¾“å‡ºè®¿é—®æ—¥å¿—
- å®¹å™¨Bè¿è¡Œåº”ç”¨ï¼Œè¾“å‡ºä¸šåŠ¡æ—¥å¿—  
- å®¹å™¨Cè¿è¡Œæ•°æ®åº“ï¼Œè¾“å‡ºé”™è¯¯æ—¥å¿—

å¦‚æœç”¨ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦åˆ†åˆ«é…ç½®3ä¸ªä¸åŒçš„è·¯å¾„
å¦‚æœç”¨å®¹å™¨æ–¹å¼ï¼šä¸€ä¸ªé…ç½®è‡ªåŠ¨å‘ç°æ‰€æœ‰å®¹å™¨æ—¥å¿—
```

### 1.3 å®¹å™¨æ—¥å¿—å­˜å‚¨ä½ç½®


**ğŸ“‚ Dockerç¯å¢ƒä¸‹çš„æ—¥å¿—ä½ç½®**ï¼š
```
Linuxç³»ç»Ÿï¼š
/var/lib/docker/containers/[å®¹å™¨ID]/[å®¹å™¨ID]-json.log

Windowsç³»ç»Ÿï¼š
C:\ProgramData\docker\containers\[å®¹å™¨ID]\[å®¹å™¨ID]-json.log

ç¤ºä¾‹è·¯å¾„ï¼š
/var/lib/docker/containers/
â”œâ”€â”€ abc123.../abc123...-json.log  â† nginxå®¹å™¨æ—¥å¿—
â”œâ”€â”€ def456.../def456...-json.log  â† appå®¹å™¨æ—¥å¿—
â””â”€â”€ ghi789.../ghi789...-json.log  â† dbå®¹å™¨æ—¥å¿—
```

---

## 2. ğŸ‹ Dockerå®¹å™¨æ—¥å¿—é…ç½®


### 2.1 åŸºç¡€Dockerå®¹å™¨é…ç½®


**ğŸ”§ æœ€ç®€å•çš„Dockeræ—¥å¿—æ”¶é›†é…ç½®**ï¼š

```yaml
# filebeat.yml - DockeråŸºç¡€é…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # åŸºç¡€è®¾ç½®
  enabled: true
  
  # å®¹å™¨IDè§£æ
  stream: all  # æ”¶é›†stdoutå’Œstderr
  
output.elasticsearch:
  hosts: ["localhost:9200"]
```

**ğŸ’¡ é…ç½®è¯´æ˜**ï¼š
- `type: container`ï¼šå‘Šè¯‰Filebeatè¿™æ˜¯å®¹å™¨ç±»å‹çš„è¾“å…¥
- `paths`ï¼šæŒ‡å®šDockerå®¹å™¨æ—¥å¿—çš„å­˜å‚¨è·¯å¾„
- `stream: all`ï¼šæ”¶é›†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ä¸¤ç§æ—¥å¿—æµ

### 2.2 Dockerå®¹å™¨è¿‡æ»¤é…ç½®


**ğŸ¯ æŒ‰å®¹å™¨åç§°è¿‡æ»¤**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # åªæ”¶é›†ç‰¹å®šå®¹å™¨çš„æ—¥å¿—
  containers.ids:
    - "nginx-*"        # æ”¶é›†nginxå¼€å¤´çš„å®¹å™¨
    - "app-*"          # æ”¶é›†appå¼€å¤´çš„å®¹å™¨
  
  # æ’é™¤æŸäº›å®¹å™¨
  exclude_lines: 
    - '^DEBUG'         # æ’é™¤DEBUGçº§åˆ«æ—¥å¿—
    - 'health-check'   # æ’é™¤å¥åº·æ£€æŸ¥æ—¥å¿—
```

**ğŸ” æŒ‰å®¹å™¨é•œåƒè¿‡æ»¤**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # æŒ‰é•œåƒåç§°è¿‡æ»¤
  condition: |
    equals:
      docker.container.image: "nginx:latest"
  
  # æˆ–è€…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼
  condition: |
    regexp:
      docker.container.image: "^nginx.*"
```

### 2.3 Dockerå…ƒæ•°æ®å¢å¼º


**ğŸ“‹ æ·»åŠ å®¹å™¨å…ƒæ•°æ®**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
  fields:
    env: production
    service_type: web
  fields_under_root: true
  
  # å¯ç”¨Dockerå…ƒæ•°æ®
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      match_fields: ["container.id"]
      # æ·»åŠ å®¹å™¨æ ‡ç­¾ã€ç¯å¢ƒå˜é‡ç­‰ä¿¡æ¯
```

**ğŸ·ï¸ è·å–çš„å…ƒæ•°æ®ç¤ºä¾‹**ï¼š
```json
{
  "docker": {
    "container": {
      "id": "abc123...",
      "name": "nginx-web",
      "image": "nginx:latest",
      "labels": {
        "com.docker.compose.service": "web",
        "environment": "production"
      }
    }
  }
}
```

---

## 3. â˜¸ï¸ Kuberneteså®¹å™¨æ—¥å¿—é…ç½®


### 3.1 Kubernetesæ—¥å¿—æ”¶é›†åŸºç¡€


**ğŸ¯ K8sç¯å¢ƒçš„ç‰¹æ®Šæ€§**ï¼š
```
Kubernetesæ—¥å¿—è·¯å¾„æ›´å¤æ‚ï¼š
/var/log/pods/[namespace]_[pod-name]_[pod-id]/[container]/[restart-count].log

ç¤ºä¾‹ï¼š
/var/log/pods/
â”œâ”€â”€ default_nginx-pod_abc123/
â”‚   â””â”€â”€ nginx/
â”‚       â””â”€â”€ 0.log
â”œâ”€â”€ kube-system_kube-proxy_def456/
â”‚   â””â”€â”€ kube-proxy/
â”‚       â””â”€â”€ 0.log
â””â”€â”€ production_app-pod_ghi789/
    â””â”€â”€ app/
        â””â”€â”€ 2.log  â† è¿™ä¸ªå®¹å™¨é‡å¯è¿‡2æ¬¡
```

### 3.2 K8såŸºç¡€é…ç½®


**ğŸ”§ æ ‡å‡†Kubernetesé…ç½®**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - /var/log/pods/*/*/*.log
  
  # K8sç‰¹æœ‰é…ç½®
  parsers:
  - container:
      stream: all
      format: auto  # è‡ªåŠ¨æ£€æµ‹æ—¥å¿—æ ¼å¼
  
  # å¯ç”¨Kuberneteså…ƒæ•°æ®
  processors:
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      matchers:
      - logs_path:
          logs_path: "/var/log/pods/"
          namespace_name_format: '%{[kubernetes.namespace]}'
          pod_name_format: '%{[kubernetes.pod.name]}'
          container_name_format: '%{[kubernetes.container.name]}'
```

### 3.3 K8så‘½åç©ºé—´è¿‡æ»¤


**ğŸ¢ æŒ‰å‘½åç©ºé—´æ”¶é›†æ—¥å¿—**ï¼š

```yaml
filebeat.inputs:
# ç”Ÿäº§ç¯å¢ƒåº”ç”¨æ—¥å¿—
- type: container
  paths:
    - /var/log/pods/production_*/*/*.log
  fields:
    environment: production
    log_type: application
  
# æµ‹è¯•ç¯å¢ƒåº”ç”¨æ—¥å¿—  
- type: container
  paths:
    - /var/log/pods/testing_*/*/*.log
  fields:
    environment: testing
    log_type: application
    
# æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´
- type: container
  paths:
    - /var/log/pods/*/*/*.log
  exclude_files:
    - '/var/log/pods/kube-system_.*'
    - '/var/log/pods/kube-public_.*'
```

### 3.4 K8sæ ‡ç­¾å’Œæ³¨è§£è¿‡æ»¤


**ğŸ·ï¸ åŸºäºPodæ ‡ç­¾è¿‡æ»¤**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - /var/log/pods/*/*/*.log
  
  processors:
  - add_kubernetes_metadata:
      host: ${NODE_NAME}
      
  # åªå¤„ç†ç‰¹å®šæ ‡ç­¾çš„Pod
  - drop_event:
      when:
        not:
          equals:
            kubernetes.labels.app: "my-application"
            
  # æˆ–è€…æ’é™¤æŸäº›æ ‡ç­¾çš„Pod            
  - drop_event:
      when:
        equals:
          kubernetes.labels.exclude_logs: "true"
```

---

## 4. ğŸ” å®¹å™¨è¿‡æ»¤ä¸å…ƒæ•°æ®


### 4.1 é«˜çº§è¿‡æ»¤è§„åˆ™


**âš¡ å¤šæ¡ä»¶ç»„åˆè¿‡æ»¤**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # å¤æ‚è¿‡æ»¤æ¡ä»¶
  processors:
  - drop_event:
      when:
        or:
          # æ’é™¤å¥åº·æ£€æŸ¥æ—¥å¿—
          - contains:
              message: "health-check"
          # æ’é™¤DEBUGçº§åˆ«
          - regexp:
              message: "^DEBUG"
          # æ’é™¤ç‰¹å®šå®¹å™¨
          - equals:
              container.name: "log-shipper"
```

**ğŸ¨ æŒ‰æ—¥å¿—çº§åˆ«åˆ†ç±»**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  # æ·»åŠ æ—¥å¿—çº§åˆ«å­—æ®µ
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message.includes("ERROR")) {
            event.Put("log.level", "error");
          } else if (message.includes("WARN")) {
            event.Put("log.level", "warning");  
          } else if (message.includes("INFO")) {
            event.Put("log.level", "info");
          } else {
            event.Put("log.level", "debug");
          }
        }
```

### 4.2 å®¹å™¨ç”Ÿå‘½å‘¨æœŸå¤„ç†


**ğŸ”„ å¤„ç†å®¹å™¨é‡å¯**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # å®¹å™¨é‡å¯æ—¶çš„å¤„ç†
  close_inactive: 5m    # 5åˆ†é’Ÿä¸æ´»è·ƒå°±å…³é—­æ–‡ä»¶å¥æŸ„
  clean_inactive: 24h   # 24å°æ—¶åæ¸…ç†ä¸æ´»è·ƒçš„é‡‡é›†å™¨
  ignore_older: 72h     # å¿½ç•¥72å°æ—¶å‰çš„æ—¥å¿—
  
  # å¤„ç†å®¹å™¨åˆ é™¤
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      # å³ä½¿å®¹å™¨è¢«åˆ é™¤ä¹Ÿä¿ç•™å…ƒæ•°æ®
      cache_ttl: 2m
```

**ğŸ“Š å®¹å™¨çŠ¶æ€ç›‘æ§**ï¼š

```yaml
# æ·»åŠ å®¹å™¨çŠ¶æ€ä¿¡æ¯
processors:
- script:
    lang: javascript
    source: >
      function process(event) {
        // æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        var containerID = event.Get("container.id");
        if (containerID) {
          event.Put("container.status", "running");
          event.Put("collected_at", new Date().toISOString());
        }
      }
```

---

## 5. ğŸ“ JSONæ—¥å¿—è§£æé…ç½®


### 5.1 æ ‡å‡†JSONæ—¥å¿—å¤„ç†


**ğŸ’« è‡ªåŠ¨JSONè§£æ**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # JSONæ—¥å¿—è§£æ
  parsers:
  - ndjson:
      target: ""          # è§£æåˆ°æ ¹çº§åˆ«
      add_error_key: true # æ·»åŠ è§£æé”™è¯¯ä¿¡æ¯
      
  # å¦‚æœåº”ç”¨è¾“å‡ºçš„æ˜¯JSONæ ¼å¼
  processors:
  - decode_json_fields:
      fields: ["message"]
      target: "json"
      add_error_key: true
```

**ğŸ”§ å¤„ç†åµŒå¥—JSON**ï¼š

```yaml
# åº”ç”¨æ—¥å¿—ç¤ºä¾‹ï¼š
# {"timestamp":"2025-09-21T10:30:00Z","level":"INFO","service":"api","message":"User login","user":{"id":123,"name":"john"}}

filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  - decode_json_fields:
      fields: ["message"]
      target: "app"
      
  # æå–ç”¨æˆ·ä¿¡æ¯åˆ°å•ç‹¬å­—æ®µ    
  - script:
      lang: javascript
      source: >
        function process(event) {
          var app = event.Get("app");
          if (app && app.user) {
            event.Put("user_id", app.user.id);
            event.Put("user_name", app.user.name);
          }
        }
```

### 5.2 æ··åˆæ ¼å¼æ—¥å¿—å¤„ç†


**ğŸ­ å¤„ç†å¤šç§æ—¥å¿—æ ¼å¼**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  # å°è¯•JSONè§£æ
  - decode_json_fields:
      fields: ["message"]
      target: "json"
      ignore_failure: true
      
  # å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•è§£ææ™®é€šæ ¼å¼
  - dissect:
      when:
        not:
          has_fields: ["json"]
      tokenizer: "%{timestamp} [%{level}] %{logger}: %{message}"
      field: "message"
      target_prefix: "parsed"
```

---

## 6. ğŸ—ï¸ å¤šå®¹å™¨ç¯å¢ƒé…ç½®


### 6.1 å¾®æœåŠ¡æ¶æ„é…ç½®


**ğŸ¯ ä¸åŒæœåŠ¡ç±»å‹çš„é…ç½®**ï¼š

```yaml
filebeat.inputs:
# WebæœåŠ¡å®¹å™¨æ—¥å¿—
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  condition: |
    regexp:
      docker.container.labels.service_type: "web"
  fields:
    service_category: web
    log_format: nginx
    
# APIæœåŠ¡å®¹å™¨æ—¥å¿—
- type: container  
  paths:
    - '/var/lib/docker/containers/*/*.log'
  condition: |
    regexp:
      docker.container.labels.service_type: "api"
  processors:
  - decode_json_fields:
      fields: ["message"]
      target: "api"
  fields:
    service_category: api
    log_format: json
    
# æ•°æ®åº“å®¹å™¨æ—¥å¿—
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'  
  condition: |
    regexp:
      docker.container.labels.service_type: "database"
  fields:
    service_category: database
    log_format: structured
```

### 6.2 ç¯å¢ƒéš”ç¦»é…ç½®


**ğŸ¢ å¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒéš”ç¦»**ï¼š

```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  condition: |
    equals:
      docker.container.labels.environment: "production"
  
  # ç”Ÿäº§ç¯å¢ƒç‰¹æ®Šå¤„ç†
  processors:
  - add_fields:
      target: metadata
      fields:
        environment: production
        priority: high
        retention_days: 90
        
  # ç”Ÿäº§ç¯å¢ƒé”™è¯¯æ—¥å¿—ç‰¹åˆ«å¤„ç†
  - add_tags:
      tags: ["production", "critical"]
      when:
        regexp:
          message: "(ERROR|FATAL|CRITICAL)"

# å¼€å‘ç¯å¢ƒé…ç½®          
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  condition: |
    equals:
      docker.container.labels.environment: "development"
      
  fields:
    environment: development
    priority: low
    retention_days: 7
```

### 6.3 è´Ÿè½½å‡è¡¡ç¯å¢ƒé…ç½®


**âš–ï¸ å¤šå®ä¾‹æœåŠ¡æ—¥å¿—èšåˆ**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  # æ·»åŠ å®ä¾‹ä¿¡æ¯
  - add_fields:
      target: instance
      fields:
        node_name: "${NODE_NAME:localhost}"
        container_id: "${HOSTNAME}"
        
  # æœåŠ¡å®ä¾‹æ ‡è¯†
  - script:
      lang: javascript
      source: >
        function process(event) {
          var containerName = event.Get("docker.container.name");
          if (containerName) {
            // ä»å®¹å™¨åæå–æœåŠ¡å’Œå®ä¾‹ä¿¡æ¯
            // ä¾‹å¦‚ï¼šweb-service-1 -> service=web-service, instance=1
            var parts = containerName.split("-");
            if (parts.length >= 3) {
              event.Put("service.name", parts.slice(0, -1).join("-"));
              event.Put("service.instance", parts[parts.length - 1]);
            }
          }
        }
```

---

## 7. ğŸ› ï¸ å®æˆ˜é…ç½®ç¤ºä¾‹


### 7.1 ç”µå•†ç½‘ç«™å®¹å™¨æ—¥å¿—é…ç½®


**ğŸ›’ å®Œæ•´çš„ç”µå•†ç³»ç»Ÿé…ç½®**ï¼š

```yaml
# ç”µå•†ç½‘ç«™ - å®Œæ•´å®¹å™¨æ—¥å¿—é…ç½®
filebeat.yml: |
  filebeat.inputs:
  # å‰ç«¯Nginxè®¿é—®æ—¥å¿—
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
    condition: |
      equals:
        docker.container.labels.app: "nginx"
    fields:
      service: frontend
      log_type: access
    processors:
    - dissect:
        tokenizer: '%{client_ip} - - [%{timestamp}] "%{method} %{url} %{protocol}" %{status_code} %{response_size}'
        field: "message"
        
  # åç«¯APIæœåŠ¡æ—¥å¿—      
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
    condition: |
      equals:
        docker.container.labels.app: "api-server"
    processors:
    - decode_json_fields:
        fields: ["message"]
        target: "api"
    fields:
      service: backend
      log_type: application
      
  # æ•°æ®åº“æ—¥å¿—
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
    condition: |
      equals:
        docker.container.labels.app: "mysql"
    fields:
      service: database
      log_type: mysql
    # MySQLæ…¢æŸ¥è¯¢æ—¥å¿—ç‰¹æ®Šå¤„ç†
    processors:
    - add_tags:
        tags: ["slow-query"]
        when:
          contains:
            message: "Query_time"
            
  # Redisç¼“å­˜æ—¥å¿—
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
    condition: |
      equals:
        docker.container.labels.app: "redis"
    fields:
      service: cache
      log_type: redis
      
  # æ¶ˆæ¯é˜Ÿåˆ—æ—¥å¿—
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'
    condition: |
      equals:
        docker.container.labels.app: "rabbitmq"
    fields:
      service: queue
      log_type: rabbitmq

  # å…¨å±€å¤„ç†å™¨
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
  - add_fields:
      target: metadata
      fields:
        project: ecommerce
        environment: "${ENV:development}"
        
  output.elasticsearch:
    hosts: ["elasticsearch:9200"]
    index: "ecommerce-logs-%{+yyyy.MM.dd}"
```

### 7.2 ç›‘æ§å‘Šè­¦é…ç½®


**ğŸ“Š æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦**ï¼š

```yaml
# ç›‘æ§é…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  processors:
  # é”™è¯¯æ—¥å¿—ç‰¹æ®Šæ ‡è®°
  - add_tags:
      tags: ["alert", "error"]
      when:
        or:
        - regexp:
            message: "(ERROR|FATAL|Exception)"
        - equals:
            log.level: "error"
            
  # æ€§èƒ½é—®é¢˜æ ‡è®°        
  - add_tags:
      tags: ["performance", "slow"]
      when:
        or:
        - regexp:
            message: "slow.*(query|request|response)"
        - range:
            response_time:
              gte: 5000  # å“åº”æ—¶é—´å¤§äº5ç§’
              
  # å®‰å…¨ç›¸å…³æ—¥å¿—æ ‡è®°
  - add_tags:
      tags: ["security", "suspicious"]  
      when:
        or:
        - regexp:
            message: "(failed.login|unauthorized|403|401)"
        - contains:
            message: "authentication failed"
```

### 7.3 æ—¥å¿—è½®è½¬å’Œæ¸…ç†é…ç½®


**ğŸ”„ è‡ªåŠ¨åŒ–è¿ç»´é…ç½®**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # æ–‡ä»¶å¤„ç†é…ç½®
  close_inactive: 10m      # 10åˆ†é’Ÿä¸æ´»è·ƒå…³é—­æ–‡ä»¶
  clean_inactive: 24h      # 24å°æ—¶åæ¸…ç†é‡‡é›†å™¨
  ignore_older: 168h       # å¿½ç•¥7å¤©å‰çš„æ—¥å¿—
  scan_frequency: 30s      # 30ç§’æ‰«æä¸€æ¬¡æ–°æ–‡ä»¶
  
  # å¤§æ–‡ä»¶å¤„ç†
  max_bytes: 104857600     # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§100MB
  
  processors:
  # æ·»åŠ æ—¶é—´æˆ³
  - timestamp:
      field: "@timestamp"
      layouts:
        - '2006-01-02T15:04:05.000Z'
        - '2006-01-02 15:04:05'
      test:
        - '2025-09-21T10:30:45.123Z'
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨æ—¥å¿—ç‰¹ç‚¹ï¼šåŠ¨æ€æ€§ã€ä¸´æ—¶æ€§ã€æ ‡å‡†åŒ–è¾“å‡º
ğŸ”¸ æ—¥å¿—è·¯å¾„é…ç½®ï¼šDockerå’ŒK8sç¯å¢ƒçš„ä¸åŒè·¯å¾„è§„åˆ™  
ğŸ”¸ å…ƒæ•°æ®åˆ©ç”¨ï¼šå®¹å™¨åã€é•œåƒã€æ ‡ç­¾ç­‰ä¿¡æ¯çš„æ´»ç”¨
ğŸ”¸ è¿‡æ»¤ç­–ç•¥ï¼šåŸºäºå®¹å™¨å±æ€§çš„æ™ºèƒ½è¿‡æ»¤
ğŸ”¸ æ ¼å¼å¤„ç†ï¼šJSONå’Œæ–‡æœ¬æ··åˆæ ¼å¼çš„å¤„ç†æ–¹æ³•
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¹å™¨æ—¥å¿— vs ä¼ ç»Ÿæ—¥å¿—**ï¼š
```
ä¼ ç»Ÿæ—¥å¿—æ”¶é›†ï¼š
- å›ºå®šè·¯å¾„ï¼Œé…ç½®ä¸€æ¬¡é•¿æœŸæœ‰æ•ˆ
- æ–‡ä»¶æŒä¹…å­˜åœ¨
- æœåŠ¡å’Œæ—¥å¿—æ–‡ä»¶ä¸€å¯¹ä¸€å…³ç³»

å®¹å™¨æ—¥å¿—æ”¶é›†ï¼š
- åŠ¨æ€è·¯å¾„ï¼Œéœ€è¦æ¨¡å¼åŒ¹é…
- å®¹å™¨é‡å¯æ—¥å¿—å¯èƒ½ä¸¢å¤±
- ä¸€ä¸ªæœåŠ¡å¯èƒ½æœ‰å¤šä¸ªå®¹å™¨å®ä¾‹
```

**ğŸ”¹ å…ƒæ•°æ®çš„é‡è¦æ€§**ï¼š
```
ä¸ºä»€ä¹ˆå®¹å™¨å…ƒæ•°æ®é‡è¦ï¼š
- åŒºåˆ†ä¸åŒæœåŠ¡çš„æ—¥å¿—
- è¿½è¸ªæ—¥å¿—æ¥æº
- å®ç°æ™ºèƒ½è·¯ç”±å’Œè¿‡æ»¤
- ä¾¿äºé—®é¢˜æ’æŸ¥å’Œåˆ†æ
```

**ğŸ”¹ å¤šç¯å¢ƒç®¡ç†ç­–ç•¥**ï¼š
```
å¼€å‘ç¯å¢ƒï¼šå…³æ³¨è°ƒè¯•ä¿¡æ¯ï¼Œä¿ç•™æ—¶é—´çŸ­
æµ‹è¯•ç¯å¢ƒï¼šå…³æ³¨åŠŸèƒ½éªŒè¯ï¼Œé€‚åº¦ä¿ç•™
ç”Ÿäº§ç¯å¢ƒï¼šå…³æ³¨é”™è¯¯å’Œæ€§èƒ½ï¼Œé•¿æœŸä¿ç•™
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **å¾®æœåŠ¡æ¶æ„**ï¼šç»Ÿä¸€æ”¶é›†åˆ†å¸ƒå¼æœåŠ¡æ—¥å¿—
- **å®¹å™¨ç¼–æ’**ï¼šK8sç¯å¢ƒä¸‹çš„æ—¥å¿—èšåˆ
- **DevOpsæµç¨‹**ï¼šCI/CDè¿‡ç¨‹ä¸­çš„æ—¥å¿—è¿½è¸ª
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½é—®é¢˜å®¹å™¨å’ŒæœåŠ¡

**ğŸ”§ è¿ç»´å®è·µ**ï¼š
- **è‡ªåŠ¨å‘ç°**ï¼šæ–°å®¹å™¨å¯åŠ¨è‡ªåŠ¨å¼€å§‹æ—¥å¿—æ”¶é›†
- **æ™ºèƒ½è¿‡æ»¤**ï¼šå‡å°‘æ— ç”¨æ—¥å¿—ï¼Œæé«˜å­˜å‚¨æ•ˆç‡
- **å…ƒæ•°æ®ä¸°å¯Œ**ï¼šä¾¿äºæ—¥å¿—åˆ†æå’Œå¯è§†åŒ–
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šåˆç†é…ç½®æ—¥å¿—ä¿ç•™å’Œæ¸…ç†ç­–ç•¥

### 8.4 æœ€ä½³å®è·µå»ºè®®


| é…ç½®åœºæ™¯ | **æ¨èåšæ³•** | **æ³¨æ„äº‹é¡¹** | **å¸¸è§é”™è¯¯** |
|---------|------------|-------------|-------------|
| ğŸ³ **Dockerç¯å¢ƒ** | `ä½¿ç”¨é€šé…ç¬¦è·¯å¾„ï¼Œå¯ç”¨å…ƒæ•°æ®` | `å®šæœŸæ¸…ç†ä¸æ´»è·ƒé‡‡é›†å™¨` | `ç¡¬ç¼–ç å®¹å™¨IDè·¯å¾„` |
| â˜¸ï¸ **K8sç¯å¢ƒ** | `æŒ‰å‘½åç©ºé—´åˆ†ç±»ï¼Œä½¿ç”¨æ ‡ç­¾è¿‡æ»¤` | `æ³¨æ„èŠ‚ç‚¹æƒé™é…ç½®` | `å¿½ç•¥ç³»ç»Ÿå‘½åç©ºé—´æ—¥å¿—` |
| ğŸ“ **JSONæ—¥å¿—** | `è‡ªåŠ¨æ£€æµ‹æ ¼å¼ï¼Œå®¹é”™å¤„ç†` | `å¤„ç†è§£æå¤±è´¥æƒ…å†µ` | `å¼ºåˆ¶è§£æéJSONæ—¥å¿—` |
| ğŸ—ï¸ **å¤šæœåŠ¡ç¯å¢ƒ** | `æŒ‰æœåŠ¡ç±»å‹åˆ†ç»„é…ç½®` | `é¿å…é…ç½®è¿‡åº¦å¤æ‚` | `æ‰€æœ‰å®¹å™¨ä½¿ç”¨ç›¸åŒé…ç½®` |

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®¹å™¨æ—¥å¿—æ”¶é›†çš„æ ¸å¿ƒæ˜¯ç†è§£å®¹å™¨çš„åŠ¨æ€ç‰¹æ€§
- å…ƒæ•°æ®æ˜¯å®¹å™¨æ—¥å¿—çš„çµé­‚ï¼Œè¦å……åˆ†åˆ©ç”¨
- ä¸åŒç¯å¢ƒéœ€è¦ä¸åŒçš„æ”¶é›†å’Œä¿ç•™ç­–ç•¥  
- é…ç½®è¦è€ƒè™‘å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- JSONæ ¼å¼æ—¥å¿—éœ€è¦ç‰¹æ®Šçš„è§£æå¤„ç†