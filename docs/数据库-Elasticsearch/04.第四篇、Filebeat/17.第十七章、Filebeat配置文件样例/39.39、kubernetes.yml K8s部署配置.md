---
title: 39ã€kubernetes.yml K8séƒ¨ç½²é…ç½®
---
## ğŸ“š ç›®å½•

1. [Kuberneteséƒ¨ç½²åŸºç¡€æ¦‚å¿µ](#1-kuberneteséƒ¨ç½²åŸºç¡€æ¦‚å¿µ)
2. [DaemonSeté…ç½®è¯¦è§£](#2-daemonseté…ç½®è¯¦è§£)
3. [ConfigMapé…ç½®ç®¡ç†](#3-configmapé…ç½®ç®¡ç†)
4. [Secretå¯†é’¥ç®¡ç†](#4-secretå¯†é’¥ç®¡ç†)
5. [æœåŠ¡è´¦æˆ·é…ç½®](#5-æœåŠ¡è´¦æˆ·é…ç½®)
6. [èµ„æºé…é¢è®¾ç½®](#6-èµ„æºé…é¢è®¾ç½®)
7. [èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®](#7-èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®)
8. [äº²å’Œæ€§é…ç½®](#8-äº²å’Œæ€§é…ç½®)
9. [æ»šåŠ¨æ›´æ–°ç­–ç•¥](#9-æ»šåŠ¨æ›´æ–°ç­–ç•¥)
10. [å®Œæ•´é…ç½®ç¤ºä¾‹](#10-å®Œæ•´é…ç½®ç¤ºä¾‹)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Kuberneteséƒ¨ç½²åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Kubernetesä¸­çš„Filebeat


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡Kubernetesé›†ç¾¤æ˜¯ä¸€ä¸ªå¤§å‹å·¥å‚ï¼Œæœ‰å¾ˆå¤šæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰åœ¨è¿è¡Œã€‚Filebeatå°±åƒæ˜¯æ¯å°æœºå™¨ä¸Šçš„"æ•°æ®æ”¶é›†å‘˜"ï¼Œè´Ÿè´£æ”¶é›†æœºå™¨äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯ï¼Œç„¶åç»Ÿä¸€é€åˆ°æ•°æ®ä»“åº“ï¼ˆElasticsearchï¼‰ã€‚

```
å·¥å‚æ¯”å–»ï¼š
å·¥å‚è½¦é—´ = Kubernetesé›†ç¾¤
ç”Ÿäº§æœºå™¨ = å·¥ä½œèŠ‚ç‚¹
æ•°æ®æ”¶é›†å‘˜ = Filebeat
æ•°æ®ä»“åº“ = Elasticsearch

æ¯å°æœºå™¨éƒ½éœ€è¦ä¸€ä¸ªæ”¶é›†å‘˜ â†’ æ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦è¿è¡ŒFilebeat
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åœ¨K8sä¸­éƒ¨ç½²Filebeat


**æ ¸å¿ƒéœ€æ±‚**ï¼š
- **æ—¥å¿—ç»Ÿä¸€æ”¶é›†**ï¼šæŠŠåˆ†æ•£åœ¨å„ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—é›†ä¸­èµ·æ¥
- **å®¹å™¨æ—¥å¿—ç›‘æ§**ï¼šç›‘æ§Dockerå®¹å™¨äº§ç”Ÿçš„æ—¥å¿—
- **ç³»ç»Ÿæ—¥å¿—æ”¶é›†**ï¼šæ”¶é›†èŠ‚ç‚¹æ“ä½œç³»ç»Ÿçš„æ—¥å¿—
- **åº”ç”¨æ—¥å¿—å¤„ç†**ï¼šå¤„ç†éƒ¨ç½²åœ¨K8sä¸Šçš„åº”ç”¨æ—¥å¿—

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
å‡è®¾ä½ æœ‰ä¸€ä¸ªåœ¨çº¿å•†åŸéƒ¨ç½²åœ¨K8sä¸Šï¼š
- å‰ç«¯æœåŠ¡ï¼ˆnginxï¼‰äº§ç”Ÿè®¿é—®æ—¥å¿—
- åç«¯æœåŠ¡ï¼ˆJavaåº”ç”¨ï¼‰äº§ç”Ÿä¸šåŠ¡æ—¥å¿—  
- æ•°æ®åº“æœåŠ¡äº§ç”Ÿæ…¢æŸ¥è¯¢æ—¥å¿—
- ç³»ç»Ÿäº§ç”Ÿå†…æ ¸æ—¥å¿—

æ²¡æœ‰Filebeatï¼šéœ€è¦ç™»å½•æ¯ä¸ªèŠ‚ç‚¹æ‰‹åŠ¨æŸ¥çœ‹æ—¥å¿— âŒ
æœ‰äº†Filebeatï¼šæ‰€æœ‰æ—¥å¿—è‡ªåŠ¨æ”¶é›†åˆ°ç»Ÿä¸€å¹³å° âœ…
```

### 1.3 Kuberneteséƒ¨ç½²æ–¹å¼é€‰æ‹©


**DaemonSet vs Deployment**ï¼š
```
DaemonSetï¼ˆæ¨èï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚  â”‚ Node2   â”‚  â”‚ Node3   â”‚
â”‚Filebeat â”‚  â”‚Filebeat â”‚  â”‚Filebeat â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç‰¹ç‚¹ï¼šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªFilebeatå®ä¾‹

Deploymentï¼ˆä¸æ¨èï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚  â”‚ Node2   â”‚  â”‚ Node3   â”‚
â”‚         â”‚  â”‚Filebeat â”‚  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç‰¹ç‚¹ï¼šåªåœ¨æŸäº›èŠ‚ç‚¹è¿è¡Œï¼Œå¯èƒ½é—æ¼æ—¥å¿—
```

---

## 2. ğŸ“¦ DaemonSeté…ç½®è¯¦è§£


### 2.1 DaemonSetåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯DaemonSet**ï¼š
DaemonSetç¡®ä¿é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªPodçš„å‰¯æœ¬ã€‚å°±åƒç»™æ¯ä¸ªå·¥äººéƒ½é…ä¸€ä¸ªåŠ©æ‰‹ä¸€æ ·ã€‚

**ä¸ºä»€ä¹ˆFilebeatç”¨DaemonSet**ï¼š
- **å…¨è¦†ç›–**ï¼šç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ—¥å¿—æ”¶é›†
- **è‡ªåŠ¨æ‰©å±•**ï¼šæ–°èŠ‚ç‚¹åŠ å…¥æ—¶è‡ªåŠ¨éƒ¨ç½²Filebeat
- **æ•…éšœæ¢å¤**ï¼šèŠ‚ç‚¹é‡å¯åè‡ªåŠ¨æ¢å¤Filebeat

### 2.2 DaemonSetåŸºç¡€é…ç½®


```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
spec:
  selector:
    matchLabels:
      app: filebeat
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.10.0
```

**é…ç½®è¯´æ˜**ï¼š
- `namespace: kube-system`ï¼šéƒ¨ç½²åœ¨ç³»ç»Ÿå‘½åç©ºé—´
- `matchLabels`ï¼šé€‰æ‹©å™¨ï¼Œç”¨äºè¯†åˆ«ç®¡ç†çš„Pod
- `image`ï¼šä½¿ç”¨å®˜æ–¹Filebeaté•œåƒ

### 2.3 å®¹å™¨è¿è¡Œé…ç½®


```yaml
containers:
- name: filebeat
  image: docker.elastic.co/beats/filebeat:8.10.0
  args: [
    "-c", "/etc/filebeat.yml",
    "-e"
  ]
  env:
  - name: ELASTICSEARCH_HOST
    value: "elasticsearch"
  - name: ELASTICSEARCH_PORT
    value: "9200"
  - name: NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
```

**å‚æ•°è§£é‡Š**ï¼š
- `args`ï¼šå¯åŠ¨å‚æ•°ï¼Œ`-c`æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œ`-e`è¾“å‡ºåˆ°stderr
- `env`ï¼šç¯å¢ƒå˜é‡ï¼Œç”¨äºé…ç½®è¿æ¥ä¿¡æ¯
- `NODE_NAME`ï¼šè·å–å½“å‰èŠ‚ç‚¹åç§°

---

## 3. ğŸ—‚ï¸ ConfigMapé…ç½®ç®¡ç†


### 3.1 ConfigMapçš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šConfigMapå°±åƒæ˜¯ä¸€ä¸ª"é…ç½®æ–‡ä»¶ç®¡ç†å™¨"ï¼ŒæŠŠFilebeatçš„é…ç½®æ–‡ä»¶å•ç‹¬å­˜å‚¨ï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œç®¡ç†ã€‚

**ä¼˜åŠ¿**ï¼š
- **é…ç½®åˆ†ç¦»**ï¼šé…ç½®å’Œç¨‹åºåˆ†å¼€ï¼Œä¾¿äºç®¡ç†
- **çƒ­æ›´æ–°**ï¼šä¿®æ”¹é…ç½®ä¸éœ€è¦é‡æ–°æ„å»ºé•œåƒ
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå¯ä»¥ç®¡ç†é…ç½®çš„ä¸åŒç‰ˆæœ¬

### 3.2 åŸºç¡€ConfigMapé…ç½®


```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: kube-system
data:
  filebeat.yml: |-
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/*.log
      processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
    
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']
    
    logging.level: info
    logging.to_files: true
    logging.files:
      path: /var/log/filebeat
      name: filebeat
      keepfiles: 7
      permissions: 0644
```

**é…ç½®è¦ç‚¹è§£é‡Š**ï¼š

**è¾“å…¥é…ç½®**ï¼š
- `type: container`ï¼šæ”¶é›†å®¹å™¨æ—¥å¿—
- `paths`ï¼šæ—¥å¿—æ–‡ä»¶è·¯å¾„
- `add_kubernetes_metadata`ï¼šè‡ªåŠ¨æ·»åŠ K8så…ƒæ•°æ®

**è¾“å‡ºé…ç½®**ï¼š
- `hosts`ï¼šElasticsearchåœ°å€
- ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¾¿äºä¸åŒç¯å¢ƒéƒ¨ç½²

### 3.3 é«˜çº§ConfigMapé…ç½®


```yaml
data:
  filebeat.yml: |-
    filebeat.inputs:
    # æ”¶é›†å®¹å™¨æ—¥å¿—
    - type: container
      paths:
        - /var/log/containers/*.log
      exclude_lines: ['^DBG']
      multiline.pattern: '^\d{4}-\d{2}-\d{2}'
      multiline.negate: true
      multiline.match: after
      
    # æ”¶é›†ç³»ç»Ÿæ—¥å¿—
    - type: log
      paths:
        - /var/log/syslog
        - /var/log/messages
      fields:
        logtype: system
        
    # æ”¶é›†Kuberneteså®¡è®¡æ—¥å¿—
    - type: log
      paths:
        - /var/log/audit.log
      fields:
        logtype: audit
        
    processors:
    - add_kubernetes_metadata:
        host: ${NODE_NAME}
        matchers:
        - logs_path:
            logs_path: "/var/log/containers/"
    - drop_event:
        when:
          contains:
            kubernetes.container.name: "filebeat"
            
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}']
      index: "filebeat-k8s-%{+yyyy.MM.dd}"
```

**é«˜çº§ç‰¹æ€§**ï¼š
- `exclude_lines`ï¼šæ’é™¤è°ƒè¯•æ—¥å¿—
- `multiline`ï¼šå¤šè¡Œæ—¥å¿—åˆå¹¶
- `fields`ï¼šæ·»åŠ è‡ªå®šä¹‰å­—æ®µ
- `drop_event`ï¼šè¿‡æ»¤æ‰è‡ªèº«æ—¥å¿—

---

## 4. ğŸ” Secretå¯†é’¥ç®¡ç†


### 4.1 Secretçš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šSecretå°±åƒä¿é™©ç®±ï¼Œä¸“é—¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯å¦‚å¯†ç ã€è¯ä¹¦ç­‰ï¼Œç¡®ä¿è¿™äº›ä¿¡æ¯ä¸ä¼šè¢«æ³„éœ²ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- **Elasticsearchè®¤è¯**ï¼šç”¨æˆ·åå¯†ç 
- **TLSè¯ä¹¦**ï¼šå®‰å…¨è¿æ¥è¯ä¹¦
- **APIå¯†é’¥**ï¼šç¬¬ä¸‰æ–¹æœåŠ¡å¯†é’¥

### 4.2 åˆ›å»ºè®¤è¯Secret


```yaml
apiVersion: v1
kind: Secret
metadata:
  name: elasticsearch-secret
  namespace: kube-system
type: Opaque
data:
  username: ZWxhc3RpYw==  # elastic (base64ç¼–ç )
  password: cGFzc3dvcmQ=  # password (base64ç¼–ç )
```

**base64ç¼–ç æ–¹æ³•**ï¼š
```bash
# ç¼–ç ç”¨æˆ·å
echo -n "elastic" | base64
# è¾“å‡ºï¼šZWxhc3RpYw==

# ç¼–ç å¯†ç   
echo -n "password" | base64
# è¾“å‡ºï¼šcGFzc3dvcmQ=
```

### 4.3 TLSè¯ä¹¦Secret


```yaml
apiVersion: v1
kind: Secret
metadata:
  name: elasticsearch-certs
  namespace: kube-system
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi... # è¯ä¹¦å†…å®¹(base64)
  tls.key: LS0tLS1CRUdJTi... # ç§é’¥å†…å®¹(base64)
  ca.crt: LS0tLS1CRUdJTi...  # CAè¯ä¹¦(base64)
```

### 4.4 åœ¨Filebeatä¸­ä½¿ç”¨Secret


```yaml
# ConfigMapä¸­å¼•ç”¨Secret
data:
  filebeat.yml: |-
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}']
      username: '${ELASTICSEARCH_USERNAME}'
      password: '${ELASTICSEARCH_PASSWORD}'
      ssl:
        certificate_authorities: ["/etc/certs/ca.crt"]
        certificate: "/etc/certs/tls.crt"
        key: "/etc/certs/tls.key"
```

```yaml
# DaemonSetä¸­æŒ‚è½½Secret
spec:
  template:
    spec:
      containers:
      - name: filebeat
        env:
        - name: ELASTICSEARCH_USERNAME
          valueFrom:
            secretKeyRef:
              name: elasticsearch-secret
              key: username
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-secret
              key: password
        volumeMounts:
        - name: certs
          mountPath: /etc/certs
          readOnly: true
      volumes:
      - name: certs
        secret:
          secretName: elasticsearch-certs
```

---

## 5. ğŸ‘¤ æœåŠ¡è´¦æˆ·é…ç½®


### 5.1 æœåŠ¡è´¦æˆ·çš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šæœåŠ¡è´¦æˆ·å°±åƒç»™FilebeatåŠçš„"å·¥ä½œè¯"ï¼Œæœ‰äº†è¿™ä¸ªè¯ä»¶ï¼ŒFilebeatæ‰èƒ½è®¿é—®Kubernetesçš„APIï¼Œè·å–å®¹å™¨å’ŒPodçš„ä¿¡æ¯ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼š
- **æƒé™æ§åˆ¶**ï¼šé™åˆ¶Filebeatåªèƒ½è®¿é—®éœ€è¦çš„èµ„æº
- **å®‰å…¨éš”ç¦»**ï¼šé˜²æ­¢æ¶æ„ç¨‹åºæ»¥ç”¨K8s API
- **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•APIè®¿é—®è¡Œä¸º

### 5.2 åˆ›å»ºæœåŠ¡è´¦æˆ·


```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
```

### 5.3 é…ç½®æƒé™ï¼ˆRBACï¼‰


```yaml
# é›†ç¾¤è§’è‰² - å®šä¹‰æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: filebeat
rules:
- apiGroups: [""]
  resources:
  - nodes
  - namespaces
  - pods
  - events
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources:
  - replicasets
  verbs: ["get", "list", "watch"]
---
# ç»‘å®šè§’è‰²åˆ°æœåŠ¡è´¦æˆ·
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: filebeat
subjects:
- kind: ServiceAccount
  name: filebeat
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: filebeat
  apiGroup: rbac.authorization.k8s.io
```

**æƒé™è¯´æ˜**ï¼š
- `nodes`ï¼šè¯»å–èŠ‚ç‚¹ä¿¡æ¯
- `pods`ï¼šè¯»å–Podå…ƒæ•°æ®
- `events`ï¼šè¯»å–é›†ç¾¤äº‹ä»¶
- `verbs`ï¼š`get`æŸ¥çœ‹å•ä¸ªï¼Œ`list`æŸ¥çœ‹åˆ—è¡¨ï¼Œ`watch`ç›‘å¬å˜åŒ–

### 5.4 åœ¨DaemonSetä¸­ä½¿ç”¨


```yaml
spec:
  template:
    spec:
      serviceAccountName: filebeat
      containers:
      - name: filebeat
        # ... å…¶ä»–é…ç½®
```

---

## 6. ğŸ’¾ èµ„æºé…é¢è®¾ç½®


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºé…é¢


**é€šä¿—ç†è§£**ï¼šèµ„æºé…é¢å°±åƒç»™Filebeatåˆ†é…"ç”¨é¤é¢„ç®—"ï¼Œé™åˆ¶å®ƒèƒ½æ¶ˆè€—å¤šå°‘CPUå’Œå†…å­˜ï¼Œé˜²æ­¢å®ƒ"åƒå¤ªå¤š"å½±å“å…¶ä»–ç¨‹åºè¿è¡Œã€‚

**é‡è¦æ€§**ï¼š
- **é˜²æ­¢èµ„æºäº‰æŠ¢**ï¼šé¿å…Filebeatå½±å“ä¸šåŠ¡åº”ç”¨
- **ç¨³å®šè¿è¡Œ**ï¼šä¿è¯Filebeatæœ‰è¶³å¤Ÿèµ„æºæ­£å¸¸å·¥ä½œ
- **æˆæœ¬æ§åˆ¶**ï¼šåˆç†åˆ†é…é›†ç¾¤èµ„æº

### 6.2 åŸºç¡€èµ„æºé…ç½®


```yaml
containers:
- name: filebeat
  image: docker.elastic.co/beats/filebeat:8.10.0
  resources:
    limits:
      memory: "200Mi"
      cpu: "100m"
    requests:
      memory: "100Mi"
      cpu: "50m"
```

**å‚æ•°å«ä¹‰**ï¼š
- `limits`ï¼šæœ€å¤§èµ„æºä½¿ç”¨é‡ï¼ˆç¡¬é™åˆ¶ï¼‰
- `requests`ï¼šé¢„ç•™èµ„æºé‡ï¼ˆè½¯é™åˆ¶ï¼‰
- `memory`ï¼šå†…å­˜ï¼Œ`Mi`è¡¨ç¤ºMB
- `cpu`ï¼šCPUï¼Œ`100m`è¡¨ç¤º0.1ä¸ªCPUæ ¸å¿ƒ

### 6.3 ç”Ÿäº§ç¯å¢ƒèµ„æºé…ç½®


```yaml
resources:
  limits:
    memory: "500Mi"
    cpu: "200m"
    ephemeral-storage: "1Gi"
  requests:
    memory: "200Mi"
    cpu: "100m"
    ephemeral-storage: "500Mi"
```

**èµ„æºè§„åˆ’å»ºè®®**ï¼š

| ç¯å¢ƒç±»å‹ | CPUè¯·æ±‚/é™åˆ¶ | å†…å­˜è¯·æ±‚/é™åˆ¶ | é€‚ç”¨åœºæ™¯ |
|---------|-------------|-------------|----------|
| **å¼€å‘ç¯å¢ƒ** | `50m/100m` | `100Mi/200Mi` | è½»é‡çº§æ—¥å¿—æ”¶é›† |
| **æµ‹è¯•ç¯å¢ƒ** | `100m/200m` | `200Mi/400Mi` | ä¸­ç­‰è´Ÿè½½æµ‹è¯• |
| **ç”Ÿäº§ç¯å¢ƒ** | `200m/500m` | `400Mi/800Mi` | é«˜è´Ÿè½½ç”Ÿäº§ |
| **å¤§è§„æ¨¡ç”Ÿäº§** | `500m/1000m` | `800Mi/1.5Gi` | è¶…å¤§è§„æ¨¡éƒ¨ç½² |

### 6.4 èµ„æºç›‘æ§é…ç½®


```yaml
# å¯ç”¨èµ„æºç›‘æ§
containers:
- name: filebeat
  env:
  - name: FILEBEAT_MONITORING_ENABLED
    value: "true"
  - name: FILEBEAT_MONITORING_ELASTICSEARCH
    value: "http://elasticsearch:9200"
```

---

## 7. ğŸ¯ èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®


### 7.1 èŠ‚ç‚¹é€‰æ‹©å™¨çš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šèŠ‚ç‚¹é€‰æ‹©å™¨å°±åƒ"æŒ‘é€‰å·¥äºº"ï¼Œå¯ä»¥æŒ‡å®šFilebeatåªåœ¨ç‰¹å®šç±»å‹çš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ¯”å¦‚åªåœ¨æœ‰SSDç¡¬ç›˜çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- **ç¡¬ä»¶è¦æ±‚**ï¼šåªåœ¨é«˜æ€§èƒ½èŠ‚ç‚¹è¿è¡Œ
- **å®‰å…¨éš”ç¦»**ï¼šåªåœ¨ç‰¹å®šå®‰å…¨çº§åˆ«èŠ‚ç‚¹è¿è¡Œ
- **æˆæœ¬ä¼˜åŒ–**ï¼šé¿å…åœ¨æ˜‚è´µèŠ‚ç‚¹è¿è¡Œ

### 7.2 åŸºç¡€èŠ‚ç‚¹é€‰æ‹©


```yaml
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/os: linux
        node-type: log-collector
```

**å¸¸ç”¨æ ‡ç­¾**ï¼š
- `kubernetes.io/os`ï¼šæ“ä½œç³»ç»Ÿç±»å‹
- `kubernetes.io/arch`ï¼šCPUæ¶æ„
- `node-type`ï¼šè‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹

### 7.3 ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾


```bash
# ç»™èŠ‚ç‚¹æ·»åŠ æ ‡ç­¾
kubectl label nodes worker-node-1 node-type=log-collector
kubectl label nodes worker-node-2 node-type=log-collector

# æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
kubectl get nodes --show-labels

# åˆ é™¤æ ‡ç­¾
kubectl label nodes worker-node-1 node-type-
```

### 7.4 æ’é™¤ç‰¹å®šèŠ‚ç‚¹


```yaml
spec:
  template:
    spec:
      nodeSelector:
        # åªåœ¨LinuxèŠ‚ç‚¹è¿è¡Œ
        kubernetes.io/os: linux
        # æ’é™¤masterèŠ‚ç‚¹ï¼ˆé€šè¿‡ä¸é€‰æ‹©masteræ ‡ç­¾å®ç°ï¼‰
        node-role.kubernetes.io/master: "false"
```

---

## 8. ğŸ§² äº²å’Œæ€§é…ç½®


### 8.1 äº²å’Œæ€§vsèŠ‚ç‚¹é€‰æ‹©å™¨


**é€šä¿—ç†è§£**ï¼š
- **èŠ‚ç‚¹é€‰æ‹©å™¨**ï¼šç¡¬æ€§è¦æ±‚ï¼Œ"å¿…é¡»"åœ¨æŒ‡å®šèŠ‚ç‚¹è¿è¡Œ
- **äº²å’Œæ€§**ï¼šè½¯æ€§åå¥½ï¼Œ"ä¼˜å…ˆ"åœ¨æŒ‡å®šèŠ‚ç‚¹è¿è¡Œï¼Œå®åœ¨ä¸è¡Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–èŠ‚ç‚¹

**äº²å’Œæ€§ç±»å‹**ï¼š
```
èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆNode Affinityï¼‰ï¼š
â”œâ”€â”€ requiredDuringSchedulingï¼ˆç¡¬è¦æ±‚ï¼‰
â””â”€â”€ preferredDuringSchedulingï¼ˆè½¯åå¥½ï¼‰

Podäº²å’Œæ€§ï¼ˆPod Affinityï¼‰ï¼š
â”œâ”€â”€ äº²å’Œæ€§ï¼šå€¾å‘äºè°ƒåº¦åˆ°ç›¸åŒä½ç½®
â””â”€â”€ åäº²å’Œæ€§ï¼šå€¾å‘äºè°ƒåº¦åˆ°ä¸åŒä½ç½®
```

### 8.2 èŠ‚ç‚¹äº²å’Œæ€§é…ç½®


```yaml
spec:
  template:
    spec:
      affinity:
        nodeAffinity:
          # ç¡¬è¦æ±‚ï¼šå¿…é¡»æ»¡è¶³
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values: ["linux"]
              - key: node-type
                operator: In
                values: ["worker", "log-collector"]
          
          # è½¯åå¥½ï¼šä¼˜å…ˆæ»¡è¶³
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: disk-type
                operator: In
                values: ["ssd"]
          - weight: 50
            preference:
              matchExpressions:
              - key: network-speed
                operator: In
                values: ["high"]
```

**é…ç½®è¯´æ˜**ï¼š
- `requiredDuring...`ï¼šå¿…é¡»æ»¡è¶³çš„æ¡ä»¶
- `preferredDuring...`ï¼šä¼˜å…ˆæ»¡è¶³çš„æ¡ä»¶
- `weight`ï¼šæƒé‡ï¼Œæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
- `operator`ï¼šæ“ä½œç¬¦ï¼Œ`In`è¡¨ç¤ºåœ¨åˆ—è¡¨ä¸­

### 8.3 Podåäº²å’Œæ€§é…ç½®


```yaml
spec:
  template:
    spec:
      affinity:
        podAntiAffinity:
          # é¿å…å¤šä¸ªFilebeatåœ¨åŒä¸€èŠ‚ç‚¹
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values: ["filebeat"]
              topologyKey: kubernetes.io/hostname
```

**ä½œç”¨**ï¼šç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹åªè¿è¡Œä¸€ä¸ªFilebeatå®ä¾‹ï¼Œæé«˜å¯ç”¨æ€§ã€‚

---

## 9. ğŸ”„ æ»šåŠ¨æ›´æ–°ç­–ç•¥


### 9.1 æ»šåŠ¨æ›´æ–°çš„æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šæ»šåŠ¨æ›´æ–°å°±åƒ"æ¥åŠ›æ¢ç­"ï¼Œé€ä¸ªèŠ‚ç‚¹æ›´æ–°Filebeatï¼Œç¡®ä¿å§‹ç»ˆæœ‰æ—¥å¿—æ”¶é›†æœåŠ¡åœ¨è¿è¡Œï¼Œé¿å…æœåŠ¡ä¸­æ–­ã€‚

**æ›´æ–°æµç¨‹**ï¼š
```
æ›´æ–°å‰ï¼š[æ—§ç‰ˆæœ¬] [æ—§ç‰ˆæœ¬] [æ—§ç‰ˆæœ¬]
æ­¥éª¤1ï¼š[æ–°ç‰ˆæœ¬] [æ—§ç‰ˆæœ¬] [æ—§ç‰ˆæœ¬]
æ­¥éª¤2ï¼š[æ–°ç‰ˆæœ¬] [æ–°ç‰ˆæœ¬] [æ—§ç‰ˆæœ¬]  
æ­¥éª¤3ï¼š[æ–°ç‰ˆæœ¬] [æ–°ç‰ˆæœ¬] [æ–°ç‰ˆæœ¬]
```

### 9.2 åŸºç¡€æ›´æ–°ç­–ç•¥


```yaml
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
```

**å‚æ•°è¯´æ˜**ï¼š
- `type: RollingUpdate`ï¼šä½¿ç”¨æ»šåŠ¨æ›´æ–°æ–¹å¼
- `maxUnavailable: 1`ï¼šåŒæ—¶æœ€å¤šæœ‰1ä¸ªPodä¸å¯ç”¨

### 9.3 é«˜çº§æ›´æ–°ç­–ç•¥


```yaml
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: "25%"
  template:
    spec:
      containers:
      - name: filebeat
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              curl -f http://localhost:5066/stats || exit 1
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        livenessProbe:
          exec:
            command:
            - sh  
            - -c
            - |
              curl -f http://localhost:5066/stats || exit 1
          initialDelaySeconds: 60
          periodSeconds: 20
          timeoutSeconds: 5
```

**å¥åº·æ£€æŸ¥è¯´æ˜**ï¼š
- `readinessProbe`ï¼šå°±ç»ªæ¢é’ˆï¼Œæ£€æŸ¥æ˜¯å¦å‡†å¤‡æ¥æ”¶æµé‡
- `livenessProbe`ï¼šå­˜æ´»æ¢é’ˆï¼Œæ£€æŸ¥æ˜¯å¦æ­£å¸¸è¿è¡Œ
- `initialDelaySeconds`ï¼šé¦–æ¬¡æ£€æŸ¥å»¶è¿Ÿæ—¶é—´
- `periodSeconds`ï¼šæ£€æŸ¥é—´éš”æ—¶é—´

### 9.4 æ›´æ–°æ“ä½œå‘½ä»¤


```bash
# æŸ¥çœ‹å½“å‰DaemonSetçŠ¶æ€
kubectl get daemonset filebeat -n kube-system

# æ›´æ–°é•œåƒç‰ˆæœ¬
kubectl set image daemonset/filebeat filebeat=docker.elastic.co/beats/filebeat:8.11.0 -n kube-system

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status daemonset/filebeat -n kube-system

# æŸ¥çœ‹æ›´æ–°å†å²
kubectl rollout history daemonset/filebeat -n kube-system

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo daemonset/filebeat -n kube-system
```

---

## 10. ğŸ“‹ å®Œæ•´é…ç½®ç¤ºä¾‹


### 10.1 å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé…ç½®


```yaml
# å®Œæ•´çš„Filebeat Kuberneteséƒ¨ç½²é…ç½®
---
# æœåŠ¡è´¦æˆ·
apiVersion: v1
kind: ServiceAccount
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat

---
# é›†ç¾¤æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: filebeat
rules:
- apiGroups: [""]
  resources: ["nodes", "namespaces", "pods", "events"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["replicasets"]
  verbs: ["get", "list", "watch"]

---
# æƒé™ç»‘å®š
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: filebeat
subjects:
- kind: ServiceAccount
  name: filebeat
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: filebeat
  apiGroup: rbac.authorization.k8s.io

---
# é…ç½®æ–‡ä»¶
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: kube-system
data:
  filebeat.yml: |-
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/*.log
      processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
            matchers:
            - logs_path:
                logs_path: "/var/log/containers/"
        - drop_event:
            when:
              contains:
                kubernetes.container.name: "filebeat"
    
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']
      index: "filebeat-k8s-%{+yyyy.MM.dd}"
    
    logging.level: info
    logging.metrics.enabled: true
    
    http:
      enabled: true
      port: 5066

---
# è®¤è¯å¯†é’¥
apiVersion: v1
kind: Secret
metadata:
  name: elasticsearch-secret
  namespace: kube-system
type: Opaque
data:
  username: ZWxhc3RpYw==
  password: cGFzc3dvcmQ=

---
# DaemonSetä¸»é…ç½®
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
spec:
  selector:
    matchLabels:
      app: filebeat
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      serviceAccountName: filebeat
      terminationGracePeriodSeconds: 30
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      
      # èŠ‚ç‚¹é€‰æ‹©
      nodeSelector:
        kubernetes.io/os: linux
      
      # äº²å’Œæ€§é…ç½®
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/os
                operator: In
                values: ["linux"]
      
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.10.0
        args: [
          "-c", "/etc/filebeat.yml",
          "-e",
        ]
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: ELASTICSEARCH_HOST
          value: "elasticsearch"
        - name: ELASTICSEARCH_PORT
          value: "9200"
        - name: ELASTICSEARCH_USERNAME
          valueFrom:
            secretKeyRef:
              name: elasticsearch-secret
              key: username
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-secret
              key: password
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        
        # èµ„æºé™åˆ¶
        resources:
          limits:
            memory: 400Mi
            cpu: 200m
          requests:
            memory: 200Mi
            cpu: 100m
        
        # å¥åº·æ£€æŸ¥
        readinessProbe:
          httpGet:
            path: /stats
            port: 5066
          initialDelaySeconds: 30
          periodSeconds: 10
        
        livenessProbe:
          httpGet:
            path: /stats
            port: 5066
          initialDelaySeconds: 60
          periodSeconds: 20
        
        # å®‰å…¨ä¸Šä¸‹æ–‡
        securityContext:
          runAsUser: 0
          privileged: false
        
        # æŒ‚è½½ç›®å½•
        volumeMounts:
        - name: config
          mountPath: /etc/filebeat.yml
          readOnly: true
          subPath: filebeat.yml
        - name: data
          mountPath: /usr/share/filebeat/data
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlognodes
          mountPath: /var/log/nodes
          readOnly: true
      
      # æŒ‚è½½å·
      volumes:
      - name: config
        configMap:
          defaultMode: 0600
          name: filebeat-config
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlognodes
        hostPath:
          path: /var/log/nodes
      - name: data
        hostPath:
          path: /var/lib/filebeat-data
          type: DirectoryOrCreate
```

### 10.2 éƒ¨ç½²å‘½ä»¤


```bash
# 1. åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
kubectl create namespace kube-system --dry-run=client -o yaml | kubectl apply -f -

# 2. åº”ç”¨é…ç½®
kubectl apply -f filebeat-k8s.yml

# 3. éªŒè¯éƒ¨ç½²
kubectl get daemonset filebeat -n kube-system
kubectl get pods -l app=filebeat -n kube-system

# 4. æŸ¥çœ‹æ—¥å¿—
kubectl logs -l app=filebeat -n kube-system

# 5. æ£€æŸ¥çŠ¶æ€
kubectl describe daemonset filebeat -n kube-system
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Kuberneteséƒ¨ç½²åŸç†ï¼šä¸ºä»€ä¹ˆç”¨DaemonSetï¼Œå¦‚ä½•ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰Filebeat
ğŸ”¸ ConfigMapç®¡ç†ï¼šå¦‚ä½•åˆ†ç¦»é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç®¡ç†å’Œæ›´æ–°
ğŸ”¸ Secretå®‰å…¨ï¼šå¦‚ä½•å®‰å…¨å­˜å‚¨å¯†ç å’Œè¯ä¹¦
ğŸ”¸ æœåŠ¡è´¦æˆ·ï¼šå¦‚ä½•ç»™Filebeatåˆ†é…åˆé€‚çš„æƒé™
ğŸ”¸ èµ„æºé…é¢ï¼šå¦‚ä½•åˆç†åˆ†é…CPUå’Œå†…å­˜èµ„æº
ğŸ”¸ èŠ‚ç‚¹é€‰æ‹©ï¼šå¦‚ä½•æ§åˆ¶Filebeatè¿è¡Œåœ¨å“ªäº›èŠ‚ç‚¹ä¸Š
ğŸ”¸ æ»šåŠ¨æ›´æ–°ï¼šå¦‚ä½•å®‰å…¨åœ°æ›´æ–°Filebeatç‰ˆæœ¬
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ DaemonSetçš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆé€‰æ‹©DaemonSetï¼š
- æ—¥å¿—æ”¶é›†éœ€è¦å…¨è¦†ç›– â†’ DaemonSetç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰
- èŠ‚ç‚¹åŠ¨æ€å˜åŒ– â†’ DaemonSetè‡ªåŠ¨é€‚åº”é›†ç¾¤å˜åŒ–
- é«˜å¯ç”¨è¦æ±‚ â†’ å•ä¸ªèŠ‚ç‚¹æ•…éšœä¸å½±å“å…¶ä»–èŠ‚ç‚¹æ”¶é›†
```

**ğŸ”¹ èµ„æºé…ç½®çš„å¹³è¡¡**
```
èµ„æºé…ç½®è€ƒè™‘å› ç´ ï¼š
- è¿‡å°‘ï¼šFilebeatå¯èƒ½OOMæˆ–CPUä¸è¶³ï¼Œå½±å“æ—¥å¿—æ”¶é›†
- è¿‡å¤šï¼šæµªè´¹é›†ç¾¤èµ„æºï¼Œå½±å“ä¸šåŠ¡åº”ç”¨
- åˆç†ï¼šæ ¹æ®æ—¥å¿—é‡å’ŒèŠ‚ç‚¹è§„æ ¼åˆç†åˆ†é…
```

**ğŸ”¹ å®‰å…¨æ€§çš„é‡è¦æ€§**
```
å®‰å…¨é…ç½®è¦ç‚¹ï¼š
- æœ€å°æƒé™åŸåˆ™ï¼šåªç»™Filebeatå¿…éœ€çš„APIæƒé™
- å¯†é’¥ä¿æŠ¤ï¼šæ•æ„Ÿä¿¡æ¯ç”¨Secretå­˜å‚¨
- ç½‘ç»œéš”ç¦»ï¼šåˆç†é…ç½®ç½‘ç»œç­–ç•¥
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•**ï¼š

| é…ç½®é¡¹ç›® | å¿…éœ€ç¨‹åº¦ | è¯´æ˜ |
|---------|---------|------|
| **ServiceAccount** | `å¿…éœ€` | è®¿é—®K8s APIçš„å‡­è¯ |
| **RBACæƒé™** | `å¿…éœ€` | é™åˆ¶APIè®¿é—®èŒƒå›´ |
| **ConfigMap** | `å¿…éœ€` | å­˜å‚¨Filebeaté…ç½® |
| **Secret** | `æ¨è` | å­˜å‚¨è®¤è¯ä¿¡æ¯ |
| **èµ„æºé™åˆ¶** | `å¿…éœ€` | é˜²æ­¢èµ„æºäº‰æŠ¢ |
| **å¥åº·æ£€æŸ¥** | `æ¨è` | ç¡®ä¿æœåŠ¡å¯ç”¨æ€§ |
| **èŠ‚ç‚¹é€‰æ‹©** | `å¯é€‰` | æ ¹æ®éœ€æ±‚é€‰æ‹©èŠ‚ç‚¹ |
| **ç›‘æ§é…ç½®** | `æ¨è` | ç›‘æ§FilebeatçŠ¶æ€ |

**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

```bash
# 1. æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -l app=filebeat -n kube-system -o wide

# 2. æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod <pod-name> -n kube-system

# 3. æŸ¥çœ‹æ—¥å¿—
kubectl logs <pod-name> -n kube-system

# 4. æ£€æŸ¥é…ç½®
kubectl get configmap filebeat-config -n kube-system -o yaml

# 5. éªŒè¯æƒé™
kubectl auth can-i get pods --as=system:serviceaccount:kube-system:filebeat
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- DaemonSetç¡®ä¿å…¨è¦†ç›–ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ”¶é›†æ—¥å¿—
- ConfigMapç®¡ç†é…ç½®ï¼ŒSecretä¿æŠ¤å¯†é’¥
- æœåŠ¡è´¦æˆ·é…æƒé™ï¼Œèµ„æºé…é¢ä¿ç¨³å®š
- æ»šåŠ¨æ›´æ–°ä¿è¿ç»­ï¼Œå¥åº·æ£€æŸ¥ä¿å¯ç”¨