---
title: 8ã€tcp-udp-input.ymlç½‘ç»œè¾“å…¥é…ç½®
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œè¾“å…¥åŸºç¡€æ¦‚å¿µ](#1-ç½‘ç»œè¾“å…¥åŸºç¡€æ¦‚å¿µ)
2. [TCPè¾“å…¥é…ç½®è¯¦è§£](#2-TCPè¾“å…¥é…ç½®è¯¦è§£)
3. [UDPè¾“å…¥é…ç½®è¯¦è§£](#3-UDPè¾“å…¥é…ç½®è¯¦è§£)
4. [SSL/TLSåŠ å¯†é…ç½®](#4-SSL-TLSåŠ å¯†é…ç½®)
5. [æ¶ˆæ¯åˆ†éš”ä¸è§£æ](#5-æ¶ˆæ¯åˆ†éš”ä¸è§£æ)
6. [æ€§èƒ½ä¼˜åŒ–é…ç½®](#6-æ€§èƒ½ä¼˜åŒ–é…ç½®)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#8-æ•…éšœæ’æŸ¥æŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ç½‘ç»œè¾“å…¥åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç½‘ç»œè¾“å…¥


**é€šä¿—ç†è§£**ï¼š
```
ç½‘ç»œè¾“å…¥å°±åƒç»™Filebeatå¼€äº†ä¸€ä¸ª"ç½‘ç»œæ¥æ”¶å£"
- å…¶ä»–ç³»ç»Ÿå¯ä»¥é€šè¿‡ç½‘ç»œå‘é€æ—¥å¿—æ•°æ®ç»™Filebeat
- Filebeatåœ¨æŒ‡å®šç«¯å£ä¸Š"ç›‘å¬"ï¼Œç­‰å¾…æ•°æ®åˆ°æ¥
- æ”¶åˆ°æ•°æ®åï¼ŒæŒ‰ç…§é…ç½®è¿›è¡Œå¤„ç†å’Œè½¬å‘
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
åº”ç”¨æœåŠ¡å™¨ â†’ ç½‘ç»œ â†’ Filebeat â†’ Elasticsearch
     â†‘                    â†‘
   å‘é€æ—¥å¿—           ç›‘å¬ç«¯å£æ¥æ”¶
```

### 1.2 TCP vs UDP åŸºæœ¬åŒºåˆ«


| ç‰¹æ€§å¯¹æ¯” | **TCP** | **UDP** |
|---------|---------|---------|
| ğŸ”— **è¿æ¥æ–¹å¼** | `é¢å‘è¿æ¥ï¼Œéœ€è¦å»ºç«‹è¿æ¥` | `æ— è¿æ¥ï¼Œç›´æ¥å‘é€æ•°æ®` |
| ğŸ“¦ **å¯é æ€§** | `ä¿è¯æ•°æ®å®Œæ•´æ€§å’Œé¡ºåº` | `ä¸ä¿è¯æ•°æ®åˆ°è¾¾ï¼Œé€Ÿåº¦å¿«` |
| ğŸš€ **æ€§èƒ½** | `ç›¸å¯¹è¾ƒæ…¢ï¼Œå¼€é”€å¤§` | `é€Ÿåº¦å¿«ï¼Œå¼€é”€å°` |
| ğŸ’¼ **é€‚ç”¨åœºæ™¯** | `é‡è¦æ—¥å¿—ï¼Œä¸èƒ½ä¸¢å¤±` | `å¤§é‡æ—¥å¿—ï¼Œå…è®¸å°‘é‡ä¸¢å¤±` |

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦ç½‘ç»œè¾“å…¥


**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **é›†ä¸­æ”¶é›†**ï¼šå¤šä¸ªæœåŠ¡å™¨çš„æ—¥å¿—ç»Ÿä¸€å‘é€åˆ°ä¸€ä¸ªFilebeat
- **å®æ—¶ä¼ è¾“**ï¼šåº”ç”¨ç¨‹åºç›´æ¥é€šè¿‡ç½‘ç»œå‘é€æ—¥å¿—ï¼Œæ— éœ€å†™æ–‡ä»¶
- **å‡å°‘ç£ç›˜IO**ï¼šä¸éœ€è¦åœ¨æœ¬åœ°å†™æ—¥å¿—æ–‡ä»¶å†è¯»å–
- **ç®€åŒ–éƒ¨ç½²**ï¼šè¿œç¨‹æ—¥å¿—æ”¶é›†ï¼Œå‡å°‘æ¯å°æœºå™¨çš„agentéƒ¨ç½²

---

## 2. ğŸ”§ TCPè¾“å…¥é…ç½®è¯¦è§£


### 2.1 åŸºç¡€TCPç›‘å¬é…ç½®


**æœ€ç®€å•çš„TCPç›‘å¬é…ç½®**ï¼š
```yaml
# åŸºç¡€TCPè¾“å…¥é…ç½®
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"    # ç›‘å¬æ‰€æœ‰ç½‘å¡çš„9001ç«¯å£
  enabled: true
  
# è¾“å‡ºåˆ°æ§åˆ¶å°æŸ¥çœ‹æ•ˆæœ
output.console:
  pretty: true
```

**é…ç½®è¯´æ˜**ï¼š
- `type: tcp` - å‘Šè¯‰Filebeatè¿™æ˜¯TCPç±»å‹çš„è¾“å…¥
- `host: "0.0.0.0:9001"` - åœ¨9001ç«¯å£ç›‘å¬ï¼Œ0.0.0.0è¡¨ç¤ºæ‰€æœ‰ç½‘å¡
- `enabled: true` - å¯ç”¨è¿™ä¸ªè¾“å…¥æº

### 2.2 TCPé«˜çº§é…ç½®é€‰é¡¹


```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  enabled: true
  
  # è¿æ¥ç®¡ç†é…ç½®
  max_connections: 100        # æœ€å¤§å¹¶å‘è¿æ¥æ•°
  timeout: 30s               # è¿æ¥è¶…æ—¶æ—¶é—´
  
  # æ¶ˆæ¯åˆ†éš”é…ç½®
  framing: delimiter         # ä½¿ç”¨åˆ†éš”ç¬¦æ¨¡å¼
  delimiter: "\n"            # ä»¥æ¢è¡Œç¬¦åˆ†éš”æ¶ˆæ¯
  
  # ç¼“å†²åŒºé…ç½®
  max_message_size: 10MB     # å•æ¡æ¶ˆæ¯æœ€å¤§å¤§å°
  
  # å­—æ®µæ·»åŠ 
  fields:
    log_source: "tcp_input"
    environment: "production"
  fields_under_root: true
```

**é‡è¦å‚æ•°è§£é‡Š**ï¼š

**ğŸ”¸ max_connectionsï¼ˆæœ€å¤§è¿æ¥æ•°ï¼‰**
```
ä½œç”¨ï¼šé™åˆ¶åŒæ—¶è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡
å»ºè®®å€¼ï¼š
- å°å‹ç¯å¢ƒï¼š50-100
- ä¸­å‹ç¯å¢ƒï¼š100-500  
- å¤§å‹ç¯å¢ƒï¼š500-1000
```

**ğŸ”¸ timeoutï¼ˆè¶…æ—¶æ—¶é—´ï¼‰**
```
ä½œç”¨ï¼šå®¢æˆ·ç«¯è¿æ¥ç©ºé—²å¤šé•¿æ—¶é—´åæ–­å¼€
å»ºè®®å€¼ï¼š
- é¢‘ç¹æ—¥å¿—ï¼š30s-60s
- å¶å‘æ—¥å¿—ï¼š300s-600s
```

**ğŸ”¸ framingï¼ˆå¸§åˆ†å‰²æ–¹å¼ï¼‰**
```
delimiterï¼šä½¿ç”¨åˆ†éš”ç¬¦åˆ†å‰²æ¶ˆæ¯ï¼ˆæ¨èï¼‰
lengthï¼šä½¿ç”¨é•¿åº¦å‰ç¼€åˆ†å‰²æ¶ˆæ¯
```

### 2.3 TCPæ¶ˆæ¯å¤„ç†ç¤ºä¾‹


**æµ‹è¯•TCPè¾“å…¥**ï¼š
```bash
# å¯åŠ¨Filebeat
./filebeat -e -c tcp-config.yml

# å¦ä¸€ä¸ªç»ˆç«¯å‘é€æµ‹è¯•æ•°æ®
echo "è¿™æ˜¯ä¸€æ¡TCPæµ‹è¯•æ—¥å¿—" | nc localhost 9001
echo "ç¬¬äºŒæ¡TCPæ—¥å¿—æ¶ˆæ¯" | nc localhost 9001
```

**é¢„æœŸè¾“å‡ºæ•ˆæœ**ï¼š
```json
{
  "@timestamp": "2024-01-21T10:30:00.000Z",
  "message": "è¿™æ˜¯ä¸€æ¡TCPæµ‹è¯•æ—¥å¿—",
  "log_source": "tcp_input",
  "environment": "production",
  "host": {
    "name": "filebeat-server"
  }
}
```

---

## 3. ğŸ“¡ UDPè¾“å…¥é…ç½®è¯¦è§£


### 3.1 åŸºç¡€UDPç›‘å¬é…ç½®


**UDPè¾“å…¥é…ç½®ç¤ºä¾‹**ï¼š
```yaml
filebeat.inputs:
- type: udp
  host: "0.0.0.0:9002"    # UDPç›‘å¬ç«¯å£
  enabled: true
  
  # UDPç‰¹æœ‰é…ç½®
  max_message_size: 65507  # UDPæœ€å¤§åŒ…å¤§å°ï¼ˆç†è®ºå€¼65507å­—èŠ‚ï¼‰
  timeout: 30s             # è¯»å–è¶…æ—¶
  
  # å­—æ®µæ ‡è¯†
  fields:
    protocol: "udp"
    log_type: "syslog"
  fields_under_root: true

output.console:
  pretty: true
```

### 3.2 UDP vs TCP é…ç½®å¯¹æ¯”


```yaml
# TCPé…ç½®ç‰¹ç‚¹
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  max_connections: 100     # TCPéœ€è¦ç®¡ç†è¿æ¥
  timeout: 30s
  framing: delimiter       # TCPéœ€è¦æ¶ˆæ¯åˆ†å‰²
  delimiter: "\n"

# UDPé…ç½®ç‰¹ç‚¹  
- type: udp
  host: "0.0.0.0:9002"
  max_message_size: 65507  # UDPå…³æ³¨åŒ…å¤§å°
  timeout: 30s             # UDPè¯»å–è¶…æ—¶
  # æ³¨æ„ï¼šUDPæ²¡æœ‰è¿æ¥ç®¡ç†å’Œæ¶ˆæ¯åˆ†å‰²é…ç½®
```

**å…³é”®å·®å¼‚ç†è§£**ï¼š
- **TCP**ï¼šéœ€è¦ç®¡ç†è¿æ¥æ•°ã€æ¶ˆæ¯åˆ†å‰²
- **UDP**ï¼šå…³æ³¨åŒ…å¤§å°ã€è¯»å–è¶…æ—¶ï¼Œæ— è¿æ¥æ¦‚å¿µ

### 3.3 UDPæµ‹è¯•éªŒè¯


**å‘é€æµ‹è¯•æ•°æ®**ï¼š
```bash
# ä½¿ç”¨ncå‘½ä»¤å‘é€UDPæ•°æ®
echo "UDPæµ‹è¯•æ—¥å¿—æ¶ˆæ¯" | nc -u localhost 9002
echo "Syslog: è¿™æ˜¯ç³»ç»Ÿæ—¥å¿—" | nc -u localhost 9002

# ä½¿ç”¨Pythonå‘é€UDPæ•°æ®
python3 -c "
import socket
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.sendto(b'Python UDPæ—¥å¿—æµ‹è¯•', ('localhost', 9002))
sock.close()
"
```

---

## 4. ğŸ”’ SSL/TLSåŠ å¯†é…ç½®


### 4.1 SSLåŸºç¡€æ¦‚å¿µ


**ä¸ºä»€ä¹ˆéœ€è¦SSL**ï¼š
```
ç½‘ç»œä¼ è¾“å®‰å…¨é—®é¢˜ï¼š
- æ˜æ–‡ä¼ è¾“ï¼šæ—¥å¿—å†…å®¹å¯èƒ½è¢«çªƒå¬
- èº«ä»½éªŒè¯ï¼šç¡®ä¿è¿æ¥æ–¹æ˜¯å¯ä¿¡çš„
- æ•°æ®å®Œæ•´æ€§ï¼šé˜²æ­¢æ•°æ®è¢«ç¯¡æ”¹

SSL/TLSè§£å†³æ–¹æ¡ˆï¼š
- åŠ å¯†ä¼ è¾“ï¼šæ‰€æœ‰æ•°æ®åŠ å¯†åä¼ è¾“
- è¯ä¹¦éªŒè¯ï¼šéªŒè¯æœåŠ¡å™¨èº«ä»½
- å®Œæ•´æ€§æ ¡éªŒï¼šç¡®ä¿æ•°æ®æœªè¢«ä¿®æ”¹
```

### 4.2 SSLè¯ä¹¦å‡†å¤‡


**ç”Ÿæˆæµ‹è¯•è¯ä¹¦**ï¼š
```bash
# 1. ç”Ÿæˆç§é’¥
openssl genrsa -out filebeat.key 2048

# 2. ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚
openssl req -new -key filebeat.key -out filebeat.csr \
  -subj "/CN=filebeat-server"

# 3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl x509 -req -in filebeat.csr -signkey filebeat.key \
  -out filebeat.crt -days 365

# 4. éªŒè¯è¯ä¹¦
openssl x509 -in filebeat.crt -text -noout
```

### 4.3 TCP SSLé…ç½®


```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9443"
  enabled: true
  
  # SSL/TLSé…ç½®
  ssl.enabled: true
  ssl.certificate: "/path/to/filebeat.crt"
  ssl.key: "/path/to/filebeat.key"
  
  # SSLé«˜çº§é€‰é¡¹
  ssl.verification_mode: "full"     # éªŒè¯æ¨¡å¼ï¼šfull, certificate, none
  ssl.supported_protocols: ["TLSv1.2", "TLSv1.3"]
  ssl.cipher_suites: []             # ç©ºè¡¨ç¤ºä½¿ç”¨é»˜è®¤åŠ å¯†å¥—ä»¶
  
  # å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆåŒå‘è®¤è¯ï¼‰
  ssl.client_authentication: "optional"  # none, optional, required
  ssl.certificate_authorities: ["/path/to/ca.crt"]
  
  # è¿æ¥é…ç½®
  max_connections: 50
  timeout: 60s
  framing: delimiter
  delimiter: "\n"
  
  fields:
    transport: "tcp_ssl"
    security: "encrypted"
  fields_under_root: true
```

**SSLé…ç½®å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | **å«ä¹‰** | **å¯é€‰å€¼** |
|------|---------|-----------|
| `ssl.verification_mode` | `è¯ä¹¦éªŒè¯ä¸¥æ ¼ç¨‹åº¦` | `full(å®Œå…¨éªŒè¯), certificate(ä»…éªŒè¯è¯ä¹¦), none(ä¸éªŒè¯)` |
| `ssl.client_authentication` | `å®¢æˆ·ç«¯è®¤è¯è¦æ±‚` | `none(æ— éœ€), optional(å¯é€‰), required(å¿…éœ€)` |
| `ssl.supported_protocols` | `æ”¯æŒçš„TLSç‰ˆæœ¬` | `TLSv1.1, TLSv1.2, TLSv1.3` |

### 4.4 SSLè¿æ¥æµ‹è¯•


**ä½¿ç”¨opensslæµ‹è¯•è¿æ¥**ï¼š
```bash
# æµ‹è¯•SSLè¿æ¥
openssl s_client -connect localhost:9443 -verify_return_error

# å‘é€æµ‹è¯•æ•°æ®
echo "åŠ å¯†çš„æ—¥å¿—æ¶ˆæ¯" | openssl s_client -connect localhost:9443 -quiet
```

---

## 5. âœ‚ï¸ æ¶ˆæ¯åˆ†éš”ä¸è§£æ


### 5.1 æ¶ˆæ¯åˆ†éš”åŸç†


**ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯åˆ†éš”**ï¼š
```
ç½‘ç»œæµé—®é¢˜ï¼š
TCPæ˜¯å­—èŠ‚æµåè®®ï¼Œæ•°æ®è¿ç»­ä¼ è¾“
ä¾‹å¦‚å‘é€ä¸¤æ¡æ—¥å¿—ï¼š
"ç¬¬ä¸€æ¡æ—¥å¿—"+"ç¬¬äºŒæ¡æ—¥å¿—" â†’ "ç¬¬ä¸€æ¡æ—¥å¿—ç¬¬äºŒæ¡æ—¥å¿—"

è§£å†³æ–¹æ¡ˆï¼š
ä½¿ç”¨åˆ†éš”ç¬¦åŒºåˆ†ä¸åŒçš„æ—¥å¿—æ¶ˆæ¯
"ç¬¬ä¸€æ¡æ—¥å¿—\nç¬¬äºŒæ¡æ—¥å¿—\n" â†’ ["ç¬¬ä¸€æ¡æ—¥å¿—", "ç¬¬äºŒæ¡æ—¥å¿—"]
```

### 5.2 åˆ†éš”ç¬¦é…ç½®è¯¦è§£


```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  
  # æ–¹å¼1ï¼šä½¿ç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼ˆæœ€å¸¸ç”¨ï¼‰
  framing: delimiter
  delimiter: "\n"
  
- type: tcp
  host: "0.0.0.0:9002" 
  
  # æ–¹å¼2ï¼šä½¿ç”¨è‡ªå®šä¹‰åˆ†éš”ç¬¦
  framing: delimiter
  delimiter: "||"         # ä½¿ç”¨||ä½œä¸ºåˆ†éš”ç¬¦
  
- type: tcp
  host: "0.0.0.0:9003"
  
  # æ–¹å¼3ï¼šä½¿ç”¨é•¿åº¦å‰ç¼€ï¼ˆäºŒè¿›åˆ¶åè®®ï¼‰
  framing: length
  # æ³¨æ„ï¼šé•¿åº¦å‰ç¼€æ¨¡å¼é€‚ç”¨äºäºŒè¿›åˆ¶åè®®ï¼Œæ—¥å¿—è¾ƒå°‘ä½¿ç”¨
```

**å¸¸ç”¨åˆ†éš”ç¬¦é€‰æ‹©**ï¼š
- `\n` - æ¢è¡Œç¬¦ï¼ˆæœ€å¸¸ç”¨ï¼Œé€‚åˆæ–‡æœ¬æ—¥å¿—ï¼‰
- `\r\n` - Windowsæ¢è¡Œç¬¦  
- `\0` - ç©ºå­—ç¬¦ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
- è‡ªå®šä¹‰ - å¦‚`||`, `###`ç­‰

### 5.3 å¤šè¡Œæ¶ˆæ¯å¤„ç†


**Javaå¼‚å¸¸æ—¥å¿—é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  framing: delimiter
  delimiter: "\n"
  
  # å¤šè¡Œé…ç½® - å¤„ç†Javaå¼‚å¸¸å †æ ˆ
  multiline.type: pattern
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'  # ä»¥æ—¥æœŸå¼€å¤´çš„ä¸ºæ–°æ¶ˆæ¯
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500      # æœ€å¤§è¡Œæ•°é™åˆ¶
  multiline.timeout: 5s         # å¤šè¡Œè¶…æ—¶
```

**å¤šè¡Œé…ç½®è§£é‡Š**ï¼š
- `pattern` - æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ¨¡å¼
- `negate: true` - ä¸åŒ¹é…æ¨¡å¼çš„è¡Œ
- `match: after` - è¿½åŠ åˆ°å‰ä¸€æ¡æ¶ˆæ¯åé¢

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®


### 6.1 è¿æ¥æ± ä¼˜åŒ–


```yaml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  
  # è¿æ¥ç®¡ç†ä¼˜åŒ–
  max_connections: 200          # æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
  timeout: 300s                 # é•¿è¿æ¥é…ç½®
  
  # ç¼“å†²åŒºä¼˜åŒ–
  max_message_size: 50MB        # å•æ¡æ¶ˆæ¯æœ€å¤§å¤§å°
  
  # å¤„ç†å™¨ä¼˜åŒ–
  processors:
  - drop_fields:                # åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
      fields: ["agent", "ecs", "host.architecture"]
  - add_host_metadata:          # æ·»åŠ ä¸»æœºä¿¡æ¯
      when.not.contains.tags: "no_host_metadata"
```

### 6.2 ç½‘ç»œç¼“å†²åŒºè°ƒä¼˜


**æ“ä½œç³»ç»Ÿçº§åˆ«ä¼˜åŒ–**ï¼š
```bash
# æŸ¥çœ‹å½“å‰ç¼“å†²åŒºè®¾ç½®
sysctl net.core.rmem_max
sysctl net.core.wmem_max

# ä¼˜åŒ–ç½‘ç»œç¼“å†²åŒºï¼ˆéœ€è¦rootæƒé™ï¼‰
echo 'net.core.rmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 65536 134217728' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 4096 65536 134217728' >> /etc/sysctl.conf

# åº”ç”¨è®¾ç½®
sysctl -p
```

### 6.3 Filebeatè¿›ç¨‹ä¼˜åŒ–


```yaml
# filebeat.yml - å…¨å±€æ€§èƒ½é…ç½®
queue.mem:
  events: 8192              # å†…å­˜é˜Ÿåˆ—å¤§å°
  flush.min_events: 1024    # æœ€å°åˆ·æ–°äº‹ä»¶æ•°
  flush.timeout: 30s        # åˆ·æ–°è¶…æ—¶

output.elasticsearch:
  hosts: ["localhost:9200"]
  worker: 4                 # å¹¶å‘å·¥ä½œçº¿ç¨‹
  bulk_max_size: 1600       # æ‰¹é‡å‘é€å¤§å°
  flush_bytes: 10MB         # åˆ·æ–°å­—èŠ‚æ•°
  compression_level: 1      # å‹ç¼©çº§åˆ«

logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat.log
  keepfiles: 7
  permissions: 0644
```

---

## 7. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 7.1 åº”ç”¨æ—¥å¿—æ”¶é›†åœºæ™¯


**åœºæ™¯1ï¼šJavaåº”ç”¨æ—¥å¿—æ”¶é›†**
```yaml
# java-app-logs.yml
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  enabled: true
  
  # Javaåº”ç”¨ç‰¹å®šé…ç½®
  framing: delimiter
  delimiter: "\n"
  
  # å¤šè¡ŒJavaå¼‚å¸¸å¤„ç†
  multiline.type: pattern
  multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
  multiline.negate: true
  multiline.match: after
  multiline.timeout: 5s
  
  fields:
    app_name: "user-service"
    log_level: "application"
    environment: "production"
  fields_under_root: true
  
  processors:
  - dissect:
      tokenizer: "%{timestamp} %{level} %{logger} - %{message}"
      field: "message"
      target_prefix: "log"

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "java-app-logs-%{+yyyy.MM.dd}"
```

### 7.2 ç³»ç»Ÿç›‘æ§åœºæ™¯


**åœºæ™¯2ï¼šç³»ç»ŸæŒ‡æ ‡æ”¶é›†**
```yaml
# system-metrics.yml  
filebeat.inputs:
- type: udp
  host: "0.0.0.0:9002"
  enabled: true
  
  # ç³»ç»ŸæŒ‡æ ‡é…ç½®
  max_message_size: 1024    # æŒ‡æ ‡æ•°æ®è¾ƒå°
  timeout: 10s
  
  fields:
    data_type: "metrics"
    source_system: "monitoring"
  fields_under_root: true
  
  processors:
  - decode_json_fields:     # è§£æJSONæ ¼å¼çš„æŒ‡æ ‡æ•°æ®
      fields: ["message"]
      target: "metrics"
  - timestamp:              # å¤„ç†æ—¶é—´æˆ³
      field: "metrics.timestamp"
      layouts:
        - "2006-01-02T15:04:05.000Z"
      test:
        - "2024-01-21T10:30:00.000Z"

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "system-metrics-%{+yyyy.MM.dd}"
```

### 7.3 å¾®æœåŠ¡æ—¥å¿—èšåˆ


**åœºæ™¯3ï¼šå¾®æœåŠ¡æ¶æ„æ—¥å¿—æ”¶é›†**
```yaml
# microservices-logs.yml
filebeat.inputs:
# ç”¨æˆ·æœåŠ¡æ—¥å¿—
- type: tcp
  host: "0.0.0.0:9001"
  enabled: true
  framing: delimiter
  delimiter: "\n"
  fields:
    service_name: "user-service"
    service_port: "8080"
  
# è®¢å•æœåŠ¡æ—¥å¿—  
- type: tcp
  host: "0.0.0.0:9002"
  enabled: true
  framing: delimiter
  delimiter: "\n"
  fields:
    service_name: "order-service" 
    service_port: "8081"
    
# æ”¯ä»˜æœåŠ¡æ—¥å¿—
- type: tcp
  host: "0.0.0.0:9003"
  enabled: true
  framing: delimiter
  delimiter: "\n"
  fields:
    service_name: "payment-service"
    service_port: "8082"

# é€šç”¨å¤„ç†å™¨
processors:
- add_host_metadata: {}
- add_docker_metadata: {}
- dissect:
    tokenizer: "%{timestamp} [%{thread}] %{level} %{logger} - %{message}"
    field: "message"
    target_prefix: "app"

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "microservices-%{[service_name]}-%{+yyyy.MM.dd}"
```

---

## 8. ğŸ” æ•…éšœæ’æŸ¥æŒ‡å—


### 8.1 å¸¸è§é—®é¢˜è¯Šæ–­


**é—®é¢˜1ï¼šè¿æ¥è¢«æ‹’ç»**
```bash
# é”™è¯¯ä¿¡æ¯
connection refused to localhost:9001

# æ’æŸ¥æ­¥éª¤
1. æ£€æŸ¥Filebeatæ˜¯å¦æ­£å¸¸å¯åŠ¨
   ./filebeat test config -c your-config.yml
   ./filebeat test output -c your-config.yml

2. æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
   netstat -tlnp | grep 9001
   ss -tlnp | grep 9001

3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   firewall-cmd --list-ports
   ufw status
```

**é—®é¢˜2ï¼šæ¶ˆæ¯ä¸å®Œæ•´**
```yaml
# å¯èƒ½åŸå› ï¼šåˆ†éš”ç¬¦é…ç½®é”™è¯¯
# è§£å†³æ–¹æ¡ˆï¼šè°ƒæ•´åˆ†éš”ç¬¦é…ç½®
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  framing: delimiter
  delimiter: "\n"           # ç¡®ä¿ä¸å‘é€ç«¯ä¸€è‡´
  max_message_size: 10MB    # å¢å¤§æ¶ˆæ¯å¤§å°é™åˆ¶
```

**é—®é¢˜3ï¼šæ€§èƒ½é—®é¢˜**
```yaml
# ç—‡çŠ¶ï¼šå¤„ç†é€Ÿåº¦æ…¢ï¼Œè¿æ¥å †ç§¯
# è§£å†³æ–¹æ¡ˆï¼šä¼˜åŒ–é…ç½®
filebeat.inputs:
- type: tcp
  host: "0.0.0.0:9001"
  max_connections: 500      # å¢åŠ è¿æ¥æ•°
  timeout: 60s              # è°ƒæ•´è¶…æ—¶æ—¶é—´

# è¾“å‡ºä¼˜åŒ–
output.elasticsearch:
  worker: 8                 # å¢åŠ å·¥ä½œçº¿ç¨‹
  bulk_max_size: 3200       # å¢å¤§æ‰¹é‡å¤§å°
```

### 8.2 è°ƒè¯•æŠ€å·§


**å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼š
```yaml
# è°ƒè¯•é…ç½®
logging.level: debug
logging.selectors: ["tcp", "input"]

# è¾“å‡ºåˆ°æ§åˆ¶å°ä¾¿äºè°ƒè¯•
output.console:
  pretty: true
  enabled: true
```

**ç½‘ç»œæŠ“åŒ…åˆ†æ**ï¼š
```bash
# ä½¿ç”¨tcpdumpæŠ“åŒ…åˆ†æ
tcpdump -i any -s 0 -w filebeat-traffic.pcap port 9001

# ä½¿ç”¨Wiresharkåˆ†æåŒ…å†…å®¹
wireshark filebeat-traffic.pcap
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å…³é”®é…ç½®å¯¹æ¯”


| é…ç½®é¡¹ | **TCP** | **UDP** | **è¯´æ˜** |
|-------|---------|---------|----------|
| ğŸ”— **è¿æ¥ç®¡ç†** | `max_connections` | `æ— ` | `TCPéœ€è¦ç®¡ç†è¿æ¥æ•°` |
| ğŸ“¦ **æ¶ˆæ¯åˆ†å‰²** | `framing + delimiter` | `æ— ` | `TCPéœ€è¦åˆ†å‰²æ¶ˆæ¯` |
| ğŸ“ **å¤§å°é™åˆ¶** | `max_message_size` | `max_message_size` | `UDPå—åŒ…å¤§å°é™åˆ¶æ›´ä¸¥æ ¼` |
| ğŸ”’ **SSLæ”¯æŒ** | `æ”¯æŒ` | `ä¸æ”¯æŒ` | `UDPä¸æ”¯æŒSSLåŠ å¯†` |
| ğŸš€ **æ€§èƒ½** | `è¿æ¥å¼€é”€å¤§` | `ä¼ è¾“æ•ˆç‡é«˜` | `æ ¹æ®åœºæ™¯é€‰æ‹©` |

### 9.2 é…ç½®é€‰æ‹©æŒ‡å—


**é€‰æ‹©TCPçš„åœºæ™¯**ï¼š
- âœ… é‡è¦æ—¥å¿—ï¼Œä¸èƒ½ä¸¢å¤±
- âœ… éœ€è¦SSLåŠ å¯†ä¼ è¾“
- âœ… æ¶ˆæ¯è¾ƒå¤§æˆ–éœ€è¦åˆ†å‰²
- âœ… è¿æ¥æ•°å¯æ§çš„ç¯å¢ƒ

**é€‰æ‹©UDPçš„åœºæ™¯**ï¼š
- âœ… å¤§é‡æ—¥å¿—ï¼Œå…è®¸å°‘é‡ä¸¢å¤±
- âœ… å¯¹ä¼ è¾“é€Ÿåº¦è¦æ±‚é«˜
- âœ… æ¶ˆæ¯è¾ƒå°ï¼ˆ<64KBï¼‰
- âœ… ç³»ç»Ÿç›‘æ§æŒ‡æ ‡æ”¶é›†

### 9.3 æœ€ä½³å®è·µè¦ç‚¹


**ğŸ”¸ å®‰å…¨é…ç½®**
```
ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
- å¯ç”¨SSL/TLSåŠ å¯†
- é…ç½®å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯
- é™åˆ¶è¿æ¥æ¥æºIP
- å®šæœŸæ›´æ–°è¯ä¹¦
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–**
```
å…³é”®é…ç½®ç‚¹ï¼š
- åˆç†è®¾ç½®max_connections
- è°ƒæ•´æ¶ˆæ¯å¤§å°é™åˆ¶
- ä¼˜åŒ–æ‰¹é‡å‘é€å‚æ•°
- ç›‘æ§é˜Ÿåˆ—çŠ¶æ€
```

**ğŸ”¸ ç›‘æ§å‘Šè­¦**
```
é‡è¦æŒ‡æ ‡ï¼š
- è¿æ¥æ•°ä½¿ç”¨ç‡
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
- é”™è¯¯è¿æ¥ç‡  
- ç½‘ç»œæµé‡ç›‘æ§
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- TCPå¯é ä½†æ…¢ï¼ŒUDPå¿«é€Ÿä½†å¯èƒ½ä¸¢å¤±
- SSLé…ç½®éœ€è¦è¯ä¹¦ï¼Œä»…TCPæ”¯æŒ
- æ¶ˆæ¯åˆ†å‰²å¾ˆé‡è¦ï¼Œé¿å…æ•°æ®ç²˜è¿
- æ€§èƒ½è°ƒä¼˜é‡ç‚¹åœ¨è¿æ¥æ•°å’Œæ‰¹é‡å¤„ç†
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘å®‰å…¨å’Œç›‘æ§