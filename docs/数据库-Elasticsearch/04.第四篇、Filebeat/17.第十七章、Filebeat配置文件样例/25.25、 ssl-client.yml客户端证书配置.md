---
title: 25ã€ ssl-client.ymlå®¢æˆ·ç«¯è¯ä¹¦é…ç½®
---
## ğŸ“š ç›®å½•

1. [SSLå®¢æˆ·ç«¯è¯ä¹¦åŸºç¡€æ¦‚å¿µ](#1-sslå®¢æˆ·ç«¯è¯ä¹¦åŸºç¡€æ¦‚å¿µ)
2. [å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶é…ç½®](#2-å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶é…ç½®)
3. [è¯ä¹¦å¯†ç å’ŒåŠ å¯†é…ç½®](#3-è¯ä¹¦å¯†ç å’ŒåŠ å¯†é…ç½®)
4. [åŒå‘è®¤è¯é…ç½®è¯¦è§£](#4-åŒå‘è®¤è¯é…ç½®è¯¦è§£)
5. [è¯ä¹¦ç®¡ç†ä¸å®‰å…¨è®¾ç½®](#5-è¯ä¹¦ç®¡ç†ä¸å®‰å…¨è®¾ç½®)
6. [å®æˆ˜é…ç½®æ ·ä¾‹](#6-å®æˆ˜é…ç½®æ ·ä¾‹)
7. [æ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ](#7-æ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SSLå®¢æˆ·ç«¯è¯ä¹¦åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯SSLå®¢æˆ·ç«¯è¯ä¹¦


**ğŸ’¡ é€šä¿—ç†è§£**

æƒ³è±¡ä¸€ä¸‹ï¼ŒSSLå®¢æˆ·ç«¯è¯ä¹¦å°±åƒæ˜¯ä½ çš„**æ•°å­—èº«ä»½è¯**ï¼š

```
ä¼ ç»Ÿåœºæ™¯ï¼š           æ•°å­—ä¸–ç•Œï¼š
å»é“¶è¡ŒåŠäº‹         â”€â”€â†’  Filebeatè¿æ¥Elasticsearch
éœ€è¦èº«ä»½è¯          â”€â”€â†’  éœ€è¦å®¢æˆ·ç«¯è¯ä¹¦
é“¶è¡ŒéªŒè¯èº«ä»½        â”€â”€â†’  æœåŠ¡å™¨éªŒè¯è¯ä¹¦
ç¡®è®¤æ˜¯æœ¬äºº          â”€â”€â†’  ç¡®è®¤æ˜¯åˆæ³•å®¢æˆ·ç«¯
```

**ğŸ” æ ¸å¿ƒä½œç”¨**
- **èº«ä»½éªŒè¯**ï¼šè¯æ˜Filebeatæ˜¯å¯ä¿¡ä»»çš„å®¢æˆ·ç«¯
- **æ•°æ®åŠ å¯†**ï¼šä¿æŠ¤ä¼ è¾“è¿‡ç¨‹ä¸­çš„æ—¥å¿—æ•°æ®
- **è®¿é—®æ§åˆ¶**ï¼šåªæœ‰æŒæœ‰æ­£ç¡®è¯ä¹¦çš„å®¢æˆ·ç«¯æ‰èƒ½è¿æ¥
- **é˜²æ­¢å†’å……**ï¼šé¿å…æ¶æ„ç¨‹åºä¼ªè£…æˆFilebeat

### 1.2 SSLè®¤è¯ç±»å‹å¯¹æ¯”


| è®¤è¯ç±»å‹ | **å·¥ä½œåŸç†** | **å®‰å…¨çº§åˆ«** | **ä½¿ç”¨åœºæ™¯** |
|---------|------------|-------------|-------------|
| ğŸ”“ **æ— è®¤è¯** | `ç›´æ¥è¿æ¥ï¼Œæ— éªŒè¯` | `å¾ˆä½` | `æµ‹è¯•ç¯å¢ƒ` |
| ğŸ”’ **å•å‘è®¤è¯** | `åªéªŒè¯æœåŠ¡å™¨è¯ä¹¦` | `ä¸­ç­‰` | `ä¸€èˆ¬åº”ç”¨` |
| ğŸ” **åŒå‘è®¤è¯** | `å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº’ç›¸éªŒè¯` | `å¾ˆé«˜` | `ä¼ä¸šçº§å®‰å…¨` |

### 1.3 è¯ä¹¦æ–‡ä»¶ç±»å‹è¯´æ˜


**ğŸ“‹ å¸¸è§è¯ä¹¦æ ¼å¼**

```
è¯ä¹¦æ–‡ä»¶ç±»å‹è¯¦è§£ï¼š

ğŸ”¸ .crt/.ceræ–‡ä»¶ï¼š
â€¢ ä½œç”¨ï¼šå­˜å‚¨å…¬é’¥è¯ä¹¦
â€¢ å†…å®¹ï¼šæ•°å­—ç­¾åã€å…¬é’¥ä¿¡æ¯
â€¢ ç±»æ¯”ï¼šå°±åƒèº«ä»½è¯ä¸Šçš„ç…§ç‰‡å’Œä¿¡æ¯

ğŸ”¸ .keyæ–‡ä»¶ï¼š
â€¢ ä½œç”¨ï¼šå­˜å‚¨ç§é’¥
â€¢ å†…å®¹ï¼šåŠ å¯†è§£å¯†çš„å…³é”®ä¿¡æ¯  
â€¢ ç±»æ¯”ï¼šå°±åƒä½ çš„ç­¾åï¼Œåªæœ‰ä½ ä¼šå†™

ğŸ”¸ .p12/.pfxæ–‡ä»¶ï¼š
â€¢ ä½œç”¨ï¼šåŒæ—¶åŒ…å«è¯ä¹¦å’Œç§é’¥
â€¢ å†…å®¹ï¼šæ‰“åŒ…çš„å®Œæ•´è¯ä¹¦ä¿¡æ¯
â€¢ ç±»æ¯”ï¼šå°±åƒæŠ¤ç…§ï¼ŒåŒ…å«æ‰€æœ‰èº«ä»½ä¿¡æ¯
```

---

## 2. ğŸ“ å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶é…ç½®


### 2.1 åŸºç¡€è¯ä¹¦æ–‡ä»¶é…ç½®


**ğŸ”§ é…ç½®ç»“æ„è¯´æ˜**

```yaml
# 25-ssl-client.yml - åŸºç¡€å®¢æˆ·ç«¯è¯ä¹¦é…ç½®
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  
  # å®¢æˆ·ç«¯è¯ä¹¦é…ç½®
  ssl:
    certificate: "/etc/filebeat/certs/client.crt"     # å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶
    key: "/etc/filebeat/certs/client.key"            # å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]  # CAæ ¹è¯ä¹¦
```

**ğŸ’­ é…ç½®å«ä¹‰è§£é‡Š**

> **ğŸ“Œ é‡è¦ç†è§£**
> 
> - `certificate`ï¼šä½ çš„èº«ä»½è¯æ˜æ–‡ä»¶
> - `key`ï¼šä½ çš„ç§äººç­¾åå·¥å…·  
> - `certificate_authorities`ï¼šå¯ä¿¡ä»»çš„å‘è¯æœºæ„

### 2.2 è¯ä¹¦è·¯å¾„é…ç½®è¯¦è§£


**ğŸ“‚ è¯ä¹¦æ–‡ä»¶å­˜å‚¨è§„åˆ’**

```
æ¨èçš„è¯ä¹¦ç›®å½•ç»“æ„ï¼š

/etc/filebeat/certs/
â”œâ”€â”€ ca.crt              # CAæ ¹è¯ä¹¦ï¼ˆéªŒè¯æœåŠ¡å™¨ï¼‰
â”œâ”€â”€ client.crt          # å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆèº«ä»½è¯æ˜ï¼‰
â”œâ”€â”€ client.key          # å®¢æˆ·ç«¯ç§é’¥ï¼ˆç§äººå¯†é’¥ï¼‰
â””â”€â”€ client.p12          # PKCS#12æ ¼å¼è¯ä¹¦ï¼ˆå¯é€‰ï¼‰

æƒé™è®¾ç½®ï¼š
â€¢ ca.crt: 644 (æ‰€æœ‰äººå¯è¯»)
â€¢ client.crt: 644 (æ‰€æœ‰äººå¯è¯»)  
â€¢ client.key: 600 (ä»…æ‰€æœ‰è€…å¯è¯»å†™)
```

**âš™ï¸ ç»å¯¹è·¯å¾„ vs ç›¸å¯¹è·¯å¾„**

```yaml
# æ¨èä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆæ›´å®‰å…¨å¯é ï¼‰
ssl:
  certificate: "/etc/filebeat/certs/client.crt"
  key: "/etc/filebeat/certs/client.key"

# ç›¸å¯¹è·¯å¾„ï¼ˆä¸æ¨èï¼Œå®¹æ˜“å‡ºé”™ï¼‰
ssl:
  certificate: "./certs/client.crt"  # ç›¸å¯¹äºfilebeatè¿è¡Œç›®å½•
  key: "./certs/client.key"
```

### 2.3 å¤šè¯ä¹¦é…ç½®


**ğŸ”„ è¯ä¹¦è½®æ¢é…ç½®**

```yaml
# æ”¯æŒå¤šä¸ªè¯ä¹¦æ–‡ä»¶ï¼ˆç”¨äºè¯ä¹¦è½®æ¢ï¼‰
output.elasticsearch:
  hosts: ["https://es-node1:9200", "https://es-node2:9200"]
  
  ssl:
    # ä¸»è¯ä¹¦é…ç½®
    certificate: "/etc/filebeat/certs/client-primary.crt"
    key: "/etc/filebeat/certs/client-primary.key"
    
    # CAè¯ä¹¦é“¾ï¼ˆæ”¯æŒå¤šä¸ªCAï¼‰
    certificate_authorities: 
      - "/etc/filebeat/certs/ca-root.crt"
      - "/etc/filebeat/certs/ca-intermediate.crt"
```

---

## 3. ğŸ”‘ è¯ä¹¦å¯†ç å’ŒåŠ å¯†é…ç½®


### 3.1 ç§é’¥å¯†ç é…ç½®


**ğŸ” åŠ å¯†ç§é’¥å¤„ç†**

å¾ˆå¤šæ—¶å€™ï¼Œä¸ºäº†å®‰å…¨ï¼Œç§é’¥æ–‡ä»¶æ˜¯ç”¨å¯†ç åŠ å¯†çš„ï¼Œå°±åƒç»™ä½ çš„ä¿é™©ç®±è®¾ç½®å¯†ç ä¸€æ ·ã€‚

```yaml
# ç§é’¥æœ‰å¯†ç ä¿æŠ¤çš„é…ç½®
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  
  ssl:
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    key_passphrase: "your-private-key-password"  # ç§é’¥å¯†ç 
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
```

**ğŸ”’ PKCS#12æ ¼å¼è¯ä¹¦é…ç½®**

```yaml
# ä½¿ç”¨PKCS#12æ ¼å¼ï¼ˆåŒ…å«è¯ä¹¦å’Œç§é’¥çš„æ‰“åŒ…æ–‡ä»¶ï¼‰
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  
  ssl:
    certificate: "/etc/filebeat/certs/client.p12"
    key_passphrase: "pkcs12-password"  # PKCS#12æ–‡ä»¶å¯†ç 
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
```

### 3.2 è¯ä¹¦æ ¼å¼è®¾ç½®


**ğŸ“„ æ”¯æŒçš„è¯ä¹¦æ ¼å¼**

```yaml
# æ˜ç¡®æŒ‡å®šè¯ä¹¦æ ¼å¼ï¼ˆé€šå¸¸è‡ªåŠ¨è¯†åˆ«ï¼‰
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  
  ssl:
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    
    # è¯ä¹¦æ ¼å¼é…ç½®ï¼ˆå¯é€‰ï¼‰
    verification_mode: "certificate"  # éªŒè¯æ¨¡å¼
    cipher_suites: []                  # åŠ å¯†å¥—ä»¶ï¼ˆä½¿ç”¨é»˜è®¤ï¼‰
```

**ğŸ” éªŒè¯æ¨¡å¼è¯´æ˜**

| éªŒè¯æ¨¡å¼ | **è¯´æ˜** | **å®‰å…¨æ€§** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-----------|-------------|
| `none` | `ä¸éªŒè¯è¯ä¹¦` | `å¾ˆä½` | `æµ‹è¯•ç¯å¢ƒ` |
| `certificate` | `éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§` | `ä¸­ç­‰` | `å¼€å‘ç¯å¢ƒ` |
| `full` | `å®Œæ•´éªŒè¯ï¼ˆæ¨èï¼‰` | `å¾ˆé«˜` | `ç”Ÿäº§ç¯å¢ƒ` |

---

## 4. ğŸ¤ åŒå‘è®¤è¯é…ç½®è¯¦è§£


### 4.1 åŒå‘è®¤è¯åŸç†


**ğŸ’­ åŒå‘è®¤è¯å·¥ä½œæµç¨‹**

```
åŒå‘SSLè®¤è¯è¿‡ç¨‹ï¼ˆå°±åƒä¸¤ä¸ªäººç›¸äº’éªŒè¯èº«ä»½ï¼‰ï¼š

æ­¥éª¤1: Filebeat â†’ Elasticsearch
"æˆ‘æ˜¯åˆæ³•çš„æ—¥å¿—æ”¶é›†å™¨ï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦"

æ­¥éª¤2: Elasticsearch â†’ Filebeat  
"æˆ‘éªŒè¯äº†ä½ çš„èº«ä»½ï¼Œè¿™æ˜¯æˆ‘çš„æœåŠ¡å™¨è¯ä¹¦"

æ­¥éª¤3: åŒæ–¹ç¡®è®¤
"æˆ‘ä»¬éƒ½éªŒè¯äº†å¯¹æ–¹èº«ä»½ï¼Œå¼€å§‹å®‰å…¨é€šä¿¡"

               Filebeat                    Elasticsearch
                  |                            |
        [1] å‘é€å®¢æˆ·ç«¯è¯ä¹¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  |
                  |                            |
                  |  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [2] å‘é€æœåŠ¡å™¨è¯ä¹¦
                  |                            |
        [3] éªŒè¯æœåŠ¡å™¨è¯ä¹¦                     [4] éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
                  |                            |
        [5] å»ºç«‹åŠ å¯†é€šé“ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [6] å»ºç«‹åŠ å¯†é€šé“
```

### 4.2 å®Œæ•´åŒå‘è®¤è¯é…ç½®


**ğŸ”§ ç”Ÿäº§ç¯å¢ƒåŒå‘è®¤è¯é…ç½®**

```yaml
# 25-ssl-client.yml - å®Œæ•´åŒå‘è®¤è¯é…ç½®
filebeat.inputs:
- type: log
  paths:
    - /var/log/applications/*.log
  fields:
    environment: production
    service: web-app

output.elasticsearch:
  hosts: ["https://es-cluster-01:9200", "https://es-cluster-02:9200"]
  
  # å®Œæ•´çš„åŒå‘SSLè®¤è¯é…ç½®
  ssl:
    # === å®¢æˆ·ç«¯èº«ä»½è®¤è¯ ===
    certificate: "/etc/filebeat/certs/filebeat-client.crt"
    key: "/etc/filebeat/certs/filebeat-client.key"
    key_passphrase: "${FILEBEAT_KEY_PASSWORD}"  # ä»ç¯å¢ƒå˜é‡è¯»å–å¯†ç 
    
    # === æœåŠ¡å™¨èº«ä»½éªŒè¯ ===
    certificate_authorities: 
      - "/etc/filebeat/certs/elasticsearch-ca.crt"
    
    # === å®‰å…¨é€‰é¡¹ ===
    verification_mode: "full"              # å®Œæ•´éªŒè¯
    supported_protocols: ["TLSv1.2", "TLSv1.3"]  # æ”¯æŒçš„TLSç‰ˆæœ¬
    
    # === é«˜çº§å®‰å…¨é…ç½® ===
    renegotiation: "never"                 # ç¦ç”¨é‡æ–°åå•†
    curve_types: ["P-256", "P-384"]        # æ¤­åœ†æ›²çº¿ç±»å‹

# å®‰å…¨æ—¥å¿—é…ç½®
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0600  # ä»…æ‰€æœ‰è€…å¯è¯»å†™
```

### 4.3 ç¯å¢ƒå˜é‡å®‰å…¨é…ç½®


**ğŸ” å¯†ç å®‰å…¨ç®¡ç†**

```bash
# ç¯å¢ƒå˜é‡è®¾ç½®æ–‡ä»¶ /etc/systemd/system/filebeat.service.d/security.conf
[Service]
Environment="FILEBEAT_KEY_PASSWORD=your-secure-password"
Environment="ES_HOSTS=https://es1:9200,https://es2:9200"

# æˆ–è€…ä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿ
Environment="FILEBEAT_KEY_PASSWORD_FILE=/run/secrets/filebeat_key_password"
```

```yaml
# åœ¨filebeat.ymlä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡
output.elasticsearch:
  hosts: ["${ES_HOSTS}"]
  ssl:
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    key_passphrase: "${FILEBEAT_KEY_PASSWORD}"
```

---

## 5. ğŸ›¡ï¸ è¯ä¹¦ç®¡ç†ä¸å®‰å…¨è®¾ç½®


### 5.1 è¯ä¹¦è‡ªåŠ¨ç»­æœŸé…ç½®


**ğŸ”„ è¯ä¹¦ç›‘æ§ä¸ç»­æœŸ**

```yaml
# è¯ä¹¦ç›‘æ§é…ç½®
output.elasticsearch:
  hosts: ["https://elasticsearch:9200"]
  
  ssl:
    certificate: "/etc/filebeat/certs/client.crt"
    key: "/etc/filebeat/certs/client.key"
    certificate_authorities: ["/etc/filebeat/certs/ca.crt"]
    
    # è¯ä¹¦è¿‡æœŸæ£€æŸ¥
    verification_mode: "full"
    
# å¯ä»¥é€šè¿‡å¤–éƒ¨è„šæœ¬ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´
# ç¤ºä¾‹ç›‘æ§è„šæœ¬ä¼šæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸå¹¶åœ¨åˆ°æœŸå‰è‡ªåŠ¨ç»­æœŸ
```

**ğŸ“‹ è¯ä¹¦ç»­æœŸæ£€æŸ¥è„šæœ¬**

```bash
#!/bin/bash
# è¯ä¹¦è¿‡æœŸæ£€æŸ¥è„šæœ¬ check_cert_expiry.sh

CERT_FILE="/etc/filebeat/certs/client.crt"
DAYS_WARNING=30  # 30å¤©å†…è¿‡æœŸåˆ™è­¦å‘Š

# æ£€æŸ¥è¯ä¹¦è¿‡æœŸæ—¶é—´
EXPIRY_DATE=$(openssl x509 -in "$CERT_FILE" -noout -enddate | cut -d= -f2)
EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s)
CURRENT_TIMESTAMP=$(date +%s)
DAYS_TO_EXPIRY=$(( ($EXPIRY_TIMESTAMP - $CURRENT_TIMESTAMP) / 86400 ))

if [ $DAYS_TO_EXPIRY -lt $DAYS_WARNING ]; then
    echo "è­¦å‘Šï¼šè¯ä¹¦å°†åœ¨ $DAYS_TO_EXPIRY å¤©å†…è¿‡æœŸï¼"
    # è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªåŠ¨ç»­æœŸé€»è¾‘æˆ–å‘é€å‘Šè­¦
fi
```

### 5.2 æƒé™å®‰å…¨è®¾ç½®


**ğŸ”’ æ–‡ä»¶æƒé™æœ€ä½³å®è·µ**

```bash
# è®¾ç½®æ­£ç¡®çš„è¯ä¹¦æ–‡ä»¶æƒé™
sudo chown root:filebeat /etc/filebeat/certs/client.crt
sudo chown root:filebeat /etc/filebeat/certs/client.key
sudo chown root:filebeat /etc/filebeat/certs/ca.crt

# è®¾ç½®å®‰å…¨æƒé™
sudo chmod 644 /etc/filebeat/certs/client.crt    # è¯ä¹¦å¯ä»¥è¢«è¯»å–
sudo chmod 600 /etc/filebeat/certs/client.key    # ç§é’¥ä»…æ‰€æœ‰è€…å¯è¯»
sudo chmod 644 /etc/filebeat/certs/ca.crt        # CAè¯ä¹¦å¯ä»¥è¢«è¯»å–

# è®¾ç½®ç›®å½•æƒé™
sudo chmod 755 /etc/filebeat/certs               # ç›®å½•å¯ä»¥è¢«è®¿é—®
```

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**

> **ğŸš¨ é‡è¦å®‰å…¨æé†’**
> 
> - **ç§é’¥æ–‡ä»¶**ç»å¯¹ä¸èƒ½ç»™å…¶ä»–ç”¨æˆ·è¯»å–æƒé™
> - **è¯ä¹¦å¯†ç **ä¸è¦ç¡¬ç¼–ç åœ¨é…ç½®æ–‡ä»¶ä¸­
> - **å®šæœŸæ£€æŸ¥**è¯ä¹¦è¿‡æœŸæ—¶é—´
> - **å¤‡ä»½è¯ä¹¦**ä½†è¦ç¡®ä¿å¤‡ä»½çš„å®‰å…¨æ€§

---

## 6. ğŸ¯ å®æˆ˜é…ç½®æ ·ä¾‹


### 6.1 ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒé…ç½®


```yaml
# 25-ssl-client-production.yml - ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®
# ===============================================
# Filebeat SSLå®¢æˆ·ç«¯è¯ä¹¦ç”Ÿäº§ç¯å¢ƒé…ç½®
# ===============================================

# å…¨å±€é…ç½®
name: "filebeat-prod-web-01"
tags: ["production", "web-server", "ssl-enabled"]

# è¾“å…¥é…ç½®
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/access.log
    - /var/log/nginx/error.log
    - /var/log/applications/*.log
  fields:
    environment: production
    datacenter: dc-east-1
    server_role: web
  fields_under_root: false
  scan_frequency: 10s
  close_inactive: 5m

# Elasticsearchè¾“å‡ºé…ç½®ï¼ˆåŒå‘SSLè®¤è¯ï¼‰
output.elasticsearch:
  hosts: 
    - "https://es-master-01.company.com:9200"
    - "https://es-master-02.company.com:9200"
    - "https://es-master-03.company.com:9200"
  
  # ç´¢å¼•é…ç½®
  index: "filebeat-prod-web-%{+yyyy.MM.dd}"
  template.name: "filebeat-prod"
  template.pattern: "filebeat-prod-*"
  
  # SSLåŒå‘è®¤è¯é…ç½®
  ssl:
    # å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
    certificate: "/etc/filebeat/ssl/certs/filebeat-client.crt"
    key: "/etc/filebeat/ssl/private/filebeat-client.key"
    key_passphrase: "${FILEBEAT_SSL_KEY_PASSWORD}"
    
    # æœåŠ¡å™¨è¯ä¹¦éªŒè¯
    certificate_authorities: 
      - "/etc/filebeat/ssl/ca/elasticsearch-ca.crt"
      - "/etc/filebeat/ssl/ca/company-root-ca.crt"
    
    # å®‰å…¨åè®®é…ç½®
    verification_mode: "full"
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
    cipher_suites:
      - "ECDHE-RSA-AES256-GCM-SHA384"
      - "ECDHE-RSA-AES128-GCM-SHA256"
    
    # é«˜çº§å®‰å…¨é€‰é¡¹
    renegotiation: "never"
    curve_types: ["P-256", "P-384", "P-521"]
  
  # è¿æ¥é…ç½®
  worker: 3
  bulk_max_size: 1000
  timeout: 90s
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s

# æ—¥å¿—é…ç½®
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 10
  permissions: 0600
  interval: 24h

# ç›‘æ§é…ç½®
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["https://monitoring-es.company.com:9200"]
  ssl:
    certificate_authorities: ["/etc/filebeat/ssl/ca/monitoring-ca.crt"]
    verification_mode: "certificate"

# æ€§èƒ½ä¼˜åŒ–
queue.mem:
  events: 4096
  flush.min_events: 512
  flush.timeout: 1s

# å¤„ç†å™¨é…ç½®
processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
- add_cloud_metadata: ~
- add_docker_metadata: ~
```

### 6.2 å¼€å‘ç¯å¢ƒç®€åŒ–é…ç½®


```yaml
# 25-ssl-client-development.yml - å¼€å‘ç¯å¢ƒç®€åŒ–é…ç½®
# ===============================================
# Filebeat SSLå®¢æˆ·ç«¯è¯ä¹¦å¼€å‘ç¯å¢ƒé…ç½®
# ===============================================

filebeat.inputs:
- type: log
  paths:
    - /var/log/myapp/*.log
  fields:
    environment: development
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after

output.elasticsearch:
  hosts: ["https://dev-elasticsearch:9200"]
  index: "filebeat-dev-%{+yyyy.MM.dd}"
  
  # å¼€å‘ç¯å¢ƒSSLé…ç½®ï¼ˆç›¸å¯¹å®½æ¾ï¼‰
  ssl:
    certificate: "/etc/filebeat/certs/dev-client.crt"
    key: "/etc/filebeat/certs/dev-client.key"
    certificate_authorities: ["/etc/filebeat/certs/dev-ca.crt"]
    verification_mode: "certificate"  # è¾ƒå®½æ¾çš„éªŒè¯
    supported_protocols: ["TLSv1.2", "TLSv1.3"]

logging.level: debug
logging.to_stderr: true
```

### 6.3 Dockerå®¹å™¨ç¯å¢ƒé…ç½®


```yaml
# 25-ssl-client-docker.yml - Dockerå®¹å™¨ç¯å¢ƒé…ç½®
# ===============================================
# Filebeat SSLå®¢æˆ·ç«¯è¯ä¹¦Dockerç¯å¢ƒé…ç½®
# ===============================================

filebeat.inputs:
- type: container
  paths:
    - /var/lib/docker/containers/*/*.log
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"

output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS}"]
  
  ssl:
    # Dockerå®¹å™¨ä¸­çš„è¯ä¹¦è·¯å¾„
    certificate: "/usr/share/filebeat/certs/client.crt"
    key: "/usr/share/filebeat/certs/client.key"
    certificate_authorities: ["/usr/share/filebeat/certs/ca.crt"]
    verification_mode: "${SSL_VERIFICATION_MODE:full}"
    
    # ä»ç¯å¢ƒå˜é‡è¯»å–ç§é’¥å¯†ç 
    key_passphrase: "${SSL_KEY_PASSWORD}"

# Dockerç‰¹å®šé…ç½®
processors:
- add_cloud_metadata: ~
- add_docker_metadata:
    host: "unix:///var/run/docker.sock"
- decode_json_fields:
    fields: ["message"]
    target: ""
    overwrite_keys: true
```

---

## 7. ğŸ”§ æ•…éšœæ’æŸ¥ä¸æœ€ä½³å®è·µ


### 7.1 å¸¸è§SSLé”™è¯¯å¤„ç†


**âŒ å¸¸è§é”™è¯¯ç±»å‹åŠè§£å†³æ–¹æ¡ˆ**

```bash
# é”™è¯¯1ï¼šè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨
Error: "failed to load SSL certificate: open /path/to/cert.crt: no such file or directory"

è§£å†³æ–¹æ¡ˆï¼š
â€¢ æ£€æŸ¥è¯ä¹¦æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
â€¢ ç¡®è®¤è¯ä¹¦æ–‡ä»¶ç¡®å®å­˜åœ¨
â€¢ æ£€æŸ¥Filebeatç”¨æˆ·æ˜¯å¦æœ‰æ–‡ä»¶è¯»å–æƒé™
```

```bash
# é”™è¯¯2ï¼šç§é’¥æƒé™é—®é¢˜  
Error: "private key file permissions are too open"

è§£å†³æ–¹æ¡ˆï¼š
sudo chmod 600 /etc/filebeat/certs/client.key
sudo chown filebeat:filebeat /etc/filebeat/certs/client.key
```

```bash
# é”™è¯¯3ï¼šè¯ä¹¦ä¸ç§é’¥ä¸åŒ¹é…
Error: "tls: private key does not match public key"

è§£å†³æ–¹æ¡ˆï¼š
â€¢ ç¡®è®¤è¯ä¹¦å’Œç§é’¥æ˜¯é…å¯¹ç”Ÿæˆçš„
â€¢ æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦æŸå
â€¢ é‡æ–°ç”Ÿæˆè¯ä¹¦å¯¹
```

**ğŸ” SSLè¿æ¥æµ‹è¯•æ–¹æ³•**

```bash
# 1. ä½¿ç”¨opensslæµ‹è¯•SSLè¿æ¥
openssl s_client -connect elasticsearch:9200 \
  -cert /etc/filebeat/certs/client.crt \
  -key /etc/filebeat/certs/client.key \
  -CAfile /etc/filebeat/certs/ca.crt

# 2. æ£€æŸ¥è¯ä¹¦ä¿¡æ¯
openssl x509 -in /etc/filebeat/certs/client.crt -text -noout

# 3. éªŒè¯è¯ä¹¦é“¾
openssl verify -CAfile /etc/filebeat/certs/ca.crt /etc/filebeat/certs/client.crt
```

### 7.2 SSLé…ç½®æœ€ä½³å®è·µ


**ğŸ“‹ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**

- [ ] **è¯ä¹¦æ–‡ä»¶æƒé™**ï¼šç§é’¥600ï¼Œè¯ä¹¦644
- [ ] **å¯†ç ç®¡ç†**ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œä¸ç¡¬ç¼–ç 
- [ ] **è¯ä¹¦è¿‡æœŸ**ï¼šè®¾ç½®ç›‘æ§ï¼Œæå‰ç»­æœŸ
- [ ] **åè®®ç‰ˆæœ¬**ï¼šåªä½¿ç”¨TLS 1.2+ï¼Œç¦ç”¨æ—§ç‰ˆæœ¬
- [ ] **éªŒè¯æ¨¡å¼**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨"full"éªŒè¯
- [ ] **å¤‡ä»½è¯ä¹¦**ï¼šå®‰å…¨åœ°å¤‡ä»½è¯ä¹¦æ–‡ä»¶
- [ ] **æ—¥å¿—å®‰å…¨**ï¼šä¸åœ¨æ—¥å¿—ä¸­æš´éœ²è¯ä¹¦å†…å®¹

**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**

```yaml
# SSLæ€§èƒ½ä¼˜åŒ–é…ç½®
output.elasticsearch:
  ssl:
    # ä½¿ç”¨æ›´å¿«çš„æ¤­åœ†æ›²çº¿
    curve_types: ["P-256"]  # P-256æ¯”P-384æ›´å¿«
    
    # ä¼˜åŒ–åŠ å¯†å¥—ä»¶é€‰æ‹©ï¼ˆæŒ‰æ€§èƒ½æ’åºï¼‰
    cipher_suites:
      - "ECDHE-RSA-AES128-GCM-SHA256"  # æ›´å¿«
      - "ECDHE-RSA-AES256-GCM-SHA384"  # æ›´å®‰å…¨ä½†ç¨æ…¢
    
    # ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½
    renegotiation: "never"  # ç¦ç”¨é‡æ–°åå•†æé«˜æ€§èƒ½
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ SSLå®¢æˆ·ç«¯è¯ä¹¦ï¼šFilebeatçš„æ•°å­—èº«ä»½è¯ï¼Œç”¨äºå‘Elasticsearchè¯æ˜èº«ä»½
ğŸ”¸ åŒå‘è®¤è¯ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç›¸äº’éªŒè¯ï¼Œæä¾›æœ€é«˜å®‰å…¨çº§åˆ«
ğŸ”¸ è¯ä¹¦æ–‡ä»¶ç±»å‹ï¼š.crtï¼ˆè¯ä¹¦ï¼‰ã€.keyï¼ˆç§é’¥ï¼‰ã€.p12ï¼ˆæ‰“åŒ…æ ¼å¼ï¼‰
ğŸ”¸ éªŒè¯æ¨¡å¼ï¼šnone < certificate < fullï¼ˆå®‰å…¨çº§åˆ«é€’å¢ï¼‰
ğŸ”¸ è¯ä¹¦ç®¡ç†ï¼šæƒé™æ§åˆ¶ã€å¯†ç ä¿æŠ¤ã€å®šæœŸç»­æœŸ
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ æ–‡ä»¶è·¯å¾„é…ç½®**
```
â€¢ ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé¿å…ç›¸å¯¹è·¯å¾„å¸¦æ¥çš„é—®é¢˜
â€¢ åˆç†è§„åˆ’è¯ä¹¦ç›®å½•ç»“æ„
â€¢ è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™ï¼ˆç§é’¥600ï¼Œè¯ä¹¦644ï¼‰
```

**ğŸ”¹ å®‰å…¨æ€§é…ç½®**
```
â€¢ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨verification_mode: "full"
â€¢ ç§é’¥å¯†ç é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œä¸ç¡¬ç¼–ç 
â€¢ åªä½¿ç”¨TLS 1.2åŠä»¥ä¸Šç‰ˆæœ¬
â€¢ é€‰æ‹©å®‰å…¨çš„åŠ å¯†å¥—ä»¶
```

**ğŸ”¹ è¯ä¹¦ç®¡ç†**
```
â€¢ å»ºç«‹è¯ä¹¦è¿‡æœŸç›‘æ§æœºåˆ¶
â€¢ åˆ¶å®šè¯ä¹¦ç»­æœŸæµç¨‹
â€¢ å®‰å…¨åœ°å¤‡ä»½è¯ä¹¦æ–‡ä»¶
â€¢ å®šæœŸå®¡æŸ¥è¯ä¹¦ä½¿ç”¨æƒ…å†µ
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ é€‚ç”¨åœºæ™¯**
- **ä¼ä¸šçº§éƒ¨ç½²**ï¼šéœ€è¦ä¸¥æ ¼èº«ä»½éªŒè¯çš„ç”Ÿäº§ç¯å¢ƒ
- **æ•æ„Ÿæ•°æ®ä¼ è¾“**ï¼šé‡‘èã€åŒ»ç–—ç­‰å¯¹å®‰å…¨è¦æ±‚æé«˜çš„è¡Œä¸š
- **åˆè§„è¦æ±‚**ï¼šéœ€è¦æ»¡è¶³ç‰¹å®šå®‰å…¨æ ‡å‡†çš„ç³»ç»Ÿ
- **å¤šç¯å¢ƒç®¡ç†**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„è¯ä¹¦ç®¡ç†

**ğŸ’¡ ä½¿ç”¨å»ºè®®**
- å¼€å‘é˜¶æ®µå¯ä»¥ä½¿ç”¨è‡ªç­¾åè¯ä¹¦é™ä½å¤æ‚åº¦
- æµ‹è¯•ç¯å¢ƒé€æ­¥å¼•å…¥SSLé…ç½®éªŒè¯åŠŸèƒ½
- ç”Ÿäº§ç¯å¢ƒä¸¥æ ¼æŒ‰ç…§æœ€ä½³å®è·µé…ç½®
- å»ºç«‹å®Œæ•´çš„è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†æµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è¯ä¹¦ç§é’¥è¦ä¿å¯†ï¼Œæƒé™è®¾ç½®å¾ˆå…³é”®
- åŒå‘è®¤è¯æœ€å®‰å…¨ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ç”¨
- ç¯å¢ƒå˜é‡ç®¡å¯†ç ï¼Œç¡¬ç¼–ç åƒä¸‡åˆ«ç¢°
- å®šæœŸæ£€æŸ¥é˜²è¿‡æœŸï¼Œç›‘æ§å‘Šè­¦è¦è·Ÿä¸Š