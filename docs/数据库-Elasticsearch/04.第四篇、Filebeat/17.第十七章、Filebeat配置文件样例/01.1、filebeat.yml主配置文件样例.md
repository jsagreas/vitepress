---
title: 1ã€filebeat.ymlä¸»é…ç½®æ–‡ä»¶æ ·ä¾‹
---
## ğŸ“š ç›®å½•

1. [FilebeatåŸºç¡€æ¦‚å¿µ](#1-filebeatåŸºç¡€æ¦‚å¿µ)
2. [ä¸»é…ç½®æ–‡ä»¶ç»“æ„è¯¦è§£](#2-ä¸»é…ç½®æ–‡ä»¶ç»“æ„è¯¦è§£)
3. [è¾“å…¥æºé…ç½®å®æˆ˜](#3-è¾“å…¥æºé…ç½®å®æˆ˜)
4. [è¾“å‡ºé…ç½®è¯¦è§£](#4-è¾“å‡ºé…ç½®è¯¦è§£)
5. [å¤„ç†å™¨é…ç½®è¿›é˜¶](#5-å¤„ç†å™¨é…ç½®è¿›é˜¶)
6. [ç³»ç»Ÿé…ç½®ä¼˜åŒ–](#6-ç³»ç»Ÿé…ç½®ä¼˜åŒ–)
7. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#7-å®æˆ˜é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ FilebeatåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Filebeat


**ç®€å•ç†è§£**ï¼šFilebeatå°±åƒä¸€ä¸ªä¸“é—¨çš„"å¿«é€’å‘˜"ï¼Œå®ƒçš„å·¥ä½œå°±æ˜¯æŠŠä½ æœåŠ¡å™¨ä¸Šçš„æ—¥å¿—æ–‡ä»¶"å¿«é€’"åˆ°Elasticsearché‡Œå­˜å‚¨èµ·æ¥ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šä½ éœ€è¦æ‰‹åŠ¨å¤åˆ¶æ—¥å¿—æ–‡ä»¶
æ—¥å¿—æ–‡ä»¶ â†’ æ‰‹åŠ¨å¤åˆ¶ â†’ Elasticsearch

Filebeatæ–¹å¼ï¼šè‡ªåŠ¨åŒ–çš„æ—¥å¿—ä¼ è¾“
æ—¥å¿—æ–‡ä»¶ â†’ Filebeatè‡ªåŠ¨æ”¶é›† â†’ Elasticsearch
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **è‡ªåŠ¨ç›‘æ§**ï¼šå®æ—¶ç›‘æ§æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶
- ğŸ”¸ **æ™ºèƒ½è¯»å–**ï¼šåªè¯»å–æ–°å¢çš„æ—¥å¿—å†…å®¹ï¼Œä¸é‡å¤
- ğŸ”¸ **å¯é ä¼ è¾“**ï¼šç¡®ä¿æ—¥å¿—ä¸ä¸¢å¤±ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
- ğŸ”¸ **è½»é‡é«˜æ•ˆ**ï¼šå ç”¨èµ„æºå¾ˆå°‘ï¼Œä¸“é—¨ä¸ºæ—¥å¿—æ”¶é›†ä¼˜åŒ–

### 1.2 Filebeatçš„å·¥ä½œåŸç†


**ç®€å•æ¯”å–»**ï¼š
```
æƒ³è±¡Filebeatæ˜¯ä¸€ä¸ªå¾ˆèªæ˜çš„å›¾ä¹¦ç®¡ç†å‘˜ï¼š

1. ğŸ“– ç›‘æ§ä¹¦æ¶ï¼šæŒç»­ç›‘æ§æŒ‡å®šæ–‡ä»¶å¤¹ä¸­çš„æ—¥å¿—æ–‡ä»¶
2. ğŸ“ è®°å½•ä½ç½®ï¼šè®°ä½æ¯æœ¬ä¹¦(æ–‡ä»¶)è¯»åˆ°äº†å“ªä¸€é¡µ(ä½ç½®)
3. ğŸ“¤ ä¼ é€æ–°å†…å®¹ï¼šåªæŠŠæ–°å¢çš„é¡µé¢å†…å®¹å‘é€å‡ºå»
4. âœ… ç¡®è®¤é€è¾¾ï¼šç¡®ä¿å†…å®¹å®‰å…¨åˆ°è¾¾ç›®çš„åœ°
```

**æŠ€æœ¯æµç¨‹å›¾**ï¼š
```
æ—¥å¿—æ–‡ä»¶äº§ç”Ÿ â†’ Filebeatç›‘æ§ â†’ è¯»å–æ–°å†…å®¹ â†’ å‘é€åˆ°ES â†’ æ›´æ–°è¯»å–ä½ç½®
     â†‘                                                        â†“
     â””â”€â”€â”€â”€â”€â”€â”€ å¦‚æœå‘é€å¤±è´¥ï¼Œä¼šé‡è¯• â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Filebeat


**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š

> âŒ **ä¼ ç»Ÿæ–¹å¼çš„ç—›ç‚¹**ï¼š
> - æ‰‹åŠ¨æ”¶é›†æ—¥å¿—å¤ªéº»çƒ¦
> - å®¹æ˜“æ¼æ‰é‡è¦æ—¥å¿—
> - æ— æ³•å®æ—¶å¤„ç†
> - æ—¥å¿—æ ¼å¼ä¸ç»Ÿä¸€

> âœ… **Filebeatçš„ä¼˜åŠ¿**ï¼š
> - å…¨è‡ªåŠ¨åŒ–æ”¶é›†ï¼Œæ— éœ€äººå·¥å¹²é¢„
> - å®æ—¶ç›‘æ§ï¼Œç§’çº§å“åº”
> - æ”¯æŒå¤šç§æ—¥å¿—æ ¼å¼
> - è½»é‡çº§ï¼Œå‡ ä¹ä¸å½±å“ç³»ç»Ÿæ€§èƒ½

---

## 2. ğŸ“‹ ä¸»é…ç½®æ–‡ä»¶ç»“æ„è¯¦è§£


### 2.1 filebeat.ymlæ–‡ä»¶ç»“æ„æ¦‚è§ˆ


**é…ç½®æ–‡ä»¶å°±åƒæˆ¿å­çš„ç»“æ„å›¾**ï¼š
```
filebeat.yml é…ç½®æ–‡ä»¶
â”œâ”€â”€ è¾“å…¥é…ç½® (inputs)     â† ä»å“ªé‡Œè¯»å–æ—¥å¿—
â”œâ”€â”€ è¾“å‡ºé…ç½® (output)     â† å‘é€åˆ°å“ªé‡Œå»
â”œâ”€â”€ å¤„ç†å™¨ (processors)   â† å¦‚ä½•å¤„ç†æ—¥å¿—
â”œâ”€â”€ æ—¥å¿—é…ç½® (logging)    â† Filebeatè‡ªå·±çš„æ—¥å¿—
â”œâ”€â”€ è·¯å¾„é…ç½® (path)       â† å„ç§æ–‡ä»¶å­˜æ”¾ä½ç½®
â””â”€â”€ å…¶ä»–é…ç½®              â† åç§°ã€æ ‡ç­¾ç­‰
```

### 2.2 åŸºç¡€é…ç½®æ–‡ä»¶æ¨¡æ¿


```yaml
# =================================== åŸºç¡€ä¿¡æ¯ ===================================
# Filebeatçš„åç§°ï¼Œç”¨äºè¯†åˆ«ä¸åŒçš„Filebeatå®ä¾‹
name: "web-server-filebeat"

# æ ‡ç­¾ï¼Œç”¨äºç»™æ‰€æœ‰æ—¥å¿—æ·»åŠ æ ‡è¯†
tags: ["web", "production", "frontend"]

# =================================== è¾“å…¥é…ç½® ===================================
filebeat.inputs:
- type: log                          # è¾“å…¥ç±»å‹ï¼šæ™®é€šæ—¥å¿—æ–‡ä»¶
  enabled: true                      # å¯ç”¨è¿™ä¸ªè¾“å…¥
  paths:                            # è¦ç›‘æ§çš„æ–‡ä»¶è·¯å¾„
    - /var/log/nginx/*.log
    - /var/log/app/*.log
  
  # å­—æ®µé…ç½®
  fields:                           # è‡ªå®šä¹‰å­—æ®µ
    service: nginx
    env: production
  fields_under_root: true           # å­—æ®µæ˜¯å¦æ”¾åœ¨æ ¹çº§åˆ«

# =================================== è¾“å‡ºé…ç½® ===================================
output.elasticsearch:
  hosts: ["localhost:9200"]         # Elasticsearchåœ°å€
  index: "filebeat-logs-%{+yyyy.MM.dd}"  # ç´¢å¼•åç§°æ¨¡æ¿
  
# =================================== æ—¥å¿—é…ç½® ===================================
logging.level: info                 # æ—¥å¿—çº§åˆ«
logging.to_files: true             # è¾“å‡ºåˆ°æ–‡ä»¶
logging.files:
  path: /var/log/filebeat          # æ—¥å¿—æ–‡ä»¶è·¯å¾„
  name: filebeat                    # æ—¥å¿—æ–‡ä»¶å
  keepfiles: 7                     # ä¿ç•™7ä¸ªæ—¥å¿—æ–‡ä»¶
  permissions: 0644                # æ–‡ä»¶æƒé™

# =================================== å…¶ä»–é…ç½® ===================================
path:
  home: /usr/share/filebeat        # Filebeatå®‰è£…ç›®å½•
  config: /etc/filebeat           # é…ç½®æ–‡ä»¶ç›®å½•
  data: /var/lib/filebeat          # æ•°æ®ç›®å½•
  logs: /var/log/filebeat          # æ—¥å¿—ç›®å½•
```

### 2.3 é…ç½®æ–‡ä»¶å„éƒ¨åˆ†è¯¦è§£


**ğŸ”¸ è¾“å…¥é…ç½® (filebeat.inputs)**
```
ä½œç”¨ï¼šå‘Šè¯‰Filebeatè¦ç›‘æ§å“ªäº›æ–‡ä»¶
ç±»æ¯”ï¼šå‘Šè¯‰å¿«é€’å‘˜è¦å»å“ªäº›åœ°æ–¹æ”¶å¿«é€’

å…³é”®å‚æ•°è¯´æ˜ï¼š
- type: è¾“å…¥ç±»å‹ï¼ˆlog=æ™®é€šæ–‡ä»¶ï¼Œstdin=æ ‡å‡†è¾“å…¥ï¼‰
- enabled: æ˜¯å¦å¯ç”¨è¿™ä¸ªè¾“å…¥æº
- paths: æ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒé€šé…ç¬¦*
- fields: ç»™æ—¥å¿—æ·»åŠ é¢å¤–ä¿¡æ¯
```

**ğŸ”¸ è¾“å‡ºé…ç½® (output)**
```
ä½œç”¨ï¼šå‘Šè¯‰FilebeatæŠŠæ—¥å¿—å‘é€åˆ°å“ªé‡Œ
ç±»æ¯”ï¼šå‘Šè¯‰å¿«é€’å‘˜æŠŠå¿«é€’é€åˆ°å“ªä¸ªåœ°å€

å¸¸è§è¾“å‡ºç±»å‹ï¼š
- elasticsearch: å‘é€åˆ°ESé›†ç¾¤
- logstash: å‘é€åˆ°Logstash
- file: ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
- console: è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
```

---

## 3. ğŸ¯ è¾“å…¥æºé…ç½®å®æˆ˜


### 3.1 æ—¥å¿—æ–‡ä»¶è¾“å…¥é…ç½®


**åœºæ™¯ï¼šç›‘æ§Nginxè®¿é—®æ—¥å¿—**

```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log      # å…·ä½“æ–‡ä»¶
    - /var/log/nginx/error.log
  
  # æ’é™¤æŸäº›æ–‡ä»¶
  exclude_files: ['\.gz$']           # æ’é™¤å‹ç¼©æ–‡ä»¶
  
  # æ–‡ä»¶è¯»å–é…ç½®
  scan_frequency: 10s                # æ‰«æé¢‘ç‡ï¼šæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
  harvester_buffer_size: 16384       # è¯»å–ç¼“å†²åŒºå¤§å°
  max_bytes: 10485760               # å•è¡Œæœ€å¤§å­—èŠ‚æ•°(10MB)
  
  # å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆå¦‚Javaå †æ ˆè·Ÿè¸ªï¼‰
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'  # ä»¥æ—¥æœŸå¼€å¤´çš„è¡Œ
  multiline.negate: true             # æ¨¡å¼å–å
  multiline.match: after            # ä¸åŒ¹é…çš„è¡Œåˆå¹¶åˆ°å‰ä¸€è¡Œ
  
  # æ·»åŠ å…ƒæ•°æ®
  fields:
    service: nginx
    log_type: access
    datacenter: beijing
  fields_under_root: true            # å­—æ®µæ”¾åœ¨æ ¹çº§åˆ«
```

**é…ç½®è§£é‡Š**ï¼š
- `scan_frequency`: æ‰«æé¢‘ç‡ï¼Œåƒé—¨å«å¤šä¹…å·¡é€»ä¸€æ¬¡
- `exclude_files`: æ’é™¤æ–‡ä»¶ï¼Œé¿å…è¯»å–ä¸éœ€è¦çš„æ–‡ä»¶
- `multiline`: å¤šè¡Œåˆå¹¶ï¼ŒæŠŠJavaé”™è¯¯å †æ ˆç­‰å¤šè¡Œå†…å®¹åˆå¹¶æˆä¸€æ¡æ—¥å¿—

### 3.2 ä¸åŒç±»å‹è¾“å…¥æºé…ç½®


**ğŸ”¸ ç›‘æ§å¤šä¸ªåº”ç”¨æ—¥å¿—**
```yaml
filebeat.inputs:
# WebæœåŠ¡å™¨æ—¥å¿—
- type: log
  enabled: true
  paths: ["/var/log/nginx/*.log"]
  tags: ["nginx", "web"]
  fields:
    service: nginx

# åº”ç”¨ç¨‹åºæ—¥å¿—  
- type: log
  enabled: true
  paths: ["/app/logs/*.log"]
  tags: ["application", "backend"]
  fields:
    service: myapp
  
  # åªè¯»å–æœ€è¿‘çš„æ—¥å¿—ï¼ˆä¸è¯»å–å†å²ï¼‰
  tail_files: true
```

**ğŸ”¸ ç›‘æ§ç³»ç»Ÿæ—¥å¿—**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/syslog
    - /var/log/messages
  tags: ["system", "syslog"]
  
  # å¿½ç•¥æ—§æ–‡ä»¶
  ignore_older: 24h                  # å¿½ç•¥24å°æ—¶å‰çš„æ–‡ä»¶
  close_older: 1h                    # 1å°æ—¶åå…³é—­æ–‡ä»¶å¥æŸ„
```

### 3.3 é«˜çº§è¾“å…¥é…ç½®


**è·¯å¾„é€šé…ç¬¦ä½¿ç”¨**ï¼š
```yaml
paths:
  - /var/log/*.log                   # æ‰€æœ‰.logæ–‡ä»¶
  - /var/log/app-*/access.log        # app-å¼€å¤´çš„ç›®å½•ä¸‹çš„access.log
  - /var/log/2024/01/**/*.log        # 2024/01ç›®å½•åŠå­ç›®å½•ä¸‹æ‰€æœ‰.logæ–‡ä»¶
```

**æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š
```yaml
# æ–‡ä»¶å¥æŸ„ç®¡ç†
close_inactive: 5m                   # 5åˆ†é’Ÿæ— æ´»åŠ¨å°±å…³é—­æ–‡ä»¶
close_removed: true                  # æ–‡ä»¶è¢«åˆ é™¤æ—¶å…³é—­å¥æŸ„
close_renamed: true                  # æ–‡ä»¶è¢«é‡å‘½åæ—¶å…³é—­å¥æŸ„

# è¯»å–ä¼˜åŒ–
harvester_limit: 100                 # æœ€å¤§åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æ•°
```

---

## 4. ğŸ“¤ è¾“å‡ºé…ç½®è¯¦è§£


### 4.1 Elasticsearchè¾“å‡ºé…ç½®


**åŸºç¡€é…ç½®**ï¼š
```yaml
output.elasticsearch:
  # ESé›†ç¾¤åœ°å€
  hosts: ["localhost:9200"]
  
  # è®¤è¯é…ç½®
  username: "filebeat_user"
  password: "your_password"
  
  # ç´¢å¼•é…ç½®
  index: "filebeat-logs-%{+yyyy.MM.dd}"
  
  # æ¨¡æ¿é…ç½®
  template.enabled: true
  template.pattern: "filebeat-*"
```

**é«˜çº§é…ç½®**ï¼š
```yaml
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  
  # è´Ÿè½½å‡è¡¡
  loadbalance: true
  
  # æ‰¹é‡å‘é€é…ç½®
  bulk_max_size: 1000               # æ‰¹é‡å¤§å°
  flush_interval: 30s               # åˆ·æ–°é—´éš”
  
  # é‡è¯•é…ç½®
  max_retries: 3                    # æœ€å¤§é‡è¯•æ¬¡æ•°
  backoff.init: 1s                  # åˆå§‹é€€é¿æ—¶é—´
  backoff.max: 60s                  # æœ€å¤§é€€é¿æ—¶é—´
  
  # è¶…æ—¶é…ç½®
  timeout: 90s                      # è¿æ¥è¶…æ—¶æ—¶é—´
  
  # ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†
  ilm.enabled: true                 # å¯ç”¨ILM
  ilm.rollover_alias: "filebeat"    # æ»šåŠ¨åˆ«å
```

### 4.2 å¤šè¾“å‡ºé…ç½®


**åœºæ™¯ï¼šåŒæ—¶å‘é€åˆ°ESå’Œæ–‡ä»¶**

> âš ï¸ **æ³¨æ„**ï¼šFilebeatä¸€æ¬¡åªèƒ½é…ç½®ä¸€ä¸ªè¾“å‡ºï¼Œå¦‚æœéœ€è¦å¤šè¾“å‡ºï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š

**æ–¹å¼ä¸€ï¼šä½¿ç”¨Logstashä½œä¸ºä¸­è½¬**
```yaml
# Filebeatå‘é€åˆ°Logstash
output.logstash:
  hosts: ["localhost:5044"]

# ç„¶ååœ¨Logstashä¸­é…ç½®å¤šä¸ªè¾“å‡º
```

**æ–¹å¼äºŒï¼šä½¿ç”¨å¤šä¸ªFilebeatå®ä¾‹**
```yaml
# filebeat-to-es.yml
output.elasticsearch:
  hosts: ["localhost:9200"]

# filebeat-to-file.yml  
output.file:
  path: "/backup/logs"
  filename: "backup.log"
```

### 4.3 è¾“å‡ºè°ƒè¯•é…ç½®


**è°ƒè¯•æ—¶ä½¿ç”¨æ§åˆ¶å°è¾“å‡º**ï¼š
```yaml
output.console:
  pretty: true                      # æ ¼å¼åŒ–è¾“å‡º
  
# ç”¨äºè°ƒè¯•ï¼Œå¯ä»¥ç›´æ¥çœ‹åˆ°è¾“å‡ºå†…å®¹
```

**æ–‡ä»¶è¾“å‡ºï¼ˆå¤‡ä»½ç”¨ï¼‰**ï¼š
```yaml
output.file:
  path: "/backup"
  filename: "filebeat-backup"
  rotate_every_kb: 10000           # æ¯10MBè½®è½¬ä¸€æ¬¡
  number_of_files: 5               # ä¿ç•™5ä¸ªæ–‡ä»¶
```

---

## 5. ğŸ”§ å¤„ç†å™¨é…ç½®è¿›é˜¶


### 5.1 ä»€ä¹ˆæ˜¯å¤„ç†å™¨


**ç®€å•ç†è§£**ï¼šå¤„ç†å™¨å°±åƒæ˜¯"æ•°æ®åŠ å·¥å‚"ï¼Œåœ¨æ—¥å¿—å‘é€ä¹‹å‰å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚

```
åŸå§‹æ—¥å¿— â†’ å¤„ç†å™¨åŠ å·¥ â†’ å¤„ç†åçš„æ—¥å¿— â†’ å‘é€åˆ°ES

æ¯”å¦‚ï¼š
åŸå§‹ï¼š192.168.1.1 - GET /index.html 200
å¤„ç†åï¼š{
  "ip": "192.168.1.1",
  "method": "GET", 
  "url": "/index.html",
  "status": 200,
  "geoip": {"country": "China"}
}
```

### 5.2 å¸¸ç”¨å¤„ç†å™¨é…ç½®


**ğŸ”¸ æ·»åŠ å­—æ®µå¤„ç†å™¨**
```yaml
processors:
- add_fields:
    target: ""                      # æ·»åŠ åˆ°æ ¹çº§åˆ«
    fields:
      environment: production
      team: backend
      version: "1.0.0"
```

**ğŸ”¸ åˆ é™¤å­—æ®µå¤„ç†å™¨**
```yaml
processors:
- drop_fields:
    fields: ["host.name", "agent.version"]  # åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
```

**ğŸ”¸ é‡å‘½åå­—æ®µå¤„ç†å™¨**
```yaml
processors:
- rename:
    fields:
      - from: "message"             # åŸå­—æ®µå
        to: "log_content"           # æ–°å­—æ®µå
      - from: "host.name"
        to: "server_name"
```

### 5.3 æ¡ä»¶å¤„ç†å™¨


**æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒå¤„ç†**ï¼š
```yaml
processors:
# åªå¯¹nginxæ—¥å¿—æ·»åŠ webæ ‡ç­¾
- add_tags:
    tags: ["web", "frontend"]
    when.contains:
      fields.service: "nginx"

# åˆ é™¤debugçº§åˆ«çš„æ—¥å¿—
- drop_event:
    when.contains:
      message: "DEBUG"

# æ ¹æ®çŠ¶æ€ç æ·»åŠ æ ‡ç­¾
- add_tags:
    tags: ["error"]
    when.range:
      http.response.status_code:
        gte: 400                    # å¤§äºç­‰äº400
        lt: 600                     # å°äº600
```

### 5.4 é«˜çº§å¤„ç†å™¨ç¤ºä¾‹


**è§£ænginxè®¿é—®æ—¥å¿—**ï¼š
```yaml
processors:
# ä½¿ç”¨grokè§£ænginxæ—¥å¿—æ ¼å¼
- dissect:
    tokenizer: '%{clientip} - - [%{timestamp}] "%{method} %{url} %{version}" %{response} %{bytes}'
    field: "message"
    target_prefix: "nginx"

# è½¬æ¢å­—æ®µç±»å‹
- convert:
    fields:
      - {from: "nginx.response", to: "nginx.status_code", type: "integer"}
      - {from: "nginx.bytes", to: "nginx.bytes_sent", type: "integer"}

# æ·»åŠ æ—¶é—´æˆ³
- timestamp:
    field: nginx.timestamp
    layouts:
      - '02/Jan/2006:15:04:05 -0700'
    test:
      - '25/May/2020:03:46:23 +0200'
```

---

## 6. âš™ï¸ ç³»ç»Ÿé…ç½®ä¼˜åŒ–


### 6.1 è·¯å¾„é…ç½®è¯¦è§£


```yaml
path:
  home: /usr/share/filebeat          # Filebeatç¨‹åºç›®å½•
  config: /etc/filebeat             # é…ç½®æ–‡ä»¶ç›®å½•
  data: /var/lib/filebeat           # æ•°æ®æ–‡ä»¶ç›®å½•ï¼ˆæ³¨å†Œè¡¨ç­‰ï¼‰
  logs: /var/log/filebeat           # Filebeatæ—¥å¿—ç›®å½•
```

**å„ç›®å½•çš„ä½œç”¨**ï¼š
- `home`: Filebeatç¨‹åºæ–‡ä»¶å­˜æ”¾ä½ç½®
- `config`: é…ç½®æ–‡ä»¶filebeat.ymlå­˜æ”¾ä½ç½®  
- `data`: è®°å½•æ–‡ä»¶è¯»å–ä½ç½®çš„æ³¨å†Œè¡¨æ–‡ä»¶
- `logs`: Filebeatè‡ªå·±çš„è¿è¡Œæ—¥å¿—

### 6.2 æ€§èƒ½è°ƒä¼˜é…ç½®


**å†…å­˜å’ŒCPUä¼˜åŒ–**ï¼š
```yaml
# é˜Ÿåˆ—é…ç½®
queue.mem:
  events: 4096                      # å†…å­˜é˜Ÿåˆ—å¤§å°
  flush.min_events: 1024            # æœ€å°åˆ·æ–°äº‹ä»¶æ•°
  flush.timeout: 1s                 # åˆ·æ–°è¶…æ—¶æ—¶é—´

# å‘å¸ƒå™¨é…ç½®  
output.elasticsearch:
  worker: 2                         # å·¥ä½œçº¿ç¨‹æ•°
  bulk_max_size: 1000              # æ‰¹é‡å¤§å°
  flush_interval: 30s              # åˆ·æ–°é—´éš”
```

**æ–‡ä»¶å¥æŸ„ä¼˜åŒ–**ï¼š
```yaml
filebeat.inputs:
- type: log
  close_inactive: 5m               # 5åˆ†é’Ÿæ— æ´»åŠ¨å…³é—­æ–‡ä»¶
  close_removed: true              # æ–‡ä»¶åˆ é™¤æ—¶å…³é—­
  close_renamed: true              # æ–‡ä»¶é‡å‘½åæ—¶å…³é—­
  harvester_limit: 100             # æœ€å¤§åŒæ—¶æ‰“å¼€æ–‡ä»¶æ•°
```

### 6.3 ç›‘æ§å’Œæ—¥å¿—é…ç½®


**è¯¦ç»†çš„æ—¥å¿—é…ç½®**ï¼š
```yaml
logging.level: info                # æ—¥å¿—çº§åˆ«ï¼šdebug,info,warning,error
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  rotateeverybytes: 10485760       # 10MBè½®è½¬
  keepfiles: 7                     # ä¿ç•™7ä¸ªæ–‡ä»¶
  permissions: 0644

# HTTPç›‘æ§ç«¯ç‚¹
http.enabled: true                 # å¯ç”¨HTTPç›‘æ§
http.host: "localhost"             # ç›‘æ§åœ°å€
http.port: 5066                    # ç›‘æ§ç«¯å£
```

**ç›‘æ§æŒ‡æ ‡è·å–**ï¼š
```bash
# æŸ¥çœ‹FilebeatçŠ¶æ€
curl http://localhost:5066/stats

# æŸ¥çœ‹è¾“å…¥çŠ¶æ€
curl http://localhost:5066/stats/filebeat
```

---

## 7. ğŸš€ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 7.1 WebæœåŠ¡å™¨æ—¥å¿—æ”¶é›†å®Œæ•´é…ç½®


```yaml
# ============================= WebæœåŠ¡å™¨æ—¥å¿—æ”¶é›†é…ç½® =============================
name: "web-server-filebeat"
tags: ["web", "production"]

# è¾“å…¥é…ç½®
filebeat.inputs:
# Nginxè®¿é—®æ—¥å¿—
- type: log
  enabled: true
  paths: ["/var/log/nginx/access.log"]
  tags: ["nginx", "access"]
  fields:
    service: nginx
    log_type: access
  multiline.pattern: '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'
  multiline.negate: true
  multiline.match: after

# Nginxé”™è¯¯æ—¥å¿—  
- type: log
  enabled: true
  paths: ["/var/log/nginx/error.log"]
  tags: ["nginx", "error"]
  fields:
    service: nginx
    log_type: error

# åº”ç”¨ç¨‹åºæ—¥å¿—
- type: log
  enabled: true
  paths: ["/app/logs/*.log"]
  tags: ["application"]
  fields:
    service: myapp
    
# å¤„ç†å™¨é…ç½®
processors:
- add_fields:
    target: ""
    fields:
      environment: production
      datacenter: beijing

- drop_fields:
    fields: ["host.os", "host.containerized"]

# è¾“å‡ºåˆ°Elasticsearch
output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "web-logs-%{+yyyy.MM.dd}"
  username: "filebeat_user"
  password: "password123"

# æ—¥å¿—é…ç½®
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
```

### 7.2 å¾®æœåŠ¡æ¶æ„æ—¥å¿—æ”¶é›†


```yaml
# ============================= å¾®æœåŠ¡æ—¥å¿—æ”¶é›†é…ç½® =============================
name: "microservices-filebeat"

filebeat.inputs:
# ç”¨æˆ·æœåŠ¡
- type: log
  enabled: true
  paths: ["/apps/user-service/logs/*.log"]
  tags: ["microservice", "user-service"]
  fields:
    service: user-service
    team: backend
  fields_under_root: true

# è®¢å•æœåŠ¡
- type: log
  enabled: true  
  paths: ["/apps/order-service/logs/*.log"]
  tags: ["microservice", "order-service"]
  fields:
    service: order-service
    team: backend
  fields_under_root: true

# æ”¯ä»˜æœåŠ¡
- type: log
  enabled: true
  paths: ["/apps/payment-service/logs/*.log"]
  tags: ["microservice", "payment-service"]
  fields:
    service: payment-service
    team: financial
  fields_under_root: true

# å¤„ç†å™¨ï¼šæ ¹æ®æœåŠ¡æ·»åŠ ä¸åŒå¤„ç†
processors:
- add_tags:
    tags: ["critical"]
    when.contains:
      service: "payment-service"

- add_tags:
    tags: ["error"]
    when.regexp:
      message: "ERROR|Exception|Failed"

# è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200"]
  index: "microservices-%{[service]}-%{+yyyy.MM.dd}"
  
  # æ ¹æ®æœåŠ¡è·¯ç”±åˆ°ä¸åŒç´¢å¼•
  indices:
    - index: "user-service-%{+yyyy.MM.dd}"
      when.equals:
        service: "user-service"
    - index: "order-service-%{+yyyy.MM.dd}"
      when.equals:
        service: "order-service"
    - index: "payment-service-%{+yyyy.MM.dd}"
      when.equals:
        service: "payment-service"
```

### 7.3 å®¹å™¨åŒ–ç¯å¢ƒé…ç½®


```yaml
# ============================= Dockerå®¹å™¨æ—¥å¿—æ”¶é›† =============================
name: "docker-filebeat"
tags: ["docker", "containers"]

filebeat.inputs:
# Dockerå®¹å™¨æ—¥å¿—
- type: container
  enabled: true
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # å®¹å™¨ä¿¡æ¯è§£æ
  processors:
    - add_docker_metadata:
        host: "unix:///var/run/docker.sock"
        
    - decode_json_fields:
        fields: ["message"]
        target: ""
        overwrite_keys: true

# ç³»ç»Ÿæ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/syslog
    - /var/log/messages
  tags: ["system"]

# è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOST:elasticsearch:9200}"]
  username: "${ELASTICSEARCH_USERNAME:}"
  password: "${ELASTICSEARCH_PASSWORD:}"
  
  # ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®ç´¢å¼•
  index: "docker-logs-%{+yyyy.MM.dd}"

# ç¯å¢ƒå˜é‡é…ç½®
# ELASTICSEARCH_HOST=es-cluster:9200
# ELASTICSEARCH_USERNAME=filebeat_user  
# ELASTICSEARCH_PASSWORD=secure_password
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„é…ç½®è¦ç‚¹


```
ğŸ”¸ åŸºç¡€ç»“æ„ï¼šinputsè¾“å…¥ + outputè¾“å‡º + processorså¤„ç†å™¨
ğŸ”¸ æ–‡ä»¶ç›‘æ§ï¼špathsè·¯å¾„é…ç½®ï¼Œæ”¯æŒé€šé…ç¬¦å’Œå¤šè·¯å¾„
ğŸ”¸ è¾“å‡ºé…ç½®ï¼šä¸»è¦æ˜¯Elasticsearchï¼ŒåŒ…æ‹¬è®¤è¯å’Œç´¢å¼•è®¾ç½®
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ–‡ä»¶å¥æŸ„ç®¡ç†ã€æ‰¹é‡å‘é€ã€é˜Ÿåˆ—é…ç½®
ğŸ”¸ å­—æ®µç®¡ç†ï¼šæ·»åŠ æ ‡ç­¾ã€è‡ªå®šä¹‰å­—æ®µã€åˆ é™¤æ— ç”¨å­—æ®µ
```

### 8.2 é…ç½®æœ€ä½³å®è·µ


**ğŸ”¹ æ–‡ä»¶è·¯å¾„é…ç½®**
```
å»ºè®®ä½¿ç”¨ï¼š
âœ… å…·ä½“è·¯å¾„ï¼š/var/log/nginx/access.log
âœ… é€šé…ç¬¦ï¼š/var/log/app-*/*.log
âœ… æ’é™¤æ–‡ä»¶ï¼šexclude_files: ['\.gz$']

é¿å…ä½¿ç”¨ï¼š
âŒ å¤ªå®½æ³›ï¼š/var/log/*ï¼ˆä¼šè¯»å–å¤ªå¤šæ–‡ä»¶ï¼‰
âŒ æ ¹ç›®å½•ï¼š/*ï¼ˆç»å¯¹ä¸è¦è¿™æ ·åšï¼‰
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
å†…å­˜ç®¡ç†ï¼š
- åˆç†è®¾ç½®queue.mem.eventsï¼ˆé»˜è®¤4096ï¼‰
- æ§åˆ¶harvester_limité¿å…æ‰“å¼€å¤ªå¤šæ–‡ä»¶

ç½‘ç»œä¼˜åŒ–ï¼š
- æ‰¹é‡å‘é€bulk_max_size: 1000
- é€‚å½“çš„flush_interval: 30s
- é…ç½®é‡è¯•æœºåˆ¶max_retries: 3
```

**ğŸ”¹ å­—æ®µè®¾è®¡**
```
æ¨èå­—æ®µï¼š
- service: æœåŠ¡åç§°
- environment: ç¯å¢ƒ(dev/test/prod)  
- log_type: æ—¥å¿—ç±»å‹(access/error/debug)
- team: è´Ÿè´£å›¢é˜Ÿ

é¿å…å­—æ®µï¼š
- åˆ é™¤host.osç­‰æ— ç”¨ä¿¡æ¯
- ä¸è¦æ·»åŠ è¿‡å¤šè‡ªå®šä¹‰å­—æ®µ
```

### 8.3 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **æ—¥å¿—ä¸é‡‡é›†** | è·¯å¾„é”™è¯¯æˆ–æƒé™é—®é¢˜ | æ£€æŸ¥è·¯å¾„å’Œæ–‡ä»¶æƒé™ |
| **é‡å¤é‡‡é›†** | å¤šä¸ªinputsé…ç½®äº†ç›¸åŒè·¯å¾„ | ç¡®ä¿è·¯å¾„å”¯ä¸€æ€§ |
| **å†…å­˜å ç”¨é«˜** | harvester_limitè®¾ç½®è¿‡å¤§ | é™ä½åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æ•° |
| **å‘é€å»¶è¿Ÿ** | flush_intervalè¿‡å¤§ | å‡å°åˆ·æ–°é—´éš”æ—¶é—´ |
| **ESè¿æ¥å¤±è´¥** | ç½‘ç»œæˆ–è®¤è¯é—®é¢˜ | æ£€æŸ¥ç½‘ç»œå’Œç”¨æˆ·åå¯†ç  |

### 8.4 é…ç½®æ–‡ä»¶ç®¡ç†æŠ€å·§


**ğŸ”¹ é…ç½®éªŒè¯**
```bash
# éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
filebeat test config -c filebeat.yml

# æµ‹è¯•è¾“å‡ºè¿æ¥
filebeat test output -c filebeat.yml

# æµ‹è¯•è¾“å…¥é…ç½®
filebeat test inputs -c filebeat.yml
```

**ğŸ”¹ é…ç½®æ¨¡å—åŒ–**
```yaml
# ä¸»é…ç½®æ–‡ä»¶å¼•ç”¨å…¶ä»–é…ç½®
filebeat.config.inputs:
  enabled: true
  path: inputs.d/*.yml
  reload.enabled: true
  reload.period: 10s
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒå»ºè®®**
```
é…ç½®ç®¡ç†ï¼š
âœ… ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®æ–‡ä»¶
âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
âœ… é…ç½®æ–‡ä»¶æ·»åŠ è¯¦ç»†æ³¨é‡Š
âœ… å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶

ç›‘æ§å»ºè®®ï¼š
âœ… å¯ç”¨HTTPç›‘æ§ç«¯ç‚¹
âœ… é…ç½®è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
âœ… ç›‘æ§Filebeatçš„èµ„æºä½¿ç”¨
âœ… è®¾ç½®åˆé€‚çš„å‘Šè­¦é˜ˆå€¼
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Filebeaté…ç½®=è¾“å…¥+è¾“å‡º+å¤„ç†ï¼Œä¸‰éƒ¨åˆ†ç¼ºä¸€ä¸å¯
- è·¯å¾„é…ç½®è¦ç²¾ç¡®ï¼Œé¿å…é‡‡é›†æ— å…³æ–‡ä»¶
- æ€§èƒ½è°ƒä¼˜é‡ç‚¹åœ¨æ–‡ä»¶å¥æŸ„å’Œæ‰¹é‡å‘é€
- å­—æ®µè®¾è®¡è¦åˆç†ï¼Œåˆ é™¤æ— ç”¨ä¿¡æ¯
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»åšå¥½é…ç½®ç®¡ç†å’Œç›‘æ§