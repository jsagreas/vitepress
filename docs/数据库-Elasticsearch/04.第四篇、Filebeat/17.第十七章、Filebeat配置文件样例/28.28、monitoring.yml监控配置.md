---
title: 28ã€monitoring.ymlç›‘æ§é…ç½®
---
## ğŸ“š ç›®å½•

1. [Filebeatç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-filebeatç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [è‡ªç›‘æ§é…ç½®è¯¦è§£](#2-è‡ªç›‘æ§é…ç½®è¯¦è§£)
3. [ç›‘æ§æŒ‡æ ‡è¾“å‡ºé…ç½®](#3-ç›‘æ§æŒ‡æ ‡è¾“å‡ºé…ç½®)
4. [æ€§èƒ½æŒ‡æ ‡ä¸å¥åº·æ£€æŸ¥](#4-æ€§èƒ½æŒ‡æ ‡ä¸å¥åº·æ£€æŸ¥)
5. [ç›‘æ§å‘Šè­¦è®¾ç½®](#5-ç›‘æ§å‘Šè­¦è®¾ç½®)
6. [ç›‘æ§æ•°æ®å­˜å‚¨ä¸å¯è§†åŒ–](#6-ç›‘æ§æ•°æ®å­˜å‚¨ä¸å¯è§†åŒ–)
7. [å®é™…ç›‘æ§é…ç½®æ¡ˆä¾‹](#7-å®é™…ç›‘æ§é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Filebeatç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Filebeatç›‘æ§


**ğŸ“‹ ç®€å•ç†è§£**
```
æƒ³è±¡Filebeatæ˜¯ä¸€ä¸ªæ¬è¿å·¥ï¼Œè´Ÿè´£æ¬è¿æ—¥å¿—æ–‡ä»¶
ç›‘æ§å°±åƒæ˜¯ç»™è¿™ä¸ªæ¬è¿å·¥å®‰è£…GPSå’Œå¥åº·æ£€æµ‹å™¨
å®æ—¶çŸ¥é“ï¼š
â€¢ æ¬è¿å·¥åœ¨å“ªé‡Œï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰
â€¢ æ¬äº†å¤šå°‘è´§ç‰©ï¼ˆå¤„ç†äº†å¤šå°‘æ—¥å¿—ï¼‰
â€¢ èº«ä½“æ˜¯å¦å¥åº·ï¼ˆæ€§èƒ½æŒ‡æ ‡ï¼‰
â€¢ æœ‰æ²¡æœ‰é‡åˆ°é—®é¢˜ï¼ˆé”™è¯¯ä¿¡æ¯ï¼‰
```

**ğŸ¯ ç›‘æ§çš„æ ¸å¿ƒä½œç”¨**
- **è¿è¡ŒçŠ¶æ€ç›‘æ§**ï¼šFilebeatæ˜¯å¦æ­£å¸¸è¿è¡Œ
- **æ€§èƒ½ç›‘æ§**ï¼šå¤„ç†é€Ÿåº¦ã€å†…å­˜ä½¿ç”¨æƒ…å†µ
- **é”™è¯¯ç›‘æ§**ï¼šå‘ç°å¹¶è®°å½•è¿è¡Œä¸­çš„é—®é¢˜
- **ä¸šåŠ¡ç›‘æ§**ï¼šæ—¥å¿—æ”¶é›†é‡ã€ä¼ è¾“æˆåŠŸç‡

### 1.2 ç›‘æ§ä½“ç³»æ¶æ„


```
ç›‘æ§æ•°æ®æµå‘å›¾ï¼š

Filebeat Agent                    ç›‘æ§ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚              â”‚                 â”‚
â”‚ è‡ªç›‘æ§æ¨¡å—      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Elasticsearch   â”‚
â”‚ â€¢ æ€§èƒ½æŒ‡æ ‡      â”‚              â”‚ â€¢ å­˜å‚¨ç›‘æ§æ•°æ®  â”‚
â”‚ â€¢ é”™è¯¯æ—¥å¿—      â”‚              â”‚ â€¢ ç´¢å¼•ç®¡ç†      â”‚
â”‚ â€¢ è¿è¡ŒçŠ¶æ€      â”‚              â”‚                 â”‚
â”‚                 â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
                                           â”‚
                                           â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚     Kibana      â”‚
                                 â”‚ â€¢ ç›‘æ§ä»ªè¡¨æ¿    â”‚
                                 â”‚ â€¢ å‘Šè­¦é…ç½®      â”‚
                                 â”‚ â€¢ å¯è§†åŒ–å›¾è¡¨    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç›‘æ§æ•°æ®ç±»å‹


**ğŸ”¸ ç³»ç»Ÿçº§ç›‘æ§æ•°æ®**
```
CPUä½¿ç”¨ç‡ï¼šFilebeatå ç”¨çš„CPUç™¾åˆ†æ¯”
å†…å­˜ä½¿ç”¨ï¼šå½“å‰å†…å­˜å ç”¨å’Œå³°å€¼
ç£ç›˜IOï¼šè¯»å†™æ–‡ä»¶çš„é¢‘ç‡å’Œå¤§å°
ç½‘ç»œæµé‡ï¼šå‘Elasticsearchå‘é€æ•°æ®çš„ç½‘ç»œä½¿ç”¨
```

**ğŸ”¸ ä¸šåŠ¡çº§ç›‘æ§æ•°æ®**
```
æ—¥å¿—å¤„ç†é‡ï¼šæ¯ç§’å¤„ç†å¤šå°‘æ¡æ—¥å¿—
ä¼ è¾“æˆåŠŸç‡ï¼šæˆåŠŸå‘é€åˆ°ç›®æ ‡çš„æ¯”ä¾‹
å»¶è¿Ÿæ—¶é—´ï¼šä»è¯»å–åˆ°å‘é€çš„æ—¶é—´å·®
é˜Ÿåˆ—çŠ¶æ€ï¼šå†…éƒ¨ç¼“å†²é˜Ÿåˆ—çš„ä½¿ç”¨æƒ…å†µ
```

---

## 2. ğŸ“Š è‡ªç›‘æ§é…ç½®è¯¦è§£


### 2.1 å¯ç”¨è‡ªç›‘æ§åŠŸèƒ½


**ğŸ’¡ åŸºç¡€ç›‘æ§é…ç½®**

```yaml
# filebeat.yml åŸºç¡€ç›‘æ§é…ç½®
monitoring:
  # å¯ç”¨ç›‘æ§åŠŸèƒ½
  enabled: true
  
  # ç›‘æ§æ•°æ®å‘é€åˆ°Elasticsearch
  elasticsearch:
    hosts: ["localhost:9200"]
    
  # ç›‘æ§æŒ‡æ ‡æ”¶é›†é—´éš”ï¼ˆé»˜è®¤10ç§’ï¼‰
  period: 10s
  
  # ç›‘æ§é›†ç¾¤UUIDï¼ˆå¯é€‰ï¼‰
  cluster_uuid: "your-cluster-uuid"
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼š`period: 10s` è¡¨ç¤ºæ¯10ç§’æ”¶é›†ä¸€æ¬¡ç›‘æ§æ•°æ®ï¼Œç±»ä¼¼ä½“æ£€é—´éš”

### 2.2 è¯¦ç»†ç›‘æ§å‚æ•°é…ç½®


**ğŸ”§ å®Œæ•´ç›‘æ§é…ç½®ç¤ºä¾‹**

```yaml
monitoring:
  enabled: true
  
  # ç›‘æ§æ•°æ®è¾“å‡ºé…ç½®
  elasticsearch:
    hosts: ["es-node1:9200", "es-node2:9200"]
    
    # è®¤è¯é…ç½®
    username: "monitoring_user"
    password: "your_password"
    
    # SSLé…ç½®
    ssl:
      enabled: true
      verification_mode: certificate
      certificate_authorities: ["/etc/filebeat/ca.crt"]
    
    # ç›‘æ§ç´¢å¼•é…ç½®
    index: "filebeat-monitoring-%{+yyyy.MM.dd}"
    
    # è¿æ¥è¶…æ—¶è®¾ç½®
    timeout: 30s
    
  # ç›‘æ§æ•°æ®æ”¶é›†é…ç½®
  period: 10s
  
  # ç›‘æ§æŒ‡æ ‡é…ç½®
  metrics:
    # ç³»ç»ŸæŒ‡æ ‡
    system:
      cpu: true
      memory: true
      network: true
      filesystem: true
    
    # Filebeatç‰¹å®šæŒ‡æ ‡
    beat:
      info: true
      memstats: true
      runtime: true
```

### 2.3 ç›‘æ§æ—¥å¿—é…ç½®


**ğŸ“ ç›‘æ§æ—¥å¿—è®¾ç½®**

```yaml
# ç›‘æ§ç›¸å…³çš„æ—¥å¿—é…ç½®
logging:
  # æ—¥å¿—çº§åˆ«è®¾ç½®
  level: info
  
  # ç›‘æ§ä¸“ç”¨æ—¥å¿—æ–‡ä»¶
  files:
    path: /var/log/filebeat
    name: filebeat-monitoring
    keepfiles: 7
    permissions: 0644
  
  # ç›‘æ§æ—¥å¿—æ ¼å¼
  metrics:
    enabled: true
    period: 30s
  
  # é€‰æ‹©å™¨é…ç½®ï¼ˆæ§åˆ¶å“ªäº›ç»„ä»¶è¾“å‡ºæ—¥å¿—ï¼‰
  selectors: ["monitoring", "elasticsearch"]
```

> âš ï¸ **æ³¨æ„**ï¼šç›‘æ§æ—¥å¿—ä¼šå ç”¨ç£ç›˜ç©ºé—´ï¼Œå»ºè®®è®¾ç½®åˆç†çš„ä¿ç•™ç­–ç•¥

---

## 3. ğŸ“ˆ ç›‘æ§æŒ‡æ ‡è¾“å‡ºé…ç½®


### 3.1 å†…ç½®ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **æŒ‡æ ‡åç§°** | **å«ä¹‰è¯´æ˜** | **ç¤ºä¾‹å€¼** |
|---------|-------------|-------------|----------|
| ğŸ“Š **ååé‡** | `libbeat.pipeline.events.total` | æ€»å¤„ç†äº‹ä»¶æ•° | `15000` |
| âš¡ **é€Ÿç‡** | `libbeat.pipeline.events.rate` | æ¯ç§’å¤„ç†äº‹ä»¶æ•° | `150/s` |
| ğŸ’¾ **å†…å­˜** | `system.memory.actual.used.pct` | å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯” | `45.6%` |
| ğŸ”„ **é˜Ÿåˆ—** | `libbeat.pipeline.queue.max_events` | é˜Ÿåˆ—æœ€å¤§å®¹é‡ | `4096` |

### 3.2 è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡


**ğŸ› ï¸ æ·»åŠ è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡**

```yaml
# è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡é…ç½®
metricbeat.modules:
- module: system
  metricsets: ["cpu", "memory", "network", "filesystem"]
  period: 10s
  
- module: beat
  metricsets: ["info", "stats"]
  period: 10s
  xpack.enabled: true
  
  # è‡ªå®šä¹‰å­—æ®µ
  fields:
    environment: "production"
    datacenter: "dc-01"
    service: "log-collection"
  
  # å¤„ç†å™¨é…ç½®
  processors:
  - add_fields:
      target: monitoring
      fields:
        source: filebeat
        version: "8.10.0"
```

### 3.3 ç›‘æ§æŒ‡æ ‡è¿‡æ»¤


**ğŸ¯ ç­›é€‰é‡è¦æŒ‡æ ‡**

```yaml
monitoring:
  enabled: true
  
  # æŒ‡æ ‡è¿‡æ»¤é…ç½®
  metrics:
    # åªæ”¶é›†å…³é”®æŒ‡æ ‡
    include:
      - "libbeat.pipeline.*"
      - "system.cpu.*"
      - "system.memory.*"
      - "filebeat.harvester.*"
    
    # æ’é™¤ä¸éœ€è¦çš„æŒ‡æ ‡
    exclude:
      - "*.debug.*"
      - "*.test.*"
  
  # å¤„ç†å™¨é…ç½®
  processors:
  - drop_fields:
      fields: ["beat.hostname", "beat.name"]
      when:
        equals:
          monitoring.type: "beat"
```

---

## 4. ğŸ¥ æ€§èƒ½æŒ‡æ ‡ä¸å¥åº·æ£€æŸ¥


### 4.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡è§£è¯»**

```yaml
# æ€§èƒ½ç›‘æ§é…ç½®æ¨¡æ¿
monitoring:
  enabled: true
  
  # æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  metrics:
    # CPUç›‘æ§
    system.cpu:
      enabled: true
      period: 10s
      
    # å†…å­˜ç›‘æ§  
    system.memory:
      enabled: true
      period: 10s
      
    # æ–‡ä»¶ç³»ç»Ÿç›‘æ§
    system.filesystem:
      enabled: true
      period: 30s
      
    # ç½‘ç»œç›‘æ§
    system.network:
      enabled: true
      period: 10s
```

**ğŸ” æ€§èƒ½æŒ‡æ ‡è¯´æ˜**

```
CPUæŒ‡æ ‡è§£è¯»ï¼š
â€¢ system.cpu.user.pct: ç”¨æˆ·æ€CPUä½¿ç”¨ç‡
â€¢ system.cpu.system.pct: ç³»ç»Ÿæ€CPUä½¿ç”¨ç‡  
â€¢ system.cpu.total.pct: æ€»CPUä½¿ç”¨ç‡

å†…å­˜æŒ‡æ ‡è§£è¯»ï¼š
â€¢ system.memory.used.bytes: å·²ä½¿ç”¨å†…å­˜å­—èŠ‚æ•°
â€¢ system.memory.used.pct: å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”
â€¢ system.memory.available.bytes: å¯ç”¨å†…å­˜å­—èŠ‚æ•°

ç½‘ç»œæŒ‡æ ‡è§£è¯»ï¼š
â€¢ system.network.in.bytes: æ¥æ”¶å­—èŠ‚æ•°
â€¢ system.network.out.bytes: å‘é€å­—èŠ‚æ•°
â€¢ system.network.in.packets: æ¥æ”¶åŒ…æ•°
```

### 4.2 å¥åº·æ£€æŸ¥é…ç½®


**ğŸ’Š å¥åº·çŠ¶æ€ç›‘æ§**

```yaml
# å¥åº·æ£€æŸ¥HTTPç«¯ç‚¹é…ç½®
http:
  enabled: true
  host: "0.0.0.0"
  port: 5066
  
  # å¥åº·æ£€æŸ¥è·¯å¾„
  endpoints:
    - path: "/health"
      method: "GET"
      
    - path: "/stats"
      method: "GET"
      
    - path: "/metrics"
      method: "GET"

# å¥åº·æ£€æŸ¥è„šæœ¬é…ç½®
monitoring:
  http:
    enabled: true
    bind_address: "127.0.0.1:5066"
    
    # å¥åº·æ£€æŸ¥è¿”å›çš„ä¿¡æ¯
    health:
      enabled: true
      path: "/health"
      
    # ç»Ÿè®¡ä¿¡æ¯ç«¯ç‚¹
    stats:
      enabled: true
      path: "/stats"
```

**ğŸ©º å¥åº·æ£€æŸ¥ä½¿ç”¨ç¤ºä¾‹**

```bash
# æ£€æŸ¥Filebeatå¥åº·çŠ¶æ€
curl -X GET "localhost:5066/health"

# è¿”å›ç¤ºä¾‹ï¼š
{
  "status": "green",
  "name": "filebeat",
  "version": "8.10.0",
  "uptime": "2h30m15s"
}

# è·å–ç»Ÿè®¡ä¿¡æ¯
curl -X GET "localhost:5066/stats"
```

### 4.3 æ€§èƒ½é˜ˆå€¼è®¾ç½®


**âš–ï¸ æ€§èƒ½é˜ˆå€¼ç›‘æ§é…ç½®**

```yaml
# æ€§èƒ½é˜ˆå€¼ç›‘æ§é…ç½®
monitoring:
  enabled: true
  
  # é˜ˆå€¼è®¾ç½®
  thresholds:
    # CPUä½¿ç”¨ç‡é˜ˆå€¼
    cpu:
      warning: 70    # 70%æ—¶å‘å‡ºè­¦å‘Š
      critical: 90   # 90%æ—¶å‘å‡ºä¸¥é‡è­¦å‘Š
      
    # å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼  
    memory:
      warning: 80    # 80%æ—¶å‘å‡ºè­¦å‘Š
      critical: 95   # 95%æ—¶å‘å‡ºä¸¥é‡è­¦å‘Š
      
    # é˜Ÿåˆ—ä½¿ç”¨ç‡é˜ˆå€¼
    queue:
      warning: 75    # 75%æ—¶å‘å‡ºè­¦å‘Š
      critical: 90   # 90%æ—¶å‘å‡ºä¸¥é‡è­¦å‘Š

  # å‘Šè­¦å¤„ç†å™¨
  processors:
  - script:
      lang: javascript
      source: |
        function process(event) {
          var cpu = event.Get("system.cpu.total.pct");
          if (cpu > 0.9) {
            event.Put("alert.level", "critical");
            event.Put("alert.message", "CPUä½¿ç”¨ç‡è¿‡é«˜: " + cpu);
          } else if (cpu > 0.7) {
            event.Put("alert.level", "warning");
            event.Put("alert.message", "CPUä½¿ç”¨ç‡è¾ƒé«˜: " + cpu);
          }
        }
```

---

## 5. ğŸš¨ ç›‘æ§å‘Šè­¦è®¾ç½®


### 5.1 åŸºç¡€å‘Šè­¦é…ç½®


**ğŸ“¢ å‘Šè­¦è§„åˆ™è®¾ç½®**

```yaml
# å‘Šè­¦é…ç½®æ¨¡æ¿
monitoring:
  enabled: true
  
  # å‘Šè­¦è®¾ç½®
  alerts:
    # å¯ç”¨å‘Šè­¦åŠŸèƒ½
    enabled: true
    
    # å‘Šè­¦æ£€æŸ¥é—´éš”
    check_interval: 60s
    
    # å‘Šè­¦è§„åˆ™
    rules:
      # CPUä½¿ç”¨ç‡å‘Šè­¦
      - name: "high_cpu_usage"
        condition: "system.cpu.total.pct > 0.8"
        message: "Filebeat CPUä½¿ç”¨ç‡è¶…è¿‡80%"
        severity: "warning"
        
      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - name: "high_memory_usage"  
        condition: "system.memory.used.pct > 0.9"
        message: "Filebeatå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%"
        severity: "critical"
        
      # æ—¥å¿—å¤„ç†å»¶è¿Ÿå‘Šè­¦
      - name: "high_latency"
        condition: "libbeat.pipeline.events.failed > 100"
        message: "æ—¥å¿—å¤„ç†å¤±è´¥æ•°é‡è¿‡å¤š"
        severity: "warning"

# å‘Šè­¦è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["localhost:9200"]
  
  # å‘Šè­¦ç´¢å¼•é…ç½®
  when.equals:
    alert.level: "critical"
  index: "filebeat-alerts-critical-%{+yyyy.MM.dd}"

output.elasticsearch:
  hosts: ["localhost:9200"]
  
  # ä¸€èˆ¬å‘Šè­¦ç´¢å¼•
  when.equals:
    alert.level: "warning"  
  index: "filebeat-alerts-warning-%{+yyyy.MM.dd}"
```

### 5.2 å‘Šè­¦é€šçŸ¥é…ç½®


**ğŸ“§ å¤šæ¸ é“å‘Šè­¦é€šçŸ¥**

```yaml
# å‘Šè­¦é€šçŸ¥é…ç½®
monitoring:
  alerts:
    enabled: true
    
    # é‚®ä»¶é€šçŸ¥é…ç½®
    email:
      enabled: true
      smtp:
        host: "smtp.company.com"
        port: 587
        username: "alerts@company.com"
        password: "your_password"
        
      # æ”¶ä»¶äººé…ç½®
      recipients:
        - "ops-team@company.com"
        - "dev-team@company.com"
        
      # é‚®ä»¶æ¨¡æ¿
      subject: "[FILEBEAT ALERT] {{.alert.name}}"
      body: |
        å‘Šè­¦æ—¶é—´: {{.timestamp}}
        å‘Šè­¦çº§åˆ«: {{.alert.severity}}
        å‘Šè­¦ä¿¡æ¯: {{.alert.message}}
        ä¸»æœºä¿¡æ¯: {{.beat.hostname}}
        
    # Webhooké€šçŸ¥é…ç½®
    webhook:
      enabled: true
      url: "https://hooks.slack.com/services/your/webhook/url"
      method: "POST"
      headers:
        Content-Type: "application/json"
      body: |
        {
          "text": "Filebeatå‘Šè­¦: {{.alert.message}}",
          "username": "filebeat-monitor",
          "channel": "#ops-alerts"
        }
```

### 5.3 å‘Šè­¦æŠ‘åˆ¶é…ç½®


**ğŸ”‡ é¿å…å‘Šè­¦é£æš´**

```yaml
# å‘Šè­¦æŠ‘åˆ¶é…ç½®
monitoring:
  alerts:
    enabled: true
    
    # å‘Šè­¦æŠ‘åˆ¶è®¾ç½®
    suppression:
      # ç›¸åŒå‘Šè­¦çš„æŠ‘åˆ¶æ—¶é—´
      duplicate_interval: 300s  # 5åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªå‘é€ä¸€æ¬¡
      
      # å‘Šè­¦æ¢å¤é€šçŸ¥
      resolve_timeout: 600s     # 10åˆ†é’Ÿåå¦‚æœé—®é¢˜è§£å†³å‘é€æ¢å¤é€šçŸ¥
      
      # ç»´æŠ¤æ¨¡å¼
      maintenance_mode:
        enabled: false
        start_time: "02:00"     # ç»´æŠ¤å¼€å§‹æ—¶é—´
        end_time: "04:00"       # ç»´æŠ¤ç»“æŸæ—¶é—´
        days: ["saturday"]      # ç»´æŠ¤æ—¥æœŸ
        
    # å‘Šè­¦åˆ†ç»„é…ç½®
    grouping:
      # æŒ‰ä¸»æœºåˆ†ç»„
      group_by: ["beat.hostname"]
      
      # åˆ†ç»„é—´éš”
      group_interval: 60s
      
      # åˆ†ç»„ç­‰å¾…æ—¶é—´
      group_wait: 30s
```

---

## 6. ğŸ’¾ ç›‘æ§æ•°æ®å­˜å‚¨ä¸å¯è§†åŒ–


### 6.1 ç›‘æ§æ•°æ®å­˜å‚¨é…ç½®


**ğŸ—„ï¸ Elasticsearchå­˜å‚¨ä¼˜åŒ–**

```yaml
# ç›‘æ§æ•°æ®å­˜å‚¨é…ç½®
monitoring:
  elasticsearch:
    hosts: ["es-monitoring:9200"]
    
    # ç›‘æ§ç´¢å¼•é…ç½®
    index: "filebeat-monitoring-%{+yyyy.MM.dd}"
    
    # ç´¢å¼•æ¨¡æ¿é…ç½®
    template:
      settings:
        # ç´¢å¼•è®¾ç½®
        index:
          number_of_shards: 1
          number_of_replicas: 1
          refresh_interval: "30s"
          
        # ç”Ÿå‘½å‘¨æœŸç®¡ç†
        lifecycle:
          name: "filebeat-monitoring-policy"
          rollover_alias: "filebeat-monitoring"
          
    # ILMç­–ç•¥é…ç½®
    ilm:
      enabled: true
      rollover_alias: "filebeat-monitoring"
      pattern: "{now/d}-000001"
      policy: |
        {
          "policy": {
            "phases": {
              "hot": {
                "actions": {
                  "rollover": {
                    "max_size": "1GB",
                    "max_age": "1d"
                  }
                }
              },
              "warm": {
                "min_age": "7d",
                "actions": {
                  "allocate": {
                    "number_of_replicas": 0
                  }
                }
              },
              "delete": {
                "min_age": "30d"
              }
            }
          }
        }
```

### 6.2 Kibanaä»ªè¡¨æ¿é…ç½®


**ğŸ“Š ç›‘æ§ä»ªè¡¨æ¿è®¾ç½®**

```yaml
# Kibanaä»ªè¡¨æ¿å¯¼å…¥é…ç½®
setup.kibana:
  host: "kibana:5601"
  
  # ä»ªè¡¨æ¿é…ç½®
  dashboards:
    enabled: true
    directory: "/usr/share/filebeat/kibana"
    
    # è‡ªå®šä¹‰ä»ªè¡¨æ¿é…ç½®
    index: "filebeat-monitoring-*"
    
# ä»ªè¡¨æ¿å†…å®¹é…ç½®
setup.template:
  enabled: true
  pattern: "filebeat-monitoring-*"
  
  settings:
    # ä»ªè¡¨æ¿å­—æ®µé…ç½®
    _source:
      enabled: true
      
    # å¯è§†åŒ–é…ç½®  
    mappings:
      properties:
        "@timestamp":
          type: date
          format: "strict_date_optional_time||epoch_millis"
          
        "system.cpu.total.pct":
          type: float
          
        "system.memory.used.pct":
          type: float
          
        "libbeat.pipeline.events.total":
          type: long
```

**ğŸ¨ å¯è§†åŒ–å›¾è¡¨é…ç½®ç¤ºä¾‹**

```json
{
  "ä»ªè¡¨æ¿é…ç½®": {
    "CPUä½¿ç”¨ç‡å›¾è¡¨": {
      "type": "line",
      "field": "system.cpu.total.pct",
      "interval": "1m",
      "title": "Filebeat CPUä½¿ç”¨ç‡è¶‹åŠ¿"
    },
    
    "å†…å­˜ä½¿ç”¨ç‡å›¾è¡¨": {
      "type": "area",
      "field": "system.memory.used.pct", 
      "interval": "1m",
      "title": "Filebeatå†…å­˜ä½¿ç”¨ç‡è¶‹åŠ¿"
    },
    
    "äº‹ä»¶å¤„ç†é‡å›¾è¡¨": {
      "type": "histogram",
      "field": "libbeat.pipeline.events.total",
      "interval": "5m", 
      "title": "æ—¥å¿—äº‹ä»¶å¤„ç†é‡ç»Ÿè®¡"
    },
    
    "é”™è¯¯ç»Ÿè®¡å›¾è¡¨": {
      "type": "pie",
      "field": "log.level",
      "title": "æ—¥å¿—çº§åˆ«åˆ†å¸ƒ"
    }
  }
}
```

### 6.3 ç›‘æ§æ•°æ®æŸ¥è¯¢


**ğŸ” å¸¸ç”¨ç›‘æ§æŸ¥è¯¢è¯­å¥**

```json
// Kibana Dev Tools æŸ¥è¯¢ç¤ºä¾‹

// 1. æŸ¥è¯¢CPUä½¿ç”¨ç‡è¶‹åŠ¿
GET filebeat-monitoring-*/_search
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-1h"
      }
    }
  },
  "aggs": {
    "cpu_usage": {
      "date_histogram": {
        "field": "@timestamp",
        "fixed_interval": "1m"
      },
      "aggs": {
        "avg_cpu": {
          "avg": {
            "field": "system.cpu.total.pct"
          }
        }
      }
    }
  }
}

// 2. æŸ¥è¯¢é”™è¯¯æ—¥å¿—
GET filebeat-monitoring-*/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "log.level": "error"
          }
        },
        {
          "range": {
            "@timestamp": {
              "gte": "now-24h"
            }
          }
        }
      ]
    }
  },
  "sort": [
    {
      "@timestamp": {
        "order": "desc"
      }
    }
  ]
}

// 3. æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡
GET filebeat-monitoring-*/_search
{
  "size": 0,
  "aggs": {
    "performance_stats": {
      "terms": {
        "field": "beat.hostname.keyword"
      },
      "aggs": {
        "avg_cpu": {
          "avg": {
            "field": "system.cpu.total.pct"
          }
        },
        "avg_memory": {
          "avg": {
            "field": "system.memory.used.pct"
          }
        },
        "total_events": {
          "sum": {
            "field": "libbeat.pipeline.events.total"
          }
        }
      }
    }
  }
}
```

---

## 7. ğŸ› ï¸ å®é™…ç›‘æ§é…ç½®æ¡ˆä¾‹


### 7.1 ç”Ÿäº§ç¯å¢ƒç›‘æ§é…ç½®


**ğŸ­ å®Œæ•´ç”Ÿäº§ç¯å¢ƒé…ç½®**

```yaml
# production-monitoring.yml
# ç”Ÿäº§ç¯å¢ƒFilebeatç›‘æ§é…ç½®

filebeat.inputs:
- type: log
  paths:
    - /var/log/apache2/*.log
    - /var/log/nginx/*.log
  fields:
    service: web-server
    environment: production

# ç›‘æ§é…ç½®
monitoring:
  enabled: true
  
  # ç›‘æ§æ•°æ®è¾“å‡ºåˆ°ä¸“ç”¨é›†ç¾¤
  elasticsearch:
    hosts: 
      - "monitoring-es-01:9200"
      - "monitoring-es-02:9200"
      - "monitoring-es-03:9200"
    
    # å®‰å…¨é…ç½®
    username: "filebeat_monitor"
    password: "${MONITOR_PASSWORD}"
    
    ssl:
      enabled: true
      verification_mode: certificate
      certificate_authorities: ["/etc/ssl/ca.crt"]
      certificate: "/etc/ssl/filebeat.crt"
      key: "/etc/ssl/filebeat.key"
    
    # æ€§èƒ½ä¼˜åŒ–é…ç½®
    bulk_max_size: 1000
    timeout: 30s
    compression_level: 3
    
    # ç´¢å¼•é…ç½®
    index: "filebeat-monitoring-prod-%{+yyyy.MM.dd}"
    
  # ç›‘æ§æŒ‡æ ‡é…ç½®
  period: 30s
  
  metrics:
    system:
      cpu: true
      memory: true
      network: true
      filesystem: true
      
    beat:
      info: true
      memstats: true
      runtime: true

# æ—¥å¿—é…ç½®
logging:
  level: info
  to_files: true
  files:
    path: /var/log/filebeat
    name: filebeat-monitoring
    keepfiles: 10
    permissions: 0644
    interval: 24h
  
  # ç›‘æ§ç‰¹å®šçš„æ—¥å¿—é€‰æ‹©å™¨
  selectors: ["monitoring", "elasticsearch", "pipeline"]

# HTTPç›‘æ§ç«¯ç‚¹
http:
  enabled: true
  host: "127.0.0.1"
  port: 5066
  
# å¤„ç†å™¨é…ç½®
processors:
# æ·»åŠ ç¯å¢ƒæ ‡è¯†
- add_fields:
    target: meta
    fields:
      environment: production
      datacenter: dc-east-1
      
# æ·»åŠ ä¸»æœºä¿¡æ¯
- add_host_metadata:
    when.not.contains.tags: forwarded

# æ€§èƒ½é˜ˆå€¼æ£€æŸ¥
- script:
    lang: javascript
    source: |
      function process(event) {
        var cpu = event.Get("system.cpu.total.pct");
        var memory = event.Get("system.memory.used.pct");
        
        if (cpu > 0.8 || memory > 0.85) {
          event.Put("alert.triggered", true);
          event.Put("alert.level", "warning");
        }
        
        if (cpu > 0.9 || memory > 0.95) {
          event.Put("alert.level", "critical");
        }
      }
```

### 7.2 å¼€å‘ç¯å¢ƒç›‘æ§é…ç½®


**ğŸ”§ å¼€å‘ç¯å¢ƒç®€åŒ–é…ç½®**

```yaml
# development-monitoring.yml
# å¼€å‘ç¯å¢ƒç›‘æ§é…ç½®

filebeat.inputs:
- type: log
  paths:
    - /app/logs/*.log
  fields:
    environment: development

# ç®€åŒ–ç›‘æ§é…ç½®
monitoring:
  enabled: true
  
  # æœ¬åœ°Elasticsearch
  elasticsearch:
    hosts: ["localhost:9200"]
    index: "filebeat-monitoring-dev-%{+yyyy.MM.dd}"
    
  # è¾ƒé•¿çš„æ”¶é›†é—´éš”
  period: 60s
  
  # åŸºç¡€æŒ‡æ ‡
  metrics:
    system:
      cpu: true
      memory: true
    beat:
      info: true

# å¼€å‘ç¯å¢ƒæ—¥å¿—
logging:
  level: debug
  to_stderr: true
  
# HTTPç›‘æ§
http:
  enabled: true
  host: "0.0.0.0"
  port: 5066

# ç®€å•å¤„ç†å™¨
processors:
- add_fields:
    target: ""
    fields:
      environment: development
```

### 7.3 å¾®æœåŠ¡ç¯å¢ƒç›‘æ§é…ç½®


**ğŸ”„ å¾®æœåŠ¡æ¶æ„ç›‘æ§**

```yaml
# microservice-monitoring.yml
# å¾®æœåŠ¡ç¯å¢ƒç›‘æ§é…ç½®

filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # å®¹å™¨æ—¥å¿—è§£æ
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"

# å¾®æœåŠ¡ç›‘æ§é…ç½®
monitoring:
  enabled: true
  
  elasticsearch:
    hosts: ["${ELASTICSEARCH_HOSTS}"]
    username: "${ELASTIC_USERNAME}"
    password: "${ELASTIC_PASSWORD}"
    
    # æœåŠ¡å‘ç°é…ç½®
    service_discovery:
      enabled: true
      type: "docker"
      
  # å¿«é€Ÿç›‘æ§é—´éš”
  period: 15s
  
  # å®¹å™¨ç‰¹å®šæŒ‡æ ‡
  metrics:
    system:
      cpu: true
      memory: true
      network: true
      
    docker:
      containers: true
      cpu: true
      memory: true
      network: true

# å®¹å™¨ç¯å¢ƒå¤„ç†å™¨
processors:
# æå–å®¹å™¨ä¿¡æ¯
- add_docker_metadata:
    host: "unix:///var/run/docker.sock"
    
# æ·»åŠ Kuberneteså…ƒæ•°æ®
- add_kubernetes_metadata:
    host: "${HOSTNAME}"
    indexers:
    - ip_port:
    matchers:
    - fields:
        lookup_fields: ["container.id"]

# æœåŠ¡æ ‡è¯†
- add_fields:
    target: service
    fields:
      name: "${SERVICE_NAME}"
      version: "${SERVICE_VERSION}"
      instance: "${HOSTNAME}"

# åŠ¨æ€å­—æ®µæ˜ å°„
- script:
    lang: javascript
    source: |
      function process(event) {
        var containerName = event.Get("container.name");
        if (containerName) {
          event.Put("service.type", containerName.split("-")[0]);
        }
      }
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„ç›‘æ§æ¦‚å¿µ


```
ğŸ”¸ ç›‘æ§æœ¬è´¨ï¼šå®æ—¶äº†è§£Filebeatè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½è¡¨ç°
ğŸ”¸ ç›‘æ§ç±»å‹ï¼šç³»ç»Ÿç›‘æ§ï¼ˆCPU/å†…å­˜ï¼‰+ ä¸šåŠ¡ç›‘æ§ï¼ˆæ—¥å¿—å¤„ç†é‡ï¼‰
ğŸ”¸ ç›‘æ§æµç¨‹ï¼šæ•°æ®æ”¶é›† â†’ å­˜å‚¨ â†’ å¯è§†åŒ– â†’ å‘Šè­¦
ğŸ”¸ é…ç½®é‡ç‚¹ï¼šåˆç†è®¾ç½®æ”¶é›†é—´éš”ï¼Œé¿å…ç›‘æ§æ•°æ®è¿‡å¤š
ğŸ”¸ å®é™…ä»·å€¼ï¼šåŠæ—¶å‘ç°é—®é¢˜ï¼Œä¿éšœæ—¥å¿—æ”¶é›†ç³»ç»Ÿç¨³å®šè¿è¡Œ
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ ç›‘æ§é…ç½®çš„æ ¸å¿ƒåŸåˆ™**
```
é€‚åº¦åŸåˆ™ï¼š
â€¢ ä¸è¦æ”¶é›†è¿‡å¤šä¸å¿…è¦çš„æŒ‡æ ‡
â€¢ åˆç†è®¾ç½®ç›‘æ§é—´éš”ï¼ˆ10-60ç§’ï¼‰
â€¢ é¿å…ç›‘æ§æ•°æ®å ç”¨è¿‡å¤šèµ„æº

é‡ç‚¹ç›‘æ§ï¼š
â€¢ CPUå’Œå†…å­˜ä½¿ç”¨ç‡ï¼ˆç³»ç»Ÿå¥åº·ï¼‰
â€¢ æ—¥å¿—å¤„ç†é‡å’ŒæˆåŠŸç‡ï¼ˆä¸šåŠ¡å¥åº·ï¼‰  
â€¢ é”™è¯¯æ—¥å¿—å’Œå¼‚å¸¸æƒ…å†µï¼ˆé—®é¢˜æ’æŸ¥ï¼‰
â€¢ ç½‘ç»œå’Œç£ç›˜IOï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰

å‘Šè­¦ç­–ç•¥ï¼š
â€¢ è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
â€¢ é¿å…å‘Šè­¦é£æš´
â€¢ å¤šæ¸ é“é€šçŸ¥æœºåˆ¶
```

**ğŸ”¹ å®é™…éƒ¨ç½²å»ºè®®**
```
ç”Ÿäº§ç¯å¢ƒï¼š
â€¢ å¯ç”¨å®Œæ•´ç›‘æ§åŠŸèƒ½
â€¢ é…ç½®å‘Šè­¦é€šçŸ¥
â€¢ ä½¿ç”¨ä¸“ç”¨ç›‘æ§é›†ç¾¤
â€¢ è®¾ç½®æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

å¼€å‘ç¯å¢ƒï¼š
â€¢ ç®€åŒ–ç›‘æ§é…ç½®
â€¢ é‡ç‚¹å…³æ³¨é”™è¯¯æ—¥å¿—
â€¢ æœ¬åœ°å­˜å‚¨å³å¯

æµ‹è¯•ç¯å¢ƒï¼š
â€¢ ä¸­ç­‰ç¨‹åº¦ç›‘æ§
â€¢ é‡ç‚¹æµ‹è¯•ç›‘æ§é…ç½®
â€¢ éªŒè¯å‘Šè­¦æœºåˆ¶
```

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ ç›‘æ§å¸¸è§é—®é¢˜**

| é—®é¢˜æè¿° | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| ğŸš« ç›‘æ§æ•°æ®ä¸æ˜¾ç¤º | `ç›‘æ§æœªå¯ç”¨æˆ–é…ç½®é”™è¯¯` | `æ£€æŸ¥monitoring.enabledå’ŒESè¿æ¥` |
| ğŸ“ˆ ç›‘æ§æ•°æ®è¿‡å¤š | `æ”¶é›†é—´éš”å¤ªçŸ­æˆ–æŒ‡æ ‡å¤ªå¤š` | `è°ƒæ•´periodå‚æ•°ï¼Œç²¾ç®€æŒ‡æ ‡` |
| âš ï¸ å‘Šè­¦ä¸è§¦å‘ | `é˜ˆå€¼è®¾ç½®ä¸å½“æˆ–è§„åˆ™é”™è¯¯` | `æ£€æŸ¥å‘Šè­¦æ¡ä»¶å’Œé˜ˆå€¼è®¾ç½®` |
| ğŸŒ ç›‘æ§å½±å“æ€§èƒ½ | `ç›‘æ§å¼€é”€è¿‡å¤§` | `å‡å°‘ç›‘æ§é¢‘ç‡ï¼Œä¼˜åŒ–é…ç½®` |

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
- **æ¸è¿›å¼é…ç½®**ï¼šä»åŸºç¡€ç›‘æ§å¼€å§‹ï¼Œé€æ­¥å®Œå–„
- **åœºæ™¯åŒ–é…ç½®**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„ç›‘æ§ç­–ç•¥  
- **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ç›‘æ§æ•°æ®å’Œå‘Šè­¦è§„åˆ™
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ç›‘æ§é…ç½®å’Œå‘Šè­¦å¤„ç†æµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç›‘æ§é…ç½®è¦é€‚åº¦ï¼Œå…³é”®æŒ‡æ ‡ä¸èƒ½å°‘
- å‘Šè­¦é˜ˆå€¼è¦åˆç†ï¼Œé¿å…é£æš´å¾ˆé‡è¦  
- å­˜å‚¨ç­–ç•¥è¦è§„åˆ’ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†å¥½
- å¯è§†åŒ–å›¾è¡¨è¦æ¸…æ™°ï¼Œé—®é¢˜æ’æŸ¥æ•ˆç‡é«˜