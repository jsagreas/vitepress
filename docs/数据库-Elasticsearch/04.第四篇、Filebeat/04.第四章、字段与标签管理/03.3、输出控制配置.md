---
title: 3ã€è¾“å‡ºæ§åˆ¶é…ç½®
---
## ğŸ“š ç›®å½•

1. [è¾“å‡ºæ§åˆ¶åŸºç¡€æ¦‚å¿µ](#1-è¾“å‡ºæ§åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [Pipelineç®¡é“è®¾ç½®è¯¦è§£](#2-Pipelineç®¡é“è®¾ç½®è¯¦è§£)
3. [Indexç´¢å¼•æŒ‡å®šé…ç½®](#3-Indexç´¢å¼•æŒ‡å®šé…ç½®)
4. [Document_typeæ–‡æ¡£ç±»å‹](#4-Document_typeæ–‡æ¡£ç±»å‹)
5. [JSONå­—æ®µå¤„ç†é…ç½®](#5-JSONå­—æ®µå¤„ç†é…ç½®)
6. [è‡ªå®šä¹‰å­—æ®µæ·»åŠ ](#6-è‡ªå®šä¹‰å­—æ®µæ·»åŠ )
7. [æ ‡ç­¾ç®¡ç†ç­–ç•¥](#7-æ ‡ç­¾ç®¡ç†ç­–ç•¥)
8. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#8-å®æˆ˜é…ç½®æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¾“å‡ºæ§åˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¾“å‡ºæ§åˆ¶


**ç®€å•ç†è§£**ï¼šè¾“å‡ºæ§åˆ¶å°±æ˜¯å‘Šè¯‰Filebeat"æŠŠæ”¶é›†åˆ°çš„æ—¥å¿—æ•°æ®æ€ä¹ˆå¤„ç†ã€å‘é€åˆ°å“ªé‡Œã€ä»¥ä»€ä¹ˆæ ¼å¼å‘é€"

```
æ—¥å¿—æ–‡ä»¶ â†’ Filebeatæ”¶é›† â†’ è¾“å‡ºæ§åˆ¶å¤„ç† â†’ å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ

æƒ³è±¡æˆå¿«é€’æ‰“åŒ…ï¼š
åŸå§‹æ—¥å¿— = è¦å¯„çš„ç‰©å“
è¾“å‡ºæ§åˆ¶ = æ‰“åŒ…è§„åˆ™ï¼ˆç”¨ä»€ä¹ˆç›’å­ã€è´´ä»€ä¹ˆæ ‡ç­¾ã€å†™ä»€ä¹ˆåœ°å€ï¼‰
ç›®æ ‡ç³»ç»Ÿ = æ”¶ä»¶äºº
```

### 1.2 è¾“å‡ºæ§åˆ¶çš„æ ¸å¿ƒä½œç”¨


**ğŸ”¸ æ•°æ®è·¯ç”±**ï¼šå†³å®šæ•°æ®å‘é€åˆ°å“ªä¸ªç´¢å¼•ã€å“ªä¸ªç®¡é“
```
ä¸åŒç±»å‹æ—¥å¿— â†’ ä¸åŒå¤„ç†æ–¹å¼ â†’ ä¸åŒå­˜å‚¨ä½ç½®
Webæ—¥å¿— â†’ web-logs-2024.01.01
é”™è¯¯æ—¥å¿— â†’ error-logs-2024.01.01
è®¿é—®æ—¥å¿— â†’ access-logs-2024.01.01
```

**ğŸ”¸ æ•°æ®æ ¼å¼åŒ–**ï¼šç»Ÿä¸€æ•°æ®æ ¼å¼ï¼Œæ·»åŠ å¿…è¦å­—æ®µ
```
åŸå§‹æ—¥å¿—ï¼š[2024-01-01 10:30:00] ERROR: Database connection failed
å¤„ç†åï¼š{
  "timestamp": "2024-01-01T10:30:00",
  "level": "ERROR", 
  "message": "Database connection failed",
  "source": "app.log",
  "environment": "production"
}
```

**ğŸ”¸ æ•°æ®å¢å¼º**ï¼šä¸ºæ—¥å¿—æ·»åŠ é¢å¤–ä¿¡æ¯ï¼Œä¾¿äºåç»­åˆ†æ

### 1.3 è¾“å‡ºæ§åˆ¶é…ç½®ç»“æ„


```
è¾“å‡ºæ§åˆ¶é…ç½®çš„å±‚æ¬¡ç»“æ„ï¼š
â”œâ”€â”€ output.elasticsearch          # è¾“å‡ºç›®æ ‡é…ç½®
â”‚   â”œâ”€â”€ hosts                    # ç›®æ ‡æœåŠ¡å™¨
â”‚   â”œâ”€â”€ index                    # ç´¢å¼•åç§°
â”‚   â”œâ”€â”€ pipeline                 # å¤„ç†ç®¡é“
â”‚   â””â”€â”€ template                 # ç´¢å¼•æ¨¡æ¿
â”œâ”€â”€ processors                   # æ•°æ®å¤„ç†å™¨
â”‚   â”œâ”€â”€ add_fields               # æ·»åŠ å­—æ®µ
â”‚   â”œâ”€â”€ add_tags                 # æ·»åŠ æ ‡ç­¾
â”‚   â””â”€â”€ drop_fields              # åˆ é™¤å­—æ®µ
â””â”€â”€ fields                       # å­—æ®µå®šä¹‰
```

---

## 2. ğŸ”§ Pipelineç®¡é“è®¾ç½®è¯¦è§£


### 2.1 Pipelineç®¡é“çš„æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šPipelineå°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œæ¯ä¸ªç¯èŠ‚å¯¹æ•°æ®è¿›è¡Œç‰¹å®šçš„åŠ å·¥å¤„ç†

```
æ•°æ®æµæ°´çº¿ç¤ºä¾‹ï¼š
åŸå§‹æ—¥å¿— â†’ è§£ææ—¶é—´ â†’ æå–IP â†’ è¯†åˆ«åœ°ç†ä½ç½® â†’ åˆ†ç±»æ ‡è®° â†’ å­˜å‚¨

å®é™…å¯¹åº”ï¼š
æ—¥å¿—æ–‡æœ¬ â†’ parse_timestamp â†’ extract_ip â†’ geoip â†’ categorize â†’ elasticsearch
```

### 2.2 Pipelineé…ç½®æ–¹æ³•


**ğŸ”¸ å…¨å±€Pipelineè®¾ç½®**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  # æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡åŒä¸€ä¸ªç®¡é“å¤„ç†
  pipeline: "filebeat-default-pipeline"
```

**ğŸ”¸ æ¡ä»¶Pipelineè®¾ç½®**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  pipelines:
    - pipeline: "nginx-pipeline"
      when.contains:
        fields.log_type: "nginx"
    - pipeline: "error-pipeline" 
      when.contains:
        fields.level: "error"
    - pipeline: "default-pipeline"  # é»˜è®¤ç®¡é“
```

### 2.3 Pipelineçš„å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯ä¸€ï¼šWebæ—¥å¿—å¤„ç†**
```
nginxè®¿é—®æ—¥å¿— â†’ nginx-pipelineå¤„ç†ï¼š
1. è§£æè®¿é—®æ—¥å¿—æ ¼å¼
2. æå–IPåœ°å€å’ŒUser-Agent
3. è¿›è¡Œåœ°ç†ä½ç½®è¯†åˆ«
4. è®¡ç®—å“åº”æ—¶é—´åˆ†ç±»
5. æ·»åŠ è®¿é—®ç±»å‹æ ‡ç­¾
```

**åœºæ™¯äºŒï¼šåº”ç”¨é”™è¯¯æ—¥å¿—**
```
åº”ç”¨é”™è¯¯æ—¥å¿— â†’ error-pipelineå¤„ç†ï¼š
1. è§£æé”™è¯¯çº§åˆ«
2. æå–å †æ ˆä¿¡æ¯
3. è¯†åˆ«é”™è¯¯ç±»å‹
4. æ·»åŠ å‘Šè­¦æ ‡ç­¾
5. è®¡ç®—é”™è¯¯é¢‘ç‡
```

### 2.4 Pipelineé…ç½®æœ€ä½³å®è·µ


**ğŸ’¡ å‘½åè§„èŒƒ**
```yaml
# æ¨èçš„å‘½åæ–¹å¼
pipeline: "åº”ç”¨å-æ—¥å¿—ç±»å‹-å¤„ç†ç›®çš„"

ç¤ºä¾‹ï¼š
- "web-nginx-access"     # WebæœåŠ¡å™¨Nginxè®¿é—®æ—¥å¿—
- "app-java-error"       # Javaåº”ç”¨é”™è¯¯æ—¥å¿—  
- "db-mysql-slow"        # MySQLæ…¢æŸ¥è¯¢æ—¥å¿—
```

**âš¡ æ€§èƒ½è€ƒè™‘**
```yaml
# é¿å…å¤æ‚çš„Pipelineå¤„ç†å½±å“æ€§èƒ½
output.elasticsearch:
  hosts: ["localhost:9200"]
  pipeline: "simple-parse-only"  # åªåšå¿…è¦çš„è§£æ
  worker: 2                      # å¢åŠ å¤„ç†çº¿ç¨‹
  bulk_max_size: 1000           # æ‰¹é‡å‘é€ä¼˜åŒ–
```

---

## 3. ğŸ“ Indexç´¢å¼•æŒ‡å®šé…ç½®


### 3.1 ç´¢å¼•æŒ‡å®šçš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦æŒ‡å®šç´¢å¼•ï¼Ÿ**
æƒ³è±¡Elasticsearchå°±åƒä¸€ä¸ªå·¨å¤§çš„å›¾ä¹¦é¦†ï¼š
- **ä¸æŒ‡å®šç´¢å¼•**ï¼šæ‰€æœ‰ä¹¦éƒ½å †åœ¨ä¸€èµ·ï¼Œæ‰¾ä¹¦å¾ˆå›°éš¾
- **æŒ‡å®šç´¢å¼•**ï¼šæŒ‰ç±»å‹åˆ†ç±»å­˜æ”¾ï¼ŒWebæ—¥å¿—ä¸€ä¸ªä¹¦æ¶ï¼Œé”™è¯¯æ—¥å¿—ä¸€ä¸ªä¹¦æ¶

```
ç´¢å¼•åˆ†ç±»ç¤ºä¾‹ï¼š
â”œâ”€â”€ web-logs-2024.01.01        # Webè®¿é—®æ—¥å¿—
â”œâ”€â”€ error-logs-2024.01.01      # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ performance-logs-2024.01.01 # æ€§èƒ½æ—¥å¿—
â””â”€â”€ security-logs-2024.01.01   # å®‰å…¨æ—¥å¿—
```

### 3.2 é™æ€ç´¢å¼•é…ç½®


**ğŸ”¸ å›ºå®šç´¢å¼•åç§°**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "my-application-logs"  # æ‰€æœ‰æ—¥å¿—éƒ½å­˜åˆ°è¿™ä¸ªç´¢å¼•
```

**ğŸ”¸ æŒ‰æ—¥æœŸåˆ†å‰²ç´¢å¼•**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  # æ¯å¤©åˆ›å»ºä¸€ä¸ªæ–°ç´¢å¼•ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†
  index: "application-logs-%{+yyyy.MM.dd}"
  
# ç»“æœï¼š
# application-logs-2024.01.01
# application-logs-2024.01.02
# application-logs-2024.01.03
```

### 3.3 åŠ¨æ€ç´¢å¼•é…ç½®


**ğŸ”¸ æ ¹æ®æ—¥å¿—ç±»å‹åŠ¨æ€åˆ†é…**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  indices:
    - index: "web-access-%{+yyyy.MM.dd}"
      when.contains:
        fields.log_type: "access"
    - index: "web-error-%{+yyyy.MM.dd}"
      when.contains:
        fields.log_type: "error"
    - index: "application-%{+yyyy.MM.dd}"  # é»˜è®¤ç´¢å¼•
```

**ğŸ”¸ æ ¹æ®æœåŠ¡å™¨åˆ†ç»„**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  indices:
    - index: "prod-logs-%{+yyyy.MM.dd}"
      when.contains:
        fields.environment: "production"
    - index: "test-logs-%{+yyyy.MM.dd}"
      when.contains:
        fields.environment: "test"
```

### 3.4 ç´¢å¼•å‘½åæœ€ä½³å®è·µ


**ğŸ“‹ æ¨èå‘½åè§„èŒƒ**
```
æ ¼å¼ï¼šé¡¹ç›®-ç»„ä»¶-ç±»å‹-æ—¥æœŸ
ç¤ºä¾‹ï¼š
- ecommerce-web-access-2024.01.01
- ecommerce-api-error-2024.01.01  
- ecommerce-db-slow-2024.01.01
```

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**
```yaml
# âŒ é”™è¯¯ç¤ºä¾‹ - ç´¢å¼•ååŒ…å«å¤§å†™å­—æ¯
index: "MyApp-Logs-2024.01.01"

# âœ… æ­£ç¡®ç¤ºä¾‹ - å…¨å°å†™ï¼Œç”¨è¿å­—ç¬¦åˆ†éš”
index: "myapp-logs-2024.01.01"

# âŒ é”™è¯¯ç¤ºä¾‹ - ç´¢å¼•åè¿‡é•¿
index: "very-long-application-name-with-detailed-description-logs-2024.01.01"

# âœ… æ­£ç¡®ç¤ºä¾‹ - ç®€æ´æ˜äº†
index: "myapp-logs-2024.01.01"
```

---

## 4. ğŸ“ Document_typeæ–‡æ¡£ç±»å‹


### 4.1 Document_typeçš„æ¦‚å¿µç†è§£


**ç®€å•æ¯”å–»**ï¼šå¦‚æœè¯´ç´¢å¼•æ˜¯å›¾ä¹¦é¦†çš„ä¹¦æ¶ï¼Œé‚£ä¹ˆdocument_typeå°±æ˜¯ä¹¦çš„åˆ†ç±»æ ‡ç­¾

```
åŒä¸€ä¸ªç´¢å¼•ä¸­çš„ä¸åŒæ–‡æ¡£ç±»å‹ï¼š
logs-2024.01.01 ç´¢å¼•ï¼š
â”œâ”€â”€ _doc (é»˜è®¤ç±»å‹)
â”‚   â”œâ”€â”€ è®¿é—®æ—¥å¿—æ–‡æ¡£
â”‚   â”œâ”€â”€ é”™è¯¯æ—¥å¿—æ–‡æ¡£
â”‚   â””â”€â”€ æ€§èƒ½æ—¥å¿—æ–‡æ¡£
```

> **ğŸ”” é‡è¦è¯´æ˜**ï¼šä»Elasticsearch 7.0å¼€å§‹ï¼Œä¸€ä¸ªç´¢å¼•åªèƒ½æœ‰ä¸€ä¸ªæ–‡æ¡£ç±»å‹ï¼Œé€šå¸¸ä½¿ç”¨`_doc`

### 4.2 Document_typeé…ç½®æ–¹æ³•


**ğŸ”¸ ä½¿ç”¨é»˜è®¤ç±»å‹**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "application-logs-2024.01.01"
  # ä¸æŒ‡å®šdocument_typeï¼Œè‡ªåŠ¨ä½¿ç”¨ _doc
```

**ğŸ”¸ æ˜ç¡®æŒ‡å®šç±»å‹ï¼ˆé€‚ç”¨äºæ—§ç‰ˆæœ¬ESï¼‰**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "application-logs-2024.01.01"
  document_type: "_doc"  # æ˜ç¡®æŒ‡å®šä½¿ç”¨_docç±»å‹
```

### 4.3 Document_typeçš„å†å²å˜åŒ–


**ğŸ“ˆ ç‰ˆæœ¬æ¼”è¿›å†ç¨‹**
```
Elasticsearchç‰ˆæœ¬å˜åŒ–ï¼š
ES 6.xä¹‹å‰ï¼šæ”¯æŒå¤šç§æ–‡æ¡£ç±»å‹
â”œâ”€â”€ logsç´¢å¼•
â”‚   â”œâ”€â”€ accessç±»å‹
â”‚   â”œâ”€â”€ errorç±»å‹
â”‚   â””â”€â”€ securityç±»å‹

ES 7.xåŠä»¥åï¼šåªæ”¯æŒ_docä¸€ç§ç±»å‹
â”œâ”€â”€ access-logsç´¢å¼• (_docç±»å‹)
â”œâ”€â”€ error-logsç´¢å¼• (_docç±»å‹)
â””â”€â”€ security-logsç´¢å¼• (_docç±»å‹)
```

**ğŸ’¡ ç°ä»£æœ€ä½³å®è·µ**
```yaml
# ç°åœ¨æ¨èï¼šä¸åŒç±»å‹æ•°æ®ä½¿ç”¨ä¸åŒç´¢å¼•
output.elasticsearch:
  hosts: ["localhost:9200"]
  indices:
    - index: "access-logs-%{+yyyy.MM.dd}"
      when.contains:
        log.file.path: "/var/log/nginx/access.log"
    - index: "error-logs-%{+yyyy.MM.dd}" 
      when.contains:
        log.file.path: "/var/log/nginx/error.log"
```

---

## 5. ğŸ”§ JSONå­—æ®µå¤„ç†é…ç½®


### 5.1 json.keys_under_rootçš„ä½œç”¨


**é—®é¢˜èƒŒæ™¯**ï¼šå¾ˆå¤šåº”ç”¨è¾“å‡ºJSONæ ¼å¼çš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¸Œæœ›ç›´æ¥ä½¿ç”¨JSONä¸­çš„å­—æ®µï¼Œè€Œä¸æ˜¯æŠŠæ•´ä¸ªJSONå½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²

**ğŸ”¸ ä¸ä½¿ç”¨keys_under_rootçš„æƒ…å†µ**
```yaml
# åŸå§‹JSONæ—¥å¿—
{"timestamp": "2024-01-01T10:30:00", "level": "ERROR", "message": "Database failed"}

# Filebeaté»˜è®¤å¤„ç†ç»“æœ
{
  "message": "{\"timestamp\": \"2024-01-01T10:30:00\", \"level\": \"ERROR\", \"message\": \"Database failed\"}",
  "@timestamp": "2024-01-01T10:30:01"
}
```

**ğŸ”¸ ä½¿ç”¨keys_under_rootçš„æƒ…å†µ**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  json.keys_under_root: true
  json.add_error_key: true

# å¤„ç†ç»“æœ
{
  "timestamp": "2024-01-01T10:30:00",
  "level": "ERROR", 
  "message": "Database failed",
  "@timestamp": "2024-01-01T10:30:01"
}
```

### 5.2 JSONå¤„ç†ç›¸å…³é…ç½®è¯¦è§£


**ğŸ”§ å®Œæ•´çš„JSONå¤„ç†é…ç½®**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  # JSONè§£æç›¸å…³é…ç½®
  json.keys_under_root: true        # JSONå­—æ®µæå‡åˆ°æ ¹çº§åˆ«
  json.add_error_key: true          # è§£æé”™è¯¯æ—¶æ·»åŠ errorå­—æ®µ
  json.message_key: "msg"           # æŒ‡å®šå“ªä¸ªå­—æ®µä½œä¸ºä¸»æ¶ˆæ¯
  json.ignore_decoding_error: false # é‡åˆ°éJSONè¡Œæ—¶æ˜¯å¦å¿½ç•¥é”™è¯¯
```

**ğŸ“Š é…ç½®é€‰é¡¹å¯¹æ¯”è¡¨**

| é…ç½®é¡¹ | ä½œç”¨ | æ¨èå€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `keys_under_root` | JSONå­—æ®µæ˜¯å¦æå‡åˆ°æ ¹çº§åˆ« | `true` | ä¾¿äºåç»­æŸ¥è¯¢å’Œåˆ†æ |
| `add_error_key` | è§£æå¤±è´¥æ—¶æ˜¯å¦æ·»åŠ é”™è¯¯ä¿¡æ¯ | `true` | ä¾¿äºæ’æŸ¥è§£æé—®é¢˜ |
| `message_key` | æŒ‡å®šä¸»æ¶ˆæ¯å­—æ®µ | æ ¹æ®æ—¥å¿—æ ¼å¼ | é¿å…å­—æ®µåå†²çª |
| `ignore_decoding_error` | æ˜¯å¦å¿½ç•¥éJSONè¡Œ | `false` | ä¸¥æ ¼æ¨¡å¼ï¼Œå‘ç°é—®é¢˜ |

### 5.3 æ··åˆæ ¼å¼æ—¥å¿—å¤„ç†


**å®é™…åœºæ™¯**ï¼šæ—¥å¿—æ–‡ä»¶ä¸­æ—¢æœ‰JSONæ ¼å¼ï¼Œä¹Ÿæœ‰çº¯æ–‡æœ¬æ ¼å¼

```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  json.keys_under_root: true
  json.ignore_decoding_error: true  # å¿½ç•¥éJSONè¡Œçš„è§£æé”™è¯¯
  
# å¤„ç†ç»“æœç¤ºä¾‹ï¼š
# JSONè¡Œï¼šæ­£å¸¸è§£æä¸ºç»“æ„åŒ–æ•°æ®
# æ–‡æœ¬è¡Œï¼šä¿æŒåœ¨messageå­—æ®µä¸­
```

---

## 6. â• è‡ªå®šä¹‰å­—æ®µæ·»åŠ 


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰å­—æ®µ


**å®é™…éœ€æ±‚**ï¼šåŸå§‹æ—¥å¿—é€šå¸¸ç¼ºå°‘ä¸€äº›é‡è¦ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š
- æœåŠ¡å™¨ç¯å¢ƒï¼ˆç”Ÿäº§/æµ‹è¯•ï¼‰
- åº”ç”¨ç‰ˆæœ¬
- æ•°æ®ä¸­å¿ƒä½ç½®
- ä¸šåŠ¡æ¨¡å—æ ‡è¯†

```
åŸå§‹æ—¥å¿—ï¼š[ERROR] Database connection failed
å¢å¼ºåï¼š  [ERROR] Database connection failed
         + environment: "production"
         + datacenter: "us-east-1" 
         + application: "user-service"
         + version: "v2.1.0"
```

### 6.2 æ·»åŠ é™æ€å­—æ®µ


**ğŸ”¸ åœ¨inputçº§åˆ«æ·»åŠ å­—æ®µ**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/access.log
  fields:
    log_type: "nginx_access"
    environment: "production"
    datacenter: "us-east-1"
  fields_under_root: false  # å­—æ®µæ·»åŠ åˆ°fieldså­å¯¹è±¡ä¸‹
```

**ğŸ”¸ åœ¨å…¨å±€çº§åˆ«æ·»åŠ å­—æ®µ**
```yaml
# å¯¹æ‰€æœ‰inputéƒ½ç”Ÿæ•ˆçš„å…¨å±€å­—æ®µ
fields:
  environment: "production"
  team: "backend"
  region: "asia"
fields_under_root: true  # å­—æ®µç›´æ¥æ·»åŠ åˆ°æ ¹çº§åˆ«
```

### 6.3 ä½¿ç”¨processorsæ·»åŠ åŠ¨æ€å­—æ®µ


**ğŸ”§ add_fieldså¤„ç†å™¨**
```yaml
processors:
- add_fields:
    target: "server"
    fields:
      hostname: "${HOSTNAME}"           # ä½¿ç”¨ç¯å¢ƒå˜é‡
      ip: "${SERVER_IP:127.0.0.1}"     # å¸¦é»˜è®¤å€¼çš„ç¯å¢ƒå˜é‡
      zone: "zone-a"

- add_fields:
    target: "application"
    fields:
      name: "web-service"
      version: "1.2.3"
    when.contains:
      log.file.path: "/var/log/web/"    # æ¡ä»¶æ·»åŠ 
```

### 6.4 å­—æ®µæ·»åŠ å®æˆ˜æ¡ˆä¾‹


**åœºæ™¯ï¼šå¤šç¯å¢ƒæ—¥å¿—ç®¡ç†**
```yaml
filebeat.inputs:
# ç”Ÿäº§ç¯å¢ƒé…ç½®
- type: log
  paths:
    - /var/log/prod/*.log
  fields:
    environment: "production"
    alert_level: "high"
    retention_days: 90

# æµ‹è¯•ç¯å¢ƒé…ç½®  
- type: log
  paths:
    - /var/log/test/*.log
  fields:
    environment: "test"
    alert_level: "low" 
    retention_days: 7

processors:
- add_fields:
    target: "meta"
    fields:
      collected_at: "${HOSTNAME}"
      filebeat_version: "8.5.0"
```

---

## 7. ğŸ·ï¸ æ ‡ç­¾ç®¡ç†ç­–ç•¥


### 7.1 æ ‡ç­¾ç³»ç»Ÿçš„æ¦‚å¿µ


**æ ‡ç­¾çš„ä½œç”¨**ï¼šå°±åƒç»™æ–‡ä»¶è´´æ ‡ç­¾ä¸€æ ·ï¼Œæ–¹ä¾¿åˆ†ç±»ã€æœç´¢å’Œç®¡ç†

```
æ ‡ç­¾åˆ†ç±»ç¤ºä¾‹ï¼š
â”œâ”€â”€ ç¯å¢ƒæ ‡ç­¾ï¼šprod, test, dev
â”œâ”€â”€ æœåŠ¡æ ‡ç­¾ï¼šweb, api, database  
â”œâ”€â”€ é‡è¦æ€§æ ‡ç­¾ï¼šcritical, normal, debug
â””â”€â”€ ä¸šåŠ¡æ ‡ç­¾ï¼šuser-service, order-service
```

### 7.2 æ·»åŠ æ ‡ç­¾çš„æ–¹æ³•


**ğŸ”¸ åœ¨inputé…ç½®ä¸­æ·»åŠ æ ‡ç­¾**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/error.log
  tags: ["nginx", "error", "web-server"]

- type: log  
  paths:
    - /var/log/app/application.log
  tags: ["application", "java", "backend"]
```

**ğŸ”¸ ä½¿ç”¨processorsåŠ¨æ€æ·»åŠ æ ‡ç­¾**
```yaml
processors:
- add_tags:
    tags: ["filebeat-processed"]
    when.contains:
      message: "ERROR"

- add_tags:
    tags: ["high-priority"]
    when.regexp:
      message: "(CRITICAL|FATAL|EMERGENCY)"
```

### 7.3 æ¡ä»¶æ ‡ç­¾æ·»åŠ 


**ğŸ”§ åŸºäºå†…å®¹æ·»åŠ æ ‡ç­¾**
```yaml
processors:
# æ ¹æ®æ—¥å¿—çº§åˆ«æ·»åŠ æ ‡ç­¾
- add_tags:
    tags: ["error-log"]
    when.contains:
      message: "ERROR"

- add_tags:
    tags: ["warning-log"] 
    when.contains:
      message: "WARN"

# æ ¹æ®æ–‡ä»¶è·¯å¾„æ·»åŠ æ ‡ç­¾
- add_tags:
    tags: ["nginx-access"]
    when.contains:
      log.file.path: "/nginx/access"

- add_tags:
    tags: ["application-log"]
    when.contains:
      log.file.path: "/app/"
```

### 7.4 æ ‡ç­¾ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“‹ æ ‡ç­¾å‘½åè§„èŒƒ**
```yaml
# æ¨èçš„æ ‡ç­¾å‘½åæ–¹å¼
tags: 
  - "env:production"      # ç¯å¢ƒç±»æ ‡ç­¾
  - "service:web"         # æœåŠ¡ç±»æ ‡ç­¾  
  - "level:error"         # çº§åˆ«ç±»æ ‡ç­¾
  - "module:auth"         # æ¨¡å—ç±»æ ‡ç­¾

# é¿å…çš„æ ‡ç­¾å‘½å
tags:
  - "prod"               # å¤ªç®€å•ï¼Œå¯èƒ½é‡å¤
  - "web server logs"    # åŒ…å«ç©ºæ ¼
  - "CRITICAL_ERROR"     # å¤§å†™å­—æ¯
```

**âš¡ æ ‡ç­¾æ•°é‡æ§åˆ¶**
```yaml
# âœ… åˆç†çš„æ ‡ç­¾æ•°é‡ï¼ˆ5-10ä¸ªï¼‰
tags: ["web", "nginx", "access", "prod", "frontend"]

# âŒ è¿‡å¤šçš„æ ‡ç­¾ï¼ˆå½±å“æ€§èƒ½ï¼‰
tags: ["web", "nginx", "access", "prod", "frontend", "server1", 
       "version1.2", "team-a", "region-us", "datacenter-1", "rack-5"]
```

---

## 8. ğŸš€ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 8.1 Webåº”ç”¨å®Œæ•´é…ç½®æ¡ˆä¾‹


```yaml
# ===============================
# Webåº”ç”¨æ—¥å¿—æ”¶é›†å®Œæ•´é…ç½®
# ===============================
filebeat.inputs:

# Nginxè®¿é—®æ—¥å¿—é…ç½®
- type: log
  paths:
    - /var/log/nginx/access.log
  fields:
    log_type: "nginx_access"
    service: "web-frontend"
    importance: "normal"
  fields_under_root: false
  tags: ["nginx", "access", "web"]
  
# Nginxé”™è¯¯æ—¥å¿—é…ç½®  
- type: log
  paths:
    - /var/log/nginx/error.log
  fields:
    log_type: "nginx_error" 
    service: "web-frontend"
    importance: "high"
  fields_under_root: false
  tags: ["nginx", "error", "web"]

# åº”ç”¨ç¨‹åºæ—¥å¿—é…ç½®
- type: log
  paths:
    - /var/log/app/*.log
  json.keys_under_root: true
  json.add_error_key: true
  fields:
    log_type: "application"
    service: "user-service"
  tags: ["application", "backend", "java"]

# ===============================
# æ•°æ®å¤„ç†é…ç½®
# ===============================
processors:
# æ·»åŠ æœåŠ¡å™¨ä¿¡æ¯
- add_fields:
    target: "host"
    fields:
      hostname: "${HOSTNAME}"
      environment: "production"
      datacenter: "us-east-1"

# æ ¹æ®é”™è¯¯çº§åˆ«æ·»åŠ æ ‡ç­¾
- add_tags:
    tags: ["critical"]
    when.regexp:
      message: "(ERROR|FATAL|CRITICAL)"

- add_tags:
    tags: ["warning"]  
    when.contains:
      message: "WARN"

# ===============================  
# è¾“å‡ºé…ç½®
# ===============================
output.elasticsearch:
  hosts: ["es-node1:9200", "es-node2:9200"]
  
  # æ ¹æ®æ—¥å¿—ç±»å‹åˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒç´¢å¼•
  indices:
    - index: "nginx-access-%{+yyyy.MM.dd}"
      when.equals:
        fields.log_type: "nginx_access"
        
    - index: "nginx-error-%{+yyyy.MM.dd}"
      when.equals:
        fields.log_type: "nginx_error"
        
    - index: "application-%{+yyyy.MM.dd}"
      when.equals:
        fields.log_type: "application"
        
    - index: "other-logs-%{+yyyy.MM.dd}"  # é»˜è®¤ç´¢å¼•

  # Pipelineå¤„ç†é…ç½®
  pipelines:
    - pipeline: "nginx-access-pipeline"
      when.equals:
        fields.log_type: "nginx_access"
        
    - pipeline: "error-processing-pipeline"
      when.contains:
        tags: "critical"

# ===============================
# å…¨å±€å­—æ®µé…ç½®  
# ===============================
fields:
  project: "ecommerce-platform"
  team: "backend-team"
  version: "v2.1.0"
fields_under_root: true
```

### 8.2 å¤šç¯å¢ƒé…ç½®ç®¡ç†


**ğŸ¢ ç”Ÿäº§ç¯å¢ƒé…ç½®**
```yaml
# filebeat-prod.yml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  fields:
    environment: "production"
    alert_threshold: "error"
    retention_days: 90
  tags: ["prod", "critical-service"]

output.elasticsearch:
  hosts: ["prod-es1:9200", "prod-es2:9200"]
  index: "prod-logs-%{+yyyy.MM.dd}"
  pipeline: "prod-processing-pipeline"
```

**ğŸ§ª æµ‹è¯•ç¯å¢ƒé…ç½®**
```yaml
# filebeat-test.yml  
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  fields:
    environment: "test"
    alert_threshold: "warning"
    retention_days: 7
  tags: ["test", "non-critical"]

output.elasticsearch:
  hosts: ["test-es1:9200"]
  index: "test-logs-%{+yyyy.MM.dd}"
  pipeline: "test-simple-pipeline"
```

### 8.3 æ€§èƒ½ä¼˜åŒ–é…ç½®


```yaml
# ===============================
# é«˜æ€§èƒ½é…ç½®ç¤ºä¾‹
# ===============================
filebeat.inputs:
- type: log
  paths:
    - /var/log/high-volume/*.log
  scan_frequency: 1s          # æé«˜æ‰«æé¢‘ç‡
  harvester_buffer_size: 32768 # å¢å¤§ç¼“å†²åŒº
  max_bytes: 1048576          # é™åˆ¶å•è¡Œæœ€å¤§å­—èŠ‚æ•°

output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  worker: 4                    # å¢åŠ å¹¶å‘worker
  bulk_max_size: 2000         # å¢å¤§æ‰¹é‡å‘é€å¤§å°
  timeout: 90s                # è®¾ç½®åˆç†è¶…æ—¶æ—¶é—´
  
  # è´Ÿè½½å‡è¡¡é…ç½®
  loadbalance: true
  compression_level: 3         # å¯ç”¨å‹ç¼©èŠ‚çœå¸¦å®½

# æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼Œé¿å…è¿‡å¤šdebugä¿¡æ¯
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 3
  rotateeverybytes: 10485760  # 10MBè½®è½¬
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¾“å‡ºæ§åˆ¶ï¼šå†³å®šæ•°æ®å‘é€åˆ°å“ªé‡Œã€å¦‚ä½•å¤„ç†
ğŸ”¸ Pipelineç®¡é“ï¼šæ•°æ®åŠ å·¥å¤„ç†çš„æµæ°´çº¿
ğŸ”¸ Indexç´¢å¼•ï¼šæ•°æ®å­˜å‚¨çš„åˆ†ç±»å’Œç»„ç»‡æ–¹å¼
ğŸ”¸ Document_typeï¼šæ–‡æ¡£ç±»å‹ï¼ˆç°ä»£ESç»Ÿä¸€ä½¿ç”¨_docï¼‰
ğŸ”¸ JSONå¤„ç†ï¼šç»“æ„åŒ–æ—¥å¿—çš„è§£æå’Œå­—æ®µæå–
ğŸ”¸ è‡ªå®šä¹‰å­—æ®µï¼šä¸ºæ—¥å¿—æ·»åŠ é¢å¤–çš„å…ƒæ•°æ®ä¿¡æ¯  
ğŸ”¸ æ ‡ç­¾ç®¡ç†ï¼šæ—¥å¿—çš„åˆ†ç±»å’Œæ ‡è®°ç³»ç»Ÿ
```

### 9.2 å…³é”®é…ç½®ç†è§£è¦ç‚¹


**ğŸ”¹ Pipelineçš„é€‰æ‹©ç­–ç•¥**
```
ç®€å•æ—¥å¿— â†’ ä¸ä½¿ç”¨Pipelineæˆ–ä½¿ç”¨ç®€å•Pipeline
å¤æ‚æ—¥å¿— â†’ ä½¿ç”¨ä¸“é—¨çš„Pipelineè¿›è¡Œè§£æå¤„ç†
é«˜é¢‘æ—¥å¿— â†’ ä¼˜åŒ–Pipelineæ€§èƒ½ï¼Œé¿å…å¤æ‚å¤„ç†
é”™è¯¯æ—¥å¿— â†’ ä½¿ç”¨å‘Šè­¦Pipelineï¼ŒåŠæ—¶é€šçŸ¥
```

**ğŸ”¹ ç´¢å¼•å‘½åçš„æœ€ä½³å®è·µ**
```
å‘½åè§„èŒƒï¼šé¡¹ç›®-ç»„ä»¶-ç±»å‹-æ—¥æœŸ
æ—¶é—´ç²’åº¦ï¼šé€šå¸¸æŒ‰å¤©åˆ†å‰²ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†
ç¯å¢ƒåŒºåˆ†ï¼šç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨ä¸åŒå‰ç¼€
å¤§å°æ§åˆ¶ï¼šé¿å…å•ä¸ªç´¢å¼•è¿‡å¤§å½±å“æ€§èƒ½
```

**ğŸ”¹ å­—æ®µå’Œæ ‡ç­¾çš„ä½¿ç”¨åŸåˆ™**
```
å­—æ®µæ·»åŠ ï¼šæ·»åŠ æœ‰ä¸šåŠ¡ä»·å€¼çš„å…ƒæ•°æ®
æ ‡ç­¾ä½¿ç”¨ï¼šä¾¿äºåˆ†ç±»æŸ¥è¯¢ï¼Œä½†ä¸è¦è¿‡å¤š
å‘½åè§„èŒƒï¼šä½¿ç”¨ç»Ÿä¸€çš„å‘½åçº¦å®š
æ€§èƒ½è€ƒè™‘ï¼šè¿‡å¤šå­—æ®µå’Œæ ‡ç­¾ä¼šå½±å“æ€§èƒ½
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ é…ç½®é€‰æ‹©å»ºè®®**
- **å°è§„æ¨¡åº”ç”¨**ï¼šä½¿ç”¨ç®€å•çš„ç´¢å¼•é…ç½®ï¼Œå°‘é‡å­—æ®µå’Œæ ‡ç­¾
- **ä¸­ç­‰è§„æ¨¡**ï¼šæŒ‰æ—¥å¿—ç±»å‹åˆ†ç´¢å¼•ï¼Œä½¿ç”¨Pipelineå¤„ç†
- **å¤§è§„æ¨¡ç³»ç»Ÿ**ï¼šç²¾ç»†åŒ–é…ç½®ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼Œåˆ†ç¯å¢ƒç®¡ç†

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**
- ç´¢å¼•åç§°åŒ…å«å¤§å†™å­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦
- Pipelineå¤„ç†è¿‡äºå¤æ‚å¯¼è‡´æ€§èƒ½é—®é¢˜
- å­—æ®µå’Œæ ‡ç­¾è¿‡å¤šå½±å“å­˜å‚¨å’ŒæŸ¥è¯¢æ•ˆç‡
- å¿˜è®°é…ç½®é”™è¯¯å¤„ç†å¯¼è‡´æ•°æ®ä¸¢å¤±

**ğŸ”§ è¿ç»´å»ºè®®**
- å®šæœŸæ£€æŸ¥ç´¢å¼•å¤§å°å’Œæ€§èƒ½
- ç›‘æ§Filebeatçš„å¤„ç†é€Ÿåº¦å’Œé”™è¯¯ç‡
- å»ºç«‹é…ç½®æ–‡ä»¶çš„ç‰ˆæœ¬ç®¡ç†
- å‡†å¤‡ä¸åŒç¯å¢ƒçš„é…ç½®æ¨¡æ¿

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è¾“å‡ºæ§åˆ¶æ˜¯Filebeatçš„"å¤§è„‘"ï¼Œå†³å®šæ•°æ®çš„å»å‘å’Œå¤„ç†æ–¹å¼
- Pipelineåƒæµæ°´çº¿ï¼Œå¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–åŠ å·¥
- ç´¢å¼•å‘½åè¦è§„èŒƒï¼Œä¾¿äºç®¡ç†å’ŒæŸ¥è¯¢
- é€‚é‡æ·»åŠ å­—æ®µå’Œæ ‡ç­¾ï¼Œæå‡æ•°æ®ä»·å€¼ä½†ä¸å½±å“æ€§èƒ½
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–