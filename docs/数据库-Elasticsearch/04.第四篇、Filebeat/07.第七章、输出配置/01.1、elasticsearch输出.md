---
title: 1、elasticsearch输出
---
## 📚 目录

1. [Elasticsearch输出基础概念](#1-elasticsearch输出基础概念)
2. [基本连接配置](#2-基本连接配置)
3. [索引配置策略](#3-索引配置策略)
4. [认证与安全配置](#4-认证与安全配置)
5. [性能优化配置](#5-性能优化配置)
6. [高级配置选项](#6-高级配置选项)
7. [实战配置示例](#7-实战配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 Elasticsearch输出基础概念


### 1.1 什么是Elasticsearch输出


> 📖 **核心概念**  
> Elasticsearch输出是Filebeat将收集到的日志数据发送到Elasticsearch集群的配置模块，相当于数据的"出口"

**🔍 生活类比**：
```
Filebeat像一个邮递员：
收集邮件(日志) → 分拣处理 → 投递到目标邮箱(Elasticsearch)

Elasticsearch输出配置就是：
- 📍 邮箱地址：ES集群地址
- 🔑 钥匙：认证信息  
- 📦 投递方式：批量大小、频率等
- 📋 分类规则：索引名称、模板等
```

### 1.2 为什么需要输出配置


**🎯 核心作用**：
- **数据路由**：决定数据发送到哪个ES集群
- **格式控制**：控制数据在ES中的存储格式
- **性能优化**：调整发送效率和资源使用
- **安全保障**：配置认证和加密传输

### 1.3 输出配置在整体架构中的位置


```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  数据源     │ → │  Filebeat   │ → │ Elasticsearch│
│ (日志文件)   │    │ ┌─────────┐ │    │   集群      │
│             │    │ │  输入   │ │    │             │
│             │    │ │  处理   │ │    │             │
│             │    │ │ [输出]  │ │    │             │
│             │    │ └─────────┘ │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
                        ↑
                   输出配置在这里！
```

---

## 2. 🔌 基本连接配置


### 2.1 hosts集群地址配置


**📋 基本语法**：
```yaml
output.elasticsearch:
  hosts: ["ES节点地址:端口"]
```

**🔧 单节点配置示例**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
```

**🏢 多节点集群配置**：
```yaml
output.elasticsearch:
  hosts: 
    - "es-node1.company.com:9200"
    - "es-node2.company.com:9200" 
    - "es-node3.company.com:9200"
```

> 💡 **实用技巧**  
> 配置多个节点地址可以实现高可用，当某个节点故障时自动切换到其他节点

### 2.2 协议和端口设置


**🌐 HTTP vs HTTPS**：
```yaml
# HTTP协议(默认)
output.elasticsearch:
  hosts: ["http://es-node:9200"]

# HTTPS协议(生产推荐)  
output.elasticsearch:
  hosts: ["https://es-node:9200"]
  ssl.verification_mode: none  # 测试环境可用
```

**📊 常用端口对照**：

| 环境类型 | **协议** | **默认端口** | **使用场景** |
|---------|---------|-------------|-------------|
| 🟢 **开发环境** | `HTTP` | `9200` | `本地测试` |
| 🟡 **测试环境** | `HTTP/HTTPS` | `9200/9443` | `功能验证` |
| 🔴 **生产环境** | `HTTPS` | `9443` | `安全要求高` |

---

## 3. 📋 索引配置策略


### 3.1 index索引名称规则


**🎯 索引名称的重要性**：
- 决定数据在ES中的存储位置
- 影响数据查询和管理效率
- 便于按时间、类型等维度组织数据

**📝 基本索引配置**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "filebeat-logs-%{+yyyy.MM.dd}"
```

**🗓️ 时间格式索引示例**：
```yaml
# 按天分割
index: "app-logs-%{+yyyy.MM.dd}"
# 结果：app-logs-2025.09.21

# 按月分割  
index: "system-logs-%{+yyyy.MM}"
# 结果：system-logs-2025.09

# 按小时分割
index: "nginx-logs-%{+yyyy.MM.dd.HH}"  
# 结果：nginx-logs-2025.09.21.14
```

### 3.2 动态索引名称配置


**🔄 基于字段的动态索引**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  indices:
    - index: "nginx-access-%{+yyyy.MM.dd}"
      when.contains:
        log.file.path: "access.log"
    - index: "nginx-error-%{+yyyy.MM.dd}"  
      when.contains:
        log.file.path: "error.log"
    - index: "app-logs-%{+yyyy.MM.dd}"
      when.contains:
        service.name: "myapp"
```

> 🧠 **记忆技巧**：动态索引就像"智能分拣"，根据数据特征自动选择合适的"存储柜"

### 3.3 索引命名最佳实践


**✅ 推荐命名规范**：
```yaml
# 格式：项目名-日志类型-时间
index: "ecommerce-order-%{+yyyy.MM.dd}"
index: "payment-system-error-%{+yyyy.MM}"
index: "user-behavior-%{+yyyy.MM.dd}"
```

**❌ 避免的命名方式**：
```yaml
# 太笼统
index: "logs"

# 特殊字符
index: "logs@#$%"

# 过长名称
index: "very-very-long-project-name-with-many-details"
```

---

## 4. 🔐 认证与安全配置


### 4.1 用户名密码认证


**👤 基本认证配置**：
```yaml
output.elasticsearch:
  hosts: ["https://es-cluster:9200"]
  username: "elastic"
  password: "your_password"
```

**🔒 安全密码配置**：
```yaml
# 方式1：环境变量
output.elasticsearch:
  hosts: ["https://es-cluster:9200"] 
  username: "${ES_USERNAME}"
  password: "${ES_PASSWORD}"

# 方式2：密钥库(推荐生产环境)
output.elasticsearch:
  hosts: ["https://es-cluster:9200"]
  username: "${ES_USERNAME}"
  password: "${ES_PASSWORD:keystore}"
```

> ⚠️ **安全提醒**  
> 生产环境绝不要在配置文件中明文写密码，使用环境变量或密钥库

### 4.2 API Key认证方式


**🔑 API Key配置**：
```yaml
output.elasticsearch:
  hosts: ["https://es-cluster:9200"]
  api_key: "VnVhQ2ZHY0JDZGJrUW0tZTVhT3g6dWkybHAyYXhUTm1zeWFrdzl0dk5udw=="
```

**🛠️ API Key生成方法**：
```bash
# 在ES中创建API Key
POST /_security/api_key
{
  "name": "filebeat-api-key",
  "expiration": "1d",
  "role_descriptors": {
    "filebeat_writer": {
      "cluster": ["monitor", "manage_index_templates"],
      "index": [
        {
          "names": ["filebeat-*"],
          "privileges": ["write", "create_index", "manage"]
        }
      ]
    }
  }
}
```

### 4.3 SSL/TLS安全传输


**🔐 SSL基础配置**：
```yaml
output.elasticsearch:
  hosts: ["https://es-cluster:9200"]
  username: "elastic"
  password: "password"
  ssl:
    verification_mode: "certificate"
    certificate_authorities: ["/path/to/ca.crt"]
    certificate: "/path/to/client.crt"
    key: "/path/to/client.key"
```

**📊 SSL验证模式对比**：

| 验证模式 | **安全级别** | **使用场景** | **配置复杂度** |
|---------|-------------|-------------|---------------|
| `none` | 🔴 **低** | `开发测试` | `简单` |
| `certificate` | 🟡 **中** | `内网环境` | `中等` |
| `full` | 🟢 **高** | `生产环境` | `复杂` |

---

## 5. ⚡ 性能优化配置


### 5.1 bulk_max_size批量大小


**📦 批量发送原理**：
```
传统方式：一条一条发送 → 慢
批量方式：打包发送 → 快

就像快递：
❌ 每件物品单独寄送
✅ 装满一车再发货
```

**🔧 批量大小配置**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  bulk_max_size: 1600    # 每批最多1600条记录
  flush_interval: 1s     # 最长等待1秒
```

**📊 批量大小选择指南**：

| 数据量 | **推荐批量大小** | **适用场景** | **内存使用** |
|--------|-----------------|-------------|-------------|
| 🟢 **小** | `50-200` | `测试环境` | `低` |
| 🟡 **中** | `500-1600` | `一般应用` | `中` |
| 🔴 **大** | `1600-5000` | `高吞吐量` | `高` |

### 5.2 worker工作线程数


**🔄 工作线程配置**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  worker: 2              # 2个工作线程
  bulk_max_size: 1600
```

**🧮 线程数量计算公式**：
```
推荐线程数 = CPU核心数 ÷ 2
但不超过ES集群节点数

示例：
4核CPU → 2个线程
8核CPU → 4个线程  
3节点ES集群 → 最多3个线程
```

### 5.3 timeout超时设置


**⏰ 超时配置详解**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  timeout: 90            # 请求超时90秒
  bulk_max_size: 1600
  worker: 2
```

**📋 超时设置指导**：
- **网络良好**：30-60秒
- **网络一般**：60-90秒  
- **网络较差**：90-120秒
- **大批量数据**：适当增加

---

## 6. 🛠️ 高级配置选项


### 6.1 模板设置管理


**📋 模板配置作用**：
- 自动设置索引的字段映射
- 定义数据类型和分析器
- 配置索引的分片和副本

**🔧 模板配置示例**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  template:
    enabled: true
    name: "filebeat-custom"
    pattern: "filebeat-*"
    settings:
      index:
        number_of_shards: 1
        number_of_replicas: 1
        refresh_interval: "5s"
```

### 6.2 ILM索引生命周期管理


**🔄 ILM生命周期阶段**：
```
Hot阶段 → Warm阶段 → Cold阶段 → Delete阶段
 新数据     旧数据     归档数据     删除数据
```

**📋 ILM配置示例**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  ilm:
    enabled: true
    rollover_alias: "filebeat-logs"
    pattern: "{now/d}-000001"
    policy: "filebeat-policy"
```

**🗓️ ILM策略示例**：
```json
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "7d"
          }
        }
      },
      "warm": {
        "min_age": "7d",
        "actions": {
          "allocate": {
            "number_of_replicas": 0
          }
        }
      },
      "delete": {
        "min_age": "30d"
      }
    }
  }
}
```

### 6.3 重试机制配置


**🔄 重试策略配置**：
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  max_retries: 3         # 最大重试3次
  backoff:
    init: 1s            # 初始等待1秒
    max: 60s            # 最大等待60秒
```

**📊 重试机制工作流程**：
```
发送失败 → 等待1秒 → 重试1
    ↓
重试1失败 → 等待2秒 → 重试2  
    ↓
重试2失败 → 等待4秒 → 重试3
    ↓
重试3失败 → 放弃数据
```

---

## 7. 🎯 实战配置示例


### 7.1 开发环境配置


```yaml
# 开发环境：简单快速
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "dev-logs-%{+yyyy.MM.dd}"
  bulk_max_size: 50
  worker: 1
  timeout: 30
```

### 7.2 测试环境配置


```yaml
# 测试环境：模拟生产
output.elasticsearch:
  hosts: 
    - "test-es1:9200"
    - "test-es2:9200"
  username: "filebeat_user"
  password: "${FB_PASSWORD}"
  index: "test-app-%{+yyyy.MM.dd}"
  bulk_max_size: 500
  worker: 2
  timeout: 60
  max_retries: 2
```

### 7.3 生产环境配置


```yaml
# 生产环境：高性能+高安全
output.elasticsearch:
  hosts:
    - "https://prod-es1:9443"
    - "https://prod-es2:9443" 
    - "https://prod-es3:9443"
  api_key: "${ES_API_KEY}"
  
  # 动态索引配置
  indices:
    - index: "app-access-%{+yyyy.MM.dd}"
      when.contains:
        log.level: "info"
    - index: "app-error-%{+yyyy.MM.dd}"
      when.regexp:
        log.level: "error|warn"
        
  # 性能优化
  bulk_max_size: 1600
  worker: 4
  timeout: 90
  flush_interval: 1s
  
  # 重试配置
  max_retries: 3
  backoff:
    init: 1s
    max: 60s
    
  # SSL安全
  ssl:
    verification_mode: "certificate"
    certificate_authorities: ["/etc/ssl/ca.crt"]
    
  # ILM管理
  ilm:
    enabled: true
    rollover_alias: "prod-logs"
    policy: "prod-ilm-policy"
```

### 7.4 多环境配置模板


> 📋 **配置检查清单**
> - [ ] 集群地址配置正确
> - [ ] 认证信息安全配置
> - [ ] 索引命名规范合理
> - [ ] 批量大小适合数据量
> - [ ] 超时时间设置合理
> - [ ] SSL安全传输启用（生产）
> - [ ] ILM策略配置（可选）

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🎯 Elasticsearch输出 = Filebeat的数据出口
🔌 hosts配置 = 告诉Filebeat往哪发送数据  
📋 index配置 = 决定数据在ES中的存储位置
🔐 认证配置 = 保证数据传输安全
⚡ 性能配置 = 优化数据传输效率
🛠️ 高级配置 = 提供更多灵活性和控制
```

### 8.2 关键配置优先级


**🔥 高优先级（必配）**：
- `hosts`：集群地址
- `index`：索引名称
- 认证信息（生产环境）

**⭐ 中优先级（推荐）**：
- `bulk_max_size`：批量大小
- `worker`：工作线程
- `timeout`：超时设置

**💫 低优先级（可选）**：
- `template`：模板设置
- `ilm`：生命周期管理
- 高级重试策略

### 8.3 实际应用指导


**🎯 配置选择策略**：
```
数据量小 → 小批量+单线程
数据量大 → 大批量+多线程  
网络不稳定 → 增加超时+重试
安全要求高 → 启用SSL+API Key
需要数据治理 → 配置ILM策略
```

**🔍 常见问题排查**：
```
连接失败 → 检查hosts和网络
认证失败 → 检查用户名密码
性能缓慢 → 调整批量大小和线程数
索引混乱 → 检查index命名规则
数据丢失 → 检查重试机制配置
```

**🧠 核心记忆口诀**：
- **连接配置**：地址端口要准确，多节点保高可用
- **索引配置**：命名规范按时间，动态分类更灵活  
- **认证配置**：安全第一不明文，API密钥是首选
- **性能配置**：批量线程要平衡，超时重试保稳定

### 8.4 生产部署建议


**✅ 最佳实践**：
1. **安全优先**：生产环境必须使用HTTPS和强认证
2. **性能测试**：批量大小需要根据实际数据量调优
3. **监控告警**：配置ES集群和Filebeat的监控
4. **备份策略**：重要数据配置ILM和备份策略
5. **文档记录**：配置变更要有文档记录

**⚠️ 常见陷阱**：
- 批量过大导致内存溢出
- 超时过短导致频繁重试
- 索引命名不规范影响查询
- 认证信息泄露安全风险
- 缺少重试机制数据丢失