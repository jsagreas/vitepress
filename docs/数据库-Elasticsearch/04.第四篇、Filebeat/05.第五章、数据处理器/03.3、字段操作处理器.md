---
title: 3ã€å­—æ®µæ“ä½œå¤„ç†å™¨
---
## ğŸ“š ç›®å½•

1. [å­—æ®µæ“ä½œå¤„ç†å™¨æ¦‚è¿°](#1-å­—æ®µæ“ä½œå¤„ç†å™¨æ¦‚è¿°)
2. [add_fieldså­—æ®µæ·»åŠ ](#2-add_fieldså­—æ®µæ·»åŠ )
3. [add_host_metadataä¸»æœºä¿¡æ¯](#3-add_host_metadataä¸»æœºä¿¡æ¯)
4. [add_docker_metadataå®¹å™¨ä¿¡æ¯](#4-add_docker_metadataå®¹å™¨ä¿¡æ¯)
5. [copy_fieldså­—æ®µå¤åˆ¶](#5-copy_fieldså­—æ®µå¤åˆ¶)
6. [renameå­—æ®µé‡å‘½å](#6-renameå­—æ®µé‡å‘½å)
7. [drop_fieldså­—æ®µåˆ é™¤](#7-drop_fieldså­—æ®µåˆ é™¤)
8. [drop_eventäº‹ä»¶åˆ é™¤](#8-drop_eventäº‹ä»¶åˆ é™¤)
9. [å®é™…åº”ç”¨åœºæ™¯](#9-å®é™…åº”ç”¨åœºæ™¯)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ å­—æ®µæ“ä½œå¤„ç†å™¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­—æ®µæ“ä½œå¤„ç†å™¨


**ç®€å•ç†è§£**ï¼šå­—æ®µæ“ä½œå¤„ç†å™¨å°±åƒæ˜¯æ•°æ®çš„"åŒ…è£…å·¥"å’Œ"æ•´ç†å‘˜"ã€‚

æƒ³è±¡ä¸€ä¸‹ä½ åœ¨æ•´ç†æ–‡ä»¶ï¼š
- æœ‰äº›æ–‡ä»¶éœ€è¦**è´´æ ‡ç­¾**ï¼ˆæ·»åŠ å­—æ®µï¼‰
- æœ‰äº›æ–‡ä»¶éœ€è¦**å¤å°ä¸€ä»½**ï¼ˆå¤åˆ¶å­—æ®µï¼‰
- æœ‰äº›æ–‡ä»¶éœ€è¦**æ¢ä¸ªåå­—**ï¼ˆé‡å‘½åå­—æ®µï¼‰
- æœ‰äº›æ–‡ä»¶è¦**æ‰”æ‰**ï¼ˆåˆ é™¤å­—æ®µæˆ–äº‹ä»¶ï¼‰

Filebeatçš„å­—æ®µå¤„ç†å™¨åšçš„å°±æ˜¯è¿™äº›å·¥ä½œï¼Œè®©æ—¥å¿—æ•°æ®å˜å¾—æ›´æœ‰åºã€æ›´æœ‰ç”¨ã€‚

### 1.2 å¤„ç†å™¨çš„å·¥ä½œæµç¨‹


```
åŸå§‹æ—¥å¿—æ•°æ® â†’ å­—æ®µå¤„ç†å™¨ â†’ å¤„ç†åçš„æ•°æ® â†’ å‘é€åˆ°ç›®æ ‡
     â†“              â†“              â†“
"2023-01-01    æ·»åŠ æ ‡ç­¾      "2023-01-01      Elasticsearch
 Error 500"    è¡¥å……ä¿¡æ¯       Error 500       æˆ–å…¶ä»–ç›®æ ‡
                              æœåŠ¡å™¨:web01
                              ç¯å¢ƒ:ç”Ÿäº§"
```

**ğŸ¯ å¤„ç†å™¨çš„æ ¸å¿ƒä½œç”¨**ï¼š
- **æ•°æ®å¢å¼º**ï¼šæ·»åŠ æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **æ•°æ®æ¸…æ´—**ï¼šåˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
- **æ•°æ®æ•´ç†**ï¼šé‡å‘½åå’Œå¤åˆ¶å­—æ®µ
- **æ•°æ®è¿‡æ»¤**ï¼šæ ¹æ®æ¡ä»¶åˆ é™¤æ•´ä¸ªäº‹ä»¶

### 1.3 å¤„ç†å™¨é…ç½®åŸºç¡€


æ‰€æœ‰çš„å­—æ®µå¤„ç†å™¨éƒ½åœ¨é…ç½®æ–‡ä»¶çš„ `processors` éƒ¨åˆ†é…ç½®ï¼š

```yaml
# filebeat.yml åŸºæœ¬ç»“æ„
filebeat.inputs:
  - type: log
    paths:
      - /var/log/*.log

processors:
  - add_fields:      # å¤„ç†å™¨1
      target: ""
      fields:
        environment: production
  
  - drop_fields:     # å¤„ç†å™¨2
      fields: ["agent", "ecs"]

output.elasticsearch:
  hosts: ["localhost:9200"]
```

**âš ï¸ é‡è¦æ¦‚å¿µ**ï¼š
- å¤„ç†å™¨æŒ‰**é¡ºåºæ‰§è¡Œ**ï¼Œå°±åƒå·¥å‚æµæ°´çº¿
- å‰ä¸€ä¸ªå¤„ç†å™¨çš„ç»“æœä¼šä¼ ç»™ä¸‹ä¸€ä¸ªå¤„ç†å™¨
- å¦‚æœæŸä¸ªå¤„ç†å™¨å‡ºé”™ï¼Œå¯èƒ½å½±å“åç»­å¤„ç†

---

## 2. â• add_fieldså­—æ®µæ·»åŠ 


### 2.1 add_fieldsåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼š`add_fields` å°±åƒç»™æ¯ä¸ªåŒ…è£¹è´´æ ‡ç­¾ï¼Œå‘Šè¯‰åˆ«äººè¿™ä¸ªåŒ…è£¹æ¥è‡ªå“ªé‡Œã€å±äºå“ªä¸ªç±»å‹ã€‚

```
å¤„ç†å‰çš„æ•°æ®ï¼š
{
  "message": "ç”¨æˆ·ç™»å½•å¤±è´¥",
  "timestamp": "2023-01-01T10:00:00Z"
}

å¤„ç†åçš„æ•°æ®ï¼š
{
  "message": "ç”¨æˆ·ç™»å½•å¤±è´¥",
  "timestamp": "2023-01-01T10:00:00Z",
  "environment": "production",    # æ–°æ·»åŠ 
  "service": "auth-service",      # æ–°æ·»åŠ 
  "datacenter": "beijing"         # æ–°æ·»åŠ 
}
```

### 2.2 add_fieldsåŸºæœ¬ç”¨æ³•


**ğŸ”§ åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š

```yaml
processors:
  - add_fields:
      target: ""          # ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ·»åŠ åˆ°æ ¹çº§åˆ«
      fields:
        environment: production
        service: web-server
        datacenter: beijing
```

**ğŸ“‹ é…ç½®å‚æ•°è¯´æ˜**ï¼š
- **`target`**ï¼šæŒ‡å®šæ·»åŠ å­—æ®µçš„ä½ç½®
  - `""` ç©ºå­—ç¬¦ä¸² = æ·»åŠ åˆ°æ ¹çº§åˆ«
  - `"custom"` = æ·»åŠ åˆ° custom å¯¹è±¡ä¸‹
- **`fields`**ï¼šè¦æ·»åŠ çš„å­—æ®µåŠå…¶å€¼

### 2.3 targetå‚æ•°è¯¦è§£


**ğŸ¯ ä¸åŒtargetçš„æ•ˆæœ**ï¼š

```yaml
# é…ç½®1ï¼šæ·»åŠ åˆ°æ ¹çº§åˆ«
processors:
  - add_fields:
      target: ""
      fields:
        env: prod

# ç»“æœ1ï¼š
{
  "message": "error log",
  "env": "prod"           # ç›´æ¥åœ¨æ ¹çº§åˆ«
}
```

```yaml
# é…ç½®2ï¼šæ·»åŠ åˆ°æŒ‡å®šå¯¹è±¡
processors:
  - add_fields:
      target: "labels"
      fields:
        env: prod
        team: backend

# ç»“æœ2ï¼š
{
  "message": "error log",
  "labels": {             # åˆ›å»ºlabelså¯¹è±¡
    "env": "prod",
    "team": "backend"
  }
}
```

### 2.4 åŠ¨æ€å­—æ®µå€¼


**ğŸ’¡ ä½¿ç”¨å˜é‡å’Œå‡½æ•°**ï¼š

```yaml
processors:
  - add_fields:
      target: "meta"
      fields:
        hostname: "${hostname}"      # ä½¿ç”¨ç³»ç»Ÿä¸»æœºå
        beat_name: "${beat.name}"    # ä½¿ç”¨Beatåç§°
        processed_at: "${timestamp}" # ä½¿ç”¨å½“å‰æ—¶é—´æˆ³
```

**ğŸ“ å¸¸ç”¨å˜é‡**ï¼š
- `${hostname}` - ç³»ç»Ÿä¸»æœºå
- `${beat.name}` - Filebeatå®ä¾‹åç§°
- `${beat.version}` - Filebeatç‰ˆæœ¬
- `${timestamp}` - å½“å‰æ—¶é—´æˆ³

### 2.5 æ¡ä»¶æ·»åŠ å­—æ®µ


```yaml
processors:
  - add_fields:
      target: ""
      fields:
        log_level: error
      when:
        contains:
          message: "ERROR"
```

**è§£é‡Š**ï¼šåªæœ‰å½“æ—¥å¿—æ¶ˆæ¯åŒ…å« "ERROR" æ—¶ï¼Œæ‰æ·»åŠ  `log_level: error` å­—æ®µã€‚

---

## 3. ğŸ–¥ï¸ add_host_metadataä¸»æœºä¿¡æ¯


### 3.1 add_host_metadataåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼š`add_host_metadata` å°±åƒç»™æ¯ä¸ªå¿«é€’åŒ…è£¹è´´ä¸Š"å‘è´§åœ°å€æ ‡ç­¾"ï¼Œè®°å½•è¿™ä¸ªæ—¥å¿—æ¥è‡ªå“ªå°æœåŠ¡å™¨ã€‚

è¿™ä¸ªå¤„ç†å™¨ä¼šè‡ªåŠ¨æ”¶é›†æœåŠ¡å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼š
- **ä¸»æœºå**ï¼šæœåŠ¡å™¨å«ä»€ä¹ˆåå­—
- **IPåœ°å€**ï¼šæœåŠ¡å™¨çš„ç½‘ç»œåœ°å€
- **æ“ä½œç³»ç»Ÿ**ï¼šWindowsã€Linuxè¿˜æ˜¯å…¶ä»–
- **ç¡¬ä»¶ä¿¡æ¯**ï¼šCPUã€å†…å­˜ç­‰åŸºæœ¬ä¿¡æ¯

### 3.2 åŸºæœ¬é…ç½®å’Œä½¿ç”¨


**ğŸ”§ æœ€ç®€å•çš„é…ç½®**ï¼š

```yaml
processors:
  - add_host_metadata: ~    # ä½¿ç”¨é»˜è®¤è®¾ç½®
```

**ğŸ“Š æ·»åŠ çš„ä¿¡æ¯ç¤ºä¾‹**ï¼š

```json
{
  "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
  "host": {
    "name": "web-server-01",
    "hostname": "web-server-01.company.com",
    "ip": ["192.168.1.100", "10.0.0.100"],
    "mac": ["00:1b:21:12:34:56"],
    "os": {
      "family": "linux",
      "name": "Ubuntu",
      "version": "20.04",
      "platform": "ubuntu"
    },
    "architecture": "x86_64"
  }
}
```

### 3.3 è¯¦ç»†é…ç½®é€‰é¡¹


**âš™ï¸ å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```yaml
processors:
  - add_host_metadata:
      cache_ttl: 5m                    # ç¼“å­˜æ—¶é—´
      geo:                             # åœ°ç†ä½ç½®ä¿¡æ¯
        name: "Beijing-DC1"
        continent_name: "Asia"
        country_iso_code: "CN"
        region_name: "Beijing"
      replace_fields: false            # æ˜¯å¦æ›¿æ¢å·²å­˜åœ¨çš„å­—æ®µ
      netinfo.enabled: true            # æ˜¯å¦åŒ…å«ç½‘ç»œä¿¡æ¯
```

**ğŸ“‹ å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | **ä½œç”¨** | **é»˜è®¤å€¼** | **è¯´æ˜** |
|------|----------|------------|----------|
| `cache_ttl` | `ç¼“å­˜æ—¶é—´` | `5m` | `ä¸»æœºä¿¡æ¯ç¼“å­˜å¤šé•¿æ—¶é—´` |
| `geo` | `åœ°ç†ä¿¡æ¯` | `æ— ` | `æ‰‹åŠ¨æŒ‡å®šæœåŠ¡å™¨åœ°ç†ä½ç½®` |
| `replace_fields` | `æ›¿æ¢å­—æ®µ` | `false` | `æ˜¯å¦è¦†ç›–å·²å­˜åœ¨çš„hostå­—æ®µ` |
| `netinfo.enabled` | `ç½‘ç»œä¿¡æ¯` | `true` | `æ˜¯å¦æ”¶é›†ç½‘ç»œæ¥å£ä¿¡æ¯` |

### 3.4 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ è¿ç»´ç›‘æ§åœºæ™¯**ï¼š
```yaml
# å¤šæœåŠ¡å™¨ç¯å¢ƒç›‘æ§
processors:
  - add_host_metadata:
      geo:
        name: "Production-Beijing"
        region_name: "Beijing"
      cache_ttl: 10m
```

**å¥½å¤„**ï¼š
- **é—®é¢˜å®šä½**ï¼šå¿«é€ŸçŸ¥é“å“ªå°æœåŠ¡å™¨å‡ºäº†é—®é¢˜
- **èµ„æºç›‘æ§**ï¼šæŒ‰æœåŠ¡å™¨åˆ†ç»„æŸ¥çœ‹æ—¥å¿—
- **åœ°ç†åˆ†æ**ï¼šäº†è§£ä¸åŒåœ°åŒºæœåŠ¡å™¨çš„çŠ¶å†µ

**ğŸ’¡ ä½¿ç”¨å»ºè®®**ï¼š
- åœ¨**å¤šæœåŠ¡å™¨ç¯å¢ƒ**ä¸­å¿…é¡»ä½¿ç”¨
- **å•æœºç¯å¢ƒ**å¯ä»¥è€ƒè™‘ä¸ç”¨ï¼ˆèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
- **å®¹å™¨ç¯å¢ƒ**å»ºè®®ç»“åˆ `add_docker_metadata` ä½¿ç”¨

---

## 4. ğŸ³ add_docker_metadataå®¹å™¨ä¿¡æ¯


### 4.1 add_docker_metadataåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼šå¦‚æœè¯´ `add_host_metadata` æ˜¯è®°å½•"å¤§æ¥¼åœ°å€"ï¼Œé‚£ä¹ˆ `add_docker_metadata` å°±æ˜¯è®°å½•"å…·ä½“æˆ¿é—´å·"ã€‚

åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­ï¼Œä¸€å°æœåŠ¡å™¨å¯èƒ½è¿è¡Œå¾ˆå¤šä¸ªå®¹å™¨ï¼š
```
ç‰©ç†æœåŠ¡å™¨ (web-server-01)
â”œâ”€â”€ å®¹å™¨1: nginx-frontend
â”œâ”€â”€ å®¹å™¨2: api-backend  
â”œâ”€â”€ å®¹å™¨3: redis-cache
â””â”€â”€ å®¹å™¨4: mysql-database
```

è¿™ä¸ªå¤„ç†å™¨å¸®æˆ‘ä»¬è¯†åˆ«æ—¥å¿—æ¥è‡ªå“ªä¸ªå…·ä½“çš„å®¹å™¨ã€‚

### 4.2 åŸºæœ¬é…ç½®


**ğŸ”§ å¯ç”¨å®¹å™¨ä¿¡æ¯æ”¶é›†**ï¼š

```yaml
processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"    # Docker socketè·¯å¾„
      match_fields: ["container.id"]         # åŒ¹é…å­—æ®µ
```

**ğŸ“Š æ·»åŠ çš„ä¿¡æ¯ç¤ºä¾‹**ï¼š

```json
{
  "message": "æ•°æ®åº“è¿æ¥æˆåŠŸ",
  "container": {
    "id": "a1b2c3d4e5f6",
    "name": "mysql-primary",
    "image": {
      "name": "mysql:8.0"
    },
    "labels": {
      "environment": "production",
      "service": "database"
    }
  },
  "docker": {
    "container": {
      "name": "mysql-primary",
      "labels": {
        "com.docker.compose.service": "mysql"
      }
    }
  }
}
```

### 4.3 é…ç½®å‚æ•°è¯¦è§£


**âš™ï¸ å®Œæ•´é…ç½®é€‰é¡¹**ï¼š

```yaml
processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      ssl:
        enabled: false
      match_fields: ["container.id", "container.name"]
      match_pids: ["process.pid", "process.ppid"]
      match_source: true
      match_source_index: 4
      match_short_id: true
      cleanup_timeout: 60s
      labels.dedot: false
      # åªåŒ…å«ç‰¹å®šæ ‡ç­¾
      labels.include:
        - "environment"
        - "service"
      # æ’é™¤ç‰¹å®šæ ‡ç­¾  
      labels.exclude:
        - "com.docker.compose.*"
```

**ğŸ“‹ é‡è¦å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | **ä½œç”¨** | **è¯´æ˜** |
|------|----------|----------|
| `match_fields` | `åŒ¹é…å­—æ®µ` | `ç”¨å“ªäº›å­—æ®µæ¥åŒ¹é…å®¹å™¨` |
| `match_pids` | `åŒ¹é…è¿›ç¨‹ID` | `é€šè¿‡è¿›ç¨‹IDåŒ¹é…å®¹å™¨` |
| `match_source` | `åŒ¹é…æ–‡ä»¶è·¯å¾„` | `é€šè¿‡æ—¥å¿—æ–‡ä»¶è·¯å¾„åŒ¹é…` |
| `labels.include` | `åŒ…å«æ ‡ç­¾` | `åªæ”¶é›†æŒ‡å®šçš„å®¹å™¨æ ‡ç­¾` |
| `labels.exclude` | `æ’é™¤æ ‡ç­¾` | `å¿½ç•¥æŸäº›å®¹å™¨æ ‡ç­¾` |

### 4.4 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ å¾®æœåŠ¡ç¯å¢ƒç›‘æ§**ï¼š

```yaml
# é’ˆå¯¹Docker Composeç¯å¢ƒçš„é…ç½®
processors:
  - add_docker_metadata:
      match_fields: ["container.name"]
      labels.include:
        - "com.docker.compose.service"
        - "environment"
        - "version"
      labels.exclude:
        - "com.docker.compose.config-hash"
        - "com.docker.compose.container-number"
```

**ğŸ’¼ Kubernetesç¯å¢ƒé…ç½®**ï¼š

```yaml
processors:
  - add_docker_metadata:
      match_fields: ["kubernetes.container.name"]
      labels.include:
        - "io.kubernetes.pod.name"
        - "io.kubernetes.pod.namespace"
        - "app"
```

**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹**ï¼š
- éœ€è¦ç¡®ä¿Filebeatæœ‰æƒé™è®¿é—®Docker socket
- åœ¨Kubernetesç¯å¢ƒä¸­ï¼Œé€šå¸¸ä½¿ç”¨ `add_kubernetes_metadata` æ›¿ä»£
- ä¼šå¢åŠ ä¸€å®šçš„ç³»ç»Ÿå¼€é”€ï¼Œå»ºè®®åˆç†é…ç½®ç¼“å­˜

---

## 5. ğŸ“„ copy_fieldså­—æ®µå¤åˆ¶


### 5.1 copy_fieldsåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼š`copy_fields` å°±åƒå¤å°æœºï¼ŒæŠŠæŸä¸ªå­—æ®µçš„å†…å®¹å¤åˆ¶ä¸€ä»½ï¼Œæ”¾åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦å¤åˆ¶å­—æ®µï¼Ÿ**
- **å¤‡ä»½é‡è¦ä¿¡æ¯**ï¼šé˜²æ­¢åç»­å¤„ç†accidentallyåˆ é™¤
- **åˆ›å»ºæ–°çš„åˆ†æç»´åº¦**ï¼šåŒä¸€ä¸ªä¿¡æ¯ç”¨ä¸åŒçš„åå­—æ–¹ä¾¿æŸ¥è¯¢
- **å…¼å®¹ä¸åŒç³»ç»Ÿ**ï¼šæœ‰äº›ç³»ç»Ÿè¦æ±‚ç‰¹å®šçš„å­—æ®µå

```
åŸå§‹æ•°æ®ï¼š
{
  "user_id": "12345",
  "timestamp": "2023-01-01T10:00:00Z"
}

å¤åˆ¶åï¼š
{
  "user_id": "12345",
  "customer_id": "12345",        # å¤åˆ¶çš„user_id
  "timestamp": "2023-01-01T10:00:00Z",
  "event_time": "2023-01-01T10:00:00Z"  # å¤åˆ¶çš„timestamp
}
```

### 5.2 åŸºæœ¬ç”¨æ³•


**ğŸ”§ ç®€å•å¤åˆ¶ç¤ºä¾‹**ï¼š

```yaml
processors:
  - copy_fields:
      fields:
        - from: "user_id"
          to: "customer_id"
        - from: "timestamp"  
          to: "event_time"
      fail_on_error: false    # å¤åˆ¶å¤±è´¥æ—¶ä¸åœæ­¢å¤„ç†
```

### 5.3 é«˜çº§å¤åˆ¶æ“ä½œ


**ğŸ“‚ å¤åˆ¶åˆ°åµŒå¥—å­—æ®µ**ï¼š

```yaml
processors:
  - copy_fields:
      fields:
        - from: "message"
          to: "original.content"     # å¤åˆ¶åˆ°originalå¯¹è±¡ä¸‹
        - from: "host.name"
          to: "metadata.hostname"    # ä»åµŒå¥—å­—æ®µå¤åˆ¶åˆ°å¦ä¸€ä¸ªåµŒå¥—å­—æ®µ
```

**ç»“æœç¤ºä¾‹**ï¼š
```json
{
  "message": "ç”¨æˆ·ç™»å½•",
  "host": {
    "name": "web-01"
  },
  "original": {
    "content": "ç”¨æˆ·ç™»å½•"        # å¤åˆ¶çš„message
  },
  "metadata": {
    "hostname": "web-01"        # å¤åˆ¶çš„host.name
  }
}
```

### 5.4 æ¡ä»¶å¤åˆ¶


**ğŸ¯ åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¤åˆ¶**ï¼š

```yaml
processors:
  - copy_fields:
      fields:
        - from: "message"
          to: "error_message"
      when:
        contains:
          message: "ERROR"
```

**è§£é‡Š**ï¼šåªæœ‰å½“æ¶ˆæ¯åŒ…å«"ERROR"æ—¶ï¼Œæ‰å°†messageå­—æ®µå¤åˆ¶åˆ°error_messageå­—æ®µã€‚

### 5.5 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ æ•°æ®æ ‡å‡†åŒ–åœºæ™¯**ï¼š
```yaml
# å°†ä¸åŒæ ¼å¼çš„æ—¶é—´å­—æ®µç»Ÿä¸€
processors:
  - copy_fields:
      fields:
        - from: "log_time"
          to: "@timestamp"
        - from: "user"
          to: "user.name"
      when:
        exists:
          log_time: true
```

**ğŸ” è°ƒè¯•å’Œå¤‡ä»½åœºæ™¯**ï¼š
```yaml
# åœ¨å¤„ç†å‰å¤‡ä»½é‡è¦å­—æ®µ
processors:
  - copy_fields:
      fields:
        - from: "message"
          to: "original_message"
  - # å…¶ä»–å¯èƒ½ä¿®æ”¹messageå­—æ®µçš„å¤„ç†å™¨
    dissect:
      tokenizer: "%{timestamp} %{level} %{content}"
      field: "message"
```

---

## 6. ğŸ·ï¸ renameå­—æ®µé‡å‘½å


### 6.1 renameåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼š`rename` å°±åƒç»™æ–‡ä»¶é‡æ–°å‘½åï¼ŒæŠŠ "æ—§åå­—.txt" æ”¹æˆ "æ–°åå­—.txt"ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦é‡å‘½åå­—æ®µï¼Ÿ**
- **æ ‡å‡†åŒ–å‘½å**ï¼šç»Ÿä¸€ä¸åŒæ¥æºçš„å­—æ®µå
- **ç®€åŒ–å­—æ®µå**ï¼šæŠŠå¤æ‚çš„åå­—æ”¹æˆç®€å•æ˜“æ‡‚çš„
- **ç¬¦åˆè§„èŒƒ**ï¼šè®©å­—æ®µåç¬¦åˆå…¬å¸æˆ–ç³»ç»Ÿçš„å‘½åè§„èŒƒ

```
é‡å‘½åå‰ï¼š
{
  "src_ip": "192.168.1.100",
  "dest_ip": "10.0.0.50",
  "msg": "è¿æ¥å»ºç«‹"
}

é‡å‘½ååï¼š
{
  "source_ip": "192.168.1.100",     # src_ip â†’ source_ip
  "destination_ip": "10.0.0.50",    # dest_ip â†’ destination_ip  
  "message": "è¿æ¥å»ºç«‹"               # msg â†’ message
}
```

### 6.2 åŸºæœ¬ç”¨æ³•


**ğŸ”§ ç®€å•é‡å‘½åç¤ºä¾‹**ï¼š

```yaml
processors:
  - rename:
      fields:
        - from: "src_ip"
          to: "source_ip"
        - from: "dest_ip"
          to: "destination_ip"
        - from: "msg"
          to: "message"
      ignore_missing: true    # å¿½ç•¥ä¸å­˜åœ¨çš„å­—æ®µ
      fail_on_error: false    # é‡å‘½åå¤±è´¥æ—¶ç»§ç»­å¤„ç†
```

### 6.3 åµŒå¥—å­—æ®µé‡å‘½å


**ğŸ“‚ å¤„ç†å¤æ‚ç»“æ„**ï¼š

```yaml
processors:
  - rename:
      fields:
        - from: "user.id"
          to: "user.user_id"
        - from: "server.hostname"  
          to: "host.name"
        - from: "app.version"
          to: "application.version"
```

**ç»“æœç¤ºä¾‹**ï¼š
```json
// é‡å‘½åå‰ï¼š
{
  "user": {"id": "12345"},
  "server": {"hostname": "web-01"},
  "app": {"version": "1.2.3"}
}

// é‡å‘½ååï¼š
{
  "user": {"user_id": "12345"},
  "host": {"name": "web-01"},
  "application": {"version": "1.2.3"}
}
```

### 6.4 æ‰¹é‡é‡å‘½åç­–ç•¥


**ğŸ¯ ç»Ÿä¸€å‘½åè§„èŒƒ**ï¼š

```yaml
processors:
  # æ­¥éª¤1ï¼šæ ‡å‡†åŒ–IPåœ°å€å­—æ®µ
  - rename:
      fields:
        - from: "src"
          to: "source_ip"
        - from: "dst"  
          to: "destination_ip"
        - from: "client_ip"
          to: "source_ip"
      when:
        or:
          - exists: {src: true}
          - exists: {dst: true}
          - exists: {client_ip: true}
  
  # æ­¥éª¤2ï¼šæ ‡å‡†åŒ–æ—¶é—´å­—æ®µ
  - rename:
      fields:
        - from: "log_time"
          to: "@timestamp"
        - from: "event_timestamp"
          to: "@timestamp"
      when:
        or:
          - exists: {log_time: true}
          - exists: {event_timestamp: true}
```

### 6.5 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“Š å¤šæ•°æ®æºæ•´åˆ**ï¼š
```yaml
# æ•´åˆnginxå’Œapacheæ—¥å¿—çš„å­—æ®µå
processors:
  - rename:
      fields:
        - from: "remote_addr"      # nginxå­—æ®µ
          to: "client_ip"
        - from: "request_uri"      # nginxå­—æ®µ
          to: "url"
      when:
        equals:
          fields.log_type: "nginx"
          
  - rename:
      fields:
        - from: "remote_host"      # apacheå­—æ®µ
          to: "client_ip"  
        - from: "request_url"      # apacheå­—æ®µ
          to: "url"
      when:
        equals:
          fields.log_type: "apache"
```

**ğŸ’¡ ä½¿ç”¨å»ºè®®**ï¼š
- **å…ˆå¤åˆ¶å†é‡å‘½å**ï¼šé‡è¦å­—æ®µå»ºè®®å…ˆç”¨ `copy_fields` å¤‡ä»½
- **æ‰¹é‡å¤„ç†**ï¼šç›¸å…³çš„é‡å‘½åæ”¾åœ¨ä¸€èµ·å¤„ç†
- **æ¡ä»¶æ§åˆ¶**ï¼šä½¿ç”¨ `when` æ¡ä»¶é¿å…ä¸å¿…è¦çš„æ“ä½œ

---

## 7. ğŸ—‘ï¸ drop_fieldså­—æ®µåˆ é™¤


### 7.1 drop_fieldsåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼š`drop_fields` å°±åƒæ¸…ç†å·¥ï¼ŒæŠŠä¸éœ€è¦çš„å­—æ®µä»æ•°æ®ä¸­åˆ é™¤ï¼Œè®©æ•°æ®æ›´æ¸…çˆ½ã€‚

**ä¸ºä»€ä¹ˆè¦åˆ é™¤å­—æ®µï¼Ÿ**
- **å‡å°‘å­˜å‚¨ç©ºé—´**ï¼šåˆ é™¤æ— ç”¨å­—æ®µèŠ‚çœç£ç›˜ç©ºé—´
- **æé«˜ä¼ è¾“æ•ˆç‡**ï¼šæ•°æ®åŒ…æ›´å°ï¼Œç½‘ç»œä¼ è¾“æ›´å¿«
- **ä¿æŠ¤éšç§ä¿¡æ¯**ï¼šåˆ é™¤æ•æ„Ÿå­—æ®µé˜²æ­¢æ³„éœ²
- **ç®€åŒ–æ•°æ®ç»“æ„**ï¼šåªä¿ç•™æœ‰ç”¨çš„ä¿¡æ¯

```
åˆ é™¤å‰çš„è‡ƒè‚¿æ•°æ®ï¼š
{
  "message": "ç”¨æˆ·ç™»å½•",
  "agent": {...},           # Filebeatè‡ªå¸¦ä¿¡æ¯ï¼Œé€šå¸¸ä¸éœ€è¦
  "ecs": {...},             # ECS schemaä¿¡æ¯ï¼Œå ç”¨ç©ºé—´
  "input": {...},           # è¾“å…¥ä¿¡æ¯ï¼Œè°ƒè¯•ç”¨
  "log": {...},             # æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
  "host": {...},            # ä¸»æœºä¿¡æ¯ï¼ˆå¦‚æœä¸éœ€è¦çš„è¯ï¼‰
  "user_password": "***"    # æ•æ„Ÿä¿¡æ¯ï¼Œå¿…é¡»åˆ é™¤
}

åˆ é™¤åçš„ç²¾ç®€æ•°æ®ï¼š
{
  "message": "ç”¨æˆ·ç™»å½•"      # åªä¿ç•™æ ¸å¿ƒä¿¡æ¯
}
```

### 7.2 åŸºæœ¬ç”¨æ³•


**ğŸ”§ åˆ é™¤æŒ‡å®šå­—æ®µ**ï¼š

```yaml
processors:
  - drop_fields:
      fields: ["agent", "ecs", "input", "log"]
```

**ğŸ¯ å¸¸è§åˆ é™¤ç»„åˆ**ï¼š

```yaml
processors:
  - drop_fields:
      fields: 
        - "agent"              # Filebeatä»£ç†ä¿¡æ¯
        - "ecs"                # ECSç‰ˆæœ¬ä¿¡æ¯  
        - "input"              # è¾“å…¥é…ç½®ä¿¡æ¯
        - "log.file"           # æ—¥å¿—æ–‡ä»¶è·¯å¾„ä¿¡æ¯
        - "host.mac"           # MACåœ°å€ï¼ˆéšç§ï¼‰
        - "host.ip"            # IPåœ°å€ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
      ignore_missing: true     # å¿½ç•¥ä¸å­˜åœ¨çš„å­—æ®µ
```

### 7.3 åµŒå¥—å­—æ®µåˆ é™¤


**ğŸ“‚ ç²¾ç¡®åˆ é™¤åµŒå¥—å­—æ®µ**ï¼š

```yaml
processors:
  - drop_fields:
      fields:
        - "host.mac"           # åªåˆ é™¤hostä¸‹çš„macå­—æ®µ
        - "host.ip"            # åªåˆ é™¤hostä¸‹çš„ipå­—æ®µ
        - "user.password"      # åˆ é™¤æ•æ„Ÿä¿¡æ¯
        - "log.file.path"      # åªåˆ é™¤æ–‡ä»¶è·¯å¾„ï¼Œä¿ç•™å…¶ä»–æ—¥å¿—ä¿¡æ¯
```

**ç»“æœå¯¹æ¯”**ï¼š
```json
// åˆ é™¤å‰ï¼š
{
  "host": {
    "name": "web-01",
    "ip": ["192.168.1.100"],
    "mac": ["00:1b:21:12:34:56"]
  },
  "user": {
    "name": "john",
    "password": "secret123"
  }
}

// åˆ é™¤åï¼š
{
  "host": {
    "name": "web-01"          # ä¿ç•™ä¸»æœºåï¼Œåˆ é™¤IPå’ŒMAC
  },
  "user": {
    "name": "john"            # ä¿ç•™ç”¨æˆ·åï¼Œåˆ é™¤å¯†ç 
  }
}
```

### 7.4 æ¡ä»¶åˆ é™¤


**ğŸ¯ åœ¨ç‰¹å®šæ¡ä»¶ä¸‹åˆ é™¤å­—æ®µ**ï¼š

```yaml
processors:
  - drop_fields:
      fields: ["debug_info", "trace_id"]
      when:
        not:
          equals:
            log.level: "DEBUG"   # éDEBUGæ—¥å¿—æ—¶åˆ é™¤è°ƒè¯•ä¿¡æ¯
```

**ğŸ”’ å®‰å…¨ç›¸å…³åˆ é™¤**ï¼š

```yaml
processors:
  - drop_fields:
      fields: ["password", "token", "secret", "key"]
      when:
        or:
          - contains: {message: "password"}
          - contains: {message: "token"}  
          - contains: {message: "secret"}
```

### 7.5 æ€§èƒ½ä¼˜åŒ–åˆ é™¤


**âš¡ å¸¸è§æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š

```yaml
processors:
  # åˆ é™¤Filebeatè‡ªå¸¦çš„å†—ä½™ä¿¡æ¯
  - drop_fields:
      fields: ["agent", "ecs", "input"]
      
  # åˆ é™¤è¯¦ç»†çš„ä¸»æœºä¿¡æ¯ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
  - drop_fields:
      fields: ["host.os", "host.architecture", "host.containerized"]
      
  # åˆ é™¤æ–‡ä»¶è¯¦ç»†ä¿¡æ¯ï¼ˆä¿ç•™åŸºæœ¬ä¿¡æ¯ï¼‰
  - drop_fields:
      fields: ["log.file.device_id", "log.file.inode", "log.file.mode"]
```

**ğŸ“Š ç©ºé—´èŠ‚çœæ•ˆæœ**ï¼š
```
åˆ é™¤å‰ï¼šæ¯æ¡æ—¥å¿— ~2KB
åˆ é™¤åï¼šæ¯æ¡æ—¥å¿— ~0.5KB
èŠ‚çœï¼šçº¦75%çš„å­˜å‚¨ç©ºé—´
```

### 7.6 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**ï¼š
```yaml
processors:
  # åŸºç¡€æ¸…ç†
  - drop_fields:
      fields: ["agent", "ecs", "input"]
      
  # æ ¹æ®æ—¥å¿—çº§åˆ«æ¸…ç†
  - drop_fields:
      fields: ["debug_details", "stack_trace"]
      when:
        not:
          or:
            - equals: {log.level: "ERROR"}
            - equals: {log.level: "WARN"}
            
  # å®‰å…¨æ¸…ç†
  - drop_fields:
      fields: ["password", "token", "authorization"]
```

---

## 8. âŒ drop_eventäº‹ä»¶åˆ é™¤


### 8.1 drop_eventåŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼šå¦‚æœè¯´ `drop_fields` æ˜¯åˆ é™¤å­—æ®µï¼Œé‚£ä¹ˆ `drop_event` å°±æ˜¯åˆ é™¤æ•´æ¡æ—¥å¿—è®°å½•ã€‚

æƒ³è±¡ä¸€ä¸‹åƒåœ¾åˆ†ç±»ï¼š
- `drop_fields` = æŠŠåŒ…è£…ç›’é‡Œçš„æŸäº›ä¸œè¥¿æ‹¿å‡ºæ¥æ‰”æ‰
- `drop_event` = æŠŠæ•´ä¸ªåŒ…è£…ç›’éƒ½æ‰”æ‰

**ä»€ä¹ˆæ—¶å€™éœ€è¦åˆ é™¤æ•´ä¸ªäº‹ä»¶ï¼Ÿ**
- **è¿‡æ»¤å™ªéŸ³æ—¥å¿—**ï¼šåˆ é™¤ä¸é‡è¦çš„DEBUGä¿¡æ¯
- **èŠ‚çœèµ„æº**ï¼šåˆ é™¤æ— ä»·å€¼çš„æ—¥å¿—å‡å°‘å­˜å‚¨å’Œä¼ è¾“
- **å®‰å…¨è¿‡æ»¤**ï¼šåˆ é™¤åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ•´æ¡æ—¥å¿—
- **ä¸šåŠ¡è¿‡æ»¤**ï¼šåˆ é™¤éå…³é”®ä¸šåŠ¡çš„æ—¥å¿—

### 8.2 åŸºæœ¬ç”¨æ³•


**ğŸ”§ ç®€å•è¿‡æ»¤ç¤ºä¾‹**ï¼š

```yaml
processors:
  # åˆ é™¤æ‰€æœ‰DEBUGçº§åˆ«çš„æ—¥å¿—
  - drop_event:
      when:
        equals:
          log.level: "DEBUG"
```

**ğŸ“Š è¿‡æ»¤æ•ˆæœ**ï¼š
```
å¤„ç†å‰ï¼ˆ10æ¡æ—¥å¿—ï¼‰ï¼š
1. INFO: ç”¨æˆ·ç™»å½•æˆåŠŸ
2. DEBUG: æŸ¥è¯¢æ•°æ®åº“è€—æ—¶50ms    â† åˆ é™¤
3. ERROR: è¿æ¥è¶…æ—¶
4. DEBUG: ç¼“å­˜å‘½ä¸­             â† åˆ é™¤  
5. WARN: å†…å­˜ä½¿ç”¨ç‡90%
6. DEBUG: å¤„ç†è¯·æ±‚å¼€å§‹          â† åˆ é™¤
7. INFO: è®¢å•åˆ›å»ºæˆåŠŸ
8. DEBUG: å‘é€é‚®ä»¶å®Œæˆ          â† åˆ é™¤
9. ERROR: æ”¯ä»˜å¤±è´¥
10. INFO: ç”¨æˆ·é€€å‡º

å¤„ç†åï¼ˆ6æ¡æ—¥å¿—ï¼‰ï¼š
1. INFO: ç”¨æˆ·ç™»å½•æˆåŠŸ
3. ERROR: è¿æ¥è¶…æ—¶
5. WARN: å†…å­˜ä½¿ç”¨ç‡90%
7. INFO: è®¢å•åˆ›å»ºæˆåŠŸ
9. ERROR: æ”¯ä»˜å¤±è´¥
10. INFO: ç”¨æˆ·é€€å‡º
```

### 8.3 å¤æ‚æ¡ä»¶è¿‡æ»¤


**ğŸ¯ å¤šæ¡ä»¶ç»„åˆ**ï¼š

```yaml
processors:
  - drop_event:
      when:
        or:
          - equals: {log.level: "DEBUG"}          # DEBUGçº§åˆ«
          - equals: {log.level: "TRACE"}          # TRACEçº§åˆ«
          - contains: {message: "health check"}   # å¥åº·æ£€æŸ¥æ—¥å¿—
          - contains: {message: "ping"}           # pingæ—¥å¿—
```

**ğŸ” åŸºäºå­—æ®µå­˜åœ¨æ€§è¿‡æ»¤**ï¼š

```yaml
processors:
  - drop_event:
      when:
        and:
          - not: {exists: {user.id}}              # æ²¡æœ‰ç”¨æˆ·ID
          - not: {exists: {session.id}}           # æ²¡æœ‰ä¼šè¯ID
          - equals: {event.type: "access"}        # ä¸”æ˜¯è®¿é—®æ—¥å¿—
```

**â±ï¸ åŸºäºæ—¶é—´è¿‡æ»¤**ï¼š

```yaml
processors:
  - drop_event:
      when:
        and:
          - equals: {log.level: "INFO"}
          - range:
              "@timestamp":
                gte: "2023-01-01T00:00:00Z"
                lt: "2023-01-01T06:00:00Z"    # åˆ é™¤å‡Œæ™¨0-6ç‚¹çš„INFOæ—¥å¿—
```

### 8.4 æ€§èƒ½ç›¸å…³è¿‡æ»¤


**âš¡ é«˜é¢‘æ— ä»·å€¼æ—¥å¿—è¿‡æ»¤**ï¼š

```yaml
processors:
  # è¿‡æ»¤è´Ÿè½½å‡è¡¡å™¨å¥åº·æ£€æŸ¥
  - drop_event:
      when:
        and:
          - contains: {message: "GET /health"}
          - contains: {user_agent.original: "ELB-HealthChecker"}
          
  # è¿‡æ»¤é™æ€èµ„æºè¯·æ±‚ï¼ˆæ ¹æ®éœ€è¦ï¼‰
  - drop_event:
      when:
        regexp:
          message: '\.(css|js|jpg|png|gif|ico|woff)(\?.*)?$'
          
  # è¿‡æ»¤çˆ¬è™«è®¿é—®
  - drop_event:
      when:
        or:
          - contains: {user_agent.original: "bot"}
          - contains: {user_agent.original: "crawler"}
          - contains: {user_agent.original: "spider"}
```

### 8.5 å®‰å…¨ç›¸å…³è¿‡æ»¤


**ğŸ”’ æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**ï¼š

```yaml
processors:
  # åˆ é™¤åŒ…å«å¯†ç çš„æ—¥å¿—
  - drop_event:
      when:
        or:
          - regexp: {message: '(?i)password\s*[=:]\s*\S+'}
          - regexp: {message: '(?i)token\s*[=:]\s*\S+'}
          - regexp: {message: '(?i)secret\s*[=:]\s*\S+'}
          
  # åˆ é™¤åŒ…å«ä¿¡ç”¨å¡å·çš„æ—¥å¿—  
  - drop_event:
      when:
        regexp:
          message: '\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b'
```

### 8.6 ä¸šåŠ¡é€»è¾‘è¿‡æ»¤


**ğŸ’¼ æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿‡æ»¤**ï¼š

```yaml
processors:
  # åªä¿ç•™é”™è¯¯å’Œè­¦å‘Šæ—¥å¿—
  - drop_event:
      when:
        not:
          or:
            - equals: {log.level: "ERROR"}
            - equals: {log.level: "WARN"}
            - equals: {log.level: "FATAL"}
            
  # åªä¿ç•™ç‰¹å®šæœåŠ¡çš„æ—¥å¿—
  - drop_event:
      when:
        not:
          or:
            - equals: {service.name: "user-service"}
            - equals: {service.name: "order-service"}
            - equals: {service.name: "payment-service"}
```

### 8.7 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“ˆ å¤§è§„æ¨¡æ—¥å¿—å¤„ç†**ï¼š
```yaml
processors:
  # ç¬¬ä¸€æ­¥ï¼šè¿‡æ»¤æ˜æ˜¾çš„å™ªéŸ³
  - drop_event:
      when:
        or:
          - equals: {log.level: "DEBUG"}
          - contains: {message: "health check"}
          - contains: {message: "ping"}
          
  # ç¬¬äºŒæ­¥ï¼šæ ¹æ®ä¸šåŠ¡ä»·å€¼è¿‡æ»¤
  - drop_event:
      when:
        and:
          - equals: {log.level: "INFO"}
          - not: {exists: {user.id}}        # æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯çš„INFOæ—¥å¿—
          
  # ç¬¬ä¸‰æ­¥ï¼šå®‰å…¨è¿‡æ»¤
  - drop_event:
      when:
        regexp:
          message: '(?i)(password|token|secret|key)\s*[=:]\s*\S+'
```

**ğŸ’° æˆæœ¬ä¼˜åŒ–æ•ˆæœ**ï¼š
```
åŸå§‹æ—¥å¿—é‡ï¼š1000ä¸‡æ¡/å¤©
è¿‡æ»¤åï¼š200ä¸‡æ¡/å¤©
èŠ‚çœï¼š80%çš„å­˜å‚¨å’Œä¼ è¾“æˆæœ¬
```

---

## 9. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 9.1 WebæœåŠ¡å™¨æ—¥å¿—å¤„ç†


**ğŸ“Š Nginxè®¿é—®æ—¥å¿—ä¼˜åŒ–**ï¼š

```yaml
filebeat.inputs:
  - type: log
    paths:
      - /var/log/nginx/access.log
    fields:
      log_type: nginx
      service: web

processors:
  # 1. æ·»åŠ ç¯å¢ƒä¿¡æ¯
  - add_fields:
      target: "labels"
      fields:
        environment: production
        datacenter: beijing
        
  # 2. æ·»åŠ ä¸»æœºä¿¡æ¯
  - add_host_metadata:
      cache_ttl: 5m
      
  # 3. è¿‡æ»¤å¥åº·æ£€æŸ¥æ—¥å¿—
  - drop_event:
      when:
        contains:
          message: "GET /health"
          
  # 4. åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
  - drop_fields:
      fields: ["agent", "ecs", "input"]
      
  # 5. é‡å‘½åå­—æ®µä»¥ç¬¦åˆæ ‡å‡†
  - rename:
      fields:
        - from: "host.hostname"
          to: "server.name"
```

### 9.2 åº”ç”¨ç¨‹åºæ—¥å¿—å¤„ç†


**ğŸ› Javaåº”ç”¨æ—¥å¿—æ ‡å‡†åŒ–**ï¼š

```yaml
filebeat.inputs:
  - type: log
    paths:
      - /app/logs/*.log
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after

processors:
  # 1. æ·»åŠ åº”ç”¨ä¿¡æ¯
  - add_fields:
      target: ""
      fields:
        application: user-service
        version: "1.2.3"
        
  # 2. å¤åˆ¶é‡è¦å­—æ®µï¼ˆå¤‡ä»½ï¼‰
  - copy_fields:
      fields:
        - from: "message"
          to: "original_message"
          
  # 3. æ ¹æ®æ—¥å¿—çº§åˆ«æ·»åŠ ä¼˜å…ˆçº§
  - add_fields:
      target: ""
      fields:
        priority: high
      when:
        or:
          - contains: {message: "ERROR"}
          - contains: {message: "FATAL"}
          
  # 4. åˆ é™¤DEBUGæ—¥å¿—
  - drop_event:
      when:
        contains:
          message: "DEBUG"
          
  # 5. åˆ é™¤æ•æ„Ÿä¿¡æ¯
  - drop_fields:
      fields: ["password", "token"]
```

### 9.3 å®¹å™¨åŒ–ç¯å¢ƒå¤„ç†


**ğŸ³ Dockeråº”ç”¨æ—¥å¿—å¤„ç†**ï¼š

```yaml
filebeat.inputs:
  - type: container
    paths:
      - /var/lib/docker/containers/*/*.log

processors:
  # 1. æ·»åŠ Dockerå…ƒæ•°æ®
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      match_fields: ["container.id"]
      labels.include:
        - "environment"
        - "service"
        - "version"
        
  # 2. æ·»åŠ ä¸»æœºä¿¡æ¯
  - add_host_metadata: ~
  
  # 3. é‡å‘½åå®¹å™¨å­—æ®µ
  - rename:
      fields:
        - from: "container.name"
          to: "service.name"
        - from: "container.image.name"
          to: "service.image"
          
  # 4. æ ¹æ®æœåŠ¡ç±»å‹æ·»åŠ æ ‡ç­¾
  - add_fields:
      target: "labels"
      fields:
        tier: frontend
      when:
        contains:
          container.image.name: "nginx"
          
  - add_fields:
      target: "labels"  
      fields:
        tier: backend
      when:
        contains:
          container.image.name: "java"
          
  # 5. è¿‡æ»¤ç³»ç»Ÿå®¹å™¨æ—¥å¿—
  - drop_event:
      when:
        or:
          - contains: {container.image.name: "pause"}
          - contains: {container.image.name: "fluentd"}
```

### 9.4 å®‰å…¨æ—¥å¿—å¤„ç†


**ğŸ” å®‰å…¨äº‹ä»¶æ—¥å¿—å¤„ç†**ï¼š

```yaml
filebeat.inputs:
  - type: log
    paths:
      - /var/log/auth.log
      - /var/log/secure
    fields:
      log_type: security

processors:
  # 1. æ·»åŠ å®‰å…¨æ ‡ç­¾
  - add_fields:
      target: "security"
      fields:
        category: authentication
        severity: medium
        
  # 2. ç™»å½•å¤±è´¥äº‹ä»¶æ ‡è®°
  - add_fields:
      target: "security"
      fields:
        event_type: login_failure
        severity: high
      when:
        or:
          - contains: {message: "Failed password"}
          - contains: {message: "authentication failure"}
          
  # 3. æˆåŠŸç™»å½•äº‹ä»¶æ ‡è®°
  - add_fields:
      target: "security"
      fields:
        event_type: login_success
        severity: low
      when:
        contains:
          message: "Accepted password"
          
  # 4. å¤åˆ¶ç”¨æˆ·ä¿¡æ¯
  - copy_fields:
      fields:
        - from: "user.name"
          to: "security.user"
      when:
        exists:
          user.name: true
          
  # 5. åˆ é™¤æˆåŠŸçš„sudoæ—¥å¿—ï¼ˆå‡å°‘å™ªéŸ³ï¼‰
  - drop_event:
      when:
        and:
          - contains: {message: "sudo"}
          - contains: {message: "COMMAND"}
          - not: {contains: {message: "incorrect password"}}
```

### 9.5 æ€§èƒ½ç›‘æ§æ—¥å¿—å¤„ç†


**âš¡ æ€§èƒ½æŒ‡æ ‡æå–å’Œæ ‡è®°**ï¼š

```yaml
filebeat.inputs:
  - type: log  
    paths:
      - /app/logs/performance.log

processors:
  # 1. æ·»åŠ æ€§èƒ½ç›‘æ§æ ‡ç­¾
  - add_fields:
      target: "monitoring"
      fields:
        category: performance
        
  # 2. æ…¢æŸ¥è¯¢æ ‡è®°
  - add_fields:
      target: "monitoring"
      fields:
        alert_level: warning
        performance_issue: slow_query
      when:
        regexp:
          message: 'query.*([0-9]+)ms.*'
        range:
          "@timestamp":
            gte: "now-1h"
            
  # 3. é«˜å†…å­˜ä½¿ç”¨æ ‡è®°
  - add_fields:
      target: "monitoring"  
      fields:
        alert_level: critical
        performance_issue: high_memory
      when:
        regexp:
          message: 'memory.*9[0-9]%'
          
  # 4. å¤åˆ¶å…³é”®æ€§èƒ½æŒ‡æ ‡
  - copy_fields:
      fields:
        - from: "response_time"
          to: "monitoring.response_time_backup"
      when:
        exists:
          response_time: true
          
  # 5. åˆ é™¤æ­£å¸¸çš„å¥åº·æ£€æŸ¥æ—¥å¿—
  - drop_event:
      when:
        and:
          - contains: {message: "health check"}
          - contains: {message: "OK"}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å­—æ®µå¤„ç†å™¨æœ¬è´¨ï¼šæ•°æ®çš„"åŒ…è£…å·¥"å’Œ"æ•´ç†å‘˜"
ğŸ”¸ add_fieldsï¼šç»™æ•°æ®è´´æ ‡ç­¾ï¼Œæ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
ğŸ”¸ add_host_metadataï¼šè‡ªåŠ¨æ·»åŠ æœåŠ¡å™¨ä¿¡æ¯
ğŸ”¸ add_docker_metadataï¼šè‡ªåŠ¨æ·»åŠ å®¹å™¨ä¿¡æ¯
ğŸ”¸ copy_fieldsï¼šå­—æ®µå¤åˆ¶ï¼Œå¤‡ä»½é‡è¦ä¿¡æ¯
ğŸ”¸ renameï¼šå­—æ®µé‡å‘½åï¼Œæ ‡å‡†åŒ–å‘½å
ğŸ”¸ drop_fieldsï¼šåˆ é™¤ä¸éœ€è¦çš„å­—æ®µï¼ŒèŠ‚çœç©ºé—´
ğŸ”¸ drop_eventï¼šåˆ é™¤æ•´ä¸ªäº‹ä»¶ï¼Œè¿‡æ»¤å™ªéŸ³
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤„ç†å™¨çš„æ‰§è¡Œé¡ºåºå¾ˆé‡è¦**ï¼š
```
æ­£ç¡®é¡ºåºç¤ºä¾‹ï¼š
1. copy_fields    # å…ˆå¤‡ä»½é‡è¦å­—æ®µ
2. add_fields     # æ·»åŠ æ ‡ç­¾
3. rename         # é‡å‘½åå­—æ®µ
4. drop_fields    # åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
5. drop_event     # æœ€åè¿‡æ»¤äº‹ä»¶

é”™è¯¯é¡ºåºç¤ºä¾‹ï¼š
1. drop_fields    # å…ˆåˆ é™¤å­—æ®µ
2. copy_fields    # æƒ³å¤åˆ¶ä½†å­—æ®µå·²ç»è¢«åˆ é™¤äº†ï¼âŒ
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨å“ªä¸ªå¤„ç†å™¨**ï¼š
```
æ•°æ®å¢å¼ºï¼š
â€¢ éœ€è¦æ·»åŠ ç¯å¢ƒä¿¡æ¯ â†’ add_fields
â€¢ éœ€è¦æœåŠ¡å™¨ä¿¡æ¯ â†’ add_host_metadata  
â€¢ éœ€è¦å®¹å™¨ä¿¡æ¯ â†’ add_docker_metadata

æ•°æ®æ•´ç†ï¼š
â€¢ å¤‡ä»½é‡è¦å­—æ®µ â†’ copy_fields
â€¢ ç»Ÿä¸€å­—æ®µå‘½å â†’ rename

æ•°æ®ç²¾ç®€ï¼š
â€¢ åˆ é™¤æ— ç”¨å­—æ®µ â†’ drop_fields
â€¢ è¿‡æ»¤æ— ç”¨æ—¥å¿— â†’ drop_event
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„è€ƒè™‘**ï¼š
```
å­˜å‚¨ä¼˜åŒ–ï¼š
â€¢ åˆ é™¤Filebeatè‡ªå¸¦å­—æ®µï¼šagentã€ecsã€input
â€¢ åˆ é™¤è¯¦ç»†ä¸»æœºä¿¡æ¯ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
â€¢ åˆ é™¤æ•æ„Ÿä¿¡æ¯å­—æ®µ

å¤„ç†æ•ˆç‡ï¼š
â€¢ æŠŠdrop_eventæ”¾åœ¨æœ€åï¼ˆé¿å…æ— æ•ˆå¤„ç†ï¼‰
â€¢ ä½¿ç”¨æ¡ä»¶whenå‡å°‘ä¸å¿…è¦çš„æ“ä½œ
â€¢ åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**ï¼š
```
åŸºç¡€é…ç½®æ¨¡æ¿ï¼š
processors:
  # 1. æ•°æ®å¢å¼ºé˜¶æ®µ
  - add_fields:
      target: "labels"
      fields:
        environment: production
        
  - add_host_metadata:
      cache_ttl: 5m
      
  # 2. æ•°æ®å¤‡ä»½é˜¶æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰
  - copy_fields:
      fields:
        - from: "message"
          to: "original_message"
      when:
        exists: {message: true}
        
  # 3. æ•°æ®æ ‡å‡†åŒ–é˜¶æ®µ
  - rename:
      fields:
        - from: "src_ip"
          to: "source_ip"
          
  # 4. æ•°æ®æ¸…ç†é˜¶æ®µ
  - drop_fields:
      fields: ["agent", "ecs", "input"]
      
  # 5. æ•°æ®è¿‡æ»¤é˜¶æ®µ
  - drop_event:
      when:
        equals:
          log.level: "DEBUG"
```

**ğŸ› ï¸ è°ƒè¯•å’Œæ•…éšœæ’æŸ¥**ï¼š
```
è°ƒè¯•æŠ€å·§ï¼š
1. é€æ­¥æ·»åŠ å¤„ç†å™¨ï¼Œè§‚å¯Ÿæ•ˆæœ
2. ä½¿ç”¨copy_fieldså¤‡ä»½å…³é”®å­—æ®µ
3. å…ˆç”¨å°æ•°æ®é‡æµ‹è¯•é…ç½®
4. æŸ¥çœ‹Filebeatæ—¥å¿—æ’æŸ¥é”™è¯¯

å¸¸è§é—®é¢˜ï¼š
â€¢ å­—æ®µçªç„¶æ¶ˆå¤± â†’ æ£€æŸ¥drop_fieldsé…ç½®
â€¢ å¤„ç†å™¨ä¸ç”Ÿæ•ˆ â†’ æ£€æŸ¥whenæ¡ä»¶
â€¢ æ€§èƒ½ä¸‹é™ â†’ æ£€æŸ¥å¤„ç†å™¨é¡ºåºå’Œç¼“å­˜è®¾ç½®
```

**ğŸ¯ é€‰æ‹©å¤„ç†å™¨çš„å†³ç­–æµç¨‹**ï¼š
```
éœ€è¦æ·»åŠ ä¿¡æ¯ï¼Ÿ
â”œâ”€ æ˜¯ â†’ å›ºå®šä¿¡æ¯ç”¨add_fields
â”‚      â†’ ä¸»æœºä¿¡æ¯ç”¨add_host_metadata
â”‚      â†’ å®¹å™¨ä¿¡æ¯ç”¨add_docker_metadata
â””â”€ å¦ â†’ ç»§ç»­

éœ€è¦ä¿ç•™åŸå­—æ®µï¼Ÿ
â”œâ”€ æ˜¯ â†’ ç”¨copy_fields
â””â”€ å¦ â†’ ç”¨rename

éœ€è¦åˆ é™¤ä¿¡æ¯ï¼Ÿ
â”œâ”€ åˆ é™¤å­—æ®µ â†’ drop_fields
â””â”€ åˆ é™¤æ•´æ¡æ—¥å¿— â†’ drop_event
```

### 10.4 å­¦ä¹ å»ºè®®å’Œæ³¨æ„äº‹é¡¹


**ğŸ“š å­¦ä¹ è·¯å¾„**ï¼š
```
å…¥é—¨é˜¶æ®µï¼š
1. ç†è§£æ¯ä¸ªå¤„ç†å™¨çš„åŸºæœ¬ä½œç”¨
2. åœ¨æµ‹è¯•ç¯å¢ƒç»ƒä¹ åŸºæœ¬é…ç½®
3. æŒæ¡å¸¸ç”¨çš„whenæ¡ä»¶

è¿›é˜¶é˜¶æ®µï¼š  
1. å­¦ä¹ å¤æ‚çš„æ¡ä»¶ç»„åˆ
2. ç†è§£å¤„ç†å™¨çš„æ‰§è¡Œé¡ºåº
3. æŒæ¡æ€§èƒ½ä¼˜åŒ–æŠ€å·§

é«˜çº§é˜¶æ®µï¼š
1. æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å¤„ç†æµç¨‹
2. å¤„ç†å¤æ‚çš„æ•°æ®è½¬æ¢éœ€æ±‚
3. ç»“åˆå…¶ä»–ELKç»„ä»¶ä¼˜åŒ–æ•´ä¸ªæµç¨‹
```

**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹**ï¼š
```
é…ç½®å®‰å…¨ï¼š
â€¢ é¿å…åœ¨é…ç½®æ–‡ä»¶ä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯
â€¢ ä½¿ç”¨drop_fieldsåˆ é™¤æ•æ„Ÿå­—æ®µ
â€¢ å®šæœŸå®¡æŸ¥å¤„ç†å™¨é…ç½®

æ€§èƒ½ç›‘æ§ï¼š
â€¢ ç›‘æ§Filebeatçš„CPUå’Œå†…å­˜ä½¿ç”¨
â€¢ è§‚å¯Ÿå¤„ç†å»¶è¿Ÿ
â€¢ æ ¹æ®æ•°æ®é‡è°ƒæ•´ç¼“å­˜è®¾ç½®

é…ç½®ç®¡ç†ï¼š
â€¢ ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç®¡ç†é…ç½®æ–‡ä»¶
â€¢ æµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½²ç”Ÿäº§
â€¢ å»ºç«‹é…ç½®å˜æ›´å®¡æŸ¥æµç¨‹
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
- æ·»åŠ ä¿¡æ¯ç”¨addç³»åˆ—ï¼Œä¸»æœºå®¹å™¨æœ‰ä¸“é—¨
- å¤åˆ¶é‡å‘½åä¸ºæ•´ç†ï¼Œå…ˆå¤åˆ¶æ¥åæ”¹å  
- åˆ é™¤åˆ†ä¸ºå­—æ®µäº‹ä»¶ï¼ŒèŠ‚çœç©ºé—´è¿‡å™ªéŸ³
- é¡ºåºå¾ˆé‡è¦è®°ç‰¢å›ºï¼Œå…ˆå¢åæ”¹å†åˆ é™¤

**æ ¸å¿ƒç†å¿µ**ï¼šå­—æ®µå¤„ç†å™¨æ˜¯æ•°æ®é¢„å¤„ç†çš„é‡è¦å·¥å…·ï¼Œåˆç†ä½¿ç”¨èƒ½è®©æ—¥å¿—æ•°æ®æ›´æœ‰ä»·å€¼ã€æ›´èŠ‚çœèµ„æºã€‚å…³é”®æ˜¯ç†è§£æ¯ä¸ªå¤„ç†å™¨çš„ç‰¹ç‚¹ï¼Œæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç»„åˆã€‚