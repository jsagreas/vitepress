---
title: 2ã€Kubernetesé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Kubernetesé›†æˆåŸºç¡€æ¦‚å¿µ](#1-kubernetesé›†æˆåŸºç¡€æ¦‚å¿µ)
2. [DaemonSetéƒ¨ç½²æ¨¡å¼è¯¦è§£](#2-daemonsetéƒ¨ç½²æ¨¡å¼è¯¦è§£)
3. [Sidecaréƒ¨ç½²æ¨¡å¼å®æˆ˜](#3-sidecaréƒ¨ç½²æ¨¡å¼å®æˆ˜)
4. [Autodiscoverè‡ªåŠ¨å‘ç°æœºåˆ¶](#4-autodiscoverè‡ªåŠ¨å‘ç°æœºåˆ¶)
5. [Podæ—¥å¿—é‡‡é›†æœ€ä½³å®è·µ](#5-podæ—¥å¿—é‡‡é›†æœ€ä½³å®è·µ)
6. [é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°](#6-é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°)
7. [å¤šå®¹å™¨ç¯å¢ƒå¤„ç†ç­–ç•¥](#7-å¤šå®¹å™¨ç¯å¢ƒå¤„ç†ç­–ç•¥)
8. [Helmå›¾è¡¨ä½¿ç”¨æŒ‡å—](#8-helmå›¾è¡¨ä½¿ç”¨æŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Kubernetesé›†æˆåŸºç¡€æ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åœ¨K8sä¸­ä½¿ç”¨Filebeat


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªå¤§å‹è´­ç‰©ä¸­å¿ƒï¼ˆKubernetesé›†ç¾¤ï¼‰ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå•†åº—ï¼ˆPodï¼‰ï¼Œæ¯ä¸ªå•†åº—éƒ½ä¼šäº§ç”Ÿé”€å”®è®°å½•ï¼ˆæ—¥å¿—ï¼‰ã€‚ä¼ ç»Ÿæ–¹å¼éœ€è¦äººå·¥å»æ¯ä¸ªåº—æ”¶é›†è®°å½•ï¼Œä½†ç”¨Filebeatå°±åƒå®‰è£…äº†è‡ªåŠ¨æ”¶é“¶ç³»ç»Ÿï¼Œèƒ½è‡ªåŠ¨æ”¶é›†æ‰€æœ‰åº—é“ºçš„æ•°æ®ã€‚

**ä¼ ç»Ÿæ—¥å¿—æ”¶é›†çš„ç—›ç‚¹**ï¼š
```
å•æœºç¯å¢ƒ vs K8sç¯å¢ƒå¯¹æ¯”ï¼š

å•æœºæœåŠ¡å™¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æœåŠ¡      â”‚ â†’ æ—¥å¿—æ–‡ä»¶å›ºå®šè·¯å¾„
â”‚   /var/log/app  â”‚ â†’ Filebeatç›´æ¥è¯»å–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

K8sç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pod-1         â”‚  â”‚   Pod-2         â”‚  â”‚   Pod-3         â”‚
â”‚ éšæ—¶åˆ›å»º/é”€æ¯    â”‚  â”‚ åŠ¨æ€è°ƒåº¦        â”‚  â”‚ æ—¥å¿—è·¯å¾„å˜åŒ–    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**K8sç¯å¢ƒçš„ç‰¹æ®ŠæŒ‘æˆ˜**ï¼š
- **åŠ¨æ€æ€§**ï¼šPodéšæ—¶åˆ›å»ºå’Œé”€æ¯ï¼Œæ—¥å¿—è·¯å¾„ä¸å›ºå®š
- **åˆ†å¸ƒæ€§**ï¼šåº”ç”¨åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šè¿è¡Œ  
- **å¤šæ ·æ€§**ï¼šä¸åŒç±»å‹çš„åº”ç”¨ï¼Œæ—¥å¿—æ ¼å¼å„å¼‚
- **è§„æ¨¡æ€§**ï¼šæˆç™¾ä¸Šåƒä¸ªPodåŒæ—¶è¿è¡Œ

### 1.2 Filebeatåœ¨K8sä¸­çš„ä½œç”¨


**ğŸ” æ·±å…¥æ€è€ƒï¼šFilebeatè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
å¼€å‘äººå‘˜ï¼šæˆ‘çš„åº”ç”¨æ—¥å¿—åœ¨å“ªé‡Œï¼ŸPodé‡å¯åæ—¥å¿—ä¸¢äº†ï¼
è¿ç»´äººå‘˜ï¼šè¦æ‰‹åŠ¨é…ç½®æ¯ä¸ªåº”ç”¨çš„æ—¥å¿—æ”¶é›†ï¼Œå¤ªç´¯äº†ï¼
ç›‘æ§äººå‘˜ï¼šæ— æ³•å®æ—¶çœ‹åˆ°æ‰€æœ‰æœåŠ¡çš„æ—¥å¿—çŠ¶æ€ï¼

Filebeatçš„è§£å†³æ–¹æ¡ˆï¼š
âœ… è‡ªåŠ¨å‘ç°æ–°å¯åŠ¨çš„Pod
âœ… åŠ¨æ€è¯»å–ä¸åŒåº”ç”¨çš„æ—¥å¿—
âœ… ç»Ÿä¸€æ”¶é›†åˆ°Elasticsearch
âœ… Podé”€æ¯åæ—¥å¿—ä»ç„¶ä¿ç•™
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨é…ç½®æ¯ä¸ªåº”ç”¨
- **ç»Ÿä¸€åŒ–**ï¼šæ‰€æœ‰æ—¥å¿—é›†ä¸­åˆ°ä¸€ä¸ªåœ°æ–¹
- **å®æ—¶æ€§**ï¼šæ–°Podå¯åŠ¨ç«‹å³å¼€å§‹æ”¶é›†æ—¥å¿—
- **å¯é æ€§**ï¼šç¡®ä¿æ—¥å¿—ä¸ä¸¢å¤±

---

## 2. âš™ï¸ DaemonSetéƒ¨ç½²æ¨¡å¼è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯DaemonSetéƒ¨ç½²


> **ğŸ§  è®°å¿†æŠ€å·§**  
> DaemonSetå°±åƒ"ä¿å®‰å·¡é€»"ï¼Œæ¯ä¸ªæ¥¼å±‚ï¼ˆèŠ‚ç‚¹ï¼‰éƒ½è¦å®‰æ’ä¸€ä¸ªä¿å®‰ï¼ˆFilebeatï¼‰ï¼Œè´Ÿè´£æ”¶é›†è¯¥æ¥¼å±‚æ‰€æœ‰æˆ¿é—´ï¼ˆPodï¼‰çš„ä¿¡æ¯ã€‚

**DaemonSetçš„å·¥ä½œåŸç†**ï¼š
```
K8sé›†ç¾¤æ¶æ„ï¼š
       MasterèŠ‚ç‚¹
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
  Node1   Node2  Node3
    â”‚      â”‚      â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”
â”‚Filebeat â”‚Filebeat â”‚Filebeat
â”‚   â”‚   â”‚ â”‚  â”‚  â”‚ â”‚ â”‚   â”‚
â”‚ Pod1  â”‚ â”‚Pod2 â”‚ â”‚Pod3 â”‚
â”‚ Pod4  â”‚ â”‚Pod5 â”‚ â”‚Pod6 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªFilebeatå®ä¾‹
```

### 2.2 DaemonSeté…ç½®å®æˆ˜


**ğŸ“‹ å¿«é€ŸæŸ¥é˜…ï¼šåŸºç¡€DaemonSeté…ç½®**

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
spec:
  selector:
    matchLabels:
      app: filebeat
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      serviceAccountName: filebeat
      terminationGracePeriodSeconds: 30
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.8.0
        args: [
          "-c", "/etc/filebeat.yml",
          "-e",
        ]
        securityContext:
          runAsUser: 0
          # éœ€è¦rootæƒé™è¯»å–èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—æ–‡ä»¶
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi
        volumeMounts:
        - name: config
          mountPath: /etc/filebeat.yml
          readOnly: true
          subPath: filebeat.yml
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: varlog
          mountPath: /var/log
          readOnly: true
      volumes:
      - name: config
        configMap:
          defaultMode: 0600
          name: filebeat-config
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: varlog
        hostPath:
          path: /var/log
```

**âš ï¸ å¸¸è§è¯¯åŒº**
```
æ–°æ‰‹å®¹æ˜“çŠ¯çš„é”™è¯¯ï¼š

âŒ å¿˜è®°è®¾ç½®runAsUser: 0
   ç»“æœï¼šFilebeatæ— æ³•è¯»å–èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—æ–‡ä»¶
   
âŒ æ²¡æœ‰æŒ‚è½½æ­£ç¡®çš„æ—¥å¿—ç›®å½•
   ç»“æœï¼šæ‰¾ä¸åˆ°å®¹å™¨æ—¥å¿—æ–‡ä»¶
   
âŒ èµ„æºé™åˆ¶è®¾ç½®è¿‡å°
   ç»“æœï¼šFilebeaté¢‘ç¹é‡å¯ï¼Œæ—¥å¿—æ”¶é›†ä¸­æ–­
```

### 2.3 DaemonSetçš„ä¼˜åŠ¿ä¸ä½¿ç”¨åœºæ™¯


**ğŸŒŸ ä¼˜åŠ¿åˆ†æ**ï¼š

| ç‰¹ç‚¹ | è¯´æ˜ | å®é™…æ„ä¹‰ |
|------|------|----------|
| **å…¨è¦†ç›–** | æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰Filebeat | ä¸ä¼šé—æ¼ä»»ä½•èŠ‚ç‚¹çš„æ—¥å¿— |
| **è‡ªåŠ¨æ‰©å±•** | æ–°èŠ‚ç‚¹è‡ªåŠ¨éƒ¨ç½²Filebeat | é›†ç¾¤æ‰©å®¹æ—¶æ— éœ€æ‰‹åŠ¨å¹²é¢„ |
| **èµ„æºæ•ˆç‡** | ä¸€ä¸ªèŠ‚ç‚¹ä¸€ä¸ªå®ä¾‹ | é¿å…é‡å¤æ”¶é›†ç›¸åŒæ—¥å¿— |
| **æ•…éšœéš”ç¦»** | å•èŠ‚ç‚¹æ•…éšœä¸å½±å“å…¶ä»–èŠ‚ç‚¹ | æé«˜æ•´ä½“å¯é æ€§ |

**ğŸ“ˆ é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **ç³»ç»Ÿæ—¥å¿—æ”¶é›†**ï¼šæ”¶é›†èŠ‚ç‚¹çº§åˆ«çš„ç³»ç»Ÿæ—¥å¿—
- âœ… **å®¹å™¨æ—¥å¿—æ”¶é›†**ï¼šæ”¶é›†æ‰€æœ‰Podçš„æ ‡å‡†è¾“å‡ºæ—¥å¿—
- âœ… **åŸºç¡€è®¾æ–½ç›‘æ§**ï¼šç›‘æ§èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ
- âœ… **å®‰å…¨å®¡è®¡**ï¼šæ”¶é›†æ‰€æœ‰èŠ‚ç‚¹çš„å®‰å…¨äº‹ä»¶

---

## 3. ğŸª Sidecaréƒ¨ç½²æ¨¡å¼å®æˆ˜


### 3.1 Sidecaræ¨¡å¼åŸºæœ¬æ¦‚å¿µ


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> Sidecarå°±åƒ"è´´èº«ä¿é•–"ï¼Œæ¯ä¸ªé‡è¦äººç‰©ï¼ˆä¸»åº”ç”¨å®¹å™¨ï¼‰éƒ½é…ä¸€ä¸ªä¸“å±ä¿é•–ï¼ˆFilebeatå®¹å™¨ï¼‰ï¼Œè´Ÿè´£å¤„ç†ä»–çš„æ‰€æœ‰äº‹åŠ¡ï¼ˆæ—¥å¿—æ”¶é›†ï¼‰ã€‚

**Sidecar vs DaemonSetå¯¹æ¯”**ï¼š
```
DaemonSetæ¨¡å¼ï¼šä¸€ä¸ªæ¥¼å±‚ä¸€ä¸ªä¿å®‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Node1                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Pod1 â”‚ â”‚Pod2 â”‚ â”‚Pod3 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜       â”‚
â”‚              â”‚                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”‚
â”‚         â”‚ Filebeat â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Sidecaræ¨¡å¼ï¼šæ¯ä¸ªæˆ¿é—´ä¸€ä¸ªä¿é•–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Node1                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚    Pod1     â”‚ â”‚    Pod2     â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚   App   â”‚ â”‚ â”‚ â”‚   App   â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚Filebeat â”‚ â”‚ â”‚ â”‚Filebeat â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Sidecaré…ç½®å®æˆ˜


**å®é™…æ¡ˆä¾‹ï¼šWebåº”ç”¨æ—¥å¿—æ”¶é›†**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp-with-logging
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      containers:
      # ä¸»åº”ç”¨å®¹å™¨
      - name: webapp
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: log-volume
          mountPath: /var/log/nginx
      
      # Sidecaræ—¥å¿—æ”¶é›†å®¹å™¨
      - name: filebeat-sidecar
        image: docker.elastic.co/beats/filebeat:8.8.0
        args: [
          "-c", "/etc/filebeat.yml",
          "-e",
        ]
        volumeMounts:
        - name: filebeat-config
          mountPath: /etc/filebeat.yml
          subPath: filebeat.yml
        - name: log-volume
          mountPath: /var/log/nginx
          readOnly: true
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 50m
            memory: 50Mi
      
      volumes:
      - name: log-volume
        emptyDir: {}
      - name: filebeat-config
        configMap:
          name: webapp-filebeat-config
```

**Sidecarä¸“ç”¨é…ç½®**ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: webapp-filebeat-config
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: log
      enabled: true
      paths:
        - /var/log/nginx/access.log
        - /var/log/nginx/error.log
      fields:
        app: webapp
        environment: production
      fields_under_root: true
      
    output.elasticsearch:
      hosts: ["elasticsearch:9200"]
      index: "webapp-logs-%{+yyyy.MM.dd}"
      
    logging.level: info
```

### 3.3 Sidecaræ¨¡å¼çš„é€‚ç”¨åœºæ™¯


**ğŸ¯ æœ€ä½³å®è·µåœºæ™¯**ï¼š

```
é€‚ç”¨æƒ…å†µåˆ†æï¼š

âœ… ç‰¹æ®Šæ—¥å¿—æ ¼å¼ï¼šåº”ç”¨æœ‰è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼éœ€è¦ç‰¹æ®Šè§£æ
âœ… å®‰å…¨è¦æ±‚é«˜ï¼šé‡‘èã€åŒ»ç–—ç­‰å¯¹æ—¥å¿—å®‰å…¨è¦æ±‚æé«˜çš„è¡Œä¸š
âœ… èµ„æºéš”ç¦»ï¼šä¸åŒåº”ç”¨éœ€è¦ä¸åŒçš„èµ„æºé…ç½®
âœ… ç‹¬ç«‹é…ç½®ï¼šæ¯ä¸ªåº”ç”¨çš„æ—¥å¿—å¤„ç†é€»è¾‘å®Œå…¨ä¸åŒ

âŒ èµ„æºæ•æ„Ÿï¼šé›†ç¾¤èµ„æºç´§å¼ ï¼Œä¸é€‚åˆéƒ¨ç½²è¿‡å¤šSidecar
âŒ ç®€å•åœºæ™¯ï¼šæ ‡å‡†æ—¥å¿—æ”¶é›†ï¼ŒDaemonSetæ›´åˆé€‚
âŒ è¿ç»´å¤æ‚ï¼šå¢åŠ éƒ¨ç½²å’Œç®¡ç†å¤æ‚åº¦
```

---

## 4. ğŸ” Autodiscoverè‡ªåŠ¨å‘ç°æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯Autodiscover


> **ğŸ§  è®°å¿†æŠ€å·§**  
> Autodiscoverå°±åƒ"æ™ºèƒ½å¿«é€’å‘˜"ï¼Œèƒ½è‡ªåŠ¨è¯†åˆ«æ–°æ¬æ¥çš„ä½æˆ·ï¼ˆæ–°Podï¼‰ï¼Œå¹¶æ ¹æ®é—¨ç‰Œå·ï¼ˆannotationï¼‰ç¡®å®šè¦æä¾›ä»€ä¹ˆæœåŠ¡ï¼ˆæ—¥å¿—æ”¶é›†é…ç½®ï¼‰ã€‚

**è‡ªåŠ¨å‘ç°è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
```
ä¼ ç»Ÿæ–¹å¼çš„å±€é™ï¼š
é…ç½®å·¥ç¨‹å¸ˆï¼šåˆæœ‰æ–°åº”ç”¨ä¸Šçº¿äº†ï¼Œè¦æ‰‹åŠ¨é…ç½®æ—¥å¿—æ”¶é›†
å¼€å‘å·¥ç¨‹å¸ˆï¼šæˆ‘çš„åº”ç”¨æœ‰ç‰¹æ®Šæ—¥å¿—æ ¼å¼ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
è¿ç»´å·¥ç¨‹å¸ˆï¼šè¿™ä¹ˆå¤šåº”ç”¨ï¼Œé…ç½®ç®¡ç†å¤ªå¤æ‚äº†ï¼

Autodiscoverçš„è§£å†³æ–¹æ¡ˆï¼š
ğŸ¯ æ–°Podå¯åŠ¨ â†’ è‡ªåŠ¨æ£€æµ‹
ğŸ¯ è¯»å–annotation â†’ è‡ªåŠ¨é…ç½®
ğŸ¯ å¼€å§‹æ”¶é›† â†’ æ— éœ€äººå·¥å¹²é¢„
ğŸ¯ Podé”€æ¯ â†’ è‡ªåŠ¨æ¸…ç†é…ç½®
```

### 4.2 Autodiscoveré…ç½®è¯¦è§£


**åŸºç¡€é…ç½®ç»“æ„**ï¼š

```yaml
filebeat.autodiscover:
  providers:
    - type: kubernetes
      scope: cluster
      node: ${NODE_NAME}
      hints.enabled: true
      hints.default_config:
        type: container
        paths:
          - /var/log/containers/*${data.kubernetes.container.id}.log
      templates:
        # åŸºäºPodæ ‡ç­¾çš„æ¨¡æ¿åŒ¹é…
        - condition:
            equals:
              kubernetes.labels.app: "nginx"
          config:
            - type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
              processors:
                - add_kubernetes_metadata:
                    host: ${NODE_NAME}
                    matchers:
                    - logs_path:
                        logs_path: "/var/log/containers/"
                        resource_type: "container"
```

**ğŸ”§ å®è·µæ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç¡®è®¤NODE_NAMEç¯å¢ƒå˜é‡è®¾ç½®
- [ ] éªŒè¯RBACæƒé™é…ç½®æ­£ç¡®
- [ ] æµ‹è¯•annotationé…ç½®ç”Ÿæ•ˆ
- [ ] æ£€æŸ¥æ¨¡æ¿åŒ¹é…é€»è¾‘

### 4.3 Annotationé…ç½®å®æˆ˜


**å®é™…åº”ç”¨ç¤ºä¾‹ï¼šä¸åŒç±»å‹åº”ç”¨çš„é…ç½®**

```yaml
# Webåº”ç”¨Podé…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: webapp-pod
  annotations:
    # å¯ç”¨æ—¥å¿—æ”¶é›†
    co.elastic.logs/enabled: "true"
    # æŒ‡å®šå¤šè¡Œæ—¥å¿—æ¨¡å¼ï¼ˆJavaå¼‚å¸¸å †æ ˆï¼‰
    co.elastic.logs/multiline.pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}'
    co.elastic.logs/multiline.negate: "true"
    co.elastic.logs/multiline.match: "after"
    # æŒ‡å®šæ—¥å¿—è§£æå™¨
    co.elastic.logs/processors.0.decode_json_fields.fields: "message"
    co.elastic.logs/processors.0.decode_json_fields.target: ""
spec:
  containers:
  - name: webapp
    image: my-webapp:latest

---
# æ•°æ®åº“Podé…ç½®
apiVersion: v1
kind: Pod
metadata:
  name: database-pod
  annotations:
    # å¯ç”¨ä½†é…ç½®ä¸åŒçš„ç´¢å¼•
    co.elastic.logs/enabled: "true"
    co.elastic.logs/index: "database-logs-%{+yyyy.MM.dd}"
    # æ’é™¤æ•æ„Ÿä¿¡æ¯
    co.elastic.logs/processors.0.drop_fields.fields: ["password", "secret"]
spec:
  containers:
  - name: mysql
    image: mysql:8.0
```

**ğŸ“Š Annotationé…ç½®å¯¹ç…§è¡¨**ï¼š

| Annotation | ä½œç”¨ | ç¤ºä¾‹å€¼ | ä½¿ç”¨åœºæ™¯ |
|------------|------|--------|----------|
| `co.elastic.logs/enabled` | å¯ç”¨æ—¥å¿—æ”¶é›† | `"true"` | æ‰€æœ‰éœ€è¦æ”¶é›†æ—¥å¿—çš„Pod |
| `co.elastic.logs/multiline.pattern` | å¤šè¡Œæ—¥å¿—æ¨¡å¼ | `'^ERROR'` | Javaå¼‚å¸¸ã€SQLæŸ¥è¯¢ç­‰ |
| `co.elastic.logs/index` | æŒ‡å®šESç´¢å¼• | `"app-logs"` | æŒ‰åº”ç”¨åˆ†ç±»å­˜å‚¨ |
| `co.elastic.logs/processors` | æ•°æ®å¤„ç† | è§ä¸Šæ–¹ç¤ºä¾‹ | æ•°æ®æ¸…æ´—å’Œè½¬æ¢ |

---

## 5. ğŸ“Š Podæ—¥å¿—é‡‡é›†æœ€ä½³å®è·µ


### 5.1 å®¹å™¨æ—¥å¿—è·¯å¾„ç†è§£


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> Kuberneteså®¹å™¨æ—¥å¿—å°±åƒ"å¿«é€’æ”¶ä»¶è®°å½•"ï¼Œæ¯ä¸ªå¿«é€’ç‚¹ï¼ˆPodï¼‰çš„è®°å½•éƒ½å­˜åœ¨å›ºå®šçš„æŸœå­ï¼ˆè·¯å¾„ï¼‰é‡Œï¼ŒFilebeatè¦çŸ¥é“æŸœå­åœ¨å“ªé‡Œæ‰èƒ½æ”¶é›†è®°å½•ã€‚

**K8sæ—¥å¿—è·¯å¾„ç»“æ„**ï¼š
```
èŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ—¥å¿—è·¯å¾„ï¼š
/var/log/containers/
â”œâ”€â”€ pod1-container1-abc123.log â†’ /var/log/pods/default_pod1_uid/container1/0.log
â”œâ”€â”€ pod1-container2-def456.log â†’ /var/log/pods/default_pod1_uid/container2/0.log
â”œâ”€â”€ pod2-container1-ghi789.log â†’ /var/log/pods/default_pod2_uid/container1/0.log
â””â”€â”€ ...

è·¯å¾„ç»„æˆè§„åˆ™ï¼š
podname-containername-containerid.log
```

**è·¯å¾„é…ç½®ç­–ç•¥**ï¼š

```yaml
filebeat.inputs:
- type: container
  paths:
    # æ ‡å‡†å®¹å™¨æ—¥å¿—è·¯å¾„
    - /var/log/containers/*.log
  processors:
    # è‡ªåŠ¨æ·»åŠ Kuberneteså…ƒæ•°æ®
    - add_kubernetes_metadata:
        host: ${NODE_NAME}
        matchers:
        - logs_path:
            logs_path: "/var/log/containers/"
            resource_type: "container"
    # è§£æå®¹å™¨æ—¥å¿—æ ¼å¼
    - decode_json_fields:
        fields: ["message"]
        target: ""
        overwrite_keys: true
```

### 5.2 å¤šå®¹å™¨Podå¤„ç†ç­–ç•¥


**å®é™…åœºæ™¯ï¼šå¾®æœåŠ¡åº”ç”¨Pod**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: microservice-pod
  labels:
    app: microservice
    tier: backend
spec:
  containers:
  # ä¸»åº”ç”¨å®¹å™¨
  - name: app-server
    image: my-app:latest
    ports:
    - containerPort: 8080
  
  # ç¼“å­˜ä»£ç†å®¹å™¨
  - name: redis-proxy
    image: redis:alpine
    ports:
    - containerPort: 6379
    
  # ç›‘æ§ä»£ç†å®¹å™¨  
  - name: monitoring-agent
    image: prometheus/node-exporter
    ports:
    - containerPort: 9100
```

**é’ˆå¯¹æ€§æ—¥å¿—æ”¶é›†é…ç½®**ï¼š

```yaml
filebeat.autodiscover:
  providers:
    - type: kubernetes
      templates:
        # åº”ç”¨æœåŠ¡å™¨æ—¥å¿—é…ç½®
        - condition:
            and:
              - equals:
                  kubernetes.labels.app: "microservice"
              - equals:
                  kubernetes.container.name: "app-server"
          config:
            - type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
              fields:
                log_type: "application"
                service: "main-app"
              processors:
                - decode_json_fields:
                    fields: ["message"]
        
        # Redisä»£ç†æ—¥å¿—é…ç½®
        - condition:
            and:
              - equals:
                  kubernetes.labels.app: "microservice"
              - equals:
                  kubernetes.container.name: "redis-proxy"
          config:
            - type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
              fields:
                log_type: "cache"
                service: "redis-proxy"
```

### 5.3 æ—¥å¿—æ ¼å¼æ ‡å‡†åŒ–


**ğŸ”„ ä¸åŒæ—¥å¿—æ ¼å¼çš„ç»Ÿä¸€å¤„ç†**ï¼š

```yaml
processors:
  # 1. JSONæ ¼å¼æ—¥å¿—å¤„ç†
  - decode_json_fields:
      fields: ["message"]
      target: ""
      overwrite_keys: true
      when:
        contains:
          message: "{"
  
  # 2. ç»“æ„åŒ–æ–‡æœ¬æ—¥å¿—å¤„ç†  
  - dissect:
      tokenizer: "%{timestamp} [%{level}] %{logger}: %{msg}"
      field: "message"
      when:
        regexp:
          message: '^\d{4}-\d{2}-\d{2}'
  
  # 3. æ·»åŠ ç»Ÿä¸€å­—æ®µ
  - add_fields:
      target: "metadata"
      fields:
        cluster: "production"
        datacenter: "us-west-1"
  
  # 4. æ¸…ç†æ•æ„Ÿä¿¡æ¯
  - drop_fields:
      fields: ["password", "secret", "token"]
  
  # 5. å­—æ®µé‡å‘½åç»Ÿä¸€
  - rename:
      fields:
        - from: "log"
          to: "original_message"
        - from: "level"
          to: "log_level"
```

---

## 6. âš™ï¸ é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°


### 6.1 ConfigMapé…ç½®ç®¡ç†


> **ğŸ” æ·±å…¥æ€è€ƒ**  
> ConfigMapå°±åƒ"ä¸­å¤®é…ç½®ä¸­å¿ƒ"ï¼Œæ‰€æœ‰Filebeatå®ä¾‹éƒ½ä»è¿™é‡Œè·å–æœ€æ–°é…ç½®ï¼Œå°±åƒæ‰€æœ‰åˆ†åº—éƒ½ä»æ€»éƒ¨è·å–æœ€æ–°çš„è¥ä¸šè§„åˆ™ä¸€æ ·ã€‚

**åˆ†å±‚é…ç½®ç­–ç•¥**ï¼š

```yaml
# å…¨å±€åŸºç¡€é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-global-config
  namespace: kube-system
data:
  filebeat.yml: |
    # å…¨å±€é€šç”¨é…ç½®
    filebeat.config.modules:
      path: ${path.config}/modules.d/*.yml
      reload.enabled: true
      reload.period: 30s
    
    output.elasticsearch:
      hosts: ["${ELASTICSEARCH_HOSTS:elasticsearch:9200}"]
      username: "${ELASTICSEARCH_USERNAME:}"
      password: "${ELASTICSEARCH_PASSWORD:}"
      
    setup.template.enabled: true
    setup.template.settings:
      index.number_of_shards: 1
      index.number_of_replicas: 1
      
    logging.level: info
    logging.to_files: true
    logging.files:
      path: /var/log/filebeat
      name: filebeat
      keepfiles: 7
      permissions: 0644

---
# åº”ç”¨ä¸“ç”¨é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-app-config
  namespace: default
data:
  app-inputs.yml: |
    - type: container
      paths:
        - /var/log/containers/*${data.kubernetes.container.id}.log
      fields_under_root: true
      fields:
        logtype: application
        environment: production
      processors:
        - add_kubernetes_metadata:
            host: ${NODE_NAME}
        - decode_json_fields:
            fields: ["message"]
            target: ""
```

### 6.2 åŠ¨æ€é…ç½®æ›´æ–°æœºåˆ¶


**é…ç½®çƒ­æ›´æ–°æµç¨‹**ï¼š
```
é…ç½®æ›´æ–°æµç¨‹ï¼š
å¼€å‘è€…ä¿®æ”¹ConfigMap
        â†“
K8s APIæ›´æ–°é…ç½®
        â†“
ConfigMapå˜æ›´è§¦å‘
        â†“
Filebeatæ£€æµ‹å˜æ›´ï¼ˆ30så‘¨æœŸï¼‰
        â†“
é‡æ–°åŠ è½½é…ç½®
        â†“
åº”ç”¨æ–°é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰
```

**å®ç°åŠ¨æ€æ›´æ–°çš„é…ç½®**ï¼š

```yaml
filebeat.config.inputs:
  enabled: true
  path: /etc/filebeat/inputs.d/*.yml
  reload.enabled: true
  reload.period: 30s

filebeat.config.modules:
  enabled: true  
  path: /etc/filebeat/modules.d/*.yml
  reload.enabled: true
  reload.period: 30s
```

### 6.3 ç¯å¢ƒå˜é‡é…ç½®


**ğŸ“‹ ç¯å¢ƒå˜é‡æœ€ä½³å®è·µ**ï¼š

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
spec:
  template:
    spec:
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.8.0
        env:
        # Kubernetesç›¸å…³
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
              
        # Elasticsearchè¿æ¥
        - name: ELASTICSEARCH_HOSTS
          value: "elasticsearch-master:9200"
        - name: ELASTICSEARCH_USERNAME
          valueFrom:
            secretKeyRef:
              name: elasticsearch-credentials
              key: username
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-credentials
              key: password
              
        # æ€§èƒ½è°ƒä¼˜
        - name: FILEBEAT_MAX_PROCS
          value: "1"
        - name: GOMAXPROCS
          value: "1"
```

---

## 7. ğŸ­ å¤šå®¹å™¨ç¯å¢ƒå¤„ç†ç­–ç•¥


### 7.1 å®¹å™¨æ ‡è¯†ä¸è¿‡æ»¤


> **âš ï¸ å¸¸è§è¯¯åŒº**  
> æ–°æ‰‹å¸¸è®¤ä¸ºä¸€ä¸ªPodåªæœ‰ä¸€ä¸ªå®¹å™¨ï¼Œå®é™…ä¸Šä¸€ä¸ªPodå¯èƒ½åŒ…å«å¤šä¸ªå®¹å™¨ï¼ˆå¦‚åº”ç”¨å®¹å™¨ã€ç›‘æ§å®¹å™¨ã€ä»£ç†å®¹å™¨ç­‰ï¼‰ï¼Œéœ€è¦é’ˆå¯¹ä¸åŒå®¹å™¨åˆ¶å®šä¸åŒçš„æ—¥å¿—æ”¶é›†ç­–ç•¥ã€‚

**å®¹å™¨åˆ†ç±»ç­–ç•¥**ï¼š

```yaml
filebeat.autodiscover:
  providers:
    - type: kubernetes
      templates:
        # åº”ç”¨å®¹å™¨æ—¥å¿—
        - condition:
            not:
              or:
                - equals:
                    kubernetes.container.name: "istio-proxy"
                - equals:
                    kubernetes.container.name: "filebeat"
                - contains:
                    kubernetes.container.name: "sidecar"
          config:
            - type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
              fields:
                container_type: "application"
                
        # ç³»ç»Ÿå®¹å™¨æ—¥å¿—ï¼ˆå•ç‹¬å¤„ç†ï¼‰
        - condition:
            or:
              - equals:
                  kubernetes.container.name: "istio-proxy"
              - equals:
                  kubernetes.container.name: "envoy"
          config:
            - type: container
              paths:
                - /var/log/containers/*${data.kubernetes.container.id}.log
              fields:
                container_type: "infrastructure"
              processors:
                - drop_event:
                    when:
                      regexp:
                        message: "^DEBUG"
```

### 7.2 èµ„æºéš”ç¦»ä¸æ€§èƒ½ä¼˜åŒ–


**æŒ‰å®¹å™¨ç±»å‹é…ç½®èµ„æº**ï¼š

```yaml
# ä¸åŒä¼˜å…ˆçº§çš„æ—¥å¿—æ”¶é›†é…ç½®
filebeat.inputs:
- type: container
  paths:
    - /var/log/containers/*${data.kubernetes.container.id}.log
  # é«˜ä¼˜å…ˆçº§åº”ç”¨æ—¥å¿—
  condition: |
    contains(fields.kubernetes.labels.priority, "high")
  scan_frequency: 1s
  harvester_buffer_size: 32768
  max_bytes: 104857600  # 100MB

- type: container
  paths:
    - /var/log/containers/*${data.kubernetes.container.id}.log
  # æ™®é€šåº”ç”¨æ—¥å¿—
  condition: |
    not contains(fields.kubernetes.labels.priority, "high")
  scan_frequency: 10s
  harvester_buffer_size: 16384
  max_bytes: 10485760   # 10MB
```

### 7.3 å¤šé›†ç¾¤ç¯å¢ƒç®¡ç†


**é›†ç¾¤æ ‡è¯†é…ç½®**ï¼š

```yaml
processors:
  - add_fields:
      target: "cluster"
      fields:
        name: "${CLUSTER_NAME:unknown}"
        region: "${CLUSTER_REGION:unknown}"
        environment: "${CLUSTER_ENV:unknown}"
  - add_fields:
      target: "infrastructure"
      fields:
        kubernetes_version: "${KUBERNETES_VERSION:unknown}"
        node_name: "${NODE_NAME}"
        node_zone: "${NODE_ZONE:unknown}"

# åŸºäºé›†ç¾¤çš„è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS}"]
  index: "filebeat-%{[cluster.name]}-%{[cluster.environment]}-%{+yyyy.MM.dd}"
  template.name: "filebeat-%{[cluster.name]}"
  template.pattern: "filebeat-%{[cluster.name]}-*"
```

---

## 8. ğŸ“¦ Helmå›¾è¡¨ä½¿ç”¨æŒ‡å—


### 8.1 Helméƒ¨ç½²FilebeatåŸºç¡€


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> Helmå°±åƒ"è½¯ä»¶åŒ…ç®¡ç†å™¨"ï¼Œç±»ä¼¼äºæ‰‹æœºçš„åº”ç”¨å•†åº—ï¼Œå¯ä»¥ä¸€é”®å®‰è£…å¤æ‚çš„åº”ç”¨ï¼Œå¹¶ä¸”èƒ½æ–¹ä¾¿åœ°å‡çº§å’Œå¸è½½ã€‚

**å¿«é€Ÿå®‰è£…æ­¥éª¤**ï¼š

```bash
# 1. æ·»åŠ Elasticå®˜æ–¹Helmä»“åº“
helm repo add elastic https://helm.elastic.co
helm repo update

# 2. æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬
helm search repo elastic/filebeat

# 3. ä¸‹è½½é»˜è®¤é…ç½®æŸ¥çœ‹
helm show values elastic/filebeat > filebeat-values.yaml

# 4. å®‰è£…Filebeat
helm install filebeat elastic/filebeat \
  --namespace kube-system \
  --create-namespace \
  -f custom-values.yaml
```

### 8.2 è‡ªå®šä¹‰Valuesé…ç½®


**ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹**ï¼š

```yaml
# custom-values.yaml
daemonset:
  enabled: true
  # èµ„æºé…ç½®
  resources:
    limits:
      memory: "400Mi"
      cpu: "200m"
    requests:
      memory: "200Mi"
      cpu: "100m"
  
  # èŠ‚ç‚¹é€‰æ‹©å™¨
  nodeSelector:
    kubernetes.io/os: linux
  
  # å®¹å¿åº¦é…ç½®
  tolerations:
  - key: node-role.kubernetes.io/master
    operator: Exists
    effect: NoSchedule

# Filebeaté…ç½®
filebeatConfig:
  filebeat.yml: |
    filebeat.autodiscover:
      providers:
        - type: kubernetes
          scope: cluster
          node: ${NODE_NAME}
          hints.enabled: true
          templates:
            - condition:
                equals:
                  kubernetes.namespace: kube-system
              config:
                - type: container
                  paths:
                    - /var/log/containers/*${data.kubernetes.container.id}.log
                  fields:
                    log_type: "system"
            - condition:
                not:
                  equals:
                    kubernetes.namespace: kube-system
              config:
                - type: container
                  paths:
                    - /var/log/containers/*${data.kubernetes.container.id}.log
                  fields:
                    log_type: "application"
    
    processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
          - logs_path:
              logs_path: "/var/log/containers/"
              resource_type: "container"
      - drop_event:
          when:
            or:
              - equals:
                  kubernetes.container.name: "filebeat"
              - contains:
                  message: "GET /health"
    
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOSTS:elasticsearch-master:9200}']
      username: '${ELASTICSEARCH_USERNAME:}'
      password: '${ELASTICSEARCH_PASSWORD:}'
      index: "filebeat-%{[fields.log_type]}-%{+yyyy.MM.dd}"

# ç¯å¢ƒå˜é‡
extraEnvs:
  - name: ELASTICSEARCH_HOSTS
    value: "elasticsearch-master:9200"
  - name: ELASTICSEARCH_USERNAME
    valueFrom:
      secretKeyRef:
        name: elasticsearch-credentials
        key: username
  - name: ELASTICSEARCH_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elasticsearch-credentials
        key: password

# é¢å¤–çš„å·æŒ‚è½½
extraVolumes:
  - name: timezone
    hostPath:
      path: /etc/localtime
      type: File

extraVolumeMounts:
  - name: timezone
    mountPath: /etc/localtime
    readOnly: true
```

### 8.3 Helmç®¡ç†æœ€ä½³å®è·µ


**ğŸ”§ è¿ç»´ç®¡ç†å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹å½“å‰éƒ¨ç½²çŠ¶æ€
helm status filebeat -n kube-system

# æŸ¥çœ‹éƒ¨ç½²å†å²
helm history filebeat -n kube-system

# å‡çº§é…ç½®
helm upgrade filebeat elastic/filebeat \
  -f custom-values.yaml \
  -n kube-system

# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
helm rollback filebeat 1 -n kube-system

# å¸è½½ï¼ˆä¿ç•™æ•°æ®ï¼‰
helm uninstall filebeat -n kube-system

# å®Œå…¨æ¸…ç†
helm uninstall filebeat -n kube-system
kubectl delete pvc -l app=filebeat -n kube-system
```

**ğŸ“ˆ ç›‘æ§éƒ¨ç½²çŠ¶æ€**ï¼š

```bash
# æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -l app=filebeat -n kube-system

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -l app=filebeat -n kube-system -f

# æ£€æŸ¥é…ç½®
kubectl get configmap filebeat-filebeat-config -n kube-system -o yaml

# éªŒè¯è‡ªåŠ¨å‘ç°
kubectl exec -it filebeat-xxx -n kube-system -- filebeat test config
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ éƒ¨ç½²æ¨¡å¼é€‰æ‹©ï¼šDaemonSet vs Sidecarï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ¨¡å¼
ğŸ”¸ è‡ªåŠ¨å‘ç°æœºåˆ¶ï¼šç†è§£autodiscoverå¦‚ä½•åŠ¨æ€é…ç½®æ—¥å¿—æ”¶é›†
ğŸ”¸ Annotationé…ç½®ï¼šæŒæ¡Podçº§åˆ«çš„æ—¥å¿—æ”¶é›†æ§åˆ¶æ–¹æ³•
ğŸ”¸ è·¯å¾„é…ç½®ï¼šç†è§£K8så®¹å™¨æ—¥å¿—çš„å­˜å‚¨è·¯å¾„å’Œè®¿é—®æ–¹å¼
ğŸ”¸ é…ç½®ç®¡ç†ï¼šä½¿ç”¨ConfigMapå®ç°é…ç½®çš„é›†ä¸­ç®¡ç†å’ŒåŠ¨æ€æ›´æ–°
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ éƒ¨ç½²æ¨¡å¼é€‰æ‹©ç­–ç•¥**ï¼š
```
DaemonSeté€‚ç”¨åœºæ™¯ï¼š
âœ… æ ‡å‡†åŒ–æ—¥å¿—æ”¶é›†éœ€æ±‚
âœ… èµ„æºä½¿ç”¨æ•ˆç‡è¦æ±‚é«˜
âœ… è¿ç»´ç®¡ç†å¤æ‚åº¦è¦æ±‚ä½
âœ… å¤§è§„æ¨¡é›†ç¾¤ç¯å¢ƒ

Sidecaré€‚ç”¨åœºæ™¯ï¼š
âœ… åº”ç”¨æœ‰ç‰¹æ®Šæ—¥å¿—å¤„ç†éœ€æ±‚
âœ… å®‰å…¨éš”ç¦»è¦æ±‚ä¸¥æ ¼
âœ… éœ€è¦åº”ç”¨çº§åˆ«çš„èµ„æºæ§åˆ¶
âœ… å¤æ‚çš„å¤šå®¹å™¨åº”ç”¨åœºæ™¯
```

**ğŸ”¹ è‡ªåŠ¨å‘ç°é…ç½®è¦ç‚¹**ï¼š
```
å…³é”®é…ç½®åŸåˆ™ï¼š
- åˆç†ä½¿ç”¨conditionæ¡ä»¶è¿‡æ»¤
- å……åˆ†åˆ©ç”¨annotationè¿›è¡Œç»†ç²’åº¦æ§åˆ¶  
- é…ç½®æ¨¡æ¿è¦è€ƒè™‘é€šç”¨æ€§å’Œç‰¹æ®Šæ€§å¹³è¡¡
- æ³¨æ„èµ„æºæ¶ˆè€—å’Œæ€§èƒ½å½±å“
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**ï¼š
```
æ€§èƒ½ä¼˜åŒ–ï¼š
- æ ¹æ®æ—¥å¿—é‡è°ƒæ•´æ‰«æé¢‘ç‡
- è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶
- ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨ä¼˜åŒ–éƒ¨ç½²

å®‰å…¨åŠ å›ºï¼š
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™é…ç½®RBAC
- æ•æ„Ÿä¿¡æ¯ä½¿ç”¨Secretç®¡ç†
- å¯ç”¨TLSåŠ å¯†ä¼ è¾“

ç›‘æ§è¿ç»´ï¼š
- é…ç½®å¥åº·æ£€æŸ¥å’Œå­˜æ´»æ¢é’ˆ
- è®¾ç½®æ—¥å¿—è½®è½¬å’Œæ¸…ç†ç­–ç•¥
- å»ºç«‹ç›‘æ§å‘Šè­¦æœºåˆ¶
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **å¾®æœåŠ¡æ¶æ„**ï¼šç»Ÿä¸€æ”¶é›†åˆ†å¸ƒå¼æœåŠ¡æ—¥å¿—ï¼Œæ”¯æŒé“¾è·¯è¿½è¸ª
- **DevOpsæµç¨‹**ï¼šé›†æˆCI/CD pipelineï¼Œå®ç°æ—¥å¿—é©±åŠ¨çš„è´¨é‡åé¦ˆ
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½é—®é¢˜Podå’Œå®¹å™¨ï¼Œæå‡æ•…éšœè§£å†³æ•ˆç‡
- **æ€§èƒ½ç›‘æ§**ï¼šåŸºäºæ—¥å¿—æ•°æ®è¿›è¡Œåº”ç”¨æ€§èƒ½åˆ†æå’Œä¼˜åŒ–

**ğŸ”§ è¿ç»´å®è·µä»·å€¼**ï¼š
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå‡å°‘æ‰‹åŠ¨é…ç½®ï¼Œå®ç°æ—¥å¿—æ”¶é›†çš„è‡ªåŠ¨åŒ–ç®¡ç†
- **è§„æ¨¡åŒ–éƒ¨ç½²**ï¼šæ”¯æŒå¤§è§„æ¨¡K8sé›†ç¾¤çš„æ—¥å¿—æ”¶é›†éœ€æ±‚
- **é…ç½®æ ‡å‡†åŒ–**ï¼šå»ºç«‹ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†è§„èŒƒå’Œæ¨¡æ¿
- **è¿ç»´æ•ˆç‡æå‡**ï¼šé€šè¿‡Helmç­‰å·¥å…·ç®€åŒ–éƒ¨ç½²å’Œç®¡ç†æµç¨‹

**ğŸ’ª å­¦ä¹ æˆé•¿è·¯å¾„**ï¼š
```
åŸºç¡€é˜¶æ®µï¼š
â†’ æŒæ¡K8såŸºæœ¬æ¦‚å¿µå’ŒPodæ—¥å¿—æœºåˆ¶
â†’ ç†è§£Filebeatåœ¨å®¹å™¨ç¯å¢ƒä¸­çš„ä½œç”¨

è¿›é˜¶é˜¶æ®µï¼š
â†’ ç†Ÿç»ƒé…ç½®DaemonSetå’ŒSidecaréƒ¨ç½²
â†’ æŒæ¡autodiscoverå’Œannotationä½¿ç”¨

é«˜çº§é˜¶æ®µï¼š
â†’ è®¾è®¡ä¼ä¸šçº§æ—¥å¿—æ”¶é›†æ¶æ„
â†’ ä¼˜åŒ–æ€§èƒ½å’Œè§£å†³å¤æ‚åœºæ™¯é—®é¢˜
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **K8sæ—¥å¿—æ”¶é›†æœ‰é—¨é“ï¼ŒDaemonSet Sidecarå„æœ‰æ‹›**
- **è‡ªåŠ¨å‘ç°é…æ¨¡æ¿ï¼Œannotationæ³¨è§£ç»†èŠ‚è¦**  
- **ConfigMapç®¡ç†é…ç½®å¥½ï¼ŒHelmå›¾è¡¨éƒ¨ç½²æ•ˆç‡é«˜**
- **å¤šå®¹å™¨ç¯å¢ƒè¦åˆ†ç±»ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸èƒ½å°‘**