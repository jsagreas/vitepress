---
title: 5ã€å®¹å™¨å¾®æœåŠ¡æ—¥å¿—
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ](#1-å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ)
2. [Dockerå®¹å™¨æ—¥å¿—æ”¶é›†](#2-Dockerå®¹å™¨æ—¥å¿—æ”¶é›†)
3. [Kubernetes Podæ—¥å¿—æ”¶é›†](#3-Kubernetes-Podæ—¥å¿—æ”¶é›†)
4. [å¾®æœåŠ¡æ¶æ„æ—¥å¿—ç­–ç•¥](#4-å¾®æœåŠ¡æ¶æ„æ—¥å¿—ç­–ç•¥)
5. [å®¹å™¨è‡ªåŠ¨å‘ç°æœºåˆ¶](#5-å®¹å™¨è‡ªåŠ¨å‘ç°æœºåˆ¶)
6. [å¤šå®¹å™¨ç¯å¢ƒç»Ÿä¸€ç®¡ç†](#6-å¤šå®¹å™¨ç¯å¢ƒç»Ÿä¸€ç®¡ç†)
7. [ELKé›†ç¾¤å¯¹æ¥å®æˆ˜](#7-ELKé›†ç¾¤å¯¹æ¥å®æˆ˜)
8. [æœåŠ¡é“¾è·¯è¿½è¸ªé›†æˆ](#8-æœåŠ¡é“¾è·¯è¿½è¸ªé›†æˆ)
9. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#9-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ‹ å®¹å™¨æ—¥å¿—æ”¶é›†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ—¥å¿—æ”¶é›†


**ç®€å•ç†è§£**ï¼šå®¹å™¨æ—¥å¿—æ”¶é›†å°±åƒæ˜¯ç»™æ¯ä¸ª"å°æˆ¿å­"ï¼ˆå®¹å™¨ï¼‰å®‰è£…ç›‘æ§æ‘„åƒå¤´ï¼Œå®æ—¶è§‚å¯Ÿé‡Œé¢å‘ç”Ÿäº†ä»€ä¹ˆã€‚

```
ä¼ ç»ŸæœåŠ¡å™¨æ—¥å¿—ï¼š                    å®¹å™¨åŒ–æ—¥å¿—ï¼š
     æœåŠ¡å™¨                           å®¿ä¸»æœº
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ åº”ç”¨ç¨‹åº â”‚                     â”‚ å®¹å™¨A å®¹å™¨B â”‚
  â”‚ æ—¥å¿—æ–‡ä»¶ â”‚ â† ç›´æ¥è¯»å–            â”‚ æ—¥å¿—  æ—¥å¿—  â”‚ â† éœ€è¦ç‰¹æ®Šå¤„ç†
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- ğŸ“¦ **å®¹å™¨çŸ­æš‚æ€§**ï¼šå®¹å™¨éšæ—¶å¯èƒ½é”€æ¯é‡å»ºï¼Œæ—¥å¿—å®¹æ˜“ä¸¢å¤±
- ğŸ”„ **åŠ¨æ€æ‰©ç¼©**ï¼šå®¹å™¨æ•°é‡ç»å¸¸å˜åŒ–ï¼Œéœ€è¦è‡ªåŠ¨å‘ç°
- ğŸ·ï¸ **æ ‡è¯†å¤æ‚**ï¼šéœ€è¦é€šè¿‡å®¹å™¨åã€é•œåƒã€æ ‡ç­¾ç­‰è¯†åˆ«æ—¥å¿—æ¥æº

### 1.2 å®¹å™¨æ—¥å¿—çš„ç‰¹æ®Šæ€§


**ä¸ä¼ ç»Ÿæ—¥å¿—çš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | **ä¼ ç»ŸæœåŠ¡å™¨** | **å®¹å™¨ç¯å¢ƒ** |
|------|--------------|-------------|
| ğŸ“ **ä½ç½®å›ºå®šæ€§** | `å›ºå®šè·¯å¾„ï¼Œä¸å˜` | `åŠ¨æ€è·¯å¾„ï¼Œéšå®¹å™¨å˜åŒ–` |
| â° **ç”Ÿå‘½å‘¨æœŸ** | `é•¿æœŸè¿è¡Œ` | `çŸ­æš‚å­˜åœ¨ï¼Œå¯èƒ½éšæ—¶é‡å¯` |
| ğŸ” **æ ‡è¯†æ–¹å¼** | `ä¸»æœºå+è·¯å¾„` | `å®¹å™¨ID+æ ‡ç­¾+å‘½åç©ºé—´` |
| ğŸ¯ **æ”¶é›†æ–¹å¼** | `ç›´æ¥æ–‡ä»¶è¯»å–` | `Docker APIæˆ–æŒ‚è½½å·` |

### 1.3 å®¹å™¨æ—¥å¿—æ”¶é›†ç­–ç•¥


**ä¸‰ç§ä¸»è¦æ–¹å¼**ï¼š

```
â”Œâ”€ æ–¹å¼ä¸€ï¼šSidecaræ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ åº”ç”¨å®¹å™¨ â”‚  â”‚ Filebeatå®¹å™¨ â”‚       â”‚
â”‚  â”‚ äº§ç”Ÿæ—¥å¿— â”‚â†’ â”‚ æ”¶é›†æ—¥å¿—    â”‚â†’ ELK  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ–¹å¼äºŒï¼šDaemonSetæ¨¡å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿ä¸»æœº                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚å®¹å™¨Aâ”‚ â”‚å®¹å™¨Bâ”‚ â”‚ Filebeat    â”‚   â”‚
â”‚  â”‚æ—¥å¿— â”‚ â”‚æ—¥å¿— â”‚ â”‚ (ç³»ç»Ÿçº§æ”¶é›†) â”‚â†’ ELKâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ–¹å¼ä¸‰ï¼šä¸­å¿ƒåŒ–æ—¥å¿—ä»£ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å®¹å™¨åº”ç”¨ â”‚â†’   â”‚ æ—¥å¿—ä»£ç†     â”‚    â”‚
â”‚  â”‚ å‘é€æ—¥å¿— â”‚    â”‚ (å¦‚Fluentd)  â”‚â†’ ELKâ”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ³ Dockerå®¹å™¨æ—¥å¿—æ”¶é›†


### 2.1 Dockeræ—¥å¿—é©±åŠ¨æœºåˆ¶


**Dockerçš„æ—¥å¿—ç³»ç»Ÿ**å°±åƒæ˜¯æ¯ä¸ªå®¹å™¨çš„"æ—¥è®°æœ¬ç®¡ç†å‘˜"ï¼Œè´Ÿè´£æ”¶é›†å’Œç®¡ç†å®¹å™¨å†…éƒ¨äº§ç”Ÿçš„æ‰€æœ‰æ—¥å¿—ã€‚

**å¸¸è§æ—¥å¿—é©±åŠ¨**ï¼š

```yaml
# docker-compose.yml ä¸­çš„æ—¥å¿—é…ç½®
version: '3.8'
services:
  webapp:
    image: nginx:latest
    logging:
      driver: "json-file"          # é»˜è®¤é©±åŠ¨
      options:
        max-size: "10m"            # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§10MB
        max-file: "3"              # æœ€å¤šä¿ç•™3ä¸ªæ—¥å¿—æ–‡ä»¶
        labels: "service=nginx"    # æ·»åŠ æ ‡ç­¾ä¾¿äºè¯†åˆ«
```

### 2.2 Filebeatæ”¶é›†Dockeræ—¥å¿—


**æ–¹æ³•ä¸€ï¼šé€šè¿‡Docker Socketæ”¶é›†**

```yaml
# filebeat-docker.yml
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'    # Dockeré»˜è®¤æ—¥å¿—è·¯å¾„
  
  # å®¹å™¨ä¿¡æ¯è§£æ
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"     # Dockerå®ˆæŠ¤è¿›ç¨‹socket
      match_fields: ["container.id"]
  
  # è¿‡æ»¤ç‰¹å®šå®¹å™¨
  - drop_event:
      when:
        not:
          contains:
            container.image.name: "nginx"

output.elasticsearch:
  hosts: ["http://elasticsearch:9200"]
  index: "docker-logs-%{+yyyy.MM.dd}"
```

**è¿è¡ŒFilebeatå®¹å™¨**ï¼š

```bash
# ä½¿ç”¨Dockerè¿è¡ŒFilebeat
docker run -d \
  --name filebeat \
  --user root \
  --volume="$(pwd)/filebeat-docker.yml:/usr/share/filebeat/filebeat.yml:ro" \
  --volume="/var/lib/docker/containers:/var/lib/docker/containers:ro" \
  --volume="/var/run/docker.sock:/var/run/docker.sock:ro" \
  docker.elastic.co/beats/filebeat:8.11.0
```

**æ–¹æ³•äºŒï¼šSidecaræ¨¡å¼æ”¶é›†**

```yaml
# docker-compose.yml
version: '3.8'
services:
  # ä¸šåŠ¡åº”ç”¨
  webapp:
    image: myapp:latest
    volumes:
      - app-logs:/var/log/app        # å…±äº«æ—¥å¿—å·
  
  # Filebeat sidecar
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    volumes:
      - app-logs:/var/log/app:ro     # åªè¯»è®¿é—®æ—¥å¿—
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
    depends_on:
      - webapp

volumes:
  app-logs:
```

### 2.3 Dockeræ—¥å¿—æ ‡ç­¾ä¸è¿‡æ»¤


**ä½¿ç”¨æ ‡ç­¾è¯†åˆ«å®¹å™¨**ï¼š

```yaml
# filebeat.yml - åŸºäºæ ‡ç­¾çš„æ™ºèƒ½æ”¶é›†
filebeat.inputs:
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # åªæ”¶é›†å¸¦æœ‰ç‰¹å®šæ ‡ç­¾çš„å®¹å™¨æ—¥å¿—
  condition: >
    contains(labels.logging, "enabled") and
    contains(labels.env, "production")
  
  fields_under_root: true
  fields:
    datacenter: "beijing"
    environment: "prod"

processors:
- add_docker_metadata:
    host: "unix:///var/run/docker.sock"
- decode_json_fields:
    fields: ["message"]           # è§£æJSONæ ¼å¼çš„æ—¥å¿—æ¶ˆæ¯
    target: "json"
```

---

## 3. â˜¸ï¸ Kubernetes Podæ—¥å¿—æ”¶é›†


### 3.1 Kubernetesæ—¥å¿—æ¶æ„


**K8sæ—¥å¿—ç³»ç»Ÿ**å°±åƒæ˜¯ä¸€ä¸ª"æ™ºèƒ½ç‰©ä¸šç®¡ç†"ï¼Œè‡ªåŠ¨ç®¡ç†å¤§æ¥¼é‡Œæ¯ä¸ªæˆ¿é—´ï¼ˆPodï¼‰çš„æ—¥å¿—ã€‚

```
Kubernetes é›†ç¾¤æ—¥å¿—æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Node 1                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Pod A   â”‚  â”‚ Pod B   â”‚  â”‚ Pod C   â”‚ â”‚
â”‚  â”‚ å®¹å™¨1,2 â”‚  â”‚ å®¹å™¨1   â”‚  â”‚ å®¹å™¨1,2 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â†“         â†“         â†“        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Filebeat DaemonSet                  â”‚ â”‚
â”‚  â”‚ (æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªå®ä¾‹)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Elasticsearch Cluster   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 DaemonSetéƒ¨ç½²Filebeat


**ä»€ä¹ˆæ˜¯DaemonSet**ï¼šç¡®ä¿é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªFilebeatå®ä¾‹ï¼Œå°±åƒæ¯æ ‹æ¥¼éƒ½æœ‰ä¸€ä¸ªä¿å®‰ã€‚

```yaml
# filebeat-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
  namespace: kube-system
  labels:
    app: filebeat
spec:
  selector:
    matchLabels:
      app: filebeat
  template:
    metadata:
      labels:
        app: filebeat
    spec:
      # ç»™äºˆå¿…è¦æƒé™
      serviceAccountName: filebeat
      hostNetwork: true
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.11.0
        resources:
          limits:
            memory: "512Mi"
            cpu: "200m"
          requests:
            memory: "256Mi"
            cpu: "100m"
        
        # æŒ‚è½½é…ç½®æ–‡ä»¶
        volumeMounts:
        - name: config
          mountPath: /usr/share/filebeat/filebeat.yml
          subPath: filebeat.yml
        # æŒ‚è½½Podæ—¥å¿—ç›®å½•
        - name: varlog
          mountPath: /var/log
          readOnly: true
        # æŒ‚è½½å®¹å™¨æ—¥å¿—ç›®å½•
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
      
      volumes:
      - name: config
        configMap:
          name: filebeat-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

### 3.3 Kubernetesè‡ªåŠ¨å‘ç°é…ç½®


**autodiscoveråŠŸèƒ½**ï¼šè‡ªåŠ¨å‘ç°æ–°çš„Podå¹¶å¼€å§‹æ”¶é›†æ—¥å¿—ï¼Œå°±åƒæ™ºèƒ½é—¨ç¦ç³»ç»Ÿã€‚

```yaml
# filebeat-k8s.yml
filebeat.autodiscover:
  providers:
  - type: kubernetes
    node: ${NODE_NAME}               # å½“å‰èŠ‚ç‚¹åç§°
    hints.enabled: true              # å¯ç”¨hintsæ³¨è§£
    
    # æ¨¡æ¿é…ç½®ï¼šé’ˆå¯¹ä¸åŒç±»å‹çš„Podä½¿ç”¨ä¸åŒé…ç½®
    templates:
    - condition:
        contains:
          kubernetes.labels.app: "nginx"
      config:
      - type: container
        paths:
          - /var/log/containers/*${data.kubernetes.container.id}.log
        fields:
          service_type: "web"
          log_level: "info"
    
    - condition:
        contains:
          kubernetes.labels.app: "mysql"
      config:
      - type: container
        paths:
          - /var/log/containers/*${data.kubernetes.container.id}.log
        multiline.pattern: '^\d{4}-\d{2}-\d{2}'    # MySQLæ—¶é—´æˆ³æ ¼å¼
        multiline.negate: true
        multiline.match: after

processors:
- add_kubernetes_metadata:
    host: ${NODE_NAME}
    matchers:
    - logs_path:
        logs_path: "/var/log/containers/"
```

### 3.4 Podæ³¨è§£æ§åˆ¶æ—¥å¿—æ”¶é›†


**ä½¿ç”¨Kubernetesæ³¨è§£**æ§åˆ¶Filebeatè¡Œä¸ºï¼š

```yaml
# åº”ç”¨Podå®šä¹‰
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  annotations:
    # Filebeat hintsæ³¨è§£
    co.elastic.logs/enabled: "true"                    # å¯ç”¨æ—¥å¿—æ”¶é›†
    co.elastic.logs/multiline.pattern: '^ERROR'       # å¤šè¡Œæ—¥å¿—åŒ¹é…
    co.elastic.logs/exclude_lines: '^DEBUG'           # æ’é™¤DEBUGæ—¥å¿—
    co.elastic.logs/include_lines: '^(ERROR|WARN)'    # åªåŒ…å«é”™è¯¯å’Œè­¦å‘Š
    co.elastic.logs/json.keys_under_root: "true"      # JSONæ—¥å¿—è§£æ
    co.elastic.logs/fields: '{"environment":"prod","team":"backend"}'
spec:
  containers:
  - name: app
    image: myapp:v1.0
    env:
    - name: LOG_LEVEL
      value: "INFO"
```

---

## 4. ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„æ—¥å¿—ç­–ç•¥


### 4.1 å¾®æœåŠ¡æ—¥å¿—æŒ‘æˆ˜


**å¾®æœåŠ¡å°±åƒä¸€ä¸ªå¤§å·¥å‚**ï¼Œæœ‰å¾ˆå¤šè½¦é—´ï¼ˆæœåŠ¡ï¼‰ï¼Œæ¯ä¸ªè½¦é—´éƒ½åœ¨ç‹¬ç«‹å·¥ä½œï¼Œä½†éœ€è¦ç»Ÿä¸€çš„è´¨é‡ç›‘æ§ã€‚

**é¢ä¸´çš„é—®é¢˜**ï¼š

```
å¾®æœåŠ¡æ¶æ„æ—¥å¿—å¤æ‚æ€§ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ APIç½‘å…³ â†’ ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ åº“å­˜æœåŠ¡
    |         |         |         |         |         |
   æ—¥å¿—A     æ—¥å¿—B     æ—¥å¿—C     æ—¥å¿—D     æ—¥å¿—E     æ—¥å¿—F

é—®é¢˜ï¼š
1. åŒä¸€è¯·æ±‚æ•£è½åœ¨å¤šä¸ªæœåŠ¡çš„æ—¥å¿—ä¸­
2. æœåŠ¡é—´è°ƒç”¨é“¾è·¯éš¾ä»¥è¿½è¸ª
3. é”™è¯¯å®šä½éœ€è¦æŸ¥çœ‹å¤šä¸ªæ—¥å¿—æº
4. ä¸åŒæœåŠ¡çš„æ—¥å¿—æ ¼å¼å¯èƒ½ä¸ç»Ÿä¸€
```

### 4.2 ç»Ÿä¸€æ—¥å¿—æ ‡å‡†


**å»ºç«‹ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼**ï¼š

```yaml
# å¾®æœåŠ¡æ—¥å¿—æ ‡å‡†é…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*microservice*.log'
  
  # ç»Ÿä¸€å­—æ®µæ˜ å°„
  processors:
  - add_kubernetes_metadata: ~
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message) {
            try {
              var log = JSON.parse(message);
              // ç»Ÿä¸€å­—æ®µæ ‡å‡†
              event.Put("microservice.name", log.service || "unknown");
              event.Put("microservice.version", log.version || "");
              event.Put("microservice.trace_id", log.traceId || "");
              event.Put("microservice.span_id", log.spanId || "");
              event.Put("microservice.user_id", log.userId || "");
              event.Put("log.level", log.level || "INFO");
              event.Put("business.operation", log.operation || "");
            } catch (e) {
              // JSONè§£æå¤±è´¥ï¼Œä¿æŒåŸå§‹æ¶ˆæ¯
            }
          }
        }

# æ ¹æ®æœåŠ¡ç±»å‹è·¯ç”±åˆ°ä¸åŒç´¢å¼•
output.elasticsearch:
  hosts: ["http://elasticsearch:9200"]
  indices:
  - index: "microservice-api-%{+yyyy.MM.dd}"
    when.contains:
      kubernetes.labels.tier: "api"
  - index: "microservice-business-%{+yyyy.MM.dd}"
    when.contains:
      kubernetes.labels.tier: "business"
  - index: "microservice-data-%{+yyyy.MM.dd}"
    when.contains:
      kubernetes.labels.tier: "data"
```

### 4.3 æœåŠ¡åˆ†å±‚æ—¥å¿—ç­–ç•¥


**æŒ‰ç…§å¾®æœåŠ¡åˆ†å±‚**è¿›è¡Œæ—¥å¿—åˆ†ç±»ï¼š

```yaml
# ä¸åŒå±‚çº§çš„æ—¥å¿—é…ç½®
filebeat.autodiscover:
  providers:
  - type: kubernetes
    templates:
    
    # ç½‘å…³å±‚æ—¥å¿—ï¼ˆå…³æ³¨æµé‡å’Œè·¯ç”±ï¼‰
    - condition:
        equals:
          kubernetes.labels.tier: "gateway"
      config:
      - type: container
        fields:
          service_layer: "gateway"
          log_category: "access"
        include_lines: ['HTTP', 'REQUEST', 'RESPONSE']
    
    # ä¸šåŠ¡æœåŠ¡å±‚æ—¥å¿—ï¼ˆå…³æ³¨ä¸šåŠ¡é€»è¾‘ï¼‰
    - condition:
        equals:
          kubernetes.labels.tier: "business"
      config:
      - type: container
        fields:
          service_layer: "business"
          log_category: "application"
        exclude_lines: ['^DEBUG']     # ç”Ÿäº§ç¯å¢ƒæ’é™¤DEBUG
    
    # æ•°æ®å±‚æ—¥å¿—ï¼ˆå…³æ³¨æ•°æ®æ“ä½œï¼‰
    - condition:
        equals:
          kubernetes.labels.tier: "data"
      config:
      - type: container
        fields:
          service_layer: "data"
          log_category: "database"
        include_lines: ['ERROR', 'SLOW', 'TRANSACTION']
```

---

## 5. ğŸ” å®¹å™¨è‡ªåŠ¨å‘ç°æœºåˆ¶


### 5.5 Autodiscoverå·¥ä½œåŸç†


**è‡ªåŠ¨å‘ç°**å°±åƒæ˜¯ä¸€ä¸ª"æ™ºèƒ½ç®¡å®¶"ï¼Œå½“æœ‰æ–°çš„å®¹å™¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨ä¸ºå®ƒé…ç½®æ—¥å¿—æ”¶é›†è§„åˆ™ã€‚

```
Autodiscover å·¥ä½œæµç¨‹ï¼š

â”Œâ”€ ç¬¬1æ­¥ï¼šç›‘å¬å®¹å™¨äº‹ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Docker/K8s API                        â”‚
â”‚ â†“ å®¹å™¨å¯åŠ¨/åœæ­¢äº‹ä»¶                    â”‚
â”‚ Filebeat Autodiscover Provider        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€ ç¬¬2æ­¥ï¼šåŒ¹é…æ¨¡æ¿æ¡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥å®¹å™¨æ ‡ç­¾ã€é•œåƒåã€å‘½åç©ºé—´ç­‰         â”‚
â”‚ æ˜¯å¦åŒ¹é…é¢„å®šä¹‰çš„æ¨¡æ¿æ¡ä»¶               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€ ç¬¬3æ­¥ï¼šç”Ÿæˆé‡‡é›†é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸºäºæ¨¡æ¿ç”Ÿæˆå…·ä½“çš„inputé…ç½®             â”‚
â”‚ åŒ…æ‹¬è·¯å¾„ã€å¤„ç†å™¨ã€å­—æ®µç­‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€ ç¬¬4æ­¥ï¼šå¯åŠ¨æ—¥å¿—æ”¶é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºharvesterå¼€å§‹æ”¶é›†æ—¥å¿—              â”‚
â”‚ åº”ç”¨å¤„ç†å™¨å’Œè·¯ç”±è§„åˆ™                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Docker Provideré…ç½®


```yaml
# Dockerç¯å¢ƒçš„è‡ªåŠ¨å‘ç°
filebeat.autodiscover:
  providers:
  - type: docker
    templates:
    
    # Webåº”ç”¨æ¨¡æ¿
    - condition:
        or:
        - contains:
            docker.container.image: "nginx"
        - contains:
            docker.container.image: "apache"
      config:
      - type: container
        paths:
          - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
        processors:
        - add_docker_metadata: ~
        - dissect:
            tokenizer: '%{timestamp} %{log_level} %{message}'
            field: "message"
        fields:
          service_type: "web_server"
          log_format: "standard"
    
    # æ•°æ®åº“æ¨¡æ¿  
    - condition:
        or:
        - contains:
            docker.container.image: "mysql"
        - contains:
            docker.container.image: "postgres"
      config:
      - type: container
        paths:
          - "/var/lib/docker/containers/${data.docker.container.id}/*.log"
        multiline.pattern: '^\d{4}-\d{2}-\d{2}'
        multiline.negate: true
        multiline.match: after
        fields:
          service_type: "database"
          log_format: "multiline"
```

### 5.3 Kubernetes Provideré«˜çº§é…ç½®


```yaml
# K8sç¯å¢ƒçš„æ™ºèƒ½å‘ç°
filebeat.autodiscover:
  providers:
  - type: kubernetes
    node: ${NODE_NAME}
    
    # åŸºäºå‘½åç©ºé—´çš„ç­–ç•¥
    namespace: "production"           # åªç›‘æ§ç”Ÿäº§å‘½åç©ºé—´
    
    # èµ„æºç±»å‹è¿‡æ»¤
    resource: "pod"                   # åªç›‘æ§Podèµ„æº
    
    # é«˜çº§æ¨¡æ¿åŒ¹é…
    templates:
    - condition:
        and:
        - equals:
            kubernetes.namespace: "production"
        - regexp:
            kubernetes.labels.app: ".*-service$"    # åŒ¹é…æœåŠ¡ç±»åº”ç”¨
        - not:
            equals:
              kubernetes.labels.logging: "disabled"  # æ’é™¤ç¦ç”¨æ—¥å¿—çš„Pod
      config:
      - type: container
        paths:
          - /var/log/containers/*${data.kubernetes.container.id}.log
        
        # åŸºäºæ ‡ç­¾çš„åŠ¨æ€å­—æ®µ
        fields:
          business_unit: "${data.kubernetes.labels.business-unit}"
          cost_center: "${data.kubernetes.labels.cost-center}"
          owner_team: "${data.kubernetes.labels.team}"
        
        # æ¡ä»¶å¤„ç†å™¨
        processors:
        - if:
            equals:
              kubernetes.labels.log-level: "debug"
          then:
          - include_fields:
              fields: ["@timestamp", "message", "kubernetes"]
        - else:
          - drop_fields:
              fields: ["kubernetes.pod.uid", "kubernetes.pod.ip"]
```

---

## 6. ğŸ›ï¸ å¤šå®¹å™¨ç¯å¢ƒç»Ÿä¸€ç®¡ç†


### 6.1 æ··åˆç¯å¢ƒæ¶æ„


**ç°å®æƒ…å†µ**ï¼šå¾ˆå¤šå…¬å¸éƒ½æ˜¯æ··åˆç¯å¢ƒï¼Œå°±åƒä¸€ä¸ªå›­åŒºé‡Œæ—¢æœ‰é«˜æ¥¼å¤§å¦ï¼ˆK8sé›†ç¾¤ï¼‰ä¹Ÿæœ‰ç‹¬æ ‹åˆ«å¢…ï¼ˆç‹¬ç«‹Dockerï¼‰ã€‚

```
æ··åˆå®¹å™¨ç¯å¢ƒæ¶æ„ï¼š

â”Œâ”€ Kubernetes é›†ç¾¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Namespaceâ”‚ â”‚Namespaceâ”‚ â”‚Namespaceâ”‚   â”‚
â”‚  â”‚  Prod   â”‚ â”‚  Test   â”‚ â”‚  Dev    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          Filebeat DaemonSet             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ç»Ÿä¸€æ—¥å¿—æ”¶é›†ä¸­å¿ƒ        â”‚
        â”‚   (Elasticsearch)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
â”Œâ”€ ç‹¬ç«‹ Docker ä¸»æœº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ é—ç•™åº”ç”¨ â”‚ â”‚ æµ‹è¯•ç¯å¢ƒ â”‚ â”‚ å·¥å…·æœåŠ¡ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          ç‹¬ç«‹ Filebeat                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç»Ÿä¸€é…ç½®ç®¡ç†


**ä½¿ç”¨é…ç½®ä¸­å¿ƒ**ç»Ÿä¸€ç®¡ç†æ‰€æœ‰Filebeaté…ç½®ï¼š

```yaml
# åŸºç¡€é…ç½®æ¨¡æ¿ï¼ˆæ‰€æœ‰ç¯å¢ƒå…±äº«ï¼‰
# filebeat-base.yml
filebeat.config:
  inputs:
    enabled: true
    path: /etc/filebeat/inputs.d/*.yml
    reload.enabled: true
    reload.period: 30s

processors:
- add_host_metadata:
    when.not.contains.tags: forwarded
- add_kubernetes_metadata:
    when.not.contains.tags: forwarded
- add_docker_metadata:
    when.not.contains.tags: forwarded

# å…¨å±€å­—æ®µï¼ˆæ ‡è¯†ç¯å¢ƒæ¥æºï¼‰
fields:
  datacenter: "${DATACENTER:unknown}"
  environment: "${ENVIRONMENT:dev}"
  cluster_type: "${CLUSTER_TYPE:standalone}"
fields_under_root: true

# ç»Ÿä¸€è¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS}"]
  username: "${ELASTICSEARCH_USERNAME}"
  password: "${ELASTICSEARCH_PASSWORD}"
  
  # æ ¹æ®ç¯å¢ƒè·¯ç”±ç´¢å¼•
  indices:
  - index: "logs-k8s-prod-%{+yyyy.MM.dd}"
    when.and:
    - equals.environment: "production"
    - exists: kubernetes.namespace
  
  - index: "logs-docker-prod-%{+yyyy.MM.dd}"
    when.and:
    - equals.environment: "production"
    - not.exists: kubernetes.namespace
  
  - index: "logs-dev-%{+yyyy.MM.dd}"
    when.equals.environment: "development"

# æ—¥å¿—è½®è½¬å’Œç”Ÿå‘½å‘¨æœŸ
setup.ilm:
  enabled: true
  policy: "logs-policy"
  pattern: "logs-*"
```

### 6.3 ç¯å¢ƒæ ‡è¯†å’Œè·¯ç”±


**ä¸åŒç¯å¢ƒçš„æ ‡è¯†ç­–ç•¥**ï¼š

```yaml
# Kubernetesç¯å¢ƒé…ç½®
# k8s-inputs.yml
- type: container
  paths:
    - /var/log/containers/*.log
  
  processors:
  - add_kubernetes_metadata: ~
  - script:
      lang: javascript
      source: >
        function process(event) {
          // ä»K8sæ ‡ç­¾ä¸­æå–ç¯å¢ƒä¿¡æ¯
          var labels = event.Get("kubernetes.labels");
          if (labels) {
            event.Put("environment", labels.environment || "unknown");
            event.Put("service_name", labels.app || "unknown");
            event.Put("service_version", labels.version || "unknown");
            event.Put("deployment_type", "kubernetes");
          }
        }

---
# Dockerç‹¬ç«‹ç¯å¢ƒé…ç½®  
# docker-inputs.yml
- type: container
  paths:
    - /var/lib/docker/containers/*/*.log
  
  processors:
  - add_docker_metadata: ~
  - script:
      lang: javascript
      source: >
        function process(event) {
          // ä»Dockeræ ‡ç­¾ä¸­æå–ç¯å¢ƒä¿¡æ¯
          var labels = event.Get("docker.container.labels");
          if (labels) {
            event.Put("environment", labels.environment || "standalone");
            event.Put("service_name", labels.service || "unknown");
            event.Put("deployment_type", "docker");
          }
        }
```

---

## 7. ğŸ”— ELKé›†ç¾¤å¯¹æ¥å®æˆ˜


### 7.1 ELKé›†ç¾¤æ¶æ„è®¾è®¡


**ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤**ï¼šå•æœºå°±åƒä¸€ä¸ªäººå¹²æ´»ï¼Œé›†ç¾¤å°±åƒä¸€ä¸ªå›¢é˜Ÿï¼Œèƒ½å¤„ç†æ›´å¤šæ—¥å¿—ï¼Œä¹Ÿæ›´ç¨³å®šã€‚

```
ç”Ÿäº§çº§ ELK é›†ç¾¤æ¶æ„ï¼š

â”Œâ”€ Filebeat é‡‡é›†å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚K8s Node1â”‚ â”‚K8s Node2â”‚ â”‚Docker Host  â”‚   â”‚
â”‚ â”‚Filebeat â”‚ â”‚Filebeat â”‚ â”‚Filebeat     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æ—¥å¿—æ•°æ®æµ
                  â†“
â”Œâ”€ Logstash å¤„ç†å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Logstash 1  â”‚ â”‚ Logstash 2  â”‚           â”‚
â”‚ â”‚ æ•°æ®æ¸…æ´—     â”‚ â”‚ æ•°æ®æ¸…æ´—     â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤„ç†åæ•°æ®
                  â†“
â”Œâ”€ Elasticsearch å­˜å‚¨å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Master  â”‚ â”‚ Data 1  â”‚ â”‚ Data 2      â”‚   â”‚
â”‚ â”‚ Node    â”‚ â”‚ Node    â”‚ â”‚ Node        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æŸ¥è¯¢æ¥å£
                  â†“
â”Œâ”€ Kibana å¯è§†åŒ–å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ Kibana 1    â”‚ â”‚ Kibana 2    â”‚           â”‚
â”‚ â”‚ ä¸»å®ä¾‹       â”‚ â”‚ å¤‡ç”¨å®ä¾‹     â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è´Ÿè½½å‡è¡¡é…ç½®


**é…ç½®Filebeatè¿æ¥å¤šä¸ªElasticsearchèŠ‚ç‚¹**ï¼š

```yaml
# filebeat-cluster.yml
output.elasticsearch:
  # å¤šèŠ‚ç‚¹è´Ÿè½½å‡è¡¡
  hosts: 
    - "https://es-node1.company.com:9200"
    - "https://es-node2.company.com:9200" 
    - "https://es-node3.company.com:9200"
  
  # è´Ÿè½½å‡è¡¡ç­–ç•¥
  loadbalance: true
  worker: 2                           # å¹¶å‘å·¥ä½œçº¿ç¨‹
  bulk_max_size: 3200                 # æ‰¹é‡å‘é€å¤§å°
  
  # è¿æ¥æ± é…ç½®
  max_retries: 3
  backoff.init: 1s
  backoff.max: 60s
  timeout: 90s
  
  # SSL/TLSé…ç½®
  protocol: "https"
  ssl.certificate_authorities: ["/etc/filebeat/ca.crt"]
  ssl.certificate: "/etc/filebeat/client.crt"
  ssl.key: "/etc/filebeat/client.key"
  
  # è®¤è¯é…ç½®
  username: "filebeat_writer"
  password: "${ELASTICSEARCH_PASSWORD}"
  
  # ç´¢å¼•ç­–ç•¥
  index: "logs-%{[fields.environment]}-%{+yyyy.MM.dd}"
  
  # æ¨¡æ¿ç®¡ç†
  template.enabled: true
  template.pattern: "logs-*"
  template.settings:
    index:
      number_of_shards: 3
      number_of_replicas: 1
      refresh_interval: 5s
```

### 7.3 é›†ç¾¤å¥åº·ç›‘æ§


**ç›‘æ§Filebeatä¸ELKé›†ç¾¤çš„è¿æ¥çŠ¶æ€**ï¼š

```yaml
# ç›‘æ§é…ç½®
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["${ELASTICSEARCH_MONITORING_HOSTS}"]
    username: "monitoring_user"
    password: "${MONITORING_PASSWORD}"
  
  # ç›‘æ§æŒ‡æ ‡æ”¶é›†
  cluster_uuid: "${ELASTICSEARCH_CLUSTER_UUID}"

# æ—¥å¿—è¾“å‡ºé…ç½®
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat.log
  keepfiles: 7
  permissions: 0644

# å¥åº·æ£€æŸ¥é…ç½®
http.enabled: true
http.host: "0.0.0.0"
http.port: 5066

# æŒ‡æ ‡è¾“å‡º
filebeat.config.monitors:
  path: ${path.config}/monitors.d/*.yml
  reload.enabled: false
```

---

## 8. ğŸ” æœåŠ¡é“¾è·¯è¿½è¸ªé›†æˆ


### 8.1 åˆ†å¸ƒå¼è¿½è¸ªæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª**ï¼šå°±åƒç»™æ¯ä¸ªå¿«é€’åŒ…è£¹ä¸€ä¸ªå”¯ä¸€ç¼–å·ï¼Œè¿½è¸ªå®ƒåœ¨æ•´ä¸ªé…é€è¿‡ç¨‹ä¸­çš„è½¨è¿¹ã€‚

```
å¾®æœåŠ¡è°ƒç”¨é“¾è·¯ç¤ºä¾‹ï¼š

ç”¨æˆ·è¯·æ±‚ [trace_id: abc123]
    â†“
APIç½‘å…³ [span_id: span001] â†’ è®°å½•ï¼šæ¥æ”¶è¯·æ±‚
    â†“
ç”¨æˆ·æœåŠ¡ [span_id: span002] â†’ è®°å½•ï¼šéªŒè¯ç”¨æˆ·
    â†“
è®¢å•æœåŠ¡ [span_id: span003] â†’ è®°å½•ï¼šåˆ›å»ºè®¢å•
    â†“  
æ”¯ä»˜æœåŠ¡ [span_id: span004] â†’ è®°å½•ï¼šå¤„ç†æ”¯ä»˜
    â†“
åº“å­˜æœåŠ¡ [span_id: span005] â†’ è®°å½•ï¼šæ‰£å‡åº“å­˜

æ‰€æœ‰æ—¥å¿—éƒ½åŒ…å«ç›¸åŒçš„ trace_idï¼Œå¯ä»¥ä¸²è”æˆå®Œæ•´é“¾è·¯
```

### 8.2 æ—¥å¿—ä¸­é›†æˆè¿½è¸ªä¿¡æ¯


**åœ¨æ—¥å¿—ä¸­æ·»åŠ è¿½è¸ªæ ‡è¯†**ï¼š

```yaml
# filebeat-tracing.yml
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*service*.log'
  
  processors:
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message) {
            try {
              var log = JSON.parse(message);
              
              // æå–è¿½è¸ªä¿¡æ¯
              if (log.traceId) {
                event.Put("trace.id", log.traceId);
              }
              if (log.spanId) {
                event.Put("trace.span.id", log.spanId);
              }
              if (log.parentSpanId) {
                event.Put("trace.parent.id", log.parentSpanId);
              }
              
              // æå–ä¸šåŠ¡ä¿¡æ¯
              if (log.userId) {
                event.Put("user.id", log.userId);
              }
              if (log.operation) {
                event.Put("business.operation", log.operation);
              }
              
            } catch (e) {
              // JSONè§£æå¤±è´¥ï¼Œå°è¯•æ­£åˆ™æå–
              var traceMatch = message.match(/trace_id=([a-zA-Z0-9]+)/);
              if (traceMatch) {
                event.Put("trace.id", traceMatch[1]);
              }
            }
          }
        }

# æ ¹æ®æœåŠ¡ç±»å‹æ·»åŠ æ ‡ç­¾
- add_labels:
    labels:
      service.name: "${kubernetes.labels.app}"
      service.version: "${kubernetes.labels.version}"
      service.environment: "${kubernetes.labels.environment}"
```

### 8.3 APMé›†æˆé…ç½®


**ä¸Elastic APMé›†æˆ**ï¼š

```yaml
# åº”ç”¨æ€§èƒ½ç›‘æ§é›†æˆ
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*-service-*.log'
  
  fields:
    service.name: "${kubernetes.labels.app}"
    service.version: "${kubernetes.labels.version}"
  fields_under_root: true
  
  processors:
  # APMæ—¥å¿—å…³è”
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          
          // æ£€æµ‹é”™è¯¯å †æ ˆ
          if (message && message.includes("Exception")) {
            event.Put("error.stack_trace", message);
            event.Put("error.type", "application_error");
            
            // æå–é”™è¯¯ç±»å‹
            var errorMatch = message.match(/([a-zA-Z.]+Exception)/);
            if (errorMatch) {
              event.Put("error.exception.type", errorMatch[1]);
            }
          }
          
          // æ£€æµ‹æ€§èƒ½æŒ‡æ ‡
          var perfMatch = message.match(/duration=(\d+)ms/);
          if (perfMatch) {
            event.Put("transaction.duration.ms", parseInt(perfMatch[1]));
          }
        }

# è¾“å‡ºåˆ°APMä¸“ç”¨ç´¢å¼•
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS}"]
  indices:
  - index: "apm-logs-%{+yyyy.MM.dd}"
    when.or:
    - exists: "trace.id"
    - exists: "error.stack_trace"
  - index: "app-logs-%{+yyyy.MM.dd}"
    when.not.or:
    - exists: "trace.id"
    - exists: "error.stack_trace"
```

---

## 9. ğŸ­ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


### 9.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ç”Ÿäº§ç¯å¢ƒ**å°±åƒæ˜¯é«˜é€Ÿå…¬è·¯ï¼Œéœ€è¦è€ƒè™‘æµé‡ã€ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚

```yaml
# ç”Ÿäº§çº§æ€§èƒ½é…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*.log'
  
  # ä¼˜åŒ–æ–‡ä»¶è¯»å–
  scan_frequency: 1s                    # æ‰«æé¢‘ç‡ï¼šå¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½
  harvester_buffer_size: 16384          # è¯»å–ç¼“å†²åŒºï¼š16KB
  max_bytes: 10485760                   # å•æ¡æ—¥å¿—æœ€å¤§10MB
  
  # é¿å…é‡å¤å¤„ç†
  ignore_older: 24h                     # å¿½ç•¥24å°æ—¶å‰çš„æ–‡ä»¶
  close_inactive: 5m                    # 5åˆ†é’Ÿæ— æ´»åŠ¨å…³é—­æ–‡ä»¶å¥æŸ„
  close_removed: true                   # æ–‡ä»¶åˆ é™¤æ—¶å…³é—­å¥æŸ„
  close_eof: true                       # è¯»åˆ°æ–‡ä»¶æœ«å°¾æ—¶å…³é—­

# è¾“å‡ºæ€§èƒ½ä¼˜åŒ–
output.elasticsearch:
  hosts: ["${ELASTICSEARCH_HOSTS}"]
  
  # æ‰¹é‡å‘é€ä¼˜åŒ–
  bulk_max_size: 1600                   # æ‰¹é‡å¤§å°ï¼šå¹³è¡¡å»¶è¿Ÿå’Œåå
  flush_interval: 1s                    # åˆ·æ–°é—´éš”
  worker: 4                             # å¹¶å‘å·¥ä½œçº¿ç¨‹
  
  # è¿æ¥ä¼˜åŒ–
  max_retries: 3
  timeout: 90s
  compression_level: 1                  # å‹ç¼©çº§åˆ«ï¼šå¹³è¡¡CPUå’Œç½‘ç»œ

# é˜Ÿåˆ—é…ç½®
queue.mem:
  events: 4096                          # å†…å­˜é˜Ÿåˆ—å¤§å°
  flush.min_events: 512                 # æœ€å°åˆ·æ–°äº‹ä»¶æ•°
  flush.timeout: 1s                     # åˆ·æ–°è¶…æ—¶

# èµ„æºé™åˆ¶
max_procs: 2                            # æœ€å¤§CPUæ ¸å¿ƒæ•°
```

### 9.2 ç›‘æ§å‘Šè­¦é…ç½®


**ç›‘æ§Filebeatè‡ªèº«çŠ¶æ€**ï¼š

```yaml
# ç›‘æ§é…ç½®
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["${MONITORING_ELASTICSEARCH_HOSTS}"]
  
# æ—¥å¿—è®°å½•
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat.log
  rotateeverybytes: 10485760            # 10MBè½®è½¬
  keepfiles: 5

# HTTPç«¯ç‚¹æš´éœ²æŒ‡æ ‡
http.enabled: true
http.host: "0.0.0.0"
http.port: 5066
http.pprof.enabled: true                # æ€§èƒ½åˆ†æ

# è‡ªå®šä¹‰æŒ‡æ ‡
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: true
  reload.period: 10s
```

**Prometheusç›‘æ§é›†æˆ**ï¼š

```yaml
# prometheus-config.yml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    
    scrape_configs:
    - job_name: 'filebeat'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: filebeat
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: '${1}:5066'
      
      # æ”¶é›†çš„æŒ‡æ ‡
      metrics_path: /stats
      scrape_interval: 30s
```

### 9.3 å®‰å…¨é…ç½®


```yaml
# å®‰å…¨åŠ å›ºé…ç½®
filebeat.inputs:
- type: container
  paths:
    - '/var/log/containers/*.log'
  
  # æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
  processors:
  - dissect:
      tokenizer: '%{timestamp} %{level} %{message}'
      field: "message"
  
  # è„±æ•å¤„ç†
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message) {
            // è„±æ•æ‰‹æœºå·
            message = message.replace(/1[3-9]\d{9}/g, "1****masked");
            // è„±æ•èº«ä»½è¯
            message = message.replace(/\d{17}[\dX]/g, "****masked****");
            // è„±æ•é‚®ç®±
            message = message.replace(/\w+@\w+\.\w+/g, "****@masked.com");
            event.Put("message", message);
          }
        }

# SSL/TLSé…ç½®
output.elasticsearch:
  hosts: ["https://es-cluster.company.com:9200"]
  
  # è¯ä¹¦é…ç½®
  ssl.certificate_authorities: ["/etc/ssl/ca.pem"]
  ssl.certificate: "/etc/ssl/filebeat.pem"
  ssl.key: "/etc/ssl/filebeat-key.pem"
  ssl.verification_mode: "strict"
  
  # è®¤è¯é…ç½®
  username: "filebeat_user"
  password: "${FILEBEAT_PASSWORD}"

# ç½‘ç»œå®‰å…¨
setup.kibana:
  host: "https://kibana.company.com:5601"
  ssl.enabled: true
  ssl.certificate_authorities: ["/etc/ssl/ca.pem"]
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨æ—¥å¿—ç‰¹æ®Šæ€§ï¼šåŠ¨æ€æ€§ã€çŸ­æš‚æ€§ã€åˆ†å¸ƒæ€§
ğŸ”¸ æ”¶é›†ç­–ç•¥ï¼šSidecaræ¨¡å¼ vs DaemonSetæ¨¡å¼ vs ä¸­å¿ƒåŒ–ä»£ç†
ğŸ”¸ è‡ªåŠ¨å‘ç°ï¼šDocker Provider vs Kubernetes Provider
ğŸ”¸ å¾®æœåŠ¡æŒ‘æˆ˜ï¼šæœåŠ¡åˆ†æ•£ã€è°ƒç”¨é“¾å¤æ‚ã€æ ¼å¼ä¸ç»Ÿä¸€
ğŸ”¸ é“¾è·¯è¿½è¸ªï¼štrace_idå…³è”åˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯
ğŸ”¸ é›†ç¾¤å¯¹æ¥ï¼šè´Ÿè½½å‡è¡¡ã€å®¹é”™ã€æ€§èƒ½ä¼˜åŒ–
```

### 10.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ Dockerç¯å¢ƒæœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨`container` inputç±»å‹è€Œé`log` input
- é€šè¿‡Docker socketè·å–å®¹å™¨å…ƒæ•°æ®
- åˆç†é…ç½®æ—¥å¿—é©±åŠ¨å’Œè½®è½¬ç­–ç•¥
- ä½¿ç”¨æ ‡ç­¾è¿›è¡Œå®¹å™¨åˆ†ç±»å’Œè¿‡æ»¤

**ğŸ”¹ Kubernetesç¯å¢ƒè¦ç‚¹**ï¼š
- DaemonSetç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰Filebeat
- åˆ©ç”¨autodiscoverè‡ªåŠ¨å‘ç°æ–°Pod
- é€šè¿‡æ³¨è§£æ§åˆ¶æ—¥å¿—æ”¶é›†è¡Œä¸º
- åŸºäºå‘½åç©ºé—´å’Œæ ‡ç­¾è¿›è¡Œè·¯ç”±

**ğŸ”¹ å¾®æœåŠ¡æ¶æ„ç­–ç•¥**ï¼š
- å»ºç«‹ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼æ ‡å‡†
- æŒ‰æœåŠ¡å±‚çº§åˆ†ç±»æ”¶é›†å’Œå­˜å‚¨
- é›†æˆåˆ†å¸ƒå¼è¿½è¸ªä¿¡æ¯
- å®ç°æœåŠ¡è°ƒç”¨é“¾è·¯è¿˜åŸ

### 10.3 ç”Ÿäº§ç¯å¢ƒå…³é”®é…ç½®


**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
æ‰¹é‡å‘é€ï¼šbulk_max_size = 1600
å¹¶å‘å¤„ç†ï¼šworker = 4
ç¼“å†²ä¼˜åŒ–ï¼šharvester_buffer_size = 16KB
é˜Ÿåˆ—é…ç½®ï¼šqueue.mem.events = 4096
èµ„æºé™åˆ¶ï¼šåˆç†è®¾ç½®CPUå’Œå†…å­˜é™åˆ¶
```

**ğŸ”’ å®‰å…¨é…ç½®è¦ç‚¹**ï¼š
```
SSL/TLSï¼šå¯ç”¨ä¼ è¾“åŠ å¯†
è®¤è¯æˆæƒï¼šä½¿ç”¨ä¸“ç”¨ç”¨æˆ·å’Œæƒé™
æ•æ„Ÿä¿¡æ¯ï¼šæ—¥å¿—è„±æ•å¤„ç†
ç½‘ç»œéš”ç¦»ï¼šé™åˆ¶ç½‘ç»œè®¿é—®èŒƒå›´
```

**ğŸ“Š ç›‘æ§å‘Šè­¦è¦ç‚¹**ï¼š
```
æŒ‡æ ‡ç›‘æ§ï¼šFilebeatè‡ªèº«æ€§èƒ½æŒ‡æ ‡
æ—¥å¿—ç›‘æ§ï¼šæ”¶é›†é”™è¯¯å’Œå¼‚å¸¸æ—¥å¿—
å¥åº·æ£€æŸ¥ï¼šHTTPç«¯ç‚¹çŠ¶æ€æ£€æŸ¥
å‘Šè­¦è§„åˆ™ï¼šåŸºäºå…³é”®æŒ‡æ ‡è®¾ç½®å‘Šè­¦
```

### 10.4 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç¯å¢ƒé€‰æ‹©ç­–ç•¥**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ç®€å•çš„Docker compose + Filebeat
- **æµ‹è¯•ç¯å¢ƒ**ï¼šæ¨¡æ‹Ÿç”Ÿäº§çš„K8s + DaemonSetæ–¹å¼
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå®Œæ•´çš„ELKé›†ç¾¤ + å¤šé‡ä¿éšœ

**ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯**ï¼š
1. **è¿æ¥é—®é¢˜**ï¼šæ£€æŸ¥ç½‘ç»œã€è®¤è¯ã€SSLé…ç½®
2. **æ€§èƒ½é—®é¢˜**ï¼šæŸ¥çœ‹æ‰¹é‡å¤§å°ã€å¹¶å‘æ•°ã€é˜Ÿåˆ—é…ç½®
3. **æ•°æ®é—®é¢˜**ï¼šéªŒè¯å¤„ç†å™¨ã€è¿‡æ»¤å™¨ã€å­—æ®µæ˜ å°„
4. **å‘ç°é—®é¢˜**ï¼šæ£€æŸ¥autodiscoveré…ç½®å’Œå®¹å™¨æ ‡ç­¾

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®¹å™¨æ—¥å¿—æ”¶é›†é‡åœ¨è‡ªåŠ¨åŒ–å’Œæ ‡å‡†åŒ–
- å¾®æœåŠ¡ç¯å¢ƒéœ€è¦ç»Ÿä¸€æ ¼å¼å’Œé“¾è·¯è¿½è¸ª
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘æ€§èƒ½ã€å®‰å…¨å’Œç›‘æ§
- é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ¨¡å¼å’Œé…ç½®ç­–ç•¥