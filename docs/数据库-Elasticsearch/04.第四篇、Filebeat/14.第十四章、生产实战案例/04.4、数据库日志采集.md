---
title: 4、数据库日志采集
---
## 📚 目录

1. [数据库日志采集概述](#1-数据库日志采集概述)
2. [MySQL日志采集实战](#2-MySQL日志采集实战)
3. [PostgreSQL日志处理](#3-PostgreSQL日志处理)
4. [Redis日志监控](#4-Redis日志监控)
5. [数据库性能监控策略](#5-数据库性能监控策略)
6. [生产环境最佳实践](#6-生产环境最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🗄️ 数据库日志采集概述


### 1.1 为什么要采集数据库日志


> 💡 **核心价值**：数据库日志就像医生给病人做体检一样，能帮我们发现数据库运行中的问题

**数据库日志的重要作用**：
- 🔍 **性能分析**：找出哪些SQL查询拖慢了系统
- 🚨 **故障排查**：快速定位数据库出错的原因
- 📊 **运维监控**：实时了解数据库健康状况
- 🔒 **安全审计**：记录谁在什么时候操作了数据库

### 1.2 数据库日志的主要类型


```
数据库日志分类图：

┌─────────────────┐
│    数据库日志    │
└─────┬───────────┘
      │
  ┌───┴───┬────────┬──────────┐
  │       │        │          │
错误日志  慢查询日志  访问日志   二进制日志
  │       │        │          │
系统故障  性能问题   用户行为   数据恢复
```

**各类日志的简单理解**：
- 🔸 **错误日志**：记录数据库启动、关闭和运行错误
- 🔸 **慢查询日志**：记录执行时间超过设定值的SQL语句
- 🔸 **访问日志**：记录所有连接和查询操作
- 🔸 **二进制日志**：记录数据变更，用于备份恢复

### 1.3 Filebeat采集数据库日志的优势


**为什么选择Filebeat**：

| 传统方式 | Filebeat方式 | 优势说明 |
|---------|-------------|----------|
| 手动查看日志文件 | 自动实时采集 | **省人工**，24小时监控 |
| 日志分散存储 | 统一收集管理 | **好管理**，一个地方看全部 |
| 简单文本格式 | 结构化解析 | **好分析**，能做复杂查询 |
| 本地存储限制 | 弹性扩展 | **能存更多**，不怕日志太大 |

---

## 2. 🐬 MySQL日志采集实战


### 2.1 MySQL慢查询日志概念


> 💡 **什么是慢查询日志**：就像路上的测速摄像头，专门抓那些"开车太慢"的SQL语句

**慢查询日志的作用**：
- 🎯 找出执行时间过长的SQL语句
- 📈 分析数据库性能瓶颈
- 🔧 为SQL优化提供依据

### 2.2 启用MySQL慢查询日志


**第一步：检查当前配置**
```sql
-- 查看慢查询日志是否开启
SHOW VARIABLES LIKE 'slow_query_log%';
-- 查看慢查询时间阈值
SHOW VARIABLES LIKE 'long_query_time';
```

**第二步：修改MySQL配置文件**
```ini
# 在 /etc/mysql/my.cnf 或 /etc/my.cnf 中添加
[mysqld]
# 开启慢查询日志
slow_query_log = 1
# 指定日志文件位置
slow_query_log_file = /var/log/mysql/mysql-slow.log
# 设置慢查询时间阈值（秒）
long_query_time = 2
# 记录没有使用索引的查询
log_queries_not_using_indexes = 1
```

> ⚠️ **重要提醒**：修改配置后需要重启MySQL服务才能生效

### 2.3 使用Filebeat的MySQL模块


**什么是模块**：可以理解为Filebeat为MySQL专门准备的"傻瓜式"配置包，开箱即用。

**启用MySQL模块**：
```bash
# 启用mysql模块
sudo filebeat modules enable mysql

# 查看已启用的模块
sudo filebeat modules list
```

**配置MySQL模块**：
```yaml
# /etc/filebeat/modules.d/mysql.yml
- module: mysql
  # 错误日志
  error:
    enabled: true
    var.paths: ["/var/log/mysql/error.log"]
  
  # 慢查询日志  
  slowlog:
    enabled: true
    var.paths: ["/var/log/mysql/mysql-slow.log"]
```

### 2.4 自定义MySQL日志采集配置


> 💡 **什么时候用自定义配置**：当默认模块不满足需求时，比如需要添加特殊字段或过滤规则

```yaml
# filebeat.yml 完整配置示例
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/mysql/mysql-slow.log
  
  # 多行日志处理（慢查询日志通常是多行的）
  multiline.pattern: '^# Time:'
  multiline.negate: true
  multiline.match: after
  
  # 添加自定义字段
  fields:
    log_type: mysql_slow
    environment: production
    server_role: database
  fields_under_root: true
  
  # 处理器配置
  processors:
    - add_host_metadata:
        when.not.contains.tags: forwarded

# 输出配置
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "mysql-logs-%{+yyyy.MM.dd}"
```

### 2.5 MySQL慢查询日志格式解析


**典型的慢查询日志内容**：
```
# Time: 2024-09-21T10:15:30.123456Z
# User@Host: webapp[webapp] @ [192.168.1.100]
# Query_time: 3.000000  Lock_time: 0.000000  Rows_sent: 1000  Rows_examined: 50000
# Rows_affected: 0
SET timestamp=1695287730;
SELECT * FROM users WHERE created_at > '2024-01-01' ORDER BY id DESC LIMIT 1000;
```

**字段含义解释**：
- 🔸 **Query_time**: SQL执行时间（3秒）
- 🔸 **Lock_time**: 等待锁的时间
- 🔸 **Rows_sent**: 返回给客户端的行数
- 🔸 **Rows_examined**: 数据库扫描的行数

> 📊 **性能分析要点**：当`Rows_examined`远大于`Rows_sent`时，说明查询效率低，需要优化

---

## 3. 🐘 PostgreSQL日志处理


### 3.1 PostgreSQL日志配置


**启用详细日志记录**：
```ini
# 在 postgresql.conf 中配置
log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# 记录慢查询
log_min_duration_statement = 1000  # 记录超过1秒的查询
log_statement = 'all'              # 记录所有SQL语句
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d '
```

### 3.2 使用PostgreSQL模块


```yaml
# 启用postgresql模块
- module: postgresql
  log:
    enabled: true
    var.paths: ["/var/log/postgresql/postgresql-*.log"]
```

### 3.3 PostgreSQL日志格式示例


```
2024-09-21 10:15:30.123 CST [12345]: [1-1] user=webapp,db=myapp LOG: 
    duration: 2500.123 ms  statement: 
    SELECT count(*) FROM orders WHERE created_at >= '2024-09-01';
```

**关键信息提取**：
- 🔸 **duration**: 查询执行时间
- 🔸 **user**: 执行查询的用户
- 🔸 **db**: 数据库名称
- 🔸 **statement**: 具体的SQL语句

---

## 4. 📦 Redis日志监控


### 4.1 Redis日志特点


> 💡 **Redis日志特点**：相比关系型数据库，Redis日志更简洁，主要关注连接、内存、持久化等方面

**Redis主要日志类型**：
- 🔸 **服务器日志**：启动、关闭、配置变更
- 🔸 **慢查询日志**：执行时间超过阈值的命令
- 🔸 **客户端连接日志**：连接建立和断开

### 4.2 Redis慢查询配置


```bash
# Redis配置文件 redis.conf
# 慢查询时间阈值（微秒），10000微秒 = 10毫秒
slowlog-log-slower-than 10000
# 慢查询日志最大长度
slowlog-max-len 1000
```

**查看Redis慢查询**：
```bash
# 连接Redis
redis-cli

# 查看慢查询日志
SLOWLOG GET 10

# 查看慢查询日志长度
SLOWLOG LEN

# 清空慢查询日志
SLOWLOG RESET
```

### 4.3 Redis日志采集配置


```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/redis/redis-server.log
  
  fields:
    log_type: redis
    service: cache
  fields_under_root: true
  
  # Redis日志通常是单行的，不需要多行处理
  processors:
    - add_host_metadata: {}
    - add_docker_metadata: {}
```

### 4.4 Redis日志示例


```
2024-09-21 10:15:30.123 * Ready to accept connections
2024-09-21 10:15:35.456 * Client connected from 192.168.1.100:54321
2024-09-21 10:16:00.789 * Slow query detected: KEYS pattern*
2024-09-21 10:16:05.012 # Warning: memory usage is high (85%)
```

---

## 5. 📊 数据库性能监控策略


### 5.1 关键性能指标


**核心监控指标体系**：

```
数据库性能金字塔：

         🔥 业务指标
        ┌─────────────┐
        │  响应时间   │ ← 用户最关心的
        │  吞吐量     │
        └─────────────┘
              │
         ⚡ 资源指标  
        ┌─────────────┐
        │  CPU使用率  │ ← 系统资源状况
        │  内存使用率 │
        │  磁盘IO     │
        └─────────────┘
              │
         🔍 数据库指标
        ┌─────────────┐
        │  连接数     │ ← 数据库内部状态
        │  锁等待     │
        │  缓存命中率 │
        └─────────────┘
```

### 5.2 告警规则设置


**基于Elasticsearch的告警配置**：

| 指标类型 | 告警阈值 | 处理级别 | 说明 |
|---------|----------|----------|------|
| **慢查询** | > 5秒 | 🔴 严重 | 立即优化SQL |
| **连接数** | > 80% | 🟡 警告 | 考虑扩容 |
| **CPU使用率** | > 85% | 🟠 注意 | 监控趋势 |
| **错误率** | > 1% | 🔴 严重 | 紧急处理 |

### 5.3 性能分析仪表板


**Kibana仪表板设计思路**：

```
仪表板布局示例：

┌─────────────────┬─────────────────┐
│   实时指标      │   趋势图表      │
│ • 当前QPS       │ • 24小时QPS趋势 │
│ • 平均响应时间  │ • 慢查询分布    │
│ • 活跃连接数    │ • 错误率变化    │
└─────────────────┼─────────────────┤
│   TOP慢查询     │   告警信息      │
│ • SQL语句       │ • 最新告警      │
│ • 执行时间      │ • 处理状态      │
│ • 执行次数      │ • 影响范围      │
└─────────────────┴─────────────────┘
```

---

## 6. 🏭 生产环境最佳实践


### 6.1 采集策略优化


**生产环境配置要点**：

> ⚠️ **生产环境注意事项**：日志采集不能影响数据库性能，需要合理配置

**资源消耗控制**：
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/mysql/mysql-slow.log
  
  # 控制采集频率，避免对磁盘IO造成压力
  scan_frequency: 10s
  
  # 设置文件读取缓冲区大小
  harvester_buffer_size: 16384
  
  # 限制最大文件大小
  max_bytes: 10485760  # 10MB
  
  # 排除不重要的日志
  exclude_lines: ['^# Tcp port:']
```

### 6.2 日志轮转配置


**MySQL日志轮转示例**：
```bash
# /etc/logrotate.d/mysql-slow
/var/log/mysql/mysql-slow.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        # 通知MySQL重新打开日志文件
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

### 6.3 安全考虑


**敏感信息处理**：
```yaml
processors:
  # 脱敏处理 - 隐藏敏感SQL参数
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message) {
            // 替换可能的密码字段
            message = message.replace(/password\s*=\s*'[^']*'/gi, "password='***'");
            event.Put("message", message);
          }
        }
```

### 6.4 性能监控与调优


**Filebeat性能监控**：
```yaml
# 启用监控指标
monitoring.enabled: true
monitoring.elasticsearch:
  hosts: ["localhost:9200"]

# 调整输出批次大小以提高性能
output.elasticsearch:
  hosts: ["localhost:9200"]
  bulk_max_size: 3200
  worker: 2
```

**性能调优参数**：

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| `bulk_max_size` | 3200 | 批次大小，平衡性能和内存 |
| `worker` | 2 | 工作线程数，根据CPU核数调整 |
| `scan_frequency` | 10s | 扫描频率，避免过于频繁 |
| `queue.mem.events` | 4096 | 内存队列大小 |

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 数据库日志类型：错误日志、慢查询日志、访问日志、二进制日志
🔸 MySQL模块：开箱即用的配置，适合大多数场景
🔸 慢查询分析：通过Query_time和Rows_examined分析性能
🔸 多行日志处理：数据库日志经常是多行格式，需要正确配置
🔸 性能监控：建立完整的指标体系和告警机制
```

### 7.2 关键理解要点


**🔹 为什么需要采集数据库日志**：
```
性能优化：找出慢查询，优化SQL和索引
故障诊断：快速定位问题，减少故障时间
容量规划：基于历史数据预测资源需求
安全审计：记录数据库访问，满足合规要求
```

**🔹 如何选择采集方式**：
```
使用模块：标准场景，配置简单，维护方便
自定义配置：特殊需求，灵活度高，需要更多配置
混合方式：核心日志用模块，特殊需求用自定义
```

**🔹 生产环境注意事项**：
```
性能影响：合理配置扫描频率和批次大小
安全性：脱敏处理敏感信息
可靠性：配置日志轮转，避免磁盘空间不足
监控：监控Filebeat自身性能和采集状态
```

### 7.3 实际应用价值


**🎯 业务场景应用**：
- **电商系统**：监控订单查询性能，优化购物体验
- **金融平台**：审计数据库访问，确保资金安全
- **游戏服务**：分析玩家数据查询，优化游戏响应
- **内容平台**：监控内容检索性能，提升用户体验

**🔧 运维实践**：
- **性能调优**：基于慢查询日志优化SQL和索引
- **容量规划**：根据历史数据预测资源需求
- **故障处理**：快速定位数据库相关问题
- **合规审计**：满足数据访问审计要求

**核心记忆**：
- 数据库日志是性能优化的重要依据
- Filebeat模块让日志采集变得简单
- 慢查询日志是性能分析的核心
- 生产环境需要平衡采集效果和系统性能
- 完整的监控体系包括指标采集、分析和告警