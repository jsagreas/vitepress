---
title: 2ã€é«˜å¯ç”¨éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [é«˜å¯ç”¨æ¦‚å¿µä¸å¿…è¦æ€§](#1-é«˜å¯ç”¨æ¦‚å¿µä¸å¿…è¦æ€§)
2. [å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥](#2-å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥)
3. [è´Ÿè½½å‡è¡¡é…ç½®è¯¦è§£](#3-è´Ÿè½½å‡è¡¡é…ç½®è¯¦è§£)
4. [è¾“å‡ºåˆ†ç‰‡ä¸æ•…éšœè½¬ç§»](#4-è¾“å‡ºåˆ†ç‰‡ä¸æ•…éšœè½¬ç§»)
5. [èŠ‚ç‚¹ç›‘æ§ä¸å¥åº·æ£€æŸ¥](#5-èŠ‚ç‚¹ç›‘æ§ä¸å¥åº·æ£€æŸ¥)
6. [å®é™…éƒ¨ç½²æ¡ˆä¾‹](#6-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é«˜å¯ç”¨æ¦‚å¿µä¸å¿…è¦æ€§


### 1.1 ä»€ä¹ˆæ˜¯é«˜å¯ç”¨éƒ¨ç½²


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸‹å¿«é€’å…¬å¸çš„è¿ä½œæ¨¡å¼ï¼šå¦‚æœåªæœ‰ä¸€ä¸ªå¿«é€’å‘˜ï¼Œä»–ç”Ÿç—…äº†æ•´ä¸ªç‰‡åŒºå°±åœæ­¢é€è´§ã€‚ä½†å¦‚æœæœ‰å¤šä¸ªå¿«é€’å‘˜ï¼Œä¸€ä¸ªäººä¸åœ¨ï¼Œå…¶ä»–äººå¯ä»¥ç»§ç»­å·¥ä½œï¼Œè¿™å°±æ˜¯é«˜å¯ç”¨çš„æ ¸å¿ƒæ€æƒ³ã€‚

```
å•ç‚¹éƒ¨ç½²ï¼š                    é«˜å¯ç”¨éƒ¨ç½²ï¼š
åº”ç”¨ â†’ Filebeat â†’ ES           åº”ç”¨ â†’ Filebeat1 â†’ ESé›†ç¾¤
      (å•ç‚¹æ•…éšœ)                    â†’ Filebeat2 â†’ 
                                  â†’ Filebeat3 â†’ 
```

**ğŸ“‹ æ ¸å¿ƒç‰¹å¾**
- **æ— å•ç‚¹æ•…éšœ**ï¼šä»»ä½•ä¸€ä¸ªç»„ä»¶æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- **è‡ªåŠ¨æ¢å¤**ï¼šæ•…éšœèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨é‡æ–°åŠ å…¥é›†ç¾¤
- **è´Ÿè½½åˆ†æ‹…**ï¼šå¤šä¸ªèŠ‚ç‚¹å…±åŒå¤„ç†æ—¥å¿—æ”¶é›†ä»»åŠ¡
- **æ•°æ®ä¸ä¸¢å¤±**ï¼šç¡®ä¿æ—¥å¿—æ•°æ®çš„å®Œæ•´æ€§å’Œå¯é æ€§

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é«˜å¯ç”¨


**âš ï¸ å•ç‚¹éƒ¨ç½²çš„é£é™©**
```
é£é™©åœºæ™¯ï¼š
ğŸ”¸ æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœ â†’ æ—¥å¿—æ”¶é›†å®Œå…¨åœæ­¢
ğŸ”¸ ç½‘ç»œè¿æ¥ä¸­æ–­ â†’ æ•°æ®ä¼ è¾“å¤±è´¥
ğŸ”¸ Filebeatè¿›ç¨‹å´©æºƒ â†’ æ—¥å¿—ä¸¢å¤±
ğŸ”¸ é…ç½®é”™è¯¯ â†’ æ•´ä¸ªæ”¶é›†é“¾è·¯ä¸­æ–­
```

**ğŸ’¡ é«˜å¯ç”¨çš„ä»·å€¼**
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼š7x24å°æ—¶ä¸é—´æ–­æ—¥å¿—æ”¶é›†
- **æ•°æ®å®Œæ•´æ€§**ï¼šé¿å…å…³é”®æ—¥å¿—æ•°æ®ä¸¢å¤±
- **è¿ç»´ç®€åŒ–**ï¼šå‡å°‘äººå·¥å¹²é¢„å’Œç´§æ€¥å¤„ç†
- **æ‰©å±•æ€§**ï¼šéšä¸šåŠ¡å¢é•¿çµæ´»æ‰©å®¹

---

## 2. ğŸ—ï¸ å¤šèŠ‚ç‚¹éƒ¨ç½²ç­–ç•¥


### 2.1 éƒ¨ç½²æ¶æ„è®¾è®¡


**ğŸ”¹ æ¨èæ¶æ„æ¨¡å¼**

```
                    åº”ç”¨æœåŠ¡å™¨é›†ç¾¤
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   App1      â”‚
                    â”‚   App2      â”‚  
                    â”‚   App3      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ—¥å¿—æ–‡ä»¶    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Filebeat1â”‚  â”‚Filebeat2â”‚  â”‚Filebeat3â”‚
        â”‚(ä¸»èŠ‚ç‚¹) â”‚  â”‚(å¤‡èŠ‚ç‚¹) â”‚  â”‚(å¤‡èŠ‚ç‚¹) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Elasticsearchâ”‚
                    â”‚    é›†ç¾¤      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ èŠ‚ç‚¹è§’è‰²åˆ†é…**

| èŠ‚ç‚¹ç±»å‹ | **ä¸»è¦èŒè´£** | **é…ç½®ç‰¹ç‚¹** | **æ•…éšœå¤„ç†** |
|---------|------------|-------------|-------------|
| ğŸ”¸ **ä¸»èŠ‚ç‚¹** | `ä¸»è¦è´Ÿè´£æ—¥å¿—æ”¶é›†` | `å®Œæ•´é…ç½®ï¼Œé«˜æ€§èƒ½` | `æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡èŠ‚ç‚¹` |
| ğŸ”¸ **å¤‡èŠ‚ç‚¹** | `æ•…éšœæ—¶æ¥ç®¡å·¥ä½œ` | `ç›¸åŒé…ç½®ï¼Œå¾…æœºçŠ¶æ€` | `æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹æ•…éšœç«‹å³æ¿€æ´»` |
| ğŸ”¸ **ç›‘æ§èŠ‚ç‚¹** | `ç›‘æ§é›†ç¾¤å¥åº·çŠ¶æ€` | `è½»é‡çº§é…ç½®` | `ç‹¬ç«‹è¿è¡Œï¼Œä¸å½±å“ä¸»å¤‡åˆ‡æ¢` |

### 2.2 èŠ‚ç‚¹æ ‡è¯†é…ç½®


**ğŸ”§ åŸºç¡€èŠ‚ç‚¹é…ç½®**

æ¯ä¸ªFilebeatèŠ‚ç‚¹éƒ½éœ€è¦æœ‰å”¯ä¸€çš„æ ‡è¯†ï¼Œå°±åƒç»™æ¯ä¸ªå¿«é€’å‘˜å‘å·¥å·ä¸€æ ·ï¼š

```yaml
# filebeat-node1.yml
name: "filebeat-node-1"
tags: ["production", "primary", "web-logs"]

# èŠ‚ç‚¹çº§åˆ«é…ç½®
node:
  name: "filebeat-primary"
  rack_id: "rack-001"
  zone: "zone-a"

# å¤„ç†å™¨æ ‡è¯†
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_docker_metadata: ~
  - add_fields:
      target: "agent"
      fields:
        node_id: "node-1"
        role: "primary"
```

**ğŸ’¡ æ ‡è¯†ä½œç”¨è¯´æ˜**
- **name**ï¼šèŠ‚ç‚¹åç§°ï¼Œç”¨äºåŒºåˆ†ä¸åŒèŠ‚ç‚¹
- **tags**ï¼šæ ‡ç­¾ï¼Œæ–¹ä¾¿åœ¨æ—¥å¿—ä¸­è¯†åˆ«æ¥æºèŠ‚ç‚¹  
- **node_id**ï¼šè‡ªå®šä¹‰èŠ‚ç‚¹IDï¼Œä¾¿äºç›‘æ§å’Œç®¡ç†
- **role**ï¼šèŠ‚ç‚¹è§’è‰²ï¼ŒåŒºåˆ†ä¸»èŠ‚ç‚¹å’Œå¤‡èŠ‚ç‚¹

### 2.3 é…ç½®æ–‡ä»¶ç®¡ç†


**ğŸ“ ç»Ÿä¸€é…ç½®ç®¡ç†ç­–ç•¥**

```
é…ç½®æ–‡ä»¶ç»“æ„ï¼š
/etc/filebeat/
â”œâ”€â”€ filebeat.yml           # é€šç”¨åŸºç¡€é…ç½®
â”œâ”€â”€ conf.d/
â”‚   â”œâ”€â”€ inputs.yml         # è¾“å…¥æºé…ç½®
â”‚   â”œâ”€â”€ outputs.yml        # è¾“å‡ºç›®æ ‡é…ç½®
â”‚   â””â”€â”€ processors.yml     # æ•°æ®å¤„ç†é…ç½®
â””â”€â”€ nodes/
    â”œâ”€â”€ node1.yml          # èŠ‚ç‚¹1ç‰¹å®šé…ç½®
    â”œâ”€â”€ node2.yml          # èŠ‚ç‚¹2ç‰¹å®šé…ç½®
    â””â”€â”€ node3.yml          # èŠ‚ç‚¹3ç‰¹å®šé…ç½®
```

**ğŸ”„ é…ç½®åŒæ­¥æ–¹æ³•**
```bash
# ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·åŒæ­¥
# æ–¹æ³•1ï¼šä½¿ç”¨rsyncåŒæ­¥
rsync -av /etc/filebeat/ node2:/etc/filebeat/
rsync -av /etc/filebeat/ node3:/etc/filebeat/

# æ–¹æ³•2ï¼šä½¿ç”¨Gitç®¡ç†é…ç½®
git clone https://github.com/company/filebeat-configs.git
cd filebeat-configs && git pull origin main
```

---

## 3. âš–ï¸ è´Ÿè½½å‡è¡¡é…ç½®è¯¦è§£


### 3.1 è´Ÿè½½å‡è¡¡åŸºæœ¬åŸç†


**ğŸ”¸ ç®€å•ç†è§£**
å°±åƒé“¶è¡Œæœ‰å¤šä¸ªçª—å£æœåŠ¡å®¢æˆ·ï¼Œå®¢æˆ·å¯ä»¥é€‰æ‹©æ’é˜Ÿäººæ•°è¾ƒå°‘çš„çª—å£ã€‚Filebeatçš„è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯ç±»ä¼¼åŸç†ï¼š

```
è´Ÿè½½å‡è¡¡å‰ï¼š                è´Ÿè½½å‡è¡¡åï¼š
æ‰€æœ‰æ—¥å¿— â†’ ESèŠ‚ç‚¹1          æ—¥å¿—A â†’ ESèŠ‚ç‚¹1  
          (å‹åŠ›å¤§)          æ—¥å¿—B â†’ ESèŠ‚ç‚¹2
                           æ—¥å¿—C â†’ ESèŠ‚ç‚¹3
                           (å‹åŠ›åˆ†æ•£)
```

### 3.2 è¾“å‡ºè´Ÿè½½å‡è¡¡é…ç½®


**âš¡ åŸºæœ¬è´Ÿè½½å‡è¡¡è®¾ç½®**

```yaml
# åŸºç¡€è´Ÿè½½å‡è¡¡é…ç½®
output.elasticsearch:
  hosts: 
    - "es-node1:9200"
    - "es-node2:9200" 
    - "es-node3:9200"
  
  # è´Ÿè½½å‡è¡¡ç­–ç•¥
  loadbalance: true
  
  # è¿æ¥é…ç½®
  worker: 3                    # å¹¶å‘workeræ•°é‡
  bulk_max_size: 3000         # æ‰¹é‡å‘é€å¤§å°
  compression_level: 1         # å‹ç¼©çº§åˆ«
  
  # é‡è¯•é…ç½®
  max_retries: 3
  backoff:
    init: 1s
    max: 60s
```

**ğŸ¯ é«˜çº§è´Ÿè½½å‡è¡¡ç­–ç•¥**

```yaml
# æ™ºèƒ½è´Ÿè½½å‡è¡¡é…ç½®
output.elasticsearch:
  hosts: ["es-node1:9200", "es-node2:9200", "es-node3:9200"]
  
  # è¿æ¥æ± é…ç½®
  connection_pool_size: 10
  
  # å¥åº·æ£€æŸ¥
  health_check:
    interval: 30s
    timeout: 5s
    path: "/_cluster/health"
  
  # èŠ‚ç‚¹é€‰æ‹©ç­–ç•¥
  selector: "round_robin"      # è½®è¯¢ç­–ç•¥
  # selector: "random"         # éšæœºç­–ç•¥  
  # selector: "least_conn"     # æœ€å°‘è¿æ¥ç­–ç•¥
```

### 3.3 åˆ†ç‰‡ç­–ç•¥é…ç½®


**ğŸ“Š ç´¢å¼•åˆ†ç‰‡é…ç½®**

```yaml
# æŒ‰æ—¶é—´åˆ†ç‰‡
output.elasticsearch:
  hosts: ["es-node1:9200", "es-node2:9200", "es-node3:9200"]
  
  # ç´¢å¼•å‘½åç­–ç•¥
  index: "filebeat-%{[agent.version]}-%{+yyyy.MM.dd}"
  
  # æ¨¡æ¿é…ç½®
  template:
    name: "filebeat-template"
    pattern: "filebeat-*"
    settings:
      index:
        number_of_shards: 3      # åˆ†ç‰‡æ•°é‡
        number_of_replicas: 1    # å‰¯æœ¬æ•°é‡
        refresh_interval: "5s"   # åˆ·æ–°é—´éš”
```

**âš¡ åŸºäºå†…å®¹çš„åˆ†ç‰‡**

```yaml
# æ ¹æ®æ—¥å¿—ç±»å‹åˆ†ç‰‡
processors:
  - script:
      lang: javascript
      source: >
        function process(event) {
          var logLevel = event.Get("log.level");
          if (logLevel === "ERROR") {
            event.Put("_index", "logs-error-%{+yyyy.MM.dd}");
          } else if (logLevel === "WARN") {
            event.Put("_index", "logs-warn-%{+yyyy.MM.dd}");
          } else {
            event.Put("_index", "logs-info-%{+yyyy.MM.dd}");
          }
        }
```

---

## 4. ğŸ”„ è¾“å‡ºåˆ†ç‰‡ä¸æ•…éšœè½¬ç§»


### 4.1 æ•…éšœè½¬ç§»æœºåˆ¶


**ğŸ› ï¸ è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®**

æ•…éšœè½¬ç§»å°±åƒå¤‡ç”¨å¸æœºï¼Œä¸»å¸æœºç”Ÿç—…äº†å¤‡ç”¨å¸æœºç«‹å³æ¥ç­ï¼š

```yaml
# å¤šè¾“å‡ºæ•…éšœè½¬ç§»é…ç½®
output.elasticsearch:
  hosts: ["es-primary:9200"]
  
  # ä¸»è¾“å‡ºå¤±è´¥æ—¶çš„å¤‡ç”¨è¾“å‡º
  fallback:
    - hosts: ["es-backup1:9200"]
      index: "backup-logs-%{+yyyy.MM.dd}"
    - hosts: ["es-backup2:9200"] 
      index: "emergency-logs-%{+yyyy.MM.dd}"
  
  # æ•…éšœæ£€æµ‹é…ç½®
  timeout: 30s
  max_retries: 3
  backoff:
    init: 1s
    max: 60s
```

**âš ï¸ å¥åº·æ£€æŸ¥é…ç½®**

```yaml
# è¯¦ç»†å¥åº·æ£€æŸ¥
output.elasticsearch:
  hosts: ["es-node1:9200", "es-node2:9200"]
  
  # å¥åº·æ£€æŸ¥å‚æ•°
  health_check:
    enabled: true
    interval: 30s              # æ£€æŸ¥é—´éš”
    timeout: 5s               # è¶…æ—¶æ—¶é—´
    path: "/_cluster/health"   # æ£€æŸ¥è·¯å¾„
    method: "GET"             # è¯·æ±‚æ–¹æ³•
    
  # æ•…éšœå¤„ç†
  dead_letter_index: "failed-logs-%{+yyyy.MM.dd}"
```

### 4.2 æ•°æ®å¤‡ä»½ç­–ç•¥


**ğŸ’¾ å¤šé‡å¤‡ä»½é…ç½®**

```yaml
# åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡
filebeat.config.inputs:
  enabled: true
  path: inputs.d/*.yml

# ä¸»è¾“å‡ºï¼šElasticsearch
output.elasticsearch:
  hosts: ["es-cluster:9200"]
  index: "primary-logs-%{+yyyy.MM.dd}"

# å¤‡ä»½è¾“å‡ºï¼šæ–‡ä»¶
processors:
  - script:
      lang: javascript
      source: >
        function process(event) {
          // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ä»½
          var backup = JSON.stringify(event.Get());
          require('fs').appendFileSync('/var/log/filebeat-backup.log', backup + '\n');
        }
```

### 4.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯


**âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥**

```yaml
# æ•°æ®å®Œæ•´æ€§é…ç½®
processors:
  - fingerprint:
      fields: ["message", "@timestamp", "host.name"]
      target_field: "data_fingerprint"
      method: "sha256"
  
  - add_fields:
      target: "backup"
      fields:
        sent_time: "${timestamp}"
        node_id: "${NODE_ID}"
        batch_id: "${batch_id}"
```

---

## 5. ğŸ“Š èŠ‚ç‚¹ç›‘æ§ä¸å¥åº·æ£€æŸ¥


### 5.1 èŠ‚ç‚¹çŠ¶æ€ç›‘æ§


**ğŸ“ˆ åŸºç¡€ç›‘æ§é…ç½®**

```yaml
# ç›‘æ§é…ç½®
monitoring:
  enabled: true
  cluster_uuid: "your-cluster-uuid"
  
  # ç›‘æ§æ•°æ®å‘é€åˆ°Elasticsearch
  elasticsearch:
    hosts: ["monitoring-es:9200"]
    index: "filebeat-monitoring"
  
  # ç›‘æ§æŒ‡æ ‡
  metrics:
    period: 30s
    processes: ["cpu", "memory", "network"]
    system: ["load", "diskio"]
```

**ğŸ” å¥åº·æ£€æŸ¥è„šæœ¬**

```bash
#!/bin/bash
# filebeat-health-check.sh

NODE_NAME="filebeat-node-1"
LOG_FILE="/var/log/filebeat-health.log"

# æ£€æŸ¥Filebeatè¿›ç¨‹
check_process() {
    if pgrep -f filebeat > /dev/null; then
        echo "$(date): âœ… Filebeatè¿›ç¨‹è¿è¡Œæ­£å¸¸" >> $LOG_FILE
        return 0
    else
        echo "$(date): âŒ Filebeatè¿›ç¨‹æœªè¿è¡Œ" >> $LOG_FILE
        return 1
    fi
}

# æ£€æŸ¥é…ç½®æ–‡ä»¶
check_config() {
    if filebeat test config -c /etc/filebeat/filebeat.yml; then
        echo "$(date): âœ… é…ç½®æ–‡ä»¶æ­£å¸¸" >> $LOG_FILE
        return 0
    else
        echo "$(date): âŒ é…ç½®æ–‡ä»¶æœ‰è¯¯" >> $LOG_FILE
        return 1
    fi
}

# æ£€æŸ¥ç½‘ç»œè¿æ¥
check_connectivity() {
    if curl -s "http://es-node1:9200/_cluster/health" > /dev/null; then
        echo "$(date): âœ… Elasticsearchè¿æ¥æ­£å¸¸" >> $LOG_FILE
        return 0
    else
        echo "$(date): âŒ Elasticsearchè¿æ¥å¤±è´¥" >> $LOG_FILE
        return 1
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    echo "$(date): å¼€å§‹å¥åº·æ£€æŸ¥..." >> $LOG_FILE
    
    check_process && check_config && check_connectivity
    
    if [ $? -eq 0 ]; then
        echo "$(date): âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡" >> $LOG_FILE
    else
        echo "$(date): âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•é‡å¯æœåŠ¡" >> $LOG_FILE
        systemctl restart filebeat
    fi
}

main
```

### 5.2 é›†ç¾¤ç›‘æ§é…ç½®


**ğŸ“Š é›†ç¾¤çŠ¶æ€ç›‘æ§**

```yaml
# é›†ç¾¤ç›‘æ§é…ç½®
metricbeat.modules:
  - module: elasticsearch
    metricsets: ["node", "node_stats", "cluster_stats"]
    period: 30s
    hosts: ["es-node1:9200", "es-node2:9200"]
    
  - module: system
    metricsets: ["cpu", "memory", "network", "process"]
    period: 30s
    processes: ['filebeat']

# å‘Šè­¦é…ç½®
processors:
  - script:
      lang: javascript
      source: >
        function process(event) {
          var cpuUsage = event.Get("system.cpu.user.pct");
          if (cpuUsage > 0.8) {
            event.Put("alert.level", "warning");
            event.Put("alert.message", "CPU usage is high: " + cpuUsage);
          }
        }
```

### 5.3 è‡ªåŠ¨æ¢å¤æœºåˆ¶


**ğŸ”§ è‡ªåŠ¨æ¢å¤é…ç½®**

```bash
#!/bin/bash
# auto-recovery.sh

RETRY_COUNT=0
MAX_RETRIES=3

recovery_filebeat() {
    echo "å°è¯•æ¢å¤FilebeatæœåŠ¡..."
    
    # åœæ­¢æœåŠ¡
    systemctl stop filebeat
    sleep 5
    
    # æ¸…ç†å¯èƒ½çš„é”æ–‡ä»¶
    rm -f /var/lib/filebeat/filebeat.lock
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    DISK_USAGE=$(df /var/log | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 90 ]; then
        echo "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†æ—§æ—¥å¿—..."
        find /var/log -name "*.log" -mtime +7 -delete
    fi
    
    # é‡å¯æœåŠ¡
    systemctl start filebeat
    sleep 10
    
    # éªŒè¯æ¢å¤
    if systemctl is-active --quiet filebeat; then
        echo "âœ… Filebeatæ¢å¤æˆåŠŸ"
        return 0
    else
        echo "âŒ Filebeatæ¢å¤å¤±è´¥"
        return 1
    fi
}

# ç›‘æ§å¾ªç¯
while true; do
    if ! systemctl is-active --quiet filebeat; then
        echo "æ£€æµ‹åˆ°FilebeatæœåŠ¡å¼‚å¸¸"
        
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            recovery_filebeat
            if [ $? -eq 0 ]; then
                RETRY_COUNT=0
            else
                RETRY_COUNT=$((RETRY_COUNT + 1))
            fi
        else
            echo "è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå‘é€å‘Šè­¦é€šçŸ¥"
            # è¿™é‡Œå¯ä»¥é›†æˆå‘Šè­¦ç³»ç»Ÿ
            RETRY_COUNT=0
        fi
    fi
    
    sleep 60
done
```

---

## 6. ğŸš€ å®é™…éƒ¨ç½²æ¡ˆä¾‹


### 6.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¤ºä¾‹


**ğŸ¢ ä¼ä¸šçº§éƒ¨ç½²æ¶æ„**

```
ç”Ÿäº§ç¯å¢ƒæ‹“æ‰‘ï¼š

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WebæœåŠ¡å™¨é›†ç¾¤   â”‚
                    â”‚   (10å°æœåŠ¡å™¨)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    æ—¥å¿—æ–‡ä»¶      â”‚
                    â”‚  /var/log/app/   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Filebeaté›†ç¾¤1â”‚   â”‚ Filebeaté›†ç¾¤2â”‚   â”‚ Filebeaté›†ç¾¤3â”‚
  â”‚  (ä¸»ç«™ç‚¹)    â”‚   â”‚  (å¤‡ç«™ç‚¹)    â”‚   â”‚  (DRç«™ç‚¹)   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Elasticsearché›†ç¾¤â”‚
                    â”‚   (9ä¸ªèŠ‚ç‚¹)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ é…ç½®æ–‡ä»¶å®ä¾‹**

```yaml
# ä¸»ç«™ç‚¹Filebeaté…ç½®
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/app/*.log
    fields:
      env: "production"
      site: "primary"
      cluster: "main"
    fields_under_root: true

# é›†ç¾¤é…ç½®
setup.ilm:
  enabled: true
  rollover_alias: "filebeat-production"
  pattern: "{now/d}-000001"
  policy: "filebeat-policy"

output.elasticsearch:
  hosts: 
    - "es-prod-01:9200"
    - "es-prod-02:9200"
    - "es-prod-03:9200"
  
  loadbalance: true
  worker: 5
  bulk_max_size: 5000
  
  # ç´¢å¼•æ¨¡æ¿
  index: "filebeat-prod-%{[site]}-%{+yyyy.MM.dd}"
  
  # è®¤è¯é…ç½®
  username: "filebeat_writer"
  password: "${FILEBEAT_PASSWORD}"
  
  # SSLé…ç½®
  ssl:
    enabled: true
    certificate_authorities: ["/etc/ssl/ca.crt"]
    certificate: "/etc/ssl/filebeat.crt"
    key: "/etc/ssl/filebeat.key"
```

### 6.2 å¤šç¯å¢ƒé…ç½®ç®¡ç†


**ğŸ”§ ç¯å¢ƒå·®å¼‚åŒ–é…ç½®**

```yaml
# å¼€å‘ç¯å¢ƒé…ç½® (filebeat-dev.yml)
filebeat.inputs:
  - type: log
    paths: ["/var/log/app-dev/*.log"]
    fields:
      env: "development"

output.elasticsearch:
  hosts: ["es-dev:9200"]
  index: "filebeat-dev-%{+yyyy.MM.dd}"

# æµ‹è¯•ç¯å¢ƒé…ç½® (filebeat-test.yml)  
filebeat.inputs:
  - type: log
    paths: ["/var/log/app-test/*.log"]
    fields:
      env: "testing"

output.elasticsearch:
  hosts: ["es-test:9200"]
  index: "filebeat-test-%{+yyyy.MM.dd}"

# ç”Ÿäº§ç¯å¢ƒé…ç½® (filebeat-prod.yml)
filebeat.inputs:
  - type: log
    paths: ["/var/log/app-prod/*.log"]
    fields:
      env: "production"

output.elasticsearch:
  hosts: ["es-prod-01:9200", "es-prod-02:9200"]
  index: "filebeat-prod-%{+yyyy.MM.dd}"
```

### 6.3 éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬


**ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# deploy-filebeat-cluster.sh

set -e

ENVIRONMENT=${1:-"dev"}
NODE_COUNT=${2:-3}
CONFIG_REPO="https://github.com/company/filebeat-configs.git"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²Filebeaté›†ç¾¤..."
echo "ç¯å¢ƒ: $ENVIRONMENT"
echo "èŠ‚ç‚¹æ•°é‡: $NODE_COUNT"

# 1. å‡†å¤‡é…ç½®æ–‡ä»¶
prepare_configs() {
    echo "ğŸ“ å‡†å¤‡é…ç½®æ–‡ä»¶..."
    git clone $CONFIG_REPO /tmp/filebeat-configs
    cd /tmp/filebeat-configs
    git checkout $ENVIRONMENT
}

# 2. éƒ¨ç½²FilebeatèŠ‚ç‚¹
deploy_node() {
    local node_id=$1
    local node_ip=$2
    
    echo "ğŸ“¦ éƒ¨ç½²èŠ‚ç‚¹ $node_id ($node_ip)..."
    
    # å¤åˆ¶é…ç½®æ–‡ä»¶
    scp -r /tmp/filebeat-configs/ root@$node_ip:/etc/filebeat/
    
    # å®‰è£…Filebeat
    ssh root@$node_ip "
        # ä¸‹è½½å¹¶å®‰è£…Filebeat
        curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.0.0-linux-x86_64.tar.gz
        tar xzvf filebeat-8.0.0-linux-x86_64.tar.gz
        
        # é…ç½®æœåŠ¡
        cp filebeat-8.0.0-linux-x86_64/filebeat /usr/local/bin/
        cp /etc/filebeat/filebeat-$ENVIRONMENT.yml /etc/filebeat/filebeat.yml
        
        # è®¾ç½®èŠ‚ç‚¹æ ‡è¯†
        sed -i 's/NODE_ID/node-$node_id/g' /etc/filebeat/filebeat.yml
        
        # å¯åŠ¨æœåŠ¡
        systemctl enable filebeat
        systemctl start filebeat
        
        echo 'âœ… èŠ‚ç‚¹ $node_id éƒ¨ç½²å®Œæˆ'
    "
}

# 3. éªŒè¯éƒ¨ç½²
verify_deployment() {
    echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."
    
    for i in $(seq 1 $NODE_COUNT); do
        node_ip="10.0.1.$((10 + i))"
        
        ssh root@$node_ip "
            if systemctl is-active --quiet filebeat; then
                echo 'âœ… èŠ‚ç‚¹ $i è¿è¡Œæ­£å¸¸'
            else
                echo 'âŒ èŠ‚ç‚¹ $i è¿è¡Œå¼‚å¸¸'
                exit 1
            fi
        "
    done
    
    echo "ğŸ‰ æ‰€æœ‰èŠ‚ç‚¹éƒ¨ç½²éªŒè¯å®Œæˆï¼"
}

# æ‰§è¡Œéƒ¨ç½²
main() {
    prepare_configs
    
    for i in $(seq 1 $NODE_COUNT); do
        node_ip="10.0.1.$((10 + i))"
        deploy_node $i $node_ip
    done
    
    verify_deployment
}

main
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


**ğŸ¯ é«˜å¯ç”¨æ ¸å¿ƒè¦ç´ **
```
ğŸ”¸ å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼šé¿å…å•ç‚¹æ•…éšœï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šåˆ†æ•£å¤„ç†å‹åŠ›ï¼Œæé«˜æ•´ä½“æ€§èƒ½  
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡èŠ‚ç‚¹
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šå®æ—¶ç›‘æ§èŠ‚ç‚¹çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
ğŸ”¸ è‡ªåŠ¨æ¢å¤ï¼šæ•…éšœèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨é‡æ–°åŠ å…¥é›†ç¾¤
```

### 7.2 é…ç½®æœ€ä½³å®è·µ


**âœ… æ¨èé…ç½®ç­–ç•¥**
- **èŠ‚ç‚¹æ•°é‡**ï¼šè‡³å°‘3ä¸ªèŠ‚ç‚¹ï¼Œå¥‡æ•°ä¸ªèŠ‚ç‚¹é¿å…è„‘è£‚
- **è´Ÿè½½å‡è¡¡**ï¼šä½¿ç”¨è½®è¯¢ç­–ç•¥ï¼Œé…åˆå¥åº·æ£€æŸ¥
- **é‡è¯•æœºåˆ¶**ï¼šè®¾ç½®åˆç†çš„é‡è¯•æ¬¡æ•°å’Œé€€é¿ç­–ç•¥
- **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®å®Œå–„çš„ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦æœºåˆ¶

**âš ï¸ å¸¸è§é…ç½®è¯¯åŒº**
- ä¸è¦æŠŠæ‰€æœ‰èŠ‚ç‚¹éƒ¨ç½²åœ¨åŒä¸€å°ç‰©ç†æœºå™¨ä¸Š
- ä¸è¦å¿½ç•¥ç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´çš„è„‘è£‚é—®é¢˜
- ä¸è¦è®¾ç½®è¿‡äºæ¿€è¿›çš„å¥åº·æ£€æŸ¥é—´éš”
- ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¼ºå°‘ç›‘æ§å’Œå‘Šè­¦

### 7.3 è¿ç»´ç®¡ç†è¦ç‚¹


**ğŸ“Š æ—¥å¸¸ç›‘æ§æŒ‡æ ‡**
```
ç³»ç»ŸæŒ‡æ ‡ï¼š
â€¢ CPUä½¿ç”¨ç‡ < 70%
â€¢ å†…å­˜ä½¿ç”¨ç‡ < 80%  
â€¢ ç£ç›˜ä½¿ç”¨ç‡ < 85%
â€¢ ç½‘ç»œè¿æ¥çŠ¶æ€æ­£å¸¸

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ æ—¥å¿—å¤„ç†å»¶è¿Ÿ < 5ç§’
â€¢ æ•°æ®ä¸¢å¤±ç‡ = 0%
â€¢ èŠ‚ç‚¹å¯ç”¨æ€§ > 99.9%
â€¢ æ•…éšœæ¢å¤æ—¶é—´ < 2åˆ†é’Ÿ
```

**ğŸ”§ æ•…éšœå¤„ç†æµç¨‹**
1. **å‘Šè­¦æ¥æ”¶**ï¼šé€šè¿‡ç›‘æ§ç³»ç»Ÿæ¥æ”¶æ•…éšœå‘Šè­¦
2. **å¿«é€Ÿè¯Šæ–­**ï¼šæ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ã€ç½‘ç»œè¿æ¥ã€èµ„æºä½¿ç”¨æƒ…å†µ
3. **è‡ªåŠ¨æ¢å¤**ï¼šè§¦å‘è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼Œå°è¯•é‡å¯æœåŠ¡
4. **æ‰‹åŠ¨ä»‹å…¥**ï¼šè‡ªåŠ¨æ¢å¤å¤±è´¥æ—¶ï¼Œè¿ç»´äººå‘˜æ‰‹åŠ¨å¤„ç†
5. **é—®é¢˜æ€»ç»“**ï¼šè®°å½•æ•…éšœåŸå› ï¼Œä¼˜åŒ–é…ç½®å’Œæµç¨‹

### 7.4 æ‰©å±•å’Œä¼˜åŒ–å»ºè®®


**ğŸš€ æ€§èƒ½ä¼˜åŒ–æ–¹å‘**
- **æ°´å¹³æ‰©å±•**ï¼šæ ¹æ®æ—¥å¿—é‡å¢é•¿å¢åŠ FilebeatèŠ‚ç‚¹
- **é…ç½®è°ƒä¼˜**ï¼šä¼˜åŒ–æ‰¹é‡å¤§å°ã€Workeræ•°é‡ç­‰å‚æ•°
- **ç½‘ç»œä¼˜åŒ–**ï¼šä½¿ç”¨ä¸“ç”¨ç½‘ç»œï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ
- **å­˜å‚¨ä¼˜åŒ–**ï¼šä½¿ç”¨SSDå­˜å‚¨ï¼Œæé«˜I/Oæ€§èƒ½

**ğŸ’¡ æ¶æ„æ¼”è¿›è·¯å¾„**
```
é˜¶æ®µ1ï¼šå•èŠ‚ç‚¹éƒ¨ç½² (é€‚åˆå¼€å‘ç¯å¢ƒ)
é˜¶æ®µ2ï¼šä¸»å¤‡æ¨¡å¼ (é€‚åˆå°å‹ç”Ÿäº§ç¯å¢ƒ)  
é˜¶æ®µ3ï¼šå¤šèŠ‚ç‚¹é›†ç¾¤ (é€‚åˆä¸­å‹ç”Ÿäº§ç¯å¢ƒ)
é˜¶æ®µ4ï¼šè·¨åœ°åŸŸéƒ¨ç½² (é€‚åˆå¤§å‹ä¼ä¸šç¯å¢ƒ)
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é«˜å¯ç”¨ä¸æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ˜¯ä¸€ä¸ªä½“ç³»
- ç›‘æ§å…ˆè¡Œï¼Œé¢„é˜²èƒœäºæ²»ç–—
- è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ ‡å‡†åŒ–é…ç½®
- æ•…éšœæ¼”ç»ƒï¼Œæå‡åº”æ€¥èƒ½åŠ›