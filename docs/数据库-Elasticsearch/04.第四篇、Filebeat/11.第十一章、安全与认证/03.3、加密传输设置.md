---
title: 3、加密传输设置
---
## 📚 目录

1. [为什么需要加密传输](#1-为什么需要加密传输)
2. [TLS/SSL基础知识](#2-TLS-SSL基础知识)
3. [Filebeat加密配置详解](#3-Filebeat加密配置详解)
4. [证书管理与配置](#4-证书管理与配置)
5. [实战配置步骤](#5-实战配置步骤)
6. [安全配置清单](#6-安全配置清单)
7. [常见问题排查](#7-常见问题排查)
8. [最佳实践建议](#8-最佳实践建议)

---

## 1. 🔒 为什么需要加密传输


### 1.1 现实生活中的加密类比


想象一下寄快递的场景：

```
普通快递（明文传输）：
📦 包裹 → 快递员 → 分拣中心 → 配送员 → 📍 目的地
问题：任何人都能打开包裹查看内容

加密快递（TLS传输）：
🔐 保险箱 → 快递员 → 分拣中心 → 配送员 → 🔓 目的地解锁
优势：只有收件人有钥匙能打开
```

### 1.2 日志传输的安全风险


**🚨 未加密传输的危险**

| 风险类型 | 具体威胁 | 可能后果 | 防护等级 |
|---------|----------|---------|----------|
| **数据窃听** | 网络中间人截获日志 | 敏感信息泄露 | `🔴 高危` |
| **内容篡改** | 恶意修改日志内容 | 误导运维决策 | `🟡 中危` |
| **身份伪造** | 冒充合法的日志源 | 注入虚假日志 | `🟡 中危` |
| **重放攻击** | 重复发送旧日志 | 干扰监控系统 | `🟢 低危` |

### 1.3 加密传输的好处


**✅ 保护效果对比**

```
明文传输链路：
Filebeat → [可被监听] → Elasticsearch
    ↓
敏感数据暴露：用户密码、API密钥、个人信息

加密传输链路：  
Filebeat → [TLS加密隧道] → Elasticsearch
    ↓
数据安全传输：即使被截获也无法解读
```

> 💡 **新手提示**
> 
> 就像给重要文件上锁一样，TLS加密为您的日志数据提供了一条安全的"专用通道"

---

## 2. 🔐 TLS/SSL基础知识


### 2.1 TLS/SSL是什么


**简单理解：TLS就是网络通信的"保险箱"**

```
TLS (Transport Layer Security) 传输层安全协议
├─ 前身是SSL (Secure Sockets Layer)
├─ 目前主流版本：TLS 1.2 和 TLS 1.3
└─ 作用：在两个通信应用程序间提供保密性和数据完整性
```

### 2.2 TLS工作原理图解


```
客户端(Filebeat)                     服务端(Elasticsearch)
       │                                    │
       │────[1] 发起连接请求─────────────────→│
       │                                    │
       │←───[2] 发送服务器证书────────────────│
       │                                    │
       │────[3] 验证证书有效性───────────────→│
       │                                    │
       │←───[4] 协商加密算法─────────────────→│
       │                                    │
       │────[5] 建立加密通道─────────────────→│
       │                                    │
       │═══════[加密数据传输]═══════════════→│
```

### 2.3 证书的作用机制


**🏆 证书就像身份证**

| 证书类型 | 作用说明 | 生活类比 | 使用场景 |
|---------|----------|----------|----------|
| **服务器证书** | 证明服务器身份 | 商店营业执照 | Elasticsearch服务端 |
| **客户端证书** | 证明客户端身份 | 个人身份证 | 双向认证时的Filebeat |
| **CA证书** | 颁发机构证书 | 政府机关印章 | 验证其他证书的合法性 |

**🔍 证书验证过程**

```
步骤1：Filebeat收到Elasticsearch证书
   ↓
步骤2：检查证书是否由可信CA签发
   ↓  
步骤3：验证证书域名是否匹配
   ↓
步骤4：检查证书是否在有效期内
   ↓
步骤5：验证通过，建立加密连接
```

---

## 3. ⚙️ Filebeat加密配置详解


### 3.1 配置文件结构概览


**📋 Filebeat加密配置的主要位置**

```yaml
# filebeat.yml 文件结构
filebeat.inputs:          # 输入源配置
  - type: log
    paths: ["/var/log/*.log"]

output.elasticsearch:      # 输出目标配置（重点）
  hosts: ["https://localhost:9200"]
  ssl:                     # TLS/SSL配置区域
    enabled: true          # 启用加密
    # 更多配置项...

logging:                   # 日志配置
  level: info
```

### 3.2 基础加密配置


**🔧 最简单的TLS配置**

```yaml
output.elasticsearch:
  hosts: ["https://es-node1:9200", "https://es-node2:9200"]
  
  # 基础TLS配置
  ssl:
    enabled: true                    # 启用TLS加密
    verification_mode: certificate   # 证书验证模式
    certificate_authorities:         # CA证书路径
      - "/etc/filebeat/certs/ca.crt"
```

**📊 验证模式说明**

| 验证模式 | 安全级别 | 验证内容 | 适用场景 |
|---------|----------|----------|----------|
| `none` | `🔴 最低` | 不验证证书 | 仅测试环境 |
| `certificate` | `🟡 中等` | 验证证书有效性 | 内网环境 |
| `full` | `🟢 最高` | 验证证书+域名 | 生产环境推荐 |

### 3.3 单向认证配置


**🎯 适用场景：Filebeat验证Elasticsearch身份**

```yaml
output.elasticsearch:
  hosts: ["https://elasticsearch.company.com:9200"]
  
  ssl:
    enabled: true
    verification_mode: full
    certificate_authorities: 
      - "/etc/pki/tls/certs/ca-bundle.crt"    # 系统CA证书
    
    # 可选：指定TLS版本
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
    
    # 可选：指定加密套件
    cipher_suites:
      - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
      - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
```

### 3.4 双向认证配置


**🔐 适用场景：双方互相验证身份（最安全）**

```yaml
output.elasticsearch:
  hosts: ["https://secure-es.company.com:9200"]
  
  ssl:
    enabled: true
    verification_mode: full
    
    # CA证书（验证对方证书）
    certificate_authorities:
      - "/etc/filebeat/ssl/ca.crt"
    
    # 客户端证书（证明自己身份）
    certificate: "/etc/filebeat/ssl/filebeat.crt"
    key: "/etc/filebeat/ssl/filebeat.key"
    
    # 可选：私钥密码
    key_passphrase: "your-private-key-password"
```

---

## 4. 📜 证书管理与配置


### 4.1 证书文件类型说明


**📁 常见证书格式对照表**

| 文件扩展名 | 格式类型 | 内容说明 | 查看命令 |
|-----------|----------|----------|----------|
| `.crt`, `.cer` | PEM/DER | 公钥证书 | `openssl x509 -in cert.crt -text` |
| `.key` | PEM/DER | 私钥文件 | `openssl rsa -in key.key -text` |
| `.pem` | PEM | 证书或私钥 | `openssl x509 -in file.pem -text` |
| `.p12`, `.pfx` | PKCS#12 | 证书+私钥包 | `openssl pkcs12 -in file.p12 -info` |

### 4.2 获取证书的方式


**🛠️ 证书获取方法对比**

```
方式1：使用现有证书（推荐）
企业环境 → 从IT部门获取 → 部署到Filebeat

方式2：自签名证书（测试）
开发环境 → 自己生成证书 → 仅限内部使用

方式3：免费CA证书
公网服务 → Let's Encrypt → 适合对外服务
```

### 4.3 自签名证书生成实例


> ⚠️ **重要提醒**
> 
> 自签名证书仅适用于测试环境，生产环境请使用正规CA颁发的证书

**🔨 生成步骤详解**

```bash
# 步骤1：创建证书目录
sudo mkdir -p /etc/filebeat/ssl
cd /etc/filebeat/ssl

# 步骤2：生成CA私钥
openssl genrsa -out ca.key 4096

# 步骤3：生成CA证书
openssl req -new -x509 -days 365 -key ca.key -out ca.crt \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/CN=CA"

# 步骤4：生成服务器私钥
openssl genrsa -out server.key 4096

# 步骤5：生成服务器证书签名请求
openssl req -new -key server.key -out server.csr \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/CN=elasticsearch.local"

# 步骤6：用CA签发服务器证书
openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key \
  -CAcreateserial -out server.crt
```

### 4.4 证书权限设置


**🔒 文件权限安全配置**

```bash
# 设置正确的文件权限
sudo chown -R root:filebeat /etc/filebeat/ssl/
sudo chmod 640 /etc/filebeat/ssl/*.crt     # 证书文件
sudo chmod 600 /etc/filebeat/ssl/*.key     # 私钥文件（最严格）
sudo chmod 755 /etc/filebeat/ssl/          # 目录权限
```

**📋 权限说明表**

| 文件类型 | 权限设置 | 原因说明 | 安全影响 |
|---------|----------|----------|----------|
| CA证书 | `644` | 需要被多个程序读取 | 公开信息，影响较小 |
| 服务器证书 | `640` | 限制读取权限 | 包含服务器信息 |
| 私钥文件 | `600` | 仅所有者可读写 | 最敏感，需严格保护 |

---

## 5. 🚀 实战配置步骤


### 5.1 环境准备检查清单


**📋 配置前准备工作**

- [ ] **确认Elasticsearch已启用TLS**
  ```bash
  curl -k https://your-es-host:9200/_cluster/health
  ```

- [ ] **检查证书文件完整性**
  ```bash
  ls -la /etc/filebeat/ssl/
  # 应该看到：ca.crt, server.crt, server.key
  ```

- [ ] **验证证书有效期**
  ```bash
  openssl x509 -in /etc/filebeat/ssl/server.crt -dates -noout
  ```

- [ ] **测试网络连通性**
  ```bash
  telnet your-es-host 9200
  ```

### 5.2 分步骤配置指南


**步骤 1️⃣：备份现有配置**

```bash
# 备份原始配置文件
sudo cp /etc/filebeat/filebeat.yml /etc/filebeat/filebeat.yml.backup.$(date +%Y%m%d)
```

**步骤 2️⃣：修改输出配置**

```yaml
# 编辑 /etc/filebeat/filebeat.yml
output.elasticsearch:
  hosts: ["https://es-node1.company.com:9200"]
  
  # 基础认证（如果需要）
  username: "filebeat_user"
  password: "your_password"
  
  # TLS配置
  ssl:
    enabled: true
    verification_mode: certificate
    certificate_authorities:
      - "/etc/filebeat/ssl/ca.crt"
```

**步骤 3️⃣：配置验证**

```bash
# 测试配置文件语法
sudo filebeat test config

# 测试输出连接
sudo filebeat test output
```

**步骤 4️⃣：重启服务**

```bash
# 重启Filebeat服务
sudo systemctl restart filebeat

# 检查服务状态
sudo systemctl status filebeat
```

**步骤 5️⃣：验证连接**

```bash
# 查看Filebeat日志
sudo tail -f /var/log/filebeat/filebeat

# 在Elasticsearch中验证数据
curl -k -u username:password \
  "https://es-host:9200/_cat/indices/filebeat-*"
```

### 5.3 配置模板示例


**🎯 生产环境推荐配置**

```yaml
################### Filebeat生产环境TLS配置 ####################

filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/*.log
    - /var/log/app/*.log
  
output.elasticsearch:
  hosts: 
    - "https://es-node1.prod.company.com:9200"
    - "https://es-node2.prod.company.com:9200" 
    - "https://es-node3.prod.company.com:9200"
  
  # 认证配置
  username: "${ELASTIC_USERNAME}"    # 使用环境变量
  password: "${ELASTIC_PASSWORD}"
  
  # TLS安全配置
  ssl:
    enabled: true
    verification_mode: full          # 完整验证
    certificate_authorities:
      - "/etc/filebeat/ssl/ca.crt"
    
    # 高级安全选项
    supported_protocols: ["TLSv1.2", "TLSv1.3"]
    curve_types: ["P-521", "P-384", "P-256"]
    
  # 性能优化
  bulk_max_size: 3200
  worker: 2
  compression_level: 3
  
# 日志配置
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644

# 监控配置
monitoring.enabled: true
```

---

## 6. 🛡️ 安全配置清单


### 6.1 基础安全检查


**📋 必做安全检查项**

```
🔸 网络安全检查
├─ [ ] 防火墙规则：只允许必要端口通信
├─ [ ] 网络隔离：使用VPN或专网
└─ [ ] IP白名单：限制连接来源

🔸 证书安全检查  
├─ [ ] 证书来源：使用可信CA签发
├─ [ ] 有效期：确保证书未过期
├─ [ ] 私钥保护：设置严格文件权限
└─ [ ] 定期更新：建立证书轮换机制

🔸 配置安全检查
├─ [ ] 密码管理：使用环境变量存储
├─ [ ] 最小权限：只开放必要功能
├─ [ ] 日志审计：记录连接尝试
└─ [ ] 定期检查：监控异常连接
```

### 6.2 权限控制策略


**🎯 分层权限设计**

| 层级 | 组件 | 权限范围 | 配置要点 |
|------|------|----------|----------|
| **系统层** | 操作系统 | 文件访问权限 | 用户组、文件权限 |
| **网络层** | 防火墙/VPN | 网络访问控制 | 端口、IP限制 |
| **应用层** | Elasticsearch | 索引操作权限 | 用户角色、API权限 |
| **数据层** | 索引/字段 | 数据读写权限 | 字段级别控制 |

### 6.3 环境变量安全配置


**🔒 敏感信息保护方案**

```bash
# 创建环境变量文件
sudo cat > /etc/filebeat/elastic.env << 'EOF'
ELASTIC_USERNAME=filebeat_user
ELASTIC_PASSWORD=your_secure_password_here
ELASTIC_CA_PATH=/etc/filebeat/ssl/ca.crt
EOF

# 设置安全权限
sudo chmod 600 /etc/filebeat/elastic.env
sudo chown root:filebeat /etc/filebeat/elastic.env
```

**在systemd服务中使用：**

```bash
# 编辑服务文件
sudo systemctl edit filebeat

# 添加环境变量配置
[Service]
EnvironmentFile=/etc/filebeat/elastic.env
```

---

## 7. 🔧 常见问题排查


### 7.1 连接问题诊断


**🚨 常见错误及解决方案**

**错误1：证书验证失败**
```
ERROR: x509: certificate signed by unknown authority
```

**🔍 排查步骤：**
```bash
# 1. 检查CA证书路径
ls -la /etc/filebeat/ssl/ca.crt

# 2. 验证CA证书内容
openssl x509 -in /etc/filebeat/ssl/ca.crt -text -noout

# 3. 检查配置文件路径
grep -A 5 "certificate_authorities" /etc/filebeat/filebeat.yml
```

**✅ 解决方案：**
- 确认CA证书路径正确
- 验证CA证书是签发服务器证书的同一个CA
- 考虑临时使用 `verification_mode: none` 测试连通性

**错误2：主机名不匹配**
```
ERROR: x509: certificate is valid for elasticsearch.local, not es-host.company.com
```

**🔍 排查步骤：**
```bash
# 查看证书中的主机名信息
openssl x509 -in server.crt -text -noout | grep -A 1 "Subject Alternative Name"
```

**✅ 解决方案：**
- 使用证书中包含的正确主机名
- 重新生成包含正确主机名的证书
- 临时使用 `verification_mode: certificate`

### 7.2 性能问题排查


**📊 TLS性能影响分析**

```
性能对比测试结果:
┌─────────────────┬─────────────┬─────────────┬──────────────┐
│ 传输方式        │ 吞吐量      │ CPU使用率   │ 延迟         │
├─────────────────┼─────────────┼─────────────┼──────────────┤
│ 明文HTTP        │ 100%       │ 基准线      │ 基准线       │
│ TLS 1.2        │ 85-90%     │ +15-20%     │ +2-5ms       │
│ TLS 1.3        │ 90-95%     │ +10-15%     │ +1-3ms       │
└─────────────────┴─────────────┴─────────────┴──────────────┘
```

**⚡ 性能优化建议：**

```yaml
# 优化TLS性能的配置
output.elasticsearch:
  ssl:
    # 使用更高效的TLS版本
    supported_protocols: ["TLSv1.3"]
    
    # 优化加密套件选择
    cipher_suites:
      - "TLS_AES_256_GCM_SHA384"        # TLS 1.3推荐
      - "TLS_CHACHA20_POLY1305_SHA256"   # 移动设备友好
    
    # 启用会话复用
    renegotiation: "freely"
  
  # 批量发送优化
  bulk_max_size: 5000      # 增大批次减少连接开销
  compression_level: 1     # 降低压缩级别
```

### 7.3 调试工具使用


**🛠️ 网络调试命令**

```bash
# 1. 测试TLS连接
openssl s_client -connect es-host:9200 -servername es-host

# 2. 查看证书链
echo | openssl s_client -connect es-host:9200 -showcerts

# 3. 检查支持的TLS版本
nmap --script ssl-enum-ciphers -p 9200 es-host

# 4. 抓包分析
sudo tcpdump -i any -w tls-debug.pcap host es-host and port 9200
```

---

## 8. 💡 最佳实践建议


### 8.1 证书管理最佳实践


**🔄 证书生命周期管理**

```
证书管理流程图:
申请证书 → 部署证书 → 监控过期 → 续期证书 → 更新部署
    ↑                                           ↓
    └─────────────── 自动化轮换 ←─────────────────┘
```

**📅 证书管理时间表**

| 阶段 | 提前时间 | 动作项目 | 责任人 |
|------|----------|----------|--------|
| **预警** | 30天前 | 发送过期提醒邮件 | 系统自动 |
| **准备** | 15天前 | 申请新证书 | 运维工程师 |
| **测试** | 7天前 | 在测试环境验证 | 开发团队 |
| **部署** | 3天前 | 生产环境更新 | 运维团队 |

### 8.2 监控与告警配置


**📊 关键监控指标**

```yaml
# 在Elasticsearch中创建监控查询
GET filebeat-*/_search
{
  "query": {
    "bool": {
      "must": [
        { "range": { "@timestamp": { "gte": "now-5m" } } },
        { "exists": { "field": "tls.cipher" } }
      ]
    }
  },
  "aggs": {
    "tls_versions": {
      "terms": { "field": "tls.version" }
    },
    "connection_errors": {
      "filter": { "match": { "log.level": "ERROR" } }
    }
  }
}
```

**🚨 告警规则建议**

- **证书即将过期**：提前30天告警
- **TLS握手失败**：5分钟内失败率>5%
- **连接超时**：平均响应时间>10秒
- **异常IP连接**：来自非白名单IP的连接尝试

### 8.3 安全加固建议


**🛡️ 多层防护策略**

```
安全防护层次结构:
┌─────────────────────────────────────────┐
│ 第4层：应用层安全 (Elasticsearch RBAC)   │
├─────────────────────────────────────────┤  
│ 第3层：传输层安全 (TLS加密)              │
├─────────────────────────────────────────┤
│ 第2层：网络层安全 (VPN/防火墙)           │
├─────────────────────────────────────────┤
│ 第1层：物理层安全 (机房/服务器)          │
└─────────────────────────────────────────┘
```

**🔒 配置加固清单**

- [ ] **禁用弱加密算法**
  ```yaml
  ssl:
    cipher_suites:
      # 禁用这些弱算法
      # - "TLS_RSA_WITH_RC4_128_SHA"
      # - "TLS_RSA_WITH_3DES_EDE_CBC_SHA"
  ```

- [ ] **启用完美前向保密**
  ```yaml
  ssl:
    curve_types: ["P-256", "P-384", "P-521"]  # 支持椭圆曲线
  ```

- [ ] **配置连接限制**
  ```yaml
  output.elasticsearch:
    max_retries: 3
    timeout: 30s
    backoff.init: 1s
    backoff.max: 60s
  ```

### 8.4 故障恢复预案


**🚑 应急响应流程**

```
故障类型判断:
├─ 证书过期
│   └─ 紧急更新证书 + 重启服务
├─ 网络中断  
│   └─ 检查网络连通性 + 备用路径
├─ 服务器故障
│   └─ 切换备用节点 + 数据同步
└─ 配置错误
    └─ 回滚配置 + 验证功能
```

**📋 故障恢复检查清单**

1. **立即响应** (5分钟内)
   - [ ] 确认故障范围和影响
   - [ ] 启动应急预案
   - [ ] 通知相关人员

2. **快速恢复** (30分钟内)  
   - [ ] 执行回滚或修复操作
   - [ ] 验证服务恢复正常
   - [ ] 确认数据完整性

3. **根因分析** (24小时内)
   - [ ] 分析故障原因
   - [ ] 制定预防措施
   - [ ] 更新运维文档

---

## 🎯 核心要点总结


### 学习重点回顾


**🔑 关键概念掌握**
- **TLS加密传输**：保护日志数据在网络中的安全
- **证书验证机制**：确保通信双方身份可信
- **配置验证方法**：通过测试确保配置正确有效
- **故障排查思路**：系统化诊断和解决问题

**⚙️ 实践技能要求**
- 能够独立配置Filebeat的TLS加密
- 掌握证书文件的管理和权限设置
- 具备基本的网络安全排查能力
- 建立完整的监控和告警机制

**🛡️ 安全意识培养**
- 理解加密传输在日志收集中的重要性
- 掌握证书生命周期管理方法
- 建立多层防护的安全思维
- 形成定期安全检查的习惯

> 💡 **新手总结**
> 
> TLS加密配置看似复杂，但本质就是给数据传输加了一把"锁"。记住三个关键点：**证书要对**、**配置要准**、**权限要严**。从简单配置开始，逐步加强安全等级，这样既保证了安全性，又便于后期维护。

**下一步学习建议：**
- 实际配置一套完整的TLS环境
- 练习证书更新和轮换操作  
- 学习更高级的安全策略配置