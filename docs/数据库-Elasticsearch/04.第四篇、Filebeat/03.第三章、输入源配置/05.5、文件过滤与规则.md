---
title: 5、文件过滤与规则
---
## 📚 目录

1. [过滤规则概述](#1-过滤规则概述)
2. [内容过滤规则](#2-内容过滤规则)
3. [文件过滤规则](#3-文件过滤规则)
4. [正则表达式应用](#4-正则表达式应用)
5. [实战配置案例](#5-实战配置案例)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 过滤规则概述


### 1.1 什么是文件过滤


**📋 简单理解**
想象你在整理一堆文件，你只想要某些特定的文件，或者想排除一些不需要的文件。Filebeat的过滤功能就像是一个智能助手，帮你自动筛选出需要的日志内容。

```
现实场景类比：
📂 日志文件夹
├── app.log          ← 想要收集
├── error.log        ← 想要收集  
├── debug.log        ← 不想收集（太多噪音）
├── temp.log         ← 不想收集（临时文件）
└── backup.log       ← 不想收集（备份文件）

Filebeat过滤 = 智能筛选器
```

### 1.2 过滤的两个维度


**🔸 按文件筛选**：决定读取哪些文件
- `exclude_files`：排除不想读的文件
- 文件名模式匹配

**🔸 按内容筛选**：决定发送哪些日志行
- `include_lines`：只发送匹配的行
- `exclude_lines`：排除匹配的行

### 1.3 为什么需要过滤


**💡 实际价值**
```
节省存储空间：
- 原始日志：1GB/天
- 过滤后：200MB/天
- 节省80%存储成本

提高查询效率：
- 减少无用数据干扰
- 加快搜索速度
- 降低服务器负载

专注重要信息：
- 过滤调试信息
- 突出错误和警告
- 便于问题定位
```

---

## 2. 📝 内容过滤规则


### 2.1 include_lines - 只要我想要的


**🔸 基本概念**
`include_lines`就像一个白名单，只有匹配规则的日志行才会被发送，其他的都被忽略。

**💻 基础语法**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  include_lines: ['^ERROR', '^WARN']
```

**🎯 实际应用场景**

```yaml
# 场景1：只收集错误和警告日志
filebeat.inputs:
- type: log
  paths:
    - /var/log/application.log
  include_lines: 
    - '^ERROR'      # 以ERROR开头的行
    - '^WARN'       # 以WARN开头的行
    - '^FATAL'      # 以FATAL开头的行
```

**📊 效果对比**
```
原始日志内容：
2024-09-21 10:00:01 INFO  应用启动成功
2024-09-21 10:00:05 DEBUG 连接数据库
2024-09-21 10:00:10 ERROR 数据库连接失败
2024-09-21 10:00:15 WARN  内存使用率过高

过滤后发送的内容：
2024-09-21 10:00:10 ERROR 数据库连接失败
2024-09-21 10:00:15 WARN  内存使用率过高
```

### 2.2 exclude_lines - 排除我不要的


**🔸 基本概念**
`exclude_lines`就像一个黑名单，匹配规则的日志行会被丢弃，不会发送到Elasticsearch。

**💻 基础配置**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  exclude_lines: ['^DEBUG', '^TRACE']
```

**🎯 常见排除场景**

```yaml
# 场景1：排除调试和健康检查日志
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/access.log
  exclude_lines:
    - 'GET /health'        # 排除健康检查请求
    - 'GET /favicon.ico'   # 排除图标请求
    - 'spider'             # 排除爬虫请求
    - 'bot'                # 排除机器人请求
```

**⚡ 性能优化示例**
```yaml
# 排除大量无用的调试信息
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  exclude_lines:
    - '^DEBUG'
    - '^TRACE'
    - 'keepalive'
    - 'heartbeat'
```

### 2.3 组合使用技巧


**🔸 先包含后排除**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  # 第一步：只要ERROR和WARN级别
  include_lines: ['^ERROR', '^WARN']
  # 第二步：但是排除测试相关的错误
  exclude_lines: ['test', 'mock']
```

**处理流程图示**
```
原始日志行
    ↓
包含规则过滤 (include_lines)
    ↓
排除规则过滤 (exclude_lines)  
    ↓
最终发送的日志
```

---

## 3. 📁 文件过滤规则


### 3.1 exclude_files - 文件级别过滤


**🔸 基本概念**
如果说`include_lines`和`exclude_lines`是对日志内容的过滤，那么`exclude_files`就是对文件本身的过滤，直接决定哪些文件不读取。

**💻 基础语法**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
  exclude_files: ['debug\.log$', '.*\.tmp$']
```

### 3.2 文件名匹配模式


**🔸 常用匹配规则**

| **模式** | **含义** | **示例** |
|---------|---------|---------|
| `debug\.log$` | 以debug.log结尾 | `app.debug.log` |
| `^temp` | 以temp开头 | `temp.log` |
| `.*\.tmp$` | 以.tmp结尾 | `任何文件.tmp` |
| `backup` | 包含backup | `app.backup.log` |

**🎯 实际应用**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
    - /var/log/app/*.log
  exclude_files:
    - 'debug\.log$'      # 排除调试日志
    - '.*\.tmp$'         # 排除临时文件
    - '.*\.bak$'         # 排除备份文件
    - '^\..*'            # 排除隐藏文件
    - 'test.*\.log$'     # 排除测试日志
```

### 3.3 动态文件过滤


**🔸 基于时间的过滤**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app-*.log
  # 排除昨天之前的日志文件
  exclude_files: ['app-2024-09-1[0-9]\.log$']
```

**🔸 基于环境的过滤**
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
  exclude_files:
    - 'dev-.*\.log$'     # 排除开发环境日志
    - 'staging-.*\.log$' # 排除测试环境日志
```

---

## 4. 🎨 正则表达式应用


### 4.1 正则表达式基础


**🔸 新手友好解释**
正则表达式就像是一个非常灵活的搜索模式，比普通的文本搜索更强大。

```
普通搜索：只能找"ERROR"这个具体词
正则搜索：可以找"以ERROR开头的所有行"
```

### 4.2 常用正则符号


**📋 必掌握符号**

| **符号** | **含义** | **示例** | **匹配结果** |
|---------|---------|---------|-------------|
| `^` | 行的开始 | `^ERROR` | ERROR开头的行 |
| `$` | 行的结束 | `\.log$` | .log结尾的文件 |
| `.*` | 任意字符 | `ERROR.*database` | ERROR...database |
| `\d+` | 数字 | `\d+` | 123, 456 |
| `[0-9]` | 数字范围 | `[0-9]+` | 任意数字 |
| `\|` | 或者 | `ERROR\|WARN` | ERROR或WARN |

### 4.3 实战正则案例


**🎯 日志级别匹配**
```yaml
# 匹配多种日志级别
include_lines: ['^(ERROR|WARN|FATAL|CRITICAL)']
```

**🎯 时间戳过滤**
```yaml
# 只收集特定时间段的日志
include_lines: ['2024-09-21 1[0-2]:[0-9]{2}:[0-9]{2}']
# 解释：2024-09-21 10:xx:xx 到 12:xx:xx 之间的日志
```

**🎯 IP地址过滤**
```yaml
# 排除内网IP的访问日志
exclude_lines: ['192\.168\..*', '10\..*', '127\.0\.0\.1']
```

**🎯 状态码过滤**
```yaml
# 只收集错误状态码
include_lines: [' (4[0-9]{2}|5[0-9]{2}) ']
# 解释：匹配 400-499 和 500-599 状态码
```

### 4.4 正则调试技巧


**💡 测试方法**
```yaml
# 开启调试模式测试正则
logging.level: debug
logging.selectors: ["input"]
```

**🔍 常见错误**
```yaml
# ❌ 错误：忘记转义点号
exclude_files: ['debug.log$']

# ✅ 正确：转义点号  
exclude_files: ['debug\.log$']

# ❌ 错误：忘记行结束符
include_lines: ['ERROR']

# ✅ 正确：明确指定位置
include_lines: ['^ERROR']
```

---

## 5. 🛠️ 实战配置案例


### 5.1 Web服务器日志过滤


**🎯 场景**：Nginx访问日志，只收集错误和重要访问

```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/nginx/access.log
  
  # 包含：错误状态码和大文件请求
  include_lines:
    - ' (4[0-9]{2}|5[0-9]{2}) '     # 4xx, 5xx错误
    - ' (POST|PUT|DELETE) '         # 重要HTTP方法
    - '"[^"]*\.(zip|tar|gz|exe)"'   # 大文件下载
  
  # 排除：健康检查和静态资源
  exclude_lines:
    - 'GET /health'
    - 'GET /ping'  
    - '\.(css|js|png|jpg|ico) '
    - 'spider|bot|crawler'

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "nginx-errors-%{+yyyy.MM.dd}"
```

### 5.2 应用程序日志过滤


**🎯 场景**：Java应用日志，分级收集

```yaml
filebeat.inputs:
# 配置1：错误日志 - 全部收集
- type: log
  paths:
    - /var/log/app/error.log
  fields:
    log_type: "error"
    priority: "high"

# 配置2：应用日志 - 只收集重要级别
- type: log
  paths:
    - /var/log/app/application.log
  include_lines:
    - '^(ERROR|WARN|FATAL)'
  exclude_lines:
    - 'HealthCheck'
    - 'keepalive'
  fields:
    log_type: "application"
    priority: "medium"

# 配置3：访问日志 - 排除正常访问
- type: log
  paths:
    - /var/log/app/access.log
  exclude_lines:
    - ' 200 '
    - ' 301 '
    - ' 304 '
  fields:
    log_type: "access"
    priority: "low"
```

### 5.3 多环境日志过滤


**🎯 场景**：根据环境差异化收集

```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  
  # 排除开发和测试环境的详细日志
  exclude_files:
    - 'dev-.*\.log$'
    - 'test-.*\.log$'
    - '.*\.debug\.log$'
  
  # 生产环境：只收集警告以上级别
  include_lines:
    - '^(WARN|ERROR|FATAL)'
  
  # 排除已知的无害错误
  exclude_lines:
    - 'connection reset by peer'
    - 'timeout.*health.*check'

processors:
- add_fields:
    fields:
      environment: "production"
      datacenter: "aws-east-1"
```

### 5.4 性能优化配置


**🎯 场景**：大流量日志的性能优化

```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/high-traffic/*.log
  
  # 文件级过滤：减少监控文件数
  exclude_files:
    - '.*\.debug\.log$'
    - '.*\.trace\.log$'
    - 'backup-.*'
  
  # 内容过滤：大幅减少传输量
  exclude_lines:
    - '^DEBUG'
    - '^TRACE'
    - 'GET /api/ping'
    - 'OPTIONS /'
  
  # 性能调优
  scan_frequency: 10s
  harvester_buffer_size: 32768
  close_inactive: 5m

# 输出优化
output.elasticsearch:
  hosts: ["es-node1:9200", "es-node2:9200"]
  bulk_max_size: 3200
  flush_interval: 5s
```

---

## 6. 📋 核心要点总结


### 6.1 必掌握概念


```
🔸 内容过滤：决定发送哪些日志行
  • include_lines：白名单，只要匹配的
  • exclude_lines：黑名单，排除匹配的
  
🔸 文件过滤：决定读取哪些文件  
  • exclude_files：排除不需要的文件
  
🔸 正则表达式：灵活的模式匹配工具
  • 基本符号：^ $ . * + [0-9]
  • 实际应用：日志级别、时间、IP过滤
```

### 6.2 最佳实践


**🎯 过滤策略**
```
优先级排序：
1. 文件过滤 (exclude_files) - 减少监控文件
2. 内容包含 (include_lines) - 明确要什么  
3. 内容排除 (exclude_lines) - 去掉不要的

性能考虑：
• 文件过滤比内容过滤效率更高
• 简单字符串匹配比复杂正则更快
• 组合使用效果最佳
```

**⚠️ 常见误区**
```
❌ 过度过滤：丢失重要信息
❌ 正则过复杂：影响性能
❌ 只用排除不用包含：逻辑不清晰
❌ 忘记转义特殊字符：匹配失效

✅ 正确做法：
• 明确过滤目标
• 测试正则表达式
• 监控过滤效果
• 定期审查规则
```

### 6.3 故障排查


**🔍 调试方法**
```yaml
# 开启详细日志
logging.level: debug
logging.selectors: ["input", "harvester"]

# 测试模式
output.console:
  enabled: true
  pretty: true
```

**📊 监控指标**
- 原始日志量 vs 过滤后日志量
- 过滤规则命中率
- 系统资源使用情况

**核心记忆**：
- 过滤是为了提高效率，不是为了复杂
- 文件过滤 + 内容过滤 = 完美组合
- 简单规则比复杂正则更可靠
- 测试验证比盲目配置更重要