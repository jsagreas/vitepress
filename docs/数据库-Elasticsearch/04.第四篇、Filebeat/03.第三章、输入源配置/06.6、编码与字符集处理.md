---
title: 6ã€ç¼–ç ä¸å­—ç¬¦é›†å¤„ç†
---
## ğŸ“š ç›®å½•

1. [ç¼–ç åŸºç¡€æ¦‚å¿µ](#1-ç¼–ç åŸºç¡€æ¦‚å¿µ)
2. [Filebeatç¼–ç é…ç½®](#2-Filebeatç¼–ç é…ç½®)
3. [å¸¸è§ç¼–ç é—®é¢˜ä¸è§£å†³](#3-å¸¸è§ç¼–ç é—®é¢˜ä¸è§£å†³)
4. [å­—ç¬¦é›†è‡ªåŠ¨æ£€æµ‹](#4-å­—ç¬¦é›†è‡ªåŠ¨æ£€æµ‹)
5. [å¤šå­—èŠ‚å­—ç¬¦å¤„ç†](#5-å¤šå­—èŠ‚å­—ç¬¦å¤„ç†)
6. [BOMæ ‡è®°å¤„ç†](#6-BOMæ ‡è®°å¤„ç†)
7. [å®æˆ˜é…ç½®æ¡ˆä¾‹](#7-å®æˆ˜é…ç½®æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“– ç¼–ç åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ–‡ä»¶ç¼–ç 


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å†™äº†ä¸€å°ä¸­æ–‡ä¿¡ï¼Œä½†æ”¶ä¿¡äººæ˜¯å¤–å›½äººã€‚ä½ éœ€è¦å‘Šè¯‰ä»–è¿™å°ä¿¡ç”¨çš„æ˜¯ä»€ä¹ˆ"è¯­è¨€è§„åˆ™"ï¼Œä»–æ‰èƒ½æ­£ç¡®ç†è§£å†…å®¹ã€‚

```
æ–‡ä»¶ç¼–ç å°±åƒæ˜¯"ç¿»è¯‘è§„åˆ™ä¹¦"ï¼š
åŸå§‹æ–‡å­— â†’ ç¼–ç è§„åˆ™ â†’ è®¡ç®—æœºå­˜å‚¨ â†’ è§£ç è§„åˆ™ â†’ æ˜¾ç¤ºæ–‡å­—

å¦‚æœç¼–ç å’Œè§£ç ç”¨çš„è§„åˆ™ä¸ä¸€æ ·ï¼Œå°±ä¼šå‡ºç°ä¹±ç ï¼
```

**ç¼–ç çš„æœ¬è´¨ä½œç”¨**ï¼š
- ğŸ”¤ **å­—ç¬¦æ˜ å°„**ï¼šå‘Šè¯‰è®¡ç®—æœºæ¯ä¸ªå­—ç¬¦å¯¹åº”ä»€ä¹ˆæ•°å­—
- ğŸ’¾ **å­˜å‚¨æ ¼å¼**ï¼šå†³å®šæ–‡å­—åœ¨ç¡¬ç›˜ä¸Šæ€ä¹ˆä¿å­˜
- ğŸ“– **è¯»å–è§„åˆ™**ï¼šå‘Šè¯‰ç¨‹åºç”¨ä»€ä¹ˆæ–¹å¼ç†è§£æ–‡ä»¶å†…å®¹

### 1.2 å¸¸è§ç¼–ç ç±»å‹è¯¦è§£


**ğŸŒ ä¸»æµç¼–ç å¯¹æ¯”**ï¼š

| ç¼–ç ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ç‰¹ç‚¹** | **ä¼˜ç¼ºç‚¹** |
|---------|------------|---------|-----------|
| **UTF-8** | `å›½é™…åŒ–åº”ç”¨` | `å¯å˜é•¿åº¦ï¼Œæ”¯æŒå…¨çƒå­—ç¬¦` | `âœ…é€šç”¨æ€§å¼º âŒå ç”¨ç¨å¤§` |
| **GBK** | `ä¸­æ–‡ç³»ç»Ÿ` | `åŒå­—èŠ‚ä¸­æ–‡ç¼–ç ` | `âœ…ä¸­æ–‡é«˜æ•ˆ âŒå›½é™…åŒ–å·®` |
| **ASCII** | `çº¯è‹±æ–‡ç¯å¢ƒ` | `å•å­—èŠ‚è‹±æ–‡æ•°å­—` | `âœ…é€Ÿåº¦å¿« âŒåªæ”¯æŒè‹±æ–‡` |
| **ISO-8859-1** | `è¥¿æ¬§è¯­è¨€` | `å•å­—èŠ‚è¥¿æ¬§å­—ç¬¦` | `âœ…å…¼å®¹æ€§å¥½ âŒä¸­æ–‡ä¹±ç ` |

### 1.3 ç¼–ç é—®é¢˜çš„è¡¨ç°


**å¸¸è§ä¹±ç ç°è±¡**ï¼š
```
åŸæ–‡ï¼šä½ å¥½ä¸–ç•Œ
UTF-8é”™è¯»æˆGBKï¼šæµ£çŠ²ã‚½æ¶“æ «æ™«
GBKé”™è¯»æˆUTF-8ï¼š?å¥½ä¸–ç•Œï¼ˆé—®å·ä»£è¡¨æ— æ³•è¯†åˆ«ï¼‰
ASCIIé”™è¯»ä¸­æ–‡ï¼š??????ï¼ˆå…¨æ˜¯é—®å·ï¼‰
```

**ä¸ºä»€ä¹ˆä¼šä¹±ç **ï¼š
- ğŸ“ **å†™å…¥ç¼–ç ** â‰  **è¯»å–ç¼–ç **
- ğŸ”„ **ç¼–ç è§„åˆ™ä¸åŒ¹é…**
- ğŸ’¿ **æ–‡ä»¶æœ¬èº«ç¼–ç æŸå**

---

## 2. âš™ï¸ Filebeatç¼–ç é…ç½®


### 2.1 åŸºç¡€ç¼–ç è®¾ç½®


**æ ¸å¿ƒé…ç½®å‚æ•°**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  encoding: utf-8          # æŒ‡å®šæ–‡ä»¶ç¼–ç 
```

**ç¼–ç é…ç½®çš„ä½œç”¨æœºåˆ¶**ï¼š
```
æ–‡ä»¶è¯»å–æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå§‹æ–‡ä»¶    â”‚â”€â”€â”€â–¶â”‚  ç¼–ç è½¬æ¢     â”‚â”€â”€â”€â–¶â”‚  æ ‡å‡†æ ¼å¼    â”‚
â”‚ (GBK/UTF-8) â”‚    â”‚ (æŒ‰é…ç½®å¤„ç†)  â”‚    â”‚ (ç»Ÿä¸€UTF-8) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†é…ç½®é€‰é¡¹


**ğŸ”§ å®Œæ•´ç¼–ç é…ç½®ç¤ºä¾‹**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /app/logs/*.log
  
  # ç¼–ç ç›¸å…³é…ç½®
  encoding: utf-8                    # æ–‡ä»¶åŸå§‹ç¼–ç 
  
  # ç¼–ç æ£€æµ‹é…ç½®
  encoding.auto_detect: true         # æ˜¯å¦è‡ªåŠ¨æ£€æµ‹ç¼–ç 
  encoding.fallback: gbk             # æ£€æµ‹å¤±è´¥æ—¶çš„å¤‡ç”¨ç¼–ç 
  
  # å­—ç¬¦å¤„ç†é…ç½®
  ignore_older: 24h                  # å¿½ç•¥24å°æ—¶å‰çš„æ–‡ä»¶
  close_inactive: 5m                 # 5åˆ†é’Ÿæ— æ´»åŠ¨å…³é—­æ–‡ä»¶
```

**ğŸ’¡ é…ç½®å‚æ•°è¯¦è§£**ï¼š

- **encoding**: æ˜ç¡®æŒ‡å®šæ–‡ä»¶ç¼–ç ç±»å‹
- **encoding.auto_detect**: è®©Filebeatè‡ªåŠ¨åˆ¤æ–­ç¼–ç 
- **encoding.fallback**: è‡ªåŠ¨æ£€æµ‹å¤±è´¥æ—¶ä½¿ç”¨çš„é»˜è®¤ç¼–ç 

### 2.3 ç¼–ç é…ç½®æœ€ä½³å®è·µ


**ğŸ¯ é€‰æ‹©ç¼–ç çš„åŸºæœ¬åŸåˆ™**ï¼š

```
åˆ¤æ–­ä¾æ®ï¼š
1. çœ‹æ—¥å¿—æ¥æºç³»ç»Ÿ
   - Linuxç³»ç»Ÿ â†’ é€šå¸¸æ˜¯UTF-8
   - Windowsç³»ç»Ÿ â†’ å¯èƒ½æ˜¯GBKæˆ–UTF-8
   - è€æ—§ç³»ç»Ÿ â†’ å¯èƒ½æ˜¯ASCIIæˆ–ISO-8859-1

2. çœ‹æ—¥å¿—å†…å®¹è¯­è¨€
   - çº¯è‹±æ–‡æ•°å­— â†’ ASCIIè¶³å¤Ÿ
   - åŒ…å«ä¸­æ–‡ â†’ UTF-8æˆ–GBK
   - å¤šå›½è¯­è¨€ â†’ å¿…é¡»UTF-8

3. çœ‹æ–‡ä»¶å¤§å°å’Œæ€§èƒ½
   - å¤§é‡æ—¥å¿— â†’ è€ƒè™‘æ€§èƒ½ï¼Œé€‰åˆé€‚ç¼–ç 
   - å°‘é‡æ—¥å¿— â†’ ä¼˜å…ˆå…¼å®¹æ€§ï¼Œé€‰UTF-8
```

---

## 3. ğŸ”§ å¸¸è§ç¼–ç é—®é¢˜ä¸è§£å†³


### 3.1 ä¹±ç é—®é¢˜è¯Šæ–­


**ğŸ” å¿«é€Ÿè¯Šæ–­æ–¹æ³•**ï¼š

**æ­¥éª¤1ï¼šæ£€æŸ¥åŸå§‹æ–‡ä»¶ç¼–ç **
```bash
# ä½¿ç”¨fileå‘½ä»¤æ£€æŸ¥æ–‡ä»¶ç¼–ç 
file -i /var/log/app.log
# è¾“å‡ºï¼š/var/log/app.log: text/plain; charset=utf-8

# ä½¿ç”¨hexdumpæŸ¥çœ‹æ–‡ä»¶å¤´éƒ¨å­—èŠ‚
hexdump -C /var/log/app.log | head -3
```

**æ­¥éª¤2ï¼šéªŒè¯Filebeaté…ç½®**
```yaml
# åœ¨é…ç½®ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  encoding: utf-8
  
# å¯ç”¨è°ƒè¯•æ—¥å¿—
logging.level: debug
logging.to_files: true
```

**æ­¥éª¤3ï¼šè§‚å¯Ÿè¾“å‡ºç»“æœ**
```bash
# æŸ¥çœ‹Filebeatæ—¥å¿—ä¸­çš„ç¼–ç ä¿¡æ¯
tail -f /var/log/filebeat/filebeat.log | grep -i encoding
```

### 3.2 å…¸å‹ä¹±ç åœºæ™¯è§£å†³


**ğŸš¨ åœºæ™¯1ï¼šä¸­æ–‡æ—¥å¿—å˜æˆé—®å·**

**é—®é¢˜è¡¨ç°**ï¼š
```
åŸå§‹æ—¥å¿—ï¼š2025-01-01 ç”¨æˆ·ç™»å½•æˆåŠŸ
æ˜¾ç¤ºç»“æœï¼š2025-01-01 ????
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/chinese.log
  encoding: gbk              # æ”¹ä¸ºGBKç¼–ç 
  
  # æˆ–è€…å¯ç”¨è‡ªåŠ¨æ£€æµ‹
  encoding.auto_detect: true
  encoding.fallback: gbk
```

**ğŸš¨ åœºæ™¯2ï¼šè‹±æ–‡æ­£å¸¸ï¼Œä¸­æ–‡ä¹±ç **

**é—®é¢˜åˆ†æ**ï¼šæ–‡ä»¶å¯èƒ½æ··åˆç¼–ç æˆ–è€…ç¼–ç ä¸ç»Ÿä¸€

**è§£å†³æ–¹æ¡ˆ**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/mixed.log
  encoding: utf-8
  
  # æ·»åŠ å¤šè¡Œå¤„ç†ï¼Œé˜²æ­¢ç¼–ç åˆ‡æ¢
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
```

### 3.3 ç¼–ç è½¬æ¢ç­–ç•¥


**ğŸ”„ ç¼–ç è½¬æ¢æµç¨‹è®¾è®¡**ï¼š

```
è½¬æ¢ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸæ–‡ä»¶     â”‚â”€â”€â”€â–¶â”‚  æ£€æµ‹ç¼–ç     â”‚â”€â”€â”€â–¶â”‚  è½¬æ¢å¤„ç†    â”‚
â”‚  (æœªçŸ¥ç¼–ç )  â”‚    â”‚  (è‡ªåŠ¨è¯†åˆ«)  â”‚    â”‚  (ç»Ÿä¸€UTF-8) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
  å¤šç§å¯èƒ½æ€§          å‡†ç¡®ç‡90%           è¾“å‡ºæ ‡å‡†åŒ–
```

**å®ç”¨è½¬æ¢é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app*.log
  
  # å¤šå±‚æ£€æµ‹ç­–ç•¥
  encoding.auto_detect: true
  encoding.fallback: utf-8
  
  # å¤„ç†å¤±è´¥æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ
  processors:
  - if:
      contains:
        message: "???"
    then:
    - add_tags:
        tags: ["encoding_error"]
```

---

## 4. ğŸ¯ å­—ç¬¦é›†è‡ªåŠ¨æ£€æµ‹


### 4.1 è‡ªåŠ¨æ£€æµ‹æœºåˆ¶


**å·¥ä½œåŸç†**ï¼š
```
è‡ªåŠ¨æ£€æµ‹æµç¨‹ï¼š
æ–‡ä»¶å¼€å¤´ â†’ è¯»å–æ ·æœ¬ â†’ åˆ†æç‰¹å¾ â†’ æ¨æ–­ç¼–ç  â†’ éªŒè¯å‡†ç¡®æ€§
   â†“           â†“         â†“         â†“         â†“
 å‰1KB     å­—èŠ‚æ¨¡å¼   ç»Ÿè®¡åˆ†æ   æœ€ä½³åŒ¹é…   ç¡®è®¤ç»“æœ
```

**ğŸ” æ£€æµ‹ä¾æ®**ï¼š
- **å­—èŠ‚åºåˆ—æ¨¡å¼**ï¼šä¸åŒç¼–ç æœ‰ç‰¹å®šçš„å­—èŠ‚ç»„åˆè§„å¾‹
- **å­—ç¬¦é¢‘ç‡åˆ†æ**ï¼šç»Ÿè®¡å¸¸è§å­—ç¬¦å‡ºç°é¢‘ç‡
- **BOMæ ‡è®°æ£€æŸ¥**ï¼šæ–‡ä»¶å¼€å¤´çš„ç¼–ç æ ‡è¯†
- **è¯­è¨€ç‰¹å¾è¯†åˆ«**ï¼šæ ¹æ®å†…å®¹æ¨æ–­è¯­è¨€ç±»å‹

### 4.2 è‡ªåŠ¨æ£€æµ‹é…ç½®


**åŸºç¡€è‡ªåŠ¨æ£€æµ‹**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
  
  # å¯ç”¨è‡ªåŠ¨æ£€æµ‹
  encoding.auto_detect: true
  
  # è®¾ç½®å¤‡ç”¨ç¼–ç ï¼ˆæ£€æµ‹å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
  encoding.fallback: utf-8
  
  # æ£€æµ‹æ ·æœ¬å¤§å°ï¼ˆå¯é€‰ï¼‰
  encoding.sample_size: 1024     # è¯»å–å‰1KBè¿›è¡Œæ£€æµ‹
```

**é«˜çº§æ£€æµ‹é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /app/logs/mixed/*.log
  
  # å¤šé‡æ£€æµ‹ç­–ç•¥
  encoding.auto_detect: true
  encoding.fallback: gbk
  
  # ç½®ä¿¡åº¦è®¾ç½®
  encoding.confidence_threshold: 0.8  # æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
  
  # æ£€æµ‹è¶…æ—¶
  encoding.detection_timeout: 5s      # 5ç§’æ£€æµ‹è¶…æ—¶
```

### 4.3 æ£€æµ‹å‡†ç¡®æ€§ä¼˜åŒ–


**ğŸ“Š æé«˜æ£€æµ‹å‡†ç¡®ç‡çš„æ–¹æ³•**ï¼š

| ä¼˜åŒ–ç­–ç•¥ | **å®ç°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-------------|
| **å¢å¤§æ ·æœ¬** | `sample_size: 4096` | `æ–‡ä»¶å¼€å¤´ç¼–ç å¯èƒ½æ··åˆ` |
| **è®¾ç½®é˜ˆå€¼** | `confidence_threshold: 0.9` | `è¦æ±‚é«˜ç²¾åº¦æ£€æµ‹` |
| **å¤šé‡éªŒè¯** | `ç»“åˆäººå·¥éªŒè¯` | `é‡è¦ä¸šåŠ¡æ—¥å¿—` |
| **åˆ†ç±»å¤„ç†** | `ä¸åŒç›®å½•ä¸åŒç­–ç•¥` | `å¤šæºæ—¥å¿—ç³»ç»Ÿ` |

**å®é™…æ£€æµ‹æ•ˆæœéªŒè¯**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶éªŒè¯æ£€æµ‹æ•ˆæœ
echo "æµ‹è¯•ä¸­æ–‡UTF-8" > /tmp/test_utf8.log
echo "æµ‹è¯•ä¸­æ–‡GBK" | iconv -f utf-8 -t gbk > /tmp/test_gbk.log

# é…ç½®Filebeatæµ‹è¯•è‡ªåŠ¨æ£€æµ‹
filebeat test config -c /etc/filebeat/filebeat.yml
```

---

## 5. ğŸˆ¯ å¤šå­—èŠ‚å­—ç¬¦å¤„ç†


### 5.1 å¤šå­—èŠ‚å­—ç¬¦æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å¤šå­—èŠ‚å­—ç¬¦**ï¼š
```
å•å­—èŠ‚å­—ç¬¦ï¼šAã€Bã€1ã€2ï¼ˆæ¯ä¸ªå­—ç¬¦å 1ä¸ªå­—èŠ‚ï¼‰
å¤šå­—èŠ‚å­—ç¬¦ï¼šä¸­ã€æ–‡ã€æ±‰ã€å­—ï¼ˆæ¯ä¸ªå­—ç¬¦å 2-4ä¸ªå­—èŠ‚ï¼‰

å­˜å‚¨å¯¹æ¯”ï¼š
è‹±æ–‡ "Hello" â†’ 5å­—èŠ‚
ä¸­æ–‡ "ä½ å¥½"   â†’ 6å­—èŠ‚ï¼ˆUTF-8ï¼‰æˆ– 4å­—èŠ‚ï¼ˆGBKï¼‰
```

**å¤šå­—èŠ‚å­—ç¬¦çš„æŒ‘æˆ˜**ï¼š
- ğŸ”ª **å­—ç¬¦åˆ‡å‰²**ï¼šæ—¥å¿—è½®è½¬æ—¶å¯èƒ½åˆ‡æ–­å­—ç¬¦
- ğŸ“ **é•¿åº¦è®¡ç®—**ï¼šå­—ç¬¦æ•°â‰ å­—èŠ‚æ•°
- ğŸ”„ **ç¼–ç è½¬æ¢**ï¼šä¸åŒç¼–ç å­—èŠ‚é•¿åº¦ä¸åŒ

### 5.2 å¤šå­—èŠ‚å­—ç¬¦é…ç½®


**é˜²æ­¢å­—ç¬¦åˆ‡å‰²é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/chinese.log
  encoding: utf-8
  
  # å¤šå­—èŠ‚å­—ç¬¦ä¿æŠ¤
  max_bytes: 10485760           # 10MBæœ€å¤§è¯»å–
  buffer_size: 16384            # 16KBç¼“å†²åŒº
  
  # å­—ç¬¦è¾¹ç•Œä¿æŠ¤
  close_on_rename: true         # æ–‡ä»¶é‡å‘½åæ—¶å…³é—­
  scan_frequency: 1s            # 1ç§’æ‰«æé¢‘ç‡
```

**å­—ç¬¦å®Œæ•´æ€§ä¿éšœ**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app.log
  encoding: utf-8
  
  # ç¡®ä¿å­—ç¬¦å®Œæ•´æ€§
  harvester_limit: 0            # ä¸é™åˆ¶harvesteræ•°é‡
  close_inactive: 5m            # 5åˆ†é’Ÿæ— æ´»åŠ¨å…³é—­
  close_renamed: false          # é‡å‘½åæ—¶ä¸ç«‹å³å…³é—­
  
  # å¤šè¡Œå¤„ç†ä¿æŠ¤
  multiline.pattern: '^[\d\-\s:]+'
  multiline.negate: true
  multiline.match: after
```

### 5.3 å¤„ç†ç­–ç•¥æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å¤šå­—èŠ‚å­—ç¬¦ä¿æŠ¤ç­–ç•¥**ï¼š

```
ä¿æŠ¤æœºåˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­—ç¬¦æ£€æµ‹    â”‚â”€â”€â”€â–¶â”‚  è¾¹ç•Œè¯†åˆ«    â”‚â”€â”€â”€â–¶â”‚  å®Œæ•´è¯»å–    â”‚
â”‚ (å¤šå­—èŠ‚è¯†åˆ«) â”‚    â”‚ (å­—ç¬¦è¾¹ç•Œ)   â”‚    â”‚ (é¿å…åˆ‡å‰²)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç”¨é…ç½®æ¨¡æ¿**ï¼š
```yaml
# ä¸­æ–‡æ—¥å¿—ä¼˜åŒ–é…ç½®
filebeat.inputs:
- type: log
  paths:
    - /var/log/chinese/*.log
  encoding: utf-8
  
  # æ€§èƒ½ä¸å‡†ç¡®æ€§å¹³è¡¡
  max_bytes: 1048576            # 1MBå•è¡Œé™åˆ¶
  buffer_size: 65536            # 64KBç¼“å†²åŒº
  backoff: 1s                   # 1ç§’é€€é¿æ—¶é—´
  max_backoff: 10s              # æœ€å¤§10ç§’é€€é¿
  
  # å­—ç¬¦å¤„ç†å¢å¼º
  ignore_older: 2h              # å¿½ç•¥2å°æ—¶å‰æ–‡ä»¶
  scan_frequency: 2s            # 2ç§’æ‰«æä¸€æ¬¡
```

---

## 6. ğŸ“ BOMæ ‡è®°å¤„ç†


### 6.1 BOMæ ‡è®°æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯BOM**ï¼š
```
BOM = Byte Order Markï¼ˆå­—èŠ‚åºæ ‡è®°ï¼‰
ä½œç”¨ï¼šå‘Šè¯‰ç¨‹åºæ–‡ä»¶ç”¨ä»€ä¹ˆç¼–ç ä¿å­˜

å¸¸è§BOMæ ‡è®°ï¼š
UTF-8 BOM:    EF BB BF
UTF-16 LE:    FF FE  
UTF-16 BE:    FE FF
UTF-32 LE:    FF FE 00 00
```

**BOMçš„å½±å“**ï¼š
- âœ… **æœ‰åˆ©**ï¼šæ˜ç¡®æ ‡è¯†æ–‡ä»¶ç¼–ç 
- âŒ **é—®é¢˜**ï¼šå¯èƒ½å½±å“æ–‡æœ¬è§£æï¼Œåœ¨å†…å®¹å¼€å¤´äº§ç”Ÿä¹±ç 

### 6.2 BOMæ£€æµ‹ä¸å¤„ç†


**BOMæ£€æµ‹é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/with_bom.log
  encoding: utf-8
  
  # BOMå¤„ç†é…ç½®
  encoding.ignore_bom: false    # ä¸å¿½ç•¥BOMï¼ˆé»˜è®¤ï¼‰
  encoding.strip_bom: true      # å»é™¤BOMæ ‡è®°
```

**æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰BOM**ï¼š
```bash
# ä½¿ç”¨hexdumpæŸ¥çœ‹æ–‡ä»¶å¼€å¤´
hexdump -C /var/log/test.log | head -1

# å¦‚æœçœ‹åˆ° "ef bb bf" å°±è¡¨ç¤ºæœ‰UTF-8 BOM
# 00000000  ef bb bf 32 30 32 35  |...2025|
```

### 6.3 BOMå¤„ç†ç­–ç•¥


**ğŸ”§ ä¸åŒåœºæ™¯çš„BOMå¤„ç†**ï¼š

| åœºæ™¯ | **BOMå¤„ç†ç­–ç•¥** | **é…ç½®å»ºè®®** |
|------|---------------|-------------|
| **Windowsæ—¥å¿—** | `ä¿ç•™BOMï¼Œæ­£ç¡®è¯†åˆ«` | `ignore_bom: false` |
| **Linuxæ—¥å¿—** | `é€šå¸¸æ— BOMï¼Œæ— éœ€å¤„ç†` | `é»˜è®¤é…ç½®å³å¯` |
| **æ··åˆç¯å¢ƒ** | `æ™ºèƒ½æ£€æµ‹ï¼Œç»Ÿä¸€å¤„ç†` | `strip_bom: true` |
| **æ•°æ®åˆ†æ** | `å»é™¤BOMï¼Œé¿å…å¹²æ‰°` | `strip_bom: true` |

**å®ç”¨BOMå¤„ç†é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/windows/*.log
  encoding: utf-8
  
  # æ™ºèƒ½BOMå¤„ç†
  encoding.strip_bom: true      # è‡ªåŠ¨å»é™¤BOM
  
  # æ·»åŠ æ ‡ç­¾æ ‡è¯†
  tags: ["windows_log", "bom_processed"]
  
  # å­—æ®µå¤„ç†
  processors:
  - if:
      has_fields: ['message']
    then:
    - script:
        lang: javascript
        source: >
          if (event.Get("message").charAt(0) === '\uFEFF') {
            event.Put("message", event.Get("message").substring(1));
          }
```

---

## 7. ğŸ¯ å®æˆ˜é…ç½®æ¡ˆä¾‹


### 7.1 å¤šæºæ—¥å¿—ç»Ÿä¸€ç¼–ç 


**åœºæ™¯æè¿°**ï¼šå…¬å¸æœ‰å¤šä¸ªç³»ç»Ÿï¼Œç¼–ç å„ä¸ç›¸åŒï¼š
- WebæœåŠ¡å™¨ï¼šUTF-8ç¼–ç 
- æ•°æ®åº“æ—¥å¿—ï¼šGBKç¼–ç   
- åº”ç”¨æ—¥å¿—ï¼šæ··åˆç¼–ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š
```yaml
filebeat.inputs:

# WebæœåŠ¡å™¨æ—¥å¿— (UTF-8)
- type: log
  paths:
    - /var/log/nginx/*.log
    - /var/log/apache/*.log
  encoding: utf-8
  tags: ["web", "utf8"]

# æ•°æ®åº“æ—¥å¿— (GBK)  
- type: log
  paths:
    - /var/log/mysql/*.log
    - /var/log/oracle/*.log
  encoding: gbk
  tags: ["database", "gbk"]

# åº”ç”¨æ—¥å¿— (è‡ªåŠ¨æ£€æµ‹)
- type: log
  paths:
    - /app/logs/*.log
  encoding.auto_detect: true
  encoding.fallback: utf-8
  tags: ["application", "auto"]

# ç»Ÿä¸€è¾“å‡ºå¤„ç†
processors:
- add_host_metadata:
    when.not.contains.tags: processed
- add_tags:
    tags: ["processed"]
```

### 7.2 ç¼–ç è½¬æ¢ç›‘æ§


**ç›‘æ§ç¼–ç é—®é¢˜çš„é…ç½®**ï¼š
```yaml
filebeat.inputs:
- type: log
  paths:
    - /var/log/app/*.log
  encoding.auto_detect: true
  encoding.fallback: utf-8
  
  # æ·»åŠ ç¼–ç æ£€æµ‹å­—æ®µ
  processors:
  - add_fields:
      target: filebeat
      fields:
        encoding_detection: true
        
  - script:
      lang: javascript
      source: >
        function process(event) {
          var msg = event.Get("message");
          if (msg && msg.includes("?") && msg.includes("ï¼Ÿ")) {
            event.Put("encoding_issue", "possible");
            event.Put("tags", ["encoding_problem"]);
          }
          return event;
        }

# è¾“å‡ºåˆ°ç›‘æ§ç³»ç»Ÿ
output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "logs-%{+yyyy.MM.dd}"
  
# ç¼–ç é—®é¢˜å‘Šè­¦
monitoring:
  enabled: true
  elasticsearch:
    hosts: ["localhost:9200"]
```

### 7.3 ç”Ÿäº§ç¯å¢ƒæœ€ä½³é…ç½®


**ä¼ä¸šçº§ç¼–ç å¤„ç†é…ç½®**ï¼š
```yaml
# Filebeatä¸»é…ç½®
filebeat.inputs:

# é€šç”¨æ—¥å¿—å¤„ç†æ¨¡æ¿
- type: log
  paths:
    - /var/log/apps/**/*.log
  
  # ç¼–ç å¤„ç†ç­–ç•¥
  encoding.auto_detect: true
  encoding.fallback: utf-8
  encoding.confidence_threshold: 0.85
  encoding.sample_size: 2048
  
  # æ€§èƒ½ä¼˜åŒ–
  harvester_limit: 10
  max_bytes: 10485760
  buffer_size: 16384
  
  # é”™è¯¯å¤„ç†
  ignore_older: 24h
  close_inactive: 5m
  close_renamed: true
  
  # å­—æ®µå¢å¼º
  fields:
    env: production
    log_type: application
  fields_under_root: false
  
  # å¤šè¡Œå¤„ç†
  multiline.pattern: '^\d{4}-\d{2}-\d{2}'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 500

# å…¨å±€å¤„ç†å™¨
processors:
- add_host_metadata: ~
- add_docker_metadata: ~
- drop_fields:
    fields: ["beat", "input", "ecs", "agent"]

# è¾“å‡ºé…ç½®  
output.elasticsearch:
  hosts: ["es1:9200", "es2:9200", "es3:9200"]
  index: "logs-%{+yyyy.MM.dd}"
  template.settings:
    index.number_of_shards: 1
    index.number_of_replicas: 1

# æ—¥å¿—é…ç½®
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç¼–ç æœ¬è´¨ï¼šæ–‡å­—ä¸æ•°å­—çš„è½¬æ¢è§„åˆ™ï¼Œå†³å®šæ–‡ä»¶å¦‚ä½•å­˜å‚¨å’Œè¯»å–
ğŸ”¸ å¸¸è§ç¼–ç ï¼šUTF-8(å›½é™…é€šç”¨)ã€GBK(ä¸­æ–‡)ã€ASCII(è‹±æ–‡)
ğŸ”¸ ä¹±ç åŸå› ï¼šç¼–ç ä¸è§£ç è§„åˆ™ä¸åŒ¹é…
ğŸ”¸ è‡ªåŠ¨æ£€æµ‹ï¼šè®©Filebeatæ™ºèƒ½è¯†åˆ«æ–‡ä»¶ç¼–ç 
ğŸ”¸ å¤šå­—èŠ‚å­—ç¬¦ï¼šä¸­æ–‡ç­‰å­—ç¬¦å ç”¨å¤šä¸ªå­—èŠ‚ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
ğŸ”¸ BOMæ ‡è®°ï¼šæ–‡ä»¶å¼€å¤´çš„ç¼–ç æ ‡è¯†ï¼Œå¯èƒ½å½±å“æ–‡æœ¬è§£æ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç¼–ç é€‰æ‹©çš„åŸºæœ¬é€»è¾‘**ï¼š
```
é€‰æ‹©ä¾æ®ï¼š
1. çœ‹ç³»ç»Ÿç¯å¢ƒï¼šLinuxå¤šç”¨UTF-8ï¼ŒWindowså¯èƒ½ç”¨GBK
2. çœ‹å†…å®¹è¯­è¨€ï¼šçº¯è‹±æ–‡ç”¨ASCIIï¼Œæœ‰ä¸­æ–‡ç”¨UTF-8æˆ–GBK
3. çœ‹å…¼å®¹éœ€æ±‚ï¼šéœ€è¦å›½é™…åŒ–å¿…é¡»UTF-8
4. çœ‹æ€§èƒ½è¦æ±‚ï¼šASCIIæœ€å¿«ï¼ŒUTF-8å¹³è¡¡ï¼ŒGBKä¸­æ–‡é«˜æ•ˆ
```

**ğŸ”¹ é—®é¢˜æ’æŸ¥çš„æ€è·¯**ï¼š
```
æ’æŸ¥æ­¥éª¤ï¼š
1. ç¡®è®¤åŸæ–‡ä»¶ç¼–ç ï¼ˆç”¨fileå‘½ä»¤æˆ–hexdumpæŸ¥çœ‹ï¼‰
2. æ£€æŸ¥Filebeaté…ç½®æ˜¯å¦åŒ¹é…
3. è§‚å¯Ÿè¾“å‡ºç»“æœï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ä¹±ç 
4. å¯ç”¨è‡ªåŠ¨æ£€æµ‹æˆ–è°ƒæ•´ç¼–ç é…ç½®
5. éªŒè¯ä¿®æ”¹æ•ˆæœ
```

**ğŸ”¹ é…ç½®ç­–ç•¥çš„æ ¸å¿ƒ**ï¼š
```
é…ç½®åŸåˆ™ï¼š
- å·²çŸ¥ç¼–ç ï¼šç›´æ¥æŒ‡å®šï¼Œæ€§èƒ½æœ€å¥½
- æœªçŸ¥ç¼–ç ï¼šå¯ç”¨è‡ªåŠ¨æ£€æµ‹ï¼Œå‡†ç¡®æ€§é«˜
- æ··åˆç¼–ç ï¼šåˆ†åˆ«é…ç½®ä¸åŒè¾“å…¥æº
- å®¹é”™å¤„ç†ï¼šè®¾ç½®fallbackç¼–ç ï¼Œé¿å…å®Œå…¨å¤±è´¥
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **å¤šç³»ç»Ÿé›†æˆ**ï¼šä¸åŒç³»ç»Ÿç¼–ç ç»Ÿä¸€å¤„ç†
- **å†å²æ•°æ®è¿ç§»**ï¼šè€ç³»ç»Ÿç¼–ç è½¬æ¢
- **å›½é™…åŒ–é¡¹ç›®**ï¼šå¤šè¯­è¨€æ—¥å¿—å¤„ç†
- **æ•…éšœæ’æŸ¥**ï¼šç¼–ç é—®é¢˜å¿«é€Ÿå®šä½

**è¿ç»´å®è·µè¦ç‚¹**ï¼š
- **é¢„é˜²ä¸ºä¸»**ï¼šæå‰è§„åˆ’ç¼–ç æ ‡å‡†
- **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶å‘ç°ç¼–ç é—®é¢˜
- **è‡ªåŠ¨å¤„ç†**ï¼šå‡å°‘äººå·¥å¹²é¢„
- **æ–‡æ¡£è®°å½•**ï¼šç¼–ç é…ç½®è¦æœ‰è¯´æ˜

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
- **åˆç†è®¾ç½®buffer_size**ï¼šå¹³è¡¡å†…å­˜å’Œæ€§èƒ½
- **é€‚å½“çš„sample_size**ï¼šæ£€æµ‹å‡†ç¡®æ€§å’Œé€Ÿåº¦å¹³è¡¡
- **é¿å…é¢‘ç¹æ£€æµ‹**ï¼šå·²çŸ¥ç¼–ç ç›´æ¥æŒ‡å®š
- **ç›‘æ§èµ„æºä½¿ç”¨**ï¼šç¼–ç è½¬æ¢ä¼šæ¶ˆè€—CPU

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç¼–ç å¦‚ç¿»è¯‘ï¼Œè§„åˆ™è¦åŒ¹é…
- UTF-8å›½é™…åŒ–ï¼ŒGBKä¸­æ–‡ä¼˜
- è‡ªåŠ¨æ£€æµ‹å¥½ï¼Œfallbackè¦è®¾ç½®  
- å¤šå­—èŠ‚å°å¿ƒï¼ŒBOMè¦å¤„ç†