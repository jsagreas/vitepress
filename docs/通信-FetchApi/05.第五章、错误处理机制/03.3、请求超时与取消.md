---
title: 3ã€è¯·æ±‚è¶…æ—¶ä¸å–æ¶ˆ
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶ä¸å–æ¶ˆæœºåˆ¶](#1-ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶ä¸å–æ¶ˆæœºåˆ¶)
2. [AbortControlleræ§åˆ¶å™¨è¯¦è§£](#2-AbortControlleræ§åˆ¶å™¨è¯¦è§£)
3. [è¯·æ±‚è¶…æ—¶çš„å®ç°æ–¹æ³•](#3-è¯·æ±‚è¶…æ—¶çš„å®ç°æ–¹æ³•)
4. [æ‰‹åŠ¨å–æ¶ˆè¯·æ±‚æ“ä½œ](#4-æ‰‹åŠ¨å–æ¶ˆè¯·æ±‚æ“ä½œ)
5. [é”™è¯¯å¤„ç†ä¸ç”¨æˆ·ä½“éªŒ](#5-é”™è¯¯å¤„ç†ä¸ç”¨æˆ·ä½“éªŒ)
6. [å®é™…åº”ç”¨åœºæ™¯](#6-å®é™…åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶ä¸å–æ¶ˆæœºåˆ¶


### 1.1 ç°å®åœºæ™¯ä¸­çš„é—®é¢˜


æƒ³è±¡ä¸€ä¸‹è¿™äº›æƒ…å†µï¼š
- ğŸŒ **ç½‘ç»œæ…¢**ï¼šç”¨æˆ·ç‚¹å‡»æœç´¢ï¼Œç­‰äº†10ç§’è¿˜æ²¡ååº”
- ğŸ”„ **é‡å¤ç‚¹å‡»**ï¼šç”¨æˆ·ä¸è€çƒ¦ï¼Œç–¯ç‹‚ç‚¹å‡»åŒä¸€ä¸ªæŒ‰é’®
- ğŸ“± **é¡µé¢åˆ‡æ¢**ï¼šç”¨æˆ·å·²ç»è·³è½¬åˆ°å…¶ä»–é¡µé¢ï¼Œä½†è¯·æ±‚è¿˜åœ¨ç»§ç»­
- ğŸ’¸ **æµé‡æµªè´¹**ï¼šæ‰‹æœºç”¨æˆ·åœ¨å¼±ç½‘ç¯å¢ƒä¸‹ï¼Œæ— æ•ˆè¯·æ±‚æ¶ˆè€—æµé‡

```
ç”¨æˆ·ä½“éªŒå¯¹æ¯”ï¼š

æ²¡æœ‰æ§åˆ¶æœºåˆ¶ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ ç­‰å¾…... â†’ ç­‰å¾…... â†’ ç­‰å¾…... â†’ ğŸ¤¬ ç”¨æˆ·å´©æºƒ

æœ‰æ§åˆ¶æœºåˆ¶ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ 2ç§’è¶…æ—¶ â†’ ğŸ”„ é‡è¯• æˆ– âŒ å–æ¶ˆ
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**ğŸ¯ è¯·æ±‚è¶…æ—¶**ï¼šå°±åƒç»™ç½‘ç»œè¯·æ±‚è®¾ç½®ä¸€ä¸ª"é—¹é’Ÿ"
- ğŸ“… è®¾å®šï¼šæœ€å¤šç­‰Xç§’
- â° åˆ°æ—¶ï¼šè‡ªåŠ¨åœæ­¢è¯·æ±‚
- ğŸ¨ ç›®çš„ï¼šé¿å…æ— é™ç­‰å¾…

**ğŸ›‘ è¯·æ±‚å–æ¶ˆ**ï¼šå°±åƒç»™è¯·æ±‚å®‰è£…ä¸€ä¸ª"ç´§æ€¥åœæ­¢æŒ‰é’®"
- ğŸ‘† ç”¨æˆ·ï¼šå¯ä»¥ä¸»åŠ¨æŒ‰åœæ­¢
- ğŸ”„ ç¨‹åºï¼šå¯ä»¥è‡ªåŠ¨å–æ¶ˆæ—§è¯·æ±‚
- ğŸ’¡ ç›®çš„ï¼šèŠ‚çœèµ„æºï¼Œæå‡ä½“éªŒ

---

## 2. ğŸ® AbortControlleræ§åˆ¶å™¨è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯AbortController


**é€šä¿—ç†è§£**ï¼šAbortControllerå°±åƒä¸€ä¸ª"é¥æ§å™¨"ï¼Œå¯ä»¥è¿œç¨‹æ§åˆ¶è¯·æ±‚çš„å¼€å§‹å’Œåœæ­¢ã€‚

```
ç°å®ç±»æ¯”ï¼š
ç”µè§†é¥æ§å™¨ â†’ AbortController
ç”µè§†æœº â†’ fetchè¯·æ±‚
æŒ‰å…³æœºé”® â†’ è°ƒç”¨abort()æ–¹æ³•
ç”µè§†å…³é—­ â†’ è¯·æ±‚è¢«å–æ¶ˆ
```

### 2.2 åŸºæœ¬å·¥ä½œåŸç†


```javascript
// 1. åˆ›å»ºæ§åˆ¶å™¨ï¼ˆæ‹¿èµ·é¥æ§å™¨ï¼‰
const controller = new AbortController();

// 2. è·å–ä¿¡å·ï¼ˆè¿æ¥é¥æ§å™¨å’Œç”µè§†ï¼‰
const signal = controller.signal;

// 3. å‘èµ·è¯·æ±‚ï¼ˆæ‰“å¼€ç”µè§†ï¼‰
fetch('/api/data', { signal });

// 4. å–æ¶ˆè¯·æ±‚ï¼ˆæŒ‰å…³æœºé”®ï¼‰
controller.abort();
```

**ğŸ” è¯¦ç»†æµç¨‹å›¾ç¤º**ï¼š
```
åˆ›å»ºé˜¶æ®µï¼š
[AbortController] â†’ ç”Ÿæˆ â†’ [AbortSignal]
        â†“                      â†“
    [æ§åˆ¶å™¨]                [ä¿¡å·å™¨]

ä½¿ç”¨é˜¶æ®µï¼š
[fetchè¯·æ±‚] â† ç›‘å¬ â† [AbortSignal]
     â†“                    â†‘
  [è¿›è¡Œä¸­]              [æ­£å¸¸çŠ¶æ€]

å–æ¶ˆé˜¶æ®µï¼š
[controller.abort()] â†’ è§¦å‘ â†’ [AbortSignal]
                               â†“
                        [signal.aborted = true]
                               â†“
                        [fetchè¯·æ±‚è¢«å–æ¶ˆ]
```

### 2.3 æ ¸å¿ƒå±æ€§å’Œæ–¹æ³•


```javascript
const controller = new AbortController();
const signal = controller.signal;

// ğŸ“Š é‡è¦å±æ€§
console.log(signal.aborted);  // false/true - æ˜¯å¦å·²å–æ¶ˆ

// ğŸ¯ æ ¸å¿ƒæ–¹æ³•
controller.abort();           // å–æ¶ˆè¯·æ±‚
controller.abort('ç”¨æˆ·å–æ¶ˆ'); // å–æ¶ˆå¹¶æŒ‡å®šåŸå› 

// ğŸ”” äº‹ä»¶ç›‘å¬
signal.addEventListener('abort', () => {
  console.log('è¯·æ±‚è¢«å–æ¶ˆäº†ï¼');
});
```

---

## 3. â° è¯·æ±‚è¶…æ—¶çš„å®ç°æ–¹æ³•


### 3.1 æ–¹æ³•ä¸€ï¼šä½¿ç”¨setTimeout


**ğŸ’¡ æ ¸å¿ƒæ€è·¯**ï¼šè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ—¶é—´åˆ°äº†å°±ä¸»åŠ¨å–æ¶ˆè¯·æ±‚ã€‚

```javascript
function fetchWithTimeout(url, timeout = 5000) {
  // åˆ›å»ºæ§åˆ¶å™¨
  const controller = new AbortController();
  
  // è®¾ç½®è¶…æ—¶å®šæ—¶å™¨
  const timeoutId = setTimeout(() => {
    controller.abort('è¯·æ±‚è¶…æ—¶');
  }, timeout);
  
  // å‘èµ·è¯·æ±‚
  return fetch(url, { signal: controller.signal })
    .then(response => {
      // è¯·æ±‚æˆåŠŸï¼Œæ¸…é™¤å®šæ—¶å™¨
      clearTimeout(timeoutId);
      return response;
    })
    .catch(error => {
      // æ¸…é™¤å®šæ—¶å™¨
      clearTimeout(timeoutId);
      
      if (error.name === 'AbortError') {
        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
      }
      throw error;
    });
}

// ğŸš€ ä½¿ç”¨ç¤ºä¾‹
fetchWithTimeout('/api/slow-data', 3000)
  .then(response => response.json())
  .then(data => console.log('è·å–æˆåŠŸ:', data))
  .catch(error => console.log('é”™è¯¯:', error.message));
```

### 3.2 æ–¹æ³•äºŒï¼šPromise.raceç«èµ›


**ğŸ’¡ æ ¸å¿ƒæ€è·¯**ï¼šè®©è¯·æ±‚å’Œè¶…æ—¶å®šæ—¶å™¨"èµ›è·‘"ï¼Œè°å…ˆå®Œæˆå¬è°çš„ã€‚

```javascript
function createTimeoutPromise(timeout, controller) {
  return new Promise((_, reject) => {
    setTimeout(() => {
      controller.abort();
      reject(new Error(`è¯·æ±‚è¶…æ—¶ï¼Œè¶…è¿‡${timeout}ms`));
    }, timeout);
  });
}

async function fetchWithRace(url, timeout = 5000) {
  const controller = new AbortController();
  
  try {
    // ğŸƒâ€â™‚ï¸ å¼€å§‹èµ›è·‘ï¼šè¯·æ±‚ vs è¶…æ—¶
    const response = await Promise.race([
      fetch(url, { signal: controller.signal }),
      createTimeoutPromise(timeout, controller)
    ]);
    
    return response;
  } catch (error) {
    if (error.name === 'AbortError') {
      throw new Error('ç½‘ç»œè¯·æ±‚è¶…æ—¶');
    }
    throw error;
  }
}
```

### 3.3 æ–¹æ³•ä¸‰ï¼šå°è£…é€šç”¨è¶…æ—¶å‡½æ•°


```javascript
class FetchManager {
  constructor(defaultTimeout = 10000) {
    this.defaultTimeout = defaultTimeout;
  }
  
  async request(url, options = {}) {
    const {
      timeout = this.defaultTimeout,
      ...fetchOptions
    } = options;
    
    const controller = new AbortController();
    
    // è®¾ç½®è¶…æ—¶
    const timeoutId = setTimeout(() => {
      controller.abort();
    }, timeout);
    
    try {
      const response = await fetch(url, {
        ...fetchOptions,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      return response;
      
    } catch (error) {
      clearTimeout(timeoutId);
      
      if (error.name === 'AbortError') {
        throw new Error(`è¯·æ±‚è¶…æ—¶ï¼Œè¶…è¿‡${timeout}ms`);
      }
      throw error;
    }
  }
}

// ğŸ¯ ä½¿ç”¨ç¤ºä¾‹
const api = new FetchManager(5000); // é»˜è®¤5ç§’è¶…æ—¶

api.request('/api/data', { timeout: 3000 })
   .then(res => res.json())
   .then(data => console.log(data));
```

---

## 4. ğŸ›‘ æ‰‹åŠ¨å–æ¶ˆè¯·æ±‚æ“ä½œ


### 4.1 åŸºç¡€å–æ¶ˆæ“ä½œ


```javascript
// 1. åˆ›å»ºå¯å–æ¶ˆçš„è¯·æ±‚
let currentController = null;

function searchData(keyword) {
  // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
  if (currentController) {
    currentController.abort();
  }
  
  // åˆ›å»ºæ–°çš„æ§åˆ¶å™¨
  currentController = new AbortController();
  
  return fetch(`/api/search?q=${keyword}`, {
    signal: currentController.signal
  });
}

// 2. ç”¨æˆ·è¾“å…¥æœç´¢
document.getElementById('search').addEventListener('input', async (e) => {
  const keyword = e.target.value.trim();
  
  if (keyword) {
    try {
      const response = await searchData(keyword);
      const results = await response.json();
      displayResults(results);
    } catch (error) {
      if (error.name !== 'AbortError') {
        console.error('æœç´¢å¤±è´¥:', error);
      }
    }
  }
});
```

### 4.2 å¸¦UIåé¦ˆçš„å–æ¶ˆæ“ä½œ


```javascript
class RequestManager {
  constructor() {
    this.activeRequests = new Map();
  }
  
  async makeRequest(requestId, url, options = {}) {
    // å¦‚æœæœ‰åŒåè¯·æ±‚åœ¨è¿›è¡Œï¼Œå…ˆå–æ¶ˆ
    this.cancelRequest(requestId);
    
    const controller = new AbortController();
    this.activeRequests.set(requestId, controller);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.showLoading(requestId);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      
      // è¯·æ±‚å®Œæˆï¼Œæ¸…ç†
      this.activeRequests.delete(requestId);
      this.hideLoading(requestId);
      
      return response;
      
    } catch (error) {
      this.activeRequests.delete(requestId);
      this.hideLoading(requestId);
      
      if (error.name === 'AbortError') {
        console.log(`è¯·æ±‚ ${requestId} è¢«å–æ¶ˆ`);
        return null;
      }
      
      throw error;
    }
  }
  
  cancelRequest(requestId) {
    const controller = this.activeRequests.get(requestId);
    if (controller) {
      controller.abort();
      this.activeRequests.delete(requestId);
      this.hideLoading(requestId);
    }
  }
  
  cancelAllRequests() {
    for (const [requestId, controller] of this.activeRequests) {
      controller.abort();
      this.hideLoading(requestId);
    }
    this.activeRequests.clear();
  }
  
  showLoading(requestId) {
    const button = document.querySelector(`[data-request="${requestId}"]`);
    if (button) {
      button.disabled = true;
      button.textContent = 'åŠ è½½ä¸­...';
    }
  }
  
  hideLoading(requestId) {
    const button = document.querySelector(`[data-request="${requestId}"]`);
    if (button) {
      button.disabled = false;
      button.textContent = 'æœç´¢';
    }
  }
}

// ğŸ¯ ä½¿ç”¨ç¤ºä¾‹
const requestManager = new RequestManager();

// æœç´¢æŒ‰é’®
document.getElementById('searchBtn').addEventListener('click', async () => {
  try {
    const response = await requestManager.makeRequest(
      'search', 
      '/api/search',
      { method: 'POST', body: JSON.stringify({ query: 'test' }) }
    );
    
    if (response) {
      const data = await response.json();
      console.log('æœç´¢ç»“æœ:', data);
    }
  } catch (error) {
    console.error('æœç´¢å¤±è´¥:', error);
  }
});

// å–æ¶ˆæŒ‰é’®
document.getElementById('cancelBtn').addEventListener('click', () => {
  requestManager.cancelRequest('search');
});
```

---

## 5. ğŸ› ï¸ é”™è¯¯å¤„ç†ä¸ç”¨æˆ·ä½“éªŒ


### 5.1 é”™è¯¯ç±»å‹è¯†åˆ«


```javascript
async function handleRequest(url) {
  const controller = new AbortController();
  
  // 3ç§’è¶…æ—¶
  setTimeout(() => controller.abort(), 3000);
  
  try {
    const response = await fetch(url, {
      signal: controller.signal
    });
    
    return await response.json();
    
  } catch (error) {
    // ğŸ” è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å¤„ç†
    if (error.name === 'AbortError') {
      if (controller.signal.reason) {
        // æœ‰å–æ¶ˆåŸå› 
        console.log('å–æ¶ˆåŸå› :', controller.signal.reason);
        throw new Error('è¯·æ±‚è¢«å–æ¶ˆ: ' + controller.signal.reason);
      } else {
        // æ²¡æœ‰åŸå› ï¼Œå¯èƒ½æ˜¯è¶…æ—¶
        throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    } else if (error.name === 'TypeError') {
      throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
    } else {
      throw new Error('è¯·æ±‚å¤±è´¥: ' + error.message);
    }
  }
}
```

### 5.2 ç”¨æˆ·å‹å¥½çš„åé¦ˆ


```javascript
class UserFriendlyFetch {
  constructor() {
    this.showUserMessage = this.showUserMessage.bind(this);
  }
  
  async requestWithUserFeedback(url, options = {}) {
    const {
      timeout = 10000,
      showLoading = true,
      retryable = true,
      ...fetchOptions
    } = options;
    
    const controller = new AbortController();
    
    try {
      if (showLoading) {
        this.showLoading('æ­£åœ¨åŠ è½½...');
      }
      
      // è®¾ç½®è¶…æ—¶
      const timeoutId = setTimeout(() => {
        controller.abort();
      }, timeout);
      
      const response = await fetch(url, {
        ...fetchOptions,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      this.hideLoading();
      
      if (!response.ok) {
        throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
      }
      
      return response;
      
    } catch (error) {
      this.hideLoading();
      
      if (error.name === 'AbortError') {
        if (retryable) {
          return this.showRetryOption('è¯·æ±‚è¶…æ—¶ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ', () => {
            return this.requestWithUserFeedback(url, options);
          });
        } else {
          this.showUserMessage('è¯·æ±‚å·²å–æ¶ˆ', 'warning');
          return null;
        }
      } else {
        this.showUserMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
        throw error;
      }
    }
  }
  
  showLoading(message) {
    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    const loader = document.getElementById('loader');
    if (loader) {
      loader.style.display = 'block';
      loader.textContent = message;
    }
  }
  
  hideLoading() {
    const loader = document.getElementById('loader');
    if (loader) {
      loader.style.display = 'none';
    }
  }
  
  showUserMessage(message, type = 'info') {
    // æ˜¾ç¤ºç”¨æˆ·æç¤º
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 3000);
  }
  
  showRetryOption(message, retryCallback) {
    return new Promise((resolve) => {
      const result = confirm(message);
      if (result) {
        resolve(retryCallback());
      } else {
        resolve(null);
      }
    });
  }
}

// ğŸš€ ä½¿ç”¨ç¤ºä¾‹
const userFetch = new UserFriendlyFetch();

document.getElementById('loadBtn').addEventListener('click', async () => {
  try {
    const response = await userFetch.requestWithUserFeedback('/api/data', {
      timeout: 5000,
      showLoading: true,
      retryable: true
    });
    
    if (response) {
      const data = await response.json();
      console.log('æ•°æ®åŠ è½½æˆåŠŸ:', data);
    }
  } catch (error) {
    console.error('æœ€ç»ˆå¤±è´¥:', error);
  }
});
```

---

## 6. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 6.1 æœç´¢è¾“å…¥é˜²æŠ– + å–æ¶ˆ


```javascript
// ğŸ” æ™ºèƒ½æœç´¢ï¼šè¾“å…¥æ—¶è‡ªåŠ¨æœç´¢ï¼Œé¿å…é‡å¤è¯·æ±‚
class SmartSearch {
  constructor(searchInput, resultsContainer) {
    this.searchInput = searchInput;
    this.resultsContainer = resultsContainer;
    this.currentController = null;
    this.debounceTimer = null;
    
    this.init();
  }
  
  init() {
    this.searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
      clearTimeout(this.debounceTimer);
      
      if (query.length < 2) {
        this.clearResults();
        return;
      }
      
      // é˜²æŠ–ï¼š500msåæ‰§è¡Œæœç´¢
      this.debounceTimer = setTimeout(() => {
        this.performSearch(query);
      }, 500);
    });
  }
  
  async performSearch(query) {
    // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
    if (this.currentController) {
      this.currentController.abort();
    }
    
    this.currentController = new AbortController();
    this.showLoading();
    
    try {
      const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
        signal: this.currentController.signal
      });
      
      const results = await response.json();
      this.displayResults(results);
      
    } catch (error) {
      if (error.name !== 'AbortError') {
        this.showError('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } finally {
      this.hideLoading();
      this.currentController = null;
    }
  }
  
  showLoading() {
    this.resultsContainer.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
  }
  
  hideLoading() {
    const loading = this.resultsContainer.querySelector('.loading');
    if (loading) loading.remove();
  }
  
  displayResults(results) {
    this.resultsContainer.innerHTML = results.map(item => 
      `<div class="result-item">${item.title}</div>`
    ).join('');
  }
  
  clearResults() {
    this.resultsContainer.innerHTML = '';
  }
  
  showError(message) {
    this.resultsContainer.innerHTML = `<div class="error">${message}</div>`;
  }
}

// ä½¿ç”¨
const search = new SmartSearch(
  document.getElementById('searchInput'),
  document.getElementById('searchResults')
);
```

### 6.2 æ–‡ä»¶ä¸Šä¼ è¿›åº¦æ§åˆ¶


```javascript
// ğŸ“ æ–‡ä»¶ä¸Šä¼ ï¼šæ”¯æŒå–æ¶ˆå’Œè¶…æ—¶æ§åˆ¶
class FileUploader {
  constructor() {
    this.activeUploads = new Map();
  }
  
  async uploadFile(file, uploadId) {
    const controller = new AbortController();
    this.activeUploads.set(uploadId, controller);
    
    // åˆ›å»ºFormData
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      // 30ç§’è¶…æ—¶ï¼ˆå¤§æ–‡ä»¶éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
      const timeoutId = setTimeout(() => {
        controller.abort('ä¸Šä¼ è¶…æ—¶');
      }, 30000);
      
      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      this.activeUploads.delete(uploadId);
      
      if (!response.ok) {
        throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`);
      }
      
      return await response.json();
      
    } catch (error) {
      this.activeUploads.delete(uploadId);
      
      if (error.name === 'AbortError') {
        throw new Error('ä¸Šä¼ è¢«å–æ¶ˆ');
      }
      throw error;
    }
  }
  
  cancelUpload(uploadId) {
    const controller = this.activeUploads.get(uploadId);
    if (controller) {
      controller.abort('ç”¨æˆ·å–æ¶ˆ');
      this.activeUploads.delete(uploadId);
    }
  }
  
  cancelAllUploads() {
    for (const [uploadId, controller] of this.activeUploads) {
      controller.abort('æ‰¹é‡å–æ¶ˆ');
    }
    this.activeUploads.clear();
  }
}

// ğŸ¯ ä½¿ç”¨ç¤ºä¾‹
const uploader = new FileUploader();

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const uploadId = 'upload_' + Date.now();
  
  try {
    console.log('å¼€å§‹ä¸Šä¼ :', file.name);
    const result = await uploader.uploadFile(file, uploadId);
    console.log('ä¸Šä¼ æˆåŠŸ:', result);
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error.message);
  }
});

// å–æ¶ˆæŒ‰é’®
document.getElementById('cancelBtn').addEventListener('click', () => {
  uploader.cancelAllUploads();
  console.log('æ‰€æœ‰ä¸Šä¼ å·²å–æ¶ˆ');
});
```

### 6.3 é¡µé¢ç¦»å¼€æ—¶æ¸…ç†è¯·æ±‚


```javascript
// ğŸšª é¡µé¢ç”Ÿå‘½å‘¨æœŸç®¡ç†
class PageRequestManager {
  constructor() {
    this.activeControllers = new Set();
    this.initPageLifecycle();
  }
  
  initPageLifecycle() {
    // é¡µé¢å³å°†ç¦»å¼€æ—¶å–æ¶ˆæ‰€æœ‰è¯·æ±‚
    window.addEventListener('beforeunload', () => {
      this.cancelAllRequests('é¡µé¢ç¦»å¼€');
    });
    
    // é¡µé¢å˜ä¸ºä¸å¯è§æ—¶å–æ¶ˆè¯·æ±‚ï¼ˆå¯é€‰ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('é¡µé¢éšè—ï¼Œä¿ç•™è¯·æ±‚ç»§ç»­æ‰§è¡Œ');
        // å¯ä»¥é€‰æ‹©æ˜¯å¦å–æ¶ˆè¯·æ±‚
        // this.cancelAllRequests('é¡µé¢éšè—');
      }
    });
  }
  
  async makeRequest(url, options = {}) {
    const controller = new AbortController();
    this.activeControllers.add(controller);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      
      return response;
      
    } finally {
      this.activeControllers.delete(controller);
    }
  }
  
  cancelAllRequests(reason = 'ä¸»åŠ¨å–æ¶ˆ') {
    console.log(`å–æ¶ˆæ‰€æœ‰è¯·æ±‚: ${reason}`);
    
    for (const controller of this.activeControllers) {
      controller.abort(reason);
    }
    
    this.activeControllers.clear();
  }
}

// ğŸŒ å…¨å±€å®ä¾‹
window.pageRequestManager = new PageRequestManager();

// ä½¿ç”¨å…¨å±€ç®¡ç†å™¨å‘èµ·è¯·æ±‚
async function apiCall(url, options) {
  return window.pageRequestManager.makeRequest(url, options);
}

// ç¤ºä¾‹è°ƒç”¨
apiCall('/api/data')
  .then(res => res.json())
  .then(data => console.log(data))
  .catch(error => {
    if (error.name !== 'AbortError') {
      console.error('è¯·æ±‚å¤±è´¥:', error);
    }
  });
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ AbortControllerï¼šè¯·æ±‚çš„"é¥æ§å™¨"ï¼Œæ§åˆ¶è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ AbortSignalï¼šè¯·æ±‚çš„"ä¿¡å·å™¨"ï¼Œä¼ é€’å–æ¶ˆçŠ¶æ€
ğŸ”¸ è¯·æ±‚è¶…æ—¶ï¼šç»™è¯·æ±‚è®¾ç½®"é—¹é’Ÿ"ï¼Œé¿å…æ— é™ç­‰å¾…
ğŸ”¸ æ‰‹åŠ¨å–æ¶ˆï¼šç»™ç”¨æˆ·"åœæ­¢æŒ‰é’®"ï¼Œæå‡äº¤äº’ä½“éªŒ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šåŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹ï¼Œæä¾›å‹å¥½åé¦ˆ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ AbortControllerçš„å·¥ä½œåŸç†**
```
æ ¸å¿ƒæœºåˆ¶ï¼š
æ§åˆ¶å™¨(Controller) â†’ ç”Ÿæˆä¿¡å·(Signal) â†’ ä¼ é€’ç»™è¯·æ±‚(fetch)
          â†“                â†“               â†“
       æŒæ§æƒ              ç›‘å¬å™¨          æ‰§è¡Œè€…

å–æ¶ˆæµç¨‹ï¼š
abort() â†’ signal.aborted=true â†’ fetchæŠ›å‡ºAbortError
```

**ğŸ”¹ è¶…æ—¶å®ç°çš„æœ¬è´¨**
```
æœ¬è´¨ï¼šç”¨å®šæ—¶å™¨è§¦å‘å–æ¶ˆæ“ä½œ
æ–¹å¼1ï¼šsetTimeout + abort()
æ–¹å¼2ï¼šPromise.race() ç«èµ›
æ–¹å¼3ï¼šå°è£…ç»Ÿä¸€å·¥å…·ç±»

é€‰æ‹©åŸåˆ™ï¼šç®€å•åœºæ™¯ç”¨æ–¹å¼1ï¼Œå¤æ‚åº”ç”¨ç”¨æ–¹å¼3
```

**ğŸ”¹ é”™è¯¯å¤„ç†çš„é‡è¦æ€§**
```
é”™è¯¯ç±»å‹ï¼š
- AbortErrorï¼šè¯·æ±‚è¢«å–æ¶ˆï¼ˆæ­£å¸¸æƒ…å†µï¼‰
- TypeErrorï¼šç½‘ç»œé—®é¢˜ï¼ˆéœ€è¦æç¤ºç”¨æˆ·ï¼‰
- å…¶ä»–é”™è¯¯ï¼šæœåŠ¡å™¨æˆ–ä»£ç é—®é¢˜

ç”¨æˆ·ä½“éªŒï¼š
âŒ ç›´æ¥æ˜¾ç¤ºæŠ€æœ¯é”™è¯¯ä¿¡æ¯
âœ… è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æç¤º
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **æœç´¢åŠŸèƒ½**ï¼šé˜²æŠ– + å–æ¶ˆæ—§è¯·æ±‚ï¼Œé¿å…ç»“æœæ··ä¹±
- **æ–‡ä»¶ä¸Šä¼ **ï¼šè¶…æ—¶æ§åˆ¶ + ç”¨æˆ·å–æ¶ˆï¼Œæå‡ä½“éªŒ
- **æ•°æ®åŠ è½½**ï¼šè¶…æ—¶é‡è¯• + åŠ è½½çŠ¶æ€ï¼Œå¢å¼ºäº¤äº’
- **é¡µé¢è·³è½¬**ï¼šè‡ªåŠ¨æ¸…ç†è¯·æ±‚ï¼ŒèŠ‚çœèµ„æº

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
- **ç»Ÿä¸€ç®¡ç†**ï¼šä½¿ç”¨å·¥å…·ç±»ç»Ÿä¸€å¤„ç†è¶…æ—¶å’Œå–æ¶ˆ
- **ç”¨æˆ·åé¦ˆ**ï¼šæä¾›æ¸…æ™°çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŠæ—¶æ¸…ç†æ— ç”¨è¯·æ±‚ï¼Œé¿å…å†…å­˜æ³„æ¼
- **ä¼˜é›…é™çº§**ï¼šè€æµè§ˆå™¨ä½¿ç”¨polyfillæˆ–é™çº§æ–¹æ¡ˆ

**ğŸ’¡ æœ€ä½³å®è·µæ¨¡å¼**
```javascript
// æ¨èçš„è¯·æ±‚å°è£…æ¨¡å¼
class ApiClient {
  async request(url, options = {}) {
    const controller = new AbortController();
    const timeout = options.timeout || 10000;
    
    setTimeout(() => controller.abort(), timeout);
    
    try {
      const response = await fetch(url, {
        ...options,
        signal: controller.signal
      });
      
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response;
      
    } catch (error) {
      if (error.name === 'AbortError') {
        throw new Error('è¯·æ±‚è¶…æ—¶');
      }
      throw error;
    }
  }
}
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- AbortControlleræ˜¯è¯·æ±‚çš„"é¥æ§å™¨"ï¼Œå¯ä»¥éšæ—¶åœæ­¢
- è¶…æ—¶å°±æ˜¯ç»™è¯·æ±‚è®¾"é—¹é’Ÿ"ï¼Œæ—¶é—´åˆ°äº†è‡ªåŠ¨å–æ¶ˆ
- å–æ¶ˆè¯·æ±‚è¦å¤„ç†AbortErrorï¼Œç»™ç”¨æˆ·å‹å¥½æç¤º
- å®é™…åº”ç”¨ä¸­è¦è€ƒè™‘ç”¨æˆ·ä½“éªŒå’Œèµ„æºç®¡ç†