---
title: 7ã€Produceræ€§èƒ½è°ƒä¼˜
---
## ğŸ“š ç›®å½•

1. [Kafka Produceræ€§èƒ½è°ƒä¼˜åŸºç¡€](#1-Kafka-Produceræ€§èƒ½è°ƒä¼˜åŸºç¡€)
2. [ååé‡ä¼˜åŒ–ç­–ç•¥](#2-ååé‡ä¼˜åŒ–ç­–ç•¥)
3. [å»¶è¿Ÿä¼˜åŒ–æŠ€æœ¯](#3-å»¶è¿Ÿä¼˜åŒ–æŠ€æœ¯)
4. [æ‰¹å¤„ç†è°ƒä¼˜å®è·µ](#4-æ‰¹å¤„ç†è°ƒä¼˜å®è·µ)
5. [å‹ç¼©ç®—æ³•é€‰æ‹©ä¸å¯¹æ¯”](#5-å‹ç¼©ç®—æ³•é€‰æ‹©ä¸å¯¹æ¯”)
6. [å¼‚æ­¥å‘é€ä¼˜åŒ–](#6-å¼‚æ­¥å‘é€ä¼˜åŒ–)
7. [å†…å­˜ä½¿ç”¨ä¼˜åŒ–](#7-å†…å­˜ä½¿ç”¨ä¼˜åŒ–)
8. [è¿æ¥æ± ç®¡ç†](#8-è¿æ¥æ± ç®¡ç†)
9. [ç›‘æ§æŒ‡æ ‡ä½“ç³»](#9-ç›‘æ§æŒ‡æ ‡ä½“ç³»)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Kafka Produceræ€§èƒ½è°ƒä¼˜åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Produceræ€§èƒ½è°ƒä¼˜

ğŸ”¸ **é€šä¿—ç†è§£**ï¼šå°±åƒå¼€è½¦ä¸€æ ·ï¼ŒåŒæ ·çš„è½¦åœ¨ä¸åŒå¸æœºæ‰‹é‡Œï¼Œæ²¹è€—å’Œé€Ÿåº¦å®Œå…¨ä¸åŒ

```
ç”Ÿæ´»ä¸­çš„æ¯”å–»ï¼š
å¿«é€’å‘˜é€åŒ…è£¹ â†’ Kafka Producerå‘é€æ¶ˆæ¯
- ä¸€æ¬¡é€ä¸€ä¸ªåŒ…è£¹ï¼ˆé€æ¡å‘é€ï¼‰â†’ æ•ˆç‡ä½ï¼Œè·‘è…¿å¤š
- æ”’ä¸€è½¦åŒ…è£¹ä¸€èµ·é€ï¼ˆæ‰¹é‡å‘é€ï¼‰â†’ æ•ˆç‡é«˜ï¼ŒèŠ‚çœæ—¶é—´
- é€‰æ‹©æœ€ä¼˜è·¯çº¿ï¼ˆç½‘ç»œä¼˜åŒ–ï¼‰â†’ é™ä½å»¶è¿Ÿ
- ç”¨å¤§è´§è½¦è€Œä¸æ˜¯å°è½¿è½¦ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰â†’ æå‡ååé‡
```

### 1.2 æ€§èƒ½è°ƒä¼˜çš„ä¸¤ä¸ªæ ¸å¿ƒç›®æ ‡

**ğŸ“Š æ€§èƒ½ç»´åº¦å¯¹æ¯”**

| æ€§èƒ½æŒ‡æ ‡ | **å«ä¹‰è§£é‡Š** | **ä¼˜åŒ–é‡ç‚¹** | **åº”ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| ğŸš€ **ååé‡** | `å•ä½æ—¶é—´èƒ½å¤„ç†çš„æ¶ˆæ¯æ•°é‡` | `æ‰¹é‡å‘é€ã€å‹ç¼©ä¼˜åŒ–` | `æ—¥å¿—æ”¶é›†ã€æ•°æ®åŒæ­¥` |
| âš¡ **å»¶è¿Ÿ** | `æ¶ˆæ¯ä»å‘é€åˆ°ç¡®è®¤çš„æ—¶é—´` | `å‡å°‘ç­‰å¾…ã€ç½‘ç»œä¼˜åŒ–` | `å®æ—¶äº¤æ˜“ã€å³æ—¶é€šè®¯` |

**ğŸ’¡ ä¸¤è€…çš„å¹³è¡¡å…³ç³»**
```
é«˜ååé‡ç­–ç•¥ï¼š
- æ¶ˆæ¯æ‰“åŒ…æˆæ‰¹æ¬¡å‘é€
- ä½¿ç”¨å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“
- é€‚å½“å¢åŠ ç­‰å¾…æ—¶é—´ï¼Œæ”’æ›´å¤šæ¶ˆæ¯

ä½å»¶è¿Ÿç­–ç•¥ï¼š
- æ¶ˆæ¯ç«‹å³å‘é€ï¼Œä¸ç­‰å¾…
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- ä¼˜å…ˆå¤„ç†ï¼Œå‡å°‘æ’é˜Ÿæ—¶é—´

å®é™…é€‰æ‹©ï¼š
å¤§å¤šæ•°åœºæ™¯éœ€è¦åœ¨ä¸¤è€…é—´æ‰¾å¹³è¡¡ç‚¹
```

### 1.3 å½±å“Produceræ€§èƒ½çš„æ ¸å¿ƒå› ç´ 

**ğŸ”§ æ€§èƒ½å½±å“å› ç´ å…¨æ™¯å›¾**

```
Produceræ€§èƒ½å½±å“é“¾æ¡ï¼š

åº”ç”¨å±‚é¢ï¼š
æ¶ˆæ¯å¤§å° â†’ æ‰¹å¤„ç†é…ç½® â†’ å‘é€æ–¹å¼
    â†“           â†“          â†“
ç½‘ç»œå±‚é¢ï¼š
å¸¦å®½é™åˆ¶ â†’ è¿æ¥æ•° â†’ ç½‘ç»œå»¶è¿Ÿ
    â†“         â†“        â†“
Brokerå±‚é¢ï¼š
ç£ç›˜IO â†’ å‰¯æœ¬åŒæ­¥ â†’ åˆ†åŒºç­–ç•¥
```

**âš™ï¸ å…³é”®é…ç½®å‚æ•°é¢„è§ˆ**
- **batch.size**: æ§åˆ¶æ‰¹æ¬¡å¤§å°ï¼Œå½±å“ååé‡
- **linger.ms**: æ§åˆ¶ç­‰å¾…æ—¶é—´ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œååé‡  
- **compression.type**: é€‰æ‹©å‹ç¼©ç®—æ³•ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
- **buffer.memory**: è®¾ç½®å†…å­˜ç¼“å†²åŒºï¼Œé¿å…é˜»å¡
- **max.in.flight.requests.per.connection**: æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°

---

## 2. ğŸš€ ååé‡ä¼˜åŒ–ç­–ç•¥


### 2.1 ç†è§£ååé‡çš„æœ¬è´¨

ğŸ¯ **ç®€å•ç±»æ¯”**ï¼šååé‡å°±åƒé«˜é€Ÿå…¬è·¯çš„è½¦æµé‡

```
å•è½¦é“ vs å¤šè½¦é“ï¼š
ä¸€æ¡æ¶ˆæ¯ä¸€ä¸ªè¯·æ±‚ â†’ å•è½¦é“ï¼Œè½¦æµé‡å°
å¤šæ¡æ¶ˆæ¯æ‰“åŒ…å‘é€ â†’ å¤šè½¦é“ï¼Œè½¦æµé‡å¤§

æå‡ååé‡çš„æ ¸å¿ƒæ€è·¯ï¼š
1. å¢åŠ å•æ¬¡ä¼ è¾“çš„æ•°æ®é‡ï¼ˆæ‰¹å¤„ç†ï¼‰
2. å‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®å¤§å°ï¼ˆå‹ç¼©ï¼‰
3. æé«˜å¹¶è¡Œå¤„ç†èƒ½åŠ›ï¼ˆå¤šçº¿ç¨‹ï¼‰
4. å‡å°‘æ— æ•ˆç­‰å¾…æ—¶é—´ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
```

### 2.2 æ‰¹å¤„ç†ä¼˜åŒ–é…ç½®

**ğŸ“¦ batch.sizeå‚æ•°è¯¦è§£**

```java
// æ‰¹å¤„ç†å¤§å°é…ç½®ç¤ºä¾‹
Properties props = new Properties();
props.put("batch.size", 32768);  // 32KBï¼Œé»˜è®¤16KB

// ç†è§£æ‰¹å¤„ç†å·¥ä½œåŸç†ï¼š
// 1. Produceræ”¶é›†æ¶ˆæ¯åˆ°ç¼“å†²åŒº
// 2. å½“è¾¾åˆ°batch.sizeæˆ–è¶…æ—¶æ—¶å‘é€
// 3. ä¸€æ¬¡ç½‘ç»œè¯·æ±‚å‘é€æ•´ä¸ªæ‰¹æ¬¡
```

**ğŸ’¡ æ‰¹å¤„ç†å¤§å°é€‰æ‹©æŒ‡å—**
```
å°æ‰¹æ¬¡ (8KB - 16KB)ï¼š
âœ… é€‚åˆï¼šå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯
âœ… ä¼˜ç‚¹ï¼šå»¶è¿Ÿä½ï¼Œå“åº”å¿«
âŒ ç¼ºç‚¹ï¼šç½‘ç»œè¯·æ±‚å¤šï¼Œååé‡ä½

å¤§æ‰¹æ¬¡ (64KB - 1MB)ï¼š
âœ… é€‚åˆï¼šå¤§æ•°æ®é‡ä¼ è¾“åœºæ™¯
âœ… ä¼˜ç‚¹ï¼šç½‘ç»œæ•ˆç‡é«˜ï¼Œååé‡å¤§
âŒ ç¼ºç‚¹ï¼šå»¶è¿Ÿå¢åŠ ï¼Œå†…å­˜å ç”¨å¤§

æ¨èé…ç½®ï¼š
- å®æ—¶åœºæ™¯ï¼š16KB - 32KB
- æ‰¹é‡åœºæ™¯ï¼š128KB - 512KB
- å¤§æ•°æ®åœºæ™¯ï¼š1MB - 4MB
```

### 2.3 ç­‰å¾…æ—¶é—´ä¼˜åŒ–

**â° linger.mså‚æ•°è°ƒä¼˜**

```java
// ç­‰å¾…æ—¶é—´é…ç½®
props.put("linger.ms", 10);  // ç­‰å¾…10æ¯«ç§’

// å·¥ä½œæœºåˆ¶ç†è§£ï¼š
// å³ä½¿batch.sizeæœªæ»¡ï¼Œä¹Ÿä¼šåœ¨linger.msåå‘é€
// è¿™æ ·å¯ä»¥åœ¨å»¶è¿Ÿå’Œååé‡é—´æ‰¾å¹³è¡¡
```

**ğŸ² ç­‰å¾…æ—¶é—´ç­–ç•¥é€‰æ‹©**
```
é›¶ç­‰å¾… (linger.ms = 0)ï¼š
- æ¶ˆæ¯ç«‹å³å‘é€ï¼Œå»¶è¿Ÿæœ€ä½
- é€‚åˆï¼šé‡‘èäº¤æ˜“ã€å®æ—¶å‘Šè­¦

çŸ­ç­‰å¾… (1-10ms)ï¼š
- è½»å¾®å»¶è¿Ÿæ¢å–æ›´å¥½ååé‡
- é€‚åˆï¼šä¸€èˆ¬å®æ—¶åº”ç”¨

é•¿ç­‰å¾… (50-100ms)ï¼š
- æ˜¾è‘—æå‡ååé‡
- é€‚åˆï¼šæ—¥å¿—æ”¶é›†ã€æ•°æ®åŒæ­¥
```

### 2.4 å¹¶å‘ä¼˜åŒ–ç­–ç•¥

**ğŸ”— max.in.flight.requests.per.connectionè°ƒä¼˜**

```java
// å¹¶å‘è¯·æ±‚æ•°é…ç½®
props.put("max.in.flight.requests.per.connection", 5);

// å‚æ•°å«ä¹‰ï¼š
// å…è®¸åœ¨å•ä¸ªè¿æ¥ä¸ŠåŒæ—¶å‘é€çš„æœªç¡®è®¤è¯·æ±‚æ•°
// å¢åŠ æ­¤å€¼å¯æå‡ååé‡ï¼Œä½†å¯èƒ½å½±å“æ¶ˆæ¯é¡ºåº
```

**âš–ï¸ å¹¶å‘æ•°æƒè¡¡åˆ†æ**
```
ä½å¹¶å‘ (1-2)ï¼š
ä¼˜åŠ¿ï¼šä¿è¯æ¶ˆæ¯é¡ºåºï¼Œç½‘ç»œç¨³å®š
åŠ£åŠ¿ï¼šååé‡å—é™ï¼Œè¿æ¥åˆ©ç”¨ç‡ä½
é€‚åˆï¼šé¡ºåºæ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯

é«˜å¹¶å‘ (5-10)ï¼š
ä¼˜åŠ¿ï¼šååé‡å¤§ï¼Œè¿æ¥åˆ©ç”¨ç‡é«˜
åŠ£åŠ¿ï¼šå¯èƒ½ä¹±åºï¼Œç½‘ç»œå‹åŠ›å¤§
é€‚åˆï¼šååé‡ä¼˜å…ˆçš„æ‰¹é‡åœºæ™¯

å®é™…é€‰æ‹©å»ºè®®ï¼š
- éœ€è¦é¡ºåºï¼šè®¾ç½®ä¸º1
- ä¸€èˆ¬åœºæ™¯ï¼šè®¾ç½®ä¸º3-5
- ååä¼˜å…ˆï¼šè®¾ç½®ä¸º5-10
```

---

## 3. âš¡ å»¶è¿Ÿä¼˜åŒ–æŠ€æœ¯


### 3.1 å»¶è¿Ÿäº§ç”Ÿçš„æ ¹æœ¬åŸå› 

ğŸ• **æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œäº†**ï¼šå°±åƒå¿«é€’é…é€ï¼Œæ—¶é—´æ¶ˆè€—åœ¨å„ä¸ªç¯èŠ‚

```
æ¶ˆæ¯å‘é€å»¶è¿Ÿåˆ†è§£ï¼š

åº”ç”¨å¤„ç†æ—¶é—´ï¼š
åºåˆ—åŒ–æ¶ˆæ¯ â†’ åˆ†åŒºè®¡ç®— â†’ ç¼“å†²åŒºæ’é˜Ÿ
   1ms         0.1ms       å˜åŒ–å¾ˆå¤§

ç½‘ç»œä¼ è¾“æ—¶é—´ï¼š
å‘é€åˆ°Broker â†’ Brokerå¤„ç† â†’ å“åº”è¿”å›
    5-50ms        1-10ms      5-50ms

Brokerå¤„ç†æ—¶é—´ï¼š
å†™å…¥æ—¥å¿— â†’ å‰¯æœ¬åŒæ­¥ â†’ ç¡®è®¤å“åº”
   1-5ms     å˜åŒ–å¾ˆå¤§      0.1ms
```

### 3.2 å®¢æˆ·ç«¯å»¶è¿Ÿä¼˜åŒ–

**ğŸš€ å‡å°‘å®¢æˆ·ç«¯å¤„ç†æ—¶é—´**

```java
// å»¶è¿Ÿä¼˜åŒ–é…ç½®ç»„åˆ
Properties props = new Properties();
props.put("linger.ms", 0);           // ä¸ç­‰å¾…ï¼Œç«‹å³å‘é€
props.put("batch.size", 16384);      // é€‚ä¸­çš„æ‰¹æ¬¡å¤§å°
props.put("request.timeout.ms", 3000); // ç¼©çŸ­è¶…æ—¶æ—¶é—´
props.put("delivery.timeout.ms", 10000); // æ•´ä½“è¶…æ—¶æ§åˆ¶
```

**ğŸ’¡ å»¶è¿Ÿä¼˜åŒ–æŠ€å·§**
```
1. æ¶ˆæ¯é¢„å¤„ç†ä¼˜åŒ–ï¼š
   - æå‰åºåˆ—åŒ–å¸¸ç”¨æ¶ˆæ¯
   - ç¼“å­˜åˆ†åŒºè®¡ç®—ç»“æœ
   - ä½¿ç”¨æ›´å¿«çš„åºåˆ—åŒ–æ–¹å¼

2. å‘é€ç­–ç•¥ä¼˜åŒ–ï¼š
   - ä½¿ç”¨å¼‚æ­¥å‘é€é¿å…é˜»å¡
   - åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
   - é¿å…ä¸å¿…è¦çš„ç¡®è®¤ç­‰å¾…

3. ç½‘ç»œå±‚ä¼˜åŒ–ï¼š
   - ä½¿ç”¨TCP_NODELAYå‡å°‘ç½‘ç»œå»¶è¿Ÿ
   - å¢åŠ socketç¼“å†²åŒºå¤§å°
   - é€‰æ‹©æ›´è¿‘çš„BrokerèŠ‚ç‚¹
```

### 3.3 ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–

**ğŸŒ ç½‘ç»œå±‚é¢çš„ä¼˜åŒ–ç­–ç•¥**

```java
// ç½‘ç»œç›¸å…³ä¼˜åŒ–é…ç½®
props.put("send.buffer.bytes", 131072);    // 128KBå‘é€ç¼“å†²åŒº
props.put("receive.buffer.bytes", 65536);  // 64KBæ¥æ”¶ç¼“å†²åŒº
props.put("reconnect.backoff.ms", 50);     // å¿«é€Ÿé‡è¿
props.put("retry.backoff.ms", 100);        // é‡è¯•é—´éš”
```

**ğŸ“¡ ç½‘ç»œä¼˜åŒ–å®è·µ**
```
è¿æ¥ä¼˜åŒ–ï¼š
- å¤ç”¨é•¿è¿æ¥ï¼Œé¿å…é¢‘ç¹å»ºè¿
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
- é…ç½®åˆé€‚çš„å¿ƒè·³æœºåˆ¶

ä¼ è¾“ä¼˜åŒ–ï¼š
- é€‰æ‹©åˆé€‚çš„å‹ç¼©ç®—æ³•
- è°ƒæ•´TCPç¼“å†²åŒºå¤§å°
- å¯ç”¨ç½‘ç»œä¼˜åŒ–é€‰é¡¹

è·¯ç”±ä¼˜åŒ–ï¼š
- é€‰æ‹©ç½‘ç»œå»¶è¿Ÿæœ€ä½çš„Broker
- é¿å…è·¨åœ°åŸŸç½‘ç»œä¼ è¾“
- ä½¿ç”¨ä¸“çº¿æˆ–é«˜è´¨é‡ç½‘ç»œ
```

### 3.4 Brokerç«¯å»¶è¿Ÿä¼˜åŒ–

**âš™ï¸ æœåŠ¡ç«¯é…ç½®ä¼˜åŒ–**

```
Brokerç«¯å½±å“å»¶è¿Ÿçš„é…ç½®ï¼š

num.network.threads=8          # ç½‘ç»œå¤„ç†çº¿ç¨‹æ•°
num.io.threads=16              # IOå¤„ç†çº¿ç¨‹æ•°  
socket.send.buffer.bytes=102400    # Socketå‘é€ç¼“å†²
socket.receive.buffer.bytes=102400 # Socketæ¥æ”¶ç¼“å†²

log.flush.interval.messages=10000  # åˆ·ç›˜æ¶ˆæ¯æ•°
log.flush.interval.ms=1000         # åˆ·ç›˜æ—¶é—´é—´éš”
```

**ğŸ”§ å»¶è¿Ÿä¼˜åŒ–å»ºè®®**
```
å®æ—¶åœºæ™¯ä¼˜åŒ–ï¼š
- å‡å°‘å‰¯æœ¬æ•°é‡(replication.factor=2)
- ä½¿ç”¨acks=1è€Œéacks=all
- å¢åŠ ç½‘ç»œå’ŒIOçº¿ç¨‹æ•°é‡

æ‰¹é‡åœºæ™¯å¹³è¡¡ï¼š
- ä¿æŒé»˜è®¤å‰¯æœ¬æ•°é‡
- ä½¿ç”¨acks=allç¡®ä¿å¯é æ€§
- é€‚å½“è°ƒæ•´åˆ·ç›˜å‚æ•°
```

---

## 4. ğŸ“¦ æ‰¹å¤„ç†è°ƒä¼˜å®è·µ


### 4.1 æ‰¹å¤„ç†æœºåˆ¶æ·±åº¦è§£æ

ğŸ¯ **æ‰¹å¤„ç†å°±åƒæ‹¼è½¦æœåŠ¡**ï¼šç­‰äººé½äº†å†å‘è½¦ï¼Œæé«˜æ•ˆç‡

```
Kafkaæ‰¹å¤„ç†å·¥ä½œæµç¨‹ï¼š

æ­¥éª¤1ï¼šæ¶ˆæ¯æ”¶é›†
Produceræ”¶åˆ°æ¶ˆæ¯ â†’ æ”¾å…¥å¯¹åº”åˆ†åŒºçš„ç¼“å†²åŒº â†’ ç­‰å¾…å‘é€

æ­¥éª¤2ï¼šè§¦å‘æ¡ä»¶
æ»¡è¶³batch.sizeå¤§å° OR è¶…è¿‡linger.msæ—¶é—´ â†’ è§¦å‘å‘é€

æ­¥éª¤3ï¼šæ‰¹é‡å‘é€
å°†æ•´ä¸ªæ‰¹æ¬¡æ‰“åŒ… â†’ ä¸€æ¬¡ç½‘ç»œè¯·æ±‚å‘é€ â†’ ç­‰å¾…Brokerå“åº”

æ­¥éª¤4ï¼šå¤„ç†å“åº”
æ”¶åˆ°æˆåŠŸå“åº” â†’ è§¦å‘å›è°ƒå‡½æ•° â†’ é‡Šæ”¾ç¼“å†²åŒºå†…å­˜
```

### 4.2 æ‰¹å¤„ç†å¤§å°çš„ç²¾ç»†è°ƒä¼˜

**ğŸ“Š ä¸åŒåœºæ™¯çš„æ‰¹å¤„ç†ç­–ç•¥**

```java
// å®æ—¶äº¤æ˜“åœºæ™¯é…ç½®
Properties realTimeProps = new Properties();
realTimeProps.put("batch.size", 8192);    // 8KBï¼Œä¼˜å…ˆä½å»¶è¿Ÿ
realTimeProps.put("linger.ms", 0);        // ä¸ç­‰å¾…

// æ—¥å¿—æ”¶é›†åœºæ™¯é…ç½®  
Properties logProps = new Properties();
logProps.put("batch.size", 65536);        // 64KBï¼Œä¼˜åŒ–ååé‡
logProps.put("linger.ms", 50);            // ç­‰å¾…50msæ”¶é›†æ›´å¤šæ¶ˆæ¯

// å¤§æ•°æ®ä¼ è¾“åœºæ™¯é…ç½®
Properties bigDataProps = new Properties();
bigDataProps.put("batch.size", 524288);   // 512KBï¼Œæœ€å¤§ååé‡
bigDataProps.put("linger.ms", 100);       // ç­‰å¾…100ms
```

**ğŸ’¡ æ‰¹å¤„ç†å¤§å°é€‰æ‹©å…¬å¼**
```
æ‰¹å¤„ç†å¤§å°é€‰æ‹©è€ƒè™‘å› ç´ ï¼š

1. æ¶ˆæ¯å¹³å‡å¤§å°
   å¦‚æœå¹³å‡æ¶ˆæ¯1KBï¼Œbatch.sizeè®¾32KBï¼Œçº¦å¯å®¹çº³32æ¡æ¶ˆæ¯

2. æ¶ˆæ¯å‘é€é¢‘ç‡
   é«˜é¢‘å‘é€ï¼šè¾ƒå°batch.size + çŸ­linger.ms
   ä½é¢‘å‘é€ï¼šè¾ƒå¤§batch.size + é•¿linger.ms

3. ç½‘ç»œå¸¦å®½é™åˆ¶
   ä½å¸¦å®½ï¼šå‡å°batch.sizeï¼Œé¿å…ç½‘ç»œé˜»å¡
   é«˜å¸¦å®½ï¼šå¢å¤§batch.sizeï¼Œå……åˆ†åˆ©ç”¨å¸¦å®½

4. å†…å­˜é™åˆ¶
   batch.size Ã— åˆ†åŒºæ•° Ã— 2 â‰ˆ æœ€å°å†…å­˜éœ€æ±‚
```

### 4.3 å¤šåˆ†åŒºæ‰¹å¤„ç†ä¼˜åŒ–

**ğŸ”€ åˆ†åŒºçº§åˆ«çš„æ‰¹å¤„ç†ç®¡ç†**

```java
// åˆ†åŒºç­–ç•¥å¯¹æ‰¹å¤„ç†çš„å½±å“
public class CustomPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes, 
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        // ç­–ç•¥1ï¼šéšæœºåˆ†åŒºï¼Œå‡åŒ€åˆ†å¸ƒä½†å¯èƒ½å½±å“æ‰¹å¤„ç†æ•ˆç‡
        // return random.nextInt(partitions.size());
        
        // ç­–ç•¥2ï¼šåŸºäºkeyçš„å“ˆå¸Œï¼Œç›¸åŒkeyçš„æ¶ˆæ¯åœ¨åŒä¸€åˆ†åŒºï¼Œæœ‰åˆ©äºæ‰¹å¤„ç†
        return Math.abs(key.hashCode()) % partitions.size();
    }
}
```

**ğŸ“ˆ åˆ†åŒºæ•°é‡ä¸æ‰¹å¤„ç†æ•ˆç‡å…³ç³»**
```
åˆ†åŒºæ•°é‡å¯¹æ‰¹å¤„ç†çš„å½±å“ï¼š

å°‘åˆ†åŒºï¼ˆ1-10ä¸ªï¼‰ï¼š
âœ… ä¼˜åŠ¿ï¼šæ¶ˆæ¯å®¹æ˜“èšé›†ï¼Œæ‰¹æ¬¡å¡«æ»¡å¿«
âœ… é€‚åˆï¼šæ¶ˆæ¯é‡å¤§ä¸”ç›¸å¯¹é›†ä¸­çš„åœºæ™¯
âŒ åŠ£åŠ¿ï¼šå¹¶å‘åº¦ä½ï¼Œå¯èƒ½æˆä¸ºç“¶é¢ˆ

å¤šåˆ†åŒºï¼ˆ50+ä¸ªï¼‰ï¼š
âœ… ä¼˜åŠ¿ï¼šé«˜å¹¶å‘ï¼Œè´Ÿè½½å‡åŒ€
âŒ åŠ£åŠ¿ï¼šæ¶ˆæ¯åˆ†æ•£ï¼Œæ‰¹æ¬¡å¯èƒ½å¡«ä¸æ»¡
âŒ å½±å“ï¼šå¯èƒ½é™ä½æ‰¹å¤„ç†æ•ˆç‡

å¹³è¡¡ç­–ç•¥ï¼š
- æ ¹æ®æ¶ˆæ¯ç”Ÿäº§é€Ÿç‡åˆç†è®¾ç½®åˆ†åŒºæ•°
- åˆ†åŒºæ•° = ç›®æ ‡ååé‡ Ã· å•åˆ†åŒºæœ€å¤§ååé‡
- é€šå¸¸è®¾ç½®ä¸ºBrokeræ•°é‡çš„2-3å€
```

### 4.4 æ‰¹å¤„ç†ç›‘æ§ä¸è°ƒä¼˜

**ğŸ“Š æ‰¹å¤„ç†æ•ˆæœç›‘æ§æŒ‡æ ‡**

```java
// æ‰¹å¤„ç†æ•ˆæœç›‘æ§ä»£ç ç¤ºä¾‹
public class BatchMonitor {
    private final KafkaProducer<String, String> producer;
    
    public void sendWithMonitoring(String topic, String key, String value) {
        long startTime = System.currentTimeMillis();
        
        producer.send(new ProducerRecord<>(topic, key, value), 
            (metadata, exception) -> {
                if (exception == null) {
                    long latency = System.currentTimeMillis() - startTime;
                    // è®°å½•å»¶è¿ŸæŒ‡æ ‡
                    recordLatency(latency);
                    
                    // è®°å½•æ‰¹æ¬¡ä¿¡æ¯
                    recordBatchInfo(metadata);
                } else {
                    // è®°å½•å¤±è´¥æŒ‡æ ‡
                    recordFailure(exception);
                }
            });
    }
    
    private void recordBatchInfo(RecordMetadata metadata) {
        // ç›‘æ§æ‰¹æ¬¡å¤§å°ã€åˆ†åŒºåˆ†å¸ƒç­‰ä¿¡æ¯
        System.out.println("Partition: " + metadata.partition() + 
                          ", Offset: " + metadata.offset());
    }
}
```

**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡è§£è¯»**
```
æ‰¹å¤„ç†æ•ˆç‡æŒ‡æ ‡ï¼š

1. å¹³å‡æ‰¹æ¬¡å¤§å°
   è®¡ç®—ï¼šæ€»å‘é€å­—èŠ‚æ•° Ã· æ‰¹æ¬¡æ•°é‡
   ç›®æ ‡ï¼šæ¥è¿‘é…ç½®çš„batch.sizeå€¼

2. æ‰¹æ¬¡å¡«å……ç‡
   è®¡ç®—ï¼šå®é™…æ‰¹æ¬¡å¤§å° Ã· batch.size
   ç›®æ ‡ï¼š>80%è¡¨ç¤ºæ‰¹å¤„ç†æ•ˆæœè‰¯å¥½

3. ç­‰å¾…æ—¶é—´åˆ†å¸ƒ
   ç»Ÿè®¡ï¼šæ¶ˆæ¯åœ¨ç¼“å†²åŒºçš„å¹³å‡ç­‰å¾…æ—¶é—´
   ç›®æ ‡ï¼šå¤§éƒ¨åˆ†æ¶ˆæ¯ç­‰å¾…æ—¶é—´ < linger.ms

4. åˆ†åŒºå‡åŒ€åº¦
   è®¡ç®—ï¼šå„åˆ†åŒºæ¶ˆæ¯æ•°é‡çš„æ ‡å‡†å·®
   ç›®æ ‡ï¼šæ ‡å‡†å·®è¶Šå°ï¼Œåˆ†å¸ƒè¶Šå‡åŒ€
```

---

## 5. ğŸ—œï¸ å‹ç¼©ç®—æ³•é€‰æ‹©ä¸å¯¹æ¯”


### 5.1 å‹ç¼©ç®—æ³•åŸºç¡€æ¦‚å¿µ

ğŸ¯ **å‹ç¼©å°±åƒæ‰“åŒ…è¡Œæ**ï¼šæŠŠå¤§ç®±å­çš„ä¸œè¥¿è£…è¿›å°ç®±å­

```
ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©ï¼š
åŸå§‹æ•°æ®ï¼šä¸€æœ¬åšåšçš„ä¹¦ â†’ ç½‘ç»œä¼ è¾“æ…¢ï¼Œå ç”¨å¸¦å®½å¤š
å‹ç¼©æ•°æ®ï¼šå‹ç¼©æˆå°åŒ…è£¹ â†’ ä¼ è¾“å¿«ï¼ŒèŠ‚çœå¸¦å®½
è§£å‹æ•°æ®ï¼šåˆ°è¾¾åè¿˜åŸæˆä¹¦ â†’ å¯ä»¥æ­£å¸¸ä½¿ç”¨

Kafkaå‹ç¼©çš„å¥½å¤„ï¼š
1. å‡å°‘ç½‘ç»œä¼ è¾“æ—¶é—´
2. èŠ‚çœç£ç›˜å­˜å‚¨ç©ºé—´  
3. é™ä½ç½‘ç»œå¸¦å®½æˆæœ¬
4. æé«˜æ•´ä½“ååé‡
```

### 5.2 å››ç§å‹ç¼©ç®—æ³•è¯¦ç»†å¯¹æ¯”

**ğŸ“Š å‹ç¼©ç®—æ³•ç‰¹æ€§å¯¹æ¯”è¡¨**

| å‹ç¼©ç®—æ³• | **å‹ç¼©ç‡** | **CPUæ¶ˆè€—** | **å‹ç¼©é€Ÿåº¦** | **è§£å‹é€Ÿåº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|-----------|-----------|-----------|-----------|
| ğŸ”¸ **none** | `æ— å‹ç¼©` | `æœ€ä½` | `æœ€å¿«` | `æœ€å¿«` | `CPUæ•æ„Ÿåœºæ™¯` |
| ğŸ”¸ **gzip** | `æœ€é«˜` | `æœ€é«˜` | `æ…¢` | `ä¸­ç­‰` | `å¸¦å®½å—é™åœºæ™¯` |
| ğŸ”¸ **lz4** | `ä¸­ç­‰` | `ä½` | `å¿«` | `æœ€å¿«` | `å‡è¡¡åœºæ™¯æ¨è` |
| ğŸ”¸ **snappy** | `ä¸­ç­‰` | `ä¸­ç­‰` | `å¿«` | `å¿«` | `Googleç”Ÿæ€` |
| ğŸ”¸ **zstd** | `é«˜` | `ä¸­ç­‰` | `ä¸­ç­‰` | `å¿«` | `æ–°ä¸€ä»£é€‰æ‹©` |

### 5.3 å‹ç¼©ç®—æ³•å®æˆ˜é…ç½®

**âš™ï¸ ä¸åŒåœºæ™¯çš„å‹ç¼©é…ç½®**

```java
// é«˜ååé‡åœºæ™¯ - æ¨èlz4
Properties highThroughputProps = new Properties();
highThroughputProps.put("compression.type", "lz4");
// ä¼˜åŠ¿ï¼šå‹ç¼©å¿«ï¼Œè§£å‹å¿«ï¼ŒCPUå¼€é”€å°

// å¸¦å®½å—é™åœºæ™¯ - æ¨ègzip
Properties lowBandwidthProps = new Properties();
lowBandwidthProps.put("compression.type", "gzip");
// ä¼˜åŠ¿ï¼šå‹ç¼©ç‡æœ€é«˜ï¼Œç½‘ç»œä¼ è¾“é‡æœ€å°

// å¹³è¡¡åœºæ™¯ - æ¨èzstd
Properties balancedProps = new Properties();
balancedProps.put("compression.type", "zstd");
// ä¼˜åŠ¿ï¼šå‹ç¼©ç‡å’Œé€Ÿåº¦çš„æœ€ä½³å¹³è¡¡

// CPUæ•æ„Ÿåœºæ™¯ - ä¸å‹ç¼©
Properties cpuSensitiveProps = new Properties();
cpuSensitiveProps.put("compression.type", "none");
// ä¼˜åŠ¿ï¼šCPUå¼€é”€ä¸º0ï¼Œå»¶è¿Ÿæœ€ä½
```

### 5.4 å‹ç¼©æ•ˆæœæµ‹è¯•ä¸é€‰æ‹©

**ğŸ§ª å¦‚ä½•æµ‹è¯•é€‰æ‹©æœ€é€‚åˆçš„å‹ç¼©ç®—æ³•**

```java
// å‹ç¼©æ•ˆæœæµ‹è¯•å·¥å…·ç±»
public class CompressionTester {
    
    public void testCompressionRatio(String sampleData) {
        String[] algorithms = {"none", "gzip", "lz4", "snappy", "zstd"};
        
        for (String algorithm : algorithms) {
            long startTime = System.currentTimeMillis();
            
            // æ¨¡æ‹Ÿå‹ç¼©è¿‡ç¨‹
            byte[] compressed = compress(sampleData, algorithm);
            long compressionTime = System.currentTimeMillis() - startTime;
            
            // è®¡ç®—å‹ç¼©ç‡
            double ratio = (double) compressed.length / sampleData.length();
            
            System.out.printf("%s: å‹ç¼©ç‡=%.2f, å‹ç¼©æ—¶é—´=%dms%n", 
                             algorithm, ratio, compressionTime);
        }
    }
}
```

**ğŸ’¡ å‹ç¼©ç®—æ³•é€‰æ‹©å†³ç­–æ ‘**
```
é€‰æ‹©æµç¨‹ï¼š

1. é¦–å…ˆè¯„ä¼°ç½‘ç»œç¯å¢ƒ
   ç½‘ç»œå¸¦å®½å……è¶³ â†’ è€ƒè™‘lz4æˆ–none
   ç½‘ç»œå¸¦å®½å—é™ â†’ è€ƒè™‘gzipæˆ–zstd

2. ç„¶åè¯„ä¼°CPUèµ„æº
   CPUèµ„æºç´§å¼  â†’ é€‰æ‹©lz4æˆ–none
   CPUèµ„æºå……è¶³ â†’ å¯ä»¥é€‰æ‹©gzipæˆ–zstd

3. æœ€åè¯„ä¼°å»¶è¿Ÿè¦æ±‚
   å»¶è¿Ÿæ•æ„Ÿ â†’ é€‰æ‹©lz4æˆ–none
   å»¶è¿Ÿä¸æ•æ„Ÿ â†’ é€‰æ‹©gzipæˆ–zstd

4. ç»¼åˆå†³ç­–å»ºè®®
   é€šç”¨æ¨èï¼šlz4ï¼ˆé€Ÿåº¦å’Œå‹ç¼©ç‡å¹³è¡¡ï¼‰
   å¸¦å®½ä¼˜å…ˆï¼šgzipï¼ˆæœ€é«˜å‹ç¼©ç‡ï¼‰
   æ€§èƒ½ä¼˜å…ˆï¼šnoneï¼ˆæœ€ä½å»¶è¿Ÿï¼‰
   ç°ä»£é€‰æ‹©ï¼šzstdï¼ˆæ–°ä¸€ä»£ç®—æ³•ï¼‰
```

### 5.5 å‹ç¼©é…ç½®çš„é«˜çº§æŠ€å·§

**ğŸ”§ å‹ç¼©ä¼˜åŒ–çš„è¿›é˜¶é…ç½®**

```java
// é«˜çº§å‹ç¼©é…ç½®
Properties advancedProps = new Properties();

// 1. æ¶ˆæ¯çº§åˆ«è®¾ç½®å‹ç¼©
advancedProps.put("compression.type", "lz4");

// 2. æ‰¹æ¬¡å¤§å°é…åˆå‹ç¼©ä¼˜åŒ–
advancedProps.put("batch.size", 65536);  // è¾ƒå¤§æ‰¹æ¬¡æé«˜å‹ç¼©æ•ˆæœ

// 3. ç¼“å†²åŒºé…ç½®
advancedProps.put("buffer.memory", 67108864);  // 64MBï¼Œä¸ºå‹ç¼©é¢„ç•™å†…å­˜

// 4. Producerç«¯é¢„å‹ç¼©
advancedProps.put("max.request.size", 10485760); // 10MBï¼Œæ”¯æŒè¾ƒå¤§å‹ç¼©æ‰¹æ¬¡
```

**âš ï¸ å‹ç¼©ä½¿ç”¨æ³¨æ„äº‹é¡¹**
```
å‹ç¼©çš„æ³¨æ„ç‚¹ï¼š

1. å†…å­˜å½±å“
   å‹ç¼©éœ€è¦é¢å¤–å†…å­˜ï¼Œç‰¹åˆ«æ˜¯gzip
   å»ºè®®ï¼šå¢åŠ buffer.memoryé…ç½®

2. CPUå½±å“  
   å‹ç¼©ä¼šæ¶ˆè€—CPUèµ„æº
   å»ºè®®ï¼šç›‘æ§CPUä½¿ç”¨ç‡ï¼Œé¿å…è¿‡è½½

3. å»¶è¿Ÿå½±å“
   å‹ç¼©è§£å‹ä¼šå¢åŠ å»¶è¿Ÿ
   å»ºè®®ï¼šå»¶è¿Ÿæ•æ„Ÿåœºæ™¯è°¨æ…é€‰æ‹©

4. å…¼å®¹æ€§
   Consumerç«¯éœ€è¦æ”¯æŒç›¸åº”çš„è§£å‹ç®—æ³•
   å»ºè®®ï¼šç¡®ä¿å®¢æˆ·ç«¯ç‰ˆæœ¬å…¼å®¹
```

---

## 6. ğŸš€ å¼‚æ­¥å‘é€ä¼˜åŒ–


### 6.1 åŒæ­¥ vs å¼‚æ­¥å‘é€å¯¹æ¯”

ğŸ¯ **å¼‚æ­¥å°±åƒç‚¹å¤–å–**ï¼šä¸‹å•åä¸ç”¨ç­‰ï¼Œå¯ä»¥åšå…¶ä»–äº‹æƒ…

```
åŒæ­¥å‘é€ï¼ˆå ‚é£Ÿæ¨¡å¼ï¼‰ï¼š
å‘é€æ¶ˆæ¯ â†’ ç­‰å¾…ç¡®è®¤ â†’ ç»§ç»­ä¸‹ä¸€æ¡
ç‰¹ç‚¹ï¼šç®€å•å¯é ï¼Œä½†æ•ˆç‡ä½ï¼Œä¼šé˜»å¡

å¼‚æ­¥å‘é€ï¼ˆå¤–å–æ¨¡å¼ï¼‰ï¼š
å‘é€æ¶ˆæ¯ â†’ ç«‹å³è¿”å› â†’ ç»§ç»­å‘é€ä¸‹ä¸€æ¡
ç‰¹ç‚¹ï¼šæ•ˆç‡é«˜ï¼Œä¸é˜»å¡ï¼Œä½†éœ€è¦å¤„ç†å›è°ƒ

æ€§èƒ½å¯¹æ¯”ï¼š
åŒæ­¥å‘é€ï¼š1æ¡æ¶ˆæ¯/æ¬¡ç½‘ç»œå¾€è¿”
å¼‚æ­¥å‘é€ï¼šå¤šæ¡æ¶ˆæ¯/æ¬¡ç½‘ç»œå¾€è¿”ï¼ˆæ‰¹å¤„ç†ï¼‰
```

### 6.2 å¼‚æ­¥å‘é€å®ç°æ¨¡å¼

**ğŸ“ ä¸‰ç§å¼‚æ­¥å‘é€æ¨¡å¼å¯¹æ¯”**

```java
// æ¨¡å¼1ï¼šFire-and-Forgetï¼ˆå‘é€å³å¿˜ï¼‰
public void fireAndForget(String topic, String key, String value) {
    ProducerRecord<String, String> record = 
        new ProducerRecord<>(topic, key, value);
    
    producer.send(record);  // ä¸å…³å¿ƒç»“æœï¼Œæ€§èƒ½æœ€é«˜
    // ä¼˜ç‚¹ï¼šæ€§èƒ½æœ€å¥½ï¼Œä»£ç ç®€å•
    // ç¼ºç‚¹ï¼šæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œæ— æ³•å¤„ç†é”™è¯¯
}

// æ¨¡å¼2ï¼šå¼‚æ­¥å›è°ƒï¼ˆæ¨èï¼‰
public void sendWithCallback(String topic, String key, String value) {
    ProducerRecord<String, String> record = 
        new ProducerRecord<>(topic, key, value);
    
    producer.send(record, new Callback() {
        @Override
        public void onCompletion(RecordMetadata metadata, Exception exception) {
            if (exception != null) {
                // å¤„ç†å‘é€å¤±è´¥
                handleSendFailure(exception, record);
            } else {
                // å¤„ç†å‘é€æˆåŠŸ
                handleSendSuccess(metadata);
            }
        }
    });
}

// æ¨¡å¼3ï¼šFutureæ¨¡å¼
public void sendWithFuture(String topic, String key, String value) {
    ProducerRecord<String, String> record = 
        new ProducerRecord<>(topic, key, value);
    
    Future<RecordMetadata> future = producer.send(record);
    
    // å¯ä»¥å…ˆåšå…¶ä»–äº‹æƒ…ï¼Œéœ€è¦ç»“æœæ—¶å†è·å–
    try {
        RecordMetadata metadata = future.get(1000, TimeUnit.MILLISECONDS);
        // å¤„ç†æˆåŠŸç»“æœ
    } catch (Exception e) {
        // å¤„ç†å¼‚å¸¸
    }
}
```

### 6.3 å¼‚æ­¥å‘é€çš„æ€§èƒ½ä¼˜åŒ–

**âš¡ æå‡å¼‚æ­¥å‘é€æ€§èƒ½çš„é…ç½®**

```java
// å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–é…ç½®
Properties asyncProps = new Properties();

// 1. å¢åŠ å¹¶å‘è¯·æ±‚æ•°
asyncProps.put("max.in.flight.requests.per.connection", 5);
// å…è®¸æ›´å¤šæœªç¡®è®¤è¯·æ±‚ï¼Œæé«˜å¹¶å‘åº¦

// 2. ä¼˜åŒ–æ‰¹å¤„ç†é…ç½®
asyncProps.put("batch.size", 32768);        // 32KB
asyncProps.put("linger.ms", 10);            // ç­‰å¾…10msèšåˆæ¶ˆæ¯

// 3. å¢åŠ ç¼“å†²åŒºå†…å­˜
asyncProps.put("buffer.memory", 134217728); // 128MB
// æ›´å¤§ç¼“å†²åŒºæ”¯æŒæ›´å¤šå¼‚æ­¥æ¶ˆæ¯

// 4. é…ç½®é‡è¯•ç­–ç•¥
asyncProps.put("retries", 3);               // é‡è¯•3æ¬¡
asyncProps.put("retry.backoff.ms", 100);    // é‡è¯•é—´éš”100ms
```

### 6.4 å¼‚æ­¥å‘é€çš„é”™è¯¯å¤„ç†

**ğŸ›¡ï¸ å¥å£®çš„å¼‚æ­¥é”™è¯¯å¤„ç†ç­–ç•¥**

```java
public class AsyncProducerWithErrorHandling {
    private final KafkaProducer<String, String> producer;
    private final ExecutorService retryExecutor;
    
    // å‘é€å¤±è´¥å¤„ç†ç­–ç•¥
    private void handleSendFailure(Exception exception, 
                                  ProducerRecord<String, String> record) {
        
        if (exception instanceof RetriableException) {
            // å¯é‡è¯•å¼‚å¸¸ï¼šç½‘ç»œè¶…æ—¶ã€Brokerä¸´æ—¶ä¸å¯ç”¨ç­‰
            retrySendAsync(record, 3);  // é‡è¯•3æ¬¡
            
        } else if (exception instanceof RecordTooLargeException) {
            // æ¶ˆæ¯è¿‡å¤§å¼‚å¸¸ï¼šåˆ†å‰²æ¶ˆæ¯æˆ–è®°å½•é”™è¯¯
            handleMessageTooLarge(record);
            
        } else {
            // å…¶ä»–å¼‚å¸¸ï¼šè®°å½•æ—¥å¿—ï¼Œå‘é€å‘Šè­¦
            logError("å‘é€å¤±è´¥", exception, record);
            sendAlert("æ¶ˆæ¯å‘é€å¼‚å¸¸", exception.getMessage());
        }
    }
    
    // å¼‚æ­¥é‡è¯•æœºåˆ¶
    private void retryS endAsync(ProducerRecord<String, String> record, 
                                int maxRetries) {
        retryExecutor.submit(() -> {
            for (int i = 0; i < maxRetries; i++) {
                try {
                    Thread.sleep(1000 * (i + 1));  // é€’å¢å»¶è¿Ÿ
                    
                    producer.send(record, (metadata, exception) -> {
                        if (exception != null && i == maxRetries - 1) {
                            // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥ï¼Œè®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—
                            sendToDeadLetterQueue(record);
                        }
                    });
                    break;  // é‡è¯•æˆåŠŸï¼Œè·³å‡ºå¾ªç¯
                } catch (Exception e) {
                    if (i == maxRetries - 1) {
                        sendToDeadLetterQueue(record);
                    }
                }
            }
        });
    }
}
```

### 6.5 å¼‚æ­¥å‘é€çš„ç›‘æ§æŒ‡æ ‡

**ğŸ“Š å…³é”®å¼‚æ­¥æ€§èƒ½æŒ‡æ ‡**

```java
public class AsyncMetrics {
    private final AtomicLong successCount = new AtomicLong(0);
    private final AtomicLong failureCount = new AtomicLong(0);
    private final AtomicLong retryCount = new AtomicLong(0);
    
    // å›è°ƒä¸­æ›´æ–°æŒ‡æ ‡
    public Callback createMetricsCallback() {
        return new Callback() {
            @Override
            public void onCompletion(RecordMetadata metadata, Exception exception) {
                if (exception == null) {
                    successCount.incrementAndGet();
                    recordLatency(System.currentTimeMillis() - sendTime);
                } else {
                    failureCount.incrementAndGet();
                    
                    if (exception instanceof RetriableException) {
                        retryCount.incrementAndGet();
                    }
                }
            }
        };
    }
    
    // å®šæœŸè¾“å‡ºç›‘æ§æŒ‡æ ‡
    public void printMetrics() {
        long success = successCount.get();
        long failure = failureCount.get();
        long total = success + failure;
        
        if (total > 0) {
            double successRate = (double) success / total * 100;
            System.out.printf("å‘é€æˆåŠŸç‡: %.2f%%, æ€»æ•°: %d, é‡è¯•: %d%n", 
                             successRate, total, retryCount.get());
        }
    }
}
```

**ğŸ“ˆ å¼‚æ­¥å‘é€ç›‘æ§é‡ç‚¹**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š

1. å‘é€æˆåŠŸç‡
   è®¡ç®—ï¼šæˆåŠŸæ•° Ã· æ€»å‘é€æ•° Ã— 100%
   ç›®æ ‡ï¼š> 99.9%

2. å¹³å‡å»¶è¿Ÿ
   è®¡ç®—ï¼šæ€»å»¶è¿Ÿæ—¶é—´ Ã· æˆåŠŸå‘é€æ•°
   ç›®æ ‡ï¼š< 100msï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰

3. ç¼“å†²åŒºä½¿ç”¨ç‡
   è®¡ç®—ï¼šå·²ç”¨å†…å­˜ Ã· buffer.memory Ã— 100%
   ç›®æ ‡ï¼š< 80%ï¼ˆé¿å…é˜»å¡ï¼‰

4. é‡è¯•é¢‘ç‡
   è®¡ç®—ï¼šé‡è¯•æ¬¡æ•° Ã· æ€»å‘é€æ¬¡æ•° Ã— 100%
   ç›®æ ‡ï¼š< 5%ï¼ˆç½‘ç»œç¨³å®šçš„æƒ…å†µä¸‹ï¼‰
```

---

## 7. ğŸ’¾ å†…å­˜ä½¿ç”¨ä¼˜åŒ–


### 7.1 Kafka Producerå†…å­˜ä½¿ç”¨åŸç†

ğŸ¯ **Producerå†…å­˜å°±åƒæ°´åº“**ï¼šéœ€è¦åˆç†è§„åˆ’å®¹é‡å’Œä½¿ç”¨ç­–ç•¥

```
Producerå†…å­˜ä½¿ç”¨å…¨æ™¯ï¼š

æ€»å†…å­˜æ± ï¼ˆbuffer.memoryï¼‰
â”œâ”€â”€ åˆ†åŒºç¼“å†²åŒº
â”‚   â”œâ”€â”€ åˆ†åŒº1çš„æ¶ˆæ¯æ‰¹æ¬¡
â”‚   â”œâ”€â”€ åˆ†åŒº2çš„æ¶ˆæ¯æ‰¹æ¬¡
â”‚   â””â”€â”€ ...
â”œâ”€â”€ å‹ç¼©å†…å­˜
â”‚   â””â”€â”€ ä¸´æ—¶å‹ç¼©ç©ºé—´
â”œâ”€â”€ å…ƒæ•°æ®å†…å­˜
â”‚   â””â”€â”€ ä¸»é¢˜åˆ†åŒºä¿¡æ¯
â””â”€â”€ å…¶ä»–å†…å­˜
    â””â”€â”€ åºåˆ—åŒ–ã€ç½‘ç»œç¼“å†²ç­‰
```

### 7.2 å†…å­˜é…ç½®å‚æ•°è¯¦è§£

**ğŸ“Š å…³é”®å†…å­˜å‚æ•°è§£æ**

```java
// å†…å­˜ä¼˜åŒ–é…ç½®è¯¦è§£
Properties memoryProps = new Properties();

// 1. æ€»å†…å­˜æ± é…ç½®
memoryProps.put("buffer.memory", 134217728);  // 128MB
// å«ä¹‰ï¼šProducerå¯ç”¨çš„æ€»å†…å­˜å¤§å°
// å½±å“ï¼šå¤ªå°ä¼šå¯¼è‡´é˜»å¡ï¼Œå¤ªå¤§æµªè´¹å†…å­˜

// 2. æ‰¹æ¬¡å¤§å°é…ç½®  
memoryProps.put("batch.size", 32768);         // 32KB
// å«ä¹‰ï¼šæ¯ä¸ªåˆ†åŒºæ‰¹æ¬¡çš„æœ€å¤§å¤§å°
// å†…å­˜å½±å“ï¼šbatch.size Ã— åˆ†åŒºæ•° = åŸºç¡€å†…å­˜éœ€æ±‚

// 3. æœ€å¤§è¯·æ±‚å¤§å°
memoryProps.put("max.request.size", 10485760); // 10MB
// å«ä¹‰ï¼šå•ä¸ªè¯·æ±‚çš„æœ€å¤§å¤§å°
// å½±å“ï¼šéœ€è¦é¢„ç•™ç›¸åº”çš„å†…å­˜ç©ºé—´
```

**ğŸ’¡ å†…å­˜è®¡ç®—å…¬å¼**
```
Producerå†…å­˜éœ€æ±‚ä¼°ç®—ï¼š

åŸºç¡€å†…å­˜éœ€æ±‚ï¼š
batch.size Ã— åˆ†åŒºæ•° Ã— 2ï¼ˆå‘é€å’Œæ¥æ”¶ç¼“å†²åŒºï¼‰

ç¤ºä¾‹è®¡ç®—ï¼š
batch.size = 32KB
åˆ†åŒºæ•° = 100
åŸºç¡€éœ€æ±‚ = 32KB Ã— 100 Ã— 2 = 6.4MB

æ¨èbuffer.memoryè®¾ç½®ï¼š
buffer.memory = åŸºç¡€éœ€æ±‚ Ã— 10 = 64MBï¼ˆå®‰å…¨ä½™é‡ï¼‰

å®é™…ç”Ÿäº§å»ºè®®ï¼š
å°è§„æ¨¡ï¼š64MB - 128MB
ä¸­ç­‰è§„æ¨¡ï¼š128MB - 256MB  
å¤§è§„æ¨¡ï¼š256MB - 512MB
```

### 7.3 å†…å­˜é˜»å¡é—®é¢˜è§£å†³

**ğŸš« é¿å…å†…å­˜è€—å°½å¯¼è‡´çš„é˜»å¡**

```java
// å†…å­˜é˜»å¡æ£€æµ‹å’Œå¤„ç†
public class MemoryMonitorProducer {
    private final KafkaProducer<String, String> producer;
    private final AtomicLong blockedTime = new AtomicLong(0);
    
    public void sendWithMemoryMonitor(String topic, String key, String value) {
        long startTime = System.currentTimeMillis();
        
        try {
            producer.send(new ProducerRecord<>(topic, key, value));
        } catch (Exception e) {
            if (e.getMessage().contains("buffer memory")) {
                // å†…å­˜ä¸è¶³å¯¼è‡´çš„é˜»å¡
                long blocked = System.currentTimeMillis() - startTime;
                blockedTime.addAndGet(blocked);
                
                // å¤„ç†å†…å­˜ä¸è¶³
                handleMemoryExhaustion(blocked);
            }
        }
    }
    
    private void handleMemoryExhaustion(long blockedMs) {
        if (blockedMs > 5000) {  // é˜»å¡è¶…è¿‡5ç§’
            // 1. è®°å½•å‘Šè­¦
            System.err.println("Producerå†…å­˜ä¸è¶³ï¼Œé˜»å¡æ—¶é—´: " + blockedMs + "ms");
            
            // 2. å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒº
            producer.flush();
            
            // 3. è€ƒè™‘é™çº§ç­–ç•¥
            // ä¾‹å¦‚ï¼šä¸´æ—¶ä¸¢å¼ƒéå…³é”®æ¶ˆæ¯
        }
    }
}
```

### 7.4 å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥

**ğŸ”§ å†…å­˜ä¼˜åŒ–æœ€ä½³å®è·µ**

```java
// å†…å­˜ä¼˜åŒ–é…ç½®ç­–ç•¥
public class MemoryOptimizedProducer {
    
    // ç­–ç•¥1ï¼šåˆ†å±‚å†…å­˜é…ç½®
    public Properties createMemoryEfficientConfig() {
        Properties props = new Properties();
        
        // æ ¹æ®æ¶ˆæ¯ç‰¹å¾è°ƒæ•´æ‰¹æ¬¡å¤§å°
        if (isLargeMessage()) {
            props.put("batch.size", 65536);     // 64KBï¼Œé€‚åˆå¤§æ¶ˆæ¯
            props.put("buffer.memory", 268435456); // 256MB
        } else {
            props.put("batch.size", 16384);     // 16KBï¼Œé€‚åˆå°æ¶ˆæ¯
            props.put("buffer.memory", 134217728); // 128MB
        }
        
        // è®¾ç½®å†…å­˜ä½¿ç”¨ä¸Šé™
        props.put("max.block.ms", 5000);     // 5ç§’è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
        
        return props;
    }
    
    // ç­–ç•¥2ï¼šåŠ¨æ€å†…å­˜ç›‘æ§
    public void enableMemoryMonitoring() {
        Timer timer = new Timer();
        timer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
                long totalMemory = Runtime.getRuntime().totalMemory();
                long freeMemory = Runtime.getRuntime().freeMemory();
                double usage = (double)(totalMemory - freeMemory) / totalMemory;
                
                if (usage > 0.8) {  // å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%
                    // è§¦å‘å†…å­˜ä¼˜åŒ–ç­–ç•¥
                    optimizeMemoryUsage();
                }
            }
        }, 0, 10000);  // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    private void optimizeMemoryUsage() {
        // 1. å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å†²åŒº
        producer.flush();
        
        // 2. å»ºè®®GC
        System.gc();
        
        // 3. ä¸´æ—¶é™ä½æ‰¹æ¬¡å¤§å°
        // æ³¨æ„ï¼šè¿™éœ€è¦é‡æ–°åˆ›å»ºProducerï¼Œå®é™…ç”Ÿäº§ä¸­è°¨æ…ä½¿ç”¨
    }
}
```

### 7.5 å†…å­˜æ€§èƒ½ç›‘æ§

**ğŸ“Š å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§**

```java
// å†…å­˜ç›‘æ§æŒ‡æ ‡æ”¶é›†
public class ProducerMemoryMetrics {
    private final KafkaProducer<String, String> producer;
    
    public void collectMemoryMetrics() {
        // 1. JVMå†…å­˜æŒ‡æ ‡
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        
        System.out.printf("JVMå †å†…å­˜: ä½¿ç”¨=%dMB, æœ€å¤§=%dMB, ä½¿ç”¨ç‡=%.2f%%%n",
                         heapUsage.getUsed() / 1024 / 1024,
                         heapUsage.getMax() / 1024 / 1024,
                         (double) heapUsage.getUsed() / heapUsage.getMax() * 100);
        
        // 2. Producerç‰¹å®šæŒ‡æ ‡
        Map<MetricName, ? extends Metric> metrics = producer.metrics();
        
        for (Map.Entry<MetricName, ? extends Metric> entry : metrics.entrySet()) {
            String metricName = entry.getKey().name();
            
            if (metricName.contains("buffer-") || metricName.contains("memory")) {
                System.out.printf("ProduceræŒ‡æ ‡: %s = %s%n", 
                                 metricName, entry.getValue().metricValue());
            }
        }
    }
}
```

**âš ï¸ å†…å­˜ä¼˜åŒ–æ³¨æ„äº‹é¡¹**
```
å†…å­˜ä¼˜åŒ–è¦ç‚¹ï¼š

1. é¿å…è¿‡åº¦åˆ†é…
   ä¸è¦è®¾ç½®è¿‡å¤§çš„buffer.memory
   æ ¹æ®å®é™…éœ€æ±‚åˆç†åˆ†é…

2. ç›‘æ§å†…å­˜ä½¿ç”¨ç‡
   å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
   åŠæ—¶å‘ç°å†…å­˜æ³„æ¼é—®é¢˜

3. å¤„ç†å†…å­˜å‹åŠ›
   è®¾ç½®max.block.msé¿å…æ°¸ä¹…é˜»å¡
   å®ç°é™çº§ç­–ç•¥å¤„ç†å†…å­˜ä¸è¶³

4. GCå½±å“è€ƒè™‘
   å¤§å†…å­˜å¯èƒ½å¯¼è‡´GCå‹åŠ›
   åˆç†é…ç½®JVM GCå‚æ•°

5. å¤šProducerå®ä¾‹
   è€ƒè™‘ä½¿ç”¨å¤šä¸ªProduceråˆ†æ‹…å†…å­˜å‹åŠ›
   é¿å…å•ä¸ªProduceræ‰¿å—è¿‡å¤§å‹åŠ›
```

---

## 8. ğŸ”— è¿æ¥æ± ç®¡ç†


### 8.1 Kafka Producerè¿æ¥ç®¡ç†æœºåˆ¶

ğŸ¯ **è¿æ¥å°±åƒç”µè¯çº¿**ï¼šå»ºç«‹è¿æ¥éœ€è¦æ—¶é—´ï¼Œå¤ç”¨è¿æ¥æé«˜æ•ˆç‡

```
Kafkaè¿æ¥å·¥ä½œåŸç†ï¼š

å•è¿æ¥æ¨¡å¼ï¼š
æ¯æ¬¡å‘æ¶ˆæ¯éƒ½å»ºæ–°è¿æ¥ â†’ æ¡æ‰‹å¼€é”€å¤§ â†’ æ•ˆç‡ä½

è¿æ¥å¤ç”¨æ¨¡å¼ï¼š
å»ºç«‹é•¿è¿æ¥ â†’ å¤šæ¬¡å¤ç”¨ â†’ æ•ˆç‡é«˜ â†’ Kafkaé»˜è®¤æ¨¡å¼

è¿æ¥æ± æ¨¡å¼ï¼š
ç»´æŠ¤å¤šæ¡è¿æ¥ â†’ è´Ÿè½½å‡è¡¡ â†’ æ›´é«˜å¹¶å‘
```

### 8.2 Producerè¿æ¥é…ç½®ä¼˜åŒ–

**âš™ï¸ è¿æ¥ç›¸å…³æ ¸å¿ƒé…ç½®**

```java
// è¿æ¥ä¼˜åŒ–é…ç½®
Properties connectionProps = new Properties();

// 1. è¿æ¥è¶…æ—¶é…ç½®
connectionProps.put("connections.max.idle.ms", 540000);  // 9åˆ†é’Ÿç©ºé—²è¶…æ—¶
// å«ä¹‰ï¼šè¿æ¥ç©ºé—²å¤šä¹…åå…³é—­ï¼Œé¿å…èµ„æºæµªè´¹

// 2. é‡è¿é…ç½®
connectionProps.put("reconnect.backoff.ms", 50);         // é‡è¿é—´éš”50ms
connectionProps.put("reconnect.backoff.max.ms", 1000);   // æœ€å¤§é‡è¿é—´éš”1ç§’
// å«ä¹‰ï¼šè¿æ¥æ–­å¼€åçš„é‡è¿ç­–ç•¥

// 3. è¯·æ±‚è¶…æ—¶é…ç½®
connectionProps.put("request.timeout.ms", 30000);        // è¯·æ±‚è¶…æ—¶30ç§’
connectionProps.put("delivery.timeout.ms", 120000);      // æ€»è¶…æ—¶2åˆ†é’Ÿ
// å«ä¹‰ï¼šå•ä¸ªè¯·æ±‚å’Œæ•´ä½“å‘é€çš„è¶…æ—¶æ§åˆ¶

// 4. å¹¶å‘è¿æ¥é…ç½®
connectionProps.put("max.in.flight.requests.per.connection", 5);
// å«ä¹‰ï¼šæ¯ä¸ªè¿æ¥å…è®¸çš„æœªç¡®è®¤è¯·æ±‚æ•°
```

### 8.3 è‡ªå®šä¹‰è¿æ¥æ± å®ç°

**ğŸ”§ é«˜çº§è¿æ¥æ± ç®¡ç†ç­–ç•¥**

```java
// è‡ªå®šä¹‰Producerè¿æ¥æ± 
public class KafkaProducerPool {
    private final Queue<KafkaProducer<String, String>> producerPool;
    private final AtomicInteger poolSize;
    private final int maxPoolSize;
    private final Properties baseConfig;
    
    public KafkaProducerPool(Properties config, int maxSize) {
        this.producerPool = new ConcurrentLinkedQueue<>();
        this.poolSize = new AtomicInteger(0);
        this.maxPoolSize = maxSize;
        this.baseConfig = config;
        
        // é¢„åˆ›å»ºæ ¸å¿ƒè¿æ¥
        initializeCoreConnections();
    }
    
    private void initializeCoreConnections() {
        int coreSize = maxPoolSize / 2;  // æ ¸å¿ƒè¿æ¥æ•°ä¸ºæœ€å¤§æ•°çš„ä¸€åŠ
        
        for (int i = 0; i < coreSize; i++) {
            KafkaProducer<String, String> producer = new KafkaProducer<>(baseConfig);
            producerPool.offer(producer);
            poolSize.incrementAndGet();
        }
    }
    
    // è·å–Producerè¿æ¥
    public KafkaProducer<String, String> borrowProducer() {
        KafkaProducer<String, String> producer = producerPool.poll();
        
        if (producer == null && poolSize.get() < maxPoolSize) {
            // æ± ä¸­æ— å¯ç”¨è¿æ¥ï¼Œä¸”æœªè¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œåˆ›å»ºæ–°è¿æ¥
            producer = new KafkaProducer<>(baseConfig);
            poolSize.incrementAndGet();
        }
        
        return producer;  // å¯èƒ½è¿”å›nullï¼Œéœ€è¦è°ƒç”¨æ–¹å¤„ç†
    }
    
    // å½’è¿˜Producerè¿æ¥
    public void returnProducer(KafkaProducer<String, String> producer) {
        if (producer != null && !producer.isClosed()) {
            producerPool.offer(producer);
        } else {
            // è¿æ¥å·²å…³é—­ï¼Œå‡å°‘æ± å¤§å°è®¡æ•°
            poolSize.decrementAndGet();
        }
    }
    
    // å…³é—­è¿æ¥æ± 
    public void shutdown() {
        KafkaProducer<String, String> producer;
        while ((producer = producerPool.poll()) != null) {
            producer.close();
        }
        poolSize.set(0);
    }
}

// ä½¿ç”¨è¿æ¥æ± çš„å‘é€å™¨
public class PooledKafkaSender {
    private final KafkaProducerPool producerPool;
    
    public void send(String topic, String key, String value) {
        KafkaProducer<String, String> producer = producerPool.borrowProducer();
        
        if (producer != null) {
            try {
                producer.send(new ProducerRecord<>(topic, key, value), 
                             (metadata, exception) -> {
                                 // å‘é€å®Œæˆåå½’è¿˜è¿æ¥
                                 producerPool.returnProducer(producer);
                             });
            } catch (Exception e) {
                // å¼‚å¸¸æ—¶ä¹Ÿè¦å½’è¿˜è¿æ¥
                producerPool.returnProducer(producer);
                throw e;
            }
        } else {
            // æ— å¯ç”¨è¿æ¥ï¼Œå®ç°é™çº§ç­–ç•¥
            handleNoAvailableConnection(topic, key, value);
        }
    }
}
```

### 8.4 è¿æ¥å¥åº·ç›‘æ§

**ğŸ“Š è¿æ¥çŠ¶æ€ç›‘æ§ä¸ç»´æŠ¤**

```java
// è¿æ¥å¥åº·æ£€æŸ¥å™¨
public class ConnectionHealthMonitor {
    private final KafkaProducerPool producerPool;
    private final ScheduledExecutorService scheduler;
    
    public ConnectionHealthMonitor(KafkaProducerPool pool) {
        this.producerPool = pool;
        this.scheduler = Executors.newScheduledThreadPool(1);
        
        // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿æ¥å¥åº·çŠ¶æ€
        startHealthCheck();
    }
    
    private void startHealthCheck() {
        scheduler.scheduleWithFixedDelay(() -> {
            checkConnectionHealth();
        }, 0, 60, TimeUnit.SECONDS);
    }
    
    private void checkConnectionHealth() {
        try {
            // 1. æ£€æŸ¥è¿æ¥å¯ç”¨æ€§
            KafkaProducer<String, String> testProducer = producerPool.borrowProducer();
            
            if (testProducer != null) {
                // å‘é€æµ‹è¯•æ¶ˆæ¯æ£€æŸ¥è¿æ¥
                testProducer.send(new ProducerRecord<>("health-check", "test"), 
                                 (metadata, exception) -> {
                                     if (exception != null) {
                                         // è¿æ¥æœ‰é—®é¢˜ï¼Œä»æ± ä¸­ç§»é™¤
                                         handleUnhealthyConnection(testProducer);
                                     } else {
                                         // è¿æ¥æ­£å¸¸ï¼Œå½’è¿˜åˆ°æ± ä¸­
                                         producerPool.returnProducer(testProducer);
                                     }
                                 });
            }
            
            // 2. ç›‘æ§è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯
            logConnectionPoolStats();
            
        } catch (Exception e) {
            System.err.println("è¿æ¥å¥åº·æ£€æŸ¥å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void logConnectionPoolStats() {
        int activeConnections = producerPool.getActiveConnectionCount();
        int totalConnections = producerPool.getTotalConnectionCount();
        
        System.out.printf("è¿æ¥æ± çŠ¶æ€: æ´»è·ƒè¿æ¥=%d, æ€»è¿æ¥=%d%n", 
                         activeConnections, totalConnections);
        
        // å¦‚æœæ´»è·ƒè¿æ¥è¿‡å°‘ï¼Œå¯ä»¥é¢„çƒ­è¿æ¥æ± 
        if (activeConnections < totalConnections * 0.3) {
            producerPool.warmUpConnections();
        }
    }
}
```

### 8.5 è¿æ¥æ•…éšœå¤„ç†ç­–ç•¥

**ğŸ›¡ï¸ è¿æ¥å¼‚å¸¸çš„å¤„ç†æ–¹æ¡ˆ**

```java
// è¿æ¥æ•…éšœå¤„ç†ç­–ç•¥
public class ConnectionFailureHandler {
    private final Map<String, AtomicInteger> failureCount = new ConcurrentHashMap<>();
    private final long FAILURE_THRESHOLD = 5;  // å¤±è´¥é˜ˆå€¼
    private final long RECOVERY_TIME = 300000;  // 5åˆ†é’Ÿæ¢å¤æ—¶é—´
    
    public boolean shouldUseConnection(String brokerId) {
        AtomicInteger failures = failureCount.get(brokerId);
        
        if (failures != null && failures.get() >= FAILURE_THRESHOLD) {
            // è¿æ¥å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œæš‚æ—¶ä¸ä½¿ç”¨
            return false;
        }
        
        return true;
    }
    
    public void recordConnectionFailure(String brokerId) {
        failureCount.computeIfAbsent(brokerId, k -> new AtomicInteger(0))
                   .incrementAndGet();
        
        System.out.println("è®°å½•è¿æ¥å¤±è´¥: " + brokerId);
        
        // å¯åŠ¨æ¢å¤å®šæ—¶å™¨
        scheduleRecovery(brokerId);
    }
    
    private void scheduleRecovery(String brokerId) {
        Timer timer = new Timer();
        timer.schedule(new TimerTask() {
            @Override
            public void run() {
                // é‡ç½®å¤±è´¥è®¡æ•°ï¼Œå°è¯•æ¢å¤è¿æ¥
                failureCount.remove(brokerId);
                System.out.println("å°è¯•æ¢å¤è¿æ¥: " + brokerId);
                
                // æµ‹è¯•è¿æ¥æ˜¯å¦æ¢å¤
                if (testConnection(brokerId)) {
                    System.out.println("è¿æ¥å·²æ¢å¤: " + brokerId);
                } else {
                    // è¿æ¥ä»æœ‰é—®é¢˜ï¼Œç»§ç»­ç›‘æ§
                    recordConnectionFailure(brokerId);
                }
                
                timer.cancel();
            }
        }, RECOVERY_TIME);
    }
    
    private boolean testConnection(String brokerId) {
        // å®ç°è¿æ¥æµ‹è¯•é€»è¾‘
        // ä¾‹å¦‚ï¼šå°è¯•è·å–å…ƒæ•°æ®æˆ–å‘é€æµ‹è¯•æ¶ˆæ¯
        return true;  // ç®€åŒ–å®ç°
    }
}
```

**ğŸ“ˆ è¿æ¥ç®¡ç†æœ€ä½³å®è·µ**
```
è¿æ¥ç®¡ç†è¦ç‚¹ï¼š

1. è¿æ¥æ•°é‡è§„åˆ’
   è¿æ¥æ•° = Brokeræ•°é‡ Ã— 2-3ï¼ˆå†—ä½™ï¼‰
   é¿å…è¿‡å¤šè¿æ¥æ¶ˆè€—èµ„æº

2. è¶…æ—¶åˆç†è®¾ç½®
   è¿æ¥è¶…æ—¶ï¼šä¸å®œè¿‡çŸ­ï¼Œé¿å…é¢‘ç¹é‡è¿
   è¯·æ±‚è¶…æ—¶ï¼šæ ¹æ®ç½‘ç»œæƒ…å†µåˆç†è®¾ç½®

3. å¥åº·æ£€æŸ¥æœºåˆ¶
   å®šæœŸæ£€æŸ¥è¿æ¥å¯ç”¨æ€§
   åŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸è¿æ¥

4. æ•…éšœæ¢å¤ç­–ç•¥
   å®ç°ç†”æ–­æœºåˆ¶ï¼Œé¿å…é›ªå´©
   è‡ªåŠ¨æ¢å¤ï¼Œå‡å°‘äººå·¥å¹²é¢„

5. ç›‘æ§å‘Šè­¦
   ç›‘æ§è¿æ¥æ± ä½¿ç”¨ç‡
   å¼‚å¸¸è¿æ¥åŠæ—¶å‘Šè­¦
```

---

## 9. ğŸ“Š ç›‘æ§æŒ‡æ ‡ä½“ç³»


### 9.1 Producerç›‘æ§æŒ‡æ ‡åˆ†ç±»

ğŸ¯ **ç›‘æ§å°±åƒæ±½è½¦ä»ªè¡¨ç›˜**ï¼šå®æ—¶æ˜¾ç¤ºå„ç§è¿è¡ŒçŠ¶æ€

```
Producerç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼š

æ€§èƒ½æŒ‡æ ‡ç±»ï¼š
â”œâ”€â”€ ååé‡æŒ‡æ ‡ï¼šTPSã€æ¶ˆæ¯é‡ã€æ•°æ®é‡
â”œâ”€â”€ å»¶è¿ŸæŒ‡æ ‡ï¼šå¹³å‡å»¶è¿Ÿã€P99å»¶è¿Ÿã€ç«¯åˆ°ç«¯å»¶è¿Ÿ
â””â”€â”€ é”™è¯¯æŒ‡æ ‡ï¼šå¤±è´¥ç‡ã€é‡è¯•ç‡ã€è¶…æ—¶ç‡

èµ„æºæŒ‡æ ‡ç±»ï¼š
â”œâ”€â”€ å†…å­˜æŒ‡æ ‡ï¼šç¼“å†²åŒºä½¿ç”¨ã€GCæƒ…å†µ
â”œâ”€â”€ ç½‘ç»œæŒ‡æ ‡ï¼šè¿æ¥æ•°ã€å¸¦å®½ä½¿ç”¨
â””â”€â”€ CPUæŒ‡æ ‡ï¼šçº¿ç¨‹ä½¿ç”¨ã€å¤„ç†æ—¶é—´

ä¸šåŠ¡æŒ‡æ ‡ç±»ï¼š
â”œâ”€â”€ æ¶ˆæ¯æŒ‡æ ‡ï¼šæ¶ˆæ¯å¤§å°ã€åˆ†åŒºåˆ†å¸ƒ
â”œâ”€â”€ ä¸»é¢˜æŒ‡æ ‡ï¼šä¸»é¢˜TPSã€åˆ†åŒºè´Ÿè½½
â””â”€â”€ é›†ç¾¤æŒ‡æ ‡ï¼šBrokerçŠ¶æ€ã€å‰¯æœ¬åŒæ­¥
```

### 9.2 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡è¯¦è§£

**ğŸ“ˆ å…³é”®æ€§èƒ½æŒ‡æ ‡çš„å«ä¹‰å’Œç›®æ ‡**

```java
// æ€§èƒ½æŒ‡æ ‡æ”¶é›†å™¨
public class ProducerMetricsCollector {
    private final KafkaProducer<String, String> producer;
    private final AtomicLong successCount = new AtomicLong(0);
    private final AtomicLong failureCount = new AtomicLong(0);
    private final List<Long> latencyRecord = Collections.synchronizedList(new ArrayList<>());
    
    // 1. ååé‡æŒ‡æ ‡è®¡ç®—
    public double calculateTPS() {
        long totalMessages = successCount.get() + failureCount.get();
        long timeWindow = 60; // 60ç§’çª—å£
        
        return (double) totalMessages / timeWindow;
    }
    
    // 2. å»¶è¿ŸæŒ‡æ ‡è®¡ç®—
    public Map<String, Double> calculateLatencyMetrics() {
        if (latencyRecord.isEmpty()) return Collections.emptyMap();
        
        List<Long> sortedLatencies = new ArrayList<>(latencyRecord);
        sortedLatencies.sort(Long::compareTo);
        
        int size = sortedLatencies.size();
        Map<String, Double> metrics = new HashMap<>();
        
        // å¹³å‡å»¶è¿Ÿ
        double avgLatency = sortedLatencies.stream()
                                         .mapToLong(Long::longValue)
                                         .average()
                                         .orElse(0.0);
        
        // P50å»¶è¿Ÿï¼ˆä¸­ä½æ•°ï¼‰
        double p50Latency = sortedLatencies.get(size / 2);
        
        // P99å»¶è¿Ÿ
        double p99Latency = sortedLatencies.get((int) (size * 0.99));
        
        // P999å»¶è¿Ÿ
        double p999Latency = sortedLatencies.get((int) (size * 0.999));
        
        metrics.put("avg", avgLatency);
        metrics.put("p50", p50Latency);
        metrics.put("p99", p99Latency);
        metrics.put("p999", p999Latency);
        
        return metrics;
    }
    
    // 3. æˆåŠŸç‡æŒ‡æ ‡è®¡ç®—
    public double calculateSuccessRate() {
        long total = successCount.get() + failureCount.get();
        if (total == 0) return 100.0;
        
        return (double) successCount.get() / total * 100;
    }
}
```

### 9.3 Kafkaå†…ç½®æŒ‡æ ‡è·å–

**âš™ï¸ ä½¿ç”¨Kafkaè‡ªå¸¦çš„JMXæŒ‡æ ‡**

```java
// Kafkaå†…ç½®æŒ‡æ ‡è·å–
public class KafkaBuiltinMetrics {
    private final KafkaProducer<String, String> producer;
    
    public void printAllMetrics() {
        Map<MetricName, ? extends Metric> metrics = producer.metrics();
        
        // æŒ‰ç±»åˆ«ç»„ç»‡æŒ‡æ ‡
        Map<String, List<String>> categorizedMetrics = new HashMap<>();
        
        for (Map.Entry<MetricName, ? extends Metric> entry : metrics.entrySet()) {
            String group = entry.getKey().group();
            String name = entry.getKey().name();
            Object value = entry.getValue().metricValue();
            
            categorizedMetrics.computeIfAbsent(group, k -> new ArrayList<>())
                             .add(name + " = " + value);
        }
        
        // é‡ç‚¹å…³æ³¨çš„æŒ‡æ ‡ç»„
        printMetricGroup(categorizedMetrics, "producer-metrics", "æ•´ä½“æ€§èƒ½æŒ‡æ ‡");
        printMetricGroup(categorizedMetrics, "producer-topic-metrics", "ä¸»é¢˜çº§åˆ«æŒ‡æ ‡"); 
        printMetricGroup(categorizedMetrics, "kafka-metrics-count", "è®¡æ•°æŒ‡æ ‡");
    }
    
    private void printMetricGroup(Map<String, List<String>> metrics, 
                                 String group, String description) {
        System.out.println("\n=== " + description + " ===");
        List<String> groupMetrics = metrics.get(group);
        
        if (groupMetrics != null) {
            groupMetrics.forEach(System.out::println);
        }
    }
    
    // è·å–ç‰¹å®šå…³é”®æŒ‡æ ‡
    public Map<String, Object> getKeyMetrics() {
        Map<MetricName, ? extends Metric> allMetrics = producer.metrics();
        Map<String, Object> keyMetrics = new HashMap<>();
        
        for (Map.Entry<MetricName, ? extends Metric> entry : allMetrics.entrySet()) {
            String metricName = entry.getKey().name();
            
            // é€‰æ‹©å…³é”®æŒ‡æ ‡
            switch (metricName) {
                case "record-send-rate":
                    keyMetrics.put("å‘é€é€Ÿç‡(records/s)", entry.getValue().metricValue());
                    break;
                case "record-send-total":
                    keyMetrics.put("æ€»å‘é€æ•°", entry.getValue().metricValue());
                    break;
                case "record-error-rate":
                    keyMetrics.put("é”™è¯¯ç‡", entry.getValue().metricValue());
                    break;
                case "record-retry-rate":
                    keyMetrics.put("é‡è¯•ç‡", entry.getValue().metricValue());
                    break;
                case "request-latency-avg":
                    keyMetrics.put("å¹³å‡å»¶è¿Ÿ(ms)", entry.getValue().metricValue());
                    break;
                case "buffer-available-bytes":
                    keyMetrics.put("å¯ç”¨ç¼“å†²åŒº(bytes)", entry.getValue().metricValue());
                    break;
            }
        }
        
        return keyMetrics;
    }
}
```

### 9.4 ç›‘æ§å‘Šè­¦ç­–ç•¥

**ğŸš¨ å»ºç«‹æœ‰æ•ˆçš„ç›‘æ§å‘Šè­¦æœºåˆ¶**

```java
// ç›‘æ§å‘Šè­¦ç®¡ç†å™¨
public class ProducerAlertManager {
    private final Map<String, AlertRule> alertRules = new HashMap<>();
    private final AlertNotifier notifier;
    
    public ProducerAlertManager(AlertNotifier notifier) {
        this.notifier = notifier;
        initializeDefaultAlerts();
    }
    
    private void initializeDefaultAlerts() {
        // 1. æˆåŠŸç‡å‘Šè­¦
        alertRules.put("success_rate", new AlertRule(
            "å‘é€æˆåŠŸç‡",
            90.0,  // é˜ˆå€¼ï¼š90%
            AlertLevel.CRITICAL,
            "å‘é€æˆåŠŸç‡ä½äº90%ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’ŒBrokerçŠ¶æ€"
        ));
        
        // 2. å»¶è¿Ÿå‘Šè­¦
        alertRules.put("p99_latency", new AlertRule(
            "P99å»¶è¿Ÿ",
            1000.0,  // é˜ˆå€¼ï¼š1000ms
            AlertLevel.WARNING,
            "P99å»¶è¿Ÿè¶…è¿‡1ç§’ï¼Œå¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ"
        ));
        
        // 3. ååé‡å‘Šè­¦
        alertRules.put("tps_drop", new AlertRule(
            "TPSä¸‹é™",
            50.0,  // é˜ˆå€¼ï¼šç›¸æ¯”å†å²ä¸‹é™50%
            AlertLevel.WARNING,
            "TPSæ˜¾è‘—ä¸‹é™ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜"
        ));
        
        // 4. å†…å­˜ä½¿ç”¨å‘Šè­¦
        alertRules.put("buffer_usage", new AlertRule(
            "ç¼“å†²åŒºä½¿ç”¨ç‡",
            85.0,  // é˜ˆå€¼ï¼š85%
            AlertLevel.WARNING,
            "Producerç¼“å†²åŒºä½¿ç”¨ç‡è¿‡é«˜ï¼Œå¯èƒ½å¯¼è‡´é˜»å¡"
        ));
    }
    
    // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
    public void checkAlerts(Map<String, Object> currentMetrics) {
        for (Map.Entry<String, AlertRule> entry : alertRules.entrySet()) {
            String metricKey = entry.getKey();
            AlertRule rule = entry.getValue();
            
            Object metricValue = currentMetrics.get(metricKey);
            if (metricValue != null && shouldAlert(rule, metricValue)) {
                notifier.sendAlert(rule);
            }
        }
    }
    
    private boolean shouldAlert(AlertRule rule, Object value) {
        if (value instanceof Number) {
            double numValue = ((Number) value).doubleValue();
            return numValue < rule.getThreshold(); // æˆ– > æ ¹æ®æŒ‡æ ‡ç±»å‹
        }
        return false;
    }
}

// å‘Šè­¦è§„åˆ™å®šä¹‰
class AlertRule {
    private final String name;
    private final double threshold;
    private final AlertLevel level;
    private final String message;
    
    public AlertRule(String name, double threshold, AlertLevel level, String message) {
        this.name = name;
        this.threshold = threshold;
        this.level = level;
        this.message = message;
    }
    
    // getteræ–¹æ³•çœç•¥...
}

### 9.5 å¯è§†åŒ–ç›‘æ§å®ç°

**ğŸ“Š æ„å»ºProduceræ€§èƒ½ç›‘æ§é¢æ¿**

```java
// ç›‘æ§æ•°æ®å¯¼å‡ºå™¨ï¼ˆå¯¹æ¥ç›‘æ§ç³»ç»Ÿï¼‰
public class MetricsExporter {
    private final KafkaProducer<String, String> producer;
    private final ScheduledExecutorService scheduler;
    
    public void startExporting() {
        // æ¯30ç§’å¯¼å‡ºä¸€æ¬¡æŒ‡æ ‡
        scheduler.scheduleWithFixedDelay(() -> {
            Map<String, Object> metrics = collectAllMetrics();
            exportToMonitoringSystem(metrics);
        }, 0, 30, TimeUnit.SECONDS);
    }
    
    private Map<String, Object> collectAllMetrics() {
        Map<String, Object> allMetrics = new HashMap<>();
        
        // 1. KafkaåŸç”ŸæŒ‡æ ‡
        Map<MetricName, ? extends Metric> kafkaMetrics = producer.metrics();
        for (Map.Entry<MetricName, ? extends Metric> entry : kafkaMetrics.entrySet()) {
            String key = entry.getKey().group() + "." + entry.getKey().name();
            allMetrics.put(key, entry.getValue().metricValue());
        }
        
        // 2. è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
        allMetrics.put("custom.success_rate", calculateSuccessRate());
        allMetrics.put("custom.error_count", getErrorCount());
        allMetrics.put("custom.retry_count", getRetryCount());
        
        // 3. JVMæŒ‡æ ‡
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        allMetrics.put("jvm.heap_used", memoryBean.getHeapMemoryUsage().getUsed());
        allMetrics.put("jvm.heap_max", memoryBean.getHeapMemoryUsage().getMax());
        
        return allMetrics;
    }
    
    private void exportToMonitoringSystem(Map<String, Object> metrics) {
        // å¯¼å‡ºåˆ°Prometheus
        exportToPrometheus(metrics);
        
        // å¯¼å‡ºåˆ°Grafana
        exportToGrafana(metrics);
        
        // å¯¼å‡ºåˆ°è‡ªå®šä¹‰ç›‘æ§ç³»ç»Ÿ
        exportToCustomSystem(metrics);
    }
}
```

**ğŸ¨ ç›‘æ§é¢æ¿è®¾è®¡è¦ç‚¹**
```
å…³é”®ç›‘æ§å›¾è¡¨è®¾è®¡ï¼š

1. å®æ—¶æ€§èƒ½ä»ªè¡¨ç›˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   TPS: 1,250    â”‚ â”‚  å»¶è¿Ÿ: 45ms     â”‚
   â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘    â”‚ â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æˆåŠŸç‡: 99.8%   â”‚ â”‚ é”™è¯¯ç‡: 0.2%    â”‚
   â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚ â”‚  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. è¶‹åŠ¿åˆ†æå›¾è¡¨
   - TPSæ—¶é—´åºåˆ—å›¾ï¼ˆè¿‡å»24å°æ—¶ï¼‰
   - å»¶è¿Ÿåˆ†å¸ƒç›´æ–¹å›¾ï¼ˆP50, P99, P999ï¼‰
   - é”™è¯¯ç‡è¶‹åŠ¿å›¾
   - å†…å­˜ä½¿ç”¨ç‡å˜åŒ–å›¾

3. åˆ†åŒºçº§åˆ«ç›‘æ§
   - å„åˆ†åŒºæ¶ˆæ¯åˆ†å¸ƒçƒ­åŠ›å›¾
   - åˆ†åŒºè´Ÿè½½å‡è¡¡åº¦é‡
   - çƒ­ç‚¹åˆ†åŒºè¯†åˆ«

4. å‘Šè­¦çŠ¶æ€é¢æ¿
   - å½“å‰æ´»è·ƒå‘Šè­¦åˆ—è¡¨
   - å‘Šè­¦å†å²è¶‹åŠ¿
   - å‘Šè­¦å“åº”æ—¶é—´ç»Ÿè®¡
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ€§èƒ½è°ƒä¼˜ç›®æ ‡ï¼šååé‡ä¸å»¶è¿Ÿçš„å¹³è¡¡ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç­–ç•¥
ğŸ”¸ æ‰¹å¤„ç†ä¼˜åŒ–ï¼šé€šè¿‡batch.sizeå’Œlinger.msæ§åˆ¶æ¶ˆæ¯èšåˆæ•ˆç‡
ğŸ”¸ å‹ç¼©ç®—æ³•é€‰æ‹©ï¼šæ ¹æ®CPUã€å¸¦å®½ã€å»¶è¿Ÿè¦æ±‚é€‰æ‹©åˆé€‚å‹ç¼©æ–¹å¼
ğŸ”¸ å¼‚æ­¥å‘é€ï¼šä½¿ç”¨å›è°ƒæœºåˆ¶æå‡å‘é€æ•ˆç‡ï¼Œé¿å…é˜»å¡
ğŸ”¸ å†…å­˜ç®¡ç†ï¼šåˆç†é…ç½®buffer.memoryï¼Œé¿å…å†…å­˜è€—å°½é˜»å¡
ğŸ”¸ è¿æ¥ä¼˜åŒ–ï¼šå¤ç”¨é•¿è¿æ¥ï¼Œåˆç†è®¾ç½®è¶…æ—¶å’Œé‡è¿å‚æ•°
ğŸ”¸ ç›‘æ§ä½“ç³»ï¼šå»ºç«‹å®Œæ•´çš„æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ååé‡ vs å»¶è¿Ÿçš„æƒè¡¡ç­–ç•¥**
```
é«˜ååé‡é…ç½®ï¼š
- å¤§æ‰¹æ¬¡sizeï¼ˆ64KB-512KBï¼‰
- è¾ƒé•¿ç­‰å¾…æ—¶é—´ï¼ˆ50-100msï¼‰
- å¯ç”¨å‹ç¼©ï¼ˆlz4/gzipï¼‰
- é«˜å¹¶å‘è¿æ¥æ•°ï¼ˆ5-10ï¼‰

ä½å»¶è¿Ÿé…ç½®ï¼š
- å°æ‰¹æ¬¡sizeï¼ˆ8KB-16KBï¼‰
- é›¶ç­‰å¾…æ—¶é—´ï¼ˆ0msï¼‰
- ä¸å‹ç¼©æˆ–fastå‹ç¼©ï¼ˆlz4ï¼‰
- è¾ƒä½å¹¶å‘æ•°ï¼ˆ1-3ï¼‰

å¹³è¡¡é…ç½®ï¼ˆæ¨èï¼‰ï¼š
- ä¸­ç­‰æ‰¹æ¬¡sizeï¼ˆ32KBï¼‰
- çŸ­ç­‰å¾…æ—¶é—´ï¼ˆ10msï¼‰
- è½»é‡å‹ç¼©ï¼ˆlz4ï¼‰
- é€‚ä¸­å¹¶å‘æ•°ï¼ˆ3-5ï¼‰
```

**ğŸ”¹ é…ç½®å‚æ•°çš„ç›¸äº’å½±å“å…³ç³»**
```
æ ¸å¿ƒå‚æ•°å…³è”ï¼š
batch.size â†â†’ linger.ms
â†•                â†•
buffer.memory â†â†’ åˆ†åŒºæ•°é‡
â†•                â†•
compression â†â†’ ç½‘ç»œå¸¦å®½

ä¼˜åŒ–æ€è·¯ï¼š
1. å…ˆç¡®å®šä¸šåŠ¡ç›®æ ‡ï¼ˆååé‡ vs å»¶è¿Ÿï¼‰
2. å†é€‰æ‹©æ ¸å¿ƒç­–ç•¥ï¼ˆæ‰¹å¤„ç† + å‹ç¼©ï¼‰
3. æœ€åå¾®è°ƒå‚æ•°ï¼ˆå†…å­˜ + è¿æ¥ï¼‰
4. æŒç»­ç›‘æ§è°ƒä¼˜ï¼ˆæŒ‡æ ‡ + å‘Šè­¦ï¼‰
```

**ğŸ”¹ ä¸åŒåœºæ™¯çš„æœ€ä½³å®è·µ**
```
å®æ—¶äº¤æ˜“åœºæ™¯ï¼š
âœ… æä½å»¶è¿Ÿä¼˜å…ˆ
âœ… å°æ‰¹æ¬¡ + é›¶ç­‰å¾…
âœ… ä¸å‹ç¼©æˆ–è½»å‹ç¼©
âœ… ä¸“ç”¨è¿æ¥

æ—¥å¿—æ”¶é›†åœºæ™¯ï¼š
âœ… é«˜ååé‡ä¼˜å…ˆ  
âœ… å¤§æ‰¹æ¬¡ + é•¿ç­‰å¾…
âœ… é«˜å‹ç¼©æ¯”ç®—æ³•
âœ… è¿æ¥å¤ç”¨

æ•°æ®åŒæ­¥åœºæ™¯ï¼š
âœ… å¹³è¡¡æ€§èƒ½
âœ… ä¸­ç­‰æ‰¹æ¬¡é…ç½®
âœ… ä¸­ç­‰å‹ç¼©
âœ… å¯é æ€§ä¿è¯
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨æŒ‡å—**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•æ¶ˆæ¯ç”¨ä½å»¶è¿Ÿé…ç½®ï¼Œæ—¥å¿—ç”¨é«˜ååé…ç½®
- **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“æ¶ˆæ¯ä¸¥æ ¼ä½å»¶è¿Ÿï¼Œæ¸…ç®—æ•°æ®å¯ç”¨é«˜åå
- **IoTå¹³å°**ï¼šä¼ æ„Ÿå™¨æ•°æ®ç”¨æ‰¹é‡é«˜å‹ç¼©ï¼Œå‘Šè­¦æ¶ˆæ¯ç”¨ä½å»¶è¿Ÿ
- **è§†é¢‘å¹³å°**ï¼šç”¨æˆ·è¡Œä¸ºæ—¥å¿—ç”¨é«˜ååï¼Œå®æ—¶å¼¹å¹•ç”¨ä½å»¶è¿Ÿ

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **æ¸è¿›å¼è°ƒä¼˜**ï¼šä»é»˜è®¤é…ç½®å¼€å§‹ï¼Œé€æ­¥è°ƒæ•´å…³é”®å‚æ•°
- **å‹æµ‹éªŒè¯**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†å‹æµ‹ï¼ŒéªŒè¯é…ç½®æ•ˆæœ
- **ç›‘æ§å…ˆè¡Œ**ï¼šå»ºç«‹å®Œæ•´ç›‘æ§åå†è¿›è¡Œè°ƒä¼˜
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•æ¯æ¬¡è°ƒä¼˜çš„å‚æ•°å˜æ›´å’Œæ•ˆæœ

**ğŸ“ˆ æ€§èƒ½è°ƒä¼˜æˆæœè¯„ä¼°**
- **ååé‡æå‡**ï¼šåˆç†é…ç½®å¯æå‡50%-200%çš„ååé‡
- **å»¶è¿Ÿé™ä½**ï¼šä¼˜åŒ–é…ç½®å¯é™ä½20%-50%çš„å¹³å‡å»¶è¿Ÿ
- **èµ„æºèŠ‚çœ**ï¼šå‹ç¼©å’Œæ‰¹å¤„ç†å¯èŠ‚çœ30%-70%çš„ç½‘ç»œå¸¦å®½
- **ç¨³å®šæ€§æå‡**ï¼šåˆç†çš„å†…å­˜å’Œè¿æ¥é…ç½®æ˜¾è‘—æå‡ç¨³å®šæ€§

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ‰¹å¤„ç†èšåˆæååï¼Œå‹ç¼©ç®—æ³•çœå¸¦å®½
- å¼‚æ­¥å›è°ƒé¿é˜»å¡ï¼Œå†…å­˜é…ç½®é˜²æº¢å‡º
- è¿æ¥å¤ç”¨é™å¼€é”€ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š
- å‚æ•°è°ƒä¼˜éœ€å¹³è¡¡ï¼Œä¸šåŠ¡åœºæ™¯å®šç­–ç•¥

**ğŸ“ å­¦ä¹ å»ºè®®**
- **åŠ¨æ‰‹å®è·µ**ï¼šåœ¨æœ¬åœ°ç¯å¢ƒæ­å»ºKafkaé›†ç¾¤ï¼Œäº²è‡ªæµ‹è¯•å„ç§é…ç½®
- **ç›‘æ§ç†è§£**ï¼šé‡ç‚¹ç†è§£å„é¡¹æŒ‡æ ‡çš„å«ä¹‰å’Œæ­£å¸¸èŒƒå›´
- **åœºæ™¯åˆ†æ**ï¼šç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯æ€è€ƒæœ€ä¼˜é…ç½®ç­–ç•¥
- **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨Kafkaç¤¾åŒºçš„æœ€æ–°ä¼˜åŒ–å®è·µå’Œå·¥å…·