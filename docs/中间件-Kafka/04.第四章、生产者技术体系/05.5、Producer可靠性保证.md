---
title: 5ã€Producerå¯é æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [ç”Ÿäº§è€…å¯é æ€§æ ¸å¿ƒæ¦‚å¿µ](#1-ç”Ÿäº§è€…å¯é æ€§æ ¸å¿ƒæ¦‚å¿µ)
2. [æ¶ˆæ¯ç¡®è®¤æœºåˆ¶è¯¦è§£](#2-æ¶ˆæ¯ç¡®è®¤æœºåˆ¶è¯¦è§£)
3. [é‡è¯•æœºåˆ¶ä¸å¹‚ç­‰æ€§](#3-é‡è¯•æœºåˆ¶ä¸å¹‚ç­‰æ€§)
4. [äº‹åŠ¡Produceræ·±åº¦è§£æ](#4-äº‹åŠ¡produceræ·±åº¦è§£æ)
5. [æ¶ˆæ¯é¡ºåºä¿è¯ç­–ç•¥](#5-æ¶ˆæ¯é¡ºåºä¿è¯ç­–ç•¥)
6. [é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ç­–ç•¥](#6-é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ç­–ç•¥)
7. [Exactly-onceè¯­ä¹‰å®ç°](#7-exactly-onceè¯­ä¹‰å®ç°)
8. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#8-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç”Ÿäº§è€…å¯é æ€§æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Producerå¯é æ€§


**é€šä¿—ç†è§£**ï¼šå°±åƒå¯„å¿«é€’ä¸€æ ·ï¼Œä½ å¸Œæœ›ç¡®ä¿åŒ…è£¹èƒ½å®‰å…¨é€åˆ°ç›®çš„åœ°

```
æ—¥å¸¸å¯„å¿«é€’çš„æ‹…å¿ƒï¼š
ğŸ“¦ åŒ…è£¹ä¼šä¸ä¼šä¸¢å¤±ï¼Ÿ    â†’ Kafkaæ¶ˆæ¯ä¼šä¸ä¼šä¸¢å¤±ï¼Ÿ
ğŸ”„ åŒ…è£¹é‡å¤æŠ•é€’ï¼Ÿ      â†’ æ¶ˆæ¯ä¼šä¸ä¼šé‡å¤ï¼Ÿ
ğŸ“‹ æŠ•é€’é¡ºåºæ­£ç¡®å—ï¼Ÿ    â†’ æ¶ˆæ¯é¡ºåºæ˜¯å¦ä¿è¯ï¼Ÿ
âœ… ç­¾æ”¶ç¡®è®¤æ”¶åˆ°äº†ï¼Ÿ    â†’ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
```

**Producerå¯é æ€§**ï¼šç¡®ä¿ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯èƒ½å¤Ÿ**å®‰å…¨ã€å‡†ç¡®ã€æœ‰åº**åœ°ä¼ é€’åˆ°Kafkaé›†ç¾¤

### 1.2 å¯é æ€§çš„ä¸‰ä¸ªæ ¸å¿ƒç»´åº¦


| å¯é æ€§ç»´åº¦ | **å«ä¹‰** | **æ—¥å¸¸ç±»æ¯”** | **Kafkaå®ç°** |
|-----------|---------|------------|-------------|
| ğŸ”’ **ä¸ä¸¢å¤±** | `æ¶ˆæ¯å¿…é¡»æˆåŠŸæŠ•é€’` | `å¿«é€’å¿…é¡»é€è¾¾` | `acksç¡®è®¤æœºåˆ¶` |
| ğŸš« **ä¸é‡å¤** | `åŒä¸€æ¶ˆæ¯ä¸èƒ½é‡å¤` | `åŒä¸ªåŒ…è£¹ä¸èƒ½é‡å¤æ”¶` | `å¹‚ç­‰æ€§Producer` |
| ğŸ“‹ **ä¿é¡ºåº** | `æ¶ˆæ¯æŒ‰å‘é€é¡ºåºåˆ°è¾¾` | `æŒ‰å¯„ä»¶é¡ºåºæŠ•é€’` | `å•åˆ†åŒºé¡ºåºä¿è¯` |

### 1.3 å¯é æ€§é¢ä¸´çš„æŒ‘æˆ˜


**ç½‘ç»œç¯å¢ƒçš„ä¸ç¡®å®šæ€§**ï¼š
```
ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„è·¯å¾„ï¼š
Producer â†’ ç½‘ç»œ â†’ Kafka Broker â†’ ç£ç›˜å­˜å‚¨

å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š
â€¢ ç½‘ç»œå»¶è¿Ÿã€ä¸¢åŒ…ã€é‡ä¼ 
â€¢ BrokerèŠ‚ç‚¹å®•æœº
â€¢ ç£ç›˜å†™å…¥å¤±è´¥
â€¢ æ¶ˆæ¯åºåˆ—åŒ–å¼‚å¸¸
```

---

## 2. ğŸ“¨ æ¶ˆæ¯ç¡®è®¤æœºåˆ¶è¯¦è§£


### 2.1 ackså‚æ•°æ ¸å¿ƒåŸç†


**acks**ï¼šå‘Šè¯‰Kafkaä»€ä¹ˆæ—¶å€™è®¤ä¸ºæ¶ˆæ¯"å‘é€æˆåŠŸ"

> ğŸ’¡ **é€šä¿—ç†è§£**  
> å°±åƒå¯„å¿«é€’æ—¶é€‰æ‹©ä¸åŒçš„ç­¾æ”¶æ–¹å¼ï¼š
> - `acks=0`ï¼šå¿«é€’å‘˜è¯´"æˆ‘æŠ•é€’äº†"å°±ç®—æˆåŠŸ
> - `acks=1`ï¼šæ”¶ä»¶äººç­¾æ”¶åæ‰ç®—æˆåŠŸ  
> - `acks=all`ï¼šæ”¶ä»¶äººå’Œé‚»å±…éƒ½ç¡®è®¤æ”¶åˆ°æ‰ç®—æˆåŠŸ

### 2.2 ä¸‰ç§acksé…ç½®è¯¦è§£


#### ğŸš€ acks=0 (å‘åä¸ç®¡æ¨¡å¼)


**å·¥ä½œåŸç†**ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åç«‹å³è®¤ä¸ºå‘é€æˆåŠŸï¼Œä¸ç­‰ä»»ä½•ç¡®è®¤

```java
// é…ç½®ç¤ºä¾‹
Properties props = new Properties();
props.put("bootstrap.servers", "localhost:9092");
props.put("acks", "0");  // å‘åä¸ç®¡
props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");

KafkaProducer<String, String> producer = new KafkaProducer<>(props);

// å‘é€æ¶ˆæ¯ï¼Œä¸å…³å¿ƒæ˜¯å¦æˆåŠŸ
producer.send(new ProducerRecord<>("my-topic", "hello world"));
```

**é€‚ç”¨åœºæ™¯ä¸ç‰¹ç‚¹**ï¼š
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ æ€§èƒ½æœ€é«˜ï¼Œå»¶è¿Ÿæœ€ä½
â€¢ ååé‡æœ€å¤§
â€¢ ä¸ä¼šå› ä¸ºç½‘ç»œé—®é¢˜é˜»å¡

âŒ ç¼ºç‚¹ï¼š
â€¢ å¯èƒ½ä¸¢å¤±æ¶ˆæ¯
â€¢ æ— æ³•çŸ¥é“å‘é€ç»“æœ
â€¢ ä¸é€‚åˆé‡è¦æ•°æ®

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ—¥å¿—æ”¶é›†ï¼ˆå…è®¸å°‘é‡ä¸¢å¤±ï¼‰
â€¢ ç›‘æ§æ•°æ®ä¸ŠæŠ¥
â€¢ éå…³é”®ä¸šåŠ¡æ•°æ®
```

#### ğŸ“‹ acks=1 (Leaderç¡®è®¤æ¨¡å¼)


**å·¥ä½œåŸç†**ï¼šLeaderå‰¯æœ¬å†™å…¥æˆåŠŸåç«‹å³è¿”å›ç¡®è®¤ï¼Œä¸ç­‰Followerå‰¯æœ¬åŒæ­¥

```java
Properties props = new Properties();
props.put("acks", "1");  // Leaderç¡®è®¤å³å¯
props.put("retries", 3);  // é…åˆé‡è¯•ä½¿ç”¨

// å¼‚æ­¥å‘é€å¸¦å›è°ƒ
producer.send(new ProducerRecord<>("my-topic", "key1", "é‡è¦æ¶ˆæ¯"), 
    new Callback() {
        public void onCompletion(RecordMetadata metadata, Exception exception) {
            if (exception == null) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸï¼š" + metadata.offset());
            } else {
                System.out.println("å‘é€å¤±è´¥ï¼š" + exception.getMessage());
            }
        }
    });
```

**å·¥ä½œæµç¨‹å›¾**ï¼š
```
Producer                 Kafka Cluster
   |                    Leader    Follower1  Follower2
   |--å‘é€æ¶ˆæ¯----------->|         |         |
   |                    |å†™å…¥æˆåŠŸ   |         |
   |<---ç«‹å³è¿”å›ACK------|         |         |
   |                    |         |å¼‚æ­¥åŒæ­¥  |å¼‚æ­¥åŒæ­¥
   âœ…å‘é€å®Œæˆ            |         |         |
```

**å¹³è¡¡ç‚¹åˆ†æ**ï¼š
```
âš–ï¸ å¹³è¡¡è€ƒè™‘ï¼š
â€¢ æ€§èƒ½ï¼šæ¯”acks=allå¿«ï¼Œæ¯”acks=0æ…¢
â€¢ å¯é æ€§ï¼šä¸­ç­‰ï¼ŒLeaderæ•…éšœå¯èƒ½ä¸¢æ¶ˆæ¯
â€¢ å¤æ‚åº¦ï¼šé€‚ä¸­ï¼Œéœ€è¦å¤„ç†å›è°ƒ

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ ä¸€èˆ¬ä¸šåŠ¡æ•°æ®
â€¢ å¯¹æ€§èƒ½æœ‰è¦æ±‚ä½†ä¸èƒ½å®¹å¿å¤§é‡ä¸¢å¤±
â€¢ å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒçš„é»˜è®¤é€‰æ‹©
```

#### ğŸ›¡ï¸ acks=all (æœ€å¼ºå¯é æ€§æ¨¡å¼)


**å·¥ä½œåŸç†**ï¼šç­‰å¾…ISR(åŒæ­¥å‰¯æœ¬é›†)ä¸­æ‰€æœ‰å‰¯æœ¬éƒ½ç¡®è®¤å†™å…¥æˆåŠŸ

```java
Properties props = new Properties();
props.put("acks", "all");  // ç­‰å¾…æ‰€æœ‰ISRå‰¯æœ¬ç¡®è®¤
props.put("min.insync.replicas", "2");  // è‡³å°‘2ä¸ªå‰¯æœ¬ç¡®è®¤
props.put("retries", Integer.MAX_VALUE);  // æ— é™é‡è¯•
props.put("max.in.flight.requests.per.connection", "1");  // ä¿è¯é¡ºåº

KafkaProducer<String, String> producer = new KafkaProducer<>(props);

// åŒæ­¥å‘é€ï¼Œç¡®ä¿å¯é æ€§
try {
    RecordMetadata metadata = producer.send(
        new ProducerRecord<>("critical-topic", "å…³é”®æ•°æ®")
    ).get();  // é˜»å¡ç­‰å¾…ç»“æœ
    System.out.println("å…³é”®æ¶ˆæ¯å·²å®‰å…¨å­˜å‚¨ï¼š" + metadata);
} catch (Exception e) {
    System.err.println("å‘é€å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†ï¼š" + e);
}
```

**ISRæœºåˆ¶è§£é‡Š**ï¼š
```
ISR (In-Sync Replicas) åŒæ­¥å‰¯æœ¬é›†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic: critical-data               â”‚
â”‚  Partition: 0                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Leader (Broker1)    [ISRæˆå‘˜]   â”‚ â”‚
â”‚  â”‚ Follower1 (Broker2) [ISRæˆå‘˜]   â”‚ â”‚  
â”‚  â”‚ Follower2 (Broker3) [ISRæˆå‘˜]   â”‚ â”‚
â”‚  â”‚ Follower3 (Broker4) [è½åå¤ªå¤š]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

acks=all åªç­‰å¾…ISRä¸­çš„å‰¯æœ¬ç¡®è®¤
min.insync.replicas=2 è¡¨ç¤ºISRè‡³å°‘è¦æœ‰2ä¸ªå‰¯æœ¬
```

### 2.3 acksé…ç½®çš„æœ€ä½³é€‰æ‹©


**é€‰æ‹©æŒ‡å¯¼åŸåˆ™**ï¼š

```java
// ğŸ”§ é…ç½®æ¨¡æ¿ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©

// åœºæ™¯1ï¼šé«˜æ€§èƒ½æ—¥å¿—æ”¶é›†
Properties highPerformance = new Properties();
highPerformance.put("acks", "0");
highPerformance.put("compression.type", "lz4");  // å‹ç¼©æå‡ç½‘ç»œæ•ˆç‡
highPerformance.put("batch.size", "65536");      // å¤§æ‰¹æ¬¡æå‡åå

// åœºæ™¯2ï¼šä¸€èˆ¬ä¸šåŠ¡æ•°æ®
Properties balanced = new Properties();
balanced.put("acks", "1");
balanced.put("retries", "3");
balanced.put("retry.backoff.ms", "1000");

// åœºæ™¯3ï¼šé‡‘èäº¤æ˜“æ•°æ®
Properties highReliability = new Properties();
highReliability.put("acks", "all");
highReliability.put("min.insync.replicas", "2");
highReliability.put("retries", Integer.MAX_VALUE);
```

---

## 3. ğŸ”„ é‡è¯•æœºåˆ¶ä¸å¹‚ç­‰æ€§


### 3.1 é‡è¯•æœºåˆ¶åŸºæœ¬åŸç†


**ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•**ï¼šç½‘ç»œä¸–ç•Œå……æ»¡ä¸ç¡®å®šæ€§

```
å¯èƒ½å¯¼è‡´å‘é€å¤±è´¥çš„åŸå› ï¼š
ğŸŒ ç½‘ç»œé—®é¢˜ï¼š
   â€¢ ç½‘ç»œå»¶è¿Ÿè¶…æ—¶
   â€¢ ç½‘ç»œä¸¢åŒ…
   â€¢ DNSè§£æå¤±è´¥

ğŸ–¥ï¸ Brokeré—®é¢˜ï¼š
   â€¢ ä¸´æ—¶è¿‡è½½
   â€¢ Leaderé€‰ä¸¾ä¸­
   â€¢ ç£ç›˜ç©ºé—´ä¸è¶³

ğŸ“¦ æ¶ˆæ¯é—®é¢˜ï¼š
   â€¢ æ¶ˆæ¯è¿‡å¤§
   â€¢ åºåˆ—åŒ–å¤±è´¥
   â€¢ åˆ†åŒºä¸å­˜åœ¨
```

### 3.2 é‡è¯•é…ç½®è¯¦è§£


```java
Properties props = new Properties();

// ğŸ”„ é‡è¯•æ¬¡æ•°é…ç½®
props.put("retries", "3");  // æœ€å¤šé‡è¯•3æ¬¡ï¼Œä¸å»ºè®®è®¾ç½®è¿‡é«˜

// â±ï¸ é‡è¯•é—´éš”é…ç½®  
props.put("retry.backoff.ms", "1000");  // æ¯æ¬¡é‡è¯•é—´éš”1ç§’

// ğŸ“Š è¯·æ±‚è¶…æ—¶é…ç½®
props.put("request.timeout.ms", "30000");  // 30ç§’è¯·æ±‚è¶…æ—¶

// ğŸš¦ æŠ•é€’è¶…æ—¶é…ç½®
props.put("delivery.timeout.ms", "120000");  // 2åˆ†é’ŸæŠ•é€’è¶…æ—¶
```

**é‡è¯•æ—¶é—´è®¡ç®—**ï¼š
```
æ€»é‡è¯•æ—¶é—´è®¡ç®—å…¬å¼ï¼š
delivery.timeout.ms >= request.timeout.ms + (retries * retry.backoff.ms)

ç¤ºä¾‹è®¡ç®—ï¼š
request.timeout.ms = 30000ms (30ç§’)
retries = 3
retry.backoff.ms = 1000ms (1ç§’)

æœ€å°delivery.timeout.ms = 30000 + (3 Ã— 1000) = 33000ms (33ç§’)
å»ºè®®è®¾ç½® = 120000ms (2åˆ†é’Ÿ) ç•™å‡ºç¼“å†²æ—¶é—´
```

### 3.3 å¹‚ç­‰æ€§ProduceråŸç†


**ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œï¼Œç»“æœéƒ½ä¸€æ ·

> ğŸ’¡ **ç”Ÿæ´»ä¸­çš„å¹‚ç­‰æ€§ä¾‹å­**  
> - æŒ‰ç”µæ¢¯æŒ‰é’®ï¼šæŒ‰1æ¬¡å’ŒæŒ‰10æ¬¡æ•ˆæœä¸€æ ·ï¼Œç”µæ¢¯åªæ¥1æ¬¡
> - è½¬è´¦æ“ä½œï¼šåŒä¸€ç¬”è½¬è´¦æ— è®ºç‚¹å‡»å¤šå°‘æ¬¡ï¼Œåªä¼šè½¬è´¦1æ¬¡
> - Kafkaæ¶ˆæ¯ï¼šåŒä¸€æ¡æ¶ˆæ¯æ— è®ºå‘é€å¤šå°‘æ¬¡ï¼Œåªä¼šå­˜å‚¨1æ¬¡

### 3.4 å¹‚ç­‰æ€§å®ç°æœºåˆ¶


**æ ¸å¿ƒæœºåˆ¶**ï¼šä¸ºæ¯ä¸ªç”Ÿäº§è€…åˆ†é…å”¯ä¸€IDï¼Œä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…åºåˆ—å·

```java
// å¯ç”¨å¹‚ç­‰æ€§Producer
Properties props = new Properties();
props.put("enable.idempotence", "true");  // å¼€å¯å¹‚ç­‰æ€§

// å¹‚ç­‰æ€§ä¼šè‡ªåŠ¨è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š
// acks = "all"  (è‡ªåŠ¨è®¾ç½®)
// retries = Integer.MAX_VALUE  (è‡ªåŠ¨è®¾ç½®) 
// max.in.flight.requests.per.connection = 5  (è‡ªåŠ¨è®¾ç½®)

KafkaProducer<String, String> producer = new KafkaProducer<>(props);
```

**å¹‚ç­‰æ€§å·¥ä½œåŸç†å›¾**ï¼š
```
Producer (PID=123)              Kafka Broker
    |                              |
    |--Msg1(Seq=0)---------------->|
    |<--ACK-----------------------|  âœ…ä¿å­˜: PID=123,Seq=0
    |                              |
    |--Msg2(Seq=1)---------------->|
    |  ç½‘ç»œè¶…æ—¶ï¼Œé‡å‘                |
    |--Msg2(Seq=1)---------------->|
    |<--ACK-----------------------|  ğŸš«é‡å¤: PID=123,Seq=1å·²å­˜åœ¨
    |                              |
    |--Msg3(Seq=2)---------------->|
    |<--ACK-----------------------|  âœ…ä¿å­˜: PID=123,Seq=2
```

**å¹‚ç­‰æ€§çš„é™åˆ¶**ï¼š
```
âš ï¸ æ³¨æ„é™åˆ¶ï¼š
â€¢ åªåœ¨å•ä¸ªProducerä¼šè¯å†…æœ‰æ•ˆ
â€¢ åªä¿è¯å•ä¸ªåˆ†åŒºçš„å¹‚ç­‰æ€§  
â€¢ Produceré‡å¯åPIDä¼šå˜åŒ–
â€¢ ä¸èƒ½è·¨Topicä¿è¯å¹‚ç­‰æ€§

è§£å†³æ–¹æ¡ˆï¼š
â€¢ ä½¿ç”¨äº‹åŠ¡Producerå®ç°è·¨ä¼šè¯å¹‚ç­‰æ€§
â€¢ åº”ç”¨å±‚å®ç°ä¸šåŠ¡å¹‚ç­‰æ€§é€»è¾‘
```

---

## 4. ğŸª äº‹åŠ¡Produceræ·±åº¦è§£æ


### 4.1 äº‹åŠ¡Produceræ ¸å¿ƒæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯äº‹åŠ¡Producer**ï¼šä¿è¯ä¸€æ‰¹æ¶ˆæ¯è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥

> ğŸ’¡ **æ•°æ®åº“äº‹åŠ¡ç±»æ¯”**  
> å°±åƒé“¶è¡Œè½¬è´¦ï¼šAè´¦æˆ·æ‰£æ¬¾å’ŒBè´¦æˆ·å…¥è´¦å¿…é¡»åŒæ—¶æˆåŠŸï¼Œä¸èƒ½åªæˆåŠŸä¸€åŠ
> 
> Kafkaäº‹åŠ¡ï¼šå¤šæ¡ç›¸å…³æ¶ˆæ¯å¿…é¡»åŒæ—¶æäº¤ï¼Œä¿è¯ä¸šåŠ¡é€»è¾‘çš„å®Œæ•´æ€§

### 4.2 äº‹åŠ¡Produceråº”ç”¨åœºæ™¯


**å…¸å‹åœºæ™¯ç¤ºä¾‹**ï¼š
```
ğŸª ç”µå•†è®¢å•åœºæ™¯ï¼š
1. åˆ›å»ºè®¢å•æ¶ˆæ¯ â†’ order-topic
2. æ‰£å‡åº“å­˜æ¶ˆæ¯ â†’ inventory-topic  
3. ç”¨æˆ·ç§¯åˆ†æ¶ˆæ¯ â†’ points-topic

è¦æ±‚ï¼šä¸‰æ¡æ¶ˆæ¯å¿…é¡»åŒæ—¶æˆåŠŸï¼Œå¦åˆ™ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´

ğŸ“Š æ•°æ®ETLåœºæ™¯ï¼š
1. ä»æ•°æ®åº“è¯»å–æ•°æ®
2. è½¬æ¢æ•°æ®æ ¼å¼
3. å‘é€åˆ°å¤šä¸ªTopic
4. æ›´æ–°å¤„ç†çŠ¶æ€

è¦æ±‚ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
```

### 4.3 äº‹åŠ¡Produceré…ç½®


```java
Properties props = new Properties();
props.put("bootstrap.servers", "localhost:9092");

// ğŸ”‘ äº‹åŠ¡ç›¸å…³é…ç½®
props.put("transactional.id", "my-transactional-producer");  // å¿…é¡»å”¯ä¸€
props.put("enable.idempotence", "true");  // äº‹åŠ¡ä¾èµ–å¹‚ç­‰æ€§

// ğŸ• äº‹åŠ¡è¶…æ—¶é…ç½®
props.put("transaction.timeout.ms", "60000");  // 1åˆ†é’Ÿäº‹åŠ¡è¶…æ—¶

// è‡ªåŠ¨ä¼˜åŒ–çš„é…ç½®
// acks = "all"  (è‡ªåŠ¨)
// retries = Integer.MAX_VALUE  (è‡ªåŠ¨)

KafkaProducer<String, String> producer = new KafkaProducer<>(props);
```

### 4.4 äº‹åŠ¡Producerä½¿ç”¨ç¤ºä¾‹


```java
public class TransactionalProducerExample {
    
    public void sendOrderMessages(String orderId, int quantity, int points) {
        KafkaProducer<String, String> producer = createTransactionalProducer();
        
        try {
            // ğŸš€ 1. åˆå§‹åŒ–äº‹åŠ¡
            producer.initTransactions();
            
            // ğŸ”„ 2. å¼€å§‹äº‹åŠ¡
            producer.beginTransaction();
            
            // ğŸ“¦ 3. å‘é€ç›¸å…³æ¶ˆæ¯
            producer.send(new ProducerRecord<>("order-topic", 
                orderId, "è®¢å•åˆ›å»º:" + orderId));
                
            producer.send(new ProducerRecord<>("inventory-topic", 
                orderId, "åº“å­˜æ‰£å‡:" + quantity));
                
            producer.send(new ProducerRecord<>("points-topic", 
                orderId, "ç§¯åˆ†å¢åŠ :" + points));
            
            // âœ… 4. æäº¤äº‹åŠ¡
            producer.commitTransaction();
            System.out.println("è®¢å•äº‹åŠ¡æäº¤æˆåŠŸ: " + orderId);
            
        } catch (Exception e) {
            // âŒ 5. å›æ»šäº‹åŠ¡
            producer.abortTransaction();
            System.err.println("è®¢å•äº‹åŠ¡å›æ»š: " + orderId + ", åŸå› : " + e.getMessage());
            throw new RuntimeException("è®¢å•å¤„ç†å¤±è´¥", e);
        } finally {
            producer.close();
        }
    }
}
```

### 4.5 äº‹åŠ¡çŠ¶æ€æµè½¬


```
äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å›¾ï¼š

   åˆå§‹åŒ–
     â†“
  [READY] â”€â”€â”€â”€beginTransaction()â”€â”€â”€â”€â†’ [IN_TRANSACTION]
                                           â”‚
                                           â”‚ send messages
                                           â†“
                              [COMMITTING_TRANSACTION] â†â”€â”€ commitTransaction()
                                           â”‚
                                           â†“
                                      [COMMITTED] 
                                           
                              [ABORTING_TRANSACTION] â†â”€â”€ abortTransaction()
                                           â”‚
                                           â†“
                                      [ABORTED]
```

---

## 5. ğŸ“‹ æ¶ˆæ¯é¡ºåºä¿è¯ç­–ç•¥


### 5.1 Kafkaé¡ºåºä¿è¯æœºåˆ¶


**Kafkaçš„é¡ºåºæ‰¿è¯º**ï¼šåªä¿è¯**å•åˆ†åŒºå†…**çš„æ¶ˆæ¯é¡ºåº

> ğŸ’¡ **å¿«é€’ç±»æ¯”**  
> - å•åˆ†åŒº = å•ä¸ªé…é€å‘˜ï¼šä¸€ä¸ªé…é€å‘˜æŒ‰é¡ºåºæŠ•é€’ï¼Œé¡ºåºæœ‰ä¿è¯
> - å¤šåˆ†åŒº = å¤šä¸ªé…é€å‘˜ï¼šä¸åŒé…é€å‘˜ä¹‹é—´æ— æ³•ä¿è¯æŠ•é€’é¡ºåº

```
Topic: user-events (3ä¸ªåˆ†åŒº)

åˆ†åŒº0: [ç™»å½•] â†’ [æµè§ˆ] â†’ [è´­ä¹°]     âœ… é¡ºåºæ­£ç¡®
åˆ†åŒº1: [é€€æ¬¾] â†’ [è¯„ä»·]             âœ… é¡ºåºæ­£ç¡®  
åˆ†åŒº2: [æ³¨å†Œ] â†’ [æ¿€æ´»]             âœ… é¡ºåºæ­£ç¡®

ä½†æ˜¯ä¸åŒåˆ†åŒºé—´çš„æ¶ˆæ¯é¡ºåºæ— æ³•ä¿è¯ï¼š
å¯èƒ½å‡ºç°ï¼š[æ³¨å†Œ] â†’ [ç™»å½•] â†’ [æµè§ˆ] â†’ [é€€æ¬¾] â†’ [è´­ä¹°] â†’ [æ¿€æ´»] â†’ [è¯„ä»·]
```

### 5.2 å½±å“æ¶ˆæ¯é¡ºåºçš„å› ç´ 


#### ğŸš¦ max.in.flight.requests.per.connectionå‚æ•°


**å‚æ•°å«ä¹‰**ï¼šåŒæ—¶å‘é€ä½†å°šæœªæ”¶åˆ°å“åº”çš„è¯·æ±‚æ•°é‡

```java
// ğŸ”§ é¡ºåºä¿è¯é…ç½®
Properties props = new Properties();

// ä¸¥æ ¼é¡ºåºä¿è¯
props.put("max.in.flight.requests.per.connection", "1");  // åŒæ—¶åªèƒ½æœ‰1ä¸ªè¯·æ±‚
props.put("enable.idempotence", "true");  // å¯ç”¨å¹‚ç­‰æ€§
props.put("acks", "all");  // ç­‰å¾…æ‰€æœ‰ç¡®è®¤

// æ€§èƒ½ä¸é¡ºåºå¹³è¡¡
props.put("max.in.flight.requests.per.connection", "5");  // å…è®¸5ä¸ªå¹¶å‘è¯·æ±‚
props.put("enable.idempotence", "true");  // å¹‚ç­‰æ€§ä¿è¯é¡ºåº
```

**å‚æ•°å½±å“åˆ†æ**ï¼š
```
max.in.flight.requests.per.connection = 1:
âœ… ä¸¥æ ¼ä¿è¯é¡ºåº
âŒ æ€§èƒ½è¾ƒä½ï¼Œååé‡å°

max.in.flight.requests.per.connection = 5 + enable.idempotence = true:
âœ… ä¿è¯é¡ºåºï¼ˆé€šè¿‡åºåˆ—å·é‡æ’ï¼‰
âœ… æ€§èƒ½è¾ƒå¥½ï¼Œååé‡é«˜

max.in.flight.requests.per.connection > 1 + enable.idempotence = false:
âŒ å¯èƒ½ä¹±åº
âœ… æ€§èƒ½æœ€å¥½
```

### 5.3 åˆ†åŒºç­–ç•¥ä¸é¡ºåº


**é€‰æ‹©åˆé€‚çš„åˆ†åŒºç­–ç•¥**ï¼š

```java
public class OrderKeyPartitioner implements Partitioner {
    
    @Override
    public int partition(String topic, Object key, byte[] keyBytes, 
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        if (keyBytes == null) {
            // æ²¡æœ‰keyæ—¶éšæœºåˆ†åŒºï¼ˆæ— é¡ºåºä¿è¯ï¼‰
            return ThreadLocalRandom.current().nextInt(
                cluster.partitionCountForTopic(topic));
        }
        
        // ğŸ”‘ æ ¹æ®ç”¨æˆ·IDå“ˆå¸Œåˆ†åŒºï¼Œä¿è¯åŒä¸€ç”¨æˆ·çš„æ¶ˆæ¯æœ‰åº
        return Math.abs(key.hashCode()) % cluster.partitionCountForTopic(topic);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Properties props = new Properties();
props.put("partitioner.class", "OrderKeyPartitioner");

// å‘é€æ¶ˆæ¯æ—¶æŒ‡å®škey
producer.send(new ProducerRecord<>("user-events", "userId123", "ç™»å½•äº‹ä»¶"));
producer.send(new ProducerRecord<>("user-events", "userId123", "è´­ä¹°äº‹ä»¶"));
// userId123çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šåˆ°åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåº
```

### 5.4 ä¸šåŠ¡å±‚é¡ºåºä¿è¯ç­–ç•¥


**ç­–ç•¥é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | **ç­–ç•¥** | **é…ç½®** | **æ€§èƒ½** |
|------|---------|---------|---------|
| ğŸ”¥ **ä¸¥æ ¼å…¨å±€é¡ºåº** | `å•åˆ†åŒºTopic` | `partitions=1` | `æœ€ä½` |
| ğŸ“Š **ç”¨æˆ·ç»´åº¦é¡ºåº** | `æŒ‰ç”¨æˆ·IDåˆ†åŒº` | `key=userId` | `ä¸­ç­‰` |
| ğŸª **è®¢å•ç»´åº¦é¡ºåº** | `æŒ‰è®¢å•IDåˆ†åŒº` | `key=orderId` | `ä¸­ç­‰` |
| âš¡ **æ— é¡ºåºè¦æ±‚** | `éšæœºåˆ†åŒº` | `key=null` | `æœ€é«˜` |

---

## 6. âš ï¸ é”™è¯¯å¤„ç†ä¸å¼‚å¸¸ç­–ç•¥


### 6.1 å¸¸è§å¼‚å¸¸ç±»å‹åˆ†æ


**Producerå‘é€å¯èƒ½é‡åˆ°çš„å¼‚å¸¸**ï¼š

```java
public class ProducerErrorHandler {
    
    public void handleSendError(Exception exception) {
        if (exception instanceof RetriableException) {
            // ğŸ”„ å¯é‡è¯•å¼‚å¸¸ï¼šç½‘ç»œé—®é¢˜ã€ä¸´æ—¶æ•…éšœ
            handleRetriableError(exception);
            
        } else if (exception instanceof SerializationException) {
            // ğŸ“¦ åºåˆ—åŒ–å¼‚å¸¸ï¼šæ•°æ®æ ¼å¼é—®é¢˜  
            handleSerializationError(exception);
            
        } else if (exception instanceof TimeoutException) {
            // â° è¶…æ—¶å¼‚å¸¸ï¼šç½‘ç»œæˆ–brokerå“åº”æ…¢
            handleTimeoutError(exception);
            
        } else if (exception instanceof AuthorizationException) {
            // ğŸ”’ æƒé™å¼‚å¸¸ï¼šè®¤è¯æˆ–æˆæƒå¤±è´¥
            handleAuthorizationError(exception);
            
        } else {
            // âŒ å…¶ä»–ä¸å¯æ¢å¤å¼‚å¸¸
            handleFatalError(exception);
        }
    }
}
```

### 6.2 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


```java
public class RobustProducer {
    private final KafkaProducer<String, String> producer;
    private final CircuitBreaker circuitBreaker;
    
    public void sendMessageSafely(String topic, String key, String value) {
        
        // ğŸ›¡ï¸ 1. è¾“å…¥éªŒè¯
        if (value == null || value.trim().isEmpty()) {
            throw new IllegalArgumentException("æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º");
        }
        
        // ğŸ”„ 2. æ–­è·¯å™¨ä¿æŠ¤
        if (circuitBreaker.isOpen()) {
            throw new RuntimeException("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        try {
            // ğŸ“¤ 3. å¼‚æ­¥å‘é€withå›è°ƒ
            producer.send(new ProducerRecord<>(topic, key, value), 
                new Callback() {
                    @Override
                    public void onCompletion(RecordMetadata metadata, Exception exception) {
                        if (exception != null) {
                            handleSendFailure(topic, key, value, exception);
                        } else {
                            handleSendSuccess(metadata);
                        }
                    }
                });
                
        } catch (Exception e) {
            // ğŸ“Š 4. è®°å½•å¤±è´¥æŒ‡æ ‡
            recordFailureMetrics(topic, e);
            throw new RuntimeException("æ¶ˆæ¯å‘é€å¤±è´¥", e);
        }
    }
    
    private void handleSendFailure(String topic, String key, String value, Exception e) {
        // ğŸ“ è®°å½•å¤±è´¥æ—¥å¿—
        logger.error("æ¶ˆæ¯å‘é€å¤±è´¥ - Topic: {}, Key: {}, Error: {}", 
                    topic, key, e.getMessage());
        
        // ğŸ’¾ æŒä¹…åŒ–å¤±è´¥æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
        saveFailedMessage(topic, key, value, e);
        
        // ğŸ“Š æ›´æ–°å¤±è´¥æŒ‡æ ‡
        failureCounter.increment();
        
        // ğŸ”” è§¦å‘å‘Šè­¦ï¼ˆä¸¥é‡é”™è¯¯æ—¶ï¼‰
        if (!(e instanceof RetriableException)) {
            alertManager.sendAlert("Producerå‘é€å¤±è´¥", e);
        }
    }
}
```

### 6.3 æ­»ä¿¡é˜Ÿåˆ—(DLQ)æ¨¡å¼


```java
public class DLQProducer {
    private final KafkaProducer<String, String> producer;
    private final String dlqTopic;
    
    public void sendWithDLQ(String topic, String key, String value) {
        ProducerRecord<String, String> record = new ProducerRecord<>(topic, key, value);
        
        producer.send(record, (metadata, exception) -> {
            if (exception != null) {
                // ğŸš¨ å‘é€å¤±è´¥ï¼Œè½¬å‘åˆ°æ­»ä¿¡é˜Ÿåˆ—
                sendToDLQ(topic, key, value, exception);
            }
        });
    }
    
    private void sendToDLQ(String originalTopic, String key, String value, Exception error) {
        // ğŸ·ï¸ æ„é€ æ­»ä¿¡æ¶ˆæ¯ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯
        String dlqValue = JSON.toJSONString(Map.of(
            "originalTopic", originalTopic,
            "originalValue", value,
            "errorMessage", error.getMessage(),
            "timestamp", System.currentTimeMillis()
        ));
        
        try {
            // ğŸ“¤ å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            producer.send(new ProducerRecord<>(dlqTopic, key, dlqValue)).get();
            logger.warn("æ¶ˆæ¯å·²å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—: {}", key);
        } catch (Exception dlqException) {
            // ğŸ’¾ è¿æ­»ä¿¡é˜Ÿåˆ—éƒ½å¤±è´¥äº†ï¼ŒæŒä¹…åŒ–åˆ°æœ¬åœ°
            saveToLocalStorage(originalTopic, key, value, error);
        }
    }
}
```

---

## 7. âš¡ Exactly-onceè¯­ä¹‰å®ç°


### 7.1 Exactly-onceæ ¸å¿ƒç†å¿µ


**ä»€ä¹ˆæ˜¯Exactly-once**ï¼šæ¶ˆæ¯åœ¨æ•´ä¸ªç³»ç»Ÿä¸­è¢«å¤„ç†ä¸”ä»…è¢«å¤„ç†ä¸€æ¬¡

> ğŸ’¡ **è½¬è´¦ä¸šåŠ¡ç±»æ¯”**  
> - At-least-onceï¼šå¯èƒ½å¤šæ¬¡è½¬è´¦ï¼ˆé’±å¤šæ‰£äº†ï¼‰
> - At-most-onceï¼šå¯èƒ½ä¸è½¬è´¦ï¼ˆé’±æ²¡æ‰£æˆåŠŸï¼‰  
> - Exactly-onceï¼šæ°å¥½è½¬è´¦ä¸€æ¬¡ï¼ˆé’±æ‰£å¾—åˆšå¥½ï¼‰

```
Exactly-once è¯­ä¹‰çš„å®ç°å±‚æ¬¡ï¼š

ğŸ“¤ Producerå±‚é¢ï¼šå¹‚ç­‰æ€§Producer + äº‹åŠ¡
ğŸ“¦ Kafkaå±‚é¢ï¼šäº‹åŠ¡æ—¥å¿— + ä¸¤é˜¶æ®µæäº¤
ğŸ“¥ Consumerå±‚é¢ï¼šäº‹åŠ¡æ¶ˆè´¹ + åç§»é‡ç®¡ç†
ğŸ”„ ç«¯åˆ°ç«¯ï¼šProduceräº‹åŠ¡ + Consumeräº‹åŠ¡
```

### 7.2 Producerç«¯Exactly-onceå®ç°


```java
public class ExactlyOnceProducer {
    
    public void sendExactlyOnce() {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        
        // ğŸ”‘ Exactly-onceå…³é”®é…ç½®
        props.put("transactional.id", "exactly-once-producer-1");  // äº‹åŠ¡ID
        props.put("enable.idempotence", "true");  // å¹‚ç­‰æ€§
        props.put("acks", "all");  // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
        props.put("retries", Integer.MAX_VALUE);  // æ— é™é‡è¯•
        props.put("max.in.flight.requests.per.connection", "5");  // æ”¯æŒæ‰¹å¤„ç†
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        
        try {
            producer.initTransactions();  // åˆå§‹åŒ–äº‹åŠ¡
            
            while (true) {
                producer.beginTransaction();  // å¼€å§‹äº‹åŠ¡
                
                try {
                    // ğŸ“¦ æ‰¹é‡å‘é€æ¶ˆæ¯
                    for (int i = 0; i < 100; i++) {
                        producer.send(new ProducerRecord<>(
                            "exactly-once-topic", 
                            "key-" + i, 
                            "value-" + System.currentTimeMillis()
                        ));
                    }
                    
                    producer.commitTransaction();  // æäº¤äº‹åŠ¡
                    System.out.println("æ‰¹æ¬¡æäº¤æˆåŠŸ");
                    
                } catch (Exception e) {
                    producer.abortTransaction();  // å›æ»šäº‹åŠ¡
                    System.err.println("æ‰¹æ¬¡å›æ»š: " + e.getMessage());
                }
                
                Thread.sleep(5000);  // ç­‰å¾…5ç§’å‘é€ä¸‹ä¸€æ‰¹
            }
            
        } finally {
            producer.close();
        }
    }
}
```

### 7.3 ç«¯åˆ°ç«¯Exactly-onceå®ç°


**å®Œæ•´çš„Exactly-onceé“¾è·¯**ï¼š

```java
// ğŸ”„ ä»ä¸€ä¸ªTopicæ¶ˆè´¹ï¼Œå¤„ç†åå‘é€åˆ°å¦ä¸€ä¸ªTopic
public class ExactlyOnceProcessor {
    
    public void processExactlyOnce() {
        // Produceré…ç½®ï¼šäº‹åŠ¡æ¨¡å¼
        Properties producerProps = new Properties();
        producerProps.put("transactional.id", "processor-1");
        producerProps.put("enable.idempotence", "true");
        
        // Consumeré…ç½®ï¼šäº‹åŠ¡æ¨¡å¼
        Properties consumerProps = new Properties();
        consumerProps.put("group.id", "exactly-once-processor");
        consumerProps.put("enable.auto.commit", "false");  // å…³é—­è‡ªåŠ¨æäº¤
        consumerProps.put("isolation.level", "read_committed");  // åªè¯»å·²æäº¤
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(producerProps);
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(consumerProps);
        
        consumer.subscribe(Arrays.asList("input-topic"));
        producer.initTransactions();
        
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
            
            if (!records.isEmpty()) {
                producer.beginTransaction();
                
                try {
                    // ğŸ”„ å¤„ç†æ¶ˆæ¯å¹¶å‘é€åˆ°è¾“å‡ºTopic
                    for (ConsumerRecord<String, String> record : records) {
                        String processedValue = processMessage(record.value());
                        producer.send(new ProducerRecord<>(
                            "output-topic", record.key(), processedValue));
                    }
                    
                    // ğŸ“‹ äº‹åŠ¡æ€§æäº¤Consumeråç§»é‡
                    Map<TopicPartition, OffsetAndMetadata> offsets = new HashMap<>();
                    for (ConsumerRecord<String, String> record : records) {
                        offsets.put(
                            new TopicPartition(record.topic(), record.partition()),
                            new OffsetAndMetadata(record.offset() + 1)
                        );
                    }
                    producer.sendOffsetsToTransaction(offsets, consumer.groupMetadata());
                    
                    // âœ… æäº¤æ•´ä¸ªäº‹åŠ¡
                    producer.commitTransaction();
                    System.out.println("å¤„ç† " + records.count() + " æ¡æ¶ˆæ¯æˆåŠŸ");
                    
                } catch (Exception e) {
                    producer.abortTransaction();  // å›æ»šäº‹åŠ¡
                    System.err.println("å¤„ç†å¤±è´¥ï¼Œäº‹åŠ¡å›æ»š: " + e.getMessage());
                }
            }
        }
    }
}
```

---

## 8. ğŸ—ï¸ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


### 8.1 é«˜å¯é æ€§é…ç½®æ¨¡æ¿


```java
public class ProductionProducerConfig {
    
    public static Properties createHighReliabilityConfig() {
        Properties props = new Properties();
        
        // ğŸ”— è¿æ¥é…ç½®
        props.put("bootstrap.servers", "kafka1:9092,kafka2:9092,kafka3:9092");
        props.put("client.id", "high-reliability-producer");
        
        // ğŸ›¡ï¸ å¯é æ€§é…ç½®
        props.put("acks", "all");  // ç­‰å¾…æ‰€æœ‰ISRç¡®è®¤
        props.put("retries", Integer.MAX_VALUE);  // æ— é™é‡è¯•
        props.put("enable.idempotence", "true");  // å¹‚ç­‰æ€§
        props.put("max.in.flight.requests.per.connection", "5");  // ä¿æŒé¡ºåº
        
        // â±ï¸ è¶…æ—¶é…ç½®
        props.put("request.timeout.ms", "30000");  // 30ç§’è¯·æ±‚è¶…æ—¶
        props.put("delivery.timeout.ms", "120000");  // 2åˆ†é’ŸæŠ•é€’è¶…æ—¶
        props.put("retry.backoff.ms", "1000");  // 1ç§’é‡è¯•é—´éš”
        
        // ğŸš€ æ€§èƒ½é…ç½®
        props.put("batch.size", "32768");  // 32KBæ‰¹å¤„ç†å¤§å°
        props.put("linger.ms", "5");  // 5mså»¶è¿Ÿæ‰¹å¤„ç†
        props.put("compression.type", "lz4");  // LZ4å‹ç¼©
        props.put("buffer.memory", "67108864");  // 64MBç¼“å†²åŒº
        
        // ğŸ“Š ç›‘æ§é…ç½®
        props.put("metrics.recording.level", "INFO");
        
        return props;
    }
}
```

### 8.2 ç›‘æ§æŒ‡æ ‡è®¾ç½®


```java
// ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡
public class ProducerMetrics {
    
    // å‘é€æˆåŠŸç‡
    @Metric("kafka.producer.send.success.rate")
    public double getSendSuccessRate() {
        return (double) successCount / (successCount + failureCount);
    }
    
    // å¹³å‡å»¶è¿Ÿ
    @Metric("kafka.producer.send.latency.avg")
    public double getAverageLatency() {
        return recordSendRateMetric.mean();
    }
    
    // é‡è¯•ç‡
    @Metric("kafka.producer.retry.rate") 
    public double getRetryRate() {
        return retryRateMetric.rate();
    }
    
    // äº‹åŠ¡æˆåŠŸç‡ï¼ˆå¦‚æœä½¿ç”¨äº‹åŠ¡ï¼‰
    @Metric("kafka.producer.transaction.success.rate")
    public double getTransactionSuccessRate() {
        return (double) transactionCommits / transactionTotal;
    }
}
```

### 8.3 å‘Šè­¦è§„åˆ™é…ç½®


```yaml
# ğŸš¨ Kafka Producer å‘Šè­¦è§„åˆ™
alerts:
  - name: ProducerSendFailureRate
    condition: kafka_producer_send_failure_rate > 0.01  # å¤±è´¥ç‡è¶…è¿‡1%
    severity: warning
    description: "Producerå‘é€å¤±è´¥ç‡è¿‡é«˜"
    
  - name: ProducerLatencyHigh  
    condition: kafka_producer_send_latency_p99 > 5000  # 99åˆ†ä½å»¶è¿Ÿè¶…è¿‡5ç§’
    severity: warning
    description: "Producerå‘é€å»¶è¿Ÿè¿‡é«˜"
    
  - name: ProducerConnectionDown
    condition: kafka_producer_connection_count == 0  # è¿æ¥æ•°ä¸º0
    severity: critical
    description: "Producerä¸Kafkaè¿æ¥æ–­å¼€"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”‘ å…³é”®æ¦‚å¿µç†è§£ï¼š
â€¢ acksæœºåˆ¶ï¼š0/1/allä¸‰ç§æ¨¡å¼çš„é€‚ç”¨åœºæ™¯
â€¢ å¹‚ç­‰æ€§ï¼šé˜²é‡å¤çš„PID+åºåˆ—å·æœºåˆ¶
â€¢ äº‹åŠ¡ï¼šè·¨æ¶ˆæ¯çš„åŸå­æ€§ä¿è¯
â€¢ é¡ºåºï¼šå•åˆ†åŒºé¡ºåº vs å…¨å±€é¡ºåº
â€¢ é‡è¯•ï¼šå¯é‡è¯•å¼‚å¸¸ vs ä¸å¯é‡è¯•å¼‚å¸¸
â€¢ Exactly-onceï¼šç«¯åˆ°ç«¯çš„ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰
```

### 9.2 é…ç½®é€‰æ‹©å†³ç­–æ ‘


```
é…ç½®é€‰æ‹©æµç¨‹ï¼š

ä¸šåŠ¡æ•°æ®é‡è¦å—ï¼Ÿ
â”œâ”€â”€ éå¸¸é‡è¦ (é‡‘èã€è®¢å•)
â”‚   â”œâ”€â”€ acks = "all"
â”‚   â”œâ”€â”€ enable.idempotence = true  
â”‚   â””â”€â”€ è€ƒè™‘äº‹åŠ¡Producer
â”‚
â”œâ”€â”€ ä¸€èˆ¬é‡è¦ (ç”¨æˆ·è¡Œä¸º)
â”‚   â”œâ”€â”€ acks = "1" 
â”‚   â”œâ”€â”€ retries = 3
â”‚   â””â”€â”€ é€‚å½“ç›‘æ§
â”‚
â””â”€â”€ ä¸å¤ªé‡è¦ (æ—¥å¿—ã€ç›‘æ§)
    â”œâ”€â”€ acks = "0"
    â””â”€â”€ è¿½æ±‚æ€§èƒ½ä¼˜å…ˆ
```

### 9.3 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•


**ğŸ” ä¸Šçº¿å‰æ£€æŸ¥é¡¹**ï¼š

- [ ] **å¯é æ€§é…ç½®**
  - [ ] acksé…ç½®ç¬¦åˆä¸šåŠ¡éœ€æ±‚
  - [ ] é‡è¯•ç­–ç•¥åˆç†è®¾ç½®
  - [ ] è¶…æ—¶æ—¶é—´å……è¶³è®¾ç½®

- [ ] **æ€§èƒ½é…ç½®** 
  - [ ] æ‰¹å¤„ç†å¤§å°é€‚å½“
  - [ ] å‹ç¼©ç®—æ³•é€‰æ‹©
  - [ ] ç¼“å†²åŒºå¤§å°åˆç†

- [ ] **ç›‘æ§å‘Šè­¦**
  - [ ] å…³é”®æŒ‡æ ‡ç›‘æ§å°±ä½
  - [ ] å‘Šè­¦é˜ˆå€¼åˆç†è®¾ç½®
  - [ ] å‘Šè­¦é€šé“ç•…é€š

- [ ] **å¼‚å¸¸å¤„ç†**
  - [ ] å¼‚å¸¸åˆ†ç±»å¤„ç†å®Œå–„
  - [ ] æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶å°±ä½  
  - [ ] å¤±è´¥é‡è¯•ç­–ç•¥æ˜ç¡®

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


| é—®é¢˜åœºæ™¯ | **ç—‡çŠ¶** | **åŸå› åˆ†æ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|---------|------------|------------|
| ğŸŒ **å‘é€æ…¢** | `å»¶è¿Ÿé«˜ï¼Œååä½` | `acks=all + ç½‘ç»œæ…¢` | `è°ƒæ•´batch.sizeå’Œlinger.ms` |
| ğŸ”„ **æ¶ˆæ¯é‡å¤** | `Consumeræ”¶åˆ°é‡å¤æ¶ˆæ¯` | `é‡è¯•å¯¼è‡´é‡å¤` | `å¯ç”¨å¹‚ç­‰æ€§Producer` |
| ğŸ“‹ **é¡ºåºé”™ä¹±** | `æ¶ˆæ¯ä¹±åºåˆ°è¾¾` | `å¹¶å‘è¯·æ±‚ + é‡è¯•` | `max.in.flight.requests=1` |
| ğŸ’¥ **å‘é€å¤±è´¥** | `å¼‚å¸¸ç‡é«˜` | `é…ç½®ä¸å½“æˆ–ç½‘ç»œé—®é¢˜` | `æ£€æŸ¥ackså’Œé‡è¯•é…ç½®` |

### 9.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ¯ å¾ªåºæ¸è¿›å­¦ä¹ **ï¼š
1. **å…¥é—¨é˜¶æ®µ**ï¼šç†è§£acksåŸºæœ¬æ¦‚å¿µï¼Œé…ç½®ç®€å•Producer
2. **è¿›é˜¶é˜¶æ®µ**ï¼šæŒæ¡å¹‚ç­‰æ€§å’Œé‡è¯•æœºåˆ¶ï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µ  
3. **é«˜çº§é˜¶æ®µ**ï¼šå­¦ä¹ äº‹åŠ¡Producerï¼Œå®ç°Exactly-once
4. **ä¸“å®¶é˜¶æ®µ**ï¼šä¼˜åŒ–æ€§èƒ½é…ç½®ï¼Œè®¾è®¡ç›‘æ§å‘Šè­¦ä½“ç³»

**ğŸ’¡ å®è·µå»ºè®®**ï¼š
- å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯é…ç½®
- ä»ç®€å•åœºæ™¯å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚æ€§
- é‡è§†ç›‘æ§å’Œæ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- äº†è§£ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé€‰æ‹©åˆé€‚çš„å¯é æ€§çº§åˆ«

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¯é å‘é€ä¸‰è¦ç´ ï¼šç¡®è®¤é‡è¯•åŠ å¹‚ç­‰
- acksé€‰æ‹©çœ‹ä¸šåŠ¡ï¼šå…³é”®å…¨éƒ¨ä¸€èˆ¬ä¸€
- é¡ºåºä¿è¯å•åˆ†åŒºï¼šåŒkeyåŒåˆ†åŒºé‡Œ
- äº‹åŠ¡ä¿è¯åŸå­æ€§ï¼šè¦ä¹ˆå…¨æˆè¦ä¹ˆå¼ƒ