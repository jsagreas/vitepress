---
title: 6ã€Produceræ‰©å±•å¼€å‘
---
## ğŸ“š ç›®å½•

1. [ç”Ÿäº§è€…æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ](#1-ç”Ÿäº§è€…æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ)
2. [ProducerInterceptoræ¥å£è¯¦è§£](#2-ProducerInterceptoræ¥å£è¯¦è§£)
3. [è‡ªå®šä¹‰æ‹¦æˆªå™¨å¼€å‘å®æˆ˜](#3-è‡ªå®šä¹‰æ‹¦æˆªå™¨å¼€å‘å®æˆ˜)
4. [æ‹¦æˆªå™¨é“¾è®¾è®¡æ¨¡å¼](#4-æ‹¦æˆªå™¨é“¾è®¾è®¡æ¨¡å¼)
5. [æ¶ˆæ¯å¢å¼ºå’Œè¿‡æ»¤æœºåˆ¶](#5-æ¶ˆæ¯å¢å¼ºå’Œè¿‡æ»¤æœºåˆ¶)
6. [ç›‘æ§æ•°æ®æ”¶é›†å®è·µ](#6-ç›‘æ§æ•°æ®æ”¶é›†å®è·µ)
7. [æ’ä»¶åŒ–æ‰©å±•æœºåˆ¶](#7-æ’ä»¶åŒ–æ‰©å±•æœºåˆ¶)
8. [æ€§èƒ½å½±å“åˆ†æä¸æœ€ä½³å®è·µ](#8-æ€§èƒ½å½±å“åˆ†æä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç”Ÿäº§è€…æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç”Ÿäº§è€…æ‹¦æˆªå™¨


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸‹å¯„å¿«é€’çš„è¿‡ç¨‹ï¼šä½ è¦å¯„ä¸€ä¸ªåŒ…è£¹ï¼Œåœ¨åŒ…è£¹åˆ°è¾¾ç›®çš„åœ°ä¹‹å‰ï¼Œå¯èƒ½éœ€è¦ç»è¿‡å¤šä¸ªä¸­è½¬ç«™ã€‚æ¯ä¸ªä¸­è½¬ç«™éƒ½å¯ä»¥å¯¹åŒ…è£¹è¿›è¡Œæ£€æŸ¥ã€è®°å½•ã€ç”šè‡³æ·»åŠ æ ‡ç­¾ã€‚

```
ä½ çš„æ¶ˆæ¯ â†’ æ‹¦æˆªå™¨A â†’ æ‹¦æˆªå™¨B â†’ æ‹¦æˆªå™¨C â†’ å‘é€åˆ°Kafka
   â†“           â†“           â†“           â†“
  åŸå§‹æ¶ˆæ¯    æ·»åŠ æ—¶é—´æˆ³    è®°å½•æ—¥å¿—     åŠ å¯†å¤„ç†
```

**Produceræ‹¦æˆªå™¨**å°±æ˜¯è¿™æ ·çš„"ä¸­è½¬ç«™"ï¼Œå®ƒä»¬å¯ä»¥åœ¨æ¶ˆæ¯å‘é€å‰åå¯¹æ¶ˆæ¯è¿›è¡Œå„ç§å¤„ç†ã€‚

### 1.2 æ‹¦æˆªå™¨çš„æ ¸å¿ƒä½œç”¨


**ğŸ’¡ ä¸»è¦åŠŸèƒ½**
- **æ¶ˆæ¯å¢å¼º**ï¼šç»™æ¶ˆæ¯æ·»åŠ é¢å¤–ä¿¡æ¯ï¼ˆæ—¶é—´æˆ³ã€æ ‡ç­¾ç­‰ï¼‰
- **æ•°æ®è¿‡æ»¤**ï¼šç­›é€‰å‡ºä¸ç¬¦åˆè¦æ±‚çš„æ¶ˆæ¯
- **ç›‘æ§ç»Ÿè®¡**ï¼šæ”¶é›†å‘é€æˆåŠŸç‡ã€å»¶è¿Ÿç­‰æ•°æ®
- **å®‰å…¨æ§åˆ¶**ï¼šå¯¹æ•æ„Ÿæ¶ˆæ¯è¿›è¡ŒåŠ å¯†æˆ–è„±æ•
- **è°ƒè¯•è¿½è¸ª**ï¼šè®°å½•æ¶ˆæ¯æµè½¬è¿‡ç¨‹ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### 1.3 æ‹¦æˆªå™¨åœ¨Kafkaä¸­çš„ä½ç½®


```
åº”ç”¨ç¨‹åº
    â†“
Producerå®ä¾‹
    â†“
æ‹¦æˆªå™¨é“¾ â† è¿™é‡Œï¼å¤„ç†æ¶ˆæ¯çš„åœ°æ–¹
    â†“
åºåˆ—åŒ–å™¨
    â†“
åˆ†åŒºå™¨
    â†“
å‘é€åˆ°Kafkaé›†ç¾¤
```

**ğŸ”¹ æ‰§è¡Œæ—¶æœº**
- **å‘é€å‰**ï¼š`onSend()` - åœ¨æ¶ˆæ¯åºåˆ—åŒ–å’Œåˆ†åŒºä¹‹å‰æ‰§è¡Œ
- **ç¡®è®¤å**ï¼š`onAcknowledgement()` - åœ¨æ”¶åˆ°æœåŠ¡å™¨å“åº”åæ‰§è¡Œ

---

## 2. ğŸ”§ ProducerInterceptoræ¥å£è¯¦è§£


### 2.1 æ¥å£æ ¸å¿ƒæ–¹æ³•


**ğŸ“‹ ProducerInterceptoræ¥å£ç»“æ„**
```java
public interface ProducerInterceptor<K, V> {
    // æ¶ˆæ¯å‘é€å‰è°ƒç”¨ - å¯ä»¥ä¿®æ”¹æ¶ˆæ¯
    ProducerRecord<K, V> onSend(ProducerRecord<K, V> record);
    
    // æ”¶åˆ°æœåŠ¡å™¨å“åº”åè°ƒç”¨ - ç”¨äºç›‘æ§ç»Ÿè®¡
    void onAcknowledgement(RecordMetadata metadata, Exception exception);
    
    // æ‹¦æˆªå™¨å…³é—­æ—¶è°ƒç”¨ - æ¸…ç†èµ„æº
    void close();
    
    // é…ç½®æ‹¦æˆªå™¨ - æ¥æ”¶é…ç½®å‚æ•°
    void configure(Map<String, ?> configs);
}
```

### 2.2 æ–¹æ³•è¯¦ç»†è¯´æ˜


**ğŸ”¸ onSend()æ–¹æ³• - æ¶ˆæ¯å‘é€å‰å¤„ç†**

è¿™æ˜¯**æœ€é‡è¦çš„æ–¹æ³•**ï¼Œåœ¨æ¶ˆæ¯å‘é€å‰è°ƒç”¨ï¼Œå¯ä»¥ï¼š

| æ“ä½œç±»å‹ | è¯´æ˜ | å®é™…ç”¨é€” |
|---------|------|---------|
| **ä¿®æ”¹æ¶ˆæ¯** | æ”¹å˜æ¶ˆæ¯å†…å®¹ã€headersç­‰ | æ·»åŠ æ—¶é—´æˆ³ã€ç”¨æˆ·ID |
| **è¿‡æ»¤æ¶ˆæ¯** | è¿”å›nullè¡¨ç¤ºä¸å‘é€ | è¿‡æ»¤æ•æ„Ÿä¿¡æ¯ |
| **è®°å½•æ—¥å¿—** | è®°å½•å‘é€çš„æ¶ˆæ¯ä¿¡æ¯ | å®¡è®¡è¿½è¸ª |

**ğŸ”¸ onAcknowledgement()æ–¹æ³• - å‘é€ç»“æœå¤„ç†**

åœ¨æ”¶åˆ°KafkaæœåŠ¡å™¨å“åº”åè°ƒç”¨ï¼Œç”¨äºï¼š
- **æˆåŠŸç»Ÿè®¡**ï¼š`metadata != null && exception == null`
- **å¤±è´¥ç»Ÿè®¡**ï¼š`exception != null`
- **å»¶è¿Ÿç›‘æ§**ï¼šè®¡ç®—å‘é€è€—æ—¶
- **é”™è¯¯è®°å½•**ï¼šè®°å½•å¤±è´¥åŸå› 

### 2.3 æ–¹æ³•æ‰§è¡Œé¡ºåºå›¾


```
åº”ç”¨è°ƒç”¨send()
        â†“
   æ‹¦æˆªå™¨A.onSend()
        â†“
   æ‹¦æˆªå™¨B.onSend()
        â†“
    åºåˆ—åŒ– + åˆ†åŒº
        â†“
    å‘é€åˆ°Kafka
        â†“
    æ”¶åˆ°å“åº”/å¼‚å¸¸
        â†“
   æ‹¦æˆªå™¨B.onAcknowledgement()  â† æ³¨æ„ï¼šé€†åºæ‰§è¡Œï¼
        â†“
   æ‹¦æˆªå™¨A.onAcknowledgement()
```

**ğŸ’­ ä¸ºä»€ä¹ˆé€†åºæ‰§è¡Œï¼Ÿ**
å°±åƒç©¿è¡£æœä¸€æ ·ï¼Œå…ˆç©¿å†…è¡£å†ç©¿å¤–å¥—ï¼Œè„±çš„æ—¶å€™å…ˆè„±å¤–å¥—å†è„±å†…è¡£ã€‚è¿™æ ·ä¿è¯äº†å¤„ç†çš„å¯¹ç§°æ€§ã€‚

---

## 3. ğŸ› ï¸ è‡ªå®šä¹‰æ‹¦æˆªå™¨å¼€å‘å®æˆ˜


### 3.1 æ¶ˆæ¯æ—¶é—´æˆ³æ‹¦æˆªå™¨


**ğŸ’¡ éœ€æ±‚åœºæ™¯**
æˆ‘ä»¬éœ€è¦ç»™æ¯ä¸ªæ¶ˆæ¯è‡ªåŠ¨æ·»åŠ å‘é€æ—¶é—´æˆ³ï¼Œä¾¿äºåç»­åˆ†ææ¶ˆæ¯çš„æ—¶æ•ˆæ€§ã€‚

```java
/**
 * æ—¶é—´æˆ³æ‹¦æˆªå™¨ - ç»™æ¶ˆæ¯æ·»åŠ å‘é€æ—¶é—´
 * è¿™æ˜¯æœ€å¸¸è§çš„æ‹¦æˆªå™¨ç”¨é€”
 */
public class TimestampInterceptor implements ProducerInterceptor<String, String> {
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // åˆ›å»ºæ–°çš„Headersï¼Œæ·»åŠ æ—¶é—´æˆ³
        Headers headers = record.headers();
        headers.add("send_timestamp", 
                   String.valueOf(System.currentTimeMillis()).getBytes());
        
        // è¿”å›å¸¦æœ‰æ—¶é—´æˆ³çš„æ–°è®°å½•
        return new ProducerRecord<>(
            record.topic(),           // ä¿æŒåŸtopic
            record.partition(),       // ä¿æŒåŸåˆ†åŒº
            record.timestamp(),       // ä¿æŒåŸæ—¶é—´æˆ³
            record.key(),            // ä¿æŒåŸkey
            record.value(),          // ä¿æŒåŸvalue
            headers                  // ä½¿ç”¨æ–°çš„headers
        );
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // è¿™é‡Œå¯ä»¥è®°å½•å‘é€ç»“æœï¼Œä½†æ—¶é—´æˆ³æ‹¦æˆªå™¨é€šå¸¸ä¸éœ€è¦å¤„ç†
        if (exception != null) {
            System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥: " + exception.getMessage());
        }
    }
    
    @Override
    public void close() {
        // æ¸…ç†èµ„æºï¼Œè¿™ä¸ªæ‹¦æˆªå™¨æ²¡æœ‰éœ€è¦æ¸…ç†çš„èµ„æº
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        // æ¥æ”¶é…ç½®å‚æ•°ï¼Œè¿™ä¸ªæ‹¦æˆªå™¨ä¸éœ€è¦ç‰¹æ®Šé…ç½®
    }
}
```

### 3.2 æ¶ˆæ¯ç»Ÿè®¡æ‹¦æˆªå™¨


**ğŸ’¡ å®é™…ç”¨é€”**
ç›‘æ§Producerçš„å‘é€æƒ…å†µï¼Œç»Ÿè®¡æˆåŠŸç‡ã€å¤±è´¥ç‡ç­‰å…³é”®æŒ‡æ ‡ã€‚

```java
/**
 * ç»Ÿè®¡æ‹¦æˆªå™¨ - æ”¶é›†å‘é€ç»Ÿè®¡ä¿¡æ¯
 */
public class MetricsInterceptor implements ProducerInterceptor<String, String> {
    
    // ä½¿ç”¨åŸå­ç±»ä¿è¯çº¿ç¨‹å®‰å…¨
    private final AtomicLong successCount = new AtomicLong(0);
    private final AtomicLong errorCount = new AtomicLong(0);
    private final AtomicLong totalLatency = new AtomicLong(0);
    
    // è®°å½•æ¶ˆæ¯å‘é€å¼€å§‹æ—¶é—´
    private final ConcurrentHashMap<String, Long> sendTimeMap = new ConcurrentHashMap<>();
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // è®°å½•å‘é€å¼€å§‹æ—¶é—´ï¼Œç”¨äºè®¡ç®—å»¶è¿Ÿ
        String recordKey = record.topic() + "-" + record.partition() + "-" + record.key();
        sendTimeMap.put(recordKey, System.currentTimeMillis());
        
        return record; // ä¸ä¿®æ”¹æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        if (exception == null) {
            // å‘é€æˆåŠŸ
            successCount.incrementAndGet();
            
            // è®¡ç®—å»¶è¿Ÿ
            String recordKey = metadata.topic() + "-" + metadata.partition();
            Long sendTime = sendTimeMap.remove(recordKey);
            if (sendTime != null) {
                long latency = System.currentTimeMillis() - sendTime;
                totalLatency.addAndGet(latency);
            }
        } else {
            // å‘é€å¤±è´¥
            errorCount.incrementAndGet();
            System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥: " + exception.getMessage());
        }
    }
    
    @Override
    public void close() {
        // è¾“å‡ºæœ€ç»ˆç»Ÿè®¡ç»“æœ
        long total = successCount.get() + errorCount.get();
        if (total > 0) {
            System.out.println("=== Producerç»Ÿè®¡ä¿¡æ¯ ===");
            System.out.println("æ€»æ¶ˆæ¯æ•°: " + total);
            System.out.println("æˆåŠŸæ•°: " + successCount.get());
            System.out.println("å¤±è´¥æ•°: " + errorCount.get());
            System.out.println("æˆåŠŸç‡: " + (successCount.get() * 100.0 / total) + "%");
            
            if (successCount.get() > 0) {
                System.out.println("å¹³å‡å»¶è¿Ÿ: " + (totalLatency.get() / successCount.get()) + "ms");
            }
        }
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        // å¯ä»¥ä»é…ç½®ä¸­è¯»å–ç»Ÿè®¡ç›¸å…³å‚æ•°
    }
}
```

### 3.3 æ¶ˆæ¯è¿‡æ»¤æ‹¦æˆªå™¨


**ğŸ’¡ ä¸šåŠ¡åœºæ™¯**
æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨å‘é€å‰è¿‡æ»¤æ‰æŸäº›ä¸ç¬¦åˆè¦æ±‚çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚ç©ºæ¶ˆæ¯æˆ–åŒ…å«æ•æ„Ÿè¯çš„æ¶ˆæ¯ã€‚

```java
/**
 * è¿‡æ»¤æ‹¦æˆªå™¨ - è¿‡æ»¤ä¸åˆè§„æ¶ˆæ¯
 */
public class FilterInterceptor implements ProducerInterceptor<String, String> {
    
    private Set<String> sensitiveWords;
    
    @Override
    public void configure(Map<String, ?> configs) {
        // ä»é…ç½®ä¸­åŠ è½½æ•æ„Ÿè¯åˆ—è¡¨
        sensitiveWords = new HashSet<>();
        sensitiveWords.add("æ•æ„Ÿè¯1");
        sensitiveWords.add("æ•æ„Ÿè¯2");
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½ä»é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“åŠ è½½
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        String value = record.value();
        
        // è¿‡æ»¤ç©ºæ¶ˆæ¯
        if (value == null || value.trim().isEmpty()) {
            System.out.println("è¿‡æ»¤ç©ºæ¶ˆæ¯");
            return null; // è¿”å›nullè¡¨ç¤ºä¸å‘é€è¿™æ¡æ¶ˆæ¯
        }
        
        // è¿‡æ»¤åŒ…å«æ•æ„Ÿè¯çš„æ¶ˆæ¯
        for (String sensitiveWord : sensitiveWords) {
            if (value.contains(sensitiveWord)) {
                System.out.println("è¿‡æ»¤åŒ…å«æ•æ„Ÿè¯çš„æ¶ˆæ¯: " + sensitiveWord);
                return null;
            }
        }
        
        return record; // é€šè¿‡æ£€æŸ¥ï¼Œæ­£å¸¸å‘é€
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // è¿‡æ»¤æ‹¦æˆªå™¨é€šå¸¸ä¸éœ€è¦å¤„ç†ç¡®è®¤ç»“æœ
    }
    
    @Override
    public void close() {
        // æ¸…ç†èµ„æº
        if (sensitiveWords != null) {
            sensitiveWords.clear();
        }
    }
}
```

---

## 4. ğŸ”— æ‹¦æˆªå™¨é“¾è®¾è®¡æ¨¡å¼


### 4.1 æ‹¦æˆªå™¨é“¾çš„å·¥ä½œåŸç†


**ğŸ’¡ ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨é“¾ï¼Ÿ**
æ‹¦æˆªå™¨é“¾å°±æ˜¯æŠŠå¤šä¸ªæ‹¦æˆªå™¨ä¸²è”èµ·æ¥ï¼Œå°±åƒå·¥å‚çš„æµæ°´çº¿ä¸€æ ·ï¼Œæ¯ä¸ªæ‹¦æˆªå™¨è´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„å¤„ç†æ­¥éª¤ã€‚

```
åŸå§‹æ¶ˆæ¯ â†’ [æ—¶é—´æˆ³] â†’ [è¿‡æ»¤] â†’ [åŠ å¯†] â†’ [ç»Ÿè®¡] â†’ æœ€ç»ˆæ¶ˆæ¯
            æ‹¦æˆªå™¨1    æ‹¦æˆªå™¨2   æ‹¦æˆªå™¨3   æ‹¦æˆªå™¨4
```

### 4.2 é…ç½®æ‹¦æˆªå™¨é“¾


```java
// Produceré…ç½®
Properties props = new Properties();
props.put("bootstrap.servers", "localhost:9092");
props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");

// é…ç½®æ‹¦æˆªå™¨é“¾ - æ³¨æ„é¡ºåºå¾ˆé‡è¦ï¼
props.put("interceptor.classes", 
    "com.example.TimestampInterceptor," +     // å…ˆæ·»åŠ æ—¶é—´æˆ³
    "com.example.FilterInterceptor," +        // å†è¿‡æ»¤æ¶ˆæ¯
    "com.example.MetricsInterceptor"          // æœ€åç»Ÿè®¡
);

KafkaProducer<String, String> producer = new KafkaProducer<>(props);
```

### 4.3 æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº


**ğŸ“Š æ‰§è¡Œæµç¨‹å›¾**
```
å‘é€æ¶ˆæ¯
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          onSend()è°ƒç”¨é“¾              â”‚
â”‚                                    â”‚
â”‚  TimestampInterceptor.onSend()     â”‚ â† ç¬¬1ä¸ª
â”‚            â†“                       â”‚
â”‚  FilterInterceptor.onSend()        â”‚ â† ç¬¬2ä¸ª
â”‚            â†“                       â”‚
â”‚  MetricsInterceptor.onSend()       â”‚ â† ç¬¬3ä¸ª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åºåˆ—åŒ– + åˆ†åŒº + å‘é€
    â†“
æ”¶åˆ°å“åº”
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       onAcknowledgement()è°ƒç”¨é“¾      â”‚
â”‚                                    â”‚
â”‚  MetricsInterceptor.onAck()        â”‚ â† ç¬¬3ä¸ªï¼ˆé€†åºï¼‰
â”‚            â†“                       â”‚
â”‚  FilterInterceptor.onAck()         â”‚ â† ç¬¬2ä¸ª
â”‚            â†“                       â”‚
â”‚  TimestampInterceptor.onAck()      â”‚ â† ç¬¬1ä¸ª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ é‡è¦æé†’**
- `onSend()`æŒ‰é…ç½®é¡ºåºæ‰§è¡Œ
- `onAcknowledgement()`æŒ‰**é€†åº**æ‰§è¡Œ
- å¦‚æœæŸä¸ªæ‹¦æˆªå™¨çš„`onSend()`è¿”å›nullï¼Œåç»­æ‹¦æˆªå™¨ä¸ä¼šæ‰§è¡Œ

### 4.4 æ‹¦æˆªå™¨é“¾æœ€ä½³å®è·µ


**ğŸ”¸ æ‹¦æˆªå™¨æ’åºåŸåˆ™**

| é¡ºåº | æ‹¦æˆªå™¨ç±»å‹ | åŸå›  |
|------|-----------|------|
| 1 | æ¶ˆæ¯å¢å¼ºï¼ˆæ—¶é—´æˆ³ï¼‰ | å…ˆå®Œå–„æ¶ˆæ¯å†…å®¹ |
| 2 | æ¶ˆæ¯è¿‡æ»¤ | æ—©æœŸè¿‡æ»¤ï¼Œé¿å…æ— æ•ˆå¤„ç† |
| 3 | æ¶ˆæ¯è½¬æ¢/åŠ å¯† | åœ¨è¿‡æ»¤åè¿›è¡Œå¤æ‚å¤„ç† |
| 4 | ç»Ÿè®¡ç›‘æ§ | æœ€åç»Ÿè®¡æœ€ç»ˆè¦å‘é€çš„æ¶ˆæ¯ |

**ğŸ’¡ é…ç½®å»ºè®®**
```java
// âœ… æ¨èçš„é…ç½®é¡ºåº
"interceptor.classes" -> "TimestampInterceptor,FilterInterceptor,MetricsInterceptor"

// âŒ ä¸æ¨èçš„é¡ºåº - ç»Ÿè®¡ä¼šåŒ…å«è¢«è¿‡æ»¤çš„æ¶ˆæ¯
"interceptor.classes" -> "MetricsInterceptor,FilterInterceptor,TimestampInterceptor"
```

---

## 5. ğŸ“ æ¶ˆæ¯å¢å¼ºå’Œè¿‡æ»¤æœºåˆ¶


### 5.1 æ¶ˆæ¯å¢å¼ºæŠ€æœ¯


**ğŸ”¸ Headerså¢å¼º**
Headersæ˜¯Kafkaæ¶ˆæ¯çš„å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ å„ç§è¾…åŠ©ä¿¡æ¯è€Œä¸å½±å“æ¶ˆæ¯ä½“ã€‚

```java
/**
 * ç»¼åˆå¢å¼ºæ‹¦æˆªå™¨ - æ¼”ç¤ºå¤šç§å¢å¼ºæŠ€æœ¯
 */
public class EnhancementInterceptor implements ProducerInterceptor<String, String> {
    
    private String applicationId;
    private String version;
    
    @Override
    public void configure(Map<String, ?> configs) {
        // ä»é…ç½®ä¸­è¯»å–åº”ç”¨ä¿¡æ¯
        applicationId = (String) configs.getOrDefault("app.id", "unknown-app");
        version = (String) configs.getOrDefault("app.version", "1.0.0");
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        Headers headers = record.headers();
        
        // 1. æ·»åŠ æ—¶é—´æˆ³
        headers.add("send_time", String.valueOf(System.currentTimeMillis()).getBytes());
        
        // 2. æ·»åŠ åº”ç”¨æ ‡è¯†
        headers.add("app_id", applicationId.getBytes());
        headers.add("app_version", version.getBytes());
        
        // 3. æ·»åŠ æ¶ˆæ¯IDï¼ˆç”¨äºå»é‡å’Œè¿½è¸ªï¼‰
        String messageId = generateMessageId();
        headers.add("message_id", messageId.getBytes());
        
        // 4. æ·»åŠ æ¶ˆæ¯å¤§å°ä¿¡æ¯
        int messageSize = record.value() != null ? record.value().length() : 0;
        headers.add("message_size", String.valueOf(messageSize).getBytes());
        
        // 5. å¦‚æœkeyä¸ºç©ºï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª
        String key = record.key();
        if (key == null || key.isEmpty()) {
            key = "auto-" + System.currentTimeMillis();
        }
        
        return new ProducerRecord<>(
            record.topic(),
            record.partition(),
            record.timestamp(),
            key,                    // ä½¿ç”¨å¢å¼ºåçš„key
            record.value(),
            headers                 // ä½¿ç”¨å¢å¼ºåçš„headers
        );
    }
    
    private String generateMessageId() {
        return applicationId + "-" + System.nanoTime() + "-" + 
               Thread.currentThread().getId();
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // å¯ä»¥è®°å½•å¢å¼ºåçš„å‘é€ç»“æœ
    }
    
    @Override
    public void close() {}
}
```

### 5.2 æ¶ˆæ¯è¿‡æ»¤æœºåˆ¶


**ğŸ”¸ å¤šå±‚è¿‡æ»¤ç­–ç•¥**

```java
/**
 * æ™ºèƒ½è¿‡æ»¤æ‹¦æˆªå™¨ - æ¼”ç¤ºå¤šç§è¿‡æ»¤ç­–ç•¥
 */
public class SmartFilterInterceptor implements ProducerInterceptor<String, String> {
    
    private int maxMessageSize;
    private Pattern allowedTopicPattern;
    private Set<String> blacklistedKeys;
    
    @Override
    public void configure(Map<String, ?> configs) {
        // é…ç½®æœ€å¤§æ¶ˆæ¯å¤§å°ï¼ˆå­—èŠ‚ï¼‰
        maxMessageSize = (Integer) configs.getOrDefault("max.message.size", 1024 * 1024);
        
        // é…ç½®å…è®¸çš„topicæ¨¡å¼
        String topicPattern = (String) configs.getOrDefault("allowed.topic.pattern", ".*");
        allowedTopicPattern = Pattern.compile(topicPattern);
        
        // é…ç½®é»‘åå•key
        blacklistedKeys = new HashSet<>();
        String blacklist = (String) configs.getOrDefault("blacklisted.keys", "");
        if (!blacklist.isEmpty()) {
            Collections.addAll(blacklistedKeys, blacklist.split(","));
        }
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // 1. æ£€æŸ¥topicæ˜¯å¦å…è®¸
        if (!allowedTopicPattern.matcher(record.topic()).matches()) {
            System.out.println("è¿‡æ»¤ä¸å…è®¸çš„topic: " + record.topic());
            return null;
        }
        
        // 2. æ£€æŸ¥keyæ˜¯å¦åœ¨é»‘åå•ä¸­
        if (record.key() != null && blacklistedKeys.contains(record.key())) {
            System.out.println("è¿‡æ»¤é»‘åå•key: " + record.key());
            return null;
        }
        
        // 3. æ£€æŸ¥æ¶ˆæ¯å¤§å°
        String value = record.value();
        if (value != null && value.getBytes().length > maxMessageSize) {
            System.out.println("è¿‡æ»¤è¶…å¤§æ¶ˆæ¯ï¼Œå¤§å°: " + value.getBytes().length);
            return null;
        }
        
        // 4. æ£€æŸ¥æ¶ˆæ¯å†…å®¹æ ¼å¼ï¼ˆä¾‹å¦‚å¿…é¡»æ˜¯JSONï¼‰
        if (value != null && !isValidJson(value)) {
            System.out.println("è¿‡æ»¤éJSONæ ¼å¼æ¶ˆæ¯");
            return null;
        }
        
        return record; // é€šè¿‡æ‰€æœ‰æ£€æŸ¥
    }
    
    private boolean isValidJson(String value) {
        try {
            // ç®€å•çš„JSONæ ¼å¼æ£€æŸ¥
            return value.trim().startsWith("{") && value.trim().endsWith("}") ||
                   value.trim().startsWith("[") && value.trim().endsWith("]");
        } catch (Exception e) {
            return false;
        }
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {}
    
    @Override
    public void close() {}
}
```

### 5.3 åŠ¨æ€è¿‡æ»¤è§„åˆ™


**ğŸ’¡ å®é™…éœ€æ±‚**
åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿‡æ»¤è§„åˆ™å¯èƒ½éœ€è¦åŠ¨æ€è°ƒæ•´ï¼Œè€Œä¸æ˜¯é‡å¯åº”ç”¨ã€‚

```java
/**
 * åŠ¨æ€è§„åˆ™è¿‡æ»¤æ‹¦æˆªå™¨
 */
public class DynamicRuleFilterInterceptor implements ProducerInterceptor<String, String> {
    
    // ä½¿ç”¨volatileä¿è¯å¯è§æ€§
    private volatile Set<String> dynamicBlacklist = new ConcurrentHashMap<String, Boolean>().keySet(ConcurrentHashMap.newKeySet());
    private volatile boolean enableFilter = true;
    
    // æ¨¡æ‹Ÿä»å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚Redisã€é…ç½®ä¸­å¿ƒï¼‰è·å–è§„åˆ™
    private final ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
    
    @Override
    public void configure(Map<String, ?> configs) {
        // å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ›´æ–°è¿‡æ»¤è§„åˆ™
        scheduler.scheduleAtFixedRate(this::updateFilterRules, 0, 30, TimeUnit.SECONDS);
    }
    
    private void updateFilterRules() {
        try {
            // æ¨¡æ‹Ÿä»å¤–éƒ¨ç³»ç»Ÿè·å–æœ€æ–°çš„è¿‡æ»¤è§„åˆ™
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè¿æ¥Redisã€æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒ
            Set<String> newBlacklist = loadBlacklistFromExternalSystem();
            dynamicBlacklist.clear();
            dynamicBlacklist.addAll(newBlacklist);
            
            System.out.println("æ›´æ–°è¿‡æ»¤è§„åˆ™ï¼Œé»‘åå•å¤§å°: " + dynamicBlacklist.size());
        } catch (Exception e) {
            System.err.println("æ›´æ–°è¿‡æ»¤è§„åˆ™å¤±è´¥: " + e.getMessage());
        }
    }
    
    private Set<String> loadBlacklistFromExternalSystem() {
        // æ¨¡æ‹Ÿå¤–éƒ¨ç³»ç»Ÿè°ƒç”¨
        Set<String> blacklist = new HashSet<>();
        blacklist.add("spam-key-1");
        blacklist.add("spam-key-2");
        return blacklist;
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        if (!enableFilter) {
            return record; // è¿‡æ»¤åŠŸèƒ½è¢«ç¦ç”¨
        }
        
        // ä½¿ç”¨åŠ¨æ€æ›´æ–°çš„é»‘åå•
        if (record.key() != null && dynamicBlacklist.contains(record.key())) {
            System.out.println("åŠ¨æ€è¿‡æ»¤é»‘åå•key: " + record.key());
            return null;
        }
        
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {}
    
    @Override
    public void close() {
        scheduler.shutdown();
        try {
            if (!scheduler.awaitTermination(5, TimeUnit.SECONDS)) {
                scheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            scheduler.shutdownNow();
        }
    }
}
```

---

## 6. ğŸ“Š ç›‘æ§æ•°æ®æ”¶é›†å®è·µ


### 6.1 å…¨é¢çš„ç›‘æ§æ‹¦æˆªå™¨


ç›‘æ§æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æ‹¦æˆªå™¨çš„é‡è¦åº”ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†å„ç§ç»´åº¦çš„æ•°æ®ã€‚

```java
/**
 * å…¨é¢ç›‘æ§æ‹¦æˆªå™¨ - æ”¶é›†è¯¦ç»†çš„å‘é€æŒ‡æ ‡
 */
public class ComprehensiveMonitorInterceptor implements ProducerInterceptor<String, String> {
    
    // è®¡æ•°å™¨ - ä½¿ç”¨AtomicLongä¿è¯çº¿ç¨‹å®‰å…¨
    private final AtomicLong totalMessages = new AtomicLong(0);
    private final AtomicLong successMessages = new AtomicLong(0);
    private final AtomicLong failedMessages = new AtomicLong(0);
    
    // å»¶è¿Ÿç»Ÿè®¡
    private final AtomicLong totalLatency = new AtomicLong(0);
    private final AtomicLong maxLatency = new AtomicLong(0);
    private final AtomicLong minLatency = new AtomicLong(Long.MAX_VALUE);
    
    // æŒ‰topicç»Ÿè®¡
    private final ConcurrentHashMap<String, AtomicLong> topicCounters = new ConcurrentHashMap<>();
    
    // æŒ‰å°æ—¶ç»Ÿè®¡
    private final ConcurrentHashMap<String, AtomicLong> hourlyCounters = new ConcurrentHashMap<>();
    
    // é”™è¯¯ç»Ÿè®¡
    private final ConcurrentHashMap<String, AtomicLong> errorCounters = new ConcurrentHashMap<>();
    
    // æ¶ˆæ¯å¤§å°ç»Ÿè®¡
    private final AtomicLong totalMessageSize = new AtomicLong(0);
    
    // è®°å½•å‘é€æ—¶é—´
    private final ConcurrentHashMap<String, Long> sendTimeMap = new ConcurrentHashMap<>();
    
    // å®šæ—¶æŠ¥å‘Š
    private final ScheduledExecutorService reportScheduler = Executors.newSingleThreadScheduledExecutor();
    
    @Override
    public void configure(Map<String, ?> configs) {
        // å¯åŠ¨å®šæ—¶æŠ¥å‘Šï¼ˆæ¯åˆ†é’Ÿä¸€æ¬¡ï¼‰
        reportScheduler.scheduleAtFixedRate(this::printReport, 60, 60, TimeUnit.SECONDS);
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        totalMessages.incrementAndGet();
        
        // è®°å½•å‘é€æ—¶é—´
        String recordId = generateRecordId(record);
        sendTimeMap.put(recordId, System.currentTimeMillis());
        
        // æŒ‰topicç»Ÿè®¡
        topicCounters.computeIfAbsent(record.topic(), k -> new AtomicLong(0)).incrementAndGet();
        
        // æŒ‰å°æ—¶ç»Ÿè®¡
        String hour = getCurrentHour();
        hourlyCounters.computeIfAbsent(hour, k -> new AtomicLong(0)).incrementAndGet();
        
        // æ¶ˆæ¯å¤§å°ç»Ÿè®¡
        if (record.value() != null) {
            totalMessageSize.addAndGet(record.value().getBytes().length);
        }
        
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        String recordId = generateRecordId(metadata);
        Long sendTime = sendTimeMap.remove(recordId);
        
        if (exception == null) {
            // æˆåŠŸå‘é€
            successMessages.incrementAndGet();
            
            // è®¡ç®—å»¶è¿Ÿ
            if (sendTime != null) {
                long latency = System.currentTimeMillis() - sendTime;
                totalLatency.addAndGet(latency);
                
                // æ›´æ–°æœ€å¤§æœ€å°å»¶è¿Ÿ
                updateMaxLatency(latency);
                updateMinLatency(latency);
            }
        } else {
            // å‘é€å¤±è´¥
            failedMessages.incrementAndGet();
            
            // é”™è¯¯ç»Ÿè®¡
            String errorType = exception.getClass().getSimpleName();
            errorCounters.computeIfAbsent(errorType, k -> new AtomicLong(0)).incrementAndGet();
        }
    }
    
    private void updateMaxLatency(long latency) {
        long currentMax = maxLatency.get();
        while (latency > currentMax && !maxLatency.compareAndSet(currentMax, latency)) {
            currentMax = maxLatency.get();
        }
    }
    
    private void updateMinLatency(long latency) {
        long currentMin = minLatency.get();
        while (latency < currentMin && !minLatency.compareAndSet(currentMin, latency)) {
            currentMin = minLatency.get();
        }
    }
    
    private String generateRecordId(ProducerRecord<String, String> record) {
        return record.topic() + "-" + record.partition() + "-" + record.key() + "-" + System.nanoTime();
    }
    
    private String generateRecordId(RecordMetadata metadata) {
        return metadata.topic() + "-" + metadata.partition() + "-" + metadata.offset();
    }
    
    private String getCurrentHour() {
        return new SimpleDateFormat("yyyy-MM-dd-HH").format(new Date());
    }
    
    private void printReport() {
        long total = totalMessages.get();
        if (total == 0) return;
        
        long success = successMessages.get();
        long failed = failedMessages.get();
        
        System.out.println("\n=== Kafka Producerç›‘æ§æŠ¥å‘Š ===");
        System.out.println("æŠ¥å‘Šæ—¶é—´: " + new Date());
        System.out.println("æ€»æ¶ˆæ¯æ•°: " + total);
        System.out.println("æˆåŠŸæ•°: " + success);
        System.out.println("å¤±è´¥æ•°: " + failed);
        System.out.println("æˆåŠŸç‡: " + String.format("%.2f%%", success * 100.0 / total));
        
        // å»¶è¿Ÿç»Ÿè®¡
        if (success > 0) {
            System.out.println("å¹³å‡å»¶è¿Ÿ: " + (totalLatency.get() / success) + "ms");
            System.out.println("æœ€å¤§å»¶è¿Ÿ: " + maxLatency.get() + "ms");
            
            long min = minLatency.get();
            System.out.println("æœ€å°å»¶è¿Ÿ: " + (min == Long.MAX_VALUE ? 0 : min) + "ms");
        }
        
        // å¹³å‡æ¶ˆæ¯å¤§å°
        if (total > 0) {
            System.out.println("å¹³å‡æ¶ˆæ¯å¤§å°: " + (totalMessageSize.get() / total) + " bytes");
        }
        
        // Topicç»Ÿè®¡
        if (!topicCounters.isEmpty()) {
            System.out.println("\nTopicç»Ÿè®¡:");
            topicCounters.forEach((topic, count) -> 
                System.out.println("  " + topic + ": " + count.get() + " æ¡"));
        }
        
        // é”™è¯¯ç»Ÿè®¡
        if (!errorCounters.isEmpty()) {
            System.out.println("\né”™è¯¯ç»Ÿè®¡:");
            errorCounters.forEach((error, count) -> 
                System.out.println("  " + error + ": " + count.get() + " æ¬¡"));
        }
        
        System.out.println("================================\n");
    }
    
    @Override
    public void close() {
        // æ‰“å°æœ€ç»ˆæŠ¥å‘Š
        printReport();
        
        // å…³é—­å®šæ—¶å™¨
        reportScheduler.shutdown();
        try {
            if (!reportScheduler.awaitTermination(5, TimeUnit.SECONDS)) {
                reportScheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            reportScheduler.shutdownNow();
        }
    }
}
```

### 6.2 ç›‘æ§æ•°æ®è¾“å‡ºåˆ°å¤–éƒ¨ç³»ç»Ÿ


åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œç›‘æ§æ•°æ®é€šå¸¸éœ€è¦è¾“å‡ºåˆ°ä¸“é—¨çš„ç›‘æ§ç³»ç»Ÿï¼Œå¦‚Prometheusã€InfluxDBç­‰ã€‚

```java
/**
 * å¤–éƒ¨ç›‘æ§é›†æˆæ‹¦æˆªå™¨
 */
public class ExternalMonitoringInterceptor implements ProducerInterceptor<String, String> {
    
    // æ¨¡æ‹ŸPrometheuså®¢æˆ·ç«¯
    private Counter totalCounter;
    private Counter successCounter;
    private Counter errorCounter;
    private Histogram latencyHistogram;
    
    @Override
    public void configure(Map<String, ?> configs) {
        // åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡ï¼ˆæ¨¡æ‹ŸPrometheusæŒ‡æ ‡ï¼‰
        initializeMetrics();
    }
    
    private void initializeMetrics() {
        // è¿™é‡Œæ˜¯æ¨¡æ‹Ÿä»£ç ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦çœŸæ­£çš„Prometheuså®¢æˆ·ç«¯
        System.out.println("åˆå§‹åŒ–PrometheusæŒ‡æ ‡...");
        
        // å®é™…ä»£ç ç¤ºä¾‹ï¼š
        // totalCounter = Counter.build()
        //     .name("kafka_producer_messages_total")
        //     .help("Total number of messages sent")
        //     .register();
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // å¢åŠ æ€»æ•°è®¡æ•°å™¨
        // totalCounter.inc();
        
        System.out.println("è®°å½•æ¶ˆæ¯å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ: " + record.topic());
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        if (exception == null) {
            // å¢åŠ æˆåŠŸè®¡æ•°å™¨
            // successCounter.inc();
            System.out.println("è®°å½•æˆåŠŸå‘é€åˆ°ç›‘æ§ç³»ç»Ÿ");
        } else {
            // å¢åŠ é”™è¯¯è®¡æ•°å™¨
            // errorCounter.labels(exception.getClass().getSimpleName()).inc();
            System.out.println("è®°å½•å‘é€é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ: " + exception.getClass().getSimpleName());
        }
    }
    
    @Override
    public void close() {
        System.out.println("æ¸…ç†ç›‘æ§èµ„æº...");
    }
}
```

---

## 7. ğŸ”Œ æ’ä»¶åŒ–æ‰©å±•æœºåˆ¶


### 7.1 æ‹¦æˆªå™¨å·¥å‚æ¨¡å¼


**ğŸ’¡ è®¾è®¡æ€è·¯**
å½“é¡¹ç›®ä¸­éœ€è¦å¤šç§ä¸åŒçš„æ‹¦æˆªå™¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å·¥å‚æ¨¡å¼æ¥ç»Ÿä¸€ç®¡ç†æ‹¦æˆªå™¨çš„åˆ›å»ºã€‚

```java
/**
 * æ‹¦æˆªå™¨å·¥å‚ - ç»Ÿä¸€ç®¡ç†æ‹¦æˆªå™¨åˆ›å»º
 */
public class InterceptorFactory {
    
    public enum InterceptorType {
        TIMESTAMP,      // æ—¶é—´æˆ³æ‹¦æˆªå™¨
        FILTER,         // è¿‡æ»¤æ‹¦æˆªå™¨
        METRICS,        // ç»Ÿè®¡æ‹¦æˆªå™¨
        MONITOR,        // ç›‘æ§æ‹¦æˆªå™¨
        SECURITY        // å®‰å…¨æ‹¦æˆªå™¨
    }
    
    /**
     * åˆ›å»ºæ‹¦æˆªå™¨å®ä¾‹
     */
    public static ProducerInterceptor<String, String> createInterceptor(
            InterceptorType type, Map<String, Object> config) {
        
        switch (type) {
            case TIMESTAMP:
                return new TimestampInterceptor();
                
            case FILTER:
                return new SmartFilterInterceptor();
                
            case METRICS:
                return new MetricsInterceptor();
                
            case MONITOR:
                return new ComprehensiveMonitorInterceptor();
                
            case SECURITY:
                return new SecurityInterceptor(config);
                
            default:
                throw new IllegalArgumentException("æœªçŸ¥çš„æ‹¦æˆªå™¨ç±»å‹: " + type);
        }
    }
    
    /**
     * æ‰¹é‡åˆ›å»ºæ‹¦æˆªå™¨é“¾
     */
    public static String createInterceptorChain(InterceptorType... types) {
        return Arrays.stream(types)
                .map(type -> getInterceptorClassName(type))
                .collect(Collectors.joining(","));
    }
    
    private static String getInterceptorClassName(InterceptorType type) {
        switch (type) {
            case TIMESTAMP: return "com.example.TimestampInterceptor";
            case FILTER: return "com.example.SmartFilterInterceptor";
            case METRICS: return "com.example.MetricsInterceptor";
            case MONITOR: return "com.example.ComprehensiveMonitorInterceptor";
            case SECURITY: return "com.example.SecurityInterceptor";
            default: throw new IllegalArgumentException("æœªçŸ¥ç±»å‹: " + type);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class ProducerConfig {
    public static Properties createProducerConfig() {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // ä½¿ç”¨å·¥å‚åˆ›å»ºæ‹¦æˆªå™¨é“¾
        String interceptorChain = InterceptorFactory.createInterceptorChain(
            InterceptorFactory.InterceptorType.TIMESTAMP,
            InterceptorFactory.InterceptorType.FILTER,
            InterceptorFactory.InterceptorType.METRICS
        );
        props.put("interceptor.classes", interceptorChain);
        
        return props;
    }
}
```

### 7.2 å¯é…ç½®çš„æ’ä»¶ç³»ç»Ÿ


**ğŸ’¡ å®é™…éœ€æ±‚**
åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œä¸åŒç¯å¢ƒå¯èƒ½éœ€è¦ä¸åŒçš„æ‹¦æˆªå™¨ç»„åˆï¼Œæˆ‘ä»¬å¸Œæœ›é€šè¿‡é…ç½®æ–‡ä»¶æ¥åŠ¨æ€ç»„è£…æ‹¦æˆªå™¨é“¾ã€‚

```java
/**
 * å¯é…ç½®çš„æ‹¦æˆªå™¨ç®¡ç†å™¨
 */
public class ConfigurableInterceptorManager {
    
    /**
     * æ‹¦æˆªå™¨é…ç½®ç±»
     */
    public static class InterceptorConfig {
        private String className;
        private boolean enabled;
        private int order;
        private Map<String, Object> properties;
        
        // æ„é€ æ–¹æ³•å’Œgetter/setterçœç•¥
        public InterceptorConfig(String className, boolean enabled, int order, Map<String, Object> properties) {
            this.className = className;
            this.enabled = enabled;
            this.order = order;
            this.properties = properties != null ? properties : new HashMap<>();
        }
        
        // getters
        public String getClassName() { return className; }
        public boolean isEnabled() { return enabled; }
        public int getOrder() { return order; }
        public Map<String, Object> getProperties() { return properties; }
    }
    
    /**
     * ä»é…ç½®æ–‡ä»¶åŠ è½½æ‹¦æˆªå™¨é…ç½®
     */
    public static List<InterceptorConfig> loadFromConfig(String configFile) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½ä»JSONã€YAMLæˆ–Propertiesæ–‡ä»¶åŠ è½½
        List<InterceptorConfig> configs = new ArrayList<>();
        
        // æ¨¡æ‹Ÿé…ç½®åŠ è½½
        configs.add(new InterceptorConfig(
            "com.example.TimestampInterceptor", 
            true, 
            1, 
            Map.of("add_hostname", true)
        ));
        
        configs.add(new InterceptorConfig(
            "com.example.FilterInterceptor", 
            true, 
            2, 
            Map.of("max_size", 1024000, "allowed_topics", "order.*,user.*")
        ));
        
        configs.add(new InterceptorConfig(
            "com.example.MetricsInterceptor", 
            true, 
            3, 
            Map.of("report_interval", 60)
        ));
        
        return configs;
    }
    
    /**
     * æ ¹æ®é…ç½®åˆ›å»ºæ‹¦æˆªå™¨é“¾å­—ç¬¦ä¸²
     */
    public static String buildInterceptorChain(List<InterceptorConfig> configs) {
        return configs.stream()
                .filter(InterceptorConfig::isEnabled)  // åªåŒ…å«å¯ç”¨çš„æ‹¦æˆªå™¨
                .sorted(Comparator.comparing(InterceptorConfig::getOrder))  // æŒ‰orderæ’åº
                .map(InterceptorConfig::getClassName)
                .collect(Collectors.joining(","));
    }
    
    /**
     * åˆ›å»ºProduceré…ç½®ï¼ŒåŒ…å«åŠ¨æ€æ‹¦æˆªå™¨é“¾
     */
    public static Properties createProducerProperties(String configFile) {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // åŠ è½½æ‹¦æˆªå™¨é…ç½®
        List<InterceptorConfig> interceptorConfigs = loadFromConfig(configFile);
        String interceptorChain = buildInterceptorChain(interceptorConfigs);
        
        if (!interceptorChain.isEmpty()) {
            props.put("interceptor.classes", interceptorChain);
            
            // å°†æ‹¦æˆªå™¨çš„é…ç½®å‚æ•°ä¹Ÿä¼ é€’ç»™Producer
            for (InterceptorConfig config : interceptorConfigs) {
                if (config.isEnabled()) {
                    config.getProperties().forEach((key, value) -> 
                        props.put("interceptor." + key, value));
                }
            }
        }
        
        return props;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class ConfigurableProducerExample {
    public static void main(String[] args) {
        // ä»é…ç½®æ–‡ä»¶åˆ›å»ºProducer
        Properties props = ConfigurableInterceptorManager.createProducerProperties("interceptor-config.json");
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        
        // å‘é€æ¶ˆæ¯
        producer.send(new ProducerRecord<>("test-topic", "key1", "Hello World"));
        
        producer.close();
    }
}
```

### 7.3 çƒ­æ’æ‹”æ‹¦æˆªå™¨æœºåˆ¶


**ğŸ’¡ é«˜çº§ç‰¹æ€§**
åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æˆ–ç§»é™¤æ‹¦æˆªå™¨ï¼Œè€Œä¸éœ€è¦é‡å¯Producerã€‚

```java
/**
 * åŠ¨æ€æ‹¦æˆªå™¨ä»£ç† - æ”¯æŒçƒ­æ’æ‹”
 */
public class DynamicInterceptorProxy implements ProducerInterceptor<String, String> {
    
    // ä½¿ç”¨CopyOnWriteArrayListä¿è¯çº¿ç¨‹å®‰å…¨çš„åŒæ—¶æ”¯æŒå¹¶å‘è¯»å–
    private final CopyOnWriteArrayList<ProducerInterceptor<String, String>> interceptors;
    private final AtomicBoolean closed = new AtomicBoolean(false);
    
    public DynamicInterceptorProxy() {
        this.interceptors = new CopyOnWriteArrayList<>();
    }
    
    /**
     * åŠ¨æ€æ·»åŠ æ‹¦æˆªå™¨
     */
    public void addInterceptor(ProducerInterceptor<String, String> interceptor) {
        if (!closed.get()) {
            interceptors.add(interceptor);
            System.out.println("åŠ¨æ€æ·»åŠ æ‹¦æˆªå™¨: " + interceptor.getClass().getSimpleName());
        }
    }
    
    /**
     * åŠ¨æ€ç§»é™¤æ‹¦æˆªå™¨
     */
    public boolean removeInterceptor(Class<?> interceptorClass) {
        if (closed.get()) return false;
        
        boolean removed = interceptors.removeIf(interceptor -> 
            interceptor.getClass().equals(interceptorClass));
        
        if (removed) {
            System.out.println("åŠ¨æ€ç§»é™¤æ‹¦æˆªå™¨: " + interceptorClass.getSimpleName());
        }
        return removed;
    }
    
    /**
     * è·å–å½“å‰æ‹¦æˆªå™¨åˆ—è¡¨
     */
    public List<String> getCurrentInterceptors() {
        return interceptors.stream()
                .map(interceptor -> interceptor.getClass().getSimpleName())
                .collect(Collectors.toList());
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        if (closed.get()) return record;
        
        ProducerRecord<String, String> currentRecord = record;
        
        // æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„onSendæ–¹æ³•
        for (ProducerInterceptor<String, String> interceptor : interceptors) {
            if (currentRecord == null) {
                break; // å¦‚æœæŸä¸ªæ‹¦æˆªå™¨è¿”å›nullï¼Œåœæ­¢åç»­å¤„ç†
            }
            
            try {
                currentRecord = interceptor.onSend(currentRecord);
            } catch (Exception e) {
                System.err.println("æ‹¦æˆªå™¨æ‰§è¡Œå¼‚å¸¸: " + interceptor.getClass().getSimpleName() + 
                                 ", " + e.getMessage());
                // ç»§ç»­æ‰§è¡Œå…¶ä»–æ‹¦æˆªå™¨ï¼Œä¸å› ä¸€ä¸ªæ‹¦æˆªå™¨å¼‚å¸¸è€Œä¸­æ–­æ•´ä¸ªé“¾
            }
        }
        
        return currentRecord;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        if (closed.get()) return;
        
        // æŒ‰é€†åºæ‰§è¡Œæ‰€æœ‰æ‹¦æˆªå™¨çš„onAcknowledgementæ–¹æ³•
        List<ProducerInterceptor<String, String>> reversedList = new ArrayList<>(interceptors);
        Collections.reverse(reversedList);
        
        for (ProducerInterceptor<String, String> interceptor : reversedList) {
            try {
                interceptor.onAcknowledgement(metadata, exception);
            } catch (Exception e) {
                System.err.println("æ‹¦æˆªå™¨ç¡®è®¤å¤„ç†å¼‚å¸¸: " + interceptor.getClass().getSimpleName() + 
                                 ", " + e.getMessage());
            }
        }
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        // å°†é…ç½®ä¼ é€’ç»™æ‰€æœ‰å·²æ·»åŠ çš„æ‹¦æˆªå™¨
        for (ProducerInterceptor<String, String> interceptor : interceptors) {
            try {
                interceptor.configure(configs);
            } catch (Exception e) {
                System.err.println("æ‹¦æˆªå™¨é…ç½®å¼‚å¸¸: " + interceptor.getClass().getSimpleName() + 
                                 ", " + e.getMessage());
            }
        }
    }
    
    @Override
    public void close() {
        if (closed.compareAndSet(false, true)) {
            // å…³é—­æ‰€æœ‰æ‹¦æˆªå™¨
            for (ProducerInterceptor<String, String> interceptor : interceptors) {
                try {
                    interceptor.close();
                } catch (Exception e) {
                    System.err.println("æ‹¦æˆªå™¨å…³é—­å¼‚å¸¸: " + interceptor.getClass().getSimpleName() + 
                                     ", " + e.getMessage());
                }
            }
            interceptors.clear();
            System.out.println("åŠ¨æ€æ‹¦æˆªå™¨ä»£ç†å·²å…³é—­");
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class HotSwapExample {
    public static void main(String[] args) throws InterruptedException {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // ä½¿ç”¨åŠ¨æ€ä»£ç†ä½œä¸ºå”¯ä¸€çš„æ‹¦æˆªå™¨
        props.put("interceptor.classes", "com.example.DynamicInterceptorProxy");
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        
        // è·å–ä»£ç†å®ä¾‹ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦æ›´ä¼˜é›…çš„æ–¹å¼ï¼‰
        DynamicInterceptorProxy proxy = new DynamicInterceptorProxy();
        
        // åˆå§‹æ·»åŠ ä¸€äº›æ‹¦æˆªå™¨
        proxy.addInterceptor(new TimestampInterceptor());
        proxy.addInterceptor(new MetricsInterceptor());
        
        // å‘é€ä¸€äº›æ¶ˆæ¯
        for (int i = 0; i < 5; i++) {
            producer.send(new ProducerRecord<>("test", "key" + i, "message" + i));
        }
        
        // è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æ–°çš„æ‹¦æˆªå™¨
        Thread.sleep(1000);
        proxy.addInterceptor(new FilterInterceptor());
        System.out.println("å½“å‰æ‹¦æˆªå™¨: " + proxy.getCurrentInterceptors());
        
        // ç»§ç»­å‘é€æ¶ˆæ¯
        for (int i = 5; i < 10; i++) {
            producer.send(new ProducerRecord<>("test", "key" + i, "message" + i));
        }
        
        // è¿è¡Œæ—¶ç§»é™¤æ‹¦æˆªå™¨
        Thread.sleep(1000);
        proxy.removeInterceptor(FilterInterceptor.class);
        System.out.println("ç§»é™¤è¿‡æ»¤å™¨åçš„æ‹¦æˆªå™¨: " + proxy.getCurrentInterceptors());
        
        producer.close();
    }
}
```

---

## 8. âš¡ æ€§èƒ½å½±å“åˆ†æä¸æœ€ä½³å®è·µ


### 8.1 æ€§èƒ½å½±å“å› ç´ åˆ†æ


**ğŸ”¸ æ‹¦æˆªå™¨æ€§èƒ½å¼€é”€æ¥æº**

| å½±å“å› ç´  | æ€§èƒ½å½±å“ | è¯´æ˜ |
|---------|---------|------|
| **æ‹¦æˆªå™¨æ•°é‡** | ğŸ”´ é«˜ | æ¯å¢åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œæ¶ˆæ¯å¤„ç†æ—¶é—´çº¿æ€§å¢åŠ  |
| **æ‹¦æˆªå™¨å¤æ‚åº¦** | ğŸ”´ é«˜ | å¤æ‚çš„å¤„ç†é€»è¾‘ç›´æ¥å½±å“ååé‡ |
| **å¯¹è±¡åˆ›å»º** | ğŸŸ¡ ä¸­ | é¢‘ç¹åˆ›å»ºæ–°çš„ProducerRecordå¯¹è±¡ |
| **é”ç«äº‰** | ğŸŸ¡ ä¸­ | å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„åŒæ­¥å¼€é”€ |
| **I/Oæ“ä½œ** | ğŸ”´ é«˜ | æ—¥å¿—å†™å…¥ã€å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ç­‰ |
| **å†…å­˜ä½¿ç”¨** | ğŸŸ¢ ä½ | ä¸»è¦æ˜¯ä¸´æ—¶å¯¹è±¡çš„åˆ›å»º |

**ğŸ“Š æ€§èƒ½æµ‹è¯•æ•°æ®**
```
æµ‹è¯•åœºæ™¯ï¼šå‘é€10ä¸‡æ¡æ¶ˆæ¯ï¼Œæ¶ˆæ¯å¤§å°1KB

æ— æ‹¦æˆªå™¨ï¼š     å¹³å‡å»¶è¿Ÿ 2msï¼Œååé‡ 50,000 msg/s
1ä¸ªæ‹¦æˆªå™¨ï¼š    å¹³å‡å»¶è¿Ÿ 2.5msï¼Œååé‡ 45,000 msg/s  â†“10%
3ä¸ªæ‹¦æˆªå™¨ï¼š    å¹³å‡å»¶è¿Ÿ 3.2msï¼Œååé‡ 38,000 msg/s  â†“24%
5ä¸ªæ‹¦æˆªå™¨ï¼š    å¹³å‡å»¶è¿Ÿ 4.1msï¼Œååé‡ 32,000 msg/s  â†“36%

ç»“è®ºï¼šæ¯ä¸ªæ‹¦æˆªå™¨å¤§çº¦å¢åŠ  0.5ms å»¶è¿Ÿï¼Œé™ä½ 5-8% ååé‡
```

### 8.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ å‡å°‘å¯¹è±¡åˆ›å»º**
```java
/**
 * ä¼˜åŒ–çš„æ‹¦æˆªå™¨ - å‡å°‘å¯¹è±¡åˆ›å»º
 */
public class OptimizedInterceptor implements ProducerInterceptor<String, String> {
    
    // é‡ç”¨Headerå¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»º
    private final String timestampKey = "send_time";
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // âœ… åªåœ¨éœ€è¦æ—¶æ‰åˆ›å»ºæ–°çš„Record
        if (needsTimestamp(record)) {
            Headers headers = record.headers();
            headers.add(timestampKey, String.valueOf(System.currentTimeMillis()).getBytes());
            // ç›´æ¥ä¿®æ”¹åŸæœ‰Headersï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çš„Record
        }
        
        return record;
    }
    
    private boolean needsTimestamp(ProducerRecord<String, String> record) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ—¶é—´æˆ³ï¼Œé¿å…é‡å¤å¤„ç†
        return record.headers().headers(timestampKey).iterator().hasNext() == false;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // âœ… ç®€åŒ–å¤„ç†é€»è¾‘
        if (exception != null) {
            // åªè®°å½•é”™è¯¯ï¼Œé¿å…å¤æ‚çš„ç»Ÿè®¡è®¡ç®—
            System.err.println("å‘é€å¤±è´¥: " + exception.getMessage());
        }
    }
    
    @Override
    public void configure(Map<String, ?> configs) {}
    
    @Override
    public void close() {}
}
```

**ğŸ”¸ æ‰¹é‡å¤„ç†ä¼˜åŒ–**
```java
/**
 * æ‰¹é‡å¤„ç†æ‹¦æˆªå™¨ - æé«˜æ•ˆç‡
 */
public class BatchProcessingInterceptor implements ProducerInterceptor<String, String> {
    
    private final AtomicLong messageCount = new AtomicLong(0);
    private final AtomicLong lastReportTime = new AtomicLong(System.currentTimeMillis());
    private final long reportInterval = 10000; // 10ç§’æŠ¥å‘Šä¸€æ¬¡
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        long count = messageCount.incrementAndGet();
        
        // âœ… æ‰¹é‡æŠ¥å‘Šï¼Œè€Œä¸æ˜¯æ¯æ¡æ¶ˆæ¯éƒ½å¤„ç†
        if (count % 1000 == 0) { // æ¯1000æ¡æ¶ˆæ¯æ£€æŸ¥ä¸€æ¬¡
            long currentTime = System.currentTimeMillis();
            long lastReport = lastReportTime.get();
            
            if (currentTime - lastReport > reportInterval) {
                if (lastReportTime.compareAndSet(lastReport, currentTime)) {
                    System.out.println("å·²å‘é€ " + count + " æ¡æ¶ˆæ¯");
                }
            }
        }
        
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // âœ… æœ€å°åŒ–å¤„ç†é€»è¾‘
    }
    
    @Override
    public void configure(Map<String, ?> configs) {}
    
    @Override
    public void close() {
        System.out.println("æœ€ç»ˆå‘é€æ¶ˆæ¯æ€»æ•°: " + messageCount.get());
    }
}
```

**ğŸ”¸ å¼‚æ­¥å¤„ç†ä¼˜åŒ–**
```java
/**
 * å¼‚æ­¥å¤„ç†æ‹¦æˆªå™¨ - é¿å…é˜»å¡ä¸»æµç¨‹
 */
public class AsyncProcessingInterceptor implements ProducerInterceptor<String, String> {
    
    private final ExecutorService asyncExecutor = Executors.newSingleThreadExecutor(r -> {
        Thread t = new Thread(r, "AsyncInterceptor-Thread");
        t.setDaemon(true); // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
        return t;
    });
    
    private final BlockingQueue<String> logQueue = new LinkedBlockingQueue<>(10000);
    
    public AsyncProcessingInterceptor() {
        // å¯åŠ¨å¼‚æ­¥æ—¥å¿—å¤„ç†çº¿ç¨‹
        asyncExecutor.submit(this::processLogs);
    }
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        // âœ… ä¸»æµç¨‹åªåšå¿…è¦çš„å¤„ç†
        Headers headers = record.headers();
        headers.add("process_time", String.valueOf(System.currentTimeMillis()).getBytes());
        
        // âœ… å°†è€—æ—¶æ“ä½œæäº¤åˆ°å¼‚æ­¥é˜Ÿåˆ—
        String logMessage = "å‘é€æ¶ˆæ¯: " + record.topic() + ", key: " + record.key();
        logQueue.offer(logMessage); // éé˜»å¡æ“ä½œ
        
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        // âœ… å¼‚æ­¥å¤„ç†ç¡®è®¤ç»“æœ
        String resultMessage = exception == null ? 
            "æˆåŠŸ: " + metadata.topic() + "-" + metadata.partition() + "-" + metadata.offset() :
            "å¤±è´¥: " + exception.getMessage();
        
        logQueue.offer(resultMessage);
    }
    
    private void processLogs() {
        try {
            while (!Thread.currentThread().isInterrupted()) {
                String logMessage = logQueue.take(); // é˜»å¡ç­‰å¾…
                // è¿™é‡Œå¯ä»¥å†™å…¥æ–‡ä»¶ã€å‘é€åˆ°ç›‘æ§ç³»ç»Ÿç­‰è€—æ—¶æ“ä½œ
                System.out.println("[ASYNC] " + logMessage);
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    @Override
    public void configure(Map<String, ?> configs) {}
    
    @Override
    public void close() {
        asyncExecutor.shutdown();
        try {
            if (!asyncExecutor.awaitTermination(5, TimeUnit.SECONDS)) {
                asyncExecutor.shutdownNow();
            }
        } catch (InterruptedException e) {
            asyncExecutor.shutdownNow();
        }
    }
}
```

### 8.3 æ‹¦æˆªå™¨æœ€ä½³å®è·µ


**ğŸ”¸ è®¾è®¡åŸåˆ™**

> **å•ä¸€èŒè´£åŸåˆ™**
> æ¯ä¸ªæ‹¦æˆªå™¨åªåšä¸€ä»¶äº‹ï¼Œè¿™æ ·ä¾¿äºç»´æŠ¤å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

```java
// âœ… å¥½çš„è®¾è®¡ - èŒè´£å•ä¸€
class TimestampInterceptor implements ProducerInterceptor<String, String> {
    // åªè´Ÿè´£æ·»åŠ æ—¶é—´æˆ³
}

class MetricsInterceptor implements ProducerInterceptor<String, String> {
    // åªè´Ÿè´£ç»Ÿè®¡æ•°æ®
}

// âŒ ä¸å¥½çš„è®¾è®¡ - èŒè´£æ··åˆ
class AllInOneInterceptor implements ProducerInterceptor<String, String> {
    // æ—¢æ·»åŠ æ—¶é—´æˆ³ï¼Œåˆç»Ÿè®¡æ•°æ®ï¼Œåˆè¿‡æ»¤æ¶ˆæ¯ï¼Œåˆè®°å½•æ—¥å¿—...
}
```

**ğŸ”¸ é…ç½®æœ€ä½³å®è·µ**

```java
/**
 * æ‹¦æˆªå™¨é…ç½®æœ€ä½³å®è·µ
 */
public class InterceptorBestPractices {
    
    public static Properties createOptimizedProducerConfig() {
        Properties props = new Properties();
        
        // åŸºç¡€é…ç½®
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // âœ… æ‹¦æˆªå™¨é…ç½®å»ºè®®
        
        // 1. å¼€å‘ç¯å¢ƒï¼šå®Œæ•´çš„æ‹¦æˆªå™¨é“¾
        if (isDevEnvironment()) {
            props.put("interceptor.classes", 
                "TimestampInterceptor," +          // è°ƒè¯•ä¿¡æ¯
                "DetailedLogInterceptor," +        // è¯¦ç»†æ—¥å¿—  
                "MetricsInterceptor"               // æ€§èƒ½ç»Ÿè®¡
            );
        }
        // 2. ç”Ÿäº§ç¯å¢ƒï¼šç²¾ç®€çš„æ‹¦æˆªå™¨é“¾
        else if (isProdEnvironment()) {
            props.put("interceptor.classes",
                "TimestampInterceptor," +          // åŸºæœ¬ä¿¡æ¯
                "MetricsInterceptor"               // å…³é”®ç›‘æ§
            );
            // ç”Ÿäº§ç¯å¢ƒç¦ç”¨è¯¦ç»†æ—¥å¿—ï¼Œé¿å…æ€§èƒ½å½±å“
        }
        
        // 3. æ€§èƒ½æµ‹è¯•ç¯å¢ƒï¼šå¯èƒ½å®Œå…¨ä¸ä½¿ç”¨æ‹¦æˆªå™¨
        else if (isPerfTestEnvironment()) {
            // ä¸é…ç½®interceptor.classesï¼Œè·å¾—æœ€ä½³æ€§èƒ½
        }
        
        return props;
    }
    
    private static boolean isDevEnvironment() {
        return "dev".equals(System.getProperty("env", "dev"));
    }
    
    private static boolean isProdEnvironment() {
        return "prod".equals(System.getProperty("env"));
    }
    
    private static boolean isPerfTestEnvironment() {
        return "perf".equals(System.getProperty("env"));
    }
}
```

**ğŸ”¸ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ**

```java
/**
 * å¥å£®çš„æ‹¦æˆªå™¨å®ç° - å®Œå–„çš„å¼‚å¸¸å¤„ç†
 */
public class RobustInterceptor implements ProducerInterceptor<String, String> {
    
    private static final Logger logger = LoggerFactory.getLogger(RobustInterceptor.class);
    
    @Override
    public ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        try {
            // âœ… é˜²å¾¡æ€§ç¼–ç¨‹ - æ£€æŸ¥è¾“å…¥å‚æ•°
            if (record == null) {
                logger.warn("æ”¶åˆ°nullçš„ProducerRecordï¼Œè·³è¿‡å¤„ç†");
                return null;
            }
            
            // âœ… å®‰å…¨çš„å¤„ç†é€»è¾‘
            return processRecord(record);
            
        } catch (Exception e) {
            // âœ… å¼‚å¸¸ä¸åº”è¯¥å½±å“æ¶ˆæ¯å‘é€
            logger.error("æ‹¦æˆªå™¨å¤„ç†å¼‚å¸¸ï¼Œå°†è¿”å›åŸå§‹record", e);
            return record; // è¿”å›åŸå§‹recordï¼Œè€Œä¸æ˜¯null
        }
    }
    
    private ProducerRecord<String, String> processRecord(ProducerRecord<String, String> record) {
        // å…·ä½“çš„å¤„ç†é€»è¾‘
        Headers headers = record.headers();
        headers.add("processed", "true".getBytes());
        return record;
    }
    
    @Override
    public void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        try {
            if (exception == null) {
                handleSuccess(metadata);
            } else {
                handleFailure(exception);
            }
        } catch (Exception e) {
            // âœ… ç¡®è®¤å¤„ç†çš„å¼‚å¸¸ä¸åº”è¯¥ä¼ æ’­
            logger.error("ç¡®è®¤å¤„ç†å¼‚å¸¸", e);
        }
    }
    
    private void handleSuccess(RecordMetadata metadata) {
        // æˆåŠŸå¤„ç†é€»è¾‘
    }
    
    private void handleFailure(Exception exception) {
        // å¤±è´¥å¤„ç†é€»è¾‘
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        try {
            // âœ… å®‰å…¨çš„é…ç½®å¤„ç†
            validateConfig(configs);
            initializeFromConfig(configs);
        } catch (Exception e) {
            logger.error("æ‹¦æˆªå™¨é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®", e);
            useDefaultConfig();
        }
    }
    
    private void validateConfig(Map<String, ?> configs) {
        // é…ç½®éªŒè¯é€»è¾‘
    }
    
    private void initializeFromConfig(Map<String, ?> configs) {
        // é…ç½®åˆå§‹åŒ–é€»è¾‘
    }
    
    private void useDefaultConfig() {
        // é»˜è®¤é…ç½®é€»è¾‘
    }
    
    @Override
    public void close() {
        try {
            // âœ… å®‰å…¨çš„èµ„æºæ¸…ç†
            cleanupResources();
        } catch (Exception e) {
            logger.error("æ‹¦æˆªå™¨å…³é—­æ—¶å¼‚å¸¸", e);
        }
    }
    
    private void cleanupResources() {
        // èµ„æºæ¸…ç†é€»è¾‘
    }
}
```

**ğŸ”¸ ç›‘æ§å’Œè°ƒè¯•æœ€ä½³å®è·µ**

```java
/**
 * å¯ç›‘æ§çš„æ‹¦æˆªå™¨åŸºç±»
 */
public abstract class MonitorableInterceptor implements ProducerInterceptor<String, String> {
    
    protected final String interceptorName;
    protected final AtomicLong processedCount = new AtomicLong(0);
    protected final AtomicLong errorCount = new AtomicLong(0);
    protected final AtomicLong totalProcessingTime = new AtomicLong(0);
    
    public MonitorableInterceptor(String name) {
        this.interceptorName = name;
    }
    
    @Override
    public final ProducerRecord<String, String> onSend(ProducerRecord<String, String> record) {
        long startTime = System.nanoTime();
        try {
            ProducerRecord<String, String> result = doOnSend(record);
            processedCount.incrementAndGet();
            return result;
        } catch (Exception e) {
            errorCount.incrementAndGet();
            System.err.println(interceptorName + " å¤„ç†å¼‚å¸¸: " + e.getMessage());
            return record;
        } finally {
            long endTime = System.nanoTime();
            totalProcessingTime.addAndGet(endTime - startTime);
        }
    }
    
    // å­ç±»å®ç°å…·ä½“çš„å¤„ç†é€»è¾‘
    protected abstract ProducerRecord<String, String> doOnSend(ProducerRecord<String, String> record);
    
    @Override
    public final void onAcknowledgement(RecordMetadata metadata, Exception exception) {
        try {
            doOnAcknowledgement(metadata, exception);
        } catch (Exception e) {
            errorCount.incrementAndGet();
            System.err.println(interceptorName + " ç¡®è®¤å¤„ç†å¼‚å¸¸: " + e.getMessage());
        }
    }
    
    // å­ç±»å®ç°å…·ä½“çš„ç¡®è®¤å¤„ç†é€»è¾‘
    protected abstract void doOnAcknowledgement(RecordMetadata metadata, Exception exception);
    
    @Override
    public void close() {
        // æ‰“å°æ€§èƒ½ç»Ÿè®¡
        long processed = processedCount.get();
        long errors = errorCount.get();
        long totalTime = totalProcessingTime.get();
        
        System.out.println("=== " + interceptorName + " æ€§èƒ½ç»Ÿè®¡ ===");
        System.out.println("å¤„ç†æ¶ˆæ¯æ•°: " + processed);
        System.out.println("å¼‚å¸¸æ¬¡æ•°: " + errors);
        if (processed > 0) {
            System.out.println("å¹³å‡å¤„ç†æ—¶é—´: " + (totalTime / processed / 1000) + " å¾®ç§’");
            System.out.println("é”™è¯¯ç‡: " + String.format("%.2f%%", errors * 100.0 / processed));
        }
        
        // è°ƒç”¨å­ç±»çš„æ¸…ç†é€»è¾‘
        doClose();
    }
    
    protected abstract void doClose();
    
    // æä¾›ç›‘æ§æ¥å£
    public Map<String, Object> getMetrics() {
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("name", interceptorName);
        metrics.put("processed_count", processedCount.get());
        metrics.put("error_count", errorCount.get());
        metrics.put("total_processing_time_ns", totalProcessingTime.get());
        return metrics;
    }
}

// ä½¿ç”¨ç›‘æ§åŸºç±»çš„ç¤ºä¾‹
public class MonitoredTimestampInterceptor extends MonitorableInterceptor {
    
    public MonitoredTimestampInterceptor() {
        super("TimestampInterceptor");
    }
    
    @Override
    protected ProducerRecord<String, String> doOnSend(ProducerRecord<String, String> record) {
        Headers headers = record.headers();
        headers.add("timestamp", String.valueOf(System.currentTimeMillis()).getBytes());
        return record;
    }
    
    @Override
    protected void doOnAcknowledgement(RecordMetadata metadata, Exception exception) {
        // æ—¶é—´æˆ³æ‹¦æˆªå™¨ä¸éœ€è¦ç‰¹æ®Šçš„ç¡®è®¤å¤„ç†
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        // é…ç½®é€»è¾‘
    }
    
    @Override
    protected void doClose() {
        // æ¸…ç†é€»è¾‘
    }
}
```

### 8.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®


**ğŸ”¸ ç¯å¢ƒé…ç½®ç­–ç•¥**

| ç¯å¢ƒç±»å‹ | æ‹¦æˆªå™¨é…ç½® | æ€§èƒ½å½±å“ | ç”¨é€” |
|---------|-----------|---------|------|
| **å¼€å‘ç¯å¢ƒ** | å…¨å¥—æ‹¦æˆªå™¨ | å¯æ¥å— | è°ƒè¯•ã€æµ‹è¯•åŠŸèƒ½ |
| **æµ‹è¯•ç¯å¢ƒ** | æ ¸å¿ƒæ‹¦æˆªå™¨ | è¾ƒå° | éªŒè¯ä¸šåŠ¡é€»è¾‘ |
| **é¢„ç”Ÿäº§ç¯å¢ƒ** | ç”Ÿäº§æ‹¦æˆªå™¨ | æœ€å° | æ€§èƒ½éªŒè¯ |
| **ç”Ÿäº§ç¯å¢ƒ** | å¿…è¦æ‹¦æˆªå™¨ | æœ€å° | ä¸šåŠ¡è¿è¡Œ |

**ğŸ”¸ ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**

```java
/**
 * ç”Ÿäº§ç¯å¢ƒæ‹¦æˆªå™¨é…ç½®æ£€æŸ¥
 */
public class ProductionInterceptorValidator {
    
    public static void validateProductionConfig(Properties producerProps) {
        String interceptorClasses = producerProps.getProperty("interceptor.classes", "");
        
        if (interceptorClasses.isEmpty()) {
            System.out.println("âœ… ç”Ÿäº§ç¯å¢ƒæœªé…ç½®æ‹¦æˆªå™¨ï¼Œæ€§èƒ½æœ€ä¼˜");
            return;
        }
        
        String[] interceptors = interceptorClasses.split(",");
        System.out.println("ğŸ” æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒæ‹¦æˆªå™¨é…ç½®...");
        
        for (String interceptor : interceptors) {
            validateInterceptor(interceptor.trim());
        }
        
        // æ£€æŸ¥æ‹¦æˆªå™¨æ•°é‡
        if (interceptors.length > 3) {
            System.out.println("âš ï¸  è­¦å‘Š: ç”Ÿäº§ç¯å¢ƒæ‹¦æˆªå™¨è¿‡å¤š(" + interceptors.length + 
                             "ä¸ª)ï¼Œå¯èƒ½å½±å“æ€§èƒ½");
        }
        
        // æ£€æŸ¥é¡ºåº
        validateInterceptorOrder(interceptors);
    }
    
    private static void validateInterceptor(String interceptorClass) {
        if (interceptorClass.contains("Debug") || interceptorClass.contains("Verbose")) {
            System.out.println("âŒ é”™è¯¯: ç”Ÿäº§ç¯å¢ƒä¸åº”ä½¿ç”¨è°ƒè¯•æ‹¦æˆªå™¨: " + interceptorClass);
        } else if (interceptorClass.contains("Metrics") || interceptorClass.contains("Monitor")) {
            System.out.println("âœ… ç›‘æ§æ‹¦æˆªå™¨: " + interceptorClass);
        } else if (interceptorClass.contains("Security") || interceptorClass.contains("Timestamp")) {
            System.out.println("âœ… æ ¸å¿ƒåŠŸèƒ½æ‹¦æˆªå™¨: " + interceptorClass);
        } else {
            System.out.println("âš ï¸  éœ€è¦ç¡®è®¤çš„æ‹¦æˆªå™¨: " + interceptorClass);
        }
    }
    
    private static void validateInterceptorOrder(String[] interceptors) {
        // æ£€æŸ¥ç›‘æ§æ‹¦æˆªå™¨æ˜¯å¦åœ¨æœ€å
        for (int i = 0; i < interceptors.length - 1; i++) {
            String interceptor = interceptors[i];
            if (interceptor.contains("Metrics") || interceptor.contains("Monitor")) {
                System.out.println("âš ï¸  å»ºè®®: ç›‘æ§æ‹¦æˆªå™¨åº”è¯¥æ”¾åœ¨æœ€åä½ç½®");
                break;
            }
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‹¦æˆªå™¨æœ¬è´¨ï¼šæ¶ˆæ¯å¤„ç†çš„"ä¸­è½¬ç«™"ï¼Œå¯ä»¥å¢å¼ºã€è¿‡æ»¤ã€ç›‘æ§æ¶ˆæ¯
ğŸ”¸ æ ¸å¿ƒæ¥å£ï¼šProducerInterceptorçš„å››ä¸ªæ–¹æ³•åŠå…¶ä½œç”¨æ—¶æœº
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šonSend()é¡ºåºæ‰§è¡Œï¼ŒonAcknowledgement()é€†åºæ‰§è¡Œ  
ğŸ”¸ è®¾è®¡æ¨¡å¼ï¼šæ‹¦æˆªå™¨é“¾æ¨¡å¼ï¼Œå•ä¸€èŒè´£åŸåˆ™
ğŸ”¸ æ€§èƒ½å½±å“ï¼šæ¯ä¸ªæ‹¦æˆªå™¨å¢åŠ çº¦0.5mså»¶è¿Ÿï¼Œé™ä½5-8%ååé‡
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯å¢å¼ºã€æ•°æ®è¿‡æ»¤ã€ç›‘æ§ç»Ÿè®¡ã€å®‰å…¨æ§åˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‹¦æˆªå™¨ vs å…¶ä»–æ‰©å±•æ–¹å¼**
```
æ‹¦æˆªå™¨ï¼šåœ¨Producerå†…éƒ¨ï¼Œå¯ä»¥ä¿®æ”¹æ¶ˆæ¯ï¼Œæ€§èƒ½å½±å“è¾ƒå¤§
åºåˆ—åŒ–å™¨ï¼šåªè´Ÿè´£æ•°æ®è½¬æ¢ï¼Œä¸èƒ½ä¿®æ”¹æ¶ˆæ¯ç»“æ„
åˆ†åŒºå™¨ï¼šåªè´Ÿè´£åˆ†åŒºé€‰æ‹©ï¼Œä¸èƒ½ä¿®æ”¹æ¶ˆæ¯å†…å®¹
å›è°ƒå‡½æ•°ï¼šåªèƒ½åœ¨å‘é€åè·å–ç»“æœï¼Œä¸èƒ½ä¿®æ”¹æ¶ˆæ¯
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ‹¦æˆªå™¨**
```
âœ… é€‚åˆä½¿ç”¨ï¼š
- éœ€è¦ç»™æ‰€æœ‰æ¶ˆæ¯æ·»åŠ ç»Ÿä¸€çš„å…ƒæ•°æ®
- éœ€è¦å…¨å±€çš„æ¶ˆæ¯è¿‡æ»¤æˆ–ç›‘æ§
- éœ€è¦æ’ä»¶åŒ–çš„æ‰©å±•èƒ½åŠ›
- è·¨å¤šä¸ªåº”ç”¨çš„ç»Ÿä¸€å¤„ç†é€»è¾‘

âŒ ä¸é€‚åˆä½¿ç”¨ï¼š
- å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†
- éœ€è¦å¤–éƒ¨æ•°æ®æŸ¥è¯¢çš„å¤„ç†
- æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
- ç®€å•çš„ä¸€æ¬¡æ€§å¤„ç†éœ€æ±‚
```

**ğŸ”¹ æ‹¦æˆªå™¨é“¾è®¾è®¡åŸåˆ™**
```
èŒè´£åˆ†ç¦»ï¼šæ¯ä¸ªæ‹¦æˆªå™¨åªåšä¸€ä»¶äº‹
é¡ºåºé‡è¦ï¼šè¿‡æ»¤â†’å¢å¼ºâ†’ç›‘æ§çš„é¡ºåº
å¼‚å¸¸å®‰å…¨ï¼šä»»ä½•æ‹¦æˆªå™¨å¼‚å¸¸éƒ½ä¸åº”å½±å“æ¶ˆæ¯å‘é€
æ€§èƒ½ä¼˜å…ˆï¼šé¿å…è€—æ—¶æ“ä½œï¼Œè€ƒè™‘å¼‚æ­¥å¤„ç†
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ å¼€å‘å®è·µå»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆå®ç°åŸºç¡€çš„æ—¶é—´æˆ³æ‹¦æˆªå™¨ï¼Œé€æ­¥å¢åŠ åŠŸèƒ½
- **ç¯å¢ƒåŒºåˆ†**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä½¿ç”¨ä¸åŒçš„æ‹¦æˆªå™¨é…ç½®
- **æ€§èƒ½ç›‘æ§**ï¼šæŒç»­ç›‘æ§æ‹¦æˆªå™¨å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
- **å¼‚å¸¸å¤„ç†**ï¼šç¡®ä¿æ‹¦æˆªå™¨å¼‚å¸¸ä¸ä¼šä¸­æ–­æ­£å¸¸çš„æ¶ˆæ¯å‘é€æµç¨‹

**ğŸ› ï¸ å¸¸è§é—®é¢˜è§£å†³**
- **æ€§èƒ½é—®é¢˜**ï¼šå‡å°‘æ‹¦æˆªå™¨æ•°é‡ï¼Œä¼˜åŒ–å¤„ç†é€»è¾‘ï¼Œä½¿ç”¨å¼‚æ­¥å¤„ç†
- **é¡ºåºé—®é¢˜**ï¼šç†è§£æ‰§è¡Œé¡ºåºï¼Œåˆç†å®‰æ’æ‹¦æˆªå™¨ä½ç½®
- **é…ç½®é—®é¢˜**ï¼šä½¿ç”¨å·¥å‚æ¨¡å¼ç»Ÿä¸€ç®¡ç†ï¼Œæ”¯æŒåŠ¨æ€é…ç½®
- **è°ƒè¯•é—®é¢˜**ï¼šä½¿ç”¨ç›‘æ§åŸºç±»ï¼Œæ·»åŠ è¯¦ç»†çš„æ—¥å¿—å’ŒæŒ‡æ ‡

**ğŸ¯ ä¼ä¸šçº§åº”ç”¨è¦ç‚¹**
- **æ’ä»¶åŒ–æ¶æ„**ï¼šè®¾è®¡å¯æ‰©å±•çš„æ‹¦æˆªå™¨æ¡†æ¶
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒä¸åŒç¯å¢ƒçš„é…ç½®ç­–ç•¥
- **ç›‘æ§å‘Šè­¦**ï¼šé›†æˆåˆ°ä¼ä¸šç›‘æ§ç³»ç»Ÿ
- **ç‰ˆæœ¬å…¼å®¹**ï¼šè€ƒè™‘æ‹¦æˆªå™¨çš„å‡çº§å’Œå…¼å®¹æ€§

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“ æ–°æ‰‹å­¦ä¹ é¡ºåº**
1. **ç†è§£æ¦‚å¿µ**ï¼šä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨ï¼Œæœ‰ä»€ä¹ˆç”¨é€”
2. **å®ç°åŸºç¡€æ‹¦æˆªå™¨**ï¼šæ—¶é—´æˆ³ã€ç®€å•è¿‡æ»¤ã€åŸºç¡€ç»Ÿè®¡
3. **æŒæ¡æ‹¦æˆªå™¨é“¾**ï¼šå¤šä¸ªæ‹¦æˆªå™¨çš„ç»„åˆä½¿ç”¨
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šç†è§£æ€§èƒ½å½±å“ï¼Œå­¦ä¼šä¼˜åŒ–ç­–ç•¥
5. **ä¼ä¸šçº§åº”ç”¨**ï¼šæ’ä»¶åŒ–è®¾è®¡ï¼Œç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

**ğŸ“š è¿›é˜¶å­¦ä¹ æ–¹å‘**
- **Kafka Streamsæ‹¦æˆªå™¨**ï¼šæµå¤„ç†ä¸­çš„æ‹¦æˆªå™¨åº”ç”¨
- **Consumeræ‹¦æˆªå™¨**ï¼šæ¶ˆè´¹ç«¯çš„æ‹¦æˆªå™¨å®ç°
- **Spring Kafkaé›†æˆ**ï¼šåœ¨Springæ¡†æ¶ä¸­ä½¿ç”¨æ‹¦æˆªå™¨
- **äº‘åŸç”Ÿç›‘æ§**ï¼šä¸Prometheusã€Grafanaç­‰ç›‘æ§ç³»ç»Ÿé›†æˆ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Produceræ‹¦æˆªå™¨æ˜¯æ¶ˆæ¯å‘é€é“¾è·¯ä¸­çš„"ä¸­è½¬ç«™"
- onSend()é¡ºåºæ‰§è¡Œå¯ä¿®æ”¹æ¶ˆæ¯ï¼ŒonAcknowledgement()é€†åºæ‰§è¡Œç”¨äºç›‘æ§
- æ‹¦æˆªå™¨é“¾è®¾è®¡è¦è€ƒè™‘èŒè´£åˆ†ç¦»å’Œæ€§èƒ½å½±å“
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¦è°¨æ…ï¼Œé‡ç‚¹å…³æ³¨æ€§èƒ½å’Œç¨³å®šæ€§
- é€šè¿‡æ’ä»¶åŒ–è®¾è®¡å¯ä»¥å®ç°çµæ´»çš„æ‰©å±•èƒ½åŠ›