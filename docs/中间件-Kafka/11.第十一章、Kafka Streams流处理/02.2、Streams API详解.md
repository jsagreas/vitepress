---
title: 2ã€Streams APIè¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Kafka StreamsåŸºç¡€æ¦‚å¿µ](#1-kafka-streamsåŸºç¡€æ¦‚å¿µ)
2. [KStream APIè¯¦è§£](#2-kstream-apiè¯¦è§£)
3. [KTable APIè¯¦è§£](#3-ktable-apiè¯¦è§£)
4. [GlobalKTable APIè¯¦è§£](#4-globaltable-apiè¯¦è§£)
5. [StreamsBuilderæ„å»ºå™¨](#5-streamsbuilderæ„å»ºå™¨)
6. [Topologyæ‹“æ‰‘æ„å»º](#6-topologyæ‹“æ‰‘æ„å»º)
7. [æµæ“ä½œè¯¦è§£](#7-æµæ“ä½œè¯¦è§£)
8. [è¡¨æ“ä½œè¯¦è§£](#8-è¡¨æ“ä½œè¯¦è§£)
9. [è¿æ¥æ“ä½œè¯¦è§£](#9-è¿æ¥æ“ä½œè¯¦è§£)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ Kafka StreamsåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Kafka Streamsï¼Ÿ


> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šKafka Streamså°±æ˜¯Kafkaå®˜æ–¹æä¾›çš„ä¸€ä¸ª"æµæ°´çº¿å¤„ç†å·¥å‚"ï¼Œå¯ä»¥å®æ—¶å¤„ç†ä»Kafkaä¸»é¢˜ä¸­æµå…¥çš„æ•°æ®ã€‚

**ç®€å•ç±»æ¯”**ï¼š
```
æƒ³è±¡ä¸€ä¸ªé¥®æ–™å·¥å‚çš„æµæ°´çº¿ï¼š
åŸæ–™ï¼ˆæ¶ˆæ¯ï¼‰ â†’ åŠ å·¥å¤„ç†ï¼ˆStreamsï¼‰ â†’ æˆå“ï¼ˆç»“æœï¼‰

Kafkaä¸­ï¼š
Topicæ•°æ® â†’ Streamså¤„ç† â†’ å¤„ç†ç»“æœ
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ”¸ **å®æ—¶å¤„ç†**ï¼šæ•°æ®ä¸€æ¥å°±å¤„ç†ï¼Œä¸ç”¨ç­‰å¾…
- ğŸ”¸ **Javaåº“**ï¼šç›´æ¥åœ¨Javaåº”ç”¨ä¸­ä½¿ç”¨ï¼Œä¸éœ€è¦é¢å¤–é›†ç¾¤
- ğŸ”¸ **çŠ¶æ€ç®¡ç†**ï¼šå¯ä»¥è®°ä½ä¹‹å‰çš„æ•°æ®çŠ¶æ€
- ğŸ”¸ **å®¹é”™èƒ½åŠ›**ï¼šç¨‹åºå´©æºƒé‡å¯åå¯ä»¥ç»§ç»­å¤„ç†

### 1.2 æ ¸å¿ƒæŠ½è±¡æ¦‚å¿µ


**ä¸‰å¤§æ ¸å¿ƒæŠ½è±¡**ï¼š

```
KStreamï¼ˆæµï¼‰    â†’  æ•°æ®æµï¼Œåƒæ°´æµä¸€æ ·è¿ç»­
KTableï¼ˆè¡¨ï¼‰     â†’  æ•°æ®è¡¨ï¼Œä¼šæ›´æ–°çš„æ•°æ®åº“è¡¨
GlobalKTable    â†’  å…¨å±€è¡¨ï¼Œæ‰€æœ‰å®ä¾‹éƒ½èƒ½çœ‹åˆ°å®Œæ•´æ•°æ®
```

**é€šä¿—ç†è§£**ï¼š
- **KStream**ï¼šå°±åƒæ–°é—»ç›´æ’­ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ä¸€ä¸ªäº‹ä»¶
- **KTable**ï¼šå°±åƒè‚¡ç¥¨è¡Œæƒ…è¡¨ï¼Œä»·æ ¼ä¼šå®æ—¶æ›´æ–°
- **GlobalKTable**ï¼šå°±åƒå…¨å›½åœ°å›¾ï¼Œæ¯ä¸ªäººçœ‹åˆ°çš„éƒ½ä¸€æ ·

### 1.3 Streamså¤„ç†æ¶æ„å›¾


```
è¾“å…¥Topic          Streamsåº”ç”¨           è¾“å‡ºTopic
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¡Œä¸º â”‚â”€â”€â”€â”€â†’  â”‚  è¿‡æ»¤/è½¬æ¢   â”‚â”€â”€â”€â”€â†’  â”‚ å¤„ç†ç»“æœ â”‚
â”‚ è®¢å•æ•°æ® â”‚       â”‚  èšåˆ/è¿æ¥   â”‚       â”‚ ç»Ÿè®¡æŠ¥è¡¨ â”‚
â”‚ æ—¥å¿—ä¿¡æ¯ â”‚       â”‚  çŠ¶æ€å­˜å‚¨    â”‚       â”‚ å‘Šè­¦ä¿¡æ¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸŒŠ KStream APIè¯¦è§£


### 2.1 KStreamæ¦‚å¿µç†è§£


> ğŸ’¡ **KStreamæœ¬è´¨**ï¼šKStreamä»£è¡¨ä¸€ä¸ª**æ— ç•Œçš„æ•°æ®æµ**ï¼Œæ¯æ¡è®°å½•éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹ä»¶ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
KStreamå°±åƒï¼š
- é“¶è¡Œæµæ°´è´¦ï¼šæ¯ç¬”äº¤æ˜“éƒ½æ˜¯ç‹¬ç«‹è®°å½•
- ç½‘ç«™è®¿é—®æ—¥å¿—ï¼šæ¯æ¬¡ç‚¹å‡»éƒ½æ˜¯ä¸€ä¸ªäº‹ä»¶
- èŠå¤©è®°å½•ï¼šæ¯æ¡æ¶ˆæ¯éƒ½æ˜¯ç‹¬ç«‹çš„
```

**ç‰¹ç‚¹æ€»ç»“**ï¼š
- âœ… **è¿½åŠ æ€§**ï¼šåªèƒ½æ·»åŠ æ–°è®°å½•ï¼Œä¸èƒ½ä¿®æ”¹å·²æœ‰è®°å½•
- âœ… **æœ‰åºæ€§**ï¼šåœ¨åŒä¸€åˆ†åŒºå†…ä¿æŒé¡ºåº
- âœ… **ç‹¬ç«‹æ€§**ï¼šæ¯æ¡è®°å½•éƒ½æ˜¯ç‹¬ç«‹äº‹ä»¶

### 2.2 KStreamåŸºç¡€æ“ä½œ


#### ğŸ”¸ åˆ›å»ºKStream


```java
// ä»Topicåˆ›å»ºKStream
KStream<String, String> userStream = builder.stream("user-events");

// æŒ‡å®šåºåˆ—åŒ–å™¨
KStream<String, User> userStream = builder.stream("user-events",
    Consumed.with(Serdes.String(), userSerde));
```

#### ğŸ”¸ è¿‡æ»¤æ“ä½œ


```java
// è¿‡æ»¤VIPç”¨æˆ·
KStream<String, User> vipUsers = userStream
    .filter((key, user) -> user.getLevel().equals("VIP"));

// è¿‡æ»¤æ‰ç©ºå€¼
KStream<String, User> validUsers = userStream
    .filterNot((key, user) -> user == null);
```

> âš ï¸ **æ³¨æ„**ï¼šfilterä¼šåˆ›å»ºæ–°çš„æµï¼ŒåŸæµä¸å˜ï¼Œè¿™å°±æ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„"ä¸å¯å˜æ€§"ã€‚

#### ğŸ”¸ æ˜ å°„è½¬æ¢


```java
// è½¬æ¢ç”¨æˆ·æ•°æ®æ ¼å¼
KStream<String, UserProfile> profiles = userStream
    .map((key, user) -> KeyValue.pair(
        user.getId(),           // æ–°key
        new UserProfile(user)   // æ–°value
    ));

// åªè½¬æ¢valueï¼Œkeyä¸å˜
KStream<String, String> userNames = userStream
    .mapValues(user -> user.getName());
```

### 2.3 KStreamé«˜çº§æ“ä½œ


#### ğŸ”¸ åˆ†æ”¯æ“ä½œ


```java
// æ ¹æ®æ¡ä»¶å°†æµåˆ†æˆå¤šä¸ªåˆ†æ”¯
Map<String, KStream<String, User>> branches = userStream
    .split(Named.as("user-"))
    .branch((key, user) -> user.getAge() < 18, Branched.as("minor"))
    .branch((key, user) -> user.getAge() < 60, Branched.as("adult"))
    .defaultBranch(Branched.as("senior"));

// è·å–å„ä¸ªåˆ†æ”¯
KStream<String, User> minorUsers = branches.get("user-minor");
KStream<String, User> adultUsers = branches.get("user-adult");
```

#### ğŸ”¸ æ‰å¹³åŒ–æ“ä½œ


```java
// å°†ä¸€æ¡è®°å½•å±•å¼€æˆå¤šæ¡è®°å½•
KStream<String, String> words = textStream
    .flatMapValues(text -> Arrays.asList(text.split("\\s+")));

// è¯é¢‘ç»Ÿè®¡çš„ç¬¬ä¸€æ­¥ï¼šåˆ†è¯
KStream<String, String> wordStream = sentences
    .flatMapValues(sentence -> 
        Arrays.asList(sentence.toLowerCase().split("\\W+")))
    .filter((key, word) -> word.length() > 0);
```

---

## 3. ğŸ“Š KTable APIè¯¦è§£


### 3.1 KTableæ¦‚å¿µç†è§£


> ğŸ’¡ **KTableæœ¬è´¨**ï¼šKTableä»£è¡¨ä¸€ä¸ª**å¯å˜æ›´çš„æ•°æ®è¡¨**ï¼Œç›¸åŒkeyçš„æ–°è®°å½•ä¼šè¦†ç›–æ—§è®°å½•ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
KTableå°±åƒï¼š
- ç”¨æˆ·æ¡£æ¡ˆè¡¨ï¼šç”¨æˆ·ä¿¡æ¯ä¼šæ›´æ–°
- å•†å“åº“å­˜è¡¨ï¼šåº“å­˜æ•°é‡ä¼šå˜åŒ–
- é…ç½®ä¿¡æ¯è¡¨ï¼šé…ç½®ä¼šä¿®æ”¹
```

**KStream vs KTableå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **KStream** | **KTable** |
|------|-------------|-----------|
| **æ•°æ®ç‰¹ç‚¹** | `äº‹ä»¶æµï¼Œæ¯æ¡éƒ½ä¿ç•™` | `çŠ¶æ€è¡¨ï¼Œç›¸åŒkeyä¼šè¦†ç›–` |
| **æ›´æ–°æ–¹å¼** | `åªèƒ½è¿½åŠ ` | `å¯ä»¥æ›´æ–°è¦†ç›–` |
| **é€‚ç”¨åœºæ™¯** | `ç”¨æˆ·è¡Œä¸ºæ—¥å¿—` | `ç”¨æˆ·æ¡£æ¡ˆä¿¡æ¯` |
| **å­˜å‚¨æ–¹å¼** | `æ‰€æœ‰è®°å½•éƒ½ä¿å­˜` | `åªä¿å­˜æœ€æ–°çŠ¶æ€` |

### 3.2 KTableåˆ›å»ºæ–¹å¼


#### ğŸ”¸ ä»Topicåˆ›å»º


```java
// ä»å‹ç¼©Topicåˆ›å»ºKTableï¼ˆæ¨èï¼‰
KTable<String, User> userTable = builder.table("users",
    Consumed.with(Serdes.String(), userSerde));

// ä»KStreamè½¬æ¢ä¸ºKTable
KTable<String, Long> wordCounts = wordStream
    .groupBy((key, word) -> word)
    .count();
```

> ğŸ“ **é‡è¦æç¤º**ï¼šç”¨äºKTableçš„Topicå»ºè®®è®¾ç½®ä¸º`cleanup.policy=compact`ï¼Œè¿™æ ·å¯ä»¥ä¿ç•™æ¯ä¸ªkeyçš„æœ€æ–°å€¼ã€‚

#### ğŸ”¸ KTableåŸºæœ¬æ“ä½œ


```java
// è¿‡æ»¤æ“ä½œ
KTable<String, User> activeUsers = userTable
    .filter((key, user) -> user.isActive());

// è½¬æ¢æ“ä½œ
KTable<String, UserSummary> summaries = userTable
    .mapValues(user -> new UserSummary(user));

// è½¬æ¢ä¸ºStream
KStream<String, User> userStream = userTable.toStream();
```

### 3.3 KTableèšåˆæ“ä½œ


```java
// æŒ‰éƒ¨é—¨ç»Ÿè®¡äººæ•°
KTable<String, Long> deptCounts = userTable
    .groupBy((userId, user) -> KeyValue.pair(user.getDepartment(), user))
    .count();

// æŒ‰éƒ¨é—¨è®¡ç®—å¹³å‡è–ªèµ„
KTable<String, Double> avgSalary = userTable
    .groupBy((userId, user) -> KeyValue.pair(user.getDepartment(), user))
    .aggregate(
        () -> new SalaryAgg(0, 0),           // åˆå§‹å€¼
        (dept, user, agg) -> agg.add(user),  // æ·»åŠ èšåˆ
        (dept, user, agg) -> agg.remove(user), // åˆ é™¤èšåˆ
        Materialized.with(Serdes.String(), salaryAggSerde)
    );
```

---

## 4. ğŸŒ GlobalKTable APIè¯¦è§£


### 4.1 GlobalKTableæ¦‚å¿µç†è§£


> ğŸ’¡ **GlobalKTableç‰¹ç‚¹**ï¼šå…¨å±€è¡¨ï¼Œæ¯ä¸ªåº”ç”¨å®ä¾‹éƒ½æœ‰å®Œæ•´çš„æ•°æ®å‰¯æœ¬ã€‚

**åº”ç”¨åœºæ™¯ç†è§£**ï¼š
```
é€‚åˆåœºæ™¯ï¼š
âœ… é…ç½®ä¿¡æ¯è¡¨ï¼šæ‰€æœ‰å®ä¾‹éƒ½éœ€è¦å®Œæ•´é…ç½®
âœ… åœ°åŒºä»£ç è¡¨ï¼šæŸ¥è¯¢åœ°åŒºä¿¡æ¯
âœ… äº§å“ç›®å½•è¡¨ï¼šå•†å“åŸºç¡€ä¿¡æ¯
âœ… ç”¨æˆ·æƒé™è¡¨ï¼šæƒé™éªŒè¯

ä¸é€‚åˆåœºæ™¯ï¼š
âŒ å¤§æ•°æ®é‡è¡¨ï¼šä¼šå ç”¨å¤§é‡å†…å­˜
âŒ é¢‘ç¹æ›´æ–°è¡¨ï¼šç½‘ç»œä¼ è¾“å‹åŠ›å¤§
```

### 4.2 GlobalKTableåˆ›å»ºå’Œä½¿ç”¨


```java
// åˆ›å»ºGlobalKTable
GlobalKTable<String, Product> productTable = builder
    .globalTable("products", Consumed.with(Serdes.String(), productSerde));

// ä¸KStreamè¿æ¥
KStream<String, OrderWithProduct> enrichedOrders = orderStream
    .join(productTable,
        order -> order.getProductId(),  // è¿æ¥é”®æå–å™¨
        (order, product) -> new OrderWithProduct(order, product) // è¿æ¥ç»“æœ
    );
```

### 4.3 GlobalKTable vs KTable


| ç‰¹æ€§ | **KTable** | **GlobalKTable** |
|------|-----------|------------------|
| **æ•°æ®åˆ†å¸ƒ** | `åˆ†åŒºåˆ†å¸ƒï¼Œæ¯ä¸ªå®ä¾‹éƒ¨åˆ†æ•°æ®` | `å…¨å¤åˆ¶ï¼Œæ¯ä¸ªå®ä¾‹å…¨éƒ¨æ•°æ®` |
| **è¿æ¥æ–¹å¼** | `éœ€è¦ç›¸åŒåˆ†åŒºé”®` | `å¯ä»¥ä»»æ„é”®è¿æ¥` |
| **å†…å­˜å ç”¨** | `è¾ƒå°‘ï¼Œåªæœ‰éƒ¨åˆ†æ•°æ®` | `è¾ƒå¤šï¼Œå…¨éƒ¨æ•°æ®` |
| **é€‚ç”¨åœºæ™¯** | `å¤§æ•°æ®é‡è¡¨` | `å°æ•°æ®é‡å‚è€ƒè¡¨` |

---

## 5. ğŸ”§ StreamsBuilderæ„å»ºå™¨


### 5.1 StreamsBuilderæ ¸å¿ƒä½œç”¨


> ğŸ’¡ **StreamsBuilderç†è§£**ï¼šå°±åƒå»ºç­‘å¸ˆçš„å›¾çº¸ï¼Œç”¨æ¥è®¾è®¡æ•´ä¸ªæ•°æ®å¤„ç†çš„"æµæ°´çº¿è“å›¾"ã€‚

```java
// åˆ›å»ºæ„å»ºå™¨
StreamsBuilder builder = new StreamsBuilder();

// æ„å»ºæ‹“æ‰‘
KStream<String, String> sourceStream = builder.stream("input-topic");
sourceStream
    .filter((key, value) -> value.length() > 5)
    .mapValues(String::toUpperCase)
    .to("output-topic");

// ç”Ÿæˆæ‹“æ‰‘
Topology topology = builder.build();
```

### 5.2 å¸¸ç”¨æ„å»ºæ–¹æ³•


#### ğŸ”¸ æ•°æ®æºæ„å»º


```java
// æ„å»ºStreamæº
KStream<String, String> stream = builder.stream("topic-name");
KStream<String, String> multiStream = builder.stream(
    Arrays.asList("topic1", "topic2", "topic3"));

// æ„å»ºTableæº
KTable<String, String> table = builder.table("table-topic");

// æ„å»ºGlobalTableæº
GlobalKTable<String, String> globalTable = builder.globalTable("global-topic");
```

#### ğŸ”¸ æ•°æ®æ±‡æ„å»º


```java
// è¾“å‡ºåˆ°Topic
stream.to("output-topic");

// æ¡ä»¶è¾“å‡º
stream.to((key, value, recordContext) -> {
    if (value.contains("error")) {
        return "error-topic";
    }
    return "normal-topic";
});
```

### 5.3 StreamsBuilderæœ€ä½³å®è·µ


```java
public class OrderProcessingTopology {
    
    public static Topology buildTopology() {
        StreamsBuilder builder = new StreamsBuilder();
        
        // 1. å®šä¹‰æ•°æ®æº
        KStream<String, Order> orders = builder.stream("orders");
        KTable<String, Customer> customers = builder.table("customers");
        
        // 2. æ•°æ®å¤„ç†é€»è¾‘
        KStream<String, EnrichedOrder> enrichedOrders = orders
            .selectKey((key, order) -> order.getCustomerId())  // é‡æ–°åˆ†åŒº
            .join(customers, (order, customer) -> 
                new EnrichedOrder(order, customer));
        
        // 3. è¾“å‡ºç»“æœ
        enrichedOrders.to("enriched-orders");
        
        return builder.build();
    }
}
```

---

## 6. ğŸ—ï¸ Topologyæ‹“æ‰‘æ„å»º


### 6.1 Topologyæ¦‚å¿µç†è§£


> ğŸ’¡ **Topologyç†è§£**ï¼šæ‹“æ‰‘å°±æ˜¯æ•´ä¸ªæ•°æ®å¤„ç†æµç¨‹çš„"æ–½å·¥å›¾"ï¼Œå®šä¹‰äº†æ•°æ®æ€ä¹ˆæµåŠ¨å’Œå¤„ç†ã€‚

**æ‹“æ‰‘ç»“æ„å›¾ç¤º**ï¼š
```
SourceèŠ‚ç‚¹ â†’ ProcessorèŠ‚ç‚¹ â†’ SinkèŠ‚ç‚¹
    â†“           â†“            â†“
ä»Topicè¯»å–  â†’ ä¸šåŠ¡å¤„ç†é€»è¾‘ â†’ è¾“å‡ºåˆ°Topic
```

### 6.2 æ‹“æ‰‘æ„å»ºæ–¹å¼


#### ğŸ”¸ é«˜çº§APIæ„å»ºï¼ˆæ¨èï¼‰


```java
StreamsBuilder builder = new StreamsBuilder();

// ä½¿ç”¨é«˜çº§APIï¼Œè‡ªåŠ¨æ„å»ºæ‹“æ‰‘
builder.stream("input")
    .filter((k, v) -> v != null)
    .mapValues(String::toUpperCase)
    .to("output");

Topology topology = builder.build();
```

#### ğŸ”¸ ä½çº§APIæ„å»ºï¼ˆé«˜çº§ç”¨æ³•ï¼‰


```java
Topology topology = new Topology();

// æ‰‹åŠ¨æ·»åŠ èŠ‚ç‚¹
topology.addSource("source", "input-topic")
    .addProcessor("processor", () -> new UpperCaseProcessor(), "source")
    .addSink("sink", "output-topic", "processor");
```

### 6.3 æ‹“æ‰‘åˆ†æå’Œè°ƒè¯•


```java
// æ‰“å°æ‹“æ‰‘æè¿°
System.out.println(topology.describe());

// è¾“å‡ºç¤ºä¾‹ï¼š
// Topologies:
//    Sub-topology: 0
//     Source: KSTREAM-SOURCE-0000000000 (topics: [input-topic])
//       --> KSTREAM-FILTER-0000000001
//     Processor: KSTREAM-FILTER-0000000001 (stores: [])
//       --> KSTREAM-MAPVALUES-0000000002
//       <-- KSTREAM-SOURCE-0000000000
//     Sink: KSTREAM-SINK-0000000003 (topic: output-topic)
//       <-- KSTREAM-MAPVALUES-0000000002
```

---

## 7. ğŸŒŠ æµæ“ä½œè¯¦è§£


### 7.1 æœ‰çŠ¶æ€æ“ä½œ vs æ— çŠ¶æ€æ“ä½œ


**æ— çŠ¶æ€æ“ä½œ**ï¼š
- âœ… **ç‰¹ç‚¹**ï¼šæ¯æ¡è®°å½•ç‹¬ç«‹å¤„ç†ï¼Œä¸ä¾èµ–å…¶ä»–è®°å½•
- âœ… **ä¼˜åŠ¿**ï¼šç®€å•é«˜æ•ˆï¼Œæ˜“äºæ‰©å±•
- âœ… **ç¤ºä¾‹**ï¼šfilterã€mapã€flatMap

**æœ‰çŠ¶æ€æ“ä½œ**ï¼š
- âœ… **ç‰¹ç‚¹**ï¼šéœ€è¦è®°ä½ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯
- âœ… **ç”¨é€”**ï¼šèšåˆè®¡ç®—ã€çª—å£æ“ä½œã€è¿æ¥æ“ä½œ
- âœ… **ç¤ºä¾‹**ï¼šgroupByã€countã€join

### 7.2 èšåˆæ“ä½œè¯¦è§£


#### ğŸ”¸ ç®€å•èšåˆ


```java
// è¯é¢‘ç»Ÿè®¡
KTable<String, Long> wordCounts = textStream
    .flatMapValues(text -> Arrays.asList(text.split("\\s+")))
    .groupBy((key, word) -> word)
    .count();

// æ±‚å’Œèšåˆ
KTable<String, Integer> sumByKey = numberStream
    .groupByKey()
    .reduce(Integer::sum);
```

#### ğŸ”¸ è‡ªå®šä¹‰èšåˆ


```java
// è®¡ç®—å¹³å‡å€¼
KTable<String, Double> averages = scoreStream
    .groupByKey()
    .aggregate(
        () -> new ScoreAgg(0, 0),  // åˆå§‹å€¼ï¼š(æ€»åˆ†,æ•°é‡)
        (key, score, agg) -> agg.add(score),  // èšåˆå‡½æ•°
        Materialized.with(Serdes.String(), scoreAggSerde)
    )
    .mapValues(agg -> agg.getAverage());

// ScoreAggç±»å®šä¹‰
class ScoreAgg {
    private int totalScore;
    private int count;
    
    public ScoreAgg add(int score) {
        return new ScoreAgg(totalScore + score, count + 1);
    }
    
    public double getAverage() {
        return count == 0 ? 0 : (double) totalScore / count;
    }
}
```

### 7.3 çª—å£æ“ä½œ


#### ğŸ”¸ æ—¶é—´çª—å£ç±»å‹


```java
// æ»šåŠ¨çª—å£ï¼š5åˆ†é’Ÿä¸é‡å çª—å£
KTable<Windowed<String>, Long> tumblingCounts = clickStream
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(5)))
    .count();

// è·³è·ƒçª—å£ï¼š5åˆ†é’Ÿçª—å£ï¼Œæ¯1åˆ†é’Ÿå¼€å§‹ä¸€ä¸ª
KTable<Windowed<String>, Long> hoppingCounts = clickStream
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(5))
                          .advanceBy(Duration.ofMinutes(1)))
    .count();

// ä¼šè¯çª—å£ï¼š30ç§’æ— æ´»åŠ¨å°±å…³é—­çª—å£
KTable<Windowed<String>, Long> sessionCounts = clickStream
    .groupByKey()
    .windowedBy(SessionWindows.with(Duration.ofSeconds(30)))
    .count();
```

---

## 8. ğŸ“Š è¡¨æ“ä½œè¯¦è§£


### 8.1 KTableèšåˆç‰¹ç‚¹


> âš ï¸ **é‡è¦ç†è§£**ï¼šKTableçš„èšåˆæ˜¯**å¢é‡æ›´æ–°**çš„ï¼Œå½“åŸæ•°æ®å˜åŒ–æ—¶ï¼Œèšåˆç»“æœä¹Ÿä¼šè‡ªåŠ¨æ›´æ–°ã€‚

```java
// ç”¨æˆ·è¡¨æ›´æ–°ç¤ºä¾‹
KTable<String, User> users = builder.table("users");

// æŒ‰éƒ¨é—¨ç»Ÿè®¡äººæ•°
KTable<String, Long> deptCounts = users
    .groupBy((userId, user) -> KeyValue.pair(user.getDepartment(), user))
    .count();

// å½“ç”¨æˆ·è¡¨æ›´æ–°æ—¶ï¼š
// 1. ç”¨æˆ·Aä»"æŠ€æœ¯éƒ¨"è½¬åˆ°"é”€å”®éƒ¨"
// 2. deptCountsä¼šè‡ªåŠ¨æ›´æ–°ï¼šæŠ€æœ¯éƒ¨-1ï¼Œé”€å”®éƒ¨+1
```

### 8.2 KTableè¿æ¥æ“ä½œ


#### ğŸ”¸ å†…è¿æ¥


```java
// ç”¨æˆ·è¡¨ å†…è¿æ¥ è®¢å•è¡¨
KTable<String, UserOrder> userOrders = userTable
    .join(orderTable,
        (user, order) -> new UserOrder(user, order)  // è¿æ¥ç»“æœ
    );
// åªæœ‰åœ¨ä¸¤ä¸ªè¡¨ä¸­éƒ½å­˜åœ¨çš„keyæ‰ä¼šå‡ºç°åœ¨ç»“æœä¸­
```

#### ğŸ”¸ å·¦è¿æ¥


```java
// ç”¨æˆ·è¡¨ å·¦è¿æ¥ VIPä¿¡æ¯è¡¨
KTable<String, UserWithVip> usersWithVip = userTable
    .leftJoin(vipTable,
        (user, vip) -> new UserWithVip(user, vip)  // vipå¯èƒ½ä¸ºnull
    );
// æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå‡ºç°ï¼Œæ²¡æœ‰VIPä¿¡æ¯çš„vipå­—æ®µä¸ºnull
```

### 8.3 KTableç‰©åŒ–è§†å›¾


```java
// åˆ›å»ºç‰©åŒ–è§†å›¾ï¼Œå¯ä»¥æŸ¥è¯¢çŠ¶æ€
KTable<String, Long> wordCounts = textStream
    .flatMapValues(text -> Arrays.asList(text.split("\\s+")))
    .groupBy((key, word) -> word)
    .count(Materialized.<String, Long, KeyValueStore<Bytes, byte[]>>as("word-counts-store")
           .withValueSerde(Serdes.Long()));

// åœ¨åº”ç”¨ä¸­æŸ¥è¯¢çŠ¶æ€
ReadOnlyKeyValueStore<String, Long> store = streams
    .store("word-counts-store", QueryableStoreTypes.keyValueStore());
Long count = store.get("hello");  // æŸ¥è¯¢"hello"çš„å‡ºç°æ¬¡æ•°
```

---

## 9. ğŸ”— è¿æ¥æ“ä½œè¯¦è§£


### 9.1 Stream-Streamè¿æ¥


> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šä¸¤ä¸ªæµçš„è¿æ¥éœ€è¦åœ¨**æ—¶é—´çª—å£**å†…è¿›è¡Œï¼Œå› ä¸ºæµæ˜¯æ— ç•Œçš„ã€‚

```java
// ç”¨æˆ·ç‚¹å‡»æµ è¿æ¥ ç”¨æˆ·è´­ä¹°æµ
KStream<String, ClickPurchase> clickPurchases = clickStream
    .join(purchaseStream,
        (click, purchase) -> new ClickPurchase(click, purchase),  // è¿æ¥é€»è¾‘
        JoinWindows.of(Duration.ofMinutes(5)),  // 5åˆ†é’Ÿæ—¶é—´çª—å£
        StreamJoined.with(Serdes.String(), clickSerde, purchaseSerde)
    );
```

**è¿æ¥çª—å£å›¾ç¤º**ï¼š
```
æ—¶é—´è½´ï¼š     1åˆ†é’Ÿ   2åˆ†é’Ÿ   3åˆ†é’Ÿ   4åˆ†é’Ÿ   5åˆ†é’Ÿ   6åˆ†é’Ÿ
ç‚¹å‡»äº‹ä»¶ï¼š      A               B               C
è´­ä¹°äº‹ä»¶ï¼š              X               Y
è¿æ¥ç»“æœï¼š              AX              BY

è¯´æ˜ï¼šäº‹ä»¶Aå’ŒXåœ¨5åˆ†é’Ÿçª—å£å†…ï¼Œå¯ä»¥è¿æ¥
      äº‹ä»¶Bå’ŒYåœ¨5åˆ†é’Ÿçª—å£å†…ï¼Œå¯ä»¥è¿æ¥
      äº‹ä»¶Cæš‚æ—¶æ²¡æœ‰åŒ¹é…çš„è´­ä¹°äº‹ä»¶
```

### 9.2 Stream-Tableè¿æ¥


```java
// è®¢å•æµ è¿æ¥ ç”¨æˆ·è¡¨ï¼ˆæŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ï¼‰
KStream<String, OrderWithUser> enrichedOrders = orderStream
    .selectKey((key, order) -> order.getUserId())  // é‡æ–°è®¾ç½®è¿æ¥é”®
    .join(userTable,
        (order, user) -> new OrderWithUser(order, user)
    );
```

> ğŸ“ **æ³¨æ„**ï¼šStream-Tableè¿æ¥ä¸­ï¼ŒStreamçš„æ¯æ¡è®°å½•éƒ½ä¼šä¸Tableçš„å½“å‰çŠ¶æ€è¿›è¡Œè¿æ¥ã€‚

### 9.3 Table-Tableè¿æ¥


```java
// ç”¨æˆ·è¡¨ è¿æ¥ åœ°å€è¡¨
KTable<String, UserWithAddress> usersWithAddress = userTable
    .join(addressTable,
        (user, address) -> new UserWithAddress(user, address)
    );

// å½“ä»»ä¸€è¡¨æ›´æ–°æ—¶ï¼Œè¿æ¥ç»“æœä¹Ÿä¼šæ›´æ–°
```

### 9.4 è¿æ¥æ“ä½œæ€»ç»“è¡¨


| è¿æ¥ç±»å‹ | **ç‰¹ç‚¹** | **ä½¿ç”¨åœºæ™¯** | **æ³¨æ„äº‹é¡¹** |
|---------|---------|-------------|-------------|
| **Stream-Stream** | `éœ€è¦æ—¶é—´çª—å£` | `äº‹ä»¶å…³è”åˆ†æ` | `è®¾ç½®åˆé€‚çš„çª—å£å¤§å°` |
| **Stream-Table** | `æµæŸ¥è¡¨è¡¥å……ä¿¡æ¯` | `æ•°æ®å¢å¼º` | `ç¡®ä¿è¿æ¥é”®åŒ¹é…` |
| **Table-Table** | `çŠ¶æ€è¡¨è¿æ¥` | `ç»´åº¦è¡¨å…³è”` | `ä¸¤è¡¨éƒ½ä¼šè§¦å‘æ›´æ–°` |

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸‰å¤§æŠ½è±¡ï¼šKStream(æµ)ã€KTable(è¡¨)ã€GlobalKTable(å…¨å±€è¡¨)
ğŸ”¸ æ„å»ºå·¥å…·ï¼šStreamsBuilderæ„å»ºæ‹“æ‰‘ï¼ŒTopologyå®šä¹‰å¤„ç†é€»è¾‘
ğŸ”¸ æ“ä½œåˆ†ç±»ï¼šæ— çŠ¶æ€æ“ä½œ(filter/map) vs æœ‰çŠ¶æ€æ“ä½œ(èšåˆ/è¿æ¥)
ğŸ”¸ è¿æ¥æ–¹å¼ï¼šæµæµè¿æ¥ã€æµè¡¨è¿æ¥ã€è¡¨è¡¨è¿æ¥çš„é€‚ç”¨åœºæ™¯
ğŸ”¸ çª—å£æ¦‚å¿µï¼šæ»šåŠ¨çª—å£ã€è·³è·ƒçª—å£ã€ä¼šè¯çª—å£çš„ä½¿ç”¨
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ KStream vs KTableçš„æœ¬è´¨åŒºåˆ«**ï¼š
```
KStreamï¼šäº‹ä»¶æ—¥å¿—æ€ç»´
- æ¯æ¡è®°å½•éƒ½æ˜¯ä¸€ä¸ªäº‹ä»¶
- æ‰€æœ‰å†å²è®°å½•éƒ½ä¿ç•™
- é€‚åˆè¡Œä¸ºåˆ†æã€å®¡è®¡æ—¥å¿—

KTableï¼šæ•°æ®åº“è¡¨æ€ç»´  
- æ¯æ¡è®°å½•æ˜¯å½“å‰çŠ¶æ€
- æ–°è®°å½•è¦†ç›–æ—§è®°å½•
- é€‚åˆç”¨æˆ·æ¡£æ¡ˆã€é…ç½®ä¿¡æ¯
```

**ğŸ”¹ çŠ¶æ€ç®¡ç†çš„é‡è¦æ€§**ï¼š
```
æ— çŠ¶æ€æ“ä½œï¼š
- ç®€å•å¿«é€Ÿï¼Œæ˜“äºæ‰©å±•
- æ¯æ¡è®°å½•ç‹¬ç«‹å¤„ç†
- å¦‚ï¼šè¿‡æ»¤ã€æ ¼å¼è½¬æ¢

æœ‰çŠ¶æ€æ“ä½œï¼š
- éœ€è¦è®°ä½å†å²ä¿¡æ¯
- æ¶‰åŠçŠ¶æ€å­˜å‚¨å’Œæ¢å¤
- å¦‚ï¼šèšåˆç»Ÿè®¡ã€çª—å£è®¡ç®—
```

**ğŸ”¹ è¿æ¥æ“ä½œçš„é€‰æ‹©ç­–ç•¥**ï¼š
```
é€‰æ‹©åŸåˆ™ï¼š
Stream-Stream â†’ åˆ†æä¸¤ä¸ªäº‹ä»¶æµçš„å…³è”
Stream-Table  â†’ ç”¨å‚è€ƒæ•°æ®å¢å¼ºæµæ•°æ®  
Table-Table   â†’ è¿æ¥ä¸¤ä¸ªç»´åº¦è¡¨

æ—¶é—´çª—å£ï¼š
åªæœ‰Stream-Streamè¿æ¥éœ€è¦æ—¶é—´çª—å£
å…¶ä»–è¿æ¥ä½¿ç”¨å½“å‰çŠ¶æ€å³å¯
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šKStreamå¤„ç†ç‚¹å‡»æµï¼Œç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦
- **å®æ—¶ç›‘æ§**ï¼šKTableç»´æŠ¤ç³»ç»ŸçŠ¶æ€ï¼ŒKStreamå¤„ç†å‘Šè­¦äº‹ä»¶
- **æ•°æ®å¢å¼º**ï¼šStream-Tableè¿æ¥è¡¥å……ç”¨æˆ·ä¿¡æ¯
- **äº‹ä»¶å…³è”**ï¼šStream-Streamè¿æ¥åˆ†æç”¨æˆ·è·¯å¾„

**ğŸ”§ å¼€å‘æœ€ä½³å®è·µ**ï¼š
```java
// 1. æ˜ç¡®æ•°æ®è¯­ä¹‰
KStream<String, ClickEvent> clicks = builder.stream("clicks");  // äº‹ä»¶æµ
KTable<String, UserProfile> users = builder.table("users");    // çŠ¶æ€è¡¨

// 2. åˆç†è®¾è®¡è¿æ¥é”®
KStream<String, EnrichedClick> enriched = clicks
    .selectKey((key, click) -> click.getUserId())  // é‡è®¾é”®ç”¨äºè¿æ¥
    .join(users, (click, user) -> new EnrichedClick(click, user));

// 3. é€‚å½“è®¾ç½®çª—å£
KTable<Windowed<String>, Long> counts = clicks
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(5)))  // 5åˆ†é’Ÿæ»šåŠ¨çª—å£
    .count();
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Streamsä¸‰å¤§æŠ½è±¡ï¼šæµè¡¨å…¨å±€è¡¨ï¼Œå„æœ‰å„ç”¨é€”
- æ„å»ºå™¨ç”»è“å›¾ï¼šStreamsBuilderå®šæ‹“æ‰‘
- çŠ¶æ€å¾ˆé‡è¦ï¼šèšåˆè¿æ¥è¦çŠ¶æ€ï¼Œè¿‡æ»¤æ˜ å°„ä¸éœ€è¦
- è¿æ¥æœ‰çª—å£ï¼šæµæµè¿æ¥è®¾æ—¶é—´ï¼Œå…¶ä»–è¿æ¥çœ‹å½“å‰
- å®æ—¶èƒ½æ›´æ–°ï¼šKTableå˜åŒ–ä¼šä¼ æ’­ï¼Œèšåˆç»“æœè‡ªåŠ¨æ›´æ–°