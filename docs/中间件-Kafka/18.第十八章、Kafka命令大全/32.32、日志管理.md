---
title: 32ã€æ—¥å¿—ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Kafkaæ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-kafkaæ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [ä¼˜é›…åœæœºä¸å¯åŠ¨ç®¡ç†](#2-ä¼˜é›…åœæœºä¸å¯åŠ¨ç®¡ç†)
3. [Log4jæ—¥å¿—çº§åˆ«è°ƒæ•´](#3-log4jæ—¥å¿—çº§åˆ«è°ƒæ•´)
4. [æ—¥å¿—è½®è½¬é…ç½®è¯¦è§£](#4-æ—¥å¿—è½®è½¬é…ç½®è¯¦è§£)
5. [æ—¥å¿—æ–‡ä»¶å‹ç¼©ç®¡ç†](#5-æ—¥å¿—æ–‡ä»¶å‹ç¼©ç®¡ç†)
6. [æ—¥å¿—æ¸…ç†ç­–ç•¥é…ç½®](#6-æ—¥å¿—æ¸…ç†ç­–ç•¥é…ç½®)
7. [é”™è¯¯æ—¥å¿—åˆ†ææŠ€å·§](#7-é”™è¯¯æ—¥å¿—åˆ†ææŠ€å·§)
8. [æ€§èƒ½æ—¥å¿—æ”¶é›†å®è·µ](#8-æ€§èƒ½æ—¥å¿—æ”¶é›†å®è·µ)
9. [å®¡è®¡æ—¥å¿—ç®¡ç†](#9-å®¡è®¡æ—¥å¿—ç®¡ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ Kafkaæ—¥å¿—ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Kafkaæ—¥å¿—ç®¡ç†

ğŸ¯ **ç®€å•ç†è§£**ï¼šKafkaæ—¥å¿—ç®¡ç†å°±åƒç®¡ç†ä¸€ä¸ªå·¨å¤§å›¾ä¹¦é¦†çš„å€Ÿé˜…è®°å½•

```
ç”Ÿæ´»ä¸­çš„å›¾ä¹¦é¦†ç®¡ç†ï¼š
ğŸ“š å€Ÿä¹¦è®°å½• â†’ Kafkaæ•°æ®æ—¥å¿—
ğŸ“ ç®¡ç†å‘˜æ—¥å¿— â†’ Kafkaè¿è¡Œæ—¥å¿—
ğŸ—‚ï¸ åˆ†ç±»æ•´ç† â†’ æ—¥å¿—åˆ†çº§ç®¡ç†
ğŸ§¹ å®šæœŸæ¸…ç† â†’ æ—¥å¿—æ¸…ç†ç­–ç•¥
```

**ğŸ”¸ Kafkaä¸­çš„ä¸¤ç§æ—¥å¿—ç±»å‹**

**æ•°æ®æ—¥å¿—ï¼ˆData Logsï¼‰**ï¼š
- **ä½œç”¨**ï¼šå­˜å‚¨å®é™…çš„æ¶ˆæ¯æ•°æ®
- **ä½ç½®**ï¼š`/var/kafka-logs/` ç›®å½•ä¸‹
- **ç‰¹ç‚¹**ï¼šæŒ‰Topicå’ŒPartitionåˆ†å¼€å­˜å‚¨
- **é‡è¦æ€§**ï¼šè¿™æ˜¯Kafkaçš„æ ¸å¿ƒï¼Œå­˜å‚¨ç€æ‰€æœ‰ä¸šåŠ¡æ•°æ®

**è¿è¡Œæ—¥å¿—ï¼ˆServer Logsï¼‰**ï¼š
- **ä½œç”¨**ï¼šè®°å½•KafkaæœåŠ¡å™¨çš„è¿è¡ŒçŠ¶æ€
- **ä½ç½®**ï¼šé€šå¸¸åœ¨ `/var/log/kafka/` æˆ– `logs/` ç›®å½•
- **ç‰¹ç‚¹**ï¼šåŒ…å«å¯åŠ¨ã€é”™è¯¯ã€æ€§èƒ½ç­‰ä¿¡æ¯
- **é‡è¦æ€§**ï¼šç”¨äºæ•…éšœæ’æŸ¥å’Œæ€§èƒ½ç›‘æ§

### 1.2 æ—¥å¿—ç®¡ç†çš„é‡è¦æ€§

**ğŸš¨ ä¸ºä»€ä¹ˆæ—¥å¿—ç®¡ç†å¦‚æ­¤é‡è¦**

```
ä¸šåŠ¡è¿ç»­æ€§ä¿éšœï¼š
- åŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜
- é˜²æ­¢ç£ç›˜ç©ºé—´çˆ†æ»¡
- ä¿è¯æœåŠ¡ç¨³å®šè¿è¡Œ

æ€§èƒ½ä¼˜åŒ–ä¾æ®ï¼š
- åˆ†ææ€§èƒ½ç“¶é¢ˆ
- ä¼˜åŒ–é…ç½®å‚æ•°
- å®¹é‡è§„åˆ’å†³ç­–

åˆè§„å®¡è®¡è¦æ±‚ï¼š
- è®°å½•æ“ä½œè½¨è¿¹
- æ»¡è¶³å®¡è®¡è¦æ±‚
- æ•°æ®å®‰å…¨ä¿éšœ
```

### 1.3 æ—¥å¿—ç®¡ç†çš„åŸºæœ¬åŸåˆ™

**ğŸ“ æ—¥å¿—ç®¡ç†æœ€ä½³å®è·µåŸåˆ™**

**ğŸŸ¢ é€‚åº¦åŸåˆ™**ï¼šæ—¢è¦æœ‰è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œåˆä¸èƒ½è¿‡äºå†—ä½™
**ğŸŸ¡ åˆ†çº§åŸåˆ™**ï¼šä¸åŒé‡è¦ç¨‹åº¦çš„ä¿¡æ¯ç”¨ä¸åŒçº§åˆ«
**ğŸ”´ å®‰å…¨åŸåˆ™**ï¼šæ•æ„Ÿä¿¡æ¯ä¸è®°å½•åœ¨æ—¥å¿—ä¸­
**âš« æ€§èƒ½åŸåˆ™**ï¼šæ—¥å¿—è®°å½•ä¸èƒ½å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½

---

## 2. ğŸ›‘ ä¼˜é›…åœæœºä¸å¯åŠ¨ç®¡ç†


### 2.1 ä»€ä¹ˆæ˜¯ä¼˜é›…åœæœº

ğŸ¯ **é€šä¿—è§£é‡Š**ï¼šä¼˜é›…åœæœºå°±åƒç¤¼è²Œåœ°å‘Šåˆ«ï¼Œè€Œä¸æ˜¯çªç„¶æ¶ˆå¤±

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ç²—æš´å…³æœº = çªç„¶æŒ‚æ–­ç”µè¯ â†’ å¯¹æ–¹ä¸çŸ¥é“å‘ç”Ÿä»€ä¹ˆ
ä¼˜é›…åœæœº = è¯´"å†è§"åæŒ‚ç”µè¯ â†’ åŒæ–¹éƒ½æ¸…æ¥šé€šè¯ç»“æŸ

Kafkaä¸­çš„è¡¨ç°ï¼š
ç²—æš´åœæœºï¼šç›´æ¥ kill -9 â†’ å¯èƒ½ä¸¢å¤±æ•°æ®ï¼Œå½±å“å…¶ä»–èŠ‚ç‚¹
ä¼˜é›…åœæœºï¼šä½¿ç”¨ä¸“ç”¨è„šæœ¬ â†’ å®‰å…¨ä¿å­˜æ•°æ®ï¼Œé€šçŸ¥å…¶ä»–èŠ‚ç‚¹
```

### 2.2 ä¼˜é›…åœæœºæ“ä½œè¯¦è§£

**ğŸ”§ ä½¿ç”¨kafka-server-stop.shæ­£ç¡®åœæœº**

```bash
# æ ‡å‡†çš„ä¼˜é›…åœæœºå‘½ä»¤
./kafka-server-stop.sh

# å¦‚æœéœ€è¦å¼ºåˆ¶åœæœºï¼ˆä¸æ¨èï¼Œé™¤éç´§æ€¥æƒ…å†µï¼‰
./kafka-server-stop.sh --force
```

**ğŸ” ä¼˜é›…åœæœºçš„å†…éƒ¨è¿‡ç¨‹**
```
æ­¥éª¤1ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚
- Kafkaä¸å†æ¥å—æ–°çš„ç”Ÿäº§è€…è¿æ¥
- ç°æœ‰è¿æ¥ç»§ç»­å¤„ç†å®Œå½“å‰è¯·æ±‚

æ­¥éª¤2ï¼šå®Œæˆæ­£åœ¨å¤„ç†çš„è¯·æ±‚
- ç­‰å¾…æ‰€æœ‰æ­£åœ¨å†™å…¥çš„æ¶ˆæ¯å®Œæˆ
- ç¡®ä¿æ•°æ®å®Œæ•´æ€§

æ­¥éª¤3ï¼šä¿å­˜çŠ¶æ€ä¿¡æ¯
- å°†å†…å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜
- ä¿å­˜åç§»é‡ç­‰å…ƒæ•°æ®

æ­¥éª¤4ï¼šé€šçŸ¥é›†ç¾¤å…¶ä»–èŠ‚ç‚¹
- å‘ŠçŸ¥å…¶ä»–Brokerè‡ªå·±å³å°†ä¸‹çº¿
- è§¦å‘å¿…è¦çš„é‡æ–°å¹³è¡¡

æ­¥éª¤5ï¼šå®‰å…¨å…³é—­
- å…³é—­æ‰€æœ‰ç½‘ç»œè¿æ¥
- é‡Šæ”¾ç³»ç»Ÿèµ„æº
```

### 2.3 å¯åŠ¨æ£€æŸ¥ä¸æ—¥å¿—ç›‘æ§

**âœ… å¯åŠ¨æ—¶çš„å…³é”®æ£€æŸ¥ç‚¹**

```bash
# å¯åŠ¨KafkaæœåŠ¡
./kafka-server-start.sh ../config/server.properties

# å¯åŠ¨åç«‹å³æ£€æŸ¥å…³é”®æŒ‡æ ‡
echo "æ£€æŸ¥Kafkaæ˜¯å¦æˆåŠŸå¯åŠ¨..."

# 1. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿è¡Œ
ps aux | grep kafka

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tlnp | grep :9092

# 3. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
tail -f logs/server.log
```

**ğŸ“Š å¯åŠ¨æˆåŠŸçš„æ ‡å¿—**
```
æ­£å¸¸å¯åŠ¨æ—¥å¿—å…³é”®è¯ï¼š
âœ… "started (kafka.server.KafkaServer)"
âœ… "Awaiting socket connections on 0.0.0.0:9092"
âœ… "kafka.coordinator.group.GroupCoordinator"

å¯åŠ¨å¤±è´¥çš„è­¦å‘Šä¿¡å·ï¼š
âŒ "FATAL" çº§åˆ«æ—¥å¿—
âŒ "Address already in use" 
âŒ "OutOfMemoryError"
âŒ "Connection refused"
```

### 2.4 å¯åŠ¨å¤±è´¥å¸¸è§é—®é¢˜è§£å†³

**ğŸš¨ æ–°æ‰‹å¸¸é‡åˆ°çš„å¯åŠ¨é—®é¢˜**

**é—®é¢˜1ï¼šç«¯å£è¢«å ç”¨**
```bash
# ç°è±¡ï¼šå¯åŠ¨æ—¶æç¤ºç«¯å£å·²è¢«ä½¿ç”¨
# è§£å†³æ–¹æ³•ï¼š
lsof -i :9092  # æŸ¥çœ‹è°åœ¨ä½¿ç”¨ç«¯å£
kill -9 <è¿›ç¨‹ID>  # æ€æ‰å ç”¨ç«¯å£çš„è¿›ç¨‹
```

**é—®é¢˜2ï¼šå†…å­˜ä¸è¶³**
```bash
# ç°è±¡ï¼šå¯åŠ¨æ—¶å‡ºç°OutOfMemoryError
# è§£å†³æ–¹æ³•ï¼šè°ƒæ•´JVMå †å†…å­˜å¤§å°
export KAFKA_HEAP_OPTS="-Xmx1G -Xms1G"
```

**é—®é¢˜3ï¼šé…ç½®æ–‡ä»¶é”™è¯¯**
```bash
# ç°è±¡ï¼šå¯åŠ¨å¤±è´¥ï¼Œæç¤ºé…ç½®é”™è¯¯
# è§£å†³æ–¹æ³•ï¼šæ£€æŸ¥server.propertiesæ–‡ä»¶
grep -v "^#" server.properties | grep -v "^$"  # æŸ¥çœ‹éæ³¨é‡Šé…ç½®
```

---

## 3. ğŸ“ Log4jæ—¥å¿—çº§åˆ«è°ƒæ•´


### 3.1 ç†è§£Log4jæ—¥å¿—çº§åˆ«

ğŸ¯ **ç®€å•ç±»æ¯”**ï¼šæ—¥å¿—çº§åˆ«å°±åƒåŒ»é™¢çš„ç—…æƒ…åˆ†çº§

```
åŒ»é™¢ç—…æƒ…åˆ†çº§      â†’    Log4jæ—¥å¿—çº§åˆ«
ğŸš¨ æ€¥è¯Š(ç´§æ€¥)     â†’    FATAL (è‡´å‘½é”™è¯¯)
ğŸ”´ ä½é™¢(ä¸¥é‡)     â†’    ERROR (é”™è¯¯)
ğŸŸ¡ é—¨è¯Š(æ³¨æ„)     â†’    WARN  (è­¦å‘Š)
ğŸŸ¢ ä½“æ£€(æ­£å¸¸)     â†’    INFO  (ä¿¡æ¯)
âšª æ£€æŸ¥(è¯¦ç»†)     â†’    DEBUG (è°ƒè¯•)
âš« å…¨é¢(æœ€è¯¦ç»†)   â†’    TRACE (è¿½è¸ª)
```

### 3.2 Log4jé…ç½®æ–‡ä»¶è¯¦è§£

**ğŸ”§ ç†è§£log4j.propertiesé…ç½®**

Kafkaçš„æ—¥å¿—é…ç½®æ–‡ä»¶é€šå¸¸ä½äº `config/log4j.properties`ï¼š

```bash
# æŸ¥çœ‹å½“å‰çš„æ—¥å¿—é…ç½®
cat config/log4j.properties
```

**ğŸ“‹ å…³é”®é…ç½®é¡¹è§£é‡Š**
```
# æ ¹æ—¥å¿—çº§åˆ«è®¾ç½®ï¼ˆå…¨å±€é»˜è®¤ï¼‰
log4j.rootLogger=INFO, stdout, kafkaAppender

# Kafkaç‰¹å®šç»„ä»¶çš„æ—¥å¿—çº§åˆ«
log4j.logger.kafka=INFO                    # Kafkaæ ¸å¿ƒæ—¥å¿—
log4j.logger.kafka.network.RequestChannel=WARN  # ç½‘ç»œè¯·æ±‚æ—¥å¿—
log4j.logger.kafka.producer.async.DefaultEventHandler=DEBUG  # ç”Ÿäº§è€…æ—¥å¿—
log4j.logger.kafka.request.logger=WARN     # è¯·æ±‚æ—¥å¿—
log4j.logger.kafka.controller=TRACE        # æ§åˆ¶å™¨æ—¥å¿—

# è¾“å‡ºé…ç½®
log4j.appender.stdout=org.apache.log4j.ConsoleAppender  # æ§åˆ¶å°è¾“å‡º
log4j.appender.kafkaAppender=org.apache.log4j.DailyRollingFileAppender  # æ–‡ä»¶è¾“å‡º
```

### 3.3 åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«

**âš¡ ä¸é‡å¯æœåŠ¡è°ƒæ•´æ—¥å¿—çº§åˆ«**

Kafkaæ”¯æŒé€šè¿‡JMXåœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼š

```bash
# ä½¿ç”¨JConsoleæˆ–JMXå·¥å…·è¿æ¥åˆ°Kafka
# æˆ–è€…ä½¿ç”¨Kafkaæä¾›çš„å·¥å…·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰

# æŸ¥çœ‹å½“å‰æ—¥å¿—çº§åˆ«
kafka-configs.sh --bootstrap-server localhost:9092 \
  --entity-type broker-loggers \
  --entity-name 0 \
  --describe
```

**ğŸ› ï¸ ä¸´æ—¶è°ƒæ•´ç¤ºä¾‹**
```bash
# ä¸ºäº†è°ƒè¯•é—®é¢˜ï¼Œä¸´æ—¶å¼€å¯DEBUGçº§åˆ«
# ä¿®æ”¹log4j.propertiesæ–‡ä»¶
sed -i 's/log4j.logger.kafka=INFO/log4j.logger.kafka=DEBUG/' config/log4j.properties

# å‘Kafkaè¿›ç¨‹å‘é€ä¿¡å·é‡æ–°åŠ è½½é…ç½®ï¼ˆæŸäº›ç‰ˆæœ¬æ”¯æŒï¼‰
kill -HUP <kafka-pid>
```

### 3.4 é’ˆå¯¹æ€§æ—¥å¿—çº§åˆ«ç­–ç•¥

**ğŸ¯ ä¸åŒåœºæ™¯ä¸‹çš„æ—¥å¿—çº§åˆ«å»ºè®®**

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```
# è¿½æ±‚æ€§èƒ½å’Œç¨³å®šæ€§
log4j.rootLogger=WARN, kafkaAppender
log4j.logger.kafka=INFO
log4j.logger.kafka.controller=INFO
log4j.logger.kafka.coordinator.group=INFO
```

**å¼€å‘æµ‹è¯•ç¯å¢ƒ**ï¼š
```
# éœ€è¦è¯¦ç»†ä¿¡æ¯ä¾¿äºè°ƒè¯•
log4j.rootLogger=DEBUG, stdout, kafkaAppender
log4j.logger.kafka=DEBUG
log4j.logger.kafka.controller=DEBUG
```

**æ•…éšœæ’æŸ¥æ—¶**ï¼š
```
# ä¸´æ—¶å¼€å¯è¯¦ç»†æ—¥å¿—
log4j.logger.kafka.network=DEBUG
log4j.logger.kafka.coordinator=DEBUG
log4j.logger.kafka.controller=TRACE
```

---

## 4. ğŸ”„ æ—¥å¿—è½®è½¬é…ç½®è¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šæ—¥å¿—è½®è½¬å°±åƒå®šæœŸæ›´æ¢æ—¥è®°æœ¬

```
ä¼ ç»Ÿæ—¥è®°æ–¹å¼ï¼š
ä¸€æœ¬æ—¥è®°å†™åˆ°åº• â†’ æ—¥è®°æœ¬è¶Šæ¥è¶Šåš â†’ æœ€ç»ˆæ— æ³•æºå¸¦

è½®è½¬æ—¥è®°æ–¹å¼ï¼š
æŒ‰æœˆæ›´æ¢æ—¥è®°æœ¬ â†’ æ¯æœ¬åšåº¦åˆç† â†’ æ—§æ—¥è®°æœ¬å¯ä»¥å­˜æ¡£æˆ–ä¸¢å¼ƒ

æ—¥å¿—è½®è½¬åŒç†ï¼š
å•ä¸ªæ—¥å¿—æ–‡ä»¶ â†’ æ–‡ä»¶æ— é™å¢é•¿ â†’ ç£ç›˜ç©ºé—´è€—å°½
è½®è½¬æ—¥å¿—æ–‡ä»¶ â†’ å®šæœŸåˆ›å»ºæ–°æ–‡ä»¶ â†’ æ—§æ–‡ä»¶å¯ä»¥å‹ç¼©æˆ–åˆ é™¤
```

### 4.2 Log4jæ—¥å¿—è½®è½¬é…ç½®

**âš™ï¸ DailyRollingFileAppenderé…ç½®**

```bash
# æŒ‰æ—¥æœŸè½®è½¬çš„é…ç½®ç¤ºä¾‹
log4j.appender.kafkaAppender=org.apache.log4j.DailyRollingFileAppender
log4j.appender.kafkaAppender.DatePattern='.'yyyy-MM-dd-HH
log4j.appender.kafkaAppender.File=${kafka.logs.dir}/server.log
log4j.appender.kafkaAppender.layout=org.apache.log4j.PatternLayout
log4j.appender.kafkaAppender.layout.ConversionPattern=[%d] %p %m (%c)%n
```

**ğŸ“… è½®è½¬æ¨¡å¼è¯´æ˜**
```
è½®è½¬é¢‘ç‡é…ç½®ï¼š
'.'yyyy-MM-dd      â†’ æ¯å¤©è½®è½¬ä¸€æ¬¡
'.'yyyy-MM-dd-HH   â†’ æ¯å°æ—¶è½®è½¬ä¸€æ¬¡  
'.'yyyy-MM         â†’ æ¯æœˆè½®è½¬ä¸€æ¬¡
'.'yyyy-ww         â†’ æ¯å‘¨è½®è½¬ä¸€æ¬¡
```

### 4.3 åŸºäºæ–‡ä»¶å¤§å°çš„è½®è½¬

**ğŸ“ RollingFileAppenderé…ç½®**

```bash
# æŒ‰æ–‡ä»¶å¤§å°è½®è½¬çš„é…ç½®
log4j.appender.kafkaAppender=org.apache.log4j.RollingFileAppender
log4j.appender.kafkaAppender.File=${kafka.logs.dir}/server.log
log4j.appender.kafkaAppender.MaxFileSize=100MB
log4j.appender.kafkaAppender.MaxBackupIndex=10
log4j.appender.kafkaAppender.layout=org.apache.log4j.PatternLayout
```

**ğŸ”¢ å‚æ•°å«ä¹‰**
```
MaxFileSize=100MB     â†’ å•ä¸ªæ–‡ä»¶æœ€å¤§100MB
MaxBackupIndex=10     â†’ æœ€å¤šä¿ç•™10ä¸ªå¤‡ä»½æ–‡ä»¶

æ–‡ä»¶å‘½åè§„å¾‹ï¼š
server.log           â†’ å½“å‰æ—¥å¿—æ–‡ä»¶
server.log.1         â†’ æœ€è¿‘çš„å¤‡ä»½
server.log.2         â†’ æ¬¡æ–°çš„å¤‡ä»½
...
server.log.10        â†’ æœ€è€çš„å¤‡ä»½ï¼ˆè¶…å‡ºä¼šè¢«åˆ é™¤ï¼‰
```

### 4.4 ç³»ç»Ÿçº§æ—¥å¿—è½®è½¬ï¼ˆlogrotateï¼‰

**ğŸ› ï¸ ä½¿ç”¨Linuxç³»ç»Ÿçš„logrotate**

åˆ›å»ºKafkaä¸“ç”¨çš„logrotateé…ç½®ï¼š

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo tee /etc/logrotate.d/kafka << EOF
/var/log/kafka/*.log {
    daily                    # æ¯å¤©è½®è½¬
    missingok               # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    rotate 30               # ä¿ç•™30å¤©
    compress                # å‹ç¼©æ—§æ–‡ä»¶
    delaycompress           # å»¶è¿Ÿä¸€å¤©å‹ç¼©
    notifempty              # ç©ºæ–‡ä»¶ä¸è½®è½¬
    create 644 kafka kafka  # åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™å’Œæ‰€æœ‰è€…
    postrotate              # è½®è½¬åæ‰§è¡Œçš„å‘½ä»¤
        /bin/kill -HUP `cat /var/run/kafka.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
EOF
```

**âœ… æµ‹è¯•logrotateé…ç½®**
```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
sudo logrotate -d /etc/logrotate.d/kafka

# å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡è½®è½¬ï¼ˆæµ‹è¯•ç”¨ï¼‰
sudo logrotate -f /etc/logrotate.d/kafka
```

---

## 5. ğŸ—œï¸ æ—¥å¿—æ–‡ä»¶å‹ç¼©ç®¡ç†


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—å‹ç¼©

ğŸ¯ **ç®€å•ç†è§£**ï¼šå‹ç¼©æ—¥å¿—å°±åƒæ•´ç†è¡£æŸœï¼ŒæŠŠä¸å¸¸ç”¨çš„è¡£æœæ”¶çº³èµ·æ¥

```
æœªå‹ç¼©çš„é—®é¢˜ï¼š
ğŸ“¦ å ç”¨å¤§é‡ç£ç›˜ç©ºé—´
ğŸ’° å¢åŠ å­˜å‚¨æˆæœ¬
â° å¤‡ä»½æ—¶é—´å»¶é•¿

å‹ç¼©çš„å¥½å¤„ï¼š
ğŸ’¾ èŠ‚çœ90%çš„å­˜å‚¨ç©ºé—´
âš¡ æé«˜å¤‡ä»½æ•ˆç‡
ğŸ’¡ å»¶é•¿æ—¥å¿—ä¿ç•™æ—¶é—´
```

### 5.2 è‡ªåŠ¨å‹ç¼©é…ç½®

**âš™ï¸ é…ç½®è‡ªåŠ¨å‹ç¼©ç­–ç•¥**

åœ¨logrotateé…ç½®ä¸­å¯ç”¨å‹ç¼©ï¼š

```bash
/var/log/kafka/*.log {
    daily
    rotate 30
    compress                 # å¯ç”¨å‹ç¼©
    delaycompress           # å»¶è¿Ÿå‹ç¼©ï¼ˆä¿ç•™æœ€æ–°çš„ä¸€ä¸ªæœªå‹ç¼©ï¼‰
    compresscmd /bin/gzip   # å‹ç¼©å‘½ä»¤
    uncompresscmd /bin/gunzip # è§£å‹å‘½ä»¤
    compressext .gz         # å‹ç¼©æ–‡ä»¶æ‰©å±•å
}
```

**ğŸ“Š å‹ç¼©æ•ˆæœå¯¹æ¯”**
```
æ–‡ä»¶ç±»å‹           åŸå§‹å¤§å°    å‹ç¼©å     å‹ç¼©ç‡
æ–‡æœ¬æ—¥å¿—æ–‡ä»¶       100MB      8-15MB     85-92%
JSONæ ¼å¼æ—¥å¿—       100MB      10-18MB    82-90%
å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—     100MB      12-20MB    80-88%
```

### 5.3 æ‰‹åŠ¨å‹ç¼©æ“ä½œ

**ğŸ”§ æ‰‹åŠ¨å‹ç¼©æ—§æ—¥å¿—æ–‡ä»¶**

```bash
# å‹ç¼©æŒ‡å®šæ—¥æœŸä¹‹å‰çš„æ—¥å¿—
find /var/log/kafka -name "*.log.*" -mtime +7 -exec gzip {} \;

# å‹ç¼©å¤§å°è¶…è¿‡é˜ˆå€¼çš„æ–‡ä»¶
find /var/log/kafka -name "*.log" -size +50M -exec gzip {} \;

# æŸ¥çœ‹å‹ç¼©åçš„æ•ˆæœ
ls -lh /var/log/kafka/
```

**ğŸ” æŸ¥çœ‹å‹ç¼©æ–‡ä»¶å†…å®¹**
```bash
# ç›´æ¥æŸ¥çœ‹å‹ç¼©æ—¥å¿—å†…å®¹ï¼ˆä¸è§£å‹ï¼‰
zcat server.log.1.gz | head -20
zgrep "ERROR" server.log.*.gz
zless server.log.1.gz  # åˆ†é¡µæŸ¥çœ‹
```

### 5.4 é«˜çº§å‹ç¼©ç­–ç•¥

**âš¡ é’ˆå¯¹ä¸åŒæ—¥å¿—ç±»å‹çš„å‹ç¼©ç­–ç•¥**

```bash
# é”™è¯¯æ—¥å¿— - é«˜å‹ç¼©æ¯”ï¼ˆä½¿ç”¨xzï¼‰
find /var/log/kafka -name "*error*" -mtime +3 -exec xz {} \;

# è®¿é—®æ—¥å¿— - å¿«é€Ÿå‹ç¼©ï¼ˆä½¿ç”¨lz4ï¼‰
find /var/log/kafka -name "*access*" -mtime +1 -exec lz4 {} \;

# è°ƒè¯•æ—¥å¿— - ç«‹å³åˆ é™¤ï¼ˆä¸å‹ç¼©ï¼‰
find /var/log/kafka -name "*debug*" -mtime +1 -delete
```

**ğŸ“ˆ å‹ç¼©ç®—æ³•é€‰æ‹©æŒ‡å—**
```
gzip:   å¹³è¡¡æ€§å¥½ï¼Œå…¼å®¹æ€§å¼º â†’ æ¨èæ—¥å¸¸ä½¿ç”¨
xz:     å‹ç¼©ç‡æœ€é«˜ï¼ŒCPUæ¶ˆè€—å¤§ â†’ é€‚åˆé•¿æœŸå­˜æ¡£
lz4:    å‹ç¼©é€Ÿåº¦å¿«ï¼Œå‹ç¼©ç‡ä¸€èˆ¬ â†’ é€‚åˆé¢‘ç¹è®¿é—®
bzip2:  å‹ç¼©ç‡é«˜ï¼Œé€Ÿåº¦ä¸­ç­‰ â†’ é€‚åˆæ‰¹é‡å¤„ç†
```

---

## 6. ğŸ§¹ æ—¥å¿—æ¸…ç†ç­–ç•¥é…ç½®


### 6.1 æ—¥å¿—æ¸…ç†çš„å¿…è¦æ€§

ğŸ¯ **ç”Ÿæ´»ç±»æ¯”**ï¼šæ—¥å¿—æ¸…ç†å°±åƒå®šæœŸæ¸…ç†æ‰‹æœºç›¸å†Œ

```
æ‰‹æœºç›¸å†Œç®¡ç†ï¼š
ä¿ç•™é‡è¦ç…§ç‰‡ â†’ ä¿ç•™ERRORå’ŒWARNçº§åˆ«æ—¥å¿—
åˆ é™¤é‡å¤ç…§ç‰‡ â†’ åˆ é™¤å†—ä½™çš„DEBUGæ—¥å¿—
æŒ‰æ—¶é—´æ¸…ç† â†’ åˆ é™¤è¿‡æœŸçš„å†å²æ—¥å¿—
è…¾å‡ºå­˜å‚¨ç©ºé—´ â†’ é‡Šæ”¾ç£ç›˜ç©ºé—´ç»™æ–°æ—¥å¿—
```

### 6.2 åŸºäºæ—¶é—´çš„æ¸…ç†ç­–ç•¥

**ğŸ“… è®¾ç½®åˆç†çš„æ—¥å¿—ä¿ç•™æœŸ**

```bash
# åˆ›å»ºå®šæ—¶æ¸…ç†è„šæœ¬
cat > /usr/local/bin/kafka-log-cleanup.sh << 'EOF'
#!/bin/bash

LOG_DIR="/var/log/kafka"
RETENTION_DAYS=30
ERROR_RETENTION_DAYS=90

echo "å¼€å§‹æ¸…ç†Kafkaæ—¥å¿—æ–‡ä»¶..."

# æ¸…ç†ä¸€èˆ¬æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰
find $LOG_DIR -name "*.log.*" -mtime +$RETENTION_DAYS -delete
echo "å·²æ¸…ç†30å¤©å‰çš„ä¸€èˆ¬æ—¥å¿—"

# é”™è¯¯æ—¥å¿—ä¿ç•™æ›´é•¿æ—¶é—´ï¼ˆ90å¤©ï¼‰
find $LOG_DIR -name "*error*" -mtime +$ERROR_RETENTION_DAYS -delete
echo "å·²æ¸…ç†90å¤©å‰çš„é”™è¯¯æ—¥å¿—"

# æ¸…ç†å‹ç¼©æ—¥å¿—
find $LOG_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete
echo "å·²æ¸…ç†30å¤©å‰çš„å‹ç¼©æ—¥å¿—"

echo "æ—¥å¿—æ¸…ç†å®Œæˆ"
EOF

chmod +x /usr/local/bin/kafka-log-cleanup.sh
```

**â° è®¾ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡**
```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
echo "0 2 * * * /usr/local/bin/kafka-log-cleanup.sh >> /var/log/log-cleanup.log 2>&1" | crontab -
```

### 6.3 åŸºäºç£ç›˜ç©ºé—´çš„æ¸…ç†ç­–ç•¥

**ğŸ’¾ æ™ºèƒ½ç£ç›˜ç©ºé—´ç®¡ç†**

```bash
# ç£ç›˜ç©ºé—´ç›‘æ§å’Œæ¸…ç†è„šæœ¬
cat > /usr/local/bin/kafka-disk-monitor.sh << 'EOF'
#!/bin/bash

LOG_DIR="/var/log/kafka"
# ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡80%æ—¶è§¦å‘æ¸…ç†
THRESHOLD=80

# è·å–å½“å‰ç£ç›˜ä½¿ç”¨ç‡
USAGE=$(df $LOG_DIR | tail -1 | awk '{print $5}' | sed 's/%//')

if [ $USAGE -gt $THRESHOLD ]; then
    echo "ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ° ${USAGE}%ï¼Œå¼€å§‹æ¸…ç†æ—¥å¿—..."
    
    # ä¼˜å…ˆæ¸…ç†æœ€è€çš„å‹ç¼©æ–‡ä»¶
    find $LOG_DIR -name "*.gz" -type f -printf '%T@ %p\n' | \
    sort -n | head -10 | cut -d' ' -f2- | xargs rm -f
    
    # å¦‚æœè¿˜ä¸å¤Ÿï¼Œæ¸…ç†DEBUGçº§åˆ«æ—¥å¿—
    find $LOG_DIR -name "*debug*" -mtime +1 -delete
    
    echo "ç´§æ€¥æ¸…ç†å®Œæˆ"
else
    echo "ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: ${USAGE}%"
fi
EOF

chmod +x /usr/local/bin/kafka-disk-monitor.sh
```

### 6.4 æ™ºèƒ½æ¸…ç†ç­–ç•¥

**ğŸ¤– æ ¹æ®æ—¥å¿—é‡è¦æ€§åˆ†çº§æ¸…ç†**

```bash
# åˆ†çº§æ¸…ç†ç­–ç•¥
CRITICAL_LOGS=(error fatal exception)     # ä¿ç•™æœ€ä¹…
IMPORTANT_LOGS=(warn info)                # ä¸­ç­‰ä¿ç•™
DEBUG_LOGS=(debug trace)                  # æœ€çŸ­ä¿ç•™

# å®ç°åˆ†çº§æ¸…ç†
for level in "${CRITICAL_LOGS[@]}"; do
    find $LOG_DIR -name "*$level*" -mtime +90 -delete
done

for level in "${IMPORTANT_LOGS[@]}"; do
    find $LOG_DIR -name "*$level*" -mtime +30 -delete
done

for level in "${DEBUG_LOGS[@]}"; do
    find $LOG_DIR -name "*$level*" -mtime +7 -delete
done
```

---

## 7. ğŸ” é”™è¯¯æ—¥å¿—åˆ†ææŠ€å·§


### 7.1 å¸¸è§é”™è¯¯ç±»å‹è¯†åˆ«

ğŸ¯ **é”™è¯¯æ—¥å¿—å°±åƒåŒ»ç”Ÿçœ‹ç—…å†ï¼Œè¦å­¦ä¼šæŠ“å…³é”®ä¿¡æ¯**

**ğŸš¨ è‡´å‘½é”™è¯¯å…³é”®è¯**
```
OutOfMemoryError        â†’ å†…å­˜ä¸è¶³
ConnectionException     â†’ ç½‘ç»œè¿æ¥é—®é¢˜
TimeoutException        â†’ è¶…æ—¶é—®é¢˜
CorruptRecordException  â†’ æ•°æ®æŸå
LeaderNotAvailableException â†’ Leaderé€‰ä¸¾é—®é¢˜
```

### 7.2 é«˜æ•ˆçš„æ—¥å¿—æœç´¢æŠ€å·§

**ğŸ” å¿«é€Ÿå®šä½é—®é¢˜çš„æœç´¢æ–¹æ³•**

```bash
# 1. æŒ‰æ—¶é—´èŒƒå›´æœç´¢é”™è¯¯
awk '/2024-01-11 14:00/,/2024-01-11 15:00/' server.log | grep ERROR

# 2. ç»Ÿè®¡é”™è¯¯é¢‘ç‡
grep ERROR server.log | cut -d' ' -f1-2 | sort | uniq -c | sort -nr

# 3. æå–å®Œæ•´çš„é”™è¯¯å †æ ˆ
grep -A 20 "Exception" server.log

# 4. æœç´¢ç‰¹å®šä¸»é¢˜çš„é—®é¢˜
grep -E "(topic_name|ERROR|WARN)" server.log

# 5. æŸ¥æ‰¾è¿æ¥é—®é¢˜
grep -E "(Connection|Network|Socket)" server.log | tail -50
```

### 7.3 é”™è¯¯æ¨¡å¼åˆ†æ

**ğŸ“Š å»ºç«‹é”™è¯¯åˆ†ææ¨¡æ¿**

```bash
# åˆ›å»ºé”™è¯¯åˆ†æè„šæœ¬
cat > /usr/local/bin/kafka-error-analysis.sh << 'EOF'
#!/bin/bash

LOG_FILE="${1:-/var/log/kafka/server.log}"
REPORT_FILE="/tmp/kafka-error-report-$(date +%Y%m%d).txt"

echo "Kafkaé”™è¯¯åˆ†ææŠ¥å‘Š - $(date)" > $REPORT_FILE
echo "=================================" >> $REPORT_FILE

# é”™è¯¯ç»Ÿè®¡
echo "Top 10 é”™è¯¯ç±»å‹:" >> $REPORT_FILE
grep ERROR $LOG_FILE | awk '{print $NF}' | sort | uniq -c | sort -nr | head -10 >> $REPORT_FILE

# æ—¶é—´åˆ†å¸ƒ
echo -e "\né”™è¯¯æ—¶é—´åˆ†å¸ƒ:" >> $REPORT_FILE
grep ERROR $LOG_FILE | cut -d' ' -f2 | cut -d: -f1 | sort | uniq -c >> $REPORT_FILE

# æœ€è¿‘çš„ä¸¥é‡é”™è¯¯
echo -e "\næœ€è¿‘çš„FATALé”™è¯¯:" >> $REPORT_FILE
grep FATAL $LOG_FILE | tail -5 >> $REPORT_FILE

echo "åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
EOF

chmod +x /usr/local/bin/kafka-error-analysis.sh
```

### 7.4 é—®é¢˜è§£å†³æ€è·¯

**ğŸ› ï¸ ä»æ—¥å¿—åˆ°è§£å†³æ–¹æ¡ˆçš„æ€ç»´å¯¼å›¾**

```
æ­¥éª¤1ï¼šç¡®å®šé—®é¢˜èŒƒå›´
â†’ æ˜¯å•ä¸ªBrokerè¿˜æ˜¯æ•´ä¸ªé›†ç¾¤ï¼Ÿ
â†’ æ˜¯ç‰¹å®šTopicè¿˜æ˜¯å…¨å±€é—®é¢˜ï¼Ÿ
â†’ ä»€ä¹ˆæ—¶å€™å¼€å§‹å‡ºç°çš„ï¼Ÿ

æ­¥éª¤2ï¼šåˆ†æé”™è¯¯æ¨¡å¼
â†’ é”™è¯¯æ˜¯æŒç»­çš„è¿˜æ˜¯é—´æ­‡çš„ï¼Ÿ
â†’ æœ‰æ²¡æœ‰æ˜æ˜¾çš„è§¦å‘æ¡ä»¶ï¼Ÿ
â†’ é”™è¯¯é¢‘ç‡æ˜¯å¦åœ¨å¢åŠ ï¼Ÿ

æ­¥éª¤3ï¼šæŸ¥æ‰¾æ ¹æœ¬åŸå› 
â†’ æ£€æŸ¥é…ç½®å˜æ›´
â†’ æ£€æŸ¥ç½‘ç»œè¿æ¥
â†’ æ£€æŸ¥ç³»ç»Ÿèµ„æº

æ­¥éª¤4ï¼šåˆ¶å®šè§£å†³æ–¹æ¡ˆ
â†’ ä¸´æ—¶ç¼“è§£æªæ–½
â†’ æ ¹æœ¬æ€§ä¿®å¤
â†’ é¢„é˜²æªæ–½
```

---

## 8. ğŸ“ˆ æ€§èƒ½æ—¥å¿—æ”¶é›†å®è·µ


### 8.1 æ€§èƒ½æŒ‡æ ‡çš„é‡è¦æ€§

ğŸ¯ **æ€§èƒ½æ—¥å¿—å°±åƒæ±½è½¦çš„ä»ªè¡¨ç›˜ï¼Œå‘Šè¯‰ä½ è½¦å­è·‘å¾—æ€ä¹ˆæ ·**

```
æ±½è½¦ä»ªè¡¨ç›˜          â†’    Kafkaæ€§èƒ½æŒ‡æ ‡
ğŸš— è½¦é€Ÿ            â†’    æ¶ˆæ¯å¤„ç†é€Ÿåº¦
â›½ æ²¹é‡            â†’    å†…å­˜ä½¿ç”¨ç‡
ğŸŒ¡ï¸ æ°´æ¸©            â†’    CPUä½¿ç”¨ç‡
ğŸ”§ æ•…éšœç¯          â†’    é”™è¯¯ç‡æŒ‡æ ‡
```

### 8.2 JVMæ€§èƒ½æ—¥å¿—é…ç½®

**âš™ï¸ å¯ç”¨è¯¦ç»†çš„JVMæ€§èƒ½ç›‘æ§**

```bash
# åœ¨kafka-server-start.shä¸­æ·»åŠ JVMå‚æ•°
export KAFKA_JVM_PERFORMANCE_OPTS="-XX:+UnlockCommercialFeatures \
  -XX:+FlightRecorder \
  -XX:+UnlockDiagnosticVMOptions \
  -XX:+LogVMOutput \
  -XX:LogFile=/var/log/kafka/jvm.log \
  -Xloggc:/var/log/kafka/gc.log \
  -XX:+UseGCLogFileRotation \
  -XX:NumberOfGCLogFiles=10 \
  -XX:GCLogFileSize=100M"
```

**ğŸ“Š GCæ—¥å¿—åˆ†æè¦ç‚¹**
```bash
# åˆ†æGCæ€§èƒ½
grep "GC" /var/log/kafka/gc.log | tail -20

# ç»Ÿè®¡GCé¢‘ç‡
grep "Full GC" /var/log/kafka/gc.log | wc -l

# åˆ†æGCæš‚åœæ—¶é—´
awk '/GC/ {print $NF}' /var/log/kafka/gc.log | sort -n | tail -10
```

### 8.3 Kafkaå†…ç½®æ€§èƒ½æŒ‡æ ‡

**ğŸ“‹ å¯ç”¨Kafka JMXæŒ‡æ ‡ç›‘æ§**

```bash
# å¯ç”¨JMXç›‘æ§ç«¯å£
export JMX_PORT=9999
./kafka-server-start.sh ../config/server.properties
```

**ğŸ”§ æ”¶é›†å…³é”®æ€§èƒ½æŒ‡æ ‡çš„è„šæœ¬**
```bash
cat > /usr/local/bin/kafka-metrics-collector.sh << 'EOF'
#!/bin/bash

METRICS_LOG="/var/log/kafka/metrics.log"
JMX_HOST="localhost:9999"

# æ”¶é›†å…³é”®æŒ‡æ ‡
echo "$(date): å¼€å§‹æ”¶é›†Kafkaæ€§èƒ½æŒ‡æ ‡" >> $METRICS_LOG

# æ¶ˆæ¯é€Ÿç‡
MESSAGES_IN=$(jmxterm -l $JMX_HOST -n | grep MessagesInPerSec | head -1)
echo "æ¶ˆæ¯è¾“å…¥é€Ÿç‡: $MESSAGES_IN" >> $METRICS_LOG

# å­—èŠ‚é€Ÿç‡  
BYTES_IN=$(jmxterm -l $JMX_HOST -n | grep BytesInPerSec | head -1)
echo "å­—èŠ‚è¾“å…¥é€Ÿç‡: $BYTES_IN" >> $METRICS_LOG

# ç½‘ç»œå¤„ç†æ—¶é—´
NETWORK_TIME=$(jmxterm -l $JMX_HOST -n | grep NetworkProcessorAvgIdlePercent)
echo "ç½‘ç»œå¤„ç†å™¨ç©ºé—²ç‡: $NETWORK_TIME" >> $METRICS_LOG

echo "æŒ‡æ ‡æ”¶é›†å®Œæˆ" >> $METRICS_LOG
EOF

# è®¾ç½®å®šæ—¶æ”¶é›†ï¼ˆæ¯5åˆ†é’Ÿï¼‰
echo "*/5 * * * * /usr/local/bin/kafka-metrics-collector.sh" | crontab -
```

### 8.4 æ€§èƒ½é—®é¢˜è¯†åˆ«

**ğŸ¯ ä»æ€§èƒ½æ—¥å¿—ä¸­å‘ç°ç“¶é¢ˆ**

**å†…å­˜é—®é¢˜è¯†åˆ«**ï¼š
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨è¶‹åŠ¿
grep "heap" /var/log/kafka/jvm.log | tail -20

# åˆ†æå†…å­˜æ³„æ¼è¿¹è±¡
awk '/OutOfMemoryError/ {print}' /var/log/kafka/server.log
```

**ç½‘ç»œæ€§èƒ½é—®é¢˜**ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œè¿æ¥æ•°
netstat -an | grep :9092 | wc -l

# åˆ†æç½‘ç»œè¶…æ—¶
grep -E "(timeout|connection.*failed)" /var/log/kafka/server.log
```

**ç£ç›˜I/Oé—®é¢˜**ï¼š
```bash
# ç›‘æ§ç£ç›˜I/O
iostat -x 1 5 | grep kafka

# æ£€æŸ¥ç£ç›˜ç©ºé—´é—®é¢˜
df -h | grep kafka
```

---

## 9. ğŸ“‹ å®¡è®¡æ—¥å¿—ç®¡ç†


### 9.1 ä»€ä¹ˆæ˜¯å®¡è®¡æ—¥å¿—

ğŸ¯ **å®¡è®¡æ—¥å¿—å°±åƒé“¶è¡Œçš„äº¤æ˜“è®°å½•ï¼Œè®°å½•æ¯ä¸€ç¬”æ“ä½œ**

```
é“¶è¡Œäº¤æ˜“è®°å½•           â†’    Kafkaå®¡è®¡æ—¥å¿—
è°æ“ä½œäº†              â†’    ç”¨æˆ·èº«ä»½
ä»€ä¹ˆæ—¶å€™æ“ä½œ          â†’    æ“ä½œæ—¶é—´  
æ“ä½œäº†ä»€ä¹ˆ            â†’    Topic/åˆ†åŒº
æ“ä½œç»“æœå¦‚ä½•          â†’    æˆåŠŸ/å¤±è´¥
```

### 9.2 å¯ç”¨Kafkaå®¡è®¡åŠŸèƒ½

**ğŸ” é…ç½®æ“ä½œå®¡è®¡æ—¥å¿—**

```bash
# åœ¨server.propertiesä¸­å¯ç”¨å®¡è®¡
authorizer.class.name=kafka.security.auth.SimpleAclAuthorizer
security.inter.broker.protocol=SASL_PLAINTEXT
sasl.mechanism.inter.broker.protocol=PLAIN
sasl.enabled.mechanisms=PLAIN

# å¯ç”¨æ“ä½œæ—¥å¿—è®°å½•
log4j.logger.kafka.authorizer.logger=INFO, authorizerAppender
log4j.additivity.kafka.authorizer.logger=false

log4j.appender.authorizerAppender=org.apache.log4j.DailyRollingFileAppender
log4j.appender.authorizerAppender.DatePattern='.'yyyy-MM-dd-HH
log4j.appender.authorizerAppender.File=${kafka.logs.dir}/kafka-authorizer.log
```

### 9.3 å®¡è®¡æ—¥å¿—å†…å®¹åˆ†æ

**ğŸ“Š å®¡è®¡æ—¥å¿—åŒ…å«çš„å…³é”®ä¿¡æ¯**

```bash
# å…¸å‹çš„å®¡è®¡æ—¥å¿—æ¡ç›®åˆ†æ
# [æ—¶é—´æˆ³] INFO Principal = User:alice is Allowed Operation = Read from host = 192.168.1.100 on resource = Topic:LITERAL:sensitive-topic

# æå–ç”¨æˆ·æ“ä½œç»Ÿè®¡
grep "is Allowed" kafka-authorizer.log | \
awk '{print $6}' | sort | uniq -c | sort -nr

# åˆ†ææ‹’ç»çš„æ“ä½œ
grep "is Denied" kafka-authorizer.log | \
awk '{print $6, $8, $12}' | sort | uniq -c

# æŒ‰ç”¨æˆ·ç»Ÿè®¡æ“ä½œ
grep "Principal = User:" kafka-authorizer.log | \
awk '{print $6}' | sort | uniq -c
```

### 9.4 åˆè§„æ€§æŠ¥å‘Šç”Ÿæˆ

**ğŸ“‹ è‡ªåŠ¨ç”Ÿæˆå®¡è®¡æŠ¥å‘Š**

```bash
cat > /usr/local/bin/kafka-audit-report.sh << 'EOF'
#!/bin/bash

AUDIT_LOG="/var/log/kafka/kafka-authorizer.log"
REPORT_DATE=$(date +%Y-%m-%d)
REPORT_FILE="/tmp/kafka-audit-report-$REPORT_DATE.html"

# ç”ŸæˆHTMLæ ¼å¼çš„å®¡è®¡æŠ¥å‘Š
cat > $REPORT_FILE << HTML
<!DOCTYPE html>
<html>
<head>
    <title>Kafkaå®¡è®¡æŠ¥å‘Š - $REPORT_DATE</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .denied { color: red; }
        .allowed { color: green; }
    </style>
</head>
<body>
    <h1>Kafkaæ“ä½œå®¡è®¡æŠ¥å‘Š</h1>
    <p>æŠ¥å‘Šæ—¥æœŸ: $REPORT_DATE</p>
    
    <h2>ç”¨æˆ·æ“ä½œç»Ÿè®¡</h2>
    <table>
        <tr><th>ç”¨æˆ·</th><th>æ“ä½œæ¬¡æ•°</th><th>çŠ¶æ€</th></tr>
HTML

# åˆ†æä»Šå¤©çš„å®¡è®¡æ—¥å¿—
grep "$(date +%Y-%m-%d)" $AUDIT_LOG | \
while read line; do
    user=$(echo $line | grep -o "User:[^ ]*" | cut -d: -f2)
    operation=$(echo $line | grep -o "Operation = [^ ]*" | cut -d= -f2)
    status=$(echo $line | grep -o "is [^ ]*" | cut -d' ' -f2)
    
    echo "<tr><td>$user</td><td>$operation</td><td class=\"$(echo $status | tr A-Z a-z)\">$status</td></tr>" >> $REPORT_FILE
done

cat >> $REPORT_FILE << HTML
    </table>
    
    <h2>æ‹’ç»è®¿é—®è®°å½•</h2>
    <pre>
$(grep "is Denied" $AUDIT_LOG | grep "$(date +%Y-%m-%d)")
    </pre>
</body>
</html>
HTML

echo "å®¡è®¡æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
EOF

chmod +x /usr/local/bin/kafka-audit-report.sh

# æ¯æ—¥è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
echo "0 23 * * * /usr/local/bin/kafka-audit-report.sh" | crontab -
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—ç±»å‹ï¼šæ•°æ®æ—¥å¿—å­˜å‚¨æ¶ˆæ¯ï¼Œè¿è¡Œæ—¥å¿—è®°å½•çŠ¶æ€
ğŸ”¸ ä¼˜é›…åœæœºï¼šä½¿ç”¨kafka-server-stop.shç¡®ä¿æ•°æ®å®‰å…¨
ğŸ”¸ æ—¥å¿—çº§åˆ«ï¼šDEBUG < INFO < WARN < ERROR < FATAL
ğŸ”¸ æ—¥å¿—è½®è½¬ï¼šé˜²æ­¢å•ä¸ªæ–‡ä»¶è¿‡å¤§ï¼Œæ”¯æŒæŒ‰æ—¶é—´æˆ–å¤§å°
ğŸ”¸ æ—¥å¿—å‹ç¼©ï¼šèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œæé«˜å¤‡ä»½æ•ˆç‡
ğŸ”¸ æ—¥å¿—æ¸…ç†ï¼šåŸºäºæ—¶é—´å’Œç£ç›˜ç©ºé—´çš„è‡ªåŠ¨æ¸…ç†ç­–ç•¥
ğŸ”¸ é”™è¯¯åˆ†æï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œè¯†åˆ«é”™è¯¯æ¨¡å¼
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šJVMæŒ‡æ ‡ã€GCæ—¥å¿—ã€ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šè®°å½•ç”¨æˆ·æ“ä½œï¼Œæ»¡è¶³åˆè§„è¦æ±‚
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ—¥å¿—ç®¡ç†çš„æ ¸å¿ƒä»·å€¼**
```
é—®é¢˜è¯Šæ–­ï¼š
- é€šè¿‡æ—¥å¿—å¿«é€Ÿå®šä½æ•…éšœåŸå› 
- åˆ†æé”™è¯¯æ¨¡å¼é¢„é˜²é—®é¢˜å¤å‘
- æä¾›æ•…éšœæ’æŸ¥çš„è¯¦ç»†ä¿¡æ¯

æ€§èƒ½ä¼˜åŒ–ï¼š
- è¯†åˆ«æ€§èƒ½ç“¶é¢ˆå’Œèµ„æºä½¿ç”¨æƒ…å†µ  
- ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€
- ä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æŒ

åˆè§„å®¡è®¡ï¼š
- è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
- æ»¡è¶³å®‰å…¨å®¡è®¡è¦æ±‚
- æä¾›æ“ä½œè¿½æº¯èƒ½åŠ›
```

**ğŸ”¹ ä¸åŒç¯å¢ƒçš„æ—¥å¿—ç­–ç•¥**
```
å¼€å‘ç¯å¢ƒï¼š
- DEBUGçº§åˆ«ï¼Œè¯¦ç»†ä¿¡æ¯ä¾¿äºè°ƒè¯•
- çŸ­ä¿ç•™æœŸï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
- é‡ç‚¹å…³æ³¨åŠŸèƒ½é—®é¢˜

æµ‹è¯•ç¯å¢ƒï¼š
- INFOçº§åˆ«ï¼Œå¹³è¡¡ä¿¡æ¯é‡å’Œæ€§èƒ½
- ä¸­ç­‰ä¿ç•™æœŸï¼Œæ”¯æŒå›å½’åˆ†æ
- é‡ç‚¹å…³æ³¨æ€§èƒ½å’Œç¨³å®šæ€§

ç”Ÿäº§ç¯å¢ƒï¼š
- WARNçº§åˆ«ï¼Œå‡å°‘æ€§èƒ½å½±å“
- é•¿ä¿ç•™æœŸï¼Œæ”¯æŒé—®é¢˜è¿½æº¯
- é‡ç‚¹å…³æ³¨é”™è¯¯å’Œå®‰å…¨
```

**ğŸ”¹ æ—¥å¿—ç®¡ç†è‡ªåŠ¨åŒ–çš„é‡è¦æ€§**
```
æ‰‹åŠ¨ç®¡ç†çš„é—®é¢˜ï¼š
- å®¹æ˜“é—å¿˜ï¼Œå¯¼è‡´ç£ç›˜çˆ†æ»¡
- æ“ä½œç¹çï¼Œå®¹æ˜“å‡ºé”™
- æ— æ³•åŠæ—¶å“åº”é—®é¢˜

è‡ªåŠ¨åŒ–çš„ä¼˜åŠ¿ï¼š
- å®šæ—¶æ‰§è¡Œï¼Œç¨³å®šå¯é 
- æ ‡å‡†åŒ–æµç¨‹ï¼Œå‡å°‘äººä¸ºé”™è¯¯
- ä¸»åŠ¨ç›‘æ§ï¼ŒåŠæ—¶å‘Šè­¦
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **é‡‘èäº¤æ˜“ç³»ç»Ÿ**ï¼šä¸¥æ ¼çš„å®¡è®¡æ—¥å¿—è®°å½•æ¯ç¬”äº¤æ˜“
- **ç”µå•†å¹³å°**ï¼šæ€§èƒ½æ—¥å¿—ç›‘æ§å¤§ä¿ƒæœŸé—´çš„ç³»ç»Ÿè´Ÿè½½
- **ç‰©è”ç½‘å¹³å°**ï¼šé”™è¯¯æ—¥å¿—å¿«é€Ÿå®šä½è®¾å¤‡è¿æ¥é—®é¢˜
- **å†…å®¹åˆ†å‘**ï¼šæ—¥å¿—åˆ†æä¼˜åŒ–å†…å®¹æ¨é€ç­–ç•¥

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **åˆ†å±‚ç®¡ç†**ï¼šä¸åŒé‡è¦æ€§çš„æ—¥å¿—é‡‡ç”¨ä¸åŒç­–ç•¥
- **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ—¥å¸¸æ“ä½œéƒ½åº”è¯¥è‡ªåŠ¨åŒ–
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„æ—¥å¿—ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- **å®šæœŸå›é¡¾**ï¼šå®šæœŸæ£€æŸ¥å’Œä¼˜åŒ–æ—¥å¿—ç®¡ç†ç­–ç•¥

**ğŸ“ˆ æŒç»­æ”¹è¿›æ–¹å‘**
- **æ™ºèƒ½åˆ†æ**ï¼šä½¿ç”¨AIæŠ€æœ¯è‡ªåŠ¨åˆ†ææ—¥å¿—æ¨¡å¼
- **å®æ—¶å¤„ç†**ï¼šå»ºç«‹å®æ—¶æ—¥å¿—å¤„ç†å’Œå‘Šè­¦ç³»ç»Ÿ
- **å¯è§†åŒ–å±•ç¤º**ï¼šç”¨å›¾è¡¨ç›´è§‚å±•ç¤ºæ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
- **é›†ä¸­ç®¡ç†**ï¼šåœ¨é›†ç¾¤ç¯å¢ƒä¸­å®ç°æ—¥å¿—çš„é›†ä¸­æ”¶é›†å’Œç®¡ç†

**å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š
```
ğŸŸ¢ åŸºç¡€çº§ï¼šæŒæ¡åŸºæœ¬çš„æ—¥å¿—æŸ¥çœ‹å’Œé…ç½®
ğŸŸ¡ è¿›é˜¶çº§ï¼šç†è§£æ—¥å¿—è½®è½¬ã€å‹ç¼©ã€æ¸…ç†ç­–ç•¥
ğŸ”´ é«˜çº§çº§ï¼šå®ç°è‡ªåŠ¨åŒ–æ—¥å¿—ç®¡ç†å’Œæ€§èƒ½ç›‘æ§
âš« ä¸“å®¶çº§ï¼šå»ºç«‹å®Œæ•´çš„æ—¥å¿—åˆ†æå’Œå®¡è®¡ä½“ç³»
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¼˜é›…åœæœºä¿æ•°æ®ï¼Œæ—¥å¿—çº§åˆ«è¦åˆç†
- è½®è½¬å‹ç¼©çœç©ºé—´ï¼Œå®šæœŸæ¸…ç†é˜²çˆ†æ»¡  
- é”™è¯¯åˆ†ææŠ“å…³é”®ï¼Œæ€§èƒ½ç›‘æ§çœ‹è¶‹åŠ¿
- å®¡è®¡è®°å½•ä¿åˆè§„ï¼Œè‡ªåŠ¨ç®¡ç†æ˜¯ç‹é“