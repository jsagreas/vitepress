---
title: 2ã€æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜æ¦‚è¿°](#1-æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜æ¦‚è¿°)
2. [é‡å¤æ¶ˆè´¹äº§ç”Ÿçš„æ ¹æœ¬åŸå› ](#2-é‡å¤æ¶ˆè´¹äº§ç”Ÿçš„æ ¹æœ¬åŸå› )
3. [at-least-onceè¯­ä¹‰è¯¦è§£](#3-at-least-onceè¯­ä¹‰è¯¦è§£)
4. [æ¶ˆè´¹è€…rebalanceé‡å¤å¤„ç†](#4-æ¶ˆè´¹è€…rebalanceé‡å¤å¤„ç†)
5. [offsetæäº¤æœºåˆ¶ä¸é‡å¤æ¶ˆè´¹](#5-offsetæäº¤æœºåˆ¶ä¸é‡å¤æ¶ˆè´¹)
6. [ç”Ÿäº§è€…å¹‚ç­‰æ€§è§£å†³æ–¹æ¡ˆ](#6-ç”Ÿäº§è€…å¹‚ç­‰æ€§è§£å†³æ–¹æ¡ˆ)
7. [exactly-onceè¯­ä¹‰å®ç°](#7-exactly-onceè¯­ä¹‰å®ç°)
8. [ä¸šåŠ¡å±‚å»é‡ç­–ç•¥](#8-ä¸šåŠ¡å±‚å»é‡ç­–ç•¥)
9. [æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤](#9-æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æ¶ˆæ¯é‡å¤æ¶ˆè´¹é—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯é‡å¤æ¶ˆè´¹


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼ŒæœåŠ¡å‘˜å¯èƒ½å› ä¸ºå„ç§åŸå› ï¼ˆæ²¡å¬æ¸…ã€å¿˜è®°äº†ï¼‰è®©ä½ é‡å¤è¯´å‡ éèœåï¼Œæœ€åç»™ä½ ä¸Šäº†ä¸¤ä»½åŒæ ·çš„èœã€‚åœ¨Kafkaä¸­ï¼Œæ¶ˆæ¯é‡å¤æ¶ˆè´¹å°±æ˜¯**åŒä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹è€…å¤„ç†äº†å¤šæ¬¡**ã€‚

```
æ­£å¸¸æƒ…å†µï¼š
æ¶ˆæ¯A â†’ æ¶ˆè´¹è€…å¤„ç† â†’ å¤„ç†å®Œæˆ âœ“

é‡å¤æ¶ˆè´¹ï¼š
æ¶ˆæ¯A â†’ æ¶ˆè´¹è€…å¤„ç† â†’ å¤„ç†å®Œæˆ
æ¶ˆæ¯A â†’ æ¶ˆè´¹è€…å¤„ç† â†’ åˆå¤„ç†ä¸€éï¼âŒ
```

### 1.2 é‡å¤æ¶ˆè´¹çš„å½±å“


**ğŸ”¸ æ•°æ®å±‚é¢å½±å“**
- **é‡å¤è®°å½•**ï¼šæ•°æ®åº“ä¸­å‡ºç°ç›¸åŒçš„è®°å½•
- **é‡å¤è®¡ç®—**ï¼šç»Ÿè®¡æ•°æ®å‡ºç°åå·®ï¼Œæ¯”å¦‚ç”¨æˆ·ç§¯åˆ†è¢«é‡å¤åŠ äº†å‡ æ¬¡
- **ä¸šåŠ¡é€»è¾‘é”™è¯¯**ï¼šè®¢å•è¢«é‡å¤å¤„ç†ï¼Œç”¨æˆ·è¢«é‡å¤æ‰£æ¬¾

**ğŸ”¸ ç³»ç»Ÿå±‚é¢å½±å“**
- **æ€§èƒ½ä¸‹é™**ï¼šæ— æ•ˆçš„é‡å¤å¤„ç†æ¶ˆè€—ç³»ç»Ÿèµ„æº
- **å­˜å‚¨æµªè´¹**ï¼šé‡å¤æ•°æ®å ç”¨å­˜å‚¨ç©ºé—´
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šå¯èƒ½å¯¼è‡´ä¸šåŠ¡æµç¨‹å‡ºé”™

### 1.3 é‡å¤æ¶ˆè´¹çš„å¸¸è§åœºæ™¯


| åœºæ™¯ç±»å‹ | **å…·ä½“æƒ…å†µ** | **å½±å“ç¨‹åº¦** |
|---------|-------------|-------------|
| ğŸ”„ **ç½‘ç»œå¼‚å¸¸** | `offsetæäº¤æ—¶ç½‘ç»œä¸­æ–­` | `ä¸­ç­‰` |
| âš¡ **ç³»ç»Ÿé‡å¯** | `æ¶ˆè´¹è€…é‡å¯ï¼ŒoffsetæœªåŠæ—¶æäº¤` | `è¾ƒé«˜` |
| ğŸ—ï¸ **rebalance** | `æ¶ˆè´¹è€…ç»„é‡æ–°åˆ†é…åˆ†åŒº` | `é«˜` |
| ğŸ› **ç¨‹åºå¼‚å¸¸** | `ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼Œæ¶ˆæ¯é‡æ–°æ¶ˆè´¹` | `ä¸­ç­‰` |
| ğŸ• **è¶…æ—¶é‡è¯•** | `å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œè§¦å‘é‡æ–°æ¶ˆè´¹` | `è¾ƒé«˜` |

---

## 2. ğŸ” é‡å¤æ¶ˆè´¹äº§ç”Ÿçš„æ ¹æœ¬åŸå› 


### 2.1 åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ¬è´¨æŒ‘æˆ˜


**æ ¸å¿ƒé—®é¢˜**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚

```
ç†æƒ³æƒ…å†µï¼ˆåŸå­æ“ä½œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆè´¹æ¶ˆæ¯ + å¤„ç†ä¸šåŠ¡ + æäº¤offset â”‚ â†’ ä¸€æ¬¡æ€§å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…æƒ…å†µï¼ˆéåŸå­æ“ä½œï¼‰ï¼š
æ­¥éª¤1ï¼šæ¶ˆè´¹æ¶ˆæ¯     âœ“
æ­¥éª¤2ï¼šå¤„ç†ä¸šåŠ¡     âœ“
æ­¥éª¤3ï¼šæäº¤offset   âŒ (ç½‘ç»œä¸­æ–­/ç³»ç»Ÿå´©æºƒ)
ç»“æœï¼šæ¶ˆæ¯ä¼šè¢«é‡æ–°æ¶ˆè´¹
```

### 2.2 Kafkaçš„æ¶ˆæ¯æŠ•é€’è¯­ä¹‰


**ğŸ”¸ ä¸‰ç§æŠ•é€’è¯­ä¹‰å¯¹æ¯”**

```
at-most-onceï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰ï¼š
æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œä½†ç»ä¸é‡å¤
åœºæ™¯ï¼šæ—¥å¿—æ”¶é›†ç­‰å…è®¸ä¸¢å¤±çš„åœºæ™¯

at-least-onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰ï¼š
æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œä½†å¯èƒ½é‡å¤  â† Kafkaé»˜è®¤è¡Œä¸º
åœºæ™¯ï¼šå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯

exactly-onceï¼ˆç²¾ç¡®ä¸€æ¬¡ï¼‰ï¼š
æ¶ˆæ¯æ—¢ä¸ä¸¢å¤±ä¹Ÿä¸é‡å¤
åœºæ™¯ï¼šé‡‘èè½¬è´¦ç­‰ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯
```

### 2.3 æŠ€æœ¯å±‚é¢çš„åŸå› åˆ†æ


**ğŸ”¸ offsetæäº¤æ—¶æœºé—®é¢˜**

```
è‡ªåŠ¨æäº¤æ¨¡å¼ï¼š
enable.auto.commit=true
auto.commit.interval.ms=5000

é—®é¢˜ï¼šæ¶ˆæ¯å¤„ç†å®Œæˆå‰å°±æäº¤äº†offset
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ¶ˆè´¹æ¶ˆæ¯â”‚â†’â”‚å¤„ç†ä¸šåŠ¡â”‚â†’â”‚è‡ªåŠ¨æäº¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†‘ è¿™é‡Œå¦‚æœå¤±è´¥ï¼Œæ¶ˆæ¯å°±ä¸¢äº†

æ‰‹åŠ¨æäº¤æ¨¡å¼ï¼š
enable.auto.commit=false

é—®é¢˜ï¼šæäº¤offsetå¤±è´¥å¯¼è‡´é‡å¤æ¶ˆè´¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ¶ˆè´¹æ¶ˆæ¯â”‚â†’â”‚å¤„ç†ä¸šåŠ¡â”‚â†’â”‚æ‰‹åŠ¨æäº¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†‘ è¿™é‡Œå¤±è´¥ï¼Œæ¶ˆæ¯ä¼šé‡å¤
```

---

## 3. ğŸ¯ at-least-onceè¯­ä¹‰è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯at-least-once


**ç®€å•ç†è§£**ï¼š`at-least-once`å°±åƒæ˜¯ä¸€ä¸ª**è¿‡åº¦è´Ÿè´£çš„å¿«é€’å‘˜**ï¼Œä»–å®å¯å¤šé€å‡ æ¬¡ï¼Œä¹Ÿä¸èƒ½æ¼é€ã€‚åœ¨Kafkaä¸­ï¼Œè¿™æ„å‘³ç€**æ¶ˆæ¯è‡³å°‘ä¼šè¢«æŠ•é€’ä¸€æ¬¡ï¼Œä½†å¯èƒ½è¢«æŠ•é€’å¤šæ¬¡**ã€‚

### 3.2 at-least-onceçš„å®ç°æœºåˆ¶


**ğŸ”¸ ç”Ÿäº§è€…ç«¯çš„ä¿è¯**

```java
// ç”Ÿäº§è€…é…ç½® - ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
Properties props = new Properties();
props.put("acks", "all");           // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
props.put("retries", Integer.MAX_VALUE);  // æ— é™é‡è¯•
props.put("max.in.flight.requests.per.connection", 1); // ä¿è¯é¡ºåº
```

**é‡è¯•æœºåˆ¶è¯´æ˜**ï¼š
```
æ¶ˆæ¯å‘é€æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ Broker(Leader) â†’ å†™å…¥æ—¥å¿— â†’ åŒæ­¥åˆ°Follower â†’ è¿”å›ç¡®è®¤

å¦‚æœä»»ä½•ç¯èŠ‚å¤±è´¥ï¼š
ç”Ÿäº§è€…è‡ªåŠ¨é‡è¯• â†’ å¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤å†™å…¥
```

**ğŸ”¸ æ¶ˆè´¹è€…ç«¯çš„ä¿è¯**

```java
// æ¶ˆè´¹è€…é…ç½® - ç¡®ä¿æ¶ˆæ¯è¢«å¤„ç†
Properties props = new Properties();
props.put("enable.auto.commit", "false");  // æ‰‹åŠ¨æäº¤offset
props.put("isolation.level", "read_committed"); // åªè¯»å·²æäº¤æ¶ˆæ¯
```

### 3.3 at-least-onceçš„ä¼˜ç¼ºç‚¹


| ä¼˜ç‚¹ | ç¼ºç‚¹ | åº”å¯¹ç­–ç•¥ |
|------|------|---------|
| âœ… **ä¸ä¸¢æ¶ˆæ¯** | âŒ **å¯èƒ½é‡å¤** | `ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡` |
| âœ… **å®ç°ç®€å•** | âŒ **éœ€è¦å»é‡** | `æ¶ˆæ¯å”¯ä¸€æ ‡è¯†` |
| âœ… **æ€§èƒ½è¾ƒå¥½** | âŒ **å­˜å‚¨å¼€é”€** | `åˆç†çš„å»é‡ç­–ç•¥` |

---

## 4. âš–ï¸ æ¶ˆè´¹è€…rebalanceé‡å¤å¤„ç†


### 4.1 ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…rebalance


**ç”Ÿæ´»åŒ–ç±»æ¯”**ï¼šæƒ³è±¡ä¸€ä¸ªé¤å…æœ‰3ä¸ªæœåŠ¡å‘˜è´Ÿè´£4å¼ æ¡Œå­ï¼Œå¦‚æœä¸€ä¸ªæœåŠ¡å‘˜è¯·å‡äº†ï¼Œå‰©ä¸‹çš„2ä¸ªæœåŠ¡å‘˜å°±è¦é‡æ–°åˆ†é…è¿™4å¼ æ¡Œå­ã€‚åœ¨Kafkaä¸­ï¼Œ`rebalance`å°±æ˜¯**æ¶ˆè´¹è€…ç»„é‡æ–°åˆ†é…åˆ†åŒºçš„è¿‡ç¨‹**ã€‚

```
Rebalanceå‰ï¼š
æ¶ˆè´¹è€…Aï¼šè´Ÿè´£åˆ†åŒº0ã€1
æ¶ˆè´¹è€…Bï¼šè´Ÿè´£åˆ†åŒº2ã€3
æ¶ˆè´¹è€…Cï¼šè´Ÿè´£åˆ†åŒº4ã€5

æ¶ˆè´¹è€…Cç¦»å¼€åRebalanceï¼š
æ¶ˆè´¹è€…Aï¼šè´Ÿè´£åˆ†åŒº0ã€1ã€2
æ¶ˆè´¹è€…Bï¼šè´Ÿè´£åˆ†åŒº3ã€4ã€5
```

### 4.2 rebalanceè§¦å‘çš„åœºæ™¯


**ğŸ”¸ å¸¸è§è§¦å‘æ¡ä»¶**

| è§¦å‘åœºæ™¯ | **å…·ä½“æƒ…å†µ** | **é‡å¤é£é™©** |
|---------|-------------|-------------|
| ğŸ”„ **æ¶ˆè´¹è€…åŠ å…¥** | `æ–°æ¶ˆè´¹è€…åŠ å…¥æ¶ˆè´¹è€…ç»„` | `ä¸­ç­‰` |
| ğŸšª **æ¶ˆè´¹è€…ç¦»å¼€** | `æ¶ˆè´¹è€…å´©æºƒæˆ–ä¸»åŠ¨ç¦»å¼€` | `é«˜` |
| ğŸ“Š **åˆ†åŒºå˜åŒ–** | `Topicåˆ†åŒºæ•°é‡æ”¹å˜` | `ä½` |
| â° **å¿ƒè·³è¶…æ—¶** | `session.timeout.mså†…æœªå‘é€å¿ƒè·³` | `é«˜` |
| ğŸŒ **å¤„ç†è¶…æ—¶** | `max.poll.interval.mså†…æœªè°ƒç”¨poll()` | `å¾ˆé«˜` |

### 4.3 rebalanceå¯¼è‡´é‡å¤æ¶ˆè´¹çš„è¿‡ç¨‹


```
æ—¶é—´çº¿åˆ†æï¼š

T1: æ¶ˆè´¹è€…Aå¤„ç†æ¶ˆæ¯M1
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚å¤„ç†æ¶ˆæ¯M1   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T2: æ¶ˆè´¹è€…Aå¤„ç†å®Œæˆï¼Œå‡†å¤‡æäº¤offset
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ä¸šåŠ¡å¤„ç†å®Œæˆ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T3: æ­¤æ—¶å‘ç”Ÿrebalanceï¼ˆå…¶ä»–æ¶ˆè´¹è€…ç¦»å¼€ï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚rebalanceå¼€å§‹â”‚ â† offsetè¿˜æ²¡æäº¤ï¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T4: rebalanceå®Œæˆï¼Œæ¶ˆè´¹è€…Bæ¥ç®¡è¯¥åˆ†åŒº
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚æ¶ˆè´¹è€…Bæ¥ç®¡  â”‚ â† ä»ä¸Šæ¬¡æäº¤çš„offsetå¼€å§‹
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T5: æ¶ˆè´¹è€…Bé‡æ–°æ¶ˆè´¹æ¶ˆæ¯M1
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚é‡å¤å¤„ç†M1   â”‚ â† é‡å¤æ¶ˆè´¹å‘ç”Ÿï¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 å‡å°‘rebalanceçš„ç­–ç•¥


**ğŸ”¸ é…ç½®ä¼˜åŒ–**

```java
Properties props = new Properties();
// å¢åŠ ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå‡å°‘è¯¯åˆ¤
props.put("session.timeout.ms", "30000");        // 30ç§’
// å¢åŠ å¿ƒè·³é—´éš”
props.put("heartbeat.interval.ms", "10000");     // 10ç§’  
// å¢åŠ pollé—´éš”æ—¶é—´
props.put("max.poll.interval.ms", "300000");     // 5åˆ†é’Ÿ
// å‡å°‘æ¯æ¬¡pollçš„è®°å½•æ•°
props.put("max.poll.records", "100");            // æ¯æ¬¡æœ€å¤š100æ¡
```

**é…ç½®è¯´æ˜**ï¼š
- **session.timeout.ms**ï¼šæ¶ˆè´¹è€…è¢«è®¤ä¸ºæ­»äº¡çš„æ—¶é—´
- **heartbeat.interval.ms**ï¼šå‘é€å¿ƒè·³çš„é—´éš”
- **max.poll.interval.ms**ï¼šä¸¤æ¬¡poll()è°ƒç”¨çš„æœ€å¤§é—´éš”
- **max.poll.records**ï¼šæ¯æ¬¡poll()è¿”å›çš„æœ€å¤§è®°å½•æ•°

---

## 5. ğŸ“ offsetæäº¤æœºåˆ¶ä¸é‡å¤æ¶ˆè´¹


### 5.1 offsetçš„ä½œç”¨å’Œé‡è¦æ€§


**ç®€å•ç†è§£**ï¼š`offset`å°±åƒæ˜¯**ä¹¦ç­¾**ï¼Œè®°å½•ç€ä½ è¯»åˆ°äº†å“ªä¸€é¡µã€‚åœ¨Kafkaä¸­ï¼Œoffsetè®°å½•ç€æ¶ˆè´¹è€…è¯»åˆ°äº†å“ªä¸€æ¡æ¶ˆæ¯ã€‚

```
Topicåˆ†åŒºç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ 0 â”‚ 1 â”‚ 2 â”‚ 3 â”‚ 4 â”‚ 5 â”‚ 6 â”‚ â† æ¶ˆæ¯ä½ç½®ï¼ˆoffsetï¼‰
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
              â†‘
        å½“å‰æ¶ˆè´¹ä½ç½®ï¼ˆoffset=3ï¼‰
        ä¸‹æ¬¡ä»offset=4å¼€å§‹æ¶ˆè´¹
```

### 5.2 è‡ªåŠ¨æäº¤vsæ‰‹åŠ¨æäº¤


**ğŸ”¸ è‡ªåŠ¨æäº¤æ¨¡å¼**

```java
// è‡ªåŠ¨æäº¤é…ç½®
props.put("enable.auto.commit", "true");
props.put("auto.commit.interval.ms", "5000");  // æ¯5ç§’è‡ªåŠ¨æäº¤

// æ¶ˆè´¹ä»£ç 
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    for (ConsumerRecord<String, String> record : records) {
        processMessage(record);  // å¤„ç†æ¶ˆæ¯
        // offsetè‡ªåŠ¨æäº¤ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
    }
}
```

**è‡ªåŠ¨æäº¤çš„é—®é¢˜**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: poll()è·å–æ¶ˆæ¯
T2: å¼€å§‹å¤„ç†æ¶ˆæ¯
T3: è‡ªåŠ¨æäº¤offsetï¼ˆ5ç§’åˆ°äº†ï¼‰â† æäº¤å¤ªæ—©ï¼
T4: å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿå¼‚å¸¸      â† æ¶ˆæ¯ä¸¢å¤±äº†
```

**ğŸ”¸ æ‰‹åŠ¨æäº¤æ¨¡å¼**

```java
// æ‰‹åŠ¨æäº¤é…ç½®
props.put("enable.auto.commit", "false");

// åŒæ­¥æäº¤ç¤ºä¾‹
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
    for (ConsumerRecord<String, String> record : records) {
        try {
            processMessage(record);  // å¤„ç†æ¶ˆæ¯
            consumer.commitSync();   // åŒæ­¥æäº¤offset
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸ï¼Œä¸æäº¤offset
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

### 5.3 æäº¤å¤±è´¥å¯¼è‡´çš„é‡å¤æ¶ˆè´¹


**ğŸ”¸ ç½‘ç»œå¼‚å¸¸åœºæ™¯**

```
æ­£å¸¸æµç¨‹ï¼š
æ¶ˆè´¹æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡ â†’ æäº¤offset â†’ å®Œæˆ âœ“

å¼‚å¸¸æµç¨‹ï¼š
æ¶ˆè´¹æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡ â†’ æäº¤offset Ã— (ç½‘ç»œä¸­æ–­)
ç»“æœï¼šä¸‹æ¬¡å¯åŠ¨æ—¶é‡æ–°æ¶ˆè´¹è¯¥æ¶ˆæ¯
```

**ğŸ”¸ å¼‚æ­¥æäº¤ä¼˜åŒ–**

```java
// å¼‚æ­¥æäº¤ - æé«˜æ€§èƒ½
consumer.commitAsync((offsets, exception) -> {
    if (exception != null) {
        log.error("offsetæäº¤å¤±è´¥", exception);
        // å¯ä»¥è®°å½•å¤±è´¥çš„offsetï¼Œåç»­é‡è¯•
    }
});
```

---

## 6. ğŸ›¡ï¸ ç”Ÿäº§è€…å¹‚ç­‰æ€§è§£å†³æ–¹æ¡ˆ


### 6.1 ä»€ä¹ˆæ˜¯ç”Ÿäº§è€…å¹‚ç­‰æ€§


**é€šä¿—è§£é‡Š**ï¼š`å¹‚ç­‰æ€§`å°±åƒæ˜¯**æ™ºèƒ½ç”µæ¢¯æŒ‰é’®**ï¼Œæ— è®ºä½ æŒ‰å¤šå°‘æ¬¡åŒä¸€å±‚æ¥¼çš„æŒ‰é’®ï¼Œç”µæ¢¯åªä¼šå»é‚£ä¸€å±‚æ¥¼ä¸€æ¬¡ã€‚åœ¨Kafkaä¸­ï¼Œå¼€å¯å¹‚ç­‰æ€§åï¼Œ**åŒä¸€æ¡æ¶ˆæ¯æ— è®ºå‘é€å¤šå°‘æ¬¡ï¼Œéƒ½åªä¼šè¢«å­˜å‚¨ä¸€æ¬¡**ã€‚

### 6.2 enable.idempotenceé…ç½®è¯¦è§£


**ğŸ”¸ åŸºæœ¬é…ç½®**

```java
Properties props = new Properties();
props.put("enable.idempotence", "true");  // å¼€å¯å¹‚ç­‰æ€§

// å¹‚ç­‰æ€§è¦æ±‚çš„å…¶ä»–é…ç½®ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
// retries = Integer.MAX_VALUE
// max.in.flight.requests.per.connection <= 5
// acks = all
```

**å¹‚ç­‰æ€§å·¥ä½œåŸç†**ï¼š
```
æ²¡æœ‰å¹‚ç­‰æ€§ï¼š
æ¶ˆæ¯Aå‘é€ â†’ ç½‘ç»œé‡ä¼  â†’ Brokeræ”¶åˆ°é‡å¤æ¶ˆæ¯ â†’ å­˜å‚¨é‡å¤è®°å½•

æœ‰å¹‚ç­‰æ€§ï¼š
æ¶ˆæ¯Aå‘é€ â†’ ç½‘ç»œé‡ä¼  â†’ Brokeræ£€æµ‹é‡å¤ â†’ ä¸¢å¼ƒé‡å¤æ¶ˆæ¯
                                    â†‘
                            é€šè¿‡PID+åºåˆ—å·æ£€æµ‹
```

### 6.3 PIDå’Œåºåˆ—å·æœºåˆ¶


**ğŸ”¸ æŠ€æœ¯å®ç°åŸç†**

```
æ¯ä¸ªç”Ÿäº§è€…å®ä¾‹åˆ†é…ï¼š
- PID (Producer ID)ï¼šç”Ÿäº§è€…å”¯ä¸€æ ‡è¯†
- åºåˆ—å·ï¼šå•è°ƒé€’å¢çš„æ¶ˆæ¯åºå·

å¹‚ç­‰æ€§æ£€æµ‹ï¼š
Brokerç»´æŠ¤ï¼š(PID, åˆ†åŒº) â†’ æœ€å¤§åºåˆ—å·
æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶æ£€æŸ¥ï¼š
if (æ–°åºåˆ—å· <= æœ€å¤§åºåˆ—å·) {
    ä¸¢å¼ƒé‡å¤æ¶ˆæ¯;
} else {
    å­˜å‚¨æ¶ˆæ¯å¹¶æ›´æ–°æœ€å¤§åºåˆ—å·;
}
```

### 6.4 å¹‚ç­‰æ€§çš„å±€é™æ€§


**âš ï¸ é‡è¦é™åˆ¶**

| é™åˆ¶ç±»å‹ | **å…·ä½“è¯´æ˜** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| ğŸ”„ **å•ä¼šè¯æœ‰æ•ˆ** | `ç”Ÿäº§è€…é‡å¯åPIDä¼šå˜åŒ–` | `ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯` |
| ğŸ“Š **å•åˆ†åŒºæœ‰æ•ˆ** | `åªèƒ½ä¿è¯å•ä¸ªåˆ†åŒºå†…å¹‚ç­‰` | `åˆç†è®¾è®¡åˆ†åŒºç­–ç•¥` |
| â° **æ—¶é—´çª—å£é™åˆ¶** | `åªèƒ½æ£€æµ‹ä¸€å®šæ—¶é—´å†…çš„é‡å¤` | `é…ç½®åˆé€‚çš„ä¿ç•™æ—¶é—´` |

```java
// å±€é™æ€§ç¤ºä¾‹
// åœºæ™¯1ï¼šç”Ÿäº§è€…é‡å¯
Producer producer1 = new KafkaProducer<>(props);  // PID=100
producer1.send(record);  // åºåˆ—å·=1
producer1.close();

Producer producer2 = new KafkaProducer<>(props);  // PID=101 (æ–°çš„PID)
producer2.send(record);  // åºåˆ—å·=1ï¼Œä½†PIDä¸åŒï¼Œä¼šé‡å¤å­˜å‚¨

// åœºæ™¯2ï¼šè·¨åˆ†åŒºæ— æ³•ä¿è¯
producer.send(new ProducerRecord<>("topic", 0, "key", "msg"));  // åˆ†åŒº0
producer.send(new ProducerRecord<>("topic", 1, "key", "msg"));  // åˆ†åŒº1
// ä¸¤ä¸ªåˆ†åŒºå¯èƒ½éƒ½å­˜å‚¨ç›¸åŒçš„æ¶ˆæ¯
```

---

## 7. ğŸ¯ exactly-onceè¯­ä¹‰å®ç°


### 7.1 ä»€ä¹ˆæ˜¯exactly-once


**é€šä¿—ç†è§£**ï¼š`exactly-once`å°±åƒæ˜¯**ç²¾ç¡®çš„è¯å‰‚å¸ˆ**ï¼Œæ¯ç§è¯æéƒ½æ°å¥½æ”¾ä¸€ä»½ï¼Œä¸å¤šä¸å°‘ã€‚åœ¨Kafkaä¸­ï¼Œexactly-onceç¡®ä¿**æ¯æ¡æ¶ˆæ¯éƒ½è¢«ç²¾ç¡®å¤„ç†ä¸€æ¬¡ï¼Œæ—¢ä¸ä¸¢å¤±ä¹Ÿä¸é‡å¤**ã€‚

### 7.2 äº‹åŠ¡æ¶ˆæ¯æœºåˆ¶


**ğŸ”¸ äº‹åŠ¡æ¶ˆæ¯çš„åŸºæœ¬æ¦‚å¿µ**

```
ä¼ ç»Ÿæ¶ˆæ¯å¤„ç†ï¼š
å‘é€æ¶ˆæ¯ â†’ æ¶ˆè´¹æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡ â†’ æäº¤offset
        â†‘                           â†‘
    å„ä¸ªæ­¥éª¤ç‹¬ç«‹ï¼Œæ— æ³•ä¿è¯åŸå­æ€§

äº‹åŠ¡æ¶ˆæ¯å¤„ç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼€å¯äº‹åŠ¡                            â”‚
â”‚ â”œâ”€â”€ å‘é€æ¶ˆæ¯åˆ°è¾“å‡ºTopic             â”‚
â”‚ â”œâ”€â”€ å¤„ç†ä¸šåŠ¡é€»è¾‘                    â”‚
â”‚ â”œâ”€â”€ æäº¤æ¶ˆè´¹offset                  â”‚
â”‚ â””â”€â”€ æäº¤äº‹åŠ¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
    æ‰€æœ‰æ“ä½œåœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…
```

**ğŸ”¸ transactional.idäº‹åŠ¡æ ‡è¯†**

```java
// äº‹åŠ¡é…ç½®
Properties producerProps = new Properties();
producerProps.put("transactional.id", "my-transaction-id");  // äº‹åŠ¡ID
producerProps.put("enable.idempotence", "true");            // å¿…é¡»å¼€å¯å¹‚ç­‰

KafkaProducer<String, String> producer = new KafkaProducer<>(producerProps);
producer.initTransactions();  // åˆå§‹åŒ–äº‹åŠ¡
```

### 7.3 äº‹åŠ¡æ¶ˆæ¯å®Œæ•´ç¤ºä¾‹


```java
public class ExactlyOnceProcessor {
    
    public void processMessages() {
        producer.beginTransaction();  // å¼€å§‹äº‹åŠ¡
        
        try {
            // 1. æ¶ˆè´¹æ¶ˆæ¯
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
            
            for (ConsumerRecord<String, String> record : records) {
                // 2. å¤„ç†ä¸šåŠ¡é€»è¾‘
                String processedData = processBusinessLogic(record.value());
                
                // 3. å‘é€å¤„ç†ç»“æœåˆ°è¾“å‡ºTopic
                producer.send(new ProducerRecord<>("output-topic", processedData));
            }
            
            // 4. æäº¤æ¶ˆè´¹ä½ç§»åˆ°äº‹åŠ¡
            producer.sendOffsetsToTransaction(
                getCurrentOffsets(records), 
                consumer.groupMetadata()
            );
            
            // 5. æäº¤äº‹åŠ¡
            producer.commitTransaction();
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸æ—¶å›æ»šäº‹åŠ¡
            producer.abortTransaction();
            throw e;
        }
    }
}
```

### 7.4 isolation.leveléš”ç¦»çº§åˆ«


**ğŸ”¸ ä¸¤ç§éš”ç¦»çº§åˆ«å¯¹æ¯”**

```java
// æ¶ˆè´¹è€…é…ç½®
Properties consumerProps = new Properties();

// éš”ç¦»çº§åˆ«1ï¼šread_uncommitted (é»˜è®¤)
consumerProps.put("isolation.level", "read_uncommitted");
// å¯ä»¥è¯»å–æœªæäº¤çš„äº‹åŠ¡æ¶ˆæ¯

// éš”ç¦»çº§åˆ«2ï¼šread_committed
consumerProps.put("isolation.level", "read_committed");  
// åªèƒ½è¯»å–å·²æäº¤çš„äº‹åŠ¡æ¶ˆæ¯
```

**éš”ç¦»çº§åˆ«çš„å½±å“**ï¼š
```
äº‹åŠ¡å¤„ç†è¿‡ç¨‹ï¼š
T1: äº‹åŠ¡å¼€å§‹ï¼Œå†™å…¥æ¶ˆæ¯M1
T2: æ¶ˆæ¯M1åœ¨Brokerä¸­ï¼ˆæœªæäº¤çŠ¶æ€ï¼‰
T3: äº‹åŠ¡æäº¤

read_uncommittedæ¨¡å¼ï¼š
T2æ—¶åˆ»å°±èƒ½æ¶ˆè´¹åˆ°M1 â† å¯èƒ½è¯»åˆ°æœªæäº¤çš„æ•°æ®

read_committedæ¨¡å¼ï¼š
T3æ—¶åˆ»æ‰èƒ½æ¶ˆè´¹åˆ°M1 â† åªè¯»å·²æäº¤çš„æ•°æ®ï¼ˆæ¨èï¼‰
```

---

## 8. ğŸ”§ ä¸šåŠ¡å±‚å»é‡ç­–ç•¥


### 8.1 æ¶ˆæ¯å”¯ä¸€æ ‡è¯†è®¾è®¡


**ğŸ”¸ ä¸šåŠ¡çº§åˆ«å”¯ä¸€ID**

```java
public class MessageWithId {
    private String businessId;    // ä¸šåŠ¡å”¯ä¸€æ ‡è¯†
    private String messageId;     // æ¶ˆæ¯å”¯ä¸€æ ‡è¯†  
    private long timestamp;       // æ—¶é—´æˆ³
    private String data;          // ä¸šåŠ¡æ•°æ®
    
    // ç”Ÿæˆå”¯ä¸€æ ‡è¯†çš„ç­–ç•¥
    public static String generateMessageId(String businessKey) {
        return businessKey + "_" + System.currentTimeMillis() + "_" + UUID.randomUUID();
    }
}
```

**å”¯ä¸€æ ‡è¯†è®¾è®¡åŸåˆ™**ï¼š
- **ä¸šåŠ¡ç›¸å…³æ€§**ï¼šåŒ…å«ä¸šåŠ¡å…³é”®ä¿¡æ¯
- **å…¨å±€å”¯ä¸€æ€§**ï¼šè·¨ç³»ç»Ÿä¸é‡å¤
- **æ—¶é—´æœ‰åºæ€§**ï¼šä¾¿äºæ’åºå’ŒæŸ¥è¯¢
- **å¯è¯»æ€§**ï¼šä¾¿äºé—®é¢˜æ’æŸ¥

### 8.2 æ•°æ®åº“å”¯ä¸€çº¦æŸå»é‡


**ğŸ”¸ æ•°æ®åº“å±‚é¢é˜²é‡å¤**

```sql
-- åˆ›å»ºå¸¦å”¯ä¸€çº¦æŸçš„è¡¨
CREATE TABLE user_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(100) NOT NULL UNIQUE,  -- æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
    user_id BIGINT NOT NULL,
    order_amount DECIMAL(10,2),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å”¯ä¸€ç´¢å¼•ç¡®ä¿ä¸é‡å¤
CREATE UNIQUE INDEX uk_message_id ON user_orders(message_id);
```

```java
// Javaä»£ç å¤„ç†é‡å¤
public void processOrder(OrderMessage message) {
    try {
        // å°è¯•æ’å…¥è®¢å•
        orderDao.insertOrder(message);
        log.info("è®¢å•å¤„ç†æˆåŠŸ: {}", message.getMessageId());
        
    } catch (DuplicateKeyException e) {
        // æ•è·é‡å¤é”®å¼‚å¸¸ï¼Œè¯´æ˜æ¶ˆæ¯å·²å¤„ç†è¿‡
        log.warn("é‡å¤æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†: {}", message.getMessageId());
        // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè®¤ä¸ºå¤„ç†æˆåŠŸ
    }
}
```

### 8.3 Redisåˆ†å¸ƒå¼é”æœºåˆ¶


**ğŸ”¸ åŸºäºRedisçš„å»é‡å®ç°**

```java
public class RedisDeduplication {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean processMessageWithLock(String messageId, Runnable businessLogic) {
        String lockKey = "msg_lock:" + messageId;
        String processedKey = "msg_processed:" + messageId;
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
        if (redisTemplate.hasKey(processedKey)) {
            log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡: {}", messageId);
            return true;
        }
        
        // 2. è·å–åˆ†å¸ƒå¼é”
        Boolean lockAcquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "locked", Duration.ofMinutes(5));
            
        if (!lockAcquired) {
            log.warn("è·å–é”å¤±è´¥ï¼Œå¯èƒ½æœ‰å…¶ä»–å®ä¾‹åœ¨å¤„ç†: {}", messageId);
            return false;
        }
        
        try {
            // 3. å†æ¬¡æ£€æŸ¥ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
            if (redisTemplate.hasKey(processedKey)) {
                return true;
            }
            
            // 4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            businessLogic.run();
            
            // 5. æ ‡è®°ä¸ºå·²å¤„ç†
            redisTemplate.opsForValue()
                .set(processedKey, "processed", Duration.ofHours(24));
            
            return true;
            
        } finally {
            // 6. é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
}
```

### 8.4 å†…å­˜ç¼“å­˜å»é‡ç­–ç•¥


**ğŸ”¸ æœ¬åœ°ç¼“å­˜å®ç°**

```java
public class LocalDeduplication {
    
    // ä½¿ç”¨Guava Cacheå®ç°æœ¬åœ°å»é‡
    private final Cache<String, Boolean> processedMessages = CacheBuilder.newBuilder()
        .maximumSize(10000)                    // æœ€å¤šç¼“å­˜1ä¸‡æ¡
        .expireAfterWrite(1, TimeUnit.HOURS)   // 1å°æ—¶è¿‡æœŸ
        .build();
    
    public boolean isProcessed(String messageId) {
        return processedMessages.getIfPresent(messageId) != null;
    }
    
    public void markAsProcessed(String messageId) {
        processedMessages.put(messageId, true);
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void processMessage(String messageId, String data) {
        if (isProcessed(messageId)) {
            log.info("æœ¬åœ°ç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡é‡å¤æ¶ˆæ¯: {}", messageId);
            return;
        }
        
        try {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            doBusinessLogic(data);
            
            // æ ‡è®°ä¸ºå·²å¤„ç†
            markAsProcessed(messageId);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥: {}", messageId, e);
            throw e;
        }
    }
}
```

---

## 9. ğŸš€ æœ€ä½³å®è·µä¸æ•…éšœæ’é™¤


### 9.1 ç»¼åˆé˜²é‡å¤ç­–ç•¥


**ğŸ”¸ å¤šå±‚é˜²æŠ¤ä½“ç³»**

```
ç¬¬ä¸€å±‚ï¼šKafkaå±‚é¢
â”œâ”€â”€ ç”Ÿäº§è€…å¹‚ç­‰æ€§ (enable.idempotence=true)
â”œâ”€â”€ äº‹åŠ¡æ¶ˆæ¯ (transactional.id)
â””â”€â”€ åˆç†çš„æäº¤ç­–ç•¥

ç¬¬äºŒå±‚ï¼šåº”ç”¨å±‚é¢  
â”œâ”€â”€ æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
â”œâ”€â”€ æœ¬åœ°ç¼“å­˜å»é‡
â””â”€â”€ ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡

ç¬¬ä¸‰å±‚ï¼šå­˜å‚¨å±‚é¢
â”œâ”€â”€ æ•°æ®åº“å”¯ä¸€çº¦æŸ
â”œâ”€â”€ Redisåˆ†å¸ƒå¼é”
â””â”€â”€ ä¸šåŠ¡çŠ¶æ€æ£€æŸ¥
```

### 9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ”¸ æ‰¹é‡å¤„ç†ä¼˜åŒ–**

```java
public class BatchProcessor {
    
    public void processBatch(List<ConsumerRecord<String, String>> records) {
        // 1. æ‰¹é‡æ£€æŸ¥é‡å¤
        Set<String> messageIds = records.stream()
            .map(record -> extractMessageId(record.value()))
            .collect(Collectors.toSet());
            
        Set<String> processedIds = checkProcessedBatch(messageIds);
        
        // 2. è¿‡æ»¤æœªå¤„ç†çš„æ¶ˆæ¯
        List<ConsumerRecord<String, String>> unprocessedRecords = records.stream()
            .filter(record -> !processedIds.contains(extractMessageId(record.value())))
            .collect(Collectors.toList());
        
        if (unprocessedRecords.isEmpty()) {
            log.info("æ‰€æœ‰æ¶ˆæ¯éƒ½å·²å¤„ç†è¿‡ï¼Œè·³è¿‡æœ¬æ‰¹æ¬¡");
            return;
        }
        
        // 3. æ‰¹é‡å¤„ç†ä¸šåŠ¡é€»è¾‘
        processBatchBusinessLogic(unprocessedRecords);
        
        // 4. æ‰¹é‡æ ‡è®°å·²å¤„ç†
        markBatchAsProcessed(unprocessedRecords);
    }
}
```

### 9.3 ç›‘æ§å’Œå‘Šè­¦


**ğŸ”¸ å…³é”®ç›‘æ§æŒ‡æ ‡**

| ç›‘æ§é¡¹ | **è¯´æ˜** | **å‘Šè­¦é˜ˆå€¼** |
|-------|---------|-------------|
| ğŸ”„ **é‡å¤ç‡** | `é‡å¤æ¶ˆæ¯æ•°/æ€»æ¶ˆæ¯æ•°` | `> 5%` |
| â±ï¸ **å¤„ç†å»¶è¿Ÿ** | `æ¶ˆæ¯å¤„ç†çš„å¹³å‡æ—¶é—´` | `> 5ç§’` |
| ğŸ“Š **offsetæ»å** | `æ¶ˆè´¹æ»åçš„æ¶ˆæ¯æ•°é‡` | `> 1000æ¡` |
| ğŸš¨ **rebalanceé¢‘ç‡** | `æ¯å°æ—¶rebalanceæ¬¡æ•°` | `> 10æ¬¡` |

```java
// ç›‘æ§ä»£ç ç¤ºä¾‹
public class MessageProcessingMetrics {
    
    private final Counter duplicateCounter = Counter.build()
        .name("kafka_duplicate_messages_total")
        .help("é‡å¤æ¶ˆæ¯æ€»æ•°")
        .register();
        
    private final Histogram processingTime = Histogram.build()
        .name("kafka_message_processing_seconds")
        .help("æ¶ˆæ¯å¤„ç†æ—¶é—´")
        .register();
    
    public void recordDuplicate() {
        duplicateCounter.inc();
    }
    
    public Timer.Sample startTimer() {
        return processingTime.startTimer();
    }
}
```

### 9.4 å¸¸è§é—®é¢˜æ’æŸ¥


**ğŸ”¸ é—®é¢˜è¯Šæ–­æ¸…å•**

```
é‡å¤æ¶ˆè´¹é—®é¢˜æ’æŸ¥æ­¥éª¤ï¼š

1. æ£€æŸ¥æ¶ˆè´¹è€…é…ç½®
   âœ“ enable.auto.commitè®¾ç½®
   âœ“ auto.commit.interval.msé—´éš”
   âœ“ session.timeout.mså’Œmax.poll.interval.ms

2. æ£€æŸ¥ä¸šåŠ¡ä»£ç 
   âœ“ å¼‚å¸¸å¤„ç†æ˜¯å¦æ­£ç¡®
   âœ“ offsetæäº¤æ—¶æœº
   âœ“ å¹‚ç­‰æ€§å®ç°

3. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
   âœ“ rebalanceæ—¥å¿—
   âœ“ offsetæäº¤å¤±è´¥æ—¥å¿—
   âœ“ ç½‘ç»œå¼‚å¸¸æ—¥å¿—

4. æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
   âœ“ æ¶ˆè´¹lag
   âœ“ é‡å¤ç‡ç»Ÿè®¡
   âœ“ é”™è¯¯ç‡è¶‹åŠ¿
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é‡å¤æ¶ˆè´¹æœ¬è´¨ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ— æ³•ä¿è¯åŸå­æ€§å¯¼è‡´çš„é—®é¢˜
ğŸ”¸ at-least-onceè¯­ä¹‰ï¼šKafkaé»˜è®¤çš„æŠ•é€’ä¿è¯ï¼Œæ¶ˆæ¯è‡³å°‘æŠ•é€’ä¸€æ¬¡
ğŸ”¸ ç”Ÿäº§è€…å¹‚ç­‰æ€§ï¼šé€šè¿‡PID+åºåˆ—å·æœºåˆ¶é˜²æ­¢é‡å¤å†™å…¥
ğŸ”¸ äº‹åŠ¡æ¶ˆæ¯ï¼šæä¾›exactly-onceè¯­ä¹‰çš„å®Œæ•´è§£å†³æ–¹æ¡ˆ
ğŸ”¸ ä¸šåŠ¡å±‚å»é‡ï¼šå¤šå±‚é˜²æŠ¤ä½“ç³»ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
```

### 10.2 å®è·µè¦ç‚¹


**ğŸ”¹ é…ç½®å±‚é¢**
- åˆç†è®¾ç½®offsetæäº¤ç­–ç•¥
- å¼€å¯ç”Ÿäº§è€…å¹‚ç­‰æ€§
- é…ç½®åˆé€‚çš„è¶…æ—¶å‚æ•°
- é€‰æ‹©æ­£ç¡®çš„éš”ç¦»çº§åˆ«

**ğŸ”¹ ä»£ç å±‚é¢**
- è®¾è®¡ä¸šåŠ¡å¹‚ç­‰æ€§
- å®ç°æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
- æ·»åŠ é‡å¤æ£€æµ‹é€»è¾‘
- å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶

**ğŸ”¹ æ¶æ„å±‚é¢**
- å¤šå±‚é˜²é‡å¤ç­–ç•¥
- ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–è€ƒè™‘
- æ•…éšœæ¢å¤é¢„æ¡ˆ

### 10.3 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Kafkaé‡å¤æœ‰åŸå› ï¼Œåˆ†å¸ƒå¼ä¸‹éš¾é¿å…
at-least-onceæ˜¯é»˜è®¤ï¼Œå¹‚ç­‰äº‹åŠ¡æ¥å¢å¼º
offsetæäº¤è¦è°¨æ…ï¼Œrebalanceæ—¶éœ€å°å¿ƒ
ä¸šåŠ¡å»é‡å¤šå±‚æ¬¡ï¼Œå”¯ä¸€æ ‡è¯†æ˜¯å…³é”®
ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œé—®é¢˜æ’æŸ¥æœ‰ç« æ³•
```

**å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **é‡‘èç³»ç»Ÿ**ï¼šé˜²æ­¢é‡å¤æ‰£æ¬¾å’Œè½¬è´¦
- **ç”µå•†å¹³å°**ï¼šé¿å…é‡å¤ä¸‹å•å’Œåº“å­˜æ“ä½œ
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šç¡®ä¿æ•°æ®ç»Ÿè®¡çš„å‡†ç¡®æ€§
- **æ¶ˆæ¯é€šçŸ¥**ï¼šé˜²æ­¢ç”¨æˆ·æ”¶åˆ°é‡å¤æ¨é€