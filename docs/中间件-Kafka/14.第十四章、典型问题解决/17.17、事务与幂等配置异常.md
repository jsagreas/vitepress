---
title: 17ã€äº‹åŠ¡ä¸å¹‚ç­‰é…ç½®å¼‚å¸¸
---
## ğŸ“š ç›®å½•

1. [å¹‚ç­‰ä¸äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-å¹‚ç­‰ä¸äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [å¹‚ç­‰æ€§é…ç½®è¯¦è§£](#2-å¹‚ç­‰æ€§é…ç½®è¯¦è§£)
3. [äº‹åŠ¡æ€§é…ç½®æ ¸å¿ƒ](#3-äº‹åŠ¡æ€§é…ç½®æ ¸å¿ƒ)
4. [éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§](#4-éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§)
5. [äº‹åŠ¡åè°ƒå™¨æœºåˆ¶](#5-äº‹åŠ¡åè°ƒå™¨æœºåˆ¶)
6. [å¸¸è§é…ç½®å¼‚å¸¸å¤„ç†](#6-å¸¸è§é…ç½®å¼‚å¸¸å¤„ç†)
7. [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#7-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¹‚ç­‰ä¸äº‹åŠ¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
å¹‚ç­‰æ€§(Idempotence)ï¼šé‡å¤æ‰§è¡ŒåŒä¸€æ“ä½œå¤šæ¬¡ï¼Œç»“æœä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒ
ç®€å•ç†è§£ï¼šåŒä¸€æ¡æ¶ˆæ¯å‘é€å¤šæ¬¡ï¼ŒKafkaåªä¼šå­˜å‚¨ä¸€ä»½

ç°å®åœºæ™¯ç±»æ¯”ï¼š
é“¶è¡Œè½¬è´¦ï¼šé‡å¤ç‚¹å‡»è½¬è´¦æŒ‰é’®ï¼Œåªä¼šè½¬ä¸€æ¬¡é’±
ç”µæ¢¯æŒ‰é’®ï¼šé‡å¤æŒ‰åŒä¸€æ¥¼å±‚ï¼Œç”µæ¢¯åªåœä¸€æ¬¡
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§**
```
é—®é¢˜åœºæ™¯ï¼š
ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ â†’ ç½‘ç»œè¶…æ—¶ â†’ é‡è¯•å‘é€ â†’ äº§ç”Ÿé‡å¤æ¶ˆæ¯

ä¼ ç»Ÿæ–¹å¼ï¼š
æ¶ˆæ¯1: {id: 1001, amount: 100}
é‡è¯•å: {id: 1001, amount: 100}  // é‡å¤äº†ï¼
ç»“æœ: è´¦æˆ·è¢«æ‰£äº†200å…ƒ

å¹‚ç­‰æ–¹å¼ï¼š
æ¶ˆæ¯1: {id: 1001, amount: 100}
é‡è¯•å: Kafkaæ£€æµ‹åˆ°é‡å¤ï¼Œå¿½ç•¥
ç»“æœ: è´¦æˆ·åªæ‰£100å…ƒ âœ“
```

### 1.2 ä»€ä¹ˆæ˜¯äº‹åŠ¡æ€§


**ğŸ”¸ äº‹åŠ¡æ€§æ¦‚å¿µ**
```
äº‹åŠ¡æ€§(Transactional)ï¼šå¤šä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
ç®€å•ç†è§£ï¼šä¸€ç»„æ¶ˆæ¯è¦ä¹ˆå…¨éƒ¨å‘é€æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å‘é€

é“¶è¡Œè½¬è´¦ç±»æ¯”ï¼š
Aè´¦æˆ·æ‰£æ¬¾ + Bè´¦æˆ·å…¥è´¦ = ä¸€ä¸ªäº‹åŠ¡
è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å›æ»š
```

**ğŸ”„ äº‹åŠ¡çš„ACIDç‰¹æ€§**
```
åŸå­æ€§(Atomicity)ï¼šå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
ä¸€è‡´æ€§(Consistency)ï¼šæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€
éš”ç¦»æ€§(Isolation)ï¼šäº‹åŠ¡é—´ä¸äº’ç›¸å¹²æ‰°
æŒä¹…æ€§(Durability)ï¼šæäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜
```

### 1.3 å¹‚ç­‰æ€§vsäº‹åŠ¡æ€§


| **ç‰¹æ€§** | **å¹‚ç­‰æ€§** | **äº‹åŠ¡æ€§** |
|---------|-----------|-----------|
| **è§£å†³é—®é¢˜** | `é‡å¤æ¶ˆæ¯` | `å¤šæ¶ˆæ¯åŸå­æ€§` |
| **åº”ç”¨åœºæ™¯** | `ç½‘ç»œé‡è¯•ä¿æŠ¤` | `å¤šæ­¥éª¤æ“ä½œä¿è¯` |
| **å®ç°å¤æ‚åº¦** | `ç›¸å¯¹ç®€å•` | `å¤æ‚ï¼Œéœ€è¦åè°ƒå™¨` |
| **æ€§èƒ½å½±å“** | `è¾ƒå°` | `è¾ƒå¤§` |
| **ä½¿ç”¨é¢‘ç‡** | `å¸¸ç”¨` | `ç‰¹å®šåœºæ™¯` |

---

## 2. âš™ï¸ å¹‚ç­‰æ€§é…ç½®è¯¦è§£


### 2.1 enable.idempotenceæ ¸å¿ƒé…ç½®


**ğŸ”§ åŸºç¡€é…ç½®**
```properties
# å¯ç”¨å¹‚ç­‰æ€§ï¼ˆæœ€é‡è¦çš„é…ç½®ï¼‰
enable.idempotence=true

# å¹‚ç­‰æ€§ç›¸å…³çš„å¿…è¦é…ç½®ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
acks=all                    # å¿…é¡»ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
retries=Integer.MAX_VALUE   # å…è®¸æ— é™é‡è¯•
max.in.flight.requests.per.connection=5  # æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°
```

**ğŸ’¡ é…ç½®è§£é‡Š**
```
enable.idempotence=true ä½œç”¨ï¼š
1. ä¸ºæ¯ä¸ªç”Ÿäº§è€…åˆ†é…å”¯ä¸€çš„PIDï¼ˆProducer IDï¼‰
2. ä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…åºåˆ—å·
3. Brokeræ£€æŸ¥é‡å¤æ¶ˆæ¯å¹¶å»é‡

è‡ªåŠ¨å¼ºåˆ¶çš„é…ç½®è¯´æ˜ï¼š
- acks=allï¼šç¡®ä¿æ¶ˆæ¯è¢«æ‰€æœ‰å‰¯æœ¬ç¡®è®¤ï¼Œä¿è¯ä¸ä¸¢å¤±
- retries>0ï¼šå…è®¸é‡è¯•ï¼Œå¦åˆ™å¹‚ç­‰æ€§æ²¡æœ‰æ„ä¹‰  
- max.in.flight.requestsâ‰¤5ï¼šæ§åˆ¶ä¹±åºé—®é¢˜
```

### 2.2 ç”Ÿäº§è€…å¹‚ç­‰é…ç½®ç¤ºä¾‹


**ğŸ“ Javaç”Ÿäº§è€…é…ç½®**
```java
public class IdempotentProducer {
    public static void main(String[] args) {
        Properties props = new Properties();
        
        // åŸºç¡€è¿æ¥é…ç½®
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // å¹‚ç­‰æ€§é…ç½®
        props.put("enable.idempotence", true);
        
        // ä»¥ä¸‹é…ç½®ä¼šè‡ªåŠ¨è®¾ç½®ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼é…ç½®
        props.put("acks", "all");
        props.put("retries", Integer.MAX_VALUE);
        props.put("max.in.flight.requests.per.connection", 5);
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        
        // å‘é€æ¶ˆæ¯
        ProducerRecord<String, String> record = 
            new ProducerRecord<>("my-topic", "key1", "Hello Kafka");
        producer.send(record);
        
        producer.close();
    }
}
```

### 2.3 å¹‚ç­‰æ€§å·¥ä½œåŸç†


**ğŸ” å†…éƒ¨æœºåˆ¶å›¾è§£**
```
ç”Ÿäº§è€…ç«¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Producer App   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ æ¶ˆæ¯ï¼š{key: "user1", value: "login"}
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kafka Producer  â”‚ â† PID: 12345
â”‚                 â”‚ â† åºåˆ—å·: 0, 1, 2...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ æ¶ˆæ¯ï¼š{PID: 12345, seq: 0, data: "login"}
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kafka Broker   â”‚ â† æ£€æŸ¥ï¼šPID+seqæ˜¯å¦å·²å­˜åœ¨
â”‚                 â”‚ â† å­˜å‚¨ï¼šPID+åºåˆ—å·æ˜ å°„è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ é‡å¤æ£€æµ‹æµç¨‹**
```
ç¬¬ä¸€æ¬¡å‘é€ï¼š
PID: 12345, åºåˆ—å·: 0 â†’ Brokeræ£€æŸ¥ï¼šä¸å­˜åœ¨ â†’ å­˜å‚¨æ¶ˆæ¯

ç½‘ç»œè¶…æ—¶é‡è¯•ï¼š
PID: 12345, åºåˆ—å·: 0 â†’ Brokeræ£€æŸ¥ï¼šå·²å­˜åœ¨ â†’ è¿”å›æˆåŠŸï¼Œä¸é‡å¤å­˜å‚¨

ä¸‹ä¸€æ¡æ¶ˆæ¯ï¼š
PID: 12345, åºåˆ—å·: 1 â†’ Brokeræ£€æŸ¥ï¼šä¸å­˜åœ¨ â†’ å­˜å‚¨æ¶ˆæ¯
```

### 2.4 å¹‚ç­‰æ€§é™åˆ¶ä¸æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦é™åˆ¶**
```
å•ä¼šè¯å¹‚ç­‰ï¼š
- åªåœ¨å•ä¸ªProducerå®ä¾‹ç”Ÿå‘½å‘¨æœŸå†…æœ‰æ•ˆ
- Produceré‡å¯åPIDä¼šå˜åŒ–ï¼Œæ— æ³•å»é‡

å•åˆ†åŒºå¹‚ç­‰ï¼š
- åªèƒ½ä¿è¯å•ä¸ªåˆ†åŒºå†…çš„å¹‚ç­‰æ€§
- è·¨åˆ†åŒºæ— æ³•ä¿è¯ï¼ˆéœ€è¦äº‹åŠ¡æ€§ï¼‰

æ—¶é—´çª—å£é™åˆ¶ï¼š
- PIDæœ‰è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰
- è¶…è¿‡æ—¶é—´çª—å£å¯èƒ½é‡å¤
```

**ğŸ› ï¸ æœ€ä½³å®è·µ**
```java
// æ¨èçš„ç”Ÿäº§è€…é…ç½®
Properties props = new Properties();
props.put("enable.idempotence", true);
props.put("batch.size", 16384);          // é€‚å½“çš„æ‰¹æ¬¡å¤§å°
props.put("linger.ms", 10);              // é€‚å½“çš„å»¶è¿Ÿ
props.put("compression.type", "lz4");    // å¯ç”¨å‹ç¼©
props.put("request.timeout.ms", 30000);  // åˆç†çš„è¶…æ—¶æ—¶é—´
```

---

## 3. ğŸ” äº‹åŠ¡æ€§é…ç½®æ ¸å¿ƒ


### 3.1 transactional.idé…ç½®


**ğŸ”¸ äº‹åŠ¡IDçš„ä½œç”¨**
```
transactional.idï¼šäº‹åŠ¡æ€§ç”Ÿäº§è€…çš„å”¯ä¸€æ ‡è¯†ç¬¦
ä½œç”¨ï¼š
1. ä¿è¯è·¨ä¼šè¯çš„ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰
2. æ”¯æŒäº‹åŠ¡æ¢å¤å’Œæ•…éšœè½¬ç§»
3. å®ç°åƒµå°¸äº‹åŠ¡æ£€æµ‹å’Œæ¸…ç†

é…ç½®ç¤ºä¾‹ï¼š
transactional.id=my-transaction-id-001
```

**ğŸ’¡ äº‹åŠ¡IDå‘½åå»ºè®®**
```
å‘½åè§„åˆ™ï¼š
- å…¨å±€å”¯ä¸€ï¼šé¿å…ä¸åŒåº”ç”¨ä½¿ç”¨ç›¸åŒID
- æœ‰æ„ä¹‰ï¼šåŒ…å«åº”ç”¨æ ‡è¯†å’Œå®ä¾‹ä¿¡æ¯
- ç¨³å®šæ€§ï¼šé‡å¯åä½¿ç”¨ç›¸åŒIDä¿è¯æ¢å¤

æ¨èæ ¼å¼ï¼š
{åº”ç”¨å}-{å®ä¾‹ID}-{åŠŸèƒ½æ¨¡å—}

ç¤ºä¾‹ï¼š
order-service-001-payment
user-service-002-registration
inventory-service-001-update
```

### 3.2 äº‹åŠ¡æ€§ç”Ÿäº§è€…é…ç½®


**ğŸ“ å®Œæ•´äº‹åŠ¡é…ç½®**
```java
public class TransactionalProducer {
    private static final String TRANSACTION_ID = "order-processor-001";
    
    public static void main(String[] args) {
        Properties props = new Properties();
        
        // åŸºç¡€é…ç½®
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // äº‹åŠ¡é…ç½®
        props.put("transactional.id", TRANSACTION_ID);
        props.put("enable.idempotence", true);  // äº‹åŠ¡æ€§éšå«å¹‚ç­‰æ€§
        
        // äº‹åŠ¡è¶…æ—¶é…ç½®
        props.put("transaction.timeout.ms", 60000);  // 1åˆ†é’Ÿè¶…æ—¶
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
        
        // åˆå§‹åŒ–äº‹åŠ¡
        producer.initTransactions();
        
        try {
            // å¼€å§‹äº‹åŠ¡
            producer.beginTransaction();
            
            // å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆåŸå­æ“ä½œï¼‰
            producer.send(new ProducerRecord<>("order-events", "order1", "created"));
            producer.send(new ProducerRecord<>("inventory-events", "item1", "reserved"));
            producer.send(new ProducerRecord<>("payment-events", "payment1", "processed"));
            
            // æäº¤äº‹åŠ¡
            producer.commitTransaction();
            System.out.println("äº‹åŠ¡æäº¤æˆåŠŸ");
            
        } catch (Exception e) {
            // å›æ»šäº‹åŠ¡
            producer.abortTransaction();
            System.out.println("äº‹åŠ¡å›æ»š: " + e.getMessage());
        } finally {
            producer.close();
        }
    }
}
```

### 3.3 äº‹åŠ¡è¶…æ—¶é…ç½®


**â±ï¸ è¶…æ—¶å‚æ•°è¯¦è§£**
```properties
# äº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç”Ÿäº§è€…ç«¯ï¼‰
transaction.timeout.ms=60000

# äº‹åŠ¡çŠ¶æ€è¿‡æœŸæ—¶é—´ï¼ˆBrokerç«¯ï¼‰  
transactional.id.expiration.ms=604800000

# äº‹åŠ¡åè°ƒå™¨è¶…æ—¶
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
```

**ğŸ”§ è¶…æ—¶é…ç½®å»ºè®®**
```
çŸ­äº‹åŠ¡ï¼ˆæ¨èï¼‰ï¼š
transaction.timeout.ms=30000    # 30ç§’
é€‚ç”¨ï¼šç®€å•çš„å¤šæ¶ˆæ¯å‘é€

ä¸­ç­‰äº‹åŠ¡ï¼š
transaction.timeout.ms=60000    # 1åˆ†é’Ÿ  
é€‚ç”¨ï¼šåŒ…å«ä¸€äº›ä¸šåŠ¡é€»è¾‘çš„äº‹åŠ¡

é•¿äº‹åŠ¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ï¼š
transaction.timeout.ms=300000   # 5åˆ†é’Ÿ
é€‚ç”¨ï¼šå¤æ‚çš„æ‰¹å¤„ç†ä»»åŠ¡

æ³¨æ„ï¼šè¶…æ—¶æ—¶é—´è¿‡é•¿ä¼šå½±å“æ€§èƒ½ï¼Œè¿‡çŸ­å¯èƒ½å¯¼è‡´äº‹åŠ¡å¼‚å¸¸ä¸­æ­¢
```

---

## 4. ğŸ“Š éš”ç¦»çº§åˆ«ä¸ä¸€è‡´æ€§


### 4.1 isolation.levelé…ç½®


**ğŸ”¸ æ¶ˆè´¹è€…éš”ç¦»çº§åˆ«**
```properties
# æ¶ˆè´¹è€…éš”ç¦»çº§åˆ«é…ç½®
isolation.level=read_committed    # é»˜è®¤ï¼šread_uncommitted
```

**ğŸ’¡ éš”ç¦»çº§åˆ«å¯¹æ¯”**
```
read_uncommittedï¼ˆè¯»æœªæäº¤ï¼‰ï¼š
- å¯ä»¥è¯»å–æ‰€æœ‰æ¶ˆæ¯ï¼ŒåŒ…æ‹¬æœªæäº¤çš„äº‹åŠ¡æ¶ˆæ¯
- æ€§èƒ½æœ€å¥½ï¼Œä½†å¯èƒ½è¯»åˆ°"è„æ•°æ®"
- é€‚ç”¨ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯

read_committedï¼ˆè¯»å·²æäº¤ï¼‰ï¼š
- åªèƒ½è¯»å–å·²æäº¤äº‹åŠ¡çš„æ¶ˆæ¯
- ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†æ€§èƒ½ç•¥ä½
- é€‚ç”¨ï¼šéœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯
```

### 4.2 ä¸€è‡´æ€§çº§åˆ«å›¾è§£


**ğŸ“ˆ æ•°æ®ä¸€è‡´æ€§ç¤ºæ„**
```
æ—¶é—´çº¿ï¼šT1 -------- T2 -------- T3 -------- T4

äº‹åŠ¡1ï¼š  [å¼€å§‹] -------- [æ¶ˆæ¯A] -------- [æäº¤] 
äº‹åŠ¡2ï¼š         [å¼€å§‹] -------- [æ¶ˆæ¯B] -------- [å›æ»š]

read_uncommitted æ¶ˆè´¹è€…è§†å›¾ï¼š
T1: æ— æ¶ˆæ¯
T2: çœ‹åˆ°æ¶ˆæ¯Aå’ŒB  â† å¯èƒ½çœ‹åˆ°åæ¥å›æ»šçš„æ¶ˆæ¯B
T3: çœ‹åˆ°æ¶ˆæ¯Aå’ŒB
T4: çœ‹åˆ°æ¶ˆæ¯Aå’ŒB

read_committed æ¶ˆè´¹è€…è§†å›¾ï¼š
T1: æ— æ¶ˆæ¯
T2: æ— æ¶ˆæ¯         â† ç­‰å¾…äº‹åŠ¡æäº¤/å›æ»š
T3: çœ‹åˆ°æ¶ˆæ¯A      â† åªçœ‹åˆ°å·²æäº¤çš„æ¶ˆæ¯A
T4: çœ‹åˆ°æ¶ˆæ¯A      â† æ¶ˆæ¯Bè¢«å›æ»šï¼Œä¸å¯è§
```

### 4.3 exactly-onceè¯­ä¹‰å®ç°


**ğŸ¯ ç²¾ç¡®ä¸€æ¬¡è¯­ä¹‰ç»„åˆ**
```
Exactly-Once = å¹‚ç­‰æ€§ + äº‹åŠ¡æ€§ + read_committed

ç”Ÿäº§è€…ç«¯ï¼š
enable.idempotence=true          # é˜²é‡å¤
transactional.id=my-app-001      # äº‹åŠ¡ä¿è¯

æ¶ˆè´¹è€…ç«¯ï¼š
isolation.level=read_committed   # åªè¯»å·²æäº¤
enable.auto.commit=false         # æ‰‹åŠ¨æäº¤offset

ç»„åˆæ•ˆæœï¼š
1. æ¶ˆæ¯ä¸ä¼šé‡å¤ï¼ˆå¹‚ç­‰æ€§ï¼‰
2. å¤šæ¶ˆæ¯åŸå­æ€§ï¼ˆäº‹åŠ¡æ€§ï¼‰
3. åªæ¶ˆè´¹ç¡®å®šæ•°æ®ï¼ˆéš”ç¦»æ€§ï¼‰
```

**ğŸ“ Exactly-Onceæ¶ˆè´¹ç¤ºä¾‹**
```java
public class ExactlyOnceConsumer {
    public static void main(String[] args) {
        Properties props = new Properties();
        props.put("bootstrap.servers", "localhost:9092");
        props.put("group.id", "exactly-once-group");
        props.put("key.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        props.put("value.deserializer", "org.apache.kafka.common.serialization.StringDeserializer");
        
        // å…³é”®é…ç½®
        props.put("isolation.level", "read_committed");
        props.put("enable.auto.commit", false);
        
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);
        consumer.subscribe(Arrays.asList("my-topic"));
        
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
            
            for (ConsumerRecord<String, String> record : records) {
                // å¤„ç†æ¶ˆæ¯
                System.out.println("æ¶ˆè´¹æ¶ˆæ¯: " + record.value());
                
                // æ‰‹åŠ¨æäº¤offsetï¼ˆç¡®ä¿å¤„ç†å®Œæˆåæ‰æäº¤ï¼‰
                consumer.commitSync();
            }
        }
    }
}
```

---

## 5. ğŸ¤ äº‹åŠ¡åè°ƒå™¨æœºåˆ¶


### 5.1 äº‹åŠ¡åè°ƒå™¨ä½œç”¨


**ğŸ”¸ åè°ƒå™¨èŒè´£**
```
äº‹åŠ¡åè°ƒå™¨(Transaction Coordinator)ï¼š
1. ç®¡ç†äº‹åŠ¡çŠ¶æ€ï¼ˆå¼€å§‹ã€è¿›è¡Œä¸­ã€å·²æäº¤ã€å·²ä¸­æ­¢ï¼‰
2. åè°ƒç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„äº‹åŠ¡æ“ä½œ
3. è®°å½•äº‹åŠ¡æ—¥å¿—ï¼Œæ”¯æŒæ•…éšœæ¢å¤
4. å¤„ç†åƒµå°¸äº‹åŠ¡æ£€æµ‹å’Œæ¸…ç†
```

**ğŸ—ï¸ åè°ƒå™¨æ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Producer 1    â”‚    â”‚   Producer 2    â”‚    â”‚   Producer 3    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Transaction Coordinator â”‚ â† ç®¡ç†æ‰€æœ‰äº‹åŠ¡
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Partition 1   â”‚    â”‚   Partition 2   â”‚    â”‚   Partition 3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¸¤é˜¶æ®µæäº¤åè®®


**ğŸ“‹ 2PCæµç¨‹è¯¦è§£**
```
é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ(Prepare Phase)
åè°ƒå™¨ â†’ æ‰€æœ‰å‚ä¸è€…ï¼šè¯¢é—®æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡
å‚ä¸è€… â†’ åè°ƒå™¨ï¼šå›å¤å‡†å¤‡å°±ç»ªæˆ–æ— æ³•æäº¤

é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ(Commit Phase)  
å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡å°±ç»ªï¼š
  åè°ƒå™¨ â†’ æ‰€æœ‰å‚ä¸è€…ï¼šå‘é€æäº¤æŒ‡ä»¤
  å‚ä¸è€…æ‰§è¡Œæäº¤ï¼Œè¿”å›ç¡®è®¤
å¦åˆ™ï¼š
  åè°ƒå™¨ â†’ æ‰€æœ‰å‚ä¸è€…ï¼šå‘é€ä¸­æ­¢æŒ‡ä»¤
  å‚ä¸è€…æ‰§è¡Œå›æ»šï¼Œè¿”å›ç¡®è®¤
```

**âš¡ Kafkaäº‹åŠ¡2PCç¤ºä¾‹**
```
äº‹åŠ¡å¼€å§‹ï¼š
Producer â†’ Coordinatorï¼šBeginTransaction(txn-id-001)
Coordinatorï¼šè®°å½•äº‹åŠ¡å¼€å§‹çŠ¶æ€

å‘é€æ¶ˆæ¯ï¼š
Producer â†’ Partition1ï¼šSendMessage(data1) with txn-id-001
Producer â†’ Partition2ï¼šSendMessage(data2) with txn-id-001
Coordinatorï¼šè®°å½•å‚ä¸çš„åˆ†åŒº

æäº¤å‡†å¤‡ï¼š
Producer â†’ Coordinatorï¼šPrepareCommit(txn-id-001)
Coordinator â†’ Partition1ï¼šPrepareCommit
Coordinator â†’ Partition2ï¼šPrepareCommit

æœ€ç»ˆæäº¤ï¼š
Coordinator â†’ Partition1ï¼šDoCommit
Coordinator â†’ Partition2ï¼šDoCommit
Coordinatorï¼šæ›´æ–°äº‹åŠ¡çŠ¶æ€ä¸ºå·²æäº¤
```

### 5.3 äº‹åŠ¡æ—¥å¿—ç®¡ç†


**ğŸ“ äº‹åŠ¡çŠ¶æ€å­˜å‚¨**
```properties
# äº‹åŠ¡çŠ¶æ€ä¸»é¢˜é…ç½®
transaction.state.log.replication.factor=3    # å‰¯æœ¬æ•°
transaction.state.log.min.isr=2               # æœ€å°åŒæ­¥å‰¯æœ¬æ•°
transaction.state.log.segment.bytes=104857600 # æ®µå¤§å°100MB
```

**ğŸ—ƒï¸ äº‹åŠ¡çŠ¶æ€ç±»å‹**
```
Emptyï¼šåˆå§‹çŠ¶æ€ï¼Œäº‹åŠ¡ä¸å­˜åœ¨
Ongoingï¼šäº‹åŠ¡è¿›è¡Œä¸­ï¼Œæ­£åœ¨å‘é€æ¶ˆæ¯
PrepareCommitï¼šå‡†å¤‡æäº¤çŠ¶æ€
PrepareAbortï¼šå‡†å¤‡ä¸­æ­¢çŠ¶æ€  
CompleteCommitï¼šæäº¤å®Œæˆ
CompleteAbortï¼šä¸­æ­¢å®Œæˆ
Deadï¼šäº‹åŠ¡å·²è¿‡æœŸæˆ–è¢«æ¸…ç†

çŠ¶æ€è½¬æ¢æµç¨‹ï¼š
Empty â†’ Ongoing â†’ PrepareCommit â†’ CompleteCommit
                      â†“
                PrepareAbort â†’ CompleteAbort
```

---

## 6. ğŸš¨ å¸¸è§é…ç½®å¼‚å¸¸å¤„ç†


### 6.1 å¹‚ç­‰æ€§é…ç½®å¼‚å¸¸


**âŒ å¸¸è§é”™è¯¯1ï¼šé…ç½®å†²çª**
```
é”™è¯¯é…ç½®ï¼š
enable.idempotence=true
acks=1                    # å†²çªï¼å¹‚ç­‰æ€§è¦æ±‚acks=all

å¼‚å¸¸ä¿¡æ¯ï¼š
InvalidConfigurationException: 
Must set acks to all in order to use the idempotent producer

è§£å†³æ–¹æ¡ˆï¼š
enable.idempotence=true
acks=all                  # æ­£ç¡®é…ç½®
```

**âŒ å¸¸è§é”™è¯¯2ï¼šé‡è¯•æ¬¡æ•°è®¾ç½®**
```
é”™è¯¯é…ç½®ï¼š
enable.idempotence=true
retries=0                 # å†²çªï¼å¹‚ç­‰æ€§éœ€è¦é‡è¯•

è§£å†³æ–¹æ¡ˆï¼š
enable.idempotence=true
retries=Integer.MAX_VALUE # æˆ–è€…ä¸è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
```

**ğŸ”§ å¹‚ç­‰æ€§å¼‚å¸¸è¯Šæ–­**
```java
// è¯Šæ–­ä»£ç ç¤ºä¾‹
public void diagnoseIdempotenceIssues() {
    try {
        Properties props = new Properties();
        props.put("enable.idempotence", true);
        props.put("acks", "1");  // é”™è¯¯é…ç½®
        
        KafkaProducer<String, String> producer = new KafkaProducer<>(props);
    } catch (ConfigException e) {
        System.out.println("é…ç½®é”™è¯¯: " + e.getMessage());
        // æ£€æŸ¥å¹¶ä¿®æ­£é…ç½®
    }
}
```

### 6.2 äº‹åŠ¡é…ç½®å¼‚å¸¸


**âŒ å¸¸è§é”™è¯¯3ï¼šäº‹åŠ¡IDé‡å¤**
```
å¼‚å¸¸åœºæ™¯ï¼š
å¤šä¸ªç”Ÿäº§è€…å®ä¾‹ä½¿ç”¨ç›¸åŒçš„transactional.id

å¼‚å¸¸ä¿¡æ¯ï¼š
ProducerFencedException: 
Producer with transactional.id 'my-app-001' is fenced

åŸå› åˆ†æï¼š
Kafkaæ£€æµ‹åˆ°åŒä¸€ä¸ªäº‹åŠ¡IDçš„æ–°ç”Ÿäº§è€…ï¼Œä¼šéš”ç¦»(fence)æ—§ç”Ÿäº§è€…

è§£å†³æ–¹æ¡ˆï¼š
1. ç¡®ä¿æ¯ä¸ªç”Ÿäº§è€…å®ä¾‹ä½¿ç”¨å”¯ä¸€çš„äº‹åŠ¡ID
2. æ­£ç¡®å¤„ç†ç”Ÿäº§è€…æ•…éšœè½¬ç§»
```

**âŒ å¸¸è§é”™è¯¯4ï¼šäº‹åŠ¡è¶…æ—¶**
```
å¼‚å¸¸ä¿¡æ¯ï¼š
TimeoutException: 
Transaction timeout expired

å¸¸è§åŸå› ï¼š
1. ä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ—¶é—´è¿‡é•¿
2. transaction.timeout.msè®¾ç½®è¿‡å°
3. ç½‘ç»œå»¶è¿Ÿæˆ–Brokerè´Ÿè½½é«˜

è§£å†³æ–¹æ¡ˆï¼š
# å¢åŠ è¶…æ—¶æ—¶é—´
transaction.timeout.ms=120000

# ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘
å°†é•¿æ—¶é—´æ“ä½œç§»å‡ºäº‹åŠ¡èŒƒå›´
```

### 6.3 éš”ç¦»çº§åˆ«å¼‚å¸¸


**âš ï¸ æ€§èƒ½å½±å“åˆ†æ**
```
read_committedæ¨¡å¼çš„æ€§èƒ½å¼€é”€ï¼š

æ¶ˆè´¹å»¶è¿Ÿï¼š
- éœ€è¦ç­‰å¾…äº‹åŠ¡æäº¤æ‰èƒ½æ¶ˆè´¹
- é•¿äº‹åŠ¡ä¼šé˜»å¡æ¶ˆè´¹è¿›åº¦

å†…å­˜å¼€é”€ï¼š
- Brokeréœ€è¦ç¼“å­˜æœªæäº¤çš„æ¶ˆæ¯
- å¤§é‡å¹¶å‘äº‹åŠ¡ä¼šå¢åŠ å†…å­˜å‹åŠ›

ååé‡å½±å“ï¼š
- ç›¸æ¯”read_uncommittedæ¨¡å¼é™ä½10-30%
- å…·ä½“å½±å“å–å†³äºäº‹åŠ¡ä½¿ç”¨é¢‘ç‡
```

**ğŸ› ï¸ ä¼˜åŒ–å»ºè®®**
```
åˆç†é€‰æ‹©éš”ç¦»çº§åˆ«ï¼š
- å®æ—¶æ€§è¦æ±‚é«˜ï¼šä½¿ç”¨read_uncommitted
- ä¸€è‡´æ€§è¦æ±‚é«˜ï¼šä½¿ç”¨read_committed

ç›‘æ§å…³é”®æŒ‡æ ‡ï¼š
- consumer-lagï¼šæ¶ˆè´¹å»¶è¿Ÿ
- transaction-durationï¼šäº‹åŠ¡æŒç»­æ—¶é—´
- memory-usageï¼šå†…å­˜ä½¿ç”¨æƒ…å†µ
```

---

## 7. ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§


### 7.1 äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–


**âš¡ ä¼˜åŒ–ç­–ç•¥**
```
1. å‡å°äº‹åŠ¡èŒƒå›´ï¼š
âŒ é”™è¯¯åšæ³•ï¼š
beginTransaction();
for (int i = 0; i < 10000; i++) {
    producer.send(record);
    Thread.sleep(10);  // ä¸å¿…è¦çš„å»¶è¿Ÿ
}
commitTransaction();

âœ… æ­£ç¡®åšæ³•ï¼š
beginTransaction();
for (int i = 0; i < 100; i++) {
    producer.send(record);  // æ‰¹é‡å‘é€ï¼Œå¿«é€Ÿæäº¤
}
commitTransaction();

2. æ‰¹é‡æ“ä½œï¼š
producer.send(record1);
producer.send(record2);
producer.send(record3);  // ä¸€ä¸ªäº‹åŠ¡å‘é€å¤šæ¡æ¶ˆæ¯

3. å¼‚æ­¥å‘é€ï¼š
producer.send(record, callback);  // ä½¿ç”¨å¼‚æ­¥æé«˜å¹¶å‘
```

**ğŸ”§ æ€§èƒ½é…ç½®è°ƒä¼˜**
```properties
# æ‰¹æ¬¡ä¼˜åŒ–
batch.size=65536                  # å¢å¤§æ‰¹æ¬¡å¤§å°
linger.ms=10                      # é€‚å½“å»¶è¿Ÿç­‰å¾…æ‰¹é‡

# å†…å­˜ä¼˜åŒ–  
buffer.memory=67108864            # å¢å¤§ç¼“å†²åŒº
max.block.ms=30000                # é€‚å½“çš„é˜»å¡æ—¶é—´

# ç½‘ç»œä¼˜åŒ–
send.buffer.bytes=131072          # å‘é€ç¼“å†²åŒº
receive.buffer.bytes=131072       # æ¥æ”¶ç¼“å†²åŒº

# äº‹åŠ¡ä¼˜åŒ–
transaction.timeout.ms=60000      # åˆç†çš„äº‹åŠ¡è¶…æ—¶
max.in.flight.requests.per.connection=5
```

### 7.2 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ“Š ç”Ÿäº§è€…ç›‘æ§**
```
äº‹åŠ¡ç›¸å…³æŒ‡æ ‡ï¼š
- transaction-duration-avgï¼šå¹³å‡äº‹åŠ¡æŒç»­æ—¶é—´
- transaction-countï¼šäº‹åŠ¡æ€»æ•°
- transaction-abort-rateï¼šäº‹åŠ¡ä¸­æ­¢ç‡

å¹‚ç­‰æ€§ç›¸å…³æŒ‡æ ‡ï¼š
- duplicate-send-rateï¼šé‡å¤å‘é€ç‡
- idempotent-producer-countï¼šå¹‚ç­‰ç”Ÿäº§è€…æ•°é‡

æ€§èƒ½æŒ‡æ ‡ï¼š
- records-per-request-avgï¼šæ¯è¯·æ±‚è®°å½•æ•°
- record-send-rateï¼šè®°å½•å‘é€é€Ÿç‡
- batch-size-avgï¼šå¹³å‡æ‰¹æ¬¡å¤§å°
```

**ğŸ“Š ç›‘æ§ä»ªè¡¨æ¿é…ç½®**
```yaml
# Prometheusç›‘æ§é…ç½®ç¤ºä¾‹
kafka_producer_transaction_duration_avg{job="kafka-producer"}
kafka_producer_transaction_abort_rate{job="kafka-producer"}  
kafka_producer_duplicate_send_rate{job="kafka-producer"}
```

### 7.3 æ•…éšœæ¢å¤æœºåˆ¶


**ğŸ”„ åƒµå°¸äº‹åŠ¡æ¸…ç†**
```
åƒµå°¸äº‹åŠ¡æ£€æµ‹ï¼š
åè°ƒå™¨å®šæœŸæ£€æŸ¥é•¿æ—¶é—´æœªæ›´æ–°çš„äº‹åŠ¡
è¶…è¿‡transactional.id.expiration.msçš„äº‹åŠ¡è¢«æ ‡è®°ä¸ºåƒµå°¸äº‹åŠ¡

æ¸…ç†æµç¨‹ï¼š
1. æ ‡è®°äº‹åŠ¡ä¸ºDeadçŠ¶æ€
2. å‘å‚ä¸åˆ†åŒºå‘é€AbortTransactionæ ‡è®°
3. æ¸…ç†äº‹åŠ¡çŠ¶æ€æ—¥å¿—
4. é‡Šæ”¾ç›¸å…³èµ„æº

é…ç½®å‚æ•°ï¼š
transactional.id.expiration.ms=604800000  # 7å¤©è¿‡æœŸ
transaction.abort.timed.out.transaction.cleanup.interval.ms=60000  # 1åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
```

**ğŸ› ï¸ æ•…éšœè½¬ç§»æœ€ä½³å®è·µ**
```java
public class RobustTransactionalProducer {
    private KafkaProducer<String, String> producer;
    private String transactionId;
    
    public void handleFailover() {
        try {
            // å°è¯•æ­£å¸¸å…³é—­
            if (producer != null) {
                producer.close(Duration.ofSeconds(10));
            }
        } catch (Exception e) {
            // å¿½ç•¥å…³é—­å¼‚å¸¸
        }
        
        // é‡æ–°åˆ›å»ºç”Ÿäº§è€…ï¼ˆä½¿ç”¨ç›¸åŒçš„äº‹åŠ¡IDï¼‰
        createNewProducer();
        
        // åˆå§‹åŒ–äº‹åŠ¡ï¼ˆä¼šè‡ªåŠ¨å¤„ç†ä¹‹å‰çš„åƒµå°¸äº‹åŠ¡ï¼‰
        producer.initTransactions();
    }
    
    private void createNewProducer() {
        Properties props = new Properties();
        props.put("transactional.id", transactionId);
        props.put("enable.idempotence", true);
        producer = new KafkaProducer<>(props);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹‚ç­‰æ€§ï¼šé˜²é‡å¤æ¶ˆæ¯ï¼Œå•ä¼šè¯å•åˆ†åŒºæœ‰æ•ˆ
ğŸ”¸ äº‹åŠ¡æ€§ï¼šå¤šæ¶ˆæ¯åŸå­æ“ä½œï¼Œæ”¯æŒè·¨åˆ†åŒºè·¨ä¼šè¯
ğŸ”¸ éš”ç¦»çº§åˆ«ï¼šread_committedä¿è¯ä¸€è‡´æ€§ï¼Œread_uncommittedæä¾›æ€§èƒ½
ğŸ”¸ åè°ƒå™¨ï¼šç®¡ç†äº‹åŠ¡çŠ¶æ€ï¼Œå®ç°ä¸¤é˜¶æ®µæäº¤åè®®
ğŸ”¸ exactly-onceï¼šå¹‚ç­‰æ€§+äº‹åŠ¡æ€§+éš”ç¦»çº§åˆ«çš„ç»„åˆ
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ å¹‚ç­‰æ€§é…ç½®**
```
å¿…é¡»é…ç½®ï¼š
enable.idempotence=true

è‡ªåŠ¨è®¾ç½®ï¼ˆå¯æ˜¾å¼é…ç½®ï¼‰ï¼š
acks=all
retries>0  
max.in.flight.requests.per.connectionâ‰¤5
```

**ğŸ”¹ äº‹åŠ¡æ€§é…ç½®**
```
æ ¸å¿ƒé…ç½®ï¼š
transactional.id=å”¯ä¸€æ ‡è¯†ç¬¦
enable.idempotence=true

è¶…æ—¶é…ç½®ï¼š
transaction.timeout.ms=60000ï¼ˆå»ºè®®30-60ç§’ï¼‰

éš”ç¦»çº§åˆ«ï¼š
isolation.level=read_committedï¼ˆæ¶ˆè´¹è€…ç«¯ï¼‰
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä½¿ç”¨åœºæ™¯é€‰æ‹©**
```
ä»…éœ€é˜²é‡å¤ï¼š
â†’ åªé…ç½®å¹‚ç­‰æ€§
â†’ é€‚ç”¨ï¼šå•æ¡æ¶ˆæ¯å‘é€ï¼Œç½‘ç»œä¸ç¨³å®šç¯å¢ƒ

éœ€è¦åŸå­æ€§ï¼š
â†’ é…ç½®äº‹åŠ¡æ€§ï¼ˆåŒ…å«å¹‚ç­‰æ€§ï¼‰
â†’ é€‚ç”¨ï¼šå¤šæ¡ç›¸å…³æ¶ˆæ¯ï¼Œéœ€è¦å…¨éƒ¨æˆåŠŸæˆ–å¤±è´¥

å¼ºä¸€è‡´æ€§è¦æ±‚ï¼š
â†’ äº‹åŠ¡æ€§ + read_committedéš”ç¦»çº§åˆ«
â†’ é€‚ç”¨ï¼šé‡‘èã€æ”¯ä»˜ç­‰å…³é”®ä¸šåŠ¡
```

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
äº‹åŠ¡èŒƒå›´æœ€å°åŒ–ï¼š
- å‡å°‘äº‹åŠ¡å†…çš„ä¸šåŠ¡é€»è¾‘
- å¿«é€Ÿå‘é€ï¼Œå¿«é€Ÿæäº¤

æ‰¹é‡æ“ä½œï¼š
- ä¸€ä¸ªäº‹åŠ¡å‘é€å¤šæ¡æ¶ˆæ¯
- åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°

ç›‘æ§å…³é”®æŒ‡æ ‡ï¼š
- äº‹åŠ¡æŒç»­æ—¶é—´
- äº‹åŠ¡ä¸­æ­¢ç‡
- æ¶ˆè´¹å»¶è¿Ÿ
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
```
é…ç½®å†²çªï¼š
- å¹‚ç­‰æ€§ä¸acksã€retriesçš„å…¼å®¹æ€§
- äº‹åŠ¡IDçš„å”¯ä¸€æ€§è¦æ±‚

æ€§èƒ½å½±å“ï¼š
- read_committedæ¨¡å¼çš„å»¶è¿Ÿå¢åŠ 
- é•¿äº‹åŠ¡å¯¹ç³»ç»Ÿçš„å½±å“

æ•…éšœå¤„ç†ï¼š
- åƒµå°¸äº‹åŠ¡çš„æ£€æµ‹å’Œæ¸…ç†
- ç”Ÿäº§è€…æ•…éšœè½¬ç§»ç­–ç•¥
```

### 8.4 æ•…éšœæ’æŸ¥æŒ‡å—


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**
```
æ¶ˆæ¯é‡å¤ï¼š
1. æ£€æŸ¥enable.idempotenceé…ç½®
2. ç¡®è®¤PIDæ˜¯å¦æ­£å¸¸åˆ†é…
3. æ£€æŸ¥ç½‘ç»œé‡è¯•é…ç½®

äº‹åŠ¡å¤±è´¥ï¼š
1. æ£€æŸ¥transactional.idå”¯ä¸€æ€§
2. ç¡®è®¤äº‹åŠ¡è¶…æ—¶é…ç½®
3. æŸ¥çœ‹åè°ƒå™¨æ—¥å¿—

æ€§èƒ½é—®é¢˜ï¼š
1. ç›‘æ§äº‹åŠ¡æŒç»­æ—¶é—´
2. æ£€æŸ¥æ‰¹æ¬¡å¤§å°é…ç½®
3. åˆ†æéš”ç¦»çº§åˆ«å½±å“
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¹‚ç­‰æ€§é˜²é‡å¤ï¼Œäº‹åŠ¡æ€§ä¿åŸå­
- é…ç½®è¦åŒ¹é…ï¼Œè¶…æ—¶è¦åˆç†
- ç›‘æ§å¾ˆé‡è¦ï¼Œæ•…éšœè¦é¢„æ¡ˆ
- æ€§èƒ½ä¸ä¸€è‡´æ€§éœ€è¦å¹³è¡¡è€ƒè™‘