---
title: 3ã€æ¶ˆæ¯ä¹±åºé—®é¢˜
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯ä¹±åºé—®é¢˜æ¦‚è¿°](#1-æ¶ˆæ¯ä¹±åºé—®é¢˜æ¦‚è¿°)
2. [åˆ†åŒºå†…æœ‰åºä¿è¯æœºåˆ¶](#2-åˆ†åŒºå†…æœ‰åºä¿è¯æœºåˆ¶)
3. [ç”Ÿäº§è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜](#3-ç”Ÿäº§è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜)
4. [æ¶ˆè´¹è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜](#4-æ¶ˆè´¹è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜)
5. [ä¹±åºé—®é¢˜è§£å†³æ–¹æ¡ˆ](#5-ä¹±åºé—®é¢˜è§£å†³æ–¹æ¡ˆ)
6. [é¡ºåºæ¶ˆæ¯æœ€ä½³å®è·µ](#6-é¡ºåºæ¶ˆæ¯æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¶ˆæ¯ä¹±åºé—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¹±åº


**ç®€å•ç†è§£ï¼š** å°±åƒé‚®é€’å‘˜é€ä¿¡ï¼Œå¦‚æœç¬¬1å°ä¿¡æ¯”ç¬¬2å°ä¿¡æ™šåˆ°ï¼Œè¿™å°±æ˜¯"ä¹±åº"äº†

```
æ­£å¸¸é¡ºåºï¼šè®¢å•åˆ›å»º â†’ æ”¯ä»˜æˆåŠŸ â†’ å‘è´§é€šçŸ¥ â†’ æ”¶è´§ç¡®è®¤
ä¹±åºæƒ…å†µï¼šè®¢å•åˆ›å»º â†’ å‘è´§é€šçŸ¥ â†’ æ”¯ä»˜æˆåŠŸ â†’ æ”¶è´§ç¡®è®¤
ç»“æœï¼šä¸šåŠ¡é€»è¾‘å‡ºé”™ï¼âŒ
```

### 1.2 ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¹±åº


**æ ¹æœ¬åŸå› åˆ†æï¼š**

| å±‚é¢ | **é€ æˆä¹±åºçš„åŸå› ** | **å½±å“ç¨‹åº¦** |
|------|------------------|-------------|
| ğŸš€ **ç½‘ç»œä¼ è¾“** | ç½‘ç»œå»¶è¿Ÿä¸ä¸€è‡´ | `ä¸­ç­‰` |
| ğŸ”„ **ç”Ÿäº§è€…é‡è¯•** | å¤±è´¥é‡è¯•å¯¼è‡´é¡ºåºæ‰“ä¹± | `é«˜` |
| âš¡ **å¹¶å‘å¤„ç†** | å¤šçº¿ç¨‹åŒæ—¶å¤„ç†æ¶ˆæ¯ | `é«˜` |
| ğŸ“¦ **åˆ†åŒºæœºåˆ¶** | æ¶ˆæ¯åˆ†æ•£åˆ°ä¸åŒåˆ†åŒº | `æé«˜` |

### 1.3 ä¹±åºå¸¦æ¥çš„ä¸šåŠ¡å½±å“


> âš ï¸ **å…¸å‹ä¸šåŠ¡åœºæ™¯é—®é¢˜**
>
> **ç”µå•†è®¢å•ï¼š** å…ˆæ”¶åˆ°"å‘è´§"å†æ”¶åˆ°"æ”¯ä»˜"ï¼Œç³»ç»Ÿä»¥ä¸ºç”¨æˆ·æ²¡ä»˜é’±å°±å‘è´§äº†
> 
> **è´¦æˆ·ä½™é¢ï¼š** å…ˆæ‰£æ¬¾åå…¥è´¦ï¼Œå¯èƒ½å¯¼è‡´ä½™é¢ä¸ºè´Ÿæ•°
> 
> **çŠ¶æ€æœºï¼š** çŠ¶æ€è½¬æ¢é¡ºåºé”™è¯¯ï¼Œä¸šåŠ¡æµç¨‹æ— æ³•æ­£å¸¸è¿›è¡Œ

**ä¸šåŠ¡é£é™©è¯„ä¼°ï¼š**
- ğŸ”´ **é«˜é£é™©ï¼š** é‡‘èäº¤æ˜“ã€è®¢å•çŠ¶æ€
- ğŸŸ¡ **ä¸­é£é™©ï¼š** ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
- ğŸŸ¢ **ä½é£é™©ï¼š** ç»Ÿè®¡æ•°æ®ã€ç›‘æ§æŒ‡æ ‡

---

## 2. ğŸ“‹ åˆ†åŒºå†…æœ‰åºä¿è¯æœºåˆ¶


### 2.1 Kafkaçš„æœ‰åºæ€§æ‰¿è¯º


**æ ¸å¿ƒåŸç†ï¼š** Kafkaåªä¿è¯**åŒä¸€ä¸ªåˆ†åŒºå†…**çš„æ¶ˆæ¯æœ‰åº

```
Topic: order-events (3ä¸ªåˆ†åŒº)

åˆ†åŒº0: [æ¶ˆæ¯A] â†’ [æ¶ˆæ¯B] â†’ [æ¶ˆæ¯C]  âœ… åˆ†åŒºå†…æœ‰åº
åˆ†åŒº1: [æ¶ˆæ¯D] â†’ [æ¶ˆæ¯E] â†’ [æ¶ˆæ¯F]  âœ… åˆ†åŒºå†…æœ‰åº  
åˆ†åŒº2: [æ¶ˆæ¯G] â†’ [æ¶ˆæ¯H] â†’ [æ¶ˆæ¯I]  âœ… åˆ†åŒºå†…æœ‰åº

å…¨å±€é¡ºåº: Aã€Dã€Gã€Bã€Eã€Hã€Cã€Fã€I  âŒ å…¨å±€æ— åº
```

### 2.2 åˆ†åŒºé€‰æ‹©æœºåˆ¶


**é»˜è®¤åˆ†åŒºç­–ç•¥ï¼š**

```
æ¶ˆæ¯åˆ†åŒºåˆ†é…æµç¨‹ï¼š

æœ‰åˆ†åŒºé”®(key) â”€â”€â”€â”€â†’ hash(key) % åˆ†åŒºæ•° â”€â”€â”€â”€â†’ å›ºå®šåˆ†åŒº
     â”‚
     â””â”€ æ— åˆ†åŒºé”® â”€â”€â”€â”€â†’ è½®è¯¢åˆ†é… â”€â”€â”€â”€â†’ éšæœºåˆ†åŒº
```

**åˆ†åŒºé”®é€‰æ‹©ç¤ºä¾‹ï¼š**

| ä¸šåŠ¡åœºæ™¯ | **åˆ†åŒºé”®é€‰æ‹©** | **æ•ˆæœ** |
|----------|---------------|----------|
| ç”¨æˆ·æ“ä½œ | `ç”¨æˆ·ID` | åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œæœ‰åº |
| è®¢å•æµç¨‹ | `è®¢å•ID` | åŒä¸€è®¢å•çš„çŠ¶æ€å˜æ›´æœ‰åº |
| è®¾å¤‡æ•°æ® | `è®¾å¤‡ID` | åŒä¸€è®¾å¤‡çš„æ•°æ®æœ‰åº |

```java
// ğŸ¯ æ­£ç¡®çš„åˆ†åŒºé”®ä½¿ç”¨
producer.send(new ProducerRecord<>(
    "order-topic",
    orderId,        // åˆ†åŒºé”®ï¼šè®¢å•ID
    orderEvent      // æ¶ˆæ¯å†…å®¹
));
```

### 2.3 åˆ†åŒºå†…æœ‰åºçš„å®ç°åŸç†


**åº•å±‚å­˜å‚¨ç»“æ„ï¼š**

```
åˆ†åŒºæ–‡ä»¶å­˜å‚¨ï¼š
partition-0/
â”œâ”€â”€ 00000000000000000000.log  â† æ¶ˆæ¯æŒ‰é¡ºåºå†™å…¥
â”œâ”€â”€ 00000000000000000000.index
â””â”€â”€ 00000000000000000000.timeindex

æ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„å­˜å‚¨ï¼š
[offset:0][æ¶ˆæ¯A] â†’ [offset:1][æ¶ˆæ¯B] â†’ [offset:2][æ¶ˆæ¯C]
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**
>
> Kafkaçš„æ—¥å¿—æ–‡ä»¶æ˜¯**è¿½åŠ å†™å…¥**çš„ï¼Œè¿™å¤©ç„¶ä¿è¯äº†åŒä¸€åˆ†åŒºå†…æ¶ˆæ¯çš„é¡ºåºæ€§

---

## 3. âš¡ ç”Ÿäº§è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜


### 3.1 é‡è¯•æœºåˆ¶å¯¼è‡´ä¹±åº


**é—®é¢˜åŸç†ï¼š** å½“æ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•æ—¶ï¼Œå¯èƒ½æ‰“ç ´åŸæœ‰é¡ºåº

```
æ—¶é—´çº¿åˆ†æï¼š

T1: å‘é€æ¶ˆæ¯A â”€â”€â”€â”€â†’ ç½‘ç»œå¼‚å¸¸ï¼Œå‡†å¤‡é‡è¯•
T2: å‘é€æ¶ˆæ¯B â”€â”€â”€â”€â†’ å‘é€æˆåŠŸ âœ…
T3: é‡è¯•æ¶ˆæ¯A â”€â”€â”€â”€â†’ å‘é€æˆåŠŸ âœ…

ç»“æœï¼šBrokeræ”¶åˆ°é¡ºåºä¸º B â†’ A ï¼ˆä¹±åºäº†ï¼ï¼‰
```

### 3.2 å…³é”®é…ç½®å‚æ•°è¯¦è§£


**ğŸ”§ `max.in.flight.requests.per.connection`**

```
é…ç½®è¯´æ˜ï¼šå…è®¸å®¢æˆ·ç«¯åœ¨æ”¶åˆ°å“åº”å‰å‘é€çš„è¯·æ±‚æ•°

max.in.flight.requests.per.connection = 1:
è¯·æ±‚1 â”€â”€â”€â”€â†’ ç­‰å¾…å“åº” â”€â”€â”€â”€â†’ è¯·æ±‚2 â”€â”€â”€â”€â†’ ç­‰å¾…å“åº”
ä¼˜ç‚¹ï¼šä¸¥æ ¼ä¿è¯é¡ºåº âœ…
ç¼ºç‚¹ï¼šååé‡è¾ƒä½ âš ï¸

max.in.flight.requests.per.connection = 5:
è¯·æ±‚1 â”€â”€â”€â”€â†’ ç«‹å³å‘é€è¯·æ±‚2 â”€â”€â”€â”€â†’ ç«‹å³å‘é€è¯·æ±‚3...
ä¼˜ç‚¹ï¼šååé‡é«˜ âœ…  
ç¼ºç‚¹ï¼šå¯èƒ½ä¹±åº âŒ
```

**âš–ï¸ é…ç½®æƒè¡¡è¡¨ï¼š**

| é…ç½®å€¼ | **ååé‡** | **é¡ºåºä¿è¯** | **é€‚ç”¨åœºæ™¯** |
|--------|-----------|-------------|-------------|
| `1` | â­â­ | â­â­â­â­â­ | ä¸¥æ ¼é¡ºåºè¦æ±‚ |
| `2-3` | â­â­â­â­ | â­â­â­ | å¹³è¡¡åœºæ™¯ |
| `5+` | â­â­â­â­â­ | â­ | é«˜ååéœ€æ±‚ |

### 3.3 ç”Ÿäº§è€…é…ç½®æœ€ä½³å®è·µ


**ğŸ¯ é¡ºåºä¼˜å…ˆé…ç½®ï¼š**

```properties
# å…³é”®é…ç½®é¡¹
max.in.flight.requests.per.connection=1
retries=Integer.MAX_VALUE
acks=all
enable.idempotence=true
```

**ğŸ“Š é…ç½®æ•ˆæœå¯¹æ¯”ï¼š**

```
åœºæ™¯ï¼šå‘é€1000æ¡æ¶ˆæ¯çš„æ€§èƒ½å¯¹æ¯”

é»˜è®¤é…ç½®:
ååé‡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
é¡ºåºæ€§: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 40%

é¡ºåºä¼˜å…ˆé…ç½®:
ååé‡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%
é¡ºåºæ€§: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
```

---

## 4. ğŸ”„ æ¶ˆè´¹è€…å¯¼è‡´çš„ä¹±åºé—®é¢˜


### 4.1 å¤šçº¿ç¨‹æ¶ˆè´¹ä¹±åº


**é—®é¢˜åœºæ™¯ï¼š** æ¶ˆè´¹è€…ç”¨å¤šçº¿ç¨‹å¤„ç†æ¶ˆæ¯æ—¶æ‰“ç ´äº†é¡ºåº

```
æ¶ˆè´¹è€…å¤„ç†æµç¨‹ï¼š

å•çº¿ç¨‹å¤„ç†ï¼š
æ¶ˆæ¯A â†’ å¤„ç†A â†’ æäº¤A â†’ æ¶ˆæ¯B â†’ å¤„ç†B â†’ æäº¤B  âœ…

å¤šçº¿ç¨‹å¤„ç†ï¼š
æ¶ˆæ¯A â†’ çº¿ç¨‹1å¤„ç†A â”
                   â”œâ”€ å¯èƒ½Bå…ˆå¤„ç†å®Œ âŒ
æ¶ˆæ¯B â†’ çº¿ç¨‹2å¤„ç†B â”˜
```

### 4.2 æäº¤ä½ç§»å¯¼è‡´ä¹±åº


**ä½ç§»æäº¤æ—¶åºé—®é¢˜ï¼š**

```
é”™è¯¯çš„å¤„ç†æ–¹å¼ï¼š

æ¶ˆè´¹æ¶ˆæ¯A(offset=100) â†’ å¼€å§‹å¤„ç†A
æ¶ˆè´¹æ¶ˆæ¯B(offset=101) â†’ å¼€å§‹å¤„ç†B  
æ¶ˆæ¯Bå¤„ç†å®Œæˆ â†’ æäº¤offset=102 âŒ  
æ¶ˆæ¯Aå¤„ç†å¤±è´¥ â†’ Aä¸¢å¤±ï¼

æ­£ç¡®çš„å¤„ç†æ–¹å¼ï¼š

æ¶ˆè´¹æ¶ˆæ¯A(offset=100) â†’ å¤„ç†å®ŒA â†’ æäº¤offset=101 âœ…
æ¶ˆè´¹æ¶ˆæ¯B(offset=101) â†’ å¤„ç†å®ŒB â†’ æäº¤offset=102 âœ…
```

### 4.3 åˆ†åŒºåˆ†é…ç­–ç•¥å½±å“


**ğŸ”„ åˆ†åŒºåˆ†é…ç­–ç•¥å¯¹æ¯”ï¼š**

| ç­–ç•¥ç±»å‹ | **ç‰¹ç‚¹** | **é¡ºåºæ€§å½±å“** |
|----------|----------|---------------|
| **RoundRobin** | è½®è¯¢åˆ†é… | å¯èƒ½æ‰“ç ´é¡ºåº |
| **Range** | èŒƒå›´åˆ†é… | ç›¸å¯¹ç¨³å®š |
| **Sticky** | ç²˜æ€§åˆ†é… | æœ€ä½³é¡ºåºä¿è¯ |

**Stickyç­–ç•¥ä¼˜åŠ¿ç¤ºä¾‹ï¼š**

```
Rebalanceå‰ï¼š
Consumer1: [åˆ†åŒº0, åˆ†åŒº1]
Consumer2: [åˆ†åŒº2, åˆ†åŒº3]

Consumer1ä¸‹çº¿åï¼š
RoundRobin: Consumer2è·å¾—[åˆ†åŒº0,åˆ†åŒº2,åˆ†åŒº1,åˆ†åŒº3] âŒ é¡ºåºå˜åŒ–
Sticky:     Consumer2è·å¾—[åˆ†åŒº2,åˆ†åŒº3,åˆ†åŒº0,åˆ†åŒº1] âœ… å°½é‡ä¿æŒ
```

---

## 5. ğŸ› ï¸ ä¹±åºé—®é¢˜è§£å†³æ–¹æ¡ˆ


### 5.1 ç”Ÿäº§è€…ç«¯è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šå•åˆ†åŒº + ä¸¥æ ¼é…ç½®**

```java
// é…ç½®ç”Ÿäº§è€…ä¿è¯é¡ºåº
Properties props = new Properties();
props.put("max.in.flight.requests.per.connection", 1);
props.put("retries", Integer.MAX_VALUE);
props.put("acks", "all");
props.put("enable.idempotence", true);

// ä½¿ç”¨å›ºå®šåˆ†åŒºé”®
producer.send(new ProducerRecord<>(
    "order-topic",
    orderService.getOrderId(),  // å›ºå®šåˆ†åŒºé”®
    orderEvent
));
```

**æ–¹æ¡ˆäºŒï¼šä¸šåŠ¡å±‚åºåˆ—å·æ§åˆ¶**

```java
// æ¶ˆæ¯æ·»åŠ åºåˆ—å·
public class OrderEvent {
    private String orderId;
    private Long sequenceNumber;  // ä¸šåŠ¡åºåˆ—å·
    private String eventType;
    private Long timestamp;
}

// ç”Ÿäº§è€…å‘é€æ—¶æ·»åŠ åºåˆ—å·
public void sendOrderEvent(OrderEvent event) {
    event.setSequenceNumber(getNextSequence(event.getOrderId()));
    producer.send(new ProducerRecord<>("order-topic", 
        event.getOrderId(), event));
}
```

### 5.2 æ¶ˆè´¹è€…ç«¯è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šå•çº¿ç¨‹é¡ºåºå¤„ç†**

```java
// ç®€å•ä½†æœ‰æ•ˆçš„å•çº¿ç¨‹å¤„ç†
@KafkaListener(topics = "order-topic")
public void handleOrderEvent(OrderEvent event) {
    try {
        // ä¸šåŠ¡å¤„ç†é€»è¾‘
        processOrderEvent(event);
        
        // æ‰‹åŠ¨æäº¤ä½ç§»ï¼ˆç¡®ä¿å¤„ç†å®Œæˆï¼‰
        acknowledgment.acknowledge();
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ä¸æäº¤ä½ç§»
        log.error("å¤„ç†è®¢å•äº‹ä»¶å¤±è´¥: {}", event, e);
    }
}
```

**æ–¹æ¡ˆäºŒï¼šåˆ†åŒºçº§åˆ«çš„çº¿ç¨‹æ± **

```java
// ä¸ºæ¯ä¸ªåˆ†åŒºåˆ›å»ºå•ç‹¬çš„å¤„ç†çº¿ç¨‹
public class PartitionOrderedConsumer {
    private final Map<Integer, BlockingQueue<ConsumerRecord>> partitionQueues;
    private final Map<Integer, Thread> partitionWorkers;
    
    public void processRecord(ConsumerRecord record) {
        int partition = record.partition();
        
        // å°†æ¶ˆæ¯æ”¾å…¥å¯¹åº”åˆ†åŒºçš„é˜Ÿåˆ—
        partitionQueues.get(partition).offer(record);
        
        // æ¯ä¸ªåˆ†åŒºå•çº¿ç¨‹å¤„ç†ï¼Œä¿è¯åˆ†åŒºå†…é¡ºåº
        if (!partitionWorkers.containsKey(partition)) {
            startWorkerForPartition(partition);
        }
    }
}
```

### 5.3 ä¸šåŠ¡å±‚è§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šæ¶ˆæ¯å»é‡ + é¡ºåºæ£€æŸ¥**

```java
public class OrderEventProcessor {
    private final RedisTemplate redis;
    
    public void processEvent(OrderEvent event) {
        String key = "order:sequence:" + event.getOrderId();
        Long expectedSeq = redis.opsForValue().get(key);
        
        if (expectedSeq == null) expectedSeq = 0L;
        
        if (event.getSequenceNumber() == expectedSeq + 1) {
            // é¡ºåºæ­£ç¡®ï¼Œå¤„ç†æ¶ˆæ¯
            doProcess(event);
            redis.opsForValue().set(key, event.getSequenceNumber());
        } else if (event.getSequenceNumber() <= expectedSeq) {
            // é‡å¤æ¶ˆæ¯ï¼Œå¿½ç•¥
            log.info("é‡å¤æ¶ˆæ¯: {}", event);
        } else {
            // ä¹±åºæ¶ˆæ¯ï¼Œæš‚å­˜ç­‰å¾…
            redis.opsForList().rightPush(
                "order:pending:" + event.getOrderId(), 
                event);
        }
    }
}
```

---

## 6. â­ é¡ºåºæ¶ˆæ¯æœ€ä½³å®è·µ


### 6.1 æ¶æ„è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡åŸåˆ™ä¼˜å…ˆçº§ï¼š**

```
1ï¸âƒ£ ä¸šåŠ¡åˆ†æ â†’ ç¡®å®šæ˜¯å¦çœŸçš„éœ€è¦å…¨å±€é¡ºåº
2ï¸âƒ£ åˆ†åŒºè®¾è®¡ â†’ åˆç†é€‰æ‹©åˆ†åŒºé”®å’Œåˆ†åŒºæ•°
3ï¸âƒ£ é…ç½®ä¼˜åŒ– â†’ å¹³è¡¡æ€§èƒ½å’Œé¡ºåºæ€§
4ï¸âƒ£ å®¹é”™å¤„ç† â†’ å¤„ç†å¼‚å¸¸æƒ…å†µçš„é¡ºåºä¿è¯
```

### 6.2 ä¸åŒä¸šåŠ¡åœºæ™¯çš„å¤„ç†ç­–ç•¥


**ğŸ“Š ä¸šåŠ¡åœºæ™¯åˆ†ç±»å¤„ç†ï¼š**

| åœºæ™¯ç±»å‹ | **é¡ºåºè¦æ±‚** | **æ¨èæ–¹æ¡ˆ** | **æ€§èƒ½å½±å“** |
|----------|-------------|-------------|-------------|
| ğŸ¦ **é‡‘èäº¤æ˜“** | ä¸¥æ ¼å…¨å±€é¡ºåº | å•åˆ†åŒº + ä¸¥æ ¼é…ç½® | æ€§èƒ½è¾ƒä½ï¼Œä½†å¿…é¡» |
| ğŸ›’ **è®¢å•æµç¨‹** | å•è®¢å•é¡ºåº | è®¢å•IDåˆ†åŒºé”® | æ€§èƒ½è‰¯å¥½ |
| ğŸ“Š **ç”¨æˆ·è¡Œä¸º** | å•ç”¨æˆ·é¡ºåº | ç”¨æˆ·IDåˆ†åŒºé”® | æ€§èƒ½è‰¯å¥½ |
| ğŸ“ˆ **ç›‘æ§æ•°æ®** | æ—¶é—´çª—å£é¡ºåº | æ—¶é—´æˆ³ + ä¸šåŠ¡å¤„ç† | é«˜æ€§èƒ½ |

### 6.3 å…¨å±€é¡ºåºæ¶ˆæ¯è®¾è®¡


**æ–¹æ¡ˆï¼šå•åˆ†åŒº + é«˜å¯ç”¨**

```
æ¶æ„è®¾è®¡ï¼š

Producer â†’ Topic(1ä¸ªåˆ†åŒº) â†’ Consumer Group
           â†“
      Leader Replica
      Follower Replica 1  
      Follower Replica 2

é…ç½®è¦ç‚¹ï¼š
- åˆ†åŒºæ•°: 1
- å‰¯æœ¬æ•°: 3+ 
- min.insync.replicas: 2
- acks: all
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š**

```
ä¼˜åŒ–æ‰‹æ®µ                     æ€§èƒ½æå‡
æ‰¹é‡å‘é€(batch.size)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ +80%
å‹ç¼©(compression.type)      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ +60%
å¼‚æ­¥å‘é€+å›è°ƒ               â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ +70%
```

### 6.4 æ—¶é—´æˆ³æœºåˆ¶åº”ç”¨


**æ¶ˆæ¯æ—¶é—´æˆ³çš„å¦™ç”¨ï¼š**

```java
// åœ¨æ¶ˆæ¯ä¸­æ·»åŠ å¤šç§æ—¶é—´æˆ³
public class TimestampedEvent {
    private Long producerTimestamp;    // ç”Ÿäº§æ—¶é—´
    private Long logAppendTimestamp;   // Kafkaå†™å…¥æ—¶é—´  
    private Long consumerTimestamp;    // æ¶ˆè´¹æ—¶é—´
    private Long businessTimestamp;    // ä¸šåŠ¡æ—¶é—´
}

// åŸºäºæ—¶é—´æˆ³çš„é¡ºåºæ¢å¤
public void processWithTimestampOrder(List<TimestampedEvent> events) {
    events.sort(Comparator.comparing(
        TimestampedEvent::getBusinessTimestamp));
    
    for (TimestampedEvent event : events) {
        processEvent(event);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†åŒºå†…æœ‰åºï¼šKafkaåªä¿è¯åŒä¸€åˆ†åŒºå†…æ¶ˆæ¯æœ‰åº
ğŸ”¸ åˆ†åŒºé”®é‡è¦æ€§ï¼šåˆç†çš„åˆ†åŒºé”®æ˜¯é¡ºåºä¿è¯çš„åŸºç¡€  
ğŸ”¸ ç”Ÿäº§è€…é…ç½®ï¼šmax.in.flight.requests.per.connectionæ˜¯å…³é”®
ğŸ”¸ æ¶ˆè´¹è€…å¤„ç†ï¼šå•çº¿ç¨‹å¤„ç†æ˜¯æœ€ç®€å•å¯é çš„æ–¹æ¡ˆ
ğŸ”¸ ä¸šåŠ¡è®¾è®¡ï¼šå¹¶éæ‰€æœ‰åœºæ™¯éƒ½éœ€è¦ä¸¥æ ¼çš„å…¨å±€é¡ºåº
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½•æ—¶éœ€è¦é¡ºåºä¿è¯**
```
âœ… éœ€è¦é¡ºåºçš„åœºæ™¯ï¼š
- çŠ¶æ€æœºè½¬æ¢ï¼ˆè®¢å•çŠ¶æ€å˜æ›´ï¼‰
- é‡‘èäº¤æ˜“è®°å½•
- ç”¨æˆ·æ“ä½œæ—¶åº

âŒ ä¸éœ€è¦é¡ºåºçš„åœºæ™¯ï¼š  
- ç‹¬ç«‹çš„æ—¥å¿—è®°å½•
- ç»Ÿè®¡è®¡æ•°ä¿¡æ¯
- ç›‘æ§æŒ‡æ ‡æ•°æ®
```

**ğŸ”¹ æ€§èƒ½ä¸é¡ºåºçš„æƒè¡¡**
```
ä¸¥æ ¼é¡ºåºï¼šmax.in.flight=1, å•åˆ†åŒº, å•çº¿ç¨‹æ¶ˆè´¹
ç»“æœï¼šé¡ºåº100% âœ…ï¼Œæ€§èƒ½30% âŒ

æ¾æ•£é¡ºåºï¼šä¸šåŠ¡å±‚æ’åº, å¤šåˆ†åŒº, å¹¶å‘æ¶ˆè´¹  
ç»“æœï¼šé¡ºåº90% âš ï¸ï¼Œæ€§èƒ½100% âœ…
```

**ğŸ”¹ å®é™…é—®é¢˜å®šä½æ€è·¯**
```
å‘ç°ä¹±åºé—®é¢˜ï¼š
1ï¸âƒ£ ç¡®è®¤æ˜¯å¦çœŸçš„éœ€è¦é¡ºåº
2ï¸âƒ£ æ£€æŸ¥åˆ†åŒºé”®æ˜¯å¦åˆç†
3ï¸âƒ£ æ£€æŸ¥ç”Ÿäº§è€…é…ç½®
4ï¸âƒ£ æ£€æŸ¥æ¶ˆè´¹è€…å¤„ç†é€»è¾‘
5ï¸âƒ£ è€ƒè™‘ä¸šåŠ¡å±‚è¡¥å¿æ–¹æ¡ˆ
```

### 7.3 ç”Ÿäº§ç¯å¢ƒå®æˆ˜å»ºè®®


**ğŸ¯ é…ç½®æ¨¡æ¿æ¨èï¼š**

```properties
# é«˜é¡ºåºè¦æ±‚åœºæ™¯
max.in.flight.requests.per.connection=1
retries=2147483647
acks=all
enable.idempotence=true

# å¹³è¡¡æ€§èƒ½åœºæ™¯  
max.in.flight.requests.per.connection=3
retries=10
acks=all
enable.idempotence=true
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡å…³æ³¨ï¼š**
- æ¶ˆæ¯ä¹±åºç‡ï¼šè‡ªå®šä¹‰ä¸šåŠ¡ç›‘æ§
- é‡è¯•æ¬¡æ•°ï¼š`producer-metrics`
- åˆ†åŒºåˆ†å¸ƒï¼š`consumer-coordinator-metrics`
- å¤„ç†å»¶è¿Ÿï¼šç«¯åˆ°ç«¯æ—¶é—´ç›‘æ§

### 7.4 å¸¸è§é—®é¢˜å¿«é€Ÿæ’æŸ¥


**ğŸ› é—®é¢˜è¯Šæ–­æ¸…å•ï¼š**

| ç°è±¡ | **å¯èƒ½åŸå› ** | **æ’æŸ¥æ–¹æ³•** |
|------|-------------|-------------|
| å¶å‘ä¹±åº | ç½‘ç»œé‡è¯•å¯¼è‡´ | æ£€æŸ¥`retries`å’Œ`max.in.flight`é…ç½® |
| æŒç»­ä¹±åº | å¤šçº¿ç¨‹æ¶ˆè´¹ | æ£€æŸ¥æ¶ˆè´¹è€…å¤„ç†é€»è¾‘ |
| é‡å¯åä¹±åº | åˆ†åŒºé‡åˆ†é… | æ£€æŸ¥åˆ†åŒºåˆ†é…ç­–ç•¥ |
| æ–°å¢æ¶ˆè´¹è€…åä¹±åº | Consumer Rebalance | ä½¿ç”¨Stickyåˆ†é…ç­–ç•¥ |

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- ğŸ¯ **åˆ†åŒºé”®æ˜¯åŸºç¡€** - å†³å®šæ¶ˆæ¯åˆ†å¸ƒ
- âš™ï¸ **é…ç½®æ˜¯å…³é”®** - å¹³è¡¡æ€§èƒ½ä¸é¡ºåº  
- ğŸ”„ **å¤„ç†æ˜¯æ ¸å¿ƒ** - å•çº¿ç¨‹æœ€å¯é 
- ğŸ’¡ **è®¾è®¡æ˜¯æ ¹æœ¬** - ä¸šåŠ¡å†³å®šæŠ€æœ¯æ–¹æ¡ˆ