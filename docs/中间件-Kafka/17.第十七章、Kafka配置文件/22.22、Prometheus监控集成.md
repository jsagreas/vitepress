---
title: 22ã€Prometheusç›‘æ§é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [JMXä»£ç†é…ç½®è¯¦è§£](#2-jmxä»£ç†é…ç½®è¯¦è§£)
3. [Prometheusé…ç½®æ–‡ä»¶è®¾ç½®](#3-prometheusé…ç½®æ–‡ä»¶è®¾ç½®)
4. [æŒ‡æ ‡é‡‡é›†ä¸è¿‡æ»¤](#4-æŒ‡æ ‡é‡‡é›†ä¸è¿‡æ»¤)
5. [ç›‘æ§å®‰å…¨é…ç½®](#5-ç›‘æ§å®‰å…¨é…ç½®)
6. [å®é™…éƒ¨ç½²å®è·µ](#6-å®é™…éƒ¨ç½²å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Prometheusç›‘æ§


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡Prometheuså°±åƒæ˜¯ä¸€ä¸ª**æ™ºèƒ½çš„æ•°æ®é‡‡é›†å‘˜**ï¼Œå®ƒä¼šå®šæ—¶åˆ°å„ä¸ªKafkaæœåŠ¡å™¨ä¸Šå»"è¯¢é—®"è¿è¡ŒçŠ¶æ€ï¼Œç„¶åæŠŠè¿™äº›ä¿¡æ¯æ•´ç†æˆå›¾è¡¨ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿç›´è§‚çœ‹åˆ°Kafkaé›†ç¾¤çš„å¥åº·çŠ¶å†µã€‚

```
ä¼ ç»Ÿç›‘æ§æ–¹å¼ï¼š                    Prometheusç›‘æ§æ–¹å¼ï¼š
äººå·¥æ£€æŸ¥æœåŠ¡å™¨ â”€â”€Ã—â”€â”€ è´¹æ—¶è´¹åŠ›        è‡ªåŠ¨é‡‡é›†æŒ‡æ ‡ â”€â”€âœ“â”€â”€ å®æ—¶ç›‘æ§
æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹ â”€â”€Ã—â”€â”€ ä¿¡æ¯åˆ†æ•£        ç»Ÿä¸€æ•°æ®å­˜å‚¨ â”€â”€âœ“â”€â”€ é›†ä¸­ç®¡ç†
æ‰‹åŠ¨ç”ŸæˆæŠ¥è¡¨ â”€â”€Ã—â”€â”€ æ•ˆç‡ä½ä¸‹        è‡ªåŠ¨åŒ–å›¾è¡¨ â”€â”€âœ“â”€â”€ å¯è§†åŒ–å±•ç¤º
```

**ğŸ¯ ç›‘æ§çš„æ ¸å¿ƒä»·å€¼**
- **åŠæ—¶å‘ç°é—®é¢˜**ï¼šç³»ç»Ÿå‡ºç°å¼‚å¸¸æ—¶ç«‹å³è·å¾—å‘Šè­¦
- **æ€§èƒ½ä¼˜åŒ–æŒ‡å¯¼**ï¼šé€šè¿‡æ•°æ®åˆ†ææ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’ä¾æ®**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹æœªæ¥éœ€æ±‚
- **æ•…éšœæ’æŸ¥å·¥å…·**ï¼šå¿«é€Ÿå®šä½é—®é¢˜æ ¹æº

### 1.2 JMXä¸Prometheusçš„å…³ç³»


**ğŸ”§ æŠ€æœ¯æ¶æ„è¯´æ˜**

```
KafkaæœåŠ¡å™¨å†…éƒ¨æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Kafkaè¿›ç¨‹                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JMX MBeans (æŒ‡æ ‡æ•°æ®æº)             â”‚ â† å†…éƒ¨äº§ç”Ÿå„ç§è¿è¡ŒæŒ‡æ ‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JMXä»£ç† (jmx_prometheus_javaagent) â”‚ â† å°†JMXæŒ‡æ ‡è½¬æ¢ä¸ºPrometheusæ ¼å¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  HTTPç«¯ç‚¹ (å¦‚:9999ç«¯å£)              â”‚ â† å¯¹å¤–æš´éœ²æŒ‡æ ‡æ¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            PrometheusæœåŠ¡å™¨å®šæœŸæ‹‰å–æ•°æ®
```

**ğŸ“Š ç®€å•ç±»æ¯”**
- **JMX**ï¼šå°±åƒKafkaå†…éƒ¨çš„"ä»ªè¡¨ç›˜"ï¼Œè®°å½•ç€CPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€æ¶ˆæ¯å¤„ç†é€Ÿåº¦ç­‰å„ç§æ•°æ®
- **JMXä»£ç†**ï¼šåƒä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼ŒæŠŠKafkaå†…éƒ¨çš„æ•°æ®ç¿»è¯‘æˆPrometheusèƒ½ç†è§£çš„æ ¼å¼
- **Prometheus**ï¼šåƒä¸€ä¸ª"æ•°æ®æ”¶é›†å‘˜"ï¼Œå®šæœŸæ¥è¯»å–è¿™äº›ç¿»è¯‘å¥½çš„æ•°æ®

---

## 2. âš™ï¸ JMXä»£ç†é…ç½®è¯¦è§£


### 2.1 jmx_prometheus_javaagent.jar åŸºç¡€é…ç½®


**ğŸ”¸ ä»£ç†æ–‡ä»¶è·å–ä¸æ”¾ç½®**

```bash
# 1. ä¸‹è½½JMXä»£ç†æ–‡ä»¶
wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.19.0/jmx_prometheus_javaagent-0.19.0.jar

# 2. åˆ›å»ºä¸“é—¨ç›®å½•
mkdir -p /opt/kafka/monitoring
mv jmx_prometheus_javaagent-0.19.0.jar /opt/kafka/monitoring/

# 3. è®¾ç½®æƒé™
chmod 644 /opt/kafka/monitoring/jmx_prometheus_javaagent-0.19.0.jar
```

**ğŸ”§ åœ¨Kafkaå¯åŠ¨è„šæœ¬ä¸­é›†æˆä»£ç†**

```bash
# åœ¨kafka-server-start.shä¸­æ·»åŠ JVMå‚æ•°
export KAFKA_OPTS="$KAFKA_OPTS -javaagent:/opt/kafka/monitoring/jmx_prometheus_javaagent-0.19.0.jar=9999:/opt/kafka/monitoring/prometheus-config.yml"

# å‚æ•°è¯¦è§£ï¼š
# -javaagent: æŒ‡å®šJavaä»£ç†
# =9999: ç›‘æ§æ•°æ®æš´éœ²çš„HTTPç«¯å£
# =/path/config.yml: æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
```

**âš¡ å¿«é€ŸéªŒè¯é…ç½®**
```bash
# å¯åŠ¨KafkaåéªŒè¯ä»£ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ
curl http://localhost:9999/metrics | head -20

# æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# kafka_server_brokertopicmetrics_messagesinpersec{topic="test"} 0.0
# kafka_server_brokertopicmetrics_bytesinpersec{topic="test"} 0.0
```

### 2.2 ä»£ç†å¯åŠ¨å‚æ•°è¯¦ç»†è¯´æ˜


**ğŸ“‹ å…³é”®å‚æ•°é…ç½®è¡¨**

| å‚æ•°ç±»å‹ | é…ç½®ç¤ºä¾‹ | å«ä¹‰è§£é‡Š | æ³¨æ„äº‹é¡¹ |
|---------|---------|---------|---------|
| **ç«¯å£é…ç½®** | `=9999:config.yml` | æŒ‡å®šHTTPæš´éœ²ç«¯å£ | ç¡®ä¿ç«¯å£æœªè¢«å ç”¨ |
| **é…ç½®æ–‡ä»¶** | `=/path/config.yml` | æŒ‡å®šè§„åˆ™é…ç½®æ–‡ä»¶ | è·¯å¾„å¿…é¡»ç»å¯¹è·¯å¾„ |
| **ç»‘å®šåœ°å€** | `=0.0.0.0:9999:config.yml` | æŒ‡å®šç»‘å®šIPåœ°å€ | ç”Ÿäº§ç¯å¢ƒå»ºè®®é™åˆ¶IP |

**ğŸ”’ å®‰å…¨æ€§è€ƒè™‘**
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼šä»…ç»‘å®šå†…ç½‘IP
export KAFKA_OPTS="$KAFKA_OPTS -javaagent:/opt/kafka/monitoring/jmx_prometheus_javaagent-0.19.0.jar=192.168.1.100:9999:/opt/kafka/monitoring/prometheus-config.yml"

# è€Œä¸æ˜¯æš´éœ²ç»™æ‰€æœ‰ç½‘ç»œæ¥å£ï¼š
# -javaagent:...=0.0.0.0:9999:... (å­˜åœ¨å®‰å…¨é£é™©)
```

---

## 3. ğŸ“„ Prometheusé…ç½®æ–‡ä»¶è®¾ç½®


### 3.1 prometheus-config.yml åŸºç¡€ç»“æ„


**ğŸ”¸ é…ç½®æ–‡ä»¶çš„ä½œç”¨**
è¿™ä¸ªé…ç½®æ–‡ä»¶å°±åƒæ˜¯ç»™"ç¿»è¯‘å®˜"çš„å·¥ä½œæ‰‹å†Œï¼Œå‘Šè¯‰å®ƒï¼š
- å“ªäº›æŒ‡æ ‡éœ€è¦ç¿»è¯‘
- å¦‚ä½•ç»™æŒ‡æ ‡å‘½å
- å“ªäº›æŒ‡æ ‡å¯ä»¥å¿½ç•¥

**ğŸ“ åŸºç¡€é…ç½®æ¨¡æ¿**

```yaml
# /opt/kafka/monitoring/prometheus-config.yml

# å…¨å±€é…ç½®
lowercaseOutputName: true        # æŒ‡æ ‡åç§°è½¬ä¸ºå°å†™
lowercaseOutputLabelNames: true  # æ ‡ç­¾åç§°è½¬ä¸ºå°å†™

# æŒ‡æ ‡é‡‡é›†è§„åˆ™
rules:
  # KafkaæœåŠ¡å™¨åŸºç¡€æŒ‡æ ‡
  - pattern: kafka.server<type=(.+), name=(.+)><>Value
    name: kafka_server_$1_$2
    type: GAUGE
    help: "Kafka server metrics for $1 $2"

  # Topicçº§åˆ«æŒ‡æ ‡  
  - pattern: kafka.server<type=(.+), name=(.+), topic=(.+)><>Count
    name: kafka_server_$1_$2_total
    labels:
      topic: "$3"
    type: COUNTER
    help: "Kafka $1 $2 total count for topic $3"
```

### 3.2 æŒ‡æ ‡è§„åˆ™è¯¦ç»†é…ç½®


**ğŸ¯ Patternæ¨¡å¼åŒ¹é…åŸç†**

```yaml
# åŸå§‹JMXæŒ‡æ ‡åç§°ç¤ºä¾‹ï¼š
# kafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec,topic=my-topic

# å¯¹åº”çš„è§„åˆ™é…ç½®ï¼š
- pattern: kafka.server<type=(.+), name=(.+), topic=(.+)><>Count
  name: kafka_server_$1_$2_total
  labels:
    topic: "$3"
  type: COUNTER

# è½¬æ¢åçš„PrometheusæŒ‡æ ‡ï¼š
# kafka_server_brokertopicmetrics_messagesinpersec_total{topic="my-topic"} 123
```

**ğŸ“Š å¸¸ç”¨æŒ‡æ ‡è§„åˆ™é…ç½®**

```yaml
rules:
  # 1. BrokeråŸºç¡€æ€§èƒ½æŒ‡æ ‡
  - pattern: kafka.server<type=BrokerTopicMetrics, name=(.+), topic=(.+)><>Count
    name: kafka_broker_topic_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # 2. ç½‘ç»œè¯·æ±‚æŒ‡æ ‡  
  - pattern: kafka.network<type=RequestMetrics, name=(.+), request=(.+)><>Count
    name: kafka_network_request_$1_total  
    labels:
      request_type: "$2"
    type: COUNTER

  # 3. JVMå†…å­˜ä½¿ç”¨æŒ‡æ ‡
  - pattern: java.lang<type=Memory><HeapMemoryUsage>used
    name: jvm_heap_memory_used_bytes
    type: GAUGE

  # 4. æ¶ˆè´¹è€…ç»„æŒ‡æ ‡
  - pattern: kafka.consumer<type=(.+), client-id=(.+)><>(.+)
    name: kafka_consumer_$1_$3
    labels:
      client_id: "$2"
    type: GAUGE
```

### 3.3 æŒ‡æ ‡æ ‡ç­¾é…ç½®æœ€ä½³å®è·µ


**ğŸ·ï¸ æ ‡ç­¾è®¾è®¡åŸåˆ™**

```yaml
# å¥½çš„æ ‡ç­¾è®¾è®¡ï¼šè¯­ä¹‰æ¸…æ™°ï¼Œä¾¿äºæŸ¥è¯¢
- pattern: kafka.server<type=BrokerTopicMetrics, name=(.+), topic=(.+)><>Count
  name: kafka_broker_messages_total
  labels:
    metric_type: "$1"      # æ¸…æ™°çš„æ ‡ç­¾å
    topic_name: "$2"       # æè¿°æ€§æ ‡ç­¾å
    broker_id: "{{broker_id}}"  # å¯ä»¥å¼•ç”¨ç³»ç»Ÿå˜é‡

# é¿å…çš„æ ‡ç­¾è®¾è®¡ï¼šè¿‡äºç®€å•æˆ–å®¹æ˜“æ··æ·†  
labels:
  t: "$2"        # âŒ æ ‡ç­¾åè¿‡äºç®€å•
  topic: "$2"    # âœ“ æ¸…æ™°æ˜ç¡®
```

---

## 4. ğŸ¯ æŒ‡æ ‡é‡‡é›†ä¸è¿‡æ»¤


### 4.1 é‡‡é›†è§„åˆ™è®¾ç½®


**â±ï¸ é‡‡é›†é—´éš”æ—¶é—´é…ç½®**

```yaml
# åœ¨Prometheus serveré…ç½®ä¸­è®¾ç½®é‡‡é›†é—´éš”
# prometheus.yml
scrape_configs:
  - job_name: 'kafka-brokers'
    scrape_interval: 15s        # æ¯15ç§’é‡‡é›†ä¸€æ¬¡
    scrape_timeout: 10s         # 10ç§’è¶…æ—¶
    static_configs:
      - targets: 
        - 'kafka1:9999'
        - 'kafka2:9999'  
        - 'kafka3:9999'
```

**ğŸ”§ é‡‡é›†é¢‘ç‡é€‰æ‹©æŒ‡å—**

| åœºæ™¯ç±»å‹ | æ¨èé—´éš” | è¯´æ˜åŸå›  |
|---------|---------|---------|
| **ç”Ÿäº§ç¯å¢ƒ** | 15-30ç§’ | å¹³è¡¡æ€§èƒ½ä¸ç›‘æ§ç²¾åº¦ |
| **å¼€å‘æµ‹è¯•** | 5-15ç§’ | å¿«é€Ÿå‘ç°é—®é¢˜ |
| **é«˜è´Ÿè½½ç³»ç»Ÿ** | 30-60ç§’ | å‡å°‘ç›‘æ§å¼€é”€ |
| **å…³é”®æŒ‡æ ‡** | 5-10ç§’ | é‡è¦æŒ‡æ ‡éœ€è¦é«˜é¢‘ç›‘æ§ |

### 4.2 æŒ‡æ ‡è¿‡æ»¤é…ç½®


**ğŸš« é»‘åå•é…ç½®ï¼šæ’é™¤ä¸éœ€è¦çš„æŒ‡æ ‡**

```yaml
# æ’é™¤JVMå†…éƒ¨è¯¦ç»†æŒ‡æ ‡ï¼ˆå‡å°‘å­˜å‚¨å‹åŠ›ï¼‰
rules:
  - pattern: ".*"
    name: "dropped"
    type: UNTYPED
    help: "Dropped"
    
# æ›´ç²¾ç¡®çš„é»‘åå•é…ç½®
rules:
  # æ’é™¤GCè¯¦ç»†ç»Ÿè®¡
  - pattern: java.lang<type=GarbageCollector, name=(.+)><>CollectionTime
    name: "jvm_gc_collection_time_ignored"
    type: UNTYPED
    
  # åªä¿ç•™é‡è¦çš„KafkaæŒ‡æ ‡
  - pattern: kafka.server<type=BrokerTopicMetrics, name=(MessagesInPerSec|BytesInPerSec|BytesOutPerSec), topic=(.+)><>Count
    name: kafka_broker_$1_total
    labels:
      topic: "$2"
    type: COUNTER
```

**âœ… ç™½åå•é…ç½®ï¼šåªé‡‡é›†æŒ‡å®šæŒ‡æ ‡**

```yaml
# ç²¾ç®€ç›‘æ§ï¼šåªé‡‡é›†æ ¸å¿ƒæŒ‡æ ‡
rules:
  # 1. æ¶ˆæ¯ååé‡
  - pattern: kafka.server<type=BrokerTopicMetrics, name=MessagesInPerSec, topic=(.+)><>Count
    name: kafka_messages_in_total
    labels:
      topic: "$1"
    type: COUNTER

  # 2. ç½‘ç»œååé‡  
  - pattern: kafka.server<type=BrokerTopicMetrics, name=(BytesInPerSec|BytesOutPerSec), topic=(.+)><>Count
    name: kafka_bytes_$1_total
    labels:
      topic: "$2"
    type: COUNTER

  # 3. æ¶ˆè´¹è€…å»¶è¿Ÿ
  - pattern: kafka.consumer<type=consumer-fetch-manager-metrics, client-id=(.+)><>records-lag-max
    name: kafka_consumer_lag_max
    labels:
      client_id: "$1"
    type: GAUGE

  # å¿½ç•¥å…¶ä»–æ‰€æœ‰æŒ‡æ ‡
  - pattern: ".*"
    name: "ignored_metric"
    type: UNTYPED
```

### 4.3 æŒ‡æ ‡å‘½åè§„èŒƒ


**ğŸ“ å‘½åæœ€ä½³å®è·µ**

```yaml
# æ¨èçš„å‘½åè§„èŒƒ
rules:
  # âœ“ å¥½çš„å‘½åï¼šæ¸…æ™°çš„å±‚æ¬¡ç»“æ„
  - pattern: kafka.server<type=BrokerTopicMetrics, name=(.+), topic=(.+)><>Count
    name: kafka_broker_topic_messages_total
    
  # âœ“ åŒ…å«å•ä½ä¿¡æ¯
  - pattern: kafka.server<type=BrokerTopicMetrics, name=BytesInPerSec, topic=(.+)><>Count  
    name: kafka_broker_topic_bytes_in_total
    
  # âŒ é¿å…çš„å‘½åï¼šè¿‡äºç®€å•
  name: kafka_$1_$2  # ä¸æ¸…æ¥šå…·ä½“å«ä¹‰
  
  # âŒ é¿å…çš„å‘½åï¼šè¿‡äºå¤æ‚
  name: kafka_server_broker_topic_metrics_messages_in_per_second_count_total
```

---

## 5. ğŸ”’ ç›‘æ§å®‰å…¨é…ç½®


### 5.1 å®‰å…¨è®¤è¯é…ç½®


**ğŸ” HTTPåŸºç¡€è®¤è¯è®¾ç½®**

```yaml
# åœ¨JMXä»£ç†ä¸­å¯ç”¨åŸºç¡€è®¤è¯
# prometheus-config.yml
ssl: false
authentication:
  enabled: true
  username: "prometheus_user"
  password: "secure_password_123"

# å¯¹åº”çš„Prometheus serveré…ç½®
# prometheus.yml  
scrape_configs:
  - job_name: 'kafka-secure'
    basic_auth:
      username: prometheus_user
      password: secure_password_123
    static_configs:
      - targets: ['kafka1:9999']
```

**ğŸ›¡ï¸ SSL/TLSåŠ å¯†é…ç½®**

```yaml
# å¯ç”¨HTTPSç›‘æ§ç«¯ç‚¹
# prometheus-config.yml
ssl: true
ssl_config:
  keystore_path: "/opt/kafka/ssl/kafka-monitoring.jks"
  keystore_password: "keystore_password"
  truststore_path: "/opt/kafka/ssl/kafka-truststore.jks" 
  truststore_password: "truststore_password"
```

### 5.2 ç½‘ç»œå®‰å…¨é…ç½®


**ğŸŒ IPè®¿é—®æ§åˆ¶**

```bash
# æ–¹æ³•1ï¼šåœ¨JMXä»£ç†å¯åŠ¨æ—¶é™åˆ¶ç»‘å®šIP
export KAFKA_OPTS="$KAFKA_OPTS -javaagent:/path/to/agent.jar=192.168.1.100:9999:/path/config.yml"

# æ–¹æ³•2ï¼šä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®
# åªå…è®¸PrometheusæœåŠ¡å™¨è®¿é—®ç›‘æ§ç«¯å£
sudo iptables -A INPUT -p tcp --dport 9999 -s 192.168.1.50 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 9999 -j DROP
```

**ğŸ” ç›‘æ§ç«¯ç‚¹å®‰å…¨æ£€æŸ¥**

```bash
# æ£€æŸ¥ç«¯å£ç»‘å®šæƒ…å†µ
netstat -tlnp | grep 9999

# éªŒè¯åªæœ‰æˆæƒIPå¯ä»¥è®¿é—®
curl http://192.168.1.100:9999/metrics  # åº”è¯¥å¯ä»¥è®¿é—®
curl http://å¤–ç½‘IP:9999/metrics          # åº”è¯¥è¢«æ‹’ç»
```

---

## 6. ğŸš€ å®é™…éƒ¨ç½²å®è·µ


### 6.1 å®Œæ•´éƒ¨ç½²æµç¨‹


**ğŸ“‹ æ­¥éª¤1ï¼šç¯å¢ƒå‡†å¤‡**

```bash
# 1. åˆ›å»ºç›‘æ§ç›®å½•ç»“æ„
mkdir -p /opt/kafka/monitoring/{agent,config,logs}

# 2. ä¸‹è½½å¹¶æ”¾ç½®ä»£ç†æ–‡ä»¶
cd /opt/kafka/monitoring/agent
wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.19.0/jmx_prometheus_javaagent-0.19.0.jar

# 3. è®¾ç½®æƒé™
chown -R kafka:kafka /opt/kafka/monitoring
chmod 755 /opt/kafka/monitoring/agent/*.jar
```

**ğŸ“ æ­¥éª¤2ï¼šé…ç½®æ–‡ä»¶åˆ›å»º**

```yaml
# /opt/kafka/monitoring/config/prometheus-kafka.yml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

lowercaseOutputName: true
lowercaseOutputLabelNames: true

rules:
  # æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡
  - pattern: kafka.server<type=BrokerTopicMetrics, name=(MessagesInPerSec|BytesInPerSec|BytesOutPerSec), topic=(.+)><>Count
    name: kafka_broker_$1_total
    labels:
      topic: "$2"
      broker_id: "{{broker.id}}"
    type: COUNTER
    help: "Total $1 for topic $2"

  # æ¶ˆè´¹è€…å»¶è¿Ÿç›‘æ§  
  - pattern: kafka.consumer<type=consumer-fetch-manager-metrics, client-id=(.+)><>records-lag-max
    name: kafka_consumer_records_lag_max
    labels:
      client_id: "$1"
    type: GAUGE

  # JVMå…³é”®æŒ‡æ ‡
  - pattern: java.lang<type=Memory><HeapMemoryUsage>used
    name: jvm_heap_memory_used_bytes
    type: GAUGE

  # æ’é™¤è¯¦ç»†GCç»Ÿè®¡ï¼ˆå‡å°‘æŒ‡æ ‡æ•°é‡ï¼‰
  - pattern: java.lang<type=GarbageCollector, name=(.+)><>.*
    name: jvm_gc_ignored
    type: UNTYPED
```

**ğŸ”§ æ­¥éª¤3ï¼šé›†æˆåˆ°Kafkaå¯åŠ¨è„šæœ¬**

```bash
# ä¿®æ”¹ /opt/kafka/bin/kafka-server-start.sh
# åœ¨å¯åŠ¨å‘½ä»¤å‰æ·»åŠ ï¼š

export JMX_OPTS="-javaagent:/opt/kafka/monitoring/agent/jmx_prometheus_javaagent-0.19.0.jar=9999:/opt/kafka/monitoring/config/prometheus-kafka.yml"
export KAFKA_OPTS="$KAFKA_OPTS $JMX_OPTS"

# æˆ–è€…åœ¨systemdæœåŠ¡æ–‡ä»¶ä¸­é…ç½®ï¼š
# /etc/systemd/system/kafka.service
[Service]
Environment="KAFKA_OPTS=-javaagent:/opt/kafka/monitoring/agent/jmx_prometheus_javaagent-0.19.0.jar=9999:/opt/kafka/monitoring/config/prometheus-kafka.yml"
```

### 6.2 é›†ç¾¤å‘ç°é…ç½®


**ğŸ” åŠ¨æ€æœåŠ¡å‘ç°è®¾ç½®**

```yaml
# prometheus.yml - ä½¿ç”¨æ–‡ä»¶å‘ç°
scrape_configs:
  - job_name: 'kafka-cluster'
    file_sd_configs:
      - files:
        - '/etc/prometheus/kafka_targets.yml'
    scrape_interval: 15s
    metrics_path: /metrics

# /etc/prometheus/kafka_targets.yml
- targets:
  - 'kafka-broker-1:9999'
  - 'kafka-broker-2:9999'  
  - 'kafka-broker-3:9999'
  labels:
    cluster: 'production'
    environment: 'prod'
```

**âš¡ å¥åº·æ£€æŸ¥ä¸è‡ªåŠ¨æ¢å¤**

```bash
# åˆ›å»ºç›‘æ§å¥åº·æ£€æŸ¥è„šæœ¬
# /opt/kafka/monitoring/health_check.sh

#!/bin/bash
BROKER_PORT=9999
BROKER_HOST=localhost

# æ£€æŸ¥ç›‘æ§ç«¯ç‚¹æ˜¯å¦å“åº”
if curl -s "http://${BROKER_HOST}:${BROKER_PORT}/metrics" > /dev/null; then
    echo "$(date): Monitoring endpoint is healthy"
    exit 0
else
    echo "$(date): Monitoring endpoint is down, attempting restart..."
    systemctl restart kafka
    exit 1
fi

# æ·»åŠ åˆ°crontabè¿›è¡Œå®šæœŸæ£€æŸ¥
# crontab -e
# */5 * * * * /opt/kafka/monitoring/health_check.sh >> /opt/kafka/monitoring/logs/health.log 2>&1
```

### 6.3 ç›‘æ§éªŒè¯ä¸æµ‹è¯•


**âœ… é…ç½®éªŒè¯æ­¥éª¤**

```bash
# 1. éªŒè¯JMXä»£ç†å¯åŠ¨
ps aux | grep jmx_prometheus_javaagent
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# kafka ... -javaagent:...jmx_prometheus_javaagent-0.19.0.jar=9999:...

# 2. æ£€æŸ¥ç›‘æ§ç«¯å£
netstat -tlnp | grep :9999
# åº”è¯¥çœ‹åˆ°ï¼š
# tcp 0 0 :::9999 :::* LISTEN 12345/java

# 3. æµ‹è¯•æŒ‡æ ‡è¾“å‡º
curl http://localhost:9999/metrics | grep kafka_broker | head -5
# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# kafka_broker_messagesinpersec_total{topic="test-topic"} 1234.0

# 4. éªŒè¯ç‰¹å®šæŒ‡æ ‡
curl -s http://localhost:9999/metrics | grep "kafka_broker_topic_messages_total"
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ JMXä»£ç†ä½œç”¨ï¼šå°†Kafkaå†…éƒ¨JMXæŒ‡æ ‡è½¬æ¢ä¸ºPrometheusæ ¼å¼
ğŸ”¸ é…ç½®æ–‡ä»¶æ ¸å¿ƒï¼šå®šä¹‰æŒ‡æ ‡é‡‡é›†è§„åˆ™å’Œå‘½åè§„èŒƒ
ğŸ”¸ å®‰å…¨é…ç½®ï¼šä¿æŠ¤ç›‘æ§ç«¯ç‚¹ä¸è¢«æœªæˆæƒè®¿é—®
ğŸ”¸ æŒ‡æ ‡è¿‡æ»¤ï¼šæ§åˆ¶é‡‡é›†çš„æŒ‡æ ‡æ•°é‡ï¼Œä¼˜åŒ–æ€§èƒ½
ğŸ”¸ é›†ç¾¤ç›‘æ§ï¼šç»Ÿä¸€ç®¡ç†å¤šä¸ªKafkaèŠ‚ç‚¹çš„ç›‘æ§
```

### 7.2 é…ç½®è¦ç‚¹é€ŸæŸ¥


**âš¡ å¿«é€Ÿé…ç½®æ£€æŸ¥æ¸…å•**

- **âœ… JMXä»£ç†é…ç½®**
  - ä»£ç†jaræ–‡ä»¶è·¯å¾„æ­£ç¡®
  - ç«¯å£æœªè¢«å ç”¨
  - é…ç½®æ–‡ä»¶è·¯å¾„å­˜åœ¨

- **âœ… é…ç½®æ–‡ä»¶è®¾ç½®**  
  - Patternè§„åˆ™è¯­æ³•æ­£ç¡®
  - æŒ‡æ ‡å‘½åç¬¦åˆè§„èŒƒ
  - æ ‡ç­¾è®¾è®¡åˆç†

- **âœ… å®‰å…¨é…ç½®**
  - é™åˆ¶ç½‘ç»œè®¿é—®
  - å¯ç”¨è®¤è¯æœºåˆ¶
  - ä½¿ç”¨HTTPSä¼ è¾“

- **âœ… æ€§èƒ½ä¼˜åŒ–**
  - åˆç†è®¾ç½®é‡‡é›†é—´éš”
  - è¿‡æ»¤ä¸å¿…è¦æŒ‡æ ‡
  - ç›‘æ§èµ„æºæ¶ˆè€—

### 7.3 å¸¸è§é—®é¢˜è§£å†³


**ğŸ”§ é—®é¢˜æ’æŸ¥æŒ‡å—**

```
é—®é¢˜ï¼šæ— æ³•è®¿é—®ç›‘æ§ç«¯ç‚¹
æ’æŸ¥ï¼šæ£€æŸ¥ç«¯å£ç»‘å®š â†’ éªŒè¯é˜²ç«å¢™è®¾ç½® â†’ ç¡®è®¤ä»£ç†å¯åŠ¨

é—®é¢˜ï¼šæŒ‡æ ‡æ•°æ®ä¸ºç©º
æ’æŸ¥ï¼šéªŒè¯é…ç½®æ–‡ä»¶è¯­æ³• â†’ æ£€æŸ¥PatternåŒ¹é… â†’ ç¡®è®¤JMXå¯ç”¨æ€§

é—®é¢˜ï¼šç›‘æ§å½±å“æ€§èƒ½  
æ’æŸ¥ï¼šè°ƒæ•´é‡‡é›†é¢‘ç‡ â†’ å‡å°‘æŒ‡æ ‡æ•°é‡ â†’ ä¼˜åŒ–Patternè§„åˆ™

é—®é¢˜ï¼šå®‰å…¨è®¤è¯å¤±è´¥
æ’æŸ¥ï¼šéªŒè¯ç”¨æˆ·åå¯†ç  â†’ æ£€æŸ¥SSLè¯ä¹¦ â†’ ç¡®è®¤è®¿é—®æƒé™
```

### 7.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå»ºè®®**

```
ç›‘æ§ç­–ç•¥ï¼š
- é‡‡é›†é—´éš”15-30ç§’ï¼Œå¹³è¡¡ç²¾åº¦ä¸æ€§èƒ½
- é‡ç‚¹ç›‘æ§ï¼šæ¶ˆæ¯ååé‡ã€æ¶ˆè´¹å»¶è¿Ÿã€JVMå†…å­˜
- è®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼šå»¶è¿Ÿ>100msã€å†…å­˜ä½¿ç”¨>80%

å®‰å…¨æªæ–½ï¼š
- é™åˆ¶ç›‘æ§ç«¯å£ç½‘ç»œè®¿é—®
- å¯ç”¨HTTPSå’ŒåŸºç¡€è®¤è¯  
- å®šæœŸæ›´æ–°ä»£ç†ç‰ˆæœ¬

è¿ç»´ç®¡ç†ï¼š
- å»ºç«‹ç›‘æ§å¥åº·æ£€æŸ¥æœºåˆ¶
- å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
- ç›‘æ§æŒ‡æ ‡å­˜å‚¨å®¹é‡è§„åˆ’
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- JMXä»£ç†åšç¿»è¯‘ï¼ŒPrometheusæ¥é‡‡é›†
- é…ç½®è§„åˆ™è¦ç²¾å‡†ï¼ŒæŒ‡æ ‡å‘½åè¦è§„èŒƒ  
- å®‰å…¨è®¤è¯ä¸èƒ½å°‘ï¼Œæ€§èƒ½å½±å“è¦è€ƒè™‘
- é›†ç¾¤ç›‘æ§ç»Ÿä¸€ç®¡ï¼Œé—®é¢˜æ’æŸ¥æœ‰ç« æ³•