---
title: 21ã€JMXç›‘æ§é…ç½®
---
## ğŸ“š ç›®å½•

1. [JMXç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-JMXç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [æ ¸å¿ƒé…ç½®å‚æ•°è¯¦è§£](#2-æ ¸å¿ƒé…ç½®å‚æ•°è¯¦è§£)
3. [ç›‘æ§é…ç½®å®æˆ˜æ“ä½œ](#3-ç›‘æ§é…ç½®å®æˆ˜æ“ä½œ)
4. [æŒ‡æ ‡æ”¶é›†ä¸å‘Šè­¦è®¾ç½®](#4-æŒ‡æ ‡æ”¶é›†ä¸å‘Šè­¦è®¾ç½®)
5. [å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–](#5-å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–)
6. [ç›‘æ§å®è·µä¸æ•…éšœæ’æŸ¥](#6-ç›‘æ§å®è·µä¸æ•…éšœæ’æŸ¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” JMXç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JMXç›‘æ§


**ğŸ”¸ JMXåŸºæœ¬æ¦‚å¿µ**
```
JMXï¼ˆJava Management Extensionsï¼‰ï¼šJavaç®¡ç†æ‰©å±•
ä½œç”¨ï¼šç›‘æ§å’Œç®¡ç†Javaåº”ç”¨ç¨‹åºçš„æ ‡å‡†API
åœ¨Kafkaä¸­ï¼šç”¨æ¥æ”¶é›†å„ç§è¿è¡Œæ—¶æŒ‡æ ‡å’ŒçŠ¶æ€ä¿¡æ¯

ç®€å•ç†è§£ï¼š
JMXå°±åƒç»™Kafkaè£…äº†ä¸€ä¸ª"å¥åº·ç›‘æµ‹ä»ª"
å¯ä»¥å®æ—¶æŸ¥çœ‹Kafkaçš„è¿è¡ŒçŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡
å°±åƒåŒ»ç”Ÿç”¨ä»ªå™¨ç›‘æµ‹ç—…äººçš„å¿ƒè·³ã€è¡€å‹ä¸€æ ·
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§Kafka**
```
ç”Ÿäº§ç¯å¢ƒé—®é¢˜ï¼š
âŒ æ¶ˆæ¯å †ç§¯äº†ï¼Œä½†ä¸çŸ¥é“åœ¨å“ªä¸ªåˆ†åŒº
âŒ æ€§èƒ½ä¸‹é™äº†ï¼Œä½†ä¸çŸ¥é“ç“¶é¢ˆåœ¨å“ª
âŒ ç£ç›˜å¿«æ»¡äº†ï¼Œä½†æ²¡æœ‰æå‰é¢„è­¦
âŒ æ¶ˆè´¹è€…æ‰çº¿äº†ï¼Œä½†æ²¡æœ‰åŠæ—¶å‘ç°

æœ‰äº†JMXç›‘æ§ï¼š
âœ… å®æ—¶çœ‹åˆ°æ¶ˆæ¯ç”Ÿäº§/æ¶ˆè´¹é€Ÿç‡
âœ… ç›‘æ§ç£ç›˜ä½¿ç”¨ç‡ï¼Œæå‰é¢„è­¦
âœ… è¿½è¸ªç½‘ç»œå»¶è¿Ÿå’Œé”™è¯¯ç‡
âœ… è‡ªåŠ¨å‘Šè­¦ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
```

### 1.2 Kafkaç›‘æ§æ¶æ„


**ğŸ—ï¸ ç›‘æ§æ¶æ„å›¾ç¤º**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kafkaé›†ç¾¤     â”‚    â”‚   JMXæš´éœ²       â”‚    â”‚   ç›‘æ§å·¥å…·      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚  Broker1 â”€â”€â”€â”€â”€â”€â–¶â”‚â”€â”€â”€â”€â”‚  JMXç«¯å£        â”‚â”€â”€â”€â”€â”‚  Prometheus     â”‚
â”‚  Broker2 â”€â”€â”€â”€â”€â”€â–¶â”‚    â”‚  MBeanå¯¹è±¡      â”‚    â”‚  Grafana        â”‚
â”‚  Broker3 â”€â”€â”€â”€â”€â”€â–¶â”‚    â”‚  æŒ‡æ ‡æ•°æ®       â”‚    â”‚  JConsole       â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚  è‡ªå®šä¹‰ç›‘æ§     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®æµå‘ï¼šKafkaå†…éƒ¨æŒ‡æ ‡ â†’ JMXæš´éœ² â†’ ç›‘æ§å·¥å…·é‡‡é›† â†’ å¯è§†åŒ–å±•ç¤º
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶è¯´æ˜**
```
MBeanï¼ˆManaged Beanï¼‰ï¼š
â€¢ ç®¡ç†å¯¹è±¡ï¼ŒåŒ…å«å…·ä½“çš„ç›‘æ§æŒ‡æ ‡
â€¢ æ¯ä¸ªMBeanæœ‰å”¯ä¸€çš„åç§°å’Œå±æ€§
â€¢ ä¾‹ï¼škafka.server:type=BrokerTopicMetrics

JMXè¿æ¥å™¨ï¼š
â€¢ å…è®¸è¿œç¨‹è®¿é—®MBean
â€¢ æ”¯æŒRMIã€HTTPç­‰åè®®
â€¢ æä¾›å®‰å…¨è®¤è¯æœºåˆ¶

ç›‘æ§å®¢æˆ·ç«¯ï¼š
â€¢ JConsoleï¼šJavaè‡ªå¸¦çš„ç›‘æ§å·¥å…·
â€¢ Prometheusï¼šå¼€æºç›‘æ§ç³»ç»Ÿ
â€¢ Grafanaï¼šæ•°æ®å¯è§†åŒ–å·¥å…·
```

---

## 2. âš™ï¸ æ ¸å¿ƒé…ç½®å‚æ•°è¯¦è§£


### 2.1 JMXç«¯å£é…ç½®


**ğŸ”¸ com.sun.management.jmxremote.port**

> ğŸ’¡ **æ ¸å¿ƒä½œç”¨**ï¼šè®¾ç½®JMXç›‘æ§æœåŠ¡çš„ç½‘ç»œç«¯å£

```bash
# åŸºç¡€é…ç½®
export JMX_PORT=9999
export KAFKA_JMX_OPTS="-Dcom.sun.management.jmxremote.port=9999"

# å¯åŠ¨æ—¶åº”ç”¨é…ç½®
bin/kafka-server-start.sh config/server.properties
```

**ğŸ“Š ç«¯å£é€‰æ‹©å»ºè®®**
| ç¯å¢ƒç±»å‹ | **æ¨èç«¯å£èŒƒå›´** | **è¯´æ˜** |
|---------|----------------|----------|
| ğŸ”§ **å¼€å‘ç¯å¢ƒ** | `9999-10009` | `æ–¹ä¾¿è®°å¿†ï¼Œå†²çªå°‘` |
| ğŸ¢ **æµ‹è¯•ç¯å¢ƒ** | `19999-20009` | `ä¸å¼€å‘ç¯å¢ƒåŒºåˆ†` |
| ğŸš€ **ç”Ÿäº§ç¯å¢ƒ** | `29999-30009` | `é«˜ç«¯å£ï¼Œå®‰å…¨æ€§å¥½` |

**âš ï¸ ç«¯å£é…ç½®æ³¨æ„äº‹é¡¹**
```
ç«¯å£å†²çªæ£€æŸ¥ï¼š
netstat -tulpn | grep 9999

é˜²ç«å¢™é…ç½®ï¼š
# CentOS/RHEL
firewall-cmd --permanent --add-port=9999/tcp
firewall-cmd --reload

# Ubuntu
ufw allow 9999/tcp

ç½‘ç»œå®‰å…¨ï¼š
â€¢ ç”Ÿäº§ç¯å¢ƒå»ºè®®åªå¯¹å†…ç½‘å¼€æ”¾
â€¢ ä½¿ç”¨VPNæˆ–è·³æ¿æœºè®¿é—®
â€¢ å®šæœŸæ£€æŸ¥ç«¯å£è®¿é—®æ—¥å¿—
```

### 2.2 è®¤è¯ä¸å®‰å…¨é…ç½®


**ğŸ”¸ com.sun.management.jmxremote.authenticate**

> ğŸ›¡ï¸ **å®‰å…¨åŸåˆ™**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»å¼€å¯è®¤è¯ï¼

```bash
# å¼€å¯è®¤è¯ï¼ˆæ¨èï¼‰
-Dcom.sun.management.jmxremote.authenticate=true
-Dcom.sun.management.jmxremote.password.file=/path/to/jmxremote.password
-Dcom.sun.management.jmxremote.access.file=/path/to/jmxremote.access

# å…³é—­è®¤è¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
-Dcom.sun.management.jmxremote.authenticate=false
```

**ğŸ“ è®¤è¯æ–‡ä»¶é…ç½®**

***jmxremote.passwordæ–‡ä»¶***
```
# ç”¨æˆ·å å¯†ç 
monitorRole  QmJhc2U2NA==
controlRole  YWRtaW4xMjM=
```

***jmxremote.accessæ–‡ä»¶***
```
# ç”¨æˆ·å æƒé™çº§åˆ«
monitorRole  readonly
controlRole  readwrite
```

**ğŸ”’ æ–‡ä»¶æƒé™è®¾ç½®**
```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™ï¼ˆé‡è¦ï¼ï¼‰
chmod 600 /path/to/jmxremote.password
chmod 644 /path/to/jmxremote.access
chown kafka:kafka /path/to/jmxremote.*
```

### 2.3 SSLå®‰å…¨é…ç½®


**ğŸ”¸ com.sun.management.jmxremote.ssl**

```bash
# å¯ç”¨SSLï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
-Dcom.sun.management.jmxremote.ssl=true
-Dcom.sun.management.jmxremote.ssl.need.client.auth=true
-Djavax.net.ssl.keyStore=/path/to/keystore.jks
-Djavax.net.ssl.keyStorePassword=keystorepass
-Djavax.net.ssl.trustStore=/path/to/truststore.jks
-Djavax.net.ssl.trustStorePassword=truststorepass

# ç¦ç”¨SSLï¼ˆå¼€å‘ç¯å¢ƒï¼‰
-Dcom.sun.management.jmxremote.ssl=false
```

**ğŸ” SSLè¯ä¹¦ç”Ÿæˆ**
```bash
# ç”Ÿæˆå¯†é’¥åº“
keytool -genkey -alias kafka-jmx -keyalg RSA -keysize 2048 \
        -keystore keystore.jks -storepass keystorepass

# å¯¼å‡ºè¯ä¹¦
keytool -export -alias kafka-jmx -file kafka-jmx.crt \
        -keystore keystore.jks -storepass keystorepass

# åˆ›å»ºä¿¡ä»»åº“
keytool -import -alias kafka-jmx -file kafka-jmx.crt \
        -keystore truststore.jks -storepass truststorepass
```

### 2.4 å®Œæ•´JMXé…ç½®ç¤ºä¾‹


**ğŸ”§ kafka.jmx.optså®Œæ•´é…ç½®**
```bash
# ç”Ÿäº§ç¯å¢ƒå®Œæ•´é…ç½®
export KAFKA_JMX_OPTS="
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=true
-Dcom.sun.management.jmxremote.ssl=true
-Dcom.sun.management.jmxremote.password.file=/opt/kafka/config/jmxremote.password
-Dcom.sun.management.jmxremote.access.file=/opt/kafka/config/jmxremote.access
-Djavax.net.ssl.keyStore=/opt/kafka/ssl/keystore.jks
-Djavax.net.ssl.keyStorePassword=keystorepass
-Djava.rmi.server.hostname=192.168.1.100"

# å¼€å‘ç¯å¢ƒç®€åŒ–é…ç½®
export KAFKA_JMX_OPTS="
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.local.only=false
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false"
```

---

## 3. ğŸ“Š ç›‘æ§é…ç½®å®æˆ˜æ“ä½œ


### 3.1 MBeanå¯¹è±¡ç›‘æ§é…ç½®


**ğŸ”¸ æ ¸å¿ƒMBeanåˆ†ç±»**

```
æœåŠ¡å™¨çº§åˆ«æŒ‡æ ‡ï¼š
â”œâ”€â”€ kafka.server:type=BrokerTopicMetrics
â”‚   â”œâ”€â”€ MessagesInPerSec         (æ¶ˆæ¯æ¥æ”¶é€Ÿç‡)
â”‚   â”œâ”€â”€ BytesInPerSec           (å­—èŠ‚æ¥æ”¶é€Ÿç‡)
â”‚   â””â”€â”€ BytesOutPerSec          (å­—èŠ‚å‘é€é€Ÿç‡)
â”œâ”€â”€ kafka.server:type=ReplicaManager
â”‚   â”œâ”€â”€ LeaderCount             (Leaderå‰¯æœ¬æ•°é‡)
â”‚   â”œâ”€â”€ PartitionCount          (åˆ†åŒºæ€»æ•°)
â”‚   â””â”€â”€ UnderReplicatedPartitions (å‰¯æœ¬ä¸è¶³åˆ†åŒº)
â””â”€â”€ kafka.server:type=KafkaRequestHandlerPool
    â”œâ”€â”€ RequestHandlerAvgIdlePercent (è¯·æ±‚å¤„ç†å™¨ç©ºé—²ç‡)
    â””â”€â”€ RequestQueueSize        (è¯·æ±‚é˜Ÿåˆ—å¤§å°)
```

**ğŸ’¡ é€šä¿—è§£é‡Šå…³é”®æŒ‡æ ‡**
```
MessagesInPerSecï¼š
â€¢ å«ä¹‰ï¼šæ¯ç§’æ¥æ”¶å¤šå°‘æ¡æ¶ˆæ¯
â€¢ ç±»æ¯”ï¼šå¿«é€’ç«™æ¯åˆ†é’Ÿæ”¶åˆ°å¤šå°‘ä¸ªåŒ…è£¹
â€¢ ç”¨é€”ï¼šåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦ç¹å¿™

BytesInPerSecï¼š
â€¢ å«ä¹‰ï¼šæ¯ç§’æ¥æ”¶å¤šå°‘å­—èŠ‚æ•°æ®
â€¢ ç±»æ¯”ï¼šæ°´ç®¡æ¯ç§’æµè¿‡å¤šå°‘å‡æ°´
â€¢ ç”¨é€”ï¼šç›‘æ§ç½‘ç»œå¸¦å®½ä½¿ç”¨æƒ…å†µ

UnderReplicatedPartitionsï¼š
â€¢ å«ä¹‰ï¼šå‰¯æœ¬æ•°é‡ä¸è¶³çš„åˆ†åŒº
â€¢ ç±»æ¯”ï¼šæ²¡æœ‰å¤‡ä»½çš„é‡è¦æ–‡ä»¶
â€¢ ç”¨é€”ï¼šå‘ç°å¯é æ€§é£é™©
```

### 3.2 æŒ‡æ ‡æ”¶é›†é—´éš”è®¾ç½®


**â° é‡‡é›†é¢‘ç‡é…ç½®**
```bash
# Prometheusé‡‡é›†é…ç½®ç¤ºä¾‹
global:
  scrape_interval: 15s      # å…¨å±€é‡‡é›†é—´éš”
  evaluation_interval: 15s  # è§„åˆ™è¯„ä¼°é—´éš”

scrape_configs:
  - job_name: 'kafka'
    static_configs:
      - targets: ['localhost:9999']
    scrape_interval: 10s     # Kafkaä¸“ç”¨é‡‡é›†é—´éš”
    metrics_path: /metrics
```

**ğŸ“ˆ é‡‡é›†é¢‘ç‡å»ºè®®**
| æŒ‡æ ‡ç±»å‹ | **é‡‡é›†é—´éš”** | **å­˜å‚¨æ—¶é•¿** | **åŸå› ** |
|---------|-------------|-------------|----------|
| ğŸ”¥ **æ ¸å¿ƒæŒ‡æ ‡** | `10-15ç§’` | `30å¤©` | `åŠæ—¶å‘ç°é—®é¢˜` |
| ğŸ“Š **ä¸šåŠ¡æŒ‡æ ‡** | `30-60ç§’` | `90å¤©` | `è¶‹åŠ¿åˆ†æ` |
| ğŸ’¾ **èµ„æºæŒ‡æ ‡** | `60ç§’` | `180å¤©` | `å®¹é‡è§„åˆ’` |
| ğŸ” **è¯¦ç»†æŒ‡æ ‡** | `5åˆ†é’Ÿ` | `7å¤©` | `æ•…éšœæ’æŸ¥` |

### 3.3 ç›‘æ§æ•°æ®å­˜å‚¨é…ç½®


**ğŸ—„ï¸ æ•°æ®å­˜å‚¨ç­–ç•¥**
```yaml
# Prometheuså­˜å‚¨é…ç½®
storage:
  tsdb:
    retention.time: 30d        # æ•°æ®ä¿ç•™30å¤©
    retention.size: 100GB      # æœ€å¤§å­˜å‚¨100GB
    max-block-duration: 2h     # å—æ–‡ä»¶æœ€å¤§æ—¶é•¿
    min-block-duration: 2h     # å—æ–‡ä»¶æœ€å°æ—¶é•¿
    
# æ•°æ®å‹ç¼©é…ç½®
compression:
  level: snappy             # å‹ç¼©ç®—æ³•
  chunk_encoding: XOR       # å—ç¼–ç æ–¹å¼
```

**ğŸ’¾ å­˜å‚¨ç©ºé—´è§„åˆ’**
```
è®¡ç®—å…¬å¼ï¼š
å­˜å‚¨ç©ºé—´ = æŒ‡æ ‡æ•°é‡ Ã— é‡‡é›†é¢‘ç‡ Ã— æ•°æ®ç‚¹å¤§å° Ã— ä¿ç•™æ—¶é—´

ç¤ºä¾‹è®¡ç®—ï¼š
â€¢ æŒ‡æ ‡æ•°é‡ï¼š1000ä¸ª
â€¢ é‡‡é›†é¢‘ç‡ï¼š15ç§’ä¸€æ¬¡
â€¢ æ•°æ®ç‚¹å¤§å°ï¼š8å­—èŠ‚
â€¢ ä¿ç•™æ—¶é—´ï¼š30å¤©

å­˜å‚¨éœ€æ±‚ = 1000 Ã— (86400/15) Ã— 8 Ã— 30 â‰ˆ 138GB
```

---

## 4. ğŸš¨ æŒ‡æ ‡æ”¶é›†ä¸å‘Šè­¦è®¾ç½®


### 4.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


**ğŸ“Š å¿…ç›‘æ§æŒ‡æ ‡æ¸…å•**

***ğŸ”¥ é«˜ä¼˜å…ˆçº§æŒ‡æ ‡***
```
æ¶ˆæ¯å¤„ç†ï¼š
â€¢ kafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec
â€¢ kafka.server:type=BrokerTopicMetrics,name=BytesInPerSec
â€¢ kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec

å‰¯æœ¬å¥åº·ï¼š
â€¢ kafka.server:type=ReplicaManager,name=UnderReplicatedPartitions
â€¢ kafka.server:type=ReplicaManager,name=LeaderCount
â€¢ kafka.server:type=ReplicaManager,name=PartitionCount

è¯·æ±‚å¤„ç†ï¼š
â€¢ kafka.network:type=RequestMetrics,name=RequestsPerSec,request=Produce
â€¢ kafka.network:type=RequestMetrics,name=RequestsPerSec,request=FetchConsumer
â€¢ kafka.network:type=RequestMetrics,name=TotalTimeMs,request=Produce
```

***â­ ä¸­ä¼˜å…ˆçº§æŒ‡æ ‡***
```
ç£ç›˜ä½¿ç”¨ï¼š
â€¢ kafka.log:type=LogSize,name=Size
â€¢ kafka.server:type=LogDirFailureChannel,name=LogDirFailureCount

ç½‘ç»œè¿æ¥ï¼š
â€¢ kafka.server:type=socket-server-metrics,listener=PLAINTEXT,networkProcessor=*
â€¢ kafka.network:type=SocketServer,name=NetworkProcessorAvgIdlePercent

JVMæ€§èƒ½ï¼š
â€¢ java.lang:type=Memory,name=HeapMemoryUsage
â€¢ java.lang:type=GarbageCollector,name=CollectionCount
```

### 4.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®**
```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
  - name: kafka.rules
    rules:
      # æ¶ˆæ¯å †ç§¯å‘Šè­¦
      - alert: KafkaConsumerLag
        expr: kafka_consumer_lag_sum > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafkaæ¶ˆè´¹è€…å»¶è¿Ÿè¿‡é«˜"
          description: "æ¶ˆè´¹è€…ç»„ {{ $labels.consumergroup }} å»¶è¿Ÿ {{ $value }} æ¡æ¶ˆæ¯"

      # å‰¯æœ¬ä¸è¶³å‘Šè­¦
      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_server_replicamanager_underreplicatedpartitions > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kafkaå­˜åœ¨å‰¯æœ¬ä¸è¶³çš„åˆ†åŒº"
          description: "{{ $labels.instance }} æœ‰ {{ $value }} ä¸ªåˆ†åŒºå‰¯æœ¬ä¸è¶³"

      # ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: KafkaDiskUsageHigh
        expr: (kafka_log_size_total / 1024 / 1024 / 1024) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafkaç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "{{ $labels.instance }} ç£ç›˜ä½¿ç”¨è¶…è¿‡80GB"
```

**ğŸ“‹ å‘Šè­¦çº§åˆ«å®šä¹‰**
| çº§åˆ« | **é˜ˆå€¼ç¤ºä¾‹** | **å“åº”æ—¶é—´** | **å¤„ç†æ–¹å¼** |
|------|-------------|-------------|-------------|
| ğŸ”´ **Critical** | `å‰¯æœ¬ä¸è¶³>0` | `ç«‹å³` | `ç”µè¯+çŸ­ä¿¡+é‚®ä»¶` |
| ğŸŸ¡ **Warning** | `æ¶ˆè´¹å»¶è¿Ÿ>1ä¸‡` | `5åˆ†é’Ÿå†…` | `çŸ­ä¿¡+é‚®ä»¶` |
| ğŸ”µ **Info** | `è¿æ¥æ•°>100` | `30åˆ†é’Ÿå†…` | `é‚®ä»¶` |

### 4.3 è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®


**ğŸ”§ è‡ªå®šä¹‰MBeanç¤ºä¾‹**
```java
// è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
public class CustomKafkaMetrics implements CustomKafkaMetricsMBean {
    private final AtomicLong businessMessageCount = new AtomicLong(0);
    private final AtomicLong errorCount = new AtomicLong(0);
    
    public CustomKafkaMetrics() {
        // æ³¨å†ŒMBean
        try {
            ManagementFactory.getPlatformMBeanServer()
                .registerMBean(this, new ObjectName("custom.kafka:type=BusinessMetrics"));
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        }
    }
    
    @Override
    public long getBusinessMessageCount() {
        return businessMessageCount.get();
    }
    
    @Override
    public long getErrorCount() {
        return errorCount.get();
    }
    
    // ä¸šåŠ¡æ–¹æ³•ä¸­è°ƒç”¨
    public void incrementBusinessMessage() {
        businessMessageCount.incrementAndGet();
    }
}
```

---

## 5. ğŸ›¡ï¸ å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–


### 5.1 ç›‘æ§å®¢æˆ·ç«¯è¿æ¥é…ç½®


**ğŸ”Œ è¿æ¥æ± é…ç½®**
```java
// JMXè¿æ¥æ± é…ç½®
public class JMXConnectionPool {
    private final GenericObjectPool<JMXConnector> pool;
    
    public JMXConnectionPool(String serviceUrl, int maxConnections) {
        GenericObjectPoolConfig config = new GenericObjectPoolConfig();
        config.setMaxTotal(maxConnections);           // æœ€å¤§è¿æ¥æ•°
        config.setMaxIdle(5);                        // æœ€å¤§ç©ºé—²è¿æ¥
        config.setMinIdle(2);                        // æœ€å°ç©ºé—²è¿æ¥
        config.setTestOnBorrow(true);                // å€Ÿç”¨æ—¶éªŒè¯
        config.setTestWhileIdle(true);               // ç©ºé—²æ—¶éªŒè¯
        
        this.pool = new GenericObjectPool<>(
            new JMXConnectorFactory(serviceUrl), config);
    }
}
```

**âš¡ è¿æ¥ä¼˜åŒ–å»ºè®®**
```
è¿æ¥å¤ç”¨ï¼š
â€¢ ä½¿ç”¨è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥
â€¢ è®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´
â€¢ ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ

æ€§èƒ½è°ƒä¼˜ï¼š
â€¢ é™åˆ¶å¹¶å‘è¿æ¥æ•°é‡
â€¢ ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å‡å°‘ç½‘ç»œå¼€é”€
â€¢ ç¼“å­˜ä¸ç»å¸¸å˜åŒ–çš„æŒ‡æ ‡
```

### 5.2 å®‰å…¨è®¿é—®æ§åˆ¶


**ğŸ”’ ç½‘ç»œå®‰å…¨é…ç½®**
```bash
# iptablesé˜²ç«å¢™è§„åˆ™
iptables -A INPUT -p tcp --dport 9999 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 9999 -j DROP

# ä½¿ç”¨SSHéš§é“ï¼ˆæ¨èï¼‰
ssh -L 9999:kafka-server:9999 user@jump-server
# ç„¶åæœ¬åœ°è¿æ¥localhost:9999
```

**ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†**
```bash
# åˆ›å»ºç›‘æ§ä¸“ç”¨ç”¨æˆ·
useradd -r -s /bin/false kafka-monitor
chown kafka-monitor:kafka-monitor /opt/kafka/config/jmx*

# RBACæƒé™é…ç½®
# jmxremote.access
readonly_user  readonly
monitor_user   readonly
admin_user     readwrite

# æƒé™è¯´æ˜ï¼š
# readonlyï¼šåªèƒ½æŸ¥çœ‹æŒ‡æ ‡ï¼Œä¸èƒ½ä¿®æ”¹
# readwriteï¼šå¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹é…ç½®
```

### 5.3 ç›‘æ§æ€§èƒ½å½±å“æ§åˆ¶


**ğŸ“Š æ€§èƒ½å½±å“è¯„ä¼°**
```
JMXç›‘æ§å¼€é”€ï¼š
â€¢ CPUå ç”¨ï¼šé€šå¸¸<1%
â€¢ å†…å­˜å ç”¨ï¼š10-50MB
â€¢ ç½‘ç»œå¸¦å®½ï¼š1-10Mbpsï¼ˆå–å†³äºé‡‡é›†é¢‘ç‡ï¼‰
â€¢ ç£ç›˜IOï¼šåŸºæœ¬æ— å½±å“

ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ åˆç†è®¾ç½®é‡‡é›†é¢‘ç‡
â€¢ åªç›‘æ§å¿…è¦çš„æŒ‡æ ‡
â€¢ ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
â€¢ é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸè¿›è¡Œå¤§é‡ç›‘æ§æŸ¥è¯¢
```

**âš™ï¸ æ€§èƒ½è°ƒä¼˜é…ç½®**
```bash
# JVMå‚æ•°ä¼˜åŒ–
export KAFKA_JMX_OPTS="$KAFKA_JMX_OPTS 
-XX:+UseG1GC 
-XX:MaxGCPauseMillis=20 
-XX:InitiatingHeapOccupancyPercent=35
-Djava.rmi.server.useLocalHostname=true
-Djava.net.preferIPv4Stack=true"

# ç›‘æ§ç¼“å­˜é…ç½®
-Dcom.sun.management.jmxremote.cache.timeout=60000  # ç¼“å­˜60ç§’
-Dcom.sun.management.jmxremote.cache.size=1000      # ç¼“å­˜1000ä¸ªå¯¹è±¡
```

---

## 6. ğŸ› ï¸ ç›‘æ§å®è·µä¸æ•…éšœæ’æŸ¥


### 6.1 ç›‘æ§å·¥å…·å¯¹æ¥


**ğŸ”§ JConsoleè¿æ¥ç¤ºä¾‹**
```bash
# å¯åŠ¨JConsole
jconsole service:jmx:rmi:///jndi/rmi://kafka-server:9999/jmxrmi

# å‘½ä»¤è¡ŒæŸ¥è¯¢
java -jar cmdline-jmxclient-X.X.X.jar - kafka-server:9999 \
  kafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec \
  Count
```

**ğŸ“ˆ Prometheusé›†æˆ**
```yaml
# prometheus.ymlé…ç½®
scrape_configs:
  - job_name: 'kafka-jmx'
    static_configs:
      - targets: 
        - 'kafka1:9999'
        - 'kafka2:9999'  
        - 'kafka3:9999'
    metrics_path: /
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):(.*)'
        replacement: '${1}'
```

### 6.2 å¸¸è§é—®é¢˜æ’æŸ¥


**âŒ è¿æ¥å¤±è´¥é—®é¢˜**
```
é—®é¢˜ï¼šConnection refused
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥JMXç«¯å£æ˜¯å¦å¯åŠ¨
   netstat -tulpn | grep 9999

2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   iptables -L | grep 9999
   firewall-cmd --list-ports

3. æ£€æŸ¥hostnameè§£æ
   echo $JAVA_HOME/bin/jconsole $HOSTNAME:9999

4. æ£€æŸ¥è®¤è¯é…ç½®
   ls -la /path/to/jmxremote.password
```

**âš ï¸ è®¤è¯å¤±è´¥é—®é¢˜**
```
é—®é¢˜ï¼šAuthentication failed
è§£å†³æ–¹æ³•ï¼š
1. æ£€æŸ¥å¯†ç æ–‡ä»¶æƒé™
   chmod 600 jmxremote.password

2. éªŒè¯ç”¨æˆ·åå¯†ç 
   cat jmxremote.password
   cat jmxremote.access

3. æ£€æŸ¥æ–‡ä»¶è·¯å¾„
   ç¡®ä¿é…ç½®ä¸­çš„è·¯å¾„æ­£ç¡®ä¸”æ–‡ä»¶å­˜åœ¨
```

**ğŸ› æ€§èƒ½é—®é¢˜æ’æŸ¥**
```
é—®é¢˜ï¼šç›‘æ§æŸ¥è¯¢å¾ˆæ…¢
ä¼˜åŒ–æ–¹æ¡ˆï¼š
1. å‡å°‘ç›‘æ§æŒ‡æ ‡æ•°é‡
2. å¢åŠ é‡‡é›†é—´éš”
3. ä½¿ç”¨è¿æ¥æ± 
4. å¯ç”¨JMXç¼“å­˜
5. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
```

### 6.3 ç›‘æ§æœ€ä½³å®è·µ


**âœ… ç”Ÿäº§ç¯å¢ƒå®è·µ**
```
éƒ¨ç½²å»ºè®®ï¼š
â€¢ ç›‘æ§æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œé¿å…å½±å“Kafka
â€¢ ä½¿ç”¨é«˜å¯ç”¨çš„ç›‘æ§æ¶æ„
â€¢ å®šæœŸå¤‡ä»½ç›‘æ§é…ç½®å’Œå†å²æ•°æ®
â€¢ å»ºç«‹ç›‘æ§çš„ç›‘æ§ï¼ˆç›‘æ§ç³»ç»Ÿè‡ªèº«å¥åº·åº¦ï¼‰

å‘Šè­¦ç­–ç•¥ï¼š
â€¢ åˆ†çº§å‘Šè­¦ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
â€¢ è®¾ç½®åˆç†çš„å‘Šè­¦æ¢å¤æ¡ä»¶
â€¢ å»ºç«‹å‘Šè­¦å¤„ç†æ ‡å‡†æµç¨‹
â€¢ å®šæœŸreviewå’Œä¼˜åŒ–å‘Šè­¦è§„åˆ™
```

**ğŸ“‹ ç›‘æ§æ¸…å•æ¨¡æ¿**
```
æ—¥å¸¸æ£€æŸ¥é¡¹ï¼š
â–¡ JMXç«¯å£æ­£å¸¸å“åº”
â–¡ è®¤è¯é…ç½®æœ‰æ•ˆ
â–¡ SSLè¯ä¹¦æœªè¿‡æœŸ
â–¡ ç›‘æ§æ•°æ®é‡‡é›†æ­£å¸¸
â–¡ å‘Šè­¦è§„åˆ™è¿è¡Œæ­£å¸¸
â–¡ å­˜å‚¨ç©ºé—´å……è¶³
â–¡ ç½‘ç»œè¿æ¥ç¨³å®š

å‘¨æœŸç»´æŠ¤ï¼š
â–¡ æ¸…ç†è¿‡æœŸæ•°æ®
â–¡ æ›´æ–°ç›‘æ§é…ç½®
â–¡ ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
â–¡ å¤‡ä»½é…ç½®æ–‡ä»¶
â–¡ æ£€æŸ¥å®‰å…¨è®¾ç½®
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ JMXç›‘æ§ï¼šJavaåº”ç”¨ç¨‹åºçš„æ ‡å‡†ç›‘æ§API
ğŸ”¸ MBeanå¯¹è±¡ï¼šåŒ…å«å…·ä½“ç›‘æ§æŒ‡æ ‡çš„ç®¡ç†å¯¹è±¡
ğŸ”¸ ç«¯å£é…ç½®ï¼šJMXæœåŠ¡çš„ç½‘ç»œè®¿é—®ç«¯å£
ğŸ”¸ è®¤è¯å®‰å…¨ï¼šä¿æŠ¤ç›‘æ§æ•°æ®çš„è®¿é—®æ§åˆ¶
ğŸ”¸ æŒ‡æ ‡é‡‡é›†ï¼šå®šæœŸæ”¶é›†Kafkaè¿è¡ŒçŠ¶æ€æ•°æ®
ğŸ”¸ å‘Šè­¦æœºåˆ¶ï¼šå¼‚å¸¸æƒ…å†µçš„è‡ªåŠ¨é€šçŸ¥ç³»ç»Ÿ
```

### 7.2 å…³é”®é…ç½®å‚æ•°ç†è§£


**ğŸ”¹ ç«¯å£ä¸ç½‘ç»œ**
```
æ ¸å¿ƒå‚æ•°ï¼š
com.sun.management.jmxremote.port=9999          # JMXæœåŠ¡ç«¯å£
com.sun.management.jmxremote.local.only=false   # å…è®¸è¿œç¨‹è®¿é—®
java.rmi.server.hostname=å®é™…IPåœ°å€              # RMIæœåŠ¡å™¨åœ°å€

å®é™…å«ä¹‰ï¼š
è¿™äº›é…ç½®å†³å®šäº†ç›‘æ§ç³»ç»Ÿå¦‚ä½•è¿æ¥åˆ°Kafka
å°±åƒç»™æˆ¿å­å®‰è£…é—¨ç‰Œå·å’Œé—¨é“ƒä¸€æ ·
```

**ğŸ”¹ å®‰å…¨é…ç½®**
```
è®¤è¯å¼€å…³ï¼š
com.sun.management.jmxremote.authenticate=true  # å¼€å¯ç”¨æˆ·è®¤è¯
com.sun.management.jmxremote.ssl=true           # å¼€å¯SSLåŠ å¯†

å®é™…å«ä¹‰ï¼š
è®¤è¯=éªŒè¯èº«ä»½ï¼ˆæ£€æŸ¥é€šè¡Œè¯ï¼‰
SSL=åŠ å¯†é€šä¿¡ï¼ˆå¯†ç æœ¬é€šè¯ï¼‰
ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¼€å¯ï¼
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç›‘æ§è§£å†³çš„å®é™…é—®é¢˜**
- **æå‰é¢„è­¦**ï¼šç£ç›˜å¿«æ»¡ã€å†…å­˜ä¸è¶³ã€æ¶ˆè´¹å»¶è¿Ÿ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‘ç°ç“¶é¢ˆã€è°ƒä¼˜å‚æ•°ã€å®¹é‡è§„åˆ’  
- **æ•…éšœå®šä½**ï¼šå¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹å› ã€ç¼©çŸ­æ¢å¤æ—¶é—´
- **ä¸šåŠ¡ä¿éšœ**ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€æœåŠ¡ä¸ä¸­æ–­

**ğŸ”§ è¿ç»´å®è·µæŒ‡å¯¼**
- **æ—¥å¸¸å·¡æ£€**ï¼šé€šè¿‡ç›‘æ§å¤§å±äº†è§£ç³»ç»ŸçŠ¶æ€
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹èµ„æºéœ€æ±‚
- **æ•…éšœå¤„ç†**ï¼šæ ¹æ®å‘Šè­¦ä¿¡æ¯å¿«é€Ÿå“åº”
- **æ€§èƒ½è°ƒä¼˜**ï¼šé€šè¿‡æŒ‡æ ‡åˆ†æä¼˜åŒ–é…ç½®å‚æ•°

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- JMXç›‘æ§æ˜¯Kafkaè¿ç»´çš„"çœ¼ç›"ï¼Œæ²¡æœ‰ç›‘æ§å°±æ˜¯"ç›²äººæ‘¸è±¡"
- å®‰å…¨é…ç½®åœ¨ç”Ÿäº§ç¯å¢ƒä¸å¯å¦¥åï¼Œè®¤è¯å’ŒSSLå¿…é¡»å¼€å¯
- å‘Šè­¦ç­–ç•¥è¦åˆç†ï¼Œæ—¢ä¸èƒ½æ¼æŠ¥ä¹Ÿä¸èƒ½è¿‡åº¦æŠ¥è­¦
- ç›‘æ§æ•°æ®æ˜¯ä¼˜åŒ–å’Œæ•…éšœæ’æŸ¥çš„é‡è¦ä¾æ®ï¼Œè¦å¦¥å–„ä¿å­˜å’Œåˆ†æ