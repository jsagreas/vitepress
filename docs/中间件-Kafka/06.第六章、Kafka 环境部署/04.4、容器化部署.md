---
title: 4ã€å®¹å™¨åŒ–éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨åŒ–éƒ¨ç½²æ¦‚è¿°](#1-å®¹å™¨åŒ–éƒ¨ç½²æ¦‚è¿°)
2. [Dockeréƒ¨ç½²æ–¹æ¡ˆ](#2-Dockeréƒ¨ç½²æ–¹æ¡ˆ)
3. [Docker Composeé›†ç¾¤éƒ¨ç½²](#3-Docker-Composeé›†ç¾¤éƒ¨ç½²)
4. [Kubernetesç”Ÿäº§çº§éƒ¨ç½²](#4-Kubernetesç”Ÿäº§çº§éƒ¨ç½²)
5. [å­˜å‚¨ä¸æŒä¹…åŒ–ç­–ç•¥](#5-å­˜å‚¨ä¸æŒä¹…åŒ–ç­–ç•¥)
6. [é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°](#6-é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°)
7. [ç›‘æ§ä¸å¥åº·æ£€æŸ¥](#7-ç›‘æ§ä¸å¥åº·æ£€æŸ¥)
8. [å®¹å™¨åŒ–æœ€ä½³å®è·µ](#8-å®¹å™¨åŒ–æœ€ä½³å®è·µ)

---

## 1. ğŸš€ å®¹å™¨åŒ–éƒ¨ç½²æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Kafkaå®¹å™¨åŒ–


**ç®€å•ç†è§£**ï¼šå°±æ˜¯æŠŠKafkaæ‰“åŒ…æˆä¸€ä¸ª"é›†è£…ç®±"ï¼Œé‡Œé¢åŒ…å«äº†è¿è¡ŒKafkaæ‰€éœ€çš„ä¸€åˆ‡

```
ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š
æœåŠ¡å™¨ â†’ å®‰è£…JDK â†’ ä¸‹è½½Kafka â†’ é…ç½®ç¯å¢ƒ â†’ å¯åŠ¨æœåŠ¡

å®¹å™¨åŒ–éƒ¨ç½²ï¼š  
æ‹‰å–é•œåƒ â†’ è¿è¡Œå®¹å™¨ â†’ Kafkaç›´æ¥å¯ç”¨ âœ¨

å°±åƒæ¬å®¶æ—¶æŠŠæ‰€æœ‰ä¸œè¥¿è£…è¿›æ ‡å‡†é›†è£…ç®±ï¼Œåˆ°å“ªéƒ½èƒ½å¿«é€Ÿä½¿ç”¨
```

### 1.2 å®¹å™¨åŒ–çš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ”¸ ç¯å¢ƒä¸€è‡´æ€§**
- **é—®é¢˜è§£å†³**ï¼šå‘Šåˆ«"åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘"çš„å›°æ‰°
- **å®é™…æ•ˆæœ**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´
- **é€šä¿—æ¯”å–»**ï¼šåƒé€Ÿé£ŸåŒ…ä¸€æ ·ï¼Œæ— è®ºåœ¨å“ªåŠ çƒ­å‘³é“éƒ½ä¸€æ ·

**ğŸ”¸ å¿«é€Ÿéƒ¨ç½²æ‰©å±•**
- **ä¼ ç»Ÿæ–¹å¼**ï¼šæ–°å¢èŠ‚ç‚¹éœ€è¦1-2å°æ—¶é…ç½®
- **å®¹å™¨æ–¹å¼**ï¼šå‡ åˆ†é’Ÿå°±èƒ½æ‰©å±•æ–°èŠ‚ç‚¹
- **å¼¹æ€§ä¼¸ç¼©**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨å¢å‡KafkaèŠ‚ç‚¹

**ğŸ”¸ èµ„æºé«˜æ•ˆåˆ©ç”¨**
```
ç‰©ç†æœºèµ„æºåˆ†é…ï¼š
CPU: 16æ ¸ â†’ å¯è¿è¡Œå¤šä¸ªKafkaå®¹å™¨å®ä¾‹
å†…å­˜: 64GB â†’ æŒ‰éœ€åˆ†é…ç»™ä¸åŒå®¹å™¨
ç£ç›˜: 2TB â†’ å®¹å™¨å…±äº«ï¼Œçµæ´»è°ƒåº¦
```

### 1.3 å®¹å™¨åŒ–éƒ¨ç½²æ–¹å¼å¯¹æ¯”


| éƒ¨ç½²æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **å¤æ‚åº¦** | **æ‰©å±•æ€§** | **ç»´æŠ¤æˆæœ¬** |
|---------|------------|----------|-----------|-------------|
| ğŸ³ **Dockerå•æœº** | `å¼€å‘æµ‹è¯•` | `ä½` | `ä½` | `ä½` |
| ğŸ“¦ **Docker Compose** | `å°å‹é›†ç¾¤` | `ä¸­` | `ä¸­` | `ä¸­` |
| â˜¸ï¸ **Kubernetes** | `ç”Ÿäº§ç¯å¢ƒ` | `é«˜` | `é«˜` | `é«˜` |

---

## 2. ğŸ³ Dockeréƒ¨ç½²æ–¹æ¡ˆ


### 2.1 Dockeré•œåƒé€‰æ‹©ç­–ç•¥


**å®˜æ–¹é•œåƒ vs ç¬¬ä¸‰æ–¹é•œåƒ**

```bash
# Apacheå®˜æ–¹é•œåƒï¼ˆæ¨èï¼‰
docker pull apache/kafka:latest

# Confluentä¼ä¸šç‰ˆé•œåƒ  
docker pull confluentinc/cp-kafka:latest

# Bitnamiä¼˜åŒ–é•œåƒ
docker pull bitnami/kafka:latest
```

**é•œåƒé€‰æ‹©å»ºè®®**ï¼š
- **å­¦ä¹ é˜¶æ®µ**ï¼šApacheå®˜æ–¹é•œåƒï¼ŒåŸæ±åŸå‘³
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šConfluenté•œåƒï¼Œä¼ä¸šçº§åŠŸèƒ½ä¸°å¯Œ
- **è½»é‡åŒ–éœ€æ±‚**ï¼šBitnamié•œåƒï¼Œå¯åŠ¨é€Ÿåº¦å¿«

### 2.2 å•èŠ‚ç‚¹Kafkaå¿«é€Ÿå¯åŠ¨


**æœ€ç®€å•çš„Kafkaå®¹å™¨å¯åŠ¨**

```bash
# 1. å¯åŠ¨Zookeeperï¼ˆKafkaçš„åè°ƒæœåŠ¡ï¼‰
docker run -d \
  --name zookeeper \
  -p 2181:2181 \
  apache/kafka:latest \
  /opt/kafka/bin/zookeeper-server-start.sh /opt/kafka/config/zookeeper.properties

# 2. å¯åŠ¨KafkaæœåŠ¡å™¨
docker run -d \
  --name kafka \
  --link zookeeper:zookeeper \
  -p 9092:9092 \
  -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
  -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
  -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
  apache/kafka:latest \
  /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
```

**å‚æ•°è§£é‡Š**ï¼š
- `--link`ï¼šå®¹å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥
- `-e`ï¼šè®¾ç½®ç¯å¢ƒå˜é‡
- `KAFKA_ZOOKEEPER_CONNECT`ï¼šå‘Šè¯‰Kafkaå»å“ªæ‰¾Zookeeper
- `KAFKA_LISTENERS`ï¼šKafkaç›‘å¬çš„åœ°å€
- `KAFKA_ADVERTISED_LISTENERS`ï¼šå®¢æˆ·ç«¯è¿æ¥çš„åœ°å€

### 2.3 æ•°æ®æŒä¹…åŒ–é…ç½®


**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æŒä¹…åŒ–**ï¼Ÿ
```
å®¹å™¨çš„ç‰¹ç‚¹ï¼š
åˆ é™¤å®¹å™¨ â†’ æ•°æ®ä¸¢å¤± âŒ
é‡å¯å®¹å™¨ â†’ æ•°æ®é‡ç½® âŒ

è§£å†³æ–¹æ¡ˆï¼š
æŒ‚è½½å®¿ä¸»æœºç›®å½• â†’ æ•°æ®æ°¸ä¹…ä¿å­˜ âœ…
```

**æŒä¹…åŒ–å¯åŠ¨å‘½ä»¤**ï¼š

```bash
# åˆ›å»ºæ•°æ®ç›®å½•
mkdir -p /data/kafka-data /data/kafka-logs /data/zookeeper-data

# å¸¦æ•°æ®æŒä¹…åŒ–çš„å¯åŠ¨
docker run -d \
  --name kafka-persistent \
  -p 9092:9092 \
  -v /data/kafka-data:/opt/kafka/data \
  -v /data/kafka-logs:/opt/kafka/logs \
  -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
  -e KAFKA_LOG_DIRS=/opt/kafka/data \
  -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \
  -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
  apache/kafka:latest
```

---

## 3. ğŸ“¦ Docker Composeé›†ç¾¤éƒ¨ç½²


### 3.1 ä»€ä¹ˆæ˜¯Docker Compose


**é€šä¿—ç†è§£**ï¼šDocker Composeå°±åƒä¸€ä¸ª"æœåŠ¡ç¼–æ’æŒ‡æŒ¥å®˜"

```
å•ç‹¬å¯åŠ¨å®¹å™¨ï¼š
docker run kafka â†’ docker run zookeeper â†’ docker runç›‘æ§...
æ¯æ¬¡è¦æ•²å¾ˆå¤šå‘½ä»¤ï¼Œå®¹æ˜“å‡ºé”™

Docker Composeï¼š
å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ â†’ ä¸€ä¸ªå‘½ä»¤å¯åŠ¨æ•´å¥—æœåŠ¡
docker-compose up â†’ æ‰€æœ‰æœåŠ¡æŒ‰é¡ºåºå¯åŠ¨ âœ¨
```

### 3.2 ä¸‰èŠ‚ç‚¹Kafkaé›†ç¾¤é…ç½®


åˆ›å»º`docker-compose.yml`æ–‡ä»¶ï¼š

```yaml
version: '3.8'

services:
  # Zookeeperé›†ç¾¤
  zookeeper:
    image: apache/kafka:latest
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zk-data:/opt/kafka/config/zookeeper
    command: ["/opt/kafka/bin/zookeeper-server-start.sh", "/opt/kafka/config/zookeeper.properties"]

  # KafkaèŠ‚ç‚¹1
  kafka1:
    image: apache/kafka:latest
    container_name: kafka1
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LOG_DIRS: /kafka/logs
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
    volumes:
      - kafka1-data:/kafka/logs

  # KafkaèŠ‚ç‚¹2
  kafka2:
    image: apache/kafka:latest
    container_name: kafka2
    depends_on:
      - zookeeper
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9093
      KAFKA_LOG_DIRS: /kafka/logs
    volumes:
      - kafka2-data:/kafka/logs

  # KafkaèŠ‚ç‚¹3
  kafka3:
    image: apache/kafka:latest
    container_name: kafka3
    depends_on:
      - zookeeper
    ports:
      - "9094:9092"
    environment:
      KAFKA_BROKER_ID: 3
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9094
      KAFKA_LOG_DIRS: /kafka/logs
    volumes:
      - kafka3-data:/kafka/logs

# æ•°æ®å·å®šä¹‰
volumes:
  zk-data:
  kafka1-data:
  kafka2-data:
  kafka3-data:
```

### 3.3 é›†ç¾¤å¯åŠ¨ä¸ç®¡ç†


**å¯åŠ¨é›†ç¾¤**ï¼š
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€  
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs kafka1
```

**é›†ç¾¤éªŒè¯**ï¼š
```bash
# è¿›å…¥Kafkaå®¹å™¨
docker exec -it kafka1 bash

# åˆ›å»ºæµ‹è¯•ä¸»é¢˜ï¼ˆ3ä¸ªåˆ†åŒºï¼Œ3ä¸ªå‰¯æœ¬ï¼‰
/opt/kafka/bin/kafka-topics.sh --create \
  --bootstrap-server localhost:9092 \
  --topic test-cluster \
  --partitions 3 \
  --replication-factor 3

# æŸ¥çœ‹ä¸»é¢˜è¯¦æƒ…
/opt/kafka/bin/kafka-topics.sh --describe \
  --bootstrap-server localhost:9092 \
  --topic test-cluster
```

**æœŸæœ›è¾“å‡º**ï¼š
```
Topic: test-cluster
Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3
Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1
Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2
```

> **è§£è¯»**ï¼šæ¯ä¸ªåˆ†åŒºéƒ½æœ‰3ä¸ªå‰¯æœ¬åˆ†å¸ƒåœ¨3ä¸ªä¸åŒèŠ‚ç‚¹ä¸Šï¼Œå®ç°äº†é«˜å¯ç”¨

---

## 4. â˜¸ï¸ Kubernetesç”Ÿäº§çº§éƒ¨ç½²


### 4.1 ä¸ºä»€ä¹ˆé€‰æ‹©Kubernetes


**Kubernetes vs Docker Composeå¯¹æ¯”**ï¼š

```
Docker Composeï¼ˆé€‚åˆå°è§„æ¨¡ï¼‰ï¼š
âœ… é…ç½®ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½
âœ… é€‚åˆå¼€å‘æµ‹è¯•ç¯å¢ƒ
âŒ æ‰©å®¹éœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®
âŒ å•ç‚¹æ•…éšœé£é™©

Kubernetesï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š
âœ… è‡ªåŠ¨æ‰©ç¼©å®¹
âœ… æ•…éšœè‡ªæ„ˆèƒ½åŠ›
âœ… æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡
âœ… æ»šåŠ¨æ›´æ–°é›¶åœæœº
âŒ å­¦ä¹ æ›²çº¿é™¡å³­
```

### 4.2 StatefulSetéƒ¨ç½²æ–¹æ¡ˆ


**ä¸ºä»€ä¹ˆç”¨StatefulSetè€Œä¸æ˜¯Deployment**ï¼Ÿ

```
Kafkaçš„ç‰¹æ®Šéœ€æ±‚ï¼š
ğŸ”¸ æ¯ä¸ªèŠ‚ç‚¹éœ€è¦å”¯ä¸€æ ‡è¯†ï¼ˆbroker.idï¼‰
ğŸ”¸ æ•°æ®éœ€è¦ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹
ğŸ”¸ èŠ‚ç‚¹å¯åŠ¨æœ‰é¡ºåºè¦æ±‚

StatefulSetç‰¹ç‚¹ï¼š
âœ… æä¾›ç¨³å®šçš„ç½‘ç»œæ ‡è¯†
âœ… æœ‰åºéƒ¨ç½²å’Œæ‰©ç¼©å®¹  
âœ… ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨
```

**Kafka StatefulSeté…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: kafka
spec:
  serviceName: kafka-headless
  replicas: 3
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
      - name: kafka
        image: apache/kafka:latest
        ports:
        - containerPort: 9092
          name: kafka
        env:
        - name: KAFKA_BROKER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['kafka.broker.id']
        - name: KAFKA_ZOOKEEPER_CONNECT
          value: "zookeeper:2181"
        - name: KAFKA_LISTENERS
          value: "PLAINTEXT://0.0.0.0:9092"
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://$(hostname).kafka-headless:9092"
        volumeMounts:
        - name: kafka-data
          mountPath: /kafka/logs
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi" 
            cpu: "2"
  volumeClaimTemplates:
  - metadata:
      name: kafka-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast-ssd
```

### 4.3 æœåŠ¡å‘ç°é…ç½®


**Headless Serviceé…ç½®**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: kafka-headless
  namespace: kafka
spec:
  clusterIP: None  # HeadlessæœåŠ¡
  selector:
    app: kafka
  ports:
  - port: 9092
    targetPort: 9092
    name: kafka

---
apiVersion: v1
kind: Service  
metadata:
  name: kafka-service
  namespace: kafka
spec:
  selector:
    app: kafka
  ports:
  - port: 9092
    targetPort: 9092
  type: LoadBalancer  # å¯¹å¤–æš´éœ²
```

**æœåŠ¡å‘ç°çš„å·¥ä½œåŸç†**ï¼š
```
å®¢æˆ·ç«¯è¿æ¥æµç¨‹ï¼š
1. å®¢æˆ·ç«¯è¯·æ±‚ kafka-service
2. LoadBalanceréšæœºè½¬å‘åˆ°æŸä¸ªKafkaèŠ‚ç‚¹
3. è¯¥èŠ‚ç‚¹è¿”å›é›†ç¾¤å…ƒæ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰èŠ‚ç‚¹åœ°å€ï¼‰
4. å®¢æˆ·ç«¯ç›´æ¥è¿æ¥ç›®æ ‡èŠ‚ç‚¹è¿›è¡Œæ•°æ®ä¼ è¾“

è¿™æ ·æ—¢æœ‰è´Ÿè½½å‡è¡¡ï¼Œåˆä¿è¯äº†æ•°æ®ä¼ è¾“æ•ˆç‡
```

---

## 5. ğŸ’¾ å­˜å‚¨ä¸æŒä¹…åŒ–ç­–ç•¥


### 5.1 å­˜å‚¨ç±»å‹é€‰æ‹©


**å­˜å‚¨æ€§èƒ½å¯¹æ¯”**ï¼š

| å­˜å‚¨ç±»å‹ | **IOPS** | **å»¶è¿Ÿ** | **æˆæœ¬** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|---------|-------------|
| **æœ¬åœ°SSD** | `50,000+` | `<1ms` | `é«˜` | `é«˜ååé‡ç”Ÿäº§ç¯å¢ƒ` |
| **ç½‘ç»œSSD** | `10,000` | `1-3ms` | `ä¸­` | `ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒ` |
| **ç½‘ç»œHDD** | `500` | `10ms+` | `ä½` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` |

### 5.2 Kuberneteså­˜å‚¨é…ç½®


**StorageClasså®šä¹‰**ï¼š
```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: kafka-storage
parameters:
  type: gp3  # AWS EBS GP3
  iops: "3000"
  throughput: "125"  # MB/s
provisioner: ebs.csi.aws.com
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
```

**ä¸ºä»€ä¹ˆè®¾ç½®è¿™äº›å‚æ•°**ï¼š
- `iops: 3000`ï¼šä¿è¯è¶³å¤Ÿçš„è¯»å†™æ€§èƒ½
- `allowVolumeExpansion`ï¼šæ”¯æŒåœ¨çº¿æ‰©å®¹
- `WaitForFirstConsumer`ï¼šç¡®ä¿å­˜å‚¨å’ŒPodåœ¨åŒä¸€å¯ç”¨åŒº

### 5.3 å¤‡ä»½æ¢å¤ç­–ç•¥


**è‡ªåŠ¨åŒ–å¤‡ä»½æ–¹æ¡ˆ**ï¼š
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kafka-backup
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: kafka-backup:latest
            command:
            - /bin/bash
            - -c 
            - |
              # å¤‡ä»½Kafkaæ•°æ®åˆ°å¯¹è±¡å­˜å‚¨
              tar -czf /tmp/kafka-backup-$(date +%Y%m%d).tar.gz /kafka/logs
              aws s3 cp /tmp/kafka-backup-$(date +%Y%m%d).tar.gz s3://kafka-backup-bucket/
            volumeMounts:
            - name: kafka-data
              mountPath: /kafka/logs
              readOnly: true
          restartPolicy: OnFailure
```

---

## 6. ğŸ”§ é…ç½®ç®¡ç†ä¸æœåŠ¡å‘ç°


### 6.1 ConfigMapé…ç½®ç®¡ç†


**ç»Ÿä¸€é…ç½®ç®¡ç†**ï¼š
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-config
  namespace: kafka
data:
  server.properties: |
    # åŸºç¡€é…ç½®
    num.network.threads=8
    num.io.threads=16
    socket.send.buffer.bytes=102400
    socket.receive.buffer.bytes=102400
    socket.request.max.bytes=104857600
    
    # æ—¥å¿—é…ç½®
    log.retention.hours=168
    log.retention.bytes=1073741824
    log.segment.bytes=1073741824
    
    # æ€§èƒ½ä¼˜åŒ–
    num.replica.fetchers=4
    replica.fetch.max.bytes=1048576
```

**åœ¨StatefulSetä¸­ä½¿ç”¨ConfigMap**ï¼š
```yaml
spec:
  template:
    spec:
      containers:
      - name: kafka
        # ... å…¶ä»–é…ç½®
        volumeMounts:
        - name: config
          mountPath: /opt/kafka/config/server.properties
          subPath: server.properties
      volumes:
      - name: config
        configMap:
          name: kafka-config
```

### 6.2 Secretç®¡ç†æ•æ„Ÿä¿¡æ¯


**SASLè®¤è¯é…ç½®**ï¼š
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: kafka-secrets
type: Opaque
stringData:
  jaas.conf: |
    KafkaServer {
      org.apache.kafka.common.security.plain.PlainLoginModule required
      username="kafka"
      password="kafka-secret-password"
      user_kafka="kafka-secret-password"
      user_client="client-password";
    };
```

### 6.3 ç¯å¢ƒç‰¹å®šé…ç½®


**å¤šç¯å¢ƒé…ç½®ç­–ç•¥**ï¼š
```yaml
# å¼€å‘ç¯å¢ƒé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-config-dev
data:
  KAFKA_HEAP_OPTS: "-Xms1G -Xmx1G"
  KAFKA_LOG_RETENTION_HOURS: "24"
  
---
# ç”Ÿäº§ç¯å¢ƒé…ç½®  
apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-config-prod
data:
  KAFKA_HEAP_OPTS: "-Xms8G -Xmx8G"
  KAFKA_LOG_RETENTION_HOURS: "168"
```

---

## 7. ğŸ“Š ç›‘æ§ä¸å¥åº·æ£€æŸ¥


### 7.1 å¥åº·æ£€æŸ¥é…ç½®


**å®¹å™¨å¥åº·æ£€æŸ¥**ï¼š
```yaml
spec:
  containers:
  - name: kafka
    # ... å…¶ä»–é…ç½®
    livenessProbe:
      exec:
        command:
        - /opt/kafka/bin/kafka-broker-api-versions.sh
        - --bootstrap-server
        - localhost:9092
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      
    readinessProbe:
      exec:
        command:
        - /bin/bash
        - -c
        - "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list"
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3
```

**å¥åº·æ£€æŸ¥çš„ä½œç”¨**ï¼š
- **livenessProbe**ï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜æ´»ç€ï¼Œæ­»äº†å°±é‡å¯
- **readinessProbe**ï¼šæ£€æŸ¥å®¹å™¨æ˜¯å¦readyï¼Œæ²¡readyå°±ä¸è½¬å‘æµé‡

### 7.2 ç›‘æ§æŒ‡æ ‡æ”¶é›†


**JMXç›‘æ§æš´éœ²**ï¼š
```yaml
spec:
  containers:
  - name: kafka
    env:
    - name: KAFKA_JMX_OPTS
      value: "-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=9999"
    ports:
    - containerPort: 9999
      name: jmx
```

**Prometheusç›‘æ§é›†æˆ**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka-exporter
  template:
    metadata:
      labels:
        app: kafka-exporter
    spec:
      containers:
      - name: kafka-exporter
        image: danielqsj/kafka-exporter:latest
        ports:
        - containerPort: 9308
        args:
        - --kafka.server=kafka-service:9092
        - --web.listen-address=:9308
```

### 7.3 æ—¥å¿—æ”¶é›†ä¸åˆ†æ


**Fluentdæ—¥å¿—æ”¶é›†é…ç½®**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-kafka
spec:
  selector:
    matchLabels:
      name: fluentd-kafka
  template:
    metadata:
      labels:
        name: fluentd-kafka
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:latest
        volumeMounts:
        - name: kafka-logs
          mountPath: /var/log/kafka
          readOnly: true
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch-service"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
```

---

## 8. â­ å®¹å™¨åŒ–æœ€ä½³å®è·µ


### 8.1 å®‰å…¨é…ç½®æœ€ä½³å®è·µ


**å®¹å™¨å®‰å…¨åŠ å›º**ï¼š
```yaml
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        fsGroup: 1001
      containers:
      - name: kafka
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
```

**ç½‘ç»œå®‰å…¨ç­–ç•¥**ï¼š
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: kafka-network-policy
spec:
  podSelector:
    matchLabels:
      app: kafka
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kafka-client
    ports:
    - protocol: TCP
      port: 9092
```

### 8.2 èµ„æºé™åˆ¶ä¸è°ƒä¼˜


**èµ„æºé…ç½®æŒ‡å¯¼**ï¼š
```yaml
resources:
  requests:
    memory: "4Gi"      # åŸºç¡€å†…å­˜éœ€æ±‚
    cpu: "1000m"       # 1æ ¸CPU
  limits:
    memory: "8Gi"      # æœ€å¤§å†…å­˜é™åˆ¶
    cpu: "2000m"       # æœ€å¤§2æ ¸CPU
```

**JVMè°ƒä¼˜å‚æ•°**ï¼š
```yaml
env:
- name: KAFKA_HEAP_OPTS
  value: "-Xms4G -Xmx4G"
- name: KAFKA_JVM_PERFORMANCE_OPTS  
  value: "-server -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35"
```

### 8.3 è¿ç»´è‡ªåŠ¨åŒ–


**æ»šåŠ¨æ›´æ–°ç­–ç•¥**ï¼š
```yaml
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
      maxUnavailable: 1
```

**è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®**ï¼š
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kafka-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: kafka
  minReplicas: 3
  maxReplicas: 9
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 8.4 æ•…éšœæ¢å¤é¢„æ¡ˆ


**å¸¸è§æ•…éšœå¤„ç†**ï¼š

```bash
# 1. Podæ— æ³•å¯åŠ¨
kubectl describe pod kafka-0
kubectl logs kafka-0 --previous

# 2. å­˜å‚¨ç©ºé—´ä¸è¶³
kubectl get pvc
kubectl patch pvc kafka-data-kafka-0 -p '{"spec":{"resources":{"requests":{"storage":"200Gi"}}}}'

# 3. èŠ‚ç‚¹æ•…éšœåˆ‡æ¢
kubectl get nodes
kubectl drain <æ•…éšœèŠ‚ç‚¹å> --ignore-daemonsets --delete-emptydir-data

# 4. æ•°æ®æ¢å¤
kubectl scale statefulset kafka --replicas=0
# æ¢å¤æ•°æ®åˆ°PVC
kubectl scale statefulset kafka --replicas=3
```

### 8.5 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å­˜å‚¨ä¼˜åŒ–**ï¼š
```yaml
# ä½¿ç”¨æœ¬åœ°SSDå­˜å‚¨
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-ssd
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
```

**ç½‘ç»œä¼˜åŒ–**ï¼š
```yaml
# å¯ç”¨å®¿ä¸»æœºç½‘ç»œæ¨¡å¼ï¼ˆé«˜æ€§èƒ½åœºæ™¯ï¼‰
spec:
  template:
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨åŒ–æœ¬è´¨ï¼šæ ‡å‡†åŒ–çš„è½¯ä»¶æ‰“åŒ…å’Œéƒ¨ç½²æ–¹å¼
ğŸ”¸ é•œåƒé€‰æ‹©ï¼šå®˜æ–¹é•œåƒç¨³å®šï¼Œä¼ä¸šç‰ˆåŠŸèƒ½ä¸°å¯Œ
ğŸ”¸ æ•°æ®æŒä¹…åŒ–ï¼šå®¹å™¨æ•°æ®é»˜è®¤æ˜“å¤±ï¼Œéœ€è¦æŒ‚è½½å­˜å‚¨å·
ğŸ”¸ StatefulSetï¼šæœ‰çŠ¶æ€æœåŠ¡çš„Kuberneteséƒ¨ç½²æ–¹å¼
ğŸ”¸ æœåŠ¡å‘ç°ï¼šè®©é›†ç¾¤å†…å„ç»„ä»¶èƒ½å¤Ÿç›¸äº’æ‰¾åˆ°å¹¶é€šä¿¡
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¹å™¨åŒ–vsä¼ ç»Ÿéƒ¨ç½²**
```
ä¼ ç»Ÿéƒ¨ç½²ç—›ç‚¹ï¼š
â€¢ ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„éƒ¨ç½²é—®é¢˜
â€¢ èµ„æºåˆ©ç”¨ç‡ä½
â€¢ æ‰©ç¼©å®¹å¤æ‚

å®¹å™¨åŒ–ä¼˜åŠ¿ï¼š
â€¢ ç¯å¢ƒä¸€è‡´æ€§ä¿è¯
â€¢ èµ„æºé«˜æ•ˆåˆ©ç”¨  
â€¢ å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›
```

**ğŸ”¹ Docker vs Kubernetes**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ å­¦ä¹ é˜¶æ®µï¼šDocker Composeç®€å•æ˜“ç”¨
â€¢ å°å‹é¡¹ç›®ï¼šDocker Composeè¶³å¤Ÿ
â€¢ ç”Ÿäº§ç¯å¢ƒï¼šKubernetesæä¾›ä¼ä¸šçº§èƒ½åŠ›
â€¢ å¤§è§„æ¨¡é›†ç¾¤ï¼šå¿…é¡»ä½¿ç”¨Kubernetes
```

**ğŸ”¹ å­˜å‚¨ç­–ç•¥é‡è¦æ€§**
```
å…³é”®å†³ç­–ï¼š
â€¢ æ€§èƒ½è¦æ±‚ï¼šé€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±»å‹
â€¢ æ•°æ®å®‰å…¨ï¼šé…ç½®å¤‡ä»½æ¢å¤ç­–ç•¥  
â€¢ æˆæœ¬æ§åˆ¶ï¼šå¹³è¡¡æ€§èƒ½å’Œè´¹ç”¨
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å¼€å‘æ•ˆç‡æå‡**
- **å¿«é€Ÿç¯å¢ƒæ­å»º**ï¼šå‡ åˆ†é’Ÿéƒ¨ç½²å®Œæ•´Kafkaé›†ç¾¤
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ¶ˆé™¤"æˆ‘è¿™é‡Œèƒ½è·‘"é—®é¢˜
- **ç®€åŒ–è¿ç»´**ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²ã€ç›‘æ§ã€æ‰©ç¼©å®¹

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒä¿éšœ**  
- **é«˜å¯ç”¨æ€§**ï¼šå¤šèŠ‚ç‚¹ã€è‡ªåŠ¨æ•…éšœè½¬ç§»
- **å¼¹æ€§ä¼¸ç¼©**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æº
- **ç›‘æ§å‘Šè­¦**ï¼šå…¨æ–¹ä½çš„å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡ç›‘æ§

**ğŸ¯ æˆæœ¬æ•ˆç›Šä¼˜åŒ–**
- **èµ„æºå…±äº«**ï¼šå¤šä¸ªæœåŠ¡å…±äº«ç‰©ç†èµ„æº
- **æŒ‰éœ€åˆ†é…**ï¼šæ ¹æ®å®é™…éœ€æ±‚åˆ†é…èµ„æº
- **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šå‡å°‘äººå·¥è¿ç»´æˆæœ¬

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


**é˜¶æ®µ1ï¼šåŸºç¡€å…¥é—¨**
1. ç†è§£å®¹å™¨åŒ–åŸºæœ¬æ¦‚å¿µ
2. å®è·µDockerå•æœºéƒ¨ç½²
3. æŒæ¡Docker Composeé›†ç¾¤éƒ¨ç½²

**é˜¶æ®µ2ï¼šè¿›é˜¶æå‡**
1. å­¦ä¹ KubernetesåŸºç¡€æ¦‚å¿µ
2. å®è·µStatefulSetéƒ¨ç½²
3. é…ç½®å­˜å‚¨å’Œç½‘ç»œ

**é˜¶æ®µ3ï¼šç”Ÿäº§çº§åº”ç”¨**  
1. ç›‘æ§å’Œæ—¥å¿—æ”¶é›†
2. å®‰å…¨é…ç½®åŠ å›º
3. æ€§èƒ½è°ƒä¼˜å’Œæ•…éšœå¤„ç†

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®¹å™¨åŒ–è®©Kafkaéƒ¨ç½²æ ‡å‡†åŒ–ã€è‡ªåŠ¨åŒ–
- é€‰æ‹©åˆé€‚çš„ç¼–æ’å·¥å…·ï¼šDocker Compose vs Kubernetes
- æ•°æ®æŒä¹…åŒ–å’ŒæœåŠ¡å‘ç°æ˜¯å…³é”®æŠ€æœ¯ç‚¹
- ç›‘æ§ã€å®‰å…¨ã€æ€§èƒ½æ˜¯ç”Ÿäº§ç¯å¢ƒä¸‰å¤§è¦ç´ 