---
title: 14ã€Leaderé€‰ä¸¾é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [Leaderé€‰ä¸¾åŸºç¡€æ¦‚å¿µ](#1-Leaderé€‰ä¸¾åŸºç¡€æ¦‚å¿µ)
2. [æ§åˆ¶å™¨é€‰ä¸¾å¤±è´¥é—®é¢˜](#2-æ§åˆ¶å™¨é€‰ä¸¾å¤±è´¥é—®é¢˜)
3. [åˆ†åŒºLeaderé¢‘ç¹åˆ‡æ¢](#3-åˆ†åŒºLeaderé¢‘ç¹åˆ‡æ¢)
4. [ISRåˆ—è¡¨æ”¶ç¼©é—®é¢˜](#4-ISRåˆ—è¡¨æ”¶ç¼©é—®é¢˜)
5. [é€‰ä¸¾è¶…æ—¶ä¸ç­–ç•¥é…ç½®](#5-é€‰ä¸¾è¶…æ—¶ä¸ç­–ç•¥é…ç½®)
6. [ç½‘ç»œåˆ†åŒºä¸ä¼šè¯ä¸¢å¤±](#6-ç½‘ç»œåˆ†åŒºä¸ä¼šè¯ä¸¢å¤±)
7. [ç›‘æ§å‘Šè­¦ä¸æ‰‹åŠ¨æ“ä½œ](#7-ç›‘æ§å‘Šè­¦ä¸æ‰‹åŠ¨æ“ä½œ)
8. [æ•…éšœæ’æŸ¥æ€»ç»“](#8-æ•…éšœæ’æŸ¥æ€»ç»“)

---

## 1. ğŸ¯ Leaderé€‰ä¸¾åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Leaderé€‰ä¸¾


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªç­çº§éœ€è¦é€‰ç­é•¿
```
ç°å®åœºæ™¯ï¼š               Kafkaåœºæ™¯ï¼š
ç­çº§æˆå‘˜ â†’ æŠ•ç¥¨é€‰ç­é•¿     å‰¯æœ¬èŠ‚ç‚¹ â†’ é€‰ä¸¾Leader
ç­é•¿è´Ÿè´£ç»„ç»‡æ´»åŠ¨         Leaderè´Ÿè´£å¤„ç†è¯»å†™è¯·æ±‚
ç­é•¿ç¦»å¼€éœ€è¦é‡æ–°é€‰ä¸¾     Leaderæ•…éšœéœ€è¦é‡æ–°é€‰ä¸¾
```

**ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
- **Leader**ï¼šåˆ†åŒºçš„ä¸»å‰¯æœ¬ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰è¯»å†™è¯·æ±‚
- **Follower**ï¼šåˆ†åŒºçš„ä»å‰¯æœ¬ï¼Œåªè´Ÿè´£åŒæ­¥Leaderçš„æ•°æ®
- **ISR**ï¼šIn-Sync Replicasï¼Œä¸Leaderä¿æŒåŒæ­¥çš„å‰¯æœ¬åˆ—è¡¨
- **Controller**ï¼šé›†ç¾¤æ§åˆ¶å™¨ï¼Œè´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤çš„Leaderé€‰ä¸¾

### 1.2 é€‰ä¸¾çš„åŸºæœ¬æµç¨‹


**ğŸ”„ é€‰ä¸¾è¿‡ç¨‹å›¾ç¤º**ï¼š
```
æ­¥éª¤1: Leaderæ•…éšœæ£€æµ‹
[Leader] âŒ â†’ [Controlleræ£€æµ‹åˆ°æ•…éšœ]

æ­¥éª¤2: ä»ISRä¸­é€‰æ‹©æ–°Leader  
[ISR: Replica1, Replica2, Replica3] â†’ [é€‰æ‹©Replica1]

æ­¥éª¤3: é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹
[Controller] â†’ é€šçŸ¥ â†’ [æ‰€æœ‰BrokerèŠ‚ç‚¹]

æ­¥éª¤4: æ›´æ–°å…ƒæ•°æ®
[æ–°Leaderå¼€å§‹æœåŠ¡] â† [å®¢æˆ·ç«¯é‡æ–°è¿æ¥]
```

**â­â­â­ é‡è¦ç¨‹åº¦**ï¼šLeaderé€‰ä¸¾æ˜¯Kafkaé«˜å¯ç”¨çš„æ ¸å¿ƒæœºåˆ¶

---

## 2. ğŸš¨ æ§åˆ¶å™¨é€‰ä¸¾å¤±è´¥é—®é¢˜


### 2.1 é—®é¢˜ç°è±¡è¯†åˆ«


**ğŸ“‹ å…¸å‹ç—‡çŠ¶**ï¼š
- é›†ç¾¤ä¸­æ²¡æœ‰æ´»è·ƒçš„Controller
- åˆ†åŒºæ— æ³•è¿›è¡ŒLeaderé€‰ä¸¾
- æ–°å»ºtopicå¤±è´¥
- ç®¡ç†æ“ä½œå…¨éƒ¨é˜»å¡

**ğŸ” è¯Šæ–­å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å½“å‰Controllerä¿¡æ¯
kafka-broker-api-versions.sh --bootstrap-server localhost:9092 \
  --check-controller

# æŸ¥çœ‹Controllerå†å²è®°å½•
kafka-log-dirs.sh --bootstrap-server localhost:9092 \
  --describe --json | grep controller
```

### 2.2 å¸¸è§æ•…éšœåŸå› 


**ğŸ’¡ åŸå› åˆ†æè¡¨**ï¼š

| ğŸ†š **æ•…éšœç±»å‹** | **ç—‡çŠ¶** | **å½±å“ç¨‹åº¦** | **è§£å†³éš¾åº¦** |
|----------------|----------|-------------|-------------|
| ğŸ”‹ **ZooKeeperè¿æ¥é—®é¢˜** | æ— æ³•è¿æ¥ZK | ğŸ”´ ä¸¥é‡ | ğŸŸ¡ ä¸­ç­‰ |
| ğŸŒ **ç½‘ç»œå»¶è¿Ÿè¿‡é«˜** | é€‰ä¸¾è¶…æ—¶ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å®¹æ˜“ |
| ğŸ’¾ **ç£ç›˜IOå¼‚å¸¸** | å“åº”ç¼“æ…¢ | ğŸ”´ ä¸¥é‡ | ğŸ”´ å›°éš¾ |
| âš™ï¸ **é…ç½®é”™è¯¯** | å‚æ•°ä¸å½“ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ å®¹æ˜“ |

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**ï¼š

**Step 1** ğŸ” **æ£€æŸ¥ZooKeeperçŠ¶æ€**
```bash
# æ£€æŸ¥ZKè¿æ¥
echo ruok | nc zookeeper-host 2181

# æ£€æŸ¥ZKä¸­çš„Controllerä¿¡æ¯
zkCli.sh -server zookeeper-host:2181
ls /controller
get /controller
```

**Step 2** âš™ï¸ **è°ƒæ•´è¶…æ—¶é…ç½®**
```properties
# server.properties å…³é”®é…ç½®
zookeeper.session.timeout.ms=18000    # ZKä¼šè¯è¶…æ—¶(é»˜è®¤18ç§’)
zookeeper.connection.timeout.ms=6000  # ZKè¿æ¥è¶…æ—¶(é»˜è®¤6ç§’)
controller.socket.timeout.ms=30000    # Controlleré€šä¿¡è¶…æ—¶
```

**Step 3** ğŸš€ **å¼ºåˆ¶é‡æ–°é€‰ä¸¾**
```bash
# é‡å¯Brokerè§¦å‘Controlleré‡æ–°é€‰ä¸¾
systemctl restart kafka

# æˆ–è€…åˆ é™¤ZKä¸­çš„Controllerä¿¡æ¯(è°¨æ…æ“ä½œ)
zkCli.sh -server zookeeper-host:2181
delete /controller
```

### 2.3 é¢„é˜²æªæ–½


**ğŸ›¡ï¸ é˜²æŠ¤ç­–ç•¥**ï¼š
- **ç›‘æ§ControllerçŠ¶æ€**ï¼šè®¾ç½®Controllerå˜æ›´å‘Šè­¦
- **ç½‘ç»œä¼˜åŒ–**ï¼šç¡®ä¿Brokerä¸ZooKeeperé—´ç½‘ç»œç¨³å®š
- **èµ„æºä¿éšœ**ï¼šControllerèŠ‚ç‚¹é¢„ç•™è¶³å¤ŸCPUå’Œå†…å­˜

---

## 3. ğŸ”„ åˆ†åŒºLeaderé¢‘ç¹åˆ‡æ¢


### 3.1 é—®é¢˜è¡¨ç°


**âš ï¸ ç—‡çŠ¶è¯†åˆ«**ï¼š
```
æ—¶é—´çº¿é—®é¢˜è¡¨ç°ï¼š
09:00 - Leader: Broker1
09:05 - Leaderåˆ‡æ¢åˆ°: Broker2  
09:10 - Leaderåˆ‡æ¢åˆ°: Broker3
09:15 - Leaderåˆåˆ‡æ¢åˆ°: Broker1
```

**ğŸ“Š å½±å“åˆ†æ**ï¼š
- **æ€§èƒ½ä¸‹é™**ï¼šå®¢æˆ·ç«¯éœ€è¦é‡æ–°å‘ç°Leader
- **æ•°æ®å»¶è¿Ÿ**ï¼šåˆ‡æ¢è¿‡ç¨‹ä¸­çŸ­æš‚ä¸å¯ç”¨
- **èµ„æºæµªè´¹**ï¼šé¢‘ç¹çš„å…ƒæ•°æ®æ›´æ–°

### 3.2 æ ¹æœ¬åŸå› åˆ†æ


**ğŸ” å¸¸è§åŸå› æ’åº**ï¼š

**â­â­â­ æœ€å¸¸è§åŸå› **ï¼š
1. **ç½‘ç»œæŠ–åŠ¨**ï¼šBrokeré—´ç½‘ç»œä¸ç¨³å®š
2. **è´Ÿè½½è¿‡é«˜**ï¼šLeaderèŠ‚ç‚¹CPU/å†…å­˜/ç£ç›˜å‹åŠ›å¤§
3. **GCåœé¡¿**ï¼šJavaåƒåœ¾å›æ”¶å¯¼è‡´å“åº”è¶…æ—¶

**â­â­ æ¬¡è¦åŸå› **ï¼š
4. **é…ç½®ä¸å½“**ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­
5. **ç¡¬ä»¶æ•…éšœ**ï¼šç£ç›˜IOå¼‚å¸¸ã€ç½‘å¡æ•…éšœ

**ğŸ”§ è¯Šæ–­æ­¥éª¤**ï¼š

**Step 1** ğŸ“ˆ **ç›‘æ§ç³»ç»Ÿèµ„æº**
```bash
# æŸ¥çœ‹CPUä½¿ç”¨ç‡
top -p $(pgrep -f kafka)

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ  
free -m

# æŸ¥çœ‹ç£ç›˜IO
iostat -x 1
```

**Step 2** ğŸŒ **æ£€æŸ¥ç½‘ç»œçŠ¶å†µ**
```bash
# æµ‹è¯•Brokeré—´ç½‘ç»œå»¶è¿Ÿ
ping broker1-ip
ping broker2-ip

# æ£€æŸ¥ç½‘ç»œä¸¢åŒ…ç‡
mtr broker1-ip
```

**Step 3** ğŸ—‚ï¸ **åˆ†æGCæ—¥å¿—**
```bash
# æŸ¥çœ‹GCé¢‘ç‡å’Œåœé¡¿æ—¶é—´
tail -f /var/log/kafka/gc.log | grep "Full GC"
```

### 3.3 è§£å†³æ–¹æ¡ˆ


**ğŸ¯ é’ˆå¯¹æ€§è§£å†³**ï¼š

**ç½‘ç»œé—®é¢˜è§£å†³**ï¼š
```properties
# å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œå®¹å¿ç½‘ç»œæŠ–åŠ¨
replica.lag.time.max.ms=30000        # å‰¯æœ¬æ»åè¶…æ—¶(é»˜è®¤30ç§’)
replica.fetch.wait.max.ms=500        # å‰¯æœ¬æ‹‰å–ç­‰å¾…æ—¶é—´
replica.socket.timeout.ms=30000      # å‰¯æœ¬é€šä¿¡è¶…æ—¶
```

**è´Ÿè½½é—®é¢˜è§£å†³**ï¼š
```properties
# é™åˆ¶å¹¶å‘è¿æ¥å’Œè¯·æ±‚
num.network.threads=8               # ç½‘ç»œçº¿ç¨‹æ•°
num.io.threads=8                   # IOçº¿ç¨‹æ•°
queued.max.requests=500            # æœ€å¤§æ’é˜Ÿè¯·æ±‚æ•°
```

**GCä¼˜åŒ–**ï¼š
```bash
# JVMå‚æ•°è°ƒä¼˜
export KAFKA_HEAP_OPTS="-Xmx6g -Xms6g"
export KAFKA_JVM_PERFORMANCE_OPTS="-server -XX:+UseG1GC -XX:MaxGCPauseMillis=20"
```

---

## 4. ğŸ“‰ ISRåˆ—è¡¨æ”¶ç¼©é—®é¢˜


### 4.1 ISRæ”¶ç¼©çš„å«ä¹‰


**ğŸ§  é€šä¿—è§£é‡Š**ï¼š
```
ç­çº§ä¾‹å­ï¼š
æ­£å¸¸æƒ…å†µï¼šç­é•¿(Leader) + 3ä¸ªç»„é•¿(ISRå‰¯æœ¬) = 4äººå°ç»„
ISRæ”¶ç¼©ï¼šå…¶ä¸­1ä¸ªç»„é•¿è·Ÿä¸ä¸Šè¿›åº¦ï¼Œè¢«ç§»å‡ºå°ç»„
ç»“æœï¼šç­é•¿ + 2ä¸ªç»„é•¿ = 3äººå°ç»„ï¼ˆé«˜å¯ç”¨æ€§é™ä½ï¼‰
```

**âš ï¸ å±é™©ä¿¡å·**ï¼š
- ISRåˆ—è¡¨ä¸­å‰¯æœ¬æ•°é‡å‡å°‘
- åªå‰©ä¸‹Leaderä¸€ä¸ªå‰¯æœ¬ï¼ˆæœ€å±é™©ï¼‰
- æ•°æ®ä¸¢å¤±é£é™©å¢åŠ 

### 4.2 æ”¶ç¼©åŸå› è¯Šæ–­


**ğŸ” æ”¶ç¼©åŸå› åˆ†æ**ï¼š

| åŸå› ç±»åˆ« | å…·ä½“è¡¨ç° | æ£€æŸ¥æ–¹æ³• | è§£å†³éš¾åº¦ |
|---------|---------|----------|---------|
| ğŸŒ **åŒæ­¥æ»å** | Followeræ‹‰å–æ…¢ | æŸ¥çœ‹å»¶è¿ŸæŒ‡æ ‡ | ğŸŸ¡ ä¸­ç­‰ |
| ğŸ’¾ **ç£ç›˜æ…¢** | å†™å…¥é€Ÿåº¦è·Ÿä¸ä¸Š | iostatæ£€æŸ¥ | ğŸ”´ å›°éš¾ |
| ğŸŒ **ç½‘ç»œé—®é¢˜** | å‰¯æœ¬é—´é€šä¿¡å¼‚å¸¸ | ç½‘ç»œç›‘æ§ | ğŸŸ¡ ä¸­ç­‰ |
| âš™ï¸ **é…ç½®ä¸å½“** | è¶…æ—¶æ—¶é—´è¿‡çŸ­ | é…ç½®æ£€æŸ¥ | ğŸŸ¢ ç®€å• |

**ğŸ“Š è¯Šæ–­å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹åˆ†åŒºISRçŠ¶æ€
kafka-topics.sh --bootstrap-server localhost:9092 \
  --describe --topic your-topic

# æŸ¥çœ‹å‰¯æœ¬å»¶è¿Ÿæƒ…å†µ
kafka-consumer-groups.sh --bootstrap-server localhost:9092 \
  --describe --group your-group
```

### 4.3 é¢„é˜²ISRæ”¶ç¼©


**ğŸ›¡ï¸ é¢„é˜²é…ç½®**ï¼š

**è°ƒæ•´åŒæ­¥å‚æ•°**ï¼š
```properties
# æ”¾å®½ISRæ¡ä»¶ï¼Œé¿å…é¢‘ç¹æ”¶ç¼©
replica.lag.time.max.ms=30000        # å»¶è¿Ÿå®¹å¿æ—¶é—´
min.insync.replicas=2                # æœ€å°åŒæ­¥å‰¯æœ¬æ•°
unclean.leader.election.enable=false # ç¦æ­¢ä¸å¹²å‡€é€‰ä¸¾
```

**ğŸ’¡ æœ€ä½³å®è·µ**ï¼š
- **ç›‘æ§ISRå˜åŒ–**ï¼šè®¾ç½®ISRæ”¶ç¼©å‘Šè­¦
- **å‡è¡¡è´Ÿè½½**ï¼šé¿å…å•ä¸ªBrokerå‹åŠ›è¿‡å¤§  
- **ç½‘ç»œä¼˜åŒ–**ï¼šç¡®ä¿Brokeré—´ç½‘ç»œç¨³å®š
- **ç£ç›˜ä¼˜åŒ–**ï¼šä½¿ç”¨SSDï¼Œå®šæœŸæ¸…ç†æ—¥å¿—

---

## 5. â° é€‰ä¸¾è¶…æ—¶ä¸ç­–ç•¥é…ç½®


### 5.1 è¶…æ—¶é—®é¢˜åˆ†æ


**â° è¶…æ—¶åœºæ™¯å›¾ç¤º**ï¼š
```
æ­£å¸¸é€‰ä¸¾æµç¨‹ï¼š
æ£€æµ‹æ•…éšœ â†’ é€‰æ‹©æ–°Leader â†’ é€šçŸ¥èŠ‚ç‚¹ â†’ æœåŠ¡æ¢å¤
   1s         2s           1s        1s    = 5s

è¶…æ—¶é€‰ä¸¾æµç¨‹ï¼š  
æ£€æµ‹æ•…éšœ â†’ ç­‰å¾…è¶…æ—¶ â†’ é‡è¯•é€‰æ‹© â†’ å¤šæ¬¡é€šçŸ¥ â†’ æœåŠ¡æ¢å¤
   5s        10s       15s        20s      = 50s
```

**ğŸš¨ è¶…æ—¶å½±å“**ï¼š
- **æœåŠ¡ä¸­æ–­æ—¶é—´å»¶é•¿**
- **å®¢æˆ·ç«¯è¿æ¥å¤±è´¥**
- **ç”Ÿäº§æ¶ˆè´¹é˜»å¡**

### 5.2 å…³é”®è¶…æ—¶å‚æ•°


**âš™ï¸ æ ¸å¿ƒé…ç½®è¯´æ˜**ï¼š

```properties
# Controllerç›¸å…³è¶…æ—¶
controller.socket.timeout.ms=30000           # Controlleré€šä¿¡è¶…æ—¶
controller.message.queue.size=10            # Controlleræ¶ˆæ¯é˜Ÿåˆ—å¤§å°

# é€‰ä¸¾ç›¸å…³è¶…æ—¶
zookeeper.session.timeout.ms=18000          # ZKä¼šè¯è¶…æ—¶
zookeeper.connection.timeout.ms=6000        # ZKè¿æ¥è¶…æ—¶
leader.imbalance.check.interval.seconds=300 # Leaderå¹³è¡¡æ£€æŸ¥é—´éš”
```

**ğŸ¯ è°ƒä¼˜å»ºè®®**ï¼š

| ç¯å¢ƒç±»å‹ | **ZKä¼šè¯è¶…æ—¶** | **è¿æ¥è¶…æ—¶** | **é€‚ç”¨åœºæ™¯** |
|---------|---------------|-------------|-------------|
| ğŸ  **å¼€å‘ç¯å¢ƒ** | 6000ms | 3000ms | å¿«é€Ÿæ•…éšœè½¬ç§» |
| ğŸ¢ **æµ‹è¯•ç¯å¢ƒ** | 12000ms | 6000ms | å¹³è¡¡ç¨³å®šæ€§ |
| ğŸ­ **ç”Ÿäº§ç¯å¢ƒ** | 18000ms | 6000ms | é¿å…è¯¯åˆ¤ |

### 5.3 é€‰ä¸¾ç­–ç•¥ä¼˜åŒ–


**ğŸ”§ ä¸å¹²å‡€é€‰ä¸¾æ§åˆ¶**ï¼š
```properties
# å…³é”®é…ç½®ï¼šæ§åˆ¶æ•°æ®ä¸€è‡´æ€§ vs å¯ç”¨æ€§
unclean.leader.election.enable=false  # ç¦æ­¢ä¸å¹²å‡€é€‰ä¸¾(æ¨è)
# true: ä¼˜å…ˆå¯ç”¨æ€§ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
# false: ä¼˜å…ˆä¸€è‡´æ€§ï¼Œç­‰å¾…ISRå‰¯æœ¬æ¢å¤
```

**ğŸ’­ å†³ç­–æ¡†æ¶**ï¼š
```
ä¸šåŠ¡ä¼˜å…ˆçº§è¯„ä¼°ï¼š
æ•°æ®å®Œæ•´æ€§ > æœåŠ¡å¯ç”¨æ€§ â†’ unclean.leader.election.enable=false
æœåŠ¡å¯ç”¨æ€§ > æ•°æ®å®Œæ•´æ€§ â†’ unclean.leader.election.enable=true
```

---

## 6. ğŸŒ ç½‘ç»œåˆ†åŒºä¸ä¼šè¯ä¸¢å¤±


### 6.1 ç½‘ç»œåˆ†åŒºé—®é¢˜


**ğŸ§  ç½‘ç»œåˆ†åŒºç†è§£**ï¼š
```
æ­£å¸¸ç½‘ç»œæ‹“æ‰‘ï¼š
Broker1 â†â†’ Broker2 â†â†’ Broker3
   â†“         â†“         â†“
  ZK1 â†â†’   ZK2   â†â†’  ZK3

ç½‘ç»œåˆ†åŒºåï¼š
Broker1 âŒ Broker2 â†â†’ Broker3  
   â†“     âŒ    â†“         â†“
  ZK1   âŒ   ZK2   â†â†’  ZK3
```

**âš ï¸ åˆ†åŒºå½±å“**ï¼š
- **è„‘è£‚é£é™©**ï¼šå¤šä¸ªControlleråŒæ—¶å­˜åœ¨
- **æ•°æ®ä¸ä¸€è‡´**ï¼šåˆ†åŒºä¸¤ä¾§æ•°æ®diverge
- **æœåŠ¡ä¸å¯ç”¨**ï¼šæ— æ³•è¾¾æˆå…±è¯†

### 6.2 ZooKeeperä¼šè¯ä¸¢å¤±


**ğŸ” ä¼šè¯ä¸¢å¤±è¯Šæ–­**ï¼š

**ç—‡çŠ¶è¡¨ç°**ï¼š
```bash
# æ—¥å¿—ä¸­çš„å…¸å‹é”™è¯¯
ERROR [Controller id=1] Error while electing or becoming controller
org.apache.kafka.common.errors.ControllerMovedException

ERROR Session expired for connectionstring
```

**ğŸ“Š æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æ£€æŸ¥ZooKeeperè¿æ¥çŠ¶æ€
echo stat | nc localhost 2181

# æŸ¥çœ‹ä¼šè¯ä¿¡æ¯
echo dump | nc localhost 2181 | grep "Session"

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
telnet zookeeper-host 2181
```

### 6.3 ç½‘ç»œé—®é¢˜è§£å†³


**ğŸ”§ è§£å†³ç­–ç•¥**ï¼š

**Step 1** ğŸŒ **ç½‘ç»œè¯Šæ–­**
```bash
# å…¨é¢ç½‘ç»œæ£€æŸ¥
ping -c 100 broker-host           # ä¸¢åŒ…ç‡æ£€æŸ¥
traceroute broker-host           # è·¯å¾„è·Ÿè¸ª  
iperf -c broker-host             # å¸¦å®½æµ‹è¯•
```

**Step 2** âš™ï¸ **é…ç½®è°ƒä¼˜**
```properties
# ç½‘ç»œå®¹é”™é…ç½®
socket.send.buffer.bytes=102400          # Socketå‘é€ç¼“å†²åŒº
socket.receive.buffer.bytes=102400       # Socketæ¥æ”¶ç¼“å†²åŒº
socket.request.max.bytes=104857600       # æœ€å¤§è¯·æ±‚å¤§å°
connections.max.idle.ms=600000          # è¿æ¥ç©ºé—²è¶…æ—¶
```

**Step 3** ğŸ›¡ï¸ **ç›‘æ§å‘Šè­¦**
```bash
# è®¾ç½®ç½‘ç»œç›‘æ§è„šæœ¬
#!/bin/bash
while true; do
    if ! ping -c 1 broker-host > /dev/null; then
        echo "$(date): Network issue detected" >> /var/log/kafka-network.log
        # å‘é€å‘Šè­¦
    fi
    sleep 10
done
```

---

## 7. ğŸ“Š ç›‘æ§å‘Šè­¦ä¸æ‰‹åŠ¨æ“ä½œ


### 7.1 é€‰ä¸¾ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§æŒ‡æ ‡** | **æ­£å¸¸å€¼** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-----------|-------------|
| ğŸ”„ **é€‰ä¸¾é¢‘ç‡** | LeaderElectionRateAndTimeMs | < 1æ¬¡/å°æ—¶ | > 5æ¬¡/å°æ—¶ |
| â° **é€‰ä¸¾è€—æ—¶** | LeaderElectionTimeMs | < 5ç§’ | > 30ç§’ |
| ğŸ‘‘ **Controller** | ActiveControllerCount | 1 | â‰  1 |
| ğŸ“ **ISRå˜åŒ–** | IsrExpandsPerSec | < 0.1 | > 1 |

**ğŸ” ç›‘æ§å‘½ä»¤**ï¼š
```bash
# JMXç›‘æ§é€‰ä¸¾æŒ‡æ ‡
jconsole broker-host:9999
# æŸ¥çœ‹kafka.controller:type=ControllerStatsæŒ‡æ ‡

# ä½¿ç”¨Kafka ManageræŸ¥çœ‹
kafka-manager.sh --zookeeper zk-host:2181
```

### 7.2 å‘Šè­¦é…ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™è®¾ç½®**ï¼š

**Prometheus + Grafana é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: kafka-leader-election
  rules:
  - alert: FrequentLeaderElection
    expr: kafka_controller_stats_leader_election_rate > 5
    for: 5m
    annotations:
      summary: "Kafka Leaderé€‰ä¸¾è¿‡äºé¢‘ç¹"
      
  - alert: NoActiveController  
    expr: kafka_controller_active_controller_count != 1
    for: 1m
    annotations:
      summary: "Kafkaé›†ç¾¤æ— æ´»è·ƒController"
```

### 7.3 æ‰‹åŠ¨æ“ä½œæŒ‡å—


**ğŸ› ï¸ å¸¸ç”¨æ‰‹åŠ¨æ“ä½œ**ï¼š

**è§¦å‘ä¼˜é€‰å‰¯æœ¬é€‰ä¸¾**ï¼š
```bash
# ç”Ÿæˆä¼˜é€‰å‰¯æœ¬é€‰ä¸¾JSONæ–‡ä»¶
echo '{"partitions":[{"topic":"test-topic","partition":0}]}' > preferred-replica-election.json

# æ‰§è¡Œä¼˜é€‰å‰¯æœ¬é€‰ä¸¾
kafka-preferred-replica-election.sh \
  --bootstrap-server localhost:9092 \
  --path-to-json-file preferred-replica-election.json
```

**æ‰‹åŠ¨åˆ†åŒºé‡åˆ†é…**ï¼š
```bash
# ç”Ÿæˆé‡åˆ†é…è®¡åˆ’
kafka-reassign-partitions.sh \
  --bootstrap-server localhost:9092 \
  --topics-to-move-json-file topics.json \
  --broker-list "1,2,3" \
  --generate

# æ‰§è¡Œé‡åˆ†é…
kafka-reassign-partitions.sh \
  --bootstrap-server localhost:9092 \
  --reassignment-json-file reassignment.json \
  --execute
```

**ğŸ’¡ æ“ä½œæ³¨æ„äº‹é¡¹**ï¼š
- **å¤‡ä»½é…ç½®**ï¼šæ“ä½œå‰å¤‡ä»½å½“å‰é…ç½®
- **ä¸šåŠ¡æ—¶é—´**ï¼šé€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ“ä½œ
- **é€æ­¥æ‰§è¡Œ**ï¼šåˆ†æ‰¹æ¬¡æ‰§è¡Œï¼Œè§‚å¯Ÿå½±å“
- **å›æ»šå‡†å¤‡**ï¼šå‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

## 8. ğŸ“‹ æ•…éšœæ’æŸ¥æ€»ç»“


### 8.1 é—®é¢˜è¯Šæ–­æµç¨‹


**ğŸ”„ æ ‡å‡†è¯Šæ–­æµç¨‹**ï¼š

```
Step 1: ç°è±¡ç¡®è®¤
[æ£€æŸ¥æ—¥å¿—] â†’ [æŸ¥çœ‹ç›‘æ§] â†’ [ç¡®å®šå½±å“èŒƒå›´]
     â†“
Step 2: åŸå› åˆ†æ  
[ç½‘ç»œæ£€æŸ¥] â†’ [èµ„æºæ£€æŸ¥] â†’ [é…ç½®æ£€æŸ¥]
     â†“
Step 3: è§£å†³æ–¹æ¡ˆ
[ä¸´æ—¶æ–¹æ¡ˆ] â†’ [æ ¹æœ¬è§£å†³] â†’ [éªŒè¯æ•ˆæœ]
     â†“
Step 4: é¢„é˜²æªæ–½
[ç›‘æ§å‘Šè­¦] â†’ [é…ç½®ä¼˜åŒ–] â†’ [æµç¨‹å®Œå–„]
```

### 8.2 æ ¸å¿ƒé…ç½®æ€»ç»“


**âš™ï¸ å…³é”®é…ç½®æ¸…å•**ï¼š

```properties
# === Controllerç›¸å…³ ===
controller.socket.timeout.ms=30000
controller.message.queue.size=10

# === ZooKeeperç›¸å…³ ===  
zookeeper.session.timeout.ms=18000
zookeeper.connection.timeout.ms=6000

# === å‰¯æœ¬åŒæ­¥ç›¸å…³ ===
replica.lag.time.max.ms=30000
min.insync.replicas=2
unclean.leader.election.enable=false

# === ç½‘ç»œç›¸å…³ ===
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
connections.max.idle.ms=600000
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ è¿ç»´æœ€ä½³å®è·µ**ï¼š

**â­â­â­ æ ¸å¿ƒå»ºè®®**ï¼š
1. **ç›‘æ§å…ˆè¡Œ**ï¼šå»ºç«‹å®Œå–„çš„é€‰ä¸¾ç›‘æ§å‘Šè­¦
2. **ç½‘ç»œç¨³å®š**ï¼šç¡®ä¿Brokeré—´ç½‘ç»œè´¨é‡
3. **èµ„æºå……è¶³**ï¼šé¿å…å•ç‚¹èµ„æºç“¶é¢ˆ
4. **é…ç½®åˆç†**ï¼šæ ¹æ®ç¯å¢ƒè°ƒæ•´è¶…æ—¶å‚æ•°

**â­â­ é‡è¦å»ºè®®**ï¼š
5. **å®šæœŸæ¼”ç»ƒ**ï¼šæ¨¡æ‹Ÿæ•…éšœåœºæ™¯éªŒè¯æ¢å¤èƒ½åŠ›
6. **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•æ‰€æœ‰é…ç½®å˜æ›´å’Œæ“ä½œæµç¨‹
7. **ç‰ˆæœ¬ç®¡ç†**ï¼šä¿æŒKafkaç‰ˆæœ¬ç¨³å®šæ›´æ–°

**âœ… å¥åº·æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ControllerçŠ¶æ€æ­£å¸¸
- [ ] ISRåˆ—è¡¨ç¨³å®š
- [ ] é€‰ä¸¾é¢‘ç‡æ­£å¸¸
- [ ] ç½‘ç»œè¿æ¥ç¨³å®š
- [ ] ç›‘æ§å‘Šè­¦æœ‰æ•ˆ
- [ ] åº”æ€¥é¢„æ¡ˆå®Œå¤‡

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- Leaderé€‰ä¸¾æ˜¯é«˜å¯ç”¨çš„åŸºç¡€ï¼Œç¨³å®šæ€§è‡³å…³é‡è¦
- ç½‘ç»œå’ŒZooKeeperæ˜¯é€‰ä¸¾çš„å…³é”®ä¾èµ–ï¼Œéœ€é‡ç‚¹å…³æ³¨
- ç›‘æ§å‘Šè­¦è¦å…¨é¢ï¼ŒåŠæ—¶å‘ç°é—®é¢˜æ¯”å¿«é€Ÿè§£å†³æ›´é‡è¦
- é…ç½®è°ƒä¼˜è¦è°¨æ…ï¼Œå……åˆ†æµ‹è¯•åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ