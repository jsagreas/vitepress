---
title: 16ã€ç”Ÿäº§è€…é—®é¢˜æ’æŸ¥
---
## ğŸ“š ç›®å½•

1. [ç”Ÿäº§è€…åŸºç¡€é—®é¢˜æ’æŸ¥](#1-ç”Ÿäº§è€…åŸºç¡€é—®é¢˜æ’æŸ¥)
2. [æ¶ˆæ¯å‘é€å¤±è´¥é—®é¢˜](#2-æ¶ˆæ¯å‘é€å¤±è´¥é—®é¢˜)
3. [æ€§èƒ½ç›¸å…³é—®é¢˜](#3-æ€§èƒ½ç›¸å…³é—®é¢˜)
4. [å†…å­˜ä¸èµ„æºé—®é¢˜](#4-å†…å­˜ä¸èµ„æºé—®é¢˜)
5. [é…ç½®ä¸ç›‘æ§é—®é¢˜](#5-é…ç½®ä¸ç›‘æ§é—®é¢˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç”Ÿäº§è€…åŸºç¡€é—®é¢˜æ’æŸ¥


### 1.1 ä»€ä¹ˆæ˜¯Kafkaç”Ÿäº§è€…é—®é¢˜


**ç®€å•ç†è§£**ï¼šå°±åƒå¯„å¿«é€’ä¸€æ ·ï¼Œç”Ÿäº§è€…æ˜¯"å¯„ä»¶äºº"ï¼Œå½“å¿«é€’å¯„ä¸å‡ºå»æˆ–è€…å‡ºç°å„ç§é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åŸå› å¹¶è§£å†³ã€‚

```
ç”Ÿäº§è€…å·¥ä½œæµç¨‹ï¼š
åº”ç”¨ç¨‹åº â†’ Kafkaç”Ÿäº§è€… â†’ ç½‘ç»œä¼ è¾“ â†’ Kafkaé›†ç¾¤
    â†“           â†“           â†“           â†“
  æ•°æ®å‡†å¤‡    æ¶ˆæ¯å°è£…     å‘é€æ¶ˆæ¯     å­˜å‚¨ç¡®è®¤

å¸¸è§é—®é¢˜ç‚¹ï¼š
â€¢ æ•°æ®åºåˆ—åŒ–å¤±è´¥
â€¢ ç½‘ç»œè¿æ¥ä¸­æ–­  
â€¢ é›†ç¾¤ä¸å¯ç”¨
â€¢ é…ç½®å‚æ•°é”™è¯¯
```

**ğŸ”¸ ç”Ÿäº§è€…é—®é¢˜çš„å½±å“**
- **æ•°æ®ä¸¢å¤±**ï¼šæ¶ˆæ¯å‘é€å¤±è´¥å¯¼è‡´ä¸šåŠ¡æ•°æ®ä¸¢å¤±
- **æ€§èƒ½ä¸‹é™**ï¼šå‘é€æ•ˆç‡ä½å½±å“æ•´ä½“ç³»ç»Ÿæ€§èƒ½
- **èµ„æºæµªè´¹**ï¼šå†…å­˜æ³„æ¼æˆ–è¿æ¥æ± è€—å°½
- **ä¸šåŠ¡ä¸­æ–­**ï¼šä¸¥é‡æ•…éšœå¯¼è‡´ä¸šåŠ¡æ— æ³•æ­£å¸¸è¿è¡Œ

### 1.2 é—®é¢˜æ’æŸ¥çš„åŸºæœ¬æ€è·¯


**ğŸ“‹ æ’æŸ¥æ­¥éª¤**
```
ç¬¬ä¸€æ­¥ï¼šç¡®è®¤é—®é¢˜ç°è±¡
â€¢ æ˜¯å®Œå…¨æ— æ³•å‘é€ï¼Œè¿˜æ˜¯éƒ¨åˆ†å¤±è´¥ï¼Ÿ
â€¢ é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ ä»€ä¹ˆæ—¶å€™å¼€å§‹å‡ºç°é—®é¢˜ï¼Ÿ

ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥åŸºç¡€ç¯å¢ƒ
â€¢ ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ
â€¢ Kafkaé›†ç¾¤çŠ¶æ€å¦‚ä½•ï¼Ÿ
â€¢ å®¢æˆ·ç«¯ç‰ˆæœ¬æ˜¯å¦å…¼å®¹ï¼Ÿ

ç¬¬ä¸‰æ­¥ï¼šåˆ†ææ—¥å¿—ä¿¡æ¯
â€¢ ç”Ÿäº§è€…å®¢æˆ·ç«¯æ—¥å¿—
â€¢ KafkaæœåŠ¡ç«¯æ—¥å¿—
â€¢ åº”ç”¨ç¨‹åºæ—¥å¿—

ç¬¬å››æ­¥ï¼šéªŒè¯é…ç½®å‚æ•°
â€¢ è¿æ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
â€¢ åºåˆ—åŒ–å™¨æ˜¯å¦åŒ¹é…ï¼Ÿ
â€¢ é‡è¯•å’Œè¶…æ—¶è®¾ç½®æ˜¯å¦åˆç†ï¼Ÿ
```

---

## 2. ğŸ“¤ æ¶ˆæ¯å‘é€å¤±è´¥é—®é¢˜


### 2.1 è¿æ¥å’Œç½‘ç»œé—®é¢˜


**ğŸŒ ç½‘ç»œè¿æ¥å¼‚å¸¸**

```java
// å¸¸è§é”™è¯¯ç¤ºä¾‹
Exception in thread "main" org.apache.kafka.common.errors.TimeoutException: 
    Failed to update metadata after 60000 ms.
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ‰“ç”µè¯æ—¶ä¿¡å·ä¸å¥½ï¼Œç”Ÿäº§è€…è”ç³»ä¸ä¸ŠKafkaæœåŠ¡å™¨ã€‚

**æ’æŸ¥æ–¹æ³•**ï¼š
```bash
# 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping kafka-server-ip

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾  
telnet kafka-server-ip 9092

# 3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status

# 4. æŸ¥çœ‹ç½‘ç»œå»¶è¿Ÿ
ping -c 10 kafka-server-ip
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
Properties props = new Properties();
props.put("bootstrap.servers", "192.168.1.100:9092,192.168.1.101:9092"); 
// é…ç½®å¤šä¸ªbrokeråœ°å€ï¼Œæé«˜å¯ç”¨æ€§

props.put("request.timeout.ms", 30000);     // è¯·æ±‚è¶…æ—¶æ—¶é—´
props.put("delivery.timeout.ms", 120000);   // å‘é€è¶…æ—¶æ—¶é—´
props.put("max.block.ms", 60000);          // æœ€å¤§é˜»å¡æ—¶é—´
```

### 2.2 åºåˆ—åŒ–å¼‚å¸¸é—®é¢˜


**ğŸ”§ åºåˆ—åŒ–å™¨é…ç½®é”™è¯¯**

**é—®é¢˜ç°è±¡**ï¼š
```
org.apache.kafka.common.errors.SerializationException: 
    Error serializing Avro message
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¯„åŒ…è£¹æ—¶åŒ…è£…æ–¹å¼ä¸å¯¹ï¼Œé‚®å±€æ— æ³•å¤„ç†ã€‚Kafkaéœ€è¦æŠŠä½ çš„æ•°æ®"æ‰“åŒ…"æˆç‰¹å®šæ ¼å¼æ‰èƒ½ä¼ è¾“ã€‚

**å¸¸è§åºåˆ—åŒ–å™¨å¯¹ç…§è¡¨**ï¼š

| æ•°æ®ç±»å‹ | **åºåˆ—åŒ–å™¨** | **ä½¿ç”¨åœºæ™¯** | **é…ç½®ç¤ºä¾‹** |
|---------|------------|------------|------------|
| å­—ç¬¦ä¸² | `StringSerializer` | ç®€å•æ–‡æœ¬æ¶ˆæ¯ | `props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer")` |
| æ•´æ•° | `IntegerSerializer` | æ•°å€¼æ•°æ® | `props.put("value.serializer", "org.apache.kafka.common.serialization.IntegerSerializer")` |
| JSON | `StringSerializer` | å¤æ‚å¯¹è±¡ | å…ˆè½¬JSONå­—ç¬¦ä¸²å†å‘é€ |
| Avro | `KafkaAvroSerializer` | æ¨¡å¼åŒ–æ•°æ® | éœ€è¦Schema Registry |

**è§£å†³ç¤ºä¾‹**ï¼š
```java
// æ­£ç¡®çš„åºåˆ—åŒ–å™¨é…ç½®
Properties props = new Properties();
props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");

// å‘é€JSONæ•°æ®çš„æ­£ç¡®æ–¹å¼
ObjectMapper mapper = new ObjectMapper();
String jsonValue = mapper.writeValueAsString(myObject);
ProducerRecord<String, String> record = 
    new ProducerRecord<>("my-topic", "key1", jsonValue);
```

### 2.3 åˆ†åŒºå™¨é€»è¾‘é”™è¯¯


**âš–ï¸ åˆ†åŒºåˆ†é…é—®é¢˜**

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¿«é€’åˆ†æ‹£ï¼Œå¦‚æœåˆ†æ‹£è§„åˆ™æœ‰é—®é¢˜ï¼ŒåŒ…è£¹å°±ä¼šé€åˆ°é”™è¯¯çš„åœ°æ–¹æˆ–è€…æ ¹æœ¬é€ä¸å‡ºå»ã€‚

**å¸¸è§åˆ†åŒºå™¨é—®é¢˜**ï¼š
```java
// é”™è¯¯ç¤ºä¾‹ï¼šè‡ªå®šä¹‰åˆ†åŒºå™¨é€»è¾‘æœ‰ç¼ºé™·
public class ProblematicPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes, 
                        Object value, byte[] valueBytes, Cluster cluster) {
        // å±é™©ï¼šå¯èƒ½è¿”å›è´Ÿæ•°æˆ–è¶…å‡ºåˆ†åŒºæ•°é‡
        return key.hashCode() % cluster.partitionCountForTopic(topic);
    }
}

// æ­£ç¡®ç¤ºä¾‹ï¼šå®‰å…¨çš„åˆ†åŒºå™¨å®ç°
public class SafePartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        int partitionCount = cluster.partitionCountForTopic(topic);
        if (key == null) {
            return Utils.toPositive(Utils.murmur2(valueBytes)) % partitionCount;
        }
        // ç¡®ä¿ç»“æœä¸ºæ­£æ•°
        return Utils.toPositive(Utils.murmur2(keyBytes)) % partitionCount;
    }
}
```

---

## 3. âš¡ æ€§èƒ½ç›¸å…³é—®é¢˜


### 3.1 æ‰¹å¤„ç†æ•ˆç‡ä½ä¸‹


**ğŸ“¦ æ‰¹å¤„ç†ä¼˜åŒ–**

**é—®é¢˜è¡¨ç°**ï¼šå‘é€æ¶ˆæ¯å¾ˆæ…¢ï¼Œååé‡ä½

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¯„å¿«é€’ï¼Œä¸€ä¸ªä¸ªå•ç‹¬å¯„è´¹æ—¶è´¹åŠ›ï¼Œæ‰“åŒ…ä¸€èµ·å¯„æ›´é«˜æ•ˆã€‚

```
æ‰¹å¤„ç†å·¥ä½œåŸç†ï¼š
æ¶ˆæ¯1 â†’ ]
æ¶ˆæ¯2 â†’ ] ç¼“å†²åŒº â†’ æ‰¹é‡å‘é€ â†’ Kafka
æ¶ˆæ¯3 â†’ ]

å¥½å¤„ï¼š
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
â€¢ æé«˜ååé‡
â€¢ é™ä½CPUä½¿ç”¨ç‡
```

**æ€§èƒ½è°ƒä¼˜é…ç½®**ï¼š
```java
Properties props = new Properties();

// æ‰¹å¤„ç†ç›¸å…³é…ç½®
props.put("batch.size", 16384);        // æ‰¹æ¬¡å¤§å°ï¼š16KB
props.put("linger.ms", 5);             // ç­‰å¾…æ—¶é—´ï¼š5æ¯«ç§’
props.put("buffer.memory", 33554432);   // ç¼“å†²åŒºå¤§å°ï¼š32MB
props.put("compression.type", "snappy"); // å‹ç¼©ç®—æ³•

// å¹¶å‘é…ç½®
props.put("max.in.flight.requests.per.connection", 5); // å¹¶å‘è¯·æ±‚æ•°
```

**æ‰¹å¤„ç†æ•ˆæœå¯¹æ¯”**ï¼š
```
è°ƒä¼˜å‰ï¼š
æ¯ç§’å‘é€: 1000æ¡æ¶ˆæ¯
ç½‘ç»œè¯·æ±‚: 1000æ¬¡
CPUä½¿ç”¨: è¾ƒé«˜

è°ƒä¼˜åï¼š  
æ¯ç§’å‘é€: 10000æ¡æ¶ˆæ¯
ç½‘ç»œè¯·æ±‚: 100æ¬¡  
CPUä½¿ç”¨: è¾ƒä½
```

### 3.2 ç”Ÿäº§è€…è¶…æ—¶å¼‚å¸¸


**â±ï¸ è¶…æ—¶é—®é¢˜è¯Šæ–­**

**å¸¸è§è¶…æ—¶é”™è¯¯**ï¼š
```
org.apache.kafka.common.errors.TimeoutException: 
    Expiring 1 record(s) for topic-1: 30036 ms has passed since batch creation
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒç­‰å…¬äº¤è½¦ï¼Œç­‰å¤ªä¹…äº†å°±æ”¾å¼ƒäº†ã€‚ç”Ÿäº§è€…ç­‰å¾…Kafkaå“åº”çš„æ—¶é—´è¶…è¿‡äº†è®¾å®šå€¼ã€‚

**è¶…æ—¶å‚æ•°è¯´æ˜**ï¼š
```
è¶…æ—¶å±‚æ¬¡ç»“æ„ï¼š
request.timeout.ms (30ç§’)
    â†“ å•æ¬¡è¯·æ±‚è¶…æ—¶
delivery.timeout.ms (120ç§’)  
    â†“ æ•´ä½“å‘é€è¶…æ—¶
max.block.ms (60ç§’)
    â†“ é˜»å¡ç­‰å¾…è¶…æ—¶

å…³ç³»ï¼šdelivery.timeout.ms â‰¥ linger.ms + request.timeout.ms
```

**è¶…æ—¶é—®é¢˜è§£å†³æ–¹æ¡ˆ**ï¼š
```java
// æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´è¶…æ—¶è®¾ç½®
Properties props = new Properties();

// ç½‘ç»œç¯å¢ƒè¾ƒå·®æ—¶çš„é…ç½®
props.put("request.timeout.ms", 60000);     // è¯·æ±‚è¶…æ—¶ï¼š60ç§’
props.put("delivery.timeout.ms", 300000);   // å‘é€è¶…æ—¶ï¼š5åˆ†é’Ÿ  
props.put("max.block.ms", 120000);          // é˜»å¡è¶…æ—¶ï¼š2åˆ†é’Ÿ

// é‡è¯•é…ç½®
props.put("retries", 5);                    // é‡è¯•æ¬¡æ•°
props.put("retry.backoff.ms", 1000);        // é‡è¯•é—´éš”ï¼š1ç§’
```

### 3.3 å¹‚ç­‰æ€§é…ç½®é—®é¢˜


**ğŸ”’ æ¶ˆæ¯é‡å¤å‘é€**

**é—®é¢˜ç°è±¡**ï¼šåŒä¸€æ¡æ¶ˆæ¯è¢«å‘é€å¤šæ¬¡

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå‘å¾®ä¿¡æ—¶ç½‘ç»œä¸å¥½ï¼ŒåŒä¸€æ¡æ¶ˆæ¯å‘äº†å¥½å‡ éã€‚å¹‚ç­‰æ€§å°±æ˜¯ç¡®ä¿å³ä½¿å‘å¤šæ¬¡ï¼Œä¹Ÿåªä¼šæ”¶åˆ°ä¸€æ¡ã€‚

**å¹‚ç­‰æ€§å·¥ä½œåŸç†**ï¼š
```
æ²¡æœ‰å¹‚ç­‰æ€§ï¼š
æ¶ˆæ¯A â†’ å‘é€ â†’ ç½‘ç»œå¼‚å¸¸ â†’ é‡è¯•å‘é€ â†’ äº§ç”Ÿé‡å¤

æœ‰å¹‚ç­‰æ€§ï¼š
æ¶ˆæ¯A â†’ å‘é€(åºå·1) â†’ ç½‘ç»œå¼‚å¸¸ â†’ é‡è¯•å‘é€(åºå·1) â†’ æœåŠ¡ç«¯å»é‡
```

**å¹‚ç­‰æ€§é…ç½®**ï¼š
```java
Properties props = new Properties();
props.put("enable.idempotence", true);       // å¼€å¯å¹‚ç­‰æ€§
props.put("acks", "all");                    // å¿…é¡»è®¾ç½®ä¸ºall
props.put("retries", Integer.MAX_VALUE);     // é‡è¯•æ¬¡æ•°
props.put("max.in.flight.requests.per.connection", 5); // å¹¶å‘æ•°â‰¤5
```

---

## 4. ğŸ’¾ å†…å­˜ä¸èµ„æºé—®é¢˜


### 4.1 ç¼“å†²åŒºæ»¡å¯¼è‡´é˜»å¡


**ğŸš° å†…å­˜ç¼“å†²åŒºæº¢å‡º**

**é—®é¢˜è¡¨ç°**ï¼šç¨‹åºå¡ä½ä¸åŠ¨ï¼Œå‘é€æ¶ˆæ¯é˜»å¡

**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ°´æ± çš„æ’æ°´ç®¡å¤ªç»†ï¼Œæ°´å€’å¾—å¤ªå¿«æ—¶ä¼šæº¢å‡ºã€‚ç”Ÿäº§è€…çš„ç¼“å†²åŒºæ»¡äº†ï¼Œæ–°æ¶ˆæ¯è¿›ä¸æ¥ã€‚

```
ç¼“å†²åŒºå·¥ä½œæµç¨‹ï¼š
åº”ç”¨æ•°æ® â†’ ç¼“å†²åŒº â†’ æ‰¹å¤„ç† â†’ ç½‘ç»œå‘é€
              â†‘
            æ»¡äº†å°±é˜»å¡

ç¼“å†²åŒºå¤§å°è®¡ç®—ï¼š
buffer.memory = å¹³å‡æ¶ˆæ¯å¤§å° Ã— ç¼“å­˜æ¶ˆæ¯æ•°é‡
```

**å†…å­˜é—®é¢˜æ’æŸ¥**ï¼š
```bash
# æŸ¥çœ‹JVMå†…å­˜ä½¿ç”¨æƒ…å†µ
jstat -gc <pid> 1s

# æŸ¥çœ‹ç”Ÿäº§è€…æŒ‡æ ‡
# å…³æ³¨ï¼šbuffer-available-bytes, buffer-exhausted-rate
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
Properties props = new Properties();

// è°ƒæ•´ç¼“å†²åŒºå¤§å°
props.put("buffer.memory", 67108864);      // å¢åŠ åˆ°64MB
props.put("max.block.ms", 5000);           // å‡å°‘é˜»å¡æ—¶é—´

// å½“ç¼“å†²åŒºæ»¡æ—¶çš„å¤„ç†ç­–ç•¥
props.put("block.on.buffer.full", false);  // ä¸é˜»å¡ï¼Œç›´æ¥æŠ›å¼‚å¸¸

// åŠ å¿«æ¶ˆæ¯å‘é€
props.put("linger.ms", 1);                 // å‡å°‘ç­‰å¾…æ—¶é—´
props.put("batch.size", 32768);            // å¢åŠ æ‰¹æ¬¡å¤§å°
```

### 4.2 è¿æ¥æ± è€—å°½


**ğŸ”Œ è¿æ¥èµ„æºç®¡ç†**

**é—®é¢˜ç°è±¡**ï¼šæ— æ³•åˆ›å»ºæ–°çš„è¿æ¥ï¼Œå‡ºç°è¿æ¥è¶…æ—¶

**é€šä¿—è§£é‡Š**ï¼šå°±åƒé¤å…çš„æ¡Œå­éƒ½æ»¡äº†ï¼Œæ–°å®¢äººè¿›ä¸æ¥ã€‚ç³»ç»Ÿçš„è¿æ¥æ•°ç”¨å®Œäº†ï¼Œæ–°çš„è¯·æ±‚æ— æ³•å¤„ç†ã€‚

**è¿æ¥æ± ç›‘æ§**ï¼š
```java
// è¿æ¥çŠ¶æ€æ£€æŸ¥
Map<MetricName, ? extends Metric> metrics = producer.metrics();
metrics.entrySet().forEach(entry -> {
    if (entry.getKey().name().contains("connection")) {
        System.out.println(entry.getKey().name() + ": " + entry.getValue().metricValue());
    }
});
```

**è¿æ¥æ± ä¼˜åŒ–**ï¼š
```java
Properties props = new Properties();
props.put("connections.max.idle.ms", 540000);    // è¿æ¥ç©ºé—²æ—¶é—´ï¼š9åˆ†é’Ÿ
props.put("reconnect.backoff.ms", 50);           // é‡è¿é—´éš”ï¼š50æ¯«ç§’
props.put("reconnect.backoff.max.ms", 1000);     // æœ€å¤§é‡è¿é—´éš”ï¼š1ç§’

// åˆç†å¤ç”¨ç”Ÿäº§è€…å®ä¾‹
// é”™è¯¯åšæ³•ï¼šæ¯æ¬¡å‘é€éƒ½åˆ›å»ºæ–°çš„Producer
// æ­£ç¡®åšæ³•ï¼šåº”ç”¨çº§åˆ«å…±äº«ä¸€ä¸ªProducerå®ä¾‹
```

### 4.3 ç”Ÿäº§è€…å†…å­˜æ³„æ¼


**ğŸ” å†…å­˜æ³„æ¼æ£€æµ‹**

**é—®é¢˜è¡¨ç°**ï¼šåº”ç”¨è¿è¡Œæ—¶é—´é•¿äº†ï¼Œå†…å­˜ä½¿ç”¨è¶Šæ¥è¶Šå¤šï¼Œæœ€ç»ˆOutOfMemoryError

**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ°´é¾™å¤´å…³ä¸ä¸¥ï¼Œä¸€ç›´åœ¨æ»´æ°´ï¼Œæ—¶é—´é•¿äº†æ°´ç¼¸å°±æ»¡äº†ã€‚ç¨‹åºä¸­çš„å¯¹è±¡æ²¡æœ‰æ­£ç¡®å›æ”¶ï¼Œè¶Šç§¯è¶Šå¤šã€‚

**å†…å­˜æ³„æ¼æ’æŸ¥å·¥å…·**ï¼š
```bash
# ç”Ÿæˆå†…å­˜å¿«ç…§
jmap -dump:format=b,file=heap.hprof <pid>

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨topå¯¹è±¡
jmap -histo <pid> | head -20

# ç›‘æ§GCæƒ…å†µ
jstat -gc <pid> 1s 10
```

**æ­£ç¡®çš„ç”Ÿäº§è€…ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š
```java
public class KafkaProducerManager {
    private KafkaProducer<String, String> producer;
    
    // å•ä¾‹æ¨¡å¼ï¼Œé¿å…åˆ›å»ºå¤šä¸ªå®ä¾‹
    public synchronized KafkaProducer<String, String> getProducer() {
        if (producer == null) {
            Properties props = new Properties();
            // ... é…ç½®å‚æ•°
            producer = new KafkaProducer<>(props);
        }
        return producer;
    }
    
    // åº”ç”¨å…³é—­æ—¶æ­£ç¡®æ¸…ç†èµ„æº
    public void shutdown() {
        if (producer != null) {
            producer.flush();    // ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯å‘é€å®Œæˆ
            producer.close();    // å…³é—­ç”Ÿäº§è€…ï¼Œé‡Šæ”¾èµ„æº
        }
    }
}

// Spring Bootä¸­çš„æ­£ç¡®é…ç½®
@Configuration
public class KafkaConfig {
    @Bean
    @PreDestroy
    public void cleanup() {
        // åº”ç”¨å…³é—­æ—¶è‡ªåŠ¨æ¸…ç†èµ„æº
    }
}
```

---

## 5. ğŸ“Š é…ç½®ä¸ç›‘æ§é—®é¢˜


### 5.1 äº‹åŠ¡æäº¤å¤±è´¥


**ğŸ’³ äº‹åŠ¡æœºåˆ¶é—®é¢˜**

**é€šä¿—è§£é‡Š**ï¼šå°±åƒé“¶è¡Œè½¬è´¦ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚Kafkaäº‹åŠ¡ç¡®ä¿ä¸€æ‰¹æ¶ˆæ¯è¦ä¹ˆå…¨éƒ¨å‘é€æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚

**äº‹åŠ¡é…ç½®è¦æ±‚**ï¼š
```java
Properties props = new Properties();
props.put("transactional.id", "my-transaction-id");  // å¿…é¡»è®¾ç½®äº‹åŠ¡ID
props.put("enable.idempotence", true);               // å¿…é¡»å¼€å¯å¹‚ç­‰æ€§
props.put("acks", "all");                           // å¿…é¡»ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
props.put("retries", Integer.MAX_VALUE);            // è®¾ç½®é‡è¯•æ¬¡æ•°
```

**äº‹åŠ¡ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
KafkaProducer<String, String> producer = new KafkaProducer<>(props);

// åˆå§‹åŒ–äº‹åŠ¡
producer.initTransactions();

try {
    // å¼€å§‹äº‹åŠ¡
    producer.beginTransaction();
    
    // å‘é€æ¶ˆæ¯
    producer.send(new ProducerRecord<>("topic1", "key1", "value1"));
    producer.send(new ProducerRecord<>("topic2", "key2", "value2"));
    
    // æäº¤äº‹åŠ¡
    producer.commitTransaction();
    
} catch (Exception e) {
    // å›æ»šäº‹åŠ¡
    producer.abortTransaction();
    e.printStackTrace();
}
```

**äº‹åŠ¡å¤±è´¥å¸¸è§åŸå› **ï¼š
```
å¸¸è§é”™è¯¯ï¼š
1. æ²¡æœ‰è®¾ç½®transactional.id
2. äº‹åŠ¡è¶…æ—¶ï¼ˆtransaction.timeout.msï¼‰
3. ç½‘ç»œåˆ†åŒºå¯¼è‡´åè°ƒå™¨ä¸å¯ç”¨
4. ç”Ÿäº§è€…å®ä¾‹è¢«é‡æ–°åˆ›å»º

è§£å†³æ–¹æ³•ï¼š
â€¢ æ£€æŸ¥äº‹åŠ¡é…ç½®æ˜¯å¦å®Œæ•´
â€¢ å¢åŠ äº‹åŠ¡è¶…æ—¶æ—¶é—´
â€¢ ç¡®ä¿ç½‘ç»œç¨³å®šæ€§
â€¢ æ­£ç¡®ç®¡ç†ç”Ÿäº§è€…ç”Ÿå‘½å‘¨æœŸ
```

### 5.2 ç›‘æ§æŒ‡æ ‡ä¸å‡†ç¡®


**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡è§£è¯»**

**å…³é”®æŒ‡æ ‡è¯´æ˜**ï¼š

| æŒ‡æ ‡åç§° | **å«ä¹‰** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸å¤„ç†** |
|---------|---------|------------|------------|
| `record-send-rate` | æ¯ç§’å‘é€æ¶ˆæ¯æ•° | æ ¹æ®ä¸šåŠ¡éœ€æ±‚ | è¿‡ä½æ£€æŸ¥æ€§èƒ½é…ç½® |
| `record-error-rate` | é”™è¯¯ç‡ | < 1% | è¶…è¿‡1%éœ€è¦æ’æŸ¥ |
| `buffer-available-bytes` | å¯ç”¨ç¼“å†²åŒº | > 50% | è¿‡ä½éœ€è¦è°ƒæ•´é…ç½® |
| `request-latency-avg` | å¹³å‡å»¶è¿Ÿ | < 100ms | è¿‡é«˜æ£€æŸ¥ç½‘ç»œå’Œé…ç½® |

**ç›‘æ§ä»£ç ç¤ºä¾‹**ï¼š
```java
// è·å–ç”Ÿäº§è€…ç›‘æ§æŒ‡æ ‡
Map<MetricName, ? extends Metric> metrics = producer.metrics();

// å…³é”®æŒ‡æ ‡ç›‘æ§
double sendRate = (Double) metrics.get(
    new MetricName("record-send-rate", "producer-metrics", "", new HashMap<>())
).metricValue();

double errorRate = (Double) metrics.get(
    new MetricName("record-error-rate", "producer-metrics", "", new HashMap<>())
).metricValue();

System.out.println("å‘é€é€Ÿç‡: " + sendRate + " æ¡/ç§’");
System.out.println("é”™è¯¯ç‡: " + errorRate * 100 + "%");
```

### 5.3 é‡è¯•æœºåˆ¶å¤±æ•ˆ


**ğŸ”„ é‡è¯•ç­–ç•¥é…ç½®**

**é‡è¯•æœºåˆ¶å·¥ä½œåŸç†**ï¼š
```
æ¶ˆæ¯å‘é€æµç¨‹ï¼š
å‘é€æ¶ˆæ¯ â†’ å¤±è´¥ â†’ ç­‰å¾… â†’ é‡è¯• â†’ æˆåŠŸ/æœ€ç»ˆå¤±è´¥

é‡è¯•å†³ç­–ï¼š
â€¢ ç½‘ç»œé”™è¯¯ï¼šå¯é‡è¯•
â€¢ åºåˆ—åŒ–é”™è¯¯ï¼šä¸å¯é‡è¯•  
â€¢ æƒé™é”™è¯¯ï¼šä¸å¯é‡è¯•
â€¢ åˆ†åŒºä¸å­˜åœ¨ï¼šä¸å¯é‡è¯•
```

**æ™ºèƒ½é‡è¯•é…ç½®**ï¼š
```java
Properties props = new Properties();

// åŸºç¡€é‡è¯•é…ç½®
props.put("retries", 10);                    // é‡è¯•æ¬¡æ•°
props.put("retry.backoff.ms", 1000);         // é‡è¯•é—´éš”
props.put("delivery.timeout.ms", 300000);    // æ€»è¶…æ—¶æ—¶é—´

// å¯é‡è¯•å¼‚å¸¸é…ç½®ï¼ˆè‡ªå®šä¹‰ï¼‰
props.put("retry.backoff.max.ms", 32000);    // æœ€å¤§é‡è¯•é—´éš”

// æŒ‡æ•°é€€é¿é‡è¯•ç¤ºä¾‹
public class ExponentialBackoffRetry {
    public void sendWithRetry(ProducerRecord<String, String> record) {
        int attempt = 0;
        int maxRetries = 5;
        
        while (attempt < maxRetries) {
            try {
                producer.send(record).get();
                return; // æˆåŠŸå‘é€ï¼Œé€€å‡º
            } catch (Exception e) {
                attempt++;
                if (attempt >= maxRetries) {
                    throw new RuntimeException("è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°", e);
                }
                
                // æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s, 16s
                long delay = 1000L * (1L << (attempt - 1));
                Thread.sleep(delay);
            }
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ’æŸ¥æ€è·¯


```
ğŸ”¸ ç”Ÿäº§è€…é—®é¢˜åˆ†ç±»ï¼š
â€¢ è¿æ¥é—®é¢˜ï¼šç½‘ç»œã€é˜²ç«å¢™ã€DNS
â€¢ é…ç½®é—®é¢˜ï¼šåºåˆ—åŒ–å™¨ã€åˆ†åŒºå™¨ã€è¶…æ—¶è®¾ç½®
â€¢ æ€§èƒ½é—®é¢˜ï¼šæ‰¹å¤„ç†ã€ç¼“å†²åŒºã€å‹ç¼©
â€¢ èµ„æºé—®é¢˜ï¼šå†…å­˜æ³„æ¼ã€è¿æ¥æ± ã€çº¿ç¨‹
â€¢ ä¸šåŠ¡é—®é¢˜ï¼šäº‹åŠ¡ã€å¹‚ç­‰æ€§ã€é‡è¯•
```

### 6.2 å…³é”®æ’æŸ¥å·¥å…·


**ğŸ”§ è¯Šæ–­å·¥å…·ç®±**ï¼š
```bash
# ç½‘ç»œè¿é€šæ€§
ping, telnet, netstat

# JVMè¯Šæ–­  
jstat, jmap, jstack, jvisualvm

# Kafkaå·¥å…·
kafka-topics.sh, kafka-console-producer.sh

# ç›‘æ§æŒ‡æ ‡
producer.metrics(), JMXç›‘æ§
```

### 6.3 æœ€ä½³å®è·µå»ºè®®


**âš¡ ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š
```
é…ç½®ä¼˜åŒ–ï¼š
â€¢ å¼€å¯å¹‚ç­‰æ€§å’Œäº‹åŠ¡ï¼ˆå¯é æ€§è¦æ±‚é«˜ï¼‰
â€¢ åˆç†è®¾ç½®æ‰¹å¤„ç†å‚æ•°
â€¢ é…ç½®é€‚å½“çš„è¶…æ—¶å’Œé‡è¯•
â€¢ å¯ç”¨å‹ç¼©ç®—æ³•

ç›‘æ§å‘Šè­¦ï¼š
â€¢ ç›‘æ§å‘é€é€Ÿç‡å’Œé”™è¯¯ç‡
â€¢ è®¾ç½®ç¼“å†²åŒºä½¿ç”¨ç‡å‘Šè­¦
â€¢ ç›‘æ§ç½‘ç»œå»¶è¿Ÿå’Œå¯ç”¨æ€§
â€¢ å»ºç«‹æ—¥å¿—èšåˆå’Œåˆ†æ

è¿ç»´è§„èŒƒï¼š
â€¢ ç»Ÿä¸€é…ç½®ç®¡ç†
â€¢ å®šæœŸæ€§èƒ½æµ‹è¯•
â€¢ åˆ¶å®šæ•…éšœé¢„æ¡ˆ
â€¢ å»ºç«‹çŸ¥è¯†åº“
```

### 6.4 å¸¸è§é”™è¯¯é¿å…


**âŒ æ–°æ‰‹å¸¸çŠ¯é”™è¯¯**ï¼š
```
â€¢ æ¯æ¬¡å‘é€éƒ½åˆ›å»ºæ–°çš„Producerå®ä¾‹
â€¢ å¿˜è®°è°ƒç”¨producer.close()é‡Šæ”¾èµ„æº
â€¢ åºåˆ—åŒ–å™¨é…ç½®ä¸åŒ¹é…
â€¢ è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­
â€¢ æ²¡æœ‰å¤„ç†å‘é€å¼‚å¸¸
â€¢ å¿½ç•¥ç›‘æ§æŒ‡æ ‡åˆ†æ
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```
â€¢ åº”ç”¨çº§åˆ«å…±äº«Producerå®ä¾‹
â€¢ å®ç°ä¼˜é›…å…³é—­æœºåˆ¶
â€¢ æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–å™¨
â€¢ æ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´è¶…æ—¶å‚æ•°
â€¢ å®ç°å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
â€¢ å»ºç«‹å®Œæ•´çš„ç›‘æ§ä½“ç³»
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç½‘ç»œè¿æ¥æ˜¯åŸºç¡€ï¼Œé…ç½®å‚æ•°è¦åˆé€‚
- åºåˆ—åŒ–å™¨è¦åŒ¹é…ï¼Œè¶…æ—¶é‡è¯•è®¾åˆç†
- å†…å­˜èµ„æºè¦ç®¡å¥½ï¼Œç›‘æ§æŒ‡æ ‡å¸¸æŸ¥çœ‹
- äº‹åŠ¡å¹‚ç­‰ä¿å¯é ï¼Œå¼‚å¸¸å¤„ç†ä¸èƒ½å°‘