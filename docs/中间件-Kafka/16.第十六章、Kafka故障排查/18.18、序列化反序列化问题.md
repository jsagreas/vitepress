---
title: 18ã€åºåˆ—åŒ–ååºåˆ—åŒ–é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [åºåˆ—åŒ–ååºåˆ—åŒ–åŸºç¡€æ¦‚å¿µ](#1-åºåˆ—åŒ–ååºåˆ—åŒ–åŸºç¡€æ¦‚å¿µ)
2. [å¸¸è§åºåˆ—åŒ–æ ¼å¼é—®é¢˜](#2-å¸¸è§åºåˆ—åŒ–æ ¼å¼é—®é¢˜)
3. [Schemaç‰ˆæœ¬ç®¡ç†é—®é¢˜](#3-Schemaç‰ˆæœ¬ç®¡ç†é—®é¢˜)
4. [æ€§èƒ½ç›¸å…³é—®é¢˜](#4-æ€§èƒ½ç›¸å…³é—®é¢˜)
5. [è‡ªå®šä¹‰åºåˆ—åŒ–å™¨é—®é¢˜](#5-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨é—®é¢˜)
6. [æ•°æ®æ ¼å¼å˜æ›´é—®é¢˜](#6-æ•°æ®æ ¼å¼å˜æ›´é—®é¢˜)
7. [ç¼–ç å’Œå­—ç¬¦é›†é—®é¢˜](#7-ç¼–ç å’Œå­—ç¬¦é›†é—®é¢˜)
8. [ä¾èµ–å’Œç‰ˆæœ¬å†²çª](#8-ä¾èµ–å’Œç‰ˆæœ¬å†²çª)
9. [ç›‘æ§å’Œæ’æŸ¥å·¥å…·](#9-ç›‘æ§å’Œæ’æŸ¥å·¥å…·)
10. [æœ€ä½³å®è·µæ€»ç»“](#10-æœ€ä½³å®è·µæ€»ç»“)

---

## 1. ğŸ”§ åºåˆ—åŒ–ååºåˆ—åŒ–åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ è¦æŠŠä¸€æœ¬ä¹¦å¯„ç»™æœ‹å‹

```
åºåˆ—åŒ– = æŠŠä¹¦æ‹†è§£æˆå¯ä»¥ä¼ è¾“çš„æ ¼å¼
åŸå§‹æ•°æ®(ä¹¦) â†’ å­—èŠ‚æµ(åŒ…è£¹) â†’ ç½‘ç»œä¼ è¾“

ååºåˆ—åŒ– = æœ‹å‹æ”¶åˆ°åé‡æ–°ç»„è£…æˆä¹¦
å­—èŠ‚æµ(åŒ…è£¹) â†’ è§£æé‡ç»„ â†’ åŸå§‹æ•°æ®(ä¹¦)
```

**ğŸ“‹ åœ¨Kafkaä¸­çš„ä½œç”¨**ï¼š
- **ç”Ÿäº§è€…ç«¯**ï¼šå°†Javaå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„å‘é€åˆ°Kafka
- **æ¶ˆè´¹è€…ç«¯**ï¼šå°†ä»Kafkaæ¥æ”¶çš„å­—èŠ‚æ•°ç»„è¿˜åŸä¸ºJavaå¯¹è±¡
- **å­˜å‚¨å±‚é¢**ï¼šKafkaå†…éƒ¨åªå­˜å‚¨å­—èŠ‚æ•°ç»„ï¼Œä¸å…³å¿ƒå…·ä½“æ•°æ®ç±»å‹

### 1.2 åºåˆ—åŒ–æµç¨‹å›¾ç¤º


```
ç”Ÿäº§è€…ä¾§ï¼š
Javaå¯¹è±¡ â†’ [åºåˆ—åŒ–å™¨] â†’ å­—èŠ‚æ•°ç»„ â†’ Kafka Topic

æ¶ˆè´¹è€…ä¾§ï¼š  
Kafka Topic â†’ å­—èŠ‚æ•°ç»„ â†’ [ååºåˆ—åŒ–å™¨] â†’ Javaå¯¹è±¡
```

### 1.3 Kafkaå†…ç½®åºåˆ—åŒ–å™¨ç±»å‹


| åºåˆ—åŒ–å™¨ç±»å‹ | **ç”¨é€”è¯´æ˜** | **é€‚ç”¨åœºæ™¯** | **æ³¨æ„äº‹é¡¹** |
|-------------|-------------|-------------|-------------|
| `StringSerializer` | å­—ç¬¦ä¸²ç±»å‹ | ç®€å•æ–‡æœ¬æ¶ˆæ¯ | éœ€è¦æŒ‡å®šå­—ç¬¦ç¼–ç  |
| `IntegerSerializer` | æ•´æ•°ç±»å‹ | æ•°å€¼å‹æ•°æ® | å›ºå®š4å­—èŠ‚é•¿åº¦ |
| `LongSerializer` | é•¿æ•´å‹ | æ—¶é—´æˆ³ã€IDç­‰ | å›ºå®š8å­—èŠ‚é•¿åº¦ |
| `ByteArraySerializer` | å­—èŠ‚æ•°ç»„ | äºŒè¿›åˆ¶æ•°æ® | åŸå§‹å­—èŠ‚ä¼ è¾“ |
| `JsonSerializer` | JSONæ ¼å¼ | å¤æ‚å¯¹è±¡ | éœ€è¦é¢å¤–ä¾èµ– |

---

## 2. ğŸš¨ å¸¸è§åºåˆ—åŒ–æ ¼å¼é—®é¢˜


### 2.1 åºåˆ—åŒ–æ ¼å¼ä¸å…¼å®¹é—®é¢˜


**é—®é¢˜ç°è±¡**ï¼š
```
âŒ æŠ¥é”™ä¿¡æ¯ï¼š
org.apache.kafka.common.errors.SerializationException: 
Can't convert value of class java.lang.String to class java.lang.Integer
```

**é—®é¢˜åŸå› åˆ†æ**ï¼š
- ç”Ÿäº§è€…ä½¿ç”¨`StringSerializer`å‘é€æ•°æ®
- æ¶ˆè´¹è€…å´ä½¿ç”¨`IntegerDeserializer`æ¥æ”¶æ•°æ®
- **æ ¼å¼ä¸åŒ¹é…**å¯¼è‡´ååºåˆ—åŒ–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… æ­£ç¡®é…ç½® - ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¿æŒä¸€è‡´
// ç”Ÿäº§è€…é…ç½®
props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, 
          "org.apache.kafka.common.serialization.StringSerializer");
props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, 
          "org.apache.kafka.common.serialization.StringSerializer");

// æ¶ˆè´¹è€…é…ç½® - å¿…é¡»ä¸ç”Ÿäº§è€…å¯¹åº”
props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, 
          "org.apache.kafka.common.serialization.StringDeserializer");
props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, 
          "org.apache.kafka.common.serialization.StringDeserializer");
```

### 2.2 æ··åˆæ•°æ®ç±»å‹å¤„ç†


**å®é™…åœºæ™¯**ï¼šåŒä¸€ä¸ªTopicä¸­å­˜åœ¨å¤šç§æ•°æ®æ ¼å¼

```
æ’æŸ¥æ­¥éª¤ï¼š
1ï¸âƒ£ æ£€æŸ¥Topicä¸­çš„å†å²æ•°æ®æ ¼å¼
2ï¸âƒ£ ç¡®è®¤æ‰€æœ‰ç”Ÿäº§è€…çš„åºåˆ—åŒ–é…ç½®
3ï¸âƒ£ ç»Ÿä¸€åºåˆ—åŒ–æ ¼å¼æˆ–ä½¿ç”¨é€šç”¨æ ¼å¼
```

**ğŸ“‹ é€šç”¨è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// ä½¿ç”¨ByteArrayä½œä¸ºé€šç”¨æ ¼å¼
public class UniversalSerializer implements Serializer<Object> {
    @Override
    public byte[] serialize(String topic, Object data) {
        if (data instanceof String) {
            return ((String) data).getBytes(StandardCharsets.UTF_8);
        } else if (data instanceof Integer) {
            return ByteBuffer.allocate(4).putInt((Integer) data).array();
        }
        // æ·»åŠ å…¶ä»–ç±»å‹å¤„ç†
        throw new SerializationException("ä¸æ”¯æŒçš„æ•°æ®ç±»å‹: " + data.getClass());
    }
}
```

---

## 3. ğŸ“ Schemaç‰ˆæœ¬ç®¡ç†é—®é¢˜


### 3.1 Schemaç‰ˆæœ¬å†²çªè¯¦è§£


**ä»€ä¹ˆæ˜¯Schemaå†²çª**ï¼š
æƒ³è±¡ä½ å’Œæœ‹å‹çº¦å®šç”¨æš—å·äº¤æµï¼Œä½†ä½ ä»¬çš„"æš—å·æœ¬"ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œå°±ä¼šäº§ç”Ÿç†è§£é”™è¯¯ã€‚

**å¸¸è§å†²çªåœºæ™¯**ï¼š

```
åœºæ™¯1ï¼šå­—æ®µåˆ é™¤å†²çª
æ—§ç‰ˆæœ¬Schema: {name: String, age: Int, email: String}
æ–°ç‰ˆæœ¬Schema: {name: String, age: Int}  // åˆ é™¤äº†emailå­—æ®µ

åœºæ™¯2ï¼šå­—æ®µç±»å‹å˜æ›´
æ—§ç‰ˆæœ¬: {price: Int}      // ä»·æ ¼ç”¨æ•´æ•°è¡¨ç¤ºï¼ˆåˆ†ï¼‰
æ–°ç‰ˆæœ¬: {price: Double}   // ä»·æ ¼ç”¨å°æ•°è¡¨ç¤ºï¼ˆå…ƒï¼‰

åœºæ™¯3ï¼šå¿…å¡«å­—æ®µå¢åŠ 
æ—§ç‰ˆæœ¬: {name: String}
æ–°ç‰ˆæœ¬: {name: String, phone: String (required)}  // æ–°å¢å¿…å¡«å­—æ®µ
```

### 3.2 Avro Schemaæ¼”è¿›ç­–ç•¥


**ğŸ”¸ å‘å‰å…¼å®¹**ï¼ˆForward Compatibilityï¼‰ï¼š
```
å«ä¹‰ï¼šæ–°çš„Schemaå¯ä»¥è¯»å–æ—§çš„æ•°æ®
å®ç°ï¼šåªèƒ½åˆ é™¤å­—æ®µæˆ–æ·»åŠ æœ‰é»˜è®¤å€¼çš„å­—æ®µ

ç¤ºä¾‹ï¼š
æ—§æ•°æ®: {"name": "å¼ ä¸‰", "age": 25, "email": "zhangsan@example.com"}
æ–°Schema: {"name": String, "age": Int}  // åˆ é™¤emailå­—æ®µ
ç»“æœï¼šâœ… å¯ä»¥æ­£å¸¸è¯»å–ï¼Œå¿½ç•¥emailå­—æ®µ
```

**ğŸ”¸ å‘åå…¼å®¹**ï¼ˆBackward Compatibilityï¼‰ï¼š
```
å«ä¹‰ï¼šæ—§çš„Schemaå¯ä»¥è¯»å–æ–°çš„æ•°æ®  
å®ç°ï¼šåªèƒ½æ·»åŠ å­—æ®µæˆ–åˆ é™¤æœ‰é»˜è®¤å€¼çš„å­—æ®µ

ç¤ºä¾‹ï¼š
æ–°æ•°æ®: {"name": "æå››", "age": 30, "phone": "13800138000"}
æ—§Schema: {"name": String, "age": Int}
ç»“æœï¼šâœ… å¯ä»¥æ­£å¸¸è¯»å–ï¼Œå¿½ç•¥phoneå­—æ®µ
```

### 3.3 Schema Registryä½¿ç”¨


**é…ç½®Schema Registry**ï¼š

```java
// ç”Ÿäº§è€…é…ç½®
Properties props = new Properties();
props.put("bootstrap.servers", "localhost:9092");
props.put("schema.registry.url", "http://localhost:8081");
props.put("key.serializer", KafkaAvroSerializer.class);
props.put("value.serializer", KafkaAvroSerializer.class);
```

**Schemaç‰ˆæœ¬æ£€æŸ¥å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹Topicçš„Schemaç‰ˆæœ¬å†å²
curl -X GET http://localhost:8081/subjects/my-topic-value/versions

# æ£€æŸ¥Schemaå…¼å®¹æ€§
curl -X POST -H "Content-Type: application/json" \
  --data '{"schema": "..."}' \
  http://localhost:8081/compatibility/subjects/my-topic-value/versions/latest
```

---

## 4. âš¡ æ€§èƒ½ç›¸å…³é—®é¢˜


### 4.1 åºåˆ—åŒ–æ€§èƒ½ç“¶é¢ˆ


**æ€§èƒ½å¯¹æ¯”åˆ†æ**ï¼š

| åºåˆ—åŒ–æ–¹å¼ | **åºåˆ—åŒ–é€Ÿåº¦** | **æ•°æ®å¤§å°** | **CPUæ¶ˆè€—** | **é€‚ç”¨åœºæ™¯** |
|-----------|---------------|-------------|-------------|-------------|
| `JSON` | ä¸­ç­‰ | è¾ƒå¤§ | ä¸­ç­‰ | å¼€å‘è°ƒè¯• |
| `Avro` | å¿« | å° | ä½ | ç”Ÿäº§ç¯å¢ƒ |
| `Protobuf` | å¾ˆå¿« | å¾ˆå° | å¾ˆä½ | é«˜æ€§èƒ½åœºæ™¯ |
| `JavaåŸç”Ÿ` | æ…¢ | å¤§ | é«˜ | ä¸æ¨è |

**ğŸ” æ€§èƒ½é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š

```
1ï¸âƒ£ ç›‘æ§åºåˆ—åŒ–è€—æ—¶
   - åœ¨åº”ç”¨ä¸­æ·»åŠ åºåˆ—åŒ–æ—¶é—´ç»Ÿè®¡
   - å…³æ³¨å¹³å‡è€—æ—¶å’ŒP99è€—æ—¶

2ï¸âƒ£ æ£€æŸ¥åºåˆ—åŒ–åçš„æ•°æ®å¤§å°
   - è¿‡å¤§çš„æ¶ˆæ¯ä¼šå½±å“ç½‘ç»œä¼ è¾“
   - å»ºè®®å•æ¡æ¶ˆæ¯æ§åˆ¶åœ¨1MBä»¥å†…

3ï¸âƒ£ åˆ†æCPUä½¿ç”¨ç‡
   - åºåˆ—åŒ–ä¸åº”å ç”¨è¿‡å¤šCPUèµ„æº
   - è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„åºåˆ—åŒ–æ ¼å¼
```

### 4.2 åºåˆ—åŒ–æ€§èƒ½ä¼˜åŒ–


**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**ï¼š

```java
// 1. ä½¿ç”¨è¿æ¥æ± é¿å…é‡å¤åˆ›å»ºåºåˆ—åŒ–å™¨
public class SerializerPool {
    private final ThreadLocal<KafkaAvroSerializer> serializers = 
        ThreadLocal.withInitial(() -> new KafkaAvroSerializer());
    
    public byte[] serialize(String topic, Object data) {
        return serializers.get().serialize(topic, data);
    }
}

// 2. æ‰¹é‡åºåˆ—åŒ–å‡å°‘å¼€é”€
public List<ProducerRecord<String, Object>> batchSerialize(
    List<Object> dataList) {
    return dataList.stream()
        .map(data -> new ProducerRecord<>("my-topic", data))
        .collect(Collectors.toList());
}
```

---

## 5. ğŸ› ï¸ è‡ªå®šä¹‰åºåˆ—åŒ–å™¨é—®é¢˜


### 5.1 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å¼‚å¸¸


**å¸¸è§å¼‚å¸¸ç±»å‹**ï¼š

```java
// âŒ å¸¸è§é”™è¯¯1ï¼šå¿˜è®°å¤„ç†nullå€¼
public class CustomSerializer implements Serializer<MyObject> {
    @Override
    public byte[] serialize(String topic, MyObject data) {
        // é”™è¯¯ï¼šæ²¡æœ‰å¤„ç†nullæƒ…å†µ
        return data.toString().getBytes();
    }
}

// âœ… æ­£ç¡®å¤„ç†æ–¹å¼
public class CustomSerializer implements Serializer<MyObject> {
    @Override
    public byte[] serialize(String topic, MyObject data) {
        if (data == null) {
            return null;  // Kafkaæ”¯æŒnullæ¶ˆæ¯
        }
        
        try {
            return objectMapper.writeValueAsBytes(data);
        } catch (Exception e) {
            throw new SerializationException("åºåˆ—åŒ–å¤±è´¥", e);
        }
    }
}
```

### 5.2 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨æœ€ä½³å®è·µ


**ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•**ï¼š

- â˜‘ï¸ **ç©ºå€¼å¤„ç†**ï¼šæ­£ç¡®å¤„ç†nullè¾“å…¥
- â˜‘ï¸ **å¼‚å¸¸å¤„ç†**ï¼šåŒ…è£…å¼‚å¸¸ä¸ºSerializationException  
- â˜‘ï¸ **çº¿ç¨‹å®‰å…¨**ï¼šç¡®ä¿åºåˆ—åŒ–å™¨çº¿ç¨‹å®‰å…¨
- â˜‘ï¸ **èµ„æºç®¡ç†**ï¼šæ­£ç¡®å®ç°close()æ–¹æ³•
- â˜‘ï¸ **é…ç½®æ”¯æŒ**ï¼šé€šè¿‡configure()æ–¹æ³•æ¥æ”¶é…ç½®

```java
public class RobustCustomSerializer implements Serializer<MyObject> {
    private ObjectMapper objectMapper;
    
    @Override
    public void configure(Map<String, ?> configs, boolean isKey) {
        // ä»é…ç½®ä¸­åˆå§‹åŒ–
        objectMapper = new ObjectMapper();
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }
    
    @Override
    public byte[] serialize(String topic, MyObject data) {
        if (data == null) return null;
        
        try {
            return objectMapper.writeValueAsBytes(data);
        } catch (JsonProcessingException e) {
            throw new SerializationException("JSONåºåˆ—åŒ–å¤±è´¥: " + data, e);
        }
    }
    
    @Override
    public void close() {
        // æ¸…ç†èµ„æº
        if (objectMapper != null) {
            objectMapper = null;
        }
    }
}
```

---

## 6. ğŸ”„ æ•°æ®æ ¼å¼å˜æ›´é—®é¢˜


### 6.1 æ•°æ®æ ¼å¼å˜æ›´å¯¼è‡´å¼‚å¸¸


**å…¸å‹å˜æ›´åœºæ™¯**ï¼š

```
åœºæ™¯1ï¼šAPIå‡çº§å¯¼è‡´æ•°æ®ç»“æ„å˜åŒ–
æ—§æ ¼å¼: {"userId": 123, "userName": "å¼ ä¸‰"}
æ–°æ ¼å¼: {"user": {"id": 123, "name": "å¼ ä¸‰", "profile": {...}}}

åœºæ™¯2ï¼šæšä¸¾å€¼å˜æ›´
æ—§æšä¸¾: STATUS = ["ACTIVE", "INACTIVE"] 
æ–°æšä¸¾: STATUS = ["ENABLED", "DISABLED", "PENDING"]

åœºæ™¯3ï¼šæ—¥æœŸæ ¼å¼æ ‡å‡†åŒ–
æ—§æ ¼å¼: "2024-01-15 10:30:00"
æ–°æ ¼å¼: "2024-01-15T10:30:00Z"
```

### 6.2 å¹³æ»‘è¿ç§»ç­–ç•¥


**ğŸ¯ åŒå†™åŒè¯»ç­–ç•¥**ï¼š

```java
// é˜¶æ®µ1ï¼šåŒå†™ç­–ç•¥ï¼ˆåŒæ—¶å†™æ–°æ—§æ ¼å¼ï¼‰
public void publishEvent(UserEvent event) {
    // å‘é€æ—§æ ¼å¼ï¼ˆå…¼å®¹ç°æœ‰æ¶ˆè´¹è€…ï¼‰
    kafkaTemplate.send("user-events-v1", convertToOldFormat(event));
    
    // å‘é€æ–°æ ¼å¼ï¼ˆä¾›æ–°æ¶ˆè´¹è€…ä½¿ç”¨ï¼‰
    kafkaTemplate.send("user-events-v2", convertToNewFormat(event));
}

// é˜¶æ®µ2ï¼šé€æ­¥è¿ç§»æ¶ˆè´¹è€…
// é˜¶æ®µ3ï¼šåœæ­¢æ—§æ ¼å¼å†™å…¥
```

**ğŸ”§ ç‰ˆæœ¬å…¼å®¹å¤„ç†**ï¼š

```java
public class VersionCompatibleDeserializer implements Deserializer<UserEvent> {
    @Override
    public UserEvent deserialize(String topic, byte[] data) {
        try {
            JsonNode json = objectMapper.readTree(data);
            
            // æ ¹æ®å­—æ®µåˆ¤æ–­ç‰ˆæœ¬
            if (json.has("userId")) {
                return parseV1Format(json);  // æ—§æ ¼å¼
            } else if (json.has("user")) {
                return parseV2Format(json);  // æ–°æ ¼å¼
            }
            
            throw new SerializationException("æœªçŸ¥çš„æ•°æ®æ ¼å¼ç‰ˆæœ¬");
        } catch (Exception e) {
            throw new SerializationException("ååºåˆ—åŒ–å¤±è´¥", e);
        }
    }
}
```

---

## 7. ğŸ”¤ ç¼–ç å’Œå­—ç¬¦é›†é—®é¢˜


### 7.1 ç¼–ç æ ¼å¼ä¸ä¸€è‡´


**é—®é¢˜è¡¨ç°**ï¼š
```
å‘é€çš„ä¸­æ–‡: "ä½ å¥½ä¸–ç•Œ"
æ¥æ”¶åˆ°çš„: "Ã¤Â½ Ã¥Â¥Â½Ã¤Â¸Ã§"  // ä¹±ç 
```

**æ ¹æœ¬åŸå› **ï¼š
- ç”Ÿäº§è€…ä½¿ç”¨UTF-8ç¼–ç å‘é€
- æ¶ˆè´¹è€…ä½¿ç”¨GBKç¼–ç æ¥æ”¶
- æˆ–è€…ç³»ç»Ÿé»˜è®¤ç¼–ç ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… æ˜¾å¼æŒ‡å®šUTF-8ç¼–ç 
public class SafeStringSerializer implements Serializer<String> {
    private static final String ENCODING = "UTF-8";
    
    @Override
    public byte[] serialize(String topic, String data) {
        if (data == null) return null;
        
        try {
            return data.getBytes(StandardCharsets.UTF_8);  // æ˜ç¡®æŒ‡å®šUTF-8
        } catch (Exception e) {
            throw new SerializationException("å­—ç¬¦ä¸²ç¼–ç å¤±è´¥", e);
        }
    }
}

public class SafeStringDeserializer implements Deserializer<String> {
    @Override
    public String deserialize(String topic, byte[] data) {
        if (data == null) return null;
        
        return new String(data, StandardCharsets.UTF_8);  // æ˜ç¡®æŒ‡å®šUTF-8
    }
}
```

### 7.2 ç‰¹æ®Šå­—ç¬¦å¤„ç†


**å¸¸è§é—®é¢˜å­—ç¬¦**ï¼š
- **æ¢è¡Œç¬¦**ï¼š`\n`, `\r\n`
- **åˆ¶è¡¨ç¬¦**ï¼š`\t`  
- **å¼•å·**ï¼š`"`, `'`
- **åæ–œæ **ï¼š`\`

**å¤„ç†ç­–ç•¥**ï¼š

```java
// JSONæ ¼å¼ä¸‹çš„ç‰¹æ®Šå­—ç¬¦å¤„ç†
ObjectMapper mapper = new ObjectMapper();
mapper.configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, true);  // è½¬ä¹‰éASCIIå­—ç¬¦
mapper.configure(JsonParser.Feature.ALLOW_UNQUOTED_CONTROL_CHARS, true);  // å…è®¸æ§åˆ¶å­—ç¬¦
```

---

## 8. ğŸ“¦ ä¾èµ–å’Œç‰ˆæœ¬å†²çª


### 8.1 åºåˆ—åŒ–åº“ç‰ˆæœ¬å†²çª


**å¸¸è§å†²çªåœºæ™¯**ï¼š

```xml
<!-- âŒ ç‰ˆæœ¬å†²çªç¤ºä¾‹ -->
<dependency>
    <groupId>org.apache.kafka</groupId>
    <artifactId>kafka-clients</artifactId>
    <version>2.8.0</version>
</dependency>

<dependency>
    <groupId>io.confluent</groupId>
    <artifactId>kafka-avro-serializer</artifactId>
    <version>7.0.0</version>  <!-- ç‰ˆæœ¬ä¸åŒ¹é… -->
</dependency>
```

**ğŸ” æ’æŸ¥å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹ä¾èµ–æ ‘ï¼Œæ‰¾å‡ºç‰ˆæœ¬å†²çª
mvn dependency:tree | grep kafka

# æˆ–ä½¿ç”¨Gradle
./gradlew dependencies | grep kafka
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š

```xml
<!-- ç»Ÿä¸€ç®¡ç†Kafkaç›¸å…³ä¾èµ–ç‰ˆæœ¬ -->
<properties>
    <kafka.version>2.8.0</kafka.version>
    <confluent.version>6.2.0</confluent.version>
</properties>

<dependencies>
    <dependency>
        <groupId>org.apache.kafka</groupId>
        <artifactId>kafka-clients</artifactId>
        <version>${kafka.version}</version>
    </dependency>
    
    <dependency>
        <groupId>io.confluent</groupId>
        <artifactId>kafka-avro-serializer</artifactId>
        <version>${confluent.version}</version>
        <exclusions>
            <exclusion>
                <groupId>org.apache.kafka</groupId>
                <artifactId>kafka-clients</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
</dependencies>
```

### 8.2 ç±»è·¯å¾„é…ç½®é”™è¯¯


**é—®é¢˜ç°è±¡**ï¼š
```
âŒ ClassNotFoundException: org.apache.avro.Schema
âŒ NoSuchMethodError: org.apache.kafka.common.serialization.Serializer.serialize
```

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨äºclasspath
find . -name "*.jar" -exec jar -tf {} \; | grep "Schema.class"

# 2. æ£€æŸ¥æ–¹æ³•ç­¾åæ˜¯å¦åŒ¹é…
javap -cp kafka-clients-2.8.0.jar org.apache.kafka.common.serialization.Serializer
```

---

## 9. ğŸ“Š ç›‘æ§å’Œæ’æŸ¥å·¥å…·


### 9.1 åºåˆ—åŒ–ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```java
// è‡ªå®šä¹‰ç›‘æ§è£…é¥°å™¨
public class MonitoredSerializer<T> implements Serializer<T> {
    private final Serializer<T> delegate;
    private final MeterRegistry meterRegistry;
    private final Timer serializationTimer;
    private final Counter errorCounter;
    
    public MonitoredSerializer(Serializer<T> delegate, MeterRegistry registry) {
        this.delegate = delegate;
        this.meterRegistry = registry;
        this.serializationTimer = Timer.builder("kafka.serialization.time")
            .register(registry);
        this.errorCounter = Counter.builder("kafka.serialization.errors")
            .register(registry);
    }
    
    @Override
    public byte[] serialize(String topic, T data) {
        return serializationTimer.recordCallable(() -> {
            try {
                byte[] result = delegate.serialize(topic, data);
                // è®°å½•åºåˆ—åŒ–åçš„æ•°æ®å¤§å°
                meterRegistry.gauge("kafka.message.size", result != null ? result.length : 0);
                return result;
            } catch (Exception e) {
                errorCounter.increment();
                throw e;
            }
        });
    }
}
```

### 9.2 æ—¥å¿—è°ƒè¯•æŠ€å·§


**ğŸ” è¯¦ç»†æ—¥å¿—é…ç½®**ï¼š

```xml
<!-- logback-spring.xml -->
<configuration>
    <!-- Kafkaåºåˆ—åŒ–ç›¸å…³æ—¥å¿— -->
    <logger name="org.apache.kafka.common.serialization" level="DEBUG"/>
    <logger name="io.confluent.kafka.serializers" level="DEBUG"/>
    
    <!-- è‡ªå®šä¹‰åºåˆ—åŒ–å™¨æ—¥å¿— -->
    <logger name="com.yourpackage.serializers" level="TRACE"/>
</configuration>
```

**ä»£ç ä¸­çš„è°ƒè¯•æ—¥å¿—**ï¼š

```java
@Slf4j
public class DebuggableSerializer implements Serializer<MyObject> {
    @Override
    public byte[] serialize(String topic, MyObject data) {
        log.debug("å¼€å§‹åºåˆ—åŒ–å¯¹è±¡: topic={}, dataType={}", topic, 
                 data != null ? data.getClass().getSimpleName() : "null");
        
        if (data == null) {
            log.debug("æ•°æ®ä¸ºnullï¼Œè¿”å›null");
            return null;
        }
        
        try {
            byte[] result = objectMapper.writeValueAsBytes(data);
            log.debug("åºåˆ—åŒ–æˆåŠŸ: topic={}, dataSize={}bytes", topic, result.length);
            return result;
        } catch (Exception e) {
            log.error("åºåˆ—åŒ–å¤±è´¥: topic={}, data={}", topic, data, e);
            throw new SerializationException("åºåˆ—åŒ–å¼‚å¸¸", e);
        }
    }
}
```

### 9.3 å®ç”¨æ’æŸ¥å‘½ä»¤


**ğŸ“‹ Kafkaå‘½ä»¤è¡Œå·¥å…·**ï¼š

```bash
# æŸ¥çœ‹Topicä¸­çš„åŸå§‹å­—èŠ‚æ•°æ®
kafka-console-consumer.sh --bootstrap-server localhost:9092 \
  --topic my-topic --property print.key=true \
  --key-deserializer org.apache.kafka.common.serialization.ByteArrayDeserializer \
  --value-deserializer org.apache.kafka.common.serialization.ByteArrayDeserializer

# ä½¿ç”¨å­—ç¬¦ä¸²ååºåˆ—åŒ–å™¨æŸ¥çœ‹æ•°æ®
kafka-console-consumer.sh --bootstrap-server localhost:9092 \
  --topic my-topic --from-beginning \
  --key-deserializer org.apache.kafka.common.serialization.StringDeserializer \
  --value-deserializer org.apache.kafka.common.serialization.StringDeserializer

# ç”Ÿäº§æµ‹è¯•æ•°æ®è¿›è¡ŒéªŒè¯
echo "æµ‹è¯•æ¶ˆæ¯" | kafka-console-producer.sh --bootstrap-server localhost:9092 \
  --topic my-topic \
  --property "key.serializer=org.apache.kafka.common.serialization.StringSerializer" \
  --property "value.serializer=org.apache.kafka.common.serialization.StringSerializer"
```

---

## 10. âœ… æœ€ä½³å®è·µæ€»ç»“


### 10.1 å¼€å‘é˜¶æ®µæœ€ä½³å®è·µ


**ğŸ¯ è®¾è®¡åŸåˆ™**ï¼š

- â˜‘ï¸ **ç»Ÿä¸€åºåˆ—åŒ–æ ¼å¼**ï¼šå›¢é˜Ÿå†…ç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„åºåˆ—åŒ–æ–¹æ¡ˆ
- â˜‘ï¸ **å‘å‰å‘åå…¼å®¹**ï¼šè®¾è®¡Schemaæ—¶è€ƒè™‘æœªæ¥æ‰©å±•æ€§
- â˜‘ï¸ **é”™è¯¯å¤„ç†å®Œå–„**ï¼šæ‰€æœ‰åºåˆ—åŒ–æ“ä½œéƒ½è¦æœ‰å¼‚å¸¸å¤„ç†
- â˜‘ï¸ **æ€§èƒ½æµ‹è¯•éªŒè¯**ï¼šåœ¨ç±»ç”Ÿäº§ç¯å¢ƒä¸‹æµ‹è¯•åºåˆ—åŒ–æ€§èƒ½
- â˜‘ï¸ **ç›‘æ§æŒ‡æ ‡å®Œæ•´**ï¼šæ·»åŠ å¿…è¦çš„ç›‘æ§å’Œå‘Šè­¦

### 10.2 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•


**ğŸ”§ ä¸Šçº¿å‰æ£€æŸ¥**ï¼š

```
é…ç½®æ£€æŸ¥ï¼š
âœ“ ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åºåˆ—åŒ–å™¨é…ç½®ä¸€è‡´
âœ“ Schema Registryè¿æ¥æ­£å¸¸ï¼ˆå¦‚ä½¿ç”¨Avroï¼‰
âœ“ å­—ç¬¦ç¼–ç è®¾ç½®ä¸ºUTF-8
âœ“ ä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§éªŒè¯

æ€§èƒ½æ£€æŸ¥ï¼š
âœ“ åºåˆ—åŒ–åæ¶ˆæ¯å¤§å°åˆç†ï¼ˆ<1MBï¼‰
âœ“ åºåˆ—åŒ–è€—æ—¶å¯æ¥å—ï¼ˆ<10msï¼‰
âœ“ å†…å­˜ä½¿ç”¨ç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼
âœ“ CPUå ç”¨åˆç†ï¼ˆåºåˆ—åŒ–<5%ï¼‰

ç›‘æ§æ£€æŸ¥ï¼š
âœ“ åºåˆ—åŒ–æˆåŠŸç‡ç›‘æ§
âœ“ åºåˆ—åŒ–è€—æ—¶ç›‘æ§  
âœ“ å¼‚å¸¸å‘Šè­¦é…ç½®
âœ“ æ—¥å¿—ç­‰çº§é€‚å½“
```

### 10.3 æ•…éšœå¤„ç†é¢„æ¡ˆ


**ğŸš¨ åº”æ€¥å“åº”æµç¨‹**ï¼š

```
1ï¸âƒ£ ç«‹å³å“åº”ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
   - æ£€æŸ¥é”™è¯¯æ—¥å¿—ç¡®è®¤é—®é¢˜èŒƒå›´
   - ç¡®è®¤æ˜¯å¦å½±å“ä¸šåŠ¡æ ¸å¿ƒåŠŸèƒ½
   - å‡†å¤‡å›æ»šæ–¹æ¡ˆ

2ï¸âƒ£ é—®é¢˜å®šä½ï¼ˆ15åˆ†é’Ÿå†…ï¼‰  
   - å¯¹æ¯”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é…ç½®
   - æ£€æŸ¥æœ€è¿‘çš„ä»£ç å˜æ›´
   - æŸ¥çœ‹åºåˆ—åŒ–ç›¸å…³ç›‘æ§æŒ‡æ ‡

3ï¸âƒ£ é—®é¢˜ä¿®å¤ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
   - æ ¹æ®é—®é¢˜ç±»å‹é‡‡ç”¨å¯¹åº”è§£å†³æ–¹æ¡ˆ
   - éªŒè¯ä¿®å¤æ•ˆæœ
   - æ›´æ–°ç›‘æ§å’Œå‘Šè­¦è§„åˆ™

4ï¸âƒ£ å¤ç›˜æ€»ç»“
   - è®°å½•é—®é¢˜åŸå› å’Œè§£å†³è¿‡ç¨‹
   - å®Œå–„é¢„é˜²æªæ–½
   - æ›´æ–°æ•…éšœå¤„ç†æ–‡æ¡£
```

### 10.4 å›¢é˜Ÿåä½œè§„èŒƒ


**ğŸ“‹ åä½œçº¦å®š**ï¼š

- **Schemaå˜æ›´æµç¨‹**ï¼šæ‰€æœ‰Schemaå˜æ›´å¿…é¡»ç»è¿‡å›¢é˜ŸReview
- **ç‰ˆæœ¬ç®¡ç†ç­–ç•¥**ï¼šä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ç®¡ç†Schemaç‰ˆæœ¬  
- **æ–‡æ¡£ç»´æŠ¤**ï¼šåŠæ—¶æ›´æ–°åºåˆ—åŒ–æ ¼å¼æ–‡æ¡£
- **æµ‹è¯•è¦†ç›–**ï¼šåºåˆ—åŒ–ç›¸å…³ä»£ç å¿…é¡»æœ‰å•å…ƒæµ‹è¯•
- **çŸ¥è¯†åˆ†äº«**ï¼šå®šæœŸåˆ†äº«åºåˆ—åŒ–æœ€ä½³å®è·µ

**è®°å¿†è¦ç‚¹**ï¼š
- åºåˆ—åŒ–å°±åƒç¿»è¯‘å®˜ï¼ŒæŠŠå¯¹è±¡ç¿»è¯‘æˆå­—èŠ‚å†ç¿»è¯‘å›æ¥
- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åºåˆ—åŒ–é…ç½®å¿…é¡»åŒ¹é…
- Schemaå˜æ›´è¦è€ƒè™‘å…¼å®¹æ€§ï¼Œé¿å…ç ´åç°æœ‰ç³»ç»Ÿ
- æ€§èƒ½å’Œç›‘æ§åŒæ ·é‡è¦ï¼Œé¢„é˜²èƒœäºæ²»ç–—
- å›¢é˜Ÿåä½œå’Œè§„èŒƒæ˜¯é¿å…é—®é¢˜çš„æœ€ä½³æ–¹å¼