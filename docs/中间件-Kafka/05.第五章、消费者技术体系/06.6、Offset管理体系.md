---
title: 6ã€Offsetç®¡ç†ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [Offsetæ¦‚å¿µä¸æœ¬è´¨](#1-Offsetæ¦‚å¿µä¸æœ¬è´¨)
2. [è‡ªåŠ¨æäº¤vsæ‰‹åŠ¨æäº¤æœºåˆ¶](#2-è‡ªåŠ¨æäº¤vsæ‰‹åŠ¨æäº¤æœºåˆ¶)
3. [åŒæ­¥æäº¤vså¼‚æ­¥æäº¤è¯¦è§£](#3-åŒæ­¥æäº¤vså¼‚æ­¥æäº¤è¯¦è§£)
4. [æäº¤å›è°ƒæœºåˆ¶æ·±å…¥](#4-æäº¤å›è°ƒæœºåˆ¶æ·±å…¥)
5. [__consumer_offsetså†…éƒ¨Topic](#5-__consumer_offsetså†…éƒ¨Topic)
6. [Offseté‡ç½®ç­–ç•¥è¯¦è§£](#6-Offseté‡ç½®ç­–ç•¥è¯¦è§£)
7. [æ¶ˆè´¹è¿›åº¦ç®¡ç†å®è·µ](#7-æ¶ˆè´¹è¿›åº¦ç®¡ç†å®è·µ)
8. [æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ](#8-æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Offsetæ¦‚å¿µä¸æœ¬è´¨


### 1.1 ä»€ä¹ˆæ˜¯Offset


**ğŸ’¡ ç®€å•ç†è§£**ï¼šOffsetå°±åƒä¹¦ç­¾ï¼Œè®°å½•ä½ è¯»åˆ°äº†å“ªä¸€é¡µ

```
æƒ³è±¡ä¸€æœ¬ä¹¦çš„é˜…è¯»è¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1é¡µ â”‚ ç¬¬2é¡µ â”‚ ç¬¬3é¡µ â”‚ ... â”‚ ç¬¬Né¡µ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘
      ä¹¦ç­¾ä½ç½® = å½“å‰è¯»åˆ°ç¬¬2é¡µ

Kafkaä¸­çš„æ¶ˆæ¯å°±åƒä¹¦é¡µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆæ¯0 â”‚ æ¶ˆæ¯1 â”‚ æ¶ˆæ¯2 â”‚ ... â”‚ æ¶ˆæ¯N â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘
     Offset=2 = ä¸‹æ¬¡è¦è¯»çš„æ¶ˆæ¯ä½ç½®
```

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
- **Offset**ï¼šæ¶ˆè´¹è€…åœ¨æ¯ä¸ªåˆ†åŒºä¸­çš„ä½ç½®æ ‡è®°
- **å•ä½**ï¼šæ¶ˆæ¯çº§åˆ«çš„åºå·ï¼Œä»0å¼€å§‹é€’å¢
- **ä½œç”¨**ï¼šè®°å½•"ä¸‹ä¸€æ¡è¦æ¶ˆè´¹çš„æ¶ˆæ¯ä½ç½®"
- **èŒƒå›´**ï¼šæ¯ä¸ªåˆ†åŒºéƒ½æœ‰ç‹¬ç«‹çš„Offset

### 1.2 Offsetçš„å·¥ä½œæœºåˆ¶


**ğŸ“Š Offsetåœ¨Kafkaä¸­çš„ä½ç½®**
```
Topic: user-events
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Partition 0          â”‚
â”‚ [msg0][msg1][msg2][msg3][msg4]  â”‚ â† æ¶ˆè´¹è€…A: offset=3
â”‚                     â†‘           â”‚   (å·²æ¶ˆè´¹0,1,2 ä¸‹æ¬¡è¯»3)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Partition 1          â”‚
â”‚ [msg0][msg1][msg2][msg3]        â”‚ â† æ¶ˆè´¹è€…A: offset=2  
â”‚               â†‘                 â”‚   (å·²æ¶ˆè´¹0,1 ä¸‹æ¬¡è¯»2)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ å…³é”®ç†è§£è¦ç‚¹**
- **åˆ†åŒºç‹¬ç«‹**ï¼šæ¯ä¸ªåˆ†åŒºéƒ½æœ‰è‡ªå·±çš„Offsetè®¡æ•°
- **æ¶ˆè´¹è€…ç‹¬ç«‹**ï¼šä¸åŒæ¶ˆè´¹è€…ç»„æœ‰å„è‡ªçš„Offsetè®°å½•
- **é€’å¢ç‰¹æ€§**ï¼šOffsetåªä¼šå‘å‰ç§»åŠ¨ï¼Œä¸ä¼šå€’é€€
- **æŒä¹…åŒ–**ï¼šOffsetä¿¡æ¯ä¼šæ°¸ä¹…ä¿å­˜åœ¨Kafkaä¸­

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Offsetç®¡ç†


**âŒ æ²¡æœ‰Offsetç®¡ç†çš„é—®é¢˜**
```
åœºæ™¯ï¼šæ¶ˆè´¹è€…ç¨‹åºé‡å¯å
é—®é¢˜1ï¼šä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹è¯» â†’ å¯èƒ½é‡å¤å¤„ç†
é—®é¢˜2ï¼šå¯èƒ½ä»å¤´å¼€å§‹è¯» â†’ å¤„ç†å¤§é‡æ—§æ•°æ®  
é—®é¢˜3ï¼šå¯èƒ½ä»æœ€æ–°å¼€å§‹è¯» â†’ ä¸¢å¤±æœªå¤„ç†æ•°æ®

å°±åƒçœ‹ä¹¦ä¸ç”¨ä¹¦ç­¾ï¼š
æ¯æ¬¡æ‰“å¼€ä¹¦éƒ½ä¸çŸ¥é“è¯»åˆ°å“ªäº†ï¼
```

**âœ… æœ‰Offsetç®¡ç†çš„å¥½å¤„**
- **â‘  æ–­ç‚¹ç»­ä¼ **ï¼šç¨‹åºé‡å¯åä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- **â‘¡ é¿å…é‡å¤**ï¼šä¸ä¼šé‡å¤å¤„ç†å·²æ¶ˆè´¹çš„æ¶ˆæ¯
- **â‘¢ è¿›åº¦è·Ÿè¸ª**ï¼šéšæ—¶çŸ¥é“æ¶ˆè´¹è¿›åº¦
- **â‘£ æ•…éšœæ¢å¤**ï¼šå¼‚å¸¸æƒ…å†µä¸‹å¿«é€Ÿæ¢å¤

---

## 2. âš–ï¸ è‡ªåŠ¨æäº¤vsæ‰‹åŠ¨æäº¤æœºåˆ¶


### 2.1 è‡ªåŠ¨æäº¤æœºåˆ¶è¯¦è§£


**ğŸ¤– è‡ªåŠ¨æäº¤çš„å·¥ä½œåŸç†**

è‡ªåŠ¨æäº¤å°±åƒ**å®šæ—¶ä¿å­˜æ¸¸æˆè¿›åº¦**ï¼Œç³»ç»Ÿæ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨ä¿å­˜ä½ çš„ä½ç½®ã€‚

```
æ—¶é—´çº¿ï¼š
T0ç§’: æ¶ˆè´¹æ¶ˆæ¯1,2,3
T5ç§’: â°è‡ªåŠ¨æäº¤ offset=4 (ä¸‹æ¬¡ä»æ¶ˆæ¯4å¼€å§‹)
T5-T10ç§’: æ¶ˆè´¹æ¶ˆæ¯4,5,6
T10ç§’: â°è‡ªåŠ¨æäº¤ offset=7 (ä¸‹æ¬¡ä»æ¶ˆæ¯7å¼€å§‹)
```

**ğŸ”§ è‡ªåŠ¨æäº¤é…ç½®**
```properties
# å¼€å¯è‡ªåŠ¨æäº¤ï¼ˆé»˜è®¤trueï¼‰
enable.auto.commit=true

# è‡ªåŠ¨æäº¤é—´éš”ï¼ˆé»˜è®¤5ç§’ï¼‰
auto.commit.interval.ms=5000
```

**âœ… è‡ªåŠ¨æäº¤ä¼˜ç‚¹**
- **ç®€å•æ˜“ç”¨**ï¼šæ— éœ€ç¼–å†™é¢å¤–ä»£ç 
- **è‡ªåŠ¨åŒ–**ï¼šç³»ç»Ÿå¸®ä½ ç®¡ç†ï¼Œä¸ä¼šå¿˜è®°
- **é€‚åˆåœºæ™¯**ï¼šç®€å•çš„æ¶ˆè´¹é€»è¾‘ï¼Œå®¹å¿å°‘é‡é‡å¤

**âŒ è‡ªåŠ¨æäº¤ç¼ºç‚¹**
- **å¯èƒ½é‡å¤æ¶ˆè´¹**ï¼šå¦‚æœåœ¨æäº¤é—´éš”å†…å´©æºƒ
- **å¯èƒ½ä¸¢å¤±æ¶ˆæ¯**ï¼šå¦‚æœæ¶ˆè´¹å¤±è´¥ä½†å·²è‡ªåŠ¨æäº¤
- **æ§åˆ¶ç²’åº¦ç²—**ï¼šæ— æ³•ç²¾ç¡®æ§åˆ¶æäº¤æ—¶æœº

### 2.2 æ‰‹åŠ¨æäº¤æœºåˆ¶è¯¦è§£


**ğŸ‘‹ æ‰‹åŠ¨æäº¤çš„å·¥ä½œåŸç†**

æ‰‹åŠ¨æäº¤å°±åƒ**æ‰‹åŠ¨ä¿å­˜æ–‡æ¡£**ï¼Œä½ å†³å®šä»€ä¹ˆæ—¶å€™ä¿å­˜è¿›åº¦ã€‚

```java
// åŸºæœ¬çš„æ‰‹åŠ¨æäº¤ç¤ºä¾‹
Properties props = new Properties();
props.put("enable.auto.commit", "false"); // å…³é—­è‡ªåŠ¨æäº¤

KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);

while (true) {
    ConsumerRecords<String, String> records = consumer.poll(1000);
    
    for (ConsumerRecord<String, String> record : records) {
        // å¤„ç†æ¶ˆæ¯
        processMessage(record);
    }
    
    // æ‰‹åŠ¨æäº¤ï¼šç¡®ä¿å¤„ç†å®Œå†æäº¤
    consumer.commitSync(); // åŒæ­¥æäº¤
}
```

**âœ… æ‰‹åŠ¨æäº¤ä¼˜ç‚¹**
- **ç²¾ç¡®æ§åˆ¶**ï¼šä½ å†³å®šä½•æ—¶æäº¤
- **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿å¤„ç†æˆåŠŸåå†æäº¤
- **é¿å…ä¸¢å¤±**ï¼šæœªå¤„ç†å®Œä¸ä¼šæäº¤offset
- **çµæ´»æ€§é«˜**ï¼šå¯ä»¥å®ç°å¤æ‚çš„æäº¤ç­–ç•¥

**âŒ æ‰‹åŠ¨æäº¤ç¼ºç‚¹**
- **ä»£ç å¤æ‚**ï¼šéœ€è¦ç¼–å†™æäº¤é€»è¾‘
- **å®¹æ˜“å¿˜è®°**ï¼šå¯èƒ½å¿˜è®°æäº¤å¯¼è‡´é‡å¤æ¶ˆè´¹
- **æ€§èƒ½è€ƒè™‘**ï¼šé¢‘ç¹æäº¤å½±å“æ€§èƒ½

### 2.3 é€‰æ‹©å»ºè®®


**ğŸ“‹ åœºæ™¯å¯¹æ¯”è¡¨**

| å¤„ç†ç‰¹ç‚¹ | **æ¨èæ–¹å¼** | **åŸå› ** |
|---------|-------------|---------|
| ğŸ”¸ **ç®€å•æ—¥å¿—å¤„ç†** | `è‡ªåŠ¨æäº¤` | `å®¹å¿å°‘é‡é‡å¤ï¼Œè¿½æ±‚ç®€å•` |
| ğŸ”¸ **é‡‘èäº¤æ˜“å¤„ç†** | `æ‰‹åŠ¨æäº¤` | `ç»å¯¹ä¸èƒ½ä¸¢å¤±æˆ–é‡å¤` |
| ğŸ”¸ **æ•°æ®åˆ†æä»»åŠ¡** | `æ‰‹åŠ¨æäº¤` | `å¤„ç†å¤±è´¥éœ€è¦é‡æ–°æ¥` |
| ğŸ”¸ **æ¶ˆæ¯è½¬å‘** | `æ‰‹åŠ¨æäº¤` | `ç¡®ä¿è½¬å‘æˆåŠŸåå†æäº¤` |

**ğŸ’¡ å®è·µå»ºè®®**
- **æ–°æ‰‹å…¥é—¨**ï¼šå…ˆç”¨è‡ªåŠ¨æäº¤ç†è§£åŸºæœ¬æ¦‚å¿µ
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®ä¸šåŠ¡é‡è¦æ€§é€‰æ‹©æ‰‹åŠ¨æäº¤
- **æ··åˆä½¿ç”¨**ï¼šå…³é”®æ¶ˆæ¯æ‰‹åŠ¨ï¼Œæ™®é€šæ¶ˆæ¯è‡ªåŠ¨

---

## 3. ğŸ”„ åŒæ­¥æäº¤vså¼‚æ­¥æäº¤è¯¦è§£


### 3.1 åŒæ­¥æäº¤æœºåˆ¶


**â±ï¸ åŒæ­¥æäº¤çš„å·¥ä½œæ–¹å¼**

åŒæ­¥æäº¤å°±åƒ**é“¶è¡Œè½¬è´¦**ï¼Œå¿…é¡»ç­‰é“¶è¡Œç¡®è®¤è½¬è´¦æˆåŠŸæ‰èƒ½åšä¸‹ä¸€æ­¥æ“ä½œã€‚

```
æ¶ˆè´¹è€…æ“ä½œæµç¨‹ï¼š
Step 1: å¤„ç†æ¶ˆæ¯ âœ“
Step 2: è°ƒç”¨commitSync() 
Step 3: ç­‰å¾…Kafkaç¡®è®¤... â³
Step 4: æ”¶åˆ°ç¡®è®¤åç»§ç»­ âœ“

å¦‚æœç¡®è®¤å¤±è´¥ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼
```

**ğŸ’» åŒæ­¥æäº¤ä»£ç ç¤ºä¾‹**
```java
try {
    while (true) {
        ConsumerRecords<String, String> records = consumer.poll(1000);
        
        // å¤„ç†æ‰€æœ‰æ¶ˆæ¯
        for (ConsumerRecord<String, String> record : records) {
            processMessage(record);
        }
        
        // åŒæ­¥æäº¤ï¼šç­‰å¾…ç¡®è®¤æ‰ç»§ç»­
        consumer.commitSync();
        System.out.println("âœ… Offsetæäº¤æˆåŠŸ");
    }
} catch (CommitFailedException e) {
    System.err.println("âŒ Offsetæäº¤å¤±è´¥: " + e.getMessage());
    // å¤„ç†æäº¤å¤±è´¥çš„æƒ…å†µ
}
```

**âœ… åŒæ­¥æäº¤ä¼˜ç‚¹**
- **å¯é æ€§é«˜**ï¼šç¡®ä¿æäº¤æˆåŠŸæ‰ç»§ç»­
- **é”™è¯¯å¤„ç†**ï¼šç«‹å³çŸ¥é“æäº¤æ˜¯å¦æˆåŠŸ
- **ç®€å•ç›´è§‚**ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£

**âŒ åŒæ­¥æäº¤ç¼ºç‚¹**
- **é˜»å¡ç­‰å¾…**ï¼šå¿…é¡»ç­‰å¾…Kafkaå“åº”
- **æ€§èƒ½å½±å“**ï¼šæ¯æ¬¡æäº¤éƒ½æœ‰ç½‘ç»œå»¶è¿Ÿ
- **ååé‡ä½**ï¼šä¸²è¡Œå¤„ç†ï¼Œæ— æ³•å¹¶è¡Œ

### 3.2 å¼‚æ­¥æäº¤æœºåˆ¶


**ğŸš€ å¼‚æ­¥æäº¤çš„å·¥ä½œæ–¹å¼**

å¼‚æ­¥æäº¤å°±åƒ**å‘é€é‚®ä»¶**ï¼Œå‘å‡ºå»å°±ç»§ç»­åšå…¶ä»–äº‹ï¼Œä¸ç­‰å›å¤ã€‚

```
æ¶ˆè´¹è€…æ“ä½œæµç¨‹ï¼š
Step 1: å¤„ç†æ¶ˆæ¯ âœ“
Step 2: è°ƒç”¨commitAsync() 
Step 3: ç«‹å³ç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹æ¶ˆæ¯ âœ“
Step N: åå°æ”¶åˆ°ç¡®è®¤å›è°ƒ ğŸ“

ä¸é˜»å¡ä¸»æµç¨‹ï¼Œæ€§èƒ½æ›´é«˜ï¼
```

**ğŸ’» å¼‚æ­¥æäº¤ä»£ç ç¤ºä¾‹**
```java
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(1000);
    
    // å¤„ç†æ‰€æœ‰æ¶ˆæ¯
    for (ConsumerRecord<String, String> record : records) {
        processMessage(record);
    }
    
    // å¼‚æ­¥æäº¤ï¼šä¸ç­‰å¾…ç¡®è®¤ï¼Œç«‹å³ç»§ç»­
    consumer.commitAsync(new OffsetCommitCallback() {
        @Override
        public void onComplete(Map<TopicPartition, OffsetAndMetadata> offsets, 
                             Exception exception) {
            if (exception != null) {
                System.err.println("âŒ å¼‚æ­¥æäº¤å¤±è´¥: " + exception.getMessage());
                // å¯ä»¥é€‰æ‹©é‡è¯•æˆ–è®°å½•é”™è¯¯
            } else {
                System.out.println("âœ… å¼‚æ­¥æäº¤æˆåŠŸ");
            }
        }
    });
    
    // ç«‹å³å¤„ç†ä¸‹ä¸€æ‰¹æ¶ˆæ¯ï¼Œä¸ç­‰å¾…æäº¤ç¡®è®¤
}
```

**âœ… å¼‚æ­¥æäº¤ä¼˜ç‚¹**
- **æ€§èƒ½ä¼˜å¼‚**ï¼šä¸é˜»å¡ä¸»æµç¨‹
- **å¹¶è¡Œå¤„ç†**ï¼šæ¶ˆè´¹å’Œæäº¤å¹¶è¡Œè¿›è¡Œ
- **é«˜ååé‡**ï¼šå‡å°‘ç­‰å¾…æ—¶é—´

**âŒ å¼‚æ­¥æäº¤ç¼ºç‚¹**
- **å¯èƒ½ä¸¢å¤±**ï¼šæäº¤å¤±è´¥ä½†ä¸çŸ¥é“
- **è°ƒè¯•å›°éš¾**ï¼šé”™è¯¯åœ¨å›è°ƒä¸­å¤„ç†
- **å¤æ‚æ€§é«˜**ï¼šéœ€è¦å¤„ç†å›è°ƒé€»è¾‘

### 3.3 æ··åˆç­–ç•¥æœ€ä½³å®è·µ


**ğŸ¯ æ¨èçš„æ··åˆä½¿ç”¨æ¨¡å¼**

```java
public class SmartConsumer {
    private KafkaConsumer<String, String> consumer;
    
    public void consumeWithMixedCommit() {
        try {
            while (true) {
                ConsumerRecords<String, String> records = consumer.poll(1000);
                
                for (ConsumerRecord<String, String> record : records) {
                    processMessage(record);
                }
                
                // æ­£å¸¸æƒ…å†µï¼šä½¿ç”¨å¼‚æ­¥æäº¤ï¼ˆé«˜æ€§èƒ½ï¼‰
                consumer.commitAsync((offsets, exception) -> {
                    if (exception != null) {
                        System.err.println("å¼‚æ­¥æäº¤å¤±è´¥ï¼Œè®°å½•é”™è¯¯: " + exception);
                    }
                });
            }
        } catch (Exception e) {
            System.err.println("æ¶ˆè´¹å¼‚å¸¸: " + e);
        } finally {
            try {
                // å…³é—­å‰ï¼šä½¿ç”¨åŒæ­¥æäº¤ï¼ˆç¡®ä¿æœ€åçš„offsetè¢«ä¿å­˜ï¼‰
                consumer.commitSync();
                System.out.println("æœ€ç»ˆåŒæ­¥æäº¤å®Œæˆ");
            } finally {
                consumer.close();
            }
        }
    }
}
```

**ğŸ“Š æäº¤æ–¹å¼å¯¹æ¯”**

| ç‰¹å¾ | **åŒæ­¥æäº¤** | **å¼‚æ­¥æäº¤** | **æ··åˆç­–ç•¥** |
|-----|-------------|-------------|-------------|
| **æ€§èƒ½** | ğŸ”´ `ä½` | ğŸŸ¢ `é«˜` | ğŸŸ¡ `ä¸­é«˜` |
| **å¯é æ€§** | ğŸŸ¢ `é«˜` | ğŸŸ¡ `ä¸­` | ğŸŸ¢ `é«˜` |
| **å¤æ‚åº¦** | ğŸŸ¢ `ç®€å•` | ğŸŸ¡ `ä¸­ç­‰` | ğŸ”´ `å¤æ‚` |
| **é€‚ç”¨åœºæ™¯** | `å¯é æ€§ä¼˜å…ˆ` | `æ€§èƒ½ä¼˜å…ˆ` | `ç”Ÿäº§ç¯å¢ƒæ¨è` |

---

## 4. ğŸ“ æäº¤å›è°ƒæœºåˆ¶æ·±å…¥


### 4.1 ä»€ä¹ˆæ˜¯æäº¤å›è°ƒ


**ğŸ“ å›è°ƒæœºåˆ¶ç±»æ¯”**

æäº¤å›è°ƒå°±åƒ**å¤–å–è®¢å•çŠ¶æ€é€šçŸ¥**ï¼š
```
ä½ ç‚¹å¤–å– â†’ å•†å®¶æ¥å• â†’ é…é€ä¸­ â†’ é€è¾¾é€šçŸ¥ğŸ“±

Kafkaæäº¤ â†’ å‘é€è¯·æ±‚ â†’ å¤„ç†ä¸­ â†’ ç»“æœå›è°ƒğŸ“
```

**ğŸ”§ å›è°ƒçš„æ ¸å¿ƒä½œç”¨**
- **â‘  ç»“æœé€šçŸ¥**ï¼šå‘Šè¯‰ä½ æäº¤æˆåŠŸè¿˜æ˜¯å¤±è´¥
- **â‘¡ é”™è¯¯å¤„ç†**ï¼šæäº¤å¤±è´¥æ—¶çš„å¤„ç†é€»è¾‘  
- **â‘¢ ç›‘æ§ç»Ÿè®¡**ï¼šè®°å½•æäº¤æˆåŠŸç‡ã€å¤±è´¥åŸå› 
- **â‘£ é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥åçš„é‡è¯•ç­–ç•¥

### 4.2 å›è°ƒå‡½æ•°è¯¦ç»†ä½¿ç”¨


**ğŸ’» å®Œæ•´çš„å›è°ƒå¤„ç†ç¤ºä¾‹**

```java
public class CallbackHandler {
    private static final Logger logger = LoggerFactory.getLogger(CallbackHandler.class);
    
    // ç»Ÿè®¡ä¿¡æ¯
    private AtomicInteger successCount = new AtomicInteger(0);
    private AtomicInteger failureCount = new AtomicInteger(0);
    
    public void consumeWithCallback() {
        consumer.commitAsync(new OffsetCommitCallback() {
            @Override
            public void onComplete(Map<TopicPartition, OffsetAndMetadata> offsets, 
                                 Exception exception) {
                
                if (exception == null) {
                    // âœ… æäº¤æˆåŠŸ
                    handleSuccess(offsets);
                } else {
                    // âŒ æäº¤å¤±è´¥  
                    handleFailure(offsets, exception);
                }
            }
        });
    }
    
    private void handleSuccess(Map<TopicPartition, OffsetAndMetadata> offsets) {
        successCount.incrementAndGet();
        
        // è®°å½•æˆåŠŸæ—¥å¿—
        for (Map.Entry<TopicPartition, OffsetAndMetadata> entry : offsets.entrySet()) {
            TopicPartition partition = entry.getKey();
            long offset = entry.getValue().offset();
            
            logger.info("âœ… åˆ†åŒº {}-{} offset {} æäº¤æˆåŠŸ", 
                       partition.topic(), partition.partition(), offset);
        }
    }
    
    private void handleFailure(Map<TopicPartition, OffsetAndMetadata> offsets, 
                             Exception exception) {
        failureCount.incrementAndGet();
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹å¤„ç†
        if (exception instanceof RetriableException) {
            // å¯é‡è¯•å¼‚å¸¸ï¼šè®°å½•æ—¥å¿—ï¼Œåç»­é‡è¯•
            logger.warn("âš ï¸ æäº¤å¤±è´¥ï¼Œå¯é‡è¯•: {}", exception.getMessage());
            
        } else {
            // ä¸å¯é‡è¯•å¼‚å¸¸ï¼šè®°å½•é”™è¯¯ï¼Œå¯èƒ½éœ€è¦å‘Šè­¦
            logger.error("âŒ æäº¤å¤±è´¥ï¼Œä¸å¯é‡è¯•: {}", exception.getMessage());
            
            // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥
            sendAlert("Kafka offsetæäº¤å¤±è´¥", exception);
        }
    }
}
```

### 4.3 é«˜çº§å›è°ƒç­–ç•¥


**ğŸ¯ æ™ºèƒ½é‡è¯•å›è°ƒ**

```java
public class SmartRetryCallback implements OffsetCommitCallback {
    private final int maxRetries;
    private final Map<TopicPartition, Integer> retryCount = new HashMap<>();
    
    public SmartRetryCallback(int maxRetries) {
        this.maxRetries = maxRetries;
    }
    
    @Override
    public void onComplete(Map<TopicPartition, OffsetAndMetadata> offsets, 
                         Exception exception) {
        if (exception != null && shouldRetry(exception)) {
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°
            boolean canRetry = offsets.entrySet().stream()
                .allMatch(entry -> {
                    TopicPartition tp = entry.getKey();
                    int count = retryCount.getOrDefault(tp, 0);
                    return count < maxRetries;
                });
            
            if (canRetry) {
                // å¢åŠ é‡è¯•è®¡æ•°
                offsets.keySet().forEach(tp -> 
                    retryCount.merge(tp, 1, Integer::sum));
                
                // å»¶è¿Ÿé‡è¯•
                scheduleRetry(offsets);
            } else {
                logger.error("é‡è¯•æ¬¡æ•°è¶…é™ï¼Œæ”¾å¼ƒæäº¤: {}", exception.getMessage());
            }
        } else {
            // æˆåŠŸæˆ–ä¸å¯é‡è¯•ï¼Œæ¸…ç©ºè®¡æ•°
            offsets.keySet().forEach(retryCount::remove);
        }
    }
}
```

---

## 5. ğŸ’¾ __consumer_offsetså†…éƒ¨Topic


### 5.1 ä»€ä¹ˆæ˜¯__consumer_offsets


**ğŸ“š ç†è§£__consumer_offsets**

æƒ³è±¡Kafkaé›†ç¾¤å°±æ˜¯ä¸€ä¸ª**å›¾ä¹¦é¦†**ï¼š
```
ğŸ“š å›¾ä¹¦é¦†çš„è—ä¹¦ = ä½ çš„ä¸šåŠ¡Topic (user-events, ordersç­‰)
ğŸ“– è¯»è€…å€Ÿé˜…è®°å½• = __consumer_offsets Topic

æ¯ä¸ªè¯»è€…(æ¶ˆè´¹è€…)çš„å€Ÿé˜…è¿›åº¦éƒ½è®°å½•åœ¨è¿™æœ¬ç‰¹æ®Šçš„ç™»è®°å†Œé‡Œï¼
```

**ğŸ”¸ æ ¸å¿ƒç‰¹å¾**
- **å†…éƒ¨Topic**ï¼šKafkaè‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºå­˜å‚¨offsetä¿¡æ¯
- **åˆ†å¸ƒå¼å­˜å‚¨**ï¼šoffsetä¿¡æ¯åˆ†æ•£åœ¨å¤šä¸ªåˆ†åŒºä¸­
- **é«˜å¯ç”¨**ï¼šæœ‰å‰¯æœ¬ä¿è¯æ•°æ®ä¸ä¸¢å¤±
- **å‹ç¼©Topic**ï¼šåªä¿ç•™æœ€æ–°çš„offsetä¿¡æ¯

### 5.2 å­˜å‚¨æ ¼å¼å’Œå†…å®¹


**ğŸ“Š __consumer_offsetsä¸­å­˜å‚¨ä»€ä¹ˆ**

```
Keyæ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆè´¹è€…ç»„ID + Topic + Partitionç¼–å·   â”‚
â”‚ ä¾‹ï¼šgroup1-user-events-partition-0  â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Valueæ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Offsetå€¼ + å…ƒæ•°æ®ä¿¡æ¯               â”‚
â”‚ ä¾‹ï¼š{offset: 12345, timestamp: ...} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» æŸ¥çœ‹offsetä¿¡æ¯çš„æ–¹æ³•**

```bash
# æŸ¥çœ‹æ¶ˆè´¹è€…ç»„çš„offsetä¿¡æ¯
kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --group my-consumer-group \
    --describe

# è¾“å‡ºç¤ºä¾‹ï¼š
GROUP           TOPIC      PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
my-group        orders     0          1000            1050            50
my-group        orders     1          2000            2000            0
my-group        orders     2          1500            1600            100
```

**ğŸ“ˆ ç†è§£è¾“å‡ºä¿¡æ¯**
- **CURRENT-OFFSET**ï¼šæ¶ˆè´¹è€…å½“å‰è¯»åˆ°çš„ä½ç½®
- **LOG-END-OFFSET**ï¼šåˆ†åŒºä¸­æœ€æ–°æ¶ˆæ¯çš„ä½ç½®  
- **LAG**ï¼šè¿˜æœ‰å¤šå°‘æ¶ˆæ¯æœªæ¶ˆè´¹ï¼ˆå»¶è¿Ÿç¨‹åº¦ï¼‰

### 5.3 é…ç½®å’Œç»´æŠ¤


**âš™ï¸ é‡è¦é…ç½®å‚æ•°**

```properties
# __consumer_offsetsåˆ†åŒºæ•°ï¼ˆé»˜è®¤50ï¼‰
offsets.topic.num.partitions=50

# å‰¯æœ¬æ•°ï¼ˆé»˜è®¤3ï¼‰
offsets.topic.replication.factor=3

# ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰
offsets.retention.minutes=10080

# å‹ç¼©ç­–ç•¥ï¼ˆé»˜è®¤compactï¼‰
offsets.topic.compression.codec=compact
```

**ğŸ§¹ offsetæ¸…ç†æœºåˆ¶**

```
æ—¶é—´çº¿ç¤ºä¾‹ï¼š
Day 1: æ¶ˆè´¹è€…ç»„activeï¼Œæ­£å¸¸æ›´æ–°offset
Day 2-7: æ¶ˆè´¹è€…ç»„inactiveï¼Œä¸å†æ›´æ–°offset  
Day 8: âš ï¸ Kafkaå¼€å§‹æ¸…ç†è¯¥ç»„çš„offsetè®°å½•
```

> **ğŸ’¡ é‡è¦æé†’**ï¼šå¦‚æœæ¶ˆè´¹è€…ç»„è¶…è¿‡7å¤©ä¸æ´»è·ƒï¼Œoffsetä¼šè¢«æ¸…ç†ï¼é‡æ–°å¯åŠ¨æ—¶ä¼šæ ¹æ®`auto.offset.reset`ç­–ç•¥é‡æ–°å®šä½ã€‚

---

## 6. ğŸ”„ Offseté‡ç½®ç­–ç•¥è¯¦è§£


### 6.1 ä»€ä¹ˆæ—¶å€™éœ€è¦é‡ç½®Offset


**ğŸ¤” å¸¸è§é‡ç½®åœºæ™¯**

```
åœºæ™¯1ï¼šæ–°æ¶ˆè´¹è€…ç»„é¦–æ¬¡å¯åŠ¨
é—®é¢˜ï¼šæ²¡æœ‰å†å²offsetè®°å½•ï¼Œä»å“ªé‡Œå¼€å§‹è¯»ï¼Ÿ

åœºæ™¯2ï¼šoffsetè¢«æ¸…ç†äº†  
é—®é¢˜ï¼šæ¶ˆè´¹è€…ç»„é•¿æœŸä¸æ´»è·ƒï¼Œoffsetè®°å½•ä¸¢å¤±

åœºæ™¯3ï¼šæ•°æ®å›æº¯éœ€æ±‚
é—®é¢˜ï¼šéœ€è¦é‡æ–°å¤„ç†å†å²æ•°æ®

åœºæ™¯4ï¼šoffsetæ— æ•ˆ
é—®é¢˜ï¼šæŒ‡å‘çš„ä½ç½®å·²ç»è¢«åˆ é™¤ï¼ˆè¶…è¿‡ä¿ç•™æœŸï¼‰
```

### 6.2 ä¸‰ç§é‡ç½®ç­–ç•¥è¯¦è§£


**ğŸ“‹ auto.offset.reseté…ç½®é€‰é¡¹**

| ç­–ç•¥å€¼ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** | **é£é™©** |
|-------|---------|-------------|---------|
| `earliest` | ä»æœ€æ—©çš„æ¶ˆæ¯å¼€å§‹ | æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜ | å¯èƒ½å¤„ç†å¤§é‡å†å²æ•°æ® |
| `latest` | ä»æœ€æ–°çš„æ¶ˆæ¯å¼€å§‹ | åªå…³å¿ƒæ–°æ•°æ® | å¯èƒ½é”™è¿‡å†å²æ¶ˆæ¯ |
| `none` | æŠ›å‡ºå¼‚å¸¸ï¼Œä¸è‡ªåŠ¨é‡ç½® | éœ€è¦æ‰‹åŠ¨æ§åˆ¶ | éœ€è¦é¢å¤–å¤„ç†é€»è¾‘ |

**ğŸ¯ ç­–ç•¥é€‰æ‹©æŒ‡å—**

```
â”Œâ”€ æ–°ç³»ç»Ÿä¸Šçº¿ â”€â”
â”‚             â”‚
â”œâ”€ éœ€è¦å†å²æ•°æ®ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ earliest
â”‚  â””â”€ å¦ â†’ latest
â”‚
â””â”€ é‡‘è/æ”¯ä»˜ç³»ç»Ÿ â†’ none (æ‰‹åŠ¨æ§åˆ¶)
```

### 6.3 å®é™…é…ç½®ç¤ºä¾‹


**âš™ï¸ ä¸åŒåœºæ™¯çš„é…ç½®**

```java
// åœºæ™¯1ï¼šæ•°æ®åˆ†æç³»ç»Ÿ - éœ€è¦å®Œæ•´æ•°æ®
Properties analyticsProps = new Properties();
analyticsProps.put("auto.offset.reset", "earliest");
analyticsProps.put("group.id", "analytics-group");

// åœºæ™¯2ï¼šå®æ—¶ç›‘æ§ç³»ç»Ÿ - åªè¦æœ€æ–°æ•°æ®  
Properties monitorProps = new Properties();
monitorProps.put("auto.offset.reset", "latest");
monitorProps.put("group.id", "monitor-group");

// åœºæ™¯3ï¼šé‡‘èç³»ç»Ÿ - æ‰‹åŠ¨æ§åˆ¶
Properties financialProps = new Properties();
financialProps.put("auto.offset.reset", "none");
financialProps.put("group.id", "payment-group");
```

**ğŸ› ï¸ æ‰‹åŠ¨é‡ç½®offsetå·¥å…·**

```bash
# é‡ç½®åˆ°æœ€æ—©ä½ç½®
kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --group my-group \
    --reset-offsets \
    --to-earliest \
    --topic my-topic \
    --execute

# é‡ç½®åˆ°æœ€æ–°ä½ç½®
kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --group my-group \
    --reset-offsets \
    --to-latest \
    --topic my-topic \
    --execute

# é‡ç½®åˆ°æŒ‡å®šoffset
kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --group my-group \
    --reset-offsets \
    --to-offset 1000 \
    --topic my-topic:0 \
    --execute
```

---

## 7. ğŸ“Š æ¶ˆè´¹è¿›åº¦ç®¡ç†å®è·µ


### 7.1 æ¶ˆè´¹è¿›åº¦ç›‘æ§


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**

```
æ ¸å¿ƒæŒ‡æ ‡ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer Lag    â”‚ â† æœ€é‡è¦ï¼æœªæ¶ˆè´¹æ¶ˆæ¯æ•°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ æ¶ˆè´¹é€Ÿç‡        â”‚ â† æ¯ç§’å¤„ç†å¤šå°‘æ¶ˆæ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æäº¤æˆåŠŸç‡      â”‚ â† offsetæäº¤æ˜¯å¦æ­£å¸¸
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†åŒºåˆ†å¸ƒ        â”‚ â† å„åˆ†åŒºæ¶ˆè´¹æ˜¯å¦å‡è¡¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» ç›‘æ§ä»£ç å®ç°**

```java
public class ConsumerMonitor {
    private final KafkaConsumer<String, String> consumer;
    private final MeterRegistry meterRegistry;
    
    public void monitorProgress() {
        // è·å–åˆ†é…çš„åˆ†åŒº
        Set<TopicPartition> assignments = consumer.assignment();
        
        // è·å–å„åˆ†åŒºçš„æœ€æ–°offset
        Map<TopicPartition, Long> endOffsets = consumer.endOffsets(assignments);
        
        // è·å–å½“å‰æ¶ˆè´¹ä½ç½®
        for (TopicPartition partition : assignments) {
            long currentOffset = consumer.position(partition);
            long endOffset = endOffsets.get(partition);
            long lag = endOffset - currentOffset;
            
            // è®°å½•å»¶è¿ŸæŒ‡æ ‡
            meterRegistry.gauge("kafka.consumer.lag", 
                Tags.of("topic", partition.topic(), 
                       "partition", String.valueOf(partition.partition())),
                lag);
            
            logger.info("åˆ†åŒº {}-{}: å½“å‰offset={}, æœ€æ–°offset={}, å»¶è¿Ÿ={}",
                       partition.topic(), partition.partition(), 
                       currentOffset, endOffset, lag);
        }
    }
}
```

### 7.2 è¿›åº¦å¯è§†åŒ–


**ğŸ“Š ç›‘æ§é¢æ¿å±•ç¤º**

```
Kafka Consumer Dashboard
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  æ¶ˆè´¹è€…ç»„: order-processing-group    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Topic: orders                       â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
â•‘  â”‚ åˆ†åŒº    â”‚ å»¶è¿Ÿæ¶ˆæ¯ â”‚ æ¶ˆè´¹é€Ÿç‡    â”‚â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â•‘
â•‘  â”‚ 0       â”‚ ğŸŸ¢ 5     â”‚ 1000 msg/s  â”‚â•‘
â•‘  â”‚ 1       â”‚ ğŸŸ¡ 50    â”‚ 950 msg/s   â”‚â•‘  
â•‘  â”‚ 2       â”‚ ğŸ”´ 500   â”‚ 800 msg/s   â”‚â•‘ â† éœ€è¦å…³æ³¨
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¢ å¥åº· ğŸŸ¡ æ³¨æ„ ğŸ”´ å‘Šè­¦
```

### 7.3 è¿›åº¦ç®¡ç†ç­–ç•¥


**ğŸ¯ ä¸åŒåœºæ™¯çš„ç®¡ç†ç­–ç•¥**

```java
public class ProgressManager {
    
    // ç­–ç•¥1ï¼šå»¶è¿Ÿæ•æ„Ÿåœºæ™¯
    public void handleLatencySensitive() {
        long lag = calculateLag();
        
        if (lag > 1000) {
            // å¢åŠ æ¶ˆè´¹è€…å®ä¾‹
            scaleUpConsumers();
            
            // è°ƒæ•´æ‰¹å¤„ç†å¤§å°
            adjustBatchSize();
            
            // å‘é€å‘Šè­¦
            sendAlert("æ¶ˆè´¹å»¶è¿Ÿè¿‡é«˜: " + lag);
        }
    }
    
    // ç­–ç•¥2ï¼šæ‰¹å¤„ç†åœºæ™¯  
    public void handleBatchProcessing() {
        // æŒ‰æ—¶é—´çª—å£å¤„ç†
        if (shouldProcessBatch()) {
            List<Message> batch = collectBatch();
            processBatchMessages(batch);
            
            // æ‰¹é‡æäº¤offset
            consumer.commitSync();
        }
    }
    
    // ç­–ç•¥3ï¼šé”™è¯¯æ¢å¤
    public void handleErrorRecovery() {
        try {
            processMessage();
        } catch (Exception e) {
            // è®°å½•é”™è¯¯æ¶ˆæ¯
            recordFailedMessage(e);
            
            // å†³å®šæ˜¯å¦è·³è¿‡è¿˜æ˜¯é‡è¯•
            if (shouldSkip(e)) {
                // è·³è¿‡æœ‰é—®é¢˜çš„æ¶ˆæ¯
                consumer.commitSync();
            } else {
                // é‡è¯•å¤„ç†
                retryProcessing();
            }
        }
    }
}
```

---

## 8. ğŸš€ æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ


### 8.1 æ‰¹é‡æ¶ˆè´¹æ¨¡å¼


**ğŸ“¦ ä¸ºä»€ä¹ˆè¦æ‰¹é‡æ“ä½œ**

```
å•æ¡å¤„ç† vs æ‰¹é‡å¤„ç†ï¼š

å•æ¡æ¨¡å¼ï¼š
å–1æ¡æ¶ˆæ¯ â†’ å¤„ç† â†’ æäº¤offset â†’ é‡å¤...
ä¼˜ç‚¹ï¼šå®æ—¶æ€§å¥½
ç¼ºç‚¹ï¼šååé‡ä½ï¼Œé¢‘ç¹ç½‘ç»œäº¤äº’

æ‰¹é‡æ¨¡å¼ï¼š  
å–Næ¡æ¶ˆæ¯ â†’ æ‰¹é‡å¤„ç† â†’ ä¸€æ¬¡æ€§æäº¤offset
ä¼˜ç‚¹ï¼šé«˜ååé‡ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
ç¼ºç‚¹ï¼šå»¶è¿Ÿç¨é«˜ï¼Œå†…å­˜å ç”¨å¤§
```

**ğŸ’» æ‰¹é‡æ¶ˆè´¹å®ç°**

```java
public class BatchConsumer {
    private final KafkaConsumer<String, String> consumer;
    private final int batchSize = 1000; // æ‰¹å¤„ç†å¤§å°
    private final long batchTimeout = 10000; // æ‰¹å¤„ç†è¶…æ—¶(10ç§’)
    
    public void consumeInBatches() {
        List<ConsumerRecord<String, String>> batch = new ArrayList<>();
        long batchStartTime = System.currentTimeMillis();
        
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(1000);
            
            for (ConsumerRecord<String, String> record : records) {
                batch.add(record);
                
                // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ‰¹å¤„ç†æ¡ä»¶
                if (shouldProcessBatch(batch, batchStartTime)) {
                    processBatch(batch);
                    
                    // æäº¤è¿™æ‰¹æ¶ˆæ¯çš„offset
                    consumer.commitSync();
                    
                    // é‡ç½®æ‰¹å¤„ç†çŠ¶æ€
                    batch.clear();
                    batchStartTime = System.currentTimeMillis();
                }
            }
        }
    }
    
    private boolean shouldProcessBatch(List<ConsumerRecord<String, String>> batch, 
                                     long startTime) {
        // æ¡ä»¶1ï¼šæ•°é‡è¾¾åˆ°é˜ˆå€¼
        if (batch.size() >= batchSize) {
            return true;
        }
        
        // æ¡ä»¶2ï¼šæ—¶é—´è¾¾åˆ°é˜ˆå€¼  
        if (System.currentTimeMillis() - startTime >= batchTimeout) {
            return true;
        }
        
        return false;
    }
    
    private void processBatch(List<ConsumerRecord<String, String>> batch) {
        // æ‰¹é‡å¤„ç†é€»è¾‘
        try {
            // ä¾‹ï¼šæ‰¹é‡å†™å…¥æ•°æ®åº“
            batchInsertToDatabase(batch);
            
            logger.info("âœ… æ‰¹å¤„ç†å®Œæˆï¼Œæ¶ˆæ¯æ•°é‡: {}", batch.size());
            
        } catch (Exception e) {
            logger.error("âŒ æ‰¹å¤„ç†å¤±è´¥", e);
            
            // å¯ä»¥é€‰æ‹©å•æ¡é‡è¯•
            processSingleMessages(batch);
        }
    }
}
```

### 8.2 æ‰¹é‡æäº¤ç­–ç•¥


**ğŸ¯ æ™ºèƒ½æ‰¹é‡æäº¤**

```java
public class SmartBatchCommit {
    private Map<TopicPartition, OffsetAndMetadata> pendingOffsets = new HashMap<>();
    private long lastCommitTime = System.currentTimeMillis();
    private final long commitInterval = 5000; // 5ç§’æäº¤é—´éš”
    
    public void smartCommit(ConsumerRecord<String, String> record) {
        // æ›´æ–°å¾…æäº¤çš„offset
        TopicPartition partition = new TopicPartition(record.topic(), record.partition());
        OffsetAndMetadata offsetMeta = new OffsetAndMetadata(record.offset() + 1);
        pendingOffsets.put(partition, offsetMeta);
        
        // æ£€æŸ¥æäº¤æ¡ä»¶
        if (shouldCommit()) {
            commitPendingOffsets();
        }
    }
    
    private boolean shouldCommit() {
        // æ¡ä»¶1ï¼šæ—¶é—´é—´éš”
        if (System.currentTimeMillis() - lastCommitTime >= commitInterval) {
            return true;
        }
        
        // æ¡ä»¶2ï¼špending offsetæ•°é‡
        if (pendingOffsets.size() >= 10) {
            return true;
        }
        
        return false;
    }
    
    private void commitPendingOffsets() {
        if (!pendingOffsets.isEmpty()) {
            try {
                consumer.commitSync(pendingOffsets);
                logger.info("âœ… æ‰¹é‡æäº¤æˆåŠŸï¼Œåˆ†åŒºæ•°: {}", pendingOffsets.size());
                
                pendingOffsets.clear();
                lastCommitTime = System.currentTimeMillis();
                
            } catch (Exception e) {
                logger.error("âŒ æ‰¹é‡æäº¤å¤±è´¥", e);
            }
        }
    }
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**âš¡ æ‰¹é‡æ“ä½œä¼˜åŒ–è¦ç‚¹**

```java
public class BatchOptimization {
    
    // æŠ€å·§1ï¼šåˆ†åŒºçº§åˆ«çš„æ‰¹å¤„ç†
    public void batchByPartition() {
        Map<TopicPartition, List<ConsumerRecord<String, String>>> partitionBatches = 
            new HashMap<>();
        
        ConsumerRecords<String, String> records = consumer.poll(1000);
        
        // æŒ‰åˆ†åŒºç»„ç»‡æ¶ˆæ¯
        for (ConsumerRecord<String, String> record : records) {
            TopicPartition partition = new TopicPartition(record.topic(), record.partition());
            partitionBatches.computeIfAbsent(partition, k -> new ArrayList<>())
                           .add(record);
        }
        
        // å¹¶è¡Œå¤„ç†å„åˆ†åŒº
        partitionBatches.entrySet().parallelStream()
                       .forEach(entry -> processPartitionBatch(entry.getKey(), entry.getValue()));
    }
    
    // æŠ€å·§2ï¼šå†…å­˜ç®¡ç†
    public void manageMemory(List<ConsumerRecord<String, String>> batch) {
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
        Runtime runtime = Runtime.getRuntime();
        long freeMemory = runtime.freeMemory();
        long totalMemory = runtime.totalMemory();
        
        double memoryUsage = 1.0 - (double)freeMemory / totalMemory;
        
        if (memoryUsage > 0.8) { // å†…å­˜ä½¿ç”¨è¶…è¿‡80%
            logger.warn("âš ï¸ å†…å­˜ä½¿ç”¨ç‡é«˜: {}%, å¼ºåˆ¶å¤„ç†æ‰¹æ¬¡", memoryUsage * 100);
            processBatch(batch);
            batch.clear();
            
            // å»ºè®®GC
            System.gc();
        }
    }
    
    // æŠ€å·§3ï¼šåŠ¨æ€æ‰¹æ¬¡å¤§å°
    public int calculateDynamicBatchSize() {
        // æ ¹æ®å¤„ç†é€Ÿåº¦è°ƒæ•´æ‰¹æ¬¡å¤§å°
        long avgProcessingTime = getAverageProcessingTime();
        
        if (avgProcessingTime < 1000) { // å¤„ç†å¾ˆå¿«
            return Math.min(currentBatchSize * 2, 5000); // å¢å¤§æ‰¹æ¬¡
        } else if (avgProcessingTime > 10000) { // å¤„ç†å¾ˆæ…¢
            return Math.max(currentBatchSize / 2, 100);  // å‡å°æ‰¹æ¬¡
        }
        
        return currentBatchSize; // ä¿æŒä¸å˜
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Offsetæœ¬è´¨ï¼šæ¶ˆè´¹è€…åœ¨åˆ†åŒºä¸­çš„ä½ç½®æ ‡è®°ï¼Œç±»ä¼¼ä¹¦ç­¾
ğŸ”¸ æäº¤æœºåˆ¶ï¼šè‡ªåŠ¨æäº¤ç®€å•ä½†ç²—ç³™ï¼Œæ‰‹åŠ¨æäº¤ç²¾ç¡®ä½†å¤æ‚
ğŸ”¸ æäº¤æ–¹å¼ï¼šåŒæ­¥æäº¤å¯é ä½†æ…¢ï¼Œå¼‚æ­¥æäº¤å¿«ä½†éœ€è¦å›è°ƒå¤„ç†
ğŸ”¸ å†…éƒ¨å­˜å‚¨ï¼š__consumer_offsets topicä¿å­˜æ‰€æœ‰offsetä¿¡æ¯
ğŸ”¸ é‡ç½®ç­–ç•¥ï¼šearliest/latest/noneä¸‰ç§ç­–ç•¥é€‚ç”¨ä¸åŒåœºæ™¯
ğŸ”¸ æ‰¹é‡å¤„ç†ï¼šæé«˜ååé‡ï¼Œä½†è¦å¹³è¡¡å»¶è¿Ÿå’Œå†…å­˜ä½¿ç”¨
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Offsetç®¡ç†çš„æ ¸å¿ƒæ€æƒ³**
```
å®‰å…¨ç¬¬ä¸€ï¼š
- ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ï¼šå…ˆå¤„ç†åæäº¤
- å®¹å¿å°‘é‡é‡å¤ï¼šç³»ç»Ÿé‡å¯å¯èƒ½é‡å¤æ¶ˆè´¹
- ç›‘æ§å»¶è¿Ÿï¼šåŠæ—¶å‘ç°æ¶ˆè´¹è·Ÿä¸ä¸Šç”Ÿäº§çš„é—®é¢˜

æ€§èƒ½å¹³è¡¡ï¼š
- æäº¤é¢‘ç‡ï¼šå¤ªé¢‘ç¹å½±å“æ€§èƒ½ï¼Œå¤ªå°‘å¯èƒ½é‡å¤å¤š
- æ‰¹é‡å¤§å°ï¼šå¤ªå¤§å å†…å­˜ï¼Œå¤ªå°å½±å“ååé‡
- è¶…æ—¶è®¾ç½®ï¼šç»™å¤„ç†é€»è¾‘ç•™è¶³å¤Ÿæ—¶é—´
```

**ğŸ”¹ ä¸åŒåœºæ™¯çš„æœ€ä½³é€‰æ‹©**
```
ğŸ¯ å®æ—¶ç³»ç»Ÿï¼šè‡ªåŠ¨æäº¤ + latestç­–ç•¥ + å°æ‰¹é‡
ğŸ¯ æ•°æ®åˆ†æï¼šæ‰‹åŠ¨æäº¤ + earliestç­–ç•¥ + å¤§æ‰¹é‡  
ğŸ¯ é‡‘èç³»ç»Ÿï¼šæ‰‹åŠ¨åŒæ­¥æäº¤ + noneç­–ç•¥ + äº‹åŠ¡å¤„ç†
ğŸ¯ æ—¥å¿—æ”¶é›†ï¼šå¼‚æ­¥æäº¤ + latestç­–ç•¥ + ä¸­ç­‰æ‰¹é‡
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š é…ç½®å‚æ•°é€ŸæŸ¥è¡¨**

| å‚æ•° | **é»˜è®¤å€¼** | **æ¨èè®¾ç½®** | **è¯´æ˜** |
|-----|-----------|-------------|---------|
| `enable.auto.commit` | `true` | `false`(ç”Ÿäº§) | æ‰‹åŠ¨æ§åˆ¶æ›´å®‰å…¨ |
| `auto.commit.interval.ms` | `5000` | `3000-10000` | è‡ªåŠ¨æäº¤é—´éš” |
| `auto.offset.reset` | `latest` | æ ¹æ®ä¸šåŠ¡éœ€æ±‚ | æ–°æ¶ˆè´¹è€…ç»„ç­–ç•¥ |
| `max.poll.records` | `500` | `100-1000` | å•æ¬¡æ‹‰å–æ¶ˆæ¯æ•° |

**ğŸ› ï¸ ç›‘æ§å‘Šè­¦å»ºè®®**
```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ Consumer Lag > 1000 â†’ ğŸŸ¡ è­¦å‘Š
â€¢ Consumer Lag > 10000 â†’ ğŸ”´ ä¸¥é‡å‘Šè­¦
â€¢ æäº¤å¤±è´¥ç‡ > 1% â†’ ğŸŸ¡ è­¦å‘Š  
â€¢ æ¶ˆè´¹è€…ç¦»çº¿ > 5åˆ†é’Ÿ â†’ ğŸ”´ ä¸¥é‡å‘Šè­¦

å¤„ç†æªæ–½ï¼š
â€¢ å»¶è¿Ÿé«˜ï¼šå¢åŠ æ¶ˆè´¹è€…å®ä¾‹ã€ä¼˜åŒ–å¤„ç†é€»è¾‘
â€¢ æäº¤å¤±è´¥ï¼šæ£€æŸ¥ç½‘ç»œã€Kafkaé›†ç¾¤çŠ¶æ€
â€¢ æ¶ˆè´¹è€…ç¦»çº¿ï¼šæ£€æŸ¥åº”ç”¨ç¨‹åºã€é‡å¯æœåŠ¡
```

**ğŸ’¡ æ•…éšœæ’æŸ¥checklist**
```
æ¶ˆè´¹å»¶è¿Ÿé—®é¢˜ï¼š
âœ“ æ£€æŸ¥æ¶ˆè´¹è€…æ•°é‡æ˜¯å¦è¶³å¤Ÿ
âœ“ æ£€æŸ¥å¤„ç†é€»è¾‘æ˜¯å¦æœ‰ç“¶é¢ˆ  
âœ“ æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿå’ŒKafkaé›†ç¾¤çŠ¶æ€
âœ“ æ£€æŸ¥GCå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ

Offsetæäº¤é—®é¢˜ï¼š
âœ“ æ£€æŸ¥æäº¤é…ç½®æ˜¯å¦æ­£ç¡®
âœ“ æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸è¢«å¿½ç•¥
âœ“ æ£€æŸ¥Kafka CoordinatorçŠ¶æ€
âœ“ æ£€æŸ¥__consumer_offsets topicå¥åº·çŠ¶æ€

é‡å¤æ¶ˆè´¹é—®é¢˜ï¼š
âœ“ æ£€æŸ¥æäº¤æ—¶æœºæ˜¯å¦æ­£ç¡®
âœ“ æ£€æŸ¥æ˜¯å¦æœ‰æœªæ•è·çš„å¼‚å¸¸å¯¼è‡´é‡å¯
âœ“ æ£€æŸ¥æ¶ˆè´¹è€…ç»„åè°ƒå™¨çŠ¶æ€
âœ“ æ£€æŸ¥å¤„ç†é€»è¾‘çš„å¹‚ç­‰æ€§
```

### 9.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸ† ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**
```java
// æ¨èçš„æ¶ˆè´¹è€…é…ç½®
Properties props = new Properties();
props.put("bootstrap.servers", "kafka1:9092,kafka2:9092,kafka3:9092");
props.put("group.id", "my-consumer-group");

// Offsetç®¡ç†è®¾ç½®
props.put("enable.auto.commit", "false");           // æ‰‹åŠ¨æäº¤
props.put("auto.offset.reset", "earliest");         // æ ¹æ®ä¸šåŠ¡è°ƒæ•´
props.put("max.poll.records", "500");              // é€‚ä¸­çš„æ‰¹æ¬¡å¤§å°
props.put("session.timeout.ms", "30000");          // ä¼šè¯è¶…æ—¶
props.put("heartbeat.interval.ms", "3000");        // å¿ƒè·³é—´éš”

// æ€§èƒ½ä¼˜åŒ–è®¾ç½®  
props.put("fetch.min.bytes", "1024");              // æœ€å°æ‹‰å–å­—èŠ‚æ•°
props.put("fetch.max.wait.ms", "500");             // æ‹‰å–ç­‰å¾…æ—¶é—´
props.put("max.partition.fetch.bytes", "1048576"); // å•åˆ†åŒºæœ€å¤§æ‹‰å–
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Offsetè®°å½•æ¶ˆè´¹ä½ç½®ï¼Œå¦‚åŒçœ‹ä¹¦ç”¨ä¹¦ç­¾
- æ‰‹åŠ¨æäº¤æ›´å®‰å…¨ï¼Œè‡ªåŠ¨æäº¤è¾ƒç®€å•  
- åŒæ­¥æäº¤ç­‰ç¡®è®¤ï¼Œå¼‚æ­¥æäº¤è¦å›è°ƒ
- æ‰¹é‡å¤„ç†ææ€§èƒ½ï¼Œç›‘æ§å»¶è¿Ÿé˜²å †ç§¯
- æ ¹æ®åœºæ™¯é€‰ç­–ç•¥ï¼Œç”Ÿäº§ç¯å¢ƒè¦è°¨æ…