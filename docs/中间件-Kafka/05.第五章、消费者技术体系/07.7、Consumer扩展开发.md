---
title: 7ã€Consumeræ‰©å±•å¼€å‘
---
## ğŸ“š ç›®å½•

1. [Consumeræ‰©å±•å¼€å‘æ¦‚è¿°](#1-consumeræ‰©å±•å¼€å‘æ¦‚è¿°)
2. [è‡ªå®šä¹‰ConsumerInterceptorè¯¦è§£](#2-è‡ªå®šä¹‰consumerinterceptorè¯¦è§£)
3. [æ¶ˆæ¯è¿‡æ»¤å’Œè½¬æ¢å®è·µ](#3-æ¶ˆæ¯è¿‡æ»¤å’Œè½¬æ¢å®è·µ)
4. [æ¶ˆè´¹ç›‘æ§æ•°æ®æ”¶é›†](#4-æ¶ˆè´¹ç›‘æ§æ•°æ®æ”¶é›†)
5. [æ¶ˆè´¹è€…æ‹¦æˆªå™¨é“¾ç®¡ç†](#5-æ¶ˆè´¹è€…æ‹¦æˆªå™¨é“¾ç®¡ç†)
6. [æ’ä»¶åŒ–æ‰©å±•æ¶æ„](#6-æ’ä»¶åŒ–æ‰©å±•æ¶æ„)
7. [æ€§èƒ½ç›‘æ§é›†æˆæ–¹æ¡ˆ](#7-æ€§èƒ½ç›‘æ§é›†æˆæ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Consumeræ‰©å±•å¼€å‘æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Consumeræ‰©å±•å¼€å‘


**é€šä¿—ç†è§£**ï¼š
Consumeræ‰©å±•å¼€å‘å°±åƒç»™ä½ çš„å¿«é€’å‘˜ï¼ˆKafka Consumerï¼‰å®‰è£…å„ç§åŠŸèƒ½æ’ä»¶ã€‚æ¯”å¦‚ï¼š
- **è®°å½•æ’ä»¶**ï¼šè®°å½•æ¯æ¬¡å–ä»¶çš„æ—¶é—´å’Œåœ°ç‚¹
- **è¿‡æ»¤æ’ä»¶**ï¼šåªå–ä½ éœ€è¦çš„å¿«é€’ï¼Œåƒåœ¾é‚®ä»¶ç›´æ¥ä¸¢å¼ƒ
- **è½¬æ¢æ’ä»¶**ï¼šæŠŠæ”¶åˆ°çš„åŒ…è£¹é‡æ–°åŒ…è£…æˆä½ å–œæ¬¢çš„æ ·å¼

```
æ™®é€šæ¶ˆè´¹è€…ï¼šæ”¶æ¶ˆæ¯ â†’ å¤„ç†æ¶ˆæ¯
æ‰©å±•æ¶ˆè´¹è€…ï¼šæ”¶æ¶ˆæ¯ â†’ [æ’ä»¶å¤„ç†] â†’ å¤„ç†æ¶ˆæ¯
                    â†‘
            å¯ä»¥åšå¾ˆå¤šè‡ªå®šä¹‰æ“ä½œ
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ”§ **åŠŸèƒ½å¢å¼º**ï¼šç»™æ¶ˆè´¹è€…æ·»åŠ é¢å¤–èƒ½åŠ›
- ğŸ“Š **ç›‘æ§é›†æˆ**ï¼šè‡ªåŠ¨æ”¶é›†æ€§èƒ½æ•°æ®
- ğŸ›¡ï¸ **æ¶ˆæ¯å¤„ç†**ï¼šè¿‡æ»¤ã€è½¬æ¢ã€éªŒè¯æ¶ˆæ¯
- ğŸ”Œ **æ’ä»¶åŒ–**ï¼šå¯æ’æ‹”çš„åŠŸèƒ½æ¨¡å—

### 1.2 æ‰©å±•å¼€å‘çš„åº”ç”¨åœºæ™¯


**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š
```
ç”µå•†ç³»ç»Ÿä¸­çš„åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¢å•æ¶ˆæ¯      â”‚ -> â”‚  æ¶ˆè´¹è€…æ‹¦æˆªå™¨     â”‚ -> â”‚   ä¸šåŠ¡å¤„ç†      â”‚
â”‚ (åŸå§‹æ•°æ®)      â”‚    â”‚ â€¢ æ•°æ®æ ¡éªŒ       â”‚    â”‚ â€¢ è®¢å•å¤„ç†      â”‚
â”‚                â”‚    â”‚ â€¢ æ•æ„Ÿä¿¡æ¯è„±æ•   â”‚    â”‚ â€¢ åº“å­˜æ›´æ–°      â”‚
â”‚                â”‚    â”‚ â€¢ ç›‘æ§æ•°æ®æ”¶é›†   â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¸¸è§æ‰©å±•éœ€æ±‚**ï¼š
- **æ•°æ®æ¸…æ´—**ï¼šæ¶ˆæ¯æ ¼å¼æ ‡å‡†åŒ–
- **å®‰å…¨åŠ å›º**ï¼šæ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†
- **æ€§èƒ½ç›‘æ§**ï¼šæ¶ˆè´¹å»¶è¿Ÿã€ååé‡ç»Ÿè®¡
- **é”™è¯¯å¤„ç†**ï¼šå¼‚å¸¸æ¶ˆæ¯çš„ç‰¹æ®Šå¤„ç†

---

## 2. ğŸ”§ è‡ªå®šä¹‰ConsumerInterceptorè¯¦è§£


### 2.1 ConsumerInterceptoråŸºç¡€åŸç†


**ä»€ä¹ˆæ˜¯ConsumerInterceptor**ï¼š
å°±åƒç»™ä½ çš„é‚®ç®±å®‰è£…ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œæ¯å°é‚®ä»¶åˆ°è¾¾æ—¶éƒ½ä¼šå…ˆç»è¿‡è¿™ä¸ªåŠ©æ‰‹å¤„ç†ï¼š

```
é‚®ä»¶æµç¨‹å¯¹æ¯”ï¼š
æ™®é€šé‚®ç®±ï¼šé‚®ä»¶ â†’ æ”¶ä»¶ç®±
æ™ºèƒ½é‚®ç®±ï¼šé‚®ä»¶ â†’ [æ™ºèƒ½åŠ©æ‰‹] â†’ æ”¶ä»¶ç®±
                    â†“
              â€¢ åƒåœ¾é‚®ä»¶è¿‡æ»¤
              â€¢ é‡è¦é‚®ä»¶æ ‡è®°  
              â€¢ è‡ªåŠ¨åˆ†ç±»æ•´ç†
```

**æ ¸å¿ƒæ¥å£æ–¹æ³•**ï¼š
- `onConsume()`ï¼šæ¶ˆæ¯åˆ°è¾¾æ—¶çš„å¤„ç†
- `onCommit()`ï¼šåç§»é‡æäº¤æ—¶çš„å¤„ç†

### 2.2 åŸºç¡€æ‹¦æˆªå™¨å®ç°


**ğŸ“‹ ç®€å•æ—¥å¿—æ‹¦æˆªå™¨**ï¼š
```java
public class LoggingConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        // å°±åƒè®°å½•æ¯å°é‚®ä»¶çš„æ¥æ”¶æ—¶é—´
        System.out.println("æ”¶åˆ° " + records.count() + " æ¡æ¶ˆæ¯ï¼Œæ—¶é—´ï¼š" + new Date());
        
        // éå†æ¯æ¡æ¶ˆæ¯è¿›è¡Œæ—¥å¿—è®°å½•
        for (ConsumerRecord<String, String> record : records) {
            System.out.printf("ä¸»é¢˜: %s, åˆ†åŒº: %d, åç§»é‡: %d%n", 
                record.topic(), record.partition(), record.offset());
        }
        
        return records;  // åŸæ ·è¿”å›æ¶ˆæ¯
    }
    
    @Override
    public void onCommit(Map<TopicPartition, OffsetAndMetadata> offsets) {
        // è®°å½•åç§»é‡æäº¤æƒ…å†µ
        System.out.println("åç§»é‡å·²æäº¤: " + offsets);
    }
    
    @Override
    public void close() {
        // æ¸…ç†èµ„æº
        System.out.println("æ‹¦æˆªå™¨å…³é—­");
    }
    
    @Override
    public void configure(Map<String, ?> configs) {
        // é…ç½®åˆå§‹åŒ–
        System.out.println("æ‹¦æˆªå™¨åˆå§‹åŒ–");
    }
}
```

### 2.3 é«˜çº§æ‹¦æˆªå™¨åŠŸèƒ½


**ğŸ“Š æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨**ï¼š
```java
public class MetricsConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    private final AtomicLong messageCount = new AtomicLong(0);
    private final AtomicLong totalBytes = new AtomicLong(0);
    private long startTime = System.currentTimeMillis();
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        // ç»Ÿè®¡æ¶ˆæ¯æ•°é‡
        messageCount.addAndGet(records.count());
        
        // ç»Ÿè®¡æ¶ˆæ¯å¤§å°
        for (ConsumerRecord<String, String> record : records) {
            totalBytes.addAndGet(record.value().getBytes().length);
        }
        
        // æ¯1000æ¡æ¶ˆæ¯è¾“å‡ºä¸€æ¬¡ç»Ÿè®¡
        if (messageCount.get() % 1000 == 0) {
            printMetrics();
        }
        
        return records;
    }
    
    private void printMetrics() {
        long elapsed = System.currentTimeMillis() - startTime;
        double messagesPerSecond = messageCount.get() * 1000.0 / elapsed;
        double bytesPerSecond = totalBytes.get() * 1000.0 / elapsed;
        
        System.out.printf("æ€§èƒ½æŒ‡æ ‡ - æ¶ˆæ¯/ç§’: %.2f, å­—èŠ‚/ç§’: %.2f%n", 
            messagesPerSecond, bytesPerSecond);
    }
}
```

---

## 3. ğŸ” æ¶ˆæ¯è¿‡æ»¤å’Œè½¬æ¢å®è·µ


### 3.1 æ¶ˆæ¯è¿‡æ»¤æœºåˆ¶


**è¿‡æ»¤å™¨åŸç†**ï¼š
å°±åƒé‚®ä»¶çš„åƒåœ¾è¿‡æ»¤å™¨ï¼Œæ ¹æ®è§„åˆ™å†³å®šå“ªäº›æ¶ˆæ¯éœ€è¦å¤„ç†ï¼š

```
æ¶ˆæ¯è¿‡æ»¤æµç¨‹ï¼š
åŸå§‹æ¶ˆæ¯ â†’ [è¿‡æ»¤è§„åˆ™æ£€æŸ¥] â†’ æœ‰æ•ˆæ¶ˆæ¯
           â”œâ”€ è§„åˆ™1ï¼šå†…å®¹æ£€æŸ¥
           â”œâ”€ è§„åˆ™2ï¼šæ¥æºéªŒè¯  
           â””â”€ è§„åˆ™3ï¼šæ ¼å¼æ ¡éªŒ
```

**å®é™…è¿‡æ»¤å®ç°**ï¼š
```java
public class FilteringConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    private final Set<String> blockedKeywords = Set.of("spam", "advertisement", "promotion");
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        Map<TopicPartition, List<ConsumerRecord<String, String>>> filteredRecords = new HashMap<>();
        
        for (TopicPartition partition : records.partitions()) {
            List<ConsumerRecord<String, String>> partitionRecords = records.records(partition);
            List<ConsumerRecord<String, String>> validRecords = new ArrayList<>();
            
            for (ConsumerRecord<String, String> record : partitionRecords) {
                // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å±è”½å…³é”®è¯
                if (isValidMessage(record.value())) {
                    validRecords.add(record);
                } else {
                    System.out.println("è¿‡æ»¤æ‰åƒåœ¾æ¶ˆæ¯: " + record.value());
                }
            }
            
            filteredRecords.put(partition, validRecords);
        }
        
        return new ConsumerRecords<>(filteredRecords);
    }
    
    private boolean isValidMessage(String message) {
        if (message == null) return false;
        
        String lowerMessage = message.toLowerCase();
        return blockedKeywords.stream().noneMatch(lowerMessage::contains);
    }
}
```

### 3.2 æ¶ˆæ¯è½¬æ¢å¤„ç†


**è½¬æ¢åœºæ™¯ç¤ºä¾‹**ï¼š
- **æ ¼å¼æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€JSONæ ¼å¼
- **æ•°æ®è„±æ•**ï¼šéšè—æ•æ„Ÿä¿¡æ¯
- **å­—æ®µæ˜ å°„**ï¼šè€ç³»ç»Ÿåˆ°æ–°ç³»ç»Ÿçš„å­—æ®µè½¬æ¢

**ğŸ”„ æ¶ˆæ¯è½¬æ¢æ‹¦æˆªå™¨**ï¼š
```java
public class TransformingConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        Map<TopicPartition, List<ConsumerRecord<String, String>>> transformedRecords = new HashMap<>();
        
        for (TopicPartition partition : records.partitions()) {
            List<ConsumerRecord<String, String>> partitionRecords = records.records(partition);
            List<ConsumerRecord<String, String>> newRecords = new ArrayList<>();
            
            for (ConsumerRecord<String, String> record : partitionRecords) {
                // è½¬æ¢æ¶ˆæ¯å†…å®¹
                String transformedValue = transformMessage(record.value());
                
                // åˆ›å»ºæ–°çš„æ¶ˆæ¯è®°å½•
                ConsumerRecord<String, String> newRecord = new ConsumerRecord<>(
                    record.topic(), record.partition(), record.offset(),
                    record.timestamp(), record.timestampType(),
                    record.serializedKeySize(), record.serializedValueSize(),
                    record.key(), transformedValue, record.headers()
                );
                
                newRecords.add(newRecord);
            }
            
            transformedRecords.put(partition, newRecords);
        }
        
        return new ConsumerRecords<>(transformedRecords);
    }
    
    private String transformMessage(String originalMessage) {
        // ç¤ºä¾‹ï¼šå°†æ‰‹æœºå·ç è„±æ•å¤„ç†
        return originalMessage.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
    }
}
```

---

## 4. ğŸ“Š æ¶ˆè´¹ç›‘æ§æ•°æ®æ”¶é›†


### 4.1 ç›‘æ§æ•°æ®æ”¶é›†ç­–ç•¥


**ç›‘æ§ç»´åº¦åˆ†æ**ï¼š
```
æ¶ˆè´¹è€…ç›‘æ§ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ€§èƒ½æŒ‡æ ‡   â”‚   â”‚   ä¸šåŠ¡æŒ‡æ ‡   â”‚   â”‚   å¥åº·æŒ‡æ ‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚â€¢ æ¶ˆè´¹é€Ÿç‡    â”‚   â”‚â€¢ æ¶ˆæ¯ç±»å‹    â”‚   â”‚â€¢ è¿æ¥çŠ¶æ€    â”‚
â”‚â€¢ å¤„ç†å»¶è¿Ÿ    â”‚   â”‚â€¢ ä¸šåŠ¡æˆåŠŸç‡  â”‚   â”‚â€¢ é”™è¯¯ç‡      â”‚
â”‚â€¢ ååé‡      â”‚   â”‚â€¢ é‡è¦äº‹ä»¶    â”‚   â”‚â€¢ èµ„æºä½¿ç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç›‘æ§æ•°æ®æ”¶é›†å®ç°


**ğŸ“ˆ ç»¼åˆç›‘æ§æ‹¦æˆªå™¨**ï¼š
```java
public class MonitoringConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    private final AtomicLong consumedMessages = new AtomicLong(0);
    private final AtomicLong consumedBytes = new AtomicLong(0);
    private final AtomicLong errors = new AtomicLong(0);
    
    // å­˜å‚¨æ¯ä¸ªä¸»é¢˜çš„æ¶ˆè´¹æƒ…å†µ
    private final Map<String, TopicMetrics> topicMetrics = new ConcurrentHashMap<>();
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        long startTime = System.nanoTime();
        
        try {
            // æ”¶é›†åŸºç¡€ç»Ÿè®¡
            consumedMessages.addAndGet(records.count());
            
            // æŒ‰ä¸»é¢˜ç»Ÿè®¡
            for (TopicPartition partition : records.partitions()) {
                String topic = partition.topic();
                List<ConsumerRecord<String, String>> partitionRecords = records.records(partition);
                
                TopicMetrics metrics = topicMetrics.computeIfAbsent(topic, k -> new TopicMetrics());
                metrics.addMessages(partitionRecords.size());
                
                // ç»Ÿè®¡æ¶ˆæ¯å¤§å°
                for (ConsumerRecord<String, String> record : partitionRecords) {
                    if (record.value() != null) {
                        consumedBytes.addAndGet(record.value().getBytes().length);
                    }
                }
            }
            
            return records;
            
        } catch (Exception e) {
            errors.incrementAndGet();
            System.err.println("ç›‘æ§æ‹¦æˆªå™¨å¼‚å¸¸: " + e.getMessage());
            return records;
        } finally {
            // è®°å½•å¤„ç†æ—¶é—´
            long processingTime = System.nanoTime() - startTime;
            recordProcessingTime(processingTime);
        }
    }
    
    @Override
    public void onCommit(Map<TopicPartition, OffsetAndMetadata> offsets) {
        // è®°å½•æäº¤çš„åç§»é‡ä¿¡æ¯
        for (Map.Entry<TopicPartition, OffsetAndMetadata> entry : offsets.entrySet()) {
            String topic = entry.getKey().topic();
            TopicMetrics metrics = topicMetrics.get(topic);
            if (metrics != null) {
                metrics.recordCommit(entry.getValue().offset());
            }
        }
    }
    
    // å®šæœŸè¾“å‡ºç›‘æ§æŠ¥å‘Š
    public void printMetrics() {
        System.out.println("=== æ¶ˆè´¹è€…ç›‘æ§æŠ¥å‘Š ===");
        System.out.printf("æ€»æ¶ˆæ¯æ•°: %d%n", consumedMessages.get());
        System.out.printf("æ€»å­—èŠ‚æ•°: %d%n", consumedBytes.get());
        System.out.printf("é”™è¯¯æ¬¡æ•°: %d%n", errors.get());
        
        topicMetrics.forEach((topic, metrics) -> {
            System.out.printf("ä¸»é¢˜ %s: æ¶ˆæ¯=%d, æœ€ååç§»é‡=%d%n", 
                topic, metrics.getMessageCount(), metrics.getLastOffset());
        });
    }
    
    // å†…éƒ¨å·¥å…·ç±»
    private static class TopicMetrics {
        private final AtomicLong messageCount = new AtomicLong(0);
        private volatile long lastOffset = -1;
        
        void addMessages(int count) {
            messageCount.addAndGet(count);
        }
        
        void recordCommit(long offset) {
            this.lastOffset = offset;
        }
        
        long getMessageCount() { return messageCount.get(); }
        long getLastOffset() { return lastOffset; }
    }
}
```

---

## 5. ğŸ”— æ¶ˆè´¹è€…æ‹¦æˆªå™¨é“¾ç®¡ç†


### 5.1 æ‹¦æˆªå™¨é“¾çš„æ¦‚å¿µ


**æ‹¦æˆªå™¨é“¾åŸç†**ï¼š
å°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œæ¯ä¸ªå·¥ä½è´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½ï¼š

```
æ¶ˆæ¯å¤„ç†æµæ°´çº¿ï¼š
æ¶ˆæ¯ â†’ [æ—¥å¿—è®°å½•] â†’ [è¿‡æ»¤æ£€æŸ¥] â†’ [æ ¼å¼è½¬æ¢] â†’ [ç›‘æ§ç»Ÿè®¡] â†’ ä¸šåŠ¡å¤„ç†
       å·¥ä½1      å·¥ä½2       å·¥ä½3       å·¥ä½4
```

### 5.2 æ‹¦æˆªå™¨é“¾é…ç½®


**ğŸ”§ Consumeré…ç½®ç¤ºä¾‹**ï¼š
```java
public class ConsumerWithInterceptorChain {
    
    public static Consumer<String, String> createConsumer() {
        Properties props = new Properties();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "my-consumer-group");
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        
        // é…ç½®æ‹¦æˆªå™¨é“¾ - æ‰§è¡Œé¡ºåºå¾ˆé‡è¦ï¼
        List<String> interceptors = Arrays.asList(
            LoggingConsumerInterceptor.class.getName(),      // 1. å…ˆè®°å½•æ—¥å¿—
            FilteringConsumerInterceptor.class.getName(),    // 2. å†è¿‡æ»¤æ¶ˆæ¯
            TransformingConsumerInterceptor.class.getName(), // 3. ç„¶åè½¬æ¢æ ¼å¼
            MonitoringConsumerInterceptor.class.getName()    // 4. æœ€åæ”¶é›†ç›‘æ§
        );
        
        props.put(ConsumerConfig.INTERCEPTOR_CLASSES_CONFIG, interceptors);
        
        return new KafkaConsumer<>(props);
    }
}
```

### 5.3 æ‹¦æˆªå™¨é“¾æœ€ä½³å®è·µ


**âš¡ æ€§èƒ½è€ƒè™‘**ï¼š
- **é¡ºåºä¼˜åŒ–**ï¼šæŠŠè½»é‡çº§æ‹¦æˆªå™¨æ”¾å‰é¢
- **å¼‚å¸¸å¤„ç†**ï¼šä¸€ä¸ªæ‹¦æˆªå™¨å‡ºé”™ä¸å½±å“å…¶ä»–
- **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾æ‹¦æˆªå™¨å ç”¨çš„èµ„æº

**ğŸ›¡ï¸ å¼‚å¸¸å®‰å…¨çš„æ‹¦æˆªå™¨**ï¼š
```java
public class SafeConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        try {
            // æ ¸å¿ƒå¤„ç†é€»è¾‘
            return processRecords(records);
        } catch (Exception e) {
            // å‡ºé”™æ—¶è®°å½•æ—¥å¿—ï¼Œä½†ä¸å½±å“æ¶ˆæ¯æµ
            System.err.println("æ‹¦æˆªå™¨å¤„ç†å¼‚å¸¸ï¼Œè·³è¿‡: " + e.getMessage());
            return records;  // è¿”å›åŸå§‹æ¶ˆæ¯
        }
    }
    
    private ConsumerRecords<String, String> processRecords(ConsumerRecords<String, String> records) {
        // å®é™…çš„å¤„ç†é€»è¾‘
        return records;
    }
}
```

---

## 6. ğŸ”Œ æ’ä»¶åŒ–æ‰©å±•æ¶æ„


### 6.1 æ’ä»¶åŒ–æ¶æ„è®¾è®¡


**æ’ä»¶ç³»ç»Ÿæ¶æ„**ï¼š
```
æ’ä»¶åŒ–æ¶ˆè´¹è€…æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Consumer Core             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Plugin Manager                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚Plugin A â”‚ â”‚Plugin B â”‚ â”‚Plugin C â”‚â”‚
â”‚  â”‚æ—¥å¿—æ’ä»¶  â”‚ â”‚ç›‘æ§æ’ä»¶  â”‚ â”‚è¿‡æ»¤æ’ä»¶ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ’ä»¶æ¥å£å®šä¹‰


**ğŸ“‹ åŸºç¡€æ’ä»¶æ¥å£**ï¼š
```java
// å®šä¹‰æ’ä»¶çš„åŸºæœ¬èƒ½åŠ›
public interface ConsumerPlugin {
    
    /**
     * æ’ä»¶åç§°
     */
    String getName();
    
    /**
     * æ’ä»¶ç‰ˆæœ¬
     */
    String getVersion();
    
    /**
     * åˆå§‹åŒ–æ’ä»¶
     */
    void initialize(Map<String, Object> config);
    
    /**
     * å¤„ç†æ¶ˆæ¯
     */
    ConsumerRecords<String, String> process(ConsumerRecords<String, String> records);
    
    /**
     * é”€æ¯æ’ä»¶
     */
    void destroy();
}

// å…·ä½“æ’ä»¶å®ç°ç¤ºä¾‹
public class LoggingPlugin implements ConsumerPlugin {
    
    @Override
    public String getName() {
        return "æ¶ˆæ¯æ—¥å¿—æ’ä»¶";
    }
    
    @Override
    public String getVersion() {
        return "1.0.0";
    }
    
    @Override
    public void initialize(Map<String, Object> config) {
        System.out.println("æ—¥å¿—æ’ä»¶åˆå§‹åŒ–");
    }
    
    @Override
    public ConsumerRecords<String, String> process(ConsumerRecords<String, String> records) {
        System.out.printf("æ—¥å¿—æ’ä»¶å¤„ç†äº† %d æ¡æ¶ˆæ¯%n", records.count());
        return records;
    }
    
    @Override
    public void destroy() {
        System.out.println("æ—¥å¿—æ’ä»¶é”€æ¯");
    }
}
```

### 6.3 æ’ä»¶ç®¡ç†å™¨å®ç°


**ğŸ”§ æ’ä»¶ç®¡ç†å™¨**ï¼š
```java
public class ConsumerPluginManager {
    
    private final List<ConsumerPlugin> plugins = new ArrayList<>();
    
    /**
     * åŠ è½½æ’ä»¶
     */
    public void loadPlugin(String pluginClassName, Map<String, Object> config) {
        try {
            Class<?> pluginClass = Class.forName(pluginClassName);
            ConsumerPlugin plugin = (ConsumerPlugin) pluginClass.newInstance();
            plugin.initialize(config);
            plugins.add(plugin);
            
            System.out.printf("æˆåŠŸåŠ è½½æ’ä»¶: %s v%s%n", 
                plugin.getName(), plugin.getVersion());
                
        } catch (Exception e) {
            System.err.println("åŠ è½½æ’ä»¶å¤±è´¥: " + pluginClassName);
        }
    }
    
    /**
     * é€šè¿‡æ‰€æœ‰æ’ä»¶å¤„ç†æ¶ˆæ¯
     */
    public ConsumerRecords<String, String> processThrough(ConsumerRecords<String, String> records) {
        ConsumerRecords<String, String> currentRecords = records;
        
        // ä¾æ¬¡é€šè¿‡æ¯ä¸ªæ’ä»¶å¤„ç†
        for (ConsumerPlugin plugin : plugins) {
            try {
                currentRecords = plugin.process(currentRecords);
            } catch (Exception e) {
                System.err.printf("æ’ä»¶ %s å¤„ç†å¼‚å¸¸: %s%n", 
                    plugin.getName(), e.getMessage());
            }
        }
        
        return currentRecords;
    }
    
    /**
     * é”€æ¯æ‰€æœ‰æ’ä»¶
     */
    public void destroyAll() {
        for (ConsumerPlugin plugin : plugins) {
            try {
                plugin.destroy();
            } catch (Exception e) {
                System.err.printf("é”€æ¯æ’ä»¶ %s å¼‚å¸¸: %s%n", 
                    plugin.getName(), e.getMessage());
            }
        }
        plugins.clear();
    }
}
```

---

## 7. ğŸ“Š æ€§èƒ½ç›‘æ§é›†æˆæ–¹æ¡ˆ


### 7.1 ç›‘æ§ç³»ç»Ÿé›†æˆ


**ç›‘æ§æ•°æ®æµå‘**ï¼š
```
Consumeråº”ç”¨ â†’ [ç›‘æ§æ‹¦æˆªå™¨] â†’ [æ•°æ®æ”¶é›†] â†’ [ç›‘æ§ç³»ç»Ÿ]
                     â†“
                [æœ¬åœ°ç¼“å­˜]
                     â†“
              [æ‰¹é‡ä¸ŠæŠ¥æœºåˆ¶]
```

### 7.2 ä¸ç¬¬ä¸‰æ–¹ç›‘æ§é›†æˆ


**ğŸ”— Prometheusé›†æˆç¤ºä¾‹**ï¼š
```java
public class PrometheusConsumerInterceptor implements ConsumerInterceptor<String, String> {
    
    // PrometheusæŒ‡æ ‡å®šä¹‰
    private final Counter consumedMessagesTotal = Counter.build()
        .name("kafka_consumer_messages_total")
        .help("æ¶ˆè´¹çš„æ¶ˆæ¯æ€»æ•°")
        .labelNames("topic", "partition")
        .register();
    
    private final Histogram processingLatency = Histogram.build()
        .name("kafka_consumer_processing_seconds")
        .help("æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ")
        .register();
    
    @Override
    public ConsumerRecords<String, String> onConsume(ConsumerRecords<String, String> records) {
        Timer.Sample sample = Timer.start();
        
        try {
            // ç»Ÿè®¡å„ä¸»é¢˜åˆ†åŒºçš„æ¶ˆæ¯æ•°
            for (TopicPartition partition : records.partitions()) {
                List<ConsumerRecord<String, String>> partitionRecords = records.records(partition);
                consumedMessagesTotal
                    .labels(partition.topic(), String.valueOf(partition.partition()))
                    .inc(partitionRecords.size());
            }
            
            return records;
            
        } finally {
            // è®°å½•å¤„ç†æ—¶é—´
            sample.stop(processingLatency);
        }
    }
}
```

### 7.3 è‡ªå®šä¹‰ç›‘æ§é¢æ¿


**ğŸ“Š ç›‘æ§æŒ‡æ ‡ä½“ç³»**ï¼š

| ç›‘æ§ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|------|---------|
| **ååé‡** | æ¶ˆæ¯æ•°/ç§’ | æ¶ˆè´¹é€Ÿç‡ | < 100/s |
| **å»¶è¿Ÿ** | ç«¯åˆ°ç«¯å»¶è¿Ÿ | æ¶ˆæ¯å¤„ç†æ—¶é—´ | > 5s |
| **å¥åº·åº¦** | é”™è¯¯ç‡ | å¤±è´¥æ¶ˆæ¯æ¯”ä¾‹ | > 1% |
| **èµ„æº** | å†…å­˜ä½¿ç”¨ | JVMå†…å­˜å ç”¨ | > 80% |

**ç›‘æ§æ•°æ®è¾“å‡ºæ ¼å¼**ï¼š
```json
{
  "timestamp": "2025-09-20T14:30:00Z",
  "consumer_group": "order-processor",
  "metrics": {
    "messages_per_second": 1250,
    "avg_processing_latency_ms": 45,
    "error_rate_percent": 0.1,
    "memory_usage_percent": 65
  },
  "topics": [
    {
      "name": "order-events", 
      "partitions": 8,
      "lag_total": 120
    }
  ]
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ConsumerInterceptorï¼šæ¶ˆè´¹è€…æ‹¦æˆªå™¨ï¼Œåœ¨æ¶ˆæ¯å¤„ç†å‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
ğŸ”¸ æ‹¦æˆªå™¨é“¾ï¼šå¤šä¸ªæ‹¦æˆªå™¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œå½¢æˆå¤„ç†ç®¡é“
ğŸ”¸ æ’ä»¶åŒ–æ¶æ„ï¼šå¯æ’æ‹”çš„åŠŸèƒ½æ¨¡å—ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
ğŸ”¸ ç›‘æ§é›†æˆï¼šå®æ—¶æ”¶é›†æ¶ˆè´¹æ€§èƒ½æ•°æ®ï¼Œæ”¯æŒè¿ç»´å†³ç­–
ğŸ”¸ æ¶ˆæ¯å¤„ç†ï¼šè¿‡æ»¤ã€è½¬æ¢ã€éªŒè¯ç­‰æ¶ˆæ¯é¢„å¤„ç†åŠŸèƒ½
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦Consumeræ‰©å±•**
```
ä¸šåŠ¡éœ€æ±‚é©±åŠ¨ï¼š
â€¢ æ¶ˆæ¯é¢„å¤„ç†ï¼šè¿‡æ»¤åƒåœ¾æ¶ˆæ¯ï¼Œè½¬æ¢æ•°æ®æ ¼å¼
â€¢ ç›‘æ§è¿ç»´ï¼šå®æ—¶æŒæ¡æ¶ˆè´¹æƒ…å†µï¼Œå¿«é€Ÿå®šä½é—®é¢˜
â€¢ å®‰å…¨åˆè§„ï¼šæ•æ„Ÿä¿¡æ¯è„±æ•ï¼Œå®¡è®¡æ—¥å¿—è®°å½•
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡å¤„ç†ï¼Œèµ„æºä½¿ç”¨ç›‘æ§
```

**ğŸ”¹ æ‹¦æˆªå™¨é“¾çš„æ‰§è¡Œé¡ºåº**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ è½»é‡çº§æ“ä½œä¼˜å…ˆï¼šæ—¥å¿—è®°å½• â†’ ç›‘æ§ç»Ÿè®¡
â€¢ æ•°æ®å¤„ç†å±…ä¸­ï¼šè¿‡æ»¤ â†’ è½¬æ¢ â†’ éªŒè¯
â€¢ å¼‚å¸¸å®‰å…¨è®¾è®¡ï¼šæ¯ä¸ªæ‹¦æˆªå™¨ç‹¬ç«‹ï¼Œäº’ä¸å½±å“
```

**ğŸ”¹ æ€§èƒ½å½±å“æ§åˆ¶**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ å¼‚æ­¥å¤„ç†ï¼šç›‘æ§æ•°æ®å¼‚æ­¥ä¸ŠæŠ¥
â€¢ æ‰¹é‡æ“ä½œï¼šå‡å°‘é¢‘ç¹çš„å¤–éƒ¨è°ƒç”¨
â€¢ ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è®¡ç®—
â€¢ é™çº§ç­–ç•¥ï¼šæ‹¦æˆªå™¨å¼‚å¸¸æ—¶è‡ªåŠ¨è·³è¿‡
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**ï¼š
- **æ•°æ®ä¸­å°**ï¼šç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼Œæ•°æ®è´¨é‡ç›‘æ§
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´é€šä¿¡ç›‘æ§ï¼Œé“¾è·¯è¿½è¸ª
- **é£æ§ç³»ç»Ÿ**ï¼šå®æ—¶æ¶ˆæ¯è¿‡æ»¤ï¼Œå¼‚å¸¸è¡Œä¸ºæ£€æµ‹
- **è¿ç»´ç›‘æ§**ï¼šæ€§èƒ½æŒ‡æ ‡æ”¶é›†ï¼Œæ•…éšœå¿«é€Ÿå®šä½

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**ï¼š
- **æ¸è¿›å¼å¼€å‘**ï¼šå…ˆå®ç°åŸºç¡€åŠŸèƒ½ï¼Œå†é€æ­¥å¢å¼º
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªæ‹¦æˆªå™¨èŒè´£å•ä¸€ï¼Œä¾¿äºæµ‹è¯•
- **é…ç½®åŒ–ç®¡ç†**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶æ‹¦æˆªå™¨è¡Œä¸º
- **æ–‡æ¡£åŒ–**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªæ‰©å±•ç»„ä»¶çš„åŠŸèƒ½å’Œé…ç½®

### 8.4 å­¦ä¹ è·¯å¾„æŒ‡å¼•


```
ğŸ“š å­¦ä¹ è¿›é˜¶è·¯çº¿ï¼š
ç¬¬1é˜¶æ®µï¼šæŒæ¡åŸºç¡€æ‹¦æˆªå™¨å¼€å‘
ç¬¬2é˜¶æ®µï¼šç†è§£æ¶ˆæ¯è¿‡æ»¤å’Œè½¬æ¢
ç¬¬3é˜¶æ®µï¼šå®ç°ç›‘æ§æ•°æ®æ”¶é›†
ç¬¬4é˜¶æ®µï¼šæ„å»ºæ’ä»¶åŒ–æ¶æ„

ğŸ’¡ å®è·µé¡¹ç›®å»ºè®®ï¼š
â€¢ å¼€å‘ä¸€ä¸ªæ¶ˆæ¯æ—¥å¿—æ‹¦æˆªå™¨
â€¢ å®ç°åŸºäºå…³é”®è¯çš„æ¶ˆæ¯è¿‡æ»¤
â€¢ é›†æˆPrometheusç›‘æ§æŒ‡æ ‡
â€¢ æ„å»ºå¯é…ç½®çš„æ’ä»¶ç®¡ç†å™¨
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Consumeræ‰©å±•æ˜¯å¢å¼ºæ¶ˆè´¹èƒ½åŠ›çš„é‡è¦æ‰‹æ®µ
- æ‹¦æˆªå™¨é“¾æä¾›äº†çµæ´»çš„æ¶ˆæ¯å¤„ç†ç®¡é“
- æ’ä»¶åŒ–æ¶æ„æé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§
- ç›‘æ§é›†æˆæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡åŠŸèƒ½
- æ€§èƒ½å’Œç¨³å®šæ€§æ˜¯æ‰©å±•å¼€å‘çš„æ ¸å¿ƒè€ƒé‡