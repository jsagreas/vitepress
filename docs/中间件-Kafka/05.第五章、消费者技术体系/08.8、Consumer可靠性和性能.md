---
title: 8ã€Consumerå¯é æ€§å’Œæ€§èƒ½
---
## ğŸ“š ç›®å½•

1. [æ¶ˆè´¹è¯­ä¹‰ä¿è¯æœºåˆ¶](#1-æ¶ˆè´¹è¯­ä¹‰ä¿è¯æœºåˆ¶)
2. [æ¶ˆæ¯ä¸¢å¤±é¢„é˜²ç­–ç•¥](#2-æ¶ˆæ¯ä¸¢å¤±é¢„é˜²ç­–ç•¥)
3. [é‡å¤æ¶ˆè´¹å¤„ç†æ–¹æ¡ˆ](#3-é‡å¤æ¶ˆè´¹å¤„ç†æ–¹æ¡ˆ)
4. [æ¶ˆæ¯é¡ºåºæ€§ä¿è¯](#4-æ¶ˆæ¯é¡ºåºæ€§ä¿è¯)
5. [å¹¶å‘æ¶ˆè´¹ä¼˜åŒ–](#5-å¹¶å‘æ¶ˆè´¹ä¼˜åŒ–)
6. [æ‰¹é‡æ¶ˆè´¹å®è·µ](#6-æ‰¹é‡æ¶ˆè´¹å®è·µ)
7. [èƒŒå‹å¤„ç†æœºåˆ¶](#7-èƒŒå‹å¤„ç†æœºåˆ¶)
8. [æ¶ˆè´¹å»¶è¿Ÿä¼˜åŒ–](#8-æ¶ˆè´¹å»¶è¿Ÿä¼˜åŒ–)
9. [æ€§èƒ½è°ƒä¼˜å®æˆ˜](#9-æ€§èƒ½è°ƒä¼˜å®æˆ˜)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¶ˆè´¹è¯­ä¹‰ä¿è¯æœºåˆ¶


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆè´¹è¯­ä¹‰

**ç®€å•ç†è§£**ï¼šæ¶ˆè´¹è¯­ä¹‰å°±æ˜¯**"æ¶ˆæ¯å¤„ç†çš„ä¿è¯ç¨‹åº¦"**ï¼Œç±»ä¼¼äºå¿«é€’çš„ç­¾æ”¶æ–¹å¼ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
At Most Once (æœ€å¤šä¸€æ¬¡) = å¿«é€’å¯èƒ½ä¸¢å¤±ï¼Œä½†ç»ä¸é‡å¤é€è¾¾
At Least Once (è‡³å°‘ä¸€æ¬¡) = å¿«é€’ä¿è¯é€è¾¾ï¼Œä½†å¯èƒ½é‡å¤æŠ•é€’  
Exactly Once (ç²¾ç¡®ä¸€æ¬¡) = å¿«é€’ä¿è¯é€è¾¾ä¸”åªé€ä¸€æ¬¡
```

### 1.2 ä¸‰ç§è¯­ä¹‰è¯¦è§£


#### ğŸ”¸ At Most Onceï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œä½†ç»ä¸é‡å¤å¤„ç†

```
å·¥ä½œæµç¨‹ï¼š
æ¶ˆè´¹è€…è·å–æ¶ˆæ¯ â†’ ç«‹å³æäº¤offset â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘

é£é™©åœºæ™¯ï¼š
1. æäº¤offsetæˆåŠŸ
2. å¤„ç†ä¸šåŠ¡é€»è¾‘æ—¶ç¨‹åºå´©æºƒ
3. é‡å¯åæ¶ˆæ¯å·²è¢«æ ‡è®°ä¸º"å·²æ¶ˆè´¹"
4. ç»“æœï¼šæ¶ˆæ¯ä¸¢å¤±
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ“Š **å®æ—¶ç»Ÿè®¡**ï¼šå°‘é‡æ•°æ®ä¸¢å¤±å¯ä»¥å®¹å¿
- ğŸ” **æ—¥å¿—åˆ†æ**ï¼šå¶å°”ä¸¢å¤±ä¸å½±å“æ•´ä½“è¶‹åŠ¿
- ğŸ® **æ¸¸æˆæ•°æ®**ï¼šéå…³é”®æ•°æ®çš„å®æ—¶å¤„ç†

#### ğŸ”¸ At Least Onceï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆæ¯ä¿è¯è¢«å¤„ç†ï¼Œä½†å¯èƒ½é‡å¤å¤„ç†

```
å·¥ä½œæµç¨‹ï¼š
æ¶ˆè´¹è€…è·å–æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘ â†’ æäº¤offset

é£é™©åœºæ™¯ï¼š
1. ä¸šåŠ¡é€»è¾‘å¤„ç†å®Œæˆ
2. æäº¤offsetæ—¶ç½‘ç»œå¼‚å¸¸
3. é‡å¯åé‡æ–°æ¶ˆè´¹ç›¸åŒæ¶ˆæ¯
4. ç»“æœï¼šæ¶ˆæ¯é‡å¤å¤„ç†
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ’° **æ”¯ä»˜ç³»ç»Ÿ**ï¼šå¯ä»¥é€šè¿‡å¹‚ç­‰æ€§å¤„ç†é‡å¤
- ğŸ“§ **é‚®ä»¶é€šçŸ¥**ï¼šé‡å¤å‘é€æ¯”é—æ¼æ›´å¥½
- ğŸ“¦ **è®¢å•å¤„ç†**ï¼šé…åˆå¹‚ç­‰æœºåˆ¶ä½¿ç”¨

#### ğŸ”¸ Exactly Onceï¼ˆç²¾ç¡®ä¸€æ¬¡ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆæ¯è¢«ç²¾ç¡®å¤„ç†ä¸€æ¬¡ï¼Œä¸å¤šä¸å°‘

> ğŸ’¡ **é‡è¦ç†è§£**  
> Kafkaçš„Exactly Onceå®é™…æ˜¯é€šè¿‡**äº‹åŠ¡æœºåˆ¶**å®ç°çš„ï¼Œç¡®ä¿æ¶ˆè´¹-å¤„ç†-ç”Ÿäº§çš„åŸå­æ€§

```
å®ç°åŸç†ï¼š
1. æ¶ˆè´¹è€…å¯åŠ¨äº‹åŠ¡
2. æ¶ˆè´¹æ¶ˆæ¯
3. å¤„ç†ä¸šåŠ¡é€»è¾‘  
4. ç”Ÿäº§ç»“æœæ¶ˆæ¯
5. æäº¤äº‹åŠ¡ï¼ˆåŒ…å«offsetï¼‰
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ¦ **é“¶è¡Œè½¬è´¦**ï¼šé‡‘é¢å˜åŠ¨å¿…é¡»ç²¾ç¡®
- ğŸ“Š **æ•°æ®åŒæ­¥**ï¼šETLå¤„ç†ä¸èƒ½é‡å¤
- ğŸ”„ **çŠ¶æ€æœº**ï¼šçŠ¶æ€å˜æ›´å¿…é¡»ç²¾ç¡®

### 1.3 è¯­ä¹‰é€‰æ‹©æŒ‡å—


| ä¸šåŠ¡ç±»å‹ | **æ•°æ®é‡è¦æ€§** | **æ€§èƒ½è¦æ±‚** | **æ¨èè¯­ä¹‰** | **åŸå› ** |
|---------|-------------|------------|-------------|---------|
| **é‡‘èäº¤æ˜“** | `æé«˜` | `ä¸­ç­‰` | `Exactly Once` | `èµ„é‡‘å®‰å…¨ç¬¬ä¸€` |
| **ç”¨æˆ·æ—¥å¿—** | `ä½` | `æé«˜` | `At Most Once` | `æ€§èƒ½ä¼˜å…ˆï¼Œå°‘é‡ä¸¢å¤±å¯æ¥å—` |
| **è®¢å•å¤„ç†** | `é«˜` | `é«˜` | `At Least Once + å¹‚ç­‰` | `å¹³è¡¡å¯é æ€§å’Œæ€§èƒ½` |
| **å®æ—¶æ¨è** | `ä¸­ç­‰` | `æé«˜` | `At Most Once` | `å®æ—¶æ€§è¦æ±‚é«˜` |

---

## 2. ğŸ›¡ï¸ æ¶ˆæ¯ä¸¢å¤±é¢„é˜²ç­–ç•¥


### 2.1 æ¶ˆæ¯ä¸¢å¤±çš„å¸¸è§åœºæ™¯


```
æ¶ˆæ¯æµè½¬è·¯å¾„ï¼š
Producer â†’ Kafka Broker â†’ Consumer â†’ Business Logic

ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿäº§ç«¯ä¸¢å¤±   â”‚    â”‚ å­˜å‚¨ç«¯ä¸¢å¤±   â”‚    â”‚ æ¶ˆè´¹ç«¯ä¸¢å¤±   â”‚
â”‚ ç½‘ç»œå¼‚å¸¸    â”‚    â”‚ ç£ç›˜æ•…éšœ    â”‚    â”‚ ç¨‹åºå´©æºƒ    â”‚
â”‚ ç¼“å†²åŒºæ»¡    â”‚    â”‚ å‰¯æœ¬ä¸è¶³    â”‚    â”‚ å¼‚å¸¸é‡å¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¶ˆè´¹ç«¯é˜²ä¸¢å¤±é…ç½®


**ğŸ”§ æ ¸å¿ƒé…ç½®å‚æ•°**

```properties
# å…³é—­è‡ªåŠ¨æäº¤ï¼Œæ‰‹åŠ¨æ§åˆ¶offset
enable.auto.commit=false

# æ¶ˆè´¹è€…ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆå»ºè®®30ç§’ï¼‰
session.timeout.ms=30000

# å¿ƒè·³é—´éš”ï¼ˆä¼šè¯è¶…æ—¶çš„1/3ï¼‰
heartbeat.interval.ms=10000

# å•æ¬¡æ‹‰å–çš„æœ€å¤§æ¶ˆæ¯æ•°ï¼ˆé¿å…å¤„ç†è¶…æ—¶ï¼‰
max.poll.records=100

# æ‹‰å–é—´éš”çš„æœ€å¤§æ—¶é—´ï¼ˆå¤„ç†æ—¶é—´é™åˆ¶ï¼‰
max.poll.interval.ms=300000
```

**ğŸ“ é˜²ä¸¢å¤±ä»£ç æ¨¡å¼**

```java
// æ¨èçš„å®‰å…¨æ¶ˆè´¹æ¨¡å¼
public class SafeConsumer {
    private KafkaConsumer<String, String> consumer;
    
    public void safeConsume() {
        try {
            while (true) {
                // 1. æ‹‰å–æ¶ˆæ¯
                ConsumerRecords<String, String> records = 
                    consumer.poll(Duration.ofMillis(1000));
                
                // 2. å¤„ç†æ¯æ¡æ¶ˆæ¯
                for (ConsumerRecord<String, String> record : records) {
                    try {
                        // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¤„ç†
                        processMessage(record);
                        
                        // 3. æˆåŠŸåæ‰æäº¤å•æ¡æ¶ˆæ¯çš„offset
                        commitOffset(record);
                        
                    } catch (Exception e) {
                        // è®°å½•å¤±è´¥æ¶ˆæ¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ¶ˆæ¯
                        logFailedMessage(record, e);
                    }
                }
            }
        } finally {
            consumer.close();
        }
    }
    
    private void commitOffset(ConsumerRecord<String, String> record) {
        // æäº¤ç‰¹å®šæ¶ˆæ¯çš„offset
        Map<TopicPartition, OffsetAndMetadata> offsets = new HashMap<>();
        offsets.put(
            new TopicPartition(record.topic(), record.partition()),
            new OffsetAndMetadata(record.offset() + 1)
        );
        consumer.commitSync(offsets);
    }
}
```

### 2.3 æ•…éšœæ¢å¤ç­–ç•¥


**ğŸ”„ é‡è¯•æœºåˆ¶è®¾è®¡**

```
æ¶ˆæ¯å¤„ç†å¤±è´¥åçš„å¤„ç†æµç¨‹ï¼š

æ¶ˆæ¯å¤„ç†å¤±è´¥
      â†“
   ç«‹å³é‡è¯•(1-3æ¬¡)
      â†“
   ä»ç„¶å¤±è´¥ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— â†’ äººå·¥å¤„ç†
   â””â”€ å¦ â†’ æäº¤offset â†’ ç»§ç»­å¤„ç†
```

> âš ï¸ **é‡è¦æé†’**  
> ä¸è¦æ— é™é‡è¯•ï¼Œä¼šé˜»å¡åç»­æ¶ˆæ¯å¤„ç†ï¼Œå»ºè®®æœ€å¤šé‡è¯•3æ¬¡

---

## 3. ğŸ”„ é‡å¤æ¶ˆè´¹å¤„ç†æ–¹æ¡ˆ


### 3.1 ä¸ºä»€ä¹ˆä¼šé‡å¤æ¶ˆè´¹


**å¸¸è§é‡å¤æ¶ˆè´¹åœºæ™¯**ï¼š

```
åœºæ™¯1ï¼šç½‘ç»œæŠ–åŠ¨
æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯ â†’ æäº¤offsetæ—¶ç½‘ç»œè¶…æ—¶ â†’ é‡å¯åé‡æ–°æ¶ˆè´¹

åœºæ™¯2ï¼šå¤„ç†è¶…æ—¶
æ¶ˆæ¯å¤„ç†æ—¶é—´è¿‡é•¿ â†’ è¶…è¿‡max.poll.interval.ms â†’ è¢«è¸¢å‡ºæ¶ˆè´¹ç»„ â†’ é‡æ–°åˆ†é…åé‡å¤æ¶ˆè´¹

åœºæ™¯3ï¼šç¨‹åºå¼‚å¸¸
å¤„ç†æ¶ˆæ¯è¿‡ç¨‹ä¸­ç¨‹åºå´©æºƒ â†’ é‡å¯åä»ä¸Šæ¬¡æäº¤çš„offsetå¼€å§‹ â†’ é‡å¤æ¶ˆè´¹éƒ¨åˆ†æ¶ˆæ¯
```

### 3.2 å¹‚ç­‰æ€§å¤„ç†æ–¹æ¡ˆ


#### ğŸ¯ ä¸šåŠ¡å±‚å¹‚ç­‰è®¾è®¡


**æ–¹æ¡ˆ1ï¼šå”¯ä¸€é”®å»é‡**
```java
public class IdempotentProcessor {
    private Set<String> processedMessageIds = new ConcurrentHashMap<>();
    
    public void processMessage(ConsumerRecord<String, String> record) {
        String messageId = extractMessageId(record);
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
        if (processedMessageIds.contains(messageId)) {
            log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: {}", messageId);
            return;
        }
        
        try {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doBusinessLogic(record);
            
            // æ ‡è®°ä¸ºå·²å¤„ç†
            processedMessageIds.add(messageId);
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œä¸æ ‡è®°ä¸ºå·²å¤„ç†
            log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥: {}", messageId, e);
            throw e;
        }
    }
}
```

**æ–¹æ¡ˆ2ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ**
```java
// åˆ©ç”¨æ•°æ®åº“å”¯ä¸€çº¦æŸä¿è¯å¹‚ç­‰
public void processOrderMessage(OrderMessage msg) {
    try {
        // æ’å…¥è®¢å•ï¼Œå¦‚æœé‡å¤ä¼šå› å”¯ä¸€çº¦æŸå¤±è´¥
        orderService.createOrder(msg.getOrderId(), msg.getData());
        
    } catch (DuplicateKeyException e) {
        // é‡å¤æ¶ˆæ¯ï¼Œç›´æ¥å¿½ç•¥
        log.info("è®¢å•å·²å­˜åœ¨ï¼Œå¿½ç•¥é‡å¤æ¶ˆæ¯: {}", msg.getOrderId());
    }
}
```

**æ–¹æ¡ˆ3ï¼šåˆ†å¸ƒå¼é”**
```java
public class DistributedLockProcessor {
    @Autowired
    private RedisTemplate redisTemplate;
    
    public void processMessage(String messageId, String content) {
        String lockKey = "msg_lock:" + messageId;
        
        // å°è¯•è·å–åˆ†å¸ƒå¼é”
        Boolean lockAcquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", Duration.ofMinutes(5));
            
        if (!lockAcquired) {
            log.info("æ¶ˆæ¯æ­£åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡: {}", messageId);
            return;
        }
        
        try {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            doBusinessLogic(content);
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
}
```

### 3.3 å¹‚ç­‰æ–¹æ¡ˆé€‰æ‹©


| åœºæ™¯ç±»å‹ | **æ¨èæ–¹æ¡ˆ** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|---------|---------|
| **è®¢å•åˆ›å»º** | `æ•°æ®åº“å”¯ä¸€çº¦æŸ` | `ç®€å•å¯é ` | `éœ€è¦ä¸šåŠ¡IDæ”¯æŒ` |
| **æ”¯ä»˜å¤„ç†** | `åˆ†å¸ƒå¼é”` | `å¼ºä¸€è‡´æ€§` | `æ€§èƒ½ç¨å·®` |
| **æ—¥å¿—å†™å…¥** | `å†…å­˜å»é‡` | `æ€§èƒ½æœ€é«˜` | `é‡å¯åä¸¢å¤±çŠ¶æ€` |
| **çŠ¶æ€æ›´æ–°** | `ä¸šåŠ¡å¹‚ç­‰è®¾è®¡` | `æœ€è‡ªç„¶` | `éœ€è¦ä¸šåŠ¡æ”¹é€ ` |

---

## 4. ğŸ“‹ æ¶ˆæ¯é¡ºåºæ€§ä¿è¯


### 4.1 é¡ºåºæ€§çš„å±‚æ¬¡ç†è§£


```
Kafkaä¸­çš„é¡ºåºæ€§å±‚æ¬¡ï¼š

å…¨å±€é¡ºåºï¼ˆTopicçº§åˆ«ï¼‰
    â†“ å¾ˆéš¾å®ç°ï¼Œæ€§èƒ½å·®
åˆ†åŒºé¡ºåºï¼ˆPartitionçº§åˆ«ï¼‰  â† æ¨èæ–¹æ¡ˆ
    â†“ åœ¨å•ä¸ªåˆ†åŒºå†…ä¿è¯é¡ºåº
æ¶ˆè´¹è€…é¡ºåºï¼ˆConsumerçº§åˆ«ï¼‰
    â†“ æ¶ˆè´¹è€…å†…éƒ¨çš„å¤„ç†é¡ºåº
ä¸šåŠ¡é¡ºåºï¼ˆBusinessçº§åˆ«ï¼‰
    â†“ ä¸šåŠ¡é€»è¾‘çš„æ‰§è¡Œé¡ºåº
```

### 4.2 åˆ†åŒºé¡ºåºä¿è¯ç­–ç•¥


#### ğŸ¯ ç”Ÿäº§ç«¯é¡ºåºä¿è¯


```java
public class OrderedProducer {
    private KafkaProducer<String, String> producer;
    
    // å…³é”®ï¼šä½¿ç”¨ç›¸åŒçš„keyå‘é€ç›¸å…³æ¶ˆæ¯
    public void sendOrderedMessages(String userId, List<String> messages) {
        for (String message : messages) {
            ProducerRecord<String, String> record = 
                new ProducerRecord<>("user_events", 
                                   userId,    // ç›¸åŒçš„key
                                   message);
            
            // åŒæ­¥å‘é€ä¿è¯é¡ºåº
            producer.send(record).get();
        }
    }
}
```

#### ğŸ¯ æ¶ˆè´¹ç«¯é¡ºåºå¤„ç†


```java
public class OrderedConsumer {
    
    public void consumeInOrder() {
        // é‡è¦é…ç½®ï¼šæ¯æ¬¡åªæ‹‰å–ä¸€æ¡æ¶ˆæ¯
        Properties props = new Properties();
        props.put("max.poll.records", 1);  // å…³é”®é…ç½®
        
        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(props);
        
        while (true) {
            ConsumerRecords<String, String> records = 
                consumer.poll(Duration.ofMillis(1000));
                
            for (ConsumerRecord<String, String> record : records) {
                // é¡ºåºå¤„ç†æ¯æ¡æ¶ˆæ¯
                processMessageInOrder(record);
                
                // å¤„ç†å®Œæ‰æäº¤offset
                consumer.commitSync();
            }
        }
    }
}
```

### 4.3 é¡ºåºæ€§ä¸æ€§èƒ½å¹³è¡¡


> ğŸ“Š **æ€§èƒ½å½±å“åˆ†æ**  
> ä¸¥æ ¼çš„é¡ºåºæ€§ä¼šæ˜¾è‘—å½±å“æ€§èƒ½ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

```
é¡ºåºæ€§ç¨‹åº¦ vs æ€§èƒ½è¡¨ç°ï¼š

å…¨å±€é¡ºåºï¼š     â– â– â– â– â– â– â– â– â– â–  (æ€§èƒ½æŸå¤±90%)
åˆ†åŒºå†…é¡ºåºï¼š   â– â– â– â– â– â– â– â–¡â–¡â–¡ (æ€§èƒ½æŸå¤±30%)
Keyçº§é¡ºåºï¼š    â– â– â– â– â– â– â–¡â–¡â–¡â–¡ (æ€§èƒ½æŸå¤±40%)
ä¸šåŠ¡é€»è¾‘é¡ºåºï¼š â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡ (æ€§èƒ½æŸå¤±20%)
```

**é€‰æ‹©å»ºè®®**ï¼š
- ğŸ¦ **é‡‘èç³»ç»Ÿ**ï¼šåˆ†åŒºå†…é¡ºåº + ä¸šåŠ¡æ ¡éªŒ
- ğŸ›’ **ç”µå•†è®¢å•**ï¼šç”¨æˆ·ç»´åº¦åˆ†åŒºé¡ºåº
- ğŸ“± **ç”¨æˆ·è¡Œä¸º**ï¼šKeyçº§é¡ºåºå³å¯
- ğŸ“Š **æ•°æ®åˆ†æ**ï¼šå¯æ”¾å®½é¡ºåºè¦æ±‚

---

## 5. ğŸš€ å¹¶å‘æ¶ˆè´¹ä¼˜åŒ–


### 5.1 å¹¶å‘æ¶ˆè´¹æ¨¡å¼


**ğŸ”¸ å¤šçº¿ç¨‹æ¶ˆè´¹æ¨¡å¼**

```java
public class MultithreadConsumer {
    private ExecutorService executor = Executors.newFixedThreadPool(10);
    private KafkaConsumer<String, String> consumer;
    
    public void startConsume() {
        while (true) {
            ConsumerRecords<String, String> records = 
                consumer.poll(Duration.ofMillis(1000));
                
            // åˆ†æ‰¹å¹¶è¡Œå¤„ç†
            List<List<ConsumerRecord<String, String>>> batches = 
                splitIntoBatches(records, 10);
                
            List<Future<Void>> futures = new ArrayList<>();
            
            for (List<ConsumerRecord<String, String>> batch : batches) {
                Future<Void> future = executor.submit(() -> {
                    processBatch(batch);
                    return null;
                });
                futures.add(future);
            }
            
            // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
            waitForAll(futures);
            
            // ç»Ÿä¸€æäº¤offset
            consumer.commitSync();
        }
    }
}
```

**ğŸ”¸ å¤šæ¶ˆè´¹è€…å®ä¾‹æ¨¡å¼**

```
å•æœºå¤šå®ä¾‹éƒ¨ç½²ï¼š

JVM-1: Consumer-1 (å¤„ç†Partition 0,1)
JVM-2: Consumer-2 (å¤„ç†Partition 2,3)  
JVM-3: Consumer-3 (å¤„ç†Partition 4,5)

ä¼˜åŠ¿ï¼š
â€¢ æ•…éšœéš”ç¦»æ›´å¥½
â€¢ åƒåœ¾å›æ”¶å½±å“å°
â€¢ èµ„æºåˆ©ç”¨æ›´å‡åŒ€
```

### 5.2 å¹¶å‘å®‰å…¨è€ƒè™‘


> âš ï¸ **é‡è¦æé†’**  
> KafkaConsumer **ä¸æ˜¯çº¿ç¨‹å®‰å…¨**çš„ï¼Œä¸èƒ½è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨

**å®‰å…¨çš„å¹¶å‘æ¨¡å¼**ï¼š

```java
// æ¨èï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„Consumer
public class SafeConcurrentConsumer {
    
    public void startMultipleConsumers(int threadCount) {
        ExecutorService executor = Executors.newFixedThreadPool(threadCount);
        
        for (int i = 0; i < threadCount; i++) {
            executor.submit(() -> {
                // æ¯ä¸ªçº¿ç¨‹åˆ›å»ºè‡ªå·±çš„Consumer
                KafkaConsumer<String, String> consumer = createConsumer();
                
                while (true) {
                    ConsumerRecords<String, String> records = 
                        consumer.poll(Duration.ofMillis(1000));
                    
                    processRecords(records);
                    consumer.commitSync();
                }
            });
        }
    }
}
```

### 5.3 å¹¶å‘åº¦è°ƒä¼˜æŒ‡å—


```
å¹¶å‘åº¦è®¡ç®—å…¬å¼ï¼š
æœ€ä¼˜çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— (1 + IOç­‰å¾…æ—¶é—´/CPUè®¡ç®—æ—¶é—´)

ç¤ºä¾‹è®¡ç®—ï¼š
CPUæ ¸å¿ƒï¼š8æ ¸
ä¸šåŠ¡å¤„ç†ï¼š70% IOæ“ä½œï¼Œ30% CPUè®¡ç®—
æ¨èçº¿ç¨‹æ•°ï¼š8 Ã— (1 + 0.7/0.3) â‰ˆ 27ä¸ªçº¿ç¨‹
```

| ä¸šåŠ¡ç‰¹ç‚¹ | **IOæ¯”ä¾‹** | **æ¨èå¹¶å‘åº¦** | **è¯´æ˜** |
|---------|-----------|---------------|---------|
| **çº¯è®¡ç®—** | `< 20%` | `CPUæ ¸å¿ƒæ•° Ã— 1.2` | `é¿å…è¿‡åº¦åˆ‡æ¢` |
| **æ•°æ®åº“æŸ¥è¯¢** | `60-80%` | `CPUæ ¸å¿ƒæ•° Ã— 3` | `IOç­‰å¾…æ—¶é—´é•¿` |
| **HTTPè°ƒç”¨** | `80-90%` | `CPUæ ¸å¿ƒæ•° Ã— 5` | `ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜` |
| **æ–‡ä»¶æ“ä½œ** | `50-70%` | `CPUæ ¸å¿ƒæ•° Ã— 2` | `ç£ç›˜IOä¸­ç­‰` |

---

## 6. ğŸ“¦ æ‰¹é‡æ¶ˆè´¹å®è·µ


### 6.1 æ‰¹é‡æ¶ˆè´¹çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆè¦æ‰¹é‡æ¶ˆè´¹ï¼Ÿ**

```
å•æ¡æ¶ˆè´¹ vs æ‰¹é‡æ¶ˆè´¹ï¼š

å•æ¡æ¶ˆè´¹ï¼š
æ¶ˆæ¯1 â†’ å¤„ç† â†’ æäº¤ â†’ æ¶ˆæ¯2 â†’ å¤„ç† â†’ æäº¤ â†’ ...
å»¶è¿Ÿï¼šä½    ååé‡ï¼šä½    èµ„æºå¼€é”€ï¼šé«˜

æ‰¹é‡æ¶ˆè´¹ï¼š
æ¶ˆæ¯1,2,3...N â†’ æ‰¹é‡å¤„ç† â†’ æ‰¹é‡æäº¤
å»¶è¿Ÿï¼šç¨é«˜  ååé‡ï¼šé«˜   èµ„æºå¼€é”€ï¼šä½
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
- ğŸ”¥ **ååé‡æå‡**ï¼š5-10å€æ€§èƒ½æå‡
- ğŸ’¾ **èµ„æºèŠ‚çœ**ï¼šå‡å°‘ç½‘ç»œå’Œç£ç›˜IO
- âš¡ **å»¶è¿Ÿå¢åŠ **ï¼šæ‰¹é‡å¤§å° Ã— å•æ¡å¤„ç†æ—¶é—´

### 6.2 æ‰¹é‡æ¶ˆè´¹å®ç°


```java
public class BatchConsumer {
    private static final int BATCH_SIZE = 100;
    private static final int BATCH_TIMEOUT_MS = 5000;
    
    public void batchConsume() {
        List<ConsumerRecord<String, String>> batch = new ArrayList<>();
        long batchStartTime = System.currentTimeMillis();
        
        while (true) {
            ConsumerRecords<String, String> records = 
                consumer.poll(Duration.ofMillis(100));
                
            for (ConsumerRecord<String, String> record : records) {
                batch.add(record);
                
                // æ‰¹é‡å¤§å°è¾¾åˆ°é˜ˆå€¼æˆ–è¶…æ—¶
                if (batch.size() >= BATCH_SIZE || 
                    System.currentTimeMillis() - batchStartTime > BATCH_TIMEOUT_MS) {
                    
                    processBatch(batch);
                    commitBatchOffsets(batch);
                    
                    // é‡ç½®æ‰¹é‡
                    batch.clear();
                    batchStartTime = System.currentTimeMillis();
                }
            }
        }
    }
    
    private void processBatch(List<ConsumerRecord<String, String>> batch) {
        // æ‰¹é‡å¤„ç†ä¸šåŠ¡é€»è¾‘
        // ä¾‹å¦‚ï¼šæ‰¹é‡æ’å…¥æ•°æ®åº“
        List<String> values = batch.stream()
            .map(ConsumerRecord::value)
            .collect(Collectors.toList());
            
        databaseService.batchInsert(values);
    }
}
```

### 6.3 æ‰¹é‡å¤§å°è°ƒä¼˜


**æ‰¹é‡å¤§å°é€‰æ‹©ç­–ç•¥**ï¼š

```
å†…å­˜é™åˆ¶è®¡ç®—ï¼š
æ‰¹é‡å¤§å° = å¯ç”¨å†…å­˜ / (æ¶ˆæ¯å¹³å‡å¤§å° Ã— å®‰å…¨ç³»æ•°)

ç¤ºä¾‹ï¼š
å¯ç”¨å†…å­˜ï¼š512MB
æ¶ˆæ¯å¤§å°ï¼š1KB
å®‰å…¨ç³»æ•°ï¼š2ï¼ˆè€ƒè™‘å…¶ä»–å†…å­˜å¼€é”€ï¼‰
æ‰¹é‡å¤§å°ï¼š512MB / (1KB Ã— 2) â‰ˆ 256,000æ¡

ä½†é€šå¸¸å»ºè®®ï¼š100-1000æ¡ä¹‹é—´
```

| ä¸šåŠ¡åœºæ™¯ | **æ¨èæ‰¹é‡å¤§å°** | **è¶…æ—¶æ—¶é—´** | **åŸå› ** |
|---------|----------------|-------------|---------|
| **æ•°æ®åº“å†™å…¥** | `500-1000æ¡` | `5-10ç§’` | `æ‰¹é‡æ“ä½œæ•ˆç‡é«˜` |
| **æ–‡ä»¶å†™å…¥** | `1000-5000æ¡` | `10-30ç§’` | `å‡å°‘ç£ç›˜IO` |
| **HTTPè°ƒç”¨** | `10-50æ¡` | `1-3ç§’` | `ç½‘ç»œå»¶è¿Ÿæ•æ„Ÿ` |
| **å®æ—¶è®¡ç®—** | `100-500æ¡` | `1-5ç§’` | `å¹³è¡¡å»¶è¿Ÿå’Œåå` |

---

## 7. ğŸŒŠ èƒŒå‹å¤„ç†æœºåˆ¶


### 7.1 ä»€ä¹ˆæ˜¯èƒŒå‹


**ç®€å•ç†è§£**ï¼šèƒŒå‹å°±æ˜¯**"ä¸Šæ¸¸ç”Ÿäº§å¤ªå¿«ï¼Œä¸‹æ¸¸å¤„ç†ä¸è¿‡æ¥"**çš„æƒ…å†µã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å·¥å‚ç”Ÿäº§çº¿ä¸Šï¼Œå¦‚æœåŒ…è£…å·¥äººé€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§é€Ÿåº¦ï¼Œ
å°±ä¼šé€ æˆåŠæˆå“å †ç§¯ï¼Œè¿™å°±æ˜¯èƒŒå‹ç°è±¡ã€‚

Kafkaä¸­çš„èƒŒå‹ï¼š
Produceré€Ÿåº¦ > Consumeré€Ÿåº¦ â†’ æ¶ˆæ¯å †ç§¯ â†’ å†…å­˜å‹åŠ› â†’ ç³»ç»Ÿä¸ç¨³å®š
```

### 7.2 èƒŒå‹æ£€æµ‹æŒ‡æ ‡


**ğŸ” å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```java
public class BackpressureMonitor {
    
    public void monitorConsumerLag() {
        // 1. æ¶ˆè´¹å»¶è¿Ÿæ£€æµ‹
        long consumerLag = getConsumerLag();
        if (consumerLag > MAX_ACCEPTABLE_LAG) {
            handleBackpressure();
        }
        
        // 2. å¤„ç†æ—¶é—´ç›‘æ§
        long processingTime = measureProcessingTime();
        if (processingTime > MAX_PROCESSING_TIME) {
            adjustBatchSize();
        }
        
        // 3. å†…å­˜ä½¿ç”¨æ£€æµ‹  
        long memoryUsage = getMemoryUsage();
        if (memoryUsage > MEMORY_THRESHOLD) {
            reduceConsumptionRate();
        }
    }
}
```

**ç›‘æ§é˜ˆå€¼å»ºè®®**ï¼š

```
æ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦ï¼š
ç»¿è‰²ï¼š< 1000æ¡æ¶ˆæ¯
é»„è‰²ï¼š1000-5000æ¡æ¶ˆæ¯  
çº¢è‰²ï¼š> 5000æ¡æ¶ˆæ¯

å¤„ç†æ—¶é—´å‘Šè­¦ï¼š
æ­£å¸¸ï¼š< 100ms/æ¡
è¾ƒæ…¢ï¼š100-500ms/æ¡
å¼‚å¸¸ï¼š> 500ms/æ¡
```

### 7.3 èƒŒå‹å¤„ç†ç­–ç•¥


#### ğŸ¯ åŠ¨æ€è°ƒæ•´ç­–ç•¥


```java
public class DynamicBackpressureHandler {
    private volatile int currentBatchSize = 100;
    private volatile long pollTimeout = 1000;
    
    public void handleBackpressure(long consumerLag) {
        if (consumerLag > 5000) {
            // ä¸¥é‡èƒŒå‹ï¼šå‡å°‘æ‰¹é‡å¤§å°ï¼Œå¢åŠ å¤„ç†é¢‘ç‡
            currentBatchSize = Math.max(10, currentBatchSize / 2);
            pollTimeout = Math.max(100, pollTimeout / 2);
            
        } else if (consumerLag < 100) {
            // æ— å‹åŠ›ï¼šå¯ä»¥å¢åŠ æ‰¹é‡å¤§å°æé«˜æ•ˆç‡
            currentBatchSize = Math.min(1000, currentBatchSize * 1.2);
            pollTimeout = Math.min(5000, pollTimeout * 1.2);
        }
    }
}
```

#### ğŸ¯ é™çº§å¤„ç†ç­–ç•¥


```java
public class GracefulDegradation {
    
    public void processWithDegradation(ConsumerRecord<String, String> record) {
        try {
            // æ­£å¸¸å¤„ç†é€»è¾‘
            fullProcess(record);
            
        } catch (BackpressureException e) {
            // é™çº§å¤„ç†ï¼šåªå¤„ç†æ ¸å¿ƒé€»è¾‘
            essentialProcess(record);
            
            // éæ ¸å¿ƒæ•°æ®å¼‚æ­¥å¤„ç†
            asyncQueue.offer(record);
        }
    }
    
    private void essentialProcess(ConsumerRecord<String, String> record) {
        // åªå¤„ç†æœ€é‡è¦çš„ä¸šåŠ¡é€»è¾‘
        // ä¾‹å¦‚ï¼šåªæ›´æ–°æ ¸å¿ƒçŠ¶æ€ï¼Œè·³è¿‡æ—¥å¿—å’Œç»Ÿè®¡
    }
}
```

---

## 8. âš¡ æ¶ˆè´¹å»¶è¿Ÿä¼˜åŒ–


### 8.1 å»¶è¿Ÿäº§ç”Ÿçš„åŸå› 


```
æ¶ˆè´¹å»¶è¿Ÿçš„æ„æˆï¼š
æ€»å»¶è¿Ÿ = ç½‘ç»œå»¶è¿Ÿ + åºåˆ—åŒ–å»¶è¿Ÿ + ä¸šåŠ¡å¤„ç†å»¶è¿Ÿ + æäº¤å»¶è¿Ÿ

å„éƒ¨åˆ†å æ¯”ï¼ˆå…¸å‹åœºæ™¯ï¼‰ï¼š
ç½‘ç»œå»¶è¿Ÿï¼š     â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡ (20%)
åºåˆ—åŒ–å»¶è¿Ÿï¼š   â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ (10%)  
ä¸šåŠ¡å¤„ç†å»¶è¿Ÿï¼š â– â– â– â– â– â– â– â–¡â–¡â–¡ (60%)
æäº¤å»¶è¿Ÿï¼š     â– â– â–¡â–¡â–¡â–¡â–¡â–¡â–¡â–¡ (10%)
```

### 8.2 ç½‘ç»œä¼˜åŒ–ç­–ç•¥


**ğŸ”§ å…³é”®ç½‘ç»œé…ç½®**ï¼š

```properties
# å¢å¤§æ‹‰å–æ•°æ®é‡ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
fetch.min.bytes=1024         # å•æ¬¡æ‹‰å–æœ€å°å­—èŠ‚æ•°
fetch.max.wait.ms=100       # æœ€å¤§ç­‰å¾…æ—¶é—´

# å¢å¤§æ‰¹é‡å¤§å°
max.poll.records=1000       # å•æ¬¡æ‹‰å–æœ€å¤§è®°å½•æ•°

# ç½‘ç»œç¼“å†²åŒºä¼˜åŒ–
receive.buffer.bytes=131072  # æ¥æ”¶ç¼“å†²åŒºå¤§å°
send.buffer.bytes=131072     # å‘é€ç¼“å†²åŒºå¤§å°
```

### 8.3 ä¸šåŠ¡å¤„ç†ä¼˜åŒ–


#### ğŸ¯ å¼‚æ­¥å¤„ç†æ¨¡å¼


```java
public class AsyncConsumer {
    private ExecutorService businessExecutor = 
        Executors.newFixedThreadPool(20);
    private CompletionService<Void> completionService = 
        new ExecutorCompletionService<>(businessExecutor);
    
    public void consumeAsync() {
        List<Future<Void>> pendingTasks = new ArrayList<>();
        
        while (true) {
            ConsumerRecords<String, String> records = 
                consumer.poll(Duration.ofMillis(100));
            
            // å¼‚æ­¥å¤„ç†æ¯æ¡æ¶ˆæ¯
            for (ConsumerRecord<String, String> record : records) {
                Future<Void> task = businessExecutor.submit(() -> {
                    processMessage(record);
                    return null;
                });
                pendingTasks.add(task);
            }
            
            // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå†æäº¤offset
            waitForCompletion(pendingTasks);
            consumer.commitSync();
            pendingTasks.clear();
        }
    }
}
```

#### ğŸ¯ é¢„å¤„ç†ä¼˜åŒ–


```java
public class PreprocessingConsumer {
    private Map<String, Object> preprocessCache = new ConcurrentHashMap<>();
    
    public void processWithPreprocessing(ConsumerRecord<String, String> record) {
        String key = record.key();
        
        // å°è¯•ä»ç¼“å­˜è·å–é¢„å¤„ç†æ•°æ®
        Object preprocessedData = preprocessCache.get(key);
        
        if (preprocessedData == null) {
            // æ‰§è¡Œé¢„å¤„ç†
            preprocessedData = doPreprocessing(record.value());
            preprocessCache.put(key, preprocessedData);
        }
        
        // ä½¿ç”¨é¢„å¤„ç†æ•°æ®è¿›è¡Œä¸šåŠ¡é€»è¾‘
        doBusinessLogic(preprocessedData);
    }
}
```

### 8.4 å»¶è¿Ÿä¼˜åŒ–æ•ˆæœå¯¹æ¯”


| ä¼˜åŒ–æ–¹æ¡ˆ | **å»¶è¿Ÿæ”¹å–„** | **å®ç°éš¾åº¦** | **èµ„æºæ¶ˆè€—** |
|---------|-------------|-------------|-------------|
| **ç½‘ç»œé…ç½®ä¼˜åŒ–** | `20-30%` | `â­` | `ä½` |
| **æ‰¹é‡å¤„ç†** | `50-80%` | `â­â­` | `ä¸­` |
| **å¼‚æ­¥å¤„ç†** | `40-60%` | `â­â­â­` | `é«˜` |
| **ç¼“å­˜é¢„å¤„ç†** | `30-50%` | `â­â­â­â­` | `ä¸­` |
| **ä¸šåŠ¡é€»è¾‘ä¼˜åŒ–** | `60-90%` | `â­â­â­â­â­` | `ä½` |

---

## 9. ğŸ”§ æ€§èƒ½è°ƒä¼˜å®æˆ˜


### 9.1 æ¶ˆè´¹è€…é…ç½®è°ƒä¼˜


**ğŸ¯ é«˜æ€§èƒ½é…ç½®æ¨¡æ¿**ï¼š

```properties
# === æ ¸å¿ƒæ€§èƒ½é…ç½® ===
# æ‰¹é‡å¤§å°ï¼ˆæ ¹æ®æ¶ˆæ¯å¤§å°è°ƒæ•´ï¼‰
max.poll.records=1000

# æ‹‰å–é…ç½®ï¼ˆå¹³è¡¡å»¶è¿Ÿå’Œååï¼‰
fetch.min.bytes=1024
fetch.max.wait.ms=100
fetch.max.bytes=52428800

# ç½‘ç»œé…ç½®ï¼ˆæ ¹æ®ç½‘ç»œç¯å¢ƒè°ƒæ•´ï¼‰
receive.buffer.bytes=262144
send.buffer.bytes=131072

# === å¯é æ€§é…ç½® ===
# æ‰‹åŠ¨æäº¤æ¨¡å¼
enable.auto.commit=false

# ä¼šè¯ç®¡ç†
session.timeout.ms=30000
heartbeat.interval.ms=10000
max.poll.interval.ms=600000

# === JVMè°ƒä¼˜é…ç½® ===
# è®¾ç½®åˆé€‚çš„å †å†…å­˜
-Xms4g -Xmx4g

# ä¼˜åŒ–åƒåœ¾å›æ”¶
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
```

### 9.2 JVMå±‚é¢ä¼˜åŒ–


**ğŸ”§ å†…å­˜é…ç½®ç­–ç•¥**ï¼š

```bash
# æ¶ˆè´¹è€…JVMä¼˜åŒ–å‚æ•°
-Xms8g -Xmx8g                    # å›ºå®šå †å†…å­˜å¤§å°
-XX:+UseG1GC                      # ä½¿ç”¨G1åƒåœ¾å›æ”¶å™¨  
-XX:MaxGCPauseMillis=100         # æœ€å¤§GCæš‚åœæ—¶é—´
-XX:G1HeapRegionSize=16m         # G1åŒºåŸŸå¤§å°
-XX:+UnlockExperimentalVMOptions
-XX:+UseJVMCICompiler            # å¯ç”¨JVMCIç¼–è¯‘å™¨

# ç›‘æ§å‚æ•°
-XX:+PrintGC                      # æ‰“å°GCä¿¡æ¯
-XX:+PrintGCDetails              # è¯¦ç»†GCä¿¡æ¯
-Xloggc:/path/to/gc.log          # GCæ—¥å¿—è·¯å¾„
```

### 9.3 ä¸šåŠ¡å±‚é¢ä¼˜åŒ–


#### ğŸ¯ æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–


```java
@Configuration
public class DatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // è¿æ¥æ± å¤§å°ï¼ˆå»ºè®®ï¼šCPUæ ¸å¿ƒæ•° Ã— 2ï¼‰
        config.setMaximumPoolSize(16);
        config.setMinimumIdle(4);
        
        // è¿æ¥è¶…æ—¶é…ç½®
        config.setConnectionTimeout(3000);
        config.setIdleTimeout(600000);
        config.setMaxLifetime(1800000);
        
        // æ€§èƒ½ä¼˜åŒ–
        config.setLeakDetectionThreshold(60000);
        config.setprepStmtCacheSize(250);
        config.setPrepStmtCacheSqlLimit(2048);
        
        return new HikariDataSource(config);
    }
}
```

#### ğŸ¯ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


```java
public class CacheOptimizedProcessor {
    
    @Cacheable(value = "userCache", unless = "#result == null")
    public User getUser(String userId) {
        return userService.findById(userId);
    }
    
    @Async("taskExecutor")
    public CompletableFuture<Void> processAsync(String message) {
        // å¼‚æ­¥å¤„ç†éæ ¸å¿ƒé€»è¾‘
        return CompletableFuture.runAsync(() -> {
            doNonCriticalProcessing(message);
        });
    }
}
```

### 9.4 ç›‘æ§å’Œè°ƒä¼˜æŒ‡æ ‡


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

```java
public class PerformanceMetrics {
    
    // ååé‡æŒ‡æ ‡
    private MeterRegistry meterRegistry;
    
    public void recordMetrics(long processingTime, int messageCount) {
        // è®°å½•å¤„ç†é€Ÿåº¦
        meterRegistry.counter("messages.processed", "count", messageCount);
        
        // è®°å½•å¤„ç†å»¶è¿Ÿ
        meterRegistry.timer("message.processing.time")
            .record(processingTime, TimeUnit.MILLISECONDS);
        
        // è®°å½•æ¶ˆè´¹å»¶è¿Ÿ
        long consumerLag = calculateConsumerLag();
        meterRegistry.gauge("consumer.lag", consumerLag);
    }
}
```

**è°ƒä¼˜ç›®æ ‡åŸºå‡†**ï¼š

```
æ€§èƒ½æŒ‡æ ‡ç›®æ ‡å€¼ï¼š

ğŸ¯ ååé‡ç›®æ ‡ï¼š
ç”Ÿäº§ç¯å¢ƒï¼š> 10,000 æ¶ˆæ¯/ç§’
å¼€å‘ç¯å¢ƒï¼š> 1,000 æ¶ˆæ¯/ç§’

â±ï¸ å»¶è¿Ÿç›®æ ‡ï¼š
P99å»¶è¿Ÿï¼š< 100ms
å¹³å‡å»¶è¿Ÿï¼š< 50ms

ğŸ“Š èµ„æºä½¿ç”¨ï¼š
CPUä½¿ç”¨ç‡ï¼š< 80%
å†…å­˜ä½¿ç”¨ç‡ï¼š< 70%
ç½‘ç»œå¸¦å®½ï¼š< 60%

ğŸ” ä¸šåŠ¡æŒ‡æ ‡ï¼š
æ¶ˆè´¹å»¶è¿Ÿï¼š< 1000æ¡æ¶ˆæ¯
é”™è¯¯ç‡ï¼š< 0.1%
é‡å¤ç‡ï¼š< 0.01%
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶ˆè´¹è¯­ä¹‰ï¼šAt Most Onceã€At Least Onceã€Exactly Onceçš„é€‚ç”¨åœºæ™¯
ğŸ”¸ é˜²ä¸¢å¤±ç­–ç•¥ï¼šæ‰‹åŠ¨æäº¤offset + å¼‚å¸¸å¤„ç† + é‡è¯•æœºåˆ¶
ğŸ”¸ å¹‚ç­‰å¤„ç†ï¼šä¸šåŠ¡å±‚å»é‡ + æ•°æ®åº“çº¦æŸ + åˆ†å¸ƒå¼é”
ğŸ”¸ é¡ºåºä¿è¯ï¼šåˆ†åŒºçº§é¡ºåº + åŒæ­¥æ¶ˆè´¹ + Keyè·¯ç”±ç­–ç•¥
ğŸ”¸ å¹¶å‘ä¼˜åŒ–ï¼šå¤šçº¿ç¨‹æ¶ˆè´¹ + æ‰¹é‡å¤„ç† + èµ„æºéš”ç¦»
ğŸ”¸ èƒŒå‹å¤„ç†ï¼šåŠ¨æ€è°ƒæ•´ + é™çº§ç­–ç•¥ + ç›‘æ§å‘Šè­¦
ğŸ”¸ æ€§èƒ½è°ƒä¼˜ï¼šé…ç½®ä¼˜åŒ– + JVMè°ƒä¼˜ + ä¸šåŠ¡ä¼˜åŒ–
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¯é æ€§ä¸æ€§èƒ½çš„å¹³è¡¡**
```
å¯é æ€§è¦æ±‚é«˜ï¼š
âœ… æ‰‹åŠ¨æäº¤offset
âœ… åŒæ­¥å¤„ç†æ¶ˆæ¯
âœ… å®Œæ•´å¼‚å¸¸å¤„ç†
âœ… é‡è¯•å’Œè¡¥å¿æœºåˆ¶

æ€§èƒ½è¦æ±‚é«˜ï¼š
âœ… æ‰¹é‡æ¶ˆè´¹å¤„ç†
âœ… å¼‚æ­¥ä¸šåŠ¡é€»è¾‘
âœ… é€‚å½“çš„å¹¶å‘åº¦
âœ… ç¼“å­˜å’Œé¢„å¤„ç†
```

**ğŸ”¹ æ¶ˆè´¹æ¨¡å¼é€‰æ‹©ç­–ç•¥**
```
é‡‘èæ”¯ä»˜ï¼šExactly Once + åŒæ­¥å¤„ç† + ä¸¥æ ¼å¹‚ç­‰
ç”µå•†è®¢å•ï¼šAt Least Once + æ‰¹é‡å¤„ç† + ä¸šåŠ¡å¹‚ç­‰  
ç”¨æˆ·æ—¥å¿—ï¼šAt Most Once + é«˜å¹¶å‘ + å®¹å¿ä¸¢å¤±
å®æ—¶æ¨èï¼šAt Most Once + å¼‚æ­¥å¤„ç† + å¿«é€Ÿå“åº”
```

**ğŸ”¹ æ€§èƒ½è°ƒä¼˜çš„å±‚æ¬¡åŒ–æ–¹æ³•**
```
ç¬¬ä¸€å±‚ï¼šé…ç½®è°ƒä¼˜ï¼ˆæ”¶ç›Šå¤§ï¼Œæˆæœ¬ä½ï¼‰
ç¬¬äºŒå±‚ï¼šJVMè°ƒä¼˜ï¼ˆæ”¶ç›Šä¸­ï¼Œæˆæœ¬ä½ï¼‰
ç¬¬ä¸‰å±‚ï¼šæ¶æ„è°ƒä¼˜ï¼ˆæ”¶ç›Šå¤§ï¼Œæˆæœ¬é«˜ï¼‰  
ç¬¬å››å±‚ï¼šä¸šåŠ¡è°ƒä¼˜ï¼ˆæ”¶ç›Šæœ€å¤§ï¼Œæˆæœ¬æœ€é«˜ï¼‰
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
- **ç›‘æ§å…ˆè¡Œ**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æ¸è¿›ä¼˜åŒ–**ï¼šä»é…ç½®å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°æ¶æ„å’Œä¸šåŠ¡å±‚
- **æ•…éšœé¢„æ¡ˆ**ï¼šå‡†å¤‡é™çº§æ–¹æ¡ˆï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®ä¸šåŠ¡å¢é•¿é¢„ä¼°èµ„æºéœ€æ±‚

**ğŸ”§ å¼€å‘é˜¶æ®µæ³¨æ„äº‹é¡¹**
- **å¹‚ç­‰è®¾è®¡**ï¼šä¸šåŠ¡é€»è¾‘å¤©ç„¶æ”¯æŒå¹‚ç­‰æ“ä½œ
- **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **èµ„æºç®¡ç†**ï¼šåˆç†çš„è¿æ¥æ± å’Œçº¿ç¨‹æ± é…ç½®
- **æ€§èƒ½æµ‹è¯•**ï¼šå‹æµ‹éªŒè¯æ€§èƒ½æŒ‡æ ‡

**ğŸ“Š è¿ç»´ç›‘æ§è¦ç‚¹**
- **æ ¸å¿ƒæŒ‡æ ‡**ï¼šæ¶ˆè´¹å»¶è¿Ÿã€å¤„ç†é€Ÿåº¦ã€é”™è¯¯ç‡
- **å‘Šè­¦é˜ˆå€¼**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è®¾ç½®åˆç†é˜ˆå€¼
- **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•å¤„ç†è¿‡ç¨‹å’Œå¼‚å¸¸æƒ…å†µ
- **å®¹é‡ç›‘æ§**ï¼šCPUã€å†…å­˜ã€ç½‘ç»œã€ç£ç›˜ä½¿ç”¨æƒ…å†µ

### 10.4 é—®é¢˜æ’æŸ¥æ€è·¯


```
æ¶ˆè´¹è€…é—®é¢˜è¯Šæ–­æµç¨‹ï¼š

æ€§èƒ½é—®é¢˜ï¼š
1. æ£€æŸ¥æ¶ˆè´¹å»¶è¿Ÿ â†’ 
2. åˆ†æå¤„ç†ç“¶é¢ˆ â†’ 
3. ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ â†’ 
4. è°ƒæ•´é…ç½®å‚æ•°

å¯é æ€§é—®é¢˜ï¼š
1. æ£€æŸ¥æ¶ˆæ¯ä¸¢å¤± â†’ 
2. éªŒè¯å¹‚ç­‰å¤„ç† â†’ 
3. å®Œå–„å¼‚å¸¸å¤„ç† â†’ 
4. åŠ å¼ºç›‘æ§å‘Šè­¦

èµ„æºé—®é¢˜ï¼š
1. ç›‘æ§ç³»ç»Ÿèµ„æº â†’ 
2. åˆ†æç“¶é¢ˆç‚¹ â†’ 
3. ä¼˜åŒ–èµ„æºé…ç½® â†’ 
4. æ‰©å®¹æˆ–é™çº§
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ¶ˆè´¹è€…çš„å¯é æ€§å’Œæ€§èƒ½éœ€è¦å¹³è¡¡è€ƒè™‘
- é…ç½®ä¼˜åŒ–æ˜¯æ€§èƒ½æå‡çš„ç¬¬ä¸€æ­¥
- ä¸šåŠ¡å±‚é¢çš„è®¾è®¡å¯¹æ•´ä½“æ•ˆæœå½±å“æœ€å¤§
- ç›‘æ§å’Œå‘Šè­¦æ˜¯ç”Ÿäº§ç¯å¢ƒçš„åŸºç¡€ä¿éšœ
- å¹‚ç­‰å¤„ç†æ˜¯å¤„ç†é‡å¤æ¶ˆè´¹çš„æ ¹æœ¬æ–¹æ¡ˆ