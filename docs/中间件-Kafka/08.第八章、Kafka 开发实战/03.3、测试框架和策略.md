---
title: 3ã€æµ‹è¯•æ¡†æ¶å’Œç­–ç•¥
---
## ğŸ“š ç›®å½•


1. [Kafkaæµ‹è¯•åŸºç¡€æ¦‚å¿µ](#1-kafkaæµ‹è¯•åŸºç¡€æ¦‚å¿µ)
2. [å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ](#2-å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ)
3. [é›†æˆæµ‹è¯•æ¡†æ¶è¯¦è§£](#3-é›†æˆæµ‹è¯•æ¡†æ¶è¯¦è§£)
4. [TestContainerså®æˆ˜åº”ç”¨](#4-testcontainerså®æˆ˜åº”ç”¨)
5. [Embedded Kafkaæµ‹è¯•ç¯å¢ƒ](#5-embedded-kafkaæµ‹è¯•ç¯å¢ƒ)
6. [Mockç­–ç•¥å’Œå·¥å…·ä½¿ç”¨](#6-mockç­–ç•¥å’Œå·¥å…·ä½¿ç”¨)
7. [æ€§èƒ½æµ‹è¯•æ–¹æ³•](#7-æ€§èƒ½æµ‹è¯•æ–¹æ³•)
8. [æµ‹è¯•æ•°æ®ç®¡ç†ç­–ç•¥](#8-æµ‹è¯•æ•°æ®ç®¡ç†ç­–ç•¥)
9. [æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆ](#9-æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# 1. ğŸ¯ Kafkaæµ‹è¯•åŸºç¡€æ¦‚å¿µ



## 1.1 ä¸ºä»€ä¹ˆKafkaéœ€è¦ç‰¹æ®Šçš„æµ‹è¯•æ–¹æ³•



**ç†è§£Kafkaçš„å¤æ‚æ€§**ï¼š
```
ä¼ ç»Ÿåº”ç”¨æµ‹è¯•ï¼š
è¾“å…¥ â†’ å¤„ç† â†’ è¾“å‡º

Kafkaåº”ç”¨æµ‹è¯•ï¼š
ç”Ÿäº§è€… â†’ Kafkaé›†ç¾¤ â†’ æ¶ˆè´¹è€…
   â†“        â†“         â†“
 ç½‘ç»œå»¶è¿Ÿ  åˆ†åŒºç­–ç•¥   æ¶ˆè´¹ç»„
 åºåˆ—åŒ–   å‰¯æœ¬åŒæ­¥   åç§»é‡
 é‡è¯•æœºåˆ¶  æ•…éšœæ¢å¤   æ¶ˆè´¹é¡ºåº
```

ğŸ”¥ **æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- **å¼‚æ­¥ç‰¹æ€§**ï¼šæ¶ˆæ¯å‘é€å’Œæ¥æ”¶ä¸æ˜¯åŒæ­¥çš„
- **åˆ†å¸ƒå¼ç¯å¢ƒ**ï¼šå¤šä¸ªç»„ä»¶ååŒå·¥ä½œ
- **çŠ¶æ€ç®¡ç†**ï¼šåç§»é‡ã€åˆ†åŒºåˆ†é…ç­‰çŠ¶æ€
- **æ—¶åºé—®é¢˜**ï¼šæ¶ˆæ¯é¡ºåºã€é‡å¤æ¶ˆè´¹ç­‰

## 1.2 Kafkaæµ‹è¯•çš„å±‚æ¬¡åˆ’åˆ†



â­ **æµ‹è¯•é‡‘å­—å¡”åœ¨Kafkaä¸­çš„åº”ç”¨**ï¼š

```
           /\
          /  \        E2Eæµ‹è¯• (å°‘é‡)
         /____\       â†‘ å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
        /      \
       /        \     é›†æˆæµ‹è¯• (é€‚é‡)  
      /__________\    â†‘ Kafkaç»„ä»¶äº¤äº’æµ‹è¯•
     /            \
    /              \  å•å…ƒæµ‹è¯• (å¤§é‡)
   /________________\ â†‘ ä¸šåŠ¡é€»è¾‘æµ‹è¯•
```

**å„å±‚æµ‹è¯•é‡ç‚¹**ï¼š

ğŸŸ¢ **å•å…ƒæµ‹è¯•**ï¼š
- ä¸šåŠ¡é€»è¾‘éªŒè¯
- æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- é…ç½®å‚æ•°æ ¡éªŒ

ğŸŸ¡ **é›†æˆæµ‹è¯•**ï¼š
- Producer/Consumeräº¤äº’
- é”™è¯¯å¤„ç†æœºåˆ¶
- é‡è¯•å’Œå¹‚ç­‰æ€§

ğŸ”´ **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼š
- å®Œæ•´ä¸šåŠ¡æµç¨‹
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- æ•…éšœæ¢å¤æµ‹è¯•

---

# 2. âœ… å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ



## 2.1 Producerå•å…ƒæµ‹è¯•



**æ ¸å¿ƒæ€è·¯**ï¼šåªæµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼Œä¸æµ‹è¯•Kafkaè¿æ¥

```java
// ä¼˜ç§€çš„Produceræµ‹è¯•ç¤ºä¾‹
@Test
public void testMessageSerialization() {
    // ğŸ¯ æµ‹è¯•é‡ç‚¹ï¼šæ¶ˆæ¯æ ¼å¼åŒ–é€»è¾‘
    OrderEvent order = new OrderEvent("123", "CREATED");
    
    // ä½¿ç”¨çœŸå®çš„åºåˆ—åŒ–å™¨æµ‹è¯•
    String serialized = orderEventSerializer.serialize(order);
    
    // éªŒè¯åºåˆ—åŒ–ç»“æœ
    assertThat(serialized).contains("123");
    assertThat(serialized).contains("CREATED");
}

@Test 
public void testMessageKeyGeneration() {
    // ğŸ¯ æµ‹è¯•é‡ç‚¹ï¼šåˆ†åŒºé”®ç”Ÿæˆé€»è¾‘
    OrderEvent order = new OrderEvent("user123", "CREATED");
    
    String partitionKey = messageKeyGenerator.generateKey(order);
    
    // éªŒè¯åˆ†åŒºé”®è§„åˆ™
    assertThat(partitionKey).isEqualTo("user123");
}
```

ğŸ’¡ **å•å…ƒæµ‹è¯•è¦ç‚¹**ï¼š
- **ä¸“æ³¨ä¸šåŠ¡é€»è¾‘**ï¼šä¸è¦æµ‹è¯•Kafkaæœ¬èº«çš„åŠŸèƒ½
- **å¿«é€Ÿæ‰§è¡Œ**ï¼šä¸ä¾èµ–å¤–éƒ¨Kafkaå®ä¾‹
- **éš”ç¦»æ€§å¼º**ï¼šæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œ

## 2.2 Consumerå•å…ƒæµ‹è¯•



```java
@Test
public void testMessageProcessing() {
    // ğŸ¯ æµ‹è¯•é‡ç‚¹ï¼šæ¶ˆæ¯å¤„ç†é€»è¾‘
    String rawMessage = """
        {
            "orderId": "123",
            "status": "PAID"
        }
        """;
    
    // æ¨¡æ‹Ÿæ¶ˆè´¹åˆ°çš„æ¶ˆæ¯
    ConsumerRecord<String, String> record = 
        new ConsumerRecord<>("orders", 0, 0, "key", rawMessage);
    
    // æ‰§è¡Œå¤„ç†é€»è¾‘
    orderProcessor.process(record);
    
    // éªŒè¯å¤„ç†ç»“æœ
    verify(orderService).updateOrderStatus("123", "PAID");
}
```

**æµ‹è¯•è¦†ç›–è¦ç‚¹**ï¼š
- âœ… æ­£å¸¸æ¶ˆæ¯å¤„ç†æµç¨‹
- âœ… å¼‚å¸¸æ¶ˆæ¯å¤„ç†ï¼ˆæ ¼å¼é”™è¯¯ã€ä¸šåŠ¡å¼‚å¸¸ï¼‰
- âœ… å¹‚ç­‰æ€§éªŒè¯
- âœ… æ‰¹é‡å¤„ç†é€»è¾‘

---

# 3. ğŸ”§ é›†æˆæµ‹è¯•æ¡†æ¶è¯¦è§£



## 3.1 Spring Kafka Testæ¡†æ¶



**æ¡†æ¶ä¼˜åŠ¿**ï¼š
- ä¸Spring Bootæ— ç¼é›†æˆ
- æä¾›æµ‹è¯•å·¥å…·ç±»
- æ”¯æŒé…ç½®çµæ´»åˆ‡æ¢

```java
@SpringBootTest
@EmbeddedKafka(partitions = 1, topics = {"test-topic"})
class KafkaIntegrationTest {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    @Autowired
    private OrderService orderService;
    
    @Test
    public void testOrderProcessing() throws Exception {
        // ğŸ¯ çœŸå®çš„Producer-Consumeräº¤äº’æµ‹è¯•
        
        // 1. å‘é€æ¶ˆæ¯
        kafkaTemplate.send("test-topic", "order-123", 
                          """
                          {
                              "orderId": "123",
                              "amount": 99.99
                          }
                          """);
        
        // 2. ç­‰å¾…æ¶ˆè´¹å®Œæˆ
        Thread.sleep(1000); // å®é™…é¡¹ç›®ç”¨CountDownLatch
        
        // 3. éªŒè¯ä¸šåŠ¡ç»“æœ
        Order order = orderService.findById("123");
        assertThat(order.getAmount()).isEqualTo(99.99);
    }
}
```

## 3.2 é›†æˆæµ‹è¯•çš„åŒæ­¥åŒ–å¤„ç†



**å¼‚æ­¥è½¬åŒæ­¥çš„æŠ€å·§**ï¼š

```java
@Component
public class TestMessageCollector {
    private final Map<String, List<String>> collectedMessages = new ConcurrentHashMap<>();
    private final Map<String, CountDownLatch> latches = new ConcurrentHashMap<>();
    
    @EventListener
    public void onMessageReceived(MessageReceivedEvent event) {
        String topic = event.getTopic();
        String message = event.getMessage();
        
        // æ”¶é›†æ¶ˆæ¯
        collectedMessages.computeIfAbsent(topic, k -> new ArrayList<>())
                         .add(message);
        
        // é‡Šæ”¾ç­‰å¾…
        CountDownLatch latch = latches.get(topic);
        if (latch != null) {
            latch.countDown();
        }
    }
    
    public boolean waitForMessage(String topic, int expectedCount, 
                                 long timeout, TimeUnit unit) {
        CountDownLatch latch = new CountDownLatch(expectedCount);
        latches.put(topic, latch);
        
        try {
            return latch.await(timeout, unit);
        } catch (InterruptedException e) {
            return false;
        }
    }
}
```

---

# 4. ğŸ³ TestContainerså®æˆ˜åº”ç”¨



## 4.1 ä»€ä¹ˆæ˜¯TestContainers



**ç®€å•ç†è§£**ï¼šTestContainerså°±æ˜¯ç”¨ä»£ç å¯åŠ¨Dockerå®¹å™¨æ¥åšæµ‹è¯•

```
ä¼ ç»Ÿæµ‹è¯•é—®é¢˜ï¼š
â€¢ éœ€è¦æ‰‹åŠ¨å¯åŠ¨Kafka
â€¢ ç¯å¢ƒä¸ä¸€è‡´
â€¢ æµ‹è¯•æ±¡æŸ“

TestContainersè§£å†³æ–¹æ¡ˆï¼š
â€¢ è‡ªåŠ¨å¯åŠ¨Kafkaå®¹å™¨
â€¢ ç¯å¢ƒæ ‡å‡†åŒ–
â€¢ æµ‹è¯•éš”ç¦»
```

## 4.2 TestContainersåŸºç¡€é…ç½®



```java
@Testcontainers
public class KafkaTestContainersTest {
    
    @Container
    static KafkaContainer kafka = new KafkaContainer(DockerImageName.parse("confluentinc/cp-kafka:latest"))
            .withExposedPorts(9093)  // æš´éœ²ç«¯å£
            .withEnv("KAFKA_AUTO_CREATE_TOPICS_ENABLE", "true"); // è‡ªåŠ¨åˆ›å»ºä¸»é¢˜
    
    private KafkaProducer<String, String> producer;
    private KafkaConsumer<String, String> consumer;
    
    @BeforeEach
    void setUp() {
        // ğŸ¯ é‡ç‚¹ï¼šä½¿ç”¨å®¹å™¨æä¾›çš„è¿æ¥ä¿¡æ¯
        String bootstrapServers = kafka.getBootstrapServers();
        
        // é…ç½®Producer
        Properties producerProps = new Properties();
        producerProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        producer = new KafkaProducer<>(producerProps);
        
        // é…ç½®Consumer
        Properties consumerProps = new Properties();
        consumerProps.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        consumerProps.put(ConsumerConfig.GROUP_ID_CONFIG, "test-group");
        consumerProps.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
        consumer = new KafkaConsumer<>(consumerProps);
    }
}
```

## 4.3 TestContainersé«˜çº§ç”¨æ³•



**å¤šå®¹å™¨ç¼–æ’**ï¼š
```java
@Testcontainers
public class KafkaEcosystemTest {
    
    // Kafkaå®¹å™¨
    @Container
    static KafkaContainer kafka = new KafkaContainer(DockerImageName.parse("confluentinc/cp-kafka:latest"));
    
    // Schema Registryå®¹å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
    @Container
    static GenericContainer<?> schemaRegistry = new GenericContainer<>("confluentinc/cp-schema-registry:latest")
            .withExposedPorts(8081)
            .withEnv("SCHEMA_REGISTRY_HOST_NAME", "schema-registry")
            .withEnv("SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS", 
                    "PLAINTEXT://" + kafka.getNetworkAliases().get(0) + ":9092")
            .dependsOn(kafka);  // ğŸ¯ é‡ç‚¹ï¼šä¾èµ–å…³ç³»
}
```

**å®¹å™¨ç½‘ç»œé…ç½®**ï¼š
- å¤šä¸ªå®¹å™¨éœ€è¦äº’ç›¸é€šä¿¡æ—¶ä½¿ç”¨`Network`
- ä½¿ç”¨`withNetworkAliases()`è®¾ç½®å®¹å™¨åˆ«å
- é€šè¿‡`dependsOn()`è®¾ç½®å¯åŠ¨é¡ºåº

---

# 5. âš¡ Embedded Kafkaæµ‹è¯•ç¯å¢ƒ



## 5.1 EmbeddedKafka vs TestContainerså¯¹æ¯”



| ç‰¹æ€§ | EmbeddedKafka | TestContainers |
|------|---------------|----------------|
| **å¯åŠ¨é€Ÿåº¦** | âš¡ å¿«é€Ÿ (è¿›ç¨‹å†…) | ğŸŒ è¾ƒæ…¢ (å®¹å™¨å¯åŠ¨) |
| **èµ„æºå ç”¨** | ğŸ’š ä½ | ğŸŸ¡ ä¸­ç­‰ |
| **ç¯å¢ƒçœŸå®æ€§** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ é«˜ (çœŸå®Kafka) |
| **ç½‘ç»œéš”ç¦»** | âŒ æ—  | âœ… å®Œå…¨éš”ç¦» |
| **å¹¶è¡Œæµ‹è¯•** | ğŸŸ¡ å—é™ | âœ… æ”¯æŒè‰¯å¥½ |

**é€‰æ‹©å»ºè®®**ï¼š
- ğŸƒ **å¿«é€Ÿåé¦ˆ** â†’ EmbeddedKafka
- ğŸ¯ **çœŸå®ç¯å¢ƒ** â†’ TestContainers

## 5.2 EmbeddedKafkaå®è·µ



```java
@ExtendWith(SpringExtension.class)
@EmbeddedKafka(
    partitions = 3,                    // åˆ†åŒºæ•°
    brokerProperties = {               // Brokeré…ç½®
        "auto.create.topics.enable=true",
        "transaction.state.log.replication.factor=1",
        "transaction.state.log.min.isr=1"
    },
    topics = {"orders", "payments"}    // é¢„åˆ›å»ºä¸»é¢˜
)
public class EmbeddedKafkaTest {
    
    @Value("${spring.embedded.kafka.brokers}")
    private String brokerAddresses;    // ğŸ¯ è‡ªåŠ¨è·å–åœ°å€
    
    @Test
    public void testMessageFlow() {
        // æµ‹è¯•é€»è¾‘...
    }
}
```

## 5.3 é…ç½®æœ€ä½³å®è·µ



**å…³é”®é…ç½®å‚æ•°**ï¼š
```
å¿…éœ€é…ç½®ï¼š
â€¢ partitions: åˆ†åŒºæ•°é‡ï¼ˆå»ºè®®>=3ï¼‰
â€¢ topics: æµ‹è¯•ä¸»é¢˜åˆ—è¡¨

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ log.flush.interval.ms=100 (å¿«é€Ÿåˆ·ç›˜)
â€¢ replica.fetch.max.wait.ms=100 (å¿«é€Ÿå¤åˆ¶)

äº‹åŠ¡æ”¯æŒï¼š
â€¢ transaction.state.log.replication.factor=1
â€¢ transaction.state.log.min.isr=1
```

---

# 6. ğŸ­ Mockç­–ç•¥å’Œå·¥å…·ä½¿ç”¨



## 6.1 Mockçš„ä½¿ç”¨åœºæ™¯



**ä»€ä¹ˆæ—¶å€™ç”¨Mock**ï¼š
```
âœ… é€‚åˆMockçš„åœºæ™¯ï¼š
â€¢ å¤–éƒ¨HTTPè°ƒç”¨
â€¢ æ•°æ®åº“æ“ä½œ
â€¢ æ–‡ä»¶ç³»ç»Ÿè®¿é—®
â€¢ å¤æ‚çš„ä¸šåŠ¡ä¾èµ–

âŒ ä¸é€‚åˆMockçš„åœºæ™¯ï¼š
â€¢ Kafka Producer/Consumeræœ¬èº«
â€¢ æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
â€¢ Kafkaé…ç½®å‚æ•°
```

## 6.2 ä¸šåŠ¡é€»è¾‘Mockç¤ºä¾‹



```java
@ExtendWith(MockitoExtension.class)
public class OrderConsumerTest {
    
    @Mock
    private OrderService orderService;        // Mockå¤–éƒ¨æœåŠ¡
    
    @Mock  
    private PaymentService paymentService;    // Mockæ”¯ä»˜æœåŠ¡
    
    @InjectMocks
    private OrderMessageConsumer consumer;    // è¢«æµ‹è¯•çš„æ¶ˆè´¹è€…
    
    @Test
    public void testOrderProcessing() {
        // ğŸ¯ é‡ç‚¹ï¼šåªMockå¤–éƒ¨ä¾èµ–ï¼Œä¸Mock Kafka
        
        // 1. å‡†å¤‡æµ‹è¯•æ•°æ®
        String orderMessage = """
            {
                "orderId": "123",
                "amount": 100.0,
                "customerId": "user456"
            }
            """;
        
        ConsumerRecord<String, String> record = 
            new ConsumerRecord<>("orders", 0, 0, "123", orderMessage);
        
        // 2. è®¾ç½®Mockè¡Œä¸º
        when(orderService.validateOrder(any())).thenReturn(true);
        when(paymentService.processPayment(any())).thenReturn("payment-789");
        
        // 3. æ‰§è¡Œæµ‹è¯•
        consumer.consume(record);
        
        // 4. éªŒè¯è°ƒç”¨
        verify(orderService).validateOrder(argThat(order -> 
            order.getOrderId().equals("123")));
        verify(paymentService).processPayment(argThat(payment -> 
            payment.getAmount().equals(100.0)));
    }
}
```

## 6.3 Mockå·¥å…·é€‰æ‹©



**æ¨èå·¥å…·å¯¹æ¯”**ï¼š

| å·¥å…· | **ä¼˜åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|------|----------|-------------|
| ğŸ¯ **Mockito** | `æ˜“ç”¨æ€§é«˜ï¼ŒåŠŸèƒ½å®Œæ•´` | `Javaé¡¹ç›®é¦–é€‰` |
| ğŸ”§ **WireMock** | `HTTPæœåŠ¡Mock` | `å¤–éƒ¨APIè°ƒç”¨æµ‹è¯•` |
| ğŸª **MockServer** | `å®Œæ•´æœåŠ¡Mock` | `å¤æ‚é›†æˆæµ‹è¯•` |

---

# 7. ğŸ“Š æ€§èƒ½æµ‹è¯•æ–¹æ³•



## 7.1 Kafkaæ€§èƒ½æµ‹è¯•æŒ‡æ ‡



**æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡**ï¼š

ğŸ”¥ **ååé‡æŒ‡æ ‡**ï¼š
- **æ¶ˆæ¯/ç§’**ï¼šæ¯ç§’å¤„ç†çš„æ¶ˆæ¯æ•°é‡
- **å­—èŠ‚/ç§’**ï¼šæ¯ç§’å¤„ç†çš„æ•°æ®é‡
- **æ‰¹æ¬¡/ç§’**ï¼šæ‰¹é‡å¤„ç†çš„æ•ˆç‡

âš¡ **å»¶è¿ŸæŒ‡æ ‡**ï¼š
- **ç«¯åˆ°ç«¯å»¶è¿Ÿ**ï¼šæ¶ˆæ¯ä»å‘é€åˆ°æ¶ˆè´¹çš„æ—¶é—´
- **Producerå»¶è¿Ÿ**ï¼šå‘é€æ¶ˆæ¯çš„å“åº”æ—¶é—´  
- **Consumerå»¶è¿Ÿ**ï¼šæ¶ˆè´¹æ¶ˆæ¯çš„å¤„ç†æ—¶é—´

ğŸ¯ **å¯é æ€§æŒ‡æ ‡**ï¼š
- **æ¶ˆæ¯ä¸¢å¤±ç‡**ï¼šæ¶ˆæ¯ä¸¢å¤±çš„æ¯”ä¾‹
- **é‡å¤æ¶ˆæ¯ç‡**ï¼šé‡å¤æ¶ˆè´¹çš„æ¯”ä¾‹
- **é”™è¯¯ç‡**ï¼šå¤„ç†å¤±è´¥çš„æ¯”ä¾‹

## 7.2 æ€§èƒ½æµ‹è¯•å·¥å…·



**å®˜æ–¹æµ‹è¯•å·¥å…·**ï¼š
```bash
# Produceræ€§èƒ½æµ‹è¯•

kafka-producer-perf-test.sh \
  --topic test-topic \
  --num-records 1000000 \
  --record-size 1024 \
  --throughput 10000 \
  --producer-props bootstrap.servers=localhost:9092

# Consumeræ€§èƒ½æµ‹è¯•  

kafka-consumer-perf-test.sh \
  --topic test-topic \
  --messages 1000000 \
  --threads 1 \
  --bootstrap-server localhost:9092
```

**Javaæ€§èƒ½æµ‹è¯•ä»£ç **ï¼š
```java
@Test
public void performanceTest() {
    int messageCount = 100000;
    int warmupCount = 10000;
    
    // ğŸ¯ é¢„çƒ­é˜¶æ®µ
    for (int i = 0; i < warmupCount; i++) {
        producer.send(new ProducerRecord<>("test-topic", "warmup-" + i));
    }
    
    // ğŸ”¥ æ€§èƒ½æµ‹è¯•é˜¶æ®µ
    long startTime = System.currentTimeMillis();
    
    for (int i = 0; i < messageCount; i++) {
        producer.send(new ProducerRecord<>("test-topic", "message-" + i));
    }
    
    producer.flush(); // ç¡®ä¿æ‰€æœ‰æ¶ˆæ¯å‘é€å®Œæˆ
    long endTime = System.currentTimeMillis();
    
    // ğŸ“Š è®¡ç®—æ€§èƒ½æŒ‡æ ‡
    long duration = endTime - startTime;
    double throughput = (double) messageCount / duration * 1000;
    
    System.out.printf("å‘é€ %d æ¡æ¶ˆæ¯ï¼Œè€—æ—¶ %d msï¼Œååé‡ %.2f msg/s%n", 
                     messageCount, duration, throughput);
    
    // æ–­è¨€æ€§èƒ½è¦æ±‚
    assertThat(throughput).isGreaterThan(10000); // è¦æ±‚ > 10k msg/s
}
```

## 7.3 æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ



**æµ‹è¯•ç¯å¢ƒè¦æ±‚**ï¼š
- **ç¡¬ä»¶ä¸€è‡´**ï¼šæµ‹è¯•ç¯å¢ƒåº”å°½é‡æ¥è¿‘ç”Ÿäº§ç¯å¢ƒ
- **ç½‘ç»œéš”ç¦»**ï¼šé¿å…ç½‘ç»œå¹²æ‰°
- **èµ„æºå……è¶³**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä¸æˆä¸ºç“¶é¢ˆ

**æµ‹è¯•æ•°æ®è®¾è®¡**ï¼š
- **æ¶ˆæ¯å¤§å°**ï¼šæµ‹è¯•ä¸åŒå¤§å°çš„æ¶ˆæ¯
- **åˆ†åŒºç­–ç•¥**ï¼šæµ‹è¯•ä¸åŒçš„åˆ†åŒºåˆ†å¸ƒ
- **å¹¶å‘çº§åˆ«**ï¼šæµ‹è¯•ä¸åŒçš„å¹¶å‘æ•°

---

# 8. ğŸ—ƒï¸ æµ‹è¯•æ•°æ®ç®¡ç†ç­–ç•¥



## 8.1 æµ‹è¯•æ•°æ®çš„æŒ‘æˆ˜



**Kafkaæµ‹è¯•æ•°æ®ç‰¹ç‚¹**ï¼š
```
ä¼ ç»Ÿæ•°æ®åº“æµ‹è¯•ï¼š
â€¢ æ•°æ®åœ¨è¡¨ä¸­ï¼Œå®¹æ˜“æ¸…ç†
â€¢ äº‹åŠ¡å›æ»šç®€å•
â€¢ çŠ¶æ€å®¹æ˜“é‡ç½®

Kafkaæµ‹è¯•æ•°æ®ï¼š
â€¢ æ¶ˆæ¯å­˜å‚¨åœ¨Topicä¸­
â€¢ ä¸æ”¯æŒåˆ é™¤å•æ¡æ¶ˆæ¯
â€¢ Consumeråç§»é‡éœ€è¦ç®¡ç†
â€¢ åˆ†åŒºçŠ¶æ€å¤æ‚
```

## 8.2 æµ‹è¯•æ•°æ®éš”ç¦»ç­–ç•¥



**ç­–ç•¥1ï¼šç‹¬ç«‹Topic**
```java
@TestMethodOrder(OrderAnnotation.class)
public class OrderProcessingTest {
    
    private String getTestTopic() {
        // ğŸ¯ æ¯ä¸ªæµ‹è¯•æ–¹æ³•ä½¿ç”¨ç‹¬ç«‹Topic
        return "test-topic-" + testInfo.getTestMethod()
                                        .map(Method::getName)
                                        .orElse("unknown");
    }
    
    @Test
    @Order(1)
    public void testOrderCreation() {
        String topic = getTestTopic();
        // ä½¿ç”¨ test-topic-testOrderCreation
    }
}
```

**ç­–ç•¥2ï¼šæ—¶é—´æˆ³åˆ†åŒº**
```java
public class TestDataGenerator {
    
    public String generateTestKey(String baseKey) {
        // ğŸ¯ åŠ å…¥æ—¶é—´æˆ³é¿å…æ•°æ®å†²çª
        long timestamp = System.currentTimeMillis();
        return String.format("%s-%d", baseKey, timestamp);
    }
    
    public OrderEvent generateTestOrder() {
        return OrderEvent.builder()
            .orderId(generateTestKey("order"))
            .customerId(generateTestKey("customer"))
            .timestamp(Instant.now())
            .build();
    }
}
```

## 8.3 æµ‹è¯•æ•°æ®æ¸…ç†



**æ¸…ç†ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|----------|----------|-------------|
| ğŸ”„ **é‡å»ºTopic** | `å½»åº•æ¸…ç†` | `è€—æ—¶è¾ƒé•¿` | `é›†æˆæµ‹è¯•` |
| ğŸ¯ **ç‹¬ç«‹Topic** | `å¤©ç„¶éš”ç¦»` | `èµ„æºæ¶ˆè€—å¤§` | `å¹¶è¡Œæµ‹è¯•` |
| â° **æ—¶é—´åˆ†åŒº** | `ç®€å•æœ‰æ•ˆ` | `å¯èƒ½æœ‰æ®‹ç•™` | `å•å…ƒæµ‹è¯•` |
| ğŸ—‘ï¸ **å®šæœŸæ¸…ç†** | `èµ„æºå›æ”¶` | `éœ€è¦è°ƒåº¦` | `é•¿æœŸè¿è¡Œ` |

```java
@AfterEach
public void cleanup() {
    // ğŸ¯ æµ‹è¯•åæ¸…ç†ç­–ç•¥
    
    if (useIsolatedTopics) {
        // åˆ é™¤æµ‹è¯•Topicï¼ˆTestContainersç¯å¢ƒï¼‰
        adminClient.deleteTopics(Collections.singletonList(testTopic));
    } else {
        // é‡ç½®Consumeråç§»é‡åˆ°æœ€æ–°
        consumer.seekToEnd(consumer.assignment());
    }
}
```

---

# 9. ğŸ—ï¸ æµ‹è¯•ç¯å¢ƒéš”ç¦»æ–¹æ¡ˆ



## 9.1 ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒéš”ç¦»



**å¹¶å‘æµ‹è¯•é—®é¢˜**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
æµ‹è¯•Aï¼šå‘topic-1å‘é€æ¶ˆæ¯ "order-123"
æµ‹è¯•Bï¼šå‘topic-1å‘é€æ¶ˆæ¯ "order-456"
       â†“
æ¶ˆè´¹è€…å¯èƒ½æ¥æ”¶åˆ°å¯¹æ–¹çš„æ¶ˆæ¯ï¼
       â†“
æµ‹è¯•ç»“æœä¸å¯é¢„æœŸ
```

## 9.2 éš”ç¦»æ–¹æ¡ˆè®¾è®¡



**æ–¹æ¡ˆ1ï¼šProfileéš”ç¦»**
```yaml
# application-test.yml

spring:
  kafka:
    bootstrap-servers: ${KAFKA_SERVERS:localhost:9092}
    consumer:
      group-id: test-group-${random.uuid}  # ğŸ¯ éšæœºç»„ID
    producer:
      client-id: test-producer-${random.uuid}

# æµ‹è¯•ç‰¹å®šé…ç½®

test:
  kafka:
    topic-prefix: test-${random.int[1000,9999]}-  # ğŸ¯ éšæœºå‰ç¼€
```

**æ–¹æ¡ˆ2ï¼šæ³¨è§£é©±åŠ¨éš”ç¦»**
```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@TestPropertySource(properties = {
    "kafka.consumer.group-id=test-${random.uuid}",
    "kafka.topic.prefix=test-${random.int}-"
})
public @interface IsolatedKafkaTest {
    String[] topics() default {};
}

// ä½¿ç”¨æ–¹å¼
@IsolatedKafkaTest(topics = {"orders", "payments"})
public class OrderIntegrationTest {
    // è‡ªåŠ¨è·å¾—éš”ç¦»çš„Kafkaç¯å¢ƒ
}
```

## 9.3 Docker Composeéš”ç¦»æ–¹æ¡ˆ



**å®Œæ•´æµ‹è¯•ç¯å¢ƒ**ï¼š
```yaml
# docker-compose.test.yml

version: '3.8'
services:
  zookeeper-test:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181"  # ğŸ¯ åŠ¨æ€ç«¯å£åˆ†é…

  kafka-test:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper-test
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "9092"  # ğŸ¯ åŠ¨æ€ç«¯å£åˆ†é…
```

**æµ‹è¯•åŸºç±»**ï¼š
```java
@Testcontainers
public abstract class KafkaIntegrationTestBase {
    
    @Container
    protected static final DockerComposeContainer<?> environment = 
        new DockerComposeContainer<>(new File("docker-compose.test.yml"))
            .withExposedService("kafka-test", 9092);
    
    protected String getKafkaBootstrapServers() {
        return environment.getServiceHost("kafka-test", 9092) + ":" +
               environment.getServicePort("kafka-test", 9092);
    }
}
```

---

# 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## 10.1 æµ‹è¯•ç­–ç•¥é€‰æ‹©æŒ‡å—



ğŸ¯ **å¿«é€Ÿå¼€å‘é˜¶æ®µ**ï¼š
- **å•å…ƒæµ‹è¯•** + **EmbeddedKafka**
- å…³æ³¨ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§
- å¿«é€Ÿåé¦ˆå¾ªç¯

âš¡ **ç¨³å®šè¿­ä»£é˜¶æ®µ**ï¼š
- **é›†æˆæµ‹è¯•** + **TestContainers**
- éªŒè¯ç»„ä»¶äº¤äº’
- æ¨¡æ‹ŸçœŸå®ç¯å¢ƒ

ğŸ”¥ **å‘å¸ƒå‡†å¤‡é˜¶æ®µ**ï¼š
- **ç«¯åˆ°ç«¯æµ‹è¯•** + **æ€§èƒ½æµ‹è¯•**
- éªŒè¯å®Œæ•´æµç¨‹
- ç¡®ä¿æ€§èƒ½è¾¾æ ‡

## 10.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ æµ‹è¯•ä¸æ˜¯è¶Šå¤šè¶Šå¥½**
```
æµ‹è¯•æˆæœ¬ vs æ”¶ç›Šå¹³è¡¡ï¼š
â€¢ å•å…ƒæµ‹è¯•ï¼šæˆæœ¬ä½ï¼Œæ”¶ç›Šé«˜ â†’ å¤šå†™
â€¢ é›†æˆæµ‹è¯•ï¼šæˆæœ¬ä¸­ï¼Œæ”¶ç›Šä¸­ â†’ é€‚é‡
â€¢ E2Eæµ‹è¯•ï¼šæˆæœ¬é«˜ï¼Œæ”¶ç›Šæœ‰é™ â†’ å°‘å†™
```

**ğŸ”¹ å¼‚æ­¥æµ‹è¯•çš„åŒæ­¥åŒ–**
```
æ ¸å¿ƒæŠ€å·§ï¼š
â€¢ CountDownLatch ç­‰å¾…æœºåˆ¶
â€¢ å›è°ƒéªŒè¯
â€¢ æ¶ˆæ¯æ”¶é›†å™¨æ¨¡å¼
â€¢ è¶…æ—¶ä¿æŠ¤
```

**ğŸ”¹ æµ‹è¯•ç¯å¢ƒçš„çœŸå®æ€§**
```
ç¯å¢ƒé€‰æ‹©åŸåˆ™ï¼š
â€¢ å¼€å‘é˜¶æ®µï¼šEmbeddedKafkaï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
â€¢ æµ‹è¯•é˜¶æ®µï¼šTestContainersï¼ˆçœŸå®æ€§ä¼˜å…ˆï¼‰
â€¢ ç”Ÿäº§éªŒè¯ï¼šçœŸå®Kafkaï¼ˆå®Œå…¨çœŸå®ï¼‰
```

## 10.3 å®è·µå»ºè®®



ğŸ’ª **ç«‹å³è¡ŒåŠ¨**ï¼š
1. **æ­å»ºåŸºç¡€æµ‹è¯•æ¡†æ¶**ï¼šé€‰æ‹©EmbeddedKafkaæˆ–TestContainers
2. **ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•**ï¼šä»æœ€ç®€å•çš„Producer/Consumerå¼€å§‹
3. **é€æ­¥å®Œå–„**ï¼šæ·»åŠ å¼‚å¸¸åœºæ™¯ã€æ€§èƒ½æµ‹è¯•

ğŸ” **æŒç»­æ”¹è¿›**ï¼š
- **ç›‘æ§æµ‹è¯•æ‰§è¡Œæ—¶é—´**ï¼šä¿æŒå¿«é€Ÿåé¦ˆ
- **å®šæœŸreviewæµ‹è¯•ç”¨ä¾‹**ï¼šç§»é™¤è¿‡æ—¶çš„æµ‹è¯•
- **å…³æ³¨æµ‹è¯•è¦†ç›–ç‡**ï¼šä½†ä¸è¿½æ±‚100%

ğŸ“ **è¿›é˜¶å­¦ä¹ **ï¼š
- **å­¦ä¹ Kafkaå†…éƒ¨æœºåˆ¶**ï¼šç†è§£åˆ†åŒºã€å‰¯æœ¬ã€åç§»é‡
- **ç ”ç©¶ç”Ÿäº§é—®é¢˜æ¡ˆä¾‹**ï¼šä»å®æˆ˜ä¸­å­¦ä¹ æµ‹è¯•é‡ç‚¹
- **å…³æ³¨ç¤¾åŒºæœ€ä½³å®è·µ**ï¼šæŒç»­æ›´æ–°æµ‹è¯•ç­–ç•¥

**æ ¸å¿ƒè®°å¿†**ï¼š
- æµ‹è¯•é‡‘å­—å¡”ï¼šå•å…ƒæµ‹è¯•å¤šï¼Œé›†æˆæµ‹è¯•é€‚ä¸­ï¼ŒE2Eæµ‹è¯•å°‘
- å¼‚æ­¥æµ‹è¯•è¦åŒæ­¥åŒ–ï¼šä½¿ç”¨CountDownLatchç­‰å¾…æœºåˆ¶
- ç¯å¢ƒéš”ç¦»å¾ˆé‡è¦ï¼šé¿å…æµ‹è¯•é—´ç›¸äº’å¹²æ‰°
- Mockå¤–éƒ¨ä¾èµ–ï¼šä¸è¦Mock Kafkaæœ¬èº«ï¼Œä¸“æ³¨ä¸šåŠ¡é€»è¾‘