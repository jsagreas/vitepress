---
title: 7ã€é”™è¯¯å¤„ç†å’Œé‡è¯•
---
## ğŸ“š ç›®å½•

1. [Kafkaé”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ](#1-Kafkaé”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ)
2. [é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥](#2-é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥)
3. [é‡è¯•æœºåˆ¶è®¾è®¡](#3-é‡è¯•æœºåˆ¶è®¾è®¡)
4. [æ­»ä¿¡é˜Ÿåˆ—å®ç°](#4-æ­»ä¿¡é˜Ÿåˆ—å®ç°)
5. [æ¯’æ¶ˆæ¯å¤„ç†ç­–ç•¥](#5-æ¯’æ¶ˆæ¯å¤„ç†ç­–ç•¥)
6. [ç†”æ–­å’Œé™çº§æœºåˆ¶](#6-ç†”æ–­å’Œé™çº§æœºåˆ¶)
7. [ç›‘æ§å‘Šè­¦ä½“ç³»](#7-ç›‘æ§å‘Šè­¦ä½“ç³»)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ Kafkaé”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Kafkaé”™è¯¯å¤„ç†


**é€šä¿—ç†è§£**ï¼šå°±åƒå¿«é€’é…é€è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å„ç§é—®é¢˜ä¸€æ ·ï¼ŒKafkaæ¶ˆæ¯å¤„ç†ä¹Ÿä¼šé‡åˆ°å„ç§é”™è¯¯

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å¿«é€’é…é€ â†’ åœ°å€é”™è¯¯ã€æ”¶ä»¶äººä¸åœ¨ã€åŒ…è£…ç ´æŸ
Kafkaæ¶ˆæ¯ â†’ ç½‘ç»œå¼‚å¸¸ã€æ¶ˆæ¯æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘å¤±è´¥

å…±åŒç‚¹ï¼šéƒ½éœ€è¦æœ‰åº”å¯¹ç­–ç•¥ï¼Œä¸èƒ½å› ä¸ºä¸€ä¸ªé—®é¢˜å°±åœæ­¢æ•´ä¸ªç³»ç»Ÿ
```

**é”™è¯¯å¤„ç†çš„æœ¬è´¨**ï¼š
- **å‘ç°é—®é¢˜**ï¼šèƒ½å¤Ÿè¯†åˆ«å‡ºç°äº†ä»€ä¹ˆé”™è¯¯
- **åˆ†ç±»å¤„ç†**ï¼šä¸åŒé”™è¯¯ç”¨ä¸åŒçš„å¤„ç†æ–¹å¼
- **ä¿è¯å¯é æ€§**ï¼šå³ä½¿å‡ºé”™ä¹Ÿä¸èƒ½ä¸¢å¤±é‡è¦æ•°æ®
- **ç³»ç»Ÿç¨³å®š**ï¼šä¸èƒ½å› ä¸ºä¸ªåˆ«é”™è¯¯å½±å“æ•´ä½“æœåŠ¡

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†


**ğŸ”¸ åˆ†å¸ƒå¼ç¯å¢ƒçš„å¤æ‚æ€§**
```
ç½‘ç»œå±‚é¢ï¼š
- ç½‘ç»œæŠ–åŠ¨ã€è¶…æ—¶ã€æ–­è¿
- æœåŠ¡å™¨é‡å¯ã€æœºå™¨æ•…éšœ

åº”ç”¨å±‚é¢ï¼š
- æ¶ˆæ¯æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘å¼‚å¸¸
- æ•°æ®åº“è¿æ¥å¤±è´¥ã€ç¬¬ä¸‰æ–¹æœåŠ¡ä¸å¯ç”¨

äººä¸ºå› ç´ ï¼š
- é…ç½®é”™è¯¯ã€ä»£ç bug
- æ•°æ®è´¨é‡é—®é¢˜
```

**ğŸ”¸ ä¸šåŠ¡è¿ç»­æ€§è¦æ±‚**
- **ä¸èƒ½åœæœ**ï¼šç³»ç»Ÿå¿…é¡»7Ã—24å°æ—¶è¿è¡Œ
- **æ•°æ®ä¸ä¸¢**ï¼šé‡è¦ä¸šåŠ¡æ•°æ®ä¸èƒ½å› é”™è¯¯è€Œä¸¢å¤±  
- **å¿«é€Ÿæ¢å¤**ï¼šå‡ºç°é—®é¢˜è¦èƒ½å¿«é€Ÿå®šä½å’Œè§£å†³

### 1.3 Kafkaé”™è¯¯å¤„ç†çš„ç‰¹ç‚¹


**ğŸ”¸ æµå¼å¤„ç†ç‰¹æ€§**
```
ä¼ ç»Ÿæ‰¹å¤„ç†ï¼š
- å¤„ç†ä¸€æ‰¹æ•°æ®ï¼Œå¤±è´¥äº†é‡æ–°å¤„ç†æ•´æ‰¹
- æœ‰æ˜ç¡®çš„å¼€å§‹å’Œç»“æŸ

Kafkaæµå¤„ç†ï¼š
- æ•°æ®æºæºä¸æ–­ï¼Œæ²¡æœ‰æ˜ç¡®è¾¹ç•Œ
- ä¸€æ¡æ¶ˆæ¯å¤±è´¥ä¸èƒ½å½±å“åç»­æ¶ˆæ¯
- éœ€è¦åœ¨æµä¸­å¤„ç†é”™è¯¯
```

**ğŸ”¸ é«˜ååé‡è¦æ±‚**
- é”™è¯¯å¤„ç†ä¸èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
- éœ€è¦å¿«é€Ÿåˆ¤æ–­å’Œå¤„ç†é”™è¯¯
- é¿å…å› é”™è¯¯å¤„ç†å½±å“æ­£å¸¸æ¶ˆæ¯

---

## 2. ğŸ“Š é”™è¯¯åˆ†ç±»å’Œå¤„ç†ç­–ç•¥


### 2.1 æŒ‰é”™è¯¯æ¥æºåˆ†ç±»


**ğŸ”¸ ç½‘ç»œç›¸å…³é”™è¯¯**
```
å¸¸è§ç½‘ç»œé”™è¯¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”Ÿäº§è€…              â”‚â”€â”€ç½‘ç»œè¶…æ—¶â”€â”€â”‚ âŒ TimeoutException
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚ âŒ NetworkException  
â”‚   Kafkaé›†ç¾¤          â”‚â”€â”€è¿æ¥æ–­å¼€â”€â”€â”‚ âŒ DisconnectException
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚   æ¶ˆè´¹è€…              â”‚â”€â”€è¯·æ±‚å¤±è´¥â”€â”€â”‚ âŒ RequestTimeoutException
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼šé€šå¸¸æ˜¯ä¸´æ—¶æ€§çš„ï¼Œé‡è¯•åå¯èƒ½æˆåŠŸ
å¤„ç†ç­–ç•¥ï¼šé‡è¯• + æŒ‡æ•°é€€é¿
```

**ğŸ”¸ åºåˆ—åŒ–/ååºåˆ—åŒ–é”™è¯¯**
```java
// å¸¸è§åºåˆ—åŒ–é”™è¯¯ç¤ºä¾‹
public class SerializationErrorExample {
    // é”™è¯¯1ï¼šæ¶ˆæ¯æ ¼å¼ä¸åŒ¹é…
    // å‘é€æ—¶ç”¨Stringæ ¼å¼ï¼Œæ¶ˆè´¹æ—¶æœŸæœ›JSONæ ¼å¼
    
    // é”™è¯¯2ï¼šç‰ˆæœ¬ä¸å…¼å®¹
    // å‡çº§äº†æ¶ˆæ¯ç»“æ„ï¼Œä½†æ—§æ¶ˆè´¹è€…è¿˜åœ¨è¿è¡Œ
    
    // é”™è¯¯3ï¼šç¼–ç é—®é¢˜
    // å­—ç¬¦ç¼–ç ä¸ä¸€è‡´å¯¼è‡´ä¹±ç 
}
```

**ç‰¹ç‚¹**ï¼šé€šå¸¸æ˜¯æŒç»­æ€§çš„ï¼Œé‡è¯•ä¹Ÿä¸ä¼šæˆåŠŸ
**å¤„ç†ç­–ç•¥**ï¼šè®°å½•é”™è¯¯ + è·³è¿‡ + å‘Šè­¦

**ğŸ”¸ ä¸šåŠ¡é€»è¾‘é”™è¯¯**
```
ä¸šåŠ¡é”™è¯¯ç¤ºä¾‹ï¼š
- è®¢å•é‡‘é¢ä¸ºè´Ÿæ•°
- ç”¨æˆ·IDä¸å­˜åœ¨
- åº“å­˜ä¸è¶³
- é‡å¤æäº¤

ç‰¹ç‚¹ï¼šéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
å¤„ç†ç­–ç•¥ï¼šä¸šåŠ¡æ ¡éªŒ + åˆ†ç±»å¤„ç†
```

### 2.2 æŒ‰é”™è¯¯ä¸¥é‡ç¨‹åº¦åˆ†ç±»


| é”™è¯¯çº§åˆ« | **æè¿°** | **å¤„ç†ç­–ç•¥** | **ç¤ºä¾‹** |
|---------|---------|-------------|----------|
| ğŸŸ¢ **è½»å¾®** | `ä¸´æ—¶æ€§é”™è¯¯ï¼Œé‡è¯•å¯è§£å†³` | `è‡ªåŠ¨é‡è¯•` | `ç½‘ç»œæŠ–åŠ¨ã€ä¸´æ—¶è¶…æ—¶` |
| ğŸŸ¡ **ä¸­ç­‰** | `éœ€è¦äººå·¥å…³æ³¨ä½†ä¸ç´§æ€¥` | `è®°å½•æ—¥å¿— + å‘Šè­¦` | `æ•°æ®æ ¼å¼è½»å¾®å¼‚å¸¸` |
| ğŸ”´ **ä¸¥é‡** | `å½±å“ä¸šåŠ¡åŠŸèƒ½` | `ç«‹å³å‘Šè­¦ + äººå·¥ä»‹å…¥` | `æ•°æ®åº“è¿æ¥å¤±è´¥` |
| âš« **è‡´å‘½** | `ç³»ç»Ÿæ— æ³•ç»§ç»­è¿è¡Œ` | `ç†”æ–­ + ç´§æ€¥ä¿®å¤` | `æ ¸å¿ƒæœåŠ¡å®Œå…¨ä¸å¯ç”¨` |

### 2.3 æŒ‰æ˜¯å¦å¯é‡è¯•åˆ†ç±»


**ğŸ”¸ å¯é‡è¯•é”™è¯¯ï¼ˆRetriable Errorsï¼‰**
```
ç½‘ç»œç±»ï¼š
âœ… TimeoutException - è¯·æ±‚è¶…æ—¶
âœ… RetriableException - å¯é‡è¯•å¼‚å¸¸  
âœ… NotEnoughReplicasException - å‰¯æœ¬ä¸è¶³

èµ„æºç±»ï¼š
âœ… NotLeaderForPartitionException - ä¸æ˜¯åˆ†åŒºLeader
âœ… LeaderNotAvailableException - Leaderä¸å¯ç”¨

ç‰¹å¾ï¼šé”™è¯¯æ˜¯ä¸´æ—¶çš„ï¼Œç¯å¢ƒæ¡ä»¶æ”¹å˜åå¯èƒ½æˆåŠŸ
ç­–ç•¥ï¼šè‡ªåŠ¨é‡è¯• + æŒ‡æ•°é€€é¿
```

**ğŸ”¸ ä¸å¯é‡è¯•é”™è¯¯ï¼ˆNon-Retriable Errorsï¼‰**
```
æ•°æ®ç±»ï¼š
âŒ SerializationException - åºåˆ—åŒ–å¼‚å¸¸
âŒ InvalidTopicException - æ— æ•ˆä¸»é¢˜
âŒ RecordTooLargeException - æ¶ˆæ¯è¿‡å¤§

æƒé™ç±»ï¼š
âŒ TopicAuthorizationException - ä¸»é¢˜æƒé™å¼‚å¸¸
âŒ ClusterAuthorizationException - é›†ç¾¤æƒé™å¼‚å¸¸

ç‰¹å¾ï¼šé‡è¯•ä¹Ÿä¸ä¼šæˆåŠŸï¼Œéœ€è¦ä¿®å¤æ ¹æœ¬é—®é¢˜
ç­–ç•¥ï¼šè®°å½•é”™è¯¯ + å‘Šè­¦ + è·³è¿‡æˆ–è½¬æ­»ä¿¡é˜Ÿåˆ—
```

---

## 3. ğŸ”„ é‡è¯•æœºåˆ¶è®¾è®¡


### 3.1 é‡è¯•ç­–ç•¥åŸºç¡€æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯é‡è¯•ç­–ç•¥**
```
ç”Ÿæ´»ç±»æ¯”ï¼š
è€ƒé©¾ç…§æ²¡è¿‡ â†’ ç­‰ä¸€æ®µæ—¶é—´å†è€ƒï¼ˆé‡è¯•é—´éš”ï¼‰
æœ€å¤šèƒ½è€ƒå‡ æ¬¡ â†’ æœ‰æ¬¡æ•°é™åˆ¶ï¼ˆæœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰  
æ¯æ¬¡é—´éš”æ—¶é—´ â†’ å¯èƒ½è¶Šæ¥è¶Šé•¿ï¼ˆé€€é¿ç­–ç•¥ï¼‰

é‡è¯•ç­–ç•¥å°±æ˜¯å®šä¹‰ï¼š
- ä»€ä¹ˆæƒ…å†µä¸‹é‡è¯•
- é‡è¯•å‡ æ¬¡
- é‡è¯•é—´éš”å¤šé•¿
- é‡è¯•é—´éš”å¦‚ä½•å¢é•¿
```

### 3.2 é‡è¯•é—´éš”ç­–ç•¥


**ğŸ”¸ å›ºå®šé—´éš”é‡è¯•**
```java
public class FixedIntervalRetry {
    private final int maxRetries = 3;
    private final long retryInterval = 1000; // 1ç§’
    
    public void processWithRetry(String message) {
        int attempt = 0;
        while (attempt < maxRetries) {
            try {
                // å¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘
                processMessage(message);
                return; // æˆåŠŸåˆ™é€€å‡º
            } catch (RetriableException e) {
                attempt++;
                if (attempt >= maxRetries) {
                    throw e; // è¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸
                }
                // å›ºå®šé—´éš”ç­‰å¾…
                Thread.sleep(retryInterval);
            }
        }
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•æ˜“ç†è§£
**ç¼ºç‚¹**ï¼šå¯èƒ½é€ æˆ"é›·ç¾¤æ•ˆåº”"ï¼ˆæ‰€æœ‰å®¢æˆ·ç«¯åŒæ—¶é‡è¯•ï¼‰

**ğŸ”¸ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæ¨èï¼‰**
```java
public class ExponentialBackoffRetry {
    private final int maxRetries = 5;
    private final long baseDelay = 1000; // åŸºç¡€å»¶è¿Ÿ1ç§’
    private final double multiplier = 2.0; // æ¯æ¬¡ä¹˜ä»¥2
    private final long maxDelay = 30000; // æœ€å¤§å»¶è¿Ÿ30ç§’
    
    public void processWithRetry(String message) {
        int attempt = 0;
        while (attempt < maxRetries) {
            try {
                processMessage(message);
                return;
            } catch (RetriableException e) {
                attempt++;
                if (attempt >= maxRetries) {
                    // æœ€ç»ˆå¤±è´¥ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                    sendToDeadLetterQueue(message, e);
                    return;
                }
                
                // è®¡ç®—é€€é¿å»¶è¿Ÿï¼š1s, 2s, 4s, 8s, 16s
                long delay = Math.min(
                    baseDelay * (long) Math.pow(multiplier, attempt - 1),
                    maxDelay
                );
                
                // æ·»åŠ éšæœºæŠ–åŠ¨ï¼Œé¿å…é›·ç¾¤æ•ˆåº”
                long jitter = (long) (delay * 0.1 * Math.random());
                Thread.sleep(delay + jitter);
            }
        }
    }
}
```

**æŒ‡æ•°é€€é¿çš„ä¼˜åŠ¿**ï¼š
```
æ—¶é—´åˆ†å¸ƒï¼š
ç¬¬1æ¬¡é‡è¯•ï¼š1ç§’å
ç¬¬2æ¬¡é‡è¯•ï¼š2ç§’å  
ç¬¬3æ¬¡é‡è¯•ï¼š4ç§’å
ç¬¬4æ¬¡é‡è¯•ï¼š8ç§’å
ç¬¬5æ¬¡é‡è¯•ï¼š16ç§’å

å¥½å¤„ï¼š
âœ… ç»™ç³»ç»Ÿæ¢å¤æ—¶é—´
âœ… å‡å°‘ç³»ç»Ÿå‹åŠ›
âœ… é¿å…é›·ç¾¤æ•ˆåº”
âœ… å…¼é¡¾å¿«é€Ÿæ¢å¤å’Œç³»ç»Ÿç¨³å®š
```

### 3.3 é‡è¯•é…ç½®å®è·µ


**ğŸ”¸ Produceré‡è¯•é…ç½®**
```java
public class ProducerRetryConfig {
    public Properties getProducerConfig() {
        Properties props = new Properties();
        
        // åŸºç¡€é…ç½®
        props.put("bootstrap.servers", "localhost:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // é‡è¯•ç›¸å…³é…ç½®
        props.put("retries", 5);                    // æœ€å¤§é‡è¯•æ¬¡æ•°
        props.put("retry.backoff.ms", 1000);        // é‡è¯•é—´éš”
        props.put("request.timeout.ms", 30000);     // è¯·æ±‚è¶…æ—¶æ—¶é—´
        props.put("delivery.timeout.ms", 120000);   // æ€»ä½“å‘é€è¶…æ—¶
        
        // å¹‚ç­‰æ€§é…ç½®ï¼ˆé¿å…é‡å¤ï¼‰
        props.put("enable.idempotence", true);
        
        return props;
    }
}
```

**ğŸ”¸ Consumeré‡è¯•é…ç½®**
```java
public class ConsumerRetryConfig {
    private final KafkaConsumer<String, String> consumer;
    private final KafkaProducer<String, String> retryProducer;
    
    public void processMessages() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
            
            for (ConsumerRecord<String, String> record : records) {
                try {
                    // å¤„ç†æ¶ˆæ¯
                    processMessage(record.value());
                } catch (RetriableException e) {
                    // å‘é€åˆ°é‡è¯•Topic
                    handleRetriableError(record, e);
                } catch (NonRetriableException e) {
                    // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                    sendToDeadLetterQueue(record, e);
                }
            }
        }
    }
    
    private void handleRetriableError(ConsumerRecord<String, String> record, Exception e) {
        // è·å–å½“å‰é‡è¯•æ¬¡æ•°
        int retryCount = getRetryCount(record);
        
        if (retryCount < 3) {
            // å‘é€åˆ°é‡è¯•Topicï¼Œå»¶è¿Ÿå¤„ç†
            sendToRetryTopic(record, retryCount + 1);
        } else {
            // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(record, e);
        }
    }
}
```

---

## 4. ğŸ’€ æ­»ä¿¡é˜Ÿåˆ—å®ç°


### 4.1 æ­»ä¿¡é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—**
```
ç”Ÿæ´»ç±»æ¯”ï¼š
é‚®å±€å¤„ç†ä¿¡ä»¶ â†’ æ— æ³•æŠ•é€’çš„ä¿¡ä»¶æ”¾åˆ°"æ­»ä¿¡"éƒ¨é—¨
é¤å…å¤„ç†è®¢å• â†’ æ— æ³•å®Œæˆçš„è®¢å•è®°å½•åˆ°"å¼‚å¸¸è®¢å•"æœ¬

æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue, DLQ)ï¼š
- å­˜æ”¾æ— æ³•æ­£å¸¸å¤„ç†çš„æ¶ˆæ¯
- é¿å…é—®é¢˜æ¶ˆæ¯é˜»å¡æ­£å¸¸æµç¨‹
- ä¾¿äºåç»­åˆ†æå’Œäººå·¥å¤„ç†
```

**ğŸ”¸ ä»€ä¹ˆæ¶ˆæ¯ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—**
- âœ… **é‡è¯•è¶…è¿‡æœ€å¤§æ¬¡æ•°**çš„æ¶ˆæ¯
- âœ… **æ ¼å¼é”™è¯¯**æ— æ³•è§£æçš„æ¶ˆæ¯  
- âœ… **ä¸šåŠ¡é€»è¾‘æ‹’ç»**çš„æ¶ˆæ¯
- âœ… **æ¯’æ¶ˆæ¯**ï¼ˆå¤„ç†æ—¶æ€»æ˜¯å‡ºé”™ï¼‰

### 4.2 æ­»ä¿¡é˜Ÿåˆ—è®¾è®¡æ¨¡å¼


**ğŸ”¸ Topicå‘½åè§„èŒƒ**
```
åŸå§‹Topic: order-events
é‡è¯•Topic: order-events.retry
æ­»ä¿¡Topic: order-events.dead-letter

ä¼˜ç‚¹ï¼š
- å‘½åè§„èŒƒï¼Œä¾¿äºç®¡ç†
- å¯ä»¥é€šè¿‡Topicåç§°å¿«é€Ÿè¯†åˆ«ç”¨é€”
- ä¾¿äºç›‘æ§å’Œå‘Šè­¦é…ç½®
```

**ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—æ¶æ„è®¾è®¡**
```
æ­£å¸¸å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸå§‹Topic   â”‚â”€â”€â”€â–¶â”‚   æ¶ˆè´¹è€…å¤„ç†   â”‚â”€â”€â”€â–¶â”‚   ä¸šåŠ¡ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚(å¤„ç†å¤±è´¥)
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é‡è¯•Topic   â”‚â—€â”€â”€â”€â”‚   é‡è¯•å¤„ç†å™¨   â”‚â”€â”€â”€â–¶â”‚   å»¶è¿Ÿé‡è¯•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                       â”‚
       â”‚(è¶…è¿‡é‡è¯•æ¬¡æ•°)                          â”‚(é‡è¯•æˆåŠŸ)
       â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ­»ä¿¡Topic   â”‚                        â”‚   ä¸šåŠ¡ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ­»ä¿¡é˜Ÿåˆ—å®ç°ä»£ç 


**ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å™¨**
```java
public class DeadLetterQueueHandler {
    private final KafkaProducer<String, String> producer;
    private final String deadLetterTopic;
    private final Logger logger = LoggerFactory.getLogger(DeadLetterQueueHandler.class);
    
    public DeadLetterQueueHandler(String deadLetterTopic) {
        this.deadLetterTopic = deadLetterTopic;
        this.producer = createProducer();
    }
    
    public void sendToDeadLetterQueue(ConsumerRecord<String, String> originalRecord, 
                                     Exception exception) {
        try {
            // æ„é€ æ­»ä¿¡æ¶ˆæ¯å¤´
            Headers headers = new RecordHeaders();
            headers.add("original-topic", originalRecord.topic().getBytes());
            headers.add("original-partition", String.valueOf(originalRecord.partition()).getBytes());
            headers.add("original-offset", String.valueOf(originalRecord.offset()).getBytes());
            headers.add("error-message", exception.getMessage().getBytes());
            headers.add("error-timestamp", String.valueOf(System.currentTimeMillis()).getBytes());
            
            // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            ProducerRecord<String, String> deadLetterRecord = new ProducerRecord<>(
                deadLetterTopic,
                null, // partition
                originalRecord.key(),
                originalRecord.value(),
                headers
            );
            
            producer.send(deadLetterRecord, (metadata, ex) -> {
                if (ex == null) {
                    logger.info("Successfully sent message to dead letter queue: topic={}, partition={}, offset={}", 
                              metadata.topic(), metadata.partition(), metadata.offset());
                } else {
                    logger.error("Failed to send message to dead letter queue", ex);
                }
            });
            
        } catch (Exception e) {
            logger.error("Error sending message to dead letter queue", e);
        }
    }
}
```

**ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯æ ¼å¼**
```json
{
  "headers": {
    "original-topic": "order-events",
    "original-partition": "2", 
    "original-offset": "12345",
    "error-message": "SerializationException: Unable to parse JSON",
    "error-timestamp": "1693872000000",
    "retry-count": "3"
  },
  "key": "order-123",
  "value": "{\"orderId\": \"123\", \"amount\": \"invalid-number\"}"
}
```

### 4.4 æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§å’Œå¤„ç†


**ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§**
```java
public class DeadLetterQueueMonitor {
    private final AdminClient adminClient;
    private final String deadLetterTopic;
    
    // ç›‘æ§æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡
    public long getDeadLetterCount() {
        // è·å–æ­»ä¿¡Topicçš„æ¶ˆæ¯æ€»æ•°
        Map<TopicPartition, Long> endOffsets = consumer.endOffsets(
            getTopicPartitions(deadLetterTopic)
        );
        return endOffsets.values().stream().mapToLong(Long::longValue).sum();
    }
    
    // å®šæœŸæ£€æŸ¥å¹¶å‘Šè­¦
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkDeadLetterQueue() {
        long count = getDeadLetterCount();
        if (count > 100) { // è¶…è¿‡100æ¡æ¶ˆæ¯å‘Šè­¦
            sendAlert("Dead letter queue has " + count + " messages");
        }
    }
}
```

---

## 5. â˜ ï¸ æ¯’æ¶ˆæ¯å¤„ç†ç­–ç•¥


### 5.1 ä»€ä¹ˆæ˜¯æ¯’æ¶ˆæ¯


**ğŸ”¸ æ¯’æ¶ˆæ¯çš„å®šä¹‰**
```
ç”Ÿæ´»ç±»æ¯”ï¼š
é¤å…èœå“ â†’ æŸé“èœæ€»æ˜¯è®©é¡¾å®¢é£Ÿç‰©ä¸­æ¯’
å¿«é€’åŒ…è£¹ â†’ æŸä¸ªåŒ…è£¹æ€»æ˜¯å¯¼è‡´é…é€ç³»ç»Ÿå´©æºƒ

æ¯’æ¶ˆæ¯(Poison Message)ï¼š
- æ— è®ºæ€ä¹ˆå¤„ç†éƒ½ä¼šå¯¼è‡´é”™è¯¯çš„æ¶ˆæ¯
- å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…å´©æºƒæˆ–æ— é™é‡è¯•
- ä¼šå½±å“å…¶ä»–æ­£å¸¸æ¶ˆæ¯çš„å¤„ç†
```

**ğŸ”¸ æ¯’æ¶ˆæ¯çš„ç‰¹å¾**
```
è¡¨ç°ç‰¹å¾ï¼š
âŒ åå¤å¤„ç†å¤±è´¥
âŒ æ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æº
âŒ é˜»å¡æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
âŒ å¯¼è‡´æ¶ˆè´¹è€…é¢‘ç¹é‡å¯

å¸¸è§åŸå› ï¼š
- æ¶ˆæ¯æ ¼å¼ä¸¥é‡é”™è¯¯
- åŒ…å«æ¶æ„æ•°æ®
- è§¦å‘äº†ç³»ç»Ÿbug
- æ•°æ®å¤§å°è¶…å‡ºå¤„ç†èƒ½åŠ›
```

### 5.2 æ¯’æ¶ˆæ¯è¯†åˆ«æœºåˆ¶


**ğŸ”¸ åŸºäºé‡è¯•æ¬¡æ•°è¯†åˆ«**
```java
public class PoisonMessageDetector {
    private final Map<String, Integer> messageRetryCount = new ConcurrentHashMap<>();
    private final int maxRetries = 3;
    
    public boolean isPoisonMessage(String messageKey) {
        int retryCount = messageRetryCount.getOrDefault(messageKey, 0);
        return retryCount >= maxRetries;
    }
    
    public void recordRetry(String messageKey) {
        messageRetryCount.merge(messageKey, 1, Integer::sum);
    }
    
    public void removeMessage(String messageKey) {
        messageRetryCount.remove(messageKey);
    }
}
```

**ğŸ”¸ åŸºäºå¼‚å¸¸ç±»å‹è¯†åˆ«**
```java
public class ExceptionBasedPoisonDetector {
    // å®šä¹‰æ¯’æ¶ˆæ¯å¼‚å¸¸ç±»å‹
    private final Set<Class<? extends Exception>> poisonExceptions = Set.of(
        OutOfMemoryError.class,
        StackOverflowError.class,
        SerializationException.class
    );
    
    public boolean isPoisonMessage(Exception exception) {
        return poisonExceptions.stream()
                .anyMatch(poisonEx -> poisonEx.isAssignableFrom(exception.getClass()));
    }
}
```

### 5.3 æ¯’æ¶ˆæ¯å¤„ç†æµç¨‹


**ğŸ”¸ æ¯’æ¶ˆæ¯å¤„ç†ç­–ç•¥**
```
è¯†åˆ«æ¯’æ¶ˆæ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶æ¶ˆæ¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤„ç†æ¶ˆæ¯        â”‚â”€â”€å¤„ç†å¤±è´¥â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
          â”‚                    â”‚
      å¤„ç†æˆåŠŸ                  â”‚
          â”‚                    â–¼
          â–¼            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  è®°å½•é‡è¯•æ¬¡æ•°    â”‚
â”‚  ç¡®è®¤æ¶ˆæ¯        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      è¶…è¿‡é˜ˆå€¼
                        â”‚  æ£€æŸ¥é‡è¯•æ¬¡æ•°    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                                â”‚                       â”‚
                           æœªè¶…è¿‡é˜ˆå€¼                     â”‚
                                â”‚                       â–¼
                                â–¼               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  æ ‡è®°ä¸ºæ¯’æ¶ˆæ¯    â”‚
                        â”‚  é‡è¯•å¤„ç†        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                                                        â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚  éš”ç¦»å¤„ç†        â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ æ¯’æ¶ˆæ¯éš”ç¦»å®ç°**
```java
public class PoisonMessageHandler {
    private final Set<String> poisonMessages = ConcurrentHashMap.newKeySet();
    private final KafkaProducer<String, String> quarantineProducer;
    
    public void handleMessage(ConsumerRecord<String, String> record) {
        String messageKey = record.key();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å·²çŸ¥æ¯’æ¶ˆæ¯
        if (poisonMessages.contains(messageKey)) {
            logger.warn("Skipping poison message: {}", messageKey);
            return; // ç›´æ¥è·³è¿‡
        }
        
        try {
            processMessage(record);
        } catch (Exception e) {
            if (isPoisonMessage(e)) {
                // æ ‡è®°ä¸ºæ¯’æ¶ˆæ¯
                poisonMessages.add(messageKey);
                // å‘é€åˆ°éš”ç¦»é˜Ÿåˆ—
                sendToQuarantineQueue(record, e);
                logger.error("Message marked as poison: {}", messageKey, e);
            } else {
                // æ­£å¸¸é”™è¯¯å¤„ç†æµç¨‹
                handleRetriableError(record, e);
            }
        }
    }
    
    private void sendToQuarantineQueue(ConsumerRecord<String, String> record, Exception e) {
        // å‘é€åˆ°ä¸“é—¨çš„éš”ç¦»Topicè¿›è¡Œäººå·¥å¤„ç†
        ProducerRecord<String, String> quarantineRecord = new ProducerRecord<>(
            "quarantine-topic",
            record.key(),
            record.value()
        );
        quarantineProducer.send(quarantineRecord);
    }
}
```

---

## 6. ğŸ”§ ç†”æ–­å’Œé™çº§æœºåˆ¶


### 6.1 ç†”æ–­æœºåˆ¶åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç†”æ–­æœºåˆ¶**
```
ç”µè·¯ç±»æ¯”ï¼š
å®¶é‡Œç”¨ç”µ â†’ ç”µæµè¿‡å¤§æ—¶ä¿é™©ä¸ç†”æ–­ï¼Œä¿æŠ¤æ•´ä¸ªç”µè·¯
è½¯ä»¶ç³»ç»Ÿ â†’ é”™è¯¯ç‡è¿‡é«˜æ—¶åœæ­¢è°ƒç”¨ï¼Œä¿æŠ¤æ•´ä¸ªç³»ç»Ÿ

ç†”æ–­å™¨çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  é”™è¯¯ç‡é«˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è¶…æ—¶åæµ‹è¯•  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å…³é—­      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    æ‰“å¼€      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   åŠæ‰“å¼€     â”‚
â”‚  (æ­£å¸¸è°ƒç”¨)  â”‚          â”‚  (æ‹’ç»è°ƒç”¨)  â”‚              â”‚  (æµ‹è¯•è°ƒç”¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                                                      â”‚
       â”‚                                                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æµ‹è¯•æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ç†”æ–­å™¨å®ç°


**ğŸ”¸ ç®€å•ç†”æ–­å™¨å®ç°**
```java
public class CircuitBreaker {
    private enum State { CLOSED, OPEN, HALF_OPEN }
    
    private State state = State.CLOSED;
    private int failureCount = 0;
    private long lastFailureTime = 0;
    
    private final int failureThreshold = 5;      // å¤±è´¥é˜ˆå€¼
    private final long recoveryTimeout = 60000;  // æ¢å¤è¶…æ—¶(1åˆ†é’Ÿ)
    
    public boolean allowRequest() {
        if (state == State.OPEN) {
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥åŠæ‰“å¼€çŠ¶æ€
            if (System.currentTimeMillis() - lastFailureTime > recoveryTimeout) {
                state = State.HALF_OPEN;
                return true;
            }
            return false; // ç†”æ–­ä¸­ï¼Œæ‹’ç»è¯·æ±‚
        }
        return true; // å…³é—­æˆ–åŠæ‰“å¼€çŠ¶æ€ï¼Œå…è®¸è¯·æ±‚
    }
    
    public void recordSuccess() {
        if (state == State.HALF_OPEN) {
            state = State.CLOSED; // æµ‹è¯•æˆåŠŸï¼Œæ¢å¤æ­£å¸¸
        }
        failureCount = 0;
    }
    
    public void recordFailure() {
        failureCount++;
        lastFailureTime = System.currentTimeMillis();
        
        if (state == State.HALF_OPEN || failureCount >= failureThreshold) {
            state = State.OPEN; // è§¦å‘ç†”æ–­
        }
    }
}
```

**ğŸ”¸ åœ¨Kafkaæ¶ˆè´¹ä¸­ä½¿ç”¨ç†”æ–­å™¨**
```java
public class CircuitBreakerConsumer {
    private final CircuitBreaker circuitBreaker = new CircuitBreaker();
    private final KafkaConsumer<String, String> consumer;
    
    public void processMessages() {
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(1000));
            
            for (ConsumerRecord<String, String> record : records) {
                // æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
                if (!circuitBreaker.allowRequest()) {
                    logger.warn("Circuit breaker is OPEN, skipping message processing");
                    // å¯ä»¥é€‰æ‹©å‘é€åˆ°é™çº§å¤„ç†é˜Ÿåˆ—
                    handleDegradedProcessing(record);
                    continue;
                }
                
                try {
                    processMessage(record);
                    circuitBreaker.recordSuccess();
                } catch (Exception e) {
                    circuitBreaker.recordFailure();
                    handleProcessingError(record, e);
                }
            }
        }
    }
}
```

### 6.3 é™çº§æœºåˆ¶è®¾è®¡


**ğŸ”¸ ä»€ä¹ˆæ˜¯é™çº§æœºåˆ¶**
```
æœåŠ¡é™çº§ç±»æ¯”ï¼š
é«˜å³°æœŸé¤å… â†’ æš‚åœå¤æ‚èœå“ï¼Œåªæä¾›ç®€å•å¿«é¤
ç½‘ç«™å¤§ä¿ƒé”€ â†’ å…³é—­æ¨èåŠŸèƒ½ï¼Œä¿è¯æ ¸å¿ƒä¸‹å•åŠŸèƒ½

é™çº§ç­–ç•¥ï¼š
- æš‚åœéæ ¸å¿ƒåŠŸèƒ½
- ä½¿ç”¨ç¼“å­˜æ•°æ®ä»£æ›¿å®æ—¶æ•°æ®
- ç®€åŒ–å¤„ç†é€»è¾‘
- å»¶è¿Ÿå¤„ç†éç´§æ€¥æ¶ˆæ¯
```

**ğŸ”¸ é™çº§ç­–ç•¥å®ç°**
```java
public class DegradationHandler {
    private boolean degradationEnabled = false;
    
    // ä¸åŒçº§åˆ«çš„é™çº§ç­–ç•¥
    public void processWithDegradation(ConsumerRecord<String, String> record) {
        if (degradationEnabled) {
            // é™çº§å¤„ç†ï¼šåªå¤„ç†æ ¸å¿ƒæ¶ˆæ¯
            if (isCriticalMessage(record)) {
                processCore Message(record);
            } else {
                // éæ ¸å¿ƒæ¶ˆæ¯å»¶è¿Ÿå¤„ç†
                sendToDelayedQueue(record);
            }
        } else {
            // æ­£å¸¸å¤„ç†
            processMessage(record);
        }
    }
    
    private boolean isCriticalMessage(ConsumerRecord<String, String> record) {
        // åˆ¤æ–­æ¶ˆæ¯ä¼˜å…ˆçº§
        String priority = getMessagePriority(record);
        return "HIGH".equals(priority) || "CRITICAL".equals(priority);
    }
    
    // ç›‘æ§ç³»ç»Ÿè´Ÿè½½ï¼Œå†³å®šæ˜¯å¦å¯ç”¨é™çº§
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥
    public void checkSystemLoad() {
        double cpuUsage = getSystemCpuUsage();
        long memoryUsage = getMemoryUsage();
        
        if (cpuUsage > 80 || memoryUsage > 85) {
            degradationEnabled = true;
            logger.warn("System overload detected, enabling degradation mode");
        } else if (cpuUsage < 60 && memoryUsage < 70) {
            degradationEnabled = false;
            logger.info("System recovered, disabling degradation mode");
        }
    }
}
```

---

## 7. ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»


### 7.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ é”™è¯¯ç‡ç›‘æ§**
```java
public class ErrorRateMonitor {
    private final AtomicLong totalMessages = new AtomicLong(0);
    private final AtomicLong errorMessages = new AtomicLong(0);
    private final Timer timer = Timer.system();
    
    public void recordMessage(boolean isError) {
        totalMessages.incrementAndGet();
        if (isError) {
            errorMessages.incrementAndGet();
        }
    }
    
    public double getErrorRate() {
        long total = totalMessages.get();
        if (total == 0) return 0.0;
        return (double) errorMessages.get() / total * 100;
    }
    
    // å®šæœŸé‡ç½®è®¡æ•°å™¨ï¼Œè®¡ç®—æ—¶é—´çª—å£å†…çš„é”™è¯¯ç‡
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿ
    public void resetCounters() {
        double currentErrorRate = getErrorRate();
        
        // å‘é€ç›‘æ§æ•°æ®åˆ°ç›‘æ§ç³»ç»Ÿ
        sendMetrics("kafka.error.rate", currentErrorRate);
        
        // æ£€æŸ¥å‘Šè­¦é˜ˆå€¼
        if (currentErrorRate > 5.0) { // é”™è¯¯ç‡è¶…è¿‡5%
            sendAlert("Kafka error rate is high: " + currentErrorRate + "%");
        }
        
        // é‡ç½®è®¡æ•°å™¨
        totalMessages.set(0);
        errorMessages.set(0);
    }
}
```

**ğŸ”¸ å¤„ç†å»¶è¿Ÿç›‘æ§**
```java
public class LatencyMonitor {
    private final Timer.Sample sample = Timer.start();
    
    public void startTiming() {
        sample = Timer.start();
    }
    
    public void recordTiming(String operation) {
        Duration duration = sample.stop(Timer.builder("kafka.processing.time")
                                        .tag("operation", operation)
                                        .register());
        
        // æ£€æŸ¥å¤„ç†æ—¶é—´æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        if (duration.toMillis() > 5000) { // è¶…è¿‡5ç§’
            logger.warn("Slow message processing detected: {}ms for operation: {}", 
                       duration.toMillis(), operation);
        }
    }
}
```

### 7.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»


| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| ğŸ”´ **é”™è¯¯ç‡** | `æ¶ˆæ¯å¤„ç†å¤±è´¥ç‡` | `< 1%` | `> 5%` |
| â±ï¸ **å»¶è¿Ÿ** | `æ¶ˆæ¯å¤„ç†è€—æ—¶` | `< 1ç§’` | `> 5ç§’` |
| ğŸ“Š **ååé‡** | `æ¯ç§’å¤„ç†æ¶ˆæ¯æ•°` | `> 1000` | `< 100` |
| ğŸ’€ **æ­»ä¿¡é˜Ÿåˆ—** | `æ­»ä¿¡æ¶ˆæ¯æ•°é‡` | `< 10` | `> 100` |
| ğŸ”„ **é‡è¯•æ¬¡æ•°** | `å¹³å‡é‡è¯•æ¬¡æ•°` | `< 0.1` | `> 1.0` |

### 7.3 å‘Šè­¦æœºåˆ¶è®¾è®¡


**ğŸ”¸ åˆ†çº§å‘Šè­¦ç­–ç•¥**
```java
public enum AlertLevel {
    INFO(0, "ä¿¡æ¯"),
    WARN(1, "è­¦å‘Š"), 
    ERROR(2, "é”™è¯¯"),
    CRITICAL(3, "ç´§æ€¥");
    
    private final int level;
    private final String description;
}

public class AlertManager {
    public void sendAlert(AlertLevel level, String message, Map<String, Object> details) {
        Alert alert = Alert.builder()
                .level(level)
                .message(message)
                .timestamp(Instant.now())
                .details(details)
                .build();
        
        switch (level) {
            case INFO:
                // åªè®°å½•æ—¥å¿—
                logger.info("Alert: {}", alert);
                break;
            case WARN:
                // è®°å½•æ—¥å¿— + å‘é€é‚®ä»¶
                logger.warn("Alert: {}", alert);
                emailService.sendAlert(alert);
                break;
            case ERROR:
                // è®°å½•æ—¥å¿— + é‚®ä»¶ + çŸ­ä¿¡
                logger.error("Alert: {}", alert);
                emailService.sendAlert(alert);
                smsService.sendAlert(alert);
                break;
            case CRITICAL:
                // æ‰€æœ‰é€šçŸ¥æ–¹å¼ + ç”µè¯
                logger.error("CRITICAL Alert: {}", alert);
                emailService.sendAlert(alert);
                smsService.sendAlert(alert);
                phoneService.sendAlert(alert);
                break;
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é”™è¯¯åˆ†ç±»ï¼šç½‘ç»œé”™è¯¯ã€åºåˆ—åŒ–é”™è¯¯ã€ä¸šåŠ¡é”™è¯¯
ğŸ”¸ é‡è¯•ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ã€æœ€å¤§æ¬¡æ•°ã€æŠ–åŠ¨æœºåˆ¶
ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—ï¼šå­˜æ”¾æ— æ³•å¤„ç†çš„æ¶ˆæ¯ï¼Œä¾¿äºåˆ†æå’Œä¿®å¤
ğŸ”¸ æ¯’æ¶ˆæ¯ï¼šåå¤å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼Œéœ€è¦éš”ç¦»å¤„ç†
ğŸ”¸ ç†”æ–­æœºåˆ¶ï¼šç³»ç»Ÿè¿‡è½½æ—¶è‡ªåŠ¨åœæ­¢å¤„ç†ï¼Œä¿æŠ¤æ•´ä½“ç¨³å®š
ğŸ”¸ é™çº§ç­–ç•¥ï¼šä¼˜å…ˆä¿è¯æ ¸å¿ƒåŠŸèƒ½ï¼Œæš‚åœéæ ¸å¿ƒå¤„ç†
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é”™è¯¯å¤„ç†çš„å¹³è¡¡è‰ºæœ¯**
```
å¯é æ€§ vs æ€§èƒ½ï¼š
- è¿‡åº¦é‡è¯•å½±å“æ€§èƒ½
- è¿‡å°‘é‡è¯•å½±å“å¯é æ€§
- éœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹æ‰¾å¹³è¡¡ç‚¹

è‡ªåŠ¨åŒ– vs äººå·¥å¹²é¢„ï¼š
- è‡ªåŠ¨é‡è¯•å¤„ç†ä¸´æ—¶é”™è¯¯
- äººå·¥å¤„ç†å¤æ‚ä¸šåŠ¡é”™è¯¯
- å»ºç«‹åˆç†çš„åˆ†å·¥æœºåˆ¶
```

**ğŸ”¹ åˆ†å±‚é˜²æŠ¤æ€æƒ³**
```
ç¬¬ä¸€å±‚ï¼šé‡è¯•æœºåˆ¶ - å¤„ç†ä¸´æ—¶æ€§é”™è¯¯
ç¬¬äºŒå±‚ï¼šç†”æ–­æœºåˆ¶ - é˜²æ­¢ç³»ç»Ÿå´©æºƒ  
ç¬¬ä¸‰å±‚ï¼šé™çº§æœºåˆ¶ - ä¿è¯æ ¸å¿ƒåŠŸèƒ½
ç¬¬å››å±‚ï¼šæ­»ä¿¡é˜Ÿåˆ— - ä¿ç•™é—®é¢˜æ•°æ®
ç¬¬äº”å±‚ï¼šç›‘æ§å‘Šè­¦ - åŠæ—¶äººå·¥ä»‹å…¥
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æœ€ä½³å®è·µæ¸…å•**
- âœ… **åŒºåˆ†é”™è¯¯ç±»å‹**ï¼šå¯é‡è¯• vs ä¸å¯é‡è¯•
- âœ… **åˆç†è®¾ç½®é‡è¯•**ï¼šæ¬¡æ•°ã€é—´éš”ã€æ€»æ—¶é—´
- âœ… **å®ç°å¹‚ç­‰æ€§**ï¼šé¿å…é‡å¤å¤„ç†å‰¯ä½œç”¨
- âœ… **ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼šé”™è¯¯ç‡ã€å»¶è¿Ÿã€ååé‡
- âœ… **å»ºç«‹å‘Šè­¦æœºåˆ¶**ï¼šåˆ†çº§å‘Šè­¦ã€å¤šæ¸ é“é€šçŸ¥
- âœ… **å®šæœŸæ¸…ç†**ï¼šæ­»ä¿¡é˜Ÿåˆ—ã€æ—¥å¿—æ–‡ä»¶
- âœ… **å‹åŠ›æµ‹è¯•**ï¼šéªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶æœ‰æ•ˆæ€§

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**
```
é—®é¢˜1ï¼šæ¶ˆæ¯å †ç§¯ä¸¥é‡
è§£å†³ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ¯’æ¶ˆæ¯ï¼Œå¢åŠ æ¶ˆè´¹è€…å®ä¾‹

é—®é¢˜2ï¼šæ­»ä¿¡é˜Ÿåˆ—å¢é•¿å¿«
è§£å†³ï¼šåˆ†æé”™è¯¯åŸå› ï¼Œä¿®å¤æ ¹æœ¬é—®é¢˜

é—®é¢˜3ï¼šç³»ç»Ÿé¢‘ç¹å‘Šè­¦
è§£å†³ï¼šè°ƒæ•´å‘Šè­¦é˜ˆå€¼ï¼Œæ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘

é—®é¢˜4ï¼šé‡è¯•é£æš´
è§£å†³ï¼šå¢åŠ éšæœºæŠ–åŠ¨ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Kafkaé”™è¯¯å¤„ç†è¦åˆ†ç±»åˆ†çº§ï¼Œä¸èƒ½ä¸€åˆ€åˆ‡
- é‡è¯•è¦é€‚åº¦ï¼ŒæŒ‡æ•°é€€é¿æ˜¯æœ€ä½³é€‰æ‹©
- æ­»ä¿¡é˜Ÿåˆ—æ˜¯æœ€åé˜²çº¿ï¼Œæ¯’æ¶ˆæ¯è¦éš”ç¦»
- ç›‘æ§å‘Šè­¦è¦åŠæ—¶ï¼Œåˆ†çº§å¤„ç†ä¸æ…Œä¹±
- ç³»ç»Ÿç¨³å®šæœ€é‡è¦ï¼Œæ€§èƒ½ä¼˜åŒ–è¦å…¼é¡¾