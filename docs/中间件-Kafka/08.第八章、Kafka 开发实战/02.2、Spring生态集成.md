---
title: 2ã€Springç”Ÿæ€é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Spring Booté›†æˆKafkaåŸºç¡€](#1-spring-booté›†æˆkafkaåŸºç¡€)
2. [Spring Kafkaæ ¸å¿ƒé…ç½®è¯¦è§£](#2-spring-kafkaæ ¸å¿ƒé…ç½®è¯¦è§£)
3. [@KafkaListeneræ¶ˆæ¯ç›‘å¬è¯¦è§£](#3-kafkalisteneræ¶ˆæ¯ç›‘å¬è¯¦è§£)
4. [KafkaTemplateæ¶ˆæ¯å‘é€å®æˆ˜](#4-kafkatemplateæ¶ˆæ¯å‘é€å®æˆ˜)
5. [æ¶ˆæ¯ç›‘å¬å®¹å™¨æ·±å…¥ç†è§£](#5-æ¶ˆæ¯ç›‘å¬å®¹å™¨æ·±å…¥ç†è§£)
6. [é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶](#6-é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶)
7. [äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§ä¿éšœ](#7-äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§ä¿éšœ)
8. [Spring Cloudé›†æˆå®æˆ˜](#8-spring-cloudé›†æˆå®æˆ˜)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Spring Booté›†æˆKafkaåŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Spring Booté›†æˆKafka


ğŸ’­ **ç®€å•ç†è§£**ï¼šå°±åƒç»™ä½ çš„Spring Bootåº”ç”¨è£…ä¸Šäº†ä¸€å¥—"æ¶ˆæ¯æ”¶å‘ç³»ç»Ÿ"ï¼Œè®©ä¸åŒçš„æœåŠ¡ä¹‹é—´å¯ä»¥é€šè¿‡Kafkaæ¥ä¼ é€’æ¶ˆæ¯ï¼Œè€Œä¸éœ€è¦ç›´æ¥è°ƒç”¨å¯¹æ–¹ã€‚

**ğŸ·ï¸ æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Spring Kafka** = Springå®˜æ–¹æä¾›çš„Kafkaå®¢æˆ·ç«¯å°è£…
- **å¼€ç®±å³ç”¨** = æ·»åŠ ä¾èµ–å°±èƒ½ç”¨ï¼Œé…ç½®ç®€å•
- **è‡ªåŠ¨è£…é…** = Spring Bootè‡ªåŠ¨å¸®ä½ é…ç½®å¥½å¤§éƒ¨åˆ†è®¾ç½®

### 1.2 å¿«é€Ÿå…¥é—¨æ­å»º


**ğŸ“š å‰ç½®çŸ¥è¯†**ï¼šä½ éœ€è¦äº†è§£Spring BootåŸºç¡€å’ŒMaven/Gradleæ„å»ºå·¥å…·

**ğŸ¯ å­¦ä¹ ç›®æ ‡**ï¼š5åˆ†é’Ÿå†…è®©ä½ çš„Spring Bootåº”ç”¨èƒ½æ”¶å‘Kafkaæ¶ˆæ¯

**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
    <version>2.9.0</version>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šåŸºç¡€é…ç½®**

```yaml
# application.yml
spring:
  kafka:
    bootstrap-servers: localhost:9092  # KafkaæœåŠ¡å™¨åœ°å€
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
    consumer:
      group-id: my-group  # æ¶ˆè´¹è€…ç»„ID
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
```

ğŸ” **æ·±å…¥ç†è§£**ï¼šè¿™ä¸ªé…ç½®å‘Šè¯‰Spring Bootï¼š
- å»å“ªé‡Œæ‰¾KafkaæœåŠ¡å™¨ï¼ˆbootstrap-serversï¼‰
- å‘æ¶ˆæ¯æ—¶å¦‚ä½•æŠŠå¯¹è±¡è½¬æˆå­—èŠ‚ï¼ˆserializerï¼‰
- æ”¶æ¶ˆæ¯æ—¶å¦‚ä½•æŠŠå­—èŠ‚è½¬æˆå¯¹è±¡ï¼ˆdeserializerï¼‰
- è¿™ä¸ªåº”ç”¨å±äºå“ªä¸ªæ¶ˆè´¹è€…ç»„ï¼ˆgroup-idï¼‰

**ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ¶ˆæ¯å‘é€è€…**

```java
@Service
public class MessageProducer {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    public void sendMessage(String topic, String message) {
        kafkaTemplate.send(topic, message);
        System.out.println("æ¶ˆæ¯å·²å‘é€: " + message);
    }
}
```

**ç¬¬å››æ­¥ï¼šåˆ›å»ºæ¶ˆæ¯æ¥æ”¶è€…**

```java
@Component
public class MessageConsumer {
    
    @KafkaListener(topics = "test-topic")
    public void listen(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
    }
}
```

âœ… **å¿«é€ŸéªŒè¯**ï¼šå¯åŠ¨åº”ç”¨åï¼Œè°ƒç”¨`sendMessage("test-topic", "Hello Kafka!")`ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°æ¶ˆæ¯è¢«å‘é€å’Œæ¥æ”¶ã€‚

### 1.3 é›†æˆæ¶æ„ç†è§£


```
Spring Boot åº”ç”¨æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Spring Boot åº”ç”¨           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controller â†’ Service â†’ Producer     â”‚ â† ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Spring Kafka å°è£…å±‚             â”‚ â† ç®€åŒ–API
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Kafka Client å®¢æˆ·ç«¯           â”‚ â† åŸç”Ÿå®¢æˆ·ç«¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Kafka é›†ç¾¤                 â”‚ â† æ¶ˆæ¯å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸŒ° ä¸¾ä¸ªä¾‹å­**ï¼š
- åŸç”ŸKafkaå®¢æˆ·ç«¯ï¼šåƒç›´æ¥æ“ä½œæ•°æ®åº“è¿æ¥
- Spring Kafkaï¼šåƒä½¿ç”¨JdbcTemplate
- Spring Booté›†æˆï¼šåƒä½¿ç”¨Spring Data JPAï¼Œæ›´åŠ ç®€åŒ–

---

## 2. âš™ï¸ Spring Kafkaæ ¸å¿ƒé…ç½®è¯¦è§£


### 2.1 ç”Ÿäº§è€…é…ç½®æ·±åº¦è§£æ


**ğŸ”¸ æ ¸å¿ƒé…ç½®é¡¹**ï¼š

```yaml
spring:
  kafka:
    producer:
      bootstrap-servers: localhost:9092
      # ğŸ”‘ å…³é”®é…ç½®è¯´æ˜
      acks: all                    # ç¡®è®¤æœºåˆ¶ï¼šall=æœ€å®‰å…¨ï¼Œ1=ä¸­ç­‰ï¼Œ0=æœ€å¿«
      retries: 3                   # é‡è¯•æ¬¡æ•°ï¼šå‘é€å¤±è´¥æ—¶é‡è¯•å‡ æ¬¡
      batch-size: 16384            # æ‰¹æ¬¡å¤§å°ï¼šç§¯ç´¯å¤šå°‘å­—èŠ‚åå‘é€
      buffer-memory: 33554432      # ç¼“å†²å†…å­˜ï¼šç”Ÿäº§è€…ç¼“å†²åŒºå¤§å°
      linger-ms: 5                 # ç­‰å¾…æ—¶é—´ï¼šå»¶è¿Ÿå¤šä¹…å‘é€ä»¥æé«˜ååé‡
      
      # åºåˆ—åŒ–é…ç½®
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      
      # è‡ªå®šä¹‰é…ç½®
      properties:
        compression.type: gzip     # å‹ç¼©ç±»å‹ï¼šå‡å°‘ç½‘ç»œä¼ è¾“
        max.request.size: 1048576  # æœ€å¤§è¯·æ±‚å¤§å°
```

ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼š
- `acks=all`ï¼šåƒå¯„é‡è¦æ–‡ä»¶ï¼Œè¦æ‰€æœ‰äººç­¾æ”¶æ‰æ”¾å¿ƒ
- `batch-size`ï¼šåƒæ‹¼è½¦ï¼Œæ”’å¤Ÿäººå†å‘è½¦ï¼Œæé«˜æ•ˆç‡
- `linger-ms`ï¼šåƒå…¬äº¤è½¦ï¼Œç­‰å‡ ç§’çœ‹è¿˜æœ‰æ²¡æœ‰äººä¸Šè½¦
- `compression.type`ï¼šåƒå‹ç¼©åŒ…ï¼Œå‡å°‘ä¼ è¾“æ—¶é—´

### 2.2 æ¶ˆè´¹è€…é…ç½®æ·±åº¦è§£æ


```yaml
spring:
  kafka:
    consumer:
      bootstrap-servers: localhost:9092
      group-id: my-consumer-group
      
      # ğŸ”‘ å…³é”®é…ç½®è¯´æ˜
      auto-offset-reset: earliest    # åç§»é‡é‡ç½®ï¼šearliest=ä»å¤´å¼€å§‹ï¼Œlatest=ä»æœ€æ–°
      enable-auto-commit: true       # è‡ªåŠ¨æäº¤ï¼šæ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
      auto-commit-interval: 1000     # æäº¤é—´éš”ï¼šå¤šä¹…æäº¤ä¸€æ¬¡åç§»é‡
      session-timeout-ms: 30000      # ä¼šè¯è¶…æ—¶ï¼šå¤šä¹…æ— å“åº”è®¤ä¸ºæ¶ˆè´¹è€…æ­»äº†
      heartbeat-interval-ms: 3000    # å¿ƒè·³é—´éš”ï¼šå¤šä¹…å‘ä¸€æ¬¡å¿ƒè·³
      max-poll-records: 500          # æ‰¹æ¬¡å¤§å°ï¼šä¸€æ¬¡æ‹‰å–å¤šå°‘æ¡æ¶ˆæ¯
      
      # ååºåˆ—åŒ–é…ç½®
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      
      properties:
        spring.json.trusted.packages: "com.example.model"  # ä¿¡ä»»çš„åŒ…å
```

ğŸ¤” **ä¸ºä»€ä¹ˆè¿™æ ·é…ç½®**ï¼š
- `auto-offset-reset=earliest`ï¼šæ–°æ¶ˆè´¹è€…åŠ å…¥æ—¶ä»å¤´å¼€å§‹æ¶ˆè´¹ï¼Œä¸ä¸¢æ¶ˆæ¯
- `enable-auto-commit=true`ï¼šè‡ªåŠ¨ç¡®è®¤ï¼Œç®€åŒ–ç¼–ç¨‹ä½†å¯èƒ½é‡å¤æ¶ˆè´¹
- `max-poll-records=500`ï¼šæ‰¹é‡å¤„ç†æé«˜æ•ˆç‡ï¼Œä½†ä¸è¦å¤ªå¤§å½±å“å®æ—¶æ€§

### 2.3 é«˜çº§é…ç½®å®šåˆ¶


```java
@Configuration
@EnableKafka
public class KafkaConfig {
    
    // ğŸ”§ ç”Ÿäº§è€…é…ç½®å®šåˆ¶
    @Bean
    public ProducerFactory<String, Object> producerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);
        
        // é«˜çº§é…ç½®
        configProps.put(ProducerConfig.ACKS_CONFIG, "all");
        configProps.put(ProducerConfig.RETRIES_CONFIG, 3);
        configProps.put(ProducerConfig.BATCH_SIZE_CONFIG, 16384);
        
        return new DefaultKafkaProducerFactory<>(configProps);
    }
    
    @Bean
    public KafkaTemplate<String, Object> kafkaTemplate() {
        return new KafkaTemplate<>(producerFactory());
    }
    
    // ğŸ”§ æ¶ˆè´¹è€…é…ç½®å®šåˆ¶
    @Bean
    public ConsumerFactory<String, Object> consumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "my-group");
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class);
        props.put(JsonDeserializer.TRUSTED_PACKAGES, "*");
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
}
```

ğŸ“‹ **é…ç½®ä¼˜å…ˆçº§**ï¼šJavaé…ç½® > application.yml > é»˜è®¤å€¼

---

## 3. ğŸ§ @KafkaListeneræ¶ˆæ¯ç›‘å¬è¯¦è§£


### 3.1 åŸºç¡€ç›‘å¬ç”¨æ³•


**ğŸ·ï¸ ä»€ä¹ˆæ˜¯@KafkaListener**ï¼šå°±åƒç»™ä½ çš„æ–¹æ³•è£…ä¸Šäº†"ç›‘å¬å™¨"ï¼Œæœ‰æ¶ˆæ¯æ¥äº†å°±è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚

```java
@Component
public class MessageListener {
    
    // æœ€ç®€å•çš„ç›‘å¬
    @KafkaListener(topics = "simple-topic")
    public void listen(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
    }
    
    // ç›‘å¬å¤šä¸ªä¸»é¢˜
    @KafkaListener(topics = {"topic1", "topic2", "topic3"})
    public void listenMultipleTopics(String message) {
        System.out.println("ä»å¤šä¸ªä¸»é¢˜æ”¶åˆ°: " + message);
    }
    
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ç›‘å¬
    @KafkaListener(topicPattern = "user-.*")  // ç›‘å¬æ‰€æœ‰ä»¥user-å¼€å¤´çš„ä¸»é¢˜
    public void listenPattern(String message) {
        System.out.println("æ¨¡å¼åŒ¹é…æ¶ˆæ¯: " + message);
    }
}
```

### 3.2 è·å–æ¶ˆæ¯è¯¦ç»†ä¿¡æ¯


```java
@Component
public class DetailedListener {
    
    // è·å–å®Œæ•´çš„æ¶ˆæ¯è®°å½•
    @KafkaListener(topics = "detailed-topic")
    public void listenWithDetails(ConsumerRecord<String, String> record) {
        System.out.println("ä¸»é¢˜: " + record.topic());
        System.out.println("åˆ†åŒº: " + record.partition());
        System.out.println("åç§»é‡: " + record.offset());
        System.out.println("é”®: " + record.key());
        System.out.println("å€¼: " + record.value());
        System.out.println("æ—¶é—´æˆ³: " + record.timestamp());
    }
    
    // è·å–æ¶ˆæ¯å¤´ä¿¡æ¯
    @KafkaListener(topics = "header-topic")
    public void listenWithHeaders(@Payload String message, 
                                 @Header Map<String, Object> headers) {
        System.out.println("æ¶ˆæ¯å†…å®¹: " + message);
        System.out.println("æ¶ˆæ¯å¤´: " + headers);
    }
    
    // æ‰¹é‡å¤„ç†æ¶ˆæ¯
    @KafkaListener(topics = "batch-topic", 
                   containerFactory = "batchListenerContainerFactory")
    public void listenBatch(List<String> messages) {
        System.out.println("æ‰¹é‡å¤„ç† " + messages.size() + " æ¡æ¶ˆæ¯");
        messages.forEach(System.out::println);
    }
}
```

ğŸ” **æ·±å…¥ç†è§£**ï¼š
- `ConsumerRecord`ï¼šåŒ…å«æ¶ˆæ¯çš„æ‰€æœ‰ä¿¡æ¯ï¼Œåƒå¿«é€’åŒ…è£¹çš„è¯¦æƒ…å•
- `@Header`ï¼šè·å–æ¶ˆæ¯å¤´ï¼Œåƒå¿«é€’çš„é™„åŠ æ ‡ç­¾
- æ‰¹é‡å¤„ç†ï¼šä¸€æ¬¡å¤„ç†å¤šæ¡æ¶ˆæ¯ï¼Œæé«˜æ•ˆç‡

### 3.3 æ¡ä»¶ç›‘å¬å’ŒåŠ¨æ€é…ç½®


```java
@Component
public class ConditionalListener {
    
    // æ ¹æ®æ¡ä»¶ç›‘å¬
    @KafkaListener(
        topics = "conditional-topic",
        condition = "#{headers['type'] == 'important'}"  // åªå¤„ç†é‡è¦æ¶ˆæ¯
    )
    public void listenImportant(String message) {
        System.out.println("å¤„ç†é‡è¦æ¶ˆæ¯: " + message);
    }
    
    // åŠ¨æ€ä¸»é¢˜é…ç½®
    @KafkaListener(topics = "#{@topicConfig.getUserTopic()}")
    public void listenDynamicTopic(String message) {
        System.out.println("åŠ¨æ€ä¸»é¢˜æ¶ˆæ¯: " + message);
    }
    
    // æŒ‡å®šæ¶ˆè´¹è€…ç»„
    @KafkaListener(
        topics = "group-topic",
        groupId = "special-group"
    )
    public void listenWithGroup(String message) {
        System.out.println("ç‰¹æ®Šç»„æ¶ˆæ¯: " + message);
    }
}

@Configuration
public class TopicConfig {
    public String getUserTopic() {
        return "user-" + getCurrentEnvironment();
    }
    
    private String getCurrentEnvironment() {
        return "dev"; // å®é™…é¡¹ç›®ä¸­ä»é…ç½®è·å–
    }
}
```

### 3.4 JSONæ¶ˆæ¯å¤„ç†


```java
@Component
public class JsonListener {
    
    // è‡ªåŠ¨ååºåˆ—åŒ–ä¸ºå¯¹è±¡
    @KafkaListener(topics = "user-topic")
    public void listenUser(User user) {
        System.out.println("æ”¶åˆ°ç”¨æˆ·: " + user.getName());
        System.out.println("å¹´é¾„: " + user.getAge());
    }
    
    // å¤„ç†å¤æ‚å¯¹è±¡
    @KafkaListener(topics = "order-topic")
    public void listenOrder(Order order) {
        System.out.println("è®¢å•ID: " + order.getId());
        System.out.println("å•†å“æ•°é‡: " + order.getItems().size());
        // å¤„ç†è®¢å•é€»è¾‘
        processOrder(order);
    }
    
    private void processOrder(Order order) {
        // è®¢å•å¤„ç†é€»è¾‘
        System.out.println("æ­£åœ¨å¤„ç†è®¢å•...");
    }
}

// æ¶ˆæ¯å¯¹è±¡
public class User {
    private String name;
    private int age;
    // getters and setters
}

public class Order {
    private String id;
    private List<OrderItem> items;
    // getters and setters
}
```

**ğŸ’¡ å…³é”®æé†’**ï¼šä½¿ç”¨JSONæ—¶è¦ç¡®ä¿ï¼š
1. ç±»æœ‰æ— å‚æ„é€ å‡½æ•°
2. å±æ€§æœ‰getter/setteræ–¹æ³•
3. é…ç½®äº†æ­£ç¡®çš„ååºåˆ—åŒ–å™¨

---

## 4. ğŸ“¤ KafkaTemplateæ¶ˆæ¯å‘é€å®æˆ˜


### 4.1 åŸºç¡€å‘é€æ“ä½œ


**ğŸ·ï¸ KafkaTemplateæ˜¯ä»€ä¹ˆ**ï¼šå°±åƒä½ çš„"æ¶ˆæ¯å‘é€å·¥å…·"ï¼Œå°è£…äº†å¤æ‚çš„å‘é€é€»è¾‘ï¼Œä½ åªéœ€è¦è¯´å‘ä»€ä¹ˆã€å‘åˆ°å“ªé‡Œå°±è¡Œã€‚

```java
@Service
public class MessageService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // ğŸ”¸ æœ€ç®€å•çš„å‘é€
    public void sendSimpleMessage(String message) {
        kafkaTemplate.send("simple-topic", message);
    }
    
    // ğŸ”¸ æŒ‡å®škeyå‘é€ï¼ˆç”¨äºåˆ†åŒºè·¯ç”±ï¼‰
    public void sendWithKey(String key, String message) {
        kafkaTemplate.send("keyed-topic", key, message);
    }
    
    // ğŸ”¸ å‘é€åˆ°æŒ‡å®šåˆ†åŒº
    public void sendToPartition(int partition, String message) {
        kafkaTemplate.send("partitioned-topic", partition, null, message);
    }
    
    // ğŸ”¸ å‘é€å¤æ‚å¯¹è±¡
    public void sendUser(User user) {
        kafkaTemplate.send("user-topic", user);
    }
}
```

### 4.2 å¼‚æ­¥å‘é€ä¸å›è°ƒå¤„ç†


```java
@Service
public class AsyncMessageService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // å¼‚æ­¥å‘é€withå›è°ƒ
    public void sendWithCallback(String topic, String message) {
        ListenableFuture<SendResult<String, Object>> future = 
            kafkaTemplate.send(topic, message);
        
        // æ·»åŠ æˆåŠŸå›è°ƒ
        future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
            @Override
            public void onSuccess(SendResult<String, Object> result) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ: " + message);
                System.out.println("åˆ†åŒº: " + result.getRecordMetadata().partition());
                System.out.println("åç§»é‡: " + result.getRecordMetadata().offset());
            }
            
            @Override
            public void onFailure(Throwable ex) {
                System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥: " + ex.getMessage());
                // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¯•é€»è¾‘
                handleSendFailure(message, ex);
            }
        });
    }
    
    private void handleSendFailure(String message, Throwable ex) {
        // å¤±è´¥å¤„ç†é€»è¾‘ï¼šè®°å½•æ—¥å¿—ã€é‡è¯•ã€æŠ¥è­¦ç­‰
        System.err.println("å¤„ç†å‘é€å¤±è´¥: " + message);
    }
}
```

ğŸ¤” **ä¸ºä»€ä¹ˆç”¨å¼‚æ­¥**ï¼š
- ä¸é˜»å¡ä¸šåŠ¡é€»è¾‘
- å¯ä»¥åŒæ—¶å‘é€å¤šæ¡æ¶ˆæ¯
- é€šè¿‡å›è°ƒå¤„ç†ç»“æœ

### 4.3 æ‰¹é‡å‘é€ä¼˜åŒ–


```java
@Service
public class BatchMessageService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // æ‰¹é‡å‘é€å¤šæ¡æ¶ˆæ¯
    public void sendBatch(String topic, List<String> messages) {
        List<ListenableFuture<SendResult<String, Object>>> futures = new ArrayList<>();
        
        // å‘é€æ‰€æœ‰æ¶ˆæ¯
        for (String message : messages) {
            ListenableFuture<SendResult<String, Object>> future = 
                kafkaTemplate.send(topic, message);
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰å‘é€å®Œæˆ
        futures.forEach(future -> {
            try {
                future.get(); // ç­‰å¾…å‘é€å®Œæˆ
            } catch (Exception e) {
                System.err.println("æ‰¹é‡å‘é€ä¸­æœ‰æ¶ˆæ¯å¤±è´¥: " + e.getMessage());
            }
        });
        
        System.out.println("æ‰¹é‡å‘é€å®Œæˆï¼Œå…± " + messages.size() + " æ¡æ¶ˆæ¯");
    }
    
    // ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å‘é€
    @Transactional("kafkaTransactionManager")
    public void sendBatchInTransaction(String topic, List<String> messages) {
        try {
            for (String message : messages) {
                kafkaTemplate.send(topic, message);
            }
            // å¦‚æœæ‰€æœ‰å‘é€éƒ½æˆåŠŸï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨æäº¤
        } catch (Exception e) {
            // å¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œäº‹åŠ¡ä¼šå›æ»š
            throw new RuntimeException("æ‰¹é‡å‘é€å¤±è´¥", e);
        }
    }
}
```

### 4.4 è‡ªå®šä¹‰å‘é€é…ç½®


```java
@Service
public class CustomSendService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // å‘é€å¸¦å¤´ä¿¡æ¯çš„æ¶ˆæ¯
    public void sendWithHeaders(String topic, String message, Map<String, Object> headers) {
        ProducerRecord<String, Object> record = new ProducerRecord<>(topic, message);
        
        // æ·»åŠ è‡ªå®šä¹‰å¤´ä¿¡æ¯
        headers.forEach((key, value) -> 
            record.headers().add(key, value.toString().getBytes())
        );
        
        kafkaTemplate.send(record);
    }
    
    // å‘é€å»¶æ—¶æ¶ˆæ¯ï¼ˆéœ€è¦Kafka 2.8+ï¼‰
    public void sendDelayedMessage(String topic, String message, long delayMs) {
        ProducerRecord<String, Object> record = new ProducerRecord<>(topic, message);
        
        // è®¾ç½®æ—¶é—´æˆ³ä¸ºå½“å‰æ—¶é—´+å»¶è¿Ÿæ—¶é—´
        record = new ProducerRecord<>(
            topic, 
            null, 
            System.currentTimeMillis() + delayMs,
            null, 
            message
        );
        
        kafkaTemplate.send(record);
    }
    
    // æ¡ä»¶å‘é€
    public void sendIfCondition(String topic, String message, boolean condition) {
        if (condition) {
            kafkaTemplate.send(topic, message);
            System.out.println("æ¡ä»¶æ»¡è¶³ï¼Œæ¶ˆæ¯å·²å‘é€");
        } else {
            System.out.println("æ¡ä»¶ä¸æ»¡è¶³ï¼Œæ¶ˆæ¯æœªå‘é€");
        }
    }
}
```

---

## 5. ğŸ›ï¸ æ¶ˆæ¯ç›‘å¬å®¹å™¨æ·±å…¥ç†è§£


### 5.1 ä»€ä¹ˆæ˜¯ç›‘å¬å®¹å™¨


ğŸ’­ **é€šä¿—ç†è§£**ï¼šç›‘å¬å®¹å™¨å°±åƒä¸€ä¸ª"æ¶ˆæ¯æ¥æ”¶ç®¡ç†å‘˜"ï¼Œå®ƒè´Ÿè´£ï¼š
- ä»Kafkaæ‹‰å–æ¶ˆæ¯
- åˆ†é…æ¶ˆæ¯ç»™å¯¹åº”çš„ç›‘å¬æ–¹æ³•
- ç®¡ç†æ¶ˆè´¹è€…çš„ç”Ÿå‘½å‘¨æœŸ
- å¤„ç†é”™è¯¯å’Œé‡è¯•

```
ç›‘å¬å®¹å™¨å·¥ä½œæµç¨‹ï¼š

æ¶ˆè´¹è€…1 â†â”
æ¶ˆè´¹è€…2 â† ç›‘å¬å®¹å™¨ â† Kafkaé›†ç¾¤
æ¶ˆè´¹è€…3 â†â”˜    â†“
               ç›‘å¬æ–¹æ³•(@KafkaListener)
```

### 5.2 å®¹å™¨é…ç½®å®šåˆ¶


```java
@Configuration
@EnableKafka
public class KafkaListenerConfig {
    
    @Bean
    public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>>
            kafkaListenerContainerFactory() {
        
        ConcurrentKafkaListenerContainerFactory<String, String> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        
        factory.setConsumerFactory(consumerFactory());
        
        // ğŸ”§ å…³é”®é…ç½®
        factory.setConcurrency(3); // å¹¶å‘æ¶ˆè´¹è€…æ•°é‡
        factory.getContainerProperties().setPollTimeout(3000); // è½®è¯¢è¶…æ—¶
        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL); // æ‰‹åŠ¨ç¡®è®¤
        
        return factory;
    }
    
    // æ‰¹é‡å¤„ç†å®¹å™¨é…ç½®
    @Bean
    public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>>
            batchListenerContainerFactory() {
        
        ConcurrentKafkaListenerContainerFactory<String, String> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        
        factory.setConsumerFactory(consumerFactory());
        factory.setBatchListener(true); // å¯ç”¨æ‰¹é‡ç›‘å¬
        
        return factory;
    }
}
```

ğŸ” **é…ç½®è¯¦è§£**ï¼š
- `setConcurrency(3)`ï¼šå¯åŠ¨3ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œæé«˜å¤„ç†èƒ½åŠ›
- `setPollTimeout(3000)`ï¼šæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
- `setAckMode(MANUAL)`ï¼šæ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯ï¼Œæ›´å®‰å…¨ä½†éœ€è¦è‡ªå·±å¤„ç†

### 5.3 æ‰‹åŠ¨ç¡®è®¤ä¸åç§»é‡ç®¡ç†


```java
@Component
public class ManualAckListener {
    
    // æ‰‹åŠ¨ç¡®è®¤ç¤ºä¾‹
    @KafkaListener(topics = "manual-ack-topic", containerFactory = "manualAckListenerContainerFactory")
    public void listenManualAck(String message, Acknowledgment ack) {
        try {
            // å¤„ç†æ¶ˆæ¯
            System.out.println("å¤„ç†æ¶ˆæ¯: " + message);
            
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            processBusinessLogic(message);
            
            // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
            ack.acknowledge();
            System.out.println("æ¶ˆæ¯ç¡®è®¤æˆåŠŸ");
            
        } catch (Exception e) {
            System.err.println("å¤„ç†å¤±è´¥ï¼Œä¸ç¡®è®¤æ¶ˆæ¯: " + e.getMessage());
            // ä¸è°ƒç”¨ack.acknowledge()ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹
        }
    }
    
    // æ‰¹é‡æ‰‹åŠ¨ç¡®è®¤
    @KafkaListener(topics = "batch-manual-topic", containerFactory = "batchManualAckFactory")
    public void listenBatchManual(List<String> messages, Acknowledgment ack) {
        int processed = 0;
        try {
            for (String message : messages) {
                processBusinessLogic(message);
                processed++;
            }
            
            // æ‰€æœ‰æ¶ˆæ¯éƒ½å¤„ç†æˆåŠŸæ‰ç¡®è®¤
            ack.acknowledge();
            System.out.println("æ‰¹é‡å¤„ç†å®Œæˆ: " + processed + " æ¡æ¶ˆæ¯");
            
        } catch (Exception e) {
            System.err.println("æ‰¹é‡å¤„ç†å¤±è´¥ï¼Œå·²å¤„ç†: " + processed + " æ¡");
            // å¯ä»¥æ ¹æ®éœ€è¦å†³å®šæ˜¯å¦éƒ¨åˆ†ç¡®è®¤
        }
    }
    
    private void processBusinessLogic(String message) throws Exception {
        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼Œå¯èƒ½æŠ›å‡ºå¼‚å¸¸
        if (message.contains("error")) {
            throw new RuntimeException("ä¸šåŠ¡å¤„ç†å¼‚å¸¸");
        }
        // æ­£å¸¸å¤„ç†é€»è¾‘
        Thread.sleep(100);
    }
}
```

**âš ï¸ é‡è¦æé†’**ï¼šæ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸è°ƒç”¨`ack.acknowledge()`ï¼Œæ¶ˆæ¯ä¼šè¢«é‡å¤æ¶ˆè´¹ã€‚

### 5.4 å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†


```java
@Service
public class ContainerManagementService {
    
    @Autowired
    private KafkaListenerEndpointRegistry endpointRegistry;
    
    // æš‚åœæŒ‡å®šç›‘å¬å™¨
    public void pauseListener(String listenerId) {
        MessageListenerContainer listenerContainer = 
            endpointRegistry.getListenerContainer(listenerId);
        if (listenerContainer != null) {
            listenerContainer.pause();
            System.out.println("ç›‘å¬å™¨å·²æš‚åœ: " + listenerId);
        }
    }
    
    // æ¢å¤æŒ‡å®šç›‘å¬å™¨
    public void resumeListener(String listenerId) {
        MessageListenerContainer listenerContainer = 
            endpointRegistry.getListenerContainer(listenerId);
        if (listenerContainer != null) {
            listenerContainer.resume();
            System.out.println("ç›‘å¬å™¨å·²æ¢å¤: " + listenerId);
        }
    }
    
    // åœæ­¢æ‰€æœ‰ç›‘å¬å™¨
    public void stopAllListeners() {
        endpointRegistry.getListenerContainers().forEach(container -> {
            container.stop();
        });
        System.out.println("æ‰€æœ‰ç›‘å¬å™¨å·²åœæ­¢");
    }
    
    // è·å–ç›‘å¬å™¨çŠ¶æ€
    public void checkListenerStatus(String listenerId) {
        MessageListenerContainer container = 
            endpointRegistry.getListenerContainer(listenerId);
        if (container != null) {
            System.out.println("ç›‘å¬å™¨ " + listenerId + " çŠ¶æ€:");
            System.out.println("- æ˜¯å¦è¿è¡Œ: " + container.isRunning());
            System.out.println("- æ˜¯å¦æš‚åœ: " + container.isPauseRequested());
        }
    }
}

// åœ¨ç›‘å¬å™¨ä¸ŠæŒ‡å®šID
@Component
public class IdentifiedListener {
    
    @KafkaListener(id = "user-listener", topics = "user-topic")
    public void listenUser(String message) {
        System.out.println("ç”¨æˆ·ç›‘å¬å™¨æ”¶åˆ°: " + message);
    }
    
    @KafkaListener(id = "order-listener", topics = "order-topic")
    public void listenOrder(String message) {
        System.out.println("è®¢å•ç›‘å¬å™¨æ”¶åˆ°: " + message);
    }
}
```

**ğŸŒ° å®é™…åº”ç”¨åœºæ™¯**ï¼š
- ç³»ç»Ÿç»´æŠ¤æ—¶æš‚åœæ¶ˆè´¹
- æ ¹æ®ä¸šåŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´
- æ•…éšœæ¢å¤åé‡å¯ç›‘å¬å™¨

---

## 6. ğŸš¨ é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶


### 6.1 åŸºç¡€é”™è¯¯å¤„ç†


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†**ï¼š
- ç½‘ç»œé—®é¢˜å¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥
- ä¸šåŠ¡é€»è¾‘å¤„ç†å¼‚å¸¸
- ä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨
- æ¶ˆæ¯æ ¼å¼é”™è¯¯

```java
@Component
public class ErrorHandlingListener {
    
    // åŸºç¡€é”™è¯¯å¤„ç†
    @KafkaListener(topics = "error-topic")
    public void listenWithErrorHandling(String message) {
        try {
            // ä¸šåŠ¡å¤„ç†é€»è¾‘
            processMessage(message);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ä½†ä¸é‡è¯•
            System.err.println("ä¸šåŠ¡å¤„ç†å¤±è´¥: " + e.getMessage());
            logError(message, e);
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦é‡è¯•
            System.err.println("ç³»ç»Ÿå¼‚å¸¸: " + e.getMessage());
            handleSystemError(message, e);
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        }
    }
    
    private void processMessage(String message) throws BusinessException {
        // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
        if (message.contains("invalid")) {
            throw new BusinessException("æ— æ•ˆæ¶ˆæ¯");
        }
        if (message.contains("system-error")) {
            throw new RuntimeException("ç³»ç»Ÿé”™è¯¯");
        }
        System.out.println("æ¶ˆæ¯å¤„ç†æˆåŠŸ: " + message);
    }
    
    private void logError(String message, Exception e) {
        // è®°å½•é”™è¯¯æ—¥å¿—
        System.out.println("é”™è¯¯æ—¥å¿— - æ¶ˆæ¯: " + message + ", å¼‚å¸¸: " + e.getMessage());
    }
    
    private void handleSystemError(String message, Exception e) {
        // ç³»ç»Ÿé”™è¯¯å¤„ç†ï¼šå‘Šè­¦ã€é€šçŸ¥ç­‰
        System.out.println("ç³»ç»Ÿé”™è¯¯å¤„ç† - æ¶ˆæ¯: " + message);
    }
}

class BusinessException extends Exception {
    public BusinessException(String message) {
        super(message);
    }
}
```

### 6.2 é…ç½®é‡è¯•æœºåˆ¶


```java
@Configuration
public class RetryConfig {
    
    @Bean
    public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, String>>
            retryListenerContainerFactory() {
        
        ConcurrentKafkaListenerContainerFactory<String, String> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        
        factory.setConsumerFactory(consumerFactory());
        
        // é…ç½®é‡è¯•æ¨¡æ¿
        RetryTemplate retryTemplate = new RetryTemplate();
        
        // é‡è¯•ç­–ç•¥ï¼šæœ€å¤šé‡è¯•3æ¬¡ï¼Œæ¯æ¬¡é—´éš”1ç§’
        FixedBackOffPolicy backOffPolicy = new FixedBackOffPolicy();
        backOffPolicy.setBackOffPeriod(1000); // 1ç§’
        retryTemplate.setBackOffPolicy(backOffPolicy);
        
        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();
        retryPolicy.setMaxAttempts(3); // æœ€å¤š3æ¬¡
        retryTemplate.setRetryPolicy(retryPolicy);
        
        // è®¾ç½®é‡è¯•æ¨¡æ¿
        factory.setRetryTemplate(retryTemplate);
        
        // é…ç½®æ¢å¤å›è°ƒï¼ˆé‡è¯•å¤±è´¥åçš„å¤„ç†ï¼‰
        factory.setRecoveryCallback(context -> {
            String message = (String) context.getAttribute("FAILED_MESSAGE");
            System.err.println("é‡è¯•å¤±è´¥ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—: " + message);
            sendToDeadLetterTopic(message);
            return null;
        });
        
        return factory;
    }
    
    private void sendToDeadLetterTopic(String message) {
        // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—çš„é€»è¾‘
        System.out.println("å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—: " + message);
    }
}
```

### 6.3 æ­»ä¿¡é˜Ÿåˆ—å¤„ç†


```java
@Service
public class DeadLetterService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    private static final String DEAD_LETTER_TOPIC = "dead-letter-topic";
    
    // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
    public void sendToDeadLetter(String originalTopic, String message, Exception error) {
        DeadLetterMessage deadLetter = new DeadLetterMessage();
        deadLetter.setOriginalTopic(originalTopic);
        deadLetter.setOriginalMessage(message);
        deadLetter.setErrorMessage(error.getMessage());
        deadLetter.setTimestamp(System.currentTimeMillis());
        deadLetter.setRetryCount(getRetryCount()); // ä»ä¸Šä¸‹æ–‡è·å–é‡è¯•æ¬¡æ•°
        
        kafkaTemplate.send(DEAD_LETTER_TOPIC, deadLetter);
        System.out.println("æ¶ˆæ¯å·²å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—");
    }
    
    // ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—
    @KafkaListener(topics = DEAD_LETTER_TOPIC)
    public void handleDeadLetter(DeadLetterMessage deadLetter) {
        System.out.println("å¤„ç†æ­»ä¿¡æ¶ˆæ¯:");
        System.out.println("- åŸå§‹ä¸»é¢˜: " + deadLetter.getOriginalTopic());
        System.out.println("- åŸå§‹æ¶ˆæ¯: " + deadLetter.getOriginalMessage());
        System.out.println("- é”™è¯¯ä¿¡æ¯: " + deadLetter.getErrorMessage());
        System.out.println("- é‡è¯•æ¬¡æ•°: " + deadLetter.getRetryCount());
        
        // æ­»ä¿¡æ¶ˆæ¯å¤„ç†é€»è¾‘
        processDeadLetter(deadLetter);
    }
    
    private void processDeadLetter(DeadLetterMessage deadLetter) {
        // å¯ä»¥é€‰æ‹©ï¼š
        // 1. äººå·¥å¤„ç†
        // 2. å»¶è¿Ÿé‡è¯•
        // 3. è®°å½•æ—¥å¿—
        // 4. å‘é€å‘Šè­¦
        
        System.out.println("æ­»ä¿¡æ¶ˆæ¯å·²è®°å½•ï¼Œç­‰å¾…äººå·¥å¤„ç†");
    }
    
    private int getRetryCount() {
        // ä»é‡è¯•ä¸Šä¸‹æ–‡è·å–ï¼Œè¿™é‡Œç®€åŒ–ä¸ºå›ºå®šå€¼
        return 3;
    }
}

// æ­»ä¿¡æ¶ˆæ¯å¯¹è±¡
class DeadLetterMessage {
    private String originalTopic;
    private String originalMessage;
    private String errorMessage;
    private long timestamp;
    private int retryCount;
    
    // getters and setters
}
```

### 6.4 å…¨å±€é”™è¯¯å¤„ç†å™¨


```java
@Component
public class GlobalErrorHandler implements KafkaListenerErrorHandler {
    
    @Override
    public Object handleError(Message<?> message, ListenerExecutionFailedException exception) {
        System.err.println("å…¨å±€é”™è¯¯å¤„ç†å™¨è¢«è°ƒç”¨:");
        System.err.println("- æ¶ˆæ¯: " + message.getPayload());
        System.err.println("- å¼‚å¸¸: " + exception.getMessage());
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡Œä¸åŒå¤„ç†
        Throwable cause = exception.getCause();
        if (cause instanceof BusinessException) {
            handleBusinessError(message, (BusinessException) cause);
        } else if (cause instanceof NetworkException) {
            handleNetworkError(message, (NetworkException) cause);
        } else {
            handleUnknownError(message, exception);
        }
        
        return null; // è¿”å›nullè¡¨ç¤ºé”™è¯¯å·²å¤„ç†
    }
    
    private void handleBusinessError(Message<?> message, BusinessException e) {
        System.out.println("ä¸šåŠ¡é”™è¯¯å¤„ç† - ä¸é‡è¯•");
    }
    
    private void handleNetworkError(Message<?> message, NetworkException e) {
        System.out.println("ç½‘ç»œé”™è¯¯å¤„ç† - å¯é‡è¯•");
        // å¯ä»¥é€‰æ‹©é‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        // throw new RuntimeException("ç½‘ç»œé”™è¯¯ï¼Œè§¦å‘é‡è¯•", e);
    }
    
    private void handleUnknownError(Message<?> message, Exception e) {
        System.out.println("æœªçŸ¥é”™è¯¯å¤„ç† - å‘é€å‘Šè­¦");
        // å‘é€å‘Šè­¦é€šçŸ¥
        sendAlert("æœªçŸ¥é”™è¯¯", message.getPayload().toString(), e);
    }
    
    private void sendAlert(String type, String message, Exception e) {
        System.out.println("å‘é€å‘Šè­¦: " + type + " - " + message);
    }
}

// åœ¨ç›‘å¬å™¨ä¸­ä½¿ç”¨å…¨å±€é”™è¯¯å¤„ç†å™¨
@Component
public class ListenerWithGlobalError {
    
    @KafkaListener(topics = "global-error-topic", errorHandler = "globalErrorHandler")
    public void listen(String message) {
        System.out.println("å¤„ç†æ¶ˆæ¯: " + message);
        
        // æ¨¡æ‹Ÿå„ç§å¼‚å¸¸
        if (message.contains("business-error")) {
            throw new BusinessException("ä¸šåŠ¡å¼‚å¸¸");
        } else if (message.contains("network-error")) {
            throw new NetworkException("ç½‘ç»œå¼‚å¸¸");
        } else if (message.contains("unknown-error")) {
            throw new RuntimeException("æœªçŸ¥å¼‚å¸¸");
        }
        
        System.out.println("æ¶ˆæ¯å¤„ç†å®Œæˆ");
    }
}

class NetworkException extends RuntimeException {
    public NetworkException(String message) {
        super(message);
    }
}
```

---

## 7. ğŸ”„ äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§ä¿éšœ


### 7.1 ä»€ä¹ˆæ˜¯Kafkaäº‹åŠ¡


ğŸ’­ **é€šä¿—ç†è§£**ï¼šKafkaäº‹åŠ¡å°±åƒé“¶è¡Œè½¬è´¦ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€ã€‚

```
äº‹åŠ¡åœºæ™¯ç¤ºä¾‹ï¼š

ç”¨æˆ·ä¸‹å• â†’ å‘é€è®¢å•æ¶ˆæ¯ â†’ å‘é€åº“å­˜æ‰£å‡æ¶ˆæ¯ â†’ å‘é€é€šçŸ¥æ¶ˆæ¯
   â†“
å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½ä¸å‘é€ï¼ˆå›æ»šï¼‰
å¦‚æœå…¨éƒ¨æˆåŠŸï¼Œæ‰€æœ‰æ¶ˆæ¯ä¸€èµ·æäº¤
```

### 7.2 é…ç½®äº‹åŠ¡æ”¯æŒ


```java
@Configuration
@EnableKafka
public class KafkaTransactionConfig {
    
    // é…ç½®äº‹åŠ¡ç”Ÿäº§è€…
    @Bean
    public ProducerFactory<String, Object> transactionalProducerFactory() {
        Map<String, Object> configProps = new HashMap<>();
        configProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);
        
        // ğŸ”‘ äº‹åŠ¡ç›¸å…³é…ç½®
        configProps.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, "tx-producer-1");
        configProps.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true); // å¯ç”¨å¹‚ç­‰æ€§
        configProps.put(ProducerConfig.ACKS_CONFIG, "all");
        configProps.put(ProducerConfig.RETRIES_CONFIG, Integer.MAX_VALUE);
        
        DefaultKafkaProducerFactory<String, Object> factory = 
            new DefaultKafkaProducerFactory<>(configProps);
        factory.setTransactionIdPrefix("tx-"); // äº‹åŠ¡IDå‰ç¼€
        
        return factory;
    }
    
    @Bean
    public KafkaTemplate<String, Object> transactionalKafkaTemplate() {
        return new KafkaTemplate<>(transactionalProducerFactory());
    }
    
    // é…ç½®Kafkaäº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public KafkaTransactionManager kafkaTransactionManager() {
        return new KafkaTransactionManager(transactionalProducerFactory());
    }
    
    // é…ç½®æ”¯æŒäº‹åŠ¡çš„æ¶ˆè´¹è€…
    @Bean
    public ConsumerFactory<String, Object> transactionalConsumerFactory() {
        Map<String, Object> props = new HashMap<>();
        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        props.put(ConsumerConfig.GROUP_ID_CONFIG, "tx-consumer-group");
        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class);
        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, JsonDeserializer.class);
        
        // äº‹åŠ¡éš”ç¦»çº§åˆ«
        props.put(ConsumerConfig.ISOLATION_LEVEL_CONFIG, "read_committed");
        
        return new DefaultKafkaConsumerFactory<>(props);
    }
}
```

ğŸ” **å…³é”®é…ç½®è¯´æ˜**ï¼š
- `TRANSACTIONAL_ID_CONFIG`ï¼šæ¯ä¸ªç”Ÿäº§è€…å®ä¾‹çš„å”¯ä¸€æ ‡è¯†
- `ENABLE_IDEMPOTENCE_CONFIG=true`ï¼šç¡®ä¿æ¶ˆæ¯ä¸é‡å¤
- `ISOLATION_LEVEL_CONFIG=read_committed`ï¼šåªè¯»å–å·²æäº¤çš„æ¶ˆæ¯

### 7.3 äº‹åŠ¡å‘é€ç¤ºä¾‹


```java
@Service
public class TransactionalMessageService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // ä½¿ç”¨Springäº‹åŠ¡æ³¨è§£
    @Transactional("kafkaTransactionManager")
    public void sendOrderMessages(Order order) {
        try {
            // å‘é€è®¢å•åˆ›å»ºæ¶ˆæ¯
            kafkaTemplate.send("order-created", order);
            
            // å‘é€åº“å­˜æ‰£å‡æ¶ˆæ¯
            InventoryEvent inventoryEvent = new InventoryEvent();
            inventoryEvent.setProductId(order.getProductId());
            inventoryEvent.setQuantity(order.getQuantity());
            kafkaTemplate.send("inventory-update", inventoryEvent);
            
            // å‘é€ç”¨æˆ·é€šçŸ¥æ¶ˆæ¯
            NotificationEvent notification = new NotificationEvent();
            notification.setUserId(order.getUserId());
            notification.setMessage("è®¢å•åˆ›å»ºæˆåŠŸ: " + order.getId());
            kafkaTemplate.send("user-notification", notification);
            
            System.out.println("æ‰€æœ‰è®¢å•ç›¸å…³æ¶ˆæ¯å‘é€æˆåŠŸ");
            
            // å¦‚æœè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šå›æ»š
            validateOrder(order);
            
        } catch (Exception e) {
            System.err.println("äº‹åŠ¡å¤±è´¥ï¼Œæ‰€æœ‰æ¶ˆæ¯å°†å›æ»š: " + e.getMessage());
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘å›æ»š
        }
    }
    
    // æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†
    public void sendMessagesManualTransaction(List<String> messages) {
        kafkaTemplate.executeInTransaction(kafkaOperations -> {
            try {
                for (String message : messages) {
                    kafkaOperations.send("batch-topic", message);
                }
                
                System.out.println("æ‰¹é‡å‘é€æˆåŠŸ: " + messages.size() + " æ¡æ¶ˆæ¯");
                return true;
                
            } catch (Exception e) {
                System.err.println("æ‰¹é‡å‘é€å¤±è´¥: " + e.getMessage());
                throw e; // è§¦å‘äº‹åŠ¡å›æ»š
            }
        });
    }
    
    private void validateOrder(Order order) throws Exception {
        // è®¢å•éªŒè¯é€»è¾‘
        if (order.getQuantity() <= 0) {
            throw new RuntimeException("è®¢å•æ•°é‡æ— æ•ˆ");
        }
        if (order.getProductId() == null) {
            throw new RuntimeException("å•†å“IDä¸èƒ½ä¸ºç©º");
        }
    }
}
```

### 7.4 äº‹åŠ¡æ¶ˆè´¹è€…


```java
@Component
public class TransactionalConsumer {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    // äº‹åŠ¡æ€§æ¶ˆè´¹ï¼šæ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œä¿è¯åŸå­æ€§
    @KafkaListener(topics = "order-created", containerFactory = "transactionalListenerContainerFactory")
    @Transactional("kafkaTransactionManager")
    public void handleOrderCreated(Order order, Acknowledgment ack) {
        try {
            // 1. å¤„ç†è®¢å•ï¼ˆå¯èƒ½æ¶‰åŠæ•°æ®åº“æ“ä½œï¼‰
            orderService.processOrder(order);
            
            // 2. å‘é€åç»­å¤„ç†æ¶ˆæ¯
            PaymentEvent paymentEvent = new PaymentEvent();
            paymentEvent.setOrderId(order.getId());
            paymentEvent.setAmount(order.getAmount());
            kafkaTemplate.send("payment-process", paymentEvent);
            
            // 3. æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
            ack.acknowledge();
            
            System.out.println("è®¢å•å¤„ç†å®Œæˆï¼Œæ”¯ä»˜æ¶ˆæ¯å·²å‘é€");
            
        } catch (Exception e) {
            System.err.println("è®¢å•å¤„ç†å¤±è´¥: " + e.getMessage());
            // ä¸ç¡®è®¤æ¶ˆæ¯ï¼Œè§¦å‘é‡è¯•
            throw e;
        }
    }
    
    // é…ç½®äº‹åŠ¡ç›‘å¬å®¹å™¨
    @Bean
    public KafkaListenerContainerFactory<ConcurrentMessageListenerContainer<String, Object>>
            transactionalListenerContainerFactory() {
        
        ConcurrentKafkaListenerContainerFactory<String, Object> factory =
                new ConcurrentKafkaListenerContainerFactory<>();
        
        factory.setConsumerFactory(transactionalConsumerFactory());
        factory.getContainerProperties().setTransactionManager(kafkaTransactionManager());
        factory.getContainerProperties().setAckMode(ContainerProperties.AckMode.MANUAL);
        
        return factory;
    }
}
```

### 7.5 åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯


```java
@Service
public class DistributedTransactionService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @Autowired
    private DatabaseService databaseService;
    
    // è·¨ç³»ç»Ÿäº‹åŠ¡ï¼šæ•°æ®åº“ + Kafkaæ¶ˆæ¯
    @Transactional("chainedTransactionManager") // ä½¿ç”¨é“¾å¼äº‹åŠ¡ç®¡ç†å™¨
    public void processOrderWithDistributedTransaction(Order order) {
        try {
            // 1. æ•°æ®åº“æ“ä½œ
            databaseService.saveOrder(order);
            databaseService.updateInventory(order.getProductId(), order.getQuantity());
            
            // 2. Kafkaæ¶ˆæ¯å‘é€
            kafkaTemplate.send("order-confirmed", order);
            kafkaTemplate.send("inventory-updated", createInventoryEvent(order));
            
            System.out.println("åˆ†å¸ƒå¼äº‹åŠ¡å®Œæˆ");
            
        } catch (Exception e) {
            System.err.println("åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥: " + e.getMessage());
            throw e; // è§¦å‘æ•´ä¸ªäº‹åŠ¡å›æ»š
        }
    }
    
    // é…ç½®é“¾å¼äº‹åŠ¡ç®¡ç†å™¨ï¼ˆç»“åˆæ•°æ®åº“äº‹åŠ¡å’ŒKafkaäº‹åŠ¡ï¼‰
    @Bean
    public ChainedTransactionManager chainedTransactionManager(
            PlatformTransactionManager databaseTransactionManager,
            KafkaTransactionManager kafkaTransactionManager) {
        
        return new ChainedTransactionManager(
            kafkaTransactionManager,      // å…ˆæäº¤Kafkaäº‹åŠ¡
            databaseTransactionManager    // å†æäº¤æ•°æ®åº“äº‹åŠ¡
        );
    }
    
    private InventoryEvent createInventoryEvent(Order order) {
        InventoryEvent event = new InventoryEvent();
        event.setProductId(order.getProductId());
        event.setQuantity(order.getQuantity());
        event.setOperation("DECREASE");
        return event;
    }
}
```

**âš ï¸ é‡è¦è¯´æ˜**ï¼š
- Kafkaäº‹åŠ¡åªä¿è¯Kafkaå†…éƒ¨çš„ä¸€è‡´æ€§
- è¦å®ç°çœŸæ­£çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œéœ€è¦ç»“åˆSagaæ¨¡å¼æˆ–ä¸¤é˜¶æ®µæäº¤
- äº‹åŠ¡ä¼šå½±å“æ€§èƒ½ï¼Œè¦æƒè¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½éœ€æ±‚

---

## 8. â˜ï¸ Spring Cloudé›†æˆå®æˆ˜


### 8.1 Spring Cloud Streamç®€ä»‹


**ğŸ·ï¸ ä»€ä¹ˆæ˜¯Spring Cloud Stream**ï¼š
å®ƒæ˜¯Spring Cloudæä¾›çš„æ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡æ¡†æ¶ï¼ŒæŠŠKafkaç­‰æ¶ˆæ¯ä¸­é—´ä»¶æŠ½è±¡æˆ"ç®¡é“ï¼ˆChannelï¼‰"ï¼Œè®©ä½ ä¸“æ³¨ä¸šåŠ¡é€»è¾‘è€Œä¸ç”¨å…³å¿ƒåº•å±‚å®ç°ã€‚

```
Spring Cloud Stream æ¶æ„ï¼š

ä¸šåŠ¡é€»è¾‘
    â†“
@Input/@Output æ³¨è§£
    â†“
æ¶ˆæ¯é€šé“ï¼ˆChannelï¼‰
    â†“
æ¶ˆæ¯ç»‘å®šå™¨ï¼ˆBinderï¼‰
    â†“
Kafka/RabbitMQç­‰ä¸­é—´ä»¶
```

### 8.2 åŸºç¡€é›†æˆé…ç½®


```yaml
# application.yml
spring:
  cloud:
    stream:
      kafka:
        binder:
          brokers: localhost:9092
          auto-add-partitions: true
          auto-create-topics: true
      bindings:
        # è¾“å…¥é€šé“é…ç½®
        user-input:
          destination: user-topic           # Kafkaä¸»é¢˜å
          group: user-service-group        # æ¶ˆè´¹è€…ç»„
          content-type: application/json   # æ¶ˆæ¯æ ¼å¼
        
        # è¾“å‡ºé€šé“é…ç½®  
        order-output:
          destination: order-topic
          content-type: application/json
          
        # æ‰¹é‡å¤„ç†é…ç½®
        batch-input:
          destination: batch-topic
          group: batch-consumer
          consumer:
            batch-mode: true
            max-attempts: 3
```

### 8.3 æ¶ˆæ¯æ¥æ”¶ä¸å‘é€


```java
// å®šä¹‰æ¶ˆæ¯é€šé“æ¥å£
public interface MessageChannels {
    
    String USER_INPUT = "user-input";
    String ORDER_OUTPUT = "order-output";
    
    @Input(USER_INPUT)
    SubscribableChannel userInput();
    
    @Output(ORDER_OUTPUT)
    MessageChannel orderOutput();
}

// å¯ç”¨ç»‘å®š
@EnableBinding(MessageChannels.class)
@Component
public class StreamMessageHandler {
    
    // æ¥æ”¶æ¶ˆæ¯
    @StreamListener(MessageChannels.USER_INPUT)
    public void handleUser(User user) {
        System.out.println("Streamæ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯: " + user.getName());
        
        // å¤„ç†ç”¨æˆ·æ³¨å†Œé€»è¾‘
        processUserRegistration(user);
        
        // å¯ä»¥åœ¨è¿™é‡Œå‘é€åç»­æ¶ˆæ¯
        sendWelcomeMessage(user);
    }
    
    // æ¡ä»¶ç›‘å¬
    @StreamListener(value = MessageChannels.USER_INPUT, 
                   condition = "headers['type']=='VIP'")
    public void handleVipUser(User user) {
        System.out.println("å¤„ç†VIPç”¨æˆ·: " + user.getName());
        // VIPç”¨æˆ·ç‰¹æ®Šå¤„ç†é€»è¾‘
        processVipUser(user);
    }
    
    private void processUserRegistration(User user) {
        System.out.println("å¤„ç†ç”¨æˆ·æ³¨å†Œ: " + user.getName());
        // ç”¨æˆ·æ³¨å†Œä¸šåŠ¡é€»è¾‘
    }
    
    private void processVipUser(User user) {
        System.out.println("VIPç”¨æˆ·ç‰¹æ®Šå¤„ç†: " + user.getName());
    }
    
    private void sendWelcomeMessage(User user) {
        // è¿™é‡Œå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼å‘é€æ¬¢è¿æ¶ˆæ¯
        System.out.println("å‘é€æ¬¢è¿æ¶ˆæ¯ç»™: " + user.getName());
    }
}

// æ¶ˆæ¯å‘é€æœåŠ¡
@Component
public class StreamMessageProducer {
    
    @Autowired
    @Qualifier(MessageChannels.ORDER_OUTPUT)
    private MessageChannel orderOutput;
    
    public void sendOrder(Order order) {
        // æ„å»ºæ¶ˆæ¯
        Message<Order> message = MessageBuilder
                .withPayload(order)
                .setHeader("type", "NEW_ORDER")
                .setHeader("source", "order-service")
                .build();
        
        // å‘é€æ¶ˆæ¯
        boolean sent = orderOutput.send(message);
        if (sent) {
            System.out.println("è®¢å•æ¶ˆæ¯å‘é€æˆåŠŸ: " + order.getId());
        } else {
            System.err.println("è®¢å•æ¶ˆæ¯å‘é€å¤±è´¥: " + order.getId());
        }
    }
    
    // å‘é€å¸¦è¶…æ—¶çš„æ¶ˆæ¯
    public void sendOrderWithTimeout(Order order, long timeoutMs) {
        Message<Order> message = MessageBuilder
                .withPayload(order)
                .setHeader("type", "URGENT_ORDER")
                .build();
        
        boolean sent = orderOutput.send(message, timeoutMs);
        System.out.println("ç´§æ€¥è®¢å•å‘é€ç»“æœ: " + sent);
    }
}
```

### 8.4 å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹ï¼ˆSpring Cloud Stream 3.x+ï¼‰


```java
// æ–°çš„å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹
@Component
public class FunctionalMessageHandler {
    
    // ç®€å•æ¶ˆè´¹è€…
    @Bean
    public Consumer<User> userConsumer() {
        return user -> {
            System.out.println("å‡½æ•°å¼å¤„ç†ç”¨æˆ·: " + user.getName());
            // å¤„ç†ç”¨æˆ·é€»è¾‘
        };
    }
    
    // ç®€å•ç”Ÿäº§è€…
    @Bean
    public Supplier<Order> orderSupplier() {
        return () -> {
            // å®šæœŸç”Ÿæˆè®¢å•æ¶ˆæ¯
            Order order = new Order();
            order.setId("ORDER-" + System.currentTimeMillis());
            order.setUserId("USER-123");
            System.out.println("ç”Ÿæˆè®¢å•: " + order.getId());
            return order;
        };
    }
    
    // æ¶ˆæ¯å¤„ç†å™¨ï¼ˆæ¥æ”¶å¹¶å‘é€ï¼‰
    @Bean
    public Function<User, Order> userToOrder() {
        return user -> {
            System.out.println("å°†ç”¨æˆ·è½¬æ¢ä¸ºè®¢å•: " + user.getName());
            
            Order order = new Order();
            order.setUserId(user.getId());
            order.setId("ORDER-" + user.getId());
            
            return order;
        };
    }
    
    // æ‰¹é‡å¤„ç†
    @Bean
    public Consumer<List<User>> batchUserConsumer() {
        return users -> {
            System.out.println("æ‰¹é‡å¤„ç†ç”¨æˆ·æ•°: " + users.size());
            users.forEach(user -> {
                System.out.println("å¤„ç†ç”¨æˆ·: " + user.getName());
            });
        };
    }
}
```

å¯¹åº”çš„é…ç½®ï¼š

```yaml
spring:
  cloud:
    stream:
      bindings:
        # å‡½æ•°åå¯¹åº”ç»‘å®šå
        userConsumer-in-0:
          destination: user-topic
          group: user-consumer-group
          
        orderSupplier-out-0:
          destination: order-topic
          
        userToOrder-in-0:
          destination: user-input-topic
          group: processor-group
          
        userToOrder-out-0:
          destination: order-output-topic
          
        batchUserConsumer-in-0:
          destination: batch-user-topic
          group: batch-group
          consumer:
            batch-mode: true
```

### 8.5 é”™è¯¯å¤„ç†å’Œæ­»ä¿¡é˜Ÿåˆ—


```java
@Component
public class StreamErrorHandler {
    
    // å…¨å±€é”™è¯¯å¤„ç†
    @Bean
    public Consumer<Message<User>> userConsumerWithError() {
        return message -> {
            try {
                User user = message.getPayload();
                System.out.println("å¤„ç†ç”¨æˆ·: " + user.getName());
                
                // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
                processUser(user);
                
            } catch (Exception e) {
                System.err.println("ç”¨æˆ·å¤„ç†å¤±è´¥: " + e.getMessage());
                
                // æ£€æŸ¥é‡è¯•æ¬¡æ•°
                Integer retryCount = (Integer) message.getHeaders()
                    .getOrDefault("retry-count", 0);
                
                if (retryCount < 3) {
                    // é‡è¯•
                    retryMessage(message, retryCount + 1);
                } else {
                    // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                    sendToDeadLetter(message);
                }
            }
        };
    }
    
    private void processUser(User user) throws Exception {
        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†å¼‚å¸¸
        if (user.getName().contains("error")) {
            throw new RuntimeException("ç”¨æˆ·æ•°æ®å¼‚å¸¸");
        }
        System.out.println("ç”¨æˆ·å¤„ç†æˆåŠŸ: " + user.getName());
    }
    
    private void retryMessage(Message<User> message, int retryCount) {
        System.out.println("æ¶ˆæ¯é‡è¯•ï¼Œç¬¬ " + retryCount + " æ¬¡");
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦å»¶è¿Ÿé‡è¯•
    }
    
    private void sendToDeadLetter(Message<User> message) {
        System.out.println("å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—: " + message.getPayload());
        // å‘é€åˆ°æ­»ä¿¡ä¸»é¢˜çš„é€»è¾‘
    }
    
    // æ­»ä¿¡é˜Ÿåˆ—æ¶ˆè´¹è€…
    @Bean
    public Consumer<User> deadLetterConsumer() {
        return user -> {
            System.out.println("å¤„ç†æ­»ä¿¡æ¶ˆæ¯: " + user.getName());
            // æ­»ä¿¡æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼šå‘Šè­¦ã€äººå·¥å¹²é¢„ç­‰
            handleDeadLetterUser(user);
        };
    }
    
    private void handleDeadLetterUser(User user) {
        System.out.println("æ­»ä¿¡ç”¨æˆ·å¤„ç†: " + user.getName());
        // å¯ä»¥é€‰æ‹©ï¼š
        // 1. è®°å½•åˆ°æ•°æ®åº“å¾…äººå·¥å¤„ç†
        // 2. å‘é€å‘Šè­¦é€šçŸ¥
        // 3. å°è¯•å…¶ä»–å¤„ç†æ–¹å¼
    }
}
```

é…ç½®æ­»ä¿¡é˜Ÿåˆ—ï¼š

```yaml
spring:
  cloud:
    stream:
      bindings:
        userConsumerWithError-in-0:
          destination: user-topic
          group: user-error-group
          consumer:
            max-attempts: 3
            
        # æ­»ä¿¡é˜Ÿåˆ—é…ç½®
        deadLetterConsumer-in-0:
          destination: user-topic.user-error-group.dlq  # æ­»ä¿¡é˜Ÿåˆ—å‘½åè§„åˆ™
          group: dlq-handler-group
```

### 8.6 é›†æˆç›‘æ§å’Œå¥åº·æ£€æŸ¥


```java
@Component
public class StreamHealthIndicator implements HealthIndicator {
    
    @Autowired
    private BinderAwareChannelResolver channelResolver;
    
    @Override
    public Health health() {
        try {
            // æ£€æŸ¥æ¶ˆæ¯é€šé“çŠ¶æ€
            MessageChannel userChannel = channelResolver.resolveDestination("user-topic");
            
            if (userChannel != null) {
                return Health.up()
                    .withDetail("kafka-stream", "ç”¨æˆ·æ¶ˆæ¯é€šé“æ­£å¸¸")
                    .withDetail("channels", "user-topic: å¯ç”¨")
                    .build();
            } else {
                return Health.down()
                    .withDetail("kafka-stream", "ç”¨æˆ·æ¶ˆæ¯é€šé“ä¸å¯ç”¨")
                    .build();
            }
            
        } catch (Exception e) {
            return Health.down(e)
                .withDetail("kafka-stream", "è¿æ¥æ£€æŸ¥å¤±è´¥")
                .build();
        }
    }
}

// æ¶ˆæ¯å¤„ç†ç›‘æ§
@Component
public class MessageMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter processedMessages;
    private final Counter failedMessages;
    
    public MessageMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.processedMessages = Counter.builder("stream.messages.processed")
            .description("å¤„ç†æˆåŠŸçš„æ¶ˆæ¯æ•°é‡")
            .register(meterRegistry);
        this.failedMessages = Counter.builder("stream.messages.failed")
            .description("å¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ•°é‡")
            .register(meterRegistry);
    }
    
    @EventListener
    public void handleMessageProcessed(MessageProcessedEvent event) {
        processedMessages.increment();
    }
    
    @EventListener
    public void handleMessageFailed(MessageFailedEvent event) {
        failedMessages.increment();
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Spring Boot + Kafkaï¼šå¼€ç®±å³ç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶é›†æˆ
ğŸ”¸ @KafkaListenerï¼šæ¶ˆæ¯ç›‘å¬çš„æ ¸å¿ƒæ³¨è§£ï¼Œè‡ªåŠ¨æ¥æ”¶å¤„ç†æ¶ˆæ¯
ğŸ”¸ KafkaTemplateï¼šæ¶ˆæ¯å‘é€çš„å·¥å…·ç±»ï¼Œå°è£…äº†å¤æ‚çš„å‘é€é€»è¾‘
ğŸ”¸ æ¶ˆæ¯ç›‘å¬å®¹å™¨ï¼šç®¡ç†æ¶ˆè´¹è€…ç”Ÿå‘½å‘¨æœŸçš„å®¹å™¨
ğŸ”¸ é”™è¯¯å¤„ç†æœºåˆ¶ï¼šé‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—ã€å…¨å±€é”™è¯¯å¤„ç†
ğŸ”¸ äº‹åŠ¡æ”¯æŒï¼šä¿è¯æ¶ˆæ¯å‘é€å’Œä¸šåŠ¡å¤„ç†çš„ä¸€è‡´æ€§
ğŸ”¸ Spring Cloud Streamï¼šæ›´é«˜å±‚æ¬¡çš„æ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡æ¡†æ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©Springé›†æˆKafka**

```
ç®€åŒ–å¼€å‘ï¼š
- è‡ªåŠ¨é…ç½®ï¼šSpring Bootè‡ªåŠ¨è£…é…Kafkaå®¢æˆ·ç«¯
- æ³¨è§£é©±åŠ¨ï¼š@KafkaListenerç®€åŒ–æ¶ˆæ¯ç›‘å¬
- æ¨¡æ¿æ¨¡å¼ï¼šKafkaTemplateç»Ÿä¸€å‘é€æ¥å£
- äº‹åŠ¡æ”¯æŒï¼šä¸Springäº‹åŠ¡æ— ç¼é›†æˆ

ä¼ä¸šçº§ç‰¹æ€§ï¼š
- é”™è¯¯å¤„ç†ï¼šå®Œå–„çš„é‡è¯•å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
- ç›‘æ§é›†æˆï¼šä¸Spring Actuatoré›†æˆ
- é…ç½®ç®¡ç†ï¼šç»Ÿä¸€çš„é…ç½®ç®¡ç†æ–¹å¼
- æµ‹è¯•æ”¯æŒï¼šæä¾›æµ‹è¯•å·¥å…·å’ŒMockæ”¯æŒ
```

**ğŸ”¹ é…ç½®çš„æ ¸å¿ƒæ€è·¯**

```
ç”Ÿäº§è€…é…ç½®é‡ç‚¹ï¼š
- å¯é æ€§ï¼šacks=all, retries>0
- æ€§èƒ½ï¼šbatch-size, linger-ms
- åºåˆ—åŒ–ï¼šé€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼

æ¶ˆè´¹è€…é…ç½®é‡ç‚¹ï¼š
- æ¶ˆè´¹è¯­ä¹‰ï¼šauto-offset-reset, enable-auto-commit
- æ€§èƒ½ï¼šmax-poll-records, session-timeout
- ååºåˆ—åŒ–ï¼šä¸ç”Ÿäº§è€…å¯¹åº”çš„ååºåˆ—åŒ–å™¨

å®¹å™¨é…ç½®é‡ç‚¹ï¼š
- å¹¶å‘åº¦ï¼šconcurrencyè®¾ç½®
- ç¡®è®¤æ¨¡å¼ï¼šæ‰‹åŠ¨vsè‡ªåŠ¨ç¡®è®¤
- é”™è¯¯å¤„ç†ï¼šé‡è¯•ç­–ç•¥ã€æ­»ä¿¡é˜Ÿåˆ—
```

**ğŸ”¹ æ¶ˆæ¯å¤„ç†çš„æœ€ä½³å®è·µ**

```
ç›‘å¬å™¨è®¾è®¡ï¼š
- èŒè´£å•ä¸€ï¼šä¸€ä¸ªç›‘å¬å™¨å¤„ç†ä¸€ç§ä¸šåŠ¡
- å¹‚ç­‰æ€§ï¼šç¡®ä¿é‡å¤æ¶ˆè´¹ä¸å½±å“ç»“æœ
- å¼‚å¸¸å¤„ç†ï¼šåŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸

å‘é€ç­–ç•¥ï¼š
- å¼‚æ­¥å‘é€ï¼šæé«˜æ€§èƒ½ï¼Œå¤„ç†å›è°ƒ
- æ‰¹é‡å‘é€ï¼šå‡å°‘ç½‘ç»œå¼€é”€
- äº‹åŠ¡å‘é€ï¼šä¿è¯ä¸€è‡´æ€§

é”™è¯¯å¤„ç†ï¼š
- åˆ†ç±»å¤„ç†ï¼šä¸šåŠ¡å¼‚å¸¸vsç³»ç»Ÿå¼‚å¸¸
- é‡è¯•æœºåˆ¶ï¼šæŒ‡æ•°é€€é¿ã€æœ€å¤§é‡è¯•æ¬¡æ•°
- æ­»ä¿¡é˜Ÿåˆ—ï¼šæœ€ç»ˆå…œåº•æ–¹æ¡ˆ
```

### 9.3 å®é™…åº”ç”¨åœºæ™¯æŒ‡å¯¼


**ğŸ¯ å¸¸è§ä¸šåŠ¡åœºæ™¯**

| åœºæ™¯ç±»å‹ | **é…ç½®å»ºè®®** | **æ³¨æ„äº‹é¡¹** | **ç¤ºä¾‹ä»£ç æ¨¡å¼** |
|---------|------------|-------------|-----------------|
| **ç”¨æˆ·æ³¨å†Œ** | `è‡ªåŠ¨ç¡®è®¤ï¼Œå•æ¶ˆè´¹è€…` | `ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±` | `@KafkaListener + ä¸šåŠ¡å¤„ç†` |
| **è®¢å•å¤„ç†** | `æ‰‹åŠ¨ç¡®è®¤ï¼Œäº‹åŠ¡æ”¯æŒ` | `ä¸€è‡´æ€§è¦æ±‚é«˜` | `@Transactional + KafkaTemplate` |
| **æ—¥å¿—æ”¶é›†** | `æ‰¹é‡å¤„ç†ï¼Œé«˜åå` | `å…è®¸å°‘é‡ä¸¢å¤±` | `æ‰¹é‡ç›‘å¬ + å¼‚æ­¥å¤„ç†` |
| **å®æ—¶é€šçŸ¥** | `ä½å»¶è¿Ÿï¼Œå¤šåˆ†åŒº` | `æ—¶æ•ˆæ€§è¦æ±‚é«˜` | `æŒ‡å®šåˆ†åŒº + å¹¶å‘æ¶ˆè´¹` |

**ğŸ› ï¸ æ¶æ„é€‰æ‹©æŒ‡å¯¼**

```
ç®€å•åº”ç”¨åœºæ™¯ï¼š
âœ… ç›´æ¥ä½¿ç”¨Spring Kafka
âœ… @KafkaListener + KafkaTemplate
âœ… è‡ªåŠ¨é…ç½®ä¸ºä¸»

å¤æ‚å¾®æœåŠ¡åœºæ™¯ï¼š
âœ… ä½¿ç”¨Spring Cloud Stream
âœ… å‡½æ•°å¼ç¼–ç¨‹æ¨¡å‹
âœ… å£°æ˜å¼é…ç½®

ä¼ä¸šçº§åœºæ™¯ï¼š
âœ… äº‹åŠ¡æ”¯æŒ + ç›‘æ§é›†æˆ
âœ… ç»Ÿä¸€é”™è¯¯å¤„ç† + æ­»ä¿¡é˜Ÿåˆ—
âœ… é…ç½®ä¸­å¿ƒ + æœåŠ¡å‘ç°
```

### 9.4 å¼€å‘å®è·µå»ºè®®


**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**

```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å…¥é—¨ï¼ˆ1-2å‘¨ï¼‰
1. æŒæ¡Spring BootåŸºç¡€
2. ç†è§£KafkaåŸºæœ¬æ¦‚å¿µ
3. å®Œæˆç®€å•çš„æ¶ˆæ¯æ”¶å‘

ç¬¬äºŒé˜¶æ®µï¼šæ·±å…¥åº”ç”¨ï¼ˆ2-3å‘¨ï¼‰
1. æŒæ¡å„ç§é…ç½®é€‰é¡¹
2. ç†è§£é”™è¯¯å¤„ç†æœºåˆ¶
3. å®è·µäº‹åŠ¡æ”¯æŒ

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§ï¼ˆ2-4å‘¨ï¼‰
1. Spring Cloud Stream
2. ç›‘æ§å’Œè¿ç»´
3. æ€§èƒ½ä¼˜åŒ–å’Œæ•…éšœæ’æŸ¥

ç¬¬å››é˜¶æ®µï¼šç”Ÿäº§å®è·µï¼ˆæŒç»­ï¼‰
1. å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†
2. è·¨ç³»ç»Ÿé›†æˆ
3. æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µ
```

**âš¡ å¸¸è§é—®é¢˜è§£å†³**

```
æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼š
ğŸ”§ å¯ç”¨å¹‚ç­‰æ€§å¤„ç†
ğŸ”§ ä½¿ç”¨å”¯ä¸€é”®å»é‡
ğŸ”§ ä¸šåŠ¡å±‚é¢ä¿è¯å¹‚ç­‰

æ¶ˆæ¯ä¹±åºï¼š
ğŸ”§ ç›¸åŒä¸šåŠ¡ç”¨ç›¸åŒkey
ğŸ”§ å•åˆ†åŒºä¿è¯é¡ºåº
ğŸ”§ ä¸šåŠ¡å±‚é¢å¤„ç†ä¹±åº

æ¶ˆè´¹å»¶è¿Ÿï¼š
ğŸ”§ å¢åŠ æ¶ˆè´¹è€…å¹¶å‘åº¦
ğŸ”§ ä¼˜åŒ–ä¸šåŠ¡å¤„ç†é€»è¾‘
ğŸ”§ è°ƒæ•´æ‰¹æ¬¡å¤§å°

è¿æ¥é—®é¢˜ï¼š
ğŸ”§ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ğŸ”§ è°ƒæ•´è¶…æ—¶é…ç½®
ğŸ”§ é…ç½®é‡è¯•æœºåˆ¶
```

**ğŸ”‘ æ ¸å¿ƒé…ç½®æ¨¡æ¿**

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
spring:
  kafka:
    bootstrap-servers: ${KAFKA_SERVERS:localhost:9092}
    
    producer:
      acks: all
      retries: 3
      batch-size: 16384
      linger-ms: 5
      buffer-memory: 33554432
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      
    consumer:
      group-id: ${spring.application.name}-group
      auto-offset-reset: earliest
      enable-auto-commit: false
      session-timeout-ms: 30000
      max-poll-records: 500
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.yourcompany.model"
        
    listener:
      ack-mode: manual
      concurrency: 3
      missing-topics-fatal: false
```

### 9.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸš€ æŠ€æœ¯è¿›é˜¶**

```
æ·±å…¥KafkaåŸç†ï¼š
- åˆ†åŒºæœºåˆ¶å’Œå‰¯æœ¬ç­–ç•¥
- æ¶ˆè´¹è€…ç»„åè°ƒåè®®
- äº‹åŠ¡å®ç°åŸç†
- æ€§èƒ½è°ƒä¼˜æŠ€å·§

Springç”Ÿæ€æ‰©å±•ï¼š
- Spring Cloud Streamè¿›é˜¶
- Spring Integrationé›†æˆ
- Spring Boot Actuatorç›‘æ§
- Spring Securityæ¶ˆæ¯å®‰å…¨

æ¶æ„è®¾è®¡ï¼š
- å¾®æœåŠ¡æ¶ˆæ¯æ¨¡å¼
- äº‹ä»¶é©±åŠ¨æ¶æ„
- CQRSå’ŒEvent Sourcing
- åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
```

**ğŸ’¼ å®æˆ˜é¡¹ç›®å»ºè®®**

```
å…¥é—¨é¡¹ç›®ï¼š
- ç®€å•çš„æ¶ˆæ¯æ”¶å‘ç³»ç»Ÿ
- ç”¨æˆ·æ³¨å†Œé€šçŸ¥åŠŸèƒ½
- ç®€å•çš„è®¢å•å¤„ç†æµç¨‹

è¿›é˜¶é¡¹ç›®ï¼š
- ç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ
- å®æ—¶æ•°æ®å¤„ç†å¹³å°
- å¾®æœåŠ¡æ¶ˆæ¯æ€»çº¿

é«˜çº§é¡¹ç›®ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ç³»ç»Ÿ
- å®æ—¶æ¨èç³»ç»Ÿ
- å¤§æ•°æ®å®æ—¶è®¡ç®—å¹³å°
```

### 9.6 æ€»ç»“è®°å¿†è¦ç‚¹


**ğŸ¯ ä¸€å¥è¯æ ¸å¿ƒ**ï¼šSpring Kafkaè®©å¤æ‚çš„æ¶ˆæ¯å¤„ç†å˜å¾—ç®€å•ï¼Œé€šè¿‡æ³¨è§£å’Œé…ç½®å°±èƒ½å®ç°ä¼ä¸šçº§çš„æ¶ˆæ¯ç³»ç»Ÿã€‚

**ğŸ”‘ å…³é”®è®°å¿†ç‚¹**ï¼š
- `@KafkaListener`æ˜¯æ¶ˆæ¯æ¥æ”¶çš„æ ¸å¿ƒ
- `KafkaTemplate`æ˜¯æ¶ˆæ¯å‘é€çš„å·¥å…·
- é…ç½®å†³å®šæ€§èƒ½å’Œå¯é æ€§
- é”™è¯¯å¤„ç†å†³å®šç³»ç»Ÿå¥å£®æ€§
- äº‹åŠ¡æ”¯æŒä¿è¯æ•°æ®ä¸€è‡´æ€§

**ğŸ“ å®è·µå£è¯€**ï¼š
- å‘é€ç”¨Templateï¼Œæ¥æ”¶ç”¨Listener
- é…ç½®è¦ç»†å¿ƒï¼Œé”™è¯¯è¦å¤„ç†
- äº‹åŠ¡ä¿ä¸€è‡´ï¼Œç›‘æ§ä¿ç¨³å®š
- ç®€å•åœºæ™¯ç›´æ¥ç”¨ï¼Œå¤æ‚åœºæ™¯StreamåŠ©

**ğŸ’¡ æœ€ç»ˆå»ºè®®**ï¼š
ä»ç®€å•çš„æ¶ˆæ¯æ”¶å‘å¼€å§‹ï¼Œé€æ­¥æŒæ¡å„ç§ç‰¹æ€§ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ç§¯ç´¯ç»éªŒã€‚é‡ç‚¹å…³æ³¨é…ç½®ä¼˜åŒ–ã€é”™è¯¯å¤„ç†å’Œæ€§èƒ½è°ƒä¼˜ï¼Œè¿™äº›æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å…³é”®ã€‚

---

**æ ¸å¿ƒä»·å€¼**ï¼šSpringç”Ÿæ€çš„Kafkaé›†æˆä¸ä»…ç®€åŒ–äº†å¼€å‘å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯æä¾›äº†ä¼ä¸šçº§çš„å¯é æ€§ã€å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œä¸æ˜¯åº•å±‚çš„æ¶ˆæ¯å¤„ç†ç»†èŠ‚ã€‚