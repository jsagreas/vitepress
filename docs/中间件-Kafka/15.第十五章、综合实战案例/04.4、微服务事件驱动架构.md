---
title: 4ã€å¾®æœåŠ¡äº‹ä»¶é©±åŠ¨æ¶æ„
---
## ğŸ“š ç›®å½•


1. [äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€æ¦‚å¿µ](#1-äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€æ¦‚å¿µ)
2. [äº‹ä»¶æº¯æºæ¨¡å¼è¯¦è§£](#2-äº‹ä»¶æº¯æºæ¨¡å¼è¯¦è§£)
3. [CQRSæ¶æ„æ¨¡å¼](#3-CQRSæ¶æ„æ¨¡å¼)
4. [Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼](#4-Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼)
5. [æœåŠ¡è§£è€¦è®¾è®¡ç­–ç•¥](#5-æœåŠ¡è§£è€¦è®¾è®¡ç­–ç•¥)
6. [æ¶ˆæ¯è·¯ç”±ä¸äº‹ä»¶ç‰ˆæœ¬ç®¡ç†](#6-æ¶ˆæ¯è·¯ç”±ä¸äº‹ä»¶ç‰ˆæœ¬ç®¡ç†)
7. [æ•…éšœå¤„ç†ä¸å®¹é”™æœºåˆ¶](#7-æ•…éšœå¤„ç†ä¸å®¹é”™æœºåˆ¶)
8. [ç»¼åˆå®æˆ˜æ¡ˆä¾‹](#8-ç»¼åˆå®æˆ˜æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# 1. ğŸ¯ äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€æ¦‚å¿µ



## 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„



**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸‹é¤å…çš„è¿ä½œæ–¹å¼
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ï¼š
é¡¾å®¢ç‚¹é¤ â†’ ç›´æ¥æ‰¾å¨å¸ˆ â†’ ç­‰å¨å¸ˆåšå®Œ â†’ å†æ‰¾æœåŠ¡å‘˜ä¸Šèœ
é—®é¢˜ï¼šæ‰€æœ‰äººéƒ½è¦ç­‰ï¼Œæ•ˆç‡ä½

äº‹ä»¶é©±åŠ¨æ–¹å¼ï¼ˆå¼‚æ­¥æ¶ˆæ¯ï¼‰ï¼š
é¡¾å®¢ç‚¹é¤ â†’ å‘å‡º"ç‚¹é¤äº‹ä»¶" â†’ å¨å¸ˆæ”¶åˆ°å¼€å§‹åšèœ
åŒæ—¶ â†’ æœåŠ¡å‘˜æ”¶åˆ°å‡†å¤‡é¤å…· â†’ æ”¶é“¶å‘˜æ”¶åˆ°å‡†å¤‡è´¦å•
ä¼˜åŠ¿ï¼šå„è‡ªå·¥ä½œï¼Œäº’ä¸é˜»å¡
```

**æŠ€æœ¯å®šä¹‰**ï¼š
- **äº‹ä»¶ï¼ˆEventï¼‰**ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦çŠ¶æ€å˜åŒ–
- **äº‹ä»¶é©±åŠ¨**ï¼šé€šè¿‡äº‹ä»¶æ¥è§¦å‘å’Œåè°ƒå„ä¸ªæœåŠ¡çš„è¡Œä¸º
- **å¼‚æ­¥è§£è€¦**ï¼šæœåŠ¡ä¹‹é—´ä¸ç›´æ¥è°ƒç”¨ï¼Œé€šè¿‡äº‹ä»¶é€šä¿¡

## 1.2 äº‹ä»¶é©±åŠ¨ vs ä¼ ç»Ÿæ¶æ„å¯¹æ¯”



| ç‰¹æ€§ | **ä¼ ç»ŸåŒæ­¥æ¶æ„** | **äº‹ä»¶é©±åŠ¨æ¶æ„** |
|------|----------------|-----------------|
| **æœåŠ¡è°ƒç”¨** | `ç›´æ¥APIè°ƒç”¨` | `é€šè¿‡äº‹ä»¶é€šä¿¡` |
| **è€¦åˆç¨‹åº¦** | `ç´§è€¦åˆ` | `æ¾è€¦åˆ` |
| **æ•…éšœå½±å“** | `ä¸€ä¸ªæœåŠ¡æ•…éšœå½±å“å…¨é“¾è·¯` | `æ•…éšœéš”ç¦»ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡` |
| **æ‰©å±•æ€§** | `éš¾ä»¥æ‰©å±•` | `æ˜“äºæ‰©å±•å’Œæ–°å¢æœåŠ¡` |
| **æ€§èƒ½** | `åŒæ­¥ç­‰å¾…ï¼Œæ€§èƒ½ç“¶é¢ˆ` | `å¼‚æ­¥å¤„ç†ï¼Œé«˜ååé‡` |

## 1.3 Kafkaåœ¨äº‹ä»¶é©±åŠ¨æ¶æ„ä¸­çš„è§’è‰²



**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **äº‹ä»¶æ€»çº¿**ï¼šæ‰€æœ‰äº‹ä»¶çš„ç»Ÿä¸€ä¼ è¾“é€šé“
- ğŸ”¸ **æ¶ˆæ¯å­˜å‚¨**ï¼šæŒä¹…åŒ–ä¿å­˜äº‹ä»¶æ•°æ®
- ğŸ”¸ **æœåŠ¡è§£è€¦**ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…äº’ä¸ä¾èµ–
- ğŸ”¸ **é¡ºåºä¿è¯**ï¼šç¡®ä¿äº‹ä»¶çš„æ—¶åºæ€§

```
å¾®æœåŠ¡æ¶æ„ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    äº‹ä»¶å‘å¸ƒ    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚    Kafka    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ Event Hub   â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    äº‹ä»¶è®¢é˜…         â†“
â”‚  è®¢å•æœåŠ¡    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    äº‹ä»¶è®¢é˜…         â†“  
â”‚  åº“å­˜æœåŠ¡    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    äº‹ä»¶è®¢é˜…         â†“
â”‚  æ”¯ä»˜æœåŠ¡    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 2. ğŸ“– äº‹ä»¶æº¯æºæ¨¡å¼è¯¦è§£



## 2.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æº¯æº



**ç”Ÿæ´»ç±»æ¯”**ï¼šé“¶è¡Œè´¦æˆ·çš„äº¤æ˜“è®°å½•
```
ä¼ ç»Ÿåšæ³•ï¼šåªä¿å­˜å½“å‰ä½™é¢
è´¦æˆ·ä½™é¢ï¼š1000å…ƒ
é—®é¢˜ï¼šä¸çŸ¥é“ä½™é¢æ˜¯æ€ä¹ˆæ¥çš„

äº‹ä»¶æº¯æºåšæ³•ï¼šä¿å­˜æ‰€æœ‰äº¤æ˜“äº‹ä»¶
å¼€æˆ·ï¼š+1000å…ƒ
æ¶ˆè´¹ï¼š-200å…ƒ  
è½¬å…¥ï¼š+500å…ƒ
å½“å‰ä½™é¢ï¼š1300å…ƒ
ä¼˜åŠ¿ï¼šå¯ä»¥å›æº¯ä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€
```

**æŠ€æœ¯å«ä¹‰**ï¼š
- **ä¸ä¿å­˜å½“å‰çŠ¶æ€**ï¼šåªå­˜å‚¨å¯¼è‡´çŠ¶æ€å˜åŒ–çš„äº‹ä»¶
- **é‡æ”¾äº‹ä»¶**ï¼šé€šè¿‡é‡æ”¾å†å²äº‹ä»¶é‡å»ºå½“å‰çŠ¶æ€
- **å®Œæ•´å†å²**ï¼šä¿ç•™ç³»ç»Ÿå®Œæ•´çš„å˜åŒ–å†å²

## 2.2 äº‹ä»¶æº¯æºçš„æ ¸å¿ƒæ¦‚å¿µ



**äº‹ä»¶çš„ç‰¹æ€§**ï¼š
```
ğŸ”¸ ä¸å¯å˜æ€§ï¼šäº‹ä»¶ä¸€æ—¦å‘ç”Ÿå°±ä¸èƒ½ä¿®æ”¹
ğŸ”¸ æ—¶åºæ€§ï¼šäº‹ä»¶æœ‰æ˜ç¡®çš„å‘ç”Ÿæ—¶é—´é¡ºåº
ğŸ”¸ ä¸šåŠ¡å«ä¹‰ï¼šæ¯ä¸ªäº‹ä»¶ä»£è¡¨ä¸€ä¸ªä¸šåŠ¡æ“ä½œ
ğŸ”¸ å®Œæ•´æ€§ï¼šåŒ…å«é‡å»ºçŠ¶æ€æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯
```

**äº‹ä»¶ç±»å‹ç¤ºä¾‹**ï¼š
```json
// ç”¨æˆ·æ³¨å†Œäº‹ä»¶
{
  "eventType": "UserRegistered",
  "eventId": "usr-001",
  "timestamp": "2025-09-20T10:00:00Z",
  "data": {
    "userId": "12345",
    "email": "user@example.com",
    "name": "å¼ ä¸‰"
  }
}

// è®¢å•åˆ›å»ºäº‹ä»¶
{
  "eventType": "OrderCreated", 
  "eventId": "ord-001",
  "timestamp": "2025-09-20T10:05:00Z",
  "data": {
    "orderId": "98765",
    "userId": "12345",
    "products": ["å•†å“A", "å•†å“B"],
    "totalAmount": 299.00
  }
}
```

## 2.3 äº‹ä»¶æº¯æºå®ç°æ¨¡å¼



**åŸºæœ¬å®ç°æ­¥éª¤**ï¼š
```
æ­¥éª¤1ï¼šå®šä¹‰äº‹ä»¶ç»“æ„
â†“
æ­¥éª¤2ï¼šäº‹ä»¶å­˜å‚¨åˆ°Kafka
â†“  
æ­¥éª¤3ï¼šäº‹ä»¶å¤„ç†å™¨é‡å»ºçŠ¶æ€
â†“
æ­¥éª¤4ï¼šæä¾›æŸ¥è¯¢æ¥å£
```

**ä»£ç å®ç°ç¤ºä¾‹**ï¼š
```java
// äº‹ä»¶å®šä¹‰
public class OrderEvent {
    private String eventType;
    private String orderId;
    private Long timestamp;
    private Object eventData;
    // getter/setter...
}

// äº‹ä»¶å­˜å‚¨
@Service
public class EventStore {
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafkaTemplate;
    
    public void saveEvent(OrderEvent event) {
        // å‘é€åˆ°Kafkaè¿›è¡ŒæŒä¹…åŒ–
        kafkaTemplate.send("order-events", event.getOrderId(), event);
    }
}

// çŠ¶æ€é‡å»º
@Service  
public class OrderProjection {
    private Map<String, Order> orders = new HashMap<>();
    
    @KafkaListener(topics = "order-events")
    public void handleEvent(OrderEvent event) {
        switch (event.getEventType()) {
            case "OrderCreated":
                createOrder(event);
                break;
            case "OrderPaid":
                markOrderPaid(event);
                break;
        }
    }
}
```

## 2.4 äº‹ä»¶æº¯æºçš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜



**ä¸»è¦ä¼˜åŠ¿**ï¼š
- âœ… **å®¡è®¡èƒ½åŠ›**ï¼šå®Œæ•´çš„æ“ä½œå†å²è®°å½•
- âœ… **æ—¶é—´æ—…è¡Œ**ï¼šå¯ä»¥æŸ¥çœ‹ä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€
- âœ… **è°ƒè¯•å‹å¥½**ï¼šå®¹æ˜“å®šä½é—®é¢˜å‘ç”Ÿçš„åŸå› 
- âœ… **æ‰©å±•æ€§å¥½**ï¼šæ–°çš„è§†å›¾å¯ä»¥ä»å†å²äº‹ä»¶æ„å»º

**é¢ä¸´æŒ‘æˆ˜**ï¼š
- âš ï¸ **å­˜å‚¨æˆæœ¬**ï¼šéœ€è¦å­˜å‚¨æ‰€æœ‰å†å²äº‹ä»¶
- âš ï¸ **æŸ¥è¯¢å¤æ‚**ï¼šå½“å‰çŠ¶æ€éœ€è¦é€šè¿‡äº‹ä»¶é‡å»º
- âš ï¸ **äº‹ä»¶æ¼”åŒ–**ï¼šäº‹ä»¶ç»“æ„å˜åŒ–æ—¶çš„å…¼å®¹æ€§é—®é¢˜

---

# 3. ğŸ”„ CQRSæ¶æ„æ¨¡å¼



## 3.1 CQRSæ˜¯ä»€ä¹ˆ



**CQRSå…¨ç§°**ï¼šCommand Query Responsibility Segregationï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰

**é€šä¿—ç†è§£**ï¼šå›¾ä¹¦é¦†çš„ç®¡ç†æ–¹å¼
```
ä¼ ç»Ÿæ–¹å¼ï¼š
åŒä¸€ä¸ªç³»ç»Ÿæ—¢è¦å¤„ç†å€Ÿä¹¦ã€è¿˜ä¹¦ï¼ˆå†™æ“ä½œï¼‰
åˆè¦å¤„ç†æŸ¥æ‰¾å›¾ä¹¦ã€ç»Ÿè®¡æŠ¥è¡¨ï¼ˆè¯»æ“ä½œï¼‰
é—®é¢˜ï¼šå†™æ“ä½œå’Œè¯»æ“ä½œç›¸äº’å½±å“æ€§èƒ½

CQRSæ–¹å¼ï¼š
å†™æ“ä½œï¼šä¸“é—¨çš„å€Ÿè¿˜ä¹¦ç³»ç»Ÿï¼ˆä¼˜åŒ–å†™å…¥æ€§èƒ½ï¼‰
è¯»æ“ä½œï¼šä¸“é—¨çš„æŸ¥è¯¢ç³»ç»Ÿï¼ˆä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰  
ä¼˜åŠ¿ï¼šå„è‡ªä¸“ä¸šåŒ–ï¼Œæ€§èƒ½éƒ½å¾ˆå¥½
```

## 3.2 CQRSæ¶æ„ç»„æˆ



**æ ¸å¿ƒç»„ä»¶**ï¼š
```
å‘½ä»¤ç«¯ï¼ˆCommand Sideï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å†™æ“ä½œ     â”‚ â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘
â”‚  Command    â”‚ â†’ äº§ç”Ÿäº‹ä»¶
â”‚   Model     â”‚ â†’ ä¿å­˜åˆ°äº‹ä»¶å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢ç«¯ï¼ˆQuery Sideï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯»æ“ä½œ     â”‚ â†’ ä¼˜åŒ–æŸ¥è¯¢ç»“æ„
â”‚   Query     â”‚ â†’ é¢„å»ºç´¢å¼•
â”‚   Model     â”‚ â†’ å¿«é€Ÿå“åº”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸­é—´é€šè¿‡äº‹ä»¶åŒæ­¥ï¼š
Command â†’ Events â†’ Query
```

## 3.3 CQRSä¸Kafkaç»“åˆå®ç°



**æ¶æ„è®¾è®¡**ï¼š
```
ç”¨æˆ·è¯·æ±‚å¤„ç†æµç¨‹ï¼š

å†™è¯·æ±‚è·¯å¾„ï¼š
å®¢æˆ·ç«¯ â†’ Command API â†’ ä¸šåŠ¡é€»è¾‘ â†’ äº‹ä»¶å‘å¸ƒ â†’ Kafka

è¯»è¯·æ±‚è·¯å¾„ï¼š  
å®¢æˆ·ç«¯ â†’ Query API â†’ æŸ¥è¯¢æ¨¡å‹ â†’ ç›´æ¥è¿”å›

äº‹ä»¶åŒæ­¥è·¯å¾„ï¼š
Kafka â†’ Event Handler â†’ æ›´æ–°Queryæ¨¡å‹
```

**ä»£ç å®ç°**ï¼š
```java
// å‘½ä»¤å¤„ç†å™¨
@RestController
public class OrderCommandController {
    
    @PostMapping("/orders")
    public ResponseEntity<String> createOrder(@RequestBody CreateOrderCommand cmd) {
        // 1. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        Order order = orderService.createOrder(cmd);
        
        // 2. å‘å¸ƒäº‹ä»¶åˆ°Kafka
        OrderCreatedEvent event = new OrderCreatedEvent(order);
        eventPublisher.publish("order-events", event);
        
        return ResponseEntity.ok("è®¢å•åˆ›å»ºæˆåŠŸ");
    }
}

// æŸ¥è¯¢å¤„ç†å™¨
@RestController  
public class OrderQueryController {
    
    @GetMapping("/orders/{orderId}")
    public Order getOrder(@PathVariable String orderId) {
        // ç›´æ¥ä»æŸ¥è¯¢æ¨¡å‹è·å–
        return orderQueryService.findById(orderId);
    }
    
    @GetMapping("/orders/user/{userId}")
    public List<Order> getUserOrders(@PathVariable String userId) {
        // ä¼˜åŒ–è¿‡çš„æŸ¥è¯¢ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶
        return orderQueryService.findByUserId(userId);
    }
}

// äº‹ä»¶å¤„ç†å™¨æ›´æ–°æŸ¥è¯¢æ¨¡å‹
@Component
public class OrderEventHandler {
    
    @KafkaListener(topics = "order-events")
    public void handle(OrderCreatedEvent event) {
        // æ›´æ–°æŸ¥è¯¢æ•°æ®åº“
        OrderQueryModel queryModel = convertToQueryModel(event);
        orderQueryRepository.save(queryModel);
    }
}
```

## 3.4 CQRSçš„é€‚ç”¨åœºæ™¯



**é€‚åˆä½¿ç”¨CQRSçš„æƒ…å†µ**ï¼š
- ğŸ¯ **è¯»å†™ä¸å‡è¡¡**ï¼šè¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œ
- ğŸ¯ **å¤æ‚æŸ¥è¯¢**ï¼šéœ€è¦å¤šç§ä¸åŒçš„æ•°æ®è§†å›¾
- ğŸ¯ **é«˜å¹¶å‘**ï¼šéœ€è¦ä¼˜åŒ–è¯»å†™æ€§èƒ½
- ğŸ¯ **å®¡è®¡è¦æ±‚**ï¼šéœ€è¦å®Œæ•´çš„æ“ä½œè®°å½•

**ä¸é€‚åˆçš„æƒ…å†µ**ï¼š
- âŒ **ç®€å•CRUD**ï¼šä¸šåŠ¡é€»è¾‘ç®€å•çš„å¢åˆ æ”¹æŸ¥
- âŒ **å¼ºä¸€è‡´æ€§è¦æ±‚**ï¼šä¸èƒ½æ¥å—è¯»å†™ä¹‹é—´çš„å»¶è¿Ÿ
- âŒ **å›¢é˜Ÿç»éªŒä¸è¶³**ï¼šå¢åŠ äº†ç³»ç»Ÿå¤æ‚æ€§

---

# 4. ğŸ”„ Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼



## 4.1 ä»€ä¹ˆæ˜¯Sagaæ¨¡å¼



**ä¼ ç»Ÿåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜**ï¼š
```
ç”µå•†ä¸‹å•åœºæ™¯ï¼š
è®¢å•æœåŠ¡ â†’ åˆ›å»ºè®¢å•
åº“å­˜æœåŠ¡ â†’ æ‰£å‡åº“å­˜  
æ”¯ä»˜æœåŠ¡ â†’ æ‰£æ¬¾
ç§¯åˆ†æœåŠ¡ â†’ å¢åŠ ç§¯åˆ†

é—®é¢˜ï¼šå¦‚æœç§¯åˆ†æœåŠ¡å¤±è´¥äº†ï¼Œå‰é¢çš„æ“ä½œæ€ä¹ˆå›æ»šï¼Ÿ
ä¼ ç»Ÿ2PCï¼šæ‰€æœ‰æœåŠ¡éƒ½è¦ç­‰å¾…ï¼Œæ€§èƒ½å·®
```

**Sagaè§£å†³æ–¹æ¡ˆ**ï¼š
```
æ ¸å¿ƒæ€æƒ³ï¼šå°†å¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°äº‹åŠ¡
æ¯ä¸ªå°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
å¦‚æœæŸæ­¥å¤±è´¥ï¼Œæ‰§è¡Œå‰é¢æ‰€æœ‰æ­¥éª¤çš„è¡¥å¿æ“ä½œ

ä¸‹å•Sagaï¼š
1. åˆ›å»ºè®¢å• â†” å–æ¶ˆè®¢å•
2. æ‰£å‡åº“å­˜ â†” æ¢å¤åº“å­˜  
3. æ‰£æ¬¾æ”¯ä»˜ â†” é€€æ¬¾
4. å¢åŠ ç§¯åˆ† â†” æ‰£å‡ç§¯åˆ†
```

## 4.2 Sagaçš„ä¸¤ç§å®ç°æ–¹å¼



**ç¼–æ’å¼ï¼ˆOrchestrationï¼‰**ï¼š
```
ä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sagaåè°ƒå™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â–¼       â–¼
è®¢å•æœåŠ¡  åº“å­˜æœåŠ¡
   â–¼       â–¼  
æ”¯ä»˜æœåŠ¡  ç§¯åˆ†æœåŠ¡

ä¼˜ç‚¹ï¼šé›†ä¸­æ§åˆ¶ï¼Œæ˜“äºç®¡ç†
ç¼ºç‚¹ï¼šåè°ƒå™¨æˆä¸ºå•ç‚¹ï¼Œè€¦åˆåº¦é«˜
```

**ååŒå¼ï¼ˆChoreographyï¼‰**ï¼š
```
æœåŠ¡é—´é€šè¿‡äº‹ä»¶ååŒå·¥ä½œï¼š

ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡å‘å¸ƒ"è®¢å•åˆ›å»º"äº‹ä»¶
            â†“
         åº“å­˜æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œæ‰£å‡åº“å­˜ï¼Œå‘å¸ƒ"åº“å­˜æ‰£å‡"äº‹ä»¶
            â†“  
         æ”¯ä»˜æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œæ‰§è¡Œæ”¯ä»˜ï¼Œå‘å¸ƒ"æ”¯ä»˜å®Œæˆ"äº‹ä»¶
            â†“
         ç§¯åˆ†æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œå¢åŠ ç§¯åˆ†

ä¼˜ç‚¹ï¼šå»ä¸­å¿ƒåŒ–ï¼Œæ¾è€¦åˆ
ç¼ºç‚¹ï¼šæµç¨‹åˆ†æ•£ï¼Œéš¾ä»¥è·Ÿè¸ª
```

## 4.3 åŸºäºKafkaçš„ååŒå¼Sagaå®ç°



**äº‹ä»¶æµè®¾è®¡**ï¼š
```
Topicè§„åˆ’ï¼š
order-events      â†’ è®¢å•ç›¸å…³äº‹ä»¶
inventory-events  â†’ åº“å­˜ç›¸å…³äº‹ä»¶  
payment-events    â†’ æ”¯ä»˜ç›¸å…³äº‹ä»¶
point-events      â†’ ç§¯åˆ†ç›¸å…³äº‹ä»¶
saga-events       â†’ Sagaåè°ƒäº‹ä»¶
```

**å®ç°ä»£ç **ï¼š
```java
// è®¢å•æœåŠ¡
@Component
public class OrderService {
    
    public void createOrder(CreateOrderCommand cmd) {
        try {
            // åˆ›å»ºè®¢å•
            Order order = new Order(cmd);
            orderRepository.save(order);
            
            // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
            OrderCreatedEvent event = new OrderCreatedEvent(order);
            eventPublisher.publish("order-events", event);
            
        } catch (Exception e) {
            // å‘å¸ƒè®¢å•åˆ›å»ºå¤±è´¥äº‹ä»¶
            OrderCreateFailedEvent failEvent = new OrderCreateFailedEvent(cmd);
            eventPublisher.publish("order-events", failEvent);
        }
    }
    
    // ç›‘å¬åº“å­˜ä¸è¶³äº‹ä»¶ï¼Œæ‰§è¡Œè¡¥å¿
    @KafkaListener(topics = "inventory-events")
    public void handleInventoryInsufficient(InventoryInsufficientEvent event) {
        // å–æ¶ˆè®¢å•ï¼ˆè¡¥å¿æ“ä½œï¼‰
        cancelOrder(event.getOrderId());
    }
}

// åº“å­˜æœåŠ¡
@Component  
public class InventoryService {
    
    @KafkaListener(topics = "order-events")
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            reduceInventory(event.getProducts());
            
            // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            InventoryReducedEvent reducedEvent = new InventoryReducedEvent(event);
            eventPublisher.publish("inventory-events", reducedEvent);
            
        } catch (InsufficientInventoryException e) {
            // å‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶
            InventoryInsufficientEvent insufficientEvent = 
                new InventoryInsufficientEvent(event);
            eventPublisher.publish("inventory-events", insufficientEvent);
        }
    }
}
```

## 4.4 SagaçŠ¶æ€ç®¡ç†



**çŠ¶æ€è·Ÿè¸ª**ï¼š
```java
// SagaçŠ¶æ€å®ä½“
@Entity
public class SagaState {
    private String sagaId;
    private String sagaType;  // ORDER_PROCESS
    private SagaStatus status; // STARTED, COMPLETED, COMPENSATING, FAILED
    private List<String> completedSteps;
    private String currentStep;
    private Map<String, Object> sagaData;
}

// SagaçŠ¶æ€ç®¡ç†å™¨
@Component
public class SagaStateManager {
    
    public void updateSagaState(String sagaId, String step, SagaStatus status) {
        SagaState saga = sagaRepository.findById(sagaId);
        saga.setCurrentStep(step);
        saga.setStatus(status);
        if (status == SagaStatus.COMPLETED) {
            saga.getCompletedSteps().add(step);
        }
        sagaRepository.save(saga);
    }
    
    public void startCompensation(String sagaId) {
        SagaState saga = sagaRepository.findById(sagaId);
        saga.setStatus(SagaStatus.COMPENSATING);
        
        // æŒ‰é€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
        List<String> stepsToCompensate = saga.getCompletedSteps();
        Collections.reverse(stepsToCompensate);
        
        for (String step : stepsToCompensate) {
            publishCompensationEvent(sagaId, step);
        }
    }
}
```

---

# 5. ğŸ”— æœåŠ¡è§£è€¦è®¾è®¡ç­–ç•¥



## 5.1 è§£è€¦çš„é‡è¦æ€§



**ç´§è€¦åˆçš„é—®é¢˜**ï¼š
```
ä¼ ç»Ÿå¾®æœåŠ¡è°ƒç”¨é“¾ï¼š
ç”¨æˆ·æœåŠ¡ â†’ è°ƒç”¨è®¢å•æœåŠ¡ â†’ è°ƒç”¨åº“å­˜æœåŠ¡ â†’ è°ƒç”¨æ”¯ä»˜æœåŠ¡

é—®é¢˜åˆ†æï¼š
âŒ ä»»ä½•ä¸€ä¸ªæœåŠ¡æ•…éšœï¼Œæ•´æ¡é“¾è·¯å¤±è´¥
âŒ æ€§èƒ½ç“¶é¢ˆï¼šæœ€æ…¢çš„æœåŠ¡å½±å“æ•´ä½“æ€§èƒ½  
âŒ æ‰©å±•å›°éš¾ï¼šæ–°å¢æœåŠ¡éœ€è¦ä¿®æ”¹è°ƒç”¨æ–¹
âŒ æµ‹è¯•å¤æ‚ï¼šæµ‹è¯•ä¸€ä¸ªåŠŸèƒ½éœ€è¦å¯åŠ¨å¤šä¸ªæœåŠ¡
```

**äº‹ä»¶é©±åŠ¨è§£è€¦å**ï¼š
```
äº‹ä»¶é©±åŠ¨è§£è€¦ï¼š
ç”¨æˆ·æœåŠ¡ â†’ å‘å¸ƒç”¨æˆ·äº‹ä»¶ â†’ Kafka
è®¢å•æœåŠ¡ â† è®¢é˜…ç”¨æˆ·äº‹ä»¶ â† Kafka
åº“å­˜æœåŠ¡ â† è®¢é˜…è®¢å•äº‹ä»¶ â† Kafka  
æ”¯ä»˜æœåŠ¡ â† è®¢é˜…è®¢å•äº‹ä»¶ â† Kafka

ä¼˜åŠ¿åˆ†æï¼š
âœ… æ•…éšœéš”ç¦»ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¶ä»–æœåŠ¡
âœ… ç‹¬ç«‹æ‰©å±•ï¼šæ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹æ‰©å®¹
âœ… æ¾è€¦åˆï¼šæœåŠ¡é—´ä¸ç›´æ¥ä¾èµ–
âœ… æ˜“äºæµ‹è¯•ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæœåŠ¡
```

## 5.2 äº‹ä»¶è®¾è®¡åŸåˆ™



**äº‹ä»¶å‘½åè§„èŒƒ**ï¼š
```
æ ¼å¼ï¼š{é¢†åŸŸ}.{å®ä½“}.{åŠ¨ä½œ}
ç¤ºä¾‹ï¼š
order.order.created     â†’ è®¢å•åˆ›å»º
user.profile.updated    â†’ ç”¨æˆ·ä¿¡æ¯æ›´æ–°
inventory.stock.depleted â†’ åº“å­˜è€—å°½
payment.transaction.completed â†’ æ”¯ä»˜å®Œæˆ
```

**äº‹ä»¶å†…å®¹è®¾è®¡**ï¼š
```json
{
  "eventId": "å”¯ä¸€æ ‡è¯†ç¬¦",
  "eventType": "äº‹ä»¶ç±»å‹", 
  "eventVersion": "äº‹ä»¶ç‰ˆæœ¬",
  "timestamp": "äº‹ä»¶æ—¶é—´",
  "source": "äº‹ä»¶æ¥æºæœåŠ¡",
  "data": {
    "èšåˆæ ¹ID": "ä¸šåŠ¡ä¸»é”®",
    "å…·ä½“ä¸šåŠ¡æ•°æ®": "å˜æ›´å†…å®¹"
  },
  "metadata": {
    "correlationId": "å…³è”ID",
    "causationId": "å› æœID"
  }
}
```

## 5.3 é¢†åŸŸäº‹ä»¶vsé›†æˆäº‹ä»¶



**é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰**ï¼š
```
å®šä¹‰ï¼šé¢†åŸŸå†…éƒ¨çš„ä¸šåŠ¡äº‹ä»¶
ç‰¹ç‚¹ï¼š
- è¡¨è¾¾ä¸šåŠ¡å«ä¹‰
- é¢†åŸŸä¸“å®¶èƒ½ç†è§£  
- åŒ…å«å®Œæ•´ä¸šåŠ¡ä¸Šä¸‹æ–‡

ç¤ºä¾‹ï¼š
ç”¨æˆ·å®Œæˆæ³¨å†Œ â†’ UserRegistrationCompleted
è®¢å•æ”¯ä»˜æˆåŠŸ â†’ OrderPaymentSucceeded
åº“å­˜ä½äºé˜ˆå€¼ â†’ InventoryBelowThreshold
```

**é›†æˆäº‹ä»¶ï¼ˆIntegration Eventsï¼‰**ï¼š
```
å®šä¹‰ï¼šè·¨æœåŠ¡è¾¹ç•Œçš„äº‹ä»¶
ç‰¹ç‚¹ï¼š
- æ ‡å‡†åŒ–æ ¼å¼
- æœ€å°åŒ–æ•°æ®
- ç¨³å®šçš„æ¥å£

ç¤ºä¾‹ï¼š
ç”¨æˆ·æœåŠ¡ â†’ å…¶ä»–æœåŠ¡ï¼šUserCreated
è®¢å•æœåŠ¡ â†’ å…¶ä»–æœåŠ¡ï¼šOrderPlaced
åº“å­˜æœåŠ¡ â†’ å…¶ä»–æœåŠ¡ï¼šStockUpdated
```

## 5.4 æœåŠ¡é—´é€šä¿¡æ¨¡å¼



**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**ï¼š
```java
// äº‹ä»¶å‘å¸ƒè€…
@Component
public class OrderEventPublisher {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void publishOrderCreated(Order order) {
        OrderCreatedEvent event = OrderCreatedEvent.builder()
            .orderId(order.getId())
            .userId(order.getUserId())
            .amount(order.getAmount())
            .timestamp(Instant.now())
            .build();
            
        kafkaTemplate.send("order.events", order.getId(), event);
    }
}

// äº‹ä»¶è®¢é˜…è€…
@Component
public class InventoryEventHandler {
    
    @KafkaListener(topics = "order.events")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // åªå…³å¿ƒä¸åº“å­˜ç›¸å…³çš„è®¢å•ä¿¡æ¯
        if (needsInventoryCheck(event)) {
            inventoryService.reserveItems(
                event.getOrderId(), 
                event.getItems()
            );
        }
    }
}
```

**äº‹ä»¶èšåˆæ¨¡å¼**ï¼š
```java
// å¤æ‚ä¸šåŠ¡åœºæ™¯çš„äº‹ä»¶èšåˆ
@Component
public class OrderProcessingAggregator {
    
    private Map<String, OrderProcessingState> processingStates = new ConcurrentHashMap<>();
    
    @KafkaListener(topics = "order.events")
    public void handleOrderEvent(OrderEvent event) {
        String orderId = event.getOrderId();
        OrderProcessingState state = processingStates.computeIfAbsent(
            orderId, k -> new OrderProcessingState());
            
        updateState(state, event);
        
        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ­¥éª¤éƒ½å®Œæˆ
        if (state.isCompleted()) {
            publishOrderCompleted(orderId);
            processingStates.remove(orderId);
        }
    }
    
    private void updateState(OrderProcessingState state, OrderEvent event) {
        switch (event.getEventType()) {
            case "OrderCreated":
                state.setOrderCreated(true);
                break;
            case "InventoryReserved":
                state.setInventoryReserved(true);
                break;
            case "PaymentProcessed":
                state.setPaymentProcessed(true);
                break;
        }
    }
}
```

---

# 6. ğŸš¦ æ¶ˆæ¯è·¯ç”±ä¸äº‹ä»¶ç‰ˆæœ¬ç®¡ç†



## 6.1 æ¶ˆæ¯è·¯ç”±ç­–ç•¥



**åŸºäºå†…å®¹çš„è·¯ç”±**ï¼š
```java
// è·¯ç”±è§„åˆ™é…ç½®
@Component
public class EventRouter {
    
    @KafkaListener(topics = "all-events")
    public void routeEvent(GenericEvent event) {
        String eventType = event.getEventType();
        String routingKey = determineRoutingKey(event);
        
        // æ ¹æ®äº‹ä»¶ç±»å‹å’Œå†…å®¹è·¯ç”±åˆ°ä¸åŒTopic
        switch (eventType) {
            case "UserEvent":
                if (event.getData().get("userType").equals("VIP")) {
                    kafkaTemplate.send("vip-user-events", event);
                } else {
                    kafkaTemplate.send("regular-user-events", event);
                }
                break;
                
            case "OrderEvent":
                BigDecimal amount = (BigDecimal) event.getData().get("amount");
                if (amount.compareTo(new BigDecimal("1000")) > 0) {
                    kafkaTemplate.send("high-value-orders", event);
                } else {
                    kafkaTemplate.send("regular-orders", event);
                }
                break;
        }
    }
}
```

**åœ°ç†ä½ç½®è·¯ç”±**ï¼š
```java
// åŸºäºåœ°ç†ä½ç½®çš„äº‹ä»¶åˆ†å‘
@Component
public class GeoEventRouter {
    
    public void routeByRegion(UserEvent event) {
        String region = determineRegion(event.getData().get("location"));
        
        String targetTopic = String.format("user-events-%s", region);
        kafkaTemplate.send(targetTopic, event);
    }
    
    private String determineRegion(Object location) {
        // æ ¹æ®IPæˆ–å…¶ä»–ä¿¡æ¯åˆ¤æ–­åœ°ç†ä½ç½®
        // è¿”å› cn-north, cn-south, us-west ç­‰
        return regionService.getRegion(location);
    }
}
```

## 6.2 äº‹ä»¶ç‰ˆæœ¬ç®¡ç†



**ç‰ˆæœ¬æ¼”åŒ–é—®é¢˜**ï¼š
```
åœºæ™¯ï¼šç”¨æˆ·äº‹ä»¶ç»“æ„å˜åŒ–

V1ç‰ˆæœ¬ï¼š
{
  "eventType": "UserCreated",
  "userId": "12345",
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com"
}

V2ç‰ˆæœ¬ï¼šï¼ˆæ–°å¢å­—æ®µï¼‰
{
  "eventType": "UserCreated", 
  "eventVersion": "2.0",
  "userId": "12345",
  "profile": {
    "firstName": "ä¸‰",
    "lastName": "å¼ ", 
    "email": "zhangsan@example.com",
    "phone": "13800138000"
  }
}

é—®é¢˜ï¼šè€ç‰ˆæœ¬çš„æ¶ˆè´¹è€…å¦‚ä½•å¤„ç†æ–°ç‰ˆæœ¬äº‹ä»¶ï¼Ÿ
```

**ç‰ˆæœ¬å…¼å®¹ç­–ç•¥**ï¼š
```java
// äº‹ä»¶ç‰ˆæœ¬å¤„ç†å™¨
@Component
public class EventVersionHandler {
    
    @KafkaListener(topics = "user-events")
    public void handleUserEvent(String eventJson) {
        JsonNode eventNode = objectMapper.readTree(eventJson);
        String version = eventNode.get("eventVersion").asText("1.0");
        
        UserEvent event;
        switch (version) {
            case "1.0":
                event = handleV1Event(eventNode);
                break;
            case "2.0":
                event = handleV2Event(eventNode);
                break;
            default:
                throw new UnsupportedEventVersionException(version);
        }
        
        processUserEvent(event);
    }
    
    private UserEvent handleV1Event(JsonNode node) {
        // å°†V1æ ¼å¼è½¬æ¢ä¸ºå†…éƒ¨ç»Ÿä¸€æ ¼å¼
        return UserEvent.builder()
            .userId(node.get("userId").asText())
            .name(node.get("name").asText())
            .email(node.get("email").asText())
            .build();
    }
    
    private UserEvent handleV2Event(JsonNode node) {
        // å¤„ç†V2æ ¼å¼
        JsonNode profile = node.get("profile");
        String fullName = profile.get("lastName").asText() + 
                         profile.get("firstName").asText();
                         
        return UserEvent.builder()
            .userId(node.get("userId").asText())
            .name(fullName)
            .email(profile.get("email").asText())
            .phone(profile.get("phone").asText())
            .build();
    }
}
```

**å‘å‰å…¼å®¹è®¾è®¡**ï¼š
```java
// äº‹ä»¶æ¨¡å¼è®¾è®¡åŸåˆ™
public class EventSchemaDesign {
    
    // âœ… å¥½çš„è®¾è®¡ï¼šå‘å‰å…¼å®¹
    public class GoodUserEvent {
        private String userId;           // å¿…éœ€å­—æ®µï¼Œä¸èƒ½åˆ é™¤
        private String name;            // å¿…éœ€å­—æ®µï¼Œä¸èƒ½åˆ é™¤
        private String email;           // å¿…éœ€å­—æ®µï¼Œä¸èƒ½åˆ é™¤
        private String phone;           // å¯é€‰å­—æ®µï¼Œå¯ä»¥æ–°å¢
        private Map<String, Object> metadata; // æ‰©å±•å­—æ®µ
    }
    
    // âŒ åçš„è®¾è®¡ï¼šç ´åå…¼å®¹æ€§
    public class BadUserEvent {
        // private String userId;      // åˆ é™¤äº†å¿…éœ€å­—æ®µï¼
        private Long userIdNumeric;    // æ”¹å˜äº†å­—æ®µç±»å‹ï¼
        private UserProfile profile;  // æ”¹å˜äº†ç»“æ„ï¼
    }
}
```

## 6.3 äº‹ä»¶å­˜å‚¨ä¸å›æ”¾



**äº‹ä»¶å­˜å‚¨å®ç°**ï¼š
```java
@Component
public class EventStore {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    public void store(DomainEvent event) {
        // 1. åºåˆ—åŒ–äº‹ä»¶
        String eventJson = serialize(event);
        
        // 2. æ·»åŠ å…ƒæ•°æ®
        EventEnvelope envelope = EventEnvelope.builder()
            .eventId(UUID.randomUUID().toString())
            .eventType(event.getClass().getSimpleName())
            .eventVersion(event.getVersion())
            .timestamp(Instant.now())
            .data(eventJson)
            .build();
        
        // 3. å­˜å‚¨åˆ°Kafka
        String partitionKey = event.getAggregateId();
        kafkaTemplate.send("event-store", partitionKey, serialize(envelope));
    }
    
    public List<DomainEvent> getEvents(String aggregateId, long fromVersion) {
        // ä»Kafkaè¯»å–æŒ‡å®šèšåˆçš„æ‰€æœ‰äº‹ä»¶
        // å®é™…å®ç°éœ€è¦ä½¿ç”¨Kafka Consumer API
        return kafkaConsumer.getEventsForAggregate(aggregateId, fromVersion);
    }
}
```

---

# 7. ğŸ›¡ï¸ æ•…éšœå¤„ç†ä¸å®¹é”™æœºåˆ¶



## 7.1 å¸¸è§æ•…éšœåœºæ™¯



**æ¶ˆæ¯å¤„ç†å¤±è´¥**ï¼š
```
æ•…éšœç±»å‹åˆ†æï¼š

æš‚æ—¶æ€§æ•…éšœï¼š
- ç½‘ç»œæŠ–åŠ¨
- æœåŠ¡ä¸´æ—¶ä¸å¯ç”¨  
- æ•°æ®åº“è¿æ¥æ± æ»¡
å¤„ç†ç­–ç•¥ï¼šé‡è¯•

æ°¸ä¹…æ€§æ•…éšœï¼š
- æ¶ˆæ¯æ ¼å¼é”™è¯¯
- ä¸šåŠ¡è§„åˆ™è¿å
- é…ç½®é”™è¯¯
å¤„ç†ç­–ç•¥ï¼šæ­»ä¿¡é˜Ÿåˆ—

èµ„æºè€—å°½ï¼š
- å†…å­˜ä¸è¶³
- ç£ç›˜ç©ºé—´æ»¡
- CPUè¿‡è½½  
å¤„ç†ç­–ç•¥ï¼šé™æµ+é™çº§
```

## 7.2 é‡è¯•æœºåˆ¶è®¾è®¡



**æŒ‡æ•°é€€é¿é‡è¯•**ï¼š
```java
@Component
public class RetryableEventHandler {
    
    private static final int MAX_RETRIES = 5;
    private static final long INITIAL_DELAY = 1000; // 1ç§’
    
    @KafkaListener(topics = "order-events")
    public void handleOrderEvent(OrderEvent event) {
        processWithRetry(event, 0);
    }
    
    private void processWithRetry(OrderEvent event, int attemptCount) {
        try {
            orderService.processOrder(event);
            
        } catch (RetryableException e) {
            if (attemptCount < MAX_RETRIES) {
                long delay = INITIAL_DELAY * (long) Math.pow(2, attemptCount);
                
                // å»¶è¿Ÿé‡è¯•
                scheduleRetry(event, attemptCount + 1, delay);
            } else {
                // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                sendToDeadLetterQueue(event, e);
            }
            
        } catch (NonRetryableException e) {
            // ä¸å¯é‡è¯•å¼‚å¸¸ï¼Œç›´æ¥å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(event, e);
        }
    }
    
    private void scheduleRetry(OrderEvent event, int attemptCount, long delay) {
        CompletableFuture.delayedExecutor(delay, TimeUnit.MILLISECONDS)
            .execute(() -> processWithRetry(event, attemptCount));
    }
}
```

**æ­»ä¿¡é˜Ÿåˆ—å¤„ç†**ï¼š
```java
@Component
public class DeadLetterHandler {
    
    @KafkaListener(topics = "order-events-dlq")
    public void handleDeadLetter(ConsumerRecord<String, String> record) {
        // è®°å½•å¤±è´¥ä¿¡æ¯
        FailedEvent failedEvent = FailedEvent.builder()
            .originalTopic(record.topic())
            .partition(record.partition())
            .offset(record.offset())
            .key(record.key())
            .value(record.value())
            .failureTime(Instant.now())
            .build();
            
        failedEventRepository.save(failedEvent);
        
        // å‘é€å‘Šè­¦
        alertService.sendAlert("æ¶ˆæ¯å¤„ç†å¤±è´¥", failedEvent);
        
        // å¯é€‰ï¼šäººå·¥ä»‹å…¥å¤„ç†
        manualProcessingQueue.add(failedEvent);
    }
}
```

## 7.3 ç†”æ–­å™¨æ¨¡å¼



**ç†”æ–­å™¨å®ç°**ï¼š
```java
@Component
public class CircuitBreakerEventHandler {
    
    private final CircuitBreaker circuitBreaker;
    
    public CircuitBreakerEventHandler() {
        this.circuitBreaker = CircuitBreaker.ofDefaults("eventHandler");
        
        // é…ç½®ç†”æ–­å™¨
        circuitBreaker.getEventPublisher()
            .onStateTransition(event -> 
                log.info("ç†”æ–­å™¨çŠ¶æ€å˜æ›´: {}", event));
    }
    
    @KafkaListener(topics = "payment-events")
    public void handlePaymentEvent(PaymentEvent event) {
        Supplier<Void> decoratedSupplier = CircuitBreaker
            .decorateSupplier(circuitBreaker, () -> {
                paymentService.processPayment(event);
                return null;
            });
        
        try {
            decoratedSupplier.get();
        } catch (CallNotPermittedException e) {
            // ç†”æ–­å™¨æ‰“å¼€ï¼Œä½¿ç”¨é™çº§å¤„ç†
            handlePaymentEventFallback(event);
        }
    }
    
    private void handlePaymentEventFallback(PaymentEvent event) {
        // é™çº§å¤„ç†ï¼šå»¶è¿Ÿå¤„ç†æˆ–ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        delayedPaymentQueue.add(event);
        log.warn("æ”¯ä»˜æœåŠ¡ä¸å¯ç”¨ï¼Œäº‹ä»¶å·²åŠ å…¥å»¶è¿Ÿå¤„ç†é˜Ÿåˆ—: {}", event.getPaymentId());
    }
}
```

## 7.4 äº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼



**ç¡®ä¿æ¶ˆæ¯å¯é å‘é€**ï¼š
```java
@Entity
@Table(name = "outbox_events")
public class OutboxEvent {
    @Id
    private String id;
    private String aggregateId;
    private String eventType;
    private String eventData;
    private Instant createdAt;
    private boolean processed;
}

@Service
@Transactional
public class OrderService {
    
    public void createOrder(CreateOrderCommand command) {
        // 1. ä¸šåŠ¡é€»è¾‘å¤„ç†
        Order order = new Order(command);
        orderRepository.save(order);
        
        // 2. åœ¨åŒä¸€äº‹åŠ¡ä¸­ä¿å­˜äº‹ä»¶åˆ°å‘ä»¶ç®±
        OutboxEvent outboxEvent = OutboxEvent.builder()
            .id(UUID.randomUUID().toString())
            .aggregateId(order.getId())
            .eventType("OrderCreated")
            .eventData(serialize(new OrderCreatedEvent(order)))
            .createdAt(Instant.now())
            .processed(false)
            .build();
            
        outboxEventRepository.save(outboxEvent);
    }
}

// å®šæ—¶ä»»åŠ¡å‘é€å‘ä»¶ç®±ä¸­çš„äº‹ä»¶
@Component
public class OutboxEventPublisher {
    
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void publishOutboxEvents() {
        List<OutboxEvent> unpublishedEvents = 
            outboxEventRepository.findByProcessedFalse();
            
        for (OutboxEvent event : unpublishedEvents) {
            try {
                kafkaTemplate.send("order-events", 
                    event.getAggregateId(), event.getEventData());
                
                // æ ‡è®°ä¸ºå·²å¤„ç†
                event.setProcessed(true);
                outboxEventRepository.save(event);
                
            } catch (Exception e) {
                log.error("å‘é€äº‹ä»¶å¤±è´¥: {}", event.getId(), e);
            }
        }
    }
}
```

---

# 8. ğŸ¬ ç»¼åˆå®æˆ˜æ¡ˆä¾‹



## 8.1 ç”µå•†å¹³å°ä¸‹å•æµç¨‹



**ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·åœ¨ç”µå•†å¹³å°ä¸‹å•è´­ä¹°å•†å“

**æ¶‰åŠæœåŠ¡**ï¼š
- ç”¨æˆ·æœåŠ¡ï¼ˆUser Serviceï¼‰
- å•†å“æœåŠ¡ï¼ˆProduct Serviceï¼‰  
- è®¢å•æœåŠ¡ï¼ˆOrder Serviceï¼‰
- åº“å­˜æœåŠ¡ï¼ˆInventory Serviceï¼‰
- æ”¯ä»˜æœåŠ¡ï¼ˆPayment Serviceï¼‰
- é€šçŸ¥æœåŠ¡ï¼ˆNotification Serviceï¼‰

## 8.2 äº‹ä»¶æµç¨‹è®¾è®¡



**å®Œæ•´äº‹ä»¶æµ**ï¼š
```
äº‹ä»¶æµç¨‹å›¾ï¼š

ç”¨æˆ·ä¸‹å•
   â†“
è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å• â†’ å‘å¸ƒ OrderCreated äº‹ä»¶
   â†“
åº“å­˜æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ æ£€æŸ¥åº“å­˜ â†’ é¢„æ‰£åº“å­˜ â†’ å‘å¸ƒ InventoryReserved äº‹ä»¶
   â†“  
æ”¯ä»˜æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ æ‰§è¡Œæ”¯ä»˜ â†’ å‘å¸ƒ PaymentCompleted äº‹ä»¶
   â†“
è®¢å•æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ ç¡®è®¤è®¢å• â†’ å‘å¸ƒ OrderConfirmed äº‹ä»¶
   â†“
åº“å­˜æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ ç¡®è®¤æ‰£å‡ â†’ å‘å¸ƒ InventoryDeducted äº‹ä»¶
   â†“
é€šçŸ¥æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ å‘é€ç¡®è®¤é‚®ä»¶

å¼‚å¸¸å¤„ç†ï¼š
å¦‚æœæ”¯ä»˜å¤±è´¥ â†’ å‘å¸ƒ PaymentFailed äº‹ä»¶
   â†“
åº“å­˜æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ é‡Šæ”¾é¢„æ‰£åº“å­˜
   â†“  
è®¢å•æœåŠ¡ï¼šç›‘å¬äº‹ä»¶ â†’ å–æ¶ˆè®¢å•
```

## 8.3 å…·ä½“å®ç°ä»£ç 



**è®¢å•æœåŠ¡å®ç°**ï¼š
```java
@RestController
public class OrderController {
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResponse> createOrder(@RequestBody CreateOrderRequest request) {
        
        // åˆ›å»ºè®¢å•
        Order order = Order.builder()
            .id(UUID.randomUUID().toString())
            .userId(request.getUserId())
            .products(request.getProducts())
            .totalAmount(calculateTotal(request.getProducts()))
            .status(OrderStatus.PENDING)
            .createdAt(Instant.now())
            .build();
            
        orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = OrderCreatedEvent.builder()
            .orderId(order.getId())
            .userId(order.getUserId())
            .products(order.getProducts())
            .totalAmount(order.getTotalAmount())
            .timestamp(Instant.now())
            .build();
            
        eventPublisher.publish("order-events", event);
        
        return ResponseEntity.ok(OrderResponse.from(order));
    }
}

@Component
public class OrderEventHandler {
    
    // å¤„ç†æ”¯ä»˜å®Œæˆäº‹ä»¶
    @KafkaListener(topics = "payment-events", 
                   groupId = "order-service")
    public void handlePaymentCompleted(PaymentCompletedEvent event) {
        String orderId = event.getOrderId();
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        Order order = orderRepository.findById(orderId);
        order.setStatus(OrderStatus.CONFIRMED);
        order.setConfirmedAt(Instant.now());
        orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•ç¡®è®¤äº‹ä»¶
        OrderConfirmedEvent confirmedEvent = OrderConfirmedEvent.builder()
            .orderId(orderId)
            .userId(order.getUserId())
            .confirmedAt(Instant.now())
            .build();
            
        eventPublisher.publish("order-events", confirmedEvent);
    }
    
    // å¤„ç†æ”¯ä»˜å¤±è´¥äº‹ä»¶
    @KafkaListener(topics = "payment-events",
                   groupId = "order-service")
    public void handlePaymentFailed(PaymentFailedEvent event) {
        String orderId = event.getOrderId();
        
        // å–æ¶ˆè®¢å•
        Order order = orderRepository.findById(orderId);
        order.setStatus(OrderStatus.CANCELLED);
        order.setCancelledAt(Instant.now());
        order.setCancelReason("æ”¯ä»˜å¤±è´¥");
        orderRepository.save(order);
        
        // å‘å¸ƒè®¢å•å–æ¶ˆäº‹ä»¶
        OrderCancelledEvent cancelledEvent = OrderCancelledEvent.builder()
            .orderId(orderId)
            .reason("æ”¯ä»˜å¤±è´¥")
            .cancelledAt(Instant.now())
            .build();
            
        eventPublisher.publish("order-events", cancelledEvent);
    }
}
```

**åº“å­˜æœåŠ¡å®ç°**ï¼š
```java
@Component
public class InventoryEventHandler {
    
    // å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶
    @KafkaListener(topics = "order-events",
                   groupId = "inventory-service")
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // æ£€æŸ¥å’Œé¢„æ‰£åº“å­˜
            for (OrderProduct product : event.getProducts()) {
                Inventory inventory = inventoryRepository.findByProductId(product.getProductId());
                
                if (inventory.getAvailableQuantity() < product.getQuantity()) {
                    // åº“å­˜ä¸è¶³
                    publishInventoryInsufficientEvent(event, product);
                    return;
                }
                
                // é¢„æ‰£åº“å­˜
                inventory.reserveQuantity(product.getQuantity());
                inventoryRepository.save(inventory);
            }
            
            // å‘å¸ƒåº“å­˜é¢„æ‰£æˆåŠŸäº‹ä»¶
            InventoryReservedEvent reservedEvent = InventoryReservedEvent.builder()
                .orderId(event.getOrderId())
                .products(event.getProducts())
                .reservedAt(Instant.now())
                .build();
                
            eventPublisher.publish("inventory-events", reservedEvent);
            
        } catch (Exception e) {
            // å‘å¸ƒåº“å­˜å¤„ç†å¤±è´¥äº‹ä»¶
            publishInventoryProcessFailedEvent(event, e.getMessage());
        }
    }
    
    // å¤„ç†è®¢å•ç¡®è®¤äº‹ä»¶
    @KafkaListener(topics = "order-events",
                   groupId = "inventory-service")
    public void handleOrderConfirmed(OrderConfirmedEvent event) {
        // ç¡®è®¤æ‰£å‡åº“å­˜ï¼ˆå°†é¢„æ‰£è½¬ä¸ºå®é™…æ‰£å‡ï¼‰
        confirmInventoryDeduction(event.getOrderId());
        
        InventoryDeductedEvent deductedEvent = InventoryDeductedEvent.builder()
            .orderId(event.getOrderId())
            .deductedAt(Instant.now())
            .build();
            
        eventPublisher.publish("inventory-events", deductedEvent);
    }
    
    // å¤„ç†è®¢å•å–æ¶ˆäº‹ä»¶
    @KafkaListener(topics = "order-events",
                   groupId = "inventory-service")  
    public void handleOrderCancelled(OrderCancelledEvent event) {
        // é‡Šæ”¾é¢„æ‰£åº“å­˜
        releaseReservedInventory(event.getOrderId());
        
        InventoryReleasedEvent releasedEvent = InventoryReleasedEvent.builder()
            .orderId(event.getOrderId())
            .releasedAt(Instant.now())
            .build();
            
        eventPublisher.publish("inventory-events", releasedEvent);
    }
}
```

**æ”¯ä»˜æœåŠ¡å®ç°**ï¼š
```java
@Component  
public class PaymentEventHandler {
    
    @KafkaListener(topics = "inventory-events",
                   groupId = "payment-service")
    public void handleInventoryReserved(InventoryReservedEvent event) {
        String orderId = event.getOrderId();
        
        try {
            // è·å–è®¢å•ä¿¡æ¯
            Order order = orderService.getOrder(orderId);
            
            // æ‰§è¡Œæ”¯ä»˜
            PaymentResult result = paymentGateway.processPayment(
                order.getUserId(),
                order.getTotalAmount(),
                order.getId()
            );
            
            if (result.isSuccess()) {
                // æ”¯ä»˜æˆåŠŸ
                PaymentCompletedEvent completedEvent = PaymentCompletedEvent.builder()
                    .orderId(orderId)
                    .paymentId(result.getPaymentId())
                    .amount(order.getTotalAmount())
                    .paidAt(Instant.now())
                    .build();
                    
                eventPublisher.publish("payment-events", completedEvent);
                
            } else {
                // æ”¯ä»˜å¤±è´¥
                PaymentFailedEvent failedEvent = PaymentFailedEvent.builder()
                    .orderId(orderId)
                    .reason(result.getFailureReason())
                    .failedAt(Instant.now())
                    .build();
                    
                eventPublisher.publish("payment-events", failedEvent);
            }
            
        } catch (Exception e) {
            // æ”¯ä»˜å¼‚å¸¸
            PaymentFailedEvent failedEvent = PaymentFailedEvent.builder()
                .orderId(orderId)
                .reason("æ”¯ä»˜ç³»ç»Ÿå¼‚å¸¸: " + e.getMessage())
                .failedAt(Instant.now())
                .build();
                
            eventPublisher.publish("payment-events", failedEvent);
        }
    }
}
```

## 8.4 ç›‘æ§å’Œå¯è§‚æµ‹æ€§



**äº‹ä»¶è¿½è¸ªå®ç°**ï¼š
```java
@Component
public class EventTracker {
    
    // ä¸ºæ¯ä¸ªäº‹ä»¶æ·»åŠ è¿½è¸ªID
    @EventListener
    public void trackEvent(DomainEvent event) {
        EventTrace trace = EventTrace.builder()
            .traceId(getOrCreateTraceId())
            .eventId(event.getEventId())
            .eventType(event.getEventType())
            .service(getCurrentServiceName())
            .timestamp(Instant.now())
            .build();
            
        eventTraceRepository.save(trace);
    }
    
    private String getOrCreateTraceId() {
        // ä»MDCè·å–ç°æœ‰trace IDï¼Œæˆ–åˆ›å»ºæ–°çš„
        String traceId = MDC.get("traceId");
        if (traceId == null) {
            traceId = UUID.randomUUID().toString();
            MDC.put("traceId", traceId);
        }
        return traceId;
    }
}

// äº‹ä»¶å¤„ç†æ€§èƒ½ç›‘æ§
@Component
public class EventMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter eventProcessedCounter;
    private final Timer eventProcessingTimer;
    
    public EventMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.eventProcessedCounter = Counter.builder("events.processed")
            .register(meterRegistry);
        this.eventProcessingTimer = Timer.builder("events.processing.duration")
            .register(meterRegistry);
    }
    
    @EventListener
    public void recordEventProcessed(EventProcessedEvent event) {
        eventProcessedCounter.increment(
            Tags.of(
                "eventType", event.getEventType(),
                "service", event.getServiceName(),
                "success", String.valueOf(event.isSuccess())
            )
        );
    }
    
    public <T> T timeEventProcessing(String eventType, Supplier<T> operation) {
        return eventProcessingTimer.recordCallable(
            Tags.of("eventType", eventType), 
            operation::get
        );
    }
}
```

---

# 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼šé€šè¿‡äº‹ä»¶å®ç°æœåŠ¡é—´å¼‚æ­¥é€šä¿¡å’Œè§£è€¦
ğŸ”¸ äº‹ä»¶æº¯æºï¼šé€šè¿‡å­˜å‚¨äº‹ä»¶åºåˆ—é‡å»ºç³»ç»ŸçŠ¶æ€
ğŸ”¸ CQRSï¼šåˆ†ç¦»å‘½ä»¤å’ŒæŸ¥è¯¢èŒè´£ï¼Œä¼˜åŒ–è¯»å†™æ€§èƒ½
ğŸ”¸ Sagaæ¨¡å¼ï¼šé€šè¿‡åè°ƒå¤šä¸ªæœ¬åœ°äº‹åŠ¡å®ç°åˆ†å¸ƒå¼äº‹åŠ¡
ğŸ”¸ æœåŠ¡è§£è€¦ï¼šé™ä½æœåŠ¡é—´ä¾èµ–ï¼Œæé«˜ç³»ç»Ÿå¼¹æ€§
ğŸ”¸ æ¶ˆæ¯è·¯ç”±ï¼šæ ¹æ®è§„åˆ™å°†äº‹ä»¶åˆ†å‘åˆ°æ­£ç¡®çš„æ¶ˆè´¹è€…
ğŸ”¸ ç‰ˆæœ¬ç®¡ç†ï¼šå¤„ç†äº‹ä»¶ç»“æ„æ¼”åŒ–çš„å…¼å®¹æ€§é—®é¢˜
ğŸ”¸ æ•…éšœå¤„ç†ï¼šé€šè¿‡é‡è¯•ã€ç†”æ–­ã€é™çº§ä¿è¯ç³»ç»Ÿç¨³å®šæ€§
```

## 9.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©äº‹ä»¶é©±åŠ¨æ¶æ„**
```
ä¼ ç»Ÿé—®é¢˜ï¼š
- æœåŠ¡é—´å¼ºè€¦åˆï¼Œéš¾ä»¥ç‹¬ç«‹æ¼”åŒ–
- åŒæ­¥è°ƒç”¨é“¾è·¯é•¿ï¼Œæ€§èƒ½ç“¶é¢ˆæ˜æ˜¾
- å•ç‚¹æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ

äº‹ä»¶é©±åŠ¨ä¼˜åŠ¿ï¼š
- æ¾è€¦åˆï¼šæœåŠ¡ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- é«˜æ€§èƒ½ï¼šå¼‚æ­¥å¤„ç†ï¼Œæé«˜ååé‡
- å¼¹æ€§ï¼šæ•…éšœéš”ç¦»ï¼Œå±€éƒ¨æ•…éšœä¸å½±å“å…¨å±€
- å¯æ‰©å±•ï¼šå®¹æ˜“æ–°å¢åŠŸèƒ½å’ŒæœåŠ¡
```

**ğŸ”¹ ä½•æ—¶ä½¿ç”¨ä¸åŒçš„æ¨¡å¼**
```
äº‹ä»¶æº¯æºé€‚ç”¨åœºæ™¯ï¼š
âœ… éœ€è¦å®¡è®¡å’Œå†å²æŸ¥è¯¢
âœ… å¤æ‚çš„ä¸šåŠ¡è§„åˆ™å’ŒçŠ¶æ€å˜åŒ–
âœ… éœ€è¦æ”¯æŒ"æ—¶é—´æ—…è¡Œ"åŠŸèƒ½

CQRSé€‚ç”¨åœºæ™¯ï¼š
âœ… è¯»å†™è´Ÿè½½å·®å¼‚å¾ˆå¤§
âœ… éœ€è¦å¤šç§æŸ¥è¯¢è§†å›¾
âœ… è¯»å†™æ“ä½œå¤æ‚åº¦ä¸åŒ

Sagaé€‚ç”¨åœºæ™¯ï¼š
âœ… è·¨å¤šä¸ªæœåŠ¡çš„ä¸šåŠ¡æµç¨‹
âœ… éœ€è¦ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
âœ… ä¸èƒ½ä½¿ç”¨ä¼ ç»Ÿåˆ†å¸ƒå¼äº‹åŠ¡
```

**ğŸ”¹ è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ**
```
äº‹ä»¶è®¾è®¡åŸåˆ™ï¼š
1. äº‹ä»¶è¡¨è¾¾ä¸šåŠ¡å«ä¹‰ï¼Œä¸æ˜¯æŠ€æœ¯å®ç°
2. äº‹ä»¶ä¸å¯å˜ï¼ŒåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
3. ä¿æŒå‘å‰å…¼å®¹ï¼Œè°¨æ…å˜æ›´äº‹ä»¶ç»“æ„
4. ä½¿ç”¨æ ‡å‡†æ ¼å¼ï¼Œä¾¿äºè·¨æœåŠ¡ç†è§£

æ¶æ„è®¾è®¡åŸåˆ™ï¼š
1. å•ä¸€èŒè´£ï¼šæ¯ä¸ªæœåŠ¡åªå…³å¿ƒè‡ªå·±çš„ä¸šåŠ¡
2. å¤±è´¥éš”ç¦»ï¼šé¿å…çº§è”æ•…éšœ
3. å¹‚ç­‰æ€§ï¼šé‡å¤å¤„ç†åŒä¸€äº‹ä»¶ä¸äº§ç”Ÿå‰¯ä½œç”¨
4. å¯è§‚æµ‹æ€§ï¼šå®Œå–„çš„ç›‘æ§å’Œè¿½è¸ªæœºåˆ¶
```

## 9.3 å®é™…åº”ç”¨ä»·å€¼



**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- ğŸ“± **ç”µå•†å¹³å°**ï¼šè®¢å•å¤„ç†ã€åº“å­˜ç®¡ç†ã€æ”¯ä»˜æµç¨‹
- ğŸ¦ **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“å¤„ç†ã€é£æ§æ£€æŸ¥ã€è´¦åŠ¡è®°å½•
- ğŸ“§ **é€šä¿¡å¹³å°**ï¼šæ¶ˆæ¯æŠ•é€’ã€çŠ¶æ€åŒæ­¥ã€é€šçŸ¥æ¨é€
- ğŸ® **æ¸¸æˆç³»ç»Ÿ**ï¼šç©å®¶è¡Œä¸ºã€ç§¯åˆ†ç³»ç»Ÿã€ç¤¾äº¤åŠŸèƒ½

**æ¶æ„æ¼”è¿›è·¯å¾„**ï¼š
- ğŸ¯ **èµ·æ­¥é˜¶æ®µ**ï¼šç®€å•çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼
- ğŸ¯ **æˆé•¿é˜¶æ®µ**ï¼šå¼•å…¥äº‹ä»¶æº¯æºå’ŒCQRS
- ğŸ¯ **æˆç†Ÿé˜¶æ®µ**ï¼šå®Œæ•´çš„Sagaå’Œæ•…éšœå¤„ç†æœºåˆ¶
- ğŸ¯ **ä¼˜åŒ–é˜¶æ®µ**ï¼šæ€§èƒ½è°ƒä¼˜å’Œå¯è§‚æµ‹æ€§å¢å¼º

## 9.4 é¿å…å¸¸è§é™·é˜±



**âš ï¸ è®¾è®¡é™·é˜±**
```
è¿‡åº¦è®¾è®¡ï¼š
âŒ ç®€å•åœºæ™¯ä¸éœ€è¦å¤æ‚çš„äº‹ä»¶é©±åŠ¨æ¶æ„
âœ… æ ¹æ®å®é™…å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æ¨¡å¼

äº‹ä»¶çˆ†ç‚¸ï¼š
âŒ ä¸ºæ¯ä¸ªç»†å¾®å˜åŒ–éƒ½åˆ›å»ºäº‹ä»¶
âœ… å…³æ³¨æœ‰ä¸šåŠ¡æ„ä¹‰çš„é‡è¦äº‹ä»¶

å¼ºä¸€è‡´æ€§å¹»è§‰ï¼š
âŒ æœŸæœ›äº‹ä»¶é©±åŠ¨æ¶æ„æä¾›å¼ºä¸€è‡´æ€§
âœ… æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Œè®¾è®¡è¡¥å¿æœºåˆ¶
```

**ğŸ”§ å®ç°é™·é˜±**
```
å¿½ç•¥å¼‚å¸¸å¤„ç†ï¼š
âŒ åªå…³æ³¨æ­£å¸¸æµç¨‹ï¼Œå¿½ç•¥å¼‚å¸¸æƒ…å†µ
âœ… å®Œå–„çš„é‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—ã€ç›‘æ§å‘Šè­¦

äº‹ä»¶ç‰ˆæœ¬ç®¡ç†ï¼š
âŒ éšæ„ä¿®æ”¹äº‹ä»¶ç»“æ„
âœ… ä¿æŒå‘å‰å…¼å®¹ï¼Œæ¸è¿›å¼æ¼”åŒ–

æ€§èƒ½è€ƒè™‘ï¼š
âŒ å¿½ç•¥æ¶ˆæ¯ç§¯å‹å’Œå¤„ç†å»¶è¿Ÿ
âœ… åˆç†è®¾è®¡åˆ†åŒºç­–ç•¥å’Œæ¶ˆè´¹è€…æ‰©å±•
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- äº‹ä»¶é©±åŠ¨é‡è§£è€¦ï¼Œå¼‚æ­¥æ¶ˆæ¯ææ€§èƒ½
- æº¯æºæ¨¡å¼å­˜å†å²ï¼ŒCQRSåˆ†ç¦»è¯»å†™ç«¯  
- Sagaåè°ƒåˆ†å¸ƒå¼ï¼Œè¡¥å¿æœºåˆ¶ä¿ä¸€è‡´
- ç‰ˆæœ¬å…¼å®¹è¦è°¨æ…ï¼Œæ•…éšœå¤„ç†éœ€å®Œå–„
- ç›‘æ§è¿½è¸ªä¸å¯å°‘ï¼Œæ¸è¿›æ¼”åŒ–æ˜¯å…³é”®