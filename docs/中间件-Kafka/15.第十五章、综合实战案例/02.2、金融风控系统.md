---
title: 2ã€é‡‘èé£æ§ç³»ç»Ÿ
---
## ğŸ“š ç›®å½•

1. [é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°](#1-é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°)
2. [å®æ—¶é£æ§éœ€æ±‚åˆ†æ](#2-å®æ—¶é£æ§éœ€æ±‚åˆ†æ)
3. [Kafkaé«˜å¯ç”¨æ¶æ„è®¾è®¡](#3-Kafkaé«˜å¯ç”¨æ¶æ„è®¾è®¡)
4. [ä½å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥](#4-ä½å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥)
5. [æ•°æ®å®‰å…¨ä¸åˆè§„è¦æ±‚](#5-æ•°æ®å®‰å…¨ä¸åˆè§„è¦æ±‚)
6. [å¼‚åœ°å®¹ç¾æ–¹æ¡ˆ](#6-å¼‚åœ°å®¹ç¾æ–¹æ¡ˆ)
7. [å‹åŠ›æµ‹è¯•ä¸æ€§èƒ½è°ƒä¼˜](#7-å‹åŠ›æµ‹è¯•ä¸æ€§èƒ½è°ƒä¼˜)
8. [åº”æ€¥é¢„æ¡ˆä¸æ•…éšœå¤„ç†](#8-åº”æ€¥é¢„æ¡ˆä¸æ•…éšœå¤„ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¦ é‡‘èé£æ§ç³»ç»Ÿæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é‡‘èé£æ§ç³»ç»Ÿ


> ğŸ’¡ **é€šä¿—ç†è§£**  
> é‡‘èé£æ§ç³»ç»Ÿå°±åƒé“¶è¡Œçš„"æ™ºèƒ½ä¿å®‰"ï¼Œå®æ—¶ç›‘æ§æ¯ä¸€ç¬”äº¤æ˜“ï¼Œå¿«é€Ÿè¯†åˆ«å¯ç–‘è¡Œä¸ºï¼Œé˜²æ­¢èµ„é‡‘æŸå¤±

**ğŸ¯ æ ¸å¿ƒä½œç”¨**
```
å®æ—¶ç›‘æ§ï¼šåƒç›‘æ§æ‘„åƒå¤´ä¸€æ ·ï¼Œ24å°æ—¶ä¸é—´æ–­ç›‘è§†
å¿«é€Ÿè¯†åˆ«ï¼šåƒç»éªŒä¸°å¯Œçš„è­¦å¯Ÿï¼Œç¬é—´å‘ç°å¼‚å¸¸è¡Œä¸º  
è‡ªåŠ¨å¤„ç†ï¼šåƒæ™ºèƒ½ç³»ç»Ÿï¼Œè‡ªåŠ¨æ‹¦æˆªå¯ç–‘äº¤æ˜“
é£é™©é¢„è­¦ï¼šåƒå¤©æ°”é¢„æŠ¥ï¼Œæå‰é¢„çŸ¥æ½œåœ¨é£é™©
```

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©Kafka


**ğŸ” é‡‘èä¸šåŠ¡ç‰¹ç‚¹**
- **äº¤æ˜“é‡å·¨å¤§**ï¼šæ¯ç§’æ•°ä¸‡ç¬”äº¤æ˜“éœ€è¦å¤„ç†
- **å»¶è¿Ÿè¦æ±‚æä½**ï¼šæ¯«ç§’çº§å“åº”ï¼Œå¦åˆ™ç”¨æˆ·ä½“éªŒå·®
- **æ•°æ®ä¸èƒ½ä¸¢**ï¼šä¸€ç¬”äº¤æ˜“éƒ½ä¸èƒ½é—æ¼ï¼Œå…³ç³»åˆ°èµ„é‡‘å®‰å…¨
- **éœ€è¦è¿½æº¯**ï¼šå‡ºé—®é¢˜è¦èƒ½å›æŸ¥å†å²æ•°æ®

**âœ… Kafkaçš„ä¼˜åŠ¿åŒ¹é…**
```
é«˜ååé‡ â¡ï¸ å¤„ç†æµ·é‡äº¤æ˜“æ•°æ®
ä½å»¶è¿Ÿ â¡ï¸ æ¯«ç§’çº§å®æ—¶é£æ§
æŒä¹…åŒ– â¡ï¸ æ•°æ®æ°¸ä¸ä¸¢å¤±  
åˆ†åŒºæœºåˆ¶ â¡ï¸ æ°´å¹³æ‰©å±•èƒ½åŠ›
```

### 1.3 å…¸å‹ä¸šåŠ¡åœºæ™¯


**ğŸ’³ ä¿¡ç”¨å¡æ¬ºè¯ˆæ£€æµ‹**
```
åœºæ™¯æè¿°ï¼š
å°æ˜çš„ä¿¡ç”¨å¡åœ¨åŒ—äº¬åˆ·å¡ä¹°å’–å•¡
1åˆ†é’Ÿååœ¨ä¸Šæµ·åˆ·å¡ä¹°å¥¢ä¾ˆå“
ç³»ç»Ÿåˆ¤æ–­ï¼šç‰©ç†ä¸Šä¸å¯èƒ½ï¼Œå¯èƒ½è¢«ç›—åˆ·
å¤„ç†ï¼šç«‹å³å†»ç»“å¡ç‰‡ï¼Œå‘é€é¢„è­¦çŸ­ä¿¡
```

**ğŸ  è´·æ¬¾å®¡æ‰¹é£æ§**
```
åœºæ™¯æè¿°ï¼š  
ç”¨æˆ·ç”³è¯·æˆ¿è´·ï¼Œç³»ç»Ÿå®æ—¶åˆ†æï¼š
- æ”¶å…¥ç¨³å®šæ€§
- å¾ä¿¡è®°å½•
- è´Ÿå€ºæ¯”ä¾‹
- è¡Œä¸šé£é™©
å¤„ç†ï¼šç§’çº§ç»™å‡ºå®¡æ‰¹å»ºè®®
```

---

## 2. âš¡ å®æ—¶é£æ§éœ€æ±‚åˆ†æ


### 2.1 ä¸šåŠ¡éœ€æ±‚æ¢³ç†


**ğŸ“Š å…³é”®æŒ‡æ ‡è¦æ±‚**

| æŒ‡æ ‡ç±»å‹ | **å…·ä½“è¦æ±‚** | **ä¸šåŠ¡å½±å“** | **æŠ€æœ¯æŒ‘æˆ˜** |
|---------|-------------|-------------|-------------|
| ğŸš€ **å“åº”æ—¶é—´** | `< 100ms` | `ç”¨æˆ·ä½“éªŒï¼Œäº¤æ˜“æˆåŠŸç‡` | `ç½‘ç»œå»¶è¿Ÿï¼Œè®¡ç®—å¤æ‚åº¦` |
| ğŸ“ˆ **ååé‡** | `10ä¸‡TPS+` | `æ”¯æ’‘ä¸šåŠ¡è§„æ¨¡` | `ç³»ç»Ÿç“¶é¢ˆï¼Œèµ„æºæ¶ˆè€—` |
| ğŸ›¡ï¸ **å¯ç”¨æ€§** | `99.99%` | `ä¸šåŠ¡è¿ç»­æ€§` | `å®¹é”™è®¾è®¡ï¼Œæ•…éšœæ¢å¤` |
| ğŸ“ **æ•°æ®å‡†ç¡®æ€§** | `100%` | `ç›‘ç®¡åˆè§„ï¼Œé£é™©æ§åˆ¶` | `æ•°æ®ä¸€è‡´æ€§ï¼Œå¹¶å‘å¤„ç†` |

### 2.2 æ•°æ®æµç‰¹å¾åˆ†æ


**ğŸ”„ æ•°æ®æµå‘å›¾ç¤º**
```
ç”¨æˆ·äº¤æ˜“ â”€â”€â”
          â”œâ”€â”€> Kafkaé›†ç¾¤ â”€â”€> é£æ§å¼•æ“ â”€â”€> å†³ç­–ç»“æœ
å¤–éƒ¨æ•°æ® â”€â”€â”˜                    â†“
                              é£é™©æ•°æ®åº“
                                â†“  
                            ç›‘ç®¡æŠ¥é€ç³»ç»Ÿ
```

**ğŸ“‹ æ•°æ®ç±»å‹åˆ†æ**
```
ğŸ”¸ äº¤æ˜“æ•°æ®
â€¢ é‡‘é¢ã€æ—¶é—´ã€åœ°ç‚¹ã€å•†æˆ·
â€¢ ç”¨æˆ·è®¾å¤‡ä¿¡æ¯ã€IPåœ°å€
â€¢ æ”¯ä»˜æ–¹å¼ã€æ¸ é“æ¥æº

ğŸ”¸ ç”¨æˆ·ç”»åƒæ•°æ®  
â€¢ å†å²è¡Œä¸ºæ¨¡å¼
â€¢ å¾ä¿¡è®°å½•ã€èµ„äº§çŠ¶å†µ
â€¢ ç¤¾äº¤å…³ç³»å›¾è°±

ğŸ”¸ å¤–éƒ¨é£é™©æ•°æ®
â€¢ é»‘åå•ã€ç™½åå•
â€¢ è¡Œä¸šé£é™©è¯„çº§
â€¢ å®è§‚ç»æµæŒ‡æ ‡
```

### 2.3 å®æ—¶æ€§è¦æ±‚åˆ†çº§


**â° ä¸åŒåœºæ™¯çš„æ—¶å»¶è¦æ±‚**

```markdown
ğŸ”¥ **è¶…å®æ—¶åœºæ™¯** (< 50ms)
- ä¿¡ç”¨å¡åˆ·å¡éªŒè¯
- ç§»åŠ¨æ”¯ä»˜ç¡®è®¤
- ATMå–æ¬¾éªŒè¯

â­ **å‡†å®æ—¶åœºæ™¯** (< 200ms)  
- è´·æ¬¾ç”³è¯·åˆå®¡
- æŠ•èµ„é£é™©è¯„ä¼°
- è´¦æˆ·å¼‚å¸¸ç›‘æ§

ğŸ’« **è¿‘å®æ—¶åœºæ™¯** (< 1s)
- åæ´—é’±ç›‘æ§
- åˆè§„æŠ¥å‘Šç”Ÿæˆ
- é£é™©è¶‹åŠ¿åˆ†æ
```

---

## 3. ğŸ—ï¸ Kafkaé«˜å¯ç”¨æ¶æ„è®¾è®¡


### 3.1 æ•´ä½“æ¶æ„è®¾è®¡


**ğŸŒŸ ä¸‰åœ°äº”ä¸­å¿ƒæ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‘èé£æ§ç³»ç»Ÿæ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸»ç”Ÿäº§ä¸­å¿ƒ     â”‚    åŒåŸç¾å¤‡     â”‚      å¼‚åœ°ç¾å¤‡        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ Kafka     â”‚  â”‚  â”‚ Kafka     â”‚  â”‚   â”‚ Kafka        â”‚ â”‚
â”‚   â”‚ é›†ç¾¤ A    â”‚â—„â”€â”¼â”€â–ºâ”‚ é›†ç¾¤ B    â”‚  â”‚   â”‚ é›†ç¾¤ C       â”‚ â”‚
â”‚   â”‚ (ä¸»)      â”‚  â”‚  â”‚ (å¤‡)      â”‚  â”‚   â”‚ (ç¾å¤‡)       â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â–²         â”‚        â–²        â”‚          â–²         â”‚
â”‚        â”‚         â”‚        â”‚        â”‚          â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”‚     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”‚
â”‚   â”‚é£æ§å¼•æ“ â”‚    â”‚   â”‚é£æ§å¼•æ“ â”‚   â”‚     â”‚é£æ§å¼•æ“ â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Kafkaé›†ç¾¤é…ç½®


**ğŸ”§ æ ¸å¿ƒé…ç½®å‚æ•°**

```properties
# é«˜å¯ç”¨åŸºç¡€é…ç½®
# æ•°æ®ä¸ä¸¢å¤±ä¿éšœ
replication.factor=3                    # æ¯ä¸ªåˆ†åŒº3ä¸ªå‰¯æœ¬
min.in.sync.replicas=2                 # è‡³å°‘2ä¸ªå‰¯æœ¬åŒæ­¥
acks=all                              # ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤

# æ€§èƒ½ä¼˜åŒ–é…ç½®  
num.network.threads=8                  # ç½‘ç»œçº¿ç¨‹æ•°
num.io.threads=16                     # IOçº¿ç¨‹æ•°
socket.send.buffer.bytes=102400       # Socketå‘é€ç¼“å†²åŒº
socket.receive.buffer.bytes=102400    # Socketæ¥æ”¶ç¼“å†²åŒº

# æ—¥å¿—é…ç½®
log.retention.hours=168               # ä¿ç•™7å¤©æ•°æ®
log.segment.bytes=1073741824         # 1GBåˆ†æ®µå¤§å°
log.cleanup.policy=delete            # åˆ é™¤è¿‡æœŸæ•°æ®
```

### 3.3 åˆ†åŒºç­–ç•¥è®¾è®¡


**ğŸ“ æŒ‰ä¸šåŠ¡ç»´åº¦åˆ†åŒº**

```java
// è‡ªå®šä¹‰åˆ†åŒºå™¨ - æŒ‰ç”¨æˆ·IDåˆ†åŒº
public class UserIdPartitioner implements Partitioner {
    
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        // è§£æç”¨æˆ·ID
        String userId = (String) key;
        
        // æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†åŒºï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·çš„äº¤æ˜“åœ¨åŒä¸€åˆ†åŒº
        return Math.abs(userId.hashCode()) % cluster.partitionCountForTopic(topic);
    }
}
```

**ğŸ’¡ åˆ†åŒºè®¾è®¡åŸåˆ™**
```
ğŸ¯ ä¸šåŠ¡éš”ç¦»
- VIPç”¨æˆ·ç‹¬ç«‹åˆ†åŒºï¼Œä¼˜å…ˆå¤„ç†
- ä¸åŒäº§å“çº¿åˆ†åˆ«åˆ†åŒº
- é«˜é£é™©äº¤æ˜“å•ç‹¬åˆ†åŒº

âš–ï¸ è´Ÿè½½å‡è¡¡  
- é¿å…çƒ­ç‚¹åˆ†åŒº
- å‡åŒ€åˆ†å¸ƒæ•°æ®
- è€ƒè™‘æ—¶é—´å› ç´ ï¼ˆå·¥ä½œæ—¶é—´vséå·¥ä½œæ—¶é—´ï¼‰

ğŸ”„ æ‰©å±•æ€§
- é¢„ç•™è¶³å¤Ÿåˆ†åŒºæ•°
- æ”¯æŒåŠ¨æ€è°ƒæ•´
- ä¾¿äºæ°´å¹³æ‰©å±•
```

### 3.4 é«˜å¯ç”¨ä¿éšœæœºåˆ¶


**ğŸ›¡ï¸ æ•…éšœè‡ªåŠ¨åˆ‡æ¢**

```yaml
# Zookeeperé…ç½® - é›†ç¾¤ç®¡ç†
zookeeper:
  servers:
    - zk1.bank.com:2181
    - zk2.bank.com:2181  
    - zk3.bank.com:2181
  session.timeout: 6000
  connection.timeout: 6000

# Kafka Controlleré…ç½®
controller:
  election.enable: true          # å¯ç”¨Controlleré€‰ä¸¾
  shutdown.enable: true          # ä¼˜é›…å…³é—­
```

**ğŸ“‹ ç›‘æ§å‘Šè­¦é…ç½®**
```
ğŸ” å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- é›†ç¾¤çŠ¶æ€ï¼šLeaderåˆ†å¸ƒã€ISRçŠ¶æ€
- æ€§èƒ½æŒ‡æ ‡ï¼šååé‡ã€å»¶è¿Ÿã€å †ç§¯
- èµ„æºç›‘æ§ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- ä¸šåŠ¡ç›‘æ§ï¼šæ¶ˆæ¯ä¸¢å¤±ã€é‡å¤æ¶ˆè´¹

âš ï¸ å‘Šè­¦ç­–ç•¥ï¼š
- æ•…éšœå‘Šè­¦ï¼šé›†ç¾¤ä¸å¯ç”¨ã€åˆ†åŒºå¼‚å¸¸
- æ€§èƒ½å‘Šè­¦ï¼šå»¶è¿Ÿè¶…é˜ˆå€¼ã€å †ç§¯ä¸¥é‡  
- èµ„æºå‘Šè­¦ï¼šç£ç›˜ç©ºé—´ä¸è¶³ã€å†…å­˜æ³„æ¼
- ä¸šåŠ¡å‘Šè­¦ï¼šé£æ§è§„åˆ™å¤±æ•ˆã€æ•°æ®å¼‚å¸¸
```

---

## 4. ğŸš€ ä½å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥


### 4.1 ç½‘ç»œå±‚ä¼˜åŒ–


**âš¡ ç½‘ç»œå‚æ•°è°ƒä¼˜**

```bash
# Linuxå†…æ ¸ç½‘ç»œå‚æ•°ä¼˜åŒ–
# TCPè¿æ¥ä¼˜åŒ–
echo 'net.core.rmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 87380 134217728' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_wmem = 4096 65536 134217728' >> /etc/sysctl.conf

# å‡å°‘TIME_WAITçŠ¶æ€
echo 'net.ipv4.tcp_tw_reuse = 1' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_fin_timeout = 30' >> /etc/sysctl.conf

# åº”ç”¨é…ç½®
sysctl -p
```

### 4.2 Producerä¼˜åŒ–ç­–ç•¥


**âš¡ æ‰¹å¤„ç†ä¸å¼‚æ­¥å‘é€**

```java
public class HighPerformanceProducer {
    
    private KafkaProducer<String, String> producer;
    
    public void initProducer() {
        Properties props = new Properties();
        
        // åŸºç¡€è¿æ¥é…ç½®
        props.put("bootstrap.servers", "kafka1:9092,kafka2:9092");
        props.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        props.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");
        
        // ğŸš€ ä½å»¶è¿Ÿä¼˜åŒ–é…ç½®
        props.put("linger.ms", 1);                    // æ‰¹å¤„ç†ç­‰å¾…æ—¶é—´1ms
        props.put("batch.size", 16384);               // æ‰¹æ¬¡å¤§å°16KB
        props.put("buffer.memory", 33554432);         // å‘é€ç¼“å†²åŒº32MB
        props.put("compression.type", "lz4");         // ä½¿ç”¨LZ4å‹ç¼©
        
        // ğŸ”¥ å¯é æ€§é…ç½®ï¼ˆé‡‘èçº§åˆ«ï¼‰
        props.put("acks", "all");                     // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
        props.put("retries", 3);                      // é‡è¯•3æ¬¡
        props.put("max.in.flight.requests.per.connection", 1); // ä¿è¯é¡ºåº
        
        producer = new KafkaProducer<>(props);
    }
    
    // å¼‚æ­¥å‘é€ - æé«˜ååé‡
    public void sendAsync(String topic, String key, String value) {
        ProducerRecord<String, String> record = 
            new ProducerRecord<>(topic, key, value);
            
        producer.send(record, (metadata, exception) -> {
            if (exception != null) {
                // å‘é€å¤±è´¥å¤„ç†
                handleSendFailure(key, value, exception);
            } else {
                // å‘é€æˆåŠŸè®°å½•
                recordSendSuccess(metadata);
            }
        });
    }
}
```

### 4.3 Consumerä¼˜åŒ–ç­–ç•¥


**âš¡ å¹¶è¡Œæ¶ˆè´¹ä¸å†…å­˜ç®¡ç†**

```java
public class HighPerformanceConsumer {
    
    private KafkaConsumer<String, String> consumer;
    private ExecutorService executorService;
    
    public void initConsumer() {
        Properties props = new Properties();
        props.put("bootstrap.servers", "kafka1:9092,kafka2:9092");
        props.put("group.id", "risk-control-group");
        
        // ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®
        props.put("fetch.min.bytes", 1024);          // æœ€å°æ‹‰å–1KB
        props.put("fetch.max.wait.ms", 10);          // æœ€å¤§ç­‰å¾…10ms
        props.put("max.poll.records", 1000);         // æ¯æ¬¡æ‹‰å–1000æ¡
        props.put("receive.buffer.bytes", 262144);   // æ¥æ”¶ç¼“å†²åŒº256KB
        
        // ğŸ”§ å¯é æ€§é…ç½®
        props.put("enable.auto.commit", false);      // æ‰‹åŠ¨æäº¤offset
        props.put("auto.offset.reset", "earliest");  // ä»æœ€æ—©å¼€å§‹æ¶ˆè´¹
        
        consumer = new KafkaConsumer<>(props);
        
        // åˆ›å»ºçº¿ç¨‹æ± å¤„ç†æ¶ˆæ¯
        executorService = Executors.newFixedThreadPool(10);
    }
    
    public void startConsume() {
        consumer.subscribe(Arrays.asList("transaction-topic"));
        
        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(10));
            
            if (!records.isEmpty()) {
                // ğŸ”„ å¹¶è¡Œå¤„ç†æ¶ˆæ¯
                List<Future<Boolean>> futures = new ArrayList<>();
                
                for (ConsumerRecord<String, String> record : records) {
                    Future<Boolean> future = executorService.submit(() -> {
                        return processRiskCheck(record);
                    });
                    futures.add(future);
                }
                
                // ç­‰å¾…æ‰€æœ‰æ¶ˆæ¯å¤„ç†å®Œæˆ
                waitForCompletion(futures);
                
                // ğŸ”’ æ‰‹åŠ¨æäº¤offset
                consumer.commitSync();
            }
        }
    }
}
```

### 4.4 JVMè°ƒä¼˜


**âš¡ åƒåœ¾å›æ”¶ä¼˜åŒ–**

```bash
# KafkaæœåŠ¡å™¨JVMå‚æ•°
export KAFKA_HEAP_OPTS="-Xmx6g -Xms6g"
export KAFKA_JVM_PERFORMANCE_OPTS="
-server
-XX:+UseG1GC                    # ä½¿ç”¨G1åƒåœ¾å›æ”¶å™¨
-XX:MaxGCPauseMillis=20         # æœ€å¤§GCæš‚åœæ—¶é—´20ms
-XX:InitiatingHeapOccupancyPercent=35  # GCè§¦å‘é˜ˆå€¼
-XX:+ExplicitGCInvokesConcurrent      # å¹¶å‘GC
-XX:MaxInlineLevel=15                 # å†…è”ä¼˜åŒ–
-XX:+UseLargePages                    # ä½¿ç”¨å¤§é¡µå†…å­˜
-Djava.awt.headless=true             # æ— å¤´æ¨¡å¼
"
```

**ğŸ’¡ å†…å­˜åˆ†é…å»ºè®®**
```
ğŸ”¸ å †å†…å­˜è®¾ç½®ï¼š
- ç”Ÿäº§ç¯å¢ƒï¼š6-8GB
- é¿å…è¶…è¿‡32GBï¼ˆå‹ç¼©æŒ‡é’ˆå¤±æ•ˆï¼‰
- æ–°ç”Ÿä»£ï¼šå †å†…å­˜çš„1/4åˆ°1/3

ğŸ”¸ å †å¤–å†…å­˜ï¼š
- page cacheï¼šå‰©ä½™å†…å­˜çš„50-60%
- ç”¨äºç¼“å­˜æ—¥å¿—æ–‡ä»¶
- å‡å°‘ç£ç›˜IO

ğŸ”¸ ç›‘æ§æŒ‡æ ‡ï¼š
- GCé¢‘ç‡å’Œæ—¶é—´
- å†…å­˜ä½¿ç”¨ç‡
- å¯¹è±¡åˆ†é…é€Ÿç‡
```

---

## 5. ğŸ”’ æ•°æ®å®‰å…¨ä¸åˆè§„è¦æ±‚


### 5.1 æ•°æ®åŠ å¯†ç­–ç•¥


**ğŸ›¡ï¸ ä¼ è¾“åŠ å¯†é…ç½®**

```properties
# SSL/TLSé…ç½®
security.protocol=SSL
ssl.keystore.location=/path/to/kafka.server.keystore.jks
ssl.keystore.password=password
ssl.key.password=password  
ssl.truststore.location=/path/to/kafka.server.truststore.jks
ssl.truststore.password=password

# å®¢æˆ·ç«¯è®¤è¯
ssl.client.auth=required
ssl.enabled.protocols=TLSv1.2,TLSv1.3
ssl.cipher.suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
```

**ğŸ” æ•°æ®è„±æ•å¤„ç†**

```java
public class DataMaskingUtil {
    
    // æ‰‹æœºå·è„±æ•ï¼š138****5678
    public static String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // èº«ä»½è¯è„±æ•ï¼š110***********1234
    public static String maskIdCard(String idCard) {
        if (idCard == null || idCard.length() != 18) {
            return idCard;
        }
        return idCard.substring(0, 3) + "***********" + idCard.substring(14);
    }
    
    // é“¶è¡Œå¡è„±æ•ï¼š6225****1234
    public static String maskBankCard(String cardNo) {
        if (cardNo == null || cardNo.length() < 8) {
            return cardNo;
        }
        return cardNo.substring(0, 4) + "****" + cardNo.substring(cardNo.length() - 4);
    }
}
```

### 5.2 è®¿é—®æƒé™æ§åˆ¶


**ğŸ”‘ SASLè®¤è¯é…ç½®**

```properties
# SASL_PLAINTEXTé…ç½®
security.protocol=SASL_PLAINTEXT
sasl.mechanism=SCRAM-SHA-256
sasl.enabled.mechanisms=SCRAM-SHA-256

# è¶…çº§ç”¨æˆ·é…ç½®
super.users=User:admin,User:system

# ACLæƒé™æ§åˆ¶
authorizer.class.name=kafka.security.authorizer.AclAuthorizer
allow.everyone.if.no.acl.found=false
```

**ğŸ‘¥ æƒé™åˆ†çº§è®¾è®¡**
```
ğŸ”¸ ç®¡ç†å‘˜æƒé™ (admin)
- é›†ç¾¤ç®¡ç†ï¼šåˆ›å»º/åˆ é™¤Topic
- ç”¨æˆ·ç®¡ç†ï¼šåˆ›å»º/åˆ é™¤ç”¨æˆ·
- é…ç½®ç®¡ç†ï¼šä¿®æ”¹é›†ç¾¤é…ç½®

ğŸ”¸ åº”ç”¨æƒé™ (application)  
- å†™å…¥æƒé™ï¼šç‰¹å®šTopicçš„Produceræƒé™
- è¯»å–æƒé™ï¼šç‰¹å®šTopicçš„Consumeræƒé™
- ç¾¤ç»„æƒé™ï¼šæ¶ˆè´¹è€…ç»„ç®¡ç†æƒé™

ğŸ”¸ åªè¯»æƒé™ (readonly)
- ç›‘æ§æƒé™ï¼šæŸ¥çœ‹é›†ç¾¤çŠ¶æ€
- å®¡è®¡æƒé™ï¼šæŸ¥çœ‹æ“ä½œæ—¥å¿—
- æ— å†™å…¥æƒé™
```

### 5.3 å®¡è®¡æ—¥å¿—


**ğŸ“ æ“ä½œå®¡è®¡é…ç½®**

```java
@Component
public class KafkaAuditLog {
    
    private final Logger auditLogger = LoggerFactory.getLogger("audit");
    
    // è®°å½•æ¶ˆæ¯å‘é€å®¡è®¡
    public void logProducerAction(String userId, String topic, 
                                 String messageId, String action) {
        AuditEvent event = AuditEvent.builder()
            .timestamp(System.currentTimeMillis())
            .userId(userId)
            .action(action)
            .resource("topic:" + topic)
            .messageId(messageId)
            .ipAddress(getClientIP())
            .build();
            
        auditLogger.info("PRODUCER_AUDIT: {}", 
                        JSON.toJSONString(event));
    }
    
    // è®°å½•æ¶ˆæ¯æ¶ˆè´¹å®¡è®¡
    public void logConsumerAction(String groupId, String topic,
                                int partition, long offset) {
        AuditEvent event = AuditEvent.builder()
            .timestamp(System.currentTimeMillis())
            .groupId(groupId)
            .action("CONSUME")
            .resource("topic:" + topic + ",partition:" + partition)
            .offset(offset)
            .build();
            
        auditLogger.info("CONSUMER_AUDIT: {}", 
                        JSON.toJSONString(event));
    }
}
```

---

## 6. ğŸŒ å¼‚åœ°å®¹ç¾æ–¹æ¡ˆ


### 6.1 è·¨åœ°åŸŸå¤åˆ¶æ¶æ„


**ğŸ”„ MirrorMaker 2.0 é…ç½®**

```properties
# é›†ç¾¤è¿æ¥é…ç½®
clusters = beijing, shanghai
beijing.bootstrap.servers = bj-kafka1:9092,bj-kafka2:9092
shanghai.bootstrap.servers = sh-kafka1:9092,sh-kafka2:9092

# å¤åˆ¶æµé…ç½®
beijing->shanghai.enabled = true
beijing->shanghai.topics = transaction-topic,risk-topic
beijing->shanghai.groups = risk-control-group

# å¤åˆ¶ç­–ç•¥
replication.policy.class = org.apache.kafka.connect.mirror.DefaultReplicationPolicy
replication.policy.separator = .

# æ€§èƒ½é…ç½®
beijing->shanghai.producer.batch.size = 16384
beijing->shanghai.producer.linger.ms = 5
beijing->shanghai.consumer.max.poll.records = 1000
```

### 6.2 æ•…éšœåˆ‡æ¢ç­–ç•¥


**âš¡ è‡ªåŠ¨æ•…éšœæ£€æµ‹**

```java
@Component
public class DisasterRecoveryManager {
    
    private final MeterRegistry meterRegistry;
    private final AlertService alertService;
    
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void healthCheck() {
        // æ£€æŸ¥ä¸»é›†ç¾¤å¥åº·çŠ¶æ€
        HealthStatus primaryStatus = checkClusterHealth("beijing");
        HealthStatus backupStatus = checkClusterHealth("shanghai");
        
        if (primaryStatus == HealthStatus.DOWN && 
            backupStatus == HealthStatus.UP) {
            // ä¸»é›†ç¾¤æ•…éšœï¼Œè§¦å‘åˆ‡æ¢
            triggerFailover();
        }
    }
    
    private void triggerFailover() {
        try {
            // 1. åœæ­¢ä¸»é›†ç¾¤çš„ç”Ÿäº§è€…
            stopProducers("beijing");
            
            // 2. åˆ‡æ¢åˆ°å¤‡ç”¨é›†ç¾¤
            switchToBackupCluster("shanghai");
            
            // 3. é€šçŸ¥ç›¸å…³ç³»ç»Ÿ
            notifySystemsOfFailover();
            
            // 4. è®°å½•åˆ‡æ¢æ—¥å¿—
            logFailoverEvent();
            
        } catch (Exception e) {
            alertService.sendCriticalAlert("æ•…éšœåˆ‡æ¢å¤±è´¥", e.getMessage());
        }
    }
}
```

### 6.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


**ğŸ”„ ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶**

```bash
#!/bin/bash
# æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬

# æ¯”è¾ƒä¸¤ä¸ªé›†ç¾¤çš„Topicå…ƒæ•°æ®
check_topic_consistency() {
    local primary_cluster=$1
    local backup_cluster=$2
    
    echo "æ£€æŸ¥Topicä¸€è‡´æ€§..."
    
    # è·å–ä¸»é›†ç¾¤Topicåˆ—è¡¨
    primary_topics=$(kafka-topics.sh --bootstrap-server $primary_cluster --list)
    
    # è·å–å¤‡ä»½é›†ç¾¤Topicåˆ—è¡¨  
    backup_topics=$(kafka-topics.sh --bootstrap-server $backup_cluster --list)
    
    # æ¯”è¾ƒTopicåˆ—è¡¨
    diff <(echo "$primary_topics" | sort) <(echo "$backup_topics" | sort)
    
    if [ $? -eq 0 ]; then
        echo "âœ… Topicåˆ—è¡¨ä¸€è‡´"
    else
        echo "âŒ Topicåˆ—è¡¨ä¸ä¸€è‡´ï¼Œéœ€è¦åŒæ­¥"
    fi
}

# æ£€æŸ¥æ¶ˆæ¯åç§»é‡
check_offset_consistency() {
    local topic=$1
    
    echo "æ£€æŸ¥åç§»é‡ä¸€è‡´æ€§: $topic"
    
    # è·å–ä¸»é›†ç¾¤åç§»é‡
    primary_offsets=$(kafka-run-class.sh kafka.tools.GetOffsetShell \
        --broker-list $PRIMARY_CLUSTER --topic $topic)
    
    # è·å–å¤‡ä»½é›†ç¾¤åç§»é‡
    backup_offsets=$(kafka-run-class.sh kafka.tools.GetOffsetShell \
        --broker-list $BACKUP_CLUSTER --topic $topic)
    
    echo "ä¸»é›†ç¾¤åç§»é‡: $primary_offsets"
    echo "å¤‡ä»½é›†ç¾¤åç§»é‡: $backup_offsets"
}
```

---

## 7. ğŸ“Š å‹åŠ›æµ‹è¯•ä¸æ€§èƒ½è°ƒä¼˜


### 7.1 å‹åŠ›æµ‹è¯•è®¾è®¡


**ğŸ¯ æµ‹è¯•åœºæ™¯è®¾è®¡**

```yaml
# æµ‹è¯•åœºæ™¯é…ç½®
test_scenarios:
  
  # åœºæ™¯1ï¼šæ­£å¸¸ä¸šåŠ¡è´Ÿè½½
  normal_load:
    producers: 10
    messages_per_second: 50000
    message_size: 1KB
    duration: 30åˆ†é’Ÿ
    
  # åœºæ™¯2ï¼šå³°å€¼è´Ÿè½½æµ‹è¯•
  peak_load:
    producers: 50  
    messages_per_second: 200000
    message_size: 2KB
    duration: 10åˆ†é’Ÿ
    
  # åœºæ™¯3ï¼šå¼‚å¸¸æ¢å¤æµ‹è¯•
  failure_recovery:
    initial_load: 100000 msg/s
    failure_simulation: èŠ‚ç‚¹æ•…éšœ
    recovery_time: ç›®æ ‡<30ç§’
    
  # åœºæ™¯4ï¼šæŒä¹…åŒ–å‹åŠ›æµ‹è¯•
  endurance_test:
    producers: 20
    messages_per_second: 80000
    duration: 24å°æ—¶
    disk_usage_limit: 80%
```

### 7.2 æ€§èƒ½æµ‹è¯•å·¥å…·


**ğŸ› ï¸ Kafkaè‡ªå¸¦å‹æµ‹å·¥å…·**

```bash
# Produceræ€§èƒ½æµ‹è¯•
kafka-producer-perf-test.sh \
  --topic transaction-topic \
  --num-records 1000000 \
  --record-size 1024 \
  --throughput 50000 \
  --producer-props bootstrap.servers=kafka1:9092,kafka2:9092 \
                   acks=all \
                   linger.ms=5 \
                   batch.size=16384

# Consumeræ€§èƒ½æµ‹è¯•  
kafka-consumer-perf-test.sh \
  --topic transaction-topic \
  --messages 1000000 \
  --threads 10 \
  --bootstrap-server kafka1:9092,kafka2:9092

# è¾“å‡ºç¤ºä¾‹
# start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.messages
# messages.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec
```

### 7.3 æ€§èƒ½è°ƒä¼˜å®è·µ


**âš¡ ç³»ç»Ÿçº§è°ƒä¼˜**

```bash
# ç£ç›˜IOä¼˜åŒ–
echo mq-deadline > /sys/block/sda/queue/scheduler  # ä½¿ç”¨mq-deadlineè°ƒåº¦å™¨
echo 4096 > /sys/block/sda/queue/read_ahead_kb     # å¢åŠ é¢„è¯»ç¼“å­˜

# ç½‘ç»œä¼˜åŒ–
echo 'net.core.netdev_max_backlog = 5000' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_congestion_control = bbr' >> /etc/sysctl.conf

# æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo 'kafka soft nofile 65536' >> /etc/security/limits.conf
echo 'kafka hard nofile 65536' >> /etc/security/limits.conf
```

**ğŸ“ˆ æ€§èƒ½ç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **å…³é”®æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| ğŸš€ **ååé‡** | `æ¶ˆæ¯/ç§’` | `50K-100K` | `< 30K` |
| â±ï¸ **å»¶è¿Ÿ** | `ç«¯åˆ°ç«¯å»¶è¿Ÿ` | `< 50ms` | `> 100ms` |
| ğŸ’¾ **å­˜å‚¨** | `ç£ç›˜ä½¿ç”¨ç‡` | `< 70%` | `> 80%` |
| ğŸ”— **ç½‘ç»œ** | `ç½‘ç»œåˆ©ç”¨ç‡` | `< 60%` | `> 80%` |
| ğŸ§  **å†…å­˜** | `å †å†…å­˜ä½¿ç”¨` | `< 80%` | `> 90%` |

---

## 8. ğŸš¨ åº”æ€¥é¢„æ¡ˆä¸æ•…éšœå¤„ç†


### 8.1 æ•…éšœåˆ†ç±»ä¸å“åº”çº§åˆ«


**ğŸš© æ•…éšœç­‰çº§å®šä¹‰**

```markdown
ğŸ”´ **P0 - è‡´å‘½æ•…éšœ**
æ•…éšœå½±å“ï¼šæ ¸å¿ƒä¸šåŠ¡å®Œå…¨ä¸­æ–­
å“åº”æ—¶é—´ï¼š5åˆ†é’Ÿå†…å“åº”
æ¢å¤ç›®æ ‡ï¼š30åˆ†é’Ÿå†…æ¢å¤
å…¸å‹åœºæ™¯ï¼šé›†ç¾¤å®Œå…¨ä¸å¯ç”¨ã€æ•°æ®å¤§é‡ä¸¢å¤±

ğŸŸ¡ **P1 - ä¸¥é‡æ•…éšœ**  
æ•…éšœå½±å“ï¼šæ ¸å¿ƒåŠŸèƒ½éƒ¨åˆ†å—æŸ
å“åº”æ—¶é—´ï¼š15åˆ†é’Ÿå†…å“åº”
æ¢å¤ç›®æ ‡ï¼š2å°æ—¶å†…æ¢å¤
å…¸å‹åœºæ™¯ï¼šæ€§èƒ½ä¸¥é‡ä¸‹é™ã€éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœ

ğŸŸ¢ **P2 - ä¸€èˆ¬æ•…éšœ**
æ•…éšœå½±å“ï¼šéæ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸
å“åº”æ—¶é—´ï¼š1å°æ—¶å†…å“åº”  
æ¢å¤ç›®æ ‡ï¼š1ä¸ªå·¥ä½œæ—¥å†…æ¢å¤
å…¸å‹åœºæ™¯ï¼šç›‘æ§å‘Šè­¦ã€é…ç½®å¼‚å¸¸
```

### 8.2 å¸¸è§æ•…éšœå¤„ç†æ‰‹å†Œ


**ğŸ’¾ ç£ç›˜ç©ºé—´ä¸è¶³å¤„ç†**

```bash
#!/bin/bash
# ç£ç›˜ç©ºé—´ç´§æ€¥æ¸…ç†è„šæœ¬

# 1. æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h /kafka/logs

# 2. æŸ¥æ‰¾æœ€å¤§çš„æ—¥å¿—æ–‡ä»¶
du -sh /kafka/logs/* | sort -hr | head -10

# 3. æ¸…ç†è¿‡æœŸæ—¥å¿—ï¼ˆè°¨æ…æ“ä½œï¼‰
find /kafka/logs -name "*.log" -mtime +7 -exec rm {} \;

# 4. å‹ç¼©å†å²æ—¥å¿—
find /kafka/logs -name "*.log" -mtime +3 -exec gzip {} \;

# 5. è°ƒæ•´æ—¥å¿—ä¿ç•™ç­–ç•¥
kafka-configs.sh --bootstrap-server localhost:9092 \
  --entity-type topics --entity-name transaction-topic \
  --alter --add-config retention.ms=604800000  # 7å¤©

echo "âœ… ç£ç›˜æ¸…ç†å®Œæˆï¼Œå½“å‰ä½¿ç”¨ç‡ï¼š"
df -h /kafka/logs | awk 'NR==2{print $5}'
```

**ğŸ”— ç½‘ç»œåˆ†åŒºå¤„ç†**

```java
@Component  
public class NetworkPartitionHandler {
    
    @EventListener
    public void handlePartitionEvent(PartitionEvent event) {
        log.warn("æ£€æµ‹åˆ°ç½‘ç»œåˆ†åŒº: {}", event.getPartitionInfo());
        
        // 1. æš‚åœè‡ªåŠ¨æäº¤
        pauseAutoCommit();
        
        // 2. åˆ‡æ¢åˆ°æ‰‹åŠ¨æäº¤æ¨¡å¼
        switchToManualCommit();
        
        // 3. å¯ç”¨å¹‚ç­‰æ€§æ£€æŸ¥
        enableIdempotenceCheck();
        
        // 4. é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿé™çº§
        notifyBusinessDegradation();
    }
    
    private void handleBrainSplit() {
        // è„‘è£‚å¤„ç†ç­–ç•¥
        if (isMinorityPartition()) {
            // å¦‚æœæ˜¯å°‘æ•°æ´¾åˆ†åŒºï¼Œåœæ­¢å†™å…¥
            stopWriteOperations();
            enterReadOnlyMode();
        } else {
            // å¦‚æœæ˜¯å¤šæ•°æ´¾åˆ†åŒºï¼Œç»§ç»­æœåŠ¡
            continueNormalOperation();
            increaseReplicationFactor();
        }
    }
}
```

### 8.3 æ•°æ®æ¢å¤ç­–ç•¥


**ğŸ’½ å¤‡ä»½æ¢å¤æµç¨‹**

```bash
#!/bin/bash
# Kafkaæ•°æ®æ¢å¤è„šæœ¬

# 1. åœæ­¢KafkaæœåŠ¡
systemctl stop kafka

# 2. å¤‡ä»½å½“å‰æŸåçš„æ•°æ®
cp -r /kafka/logs /kafka/logs.backup.$(date +%Y%m%d_%H%M%S)

# 3. ä»å¤‡ä»½æ¢å¤æ•°æ®
restore_from_backup() {
    local backup_path=$1
    local target_path="/kafka/logs"
    
    echo "ä»å¤‡ä»½æ¢å¤æ•°æ®: $backup_path -> $target_path"
    
    # æ¸…ç©ºç›®æ ‡ç›®å½•
    rm -rf $target_path/*
    
    # æ¢å¤æ•°æ®
    cp -r $backup_path/* $target_path/
    
    # ä¿®æ­£æƒé™
    chown -R kafka:kafka $target_path
    chmod -R 755 $target_path
}

# 4. éªŒè¯æ•°æ®å®Œæ•´æ€§
verify_data_integrity() {
    echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."
    
    # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶æ ¼å¼
    kafka-dump-log.sh --files /kafka/logs/transaction-topic-0/*.log \
                     --verify-index-only
    
    if [ $? -eq 0 ]; then
        echo "âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        return 0
    else
        echo "âŒ æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥"
        return 1
    fi
}

# 5. é‡å¯æœåŠ¡
restart_kafka_cluster() {
    echo "é‡å¯Kafkaé›†ç¾¤..."
    systemctl start kafka
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 30
    
    # éªŒè¯é›†ç¾¤çŠ¶æ€
    kafka-broker-api-versions.sh --bootstrap-server localhost:9092
}
```

### 8.4 åº”æ€¥é¢„æ¡ˆæ¼”ç»ƒ


**ğŸ­ æ•…éšœæ¼”ç»ƒè®¡åˆ’**

```yaml
# åº”æ€¥æ¼”ç»ƒè®¡åˆ’
drill_scenarios:
  
  # åœºæ™¯1ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ¼”ç»ƒ
  leader_failure_drill:
    frequency: æœˆåº¦
    procedure:
      - éšæœºé€‰æ‹©LeaderèŠ‚ç‚¹
      - æ¨¡æ‹ŸèŠ‚ç‚¹ä¸‹çº¿
      - è§‚å¯Ÿé‡æ–°é€‰ä¸¾è¿‡ç¨‹
      - éªŒè¯ä¸šåŠ¡è¿ç»­æ€§
      - è®°å½•æ¢å¤æ—¶é—´
    
  # åœºæ™¯2ï¼šç½‘ç»œåˆ†åŒºæ¼”ç»ƒ  
  network_partition_drill:
    frequency: å­£åº¦
    procedure:
      - ä½¿ç”¨iptablesæ¨¡æ‹Ÿç½‘ç»œåˆ†åŒº
      - è§‚å¯Ÿè„‘è£‚å¤„ç†
      - éªŒè¯æ•°æ®ä¸€è‡´æ€§
      - æµ‹è¯•è‡ªåŠ¨æ¢å¤æœºåˆ¶
      
  # åœºæ™¯3ï¼šæ•°æ®ä¸­å¿ƒæ•…éšœæ¼”ç»ƒ
  datacenter_failure_drill:
    frequency: åŠå¹´åº¦
    procedure:
      - æ¨¡æ‹Ÿæ•´ä¸ªæ•°æ®ä¸­å¿ƒä¸‹çº¿
      - å¯åŠ¨å¼‚åœ°å®¹ç¾åˆ‡æ¢
      - éªŒè¯RTO/RPOæŒ‡æ ‡
      - æµ‹è¯•æ•°æ®åŒæ­¥æ¢å¤
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 æ¶æ„è®¾è®¡è¦ç‚¹


> ğŸ—ï¸ **æ€»ä½“åŸåˆ™**  
> é‡‘èé£æ§ç³»ç»Ÿçš„Kafkaæ¶æ„å¿…é¡»ä»¥**å®‰å…¨æ€§**å’Œ**å¯é æ€§**ä¸ºç¬¬ä¸€ä¼˜å…ˆçº§ï¼Œæ€§èƒ½ä¼˜åŒ–åœ¨ä¿éšœå®‰å…¨çš„å‰æä¸‹è¿›è¡Œ

**ğŸ”‘ å…³é”®è®¾è®¡å†³ç­–**
```
âœ… ä¸‰åœ°äº”ä¸­å¿ƒï¼šä¿éšœä¸šåŠ¡è¿ç»­æ€§
âœ… å¤šå‰¯æœ¬æœºåˆ¶ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
âœ… åŠ å¯†ä¼ è¾“ï¼šä¿æŠ¤æ•æ„Ÿæ•°æ®
âœ… æƒé™æ§åˆ¶ï¼šåˆ†çº§è®¿é—®ç®¡ç†
âœ… å®æ—¶ç›‘æ§ï¼šåŠæ—¶å‘ç°é—®é¢˜
```

### 9.2 æ€§èƒ½ä¼˜åŒ–ç²¾å


**âš¡ ä½å»¶è¿Ÿä¼˜åŒ–æ ¸å¿ƒ**
```
ğŸ¯ ç½‘ç»œå±‚ï¼šè°ƒä¼˜TCPå‚æ•°ï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ
ğŸ¯ åº”ç”¨å±‚ï¼šæ‰¹å¤„ç†+å¼‚æ­¥ï¼Œæé«˜ååé‡
ğŸ¯ å­˜å‚¨å±‚ï¼šSSD+é¡µé¢ç¼“å­˜ï¼ŒåŠ é€ŸIO
ğŸ¯ JVMå±‚ï¼šG1GC+å¤§é¡µå†…å­˜ï¼Œå‡å°‘åœé¡¿
ğŸ¯ ä¸šåŠ¡å±‚ï¼šåˆ†åŒºç­–ç•¥+å¹¶è¡Œå¤„ç†ï¼Œè´Ÿè½½å‡è¡¡
```

### 9.3 è¿ç»´ç®¡ç†è¦ç‚¹


**ğŸ›¡ï¸ å®‰å…¨åˆè§„è¦æ±‚**
```
ğŸ”’ æ•°æ®åŠ å¯†ï¼šä¼ è¾“åŠ å¯†+å­˜å‚¨åŠ å¯†
ğŸ”’ è®¿é—®æ§åˆ¶ï¼šSASLè®¤è¯+ACLæˆæƒ
ğŸ”’ å®¡è®¡æ—¥å¿—ï¼šå®Œæ•´è®°å½•+å®šæœŸåˆ†æ
ğŸ”’ æ•°æ®è„±æ•ï¼šæ•æ„Ÿä¿¡æ¯+å­—æ®µè„±æ•
ğŸ”’ åˆè§„æŠ¥é€ï¼šç›‘ç®¡è¦æ±‚+è‡ªåŠ¨åŒ–æŠ¥å‘Š
```

### 9.4 æ•…éšœå¤„ç†æ–¹æ³•è®º


**ğŸš¨ åº”æ€¥å“åº”æµç¨‹**
```
1ï¸âƒ£ å¿«é€Ÿè¯Šæ–­ï¼šç›‘æ§å‘Šè­¦+æ—¥å¿—åˆ†æ
2ï¸âƒ£ å½±å“è¯„ä¼°ï¼šä¸šåŠ¡å½±å“+ç”¨æˆ·æ„ŸçŸ¥
3ï¸âƒ£ åº”æ€¥å¤„ç†ï¼šæ­¢æŸä¼˜å…ˆ+æ¢å¤æœåŠ¡  
4ï¸âƒ£ æ ¹å› åˆ†æï¼šæ·±åº¦è°ƒæŸ¥+é—®é¢˜å®šä½
5ï¸âƒ£ æŒç»­æ”¹è¿›ï¼šæµç¨‹ä¼˜åŒ–+é¢„é˜²æªæ–½
```

### 9.5 æœ€ä½³å®è·µæ€»ç»“


**ğŸ’¡ é‡‘èçº§Kafkaè¿ç»´ç²¾é«“**

```markdown
ğŸ¯ **è®¾è®¡é˜¶æ®µ**
- å®¹é‡è§„åˆ’ï¼šæŒ‰3å€å³°å€¼è´Ÿè½½è®¾è®¡
- æ¶æ„è®¾è®¡ï¼šå¼‚åœ°å¤šæ´»+è‡ªåŠ¨åˆ‡æ¢
- å®‰å…¨è®¾è®¡ï¼šçºµæ·±é˜²å¾¡+æœ€å°æƒé™

âš¡ **å®æ–½é˜¶æ®µ**  
- æ¸è¿›éƒ¨ç½²ï¼šç°åº¦å‘å¸ƒ+åˆ†æ‰¹ä¸Šçº¿
- å‹åŠ›æµ‹è¯•ï¼šå…¨é“¾è·¯+çœŸå®è´Ÿè½½
- ç›‘æ§å®Œå–„ï¼šæŒ‡æ ‡å…¨é¢+å‘Šè­¦åŠæ—¶

ğŸ›¡ï¸ **è¿ç»´é˜¶æ®µ**
- é¢„é˜²ä¸ºä¸»ï¼šå·¡æ£€åˆ¶åº¦+é¢„è­¦æœºåˆ¶
- å¿«é€Ÿå“åº”ï¼šåº”æ€¥é¢„æ¡ˆ+æ¼”ç»ƒéªŒè¯
- æŒç»­ä¼˜åŒ–ï¼šæ€§èƒ½è°ƒä¼˜+æ¶æ„æ¼”è¿›
```

**ğŸ§  æ ¸å¿ƒè®°å¿†**
- é‡‘èé£æ§Kafkaï¼Œå®‰å…¨å¯é æ˜¯æ ¹æœ¬
- ä½å»¶è¿Ÿé«˜å¯ç”¨ï¼Œä¸‰åœ°äº”ä¸­å¿ƒä¿å¹³å®‰
- å®æ—¶ç›‘æ§åŠ å‘Šè­¦ï¼Œæ•…éšœå¤„ç†è¦è¿…é€Ÿ
- å‹æµ‹æ¼”ç»ƒä¸å¯å°‘ï¼ŒæŒç»­ä¼˜åŒ–æ˜¯å…³é”®