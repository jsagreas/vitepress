---
title: 9ã€SSEå®‰å…¨ä¸è®¤è¯
---
## ğŸ“š ç›®å½•

1. [è®¤è¯æœºåˆ¶æ¦‚è§ˆ](#1-è®¤è¯æœºåˆ¶æ¦‚è§ˆ)
2. [Tokenè®¤è¯æ–¹å¼è¯¦è§£](#2-tokenè®¤è¯æ–¹å¼è¯¦è§£)
3. [Cookieä¼ é€’æœºåˆ¶](#3-cookieä¼ é€’æœºåˆ¶)
4. [è‡ªå®šä¹‰è¯·æ±‚å¤´éªŒè¯æ–¹æ³•](#4-è‡ªå®šä¹‰è¯·æ±‚å¤´éªŒè¯æ–¹æ³•)
5. [HTTPSä¼ è¾“å®‰å…¨é…ç½®](#5-httpsä¼ è¾“å®‰å…¨é…ç½®)
6. [CORSè·¨åŸŸé…ç½®å®è·µ](#6-corsè·¨åŸŸé…ç½®å®è·µ)
7. [é˜²æ­¢æ¶æ„è¿æ¥çš„ç­–ç•¥](#7-é˜²æ­¢æ¶æ„è¿æ¥çš„ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯æœºåˆ¶æ¦‚è§ˆ


### 1.1 ä¸ºä»€ä¹ˆSSEéœ€è¦è®¤è¯


**ç®€å•ç†è§£**ï¼š
```
æƒ³è±¡SSEåƒä¸€ä¸ªç”µè§†ç›´æ’­ï¼š
ğŸ“º ç”µè§†å° = æœåŠ¡å™¨
ğŸ“± è§‚ä¼— = å®¢æˆ·ç«¯

å¦‚æœæ²¡æœ‰è®¤è¯ï¼š
- ä»»ä½•äººéƒ½èƒ½è¿æ¥ä½ çš„æœåŠ¡å™¨
- æ¶æ„ç”¨æˆ·å¯èƒ½æ¶ˆè€—ä½ çš„èµ„æº  
- æ•æ„Ÿæ•°æ®å¯èƒ½è¢«çªƒå–
```

**å®é™…é£é™©**ï¼š
- ğŸš¨ **æœªæˆæƒè®¿é—®**ï¼šé™Œç”Ÿäººè¿æ¥ä½ çš„å®æ—¶æ•°æ®
- ğŸ’¸ **èµ„æºæ¶ˆè€—**ï¼šå¤§é‡æ— æ•ˆè¿æ¥å ç”¨æœåŠ¡å™¨
- ğŸ”“ **æ•°æ®æ³„éœ²**ï¼šæ•æ„Ÿä¿¡æ¯è¢«éæ³•è·å–
- ğŸŒŠ **DDoSæ”»å‡»**ï¼šæ¶æ„å¤§é‡è¿æ¥å¯¼è‡´æœåŠ¡å´©æºƒ

### 1.2 å¸¸ç”¨è®¤è¯æ–¹å¼å¯¹æ¯”


| è®¤è¯æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| ğŸ« **Tokenè®¤è¯** | `å®‰å…¨æ€§é«˜ï¼Œçµæ´»æ§åˆ¶` | `éœ€è¦é¢å¤–ä¼ é€’æœºåˆ¶` | `APIåº”ç”¨ï¼Œç§»åŠ¨ç«¯` |
| ğŸª **Cookieè®¤è¯** | `æµè§ˆå™¨è‡ªåŠ¨å¤„ç†` | `CSRFé£é™©ï¼ŒåŒåŸŸé™åˆ¶` | `Webåº”ç”¨` |
| ğŸ¯ **è‡ªå®šä¹‰Header** | `çµæ´»è‡ªå®šä¹‰` | `æµè§ˆå™¨é™åˆ¶å¤š` | `ç‰¹æ®Šéœ€æ±‚` |

---

## 2. ğŸ« Tokenè®¤è¯æ–¹å¼è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯Tokenè®¤è¯


**é€šä¿—è§£é‡Š**ï¼š
```
Tokenå°±åƒç”µå½±ç¥¨ï¼š
ğŸ¬ ä½ ä¹°ç¥¨æ—¶ = ç”¨æˆ·ç™»å½•
ğŸ« æ‹¿åˆ°ç”µå½±ç¥¨ = è·å¾—Token
ğŸšª å‡­ç¥¨è¿›å…¥ = ç”¨Tokenè®¿é—®SSE
```

**Tokençš„æœ¬è´¨**ï¼š
- ğŸ”‘ **èº«ä»½å‡­è¯**ï¼šè¯æ˜ä½ æ˜¯è°
- â° **ä¸´æ—¶æ€§**ï¼šæœ‰æ•ˆæœŸé™åˆ¶
- ğŸ” **åŠ å¯†ä¿¡æ¯**ï¼šåŒ…å«ç”¨æˆ·èº«ä»½ç­‰æ•°æ®

### 2.2 JWT Tokenè¯¦è§£


**JWTç»„æˆç»“æ„**ï¼š
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

åˆ†è§£ç»“æ„ï¼š
Header.Payload.Signature
ğŸ“‹å¤´éƒ¨.ğŸ’¼è½½è·.âœï¸ç­¾å
```

**å®é™…JWTå†…å®¹**ï¼š
```json
// Header å¤´éƒ¨
{
  "alg": "HS256",  // åŠ å¯†ç®—æ³•
  "typ": "JWT"     // ä»¤ç‰Œç±»å‹
}

// Payload è½½è·ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
{
  "userId": 12345,
  "username": "john",
  "role": "user",
  "exp": 1672531200  // è¿‡æœŸæ—¶é—´
}

// Signature ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret
)
```

### 2.3 SSEä¸­ä¼ é€’Tokençš„æ–¹æ³•


#### æ–¹æ³•1ï¼šURLæŸ¥è¯¢å‚æ•°ï¼ˆæœ€å¸¸ç”¨ï¼‰


**å‰ç«¯ä»£ç **ï¼š
```javascript
// ç”¨æˆ·ç™»å½•åè·å¾—token
const token = localStorage.getItem('authToken');

// è¿æ¥SSEæ—¶åœ¨URLä¸­ä¼ é€’token
const eventSource = new EventSource(`/api/events?token=${token}`);

eventSource.onmessage = function(event) {
    console.log('æ”¶åˆ°æ•°æ®ï¼š', event.data);
};
```

**åç«¯éªŒè¯**ï¼ˆNode.jsç¤ºä¾‹ï¼‰ï¼š
```javascript
app.get('/api/events', (req, res) => {
    // ä»URLå‚æ•°è·å–token
    const token = req.query.token;
    
    if (!token) {
        return res.status(401).json({ error: 'ç¼ºå°‘è®¤è¯token' });
    }
    
    // éªŒè¯token
    try {
        const decoded = jwt.verify(token, SECRET_KEY);
        const userId = decoded.userId;
        
        // è®¾ç½®SSEå“åº”å¤´
        res.writeHead(200, {
            'Content-Type': 'text/event-stream',
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive'
        });
        
        // å‘é€æ¬¢è¿æ¶ˆæ¯
        res.write(`data: æ¬¢è¿ç”¨æˆ· ${decoded.username}\n\n`);
        
    } catch (error) {
        return res.status(401).json({ error: 'Tokenæ— æ•ˆ' });
    }
});
```

#### æ–¹æ³•2ï¼šè‡ªå®šä¹‰EventSourceï¼ˆé«˜çº§ç”¨æ³•ï¼‰


**å‰ç«¯å®ç°**ï¼š
```javascript
class SecureEventSource {
    constructor(url, token) {
        this.url = url;
        this.token = token;
        this.eventSource = null;
        this.connect();
    }
    
    connect() {
        // åˆ›å»ºå¸¦è®¤è¯çš„è¿æ¥
        const urlWithAuth = `${this.url}?token=${this.token}`;
        this.eventSource = new EventSource(urlWithAuth);
        
        this.eventSource.onopen = () => {
            console.log('âœ… SSEè¿æ¥å·²å»ºç«‹');
        };
        
        this.eventSource.onerror = (error) => {
            console.error('âŒ SSEè¿æ¥é”™è¯¯ï¼š', error);
            // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†tokenè¿‡æœŸï¼Œè‡ªåŠ¨é‡æ–°è·å–
        };
    }
    
    // å°è£…äº‹ä»¶ç›‘å¬
    addEventListener(type, listener) {
        this.eventSource.addEventListener(type, listener);
    }
}

// ä½¿ç”¨æ–¹å¼
const secureSSE = new SecureEventSource('/api/events', userToken);
secureSSE.addEventListener('message', (event) => {
    console.log('å®‰å…¨æ•°æ®ï¼š', event.data);
});
```

### 2.4 Tokenåˆ·æ–°æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦åˆ·æ–°**ï¼š
```
Tokenè¿‡æœŸé—®é¢˜ï¼š
ğŸ• Tokenæœ‰æ•ˆæœŸï¼š2å°æ—¶
ğŸ“º ç”¨æˆ·è§‚çœ‹ç›´æ’­ï¼š3å°æ—¶
âŒ 2å°æ—¶åè¿æ¥æ–­å¼€

è§£å†³æ–¹æ¡ˆï¼š
ğŸ”„ è‡ªåŠ¨åˆ·æ–°Token
ğŸ”— é‡æ–°å»ºç«‹è¿æ¥
```

**å®ç°Tokenåˆ·æ–°**ï¼š
```javascript
class AutoRefreshSSE {
    constructor(url, getToken) {
        this.url = url;
        this.getToken = getToken;  // è·å–æ–°tokençš„å‡½æ•°
        this.eventSource = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        
        this.connect();
    }
    
    async connect() {
        try {
            const token = await this.getToken();
            const urlWithAuth = `${this.url}?token=${token}`;
            
            this.eventSource = new EventSource(urlWithAuth);
            
            this.eventSource.onerror = (error) => {
                console.log('è¿æ¥é”™è¯¯ï¼Œå¯èƒ½æ˜¯tokenè¿‡æœŸ');
                this.handleReconnect();
            };
            
        } catch (error) {
            console.error('è·å–tokenå¤±è´¥ï¼š', error);
        }
    }
    
    async handleReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            console.log(`å°è¯•é‡è¿ ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
            
            // å…³é—­æ—§è¿æ¥
            if (this.eventSource) {
                this.eventSource.close();
            }
            
            // å»¶è¿Ÿåé‡æ–°è¿æ¥
            setTimeout(() => {
                this.connect();
            }, 2000);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const autoSSE = new AutoRefreshSSE('/api/events', async () => {
    // è¿™é‡Œå®ç°è·å–æ–°tokençš„é€»è¾‘
    const response = await fetch('/api/refresh-token', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${refreshToken}`
        }
    });
    const data = await response.json();
    return data.accessToken;
});
```

---

## 3. ğŸª Cookieä¼ é€’æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯Cookieè®¤è¯


**ç”Ÿæ´»åŒ–æ¯”å–»**ï¼š
```
Cookieåƒä¼šå‘˜å¡ï¼š
ğŸª ç¬¬ä¸€æ¬¡è¿›åº— = ç”¨æˆ·ç™»å½•
ğŸ’³ åŠç†ä¼šå‘˜å¡ = è®¾ç½®Cookie
ğŸšª ä¸‹æ¬¡è‡ªåŠ¨è¯†åˆ« = Cookieè‡ªåŠ¨å‘é€
```

**Cookieçš„ç‰¹ç‚¹**ï¼š
- ğŸ¤– **è‡ªåŠ¨å‘é€**ï¼šæµè§ˆå™¨è‡ªåŠ¨æºå¸¦åŒåŸŸCookie
- ğŸ’¾ **æŒä¹…å­˜å‚¨**ï¼šå¯è®¾ç½®è¿‡æœŸæ—¶é—´
- ğŸŒ **åŒåŸŸé™åˆ¶**ï¼šåªèƒ½åœ¨ç›¸åŒåŸŸåä¸‹ä½¿ç”¨

### 3.2 Cookieåœ¨SSEä¸­çš„ä½¿ç”¨


**è®¾ç½®Cookieï¼ˆç™»å½•æ—¶ï¼‰**ï¼š
```javascript
// åç«¯ç™»å½•æ¥å£è®¾ç½®Cookie
app.post('/api/login', async (req, res) => {
    const { username, password } = req.body;
    
    // éªŒè¯ç”¨æˆ·åå¯†ç 
    const user = await authenticateUser(username, password);
    
    if (user) {
        // è®¾ç½®HttpOnly Cookie
        res.cookie('sessionId', user.sessionId, {
            httpOnly: true,    // é˜²æ­¢XSSæ”»å‡»
            secure: true,      // ä»…HTTPSä¼ è¾“
            maxAge: 2 * 60 * 60 * 1000, // 2å°æ—¶æœ‰æ•ˆ
            sameSite: 'strict' // é˜²æ­¢CSRFæ”»å‡»
        });
        
        res.json({ success: true, user: user.profile });
    } else {
        res.status(401).json({ error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
    }
});
```

**SSEè¿æ¥è‡ªåŠ¨æºå¸¦Cookie**ï¼š
```javascript
// å‰ç«¯ï¼šæµè§ˆå™¨ä¼šè‡ªåŠ¨å‘é€Cookie
const eventSource = new EventSource('/api/events');

eventSource.onmessage = function(event) {
    console.log('æ¥æ”¶åˆ°æ•°æ®ï¼š', event.data);
};
```

**åç«¯éªŒè¯Cookie**ï¼š
```javascript
app.get('/api/events', async (req, res) => {
    // è·å–Cookieä¸­çš„ä¼šè¯ID
    const sessionId = req.cookies.sessionId;
    
    if (!sessionId) {
        return res.status(401).json({ error: 'æœªç™»å½•' });
    }
    
    // éªŒè¯ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
    const session = await getSessionFromDatabase(sessionId);
    if (!session || session.expired) {
        return res.status(401).json({ error: 'ä¼šè¯å·²è¿‡æœŸ' });
    }
    
    // è®¾ç½®SSEå¤´éƒ¨
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        // å…è®¸è·¨åŸŸå‘é€Cookie
        'Access-Control-Allow-Credentials': 'true'
    });
    
    // ä¸ªæ€§åŒ–æ•°æ®æ¨é€
    const userId = session.userId;
    res.write(`data: æ¬¢è¿å›æ¥ï¼Œ${session.username}!\n\n`);
    
    // å®šæ—¶æ¨é€ç”¨æˆ·ç›¸å…³æ•°æ®
    const interval = setInterval(() => {
        const personalData = getUserPersonalData(userId);
        res.write(`data: ${JSON.stringify(personalData)}\n\n`);
    }, 5000);
    
    // è¿æ¥å…³é—­æ—¶æ¸…ç†
    req.on('close', () => {
        clearInterval(interval);
        console.log(`ç”¨æˆ· ${session.username} æ–­å¼€è¿æ¥`);
    });
});
```

### 3.3 Cookieå®‰å…¨é…ç½®è¯¦è§£


**å®‰å…¨é…ç½®é€‰é¡¹**ï¼š
```javascript
res.cookie('sessionId', sessionValue, {
    httpOnly: true,     // âœ… é˜²æ­¢JSè¯»å–Cookie
    secure: true,       // âœ… ä»…HTTPSä¼ è¾“
    maxAge: 3600000,    // âœ… è®¾ç½®è¿‡æœŸæ—¶é—´
    sameSite: 'strict', // âœ… é˜²CSRFæ”»å‡»
    domain: '.example.com', // ğŸ¯ æŒ‡å®šåŸŸåèŒƒå›´
    path: '/api'        // ğŸ¯ é™åˆ¶è·¯å¾„èŒƒå›´
});
```

**é…ç½®å«ä¹‰è§£é‡Š**ï¼š
- ğŸ” **httpOnly**: Cookieåªèƒ½é€šè¿‡HTTPè¯·æ±‚è®¿é—®ï¼ŒJavaScriptæ— æ³•è¯»å–
- ğŸ”’ **secure**: åªåœ¨HTTPSè¿æ¥ä¸­å‘é€Cookie
- â° **maxAge**: Cookieçš„ç”Ÿå­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- ğŸ›¡ï¸ **sameSite**: é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»
- ğŸŒ **domain**: Cookieçš„æœ‰æ•ˆåŸŸåèŒƒå›´
- ğŸ“‚ **path**: Cookieçš„æœ‰æ•ˆè·¯å¾„èŒƒå›´

---

## 4. ğŸ¯ è‡ªå®šä¹‰è¯·æ±‚å¤´éªŒè¯æ–¹æ³•


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰Header


**åº”ç”¨åœºæ™¯**ï¼š
```
ç‰¹æ®Šéœ€æ±‚æƒ…å†µï¼š
ğŸ“± ç§»åŠ¨Appå¼€å‘ = éœ€è¦ç‰¹æ®Šæ ‡è¯†
ğŸ”§ APIå¯¹æ¥ = è‡ªå®šä¹‰è®¤è¯æ–¹å¼
ğŸ¢ ä¼ä¸šå†…éƒ¨ = ç‰¹æ®Šå®‰å…¨è¦æ±‚
```

**é™åˆ¶è¯´æ˜**ï¼š
> âš ï¸ **é‡è¦æé†’**ï¼šSSEçš„EventSource APIä¸æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´ï¼
> è¿™æ˜¯æµè§ˆå™¨çš„é™åˆ¶ï¼Œä¸æ˜¯æŠ€æœ¯é—®é¢˜ã€‚

### 4.2 è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡ç«¯ä»£ç†


**æ¶æ„å›¾ç¤º**ï¼š
```
å®¢æˆ·ç«¯åº”ç”¨                ä»£ç†æœåŠ¡å™¨              SSEæœåŠ¡å™¨
     |                       |                      |
     |--[1]å¸¦Headerè¯·æ±‚----->|                      |
     |   Authorization: xxx  |                      |
     |                       |--[2]éªŒè¯åè½¬å‘------->|
     |                       |   token=verified     |
     |                       |                      |
     |<--[3]SSEæ•°æ®æµ--------|<--[4]å®é™…SSEæ•°æ®-----|
```

**ä»£ç†æœåŠ¡å™¨å®ç°**ï¼š
```javascript
// ä»£ç†ç«¯ç‚¹ï¼šæ¥æ”¶è‡ªå®šä¹‰Header
app.get('/api/secure-events', (req, res) => {
    // è·å–è‡ªå®šä¹‰è®¤è¯å¤´
    const authHeader = req.headers.authorization;
    const customKey = req.headers['x-custom-auth'];
    
    if (!authHeader || !customKey) {
        return res.status(401).json({ error: 'ç¼ºå°‘è®¤è¯ä¿¡æ¯' });
    }
    
    // éªŒè¯è‡ªå®šä¹‰è®¤è¯
    if (!validateCustomAuth(authHeader, customKey)) {
        return res.status(403).json({ error: 'è®¤è¯å¤±è´¥' });
    }
    
    // ç”Ÿæˆä¸´æ—¶è®¿é—®token
    const tempToken = generateTempToken(req.userId);
    
    // é‡å®šå‘åˆ°çœŸæ­£çš„SSEç«¯ç‚¹
    res.redirect(`/api/events?token=${tempToken}`);
});

// çœŸæ­£çš„SSEç«¯ç‚¹
app.get('/api/events', (req, res) => {
    const token = req.query.token;
    
    // éªŒè¯ä¸´æ—¶token
    if (!validateTempToken(token)) {
        return res.status(401).json({ error: 'Tokenæ— æ•ˆ' });
    }
    
    // å»ºç«‹SSEè¿æ¥
    setupSSEConnection(res, token);
});
```

### 4.3 å‰ç«¯è°ƒç”¨æ–¹å¼


**ç¬¬ä¸€æ­¥ï¼šè·å–è®¤è¯SSE URL**ï¼š
```javascript
async function getAuthenticatedSSEUrl() {
    try {
        const response = await fetch('/api/secure-events', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + userToken,
                'X-Custom-Auth': customAuthKey,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.redirected) {
            // è·å–é‡å®šå‘åçš„URLï¼ˆåŒ…å«ä¸´æ—¶tokenï¼‰
            return response.url;
        }
        
        throw new Error('è®¤è¯å¤±è´¥');
        
    } catch (error) {
        console.error('è·å–SSE URLå¤±è´¥ï¼š', error);
        throw error;
    }
}

// ä½¿ç”¨è®¤è¯åçš„URLå»ºç«‹SSEè¿æ¥
async function connectSecureSSE() {
    try {
        const sseUrl = await getAuthenticatedSSEUrl();
        const eventSource = new EventSource(sseUrl);
        
        eventSource.onmessage = (event) => {
            console.log('å®‰å…¨æ•°æ®ï¼š', event.data);
        };
        
        eventSource.onerror = (error) => {
            console.error('SSEè¿æ¥é”™è¯¯ï¼š', error);
        };
        
    } catch (error) {
        console.error('å»ºç«‹å®‰å…¨è¿æ¥å¤±è´¥ï¼š', error);
    }
}
```

---

## 5. ğŸ”’ HTTPSä¼ è¾“å®‰å…¨é…ç½®


### 5.1 ä¸ºä»€ä¹ˆSSEå¿…é¡»ç”¨HTTPS


**å®‰å…¨é£é™©å¯¹æ¯”**ï¼š
```
HTTPä¼ è¾“ï¼š
ğŸ“¡ æ•°æ®æ˜æ–‡ä¼ è¾“
ğŸ‘ï¸ ä¸­é—´äººå¯ä»¥çªƒå¬
ğŸ­ æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹
âŒ ç°ä»£æµè§ˆå™¨é™åˆ¶

HTTPSä¼ è¾“ï¼š
ğŸ” ç«¯åˆ°ç«¯åŠ å¯†
ğŸ›¡ï¸ é˜²æ­¢çªƒå¬å’Œç¯¡æ”¹
âœ… æµè§ˆå™¨å®Œå…¨æ”¯æŒ
ğŸ”’ ç¬¦åˆå®‰å…¨æ ‡å‡†
```

### 5.2 HTTPSé…ç½®å®ç°


**Node.js HTTPSæœåŠ¡å™¨**ï¼š
```javascript
const https = require('https');
const fs = require('fs');

// è¯»å–SSLè¯ä¹¦æ–‡ä»¶
const options = {
    key: fs.readFileSync('path/to/private-key.pem'),
    cert: fs.readFileSync('path/to/certificate.pem')
};

// åˆ›å»ºHTTPSæœåŠ¡å™¨
const server = https.createServer(options, app);

// SSEç«¯ç‚¹
app.get('/api/events', (req, res) => {
    // è®¾ç½®HTTPSå®‰å…¨å¤´
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        // å®‰å…¨ç›¸å…³å¤´éƒ¨
        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',
        'X-Content-Type-Options': 'nosniff',
        'X-Frame-Options': 'DENY'
    });
    
    res.write('data: å®‰å…¨è¿æ¥å·²å»ºç«‹\n\n');
});

server.listen(443, () => {
    console.log('ğŸ”’ HTTPS SSEæœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 443');
});
```

**å‰ç«¯å¼ºåˆ¶HTTPSæ£€æŸ¥**ï¼š
```javascript
function createSecureSSE(endpoint) {
    // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦ä¸ºHTTPS
    if (location.protocol !== 'https:') {
        console.error('âŒ SSEéœ€è¦HTTPSç¯å¢ƒ');
        alert('ä¸ºäº†å®‰å…¨ï¼Œè¯·ä½¿ç”¨HTTPSè®¿é—®');
        return null;
    }
    
    // ç¡®ä¿SSEç«¯ç‚¹ä¹Ÿæ˜¯HTTPS
    const secureUrl = endpoint.startsWith('https://') 
        ? endpoint 
        : `https://${window.location.host}${endpoint}`;
    
    console.log('ğŸ”’ å»ºç«‹å®‰å…¨SSEè¿æ¥ï¼š', secureUrl);
    return new EventSource(secureUrl);
}

// ä½¿ç”¨æ–¹å¼
const secureSSE = createSecureSSE('/api/events?token=xxx');
if (secureSSE) {
    secureSSE.onmessage = (event) => {
        console.log('å®‰å…¨æ•°æ®ï¼š', event.data);
    };
}
```

### 5.3 SSLè¯ä¹¦è·å–ä¸é…ç½®


**Let's Encryptå…è´¹è¯ä¹¦**ï¼š
```bash
# å®‰è£…certbot
sudo apt-get install certbot

# è·å–è¯ä¹¦
sudo certbot certonly --standalone -d your-domain.com

# è¯ä¹¦æ–‡ä»¶ä½ç½®
# ç§é’¥ï¼š/etc/letsencrypt/live/your-domain.com/privkey.pem
# è¯ä¹¦ï¼š/etc/letsencrypt/live/your-domain.com/fullchain.pem
```

**å¼€å‘ç¯å¢ƒè‡ªç­¾åè¯ä¹¦**ï¼š
```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out private-key.pem 2048

# ç”Ÿæˆè¯ä¹¦
openssl req -new -x509 -key private-key.pem -out certificate.pem -days 365
```

---

## 6. ğŸŒ CORSè·¨åŸŸé…ç½®å®è·µ


### 6.1 ä»€ä¹ˆæ˜¯CORSè·¨åŸŸé—®é¢˜


**ç®€å•ç†è§£**ï¼š
```
è·¨åŸŸåœºæ™¯ï¼š
ğŸŒ ç½‘ç«™A: https://www.example.com
ğŸ”— è¯·æ±‚B: https://api.server.com/events

æµè§ˆå™¨å®‰å…¨ç­–ç•¥ï¼š
âŒ ä¸å…è®¸è·¨åŸŸè¯·æ±‚
ğŸ›¡ï¸ é˜²æ­¢æ¶æ„ç½‘ç«™æ”»å‡»
```

**SSEè·¨åŸŸç‰¹ç‚¹**ï¼š
- ğŸŒ EventSourceä¹Ÿå—åŒæºç­–ç•¥é™åˆ¶
- ğŸ”§ éœ€è¦æœåŠ¡å™¨ç«¯é…ç½®CORSå¤´
- ğŸª å¦‚æœéœ€è¦Cookieï¼Œé…ç½®æ›´å¤æ‚

### 6.2 åŸºç¡€CORSé…ç½®


**æœåŠ¡å™¨ç«¯é…ç½®**ï¼š
```javascript
app.use((req, res, next) => {
    // å…è®¸ç‰¹å®šåŸŸåè®¿é—®
    const allowedOrigins = [
        'https://www.example.com',
        'https://app.example.com',
        'http://localhost:3000'  // å¼€å‘ç¯å¢ƒ
    ];
    
    const origin = req.headers.origin;
    if (allowedOrigins.includes(origin)) {
        res.setHeader('Access-Control-Allow-Origin', origin);
    }
    
    // SSEå¿…éœ€çš„CORSå¤´
    res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    res.setHeader('Access-Control-Max-Age', '86400'); // 24å°æ—¶ç¼“å­˜
    
    next();
});

// SSEç«¯ç‚¹çš„CORSé…ç½®
app.get('/api/events', (req, res) => {
    // è®¾ç½®SSEå¤´éƒ¨
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        // CORSå¤´éƒ¨
        'Access-Control-Allow-Origin': req.headers.origin,
        'Access-Control-Allow-Credentials': 'false'  // ä¸éœ€è¦Cookieæ—¶è®¾ä¸ºfalse
    });
    
    res.write('data: è·¨åŸŸSSEè¿æ¥æˆåŠŸ\n\n');
});
```

### 6.3 å¸¦Cookieçš„è·¨åŸŸé…ç½®


**å¤æ‚åœºæ™¯é…ç½®**ï¼š
```javascript
// éœ€è¦Cookieçš„è·¨åŸŸSSE
app.get('/api/secure-events', (req, res) => {
    const origin = req.headers.origin;
    
    // æ£€æŸ¥åŸŸåç™½åå•
    const allowedOrigins = ['https://trusted-site.com'];
    if (!allowedOrigins.includes(origin)) {
        return res.status(403).json({ error: 'åŸŸåä¸è¢«å…è®¸' });
    }
    
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        // é‡è¦ï¼šå¸¦Cookieçš„è·¨åŸŸé…ç½®
        'Access-Control-Allow-Origin': origin,  // ä¸èƒ½ç”¨*
        'Access-Control-Allow-Credentials': 'true',  // å…è®¸å‘é€Cookie
        'Access-Control-Allow-Headers': 'Content-Type, Authorization'
    });
    
    // éªŒè¯Cookie
    const sessionId = req.cookies.sessionId;
    if (!sessionId) {
        res.write('event: error\n');
        res.write('data: æœªç™»å½•\n\n');
        return;
    }
    
    res.write('data: å¸¦Cookieçš„è·¨åŸŸSSEè¿æ¥æˆåŠŸ\n\n');
});
```

**å‰ç«¯è·¨åŸŸè¯·æ±‚**ï¼š
```javascript
// è·¨åŸŸSSEè¿æ¥ï¼ˆéœ€è¦Cookieï¼‰
function createCORSSSE() {
    const eventSource = new EventSource('https://api.server.com/api/secure-events', {
        withCredentials: true  // å…³é”®ï¼šå‘é€Cookie
    });
    
    eventSource.onmessage = (event) => {
        console.log('è·¨åŸŸæ•°æ®ï¼š', event.data);
    };
    
    eventSource.addEventListener('error', (event) => {
        if (event.type === 'error') {
            console.error('è·¨åŸŸSSEè¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé…ç½®é—®é¢˜');
        }
    });
    
    return eventSource;
}

// å¤„ç†CORSé”™è¯¯
function handleCORSError() {
    console.log(`
    CORSé”™è¯¯å¯èƒ½åŸå› ï¼š
    âŒ æœåŠ¡å™¨æœªè®¾ç½®æ­£ç¡®çš„CORSå¤´
    âŒ åŸŸåä¸åœ¨ç™½åå•ä¸­
    âŒ withCredentialsé…ç½®ä¸åŒ¹é…
    âŒ é¢„æ£€è¯·æ±‚(OPTIONS)å¤±è´¥
    `);
}
```

---

## 7. ğŸ›¡ï¸ é˜²æ­¢æ¶æ„è¿æ¥çš„ç­–ç•¥


### 7.1 å¸¸è§æ”»å‡»æ–¹å¼


**æ”»å‡»ç±»å‹è¯†åˆ«**ï¼š
```
ğŸŒŠ DDoSæ”»å‡»ï¼š
å¤§é‡æ— æ•ˆè¿æ¥æ¶ˆè€—æœåŠ¡å™¨èµ„æº

ğŸ¤– åƒµå°¸ç½‘ç»œï¼š
è‡ªåŠ¨åŒ–è„šæœ¬é¢‘ç¹è¿æ¥

ğŸ’£ èµ„æºè€—å°½ï¼š
é•¿æ—¶é—´å ç”¨è¿æ¥ä¸é‡Šæ”¾

ğŸ­ èº«ä»½ä¼ªé€ ï¼š
ä½¿ç”¨è™šå‡æˆ–ç›—å–çš„è®¤è¯ä¿¡æ¯
```

### 7.2 é¢‘ç‡é™åˆ¶ï¼ˆRate Limitingï¼‰


**åŸºäºIPçš„é™åˆ¶**ï¼š
```javascript
const rateLimit = require('express-rate-limit');
const slowDown = require('express-slow-down');

// IPé¢‘ç‡é™åˆ¶
const sseRateLimit = rateLimit({
    windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿçª—å£
    max: 10, // æ¯ä¸ªIPæœ€å¤š10ä¸ªè¿æ¥
    message: {
        error: 'è¿æ¥è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
        retryAfter: '15åˆ†é’Ÿåé‡è¯•'
    },
    standardHeaders: true,
    legacyHeaders: false
});

// é€æ¸é™é€Ÿç­–ç•¥
const speedLimiter = slowDown({
    windowMs: 15 * 60 * 1000,
    delayAfter: 5,  // 5æ¬¡è¯·æ±‚åå¼€å§‹å»¶è¿Ÿ
    delayMs: 500    // æ¯æ¬¡å¢åŠ 500mså»¶è¿Ÿ
});

// åº”ç”¨åˆ°SSEç«¯ç‚¹
app.get('/api/events', sseRateLimit, speedLimiter, (req, res) => {
    // SSEé€»è¾‘
});
```

**ç”¨æˆ·çº§åˆ«é™åˆ¶**ï¼š
```javascript
// ç”¨æˆ·è¿æ¥æ•°é™åˆ¶
const userConnections = new Map();

app.get('/api/events', (req, res) => {
    const userId = getUserId(req);
    
    // æ£€æŸ¥ç”¨æˆ·å½“å‰è¿æ¥æ•°
    const currentConnections = userConnections.get(userId) || 0;
    if (currentConnections >= 3) {  // æ¯ç”¨æˆ·æœ€å¤š3ä¸ªè¿æ¥
        return res.status(429).json({
            error: 'è¿æ¥æ•°è¶…é™',
            message: 'æ¯ä¸ªç”¨æˆ·æœ€å¤šåŒæ—¶3ä¸ªè¿æ¥'
        });
    }
    
    // å¢åŠ è¿æ¥è®¡æ•°
    userConnections.set(userId, currentConnections + 1);
    
    // è®¾ç½®SSE
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive'
    });
    
    // è¿æ¥å…³é—­æ—¶å‡å°‘è®¡æ•°
    req.on('close', () => {
        const current = userConnections.get(userId) || 1;
        userConnections.set(userId, current - 1);
        console.log(`ç”¨æˆ· ${userId} æ–­å¼€è¿æ¥ï¼Œå‰©ä½™: ${current - 1}`);
    });
    
    res.write(`data: è¿æ¥æˆåŠŸï¼Œå½“å‰è¿æ¥æ•°: ${currentConnections + 1}\n\n`);
});
```

### 7.3 è¿æ¥éªŒè¯ä¸ç›‘æ§


**å¥åº·æ£€æŸ¥æœºåˆ¶**ï¼š
```javascript
// è¿æ¥å¥åº·ç›‘æ§
class SSEConnectionMonitor {
    constructor() {
        this.connections = new Map();
        this.suspiciousIPs = new Set();
        
        // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        setInterval(() => this.monitorConnections(), 60000);
    }
    
    addConnection(req, res) {
        const clientIP = req.ip;
        const userAgent = req.headers['user-agent'];
        
        const connectionInfo = {
            ip: clientIP,
            userAgent: userAgent,
            connectTime: Date.now(),
            dataReceived: 0,
            lastActivity: Date.now()
        };
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå¯ç–‘è¿æ¥
        if (this.isSuspicious(connectionInfo)) {
            console.log(`ğŸš¨ å‘ç°å¯ç–‘è¿æ¥ï¼š${clientIP}`);
            this.suspiciousIPs.add(clientIP);
            res.status(403).json({ error: 'è¿æ¥è¢«æ‹’ç»' });
            return false;
        }
        
        this.connections.set(req, connectionInfo);
        return true;
    }
    
    isSuspicious(connectionInfo) {
        // æ£€æŸ¥User-Agent
        if (!connectionInfo.userAgent || 
            connectionInfo.userAgent.includes('bot') ||
            connectionInfo.userAgent.length < 10) {
            return true;
        }
        
        // æ£€æŸ¥IPæ˜¯å¦åœ¨é»‘åå•ä¸­
        if (this.suspiciousIPs.has(connectionInfo.ip)) {
            return true;
        }
        
        return false;
    }
    
    monitorConnections() {
        const now = Date.now();
        let suspiciousCount = 0;
        
        for (let [req, info] of this.connections) {
            // æ£€æŸ¥é•¿æ—¶é—´æ— æ´»åŠ¨çš„è¿æ¥
            if (now - info.lastActivity > 5 * 60 * 1000) {  // 5åˆ†é’Ÿæ— æ´»åŠ¨
                console.log(`âš ï¸ å‘ç°åƒµæ­»è¿æ¥ï¼š${info.ip}`);
                req.connection.destroy();  // å¼ºåˆ¶æ–­å¼€
                this.connections.delete(req);
                suspiciousCount++;
            }
        }
        
        console.log(`ğŸ“Š è¿æ¥ç›‘æ§æŠ¥å‘Šï¼š
        æ€»è¿æ¥æ•°: ${this.connections.size}
        æ¸…ç†åƒµæ­»è¿æ¥: ${suspiciousCount}
        å¯ç–‘IPæ•°: ${this.suspiciousIPs.size}`);
    }
}

// ä½¿ç”¨ç›‘æ§å™¨
const monitor = new SSEConnectionMonitor();

app.get('/api/events', (req, res) => {
    // è¿æ¥éªŒè¯
    if (!monitor.addConnection(req, res)) {
        return;  // å¯ç–‘è¿æ¥å·²è¢«æ‹’ç»
    }
    
    // æ­£å¸¸SSEé€»è¾‘
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive'
    });
    
    res.write('data: å®‰å…¨è¿æ¥å·²å»ºç«‹\n\n');
});
```

### 7.4 IPé»‘åå•ä¸ç™½åå•


**é»‘ç™½åå•ç®¡ç†**ï¼š
```javascript
class IPAccessControl {
    constructor() {
        // å¯ä»¥ä»æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶åŠ è½½
        this.blacklist = new Set([
            '192.168.1.100',  // å·²çŸ¥æ”»å‡»IP
            '10.0.0.50'
        ]);
        
        this.whitelist = new Set([
            '192.168.1.1',    // ç®¡ç†å‘˜IP
            '10.0.0.1'
        ]);
        
        // ä¸´æ—¶å°ç¦ï¼ˆè¿‡æœŸè‡ªåŠ¨è§£é™¤ï¼‰
        this.temporaryBan = new Map();
    }
    
    isAllowed(ip) {
        // ç™½åå•ä¼˜å…ˆ
        if (this.whitelist.has(ip)) {
            return true;
        }
        
        // æ£€æŸ¥é»‘åå•
        if (this.blacklist.has(ip)) {
            return false;
        }
        
        // æ£€æŸ¥ä¸´æ—¶å°ç¦
        const banInfo = this.temporaryBan.get(ip);
        if (banInfo && Date.now() < banInfo.expireTime) {
            return false;
        } else if (banInfo) {
            // å°ç¦å·²è¿‡æœŸï¼Œç§»é™¤
            this.temporaryBan.delete(ip);
        }
        
        return true;
    }
    
    // ä¸´æ—¶å°ç¦IP
    banTemporarily(ip, minutes = 15) {
        const expireTime = Date.now() + minutes * 60 * 1000;
        this.temporaryBan.set(ip, { expireTime });
        console.log(`ğŸš« IP ${ip} è¢«ä¸´æ—¶å°ç¦ ${minutes} åˆ†é’Ÿ`);
    }
    
    // æ°¸ä¹…åŠ å…¥é»‘åå•
    addToBlacklist(ip, reason) {
        this.blacklist.add(ip);
        console.log(`ğŸš« IP ${ip} è¢«åŠ å…¥é»‘åå•ï¼ŒåŸå› : ${reason}`);
        // å¯ä»¥æŒä¹…åŒ–åˆ°æ•°æ®åº“
    }
}

// ä¸­é—´ä»¶ä½¿ç”¨
const accessControl = new IPAccessControl();

app.use('/api/events', (req, res, next) => {
    const clientIP = req.ip;
    
    if (!accessControl.isAllowed(clientIP)) {
        console.log(`âŒ IP ${clientIP} è®¿é—®è¢«æ‹’ç»`);
        return res.status(403).json({
            error: 'è®¿é—®è¢«æ‹’ç»',
            message: 'IPåœ°å€ä¸è¢«å…è®¸'
        });
    }
    
    next();
});
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 è®¤è¯æ–¹å¼é€‰æ‹©æŒ‡å—


```
ğŸ¯ é€‰æ‹©å»ºè®®ï¼š

Webåº”ç”¨ + åŒåŸŸï¼š
âœ… ä½¿ç”¨Cookieè®¤è¯
ğŸ‘ æµè§ˆå™¨è‡ªåŠ¨å¤„ç†ï¼Œç”¨æˆ·ä½“éªŒå¥½

APIåº”ç”¨ + è·¨åŸŸï¼š
âœ… ä½¿ç”¨Tokenè®¤è¯ï¼ˆURLå‚æ•°ï¼‰
ğŸ‘ çµæ´»æ€§é«˜ï¼Œå®‰å…¨æ€§å¥½

ç§»åŠ¨ç«¯åº”ç”¨ï¼š
âœ… ä½¿ç”¨Token + ä»£ç†æ¨¡å¼
ğŸ‘ æ”¯æŒè‡ªå®šä¹‰è®¤è¯æ–¹å¼

ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼š
âœ… ç»“åˆå¤šç§è®¤è¯æ–¹å¼
ğŸ‘ æ ¹æ®å®‰å…¨ç­‰çº§çµæ´»é…ç½®
```

### 8.2 å®‰å…¨é…ç½®æ¸…å•


```
ğŸ”’ åŸºç¡€å®‰å…¨ï¼š
â–¡ å¼ºåˆ¶ä½¿ç”¨HTTPS
â–¡ è®¾ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´  
â–¡ é…ç½®æ­£ç¡®çš„CORSå¤´
â–¡ å¯ç”¨Cookieå®‰å…¨é€‰é¡¹

ğŸ›¡ï¸ è¿›é˜¶é˜²æŠ¤ï¼š
â–¡ å®æ–½é¢‘ç‡é™åˆ¶
â–¡ ç›‘æ§å¯ç–‘è¿æ¥
â–¡ å»ºç«‹IPé»‘ç™½åå•
â–¡ è®¾ç½®è¿æ¥æ•°é™åˆ¶

ğŸ“Š ç›‘æ§å‘Šè­¦ï¼š
â–¡ è¿æ¥æ•°é‡ç›‘æ§
â–¡ å¼‚å¸¸æµé‡å‘Šè­¦
â–¡ è®¤è¯å¤±è´¥ç»Ÿè®¡
â–¡ æ€§èƒ½æŒ‡æ ‡è·Ÿè¸ª
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ”¹ å¼€å‘é˜¶æ®µ**ï¼š
- ä½¿ç”¨è‡ªç­¾åè¯ä¹¦è¿›è¡ŒHTTPSæµ‹è¯•
- é…ç½®å®½æ¾çš„CORSç­–ç•¥ä¾¿äºè°ƒè¯•
- å¯ç”¨è¯¦ç»†çš„è¿æ¥æ—¥å¿—

**ğŸ”¹ ç”Ÿäº§é˜¶æ®µ**ï¼š  
- ä½¿ç”¨æ­£å¼SSLè¯ä¹¦
- ä¸¥æ ¼é…ç½®CORSç™½åå•
- å¯ç”¨æ‰€æœ‰å®‰å…¨é˜²æŠ¤æªæ–½
- å®šæœŸæ›´æ–°å’Œç›‘æ§

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–**ï¼š
- åˆç†è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´
- å®æ–½è¿æ¥æ± ç®¡ç†
- ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨
- å®šæœŸæ¸…ç†æ— æ•ˆè¿æ¥

**æ ¸å¿ƒè®°å¿†**ï¼š
- ğŸ” å®‰å…¨ç¬¬ä¸€ï¼šæ‰€æœ‰SSEè¿æ¥éƒ½è¦è®¤è¯
- ğŸ›¡ï¸ å¤šå±‚é˜²æŠ¤ï¼šè®¤è¯+HTTPS+CORS+é™æµ
- ğŸ“Š æŒç»­ç›‘æ§ï¼šå®æ—¶å‘ç°å’Œå¤„ç†å®‰å…¨å¨èƒ
- âš–ï¸ å¹³è¡¡ä½“éªŒï¼šå®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒå¹¶é‡