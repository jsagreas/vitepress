---
title: 1ã€å®¢æˆ·ç«¯EventSource-APIè¯¦è§£
---
## ğŸ“š ç›®å½•

1. [EventSourceåŸºç¡€æ¦‚å¿µ](#1-EventSourceåŸºç¡€æ¦‚å¿µ)
2. [EventSourceæ„é€ å‡½æ•°ä¸å‚æ•°](#2-EventSourceæ„é€ å‡½æ•°ä¸å‚æ•°)
3. [è¿æ¥çŠ¶æ€ç®¡ç†](#3-è¿æ¥çŠ¶æ€ç®¡ç†)
4. [æ ¸å¿ƒå±æ€§è¯¦è§£](#4-æ ¸å¿ƒå±æ€§è¯¦è§£)
5. [ä¸‰å¤§æ ¸å¿ƒäº‹ä»¶](#5-ä¸‰å¤§æ ¸å¿ƒäº‹ä»¶)
6. [äº‹ä»¶å¯¹è±¡å±æ€§](#6-äº‹ä»¶å¯¹è±¡å±æ€§)
7. [å®æˆ˜æ¼”ç¤ºä¸åº”ç”¨](#7-å®æˆ˜æ¼”ç¤ºä¸åº”ç”¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ EventSourceåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯EventSource


**ğŸ”¸ é€šä¿—ç†è§£**
EventSourceå°±åƒæ˜¯æµè§ˆå™¨å†…ç½®çš„ä¸€ä¸ª"æ¶ˆæ¯æ¥æ”¶å™¨"ï¼Œä¸“é—¨ç”¨æ¥æ¥æ”¶æœåŠ¡å™¨ä¸»åŠ¨æ¨é€çš„æ¶ˆæ¯ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šæµè§ˆå™¨é—®ä¸€æ¬¡ï¼ŒæœåŠ¡å™¨ç­”ä¸€æ¬¡ï¼ˆè¯·æ±‚-å“åº”ï¼‰
SSEæ–¹å¼ï¼šæœåŠ¡å™¨æƒ³è¯´å°±è¯´ï¼Œæµè§ˆå™¨ä¸€ç›´åœ¨å¬ï¼ˆæŒç»­æ¨é€ï¼‰

å¥½æ¯”ï¼š
ä¼ ç»Ÿ = ä½ é—®æˆ‘ç­”çš„å¯¹è¯
SSE = è€å¸ˆè®²è¯¾ï¼Œå­¦ç”Ÿä¸€ç›´åœ¨å¬
```

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**
```
âœ… è¯­æ³•ç®€å•ï¼šåªéœ€å‡ è¡Œä»£ç å°±èƒ½å»ºç«‹è¿æ¥
âœ… åŠŸèƒ½å¼ºå¤§ï¼šè‡ªåŠ¨é‡è¿ã€äº‹ä»¶å¤„ç†ã€çŠ¶æ€ç®¡ç†
âœ… æµè§ˆå™¨åŸç”Ÿï¼šä¸éœ€è¦ä»»ä½•ç¬¬ä¸‰æ–¹åº“
âœ… å•å‘é€šä¿¡ï¼šä¸“é—¨ç”¨äºæœåŠ¡å™¨å‘å®¢æˆ·ç«¯æ¨é€
```

### 1.2 EventSourceçš„å·¥ä½œåŸç†


**ğŸ“¡ è¿æ¥å»ºç«‹è¿‡ç¨‹**
```
å®¢æˆ·ç«¯                                æœåŠ¡å™¨
   |                                     |
   |---[1] new EventSource(url)--------->|
   |                                     |
   |<--[2] HTTP 200 + text/event-stream--|
   |                                     |
   |<--[3] æŒç»­æ¥æ”¶æ•°æ®æµ-----------------|
   |   data: æ¶ˆæ¯1                       |
   |   data: æ¶ˆæ¯2                       |
   |   data: æ¶ˆæ¯3                       |
```

---

## 2. ğŸ—ï¸ EventSourceæ„é€ å‡½æ•°ä¸å‚æ•°


### 2.1 åŸºç¡€è¯­æ³•


**ğŸ”¸ æœ€ç®€å•çš„ç”¨æ³•**
```javascript
// åˆ›å»ºEventSourceè¿æ¥
const eventSource = new EventSource('http://localhost:3000/events');

// å°±è¿™ä¹ˆç®€å•ï¼è¿æ¥å°±å»ºç«‹äº†
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- `new EventSource()` å°±åƒæ‰“ç”µè¯æ‹¨å·
- ä¸€æ—¦åˆ›å»ºï¼Œç«‹å³å¼€å§‹å°è¯•è¿æ¥
- ä¸éœ€è¦æ‰‹åŠ¨"å¼€å§‹"ï¼Œè‡ªåŠ¨å°±è¿ä¸Šäº†

### 2.2 æ„é€ å‡½æ•°å‚æ•°è¯¦è§£


**ğŸ”§ å®Œæ•´è¯­æ³•**
```javascript
const eventSource = new EventSource(url, options);
```

**ğŸ“‹ å‚æ•°è¯´æ˜**

| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| **url** | `string` | âœ… | æœåŠ¡å™¨SSEæ¥å£åœ°å€ |
| **options** | `object` | âŒ | é…ç½®é€‰é¡¹ï¼ˆå¯é€‰ï¼‰ |

**ğŸ”¸ optionsé…ç½®é€‰é¡¹**
```javascript
const eventSource = new EventSource('/events', {
    withCredentials: true  // æ˜¯å¦å‘é€Cookieå’Œè®¤è¯ä¿¡æ¯
});
```

**ğŸ’¡ withCredentialsè¯¦è§£**
```
withCredentials: false (é»˜è®¤)
- ä¸å‘é€Cookie
- ä¸å‘é€è®¤è¯å¤´
- é€‚ç”¨äºå…¬å¼€æ¥å£

withCredentials: true
- å‘é€Cookieå’Œè®¤è¯ä¿¡æ¯
- é€‚ç”¨äºéœ€è¦ç™»å½•çš„æ¥å£
- æ”¯æŒè·¨åŸŸè®¤è¯
```

### 2.3 å®é™…åˆ›å»ºç¤ºä¾‹


**ğŸŒŸ åŸºç¡€ç¤ºä¾‹**
```javascript
// è¿æ¥æœ¬åœ°å¼€å‘æœåŠ¡å™¨
const eventSource = new EventSource('http://localhost:3000/events');

console.log('EventSourceå·²åˆ›å»ºï¼Œå¼€å§‹è¿æ¥...');
```

**ğŸŒŸ å¸¦è®¤è¯çš„ç¤ºä¾‹**
```javascript
// è¿æ¥éœ€è¦ç™»å½•çš„æ¥å£
const eventSource = new EventSource('/api/user-notifications', {
    withCredentials: true
});

console.log('å¸¦è®¤è¯çš„EventSourceå·²åˆ›å»º');
```

---

## 3. ğŸ“Š è¿æ¥çŠ¶æ€ç®¡ç†


### 3.1 ä¸‰ç§è¿æ¥çŠ¶æ€


EventSourceå°±åƒæ‰‹æœºä¿¡å·ï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š

```
ğŸ”„ CONNECTING (0) = æ­£åœ¨è¿æ¥ä¸­ï¼ˆæ‹¨å·ä¸­ï¼‰
âœ… OPEN (1)       = è¿æ¥å·²å»ºç«‹ï¼ˆé€šè¯ä¸­ï¼‰  
âŒ CLOSED (2)     = è¿æ¥å·²å…³é—­ï¼ˆæŒ‚æ–­äº†ï¼‰
```

### 3.2 readyStateå±æ€§è¯¦è§£


**ğŸ”¸ çŠ¶æ€å¸¸é‡**
```javascript
console.log(EventSource.CONNECTING); // 0
console.log(EventSource.OPEN);       // 1
console.log(EventSource.CLOSED);     // 2
```

**ğŸ”¸ å®æ—¶çŠ¶æ€æ£€æµ‹**
```javascript
const eventSource = new EventSource('/events');

// æ£€æŸ¥å½“å‰çŠ¶æ€
function checkStatus() {
    switch(eventSource.readyState) {
        case EventSource.CONNECTING:
            console.log('ğŸ”„ æ­£åœ¨è¿æ¥...');
            break;
        case EventSource.OPEN:
            console.log('âœ… è¿æ¥æˆåŠŸï¼');
            break;
        case EventSource.CLOSED:
            console.log('âŒ è¿æ¥å·²å…³é—­');
            break;
    }
}

// æ¯ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
setInterval(checkStatus, 1000);
```

### 3.3 çŠ¶æ€å˜åŒ–æ—¶æœº


**ğŸ“ˆ çŠ¶æ€å˜åŒ–æµç¨‹**
```
åˆ›å»ºEventSource
       â†“
   CONNECTING (å¼€å§‹è¿æ¥)
       â†“
    è¿æ¥æˆåŠŸï¼Ÿ
   â†™ï¸       â†˜ï¸
 OPEN      è¿æ¥å¤±è´¥
(æ­£å¸¸)        â†“
   â†“       é‡è¯•è¿æ¥
æ•°æ®ä¼ è¾“        â†“
   â†“       CONNECTING
æ‰‹åŠ¨å…³é—­         â†“
   â†“        (å¾ªç¯é‡è¯•)
CLOSED
```

---

## 4. ğŸ¯ æ ¸å¿ƒå±æ€§è¯¦è§£


### 4.1 urlå±æ€§


**ğŸ”¸ è·å–è¿æ¥åœ°å€**
```javascript
const eventSource = new EventSource('http://localhost:3000/events');

console.log('è¿æ¥åœ°å€:', eventSource.url);
// è¾“å‡º: http://localhost:3000/events
```

**ğŸ’¡ å®ç”¨åœºæ™¯**
```javascript
// æ ¹æ®è¿æ¥åœ°å€åšä¸åŒå¤„ç†
if (eventSource.url.includes('localhost')) {
    console.log('è¿™æ˜¯å¼€å‘ç¯å¢ƒ');
} else {
    console.log('è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒ');
}
```

### 4.2 withCredentialså±æ€§


**ğŸ”¸ æŸ¥çœ‹è®¤è¯çŠ¶æ€**
```javascript
const eventSource = new EventSource('/events', {
    withCredentials: true
});

console.log('æ˜¯å¦å‘é€è®¤è¯ä¿¡æ¯:', eventSource.withCredentials);
// è¾“å‡º: true
```

---

## 5. ğŸª ä¸‰å¤§æ ¸å¿ƒäº‹ä»¶


### 5.1 onopen - è¿æ¥å»ºç«‹äº‹ä»¶


**ğŸ”¸ ä½œç”¨è¯´æ˜**
`onopen` å°±åƒæ¥ç”µè¯æ—¶å¬åˆ°"å–‚"çš„å£°éŸ³ï¼Œè¡¨ç¤ºè¿æ¥é€šäº†ã€‚

```javascript
const eventSource = new EventSource('/events');

eventSource.onopen = function(event) {
    console.log('ğŸ‰ è¿æ¥å»ºç«‹æˆåŠŸï¼');
    console.log('è¿æ¥çŠ¶æ€:', eventSource.readyState); // 1
};
```

**ğŸ’¡ å®é™…åº”ç”¨**
```javascript
eventSource.onopen = function() {
    // è¿æ¥æˆåŠŸåçš„æ“ä½œ
    document.getElementById('status').textContent = 'âœ… å·²è¿æ¥';
    document.getElementById('status').style.color = 'green';
};
```

### 5.2 onmessage - æ¥æ”¶æ¶ˆæ¯äº‹ä»¶


**ğŸ”¸ ä½œç”¨è¯´æ˜**
`onmessage` å°±åƒæ”¶åˆ°å¾®ä¿¡æ¶ˆæ¯çš„æç¤ºéŸ³ï¼Œæ¯æ¬¡æœåŠ¡å™¨å‘æ¶ˆæ¯éƒ½ä¼šè§¦å‘ã€‚

```javascript
eventSource.onmessage = function(event) {
    console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', event.data);
};
```

**ğŸŒŸ å®é™…æ•°æ®å¤„ç†**
```javascript
eventSource.onmessage = function(event) {
    // æ¥æ”¶åˆ°çš„æ•°æ®åœ¨ event.data ä¸­
    const message = event.data;
    
    // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
    const messageDiv = document.createElement('div');
    messageDiv.textContent = `æ”¶åˆ°: ${message}`;
    document.getElementById('messages').appendChild(messageDiv);
};
```

### 5.3 onerror - é”™è¯¯å¤„ç†äº‹ä»¶


**ğŸ”¸ ä½œç”¨è¯´æ˜**
`onerror` å°±åƒæ‰‹æœºæ˜¾ç¤º"æ— ä¿¡å·"ï¼Œè¡¨ç¤ºè¿æ¥å‡ºç°é—®é¢˜ã€‚

```javascript
eventSource.onerror = function(event) {
    console.log('âŒ è¿æ¥å‡ºé”™äº†');
    console.log('é”™è¯¯çŠ¶æ€:', eventSource.readyState);
};
```

**ğŸ’¡ å‹å¥½çš„é”™è¯¯å¤„ç†**
```javascript
eventSource.onerror = function(event) {
    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒé”™è¯¯ä¿¡æ¯
    if (eventSource.readyState === EventSource.CONNECTING) {
        console.log('ğŸ”„ è¿æ¥ä¸­æ–­ï¼Œæ­£åœ¨é‡è¿...');
        document.getElementById('status').textContent = 'ğŸ”„ é‡è¿ä¸­...';
    } else {
        console.log('âŒ è¿æ¥å¤±è´¥');
        document.getElementById('status').textContent = 'âŒ è¿æ¥å¤±è´¥';
    }
};
```

### 5.4 å®Œæ•´çš„äº‹ä»¶å¤„ç†ç¤ºä¾‹


**ğŸ¯ ç»¼åˆåº”ç”¨**
```javascript
const eventSource = new EventSource('/events');

// è¿æ¥å»ºç«‹
eventSource.onopen = function() {
    console.log('ğŸ‰ è¿æ¥æˆåŠŸï¼');
    updateStatus('connected');
};

// æ¥æ”¶æ¶ˆæ¯
eventSource.onmessage = function(event) {
    console.log('ğŸ“¨ æ”¶åˆ°:', event.data);
    displayMessage(event.data);
};

// é”™è¯¯å¤„ç†
eventSource.onerror = function() {
    console.log('âŒ è¿æ¥é”™è¯¯');
    updateStatus('error');
};

// è¾…åŠ©å‡½æ•°
function updateStatus(status) {
    const statusEl = document.getElementById('connection-status');
    const statusText = {
        connected: 'âœ… å·²è¿æ¥',
        error: 'âŒ è¿æ¥é”™è¯¯'
    };
    statusEl.textContent = statusText[status];
}

function displayMessage(data) {
    const messagesEl = document.getElementById('messages');
    messagesEl.innerHTML += `<div>ğŸ“¨ ${data}</div>`;
}
```

---

## 6. ğŸ­ äº‹ä»¶å¯¹è±¡å±æ€§


### 6.1 dataå±æ€§ - æ¶ˆæ¯å†…å®¹


**ğŸ”¸ åŸºæœ¬ç”¨æ³•**
```javascript
eventSource.onmessage = function(event) {
    // event.data å°±æ˜¯æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯å†…å®¹
    console.log('æ¶ˆæ¯å†…å®¹:', event.data);
};
```

**ğŸ’¡ æ•°æ®ç±»å‹è¯´æ˜**
```javascript
// æœåŠ¡å™¨å‘é€çš„éƒ½æ˜¯å­—ç¬¦ä¸²
eventSource.onmessage = function(event) {
    console.log('æ•°æ®ç±»å‹:', typeof event.data); // "string"
    console.log('æ¶ˆæ¯å†…å®¹:', event.data);        // "Hello World"
};
```

### 6.2 lastEventIdå±æ€§ - äº‹ä»¶ID


**ğŸ”¸ ä½œç”¨è¯´æ˜**
`lastEventId` å°±åƒå¿«é€’å•å·ï¼Œç”¨æ¥æ ‡è¯†æ¯ä¸ªæ¶ˆæ¯çš„å”¯ä¸€ç¼–å·ã€‚

```javascript
eventSource.onmessage = function(event) {
    console.log('æ¶ˆæ¯ID:', event.lastEventId);
    console.log('æ¶ˆæ¯å†…å®¹:', event.data);
};
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```javascript
// è®°å½•æœ€åæ”¶åˆ°çš„æ¶ˆæ¯IDï¼Œç”¨äºæ–­çº¿é‡è¿æ—¶æ¢å¤
eventSource.onmessage = function(event) {
    if (event.lastEventId) {
        localStorage.setItem('lastEventId', event.lastEventId);
    }
    console.log('å¤„ç†æ¶ˆæ¯:', event.data);
};
```

### 6.3 typeå±æ€§ - äº‹ä»¶ç±»å‹


**ğŸ”¸ é»˜è®¤äº‹ä»¶ç±»å‹**
```javascript
eventSource.onmessage = function(event) {
    console.log('äº‹ä»¶ç±»å‹:', event.type); // "message"
};
```

### 6.4 addEventListener - è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬


**ğŸ”¸ ç›‘å¬ç‰¹å®šäº‹ä»¶ç±»å‹**
```javascript
// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ç±»å‹
eventSource.addEventListener('notification', function(event) {
    console.log('ğŸ“¢ é€šçŸ¥:', event.data);
});

eventSource.addEventListener('system-update', function(event) {
    console.log('ğŸ”§ ç³»ç»Ÿæ›´æ–°:', event.data);
});
```

**ğŸŒŸ å®Œæ•´çš„äº‹ä»¶å¤„ç†ç¤ºä¾‹**
```javascript
const eventSource = new EventSource('/events');

// é»˜è®¤æ¶ˆæ¯äº‹ä»¶
eventSource.onmessage = function(event) {
    console.log('ğŸ’¬ æ™®é€šæ¶ˆæ¯:', event.data);
};

// è‡ªå®šä¹‰é€šçŸ¥äº‹ä»¶
eventSource.addEventListener('notification', function(event) {
    console.log('ğŸ“¢ é€šçŸ¥æ¶ˆæ¯:', event.data);
    showNotification(event.data);
});

// ç³»ç»ŸçŠ¶æ€äº‹ä»¶
eventSource.addEventListener('status', function(event) {
    console.log('ğŸ“Š çŠ¶æ€æ›´æ–°:', event.data);
    updateSystemStatus(event.data);
});

function showNotification(message) {
    // æ˜¾ç¤ºé€šçŸ¥
    alert(`é€šçŸ¥: ${message}`);
}

function updateSystemStatus(status) {
    // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
    document.getElementById('system-status').textContent = status;
}
```

---

## 7. ğŸ¬ å®æˆ˜æ¼”ç¤ºä¸åº”ç”¨


### 7.1 æ§åˆ¶å°æ—¥å¿—æ¼”ç¤º


**ğŸ”¸ åŸºç¡€æ•°æ®æ¥æ”¶æ¼”ç¤º**
```javascript
// åˆ›å»ºè¿æ¥å¹¶æ¼”ç¤ºæ•°æ®æ¥æ”¶è¿‡ç¨‹
const eventSource = new EventSource('/events');

console.log('ğŸš€ å¼€å§‹EventSourceæ¼”ç¤º');

eventSource.onopen = function() {
    console.log('âœ… è¿æ¥å»ºç«‹æ—¶é—´:', new Date().toLocaleTimeString());
};

eventSource.onmessage = function(event) {
    console.log('ğŸ“¨ æ”¶åˆ°æ•°æ®æ—¶é—´:', new Date().toLocaleTimeString());
    console.log('ğŸ“‹ æ•°æ®å†…å®¹:', event.data);
    console.log('ğŸ†” æ¶ˆæ¯ID:', event.lastEventId || 'æ— ');
    console.log('ğŸ“‚ äº‹ä»¶ç±»å‹:', event.type);
    console.log('---åˆ†å‰²çº¿---');
};

eventSource.onerror = function() {
    console.log('âŒ é”™è¯¯å‘ç”Ÿæ—¶é—´:', new Date().toLocaleTimeString());
    console.log('ğŸ” è¿æ¥çŠ¶æ€:', eventSource.readyState);
};
```

### 7.2 JSONæ•°æ®å¤„ç†æ–¹æ³•


**ğŸ”¸ æ¥æ”¶å’Œè§£æJSONæ•°æ®**
```javascript
eventSource.onmessage = function(event) {
    try {
        // æœåŠ¡å™¨å‘é€çš„JSONå­—ç¬¦ä¸²éœ€è¦è§£æ
        const jsonData = JSON.parse(event.data);
        
        console.log('ğŸ“¦ è§£æåçš„å¯¹è±¡:', jsonData);
        console.log('ğŸ“ æ¶ˆæ¯æ–‡æœ¬:', jsonData.message);
        console.log('â° æ—¶é—´æˆ³:', jsonData.timestamp);
        
        // å¤„ç†ä¸åŒç±»å‹çš„JSONæ¶ˆæ¯
        if (jsonData.type === 'chat') {
            displayChatMessage(jsonData);
        } else if (jsonData.type === 'notification') {
            showNotification(jsonData);
        }
        
    } catch (error) {
        console.log('âŒ JSONè§£æå¤±è´¥:', error);
        console.log('ğŸ“„ åŸå§‹æ•°æ®:', event.data);
    }
};

function displayChatMessage(data) {
    console.log(`ğŸ’¬ [${data.user}]: ${data.message}`);
}

function showNotification(data) {
    console.log(`ğŸ“¢ é€šçŸ¥: ${data.message}`);
}
```

### 7.3 å®æ—¶æ¶ˆæ¯é¢æ¿å®æˆ˜


**ğŸ”¸ åˆ›å»ºå‰ç«¯æ¶ˆæ¯é¢æ¿**

**HTMLç»“æ„**
```html
<div id="message-panel">
    <div id="connection-status">ğŸ”„ è¿æ¥ä¸­...</div>
    <div id="message-count">æ¶ˆæ¯æ•°é‡: 0</div>
    <div id="messages"></div>
    <button onclick="closeConnection()">å…³é—­è¿æ¥</button>
</div>
```

**JavaScriptå®ç°**
```javascript
class MessagePanel {
    constructor() {
        this.messageCount = 0;
        this.eventSource = null;
        this.init();
    }
    
    init() {
        // åˆ›å»ºEventSourceè¿æ¥
        this.eventSource = new EventSource('/events');
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // è¿æ¥å»ºç«‹
        this.eventSource.onopen = () => {
            this.updateStatus('âœ… å·²è¿æ¥', 'green');
            console.log('ğŸ‰ æ¶ˆæ¯é¢æ¿è¿æ¥æˆåŠŸ');
        };
        
        // æ¥æ”¶æ¶ˆæ¯
        this.eventSource.onmessage = (event) => {
            this.handleMessage(event);
        };
        
        // é”™è¯¯å¤„ç†
        this.eventSource.onerror = () => {
            this.updateStatus('âŒ è¿æ¥é”™è¯¯', 'red');
            console.log('âš ï¸ æ¶ˆæ¯é¢æ¿è¿æ¥å‡ºé”™');
        };
    }
    
    handleMessage(event) {
        this.messageCount++;
        
        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
        document.getElementById('message-count').textContent = 
            `æ¶ˆæ¯æ•°é‡: ${this.messageCount}`;
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        const messageDiv = document.createElement('div');
        messageDiv.innerHTML = `
            <div style="border: 1px solid #ccc; margin: 5px; padding: 10px;">
                <strong>æ—¶é—´:</strong> ${new Date().toLocaleTimeString()} <br>
                <strong>å†…å®¹:</strong> ${event.data} <br>
                <strong>ID:</strong> ${event.lastEventId || 'æ— '}
            </div>
        `;
        
        document.getElementById('messages').appendChild(messageDiv);
        
        // æ§åˆ¶å°æ—¥å¿—
        console.log(`ğŸ“¨ ç¬¬${this.messageCount}æ¡æ¶ˆæ¯:`, event.data);
    }
    
    updateStatus(text, color) {
        const statusEl = document.getElementById('connection-status');
        statusEl.textContent = text;
        statusEl.style.color = color;
    }
    
    close() {
        if (this.eventSource) {
            this.eventSource.close();
            this.updateStatus('â­• è¿æ¥å·²å…³é—­', 'gray');
            console.log('ğŸ”š æ¶ˆæ¯é¢æ¿å·²å…³é—­');
        }
    }
}

// åˆ›å»ºæ¶ˆæ¯é¢æ¿å®ä¾‹
const messagePanel = new MessagePanel();

// å…³é—­è¿æ¥çš„å‡½æ•°
function closeConnection() {
    messagePanel.close();
}
```

### 7.4 å®¢æˆ·ç«¯æ—¥å¿—ç¤ºä¾‹æ¼”ç¤º


**ğŸ”¸ è¯¦ç»†æ—¥å¿—è¾“å‡ºç¤ºä¾‹**
```javascript
// åˆ›å»ºå¸¦æœ‰è¯¦ç»†æ—¥å¿—çš„EventSource
function createDetailedEventSource() {
    console.log('ğŸš€ === EventSourceè¯¦ç»†æ¼”ç¤ºå¼€å§‹ ===');
    
    const eventSource = new EventSource('/events');
    
    // è®°å½•åˆ›å»ºä¿¡æ¯
    console.log('ğŸ“‹ EventSourceé…ç½®ä¿¡æ¯:');
    console.log('   URL:', eventSource.url);
    console.log('   withCredentials:', eventSource.withCredentials);
    console.log('   åˆå§‹çŠ¶æ€:', eventSource.readyState);
    
    // è¿æ¥çŠ¶æ€ç›‘æ§
    const statusMonitor = setInterval(() => {
        console.log(`â° [${new Date().toLocaleTimeString()}] å½“å‰çŠ¶æ€: ${eventSource.readyState}`);
    }, 5000);
    
    // è¿æ¥å»ºç«‹äº‹ä»¶
    eventSource.onopen = function(event) {
        console.log('ğŸ‰ === è¿æ¥å»ºç«‹äº‹ä»¶ ===');
        console.log('   è§¦å‘æ—¶é—´:', new Date().toLocaleTimeString());
        console.log('   è¿æ¥çŠ¶æ€:', eventSource.readyState);
        console.log('   äº‹ä»¶å¯¹è±¡:', event);
    };
    
    // æ¶ˆæ¯æ¥æ”¶äº‹ä»¶
    eventSource.onmessage = function(event) {
        console.log('ğŸ“¨ === æ¶ˆæ¯æ¥æ”¶äº‹ä»¶ ===');
        console.log('   æ¥æ”¶æ—¶é—´:', new Date().toLocaleTimeString());
        console.log('   æ¶ˆæ¯å†…å®¹:', event.data);
        console.log('   æ¶ˆæ¯ID:', event.lastEventId);
        console.log('   äº‹ä»¶ç±»å‹:', event.type);
        console.log('   æ•°æ®é•¿åº¦:', event.data.length, 'å­—ç¬¦');
        
        // å°è¯•è§£æJSON
        try {
            const parsed = JSON.parse(event.data);
            console.log('   JSONè§£ææˆåŠŸ:', parsed);
        } catch (e) {
            console.log('   è¿™æ˜¯æ™®é€šæ–‡æœ¬æ¶ˆæ¯');
        }
    };
    
    // é”™è¯¯äº‹ä»¶
    eventSource.onerror = function(event) {
        console.log('âŒ === é”™è¯¯äº‹ä»¶ ===');
        console.log('   é”™è¯¯æ—¶é—´:', new Date().toLocaleTimeString());
        console.log('   è¿æ¥çŠ¶æ€:', eventSource.readyState);
        console.log('   äº‹ä»¶å¯¹è±¡:', event);
        
        if (eventSource.readyState === EventSource.CLOSED) {
            console.log('ğŸ”š è¿æ¥å·²æ°¸ä¹…å…³é—­');
            clearInterval(statusMonitor);
        }
    };
    
    // è¿”å›å®ä¾‹ä¾›å¤–éƒ¨æ§åˆ¶
    return eventSource;
}

// ä½¿ç”¨ç¤ºä¾‹
const detailedEventSource = createDetailedEventSource();

// 5ç§’åå…³é—­è¿æ¥æ¼”ç¤º
setTimeout(() => {
    console.log('ğŸ”š 5ç§’åä¸»åŠ¨å…³é—­è¿æ¥');
    detailedEventSource.close();
    console.log('âœ… è¿æ¥å·²å…³é—­ï¼ŒçŠ¶æ€:', detailedEventSource.readyState);
}, 5000);
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ EventSourceæœ¬è´¨ï¼šæµè§ˆå™¨å†…ç½®çš„æ¶ˆæ¯æ¥æ”¶å™¨
ğŸ”¸ åˆ›å»ºè¯­æ³•ï¼šnew EventSource(url, options)
ğŸ”¸ ä¸‰ç§çŠ¶æ€ï¼šCONNECTING(0)ã€OPEN(1)ã€CLOSED(2)
ğŸ”¸ æ ¸å¿ƒå±æ€§ï¼šurlã€readyStateã€withCredentials
ğŸ”¸ ä¸‰å¤§äº‹ä»¶ï¼šonopenã€onmessageã€onerror
ğŸ”¸ äº‹ä»¶å±æ€§ï¼šdataã€lastEventIdã€type
ğŸ”¸ å…³é—­è¿æ¥ï¼ševentSource.close()
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ EventSourceçš„ç‰¹ç‚¹**
```
è¯­æ³•ç®€å•ï¼š
- åªéœ€ä¸€è¡Œä»£ç åˆ›å»ºè¿æ¥
- è‡ªåŠ¨å¤„ç†é‡è¿æœºåˆ¶
- å†…ç½®é”™è¯¯å¤„ç†

åŠŸèƒ½å¼ºå¤§ï¼š
- è‡ªåŠ¨è§£æSSEæ•°æ®æ ¼å¼
- æ”¯æŒè‡ªå®šä¹‰äº‹ä»¶ç±»å‹
- æä¾›å®Œæ•´çš„çŠ¶æ€ç®¡ç†
```

**ğŸ”¹ æ•°æ®å¤„ç†è¦ç‚¹**
```
æ¥æ”¶çš„æ•°æ®ï¼š
- å§‹ç»ˆæ˜¯å­—ç¬¦ä¸²ç±»å‹
- éœ€è¦æ‰‹åŠ¨è§£æJSON
- é€šè¿‡event.dataè·å–

äº‹ä»¶å¤„ç†ï¼š
- onmessageå¤„ç†æ™®é€šæ¶ˆæ¯
- addEventListenerå¤„ç†è‡ªå®šä¹‰äº‹ä»¶
- onerrorå¤„ç†è¿æ¥é”™è¯¯
```

**ğŸ”¹ è¿æ¥ç®¡ç†è¦ç‚¹**
```
è‡ªåŠ¨é‡è¿ï¼š
- è¿æ¥æ–­å¼€åè‡ªåŠ¨å°è¯•é‡è¿
- onerrorä¼šåœ¨é‡è¿æ—¶è§¦å‘
- æ— éœ€æ‰‹åŠ¨å¤„ç†é‡è¿é€»è¾‘

æ‰‹åŠ¨å…³é—­ï¼š
- è°ƒç”¨close()æ–¹æ³•å…³é—­è¿æ¥
- å…³é—­åä¸ä¼šè‡ªåŠ¨é‡è¿
- çŠ¶æ€å˜ä¸ºCLOSED(2)
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**âœ… é€‚åˆä½¿ç”¨EventSourceçš„åœºæ™¯**
- å®æ—¶é€šçŸ¥æ¨é€
- æ—¥å¿—ç›‘æ§é¢æ¿  
- è¿›åº¦æ¡æ›´æ–°
- è‚¡ç¥¨ä»·æ ¼æ¨é€
- èŠå¤©æ¶ˆæ¯æ¥æ”¶

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
```
é”™è¯¯å¤„ç†ï¼š
- å¿…é¡»æ·»åŠ onerroräº‹ä»¶å¤„ç†
- æ ¹æ®readyStateåˆ¤æ–­å…·ä½“é”™è¯¯ç±»å‹
- æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

æ€§èƒ½ä¼˜åŒ–ï¼š
- åŠæ—¶è°ƒç”¨close()é‡Šæ”¾è¿æ¥
- é¿å…åˆ›å»ºå¤šä¸ªä¸å¿…è¦çš„è¿æ¥
- è€ƒè™‘é¡µé¢åˆ·æ–°æ—¶çš„è¿æ¥å¤„ç†

è°ƒè¯•æŠ€å·§ï¼š
- ä½¿ç”¨console.logè®°å½•è¿æ¥çŠ¶æ€
- æ‰“å°å®Œæ•´çš„eventå¯¹è±¡æŸ¥çœ‹è¯¦æƒ…
- ç›‘æ§readyStateå˜åŒ–è¿‡ç¨‹
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³


```
â“ è¿æ¥ä¸ä¸Šæ€ä¹ˆåŠï¼Ÿ
âœ… æ£€æŸ¥æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®
âœ… ç¡®è®¤æœåŠ¡å™¨æ”¯æŒSSEåè®®
âœ… æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

â“ æ”¶ä¸åˆ°æ¶ˆæ¯æ€ä¹ˆåŠï¼Ÿ
âœ… ç¡®è®¤onmessageäº‹ä»¶å·²ç»‘å®š
âœ… æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®å‘é€æ•°æ®
âœ… æŸ¥çœ‹ç½‘ç»œé¢æ¿çš„è¯·æ±‚çŠ¶æ€

â“ å¦‚ä½•å¤„ç†è·¨åŸŸé—®é¢˜ï¼Ÿ
âœ… æœåŠ¡å™¨è®¾ç½®CORSå¤´éƒ¨
âœ… ä½¿ç”¨withCredentials: trueå‘é€è®¤è¯
âœ… ç¡®ä¿æœåŠ¡å™¨æ”¯æŒè·¨åŸŸSSE
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- EventSourceåˆ›å»ºå¾ˆç®€å•ï¼Œä¸€è¡Œä»£ç è¿æ¥å»ºç«‹
- ä¸‰ç§çŠ¶æ€è¦è®°æ¸…ï¼ŒCONNECTINGåˆ°OPENå†CLOSED  
- ä¸‰å¤§äº‹ä»¶æ˜¯æ ¸å¿ƒï¼Œonopenã€onmessageã€onerror
- æ•°æ®éƒ½åœ¨event.dataï¼ŒJSONéœ€è¦æ‰‹åŠ¨è§£æ
- è‡ªåŠ¨é‡è¿æ˜¯ç‰¹è‰²ï¼Œæ‰‹åŠ¨closeæ‰å½»åº•æ–­å¼€