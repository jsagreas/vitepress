---
title: 4ã€å¸¸è§é—®é¢˜è¯Šæ–­ä¸è§£å†³
---
## ğŸ“š ç›®å½•

1. [è¿æ¥é—®é¢˜è¯Šæ–­ä¸è§£å†³](#1-è¿æ¥é—®é¢˜è¯Šæ–­ä¸è§£å†³)
2. [æ¶ˆæ¯ä¼ è¾“é—®é¢˜å¤„ç†](#2-æ¶ˆæ¯ä¼ è¾“é—®é¢˜å¤„ç†)
3. [æµè§ˆå™¨ç¯å¢ƒé—®é¢˜](#3-æµè§ˆå™¨ç¯å¢ƒé—®é¢˜)
4. [ç½‘ç»œä¸ä»£ç†é—®é¢˜](#4-ç½‘ç»œä¸ä»£ç†é—®é¢˜)
5. [è°ƒè¯•æŠ€å·§ä¸å·¥å…·](#5-è°ƒè¯•æŠ€å·§ä¸å·¥å…·)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”Œ è¿æ¥é—®é¢˜è¯Šæ–­ä¸è§£å†³


### 1.1 è¿æ¥é¢‘ç¹æ–­å¼€é—®é¢˜


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
è¿æ¥å»ºç«‹åå¾ˆå¿«å°±æ–­å¼€ï¼Œä¸æ–­é‡è¿
EventSourceçŠ¶æ€åœ¨openå’Œerrorä¹‹é—´åˆ‡æ¢
æ§åˆ¶å°å‡ºç°å¤§é‡è¿æ¥é”™è¯¯
```

**ğŸ’¡ é—®é¢˜æ ¹æœ¬åŸå› **
SSEæ˜¯**é•¿è¿æ¥**ï¼Œå°±åƒä½ å’Œæœ‹å‹ç…²ç”µè¯ç²¥ä¸€æ ·ï¼Œéœ€è¦ä¿æŒçº¿è·¯ä¸€ç›´é€šç€ã€‚ä½†å¾ˆå¤šç½‘ç»œè®¾å¤‡ï¼ˆè·¯ç”±å™¨ã€é˜²ç«å¢™ã€ä»£ç†æœåŠ¡å™¨ï¼‰ä¼šè®¤ä¸º"å¤ªä¹…æ²¡æ•°æ®ä¼ è¾“äº†ï¼Œè¿™æ¡çº¿è·¯å¯èƒ½åäº†"ï¼Œå°±ä¸»åŠ¨æŠŠè¿æ¥åˆ‡æ–­ã€‚

**ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šå¿ƒè·³åŒ…æœºåˆ¶**

***ä»€ä¹ˆæ˜¯å¿ƒè·³åŒ…ï¼Ÿ***
å¿ƒè·³åŒ…å°±åƒå®šæœŸè¯´"æˆ‘è¿˜æ´»ç€"ä¸€æ ·ï¼Œè®©ç½‘ç»œè®¾å¤‡çŸ¥é“è¿™æ¡è¿æ¥è¿˜åœ¨æ­£å¸¸å·¥ä½œã€‚

```javascript
// å‰ç«¯ï¼šç›‘å¬å¿ƒè·³æ¶ˆæ¯
const eventSource = new EventSource('/events');

eventSource.addEventListener('heartbeat', function(e) {
    console.log('æ”¶åˆ°å¿ƒè·³:', e.data); // æœåŠ¡å™¨è¿˜æ´»ç€
});

eventSource.addEventListener('message', function(e) {
    console.log('ä¸šåŠ¡æ¶ˆæ¯:', e.data);
});
```

```javascript
// åç«¯Node.jsï¼šå®šæœŸå‘é€å¿ƒè·³
app.get('/events', (req, res) => {
    // è®¾ç½®SSEå“åº”å¤´
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive'
    });
    
    // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    const heartbeatInterval = setInterval(() => {
        res.write('event: heartbeat\n');
        res.write('data: ping\n\n');
    }, 30000); // 30ç§’
    
    // æ¸…ç†å®šæ—¶å™¨
    req.on('close', () => {
        clearInterval(heartbeatInterval);
    });
});
```

**ğŸ“Š å¿ƒè·³é—´éš”å»ºè®®**
| ç½‘ç»œç¯å¢ƒ | å»ºè®®é—´éš” | è¯´æ˜ |
|---------|---------|------|
| **å†…ç½‘ç¯å¢ƒ** | `60ç§’` | ç½‘ç»œç¨³å®šï¼Œé—´éš”å¯é•¿ä¸€äº› |
| **å…¬ç½‘ç¯å¢ƒ** | `30ç§’` | ç»è¿‡å¤šå±‚ä»£ç†ï¼Œéœ€è¦é¢‘ç¹å¿ƒè·³ |
| **ç§»åŠ¨ç½‘ç»œ** | `15-20ç§’` | ç½‘ç»œä¸ç¨³å®šï¼Œéœ€è¦æ›´é¢‘ç¹ |

### 1.2 é•¿è¿æ¥è¶…æ—¶é—®é¢˜


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
è¿æ¥å·¥ä½œä¸€æ®µæ—¶é—´åè‡ªåŠ¨æ–­å¼€
æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤ºè¿æ¥è¶…æ—¶
æ²¡æœ‰æ˜æ˜¾çš„é”™è¯¯ä¿¡æ¯
```

**ğŸ’¡ åŸå› åˆ†æ**
å¾ˆå¤šæœåŠ¡å™¨å’Œä»£ç†éƒ½æœ‰**è¶…æ—¶è®¾ç½®**ï¼Œå°±åƒåœè½¦åœºæœ‰æ—¶é—´é™åˆ¶ä¸€æ ·ã€‚å¦‚æœåœ¨è®¾å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®ä¼ è¾“ï¼Œå°±ä¼šå¼ºåˆ¶æ–­å¼€è¿æ¥ã€‚

**ğŸ› ï¸ è§£å†³ç­–ç•¥**

***1. æœåŠ¡å™¨ç«¯è¶…æ—¶é…ç½®***
```javascript
// Node.js Expressè®¾ç½®
app.get('/events', (req, res) => {
    // è®¾ç½®è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆ0è¡¨ç¤ºæ— é™åˆ¶ï¼‰
    req.setTimeout(0);
    res.setTimeout(0);
    
    // è®¾ç½®keep-alive
    req.connection.setTimeout(0);
});
```

***2. Nginxåå‘ä»£ç†é…ç½®***
```nginx
location /events {
    proxy_pass http://backend;
    
    # å…³é”®é…ç½®ï¼šæ”¯æŒSSEçš„è¶…æ—¶è®¾ç½®
    proxy_read_timeout 24h;        # è¯»å–è¶…æ—¶24å°æ—¶
    proxy_send_timeout 24h;        # å‘é€è¶…æ—¶24å°æ—¶
    proxy_connect_timeout 30s;     # è¿æ¥è¶…æ—¶30ç§’
    
    # ç¦ç”¨ç¼“å†²ï¼ˆé‡è¦ï¼ï¼‰
    proxy_buffering off;
    proxy_cache off;
    
    # è®¾ç½®HTTPç‰ˆæœ¬
    proxy_http_version 1.1;
    proxy_set_header Connection "";
}
```

### 1.3 ç½‘ç»œä¸­æ–­å¤„ç†ç­–ç•¥


**ğŸ”¸ æ™ºèƒ½é‡è¿æœºåˆ¶**

***ä»€ä¹ˆæ˜¯æ™ºèƒ½é‡è¿ï¼Ÿ***
å°±åƒæ‰‹æœºä¿¡å·æ–­äº†ä¼šè‡ªåŠ¨é‡æ–°æœç´¢ä¿¡å·ä¸€æ ·ï¼ŒSSEä¹Ÿéœ€è¦åœ¨æ–­ç½‘åè‡ªåŠ¨é‡æ–°è¿æ¥ã€‚

```javascript
class SmartEventSource {
    constructor(url) {
        this.url = url;
        this.reconnectInterval = 1000; // åˆå§‹1ç§’
        this.maxReconnectInterval = 30000; // æœ€å¤§30ç§’
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        
        this.connect();
    }
    
    connect() {
        this.eventSource = new EventSource(this.url);
        
        this.eventSource.onopen = () => {
            console.log('âœ… SSEè¿æ¥æˆåŠŸ');
            // é‡ç½®é‡è¿å‚æ•°
            this.reconnectInterval = 1000;
            this.reconnectAttempts = 0;
        };
        
        this.eventSource.onerror = () => {
            console.log('âŒ SSEè¿æ¥é”™è¯¯');
            this.eventSource.close();
            this.scheduleReconnect();
        };
    }
    
    scheduleReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            console.log(`ğŸ”„ ${this.reconnectInterval/1000}ç§’åé‡è¿...`);
            
            setTimeout(() => {
                this.reconnectAttempts++;
                this.connect();
                
                // é€’å¢é‡è¿é—´éš”ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
                this.reconnectInterval = Math.min(
                    this.reconnectInterval * 2,
                    this.maxReconnectInterval
                );
            }, this.reconnectInterval);
        } else {
            console.log('ğŸ’” è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿');
        }
    }
}

// ä½¿ç”¨æ™ºèƒ½é‡è¿
const smartSSE = new SmartEventSource('/events');
```

---

## 2. ğŸ“¨ æ¶ˆæ¯ä¼ è¾“é—®é¢˜å¤„ç†


### 2.1 æ¶ˆæ¯ä¸¢å¤±é—®é¢˜æ’æŸ¥


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
æœåŠ¡å™¨å‘é€äº†æ¶ˆæ¯ï¼Œä½†å‰ç«¯æ”¶ä¸åˆ°
æ¶ˆæ¯é¡ºåºé”™ä¹±æˆ–éƒ¨åˆ†ä¸¢å¤±
æ•°æ®ä¸å®Œæ•´
```

**ğŸ’¡ æ¶ˆæ¯ä¸¢å¤±çš„å¸¸è§åŸå› **

***1. æ ¼å¼é”™è¯¯å¯¼è‡´è§£æå¤±è´¥***
SSEæ¶ˆæ¯æ ¼å¼éå¸¸ä¸¥æ ¼ï¼Œå°±åƒå†™ä¿¡å¿…é¡»æŒ‰æ ¼å¼å†™åœ°å€ä¸€æ ·ã€‚

```javascript
// âŒ é”™è¯¯æ ¼å¼ - ç¼ºå°‘åŒæ¢è¡Œ
res.write('data: hello world\n');

// âœ… æ­£ç¡®æ ¼å¼ - å¿…é¡»æœ‰åŒæ¢è¡Œ
res.write('data: hello world\n\n');

// âŒ é”™è¯¯æ ¼å¼ - ä¸­æ–‡ç¼–ç é—®é¢˜
res.write('data: ä½ å¥½\n\n');

// âœ… æ­£ç¡®æ ¼å¼ - ç¡®ä¿UTF-8ç¼–ç 
res.write('data: ' + Buffer.from('ä½ å¥½').toString('utf8') + '\n\n');
```

***2. ç¼“å†²åŒºé—®é¢˜***
```javascript
// åç«¯ç¡®ä¿ç«‹å³å‘é€
app.get('/events', (req, res) => {
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'X-Accel-Buffering': 'no', // Nginxä¸ç¼“å†²
    });
    
    // ç«‹å³flushï¼Œç¡®ä¿æ¶ˆæ¯ç«‹å³å‘é€
    setInterval(() => {
        res.write('data: ' + new Date().toISOString() + '\n\n');
        res.flush(); // å¼ºåˆ¶å‘é€ç¼“å†²åŒºå†…å®¹
    }, 1000);
});
```

### 2.2 é‡å¤æ¶ˆæ¯å¤„ç†æœºåˆ¶


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
åŒä¸€æ¡æ¶ˆæ¯æ”¶åˆ°å¤šæ¬¡
é‡è¿åæ”¶åˆ°æ—§æ¶ˆæ¯
æ¶ˆæ¯IDæ··ä¹±
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šæ¶ˆæ¯å»é‡**

***ä»€ä¹ˆæ˜¯æ¶ˆæ¯å»é‡ï¼Ÿ***
å°±åƒå¿«é€’åŒ…è£¹æœ‰å•å·ä¸€æ ·ï¼Œç»™æ¯æ¡æ¶ˆæ¯ä¸€ä¸ªå”¯ä¸€IDï¼Œæ”¶åˆ°é‡å¤IDçš„æ¶ˆæ¯å°±å¿½ç•¥ã€‚

```javascript
// åç«¯ï¼šå‘é€å¸¦IDçš„æ¶ˆæ¯
let messageId = 0;

function sendMessage(res, data) {
    messageId++;
    res.write(`id: ${messageId}\n`);
    res.write(`data: ${JSON.stringify(data)}\n\n`);
}

// å‰ç«¯ï¼šæ¶ˆæ¯å»é‡å¤„ç†
class MessageHandler {
    constructor() {
        this.receivedIds = new Set(); // è®°å½•å·²æ”¶åˆ°çš„æ¶ˆæ¯ID
    }
    
    handleMessage(event) {
        const messageId = event.lastEventId;
        
        // æ£€æŸ¥æ˜¯å¦å·²æ”¶åˆ°è¿‡è¿™æ¡æ¶ˆæ¯
        if (this.receivedIds.has(messageId)) {
            console.log('ğŸ”„ é‡å¤æ¶ˆæ¯ï¼Œå¿½ç•¥:', messageId);
            return;
        }
        
        // è®°å½•æ¶ˆæ¯ID
        this.receivedIds.add(messageId);
        
        // å¤„ç†æ–°æ¶ˆæ¯
        console.log('ğŸ“¨ æ–°æ¶ˆæ¯:', event.data);
        
        // æ¸…ç†æ—§IDï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
        if (this.receivedIds.size > 1000) {
            const oldIds = Array.from(this.receivedIds).slice(0, 500);
            oldIds.forEach(id => this.receivedIds.delete(id));
        }
    }
}
```

### 2.3 æ¶ˆæ¯å»¶è¿Ÿé—®é¢˜å¤„ç†


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
æ¶ˆæ¯å‘é€åå¾ˆä¹…æ‰æ”¶åˆ°
å®æ—¶æ€§è¦æ±‚æ— æ³•æ»¡è¶³
æ¶ˆæ¯å †ç§¯ç°è±¡
```

**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**

***1. æœåŠ¡å™¨ç«¯ä¼˜åŒ–***
```javascript
// ä½¿ç”¨äº‹ä»¶é©±åŠ¨ï¼Œå‡å°‘è½®è¯¢
const EventEmitter = require('events');
const messageEmitter = new EventEmitter();

app.get('/events', (req, res) => {
    // SSEè®¾ç½®
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
    });
    
    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
    const messageHandler = (data) => {
        res.write(`data: ${JSON.stringify(data)}\n\n`);
    };
    
    messageEmitter.on('newMessage', messageHandler);
    
    // è¿æ¥å…³é—­æ—¶æ¸…ç†
    req.on('close', () => {
        messageEmitter.off('newMessage', messageHandler);
    });
});

// å…¶ä»–åœ°æ–¹è§¦å‘æ¶ˆæ¯å‘é€
function broadcastMessage(message) {
    messageEmitter.emit('newMessage', message);
}
```

---

## 3. ğŸŒ æµè§ˆå™¨ç¯å¢ƒé—®é¢˜


### 3.1 æµè§ˆå™¨ç¼“å­˜å½±å“å¤„ç†


**ğŸ”¸ é—®é¢˜ç°è±¡**
```
ä¿®æ”¹ä»£ç åè¿˜æ˜¯æ—§çš„è¡Œä¸º
æ¶ˆæ¯å†…å®¹ä¸æ›´æ–°
è¿æ¥ä½¿ç”¨ç¼“å­˜çš„å“åº”
```

**ğŸ’¡ ç¼“å­˜é—®é¢˜è§£é‡Š**
æµè§ˆå™¨ä¼šç¼“å­˜èµ„æºæ¥æé«˜æ€§èƒ½ï¼Œå°±åƒä½ æŠŠå¸¸ç”¨çš„ä¸œè¥¿æ”¾åœ¨æ‰‹è¾¹ä¸€æ ·ã€‚ä½†å¯¹äºå®æ—¶æ•°æ®ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æœ‰ç¼“å­˜ã€‚

**ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ**

***1. æœåŠ¡å™¨ç«¯ç¦ç”¨ç¼“å­˜***
```javascript
app.get('/events', (req, res) => {
    res.writeHead(200, {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0',
        'Connection': 'keep-alive'
    });
});
```

***2. å‰ç«¯æ·»åŠ æ—¶é—´æˆ³***
```javascript
// åœ¨URLä¸­æ·»åŠ æ—¶é—´æˆ³ï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°è¯·æ±‚
const timestamp = Date.now();
const eventSource = new EventSource(`/events?t=${timestamp}`);
```

### 3.2 ç§»åŠ¨ç«¯å…¼å®¹æ€§å¤„ç†


**ğŸ”¸ ç§»åŠ¨ç«¯ç‰¹æ®Šé—®é¢˜**
```
å±å¹•é”å®šåè¿æ¥æ–­å¼€
åº”ç”¨åˆ‡æ¢åˆ°åå°æ—¶SSEåœæ­¢
ç§»åŠ¨ç½‘ç»œä¸ç¨³å®šå¯¼è‡´é¢‘ç¹æ–­è¿
```

**ğŸ”§ ç§»åŠ¨ç«¯ä¼˜åŒ–ç­–ç•¥**

***1. é¡µé¢å¯è§æ€§æ£€æµ‹***
```javascript
class MobileSSE {
    constructor(url) {
        this.url = url;
        this.eventSource = null;
        this.isPageVisible = true;
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            this.isPageVisible = !document.hidden;
            
            if (this.isPageVisible) {
                console.log('ğŸ“± é¡µé¢é‡æ–°å¯è§ï¼Œé‡è¿SSE');
                this.reconnect();
            } else {
                console.log('ğŸ“± é¡µé¢éšè—ï¼Œä¿æŒè¿æ¥ä½†åœæ­¢å¿ƒè·³');
            }
        });
        
        this.connect();
    }
    
    connect() {
        this.eventSource = new EventSource(this.url);
        
        this.eventSource.addEventListener('message', (e) => {
            // åªåœ¨é¡µé¢å¯è§æ—¶å¤„ç†æ¶ˆæ¯
            if (this.isPageVisible) {
                this.handleMessage(e);
            }
        });
    }
    
    reconnect() {
        if (this.eventSource) {
            this.eventSource.close();
        }
        this.connect();
    }
}
```

---

## 4. ğŸŒ ç½‘ç»œä¸ä»£ç†é—®é¢˜


### 4.1 ä»£ç†æœåŠ¡å™¨é—®é¢˜è§£å†³


**ğŸ”¸ å¸¸è§ä»£ç†é—®é¢˜**
```
ä¼ä¸šé˜²ç«å¢™é˜»æ­¢SSEè¿æ¥
CDNä¸æ”¯æŒæµå¼å“åº”
è´Ÿè½½å‡è¡¡å™¨é…ç½®ä¸å½“
```

**ğŸ› ï¸ Nginxä»£ç†é…ç½®ä¼˜åŒ–**

***ä»€ä¹ˆæ˜¯åå‘ä»£ç†ï¼Ÿ***
å°±åƒé…’åº—å‰å°ä¸€æ ·ï¼Œå®¢æˆ·ä¸ç›´æ¥è”ç³»å…·ä½“æœåŠ¡å‘˜ï¼Œè€Œæ˜¯é€šè¿‡å‰å°è½¬è¾¾ã€‚Nginxå°±æ˜¯è¿™ä¸ª"å‰å°"ï¼Œå¸®å¿™è½¬å‘SSEè¯·æ±‚ã€‚

```nginx
# Nginxé…ç½®æ”¯æŒSSE
server {
    listen 80;
    server_name your-domain.com;
    
    location /events {
        proxy_pass http://backend-server;
        
        # ğŸ”‘ å…³é”®é…ç½®ï¼šæ”¯æŒSSE
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # âš¡ ç¦ç”¨ç¼“å†²ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
        proxy_buffering off;
        proxy_cache off;
        
        # â° è¶…æ—¶è®¾ç½®
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;
        proxy_connect_timeout 30s;
        
        # ğŸ”„ ä¿æŒè¿æ¥
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # ğŸ“± æ”¯æŒè·¨åŸŸï¼ˆå¦‚æœéœ€è¦ï¼‰
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Headers "Cache-Control";
    }
}
```

### 4.2 CDNå…¼å®¹æ€§é—®é¢˜


**ğŸ”¸ CDNé—®é¢˜ç°è±¡**
```
é€šè¿‡CDNè®¿é—®SSEæ— å“åº”
æ¶ˆæ¯å»¶è¿Ÿä¸¥é‡
è¿æ¥ç»å¸¸è¢«é‡ç½®
```

**ğŸ’¡ CDNé—®é¢˜è§£é‡Š**
CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰å°±åƒå¿«é€’ä¸­è½¬ç«™ï¼Œä¸»è¦æ˜¯ä¸ºäº†åŠ é€Ÿé™æ€å†…å®¹ï¼ˆå›¾ç‰‡ã€CSSã€JSï¼‰çš„ä¼ è¾“ã€‚ä½†SSEæ˜¯**åŠ¨æ€å®æ—¶æ•°æ®æµ**ï¼ŒCDNå¯èƒ½ä¸çŸ¥é“æ€ä¹ˆå¤„ç†ã€‚

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**

***1. ç»•è¿‡CDN***
```javascript
// ç›´æ¥è¿æ¥æºæœåŠ¡å™¨ï¼Œä¸èµ°CDN
const eventSource = new EventSource('https://origin-server.com/events');

// æˆ–è€…ä½¿ç”¨ä¸“é—¨çš„å­åŸŸå
const eventSource = new EventSource('https://sse.your-domain.com/events');
```

***2. CDNé…ç½®ä¼˜åŒ–***
```javascript
// åœ¨CDNæ§åˆ¶å°è®¾ç½®ï¼š
// - ç¦ç”¨å¯¹ /events è·¯å¾„çš„ç¼“å­˜
// - è®¾ç½® Cache-Control: no-cache
// - å¯ç”¨æµå¼å“åº”æ”¯æŒ
```

---

## 5. ğŸ” è°ƒè¯•æŠ€å·§ä¸å·¥å…·


### 5.1 æµè§ˆå™¨æ§åˆ¶å°è°ƒè¯•æ–¹æ³•


**ğŸ”¸ EventSourceçŠ¶æ€æ£€æŸ¥**

***å¦‚ä½•æŸ¥çœ‹SSEçŠ¶æ€ï¼Ÿ***
æ‰“å¼€æµè§ˆå™¨çš„**å¼€å‘è€…å·¥å…·**ï¼Œå°±åƒåŒ»ç”Ÿç”¨å¬è¯Šå™¨æ£€æŸ¥èº«ä½“ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥"å¬"SSEçš„"å¿ƒè·³"ã€‚

```javascript
// åˆ›å»ºSSEè¿æ¥
const eventSource = new EventSource('/events');

// ğŸŸ¢ è¿æ¥æˆåŠŸçŠ¶æ€
eventSource.onopen = function(event) {
    console.log('âœ… SSEçŠ¶æ€: OPEN');
    console.log('è¿æ¥å°±ç»ªçŠ¶æ€:', eventSource.readyState); // 1
};

// ğŸ”´ è¿æ¥é”™è¯¯çŠ¶æ€
eventSource.onerror = function(event) {
    console.log('âŒ SSEçŠ¶æ€: ERROR');
    console.log('è¿æ¥å°±ç»ªçŠ¶æ€:', eventSource.readyState); // 2
    console.log('é”™è¯¯è¯¦æƒ…:', event);
};

// ğŸ“¨ æ¶ˆæ¯æ¥æ”¶çŠ¶æ€
eventSource.onmessage = function(event) {
    console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', event.data);
    console.log('æ¶ˆæ¯ID:', event.lastEventId);
    console.log('æ¶ˆæ¯ç±»å‹:', event.type);
};

// æ‰‹åŠ¨æ£€æŸ¥è¿æ¥çŠ¶æ€
function checkSSEStatus() {
    const states = ['CONNECTING', 'OPEN', 'CLOSED'];
    console.log('å½“å‰SSEçŠ¶æ€:', states[eventSource.readyState]);
    
    switch(eventSource.readyState) {
        case 0:
            console.log('ğŸ”„ æ­£åœ¨è¿æ¥...');
            break;
        case 1:
            console.log('âœ… è¿æ¥å·²å»ºç«‹');
            break;
        case 2:
            console.log('âŒ è¿æ¥å·²å…³é—­');
            break;
    }
}
```

### 5.2 ç½‘ç»œé¢æ¿è°ƒè¯•æŠ€å·§


**ğŸ”¸ åœ¨Chrome DevToolsä¸­æŸ¥çœ‹SSE**

***1. Networké¢æ¿æŸ¥çœ‹***
```
1. æ‰“å¼€Chrome DevTools
2. åˆ‡æ¢åˆ° Network é¢æ¿
3. åˆ·æ–°é¡µé¢æˆ–å»ºç«‹SSEè¿æ¥
4. æ‰¾åˆ° /events è¯·æ±‚ï¼ˆé€šå¸¸æ˜¾ç¤ºä¸º "Pending" çŠ¶æ€ï¼‰
5. ç‚¹å‡»è¯¥è¯·æ±‚ï¼ŒæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯

å…³é”®ä¿¡æ¯ï¼š
- Status: 200ï¼ˆæ­£å¸¸ï¼‰
- Type: text/event-stream
- Response: å¯ä»¥çœ‹åˆ°å®æ—¶æ¥æ”¶çš„æ•°æ®æµ
```

***2. Consoleé¢æ¿ç›‘æ§***
```javascript
// åœ¨Consoleä¸­è¾“å…¥ä»¥ä¸‹ä»£ç è¿›è¡Œè°ƒè¯•
window.debugSSE = function() {
    const es = new EventSource('/events');
    
    es.addEventListener('message', e => {
        console.log('ğŸ“¨ æ¶ˆæ¯:', e.data);
    });
    
    es.addEventListener('error', e => {
        console.error('âŒ é”™è¯¯:', e);
    });
    
    // è¿”å›EventSourceå¯¹è±¡ä¾›è¿›ä¸€æ­¥è°ƒè¯•
    return es;
};

// ä½¿ç”¨ï¼šconst mySSE = debugSSE();
```

### 5.3 å®¢æˆ·ç«¯æ— æ³•æ¥æ”¶æ¶ˆæ¯çš„æ’æŸ¥æµç¨‹


**ğŸ”¸ ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•**

***æ’æŸ¥æ£€æŸ¥æ¸…å•ï¼š***

```javascript
// ğŸ“‹ SSEé—®é¢˜æ’æŸ¥æ¸…å•
class SSEDiagnostic {
    static async runDiagnostic(url) {
        console.log('ğŸ” å¼€å§‹SSEè¯Šæ–­...\n');
        
        // 1ï¸âƒ£ æ£€æŸ¥URLå¯è®¿é—®æ€§
        try {
            const response = await fetch(url);
            console.log('âœ… 1. URLå¯è®¿é—®');
            console.log('   çŠ¶æ€ç :', response.status);
            console.log('   Content-Type:', response.headers.get('content-type'));
        } catch (error) {
            console.error('âŒ 1. URLæ— æ³•è®¿é—®:', error.message);
            return;
        }
        
        // 2ï¸âƒ£ æ£€æŸ¥å“åº”å¤´
        const es = new EventSource(url);
        
        es.onopen = () => {
            console.log('âœ… 2. SSEè¿æ¥å»ºç«‹æˆåŠŸ');
        };
        
        es.onerror = (error) => {
            console.error('âŒ 2. SSEè¿æ¥å¤±è´¥');
            console.error('   readyState:', es.readyState);
        };
        
        // 3ï¸âƒ£ æ£€æŸ¥æ¶ˆæ¯æ¥æ”¶
        let messageCount = 0;
        es.onmessage = (event) => {
            messageCount++;
            console.log(`âœ… 3. æ”¶åˆ°ç¬¬${messageCount}æ¡æ¶ˆæ¯`);
            console.log('   å†…å®¹:', event.data.substring(0, 100) + '...');
        };
        
        // 4ï¸âƒ£ 10ç§’åæ£€æŸ¥ç»“æœ
        setTimeout(() => {
            console.log('\nğŸ“Š è¯Šæ–­ç»“æœæ±‡æ€»:');
            console.log(`   è¿æ¥çŠ¶æ€: ${es.readyState === 1 ? 'æ­£å¸¸' : 'å¼‚å¸¸'}`);
            console.log(`   æ”¶åˆ°æ¶ˆæ¯: ${messageCount} æ¡`);
            
            if (messageCount === 0 && es.readyState === 1) {
                console.log('âš ï¸  è¿æ¥æ­£å¸¸ä½†æ— æ¶ˆæ¯ï¼Œæ£€æŸ¥æœåŠ¡å™¨ç«¯æ˜¯å¦å‘é€æ•°æ®');
            }
        }, 10000);
        
        return es;
    }
}

// ä½¿ç”¨æ–¹æ³•ï¼šSSEDiagnostic.runDiagnostic('/events');
```

### 5.4 æœåŠ¡å™¨ç«¯æ•°æ®æ ¼å¼éªŒè¯


**ğŸ”¸ æ¶ˆæ¯æ ¼å¼æ£€æŸ¥å·¥å…·**

```javascript
// æœåŠ¡å™¨ç«¯ï¼šæ¶ˆæ¯æ ¼å¼éªŒè¯å·¥å…·
class SSEFormatter {
    static validateMessage(message) {
        const errors = [];
        
        // æ£€æŸ¥æ˜¯å¦ä»¥åŒæ¢è¡Œç»“å°¾
        if (!message.endsWith('\n\n')) {
            errors.push('æ¶ˆæ¯å¿…é¡»ä»¥åŒæ¢è¡Œ(\\n\\n)ç»“å°¾');
        }
        
        // æ£€æŸ¥å­—æ®µæ ¼å¼
        const lines = message.split('\n');
        for (let line of lines) {
            if (line && !line.match(/^(data|event|id|retry):/)) {
                if (line.trim() !== '') {
                    errors.push(`æ— æ•ˆè¡Œæ ¼å¼: ${line}`);
                }
            }
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }
    
    static formatMessage(data, eventType = null, id = null) {
        let message = '';
        
        if (id) {
            message += `id: ${id}\n`;
        }
        
        if (eventType) {
            message += `event: ${eventType}\n`;
        }
        
        // å¤„ç†å¤šè¡Œæ•°æ®
        const dataLines = String(data).split('\n');
        for (let line of dataLines) {
            message += `data: ${line}\n`;
        }
        
        message += '\n'; // ç»“æŸæ ‡è®°
        
        // éªŒè¯æ ¼å¼
        const validation = this.validateMessage(message);
        if (!validation.isValid) {
            console.warn('âš ï¸  SSEæ¶ˆæ¯æ ¼å¼é—®é¢˜:', validation.errors);
        }
        
        return message;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const message = SSEFormatter.formatMessage('Hello World', 'greeting', '123');
console.log('æ ¼å¼åŒ–åçš„æ¶ˆæ¯:');
console.log(JSON.stringify(message)); // æŸ¥çœ‹å®é™…æ ¼å¼
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ•…éšœæ’æŸ¥æŠ€èƒ½


```
ğŸ”§ è¿æ¥é—®é¢˜ï¼š
â€¢ å¿ƒè·³åŒ…æœºåˆ¶ - æ¯30ç§’å‘é€pingä¿æŒè¿æ¥
â€¢ æ™ºèƒ½é‡è¿ - æŒ‡æ•°é€€é¿ç®—æ³•é¿å…æœåŠ¡å™¨å‹åŠ›
â€¢ è¶…æ—¶é…ç½® - æœåŠ¡å™¨å’Œä»£ç†çš„è¶…æ—¶è®¾ç½®

ğŸ“¨ æ¶ˆæ¯é—®é¢˜ï¼š
â€¢ æ ¼å¼ä¸¥æ ¼ - å¿…é¡»ä»¥\n\nç»“å°¾
â€¢ æ¶ˆæ¯å»é‡ - ä½¿ç”¨IDé¿å…é‡å¤å¤„ç†
â€¢ ç¼–ç æ­£ç¡® - ç¡®ä¿UTF-8ç¼–ç 

ğŸŒ ç¯å¢ƒé—®é¢˜ï¼š
â€¢ ç¼“å­˜æ§åˆ¶ - ç¦ç”¨æµè§ˆå™¨å’Œä»£ç†ç¼“å­˜
â€¢ ä»£ç†é…ç½® - Nginxéœ€è¦ç‰¹æ®Šé…ç½®æ”¯æŒSSE
â€¢ ç§»åŠ¨ç«¯é€‚é… - å¤„ç†é¡µé¢åˆ‡æ¢å’Œç½‘ç»œåˆ‡æ¢
```

### 6.2 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸ¯ ç¨³å®šæ€§ä¿éšœ**
- **å¿ƒè·³æœºåˆ¶**ï¼š30ç§’é—´éš”ï¼Œç»´æŒé•¿è¿æ¥
- **æ™ºèƒ½é‡è¿**ï¼š1-30ç§’é€’å¢é—´éš”ï¼Œæœ€å¤šé‡è¯•10æ¬¡
- **æ¶ˆæ¯å»é‡**ï¼šä½¿ç”¨IDæœºåˆ¶é˜²æ­¢é‡å¤å¤„ç†
- **çŠ¶æ€ç›‘æ§**ï¼šå®æ—¶ç›‘æ§è¿æ¥çŠ¶æ€å’Œæ¶ˆæ¯ä¼ è¾“

**ğŸ”§ é—®é¢˜é¢„é˜²**
- **æ ¼å¼éªŒè¯**ï¼šæœåŠ¡ç«¯éªŒè¯æ¶ˆæ¯æ ¼å¼æ­£ç¡®æ€§
- **ç¼“å­˜æ§åˆ¶**ï¼šæ˜ç¡®ç¦ç”¨æ‰€æœ‰çº§åˆ«çš„ç¼“å­˜
- **ä»£ç†ä¼˜åŒ–**ï¼šé…ç½®Nginxç­‰ä»£ç†æœåŠ¡å™¨æ”¯æŒSSE
- **ç§»åŠ¨ç«¯é€‚é…**ï¼šå¤„ç†é¡µé¢åˆ‡æ¢å’Œç½‘ç»œç¯å¢ƒå˜åŒ–

**ğŸ’¡ è°ƒè¯•æŠ€å·§**
- **æ§åˆ¶å°ç›‘æ§**ï¼šä½¿ç”¨æµè§ˆå™¨DevToolsæŸ¥çœ‹è¿æ¥çŠ¶æ€
- **ç½‘ç»œé¢æ¿**ï¼šè§‚å¯Ÿè¯·æ±‚å“åº”å’Œæ•°æ®æµ
- **ç³»ç»Ÿè¯Šæ–­**ï¼šè¿è¡Œè‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬
- **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•è¿æ¥å’Œæ¶ˆæ¯ä¼ è¾“æ—¥å¿—

### 6.3 æ ¸å¿ƒè®°å¿†è¦ç‚¹


**ğŸ§  æ•…éšœæ’æŸ¥æ€è·¯**
```
1ï¸âƒ£ å…ˆæ£€æŸ¥è¿æ¥ - readyStateæ˜¯å¦ä¸º1(OPEN)
2ï¸âƒ£ å†æ£€æŸ¥æ ¼å¼ - æ¶ˆæ¯æ˜¯å¦ä»¥\n\nç»“å°¾
3ï¸âƒ£ æŸ¥çœ‹ç½‘ç»œ - Networké¢æ¿æ˜¯å¦æœ‰è¯·æ±‚
4ï¸âƒ£ æ£€æŸ¥ä»£ç† - Nginx/CDNé…ç½®æ˜¯å¦æ­£ç¡®
5ï¸âƒ£ éªŒè¯ç¼–ç  - ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦æ˜¯å¦æ­£ç¡®
```

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæ ¸å¿ƒé…ç½®**
- **æœåŠ¡ç«¯**ï¼šç¦ç”¨ç¼“å†²ã€è®¾ç½®è¶…æ—¶ã€å‘é€å¿ƒè·³
- **ä»£ç†ç«¯**ï¼šproxy_buffering offã€é•¿è¶…æ—¶æ—¶é—´
- **å®¢æˆ·ç«¯**ï¼šæ™ºèƒ½é‡è¿ã€çŠ¶æ€ç›‘æ§ã€é”™è¯¯å¤„ç†

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è¿æ¥æ–­å¼€æŸ¥å¿ƒè·³ï¼Œæ¶ˆæ¯ä¸¢å¤±çœ‹æ ¼å¼
- ä»£ç†ç¼“å†²è¦å…³é—­ï¼Œç§»åŠ¨ç«¯è®°å¾—é‡è¿
- æ§åˆ¶å°æ˜¯å¥½æœ‹å‹ï¼Œç½‘ç»œé¢æ¿æ˜¾çœŸç›¸