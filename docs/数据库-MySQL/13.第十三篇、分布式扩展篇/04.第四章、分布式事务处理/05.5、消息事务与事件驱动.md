---
title: 5ã€æ¶ˆæ¯äº‹åŠ¡ä¸äº‹ä»¶é©±åŠ¨
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ](#1-æ¶ˆæ¯äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ)
2. [äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€](#2-äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€)
3. [å¯é æ¶ˆæ¯æŠ•é€’æœºåˆ¶](#3-å¯é æ¶ˆæ¯æŠ•é€’æœºåˆ¶)
4. [æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ä¸é…ç½®](#4-æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ä¸é…ç½®)
5. [äº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼](#5-äº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼)
6. [æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ](#6-æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ)
7. [å¤±è´¥é‡è¯•ä¸ç›‘æ§ç­–ç•¥](#7-å¤±è´¥é‡è¯•ä¸ç›‘æ§ç­–ç•¥)
8. [é«˜çº§æ¶æ„æ¨¡å¼](#8-é«˜çº§æ¶æ„æ¨¡å¼)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¨ æ¶ˆæ¯äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯äº‹åŠ¡


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
æ¶ˆæ¯äº‹åŠ¡æ˜¯æŒ‡é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥åè°ƒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªæœåŠ¡ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç”¨"å‘æ¶ˆæ¯"çš„æ–¹å¼æ¥ç¡®ä¿ä¸åŒç³»ç»Ÿä¹‹é—´çš„æ•°æ®ä¿æŒåŒæ­¥ã€‚

```
ä¼ ç»Ÿé—®é¢˜ï¼š
ç”¨æˆ·ä¸‹å• â†’ æ‰£åº“å­˜ â†’ æ‰£ä½™é¢ â†’ å‘è´§
å¦‚æœæ‰£ä½™é¢å¤±è´¥äº†ï¼Œå‰é¢çš„æ“ä½œæ€ä¹ˆå›æ»šï¼Ÿ

æ¶ˆæ¯äº‹åŠ¡è§£å†³ï¼š
ç”¨æˆ·ä¸‹å• â†’ å‘é€"è®¢å•åˆ›å»º"æ¶ˆæ¯
åº“å­˜æœåŠ¡æ”¶åˆ°æ¶ˆæ¯ â†’ æ‰£åº“å­˜ â†’ å‘é€"åº“å­˜å·²æ‰£"æ¶ˆæ¯  
æ”¯ä»˜æœåŠ¡æ”¶åˆ°æ¶ˆæ¯ â†’ æ‰£ä½™é¢ â†’ å‘é€"æ”¯ä»˜å®Œæˆ"æ¶ˆæ¯
ç‰©æµæœåŠ¡æ”¶åˆ°æ¶ˆæ¯ â†’ å®‰æ’å‘è´§
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒæ¥åŠ›èµ›è·‘ï¼Œæ¯ä¸ªäººè·‘å®Œè‡ªå·±çš„æ£’æ¬¡åï¼ŒæŠŠæ¥åŠ›æ£’ä¼ ç»™ä¸‹ä¸€ä¸ªäººï¼Œå¦‚æœä¸­é€”æœ‰äººæ‘”å€’äº†ï¼Œå¯ä»¥é‡æ–°å¼€å§‹è¿™ä¸€æ£’

### 1.2 æ¶ˆæ¯äº‹åŠ¡çš„æ ¸å¿ƒåŸç†


**ğŸ”„ åŸºæœ¬å·¥ä½œæµç¨‹**
```
æ­¥éª¤1ï¸âƒ£ æœ¬åœ°äº‹åŠ¡ + æ¶ˆæ¯å‘é€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼€å§‹æœ¬åœ°äº‹åŠ¡        â”‚
â”‚ â”œâ”€ æ‰§è¡Œä¸šåŠ¡æ“ä½œ     â”‚ 
â”‚ â”œâ”€ å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—   â”‚
â”‚ â””â”€ æäº¤æœ¬åœ°äº‹åŠ¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤2ï¸âƒ£ æ¶ˆæ¯æ¶ˆè´¹å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯      â”‚
â”‚ â”œâ”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘     â”‚
â”‚ â”œâ”€ ç¡®è®¤æ¶ˆæ¯å¤„ç†æˆåŠŸ â”‚ 
â”‚ â””â”€ æ¶ˆæ¯ä»é˜Ÿåˆ—åˆ é™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš–ï¸ ä¸€è‡´æ€§ä¿è¯æœºåˆ¶**
- **At Least Once**ï¼šæ¶ˆæ¯è‡³å°‘è¢«å¤„ç†ä¸€æ¬¡ï¼Œå¯èƒ½é‡å¤
- **At Most Once**ï¼šæ¶ˆæ¯æœ€å¤šè¢«å¤„ç†ä¸€æ¬¡ï¼Œå¯èƒ½ä¸¢å¤±
- **Exactly Once**ï¼šæ¶ˆæ¯æ°å¥½è¢«å¤„ç†ä¸€æ¬¡ï¼Œç†æƒ³çŠ¶æ€

> ğŸ“Œ **å…³é”®ç†è§£**ï¼šæ¶ˆæ¯äº‹åŠ¡ä¸æ˜¯å¼ºä¸€è‡´æ€§ï¼Œè€Œæ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚å°±åƒé“¶è¡Œè½¬è´¦ï¼Œå¯èƒ½å‡ åˆ†é’Ÿåæ‰åˆ°è´¦ï¼Œä½†æœ€ç»ˆä¸€å®šä¼šä¸€è‡´

---

## 2. ğŸ—ï¸ äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€


### 2.1 äº‹ä»¶é©±åŠ¨æ¶æ„åŸç†


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**
äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEDAï¼‰æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„æ¨¡å¼ï¼Œç³»ç»Ÿä¸­çš„ç»„ä»¶é€šè¿‡äº§ç”Ÿå’Œå“åº”äº‹ä»¶æ¥è¿›è¡Œé€šä¿¡ã€‚

```
ä¼ ç»Ÿè°ƒç”¨æ¨¡å¼ï¼š
æœåŠ¡A â”€â”€ç›´æ¥è°ƒç”¨â”€â”€â†’ æœåŠ¡B â”€â”€ç›´æ¥è°ƒç”¨â”€â”€â†’ æœåŠ¡C
é—®é¢˜ï¼šå¼ºè€¦åˆï¼ŒæœåŠ¡Bæ•…éšœä¼šå½±å“æ•´ä¸ªé“¾è·¯

äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼š
æœåŠ¡A â”€â”€å‘å¸ƒäº‹ä»¶â”€â”€â†’ äº‹ä»¶æ€»çº¿ â”€â”€è®¢é˜…äº‹ä»¶â”€â”€â†’ æœåŠ¡B
                    â†“
                æœåŠ¡Cä¹Ÿèƒ½è®¢é˜…åŒä¸€äº‹ä»¶
```

**ğŸ”¸ äº‹ä»¶é©±åŠ¨çš„ä¼˜åŠ¿**
```
âœ… æ¾è€¦åˆï¼šæœåŠ¡ä¹‹é—´ä¸ç›´æ¥ä¾èµ–
âœ… å¯æ‰©å±•ï¼šæ–°æœåŠ¡å¯ä»¥è½»æ¾è®¢é˜…å·²æœ‰äº‹ä»¶
âœ… å¼‚æ­¥å¤„ç†ï¼šæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦
âœ… å®¹é”™æ€§ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¶ä»–æœåŠ¡
```

### 2.2 äº‹ä»¶çš„åŸºæœ¬ç»“æ„


**ğŸ“¦ æ ‡å‡†äº‹ä»¶æ ¼å¼**
```json
{
  "eventId": "uuid-1234-5678",
  "eventType": "OrderCreated", 
  "eventTime": "2025-09-09T15:30:00Z",
  "source": "order-service",
  "data": {
    "orderId": "ORDER-001",
    "userId": "USER-123", 
    "amount": 299.99,
    "items": [...]
  }
}
```

**ğŸ”‘ äº‹ä»¶å±æ€§è§£é‡Š**
- **eventId**ï¼šäº‹ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå»é‡
- **eventType**ï¼šäº‹ä»¶ç±»å‹ï¼Œè¯´æ˜å‘ç”Ÿäº†ä»€ä¹ˆ
- **eventTime**ï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´
- **source**ï¼šäº‹ä»¶çš„æ¥æºæœåŠ¡
- **data**ï¼šäº‹ä»¶æºå¸¦çš„å…·ä½“æ•°æ®

### 2.3 äº‹ä»¶ç±»å‹åˆ†ç±»


```
ğŸ”¸ ä¸šåŠ¡äº‹ä»¶ï¼ˆBusiness Eventsï¼‰
- è®¢å•åˆ›å»ºã€æ”¯ä»˜å®Œæˆã€å•†å“ä¸Šæ¶
- ç›´æ¥åæ˜ ä¸šåŠ¡çŠ¶æ€å˜åŒ–

ğŸ”¸ ç³»ç»Ÿäº‹ä»¶ï¼ˆSystem Eventsï¼‰  
- æœåŠ¡å¯åŠ¨ã€æœåŠ¡ä¸‹çº¿ã€é…ç½®æ›´æ–°
- åæ˜ ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å˜åŒ–

ğŸ”¸ é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰
- ç”¨æˆ·æ³¨å†Œã€ä¼šå‘˜å‡çº§ã€ç§¯åˆ†å˜åŒ–
- åæ˜ é¢†åŸŸæ¨¡å‹çŠ¶æ€å˜åŒ–
```

---

## 3. ğŸš€ å¯é æ¶ˆæ¯æŠ•é€’æœºåˆ¶


### 3.1 å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼


**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**
ç¡®ä¿æ¶ˆæ¯ä¸€å®šèƒ½è¢«æŠ•é€’åˆ°ç›®æ ‡ç³»ç»Ÿï¼Œå³ä½¿ç½‘ç»œæ•…éšœæˆ–ç³»ç»Ÿä¸´æ—¶ä¸å¯ç”¨ã€‚

```
å¯é æŠ•é€’ä¿è¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘é€æ–¹                                  â”‚
â”‚ â”œâ”€ æœ¬åœ°äº‹åŠ¡æäº¤                         â”‚
â”‚ â”œâ”€ æ¶ˆæ¯æŒä¹…åŒ–åˆ°æœ¬åœ°                     â”‚ 
â”‚ â”œâ”€ å¼‚æ­¥å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—                   â”‚
â”‚ â””â”€ ç¡®è®¤å‘é€æˆåŠŸååˆ é™¤æœ¬åœ°æ¶ˆæ¯           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆæ¯é˜Ÿåˆ—                                â”‚
â”‚ â”œâ”€ æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨                       â”‚
â”‚ â”œâ”€ æ”¯æŒé‡å¤æŠ•é€’                         â”‚
â”‚ â””â”€ æ¶ˆè´¹ç¡®è®¤æœºåˆ¶                         â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¥æ”¶æ–¹                                  â”‚
â”‚ â”œâ”€ å¹‚ç­‰æ€§æ£€æŸ¥                           â”‚
â”‚ â”œâ”€ æœ¬åœ°äº‹åŠ¡å¤„ç†                         â”‚
â”‚ â””â”€ ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¶ˆæ¯å‘é€ç«¯ä¿éšœ


**ğŸ” å‘é€ç«¯å¯é æ€§è®¾è®¡**
```java
// æœ¬åœ°æ¶ˆæ¯è¡¨æ¨¡å¼
@Transactional
public void createOrder(Order order) {
    // 1. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
    orderRepository.save(order);
    
    // 2. ä¿å­˜æ¶ˆæ¯åˆ°æœ¬åœ°è¡¨ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
    LocalMessage message = new LocalMessage(
        "OrderCreated", 
        order.toJson(),
        MessageStatus.PENDING
    );
    messageRepository.save(message);
    
    // 3. äº‹åŠ¡æäº¤åï¼Œå¼‚æ­¥å‘é€æ¶ˆæ¯
    // é€šè¿‡å®šæ—¶ä»»åŠ¡æˆ–ç›‘å¬å™¨å‘é€
}

// å¼‚æ­¥å‘é€æ¶ˆæ¯
@Async
public void sendMessage(LocalMessage message) {
    try {
        messageQueue.send(message.getContent());
        // å‘é€æˆåŠŸï¼Œæ ‡è®°ä¸ºå·²å‘é€
        message.setStatus(MessageStatus.SENT);
        messageRepository.save(message);
    } catch (Exception e) {
        // å‘é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯•
        message.setRetryCount(message.getRetryCount() + 1);
        messageRepository.save(message);
    }
}
```

> ğŸ“Œ **é‡ç‚¹ç†è§£**ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ç¡®ä¿äº†ä¸šåŠ¡æ“ä½œå’Œæ¶ˆæ¯å‘é€åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥

### 3.3 æ¶ˆæ¯æ¥æ”¶ç«¯ä¿éšœ


**âœ… æ¥æ”¶ç«¯å¹‚ç­‰æ€§å¤„ç†**
```java
@MessageListener("order.created")
public void handleOrderCreated(String messageId, OrderCreatedEvent event) {
    // 1. å¹‚ç­‰æ€§æ£€æŸ¥
    if (processedMessageRepository.exists(messageId)) {
        log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: {}", messageId);
        return;
    }
    
    try {
        // 2. å¼€å¯æœ¬åœ°äº‹åŠ¡
        transactionTemplate.execute(status -> {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            inventoryService.deductStock(event.getItems());
            
            // è®°å½•æ¶ˆæ¯å·²å¤„ç†
            processedMessageRepository.save(new ProcessedMessage(messageId));
            
            return null;
        });
        
        // 3. ç¡®è®¤æ¶ˆæ¯æ¶ˆè´¹
        acknowledgeMessage(messageId);
        
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æŠ•é€’
        log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥: {}", messageId, e);
        throw e;
    }
}
```

---

## 4. ğŸ› ï¸ æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹ä¸é…ç½®


### 4.1 ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”


| ç‰¹æ€§å¯¹æ¯” | **RabbitMQ** | **Apache Kafka** | **RocketMQ** | **ActiveMQ** |
|---------|-------------|-----------------|-------------|-------------|
| **æ€§èƒ½** | `ä¸­ç­‰(ä¸‡çº§TPS)` | `æé«˜(åä¸‡çº§TPS)` | `é«˜(åä¸‡çº§TPS)` | `ä¸­ç­‰(ä¸‡çº§TPS)` |
| **å¯é æ€§** | `é«˜` | `é«˜` | `æé«˜` | `ä¸­ç­‰` |
| **å­¦ä¹ éš¾åº¦** | `ç®€å•` | `å¤æ‚` | `ä¸­ç­‰` | `ç®€å•` |
| **äº‹åŠ¡æ”¯æŒ** | `æ”¯æŒ` | `æœ‰é™æ”¯æŒ` | `å¼ºæ”¯æŒ` | `æ”¯æŒ` |
| **é€‚ç”¨åœºæ™¯** | `ä¸­å°å‹ç³»ç»Ÿ` | `å¤§æ•°æ®æµå¤„ç†` | `é‡‘èæ”¯ä»˜` | `ä¼ä¸šé›†æˆ` |

### 4.2 æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹å†³ç­–çŸ©é˜µ


```
ğŸ¯ é€‰æ‹©RabbitMQçš„åœºæ™¯ï¼š
âœ… ä¸­å°å‹é¡¹ç›®ï¼Œè¿½æ±‚å¼€å‘æ•ˆç‡
âœ… éœ€è¦å¤æ‚çš„æ¶ˆæ¯è·¯ç”±
âœ… å›¢é˜ŸæŠ€æœ¯æ ˆåå‘ç®€å•æ˜“ç”¨
âœ… æ¶ˆæ¯é‡ä¸æ˜¯ç‰¹åˆ«å¤§ï¼ˆæ—¥å¤„ç†é‡ < 1000ä¸‡ï¼‰

ğŸ¯ é€‰æ‹©Kafkaçš„åœºæ™¯ï¼š
âœ… å¤§æ•°æ®é‡ï¼Œé«˜åååœºæ™¯
âœ… æµæ•°æ®å¤„ç†å’Œåˆ†æ
âœ… æ—¥å¿—æ”¶é›†å’Œæ•°æ®ç®¡é“
âœ… å¯¹å»¶è¿Ÿè¦æ±‚ä¸æ˜¯ç‰¹åˆ«ä¸¥æ ¼

ğŸ¯ é€‰æ‹©RocketMQçš„åœºæ™¯ï¼š
âœ… é‡‘èã€æ”¯ä»˜ç­‰å¯¹å¯é æ€§è¦æ±‚æé«˜
âœ… éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ
âœ… é˜¿é‡Œäº‘ç”Ÿæ€æˆ–JavaæŠ€æœ¯æ ˆ
âœ… é¡ºåºæ¶ˆæ¯å’Œå®šæ—¶æ¶ˆæ¯éœ€æ±‚
```

### 4.3 RabbitMQäº‹åŠ¡é…ç½®ç¤ºä¾‹


**âš™ï¸ åŸºç¡€é…ç½®**
```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public RabbitTransactionManager transactionManager(
            ConnectionFactory connectionFactory) {
        return new RabbitTransactionManager(connectionFactory);
    }
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        // å¼€å¯äº‹åŠ¡æ”¯æŒ
        template.setChannelTransacted(true);
        // å¼€å¯å‘é€ç¡®è®¤
        template.setMandatory(true);
        return template;
    }
}

// äº‹åŠ¡å‘é€æ¶ˆæ¯
@Service
public class OrderMessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Transactional("transactionManager")
    public void sendOrderMessage(Order order) {
        // å‘é€æ¶ˆæ¯ï¼ˆåœ¨äº‹åŠ¡ä¸­ï¼‰
        rabbitTemplate.convertAndSend(
            "order.exchange", 
            "order.created", 
            order
        );
    }
}
```

---

## 5. ğŸ“¡ äº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼


### 5.1 å‘å¸ƒè®¢é˜…åŸºæœ¬åŸç†


**ğŸ”„ Pub/Subæ¨¡å¼å·¥ä½œæµç¨‹**
```
å‘å¸ƒè€…ï¼ˆPublisherï¼‰                è®¢é˜…è€…ï¼ˆSubscriberï¼‰
       â†“                              â†‘
   å‘å¸ƒäº‹ä»¶                        æ¥æ”¶äº‹ä»¶
       â†“                              â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            äº‹ä»¶æ€»çº¿/æ¶ˆæ¯ä»£ç†              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Topic A â”‚  â”‚ Topic B â”‚  â”‚ Topic C â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                              â†“
   å¤šä¸ªå‘å¸ƒè€…                        å¤šä¸ªè®¢é˜…è€…
```

**ğŸ¯ è®¢é˜…æ¨¡å¼åˆ†ç±»**
```
ğŸ”¸ ä¸»é¢˜è®¢é˜…ï¼ˆTopic Subscriptionï¼‰
- è®¢é˜…ç‰¹å®šä¸»é¢˜çš„æ‰€æœ‰æ¶ˆæ¯
- ç¤ºä¾‹ï¼šè®¢é˜…"order.*"ä¸»é¢˜

ğŸ”¸ å†…å®¹è¿‡æ»¤è®¢é˜…ï¼ˆContent-based Subscriptionï¼‰  
- æ ¹æ®æ¶ˆæ¯å†…å®¹è¿›è¡Œè¿‡æ»¤
- ç¤ºä¾‹ï¼šåªè®¢é˜…é‡‘é¢>1000çš„è®¢å•äº‹ä»¶

ğŸ”¸ æ¨¡å¼åŒ¹é…è®¢é˜…ï¼ˆPattern-based Subscriptionï¼‰
- ä½¿ç”¨é€šé…ç¬¦æ¨¡å¼è®¢é˜…
- ç¤ºä¾‹ï¼šè®¢é˜…"*.created"æ‰€æœ‰åˆ›å»ºäº‹ä»¶
```

### 5.2 äº‹ä»¶å‘å¸ƒå®ç°


**ğŸ“¤ Spring Eventå‘å¸ƒç¤ºä¾‹**
```java
// å®šä¹‰äº‹ä»¶
public class OrderCreatedEvent extends ApplicationEvent {
    private final Order order;
    
    public OrderCreatedEvent(Object source, Order order) {
        super(source);
        this.order = order;
    }
    
    public Order getOrder() { return order; }
}

// å‘å¸ƒäº‹ä»¶
@Service
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public void createOrder(Order order) {
        // 1. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        orderRepository.save(order);
        
        // 2. å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(new OrderCreatedEvent(this, order));
    }
}
```

### 5.3 äº‹ä»¶è®¢é˜…å®ç°


**ğŸ“¥ å¤šä¸ªæœåŠ¡è®¢é˜…åŒä¸€äº‹ä»¶**
```java
// åº“å­˜æœåŠ¡è®¢é˜…
@Component
public class InventoryEventHandler {
    
    @EventListener
    @Async  // å¼‚æ­¥å¤„ç†
    public void handleOrderCreated(OrderCreatedEvent event) {
        Order order = event.getOrder();
        log.info("åº“å­˜æœåŠ¡å¤„ç†è®¢å•: {}", order.getId());
        
        // æ‰£å‡åº“å­˜
        inventoryService.deductStock(order.getItems());
    }
}

// æ”¯ä»˜æœåŠ¡è®¢é˜…
@Component  
public class PaymentEventHandler {
    
    @EventListener
    @Async
    public void handleOrderCreated(OrderCreatedEvent event) {
        Order order = event.getOrder();
        log.info("æ”¯ä»˜æœåŠ¡å¤„ç†è®¢å•: {}", order.getId());
        
        // åˆ›å»ºæ”¯ä»˜è®¢å•
        paymentService.createPayment(order);
    }
}

// é€šçŸ¥æœåŠ¡è®¢é˜…
@Component
public class NotificationEventHandler {
    
    @EventListener
    @Async
    public void handleOrderCreated(OrderCreatedEvent event) {
        Order order = event.getOrder();
        log.info("é€šçŸ¥æœåŠ¡å¤„ç†è®¢å•: {}", order.getId());
        
        // å‘é€é€šçŸ¥
        notificationService.sendOrderNotification(order);
    }
}
```

> ğŸ’¡ **å…³é”®ä¼˜åŠ¿**ï¼šä¸€ä¸ªäº‹ä»¶å¯ä»¥è¢«å¤šä¸ªæœåŠ¡åŒæ—¶è®¢é˜…ï¼Œæ–°å¢æœåŠ¡æ—¶åªéœ€è¦æ·»åŠ è®¢é˜…è€…ï¼Œä¸éœ€è¦ä¿®æ”¹å‘å¸ƒè€…ä»£ç 

---

## 6. ğŸ›¡ï¸ æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ


### 6.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯å¹‚ç­‰æ€§


**ğŸ“‹ å¹‚ç­‰æ€§å®šä¹‰**
å¹‚ç­‰æ€§æ˜¯æŒ‡åŒä¸€ä¸ªæ“ä½œæ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·çš„ã€‚åœ¨æ¶ˆæ¯å¤„ç†ä¸­ï¼Œå°±æ˜¯åŒä¸€æ¡æ¶ˆæ¯è¢«å¤„ç†å¤šæ¬¡ï¼Œæœ€ç»ˆæ•ˆæœå’Œå¤„ç†ä¸€æ¬¡ä¸€æ ·ã€‚

```
å¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š
SET user_status = 'ACTIVE' WHERE user_id = 123
â†‘ æ‰§è¡Œå¤šæ¬¡ç»“æœä¸€æ ·

éå¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š  
UPDATE account_balance = account_balance + 100 WHERE user_id = 123
â†‘ æ‰§è¡Œå¤šæ¬¡ä¼šç´¯åŠ ï¼Œç»“æœä¸åŒ
```

> âš ï¸ **ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§**ï¼šç½‘ç»œä¸ç¨³å®šå¯èƒ½å¯¼è‡´æ¶ˆæ¯é‡å¤æŠ•é€’ï¼Œå¦‚æœä¸åšå¹‚ç­‰å¤„ç†ï¼Œå¯èƒ½é€ æˆé‡å¤æ‰£æ¬¾ã€é‡å¤å‘è´§ç­‰ä¸¥é‡é—®é¢˜

### 6.2 å¹‚ç­‰æ€§å®ç°ç­–ç•¥


**ğŸ”‘ ä¸»è¦å®ç°æ–¹æ¡ˆ**

```
ç­–ç•¥1ï¸âƒ£ å”¯ä¸€é”®çº¦æŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“è¡¨å¢åŠ å”¯ä¸€ç´¢å¼•                â”‚
â”‚ CREATE UNIQUE INDEX idx_order_id     â”‚
â”‚ ON orders(order_id)                 â”‚
â”‚                                     â”‚
â”‚ é‡å¤æ’å…¥ä¼šæŠ¥é”™ï¼Œç¨‹åºæ•è·å¼‚å¸¸å¤„ç†    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç­–ç•¥2ï¸âƒ£ åˆ†å¸ƒå¼é”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨Redisåˆ†å¸ƒå¼é”                   â”‚
â”‚ SET order:123 "processing" NX EX 300â”‚
â”‚                                     â”‚
â”‚ åŒä¸€è®¢å•åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç­–ç•¥3ï¸âƒ£ å¹‚ç­‰è¡¨è®°å½•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸“é—¨çš„å¹‚ç­‰è¡¨è®°å½•å¤„ç†çŠ¶æ€            â”‚
â”‚ INSERT INTO idempotent_records      â”‚
â”‚ (message_id, status, create_time)   â”‚
â”‚                                     â”‚
â”‚ å¤„ç†å‰å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å¹‚ç­‰æ€§å®ç°ä»£ç 


**ğŸ› ï¸ Redisåˆ†å¸ƒå¼é”å®ç°**
```java
@Service
public class IdempotentMessageProcessor {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean processMessage(String messageId, Runnable processor) {
        String lockKey = "message:lock:" + messageId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // å°è¯•è·å–åˆ†å¸ƒå¼é”ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
            Boolean acquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofMinutes(5));
                
            if (!acquired) {
                log.info("æ¶ˆæ¯æ­£åœ¨å¤„ç†ä¸­: {}", messageId);
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
            String processedKey = "message:processed:" + messageId;
            if (redisTemplate.hasKey(processedKey)) {
                log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡: {}", messageId);
                return true;
            }
            
            // æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘
            processor.run();
            
            // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆ24å°æ—¶è¿‡æœŸï¼‰
            redisTemplate.opsForValue()
                .set(processedKey, "1", Duration.ofHours(24));
            
            return true;
            
        } finally {
            // é‡Šæ”¾é”
            String currentValue = redisTemplate.opsForValue().get(lockKey);
            if (lockValue.equals(currentValue)) {
                redisTemplate.delete(lockKey);
            }
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@MessageListener("order.payment")
public void handlePayment(String messageId, PaymentEvent event) {
    idempotentProcessor.processMessage(messageId, () -> {
        // å…·ä½“çš„æ”¯ä»˜å¤„ç†é€»è¾‘
        paymentService.processPayment(event.getOrderId(), event.getAmount());
    });
}
```

**ğŸ“Š å¹‚ç­‰è¡¨å®ç°**
```java
// å¹‚ç­‰è®°å½•è¡¨
@Entity
public class IdempotentRecord {
    @Id
    private String messageId;
    private String businessType;
    private String status; // PROCESSING, SUCCESS, FAILED
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}

// å¹‚ç­‰å¤„ç†æœåŠ¡
@Service
@Transactional
public class IdempotentService {
    
    public boolean tryProcess(String messageId, String businessType, 
                             Supplier<Boolean> processor) {
        // 1. å°è¯•æ’å…¥å¤„ç†è®°å½•
        try {
            IdempotentRecord record = new IdempotentRecord();
            record.setMessageId(messageId);
            record.setBusinessType(businessType);
            record.setStatus("PROCESSING");
            record.setCreateTime(LocalDateTime.now());
            
            idempotentRepository.save(record);
        } catch (DuplicateKeyException e) {
            // è®°å½•å·²å­˜åœ¨ï¼Œæ£€æŸ¥çŠ¶æ€
            IdempotentRecord existing = idempotentRepository
                .findByMessageId(messageId);
            return "SUCCESS".equals(existing.getStatus());
        }
        
        try {
            // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            boolean success = processor.get();
            
            // 3. æ›´æ–°å¤„ç†çŠ¶æ€
            idempotentRepository.updateStatus(messageId, 
                success ? "SUCCESS" : "FAILED");
                
            return success;
        } catch (Exception e) {
            idempotentRepository.updateStatus(messageId, "FAILED");
            throw e;
        }
    }
}
```

---

## 7. ğŸ”„ å¤±è´¥é‡è¯•ä¸ç›‘æ§ç­–ç•¥


### 7.1 å¤±è´¥é‡è¯•æœºåˆ¶è®¾è®¡


**ğŸ¯ é‡è¯•ç­–ç•¥ç±»å‹**
```
ğŸ”¸ ç«‹å³é‡è¯•ï¼ˆImmediate Retryï¼‰
- å¤±è´¥åç«‹å³é‡è¯•
- é€‚ç”¨ï¼šå¶å‘æ€§ç½‘ç»œæŠ–åŠ¨
- ç¼ºç‚¹ï¼šå¯èƒ½åŠ é‡ç³»ç»Ÿè´Ÿæ‹…

ğŸ”¸ å›ºå®šé—´éš”é‡è¯•ï¼ˆFixed Intervalï¼‰
- æ¯éš”å›ºå®šæ—¶é—´é‡è¯•ä¸€æ¬¡
- ç¤ºä¾‹ï¼šæ¯30ç§’é‡è¯•ä¸€æ¬¡
- é€‚ç”¨ï¼šç³»ç»Ÿä¸´æ—¶ä¸å¯ç”¨

ğŸ”¸ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆExponential Backoffï¼‰
- é‡è¯•é—´éš”é€æ¸å¢é•¿
- ç¤ºä¾‹ï¼š1ç§’ã€2ç§’ã€4ç§’ã€8ç§’...
- é€‚ç”¨ï¼šç³»ç»Ÿè´Ÿè½½è¿‡é«˜æƒ…å†µ

ğŸ”¸ çº¿æ€§é€€é¿é‡è¯•ï¼ˆLinear Backoffï¼‰  
- é‡è¯•é—´éš”çº¿æ€§å¢é•¿
- ç¤ºä¾‹ï¼š1ç§’ã€2ç§’ã€3ç§’ã€4ç§’...
- é€‚ç”¨ï¼šä¸€èˆ¬çš„ç³»ç»Ÿæ¢å¤åœºæ™¯
```

### 7.2 é‡è¯•æœºåˆ¶å®ç°


**âš™ï¸ Spring Retryé…ç½®**
```java
@Configuration
@EnableRetry
public class RetryConfig {
    
    @Bean
    public RetryTemplate retryTemplate() {
        RetryTemplate template = new RetryTemplate();
        
        // é‡è¯•ç­–ç•¥ï¼šæœ€å¤šé‡è¯•3æ¬¡
        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();
        retryPolicy.setMaxAttempts(3);
        template.setRetryPolicy(retryPolicy);
        
        // é€€é¿ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ï¼Œåˆå§‹1ç§’ï¼Œæœ€å¤§10ç§’
        ExponentialBackOffPolicy backOffPolicy = new ExponentialBackOffPolicy();
        backOffPolicy.setInitialInterval(1000);
        backOffPolicy.setMaxInterval(10000);
        backOffPolicy.setMultiplier(2.0);
        template.setBackOffPolicy(backOffPolicy);
        
        return template;
    }
}

// ä½¿ç”¨é‡è¯•æœºåˆ¶
@Service
public class MessageProcessorService {
    
    @Retryable(
        value = {Exception.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public void processMessage(MessageEvent event) {
        try {
            // å…·ä½“ä¸šåŠ¡å¤„ç†
            businessService.process(event.getData());
        } catch (BusinessException e) {
            log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: {}", event.getId(), e);
            throw e;
        }
    }
    
    @Recover
    public void recover(Exception e, MessageEvent event) {
        // é‡è¯•å¤±è´¥åçš„å…œåº•å¤„ç†
        log.error("æ¶ˆæ¯å¤„ç†æœ€ç»ˆå¤±è´¥: {}", event.getId(), e);
        
        // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—æˆ–äººå·¥å¤„ç†é˜Ÿåˆ—
        deadLetterService.sendToDeadLetter(event);
    }
}
```

### 7.3 æ­»ä¿¡é˜Ÿåˆ—å¤„ç†


**ğŸ’€ æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶**
```
æ­£å¸¸æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š
æ¶ˆæ¯é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…å¤„ç† â†’ å¤„ç†æˆåŠŸ â†’ æ¶ˆæ¯åˆ é™¤

å¼‚å¸¸å¤„ç†æµç¨‹ï¼š
æ¶ˆæ¯é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…å¤„ç† â†’ å¤„ç†å¤±è´¥ â†’ é‡è¯•Næ¬¡ â†’ ä»å¤±è´¥ â†’ æ­»ä¿¡é˜Ÿåˆ—

æ­»ä¿¡é˜Ÿåˆ—ä½œç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿å­˜å¤„ç†å¤±è´¥çš„æ¶ˆæ¯                  â”‚
â”‚ â”œâ”€ é¿å…æ¶ˆæ¯ä¸¢å¤±                     â”‚
â”‚ â”œâ”€ æ”¯æŒäººå·¥æ’æŸ¥                     â”‚
â”‚ â”œâ”€ å¯ä»¥é‡æ–°æŠ•é€’åˆ°åŸé˜Ÿåˆ—             â”‚
â”‚ â””â”€ ç»Ÿè®¡åˆ†æå¤±è´¥åŸå›                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ› ï¸ RabbitMQæ­»ä¿¡é˜Ÿåˆ—é…ç½®**
```java
@Configuration
public class DeadLetterConfig {
    
    @Bean
    public Queue orderQueue() {
        return QueueBuilder.durable("order.queue")
            // è®¾ç½®æ­»ä¿¡äº¤æ¢æœº
            .withArgument("x-dead-letter-exchange", "order.dlx")
            .withArgument("x-dead-letter-routing-key", "order.dead")
            // æ¶ˆæ¯TTLï¼š5åˆ†é’Ÿ
            .withArgument("x-message-ttl", 300000)
            .build();
    }
    
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("order.dead.queue").build();
    }
    
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("order.dlx");
    }
}

// æ­»ä¿¡æ¶ˆæ¯å¤„ç†
@Component
public class DeadLetterHandler {
    
    @RabbitListener(queues = "order.dead.queue")
    public void handleDeadLetter(@Payload String message, 
                                @Header Map<String, Object> headers) {
        log.error("æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯: {}", message);
        log.error("æ­»ä¿¡åŸå› : {}", headers.get("x-first-death-reason"));
        
        // è®°å½•åˆ°æ•°æ®åº“ï¼Œä¾›äººå·¥å¤„ç†
        deadLetterRecordService.save(message, headers);
        
        // å¯é€‰ï¼šå‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendDeadLetterAlert(message);
    }
}
```

### 7.4 ç›‘æ§ç­–ç•¥å®ç°


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```
ğŸ”¸ æ¶ˆæ¯å¤„ç†æ€§èƒ½æŒ‡æ ‡
- æ¶ˆæ¯å¤„ç†TPSï¼ˆæ¯ç§’å¤„ç†é‡ï¼‰
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿï¼ˆP99ã€P95ã€å¹³å‡å€¼ï¼‰
- æ¶ˆæ¯ç§¯å‹é‡ï¼ˆé˜Ÿåˆ—æ·±åº¦ï¼‰

ğŸ”¸ æ¶ˆæ¯å¯é æ€§æŒ‡æ ‡  
- æ¶ˆæ¯æˆåŠŸç‡ï¼ˆå¤„ç†æˆåŠŸ/æ€»æ¶ˆæ¯æ•°ï¼‰
- é‡è¯•æ¬¡æ•°åˆ†å¸ƒ
- æ­»ä¿¡æ¶ˆæ¯æ•°é‡

ğŸ”¸ ç³»ç»Ÿå¥åº·æŒ‡æ ‡
- æ¶ˆè´¹è€…å­˜æ´»çŠ¶æ€
- æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥çŠ¶æ€  
- å†…å­˜å’ŒCPUä½¿ç”¨ç‡
```

**ğŸ“ˆ ç›‘æ§å®ç°ç¤ºä¾‹**
```java
@Component
public class MessageMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter successCounter;
    private final Counter failureCounter;
    private final Timer processingTimer;
    
    public MessageMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.successCounter = Counter.builder("message.processed.success")
            .description("æˆåŠŸå¤„ç†çš„æ¶ˆæ¯æ•°")
            .register(meterRegistry);
        this.failureCounter = Counter.builder("message.processed.failure")
            .description("å¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ•°")
            .register(meterRegistry);
        this.processingTimer = Timer.builder("message.processing.duration")
            .description("æ¶ˆæ¯å¤„ç†è€—æ—¶")
            .register(meterRegistry);
    }
    
    public void recordSuccess(String messageType) {
        successCounter.increment(Tags.of("type", messageType));
    }
    
    public void recordFailure(String messageType, String errorType) {
        failureCounter.increment(Tags.of("type", messageType, "error", errorType));
    }
    
    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }
}

// åœ¨æ¶ˆæ¯å¤„ç†ä¸­ä½¿ç”¨ç›‘æ§
@MessageListener("order.created")
public void handleOrderCreated(OrderCreatedEvent event) {
    Timer.Sample sample = messageMetrics.startTimer();
    
    try {
        // å¤„ç†æ¶ˆæ¯
        orderProcessingService.process(event);
        
        // è®°å½•æˆåŠŸ
        messageMetrics.recordSuccess("OrderCreated");
        
    } catch (Exception e) {
        // è®°å½•å¤±è´¥
        messageMetrics.recordFailure("OrderCreated", e.getClass().getSimpleName());
        throw e;
    } finally {
        // è®°å½•å¤„ç†æ—¶é—´
        sample.stop(messageMetrics.getProcessingTimer());
    }
}
```

---

## 8. ğŸ›ï¸ é«˜çº§æ¶æ„æ¨¡å¼


### 8.1 äº‹ä»¶æº¯æºä¸CQRSç»“åˆ


**ğŸ“š äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰æ¦‚å¿µ**
äº‹ä»¶æº¯æºæ˜¯ä¸€ç§æ•°æ®æŒä¹…åŒ–æ–¹å¼ï¼Œä¸ç›´æ¥å­˜å‚¨å½“å‰çŠ¶æ€ï¼Œè€Œæ˜¯å­˜å‚¨å¯¼è‡´å½“å‰çŠ¶æ€çš„æ‰€æœ‰äº‹ä»¶åºåˆ—ã€‚

```
ä¼ ç»Ÿæ–¹å¼å­˜å‚¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¡¨          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ ID: 123         â”‚
â”‚ å§“å: å¼ ä¸‰      â”‚  â† åªä¿å­˜æœ€ç»ˆçŠ¶æ€
â”‚ ä½™é¢: 1000      â”‚
â”‚ çŠ¶æ€: æ´»è·ƒ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº‹ä»¶æº¯æºæ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶æµ                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 1. ç”¨æˆ·åˆ›å»º(å¼ ä¸‰, åˆå§‹ä½™é¢500)      â”‚
â”‚ 2. å……å€¼äº‹ä»¶(+600)                  â”‚  â† ä¿å­˜æ‰€æœ‰å†å²äº‹ä»¶
â”‚ 3. æ¶ˆè´¹äº‹ä»¶(-100)                  â”‚
â”‚ 4. çŠ¶æ€å˜æ›´(æ´»è·ƒ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”„ CQRSï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰åŸç†**
```
ä¼ ç»Ÿæ¶æ„ï¼š
åº”ç”¨ â†â†’ åŒä¸€ä¸ªæ•°æ®æ¨¡å‹ â†â†’ æ•°æ®åº“

CQRSæ¶æ„ï¼š
åº”ç”¨ â†’ å‘½ä»¤æ¨¡å‹ï¼ˆå†™æ“ä½œï¼‰â†’ äº‹ä»¶å­˜å‚¨
     â†“
     äº‹ä»¶æµ â†’ æŸ¥è¯¢æ¨¡å‹ï¼ˆè¯»æ“ä½œï¼‰â†’ æŸ¥è¯¢æ•°æ®åº“
```

### 8.2 äº‹ä»¶æº¯æºå®ç°ç¤ºä¾‹


**ğŸ“ äº‹ä»¶å®šä¹‰**
```java
// åŸºç¡€äº‹ä»¶æ¥å£
public interface DomainEvent {
    String getAggregateId();
    LocalDateTime getOccurredOn();
    String getEventType();
}

// å…·ä½“äº‹ä»¶å®ç°
public class AccountCreatedEvent implements DomainEvent {
    private String accountId;
    private String ownerName;
    private BigDecimal initialBalance;
    private LocalDateTime occurredOn;
    
    // æ„é€ å™¨å’Œgetteræ–¹æ³•...
}

public class MoneyDepositedEvent implements DomainEvent {
    private String accountId;
    private BigDecimal amount;
    private LocalDateTime occurredOn;
    
    // æ„é€ å™¨å’Œgetteræ–¹æ³•...
}
```

**ğŸ—ï¸ èšåˆæ ¹å®ç°**
```java
public class Account {
    private String accountId;
    private String ownerName;
    private BigDecimal balance;
    private List<DomainEvent> uncommittedEvents;
    
    // ä»äº‹ä»¶æµé‡å»ºèšåˆçŠ¶æ€
    public static Account fromEvents(List<DomainEvent> events) {
        Account account = new Account();
        for (DomainEvent event : events) {
            account.apply(event);
        }
        return account;
    }
    
    // åº”ç”¨äº‹ä»¶åˆ°èšåˆçŠ¶æ€
    private void apply(DomainEvent event) {
        if (event instanceof AccountCreatedEvent) {
            AccountCreatedEvent e = (AccountCreatedEvent) event;
            this.accountId = e.getAccountId();
            this.ownerName = e.getOwnerName();
            this.balance = e.getInitialBalance();
        } else if (event instanceof MoneyDepositedEvent) {
            MoneyDepositedEvent e = (MoneyDepositedEvent) event;
            this.balance = this.balance.add(e.getAmount());
        }
        // å¤„ç†å…¶ä»–äº‹ä»¶ç±»å‹...
    }
    
    // ä¸šåŠ¡æ“ä½œäº§ç”Ÿæ–°äº‹ä»¶
    public void deposit(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("å­˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        // äº§ç”Ÿäº‹ä»¶
        MoneyDepositedEvent event = new MoneyDepositedEvent(
            this.accountId, amount, LocalDateTime.now()
        );
        
        // åº”ç”¨äº‹ä»¶åˆ°å½“å‰çŠ¶æ€
        apply(event);
        
        // è®°å½•æœªæäº¤äº‹ä»¶
        uncommittedEvents.add(event);
    }
}
```

### 8.3 Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼


**ğŸ­ Sagaæ¨¡å¼åŸç†**
Sagaæ˜¯ä¸€ç§ç®¡ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„æ¨¡å¼ï¼Œå°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

```
è®¢å•å¤„ç†Sagaç¤ºä¾‹ï¼š
æ­¥éª¤1ï¸âƒ£ åˆ›å»ºè®¢å• â”€â”€æˆåŠŸâ”€â”€â†’ æ­¥éª¤2ï¸âƒ£ æ‰£å‡åº“å­˜ â”€â”€æˆåŠŸâ”€â”€â†’ æ­¥éª¤3ï¸âƒ£ æ”¯ä»˜
   â”‚                         â”‚                         â”‚
   â”‚(å–æ¶ˆè®¢å•)               â”‚(æ¢å¤åº“å­˜)               â”‚(é€€æ¬¾)
   â†“                         â†“                         â†“
è¡¥å¿æ“ä½œ                   è¡¥å¿æ“ä½œ                   è¡¥å¿æ“ä½œ

å¦‚æœæ­¥éª¤3å¤±è´¥ï¼Œè‡ªåŠ¨æ‰§è¡Œ: é€€æ¬¾ â†’ æ¢å¤åº“å­˜ â†’ å–æ¶ˆè®¢å•
```

**ğŸ› ï¸ Sagaåè°ƒå™¨å®ç°**
```java
@Component
public class OrderSagaOrchestrator {
    
    @SagaOrchestrationStart
    public void handleOrderCreated(OrderCreatedEvent event) {
        SagaManager.builder()
            .sagaId(event.getOrderId())
            .step("å‡åº“å­˜")
                .action(() -> inventoryService.deductStock(event.getItems()))
                .compensation(() -> inventoryService.restoreStock(event.getItems()))
            .step("å¤„ç†æ”¯ä»˜")  
                .action(() -> paymentService.processPayment(event.getOrderId()))
                .compensation(() -> paymentService.refund(event.getOrderId()))
            .step("å®‰æ’å‘è´§")
                .action(() -> shippingService.arrangeShipping(event.getOrderId()))
                .compensation(() -> shippingService.cancelShipping(event.getOrderId()))
            .execute();
    }
    
    @SagaCompensation
    public void handleCompensation(SagaCompensationEvent event) {
        log.info("æ‰§è¡Œè¡¥å¿æ“ä½œ: {}", event.getCompensationStep());
        // æ‰§è¡Œå…·ä½“çš„è¡¥å¿é€»è¾‘
    }
}
```

### 8.4 åˆ†å¸ƒå¼äº‹åŠ¡æ¶ˆæ¯æ¨¡å¼


**ğŸ“® æ¶ˆæ¯äº‹åŠ¡å®ç°æ–¹æ¡ˆ**
```java
// ä¸¤é˜¶æ®µæ¶ˆæ¯æäº¤
@Service
public class TransactionalMessageService {
    
    @Transactional
    public void sendTransactionalMessage(String topic, Object message, 
                                       Runnable localTransaction) {
        // ç¬¬ä¸€é˜¶æ®µï¼šå‘é€åŠæ¶ˆæ¯ï¼ˆä¸ä¼šè¢«æ¶ˆè´¹è€…çœ‹åˆ°ï¼‰
        String messageId = messageProducer.sendHalfMessage(topic, message);
        
        try {
            // æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
            localTransaction.run();
            
            // ç¬¬äºŒé˜¶æ®µï¼šæäº¤æ¶ˆæ¯ï¼ˆæ¶ˆè´¹è€…å¯ä»¥çœ‹åˆ°ï¼‰
            messageProducer.commitMessage(messageId);
            
        } catch (Exception e) {
            // æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œå›æ»šæ¶ˆæ¯
            messageProducer.rollbackMessage(messageId);
            throw e;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public void createOrderWithMessage(Order order) {
    transactionalMessageService.sendTransactionalMessage(
        "order.created",
        new OrderCreatedEvent(order),
        () -> {
            // æœ¬åœ°äº‹åŠ¡ï¼šä¿å­˜è®¢å•
            orderRepository.save(order);
        }
    );
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶ˆæ¯äº‹åŠ¡ï¼šé€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæœ€ç»ˆä¸€è‡´æ€§
ğŸ”¸ äº‹ä»¶é©±åŠ¨ï¼šåŸºäºäº‹ä»¶çš„æ¾è€¦åˆæ¶æ„æ¨¡å¼ï¼Œæé«˜ç³»ç»Ÿæ‰©å±•æ€§
ğŸ”¸ å¯é æŠ•é€’ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±çš„æœºåˆ¶è®¾è®¡
ğŸ”¸ å¹‚ç­‰æ€§ï¼šç›¸åŒæ“ä½œå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼Œé˜²æ­¢é‡å¤å¤„ç†
ğŸ”¸ é‡è¯•æœºåˆ¶ï¼šå¤„ç†ä¸´æ—¶æ•…éšœçš„è‡ªåŠ¨æ¢å¤ç­–ç•¥
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œçš„å¯è§‚æµ‹æ€§
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¶ˆæ¯äº‹åŠ¡ vs ä¼ ç»Ÿäº‹åŠ¡**
```
ä¼ ç»ŸACIDäº‹åŠ¡ï¼š
âœ… å¼ºä¸€è‡´æ€§ï¼Œæ“ä½œè¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥
âŒ æ€§èƒ½å¼€é”€å¤§ï¼Œä¸é€‚åˆåˆ†å¸ƒå¼åœºæ™¯
âŒ é•¿äº‹åŠ¡å¯èƒ½å¯¼è‡´èµ„æºé”å®š

æ¶ˆæ¯äº‹åŠ¡ï¼š
âœ… æœ€ç»ˆä¸€è‡´æ€§ï¼Œç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§é«˜
âœ… å¼‚æ­¥å¤„ç†ï¼Œæå‡ç³»ç»Ÿååé‡
âŒ çŸ­æœŸå†…å¯èƒ½æ•°æ®ä¸ä¸€è‡´
âŒ å¤æ‚åº¦é«˜ï¼Œéœ€è¦è€ƒè™‘å¹‚ç­‰å’Œé‡è¯•
```

**ğŸ”¹ ä½•æ—¶é€‰æ‹©äº‹ä»¶é©±åŠ¨æ¶æ„**
```
é€‚åˆåœºæ™¯ï¼š
âœ… å¾®æœåŠ¡æ¶æ„ï¼ŒæœåŠ¡é—´è§£è€¦éœ€æ±‚å¼º
âœ… é«˜å¹¶å‘åœºæ™¯ï¼Œéœ€è¦å¼‚æ­¥å¤„ç†æå‡æ€§èƒ½
âœ… ä¸šåŠ¡æµç¨‹å¤æ‚ï¼Œæ¶‰åŠå¤šä¸ªç³»ç»Ÿåä½œ
âœ… éœ€è¦å®¡è®¡è¿½è¸ªï¼Œè®°å½•å®Œæ•´æ“ä½œå†å²

ä¸é€‚åˆåœºæ™¯ï¼š
âŒ ç®€å•çš„å•ä½“åº”ç”¨
âŒ å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆå¦‚è½¬è´¦ï¼‰
âŒ å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›ä¸è¶³ä»¥å¤„ç†å¤æ‚çš„å¼‚æ­¥é€»è¾‘
âŒ å®æ—¶æ€§è¦æ±‚æé«˜çš„åœºæ™¯
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**
```
æ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©ï¼š
- å°å›¢é˜Ÿ/å¿«é€Ÿå¼€å‘ï¼šRabbitMQ
- é«˜ååé‡åœºæ™¯ï¼šApache Kafka  
- é‡‘èçº§å¯é æ€§ï¼šRocketMQ
- ä¼ä¸šé›†æˆåœºæ™¯ï¼šActiveMQ

æ¶æ„æ¨¡å¼é€‰æ‹©ï¼š
- ç®€å•ä¸šåŠ¡ï¼šåŸºç¡€å‘å¸ƒè®¢é˜…
- å¤æ‚ä¸šåŠ¡æµç¨‹ï¼šSagaæ¨¡å¼
- éœ€è¦å®¡è®¡è¿½è¸ªï¼šäº‹ä»¶æº¯æº + CQRS
- åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ› ï¸ å·¥ç¨‹å®è·µè¦ç‚¹**
```
å¼€å‘é˜¶æ®µï¼š
1. è®¾è®¡é˜¶æ®µè€ƒè™‘å¹‚ç­‰æ€§
2. å®šä¹‰æ¸…æ™°çš„äº‹ä»¶æ ¼å¼è§„èŒƒ  
3. å»ºç«‹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
4. å®ç°å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦

è¿ç»´é˜¶æ®µï¼š
1. ç›‘æ§æ¶ˆæ¯ç§¯å‹å’Œå¤„ç†å»¶è¿Ÿ
2. å®šæœŸæ£€æŸ¥æ­»ä¿¡é˜Ÿåˆ—
3. æ€§èƒ½è°ƒä¼˜å’Œå®¹é‡è§„åˆ’
4. å»ºç«‹åº”æ€¥å¤„ç†é¢„æ¡ˆ
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”§ å…¸å‹é—®é¢˜å¤„ç†**
```
é—®é¢˜1ï¼šæ¶ˆæ¯é‡å¤æ¶ˆè´¹
è§£å†³ï¼šå®ç°å¹‚ç­‰æ€§æ£€æŸ¥æœºåˆ¶

é—®é¢˜2ï¼šæ¶ˆæ¯ä¸¢å¤±  
è§£å†³ï¼šå¼€å¯æŒä¹…åŒ– + æ¶ˆè´¹ç¡®è®¤æœºåˆ¶

é—®é¢˜3ï¼šæ¶ˆæ¯ç§¯å‹
è§£å†³ï¼šå¢åŠ æ¶ˆè´¹è€…å®ä¾‹ + ä¼˜åŒ–å¤„ç†é€»è¾‘

é—®é¢˜4ï¼šé¡ºåºæ¶ˆæ¯å¤„ç†
è§£å†³ï¼šä½¿ç”¨åˆ†åŒº/é˜Ÿåˆ—ä¿è¯åŒä¸€ä¸šåŠ¡çš„æ¶ˆæ¯é¡ºåº

é—®é¢˜5ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
è§£å†³ï¼šé‡‡ç”¨Sagaæ¨¡å¼æˆ–å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ¶ˆæ¯äº‹åŠ¡ä¿æœ€ç»ˆä¸€è‡´ï¼Œå¼‚æ­¥è§£è€¦ææ€§èƒ½
- å¹‚ç­‰é‡è¯•é˜²é‡å¤ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š  
- äº‹ä»¶é©±åŠ¨æ¾è€¦åˆï¼Œå‘å¸ƒè®¢é˜…æ˜“æ‰©å±•
- é€‰å¯¹æŠ€æœ¯çœ‹åœºæ™¯ï¼Œå·¥ç¨‹å®è·µé‡ç»†èŠ‚