---
title: 6ã€æœ€ç»ˆä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [æœ€ç»ˆä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ](#1-æœ€ç»ˆä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ)
2. [å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§](#2-å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§)
3. [æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆ](#3-æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆ)
4. [å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶](#4-å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶)
5. [çŠ¶æ€æœºç®¡ç†](#5-çŠ¶æ€æœºç®¡ç†)
6. [æ•°æ®å¯¹è´¦æœºåˆ¶](#6-æ•°æ®å¯¹è´¦æœºåˆ¶)
7. [ä¸€è‡´æ€§æ—¶é—´çª—å£æ§åˆ¶](#7-ä¸€è‡´æ€§æ—¶é—´çª—å£æ§åˆ¶)
8. [å¼‚å¸¸å¤„ç†ä¸è‡ªåŠ¨ä¿®å¤](#8-å¼‚å¸¸å¤„ç†ä¸è‡ªåŠ¨ä¿®å¤)
9. [SLAä¿è¯æœºåˆ¶](#9-SLAä¿è¯æœºåˆ¶)
10. [ç›‘æ§å‘Šè­¦ç³»ç»Ÿ](#10-ç›‘æ§å‘Šè­¦ç³»ç»Ÿ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æœ€ç»ˆä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§


**é€šä¿—ç†è§£**ï¼šå°±åƒé“¶è¡Œè½¬è´¦ä¸€æ ·ï¼Œä½ ä»Aé“¶è¡Œè½¬é’±åˆ°Bé“¶è¡Œï¼Œå¯èƒ½Aé“¶è¡Œå…ˆæ‰£é’±ï¼ŒBé“¶è¡Œè¿‡ä¸€ä¼šå„¿æ‰åˆ°è´¦ã€‚è¿™ä¸ª"è¿‡ä¸€ä¼šå„¿"å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§çš„æ—¶é—´çª—å£ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ç½‘è´­ä¸‹å• â†’ åº“å­˜æ‰£å‡ â†’ æ”¯ä»˜æˆåŠŸ â†’ å‘è´§
è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯ç¬é—´å®Œæˆçš„ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šç³»ç»Ÿä¸­çš„æ•°æ®å‰¯æœ¬åœ¨ä¸€æ®µæ—¶é—´åä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
- **å®¹å¿çŸ­æœŸä¸ä¸€è‡´**ï¼šå…è®¸ç³»ç»Ÿåœ¨çŸ­æ—¶é—´å†…å‡ºç°æ•°æ®ä¸ä¸€è‡´
- **ä¿è¯æœ€ç»ˆæ”¶æ•›**ï¼šé€šè¿‡è¡¥å¿æœºåˆ¶ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœ€ç»ˆä¸€è‡´æ€§


**ğŸ”¸ åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç°å®æŒ‘æˆ˜**
```
ç½‘ç»œå»¶è¿Ÿï¼šä¸åŒç³»ç»Ÿé—´çš„é€šä¿¡éœ€è¦æ—¶é—´
ç³»ç»Ÿæ•…éšœï¼šæŸä¸ªæœåŠ¡å¯èƒ½ä¸´æ—¶ä¸å¯ç”¨
æ€§èƒ½è€ƒè™‘ï¼šå¼ºä¸€è‡´æ€§ä¼šä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½
ä¸šåŠ¡å®¹å¿åº¦ï¼šå¾ˆå¤šä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—çŸ­æš‚çš„ä¸ä¸€è‡´
```

**ğŸ’¡ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… é€‚åˆæœ€ç»ˆä¸€è‡´æ€§ï¼š
- ç”µå•†åº“å­˜ç®¡ç†ï¼ˆå¯ä»¥è¶…å–åè¡¥å¿ï¼‰
- ç¤¾äº¤åª’ä½“ç‚¹èµè®¡æ•°ï¼ˆä¸éœ€è¦å®æ—¶ç²¾ç¡®ï¼‰
- æ•°æ®åŒæ­¥å¤‡ä»½ï¼ˆå¯ä»¥æœ‰å»¶è¿Ÿï¼‰

âŒ ä¸é€‚åˆæœ€ç»ˆä¸€è‡´æ€§ï¼š
- é“¶è¡Œè´¦æˆ·ä½™é¢ï¼ˆå¿…é¡»å¼ºä¸€è‡´ï¼‰
- äº¤æ˜“æ’®åˆç³»ç»Ÿï¼ˆå¿…é¡»å®æ—¶å‡†ç¡®ï¼‰
- å®‰å…¨è®¤è¯ç³»ç»Ÿï¼ˆä¸èƒ½æœ‰å»¶è¿Ÿï¼‰
```

### 1.3 æœ€ç»ˆä¸€è‡´æ€§çš„æ ¸å¿ƒè¦ç´ 


**â­ æ—¶é—´çª—å£ï¼ˆTime Windowï¼‰**
```
å®šä¹‰ï¼šä»æ•°æ®ä¸ä¸€è‡´åˆ°æ¢å¤ä¸€è‡´çš„æœ€å¤§æ—¶é—´
å½±å“å› ç´ ï¼š
â€¢ ç½‘ç»œå»¶è¿Ÿï¼šç³»ç»Ÿé—´é€šä¿¡æ—¶é—´
â€¢ å¤„ç†å»¶è¿Ÿï¼šä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ—¶é—´  
â€¢ é‡è¯•é—´éš”ï¼šå¤±è´¥é‡è¯•çš„ç­‰å¾…æ—¶é—´
â€¢ è¡¥å¿å»¶è¿Ÿï¼šæ•°æ®å¯¹è´¦å’Œä¿®å¤æ—¶é—´

å…¸å‹æ—¶é—´çª—å£ï¼š
- å®æ—¶ç³»ç»Ÿï¼š< 1ç§’
- å‡†å®æ—¶ç³»ç»Ÿï¼š1-10ç§’
- æ‰¹å¤„ç†ç³»ç»Ÿï¼šåˆ†é’Ÿçº§åˆ°å°æ—¶çº§
```

---

## 2. ğŸ“¨ å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§


### 2.1 åŸºæœ¬åŸç†


**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¯„å¿«é€’ä¸€æ ·ï¼Œå…ˆæŠŠåŒ…è£¹ï¼ˆæ¶ˆæ¯ï¼‰å¯„å‡ºå»ï¼Œç„¶åç¡®ä¿æ”¶ä»¶äººä¸€å®šèƒ½æ”¶åˆ°ã€‚å¦‚æœç¬¬ä¸€æ¬¡æ²¡æ”¶åˆ°ï¼Œå¿«é€’å‘˜ä¼šå†é€ï¼Œç›´åˆ°ç­¾æ”¶ä¸ºæ­¢ã€‚

```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
è®¢å•æœåŠ¡ â†’ ç›´æ¥è°ƒç”¨åº“å­˜æœåŠ¡ â†’ å¦‚æœåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥

å¯é æ¶ˆæ¯æ–¹å¼ï¼š
è®¢å•æœåŠ¡ â†’ å‘æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ— â†’ åº“å­˜æœåŠ¡ä»é˜Ÿåˆ—å–æ¶ˆæ¯å¤„ç†
å³ä½¿åº“å­˜æœåŠ¡æš‚æ—¶æŒ‚äº†ï¼Œæ¶ˆæ¯è¿˜åœ¨é˜Ÿåˆ—é‡Œç­‰ç€å¤„ç†
```

### 2.2 å®ç°æ¶æ„


**ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ å‘é€æ¶ˆæ¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   æ¶ˆæ¯é˜Ÿåˆ—   â”‚
â”‚             â”‚                â”‚ (å¯é å­˜å‚¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ â‘¡æ¶ˆè´¹æ¶ˆæ¯
                                      â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚  åº“å­˜æœåŠ¡    â”‚
                               â”‚ (æ¶ˆæ¯å¤„ç†)   â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ ¸å¿ƒç»„ä»¶**

**å¯é æ¶ˆæ¯é˜Ÿåˆ—**
```java
// ç®€åŒ–ç¤ºä¾‹ï¼šå‘é€å¯é æ¶ˆæ¯
@Service
public class OrderService {
    
    @Autowired
    private MessageProducer messageProducer;
    
    @Transactional
    public void createOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        orderRepository.save(order);
        
        // 2. å‘é€å¯é æ¶ˆæ¯
        StockMessage message = new StockMessage(
            order.getProductId(), 
            order.getQuantity()
        );
        messageProducer.sendReliableMessage("stock-topic", message);
    }
}
```

**æ¶ˆæ¯æ¶ˆè´¹è€…**
```java
// åº“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯
@Component
public class StockMessageConsumer {
    
    @RabbitListener(queues = "stock-queue")
    public void handleStockMessage(StockMessage message) {
        try {
            // å¤„ç†åº“å­˜æ‰£å‡
            stockService.reduceStock(
                message.getProductId(), 
                message.getQuantity()
            );
            
            // æ¶ˆæ¯å¤„ç†æˆåŠŸï¼Œè‡ªåŠ¨ACK
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æŠ•é€’
            throw new MessageProcessException("åº“å­˜å¤„ç†å¤±è´¥", e);
        }
    }
}
```

### 2.3 æ¶ˆæ¯é‡è¯•æœºåˆ¶


**ğŸ”„ é‡è¯•ç­–ç•¥**
```java
// é…ç½®é‡è¯•ç­–ç•¥
@Configuration
public class MessageRetryConfig {
    
    @Bean
    public RetryTemplate retryTemplate() {
        RetryTemplate template = new RetryTemplate();
        
        // å›ºå®šé—´éš”é‡è¯•
        FixedBackOffPolicy backOffPolicy = new FixedBackOffPolicy();
        backOffPolicy.setBackOffPeriod(5000); // 5ç§’é—´éš”
        
        // æœ€å¤§é‡è¯•æ¬¡æ•°
        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();
        retryPolicy.setMaxAttempts(3);
        
        template.setBackOffPolicy(backOffPolicy);
        template.setRetryPolicy(retryPolicy);
        
        return template;
    }
}
```

**âš ï¸ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†**
```java
// å¤„ç†æœ€ç»ˆå¤±è´¥çš„æ¶ˆæ¯
@RabbitListener(queues = "stock-dlq")
public void handleDeadLetter(StockMessage message) {
    // è®°å½•åˆ°æ•°æ®åº“ï¼Œäººå·¥å¤„ç†
    failedMessageService.saveFailedMessage(message);
    
    // å‘é€å‘Šè­¦é€šçŸ¥
    alertService.sendAlert("æ¶ˆæ¯å¤„ç†æœ€ç»ˆå¤±è´¥: " + message);
}
```

---

## 3. ğŸ“¢ æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆ


### 3.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šå°±åƒå‘çŸ­ä¿¡é€šçŸ¥ä¸€æ ·ï¼Œæˆ‘ä»¬å°½æœ€å¤§åŠªåŠ›ç¡®ä¿å¯¹æ–¹æ”¶åˆ°é€šçŸ¥ï¼Œä½†å¦‚æœå®åœ¨å‘ä¸å‡ºå»ï¼Œä¹Ÿä¸ä¼šä¸€ç›´é‡è¯•ä¸‹å»ã€‚

```
åº”ç”¨åœºæ™¯ï¼š
æ”¯ä»˜æˆåŠŸåé€šçŸ¥å•†æˆ· â†’ é‡è¯•å‡ æ¬¡åæ”¾å¼ƒ
é‚®ä»¶å‘é€ â†’ å°è¯•å¤šæ¬¡åæ ‡è®°å¤±è´¥
ç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨ â†’ æœ‰é™æ¬¡æ•°é‡è¯•
```

### 3.2 å®ç°æ–¹å¼


**ğŸ“‹ é€šçŸ¥æµç¨‹**
```
ç”¨æˆ·æ”¯ä»˜ â†’ æ”¯ä»˜æˆåŠŸ â†’ é€šçŸ¥å•†æˆ·(ç¬¬1æ¬¡)
                    â†“
              å¤±è´¥ï¼Ÿé‡è¯•(ç¬¬2æ¬¡)
                    â†“  
              å¤±è´¥ï¼Ÿé‡è¯•(ç¬¬3æ¬¡)
                    â†“
              æœ€ç»ˆå¤±è´¥ â†’ è®°å½•æ—¥å¿—ï¼Œäººå·¥å¤„ç†
```

**ğŸ’» ä»£ç å®ç°**
```java
@Service
public class NotificationService {
    
    private static final int MAX_RETRY_TIMES = 3;
    
    public void notifyMerchant(PaymentEvent event) {
        NotificationRecord record = new NotificationRecord();
        record.setEvent(event);
        record.setRetryCount(0);
        record.setStatus("PENDING");
        
        // ä¿å­˜é€šçŸ¥è®°å½•
        notificationRepository.save(record);
        
        // å¼‚æ­¥å‘é€é€šçŸ¥
        sendNotificationAsync(record);
    }
    
    @Async
    private void sendNotificationAsync(NotificationRecord record) {
        boolean success = false;
        
        while (record.getRetryCount() < MAX_RETRY_TIMES && !success) {
            try {
                // è°ƒç”¨å•†æˆ·æ¥å£
                merchantClient.notify(record.getEvent());
                
                record.setStatus("SUCCESS");
                success = true;
                
            } catch (Exception e) {
                record.setRetryCount(record.getRetryCount() + 1);
                
                if (record.getRetryCount() >= MAX_RETRY_TIMES) {
                    record.setStatus("FAILED");
                    // å‘é€å‘Šè­¦
                    alertService.sendAlert("é€šçŸ¥æœ€ç»ˆå¤±è´¥: " + record);
                } else {
                    // ç­‰å¾…åé‡è¯•
                    sleep(getRetryInterval(record.getRetryCount()));
                }
            }
        }
        
        notificationRepository.save(record);
    }
    
    // é‡è¯•é—´éš”é€’å¢ï¼š1s, 2s, 4s
    private long getRetryInterval(int retryCount) {
        return (long) Math.pow(2, retryCount) * 1000;
    }
}
```

### 3.3 é€šçŸ¥çŠ¶æ€ç®¡ç†


**ğŸ“Š çŠ¶æ€è½¬æ¢å›¾**
```
PENDING â”€â”€æˆåŠŸâ”€â”€â†’ SUCCESS
   â”‚
   â”‚å¤±è´¥é‡è¯•
   â–¼
RETRYING â”€â”€æˆåŠŸâ”€â”€â†’ SUCCESS
   â”‚
   â”‚è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
   â–¼
FAILED â”€â”€äººå·¥å¤„ç†â”€â”€â†’ SUCCESS
```

---

## 4. â° å®šæ—¶ä»»åŠ¡è¡¥å¿æœºåˆ¶


### 4.1 è¡¥å¿åŸç†


**é€šä¿—ç†è§£**ï¼šå°±åƒå®šæœŸæ£€æŸ¥å®¶é‡Œçš„ç”µå™¨æ˜¯å¦æ­£å¸¸å·¥ä½œä¸€æ ·ï¼Œç³»ç»Ÿå®šæœŸæ£€æŸ¥æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå‘ç°é—®é¢˜å°±åŠæ—¶ä¿®å¤ã€‚

```
è¡¥å¿åœºæ™¯ï¼š
â€¢ æ¶ˆæ¯ä¸¢å¤±ï¼šå®šæ—¶æ£€æŸ¥æœªå¤„ç†çš„è®¢å•
â€¢ å¤„ç†å¤±è´¥ï¼šå®šæ—¶é‡è¯•å¤±è´¥çš„ä»»åŠ¡
â€¢ çŠ¶æ€ä¸ä¸€è‡´ï¼šå®šæ—¶å¯¹è´¦å‘ç°å·®å¼‚
```

### 4.2 è¡¥å¿ä»»åŠ¡è®¾è®¡


**ğŸ• è¡¥å¿ç­–ç•¥**
```java
@Component
@Slf4j
public class OrderCompensationTask {
    
    // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡è¡¥å¿
    @Scheduled(fixedRate = 300000)
    public void compensateOrders() {
        log.info("å¼€å§‹æ‰§è¡Œè®¢å•è¡¥å¿ä»»åŠ¡");
        
        // 1. æŸ¥æ‰¾è¶…æ—¶æœªå¤„ç†çš„è®¢å•
        List<Order> timeoutOrders = orderService.findTimeoutOrders(5); // 5åˆ†é’Ÿè¶…æ—¶
        
        for (Order order : timeoutOrders) {
            try {
                compensateOrder(order);
            } catch (Exception e) {
                log.error("è®¢å•è¡¥å¿å¤±è´¥: {}", order.getId(), e);
            }
        }
        
        log.info("è®¢å•è¡¥å¿ä»»åŠ¡å®Œæˆï¼Œå¤„ç†è®¢å•æ•°é‡: {}", timeoutOrders.size());
    }
    
    private void compensateOrder(Order order) {
        // æ ¹æ®è®¢å•çŠ¶æ€å†³å®šè¡¥å¿åŠ¨ä½œ
        switch (order.getStatus()) {
            case "CREATED":
                // é‡æ–°å‘é€åº“å­˜æ‰£å‡æ¶ˆæ¯
                messageProducer.sendStockMessage(order);
                break;
                
            case "STOCK_REDUCED":
                // é‡æ–°å‘é€æ”¯ä»˜æ¶ˆæ¯
                messageProducer.sendPaymentMessage(order);
                break;
                
            case "PAID":
                // é‡æ–°å‘é€å‘è´§æ¶ˆæ¯
                messageProducer.sendShippingMessage(order);
                break;
                
            default:
                log.warn("æœªçŸ¥è®¢å•çŠ¶æ€: {}", order.getStatus());
        }
    }
}
```

### 4.3 è¡¥å¿é¢‘ç‡æ§åˆ¶


**âš¡ æ™ºèƒ½è¡¥å¿ç­–ç•¥**
```java
// æ ¹æ®å¤±è´¥æ¬¡æ•°è°ƒæ•´è¡¥å¿é¢‘ç‡
public class SmartCompensationScheduler {
    
    public long getNextCompensationDelay(int failureCount) {
        // æŒ‡æ•°é€€é¿ï¼š1åˆ†é’Ÿ â†’ 2åˆ†é’Ÿ â†’ 4åˆ†é’Ÿ â†’ 8åˆ†é’Ÿ â†’ æœ€å¤§30åˆ†é’Ÿ
        long baseDelay = 60000; // 1åˆ†é’Ÿ
        long maxDelay = 1800000; // 30åˆ†é’Ÿ
        
        long delay = (long) (baseDelay * Math.pow(2, failureCount));
        return Math.min(delay, maxDelay);
    }
}
```

---

## 5. ğŸ° çŠ¶æ€æœºç®¡ç†


### 5.1 çŠ¶æ€æœºåŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šçŠ¶æ€æœºå°±åƒçº¢ç»¿ç¯ç³»ç»Ÿï¼Œæœ‰å›ºå®šçš„çŠ¶æ€ï¼ˆçº¢ã€é»„ã€ç»¿ï¼‰ï¼Œåªèƒ½æŒ‰ç…§è§„å®šçš„è·¯å¾„è½¬æ¢ï¼Œä¸èƒ½éšæ„è·³è·ƒã€‚

```
è®¢å•çŠ¶æ€æœºç¤ºä¾‹ï¼š
åˆ›å»º â†’ åº“å­˜æ‰£å‡ â†’ æ”¯ä»˜ â†’ å‘è´§ â†’ å®Œæˆ
  â†“       â†“      â†“     â†“
 å–æ¶ˆ   å–æ¶ˆ    é€€æ¬¾  é€€è´§
```

### 5.2 çŠ¶æ€æœºå®ç°


**ğŸ“Š è®¢å•çŠ¶æ€æœºè®¾è®¡**
```java
public enum OrderStatus {
    CREATED("å·²åˆ›å»º"),
    STOCK_REDUCED("åº“å­˜å·²æ‰£å‡"), 
    PAID("å·²æ”¯ä»˜"),
    SHIPPED("å·²å‘è´§"),
    COMPLETED("å·²å®Œæˆ"),
    CANCELLED("å·²å–æ¶ˆ");
    
    private final String description;
    
    OrderStatus(String description) {
        this.description = description;
    }
}

// çŠ¶æ€è½¬æ¢è§„åˆ™
@Component
public class OrderStateMachine {
    
    // å®šä¹‰å…è®¸çš„çŠ¶æ€è½¬æ¢
    private static final Map<OrderStatus, Set<OrderStatus>> ALLOWED_TRANSITIONS = 
        Map.of(
            OrderStatus.CREATED, Set.of(OrderStatus.STOCK_REDUCED, OrderStatus.CANCELLED),
            OrderStatus.STOCK_REDUCED, Set.of(OrderStatus.PAID, OrderStatus.CANCELLED),
            OrderStatus.PAID, Set.of(OrderStatus.SHIPPED, OrderStatus.CANCELLED),
            OrderStatus.SHIPPED, Set.of(OrderStatus.COMPLETED),
            OrderStatus.COMPLETED, Set.of(), // ç»ˆæ€
            OrderStatus.CANCELLED, Set.of()  // ç»ˆæ€
        );
    
    public boolean canTransition(OrderStatus from, OrderStatus to) {
        return ALLOWED_TRANSITIONS.get(from).contains(to);
    }
    
    @Transactional
    public void transitOrder(Long orderId, OrderStatus targetStatus) {
        Order order = orderRepository.findById(orderId);
        
        if (!canTransition(order.getStatus(), targetStatus)) {
            throw new IllegalStateException(
                String.format("ä¸èƒ½ä»çŠ¶æ€ %s è½¬æ¢åˆ° %s", 
                    order.getStatus(), targetStatus)
            );
        }
        
        // æ‰§è¡ŒçŠ¶æ€è½¬æ¢
        OrderStatus oldStatus = order.getStatus();
        order.setStatus(targetStatus);
        orderRepository.save(order);
        
        // å‘å¸ƒçŠ¶æ€å˜æ›´äº‹ä»¶
        eventPublisher.publishEvent(
            new OrderStatusChangedEvent(orderId, oldStatus, targetStatus)
        );
    }
}
```

### 5.3 çŠ¶æ€æ¢å¤æœºåˆ¶


**ğŸ”§ çŠ¶æ€ä¸€è‡´æ€§ä¿è¯**
```java
// å®šæ—¶æ£€æŸ¥çŠ¶æ€ä¸€è‡´æ€§
@Scheduled(fixedRate = 600000) // æ¯10åˆ†é’Ÿ
public void checkStateConsistency() {
    List<Order> inconsistentOrders = findInconsistentOrders();
    
    for (Order order : inconsistentOrders) {
        repairOrderState(order);
    }
}

private void repairOrderState(Order order) {
    // æ ¹æ®å­ç³»ç»ŸçŠ¶æ€æ¨æ–­æ­£ç¡®çš„è®¢å•çŠ¶æ€
    boolean stockReduced = stockService.isStockReduced(order.getId());
    boolean paid = paymentService.isPaid(order.getId());
    boolean shipped = shippingService.isShipped(order.getId());
    
    OrderStatus correctStatus = determineCorrectStatus(stockReduced, paid, shipped);
    
    if (!order.getStatus().equals(correctStatus)) {
        log.warn("å‘ç°çŠ¶æ€ä¸ä¸€è‡´ï¼Œè®¢å•: {}, å½“å‰çŠ¶æ€: {}, æ­£ç¡®çŠ¶æ€: {}", 
            order.getId(), order.getStatus(), correctStatus);
        
        order.setStatus(correctStatus);
        orderRepository.save(order);
    }
}
```

---

## 6. ğŸ” æ•°æ®å¯¹è´¦æœºåˆ¶


### 6.1 å¯¹è´¦åŸºæœ¬æ–¹æ³•


**é€šä¿—ç†è§£**ï¼šå¯¹è´¦å°±åƒæœˆåº•æ ¸å¯¹é“¶è¡Œè´¦å•ä¸€æ ·ï¼ŒæŠŠè‡ªå·±çš„è´¦å’Œé“¶è¡Œçš„è´¦æ¯”è¾ƒï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰å·®å¼‚ã€‚

**ğŸ“‹ å¯¹è´¦ç»´åº¦**
```
æ•°é‡å¯¹è´¦ï¼šè®¢å•æ•°é‡ vs æ”¯ä»˜æ•°é‡ vs å‘è´§æ•°é‡
é‡‘é¢å¯¹è´¦ï¼šè®¢å•é‡‘é¢ vs æ”¯ä»˜é‡‘é¢ vs ç»“ç®—é‡‘é¢
çŠ¶æ€å¯¹è´¦ï¼šè®¢å•çŠ¶æ€ vs åº“å­˜çŠ¶æ€ vs ç‰©æµçŠ¶æ€
æ—¶é—´å¯¹è´¦ï¼šå„ç³»ç»Ÿçš„æ—¶é—´æˆ³æ˜¯å¦åˆç†
```

### 6.2 å¯¹è´¦å®ç°


**ğŸ’» è‡ªåŠ¨å¯¹è´¦ç³»ç»Ÿ**
```java
@Service
public class ReconciliationService {
    
    // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¯¹è´¦
    @Scheduled(cron = "0 0 2 * * ?")
    public void dailyReconciliation() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        // 1. è®¢å•vsæ”¯ä»˜å¯¹è´¦
        reconcileOrderAndPayment(yesterday);
        
        // 2. è®¢å•vsåº“å­˜å¯¹è´¦  
        reconcileOrderAndStock(yesterday);
        
        // 3. æ”¯ä»˜vsç»“ç®—å¯¹è´¦
        reconcilePaymentAndSettlement(yesterday);
    }
    
    private void reconcileOrderAndPayment(LocalDate date) {
        // è·å–è®¢å•æ•°æ®
        List<OrderSummary> orders = orderService.getOrderSummary(date);
        
        // è·å–æ”¯ä»˜æ•°æ®
        List<PaymentSummary> payments = paymentService.getPaymentSummary(date);
        
        // æ„å»ºå¯¹è´¦æŠ¥å‘Š
        ReconciliationReport report = new ReconciliationReport();
        
        for (OrderSummary order : orders) {
            PaymentSummary payment = findMatchingPayment(payments, order.getOrderId());
            
            if (payment == null) {
                // æœ‰è®¢å•æ— æ”¯ä»˜
                report.addMissingPayment(order);
            } else if (!order.getAmount().equals(payment.getAmount())) {
                // é‡‘é¢ä¸ä¸€è‡´
                report.addAmountMismatch(order, payment);
            }
        }
        
        // æŸ¥æ‰¾å¤šä½™çš„æ”¯ä»˜ï¼ˆæœ‰æ”¯ä»˜æ— è®¢å•ï¼‰
        for (PaymentSummary payment : payments) {
            if (!hasMatchingOrder(orders, payment.getOrderId())) {
                report.addOrphanPayment(payment);
            }
        }
        
        // ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
        generateReconciliationReport(report, date);
        
        // å¦‚æœæœ‰å·®å¼‚ï¼Œå‘é€å‘Šè­¦
        if (report.hasDifferences()) {
            alertService.sendReconciliationAlert(report);
        }
    }
}
```

### 6.3 å·®å¼‚å¤„ç†


**ğŸ”§ å·®å¼‚è‡ªåŠ¨ä¿®å¤**
```java
@Component
public class DifferenceHandler {
    
    public void handleDifferences(ReconciliationReport report) {
        // å¤„ç†ç¼ºå¤±æ”¯ä»˜
        for (OrderSummary order : report.getMissingPayments()) {
            if (canAutoFix(order)) {
                // è‡ªåŠ¨å‘èµ·è¡¥å¿æ”¯ä»˜
                paymentService.compensatePayment(order);
            } else {
                // äººå·¥å¤„ç†
                manualProcessService.createTask("ç¼ºå¤±æ”¯ä»˜", order);
            }
        }
        
        // å¤„ç†é‡‘é¢ä¸ä¸€è‡´
        for (AmountMismatch mismatch : report.getAmountMismatches()) {
            if (isMinorDifference(mismatch)) {
                // å°é¢å·®å¼‚è‡ªåŠ¨è°ƒæ•´
                adjustAmount(mismatch);
            } else {
                // å¤§é¢å·®å¼‚äººå·¥ç¡®è®¤
                manualProcessService.createTask("é‡‘é¢å·®å¼‚", mismatch);
            }
        }
    }
    
    private boolean canAutoFix(OrderSummary order) {
        // åªæœ‰å°é¢è®¢å•ä¸”æ—¶é—´ä¸è¶…è¿‡24å°æ—¶æ‰è‡ªåŠ¨ä¿®å¤
        return order.getAmount().compareTo(new BigDecimal("100")) <= 0 &&
               order.getCreateTime().isAfter(LocalDateTime.now().minusHours(24));
    }
}
```

---

## 7. â±ï¸ ä¸€è‡´æ€§æ—¶é—´çª—å£æ§åˆ¶


### 7.1 æ—¶é—´çª—å£æ§åˆ¶ç­–ç•¥


**é€šä¿—ç†è§£**ï¼šå°±åƒçº¦å®šé€é¤æ—¶é—´ä¸€æ ·ï¼Œ"30åˆ†é’Ÿå†…é€è¾¾"å°±æ˜¯ä¸€ä¸ªæ—¶é—´çª—å£æ‰¿è¯ºã€‚

**ğŸ“Š æ—¶é—´çª—å£åˆ†çº§**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡é‡è¦æ€§     â”‚    æ—¶é—´çª—å£      â”‚    å¤„ç†ç­–ç•¥      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ ¸å¿ƒä¸šåŠ¡       â”‚    < 10ç§’       â”‚   å®æ—¶ç›‘æ§å‘Šè­¦   â”‚
â”‚   é‡è¦ä¸šåŠ¡       â”‚    < 60ç§’       â”‚   å¿«é€Ÿé‡è¯•è¡¥å¿   â”‚
â”‚   ä¸€èˆ¬ä¸šåŠ¡       â”‚    < 300ç§’      â”‚   å®šæ—¶æ‰¹é‡å¤„ç†   â”‚
â”‚   éæ ¸å¿ƒä¸šåŠ¡     â”‚    < 1800ç§’     â”‚   å»¶è¿Ÿæ‰¹é‡å¤„ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ—¶é—´çª—å£ç›‘æ§


**â° å®æ—¶ç›‘æ§å®ç°**
```java
@Component
public class ConsistencyWindowMonitor {
    
    private final Map<String, Long> businessTimeWindows = Map.of(
        "ORDER_PAYMENT", 10000L,    // è®¢å•æ”¯ä»˜ï¼š10ç§’
        "STOCK_REDUCTION", 30000L,  // åº“å­˜æ‰£å‡ï¼š30ç§’  
        "SHIPPING_NOTIFY", 300000L  // å‘è´§é€šçŸ¥ï¼š5åˆ†é’Ÿ
    );
    
    @EventListener
    public void onBusinessEvent(BusinessEvent event) {
        // è®°å½•äº‹ä»¶å¼€å§‹æ—¶é—´
        windowTracker.startWindow(event.getBusinessId(), event.getType());
        
        // è®¾ç½®è¶…æ—¶æ£€æŸ¥
        scheduleTimeoutCheck(event);
    }
    
    private void scheduleTimeoutCheck(BusinessEvent event) {
        long timeWindow = businessTimeWindows.get(event.getType());
        
        scheduledExecutor.schedule(() -> {
            if (!windowTracker.isCompleted(event.getBusinessId())) {
                // è¶…æ—¶æœªå®Œæˆï¼Œè§¦å‘å‘Šè­¦
                handleTimeoutEvent(event);
            }
        }, timeWindow, TimeUnit.MILLISECONDS);
    }
    
    private void handleTimeoutEvent(BusinessEvent event) {
        // 1. è®°å½•è¶…æ—¶äº‹ä»¶
        timeoutEventRepository.save(new TimeoutEvent(event));
        
        // 2. å‘é€å‘Šè­¦
        alertService.sendTimeoutAlert(event);
        
        // 3. è§¦å‘è¡¥å¿æœºåˆ¶
        compensationService.triggerCompensation(event);
    }
}
```

### 7.3 çª—å£è‡ªé€‚åº”è°ƒæ•´


**ğŸ¯ åŠ¨æ€è°ƒæ•´ç­–ç•¥**
```java
// æ ¹æ®ç³»ç»Ÿè´Ÿè½½å’Œå†å²æ•°æ®åŠ¨æ€è°ƒæ•´æ—¶é—´çª—å£
@Service
public class AdaptiveWindowService {
    
    public void adjustTimeWindows() {
        // åˆ†æè¿‡å»24å°æ—¶çš„å®Œæˆæ—¶é—´åˆ†å¸ƒ
        Map<String, StatsSummary> stats = 
            statisticsService.getCompletionStats(Duration.ofHours(24));
        
        for (Map.Entry<String, StatsSummary> entry : stats.entrySet()) {
            String businessType = entry.getKey();
            StatsSummary summary = entry.getValue();
            
            // è®¡ç®—æ–°çš„æ—¶é—´çª—å£ï¼šP95 + 20%ç¼“å†²
            long newWindow = (long) (summary.getP95() * 1.2);
            
            // é™åˆ¶è°ƒæ•´å¹…åº¦ï¼Œé¿å…æ³¢åŠ¨è¿‡å¤§
            long currentWindow = businessTimeWindows.get(businessType);
            long adjustedWindow = limitAdjustment(currentWindow, newWindow, 0.3);
            
            if (adjustedWindow != currentWindow) {
                log.info("è°ƒæ•´æ—¶é—´çª—å£ - ä¸šåŠ¡ç±»å‹: {}, åŸçª—å£: {}ms, æ–°çª—å£: {}ms", 
                    businessType, currentWindow, adjustedWindow);
                
                businessTimeWindows.put(businessType, adjustedWindow);
            }
        }
    }
    
    // é™åˆ¶å•æ¬¡è°ƒæ•´å¹…åº¦ä¸è¶…è¿‡30%
    private long limitAdjustment(long current, long target, double maxChange) {
        long maxIncrease = (long) (current * (1 + maxChange));
        long maxDecrease = (long) (current * (1 - maxChange));
        
        return Math.max(maxDecrease, Math.min(maxIncrease, target));
    }
}
```

---

## 8. ğŸš¨ å¼‚å¸¸å¤„ç†ä¸è‡ªåŠ¨ä¿®å¤


### 8.1 å¼‚å¸¸åˆ†ç±»å¤„ç†


**é€šä¿—ç†è§£**ï¼šå°±åƒåŒ»ç”Ÿçœ‹ç—…ä¸€æ ·ï¼Œä¸åŒçš„ç—…ç—‡æœ‰ä¸åŒçš„æ²»ç–—æ–¹æ¡ˆï¼Œç³»ç»Ÿå¼‚å¸¸ä¹Ÿè¦åˆ†ç±»å¤„ç†ã€‚

**ğŸ“‹ å¼‚å¸¸åˆ†ç±»ä½“ç³»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼‚å¸¸ç±»å‹       â”‚    å¤„ç†ç­–ç•¥      â”‚    ä¿®å¤æ–¹å¼      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç½‘ç»œè¶…æ—¶å¼‚å¸¸    â”‚   è‡ªåŠ¨é‡è¯•       â”‚   æŒ‡æ•°é€€é¿é‡è¯•   â”‚
â”‚  ä¸šåŠ¡é€»è¾‘å¼‚å¸¸    â”‚   äººå·¥ä»‹å…¥       â”‚   å·¥å•å¤„ç†       â”‚
â”‚  æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸  â”‚   è‡ªåŠ¨è¡¥å¿       â”‚   å¯¹è´¦ä¿®å¤       â”‚
â”‚  ç³»ç»Ÿæ•…éšœå¼‚å¸¸    â”‚   é™çº§å¤„ç†       â”‚   å¤‡ç”¨æ–¹æ¡ˆ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 è‡ªåŠ¨ä¿®å¤æœºåˆ¶


**ğŸ”§ æ™ºèƒ½ä¿®å¤å¼•æ“**
```java
@Component
public class AutoRepairEngine {
    
    private final Map<Class<? extends Exception>, RepairStrategy> repairStrategies;
    
    public AutoRepairEngine() {
        repairStrategies = Map.of(
            NetworkTimeoutException.class, new RetryRepairStrategy(),
            DataInconsistencyException.class, new CompensationRepairStrategy(),
            BusinessLogicException.class, new ManualRepairStrategy()
        );
    }
    
    @EventListener
    public void handleException(ExceptionEvent event) {
        Exception exception = event.getException();
        RepairStrategy strategy = findRepairStrategy(exception);
        
        if (strategy.canAutoRepair(exception)) {
            RepairResult result = strategy.repair(event);
            
            if (result.isSuccess()) {
                log.info("è‡ªåŠ¨ä¿®å¤æˆåŠŸ: {}", event.getBusinessId());
            } else {
                // è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè½¬äººå·¥å¤„ç†
                escalateToManual(event, result);
            }
        } else {
            // ä¸èƒ½è‡ªåŠ¨ä¿®å¤ï¼Œç›´æ¥è½¬äººå·¥å¤„ç†
            escalateToManual(event, null);
        }
    }
    
    private RepairStrategy findRepairStrategy(Exception exception) {
        return repairStrategies.entrySet().stream()
            .filter(entry -> entry.getKey().isAssignableFrom(exception.getClass()))
            .map(Map.Entry::getValue)
            .findFirst()
            .orElse(new DefaultRepairStrategy());
    }
}

// é‡è¯•ä¿®å¤ç­–ç•¥
public class RetryRepairStrategy implements RepairStrategy {
    
    @Override
    public boolean canAutoRepair(Exception exception) {
        // ç½‘ç»œå¼‚å¸¸ä¸”é‡è¯•æ¬¡æ•°æœªè¶…é™
        return exception instanceof NetworkTimeoutException &&
               getRetryCount(exception) < 3;
    }
    
    @Override
    public RepairResult repair(ExceptionEvent event) {
        try {
            // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
            Thread.sleep(getRetryDelay(getRetryCount(event.getException())));
            
            // é‡æ–°æ‰§è¡ŒåŸæ“ä½œ
            event.getOriginalOperation().retry();
            
            return RepairResult.success();
            
        } catch (Exception e) {
            return RepairResult.failure("é‡è¯•å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### 8.3 ä¿®å¤æ•ˆæœéªŒè¯


**âœ… ä¿®å¤éªŒè¯æœºåˆ¶**
```java
@Service  
public class RepairVerificationService {
    
    public void verifyRepair(String businessId, RepairType repairType) {
        switch (repairType) {
            case DATA_COMPENSATION:
                verifyDataConsistency(businessId);
                break;
                
            case RETRY_SUCCESS:
                verifyOperationSuccess(businessId);
                break;
                
            case MANUAL_FIX:
                verifyManualFix(businessId);
                break;
        }
    }
    
    private void verifyDataConsistency(String businessId) {
        // æ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
        ConsistencyCheckResult result = consistencyChecker.check(businessId);
        
        if (!result.isConsistent()) {
            // ä¿®å¤å¤±è´¥ï¼Œé‡æ–°æ ‡è®°ä¸ºå¼‚å¸¸
            exceptionService.markAsUnresolved(businessId, 
                "æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥: " + result.getDifferences());
        } else {
            // ä¿®å¤æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
            exceptionService.markAsResolved(businessId);
        }
    }
}
```

---

## 9. ğŸ“Š SLAä¿è¯æœºåˆ¶


### 9.1 ä¸€è‡´æ€§çº§åˆ«SLAå®šä¹‰


**é€šä¿—ç†è§£**ï¼šSLAå°±åƒæœåŠ¡æ‰¿è¯ºä¹¦ï¼Œæ‰¿è¯ºåœ¨ä»€ä¹ˆæ—¶é—´å†…è¾¾åˆ°ä»€ä¹ˆç¨‹åº¦çš„ä¸€è‡´æ€§ã€‚

**â­ SLAåˆ†çº§å®šä¹‰**
```
ğŸ”¹ é‡‘ç‰ŒSLAï¼ˆ99.99%å¯ç”¨æ€§ï¼‰
   - ä¸€è‡´æ€§æ—¶é—´çª—å£ï¼š< 5ç§’
   - å¹´åº¦æ•…éšœæ—¶é—´ï¼š< 53åˆ†é’Ÿ
   - é€‚ç”¨ï¼šæ ¸å¿ƒæ”¯ä»˜ä¸šåŠ¡

ğŸ”¸ é“¶ç‰ŒSLAï¼ˆ99.9%å¯ç”¨æ€§ï¼‰  
   - ä¸€è‡´æ€§æ—¶é—´çª—å£ï¼š< 30ç§’
   - å¹´åº¦æ•…éšœæ—¶é—´ï¼š< 8.77å°æ—¶
   - é€‚ç”¨ï¼šè®¢å•å¤„ç†ä¸šåŠ¡

ğŸ”» é“œç‰ŒSLAï¼ˆ99.5%å¯ç”¨æ€§ï¼‰
   - ä¸€è‡´æ€§æ—¶é—´çª—å£ï¼š< 300ç§’  
   - å¹´åº¦æ•…éšœæ—¶é—´ï¼š< 1.83å¤©
   - é€‚ç”¨ï¼šç»Ÿè®¡åˆ†æä¸šåŠ¡
```

### 9.2 SLAç›‘æ§å®ç°


**ğŸ“ˆ SLAæŒ‡æ ‡ç›‘æ§**
```java
@Component
public class SLAMonitor {
    
    private final Map<String, SLAConfig> slaConfigs = Map.of(
        "PAYMENT", new SLAConfig(5000, 0.9999),      // 5ç§’ï¼Œ99.99%
        "ORDER", new SLAConfig(30000, 0.999),        // 30ç§’ï¼Œ99.9%
        "ANALYTICS", new SLAConfig(300000, 0.995)    // 5åˆ†é’Ÿï¼Œ99.5%
    );
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿç»Ÿè®¡
    public void calculateSLA() {
        for (Map.Entry<String, SLAConfig> entry : slaConfigs.entrySet()) {
            String businessType = entry.getKey();
            SLAConfig config = entry.getValue();
            
            // è·å–è¿‡å»1å°æ—¶çš„æ•°æ®
            List<ConsistencyRecord> records = 
                consistencyService.getRecords(businessType, Duration.ofHours(1));
            
            SLAMetrics metrics = calculateMetrics(records, config);
            
            // è®°å½•SLAæŒ‡æ ‡
            metricsService.recordSLA(businessType, metrics);
            
            // æ£€æŸ¥æ˜¯å¦è¿åSLA
            if (metrics.getAvailability() < config.getTargetAvailability()) {
                handleSLAViolation(businessType, metrics, config);
            }
        }
    }
    
    private SLAMetrics calculateMetrics(List<ConsistencyRecord> records, SLAConfig config) {
        long totalCount = records.size();
        long successCount = records.stream()
            .mapToLong(r -> r.getCompletionTime() <= config.getTimeWindow() ? 1 : 0)
            .sum();
        
        double availability = totalCount > 0 ? (double) successCount / totalCount : 1.0;
        
        return new SLAMetrics(availability, successCount, totalCount);
    }
}
```

### 9.3 SLAå‘Šè­¦ä¸å“åº”


**ğŸš¨ SLAè¿åå¤„ç†**
```java
public void handleSLAViolation(String businessType, SLAMetrics metrics, SLAConfig config) {
    SLAViolation violation = new SLAViolation(businessType, metrics, config);
    
    // 1. ç«‹å³å‘Šè­¦
    alertService.sendSLAViolationAlert(violation);
    
    // 2. è§¦å‘è‡ªåŠ¨æ¢å¤æªæ–½
    if (violation.getSeverity() == Severity.CRITICAL) {
        // ä¸¥é‡è¿åï¼šå¯åŠ¨é™çº§æªæ–½
        circuitBreakerService.activateDegradation(businessType);
        
        // å¢åŠ èµ„æºåˆ†é…
        resourceManager.scaleUp(businessType);
        
    } else if (violation.getSeverity() == Severity.WARNING) {
        // è­¦å‘Šçº§åˆ«ï¼šä¼˜åŒ–å¤„ç†
        optimizationService.optimize(businessType);
    }
    
    // 3. è®°å½•è¿åäº‹ä»¶
    slaViolationRepository.save(violation);
}
```

---

## 10. ğŸ“Š ç›‘æ§å‘Šè­¦ç³»ç»Ÿ


### 10.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**é€šä¿—ç†è§£**ï¼šå°±åƒæ±½è½¦ä»ªè¡¨ç›˜ä¸€æ ·ï¼Œæ˜¾ç¤ºå„ç§é‡è¦æŒ‡æ ‡ï¼Œæœ‰é—®é¢˜ç«‹å³æŠ¥è­¦ã€‚

**ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
ä¸€è‡´æ€§æŒ‡æ ‡ï¼š
â€¢ ä¸€è‡´æ€§è¾¾æˆç‡ï¼šæˆåŠŸè¾¾åˆ°ä¸€è‡´çŠ¶æ€çš„æ¯”ä¾‹
â€¢ å¹³å‡ä¸€è‡´æ€§æ—¶é—´ï¼šä»ä¸ä¸€è‡´åˆ°ä¸€è‡´çš„å¹³å‡æ—¶é—´
â€¢ ä¸€è‡´æ€§æ—¶é—´åˆ†å¸ƒï¼šP50ã€P90ã€P95ã€P99

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ æ¶ˆæ¯å¤„ç†æˆåŠŸç‡ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æˆåŠŸçš„æ¯”ä¾‹  
â€¢ è¡¥å¿ä»»åŠ¡æˆåŠŸç‡ï¼šå®šæ—¶è¡¥å¿ä»»åŠ¡çš„æˆåŠŸç‡
â€¢ å¯¹è´¦å·®å¼‚ç‡ï¼šå¯¹è´¦å‘ç°å·®å¼‚çš„æ¯”ä¾‹

ç³»ç»ŸæŒ‡æ ‡ï¼š
â€¢ ç³»ç»Ÿå¯ç”¨æ€§ï¼šå„æœåŠ¡çš„æ­£å¸¸è¿è¡Œæ—¶é—´æ¯”ä¾‹
â€¢ å“åº”æ—¶é—´ï¼šå„æ¥å£çš„å“åº”æ—¶é—´åˆ†å¸ƒ
â€¢ é”™è¯¯ç‡ï¼šå„ç±»å¼‚å¸¸çš„å‘ç”Ÿç‡
```

### 10.2 ç›‘æ§ç³»ç»Ÿå®ç°


**âš¡ å®æ—¶ç›‘æ§ç»„ä»¶**
```java
@Component
public class ConsistencyMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer consistencyTimer;
    private final Counter successCounter;
    private final Counter failureCounter;
    
    public ConsistencyMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.consistencyTimer = Timer.builder("consistency.time")
            .description("ä¸€è‡´æ€§è¾¾æˆæ—¶é—´")
            .register(meterRegistry);
        this.successCounter = Counter.builder("consistency.success")
            .description("ä¸€è‡´æ€§æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
        this.failureCounter = Counter.builder("consistency.failure")
            .description("ä¸€è‡´æ€§å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
    }
    
    @EventListener
    public void onConsistencyEvent(ConsistencyEvent event) {
        if (event.isSuccess()) {
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            successCounter.increment(Tags.of("business.type", event.getBusinessType()));
            consistencyTimer.record(event.getDuration(), TimeUnit.MILLISECONDS);
            
        } else {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            failureCounter.increment(Tags.of(
                "business.type", event.getBusinessType(),
                "failure.reason", event.getFailureReason()
            ));
        }
    }
    
    // è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
    @Component
    public class ConsistencyHealthIndicator implements HealthIndicator {
        
        @Override
        public Health health() {
            double successRate = calculateRecentSuccessRate();
            
            if (successRate >= 0.95) {
                return Health.up()
                    .withDetail("successRate", successRate)
                    .withDetail("status", "æ­£å¸¸")
                    .build();
            } else if (successRate >= 0.90) {
                return Health.status("WARNING")
                    .withDetail("successRate", successRate)
                    .withDetail("status", "è­¦å‘Š")
                    .build();
            } else {
                return Health.down()
                    .withDetail("successRate", successRate)
                    .withDetail("status", "å¼‚å¸¸")
                    .build();
            }
        }
    }
}
```

### 10.3 æ™ºèƒ½å‘Šè­¦ç­–ç•¥


**ğŸ”” å¤šçº§å‘Šè­¦æœºåˆ¶**
```java
@Service
public class SmartAlertService {
    
    // å‘Šè­¦çº§åˆ«å®šä¹‰
    public enum AlertLevel {
        INFO(0, "ä¿¡æ¯", "æ— éœ€å¤„ç†"),
        WARNING(1, "è­¦å‘Š", "å…³æ³¨å³å¯"), 
        ERROR(2, "é”™è¯¯", "éœ€è¦å¤„ç†"),
        CRITICAL(3, "ä¸¥é‡", "ç«‹å³å¤„ç†");
    }
    
    public void sendAlert(AlertEvent event) {
        AlertLevel level = determineAlertLevel(event);
        
        switch (level) {
            case INFO:
                // ä»…è®°å½•æ—¥å¿—ï¼Œä¸å‘é€é€šçŸ¥
                log.info("ä¿¡æ¯å‘Šè­¦: {}", event.getMessage());
                break;
                
            case WARNING:
                // å‘é€é‚®ä»¶é€šçŸ¥
                emailService.sendAlert(event, getOnCallDevelopers());
                break;
                
            case ERROR:
                // å‘é€é‚®ä»¶+çŸ­ä¿¡é€šçŸ¥
                emailService.sendAlert(event, getOnCallDevelopers());
                smsService.sendAlert(event, getOnCallDevelopers());
                break;
                
            case CRITICAL:
                // å‘é€æ‰€æœ‰é€šçŸ¥+ç”µè¯å‘Šè­¦
                emailService.sendAlert(event, getAllDevelopers());
                smsService.sendAlert(event, getAllDevelopers());
                phoneService.callAlert(event, getOnCallManagers());
                
                // è‡ªåŠ¨åˆ›å»ºç´§æ€¥å·¥å•
                ticketService.createEmergencyTicket(event);
                break;
        }
        
        // è®°å½•å‘Šè­¦å†å²
        alertHistoryService.recordAlert(level, event);
    }
    
    // å‘Šè­¦æŠ‘åˆ¶ï¼šé˜²æ­¢å‘Šè­¦é£æš´
    @Component
    public class AlertSuppressor {
        
        private final Map<String, LocalDateTime> lastAlertTime = new ConcurrentHashMap<>();
        private final Duration suppressionWindow = Duration.ofMinutes(5);
        
        public boolean shouldSuppressAlert(String alertKey) {
            LocalDateTime lastTime = lastAlertTime.get(alertKey);
            LocalDateTime now = LocalDateTime.now();
            
            if (lastTime == null || now.isAfter(lastTime.plus(suppressionWindow))) {
                lastAlertTime.put(alertKey, now);
                return false; // ä¸æŠ‘åˆ¶
            } else {
                return true; // æŠ‘åˆ¶å‘Šè­¦
            }
        }
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§æœ¬è´¨ï¼šå®¹å¿çŸ­æœŸä¸ä¸€è‡´ï¼Œä¿è¯æœ€ç»ˆæ”¶æ•›
ğŸ”¸ å¯é æ¶ˆæ¯æœºåˆ¶ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ç¡®ä¿æ“ä½œæœ€ç»ˆæ‰§è¡Œ
ğŸ”¸ æœ€å¤§åŠªåŠ›é€šçŸ¥ï¼šå°½åŠ›é‡è¯•ï¼Œè¾¾åˆ°ä¸Šé™åæ”¾å¼ƒ
ğŸ”¸ å®šæ—¶è¡¥å¿ï¼šé€šè¿‡å®šæ—¶ä»»åŠ¡ä¿®å¤å¼‚å¸¸çŠ¶æ€
ğŸ”¸ çŠ¶æ€æœºç®¡ç†ï¼šä¸¥æ ¼æ§åˆ¶çŠ¶æ€è½¬æ¢ï¼Œä¿è¯ä¸šåŠ¡æ­£ç¡®æ€§
ğŸ”¸ æ•°æ®å¯¹è´¦ï¼šå®šæœŸæ¯”å¯¹æ•°æ®ï¼Œå‘ç°å¹¶ä¿®å¤å·®å¼‚
ğŸ”¸ æ—¶é—´çª—å£æ§åˆ¶ï¼šè®¾å®šåˆç†çš„ä¸€è‡´æ€§è¾¾æˆæ—¶é—´é¢„æœŸ
ğŸ”¸ SLAä¿è¯ï¼šå»ºç«‹æœåŠ¡ç­‰çº§æ‰¿è¯ºå’Œç›‘æ§ä½“ç³»
```

### 11.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ è®¾è®¡åŸåˆ™**
```
ä¸šåŠ¡ä¼˜å…ˆï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ–¹æ¡ˆ
æ¸è¿›å¼ï¼šä»ç®€å•æ–¹æ¡ˆå¼€å§‹ï¼Œé€æ­¥å®Œå–„
å¯è§‚æµ‹ï¼šå…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
å¯æ¢å¤ï¼šå¼‚å¸¸æƒ…å†µä¸‹çš„è‡ªåŠ¨å’Œæ‰‹å·¥æ¢å¤èƒ½åŠ›
```

**ğŸ”¹ æŠ€æœ¯é€‰å‹æŒ‡å—**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
â†’ é€‰æ‹©å¯é æ¶ˆæ¯ + å¼‚æ­¥å¤„ç†
â†’ æ³¨é‡æ€§èƒ½å’Œååé‡

å¼ºä¸šåŠ¡é€»è¾‘ï¼š
â†’ é€‰æ‹©çŠ¶æ€æœº + è¡¥å¿æœºåˆ¶  
â†’ æ³¨é‡ä¸šåŠ¡æ­£ç¡®æ€§

ç®€å•åœºæ™¯ï¼š
â†’ é€‰æ‹©æœ€å¤§åŠªåŠ›é€šçŸ¥
â†’ æ³¨é‡å®ç°ç®€å•æ€§

é‡‘èåœºæ™¯ï¼š
â†’ ç»„åˆå¤šç§æ–¹æ¡ˆ
â†’ æ³¨é‡æ•°æ®å‡†ç¡®æ€§
```

### 11.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ’¡ æ¶æ„è®¾è®¡å»ºè®®**
```
åˆ†å±‚è®¾è®¡ï¼š
â€¢ ä¸šåŠ¡å±‚ï¼šä¸“æ³¨ä¸šåŠ¡é€»è¾‘
â€¢ ä¸€è‡´æ€§å±‚ï¼šå¤„ç†åˆ†å¸ƒå¼ä¸€è‡´æ€§
â€¢ åŸºç¡€è®¾æ–½å±‚ï¼šæä¾›å¯é çš„æ¶ˆæ¯ã€å­˜å‚¨ç­‰æœåŠ¡

ç»„ä»¶åŒ–ï¼š
â€¢ æ¶ˆæ¯ç»„ä»¶ï¼šç»Ÿä¸€çš„æ¶ˆæ¯å‘é€å’Œå¤„ç†
â€¢ è¡¥å¿ç»„ä»¶ï¼šé€šç”¨çš„è¡¥å¿ä»»åŠ¡æ¡†æ¶  
â€¢ ç›‘æ§ç»„ä»¶ï¼šä¸€è‡´æ€§æŒ‡æ ‡ç›‘æ§
â€¢ å‘Šè­¦ç»„ä»¶ï¼šæ™ºèƒ½å‘Šè­¦å’Œå‡çº§
```

**ğŸ› ï¸ è¿ç»´æœ€ä½³å®è·µ**
```
é¢„é˜²ä¸ºä¸»ï¼š
â€¢ å®Œå–„çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç‰¹åˆ«æ˜¯å¼‚å¸¸åœºæ™¯
â€¢ å®¹é‡è§„åˆ’ï¼Œé¿å…ç³»ç»Ÿè¿‡è½½
â€¢ å®šæœŸæ¼”ç»ƒï¼ŒéªŒè¯æ¢å¤æœºåˆ¶

å¿«é€Ÿå“åº”ï¼š
â€¢ å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
â€¢ æ¸…æ™°çš„æ•…éšœå¤„ç†æµç¨‹
â€¢ è‡ªåŠ¨åŒ–çš„æ¢å¤å·¥å…·

æŒç»­æ”¹è¿›ï¼š
â€¢ å®šæœŸåˆ†æä¸€è‡´æ€§æŒ‡æ ‡è¶‹åŠ¿
â€¢ ä¼˜åŒ–è¡¥å¿ç­–ç•¥å’Œæ—¶é—´çª—å£
â€¢ æ€»ç»“æ•…éšœç»éªŒï¼Œå®Œå–„æœºåˆ¶
```

### 11.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ æ¶ˆæ¯é‡å¤å¤„ç†**
```
é—®é¢˜ï¼šç½‘ç»œé‡è¯•å¯¼è‡´æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹
è§£å†³ï¼šå®ç°å¹‚ç­‰æ€§å¤„ç†ï¼Œä½¿ç”¨å”¯ä¸€æ ‡è¯†å»é‡
```

**â“ è¡¥å¿ä»»åŠ¡è¿‡å¤š**
```
é—®é¢˜ï¼šå¤§é‡è¡¥å¿ä»»åŠ¡å½±å“ç³»ç»Ÿæ€§èƒ½
è§£å†³ï¼šä¼˜åŒ–é‡è¯•ç­–ç•¥ï¼Œå®ç°æ™ºèƒ½é™æµ
```

**â“ å¯¹è´¦å·®å¼‚è¿‡å¤š**
```
é—®é¢˜ï¼šå¯¹è´¦å‘ç°å¤§é‡å·®å¼‚ï¼Œå¤„ç†ä¸è¿‡æ¥
è§£å†³ï¼šåˆ†æå·®å¼‚æ ¹å› ï¼Œä¼˜åŒ–ä¸šåŠ¡æµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æœ€ç»ˆä¸€è‡´ä¸è¦æ€¥ï¼Œæ—¶é—´çª—å£è¦æ§åˆ¶
- æ¶ˆæ¯å¯é æ˜¯åŸºç¡€ï¼Œé‡è¯•è¡¥å¿æ¥å…œåº•  
- çŠ¶æ€æœºå™¨ç®¡æµç¨‹ï¼Œå¯¹è´¦ç›‘æ§ä¿è´¨é‡
- SLAæ‰¿è¯ºè¦å…‘ç°ï¼Œå‘Šè­¦å“åº”è¦åŠæ—¶