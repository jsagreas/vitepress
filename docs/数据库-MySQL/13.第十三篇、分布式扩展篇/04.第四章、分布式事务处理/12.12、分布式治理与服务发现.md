---
title: 12ã€åˆ†å¸ƒå¼æ²»ç†ä¸æœåŠ¡å‘ç°
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼æ²»ç†æ¦‚è¿°](#1-åˆ†å¸ƒå¼æ²»ç†æ¦‚è¿°)
2. [é…ç½®ä¸­å¿ƒé›†æˆ](#2-é…ç½®ä¸­å¿ƒé›†æˆ)
3. [æ³¨å†Œä¸­å¿ƒç®¡ç†](#3-æ³¨å†Œä¸­å¿ƒç®¡ç†)
4. [åŠ¨æ€é…ç½®æ›´æ–°](#4-åŠ¨æ€é…ç½®æ›´æ–°)
5. [æœåŠ¡å‘ç°æœºåˆ¶](#5-æœåŠ¡å‘ç°æœºåˆ¶)
6. [åˆ†å¸ƒå¼é”æ”¯æŒ](#6-åˆ†å¸ƒå¼é”æ”¯æŒ)
7. [å…ƒæ•°æ®ç®¡ç†](#7-å…ƒæ•°æ®ç®¡ç†)
8. [é›†ç¾¤åè°ƒæœåŠ¡](#8-é›†ç¾¤åè°ƒæœåŠ¡)
9. [é…ç½®ä¸­å¿ƒé€‰å‹å¯¹æ¯”](#9-é…ç½®ä¸­å¿ƒé€‰å‹å¯¹æ¯”)
10. [æœ€ä½³å®è·µä¸æ•…éšœå¤„ç†](#10-æœ€ä½³å®è·µä¸æ•…éšœå¤„ç†)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼æ²»ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ²»ç†


**åˆ†å¸ƒå¼æ²»ç†**å°±åƒæ˜¯ç»™æ•´ä¸ªé›†ç¾¤å®‰æ’ä¸€ä¸ª"ç®¡å®¶"ï¼Œè´Ÿè´£åè°ƒå„ä¸ªèŠ‚ç‚¹çš„å·¥ä½œã€‚

```
ä¼ ç»Ÿå•æœºåº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åº    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚é…ç½®æ–‡ä»¶â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹1   â”‚  â”‚ èŠ‚ç‚¹2   â”‚  â”‚ èŠ‚ç‚¹3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€ é…ç½®ä¸­å¿ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ ç»Ÿä¸€ç®¡ç† â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼æ²»ç†


**æ ¸å¿ƒé—®é¢˜**ï¼š
- **é…ç½®åŒæ­¥**ï¼šå¤šä¸ªèŠ‚ç‚¹å¦‚ä½•ä¿æŒé…ç½®ä¸€è‡´ï¼Ÿ
- **æœåŠ¡å‘ç°**ï¼šæ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œå…¶ä»–èŠ‚ç‚¹å¦‚ä½•çŸ¥é“ï¼Ÿ
- **æ•…éšœå¤„ç†**ï¼šæŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå¦‚ä½•è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ
- **åè°ƒå·¥ä½œ**ï¼šå¤šä¸ªèŠ‚ç‚¹å¦‚ä½•åè°ƒé¿å…å†²çªï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
ğŸ”¸ é…ç½®ä¸­å¿ƒï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®
ğŸ”¸ æ³¨å†Œä¸­å¿ƒï¼šè®°å½•æ‰€æœ‰å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šé¿å…å¤šä¸ªèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œç›¸åŒä»»åŠ¡
ğŸ”¸ å…ƒæ•°æ®ç®¡ç†ï¼šç»Ÿä¸€ç®¡ç†æ•°æ®åº“ç»“æ„ä¿¡æ¯
```

### 1.3 ShardingSphereæ²»ç†æ¶æ„


```
                    â”Œâ”€ åº”ç”¨1 â”€â”
                    â”‚        â”‚
    é…ç½®ä¸­å¿ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ åº”ç”¨2 â”€â”¤
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚        â”‚
    â”‚ZooKeeperâ”‚     â””â”€ åº”ç”¨3 â”€â”˜
    â”‚  Etcd   â”‚          â”‚
    â”‚ Apollo  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Nacos   â”‚     â”‚ æ•°æ®æºé›†ç¾¤  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚          â”‚ â”‚ MySQL1 â”‚ â”‚
         â”‚          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚ â”‚ MySQL2 â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ é…ç½®ä¸­å¿ƒé›†æˆ


### 2.1 é…ç½®ä¸­å¿ƒçš„ä½œç”¨


**é…ç½®ä¸­å¿ƒ**å°±åƒæ˜¯ä¸€ä¸ª"æ€»æœºæˆ¿"ï¼Œæ‰€æœ‰çš„é…ç½®éƒ½å­˜æ”¾åœ¨è¿™é‡Œï¼Œå„ä¸ªåº”ç”¨éƒ½æ¥è¿™é‡Œå–é…ç½®ã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š
- **é›†ä¸­å­˜å‚¨**ï¼šæ‰€æœ‰é…ç½®ç»Ÿä¸€å­˜æ”¾
- **ç‰ˆæœ¬ç®¡ç†**ï¼šé…ç½®å˜æ›´æœ‰å†å²è®°å½•
- **åŠ¨æ€æ›´æ–°**ï¼šé…ç½®æ”¹äº†ç«‹å³é€šçŸ¥æ‰€æœ‰åº”ç”¨
- **æƒé™æ§åˆ¶**ï¼šæ§åˆ¶è°èƒ½ä¿®æ”¹é…ç½®

### 2.2 ZooKeeperé…ç½®ä¸­å¿ƒ


**ZooKeeper**æ˜¯æœ€å¸¸ç”¨çš„é…ç½®ä¸­å¿ƒï¼Œå°±åƒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ ‘å½¢ç»“æ„å­˜å‚¨é…ç½®ã€‚

```yaml
# application.yml
spring:
  shardingsphere:
    orchestration:
      name: sharding-orchestration
      overwrite: true
      zookeeper:
        namespace: sharding-demo
        server-lists: localhost:2181
        digest: # å¯é€‰ï¼Œè®¿é—®æƒé™
```

**ZooKeeperèŠ‚ç‚¹ç»“æ„**ï¼š
```
/sharding-demo
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ schema
â”‚   â”œâ”€â”€ rule
â”‚   â””â”€â”€ props
â”œâ”€â”€ state
â”‚   â”œâ”€â”€ datasources
â”‚   â””â”€â”€ primarynodes
â””â”€â”€ metadata
    â””â”€â”€ sharding_db
```

### 2.3 Etcdé…ç½®ä¸­å¿ƒæ”¯æŒ


**Etcd**æ˜¯å¦ä¸€ç§é…ç½®ä¸­å¿ƒï¼Œç‰¹ç‚¹æ˜¯é«˜æ€§èƒ½å’Œå¼ºä¸€è‡´æ€§ã€‚

```yaml
spring:
  shardingsphere:
    orchestration:
      name: sharding-orchestration
      overwrite: true
      etcd:
        server-lists: http://localhost:2379
        time-to-live-seconds: 60 # å¿ƒè·³é—´éš”
```

**Etcdç‰¹ç‚¹**ï¼š
- **æ€§èƒ½æ›´å¥½**ï¼šæ¯”ZooKeeperå“åº”æ›´å¿«
- **HTTPæ¥å£**ï¼šä½¿ç”¨HTTP APIï¼Œæ›´å®¹æ˜“é›†æˆ
- **å¼ºä¸€è‡´æ€§**ï¼šä½¿ç”¨Raftç®—æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 2.4 Apolloé…ç½®ä¸­å¿ƒé›†æˆ


**Apollo**æ˜¯æºç¨‹å¼€æºçš„é…ç½®ä¸­å¿ƒï¼Œç•Œé¢å‹å¥½ï¼ŒåŠŸèƒ½å¼ºå¤§ã€‚

```yaml
spring:
  shardingsphere:
    orchestration:
      name: sharding-orchestration
      overwrite: true
      apollo:
        namespace: application
        apollo-meta: http://localhost:8080
        app-id: sharding-demo
```

**Apolloä¼˜åŠ¿**ï¼š
- **å¯è§†åŒ–ç•Œé¢**ï¼šæœ‰Webç®¡ç†ç•Œé¢
- **ç°åº¦å‘å¸ƒ**ï¼šå¯ä»¥å…ˆåœ¨éƒ¨åˆ†èŠ‚ç‚¹æµ‹è¯•é…ç½®
- **é…ç½®ç»§æ‰¿**ï¼šæ”¯æŒé…ç½®çš„ç»§æ‰¿å’Œè¦†ç›–

### 2.5 NacosæœåŠ¡å‘ç°


**Nacos**æ—¢æ˜¯é…ç½®ä¸­å¿ƒï¼Œä¹Ÿæ˜¯æ³¨å†Œä¸­å¿ƒï¼Œé˜¿é‡Œå·´å·´å¼€æºã€‚

```yaml
spring:
  shardingsphere:
    orchestration:
      name: sharding-orchestration
      overwrite: true
      nacos:
        server-lists: localhost:8848
        namespace: sharding-demo
        group: DEFAULT_GROUP
```

**Nacosç‰¹è‰²åŠŸèƒ½**ï¼š
- **å¤šç¯å¢ƒç®¡ç†**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- **é…ç½®æ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒPropertiesã€YAMLã€JSONç­‰æ ¼å¼
- **æœåŠ¡æ²»ç†**ï¼šé™¤äº†é…ç½®ç®¡ç†ï¼Œè¿˜æœ‰æœåŠ¡æ³¨å†Œå‘ç°

---

## 3. ğŸ“‹ æ³¨å†Œä¸­å¿ƒç®¡ç†


### 3.1 æ³¨å†Œä¸­å¿ƒçš„æ ¸å¿ƒæ¦‚å¿µ


**æ³¨å†Œä¸­å¿ƒ**å°±åƒæ˜¯ä¸€ä¸ª"ç”µè¯ç°¿"ï¼Œè®°å½•äº†æ‰€æœ‰å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯ã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š
```
ğŸ”¸ æœåŠ¡æ³¨å†Œï¼šæ–°èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œå‘æ³¨å†Œä¸­å¿ƒæŠ¥å‘Šè‡ªå·±çš„å­˜åœ¨
ğŸ”¸ æœåŠ¡å‘ç°ï¼šå…¶ä»–èŠ‚ç‚¹å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰å¯ç”¨çš„èŠ‚ç‚¹
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šå®šæœŸæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è¿˜æ´»ç€
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå¸®åŠ©é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹å¤„ç†è¯·æ±‚
```

### 3.2 ConsulæœåŠ¡æ³¨å†Œ


**Consul**æ˜¯HashiCorpå¼€å‘çš„æœåŠ¡å‘ç°å·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§ä¸”æ˜“ç”¨ã€‚

```yaml
spring:
  shardingsphere:
    orchestration:
      name: sharding-orchestration
      overwrite: true
      consul:
        server-lists: localhost:8500
        props:
          time-to-live-seconds: 30
          block-query-time-to-seconds: 60
```

**Consulç‰¹ç‚¹**ï¼š
- **å¤šæ•°æ®ä¸­å¿ƒ**ï¼šæ”¯æŒè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å‘ç°
- **å¥åº·æ£€æŸ¥**ï¼šå†…ç½®å¤šç§å¥åº·æ£€æŸ¥æ–¹å¼
- **KVå­˜å‚¨**ï¼šå¯ä»¥å­˜å‚¨é…ç½®ä¿¡æ¯
- **Webç•Œé¢**ï¼šæä¾›ç›´è§‚çš„ç®¡ç†ç•Œé¢

### 3.3 æœåŠ¡æ³¨å†Œæµç¨‹


```
èŠ‚ç‚¹å¯åŠ¨                    æ³¨å†Œä¸­å¿ƒ
   â”‚                         â”‚
   â”‚â”€â”€[1]æœåŠ¡æ³¨å†Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚   (IP,Port,å¥åº·çŠ¶æ€)      â”‚
   â”‚                         â”‚
   â”‚â†â”€[2]æ³¨å†ŒæˆåŠŸç¡®è®¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                         â”‚
   â”‚â”€â”€[3]å®šæœŸå¿ƒè·³â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚   (æ¯30ç§’)               â”‚
   â”‚                         â”‚
   â”‚â†â”€[4]å¥åº·æ£€æŸ¥ç¡®è®¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                         â”‚
```

### 3.4 æœåŠ¡å‘ç°æœºåˆ¶


**æœåŠ¡å‘ç°**å°±æ˜¯è®©åº”ç”¨èƒ½å¤Ÿæ‰¾åˆ°å®ƒéœ€è¦çš„æœåŠ¡èŠ‚ç‚¹ã€‚

```java
// æœåŠ¡å‘ç°ç¤ºä¾‹
@Component
public class DataSourceDiscovery {
    
    // è·å–æ‰€æœ‰å¯ç”¨çš„æ•°æ®æºèŠ‚ç‚¹
    public List<DataSourceNode> getAvailableDataSources() {
        // ä»æ³¨å†Œä¸­å¿ƒæŸ¥è¯¢å¥åº·çš„æ•°æ®æºèŠ‚ç‚¹
        return registryCenter.getChildrenKeys("/datasources")
            .stream()
            .filter(this::isHealthy)
            .map(this::toDataSourceNode)
            .collect(Collectors.toList());
    }
    
    private boolean isHealthy(String nodePath) {
        // æ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€
        return registryCenter.get(nodePath + "/status").equals("ONLINE");
    }
}
```

### 3.5 èŠ‚ç‚¹çŠ¶æ€ç®¡ç†


**èŠ‚ç‚¹çŠ¶æ€**è¡¨ç¤ºæ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„å½“å‰æƒ…å†µï¼š

| çŠ¶æ€ | å«ä¹‰ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| **ONLINE** | `èŠ‚ç‚¹æ­£å¸¸è¿è¡Œ` | `å¯ä»¥æ¥æ”¶è¯·æ±‚` |
| **OFFLINE** | `èŠ‚ç‚¹ä¸»åŠ¨ä¸‹çº¿` | `åœæ­¢å‘é€è¯·æ±‚` |
| **CIRCUIT_BREAK** | `èŠ‚ç‚¹æ•…éšœç†”æ–­` | `æš‚æ—¶åœæ­¢ä½¿ç”¨` |
| **DISABLED** | `èŠ‚ç‚¹è¢«ç¦ç”¨` | `ç®¡ç†å‘˜æ‰‹åŠ¨ç¦ç”¨` |

---

## 4. ğŸ”„ åŠ¨æ€é…ç½®æ›´æ–°


### 4.1 é…ç½®å˜æ›´é€šçŸ¥æœºåˆ¶


**é…ç½®å˜æ›´é€šçŸ¥**å°±åƒæ˜¯"ç¾¤å‘çŸ­ä¿¡"ï¼Œé…ç½®ä¸€æ—¦æ”¹å˜ï¼Œç«‹å³é€šçŸ¥æ‰€æœ‰ç›¸å…³çš„åº”ç”¨ã€‚

```
é…ç½®ä¸­å¿ƒ                     åº”ç”¨èŠ‚ç‚¹ä»¬
   â”‚                         â”‚
   â”‚â”€â”€â”€â”€â”€[é…ç½®å˜æ›´]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ èŠ‚ç‚¹1
   â”‚     (æ•°æ®æºé…ç½®)          â”‚
   â”‚                         â”‚
   â”‚â”€â”€â”€â”€â”€[é…ç½®å˜æ›´]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ èŠ‚ç‚¹2
   â”‚                         â”‚
   â”‚                         â”‚
   â”‚â”€â”€â”€â”€â”€[é…ç½®å˜æ›´]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ èŠ‚ç‚¹3
```

### 3.2 ç›‘å¬æœºåˆ¶å®ç°


**é…ç½®ç›‘å¬**è®©åº”ç”¨èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥é…ç½®å˜åŒ–ï¼š

```java
@Component
public class ConfigurationListener {
    
    @EventListener
    public void onDataSourceChanged(DataSourceChangedEvent event) {
        log.info("æ•°æ®æºé…ç½®å‘ç”Ÿå˜æ›´: {}", event.getChangedDataSources());
        
        // é‡æ–°åŠ è½½æ•°æ®æºè¿æ¥æ± 
        reloadDataSources(event.getChangedDataSources());
        
        // æ¸…ç†æ—§çš„è¿æ¥
        cleanupOldConnections();
    }
    
    @EventListener  
    public void onShardingRuleChanged(ShardingRuleChangedEvent event) {
        log.info("åˆ†ç‰‡è§„åˆ™å‘ç”Ÿå˜æ›´");
        
        // é‡æ–°æ„å»ºåˆ†ç‰‡è§„åˆ™
        rebuildShardingRules(event.getNewRules());
    }
}
```

### 4.3 é…ç½®çƒ­æ›´æ–°æµç¨‹


```
1. ç®¡ç†å‘˜ä¿®æ”¹é…ç½®
   â”‚
   â–¼
2. é…ç½®ä¸­å¿ƒå­˜å‚¨æ–°é…ç½®
   â”‚
   â–¼
3. è§¦å‘å˜æ›´äº‹ä»¶
   â”‚
   â–¼
4. é€šçŸ¥æ‰€æœ‰è®¢é˜…çš„åº”ç”¨
   â”‚
   â–¼
5. åº”ç”¨é‡æ–°åŠ è½½é…ç½®
   â”‚
   â–¼
6. æ–°é…ç½®ç”Ÿæ•ˆ
```

### 4.4 é…ç½®ç‰ˆæœ¬ç®¡ç†ç­–ç•¥


**ç‰ˆæœ¬ç®¡ç†**ç¡®ä¿é…ç½®å˜æ›´çš„å¯è¿½æº¯å’Œå¯å›æ»šï¼š

```yaml
# é…ç½®ç‰ˆæœ¬ä¿¡æ¯
version: 
  current: "1.2.3"
  previous: "1.2.2"
  history:
    - version: "1.2.3"
      timestamp: "2025-01-09T10:30:00"
      changes: ["æ–°å¢è¯»å†™åˆ†ç¦»é…ç½®"]
    - version: "1.2.2"
      timestamp: "2025-01-08T15:20:00"
      changes: ["ä¿®æ”¹åˆ†ç‰‡ç®—æ³•"]
```

**ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥**ï¼š
- **è¯­ä¹‰åŒ–ç‰ˆæœ¬**ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
- **å˜æ›´è®°å½•**ï¼šæ¯æ¬¡å˜æ›´éƒ½è®°å½•åŸå› å’Œå†…å®¹
- **å¿«é€Ÿå›æ»š**ï¼šæ”¯æŒä¸€é”®å›æ»šåˆ°ä¸Šä¸ªç‰ˆæœ¬

---

## 5. ğŸ” æœåŠ¡å‘ç°æœºåˆ¶


### 5.1 æœåŠ¡å‘ç°çš„å·¥ä½œåŸç†


**æœåŠ¡å‘ç°**å°±åƒæ˜¯"æ‰¾æœ‹å‹"çš„è¿‡ç¨‹ï¼Œåº”ç”¨éœ€è¦çŸ¥é“å…¶ä»–æœåŠ¡åœ¨å“ªé‡Œã€‚

```
å®¢æˆ·ç«¯åº”ç”¨                   æ³¨å†Œä¸­å¿ƒ                    æœåŠ¡æä¾›è€…
    â”‚                         â”‚                         â”‚
    â”‚â”€[1]æŸ¥è¯¢æœåŠ¡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                         â”‚
    â”‚                         â”‚â†â”€[2]æœåŠ¡æ³¨å†Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â†â”€[3]è¿”å›æœåŠ¡åœ°å€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
    â”‚                         â”‚                         â”‚
    â”‚â”€â”€â”€â”€â”€[4]ç›´æ¥è°ƒç”¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
```

### 5.2 è´Ÿè½½å‡è¡¡ç­–ç•¥


å½“æœ‰å¤šä¸ªç›¸åŒçš„æœåŠ¡èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **è½®è¯¢** | `ä¾æ¬¡é€‰æ‹©æ¯ä¸ªèŠ‚ç‚¹` | `èŠ‚ç‚¹æ€§èƒ½ç›¸è¿‘` |
| **éšæœº** | `éšæœºé€‰æ‹©èŠ‚ç‚¹` | `ç®€å•åœºæ™¯` |
| **åŠ æƒè½®è¯¢** | `æ ¹æ®æƒé‡åˆ†é…è¯·æ±‚` | `èŠ‚ç‚¹æ€§èƒ½ä¸åŒ` |
| **æœ€å°‘è¿æ¥** | `é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„èŠ‚ç‚¹` | `é•¿è¿æ¥åœºæ™¯` |

```java
// è´Ÿè½½å‡è¡¡å®ç°ç¤ºä¾‹
@Component
public class LoadBalancer {
    
    public DataSourceNode selectNode(List<DataSourceNode> nodes, String strategy) {
        switch (strategy) {
            case "ROUND_ROBIN":
                return roundRobin(nodes);
            case "RANDOM":
                return random(nodes);
            case "WEIGHTED":
                return weighted(nodes);
            default:
                return nodes.get(0);
        }
    }
    
    private DataSourceNode roundRobin(List<DataSourceNode> nodes) {
        int index = counter.getAndIncrement() % nodes.size();
        return nodes.get(index);
    }
}
```

### 5.3 å¥åº·æ£€æŸ¥æœºåˆ¶


**å¥åº·æ£€æŸ¥**ç¡®ä¿åªä½¿ç”¨æ­£å¸¸å·¥ä½œçš„æœåŠ¡èŠ‚ç‚¹ï¼š

```java
@Component
public class HealthChecker {
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkHealth() {
        for (DataSourceNode node : getAllNodes()) {
            try {
                // æ‰§è¡Œç®€å•æŸ¥è¯¢æµ‹è¯•è¿æ¥
                Connection conn = node.getConnection();
                conn.createStatement().execute("SELECT 1");
                
                // æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ä¸ºå¥åº·
                updateNodeStatus(node, NodeStatus.HEALTHY);
                
            } catch (Exception e) {
                log.warn("èŠ‚ç‚¹{}å¥åº·æ£€æŸ¥å¤±è´¥", node.getAddress());
                updateNodeStatus(node, NodeStatus.UNHEALTHY);
            }
        }
    }
}
```

---

## 6. ğŸ”’ åˆ†å¸ƒå¼é”æ”¯æŒ


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**åˆ†å¸ƒå¼é”**å°±åƒæ˜¯ç»™æ•´ä¸ªé›†ç¾¤ä¸Šä¸€æŠŠé”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½æ‰§è¡Œç‰¹å®šæ“ä½œã€‚

**å…¸å‹åœºæ™¯**ï¼š
```
ğŸ”¸ æ•°æ®åº“åˆ‡æ¢ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œä¸»ä»åˆ‡æ¢
ğŸ”¸ é…ç½®æ›´æ–°ï¼šé¿å…å¤šä¸ªèŠ‚ç‚¹åŒæ—¶ä¿®æ”¹é…ç½®
ğŸ”¸ å®šæ—¶ä»»åŠ¡ï¼šé˜²æ­¢å¤šä¸ªèŠ‚ç‚¹é‡å¤æ‰§è¡ŒåŒä¸€ä»»åŠ¡
ğŸ”¸ èµ„æºåˆ†é…ï¼šç¡®ä¿èµ„æºä¸è¢«é‡å¤åˆ†é…
```

### 6.2 åˆ†å¸ƒå¼åè°ƒç®—æ³•


**å¸¸ç”¨çš„åˆ†å¸ƒå¼åè°ƒç®—æ³•**ï¼š

**Raftç®—æ³•**ï¼š
```
é¢†å¯¼è€…é€‰ä¸¾è¿‡ç¨‹ï¼š
å€™é€‰è€…A â”€â”€â”€â”€[è¯·æ±‚æŠ•ç¥¨]â”€â”€â”€â”€â†’ èŠ‚ç‚¹B
         â†â”€â”€â”€[åŒæ„æŠ•ç¥¨]â”€â”€â”€â”€â”€
         â”€â”€â”€â”€[è¯·æ±‚æŠ•ç¥¨]â”€â”€â”€â”€â†’ èŠ‚ç‚¹C  
         â†â”€â”€â”€[åŒæ„æŠ•ç¥¨]â”€â”€â”€â”€â”€

å½“Aè·å¾—å¤šæ•°ç¥¨åï¼Œæˆä¸ºé¢†å¯¼è€…
```

**ZABç®—æ³•**ï¼ˆZooKeeperä½¿ç”¨ï¼‰ï¼š
- **åŸå­å¹¿æ’­**ï¼šç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°ç›¸åŒçš„æ›´æ–°
- **å´©æºƒæ¢å¤**ï¼šé¢†å¯¼è€…å´©æºƒåå¿«é€Ÿé€‰å‡ºæ–°é¢†å¯¼è€…
- **é¡ºåºä¿è¯**ï¼šæ“ä½œæŒ‰é¡ºåºæ‰§è¡Œ

### 6.3 åˆ†å¸ƒå¼é”å®ç°


```java
@Component
public class DistributedLock {
    
    // è·å–åˆ†å¸ƒå¼é”
    public boolean tryLock(String lockKey, long timeout) {
        String lockPath = "/locks/" + lockKey;
        
        try {
            // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
            String nodePath = zkClient.create(lockPath + "/lock-", 
                "".getBytes(), CreateMode.EPHEMERAL_SEQUENTIAL);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹ï¼ˆè·å¾—é”ï¼‰
            List<String> children = zkClient.getChildren(lockPath);
            Collections.sort(children);
            
            if (nodePath.endsWith(children.get(0))) {
                return true; // è·å¾—é”
            } else {
                // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
                watchPreviousNode(lockPath, children, nodePath);
                return false;
            }
            
        } catch (Exception e) {
            log.error("è·å–åˆ†å¸ƒå¼é”å¤±è´¥", e);
            return false;
        }
    }
    
    // é‡Šæ”¾é”
    public void unlock(String lockKey) {
        String lockPath = "/locks/" + lockKey;
        zkClient.delete(lockPath);
    }
}
```

### 6.4 é”çš„åº”ç”¨åœºæ™¯


**ä¸»ä»åˆ‡æ¢åœºæ™¯**ï¼š
```java
@Service
public class MasterSlaveSwitch {
    
    @Autowired
    private DistributedLock distributedLock;
    
    public void switchMaster(String dataSourceName) {
        String lockKey = "switch_master_" + dataSourceName;
        
        if (distributedLock.tryLock(lockKey, 30000)) {
            try {
                // æ‰§è¡Œä¸»ä»åˆ‡æ¢é€»è¾‘
                doSwitchMaster(dataSourceName);
                
                // é€šçŸ¥å…¶ä»–èŠ‚ç‚¹
                notifyMasterChanged(dataSourceName);
                
            } finally {
                distributedLock.unlock(lockKey);
            }
        } else {
            log.info("å…¶ä»–èŠ‚ç‚¹æ­£åœ¨æ‰§è¡Œä¸»ä»åˆ‡æ¢ï¼Œè·³è¿‡");
        }
    }
}
```

---

## 7. ğŸ“Š å…ƒæ•°æ®ç®¡ç†


### 7.1 å…ƒæ•°æ®çš„æ¦‚å¿µ


**å…ƒæ•°æ®**å°±æ˜¯"æè¿°æ•°æ®çš„æ•°æ®"ï¼Œåœ¨æ•°æ®åº“ä¸­å°±æ˜¯è¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸç­‰ä¿¡æ¯ã€‚

**ShardingSphereä¸­çš„å…ƒæ•°æ®**ï¼š
```
ğŸ”¸ è¡¨ç»“æ„ä¿¡æ¯ï¼šå­—æ®µåã€ç±»å‹ã€çº¦æŸç­‰
ğŸ”¸ åˆ†ç‰‡è§„åˆ™ï¼šæ•°æ®å¦‚ä½•åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹
ğŸ”¸ æ•°æ®æºä¿¡æ¯ï¼šæ¯ä¸ªæ•°æ®åº“çš„è¿æ¥ä¿¡æ¯
ğŸ”¸ ç´¢å¼•ä¿¡æ¯ï¼šå“ªäº›å­—æ®µå»ºäº†ç´¢å¼•
```

### 7.2 å…ƒæ•°æ®åŒæ­¥æœºåˆ¶


```
ä¸»èŠ‚ç‚¹                      é…ç½®ä¸­å¿ƒ                     ä»èŠ‚ç‚¹
  â”‚                          â”‚                          â”‚
  â”‚â”€[1]å…ƒæ•°æ®å˜æ›´]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
  â”‚  (æ–°å¢è¡¨ç»“æ„)             â”‚                          â”‚
  â”‚                          â”‚â”€[2]å¹¿æ’­å˜æ›´]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                          â”‚                          â”‚
  â”‚                          â”‚â†â”€[3]ç¡®è®¤æ”¶åˆ°]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚â†â”€[4]åŒæ­¥å®Œæˆç¡®è®¤]â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
```

### 7.3 å…ƒæ•°æ®ç‰ˆæœ¬ç®¡ç†ç­–ç•¥


**ç‰ˆæœ¬æ§åˆ¶ç¡®ä¿å…ƒæ•°æ®çš„ä¸€è‡´æ€§**ï¼š

```yaml
# å…ƒæ•°æ®ç‰ˆæœ¬ä¿¡æ¯
metadata:
  version: "2.1.0"
  tables:
    - name: "user"
      version: "1.2.0"
      schema_hash: "abc123def456"
      last_updated: "2025-01-09T10:30:00"
    - name: "order"  
      version: "1.1.0"
      schema_hash: "def456ghi789"
      last_updated: "2025-01-08T15:20:00"
```

**ç‰ˆæœ¬å†²çªå¤„ç†**ï¼š
```
å¦‚æœå‘ç°ç‰ˆæœ¬å†²çªï¼š
1. æš‚åœç›¸å…³æ“ä½œ
2. å¯¹æ¯”å…ƒæ•°æ®å·®å¼‚
3. é€‰æ‹©æœ€æ–°ç‰ˆæœ¬æˆ–äººå·¥å†³ç­–
4. åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
5. æ¢å¤æ­£å¸¸æ“ä½œ
```

### 7.4 å…ƒæ•°æ®ç¼“å­˜ä¼˜åŒ–


**æœ¬åœ°ç¼“å­˜ç­–ç•¥**ï¼š
```java
@Component
public class MetadataCache {
    
    private final LoadingCache<String, TableMetadata> tableCache;
    
    public MetadataCache() {
        this.tableCache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .refreshAfterWrite(5, TimeUnit.MINUTES)
            .build(this::loadTableMetadata);
    }
    
    public TableMetadata getTableMetadata(String tableName) {
        return tableCache.get(tableName);
    }
    
    // å½“é…ç½®ä¸­å¿ƒé€šçŸ¥å…ƒæ•°æ®å˜æ›´æ—¶ï¼Œæ¸…ç†ç¼“å­˜
    @EventListener
    public void onMetadataChanged(MetadataChangedEvent event) {
        tableCache.invalidate(event.getTableName());
    }
}
```

---

## 8. ğŸ¤ é›†ç¾¤åè°ƒæœåŠ¡


### 8.1 é›†ç¾¤åè°ƒçš„æ ¸å¿ƒä»»åŠ¡


**é›†ç¾¤åè°ƒæœåŠ¡**å°±åƒæ˜¯ä¸€ä¸ª"æŒ‡æŒ¥å®˜"ï¼Œåè°ƒå„ä¸ªèŠ‚ç‚¹çš„å·¥ä½œï¼š

```
ğŸ”¸ é¢†å¯¼è€…é€‰ä¸¾ï¼šé€‰å‡ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºåè°ƒè€…
ğŸ”¸ ä»»åŠ¡åˆ†é…ï¼šå°†å·¥ä½œåˆç†åˆ†é…ç»™å„ä¸ªèŠ‚ç‚¹
ğŸ”¸ çŠ¶æ€åŒæ­¥ï¼šä¿æŒæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€ä¸€è‡´
ğŸ”¸ æ•…éšœæ¢å¤ï¼šèŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨å¤„ç†
```

### 8.2 é¢†å¯¼è€…é€‰ä¸¾æœºåˆ¶


**é€‰ä¸¾è¿‡ç¨‹**ï¼š
```
åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯è·Ÿéšè€…
    â”‚
    â–¼
è¶…æ—¶åæŸä¸ªèŠ‚ç‚¹å‘èµ·é€‰ä¸¾
    â”‚
    â–¼
èŠ‚ç‚¹å‘å…¶ä»–èŠ‚ç‚¹è¯·æ±‚æŠ•ç¥¨
    â”‚
    â–¼ 
è·å¾—å¤šæ•°ç¥¨åæˆä¸ºé¢†å¯¼è€…
    â”‚
    â–¼
å®šæœŸå‘é€å¿ƒè·³ç»´æŒé¢†å¯¼åœ°ä½
```

```java
@Component
public class LeaderElection {
    
    private volatile boolean isLeader = false;
    
    @PostConstruct
    public void startElection() {
        String leaderPath = "/cluster/leader";
        
        try {
            // å°è¯•åˆ›å»ºé¢†å¯¼è€…èŠ‚ç‚¹
            zkClient.create(leaderPath, getNodeInfo().getBytes(),
                CreateMode.EPHEMERAL);
            
            isLeader = true;
            log.info("æˆä¸ºé›†ç¾¤é¢†å¯¼è€…");
            
            // å¼€å§‹æ‰§è¡Œé¢†å¯¼è€…ä»»åŠ¡
            startLeaderTasks();
            
        } catch (NodeExistsException e) {
            // é¢†å¯¼è€…å·²å­˜åœ¨ï¼Œç›‘å¬é¢†å¯¼è€…å˜åŒ–
            watchLeader(leaderPath);
        }
    }
    
    private void startLeaderTasks() {
        // é¢†å¯¼è€…è´Ÿè´£çš„ä»»åŠ¡
        scheduleHealthCheck();
        scheduleConfigSync();
        scheduleLoadBalancing();
    }
}
```

### 8.3 é›†ç¾¤è„‘è£‚å¤„ç†æœºåˆ¶


**è„‘è£‚é—®é¢˜**ï¼šç½‘ç»œåˆ†åŒºå¯¼è‡´é›†ç¾¤åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯éƒ¨åˆ†éƒ½è®¤ä¸ºè‡ªå·±æ˜¯å®Œæ•´é›†ç¾¤ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```
ğŸ”¸ æ³•å®šäººæ•°æœºåˆ¶ï¼šåªæœ‰è¶…è¿‡åŠæ•°èŠ‚ç‚¹çš„åˆ†åŒºæ‰èƒ½å·¥ä½œ
ğŸ”¸ ä»²è£èŠ‚ç‚¹ï¼šæ·»åŠ ä»²è£èŠ‚ç‚¹å¸®åŠ©å†³ç­–
ğŸ”¸ ä¼˜å…ˆçº§æœºåˆ¶ï¼šæŒ‡å®šæŸäº›èŠ‚ç‚¹ä¼˜å…ˆçº§æ›´é«˜
ğŸ”¸ äººå·¥å¹²é¢„ï¼šä¸¥é‡æƒ…å†µä¸‹éœ€è¦äººå·¥å¤„ç†
```

**è„‘è£‚æ£€æµ‹ä¸å¤„ç†**ï¼š
```java
@Component
public class SplitBrainHandler {
    
    public void handleSplitBrain() {
        int activeNodes = getActiveNodeCount();
        int totalNodes = getTotalNodeCount();
        
        if (activeNodes <= totalNodes / 2) {
            log.warn("æ£€æµ‹åˆ°å¯èƒ½çš„è„‘è£‚ï¼Œå½“å‰æ´»è·ƒèŠ‚ç‚¹æ•°: {}, æ€»èŠ‚ç‚¹æ•°: {}", 
                activeNodes, totalNodes);
            
            // è¿›å…¥åªè¯»æ¨¡å¼ï¼Œåœæ­¢å†™æ“ä½œ
            enterReadOnlyMode();
            
            // ç­‰å¾…ç½‘ç»œæ¢å¤
            waitForNetworkRecovery();
        }
    }
    
    private void enterReadOnlyMode() {
        // ç¦ç”¨æ‰€æœ‰å†™æ“ä½œ
        configurationManager.setReadOnly(true);
        
        // é€šçŸ¥åº”ç”¨å±‚
        eventPublisher.publishEvent(new ReadOnlyModeEvent());
    }
}
```

---

## 9. ğŸ“‹ é…ç½®ä¸­å¿ƒé€‰å‹å¯¹æ¯”


### 9.1 ä¸»æµé…ç½®ä¸­å¿ƒå¯¹æ¯”


| ç‰¹æ€§ | **ZooKeeper** | **Etcd** | **Apollo** | **Nacos** | **Consul** |
|------|---------------|----------|------------|-----------|------------|
| **æ€§èƒ½** | `ä¸­ç­‰` | `é«˜` | `ä¸­ç­‰` | `é«˜` | `ä¸­ç­‰` |
| **ä¸€è‡´æ€§** | `å¼ºä¸€è‡´` | `å¼ºä¸€è‡´` | `æœ€ç»ˆä¸€è‡´` | `å¼ºä¸€è‡´` | `å¼ºä¸€è‡´` |
| **ç•Œé¢** | `æ— ` | `ç®€å•` | `ä¸°å¯Œ` | `ä¸°å¯Œ` | `ç®€å•` |
| **å¤šç¯å¢ƒ** | `ä¸€èˆ¬` | `ä¸€èˆ¬` | `ä¼˜ç§€` | `ä¼˜ç§€` | `ä¸€èˆ¬` |
| **å­¦ä¹ æˆæœ¬** | `é«˜` | `ä¸­` | `ä½` | `ä½` | `ä¸­` |

### 9.2 é€‰å‹å»ºè®®


**ZooKeeperé€‚ç”¨åœºæ™¯**ï¼š
```
âœ… å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
âœ… å·²æœ‰ZooKeeperåŸºç¡€è®¾æ–½
âœ… å›¢é˜Ÿæœ‰ZooKeeperè¿ç»´ç»éªŒ
âŒ ä¸éœ€è¦å¤æ‚çš„é…ç½®ç®¡ç†ç•Œé¢
```

**Apolloé€‚ç”¨åœºæ™¯**ï¼š
```
âœ… éœ€è¦å‹å¥½çš„ç®¡ç†ç•Œé¢
âœ… è¦æ±‚ç²¾ç»†çš„æƒé™æ§åˆ¶
âœ… éœ€è¦é…ç½®çš„ç°åº¦å‘å¸ƒ
âŒ å¯¹æ€§èƒ½è¦æ±‚ä¸æ˜¯æè‡´
```

**Nacosé€‚ç”¨åœºæ™¯**ï¼š
```
âœ… å¾®æœåŠ¡æ¶æ„
âœ… éœ€è¦æœåŠ¡å‘ç° + é…ç½®ç®¡ç†
âœ… é˜¿é‡Œå·´å·´æŠ€æœ¯æ ˆ
âœ… äº‘åŸç”Ÿç¯å¢ƒ
```

### 9.3 é…ç½®ä¸­å¿ƒè¿ç§»ç­–ç•¥


**è¿ç§»æ­¥éª¤**ï¼š
```
1. è¯„ä¼°ç°æœ‰é…ç½®
   â”‚
   â–¼
2. é€‰æ‹©ç›®æ ‡é…ç½®ä¸­å¿ƒ
   â”‚  
   â–¼
3. æ­å»ºæ–°é…ç½®ä¸­å¿ƒç¯å¢ƒ
   â”‚
   â–¼
4. é…ç½®æ•°æ®è¿ç§»
   â”‚
   â–¼
5. åº”ç”¨é€æ­¥åˆ‡æ¢
   â”‚
   â–¼
6. éªŒè¯åŠŸèƒ½æ­£å¸¸
   â”‚
   â–¼
7. ä¸‹çº¿æ—§é…ç½®ä¸­å¿ƒ
```

**åŒå†™ç­–ç•¥**ï¼š
```java
@Component
public class DualWriteConfigCenter {
    
    @Autowired
    private ZooKeeperConfigCenter oldCenter;
    
    @Autowired  
    private NacosConfigCenter newCenter;
    
    public void updateConfig(String key, String value) {
        try {
            // å…ˆå†™æ–°é…ç½®ä¸­å¿ƒ
            newCenter.updateConfig(key, value);
            
            // å†å†™æ—§é…ç½®ä¸­å¿ƒ
            oldCenter.updateConfig(key, value);
            
        } catch (Exception e) {
            // å†™å…¥å¤±è´¥æ—¶çš„å›æ»šé€»è¾‘
            rollbackUpdate(key, value);
        }
    }
}
```

---

## 10. ğŸ› ï¸ æœ€ä½³å®è·µä¸æ•…éšœå¤„ç†


### 10.1 é…ç½®ç®¡ç†æœ€ä½³å®è·µ


**é…ç½®åˆ†å±‚ç®¡ç†**ï¼š
```
ç¯å¢ƒå±‚çº§ï¼š
â”œâ”€â”€ å…¨å±€é…ç½®ï¼ˆæ‰€æœ‰ç¯å¢ƒå…±äº«ï¼‰
â”‚   â”œâ”€â”€ åŸºç¡€æ¡†æ¶é…ç½®
â”‚   â””â”€â”€ é€šç”¨ä¸šåŠ¡è§„åˆ™
â”œâ”€â”€ ç¯å¢ƒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
â”‚   â”œâ”€â”€ æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ å¤–éƒ¨æœåŠ¡åœ°å€
â””â”€â”€ åº”ç”¨é…ç½®ï¼ˆç‰¹å®šåº”ç”¨ï¼‰
    â”œâ”€â”€ åˆ†ç‰‡è§„åˆ™
    â””â”€â”€ ç¼“å­˜é…ç½®
```

**é…ç½®å‘½åè§„èŒƒ**ï¼š
```yaml
# æ¨èçš„é…ç½®å‘½å
shardingsphere:
  datasource:
    master:
      driver: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://master:3306/db
    slave:
      driver: com.mysql.cj.jdbc.Driver  
      url: jdbc:mysql://slave:3306/db
      
# é¿å…çš„å‘½åæ–¹å¼
ds1: 
  driver: xxx
  url: xxx
ds2:
  driver: xxx
  url: xxx
```

### 10.2 ç›‘æ§å‘Šè­¦æœºåˆ¶


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```
ğŸ”¸ é…ç½®ä¸­å¿ƒè¿æ¥çŠ¶æ€
ğŸ”¸ é…ç½®å˜æ›´é¢‘ç‡
ğŸ”¸ èŠ‚ç‚¹å¥åº·çŠ¶æ€
ğŸ”¸ é€‰ä¸¾æ¬¡æ•°
ğŸ”¸ ç½‘ç»œåˆ†åŒºæ£€æµ‹
```

```java
@Component
public class GovernanceMonitor {
    
    @Scheduled(fixedRate = 60000)
    public void monitorHealth() {
        // æ£€æŸ¥é…ç½®ä¸­å¿ƒè¿æ¥
        if (!configCenter.isConnected()) {
            alertManager.sendAlert("é…ç½®ä¸­å¿ƒè¿æ¥å¼‚å¸¸");
        }
        
        // æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
        long unhealthyNodes = getUnhealthyNodeCount();
        if (unhealthyNodes > 0) {
            alertManager.sendAlert("å‘ç°{}ä¸ªå¼‚å¸¸èŠ‚ç‚¹", unhealthyNodes);
        }
        
        // æ£€æŸ¥é€‰ä¸¾é¢‘ç‡
        if (getElectionCount() > ELECTION_THRESHOLD) {
            alertManager.sendAlert("é€‰ä¸¾è¿‡äºé¢‘ç¹ï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œé—®é¢˜");
        }
    }
}
```

### 10.3 å¸¸è§æ•…éšœå¤„ç†


**é…ç½®ä¸­å¿ƒå®•æœºå¤„ç†**ï¼š
```
æ•…éšœç°è±¡ï¼šæ— æ³•è¿æ¥é…ç½®ä¸­å¿ƒ
å¤„ç†æ­¥éª¤ï¼š
1. åº”ç”¨åˆ‡æ¢åˆ°æœ¬åœ°ç¼“å­˜é…ç½®
2. å¯åŠ¨é…ç½®ä¸­å¿ƒå¤‡ç”¨èŠ‚ç‚¹
3. æ•°æ®åŒæ­¥åˆ°æ–°èŠ‚ç‚¹
4. åº”ç”¨é‡æ–°è¿æ¥é…ç½®ä¸­å¿ƒ
5. ä¿®å¤åŸæ•…éšœèŠ‚ç‚¹
```

**ç½‘ç»œåˆ†åŒºå¤„ç†**ï¼š
```
æ•…éšœç°è±¡ï¼šé›†ç¾¤åˆ†æˆå¤šä¸ªåˆ†åŒº
å¤„ç†æ­¥éª¤ï¼š
1. è¯†åˆ«ä¸»åˆ†åŒºï¼ˆèŠ‚ç‚¹æ•°è¿‡åŠï¼‰
2. éä¸»åˆ†åŒºè¿›å…¥åªè¯»æ¨¡å¼
3. ç­‰å¾…ç½‘ç»œæ¢å¤
4. é‡æ–°åŠ å…¥é›†ç¾¤
5. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
```

**æ•°æ®ä¸ä¸€è‡´å¤„ç†**ï¼š
```java
@Component
public class ConsistencyChecker {
    
    public void checkAndRepair() {
        // æ¯”è¾ƒå„èŠ‚ç‚¹çš„é…ç½®ç‰ˆæœ¬
        Map<String, String> nodeVersions = getAllNodeVersions();
        
        String latestVersion = findLatestVersion(nodeVersions);
        
        // ä¿®å¤ä¸ä¸€è‡´çš„èŠ‚ç‚¹
        for (Map.Entry<String, String> entry : nodeVersions.entrySet()) {
            if (!entry.getValue().equals(latestVersion)) {
                repairNode(entry.getKey(), latestVersion);
            }
        }
    }
    
    private void repairNode(String nodeId, String targetVersion) {
        log.info("ä¿®å¤èŠ‚ç‚¹{}åˆ°ç‰ˆæœ¬{}", nodeId, targetVersion);
        
        // ä»é…ç½®ä¸­å¿ƒé‡æ–°æ‹‰å–é…ç½®
        String config = configCenter.getConfig(targetVersion);
        
        // æ¨é€åˆ°ç›®æ ‡èŠ‚ç‚¹
        pushConfigToNode(nodeId, config);
    }
}
```

### 10.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**è¿æ¥æ± ä¼˜åŒ–**ï¼š
```yaml
# é…ç½®ä¸­å¿ƒè¿æ¥æ± è®¾ç½®
zookeeper:
  connection-timeout: 15000
  session-timeout: 60000
  max-retries: 3
  base-sleep-time: 1000
  max-sleep-time: 3000
```

**ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼š
```java
@Configuration
public class CacheConfiguration {
    
    @Bean
    public CacheManager configCacheManager() {
        CaffeineCacheManager cacheManager = new CaffeineCacheManager();
        cacheManager.setCaffeine(Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(30, TimeUnit.MINUTES)
            .recordStats()); // å¼€å¯ç»Ÿè®¡
        return cacheManager;
    }
}
```

---

## 11. ğŸ“š æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼æ²»ç†ï¼šé€šè¿‡é…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†é›†ç¾¤
ğŸ”¸ é…ç½®ä¸­å¿ƒï¼šZooKeeperã€Etcdã€Apolloã€Nacosç­‰
ğŸ”¸ æ³¨å†Œä¸­å¿ƒï¼šæœåŠ¡æ³¨å†Œã€å‘ç°ã€å¥åº·æ£€æŸ¥
ğŸ”¸ åŠ¨æ€é…ç½®ï¼šé…ç½®çƒ­æ›´æ–°ã€ç‰ˆæœ¬ç®¡ç†
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šåè°ƒå¤šèŠ‚ç‚¹é¿å…å†²çª
ğŸ”¸ å…ƒæ•°æ®ç®¡ç†ï¼šè¡¨ç»“æ„ä¿¡æ¯çš„ç»Ÿä¸€ç®¡ç†
ğŸ”¸ é›†ç¾¤åè°ƒï¼šé¢†å¯¼è€…é€‰ä¸¾ã€è„‘è£‚å¤„ç†
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼æ²»ç†**
```
é—®é¢˜ï¼šå¤šèŠ‚ç‚¹é…ç½®ä¸ä¸€è‡´ã€æœåŠ¡å‘ç°å›°éš¾
è§£å†³ï¼šç»Ÿä¸€çš„é…ç½®ä¸­å¿ƒå’Œæ³¨å†Œä¸­å¿ƒ
æ”¶ç›Šï¼šé…ç½®åŒæ­¥ã€æ•…éšœè‡ªæ„ˆã€è¿ç»´ç®€åŒ–
```

**ğŸ”¹ é…ç½®ä¸­å¿ƒé€‰å‹è€ƒè™‘**
```
æ€§èƒ½è¦æ±‚ï¼šEtcd > ZooKeeper > Apollo
åŠŸèƒ½å®Œæ•´æ€§ï¼šApollo > Nacos > Consul  
æ˜“ç”¨æ€§ï¼šApollo = Nacos > Consul > ZooKeeper
ä¸€è‡´æ€§ï¼šZooKeeper = Etcd = Consul > Apollo
```

**ğŸ”¹ åˆ†å¸ƒå¼é”çš„ä½¿ç”¨åœºæ™¯**
```
å¿…é¡»ä½¿ç”¨ï¼šä¸»ä»åˆ‡æ¢ã€é…ç½®æ›´æ–°ã€å®šæ—¶ä»»åŠ¡
æ€§èƒ½å½±å“ï¼šå¢åŠ å»¶è¿Ÿï¼Œä½†ä¿è¯ä¸€è‡´æ€§
å®ç°æ–¹å¼ï¼šåŸºäºé…ç½®ä¸­å¿ƒçš„ä¸´æ—¶èŠ‚ç‚¹
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæ”¶ç›Š**
- **è¿ç»´æ•ˆç‡**ï¼šé…ç½®ç»Ÿä¸€ç®¡ç†ï¼Œå‡å°‘äººå·¥é”™è¯¯
- **ç³»ç»Ÿå¯é æ€§**ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤
- **æ‰©å±•æ€§**ï¼šæ–°èŠ‚ç‚¹è‡ªåŠ¨åŠ å…¥é›†ç¾¤
- **ç›‘æ§èƒ½åŠ›**ï¼šé›†ä¸­ç›‘æ§é›†ç¾¤çŠ¶æ€

**ğŸ› ï¸ å®æ–½å»ºè®®**
- **èµ·æ­¥é˜¶æ®µ**ï¼šé€‰æ‹©ç®€å•æ˜“ç”¨çš„Nacosæˆ–Apollo
- **é«˜æ€§èƒ½è¦æ±‚**ï¼šé€‰æ‹©Etcd
- **å·²æœ‰åŸºç¡€è®¾æ–½**ï¼šä½¿ç”¨ç°æœ‰çš„ZooKeeper
- **ä¼ä¸šçº§åº”ç”¨**ï¼šè€ƒè™‘å•†ä¸šç‰ˆæœ¬çš„æŠ€æœ¯æ”¯æŒ

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼æ²»ç†è§£å†³å¤šèŠ‚ç‚¹åè°ƒé—®é¢˜
- é…ç½®ä¸­å¿ƒæ˜¯é›†ç¾¤çš„"å¤§è„‘"
- æ³¨å†Œä¸­å¿ƒæ˜¯æœåŠ¡çš„"ç”µè¯ç°¿"
- åˆ†å¸ƒå¼é”é¿å…å¹¶å‘å†²çª
- é€‰å‹è¦è€ƒè™‘æ€§èƒ½ã€åŠŸèƒ½ã€æ˜“ç”¨æ€§