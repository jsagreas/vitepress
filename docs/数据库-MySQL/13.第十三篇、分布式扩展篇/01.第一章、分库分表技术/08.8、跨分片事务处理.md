---
title: 8ã€è·¨åˆ†ç‰‡äº‹åŠ¡å¤„ç†
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [ä¸¤é˜¶æ®µæäº¤åè®®è¯¦è§£](#2-ä¸¤é˜¶æ®µæäº¤åè®®è¯¦è§£)
3. [XAåˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†](#3-XAåˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†)
4. [TCCäº‹åŠ¡æ¨¡å¼å®è·µ](#4-TCCäº‹åŠ¡æ¨¡å¼å®è·µ)
5. [Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼](#5-Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼)
6. [æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ](#6-æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ)
7. [æœ¬åœ°æ¶ˆæ¯è¡¨æœºåˆ¶](#7-æœ¬åœ°æ¶ˆæ¯è¡¨æœºåˆ¶)
8. [äº‹åŠ¡è¡¥å¿ä¸å›æ»šç­–ç•¥](#8-äº‹åŠ¡è¡¥å¿ä¸å›æ»šç­–ç•¥)
9. [åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§ä¸è¿½è¸ª](#9-åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§ä¸è¿½è¸ª)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨ç½‘ä¸Šè´­ç‰©ï¼Œä»˜æ¬¾æ—¶éœ€è¦åŒæ—¶å®Œæˆå‡ ä»¶äº‹ï¼š
- æ‰£å‡ä½ çš„è´¦æˆ·ä½™é¢
- å¢åŠ å•†å®¶çš„æ”¶å…¥
- å‡å°‘å•†å“åº“å­˜
- ç”Ÿæˆè®¢å•è®°å½•

è¿™äº›æ“ä½œåˆ†å¸ƒåœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œè¿™å°±æ˜¯**åˆ†å¸ƒå¼äº‹åŠ¡**ã€‚

```
å•æœºäº‹åŠ¡ï¼ˆç®€å•ï¼‰ï¼š           åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¤æ‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸€ä¸ªæ•°æ®åº“  â”‚             â”‚ ç”¨æˆ·åº“  â”‚  â”‚ å•†å“åº“  â”‚  â”‚ è®¢å•åº“  â”‚
â”‚  â”Œâ”€â”¬â”€â”¬â”€â”   â”‚             â”‚ æ‰£æ¬¾   â”‚  â”‚ å‡åº“å­˜  â”‚  â”‚ åˆ›è®¢å•  â”‚
â”‚  â”‚ â”‚ â”‚ â”‚   â”‚             â”‚        â”‚  â”‚        â”‚  â”‚        â”‚
â”‚  â””â”€â”´â”€â”´â”€â”˜   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    éœ€è¦ä¿è¯ä¸€è‡´æ€§
```

### 1.2 ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æŒ‘æˆ˜


**ACIDå›é¡¾**ï¼š
- **A**tomicityï¼ˆåŸå­æ€§ï¼‰ï¼šè¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš
- **C**onsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€
- **I**solationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šäº‹åŠ¡ä¹‹é—´äº’ä¸å¹²æ‰°  
- **D**urabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šæäº¤åæ°¸ä¹…ä¿å­˜

**åˆ†å¸ƒå¼ç¯å¢ƒçš„éš¾ç‚¹**ï¼š
```
æŒ‘æˆ˜1ï¼šç½‘ç»œåˆ†åŒº
ç”¨æˆ·åº“ âœ… æ‰£æ¬¾æˆåŠŸ
  â†“ ç½‘ç»œæ–­å¼€ âŒ
å•†å“åº“ âŒ å‡åº“å­˜å¤±è´¥

æŒ‘æˆ˜2ï¼šéƒ¨åˆ†å¤±è´¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œ1   â”‚  â”‚ æ“ä½œ2   â”‚  â”‚ æ“ä½œ3   â”‚
â”‚ âœ…æˆåŠŸ  â”‚  â”‚ âœ…æˆåŠŸ  â”‚  â”‚ âŒå¤±è´¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å‰é¢æˆåŠŸçš„æ€ä¹ˆåŠï¼Ÿ

æŒ‘æˆ˜3ï¼šæ€§èƒ½é—®é¢˜
åˆ†å¸ƒå¼åè°ƒ â†’ ç½‘ç»œé€šä¿¡ â†’ å»¶è¿Ÿå¢åŠ  â†’ é”ç­‰å¾…
```

### 1.3 CAPå®šç†çš„åˆ¶çº¦


> ğŸ’¡ **CAPå®šç†**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆCï¼‰ã€å¯ç”¨æ€§ï¼ˆAï¼‰ã€åˆ†åŒºå®¹é”™æ€§ï¼ˆPï¼‰æœ€å¤šåªèƒ½ä¿è¯ä¸¤ä¸ª

**ç°å®é€‰æ‹©**ï¼š
- **CPç³»ç»Ÿ**ï¼šä¿è¯ä¸€è‡´æ€§ï¼Œç‰ºç‰²éƒ¨åˆ†å¯ç”¨æ€§ï¼ˆé‡‘èç³»ç»Ÿï¼‰
- **APç³»ç»Ÿ**ï¼šä¿è¯å¯ç”¨æ€§ï¼Œå…è®¸æš‚æ—¶ä¸ä¸€è‡´ï¼ˆç¤¾äº¤åª’ä½“ï¼‰

---

## 2. âš–ï¸ ä¸¤é˜¶æ®µæäº¤åè®®è¯¦è§£


### 2.1 2PCåè®®åŸºæœ¬åŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠæäº¤è¿‡ç¨‹åˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼Œå°±åƒç»„ç»‡é›†ä½“æ´»åŠ¨æŠ•ç¥¨ä¸€æ ·ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
é˜¶æ®µ1 - è¯¢é—®æ„è§ï¼š"æ˜å¤©å»éƒŠæ¸¸ï¼Œå¤§å®¶æœ‰ç©ºå—ï¼Ÿ"
        æ¯ä¸ªäººå›ç­”ï¼š"æœ‰ç©º" æˆ– "æ²¡ç©º"
é˜¶æ®µ2 - æœ€ç»ˆå†³å®šï¼šå¦‚æœå…¨éƒ¨æœ‰ç©º â†’ "æ˜å¤©å‡ºå‘"
                  å¦‚æœæœ‰äººæ²¡ç©º â†’ "æ´»åŠ¨å–æ¶ˆ"

2PCäº‹åŠ¡è¿‡ç¨‹ï¼š
åè°ƒè€…                å‚ä¸è€…1(ç”¨æˆ·åº“)    å‚ä¸è€…2(å•†å“åº“)    å‚ä¸è€…3(è®¢å•åº“)
    |                      |               |               |
    |---[é˜¶æ®µ1:å‡†å¤‡]------->|               |               |
    |                      |<--å‡†å¤‡å°±ç»ª-----|               |
    |<-----å‡†å¤‡å°±ç»ª----------|               |               |
    |---[é˜¶æ®µ1:å‡†å¤‡]--------|-------------->|               |
    |<-----å‡†å¤‡å°±ç»ª----------|<--å‡†å¤‡å°±ç»ª-----|               |
    |---[é˜¶æ®µ1:å‡†å¤‡]--------|---------------|-------------->|
    |<-----å‡†å¤‡å°±ç»ª----------|---------------|<--å‡†å¤‡å°±ç»ª-----|
    |                      |               |               |
    |---[é˜¶æ®µ2:æäº¤]------->|               |               |
    |---[é˜¶æ®µ2:æäº¤]--------|-------------->|               |
    |---[é˜¶æ®µ2:æäº¤]--------|---------------|-------------->|
    |<-----æäº¤å®Œæˆ----------|               |               |
    |<-----æäº¤å®Œæˆ----------|<--æäº¤å®Œæˆ-----|               |
    |<-----æäº¤å®Œæˆ----------|<--æäº¤å®Œæˆ-----|<--æäº¤å®Œæˆ-----|
```

### 2.2 åè®®å®ç°æ­¥éª¤


**é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰**
```sql
-- åè°ƒè€…å‘é€å‡†å¤‡å‘½ä»¤
PREPARE TRANSACTION 'tx_001';

-- å„å‚ä¸è€…æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä½†ä¸æäº¤
START TRANSACTION;
UPDATE user_account SET balance = balance - 100 WHERE user_id = 123;
-- å†™å…¥æ—¥å¿—ï¼Œé”å®šèµ„æºï¼Œä½†ä¸æäº¤
-- å›å¤ï¼šYESï¼ˆå‡†å¤‡å°±ç»ªï¼‰æˆ– NOï¼ˆå‡†å¤‡å¤±è´¥ï¼‰
```

**é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰**
```sql
-- å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å›å¤YES
COMMIT PREPARED 'tx_001';

-- å¦‚æœæœ‰å‚ä¸è€…å›å¤NO
ROLLBACK PREPARED 'tx_001';
```

### 2.3 2PCçš„ä¼˜ç¼ºç‚¹åˆ†æ


**ä¼˜ç‚¹**ï¼š
- âœ… **å¼ºä¸€è‡´æ€§**ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… **å®ç°ç®€å•**ï¼šé€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£
- âœ… **å¹¿æ³›æ”¯æŒ**ï¼šå¤§å¤šæ•°æ•°æ®åº“éƒ½æ”¯æŒ

**ç¼ºç‚¹**ï¼š
- âŒ **åŒæ­¥é˜»å¡**ï¼šå‚ä¸è€…åœ¨ç­‰å¾…æœŸé—´è¢«é”å®š
- âŒ **å•ç‚¹æ•…éšœ**ï¼šåè°ƒè€…å´©æºƒå¯¼è‡´ç³»ç»Ÿé˜»å¡
- âŒ **æ€§èƒ½è¾ƒå·®**ï¼šéœ€è¦å¤šè½®ç½‘ç»œé€šä¿¡

```
æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹ï¼š
å•æœºäº‹åŠ¡ï¼š100ms
2PCäº‹åŠ¡ï¼š300-500msï¼ˆå¢åŠ 200-400msï¼‰

åŸå› åˆ†æï¼š
â”œâ”€â”€ ç½‘ç»œé€šä¿¡å»¶è¿Ÿï¼š50ms Ã— 4æ¬¡ = 200ms
â”œâ”€â”€ åè°ƒå¼€é”€ï¼š50ms
â”œâ”€â”€ é”ç­‰å¾…æ—¶é—´ï¼š100-200ms
â””â”€â”€ æ—¥å¿—å†™å…¥ï¼šé¢å¤–50ms
```

---

## 3. ğŸ”§ XAåˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†


### 3.1 XAæ ‡å‡†ç®€ä»‹


**ä»€ä¹ˆæ˜¯XA**ï¼šXAæ˜¯X/Openç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†ï¼Œå°±åƒåˆ¶å®šäº†ä¸€å¥—"é€šç”¨è¯­è¨€"è®©ä¸åŒçš„æ•°æ®åº“éƒ½èƒ½å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

```
XAæ¶æ„å›¾ï¼š
åº”ç”¨ç¨‹åº (Application Program)
    |
äº‹åŠ¡ç®¡ç†å™¨ (Transaction Manager - TM)
    |
èµ„æºç®¡ç†å™¨ (Resource Manager - RM)
    |        |        |
  æ•°æ®åº“A   æ•°æ®åº“B   æ¶ˆæ¯é˜Ÿåˆ—C
```

### 3.2 XAäº‹åŠ¡çŠ¶æ€è½¬æ¢


```
XAäº‹åŠ¡ç”Ÿå‘½å‘¨æœŸï¼š
                å¼€å§‹
                 â†“
              æ´»è·ƒçŠ¶æ€ (Active)
             â†™        â†˜
        å‡†å¤‡çŠ¶æ€      å›æ»šçŠ¶æ€
       (Prepared)    (Rollback)
           â†“            â†“
        æäº¤çŠ¶æ€      å®ŒæˆçŠ¶æ€
       (Committed)   (Complete)
```

### 3.3 XAåœ¨MySQLä¸­çš„åº”ç”¨


```sql
-- å¯åŠ¨XAäº‹åŠ¡
XA START 'transaction_001';

-- æ‰§è¡Œä¸šåŠ¡SQL
UPDATE user_account SET balance = balance - 100 WHERE user_id = 123;

-- ç»“æŸXAäº‹åŠ¡
XA END 'transaction_001';

-- å‡†å¤‡æäº¤
XA PREPARE 'transaction_001';

-- æŸ¥çœ‹XAäº‹åŠ¡çŠ¶æ€
XA RECOVER;

-- æäº¤æˆ–å›æ»š
XA COMMIT 'transaction_001';
-- æˆ–è€…
XA ROLLBACK 'transaction_001';
```

**Javaä»£ç ç¤ºä¾‹**ï¼š
```java
// XAäº‹åŠ¡ç®¡ç†å™¨
@Service
public class XATransactionService {
    
    @Autowired
    private DataSource userDataSource;
    
    @Autowired  
    private DataSource orderDataSource;
    
    public void transferWithXA(int userId, int amount) {
        // åˆ›å»ºXAèµ„æº
        XADataSource userXADS = new MysqlXADataSource();
        XADataSource orderXADS = new MysqlXADataSource();
        
        XAConnection userXAConn = userXADS.getXAConnection();
        XAConnection orderXAConn = orderXADS.getXAConnection();
        
        XAResource userXARes = userXAConn.getXAResource();
        XAResource orderXARes = orderXAConn.getXAResource();
        
        // åˆ›å»ºäº‹åŠ¡ID
        Xid userXid = new XidImpl("user_tx_001");
        Xid orderXid = new XidImpl("order_tx_001");
        
        try {
            // é˜¶æ®µ1ï¼šå‡†å¤‡
            userXARes.start(userXid, XAResource.TMNOFLAGS);
            // æ‰§è¡Œç”¨æˆ·æ‰£æ¬¾
            userXARes.end(userXid, XAResource.TMSUCCESS);
            
            orderXARes.start(orderXid, XAResource.TMNOFLAGS);
            // åˆ›å»ºè®¢å•
            orderXARes.end(orderXid, XAResource.TMSUCCESS);
            
            // å‡†å¤‡æäº¤
            int userResult = userXARes.prepare(userXid);
            int orderResult = orderXARes.prepare(orderXid);
            
            // é˜¶æ®µ2ï¼šæäº¤
            if (userResult == XAResource.XA_OK && orderResult == XAResource.XA_OK) {
                userXARes.commit(userXid, false);
                orderXARes.commit(orderXid, false);
            } else {
                userXARes.rollback(userXid);
                orderXARes.rollback(orderXid);
            }
        } catch (Exception e) {
            // å¼‚å¸¸å›æ»š
            userXARes.rollback(userXid);
            orderXARes.rollback(orderXid);
        }
    }
}
```

---

## 4. ğŸ’¼ TCCäº‹åŠ¡æ¨¡å¼å®è·µ


### 4.1 TCCæ¨¡å¼åŸºæœ¬æ¦‚å¿µ


**TCCä¸‰ä¸ªé˜¶æ®µ**ï¼š
- **Try**ï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
- **Confirm**ï¼šç¡®è®¤æ‰§è¡Œï¼Œæäº¤æ“ä½œ  
- **Cancel**ï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº

**ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒé¢„è®¢é…’åº—æˆ¿é—´
- **Try**ï¼šæŸ¥çœ‹æˆ¿é—´æ˜¯å¦æœ‰ç©ºï¼Œå…ˆé¢„è®¢å ä½
- **Confirm**ï¼šç¡®è®¤å…¥ä½ï¼Œæ­£å¼åŠç†æ‰‹ç»­
- **Cancel**ï¼šå–æ¶ˆé¢„è®¢ï¼Œé‡Šæ”¾æˆ¿é—´ç»™å…¶ä»–å®¢äºº

```
TCCäº‹åŠ¡æµç¨‹ï¼š
ä¸šåŠ¡å‘èµ·æ–¹                æœåŠ¡A(æ‰£æ¬¾)              æœåŠ¡B(åŠ ç§¯åˆ†)
    |                        |                      |
    |-------Try------------->|                      |
    |                        |--é¢„æ‰£100å…ƒ------------>|
    |<------æˆåŠŸ-------------|                      |
    |-------Try--------------|-------------------->|
    |                        |                     |--é¢„åŠ 100ç§¯åˆ†
    |<------æˆåŠŸ-------------|<--------------------|
    |                        |                      |
    |-----Confirm----------->|                      |
    |                        |--ç¡®è®¤æ‰£æ¬¾------------>|
    |-----Confirm------------|-------------------->|
    |                        |                     |--ç¡®è®¤åŠ ç§¯åˆ†
```

### 4.2 TCCå®ç°ç¤ºä¾‹


**ç”¨æˆ·æœåŠ¡ - æ‰£æ¬¾æ“ä½œ**ï¼š
```java
@Service
public class UserAccountService {
    
    // Tryé˜¶æ®µï¼šå†»ç»“é‡‘é¢
    public boolean tryDeduct(String userId, BigDecimal amount) {
        try {
            // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
            UserAccount account = getAccount(userId);
            if (account.getBalance().compareTo(amount) < 0) {
                return false;
            }
            
            // å†»ç»“èµ„é‡‘ï¼ˆä¸å®é™…æ‰£é™¤ï¼‰
            account.setFrozenAmount(account.getFrozenAmount().add(amount));
            updateAccount(account);
            
            // è®°å½•TCCæ—¥å¿—
            saveTccLog(userId, amount, "TRY");
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£æ¬¾
    public void confirmDeduct(String userId, BigDecimal amount) {
        UserAccount account = getAccount(userId);
        // çœŸæ­£æ‰£é™¤ä½™é¢
        account.setBalance(account.getBalance().subtract(amount));
        // è§£å†»é‡‘é¢
        account.setFrozenAmount(account.getFrozenAmount().subtract(amount));
        updateAccount(account);
        
        saveTccLog(userId, amount, "CONFIRM");
    }
    
    // Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰£æ¬¾
    public void cancelDeduct(String userId, BigDecimal amount) {
        UserAccount account = getAccount(userId);
        // è§£å†»é‡‘é¢ï¼ˆæ¢å¤å¯ç”¨ä½™é¢ï¼‰
        account.setFrozenAmount(account.getFrozenAmount().subtract(amount));
        updateAccount(account);
        
        saveTccLog(userId, amount, "CANCEL");
    }
}
```

**è®¢å•æœåŠ¡ - åˆ›å»ºè®¢å•**ï¼š
```java
@Service  
public class OrderService {
    
    // Tryé˜¶æ®µï¼šåˆ›å»ºä¸´æ—¶è®¢å•
    public boolean tryCreateOrder(OrderInfo orderInfo) {
        try {
            // åˆ›å»ºçŠ¶æ€ä¸º"é¢„åˆ›å»º"çš„è®¢å•
            Order order = new Order();
            order.setStatus("TRYING");
            order.setUserId(orderInfo.getUserId());
            order.setAmount(orderInfo.getAmount());
            saveOrder(order);
            
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    // Confirmé˜¶æ®µï¼šç¡®è®¤è®¢å•
    public void confirmCreateOrder(String orderId) {
        Order order = getOrder(orderId);
        order.setStatus("CONFIRMED");
        updateOrder(order);
    }
    
    // Cancelé˜¶æ®µï¼šåˆ é™¤è®¢å•
    public void cancelCreateOrder(String orderId) {
        Order order = getOrder(orderId);
        order.setStatus("CANCELLED");
        updateOrder(order);
    }
}
```

### 4.3 TCCæ¡†æ¶æ•´åˆ


```java
// ä½¿ç”¨Seata TCCæ³¨è§£
@LocalTCC
public interface AccountService {
    
    @TwoPhaseBusinessAction(name = "deductAccount", commitMethod = "confirm", rollbackMethod = "cancel")
    boolean tryDeduct(@BusinessActionContextParameter(paramName = "userId") String userId,
                     @BusinessActionContextParameter(paramName = "amount") BigDecimal amount);
    
    boolean confirm(BusinessActionContext context);
    
    boolean cancel(BusinessActionContext context);
}
```

### 4.4 TCCä¼˜ç¼ºç‚¹åˆ†æ


**ä¼˜ç‚¹**ï¼š
- âœ… **æ€§èƒ½è¾ƒå¥½**ï¼šæ— é•¿æ—¶é—´é”ç­‰å¾…
- âœ… **é€‚ç”¨èŒƒå›´å¹¿**ï¼šæ”¯æŒè·¨æ•°æ®åº“ã€è·¨æœåŠ¡
- âœ… **ä¸€è‡´æ€§å¼º**ï¼šæœ€ç»ˆä¿è¯å¼ºä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- âŒ **å®ç°å¤æ‚**ï¼šéœ€è¦å®ç°ä¸‰ä¸ªé˜¶æ®µçš„æ–¹æ³•
- âŒ **ä¸šåŠ¡ä¾µå…¥æ€§å¼º**ï¼šéœ€è¦ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
- âŒ **å¼€å‘æˆæœ¬é«˜**ï¼šéœ€è¦å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

---

## 5. ğŸ“– Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼


### 5.1 Sagaæ¨¡å¼åŸºæœ¬æ¦‚å¿µ


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

**ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒæ—…è¡Œè®¡åˆ’ï¼Œå¦‚æœæŸä¸ªç¯èŠ‚å‡ºé—®é¢˜ï¼Œå°±æŒ‰åŸè·¯è¿”å›ï¼š
```
æ­£å¸¸æµç¨‹ï¼šè®¢æœºç¥¨ â†’ è®¢é…’åº— â†’ è®¢é—¨ç¥¨ â†’ å®Œæˆæ—…è¡Œ
å‡ºç°é—®é¢˜ï¼šè®¢æœºç¥¨ âœ… â†’ è®¢é…’åº— âœ… â†’ è®¢é—¨ç¥¨ âŒ 
è¡¥å¿æµç¨‹ï¼šé€€é—¨ç¥¨ â†’ é€€é…’åº— â†’ é€€æœºç¥¨
```

### 5.2 Sagaä¸¤ç§å®ç°æ–¹å¼


**åè°ƒè€…æ¨¡å¼ï¼ˆOrchestrationï¼‰**ï¼š
```
ä¸­å¤®åè°ƒå™¨                æœåŠ¡A         æœåŠ¡B         æœåŠ¡C
     |                      |             |             |
     |-------T1------------>|             |             |
     |<------æˆåŠŸ-----------|             |             |
     |-------T2-------------|------------>|             |
     |<------æˆåŠŸ-----------|<------------|             |
     |-------T3-------------|-------------|------------>|
     |<------å¤±è´¥-----------|-------------|<------------|
     |                      |             |             |
     |-------C2-------------|------------>| (è¡¥å¿T2)    |
     |-------C1------------>| (è¡¥å¿T1)    |             |
```

**ç¼–æ’æ¨¡å¼ï¼ˆChoreographyï¼‰**ï¼š
```
æœåŠ¡A                    æœåŠ¡B                    æœåŠ¡C
  |                        |                        |
  |--æ‰§è¡ŒT1ï¼Œå‘é€äº‹ä»¶------>|                        |
  |                        |--æ‰§è¡ŒT2ï¼Œå‘é€äº‹ä»¶------>|
  |                        |                        |--æ‰§è¡ŒT3å¤±è´¥
  |                        |<--å‘é€è¡¥å¿äº‹ä»¶----------|
  |<--å‘é€è¡¥å¿äº‹ä»¶----------|                        |
  |--æ‰§è¡ŒC1--------------->|                        |
  |                        |--æ‰§è¡ŒC2--------------->|
```

### 5.3 Sagaå®ç°ç¤ºä¾‹


**è®¢å•å¤„ç†Saga**ï¼š
```java
@Service
public class OrderSagaService {
    
    @SagaOrchestrationStart
    public void processOrder(OrderRequest request) {
        // å®šä¹‰Sagaäº‹åŠ¡æ­¥éª¤
        SagaDefinition saga = SagaDefinition.create()
            .step("æ‰£å‡è´¦æˆ·ä½™é¢")
                .invokeParticipant("userService")
                .action("deductBalance", request.getUserId(), request.getAmount())
                .compensation("refundBalance", request.getUserId(), request.getAmount())
            .step("æ‰£å‡å•†å“åº“å­˜")  
                .invokeParticipant("inventoryService")
                .action("deductStock", request.getProductId(), request.getQuantity())
                .compensation("restoreStock", request.getProductId(), request.getQuantity())
            .step("åˆ›å»ºè®¢å•")
                .invokeParticipant("orderService") 
                .action("createOrder", request)
                .compensation("cancelOrder", request.getOrderId())
            .step("å‘é€é€šçŸ¥")
                .invokeParticipant("notificationService")
                .action("sendConfirmation", request.getUserId())
                .compensation("sendCancellation", request.getUserId())
            .build();
            
        // æ‰§è¡ŒSaga
        sagaOrchestrator.execute(saga);
    }
}
```

**å‚ä¸æœåŠ¡å®ç°**ï¼š
```java
// ç”¨æˆ·æœåŠ¡
@SagaParticipant  
public class UserService {
    
    public void deductBalance(String userId, BigDecimal amount) {
        // æ‰§è¡Œæ‰£æ¬¾æ“ä½œ
        UserAccount account = getAccount(userId);
        account.setBalance(account.getBalance().subtract(amount));
        updateAccount(account);
        
        // è®°å½•æ“ä½œæ—¥å¿—ç”¨äºè¡¥å¿
        saveOperationLog(userId, amount, "DEDUCT");
    }
    
    public void refundBalance(String userId, BigDecimal amount) {
        // è¡¥å¿ï¼šé€€æ¬¾
        UserAccount account = getAccount(userId);
        account.setBalance(account.getBalance().add(amount));
        updateAccount(account);
        
        saveOperationLog(userId, amount, "REFUND");
    }
}
```

### 5.4 SagaçŠ¶æ€ç®¡ç†


```java
// Sagaäº‹åŠ¡çŠ¶æ€è·Ÿè¸ª
@Entity
public class SagaTransaction {
    private String sagaId;
    private String status; // STARTED, COMPLETED, COMPENSATING, COMPENSATED, FAILED
    private List<SagaStep> steps;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
}

@Entity  
public class SagaStep {
    private String stepId;
    private String participantService;
    private String action;
    private String compensation;
    private String status; // PENDING, COMPLETED, COMPENSATED, FAILED
    private String resultData;
}
```

---

## 6. ğŸ¯ æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ


### 6.1 æœ€ç»ˆä¸€è‡´æ€§æ¦‚å¿µ


**æ ¸å¿ƒæ€æƒ³**ï¼šç³»ç»Ÿåœ¨ä¸€æ®µæ—¶é—´å†…å¯èƒ½ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚

**ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒé“¶è¡Œè½¬è´¦ï¼Œä½ è½¬è´¦åï¼š
- ç«‹å³ï¼šä½ çš„è´¦æˆ·æ‰£æ¬¾ï¼Œå¯¹æ–¹è¿˜æ²¡æ”¶åˆ°
- å‡ åˆ†é’Ÿåï¼šå¯¹æ–¹æ”¶åˆ°æ¬¾é¡¹
- æœ€ç»ˆç»“æœï¼šä¸¤è¾¹è´¦ç›®ä¸€è‡´

```
æ—¶é—´è½´æ¼”ç¤ºï¼š
T0: ç”¨æˆ·A: 1000å…ƒ, ç”¨æˆ·B: 500å…ƒ  (åˆå§‹çŠ¶æ€)
T1: ç”¨æˆ·A: 900å…ƒ,  ç”¨æˆ·B: 500å…ƒ  (Aè½¬å‡º100å…ƒç»™B)
T2: ç”¨æˆ·A: 900å…ƒ,  ç”¨æˆ·B: 500å…ƒ  (Bè¿˜æœªæ”¶åˆ°)
T3: ç”¨æˆ·A: 900å…ƒ,  ç”¨æˆ·B: 600å…ƒ  (Bæ”¶åˆ°100å…ƒï¼Œæœ€ç»ˆä¸€è‡´)
```

### 6.2 BASEç†è®º


**BASE vs ACID**ï¼š
- **ACID**ï¼šå¼ºä¸€è‡´æ€§ï¼Œç«‹å³ä¸€è‡´
- **BASE**ï¼šå¼±ä¸€è‡´æ€§ï¼Œæœ€ç»ˆä¸€è‡´

**BASEå«ä¹‰**ï¼š
- **BA**sically Availableï¼šåŸºæœ¬å¯ç”¨
- **S**oft Stateï¼šè½¯çŠ¶æ€ï¼ˆå…è®¸ä¸­é—´çŠ¶æ€ï¼‰
- **E**ventual Consistencyï¼šæœ€ç»ˆä¸€è‡´æ€§

### 6.3 æœ€ç»ˆä¸€è‡´æ€§å®ç°æ¨¡å¼


**å¼‚æ­¥æ¶ˆæ¯æ¨¡å¼**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private MessageProducer messageProducer;
    
    @Transactional
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–æœåŠ¡
        OrderCreatedEvent event = new OrderCreatedEvent(order.getId(), 
                                                        order.getUserId(), 
                                                        order.getAmount());
        messageProducer.send("order.created", event);
    }
}

// åº“å­˜æœåŠ¡ç›‘å¬æ¶ˆæ¯
@EventListener
public class InventoryService {
    
    @RabbitListener(queues = "order.created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å¼‚æ­¥å¤„ç†åº“å­˜æ‰£å‡
        try {
            deductStock(event.getProductId(), event.getQuantity());
            
            // å‘é€æˆåŠŸç¡®è®¤
            StockDeductedEvent confirmEvent = new StockDeductedEvent(event.getOrderId());
            messageProducer.send("stock.deducted", confirmEvent);
            
        } catch (Exception e) {
            // å‘é€å¤±è´¥æ¶ˆæ¯
            StockDeductFailedEvent failEvent = new StockDeductFailedEvent(event.getOrderId(), e.getMessage());
            messageProducer.send("stock.deduct.failed", failEvent);
        }
    }
}
```

---

## 7. ğŸ“ æœ¬åœ°æ¶ˆæ¯è¡¨æœºåˆ¶


### 7.1 æœ¬åœ°æ¶ˆæ¯è¡¨æ¦‚å¿µ


**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æœ¬åœ°æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯è¡¨ï¼Œåˆ©ç”¨æœ¬åœ°äº‹åŠ¡ä¿è¯æ•°æ®æ“ä½œå’Œæ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§ã€‚

```
æœ¬åœ°æ¶ˆæ¯è¡¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡æ•°æ®è¡¨  â”‚    â”‚  æœ¬åœ°æ¶ˆæ¯è¡¨  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚    â”‚ msg_id      â”‚
â”‚ user_id     â”‚    â”‚ topic       â”‚
â”‚ amount      â”‚    â”‚ content     â”‚
â”‚ status      â”‚    â”‚ status      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ create_time â”‚
                   â”‚ send_time   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡
```

### 7.2 å®ç°æ­¥éª¤è¯¦è§£


**ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯è¡¨è®¾è®¡**ï¼š
```sql
CREATE TABLE local_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) UNIQUE NOT NULL,
    topic VARCHAR(100) NOT NULL,
    content JSON NOT NULL,
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, SENT, FAILED
    retry_count INT DEFAULT 0,
    max_retry_count INT DEFAULT 3,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**ç¬¬äºŒæ­¥ï¼šä¸šåŠ¡æ“ä½œ + æ¶ˆæ¯è®°å½•**ï¼š
```java
@Service
public class TransferService {
    
    @Transactional
    public void transfer(String fromUserId, String toUserId, BigDecimal amount) {
        // 1. æœ¬åœ°ä¸šåŠ¡æ“ä½œ
        UserAccount fromAccount = accountRepository.findByUserId(fromUserId);
        fromAccount.setBalance(fromAccount.getBalance().subtract(amount));
        accountRepository.save(fromAccount);
        
        // 2. ä¿å­˜æœ¬åœ°æ¶ˆæ¯ï¼ˆåŒä¸€ä¸ªäº‹åŠ¡ï¼‰
        LocalMessage message = new LocalMessage();
        message.setMessageId(UUID.randomUUID().toString());
        message.setTopic("account.transfer");
        
        TransferEvent event = new TransferEvent(fromUserId, toUserId, amount);
        message.setContent(JSON.toJSONString(event));
        message.setStatus("PENDING");
        
        localMessageRepository.save(message);
        
        // æœ¬åœ°äº‹åŠ¡æäº¤ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼šæ¶ˆæ¯å‘é€æœåŠ¡**ï¼š
```java
@Component
public class MessageSender {
    
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void sendPendingMessages() {
        // æŸ¥è¯¢å¾…å‘é€æ¶ˆæ¯
        List<LocalMessage> pendingMessages = localMessageRepository
            .findByStatusAndRetryCountLessThan("PENDING", 3);
            
        for (LocalMessage message : pendingMessages) {
            try {
                // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
                messageProducer.send(message.getTopic(), message.getContent());
                
                // æ›´æ–°çŠ¶æ€ä¸ºå·²å‘é€
                message.setStatus("SENT");
                message.setSendTime(new Date());
                localMessageRepository.save(message);
                
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œå¢åŠ é‡è¯•æ¬¡æ•°
                message.setRetryCount(message.getRetryCount() + 1);
                
                if (message.getRetryCount() >= message.getMaxRetryCount()) {
                    message.setStatus("FAILED");
                }
                
                localMessageRepository.save(message);
            }
        }
    }
}
```

### 7.3 æ¶ˆæ¯å¹‚ç­‰æ€§å¤„ç†


```java
// æ¶ˆæ¯æ¶ˆè´¹ç«¯å¤„ç†
@RabbitListener(queues = "account.transfer")
public class TransferMessageConsumer {
    
    public void handleTransferMessage(String messageContent) {
        TransferEvent event = JSON.parseObject(messageContent, TransferEvent.class);
        
        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²ç»å¤„ç†è¿‡ï¼ˆå¹‚ç­‰æ€§ï¼‰
        if (isMessageProcessed(event.getMessageId())) {
            return; // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        try {
            // å¤„ç†è½¬è´¦é€»è¾‘
            processTransfer(event);
            
            // æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
            markMessageProcessed(event.getMessageId());
            
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
            log.error("å¤„ç†è½¬è´¦æ¶ˆæ¯å¤±è´¥", e);
            throw e; // é‡æ–°æŠ›å‡ºï¼Œè§¦å‘é‡è¯•
        }
    }
    
    private boolean isMessageProcessed(String messageId) {
        return processedMessageRepository.existsByMessageId(messageId);
    }
}
```

---

## 8. ğŸ”„ äº‹åŠ¡è¡¥å¿ä¸å›æ»šç­–ç•¥


### 8.1 è¡¥å¿æœºåˆ¶è®¾è®¡åŸåˆ™


**è¡¥å¿æ“ä½œç‰¹ç‚¹**ï¼š
- **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
- **å¯é‡è¯•**ï¼šå¤±è´¥åå¯ä»¥é‡æ–°æ‰§è¡Œ
- **ä¸šåŠ¡ç›¸å…³**ï¼šæ ¹æ®å…·ä½“ä¸šåŠ¡è®¾è®¡è¡¥å¿é€»è¾‘

```
è¡¥å¿æ“ä½œè®¾è®¡æ¨¡å¼ï¼š

æ­£å‘æ“ä½œ          è¡¥å¿æ“ä½œ
æ‰£æ¬¾ 100å…ƒ   â†’   é€€æ¬¾ 100å…ƒ
æ‰£å‡åº“å­˜ 5ä¸ª  â†’   å¢åŠ åº“å­˜ 5ä¸ª  
å‘é€é‚®ä»¶     â†’   å‘é€æ’¤é”€é‚®ä»¶
åˆ›å»ºè®¢å•     â†’   å–æ¶ˆè®¢å•
```

### 8.2 è‡ªåŠ¨è¡¥å¿æœºåˆ¶


```java
@Component
public class CompensationService {
    
    @Autowired
    private CompensationRepository compensationRepository;
    
    // æ³¨å†Œè¡¥å¿æ“ä½œ
    public void registerCompensation(String transactionId, CompensationAction action) {
        Compensation compensation = new Compensation();
        compensation.setTransactionId(transactionId);
        compensation.setServiceName(action.getServiceName());
        compensation.setMethod(action.getMethod());
        compensation.setParameters(action.getParameters());
        compensation.setStatus("REGISTERED");
        
        compensationRepository.save(compensation);
    }
    
    // æ‰§è¡Œäº‹åŠ¡å›æ»š
    public void rollbackTransaction(String transactionId) {
        List<Compensation> compensations = compensationRepository
            .findByTransactionIdOrderByCreateTimeDesc(transactionId);
            
        // æŒ‰ç…§æ³¨å†Œé¡ºåºçš„é€†åºæ‰§è¡Œè¡¥å¿
        for (Compensation compensation : compensations) {
            try {
                executeCompensation(compensation);
                compensation.setStatus("COMPENSATED");
                
            } catch (Exception e) {
                compensation.setStatus("COMPENSATION_FAILED");
                compensation.setErrorMessage(e.getMessage());
                
                // è®°å½•è¡¥å¿å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†
                alertService.sendCompensationFailedAlert(compensation);
            } finally {
                compensationRepository.save(compensation);
            }
        }
    }
    
    private void executeCompensation(Compensation compensation) {
        // é€šè¿‡åå°„æˆ–RPCè°ƒç”¨è¡¥å¿æ–¹æ³•
        String serviceName = compensation.getServiceName();
        String method = compensation.getMethod();
        Object[] parameters = compensation.getParameters();
        
        // å…·ä½“è°ƒç”¨å®ç°...
        serviceInvoker.invoke(serviceName, method, parameters);
    }
}
```

### 8.3 è¡¥å¿çŠ¶æ€ç›‘æ§


```java
// è¡¥å¿ä»»åŠ¡ç›‘æ§
@Entity
public class CompensationTask {
    private String taskId;
    private String transactionId;
    private String serviceName;
    private String methodName;
    private String parameters;
    private String status; // PENDING, EXECUTING, COMPLETED, FAILED
    private Integer retryCount;
    private LocalDateTime createTime;
    private LocalDateTime executeTime;
    private String errorMessage;
}

// å®šæ—¶æ£€æŸ¥è¡¥å¿ä»»åŠ¡
@Component
public class CompensationMonitor {
    
    @Scheduled(fixedDelay = 30000)
    public void checkPendingCompensations() {
        List<CompensationTask> pendingTasks = compensationTaskRepository
            .findByStatusAndRetryCountLessThan("PENDING", 3);
            
        for (CompensationTask task : pendingTasks) {
            try {
                executeCompensationTask(task);
            } catch (Exception e) {
                handleCompensationFailure(task, e);
            }
        }
    }
}
```

---

## 9. ğŸ“Š åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§ä¸è¿½è¸ª


### 9.1 äº‹åŠ¡é“¾è·¯è¿½è¸ª


```java
// åˆ†å¸ƒå¼äº‹åŠ¡è¿½è¸ª
@Component
public class TransactionTracer {
    
    public void startTransaction(String transactionId, String transactionType) {
        TransactionTrace trace = new TransactionTrace();
        trace.setTransactionId(transactionId);
        trace.setTransactionType(transactionType);
        trace.setStatus("STARTED");
        trace.setStartTime(System.currentTimeMillis());
        
        // å­˜å‚¨åˆ°é“¾è·¯è¿½è¸ªç³»ç»Ÿ
        traceRepository.save(trace);
        
        // è®¾ç½®ä¸Šä¸‹æ–‡
        TransactionContext.setCurrentTransactionId(transactionId);
    }
    
    public void recordStep(String stepName, String serviceName, long duration) {
        String transactionId = TransactionContext.getCurrentTransactionId();
        
        TransactionStep step = new TransactionStep();
        step.setTransactionId(transactionId);
        step.setStepName(stepName);
        step.setServiceName(serviceName);
        step.setDuration(duration);
        step.setTimestamp(System.currentTimeMillis());
        
        stepRepository.save(step);
    }
}
```

### 9.2 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


```java
@Component
public class TransactionMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // äº‹åŠ¡æˆåŠŸç‡
    public void recordTransactionResult(String transactionType, boolean success) {
        Counter.builder("distributed_transaction_total")
            .tag("type", transactionType)
            .tag("result", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
    }
    
    // äº‹åŠ¡è€—æ—¶
    public void recordTransactionDuration(String transactionType, long duration) {
        Timer.builder("distributed_transaction_duration")
            .tag("type", transactionType)
            .register(meterRegistry)
            .record(Duration.ofMillis(duration));
    }
    
    // è¡¥å¿ç‡
    public void recordCompensationRate(String transactionType) {
        Counter.builder("distributed_transaction_compensation")
            .tag("type", transactionType)
            .register(meterRegistry)
            .increment();
    }
}
```

**ç›‘æ§å¤§ç›˜ç¤ºä¾‹**ï¼š
```
åˆ†å¸ƒå¼äº‹åŠ¡ç›‘æ§å¤§ç›˜
â”œâ”€â”€ äº‹åŠ¡æˆåŠŸç‡: 95.8%
â”œâ”€â”€ å¹³å‡å“åº”æ—¶é—´: 285ms
â”œâ”€â”€ è¡¥å¿ç‡: 2.1%
â”œâ”€â”€ è¶…æ—¶ç‡: 1.3%
â””â”€â”€ å¼‚å¸¸ç‡: 0.8%

çƒ­ç‚¹äº‹åŠ¡ç±»å‹ï¼š
- æ”¯ä»˜äº‹åŠ¡: 45% (æˆåŠŸç‡: 97.2%)
- è®¢å•äº‹åŠ¡: 30% (æˆåŠŸç‡: 94.6%)  
- åº“å­˜äº‹åŠ¡: 25% (æˆåŠŸç‡: 96.1%)
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡æŒ‘æˆ˜ï¼šç½‘ç»œåˆ†åŒºã€éƒ¨åˆ†å¤±è´¥ã€æ€§èƒ½é—®é¢˜
ğŸ”¸ ä¸¤é˜¶æ®µæäº¤(2PC)ï¼šå‡†å¤‡é˜¶æ®µ + æäº¤é˜¶æ®µï¼Œå¼ºä¸€è‡´æ€§ä½†æ€§èƒ½å·®
ğŸ”¸ XAæ ‡å‡†ï¼šé€šç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡åè®®ï¼Œå¹¿æ³›æ”¯æŒä½†å¤æ‚
ğŸ”¸ TCCæ¨¡å¼ï¼šTry-Confirm-Cancelï¼Œæ€§èƒ½å¥½ä½†å®ç°å¤æ‚
ğŸ”¸ Sagaæ¨¡å¼ï¼šé•¿äº‹åŠ¡åˆ†è§£ + è¡¥å¿æœºåˆ¶ï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸ä¸­é—´çŠ¶æ€ï¼Œæœ€ç»ˆè¾¾åˆ°ä¸€è‡´
ğŸ”¸ æœ¬åœ°æ¶ˆæ¯è¡¨ï¼šåˆ©ç”¨æœ¬åœ°äº‹åŠ¡ä¿è¯æ¶ˆæ¯å‘é€çš„å¯é æ€§
```

### 10.2 æ–¹æ¡ˆé€‰æ‹©æŒ‡å¯¼


| åœºæ™¯ç‰¹ç‚¹ | **æ¨èæ–¹æ¡ˆ** | **åŸå› è¯´æ˜** |
|---------|------------|-------------|
| ğŸ¦ **é‡‘èåœºæ™¯** | `2PC/XA` | `å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œä¸å…è®¸æ•°æ®ä¸ä¸€è‡´` |
| ğŸ›’ **ç”µå•†è®¢å•** | `TCC/Saga` | `ä¸šåŠ¡å¤æ‚ï¼Œéœ€è¦ç²¾ç»†æ§åˆ¶å„ä¸ªæ­¥éª¤` |
| ğŸ“± **ç¤¾äº¤åª’ä½“** | `æœ€ç»ˆä¸€è‡´æ€§` | `å¯æ¥å—çŸ­æœŸä¸ä¸€è‡´ï¼Œæ€§èƒ½è¦æ±‚é«˜` |
| ğŸ“¦ **ç‰©æµè·Ÿè¸ª** | `æ¶ˆæ¯é©±åŠ¨` | `å¼‚æ­¥å¤„ç†ï¼Œäº‹ä»¶é©±åŠ¨ç‰¹å¾æ˜æ˜¾` |

### 10.3 å®æ–½æœ€ä½³å®è·µ


**ğŸ’¡ è®¾è®¡åŸåˆ™**ï¼š
- **å¹‚ç­‰æ€§ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ“ä½œéƒ½è¦æ”¯æŒé‡å¤æ‰§è¡Œ
- **è¡¥å¿å¯è¡Œ**ï¼šæ¯ä¸ªæ“ä½œéƒ½è¦æœ‰å¯¹åº”çš„è¡¥å¿æ–¹æ³•
- **ç›‘æ§å®Œå–„**ï¼šå®Œå¤‡çš„æ—¥å¿—å’Œç›‘æ§ä½“ç³»
- **é™çº§æ–¹æ¡ˆ**ï¼šå¼‚å¸¸æƒ…å†µä¸‹çš„äººå·¥å¤„ç†æµç¨‹

**âš ï¸ å¸¸è§é™·é˜±**ï¼š
- **è¿‡åº¦è®¾è®¡**ï¼šç®€å•åœºæ™¯ä¸è¦ç”¨å¤æ‚æ–¹æ¡ˆ
- **å¿½ç•¥è¡¥å¿**ï¼šè®¾è®¡æ­£å‘æµç¨‹æ—¶å¿½ç•¥è¡¥å¿é€»è¾‘
- **ç¼ºä¹ç›‘æ§**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜éš¾æ’æŸ¥
- **æ€§èƒ½å¿½è§†**ï¼šåªå…³æ³¨ä¸€è‡´æ€§ï¼Œå¿½ç•¥æ€§èƒ½å½±å“

**ğŸ¯ é€‰æ‹©å»ºè®®**ï¼š
- **æ•°æ®å¼ºä¸€è‡´æ€§è¦æ±‚é«˜** â†’ 2PC/XA
- **ä¸šåŠ¡æµç¨‹å¤æ‚ï¼Œå…è®¸è¡¥å¿** â†’ TCC/Saga  
- **æ€§èƒ½è¦æ±‚é«˜ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´** â†’ æ¶ˆæ¯æ–¹æ¡ˆ
- **ç®€å•åœºæ™¯** â†’ é¿å…åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œé‡æ–°è®¾è®¡ä¸šåŠ¡

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯ä¸ºäº†è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜
- ä¸åŒæ–¹æ¡ˆé€‚ç”¨äºä¸åŒåœºæ™¯ï¼Œæ²¡æœ‰é“¶å¼¹
- ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€æ€§èƒ½æ˜¯éœ€è¦æƒè¡¡çš„ä¸‰è§’å…³ç³»
- ç›‘æ§å’Œè¿ç»´æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡æˆåŠŸçš„å…³é”®