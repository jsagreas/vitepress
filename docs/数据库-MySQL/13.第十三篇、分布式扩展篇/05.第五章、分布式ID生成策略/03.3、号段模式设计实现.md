---
title: 3ã€å·æ®µæ¨¡å¼è®¾è®¡å®ç°
---
## ğŸ“š ç›®å½•

1. [å·æ®µæ¨¡å¼åŸºæœ¬æ¦‚å¿µ](#1-å·æ®µæ¨¡å¼åŸºæœ¬æ¦‚å¿µ)
2. [å·æ®µåˆ†é…æœºåˆ¶è¯¦è§£](#2-å·æ®µåˆ†é…æœºåˆ¶è¯¦è§£)
3. [å·æ®µå¤§å°è®¾è®¡ç­–ç•¥](#3-å·æ®µå¤§å°è®¾è®¡ç­–ç•¥)
4. [åŒBufferé¢„åˆ†é…æœºåˆ¶](#4-åŒBufferé¢„åˆ†é…æœºåˆ¶)
5. [å¹¶å‘å®‰å…¨æ§åˆ¶](#5-å¹¶å‘å®‰å…¨æ§åˆ¶)
6. [æ•…éšœå®¹é”™ä¸é«˜å¯ç”¨](#6-æ•…éšœå®¹é”™ä¸é«˜å¯ç”¨)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å·æ®µæ¨¡å¼åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å·æ®µæ¨¡å¼


**é€šä¿—ç†è§£**ï¼šå·æ®µæ¨¡å¼å°±åƒ**é“¶è¡Œçª—å£å–å·**çš„å‡çº§ç‰ˆã€‚

```
é“¶è¡Œå–å·æœºï¼šä¸€æ¬¡åªèƒ½å–ä¸€ä¸ªå·
å·æ®µæ¨¡å¼ï¼šä¸€æ¬¡å–ä¸€æ‰¹å·ï¼ˆæ¯”å¦‚1-100ï¼‰ï¼Œç”¨å®Œå†å–ä¸‹ä¸€æ‰¹ï¼ˆ101-200ï¼‰

ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡è¦IDéƒ½å»æ•°æ®åº“å–
å·æ®µæ¨¡å¼ï¼šæ‰¹é‡å–ä¸€å †IDï¼Œæœ¬åœ°æ…¢æ…¢ç”¨
```

**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**
```
æ‰¹é‡åˆ†é…ï¼šä¸€æ¬¡ç”³è¯·å¤šä¸ªIDå·æ®µï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
æœ¬åœ°åˆ†å‘ï¼šåœ¨å†…å­˜ä¸­æŒ‰é¡ºåºåˆ†å‘IDï¼Œæ€§èƒ½æé«˜
ç”¨å®Œå†å–ï¼šå·æ®µç”¨å®Œæ—¶ï¼Œå†å»ç”³è¯·æ–°çš„å·æ®µ
```

### 1.2 å·æ®µæ¨¡å¼çš„å·¥ä½œåŸç†


**ğŸ“Š åŸºæœ¬æµç¨‹å›¾**
```
åº”ç”¨æœåŠ¡å™¨                    IDåˆ†é…æœåŠ¡å™¨                æ•°æ®åº“
     |                           |                        |
     |--[1]ç”³è¯·å·æ®µ--------------->|                        |
     |                           |--[2]æŸ¥è¯¢å¯ç”¨å·æ®µ------->|
     |                           |<-[3]è¿”å›å·æ®µ(1-1000)---|
     |<--[4]è¿”å›å·æ®µä¿¡æ¯----------|                        |
     |                           |                        |
     |--[5]æœ¬åœ°åˆ†å‘ID:1,2,3...   |                        |
     |                           |                        |
     |--[6]å·æ®µç”¨å®Œ,ç”³è¯·æ–°å·æ®µ---->|                        |
     |                           |--[7]æ›´æ–°å¹¶è·å–æ–°å·æ®µ--->|
     |                           |<-[8]è¿”å›æ–°å·æ®µ(1001-2000)|
```

**ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿**
```
é«˜æ€§èƒ½ï¼šæœ¬åœ°å†…å­˜åˆ†å‘ï¼ŒQPSå¯è¾¾å‡ åä¸‡
ä½å»¶è¿Ÿï¼šé¿å…æ¯æ¬¡è¯·æ±‚éƒ½è®¿é—®æ•°æ®åº“
é«˜å¯ç”¨ï¼šæ”¯æŒå¤šå®ä¾‹ï¼Œä¸€ä¸ªæŒ‚äº†å…¶ä»–ç»§ç»­æœåŠ¡
å¯æ‰©å±•ï¼šå¯ä»¥æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´å·æ®µå¤§å°
```

### 1.3 å·æ®µæ¨¡å¼æ•°æ®ç»“æ„


**ğŸ—„ï¸ æ•°æ®åº“è¡¨è®¾è®¡**
```sql
-- å·æ®µåˆ†é…è¡¨
CREATE TABLE id_segment (
    biz_type     VARCHAR(32) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
    max_id       BIGINT      NOT NULL COMMENT 'å½“å‰æœ€å¤§ID',
    step         INT         NOT NULL COMMENT 'å·æ®µå¤§å°',
    description  VARCHAR(255)         COMMENT 'ä¸šåŠ¡æè¿°',
    update_time  TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (biz_type)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO id_segment VALUES 
('order', 1000, 1000, 'è®¢å•ID'),
('user',  2000, 500,  'ç”¨æˆ·ID');
```

---

## 2. âš™ï¸ å·æ®µåˆ†é…æœºåˆ¶è¯¦è§£


### 2.1 å·æ®µåˆ†é…åŸºç¡€æµç¨‹


**ğŸ”¸ åˆ†é…æœºåˆ¶æ ¸å¿ƒ**

åˆ†é…ä¸€ä¸ªå·æ®µå°±æ˜¯ï¼š**å…ˆå ä½ï¼Œå†ä½¿ç”¨**

```java
// å·æ®µåˆ†é…æ ¸å¿ƒé€»è¾‘
public class SegmentAllocator {
    
    // è·å–å·æ®µï¼šåŸå­æ“ä½œï¼Œé˜²æ­¢å¹¶å‘é—®é¢˜
    public Segment allocateSegment(String bizType) {
        // 1. åŠ é”æŸ¥è¯¢å½“å‰max_id
        String sql = "SELECT max_id, step FROM id_segment WHERE biz_type = ? FOR UPDATE";
        
        // 2. è®¡ç®—æ–°çš„å·æ®µèŒƒå›´
        long currentMaxId = queryMaxId(bizType);
        long step = queryStep(bizType);
        long newMaxId = currentMaxId + step;
        
        // 3. æ›´æ–°æ•°æ®åº“ä¸­çš„max_id
        updateMaxId(bizType, newMaxId);
        
        // 4. è¿”å›å·æ®µä¿¡æ¯
        return new Segment(currentMaxId + 1, newMaxId);
    }
}
```

**ğŸ“ è¯¦ç»†è§£é‡Š**
- `FOR UPDATE`ï¼šæ•°æ®åº“è¡Œé”ï¼Œç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–å·æ®µ
- `max_id`ï¼šè¡¨ç¤ºå·²åˆ†é…å‡ºå»çš„æœ€å¤§ID
- `step`ï¼šå·æ®µå¤§å°ï¼Œå³ä¸€æ¬¡åˆ†é…å¤šå°‘ä¸ªID
- æ–°å·æ®µèŒƒå›´ï¼š`(max_id, max_id + step]`

### 2.2 å·æ®µä½¿ç”¨ä¸åˆ†å‘


**ğŸ¯ æœ¬åœ°IDåˆ†å‘å™¨**
```java
public class SegmentDispenser {
    private long currentId;    // å½“å‰åˆ†å‘åˆ°çš„ID
    private long maxId;        // å·æ®µæœ€å¤§ID
    private final Object lock = new Object();
    
    // è·å–ä¸‹ä¸€ä¸ªID
    public long nextId() {
        synchronized (lock) {
            if (currentId >= maxId) {
                throw new RuntimeException("å·æ®µå·²ç”¨å®Œï¼Œéœ€è¦é‡æ–°åˆ†é…");
            }
            return ++currentId;
        }
    }
    
    // æ£€æŸ¥å·æ®µæ˜¯å¦å³å°†ç”¨å®Œ
    public boolean needRefresh() {
        return (maxId - currentId) < (maxId - minId) * 0.1; // å‰©ä½™10%æ—¶è§¦å‘
    }
}
```

### 2.3 å·æ®µè´Ÿè½½å‡è¡¡ç­–ç•¥


**âš–ï¸ å¤šå®ä¾‹åœºæ™¯ä¸‹çš„è´Ÿè½½å‡è¡¡**

```
åœºæ™¯ï¼š3ä¸ªåº”ç”¨å®ä¾‹éƒ½éœ€è¦ç”Ÿæˆè®¢å•ID

ç­–ç•¥1ï¼šæŒ‰æœºå™¨IPå–æ¨¡
å®ä¾‹Aï¼šåˆ†é…å·æ®µ 1-1000
å®ä¾‹Bï¼šåˆ†é…å·æ®µ 1001-2000  
å®ä¾‹Cï¼šåˆ†é…å·æ®µ 2001-3000

ç­–ç•¥2ï¼šéšæœºåˆ†é…
æ¯ä¸ªå®ä¾‹éšæœºè·å–å¯ç”¨å·æ®µ

ç­–ç•¥3ï¼šæŒ‰è´Ÿè½½åˆ†é…
QPSé«˜çš„å®ä¾‹åˆ†é…æ›´å¤§çš„å·æ®µ
```

**ğŸ”§ è´Ÿè½½å‡è¡¡å®ç°**
```java
public class LoadBalancedSegmentService {
    
    // æ ¹æ®å®ä¾‹è´Ÿè½½åŠ¨æ€è°ƒæ•´stepå¤§å°
    public int calculateStep(String bizType, String instanceId) {
        // è·å–å®ä¾‹å½“å‰QPS
        int currentQps = getInstanceQps(instanceId);
        
        // åŸºç¡€step
        int baseStep = getBaseStep(bizType);
        
        // æ ¹æ®QPSè°ƒæ•´ï¼šQPSè¶Šé«˜ï¼Œstepè¶Šå¤§
        return Math.max(baseStep, currentQps * 10);
    }
}
```

---

## 3. ğŸ“ å·æ®µå¤§å°è®¾è®¡ç­–ç•¥


### 3.1 å·æ®µå¤§å°çš„å½±å“å› ç´ 


**ğŸ¯ å…³é”®å½±å“å› ç´ **

| å› ç´  | **å°å·æ®µ** | **å¤§å·æ®µ** | **å½±å“è¯´æ˜** |
|------|-----------|-----------|-------------|
| **æ•°æ®åº“å‹åŠ›** | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | å°å·æ®µéœ€è¦é¢‘ç¹ç”³è¯· |
| **å†…å­˜å ç”¨** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | å¤§å·æ®µç¼“å­˜æ›´å¤šID |
| **æµªè´¹ç¨‹åº¦** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | é‡å¯æ—¶æœªç”¨å®Œçš„IDæµªè´¹ |
| **å¹¶å‘æ€§èƒ½** | ğŸ”´ ä½ | ğŸŸ¢ é«˜ | å¤§å·æ®µæ”¯æŒæ›´é«˜å¹¶å‘ |

### 3.2 åŠ¨æ€è°ƒæ•´ç®—æ³•


**ğŸ“Š è‡ªé€‚åº”å·æ®µå¤§å°**

```java
public class DynamicSegmentSizer {
    
    // æ ¹æ®å†å²ä½¿ç”¨æƒ…å†µåŠ¨æ€è°ƒæ•´step
    public int calculateOptimalStep(String bizType) {
        // 1. è·å–æœ€è¿‘1å°æ—¶çš„IDä½¿ç”¨ç»Ÿè®¡
        IDUsageStats stats = getUsageStats(bizType, Duration.ofHours(1));
        
        // 2. è®¡ç®—å¹³å‡QPS
        double avgQps = stats.getTotalUsed() / 3600.0;
        
        // 3. é¢„ä¼°æœªæ¥1åˆ†é’Ÿçš„ä½¿ç”¨é‡
        int predictedUsage = (int) (avgQps * 60 * 1.2); // å¢åŠ 20%ç¼“å†²
        
        // 4. è®¾ç½®åˆç†çš„è¾¹ç•Œå€¼
        return Math.max(100, Math.min(10000, predictedUsage));
    }
}
```

**ğŸ’¡ è°ƒæ•´ç­–ç•¥è¯´æ˜**
- **ä½å³°æœŸ**ï¼šä½¿ç”¨å°å·æ®µ(100-500)ï¼Œå‡å°‘æµªè´¹
- **é«˜å³°æœŸ**ï¼šä½¿ç”¨å¤§å·æ®µ(5000-10000)ï¼Œæå‡æ€§èƒ½  
- **çªå‘æµé‡**ï¼šå¿«é€Ÿæ‰©å¤§å·æ®µï¼Œåº”å¯¹æµé‡æš´å¢
- **å¹³ç¨³æœŸ**ï¼šé€æ­¥æ”¶ç¼©å·æ®µï¼Œä¼˜åŒ–èµ„æºä½¿ç”¨

### 3.3 ä¸åŒä¸šåŠ¡åœºæ™¯çš„å»ºè®®


**ğŸ“‹ ä¸šåŠ¡åœºæ™¯å¯¹ç…§è¡¨**

| ä¸šåŠ¡ç±»å‹ | **æ¨èå·æ®µå¤§å°** | **è°ƒæ•´é¢‘ç‡** | **åŸå› è¯´æ˜** |
|---------|----------------|-------------|-------------|
| **è®¢å•ID** | 1000-5000 | æ¯å°æ—¶ | æµé‡æœ‰å³°è°·ï¼Œéœ€åŠ¨æ€è°ƒæ•´ |
| **ç”¨æˆ·ID** | 100-500 | æ¯å¤© | å¢é•¿ç›¸å¯¹ç¨³å®š |
| **æ¶ˆæ¯ID** | 10000-50000 | å®æ—¶ | é«˜é¢‘åœºæ™¯ï¼Œä¼˜å…ˆæ€§èƒ½ |
| **æ—¥å¿—ID** | 5000-20000 | æ¯å°æ—¶ | é‡å¤§ä½†å…è®¸ä¸€å®šæµªè´¹ |

---

## 4. ğŸ”„ åŒBufferé¢„åˆ†é…æœºåˆ¶


### 4.1 åŒBufferè®¾è®¡æ€æƒ³


**ğŸ¯ è§£å†³çš„é—®é¢˜**ï¼šé¿å…å·æ®µç”¨å®Œæ—¶çš„**é˜»å¡ç­‰å¾…**

```
å•Bufferé—®é¢˜ï¼š
å·æ®µç”¨å®Œ â†’ ç”³è¯·æ–°å·æ®µ â†’ ç­‰å¾…æ•°æ®åº“å“åº” â†’ ç»§ç»­åˆ†å‘
          â†‘_____è¿™æ®µæ—¶é—´æ‰€æœ‰è¯·æ±‚éƒ½è¢«é˜»å¡_____â†‘

åŒBufferè§£å†³æ–¹æ¡ˆï¼š
Buffer Aï¼šæ­£åœ¨ä½¿ç”¨ä¸­
Buffer Bï¼šæå‰å‡†å¤‡å¥½çš„å¤‡ç”¨å·æ®µ
```

### 4.2 åŒBufferå®ç°æœºåˆ¶


**ğŸ”§ æ ¸å¿ƒå®ç°ç»“æ„**
```java
public class DoubleBufferSegmentService {
    
    // åŒç¼“å†²åŒº
    private volatile SegmentBuffer currentBuffer;  // å½“å‰ä½¿ç”¨çš„buffer
    private volatile SegmentBuffer backupBuffer;   // å¤‡ç”¨buffer
    
    // åˆ‡æ¢é”
    private final Object switchLock = new Object();
    
    public long nextId() {
        long id = currentBuffer.nextId();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é¢„åˆ†é…å¤‡ç”¨buffer
        if (currentBuffer.needRefresh() && !backupBuffer.isReady()) {
            asyncPrepareBackupBuffer();  // å¼‚æ­¥å‡†å¤‡
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢buffer
        if (currentBuffer.isEmpty() && backupBuffer.isReady()) {
            switchBuffer();
        }
        
        return id;
    }
    
    // å¼‚æ­¥å‡†å¤‡å¤‡ç”¨buffer
    private void asyncPrepareBackupBuffer() {
        CompletableFuture.runAsync(() -> {
            try {
                Segment newSegment = segmentAllocator.allocateSegment(bizType);
                backupBuffer.load(newSegment);
            } catch (Exception e) {
                log.error("é¢„åˆ†é…å·æ®µå¤±è´¥", e);
            }
        });
    }
}
```

### 4.3 Bufferåˆ‡æ¢ç­–ç•¥


**âš¡ æ™ºèƒ½åˆ‡æ¢æœºåˆ¶**

```
è§¦å‘åˆ‡æ¢çš„æ¡ä»¶ï¼š
1. å½“å‰bufferä½¿ç”¨è¶…è¿‡90%
2. å¤‡ç”¨bufferå·²ç»å‡†å¤‡å°±ç»ª
3. ç³»ç»Ÿè´Ÿè½½å…è®¸åˆ‡æ¢

åˆ‡æ¢è¿‡ç¨‹ï¼š
1. åŠ é”ç¡®ä¿åŸå­æ€§
2. äº¤æ¢currentå’Œbackupçš„å¼•ç”¨
3. æ¸…ç©ºæ–°çš„backupï¼Œå‡†å¤‡ä¸‹æ¬¡é¢„åˆ†é…
```

**ğŸ“Š åˆ‡æ¢æ—¶åºå›¾**
```
æ—¶é—´è½´ï¼š  |--Aä½¿ç”¨ä¸­--|--åˆ‡æ¢--|--Bä½¿ç”¨ä¸­--|--åˆ‡æ¢--|
Buffer A: |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘|        |          |        |
Buffer B: |   å‡†å¤‡ä¸­  |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘|        |
çŠ¶æ€ï¼š    æ­£å¸¸åˆ†å‘     ç¬é—´åˆ‡æ¢   æ­£å¸¸åˆ†å‘    å‡†å¤‡C
```

---

## 5. ğŸ”’ å¹¶å‘å®‰å…¨æ§åˆ¶


### 5.1 å¹¶å‘å®‰å…¨çš„æŒ‘æˆ˜


**âš ï¸ å¹¶å‘é—®é¢˜åœºæ™¯**

```
é—®é¢˜1ï¼šå¤šçº¿ç¨‹åŒæ—¶è·å–ID
Thread 1: currentId = 100, è¿”å›101
Thread 2: currentId = 100, ä¹Ÿè¿”å›101  âŒ IDé‡å¤

é—®é¢˜2ï¼šBufferåˆ‡æ¢æ—¶çš„ç«æ€æ¡ä»¶
Thread 1: æ£€æŸ¥éœ€è¦åˆ‡æ¢ï¼Œå‡†å¤‡åˆ‡æ¢
Thread 2: ä¹Ÿæ£€æŸ¥éœ€è¦åˆ‡æ¢ï¼Œä¹Ÿå‡†å¤‡åˆ‡æ¢  âŒ å¯èƒ½åˆ‡æ¢å¤šæ¬¡

é—®é¢˜3ï¼šå·æ®µç”³è¯·çš„å¹¶å‘å†²çª  
Instance A: ç”³è¯·å·æ®µï¼Œè·å¾—max_id = 1000
Instance B: ç”³è¯·å·æ®µï¼Œä¹Ÿè·å¾—max_id = 1000  âŒ å·æ®µé‡å 
```

### 5.2 æœ¬åœ°å¹¶å‘æ§åˆ¶


**ğŸ” çº¿ç¨‹å®‰å…¨çš„IDåˆ†å‘**
```java
public class ThreadSafeSegmentDispenser {
    
    // ä½¿ç”¨AtomicLongé¿å…é”ç«äº‰
    private final AtomicLong currentId;
    private final long maxId;
    
    public long nextId() {
        while (true) {
            long current = currentId.get();
            if (current >= maxId) {
                throw new SegmentExhaustedException("å·æ®µå·²ç”¨å®Œ");
            }
            
            long next = current + 1;
            if (currentId.compareAndSet(current, next)) {
                return next;  // CASæˆåŠŸï¼Œè¿”å›ID
            }
            // CASå¤±è´¥ï¼Œé‡è¯•
        }
    }
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆç”¨AtomicLong**
- **æ— é”æ“ä½œ**ï¼šæ¯”synchronizedæ€§èƒ½æ›´é«˜
- **CASæœºåˆ¶**ï¼šCompare-And-Swapï¼ŒåŸå­æ€§ä¿è¯
- **é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥åè‡ªåŠ¨é‡è¯•ï¼Œæœ€ç»ˆä¸€å®šæˆåŠŸ

### 5.3 åˆ†å¸ƒå¼å¹¶å‘æ§åˆ¶


**ğŸŒ æ•°æ®åº“å±‚é¢çš„å¹¶å‘æ§åˆ¶**

```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨FOR UPDATEè¡Œé”
BEGIN;
SELECT max_id, step FROM id_segment 
WHERE biz_type = 'order' FOR UPDATE;

UPDATE id_segment 
SET max_id = max_id + step 
WHERE biz_type = 'order';
COMMIT;
```

**ğŸ”§ åº”ç”¨å±‚é¢çš„åˆ†å¸ƒå¼é”**
```java
public class DistributedSegmentAllocator {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public Segment allocateSegment(String bizType) {
        String lockKey = "segment_lock:" + bizType;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”ï¼Œè¶…æ—¶æ—¶é—´30ç§’
            if (acquireLock(lockKey, lockValue, 30)) {
                return doAllocateSegment(bizType);
            } else {
                throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥");
            }
        } finally {
            releaseLock(lockKey, lockValue);
        }
    }
}
```

---

## 6. ğŸ›¡ï¸ æ•…éšœå®¹é”™ä¸é«˜å¯ç”¨


### 6.1 å¸¸è§æ•…éšœåœºæ™¯


**ğŸš¨ å…¸å‹æ•…éšœç±»å‹**

```
æ•…éšœ1ï¼šæ•°æ®åº“è¿æ¥å¼‚å¸¸
ç°è±¡ï¼šæ— æ³•ç”³è¯·æ–°å·æ®µ
å½±å“ï¼šå½“å‰å·æ®µç”¨å®ŒåæœåŠ¡ä¸å¯ç”¨

æ•…éšœ2ï¼šåº”ç”¨å®ä¾‹é‡å¯
ç°è±¡ï¼šå†…å­˜ä¸­æœªä½¿ç”¨çš„å·æ®µä¸¢å¤±
å½±å“ï¼šéƒ¨åˆ†IDå·æ®µæµªè´¹ï¼Œä½†ä¸å½±å“æœåŠ¡

æ•…éšœ3ï¼šç½‘ç»œåˆ†åŒº
ç°è±¡ï¼šéƒ¨åˆ†å®ä¾‹æ— æ³•è¿æ¥æ•°æ®åº“
å½±å“ï¼šå­¤ç«‹å®ä¾‹æ— æ³•è·å–æ–°å·æ®µ
```

### 6.2 æ•…éšœè½¬ç§»æœºåˆ¶


**ğŸ”„ å¤šçº§å®¹é”™ç­–ç•¥**

```java
public class FaultTolerantSegmentService {
    
    // å¤šæ•°æ®æºé…ç½®
    @Primary
    private DataSource primaryDB;
    private DataSource backupDB;
    
    public Segment allocateSegment(String bizType) {
        // å°è¯•ä¸»æ•°æ®åº“
        try {
            return allocateFromDB(primaryDB, bizType);
        } catch (Exception e) {
            log.warn("ä¸»æ•°æ®åº“åˆ†é…å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ•°æ®åº“", e);
        }
        
        // å°è¯•å¤‡ç”¨æ•°æ®åº“
        try {
            return allocateFromDB(backupDB, bizType);
        } catch (Exception e) {
            log.error("å¤‡ç”¨æ•°æ®åº“ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨åº”æ€¥æ–¹æ¡ˆ", e);
        }
        
        // åº”æ€¥æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³+æœºå™¨ID
        return generateEmergencySegment();
    }
}
```

### 6.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯


**ğŸ“Š å¤šå®ä¾‹æ•°æ®åŒæ­¥**

```
åŒæ­¥ç­–ç•¥ï¼š
1. ä¸»ä»å¤åˆ¶ï¼šä¸»åº“åˆ†é…ï¼Œä»åº“åŒæ­¥
2. åˆ†åŒºç­–ç•¥ï¼šä¸åŒå®ä¾‹è´Ÿè´£ä¸åŒå·æ®µèŒƒå›´  
3. é›†ä¸­åˆ†é…ï¼šç»Ÿä¸€çš„IDåˆ†é…æœåŠ¡

å®ä¾‹A: è´Ÿè´£ 1-100ä¸‡
å®ä¾‹B: è´Ÿè´£ 100ä¸‡-200ä¸‡
å®ä¾‹C: è´Ÿè´£ 200ä¸‡-300ä¸‡
```

**ğŸ”§ åˆ†åŒºåˆ†é…å®ç°**
```java
public class PartitionedSegmentService {
    
    private final int instanceId;      // å®ä¾‹ç¼–å·
    private final int totalInstances;  // æ€»å®ä¾‹æ•°
    
    // è®¡ç®—å½“å‰å®ä¾‹è´Ÿè´£çš„å·æ®µèŒƒå›´
    private long calculatePartitionOffset() {
        return instanceId * PARTITION_SIZE;
    }
    
    public Segment allocateSegment(String bizType) {
        long offset = calculatePartitionOffset();
        
        // åœ¨è‡ªå·±çš„åˆ†åŒºå†…åˆ†é…å·æ®µ
        return allocateInPartition(bizType, offset);
    }
}
```

---

## 7. ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**

| æŒ‡æ ‡ç±»åˆ« | **ç›‘æ§æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| **ååé‡** | IDç”ŸæˆQPS | >10ä¸‡/ç§’ | <5ä¸‡/ç§’ |
| **å»¶è¿Ÿ** | å¹³å‡å“åº”æ—¶é—´ | <1ms | >10ms |
| **å¯ç”¨æ€§** | æˆåŠŸç‡ | >99.9% | <99% |
| **èµ„æº** | æ•°æ®åº“è¿æ¥æ•° | <50% | >80% |

### 7.2 æ€§èƒ½è°ƒä¼˜ç­–ç•¥


**âš¡ å¤šç»´åº¦ä¼˜åŒ–**

```java
public class PerformanceOptimizedSegmentService {
    
    // 1. è¿æ¥æ± ä¼˜åŒ–
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(20);        // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);             // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(3000);     // è¿æ¥è¶…æ—¶3ç§’
        return new HikariDataSource(config);
    }
    
    // 2. æ‰¹é‡é¢„åˆ†é…
    public List<Segment> batchAllocateSegments(String bizType, int count) {
        return jdbcTemplate.execute(connection -> {
            // æ‰¹é‡åˆ†é…å¤šä¸ªå·æ®µï¼Œå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
            PreparedStatement ps = connection.prepareStatement(
                "UPDATE id_segment SET max_id = max_id + ? WHERE biz_type = ?");
            
            List<Segment> segments = new ArrayList<>();
            for (int i = 0; i < count; i++) {
                // æ‰¹é‡æ‰§è¡Œ
                segments.add(executeSingleAllocation(ps, bizType));
            }
            return segments;
        });
    }
}
```

### 7.3 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


**ğŸ¯ å¤šçº§ç¼“å­˜æ¶æ„**

```
L1ç¼“å­˜ï¼šåº”ç”¨å†…å­˜ï¼ˆå½“å‰ä½¿ç”¨çš„å·æ®µï¼‰
L2ç¼“å­˜ï¼šRedisï¼ˆé¢„åˆ†é…çš„å·æ®µæ± ï¼‰
L3å­˜å‚¨ï¼šMySQLï¼ˆæŒä¹…åŒ–çš„åˆ†é…è®°å½•ï¼‰

è®¿é—®è·¯å¾„ï¼š
å†…å­˜ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“
å‘½ä¸­ç‡ï¼š   95%    â†’   4%   â†’  1%
```

**ğŸ”§ Redisç¼“å­˜å®ç°**
```java
public class CachedSegmentService {
    
    // Redisä¸­é¢„å­˜å¤šä¸ªå¯ç”¨å·æ®µ
    public void preloadSegmentsToRedis(String bizType) {
        String cacheKey = "segments:" + bizType;
        
        // é¢„åˆ†é…10ä¸ªå·æ®µå­˜å…¥Redis
        for (int i = 0; i < 10; i++) {
            Segment segment = allocateFromDB(bizType);
            redisTemplate.opsForList().rightPush(cacheKey, segment);
        }
    }
    
    public Segment getSegmentFromCache(String bizType) {
        String cacheKey = "segments:" + bizType;
        
        // ä»Redisè·å–å·æ®µ
        Segment segment = redisTemplate.opsForList().leftPop(cacheKey);
        
        // å¦‚æœç¼“å­˜ä¸­å·æ®µä¸è¶³ï¼Œå¼‚æ­¥è¡¥å……
        if (getCacheSize(cacheKey) < 3) {
            asyncRefillCache(bizType);
        }
        
        return segment;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å·æ®µæ¨¡å¼ï¼šæ‰¹é‡åˆ†é…IDå·æ®µï¼Œæœ¬åœ°åˆ†å‘ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
ğŸ”¸ åŒBufferï¼šå½“å‰bufferä½¿ç”¨ï¼Œå¤‡ç”¨bufferé¢„å‡†å¤‡ï¼Œæ— ç¼åˆ‡æ¢
ğŸ”¸ å¹¶å‘æ§åˆ¶ï¼šAtomicLong + CASä¿è¯çº¿ç¨‹å®‰å…¨
ğŸ”¸ æ•…éšœå®¹é”™ï¼šå¤šæ•°æ®æº+åˆ†åŒºç­–ç•¥+åº”æ€¥æ–¹æ¡ˆ
ğŸ”¸ åŠ¨æ€è°ƒä¼˜ï¼šæ ¹æ®QPSè‡ªåŠ¨è°ƒæ•´å·æ®µå¤§å°
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å·æ®µæ¨¡å¼çš„æ ¸å¿ƒä»·å€¼**
```
æ€§èƒ½æå‡ï¼š
- æ‰¹é‡åˆ†é…å‡å°‘æ•°æ®åº“è®¿é—®99%
- å†…å­˜åˆ†å‘QPSå¯è¾¾10ä¸‡+

å¯ç”¨æ€§ä¿è¯ï¼š
- åŒbufferé¿å…ç”³è¯·æ–°å·æ®µæ—¶çš„é˜»å¡
- å¤šå®ä¾‹éƒ¨ç½²é¿å…å•ç‚¹æ•…éšœ

æ‰©å±•æ€§æ”¯æŒï¼š
- åŠ¨æ€è°ƒæ•´å·æ®µå¤§å°é€‚åº”æµé‡å˜åŒ–
- æ°´å¹³æ‰©å±•æ”¯æŒæ›´å¤§å¹¶å‘é‡
```

**ğŸ”¹ è®¾è®¡æƒè¡¡è€ƒè™‘**
```
å·æ®µå¤§å°æƒè¡¡ï¼š
- å¤ªå°ï¼šæ•°æ®åº“å‹åŠ›å¤§ï¼Œæ€§èƒ½å·®
- å¤ªå¤§ï¼šé‡å¯æµªè´¹å¤šï¼Œå†…å­˜å ç”¨é«˜
- æœ€ä½³ï¼šæ ¹æ®QPSåŠ¨æ€è°ƒæ•´

ä¸€è‡´æ€§ä¸æ€§èƒ½ï¼š
- å¼ºä¸€è‡´æ€§ï¼šæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ï¼Œæ€§èƒ½å·®
- æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸å·æ®µå†…ä¹±åºï¼Œæ€§èƒ½å¥½
- å®è·µé€‰æ‹©ï¼šå¤§éƒ¨åˆ†åœºæ™¯é€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è®¢å•ç³»ç»Ÿ**ï¼šç”Ÿæˆå…¨å±€å”¯ä¸€è®¢å•å·ï¼Œæ”¯æŒé«˜å¹¶å‘ä¸‹å•
- **ç”¨æˆ·ç³»ç»Ÿ**ï¼šåˆ†é…ç”¨æˆ·IDï¼Œä¿è¯ç”¨æˆ·æ³¨å†Œçš„é«˜å¯ç”¨æ€§
- **æ¶ˆæ¯ç³»ç»Ÿ**ï¼šç”Ÿæˆæ¶ˆæ¯IDï¼Œæ”¯æŒäº¿çº§æ¶ˆæ¯å¤„ç†
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šåˆ†é…æ—¥å¿—IDï¼Œç¡®ä¿æ—¥å¿—çš„å”¯ä¸€æ€§å’Œé¡ºåºæ€§

**ğŸ”§ å®æ–½å»ºè®®**
- **å°å…¬å¸**ï¼šå•æœºå·æ®µæ¨¡å¼ï¼Œç®€å•å¤Ÿç”¨
- **ä¸­ç­‰è§„æ¨¡**ï¼šåŒbuffer + Redisç¼“å­˜ï¼Œå¹³è¡¡æ€§èƒ½å’Œå¤æ‚åº¦  
- **å¤§å‚è§„æ¨¡**ï¼šåˆ†åŒºå·æ®µ + å¤šæœºæˆ¿éƒ¨ç½²ï¼Œæè‡´æ€§èƒ½å’Œå¯ç”¨æ€§
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼Œæå‰å‘ç°é—®é¢˜

**ğŸ’¡ æœ€ä½³å®è·µ**
```
å¼€å‘é˜¶æ®µï¼š
1. å…ˆå®ç°åŸºç¡€çš„å•bufferç‰ˆæœ¬
2. å‹æµ‹éªŒè¯æ€§èƒ½æ˜¯å¦æ»¡è¶³éœ€æ±‚
3. æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹ä¼˜åŒ–å·æ®µå¤§å°

ç”Ÿäº§éƒ¨ç½²ï¼š
1. å®æ–½åŒbufferæå‡å¯ç”¨æ€§
2. é…ç½®å¤šæ•°æ®æºå®¹ç¾
3. å»ºç«‹ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
4. å®šæœŸreviewå’Œä¼˜åŒ–å‚æ•°

æ€§èƒ½è°ƒä¼˜ï¼š
1. ç›‘æ§QPSå’Œå“åº”æ—¶é—´
2. æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´step
3. åˆç†è®¾ç½®bufferåˆ‡æ¢é˜ˆå€¼
4. ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ‰¹é‡ç”³è¯·å‡å‹åŠ›ï¼Œæœ¬åœ°åˆ†å‘ææ€§èƒ½
- åŒbufferåˆ‡æ¢æ— é˜»å¡ï¼Œå¹¶å‘æ§åˆ¶ä¿å®‰å…¨  
- åŠ¨æ€è°ƒæ•´é€‚æµé‡ï¼Œæ•…éšœè½¬ç§»ä¿å¯ç”¨
- ç›‘æ§å‘Šè­¦è¦åŠæ—¶ï¼ŒæŒç»­ä¼˜åŒ–æ˜¯å…³é”®