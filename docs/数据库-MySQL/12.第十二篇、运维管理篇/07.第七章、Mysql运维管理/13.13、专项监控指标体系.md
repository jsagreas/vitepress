---
title: 13ã€ä¸“é¡¹ç›‘æ§æŒ‡æ ‡ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [MySQLç›‘æ§ä½“ç³»æ¦‚è¿°](#1-MySQLç›‘æ§ä½“ç³»æ¦‚è¿°)
2. [InnoDBå¼•æ“ä¸“é¡¹ç›‘æ§æŒ‡æ ‡](#2-InnoDBå¼•æ“ä¸“é¡¹ç›‘æ§æŒ‡æ ‡)
3. [MySQLè¿æ¥æ± ç›‘æ§ä½“ç³»](#3-MySQLè¿æ¥æ± ç›‘æ§ä½“ç³»)
4. [æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒç›‘æ§](#4-æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒç›‘æ§)
5. [ç´¢å¼•ä½¿ç”¨æ•ˆç‡ç›‘æ§](#5-ç´¢å¼•ä½¿ç”¨æ•ˆç‡ç›‘æ§)
6. [è¡¨ç©ºé—´ç¢ç‰‡åŒ–ç›‘æ§](#6-è¡¨ç©ºé—´ç¢ç‰‡åŒ–ç›‘æ§)
7. [ä¸´æ—¶è¡¨ä½¿ç”¨é¢‘ç‡ç›‘æ§](#7-ä¸´æ—¶è¡¨ä½¿ç”¨é¢‘ç‡ç›‘æ§)
8. [é”äº‰ç”¨æ—¶é—´ç›‘æ§](#8-é”äº‰ç”¨æ—¶é—´ç›‘æ§)
9. [MySQLç‰¹æœ‰æ€§èƒ½è®¡æ•°å™¨è¯¦è§£](#9-MySQLç‰¹æœ‰æ€§èƒ½è®¡æ•°å™¨è¯¦è§£)
10. [Information_Schemaç³»ç»Ÿè¡¨ç›‘æ§](#10-Information_Schemaç³»ç»Ÿè¡¨ç›‘æ§)
11. [Performance_Schemaç›‘æ§å®æˆ˜](#11-Performance_Schemaç›‘æ§å®æˆ˜)
12. [MySQLé”™è¯¯ä»£ç ç›‘æ§åˆ†ç±»](#12-MySQLé”™è¯¯ä»£ç ç›‘æ§åˆ†ç±»)
13. [å­˜å‚¨å¼•æ“çº§åˆ«ç›‘æ§æŒ‡æ ‡](#13-å­˜å‚¨å¼•æ“çº§åˆ«ç›‘æ§æŒ‡æ ‡)
14. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#14-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” MySQLç›‘æ§ä½“ç³»æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸“é¡¹ç›‘æ§


**MySQLç›‘æ§çš„æ ¸å¿ƒæ„ä¹‰**ï¼š
```
æ•°æ®åº“æ˜¯åº”ç”¨ç³»ç»Ÿçš„å¿ƒè„ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å½±å“é¢å·¨å¤§ï¼š
â€¢ æ€§èƒ½é—®é¢˜ â†’ ç”¨æˆ·ä½“éªŒä¸‹é™ï¼Œå“åº”ç¼“æ…¢
â€¢ ç¨³å®šæ€§é—®é¢˜ â†’ ç³»ç»Ÿå®•æœºï¼Œä¸šåŠ¡ä¸­æ–­
â€¢ å®¹é‡é—®é¢˜ â†’ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼ŒæœåŠ¡ä¸å¯ç”¨
â€¢ å®‰å…¨é—®é¢˜ â†’ æ•°æ®æ³„éœ²ï¼Œä¸šåŠ¡é£é™©

é€šè¿‡ä¸“é¡¹ç›‘æ§å¯ä»¥ï¼š
âœ… æå‰å‘ç°æ½œåœ¨é—®é¢˜ï¼Œé¢„é˜²æ•…éšœ
âœ… å¿«é€Ÿå®šä½é—®é¢˜æ ¹å› ï¼Œç¼©çŸ­æ•…éšœæ—¶é—´
âœ… ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
âœ… åˆç†è§„åˆ’å®¹é‡ï¼Œæ§åˆ¶æˆæœ¬
```

### 1.2 MySQLç›‘æ§å±‚æ¬¡æ¶æ„


```
MySQLç›‘æ§ä½“ç³»æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡å±‚ç›‘æ§     â”‚ â† ä¸šåŠ¡æŒ‡æ ‡ã€ç”¨æˆ·ä½“éªŒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨å±‚ç›‘æ§     â”‚ â† è¿æ¥æ± ã€SQLæ‰§è¡Œæ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   MySQLå±‚ç›‘æ§   â”‚ â† æ€§èƒ½è®¡æ•°å™¨ã€é”ã€ç´¢å¼•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å­˜å‚¨å¼•æ“ç›‘æ§   â”‚ â† InnoDBç¼“å†²æ± ã€äº‹åŠ¡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç³»ç»Ÿå±‚ç›‘æ§     â”‚ â† CPUã€å†…å­˜ã€ç£ç›˜IO
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸€å±‚éƒ½æœ‰ä¸åŒçš„å…³æ³¨é‡ç‚¹å’Œç›‘æ§æŒ‡æ ‡
```

### 1.3 ç›‘æ§æŒ‡æ ‡åˆ†ç±»ä½“ç³»


**æŒ‰ç…§ç´§æ€¥ç¨‹åº¦åˆ†ç±»**ï¼š
- ğŸš¨ **P0çº§åˆ«**ï¼šå½±å“ä¸šåŠ¡å¯ç”¨æ€§çš„å…³é”®æŒ‡æ ‡
- âš ï¸ **P1çº§åˆ«**ï¼šå½±å“æ€§èƒ½ä½“éªŒçš„é‡è¦æŒ‡æ ‡  
- â„¹ï¸ **P2çº§åˆ«**ï¼šç”¨äºä¼˜åŒ–åˆ†æçš„å‚è€ƒæŒ‡æ ‡

**æŒ‰ç…§ç›‘æ§èŒƒå›´åˆ†ç±»**ï¼š
- **å®ä¾‹çº§**ï¼šæ•´ä¸ªMySQLå®ä¾‹çš„å…¨å±€æŒ‡æ ‡
- **æ•°æ®åº“çº§**ï¼šç‰¹å®šæ•°æ®åº“schemaçš„æŒ‡æ ‡
- **è¡¨çº§**ï¼šå•ä¸ªè¡¨çš„è¯¦ç»†æŒ‡æ ‡
- **ä¼šè¯çº§**ï¼šå•ä¸ªè¿æ¥ä¼šè¯çš„æŒ‡æ ‡

---

## 2. âš™ï¸ InnoDBå¼•æ“ä¸“é¡¹ç›‘æ§æŒ‡æ ‡


### 2.1 InnoDBç¼“å†²æ± ç›‘æ§


**ç¼“å†²æ± æ˜¯ä»€ä¹ˆ**ï¼š
InnoDBç¼“å†²æ± æ˜¯MySQLæœ€é‡è¦çš„å†…å­˜ç»“æ„ï¼Œå®ƒç¼“å­˜è¡¨æ•°æ®å’Œç´¢å¼•æ•°æ®ï¼Œå‡å°‘ç£ç›˜IOæ“ä½œã€‚ç¼“å†²æ± çš„å¥åº·çŠ¶å†µç›´æ¥å½±å“æ•°æ®åº“æ€§èƒ½ã€‚

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡åç§° | è·å–æ–¹å¼ | æ­£å¸¸èŒƒå›´ | è¯´æ˜ |
|---------|---------|---------|------|
| **ç¼“å†²æ± å‘½ä¸­ç‡** | `(1 - Innodb_buffer_pool_reads/Innodb_buffer_pool_read_requests) * 100` | `>95%` | è¶Šé«˜è¶Šå¥½ï¼Œä½äº95%éœ€è¦è°ƒä¼˜ |
| **ç¼“å†²æ± ä½¿ç”¨ç‡** | `Innodb_buffer_pool_pages_data/Innodb_buffer_pool_pages_total * 100` | `70%-90%` | å¤ªä½æµªè´¹å†…å­˜ï¼Œå¤ªé«˜å¯èƒ½ä¸å¤Ÿç”¨ |
| **è„é¡µæ¯”ä¾‹** | `Innodb_buffer_pool_pages_dirty/Innodb_buffer_pool_pages_data * 100` | `<30%` | è¿‡é«˜ä¼šå½±å“æ£€æŸ¥ç‚¹æ€§èƒ½ |

```sql
-- æŸ¥çœ‹ç¼“å†²æ± å…³é”®æŒ‡æ ‡
SHOW STATUS LIKE 'Innodb_buffer_pool%';

-- è®¡ç®—ç¼“å†²æ± å‘½ä¸­ç‡
SELECT 
  ROUND((1 - (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
              WHERE VARIABLE_NAME = 'Innodb_buffer_pool_reads') /
             (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
              WHERE VARIABLE_NAME = 'Innodb_buffer_pool_read_requests')) * 100, 2) 
  AS buffer_pool_hit_rate;
```

> ğŸ’¡ **ä¼˜åŒ–å»ºè®®**ï¼šå¦‚æœç¼“å†²æ± å‘½ä¸­ç‡ä½äº95%ï¼Œè€ƒè™‘å¢åŠ `innodb_buffer_pool_size`å‚æ•°

### 2.2 InnoDBäº‹åŠ¡ç›‘æ§


**äº‹åŠ¡ç›‘æ§çš„é‡è¦æ€§**ï¼š
äº‹åŠ¡æ˜¯æ•°æ®åº“ACIDç‰¹æ€§çš„ä¿éšœï¼Œç›‘æ§äº‹åŠ¡çŠ¶æ€å¯ä»¥å‘ç°é”ç­‰å¾…ã€æ­»é”ç­‰é—®é¢˜ã€‚

**å…³é”®äº‹åŠ¡æŒ‡æ ‡**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰æ´»è·ƒäº‹åŠ¡
SELECT 
  trx_id,
  trx_state,
  trx_started,
  TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration,
  trx_isolation_level,
  trx_rows_locked,
  trx_rows_modified
FROM information_schema.innodb_trx
ORDER BY trx_started;
```

**é‡è¦ç›‘æ§æŒ‡æ ‡**ï¼š
- **æ´»è·ƒäº‹åŠ¡æ•°é‡**ï¼š`SELECT COUNT(*) FROM information_schema.innodb_trx`
- **é•¿äº‹åŠ¡æ£€æµ‹**ï¼šè¿è¡Œè¶…è¿‡30ç§’çš„äº‹åŠ¡
- **äº‹åŠ¡é”ç­‰å¾…æ—¶é—´**ï¼š`innodb_lock_wait_timeout`ç›¸å…³æŒ‡æ ‡

### 2.3 InnoDBæ—¥å¿—ç›‘æ§


**é‡åšæ—¥å¿—ï¼ˆRedo Logï¼‰ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹é‡åšæ—¥å¿—çŠ¶æ€
SHOW STATUS LIKE 'Innodb_log%';

-- å…³é”®æŒ‡æ ‡è§£é‡Šï¼š
-- Innodb_log_waits: ç­‰å¾…æ—¥å¿—ç¼“å†²åŒºçš„æ¬¡æ•°ï¼ˆåº”è¯¥ä¸º0ï¼‰
-- Innodb_log_writes: æ—¥å¿—å†™å…¥æ¬¡æ•°
-- Innodb_log_write_requests: æ—¥å¿—å†™å…¥è¯·æ±‚æ¬¡æ•°
```

**ç›‘æ§è¦ç‚¹**ï¼š
- **æ—¥å¿—ç­‰å¾…æ¬¡æ•°**ï¼š`Innodb_log_waits`åº”è¯¥ä¿æŒä¸º0
- **æ—¥å¿—å†™å…¥æ¯”ç‡**ï¼š`Innodb_log_writes/Innodb_log_write_requests`
- **æ—¥å¿—æ–‡ä»¶ä½¿ç”¨ç‡**ï¼šé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å°å¯¼è‡´é¢‘ç¹åˆ‡æ¢

---

## 3. ğŸ”— MySQLè¿æ¥æ± ç›‘æ§ä½“ç³»


### 3.1 è¿æ¥æ•°ç›‘æ§


**è¿æ¥æ˜¯ä»€ä¹ˆ**ï¼š
MySQLè¿æ¥å°±åƒæ˜¯åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“ä¹‹é—´çš„"ç”µè¯çº¿"ï¼Œæ¯ä¸ªæŸ¥è¯¢éƒ½éœ€è¦é€šè¿‡è¿æ¥æ¥æ‰§è¡Œã€‚è¿æ¥æ•°è¿‡å¤šä¼šæ¶ˆè€—èµ„æºï¼Œè¿‡å°‘ä¼šå½±å“å¹¶å‘ã€‚

**æ ¸å¿ƒè¿æ¥æŒ‡æ ‡**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥çŠ¶æ€
SHOW STATUS LIKE 'Threads_%';
SHOW STATUS LIKE 'Connections';
SHOW STATUS LIKE 'Max_used_connections';

-- æŸ¥çœ‹è¿æ¥è¯¦æƒ…
SELECT 
  USER,
  HOST,
  DB,
  COMMAND,
  TIME,
  STATE,
  INFO
FROM information_schema.PROCESSLIST
WHERE COMMAND != 'Sleep'
ORDER BY TIME DESC;
```

**ç›‘æ§æŒ‡æ ‡è§£æ**ï¼š

| æŒ‡æ ‡ | å«ä¹‰ | ç›‘æ§å»ºè®® |
|-----|------|---------|
| **Threads_connected** | å½“å‰è¿æ¥æ•° | ä¸åº”è¶…è¿‡`max_connections`çš„80% |
| **Threads_running** | æ­£åœ¨æ‰§è¡Œçš„è¿æ¥æ•° | é€šå¸¸åº”å°äºCPUæ ¸å¿ƒæ•°çš„2å€ |
| **Max_used_connections** | å†å²æœ€å¤§è¿æ¥æ•° | ç”¨äºè¯„ä¼°è¿æ¥æ•°é…ç½®æ˜¯å¦åˆç† |
| **Connection_errors_max_connections** | å› è¿æ¥æ•°è¶…é™è¢«æ‹’ç»çš„æ¬¡æ•° | åº”è¯¥ä¿æŒä¸º0 |

### 3.2 è¿æ¥è´¨é‡ç›‘æ§


**è¿æ¥å¼‚å¸¸ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥é”™è¯¯ç»Ÿè®¡
SHOW STATUS LIKE 'Connection_errors%';
SHOW STATUS LIKE 'Aborted%';

-- å…³é”®é”™è¯¯æŒ‡æ ‡ï¼š
-- Connection_errors_internal: å†…éƒ¨é”™è¯¯
-- Connection_errors_max_connections: è¿æ¥æ•°è¶…é™
-- Aborted_connects: è¿æ¥å»ºç«‹å¤±è´¥æ¬¡æ•°
-- Aborted_clients: å®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€æ¬¡æ•°
```

> âš ï¸ **æ³¨æ„**ï¼š`Aborted_connects`æŒç»­å¢é•¿è¯´æ˜æœ‰è¿æ¥å»ºç«‹é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ç½‘ç»œå’Œå®¢æˆ·ç«¯é…ç½®

### 3.3 è¿æ¥æ± é…ç½®ä¼˜åŒ–


**è¿æ¥æ± å‚æ•°ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥ç›¸å…³é…ç½®
SHOW VARIABLES LIKE 'max_connections';
SHOW VARIABLES LIKE 'max_user_connections';
SHOW VARIABLES LIKE 'thread_cache_size';
SHOW VARIABLES LIKE 'wait_timeout';
SHOW VARIABLES LIKE 'interactive_timeout';
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- **max_connections**ï¼šæ ¹æ®ä¸šåŠ¡å¹¶å‘é‡è®¾ç½®ï¼Œé€šå¸¸100-1000
- **thread_cache_size**ï¼šè®¾ç½®ä¸ºå¸¸è§å¹¶å‘è¿æ¥æ•°ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºå¼€é”€
- **wait_timeout**ï¼šè®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé¿å…åƒµå°¸è¿æ¥

---

## 4. â±ï¸ æŸ¥è¯¢æ‰§è¡Œæ—¶é—´åˆ†å¸ƒç›‘æ§


### 4.1 æ…¢æŸ¥è¯¢ç›‘æ§


**æ…¢æŸ¥è¯¢æ˜¯ä»€ä¹ˆ**ï¼š
æ…¢æŸ¥è¯¢å°±æ˜¯æ‰§è¡Œæ—¶é—´è¶…è¿‡è®¾å®šé˜ˆå€¼çš„SQLè¯­å¥ã€‚å®ƒä»¬æ˜¯æ€§èƒ½é—®é¢˜çš„ä¸»è¦å…ƒå‡¶ï¼Œä¼šå ç”¨å¤§é‡èµ„æºå½±å“æ•´ä½“æ€§èƒ½ã€‚

**å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢é…ç½®
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 2;  -- 2ç§’ä»¥ä¸Šçš„æŸ¥è¯¢è®°å½•ä¸ºæ…¢æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = ON;  -- è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
```

**æ…¢æŸ¥è¯¢åˆ†æç¤ºä¾‹**ï¼š

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ç»Ÿè®¡
SHOW STATUS LIKE 'Slow_queries';

-- ä½¿ç”¨mysqldumpslowåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
-- mysqldumpslow -s t -t 10 /var/log/mysql/slow.log
-- -s t: æŒ‰æŸ¥è¯¢æ—¶é—´æ’åº
-- -t 10: æ˜¾ç¤ºå‰10æ¡
```

### 4.2 æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒç›‘æ§


**ä½¿ç”¨Performance Schemaç›‘æ§æŸ¥è¯¢æ—¶é—´**ï¼š

```sql
-- æŸ¥çœ‹SQLè¯­å¥æ‰§è¡Œç»Ÿè®¡
SELECT 
  SCHEMA_NAME,
  DIGEST_TEXT,
  COUNT_STAR as exec_count,
  AVG_TIMER_WAIT/1000000000 as avg_time_sec,
  MAX_TIMER_WAIT/1000000000 as max_time_sec,
  SUM_TIMER_WAIT/1000000000 as total_time_sec
FROM performance_schema.events_statements_summary_by_digest
WHERE SCHEMA_NAME IS NOT NULL
ORDER BY SUM_TIMER_WAIT DESC
LIMIT 10;
```

**æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒåˆ†æ**ï¼š

```
æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒå›¾ï¼ˆASCIIç¤ºæ„ï¼‰ï¼š

æ‰§è¡Œæ—¶é—´    æŸ¥è¯¢æ•°é‡     ç™¾åˆ†æ¯”
0-0.1s     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 80%   â† å¿«é€ŸæŸ¥è¯¢
0.1-1s     â–ˆâ–ˆâ–ˆâ–ˆ         20%   â† ä¸€èˆ¬æŸ¥è¯¢  
1-5s       â–ˆâ–ˆ           5%    â† æ…¢æŸ¥è¯¢
5s+        â–Œ            1%    â† è¶…æ…¢æŸ¥è¯¢ï¼ˆéœ€è¦é‡ç‚¹å…³æ³¨ï¼‰

ç†æƒ³çš„åˆ†å¸ƒåº”è¯¥æ˜¯å¤§éƒ¨åˆ†æŸ¥è¯¢åœ¨0.1ç§’ä»¥å†…å®Œæˆ
```

### 4.3 æŸ¥è¯¢ç±»å‹åˆ†æ


**æŒ‰æŸ¥è¯¢ç±»å‹ç»Ÿè®¡**ï¼š

```sql
-- æŸ¥çœ‹ä¸åŒç±»å‹SQLçš„æ‰§è¡Œæƒ…å†µ
SELECT 
  EVENT_NAME,
  COUNT_STAR,
  AVG_TIMER_WAIT/1000000000 as avg_time_sec,
  SUM_TIMER_WAIT/1000000000 as total_time_sec
FROM performance_schema.events_statements_summary_global_by_event_name
WHERE EVENT_NAME LIKE 'statement/sql/%'
ORDER BY SUM_TIMER_WAIT DESC;
```

**é‡ç‚¹å…³æ³¨çš„æŸ¥è¯¢ç±»å‹**ï¼š
- **SELECTæŸ¥è¯¢**ï¼šå…³æ³¨æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•
- **INSERTæŸ¥è¯¢**ï¼šå…³æ³¨æ‰¹é‡æ’å…¥çš„æ•ˆç‡
- **UPDATE/DELETEæŸ¥è¯¢**ï¼šå…³æ³¨å½±å“è¡Œæ•°å’Œé”ç­‰å¾…
- **å¤æ‚JOINæŸ¥è¯¢**ï¼šå…³æ³¨æ‰§è¡Œè®¡åˆ’å’Œä¸´æ—¶è¡¨ä½¿ç”¨

---

## 5. ğŸ“Š ç´¢å¼•ä½¿ç”¨æ•ˆç‡ç›‘æ§


### 5.1 ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡


**ç´¢å¼•æ˜¯ä»€ä¹ˆ**ï¼š
ç´¢å¼•å°±åƒä¹¦ç±çš„ç›®å½•ï¼Œå®ƒå¸®åŠ©MySQLå¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„æ•°æ®ï¼Œè€Œä¸ç”¨é€è¡Œæ‰«ææ•´ä¸ªè¡¨ã€‚ç´¢å¼•ä½¿ç”¨æ•ˆç‡ç›´æ¥å½±å“æŸ¥è¯¢æ€§èƒ½ã€‚

**ç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  INDEX_NAME,
  CARDINALITY,
  SUB_PART,
  NULLABLE,
  INDEX_TYPE
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY TABLE_SCHEMA, TABLE_NAME;
```

**æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT 
  OBJECT_SCHEMA,
  OBJECT_NAME,
  COUNT_STAR,
  COUNT_READ,
  COUNT_WRITE,
  SUM_TIMER_WAIT/1000000000 as total_time_sec
FROM performance_schema.table_io_waits_summary_by_table
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY SUM_TIMER_WAIT DESC;
```

### 5.2 ç´¢å¼•æ•ˆç‡åˆ†æ


**ç´¢å¼•é€‰æ‹©æ€§ç›‘æ§**ï¼š

```sql
-- åˆ†æç´¢å¼•é€‰æ‹©æ€§ï¼ˆå€¼è¶Šæ¥è¿‘1è¶Šå¥½ï¼‰
SELECT 
  TABLE_NAME,
  COLUMN_NAME,
  CARDINALITY,
  CARDINALITY / (SELECT TABLE_ROWS FROM information_schema.TABLES 
                 WHERE TABLE_NAME = s.TABLE_NAME 
                 AND TABLE_SCHEMA = s.TABLE_SCHEMA) as selectivity
FROM information_schema.STATISTICS s
WHERE TABLE_SCHEMA = 'your_database'
  AND CARDINALITY > 0
ORDER BY selectivity DESC;
```

**é‡å¤å’Œå†—ä½™ç´¢å¼•æ£€æµ‹**ï¼š

```sql
-- æ£€æµ‹å¯èƒ½é‡å¤çš„ç´¢å¼•
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  GROUP_CONCAT(INDEX_NAME ORDER BY INDEX_NAME) as duplicate_indexes,
  GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) as columns
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
GROUP BY TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME
HAVING COUNT(*) > 1;
```

### 5.3 ç´¢å¼•ç»´æŠ¤ç›‘æ§


**ç´¢å¼•ç¢ç‰‡åŒ–ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¡¨å’Œç´¢å¼•çš„ç¢ç‰‡åŒ–æƒ…å†µ
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  ENGINE,
  DATA_LENGTH/1024/1024 as data_mb,
  INDEX_LENGTH/1024/1024 as index_mb,
  DATA_FREE/1024/1024 as free_mb,
  ROUND(DATA_FREE/(DATA_LENGTH+INDEX_LENGTH+DATA_FREE)*100,2) as fragmentation_pct
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
  AND DATA_FREE > 0
ORDER BY fragmentation_pct DESC;
```

> ğŸ’¡ **ç»´æŠ¤å»ºè®®**ï¼šç¢ç‰‡åŒ–è¶…è¿‡20%çš„è¡¨å»ºè®®æ‰§è¡Œ`OPTIMIZE TABLE`è¿›è¡Œæ•´ç†

---

## 6. ğŸ’¾ è¡¨ç©ºé—´ç¢ç‰‡åŒ–ç›‘æ§


### 6.1 è¡¨ç©ºé—´ç¢ç‰‡åŒ–æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è¡¨ç©ºé—´ç¢ç‰‡**ï¼š
å½“æ•°æ®è¢«åˆ é™¤æˆ–æ›´æ–°æ—¶ï¼Œä¼šåœ¨è¡¨ç©ºé—´ä¸­ç•™ä¸‹"ç©ºæ´"ï¼Œè¿™äº›ç©ºæ´å°±æ˜¯ç¢ç‰‡ã€‚ç¢ç‰‡è¿‡å¤šä¼šå¯¼è‡´ï¼š
- å­˜å‚¨ç©ºé—´æµªè´¹
- æŸ¥è¯¢æ€§èƒ½ä¸‹é™  
- å¤‡ä»½æ—¶é—´å¢é•¿

```
è¡¨ç©ºé—´ç¢ç‰‡ç¤ºæ„å›¾ï¼š

æ­£å¸¸è¡¨ç©ºé—´ï¼š[æ•°æ®][æ•°æ®][æ•°æ®][æ•°æ®][æ•°æ®]
ç¢ç‰‡åŒ–è¡¨ç©ºé—´ï¼š[æ•°æ®][ç©ºæ´][æ•°æ®][ç©ºæ´][ç©ºæ´][æ•°æ®]

ç¢ç‰‡åŒ–åï¼Œç›¸åŒçš„æ•°æ®å ç”¨æ›´å¤šç©ºé—´ï¼ŒæŸ¥è¯¢éœ€è¦æ‰«ææ›´å¤šé¡µé¢
```

### 6.2 ç¢ç‰‡åŒ–æ£€æµ‹æ–¹æ³•


**æ£€æµ‹è¡¨ç¢ç‰‡åŒ–ç¨‹åº¦**ï¼š

```sql
-- è¯¦ç»†çš„ç¢ç‰‡åŒ–åˆ†æ
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  ENGINE,
  TABLE_ROWS,
  ROUND(DATA_LENGTH/1024/1024, 2) as data_size_mb,
  ROUND(INDEX_LENGTH/1024/1024, 2) as index_size_mb,
  ROUND(DATA_FREE/1024/1024, 2) as free_space_mb,
  ROUND(DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100, 2) as fragmentation_pct,
  CASE 
    WHEN DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100 > 25 THEN 'ä¸¥é‡ç¢ç‰‡åŒ–'
    WHEN DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100 > 10 THEN 'ä¸­åº¦ç¢ç‰‡åŒ–'
    WHEN DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100 > 5 THEN 'è½»åº¦ç¢ç‰‡åŒ–'
    ELSE 'æ­£å¸¸'
  END as fragmentation_level
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
  AND DATA_LENGTH > 0
ORDER BY fragmentation_pct DESC;
```

### 6.3 ç¢ç‰‡åŒ–å¤„ç†ç­–ç•¥


**ç¢ç‰‡æ•´ç†æ–¹æ³•**ï¼š

```sql
-- æ–¹æ³•1ï¼šOPTIMIZE TABLEï¼ˆä¼šé”è¡¨ï¼Œé€‚åˆå°è¡¨ï¼‰
OPTIMIZE TABLE your_table_name;

-- æ–¹æ³•2ï¼šALTER TABLEï¼ˆåœ¨çº¿DDLï¼Œé€‚åˆå¤§è¡¨ï¼‰  
ALTER TABLE your_table_name ENGINE=InnoDB;

-- æ–¹æ³•3ï¼špt-online-schema-changeï¼ˆç¬¬ä¸‰æ–¹å·¥å…·ï¼Œæ¨èï¼‰
-- pt-online-schema-change --execute --alter "ENGINE=InnoDB" D=database,t=table_name
```

**ç¢ç‰‡åŒ–ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# ç¢ç‰‡åŒ–ç›‘æ§è„šæœ¬

mysql -e "
SELECT 
  CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) as table_name,
  ROUND(DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100, 2) as fragmentation_pct
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
  AND DATA_LENGTH > 0
  AND DATA_FREE/(DATA_LENGTH+INDEX_LENGTH)*100 > 20
ORDER BY fragmentation_pct DESC;
" | while read table frag; do
  echo "WARNING: Table $table has $frag% fragmentation"
done
```

---

## 7. ğŸ“‹ ä¸´æ—¶è¡¨ä½¿ç”¨é¢‘ç‡ç›‘æ§


### 7.1 ä¸´æ—¶è¡¨åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ä¸´æ—¶è¡¨**ï¼š
ä¸´æ—¶è¡¨æ˜¯MySQLåœ¨æ‰§è¡Œå¤æ‚æŸ¥è¯¢æ—¶è‡ªåŠ¨åˆ›å»ºçš„è¡¨ï¼Œç”¨äºå­˜å‚¨ä¸­é—´ç»“æœã€‚ä¸´æ—¶è¡¨åˆ†ä¸ºä¸¤ç§ï¼š
- **å†…å­˜ä¸´æ—¶è¡¨**ï¼šåœ¨å†…å­˜ä¸­åˆ›å»ºï¼Œé€Ÿåº¦å¿«ä½†å®¹é‡æœ‰é™
- **ç£ç›˜ä¸´æ—¶è¡¨**ï¼šåœ¨ç£ç›˜ä¸Šåˆ›å»ºï¼Œå®¹é‡å¤§ä½†é€Ÿåº¦æ…¢

```
ä¸´æ—¶è¡¨åˆ›å»ºçš„å…¸å‹åœºæ™¯ï¼š

æŸ¥è¯¢åœºæ™¯                 ä¸´æ—¶è¡¨ä½¿ç”¨
GROUP BY               âœ“ ç”¨äºåˆ†ç»„èšåˆ
ORDER BY               âœ“ ç”¨äºæ’åº
DISTINCT               âœ“ ç”¨äºå»é‡
å­æŸ¥è¯¢                 âœ“ ç”¨äºå­˜å‚¨å­æŸ¥è¯¢ç»“æœ
UNION                  âœ“ ç”¨äºåˆå¹¶ç»“æœé›†
å¤æ‚JOIN               âœ“ ç”¨äºå­˜å‚¨ä¸­é—´ç»“æœ
```

### 7.2 ä¸´æ—¶è¡¨ç›‘æ§æŒ‡æ ‡


**ä¸´æ—¶è¡¨ç»Ÿè®¡ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹ä¸´æ—¶è¡¨ä½¿ç”¨æƒ…å†µ
SHOW STATUS LIKE 'Created_tmp%';

-- é‡è¦æŒ‡æ ‡è§£é‡Šï¼š
-- Created_tmp_tables: åˆ›å»ºçš„ä¸´æ—¶è¡¨æ€»æ•°
-- Created_tmp_disk_tables: åˆ›å»ºçš„ç£ç›˜ä¸´æ—¶è¡¨æ•°
-- Created_tmp_files: åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶æ•°
```

**ä¸´æ—¶è¡¨æ•ˆç‡åˆ†æ**ï¼š

```sql
-- è®¡ç®—ç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹
SELECT 
  $$Created_tmp_disk_tables as disk_tmp_tables,
  $$Created_tmp_tables as total_tmp_tables,
  ROUND($$Created_tmp_disk_tables / $$Created_tmp_tables * 100, 2) as disk_tmp_pct
FROM dual;
```

> âš ï¸ **æ€§èƒ½è­¦å‘Š**ï¼šç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹è¶…è¿‡25%è¯´æ˜éœ€è¦ä¼˜åŒ–æŸ¥è¯¢æˆ–è°ƒæ•´å‚æ•°

### 7.3 ä¸´æ—¶è¡¨ä¼˜åŒ–ç­–ç•¥


**å‚æ•°è°ƒä¼˜**ï¼š

```sql
-- æŸ¥çœ‹ä¸´æ—¶è¡¨ç›¸å…³å‚æ•°
SHOW VARIABLES LIKE 'tmp_table_size';
SHOW VARIABLES LIKE 'max_heap_table_size';
SHOW VARIABLES LIKE 'internal_tmp_disk_storage_engine';

-- ä¼˜åŒ–å»ºè®®ï¼š
-- tmp_table_size: å¢å¤§å†…å­˜ä¸´æ—¶è¡¨å¤§å°ï¼ˆå¦‚64MBï¼‰
-- max_heap_table_size: éœ€è¦åŒæ—¶å¢å¤§è¿™ä¸ªå‚æ•°
-- ä¸¤ä¸ªå‚æ•°å–è¾ƒå°å€¼ä½œä¸ºå®é™…é™åˆ¶
```

**æŸ¥è¯¢ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- æ‰¾å‡ºåˆ›å»ºä¸´æ—¶è¡¨çš„æŸ¥è¯¢
SELECT 
  DIGEST_TEXT,
  COUNT_STAR,
  SUM_CREATED_TMP_TABLES,
  SUM_CREATED_TMP_DISK_TABLES,
  ROUND(SUM_CREATED_TMP_DISK_TABLES/SUM_CREATED_TMP_TABLES*100, 2) as disk_tmp_pct
FROM performance_schema.events_statements_summary_by_digest
WHERE SUM_CREATED_TMP_TABLES > 0
ORDER BY SUM_CREATED_TMP_DISK_TABLES DESC
LIMIT 10;
```

**ä¼˜åŒ–æ–¹æ³•**ï¼š
- **æ·»åŠ é€‚å½“ç´¢å¼•**ï¼šé¿å…æ–‡ä»¶æ’åºå’Œä¸´æ—¶è¡¨
- **ä¼˜åŒ–GROUP BY**ï¼šä½¿ç”¨ç´¢å¼•åˆ—è¿›è¡Œåˆ†ç»„
- **è°ƒæ•´ORDER BY**ï¼šåˆ©ç”¨ç´¢å¼•é¡ºåºé¿å…æ’åº
- **åˆ†è§£å¤æ‚æŸ¥è¯¢**ï¼šå°†å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºç®€å•æŸ¥è¯¢

---

## 8. ğŸ”’ é”äº‰ç”¨æ—¶é—´ç›‘æ§


### 8.1 MySQLé”æœºåˆ¶æ¦‚è¿°


**MySQLé”çš„åˆ†ç±»**ï¼š

```
MySQLé”åˆ†ç±»ä½“ç³»ï¼š

æŒ‰é”ç²’åº¦åˆ†ï¼š
â”Œâ”€è¡¨çº§é”â”€â”€â”€â”€â”€â”€â”  â”Œâ”€è¡Œçº§é”â”€â”€â”€â”€â”€â”€â”  â”Œâ”€é¡µçº§é”â”€â”€â”€â”€â”€â”€â”
â”‚ é”æ•´ä¸ªè¡¨    â”‚  â”‚ é”å•è¡Œæ•°æ®  â”‚  â”‚ é”æ•°æ®é¡µ    â”‚
â”‚ å¹¶å‘æ€§ä½    â”‚  â”‚ å¹¶å‘æ€§é«˜    â”‚  â”‚ ä»‹äºä¸¤è€…é—´  â”‚
â”‚ å¼€é”€å°      â”‚  â”‚ å¼€é”€å¤§      â”‚  â”‚ å¼€é”€ä¸­ç­‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‰é”æ¨¡å¼åˆ†ï¼š
â€¢ å…±äº«é”ï¼ˆSé”ï¼‰ï¼šè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰
â€¢ æ’ä»–é”ï¼ˆXé”ï¼‰ï¼šå†™é”ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªäº‹åŠ¡æŒæœ‰
â€¢ æ„å‘é”ï¼ˆIS/IXé”ï¼‰ï¼šè¡¨ç¤ºäº‹åŠ¡å‡†å¤‡åœ¨ä¸‹å±‚åŠ é”
```

### 8.2 é”ç­‰å¾…ç›‘æ§


**å½“å‰é”ç­‰å¾…æƒ…å†µ**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
  r.trx_id waiting_trx_id,
  r.trx_mysql_thread_id waiting_thread,
  r.trx_query waiting_query,
  b.trx_id blocking_trx_id,
  b.trx_mysql_thread_id blocking_thread,
  b.trx_query blocking_query,
  TIMESTAMPDIFF(SECOND, r.trx_wait_started, NOW()) as wait_time_sec
FROM information_schema.innodb_lock_waits w
INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;
```

**é”ç»Ÿè®¡ä¿¡æ¯**ï¼š

```sql
-- æŸ¥çœ‹é”ç›¸å…³çŠ¶æ€
SHOW STATUS LIKE 'Innodb_row_lock%';

-- å…³é”®æŒ‡æ ‡ï¼š
-- Innodb_row_lock_current_waits: å½“å‰ç­‰å¾…è¡Œé”çš„äº‹åŠ¡æ•°
-- Innodb_row_lock_time: æ€»çš„è¡Œé”ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
-- Innodb_row_lock_time_avg: å¹³å‡è¡Œé”ç­‰å¾…æ—¶é—´
-- Innodb_row_lock_waits: è¡Œé”ç­‰å¾…æ€»æ¬¡æ•°
```

### 8.3 æ­»é”ç›‘æ§


**æ­»é”æ£€æµ‹**ï¼š

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS\G

-- æ­»é”æ—¥å¿—åˆ†æè¦ç‚¹ï¼š
-- 1. æ­»é”æ¶‰åŠçš„äº‹åŠ¡ä¿¡æ¯
-- 2. æ­»é”å‘ç”Ÿçš„è¡¨å’Œç´¢å¼•
-- 3. äº‹åŠ¡æŒæœ‰å’Œç­‰å¾…çš„é”
-- 4. MySQLé€‰æ‹©å›æ»šçš„äº‹åŠ¡
```

**æ­»é”é¢„é˜²ç­–ç•¥**ï¼š

```sql
-- è®¾ç½®é”ç­‰å¾…è¶…æ—¶æ—¶é—´
SET innodb_lock_wait_timeout = 50;  -- 50ç§’

-- è®¾ç½®æ­»é”æ£€æµ‹
SET innodb_deadlock_detect = ON;    -- å¼€å¯æ­»é”æ£€æµ‹
```

> ğŸ’¡ **æ­»é”è§£å†³æ–¹æ³•**ï¼š
> 1. **ç»Ÿä¸€åŠ é”é¡ºåº**ï¼šæ‰€æœ‰äº‹åŠ¡æŒ‰ç›¸åŒé¡ºåºè·å–é”
> 2. **ç¼©çŸ­äº‹åŠ¡æ—¶é—´**ï¼šå‡å°‘é”æŒæœ‰æ—¶é—´
> 3. **é™ä½éš”ç¦»çº§åˆ«**ï¼šåœ¨ä¸šåŠ¡å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨READ COMMITTED
> 4. **æ·»åŠ åˆé€‚ç´¢å¼•**ï¼šå‡å°‘é”çš„èŒƒå›´

### 8.4 é”äº‰ç”¨åˆ†æ


**é«˜é¢‘é”äº‰ç”¨æŸ¥è¯¢**ï¼š

```sql
-- æŸ¥çœ‹é”äº‰ç”¨è¾ƒå¤šçš„è¡¨
SELECT 
  OBJECT_SCHEMA,
  OBJECT_NAME,
  COUNT_READ,
  COUNT_WRITE,
  SUM_TIMER_READ/1000000000 as total_read_time_sec,
  SUM_TIMER_WRITE/1000000000 as total_write_time_sec,
  AVG_TIMER_READ/1000000000 as avg_read_time_sec,
  AVG_TIMER_WRITE/1000000000 as avg_write_time_sec
FROM performance_schema.table_lock_waits_summary_by_table
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY SUM_TIMER_WRITE DESC;
```

---

## 9. ğŸ“ˆ MySQLç‰¹æœ‰æ€§èƒ½è®¡æ•°å™¨è¯¦è§£


### 9.1 è¿æ¥ç›¸å…³è®¡æ•°å™¨


**è¿æ¥æ€§èƒ½æŒ‡æ ‡**ï¼š

```sql
-- æŸ¥çœ‹è¿æ¥ç›¸å…³è®¡æ•°å™¨
SHOW STATUS LIKE 'Connections';           -- è¿æ¥æ€»æ•°
SHOW STATUS LIKE 'Threads_connected';     -- å½“å‰è¿æ¥æ•°
SHOW STATUS LIKE 'Threads_running';       -- æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°
SHOW STATUS LIKE 'Max_used_connections';  -- å†å²æœ€å¤§è¿æ¥æ•°
SHOW STATUS LIKE 'Connection_errors%';    -- å„ç±»è¿æ¥é”™è¯¯
```

**é‡è¦è®¡æ•°å™¨è¯´æ˜**ï¼š

| è®¡æ•°å™¨åç§° | å«ä¹‰ | ç›‘æ§å»ºè®® |
|-----------|------|---------|
| **Threads_connected** | å½“å‰æ´»è·ƒè¿æ¥æ•° | ä¸åº”è¶…è¿‡max_connectionsçš„80% |
| **Threads_running** | æ­£åœ¨æ‰§è¡ŒæŸ¥è¯¢çš„è¿æ¥æ•° | æŒç»­è¿‡é«˜è¯´æ˜æœ‰æ€§èƒ½é—®é¢˜ |
| **Connection_errors_internal** | å†…éƒ¨è¿æ¥é”™è¯¯æ•° | åº”è¯¥ä¿æŒä¸º0 |
| **Aborted_connects** | è¿æ¥å»ºç«‹å¤±è´¥æ•° | æŒç»­å¢é•¿éœ€è¦æ£€æŸ¥ç½‘ç»œ |

### 9.2 æŸ¥è¯¢æ€§èƒ½è®¡æ•°å™¨


**æŸ¥è¯¢ç»Ÿè®¡æŒ‡æ ‡**ï¼š

```sql
-- æŸ¥è¯¢æ€§èƒ½ç›¸å…³è®¡æ•°å™¨
SHOW STATUS LIKE 'Queries';              -- æ€»æŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Questions';            -- å®¢æˆ·ç«¯æŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Com_select';           -- SELECTæŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Com_insert';           -- INSERTæŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Com_update';           -- UPDATEæŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Com_delete';           -- DELETEæŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Slow_queries';         -- æ…¢æŸ¥è¯¢æ•°
```

**QPSå’ŒTPSè®¡ç®—**ï¼š

```sql
-- è®¡ç®—QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰
SELECT 
  VARIABLE_VALUE as current_queries,
  @previous_queries,
  VARIABLE_VALUE - @previous_queries as queries_diff,
  NOW() as current_time,
  @previous_time,
  TIMESTAMPDIFF(SECOND, @previous_time, NOW()) as time_diff,
  (VARIABLE_VALUE - @previous_queries) / TIMESTAMPDIFF(SECOND, @previous_time, NOW()) as qps
FROM performance_schema.global_status 
WHERE VARIABLE_NAME = 'Queries';
```

### 9.3 ç¼“å­˜æ€§èƒ½è®¡æ•°å™¨


**æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡**ï¼š

```sql
-- æŸ¥è¯¢ç¼“å­˜ç›¸å…³æŒ‡æ ‡ï¼ˆMySQL 5.7åŠä»¥å‰ç‰ˆæœ¬ï¼‰
SHOW STATUS LIKE 'Qcache%';

-- Key Bufferç›¸å…³æŒ‡æ ‡ï¼ˆMyISAMå¼•æ“ï¼‰
SHOW STATUS LIKE 'Key_%';

-- Table Cacheç›¸å…³æŒ‡æ ‡
SHOW STATUS LIKE 'Open%tables';
SHOW STATUS LIKE 'Opened_tables';
```

**é‡è¦ç¼“å­˜æŒ‡æ ‡**ï¼š
- **Qcache_hits**ï¼šæŸ¥è¯¢ç¼“å­˜å‘½ä¸­æ¬¡æ•°
- **Qcache_inserts**ï¼šæŸ¥è¯¢ç¼“å­˜æ’å…¥æ¬¡æ•°  
- **Key_read_requests**ï¼šé”®å€¼è¯»å–è¯·æ±‚æ•°
- **Key_reads**ï¼šä»ç£ç›˜è¯»å–é”®å€¼çš„æ¬¡æ•°

### 9.4 æ’åºå’Œä¸´æ—¶è¡¨è®¡æ•°å™¨


**æ’åºæ€§èƒ½æŒ‡æ ‡**ï¼š

```sql
-- æ’åºç›¸å…³è®¡æ•°å™¨
SHOW STATUS LIKE 'Sort_%';

-- é‡è¦æŒ‡æ ‡ï¼š
-- Sort_rows: æ’åºçš„è¡Œæ•°
-- Sort_range: èŒƒå›´æ’åºçš„æ¬¡æ•°
-- Sort_scan: å…¨è¡¨æ‰«ææ’åºçš„æ¬¡æ•°
-- Sort_merge_passes: æ’åºåˆå¹¶çš„æ¬¡æ•°
```

**æ–‡ä»¶æ’åºç›‘æ§**ï¼š

```sql
-- è®¡ç®—æ’åºæ•ˆç‡
SELECT 
  $$Sort_merge_passes as merge_passes,
  $$Sort_range + $$Sort_scan as total_sorts,
  CASE 
    WHEN $$Sort_range + $$Sort_scan = 0 THEN 0
    ELSE $$Sort_merge_passes / ($$Sort_range + $$Sort_scan) * 100
  END as merge_pass_ratio
FROM dual;
```

> âš ï¸ **ä¼˜åŒ–æç¤º**ï¼šå¦‚æœmerge_pass_ratio > 10%ï¼Œè€ƒè™‘å¢å¤§`sort_buffer_size`

---

## 10. ğŸ—ƒï¸ Information_Schemaç³»ç»Ÿè¡¨ç›‘æ§


### 10.1 Information_Schemaæ¦‚è¿°


**ä»€ä¹ˆæ˜¯Information_Schema**ï¼š
Information_Schemaæ˜¯MySQLçš„ç³»ç»Ÿæ•°æ®åº“ï¼ŒåŒ…å«äº†å…³äºæ•°æ®åº“å…ƒæ•°æ®çš„åªè¯»è§†å›¾ã€‚å®ƒå°±åƒæ˜¯MySQLçš„"ä¿¡æ¯ä¸­å¿ƒ"ï¼Œè®°å½•äº†æ‰€æœ‰æ•°æ®åº“ã€è¡¨ã€åˆ—ã€ç´¢å¼•ç­‰çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
Information_Schemaé‡è¦è¡¨åˆ†ç±»ï¼š

æ•°æ®åº“ç»“æ„ä¿¡æ¯ï¼š
â€¢ SCHEMATA         - æ•°æ®åº“åˆ—è¡¨
â€¢ TABLES           - è¡¨ä¿¡æ¯
â€¢ COLUMNS          - åˆ—ä¿¡æ¯
â€¢ STATISTICS       - ç´¢å¼•ä¿¡æ¯

è¿è¡Œæ—¶ä¿¡æ¯ï¼š
â€¢ PROCESSLIST      - å½“å‰è¿æ¥å’ŒæŸ¥è¯¢
â€¢ INNODB_TRX       - InnoDBäº‹åŠ¡ä¿¡æ¯
â€¢ INNODB_LOCKS     - InnoDBé”ä¿¡æ¯
â€¢ INNODB_LOCK_WAITS - é”ç­‰å¾…ä¿¡æ¯
```

### 10.2 è¡¨å’Œç´¢å¼•ç›‘æ§


**è¡¨å¤§å°å’Œè¡Œæ•°ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æ•°æ®åº“ä¸­å„è¡¨çš„å¤§å°ä¿¡æ¯
SELECT 
  TABLE_SCHEMA as database_name,
  TABLE_NAME as table_name,
  ENGINE,
  TABLE_ROWS as estimated_rows,
  ROUND(DATA_LENGTH/1024/1024, 2) as data_size_mb,
  ROUND(INDEX_LENGTH/1024/1024, 2) as index_size_mb,
  ROUND((DATA_LENGTH + INDEX_LENGTH)/1024/1024, 2) as total_size_mb,
  ROUND(DATA_FREE/1024/1024, 2) as free_space_mb,
  TABLE_COLLATION
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
  AND TABLE_TYPE = 'BASE TABLE'
ORDER BY (DATA_LENGTH + INDEX_LENGTH) DESC;
```

**ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹è¡¨çš„ç´¢å¼•è¯¦æƒ…
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  INDEX_NAME,
  COLUMN_NAME,
  SEQ_IN_INDEX,
  CARDINALITY,
  NULLABLE,
  INDEX_TYPE
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database_name'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;
```

### 10.3 æƒé™å’Œç”¨æˆ·ç›‘æ§


**ç”¨æˆ·æƒé™ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹ç”¨æˆ·æƒé™ä¿¡æ¯
SELECT 
  GRANTEE,
  TABLE_SCHEMA,
  PRIVILEGE_TYPE,
  IS_GRANTABLE
FROM information_schema.SCHEMA_PRIVILEGES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY GRANTEE, TABLE_SCHEMA;

-- æŸ¥çœ‹è¡¨çº§æƒé™
SELECT 
  GRANTEE,
  TABLE_SCHEMA,
  TABLE_NAME,
  PRIVILEGE_TYPE
FROM information_schema.TABLE_PRIVILEGES
ORDER BY GRANTEE, TABLE_SCHEMA, TABLE_NAME;
```

### 10.4 å­˜å‚¨å¼•æ“ä¿¡æ¯ç›‘æ§


**å¼•æ“ä½¿ç”¨ç»Ÿè®¡**ï¼š

```sql
-- æŸ¥çœ‹ä¸åŒå­˜å‚¨å¼•æ“çš„ä½¿ç”¨æƒ…å†µ
SELECT 
  ENGINE,
  COUNT(*) as table_count,
  ROUND(SUM(DATA_LENGTH)/1024/1024, 2) as total_data_mb,
  ROUND(SUM(INDEX_LENGTH)/1024/1024, 2) as total_index_mb,
  ROUND(SUM(DATA_LENGTH + INDEX_LENGTH)/1024/1024, 2) as total_size_mb
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
  AND TABLE_TYPE = 'BASE TABLE'
GROUP BY ENGINE
ORDER BY total_size_mb DESC;
```

**å­—ç¬¦é›†å’Œæ’åºè§„åˆ™ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹å­—ç¬¦é›†ä½¿ç”¨æƒ…å†µ
SELECT 
  CHARACTER_SET_NAME,
  DEFAULT_COLLATE_NAME,
  DESCRIPTION
FROM information_schema.CHARACTER_SETS
ORDER BY CHARACTER_SET_NAME;

-- æŸ¥çœ‹è¡¨çš„å­—ç¬¦é›†åˆ†å¸ƒ
SELECT 
  TABLE_COLLATION,
  COUNT(*) as table_count
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
GROUP BY TABLE_COLLATION
ORDER BY table_count DESC;
```

---

## 11. ğŸ”¬ Performance_Schemaç›‘æ§å®æˆ˜


### 11.1 Performance_Schemaç®€ä»‹


**ä»€ä¹ˆæ˜¯Performance_Schema**ï¼š
Performance_Schemaæ˜¯MySQLçš„æ€§èƒ½ç›‘æ§æ¡†æ¶ï¼Œå®ƒå°±åƒæ˜¯ç»™MySQLè£…äº†ä¸€ä¸ª"æ€§èƒ½ç›‘æ§ä»ª"ï¼Œå¯ä»¥å®æ—¶ç›‘æ§å„ç§æ€§èƒ½æŒ‡æ ‡ï¼Œå¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆã€‚

```
Performance_Schema vs Information_Schemaï¼š

Information_Schema           Performance_Schema
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…ƒæ•°æ®ä¿¡æ¯       â”‚         â”‚ æ€§èƒ½ç›‘æ§æ•°æ®    â”‚
â”‚ è¡¨ç»“æ„ã€ç´¢å¼•ç­‰   â”‚         â”‚ æ‰§è¡Œæ—¶é—´ã€ç­‰å¾…  â”‚
â”‚ ç›¸å¯¹é™æ€        â”‚         â”‚ å®æ—¶åŠ¨æ€        â”‚
â”‚ ç»“æ„åŒ–ä¿¡æ¯      â”‚         â”‚ æ€§èƒ½ç»Ÿè®¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 SQLè¯­å¥æ€§èƒ½ç›‘æ§


**å¼€å¯Performance Schema**ï¼š

```sql
-- æ£€æŸ¥Performance Schemaæ˜¯å¦å¼€å¯
SHOW VARIABLES LIKE 'performance_schema';

-- æŸ¥çœ‹events_statementsç›¸å…³é…ç½®
SELECT * FROM performance_schema.setup_instruments 
WHERE NAME LIKE 'statement/%';

-- å¼€å¯SQLè¯­å¥ç›‘æ§
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES', TIMED = 'YES' 
WHERE NAME LIKE 'statement/%';
```

**SQLæ‰§è¡Œç»Ÿè®¡åˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹æœ€è€—æ—¶çš„SQLè¯­å¥
SELECT 
  SCHEMA_NAME,
  LEFT(DIGEST_TEXT, 100) as sql_text,
  COUNT_STAR as exec_count,
  ROUND(AVG_TIMER_WAIT/1000000000, 3) as avg_time_sec,
  ROUND(MAX_TIMER_WAIT/1000000000, 3) as max_time_sec,
  ROUND(SUM_TIMER_WAIT/1000000000, 3) as total_time_sec,
  ROUND(SUM_LOCK_TIME/1000000000, 3) as total_lock_time_sec,
  SUM_ROWS_EXAMINED as total_rows_examined,
  SUM_ROWS_SENT as total_rows_sent,
  SUM_CREATED_TMP_TABLES as total_tmp_tables,
  SUM_CREATED_TMP_DISK_TABLES as total_tmp_disk_tables
FROM performance_schema.events_statements_summary_by_digest
WHERE SCHEMA_NAME IS NOT NULL
  AND SCHEMA_NAME NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY SUM_TIMER_WAIT DESC
LIMIT 20;
```

### 11.3 IOæ€§èƒ½ç›‘æ§


**æ–‡ä»¶IOç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æ–‡ä»¶IOç»Ÿè®¡
SELECT 
  FILE_NAME,
  EVENT_NAME,
  COUNT_READ,
  COUNT_WRITE,
  SUM_NUMBER_OF_BYTES_READ/1024/1024 as read_mb,
  SUM_NUMBER_OF_BYTES_WRITE/1024/1024 as write_mb,
  ROUND(SUM_TIMER_READ/1000000000, 3) as read_time_sec,
  ROUND(SUM_TIMER_WRITE/1000000000, 3) as write_time_sec
FROM performance_schema.file_summary_by_instance
WHERE SUM_NUMBER_OF_BYTES_READ > 0 OR SUM_NUMBER_OF_BYTES_WRITE > 0
ORDER BY (SUM_NUMBER_OF_BYTES_READ + SUM_NUMBER_OF_BYTES_WRITE) DESC
LIMIT 20;
```

**è¡¨IOç­‰å¾…ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹è¡¨IOç­‰å¾…æƒ…å†µ
SELECT 
  OBJECT_SCHEMA,
  OBJECT_NAME,
  COUNT_READ,
  COUNT_WRITE,
  ROUND(SUM_TIMER_READ/1000000000, 3) as read_time_sec,
  ROUND(SUM_TIMER_WRITE/1000000000, 3) as write_time_sec,
  ROUND(AVG_TIMER_READ/1000000000, 3) as avg_read_time_sec,
  ROUND(AVG_TIMER_WRITE/1000000000, 3) as avg_write_time_sec
FROM performance_schema.table_io_waits_summary_by_table
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema')
ORDER BY SUM_TIMER_READ + SUM_TIMER_WRITE DESC
LIMIT 10;
```

### 11.4 å†…å­˜ä½¿ç”¨ç›‘æ§


**å†…å­˜ä½¿ç”¨æƒ…å†µåˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹å†…å­˜ä½¿ç”¨ç»Ÿè®¡ï¼ˆMySQL 5.7+ï¼‰
SELECT 
  EVENT_NAME,
  COUNT_ALLOC,
  COUNT_FREE,
  SUM_NUMBER_OF_BYTES_ALLOC/1024/1024 as allocated_mb,
  SUM_NUMBER_OF_BYTES_FREE/1024/1024 as freed_mb,
  (SUM_NUMBER_OF_BYTES_ALLOC - SUM_NUMBER_OF_BYTES_FREE)/1024/1024 as current_allocated_mb
FROM performance_schema.memory_summary_global_by_event_name
WHERE SUM_NUMBER_OF_BYTES_ALLOC > 0
ORDER BY current_allocated_mb DESC
LIMIT 20;
```

### 11.5 è¿æ¥å’Œä¼šè¯ç›‘æ§


**è¿æ¥æ´»åŠ¨ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥çš„è¯¦ç»†ä¿¡æ¯
SELECT 
  t.THREAD_ID,
  t.PROCESSLIST_ID,
  t.PROCESSLIST_USER,
  t.PROCESSLIST_HOST,
  t.PROCESSLIST_DB,
  t.PROCESSLIST_COMMAND,
  t.PROCESSLIST_TIME,
  t.PROCESSLIST_STATE,
  LEFT(t.PROCESSLIST_INFO, 100) as current_sql
FROM performance_schema.threads t
WHERE t.TYPE = 'FOREGROUND'
  AND t.PROCESSLIST_COMMAND != 'Sleep'
ORDER BY t.PROCESSLIST_TIME DESC;
```

**ç”¨æˆ·è¿æ¥ç»Ÿè®¡**ï¼š

```sql
-- æŒ‰ç”¨æˆ·ç»Ÿè®¡è¿æ¥æƒ…å†µ
SELECT 
  USER,
  COUNT(*) as connection_count,
  SUM(CASE WHEN COMMAND != 'Sleep' THEN 1 ELSE 0 END) as active_connections,
  AVG(TIME) as avg_connection_time
FROM information_schema.PROCESSLIST
GROUP BY USER
ORDER BY connection_count DESC;
```

---

## 12. âš ï¸ MySQLé”™è¯¯ä»£ç ç›‘æ§åˆ†ç±»


### 12.1 MySQLé”™è¯¯ä»£ç ä½“ç³»


**MySQLé”™è¯¯ä»£ç åˆ†ç±»**ï¼š

```
MySQLé”™è¯¯ä»£ç åˆ†ç±»ä½“ç³»ï¼š

â”Œâ”€è¿æ¥ç±»é”™è¯¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€è¯­æ³•ç±»é”™è¯¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1040: è¿æ¥æ•°è¿‡å¤š   â”‚  â”‚ 1064: SQLè¯­æ³•é”™è¯¯  â”‚
â”‚ 1045: è®¿é—®è¢«æ‹’ç»   â”‚  â”‚ 1146: è¡¨ä¸å­˜åœ¨     â”‚  
â”‚ 2002: è¿æ¥å¤±è´¥     â”‚  â”‚ 1054: åˆ—ä¸å­˜åœ¨     â”‚
â”‚ 2013: è¿æ¥ä¸¢å¤±     â”‚  â”‚ 1062: ä¸»é”®é‡å¤     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€æƒé™ç±»é”™è¯¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€èµ„æºç±»é”™è¯¯â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1142: æƒé™ä¸è¶³     â”‚  â”‚ 1206: é”æ•°è¿‡å¤š     â”‚
â”‚ 1227: è®¿é—®è¢«æ‹’ç»   â”‚  â”‚ 1213: æ­»é”         â”‚
â”‚ 1370: æƒé™é”™è¯¯     â”‚  â”‚ 1205: é”ç­‰å¾…è¶…æ—¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.2 å…³é”®é”™è¯¯ä»£ç ç›‘æ§


**è¿æ¥ç±»é”™è¯¯ç›‘æ§**ï¼š

```sql
-- ç›‘æ§è¿æ¥ç›¸å…³é”™è¯¯
SHOW STATUS LIKE 'Connection_errors%';
SHOW STATUS LIKE 'Aborted%';

-- é‡è¦é”™è¯¯çŠ¶æ€ï¼š
-- Connection_errors_max_connections: è¿æ¥æ•°è¶…é™é”™è¯¯
-- Connection_errors_internal: å†…éƒ¨è¿æ¥é”™è¯¯
-- Aborted_connects: è¿æ¥ä¸­æ–­æ¬¡æ•°
-- Aborted_clients: å®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€æ¬¡æ•°
```

**å¸¸è§è¿æ¥é”™è¯¯å¤„ç†**ï¼š

| é”™è¯¯ä»£ç  | é”™è¯¯æè¿° | ç›‘æ§æ–¹æ³• | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|---------|
| **1040** | Too many connections | ç›‘æ§Threads_connected | å¢åŠ max_connectionsæˆ–ä¼˜åŒ–è¿æ¥æ±  |
| **1045** | Access denied | æ£€æŸ¥é”™è¯¯æ—¥å¿— | æ£€æŸ¥ç”¨æˆ·åå¯†ç å’Œæƒé™ |
| **2002** | Can't connect to server | ç›‘æ§æœåŠ¡çŠ¶æ€ | æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨å’Œç½‘ç»œè¿é€šæ€§ |
| **2013** | Lost connection | ç›‘æ§Aborted_clients | æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§å’Œè¶…æ—¶è®¾ç½® |

### 12.3 ä¸šåŠ¡é€»è¾‘é”™è¯¯ç›‘æ§


**æ•°æ®å®Œæ•´æ€§é”™è¯¯**ï¼š

```sql
-- ç›‘æ§ä¸»é”®å†²çªç­‰é”™è¯¯ï¼ˆé€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—æˆ–åº”ç”¨æ—¥å¿—ï¼‰
-- 1062: Duplicate entry for key 'PRIMARY'
-- 1452: Cannot add or update a child row: foreign key constraint fails
-- 1064: You have an error in your SQL syntax
```

**é”ç›¸å…³é”™è¯¯ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹é”ç›¸å…³é”™è¯¯ç»Ÿè®¡
SHOW STATUS LIKE 'Innodb_deadlocks';
SHOW STATUS LIKE 'Table_locks_waited';

-- æ­»é”ç›‘æ§
SELECT 
  COUNT(*) as deadlock_count,
  MAX(LAST_SEEN) as last_deadlock_time
FROM performance_schema.events_errors_summary_global_by_error
WHERE ERROR_NUMBER = 1213;  -- æ­»é”é”™è¯¯ä»£ç 
```

### 12.4 é”™è¯¯æ—¥å¿—ç›‘æ§ç­–ç•¥


**é”™è¯¯æ—¥å¿—åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# MySQLé”™è¯¯æ—¥å¿—ç›‘æ§è„šæœ¬

ERROR_LOG="/var/log/mysql/error.log"
ALERT_THRESHOLD=10

# æ£€æŸ¥æœ€è¿‘1å°æ—¶çš„é”™è¯¯æ•°é‡
error_count=$(grep "$(date +'%Y-%m-%d %H')" $ERROR_LOG | grep -i error | wc -l)

if [ $error_count -gt $ALERT_THRESHOLD ]; then
    echo "WARNING: $error_count errors found in last hour"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi

# æ£€æŸ¥ç‰¹å®šé”™è¯¯æ¨¡å¼
grep -i "deadlock\|timeout\|connection" $ERROR_LOG | tail -10
```

**å…³é”®é”™è¯¯æ¨¡å¼ç›‘æ§**ï¼š

```sql
-- è®¾ç½®é”™è¯¯äº‹ä»¶ç›‘æ§
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES' 
WHERE NAME = 'statement/sql/error';

-- æŸ¥çœ‹é”™è¯¯ç»Ÿè®¡
SELECT 
  ERROR_NUMBER,
  ERROR_NAME,
  COUNT_STAR,
  FIRST_SEEN,
  LAST_SEEN
FROM performance_schema.events_errors_summary_global_by_error
WHERE COUNT_STAR > 0
ORDER BY COUNT_STAR DESC;
```

---

## 13. ğŸ”§ å­˜å‚¨å¼•æ“çº§åˆ«ç›‘æ§æŒ‡æ ‡


### 13.1 InnoDBå­˜å‚¨å¼•æ“ç›‘æ§


**InnoDBçŠ¶æ€å…¨è§ˆ**ï¼š

```sql
-- æŸ¥çœ‹InnoDBæ•´ä½“çŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- è¿™ä¸ªå‘½ä»¤ä¼šæ˜¾ç¤ºï¼š
-- 1. å½“å‰äº‹åŠ¡ä¿¡æ¯
-- 2. æ­»é”ä¿¡æ¯  
-- 3. å¤–é”®é”™è¯¯ä¿¡æ¯
-- 4. ç¼“å†²æ± ç»Ÿè®¡
-- 5. è¡Œæ“ä½œç»Ÿè®¡
-- 6. æ—¥å¿—ç»Ÿè®¡
```

**InnoDBç¼“å†²æ± è¯¦ç»†ç›‘æ§**ï¼š

```sql
-- InnoDBç¼“å†²æ± å„é¡¹æŒ‡æ ‡
SELECT 
  'Buffer Pool Size' as metric,
  FORMAT($$innodb_buffer_pool_size/1024/1024, 0) as value_mb
UNION ALL
SELECT 
  'Buffer Pool Pages Total',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_buffer_pool_pages_total'), 0)
UNION ALL
SELECT 
  'Buffer Pool Pages Data',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_buffer_pool_pages_data'), 0)
UNION ALL
SELECT 
  'Buffer Pool Pages Free',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_buffer_pool_pages_free'), 0)
UNION ALL
SELECT 
  'Buffer Pool Hit Rate %',
  FORMAT((1 - (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
               WHERE VARIABLE_NAME = 'Innodb_buffer_pool_reads') /
              (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
               WHERE VARIABLE_NAME = 'Innodb_buffer_pool_read_requests')) * 100, 2);
```

### 13.2 InnoDBè¡Œæ“ä½œç›‘æ§


**è¡Œçº§æ“ä½œç»Ÿè®¡**ï¼š

```sql
-- InnoDBè¡Œæ“ä½œç»Ÿè®¡
SELECT 
  'Rows Read' as operation,
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_rows_read'), 0) as count
UNION ALL
SELECT 
  'Rows Inserted',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_rows_inserted'), 0)
UNION ALL
SELECT 
  'Rows Updated',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_rows_updated'), 0)
UNION ALL
SELECT 
  'Rows Deleted',
  FORMAT((SELECT VARIABLE_VALUE FROM performance_schema.global_status 
          WHERE VARIABLE_NAME = 'Innodb_rows_deleted'), 0);
```

### 13.3 MyISAMå­˜å‚¨å¼•æ“ç›‘æ§


**MyISAMé”®ç¼“å†²ç›‘æ§**ï¼š

```sql
-- MyISAMé”®ç¼“å†²ç»Ÿè®¡
SHOW STATUS LIKE 'Key_%';

-- é‡è¦æŒ‡æ ‡ï¼š
-- Key_blocks_used: ä½¿ç”¨çš„é”®ç¼“å†²å—æ•°
-- Key_blocks_unused: æœªä½¿ç”¨çš„é”®ç¼“å†²å—æ•°  
-- Key_read_requests: é”®è¯»å–è¯·æ±‚æ•°
-- Key_reads: ä»ç£ç›˜è¯»å–é”®çš„æ¬¡æ•°
-- Key_write_requests: é”®å†™å…¥è¯·æ±‚æ•°
-- Key_writes: é”®å†™å…¥ç£ç›˜çš„æ¬¡æ•°
```

**MyISAMè¡¨é”ç›‘æ§**ï¼š

```sql
-- MyISAMè¡¨é”ç»Ÿè®¡
SHOW STATUS LIKE 'Table_locks%';

-- è®¡ç®—è¡¨é”ç­‰å¾…æ¯”ä¾‹
SELECT 
  $$Table_locks_immediate as immediate_locks,
  $$Table_locks_waited as waited_locks,
  ROUND($$Table_locks_waited / ($$Table_locks_immediate + $$Table_locks_waited) * 100, 2) as lock_wait_ratio
FROM dual;
```

> âš ï¸ **æ€§èƒ½æç¤º**ï¼šå¦‚æœlock_wait_ratio > 5%ï¼Œè¯´æ˜è¡¨é”äº‰ç”¨ä¸¥é‡ï¼Œè€ƒè™‘ä¼˜åŒ–æŸ¥è¯¢æˆ–æ”¹ç”¨InnoDB

### 13.4 Memoryå­˜å‚¨å¼•æ“ç›‘æ§


**Memoryå¼•æ“è¡¨ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹Memoryå¼•æ“è¡¨ä¿¡æ¯
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  ENGINE,
  TABLE_ROWS,
  AVG_ROW_LENGTH,
  DATA_LENGTH/1024/1024 as data_size_mb,
  MAX_DATA_LENGTH/1024/1024 as max_data_size_mb
FROM information_schema.TABLES
WHERE ENGINE = 'MEMORY'
  AND TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema');
```

### 13.5 å­˜å‚¨å¼•æ“æ€§èƒ½å¯¹æ¯”


**ä¸åŒå¼•æ“çš„æ€§èƒ½ç‰¹ç‚¹**ï¼š

| å­˜å‚¨å¼•æ“ | äº‹åŠ¡æ”¯æŒ | è¡Œçº§é” | å¤–é”® | å…¨æ–‡ç´¢å¼• | é€‚ç”¨åœºæ™¯ |
|---------|---------|-------|------|---------|---------|
| **InnoDB** | âœ… | âœ… | âœ… | âœ…(5.6+) | OLTPäº‹åŠ¡å¤„ç† |
| **MyISAM** | âŒ | âŒ | âŒ | âœ… | è¯»å¤šå†™å°‘åœºæ™¯ |
| **Memory** | âŒ | âŒ | âŒ | âŒ | ä¸´æ—¶æ•°æ®ç¼“å­˜ |
| **Archive** | âŒ | âŒ | âŒ | âŒ | å½’æ¡£å†å²æ•°æ® |

**å¼•æ“é€‰æ‹©ç›‘æ§**ï¼š

```sql
-- æŸ¥çœ‹æ•°æ®åº“ä¸­å„å¼•æ“çš„ä½¿ç”¨æƒ…å†µ
SELECT 
  ENGINE,
  COUNT(*) as table_count,
  ROUND(SUM(DATA_LENGTH)/1024/1024, 2) as total_data_mb,
  ROUND(AVG(DATA_LENGTH)/1024/1024, 2) as avg_table_size_mb
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'information_schema', 'sys')
  AND TABLE_TYPE = 'BASE TABLE'
GROUP BY ENGINE
ORDER BY table_count DESC;
```

---

## 14. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 14.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


```
ğŸ”¸ è¿æ¥ç›‘æ§ï¼šè¿æ¥æ•°ã€è¿æ¥é”™è¯¯ã€è¿æ¥è´¨é‡
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šQPS/TPSã€æ…¢æŸ¥è¯¢ã€æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ
ğŸ”¸ èµ„æºç›‘æ§ï¼šç¼“å†²æ± å‘½ä¸­ç‡ã€ä¸´æ—¶è¡¨ä½¿ç”¨ã€é”ç­‰å¾…
ğŸ”¸ å­˜å‚¨ç›‘æ§ï¼šè¡¨ç©ºé—´ç¢ç‰‡åŒ–ã€ç´¢å¼•ä½¿ç”¨æ•ˆç‡
ğŸ”¸ é”™è¯¯ç›‘æ§ï¼šé”™è¯¯ä»£ç åˆ†ç±»ã€æ­»é”ã€æƒé™é”™è¯¯
ğŸ”¸ å¼•æ“ç›‘æ§ï¼šInnoDBäº‹åŠ¡çŠ¶æ€ã€è¡Œæ“ä½œç»Ÿè®¡
```

### 14.2 ç›‘æ§ä½“ç³»å»ºè®¾è¦ç‚¹


**ğŸ”¹ ç›‘æ§å±‚æ¬¡è®¾è®¡**ï¼š
```
åˆ†å±‚ç›‘æ§æ€è·¯ï¼š
â€¢ ä¸šåŠ¡å±‚ â†’ å…³æ³¨ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡æŒ‡æ ‡
â€¢ åº”ç”¨å±‚ â†’ å…³æ³¨è¿æ¥æ± å’ŒSQLæ‰§è¡Œæ•ˆæœ  
â€¢ MySQLå±‚ â†’ å…³æ³¨æ•°æ®åº“å†…éƒ¨æ€§èƒ½æŒ‡æ ‡
â€¢ ç³»ç»Ÿå±‚ â†’ å…³æ³¨ç¡¬ä»¶èµ„æºä½¿ç”¨æƒ…å†µ

æ¯å±‚éƒ½æœ‰ä¸åŒçš„å‘Šè­¦é˜ˆå€¼å’Œå¤„ç†æ–¹å¼
```

**ğŸ”¹ å…³é”®é˜ˆå€¼è®¾ç½®**ï¼š
```
æ€§èƒ½é˜ˆå€¼å»ºè®®ï¼š
â€¢ ç¼“å†²æ± å‘½ä¸­ç‡ï¼š> 95%
â€¢ æ…¢æŸ¥è¯¢æ¯”ä¾‹ï¼š< 5%
â€¢ è¿æ¥ä½¿ç”¨ç‡ï¼š< 80%
â€¢ ç£ç›˜ä¸´æ—¶è¡¨æ¯”ä¾‹ï¼š< 25%
â€¢ é”ç­‰å¾…æ—¶é—´ï¼š< 10ç§’
â€¢ è¡¨ç¢ç‰‡åŒ–ç‡ï¼š< 20%
```

**ğŸ”¹ ç›‘æ§å·¥å…·é€‰æ‹©**ï¼š
```
ç›‘æ§å·¥å…·æ¨èï¼š
â€¢ Prometheus + Grafanaï¼šå¼€æºç›‘æ§æ–¹æ¡ˆ
â€¢ Zabbixï¼šä¼ä¸šçº§ç›‘æ§å¹³å°
â€¢ Percona Monitoringï¼šä¸“ä¸šMySQLç›‘æ§
â€¢ MySQL Enterprise Monitorï¼šå®˜æ–¹ç›‘æ§å·¥å…·
â€¢ è‡ªç ”è„šæœ¬ï¼šå®šåˆ¶åŒ–ç›‘æ§éœ€æ±‚
```

### 14.3 æ•…éšœæ’æŸ¥æ€è·¯


**ğŸ¯ æ€§èƒ½é—®é¢˜æ’æŸ¥æµç¨‹**ï¼š
```
é—®é¢˜æ’æŸ¥æ­¥éª¤ï¼š

1. ç¡®è®¤ç—‡çŠ¶
   â†“
2. æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
   â†“  
3. åˆ†æMySQLçŠ¶æ€ï¼ˆè¿æ¥ã€é”ã€ç¼“å†²æ± ï¼‰
   â†“
4. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
   â†“
5. æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
   â†“
6. åˆ†ææ‰§è¡Œè®¡åˆ’
   â†“
7. åˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ
```

**ğŸš¨ å¸¸è§é—®é¢˜å®šä½**ï¼š
```
å…¸å‹é—®é¢˜ç—‡çŠ¶å’Œæ’æŸ¥æ–¹å‘ï¼š

å“åº”ç¼“æ…¢ï¼š
â†’ æ£€æŸ¥æ…¢æŸ¥è¯¢ã€é”ç­‰å¾…ã€ç¼“å†²æ± å‘½ä¸­ç‡

è¿æ¥å¤±è´¥ï¼š  
â†’ æ£€æŸ¥è¿æ¥æ•°é™åˆ¶ã€ç½‘ç»œçŠ¶å†µã€æƒé™è®¾ç½®

æ­»é”é¢‘å‘ï¼š
â†’ åˆ†æäº‹åŠ¡é¡ºåºã€ç´¢å¼•è®¾è®¡ã€ä¸šåŠ¡é€»è¾‘

ç©ºé—´ä¸è¶³ï¼š
â†’ æ£€æŸ¥è¡¨ç¢ç‰‡åŒ–ã€æ—¥å¿—æ–‡ä»¶å¤§å°ã€ä¸´æ—¶è¡¨ä½¿ç”¨
```

### 14.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ ç›‘æ§å®æ–½å»ºè®®**ï¼š
- **æ¸è¿›éƒ¨ç½²**ï¼šä»æ ¸å¿ƒæŒ‡æ ‡å¼€å§‹ï¼Œé€æ­¥å®Œå–„ç›‘æ§ä½“ç³»
- **å‘Šè­¦åˆ†çº§**ï¼šP0/P1/P2çº§åˆ«å‘Šè­¦ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
- **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šå¸¸è§é—®é¢˜è‡ªåŠ¨ä¿®å¤ï¼Œå‡å°‘äººå·¥å¹²é¢„
- **å®šæœŸå›é¡¾**ï¼šæ ¹æ®ä¸šåŠ¡å˜åŒ–è°ƒæ•´ç›‘æ§æŒ‡æ ‡å’Œé˜ˆå€¼

**ğŸ“Š ç›‘æ§æ•°æ®ä»·å€¼**ï¼š
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›è¡ŒSQLå’Œé…ç½®ä¼˜åŒ–
- **å®¹é‡è§„åˆ’**ï¼šé¢„æµ‹èµ„æºéœ€æ±‚ï¼Œæå‰æ‰©å®¹
- **æ•…éšœé¢„é˜²**ï¼šæå‰å‘ç°æ½œåœ¨é—®é¢˜ï¼Œé¿å…ä¸šåŠ¡ä¸­æ–­
- **æˆæœ¬æ§åˆ¶**ï¼šä¼˜åŒ–èµ„æºä½¿ç”¨ï¼Œé™ä½è¿ç»´æˆæœ¬

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- MySQLç›‘æ§æ˜¯ä¿éšœä¸šåŠ¡ç¨³å®šçš„é‡è¦æ‰‹æ®µ
- åˆ†å±‚ç›‘æ§ä½“ç³»ï¼Œæ¯å±‚å…³æ³¨ç‚¹ä¸åŒ
- é‡ç‚¹å…³æ³¨è¿æ¥ã€æ€§èƒ½ã€èµ„æºã€é”™è¯¯å››å¤§ç±»æŒ‡æ ‡
- ç›‘æ§æ•°æ®è¦è½¬åŒ–ä¸ºå®é™…çš„ä¼˜åŒ–è¡ŒåŠ¨
- å·¥å…·æ˜¯æ‰‹æ®µï¼Œç†è§£åŸç†æ›´é‡è¦