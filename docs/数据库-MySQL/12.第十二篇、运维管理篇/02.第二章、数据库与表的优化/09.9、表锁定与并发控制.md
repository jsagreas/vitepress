---
title: 9ã€è¡¨é”å®šä¸å¹¶å‘æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [è¡¨é”åŸºç¡€æ¦‚å¿µ](#1-è¡¨é”åŸºç¡€æ¦‚å¿µ)
2. [è¡¨é”ç±»å‹è¯†åˆ«](#2-è¡¨é”ç±»å‹è¯†åˆ«)
3. [é”ç­‰å¾…ç›‘æ§åˆ†æ](#3-é”ç­‰å¾…ç›‘æ§åˆ†æ)
4. [å…ƒæ•°æ®é”MDLç®¡ç†](#4-å…ƒæ•°æ®é”MDLç®¡ç†)
5. [è¡¨é”è¶…æ—¶å¤„ç†](#5-è¡¨é”è¶…æ—¶å¤„ç†)
6. [å¹¶å‘DMLæ§åˆ¶](#6-å¹¶å‘DMLæ§åˆ¶)
7. [é”å†²çªè§£å†³æ–¹æ¡ˆ](#7-é”å†²çªè§£å†³æ–¹æ¡ˆ)
8. [è¡¨é”æ€§èƒ½å½±å“](#8-è¡¨é”æ€§èƒ½å½±å“)
9. [é”å®šçŠ¶æ€æŸ¥è¯¢](#9-é”å®šçŠ¶æ€æŸ¥è¯¢)
10. [è¡¨é”äº‰ç”¨è¯Šæ–­æ–¹æ³•](#10-è¡¨é”äº‰ç”¨è¯Šæ–­æ–¹æ¡ˆ)
11. [è¡¨é”ä¼˜åŒ–ç­–ç•¥](#11-è¡¨é”ä¼˜åŒ–ç­–ç•¥)
12. [è¡¨é”ç›‘æ§å‘Šè­¦](#12-è¡¨é”ç›‘æ§å‘Šè­¦)
13. [è¡¨é”æ•…éšœåº”æ€¥å¤„ç†](#13-è¡¨é”æ•…éšœåº”æ€¥å¤„ç†)
14. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#14-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ è¡¨é”åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¡¨é”


**è¡¨é”**æ˜¯æ•°æ®åº“ç”¨æ¥**æ§åˆ¶å¹¶å‘è®¿é—®**çš„ä¸€ç§æœºåˆ¶ï¼Œå°±åƒç”Ÿæ´»ä¸­çš„é—¨é”ä¸€æ ·ã€‚

```
ç”Ÿæ´»ä¸­çš„é—¨é”ï¼š                    æ•°æ®åº“ä¸­çš„è¡¨é”ï¼š
    æˆ¿é—´é—¨                         æ•°æ®è¡¨
     |                             |
   ğŸ”’é”                          è¡¨é”æœºåˆ¶
     |                             |
  é˜²æ­¢å†²çª                      é˜²æ­¢æ•°æ®å†²çª
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªå›¾ä¹¦é¦†çš„é˜…è§ˆå®¤ï¼Œå½“æœ‰äººåœ¨æ•´ç†ä¹¦æ¶æ—¶ï¼Œå°±éœ€è¦"é”å®š"è¿™ä¸ªåŒºåŸŸï¼Œå…¶ä»–äººè¦ç­‰å¾…æ•´ç†å®Œæˆæ‰èƒ½è¿›å…¥ã€‚è¡¨é”å°±æ˜¯è¿™æ ·çš„æœºåˆ¶ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¡¨é”


**æ ¸å¿ƒä½œç”¨**ï¼š
- **ä¿è¯æ•°æ®ä¸€è‡´æ€§** - é˜²æ­¢å¤šä¸ªæ“ä½œåŒæ—¶ä¿®æ”¹é€ æˆæ•°æ®æ··ä¹±
- **æ§åˆ¶è®¿é—®é¡ºåº** - è®©æ•°æ®åº“æ“ä½œæœ‰åºè¿›è¡Œ
- **é¿å…è„è¯»å†™** - ç¡®ä¿è¯»åˆ°çš„æ˜¯å®Œæ•´æ­£ç¡®çš„æ•°æ®

```
æ²¡æœ‰é”çš„æƒ…å†µï¼š
ç”¨æˆ·A: æ­£åœ¨ä¿®æ”¹è®¢å•é‡‘é¢...
ç”¨æˆ·B: åŒæ—¶è¯»å–è®¢å•é‡‘é¢    â† å¯èƒ½è¯»åˆ°ä¸€åŠä¿®æ”¹çš„é”™è¯¯æ•°æ®
ç”¨æˆ·C: ä¹Ÿåœ¨ä¿®æ”¹è®¢å•é‡‘é¢    â† æ•°æ®å†²çªï¼

æœ‰é”çš„æƒ…å†µï¼š
ç”¨æˆ·A: è·å¾—é”ï¼Œä¿®æ”¹è®¢å•é‡‘é¢
ç”¨æˆ·B: ç­‰å¾…é”é‡Šæ”¾...
ç”¨æˆ·C: ç­‰å¾…é”é‡Šæ”¾...
ç”¨æˆ·A: ä¿®æ”¹å®Œæˆï¼Œé‡Šæ”¾é”
ç”¨æˆ·B: è·å¾—é”ï¼Œå¼€å§‹æ“ä½œ
```

### 1.3 è¡¨é”çš„åŸºæœ¬åŸç†


**å·¥ä½œæœºåˆ¶**ï¼š
```
è¯·æ±‚é” â†’ æ£€æŸ¥å†²çª â†’ è·å¾—é”/ç­‰å¾… â†’ æ‰§è¡Œæ“ä½œ â†’ é‡Šæ”¾é”
```

> ğŸ“– **æ¦‚å¿µè§£é‡Š**ï¼š
> - **é”æŒæœ‰è€…**ï¼šå½“å‰æ­£åœ¨ä½¿ç”¨è¡¨çš„è¿æ¥/äº‹åŠ¡
> - **é”ç­‰å¾…è€…**ï¼šæ’é˜Ÿç­‰å¾…è·å–é”çš„å…¶ä»–è¿æ¥
> - **é”ç²’åº¦**ï¼šé”å®šçš„èŒƒå›´å¤§å°ï¼ˆè¡¨çº§ã€è¡Œçº§ç­‰ï¼‰

---

## 2. ğŸ·ï¸ è¡¨é”ç±»å‹è¯†åˆ«


### 2.1 è¯»é”ï¼ˆå…±äº«é”ï¼‰


**ä»€ä¹ˆæ˜¯è¯»é”**ï¼šå¤šä¸ªç”¨æˆ·å¯ä»¥**åŒæ—¶è¯»å–**æ•°æ®ï¼Œä½†**ä¸èƒ½ä¿®æ”¹**ã€‚

```sql
-- æ‰‹åŠ¨åŠ è¯»é”
LOCK TABLES orders READ;
SELECT * FROM orders WHERE id = 100;
UNLOCK TABLES;
```

**ç‰¹ç‚¹**ï¼š
- âœ… **å¤šä¸ªè¯»æ“ä½œ**å¯ä»¥å¹¶è¡Œ
- âŒ **å†™æ“ä½œ**å¿…é¡»ç­‰å¾…
- ğŸ”„ **è¯»é”ä¹‹é—´**ä¸å†²çª

```
è¯»é”ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®è¡¨    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·A è¯» âœ…  â”‚
â”‚ ç”¨æˆ·B è¯» âœ…  â”‚  
â”‚ ç”¨æˆ·C è¯» âœ…  â”‚
â”‚ ç”¨æˆ·D å†™ âŒ  â”‚ â† ç­‰å¾…ä¸­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å†™é”ï¼ˆæ’ä»–é”ï¼‰


**ä»€ä¹ˆæ˜¯å†™é”**ï¼šåªæœ‰**ä¸€ä¸ªç”¨æˆ·**å¯ä»¥æ“ä½œï¼Œå…¶ä»–æ‰€æœ‰æ“ä½œéƒ½è¦ç­‰å¾…ã€‚

```sql
-- æ‰‹åŠ¨åŠ å†™é”
LOCK TABLES orders WRITE;
UPDATE orders SET amount = 1000 WHERE id = 100;
UNLOCK TABLES;
```

**ç‰¹ç‚¹**ï¼š
- âŒ **å…¶ä»–æ‰€æœ‰æ“ä½œ**éƒ½è¢«é˜»å¡
- ğŸ”’ **ç‹¬å è®¿é—®**æ•°æ®è¡¨
- âš¡ **æ“ä½œå®Œæˆ**ç«‹å³é‡Šæ”¾

```
å†™é”ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®è¡¨    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·A å†™ âœ…  â”‚ â† ç‹¬å ä½¿ç”¨
â”‚ ç”¨æˆ·B è¯» âŒ  â”‚ â† ç­‰å¾…ä¸­
â”‚ ç”¨æˆ·C å†™ âŒ  â”‚ â† ç­‰å¾…ä¸­
â”‚ ç”¨æˆ·D è¯» âŒ  â”‚ â† ç­‰å¾…ä¸­
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 é”å…¼å®¹æ€§çŸ©é˜µ


| å½“å‰é”\è¯·æ±‚é” | **READ** | **WRITE** |
|--------------|----------|-----------|
| **READ** | âœ… å…¼å®¹ | âŒ å†²çª |
| **WRITE** | âŒ å†²çª | âŒ å†²çª |
| **æ— é”** | âœ… å¯è·å¾— | âœ… å¯è·å¾— |

> âš ï¸ **é‡è¦æé†’**ï¼šåªæœ‰è¯»é”ä¸è¯»é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œå…¶ä»–æƒ…å†µéƒ½ä¼šäº§ç”Ÿå†²çªç­‰å¾…ã€‚

### 2.4 è‡ªåŠ¨é”ä¸æ‰‹åŠ¨é”


**è‡ªåŠ¨é”**ï¼ˆæ›´å¸¸è§ï¼‰ï¼š
```sql
-- è¿™äº›æ“ä½œä¼šè‡ªåŠ¨åŠ é”
SELECT * FROM orders;           -- è‡ªåŠ¨åŠ è¯»é”
UPDATE orders SET amount = 100; -- è‡ªåŠ¨åŠ å†™é”
DELETE FROM orders WHERE id=1;  -- è‡ªåŠ¨åŠ å†™é”
```

**æ‰‹åŠ¨é”**ï¼ˆç‰¹æ®Šéœ€æ±‚ï¼‰ï¼š
```sql
-- æ˜¾å¼åŠ é”
LOCK TABLES orders READ, users WRITE;
-- æ‰§è¡Œå¤šä¸ªæ“ä½œ...
UNLOCK TABLES;
```

---

## 3. ğŸ“Š é”ç­‰å¾…ç›‘æ§åˆ†æ


### 3.1 æŸ¥çœ‹å½“å‰é”çŠ¶æ€


**åŸºç¡€æŸ¥è¯¢**ï¼š
```sql
-- æŸ¥çœ‹è¡¨é”çŠ¶æ€
SHOW OPEN TABLES WHERE In_use > 0;

-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SHOW PROCESSLIST;
```

**è¯¦ç»†è¾“å‡ºè§£é‡Š**ï¼š
```
+----------+--------+-----------+------+---------+------+-------+------------------+
| Database | Table  | In_use    | Name_locked                                    |
+----------+--------+-----------+------+---------+------+-------+------------------+
| shop     | orders | 1         | 0                                              |
```

> ğŸ“ **å­—æ®µå«ä¹‰**ï¼š
> - `In_use`: å½“å‰ä½¿ç”¨è¡¨çš„è¿æ¥æ•°
> - `Name_locked`: è¡¨åæ˜¯å¦è¢«é”å®š

### 3.2 Performance Schemaç›‘æ§


**æŸ¥çœ‹é”ç­‰å¾…è¯¦æƒ…**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…
SELECT 
    object_schema,
    object_name,
    lock_type,
    lock_duration,
    lock_status
FROM performance_schema.metadata_locks 
WHERE object_type = 'TABLE';
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
+---------------+-------------+-----------+---------------+-------------+
| object_schema | object_name | lock_type | lock_duration | lock_status |
+---------------+-------------+-----------+---------------+-------------+
| shop          | orders      | SHARED_READ| TRANSACTION  | GRANTED     |
| shop          | orders      | EXCLUSIVE | TRANSACTION   | PENDING     |
+---------------+-------------+-----------+---------------+-------------+
```

### 3.3 é”ç­‰å¾…æ—¶é—´åˆ†æ


**æŸ¥çœ‹ç­‰å¾…æ—¶é—´**ï¼š
```sql
-- æŸ¥çœ‹é•¿æ—¶é—´ç­‰å¾…çš„é”
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread,
    b.trx_query blocking_query
FROM information_schema.innodb_lock_waits w
INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;
```

> ğŸ”§ **å®è·µæŠ€å·§**ï¼šå®šæœŸç›‘æ§é”ç­‰å¾…æ—¶é—´ï¼Œè¶…è¿‡30ç§’çš„ç­‰å¾…é€šå¸¸éœ€è¦äººå·¥å¹²é¢„ã€‚

---

## 4. ğŸ” å…ƒæ•°æ®é”MDLç®¡ç†


### 4.1 ä»€ä¹ˆæ˜¯å…ƒæ•°æ®é”


**å…ƒæ•°æ®é”ï¼ˆMDLï¼‰**æ˜¯MySQLä¿æŠ¤**è¡¨ç»“æ„**çš„ç‰¹æ®Šé”æœºåˆ¶ã€‚

> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šå°±åƒè£…ä¿®æˆ¿å­æ—¶ï¼Œä¸èƒ½è®©äººéšæ„æ”¹å˜æˆ¿é—´ç»“æ„ä¸€æ ·ï¼ŒMDLç¡®ä¿åœ¨æ“ä½œæ•°æ®æ—¶ï¼Œè¡¨ç»“æ„ä¸ä¼šè¢«æ„å¤–ä¿®æ”¹ã€‚

```
è¡¨ç»“æ„å˜æ›´æ“ä½œï¼š
ALTER TABLE orders ADD COLUMN ...  â† éœ€è¦ç‹¬å MDLé”
DROP TABLE orders                  â† éœ€è¦ç‹¬å MDLé”

æ•°æ®æ“ä½œï¼š
SELECT, INSERT, UPDATE, DELETE     â† éœ€è¦å…±äº«MDLé”
```

### 4.2 MDLé”çš„ç±»å‹


**å…±äº«MDLé”**ï¼š
- **è°ä½¿ç”¨**ï¼šæ™®é€šçš„DMLæ“ä½œï¼ˆINSERTã€UPDATEã€DELETEã€SELECTï¼‰
- **ä½œç”¨**ï¼šå…è®¸å¤šä¸ªæ•°æ®æ“ä½œåŒæ—¶è¿›è¡Œ
- **é™åˆ¶**ï¼šé˜»æ­¢è¡¨ç»“æ„å˜æ›´

**ç‹¬å MDLé”**ï¼š
- **è°ä½¿ç”¨**ï¼šDDLæ“ä½œï¼ˆALTER TABLEã€DROP TABLEç­‰ï¼‰
- **ä½œç”¨**ï¼šç‹¬å è®¿é—®ï¼Œä¿®æ”¹è¡¨ç»“æ„
- **é™åˆ¶**ï¼šé˜»æ­¢æ‰€æœ‰å…¶ä»–æ“ä½œ

### 4.3 MDLé”å†²çªåœºæ™¯


**å¸¸è§å†²çª**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: BEGIN; SELECT * FROM orders; -- è·å¾—å…±äº«MDLé”
T2: ALTER TABLE orders ADD COLUMN price DECIMAL(10,2); -- ç­‰å¾…ç‹¬å MDLé”
T3: SELECT * FROM orders; -- ç­‰å¾…ï¼ˆè¢«T2é˜»å¡ï¼‰
T4: INSERT INTO orders VALUES (...); -- ç­‰å¾…ï¼ˆè¢«T2é˜»å¡ï¼‰
```

```
MDLé”å†²çªç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ordersè¡¨               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T1: SELECT (å…±äº«MDL) âœ…         â”‚
â”‚ T2: ALTER TABLE (ç‹¬å MDL) â³    â”‚ â† ç­‰å¾…T1ç»“æŸ
â”‚ T3: SELECT (å…±äº«MDL) â³         â”‚ â† è¢«T2é˜»å¡
â”‚ T4: INSERT (å…±äº«MDL) â³         â”‚ â† è¢«T2é˜»å¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 MDLé”ç®¡ç†ç­–ç•¥


**é¿å…é•¿æ—¶é—´MDLé”**ï¼š
```sql
-- âŒ é¿å…ï¼šé•¿äº‹åŠ¡ä¸­çš„è¡¨æ“ä½œ
BEGIN;
SELECT * FROM orders WHERE create_time > '2025-01-01'; -- å¯èƒ½å¾ˆæ…¢
-- ... å…¶ä»–ä¸šåŠ¡é€»è¾‘
COMMIT; -- MDLé”æŒç»­æ•´ä¸ªäº‹åŠ¡æœŸé—´

-- âœ… æ¨èï¼šç¼©çŸ­äº‹åŠ¡æ—¶é—´
BEGIN;
SELECT * FROM orders WHERE id = 123; -- å¿«é€ŸæŸ¥è¯¢
COMMIT; -- å¿«é€Ÿé‡Šæ”¾MDLé”
```

---

## 5. â° è¡¨é”è¶…æ—¶å¤„ç†


### 5.1 é”è¶…æ—¶å‚æ•°é…ç½®


**å…³é”®å‚æ•°**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰è¶…æ—¶è®¾ç½®
SHOW VARIABLES LIKE '%timeout%';

-- é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
SET SESSION lock_wait_timeout = 50;

-- å…ƒæ•°æ®é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰  
SET SESSION lock_wait_timeout = 31536000;
```

**å‚æ•°è¯´æ˜**ï¼š
- `lock_wait_timeout`: **æ™®é€šé”**ç­‰å¾…è¶…æ—¶æ—¶é—´
- `innodb_lock_wait_timeout`: **InnoDBè¡Œé”**ç­‰å¾…è¶…æ—¶æ—¶é—´

### 5.2 è¶…æ—¶å¤„ç†ç­–ç•¥


**åº”ç”¨å±‚å¤„ç†**ï¼š
```python
import pymysql
import time

def safe_table_operation():
    conn = pymysql.connect(...)
    try:
        cursor = conn.cursor()
        # è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
        cursor.execute("SET SESSION lock_wait_timeout = 10")
        
        # æ‰§è¡Œå¯èƒ½å†²çªçš„æ“ä½œ
        cursor.execute("SELECT * FROM orders WHERE id = %s", (order_id,))
        result = cursor.fetchall()
        
        conn.commit()
        return result
        
    except pymysql.err.OperationalError as e:
        if "Lock wait timeout" in str(e):
            print("è¡¨é”ç­‰å¾…è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
            return None
        raise e
    finally:
        conn.close()
```

### 5.3 è¶…æ—¶é—®é¢˜è¯Šæ–­


**è¯Šæ–­æ­¥éª¤**ï¼š
```sql
-- 1. æŸ¥çœ‹è¶…æ—¶è®¾ç½®
SHOW VARIABLES LIKE '%timeout%';

-- 2. æŸ¥çœ‹å½“å‰é”ç­‰å¾…
SHOW PROCESSLIST;

-- 3. åˆ†æé”å†²çªåŸå› 
SELECT * FROM information_schema.innodb_trx 
WHERE trx_state = 'LOCK WAIT';
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
> - è¶…æ—¶æ—¶é—´è®¾ç½®è¦åˆç†ï¼Œå¤ªçŸ­å½±å“æ­£å¸¸æ“ä½œï¼Œå¤ªé•¿å½±å“ç³»ç»Ÿå“åº”
> - ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®10-30ç§’çš„é”ç­‰å¾…è¶…æ—¶

---

## 6. ğŸ”„ å¹¶å‘DMLæ§åˆ¶


### 6.1 ä»€ä¹ˆæ˜¯å¹¶å‘DML


**DMLæ“ä½œ**åŒ…æ‹¬ï¼š
- `INSERT` - æ’å…¥æ•°æ®
- `UPDATE` - æ›´æ–°æ•°æ®  
- `DELETE` - åˆ é™¤æ•°æ®
- `SELECT` - æŸ¥è¯¢æ•°æ®

**å¹¶å‘é—®é¢˜**ï¼šå¤šä¸ªDMLæ“ä½œåŒæ—¶æ‰§è¡Œå¯èƒ½äº§ç”Ÿï¼š
- **æ•°æ®ä¸ä¸€è‡´**
- **æ­»é”**
- **æ€§èƒ½ä¸‹é™**

### 6.2 å¹¶å‘æ§åˆ¶æœºåˆ¶


**äº‹åŠ¡éš”ç¦»çº§åˆ«**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SELECT $$tx_isolation;

-- è®¾ç½®éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

**éš”ç¦»çº§åˆ«å¯¹æ¯”**ï¼š
| éš”ç¦»çº§åˆ« | **è„è¯»** | **ä¸å¯é‡å¤è¯»** | **å¹»è¯»** | **å¹¶å‘æ€§èƒ½** |
|---------|---------|---------------|---------|-------------|
| READ UNCOMMITTED | âŒ å¯èƒ½ | âŒ å¯èƒ½ | âŒ å¯èƒ½ | ğŸš€ æœ€é«˜ |
| READ COMMITTED | âœ… é¿å… | âŒ å¯èƒ½ | âŒ å¯èƒ½ | ğŸƒ è¾ƒé«˜ |
| REPEATABLE READ | âœ… é¿å… | âœ… é¿å… | âŒ å¯èƒ½ | ğŸš¶ ä¸­ç­‰ |
| SERIALIZABLE | âœ… é¿å… | âœ… é¿å… | âœ… é¿å… | ğŸŒ æœ€ä½ |

### 6.3 æ§åˆ¶å¹¶å‘çš„æœ€ä½³å®è·µ


**1. ä½¿ç”¨åˆé€‚çš„äº‹åŠ¡å¤§å°**ï¼š
```sql
-- âŒ é¿å…ï¼šå¤§äº‹åŠ¡
BEGIN;
UPDATE orders SET status = 'paid' WHERE create_time < '2025-01-01'; -- å¯èƒ½å½±å“å‡ ä¸‡æ¡
-- ... å…¶ä»–æ“ä½œ
COMMIT;

-- âœ… æ¨èï¼šå°æ‰¹é‡å¤„ç†
DELIMITER $$
CREATE PROCEDURE batch_update_orders()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE batch_size INT DEFAULT 1000;
    
    REPEAT
        BEGIN
            UPDATE orders SET status = 'paid' 
            WHERE create_time < '2025-01-01' 
            AND status != 'paid'
            LIMIT batch_size;
            
            COMMIT;
        END;
        
        SET done = (ROW_COUNT() < batch_size);
    UNTIL done END REPEAT;
END$$
```

**2. ä¼˜åŒ–é”é¡ºåº**ï¼š
```sql
-- âŒ é¿å…ï¼šä¸åŒé¡ºåºå¯èƒ½æ­»é”
-- è¿æ¥A
UPDATE orders SET amount = 100 WHERE id = 1;
UPDATE users SET balance = 500 WHERE id = 2;

-- è¿æ¥B  
UPDATE users SET balance = 600 WHERE id = 2;  -- å¯èƒ½æ­»é”
UPDATE orders SET amount = 200 WHERE id = 1;

-- âœ… æ¨èï¼šç»Ÿä¸€é”é¡ºåº
-- éƒ½æŒ‰ç…§ orders -> users çš„é¡ºåº
UPDATE orders SET amount = 100 WHERE id = 1;
UPDATE users SET balance = 500 WHERE id = 2;
```

---

## 7. ğŸ› ï¸ é”å†²çªè§£å†³æ–¹æ¡ˆ


### 7.1 è¯†åˆ«é”å†²çª


**å¿«é€Ÿè¯Šæ–­**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰æ‰€æœ‰è¿›ç¨‹
SHOW FULL PROCESSLIST;

-- æŸ¥çœ‹é”ç­‰å¾…é“¾
SELECT 
    waiting_pid,
    waiting_query,
    blocking_pid,
    blocking_query,
    wait_age_secs
FROM sys.innodb_lock_waits;
```

**è¾“å‡ºè§£è¯»**ï¼š
```
+-------------+------------------------+-------------+------------------------+--------------+
| waiting_pid | waiting_query          | blocking_pid| blocking_query         | wait_age_secs|
+-------------+------------------------+-------------+------------------------+--------------+
| 123         | UPDATE orders SET...   | 456         | SELECT * FROM orders   | 45           |
+-------------+------------------------+-------------+------------------------+--------------+
```

### 7.2 æ‰‹åŠ¨è§£å†³é”å†²çª


**ç»ˆæ­¢é˜»å¡è¿›ç¨‹**ï¼š
```sql
-- æŸ¥çœ‹è¿›ç¨‹è¯¦æƒ…
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    info
FROM information_schema.processlist 
WHERE id = 456;

-- ç»ˆæ­¢é˜»å¡çš„è¿›ç¨‹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
KILL 456;
```

> âš ï¸ **è­¦å‘Š**ï¼šKILLå‘½ä»¤ä¼šå¼ºåˆ¶ç»ˆæ­¢è¿æ¥ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œä½¿ç”¨å‰è¦ç¡®è®¤å½±å“èŒƒå›´ã€‚

### 7.3 é¢„é˜²é”å†²çª


**è®¾è®¡å±‚é¢é¢„é˜²**ï¼š
```sql
-- 1. ä½¿ç”¨ç´¢å¼•å‡å°‘é”èŒƒå›´
-- âŒ å…¨è¡¨æ‰«æé”å®šæ›´å¤šè¡Œ
UPDATE orders SET status = 'paid' WHERE amount > 1000;

-- âœ… åŸºäºç´¢å¼•çš„ç²¾ç¡®æ›´æ–°  
UPDATE orders SET status = 'paid' WHERE id IN (1,2,3,4,5);

-- 2. æ‹†åˆ†å¤§äº‹åŠ¡
-- âŒ é•¿æ—¶é—´æŒæœ‰é”
BEGIN;
UPDATE orders SET status = 'shipped' WHERE create_time < '2025-01-01';
UPDATE inventory SET stock = stock - 1 WHERE product_id IN (...);
COMMIT;

-- âœ… åˆ†åˆ«å¤„ç†
BEGIN;
UPDATE orders SET status = 'shipped' WHERE id = 123;
COMMIT;

BEGIN;  
UPDATE inventory SET stock = stock - 1 WHERE product_id = 456;
COMMIT;
```

---

## 8. ğŸ“‰ è¡¨é”æ€§èƒ½å½±å“


### 8.1 æ€§èƒ½å½±å“åˆ†æ


**é”å¯¹æ€§èƒ½çš„å½±å“**ï¼š
```
æ— é”ç«äº‰ï¼š                    æœ‰é”ç«äº‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚ â†’ æ‰§è¡Œ  â”‚              â”‚ è¯·æ±‚ â†’ ç­‰å¾…  â”‚
â”‚   1ms       â”‚              â”‚   100ms     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â†’ æ‰§è¡Œ 1ms  â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”**ï¼š
| åœºæ™¯ | **å“åº”æ—¶é—´** | **ååé‡** | **CPUä½¿ç”¨ç‡** |
|------|-------------|-----------|--------------|
| **æ— é”ç«äº‰** | 1-5ms | 1000 TPS | 60% |
| **è½»åº¦ç«äº‰** | 10-50ms | 500 TPS | 40% |
| **é‡åº¦ç«äº‰** | 100ms+ | 100 TPS | 20% |

### 8.2 é”ç²’åº¦çš„æ€§èƒ½å·®å¼‚


**è¡¨é” vs è¡Œé”**ï¼š
```sql
-- è¡¨é”ï¼šå½±å“æ•´ä¸ªè¡¨
LOCK TABLES orders WRITE;
UPDATE orders SET amount = 100 WHERE id = 123;
UNLOCK TABLES;

-- è¡Œé”ï¼šåªå½±å“ç›¸å…³è¡Œ
BEGIN;
UPDATE orders SET amount = 100 WHERE id = 123; -- åªé”å®šid=123çš„è¡Œ
COMMIT;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
è¡¨é”å½±å“èŒƒå›´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ordersè¡¨    â”‚ â† æ•´ä¸ªè¡¨è¢«é”å®š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id=1   è¢«é˜»å¡    â”‚
â”‚ id=2   è¢«é˜»å¡    â”‚
â”‚ id=3   è¢«é˜»å¡    â”‚
â”‚ ...             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¡Œé”å½±å“èŒƒå›´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ordersè¡¨    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id=1   æ­£å¸¸è®¿é—®   â”‚
â”‚ id=2   æ­£å¸¸è®¿é—®   â”‚
â”‚ id=3   ğŸ”’è¢«é”å®š   â”‚
â”‚ ...    æ­£å¸¸è®¿é—®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å‡å°‘é”æŒæœ‰æ—¶é—´**ï¼š
```python
# âŒ é¿å…ï¼šåœ¨é”å†…æ‰§è¡Œè€—æ—¶æ“ä½œ
def bad_example():
    conn.execute("BEGIN")
    conn.execute("UPDATE orders SET status='processing' WHERE id=%s", order_id)
    
    # è€—æ—¶çš„å¤–éƒ¨APIè°ƒç”¨
    response = requests.post("http://payment-api.com/process", data=order_data)
    time.sleep(2)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    
    conn.execute("UPDATE orders SET status='paid' WHERE id=%s", order_id)  
    conn.execute("COMMIT")

# âœ… æ¨èï¼šå…ˆå®Œæˆå¤–éƒ¨æ“ä½œï¼Œå†æ›´æ–°æ•°æ®åº“
def good_example():
    # å…ˆå¤„ç†å¤–éƒ¨æ“ä½œ
    response = requests.post("http://payment-api.com/process", data=order_data)
    
    # å¿«é€Ÿæ›´æ–°æ•°æ®åº“
    conn.execute("BEGIN")
    conn.execute("UPDATE orders SET status='paid' WHERE id=%s", order_id)
    conn.execute("COMMIT")
```

---

## 9. ğŸ” é”å®šçŠ¶æ€æŸ¥è¯¢


### 9.1 åŸºç¡€æŸ¥è¯¢å‘½ä»¤


**æŸ¥çœ‹è¡¨é”çŠ¶æ€**ï¼š
```sql
-- æ˜¾ç¤ºæ‰€æœ‰æ‰“å¼€çš„è¡¨
SHOW OPEN TABLES;

-- åªæ˜¾ç¤ºæ­£åœ¨ä½¿ç”¨çš„è¡¨
SHOW OPEN TABLES WHERE In_use > 0;

-- æŸ¥çœ‹è¡¨é”ç»Ÿè®¡
SHOW STATUS LIKE 'Table_locks%';
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
+----------------------------+-------+
| Variable_name              | Value |
+----------------------------+-------+
| Table_locks_immediate      | 1151552 |  â† ç«‹å³è·å¾—é”çš„æ¬¡æ•°
| Table_locks_waited         | 15324   |  â† éœ€è¦ç­‰å¾…é”çš„æ¬¡æ•°  
+----------------------------+-------+
```

### 9.2 è¯¦ç»†é”ä¿¡æ¯æŸ¥è¯¢


**ä½¿ç”¨Performance Schema**ï¼š
```sql
-- æŸ¥çœ‹å…ƒæ•°æ®é”è¯¦æƒ…
SELECT 
    object_schema AS 'æ•°æ®åº“',
    object_name AS 'è¡¨å',
    lock_type AS 'é”ç±»å‹',
    lock_duration AS 'é”æŒç»­æœŸ',
    lock_status AS 'é”çŠ¶æ€',
    source AS 'æ¥æº'
FROM performance_schema.metadata_locks 
WHERE object_type = 'TABLE'
ORDER BY object_schema, object_name;
```

**æŸ¥çœ‹é”ç­‰å¾…å†å²**ï¼š
```sql
-- æŸ¥çœ‹æœ€è¿‘çš„é”ç­‰å¾…äº‹ä»¶
SELECT 
    thread_id,
    event_name,
    object_schema,
    object_name,
    operation,
    number_of_bytes,
    timer_wait/1000000000 AS wait_time_ms
FROM performance_schema.events_waits_history_long 
WHERE event_name LIKE '%lock%'
ORDER BY timer_start DESC 
LIMIT 10;
```

### 9.3 å®æ—¶ç›‘æ§è„šæœ¬


**Pythonç›‘æ§è„šæœ¬**ï¼š
```python
import pymysql
import time
import json

def monitor_table_locks():
    """å®æ—¶ç›‘æ§è¡¨é”çŠ¶æ€"""
    conn = pymysql.connect(
        host='localhost',
        user='monitor_user', 
        password='password',
        database='information_schema'
    )
    
    while True:
        try:
            cursor = conn.cursor(pymysql.cursors.DictCursor)
            
            # æŸ¥è¯¢é”ç­‰å¾…æƒ…å†µ
            cursor.execute("""
                SELECT 
                    object_schema,
                    object_name,
                    lock_type,
                    lock_status,
                    COUNT(*) as lock_count
                FROM performance_schema.metadata_locks 
                WHERE object_type = 'TABLE'
                GROUP BY object_schema, object_name, lock_type, lock_status
            """)
            
            locks = cursor.fetchall()
            
            if locks:
                print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] å‘ç°è¡¨é”:")
                for lock in locks:
                    print(f"  {lock['object_schema']}.{lock['object_name']}: "
                          f"{lock['lock_type']} ({lock['lock_status']}) x{lock['lock_count']}")
            
            time.sleep(5)  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            
        except Exception as e:
            print(f"ç›‘æ§å‡ºé”™: {e}")
            time.sleep(10)

if __name__ == "__main__":
    monitor_table_locks()
```

---

## 10. ğŸ”§ è¡¨é”äº‰ç”¨è¯Šæ–­æ–¹æ³•


### 10.1 äº‰ç”¨è¯†åˆ«æ­¥éª¤


**è¯Šæ–­æµç¨‹**ï¼š
```
ç¬¬1æ­¥ï¼šå‘ç°é—®é¢˜ç—‡çŠ¶
    â†“
ç¬¬2æ­¥ï¼šæ”¶é›†é”çŠ¶æ€ä¿¡æ¯  
    â†“
ç¬¬3æ­¥ï¼šåˆ†æé”ç­‰å¾…é“¾
    â†“  
ç¬¬4æ­¥ï¼šå®šä½æ ¹æœ¬åŸå› 
    â†“
ç¬¬5æ­¥ï¼šåˆ¶å®šè§£å†³æ–¹æ¡ˆ
```

### 10.2 ç—‡çŠ¶è¯†åˆ«


**å¸¸è§ç—‡çŠ¶**ï¼š
- **åº”ç”¨å“åº”ç¼“æ…¢** - è¯·æ±‚å¤„ç†æ—¶é—´å¼‚å¸¸å¢é•¿
- **æ•°æ®åº“è¿æ¥å †ç§¯** - è¿æ¥æ± è€—å°½
- **CPUä½¿ç”¨ç‡å¼‚å¸¸** - è¿‡é«˜æˆ–è¿‡ä½éƒ½å¯èƒ½æ˜¯é”é—®é¢˜

**å¿«é€Ÿæ£€æŸ¥**ï¼š
```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SHOW PROCESSLIST;

-- æ£€æŸ¥é”ç­‰å¾…æ—¶é—´
SELECT 
    COUNT(*) as waiting_queries,
    AVG(time) as avg_wait_seconds
FROM information_schema.processlist 
WHERE state LIKE '%lock%';
```

### 10.3 æ·±åº¦è¯Šæ–­åˆ†æ


**åˆ†æé”ä¾èµ–å…³ç³»**ï¼š
```sql
-- æŸ¥çœ‹å®Œæ•´çš„é”ç­‰å¾…é“¾
WITH RECURSIVE lock_chain AS (
  -- æ‰¾åˆ°æ‰€æœ‰ç­‰å¾…çš„äº‹åŠ¡
  SELECT 
    requesting_trx_id,
    blocking_trx_id,
    1 as level
  FROM information_schema.innodb_lock_waits
  
  UNION ALL
  
  -- é€’å½’æŸ¥æ‰¾é˜»å¡é“¾
  SELECT 
    lw.requesting_trx_id,
    lw.blocking_trx_id, 
    lc.level + 1
  FROM information_schema.innodb_lock_waits lw
  JOIN lock_chain lc ON lw.requesting_trx_id = lc.blocking_trx_id
  WHERE lc.level < 10  -- é˜²æ­¢æ— é™é€’å½’
)
SELECT * FROM lock_chain ORDER BY level, requesting_trx_id;
```

### 10.4 è¯Šæ–­å·¥å…·è„šæœ¬


**ä¸€é”®è¯Šæ–­è„šæœ¬**ï¼š
```bash
#!/bin/bash
# table_lock_diagnosis.sh

echo "=== è¡¨é”äº‰ç”¨è¯Šæ–­æŠ¥å‘Š ==="
echo "æ—¶é—´: $(date)"
echo

# 1. æ£€æŸ¥å½“å‰è¿›ç¨‹
echo "1. å½“å‰æ•°æ®åº“è¿›ç¨‹:"
mysql -e "SHOW PROCESSLIST;" | head -20

echo -e "\n2. è¡¨é”ç»Ÿè®¡:"
mysql -e "SHOW STATUS LIKE 'Table_locks%';"

echo -e "\n3. å½“å‰é”ç­‰å¾…:"
mysql -e "
SELECT 
    r.trx_id as waiting_trx,
    r.trx_mysql_thread_id as waiting_thread,
    SUBSTRING(r.trx_query, 1, 100) as waiting_query,
    b.trx_id as blocking_trx,
    b.trx_mysql_thread_id as blocking_thread,
    SUBSTRING(b.trx_query, 1, 100) as blocking_query
FROM information_schema.innodb_lock_waits w
JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id  
JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id;
"

echo -e "\n4. å…ƒæ•°æ®é”çŠ¶æ€:"
mysql -e "
SELECT 
    object_schema,
    object_name,
    lock_type,
    lock_status,
    COUNT(*) as count
FROM performance_schema.metadata_locks 
WHERE object_type = 'TABLE'
GROUP BY object_schema, object_name, lock_type, lock_status;
"

echo -e "\n=== è¯Šæ–­å®Œæˆ ==="
```

---

## 11. âš¡ è¡¨é”ä¼˜åŒ–ç­–ç•¥


### 11.1 åº”ç”¨å±‚ä¼˜åŒ–


**ä¼˜åŒ–äº‹åŠ¡è®¾è®¡**ï¼š
```python
# âŒ ä¸å¥½çš„åšæ³•ï¼šé•¿äº‹åŠ¡
def bad_order_process():
    conn.execute("BEGIN")
    
    # éªŒè¯åº“å­˜ï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
    check_inventory()
    
    # å¤–éƒ¨æ”¯ä»˜è°ƒç”¨ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰
    payment_result = call_payment_api()
    
    # å‘é€é‚®ä»¶ï¼ˆå¯èƒ½å¤±è´¥é‡è¯•ï¼‰
    send_notification_email()
    
    # æ›´æ–°è®¢å•çŠ¶æ€
    conn.execute("UPDATE orders SET status='completed'")
    conn.execute("COMMIT")

# âœ… å¥½çš„åšæ³•ï¼šæ‹†åˆ†äº‹åŠ¡  
def good_order_process():
    # 1. å…ˆåšå¤–éƒ¨æ“ä½œ
    check_inventory()
    payment_result = call_payment_api()
    
    # 2. å¿«é€Ÿæ•°æ®åº“äº‹åŠ¡
    conn.execute("BEGIN")
    conn.execute("UPDATE orders SET status='completed', payment_id=%s", payment_result.id)
    conn.execute("COMMIT")
    
    # 3. å¼‚æ­¥å¤„ç†é‚®ä»¶
    async_send_email.delay(order_id)
```

### 11.2 æ•°æ®åº“å±‚ä¼˜åŒ–


**é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“**ï¼š
```sql
-- MyISAM: è¡¨çº§é”ï¼Œè¯»å¤šå†™å°‘çš„åœºæ™¯
CREATE TABLE logs (
    id INT PRIMARY KEY,
    message TEXT,
    created_at TIMESTAMP
) ENGINE=MyISAM;

-- InnoDB: è¡Œçº§é”ï¼Œé«˜å¹¶å‘è¯»å†™åœºæ™¯  
CREATE TABLE orders (
    id INT PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10,2),
    status VARCHAR(20)
) ENGINE=InnoDB;
```

**ç´¢å¼•ä¼˜åŒ–å‡å°‘é”èŒƒå›´**ï¼š
```sql
-- âŒ æ²¡æœ‰ç´¢å¼•ï¼šå…¨è¡¨æ‰«æï¼Œé”å®šå¤§é‡è¡Œ
UPDATE orders SET status = 'shipped' 
WHERE create_time > '2025-01-01' AND amount > 100;

-- âœ… æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_orders_time_amount ON orders(create_time, amount);

-- ç°åœ¨æ›´æ–°åªé”å®šå¿…è¦çš„è¡Œ
UPDATE orders SET status = 'shipped' 
WHERE create_time > '2025-01-01' AND amount > 100;
```

### 11.3 æ¶æ„å±‚ä¼˜åŒ–


**è¯»å†™åˆ†ç¦»**ï¼š
```python
class DatabaseRouter:
    def __init__(self):
        self.read_db = connect_to_slave()
        self.write_db = connect_to_master()
    
    def select(self, query):
        # è¯»æ“ä½œä½¿ç”¨ä»åº“
        return self.read_db.execute(query)
    
    def insert_update_delete(self, query):
        # å†™æ“ä½œä½¿ç”¨ä¸»åº“
        return self.write_db.execute(query)

# ä½¿ç”¨ç¤ºä¾‹
router = DatabaseRouter()

# è¯»æ“ä½œä¸ä¼šå’Œå†™æ“ä½œäº§ç”Ÿé”å†²çª
orders = router.select("SELECT * FROM orders WHERE user_id = 123")

# å†™æ“ä½œåªåœ¨ä¸»åº“è¿›è¡Œ
router.insert_update_delete("UPDATE orders SET status = 'paid' WHERE id = 456")
```

**åˆ†åº“åˆ†è¡¨**ï¼š
```sql
-- æŒ‰ç”¨æˆ·IDåˆ†è¡¨ï¼Œå‡å°‘å•è¡¨é”ç«äº‰
CREATE TABLE orders_001 (...);  -- user_id % 10 = 1
CREATE TABLE orders_002 (...);  -- user_id % 10 = 2
...
CREATE TABLE orders_010 (...);  -- user_id % 10 = 0
```

---

## 12. ğŸ“¡ è¡¨é”ç›‘æ§å‘Šè­¦


### 12.1 ç›‘æ§æŒ‡æ ‡è®¾ç½®


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```sql
-- é”ç­‰å¾…æ¯”ç‡
SELECT 
    Variable_value/(SELECT Variable_value FROM information_schema.global_status WHERE Variable_name = 'Table_locks_immediate') * 100 AS lock_wait_ratio
FROM information_schema.global_status 
WHERE Variable_name = 'Table_locks_waited';

-- å¹³å‡é”ç­‰å¾…æ—¶é—´
SELECT AVG(time) as avg_lock_wait_seconds
FROM information_schema.processlist 
WHERE state LIKE '%lock%';
```

**å‘Šè­¦é˜ˆå€¼å»ºè®®**ï¼š
| æŒ‡æ ‡ | **æ­£å¸¸** | **è­¦å‘Š** | **ä¸¥é‡** |
|------|---------|---------|---------|
| **é”ç­‰å¾…æ¯”ç‡** | < 5% | 5-15% | > 15% |
| **é”ç­‰å¾…æ—¶é—´** | < 1s | 1-10s | > 10s |
| **ç­‰å¾…æŸ¥è¯¢æ•°é‡** | < 10 | 10-50 | > 50 |

### 12.2 ç›‘æ§è„šæœ¬


**Zabbixç›‘æ§æ¨¡æ¿**ï¼š
```bash
#!/bin/bash
# mysql_lock_monitor.sh

case $1 in
    "lock_wait_ratio")
        mysql -e "
        SELECT ROUND(
            (SELECT Variable_value FROM information_schema.global_status WHERE Variable_name = 'Table_locks_waited') /
            (SELECT Variable_value FROM information_schema.global_status WHERE Variable_name = 'Table_locks_immediate') * 100, 2
        ) as lock_wait_ratio;" | tail -1
        ;;
    "waiting_queries")
        mysql -e "SELECT COUNT(*) FROM information_schema.processlist WHERE state LIKE '%lock%';" | tail -1
        ;;
    "avg_wait_time")
        mysql -e "SELECT IFNULL(AVG(time), 0) FROM information_schema.processlist WHERE state LIKE '%lock%';" | tail -1
        ;;
esac
```

### 12.3 å‘Šè­¦é€šçŸ¥


**é’‰é’‰å‘Šè­¦è„šæœ¬**ï¼š
```python
import requests
import json
import pymysql

def send_dingtalk_alert(message):
    """å‘é€é’‰é’‰å‘Šè­¦"""
    webhook = "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
    
    data = {
        "msgtype": "text",
        "text": {
            "content": f"ğŸš¨ æ•°æ®åº“é”å‘Šè­¦\n{message}"
        }
    }
    
    requests.post(webhook, json=data)

def check_lock_status():
    """æ£€æŸ¥é”çŠ¶æ€å¹¶å‘Šè­¦"""
    conn = pymysql.connect(...)
    cursor = conn.cursor()
    
    # æ£€æŸ¥é”ç­‰å¾…æ¯”ç‡
    cursor.execute("""
        SELECT 
            (SELECT Variable_value FROM information_schema.global_status WHERE Variable_name = 'Table_locks_waited') /
            (SELECT Variable_value FROM information_schema.global_status WHERE Variable_name = 'Table_locks_immediate') * 100 
        as lock_wait_ratio
    """)
    
    ratio = cursor.fetchone()[0]
    
    if ratio > 15:  # ä¸¥é‡å‘Šè­¦
        send_dingtalk_alert(f"è¡¨é”ç­‰å¾…æ¯”ç‡è¿‡é«˜: {ratio:.2f}%")
    elif ratio > 5:  # è­¦å‘Š
        send_dingtalk_alert(f"è¡¨é”ç­‰å¾…æ¯”ç‡è¾ƒé«˜: {ratio:.2f}%")

if __name__ == "__main__":
    check_lock_status()
```

---

## 13. ğŸš‘ è¡¨é”æ•…éšœåº”æ€¥å¤„ç†


### 13.1 åº”æ€¥å¤„ç†æµç¨‹


**æ•…éšœå“åº”æ­¥éª¤**ï¼š
```
æ¥æ”¶å‘Šè­¦ â†’ å¿«é€Ÿè¯„ä¼° â†’ å®šä½é—®é¢˜ â†’ æ‰§è¡Œå¤„ç† â†’ éªŒè¯æ¢å¤ â†’ äº‹ååˆ†æ
```

### 13.2 å¸¸è§æ•…éšœåœºæ™¯


**åœºæ™¯1ï¼šDDLæ“ä½œé˜»å¡æ‰€æœ‰æŸ¥è¯¢**
```sql
-- é—®é¢˜ï¼šALTER TABLEæ­£åœ¨æ‰§è¡Œï¼Œé˜»å¡æ‰€æœ‰æŸ¥è¯¢
-- æ’æŸ¥ï¼š
SHOW PROCESSLIST;
-- çœ‹åˆ°å¤§é‡ "Waiting for table metadata lock" çŠ¶æ€

-- è§£å†³ï¼š
-- 1. æ‰¾åˆ°DDLæ“ä½œçš„è¿›ç¨‹ID
-- 2. è¯„ä¼°æ˜¯å¦å¯ä»¥KILL
-- 3. å¦‚æœå®‰å…¨ï¼Œç»ˆæ­¢DDLæ“ä½œ
KILL 1234; -- DDLè¿›ç¨‹ID
```

**åœºæ™¯2ï¼šé•¿äº‹åŠ¡æŒæœ‰é”ä¸é‡Šæ”¾**
```sql
-- é—®é¢˜ï¼šæŸä¸ªè¿æ¥å¼€å¯äº‹åŠ¡åå¿˜è®°æäº¤
-- æ’æŸ¥ï¼š
SELECT 
    trx_id,
    trx_mysql_thread_id,
    trx_started,
    trx_query
FROM information_schema.innodb_trx 
WHERE trx_started < DATE_SUB(NOW(), INTERVAL 30 MINUTE);

-- è§£å†³ï¼š
-- 1. è”ç³»åº”ç”¨å¼€å‘è€…ç¡®è®¤
-- 2. å¦‚æœç¡®è®¤å¯ä»¥å›æ»šï¼Œç»ˆæ­¢é•¿äº‹åŠ¡
KILL 5678; -- é•¿äº‹åŠ¡è¿›ç¨‹ID
```

### 13.3 åº”æ€¥å¤„ç†å·¥å…·


**ä¸€é”®è§£é”è„šæœ¬**ï¼š
```bash
#!/bin/bash
# emergency_unlock.sh

echo "ç´§æ€¥è¡¨é”å¤„ç†å·¥å…·"
echo "=================="

# æ˜¾ç¤ºå½“å‰é”çŠ¶æ€
echo "1. å½“å‰é”ç­‰å¾…æƒ…å†µï¼š"
mysql -e "
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    LEFT(info, 50) as query_start
FROM information_schema.processlist 
WHERE state LIKE '%lock%' OR state LIKE '%Waiting%'
ORDER BY time DESC;
"

# æ˜¾ç¤ºé•¿äº‹åŠ¡
echo -e "\n2. é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ï¼š"
mysql -e "
SELECT 
    trx_id,
    trx_mysql_thread_id as thread_id,
    trx_started,
    TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration_seconds,
    LEFT(trx_query, 100) as query_start
FROM information_schema.innodb_trx 
WHERE trx_started < DATE_SUB(NOW(), INTERVAL 5 MINUTE)
ORDER BY duration_seconds DESC;
"

# æä¾›æ“ä½œå»ºè®®
echo -e "\n3. å»ºè®®æ“ä½œï¼š"
echo "- æ£€æŸ¥æ˜¯å¦æœ‰DDLæ“ä½œå¯ä»¥æš‚åœ"
echo "- è”ç³»åº”ç”¨å¼€å‘è€…ç¡®è®¤é•¿äº‹åŠ¡çŠ¶æ€" 
echo "- å¿…è¦æ—¶ä½¿ç”¨ KILL å‘½ä»¤ç»ˆæ­¢é˜»å¡è¿›ç¨‹"
echo "- è®°å½•æ•…éšœè¯¦æƒ…ç”¨äºäº‹ååˆ†æ"
```

### 13.4 é¢„é˜²æªæ–½


**ç›‘æ§é¢„è­¦**ï¼š
```python
def setup_preventive_monitoring():
    """è®¾ç½®é¢„é˜²æ€§ç›‘æ§"""
    
    # 1. é•¿äº‹åŠ¡æ£€æµ‹
    def check_long_transactions():
        # æ£€æŸ¥è¶…è¿‡5åˆ†é’Ÿçš„äº‹åŠ¡
        query = """
        SELECT COUNT(*) 
        FROM information_schema.innodb_trx 
        WHERE trx_started < DATE_SUB(NOW(), INTERVAL 5 MINUTE)
        """
        # å‘é€é¢„è­¦...
    
    # 2. é”ç­‰å¾…ç§¯å‹æ£€æµ‹  
    def check_lock_backlog():
        # æ£€æŸ¥é”ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
        query = """
        SELECT COUNT(*) 
        FROM information_schema.processlist 
        WHERE state LIKE '%lock%'
        """
        # è¶…è¿‡é˜ˆå€¼å‘é€é¢„è­¦...
    
    # 3. DDLæ“ä½œé€šçŸ¥
    def notify_ddl_operations():
        # æ£€æµ‹æ­£åœ¨æ‰§è¡Œçš„DDL
        query = """
        SELECT * 
        FROM information_schema.processlist 
        WHERE info LIKE 'ALTER%' OR info LIKE 'CREATE%' OR info LIKE 'DROP%'
        """
        # é€šçŸ¥ç›¸å…³äººå‘˜...
```

---

## 14. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 14.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¡¨é”æœ¬è´¨ï¼šæ•°æ®åº“å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ é”ç±»å‹ï¼šè¯»é”ï¼ˆå…±äº«ï¼‰å…è®¸å¹¶å‘è¯»ï¼Œå†™é”ï¼ˆæ’ä»–ï¼‰ç‹¬å è®¿é—®
ğŸ”¸ MDLé”ï¼šä¿æŠ¤è¡¨ç»“æ„çš„å…ƒæ•°æ®é”ï¼ŒDDLä¸DMLäº’æ–¥
ğŸ”¸ é”å†²çªï¼šä¸åŒç±»å‹é”ä¹‹é—´çš„å…¼å®¹æ€§å†³å®šäº†ç­‰å¾…å…³ç³»
ğŸ”¸ æ€§èƒ½å½±å“ï¼šé”äº‰ç”¨ç›´æ¥å½±å“ç³»ç»Ÿå¹¶å‘æ€§èƒ½å’Œå“åº”æ—¶é—´
```

### 14.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¡¨é”çš„åŒé¢æ€§**
```
ä¼˜ç‚¹ï¼š
âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§
âœ… é¿å…å¹¶å‘å†²çª
âœ… ç®€åŒ–äº‹åŠ¡å¤„ç†

ç¼ºç‚¹ï¼š  
âŒ é™ä½å¹¶å‘æ€§èƒ½
âŒ å¯èƒ½äº§ç”Ÿæ­»é”
âŒ å½±å“ç”¨æˆ·ä½“éªŒ
```

**ğŸ”¹ é”ç²’åº¦çš„æƒè¡¡**
```
è¡¨é”ï¼š
- ç²’åº¦å¤§ï¼Œå¹¶å‘æ€§å·®
- å¼€é”€å°ï¼Œç®¡ç†ç®€å•
- é€‚åˆè¯»å¤šå†™å°‘åœºæ™¯

è¡Œé”ï¼š
- ç²’åº¦å°ï¼Œå¹¶å‘æ€§å¥½
- å¼€é”€å¤§ï¼Œç®¡ç†å¤æ‚  
- é€‚åˆé«˜å¹¶å‘åœºæ™¯
```

### 14.3 æœ€ä½³å®è·µæŒ‡å—


**è®¾è®¡åŸåˆ™**ï¼š
- **æœ€å°é”ç²’åº¦** - åªé”å®šå¿…è¦çš„æ•°æ®èŒƒå›´
- **æœ€çŸ­é”æ—¶é—´** - å°½å¿«å®Œæˆæ“ä½œå¹¶é‡Šæ”¾é”
- **é¿å…åµŒå¥—é”** - å‡å°‘æ­»é”å‘ç”Ÿæ¦‚ç‡
- **ç»Ÿä¸€é”é¡ºåº** - é˜²æ­¢å¾ªç¯ç­‰å¾…æ­»é”

**ç›‘æ§è¦ç‚¹**ï¼š
- **é”ç­‰å¾…æ¯”ç‡** - åæ˜ é”ç«äº‰æ¿€çƒˆç¨‹åº¦
- **å¹³å‡ç­‰å¾…æ—¶é—´** - è¡¡é‡æ€§èƒ½å½±å“
- **é•¿äº‹åŠ¡æ£€æµ‹** - é¢„é˜²é”èµ„æºå ç”¨
- **DDLæ“ä½œç›‘æ§** - é¿å…æ„å¤–çš„è¡¨é”

**åº”æ€¥å‡†å¤‡**ï¼š
- **å¿«é€Ÿè¯Šæ–­è„šæœ¬** - å¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
- **åº”æ€¥å¤„ç†é¢„æ¡ˆ** - æ ‡å‡†åŒ–å¤„ç†æµç¨‹
- **ç›‘æ§å‘Šè­¦æœºåˆ¶** - åŠæ—¶å‘ç°å¼‚å¸¸
- **æ•…éšœå¤ç›˜åˆ¶åº¦** - æŒç»­æ”¹è¿›ä¼˜åŒ–

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - è¡¨é”æ˜¯å¹¶å‘æ§åˆ¶çš„åŸºç¡€ï¼Œç†è§£é”æœºåˆ¶æ˜¯æ•°æ®åº“è¿ç»´çš„å¿…å¤‡æŠ€èƒ½
> - é¢„é˜²èƒœäºæ²»ç–—ï¼Œè‰¯å¥½çš„è®¾è®¡å’Œç›‘æ§å¯ä»¥é¿å…å¤§éƒ¨åˆ†é”é—®é¢˜
> - åº”æ€¥å¤„ç†è¦è°¨æ…ï¼ŒKILLæ“ä½œå‰è¦è¯„ä¼°å½±å“èŒƒå›´
> - æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆç›‘æ§æ•°æ®ä¸æ–­è°ƒä¼˜