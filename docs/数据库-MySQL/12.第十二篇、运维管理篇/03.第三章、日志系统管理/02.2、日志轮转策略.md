---
title: 2ã€æ—¥å¿—è½®è½¬ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—è½®è½¬åŸºç¡€æ¦‚å¿µ](#1-æ—¥å¿—è½®è½¬åŸºç¡€æ¦‚å¿µ)
2. [æ—¥å¿—è½®è½¬è§¦å‘æœºåˆ¶](#2-æ—¥å¿—è½®è½¬è§¦å‘æœºåˆ¶)
3. [MySQLå†…ç½®è½®è½¬é…ç½®](#3-MySQLå†…ç½®è½®è½¬é…ç½®)
4. [ç³»ç»Ÿçº§æ—¥å¿—è½®è½¬](#4-ç³»ç»Ÿçº§æ—¥å¿—è½®è½¬)
5. [æ—¥å¿—æ¸…ç†ä¸å½’æ¡£](#5-æ—¥å¿—æ¸…ç†ä¸å½’æ¡£)
6. [ç›‘æ§ä¸å‘Šè­¦ç­–ç•¥](#6-ç›‘æ§ä¸å‘Šè­¦ç­–ç•¥)
7. [æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶](#7-æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æ—¥å¿—è½®è½¬åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬


**æ—¥å¿—è½®è½¬ï¼ˆLog Rotationï¼‰** å°±åƒæ˜¯ç»™æ•°æ®åº“çš„"æ—¥è®°æœ¬"å®šæœŸæ¢æ–°ä¸€æ ·ã€‚

```
æƒ³è±¡ä¸€ä¸‹å†™æ—¥è®°ï¼š
ğŸ“” ç¬¬ä¸€æœ¬æ—¥è®°å†™æ»¡äº† â†’ æ¢ç¬¬äºŒæœ¬ç»§ç»­å†™
ğŸ“” ç¬¬äºŒæœ¬æ—¥è®°å†™æ»¡äº† â†’ æ¢ç¬¬ä¸‰æœ¬ç»§ç»­å†™
ğŸ—‘ï¸ è€æ—¥è®°å¤ªå¤šäº† â†’ æŠŠå¾ˆä¹…ä»¥å‰çš„æ‰”æ‰

MySQLæ—¥å¿—è½®è½¬ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼
```

**ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—è½®è½¬ï¼Ÿ**
- **é˜²æ­¢ç£ç›˜çˆ†æ»¡** - æ—¥å¿—æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸æ¸…ç†å°±ä¼šå¡æ»¡ç¡¬ç›˜
- **æé«˜æŸ¥è¯¢æ•ˆç‡** - å°æ–‡ä»¶æ¯”è¶…å¤§æ–‡ä»¶æŸ¥æ‰¾é€Ÿåº¦æ›´å¿«
- **ä¾¿äºå¤‡ä»½ç®¡ç†** - æŒ‰æ—¶é—´åˆ†å‰²çš„æ—¥å¿—æ›´å®¹æ˜“å¤‡ä»½å’Œæ¢å¤
- **æ»¡è¶³åˆè§„è¦æ±‚** - æ³•è§„å¯èƒ½è¦æ±‚æ—¥å¿—ä¿ç•™ç‰¹å®šæ—¶é—´

### 1.2 MySQLä¸»è¦æ—¥å¿—ç±»å‹


```
MySQLæ—¥å¿—å®¶æ—ï¼š
ğŸ“ binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰    â† ä¸»è¦è½®è½¬å¯¹è±¡
ğŸ“ error logï¼ˆé”™è¯¯æ—¥å¿—ï¼‰   â† éœ€è¦è½®è½¬
ğŸ“ slow logï¼ˆæ…¢æŸ¥è¯¢æ—¥å¿—ï¼‰  â† éœ€è¦è½®è½¬
ğŸ“ general logï¼ˆé€šç”¨æ—¥å¿—ï¼‰ â† å¾ˆå°‘ä½¿ç”¨
ğŸ“ relay logï¼ˆä¸­ç»§æ—¥å¿—ï¼‰   â† ä¸»ä»å¤åˆ¶ç”¨
```

### 1.3 æ—¥å¿—è½®è½¬çš„åŸºæœ¬æµç¨‹


```
æ—¥å¿—è½®è½¬æµç¨‹å›¾ï¼š

å½“å‰æ—¥å¿—æ–‡ä»¶
     â†“
[è¾¾åˆ°è½®è½¬æ¡ä»¶] â†’ åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶
     â†“              â†“
æ—§æ—¥å¿—æ–‡ä»¶ â† åˆ‡æ¢å†™å…¥ â†’ æ–°æ—¥å¿—æ–‡ä»¶
     â†“
[ä¿ç•™æœŸæ»¡] â†’ è‡ªåŠ¨åˆ é™¤
```

---

## 2. âš¡ æ—¥å¿—è½®è½¬è§¦å‘æœºåˆ¶


### 2.1 è½®è½¬è§¦å‘æ¡ä»¶è¯¦è§£


**æ—¥å¿—è½®è½¬ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ** å°±åƒé—¹é’Ÿå“äº†å°±è¦èµ·åºŠä¸€æ ·ï¼Œæœ‰å‡ ä¸ª"é—¹é’Ÿ"ä¼šè§¦å‘è½®è½¬ï¼š

| è§¦å‘æ¡ä»¶ | **è¯´æ˜** | **å…¸å‹åœºæ™¯** |
|---------|---------|-------------|
| **æ–‡ä»¶å¤§å°** | `å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾¾åˆ°æŒ‡å®šå¤§å°` | `binlogæ–‡ä»¶è¶…è¿‡1GB` |
| **æ—¶é—´é—´éš”** | `æŒ‰æ—¶é—´å‘¨æœŸè‡ªåŠ¨è½®è½¬` | `æ¯å¤©å‡Œæ™¨è½®è½¬ä¸€æ¬¡` |
| **æ–‡ä»¶æ•°é‡** | `æ—¥å¿—æ–‡ä»¶æ•°é‡è¾¾åˆ°ä¸Šé™` | `ä¿ç•™æœ€è¿‘7ä¸ªæ–‡ä»¶` |
| **æ‰‹åŠ¨è§¦å‘** | `ç®¡ç†å‘˜ä¸»åŠ¨æ‰§è¡Œè½®è½¬` | `ç»´æŠ¤å‰æ‰‹åŠ¨æ¸…ç†` |

### 2.2 æ–‡ä»¶å¤§å°è§¦å‘æœºåˆ¶


**max_binlog_sizeå‚æ•°**ï¼šè¿™æ˜¯æ§åˆ¶binlogæ–‡ä»¶å¤§å°çš„"æ°´ä½çº¿"

```sql
-- æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW VARIABLES LIKE 'max_binlog_size';

-- è®¾ç½®binlogæ–‡ä»¶æœ€å¤§1GBï¼ˆæ¨èå€¼ï¼‰
SET GLOBAL max_binlog_size = 1073741824;  -- 1GB = 1024*1024*1024

-- æ°¸ä¹…é…ç½®ï¼ˆå†™å…¥my.cnfï¼‰
[mysqld]
max_binlog_size = 1G
```

**å·¥ä½œåŸç†**ï¼š
```
å½“å‰binlogå†™å…¥è¿‡ç¨‹ï¼š
mysql-bin.000001 [å·²å†™å…¥950MB]
         â†“
ç»§ç»­å†™å…¥æ•°æ®...
         â†“
è¾¾åˆ°1GBé™åˆ¶ï¼
         â†“
è‡ªåŠ¨åˆ›å»ºï¼šmysql-bin.000002
æ—§æ–‡ä»¶ï¼šmysql-bin.000001ï¼ˆåœæ­¢å†™å…¥ï¼‰
æ–°æ–‡ä»¶ï¼šmysql-bin.000002ï¼ˆå¼€å§‹å†™å…¥ï¼‰
```

### 2.3 æ—¶é—´è§¦å‘æœºåˆ¶


**é‡å¯å’Œæ‰‹åŠ¨åˆ‡æ¢**ï¼š
```sql
-- æ‰‹åŠ¨è§¦å‘binlogè½®è½¬
FLUSH BINARY LOGS;

-- æŸ¥çœ‹å½“å‰binlogæ–‡ä»¶
SHOW MASTER STATUS;

-- æŸ¥çœ‹æ‰€æœ‰binlogæ–‡ä»¶
SHOW BINARY LOGS;
```

**å®é™…æ¡ˆä¾‹**ï¼š
```
è½®è½¬å‰ï¼š
mysql-bin.000003  [å½“å‰å†™å…¥æ–‡ä»¶]
mysql-bin.000002  [æ˜¨å¤©çš„æ–‡ä»¶]
mysql-bin.000001  [å‰å¤©çš„æ–‡ä»¶]

æ‰§è¡Œ FLUSH BINARY LOGS åï¼š
mysql-bin.000004  [æ–°çš„å½“å‰æ–‡ä»¶] â† å¼€å§‹å†™å…¥
mysql-bin.000003  [åˆšæ‰çš„æ–‡ä»¶]   â† åœæ­¢å†™å…¥
mysql-bin.000002  [æ˜¨å¤©çš„æ–‡ä»¶]
mysql-bin.000001  [å‰å¤©çš„æ–‡ä»¶]
```

---

## 3. ğŸ”§ MySQLå†…ç½®è½®è½¬é…ç½®


### 3.1 è¿‡æœŸæ—¶é—´é…ç½®


**expire_logs_daysï¼ˆMySQL 5.7åŠä¹‹å‰ï¼‰**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW VARIABLES LIKE 'expire_logs_days';

-- è®¾ç½®binlogä¿ç•™7å¤©
SET GLOBAL expire_logs_days = 7;

-- æ°¸ä¹…é…ç½®
[mysqld]
expire_logs_days = 7
```

**binlog_expire_logs_secondsï¼ˆMySQL 8.0æ¨èï¼‰**ï¼š
```sql
-- æ›´ç²¾ç¡®çš„ç§’çº§æ§åˆ¶
SHOW VARIABLES LIKE 'binlog_expire_logs_seconds';

-- è®¾ç½®ä¿ç•™7å¤©ï¼ˆ7*24*3600ç§’ï¼‰
SET GLOBAL binlog_expire_logs_seconds = 604800;

-- æ°¸ä¹…é…ç½®
[mysqld]
binlog_expire_logs_seconds = 604800  # 7å¤©
```

> **ğŸ’¡ ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨ç§’çº§é…ç½®ï¼Ÿ**
> - æ›´ç²¾ç¡®çš„æ§åˆ¶
> - å¯ä»¥è®¾ç½®å°æ—¶çº§åˆ«çš„ä¿ç•™æ—¶é—´
> - MySQL 8.0çš„æ ‡å‡†åšæ³•

### 3.2 è‡ªåŠ¨æ¸…ç†ç­–ç•¥é…ç½®


**å®Œæ•´çš„binlogç®¡ç†é…ç½®**ï¼š
```ini
[mysqld]
# binlogåŸºç¡€é…ç½®
log-bin = mysql-bin
server-id = 1

# æ–‡ä»¶å¤§å°æ§åˆ¶
max_binlog_size = 1G

# è‡ªåŠ¨æ¸…ç†é…ç½®
binlog_expire_logs_seconds = 604800  # 7å¤©è‡ªåŠ¨åˆ é™¤
max_binlog_files = 50               # æœ€å¤šä¿ç•™50ä¸ªæ–‡ä»¶

# æ€§èƒ½ä¼˜åŒ–
sync_binlog = 1                     # å®‰å…¨ä½†å½±å“æ€§èƒ½
binlog_cache_size = 1M              # ç¼“å­˜å¤§å°
```

### 3.3 æ‰‹åŠ¨æ¸…ç†å‘½ä»¤è¯¦è§£


**PURGEå‘½ä»¤çš„ä½¿ç”¨**ï¼š

```sql
-- 1. æŸ¥çœ‹æ‰€æœ‰binlogæ–‡ä»¶
SHOW BINARY LOGS;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 | 177       |
| mysql-bin.000002 | 156       |
| mysql-bin.000003 | 154       |
| mysql-bin.000004 | 1048      |
+------------------+-----------+

-- 2. åˆ é™¤æŒ‡å®šæ–‡ä»¶ä¹‹å‰çš„æ‰€æœ‰binlog
PURGE BINARY LOGS TO 'mysql-bin.000003';
-- ç»“æœï¼šåˆ é™¤000001å’Œ000002ï¼Œä¿ç•™000003åŠä¹‹å

-- 3. åˆ é™¤æŒ‡å®šæ—¶é—´ä¹‹å‰çš„binlog
PURGE BINARY LOGS BEFORE '2025-09-01 00:00:00';

-- 4. åˆ é™¤Nå¤©å‰çš„binlog
PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);
```

**âš ï¸ å®‰å…¨ä½¿ç”¨æ³¨æ„äº‹é¡¹**ï¼š
```sql
-- æ¸…ç†å‰æ£€æŸ¥ä¸»ä»åŒæ­¥çŠ¶æ€
SHOW SLAVE STATUS\G

-- ç¡®è®¤ä»åº“å·²ç»åº”ç”¨äº†è¦åˆ é™¤çš„binlog
-- åªæœ‰ç¡®è®¤å®‰å…¨æ‰èƒ½æ‰§è¡Œæ¸…ç†æ“ä½œ
```

---

## 4. ğŸ› ï¸ ç³»ç»Ÿçº§æ—¥å¿—è½®è½¬


### 4.1 logrotateå·¥å…·ä»‹ç»


**logrotate** æ˜¯Linuxç³»ç»Ÿçš„æ—¥å¿—è½®è½¬ç¥å™¨ï¼Œä¸“é—¨ç”¨æ¥ç®¡ç†å„ç§æ—¥å¿—æ–‡ä»¶ã€‚

```
logrotateçš„å·¥ä½œæ–¹å¼ï¼š
ğŸ“… å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼ˆé€šå¸¸åœ¨cronä¸­ï¼‰
ğŸ“‹ è¯»å–é…ç½®æ–‡ä»¶
ğŸ”„ æ‰§è¡Œè½®è½¬æ“ä½œ
ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸæ–‡ä»¶
```

### 4.2 MySQLé”™è¯¯æ—¥å¿—è½®è½¬é…ç½®


**åˆ›å»ºMySQLé”™è¯¯æ—¥å¿—è½®è½¬é…ç½®**ï¼š
```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
sudo vim /etc/logrotate.d/mysql-error

# é…ç½®å†…å®¹
/var/log/mysql/error.log {
    daily                    # æ¯å¤©è½®è½¬
    rotate 30               # ä¿ç•™30ä¸ªæ–‡ä»¶
    compress                # å‹ç¼©æ—§æ–‡ä»¶
    delaycompress          # å»¶è¿Ÿå‹ç¼©ï¼ˆç¬¬äºŒæ¬¡è½®è½¬æ—¶æ‰å‹ç¼©ï¼‰
    missingok              # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    notifempty             # ç©ºæ–‡ä»¶ä¸è½®è½¬
    create 640 mysql mysql  # åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™å’Œå±ä¸»
    postrotate             # è½®è½¬åæ‰§è¡Œçš„å‘½ä»¤
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

### 4.3 æ…¢æŸ¥è¯¢æ—¥å¿—è½®è½¬é…ç½®


```bash
# æ…¢æŸ¥è¯¢æ—¥å¿—è½®è½¬é…ç½®
sudo vim /etc/logrotate.d/mysql-slow

/var/log/mysql/slow.log {
    weekly                  # æ¯å‘¨è½®è½¬
    rotate 12              # ä¿ç•™12å‘¨çš„æ—¥å¿—
    compress
    delaycompress
    missingok
    notifempty
    create 640 mysql mysql
    postrotate
        # é€šçŸ¥MySQLé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        if [ -f /var/run/mysqld/mysqld.pid ]; then
            /usr/bin/mysqladmin flush-logs
        fi
    endscript
}
```

### 4.4 æ‰‹åŠ¨æµ‹è¯•logrotate


```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
sudo logrotate -d /etc/logrotate.d/mysql-error

# å¼ºåˆ¶æ‰§è¡Œè½®è½¬ï¼ˆæµ‹è¯•ç”¨ï¼‰
sudo logrotate -f /etc/logrotate.d/mysql-error

# æŸ¥çœ‹è½®è½¬çŠ¶æ€
sudo cat /var/lib/logrotate/status | grep mysql
```

---

## 5. ğŸ“ æ—¥å¿—æ¸…ç†ä¸å½’æ¡£


### 5.1 æ—¥å¿—å½’æ¡£ç­–ç•¥è®¾è®¡


**åˆ†å±‚å­˜å‚¨ç­–ç•¥**ï¼š
```
æ—¥å¿—ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

ğŸ”¥ çƒ­æ•°æ®ï¼ˆ0-7å¤©ï¼‰    â†’ æœ¬åœ°SSDå¿«é€Ÿè®¿é—®
â„ï¸  æ¸©æ•°æ®ï¼ˆ8-30å¤©ï¼‰   â†’ æœ¬åœ°æœºæ¢°ç¡¬ç›˜
ğŸ§Š å†·æ•°æ®ï¼ˆ31-365å¤©ï¼‰ â†’ å½’æ¡£åˆ°äº‘å­˜å‚¨
ğŸ—‘ï¸ è¿‡æœŸæ•°æ®ï¼ˆ>1å¹´ï¼‰   â†’ æ°¸ä¹…åˆ é™¤
```

### 5.2 è‡ªåŠ¨åŒ–å½’æ¡£è„šæœ¬


**binlogå½’æ¡£è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# mysql_binlog_archive.sh - MySQL binlogå½’æ¡£è„šæœ¬

# é…ç½®å‚æ•°
MYSQL_USER="backup_user"
MYSQL_PASS="backup_password"
BACKUP_DIR="/backup/mysql/binlog"
ARCHIVE_DIR="/archive/mysql/binlog"
KEEP_DAYS=7

# åˆ›å»ºç›®å½•
mkdir -p $BACKUP_DIR $ARCHIVE_DIR

# è·å–éœ€è¦å½’æ¡£çš„binlogåˆ—è¡¨
BINLOGS=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW BINARY LOGS;" | awk 'NR>1 {print $1}')

echo "å¼€å§‹å½’æ¡£binlogæ–‡ä»¶..."
for binlog in $BINLOGS; do
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¶…è¿‡ä¿ç•™æœŸ
    if [ $(find /var/lib/mysql/$binlog -mtime +$KEEP_DAYS 2>/dev/null | wc -l) -gt 0 ]; then
        echo "å½’æ¡£æ–‡ä»¶: $binlog"
        
        # å¤åˆ¶åˆ°å½’æ¡£ç›®å½•
        cp /var/lib/mysql/$binlog $ARCHIVE_DIR/
        
        # å‹ç¼©å½’æ¡£æ–‡ä»¶
        gzip $ARCHIVE_DIR/$binlog
        
        echo "æ–‡ä»¶ $binlog å·²å½’æ¡£å¹¶å‹ç¼©"
    fi
done

echo "binlogå½’æ¡£å®Œæˆ"
```

### 5.3 æ—¥å¿—å‹ç¼©ä¼˜åŒ–


**å‹ç¼©æ¯”è¾ƒä¸é€‰æ‹©**ï¼š
| å‹ç¼©å·¥å…· | **å‹ç¼©æ¯”** | **å‹ç¼©é€Ÿåº¦** | **è§£å‹é€Ÿåº¦** | **æ¨èåœºæ™¯** |
|---------|-----------|-------------|-------------|-------------|
| **gzip** | `ä¸­ç­‰(60-70%)` | `ä¸­ç­‰` | `å¿«` | `é€šç”¨åœºæ™¯` |
| **bzip2** | `é«˜(50-60%)` | `æ…¢` | `æ…¢` | `å­˜å‚¨ä¼˜å…ˆ` |
| **lz4** | `ä½(70-80%)` | `å¾ˆå¿«` | `å¾ˆå¿«` | `æ€§èƒ½ä¼˜å…ˆ` |
| **xz** | `å¾ˆé«˜(40-50%)` | `å¾ˆæ…¢` | `æ…¢` | `é•¿æœŸå½’æ¡£` |

**å®é™…å‹ç¼©ç¤ºä¾‹**ï¼š
```bash
# gzipå‹ç¼©ï¼ˆæ¨èæ—¥å¸¸ä½¿ç”¨ï¼‰
gzip mysql-bin.000001
# ç»“æœï¼šmysql-bin.000001.gz

# æŸ¥çœ‹å‹ç¼©æ•ˆæœ
ls -lh mysql-bin.000001*
# -rw-r----- 1 mysql mysql 256M 9æœˆ 8 14:30 mysql-bin.000001.gz
# åŸæ–‡ä»¶1GBï¼Œå‹ç¼©å256MBï¼Œå‹ç¼©æ¯”75%

# è§£å‹æŸ¥çœ‹
zcat mysql-bin.000001.gz | mysqlbinlog - | less
```

---

## 6. ğŸ“Š ç›‘æ§ä¸å‘Šè­¦ç­–ç•¥


### 6.1 æ—¥å¿—è½®è½¬ç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```sql
-- 1. å½“å‰binlogæ–‡ä»¶å¤§å°
SELECT 
    file_name,
    ROUND(file_size/1024/1024, 2) AS size_mb
FROM information_schema.FILES 
WHERE file_name LIKE '%binlog%';

-- 2. binlogæ–‡ä»¶æ€»æ•°
SHOW BINARY LOGS;

-- 3. ç£ç›˜ä½¿ç”¨æƒ…å†µ
SELECT 
    SUM(file_size)/1024/1024/1024 AS total_binlog_gb
FROM information_schema.FILES 
WHERE file_name LIKE '%binlog%';
```

### 6.2 å‘Šè­¦é˜ˆå€¼è®¾ç½®


**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š
```yaml
# Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹
groups:
- name: mysql_binlog_alerts
  rules:
  - alert: BinlogDiskUsageHigh
    expr: mysql_binlog_disk_usage_percent > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "MySQL binlogç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜"
      description: "binlogç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ°{{ $value }}%"

  - alert: BinlogFileCountHigh
    expr: mysql_binlog_file_count > 100
    for: 10m
    labels:
      severity: critical
    annotations:
      summary: "MySQL binlogæ–‡ä»¶æ•°é‡è¿‡å¤š"
      description: "å½“å‰binlogæ–‡ä»¶æ•°é‡: {{ $value }}"
```

### 6.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬


```bash
#!/bin/bash
# binlog_monitor.sh - binlogç›‘æ§è„šæœ¬

# é…ç½®
MYSQL_USER="monitor"
MYSQL_PASS="monitor_pass"
THRESHOLD_GB=50      # ç£ç›˜ä½¿ç”¨é˜ˆå€¼(GB)
THRESHOLD_COUNT=50   # æ–‡ä»¶æ•°é‡é˜ˆå€¼
ALERT_EMAIL="admin@company.com"

# æ£€æŸ¥binlogç£ç›˜ä½¿ç”¨
BINLOG_SIZE=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -e "
SELECT ROUND(SUM(file_size)/1024/1024/1024, 2) 
FROM information_schema.FILES 
WHERE file_name LIKE '%binlog%';" -s)

# æ£€æŸ¥binlogæ–‡ä»¶æ•°é‡
BINLOG_COUNT=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW BINARY LOGS;" | wc -l)

# ç£ç›˜ä½¿ç”¨å‘Šè­¦
if (( $(echo "$BINLOG_SIZE > $THRESHOLD_GB" | bc -l) )); then
    echo "å‘Šè­¦: binlogç£ç›˜ä½¿ç”¨ ${BINLOG_SIZE}GB è¶…è¿‡é˜ˆå€¼ ${THRESHOLD_GB}GB" | \
    mail -s "MySQL binlogç£ç›˜å‘Šè­¦" $ALERT_EMAIL
fi

# æ–‡ä»¶æ•°é‡å‘Šè­¦
if [ $BINLOG_COUNT -gt $THRESHOLD_COUNT ]; then
    echo "å‘Šè­¦: binlogæ–‡ä»¶æ•°é‡ $BINLOG_COUNT è¶…è¿‡é˜ˆå€¼ $THRESHOLD_COUNT" | \
    mail -s "MySQL binlogæ•°é‡å‘Šè­¦" $ALERT_EMAIL
fi
```

---

## 7. ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶


### 7.1 è½®è½¬æ€§èƒ½å½±å“åˆ†æ


**è½®è½¬å¯¹æ€§èƒ½çš„å½±å“**ï¼š
```
æ€§èƒ½å½±å“å› ç´ ï¼š

ğŸ’¾ ç£ç›˜I/Oå³°å€¼ï¼š
   - è½®è½¬æ—¶çŸ­æš‚çš„I/Oå³°å€¼
   - å½±å“ç¨‹åº¦ï¼šè½»å¾®ï¼ˆå‡ ç§’é’Ÿï¼‰
   - ä¼˜åŒ–ï¼šé”™å³°æ‰§è¡Œ

ğŸ”„ é”ç­‰å¾…æ—¶é—´ï¼š
   - åˆ‡æ¢æ—¥å¿—æ–‡ä»¶æ—¶çš„çŸ­æš‚é”å®š
   - å½±å“ç¨‹åº¦ï¼šæè½»å¾®ï¼ˆæ¯«ç§’çº§ï¼‰
   - ä¼˜åŒ–ï¼šé¿å…é«˜å¹¶å‘æ—¶æ‰§è¡Œ

ğŸ“ æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼š
   - åˆ›å»ºå’Œåˆ é™¤æ–‡ä»¶çš„å¼€é”€
   - å½±å“ç¨‹åº¦ï¼šå¯å¿½ç•¥
   - ä¼˜åŒ–ï¼šä½¿ç”¨SSDå­˜å‚¨
```

### 7.2 å­˜å‚¨æˆæœ¬ä¼˜åŒ–ç­–ç•¥


**æˆæœ¬è®¡ç®—æ¨¡å‹**ï¼š
```
æ—¥å¿—å­˜å‚¨æˆæœ¬åˆ†æï¼š

ğŸ“Š æ•°æ®é‡é¢„ä¼°ï¼š
   - æ—¥å‡binlogäº§ç”Ÿï¼š100GB
   - ä¿ç•™å‘¨æœŸï¼š30å¤©
   - æ€»å­˜å‚¨éœ€æ±‚ï¼š100GB Ã— 30 = 3TB

ğŸ’° å­˜å‚¨æˆæœ¬å¯¹æ¯”ï¼š
   - æœ¬åœ°SSDï¼š3TB Ã— ï¿¥2/GB/æœˆ = ï¿¥6000/æœˆ
   - æœ¬åœ°HDDï¼š3TB Ã— ï¿¥0.5/GB/æœˆ = ï¿¥1500/æœˆ  
   - äº‘å­˜å‚¨ï¼š3TB Ã— ï¿¥0.1/GB/æœˆ = ï¿¥300/æœˆ

ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆï¼š
   - 7å¤©çƒ­æ•°æ®ï¼šSSDå­˜å‚¨
   - 30å¤©æ¸©æ•°æ®ï¼šHDDå­˜å‚¨  
   - é•¿æœŸå½’æ¡£ï¼šäº‘å­˜å‚¨
```

### 7.3 å‹ç¼©å­˜å‚¨ä¼˜åŒ–


**æ™ºèƒ½å‹ç¼©ç­–ç•¥**ï¼š
```bash
#!/bin/bash
# smart_compress.sh - æ™ºèƒ½å‹ç¼©è„šæœ¬

compress_binlog() {
    local file=$1
    local age_days=$2
    
    if [ $age_days -gt 7 ] && [ $age_days -le 30 ]; then
        # 7-30å¤©ï¼šä½¿ç”¨gzipå‹ç¼©
        echo "ä½¿ç”¨gzipå‹ç¼© $file"
        gzip $file
    elif [ $age_days -gt 30 ]; then
        # 30å¤©ä»¥ä¸Šï¼šä½¿ç”¨xzé«˜å‹ç¼©æ¯”
        echo "ä½¿ç”¨xzå‹ç¼© $file" 
        xz -9 $file
    fi
}

# éå†binlogæ–‡ä»¶å¹¶æ™ºèƒ½å‹ç¼©
for binlog in /var/lib/mysql/mysql-bin.*; do
    if [ -f "$binlog" ]; then
        age_days=$(( ($(date +%s) - $(stat -c %Y "$binlog")) / 86400 ))
        compress_binlog "$binlog" $age_days
    fi
done
```

### 7.4 æ¸…ç†é¢„æµ‹æ¨¡å‹


**å­˜å‚¨å¢é•¿é¢„æµ‹**ï¼š
```python
# storage_prediction.py - å­˜å‚¨å¢é•¿é¢„æµ‹
import numpy as np
from datetime import datetime, timedelta

def predict_storage_growth(daily_growth_gb, retention_days):
    """
    é¢„æµ‹å­˜å‚¨å¢é•¿å’Œæ¸…ç†éœ€æ±‚
    
    å‚æ•°:
    daily_growth_gb: æ¯æ—¥binlogå¢é•¿é‡(GB)
    retention_days: ä¿ç•™å¤©æ•°
    """
    
    # è®¡ç®—ç¨³æ€å­˜å‚¨éœ€æ±‚
    steady_state_storage = daily_growth_gb * retention_days
    
    # é¢„æµ‹æœªæ¥30å¤©çš„å­˜å‚¨éœ€æ±‚
    future_dates = []
    storage_usage = []
    
    for i in range(30):
        date = datetime.now() + timedelta(days=i)
        # è€ƒè™‘æ¸…ç†æœºåˆ¶çš„å­˜å‚¨ä½¿ç”¨é‡
        if i < retention_days:
            usage = daily_growth_gb * (i + 1)
        else:
            usage = steady_state_storage
            
        future_dates.append(date.strftime('%Y-%m-%d'))
        storage_usage.append(usage)
    
    return future_dates, storage_usage

# ç¤ºä¾‹ä½¿ç”¨
dates, storage = predict_storage_growth(100, 7)  # æ¯æ—¥100GBï¼Œä¿ç•™7å¤©
print(f"ç¨³æ€å­˜å‚¨éœ€æ±‚: {storage[-1]}GB")
print(f"30å¤©åå­˜å‚¨ä½¿ç”¨: {storage[-1]}GB")
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—è½®è½¬æœ¬è´¨ï¼šå®šæœŸåˆ‡æ¢å’Œæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé˜²æ­¢ç£ç›˜çˆ†æ»¡
ğŸ”¸ è§¦å‘æ¡ä»¶ï¼šæ–‡ä»¶å¤§å°ã€æ—¶é—´é—´éš”ã€æ–‡ä»¶æ•°é‡ã€æ‰‹åŠ¨è§¦å‘
ğŸ”¸ MySQLå†…ç½®æœºåˆ¶ï¼šexpire_logs_daysã€binlog_expire_logs_seconds
ğŸ”¸ ç³»ç»Ÿçº§å·¥å…·ï¼šlogrotateå·¥å…·ç®¡ç†é”™è¯¯æ—¥å¿—å’Œæ…¢æŸ¥è¯¢æ—¥å¿—
ğŸ”¸ æ‰‹åŠ¨æ¸…ç†ï¼šPURGEå‘½ä»¤å®‰å…¨åˆ é™¤è¿‡æœŸbinlog
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šç£ç›˜ä½¿ç”¨ç‡ã€æ–‡ä»¶æ•°é‡ã€è½®è½¬å¤±è´¥æ£€æµ‹
```

### 8.2 å…³é”®é…ç½®å‚æ•°é€ŸæŸ¥


| å‚æ•°åç§° | **ä½œç”¨** | **æ¨èå€¼** | **æ³¨æ„äº‹é¡¹** |
|---------|---------|-----------|-------------|
| `max_binlog_size` | `æ§åˆ¶å•ä¸ªbinlogæ–‡ä»¶å¤§å°` | `1G` | `ä¸è¦è®¾ç½®è¿‡å°ï¼Œå½±å“æ€§èƒ½` |
| `binlog_expire_logs_seconds` | `è‡ªåŠ¨åˆ é™¤è¿‡æœŸbinlog` | `604800(7å¤©)` | `è€ƒè™‘ä¸»ä»åŒæ­¥éœ€æ±‚` |
| `max_binlog_files` | `æœ€å¤§binlogæ–‡ä»¶æ•°` | `50-100` | `é˜²æ­¢æ„å¤–ä¿ç•™è¿‡å¤šæ–‡ä»¶` |

### 8.3 æœ€ä½³å®è·µæ€»ç»“


**ğŸ”¹ é…ç½®åŸåˆ™**ï¼š
```
å®‰å…¨ç¬¬ä¸€ï¼š
- æ¸…ç†å‰ç¡®è®¤ä¸»ä»åŒæ­¥çŠ¶æ€
- é‡è¦ç¯å¢ƒå…ˆå¤‡ä»½å†æ¸…ç†
- è®¾ç½®åˆç†çš„ä¿ç•™å‘¨æœŸ

æ€§èƒ½è€ƒè™‘ï¼š
- é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸæ‰§è¡Œè½®è½¬
- ä½¿ç”¨SSDå­˜å‚¨æé«˜I/Oæ€§èƒ½
- åˆç†è®¾ç½®ç¼“å­˜å‚æ•°

æˆæœ¬ä¼˜åŒ–ï¼š
- å®æ–½åˆ†å±‚å­˜å‚¨ç­–ç•¥
- å¯ç”¨å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´
- å®šæœŸæ¸…ç†ä¸å¿…è¦çš„æ—¥å¿—
```

**ğŸ”¹ æ•…éšœæ’é™¤**ï¼š
```
å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š

ç£ç›˜ç©ºé—´ä¸è¶³ï¼š
âœ… ç«‹å³æ‰§è¡Œæ‰‹åŠ¨æ¸…ç†
âœ… è°ƒæ•´ä¿ç•™ç­–ç•¥
âœ… å¢åŠ å­˜å‚¨å®¹é‡

è½®è½¬å¤±è´¥ï¼š
âœ… æ£€æŸ¥æ–‡ä»¶æƒé™
âœ… ç¡®è®¤ç£ç›˜ç©ºé—´
âœ… æŸ¥çœ‹é”™è¯¯æ—¥å¿—

æ€§èƒ½ä¸‹é™ï¼š
âœ… æ£€æŸ¥I/Oè´Ÿè½½
âœ… ä¼˜åŒ–è½®è½¬æ—¶é—´
âœ… è€ƒè™‘ç¡¬ä»¶å‡çº§
```

**ğŸ”¹ è¿ç»´æ£€æŸ¥æ¸…å•**ï¼š
```
æ—¥å¸¸æ£€æŸ¥ï¼š
â˜‘ï¸ æŸ¥çœ‹binlogæ–‡ä»¶æ•°é‡å’Œå¤§å°
â˜‘ï¸ æ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡
â˜‘ï¸ ç¡®è®¤è‡ªåŠ¨æ¸…ç†æ˜¯å¦æ­£å¸¸

å®šæœŸæ£€æŸ¥ï¼š
â˜‘ï¸ éªŒè¯å¤‡ä»½å’Œå½’æ¡£å®Œæ•´æ€§
â˜‘ï¸ æµ‹è¯•è½®è½¬è„šæœ¬åŠŸèƒ½
â˜‘ï¸ å›é¡¾å’Œè°ƒæ•´ä¿ç•™ç­–ç•¥

åº”æ€¥å¤„ç†ï¼š
â˜‘ï¸ å‡†å¤‡å¿«é€Ÿæ¸…ç†è„šæœ¬
â˜‘ï¸ å»ºç«‹å‘Šè­¦å“åº”æµç¨‹
â˜‘ï¸ åˆ¶å®šæ‰©å®¹é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ—¥å¿—è½®è½¬æ˜¯é˜²æ­¢ç£ç›˜çˆ†æ»¡çš„å¿…è¦æ‰‹æ®µ
- MySQLå†…ç½®æœºåˆ¶å’Œç³»ç»Ÿå·¥å…·ç›¸ç»“åˆä½¿ç”¨
- æ¸…ç†å‰å¿…é¡»ç¡®è®¤æ•°æ®å®‰å…¨
- ç›‘æ§å‘Šè­¦æ˜¯è¿ç»´ç®¡ç†çš„é‡è¦ç¯èŠ‚
- æˆæœ¬ä¼˜åŒ–éœ€è¦ç»¼åˆè€ƒè™‘æ€§èƒ½å’Œå­˜å‚¨éœ€æ±‚