---
title: 38ã€äº‹åŠ¡å¼‚å¸¸æ•…éšœæ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡é•¿æ—¶é—´æœªæäº¤æ•…éšœ](#1-äº‹åŠ¡é•¿æ—¶é—´æœªæäº¤æ•…éšœ)
2. [äº‹åŠ¡å›æ»šå¼‚å¸¸é—®é¢˜](#2-äº‹åŠ¡å›æ»šå¼‚å¸¸é—®é¢˜)
3. [åˆ†å¸ƒå¼äº‹åŠ¡æ•…éšœå¤„ç†](#3-åˆ†å¸ƒå¼äº‹åŠ¡æ•…éšœå¤„ç†)
4. [äº‹åŠ¡éš”ç¦»çº§åˆ«é”™è¯¯æ¡ˆä¾‹](#4-äº‹åŠ¡éš”ç¦»çº§åˆ«é”™è¯¯æ¡ˆä¾‹)
5. [XAäº‹åŠ¡å¼‚å¸¸å¤„ç†](#5-xaäº‹åŠ¡å¼‚å¸¸å¤„ç†)
6. [äº‹åŠ¡æ—¥å¿—å¼‚å¸¸æ•…éšœ](#6-äº‹åŠ¡æ—¥å¿—å¼‚å¸¸æ•…éšœ)
7. [äº‹åŠ¡è¶…æ—¶å¤„ç†æœºåˆ¶](#7-äº‹åŠ¡è¶…æ—¶å¤„ç†æœºåˆ¶)
8. [äº‹åŠ¡çŠ¶æ€ç›‘æ§ä¸åˆ†æ](#8-äº‹åŠ¡çŠ¶æ€ç›‘æ§ä¸åˆ†æ)
9. [äº‹åŠ¡å¼‚å¸¸è‡ªåŠ¨å¤„ç†](#9-äº‹åŠ¡å¼‚å¸¸è‡ªåŠ¨å¤„ç†)
10. [äº‹åŠ¡æ€§èƒ½åˆ†æä¼˜åŒ–](#10-äº‹åŠ¡æ€§èƒ½åˆ†æä¼˜åŒ–)
11. [äº‹åŠ¡æ•…éšœé¢„é˜²ç­–ç•¥](#11-äº‹åŠ¡æ•…éšœé¢„é˜²ç­–ç•¥)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ äº‹åŠ¡é•¿æ—¶é—´æœªæäº¤æ•…éšœ


### 1.1 é—®é¢˜ç°è±¡ä¸åŸå› 


**ğŸ”¸ å…¸å‹æ•…éšœè¡¨ç°**
```
ç—‡çŠ¶è¡¨ç°ï¼š
â€¢ æ•°æ®åº“è¿æ¥æ± è€—å°½
â€¢ æŸ¥è¯¢å“åº”ç¼“æ…¢ï¼Œç”šè‡³è¶…æ—¶
â€¢ é”ç­‰å¾…æ—¶é—´è¿‡é•¿
â€¢ æ´»è·ƒè¿æ¥æ•°å¼‚å¸¸å¢é«˜
```

**ğŸ’¡ é—®é¢˜äº§ç”ŸåŸå› **
```
å¸¸è§åŸå› ï¼š
1. ç¨‹åºæœªæ­£ç¡®æäº¤æˆ–å›æ»šäº‹åŠ¡
2. å¼‚å¸¸å¤„ç†ä¸å½“ï¼Œäº‹åŠ¡æœªé‡Šæ”¾
3. é•¿æ—¶é—´çš„å¤æ‚ä¸šåŠ¡æ“ä½œ
4. ç½‘ç»œä¸­æ–­å¯¼è‡´è¿æ¥æ‚¬æŒ‚
5. åº”ç”¨ç¨‹åºæ­»å¾ªç¯æˆ–é˜»å¡
```

### 1.2 æ•…éšœè¯Šæ–­æ–¹æ³•


**ğŸ” è¯Šæ–­SQLè¯­å¥**
```sql
-- æŸ¥çœ‹å½“å‰æ´»è·ƒäº‹åŠ¡
SELECT 
    trx_id,
    trx_state,
    trx_started,
    trx_query,
    TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration_seconds
FROM INFORMATION_SCHEMA.INNODB_TRX
WHERE trx_state = 'RUNNING'
ORDER BY trx_started;

-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread
FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS w
JOIN INFORMATION_SCHEMA.INNODB_TRX b ON b.trx_id = w.blocking_trx_id
JOIN INFORMATION_SCHEMA.INNODB_TRX r ON r.trx_id = w.requesting_trx_id;
```

### 1.3 è§£å†³æ–¹æ¡ˆ


**âš¡ ç«‹å³å¤„ç†æ–¹æ³•**
```sql
-- æ€æ­»é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
KILL [CONNECTION/QUERY] thread_id;

-- ç¤ºä¾‹ï¼šæ€æ­»è¶…è¿‡1å°æ—¶çš„äº‹åŠ¡
SELECT CONCAT('KILL ', id, ';') as kill_cmd
FROM INFORMATION_SCHEMA.PROCESSLIST p
JOIN INFORMATION_SCHEMA.INNODB_TRX t ON p.id = t.trx_mysql_thread_id
WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 3600;
```

**ğŸ› ï¸ åº”ç”¨å±‚æ”¹è¿›**
```java
// æ­£ç¡®çš„äº‹åŠ¡å¤„ç†æ¨¡å¼
@Transactional(rollbackFor = Exception.class, timeout = 30)
public void businessOperation() {
    try {
        // ä¸šåŠ¡æ“ä½œ
        userService.updateUser();
        orderService.createOrder();
        // è‡ªåŠ¨æäº¤
    } catch (Exception e) {
        // è‡ªåŠ¨å›æ»š
        log.error("ä¸šåŠ¡æ“ä½œå¤±è´¥", e);
        throw e;
    }
}

// æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†ï¼ˆç²¾ç»†æ§åˆ¶ï¼‰
public void manualTransactionControl() {
    Connection conn = null;
    try {
        conn = dataSource.getConnection();
        conn.setAutoCommit(false);
        
        // ä¸šåŠ¡æ“ä½œ
        executeBusinessLogic(conn);
        
        conn.commit(); // æ˜ç¡®æäº¤
    } catch (Exception e) {
        if (conn != null) {
            conn.rollback(); // æ˜ç¡®å›æ»š
        }
        throw e;
    } finally {
        if (conn != null) {
            conn.close(); // é‡Šæ”¾è¿æ¥
        }
    }
}
```

---

## 2. ğŸ”„ äº‹åŠ¡å›æ»šå¼‚å¸¸é—®é¢˜


### 2.1 å¸¸è§å›æ»šå¼‚å¸¸


**âŒ å…¸å‹å¼‚å¸¸åœºæ™¯**
```
å›æ»šå¼‚å¸¸ç±»å‹ï¼š
1. éƒ¨åˆ†å›æ»šå¤±è´¥
2. å›æ»šæ—¥å¿—æŸå
3. ç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´å›æ»šå¤±è´¥
4. å¤–é”®çº¦æŸå†²çª
5. æ­»é”å¯¼è‡´çš„å¼ºåˆ¶å›æ»š
```

### 2.2 å¼‚å¸¸è¯Šæ–­ä¸å¤„ç†


**ğŸ” è¯Šæ–­æŸ¥è¯¢**
```sql
-- æ£€æŸ¥å›æ»šæ®µçŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- æŸ¥çœ‹é”™è¯¯æ—¥å¿—ä¸­çš„å›æ»šä¿¡æ¯
-- åœ¨é”™è¯¯æ—¥å¿—ä¸­æŸ¥æ‰¾å…³é”®è¯ï¼šrollback, undo, transaction

-- æ£€æŸ¥æ­»é”ä¿¡æ¯
SELECT 
    engine_lock_id,
    engine_transaction_id,
    object_name,
    lock_type,
    lock_mode,
    lock_status
FROM performance_schema.data_locks
WHERE lock_status = 'WAITING';
```

**âš¡ å¤„ç†ç­–ç•¥**
```java
// å›æ»šå¼‚å¸¸çš„å¥å£®å¤„ç†
@Service
public class TransactionService {
    
    @Transactional
    public void robustTransaction() {
        try {
            // ä¸šåŠ¡æ“ä½œ
            performBusinessLogic();
        } catch (DataIntegrityViolationException e) {
            // æ•°æ®å®Œæ•´æ€§å¼‚å¸¸ï¼Œéœ€è¦å›æ»š
            log.error("æ•°æ®å®Œæ•´æ€§å†²çªï¼š{}", e.getMessage());
            throw new BusinessException("æ•°æ®å†²çªï¼Œè¯·é‡è¯•");
        } catch (DeadlockLoserDataAccessException e) {
            // æ­»é”å¼‚å¸¸ï¼Œå¯ä»¥é‡è¯•
            log.warn("æ£€æµ‹åˆ°æ­»é”ï¼Œå‡†å¤‡é‡è¯•ï¼š{}", e.getMessage());
            throw new RetryableException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        } catch (Exception e) {
            log.error("äº‹åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw e; // è®©äº‹åŠ¡å›æ»š
        }
    }
}
```

---

## 3. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡æ•…éšœå¤„ç†


### 3.1 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜åˆ†æ


**ğŸ”¸ å¸¸è§é—®é¢˜ç±»å‹**
```
åˆ†å¸ƒå¼äº‹åŠ¡æ•…éšœï¼š
1. ç½‘ç»œåˆ†åŒºå¯¼è‡´åè°ƒå¤±è´¥
2. å‚ä¸è€…èŠ‚ç‚¹å®•æœº
3. åè°ƒè€…æ•…éšœ
4. è¶…æ—¶å¯¼è‡´çš„ä¸ä¸€è‡´çŠ¶æ€
5. æ¶ˆæ¯ä¸¢å¤±é€ æˆçš„çŠ¶æ€ä¸åŒæ­¥
```

### 3.2 ä¸¤é˜¶æ®µæäº¤(2PC)æ•…éšœå¤„ç†


**ğŸ’¡ 2PCæ•…éšœè¯Šæ–­**
```sql
-- æŸ¥çœ‹XAäº‹åŠ¡çŠ¶æ€
XA RECOVER;

-- æŸ¥çœ‹å‡†å¤‡çŠ¶æ€çš„äº‹åŠ¡
SELECT 
    trx_id,
    trx_state,
    trx_query
FROM INFORMATION_SCHEMA.INNODB_TRX
WHERE trx_state = 'PREPARED';
```

**ğŸ› ï¸ æ•…éšœæ¢å¤ç­–ç•¥**
```java
// åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨å®ç°
@Component
public class DistributedTransactionManager {
    
    public void handleXARecovery() {
        try {
            // 1. æŸ¥è¯¢æ‰€æœ‰å‡†å¤‡çŠ¶æ€çš„äº‹åŠ¡
            List<Xid> preparedXids = xaResource.recover(XAResource.TMSTARTRSCAN);
            
            for (Xid xid : preparedXids) {
                // 2. æ£€æŸ¥äº‹åŠ¡ç®¡ç†å™¨çš„å†³å®š
                TransactionDecision decision = getTransactionDecision(xid);
                
                if (decision == TransactionDecision.COMMIT) {
                    // æäº¤äº‹åŠ¡
                    xaResource.commit(xid, false);
                } else if (decision == TransactionDecision.ROLLBACK) {
                    // å›æ»šäº‹åŠ¡
                    xaResource.rollback(xid);
                } else {
                    // å†³å®šæœªçŸ¥ï¼Œæ ¹æ®ç­–ç•¥å¤„ç†
                    handleUnknownTransaction(xid);
                }
            }
        } catch (XAException e) {
            log.error("XAæ¢å¤å¤±è´¥", e);
        }
    }
}
```

### 3.3 åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§


**ğŸ“¨ æ¶ˆæ¯äº‹åŠ¡æ¨¡å¼**
```java
// å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§å®ç°
@Service
public class MessageTransactionService {
    
    @Transactional
    public void reliableMessageTransaction(OrderDTO order) {
        // 1. æœ¬åœ°äº‹åŠ¡ï¼šè®¢å•å…¥åº“ + æ¶ˆæ¯å…¥åº“
        orderRepository.save(order);
        
        MessageRecord message = MessageRecord.builder()
            .businessId(order.getId())
            .content(JSON.toJSONString(order))
            .status(MessageStatus.PENDING)
            .build();
        messageRepository.save(message);
        
        // 2. äº‹åŠ¡æäº¤åå‘é€æ¶ˆæ¯
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronizationAdapter() {
                @Override
                public void afterCommit() {
                    // å‘é€æ¶ˆæ¯åˆ°MQ
                    messageProducer.sendMessage(message);
                    // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€
                    messageRepository.updateStatus(message.getId(), MessageStatus.SENT);
                }
            }
        );
    }
}
```

---

## 4. ğŸ” äº‹åŠ¡éš”ç¦»çº§åˆ«é”™è¯¯æ¡ˆä¾‹


### 4.1 éš”ç¦»çº§åˆ«é—®é¢˜åˆ†æ


**ğŸ“Š éš”ç¦»çº§åˆ«å¯¹æ¯”**
| éš”ç¦»çº§åˆ« | **è„è¯»** | **ä¸å¯é‡å¤è¯»** | **å¹»è¯»** | **æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------------|---------|----------|-------------|
| **READ UNCOMMITTED** | âŒå¯èƒ½ | âŒå¯èƒ½ | âŒå¯èƒ½ | ğŸš€æé«˜ | æ•°æ®ä¸€è‡´æ€§è¦æ±‚æä½ |
| **READ COMMITTED** | âœ…é¿å… | âŒå¯èƒ½ | âŒå¯èƒ½ | ğŸƒé«˜ | å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ |
| **REPEATABLE READ** | âœ…é¿å… | âœ…é¿å… | âŒå¯èƒ½ | ğŸ“ˆä¸­ç­‰ | MySQLé»˜è®¤çº§åˆ« |
| **SERIALIZABLE** | âœ…é¿å… | âœ…é¿å… | âœ…é¿å… | ğŸŒä½ | æé«˜ä¸€è‡´æ€§è¦æ±‚ |

### 4.2 å¸¸è§éš”ç¦»çº§åˆ«é—®é¢˜


**ğŸ”¸ è„è¯»é—®é¢˜ç¤ºä¾‹**
```sql
-- åœºæ™¯ï¼šREAD UNCOMMITTEDçº§åˆ«ä¸‹çš„è„è¯»
-- äº‹åŠ¡A
BEGIN;
UPDATE accounts SET balance = 1000 WHERE id = 1;
-- æœªæäº¤

-- äº‹åŠ¡Bï¼ˆåŒæ—¶æ‰§è¡Œï¼‰
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
BEGIN;
SELECT balance FROM accounts WHERE id = 1; -- è¯»åˆ°1000ï¼ˆè„æ•°æ®ï¼‰
COMMIT;

-- äº‹åŠ¡Aå›æ»š
ROLLBACK; -- å®é™…balanceè¿˜æ˜¯åŸå€¼
```

**âš¡ è§£å†³æ–¹æ¡ˆ**
```java
// æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
@Transactional(isolation = Isolation.READ_COMMITTED)
public AccountInfo getAccountInfo(Long accountId) {
    // é¿å…è„è¯»ï¼Œå…è®¸ä¸å¯é‡å¤è¯»ï¼ˆé€‚åˆæŸ¥è¯¢åœºæ™¯ï¼‰
    return accountRepository.findById(accountId);
}

@Transactional(isolation = Isolation.REPEATABLE_READ)
public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
    // é¿å…ä¸å¯é‡å¤è¯»ï¼ˆé€‚åˆè½¬è´¦ç­‰éœ€è¦æ•°æ®ä¸€è‡´æ€§çš„åœºæ™¯ï¼‰
    Account fromAccount = accountRepository.findById(fromId);
    Account toAccount = accountRepository.findById(toId);
    
    // è½¬è´¦é€»è¾‘
    fromAccount.withdraw(amount);
    toAccount.deposit(amount);
    
    accountRepository.save(fromAccount);
    accountRepository.save(toAccount);
}
```

---

## 5. âš™ï¸ XAäº‹åŠ¡å¼‚å¸¸å¤„ç†


### 5.1 XAäº‹åŠ¡æœºåˆ¶åŸç†


**ğŸ”¸ XAäº‹åŠ¡åŸºæœ¬æ¦‚å¿µ**
```
XAè§„èŒƒæ ¸å¿ƒç»„ä»¶ï¼š
â€¢ äº‹åŠ¡ç®¡ç†å™¨(TM)ï¼šåè°ƒå…¨å±€äº‹åŠ¡
â€¢ èµ„æºç®¡ç†å™¨(RM)ï¼šç®¡ç†æœ¬åœ°èµ„æºï¼ˆæ•°æ®åº“ï¼‰
â€¢ åº”ç”¨ç¨‹åº(AP)ï¼šå‘èµ·äº‹åŠ¡çš„ç¨‹åº

XAäº‹åŠ¡çŠ¶æ€ï¼š
ACTIVE â†’ PREPARED â†’ COMMITTED/ROLLED_BACK
```

### 5.2 å¸¸è§XAå¼‚å¸¸ç±»å‹


**âŒ XAå¼‚å¸¸åˆ†ç±»**
```
1. XA_RBROLLBACKï¼šäº‹åŠ¡å›æ»š
2. XA_RBTIMEOUTï¼šäº‹åŠ¡è¶…æ—¶
3. XA_RBDEADLOCKï¼šæ­»é”æ£€æµ‹
4. XA_RBOTHERï¼šå…¶ä»–åŸå› å›æ»š
5. XA_NOMIGRATEï¼šäº‹åŠ¡åˆ†æ”¯è¿ç§»å¤±è´¥
6. XA_HEURHAZï¼šå¯å‘å¼å¼‚å¸¸
```

### 5.3 XAå¼‚å¸¸å¤„ç†å®ç°


**ğŸ› ï¸ XAå¼‚å¸¸å¤„ç†ä»£ç **
```java
@Component
public class XATransactionHandler {
    
    public void handleXATransaction() {
        Xid xid = createXid();
        
        try {
            // å¼€å§‹XAäº‹åŠ¡
            xaResource.start(xid, XAResource.TMNOFLAGS);
            
            // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            executeBusinessOperation();
            
            // ç»“æŸäº‹åŠ¡åˆ†æ”¯
            xaResource.end(xid, XAResource.TMSUCCESS);
            
            // å‡†å¤‡é˜¶æ®µ
            int prepareResult = xaResource.prepare(xid);
            
            if (prepareResult == XAResource.XA_OK) {
                // æäº¤äº‹åŠ¡
                xaResource.commit(xid, false);
            } else {
                // å›æ»šäº‹åŠ¡
                xaResource.rollback(xid);
            }
            
        } catch (XAException e) {
            handleXAException(xid, e);
        }
    }
    
    private void handleXAException(Xid xid, XAException e) {
        switch (e.errorCode) {
            case XAException.XA_RBROLLBACK:
                log.warn("äº‹åŠ¡å·²å›æ»š: {}", xid);
                break;
            case XAException.XA_RBTIMEOUT:
                log.error("äº‹åŠ¡è¶…æ—¶: {}", xid);
                // å°è¯•å›æ»š
                tryRollback(xid);
                break;
            case XAException.XA_RBDEADLOCK:
                log.error("æ£€æµ‹åˆ°æ­»é”: {}", xid);
                // é‡è¯•é€»è¾‘
                scheduleRetry(xid);
                break;
            default:
                log.error("XAäº‹åŠ¡å¼‚å¸¸: {}, code: {}", xid, e.errorCode);
                tryRollback(xid);
        }
    }
}
```

---

## 6. ğŸ“ äº‹åŠ¡æ—¥å¿—å¼‚å¸¸æ•…éšœ


### 6.1 äº‹åŠ¡æ—¥å¿—ç±»å‹ä¸ä½œç”¨


**ğŸ”¸ InnoDBæ—¥å¿—ç³»ç»Ÿ**
```
æ—¥å¿—ç±»å‹è¯´æ˜ï¼š
â€¢ Redo Logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§
â€¢ Undo Logï¼ˆå›æ»šæ—¥å¿—ï¼‰ï¼šä¿è¯äº‹åŠ¡åŸå­æ€§
â€¢ Binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ï¼šç”¨äºå¤åˆ¶å’Œæ¢å¤
â€¢ é”™è¯¯æ—¥å¿—ï¼šè®°å½•MySQLè¿è¡Œé”™è¯¯ä¿¡æ¯
```

### 6.2 æ—¥å¿—å¼‚å¸¸è¯Šæ–­


**ğŸ” æ—¥å¿—çŠ¶æ€æ£€æŸ¥**
```sql
-- æ£€æŸ¥InnoDBçŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- æŸ¥çœ‹æ—¥å¿—ç›¸å…³å˜é‡
SHOW VARIABLES LIKE '%log%';

-- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°å’Œä½¿ç”¨æƒ…å†µ
SELECT 
    FILE_NAME,
    TOTAL_EXTENTS,
    INITIAL_SIZE/1024/1024 as SIZE_MB,
    DATA_FREE/1024/1024 as FREE_MB
FROM INFORMATION_SCHEMA.FILES 
WHERE TABLESPACE_NAME = 'innodb_system';
```

### 6.3 æ—¥å¿—å¼‚å¸¸å¤„ç†


**âš¡ å¸¸è§æ—¥å¿—é—®é¢˜è§£å†³**
```sql
-- 1. Redoæ—¥å¿—ç©ºé—´ä¸è¶³
-- æ£€æŸ¥redoæ—¥å¿—ä½¿ç”¨æƒ…å†µ
SHOW STATUS LIKE 'Innodb_log%';

-- å¢åŠ redoæ—¥å¿—å¤§å°ï¼ˆéœ€è¦é‡å¯MySQLï¼‰
-- åœ¨my.cnfä¸­é…ç½®ï¼š
-- innodb_log_file_size = 256M
-- innodb_log_files_in_group = 3

-- 2. Undoæ—¥å¿—æ¸…ç†é—®é¢˜
-- æ£€æŸ¥undoç©ºé—´ä½¿ç”¨
SELECT 
    TABLESPACE_NAME,
    FILE_NAME,
    TOTAL_EXTENTS,
    EXTENT_SIZE,
    INITIAL_SIZE,
    MAXIMUM_SIZE,
    DATA_FREE
FROM INFORMATION_SCHEMA.FILES 
WHERE TABLESPACE_NAME LIKE 'innodb_undo%';

-- æ‰‹åŠ¨è§¦å‘undoæ—¥å¿—æ¸…ç†
SET GLOBAL innodb_undo_log_truncate = ON;
SET GLOBAL innodb_max_undo_log_size = 1073741824; -- 1GB
```

---

## 7. â° äº‹åŠ¡è¶…æ—¶å¤„ç†æœºåˆ¶


### 7.1 è¶…æ—¶å‚æ•°é…ç½®


**ğŸ”§ å…³é”®è¶…æ—¶å‚æ•°**
```sql
-- æŸ¥çœ‹è¶…æ—¶ç›¸å…³é…ç½®
SHOW VARIABLES LIKE '%timeout%';

-- å…³é”®å‚æ•°è¯´æ˜ï¼š
-- wait_timeout: éäº¤äº’è¿æ¥è¶…æ—¶æ—¶é—´
-- interactive_timeout: äº¤äº’è¿æ¥è¶…æ—¶æ—¶é—´  
-- lock_wait_timeout: é”ç­‰å¾…è¶…æ—¶æ—¶é—´
-- innodb_rollback_on_timeout: è¶…æ—¶æ—¶å›æ»šæ•´ä¸ªäº‹åŠ¡
```

### 7.2 åº”ç”¨å±‚è¶…æ—¶å¤„ç†


**ğŸ› ï¸ è¶…æ—¶å¤„ç†å®ç°**
```java
// æ•°æ®åº“å±‚é¢è¶…æ—¶è®¾ç½®
@Transactional(timeout = 30) // 30ç§’è¶…æ—¶
public void businessOperationWithTimeout() {
    // ä¸šåŠ¡é€»è¾‘
}

// è¿æ¥æ± è¶…æ—¶é…ç½®
@Configuration
public class DataSourceConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setConnectionTimeout(20000); // è¿æ¥è¶…æ—¶20ç§’
        config.setIdleTimeout(300000);      // ç©ºé—²è¶…æ—¶5åˆ†é’Ÿ
        config.setMaxLifetime(1200000);     // æœ€å¤§ç”Ÿå‘½å‘¨æœŸ20åˆ†é’Ÿ
        config.setLeakDetectionThreshold(60000); // æ³„éœ²æ£€æµ‹1åˆ†é’Ÿ
        
        return new HikariDataSource(config);
    }
}

// è‡ªå®šä¹‰è¶…æ—¶å¼‚å¸¸å¤„ç†
@ControllerAdvice
public class TransactionExceptionHandler {
    
    @ExceptionHandler(TransactionTimedOutException.class)
    public ResponseEntity<String> handleTransactionTimeout(
            TransactionTimedOutException e) {
        log.error("äº‹åŠ¡è¶…æ—¶", e);
        return ResponseEntity.status(408)
            .body("æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

## 8. ğŸ“Š äº‹åŠ¡çŠ¶æ€ç›‘æ§ä¸åˆ†æ


### 8.1 äº‹åŠ¡ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- å½“å‰æ´»è·ƒäº‹åŠ¡æ•°
SELECT COUNT(*) as active_transactions
FROM INFORMATION_SCHEMA.INNODB_TRX;

-- é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
SELECT 
    trx_id,
    trx_mysql_thread_id,
    trx_started,
    TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration,
    trx_query
FROM INFORMATION_SCHEMA.INNODB_TRX
WHERE trx_started < DATE_SUB(NOW(), INTERVAL 60 SECOND);

-- é”ç­‰å¾…ç»Ÿè®¡
SELECT 
    COUNT(*) as waiting_transactions,
    AVG(TIMESTAMPDIFF(SECOND, trx_started, NOW())) as avg_wait_time
FROM INFORMATION_SCHEMA.INNODB_TRX
WHERE trx_state = 'LOCK WAIT';
```

### 8.2 æ€§èƒ½ç›‘æ§å®ç°


**ğŸ” ç›‘æ§ç³»ç»Ÿå®ç°**
```java
@Component
@Slf4j
public class TransactionMonitor {
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ‰§è¡Œ
    public void monitorTransactions() {
        try {
            // æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
            List<LongRunningTransaction> longTrx = findLongRunningTransactions();
            if (!longTrx.isEmpty()) {
                alertLongRunningTransactions(longTrx);
            }
            
            // æ£€æŸ¥é”ç­‰å¾…æƒ…å†µ
            int waitingCount = countWaitingTransactions();
            if (waitingCount > LOCK_WAIT_THRESHOLD) {
                alertLockWaiting(waitingCount);
            }
            
            // è®°å½•äº‹åŠ¡æ€§èƒ½æŒ‡æ ‡
            recordTransactionMetrics();
            
        } catch (Exception e) {
            log.error("äº‹åŠ¡ç›‘æ§å¼‚å¸¸", e);
        }
    }
    
    private void recordTransactionMetrics() {
        TransactionMetrics metrics = TransactionMetrics.builder()
            .activeTransactionCount(getActiveTransactionCount())
            .avgTransactionDuration(getAvgTransactionDuration())
            .lockWaitCount(getLockWaitCount())
            .deadlockCount(getDeadlockCount())
            .build();
            
        metricsService.record(metrics);
    }
}
```

---

## 9. ğŸ¤– äº‹åŠ¡å¼‚å¸¸è‡ªåŠ¨å¤„ç†


### 9.1 è‡ªåŠ¨å¤„ç†ç­–ç•¥


**ğŸ”¸ å¤„ç†ç­–ç•¥æ¡†æ¶**
```
å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼š
1. æ£€æµ‹å¼‚å¸¸ç±»å‹å’Œä¸¥é‡ç¨‹åº¦
2. è‡ªåŠ¨é‡è¯•æœºåˆ¶
3. é™çº§å¤„ç†
4. å‘Šè­¦é€šçŸ¥
5. è‡ªåŠ¨æ¢å¤
```

### 9.2 è‡ªåŠ¨å¤„ç†å®ç°


**âš¡ è‡ªåŠ¨æ¢å¤æœºåˆ¶**
```java
@Component
public class AutoTransactionRecovery {
    
    @EventListener
    public void handleTransactionException(TransactionExceptionEvent event) {
        TransactionException exception = event.getException();
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹é€‰æ‹©å¤„ç†ç­–ç•¥
        RecoveryStrategy strategy = strategyFactory.getStrategy(exception);
        
        try {
            strategy.recover(exception);
        } catch (RecoveryFailedException e) {
            // æ¢å¤å¤±è´¥ï¼Œå‘é€å‘Šè­¦
            alertService.sendAlert(
                "äº‹åŠ¡è‡ªåŠ¨æ¢å¤å¤±è´¥: " + e.getMessage()
            );
        }
    }
}

// é‡è¯•ç­–ç•¥å®ç°
@Component
public class RetryRecoveryStrategy implements RecoveryStrategy {
    
    @Retryable(
        value = {TransactionException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public void recover(TransactionException exception) {
        // é‡è¯•äº‹åŠ¡æ“ä½œ
        retryTransactionOperation(exception.getTransactionId());
    }
    
    @Recover
    public void recoverAfterRetry(TransactionException ex) {
        // é‡è¯•å¤±è´¥åçš„å¤„ç†
        log.error("é‡è¯•æ¢å¤å¤±è´¥ï¼Œè¿›å…¥äººå·¥å¤„ç†é˜Ÿåˆ—", ex);
        manualProcessQueue.add(ex.getTransactionId());
    }
}
```

---

## 10. ğŸ“ˆ äº‹åŠ¡æ€§èƒ½åˆ†æä¼˜åŒ–


### 10.1 æ€§èƒ½åˆ†ææ–¹æ³•


**ğŸ” æ€§èƒ½åˆ†æSQL**
```sql
-- åˆ†æäº‹åŠ¡è€—æ—¶åˆ†å¸ƒ
SELECT 
    ROUND(TIMESTAMPDIFF(MICROSECOND, trx_started, NOW()) / 1000) as duration_ms,
    COUNT(*) as transaction_count
FROM INFORMATION_SCHEMA.INNODB_TRX
GROUP BY ROUND(TIMESTAMPDIFF(MICROSECOND, trx_started, NOW()) / 1000)
ORDER BY duration_ms;

-- åˆ†æé”äº‰ç”¨æƒ…å†µ
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    LOCK_TYPE,
    LOCK_MODE,
    COUNT(*) as lock_count
FROM performance_schema.data_locks
GROUP BY OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE, LOCK_MODE
ORDER BY lock_count DESC;

-- æ­»é”å†å²åˆ†æ
SHOW ENGINE INNODB STATUS\G
-- æŸ¥çœ‹LATEST DETECTED DEADLOCKéƒ¨åˆ†
```

### 10.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ**
```java
// 1. äº‹åŠ¡ç²’åº¦ä¼˜åŒ–
@Service
public class OptimizedTransactionService {
    
    // ç»†ç²’åº¦äº‹åŠ¡ï¼šå‡å°‘é”æŒæœ‰æ—¶é—´
    @Transactional
    public void updateUserBalance(Long userId, BigDecimal amount) {
        User user = userRepository.findById(userId);
        user.setBalance(user.getBalance().add(amount));
        userRepository.save(user);
        // äº‹åŠ¡ç«‹å³ç»“æŸï¼Œé‡Šæ”¾é”
    }
    
    // åˆ†æ‰¹å¤„ç†ï¼šé¿å…é•¿äº‹åŠ¡
    public void batchUpdateUsers(List<Long> userIds) {
        for (List<Long> batch : Lists.partition(userIds, 100)) {
            updateUserBatch(batch); // æ¯æ‰¹ä¸€ä¸ªå°äº‹åŠ¡
        }
    }
    
    @Transactional
    private void updateUserBatch(List<Long> userIds) {
        // æ‰¹é‡æ›´æ–°ï¼Œä½†äº‹åŠ¡è¾ƒå°
        userIds.forEach(this::updateUser);
    }
}

// 2. ç´¢å¼•ä¼˜åŒ–å‡å°‘é”èŒƒå›´
// ç¡®ä¿WHEREæ¡ä»¶ä½¿ç”¨ç´¢å¼•ï¼Œå‡å°‘é”å®šè¡Œæ•°
@Query("UPDATE User u SET u.status = :status WHERE u.id = :id")
void updateUserStatus(@Param("id") Long id, @Param("status") String status);
```

---

## 11. ğŸ›¡ï¸ äº‹åŠ¡æ•…éšœé¢„é˜²ç­–ç•¥


### 11.1 é¢„é˜²æ€§é…ç½®


**ğŸ”§ æ•°æ®åº“é…ç½®ä¼˜åŒ–**
```sql
-- äº‹åŠ¡ç›¸å…³å‚æ•°ä¼˜åŒ–
SET GLOBAL innodb_lock_wait_timeout = 50;        -- é”ç­‰å¾…è¶…æ—¶50ç§’
SET GLOBAL transaction_isolation = 'READ-COMMITTED'; -- å‡å°‘é”å†²çª
SET GLOBAL innodb_deadlock_detect = ON;          -- å¼€å¯æ­»é”æ£€æµ‹
SET GLOBAL innodb_print_all_deadlocks = ON;      -- è®°å½•æ‰€æœ‰æ­»é”ä¿¡æ¯

-- æ—¥å¿—é…ç½®ä¼˜åŒ–
SET GLOBAL innodb_log_file_size = 268435456;     -- 256MB redoæ—¥å¿—
SET GLOBAL innodb_flush_log_at_trx_commit = 1;   -- æœ€å®‰å…¨çš„æŒä¹…åŒ–è®¾ç½®
SET GLOBAL sync_binlog = 1;                      -- åŒæ­¥å†™å…¥binlog
```

### 11.2 åº”ç”¨å±‚é¢„é˜²æªæ–½


**ğŸ› ï¸ ç¼–ç¨‹æœ€ä½³å®è·µ**
```java
// 1. ç»Ÿä¸€äº‹åŠ¡ç®¡ç†
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    @Bean
    public PlatformTransactionManager transactionManager(
            EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager manager = new JpaTransactionManager();
        manager.setEntityManagerFactory(entityManagerFactory);
        // è®¾ç½®é»˜è®¤è¶…æ—¶æ—¶é—´
        manager.setDefaultTimeout(30);
        return manager;
    }
}

// 2. äº‹åŠ¡æ³¨è§£æœ€ä½³å®è·µ
@Service
public class BestPracticeService {
    
    // æ˜ç¡®æŒ‡å®šå›æ»šå¼‚å¸¸
    @Transactional(rollbackFor = {Exception.class})
    public void reliableOperation() {
        // ä¸šåŠ¡é€»è¾‘
    }
    
    // åªè¯»äº‹åŠ¡ä¼˜åŒ–
    @Transactional(readOnly = true)
    public List<User> queryUsers() {
        // æŸ¥è¯¢æ“ä½œ
        return userRepository.findAll();
    }
    
    // ä¼ æ’­è¡Œä¸ºæ§åˆ¶
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void independentOperation() {
        // éœ€è¦ç‹¬ç«‹äº‹åŠ¡çš„æ“ä½œ
    }
}
```

### 11.3 ç›‘æ§é¢„è­¦ç³»ç»Ÿ


**ğŸ“Š é¢„è­¦è§„åˆ™è®¾ç½®**
```java
@Component
public class TransactionAlertRules {
    
    // é•¿äº‹åŠ¡é¢„è­¦
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkLongRunningTransactions() {
        List<Transaction> longTrx = findTransactionsOlderThan(Duration.ofMinutes(5));
        if (!longTrx.isEmpty()) {
            alertService.sendAlert(
                AlertLevel.WARNING,
                "æ£€æµ‹åˆ°é•¿æ—¶é—´è¿è¡Œäº‹åŠ¡: " + longTrx.size() + " ä¸ª"
            );
        }
    }
    
    // æ­»é”é¢„è­¦
    @EventListener
    public void handleDeadlockEvent(DeadlockDetectedEvent event) {
        alertService.sendAlert(
            AlertLevel.ERROR,
            "æ£€æµ‹åˆ°æ­»é”: " + event.getDeadlockInfo()
        );
        
        // è®°å½•æ­»é”è¯¦æƒ…ç”¨äºåˆ†æ
        deadlockAnalyzer.analyze(event.getDeadlockInfo());
    }
    
    // è¿æ¥æ± è€—å°½é¢„è­¦
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥
    public void checkConnectionPoolHealth() {
        int activeConnections = dataSource.getActiveConnections();
        int maxConnections = dataSource.getMaxConnections();
        
        double usage = (double) activeConnections / maxConnections;
        if (usage > 0.8) { // ä½¿ç”¨ç‡è¶…è¿‡80%
            alertService.sendAlert(
                AlertLevel.WARNING,
                String.format("è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: %.2f%% (%d/%d)", 
                    usage * 100, activeConnections, maxConnections)
            );
        }
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 äº‹åŠ¡æ•…éšœåˆ†ç±»ä¸ç‰¹ç‚¹


```
ğŸ”¸ äº‹åŠ¡é•¿æ—¶é—´æœªæäº¤ï¼šè¿æ¥æ± è€—å°½ã€é”ç­‰å¾…
ğŸ”¸ äº‹åŠ¡å›æ»šå¼‚å¸¸ï¼šéƒ¨åˆ†å›æ»šå¤±è´¥ã€å¤–é”®çº¦æŸå†²çª
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡æ•…éšœï¼šç½‘ç»œåˆ†åŒºã€èŠ‚ç‚¹å®•æœºã€åè°ƒå¤±è´¥
ğŸ”¸ éš”ç¦»çº§åˆ«é”™è¯¯ï¼šè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»é—®é¢˜
ğŸ”¸ XAäº‹åŠ¡å¼‚å¸¸ï¼šå‡†å¤‡é˜¶æ®µå¤±è´¥ã€å¯å‘å¼å¼‚å¸¸
ğŸ”¸ äº‹åŠ¡æ—¥å¿—å¼‚å¸¸ï¼šredo/undoæ—¥å¿—æŸåã€ç©ºé—´ä¸è¶³
```

### 12.2 æ•…éšœè¯Šæ–­æ ¸å¿ƒæ–¹æ³•


**ğŸ” è¯Šæ–­æŸ¥è¯¢è¯­å¥**
```sql
-- ä¸‡èƒ½è¯Šæ–­ç»„åˆ
SHOW ENGINE INNODB STATUS\G              -- æ•´ä½“çŠ¶æ€
SELECT * FROM INFORMATION_SCHEMA.INNODB_TRX;  -- æ´»è·ƒäº‹åŠ¡
SELECT * FROM performance_schema.data_locks;  -- é”ä¿¡æ¯
SHOW PROCESSLIST;                        -- è¿æ¥çŠ¶æ€
```

### 12.3 è§£å†³æ–¹æ¡ˆæ ¸å¿ƒæ€è·¯


**âš¡ å¤„ç†åŸåˆ™**
```
ç«‹å³å¤„ç†ï¼š
â€¢ è¯†åˆ«é—®é¢˜äº‹åŠ¡ â†’ è¯„ä¼°å½±å“ â†’ å¼ºåˆ¶ç»ˆæ­¢ â†’ æ¢å¤æœåŠ¡

æ ¹æœ¬è§£å†³ï¼š
â€¢ åº”ç”¨å±‚æ”¹è¿› â†’ è¶…æ—¶æœºåˆ¶ â†’ å¼‚å¸¸å¤„ç† â†’ ç›‘æ§é¢„è­¦

é¢„é˜²æªæ–½ï¼š
â€¢ å‚æ•°ä¼˜åŒ– â†’ ç¼–ç¨‹è§„èŒƒ â†’ è‡ªåŠ¨åŒ–å¤„ç† â†’ æŒç»­ç›‘æ§
```

### 12.4 æœ€ä½³å®è·µè¦ç‚¹


**ğŸ¯ å…³é”®è®°å¿†ç‚¹**
- **äº‹åŠ¡è¦çŸ­**ï¼šå‡å°‘é”æŒæœ‰æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
- **å¼‚å¸¸è¦å¤„ç†**ï¼šæ˜ç¡®å›æ»šç­–ç•¥ï¼Œå®Œå–„å¼‚å¸¸æ•è·
- **è¶…æ—¶è¦è®¾ç½®**ï¼šåº”ç”¨å±‚å’Œæ•°æ®åº“å±‚åŒé‡è¶…æ—¶ä¿æŠ¤
- **ç›‘æ§è¦åˆ°ä½**ï¼šå®æ—¶ç›‘æ§äº‹åŠ¡çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æ—¥å¿—è¦åˆ†æ**ï¼šå®šæœŸåˆ†æäº‹åŠ¡æ—¥å¿—ï¼Œä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ

**ğŸ’¡ æ•…éšœå¤„ç†è®°å¿†å£è¯€**ï¼š
```
äº‹åŠ¡æ•…éšœä¸è¦æ…Œï¼Œå…ˆçœ‹çŠ¶æ€å†åˆ†æ
é•¿äº‹åŠ¡é”éœ€æ¸…ç†ï¼Œå›æ»šå¼‚å¸¸æŸ¥çº¦æŸ
åˆ†å¸ƒå¼è¦çœ‹åè°ƒï¼Œéš”ç¦»çº§åˆ«è¦åŒ¹é…
XAå¼‚å¸¸åˆ†ç±»å¤„ç†ï¼Œæ—¥å¿—å¼‚å¸¸æŸ¥ç©ºé—´
è¶…æ—¶è®¾ç½®è¦åˆç†ï¼Œç›‘æ§é¢„è­¦ä¿å¹³å®‰
```

---

::: tip ğŸ’¡ å®ç”¨å»ºè®®
1. **å»ºç«‹äº‹åŠ¡ç›‘æ§ä½“ç³»**ï¼šå®æ—¶ç›‘æ§äº‹åŠ¡çŠ¶æ€ï¼Œè®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
2. **åˆ¶å®šåº”æ€¥å¤„ç†é¢„æ¡ˆ**ï¼šé’ˆå¯¹ä¸åŒç±»å‹çš„äº‹åŠ¡å¼‚å¸¸åˆ¶å®šæ ‡å‡†åŒ–å¤„ç†æµç¨‹
3. **å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ**ï¼šæ¨¡æ‹Ÿå„ç§äº‹åŠ¡å¼‚å¸¸åœºæ™¯ï¼ŒéªŒè¯å¤„ç†æ–¹æ¡ˆçš„æœ‰æ•ˆæ€§
4. **æŒç»­ä¼˜åŒ–äº‹åŠ¡è®¾è®¡**ï¼šæ ¹æ®ç›‘æ§æ•°æ®æŒç»­ä¼˜åŒ–äº‹åŠ¡ç²’åº¦å’Œéš”ç¦»çº§åˆ«
5. **åŠ å¼ºå¼€å‘è§„èŒƒåŸ¹è®­**ï¼šç¡®ä¿å¼€å‘å›¢é˜ŸæŒæ¡äº‹åŠ¡ç¼–ç¨‹çš„æœ€ä½³å®è·µ
:::

::: warning âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹
- å¼ºåˆ¶ç»ˆæ­¢äº‹åŠ¡å‰åŠ¡å¿…è¯„ä¼°ä¸šåŠ¡å½±å“
- åˆ†å¸ƒå¼äº‹åŠ¡å¼‚å¸¸å¤„ç†è¦è€ƒè™‘æ•°æ®ä¸€è‡´æ€§
- ä¿®æ”¹äº‹åŠ¡éš”ç¦»çº§åˆ«å‰è¦å……åˆ†æµ‹è¯•æ€§èƒ½å½±å“
- XAäº‹åŠ¡æ¢å¤æ“ä½œè¦åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œ
- äº‹åŠ¡æ—¥å¿—å¼‚å¸¸å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œéœ€è¦ç«‹å³å¤„ç†
:::