---
title: 25ã€ è¿æ¥é—®é¢˜æ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [è¿æ¥æ•°è€—å°½é—®é¢˜](#1-è¿æ¥æ•°è€—å°½é—®é¢˜)
2. [è¿æ¥è¶…æ—¶è®¾ç½®ä¼˜åŒ–](#2-è¿æ¥è¶…æ—¶è®¾ç½®ä¼˜åŒ–)
3. [è¿æ¥æ± é…ç½®è¯¦è§£](#3-è¿æ¥æ± é…ç½®è¯¦è§£)
4. [ç½‘ç»œè¿æ¥ä¸­æ–­å¤„ç†](#4-ç½‘ç»œè¿æ¥ä¸­æ–­å¤„ç†)
5. [SSLè¿æ¥æ•…éšœæ’æŸ¥](#5-SSLè¿æ¥æ•…éšœæ’æŸ¥)
6. [ç”¨æˆ·è¿æ¥é™åˆ¶ç®¡ç†](#6-ç”¨æˆ·è¿æ¥é™åˆ¶ç®¡ç†)
7. [è¿æ¥çº¿ç¨‹å¼‚å¸¸è¯Šæ–­](#7-è¿æ¥çº¿ç¨‹å¼‚å¸¸è¯Šæ–­)
8. [è¿æ¥æ³„æ¼æ£€æµ‹ä¸ä¿®å¤](#8-è¿æ¥æ³„æ¼æ£€æµ‹ä¸ä¿®å¤)
9. [è¿æ¥å¤ç”¨ä¼˜åŒ–ç­–ç•¥](#9-è¿æ¥å¤ç”¨ä¼˜åŒ–ç­–ç•¥)
10. [è¿æ¥è´Ÿè½½å‡è¡¡å®è·µ](#10-è¿æ¥è´Ÿè½½å‡è¡¡å®è·µ)
11. [è¿æ¥æ•…éšœè‡ªæ„ˆæœºåˆ¶](#11-è¿æ¥æ•…éšœè‡ªæ„ˆæœºåˆ¶)
12. [è¿æ¥å®‰å…¨åŠ å›ºæªæ–½](#12-è¿æ¥å®‰å…¨åŠ å›ºæªæ–½)
13. [è¿æ¥ç›‘æ§æœ€ä½³å®è·µ](#13-è¿æ¥ç›‘æ§æœ€ä½³å®è·µ)
14. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#14-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¥ è¿æ¥æ•°è€—å°½é—®é¢˜


### 1.1 ä»€ä¹ˆæ˜¯è¿æ¥æ•°è€—å°½


**ğŸ’¡ é€šä¿—è§£é‡Š**ï¼š
æƒ³è±¡ä¸€å®¶é¤å…åªæœ‰20å¼ æ¡Œå­ï¼Œå½“21ä¸ªå®¢äººåŒæ—¶æ¥åƒé¥­æ—¶ï¼Œç¬¬21ä¸ªå®¢äººå°±è¦ç­‰ä½ã€‚MySQLè¿æ¥æ•°è€—å°½å°±æ˜¯è¿™ä¸ªé“ç† - æ•°æ®åº“åŒæ—¶åªèƒ½å¤„ç†å›ºå®šæ•°é‡çš„è¿æ¥ï¼Œè¶…è¿‡å°±è¦æ’é˜Ÿç­‰å¾…ã€‚

```
ç°è±¡ï¼šåº”ç”¨æŠ¥é”™ "Too many connections"
æœ¬è´¨ï¼šMySQLè¾¾åˆ°äº†max_connectionsé™åˆ¶
å½±å“ï¼šæ–°çš„è¿æ¥è¯·æ±‚è¢«æ‹’ç»ï¼Œä¸šåŠ¡æ— æ³•è®¿é—®æ•°æ®åº“
```

### 1.2 è¿æ¥æ•°è€—å°½çš„å¸¸è§åŸå› 


**ğŸ” æ ¹æœ¬åŸå› åˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°æƒ…å†µ
SHOW STATUS LIKE 'Threads_connected';     -- å½“å‰è¿æ¥æ•°
SHOW STATUS LIKE 'Max_used_connections';  -- å†å²æœ€é«˜è¿æ¥æ•°
SHOW VARIABLES LIKE 'max_connections';    -- æœ€å¤§è¿æ¥æ•°é™åˆ¶
```

**ğŸ”¸ ä¸»è¦åŸå› **ï¼š
```
åº”ç”¨ç¨‹åºé—®é¢˜ï¼š
â€¢ è¿æ¥æ³„æ¼ï¼šç¨‹åºå¿˜è®°å…³é—­æ•°æ®åº“è¿æ¥
â€¢ è¿æ¥æ± é…ç½®ä¸å½“ï¼šæ± å­å¤ªå¤§æˆ–è¶…æ—¶è®¾ç½®ä¸åˆç†
â€¢ æ…¢æŸ¥è¯¢ï¼šé•¿æ—¶é—´è¿è¡Œçš„SQLå ç”¨è¿æ¥ä¸é‡Šæ”¾

æ•°æ®åº“é…ç½®é—®é¢˜ï¼š
â€¢ max_connectionsè®¾ç½®è¿‡å°
â€¢ è¿æ¥è¶…æ—¶æ—¶é—´è¿‡é•¿ï¼Œåƒµæ­»è¿æ¥å ç”¨èµ„æº

ä¸šåŠ¡æµé‡é—®é¢˜ï¼š
â€¢ çªå‘æµé‡è¶…è¿‡é¢„æœŸ
â€¢ å¹¶å‘ç”¨æˆ·æ•°æ¿€å¢
```

### 1.3 å¿«é€Ÿè¯Šæ–­ä¸è§£å†³


**âš¡ åº”æ€¥å¤„ç†æ­¥éª¤**ï¼š

```sql
-- 1. æŸ¥çœ‹å½“å‰æ‰€æœ‰è¿æ¥
SHOW PROCESSLIST;

-- 2. æ‰¾å‡ºå¼‚å¸¸è¿æ¥ï¼ˆè¿è¡Œæ—¶é—´é•¿ã€çŠ¶æ€å¼‚å¸¸ï¼‰
SELECT * FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep' 
AND TIME > 300;  -- è¶…è¿‡5åˆ†é’Ÿçš„éç¡çœ è¿æ¥

-- 3. å¼ºåˆ¶å…³é—­å¼‚å¸¸è¿æ¥
KILL CONNECTION è¿æ¥ID;
```

**ğŸ”§ é…ç½®ä¼˜åŒ–**ï¼š
```sql
-- ä¸´æ—¶å¢åŠ è¿æ¥æ•°ï¼ˆé‡å¯å¤±æ•ˆï¼‰
SET GLOBAL max_connections = 500;

-- æ°¸ä¹…é…ç½®ä¿®æ”¹ my.cnf
[mysqld]
max_connections = 500
max_user_connections = 450  -- å•ç”¨æˆ·æœ€å¤§è¿æ¥æ•°
```

---

## 2. â° è¿æ¥è¶…æ—¶è®¾ç½®ä¼˜åŒ–


### 2.1 ç†è§£å„ç§è¶…æ—¶å‚æ•°


**ğŸ“ è¶…æ—¶å‚æ•°å«ä¹‰**ï¼š

```
wait_timeoutï¼šéäº¤äº’è¿æ¥ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰
interactive_timeoutï¼šäº¤äº’è¿æ¥ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰
connect_timeoutï¼šå»ºç«‹è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
net_read_timeoutï¼šè¯»å–æ•°æ®è¶…æ—¶ï¼ˆç§’ï¼‰
net_write_timeoutï¼šå†™å…¥æ•°æ®è¶…æ—¶ï¼ˆç§’ï¼‰
```

**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
- **wait_timeout**ï¼šç¨‹åºè¿æ¥æ•°æ®åº“åï¼Œå¦‚æœä¸å¹²æ´»æœ€å¤šç­‰å¤šä¹…å°±æ–­å¼€
- **connect_timeout**ï¼šå»ºç«‹è¿æ¥æœ€å¤šç­‰å¤šä¹…ï¼Œè¶…æ—¶å°±æ”¾å¼ƒ
- **net_read/write_timeout**ï¼šä¼ è¾“æ•°æ®æ—¶æœ€å¤šç­‰å¤šä¹…

### 2.2 è¶…æ—¶é—®é¢˜æ¡ˆä¾‹ä¸è§£å†³


**ğŸ” å…¸å‹é—®é¢˜åœºæ™¯**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰è¶…æ—¶è®¾ç½®
SHOW VARIABLES LIKE '%timeout%';

-- å¸¸è§çš„è¶…æ—¶è®¾ç½®
SET GLOBAL wait_timeout = 28800;        -- 8å°æ—¶
SET GLOBAL interactive_timeout = 28800; -- 8å°æ—¶  
SET GLOBAL connect_timeout = 10;        -- 10ç§’
```

**âš ï¸ é…ç½®åŸåˆ™**ï¼š
```
wait_timeoutå»ºè®®ï¼š
â€¢ é«˜å¹¶å‘åº”ç”¨ï¼š300-1800ç§’ï¼ˆ5-30åˆ†é’Ÿï¼‰
â€¢ ä½å¹¶å‘åº”ç”¨ï¼š3600-28800ç§’ï¼ˆ1-8å°æ—¶ï¼‰
â€¢ è¿æ¥æ± ç¯å¢ƒï¼šå»ºè®®è¾ƒçŸ­ï¼Œé¿å…èµ„æºæµªè´¹

connect_timeoutå»ºè®®ï¼š
â€¢ ä¸€èˆ¬è®¾ç½®ï¼š10-30ç§’
â€¢ ç½‘ç»œè¾ƒå·®ï¼šé€‚å½“å»¶é•¿è‡³60ç§’
```

---

## 3. ğŸŠ è¿æ¥æ± é…ç½®è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± 


**ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**ï¼š
è¿æ¥æ± å°±åƒå…±äº«å•è½¦ç³»ç»Ÿã€‚ä¸æ˜¯æ¯ä¸ªäººéƒ½ä¹°è‡ªè¡Œè½¦ï¼Œè€Œæ˜¯å¤§å®¶å…±ç”¨ä¸€æ‰¹å•è½¦ã€‚ç”¨å®Œå°±è¿˜å›å»ï¼Œåˆ«äººæ¥ç€ç”¨ã€‚æ•°æ®åº“è¿æ¥æ± ä¹Ÿæ˜¯è¿™æ · - é¢„å…ˆåˆ›å»ºä¸€æ‰¹è¿æ¥ï¼Œåº”ç”¨éœ€è¦æ—¶å€Ÿç”¨ï¼Œç”¨å®Œå½’è¿˜ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡éœ€è¦æ—¶åˆ›å»ºè¿æ¥ â†’ ä½¿ç”¨ â†’ å…³é—­
è¿æ¥æ± æ–¹å¼ï¼šé¢„åˆ›å»ºè¿æ¥æ±  â†’ å€Ÿç”¨è¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜è¿æ¥
```

### 3.2 è¿æ¥æ± æ ¸å¿ƒå‚æ•°é…ç½®


**ğŸ”§ HikariCPè¿æ¥æ± ç¤ºä¾‹**ï¼š

```java
// ç²¾ç®€ä½†å®Œå¤‡çš„è¿æ¥æ± é…ç½®
@Configuration
public class DatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
        config.setUsername("user");
        config.setPassword("password");
        
        // æ ¸å¿ƒå‚æ•°
        config.setMaximumPoolSize(20);           // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);                // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);     // è·å–è¿æ¥è¶…æ—¶(æ¯«ç§’)
        config.setIdleTimeout(600000);          // ç©ºé—²è¿æ¥è¶…æ—¶(10åˆ†é’Ÿ)
        config.setMaxLifetime(1800000);         // è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´(30åˆ†é’Ÿ)
        
        return new HikariDataSource(config);
    }
}
```

**ğŸ“Š å‚æ•°é…ç½®æŒ‡å—**ï¼š

| å‚æ•° | **æ¨èå€¼** | **è¯´æ˜** |
|-----|----------|---------|
| `maximumPoolSize` | `CPUæ ¸æ•° Ã— 2 + ç£ç›˜æ•°` | æœ€å¤§è¿æ¥æ•°ï¼Œé¿å…è¿‡å¤§é€ æˆèµ„æºæµªè´¹ |
| `minimumIdle` | `maximumPoolSize Ã· 2` | ä¿æŒè¶³å¤Ÿç©ºé—²è¿æ¥ï¼Œåº”å¯¹çªå‘è¯·æ±‚ |
| `connectionTimeout` | `30ç§’` | è·å–è¿æ¥çš„ç­‰å¾…æ—¶é—´ |
| `idleTimeout` | `10-30åˆ†é’Ÿ` | ç©ºé—²è¿æ¥å›æ”¶æ—¶é—´ |
| `maxLifetime` | `30åˆ†é’Ÿ-2å°æ—¶` | è¿æ¥æœ€é•¿å­˜æ´»æ—¶é—´ï¼Œå®šæœŸåˆ·æ–° |

---

## 4. ğŸ”Œ ç½‘ç»œè¿æ¥ä¸­æ–­å¤„ç†


### 4.1 ç½‘ç»œä¸­æ–­çš„å¸¸è§åœºæ™¯


**ğŸ’¡ å®é™…åœºæ™¯ç†è§£**ï¼š
å°±åƒæ‰“ç”µè¯æ—¶ä¿¡å·ä¸­æ–­ï¼Œæ•°æ®åº“è¿æ¥ä¹Ÿä¼šå› ä¸ºç½‘ç»œé—®é¢˜æ–­å¼€ã€‚å¸¸è§æƒ…å†µï¼š

```
ç‰©ç†ç½‘ç»œé—®é¢˜ï¼š
â€¢ ç½‘çº¿æ¾åŠ¨ã€äº¤æ¢æœºæ•…éšœ
â€¢ ç½‘ç»œæ‹¥å¡ã€ä¸¢åŒ…ç‡é«˜

é˜²ç«å¢™/NATé—®é¢˜ï¼š
â€¢ é˜²ç«å¢™å…³é—­é•¿æ—¶é—´ç©ºé—²è¿æ¥
â€¢ NATä¼šè¯è¶…æ—¶

MySQLæœåŠ¡é—®é¢˜ï¼š
â€¢ MySQLé‡å¯
â€¢ æœåŠ¡å™¨èµ„æºä¸è¶³
```

### 4.2 è¿æ¥ä¸­æ–­æ£€æµ‹ä¸æ¢å¤


**ğŸ” æ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§**ï¼š

```java
// è¿æ¥æœ‰æ•ˆæ€§æ£€æŸ¥
public boolean isConnectionValid(Connection conn) {
    try {
        // æ–¹æ³•1ï¼šä½¿ç”¨isValid()æ–¹æ³•ï¼ˆæ¨èï¼‰
        return conn.isValid(5); // 5ç§’è¶…æ—¶
        
        // æ–¹æ³•2ï¼šæ‰§è¡Œç®€å•æŸ¥è¯¢
        // PreparedStatement ps = conn.prepareStatement("SELECT 1");
        // ps.executeQuery();
        // return true;
    } catch (SQLException e) {
        return false;
    }
}
```

**âš¡ è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼š

```properties
# JDBC URLå‚æ•°é…ç½®
jdbc:mysql://localhost:3306/test?
  autoReconnect=true&           # è‡ªåŠ¨é‡è¿
  failOverReadOnly=false&       # é‡è¿åä¿æŒè¯»å†™çŠ¶æ€
  maxReconnects=3&              # æœ€å¤§é‡è¿æ¬¡æ•°
  initialTimeout=2&             # åˆå§‹é‡è¿é—´éš”(ç§’)
  connectTimeout=60000&         # è¿æ¥è¶…æ—¶(æ¯«ç§’)
  socketTimeout=60000           # Socketè¶…æ—¶(æ¯«ç§’)
```

---

## 5. ğŸ”’ SSLè¿æ¥æ•…éšœæ’æŸ¥


### 5.1 SSLè¿æ¥åŸºç¡€ç†è§£


**ğŸ’¡ SSLæ˜¯ä»€ä¹ˆ**ï¼š
SSLå°±åƒç»™æ•°æ®åº“è¿æ¥åŠ äº†ä¸€æŠŠé”ï¼Œæ•°æ®ä¼ è¾“æ—¶ä¼šåŠ å¯†ï¼Œé˜²æ­¢è¢«å·å¬ã€‚ä½†åŠ é”è¿‡ç¨‹å¯èƒ½å‡ºç°é—®é¢˜ã€‚

```
SSLè¿æ¥æµç¨‹ï¼š
1. å®¢æˆ·ç«¯è¯·æ±‚SSLè¿æ¥
2. æœåŠ¡å™¨å‘é€SSLè¯ä¹¦
3. å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
4. å»ºç«‹åŠ å¯†é€šé“
5. å¼€å§‹å®‰å…¨æ•°æ®ä¼ è¾“
```

### 5.2 SSLæ•…éšœè¯Šæ–­æ­¥éª¤


**ğŸ” æ£€æŸ¥SSLé…ç½®**ï¼š

```sql
-- æ£€æŸ¥MySQL SSLçŠ¶æ€
SHOW VARIABLES LIKE '%ssl%';
SHOW STATUS LIKE 'Ssl%';

-- æŸ¥çœ‹SSLè¯ä¹¦ä¿¡æ¯
SELECT * FROM performance_schema.session_status 
WHERE VARIABLE_NAME IN ('Ssl_cipher', 'Ssl_version');
```

**ğŸ”§ å¸¸è§SSLé—®é¢˜è§£å†³**ï¼š

```java
// Javaåº”ç”¨SSLè¿æ¥é…ç½®
String url = "jdbc:mysql://localhost:3306/test?" +
    "useSSL=true&" +                          // å¯ç”¨SSL
    "verifyServerCertificate=false&" +        // è·³è¿‡è¯ä¹¦éªŒè¯ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
    "trustCertificateKeyStoreUrl=file:///path/to/truststore&" +
    "trustCertificateKeyStorePassword=password";
```

**âš ï¸ SSLé—®é¢˜æ’æŸ¥æ¸…å•**ï¼š
```
âœ… MySQLæœåŠ¡å™¨æ˜¯å¦å¯ç”¨SSL
âœ… SSLè¯ä¹¦æ˜¯å¦è¿‡æœŸ
âœ… å®¢æˆ·ç«¯æ˜¯å¦ä¿¡ä»»æœåŠ¡å™¨è¯ä¹¦
âœ… é˜²ç«å¢™æ˜¯å¦é˜»æ­¢SSLç«¯å£
âœ… åº”ç”¨ç¨‹åºSSLé…ç½®æ˜¯å¦æ­£ç¡®
```

---

## 6. ğŸ‘¤ ç”¨æˆ·è¿æ¥é™åˆ¶ç®¡ç†


### 6.1 ç†è§£ç”¨æˆ·è¿æ¥é™åˆ¶


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦é™åˆ¶**ï¼š
å°±åƒé™åˆ¶æ¯ä¸ªå‘˜å·¥æœ€å¤šå€Ÿç”¨3æŠŠå…¬å¸é’¥åŒ™ï¼Œé¿å…æŸä¸ªäººå ç”¨å¤ªå¤šèµ„æºå½±å“å…¶ä»–äººã€‚MySQLä¹Ÿå¯ä»¥é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„è¿æ¥æ•°ã€‚

```sql
-- æŸ¥çœ‹ç”¨æˆ·è¿æ¥é™åˆ¶
SELECT User, Host, max_connections, max_user_connections 
FROM mysql.user WHERE User = 'your_user';

-- æŸ¥çœ‹å½“å‰å„ç”¨æˆ·è¿æ¥æ•°
SELECT USER, COUNT(*) as connection_count 
FROM information_schema.PROCESSLIST 
GROUP BY USER ORDER BY connection_count DESC;
```

### 6.2 è®¾ç½®ç”¨æˆ·è¿æ¥é™åˆ¶


**ğŸ”§ é…ç½®ç”¨æˆ·é™åˆ¶**ï¼š

```sql
-- åˆ›å»ºé™åˆ¶è¿æ¥æ•°çš„ç”¨æˆ·
CREATE USER 'app_user'@'%' IDENTIFIED BY 'password'
WITH MAX_CONNECTIONS_PER_HOUR 100      -- æ¯å°æ—¶æœ€å¤š100ä¸ªè¿æ¥
     MAX_USER_CONNECTIONS 10;          -- åŒæ—¶æœ€å¤š10ä¸ªè¿æ¥

-- ä¿®æ”¹ç°æœ‰ç”¨æˆ·çš„è¿æ¥é™åˆ¶
ALTER USER 'existing_user'@'%' 
WITH MAX_USER_CONNECTIONS 20;

-- å…¨å±€ç”¨æˆ·è¿æ¥é™åˆ¶ï¼ˆå½±å“æ‰€æœ‰ç”¨æˆ·ï¼‰
SET GLOBAL max_user_connections = 50;
```

**ğŸ“Š è¿æ¥é™åˆ¶ç­–ç•¥**ï¼š

| ç”¨æˆ·ç±»å‹ | **å»ºè®®è¿æ¥æ•°** | **ä½¿ç”¨åœºæ™¯** |
|---------|-------------|------------|
| `åº”ç”¨ç”¨æˆ·` | `10-50` | åº”ç”¨ç¨‹åºè¿æ¥æ± ä½¿ç”¨ |
| `åªè¯»ç”¨æˆ·` | `5-20` | æŠ¥è¡¨æŸ¥è¯¢ã€æ•°æ®åˆ†æ |
| `ç®¡ç†å‘˜ç”¨æˆ·` | `5-10` | è¿ç»´ç®¡ç†ï¼Œç´§æ€¥å¤„ç† |
| `ç›‘æ§ç”¨æˆ·` | `2-5` | ç›‘æ§ç³»ç»Ÿä¸“ç”¨ |

---

## 7. ğŸ§µ è¿æ¥çº¿ç¨‹å¼‚å¸¸è¯Šæ–­


### 7.1 ç†è§£MySQLè¿æ¥çº¿ç¨‹


**ğŸ’¡ çº¿ç¨‹æ˜¯ä»€ä¹ˆ**ï¼š
æ¯ä¸ªæ•°æ®åº“è¿æ¥éƒ½å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ï¼Œå°±åƒæ¯ä¸ªç”µè¯å¯¹åº”ä¸€æ¡ç”µè¯çº¿ã€‚çº¿ç¨‹å¼‚å¸¸å°±æ˜¯ç”µè¯çº¿å‡ºäº†é—®é¢˜ï¼Œå¯¼è‡´é€šè¯ä¸­æ–­ã€‚

```sql
-- æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€
SHOW PROCESSLIST;

-- è¯¦ç»†çº¿ç¨‹ä¿¡æ¯
SELECT 
    ID,                    -- çº¿ç¨‹ID
    USER,                  -- ç”¨æˆ·å
    HOST,                  -- å®¢æˆ·ç«¯åœ°å€
    DB,                    -- å½“å‰æ•°æ®åº“
    COMMAND,               -- å½“å‰å‘½ä»¤
    TIME,                  -- è¿è¡Œæ—¶é—´(ç§’)
    STATE,                 -- çº¿ç¨‹çŠ¶æ€
    INFO                   -- æ‰§è¡Œçš„SQLè¯­å¥
FROM information_schema.PROCESSLIST
ORDER BY TIME DESC;
```

### 7.2 å¸¸è§çº¿ç¨‹å¼‚å¸¸å¤„ç†


**ğŸ” å¼‚å¸¸çº¿ç¨‹è¯†åˆ«**ï¼š

```sql
-- æŸ¥æ‰¾é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
SELECT * FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep' 
AND TIME > 300                    -- è¶…è¿‡5åˆ†é’Ÿ
ORDER BY TIME DESC;

-- æŸ¥æ‰¾é”ç­‰å¾…çš„çº¿ç¨‹
SELECT * FROM information_schema.PROCESSLIST 
WHERE STATE LIKE '%lock%'
OR STATE LIKE '%Waiting%';
```

**âš¡ å¤„ç†å¼‚å¸¸çº¿ç¨‹**ï¼š

```sql
-- ç»ˆæ­¢ç‰¹å®šçº¿ç¨‹
KILL QUERY 123;        -- åªç»ˆæ­¢æŸ¥è¯¢ï¼Œä¿æŒè¿æ¥
KILL CONNECTION 123;   -- ç»ˆæ­¢è¿æ¥

-- æ‰¹é‡ç»ˆæ­¢å¼‚å¸¸çº¿ç¨‹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SELECT CONCAT('KILL CONNECTION ', ID, ';') as kill_sql
FROM information_schema.PROCESSLIST 
WHERE USER = 'problem_user' 
AND TIME > 1800;       -- è¶…è¿‡30åˆ†é’Ÿçš„è¿æ¥
```

---

## 8. ğŸ” è¿æ¥æ³„æ¼æ£€æµ‹ä¸ä¿®å¤


### 8.1 ä»€ä¹ˆæ˜¯è¿æ¥æ³„æ¼


**ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**ï¼š
è¿æ¥æ³„æ¼å°±åƒå€Ÿä¹¦ä¸è¿˜ã€‚ç¨‹åºä»è¿æ¥æ± å€Ÿäº†è¿æ¥ï¼Œç”¨å®Œåå¿˜è®°å½’è¿˜ï¼Œä¹…è€Œä¹…ä¹‹è¿æ¥æ± è¢«æç©ºï¼Œæ–°çš„è¯·æ±‚å°±æ— æ³•è·å–è¿æ¥ã€‚

```
æ­£å¸¸æµç¨‹ï¼šå€Ÿè¿æ¥ â†’ ä½¿ç”¨ â†’ å½’è¿˜
æ³„æ¼æµç¨‹ï¼šå€Ÿè¿æ¥ â†’ ä½¿ç”¨ â†’ å¿˜è®°å½’è¿˜ â†’ è¿æ¥ä¸¢å¤±
```

### 8.2 è¿æ¥æ³„æ¼æ£€æµ‹æ–¹æ³•


**ğŸ” åº”ç”¨å±‚æ£€æµ‹**ï¼š

```java
// HikariCPè¿æ¥æ± ç›‘æ§
@Component
public class ConnectionPoolMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @EventListener
    @Async
    public void checkConnectionLeak() {
        HikariPoolMXBean poolBean = dataSource.getHikariPoolMXBean();
        
        int activeConnections = poolBean.getActiveConnections();
        int idleConnections = poolBean.getIdleConnections();
        int totalConnections = poolBean.getTotalConnections();
        
        System.out.println("æ´»è·ƒè¿æ¥: " + activeConnections);
        System.out.println("ç©ºé—²è¿æ¥: " + idleConnections);
        System.out.println("æ€»è¿æ¥æ•°: " + totalConnections);
        
        // å¦‚æœæ´»è·ƒè¿æ¥æŒç»­å¢é•¿ä¸”ä¸é‡Šæ”¾ï¼Œå¯èƒ½å­˜åœ¨æ³„æ¼
        if (activeConnections > totalConnections * 0.8) {
            System.out.println("è­¦å‘Šï¼šæ´»è·ƒè¿æ¥æ•°è¿‡é«˜ï¼Œå¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼ï¼");
        }
    }
}
```

**ğŸ“Š æ•°æ®åº“å±‚æ£€æµ‹**ï¼š

```sql
-- ç›‘æ§è¿æ¥æ•°å˜åŒ–è¶‹åŠ¿
SELECT 
    DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:00') as time_slot,
    COUNT(*) as connection_count
FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep'
GROUP BY time_slot
ORDER BY time_slot DESC;
```

### 8.3 ä¿®å¤è¿æ¥æ³„æ¼


**ğŸ”§ ä»£ç å±‚é¢ä¿®å¤**ï¼š

```java
// æ­£ç¡®çš„è¿æ¥ä½¿ç”¨æ–¹å¼
public class DataAccessExample {
    
    @Autowired
    private DataSource dataSource;
    
    // æ¨èï¼šä½¿ç”¨try-with-resourcesè‡ªåŠ¨å…³é—­
    public List<User> getUsers() {
        String sql = "SELECT * FROM users";
        List<User> users = new ArrayList<>();
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {
            
            while (rs.next()) {
                users.add(mapToUser(rs));
            }
        } catch (SQLException e) {
            throw new RuntimeException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        }
        
        return users;  // è¿æ¥è‡ªåŠ¨é‡Šæ”¾
    }
}
```

---

## 9. â™»ï¸ è¿æ¥å¤ç”¨ä¼˜åŒ–ç­–ç•¥


### 9.1 è¿æ¥å¤ç”¨çš„é‡è¦æ€§


**ğŸ’¡ ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥**ï¼š
å»ºç«‹æ•°æ®åº“è¿æ¥å°±åƒå¼€è½¦å»å•†åœºï¼Œå¦‚æœæ¯ä¹°ä¸€æ ·ä¸œè¥¿éƒ½è¦å¼€è½¦å¾€è¿”ä¸€æ¬¡ï¼Œä¼šå¾ˆæµªè´¹æ—¶é—´å’Œæ²¹é’±ã€‚è¿æ¥å¤ç”¨å°±æ˜¯ä¸€æ¬¡å¼€è½¦ä¹°å®Œæ‰€æœ‰ä¸œè¥¿å†å›æ¥ã€‚

```
ä¸å¤ç”¨ï¼šè¯·æ±‚1åˆ›å»ºè¿æ¥â†’ä½¿ç”¨â†’å…³é—­ï¼Œè¯·æ±‚2åˆ›å»ºè¿æ¥â†’ä½¿ç”¨â†’å…³é—­
å¤ç”¨ï¼šåˆ›å»ºè¿æ¥â†’è¯·æ±‚1ä½¿ç”¨â†’è¯·æ±‚2ä½¿ç”¨â†’...â†’ç©ºé—²åå›æ”¶
```

### 9.2 è¿æ¥å¤ç”¨ä¼˜åŒ–é…ç½®


**âš¡ ä¼˜åŒ–è¿æ¥æ± å‚æ•°**ï¼š

```properties
# application.yml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20          # æ ¹æ®å¹¶å‘é‡è°ƒæ•´
      minimum-idle: 5                # ä¿æŒåŸºç¡€è¿æ¥æ•°
      connection-timeout: 20000      # 20ç§’è·å–è¿æ¥è¶…æ—¶
      idle-timeout: 300000           # 5åˆ†é’Ÿç©ºé—²å›æ”¶
      max-lifetime: 1800000          # 30åˆ†é’Ÿæœ€å¤§å­˜æ´»æ—¶é—´
      leak-detection-threshold: 60000 # 1åˆ†é’Ÿè¿æ¥æ³„æ¼æ£€æµ‹
```

**ğŸ”§ åº”ç”¨å±‚ä¼˜åŒ–**ï¼š

```java
@Service
public class OptimizedDataService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // æ‰¹é‡æ“ä½œå‡å°‘è¿æ¥ä½¿ç”¨
    public void batchUpdateUsers(List<User> users) {
        String sql = "UPDATE users SET name = ?, email = ? WHERE id = ?";
        
        jdbcTemplate.batchUpdate(sql, users, users.size(),
            (PreparedStatement ps, User user) -> {
                ps.setString(1, user.getName());
                ps.setString(2, user.getEmail());
                ps.setLong(3, user.getId());
            });
    }
    
    // ä½¿ç”¨äº‹åŠ¡å‡å°‘è¿æ¥å ç”¨æ—¶é—´
    @Transactional
    public void processUserData(Long userId) {
        // æ‰€æœ‰æ“ä½œåœ¨ä¸€ä¸ªè¿æ¥ä¸­å®Œæˆ
        User user = findUserById(userId);
        updateUserStatus(user);
        logUserActivity(userId);
    }
}
```

---

## 10. âš–ï¸ è¿æ¥è´Ÿè½½å‡è¡¡å®è·µ


### 10.1 ä»€ä¹ˆæ˜¯è¿æ¥è´Ÿè½½å‡è¡¡


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
å°±åƒé“¶è¡Œæœ‰å¤šä¸ªçª—å£ï¼Œå®¢æˆ·å¯ä»¥é€‰æ‹©æ’é˜Ÿäººæ•°æœ€å°‘çš„çª—å£åŠä¸šåŠ¡ã€‚æ•°æ®åº“è¿æ¥è´Ÿè½½å‡è¡¡ä¹Ÿæ˜¯è¿™æ ·ï¼Œå°†è¿æ¥åˆ†é…åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ä¸Šï¼Œé¿å…æŸä¸€å°æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚

```
å•ç‚¹è¿æ¥ï¼šæ‰€æœ‰åº”ç”¨ â†’ ä¸»æ•°æ®åº“
è´Ÿè½½å‡è¡¡ï¼šåº”ç”¨1 â†’ æ•°æ®åº“1ï¼Œåº”ç”¨2 â†’ æ•°æ®åº“2ï¼Œåº”ç”¨3 â†’ æ•°æ®åº“1...
```

### 10.2 è¯»å†™åˆ†ç¦»è´Ÿè½½å‡è¡¡


**ğŸ”§ MyBatisé…ç½®ç¤ºä¾‹**ï¼š

```java
@Configuration
public class DataSourceConfig {
    
    // ä¸»æ•°æ®åº“ï¼ˆå†™æ“ä½œï¼‰
    @Bean
    @Primary
    public DataSource masterDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://master-db:3306/test");
        config.setMaximumPoolSize(20);
        return new HikariDataSource(config);
    }
    
    // ä»æ•°æ®åº“ï¼ˆè¯»æ“ä½œï¼‰
    @Bean
    public DataSource slaveDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://slave-db:3306/test");
        config.setMaximumPoolSize(30);  // è¯»æ“ä½œé€šå¸¸æ›´å¤š
        return new HikariDataSource(config);
    }
    
    // åŠ¨æ€æ•°æ®æºè·¯ç”±
    @Bean
    public DataSource routingDataSource() {
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        
        DynamicDataSource routingDataSource = new DynamicDataSource();
        routingDataSource.setTargetDataSources(dataSourceMap);
        routingDataSource.setDefaultTargetDataSource(masterDataSource());
        
        return routingDataSource;
    }
}
```

### 10.3 è¿æ¥æ± è´Ÿè½½å‡è¡¡


**ğŸ“Š å¤šè¿æ¥æ± ç­–ç•¥**ï¼š

```java
@Component
public class ConnectionPoolLoadBalancer {
    
    private List<DataSource> dataSources;
    private AtomicInteger counter = new AtomicInteger(0);
    
    public ConnectionPoolLoadBalancer(List<DataSource> dataSources) {
        this.dataSources = dataSources;
    }
    
    // è½®è¯¢è´Ÿè½½å‡è¡¡
    public DataSource getDataSource() {
        int index = counter.getAndIncrement() % dataSources.size();
        return dataSources.get(index);
    }
    
    // åŠ æƒè´Ÿè½½å‡è¡¡
    public DataSource getWeightedDataSource() {
        // æ ¹æ®è¿æ¥æ± æ´»è·ƒåº¦é€‰æ‹©æœ€ç©ºé—²çš„æ•°æ®æº
        return dataSources.stream()
            .min(Comparator.comparingInt(this::getActiveConnections))
            .orElse(dataSources.get(0));
    }
    
    private int getActiveConnections(DataSource dataSource) {
        if (dataSource instanceof HikariDataSource) {
            return ((HikariDataSource) dataSource)
                .getHikariPoolMXBean()
                .getActiveConnections();
        }
        return 0;
    }
}
```

---

## 11. ğŸ”„ è¿æ¥æ•…éšœè‡ªæ„ˆæœºåˆ¶


### 11.1 ä»€ä¹ˆæ˜¯è‡ªæ„ˆæœºåˆ¶


**ğŸ’¡ è‡ªæ„ˆæœºåˆ¶ç†è§£**ï¼š
å°±åƒäººä½“çš„è‡ªæ„ˆèƒ½åŠ›ï¼Œå°ä¼¤å£ä¼šè‡ªåŠ¨æ„ˆåˆã€‚æ•°æ®åº“è¿æ¥çš„è‡ªæ„ˆæœºåˆ¶èƒ½å¤Ÿè‡ªåŠ¨å‘ç°æ•…éšœè¿æ¥å¹¶ä¿®å¤ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

```
æ•…éšœæ£€æµ‹ â†’ éš”ç¦»æ•…éšœè¿æ¥ â†’ åˆ›å»ºæ–°è¿æ¥ â†’ æ¢å¤æœåŠ¡
```

### 11.2 å®ç°è¿æ¥è‡ªæ„ˆæœºåˆ¶


**âš¡ Spring Bootå¥åº·æ£€æŸ¥**ï¼š

```java
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try (Connection connection = dataSource.getConnection()) {
            if (connection.isValid(5)) {  // 5ç§’è¶…æ—¶æ£€æŸ¥
                return Health.up()
                    .withDetail("database", "Available")
                    .withDetail("validationQuery", "SELECT 1")
                    .build();
            }
        } catch (SQLException e) {
            return Health.down()
                .withDetail("database", "Unavailable")
                .withException(e)
                .build();
        }
        return Health.down().build();
    }
}
```

**ğŸ”§ è‡ªåŠ¨é‡è¯•æœºåˆ¶**ï¼š

```java
@Component
public class DatabaseOperationWithRetry {
    
    @Retryable(
        value = {SQLException.class, DataAccessException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 2000, multiplier = 2)
    )
    public List<User> getUsersWithRetry() throws SQLException {
        // æ•°æ®åº“æ“ä½œï¼Œå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•
        return jdbcTemplate.query("SELECT * FROM users", 
            (rs, rowNum) -> mapToUser(rs));
    }
    
    @Recover
    public List<User> recoverGetUsers(SQLException ex) {
        // é‡è¯•å¤±è´¥åçš„æ¢å¤é€»è¾‘
        log.error("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œå¯ç”¨ç¼“å­˜æ•°æ®", ex);
        return getCachedUsers();  // è¿”å›ç¼“å­˜æ•°æ®
    }
}
```

### 11.3 æ•…éšœè½¬ç§»é…ç½®


**ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼š

```properties
# JDBC URLæ•…éšœè½¬ç§»é…ç½®
jdbc:mysql://primary-db:3306,secondary-db:3306/test?
  autoReconnect=true&
  failOverReadOnly=false&
  retriesAllDown=3&
  loadBalanceStrategy=random&
  ha.enableJMX=true
```

---

## 12. ğŸ›¡ï¸ è¿æ¥å®‰å…¨åŠ å›ºæªæ–½


### 12.1 è¿æ¥å®‰å…¨å¨èƒè¯†åˆ«


**âš ï¸ å¸¸è§å®‰å…¨å¨èƒ**ï¼š
```
è¿æ¥åŠ«æŒï¼šæ”»å‡»è€…æˆªè·æ•°æ®åº“è¿æ¥ï¼Œçªƒå–æ•æ„Ÿæ•°æ®
æš´åŠ›ç ´è§£ï¼šå°è¯•ä¸åŒå¯†ç ç»„åˆç ´è§£æ•°æ®åº“è´¦æˆ·
SQLæ³¨å…¥ï¼šé€šè¿‡æ¶æ„SQLè¯­å¥è·å–æ•°æ®åº“æƒé™
è¿æ¥æ³„éœ²ï¼šè¿æ¥å­—ç¬¦ä¸²åŒ…å«æ•æ„Ÿä¿¡æ¯è¢«æ³„éœ²
```

### 12.2 è¿æ¥å®‰å…¨åŠ å›ºç­–ç•¥


**ğŸ”’ SSL/TLSåŠ å¯†é…ç½®**ï¼š

```properties
# å¼ºåˆ¶SSLè¿æ¥
spring.datasource.url=jdbc:mysql://localhost:3306/test?
  useSSL=true&
  requireSSL=true&
  verifyServerCertificate=true&
  useUnicode=true&
  characterEncoding=utf8&
  serverTimezone=Asia/Shanghai
```

**ğŸ” è¿æ¥å‡­æ®å®‰å…¨ç®¡ç†**ï¼š

```java
@Configuration
public class SecurityDataSourceConfig {
    
    // ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
    @Value("${DB_HOST:localhost}")
    private String dbHost;
    
    @Value("${DB_PASSWORD:}")
    private String dbPassword;
    
    @Bean
    public DataSource secureDataSource() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€é…ç½®
        config.setJdbcUrl("jdbc:mysql://" + dbHost + ":3306/test");
        config.setUsername("app_user");
        config.setPassword(dbPassword);  // ä»ç¯å¢ƒå˜é‡è·å–
        
        // å®‰å…¨é…ç½®
        config.addDataSourceProperty("useSSL", "true");
        config.addDataSourceProperty("requireSSL", "true");
        config.addDataSourceProperty("allowPublicKeyRetrieval", "false");
        
        // è¿æ¥è¶…æ—¶ä¿æŠ¤
        config.setConnectionTimeout(10000);     // 10ç§’è¿æ¥è¶…æ—¶
        config.setLeakDetectionThreshold(60000); // 1åˆ†é’Ÿæ³„æ¼æ£€æµ‹
        
        return new HikariDataSource(config);
    }
}
```

### 12.3 è®¿é—®æ§åˆ¶ä¸å®¡è®¡


**ğŸ‘¤ ç”¨æˆ·æƒé™æœ€å°åŒ–**ï¼š

```sql
-- åˆ›å»ºä¸“ç”¨åº”ç”¨ç”¨æˆ·ï¼Œåªæˆäºˆå¿…è¦æƒé™
CREATE USER 'app_readonly'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON business.* TO 'app_readonly'@'%';

CREATE USER 'app_readwrite'@'%' IDENTIFIED BY 'strong_password'; 
GRANT SELECT, INSERT, UPDATE ON business.* TO 'app_readwrite'@'%';

-- é™åˆ¶è¿æ¥æ¥æº
CREATE USER 'app_user'@'192.168.1.%' IDENTIFIED BY 'password';  -- åªå…è®¸ç‰¹å®šç½‘æ®µ
```

**ğŸ“‹ è¿æ¥å®¡è®¡æ—¥å¿—**ï¼š

```sql
-- å¯ç”¨è¿æ¥æ—¥å¿—è®°å½•
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/var/log/mysql/connections.log';

-- æŸ¥çœ‹è¿æ¥å†å²
SELECT 
    event_time,
    user_host,
    thread_id,
    server_id,
    command_type,
    argument
FROM mysql.general_log 
WHERE command_type = 'Connect'
ORDER BY event_time DESC 
LIMIT 100;
```

---

## 13. ğŸ“Š è¿æ¥ç›‘æ§æœ€ä½³å®è·µ


### 13.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§ç»´åº¦**ï¼š

```
è¿æ¥æ•°æŒ‡æ ‡ï¼š
â€¢ å½“å‰è¿æ¥æ•° vs æœ€å¤§è¿æ¥æ•°
â€¢ æ´»è·ƒè¿æ¥æ•° vs ç©ºé—²è¿æ¥æ•°  
â€¢ è¿æ¥ä½¿ç”¨ç‡è¶‹åŠ¿

æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ è¿æ¥å»ºç«‹è€—æ—¶
â€¢ è¿æ¥ç­‰å¾…æ—¶é—´
â€¢ è¿æ¥å¤ç”¨ç‡

å¼‚å¸¸æŒ‡æ ‡ï¼š
â€¢ è¿æ¥å¤±è´¥æ¬¡æ•°
â€¢ è¿æ¥è¶…æ—¶æ¬¡æ•°
â€¢ è¿æ¥æ³„æ¼å‘Šè­¦
```

### 13.2 ç›‘æ§å®ç°æ–¹æ¡ˆ


**ğŸ“Š åº”ç”¨ç›‘æ§ä»£ç **ï¼š

```java
@Component
public class ConnectionPoolMetrics {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 30000)  // æ¯30ç§’ç›‘æ§ä¸€æ¬¡
    public void recordMetrics() {
        HikariPoolMXBean poolBean = dataSource.getHikariPoolMXBean();
        
        // è®°å½•å…³é”®æŒ‡æ ‡
        int totalConnections = poolBean.getTotalConnections();
        int activeConnections = poolBean.getActiveConnections();
        int idleConnections = poolBean.getIdleConnections();
        int waitingThreads = poolBean.getThreadsAwaitingConnection();
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿï¼ˆPrometheusã€InfluxDBç­‰ï¼‰
        recordGauge("db.connections.total", totalConnections);
        recordGauge("db.connections.active", activeConnections);
        recordGauge("db.connections.idle", idleConnections);
        recordGauge("db.connections.waiting", waitingThreads);
        
        // å¼‚å¸¸å‘Šè­¦
        double usageRate = (double) activeConnections / totalConnections;
        if (usageRate > 0.8) {
            sendAlert("æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜: " + String.format("%.2f%%", usageRate * 100));
        }
    }
    
    private void recordGauge(String name, double value) {
        // å®ç°æŒ‡æ ‡è®°å½•é€»è¾‘
    }
    
    private void sendAlert(String message) {
        // å®ç°å‘Šè­¦é€šçŸ¥é€»è¾‘
    }
}
```

### 13.3 ç›‘æ§å‘Šè­¦é…ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: mysql_connection_alerts
    rules:
    - alert: HighConnectionUsage
      expr: mysql_connections_active / mysql_connections_max > 0.8
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "MySQLè¿æ¥ä½¿ç”¨ç‡è¿‡é«˜"
        description: "æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰å€¼: {{ $value }}"
        
    - alert: ConnectionLeakDetected  
      expr: mysql_connections_active > mysql_connections_active offset 5m
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "æ£€æµ‹åˆ°è¿æ¥æ³„æ¼"
        description: "æ´»è·ƒè¿æ¥æ•°æŒç»­å¢é•¿ï¼Œå¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼"

    - alert: ConnectionTimeoutHigh
      expr: mysql_connection_errors_timeout_rate > 0.1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "è¿æ¥è¶…æ—¶ç‡è¿‡é«˜"
        description: "è¿æ¥è¶…æ—¶é”™è¯¯ç‡è¶…è¿‡10%"
```

---

## 14. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 14.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿æ¥æ± æœ¬è´¨ï¼šé¢„åˆ›å»ºè¿æ¥ä¾›åº”ç”¨å¤ç”¨ï¼Œé¿å…é¢‘ç¹å»ºç«‹/å…³é—­è¿æ¥
ğŸ”¸ è¿æ¥æ³„æ¼ï¼šç¨‹åºè·å–è¿æ¥åå¿˜è®°é‡Šæ”¾ï¼Œå¯¼è‡´è¿æ¥æ± èµ„æºè€—å°½
ğŸ”¸ è¶…æ—¶è®¾ç½®ï¼šæ§åˆ¶è¿æ¥å»ºç«‹ã€ç©ºé—²ç­‰å¾…ã€æ•°æ®ä¼ è¾“çš„æ—¶é—´é™åˆ¶
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå°†è¿æ¥è¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“å®ä¾‹ï¼Œæé«˜å¯ç”¨æ€§
ğŸ”¸ è‡ªæ„ˆæœºåˆ¶ï¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æ•…éšœè¿æ¥ï¼Œå‡å°‘äººå·¥å¹²é¢„
ğŸ”¸ å®‰å…¨åŠ å›ºï¼šé€šè¿‡SSLåŠ å¯†ã€æƒé™æ§åˆ¶ã€å®¡è®¡æ—¥å¿—ä¿æŠ¤è¿æ¥å®‰å…¨
```

### 14.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿æ¥æ•°è€—å°½çš„æœ¬è´¨**ï¼š
```
æ ¹æœ¬åŸå› ï¼šè¿æ¥ä¾›ä¸åº”æ±‚
ç›´æ¥åŸå› ï¼šmax_connectionsè®¾ç½®ä¸å½“ã€è¿æ¥æ³„æ¼ã€æ…¢æŸ¥è¯¢å ç”¨
è§£å†³æ€è·¯ï¼šå¢åŠ è¿æ¥æ•°ã€ä¼˜åŒ–è¿æ¥ä½¿ç”¨ã€æ¸…ç†å¼‚å¸¸è¿æ¥
```

**ğŸ”¹ è¿æ¥æ± é…ç½®åŸåˆ™**ï¼š
```
å¤§å°è®¾ç½®ï¼šæ ¹æ®å¹¶å‘é‡å’Œæ•°æ®åº“æ€§èƒ½ç¡®å®šï¼Œä¸æ˜¯è¶Šå¤§è¶Šå¥½
è¶…æ—¶é…ç½®ï¼šå¹³è¡¡å“åº”é€Ÿåº¦å’Œèµ„æºåˆ©ç”¨ç‡
ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å¼‚å¸¸ï¼Œé¢„é˜²æ•…éšœå‘ç”Ÿ
```

**ğŸ”¹ è¿æ¥å®‰å…¨çš„é‡è¦æ€§**ï¼š
```
åŠ å¯†ä¼ è¾“ï¼šé˜²æ­¢æ•°æ®è¢«çªƒå¬
æƒé™æœ€å°åŒ–ï¼šå‡å°‘æ”»å‡»é¢
å®¡è®¡æ—¥å¿—ï¼šè¿½è¸ªå¼‚å¸¸è®¿é—®
ç¯å¢ƒéš”ç¦»ï¼šæ•æ„Ÿä¿¡æ¯ä¸ç¡¬ç¼–ç 
```

### 14.3 å®æˆ˜åº”ç”¨æŒ‡å¯¼


**âœ… è¿æ¥é—®é¢˜é¢„é˜²æ¸…å•**ï¼š
```
é…ç½®æ£€æŸ¥ï¼š
â–¡ max_connectionsæ˜¯å¦åˆç†ï¼ˆå»ºè®®200-1000ï¼‰
â–¡ è¿æ¥æ± å¤§å°æ˜¯å¦é€‚å½“ï¼ˆå»ºè®®CPUæ ¸æ•°Ã—2+ç£ç›˜æ•°ï¼‰
â–¡ è¶…æ—¶å‚æ•°æ˜¯å¦é…ç½®ï¼ˆwait_timeoutå»ºè®®5-30åˆ†é’Ÿï¼‰

ä»£ç è§„èŒƒï¼š
â–¡ ä½¿ç”¨try-with-resourcesç¡®ä¿è¿æ¥é‡Šæ”¾
â–¡ é¿å…é•¿äº‹åŠ¡å ç”¨è¿æ¥
â–¡ å®ç°è¿æ¥å¥åº·æ£€æŸ¥

ç›‘æ§å‘Šè­¦ï¼š
â–¡ è¿æ¥ä½¿ç”¨ç‡ç›‘æ§ï¼ˆè¶…è¿‡80%å‘Šè­¦ï¼‰
â–¡ è¿æ¥æ³„æ¼æ£€æµ‹ï¼ˆæ´»è·ƒè¿æ¥æŒç»­å¢é•¿ï¼‰
â–¡ å“åº”æ—¶é—´ç›‘æ§ï¼ˆè¿æ¥è·å–è€—æ—¶è¿‡é•¿ï¼‰
```

**ğŸ”§ æ•…éšœæ’æŸ¥æ­¥éª¤**ï¼š
```
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ç¡®å®šé—®é¢˜ç±»å‹
2. æ£€æŸ¥å½“å‰è¿æ¥æ•°å’Œæœ€å¤§è¿æ¥æ•°
3. è¯†åˆ«å¼‚å¸¸è¿æ¥ï¼ˆé•¿æ—¶é—´è¿è¡Œã€é”ç­‰å¾…ï¼‰
4. åˆ†æåº”ç”¨ä»£ç æ˜¯å¦æœ‰è¿æ¥æ³„æ¼
5. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒSSLé…ç½®
6. ä¼˜åŒ–è¿æ¥æ± å’Œæ•°æ®åº“å‚æ•°
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¿æ¥æ˜¯æœ‰é™èµ„æºï¼Œç”¨å®Œå¿…é¡»å½’è¿˜
- è¿æ¥æ± æ˜¯å…±äº«èµ„æºï¼Œéœ€è¦åˆç†é…ç½®å’Œç›‘æ§
- ç½‘ç»œä¸å¯é ï¼Œè¿æ¥å¯èƒ½ä¸­æ–­ï¼Œè¦æœ‰é‡è¯•æœºåˆ¶
- å®‰å…¨ç¬¬ä¸€ï¼Œè¿æ¥ä¿¡æ¯è¦åŠ å¯†å’Œä¿æŠ¤
- ç›‘æ§å‘Šè­¦æ˜¯é¢„é˜²æ•…éšœçš„ç¬¬ä¸€é“é˜²çº¿