---
title: 7、磁盘空间故障处理
---
## 📚 目录

1. [磁盘空间故障概述](#1-磁盘空间故障概述)
2. [No space left on device错误处理](#2-no-space-left-on-device错误处理)
3. [binlog日志清理策略](#3-binlog日志清理策略)
4. [临时文件清理方案](#4-临时文件清理方案)
5. [表空间扩展失败处理](#5-表空间扩展失败处理)
6. [数据文件迁移操作](#6-数据文件迁移操作)
7. [磁盘IO错误诊断与修复](#7-磁盘io错误诊断与修复)
8. [磁盘监控与预警机制](#8-磁盘监控与预警机制)
9. [紧急空间释放技巧](#9-紧急空间释放技巧)
10. [数据目录扩容方案](#10-数据目录扩容方案)
11. [磁盘故障恢复流程](#11-磁盘故障恢复流程)
12. [存储空间预警系统](#12-存储空间预警系统)
13. [核心要点总结](#13-核心要点总结)

---

## 1. 💾 磁盘空间故障概述


### 1.1 什么是MySQL磁盘空间故障


**简单理解**：就像家里的储物柜满了，新东西放不进去了。MySQL数据库在运行时需要不断地写入数据、日志文件，当磁盘空间不足时，就会出现各种问题。

**常见表现**：
```
数据库症状：
• 无法插入新数据
• 事务回滚
• 数据库服务异常
• 查询响应缓慢

系统表现：
• "No space left on device" 错误
• 磁盘使用率100%
• 文件创建失败
• 应用程序连接超时
```

### 1.2 磁盘空间故障的危害


**💡 生活类比**：
> 就像手机存储空间满了，不仅无法拍照，连微信都可能卡顿。数据库磁盘满了，影响的不只是新数据写入，整个业务系统都可能瘫痪。

**具体危害**：
- **数据丢失风险**：事务无法完成可能导致数据不一致
- **业务中断**：应用程序无法正常写入数据
- **性能严重下降**：磁盘IO压力导致查询缓慢
- **恢复困难**：备份和恢复操作也需要磁盘空间

### 1.3 故障分类与优先级


| 故障类型 | **紧急程度** | **影响范围** | **处理时间** |
|---------|------------|-------------|-------------|
| 🔴 **数据目录满** | `极高` | `全库停服` | `立即处理` |
| 🟡 **binlog目录满** | `高` | `写入受影响` | `1小时内` |
| 🟢 **临时目录满** | `中` | `复杂查询失败` | `2小时内` |
| 🔵 **备份目录满** | `低` | `备份失败` | `当日处理` |

---

## 2. 🚨 No space left on device错误处理


### 2.1 错误现象识别


**典型错误信息**：
```sql
ERROR 3 (HY000): Error writing file '/tmp/mysql-tmp-file' (Errcode: 28 - No space left on device)

ERROR 1030 (HY000): Got error 28 from storage engine

MySQL服务启动失败：Can't create/write to file '/var/lib/mysql/mysql.log' (Errcode: 28)
```

**快速诊断命令**：
```bash
# 检查磁盘使用情况
df -h

# 查看具体目录占用
du -sh /var/lib/mysql/*

# 检查MySQL进程状态
systemctl status mysql
```

### 2.2 应急处理流程


**🚀 紧急处理步骤**：

**Step 1: 立即评估影响范围**
```bash
# 检查MySQL是否还在运行
ps aux | grep mysql

# 查看当前连接数
mysql -e "SHOW PROCESSLIST;"

# 检查磁盘空间分布
df -h | grep -E "(mysql|tmp|var)"
```

**Step 2: 快速释放空间**
```bash
# 清理MySQL临时文件
rm -f /tmp/mysql-tmp-*
rm -f /tmp/sql_*

# 清理系统临时文件
find /tmp -name "*mysql*" -type f -delete

# 立即清理binlog（谨慎操作）
mysql -e "PURGE BINARY LOGS BEFORE DATE(NOW() - INTERVAL 1 DAY);"
```

**Step 3: 重启服务验证**
```bash
# 重启MySQL服务
systemctl restart mysql

# 验证服务状态
systemctl status mysql

# 测试数据库连接
mysql -e "SELECT 1;"
```

### 2.3 根本原因分析


**磁盘空间耗尽的常见原因**：

```
📊 原因分析图：
数据增长 ────────┐
                │
binlog堆积 ──────┼──► 磁盘空间不足 ──► 服务异常
                │
临时文件残留 ────┘

主要原因占比：
数据文件增长：     ██████████ 40%
binlog日志堆积：   ████████   32%
临时文件残留：     ████       16%
其他系统文件：     ███        12%
```

**详细原因排查**：
```bash
# 分析各目录占用情况
du -sh /var/lib/mysql/*/

# 检查binlog文件大小
ls -lh /var/lib/mysql/mysql-bin.*

# 查找大文件
find /var/lib/mysql -size +1G -exec ls -lh {} \;

# 检查错误日志
tail -100 /var/log/mysql/error.log
```

---

## 3. 📜 binlog日志清理策略


### 3.1 什么是binlog及其作用


**通俗解释**：
> binlog就像银行的交易记录本，记录了所有对数据库的修改操作。它主要用于数据恢复和主从复制。

**binlog的重要性**：
- **数据恢复**：可以通过binlog恢复到任意时间点
- **主从同步**：从库通过读取主库binlog同步数据
- **审计追踪**：记录所有数据变更历史

### 3.2 binlog清理方法


**🔧 安全清理操作**：

**方法1：基于时间清理**
```sql
-- 清理3天前的binlog
PURGE BINARY LOGS BEFORE DATE(NOW() - INTERVAL 3 DAY);

-- 清理到指定时间点
PURGE BINARY LOGS BEFORE '2024-09-05 10:00:00';

-- 查看当前binlog文件
SHOW BINARY LOGS;
```

**方法2：基于文件名清理**
```sql
-- 清理到指定文件（不包含该文件）
PURGE BINARY LOGS TO 'mysql-bin.000010';

-- 查看当前使用的binlog文件
SHOW MASTER STATUS;
```

**方法3：自动清理配置**
```ini
# 在my.cnf中设置自动清理
[mysqld]
# 保留7天的binlog
expire_logs_days = 7

# MySQL 8.0新参数（秒为单位）
binlog_expire_logs_seconds = 604800  # 7天
```

### 3.3 清理注意事项


**⚠️ 重要提醒**：
> **绝对不能**直接用`rm`命令删除binlog文件！这会导致binlog索引混乱，可能造成主从复制中断。

**安全检查清单**：
```
📋 清理前检查
- [ ] 确认主从复制状态正常
- [ ] 备份重要的binlog文件
- [ ] 检查当前活跃的binlog文件
- [ ] 确认是否有基于时间点的恢复需求

清理操作：
- [ ] 使用SQL命令清理，不用系统命令
- [ ] 分批清理，不要一次清理太多
- [ ] 清理后检查主从状态
- [ ] 记录清理日志，便于追踪
```

**主从环境特殊处理**：
```sql
-- 检查从库复制位置
SHOW SLAVE STATUS\G

-- 确保从库已经读取了要删除的binlog
-- 只有当所有从库都读取完某个binlog后，才能安全删除
```

---

## 4. 🗂️ 临时文件清理方案


### 4.1 MySQL临时文件类型


**MySQL会产生哪些临时文件**：

```
临时文件分类：
┌─ MySQL临时文件 ─────────────┐
│ • 排序临时文件（#sql_xxx）  │
│ • 查询结果临时表            │
│ • 复制临时文件              │
│ • 崩溃恢复临时文件          │
└─────────────────────────────┘

存储位置：
/tmp/              ← 系统临时目录
/var/lib/mysql/    ← MySQL数据目录
tmpdir配置目录     ← 自定义临时目录
```

### 4.2 临时文件清理方法


**🧹 安全清理步骤**：

**Step 1: 识别临时文件**
```bash
# 查找MySQL临时文件
find /tmp -name "#sql*" -ls
find /tmp -name "mysql-tmp-*" -ls

# 检查文件是否在使用中
lsof /tmp/#sql*

# 查看临时目录配置
mysql -e "SHOW VARIABLES LIKE 'tmpdir';"
```

**Step 2: 安全删除策略**
```bash
# 删除明显过期的临时文件（修改时间超过1小时）
find /tmp -name "#sql*" -mtime +0.04 -delete
find /tmp -name "mysql-tmp-*" -mtime +0.04 -delete

# 对于正在使用的临时文件，需要先停止相关查询
mysql -e "SHOW PROCESSLIST;" | grep "Copying to tmp table"
```

**Step 3: 预防措施**
```ini
# 在my.cnf中配置临时文件管理
[mysqld]
# 设置专用临时目录
tmpdir = /var/mysql-tmp

# 限制临时表大小
tmp_table_size = 256M
max_heap_table_size = 256M

# 优化查询避免产生大临时文件
sort_buffer_size = 2M
```

### 4.3 临时文件问题排查


**常见问题及解决方案**：

| 问题现象 | **可能原因** | **解决方案** |
|---------|------------|-------------|
| 大量`#sql`文件 | `复杂查询产生临时表` | `优化SQL，增加索引` |
| 临时文件不清理 | `查询异常中断` | `重启MySQL服务` |
| 临时目录满 | `tmpdir空间不足` | `扩容或迁移tmpdir` |
| 权限错误 | `临时目录权限问题` | `修正目录权限` |

**查询优化减少临时文件**：
```sql
-- 检查产生临时表的查询
SELECT * FROM information_schema.PROCESSLIST 
WHERE STATE LIKE '%tmp%';

-- 分析查询执行计划
EXPLAIN FORMAT=JSON 
SELECT * FROM large_table ORDER BY column_name;

-- 优化建议：添加索引避免文件排序
CREATE INDEX idx_column_name ON large_table(column_name);
```

---

## 5. 📦 表空间扩展失败处理


### 5.1 表空间扩展失败现象


**什么是表空间扩展失败**：
> 就像要往一个已经装满的箱子里再放东西，箱子装不下了。MySQL表在增长时需要更多磁盘空间，如果空间不足就会扩展失败。

**典型错误信息**：
```
ERROR 1114 (HY000): The table 'table_name' is full

InnoDB: ERROR: the age of the last checkpoint is 9433645
InnoDB: which exceeds the log group capacity 9433498

Error Code: 1030. Got error 28 from storage engine
```

### 5.2 InnoDB表空间处理


**🔧 InnoDB扩展失败处理**：

**诊断步骤**：
```sql
-- 检查表空间使用情况
SELECT 
    table_schema,
    table_name,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS 'Size(MB)'
FROM information_schema.tables 
WHERE engine = 'InnoDB'
ORDER BY (data_length + index_length) DESC;

-- 检查InnoDB状态
SHOW ENGINE INNODB STATUS;

-- 查看自动扩展设置
SHOW VARIABLES LIKE 'innodb_autoextend_increment';
```

**处理方案**：
```sql
-- 方案1：立即释放空间
OPTIMIZE TABLE large_table;

-- 方案2：修改自动扩展参数
SET GLOBAL innodb_autoextend_increment = 64;  -- 64MB扩展

-- 方案3：独立表空间迁移
ALTER TABLE large_table ENGINE=InnoDB;
```

### 5.3 MyISAM表空间处理


**MyISAM特殊处理**：
```sql
-- 检查MyISAM表状态
CHECK TABLE myisam_table;

-- 修复表空间
REPAIR TABLE myisam_table;

-- 重建表释放空间
ALTER TABLE myisam_table ENGINE=MyISAM;
```

**紧急空间释放**：
```bash
# 压缩MyISAM表
myisampack /var/lib/mysql/db_name/table_name

# 重建索引
myisamchk -rq /var/lib/mysql/db_name/table_name
```

---

## 6. 🚚 数据文件迁移操作


### 6.1 数据迁移前准备


**为什么需要数据迁移**：
> 就像家里东西太多，需要搬到更大的房子。当前磁盘空间不足时，需要将数据文件迁移到空间更大的磁盘。

**🎯 迁移规划**：

**Step 1: 评估迁移需求**
```bash
# 计算所需空间（建议预留50%空间）
du -sh /var/lib/mysql/
df -h

# 选择目标磁盘
df -h | grep -v tmpfs
```

**Step 2: 备份关键配置**
```bash
# 备份MySQL配置文件
cp /etc/mysql/my.cnf /backup/my.cnf.backup

# 备份当前数据库列表
mysql -e "SHOW DATABASES;" > /backup/database_list.txt

# 创建完整备份
mysqldump --all-databases --routines --triggers > /backup/full_backup.sql
```

### 6.2 数据目录迁移步骤


**🚀 完整迁移流程**：

**Step 1: 停止MySQL服务**
```bash
# 优雅停止MySQL
systemctl stop mysql

# 确认服务已停止
ps aux | grep mysql
```

**Step 2: 迁移数据文件**
```bash
# 创建新数据目录
mkdir -p /new/mysql/data
chown mysql:mysql /new/mysql/data
chmod 755 /new/mysql/data

# 迁移数据文件（保持权限）
rsync -av /var/lib/mysql/ /new/mysql/data/

# 验证迁移完整性
diff -r /var/lib/mysql/ /new/mysql/data/
```

**Step 3: 修改配置文件**
```ini
# 编辑 /etc/mysql/my.cnf
[mysqld]
datadir = /new/mysql/data
socket = /new/mysql/data/mysql.sock

# 如果有其他路径配置也要修改
log-error = /new/mysql/data/error.log
pid-file = /new/mysql/data/mysql.pid
```

**Step 4: 启动并验证**
```bash
# 启动MySQL服务
systemctl start mysql

# 验证数据完整性
mysql -e "SHOW DATABASES;"
mysql -e "SELECT COUNT(*) FROM important_table;"

# 检查错误日志
tail -50 /new/mysql/data/error.log
```

### 6.3 部分表迁移方案


**针对单个大表的迁移**：

```sql
-- 方案1：使用符号链接（适用于MyISAM）
-- 停止MySQL，移动表文件，创建软链接

-- 方案2：创建新表并迁移数据
CREATE TABLE new_table LIKE old_table;
INSERT INTO new_table SELECT * FROM old_table;
RENAME TABLE old_table TO old_table_backup, new_table TO old_table;

-- 方案3：使用分区表
ALTER TABLE large_table 
PARTITION BY RANGE (YEAR(date_column)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025)
);
```

---

## 7. 💿 磁盘IO错误诊断与修复


### 7.1 磁盘IO错误识别


**常见IO错误类型**：

```
磁盘错误分类：
┌─ 硬件错误 ─────────────┐  ┌─ 软件错误 ─────────────┐
│ • 磁盘坏道             │  │ • 文件系统错误         │
│ • 磁盘控制器故障       │  │ • 权限问题             │
│ • 连接线缆问题         │  │ • 驱动程序问题         │
└───────────────────────┘  └───────────────────────┘
```

**错误信息识别**：
```bash
# 检查系统日志中的磁盘错误
dmesg | grep -i "error\|fail\|bad"
grep -i "i/o error" /var/log/syslog

# 检查MySQL错误日志
grep -i "error\|corrupt\|crash" /var/log/mysql/error.log

# 检查磁盘健康状态
smartctl -a /dev/sda
```

### 7.2 磁盘健康检测


**🔍 磁盘状态检测**：

```bash
# 基本磁盘信息
fdisk -l
lsblk

# 磁盘健康检测
smartctl -H /dev/sda  # 简单健康检测
smartctl -t short /dev/sda  # 短测试
smartctl -t long /dev/sda   # 长测试

# 实时IO监控
iostat -x 1 10
iotop

# 检查文件系统
fsck -n /dev/sda1  # 只检查不修复
```

### 7.3 IO性能优化


**MySQL IO优化配置**：

```ini
# my.cnf优化配置
[mysqld]
# InnoDB IO优化
innodb_io_capacity = 200
innodb_io_capacity_max = 2000
innodb_read_io_threads = 4
innodb_write_io_threads = 4

# 刷新策略优化
innodb_flush_method = O_DIRECT
innodb_flush_log_at_trx_commit = 2

# 缓冲池优化
innodb_buffer_pool_size = 2G
innodb_buffer_pool_instances = 4
```

**系统级IO优化**：
```bash
# 修改IO调度器
echo deadline > /sys/block/sda/queue/scheduler

# 优化读写队列
echo 128 > /sys/block/sda/queue/nr_requests

# 禁用文件系统访问时间更新
mount -o remount,noatime /var/lib/mysql
```

---

## 8. 📊 磁盘监控与预警机制


### 8.1 监控指标设计


**🎯 关键监控指标**：

| 监控项目 | **警告阈值** | **严重阈值** | **监控频率** |
|---------|------------|-------------|-------------|
| 磁盘使用率 | `85%` | `95%` | `每分钟` |
| 磁盘IO等待 | `20%` | `50%` | `每分钟` |
| 读写延迟 | `20ms` | `100ms` | `每分钟` |
| 错误计数 | `>0` | `>10` | `实时` |

### 8.2 监控脚本实现


**磁盘空间监控脚本**：
```bash
#!/bin/bash
# mysql_disk_monitor.sh

# 配置参数
MYSQL_DATA_DIR="/var/lib/mysql"
WARNING_THRESHOLD=85
CRITICAL_THRESHOLD=95
LOG_FILE="/var/log/mysql_disk_monitor.log"

# 获取磁盘使用率
USAGE=$(df -h $MYSQL_DATA_DIR | awk 'NR==2 {print $5}' | sed 's/%//')

# 记录日志
echo "$(date): MySQL data directory usage: ${USAGE}%" >> $LOG_FILE

# 预警逻辑
if [ $USAGE -gt $CRITICAL_THRESHOLD ]; then
    echo "CRITICAL: MySQL disk usage ${USAGE}% exceeds ${CRITICAL_THRESHOLD}%"
    # 发送紧急通知
    mail -s "CRITICAL: MySQL Disk Full" admin@company.com < /dev/null
elif [ $USAGE -gt $WARNING_THRESHOLD ]; then
    echo "WARNING: MySQL disk usage ${USAGE}% exceeds ${WARNING_THRESHOLD}%"
    # 发送警告通知
fi
```

**IO性能监控**：
```bash
#!/bin/bash
# mysql_io_monitor.sh

# 监控IO等待时间
IO_WAIT=$(iostat -x 1 2 | tail -1 | awk '{print $10}')

# 检查MySQL慢查询
SLOW_QUERIES=$(mysql -e "SHOW GLOBAL STATUS LIKE 'Slow_queries';" | tail -1 | awk '{print $2}')

# 记录并告警
if (( $(echo "$IO_WAIT > 50" | bc -l) )); then
    echo "HIGH IO WAIT: ${IO_WAIT}%"
fi
```

### 8.3 自动化处理机制


**自动清理脚本**：
```bash
#!/bin/bash
# auto_cleanup.sh

MYSQL_DATA_DIR="/var/lib/mysql"
USAGE=$(df $MYSQL_DATA_DIR | tail -1 | awk '{print $5}' | sed 's/%//')

if [ $USAGE -gt 90 ]; then
    echo "Disk usage ${USAGE}%, starting auto cleanup..."
    
    # 自动清理binlog
    mysql -e "PURGE BINARY LOGS BEFORE DATE(NOW() - INTERVAL 3 DAY);"
    
    # 清理临时文件
    find /tmp -name "#sql*" -mtime +0.04 -delete
    
    # 优化表释放空间
    mysql -e "OPTIMIZE TABLE mysql.general_log;"
    
    echo "Auto cleanup completed"
fi
```

---

## 9. 🆘 紧急空间释放技巧


### 9.1 快速空间释放清单


**⚡ 5分钟紧急处理**：

```
紧急处理优先级：
1️⃣ 清理临时文件 ←─ 最快见效
2️⃣ 清理binlog   ←─ 释放大量空间  
3️⃣ 优化表       ←─ 回收碎片空间
4️⃣ 删除备份     ←─ 最后手段
```

**Step 1: 立即释放（30秒内）**
```bash
# 快速清理临时文件
rm -f /tmp/#sql* /tmp/mysql-tmp-*

# 清理错误日志（如果很大）
> /var/log/mysql/error.log

# 清理general log（如果开启）
mysql -e "SET GLOBAL general_log = 'OFF';"
> /var/lib/mysql/general.log
```

**Step 2: 快速清理binlog（2分钟内）**
```sql
-- 查看binlog占用空间
SELECT 
    ROUND(SUM(file_size)/1024/1024/1024, 2) AS 'Binlog Size (GB)'
FROM information_schema.binary_log_files;

-- 紧急清理（保留最近24小时）
PURGE BINARY LOGS BEFORE DATE(NOW() - INTERVAL 1 DAY);
```

**Step 3: 表优化清理（5分钟内）**
```sql
-- 找出最大的表
SELECT 
    table_name,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS 'Size(MB)'
FROM information_schema.tables 
WHERE table_schema = DATABASE()
ORDER BY (data_length + index_length) DESC LIMIT 5;

-- 优化最大的几个表
OPTIMIZE TABLE large_table1, large_table2;
```

### 9.2 深度空间清理


**🔧 进阶清理技巧**：

**清理MySQL系统表**：
```sql
-- 清理慢查询日志表
SET GLOBAL slow_query_log = 'OFF';
TRUNCATE TABLE mysql.slow_log;

-- 清理一般查询日志表
SET GLOBAL general_log = 'OFF';
TRUNCATE TABLE mysql.general_log;

-- 清理performance_schema（谨慎操作）
TRUNCATE TABLE performance_schema.events_statements_history_long;
```

**表碎片整理**：
```sql
-- 检查表碎片情况
SELECT 
    table_name,
    ROUND(data_free/1024/1024, 2) AS 'Fragmentation(MB)'
FROM information_schema.tables 
WHERE data_free > 100*1024*1024;  -- 大于100MB碎片

-- 整理碎片
ALTER TABLE fragmented_table ENGINE=InnoDB;
```

### 9.3 预防性空间管理


**空间使用预测**：
```sql
-- 创建空间监控表
CREATE TABLE disk_usage_history (
    check_time DATETIME,
    total_size_mb DECIMAL(15,2),
    used_size_mb DECIMAL(15,2),
    usage_percent DECIMAL(5,2)
);

-- 定期记录空间使用情况
INSERT INTO disk_usage_history 
SELECT NOW(), 
       total_size/1024/1024,
       used_size/1024/1024,
       (used_size/total_size)*100
FROM (
    SELECT 
        $$datadir as datadir,
        SUM(data_length + index_length) as used_size,
        -- 需要通过系统命令获取总大小
        1000*1024*1024*1024 as total_size  -- 示例：1TB
    FROM information_schema.tables
) t;
```

---

## 10. 📈 数据目录扩容方案


### 10.1 扩容方案选择


**💡 扩容策略对比**：

| 扩容方式 | **实施难度** | **停机时间** | **风险等级** | **适用场景** |
|---------|------------|-------------|-------------|-------------|
| 添加磁盘+LVM | `中等` | `较短` | `低` | `生产环境推荐` |
| 数据迁移 | `高` | `长` | `中` | `彻底解决方案` |
| 分库分表 | `高` | `短` | `高` | `大数据量场景` |
| 云盘扩容 | `低` | `极短` | `低` | `云环境首选` |

### 10.2 LVM扩容操作


**🔧 LVM动态扩容步骤**：

**前提检查**：
```bash
# 检查当前LVM配置
lvdisplay
vgdisplay
pvdisplay

# 确认MySQL数据目录在LVM上
df -h /var/lib/mysql
```

**扩容操作**：
```bash
# Step 1: 添加新磁盘到VG
pvcreate /dev/sdb1
vgextend mysql_vg /dev/sdb1

# Step 2: 扩展逻辑卷
lvextend -L +100G /dev/mysql_vg/mysql_lv

# Step 3: 扩展文件系统
# 对于ext4
resize2fs /dev/mysql_vg/mysql_lv

# 对于xfs
xfs_growfs /var/lib/mysql

# Step 4: 验证扩容结果
df -h /var/lib/mysql
```

### 10.3 云环境扩容


**云盘在线扩容**：
```bash
# 阿里云ECS磁盘扩容
# 1. 在控制台扩容云盘
# 2. 在系统内识别新空间

# 重新扫描磁盘
echo 1 > /sys/class/block/vdb/device/rescan

# 扩展分区（如果使用分区）
growpart /dev/vdb 1

# 扩展文件系统
resize2fs /dev/vdb1

# 验证结果
df -h
```

**AWS EBS扩容**：
```bash
# 修改EBS卷大小后
# 1. 扩展分区
sudo growpart /dev/xvdf 1

# 2. 扩展文件系统
sudo resize2fs /dev/xvdf1

# 3. 验证
df -h
```

---

## 11. 🔄 磁盘故障恢复流程


### 11.1 故障评估与分类


**故障严重程度评估**：

```
故障分级处理：
┌─ Level 1：逻辑错误 ─────┐
│ • 文件系统错误         │ ──► 文件系统修复
│ • 权限问题             │
└───────────────────────┘

┌─ Level 2：软件故障 ─────┐
│ • 驱动问题             │ ──► 重装驱动/系统
│ • 控制器软故障         │
└───────────────────────┘

┌─ Level 3：硬件故障 ─────┐
│ • 磁盘坏道             │ ──► 数据迁移/更换硬件
│ • 控制器硬件故障       │
└───────────────────────┘
```

### 11.2 数据恢复策略


**🚨 紧急恢复流程**：

**Step 1: 故障隔离**
```bash
# 立即停止MySQL服务
systemctl stop mysql

# 挂载磁盘为只读模式
mount -o remount,ro /var/lib/mysql

# 创建故障磁盘镜像
dd if=/dev/sda of=/backup/disk_image.img conv=noerror,sync
```

**Step 2: 数据抢救**
```bash
# 尝试挂载到其他系统
mkdir /recovery
mount -o ro /dev/sdb1 /recovery

# 复制关键数据文件
cp -r /recovery/mysql/important_db /backup/

# 检查数据文件完整性
innochecksum /backup/important_db/table_name.ibd
```

**Step 3: 服务恢复**
```bash
# 在新磁盘上恢复MySQL
# 1. 安装新磁盘
# 2. 创建文件系统
mkfs.ext4 /dev/sdc1

# 3. 恢复数据
mount /dev/sdc1 /var/lib/mysql
cp -r /backup/mysql/* /var/lib/mysql/

# 4. 修正权限
chown -R mysql:mysql /var/lib/mysql

# 5. 启动MySQL并验证
systemctl start mysql
mysql -e "SHOW DATABASES;"
```

### 11.3 预防性措施


**建立完善的备份策略**：
```bash
#!/bin/bash
# full_backup_strategy.sh

# 每日增量备份
innobackupex --incremental /backup/incremental \
    --incremental-basedir=/backup/base

# 每周全量备份  
innobackupex /backup/full/$(date +%Y%m%d)

# 备份到异地存储
rsync -av /backup/ remote_server:/mysql_backup/

# 定期验证备份可用性
innobackupex --apply-log /backup/test_restore/
```

---

## 12. 🔔 存储空间预警系统


### 12.1 预警系统架构


**📊 监控体系设计**：

```
预警系统架构：
┌─ 数据采集层 ─────────────┐
│ • 磁盘使用率监控         │
│ • IO性能监控             │ ──► 数据处理层 ──► 告警通知层
│ • MySQL状态监控         │
└─────────────────────────┘
         │
         ▼
┌─ 历史数据存储 ───────────┐
│ • 趋势分析               │
│ • 容量规划               │
└─────────────────────────┘
```

### 12.2 智能预警规则


**🧠 动态预警阈值**：
```bash
#!/bin/bash
# smart_alerting.sh

# 基于历史数据的动态阈值
calculate_threshold() {
    # 获取过去7天的使用率增长趋势
    GROWTH_RATE=$(mysql -e "
        SELECT AVG(daily_growth) FROM (
            SELECT 
                DATE(check_time) as date,
                MAX(usage_percent) - MIN(usage_percent) as daily_growth
            FROM disk_usage_history 
            WHERE check_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            GROUP BY DATE(check_time)
        ) t")
    
    # 计算动态阈值
    CURRENT_USAGE=$(df /var/lib/mysql | tail -1 | awk '{print $5}' | sed 's/%//')
    DAYS_TO_FULL=$(echo "scale=2; (95 - $CURRENT_USAGE) / $GROWTH_RATE" | bc)
    
    if (( $(echo "$DAYS_TO_FULL < 7" | bc -l) )); then
        echo "CRITICAL: Disk will be full in $DAYS_TO_FULL days"
        # 发送紧急通知
    fi
}
```

### 12.3 预警通知集成


**多渠道通知配置**：
```bash
# 邮件通知
send_email_alert() {
    cat << EOF | mail -s "$1" admin@company.com
MySQL磁盘空间预警

服务器: $(hostname)
时间: $(date)
当前使用率: $2%
预警级别: $1

请及时处理！
EOF
}

# 短信通知（通过API）
send_sms_alert() {
    curl -X POST "https://sms-api.company.com/send" \
        -d "phone=13800138000" \
        -d "message=MySQL磁盘使用率${1}%，请立即处理"
}

# 企业微信通知
send_wechat_alert() {
    curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send" \
        -H "Content-Type: application/json" \
        -d '{
            "msgtype": "text",
            "text": {
                "content": "MySQL磁盘空间告警\n使用率: '${1}'%\n服务器: '$(hostname)'"
            }
        }'
}
```

---

## 13. 📋 核心要点总结


### 13.1 必须掌握的核心操作


```
🎯 磁盘故障处理核心技能：
• No space left on device错误快速诊断
• binlog安全清理方法（绝不用rm删除）
• 临时文件识别与清理
• 表空间扩展失败处理
• 数据文件安全迁移
• 磁盘IO错误诊断
• 紧急空间释放技巧
```

### 13.2 关键理解要点


**🔹 磁盘空间管理的本质**
```
预防优于治疗：
• 建立监控预警体系
• 定期清理维护
• 合理规划容量增长
• 完善备份策略

应急处理原则：
• 快速定位问题根源
• 优先保证服务可用性
• 分步骤安全操作
• 记录处理过程
```

**🔹 常见误区避免**
```
❌ 危险操作：
• 直接rm删除binlog文件
• 强制kill MySQL进程
• 不备份直接迁移数据
• 忽略权限设置

✅ 正确做法：
• 使用SQL命令管理binlog
• 优雅停止服务
• 完整备份后再操作
• 严格权限管理
```

### 13.3 实际应用指导


**💡 最佳实践清单**：
```
📋 日常维护
- [ ] 每日检查磁盘使用率
- [ ] 定期清理binlog和临时文件
- [ ] 监控IO性能指标
- [ ] 验证备份可用性

📋 应急准备
- [ ] 准备应急清理脚本
- [ ] 建立通知联系机制
- [ ] 熟悉快速恢复流程
- [ ] 定期演练故障处理

📋 容量规划
- [ ] 分析数据增长趋势
- [ ] 预留足够的空间buffer
- [ ] 制定扩容计划
- [ ] 考虑分库分表策略
```

### 13.4 故障处理优先级


**🚨 处理优先级排序**：
```
P0 - 立即处理（5分钟内）：
• 数据目录100%满
• MySQL服务停止
• 数据损坏风险

P1 - 紧急处理（30分钟内）：
• 磁盘使用率>95%
• 严重IO错误
• 主从复制中断

P2 - 高优先级（2小时内）：
• 磁盘使用率>90%
• 性能严重下降
• binlog堆积

P3 - 中等优先级（当日处理）：
• 磁盘使用率>85%
• 临时文件堆积
• 表碎片严重
```

**📞 应急联系流程**：
```
故障发现 ──► 立即评估 ──► 确定优先级
    │             │           │
    ▼             ▼           ▼
通知相关人员   启动应急预案   执行处理流程
    │             │           │
    ▼             ▼           ▼
记录处理过程   验证修复效果   总结改进点
```

**🧠 核心记忆口诀**：
```
"磁盘告警莫慌张，先查空间再诊断
binlog清理用SQL，临时文件安全删
数据迁移先备份，IO错误查硬件
监控预警很重要，防患未然是关键"
```

**核心要点**：
- 磁盘空间管理是MySQL运维的基础技能
- 预防性监控比事后处理更重要
- 任何清理操作都要确保数据安全
- 建立完善的应急响应机制是必需的