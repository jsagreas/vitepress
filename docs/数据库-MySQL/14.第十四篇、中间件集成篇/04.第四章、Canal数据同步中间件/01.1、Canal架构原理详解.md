---
title: 1ã€Canalæ¶æ„åŸç†è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [CanalåŸºç¡€æ¦‚å¿µä¸å®šä½](#1-CanalåŸºç¡€æ¦‚å¿µä¸å®šä½)
2. [Canalæ ¸å¿ƒå·¥ä½œåŸç†](#2-Canalæ ¸å¿ƒå·¥ä½œåŸç†)
3. [binlogè§£ææœºåˆ¶æ·±å…¥å‰–æ](#3-binlogè§£ææœºåˆ¶æ·±å…¥å‰–æ)
4. [Canal Serveræ•´ä½“æ¶æ„è®¾è®¡](#4-Canal-Serveræ•´ä½“æ¶æ„è®¾è®¡)
5. [Canalæ ¸å¿ƒç»„ä»¶è¯¦è§£](#5-Canalæ ¸å¿ƒç»„ä»¶è¯¦è§£)
6. [æ•°æ®è¿‡æ»¤ä¸è·¯ç”±æœºåˆ¶](#6-æ•°æ®è¿‡æ»¤ä¸è·¯ç”±æœºåˆ¶)
7. [ä½ç‚¹ç®¡ç†ä¸æ•…éšœæ¢å¤](#7-ä½ç‚¹ç®¡ç†ä¸æ•…éšœæ¢å¤)
8. [Canalå†…å­˜æ¨¡å‹ä¸æ€§èƒ½ä¼˜åŒ–](#8-Canalå†…å­˜æ¨¡å‹ä¸æ€§èƒ½ä¼˜åŒ–)
9. [Canalä¸MySQLåè®®äº¤äº’](#9-Canalä¸MySQLåè®®äº¤äº’)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CanalåŸºç¡€æ¦‚å¿µä¸å®šä½


### 1.1 ä»€ä¹ˆæ˜¯Canal


**ğŸ”¸ CanalåŸºæœ¬å®šä¹‰**
```
Canalï¼šé˜¿é‡Œå·´å·´å¼€æºçš„åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æçš„æ•°æ®åŒæ­¥ä¸­é—´ä»¶
æ ¸å¿ƒåŠŸèƒ½ï¼šå®æ—¶è§£æMySQL binlogï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹
è®¾è®¡ç†å¿µï¼šä¼ªè£…æˆMySQL Slaveï¼Œè·å–binlogå¹¶è§£ææˆç»“æ„åŒ–æ•°æ®
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡Canalå°±åƒä¸€ä¸ª"æ•°æ®åº“ç›‘å¬å™¨"ï¼Œå°±å¥½æ¯”ä½ åœ¨å¬å¹¿æ’­ï¼Œæ•°æ®åº“æ¯æ¬¡æœ‰å˜åŒ–æ—¶éƒ½ä¼š"å¹¿æ’­"å‡ºæ¥ï¼ŒCanalå°±è´Ÿè´£"æ”¶å¬"è¿™äº›å¹¿æ’­å¹¶æŠŠé‡è¦ä¿¡æ¯æ•´ç†ç»™éœ€è¦çš„äººã€‚

### 1.2 Canalè§£å†³çš„æ ¸å¿ƒé—®é¢˜


**ğŸ“Š ä¼ ç»Ÿæ•°æ®åŒæ­¥ç—›ç‚¹**
```
å®æ—¶æ€§å·®ï¼š
ä¼ ç»Ÿæ–¹æ¡ˆï¼šå®šæ—¶å…¨é‡/å¢é‡åŒæ­¥
é—®é¢˜ï¼šå»¶è¿Ÿé«˜ï¼Œèµ„æºæ¶ˆè€—å¤§ï¼Œå¯¹æºåº“å‹åŠ›å¤§

æ•°æ®ä¸€è‡´æ€§éš¾ä¿è¯ï¼š
ä¼ ç»Ÿæ–¹æ¡ˆï¼šåŸºäºæ—¶é—´æˆ³æˆ–ç‰ˆæœ¬å·
é—®é¢˜ï¼šæ—¶é’Ÿä¸åŒæ­¥ï¼Œæ•°æ®å¯èƒ½ä¸¢å¤±æˆ–é‡å¤

ä¸šåŠ¡è€¦åˆä¸¥é‡ï¼š
ä¼ ç»Ÿæ–¹æ¡ˆï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­å¤„ç†åŒæ­¥é€»è¾‘
é—®é¢˜ï¼šä»£ç å¤æ‚ï¼Œç»´æŠ¤å›°éš¾ï¼Œå½±å“ä¸»ä¸šåŠ¡
```

**âœ¨ Canalçš„è§£å†³æ–¹æ¡ˆ**
```
ğŸ”¸ å®æ—¶æ€§ï¼šåŸºäºbinlogå®æ—¶è§£æï¼Œå»¶è¿Ÿæ¯«ç§’çº§
ğŸ”¸ å‡†ç¡®æ€§ï¼šåŸºäºæ•°æ®åº“äº‹åŠ¡æ—¥å¿—ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ ä½è€¦åˆï¼šç‹¬ç«‹ä¸­é—´ä»¶ï¼Œä¸ä¸šåŠ¡ä»£ç è§£è€¦
ğŸ”¸ ä½æˆæœ¬ï¼šæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼Œå¼€ç®±å³ç”¨
```

### 1.3 Canalçš„åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯**
```
æ•°æ®åº“åŒæ­¥ï¼š
â€¢ ä¸»åº“åˆ°ä»åº“çš„å®æ—¶åŒæ­¥
â€¢ è·¨æœºæˆ¿æ•°æ®åŒæ­¥
â€¢ å¼‚æ„æ•°æ®åº“åŒæ­¥ï¼ˆMySQLâ†’PostgreSQLï¼‰

æ•°æ®è®¢é˜…ï¼š
â€¢ å®æ—¶æ•°æ®å˜æ›´é€šçŸ¥
â€¢ ç¼“å­˜æ›´æ–°è§¦å‘
â€¢ æœç´¢å¼•æ“ç´¢å¼•æ›´æ–°

æ•°æ®åˆ†æï¼š
â€¢ å®æ—¶æ•°æ®ä»“åº“æ„å»º
â€¢ ä¸šåŠ¡æŒ‡æ ‡å®æ—¶è®¡ç®—
â€¢ ç”¨æˆ·è¡Œä¸ºå®æ—¶åˆ†æ

ä¸šåŠ¡è§£è€¦ï¼š
â€¢ è®¢å•çŠ¶æ€å˜æ›´é€šçŸ¥
â€¢ åº“å­˜å˜æ›´è§¦å‘è¡¥è´§
â€¢ ç”¨æˆ·ä¿¡æ¯å˜æ›´åŒæ­¥å¤šä¸ªç³»ç»Ÿ
```

---

## 2. âš™ï¸ Canalæ ¸å¿ƒå·¥ä½œåŸç†


### 2.1 ä¼ªè£…MySQL Slaveçš„å·§å¦™è®¾è®¡


**ğŸ”¸ MySQLä¸»ä»å¤åˆ¶åŸºç¡€**
```
æ­£å¸¸çš„MySQLä¸»ä»å¤åˆ¶æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    binlog    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚    Slave    â”‚
â”‚   MySQL     â”‚              â”‚   MySQL     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Canalçš„ä¼ªè£…ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    binlog    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Master    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚    Canal    â”‚
â”‚   MySQL     â”‚              â”‚  (ä¼ªè£…Slave) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ æ ¸å¿ƒç†è§£è¦ç‚¹**
Canalé€šè¿‡ä¼ªè£…æˆä¸€ä¸ªMySQL SlaveèŠ‚ç‚¹ï¼Œå‘Masterå‘èµ·å¤åˆ¶è¯·æ±‚ï¼ŒMasterä¼šæŠŠbinlogå‘é€ç»™Canalï¼ŒCanalè§£æbinlogåæä¾›ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š
- **æ— ä¾µå…¥æ€§**ï¼šæ— éœ€ä¿®æ”¹MySQLé…ç½®æˆ–ä¸šåŠ¡ä»£ç 
- **å®æ—¶æ€§å¼º**ï¼šç›´æ¥æ¥æ”¶binlogæµï¼Œå»¶è¿Ÿæä½
- **ç¨³å®šæ€§é«˜**ï¼šåˆ©ç”¨MySQLæˆç†Ÿçš„ä¸»ä»å¤åˆ¶æœºåˆ¶

### 2.2 Canalå·¥ä½œæµç¨‹è¯¦è§£


```
Canalå®Œæ•´å·¥ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Canalå·¥ä½œæµæ°´çº¿                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. è¿æ¥å»ºç«‹                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚   MySQL     â”‚                                             â”‚
â”‚  â”‚   Master    â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”‚ dumpè¯·æ±‚                                           â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚   Canal     â”‚                                             â”‚
â”‚  â”‚   Server    â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                              â”‚
â”‚  2. binlogæ¥æ”¶ä¸è§£æ                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è§£æ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   binlog    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  Eventå¯¹è±¡   â”‚                â”‚
â”‚  â”‚   åŸå§‹æ•°æ®   â”‚            â”‚  ç»“æ„åŒ–æ•°æ®  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                              â”‚
â”‚  3. æ•°æ®åˆ†å‘                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ¨é€     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   Canal     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  å®¢æˆ·ç«¯      â”‚                â”‚
â”‚  â”‚   å®ä¾‹       â”‚            â”‚  åº”ç”¨ç¨‹åº    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å¢é‡æ•°æ®æ•è·æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¢é‡æ•°æ®æ•è·**
```
å¢é‡æ•°æ®ï¼šç›¸å¯¹äºå…¨é‡æ•°æ®ï¼ŒåªåŒ…å«å˜åŒ–çš„éƒ¨åˆ†
ä¼ ç»Ÿæ–¹å¼ï¼šselect * from table where update_time > ?
Canalæ–¹å¼ï¼šç›´æ¥ä»binlogä¸­è·å–å˜æ›´äº‹ä»¶

ä¼˜åŠ¿å¯¹æ¯”ï¼š
ä¼ ç»Ÿæ–¹å¼                     Canalæ–¹å¼
â”œâ”€ éœ€è¦ä¸šåŠ¡è¡¨æœ‰æ—¶é—´å­—æ®µ      â”œâ”€ æ— éœ€é¢å¤–å­—æ®µ
â”œâ”€ å¯èƒ½é—æ¼åˆ é™¤æ“ä½œ         â”œâ”€ æ•è·æ‰€æœ‰æ“ä½œ(å¢åˆ æ”¹)
â”œâ”€ æ‰«æå…¨è¡¨ï¼Œæ€§èƒ½å·®         â”œâ”€ ç›´æ¥è§£ææ—¥å¿—ï¼Œæ€§èƒ½å¥½
â””â”€ æ—¶é—´ç²¾åº¦æœ‰é™            â””â”€ äº‹åŠ¡çº§åˆ«ç²¾ç¡®æ€§
```

**ğŸ“ˆ æ•°æ®å˜æ›´ç±»å‹**
```java
// Canalæ•è·çš„ä¸»è¦äº‹ä»¶ç±»å‹
public enum EventType {
    INSERT,    // æ’å…¥äº‹ä»¶ï¼šæ–°å¢æ•°æ®
    UPDATE,    // æ›´æ–°äº‹ä»¶ï¼šä¿®æ”¹æ•°æ®  
    DELETE,    // åˆ é™¤äº‹ä»¶ï¼šåˆ é™¤æ•°æ®
    QUERY,     // æŸ¥è¯¢äº‹ä»¶ï¼šDDLè¯­å¥
    CREATE,    // åˆ›å»ºäº‹ä»¶ï¼šåˆ›å»ºè¡¨/åº“
    ALTER,     // ä¿®æ”¹äº‹ä»¶ï¼šä¿®æ”¹è¡¨ç»“æ„
    DROP       // åˆ é™¤äº‹ä»¶ï¼šåˆ é™¤è¡¨/åº“
}
```

---

## 3. ğŸ” binlogè§£ææœºåˆ¶æ·±å…¥å‰–æ


### 3.1 MySQL binlogåŸºç¡€çŸ¥è¯†


**ğŸ”¸ binlogæ˜¯ä»€ä¹ˆ**
```
binlogï¼šBinary Logï¼ŒMySQLçš„äºŒè¿›åˆ¶æ—¥å¿—
ä½œç”¨ï¼šè®°å½•æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„SQLè¯­å¥
æ ¼å¼ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼Œä½“ç§¯å°ï¼Œå†™å…¥é€Ÿåº¦å¿«
ä½ç½®ï¼šé€šå¸¸å­˜å‚¨åœ¨MySQLæ•°æ®ç›®å½•ä¸‹
```

**ğŸ“Š binlogæ ¼å¼ç±»å‹**
| æ ¼å¼ç±»å‹ | **æè¿°** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **Canalæ”¯æŒ** |
|---------|----------|----------|----------|---------------|
| `STATEMENT` | è®°å½•SQLè¯­å¥æœ¬èº« | æ—¥å¿—é‡å° | å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´ | âŒ ä¸å»ºè®® |
| `ROW` | è®°å½•æ¯è¡Œæ•°æ®å˜æ›´ | æ•°æ®ä¸€è‡´æ€§å¥½ | æ—¥å¿—é‡å¤§ | âœ… **æ¨è** |
| `MIXED` | è‡ªåŠ¨é€‰æ‹©æ ¼å¼ | å¹³è¡¡ä¸¤è€… | å¤æ‚åº¦é«˜ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |

**ğŸ’¡ ä¸ºä»€ä¹ˆCanalæ¨èROWæ ¼å¼**
ROWæ ¼å¼è®°å½•çš„æ˜¯å…·ä½“çš„æ•°æ®å˜æ›´ï¼Œè€Œä¸æ˜¯SQLè¯­å¥ï¼Œè¿™æ ·å¯ä»¥ï¼š
- **é¿å…å‡½æ•°é—®é¢˜**ï¼šNOW()ã€UUID()ç­‰å‡½æ•°åœ¨ä¸åŒæ—¶é—´æ‰§è¡Œç»“æœä¸åŒ
- **ç²¾ç¡®æ•è·**ï¼šçŸ¥é“å…·ä½“å“ªäº›å­—æ®µå‘ç”Ÿäº†å˜åŒ–
- **æ”¯æŒæ‰€æœ‰æ“ä½œ**ï¼šåŒ…æ‹¬å¤æ‚çš„UPDATEã€DELETEæ“ä½œ

### 3.2 binlogäº‹ä»¶ç»“æ„è§£æ


**ğŸ—ï¸ binlogäº‹ä»¶ç»“æ„**
```
å•ä¸ªbinlogäº‹ä»¶ç»„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Event Header              â”‚  äº‹ä»¶å¤´ï¼ˆ19å­—èŠ‚ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Event Data                   â”‚  äº‹ä»¶æ•°æ®ï¼ˆå˜é•¿ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Event HeaderåŒ…å«ï¼š
â€¢ timestampï¼šäº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³ï¼ˆ4å­—èŠ‚ï¼‰
â€¢ event_typeï¼šäº‹ä»¶ç±»å‹ï¼ˆ1å­—èŠ‚ï¼‰
â€¢ server_idï¼šäº§ç”Ÿäº‹ä»¶çš„æœåŠ¡å™¨IDï¼ˆ4å­—èŠ‚ï¼‰
â€¢ event_lengthï¼šäº‹ä»¶æ€»é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰
â€¢ next_positionï¼šä¸‹ä¸€ä¸ªäº‹ä»¶ä½ç½®ï¼ˆ4å­—èŠ‚ï¼‰
â€¢ flagsï¼šäº‹ä»¶æ ‡å¿—ï¼ˆ2å­—èŠ‚ï¼‰
```

### 3.3 Canalçš„binlogè§£ææµç¨‹


**ğŸ”§ è§£ææµç¨‹è¯¦è§£**
```
Canal binlogè§£æpipelineï¼š

1. åŸå§‹binlogæ¥æ”¶
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  äºŒè¿›åˆ¶binlog   â”‚ â† ä»MySQLæ¥æ”¶
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
2. äº‹ä»¶ååºåˆ—åŒ–
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  LogEventå¯¹è±¡   â”‚ â† è§£æäºŒè¿›åˆ¶æ•°æ®
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
3. äº‹ä»¶ç±»å‹è¯†åˆ«
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ äº‹ä»¶åˆ†ç±»å¤„ç†     â”‚ â† åŒºåˆ†INSERT/UPDATE/DELETE
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
4. æ•°æ®æå–è½¬æ¢
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç»“æ„åŒ–æ•°æ®       â”‚ â† æå–è¡¨åã€å­—æ®µã€å€¼
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
5. å°è£…æˆCanaläº‹ä»¶
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  CanalEntry     â”‚ â† æœ€ç»ˆè¾“å‡ºæ ¼å¼
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» æ ¸å¿ƒè§£æä»£ç ç¤ºä¾‹**
```java
// Canaläº‹ä»¶è§£ææ ¸å¿ƒé€»è¾‘
public class CanalEventParser {
    
    // è§£æbinlogäº‹ä»¶
    public CanalEntry.Entry parseLogEvent(LogEvent logEvent) {
        CanalEntry.Entry.Builder entryBuilder = CanalEntry.Entry.newBuilder();
        
        // è®¾ç½®åŸºæœ¬ä¿¡æ¯
        entryBuilder.setLogfileName(logEvent.getLogFileName());
        entryBuilder.setLogfileOffset(logEvent.getLogPos());
        entryBuilder.setExecuteTime(logEvent.getWhen() * 1000);
        
        // æ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œå…·ä½“è§£æ
        switch (logEvent.getHeader().getType()) {
            case TABLE_MAP:
                // è§£æè¡¨æ˜ å°„äº‹ä»¶
                parseTableMapEvent(logEvent, entryBuilder);
                break;
            case WRITE_ROWS:
                // è§£æINSERTäº‹ä»¶
                parseInsertEvent(logEvent, entryBuilder);
                break;
            case UPDATE_ROWS:
                // è§£æUPDATEäº‹ä»¶
                parseUpdateEvent(logEvent, entryBuilder);
                break;
            case DELETE_ROWS:
                // è§£æDELETEäº‹ä»¶
                parseDeleteEvent(logEvent, entryBuilder);
                break;
        }
        
        return entryBuilder.build();
    }
}
```

---

## 4. ğŸ—ï¸ Canal Serveræ•´ä½“æ¶æ„è®¾è®¡


### 4.1 Canal Serveræ¶æ„å±‚æ¬¡


```
Canal Serveræ•´ä½“æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Canal Server                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 ç®¡ç†å±‚ (Manager)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ å®ä¾‹ç®¡ç†     â”‚  â”‚ é…ç½®ç®¡ç†     â”‚  â”‚ ç›‘æ§ç®¡ç†     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                 â”‚
â”‚                              â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                æœåŠ¡å±‚ (Service)                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ Instance1   â”‚  â”‚ Instance2   â”‚  â”‚ Instance3   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ (æ•°æ®åº“A)    â”‚  â”‚ (æ•°æ®åº“B)    â”‚  â”‚ (æ•°æ®åº“C)    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Java Client â”‚  â”‚ Python Clientâ”‚ â”‚ Go Client   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Canalå®ä¾‹(Instance)è¯¦ç»†æ¶æ„


**ğŸ”¸ å•ä¸ªCanalå®ä¾‹å†…éƒ¨ç»“æ„**
```
å•ä¸ªCanal Instanceå†…éƒ¨ç»„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Canal Instance                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  1. EventParser (äº‹ä»¶è§£æå™¨)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ MySQLè¿æ¥ç®¡ç†                                   â”‚  â”‚
â”‚  â”‚  â€¢ binlogæ‹‰å–                                     â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ binlogäº‹ä»¶è§£æ                              â”‚  â”‚
â”‚  â”‚  â””â”€> EventSink                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                  â”‚
â”‚                       â–¼                                  â”‚
â”‚  2. EventSink (äº‹ä»¶åˆ†å‘å™¨)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ æ•°æ®è¿‡æ»¤                                        â”‚  â”‚
â”‚  â”‚  â€¢ æ•°æ®è½¬æ¢                                        â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ æ•°æ®è·¯ç”±                                     â”‚  â”‚
â”‚  â”‚  â””â”€> EventStore                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                  â”‚
â”‚                       â–¼                                  â”‚
â”‚  3. EventStore (äº‹ä»¶å­˜å‚¨)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â€¢ å†…å­˜ç¼“å†²åŒºç®¡ç†                                   â”‚  â”‚
â”‚  â”‚  â€¢ äº‹ä»¶æŒä¹…åŒ–                                      â”‚  â”‚
â”‚  â”‚  â€¢ å®¢æˆ·ç«¯æ¶ˆè´¹ç®¡ç†                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Canaléƒ¨ç½²æ¨¡å¼


**ğŸ“Š Canalæ”¯æŒçš„éƒ¨ç½²æ¨¡å¼**
| éƒ¨ç½²æ¨¡å¼ | **æè¿°** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|----------|--------------|----------|----------|
| `å•æœºæ¨¡å¼` | å•ä¸ªCanal Server | å°è§„æ¨¡åº”ç”¨ | éƒ¨ç½²ç®€å• | æ— é«˜å¯ç”¨ |
| `é›†ç¾¤æ¨¡å¼` | å¤šä¸ªCanal Server | ç”Ÿäº§ç¯å¢ƒ | é«˜å¯ç”¨æ€§ | é…ç½®å¤æ‚ |
| `Dockeræ¨¡å¼` | å®¹å™¨åŒ–éƒ¨ç½² | äº‘åŸç”Ÿç¯å¢ƒ | æ˜“äºæ‰©å±• | ç½‘ç»œé…ç½® |

**ğŸš€ ç”Ÿäº§ç¯å¢ƒæ¨èæ¶æ„**
```
Canalé›†ç¾¤éƒ¨ç½²æ¶æ„ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Zookeeper     â”‚ â† åè°ƒæœåŠ¡
                    â”‚   é›†ç¾¤          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Canal       â”‚ â”‚ Canal       â”‚ â”‚ Canal       â”‚
    â”‚ Server 1    â”‚ â”‚ Server 2    â”‚ â”‚ Server 3    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   MySQL     â”‚
                  â”‚   Master    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ğŸ§© Canalæ ¸å¿ƒç»„ä»¶è¯¦è§£


### 5.1 EventParseräº‹ä»¶è§£æå™¨


**ğŸ”¸ EventParseræ ¸å¿ƒèŒè´£**
```
EventParserä¸»è¦åŠŸèƒ½ï¼š
1. å»ºç«‹ä¸MySQLçš„è¿æ¥
2. å‘é€dumpå‘½ä»¤è·å–binlog
3. æ¥æ”¶å¹¶è§£æbinlogäº‹ä»¶
4. ç»´æŠ¤binlogä½ç‚¹ä¿¡æ¯
5. å¤„ç†è¿æ¥å¼‚å¸¸å’Œé‡è¿
```

**ğŸ’» EventParserå…³é”®é…ç½®**
```java
// EventParseræ ¸å¿ƒé…ç½®ç¤ºä¾‹
public class MysqlEventParser {
    
    // MySQLè¿æ¥é…ç½®
    private String hostname = "localhost";
    private int port = 3306;
    private String username = "canal";
    private String password = "canal";
    
    // binlogé…ç½®
    private String logFileName;     // èµ·å§‹binlogæ–‡ä»¶
    private Long logPosition;       // èµ·å§‹ä½ç‚¹
    private boolean enableGTID;     // æ˜¯å¦å¯ç”¨GTID
    
    // æ€§èƒ½é…ç½®
    private int receiveBufferSize = 64 * 1024;  // æ¥æ”¶ç¼“å†²åŒºå¤§å°
    private int sendBufferSize = 64 * 1024;     // å‘é€ç¼“å†²åŒºå¤§å°
    private boolean tcpNoDelay = true;          // TCPæ— å»¶è¿Ÿ
    
    // æ ¸å¿ƒè§£ææ–¹æ³•
    public void start() {
        // 1. å»ºç«‹MySQLè¿æ¥
        connector = new MysqlConnector(hostname, port, username, password);
        connector.connect();
        
        // 2. å‘é€binlog dumpè¯·æ±‚
        connector.dump(logFileName, logPosition);
        
        // 3. å¾ªç¯æ¥æ”¶å¹¶è§£æbinlog
        while (running) {
            LogEvent event = connector.fetchLogEvent();
            parseAndSink(event);
        }
    }
}
```

### 5.2 EventSinkäº‹ä»¶åˆ†å‘å™¨


**ğŸ”¸ EventSinkæ ¸å¿ƒåŠŸèƒ½**
```
EventSinkçš„ä½œç”¨ï¼š
â€¢ æ¥æ”¶EventParserè§£æçš„äº‹ä»¶
â€¢ å¯¹äº‹ä»¶è¿›è¡Œè¿‡æ»¤å’Œè½¬æ¢
â€¢ å°†äº‹ä»¶å‘é€åˆ°EventStore
â€¢ å¤„ç†äº‹ä»¶æµæ§åˆ¶
```

**ğŸ¯ æ•°æ®è¿‡æ»¤æœºåˆ¶**
```java
// EventSinkè¿‡æ»¤å™¨ç¤ºä¾‹
public class CanalEventSink {
    
    // æ•°æ®è¿‡æ»¤å™¨é“¾
    private List<CanalEventFilter> filters;
    
    public boolean sink(List<CanalEntry.Entry> entries) {
        for (CanalEntry.Entry entry : entries) {
            // åº”ç”¨è¿‡æ»¤å™¨é“¾
            if (!applyFilters(entry)) {
                continue; // è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ•°æ®
            }
            
            // å‘é€åˆ°EventStore
            eventStore.put(entry);
        }
        return true;
    }
    
    // å¸¸è§è¿‡æ»¤æ¡ä»¶
    private boolean applyFilters(CanalEntry.Entry entry) {
        // 1. åº“åè¿‡æ»¤
        if (!allowedDatabases.contains(entry.getHeader().getSchemaName())) {
            return false;
        }
        
        // 2. è¡¨åè¿‡æ»¤  
        if (!allowedTables.contains(entry.getHeader().getTableName())) {
            return false;
        }
        
        // 3. æ“ä½œç±»å‹è¿‡æ»¤
        if (!allowedEventTypes.contains(entry.getHeader().getEventType())) {
            return false;
        }
        
        return true;
    }
}
```

### 5.3 EventStoreäº‹ä»¶å­˜å‚¨


**ğŸ”¸ EventStoreæ¶æ„è®¾è®¡**
```
EventStoreå†…éƒ¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EventStore                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Ring Buffer                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚  â”‚Eventâ”‚ â”‚Eventâ”‚ â”‚Eventâ”‚ â”‚Eventâ”‚ â”‚Eventâ”‚ ...   â”‚  â”‚
â”‚  â”‚  â”‚  1  â”‚ â”‚  2  â”‚ â”‚  3  â”‚ â”‚  4  â”‚ â”‚  5  â”‚       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â”‚    â†‘                               â†‘            â”‚  â”‚
â”‚  â”‚    â”‚                               â”‚            â”‚  â”‚
â”‚  â”‚ putä½ç½®                         getä½ç½®         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                        â”‚
â”‚  â€¢ é«˜æ€§èƒ½å†…å­˜ç¼“å†²åŒº                                     â”‚
â”‚  â€¢ æ”¯æŒæ‰¹é‡è¯»å†™                                        â”‚
â”‚  â€¢ ä½ç‚¹ç®¡ç†å’ŒæŒä¹…åŒ–                                     â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 MetaManagerå…ƒæ•°æ®ç®¡ç†å™¨


**ğŸ”¸ MetaManagerç®¡ç†å†…å®¹**
```
MetaManagerè´Ÿè´£ç®¡ç†ï¼š
1. binlogä½ç‚¹ä¿¡æ¯ (position)
2. è¡¨ç»“æ„ä¿¡æ¯ (schema)  
3. å®¢æˆ·ç«¯æ¶ˆè´¹ä½ç‚¹
4. å®ä¾‹è¿è¡ŒçŠ¶æ€
5. é…ç½®å˜æ›´å†å²
```

**ğŸ’¾ ä½ç‚¹ä¿¡æ¯æŒä¹…åŒ–**
```java
// ä½ç‚¹ç®¡ç†ç¤ºä¾‹
public class FileMixedMetaManager implements CanalMetaManager {
    
    // ä½ç‚¹æ–‡ä»¶è·¯å¾„
    private String dataDir = "./canal/meta";
    
    // æ›´æ–°ä½ç‚¹ä¿¡æ¯
    public void updatePosition(String destination, LogPosition position) {
        // ä½ç‚¹ä¿¡æ¯æ ¼å¼: {"journalName":"mysql-bin.000001","position":12345,"timestamp":1234567890}
        String positionData = JSON.toJSONString(position);
        
        // å†™å…¥ä½ç‚¹æ–‡ä»¶
        String fileName = dataDir + "/" + destination + "/meta.dat";
        FileUtils.writeStringToFile(fileName, positionData);
        
        // åŒæ—¶æ›´æ–°å†…å­˜ç¼“å­˜
        positionCache.put(destination, position);
    }
    
    // è·å–ä½ç‚¹ä¿¡æ¯
    public LogPosition getPosition(String destination) {
        // ä¼˜å…ˆä»ç¼“å­˜è·å–
        LogPosition position = positionCache.get(destination);
        if (position != null) {
            return position;
        }
        
        // ä»æ–‡ä»¶è¯»å–
        String fileName = dataDir + "/" + destination + "/meta.dat";
        if (FileUtils.exists(fileName)) {
            String positionData = FileUtils.readFileToString(fileName);
            return JSON.parseObject(positionData, LogPosition.class);
        }
        
        return null; // é¦–æ¬¡å¯åŠ¨ï¼Œæ— ä½ç‚¹ä¿¡æ¯
    }
}
```

---

## 6. ğŸ”€ æ•°æ®è¿‡æ»¤ä¸è·¯ç”±æœºåˆ¶


### 6.1 Canalæ•°æ®è¿‡æ»¤ä½“ç³»


**ğŸ¯ å¤šå±‚è¿‡æ»¤æœºåˆ¶**
```
Canalæ•°æ®è¿‡æ»¤å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åŸå§‹binlogäº‹ä»¶                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                1. å®ä¾‹çº§è¿‡æ»¤                            â”‚
â”‚  â€¢ databaseè¿‡æ»¤ï¼šåªå…³æ³¨ç‰¹å®šæ•°æ®åº“                        â”‚
â”‚  â€¢ tableè¿‡æ»¤ï¼šåªå…³æ³¨ç‰¹å®šè¡¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                2. äº‹ä»¶ç±»å‹è¿‡æ»¤                          â”‚
â”‚  â€¢ INSERT/UPDATE/DELETEè¿‡æ»¤                           â”‚
â”‚  â€¢ DDLäº‹ä»¶è¿‡æ»¤                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                3. å­—æ®µçº§è¿‡æ»¤                            â”‚
â”‚  â€¢ æ•æ„Ÿå­—æ®µè¿‡æ»¤                                        â”‚
â”‚  â€¢ ä¸šåŠ¡å­—æ®µé€‰æ‹©                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœ€ç»ˆè¾“å‡ºäº‹ä»¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Canalè¿‡æ»¤é…ç½®è¯¦è§£


**ğŸ’» è¿‡æ»¤é…ç½®ç¤ºä¾‹**
```properties
# canal.properties - Canalå®ä¾‹è¿‡æ»¤é…ç½®

# 1. æ•°æ®åº“è¿‡æ»¤ (æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼)
canal.instance.filter.regex = test\\..*,mysql\\.slave_.*

# 2. æ•°æ®åº“é»‘åå•
canal.instance.filter.black.regex = mysql\\.slave_.*

# 3. è¡¨çº§åˆ«è¿‡æ»¤ 
canal.instance.filter.regex = test\\.user,test\\.order,test\\.product

# 4. å­—æ®µçº§åˆ«è¿‡æ»¤
canal.instance.filter.field.regex = test\\.user:name,email

# 5. DMLè¿‡æ»¤ (åªå…³æ³¨æ•°æ®å˜æ›´ï¼Œå¿½ç•¥DDL)
canal.instance.filter.dml = true

# 6. äº‹ä»¶ç±»å‹è¿‡æ»¤
canal.instance.filter.event.type = INSERT,UPDATE,DELETE
```

**ğŸ”§ è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘**
```java
// è‡ªå®šä¹‰è¿‡æ»¤å™¨å®ç°
public class CustomCanalEventFilter implements CanalEventFilter {
    
    @Override
    public boolean filter(CanalEntry.Entry entry) {
        // è·å–äº‹ä»¶åŸºæœ¬ä¿¡æ¯
        String database = entry.getHeader().getSchemaName();
        String table = entry.getHeader().getTableName();
        CanalEntry.EventType eventType = entry.getHeader().getEventType();
        
        // 1. è¿‡æ»¤ç³»ç»Ÿè¡¨
        if ("information_schema".equals(database) || 
            "performance_schema".equals(database)) {
            return false;
        }
        
        // 2. åªå¤„ç†ä¸šåŠ¡ç›¸å…³è¡¨
        if (!table.startsWith("biz_")) {
            return false;
        }
        
        // 3. è¿‡æ»¤DDLäº‹ä»¶  
        if (eventType == CanalEntry.EventType.QUERY) {
            return false;
        }
        
        // 4. è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘è¿‡æ»¤
        return customBusinessFilter(entry);
    }
    
    private boolean customBusinessFilter(CanalEntry.Entry entry) {
        // è§£æäº‹ä»¶æ•°æ®
        CanalEntry.RowChange rowChange = CanalEntry.RowChange.parseFrom(entry.getStoreValue());
        
        for (CanalEntry.RowData rowData : rowChange.getRowDatasList()) {
            // æ£€æŸ¥ç‰¹å®šå­—æ®µå€¼
            for (CanalEntry.Column column : rowData.getAfterColumnsList()) {
                if ("status".equals(column.getName()) && "deleted".equals(column.getValue())) {
                    return false; // è¿‡æ»¤å·²åˆ é™¤çŠ¶æ€çš„æ•°æ®
                }
            }
        }
        
        return true;
    }
}
```

### 6.3 æ•°æ®è·¯ç”±æœºåˆ¶


**ğŸ”€ Canalæ•°æ®è·¯ç”±ç­–ç•¥**
```
æ•°æ®è·¯ç”±åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è·¯ç”±è§„åˆ™    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æºMySQL       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   ç›®æ ‡ç³»ç»Ÿ1      â”‚
â”‚   (è®¢å•åº“)       â”‚              â”‚   (æ•°æ®ä»“åº“)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚                                 â–¼
        â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                        â”‚   ç›®æ ‡ç³»ç»Ÿ2      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   (æœç´¢å¼•æ“)     â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚   ç›®æ ‡ç³»ç»Ÿ3      â”‚
                                â”‚   (ç¼“å­˜ç³»ç»Ÿ)     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ğŸ“ ä½ç‚¹ç®¡ç†ä¸æ•…éšœæ¢å¤


### 7.1 binlogä½ç‚¹æ¦‚å¿µæ·±å…¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯binlogä½ç‚¹**
```
binlogä½ç‚¹(Position)ï¼šæ ‡è¯†binlogä¸­äº‹ä»¶ä½ç½®çš„åæ ‡
ç»„æˆè¦ç´ ï¼š
â€¢ File Nameï¼šbinlogæ–‡ä»¶å (å¦‚: mysql-bin.000001)
â€¢ Positionï¼šæ–‡ä»¶å†…çš„åç§»é‡ (å¦‚: 12345)
â€¢ Timestampï¼šäº‹ä»¶æ—¶é—´æˆ³
â€¢ Server IDï¼šMySQLæœåŠ¡å™¨ID

ä½œç”¨ï¼š
â€¢ è®°å½•æ¶ˆè´¹è¿›åº¦
â€¢ æ”¯æŒæ–­ç‚¹ç»­ä¼   
â€¢ æ•…éšœæ¢å¤å®šä½
â€¢ é¿å…é‡å¤æ¶ˆè´¹
```

**ğŸ“Š ä½ç‚¹ä¿¡æ¯ç»“æ„**
```java
// Canalä½ç‚¹ä¿¡æ¯æ•°æ®ç»“æ„
public class LogPosition {
    private String journalName;    // binlogæ–‡ä»¶å
    private Long position;         // æ–‡ä»¶å†…ä½ç½®
    private Long timestamp;        // æ—¶é—´æˆ³
    private String serverId;       // æœåŠ¡å™¨ID
    
    // ç¤ºä¾‹ä½ç‚¹ä¿¡æ¯
    // {
    //   "journalName": "mysql-bin.000001",
    //   "position": 12345,
    //   "timestamp": 1609459200000,
    //   "serverId": "1"
    // }
}
```

### 7.2 ä½ç‚¹ç®¡ç†ç­–ç•¥


**ğŸ”§ Canalæ”¯æŒçš„ä½ç‚¹å­˜å‚¨æ–¹å¼**
| å­˜å‚¨æ–¹å¼ | **æè¿°** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|----------|----------|----------|--------------|
| `Memory` | å†…å­˜å­˜å‚¨ | æ€§èƒ½æœ€é«˜ | é‡å¯ä¸¢å¤± | å¼€å‘æµ‹è¯• |
| `File` | æ–‡ä»¶å­˜å‚¨ | ç®€å•å¯é  | å•æœºé™åˆ¶ | å•æœºéƒ¨ç½² |
| `Zookeeper` | ZKå­˜å‚¨ | é›†ç¾¤å…±äº« | ä¾èµ–ZK | é›†ç¾¤éƒ¨ç½² |
| `MySQL` | æ•°æ®åº“å­˜å‚¨ | äº‹åŠ¡æ”¯æŒ | æ€§èƒ½ä¸€èˆ¬ | é«˜å¯é è¦æ±‚ |

**ğŸ’» ä½ç‚¹ç®¡ç†é…ç½®ç¤ºä¾‹**
```properties
# canal.properties - ä½ç‚¹ç®¡ç†é…ç½®

# 1. Memoryæ¨¡å¼ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
canal.instance.memory.meta.mode = memory

# 2. Fileæ¨¡å¼ï¼ˆæ–‡ä»¶å­˜å‚¨ï¼‰  
canal.instance.meta.mode = file
canal.instance.meta.dir = /tmp/canal/meta

# 3. Zookeeperæ¨¡å¼ï¼ˆåˆ†å¸ƒå¼å­˜å‚¨ï¼‰
canal.instance.meta.mode = zookeeper
canal.zkServers = zk1:2181,zk2:2181,zk3:2181

# 4. MySQLæ¨¡å¼ï¼ˆæ•°æ®åº“å­˜å‚¨ï¼‰
canal.instance.meta.mode = mysql
canal.instance.meta.manager.connection.address = mysql:3306
canal.instance.meta.manager.connection.username = canal
canal.instance.meta.manager.connection.password = canal
```

### 7.3 æ•…éšœæ¢å¤æœºåˆ¶


**ğŸ”„ Canalæ•…éšœæ¢å¤æµç¨‹**
```
Canalæ•…éšœæ¢å¤æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Canalå®ä¾‹å¯åŠ¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1. è¯»å–ä¸Šæ¬¡ä½ç‚¹ä¿¡æ¯                         â”‚
â”‚  â€¢ ä»metaå­˜å‚¨ä¸­è·å–æœ€åæ¶ˆè´¹ä½ç‚¹                          â”‚
â”‚  â€¢ å¦‚æœæ²¡æœ‰ä½ç‚¹ä¿¡æ¯ï¼Œä½¿ç”¨é…ç½®çš„åˆå§‹ä½ç‚¹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2. éªŒè¯ä½ç‚¹æœ‰æ•ˆæ€§                          â”‚
â”‚  â€¢ æ£€æŸ¥binlogæ–‡ä»¶æ˜¯å¦å­˜åœ¨                               â”‚
â”‚  â€¢ æ£€æŸ¥ä½ç‚¹æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…                              â”‚
â”‚  â€¢ å¦‚æœæ— æ•ˆï¼Œå¯»æ‰¾æœ€è¿‘çš„æœ‰æ•ˆä½ç‚¹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3. é‡æ–°å»ºç«‹è¿æ¥                            â”‚
â”‚  â€¢ è¿æ¥åˆ°MySQL Master                                 â”‚
â”‚  â€¢ ä»æŒ‡å®šä½ç‚¹å¼€å§‹dump binlog                            â”‚
â”‚  â€¢ ç»§ç»­æ•°æ®åŒæ­¥                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ å¸¸è§æ•…éšœåœºæ™¯å¤„ç†**
```java
// Canalæ•…éšœæ¢å¤å¤„ç†ç¤ºä¾‹
public class CanalFailoverHandler {
    
    public void handleRecovery() {
        try {
            // 1. è·å–æœ€åä½ç‚¹
            LogPosition lastPosition = metaManager.getPosition(destination);
            
            if (lastPosition == null) {
                // é¦–æ¬¡å¯åŠ¨ï¼Œä½¿ç”¨é…ç½®çš„åˆå§‹ä½ç‚¹
                lastPosition = getConfiguredStartPosition();
            }
            
            // 2. éªŒè¯ä½ç‚¹æœ‰æ•ˆæ€§
            if (!isPositionValid(lastPosition)) {
                // ä½ç‚¹æ— æ•ˆï¼Œå¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆ
                lastPosition = findValidPosition(lastPosition);
            }
            
            // 3. ä»ä½ç‚¹æ¢å¤
            eventParser.start(lastPosition);
            
        } catch (Exception e) {
            // 4. æ•…éšœå¤„ç†
            handleFailure(e);
        }
    }
    
    private LogPosition findValidPosition(LogPosition invalidPosition) {
        // ç­–ç•¥1: å¯»æ‰¾æœ€æ–°çš„binlogèµ·å§‹ä½ç½®
        LogPosition latestPosition = findLatestBinlogPosition();
        if (latestPosition != null) {
            return latestPosition;
        }
        
        // ç­–ç•¥2: ä½¿ç”¨MySQL MasterçŠ¶æ€
        LogPosition masterPosition = getMasterStatus();
        return masterPosition;
    }
}
```

---

## 8. ğŸ’¾ Canalå†…å­˜æ¨¡å‹ä¸æ€§èƒ½ä¼˜åŒ–


### 8.1 MemoryEventStoreWithBufferè¯¦è§£


**ğŸ”¸ Canalå†…å­˜æ¨¡å‹è®¾è®¡ç†å¿µ**
```
Canalå†…å­˜å­˜å‚¨çš„æ ¸å¿ƒè®¾è®¡ï¼š
â€¢ é«˜æ€§èƒ½ï¼šåŸºäºç¯å½¢ç¼“å†²åŒº(Ring Buffer)è®¾è®¡
â€¢ é«˜å¹¶å‘ï¼šæ”¯æŒå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å¼  
â€¢ å†…å­˜å¯æ§ï¼šå›ºå®šå¤§å°ç¼“å†²åŒºï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
â€¢ æ‰¹é‡å¤„ç†ï¼šæ”¯æŒæ‰¹é‡è¯»å†™æå‡æ€§èƒ½
```

**ğŸ—ï¸ å†…å­˜ç¼“å†²åŒºç»“æ„**
```
MemoryEventStoreå†…éƒ¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Ring Buffer Array                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  ç´¢å¼•: 0    1    2    3    4    5    6    7    8    9   â”‚
â”‚       â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”â”‚
â”‚  æ•°æ®: â”‚ E1 â”‚ E2 â”‚ E3 â”‚ E4 â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚â”‚
â”‚       â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜â”‚
â”‚         â†‘              â†‘                                 â”‚
â”‚      putIndex      getIndex                              â”‚
â”‚       (å†™ä½ç½®)      (è¯»ä½ç½®)                              â”‚
â”‚                                                          â”‚
â”‚  ç‰¹ç‚¹ï¼š                                                   â”‚
â”‚  â€¢ å›ºå®šå¤§å°æ•°ç»„ï¼Œå¾ªç¯ä½¿ç”¨                                 â”‚
â”‚  â€¢ putIndexï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªå†™å…¥ä½ç½®                          â”‚ 
â”‚  â€¢ getIndexï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªè¯»å–ä½ç½®                          â”‚
â”‚  â€¢ å½“putIndexè¿½ä¸ŠgetIndexæ—¶ï¼Œå†™å…¥é˜»å¡                    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» å†…å­˜å­˜å‚¨æ ¸å¿ƒä»£ç **
```java
// Canalå†…å­˜äº‹ä»¶å­˜å‚¨å®ç°
public class MemoryEventStoreWithBuffer implements CanalEventStore {
    
    // ç¯å½¢ç¼“å†²åŒºé…ç½®
    private int bufferSize = 16384;        // ç¼“å†²åŒºå¤§å°
    private Event[] buffer;                // äº‹ä»¶æ•°ç»„
    private volatile long putIndex = 0;    // å†™å…¥ä½ç½®
    private volatile long getIndex = 0;    // è¯»å–ä½ç½®
    
    // æ‰¹é‡æ“ä½œé…ç½®
    private int batchMode = 1024;          // æ‰¹é‡å¤§å°
    private long timeout = 1000;           // è¶…æ—¶æ—¶é—´
    
    // å†™å…¥äº‹ä»¶ï¼ˆç”Ÿäº§è€…ï¼‰
    public void put(Event event) throws InterruptedException {
        // 1. æ£€æŸ¥ç¼“å†²åŒºæ˜¯å¦å·²æ»¡
        while (putIndex - getIndex >= bufferSize) {
            Thread.sleep(1); // ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹
        }
        
        // 2. å†™å…¥äº‹ä»¶åˆ°ç¯å½¢ç¼“å†²åŒº
        int index = (int) (putIndex % bufferSize);
        buffer[index] = event;
        
        // 3. æ›´æ–°å†™å…¥ä½ç½®
        putIndex++;
    }
    
    // æ‰¹é‡è¯»å–äº‹ä»¶ï¼ˆæ¶ˆè´¹è€…ï¼‰
    public Events get(Position start, int batchSize, long timeout) {
        List<Event> eventList = new ArrayList<>();
        long endTime = System.currentTimeMillis() + timeout;
        
        // æ‰¹é‡è¯»å–ç›´åˆ°è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–è¶…æ—¶
        while (eventList.size() < batchSize && 
               System.currentTimeMillis() < endTime) {
            
            if (getIndex < putIndex) {
                // æœ‰æ–°äº‹ä»¶å¯è¯»
                int index = (int) (getIndex % bufferSize);
                Event event = buffer[index];
                eventList.add(event);
                getIndex++;
            } else {
                // æ²¡æœ‰æ–°äº‹ä»¶ï¼ŒçŸ­æš‚ç­‰å¾…
                Thread.sleep(1);
            }
        }
        
        return new Events(eventList);
    }
}
```

### 8.2 Canalæ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
Canalæ€§èƒ½ä¼˜åŒ–checklistï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç½‘ç»œå±‚ä¼˜åŒ–                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ è°ƒæ•´MySQL max_binlog_size                           â”‚
â”‚ âœ“ è®¾ç½®åˆé€‚çš„TCPç¼“å†²åŒºå¤§å°                               â”‚
â”‚ âœ“ å¯ç”¨TCP_NODELAYå‡å°‘ç½‘ç»œå»¶è¿Ÿ                          â”‚
â”‚ âœ“ ä¼˜åŒ–binlogæ ¼å¼ï¼ˆæ¨èROWæ ¼å¼ï¼‰                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å†…å­˜å±‚ä¼˜åŒ–                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ åˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°(bufferSize)                        â”‚
â”‚ âœ“ è°ƒæ•´æ‰¹é‡å¤„ç†å¤§å°(batchSize)                          â”‚
â”‚ âœ“ ä¼˜åŒ–JVMå †å†…å­˜è®¾ç½®                                    â”‚
â”‚ âœ“ ä½¿ç”¨G1 GCå‡å°‘åœé¡¿æ—¶é—´                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å±‚ä¼˜åŒ–                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ å‡å°‘ä¸å¿…è¦çš„æ•°æ®è¿‡æ»¤                                  â”‚
â”‚ âœ“ ä¼˜åŒ–å®¢æˆ·ç«¯æ¶ˆè´¹é€Ÿåº¦                                    â”‚
â”‚ âœ“ åˆç†è®¾ç½®æ¶ˆè´¹çº¿ç¨‹æ•°                                    â”‚
â”‚ âœ“ é¿å…é•¿æ—¶é—´äº‹åŠ¡é˜»å¡                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
| ç›‘æ§æŒ‡æ ‡ | **è¯´æ˜** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸å¤„ç†** |
|---------|----------|--------------|-------------|
| `å»¶è¿Ÿæ—¶é—´` | äº‹ä»¶äº§ç”Ÿåˆ°æ¶ˆè´¹çš„æ—¶é—´å·® | < 100ms | æ£€æŸ¥ç½‘ç»œå’Œå¤„ç†é€»è¾‘ |
| `ç¼“å†²åŒºä½¿ç”¨ç‡` | å†…å­˜ç¼“å†²åŒºå¡«å……æ¯”ä¾‹ | < 80% | å¢åŠ ç¼“å†²åŒºæˆ–æå‡æ¶ˆè´¹é€Ÿåº¦ |
| `ç½‘ç»œååé‡` | binlogæ¥æ”¶é€Ÿåº¦ | æ ¹æ®ä¸šåŠ¡é‡ | ä¼˜åŒ–ç½‘ç»œé…ç½® |
| `GCé¢‘ç‡` | JVMåƒåœ¾å›æ”¶é¢‘ç‡ | < æ¯ç§’1æ¬¡ | è°ƒæ•´JVMå‚æ•° |

---

## 9. ğŸ”„ Canalä¸MySQLåè®®äº¤äº’


### 9.1 MySQLä¸»ä»å¤åˆ¶åè®®åŸºç¡€


**ğŸ”¸ MySQLå¤åˆ¶åè®®æ¦‚è¿°**
```
MySQLä¸»ä»å¤åˆ¶åè®®æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL Slave   â”‚                    â”‚  MySQL Master   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                       â”‚
         â”‚ 1. è¿æ¥è¯·æ±‚                            â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                       â”‚
         â”‚ 2. è®¤è¯å“åº”                            â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                       â”‚
         â”‚ 3. æ³¨å†ŒSlave                          â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                       â”‚
         â”‚ 4. binlog dumpè¯·æ±‚                    â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                       â”‚
         â”‚ 5. binlogäº‹ä»¶æµ                       â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                                       â”‚
```

**ğŸ”§ Canalä¼ªè£…Slaveçš„å®ç°**
```java
// Canalä¼ªè£…MySQL Slaveçš„æ ¸å¿ƒå®ç°
public class CanalMysqlConnector {
    
    // å»ºç«‹è¿æ¥å¹¶ä¼ªè£…æˆSlave
    public void connect() throws IOException {
        // 1. å»ºç«‹TCPè¿æ¥
        socket = new Socket(hostname, port);
        
        // 2. MySQLæ¡æ‰‹åè®®
        HandshakePacket handshake = receiveHandshakePacket();
        
        // 3. å‘é€è®¤è¯ä¿¡æ¯
        AuthPacket auth = new AuthPacket();
        auth.username = username;
        auth.password = password;
        auth.serverCapabilities = handshake.serverCapabilities;
        sendPacket(auth);
        
        // 4. æ¥æ”¶è®¤è¯ç»“æœ
        OKPacket ok = receiveOKPacket();
        
        // 5. æ³¨å†Œä¸ºSlave
        registerSlave();
    }
    
    // æ³¨å†ŒSlaveèº«ä»½
    private void registerSlave() throws IOException {
        RegisterSlaveCommandPacket cmd = new RegisterSlaveCommandPacket();
        cmd.slaveId = 1001;  // ä¼ªè£…çš„Slave ID
        cmd.slaveHostname = "canal-client";
        cmd.slaveUser = "canal";
        cmd.slavePassword = "";
        cmd.slavePort = 3306;
        
        sendPacket(cmd);
        receiveOKPacket(); // ç­‰å¾…æ³¨å†ŒæˆåŠŸå“åº”
    }
    
    // å‘é€binlog dumpè¯·æ±‚
    public void dump(String binlogFileName, long position) throws IOException {
        DumpBinlogCommandPacket dumpCmd = new DumpBinlogCommandPacket();
        dumpCmd.binlogPosition = position;
        dumpCmd.slaveId = 1001;
        dumpCmd.binlogFileName = binlogFileName;
        
        sendPacket(dumpCmd);
        
        // å¼€å§‹æ¥æ”¶binlogäº‹ä»¶æµ
        startReceiveBinlogEvents();
    }
}
```

### 9.2 binlogäº‹ä»¶å¤„ç†æµæ°´çº¿


**ğŸ”„ äº‹ä»¶å¤„ç†Pipeline**
```
Canal binlogäº‹ä»¶å¤„ç†æµæ°´çº¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   binlogäº‹ä»¶æµ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                1. äº‹ä»¶æ¥æ”¶å±‚                              â”‚
â”‚  â€¢ ä»ç½‘ç»œsocketæ¥æ”¶åŸå§‹binlogæ•°æ®                         â”‚
â”‚  â€¢ æŒ‰ç…§MySQLåè®®è§£ææ•°æ®åŒ…                               â”‚
â”‚  â€¢ å¤„ç†ç½‘ç»œå¼‚å¸¸å’Œé‡è¿                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                2. äº‹ä»¶è§£æå±‚                              â”‚
â”‚  â€¢ è§£æbinlogäº‹ä»¶å¤´ä¿¡æ¯                                  â”‚
â”‚  â€¢ æ ¹æ®äº‹ä»¶ç±»å‹è¿›è¡Œå…·ä½“è§£æ                               â”‚
â”‚  â€¢ æ„å»ºCanalå†…éƒ¨äº‹ä»¶å¯¹è±¡                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                3. äº‹ä»¶è¿‡æ»¤å±‚                              â”‚
â”‚  â€¢ åº”ç”¨æ•°æ®åº“/è¡¨è¿‡æ»¤è§„åˆ™                                 â”‚
â”‚  â€¢ åº”ç”¨äº‹ä»¶ç±»å‹è¿‡æ»¤                                      â”‚
â”‚  â€¢ åº”ç”¨è‡ªå®šä¹‰è¿‡æ»¤é€»è¾‘                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                4. äº‹ä»¶å­˜å‚¨å±‚                              â”‚
â”‚  â€¢ å°†äº‹ä»¶å­˜å‚¨åˆ°å†…å­˜ç¼“å†²åŒº                                 â”‚
â”‚  â€¢ ç®¡ç†äº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸ                                    â”‚
â”‚  â€¢ æä¾›äº‹ä»¶æŸ¥è¯¢å’Œæ¶ˆè´¹æ¥å£                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                5. å®¢æˆ·ç«¯æ¶ˆè´¹å±‚                            â”‚
â”‚  â€¢ å“åº”å®¢æˆ·ç«¯çš„è®¢é˜…è¯·æ±‚                                   â”‚
â”‚  â€¢ æ‰¹é‡æ¨é€äº‹ä»¶ç»™å®¢æˆ·ç«¯                                   â”‚
â”‚  â€¢ ç®¡ç†å®¢æˆ·ç«¯æ¶ˆè´¹ä½ç‚¹                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 Canalåè®®äº¤äº’ä¼˜åŒ–


**âš¡ åè®®å±‚é¢ä¼˜åŒ–ç­–ç•¥**
```java
// Canalåè®®ä¼˜åŒ–é…ç½®
public class CanalProtocolOptimizer {
    
    // ç½‘ç»œå±‚ä¼˜åŒ–
    public void optimizeNetwork() {
        // 1. TCPç¼“å†²åŒºä¼˜åŒ–
        socket.setReceiveBufferSize(64 * 1024);  // 64KBæ¥æ”¶ç¼“å†²åŒº
        socket.setSendBufferSize(64 * 1024);     // 64KBå‘é€ç¼“å†²åŒº
        socket.setTcpNoDelay(true);              // ç¦ç”¨Nagleç®—æ³•
        socket.setKeepAlive(true);               // å¯ç”¨TCPå¿ƒè·³
        
        // 2. MySQLè¿æ¥ä¼˜åŒ–
        connectionParams.put("useCompression", "true");        // å¯ç”¨å‹ç¼©
        connectionParams.put("autoReconnect", "true");         // è‡ªåŠ¨é‡è¿
        connectionParams.put("failOverReadOnly", "false");     // æ•…éšœè½¬ç§»è®¾ç½®
        connectionParams.put("maxReconnects", "3");            // æœ€å¤§é‡è¿æ¬¡æ•°
    }
    
    // binlogæ‹‰å–ä¼˜åŒ–
    public void optimizeBinlogFetch() {
        // 1. è®¾ç½®åˆé€‚çš„å¿ƒè·³é—´éš”
        setHeartbeatPeriod(15000); // 15ç§’å¿ƒè·³
        
        // 2. ä¼˜åŒ–binlogè¯»å–ç¼“å†²åŒº
        setBinlogReadBufferSize(1024 * 1024); // 1MBç¼“å†²åŒº
        
        // 3. å¯ç”¨binlogæ ¡éªŒå’Œ
        setChecksumType(ChecksumType.CRC32);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Canalæœ¬è´¨ï¼šåŸºäºMySQL binlogçš„å®æ—¶æ•°æ®åŒæ­¥ä¸­é—´ä»¶
ğŸ”¸ æ ¸å¿ƒåŸç†ï¼šä¼ªè£…æˆMySQL Slaveè·å–å¹¶è§£æbinlogäº‹ä»¶
ğŸ”¸ æ¶æ„è®¾è®¡ï¼šEventParser â†’ EventSink â†’ EventStoreçš„æµæ°´çº¿
ğŸ”¸ æ•°æ®æµè½¬ï¼šbinlog â†’ è§£æ â†’ è¿‡æ»¤ â†’ å­˜å‚¨ â†’ æ¶ˆè´¹
ğŸ”¸ ä½ç‚¹ç®¡ç†ï¼šè®°å½•æ¶ˆè´¹è¿›åº¦ï¼Œæ”¯æŒæ•…éšœæ¢å¤å’Œæ–­ç‚¹ç»­ä¼ 
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆCanalèƒ½å®ç°å®æ—¶åŒæ­¥**
```
å®æ—¶æ€§æ¥æºï¼š
â€¢ åŸºäºbinlogï¼šMySQLå†™å…¥æ—¶ç«‹å³äº§ç”Ÿbinlog
â€¢ åè®®ä¼˜åŒ–ï¼šç›´æ¥ä½¿ç”¨MySQLä¸»ä»å¤åˆ¶åè®®
â€¢ å†…å­˜ç¼“å†²ï¼šé«˜æ€§èƒ½å†…å­˜å­˜å‚¨å‡å°‘å»¶è¿Ÿ
â€¢ æ‰¹é‡å¤„ç†ï¼šæ‰¹é‡è¯»å†™æå‡æ•´ä½“æ€§èƒ½
```

**ğŸ”¹ Canalçš„æ ¸å¿ƒä¼˜åŠ¿**
```
æŠ€æœ¯ä¼˜åŠ¿ï¼š
â€¢ æ— ä¾µå…¥ï¼šä¸éœ€è¦ä¿®æ”¹ä¸šåŠ¡ä»£ç 
â€¢ å®æ—¶æ€§ï¼šæ¯«ç§’çº§å»¶è¿Ÿ
â€¢ å¯é æ€§ï¼šåŸºäºMySQLæˆç†Ÿçš„å¤åˆ¶æœºåˆ¶
â€¢ å¯æ‰©å±•ï¼šæ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼å’Œå­˜å‚¨æ–¹å¼

ä¸šåŠ¡ä»·å€¼ï¼š
â€¢ æ•°æ®ä¸€è‡´æ€§ï¼šä¿è¯å¤šç³»ç»Ÿæ•°æ®åŒæ­¥
â€¢ ç³»ç»Ÿè§£è€¦ï¼šæ¶ˆé™¤ä¸šåŠ¡ç³»ç»Ÿé—´çš„ç›´æ¥ä¾èµ–
â€¢ æ€§èƒ½æå‡ï¼šå¼‚æ­¥å¤„ç†å‡å°‘ä¸»ä¸šåŠ¡å‹åŠ›
â€¢ æˆæœ¬é™ä½ï¼šå‡å°‘å¼€å‘å’Œç»´æŠ¤æˆæœ¬
```

**ğŸ”¹ Canalæ¶æ„è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„**
```
è®¾è®¡äº®ç‚¹ï¼š
â€¢ åˆ†å±‚æ¶æ„ï¼šèŒè´£æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
â€¢ æ’ä»¶åŒ–ï¼šæ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨å’Œå­˜å‚¨
â€¢ é«˜æ€§èƒ½ï¼šå†…å­˜ç¼“å†² + æ‰¹é‡å¤„ç†
â€¢ é«˜å¯ç”¨ï¼šæ”¯æŒé›†ç¾¤éƒ¨ç½²å’Œæ•…éšœè½¬ç§»
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ Canalé€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… éœ€è¦å®æ—¶æ•°æ®åŒæ­¥
âœ… å¤šç³»ç»Ÿæ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜
âœ… å¸Œæœ›ç³»ç»Ÿé—´è§£è€¦
âœ… æœ‰MySQLä½œä¸ºæ•°æ®æº
âœ… å¯¹å»¶è¿Ÿè¦æ±‚è¾ƒé«˜ï¼ˆæ¯«ç§’çº§ï¼‰

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ æ•°æ®æºä¸æ˜¯MySQL
âŒ åªéœ€è¦å®šæ—¶æ‰¹é‡åŒæ­¥
âŒ å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜
âŒ ç³»ç»Ÿè§„æ¨¡å¾ˆå°
âŒ ç½‘ç»œç¯å¢ƒä¸ç¨³å®š
```

**ğŸ”§ Canaléƒ¨ç½²å’Œä¼˜åŒ–å»ºè®®**
```
éƒ¨ç½²å»ºè®®ï¼š
â€¢ ç”Ÿäº§ç¯å¢ƒå»ºè®®é›†ç¾¤éƒ¨ç½²
â€¢ é…ç½®åˆé€‚çš„ç¼“å†²åŒºå¤§å°
â€¢ ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡
â€¢ å®šæœŸå¤‡ä»½ä½ç‚¹ä¿¡æ¯

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®è¿‡æ»¤è§„åˆ™å‡å°‘æ— æ•ˆæ•°æ®
â€¢ ä¼˜åŒ–å®¢æˆ·ç«¯æ¶ˆè´¹é€Ÿåº¦
â€¢ è°ƒæ•´JVMå‚æ•°å‡å°‘GCå½±å“
â€¢ ç›‘æ§ç½‘ç»œå»¶è¿Ÿå’Œååé‡

è¿ç»´æ³¨æ„äº‹é¡¹ï¼š
â€¢ å®šæœŸæ¸…ç†è¿‡æœŸçš„binlogæ–‡ä»¶
â€¢ ç›‘æ§Canalå®ä¾‹çš„å¥åº·çŠ¶æ€
â€¢ å»ºç«‹å®Œå–„çš„å‘Šè­¦æœºåˆ¶
â€¢ åˆ¶å®šæ•…éšœæ¢å¤é¢„æ¡ˆ
```

### 10.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š æ·±å…¥å­¦ä¹ å»ºè®®**
```
åŸºç¡€é˜¶æ®µï¼š
â–¡ ç†è§£MySQL binlogæœºåˆ¶
â–¡ æŒæ¡CanalåŸºæœ¬ä½¿ç”¨
â–¡ å­¦ä¼šé…ç½®è¿‡æ»¤è§„åˆ™
â–¡ ç†Ÿæ‚‰ä½ç‚¹ç®¡ç†

è¿›é˜¶é˜¶æ®µï¼š
â–¡ æ·±å…¥ç†è§£Canalæ¶æ„
â–¡ å­¦ä¹ è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘
â–¡ æŒæ¡é›†ç¾¤éƒ¨ç½²å’Œè¿ç»´
â–¡ æ€§èƒ½è°ƒä¼˜å’Œæ•…éšœæ’æŸ¥

é«˜çº§é˜¶æ®µï¼š
â–¡ æºç é˜…è¯»å’Œè´¡çŒ®
â–¡ æ‰©å±•CanalåŠŸèƒ½
â–¡ ä¸å…¶ä»–ä¸­é—´ä»¶é›†æˆ
â–¡ æ„å»ºå®æ—¶æ•°æ®å¤„ç†å¹³å°
```

### 10.5 å¸¸è§é—®é¢˜è§£ç­”


**ğŸ¤” FAQå¿«é€Ÿè§£ç­”**
```
Q: Canalä¼šå½±å“MySQLæ€§èƒ½å—ï¼Ÿ
A: å½±å“å¾ˆå°ï¼Œç±»ä¼¼äºæ·»åŠ ä¸€ä¸ªåªè¯»ä»åº“

Q: Canalå¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ
A: é€šè¿‡ä½ç‚¹ç®¡ç†å’Œäº‹åŠ¡æ—¥å¿—ä¿è¯

Q: Canalæ”¯æŒå“ªäº›MySQLç‰ˆæœ¬ï¼Ÿ
A: æ”¯æŒMySQL 5.1åŠä»¥ä¸Šç‰ˆæœ¬

Q: Canalèƒ½å¤„ç†å¤§äº‹åŠ¡å—ï¼Ÿ
A: å¯ä»¥ï¼Œä½†å»ºè®®é¿å…è¿‡å¤§çš„äº‹åŠ¡

Q: Canalå¦‚ä½•å¤„ç†DDLäº‹ä»¶ï¼Ÿ
A: æ”¯æŒDDLäº‹ä»¶æ•è·ï¼Œå¯é…ç½®æ˜¯å¦åŒæ­¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Canalä¼ªè£…Slaveå–æ—¥å¿—ï¼Œå®æ—¶è§£ææ— å»¶è¿Ÿ
- Parserè´Ÿè´£è§£æäº‹ä»¶ï¼ŒSinkè¿‡æ»¤Storeç¼“å­˜  
- ä½ç‚¹ç®¡ç†é˜²ä¸¢å¤±ï¼Œæ•…éšœæ¢å¤æœ‰ä¿éšœ
- å†…å­˜ç¼“å†²æ€§èƒ½å¥½ï¼Œæ‰¹é‡å¤„ç†æ•ˆç‡é«˜
- é›†ç¾¤éƒ¨ç½²ä¿å¯ç”¨ï¼Œç›‘æ§è¿ç»´ä¸å¯å°‘