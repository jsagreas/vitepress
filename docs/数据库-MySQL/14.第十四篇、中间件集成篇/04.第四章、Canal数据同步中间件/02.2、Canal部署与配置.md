---
title: 2ã€Canaléƒ¨ç½²ä¸é…ç½®
---
## ğŸ“š ç›®å½•

1. [CanalåŸºç¡€æ¦‚å¿µ](#1-CanalåŸºç¡€æ¦‚å¿µ)
2. [MySQLç¯å¢ƒå‡†å¤‡](#2-MySQLç¯å¢ƒå‡†å¤‡)
3. [Canal Serveréƒ¨ç½²](#3-Canal-Serveréƒ¨ç½²)
4. [Canalé…ç½®è¯¦è§£](#4-Canalé…ç½®è¯¦è§£)
5. [Canalå®¢æˆ·ç«¯é…ç½®](#5-Canalå®¢æˆ·ç«¯é…ç½®)
6. [é›†ç¾¤éƒ¨ç½²æ¶æ„](#6-é›†ç¾¤éƒ¨ç½²æ¶æ„)
7. [è¿ç»´ç®¡ç†å®è·µ](#7-è¿ç»´ç®¡ç†å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ CanalåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Canal


**Canalç®€å•ç†è§£**ï¼šCanalå°±åƒæ˜¯MySQLæ•°æ®åº“çš„"ç›‘å¬å™¨"ï¼Œå®æ—¶ç›‘æ§æ•°æ®å˜åŒ–å¹¶åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿã€‚

```
ç°å®æ¯”å–»ï¼š
Canal = é“¶è¡Œæµæ°´ç›‘æ§ç³»ç»Ÿ
MySQL = é“¶è¡Œè´¦æˆ·
binlog = è´¦æˆ·æµæ°´è®°å½•
Canalå®¢æˆ·ç«¯ = æ¥æ”¶æµæ°´é€šçŸ¥çš„åº”ç”¨

å½“è´¦æˆ·æœ‰ä»»ä½•å˜åŠ¨æ—¶ï¼Œç›‘æ§ç³»ç»Ÿç«‹å³é€šçŸ¥ç›¸å…³åº”ç”¨
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **æ•°æ®åŒæ­¥**ï¼šæŠŠMySQLçš„æ•°æ®å˜åŒ–å®æ—¶åŒæ­¥åˆ°å…¶ä»–æ•°æ®åº“
- **ç¼“å­˜æ›´æ–°**ï¼šæ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°Redisç¼“å­˜
- **æœç´¢å¼•æ“åŒæ­¥**ï¼šåŒæ­¥æ•°æ®åˆ°Elasticsearch
- **æ¶ˆæ¯å‘é€**ï¼šæ•°æ®å˜åŒ–æ—¶å‘é€æ¶ˆæ¯é€šçŸ¥

### 1.2 Canalå·¥ä½œåŸç†


**åŸºæœ¬åŸç†**ï¼šCanalä¼ªè£…æˆMySQLçš„ä»åº“ï¼Œè¯»å–MySQLçš„binlogæ—¥å¿—

```
å·¥ä½œæµç¨‹å›¾ï¼š
MySQLä¸»åº“ â”€â”€binlogâ”€â”€> Canal Server â”€â”€è§£æâ”€â”€> Canalå®¢æˆ·ç«¯ â”€â”€å¤„ç†â”€â”€> ç›®æ ‡ç³»ç»Ÿ
    â”‚                      â”‚                    â”‚                â”‚
    â”‚                      â”‚                    â”‚                â””â”€> Redis
    â”‚                      â”‚                    â””â”€> æ¶ˆæ¯é˜Ÿåˆ— â”€â”€> Elasticsearch
    â”‚                      â””â”€> è§£æSQLå˜åŒ–                    â””â”€> å…¶ä»–æ•°æ®åº“
    â””â”€> äº§ç”Ÿbinlogæ—¥å¿—
```

**å…³é”®ç†è§£**ï¼š
- MySQLæ¯æ¬¡æ•°æ®å˜åŒ–éƒ½ä¼šå†™å…¥binlog
- Canalè¯»å–binlogå¹¶è§£ææˆç»“æ„åŒ–æ•°æ®
- å®¢æˆ·ç«¯æ¥æ”¶è§£æåçš„æ•°æ®è¿›è¡Œä¸šåŠ¡å¤„ç†

---

## 2. ğŸ—„ï¸ MySQLç¯å¢ƒå‡†å¤‡


### 2.1 å¼€å¯binlogåŠŸèƒ½


**ä¸ºä»€ä¹ˆéœ€è¦binlog**ï¼šCanaléœ€è¦è¯»å–MySQLçš„å˜æ›´æ—¥å¿—æ¥è·å–æ•°æ®å˜åŒ–

**æ£€æŸ¥binlogçŠ¶æ€**ï¼š
```sql
-- æŸ¥çœ‹binlogæ˜¯å¦å¼€å¯
SHOW VARIABLES LIKE 'log_bin';

-- æŸ¥çœ‹binlogæ ¼å¼
SHOW VARIABLES LIKE 'binlog_format';

-- æŸ¥çœ‹å½“å‰binlogæ–‡ä»¶
SHOW MASTER STATUS;
```

**é…ç½®binlogï¼ˆéœ€è¦é‡å¯MySQLï¼‰**ï¼š
```ini
# my.cnfæ–‡ä»¶é…ç½®
[mysqld]
# å¼€å¯binlog
log-bin=mysql-bin

# è®¾ç½®binlogæ ¼å¼ä¸ºROWï¼ˆé‡è¦ï¼ï¼‰
binlog-format=ROW

# è®¾ç½®server-idï¼ˆé›†ç¾¤ç¯å¢ƒä¸‹æ¯ä¸ªèŠ‚ç‚¹å”¯ä¸€ï¼‰
server-id=1

# binlogä¿ç•™æ—¶é—´ï¼ˆå¤©ï¼‰
expire_logs_days=7
```

> ğŸ’¡ **æ ¼å¼è¯´æ˜**ï¼š
> - **ROWæ ¼å¼**ï¼šè®°å½•æ¯è¡Œæ•°æ®çš„å…·ä½“å˜åŒ–ï¼ŒCanalæ¨èæ ¼å¼
> - **STATEMENTæ ¼å¼**ï¼šè®°å½•SQLè¯­å¥ï¼Œå¯èƒ½æœ‰æ•°æ®ä¸ä¸€è‡´é£é™©
> - **MIXEDæ ¼å¼**ï¼šæ··åˆæ¨¡å¼ï¼Œä¸æ¨èCanalä½¿ç”¨

### 2.2 åˆ›å»ºCanalä¸“ç”¨ç”¨æˆ·


**ç”¨æˆ·æƒé™åŸç†**ï¼šCanaléœ€è¦è¯»å–binlogå’ŒæŸ¥è¯¢è¡¨ç»“æ„ä¿¡æ¯

```sql
-- åˆ›å»ºCanalç”¨æˆ·
CREATE USER 'canal'@'%' IDENTIFIED BY 'canal123';

-- æˆäºˆå¿…è¦æƒé™
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;

-- éªŒè¯ç”¨æˆ·æƒé™
SHOW GRANTS FOR 'canal'@'%';
```

**æƒé™è§£é‡Š**ï¼š
- `SELECT`ï¼šæŸ¥è¯¢è¡¨ç»“æ„å’Œæ•°æ®
- `REPLICATION SLAVE`ï¼šè¯»å–binlogæƒé™
- `REPLICATION CLIENT`ï¼šè·å–ä¸»åº“çŠ¶æ€æƒé™

---

## 3. ğŸš€ Canal Serveréƒ¨ç½²


### 3.1 ä¸‹è½½å®‰è£…Canal


**ä¸‹è½½åœ°å€**ï¼šhttps://github.com/alibaba/canal/releases

```bash
# ä¸‹è½½Canalï¼ˆä»¥1.1.6ç‰ˆæœ¬ä¸ºä¾‹ï¼‰
wget https://github.com/alibaba/canal/releases/download/canal-1.1.6/canal.deployer-1.1.6.tar.gz

# åˆ›å»ºå®‰è£…ç›®å½•
mkdir /opt/canal
cd /opt/canal

# è§£å‹
tar -zxvf canal.deployer-1.1.6.tar.gz

# æŸ¥çœ‹ç›®å½•ç»“æ„
ls -la
```

**ç›®å½•ç»“æ„è¯´æ˜**ï¼š
```
canal/
â”œâ”€â”€ bin/              # å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ startup.sh   # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ stop.sh      # åœæ­¢è„šæœ¬
â”œâ”€â”€ conf/            # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ canal.properties     # å…¨å±€é…ç½®
â”‚   â””â”€â”€ example/            # å®ä¾‹é…ç½®ç›®å½•
â”‚       â””â”€â”€ instance.properties
â”œâ”€â”€ lib/             # ä¾èµ–jaråŒ…
â””â”€â”€ logs/            # æ—¥å¿—ç›®å½•
```

### 3.2 JVMç¯å¢ƒè¦æ±‚


**Javaç‰ˆæœ¬è¦æ±‚**ï¼šJDK 8æˆ–æ›´é«˜ç‰ˆæœ¬

```bash
# æ£€æŸ¥Javaç‰ˆæœ¬
java -version

# å¦‚æœæ²¡æœ‰Javaï¼Œå®‰è£…OpenJDK
# CentOS/RHEL
yum install -y java-1.8.0-openjdk

# Ubuntu/Debian
apt update && apt install -y openjdk-8-jdk
```

---

## 4. âš™ï¸ Canalé…ç½®è¯¦è§£


### 4.1 å…¨å±€é…ç½®æ–‡ä»¶


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`conf/canal.properties`

```properties
# CanalæœåŠ¡ç«¯å£ï¼ˆé»˜è®¤11111ï¼‰
canal.port = 11111

# Canalå®ä¾‹é…ç½®
canal.destinations = example,order_sync

# ç®¡ç†ç«¯å£ï¼ˆç”¨äºç®¡ç†å’Œç›‘æ§ï¼‰
canal.admin.manager = 127.0.0.1:11110

# æ•°æ®å­˜å‚¨æ¨¡å¼
canal.instance.memory.buffer.size = 16384
canal.instance.memory.buffer.memunit = 1024

# ç½‘ç»œé…ç½®
canal.instance.network.receiveBufferSize = 16384
canal.instance.network.sendBufferSize = 16384

# å¿ƒè·³é…ç½®
canal.instance.detecting.enable = false
canal.instance.detecting.sql = insert into retl.xdual values(1,now()) on duplicate key update x=now()
```

**å…³é”®å‚æ•°è§£é‡Š**ï¼š

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `canal.port` | CanalæœåŠ¡ç›‘å¬ç«¯å£ | `11111` |
| `canal.destinations` | å®ä¾‹åç§°åˆ—è¡¨ | `æ ¹æ®ä¸šåŠ¡å‘½å` |
| `memory.buffer.size` | å†…å­˜ç¼“å†²åŒºå¤§å° | `16384` |
| `network.receiveBufferSize` | ç½‘ç»œæ¥æ”¶ç¼“å†²åŒº | `16384` |

### 4.2 å®ä¾‹é…ç½®æ–‡ä»¶


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š`conf/example/instance.properties`

```properties
# MySQLè¿æ¥é…ç½®
canal.instance.master.address=127.0.0.1:3306
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal123

# binlogé…ç½®
canal.instance.connectionCharset = UTF-8
canal.instance.enableDruid=false

# è¿‡æ»¤é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
# ç›‘æ§æ‰€æœ‰æ•°æ®åº“çš„æ‰€æœ‰è¡¨
canal.instance.filter.regex=.*\\..*

# åªç›‘æ§ç‰¹å®šæ•°æ®åº“
# canal.instance.filter.regex=test\\..*

# æ’é™¤ç‰¹å®šè¡¨
# canal.instance.filter.black.regex=test\\.black_table

# ä½ç‚¹å­˜å‚¨
canal.instance.meta.manager=
```

**è¿‡æ»¤è§„åˆ™è¯¦è§£**ï¼š

```properties
# ç›‘æ§è§„åˆ™ç¤ºä¾‹

# 1. ç›‘æ§æ‰€æœ‰æ•°æ®åº“æ‰€æœ‰è¡¨
canal.instance.filter.regex=.*\\..*

# 2. ç›‘æ§ç‰¹å®šæ•°æ®åº“
canal.instance.filter.regex=shop_db\\..*

# 3. ç›‘æ§å¤šä¸ªæ•°æ®åº“
canal.instance.filter.regex=shop_db\\..*,user_db\\..*

# 4. ç›‘æ§ç‰¹å®šè¡¨
canal.instance.filter.regex=shop_db\\.product,shop_db\\.order

# 5. æ’é™¤ç‰¹å®šè¡¨ï¼ˆé»‘åå•ï¼‰
canal.instance.filter.black.regex=.*\\.temp_.*,.*\\.backup_.*
```

### 4.3 é…ç½®æ¨¡æ¿ç®¡ç†


**åˆ›å»ºé…ç½®æ¨¡æ¿**ï¼š
```bash
# å¤åˆ¶exampleåˆ›å»ºæ–°å®ä¾‹
cp -r conf/example conf/order_sync

# ä¿®æ”¹å®ä¾‹é…ç½®
vim conf/order_sync/instance.properties
```

**å¤šå®ä¾‹é…ç½®ç¤ºä¾‹**ï¼š
```properties
# è®¢å•åŒæ­¥å®ä¾‹é…ç½®
canal.instance.master.address=192.168.1.100:3306
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal123
canal.instance.filter.regex=order_db\\.orders,order_db\\.order_items

# ç”¨æˆ·åŒæ­¥å®ä¾‹é…ç½®  
canal.instance.master.address=192.168.1.101:3306
canal.instance.dbUsername=canal
canal.instance.dbPassword=canal123
canal.instance.filter.regex=user_db\\.users,user_db\\.user_profiles
```

---

## 5. ğŸ“± Canalå®¢æˆ·ç«¯é…ç½®


### 5.1 Javaå®¢æˆ·ç«¯ç¤ºä¾‹


**Mavenä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>com.alibaba.otter</groupId>
    <artifactId>canal.client</artifactId>
    <version>1.1.6</version>
</dependency>
```

**ç®€å•å®¢æˆ·ç«¯ä»£ç **ï¼š
```java
public class SimpleCanalClient {
    public static void main(String[] args) {
        // åˆ›å»ºè¿æ¥
        CanalConnector connector = CanalConnectors.newSingleConnector(
            new InetSocketAddress("127.0.0.1", 11111), 
            "example", // å®ä¾‹å
            "", ""     // ç”¨æˆ·åå¯†ç 
        );
        
        try {
            connector.connect();
            connector.subscribe(".*\\..*"); // è®¢é˜…è§„åˆ™
            
            while (true) {
                // è·å–æ•°æ®å˜åŒ–
                Message message = connector.getWithoutAck(100);
                long batchId = message.getBatchId();
                
                if (batchId != -1) {
                    processEntries(message.getEntries());
                    connector.ack(batchId); // ç¡®è®¤æ¶ˆè´¹
                }
            }
        } finally {
            connector.disconnect();
        }
    }
    
    private static void processEntries(List<Entry> entries) {
        for (Entry entry : entries) {
            if (entry.getEntryType() == EntryType.ROWDATA) {
                RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                String tableName = entry.getHeader().getTableName();
                
                for (RowData rowData : rowChange.getRowDatasList()) {
                    if (rowChange.getEventType() == EventType.INSERT) {
                        System.out.println("æ–°å¢æ•°æ®: " + tableName);
                        printColumns(rowData.getAfterColumnsList());
                    } else if (rowChange.getEventType() == EventType.UPDATE) {
                        System.out.println("æ›´æ–°æ•°æ®: " + tableName);
                        printColumns(rowData.getAfterColumnsList());
                    } else if (rowChange.getEventType() == EventType.DELETE) {
                        System.out.println("åˆ é™¤æ•°æ®: " + tableName);
                        printColumns(rowData.getBeforeColumnsList());
                    }
                }
            }
        }
    }
}
```

### 5.2 å®¢æˆ·ç«¯é…ç½®æœ€ä½³å®è·µ


**è¿æ¥æ± é…ç½®**ï¼š
```java
// ä½¿ç”¨è¿æ¥æ± æé«˜æ€§èƒ½
CanalConnector connector = CanalConnectors.newClusterConnector(
    Arrays.asList(
        new InetSocketAddress("192.168.1.100", 11111),
        new InetSocketAddress("192.168.1.101", 11111)
    ),
    "example",
    "", ""
);
```

**å¼‚å¸¸å¤„ç†**ï¼š
```java
public class RobustCanalClient {
    private static final int RETRY_TIMES = 3;
    
    public void consume() {
        int retryCount = 0;
        while (retryCount < RETRY_TIMES) {
            try {
                doConsume();
                break;
            } catch (Exception e) {
                retryCount++;
                if (retryCount >= RETRY_TIMES) {
                    throw new RuntimeException("Canalæ¶ˆè´¹å¤±è´¥", e);
                }
                try {
                    Thread.sleep(1000 * retryCount);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
}
```

---

## 6. ğŸ—ï¸ é›†ç¾¤éƒ¨ç½²æ¶æ„


### 6.1 Canalé›†ç¾¤æ¶æ„


**é›†ç¾¤éƒ¨ç½²åŸç†**ï¼šå¤šä¸ªCanal Serverå®ä¾‹å…±åŒå·¥ä½œï¼Œæä¾›é«˜å¯ç”¨æ€§

```
é›†ç¾¤æ¶æ„å›¾ï¼š
                    MySQLä¸»åº“
                       â”‚
                   binlogæ—¥å¿—
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
    Canal-1         Canal-2       Canal-3
    (Active)       (Standby)     (Standby)
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                   ZooKeeper
                   (åè°ƒè€…)
                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                â”‚             â”‚
            Client-1      Client-2
```

### 6.2 ZooKeeperé›†ç¾¤é…ç½®


**å®‰è£…ZooKeeper**ï¼š
```bash
# ä¸‹è½½ZooKeeper
wget https://downloads.apache.org/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz

# è§£å‹å®‰è£…
tar -zxvf apache-zookeeper-3.7.0-bin.tar.gz -C /opt/
cd /opt/apache-zookeeper-3.7.0-bin

# é…ç½®ZooKeeper
cp conf/zoo_sample.cfg conf/zoo.cfg
```

**ZooKeeperé…ç½®**ï¼š
```properties
# zoo.cfg
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/opt/zookeeper/data
clientPort=2181

# é›†ç¾¤é…ç½®
server.1=192.168.1.100:2888:3888
server.2=192.168.1.101:2888:3888
server.3=192.168.1.102:2888:3888
```

### 6.3 Canalé›†ç¾¤é…ç½®


**ä¿®æ”¹canal.propertieså¯ç”¨é›†ç¾¤**ï¼š
```properties
# å¯ç”¨é›†ç¾¤æ¨¡å¼
canal.zkServers = 192.168.1.100:2181,192.168.1.101:2181,192.168.1.102:2181

# é›†ç¾¤èŠ‚ç‚¹ID
canal.auto.scan = true
canal.auto.scan.interval = 5

# å®ä¾‹é…ç½®
canal.destinations = example
```

**å®ä¾‹é…ç½®å¯ç”¨HA**ï¼š
```properties
# instance.properties
# å¯ç”¨HAæ¨¡å¼
canal.instance.global.mode = spring
canal.instance.global.lazy = false

# ZooKeeperé…ç½®
canal.instance.global.spring.xml = classpath:spring/ha-default.xml
```

### 6.4 é›†ç¾¤éƒ¨ç½²è„šæœ¬


**è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**ï¼š
```bash
#!/bin/bash
# deploy_canal_cluster.sh

CANAL_VERSION="1.1.6"
NODES=("192.168.1.100" "192.168.1.101" "192.168.1.102")

for node in "${NODES[@]}"; do
    echo "éƒ¨ç½²Canalåˆ°èŠ‚ç‚¹: $node"
    
    # å¤åˆ¶å®‰è£…åŒ…
    scp canal.deployer-${CANAL_VERSION}.tar.gz root@$node:/opt/
    
    # è¿œç¨‹å®‰è£…
    ssh root@$node "
        cd /opt && 
        tar -zxvf canal.deployer-${CANAL_VERSION}.tar.gz &&
        mv canal.deployer-${CANAL_VERSION} canal
    "
    
    # å¤åˆ¶é…ç½®æ–‡ä»¶
    scp conf/canal.properties root@$node:/opt/canal/conf/
    scp -r conf/example root@$node:/opt/canal/conf/
    
    # å¯åŠ¨æœåŠ¡
    ssh root@$node "/opt/canal/bin/startup.sh"
    
    echo "èŠ‚ç‚¹ $node éƒ¨ç½²å®Œæˆ"
done
```

---

## 7. ğŸ”§ è¿ç»´ç®¡ç†å®è·µ


### 7.1 å¯åŠ¨åœæ­¢ç®¡ç†


**å¯åŠ¨Canal**ï¼š
```bash
# å¯åŠ¨Canal
cd /opt/canal
./bin/startup.sh

# æ£€æŸ¥å¯åŠ¨çŠ¶æ€
tail -f logs/canal/canal.log

# æ£€æŸ¥å®ä¾‹æ—¥å¿—
tail -f logs/example/example.log
```

**åœæ­¢Canal**ï¼š
```bash
# ä¼˜é›…åœæ­¢
./bin/stop.sh

# å¼ºåˆ¶åœæ­¢
ps aux | grep canal | grep -v grep | awk '{print $2}' | xargs kill -9
```

### 7.2 æ—¥å¿—é…ç½®ç®¡ç†


**ä¿®æ”¹æ—¥å¿—çº§åˆ«**ï¼š
```xml
<!-- conf/logback.xml -->
<configuration>
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- è®¾ç½®æ—¥å¿—çº§åˆ« -->
    <logger name="com.alibaba.otter.canal" level="INFO"/>
    
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
</configuration>
```

### 7.3 ç›‘æ§æŒ‡æ ‡é…ç½®


**JVMç›‘æ§**ï¼š
```bash
# æ·»åŠ JVMç›‘æ§å‚æ•°
export JAVA_OPTS="-server -Xms2048m -Xmx3072m -XX:NewSize=256m -XX:MaxNewSize=256m -XX:MaxPermSize=128m"

# å¯ç”¨JMXç›‘æ§
export JAVA_OPTS="$JAVA_OPTS -Djava.rmi.server.hostname=192.168.1.100"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.port=9999"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=false"
export JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false"
```

### 7.4 å¤šç¯å¢ƒé…ç½®ç®¡ç†


**ç¯å¢ƒé…ç½®ç­–ç•¥**ï¼š
```bash
# åˆ›å»ºç¯å¢ƒé…ç½®ç›®å½•
mkdir -p conf/env/{dev,test,prod}

# å¼€å‘ç¯å¢ƒé…ç½®
cat > conf/env/dev/canal.properties << EOF
canal.port = 11111
canal.destinations = dev_sync
EOF

# ç”Ÿäº§ç¯å¢ƒé…ç½®
cat > conf/env/prod/canal.properties << EOF
canal.port = 11111
canal.destinations = prod_order,prod_user
canal.instance.memory.buffer.size = 32768
EOF
```

**é…ç½®åˆ‡æ¢è„šæœ¬**ï¼š
```bash
#!/bin/bash
# switch_env.sh

ENV=$1
if [ -z "$ENV" ]; then
    echo "ä½¿ç”¨æ–¹å¼: $0 {dev|test|prod}"
    exit 1
fi

# å¤‡ä»½å½“å‰é…ç½®
cp conf/canal.properties conf/canal.properties.bak

# åˆ‡æ¢é…ç½®
cp conf/env/$ENV/canal.properties conf/
cp -r conf/env/$ENV/instances/* conf/

echo "å·²åˆ‡æ¢åˆ° $ENV ç¯å¢ƒ"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Canalæœ¬è´¨ï¼šMySQL binlogè§£æå’Œåˆ†å‘ä¸­é—´ä»¶
ğŸ”¸ å·¥ä½œåŸç†ï¼šä¼ªè£…æˆMySQLä»åº“è¯»å–binlog
ğŸ”¸ æ ¸å¿ƒé…ç½®ï¼šå…¨å±€é…ç½® + å®ä¾‹é…ç½®
ğŸ”¸ è¿‡æ»¤è§„åˆ™ï¼šæ­£åˆ™è¡¨è¾¾å¼æ§åˆ¶ç›‘æ§èŒƒå›´
ğŸ”¸ é›†ç¾¤æ¨¡å¼ï¼šZooKeeperåè°ƒçš„HAé›†ç¾¤
ğŸ”¸ å®¢æˆ·ç«¯ï¼šè¿æ¥Canalè·å–æ•°æ®å˜åŒ–äº‹ä»¶
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é…ç½®ä¼˜å…ˆçº§**ï¼š
```
å®ä¾‹é…ç½® > å…¨å±€é…ç½® > é»˜è®¤å€¼
å®ä¾‹é…ç½®æ–‡ä»¶ä¼šè¦†ç›–å…¨å±€é…ç½®çš„ç›¸åŒå‚æ•°
```

**ğŸ”¹ è¿‡æ»¤è§„åˆ™è®¾è®¡**ï¼š
```
ç™½åå•ï¼šcanal.instance.filter.regexï¼ˆåŒ…å«è§„åˆ™ï¼‰
é»‘åå•ï¼šcanal.instance.filter.black.regexï¼ˆæ’é™¤è§„åˆ™ï¼‰
è§„åˆ™è¯­æ³•ï¼šæ•°æ®åº“.è¡¨åï¼Œæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼
```

**ğŸ”¹ å†…å­˜ç¼“å†²åŒºè®¾è®¡**ï¼š
```
buffer.sizeï¼šæ§åˆ¶å†…å­˜ä½¿ç”¨é‡
memunitï¼šå†…å­˜å•ä½å¤§å°
åˆç†é…ç½®é¿å…OOMå’Œæ€§èƒ½é—®é¢˜
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **æ•°æ®åŒæ­¥**ï¼šä¸»ä»æ•°æ®åº“åŒæ­¥ã€å¼‚æ„æ•°æ®åº“åŒæ­¥
- **ç¼“å­˜æ›´æ–°**ï¼šMySQLå˜åŒ–è‡ªåŠ¨æ›´æ–°Redisç¼“å­˜
- **æœç´¢å¼•æ“**ï¼šå®æ—¶åŒæ­¥æ•°æ®åˆ°Elasticsearch
- **æ¶ˆæ¯é€šçŸ¥**ï¼šæ•°æ®å˜åŒ–è§¦å‘ä¸šåŠ¡æ¶ˆæ¯
- **æ•°æ®åˆ†æ**ï¼šå®æ—¶æ•°æ®æµå…¥åˆ†æç³»ç»Ÿ

**è¿ç»´å®è·µä»·å€¼**ï¼š
- **é«˜å¯ç”¨éƒ¨ç½²**ï¼šé›†ç¾¤æ¨¡å¼ä¿è¯æœåŠ¡ç¨³å®šæ€§
- **é…ç½®ç®¡ç†**ï¼šå¤šç¯å¢ƒé…ç½®è‡ªåŠ¨åŒ–ç®¡ç†
- **ç›‘æ§å‘Šè­¦**ï¼šJVMå’Œä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
- **æ•…éšœæ¢å¤**ï¼šè‡ªåŠ¨é‡è¿å’Œæ–­ç‚¹ç»­ä¼ æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- Canalæ˜¯MySQLæ•°æ®å˜åŒ–çš„å®æ—¶ç›‘å¬å™¨
- binlogæ˜¯Canalå·¥ä½œçš„æ•°æ®æºï¼Œå¿…é¡»æ­£ç¡®é…ç½®
- è¿‡æ»¤è§„åˆ™å†³å®šç›‘æ§èŒƒå›´ï¼Œåˆç†è®¾è®¡å¾ˆé‡è¦
- é›†ç¾¤éƒ¨ç½²éœ€è¦ZooKeeperåè°ƒï¼Œæä¾›é«˜å¯ç”¨
- å®¢æˆ·ç«¯è´Ÿè´£å…·ä½“ä¸šåŠ¡é€»è¾‘ï¼ŒCanalåªè´Ÿè´£æ•°æ®åˆ†å‘

> ğŸ’¡ **éƒ¨ç½²å»ºè®®**ï¼š
> - ç”Ÿäº§ç¯å¢ƒå»ºè®®é›†ç¾¤éƒ¨ç½²ï¼Œè‡³å°‘3ä¸ªèŠ‚ç‚¹
> - MySQLç”¨æˆ·æƒé™æŒ‰æœ€å°åŸåˆ™åˆ†é…
> - è¿‡æ»¤è§„åˆ™å…ˆæµ‹è¯•åä¸Šçº¿ï¼Œé¿å…æ€§èƒ½é—®é¢˜
> - å®šæœŸç›‘æ§binlogå»¶è¿Ÿå’Œå†…å­˜ä½¿ç”¨æƒ…å†µ