---
title: 3ã€Canalæ•°æ®åŒæ­¥å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [Canalæ•°æ®åŒæ­¥åŸºç¡€æ¦‚å¿µ](#1-Canalæ•°æ®åŒæ­¥åŸºç¡€æ¦‚å¿µ)
2. [å®æ—¶æ•°æ®åŒæ­¥å®ç°](#2-å®æ—¶æ•°æ®åŒæ­¥å®ç°)
3. [åŒæ­¥è§„åˆ™é…ç½®è¯¦è§£](#3-åŒæ­¥è§„åˆ™é…ç½®è¯¦è§£)
4. [æ•°æ®æ ¼å¼è½¬æ¢æŠ€æœ¯](#4-æ•°æ®æ ¼å¼è½¬æ¢æŠ€æœ¯)
5. [ç›®æ ‡ç³»ç»Ÿé€‚é…é›†æˆ](#5-ç›®æ ‡ç³»ç»Ÿé€‚é…é›†æˆ)
6. [åŒæ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-åŒæ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶](#7-æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶)
8. [åŒæ­¥ç›‘æ§ä¸å‘Šè­¦](#8-åŒæ­¥ç›‘æ§ä¸å‘Šè­¦)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¡ Canalæ•°æ®åŒæ­¥åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Canalæ•°æ®åŒæ­¥


**ç®€å•ç†è§£**ï¼šCanalå°±åƒæ˜¯ä¸€ä¸ª"æ•°æ®æ¬è¿å·¥"ï¼Œå®ƒèƒ½å®æ—¶ç›‘å¬MySQLæ•°æ®åº“çš„å˜åŒ–ï¼Œç„¶åæŠŠè¿™äº›å˜åŒ–æ¬è¿åˆ°å…¶ä»–åœ°æ–¹ã€‚

```
ä¼ ç»Ÿæ•°æ®åŒæ­¥é—®é¢˜ï¼š
å®šæ—¶ä»»åŠ¡åŒæ­¥ â†’ å»¶è¿Ÿé«˜ï¼Œå®æ—¶æ€§å·®
æ‰‹åŠ¨å¯¼å…¥å¯¼å‡º â†’ æ•ˆç‡ä½ï¼Œå®¹æ˜“å‡ºé”™
åŒå†™ä»£ç  â†’ å¤æ‚åº¦é«˜ï¼Œç»´æŠ¤å›°éš¾

Canalè§£å†³æ–¹æ¡ˆï¼š
MySQLå˜åŒ– â†’ Canalç›‘å¬ â†’ å®æ—¶åŒæ­¥ â†’ ç›®æ ‡ç³»ç»Ÿ
è‡ªåŠ¨ã€å®æ—¶ã€å¯é 
```

**ğŸ” æ ¸å¿ƒå·¥ä½œåŸç†**
```
æ•°æ®åŒæ­¥é“¾è·¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL     â”‚â”€â”€â”€â–¶â”‚   Canal     â”‚â”€â”€â”€â–¶â”‚  ç›®æ ‡ç³»ç»Ÿ    â”‚
â”‚  (ä¸»åº“)     â”‚    â”‚ (ç›‘å¬+è½¬æ¢)  â”‚    â”‚ ES/Redisç­‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Canalä¼ªè£…æˆMySQLä»åº“ï¼Œè¯»å–binlogæ—¥å¿—
è§£æbinlogä¸­çš„å¢åˆ æ”¹æ“ä½œ
è½¬æ¢æˆç›®æ ‡æ ¼å¼å¹¶å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ
```

### 1.2 æ•°æ®åŒæ­¥çš„æ ¸å¿ƒä»·å€¼


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åŒæ­¥**
```
ä¸šåŠ¡åœºæ™¯éœ€æ±‚ï¼š
ğŸ”¸ æœç´¢ç³»ç»Ÿï¼šMySQLæ•°æ® â†’ Elasticsearch
ğŸ”¸ ç¼“å­˜æ›´æ–°ï¼šMySQLæ•°æ® â†’ Redis
ğŸ”¸ æ•°æ®åˆ†æï¼šMySQLæ•°æ® â†’ æ•°æ®ä»“åº“
ğŸ”¸ æ¶ˆæ¯é€šçŸ¥ï¼šæ•°æ®å˜åŒ– â†’ æ¶ˆæ¯é˜Ÿåˆ—
```

**ä¼ ç»Ÿæ–¹æ¡ˆ vs Canalæ–¹æ¡ˆå¯¹æ¯”ï¼š**

| å¯¹æ¯”ç»´åº¦ | **ä¼ ç»Ÿå®šæ—¶åŒæ­¥** | **Canalå®æ—¶åŒæ­¥** |
|---------|-----------------|------------------|
| ğŸ•’ **å®æ—¶æ€§** | `åˆ†é’Ÿçº§å»¶è¿Ÿ` | `ç§’çº§å»¶è¿Ÿ` |
| ğŸ“Š **æ•°æ®ä¸€è‡´æ€§** | `å®¹æ˜“å‡ºç°ä¸ä¸€è‡´` | `å¼ºä¸€è‡´æ€§ä¿è¯` |
| ğŸ”§ **å¼€å‘å¤æ‚åº¦** | `éœ€è¦ç¼–å†™å¤§é‡ä»£ç ` | `é…ç½®é©±åŠ¨ï¼Œä»£ç å°‘` |
| âš¡ **æ€§èƒ½å½±å“** | `å®šæ—¶å…¨é‡æŸ¥è¯¢ï¼Œå½±å“å¤§` | `å¢é‡åŒæ­¥ï¼Œå½±å“å°` |
| ğŸ›  **ç»´æŠ¤æˆæœ¬** | `éœ€è¦ç»´æŠ¤å®šæ—¶ä»»åŠ¡` | `ç›‘æ§CanalçŠ¶æ€å³å¯` |

---

## 2. âš¡ å®æ—¶æ•°æ®åŒæ­¥å®ç°


### 2.1 Canalå®¢æˆ·ç«¯å¼€å‘å®æˆ˜


**ğŸ— åŸºç¡€å®¢æˆ·ç«¯å®ç°**
```java
// Canalå®¢æˆ·ç«¯è¿æ¥é…ç½®
@Configuration
public class CanalConfig {
    
    @Bean
    public CanalConnector canalConnector() {
        // è¿æ¥CanalæœåŠ¡å™¨
        CanalConnector connector = CanalConnectors.newSingleConnector(
            new InetSocketAddress("127.0.0.1", 11111),
            "example",  // destinationåç§°
            "",         // ç”¨æˆ·å
            ""          // å¯†ç 
        );
        
        connector.connect();
        connector.subscribe(".*\\..*");  // è®¢é˜…æ‰€æœ‰åº“æ‰€æœ‰è¡¨
        connector.rollback();
        
        return connector;
    }
}

// æ•°æ®åŒæ­¥å¤„ç†å™¨
@Component
public class DataSyncProcessor {
    
    @Autowired
    private CanalConnector connector;
    
    @Autowired
    private ElasticsearchService esService;
    
    // å¯åŠ¨æ•°æ®åŒæ­¥ç›‘å¬
    @PostConstruct
    public void startSync() {
        new Thread(this::processData).start();
    }
    
    private void processData() {
        while (true) {
            try {
                // è·å–æ•°æ®å˜åŒ–
                Message message = connector.getWithoutAck(100);
                
                if (message.getId() != -1 && !message.getEntries().isEmpty()) {
                    processEntries(message.getEntries());
                    connector.ack(message.getId()); // ç¡®è®¤æ¶ˆè´¹
                }
                
                Thread.sleep(1000); // 1ç§’æ£€æŸ¥ä¸€æ¬¡
                
            } catch (Exception e) {
                log.error("æ•°æ®åŒæ­¥å¼‚å¸¸", e);
                connector.rollback(); // å›æ»šæœªç¡®è®¤çš„æ¶ˆæ¯
            }
        }
    }
}
```

### 2.2 æ•°æ®å˜åŒ–äº‹ä»¶å¤„ç†


**ğŸ“ è§£æbinlogäº‹ä»¶**
```java
private void processEntries(List<Entry> entries) {
    for (Entry entry : entries) {
        // åªå¤„ç†æ•°æ®å˜åŒ–äº‹ä»¶
        if (entry.getEntryType() == EntryType.ROWDATA) {
            RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
            
            String database = entry.getHeader().getSchemaName();
            String table = entry.getHeader().getTableName();
            
            // æ ¹æ®æ“ä½œç±»å‹åˆ†åˆ«å¤„ç†
            switch (rowChange.getEventType()) {
                case INSERT:
                    handleInsert(database, table, rowChange);
                    break;
                case UPDATE:
                    handleUpdate(database, table, rowChange);
                    break;
                case DELETE:
                    handleDelete(database, table, rowChange);
                    break;
            }
        }
    }
}

// å¤„ç†æ’å…¥æ“ä½œ
private void handleInsert(String database, String table, RowChange rowChange) {
    for (RowData rowData : rowChange.getRowDatasList()) {
        Map<String, Object> data = new HashMap<>();
        
        // è§£ææ–°å¢çš„æ•°æ®
        for (Column column : rowData.getAfterColumnsList()) {
            data.put(column.getName(), column.getValue());
        }
        
        // åŒæ­¥åˆ°ç›®æ ‡ç³»ç»Ÿ
        syncToTarget(database, table, "INSERT", data);
    }
}
```

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”ç†è§£**
> æƒ³è±¡Canalå°±åƒä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"ï¼Œæ—¶åˆ»ç›¯ç€MySQLæ•°æ®åº“ã€‚ä¸€æ—¦æœ‰äººåœ¨æ•°æ®åº“é‡Œå¢åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æ•°æ®ï¼Œæ‘„åƒå¤´ç«‹åˆ»å°±èƒ½çœ‹åˆ°ï¼Œç„¶åé€šçŸ¥ç›¸å…³çš„ç³»ç»Ÿè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚

---

## 3. âš™ åŒæ­¥è§„åˆ™é…ç½®è¯¦è§£


### 3.1 è¡¨çº§åˆ«åŒæ­¥é…ç½®


**ğŸ¯ ç²¾ç¡®æ§åˆ¶åŒæ­¥èŒƒå›´**
```yaml
# application.yml åŒæ­¥é…ç½®
canal:
  sync:
    # æ•°æ®åº“çº§åˆ«é…ç½®
    databases:
      - name: "ecommerce"
        # è¡¨çº§åˆ«é…ç½®
        tables:
          - name: "users"
            # åŒæ­¥åˆ°ESçš„ç”¨æˆ·ç´¢å¼•
            targets:
              - type: "elasticsearch"
                index: "users"
                sync-fields: ["id", "username", "email", "created_time"]
                
          - name: "orders"
            # åŒæ­¥åˆ°å¤šä¸ªç›®æ ‡
            targets:
              - type: "elasticsearch"
                index: "orders"
              - type: "redis"
                key-pattern: "order:{id}"
                ttl: 3600  # 1å°æ—¶è¿‡æœŸ
```

**ğŸ“‹ åŒæ­¥è§„åˆ™é…ç½®å™¨**
```java
@Component
public class SyncRuleManager {
    
    // åŒæ­¥è§„åˆ™æ˜ å°„
    private Map<String, SyncRule> syncRules = new HashMap<>();
    
    @PostConstruct
    public void initRules() {
        // ç”¨æˆ·è¡¨åŒæ­¥è§„åˆ™
        SyncRule userRule = SyncRule.builder()
            .database("ecommerce")
            .table("users")
            .syncFields(Arrays.asList("id", "username", "email"))
            .targets(Arrays.asList(
                SyncTarget.elasticsearch("users"),
                SyncTarget.redis("user:{id}", 7200)
            ))
            .build();
            
        syncRules.put("ecommerce.users", userRule);
    }
    
    // æ ¹æ®è§„åˆ™æ‰§è¡ŒåŒæ­¥
    public void syncByRule(String database, String table, String operation, Map<String, Object> data) {
        String key = database + "." + table;
        SyncRule rule = syncRules.get(key);
        
        if (rule != null) {
            // è¿‡æ»¤éœ€è¦åŒæ­¥çš„å­—æ®µ
            Map<String, Object> filteredData = filterFields(data, rule.getSyncFields());
            
            // åŒæ­¥åˆ°å„ä¸ªç›®æ ‡ç³»ç»Ÿ
            for (SyncTarget target : rule.getTargets()) {
                syncToTarget(target, operation, filteredData);
            }
        }
    }
}
```

### 3.2 å­—æ®µæ˜ å°„ä¸è½¬æ¢é…ç½®


**ğŸ”„ å­—æ®µåç§°æ˜ å°„**
```java
// å­—æ®µæ˜ å°„é…ç½®
@Configuration
public class FieldMappingConfig {
    
    // MySQLå­—æ®µ -> ESå­—æ®µæ˜ å°„
    public Map<String, String> getUserFieldMapping() {
        Map<String, String> mapping = new HashMap<>();
        mapping.put("user_id", "id");
        mapping.put("user_name", "username");
        mapping.put("create_time", "createdTime");
        mapping.put("update_time", "updatedTime");
        return mapping;
    }
    
    // æ•°æ®ç±»å‹è½¬æ¢
    public Object convertFieldValue(String fieldName, Object value) {
        switch (fieldName) {
            case "create_time":
            case "update_time":
                // æ—¶é—´æˆ³è½¬æ¢ä¸ºISOæ ¼å¼
                return Instant.ofEpochMilli(Long.parseLong(value.toString()))
                    .atZone(ZoneOffset.UTC)
                    .format(DateTimeFormatter.ISO_INSTANT);
                    
            case "status":
                // æ•°å­—çŠ¶æ€è½¬æ¢ä¸ºæ–‡å­—
                return convertStatus(Integer.parseInt(value.toString()));
                
            default:
                return value;
        }
    }
}
```

---

## 4. ğŸ”„ æ•°æ®æ ¼å¼è½¬æ¢æŠ€æœ¯


### 4.1 æ•°æ®æ ¼å¼è½¬æ¢å™¨å¼€å‘


**ğŸ­ é€šç”¨æ•°æ®è½¬æ¢å™¨**
```java
@Component
public class DataFormatConverter {
    
    // ESæ–‡æ¡£æ ¼å¼è½¬æ¢
    public Map<String, Object> toElasticsearchDoc(String table, Map<String, Object> mysqlData) {
        Map<String, Object> esDoc = new HashMap<>();
        
        switch (table) {
            case "users":
                return convertUserData(mysqlData);
            case "orders":
                return convertOrderData(mysqlData);
            case "products":
                return convertProductData(mysqlData);
            default:
                return mysqlData; // é»˜è®¤ä¸è½¬æ¢
        }
    }
    
    private Map<String, Object> convertUserData(Map<String, Object> data) {
        Map<String, Object> result = new HashMap<>();
        
        // åŸºç¡€å­—æ®µè½¬æ¢
        result.put("id", data.get("user_id"));
        result.put("username", data.get("user_name"));
        result.put("email", data.get("email"));
        
        // æ—¶é—´å­—æ®µè½¬æ¢
        if (data.get("create_time") != null) {
            result.put("createdTime", formatTimestamp(data.get("create_time")));
        }
        
        // çŠ¶æ€å­—æ®µè½¬æ¢
        if (data.get("status") != null) {
            result.put("status", convertUserStatus(data.get("status")));
        }
        
        return result;
    }
    
    // Redisæ ¼å¼è½¬æ¢
    public String toRedisValue(String table, Map<String, Object> data) {
        // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²å­˜å‚¨
        try {
            return objectMapper.writeValueAsString(data);
        } catch (Exception e) {
            log.error("Redisæ ¼å¼è½¬æ¢å¤±è´¥", e);
            return "{}";
        }
    }
}
```

### 4.2 æ‰¹é‡æ•°æ®è½¬æ¢å¤„ç†


**âš¡ æ‰¹é‡è½¬æ¢ä¼˜åŒ–**
```java
@Service
public class BatchDataConverter {
    
    private static final int BATCH_SIZE = 100;
    
    // æ‰¹é‡è½¬æ¢å¹¶åŒæ­¥
    public void batchConvertAndSync(List<DataChangeEvent> events) {
        // æŒ‰ç›®æ ‡ç³»ç»Ÿåˆ†ç»„
        Map<String, List<DataChangeEvent>> groupedEvents = events.stream()
            .collect(Collectors.groupingBy(event -> 
                event.getDatabase() + "." + event.getTable()));
        
        // å¹¶è¡Œå¤„ç†ä¸åŒè¡¨çš„æ•°æ®
        groupedEvents.entrySet().parallelStream().forEach(entry -> {
            String tableKey = entry.getKey();
            List<DataChangeEvent> tableEvents = entry.getValue();
            
            // åˆ†æ‰¹å¤„ç†
            for (int i = 0; i < tableEvents.size(); i += BATCH_SIZE) {
                List<DataChangeEvent> batch = tableEvents.subList(
                    i, Math.min(i + BATCH_SIZE, tableEvents.size()));
                
                processBatch(tableKey, batch);
            }
        });
    }
    
    private void processBatch(String tableKey, List<DataChangeEvent> batch) {
        try {
            // æ‰¹é‡è½¬æ¢
            List<ConvertedData> convertedList = batch.stream()
                .map(this::convertSingleEvent)
                .collect(Collectors.toList());
            
            // æ‰¹é‡åŒæ­¥åˆ°ç›®æ ‡ç³»ç»Ÿ
            batchSyncToTargets(tableKey, convertedList);
            
        } catch (Exception e) {
            log.error("æ‰¹é‡å¤„ç†å¤±è´¥: {}", tableKey, e);
            // é™çº§ä¸ºå•æ¡å¤„ç†
            fallbackToSingleProcess(batch);
        }
    }
}
```

---

## 5. ğŸ¯ ç›®æ ‡ç³»ç»Ÿé€‚é…é›†æˆ


### 5.1 æ•°æ®åŒæ­¥åˆ°Elasticsearch


**ğŸ” ESé›†æˆå®ç°**
```java
@Service
public class ElasticsearchSyncService {
    
    @Autowired
    private ElasticsearchClient esClient;
    
    // åŒæ­¥å•æ¡æ•°æ®åˆ°ES
    public void syncToES(String operation, String index, String id, Map<String, Object> data) {
        try {
            switch (operation.toUpperCase()) {
                case "INSERT":
                case "UPDATE":
                    indexDocument(index, id, data);
                    break;
                case "DELETE":
                    deleteDocument(index, id);
                    break;
            }
        } catch (Exception e) {
            log.error("ESåŒæ­¥å¤±è´¥: index={}, id={}", index, id, e);
            throw new SyncException("ESåŒæ­¥å¤±è´¥", e);
        }
    }
    
    private void indexDocument(String index, String id, Map<String, Object> data) {
        IndexRequest request = IndexRequest.of(builder -> builder
            .index(index)
            .id(id)
            .document(data)
        );
        
        esClient.index(request);
        log.info("ESæ–‡æ¡£å·²æ›´æ–°: {}/{}", index, id);
    }
    
    // æ‰¹é‡åŒæ­¥åˆ°ES
    public void batchSyncToES(String index, List<BulkOperation> operations) {
        if (operations.isEmpty()) return;
        
        BulkRequest bulkRequest = BulkRequest.of(builder -> builder
            .index(index)
            .operations(operations)
        );
        
        BulkResponse response = esClient.bulk(bulkRequest);
        
        if (response.errors()) {
            log.warn("ESæ‰¹é‡åŒæ­¥éƒ¨åˆ†å¤±è´¥: {}", response.items().size());
        } else {
            log.info("ESæ‰¹é‡åŒæ­¥æˆåŠŸ: {} æ¡è®°å½•", operations.size());
        }
    }
}
```

### 5.2 æ•°æ®åŒæ­¥åˆ°Redisç¼“å­˜


**âš¡ Redisé›†æˆå®ç°**
```java
@Service
public class RedisSyncService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åŒæ­¥åˆ°Redis
    public void syncToRedis(String operation, String keyPattern, String id, 
                           Map<String, Object> data, Integer ttl) {
        String key = keyPattern.replace("{id}", id);
        
        try {
            switch (operation.toUpperCase()) {
                case "INSERT":
                case "UPDATE":
                    setRedisValue(key, data, ttl);
                    break;
                case "DELETE":
                    deleteRedisKey(key);
                    break;
            }
        } catch (Exception e) {
            log.error("RedisåŒæ­¥å¤±è´¥: key={}", key, e);
        }
    }
    
    private void setRedisValue(String key, Map<String, Object> data, Integer ttl) {
        // è½¬æ¢ä¸ºJSONå­˜å‚¨
        String jsonValue = objectMapper.writeValueAsString(data);
        
        if (ttl != null && ttl > 0) {
            redisTemplate.opsForValue().set(key, jsonValue, ttl, TimeUnit.SECONDS);
        } else {
            redisTemplate.opsForValue().set(key, jsonValue);
        }
        
        log.info("Redisç¼“å­˜å·²æ›´æ–°: {}", key);
    }
    
    // æ‰¹é‡åˆ é™¤Redisç¼“å­˜
    public void batchDeleteFromRedis(String keyPattern, List<String> ids) {
        List<String> keys = ids.stream()
            .map(id -> keyPattern.replace("{id}", id))
            .collect(Collectors.toList());
        
        redisTemplate.delete(keys);
        log.info("æ‰¹é‡åˆ é™¤Redisç¼“å­˜: {} ä¸ªkey", keys.size());
    }
}
```

### 5.3 æ•°æ®åŒæ­¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—


**ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ**
```java
@Service
public class MessageQueueSyncService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // å‘é€æ•°æ®å˜åŒ–æ¶ˆæ¯
    public void sendDataChangeMessage(String database, String table, String operation, 
                                    Map<String, Object> data) {
        DataChangeMessage message = DataChangeMessage.builder()
            .database(database)
            .table(table)
            .operation(operation)
            .data(data)
            .timestamp(System.currentTimeMillis())
            .build();
        
        // æ ¹æ®è¡¨åè·¯ç”±åˆ°ä¸åŒé˜Ÿåˆ—
        String routingKey = "data.change." + database + "." + table;
        
        rabbitTemplate.convertAndSend("data.exchange", routingKey, message);
        log.info("æ•°æ®å˜åŒ–æ¶ˆæ¯å·²å‘é€: {}.{} - {}", database, table, operation);
    }
    
    // æ‰¹é‡å‘é€æ¶ˆæ¯
    public void batchSendMessages(List<DataChangeMessage> messages) {
        for (DataChangeMessage message : messages) {
            sendDataChangeMessage(
                message.getDatabase(),
                message.getTable(), 
                message.getOperation(),
                message.getData()
            );
        }
    }
}
```

---

## 6. ğŸš€ åŒæ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 æ‰¹é‡å¤„ç†ä¼˜åŒ–


**ğŸ“Š æ€§èƒ½ä¼˜åŒ–é…ç½®**
```java
@Configuration
public class SyncPerformanceConfig {
    
    // æ‰¹é‡å¤„ç†é…ç½®
    @Bean
    public BatchProcessor batchProcessor() {
        return BatchProcessor.builder()
            .batchSize(100)           // æ‰¹é‡å¤§å°
            .flushInterval(5000)      // 5ç§’å¼ºåˆ¶åˆ·æ–°
            .maxWaitTime(10000)       // æœ€å¤§ç­‰å¾…10ç§’
            .retryTimes(3)            // é‡è¯•3æ¬¡
            .threadPoolSize(4)        // 4ä¸ªå¤„ç†çº¿ç¨‹
            .build();
    }
}

@Service
public class OptimizedSyncService {
    
    private final BlockingQueue<SyncTask> taskQueue = new LinkedBlockingQueue<>(1000);
    private final List<SyncTask> batchBuffer = new ArrayList<>();
    
    @PostConstruct
    public void startBatchProcessor() {
        // å¯åŠ¨æ‰¹é‡å¤„ç†çº¿ç¨‹
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(2);
        
        // æ‰¹é‡å¤§å°è§¦å‘
        scheduler.scheduleWithFixedDelay(this::processBatchBySize, 0, 100, TimeUnit.MILLISECONDS);
        
        // æ—¶é—´è§¦å‘
        scheduler.scheduleWithFixedDelay(this::processBatchByTime, 0, 5, TimeUnit.SECONDS);
    }
    
    public void addSyncTask(SyncTask task) {
        if (!taskQueue.offer(task)) {
            log.warn("ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒä»»åŠ¡: {}", task);
        }
    }
    
    private void processBatchBySize() {
        drainTasks();
        if (batchBuffer.size() >= BATCH_SIZE) {
            processBatch(new ArrayList<>(batchBuffer));
            batchBuffer.clear();
        }
    }
    
    private void processBatchByTime() {
        drainTasks();
        if (!batchBuffer.isEmpty()) {
            processBatch(new ArrayList<>(batchBuffer));
            batchBuffer.clear();
        }
    }
}
```

### 6.2 å¹¶è¡ŒåŒæ­¥ç­–ç•¥


**âš¡ å¤šç›®æ ‡å¹¶è¡ŒåŒæ­¥**
```java
@Service
public class ParallelSyncService {
    
    private final ExecutorService syncExecutor = Executors.newFixedThreadPool(8);
    
    // å¹¶è¡ŒåŒæ­¥åˆ°å¤šä¸ªç›®æ ‡
    public void parallelSyncToTargets(SyncTask task) {
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        // ä¸ºæ¯ä¸ªç›®æ ‡ç³»ç»Ÿåˆ›å»ºå¼‚æ­¥ä»»åŠ¡
        for (SyncTarget target : task.getTargets()) {
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                try {
                    syncToSingleTarget(target, task);
                } catch (Exception e) {
                    log.error("åŒæ­¥åˆ°{}å¤±è´¥", target.getType(), e);
                }
            }, syncExecutor);
            
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰åŒæ­¥å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .whenComplete((result, throwable) -> {
                if (throwable != null) {
                    log.error("å¹¶è¡ŒåŒæ­¥å‡ºç°å¼‚å¸¸", throwable);
                } else {
                    log.info("å¹¶è¡ŒåŒæ­¥å®Œæˆ: {}", task.getTaskId());
                }
            });
    }
}
```

---

## 7. ğŸ”’ æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶


### 7.1 æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå·¥å…·


**ğŸ” ä¸€è‡´æ€§æ£€æŸ¥å®ç°**
```java
@Service
public class DataConsistencyChecker {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Autowired
    private ElasticsearchClient esClient;
    
    // æ£€æŸ¥MySQLä¸ESæ•°æ®ä¸€è‡´æ€§
    public ConsistencyReport checkMysqlEsConsistency(String database, String table) {
        ConsistencyReport report = new ConsistencyReport();
        
        try {
            // è·å–MySQLæ•°æ®æ€»æ•°
            String countSql = "SELECT COUNT(*) FROM " + database + "." + table;
            Long mysqlCount = jdbcTemplate.queryForObject(countSql, Long.class);
            
            // è·å–ESæ•°æ®æ€»æ•°
            String esIndex = getEsIndex(database, table);
            Long esCount = getEsDocumentCount(esIndex);
            
            report.setMysqlCount(mysqlCount);
            report.setEsCount(esCount);
            report.setConsistent(Objects.equals(mysqlCount, esCount));
            
            // å¦‚æœæ•°é‡ä¸ä¸€è‡´ï¼ŒæŸ¥æ‰¾å…·ä½“å·®å¼‚
            if (!report.isConsistent()) {
                findDataDifferences(database, table, report);
            }
            
        } catch (Exception e) {
            log.error("ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥", e);
            report.setError(e.getMessage());
        }
        
        return report;
    }
    
    // æŸ¥æ‰¾å…·ä½“çš„æ•°æ®å·®å¼‚
    private void findDataDifferences(String database, String table, ConsistencyReport report) {
        // è·å–MySQLä¸­çš„æ‰€æœ‰ID
        String idSql = "SELECT id FROM " + database + "." + table;
        Set<String> mysqlIds = new HashSet<>(jdbcTemplate.queryForList(idSql, String.class));
        
        // è·å–ESä¸­çš„æ‰€æœ‰ID
        Set<String> esIds = getEsDocumentIds(getEsIndex(database, table));
        
        // æ‰¾å‡ºåªåœ¨MySQLä¸­å­˜åœ¨çš„ID
        Set<String> onlyInMysql = new HashSet<>(mysqlIds);
        onlyInMysql.removeAll(esIds);
        report.setOnlyInMysql(onlyInMysql);
        
        // æ‰¾å‡ºåªåœ¨ESä¸­å­˜åœ¨çš„ID
        Set<String> onlyInEs = new HashSet<>(esIds);
        onlyInEs.removeAll(mysqlIds);
        report.setOnlyInEs(onlyInEs);
    }
}
```

### 7.2 æ•°æ®ä¿®å¤æœºåˆ¶


**ğŸ”§ è‡ªåŠ¨æ•°æ®ä¿®å¤**
```java
@Service
public class DataRepairService {
    
    // ä¿®å¤æ•°æ®ä¸ä¸€è‡´
    public void repairDataInconsistency(ConsistencyReport report) {
        if (report.isConsistent()) {
            return; // æ•°æ®ä¸€è‡´ï¼Œæ— éœ€ä¿®å¤
        }
        
        log.info("å¼€å§‹ä¿®å¤æ•°æ®ä¸ä¸€è‡´: {}", report);
        
        // ä¿®å¤åªåœ¨MySQLä¸­å­˜åœ¨çš„æ•°æ®ï¼ˆåŒæ­¥åˆ°ESï¼‰
        for (String id : report.getOnlyInMysql()) {
            repairMissingInEs(report.getDatabase(), report.getTable(), id);
        }
        
        // ä¿®å¤åªåœ¨ESä¸­å­˜åœ¨çš„æ•°æ®ï¼ˆä»ESåˆ é™¤ï¼‰
        for (String id : report.getOnlyInEs()) {
            repairExtraInEs(report.getDatabase(), report.getTable(), id);
        }
        
        log.info("æ•°æ®ä¿®å¤å®Œæˆ");
    }
    
    private void repairMissingInEs(String database, String table, String id) {
        try {
            // ä»MySQLæŸ¥è¯¢å®Œæ•´æ•°æ®
            String sql = "SELECT * FROM " + database + "." + table + " WHERE id = ?";
            Map<String, Object> data = jdbcTemplate.queryForMap(sql, id);
            
            // åŒæ­¥åˆ°ES
            String esIndex = getEsIndex(database, table);
            elasticsearchSyncService.syncToES("INSERT", esIndex, id, data);
            
            log.info("ä¿®å¤ESç¼ºå¤±æ•°æ®: {}/{}", esIndex, id);
            
        } catch (Exception e) {
            log.error("ä¿®å¤ESç¼ºå¤±æ•°æ®å¤±è´¥: {}", id, e);
        }
    }
}
```

---

## 8. ğŸ“Š åŒæ­¥ç›‘æ§ä¸å‘Šè­¦


### 8.1 æ•°æ®åŒæ­¥é“¾è·¯ç›‘æ§


**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡æ”¶é›†**
```java
@Component
public class SyncMonitoringService {
    
    private final MeterRegistry meterRegistry;
    private final Counter syncSuccessCounter;
    private final Counter syncFailureCounter;
    private final Timer syncLatencyTimer;
    
    public SyncMonitoringService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.syncSuccessCounter = Counter.builder("canal.sync.success")
            .description("åŒæ­¥æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
        this.syncFailureCounter = Counter.builder("canal.sync.failure")
            .description("åŒæ­¥å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
        this.syncLatencyTimer = Timer.builder("canal.sync.latency")
            .description("åŒæ­¥å»¶è¿Ÿæ—¶é—´")
            .register(meterRegistry);
    }
    
    // è®°å½•åŒæ­¥æˆåŠŸ
    public void recordSyncSuccess(String database, String table, String target) {
        syncSuccessCounter.increment(
            Tags.of(
                "database", database,
                "table", table,
                "target", target
            )
        );
    }
    
    // è®°å½•åŒæ­¥å»¶è¿Ÿ
    public void recordSyncLatency(long startTime, String database, String table) {
        long latency = System.currentTimeMillis() - startTime;
        syncLatencyTimer.record(latency, TimeUnit.MILLISECONDS,
            Tags.of("database", database, "table", table));
    }
}
```

### 8.2 åŒæ­¥å»¶è¿Ÿç›‘æ§å‘Šè­¦


**â° å»¶è¿Ÿç›‘æ§å®ç°**
```java
@Component
public class SyncDelayMonitor {
    
    private static final long MAX_DELAY_THRESHOLD = 30000; // 30ç§’
    
    @Autowired
    private AlertService alertService;
    
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkSyncDelay() {
        try {
            // æ£€æŸ¥Canalæ¶ˆè´¹ä½ç‚¹
            long currentPosition = getCurrentBinlogPosition();
            long canalPosition = getCanalPosition();
            
            long delay = currentPosition - canalPosition;
            
            if (delay > MAX_DELAY_THRESHOLD) {
                sendDelayAlert(delay);
            }
            
            // è®°å½•å»¶è¿ŸæŒ‡æ ‡
            Gauge.builder("canal.sync.delay")
                .description("CanalåŒæ­¥å»¶è¿Ÿ(å­—èŠ‚)")
                .register(meterRegistry, () -> delay);
                
        } catch (Exception e) {
            log.error("å»¶è¿Ÿç›‘æ§æ£€æŸ¥å¤±è´¥", e);
        }
    }
    
    private void sendDelayAlert(long delay) {
        AlertMessage alert = AlertMessage.builder()
            .level("WARNING")
            .title("CanalåŒæ­¥å»¶è¿Ÿå‘Šè­¦")
            .content(String.format("å½“å‰åŒæ­¥å»¶è¿Ÿ: %d å­—èŠ‚ï¼Œè¶…è¿‡é˜ˆå€¼ %d", 
                delay, MAX_DELAY_THRESHOLD))
            .timestamp(LocalDateTime.now())
            .build();
            
        alertService.sendAlert(alert);
    }
}
```

### 8.3 åŒæ­¥æ•°æ®è´¨é‡ä¿è¯


**ğŸ” æ•°æ®è´¨é‡ç›‘æ§**
```java
@Service
public class DataQualityMonitor {
    
    // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
    public void checkDataIntegrity(String database, String table, Map<String, Object> data) {
        List<String> errors = new ArrayList<>();
        
        // æ£€æŸ¥å¿…å¡«å­—æ®µ
        List<String> requiredFields = getRequiredFields(database, table);
        for (String field : requiredFields) {
            if (data.get(field) == null || data.get(field).toString().trim().isEmpty()) {
                errors.add("å¿…å¡«å­—æ®µç¼ºå¤±: " + field);
            }
        }
        
        // æ£€æŸ¥æ•°æ®æ ¼å¼
        validateDataFormat(data, errors);
        
        // æ£€æŸ¥æ•°æ®èŒƒå›´
        validateDataRange(data, errors);
        
        if (!errors.isEmpty()) {
            log.warn("æ•°æ®è´¨é‡æ£€æŸ¥å‘ç°é—®é¢˜: {}, æ•°æ®: {}", errors, data);
            recordDataQualityIssue(database, table, errors);
        }
    }
    
    private void validateDataFormat(Map<String, Object> data, List<String> errors) {
        // é‚®ç®±æ ¼å¼æ£€æŸ¥
        Object email = data.get("email");
        if (email != null && !isValidEmail(email.toString())) {
            errors.add("é‚®ç®±æ ¼å¼é”™è¯¯: " + email);
        }
        
        // æ‰‹æœºå·æ ¼å¼æ£€æŸ¥
        Object phone = data.get("phone");
        if (phone != null && !isValidPhone(phone.toString())) {
            errors.add("æ‰‹æœºå·æ ¼å¼é”™è¯¯: " + phone);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CanalåŒæ­¥åŸç†ï¼šä¼ªè£…MySQLä»åº“ï¼Œè¯»å–binlogå®ç°å®æ—¶åŒæ­¥
ğŸ”¸ æ•°æ®è½¬æ¢æœºåˆ¶ï¼šMySQLæ ¼å¼ â†’ ç›®æ ‡ç³»ç»Ÿæ ¼å¼çš„è½¬æ¢æµç¨‹
ğŸ”¸ å¤šç›®æ ‡é€‚é…ï¼šåŒä¸€ä»½æ•°æ®åŒæ­¥åˆ°ESã€Redisã€MQç­‰ä¸åŒç³»ç»Ÿ
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼šæ‰¹é‡å¤„ç†ã€å¹¶è¡ŒåŒæ­¥ã€é˜Ÿåˆ—ç¼“å†²
ğŸ”¸ ä¸€è‡´æ€§ä¿è¯ï¼šæ•°æ®æ ¡éªŒã€è‡ªåŠ¨ä¿®å¤ã€ç›‘æ§å‘Šè­¦
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆCanalæ¯”ä¼ ç»ŸåŒæ­¥å¥½**
```
å®æ—¶æ€§å¯¹æ¯”ï¼š
ä¼ ç»Ÿå®šæ—¶åŒæ­¥ï¼šåˆ†é’Ÿçº§å»¶è¿Ÿ
Canalå®æ—¶åŒæ­¥ï¼šç§’çº§å»¶è¿Ÿ

æ€§èƒ½å½±å“å¯¹æ¯”ï¼š
ä¼ ç»Ÿæ–¹æ¡ˆï¼šå®šæœŸå…¨é‡æŸ¥è¯¢ï¼Œæ•°æ®åº“å‹åŠ›å¤§
Canalæ–¹æ¡ˆï¼šåŸºäºbinlogå¢é‡åŒæ­¥ï¼Œå½±å“å°

å¼€å‘å¤æ‚åº¦å¯¹æ¯”ï¼š
ä¼ ç»Ÿæ–¹æ¡ˆï¼šéœ€è¦ç¼–å†™å¤§é‡åŒæ­¥ä»£ç 
Canalæ–¹æ¡ˆï¼šé…ç½®é©±åŠ¨ï¼Œä»£ç é‡å°‘
```

**ğŸ”¹ æ•°æ®åŒæ­¥çš„æ ¸å¿ƒæŒ‘æˆ˜**
```
æ•°æ®ä¸€è‡´æ€§ï¼šå¦‚ä½•ä¿è¯æºæ•°æ®å’Œç›®æ ‡æ•°æ®çš„ä¸€è‡´
åŒæ­¥æ€§èƒ½ï¼šå¤§æ•°æ®é‡ä¸‹å¦‚ä½•ä¿è¯åŒæ­¥æ•ˆç‡
é”™è¯¯å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€ç›®æ ‡ç³»ç»Ÿå¼‚å¸¸å¦‚ä½•å¤„ç†
ç›‘æ§å‘Šè­¦ï¼šå¦‚ä½•åŠæ—¶å‘ç°å’Œè§£å†³åŒæ­¥é—®é¢˜
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Œ æœ€ä½³å®è·µå»ºè®®**
```
é…ç½®ç®¡ç†ï¼š
â€¢ ä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†åŒæ­¥è§„åˆ™ï¼Œä¾¿äºåŠ¨æ€è°ƒæ•´
â€¢ ä¸ºä¸åŒç¯å¢ƒå‡†å¤‡ä¸åŒçš„é…ç½®æ–‡ä»¶

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®æ‰¹é‡å¤§å°ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œååé‡
â€¢ ä½¿ç”¨å¹¶è¡Œå¤„ç†æé«˜åŒæ­¥æ•ˆç‡
â€¢ ç›‘æ§é˜Ÿåˆ—ç§¯å‹æƒ…å†µï¼ŒåŠæ—¶è°ƒæ•´èµ„æº

é”™è¯¯å¤„ç†ï¼š
â€¢ å®ç°é‡è¯•æœºåˆ¶ï¼Œå¤„ç†ä¸´æ—¶ç½‘ç»œé—®é¢˜
â€¢ è®¾è®¡é™çº§ç­–ç•¥ï¼Œå…³é”®æ•°æ®ä¼˜å…ˆä¿è¯
â€¢ å»ºç«‹å‘Šè­¦æœºåˆ¶ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

æ•°æ®è´¨é‡ï¼š
â€¢ åœ¨åŒæ­¥å‰è¿›è¡Œæ•°æ®æ ¡éªŒ
â€¢ å®šæœŸæ‰§è¡Œä¸€è‡´æ€§æ£€æŸ¥
â€¢ å»ºç«‹æ•°æ®ä¿®å¤æœºåˆ¶
```

**ğŸ¯ åº”ç”¨åœºæ™¯é€‰æ‹©**
```
å®æ—¶æœç´¢åœºæ™¯ï¼š
MySQL â†’ Elasticsearch
é€‚ç”¨äºï¼šå•†å“æœç´¢ã€ç”¨æˆ·æœç´¢ã€è®¢å•æŸ¥è¯¢

ç¼“å­˜æ›´æ–°åœºæ™¯ï¼š
MySQL â†’ Redis
é€‚ç”¨äºï¼šçƒ­ç‚¹æ•°æ®ç¼“å­˜ã€ä¼šè¯æ•°æ®ã€è®¡æ•°å™¨

æ¶ˆæ¯é€šçŸ¥åœºæ™¯ï¼š
MySQL â†’ æ¶ˆæ¯é˜Ÿåˆ—
é€‚ç”¨äºï¼šæ•°æ®å˜æ›´é€šçŸ¥ã€å¼‚æ­¥å¤„ç†ã€äº‹ä»¶é©±åŠ¨

æ•°æ®åˆ†æåœºæ™¯ï¼š
MySQL â†’ æ•°æ®ä»“åº“
é€‚ç”¨äºï¼šå®æ—¶æŠ¥è¡¨ã€æ•°æ®åˆ†æã€å•†ä¸šæ™ºèƒ½
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Canalè®©æ•°æ®åŒæ­¥å˜å¾—ç®€å•å¯é 
- å®æ—¶åŒæ­¥è§£å†³ä¼ ç»Ÿæ–¹æ¡ˆçš„å»¶è¿Ÿé—®é¢˜
- å¤šç›®æ ‡åŒæ­¥æ»¡è¶³ä¸åŒä¸šåŠ¡éœ€æ±‚
- ç›‘æ§å‘Šè­¦ä¿è¯åŒæ­¥æœåŠ¡çš„ç¨³å®šæ€§