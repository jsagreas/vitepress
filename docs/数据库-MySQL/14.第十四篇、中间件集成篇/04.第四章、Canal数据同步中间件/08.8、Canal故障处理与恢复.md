---
title: 8ã€Canalæ•…éšœå¤„ç†ä¸æ¢å¤
---
## ğŸ“š ç›®å½•


1. [Canalæ•…éšœæ¦‚è¿°](#1-Canalæ•…éšœæ¦‚è¿°)
2. [å¸¸è§æ•…éšœç±»å‹ä¸å¤„ç†](#2-å¸¸è§æ•…éšœç±»å‹ä¸å¤„ç†)
3. [ä½ç‚¹ç®¡ç†ä¸æ¢å¤æœºåˆ¶](#3-ä½ç‚¹ç®¡ç†ä¸æ¢å¤æœºåˆ¶)
4. [æ•°æ®ä¿®å¤ä¸é‡å¤å¤„ç†](#4-æ•°æ®ä¿®å¤ä¸é‡å¤å¤„ç†)
5. [æ•…éšœé¢„é˜²ä¸è‡ªæ„ˆæœºåˆ¶](#5-æ•…éšœé¢„é˜²ä¸è‡ªæ„ˆæœºåˆ¶)
6. [åº”æ€¥é¢„æ¡ˆä¸æ“ä½œæµç¨‹](#6-åº”æ€¥é¢„æ¡ˆä¸æ“ä½œæµç¨‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Canalæ•…éšœæ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯Canalæ•…éšœ



**Canalæ•…éšœå®šä¹‰**ï¼šCanalä½œä¸ºMySQL binlogè§£æå’ŒåŒæ­¥ä¸­é—´ä»¶ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ç”±äºå„ç§åŸå› å¯¼è‡´çš„æœåŠ¡ä¸­æ–­ã€æ•°æ®ä¸¢å¤±æˆ–æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚

**æ•…éšœå½±å“èŒƒå›´**ï¼š
```
æ•°æ®å±‚é¢ï¼š
â€¢ æ•°æ®ä¸¢å¤±ï¼šbinlogæœªèƒ½æ­£ç¡®è§£ææˆ–ä¼ è¾“
â€¢ æ•°æ®é‡å¤ï¼šä½ç‚¹ç®¡ç†å¼‚å¸¸å¯¼è‡´é‡å¤æ¶ˆè´¹
â€¢ æ•°æ®å»¶è¿Ÿï¼šç½‘ç»œæˆ–è§£ææ€§èƒ½é—®é¢˜
â€¢ æ•°æ®ä¸ä¸€è‡´ï¼šç›®æ ‡ç«¯ä¸æºç«¯æ•°æ®å·®å¼‚

æœåŠ¡å±‚é¢ï¼š
â€¢ CanalæœåŠ¡åœæ­¢ï¼šè¿›ç¨‹å¼‚å¸¸é€€å‡º
â€¢ è¿æ¥ä¸­æ–­ï¼šä¸MySQLæˆ–ä¸‹æ¸¸çš„è¿æ¥æ–­å¼€
â€¢ æ€§èƒ½ä¸‹é™ï¼šè§£æé€Ÿåº¦æ˜æ˜¾é™ä½
â€¢ èµ„æºè€—å°½ï¼šå†…å­˜æˆ–ç£ç›˜ç©ºé—´ä¸è¶³
```

### 1.2 Canalç³»ç»Ÿæ¶æ„å›é¡¾



```
Canalæ•°æ®æµæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL     â”‚    â”‚   Canal     â”‚    â”‚  æ¶ˆè´¹ç«¯     â”‚
â”‚   Master    â”‚â”€â”€â”€â”€â”‚   Server    â”‚â”€â”€â”€â”€â”‚ (MQ/ES/DB)  â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚  binlogæ–‡ä»¶ â”‚    â”‚ è§£æ+ä½ç‚¹   â”‚    â”‚   ä¸šåŠ¡å¤„ç†  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                   â†‘                   â†‘
   æ•…éšœç‚¹1:             æ•…éšœç‚¹2:            æ•…éšœç‚¹3:
   ä¸»ä»åˆ‡æ¢             Canalå¼‚å¸¸           æ¶ˆè´¹å¼‚å¸¸
   binlogæŸå           ä½ç‚¹ä¸¢å¤±            ç½‘ç»œä¸­æ–­
```

### 1.3 æ•…éšœåˆ†ç±»ä½“ç³»



**æŒ‰å½±å“ç¨‹åº¦åˆ†ç±»**ï¼š
- **P0çº§æ•…éšœ**ï¼šæ•°æ®ä¸¢å¤±ã€æœåŠ¡å®Œå…¨ä¸å¯ç”¨
- **P1çº§æ•…éšœ**ï¼šæ•°æ®å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼ã€éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸  
- **P2çº§æ•…éšœ**ï¼šæ€§èƒ½ä¸‹é™ã€å‘Šè­¦é¢‘ç¹ä½†æœåŠ¡å¯ç”¨
- **P3çº§æ•…éšœ**ï¼šè½»å¾®å¼‚å¸¸ã€å¯¹ä¸šåŠ¡å½±å“å¾ˆå°

**æŒ‰æ•…éšœæ¥æºåˆ†ç±»**ï¼š
- **ç¯å¢ƒæ•…éšœ**ï¼šç½‘ç»œã€ç¡¬ä»¶ã€ç³»ç»Ÿèµ„æºé—®é¢˜
- **é…ç½®æ•…éšœ**ï¼šå‚æ•°é…ç½®é”™è¯¯ã€æƒé™é—®é¢˜
- **ç¨‹åºæ•…éšœ**ï¼šCanalä»£ç bugã€ä¾èµ–ç»„ä»¶å¼‚å¸¸
- **æ•°æ®æ•…éšœ**ï¼šbinlogæ ¼å¼å¼‚å¸¸ã€æ•°æ®åº“å¼‚å¸¸

---

## 2. âš ï¸ å¸¸è§æ•…éšœç±»å‹ä¸å¤„ç†



### 2.1 binlogè§£æå¼‚å¸¸å¤„ç†



#### ğŸ”¸ binlogæ ¼å¼ä¸å…¼å®¹



**æ•…éšœç°è±¡**ï¼š
```bash
# å…¸å‹é”™è¯¯æ—¥å¿—

ERROR - parse binlog error, position xxx
java.io.IOException: Unknown event type: 39
    at com.alibaba.otter.canal.parse.inbound.mysql.dbsync.LogEventConvert.parse
```

**äº§ç”ŸåŸå› **ï¼š
- MySQLç‰ˆæœ¬å‡çº§å¯¼è‡´binlogæ ¼å¼å˜åŒ–
- Canalç‰ˆæœ¬è¿‡ä½ï¼Œä¸æ”¯æŒæ–°çš„binlogäº‹ä»¶ç±»å‹
- binlogæ–‡ä»¶æŸåæˆ–æ ¼å¼å¼‚å¸¸

**å¤„ç†æ–¹æ¡ˆ**ï¼š
```yaml
# 1. å‡çº§Canalç‰ˆæœ¬

canal.version: 1.1.6 â†’ 1.1.7

# 2. è°ƒæ•´binlogæ ¼å¼é…ç½®

canal.instance.filter.regex: .*\\..*
canal.instance.filter.black.regex: mysql\\..*

# 3. è·³è¿‡å¼‚å¸¸ä½ç‚¹

canal.instance.fallbackIntervalInSeconds: 60
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// binlogå¼‚å¸¸å¤„ç†å™¨
public class BinlogExceptionHandler {
    
    public void handleParseException(Exception e, LogPosition position) {
        if (e instanceof IOException && e.getMessage().contains("Unknown event type")) {
            // è®°å½•å¼‚å¸¸ä½ç‚¹
            logFailedPosition(position);
            // è·³è¿‡å¼‚å¸¸äº‹ä»¶
            skipToNextSafePosition(position);
        }
    }
    
    private void skipToNextSafePosition(LogPosition position) {
        // å‘å‰ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå®‰å…¨ä½ç‚¹
        position.setPosition(position.getPosition() + 1);
        logger.warn("è·³è¿‡å¼‚å¸¸ä½ç‚¹: {}", position);
    }
}
```

#### ğŸ”¸ binlogæ–‡ä»¶ç¼ºå¤±



**æ•…éšœç°è±¡**ï¼š
- Canalæ— æ³•æ‰¾åˆ°æŒ‡å®šçš„binlogæ–‡ä»¶
- æ—¥å¿—æ˜¾ç¤º"Could not find binlog file"

**å¤„ç†æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥MySQL binlogæ–‡ä»¶

mysql> SHOW BINARY LOGS;
mysql> SHOW MASTER STATUS;

# 2. é‡ç½®Canalä½ç‚¹åˆ°å¯ç”¨ä½ç½®

# æ–¹å¼1: é‡ç½®åˆ°æœ€æ–°ä½ç‚¹

canal_position_reset --latest

# æ–¹å¼2: é‡ç½®åˆ°æŒ‡å®šæ—¶é—´ç‚¹

canal_position_reset --timestamp="2024-01-01 10:00:00"
```

### 2.2 ç½‘ç»œä¸­æ–­æ¢å¤



#### ğŸ”¸ MySQLè¿æ¥ä¸­æ–­



**æ•…éšœç°è±¡**ï¼š
```
è¿æ¥å¼‚å¸¸æ—¥å¿—ï¼š
2024-01-01 10:30:15 ERROR - canal connection lost
2024-01-01 10:30:15 WARN  - try to reconnect after 5s
```

**è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼š
```properties
# Canalé‡è¿é…ç½®

canal.instance.connectionCharset = UTF-8
canal.instance.enableDruid = false

# é‡è¿å‚æ•°

canal.instance.receiveBufferSize = 16384
canal.instance.sendBufferSize = 16384
canal.instance.defaultConnectionTimeoutInSeconds = 30

# é‡è¯•ç­–ç•¥

canal.instance.retryTimes = 3
canal.instance.retryIntervalInSeconds = 5
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
public class ConnectionRecoveryHandler {
    
    private static final int MAX_RETRY_TIMES = 5;
    private static final long RETRY_INTERVAL = 5000; // 5ç§’
    
    public void handleConnectionLost() {
        int retryCount = 0;
        
        while (retryCount < MAX_RETRY_TIMES) {
            try {
                // å°è¯•é‡æ–°è¿æ¥
                reconnectToMySQL();
                logger.info("é‡è¿æˆåŠŸï¼Œæ¢å¤æ•°æ®åŒæ­¥");
                break;
                
            } catch (Exception e) {
                retryCount++;
                logger.warn("é‡è¿å¤±è´¥ï¼Œç¬¬{}æ¬¡é‡è¯•ï¼Œ{}ç§’åå†è¯•", retryCount, RETRY_INTERVAL/1000);
                
                try {
                    Thread.sleep(RETRY_INTERVAL);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        if (retryCount >= MAX_RETRY_TIMES) {
            // é‡è¿å¤±è´¥ï¼Œè§¦å‘å‘Šè­¦
            alertService.sendAlert("Canalé‡è¿å¤±è´¥ï¼Œéœ€äººå·¥ä»‹å…¥");
        }
    }
}
```

### 2.3 MySQLä¸»ä»åˆ‡æ¢å¤„ç†



#### ğŸ”¸ ä¸»ä»åˆ‡æ¢åœºæ™¯



**åˆ‡æ¢è¿‡ç¨‹**ï¼š
```
æ­£å¸¸çŠ¶æ€ï¼š
Canal â”€â”€â”€â”€è¿æ¥â”€â”€â”€â”€> MySQL Master (192.168.1.100:3306)

ä¸»ä»åˆ‡æ¢ï¼š
Canal â”€â”€â”€â”€è¿æ¥Xâ”€â”€â”€> MySQL Master (æ•…éšœ)
      â””â”€â”€é‡è¿â”€â”€â”€â”€> MySQL New Master (192.168.1.101:3306)
```

**å¤„ç†æ­¥éª¤**ï¼š

**1. æ£€æµ‹ä¸»åº“åˆ‡æ¢**ï¼š
```java
public class MasterSwitchDetector {
    
    public void detectMasterSwitch() {
        try {
            // æ£€æŸ¥å½“å‰è¿æ¥çŠ¶æ€
            if (!isConnectionAlive()) {
                // è·å–æ–°ä¸»åº“ä¿¡æ¯
                String newMasterHost = getNewMasterFromVIP();
                // åˆ‡æ¢è¿æ¥
                switchToNewMaster(newMasterHost);
            }
        } catch (Exception e) {
            logger.error("ä¸»ä»åˆ‡æ¢æ£€æµ‹å¤±è´¥", e);
        }
    }
    
    private void switchToNewMaster(String newMasterHost) {
        // 1. ä¿å­˜å½“å‰ä½ç‚¹
        LogPosition currentPosition = getCurrentPosition();
        
        // 2. æ–­å¼€æ—§è¿æ¥
        closeCurrentConnection();
        
        // 3. è¿æ¥æ–°ä¸»åº“
        connectToNewMaster(newMasterHost, currentPosition);
    }
}
```

**2. ä½ç‚¹è½¬æ¢å¤„ç†**ï¼š
```sql
-- åœ¨æ–°ä¸»åº“ä¸ŠæŸ¥æ‰¾å¯¹åº”ä½ç‚¹
SHOW SLAVE STATUS;

-- è·å–æ–°ä¸»åº“çš„binlogä½ç½®
SHOW MASTER STATUS;
```

### 2.4 Canalæ•…éšœåˆ†ç±»å¤„ç†çŸ©é˜µ



| æ•…éšœç±»å‹ | æ•…éšœç­‰çº§ | è‡ªåŠ¨å¤„ç† | äººå·¥å¹²é¢„ | æ¢å¤æ—¶é—´ | å¤„ç†ç­–ç•¥ |
|---------|---------|---------|---------|---------|---------|
| **binlogè§£æå¼‚å¸¸** | P1 | âœ… è·³è¿‡å¼‚å¸¸äº‹ä»¶ | âš ï¸ æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ | 5åˆ†é’Ÿ | è‡ªåŠ¨è·³è¿‡+äººå·¥éªŒè¯ |
| **ç½‘ç»œè¿æ¥ä¸­æ–­** | P1 | âœ… è‡ªåŠ¨é‡è¿ | âŒ æ— éœ€å¹²é¢„ | 30ç§’ | æŒ‡æ•°é€€é¿é‡è¯• |
| **MySQLä¸»ä»åˆ‡æ¢** | P0 | âœ… è‡ªåŠ¨åˆ‡æ¢ | âš ï¸ éªŒè¯ä½ç‚¹æ­£ç¡®æ€§ | 1åˆ†é’Ÿ | VIPåˆ‡æ¢+ä½ç‚¹æ ¡å‡† |
| **ä½ç‚¹ä¸¢å¤±** | P0 | âŒ æ— æ³•è‡ªåŠ¨å¤„ç† | âœ… å¿…é¡»äººå·¥ä¿®å¤ | 10åˆ†é’Ÿ | é‡æ–°åˆå§‹åŒ–ä½ç‚¹ |
| **ç£ç›˜ç©ºé—´ä¸è¶³** | P1 | âœ… æ¸…ç†æ—¥å¿—æ–‡ä»¶ | âš ï¸ æ‰©å®¹ç£ç›˜ | 5åˆ†é’Ÿ | è‡ªåŠ¨æ¸…ç†+å®¹é‡ç›‘æ§ |
| **å†…å­˜æº¢å‡º** | P0 | âœ… é‡å¯æœåŠ¡ | âš ï¸ è°ƒæ•´JVMå‚æ•° | 2åˆ†é’Ÿ | é‡å¯+å‚æ•°ä¼˜åŒ– |

---

## 3. ğŸ“ ä½ç‚¹ç®¡ç†ä¸æ¢å¤æœºåˆ¶



### 3.1 ä½ç‚¹å­˜å‚¨æœºåˆ¶è¯¦è§£



**ä½ç‚¹çš„æœ¬è´¨**ï¼šä½ç‚¹ï¼ˆPositionï¼‰æ˜¯Canalè®°å½•binlogè§£æè¿›åº¦çš„å…³é”®æ ‡è¯†ï¼ŒåŒ…å«æ–‡ä»¶åå’Œåç§»é‡ã€‚

```
ä½ç‚¹ä¿¡æ¯ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LogPosition                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ journalName: mysql-bin.000001     â”‚  â† binlogæ–‡ä»¶å
â”‚ â€¢ position: 1234567                 â”‚  â† æ–‡ä»¶å†…åç§»é‡  
â”‚ â€¢ timestamp: 1704067200000          â”‚  â† äº‹ä»¶æ—¶é—´æˆ³
â”‚ â€¢ serverId: 1                       â”‚  â† MySQL server_id
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ç‚¹å­˜å‚¨æ–¹å¼**ï¼š

**1. æ–‡ä»¶å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰**ï¼š
```bash
# ä½ç‚¹æ–‡ä»¶ä½ç½®

${canal.instance.data.dir}/${canal.instance.destination}/meta.dat

# æ–‡ä»¶å†…å®¹ç¤ºä¾‹

{
  "clientDatas": [{
    "clientIdentity": "1001",
    "cursor": {
      "identity": {
        "slaveId": -1,
        "sourceAddress": "192.168.1.100:3306"
      },
      "postion": {
        "journalName": "mysql-bin.000001",
        "position": 1234567,
        "timestamp": 1704067200000
      }
    }
  }]
}
```

**2. Zookeeperå­˜å‚¨**ï¼š
```properties
# é…ç½®Zookeeperå­˜å‚¨

canal.instance.metaManager = com.alibaba.otter.canal.meta.ZooKeeperMetaManager
canal.zkServers = 127.0.0.1:2181
```

**3. æ•°æ®åº“å­˜å‚¨**ï¼š
```sql
-- ä½ç‚¹å­˜å‚¨è¡¨ç»“æ„
CREATE TABLE canal_position (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    destination VARCHAR(128) NOT NULL,
    client_id VARCHAR(128) NOT NULL,
    binlog_file VARCHAR(128) NOT NULL,
    binlog_position BIGINT NOT NULL,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_dest_client (destination, client_id)
);
```

### 3.2 ä½ç‚¹ä¸¢å¤±æ¢å¤ç­–ç•¥



#### ğŸ”¸ ä½ç‚¹ä¸¢å¤±åŸå› åˆ†æ



**å¸¸è§åŸå› **ï¼š
- meta.datæ–‡ä»¶æŸåæˆ–è¢«åˆ é™¤
- ZookeeperèŠ‚ç‚¹æ•°æ®ä¸¢å¤±
- æ•°æ®åº“ä½ç‚¹è¡¨æ•°æ®å¼‚å¸¸
- Canalå¼‚å¸¸å…³é—­å¯¼è‡´ä½ç‚¹æœªä¿å­˜

#### ğŸ”¸ æ¢å¤ç­–ç•¥é€‰æ‹©



**ç­–ç•¥1ï¼šé‡ç½®åˆ°æœ€æ–°ä½ç‚¹ï¼ˆæ•°æ®ä¸¢å¤±é£é™©ï¼‰**ï¼š
```bash
# è·å–å½“å‰MySQLæœ€æ–°ä½ç‚¹

mysql> SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 | 8888888  |              |                  |
+------------------+----------+--------------+------------------+

# é‡ç½®Canalä½ç‚¹

echo '{"journalName":"mysql-bin.000001","position":8888888}' > meta.dat
```

**ç­–ç•¥2ï¼šåŸºäºæ—¶é—´ç‚¹æ¢å¤ï¼ˆæ¨èï¼‰**ï¼š
```java
public class PositionRecoveryService {
    
    public LogPosition recoverPositionByTime(String targetTime) {
        try {
            // 1. è§£æç›®æ ‡æ—¶é—´
            Date targetDate = DateUtils.parseDate(targetTime, "yyyy-MM-dd HH:mm:ss");
            
            // 2. ä»binlogä¸­æœç´¢æœ€æ¥è¿‘çš„ä½ç‚¹
            List<String> binlogFiles = getBinlogFiles();
            
            for (String binlogFile : binlogFiles) {
                LogPosition position = findPositionByTime(binlogFile, targetDate);
                if (position != null) {
                    logger.info("æ‰¾åˆ°æ¢å¤ä½ç‚¹: {}", position);
                    return position;
                }
            }
            
        } catch (Exception e) {
            logger.error("ä½ç‚¹æ¢å¤å¤±è´¥", e);
        }
        
        return null;
    }
    
    private LogPosition findPositionByTime(String binlogFile, Date targetTime) {
        // ä½¿ç”¨Canalçš„binlogè§£æå™¨æœç´¢æ—¶é—´ç‚¹
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è§£æbinlogæ–‡ä»¶
        return new LogPosition(binlogFile, calculatePosition(targetTime));
    }
}
```

**ç­–ç•¥3ï¼šåŸºäºGTIDæ¢å¤ï¼ˆMySQL 5.6+ï¼‰**ï¼š
```sql
-- æ£€æŸ¥GTIDçŠ¶æ€
mysql> SHOW GLOBAL VARIABLES LIKE '%gtid%';

-- è·å–å·²æ‰§è¡Œçš„GTIDé›†åˆ
mysql> SHOW MASTER STATUS;
mysql> SELECT $$GLOBAL.gtid_executed;

-- Canal GTIDé…ç½®
canal.instance.gtidon = true
canal.instance.gtidSet = 3E11FA47-71CA-11E1-9E33-C80AA9429562:1-5
```

### 3.3 ä½ç‚¹æ ¡éªŒä¸ä¿®å¤



**ä½ç‚¹æ ¡éªŒæœºåˆ¶**ï¼š
```java
public class PositionValidator {
    
    public boolean validatePosition(LogPosition position) {
        try {
            // 1. æ£€æŸ¥binlogæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if (!binlogFileExists(position.getJournalName())) {
                logger.error("binlogæ–‡ä»¶ä¸å­˜åœ¨: {}", position.getJournalName());
                return false;
            }
            
            // 2. æ£€æŸ¥ä½ç‚¹åç§»é‡æ˜¯å¦åˆæ³•
            long fileSize = getBinlogFileSize(position.getJournalName());
            if (position.getPosition() > fileSize) {
                logger.error("ä½ç‚¹åç§»é‡è¶…å‡ºæ–‡ä»¶å¤§å°: {} > {}", 
                    position.getPosition(), fileSize);
                return false;
            }
            
            // 3. å°è¯•ä»è¯¥ä½ç‚¹å¼€å§‹è§£æ
            return canParseFromPosition(position);
            
        } catch (Exception e) {
            logger.error("ä½ç‚¹æ ¡éªŒå¼‚å¸¸", e);
            return false;
        }
    }
    
    private boolean canParseFromPosition(LogPosition position) {
        // å°è¯•è§£æå°‘é‡äº‹ä»¶éªŒè¯ä½ç‚¹æœ‰æ•ˆæ€§
        try (BinlogParser parser = new BinlogParser()) {
            parser.start(position);
            Entry entry = parser.next(5000); // 5ç§’è¶…æ—¶
            return entry != null;
        } catch (Exception e) {
            return false;
        }
    }
}
```

---

## 4. ğŸ”„ æ•°æ®ä¿®å¤ä¸é‡å¤å¤„ç†



### 4.1 æ•°æ®é‡å¤äº§ç”ŸåŸå› 



**é‡å¤æ•°æ®åœºæ™¯**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ä½ç‚¹100 â†’ å¤„ç†äº‹ä»¶A â†’ ä½ç‚¹110 â†’ å¤„ç†äº‹ä»¶B â†’ ä½ç‚¹120

å¼‚å¸¸æµç¨‹ï¼š
ä½ç‚¹100 â†’ å¤„ç†äº‹ä»¶A â†’ ä½ç‚¹110 â†’ Canalå¼‚å¸¸é‡å¯
é‡å¯åä»ä½ç‚¹100å¼€å§‹ â†’ é‡å¤å¤„ç†äº‹ä»¶A
```

**äº§ç”ŸåŸå› åˆ†æ**ï¼š
- Canalå¼‚å¸¸é€€å‡ºæ—¶ä½ç‚¹æœªåŠæ—¶ä¿å­˜
- ä½ç‚¹ä¿å­˜ä¸äº‹ä»¶å¤„ç†ä¸æ˜¯åŸå­æ“ä½œ
- ä¸‹æ¸¸å¤„ç†å¼‚å¸¸å¯¼è‡´ä½ç‚¹å›æ»š
- ç½‘ç»œå¼‚å¸¸å¯¼è‡´ç¡®è®¤æ¶ˆæ¯ä¸¢å¤±

### 4.2 é‡å¤æ•°æ®æ£€æµ‹æœºåˆ¶



**åŸºäºä¸šåŠ¡ä¸»é”®å»é‡**ï¼š
```java
public class DuplicateDetector {
    
    private final Map<String, String> processedRecords = new ConcurrentHashMap<>();
    
    public boolean isDuplicate(Entry entry) {
        String tableKey = entry.getHeader().getSchemaName() + "." + 
                         entry.getHeader().getTableName();
        
        for (RowData rowData : entry.getRowDatasList()) {
            String primaryKey = extractPrimaryKey(rowData);
            String recordKey = tableKey + ":" + primaryKey;
            
            // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
            String lastProcessTime = processedRecords.get(recordKey);
            if (lastProcessTime != null) {
                logger.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®: {}", recordKey);
                return true;
            }
            
            // è®°å½•å·²å¤„ç†
            processedRecords.put(recordKey, String.valueOf(System.currentTimeMillis()));
        }
        
        return false;
    }
    
    private String extractPrimaryKey(RowData rowData) {
        // æå–ä¸»é”®å€¼ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        List<Column> columns = rowData.getAfterColumnsList();
        return columns.stream()
                .filter(Column::getIsKey)
                .map(Column::getValue)
                .collect(Collectors.joining(","));
    }
}
```

**åŸºäºä½ç‚¹å»é‡**ï¼š
```java
public class PositionBasedDeduplicator {
    
    private final Set<String> processedPositions = new HashSet<>();
    
    public boolean shouldProcess(Entry entry) {
        LogPosition position = entry.getHeader().getLogPosition();
        String positionKey = position.getJournalName() + ":" + position.getPosition();
        
        if (processedPositions.contains(positionKey)) {
            logger.info("åŸºäºä½ç‚¹è·³è¿‡é‡å¤æ•°æ®: {}", positionKey);
            return false;
        }
        
        processedPositions.add(positionKey);
        return true;
    }
}
```

### 4.3 æ•°æ®ä¿®å¤ç­–ç•¥



**ä¿®å¤æµç¨‹**ï¼š
```
æ•°æ®ä¿®å¤æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1.æ•°æ®æ¯”å¯¹  â”‚â”€â”€â”€>â”‚  2.å·®å¼‚åˆ†æ  â”‚â”€â”€â”€>â”‚  3.ä¿®å¤æ‰§è¡Œ  â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ æºç«¯ vs ç›®æ ‡ç«¯ â”‚    â”‚ æ‰¾å‡ºä¸ä¸€è‡´è®°å½• â”‚    â”‚ æ‰¹é‡ä¿®å¤æ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·**ï¼š
```java
public class DataConsistencyChecker {
    
    public ConsistencyReport checkConsistency(String database, String table) {
        ConsistencyReport report = new ConsistencyReport();
        
        try {
            // 1. è·å–æºç«¯æ•°æ®æ‘˜è¦
            String sourceChecksum = calculateChecksum(sourceDataSource, database, table);
            
            // 2. è·å–ç›®æ ‡ç«¯æ•°æ®æ‘˜è¦
            String targetChecksum = calculateChecksum(targetDataSource, database, table);
            
            // 3. æ¯”è¾ƒæ‘˜è¦
            if (!sourceChecksum.equals(targetChecksum)) {
                report.setConsistent(false);
                
                // 4. è¯¦ç»†æ¯”å¯¹æ‰¾å‡ºå·®å¼‚è®°å½•
                List<InconsistentRecord> differences = findDifferences(database, table);
                report.setDifferences(differences);
            } else {
                report.setConsistent(true);
            }
            
        } catch (Exception e) {
            logger.error("ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥", e);
            report.setError(e.getMessage());
        }
        
        return report;
    }
    
    private String calculateChecksum(DataSource dataSource, String database, String table) {
        // è®¡ç®—è¡¨æ•°æ®çš„æ ¡éªŒå’Œ
        String sql = String.format(
            "SELECT MD5(GROUP_CONCAT(CONCAT_WS(',', %s) ORDER BY %s)) as checksum FROM %s.%s",
            getAllColumns(table), getPrimaryKey(table), database, table
        );
        
        return jdbcTemplate.queryForObject(sql, String.class);
    }
}
```

---

## 5. ğŸ›¡ï¸ æ•…éšœé¢„é˜²ä¸è‡ªæ„ˆæœºåˆ¶



### 5.1 æ•…éšœé¢„é˜²æªæ–½



#### ğŸ”¸ ç›‘æ§å‘Šè­¦ä½“ç³»



**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```yaml
# Canalç›‘æ§é…ç½®

monitoring:
  metrics:
#    # åŒæ­¥å»¶è¿Ÿç›‘æ§
    sync_delay_threshold: 30000  # 30ç§’
    
#    # é”™è¯¯ç‡ç›‘æ§  
    error_rate_threshold: 0.01   # 1%
    
#    # è¿æ¥çŠ¶æ€ç›‘æ§
    connection_check_interval: 10000  # 10ç§’
    
#    # ä½ç‚¹æ›´æ–°ç›‘æ§
    position_update_threshold: 60000  # 1åˆ†é’Ÿæœªæ›´æ–°å‘Šè­¦
```

**ç›‘æ§å®ç°**ï¼š
```java
@Component
public class CanalMonitor {
    
    @Scheduled(fixedDelay = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkSyncStatus() {
        try {
            // 1. æ£€æŸ¥åŒæ­¥å»¶è¿Ÿ
            long delay = calculateSyncDelay();
            if (delay > 30000) {
                alertService.sendAlert("CanalåŒæ­¥å»¶è¿Ÿè¿‡é«˜: " + delay + "ms");
            }
            
            // 2. æ£€æŸ¥é”™è¯¯ç‡
            double errorRate = calculateErrorRate();
            if (errorRate > 0.01) {
                alertService.sendAlert("Canalé”™è¯¯ç‡è¿‡é«˜: " + (errorRate * 100) + "%");
            }
            
            // 3. æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!isConnectionHealthy()) {
                alertService.sendAlert("Canalè¿æ¥å¼‚å¸¸");
            }
            
        } catch (Exception e) {
            logger.error("ç›‘æ§æ£€æŸ¥å¼‚å¸¸", e);
        }
    }
    
    private long calculateSyncDelay() {
        // è®¡ç®—binlogæ—¶é—´æˆ³ä¸å½“å‰æ—¶é—´çš„å·®å€¼
        LogPosition currentPosition = canalClient.getCurrentPosition();
        return System.currentTimeMillis() - currentPosition.getTimestamp();
    }
}
```

#### ğŸ”¸ èµ„æºä¿æŠ¤æœºåˆ¶



**å†…å­˜ä¿æŠ¤**ï¼š
```bash
# JVMå†…å­˜é…ç½®

-Xms2g -Xmx4g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/opt/canal/logs/

# å†…å­˜ä½¿ç”¨ç›‘æ§

-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
```

**ç£ç›˜ä¿æŠ¤**ï¼š
```properties
# æ—¥å¿—æ–‡ä»¶å¤§å°é™åˆ¶

canal.instance.memory.buffer.size = 16384
canal.instance.memory.buffer.memunit = 1024

# è‡ªåŠ¨æ¸…ç†æœºåˆ¶

canal.instance.tsdb.enable = true
canal.instance.tsdb.dir = ${canal.conf.dir}/../logs
```

### 5.2 è‡ªæ„ˆæœºåˆ¶è®¾è®¡



#### ğŸ”¸ è‡ªåŠ¨é‡å¯æœºåˆ¶



**è¿›ç¨‹ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash

# canal_watchdog.sh - Canalè¿›ç¨‹ç›‘æ§è„šæœ¬


CANAL_HOME="/opt/canal"
CANAL_PID_FILE="$CANAL_HOME/bin/canal.pid"
MAX_RESTART_COUNT=3
RESTART_COUNT_FILE="/tmp/canal_restart_count"

check_canal_process() {
    if [ -f "$CANAL_PID_FILE" ]; then
        PID=$(cat $CANAL_PID_FILE)
        if ps -p $PID > /dev/null 2>&1; then
            return 0  # è¿›ç¨‹æ­£å¸¸è¿è¡Œ
        fi
    fi
    return 1  # è¿›ç¨‹ä¸å­˜åœ¨
}

restart_canal() {
    echo "$(date): Canalè¿›ç¨‹å¼‚å¸¸ï¼Œå°è¯•é‡å¯..."
    
#    # è·å–é‡å¯æ¬¡æ•°
    if [ -f "$RESTART_COUNT_FILE" ]; then
        RESTART_COUNT=$(cat $RESTART_COUNT_FILE)
    else
        RESTART_COUNT=0
    fi
    
#    # æ£€æŸ¥é‡å¯æ¬¡æ•°é™åˆ¶
    if [ $RESTART_COUNT -ge $MAX_RESTART_COUNT ]; then
        echo "$(date): é‡å¯æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œåœæ­¢è‡ªåŠ¨é‡å¯ï¼Œå‘é€å‘Šè­¦"
#        # å‘é€å‘Šè­¦é€šçŸ¥
        send_alert "Canalé‡å¯æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
        exit 1
    fi
    
#    # æ‰§è¡Œé‡å¯
    cd $CANAL_HOME
    sh bin/startup.sh
    
#    # æ›´æ–°é‡å¯æ¬¡æ•°
    echo $((RESTART_COUNT + 1)) > $RESTART_COUNT_FILE
    
    sleep 30  # ç­‰å¾…å¯åŠ¨å®Œæˆ
    
    if check_canal_process; then
        echo "$(date): Canalé‡å¯æˆåŠŸ"
#        # é‡å¯æˆåŠŸï¼Œæ¸…é›¶è®¡æ•°å™¨
        echo 0 > $RESTART_COUNT_FILE
    else
        echo "$(date): Canalé‡å¯å¤±è´¥"
    fi
}

# ä¸»ç›‘æ§å¾ªç¯

while true; do
    if ! check_canal_process; then
        restart_canal
    fi
    sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
```

#### ğŸ”¸ ä½ç‚¹è‡ªåŠ¨æ ¡æ­£



**ä½ç‚¹å¼‚å¸¸æ£€æµ‹ä¸æ ¡æ­£**ï¼š
```java
@Component
public class PositionAutoCorrector {
    
    @Scheduled(fixedDelay = 300000) // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkAndCorrectPosition() {
        try {
            LogPosition currentPosition = getCurrentPosition();
            
            // 1. æ£€æŸ¥ä½ç‚¹æ˜¯å¦å¼‚å¸¸
            if (isPositionAbnormal(currentPosition)) {
                logger.warn("æ£€æµ‹åˆ°å¼‚å¸¸ä½ç‚¹: {}", currentPosition);
                
                // 2. å°è¯•è‡ªåŠ¨æ ¡æ­£
                LogPosition correctedPosition = autoCorrectPosition(currentPosition);
                
                if (correctedPosition != null) {
                    // 3. åº”ç”¨æ ¡æ­£åçš„ä½ç‚¹
                    applyPosition(correctedPosition);
                    logger.info("ä½ç‚¹è‡ªåŠ¨æ ¡æ­£æˆåŠŸ: {} -> {}", currentPosition, correctedPosition);
                } else {
                    // 4. è‡ªåŠ¨æ ¡æ­£å¤±è´¥ï¼Œå‘é€å‘Šè­¦
                    alertService.sendAlert("ä½ç‚¹å¼‚å¸¸ä¸”æ— æ³•è‡ªåŠ¨æ ¡æ­£ï¼Œéœ€è¦äººå·¥å¤„ç†");
                }
            }
            
        } catch (Exception e) {
            logger.error("ä½ç‚¹è‡ªåŠ¨æ ¡æ­£å¼‚å¸¸", e);
        }
    }
    
    private boolean isPositionAbnormal(LogPosition position) {
        // æ£€æŸ¥ä½ç‚¹æ˜¯å¦å¼‚å¸¸çš„é€»è¾‘
        return !binlogFileExists(position.getJournalName()) || 
               position.getPosition() < 0 ||
               isPositionTooOld(position);
    }
    
    private LogPosition autoCorrectPosition(LogPosition abnormalPosition) {
        // å°è¯•æ‰¾åˆ°æœ€è¿‘çš„æœ‰æ•ˆä½ç‚¹
        List<String> recentBinlogs = getRecentBinlogFiles();
        
        for (String binlogFile : recentBinlogs) {
            LogPosition candidatePosition = new LogPosition(binlogFile, 4); // binlogæ–‡ä»¶å¼€å§‹ä½ç½®
            if (validatePosition(candidatePosition)) {
                return candidatePosition;
            }
        }
        
        return null; // æ— æ³•è‡ªåŠ¨æ ¡æ­£
    }
}
```

---

## 6. ğŸš¨ åº”æ€¥é¢„æ¡ˆä¸æ“ä½œæµç¨‹



### 6.1 åº”æ€¥é¢„æ¡ˆæ¨¡æ¿



#### ğŸ”¸ P0çº§æ•…éšœåº”æ€¥é¢„æ¡ˆ



**æ•…éšœç±»å‹**ï¼šæ•°æ®ä¸¢å¤±ã€æœåŠ¡å®Œå…¨ä¸å¯ç”¨

**å“åº”æµç¨‹**ï¼š
```
P0æ•…éšœå“åº”æµç¨‹ï¼ˆæ€»æ—¶é•¿: 30åˆ†é’Ÿå†…æ¢å¤ï¼‰:

0-5åˆ†é’Ÿï¼šæ•…éšœç¡®è®¤
â”œâ”€ ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
â”œâ”€ è¯„ä¼°æ•°æ®ä¸¢å¤±é£é™©  
â””â”€ å¯åŠ¨åº”æ€¥å“åº”

5-15åˆ†é’Ÿï¼šç´§æ€¥å¤„ç†
â”œâ”€ åœæ­¢CanalæœåŠ¡ï¼ˆé˜²æ­¢æ•°æ®æ±¡æŸ“ï¼‰
â”œâ”€ ä¿ç•™ç°åœºæ—¥å¿—å’Œä½ç‚¹ä¿¡æ¯
â”œâ”€ è¯„ä¼°æ¢å¤ç­–ç•¥
â””â”€ æ‰§è¡Œæœ€ä¼˜æ¢å¤æ–¹æ¡ˆ

15-25åˆ†é’Ÿï¼šæœåŠ¡æ¢å¤
â”œâ”€ é‡å¯CanalæœåŠ¡
â”œâ”€ éªŒè¯æ•°æ®åŒæ­¥æ­£å¸¸
â”œâ”€ æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
â””â”€ æ¢å¤ä¸šåŠ¡æµé‡

25-30åˆ†é’Ÿï¼šåç»­å¤„ç†
â”œâ”€ é€šçŸ¥ç›¸å…³å›¢é˜Ÿæ•…éšœå·²æ¢å¤
â”œâ”€ æ•´ç†æ•…éšœå¤„ç†è®°å½•
â””â”€ å®‰æ’æ•…éšœå¤ç›˜æ—¶é—´
```

**å…·ä½“æ“ä½œå‘½ä»¤**ï¼š
```bash
# 1. ç´§æ€¥åœæœ

cd /opt/canal
sh bin/stop.sh

# 2. å¤‡ä»½ç°åœº

cp -r logs logs_backup_$(date +%Y%m%d_%H%M%S)
cp conf/example/meta.dat meta.dat.backup

# 3. æ£€æŸ¥MySQLçŠ¶æ€

mysql -h192.168.1.100 -u canal_user -p -e "SHOW MASTER STATUS;"

# 4. ä½ç‚¹æ¢å¤ï¼ˆæ ¹æ®å…·ä½“æƒ…å†µé€‰æ‹©ï¼‰

# æ–¹æ¡ˆA: é‡ç½®åˆ°æœ€æ–°ä½ç‚¹

echo '{"journalName":"mysql-bin.000123","position":4567890}' > conf/example/meta.dat

# æ–¹æ¡ˆB: åŸºäºæ—¶é—´ç‚¹æ¢å¤

./tools/position_recovery.sh --timestamp="2024-01-01 14:30:00"

# 5. é‡å¯æœåŠ¡

sh bin/startup.sh

# 6. éªŒè¯æœåŠ¡çŠ¶æ€

tail -f logs/canal/canal.log
```

#### ğŸ”¸ P1çº§æ•…éšœåº”æ€¥é¢„æ¡ˆ



**æ•…éšœç±»å‹**ï¼šæ•°æ®å»¶è¿Ÿã€éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸

**å¿«é€Ÿè¯Šæ–­æ¸…å•**ï¼š
```bash
# 1. æ£€æŸ¥Canalè¿›ç¨‹çŠ¶æ€

ps aux | grep canal
netstat -tlnp | grep 11111

# 2. æ£€æŸ¥åŒæ­¥å»¶è¿Ÿ

mysql -h192.168.1.100 -u canal_user -p -e "SHOW SLAVE STATUS\G" | grep Seconds_Behind_Master

# 3. æ£€æŸ¥é”™è¯¯æ—¥å¿—

tail -100 logs/canal/canal.log | grep ERROR
tail -100 logs/example/example.log | grep ERROR

# 4. æ£€æŸ¥èµ„æºä½¿ç”¨

top -p $(cat bin/canal.pid)
df -h /opt/canal

# 5. æ£€æŸ¥ç½‘ç»œè¿æ¥

telnet 192.168.1.100 3306
```

### 6.2 æ•…éšœæ ¹å› åˆ†ææ–¹æ³•



#### ğŸ”¸ åˆ†ææ€è·¯æ¡†æ¶



```
æ•…éšœæ ¹å› åˆ†æäº”è¦ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚  äºº(People)     æœº(Machine)    æ–™(Material) â”‚
â”‚     â†“              â†“              â†“         â”‚
â”‚   æ“ä½œå¤±è¯¯       ç¡¬ä»¶æ•…éšœ      æ•°æ®å¼‚å¸¸       â”‚
â”‚     â†“              â†“              â†“         â”‚
â”‚  æ³•(Method)     ç¯(Environment)              â”‚
â”‚     â†“              â†“                        â”‚
â”‚   é…ç½®é”™è¯¯       ç½‘ç»œç¯å¢ƒ                     â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¹å› åˆ†ææ­¥éª¤**ï¼š
```java
public class RootCauseAnalyzer {
    
    public AnalysisReport analyzeFailure(FailureEvent event) {
        AnalysisReport report = new AnalysisReport();
        
        // 1. æ”¶é›†æ•…éšœä¿¡æ¯
        collectFailureInfo(event, report);
        
        // 2. æ—¶é—´è½´åˆ†æ
        buildTimelineAnalysis(event, report);
        
        // 3. ç³»ç»ŸçŠ¶æ€åˆ†æ
        analyzeSystemState(event, report);
        
        // 4. æ—¥å¿—å…³è”åˆ†æ
        analyzeRelatedLogs(event, report);
        
        // 5. æ ¹å› æ¨æ–­
        inferRootCause(report);
        
        return report;
    }
    
    private void collectFailureInfo(FailureEvent event, AnalysisReport report) {
        // æ”¶é›†æ•…éšœæ—¶çš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯
        report.addInfo("æ•…éšœæ—¶é—´", event.getOccurTime());
        report.addInfo("å½±å“èŒƒå›´", event.getImpactScope());
        report.addInfo("æ•…éšœç°è±¡", event.getSymptoms());
        
        // æ”¶é›†ç›¸å…³é…ç½®ä¿¡æ¯
        report.addInfo("Canalç‰ˆæœ¬", getCanalVersion());
        report.addInfo("MySQLç‰ˆæœ¬", getMySQLVersion());
        report.addInfo("ç³»ç»Ÿé…ç½®", getSystemConfiguration());
    }
    
    private void buildTimelineAnalysis(FailureEvent event, AnalysisReport report) {
        // æ„å»ºæ•…éšœå‰åçš„æ—¶é—´è½´
        List<TimelineEvent> timeline = new ArrayList<>();
        
        // æ•…éšœå‰30åˆ†é’Ÿçš„å…³é”®äº‹ä»¶
        timeline.addAll(getEventsBeforeFailure(event.getOccurTime(), 30));
        
        // æ•…éšœå‘ç”Ÿæ—¶çš„äº‹ä»¶
        timeline.add(new TimelineEvent(event.getOccurTime(), "æ•…éšœå‘ç”Ÿ", event.getDescription()));
        
        // æ•…éšœåçš„å¤„ç†äº‹ä»¶
        timeline.addAll(getEventsAfterFailure(event.getOccurTime()));
        
        report.setTimeline(timeline);
    }
}
```

### 6.3 æ“ä½œæ‰‹å†Œä¸æ£€æŸ¥æ¸…å•



**æ—¥å¸¸å·¡æ£€æ¸…å•**ï¼š
```markdown
# Canalæ—¥å¸¸å·¡æ£€æ¸…å•


# æœåŠ¡çŠ¶æ€æ£€æŸ¥ âœ…


- [ ] Canalè¿›ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œ
- [ ] ä¸MySQLè¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] ä¸‹æ¸¸æ¶ˆè´¹ç«¯è¿æ¥æ˜¯å¦æ­£å¸¸
- [ ] åŒæ­¥å»¶è¿Ÿæ˜¯å¦åœ¨æ­£å¸¸èŒƒå›´å†…ï¼ˆ< 30ç§’ï¼‰

# èµ„æºä½¿ç”¨æ£€æŸ¥ âœ…  


- [ ] CPUä½¿ç”¨ç‡ < 80%
- [ ] å†…å­˜ä½¿ç”¨ç‡ < 85%
- [ ] ç£ç›˜ä½¿ç”¨ç‡ < 90%
- [ ] ç½‘ç»œè¿æ¥æ•°æ˜¯å¦æ­£å¸¸

# æ•°æ®è´¨é‡æ£€æŸ¥ âœ…


- [ ] é”™è¯¯æ—¥å¿—æ•°é‡æ˜¯å¦å¼‚å¸¸
- [ ] æ•°æ®åŒæ­¥é‡æ˜¯å¦ç¬¦åˆé¢„æœŸ
- [ ] å…³é”®è¡¨æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- [ ] ä½ç‚¹æ›´æ–°æ˜¯å¦æ­£å¸¸

# é…ç½®æ£€æŸ¥ âœ…


- [ ] é…ç½®æ–‡ä»¶æ˜¯å¦è¢«æ„å¤–ä¿®æ”¹
- [ ] æ•°æ®åº“æƒé™æ˜¯å¦æ­£å¸¸
- [ ] ç›‘æ§å‘Šè­¦æ˜¯å¦å·¥ä½œæ­£å¸¸
- [ ] å¤‡ä»½ç­–ç•¥æ˜¯å¦æ‰§è¡Œ
```

**æ•…éšœå¤„ç†æ“ä½œæ‰‹å†Œ**ï¼š
```bash
#!/bin/bash

# canal_troubleshoot.sh - Canalæ•…éšœå¤„ç†å·¥å…·è„šæœ¬


function show_menu() {
    echo "=== Canalæ•…éšœå¤„ç†å·¥å…· ==="
    echo "1. å¿«é€Ÿè¯Šæ–­"
    echo "2. é‡å¯æœåŠ¡"
    echo "3. ä½ç‚¹é‡ç½®"
    echo "4. æ—¥å¿—åˆ†æ"
    echo "5. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥"
    echo "0. é€€å‡º"
    read -p "è¯·é€‰æ‹©æ“ä½œ: " choice
}

function quick_diagnosis() {
    echo "=== å¿«é€Ÿè¯Šæ–­ ==="
    
#    # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
    echo "1. æ£€æŸ¥Canalè¿›ç¨‹..."
    if pgrep -f canal > /dev/null; then
        echo "   âœ… Canalè¿›ç¨‹æ­£å¸¸è¿è¡Œ"
    else
        echo "   âŒ Canalè¿›ç¨‹æœªè¿è¡Œ"
    fi
    
#    # æ£€æŸ¥ç«¯å£ç›‘å¬
    echo "2. æ£€æŸ¥ç«¯å£ç›‘å¬..."
    if netstat -tlnp | grep 11111 > /dev/null; then
        echo "   âœ… Canalç«¯å£æ­£å¸¸ç›‘å¬"
    else
        echo "   âŒ Canalç«¯å£æœªç›‘å¬"
    fi
    
#    # æ£€æŸ¥MySQLè¿æ¥
    echo "3. æ£€æŸ¥MySQLè¿æ¥..."
    if mysql -h${MYSQL_HOST} -u${CANAL_USER} -p${CANAL_PASSWORD} -e "SELECT 1" > /dev/null 2>&1; then
        echo "   âœ… MySQLè¿æ¥æ­£å¸¸"
    else
        echo "   âŒ MySQLè¿æ¥å¤±è´¥"
    fi
    
#    # æ£€æŸ¥æœ€æ–°æ—¥å¿—
    echo "4. æ£€æŸ¥æœ€æ–°é”™è¯¯æ—¥å¿—..."
    if tail -20 logs/canal/canal.log | grep ERROR > /dev/null; then
        echo "   âš ï¸  å‘ç°é”™è¯¯æ—¥å¿—:"
        tail -5 logs/canal/canal.log | grep ERROR
    else
        echo "   âœ… æ— æ˜æ˜¾é”™è¯¯"
    fi
}

# ä¸»ç¨‹åºå…¥å£

while true; do
    show_menu
    case $choice in
        1) quick_diagnosis ;;
        2) restart_canal_service ;;
        3) reset_position ;;
        4) analyze_logs ;;
        5) check_data_consistency ;;
        0) exit 0 ;;
        *) echo "æ— æ•ˆé€‰æ‹©" ;;
    esac
    echo
    read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
done
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 7.1 å¿…é¡»æŒæ¡çš„æ•…éšœå¤„ç†è¦ç‚¹



```
ğŸ”¸ Canalæ•…éšœåˆ†ç±»ï¼šç¯å¢ƒã€é…ç½®ã€ç¨‹åºã€æ•°æ®å››å¤§ç±»æ•…éšœ
ğŸ”¸ ä½ç‚¹ç®¡ç†ï¼šç†è§£ä½ç‚¹ç»“æ„ã€å­˜å‚¨æ–¹å¼å’Œæ¢å¤ç­–ç•¥
ğŸ”¸ è‡ªåŠ¨é‡è¿ï¼šç½‘ç»œä¸­æ–­çš„è‡ªåŠ¨æ¢å¤æœºåˆ¶å’Œé‡è¯•ç­–ç•¥
ğŸ”¸ ä¸»ä»åˆ‡æ¢ï¼šMySQLä¸»ä»åˆ‡æ¢æ—¶çš„ä½ç‚¹è½¬æ¢å¤„ç†
ğŸ”¸ æ•°æ®ä¿®å¤ï¼šé‡å¤æ•°æ®æ£€æµ‹å’Œä¸€è‡´æ€§æ ¡éªŒæ–¹æ³•
ğŸ”¸ é¢„é˜²æœºåˆ¶ï¼šç›‘æ§å‘Šè­¦ã€èµ„æºä¿æŠ¤å’Œè‡ªæ„ˆæœºåˆ¶
ğŸ”¸ åº”æ€¥å“åº”ï¼šP0/P1æ•…éšœçš„æ ‡å‡†å¤„ç†æµç¨‹
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ æ•…éšœå¤„ç†çš„æ ¸å¿ƒåŸåˆ™**
```
æ•°æ®å®‰å…¨ä¼˜å…ˆï¼š
â€¢ ä»»ä½•æ“ä½œéƒ½è¦è€ƒè™‘æ•°æ®ä¸¢å¤±é£é™©
â€¢ é‡è¦æ“ä½œå‰å¿…é¡»å¤‡ä»½ç°åœº
â€¢ ä¼˜å…ˆä¿è¯æ•°æ®ä¸€è‡´æ€§è€ŒéæœåŠ¡å¯ç”¨æ€§

å¿«é€Ÿæ¢å¤å¯¼å‘ï¼š
â€¢ P0æ•…éšœ30åˆ†é’Ÿå†…å¿…é¡»æ¢å¤
â€¢ æ ‡å‡†åŒ–æ“ä½œæµç¨‹ï¼Œå‡å°‘äººä¸ºé”™è¯¯
â€¢ è‡ªåŠ¨åŒ–ä¼˜å…ˆï¼Œäººå·¥å¹²é¢„ä¸ºè¾…

æ ¹å› åˆ†ææ€ç»´ï¼š
â€¢ ä¸ä»…è¦è§£å†³è¡¨é¢é—®é¢˜ï¼Œè¿˜è¦æ‰¾åˆ°æ ¹æœ¬åŸå› 
â€¢ å»ºç«‹æ•…éšœçŸ¥è¯†åº“ï¼Œé¿å…é‡å¤æ•…éšœ
â€¢ æŒç»­æ”¹è¿›é¢„é˜²æœºåˆ¶
```

**ğŸ”¹ ä½ç‚¹ç®¡ç†çš„å…³é”®ç†è§£**
```
ä½ç‚¹çš„æœ¬è´¨ï¼š
â€¢ ä½ç‚¹æ˜¯Canalçš„"ä¹¦ç­¾"ï¼Œè®°å½•è§£æè¿›åº¦
â€¢ ä½ç‚¹ä¸¢å¤±ç­‰äº"å¿˜è®°è¯»åˆ°å“ªé‡Œäº†"
â€¢ ä½ç‚¹é”™è¯¯å¯èƒ½å¯¼è‡´æ•°æ®é‡å¤æˆ–ä¸¢å¤±

æ¢å¤ç­–ç•¥é€‰æ‹©ï¼š
â€¢ åŸºäºæ—¶é—´ç‚¹æ¢å¤ï¼šæœ€å®‰å…¨ä½†å¯èƒ½æœ‰å»¶è¿Ÿ
â€¢ é‡ç½®åˆ°æœ€æ–°ï¼šæœ€å¿«ä½†å¯èƒ½ä¸¢å¤±æ•°æ®
â€¢ åŸºäºGTIDï¼šæœ€å‡†ç¡®ä½†éœ€è¦MySQL 5.6+æ”¯æŒ
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼



- **ç”Ÿäº§ç¯å¢ƒè¿ç»´**ï¼šæŒæ¡Canalæ•…éšœçš„å¿«é€Ÿå®šä½å’Œå¤„ç†
- **æ•°æ®å®‰å…¨ä¿éšœ**ï¼šç†è§£æ•°æ®åŒæ­¥çš„é£é™©ç‚¹å’Œé˜²æŠ¤æªæ–½  
- **ç³»ç»Ÿç¨³å®šæ€§æå‡**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œè‡ªæ„ˆæœºåˆ¶
- **åº”æ€¥å“åº”èƒ½åŠ›**ï¼šå…·å¤‡P0/P1æ•…éšœçš„æ ‡å‡†å¤„ç†èƒ½åŠ›
- **å›¢é˜Ÿåä½œæ•ˆç‡**ï¼šæ ‡å‡†åŒ–çš„æ•…éšœå¤„ç†æµç¨‹å’Œæ–‡æ¡£

**æ ¸å¿ƒè®°å¿†**ï¼š
- Canalæ•…éšœè¦åˆ†çº§å¤„ç†ï¼ŒP0çº§30åˆ†é’Ÿå†…æ¢å¤
- ä½ç‚¹æ˜¯æ ¸å¿ƒï¼Œå¤‡ä»½ç°åœºæ˜¯åŸåˆ™ï¼Œæ•°æ®å®‰å…¨æ˜¯åº•çº¿
- ç›‘æ§é¢„é˜²èƒœè¿‡æ•…éšœå¤„ç†ï¼Œè‡ªåŠ¨åŒ–ä¼˜äºäººå·¥å¹²é¢„
- æ ¹å› åˆ†æé˜²é‡å¤ï¼Œæ ‡å‡†æµç¨‹å‡é£é™©