---
title: 3ã€æŸ¥è¯¢è·¯ç”±ä¸Žé‡å†™è§„åˆ™
---
## ðŸ“š ç›®å½•

1. [æŸ¥è¯¢è·¯ç”±åŸºç¡€æ¦‚å¿µ](#1-æŸ¥è¯¢è·¯ç”±åŸºç¡€æ¦‚å¿µ)
2. [SQLè·¯ç”±ç®—æ³•åŽŸç†](#2-SQLè·¯ç”±ç®—æ³•åŽŸç†)
3. [è¯»å†™åˆ†ç¦»è·¯ç”±æœºåˆ¶](#3-è¯»å†™åˆ†ç¦»è·¯ç”±æœºåˆ¶)
4. [æŸ¥è¯¢é‡å†™è§„åˆ™](#4-æŸ¥è¯¢é‡å†™è§„åˆ™)
5. [è·¯ç”±è§„åˆ™é…ç½®](#5-è·¯ç”±è§„åˆ™é…ç½®)
6. [æŸ¥è¯¢åˆ†æžå™¨è¯¦è§£](#6-æŸ¥è¯¢åˆ†æžå™¨è¯¦è§£)
7. [é«˜çº§è·¯ç”±ç­–ç•¥](#7-é«˜çº§è·¯ç”±ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŽ¯ æŸ¥è¯¢è·¯ç”±åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢è·¯ç”±


**æŸ¥è¯¢è·¯ç”±**å°±åƒæ˜¯ä¸€ä¸ªæ™ºèƒ½çš„äº¤é€šæŒ‡æŒ¥å‘˜ï¼Œå®ƒçš„å·¥ä½œæ˜¯å†³å®šå®¢æˆ·ç«¯å‘æ¥çš„SQLè¯­å¥åº”è¯¥å‘é€åˆ°å“ªä¸ªæ•°æ®åº“æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚

```
ç®€å•ç†è§£ï¼š
å®¢æˆ·ç«¯å‘é€SQL â†’ ä»£ç†ä¸­é—´ä»¶ â†’ åˆ†æžSQLç±»åž‹ â†’ é€‰æ‹©åˆé€‚çš„æœåŠ¡å™¨ â†’ è½¬å‘æ‰§è¡Œ
```

**ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢è·¯ç”±ï¼Ÿ**
- **è¯»å†™åˆ†ç¦»**ï¼šè¯»æ“ä½œå‘åˆ°ä»Žåº“ï¼Œå†™æ“ä½œå‘åˆ°ä¸»åº“
- **è´Ÿè½½å‡è¡¡**ï¼šæŠŠæŸ¥è¯¢åˆ†æ•£åˆ°å¤šä¸ªæœåŠ¡å™¨
- **æ•°æ®åˆ†ç‰‡**ï¼šæ ¹æ®æ¡ä»¶æŠŠæ•°æ®åˆ†æ•£å­˜å‚¨
- **æ•…éšœè½¬ç§»**ï¼šæŸå°æœåŠ¡å™¨æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢

### 1.2 è·¯ç”±å·¥ä½œæµç¨‹


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯åº”ç”¨  â”‚â”€â”€â”€â†’â”‚  ä»£ç†ä¸­é—´ä»¶      â”‚â”€â”€â”€â†’â”‚  æ•°æ®åº“é›†ç¾¤  â”‚
â”‚             â”‚    â”‚                â”‚    â”‚             â”‚
â”‚ SELECT ...  â”‚    â”‚ 1.è§£æžSQL       â”‚    â”‚ ä¸»åº“(å†™)    â”‚
â”‚ INSERT ...  â”‚    â”‚ 2.åŒ¹é…è§„åˆ™      â”‚    â”‚ ä»Žåº“1(è¯»)   â”‚
â”‚ UPDATE ...  â”‚    â”‚ 3.é€‰æ‹©ç›®æ ‡      â”‚    â”‚ ä»Žåº“2(è¯»)   â”‚
â”‚             â”‚    â”‚ 4.è½¬å‘æ‰§è¡Œ      â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 è·¯ç”±å†³ç­–å› ç´ 


**ä¸»è¦åˆ¤æ–­ä¾æ®ï¼š**
- **SQLè¯­å¥ç±»åž‹**ï¼šSELECTã€INSERTã€UPDATEã€DELETE
- **ç”¨æˆ·èº«ä»½**ï¼šä¸åŒç”¨æˆ·æœ‰ä¸åŒæƒé™å’Œè·¯ç”±è§„åˆ™
- **ç›®æ ‡æ•°æ®åº“**ï¼šæ“ä½œå“ªä¸ªæ•°æ®åº“
- **æŸ¥è¯¢æ¡ä»¶**ï¼šWHEREæ¡ä»¶ä¸­çš„ç‰¹å®šå­—æ®µå€¼
- **æ—¶é—´å› ç´ **ï¼šæŸäº›æ—¶æ®µçš„ç‰¹æ®Šè·¯ç”±ç­–ç•¥

---

## 2. ðŸ”„ SQLè·¯ç”±ç®—æ³•åŽŸç†


### 2.1 åŸºäºŽè¯­å¥ç±»åž‹çš„è·¯ç”±


è¿™æ˜¯æœ€åŸºç¡€çš„è·¯ç”±æ–¹å¼ï¼Œæ ¹æ®SQLè¯­å¥çš„æ“ä½œç±»åž‹æ¥å†³å®šåŽ»å‘ã€‚

**è·¯ç”±è§„åˆ™ç¤ºä¾‹ï¼š**
```
è¯»æ“ä½œï¼ˆSELECTï¼‰    â†’ ä»Žåº“æœåŠ¡å™¨
å†™æ“ä½œï¼ˆINSERT/UPDATE/DELETEï¼‰ â†’ ä¸»åº“æœåŠ¡å™¨
DDLæ“ä½œï¼ˆCREATE/ALTERï¼‰        â†’ ä¸»åº“æœåŠ¡å™¨
```

**å®žé™…åº”ç”¨åœºæ™¯ï¼š**
```sql
-- è¿™ä¸ªæŸ¥è¯¢ä¼šè¢«è·¯ç”±åˆ°ä»Žåº“
SELECT * FROM users WHERE age > 18;

-- è¿™ä¸ªæ’å…¥ä¼šè¢«è·¯ç”±åˆ°ä¸»åº“  
INSERT INTO users (name, age) VALUES ('å¼ ä¸‰', 25);

-- è¿™ä¸ªæ›´æ–°ä¼šè¢«è·¯ç”±åˆ°ä¸»åº“
UPDATE users SET age = 26 WHERE id = 1;
```

### 2.2 åŸºäºŽæ­£åˆ™è¡¨è¾¾å¼çš„è·¯ç”±


æ­£åˆ™è¡¨è¾¾å¼è®©è·¯ç”±è§„åˆ™æ›´åŠ çµæ´»ï¼Œå¯ä»¥åŒ¹é…å¤æ‚çš„SQLæ¨¡å¼ã€‚

**å¸¸ç”¨æ­£åˆ™æ¨¡å¼ï¼š**
```
^SELECT.*FROM users.*     # åŒ¹é…æŸ¥è¯¢usersè¡¨çš„è¯­å¥
^INSERT INTO orders.*     # åŒ¹é…æ’å…¥ordersè¡¨çš„è¯­å¥  
.*WHERE user_id = \d+.*   # åŒ¹é…åŒ…å«ç‰¹å®šç”¨æˆ·IDçš„æŸ¥è¯¢
```

**å®žé™…é…ç½®ç¤ºä¾‹ï¼š**
```sql
-- åŒ¹é…æ‰€æœ‰æŠ¥è¡¨æŸ¥è¯¢ï¼Œå‘é€åˆ°ä¸“é—¨çš„æŠ¥è¡¨æœåŠ¡å™¨
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup) 
VALUES 
(1, '^SELECT.*FROM report_.*', 2);
```

### 2.3 åŸºäºŽå“ˆå¸Œçš„åˆ†ç‰‡è·¯ç”±


å½“æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªæ•°æ®åº“æ—¶ï¼Œéœ€è¦æ ¹æ®æŸä¸ªå­—æ®µçš„å€¼æ¥å†³å®šæŸ¥è¯¢å“ªä¸ªåˆ†ç‰‡ã€‚

**åˆ†ç‰‡è·¯ç”±åŽŸç†ï¼š**
```
ç”¨æˆ·ID = 12345
å“ˆå¸Œå€¼ = hash(12345) = 67890  
åˆ†ç‰‡ç¼–å· = 67890 % åˆ†ç‰‡æ€»æ•°
ç›®æ ‡æœåŠ¡å™¨ = åˆ†ç‰‡ç¼–å·å¯¹åº”çš„æ•°æ®åº“
```

**åˆ†ç‰‡ç¤ºä¾‹ï¼š**
```sql
-- ç”¨æˆ·IDä¸º1001çš„æ•°æ®ï¼Œé€šè¿‡å“ˆå¸Œè®¡ç®—åŽå¯èƒ½åœ¨åˆ†ç‰‡2
SELECT * FROM users WHERE user_id = 1001;

-- ç”¨æˆ·IDä¸º2002çš„æ•°æ®ï¼Œå¯èƒ½åœ¨åˆ†ç‰‡1  
SELECT * FROM orders WHERE user_id = 2002;
```

---

## 3. ðŸ“– è¯»å†™åˆ†ç¦»è·¯ç”±æœºåˆ¶


### 3.1 è¯»å†™åˆ†ç¦»åŸºæœ¬åŽŸç†


è¯»å†™åˆ†ç¦»æ˜¯æœ€å¸¸è§çš„è·¯ç”±ç­–ç•¥ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯**å†™æ“ä½œå½±å“æ•°æ®ï¼Œå¿…é¡»åœ¨ä¸»åº“æ‰§è¡Œï¼›è¯»æ“ä½œä¸æ”¹å˜æ•°æ®ï¼Œå¯ä»¥åœ¨ä»Žåº“æ‰§è¡Œ**ã€‚

```
æ•°æ®åº“æž¶æž„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¤åˆ¶    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»åº“      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   ä»Žåº“1     â”‚
â”‚  (Master)   â”‚          â”‚  (Slave1)   â”‚  
â”‚   å†™æ“ä½œ     â”‚    å¤åˆ¶    â”‚   è¯»æ“ä½œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   ä»Žåº“2     â”‚
                        â”‚  (Slave2)   â”‚
                        â”‚   è¯»æ“ä½œ     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯»å†™æ“ä½œè¯†åˆ«


**å†™æ“ä½œï¼ˆå¿…é¡»ä¸»åº“ï¼‰ï¼š**
- INSERTï¼šæ’å…¥æ–°æ•°æ®
- UPDATEï¼šä¿®æ”¹çŽ°æœ‰æ•°æ®  
- DELETEï¼šåˆ é™¤æ•°æ®
- DDLè¯­å¥ï¼šCREATEã€ALTERã€DROPç­‰

**è¯»æ“ä½œï¼ˆå¯ä»¥ä»Žåº“ï¼‰ï¼š**
- SELECTï¼šæŸ¥è¯¢æ•°æ®
- SHOWï¼šæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
- DESCRIBEï¼šæŸ¥çœ‹è¡¨ç»“æž„

### 3.3 è¯»æ“ä½œè´Ÿè½½å‡è¡¡


å½“æœ‰å¤šä¸ªä»Žåº“æ—¶ï¼Œéœ€è¦åœ¨å®ƒä»¬ä¹‹é—´åˆ†é…è¯»æ“ä½œè´Ÿè½½ã€‚

**è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š**

| ç­–ç•¥ç±»åž‹ | è¯´æ˜Ž | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|------|------|------|
| **è½®è¯¢** | æŒ‰é¡ºåºåˆ†é…åˆ°å„ä»Žåº“ | åˆ†é…å‡åŒ€ | ä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½å·®å¼‚ |
| **éšæœº** | éšæœºé€‰æ‹©ä»Žåº“ | å®žçŽ°ç®€å• | çŸ­æœŸå†…å¯èƒ½ä¸å‡åŒ€ |
| **åŠ æƒ** | æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…æƒé‡ | å……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æº | é…ç½®å¤æ‚ |
| **æœ€å°‘è¿žæŽ¥** | é€‰æ‹©å½“å‰è¿žæŽ¥æ•°æœ€å°‘çš„ä»Žåº“ | åŠ¨æ€å¹³è¡¡è´Ÿè½½ | éœ€è¦å®žæ—¶ç›‘æŽ§è¿žæŽ¥çŠ¶æ€ |

### 3.4 è¯»ä¸€è‡´æ€§å¤„ç†


è¯»å†™åˆ†ç¦»ä¼šå¸¦æ¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå› ä¸ºä¸»ä»Žå¤åˆ¶æœ‰å»¶è¿Ÿã€‚

**å¸¸è§è§£å†³æ–¹æ¡ˆï¼š**

> âš ï¸ **ä¸»ä»Žå»¶è¿Ÿé—®é¢˜**
> 
> åˆšåœ¨ä¸»åº“å†™å…¥çš„æ•°æ®ï¼Œå¯èƒ½è¿˜æ²¡å¤åˆ¶åˆ°ä»Žåº“ï¼Œç«‹å³ä»Žä»Žåº“è¯»å–ä¼šè¯»ä¸åˆ°æœ€æ–°æ•°æ®ã€‚

**è§£å†³ç­–ç•¥ï¼š**
```sql
-- ç­–ç•¥1ï¼šå¼ºåˆ¶è¯»ä¸»åº“ï¼ˆç‰¹æ®Šæ ‡è®°ï¼‰
SELECT /*+ HINT_ROUTE_TO_MASTER */ * FROM users WHERE id = 1001;

-- ç­–ç•¥2ï¼šå»¶è¿Ÿè¯»å–ï¼ˆç­‰å¾…å¤åˆ¶å®Œæˆï¼‰  
-- å†™å…¥åŽç­‰å¾…100mså†è¯»å–

-- ç­–ç•¥3ï¼šä¼šè¯ç²˜æ€§ï¼ˆåŒä¸€ä¼šè¯è¯»å†™éƒ½åœ¨ä¸»åº“ï¼‰
-- åŒä¸€ç”¨æˆ·è¿žæŽ¥åœ¨ä¸€æ®µæ—¶é—´å†…éƒ½è·¯ç”±åˆ°ä¸»åº“
```

---

## 4. âœï¸ æŸ¥è¯¢é‡å†™è§„åˆ™


### 4.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢é‡å†™


æŸ¥è¯¢é‡å†™å°±æ˜¯åœ¨SQLè¯­å¥æ‰§è¡Œå‰ï¼Œè‡ªåŠ¨ä¿®æ”¹SQLè¯­å¥çš„å†…å®¹ï¼Œè®©å®ƒå˜æˆå¦ä¸€ç§å½¢å¼ï¼Œä½†è¾¾åˆ°ç›¸åŒæˆ–æ›´å¥½çš„æ•ˆæžœã€‚

**é‡å†™çš„ç›®çš„ï¼š**
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¹å†™ä¸ºæ›´é«˜æ•ˆçš„SQL
- **å®‰å…¨å¢žå¼º**ï¼šæ·»åŠ æƒé™æ£€æŸ¥æ¡ä»¶
- **å…¼å®¹æ€§å¤„ç†**ï¼šè½¬æ¢ä¸åŒæ•°æ®åº“è¯­æ³•
- **ä¸šåŠ¡é€»è¾‘**ï¼šè‡ªåŠ¨æ·»åŠ ä¸šåŠ¡ç›¸å…³æ¡ä»¶

### 4.2 å¸¸è§é‡å†™åœºæ™¯


**åœºæ™¯1ï¼šæ·»åŠ å®‰å…¨æ¡ä»¶**
```sql
-- åŽŸå§‹æŸ¥è¯¢
SELECT * FROM orders;

-- é‡å†™åŽï¼ˆè‡ªåŠ¨æ·»åŠ ç”¨æˆ·æƒé™é™åˆ¶ï¼‰
SELECT * FROM orders WHERE user_id = 1001;
```

**åœºæ™¯2ï¼šæ€§èƒ½ä¼˜åŒ–**
```sql
-- åŽŸå§‹æŸ¥è¯¢ï¼ˆå¯èƒ½æ€§èƒ½è¾ƒå·®ï¼‰
SELECT * FROM users WHERE name LIKE '%å¼ %';

-- é‡å†™åŽï¼ˆä½¿ç”¨æ›´é«˜æ•ˆçš„æŸ¥è¯¢ï¼‰
SELECT * FROM users WHERE name >= 'å¼ ' AND name < 'å¼ z';
```

**åœºæ™¯3ï¼šè¡¨åæ›¿æ¢**
```sql
-- åŽŸå§‹æŸ¥è¯¢
SELECT * FROM user_data;

-- é‡å†™åŽï¼ˆè·¯ç”±åˆ°åˆ†ç‰‡è¡¨ï¼‰
SELECT * FROM user_data_2024_01;
```

### 4.3 é‡å†™è§„åˆ™é…ç½®


**åŸºäºŽæ­£åˆ™è¡¨è¾¾å¼çš„é‡å†™ï¼š**
```sql
-- é‡å†™è§„åˆ™é…ç½®ç¤ºä¾‹
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, replace_pattern, apply) 
VALUES 
(10, 
 '^SELECT \* FROM orders$',           -- åŒ¹é…æ¨¡å¼
 'SELECT * FROM orders WHERE user_id = ?', -- é‡å†™æ¨¡å¼  
 1);                                  -- å¯ç”¨è§„åˆ™
```

**é‡å†™è§„åˆ™ä¼˜å…ˆçº§ï¼š**
```
è§„åˆ™ä¼˜å…ˆçº§ï¼šrule_idè¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜
æ‰§è¡Œé¡ºåºï¼šå…ˆåŒ¹é…é«˜ä¼˜å…ˆçº§è§„åˆ™ï¼ŒåŒ¹é…æˆåŠŸåˆ™åº”ç”¨é‡å†™
è§„åˆ™é“¾ï¼šä¸€ä¸ªSQLå¯èƒ½è¢«å¤šä¸ªè§„åˆ™ä¾æ¬¡é‡å†™
```

---

## 5. ðŸ”§ è·¯ç”±è§„åˆ™é…ç½®


### 5.1 mysql_query_rulesè¡¨è¯¦è§£


è¿™æ˜¯ProxySQLä¸­æœ€é‡è¦çš„é…ç½®è¡¨ï¼Œç”¨äºŽå®šä¹‰æ‰€æœ‰çš„è·¯ç”±å’Œé‡å†™è§„åˆ™ã€‚

**è¡¨ç»“æž„è¯´æ˜Žï¼š**
```sql
CREATE TABLE mysql_query_rules (
    rule_id INTEGER PRIMARY KEY,           -- è§„åˆ™IDï¼ˆä¼˜å…ˆçº§ï¼‰
    active INTEGER CHECK (active IN (0,1)), -- æ˜¯å¦å¯ç”¨
    username VARCHAR,                      -- é€‚ç”¨ç”¨æˆ·
    schemaname VARCHAR,                    -- é€‚ç”¨æ•°æ®åº“  
    flagIN INTEGER,                        -- è¾“å…¥æ ‡å¿—
    client_addr VARCHAR,                   -- å®¢æˆ·ç«¯åœ°å€
    proxy_addr VARCHAR,                    -- ä»£ç†åœ°å€
    proxy_port INTEGER,                    -- ä»£ç†ç«¯å£
    digest VARCHAR,                        -- SQLæ‘˜è¦
    match_digest VARCHAR,                  -- åŒ¹é…æ‘˜è¦
    match_pattern VARCHAR,                 -- åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
    negate_match_pattern INTEGER,          -- æ˜¯å¦å–ååŒ¹é…
    re_modifiers VARCHAR,                  -- æ­£åˆ™ä¿®é¥°ç¬¦
    flagOUT INTEGER,                       -- è¾“å‡ºæ ‡å¿—  
    replace_pattern VARCHAR,               -- æ›¿æ¢æ¨¡å¼
    destination_hostgroup INTEGER,         -- ç›®æ ‡ä¸»æœºç»„
    cache_ttl INTEGER,                     -- ç¼“å­˜TTL
    cache_empty_result INTEGER,            -- æ˜¯å¦ç¼“å­˜ç©ºç»“æžœ
    cache_timeout INTEGER,                 -- ç¼“å­˜è¶…æ—¶
    reconnect INTEGER,                     -- é‡è¿žæ ‡å¿—
    timeout INTEGER,                       -- è¶…æ—¶æ—¶é—´
    retries INTEGER,                       -- é‡è¯•æ¬¡æ•°
    delay INTEGER,                         -- å»¶è¿Ÿæ—¶é—´
    next_query_flagIN INTEGER,             -- ä¸‹ä¸ªæŸ¥è¯¢è¾“å…¥æ ‡å¿—
    mirror_flagOUT INTEGER,                -- é•œåƒè¾“å‡ºæ ‡å¿—
    mirror_hostgroup INTEGER,              -- é•œåƒä¸»æœºç»„
    error_msg VARCHAR,                     -- é”™è¯¯æ¶ˆæ¯
    OK_msg VARCHAR,                        -- æˆåŠŸæ¶ˆæ¯
    sticky_conn INTEGER,                   -- ç²˜æ€§è¿žæŽ¥
    multiplex INTEGER,                     -- è¿žæŽ¥å¤ç”¨
    gtid_from_hostgroup INTEGER,           -- GTIDæ¥æºä¸»æœºç»„
    log INTEGER,                           -- æ˜¯å¦è®°å½•æ—¥å¿—
    apply INTEGER,                         -- æ˜¯å¦åº”ç”¨è§„åˆ™
    comment VARCHAR                        -- æ³¨é‡Šè¯´æ˜Ž
);
```

### 5.2 åŸºç¡€è·¯ç”±é…ç½®ç¤ºä¾‹


**ç¤ºä¾‹1ï¼šç®€å•è¯»å†™åˆ†ç¦»**
```sql
-- è¯»æ“ä½œè·¯ç”±åˆ°ä»Žåº“ç»„(hostgroup 1)
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup, apply, comment) 
VALUES 
(1, '^SELECT.*', 1, 1, 'è¯»æ“ä½œè·¯ç”±åˆ°ä»Žåº“');

-- å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“ç»„(hostgroup 0)  
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup, apply, comment)
VALUES 
(2, '^(INSERT|UPDATE|DELETE).*', 0, 1, 'å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“');
```

**ç¤ºä¾‹2ï¼šåŸºäºŽç”¨æˆ·çš„è·¯ç”±**
```sql
-- æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®ä»Žåº“
INSERT INTO mysql_query_rules 
(rule_id, username, destination_hostgroup, apply, comment)
VALUES 
(10, 'readonly_user', 1, 1, 'åªè¯»ç”¨æˆ·è·¯ç”±åˆ°ä»Žåº“');

-- ç®¡ç†å‘˜ç”¨æˆ·å¯ä»¥è®¿é—®ä¸»åº“
INSERT INTO mysql_query_rules 
(rule_id, username, destination_hostgroup, apply, comment) 
VALUES 
(11, 'admin_user', 0, 1, 'ç®¡ç†å‘˜ç”¨æˆ·è·¯ç”±åˆ°ä¸»åº“');
```

### 5.3 æ¡ä»¶è·¯ç”±é…ç½®


**åŸºäºŽæ•°æ®åº“çš„è·¯ç”±ï¼š**
```sql
-- æŠ¥è¡¨åº“æŸ¥è¯¢è·¯ç”±åˆ°ä¸“é—¨çš„æŠ¥è¡¨æœåŠ¡å™¨
INSERT INTO mysql_query_rules 
(rule_id, schemaname, destination_hostgroup, apply, comment)
VALUES 
(20, 'report_db', 2, 1, 'æŠ¥è¡¨åº“è·¯ç”±åˆ°æŠ¥è¡¨æœåŠ¡å™¨');
```

**åŸºäºŽæ—¶é—´çš„è·¯ç”±ï¼š**
```sql
-- å¤œé—´æ‰¹å¤„ç†ä½œä¸šè·¯ç”±åˆ°å¤‡ç”¨æœåŠ¡å™¨
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup, apply, comment)
VALUES 
(30, '^SELECT.*batch_process.*', 3, 1, 'æ‰¹å¤„ç†ä½œä¸šè·¯ç”±');
```

---

## 6. ðŸ” æŸ¥è¯¢åˆ†æžå™¨è¯¦è§£


### 6.1 Query Processorå·¥ä½œåŽŸç†


æŸ¥è¯¢åˆ†æžå™¨æ˜¯ä»£ç†ä¸­é—´ä»¶çš„"å¤§è„‘"ï¼Œè´Ÿè´£ç†è§£å’Œå¤„ç†æ¯ä¸€ä¸ªSQLè¯­å¥ã€‚

**å¤„ç†æµç¨‹ï¼š**
```
SQLè¯­å¥è¾“å…¥
     â†“
1. è¯æ³•åˆ†æžï¼ˆåˆ†è§£SQLå…³é”®å­—ï¼‰
     â†“  
2. è¯­æ³•åˆ†æžï¼ˆç†è§£SQLç»“æž„ï¼‰
     â†“
3. è§„åˆ™åŒ¹é…ï¼ˆæŸ¥æ‰¾é€‚ç”¨çš„è·¯ç”±è§„åˆ™ï¼‰
     â†“
4. æ¡ä»¶è¯„ä¼°ï¼ˆæ£€æŸ¥è§„åˆ™æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼‰
     â†“
5. åŠ¨ä½œæ‰§è¡Œï¼ˆè·¯ç”±ã€é‡å†™ã€ç¼“å­˜ç­‰ï¼‰
     â†“
ç›®æ ‡æœåŠ¡å™¨
```

### 6.2 SQLè§£æžä¸Žåˆ†ç±»


**è¯­å¥ç±»åž‹è¯†åˆ«ï¼š**
```sql
-- æŸ¥è¯¢ç±»åž‹æ£€æµ‹
SELECT statement_type, count(*) 
FROM stats_mysql_query_digest 
GROUP BY statement_type;

/*
ç»“æžœç¤ºä¾‹ï¼š
+----------------+-------+
| statement_type | count |
+----------------+-------+
| SELECT         | 1500  |
| INSERT         | 300   |  
| UPDATE         | 200   |
| DELETE         | 50    |
+----------------+-------+
*/
```

### 6.3 æŸ¥è¯¢æ‘˜è¦ä¸Žç»Ÿè®¡


**SQLæ‘˜è¦ï¼ˆDigestï¼‰**æ˜¯å¯¹SQLè¯­å¥çš„æ ‡å‡†åŒ–è¡¨ç¤ºï¼Œç”¨äºŽç»Ÿè®¡å’Œåˆ†æžã€‚

```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ‘˜è¦ç»Ÿè®¡
SELECT 
    digest_text,                    -- SQLæ¨¡æ¿
    count_star,                     -- æ‰§è¡Œæ¬¡æ•°
    sum_time/1000 as avg_time_ms,   -- å¹³å‡æ‰§è¡Œæ—¶é—´
    hostgroup                       -- æ‰§è¡Œçš„ä¸»æœºç»„
FROM stats_mysql_query_digest 
ORDER BY count_star DESC 
LIMIT 10;
```

**æ‘˜è¦çš„ä½œç”¨ï¼š**
- **æ€§èƒ½åˆ†æž**ï¼šæ‰¾å‡ºæ‰§è¡Œé¢‘çŽ‡æœ€é«˜çš„SQL
- **ç¼“å­˜ä¼˜åŒ–**ï¼šä¸ºçƒ­ç‚¹æŸ¥è¯¢é…ç½®ç¼“å­˜
- **è·¯ç”±ä¼˜åŒ–**ï¼šä¸ºç‰¹å®šæŸ¥è¯¢é…ç½®ä¸“é—¨è·¯ç”±

---

## 7. ðŸŽ¯ é«˜çº§è·¯ç”±ç­–ç•¥


### 7.1 è‡ªå®šä¹‰è·¯ç”±å‡½æ•°


å¯¹äºŽå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥ç¼–å†™è‡ªå®šä¹‰å‡½æ•°æ¥å†³å®šè·¯ç”±ç­–ç•¥ã€‚

**è·¯ç”±å‡½æ•°ç¤ºä¾‹ï¼š**
```lua
-- Luaè„šæœ¬ç¤ºä¾‹ï¼šåŸºäºŽæ—¶é—´çš„åŠ¨æ€è·¯ç”±
function route_by_time(hour)
    if hour >= 2 and hour <= 6 then
        return 2  -- å¤œé—´ç»´æŠ¤æ—¶æ®µï¼Œè·¯ç”±åˆ°å¤‡ç”¨æœåŠ¡å™¨
    elseif hour >= 9 and hour <= 18 then  
        return 1  -- å·¥ä½œæ—¶é—´ï¼Œè·¯ç”±åˆ°é«˜æ€§èƒ½æœåŠ¡å™¨
    else
        return 0  -- å…¶ä»–æ—¶é—´ï¼Œè·¯ç”±åˆ°æ™®é€šæœåŠ¡å™¨
    end
end
```

### 7.2 æ•…éšœè½¬ç§»è·¯ç”±


å½“ä¸»è¦æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨ã€‚

**æ•…éšœæ£€æµ‹æœºåˆ¶ï¼š**
```
å¥åº·æ£€æŸ¥ â†’ è¿žæŽ¥å¤±è´¥è®¡æ•° â†’ è¾¾åˆ°é˜ˆå€¼ â†’ æ ‡è®°ä¸ºä¸‹çº¿ â†’ è·¯ç”±åˆ‡æ¢
```

**æ•…éšœè½¬ç§»é…ç½®ï¼š**
```sql
-- é…ç½®å¥åº·æ£€æŸ¥
INSERT INTO mysql_servers 
(hostgroup_id, hostname, port, weight, status, max_connections) 
VALUES 
(0, '192.168.1.10', 3306, 1000, 'ONLINE', 1000),   -- ä¸»æœåŠ¡å™¨
(0, '192.168.1.11', 3306, 900,  'ONLINE', 1000);   -- å¤‡ç”¨æœåŠ¡å™¨

-- æ•…éšœæ£€æµ‹å‚æ•°
SET mysql-monitor_connect_interval = 2000;    -- 2ç§’æ£€æŸ¥ä¸€æ¬¡
SET mysql-monitor_connect_timeout = 1000;     -- 1ç§’è¿žæŽ¥è¶…æ—¶
SET mysql-max_connections = 2048;             -- æœ€å¤§è¿žæŽ¥æ•°
```

### 7.3 A/Bæµ‹è¯•è·¯ç”±


åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­å®‰å…¨åœ°æµ‹è¯•æ–°åŠŸèƒ½æˆ–æ–°çš„æ•°æ®åº“é…ç½®ã€‚

**A/Bæµ‹è¯•é…ç½®ï¼š**
```sql
-- 10%çš„æµé‡è·¯ç”±åˆ°æµ‹è¯•çŽ¯å¢ƒ
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup, apply, comment)
VALUES 
(100, '^SELECT.*', 
      CASE WHEN RAND() < 0.1 THEN 3 ELSE 1 END, 
      1, 'A/Bæµ‹è¯•ï¼š10%æµé‡åˆ°æµ‹è¯•çŽ¯å¢ƒ');
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ æŸ¥è¯¢è·¯ç”±ï¼šæ™ºèƒ½åˆ†å‘SQLåˆ°åˆé€‚çš„æ•°æ®åº“æœåŠ¡å™¨
ðŸ”¸ è¯»å†™åˆ†ç¦»ï¼šè¯»æ“ä½œåˆ°ä»Žåº“ï¼Œå†™æ“ä½œåˆ°ä¸»åº“  
ðŸ”¸ æŸ¥è¯¢é‡å†™ï¼šè‡ªåŠ¨ä¿®æ”¹SQLä»¥è¾¾åˆ°ä¼˜åŒ–æˆ–å®‰å…¨ç›®çš„
ðŸ”¸ è§„åˆ™ä¼˜å…ˆçº§ï¼šrule_idè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
ðŸ”¸ mysql_query_rulesè¡¨ï¼šè·¯ç”±è§„åˆ™çš„æ ¸å¿ƒé…ç½®è¡¨
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ è·¯ç”±å†³ç­–æµç¨‹**
```
æŽ¥æ”¶SQL â†’ è§£æžè¯­å¥ â†’ åŒ¹é…è§„åˆ™ â†’ è¯„ä¼°æ¡ä»¶ â†’ é€‰æ‹©ç›®æ ‡ â†’ è½¬å‘æ‰§è¡Œ
```

**ðŸ”¹ è§„åˆ™åŒ¹é…æœºåˆ¶**  
```
æŒ‰rule_idä»Žå°åˆ°å¤§æ£€æŸ¥è§„åˆ™
æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè§„åˆ™ç”Ÿæ•ˆ
apply=1çš„è§„åˆ™æ‰ä¼šå®žé™…æ‰§è¡Œ
```

**ðŸ”¹ è¯»å†™åˆ†ç¦»æ³¨æ„äº‹é¡¹**
```
ä¸»ä»Žå»¶è¿Ÿï¼šå†™åŽç«‹å³è¯»å¯èƒ½è¯»ä¸åˆ°æœ€æ–°æ•°æ®
ä¼šè¯ç²˜æ€§ï¼šæŸäº›åœºæ™¯éœ€è¦è¯»å†™éƒ½åœ¨åŒä¸€æœåŠ¡å™¨
ä¸€è‡´æ€§è¦æ±‚ï¼šå…³é”®ä¸šåŠ¡å¯èƒ½éœ€è¦å¼ºåˆ¶è¯»ä¸»åº“
```

### 8.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸŽ¯ æ€§èƒ½æå‡**
- è¯»å†™åˆ†ç¦»å‡è½»ä¸»åº“åŽ‹åŠ›
- è´Ÿè½½å‡è¡¡æé«˜æ•´ä½“åžåé‡
- æŸ¥è¯¢ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—

**ðŸ”’ å®‰å…¨å¢žå¼º**  
- ç”¨æˆ·æƒé™éš”ç¦»
- SQLæ³¨å…¥é˜²æŠ¤
- æ•æ„Ÿæ•°æ®è®¿é—®æŽ§åˆ¶

**ðŸš€ è¿ç»´ä¾¿åˆ©**
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- åœ¨çº¿é…ç½®å˜æ›´
- è¯¦ç»†çš„ç›‘æŽ§ç»Ÿè®¡

### 8.4 æœ€ä½³å®žè·µå»ºè®®


**ðŸ”§ é…ç½®åŽŸåˆ™**
```
è§„åˆ™ç®€å•æ˜Žç¡®ï¼šé¿å…è¿‡äºŽå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼
ä¼˜å…ˆçº§åˆç†ï¼šé‡è¦è§„åˆ™è®¾ç½®è¾ƒå°çš„rule_id
æµ‹è¯•å……åˆ†ï¼šæ–°è§„åˆ™å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
ç›‘æŽ§å®Œå–„ï¼šå…³æ³¨è·¯ç”±æ•ˆæžœå’Œæ€§èƒ½æŒ‡æ ‡
```

**âš ï¸ å¸¸è§é™·é˜±**
```
è§„åˆ™å†²çªï¼šå¤šä¸ªè§„åˆ™åŒ¹é…åŒä¸€SQLæ—¶çš„å¤„ç†
ç¼“å­˜ä¸€è‡´æ€§ï¼šç¼“å­˜çš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„
è¿žæŽ¥æ± ç®¡ç†ï¼šé¿å…è¿žæŽ¥æ•°è¿‡å¤šå¯¼è‡´çš„æ€§èƒ½é—®é¢˜
ç›‘æŽ§ç›²åŒºï¼šç¡®ä¿æ‰€æœ‰è·¯ç”±è·¯å¾„éƒ½æœ‰ç›‘æŽ§è¦†ç›–
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æŸ¥è¯¢è·¯ç”±æ˜¯æ•°æ®åº“ä»£ç†çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡æ™ºèƒ½åˆ†å‘æé«˜æ€§èƒ½
- è¯»å†™åˆ†ç¦»æ˜¯æœ€åŸºç¡€çš„è·¯ç”±ç­–ç•¥ï¼Œä½†è¦æ³¨æ„æ•°æ®ä¸€è‡´æ€§é—®é¢˜  
- mysql_query_rulesè¡¨æ˜¯é…ç½®çš„æ ¸å¿ƒï¼Œè§„åˆ™ä¼˜å…ˆçº§å†³å®šåŒ¹é…é¡ºåº
- æŸ¥è¯¢é‡å†™å¯ä»¥å®žçŽ°æ€§èƒ½ä¼˜åŒ–å’Œå®‰å…¨å¢žå¼º
- ç›‘æŽ§å’Œæµ‹è¯•æ˜¯ç¡®ä¿è·¯ç”±ç­–ç•¥æœ‰æ•ˆæ€§çš„å…³é”®æ‰‹æ®µ