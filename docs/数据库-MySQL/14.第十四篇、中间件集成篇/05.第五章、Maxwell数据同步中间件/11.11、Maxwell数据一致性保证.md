---
title: 11ã€Maxwellæ•°æ®ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [Maxwellä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ](#1-Maxwellä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ)
2. [äº‹åŠ¡å®Œæ•´æ€§ä¿è¯æœºåˆ¶](#2-äº‹åŠ¡å®Œæ•´æ€§ä¿è¯æœºåˆ¶)
3. [é¡ºåºä¸€è‡´æ€§ç»´æŠ¤ç­–ç•¥](#3-é¡ºåºä¸€è‡´æ€§ç»´æŠ¤ç­–ç•¥)
4. [é‡å¤æ•°æ®å¤„ç†æ–¹æ¡ˆ](#4-é‡å¤æ•°æ®å¤„ç†æ–¹æ¡ˆ)
5. [æ•°æ®æ ¡éªŒä¸ç›‘æ§ä½“ç³»](#5-æ•°æ®æ ¡éªŒä¸ç›‘æ§ä½“ç³»)
6. [ä¸€è‡´æ€§ä¿®å¤ç­–ç•¥](#6-ä¸€è‡´æ€§ä¿®å¤ç­–ç•¥)
7. [ä¸€è‡´æ€§æµ‹è¯•æ–¹æ³•](#7-ä¸€è‡´æ€§æµ‹è¯•æ–¹æ³•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Maxwellä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸€è‡´æ€§


**ğŸ”¸ ä¸€è‡´æ€§çš„é€šä¿—ç†è§£**
æ•°æ®ä¸€è‡´æ€§å°±åƒæ˜¯"ä¿è¯æ•°æ®çš„çœŸå®å¯é "ã€‚æƒ³è±¡ä½ åœ¨é“¶è¡Œè½¬è´¦ï¼Œä»Aè´¦æˆ·è½¬100å…ƒåˆ°Bè´¦æˆ·ï¼Œé‚£ä¹ˆAè´¦æˆ·å¿…é¡»å‡å°‘100å…ƒï¼ŒBè´¦æˆ·å¿…é¡»å¢åŠ 100å…ƒï¼Œä¸èƒ½å‡ºç°é’±å‡­ç©ºæ¶ˆå¤±æˆ–è€…å‡­ç©ºå¢åŠ çš„æƒ…å†µã€‚

```
ç®€å•ç†è§£ï¼š
åŸå§‹æ•°æ®: Aè´¦æˆ·=1000å…ƒ, Bè´¦æˆ·=500å…ƒ
è½¬è´¦æ“ä½œ: Aè½¬ç»™B 100å…ƒ
ç»“æœæ•°æ®: Aè´¦æˆ·=900å…ƒ, Bè´¦æˆ·=600å…ƒ

ä¸€è‡´æ€§è¦æ±‚ï¼š
âœ… æ“ä½œå‰åæ€»é‡‘é¢ä¸å˜ (1500å…ƒ)
âœ… ä¸¤ä¸ªè´¦æˆ·å˜åŒ–å¿…é¡»åŒæ—¶ç”Ÿæ•ˆ
âœ… ä¸èƒ½å‡ºç°ä¸­é—´çŠ¶æ€è¢«å…¶ä»–äººçœ‹åˆ°
```

### 1.2 Maxwellé¢ä¸´çš„ä¸€è‡´æ€§æŒ‘æˆ˜


**ğŸ”¸ Maxwellå·¥ä½œåŸç†å›é¡¾**
Maxwellæ˜¯ä¸€ä¸ªè¯»å–MySQL binlogå¹¶å°†å˜æ›´æ•°æ®å®æ—¶åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿçš„ä¸­é—´ä»¶ã€‚

```
MySQLæ•°æ®åº“ â†’ binlogæ—¥å¿— â†’ Maxwellè§£æ â†’ ç›®æ ‡ç³»ç»Ÿ(ES/Kafkaç­‰)
    |             |           |              |
  åŸå§‹æ•°æ®      å˜æ›´è®°å½•    æ•°æ®è½¬æ¢        æœ€ç»ˆæ•°æ®
```

**ğŸ’¡ é¢ä¸´çš„ä¸»è¦æŒ‘æˆ˜**

```
ğŸ”¸ ç½‘ç»œä¼ è¾“é—®é¢˜
- æ•°æ®åŒ…ä¸¢å¤±ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±
- ä¼ è¾“å»¶è¿Ÿï¼šæ•°æ®åˆ°è¾¾ç›®æ ‡ç³»ç»Ÿæœ‰æ—¶é—´å·®
- é‡å¤å‘é€ï¼šç½‘ç»œé‡è¯•æœºåˆ¶å¯èƒ½å¯¼è‡´æ•°æ®é‡å¤

ğŸ”¸ ç³»ç»Ÿæ•…éšœé—®é¢˜  
- Maxwellé‡å¯ï¼šå¯èƒ½å¯¼è‡´æ•°æ®é—æ¼æˆ–é‡å¤
- ç›®æ ‡ç³»ç»Ÿæ•…éšœï¼šæ•°æ®ç§¯å‹æˆ–ä¸¢å¤±
- MySQLä¸»ä»åˆ‡æ¢ï¼šbinlogä½ç½®å¯èƒ½ä¸ä¸€è‡´

ğŸ”¸ å¹¶å‘å¤„ç†é—®é¢˜
- å¤šçº¿ç¨‹å¤„ç†ï¼šå¯èƒ½å¯¼è‡´æ•°æ®é¡ºåºé”™ä¹±
- äº‹åŠ¡è¾¹ç•Œï¼šè·¨å¤šæ¡SQLçš„äº‹åŠ¡å®Œæ•´æ€§
- å¤§äº‹åŠ¡å¤„ç†ï¼šè¶…å¤§äº‹åŠ¡å¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º
```

### 1.3 ä¸€è‡´æ€§ç±»å‹è¯¦è§£


**ğŸ”¹ å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§**

| ä¸€è‡´æ€§ç±»å‹ | **ç‰¹ç‚¹** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|---------|-------------|
| **å¼ºä¸€è‡´æ€§** | `æ•°æ®å®æ—¶åŒæ­¥ï¼Œç«‹å³å¯è§` | `æ•°æ®ç»å¯¹å‡†ç¡®` | `æ€§èƒ½å¼€é”€å¤§ï¼Œå¯ç”¨æ€§ä½` | `é‡‘èäº¤æ˜“ï¼Œåº“å­˜ç®¡ç†` |
| **æœ€ç»ˆä¸€è‡´æ€§** | `å…è®¸çŸ­æ—¶é—´ä¸ä¸€è‡´ï¼Œæœ€ç»ˆè¶‹äºä¸€è‡´` | `æ€§èƒ½å¥½ï¼Œå¯ç”¨æ€§é«˜` | `å­˜åœ¨æ•°æ®å»¶è¿Ÿ` | `ç”¨æˆ·ç”»åƒï¼Œæ¨èç³»ç»Ÿ` |

**ğŸ’¡ å®é™…ä¾‹å­è¯´æ˜**

```
å¼ºä¸€è‡´æ€§åœºæ™¯ - é“¶è¡Œè½¬è´¦ï¼š
ç”¨æˆ·Aè½¬è´¦ç»™ç”¨æˆ·Bï¼Œå¿…é¡»ä¿è¯ï¼š
- Aè´¦æˆ·æ‰£æ¬¾å’ŒBè´¦æˆ·å…¥è´¦åŒæ—¶å®Œæˆ
- ä»»ä½•æ—¶åˆ»æŸ¥è¯¢éƒ½èƒ½çœ‹åˆ°æ­£ç¡®ä½™é¢
- ä¸å…è®¸å‡ºç°ä¸­é—´çŠ¶æ€

æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ - ç”¨æˆ·å¤´åƒæ›´æ–°ï¼š
ç”¨æˆ·æ›´æ¢å¤´åƒåï¼š
- ä¸ªäººèµ„æ–™é¡µé¢ç«‹å³æ›´æ–° âœ“
- è¯„è®ºåŒºå¤´åƒå¯èƒ½å»¶è¿Ÿå‡ ç§’æ›´æ–° âœ“
- çŸ­æš‚ä¸ä¸€è‡´æ˜¯å¯ä»¥æ¥å—çš„
```

---

## 2. ğŸ”’ äº‹åŠ¡å®Œæ•´æ€§ä¿è¯æœºåˆ¶


### 2.1 MySQLäº‹åŠ¡ä¸binlogå…³ç³»


**ğŸ”¸ äº‹åŠ¡åŸºç¡€æ¦‚å¿µ**
äº‹åŠ¡å°±æ˜¯"ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥"ã€‚å°±åƒç½‘è´­ä¸‹å•ï¼Œæ‰£åº“å­˜ã€æ‰£ä½™é¢ã€ç”Ÿæˆè®¢å•å¿…é¡»å…¨éƒ¨æˆåŠŸï¼Œå¦åˆ™å…¨éƒ¨æ’¤é”€ã€‚

```sql
-- ç¤ºä¾‹ï¼šç”¨æˆ·è´­ä¹°å•†å“çš„äº‹åŠ¡
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;     -- æ‰£æ¬¾
UPDATE products SET stock = stock - 1 WHERE id = 101;     -- æ‰£åº“å­˜  
INSERT INTO orders (user_id, product_id, amount) VALUES (1, 101, 100); -- ç”Ÿæˆè®¢å•
COMMIT;
```

**ğŸ”¸ binlogè®°å½•äº‹åŠ¡çš„æ–¹å¼**

```
binlogä¸­çš„äº‹åŠ¡è®°å½•æ ¼å¼ï¼š
BEGIN          -- äº‹åŠ¡å¼€å§‹æ ‡è®°
update users...   -- ç¬¬ä¸€æ¡SQLå˜æ›´
update products... -- ç¬¬äºŒæ¡SQLå˜æ›´  
insert orders...  -- ç¬¬ä¸‰æ¡SQLå˜æ›´
COMMIT         -- äº‹åŠ¡æäº¤æ ‡è®°
```

### 2.2 Maxwelläº‹åŠ¡å¤„ç†æœºåˆ¶


**ğŸ”¹ äº‹åŠ¡è¾¹ç•Œè¯†åˆ«**

Maxwellé€šè¿‡è¯†åˆ«binlogä¸­çš„`BEGIN`å’Œ`COMMIT`æ ‡è®°æ¥ç¡®å®šäº‹åŠ¡è¾¹ç•Œï¼š

```java
// Maxwelläº‹åŠ¡å¤„ç†æ ¸å¿ƒé…ç½®
{
  "transaction_mode": "enabled",           // å¯ç”¨äº‹åŠ¡æ¨¡å¼
  "output_transaction_boundary": true,     // è¾“å‡ºäº‹åŠ¡è¾¹ç•Œä¿¡æ¯
  "transaction_timeout": 30000            // äº‹åŠ¡è¶…æ—¶æ—¶é—´(æ¯«ç§’)
}
```

**ğŸ”¹ äº‹åŠ¡æ•°æ®è¾“å‡ºæ ¼å¼**

```json
// äº‹åŠ¡å¼€å§‹æ ‡è®°
{
  "database": "test_db",
  "table": null,
  "type": "transaction_begin",
  "transaction_id": "12345",
  "ts": 1699123456
}

// å…·ä½“æ•°æ®å˜æ›´
{
  "database": "test_db", 
  "table": "users",
  "type": "update",
  "transaction_id": "12345",
  "data": {"id": 1, "balance": 900},
  "old": {"id": 1, "balance": 1000}
}

// äº‹åŠ¡æäº¤æ ‡è®°
{
  "database": "test_db",
  "table": null, 
  "type": "transaction_commit",
  "transaction_id": "12345",
  "ts": 1699123460
}
```

### 2.3 äº‹åŠ¡å®Œæ•´æ€§ä¿è¯ç­–ç•¥


**ğŸ”¸ ç­–ç•¥ä¸€ï¼šäº‹åŠ¡çº§åˆ«çš„åŸå­æ€§è¾“å‡º**

```java
// Maxwellé…ç½®ï¼šç¡®ä¿äº‹åŠ¡å®Œæ•´æ€§
public class TransactionHandler {
    
    // äº‹åŠ¡ç¼“å­˜ï¼šæš‚å­˜æœªæäº¤äº‹åŠ¡çš„æ‰€æœ‰å˜æ›´
    private Map<String, List<RowMap>> transactionBuffer = new HashMap<>();
    
    public void handleRowMap(RowMap row) {
        String txId = row.getTransactionId();
        
        if ("transaction_begin".equals(row.getType())) {
            // äº‹åŠ¡å¼€å§‹ï¼Œåˆ›å»ºç¼“å­˜åŒº
            transactionBuffer.put(txId, new ArrayList<>());
            
        } else if ("transaction_commit".equals(row.getType())) {
            // äº‹åŠ¡æäº¤ï¼Œæ‰¹é‡è¾“å‡ºæ‰€æœ‰å˜æ›´
            List<RowMap> txRows = transactionBuffer.get(txId);
            if (txRows != null) {
                outputTransactionBatch(txRows);  // åŸå­æ€§è¾“å‡º
                transactionBuffer.remove(txId);
            }
            
        } else {
            // æ™®é€šæ•°æ®å˜æ›´ï¼ŒåŠ å…¥äº‹åŠ¡ç¼“å­˜
            List<RowMap> txRows = transactionBuffer.get(txId);
            if (txRows != null) {
                txRows.add(row);
            }
        }
    }
}
```

**ğŸ”¸ ç­–ç•¥äºŒï¼šäº‹åŠ¡è¶…æ—¶å¤„ç†**

```java
// å¤„ç†é•¿æ—¶é—´æœªæäº¤çš„äº‹åŠ¡
public class TransactionTimeoutHandler {
    
    public void checkTransactionTimeout() {
        long currentTime = System.currentTimeMillis();
        
        for (String txId : transactionBuffer.keySet()) {
            long txStartTime = getTransactionStartTime(txId);
            
            if (currentTime - txStartTime > TRANSACTION_TIMEOUT) {
                // è¶…æ—¶äº‹åŠ¡å¤„ç†ï¼šè®°å½•æ—¥å¿—å¹¶æ¸…ç†ç¼“å­˜
                logger.warn("Transaction timeout: " + txId);
                transactionBuffer.remove(txId);
                
                // å¯é€‰ï¼šå°†è¶…æ—¶äº‹åŠ¡è®°å½•åˆ°é”™è¯¯æ—¥å¿—ä¸­
                recordTimeoutTransaction(txId);
            }
        }
    }
}
```

---

## 3. ğŸ”„ é¡ºåºä¸€è‡´æ€§ç»´æŠ¤ç­–ç•¥


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦é¡ºåºä¸€è‡´æ€§


**ğŸ”¸ é¡ºåºä¸€è‡´æ€§çš„é‡è¦æ€§**
æƒ³è±¡ä¸€ä¸ªç”¨æˆ·å…ˆå……å€¼100å…ƒï¼Œå†æ¶ˆè´¹50å…ƒã€‚å¦‚æœé¡ºåºé¢ å€’å˜æˆå…ˆæ¶ˆè´¹å†å……å€¼ï¼Œå¯èƒ½å¯¼è‡´ä½™é¢ä¸è¶³çš„é”™è¯¯ã€‚

```
æ­£ç¡®é¡ºåºï¼š
æ—¶é—´1: ä½™é¢=0,   å……å€¼+100  â†’ ä½™é¢=100
æ—¶é—´2: ä½™é¢=100, æ¶ˆè´¹-50   â†’ ä½™é¢=50   âœ“æ­£ç¡®

é”™è¯¯é¡ºåºï¼š
æ—¶é—´1: ä½™é¢=0,   æ¶ˆè´¹-50   â†’ ä½™é¢=-50  âŒé”™è¯¯ï¼
æ—¶é—´2: ä½™é¢=-50, å……å€¼+100  â†’ ä½™é¢=50
```

### 3.2 Maxwellé¡ºåºä¿è¯æœºåˆ¶


**ğŸ”¹ å•çº¿ç¨‹å¤„ç†ä¿è¯é¡ºåº**

```java
// Maxwellé…ç½®ï¼šç¡®ä¿å•çº¿ç¨‹å¤„ç†
{
  "producer": "kafka",
  "kafka_topic": "maxwell",
  "producer_partition_by": "primary_key",  // æŒ‰ä¸»é”®åˆ†åŒº
  "producer_ack_timeout": 0,               // ç­‰å¾…ç¡®è®¤
  "threads": 1                            // å•çº¿ç¨‹å¤„ç†
}
```

**ğŸ”¹ æŒ‰ä¸»é”®åˆ†åŒºç­–ç•¥**

```
ç”¨æˆ·è¡¨å˜æ›´æŒ‰user_idåˆ†åŒºï¼š
user_id=1 çš„æ‰€æœ‰æ“ä½œ â†’ Kafkaåˆ†åŒº0
user_id=2 çš„æ‰€æœ‰æ“ä½œ â†’ Kafkaåˆ†åŒº1  
user_id=3 çš„æ‰€æœ‰æ“ä½œ â†’ Kafkaåˆ†åŒº2

åŒä¸€ç”¨æˆ·çš„æ“ä½œå§‹ç»ˆåœ¨åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåºæ€§
```

### 3.3 é¡ºåºä¸€è‡´æ€§é…ç½®å®è·µ


**ğŸ”¸ Kafkaåˆ†åŒºç­–ç•¥é…ç½®**

```java
// è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼šç¡®ä¿ç›¸å…³æ•°æ®çš„é¡ºåºæ€§
public class OrderedPartitioner implements Partitioner {
    
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        
        // è§£æMaxwellæ¶ˆæ¯
        JSONObject message = JSON.parseObject(new String(valueBytes));
        String database = message.getString("database");
        String table = message.getString("table");
        
        // æŒ‰ä¸šåŠ¡å…³é”®å­—æ®µåˆ†åŒº
        if ("orders".equals(table)) {
            // è®¢å•è¡¨æŒ‰ç”¨æˆ·IDåˆ†åŒº
            Integer userId = message.getJSONObject("data").getInteger("user_id");
            return Math.abs(userId.hashCode()) % cluster.partitionCountForTopic(topic);
            
        } else if ("users".equals(table)) {
            // ç”¨æˆ·è¡¨æŒ‰ç”¨æˆ·IDåˆ†åŒº
            Integer userId = message.getJSONObject("data").getInteger("id");
            return Math.abs(userId.hashCode()) % cluster.partitionCountForTopic(topic);
        }
        
        // é»˜è®¤åˆ†åŒºç­–ç•¥
        return Math.abs(key.hashCode()) % cluster.partitionCountForTopic(topic);
    }
}
```

**ğŸ”¸ binlogä½ç½®ç®¡ç†**

```java
// ç¡®ä¿Maxwellé‡å¯åä»æ­£ç¡®ä½ç½®ç»§ç»­
public class PositionManager {
    
    // ä¿å­˜å¤„ç†è¿›åº¦åˆ°MySQL
    public void savePosition(BinlogPosition position) {
        String sql = "INSERT INTO maxwell.positions (server_id, binlog_file, binlog_position, heartbeat_at) " +
                    "VALUES (?, ?, ?, NOW()) " +
                    "ON DUPLICATE KEY UPDATE " +
                    "binlog_file=VALUES(binlog_file), " +
                    "binlog_position=VALUES(binlog_position), " +
                    "heartbeat_at=VALUES(heartbeat_at)";
        
        jdbcTemplate.update(sql, serverId, position.getFile(), position.getOffset());
    }
    
    // å¯åŠ¨æ—¶æ¢å¤å¤„ç†è¿›åº¦
    public BinlogPosition loadPosition() {
        String sql = "SELECT binlog_file, binlog_position FROM maxwell.positions WHERE server_id = ?";
        return jdbcTemplate.queryForObject(sql, new Object[]{serverId}, 
            (rs, rowNum) -> new BinlogPosition(rs.getString(1), rs.getLong(2)));
    }
}
```

---

## 4. âš¡ é‡å¤æ•°æ®å¤„ç†æ–¹æ¡ˆ


### 4.1 é‡å¤æ•°æ®äº§ç”ŸåŸå› 


**ğŸ”¸ å¸¸è§é‡å¤åœºæ™¯**
é‡å¤æ•°æ®å°±åƒå¿«é€’é‡å¤æŠ•é€’ï¼Œè™½ç„¶å†…å®¹ç›¸åŒï¼Œä½†ä¼šé€ æˆæ··ä¹±ã€‚

```
é‡å¤æ•°æ®äº§ç”ŸåŸå› ï¼š

ğŸ”¸ ç½‘ç»œé‡è¯•
Maxwellå‘é€æ•°æ®åˆ°Kafkaå¤±è´¥ â†’ è‡ªåŠ¨é‡è¯• â†’ æ•°æ®é‡å¤å‘é€

ğŸ”¸ Maxwellé‡å¯
å¤„ç†åˆ°ä¸€åŠçªç„¶é‡å¯ â†’ ä»ä¸Šæ¬¡ä½ç½®é‡æ–°å¼€å§‹ â†’ éƒ¨åˆ†æ•°æ®é‡å¤å¤„ç†

ğŸ”¸ ä¸‹æ¸¸ç³»ç»Ÿæ•…éšœ
ç›®æ ‡ç³»ç»Ÿæ¥æ”¶å¤±è´¥ â†’ Maxwellé‡å‘ â†’ æ¢å¤åé‡å¤æ¥æ”¶
```

### 4.2 å¹‚ç­‰æ€§ä¿è¯æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**
å¹‚ç­‰æ€§å°±æ˜¯"å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œï¼Œç»“æœéƒ½ä¸€æ ·"ã€‚å°±åƒç”µç¯å¼€å…³ï¼Œä¸ç®¡æŒ‰å¤šå°‘æ¬¡å¼€ï¼Œç¯éƒ½æ˜¯äº®çš„ã€‚

```
å¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š
SET balance = 100     (è®¾ç½®ä½™é¢ä¸º100ï¼Œæ‰§è¡Œå¤šæ¬¡ç»“æœç›¸åŒ)

éå¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š  
UPDATE balance = balance + 10  (æ¯æ¬¡æ‰§è¡Œä½™é¢éƒ½å¢åŠ 10)
```

**ğŸ”¹ Maxwellå¹‚ç­‰æ€§è®¾è®¡**

```json
// Maxwellè¾“å‡ºåŒ…å«å”¯ä¸€æ ‡è¯†
{
  "database": "test_db",
  "table": "users", 
  "type": "update",
  "ts": 1699123456789,        // æ—¶é—´æˆ³
  "position": "mysql-bin.000001:1234",  // binlogä½ç½®
  "thread_id": 12,            // MySQLçº¿ç¨‹ID
  "server_id": 1,             // MySQLæœåŠ¡å™¨ID
  "data": {"id": 1, "name": "å¼ ä¸‰"},
  "old": {"id": 1, "name": "æå››"}
}
```

### 4.3 å»é‡ç­–ç•¥å®ç°


**ğŸ”¸ ç­–ç•¥ä¸€ï¼šåŸºäºbinlogä½ç½®å»é‡**

```java
public class DuplicationDetector {
    
    // ä½¿ç”¨Redisè®°å½•å·²å¤„ç†çš„binlogä½ç½®
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean isDuplicate(RowMap row) {
        // æ„é€ å”¯ä¸€é”®ï¼šserver_id + binlog_file + position
        String key = String.format("maxwell:processed:%d:%s:%d", 
            row.getServerId(), 
            row.getBinlogFile(), 
            row.getBinlogPosition());
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
        if (redisTemplate.hasKey(key)) {
            return true;  // é‡å¤æ•°æ®
        }
        
        // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´é˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        redisTemplate.opsForValue().set(key, "1", Duration.ofHours(24));
        return false;
    }
}
```

**ğŸ”¸ ç­–ç•¥äºŒï¼šåŸºäºä¸šåŠ¡ä¸»é”®å»é‡**

```java
public class BusinessDuplicationHandler {
    
    public void handleUpdate(RowMap row) {
        String table = row.getTable();
        Map<String, Object> data = row.getData();
        
        if ("users".equals(table)) {
            Long userId = (Long) data.get("id");
            Long version = (Long) data.get("version");
            
            // æ„é€ ä¸šåŠ¡çº§åˆ«çš„å”¯ä¸€é”®
            String businessKey = String.format("user:update:%d:%d", userId, version);
            
            if (!redisTemplate.hasKey(businessKey)) {
                // æ‰§è¡Œä¸šåŠ¡å¤„ç†
                processUserUpdate(data);
                
                // æ ‡è®°å·²å¤„ç†
                redisTemplate.opsForValue().set(businessKey, "1", Duration.ofDays(1));
            }
        }
    }
}
```

**ğŸ”¸ ç­–ç•¥ä¸‰ï¼šä¸‹æ¸¸ç³»ç»Ÿå¹‚ç­‰è®¾è®¡**

```java
// ElasticSearchå¹‚ç­‰æ›´æ–°ç¤ºä¾‹
public class ESIdempotentWriter {
    
    public void updateDocument(RowMap row) {
        String index = row.getTable();
        String id = String.valueOf(row.getData().get("id"));
        
        // ä½¿ç”¨ç‰ˆæœ¬å·ç¡®ä¿å¹‚ç­‰æ€§
        Long version = (Long) row.getData().get("version");
        
        UpdateRequest request = new UpdateRequest(index, id)
            .version(version)                    // ç‰ˆæœ¬æ§åˆ¶
            .versionType(VersionType.EXTERNAL)   // å¤–éƒ¨ç‰ˆæœ¬
            .doc(row.getData())
            .upsert(row.getData());             // ä¸å­˜åœ¨åˆ™åˆ›å»º
        
        try {
            client.update(request, RequestOptions.DEFAULT);
        } catch (VersionConflictEngineException e) {
            // ç‰ˆæœ¬å†²çªï¼Œè¯´æ˜æ˜¯é‡å¤æ•°æ®ï¼Œå¿½ç•¥
            logger.info("Duplicate data ignored: " + id);
        }
    }
}
```

---

## 5. ğŸ“Š æ•°æ®æ ¡éªŒä¸ç›‘æ§ä½“ç³»


### 5.1 æ•°æ®æ ¡éªŒæœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ•°æ®æ ¡éªŒ**
æ•°æ®æ ¡éªŒå°±åƒæ˜¯"æ ¸å¯¹è´¦æœ¬"ï¼Œç¡®ä¿åŸå§‹æ•°æ®å’ŒåŒæ­¥åçš„æ•°æ®å®Œå…¨ä¸€è‡´ã€‚

```
æ ¡éªŒç»´åº¦ï¼š
âœ… æ•°æ®å®Œæ•´æ€§ï¼šæ‰€æœ‰åº”è¯¥åŒæ­¥çš„æ•°æ®éƒ½åŒæ­¥äº†
âœ… æ•°æ®å‡†ç¡®æ€§ï¼šåŒæ­¥çš„æ•°æ®å†…å®¹å®Œå…¨æ­£ç¡®  
âœ… æ•°æ®åŠæ—¶æ€§ï¼šæ•°æ®åŒæ­¥å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´å†…
âœ… æ•°æ®é¡ºåºæ€§ï¼šç›¸å…³æ•°æ®çš„æ“ä½œé¡ºåºæ­£ç¡®
```

**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§æ ¡éªŒå®ç°**

```java
public class DataConsistencyChecker {
    
    // å®šæœŸæ ¡éªŒæ•°æ®ä¸€è‡´æ€§
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void checkConsistency() {
        
        // 1. è·å–æœ€è¿‘5åˆ†é’Ÿçš„å˜æ›´æ•°æ®
        List<String> changedTables = getChangedTables();
        
        for (String table : changedTables) {
            checkTableConsistency(table);
        }
    }
    
    private void checkTableConsistency(String table) {
        // 2. å¯¹æ¯”æºæ•°æ®åº“å’Œç›®æ ‡ç³»ç»Ÿçš„æ•°æ®
        String sql = "SELECT id, CONCAT(COALESCE(name,''), COALESCE(email,'')) as checksum " +
                    "FROM " + table + " WHERE updated_at > DATE_SUB(NOW(), INTERVAL 5 MINUTE)";
        
        List<Map<String, Object>> sourceData = sourceJdbcTemplate.queryForList(sql);
        
        for (Map<String, Object> row : sourceData) {
            Long id = (Long) row.get("id");
            String sourceChecksum = (String) row.get("checksum");
            
            // ä»ESè·å–å¯¹åº”æ•°æ®
            String targetChecksum = getTargetChecksum(table, id);
            
            if (!sourceChecksum.equals(targetChecksum)) {
                // å‘ç°ä¸ä¸€è‡´ï¼Œè®°å½•åˆ°ä¿®å¤é˜Ÿåˆ—
                recordInconsistency(table, id, sourceChecksum, targetChecksum);
            }
        }
    }
}
```

### 5.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ”¸ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **å…·ä½“æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** | **ä¸šåŠ¡å½±å“** |
|---------|-------------|-------------|-------------|-------------|
| **å»¶è¿Ÿç›‘æ§** | `æ•°æ®åŒæ­¥å»¶è¿Ÿ` | `< 5ç§’` | `> 30ç§’` | `ç”¨æˆ·çœ‹åˆ°è¿‡æœŸæ•°æ®` |
| **ååé‡ç›‘æ§** | `æ¯ç§’å¤„ç†è®°å½•æ•°` | `> 1000æ¡/ç§’` | `< 100æ¡/ç§’` | `æ•°æ®ç§¯å‹` |
| **é”™è¯¯ç‡ç›‘æ§** | `åŒæ­¥å¤±è´¥ç‡` | `< 0.1%` | `> 1%` | `æ•°æ®ä¸¢å¤±` |
| **ä¸€è‡´æ€§ç›‘æ§** | `æ•°æ®ä¸ä¸€è‡´ç‡` | `< 0.01%` | `> 0.1%` | `ä¸šåŠ¡å†³ç­–é”™è¯¯` |

**ğŸ”¹ ç›‘æ§å®ç°ç¤ºä¾‹**

```java
@Component
public class MaxwellMonitor {
    
    private MeterRegistry meterRegistry;
    
    // å»¶è¿Ÿç›‘æ§
    public void recordSyncDelay(long delayMs) {
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("maxwell.sync.delay")
            .description("MaxwellåŒæ­¥å»¶è¿Ÿ")
            .register(meterRegistry));
    }
    
    // ååé‡ç›‘æ§
    public void recordProcessedCount(int count) {
        Counter.builder("maxwell.processed.count")
            .description("Maxwellå¤„ç†è®°å½•æ•°")
            .register(meterRegistry)
            .increment(count);
    }
    
    // é”™è¯¯ç‡ç›‘æ§
    public void recordError(String errorType) {
        Counter.builder("maxwell.error.count")
            .tag("type", errorType)
            .description("Maxwellé”™è¯¯è®¡æ•°")
            .register(meterRegistry)
            .increment();
    }
}
```

### 5.3 å®æ—¶ç›‘æ§å‘Šè­¦


**ğŸ”¸ å‘Šè­¦è§„åˆ™é…ç½®**

```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: maxwell_alerts
  rules:
  # åŒæ­¥å»¶è¿Ÿå‘Šè­¦
  - alert: MaxwellHighLatency
    expr: maxwell_sync_delay_seconds > 30
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MaxwellåŒæ­¥å»¶è¿Ÿè¿‡é«˜"
      description: "MaxwellåŒæ­¥å»¶è¿Ÿè¶…è¿‡30ç§’ï¼Œå½“å‰å»¶è¿Ÿï¼š{{ $value }}ç§’"
  
  # é”™è¯¯ç‡å‘Šè­¦  
  - alert: MaxwellHighErrorRate
    expr: rate(maxwell_error_count[5m]) > 0.01
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Maxwellé”™è¯¯ç‡è¿‡é«˜"
      description: "Maxwellé”™è¯¯ç‡è¶…è¿‡1%ï¼Œå½“å‰é”™è¯¯ç‡ï¼š{{ $value }}"
```

---

## 6. ğŸ”§ ä¸€è‡´æ€§ä¿®å¤ç­–ç•¥


### 6.1 ä¸ä¸€è‡´æ•°æ®è¯†åˆ«


**ğŸ”¸ ä¸ä¸€è‡´æ•°æ®çš„å¸¸è§ç±»å‹**

```
æ•°æ®ä¸ä¸€è‡´ç±»å‹ï¼š

ğŸ”¸ ç¼ºå¤±æ•°æ®ï¼šæºåº“æœ‰æ•°æ®ï¼Œç›®æ ‡ç³»ç»Ÿæ²¡æœ‰
ç¤ºä¾‹ï¼šMySQLæ–°å¢ç”¨æˆ·ï¼Œä½†ESä¸­æ‰¾ä¸åˆ°è¯¥ç”¨æˆ·

ğŸ”¸ å¤šä½™æ•°æ®ï¼šç›®æ ‡ç³»ç»Ÿæœ‰æ•°æ®ï¼Œæºåº“æ²¡æœ‰  
ç¤ºä¾‹ï¼šESä¸­æœ‰ç”¨æˆ·æ•°æ®ï¼Œä½†MySQLä¸­è¯¥ç”¨æˆ·å·²åˆ é™¤

ğŸ”¸ å†…å®¹ä¸ä¸€è‡´ï¼šæ•°æ®å­˜åœ¨ä½†å†…å®¹ä¸åŒ¹é…
ç¤ºä¾‹ï¼šMySQLç”¨æˆ·å="å¼ ä¸‰"ï¼ŒESä¸­ç”¨æˆ·å="æå››"

ğŸ”¸ ç‰ˆæœ¬ä¸ä¸€è‡´ï¼šæ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…
ç¤ºä¾‹ï¼šMySQLç‰ˆæœ¬=5ï¼ŒESä¸­ç‰ˆæœ¬=3
```

**ğŸ”¹ ä¸ä¸€è‡´æ£€æµ‹ç®—æ³•**

```java
public class InconsistencyDetector {
    
    // æ‰¹é‡æ£€æµ‹æ•°æ®ä¸€è‡´æ€§
    public List<InconsistencyRecord> detectInconsistencies(String table, int batchSize) {
        List<InconsistencyRecord> inconsistencies = new ArrayList<>();
        
        // 1. åˆ†æ‰¹è·å–æºæ•°æ®
        String sql = "SELECT * FROM " + table + " ORDER BY id LIMIT ? OFFSET ?";
        int offset = 0;
        
        while (true) {
            List<Map<String, Object>> batch = sourceJdbcTemplate.queryForList(sql, batchSize, offset);
            if (batch.isEmpty()) break;
            
            // 2. æ‰¹é‡æ£€æŸ¥ç›®æ ‡æ•°æ®
            for (Map<String, Object> sourceRow : batch) {
                Long id = (Long) sourceRow.get("id");
                Map<String, Object> targetRow = getTargetData(table, id);
                
                // 3. å¯¹æ¯”æ•°æ®
                InconsistencyType type = compareData(sourceRow, targetRow);
                if (type != InconsistencyType.CONSISTENT) {
                    inconsistencies.add(new InconsistencyRecord(table, id, type, sourceRow, targetRow));
                }
            }
            
            offset += batchSize;
        }
        
        return inconsistencies;
    }
    
    private InconsistencyType compareData(Map<String, Object> source, Map<String, Object> target) {
        if (target == null) {
            return InconsistencyType.MISSING_IN_TARGET;
        }
        
        if (source == null) {
            return InconsistencyType.EXTRA_IN_TARGET;
        }
        
        // å¯¹æ¯”å…³é”®å­—æ®µ
        for (String key : source.keySet()) {
            if (!Objects.equals(source.get(key), target.get(key))) {
                return InconsistencyType.CONTENT_MISMATCH;
            }
        }
        
        return InconsistencyType.CONSISTENT;
    }
}
```

### 6.2 è‡ªåŠ¨ä¿®å¤æœºåˆ¶


**ğŸ”¸ ä¿®å¤ç­–ç•¥é€‰æ‹©**

```java
public class DataRepairService {
    
    public void repairInconsistency(InconsistencyRecord record) {
        switch (record.getType()) {
            case MISSING_IN_TARGET:
                // ç›®æ ‡ç¼ºå¤±ï¼šä»æºåº“åŒæ­¥æ•°æ®
                syncToTarget(record.getTable(), record.getSourceData());
                break;
                
            case EXTRA_IN_TARGET:
                // ç›®æ ‡å¤šä½™ï¼šåˆ é™¤ç›®æ ‡æ•°æ®
                deleteFromTarget(record.getTable(), record.getId());
                break;
                
            case CONTENT_MISMATCH:
                // å†…å®¹ä¸åŒ¹é…ï¼šä»¥æºåº“ä¸ºå‡†æ›´æ–°ç›®æ ‡
                updateTarget(record.getTable(), record.getId(), record.getSourceData());
                break;
        }
    }
    
    private void syncToTarget(String table, Map<String, Object> data) {
        try {
            // æ„é€ ESç´¢å¼•è¯·æ±‚
            IndexRequest request = new IndexRequest(table)
                .id(String.valueOf(data.get("id")))
                .source(data);
            
            esClient.index(request, RequestOptions.DEFAULT);
            
            logger.info("ä¿®å¤æˆåŠŸï¼šåŒæ­¥æ•°æ®åˆ°ç›®æ ‡ç³»ç»Ÿ - table:{}, id:{}", table, data.get("id"));
            
        } catch (Exception e) {
            logger.error("ä¿®å¤å¤±è´¥ï¼šåŒæ­¥æ•°æ®åˆ°ç›®æ ‡ç³»ç»Ÿ", e);
            // è®°å½•ä¿®å¤å¤±è´¥ï¼Œç¨åé‡è¯•
            recordRepairFailure(table, data, e.getMessage());
        }
    }
}
```

### 6.3 ä¿®å¤éªŒè¯ä¸å›æ»š


**ğŸ”¸ ä¿®å¤åéªŒè¯**

```java
public class RepairValidator {
    
    // ä¿®å¤åéªŒè¯æ•°æ®ä¸€è‡´æ€§
    public boolean validateRepair(String table, Long id) {
        try {
            // 1. é‡æ–°è·å–æºæ•°æ®å’Œç›®æ ‡æ•°æ®
            Map<String, Object> sourceData = getSourceData(table, id);
            Map<String, Object> targetData = getTargetData(table, id);
            
            // 2. å†æ¬¡å¯¹æ¯”
            boolean isConsistent = compareData(sourceData, targetData);
            
            if (isConsistent) {
                logger.info("ä¿®å¤éªŒè¯æˆåŠŸ - table:{}, id:{}", table, id);
                return true;
            } else {
                logger.warn("ä¿®å¤éªŒè¯å¤±è´¥ - table:{}, id:{}", table, id);
                return false;
            }
            
        } catch (Exception e) {
            logger.error("ä¿®å¤éªŒè¯å¼‚å¸¸", e);
            return false;
        }
    }
    
    // ä¿®å¤å¤±è´¥æ—¶çš„å›æ»šç­–ç•¥
    public void rollbackRepair(String table, Long id, Map<String, Object> originalData) {
        try {
            // æ¢å¤åˆ°ä¿®å¤å‰çš„çŠ¶æ€
            if (originalData != null) {
                updateTarget(table, id, originalData);
                logger.info("ä¿®å¤å›æ»šæˆåŠŸ - table:{}, id:{}", table, id);
            }
        } catch (Exception e) {
            logger.error("ä¿®å¤å›æ»šå¤±è´¥", e);
            // å‘é€å‘Šè­¦ï¼Œéœ€è¦äººå·¥ä»‹å…¥
            sendAlert("ä¿®å¤å›æ»šå¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†ï¼š" + table + ":" + id);
        }
    }
}
```

---

## 7. ğŸ§ª ä¸€è‡´æ€§æµ‹è¯•æ–¹æ³•


### 7.1 æµ‹è¯•åœºæ™¯è®¾è®¡


**ğŸ”¸ å¸¸è§æµ‹è¯•åœºæ™¯**

```
åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼š
âœ… æ­£å¸¸æ•°æ®åŒæ­¥ï¼šå¢åˆ æ”¹æŸ¥æ“ä½œæ˜¯å¦æ­£ç¡®åŒæ­¥
âœ… æ‰¹é‡æ•°æ®å¤„ç†ï¼šå¤§æ‰¹é‡æ•°æ®åŒæ­¥çš„å‡†ç¡®æ€§
âœ… äº‹åŠ¡å®Œæ•´æ€§ï¼šè·¨è¡¨äº‹åŠ¡çš„å®Œæ•´æ€§ä¿è¯

å¼‚å¸¸æƒ…å†µæµ‹è¯•ï¼š
âœ… ç½‘ç»œæ•…éšœï¼šç½‘ç»œä¸­æ–­åçš„æ•°æ®ä¸€è‡´æ€§
âœ… ç³»ç»Ÿé‡å¯ï¼šMaxwellé‡å¯åçš„æ•°æ®è¿ç»­æ€§  
âœ… ç›®æ ‡ç³»ç»Ÿæ•…éšœï¼šESå®•æœºåçš„æ•°æ®æ¢å¤
âœ… å¤§äº‹åŠ¡å¤„ç†ï¼šè¶…å¤§äº‹åŠ¡çš„å¤„ç†èƒ½åŠ›

æ€§èƒ½å‹åŠ›æµ‹è¯•ï¼š
âœ… é«˜å¹¶å‘å†™å…¥ï¼šå¤§é‡å¹¶å‘å†™å…¥çš„æ•°æ®ä¸€è‡´æ€§
âœ… é•¿æ—¶é—´è¿è¡Œï¼šé•¿æœŸè¿è¡Œçš„ç¨³å®šæ€§
âœ… èµ„æºé™åˆ¶ï¼šå†…å­˜/CPUå—é™æƒ…å†µä¸‹çš„è¡¨ç°
```

### 7.2 æµ‹è¯•å·¥å…·å®ç°


**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å·¥å…·**

```java
@Component
public class ConsistencyTestTool {
    
    // ç”Ÿæˆæµ‹è¯•æ•°æ®
    public void generateTestData(int count) {
        for (int i = 0; i < count; i++) {
            // æ’å…¥éšæœºæµ‹è¯•æ•°æ®
            User user = new User();
            user.setName("æµ‹è¯•ç”¨æˆ·" + i);
            user.setEmail("test" + i + "@example.com");
            user.setCreatedAt(new Date());
            
            userRepository.save(user);
        }
        
        logger.info("ç”Ÿæˆæµ‹è¯•æ•°æ® {} æ¡", count);
    }
    
    // éªŒè¯æ•°æ®ä¸€è‡´æ€§
    public ConsistencyTestResult verifyConsistency(long timeoutMs) {
        long startTime = System.currentTimeMillis();
        ConsistencyTestResult result = new ConsistencyTestResult();
        
        // ç­‰å¾…æ•°æ®åŒæ­¥å®Œæˆ
        Thread.sleep(timeoutMs);
        
        // è·å–æºæ•°æ®æ€»æ•°
        long sourceCount = jdbcTemplate.queryForObject("SELECT COUNT(*) FROM users", Long.class);
        
        // è·å–ç›®æ ‡æ•°æ®æ€»æ•°  
        long targetCount = esTemplate.count(Query.of(q -> q.matchAll(m -> m)), User.class);
        
        result.setSourceCount(sourceCount);
        result.setTargetCount(targetCount);
        result.setConsistent(sourceCount == targetCount);
        result.setTestDurationMs(System.currentTimeMillis() - startTime);
        
        return result;
    }
}
```

**ğŸ”¹ æ•…éšœæ³¨å…¥æµ‹è¯•**

```java
public class FaultInjectionTest {
    
    // æ¨¡æ‹Ÿç½‘ç»œæ•…éšœ
    public void simulateNetworkFailure() {
        logger.info("å¼€å§‹æ¨¡æ‹Ÿç½‘ç»œæ•…éšœ");
        
        // 1. æ­£å¸¸å†™å…¥æ•°æ®
        generateTestData(100);
        
        // 2. æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­ï¼ˆåœæ­¢Maxwellï¼‰
        maxwellService.stop();
        
        // 3. ç»§ç»­å†™å…¥æ•°æ®ï¼ˆè¿™éƒ¨åˆ†æ•°æ®åº”è¯¥åœ¨æ¢å¤ååŒæ­¥ï¼‰
        generateTestData(100);
        
        // 4. æ¢å¤ç½‘ç»œï¼ˆé‡å¯Maxwellï¼‰
        maxwellService.start();
        
        // 5. ç­‰å¾…åŒæ­¥å®Œæˆå¹¶éªŒè¯
        Thread.sleep(30000);
        ConsistencyTestResult result = verifyConsistency();
        
        assert result.isConsistent() : "ç½‘ç»œæ•…éšœæ¢å¤åæ•°æ®ä¸ä¸€è‡´";
        logger.info("ç½‘ç»œæ•…éšœæµ‹è¯•é€šè¿‡");
    }
    
    // æ¨¡æ‹Ÿç³»ç»Ÿé‡å¯
    public void simulateSystemRestart() {
        logger.info("å¼€å§‹æ¨¡æ‹Ÿç³»ç»Ÿé‡å¯");
        
        // 1. æ­£å¸¸è¿è¡ŒçŠ¶æ€ä¸‹å†™å…¥æ•°æ®
        generateTestData(50);
        
        // 2. æ¨¡æ‹Ÿçªç„¶é‡å¯
        maxwellService.forceStop();  // å¼ºåˆ¶åœæ­¢ï¼Œä¸ç­‰å¾…å¤„ç†å®Œæˆ
        
        // 3. é‡æ–°å¯åŠ¨
        maxwellService.start();
        
        // 4. éªŒè¯æ•°æ®ä¸€è‡´æ€§
        Thread.sleep(10000);
        ConsistencyTestResult result = verifyConsistency();
        
        assert result.isConsistent() : "ç³»ç»Ÿé‡å¯åæ•°æ®ä¸ä¸€è‡´";
        logger.info("ç³»ç»Ÿé‡å¯æµ‹è¯•é€šè¿‡");
    }
}
```

### 7.3 æ€§èƒ½åŸºå‡†æµ‹è¯•


**ğŸ”¸ ååé‡æµ‹è¯•**

```java
public class PerformanceTest {
    
    @Test
    public void testThroughput() {
        long startTime = System.currentTimeMillis();
        int totalRecords = 10000;
        
        // æ‰¹é‡æ’å…¥æ•°æ®
        batchInsertUsers(totalRecords);
        
        // ç­‰å¾…åŒæ­¥å®Œæˆ
        waitForSyncComplete(totalRecords);
        
        long endTime = System.currentTimeMillis();
        long duration = endTime - startTime;
        
        double throughput = (double) totalRecords / (duration / 1000.0);
        
        logger.info("ååé‡æµ‹è¯•ç»“æœï¼š");
        logger.info("æ€»è®°å½•æ•°ï¼š{}", totalRecords);
        logger.info("è€—æ—¶ï¼š{}ms", duration);
        logger.info("ååé‡ï¼š{} æ¡/ç§’", String.format("%.2f", throughput));
        
        // éªŒè¯ååé‡æ˜¯å¦è¾¾æ ‡
        assert throughput > 1000 : "ååé‡ä½äºé¢„æœŸï¼š" + throughput;
    }
    
    @Test  
    public void testLatency() {
        List<Long> latencies = new ArrayList<>();
        
        for (int i = 0; i < 100; i++) {
            long startTime = System.currentTimeMillis();
            
            // æ’å…¥å•æ¡æ•°æ®
            insertSingleUser("æµ‹è¯•ç”¨æˆ·" + i);
            
            // ç­‰å¾…åœ¨ESä¸­å¯æŸ¥è¯¢åˆ°
            waitForDataInES("æµ‹è¯•ç”¨æˆ·" + i);
            
            long latency = System.currentTimeMillis() - startTime;
            latencies.add(latency);
        }
        
        // è®¡ç®—å»¶è¿Ÿç»Ÿè®¡
        double avgLatency = latencies.stream().mapToLong(Long::longValue).average().orElse(0);
        long maxLatency = latencies.stream().mapToLong(Long::longValue).max().orElse(0);
        
        logger.info("å»¶è¿Ÿæµ‹è¯•ç»“æœï¼š");
        logger.info("å¹³å‡å»¶è¿Ÿï¼š{}ms", String.format("%.2f", avgLatency));
        logger.info("æœ€å¤§å»¶è¿Ÿï¼š{}ms", maxLatency);
        
        // éªŒè¯å»¶è¿Ÿæ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´å†…
        assert avgLatency < 5000 : "å¹³å‡å»¶è¿Ÿè¿‡é«˜ï¼š" + avgLatency;
        assert maxLatency < 10000 : "æœ€å¤§å»¶è¿Ÿè¿‡é«˜ï¼š" + maxLatency;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§æœ¬è´¨ï¼šç¡®ä¿åŸå§‹æ•°æ®å’ŒåŒæ­¥æ•°æ®å®Œå…¨åŒ¹é…
ğŸ”¸ äº‹åŠ¡å®Œæ•´æ€§ï¼šä¸€ç»„ç›¸å…³æ“ä½œè¦ä¹ˆå…¨éƒ¨åŒæ­¥ï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
ğŸ”¸ é¡ºåºä¸€è‡´æ€§ï¼šç›¸å…³æ•°æ®çš„æ“ä½œé¡ºåºå¿…é¡»ä¿æŒæ­£ç¡®
ğŸ”¸ å¹‚ç­‰æ€§åŸç†ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œç»“æœç›¸åŒï¼Œé¿å…é‡å¤æ•°æ®
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æ—¶é—´ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¶‹äºä¸€è‡´
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ Maxwellæ ¸å¿ƒé…ç½®**
```json
{
  "transaction_mode": "enabled",           // å¯ç”¨äº‹åŠ¡æ¨¡å¼
  "output_transaction_boundary": true,     // è¾“å‡ºäº‹åŠ¡è¾¹ç•Œ  
  "producer_partition_by": "primary_key",  // æŒ‰ä¸»é”®åˆ†åŒºä¿è¯é¡ºåº
  "producer_ack_timeout": 0,              // ç­‰å¾…ç¡®è®¤ä¿è¯å¯é æ€§
  "threads": 1                            // å•çº¿ç¨‹ä¿è¯é¡ºåº
}
```

**ğŸ”¹ ä¸€è‡´æ€§ä¿è¯ç­–ç•¥**
```
äº‹åŠ¡çº§åˆ«ï¼šç¼“å­˜äº‹åŠ¡å†…æ‰€æœ‰å˜æ›´ï¼Œæäº¤æ—¶æ‰¹é‡è¾“å‡º
é¡ºåºçº§åˆ«ï¼šæŒ‰ä¸šåŠ¡ä¸»é”®åˆ†åŒºï¼Œç¡®ä¿ç›¸å…³æ“ä½œçš„é¡ºåºæ€§
å¹‚ç­‰çº§åˆ«ï¼šåŸºäºbinlogä½ç½®æˆ–ä¸šåŠ¡ç‰ˆæœ¬å·å»é‡
ç›‘æ§çº§åˆ«ï¼šå®æ—¶ç›‘æ§å»¶è¿Ÿã€é”™è¯¯ç‡ã€ä¸€è‡´æ€§æŒ‡æ ‡
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‚ç”¨åœºæ™¯é€‰æ‹©**
- **å¼ºä¸€è‡´æ€§éœ€æ±‚**ï¼šé‡‘èäº¤æ˜“ã€åº“å­˜ç®¡ç† â†’ ä½¿ç”¨äº‹åŠ¡æ¨¡å¼ + å®æ—¶æ ¡éªŒ
- **æœ€ç»ˆä¸€è‡´æ€§éœ€æ±‚**ï¼šç”¨æˆ·ç”»åƒã€æ¨èç³»ç»Ÿ â†’ ä½¿ç”¨å¼‚æ­¥æ¨¡å¼ + å®šæœŸæ ¡éªŒ
- **é«˜æ€§èƒ½éœ€æ±‚**ï¼šæ—¥å¿—åŒæ­¥ã€ç›‘æ§æ•°æ® â†’ ä½¿ç”¨æ‰¹é‡æ¨¡å¼ + å®¹é”™æœºåˆ¶

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**
```
é…ç½®é—®é¢˜ï¼š
âŒ å¤šçº¿ç¨‹å¤„ç†å¯¼è‡´é¡ºåºé”™ä¹±
âŒ æœªå¯ç”¨äº‹åŠ¡æ¨¡å¼å¯¼è‡´æ•°æ®ä¸å®Œæ•´
âŒ åˆ†åŒºç­–ç•¥ä¸å½“å¯¼è‡´çƒ­ç‚¹é—®é¢˜

ç›‘æ§é—®é¢˜ï¼š
âŒ ç¼ºä¹å®æ—¶ç›‘æ§å¯¼è‡´é—®é¢˜å‘ç°å¤ªæ™š
âŒ å‘Šè­¦é˜ˆå€¼è®¾ç½®ä¸åˆç†
âŒ ç¼ºä¹ä¸€è‡´æ€§éªŒè¯æœºåˆ¶

æ•…éšœå¤„ç†ï¼š
âŒ ç¼ºä¹è‡ªåŠ¨é‡è¯•æœºåˆ¶
âŒ ç¼ºä¹æ•°æ®ä¿®å¤ç­–ç•¥
âŒ ç¼ºä¹æ•…éšœæ¼”ç»ƒå’Œæµ‹è¯•
```

### 8.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸŒŸ ç”Ÿäº§ç¯å¢ƒå»ºè®®**
```
éƒ¨ç½²é…ç½®ï¼š
âœ… ä½¿ç”¨ä¸“ç”¨æœºå™¨éƒ¨ç½²Maxwellï¼Œé¿å…èµ„æºäº‰æŠ¢
âœ… é…ç½®å……è¶³çš„å†…å­˜å’Œç£ç›˜ç©ºé—´
âœ… å¯ç”¨JVMç›‘æ§å’Œè°ƒä¼˜

è¿ç»´ç­–ç•¥ï¼š
âœ… å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
âœ… å®šæœŸæ‰§è¡Œæ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
âœ… åˆ¶å®šè¯¦ç»†çš„æ•…éšœå¤„ç†é¢„æ¡ˆ
âœ… å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ

ä¼˜åŒ–ç­–ç•¥ï¼š
âœ… æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´æ‰¹å¤„ç†å¤§å°
âœ… ä¼˜åŒ–ç½‘ç»œå’Œå­˜å‚¨æ€§èƒ½
âœ… åˆç†è®¾è®¡åˆ†åŒºç­–ç•¥
âœ… å®šæœŸæ¸…ç†å†å²æ•°æ®å’Œæ—¥å¿—
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Maxwellä¸€è‡´æ€§ä¿è¯éœ€è¦ä»äº‹åŠ¡ã€é¡ºåºã€å¹‚ç­‰ä¸‰ä¸ªç»´åº¦ç»¼åˆè€ƒè™‘
- ç›‘æ§å’Œä¿®å¤æœºåˆ¶æ˜¯ä¿è¯é•¿æœŸç¨³å®šè¿è¡Œçš„å…³é”®
- æµ‹è¯•éªŒè¯æ˜¯ç¡®ä¿ä¸€è‡´æ€§ç­–ç•¥æœ‰æ•ˆæ€§çš„é‡è¦æ‰‹æ®µ
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«å’Œå®ç°ç­–ç•¥