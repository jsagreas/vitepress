---
title: 7ã€è¿æ¥æ± æ•…éšœå¤„ç†
---
## ğŸ“š ç›®å½•

1. [è¿æ¥æ± æ•…éšœæ¦‚è§ˆ](#1-è¿æ¥æ± æ•…éšœæ¦‚è§ˆ)
2. [æ•°æ®åº“è¿æ¥ä¸­æ–­å¤„ç†](#2-æ•°æ®åº“è¿æ¥ä¸­æ–­å¤„ç†)
3. [è¿æ¥æ± è€—å°½æ•…éšœ](#3-è¿æ¥æ± è€—å°½æ•…éšœ)
4. [ç½‘ç»œå¼‚å¸¸æ¢å¤æœºåˆ¶](#4-ç½‘ç»œå¼‚å¸¸æ¢å¤æœºåˆ¶)
5. [æ•°æ®åº“é‡å¯æ¢å¤](#5-æ•°æ®åº“é‡å¯æ¢å¤)
6. [è¿æ¥å¥åº·æ£€æŸ¥](#6-è¿æ¥å¥åº·æ£€æŸ¥)
7. [ç†”æ–­ä¸æ•…éšœè½¬ç§»](#7-ç†”æ–­ä¸æ•…éšœè½¬ç§»)
8. [æ•…éšœæ¢å¤æ—¶é—´ä¼˜åŒ–](#8-æ•…éšœæ¢å¤æ—¶é—´ä¼˜åŒ–)
9. [æ•…éšœæ¼”ç»ƒæ–¹æ¡ˆ](#9-æ•…éšœæ¼”ç»ƒæ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ è¿æ¥æ± æ•…éšœæ¦‚è§ˆ


### 1.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± æ•…éšœ


**é€šä¿—ç†è§£**ï¼šè¿æ¥æ± æ•…éšœå°±åƒé¤å…çš„æœåŠ¡å‘˜ä¸å¤Ÿç”¨æˆ–è€…å¨æˆ¿è®¾å¤‡åäº†ï¼Œå¯¼è‡´å®¢äººç‚¹é¤åæ— æ³•æ­£å¸¸ç”¨é¤

```
æ­£å¸¸æƒ…å†µï¼š
åº”ç”¨ç¨‹åº â†’ è¿æ¥æ±  â†’ æ•°æ®åº“
         (æœ‰å¯ç”¨è¿æ¥)   (æ­£å¸¸å“åº”)

æ•…éšœæƒ…å†µï¼š
åº”ç”¨ç¨‹åº â†’ è¿æ¥æ±  â†’ æ•°æ®åº“
         (è¿æ¥ç”¨å®Œ)   (æ— æ³•è¿æ¥)
```

### 1.2 å¸¸è§æ•…éšœç±»å‹


**ğŸ”¸ è¿æ¥ç›¸å…³æ•…éšœ**
```
è¿æ¥è€—å°½ï¼šæ‰€æœ‰è¿æ¥éƒ½è¢«å ç”¨ï¼Œæ–°è¯·æ±‚æ— æ³•è·å–è¿æ¥
è¿æ¥ä¸­æ–­ï¼šç½‘ç»œé—®é¢˜å¯¼è‡´å·²æœ‰è¿æ¥æ–­å¼€
è¿æ¥è¶…æ—¶ï¼šè¿æ¥å»ºç«‹æ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡è®¾å®šé˜ˆå€¼
è¿æ¥æ³„æ¼ï¼šè¿æ¥ä½¿ç”¨åæ²¡æœ‰æ­£ç¡®é‡Šæ”¾å›è¿æ¥æ± 
```

**ğŸ”¸ æ•°æ®åº“ç›¸å…³æ•…éšœ**
```
æ•°æ®åº“å®•æœºï¼šæ•°æ®åº“æœåŠ¡å®Œå…¨åœæ­¢
æ•°æ®åº“é‡å¯ï¼šæ•°æ®åº“é‡æ–°å¯åŠ¨ï¼Œæ—§è¿æ¥å¤±æ•ˆ
æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼šå“åº”ç¼“æ…¢ï¼Œè¿æ¥è¯·æ±‚ç§¯å‹
ç½‘ç»œåˆ†åŒºï¼šåº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´ç½‘ç»œä¸é€š
```

### 1.3 æ•…éšœå½±å“èŒƒå›´


**åº”ç”¨å±‚é¢å½±å“**ï¼š
- ç”¨æˆ·è¯·æ±‚å“åº”ç¼“æ…¢æˆ–å¤±è´¥
- ç³»ç»Ÿååé‡æ€¥å‰§ä¸‹é™
- åº”ç”¨ç¨‹åºå¯èƒ½å‡ºç°å‡æ­»çŠ¶æ€

**æ•°æ®å±‚é¢å½±å“**ï¼š
- æ•°æ®è¯»å†™æ“ä½œå¤±è´¥
- äº‹åŠ¡å›æ»šå¢åŠ 
- æ•°æ®ä¸€è‡´æ€§é£é™©

---

## 2. ğŸ”Œ æ•°æ®åº“è¿æ¥ä¸­æ–­å¤„ç†


### 2.1 è¿æ¥ä¸­æ–­çš„åŸå› 


**ç½‘ç»œå±‚é¢é—®é¢˜**ï¼š
```
å¸¸è§åŸå› ï¼š
â€¢ ç½‘ç»œè®¾å¤‡æ•…éšœï¼ˆè·¯ç”±å™¨ã€äº¤æ¢æœºï¼‰
â€¢ ç½‘ç»œæ‹¥å¡å¯¼è‡´æ•°æ®åŒ…ä¸¢å¤±
â€¢ é˜²ç«å¢™è§„åˆ™å˜æ›´é˜»æ­¢è¿æ¥
â€¢ ç½‘ç»œåˆ†åŒºï¼ˆä¸åŒæœºæˆ¿é—´ç½‘ç»œä¸­æ–­ï¼‰
```

**æ•°æ®åº“å±‚é¢é—®é¢˜**ï¼š
```
æœåŠ¡å™¨é—®é¢˜ï¼š
â€¢ æ•°æ®åº“æœåŠ¡æ„å¤–é‡å¯
â€¢ æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼Œä¸»åŠ¨æ–­å¼€è¿æ¥
â€¢ æ•°æ®åº“ç»´æŠ¤æ“ä½œï¼ˆå‡çº§ã€å¤‡ä»½ï¼‰
â€¢ è¾¾åˆ°æœ€å¤§è¿æ¥æ•°é™åˆ¶
```

### 2.2 è¿æ¥ä¸­æ–­æ£€æµ‹æœºåˆ¶


**å¿ƒè·³æ£€æµ‹æ–¹å¼**ï¼š
```java
// HikariCPè¿æ¥æ± å¿ƒè·³æ£€æµ‹é…ç½®
HikariConfig config = new HikariConfig();
config.setConnectionTestQuery("SELECT 1");  // ç®€å•çš„å¿ƒè·³æŸ¥è¯¢
config.setValidationTimeout(3000);          // éªŒè¯è¶…æ—¶3ç§’
config.setLeakDetectionThreshold(60000);    // è¿æ¥æ³„æ¼æ£€æµ‹60ç§’

// è§£é‡Šï¼šæ¯æ¬¡ä»è¿æ¥æ± è·å–è¿æ¥æ—¶ï¼Œå…ˆæ‰§è¡ŒSELECT 1æŸ¥è¯¢
// å¦‚æœ3ç§’å†…æ²¡æœ‰å“åº”ï¼Œå°±è®¤ä¸ºè¿æ¥å·²ç»å¤±æ•ˆ
```

**è¿æ¥çŠ¶æ€ç›‘æ§**ï¼š
```java
// ç›‘æ§è¿æ¥çŠ¶æ€çš„ç®€å•ç¤ºä¾‹
public class ConnectionMonitor {
    
    public boolean isConnectionValid(Connection conn) {
        try {
            // æ–¹æ³•1ï¼šä½¿ç”¨æ•°æ®åº“é©±åŠ¨çš„isValidæ–¹æ³•
            return conn.isValid(5); // 5ç§’è¶…æ—¶
            
        } catch (SQLException e) {
            return false; // è¿æ¥å·²å¤±æ•ˆ
        }
    }
    
    // æ–¹æ³•2ï¼šæ‰§è¡Œç®€å•æŸ¥è¯¢æ£€æµ‹
    public boolean testConnection(Connection conn) {
        try {
            PreparedStatement ps = conn.prepareStatement("SELECT 1");
            ResultSet rs = ps.executeQuery();
            return rs.next(); // èƒ½æŸ¥è¯¢åˆ°ç»“æœè¯´æ˜è¿æ¥æ­£å¸¸
        } catch (SQLException e) {
            return false;
        }
    }
}
```

### 2.3 è‡ªåŠ¨é‡è¿æœºåˆ¶


**é‡è¿ç­–ç•¥é…ç½®**ï¼š
```java
// é…ç½®è‡ªåŠ¨é‡è¿å‚æ•°
public class ReconnectConfig {
    
    public DataSource createDataSource() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€è¿æ¥é…ç½®
        config.setJdbcUrl("jdbc:mysql://localhost:3306/test");
        config.setUsername("root");
        config.setPassword("password");
        
        // é‡è¿ç›¸å…³é…ç½®
        config.setConnectionTimeout(10000);      // è·å–è¿æ¥è¶…æ—¶10ç§’
        config.setMaxLifetime(600000);           // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´10åˆ†é’Ÿ
        config.setIdleTimeout(300000);           // ç©ºé—²è¿æ¥è¶…æ—¶5åˆ†é’Ÿ
        
        // è¿æ¥æ± å¤§å°
        config.setMinimumIdle(5);                // æœ€å°‘ä¿æŒ5ä¸ªè¿æ¥
        config.setMaximumPoolSize(20);           // æœ€å¤š20ä¸ªè¿æ¥
        
        return new HikariDataSource(config);
    }
}
```

**æ¸è¿›å¼é‡è¿ç­–ç•¥**ï¼š
```java
// å®ç°æ™ºèƒ½é‡è¿æœºåˆ¶
public class SmartReconnectManager {
    private int retryCount = 0;
    private final int maxRetries = 5;
    
    public Connection getConnectionWithRetry(DataSource dataSource) {
        while (retryCount < maxRetries) {
            try {
                return dataSource.getConnection();
                
            } catch (SQLException e) {
                retryCount++;
                
                // è®¡ç®—é€€é¿æ—¶é—´ï¼š1ç§’ã€2ç§’ã€4ç§’ã€8ç§’ã€16ç§’
                int backoffTime = (int) Math.pow(2, retryCount - 1) * 1000;
                
                System.out.println("è¿æ¥å¤±è´¥ï¼Œ" + backoffTime + "æ¯«ç§’åé‡è¯•...");
                
                try {
                    Thread.sleep(backoffTime);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        throw new RuntimeException("é‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°");
    }
}
```

---

## 3. ğŸ’§ è¿æ¥æ± è€—å°½æ•…éšœ


### 3.1 è¿æ¥æ± è€—å°½ç°è±¡


**ä»€ä¹ˆæ˜¯è¿æ¥æ± è€—å°½**ï¼š
å°±åƒåœè½¦åœºè½¦ä½å…¨æ»¡ï¼Œæ–°æ¥çš„è½¦æ— æ³•åœè½¦ï¼Œåªèƒ½åœ¨å¤–é¢æ’é˜Ÿç­‰å¾…

```
è¿æ¥æ± çŠ¶æ€ç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿æ¥æ±  (æœ€å¤§10ä¸ªè¿æ¥)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å ç”¨] [å ç”¨] [å ç”¨] [å ç”¨] [å ç”¨] â”‚
â”‚ [å ç”¨] [å ç”¨] [å ç”¨] [å ç”¨] [å ç”¨] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘
    æ–°è¯·æ±‚ç­‰å¾…ä¸­...
```

### 3.2 è¿æ¥è€—å°½çš„åŸå› åˆ†æ


**è¿æ¥æ³„æ¼é—®é¢˜**ï¼š
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šè¿æ¥æ²¡æœ‰æ­£ç¡®é‡Šæ”¾
public void badExample() {
    try {
        Connection conn = dataSource.getConnection();
        // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        // å¿˜è®°å…³é—­è¿æ¥ï¼è¿æ¥æ³„æ¼äº†
    } catch (SQLException e) {
        e.printStackTrace();
    }
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨try-with-resourcesè‡ªåŠ¨é‡Šæ”¾
public void goodExample() {
    try (Connection conn = dataSource.getConnection()) {
        // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
        // è‡ªåŠ¨é‡Šæ”¾è¿æ¥
    } catch (SQLException e) {
        e.printStackTrace();
    }
}
```

**ä¸šåŠ¡å¹¶å‘é‡è¿‡é«˜**ï¼š
```java
// ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
public class PoolMonitor {
    
    public void checkPoolStatus(HikariDataSource dataSource) {
        HikariPoolMXBean poolBean = dataSource.getHikariPoolMXBean();
        
        int activeConnections = poolBean.getActiveConnections();     // æ­£åœ¨ä½¿ç”¨çš„è¿æ¥
        int idleConnections = poolBean.getIdleConnections();         // ç©ºé—²è¿æ¥
        int totalConnections = poolBean.getTotalConnections();       // æ€»è¿æ¥æ•°
        int threadsWaiting = poolBean.getThreadsAwaitingConnection(); // ç­‰å¾…è¿æ¥çš„çº¿ç¨‹
        
        System.out.println("æ´»è·ƒè¿æ¥: " + activeConnections);
        System.out.println("ç©ºé—²è¿æ¥: " + idleConnections);
        System.out.println("æ€»è¿æ¥æ•°: " + totalConnections);
        System.out.println("ç­‰å¾…çº¿ç¨‹: " + threadsWaiting);
        
        // å‘Šè­¦åˆ¤æ–­
        if (threadsWaiting > 0) {
            System.out.println("âš ï¸ è­¦å‘Šï¼šæœ‰çº¿ç¨‹åœ¨ç­‰å¾…è¿æ¥ï¼Œå¯èƒ½å‡ºç°è¿æ¥ä¸è¶³");
        }
    }
}
```

### 3.3 è¿æ¥æ± å¤§å°ä¼˜åŒ–


**è¿æ¥æ•°è®¡ç®—å…¬å¼**ï¼š
```
åˆç†çš„è¿æ¥æ± å¤§å° = ((æ ¸å¿ƒçº¿ç¨‹æ•° Ã— 2) + æœ‰æ•ˆç£ç›˜æ•°)

ä¾‹å¦‚ï¼š
æœåŠ¡å™¨CPUæ ¸å¿ƒæ•°ï¼š8æ ¸
æœ‰æ•ˆç£ç›˜æ•°ï¼š1ä¸ªSSD
æ¨èè¿æ¥æ± å¤§å°ï¼š(8 Ã— 2) + 1 = 17ä¸ªè¿æ¥

å®é™…è¿˜è¦è€ƒè™‘ï¼š
â€¢ ä¸šåŠ¡ç‰¹ç‚¹ï¼ˆCPUå¯†é›†å‹ vs IOå¯†é›†å‹ï¼‰
â€¢ æ•°æ®åº“æœåŠ¡å™¨æ€§èƒ½
â€¢ ç½‘ç»œå»¶è¿Ÿæƒ…å†µ
```

**åŠ¨æ€è°ƒæ•´ç­–ç•¥**ï¼š
```java
// è¿æ¥æ± åŠ¨æ€è°ƒæ•´é…ç½®
public class DynamicPoolConfig {
    
    public HikariConfig createAdaptiveConfig() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€é…ç½®
        config.setMinimumIdle(5);          // æœ€å°‘ä¿æŒ5ä¸ªè¿æ¥
        config.setMaximumPoolSize(50);     // æœ€å¤š50ä¸ªè¿æ¥
        
        // è¿æ¥è·å–ç­–ç•¥
        config.setConnectionTimeout(3000); // 3ç§’è·å–ä¸åˆ°è¿æ¥å°±æŠ¥é”™
        config.setValidationTimeout(2000); // è¿æ¥éªŒè¯è¶…æ—¶2ç§’
        
        // è¿æ¥ç”Ÿå‘½å‘¨æœŸ
        config.setMaxLifetime(1800000);    // è¿æ¥æœ€é•¿ç”Ÿå­˜30åˆ†é’Ÿ
        config.setIdleTimeout(600000);     // ç©ºé—²è¿æ¥10åˆ†é’Ÿåå›æ”¶
        
        return config;
    }
}
```

---

## 4. ğŸŒ ç½‘ç»œå¼‚å¸¸æ¢å¤æœºåˆ¶


### 4.1 ç½‘ç»œå¼‚å¸¸ç±»å‹è¯†åˆ«


**ä¸´æ—¶æ€§ç½‘ç»œæŠ–åŠ¨**ï¼š
```
ç‰¹å¾ï¼š
â€¢ æŒç»­æ—¶é—´çŸ­ï¼ˆå‡ ç§’åˆ°å‡ åˆ†é’Ÿï¼‰
â€¢ éƒ¨åˆ†è¿æ¥å—å½±å“
â€¢ ç½‘ç»œæ¢å¤åè‡ªåŠ¨æ­£å¸¸

å¤„ç†ç­–ç•¥ï¼š
â€¢ çŸ­æš‚é‡è¯•
â€¢ ä½¿ç”¨å¤‡ç”¨è¿æ¥
â€¢ é™çº§æœåŠ¡
```

**ç½‘ç»œåˆ†åŒºæ•…éšœ**ï¼š
```
ç‰¹å¾ï¼š
â€¢ åº”ç”¨ä¸æ•°æ®åº“å®Œå…¨æ— æ³•é€šä¿¡
â€¢ æŒç»­æ—¶é—´è¾ƒé•¿
â€¢ éœ€è¦äººå·¥ä»‹å…¥

å¤„ç†ç­–ç•¥ï¼š
â€¢ åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®åº“
â€¢ å¯ç”¨åªè¯»æ¨¡å¼
â€¢ ä½¿ç”¨ç¼“å­˜æ•°æ®
```

### 4.2 ç½‘ç»œæ¢å¤æ£€æµ‹


**è¿æ¥æ¢å¤éªŒè¯**ï¼š
```java
public class NetworkRecoveryDetector {
    
    // æ£€æµ‹ç½‘ç»œæ˜¯å¦æ¢å¤
    public boolean isNetworkRecovered(String dbHost, int dbPort) {
        try {
            // æ–¹æ³•1ï¼šSocketè¿æ¥æµ‹è¯•
            Socket socket = new Socket();
            socket.connect(new InetSocketAddress(dbHost, dbPort), 5000);
            socket.close();
            
            System.out.println("âœ… ç½‘ç»œè¿æ¥å·²æ¢å¤");
            return true;
            
        } catch (IOException e) {
            System.out.println("âŒ ç½‘ç»œä»æœªæ¢å¤: " + e.getMessage());
            return false;
        }
    }
    
    // æ•°æ®åº“æœåŠ¡æ£€æµ‹
    public boolean isDatabaseServiceUp(DataSource dataSource) {
        try (Connection conn = dataSource.getConnection()) {
            // æ‰§è¡Œç®€å•æŸ¥è¯¢æµ‹è¯•
            PreparedStatement ps = conn.prepareStatement("SELECT 1");
            ResultSet rs = ps.executeQuery();
            
            return rs.next(); // èƒ½æŸ¥è¯¢è¯´æ˜æ•°æ®åº“æœåŠ¡æ­£å¸¸
            
        } catch (SQLException e) {
            return false;
        }
    }
}
```

### 4.3 ç½‘ç»œå¼‚å¸¸æœŸé—´çš„åº”å¯¹æªæ–½


**é™çº§æœåŠ¡ç­–ç•¥**ï¼š
```java
public class ServiceDegradationManager {
    private boolean isDatabaseAvailable = true;
    private final CacheManager cacheManager = new CacheManager();
    
    public UserInfo getUserInfo(Long userId) {
        if (isDatabaseAvailable) {
            try {
                // å°è¯•ä»æ•°æ®åº“è·å–
                return getUserFromDatabase(userId);
                
            } catch (SQLException e) {
                // æ•°æ®åº“ä¸å¯ç”¨ï¼Œæ ‡è®°çŠ¶æ€
                isDatabaseAvailable = false;
                System.out.println("âš ï¸ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œå¯ç”¨é™çº§æ¨¡å¼");
            }
        }
        
        // é™çº§ï¼šä»ç¼“å­˜è·å–æ•°æ®
        UserInfo cachedUser = cacheManager.getUser(userId);
        if (cachedUser != null) {
            System.out.println("ğŸ“¦ ä»ç¼“å­˜è¿”å›ç”¨æˆ·æ•°æ®");
            return cachedUser;
        }
        
        // æœ€åé™çº§ï¼šè¿”å›é»˜è®¤æ•°æ®
        return createDefaultUserInfo(userId);
    }
    
    private UserInfo createDefaultUserInfo(Long userId) {
        UserInfo defaultUser = new UserInfo();
        defaultUser.setId(userId);
        defaultUser.setName("è®¿å®¢ç”¨æˆ·");
        return defaultUser;
    }
}
```

---

## 5. ğŸ”„ æ•°æ®åº“é‡å¯æ¢å¤


### 5.1 æ•°æ®åº“é‡å¯æ£€æµ‹


**é‡å¯ä¿¡å·è¯†åˆ«**ï¼š
```java
public class DatabaseRestartDetector {
    
    public boolean isDatabaseRestarted(DataSource dataSource) {
        try (Connection conn = dataSource.getConnection()) {
            // æŸ¥è¯¢æ•°æ®åº“å¯åŠ¨æ—¶é—´
            PreparedStatement ps = conn.prepareStatement(
                "SELECT VARIABLE_VALUE FROM INFORMATION_SCHEMA.GLOBAL_STATUS " +
                "WHERE VARIABLE_NAME = 'Uptime'"
            );
            
            ResultSet rs = ps.executeQuery();
            if (rs.next()) {
                long uptime = rs.getLong(1); // è·å–è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
                
                // å¦‚æœè¿è¡Œæ—¶é—´å°äº10åˆ†é’Ÿï¼Œå¯èƒ½æ˜¯åˆšé‡å¯
                if (uptime < 600) {
                    System.out.println("ğŸ”„ æ£€æµ‹åˆ°æ•°æ®åº“å¯èƒ½åˆšé‡å¯ï¼Œè¿è¡Œæ—¶é—´: " + uptime + "ç§’");
                    return true;
                }
            }
            
        } catch (SQLException e) {
            System.out.println("âŒ æ£€æµ‹æ•°æ®åº“çŠ¶æ€å¤±è´¥: " + e.getMessage());
        }
        
        return false;
    }
}
```

### 5.2 è¿æ¥æ± é‡å»ºç­–ç•¥


**æ™ºèƒ½é‡å»ºæœºåˆ¶**ï¼š
```java
public class PoolRebuildManager {
    
    public void handleDatabaseRestart(HikariDataSource dataSource) {
        System.out.println("ğŸ”§ å¼€å§‹å¤„ç†æ•°æ®åº“é‡å¯æ¢å¤...");
        
        // æ­¥éª¤1ï¼šæš‚åœæ¥æ”¶æ–°è¯·æ±‚
        dataSource.setMaximumPoolSize(0);
        
        try {
            // æ­¥éª¤2ï¼šç­‰å¾…ç°æœ‰è¿æ¥å®Œæˆ
            Thread.sleep(5000);
            
            // æ­¥éª¤3ï¼šæ¸…ç†æ‰€æœ‰è¿æ¥
            dataSource.getHikariPoolMXBean().softEvictConnections();
            
            // æ­¥éª¤4ï¼šæ¢å¤è¿æ¥æ± 
            dataSource.setMaximumPoolSize(20); // æ¢å¤åŸæ¥çš„è¿æ¥æ•°
            
            // æ­¥éª¤5ï¼šé¢„çƒ­è¿æ¥æ± 
            warmupConnectionPool(dataSource);
            
            System.out.println("âœ… è¿æ¥æ± é‡å»ºå®Œæˆ");
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            System.out.println("âŒ è¿æ¥æ± é‡å»ºè¢«ä¸­æ–­");
        }
    }
    
    private void warmupConnectionPool(DataSource dataSource) {
        // é¢„å…ˆåˆ›å»ºå‡ ä¸ªè¿æ¥ï¼Œç¡®ä¿æ± å­æ˜¯å¥åº·çš„
        for (int i = 0; i < 3; i++) {
            try (Connection conn = dataSource.getConnection()) {
                PreparedStatement ps = conn.prepareStatement("SELECT 1");
                ps.executeQuery();
                System.out.println("ğŸ”¥ é¢„çƒ­è¿æ¥ " + (i + 1) + " æˆåŠŸ");
            } catch (SQLException e) {
                System.out.println("âš ï¸ é¢„çƒ­è¿æ¥å¤±è´¥: " + e.getMessage());
            }
        }
    }
}
```

---

## 6. â¤ï¸ è¿æ¥å¥åº·æ£€æŸ¥


### 6.1 å¥åº·æ£€æŸ¥æœºåˆ¶è®¾è®¡


**å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥**ï¼š
```
ç¬¬1å±‚ï¼šè¿æ¥åŸºç¡€æ£€æŸ¥
â”œâ”€ è¿æ¥æ˜¯å¦ä¸ºnull
â”œâ”€ è¿æ¥æ˜¯å¦å·²å…³é—­
â””â”€ è¿æ¥è¶…æ—¶æ£€æŸ¥

ç¬¬2å±‚ï¼šæ•°æ®åº“å“åº”æ£€æŸ¥  
â”œâ”€ æ‰§è¡ŒSELECT 1æŸ¥è¯¢
â”œâ”€ æŸ¥è¯¢å“åº”æ—¶é—´æ£€æµ‹
â””â”€ æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯éªŒè¯

ç¬¬3å±‚ï¼šä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥
â”œâ”€ å…³é”®è¡¨è®¿é—®æµ‹è¯•
â”œâ”€ äº‹åŠ¡æäº¤æµ‹è¯•
â””â”€ è¯»å†™æƒé™éªŒè¯
```

### 6.2 å¥åº·æ£€æŸ¥å®ç°


**åˆ†å±‚æ£€æŸ¥ä»£ç ç¤ºä¾‹**ï¼š
```java
public class ConnectionHealthChecker {
    
    // ç¬¬1å±‚ï¼šåŸºç¡€è¿æ¥æ£€æŸ¥
    public boolean isConnectionBasicallyValid(Connection conn) {
        try {
            return conn != null && !conn.isClosed() && conn.isValid(3);
        } catch (SQLException e) {
            return false;
        }
    }
    
    // ç¬¬2å±‚ï¼šæ•°æ®åº“å“åº”æ£€æŸ¥
    public boolean isDatabaseResponding(Connection conn) {
        try {
            long startTime = System.currentTimeMillis();
            
            PreparedStatement ps = conn.prepareStatement("SELECT 1");
            ResultSet rs = ps.executeQuery();
            boolean hasResult = rs.next();
            
            long responseTime = System.currentTimeMillis() - startTime;
            
            // å“åº”æ—¶é—´è¶…è¿‡2ç§’è®¤ä¸ºå¼‚å¸¸
            if (responseTime > 2000) {
                System.out.println("âš ï¸ æ•°æ®åº“å“åº”ç¼“æ…¢: " + responseTime + "ms");
                return false;
            }
            
            return hasResult;
            
        } catch (SQLException e) {
            return false;
        }
    }
    
    // ç¬¬3å±‚ï¼šä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥
    public boolean isBusinessFunctionWorking(Connection conn) {
        try {
            // æ£€æŸ¥æ˜¯å¦èƒ½è¯»å–å…³é”®ä¸šåŠ¡è¡¨
            PreparedStatement ps = conn.prepareStatement(
                "SELECT COUNT(*) FROM user_info LIMIT 1"
            );
            ResultSet rs = ps.executeQuery();
            
            return rs.next(); // èƒ½æŸ¥è¯¢ä¸šåŠ¡è¡¨è¯´æ˜åŠŸèƒ½æ­£å¸¸
            
        } catch (SQLException e) {
            System.out.println("âŒ ä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥å¤±è´¥: " + e.getMessage());
            return false;
        }
    }
    
    // ç»¼åˆå¥åº·æ£€æŸ¥
    public HealthStatus checkConnectionHealth(Connection conn) {
        if (!isConnectionBasicallyValid(conn)) {
            return HealthStatus.DEAD;
        }
        
        if (!isDatabaseResponding(conn)) {
            return HealthStatus.SLOW;
        }
        
        if (!isBusinessFunctionWorking(conn)) {
            return HealthStatus.LIMITED;
        }
        
        return HealthStatus.HEALTHY;
    }
}

enum HealthStatus {
    HEALTHY,    // å®Œå…¨æ­£å¸¸
    LIMITED,    // éƒ¨åˆ†åŠŸèƒ½å—é™
    SLOW,       // å“åº”ç¼“æ…¢
    DEAD        // è¿æ¥å¤±æ•ˆ
}
```

### 6.3 å¥åº·æ£€æŸ¥è°ƒåº¦


**å®šæœŸæ£€æŸ¥æœºåˆ¶**ï¼š
```java
public class HealthCheckScheduler {
    private final ScheduledExecutorService scheduler = 
        Executors.newScheduledThreadPool(2);
    
    private final ConnectionHealthChecker healthChecker = 
        new ConnectionHealthChecker();
    
    public void startHealthCheck(DataSource dataSource) {
        // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
        scheduler.scheduleAtFixedRate(() -> {
            try (Connection conn = dataSource.getConnection()) {
                HealthStatus status = healthChecker.checkConnectionHealth(conn);
                
                switch (status) {
                    case HEALTHY:
                        System.out.println("âœ… è¿æ¥æ± å¥åº·çŠ¶æ€è‰¯å¥½");
                        break;
                    case SLOW:
                        System.out.println("âš ï¸ æ•°æ®åº“å“åº”ç¼“æ…¢ï¼Œéœ€è¦å…³æ³¨");
                        break;
                    case LIMITED:
                        System.out.println("âš ï¸ éƒ¨åˆ†åŠŸèƒ½å—é™ï¼Œæ£€æŸ¥æ•°æ®åº“çŠ¶æ€");
                        break;
                    case DEAD:
                        System.out.println("âŒ è¿æ¥å¤±æ•ˆï¼Œè§¦å‘æ•…éšœæ¢å¤");
                        // è§¦å‘æ•…éšœæ¢å¤æœºåˆ¶
                        break;
                }
                
            } catch (SQLException e) {
                System.out.println("âŒ å¥åº·æ£€æŸ¥å¤±è´¥: " + e.getMessage());
            }
            
        }, 0, 30, TimeUnit.SECONDS);
    }
}
```

---

## 7. âš¡ ç†”æ–­ä¸æ•…éšœè½¬ç§»


### 7.1 ç†”æ–­æœºåˆ¶åŸç†


**ç†”æ–­å™¨å·¥ä½œåŸç†**ï¼š
å°±åƒå®¶é‡Œçš„ä¿é™©ä¸ï¼Œå½“ç”µæµè¿‡å¤§æ—¶è‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤æ•´ä¸ªç”µè·¯ä¸è¢«çƒ§å

```
ç†”æ–­å™¨çŠ¶æ€å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å¤±è´¥ç‡è¿‡é«˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…³é—­çŠ¶æ€   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   å¼€å¯çŠ¶æ€   â”‚
â”‚ (æ­£å¸¸å·¥ä½œ)   â”‚            â”‚ (æ‹’ç»è¯·æ±‚)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                          â”‚
       â”‚                    è¶…æ—¶åå°è¯•
       â”‚                          â”‚
       â”‚                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æµ‹è¯•æˆåŠŸ    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…³é—­çŠ¶æ€   â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   åŠå¼€çŠ¶æ€   â”‚
â”‚ (æ¢å¤å·¥ä½œ)   â”‚            â”‚ (è°¨æ…æµ‹è¯•)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 ç†”æ–­å™¨å®ç°


**ç®€å•ç†”æ–­å™¨å®ç°**ï¼š
```java
public class DatabaseCircuitBreaker {
    private volatile CircuitState state = CircuitState.CLOSED;
    private int failureCount = 0;
    private final int failureThreshold = 5;        // å¤±è´¥5æ¬¡å°±ç†”æ–­
    private final long timeout = 60000;            // ç†”æ–­60ç§’åå°è¯•æ¢å¤
    private long lastFailureTime = 0;
    
    public enum CircuitState {
        CLOSED,     // å…³é—­çŠ¶æ€ï¼šæ­£å¸¸å·¥ä½œ
        OPEN,       // å¼€å¯çŠ¶æ€ï¼šæ‹’ç»è¯·æ±‚
        HALF_OPEN   // åŠå¼€çŠ¶æ€ï¼šè°¨æ…æµ‹è¯•
    }
    
    public boolean canExecute() {
        switch (state) {
            case CLOSED:
                return true; // æ­£å¸¸çŠ¶æ€ï¼Œå…è®¸æ‰§è¡Œ
                
            case OPEN:
                // æ£€æŸ¥æ˜¯å¦åˆ°äº†é‡è¯•æ—¶é—´
                if (System.currentTimeMillis() - lastFailureTime > timeout) {
                    state = CircuitState.HALF_OPEN;
                    System.out.println("ğŸ”„ ç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå¼€å§‹æµ‹è¯•");
                    return true;
                }
                return false; // ä»åœ¨ç†”æ–­æœŸé—´
                
            case HALF_OPEN:
                return true; // æµ‹è¯•é˜¶æ®µï¼Œå…è®¸å°‘é‡è¯·æ±‚
                
            default:
                return false;
        }
    }
    
    public void recordSuccess() {
        if (state == CircuitState.HALF_OPEN) {
            // æµ‹è¯•æˆåŠŸï¼Œæ¢å¤æ­£å¸¸
            state = CircuitState.CLOSED;
            failureCount = 0;
            System.out.println("âœ… ç†”æ–­å™¨æ¢å¤æ­£å¸¸çŠ¶æ€");
        }
    }
    
    public void recordFailure() {
        failureCount++;
        lastFailureTime = System.currentTimeMillis();
        
        if (state == CircuitState.HALF_OPEN) {
            // æµ‹è¯•å¤±è´¥ï¼Œé‡æ–°ç†”æ–­
            state = CircuitState.OPEN;
            System.out.println("âŒ æµ‹è¯•å¤±è´¥ï¼Œç†”æ–­å™¨é‡æ–°å¼€å¯");
            
        } else if (failureCount >= failureThreshold) {
            // å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ï¼Œè§¦å‘ç†”æ–­
            state = CircuitState.OPEN;
            System.out.println("ğŸš¨ è¿ç»­å¤±è´¥" + failureCount + "æ¬¡ï¼Œè§¦å‘ç†”æ–­");
        }
    }
}
```

### 7.3 æ•…éšœè½¬ç§»æœºåˆ¶


**ä¸»å¤‡æ•°æ®åº“åˆ‡æ¢**ï¼š
```java
public class DatabaseFailoverManager {
    private DataSource primaryDataSource;      // ä¸»æ•°æ®åº“
    private DataSource secondaryDataSource;    // å¤‡æ•°æ®åº“
    private volatile boolean usingPrimary = true;
    
    private final DatabaseCircuitBreaker circuitBreaker = 
        new DatabaseCircuitBreaker();
    
    public Connection getConnection() throws SQLException {
        // æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
        if (!circuitBreaker.canExecute()) {
            System.out.println("âš ï¸ ç†”æ–­å™¨å¼€å¯ï¼Œç›´æ¥ä½¿ç”¨å¤‡ç”¨æ•°æ®åº“");
            return getSecondaryConnection();
        }
        
        if (usingPrimary) {
            try {
                Connection conn = primaryDataSource.getConnection();
                circuitBreaker.recordSuccess(); // è®°å½•æˆåŠŸ
                return conn;
                
            } catch (SQLException e) {
                circuitBreaker.recordFailure(); // è®°å½•å¤±è´¥
                
                System.out.println("âŒ ä¸»æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®åº“");
                usingPrimary = false;
                
                return getSecondaryConnection();
            }
        } else {
            // å½“å‰ä½¿ç”¨å¤‡ç”¨æ•°æ®åº“
            return getSecondaryConnection();
        }
    }
    
    private Connection getSecondaryConnection() throws SQLException {
        try {
            return secondaryDataSource.getConnection();
        } catch (SQLException e) {
            System.out.println("âŒ å¤‡ç”¨æ•°æ®åº“ä¹Ÿæ— æ³•è¿æ¥ï¼");
            throw new SQLException("æ‰€æœ‰æ•°æ®åº“éƒ½ä¸å¯ç”¨", e);
        }
    }
    
    // å®šæœŸæ£€æŸ¥ä¸»æ•°æ®åº“æ˜¯å¦æ¢å¤
    public void startPrimaryHealthCheck() {
        ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
        
        scheduler.scheduleAtFixedRate(() -> {
            if (!usingPrimary) {
                try (Connection conn = primaryDataSource.getConnection()) {
                    // æµ‹è¯•ä¸»æ•°æ®åº“è¿æ¥
                    PreparedStatement ps = conn.prepareStatement("SELECT 1");
                    ps.executeQuery();
                    
                    // ä¸»æ•°æ®åº“æ¢å¤ï¼Œåˆ‡æ¢å›æ¥
                    usingPrimary = true;
                    circuitBreaker.recordSuccess();
                    System.out.println("âœ… ä¸»æ•°æ®åº“å·²æ¢å¤ï¼Œåˆ‡æ¢å›ä¸»æ•°æ®åº“");
                    
                } catch (SQLException e) {
                    System.out.println("âš ï¸ ä¸»æ•°æ®åº“ä»æœªæ¢å¤");
                }
            }
        }, 30, 30, TimeUnit.SECONDS); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    }
}
```

---

## 8. â±ï¸ æ•…éšœæ¢å¤æ—¶é—´ä¼˜åŒ–


### 8.1 å¿«é€Ÿæ£€æµ‹æ•…éšœ


**å®æ—¶ç›‘æ§æŒ‡æ ‡**ï¼š
```java
public class PerformanceMonitor {
    private final AtomicInteger connectionErrors = new AtomicInteger(0);
    private final AtomicLong totalResponseTime = new AtomicLong(0);
    private final AtomicInteger requestCount = new AtomicInteger(0);
    
    public void recordConnectionError() {
        connectionErrors.incrementAndGet();
        checkErrorRate(); // å®æ—¶æ£€æŸ¥é”™è¯¯ç‡
    }
    
    public void recordRequest(long responseTime) {
        totalResponseTime.addAndGet(responseTime);
        requestCount.incrementAndGet();
        
        // æ£€æŸ¥å“åº”æ—¶é—´
        if (responseTime > 5000) { // è¶…è¿‡5ç§’
            System.out.println("âš ï¸ å‘ç°æ…¢æŸ¥è¯¢ï¼Œå“åº”æ—¶é—´: " + responseTime + "ms");
        }
    }
    
    private void checkErrorRate() {
        int errors = connectionErrors.get();
        int requests = requestCount.get();
        
        if (requests > 10 && errors > requests * 0.5) { // é”™è¯¯ç‡è¶…è¿‡50%
            System.out.println("ğŸš¨ é”™è¯¯ç‡è¿‡é«˜: " + errors + "/" + requests);
            // è§¦å‘å‘Šè­¦æˆ–æ•…éšœå¤„ç†
        }
    }
    
    // è·å–å¹³å‡å“åº”æ—¶é—´
    public long getAverageResponseTime() {
        int count = requestCount.get();
        if (count == 0) return 0;
        
        return totalResponseTime.get() / count;
    }
}
```

### 8.2 é¢„çƒ­ç­–ç•¥ä¼˜åŒ–


**è¿æ¥æ± é¢„çƒ­æœºåˆ¶**ï¼š
```java
public class ConnectionPoolWarmer {
    
    public void warmupPool(DataSource dataSource, int targetConnections) {
        System.out.println("ğŸ”¥ å¼€å§‹é¢„çƒ­è¿æ¥æ± ï¼Œç›®æ ‡è¿æ¥æ•°: " + targetConnections);
        
        List<Connection> connections = new ArrayList<>();
        
        try {
            // å¹¶è¡Œåˆ›å»ºè¿æ¥ï¼Œæé«˜é¢„çƒ­é€Ÿåº¦
            ExecutorService executor = Executors.newFixedThreadPool(5);
            List<Future<Connection>> futures = new ArrayList<>();
            
            for (int i = 0; i < targetConnections; i++) {
                Future<Connection> future = executor.submit(() -> {
                    try {
                        Connection conn = dataSource.getConnection();
                        
                        // æ‰§è¡Œä¸€ä¸ªç®€å•æŸ¥è¯¢ï¼Œç¡®ä¿è¿æ¥å¯ç”¨
                        PreparedStatement ps = conn.prepareStatement("SELECT 1");
                        ps.executeQuery();
                        ps.close();
                        
                        return conn;
                    } catch (SQLException e) {
                        System.out.println("âŒ é¢„çƒ­è¿æ¥å¤±è´¥: " + e.getMessage());
                        return null;
                    }
                });
                
                futures.add(future);
            }
            
            // æ”¶é›†é¢„çƒ­ç»“æœ
            int successCount = 0;
            for (Future<Connection> future : futures) {
                try {
                    Connection conn = future.get(10, TimeUnit.SECONDS);
                    if (conn != null) {
                        connections.add(conn);
                        successCount++;
                    }
                } catch (Exception e) {
                    System.out.println("âš ï¸ é¢„çƒ­è¿æ¥è¶…æ—¶");
                }
            }
            
            System.out.println("âœ… é¢„çƒ­å®Œæˆï¼ŒæˆåŠŸåˆ›å»º " + successCount + " ä¸ªè¿æ¥");
            
            executor.shutdown();
            
        } finally {
            // é‡Šæ”¾é¢„çƒ­è¿æ¥ï¼Œè®©å®ƒä»¬å›åˆ°è¿æ¥æ± 
            for (Connection conn : connections) {
                try {
                    conn.close();
                } catch (SQLException e) {
                    // å¿½ç•¥å…³é—­å¼‚å¸¸
                }
            }
        }
    }
}
```

### 8.3 æ•…éšœæ¢å¤æ—¶é—´æµ‹é‡


**æ¢å¤æ—¶é—´ç›‘æ§**ï¼š
```java
public class RecoveryTimeMonitor {
    private long failureStartTime = 0;
    private boolean inFailureState = false;
    
    public void markFailureStart() {
        if (!inFailureState) {
            failureStartTime = System.currentTimeMillis();
            inFailureState = true;
            System.out.println("ğŸš¨ æ•…éšœå¼€å§‹æ—¶é—´: " + new Date(failureStartTime));
        }
    }
    
    public void markRecoveryComplete() {
        if (inFailureState) {
            long recoveryTime = System.currentTimeMillis() - failureStartTime;
            inFailureState = false;
            
            System.out.println("âœ… æ•…éšœæ¢å¤å®Œæˆ");
            System.out.println("ğŸ“Š æ•…éšœæŒç»­æ—¶é—´: " + recoveryTime + "ms");
            System.out.println("ğŸ“Š æ•…éšœæŒç»­æ—¶é—´: " + (recoveryTime / 1000) + "ç§’");
            
            // è®°å½•æ¢å¤æ—¶é—´ï¼Œç”¨äºåç»­ä¼˜åŒ–
            recordRecoveryMetrics(recoveryTime);
        }
    }
    
    private void recordRecoveryMetrics(long recoveryTime) {
        // å¯ä»¥å†™å…¥æ—¥å¿—ã€å‘é€ç›‘æ§æ•°æ®ç­‰
        if (recoveryTime > 30000) { // è¶…è¿‡30ç§’
            System.out.println("âš ï¸ æ¢å¤æ—¶é—´è¿‡é•¿ï¼Œéœ€è¦ä¼˜åŒ–æ•…éšœå¤„ç†æµç¨‹");
        }
    }
}
```

---

## 9. ğŸ­ æ•…éšœæ¼”ç»ƒæ–¹æ¡ˆ


### 9.1 æ•…éšœåœºæ™¯è®¾è®¡


**å¸¸è§æ•…éšœåœºæ™¯æ¸…å•**ï¼š
```
ç½‘ç»œç±»æ•…éšœï¼š
â”œâ”€ ç½‘ç»œå»¶è¿Ÿæ¨¡æ‹Ÿï¼ˆ100msã€500msã€1000msï¼‰
â”œâ”€ ç½‘ç»œä¸¢åŒ…æ¨¡æ‹Ÿï¼ˆ1%ã€5%ã€10%ä¸¢åŒ…ç‡ï¼‰
â”œâ”€ ç½‘ç»œä¸­æ–­æ¨¡æ‹Ÿï¼ˆå®Œå…¨æ–­ç½‘5ç§’ã€30ç§’ã€5åˆ†é’Ÿï¼‰
â””â”€ ç½‘ç»œåˆ†åŒºæ¨¡æ‹Ÿï¼ˆåº”ç”¨ä¸æ•°æ®åº“ç½‘ç»œéš”ç¦»ï¼‰

æ•°æ®åº“ç±»æ•…éšœï¼š
â”œâ”€ æ•°æ®åº“æœåŠ¡åœæ­¢ï¼ˆæ­£å¸¸åœæ­¢ã€å¼ºåˆ¶æ€è¿›ç¨‹ï¼‰
â”œâ”€ æ•°æ®åº“é‡å¯ï¼ˆå¿«é€Ÿé‡å¯ã€ç¼“æ…¢é‡å¯ï¼‰
â”œâ”€ æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼ˆCPU100%ã€å†…å­˜ä¸è¶³ï¼‰
â””â”€ æ•°æ®åº“è¿æ¥æ•°è¾¾åˆ°ä¸Šé™

åº”ç”¨ç±»æ•…éšœï¼š
â”œâ”€ è¿æ¥æ± è€—å°½ï¼ˆæ‰€æœ‰è¿æ¥è¢«å ç”¨ï¼‰
â”œâ”€ è¿æ¥æ³„æ¼ï¼ˆè¿æ¥ä¸é‡Šæ”¾ï¼‰
â”œâ”€ åº”ç”¨æœåŠ¡å™¨é‡å¯
â””â”€ JVMå†…å­˜ä¸è¶³
```

### 9.2 æ•…éšœæ¨¡æ‹Ÿå·¥å…·


**ç½‘ç»œæ•…éšœæ¨¡æ‹Ÿå™¨**ï¼š
```java
public class NetworkFaultSimulator {
    
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    public static void simulateNetworkDelay(long delayMs) {
        try {
            System.out.println("ğŸŒ æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ: " + delayMs + "ms");
            Thread.sleep(delayMs);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    // æ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…
    public static boolean simulatePacketLoss(double lossRate) {
        boolean isPacketLost = Math.random() < lossRate;
        if (isPacketLost) {
            System.out.println("ğŸ“¦ æ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…");
            return true;
        }
        return false;
    }
    
    // æ¨¡æ‹Ÿè¿æ¥è¶…æ—¶
    public static void simulateConnectionTimeout() throws SQLException {
        System.out.println("â° æ¨¡æ‹Ÿè¿æ¥è¶…æ—¶");
        throw new SQLException("Connection timed out", "08001");
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class FaultTestDataSource implements DataSource {
    private final DataSource realDataSource;
    private double faultRate = 0.1; // 10%çš„æ•…éšœç‡
    
    public FaultTestDataSource(DataSource realDataSource) {
        this.realDataSource = realDataSource;
    }
    
    @Override
    public Connection getConnection() throws SQLException {
        // éšæœºè§¦å‘æ•…éšœ
        if (Math.random() < faultRate) {
            NetworkFaultSimulator.simulateConnectionTimeout();
        }
        
        return realDataSource.getConnection();
    }
}
```

### 9.3 æ•…éšœæ¼”ç»ƒè„šæœ¬


**è‡ªåŠ¨åŒ–æ¼”ç»ƒç¨‹åº**ï¼š
```java
public class FaultDrillExecutor {
    private final DataSource dataSource;
    private final PerformanceMonitor monitor = new PerformanceMonitor();
    
    public FaultDrillExecutor(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    // æ‰§è¡Œè¿æ¥æ± è€—å°½æ¼”ç»ƒ
    public void drillConnectionPoolExhaustion() {
        System.out.println("ğŸ­ å¼€å§‹è¿æ¥æ± è€—å°½æ¼”ç»ƒ");
        
        List<Connection> connections = new ArrayList<>();
        
        try {
            // è·å–æ‰€æœ‰å¯ç”¨è¿æ¥
            while (true) {
                try {
                    Connection conn = dataSource.getConnection();
                    connections.add(conn);
                    System.out.println("ğŸ“Œ è·å–è¿æ¥ " + connections.size());
                    
                    // æ¨¡æ‹Ÿè¿æ¥è¢«é•¿æ—¶é—´å ç”¨
                    Thread.sleep(100);
                    
                } catch (SQLException e) {
                    System.out.println("âŒ è¿æ¥æ± å·²è€—å°½: " + e.getMessage());
                    break;
                }
            }
            
            // æµ‹è¯•æ–°è¯·æ±‚çš„å¤„ç†
            testNewRequestsWhenPoolExhausted();
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            
        } finally {
            // é‡Šæ”¾æ‰€æœ‰è¿æ¥
            System.out.println("ğŸ”„ é‡Šæ”¾æ‰€æœ‰è¿æ¥");
            for (Connection conn : connections) {
                try {
                    conn.close();
                } catch (SQLException e) {
                    // å¿½ç•¥å…³é—­å¼‚å¸¸
                }
            }
        }
    }
    
    private void testNewRequestsWhenPoolExhausted() {
        System.out.println("ğŸ§ª æµ‹è¯•è¿æ¥æ± è€—å°½æ—¶çš„æ–°è¯·æ±‚å¤„ç†");
        
        try (Connection conn = dataSource.getConnection()) {
            System.out.println("âŒ æ„å¤–ï¼šä»èƒ½è·å–åˆ°è¿æ¥");
        } catch (SQLException e) {
            System.out.println("âœ… é¢„æœŸï¼šæ— æ³•è·å–è¿æ¥ - " + e.getMessage());
        }
    }
    
    // æ‰§è¡Œæ•°æ®åº“é‡å¯æ¼”ç»ƒ
    public void drillDatabaseRestart() {
        System.out.println("ğŸ­ å¼€å§‹æ•°æ®åº“é‡å¯æ¼”ç»ƒ");
        
        // æ­¥éª¤1ï¼šè®°å½•é‡å¯å‰çŠ¶æ€
        testConnectionBeforeRestart();
        
        // æ­¥éª¤2ï¼šæ¨¡æ‹Ÿæ•°æ®åº“é‡å¯ï¼ˆéœ€è¦æ‰‹åŠ¨é‡å¯æ•°æ®åº“ï¼‰
        System.out.println("â¸ï¸ è¯·æ‰‹åŠ¨é‡å¯æ•°æ®åº“ï¼Œç„¶åæŒ‰å›è½¦ç»§ç»­...");
        try {
            System.in.read();
        } catch (IOException e) {
            // å¿½ç•¥
        }
        
        // æ­¥éª¤3ï¼šæµ‹è¯•é‡å¯åæ¢å¤
        testRecoveryAfterRestart();
    }
    
    private void testConnectionBeforeRestart() {
        try (Connection conn = dataSource.getConnection()) {
            PreparedStatement ps = conn.prepareStatement("SELECT NOW()");
            ResultSet rs = ps.executeQuery();
            if (rs.next()) {
                System.out.println("âœ… é‡å¯å‰è¿æ¥æ­£å¸¸ï¼Œæ—¶é—´: " + rs.getTimestamp(1));
            }
        } catch (SQLException e) {
            System.out.println("âŒ é‡å¯å‰è¿æ¥å¼‚å¸¸: " + e.getMessage());
        }
    }
    
    private void testRecoveryAfterRestart() {
        System.out.println("ğŸ”„ æµ‹è¯•æ•°æ®åº“é‡å¯åçš„æ¢å¤æƒ…å†µ");
        
        for (int i = 1; i <= 10; i++) {
            try (Connection conn = dataSource.getConnection()) {
                PreparedStatement ps = conn.prepareStatement("SELECT NOW()");
                ResultSet rs = ps.executeQuery();
                if (rs.next()) {
                    System.out.println("âœ… å°è¯• " + i + " æˆåŠŸï¼Œæ—¶é—´: " + rs.getTimestamp(1));
                    break;
                }
            } catch (SQLException e) {
                System.out.println("âŒ å°è¯• " + i + " å¤±è´¥: " + e.getMessage());
                
                // ç­‰å¾…2ç§’åé‡è¯•
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


**ğŸ”¸ æ•…éšœç±»å‹ç†è§£**
```
è¿æ¥æ•…éšœï¼šè¿æ¥ä¸­æ–­ã€è¶…æ—¶ã€æ³„æ¼
æ± å­æ•…éšœï¼šè¿æ¥è€—å°½ã€é…ç½®ä¸å½“
ç½‘ç»œæ•…éšœï¼šå»¶è¿Ÿã€ä¸¢åŒ…ã€åˆ†åŒº
æ•°æ®åº“æ•…éšœï¼šå®•æœºã€é‡å¯ã€è´Ÿè½½é«˜
```

**ğŸ”¸ æ£€æµ‹æœºåˆ¶**
```
å¿ƒè·³æ£€æµ‹ï¼šå®šæœŸéªŒè¯è¿æ¥å¯ç”¨æ€§
å¥åº·æ£€æŸ¥ï¼šå¤šå±‚æ¬¡æ£€æŸ¥è¿æ¥çŠ¶æ€
æ€§èƒ½ç›‘æ§ï¼šå“åº”æ—¶é—´ã€é”™è¯¯ç‡è·Ÿè¸ª
æ•…éšœé¢„è­¦ï¼šé˜ˆå€¼å‘Šè­¦ã€è¶‹åŠ¿åˆ†æ
```

**ğŸ”¸ æ¢å¤ç­–ç•¥**
```
è‡ªåŠ¨é‡è¿ï¼šæŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
è¿æ¥æ± é‡å»ºï¼šæ¸…ç†å¤±æ•ˆè¿æ¥
ç†”æ–­ä¿æŠ¤ï¼šé¿å…æ•…éšœæ‰©æ•£
æ•…éšœè½¬ç§»ï¼šä¸»å¤‡åˆ‡æ¢æœºåˆ¶
```

### 10.2 æœ€ä½³å®è·µæŒ‡å¯¼


**ğŸ¯ é¢„é˜²æªæ–½**
```
è¿æ¥æ± å¤§å°åˆç†é…ç½®ï¼š
â€¢ åŸºäºä¸šåŠ¡è´Ÿè½½å’Œæ•°æ®åº“æ€§èƒ½
â€¢ é¢„ç•™ä¸€å®šçš„ç¼“å†²ç©ºé—´
â€¢ å®šæœŸç›‘æ§å’Œè°ƒæ•´

è¶…æ—¶å‚æ•°è®¾ç½®ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼š3-10ç§’
â€¢ æŸ¥è¯¢è¶…æ—¶ï¼š30ç§’-2åˆ†é’Ÿ
â€¢ ç©ºé—²è¶…æ—¶ï¼š5-30åˆ†é’Ÿ

å¥åº·æ£€æŸ¥é…ç½®ï¼š
â€¢ æ£€æŸ¥é—´éš”ï¼š30ç§’-5åˆ†é’Ÿ
â€¢ æ£€æŸ¥æŸ¥è¯¢ï¼šSELECT 1
â€¢ å¤±è´¥é˜ˆå€¼ï¼šè¿ç»­3-5æ¬¡
```

**ğŸ› ï¸ æ•…éšœå¤„ç†**
```
å¿«é€Ÿæ£€æµ‹ï¼š
â€¢ å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
â€¢ è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
â€¢ è‡ªåŠ¨åŒ–æ•…éšœæ£€æµ‹

å¿«é€Ÿæ¢å¤ï¼š
â€¢ è‡ªåŠ¨é‡è¿æœºåˆ¶
â€¢ è¿æ¥æ± é¢„çƒ­
â€¢ æ•…éšœè½¬ç§»èƒ½åŠ›

å½±å“æ§åˆ¶ï¼š
â€¢ ç†”æ–­å™¨ä¿æŠ¤
â€¢ é™çº§æœåŠ¡ç­–ç•¥
â€¢ è¯·æ±‚é™æµæœºåˆ¶
```

### 10.3 æ•…éšœå¤„ç†æ£€æŸ¥æ¸…å•


**ğŸ“‹ æ—¥å¸¸è¿ç»´æ£€æŸ¥**
- [ ] è¿æ¥æ± ä½¿ç”¨ç‡æ˜¯å¦æ­£å¸¸ï¼ˆ< 80%ï¼‰
- [ ] å¹³å‡å“åº”æ—¶é—´æ˜¯å¦åœ¨é¢„æœŸèŒƒå›´å†…
- [ ] é”™è¯¯ç‡æ˜¯å¦åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ< 1%ï¼‰
- [ ] è¿æ¥æ³„æ¼æ£€æµ‹æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] å¥åº·æ£€æŸ¥æ˜¯å¦æŒ‰è®¡åˆ’æ‰§è¡Œ

**ğŸš¨ æ•…éšœåº”æ€¥å¤„ç†**
- [ ] ç¡®è®¤æ•…éšœèŒƒå›´å’Œå½±å“ç¨‹åº¦
- [ ] æ£€æŸ¥è¿æ¥æ± çŠ¶æ€å’Œé…ç½®
- [ ] éªŒè¯æ•°æ®åº“æœåŠ¡çŠ¶æ€
- [ ] æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
- [ ] æ‰§è¡Œæ•…éšœæ¢å¤æ­¥éª¤
- [ ] ç›‘æ§æ¢å¤æ•ˆæœ

**ğŸ“ˆ æ•…éšœåä¼˜åŒ–**
- [ ] åˆ†ææ•…éšœæ ¹æœ¬åŸå› 
- [ ] è¯„ä¼°ç°æœ‰ç›‘æ§å’Œå‘Šè­¦
- [ ] ä¼˜åŒ–è¿æ¥æ± é…ç½®
- [ ] æ”¹è¿›æ•…éšœæ£€æµ‹æœºåˆ¶
- [ ] æ›´æ–°æ•…éšœå¤„ç†æµç¨‹

### 10.4 è®°å¿†è¦ç‚¹


**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
```
è¿æ¥æ± æ•…éšœè¦ä¸‰é˜²ï¼š
â€¢ é˜²è€—å°½ï¼šåˆç†é…ç½®è¿æ¥æ•°
â€¢ é˜²æ³„æ¼ï¼šåŠæ—¶é‡Šæ”¾è¿æ¥
â€¢ é˜²ä¸­æ–­ï¼šå¥åº·æ£€æŸ¥æœºåˆ¶

æ•…éšœæ¢å¤ä¸‰æ­¥èµ°ï¼š
â€¢ å¿«é€Ÿæ£€æµ‹ï¼šå®æ—¶ç›‘æ§å‘Šè­¦
â€¢ è‡ªåŠ¨å¤„ç†ï¼šé‡è¿ç†”æ–­è½¬ç§»
â€¢ å½±å“æ§åˆ¶ï¼šé™çº§é™æµä¿æŠ¤
```

**ğŸ’¡ å®æˆ˜ç»éªŒ**
- è¿æ¥æ± å¤§å°ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè¦æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
- å¥åº·æ£€æŸ¥ä¸èƒ½å¤ªé¢‘ç¹ï¼Œä¼šå¢åŠ æ•°æ®åº“è´Ÿæ‹…
- æ•…éšœæ¼”ç»ƒå¾ˆé‡è¦ï¼Œèƒ½æå‰å‘ç°é—®é¢˜
- ç›‘æ§å’Œå‘Šè­¦æ˜¯æ•…éšœå¤„ç†çš„åŸºç¡€
- è‡ªåŠ¨åŒ–ç¨‹åº¦è¶Šé«˜ï¼Œæ•…éšœæ¢å¤è¶Šå¿«

**æ ¸å¿ƒç†å¿µ**ï¼šè¿æ¥æ± æ•…éšœå¤„ç†çš„ç›®æ ‡æ˜¯"å¿«é€Ÿæ£€æµ‹ã€è‡ªåŠ¨æ¢å¤ã€å½±å“æœ€å°"ï¼Œé€šè¿‡å®Œå–„çš„ç›‘æ§ã€æ£€æµ‹å’Œæ¢å¤æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®åº“è¿æ¥çš„ç¨³å®šæ€§å’Œåº”ç”¨çš„å¯ç”¨æ€§ã€‚