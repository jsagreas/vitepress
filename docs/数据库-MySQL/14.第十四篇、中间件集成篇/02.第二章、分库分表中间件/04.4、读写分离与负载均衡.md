---
title: 4ã€è¯»å†™åˆ†ç¦»ä¸è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ](#1-è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ)
2. [è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£](#2-è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£)
3. [ä¸»ä»å»¶è¿Ÿå¤„ç†ç­–ç•¥](#3-ä¸»ä»å»¶è¿Ÿå¤„ç†ç­–ç•¥)
4. [è¯»å†™åˆ†ç¦»é…ç½®å®æˆ˜](#4-è¯»å†™åˆ†ç¦»é…ç½®å®æˆ˜)
5. [æ•…éšœåˆ‡æ¢ä¸å¼‚å¸¸å¤„ç†](#5-æ•…éšœåˆ‡æ¢ä¸å¼‚å¸¸å¤„ç†)
6. [äº‹åŠ¡å¤„ç†ä¸ä¸€è‡´æ€§æ§åˆ¶](#6-äº‹åŠ¡å¤„ç†ä¸ä¸€è‡´æ€§æ§åˆ¶)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»


**ğŸ“‹ é€šä¿—è§£é‡Š**
è¯»å†™åˆ†ç¦»å°±åƒä¸€ä¸ªå›¾ä¹¦é¦†çš„ç®¡ç†æ–¹å¼ï¼š
- **å†™æ“ä½œ**ï¼šåªæœ‰ç®¡ç†å‘˜èƒ½å¾€å›¾ä¹¦é¦†æ·»åŠ æ–°ä¹¦ã€ä¿®æ”¹ä¹¦ç±ä¿¡æ¯ï¼ˆä¸»åº“ï¼‰
- **è¯»æ“ä½œ**ï¼šæ™®é€šè¯»è€…å¯ä»¥ä»å¤šä¸ªé˜…è§ˆå®¤å€Ÿé˜…å›¾ä¹¦ï¼ˆä»åº“ï¼‰
- **ç›®çš„**ï¼šè®©ç®¡ç†å‘˜ä¸“å¿ƒç®¡ç†ï¼Œè¯»è€…åˆ†æ•£åˆ°ä¸åŒé˜…è§ˆå®¤ï¼Œé¿å…æ‹¥æŒ¤

```
åº”ç”¨ç³»ç»Ÿçš„è¯·æ±‚åˆ†é…ï¼š
å†™è¯·æ±‚ï¼ˆå¢åˆ æ”¹ï¼‰ â†’ ä¸»æ•°æ®åº“ â†’ å¤„ç†å†™æ“ä½œ
è¯»è¯·æ±‚ï¼ˆæŸ¥è¯¢ï¼‰   â†’ ä»æ•°æ®åº“ â†’ å¤„ç†è¯»æ“ä½œ
```

### 1.2 è¯»å†™åˆ†ç¦»çš„æ ¸å¿ƒä»·å€¼


**ğŸ”¸ æ€§èƒ½æå‡åŸç†**
```
ä¼ ç»Ÿå•åº“æ¨¡å¼ï¼š
æ‰€æœ‰è¯·æ±‚ â†’ ä¸»åº“ â†’ å®¹æ˜“æˆä¸ºç“¶é¢ˆ

è¯»å†™åˆ†ç¦»æ¨¡å¼ï¼š
å†™è¯·æ±‚(20%) â†’ ä¸»åº“ â†’ ä¸“æ³¨å¤„ç†å†™æ“ä½œ
è¯»è¯·æ±‚(80%) â†’ ä»åº“ â†’ åˆ†æ•£è¯»å‹åŠ›
```

**ğŸ’¡ å®é™…æ•ˆæœ**
- **å‡è½»ä¸»åº“å‹åŠ›**ï¼šä¸»åº“åªå¤„ç†å†™æ“ä½œï¼Œæ€§èƒ½æ›´ç¨³å®š
- **æå‡è¯»æ€§èƒ½**ï¼šå¤šä¸ªä»åº“å¹¶è¡Œå¤„ç†è¯»è¯·æ±‚
- **å¢å¼ºå¯ç”¨æ€§**ï¼šä»åº“æ•…éšœä¸å½±å“å†™æ“ä½œï¼Œä¸»åº“æ•…éšœä»å¯è¯»å–

### 1.3 è¯»å†™åˆ†ç¦»æ¶æ„å›¾


```
                    åº”ç”¨æœåŠ¡å™¨
                        |
                   è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶
                    /        \
            å†™è¯·æ±‚ /            \ è¯»è¯·æ±‚
               /                \
           ä¸»æ•°æ®åº“          è´Ÿè½½å‡è¡¡å™¨
              |              /    |    \
              |         ä»åº“1   ä»åº“2  ä»åº“3
              |          /       |       \
              â””â”€â”€â”€â”€â”€æ•°æ®åŒæ­¥â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš–ï¸ è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£


### 2.1 æƒé‡è½®è¯¢ç®—æ³•ï¼ˆWeighted Round Robinï¼‰


**ğŸ”¸ ç®—æ³•åŸç†**
æƒé‡è½®è¯¢å°±åƒæŒ‰èƒ½åŠ›åˆ†é…å·¥ä½œä»»åŠ¡ï¼šèƒ½åŠ›å¼ºçš„å‘˜å·¥åˆ†é…æ›´å¤šä»»åŠ¡ï¼Œèƒ½åŠ›å¼±çš„åˆ†é…è¾ƒå°‘ä»»åŠ¡ã€‚

**ğŸ’» é…ç½®ç¤ºä¾‹**
```xml
<!-- MyCATè¯»å†™åˆ†ç¦»é…ç½® -->
<dataHost name="mysql_cluster" maxCon="1000" minCon="10" 
          balance="1" writeType="0">
    
    <!-- ä¸»åº“é…ç½® -->
    <writeHost host="master" url="192.168.1.10:3306" 
               user="root" password="123456">
        
        <!-- ä»åº“é…ç½®withæƒé‡ -->
        <readHost host="slave1" url="192.168.1.11:3306" 
                  user="root" password="123456" weight="100"/>
        <readHost host="slave2" url="192.168.1.12:3306" 
                  user="root" password="123456" weight="200"/>
        <readHost host="slave3" url="192.168.1.13:3306" 
                  user="root" password="123456" weight="150"/>
    </writeHost>
</dataHost>
```

**ğŸ“Š æƒé‡åˆ†é…è®¡ç®—**
```
æ€»æƒé‡ = 100 + 200 + 150 = 450

slave1 åˆ†é…æ¯”ä¾‹ = 100/450 â‰ˆ 22.2%
slave2 åˆ†é…æ¯”ä¾‹ = 200/450 â‰ˆ 44.4%  
slave3 åˆ†é…æ¯”ä¾‹ = 150/450 â‰ˆ 33.3%

å‡è®¾100ä¸ªè¯»è¯·æ±‚ï¼š
slave1 å¤„ç†çº¦22ä¸ªè¯·æ±‚
slave2 å¤„ç†çº¦44ä¸ªè¯·æ±‚
slave3 å¤„ç†çº¦33ä¸ªè¯·æ±‚
```

### 2.2 æœ€å°‘è¿æ¥æ•°ç®—æ³•ï¼ˆLeast Connectionsï¼‰


**ğŸ”¸ å·¥ä½œæœºåˆ¶**
å°±åƒé“¶è¡Œæ’é˜Ÿç³»ç»Ÿï¼šæ€»æ˜¯è®©é¡¾å®¢åˆ°äººæ•°æœ€å°‘çš„çª—å£æ’é˜Ÿï¼Œç¡®ä¿è´Ÿè½½æœ€å‡è¡¡ã€‚

**ğŸ’¡ ç®—æ³•é€»è¾‘**
```
å½“å‰è¿æ¥æ•°ç»Ÿè®¡ï¼š
slave1: 15ä¸ªæ´»è·ƒè¿æ¥
slave2: 23ä¸ªæ´»è·ƒè¿æ¥  
slave3: 8ä¸ªæ´»è·ƒè¿æ¥

æ–°çš„è¯»è¯·æ±‚åˆ°æ¥ â†’ é€‰æ‹©slave3ï¼ˆè¿æ¥æ•°æœ€å°‘ï¼‰
```

**âš¡ é€‚ç”¨åœºæ™¯**
- **é•¿è¿æ¥åº”ç”¨**ï¼šWebSocketã€æŒä¹…åŒ–è¿æ¥
- **å¤„ç†æ—¶é—´å·®å¼‚å¤§**ï¼šå¤æ‚æŸ¥è¯¢ä¸ç®€å•æŸ¥è¯¢æ··åˆ
- **æœåŠ¡å™¨æ€§èƒ½å·®å¼‚**ï¼šç¡¬ä»¶é…ç½®ä¸åŒçš„ä»åº“

### 2.3 å“åº”æ—¶é—´åŠ æƒç®—æ³•ï¼ˆResponse Time Weightedï¼‰


**ğŸ”¸ ç®—æ³•æ€æƒ³**
ç±»ä¼¼å¿«é€’é…é€ï¼šå“åº”é€Ÿåº¦å¿«çš„é…é€å‘˜åˆ†é…æ›´å¤šè®¢å•ï¼Œé€Ÿåº¦æ…¢çš„åˆ†é…è¾ƒå°‘è®¢å•ã€‚

**ğŸ“ˆ å“åº”æ—¶é—´è®¡ç®—**
```java
// ç®€åŒ–çš„å“åº”æ—¶é—´åŠ æƒç®—æ³•
public class ResponseTimeWeighted {
    private Map<String, Long> avgResponseTime = new HashMap<>();
    
    public String selectReadHost(List<String> hosts) {
        String bestHost = null;
        long minTime = Long.MAX_VALUE;
        
        for (String host : hosts) {
            long responseTime = avgResponseTime.get(host);
            if (responseTime < minTime) {
                minTime = responseTime;
                bestHost = host;
            }
        }
        return bestHost;
    }
}
```

### 2.4 balanceå±æ€§è¯¦è§£


**ğŸ“‹ balanceå±æ€§è¯´æ˜**
```
balance="0": ä¸å¼€å¯è¯»å†™åˆ†ç¦»ï¼Œæ‰€æœ‰è¯»å†™éƒ½å‘é€åˆ°writeHost
balance="1": å…¨éƒ¨readHostä¸writeHostéƒ½å‚ä¸è¯»è´Ÿè½½å‡è¡¡
balance="2": æ‰€æœ‰è¯»è¯·æ±‚éšæœºå‘é€åˆ°readHost
balance="3": æ‰€æœ‰è¯»è¯·æ±‚å‘é€åˆ°writeHostå¯¹åº”çš„readHost
```

**ğŸ¯ é€‰æ‹©å»ºè®®**
| balanceå€¼ | **ä½¿ç”¨åœºæ™¯** | **ç‰¹ç‚¹** | **æ¨èåº¦** |
|----------|-------------|---------|-----------|
| `0` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` | `å…³é—­è¯»å†™åˆ†ç¦»` | `â­â­` |
| `1` | `ç”Ÿäº§ç¯å¢ƒ` | `è¯»å†™å®Œå…¨åˆ†ç¦»ï¼Œæ€§èƒ½æœ€ä½³` | `â­â­â­â­â­` |
| `2` | `ç®€å•åœºæ™¯` | `åªç”¨ä»åº“è¯»å–` | `â­â­â­` |
| `3` | `ç‰¹æ®Šéœ€æ±‚` | `è¯»å†™éƒ½å¯èƒ½ç”¨ä¸»åº“` | `â­â­` |

---

## 3. â° ä¸»ä»å»¶è¿Ÿå¤„ç†ç­–ç•¥


### 3.1 ä¸»ä»å»¶è¿Ÿäº§ç”ŸåŸå› 


**ğŸ”¸ å»¶è¿Ÿäº§ç”Ÿæœºåˆ¶**
```
ä¸»ä»åŒæ­¥æµç¨‹ï¼š
1. ä¸»åº“æ‰§è¡Œå†™æ“ä½œ â†’ å†™å…¥binlog
2. ä»åº“è¯»å–binlog â†’ å†™å…¥relay log  
3. ä»åº“æ‰§è¡Œrelay log â†’ æ›´æ–°æ•°æ®

å»¶è¿Ÿç‚¹åˆ†æï¼š
- ç½‘ç»œä¼ è¾“å»¶è¿Ÿï¼šä¸»åº“â†’ä»åº“çš„ç½‘ç»œè€—æ—¶
- ä»åº“å¤„ç†å»¶è¿Ÿï¼šä»åº“æ‰§è¡ŒSQLçš„æ—¶é—´å·®
- è´Ÿè½½å½±å“å»¶è¿Ÿï¼šä»åº“è´Ÿè½½é«˜æ—¶å¤„ç†å˜æ…¢
```

**ğŸ“Š å»¶è¿Ÿæ—¶é—´èŒƒå›´**
```
æ­£å¸¸æƒ…å†µï¼š0-100ms
é«˜è´Ÿè½½ï¼š100ms-1ç§’
ç½‘ç»œé—®é¢˜ï¼š1ç§’-æ•°ç§’
ä¸¥é‡æ•…éšœï¼šæ•°åˆ†é’Ÿæˆ–æ›´é•¿
```

### 3.2 ä¸»ä»å»¶è¿Ÿæ£€æµ‹æœºåˆ¶


**ğŸ’» å»¶è¿Ÿæ£€æµ‹é…ç½®**
```xml
<!-- MyCATå»¶è¿Ÿæ£€æµ‹é…ç½® -->
<dataHost name="mysql_cluster" maxCon="1000" minCon="10" 
          balance="1" writeType="0" 
          slaveThreshold="100">  <!-- å»¶è¿Ÿé˜ˆå€¼100ms -->
    
    <heartbeat>select user()</heartbeat>  <!-- å¿ƒè·³æ£€æµ‹SQL -->
    
    <writeHost host="master" url="192.168.1.10:3306">
        <readHost host="slave1" url="192.168.1.11:3306"/>
        <readHost host="slave2" url="192.168.1.12:3306"/>
    </writeHost>
</dataHost>
```

**ğŸ” å»¶è¿Ÿæ£€æµ‹åŸç†**
```
å¿ƒè·³æ£€æµ‹æœºåˆ¶ï¼š
1. ä¸»åº“å†™å…¥æ—¶é—´æˆ³ â†’ timestampè¡¨
2. ä»åº“è¯»å–timestamp â†’ è®¡ç®—æ—¶é—´å·®
3. è¶…è¿‡é˜ˆå€¼ â†’ æš‚æ—¶å‰”é™¤è¯¥ä»åº“
4. å»¶è¿Ÿæ¢å¤ â†’ é‡æ–°åŠ å…¥è´Ÿè½½å‡è¡¡
```

### 3.3 å¼ºåˆ¶è¯»ä¸»åº“ç­–ç•¥


**ğŸ¯ å¼ºåˆ¶è¯»ä¸»æ³¨è§£**
```java
// ä½¿ç”¨æ³¨è§£å¼ºåˆ¶è¯»ä¸»åº“
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    // æ™®é€šæŸ¥è¯¢ï¼šèµ°ä»åº“
    public Order getOrderById(Long id) {
        return orderMapper.selectById(id);
    }
    
    // å¼ºåˆ¶è¯»ä¸»åº“ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    @ReadDataSource("master")  // è‡ªå®šä¹‰æ³¨è§£
    public Order getOrderAfterCreate(Long id) {
        return orderMapper.selectById(id);
    }
    
    // ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹
    @Transactional
    public Long createOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆå†™ä¸»åº“ï¼‰
        orderMapper.insert(order);
        
        // 2. ç«‹å³æŸ¥è¯¢è®¢å•ï¼ˆå¼ºåˆ¶è¯»ä¸»åº“ï¼Œé¿å…ä¸»ä»å»¶è¿Ÿï¼‰
        return getOrderAfterCreate(order.getId()).getId();
    }
}
```

**âš¡ SQLçº§åˆ«æ§åˆ¶**
```java
// åœ¨SQLä¸­æ·»åŠ hintå¼ºåˆ¶è·¯ç”±
public interface OrderMapper {
    
    // æ™®é€šæŸ¥è¯¢ï¼šè‡ªåŠ¨è·¯ç”±åˆ°ä»åº“
    @Select("SELECT * FROM orders WHERE id = #{id}")
    Order selectById(Long id);
    
    // å¼ºåˆ¶ä¸»åº“æŸ¥è¯¢ï¼šæ·»åŠ hint
    @Select("/*master*/ SELECT * FROM orders WHERE id = #{id}")
    Order selectByIdFromMaster(Long id);
}
```

### 3.4 å»¶è¿Ÿè¡¥å¿æœºåˆ¶


**ğŸ’¡ æ—¶é—´çª—å£ç­–ç•¥**
```java
// è¯»å†™åˆ†ç¦»å»¶è¿Ÿè¡¥å¿
@Component
public class ReadWriteCompensation {
    
    private Cache<String, Long> writeOperationCache = 
        CacheBuilder.newBuilder()
            .expireAfterWrite(5, TimeUnit.SECONDS)  // 5ç§’çª—å£æœŸ
            .build();
    
    public void recordWriteOperation(String key) {
        writeOperationCache.put(key, System.currentTimeMillis());
    }
    
    public boolean shouldReadFromMaster(String key) {
        Long writeTime = writeOperationCache.getIfPresent(key);
        return writeTime != null;  // 5ç§’å†…æœ‰å†™æ“ä½œï¼Œå¼ºåˆ¶è¯»ä¸»åº“
    }
}
```

---

## 4. ğŸ”§ è¯»å†™åˆ†ç¦»é…ç½®å®æˆ˜


### 4.1 MyCATè¯»å†™åˆ†ç¦»é…ç½®


**ğŸ“„ schema.xmlé…ç½®**
```xml
<?xml version="1.0"?>
<!DOCTYPE mycat:schema SYSTEM "schema.dtd">
<mycat:schema xmlns:mycat="http://io.mycat/">
    
    <!-- é€»è¾‘åº“é…ç½® -->
    <schema name="test_db" checkSQLschema="false" sqlMaxLimit="100">
        <table name="user" dataNode="dn1" />
        <table name="order" dataNode="dn1" />
    </schema>
    
    <!-- æ•°æ®èŠ‚ç‚¹é…ç½® -->
    <dataNode name="dn1" dataHost="mysql_ha" database="test_db" />
    
    <!-- æ•°æ®ä¸»æœºé…ç½®ï¼šè¯»å†™åˆ†ç¦»æ ¸å¿ƒ -->
    <dataHost name="mysql_ha" maxCon="1000" minCon="10" 
              balance="1" writeType="0" dbType="mysql" 
              dbDriver="native" switchType="1">
        
        <!-- å¿ƒè·³æ£€æµ‹ -->
        <heartbeat>select user()</heartbeat>
        
        <!-- ä¸»åº“é…ç½® -->
        <writeHost host="M1" url="192.168.1.10:3306" 
                   user="root" password="123456">
            
            <!-- ä»åº“é…ç½® -->
            <readHost host="S1" url="192.168.1.11:3306" 
                      user="root" password="123456" weight="100"/>
            <readHost host="S2" url="192.168.1.12:3306" 
                      user="root" password="123456" weight="200"/>
        </writeHost>
        
        <!-- å¤‡ç”¨ä¸»åº“é…ç½® -->
        <writeHost host="M2" url="192.168.1.20:3306" 
                   user="root" password="123456">
            <readHost host="S3" url="192.168.1.21:3306" 
                      user="root" password="123456" weight="100"/>
        </writeHost>
    </dataHost>
</mycat:schema>
```

### 4.2 Spring Booté›†æˆé…ç½®


**ğŸ’» å¤šæ•°æ®æºé…ç½®**
```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DruidDataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DruidDataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource routingDataSource() {
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        
        DynamicDataSource routing = new DynamicDataSource();
        routing.setTargetDataSources(dataSourceMap);
        routing.setDefaultTargetDataSource(masterDataSource());
        return routing;
    }
}
```

**ğŸ¯ åŠ¨æ€æ•°æ®æºåˆ‡æ¢**
```java
// åŠ¨æ€æ•°æ®æºå®ç°
public class DynamicDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceContextHolder.getDataSourceType();
    }
}

// æ•°æ®æºä¸Šä¸‹æ–‡ç®¡ç†
public class DataSourceContextHolder {
    
    private static final ThreadLocal<String> CONTEXT = new ThreadLocal<>();
    
    public static void setDataSourceType(String dataSourceType) {
        CONTEXT.set(dataSourceType);
    }
    
    public static String getDataSourceType() {
        return CONTEXT.get();
    }
    
    public static void clearDataSourceType() {
        CONTEXT.remove();
    }
}
```

### 4.3 è¯»å†™åˆ†ç¦»æ‹¦æˆªå™¨


**ğŸ”§ AOPå®ç°è¯»å†™åˆ†ç¦»**
```java
@Aspect
@Component
public class DataSourceAspect {
    
    @Before("@annotation(readDataSource)")
    public void setReadDataSource(ReadDataSource readDataSource) {
        DataSourceContextHolder.setDataSourceType("slave");
    }
    
    @Before("execution(* *..*Service.save*(..)) || " +
            "execution(* *..*Service.update*(..)) || " +
            "execution(* *..*Service.delete*(..))")
    public void setWriteDataSource() {
        DataSourceContextHolder.setDataSourceType("master");
    }
    
    @After("@annotation(readDataSource) || " +
           "execution(* *..*Service.*(..))")
    public void clearDataSource() {
        DataSourceContextHolder.clearDataSourceType();
    }
}

// è¯»æ•°æ®æºæ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface ReadDataSource {
    String value() default "slave";
}
```

---

## 5. ğŸš¨ æ•…éšœåˆ‡æ¢ä¸å¼‚å¸¸å¤„ç†


### 5.1 è‡ªåŠ¨æ•…éšœåˆ‡æ¢ç­–ç•¥


**ğŸ”¸ switchTypeé…ç½®è¯´æ˜**
```
switchType="1": è‡ªåŠ¨åˆ‡æ¢
- ä¸»åº“æ•…éšœ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ä¸»åº“
- é€‚ç”¨äºåŒä¸»çƒ­å¤‡åœºæ™¯

switchType="-1": ä¸è‡ªåŠ¨åˆ‡æ¢  
- ä¸»åº“æ•…éšœ â†’ æ‰‹åŠ¨å¤„ç†
- é€‚ç”¨äºä¸¥æ ¼æ§åˆ¶çš„ç¯å¢ƒ

switchType="2": åŸºäºMySQLä¸»ä»çŠ¶æ€å†³å®šåˆ‡æ¢
- ç›‘æ§ä¸»ä»çŠ¶æ€ â†’ æ™ºèƒ½åˆ‡æ¢
- æœ€æ™ºèƒ½ä½†é…ç½®å¤æ‚
```

**âš¡ æ•…éšœåˆ‡æ¢æµç¨‹**
```
æ•…éšœæ£€æµ‹æµç¨‹ï¼š
1. å¿ƒè·³æ£€æµ‹å¤±è´¥ â†’ æ ‡è®°ä¸»åº“å¼‚å¸¸
2. é‡è¯•æœºåˆ¶ â†’ ç¡®è®¤æ•…éšœçŠ¶æ€  
3. è‡ªåŠ¨åˆ‡æ¢ â†’ æ¿€æ´»å¤‡ç”¨ä¸»åº“
4. é€šçŸ¥åº”ç”¨ â†’ æ›´æ–°è¿æ¥é…ç½®
5. æ•…éšœæ¢å¤ â†’ å¯é€‰æ‹©åˆ‡å›åŸä¸»åº“
```

### 5.2 ä»åº“å¼‚å¸¸å¤„ç†


**ğŸ“Š ä»åº“æ•…éšœå¤„ç†æœºåˆ¶**
```java
// ä»åº“å¼‚å¸¸å¤„ç†é…ç½®
public class SlaveExceptionHandler {
    
    private List<String> availableSlaves = new ArrayList<>();
    private Map<String, Integer> retryCount = new HashMap<>();
    
    public String selectAvailableSlave() {
        for (String slave : availableSlaves) {
            if (isSlaveHealthy(slave)) {
                return slave;
            } else {
                handleSlaveException(slave);
            }
        }
        return "master";  // æ‰€æœ‰ä»åº“éƒ½å¼‚å¸¸ï¼Œé™çº§åˆ°ä¸»åº“
    }
    
    private void handleSlaveException(String slave) {
        int count = retryCount.getOrDefault(slave, 0) + 1;
        retryCount.put(slave, count);
        
        if (count >= 3) {
            // è¿ç»­3æ¬¡å¤±è´¥ï¼Œæš‚æ—¶ç§»é™¤
            availableSlaves.remove(slave);
            scheduleSlaveRecoveryCheck(slave);
        }
    }
}
```

### 5.3 è¯»å†™åˆ†ç¦»å¼‚å¸¸é™çº§


**ğŸ›¡ï¸ å¼‚å¸¸é™çº§ç­–ç•¥**
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    // è¯»å–è®¢å•ä¿¡æ¯ï¼šå¸¦é™çº§å¤„ç†
    public Order getOrderById(Long id) {
        try {
            // å°è¯•ä»ä»åº“è¯»å–
            return orderMapper.selectById(id);
        } catch (DataAccessException e) {
            // ä»åº“å¼‚å¸¸ï¼Œé™çº§åˆ°ä¸»åº“
            log.warn("ä»åº“è®¿é—®å¼‚å¸¸ï¼Œé™çº§åˆ°ä¸»åº“: {}", e.getMessage());
            return getOrderFromMaster(id);
        }
    }
    
    @ReadDataSource("master")  // å¼ºåˆ¶è¯»ä¸»åº“
    private Order getOrderFromMaster(Long id) {
        return orderMapper.selectById(id);
    }
}
```

---

## 6. ğŸ’¼ äº‹åŠ¡å¤„ç†ä¸ä¸€è‡´æ€§æ§åˆ¶


### 6.1 äº‹åŠ¡ä¸­çš„è¯»å†™åˆ†ç¦»


**ğŸ”¸ äº‹åŠ¡å¤„ç†åŸåˆ™**
```
äº‹åŠ¡å†…è¯»å†™è§„åˆ™ï¼š
1. äº‹åŠ¡å¼€å§‹ â†’ æ‰€æœ‰æ“ä½œå¼ºåˆ¶èµ°ä¸»åº“
2. ä¿è¯ä¸€è‡´æ€§ â†’ è¯»å†™åœ¨åŒä¸€åº“è¿›è¡Œ
3. äº‹åŠ¡ç»“æŸ â†’ æ¢å¤æ­£å¸¸è¯»å†™åˆ†ç¦»
```

**ğŸ’» äº‹åŠ¡æ³¨è§£å¤„ç†**
```java
@Service
@Transactional
public class OrderService {
    
    // äº‹åŠ¡æ–¹æ³•ï¼šè‡ªåŠ¨èµ°ä¸»åº“
    @Transactional
    public void processOrder(Order order) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆä¸»åº“å†™å…¥ï¼‰
        orderMapper.insert(order);
        
        // 2. æ›´æ–°åº“å­˜ï¼ˆä¸»åº“å†™å…¥ï¼‰
        stockMapper.updateStock(order.getProductId(), order.getQuantity());
        
        // 3. æŸ¥è¯¢è®¢å•ï¼ˆäº‹åŠ¡å†…ï¼Œèµ°ä¸»åº“ä¿è¯ä¸€è‡´æ€§ï¼‰
        Order created = orderMapper.selectById(order.getId());
        
        // 4. åç»­ä¸šåŠ¡é€»è¾‘...
    }
    
    // åªè¯»äº‹åŠ¡ï¼šå¯ä»¥èµ°ä»åº“
    @Transactional(readOnly = true)
    public List<Order> getOrderList(Long userId) {
        return orderMapper.selectByUserId(userId);
    }
}
```

### 6.2 ä¸€è‡´æ€§çº§åˆ«æ§åˆ¶


**ğŸ“‹ ä¸€è‡´æ€§çº§åˆ«è¯´æ˜**
```
å¼ºä¸€è‡´æ€§ï¼š
- æ‰€æœ‰è¯»å†™éƒ½èµ°ä¸»åº“
- æ•°æ®ç»å¯¹ä¸€è‡´ï¼Œæ€§èƒ½è¾ƒä½

æœ€ç»ˆä¸€è‡´æ€§ï¼š
- å†™èµ°ä¸»åº“ï¼Œè¯»èµ°ä»åº“
- å¯èƒ½æœ‰çŸ­æš‚å»¶è¿Ÿï¼Œæ€§èƒ½æœ€ä½³

ä¼šè¯ä¸€è‡´æ€§ï¼š
- åŒä¸€ä¼šè¯å†…ä¿æŒä¸€è‡´
- å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
```

**ğŸ¯ ä¸€è‡´æ€§æ§åˆ¶å®ç°**
```java
@Component
public class ConsistencyController {
    
    // å¼ºä¸€è‡´æ€§ï¼šé‡è¦ä¸šåŠ¡æ“ä½œ
    @ReadDataSource("master")
    public Order getOrderForPayment(Long orderId) {
        return orderMapper.selectById(orderId);
    }
    
    // æœ€ç»ˆä¸€è‡´æ€§ï¼šæ™®é€šæŸ¥è¯¢
    public List<Order> getOrderHistory(Long userId) {
        return orderMapper.selectByUserId(userId);
    }
    
    // ä¼šè¯ä¸€è‡´æ€§ï¼šç”¨æˆ·ç›¸å…³æ“ä½œ
    public Order getOrderInSession(Long orderId, String sessionId) {
        if (hasRecentWrite(sessionId)) {
            return getOrderFromMaster(orderId);
        } else {
            return orderMapper.selectById(orderId);
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¯»å†™åˆ†ç¦»æœ¬è´¨ï¼šåˆ†ç¦»è¯»å†™è¯·æ±‚ï¼Œæå‡æ•°æ®åº“æ€§èƒ½
ğŸ”¸ è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šæƒé‡è½®è¯¢ã€æœ€å°‘è¿æ¥ã€å“åº”æ—¶é—´åŠ æƒ
ğŸ”¸ ä¸»ä»å»¶è¿Ÿå¤„ç†ï¼šæ£€æµ‹ã€è¡¥å¿ã€å¼ºåˆ¶è¯»ä¸»åº“ç­–ç•¥
ğŸ”¸ æ•…éšœåˆ‡æ¢æœºåˆ¶ï¼šè‡ªåŠ¨åˆ‡æ¢ã€å¼‚å¸¸é™çº§ã€æ¢å¤ç­–ç•¥
ğŸ”¸ äº‹åŠ¡ä¸€è‡´æ€§ï¼šäº‹åŠ¡å†…å¼ºåˆ¶ä¸»åº“ã€ä¸€è‡´æ€§çº§åˆ«æ§åˆ¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¯»å†™åˆ†ç¦»çš„ä»·å€¼**
```
æ€§èƒ½æå‡ï¼š
- ä¸»åº“ä¸“æ³¨å†™æ“ä½œï¼Œä»åº“å¤„ç†è¯»æ“ä½œ
- å¤šä»åº“å¹¶è¡Œå¤„ç†ï¼Œå¤§å¹…æå‡å¹¶å‘èƒ½åŠ›
- è¯»å†™æ¯”ä¾‹é€šå¸¸8:2ï¼Œæ”¶ç›Šæ˜æ˜¾

å¯ç”¨æ€§æå‡ï¼š
- ä¸»ä»åˆ†ç¦»ï¼Œæ•…éšœå½±å“èŒƒå›´å°
- å¤šä»åº“å†—ä½™ï¼Œå•ç‚¹æ•…éšœä¸å½±å“è¯»å–
- è‡ªåŠ¨åˆ‡æ¢æœºåˆ¶ï¼Œæ•…éšœæ¢å¤å¿«
```

**ğŸ”¹ ä¸»ä»å»¶è¿Ÿçš„å½±å“å’Œå¤„ç†**
```
å»¶è¿Ÿå½±å“ï¼š
- æ•°æ®ä¸ä¸€è‡´ï¼šè¯»å–åˆ°æ—§æ•°æ®
- ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼šä¾èµ–æœ€æ–°æ•°æ®çš„æ“ä½œ

å¤„ç†ç­–ç•¥ï¼š
- å¼ºåˆ¶è¯»ä¸»åº“ï¼šé‡è¦æ“ä½œç¡®ä¿ä¸€è‡´æ€§
- å»¶è¿Ÿæ£€æµ‹ï¼šè¶…æ—¶è‡ªåŠ¨å‰”é™¤æ…¢ä»åº“
- ä¸šåŠ¡å®¹å¿ï¼šå¯æ¥å—çŸ­æš‚ä¸ä¸€è‡´çš„åœºæ™¯
```

**ğŸ”¹ é…ç½®é€‰æ‹©åŸåˆ™**
```
balanceå±æ€§é€‰æ‹©ï¼š
- balance="1"ï¼šç”Ÿäº§ç¯å¢ƒé¦–é€‰
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚ç®—æ³•
- æƒé‡é…ç½®è¦è€ƒè™‘ç¡¬ä»¶å·®å¼‚

æ•…éšœåˆ‡æ¢é…ç½®ï¼š
- switchType="1"ï¼šè‡ªåŠ¨åˆ‡æ¢é€‚åˆå¤§å¤šæ•°åœºæ™¯
- é…ç½®å¤‡ç”¨ä¸»åº“æé«˜å¯ç”¨æ€§
- ç›‘æ§å‘Šè­¦æœºåˆ¶å¿…ä¸å¯å°‘
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‚ç”¨åœºæ™¯**
- **è¯»å¤šå†™å°‘**ï¼šç”µå•†å•†å“å±•ç¤ºã€æ–°é—»èµ„è®¯
- **æŸ¥è¯¢å‹åŠ›å¤§**ï¼šæŠ¥è¡¨ç³»ç»Ÿã€æ•°æ®åˆ†æ
- **é«˜å¯ç”¨è¦æ±‚**ï¼šæ ¸å¿ƒä¸šåŠ¡ç³»ç»Ÿ

**âš ï¸ æ³¨æ„äº‹é¡¹**
- **ä¸»ä»å»¶è¿Ÿ**ï¼šé‡è¦æ“ä½œè¦è€ƒè™‘ä¸€è‡´æ€§
- **äº‹åŠ¡å¤„ç†**ï¼šäº‹åŠ¡å†…æ“ä½œå¿…é¡»èµ°ä¸»åº“
- **ç›‘æ§å‘Šè­¦**ï¼šå»¶è¿Ÿã€æ•…éšœè¦åŠæ—¶å‘ç°

**ğŸ”§ æœ€ä½³å®è·µ**
- **æ¢¯åº¦é…ç½®**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½è®¾ç½®æƒé‡
- **é™çº§ç­–ç•¥**ï¼šä»åº“æ•…éšœæ—¶è‡ªåŠ¨é™çº§åˆ°ä¸»åº“
- **ä¸šåŠ¡éš”ç¦»**ï¼šä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒæ•°æ®æº

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¯»å†™åˆ†ç¦»æ ¸å¿ƒæ˜¯åˆ†ç¦»è¯»å†™å‹åŠ›ï¼Œæå‡æ€§èƒ½
- ä¸»ä»å»¶è¿Ÿæ˜¯æœ€å¤§æŒ‘æˆ˜ï¼Œéœ€è¦åˆç†çš„å¤„ç†ç­–ç•¥
- è´Ÿè½½å‡è¡¡ç®—æ³•è¦æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©
- æ•…éšœåˆ‡æ¢å’Œå¼‚å¸¸å¤„ç†æ˜¯é«˜å¯ç”¨çš„ä¿éšœ
- äº‹åŠ¡ä¸€è‡´æ€§å¤„ç†æ˜¯æ­£ç¡®æ€§çš„å…³é”®