---
title: 3ã€å…¨å±€åºåˆ—ä¸è·¨åˆ†ç‰‡å¤„ç†
---
## ğŸ“š ç›®å½•

1. [å…¨å±€åºåˆ—å·ç”Ÿæˆæ¦‚è¿°](#1-å…¨å±€åºåˆ—å·ç”Ÿæˆæ¦‚è¿°)
2. [åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹æ¡ˆ](#2-åˆ†å¸ƒå¼idç”Ÿæˆæ–¹æ¡ˆ)
3. [è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†](#3-è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†)
4. [è·¨åˆ†ç‰‡äº‹åŠ¡æ”¯æŒ](#4-è·¨åˆ†ç‰‡äº‹åŠ¡æ”¯æŒ)
5. [JOINæ“ä½œå®ç°](#5-joinæ“ä½œå®ç°)
6. [èšåˆæŸ¥è¯¢ä¼˜åŒ–](#6-èšåˆæŸ¥è¯¢ä¼˜åŒ–)
7. [æ•°æ®ä¸€è‡´æ€§ä¿è¯](#7-æ•°æ®ä¸€è‡´æ€§ä¿è¯)
8. [åˆ†å¸ƒå¼IDæ€§èƒ½å¯¹æ¯”åˆ†æ](#8-åˆ†å¸ƒå¼idæ€§èƒ½å¯¹æ¯”åˆ†æ)
9. [è·¨åˆ†ç‰‡äº‹åŠ¡è¡¥å¿æœºåˆ¶](#9-è·¨åˆ†ç‰‡äº‹åŠ¡è¡¥å¿æœºåˆ¶)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ†” å…¨å±€åºåˆ—å·ç”Ÿæˆæ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€åºåˆ—å·


**é€šä¿—ç†è§£**ï¼šåœ¨åˆ†åº“åˆ†è¡¨ç¯å¢ƒä¸­ï¼Œå…¨å±€åºåˆ—å·å°±åƒç»™å…¨ä¸–ç•Œçš„æ¯ä¸ªäººåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„èº«ä»½è¯å·ç ï¼Œç¡®ä¿å³ä½¿åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­ï¼Œæ¯æ¡è®°å½•éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ã€‚

**å•æœºæ•°æ®åº“ vs åˆ†å¸ƒå¼æ•°æ®åº“çš„IDç”Ÿæˆ**ï¼š

```
å•æœºç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database  â”‚
â”‚ AUTO_INCREMENTâ”‚ â†’ 1, 2, 3, 4, 5...
â”‚   (ç®€å•)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼ç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DB1    â”‚ â”‚  DB2    â”‚ â”‚  DB3    â”‚
â”‚ 1,4,7...â”‚ â”‚ 2,5,8...â”‚ â”‚ 3,6,9...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
éœ€è¦å…¨å±€åè°ƒç¡®ä¿å”¯ä¸€æ€§
```

**å…¨å±€åºåˆ—å·çš„æ ¸å¿ƒéœ€æ±‚**ï¼š
- **âœ… å…¨å±€å”¯ä¸€æ€§**ï¼šåœ¨æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿è¯IDä¸é‡å¤
- **âš¡ é«˜æ€§èƒ½**ï¼šIDç”Ÿæˆä¸èƒ½æˆä¸ºç³»ç»Ÿç“¶é¢ˆ
- **ğŸ“ˆ å•è°ƒé€’å¢**ï¼šæ»¡è¶³ä¸šåŠ¡å¯¹æœ‰åºIDçš„éœ€æ±‚
- **ğŸ”§ æ˜“äºå®ç°**ï¼šå®ç°å¤æ‚åº¦é€‚ä¸­ï¼Œè¿ç»´ç®€å•
- **ğŸ’ª é«˜å¯ç”¨**ï¼šIDç”ŸæˆæœåŠ¡ä¸èƒ½å•ç‚¹æ•…éšœ

### 1.2 å…¨å±€åºåˆ—å·çš„åº”ç”¨åœºæ™¯


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ç±»å‹ | åº”ç”¨ç¤ºä¾‹ | å”¯ä¸€æ€§è¦æ±‚ | æœ‰åºæ€§è¦æ±‚ | æ€§èƒ½è¦æ±‚ |
|---------|---------|----------|----------|----------|
| **è®¢å•ç³»ç»Ÿ** | è®¢å•å·ç”Ÿæˆ | ä¸¥æ ¼å”¯ä¸€ | æœ‰åºä¼˜å…ˆ | é«˜ |
| **ç”¨æˆ·ç³»ç»Ÿ** | ç”¨æˆ·IDç”Ÿæˆ | ä¸¥æ ¼å”¯ä¸€ | æ— åºå¯æ¥å— | ä¸­ |
| **æ—¥å¿—ç³»ç»Ÿ** | æ—¥å¿—IDç”Ÿæˆ | ä¸¥æ ¼å”¯ä¸€ | æœ‰åºä¼˜å…ˆ | æé«˜ |
| **æ¶ˆæ¯ç³»ç»Ÿ** | æ¶ˆæ¯IDç”Ÿæˆ | ä¸¥æ ¼å”¯ä¸€ | æœ‰åºé‡è¦ | æé«˜ |

### 1.3 å…¨å±€åºåˆ—å·çš„æŠ€æœ¯æŒ‘æˆ˜


**ä¸»è¦æŠ€æœ¯æŒ‘æˆ˜**ï¼š
- **ğŸ”„ å¹¶å‘å†²çª**ï¼šå¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”ŸæˆIDå¯èƒ½äº§ç”Ÿå†²çª
- **ğŸ“Š æ€§èƒ½ç“¶é¢ˆ**ï¼šé›†ä¸­å¼IDç”Ÿæˆå¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
- **âš¡ ç½‘ç»œå»¶è¿Ÿ**ï¼šåˆ†å¸ƒå¼åè°ƒå¸¦æ¥çš„ç½‘ç»œå¼€é”€
- **ğŸ›¡ï¸ å•ç‚¹æ•…éšœ**ï¼šIDç”ŸæˆæœåŠ¡çš„é«˜å¯ç”¨æ€§ä¿éšœ
- **â° æ—¶é’ŸåŒæ­¥**ï¼šåŸºäºæ—¶é—´çš„IDç”Ÿæˆéœ€è¦æ—¶é’ŸåŒæ­¥

---

## 2. ğŸ¯ åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹æ¡ˆ


### 2.1 æ•°æ®åº“æ–¹å¼ç”Ÿæˆå…¨å±€ID


**é€šä¿—ç†è§£**ï¼šåˆ©ç”¨æ•°æ®åº“çš„AUTO_INCREMENTç‰¹æ€§ï¼Œä½†è¦è§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å”¯ä¸€æ€§é—®é¢˜ã€‚

**å•åº“æ–¹å¼**ï¼š
```sql
-- åˆ›å»ºä¸“é—¨çš„IDç”Ÿæˆè¡¨
CREATE TABLE global_id_generator (
    id BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    business_type VARCHAR(50) NOT NULL,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- è·å–IDçš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE GetGlobalId(IN biz_type VARCHAR(50), OUT new_id BIGINT)
BEGIN
    INSERT INTO global_id_generator (business_type) VALUES (biz_type);
    SET new_id = LAST_INSERT_ID();
END //
DELIMITER ;
```

**å¤šåº“æ­¥é•¿æ–¹å¼**ï¼š
```sql
-- DB1è®¾ç½®ï¼šèµ·å§‹å€¼1ï¼Œæ­¥é•¿3
ALTER TABLE global_id_generator AUTO_INCREMENT = 1;
SET $$auto_increment_increment = 3;

-- DB2è®¾ç½®ï¼šèµ·å§‹å€¼2ï¼Œæ­¥é•¿3  
ALTER TABLE global_id_generator AUTO_INCREMENT = 2;
SET $$auto_increment_increment = 3;

-- ç»“æœï¼šDB1ç”Ÿæˆ1,4,7... DB2ç”Ÿæˆ2,5,8... DB3ç”Ÿæˆ3,6,9...
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… å®ç°ç®€å•ï¼Œåˆ©ç”¨ç°æœ‰æ•°æ®åº“ç‰¹æ€§
âœ… IDä¸¥æ ¼é€’å¢ï¼Œæ»¡è¶³æœ‰åºæ€§è¦æ±‚
âœ… æ”¯æŒä¸åŒä¸šåŠ¡ç±»å‹çš„IDç”Ÿæˆ

ç¼ºç‚¹ï¼š
âŒ æ•°æ®åº“æˆä¸ºç“¶é¢ˆï¼Œæ€§èƒ½æœ‰é™
âŒ å­˜åœ¨å•ç‚¹æ•…éšœé£é™©
âŒ ç½‘ç»œIOå¼€é”€ï¼Œæ¯æ¬¡ç”Ÿæˆéœ€è¦æ•°æ®åº“äº¤äº’
```

### 2.2 æ—¶é—´æˆ³æ–¹å¼ç”ŸæˆID


**åŸºæœ¬å®ç°**ï¼š
```java
public class TimestampIdGenerator {
    private static final int MACHINE_ID = getMachineId();
    
    public static long generateId() {
        long timestamp = System.currentTimeMillis();
        int sequence = getSequence(); // åºåˆ—å·
        return timestamp << 22 | MACHINE_ID << 12 | sequence;
    }
}
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… ç”Ÿæˆé€Ÿåº¦å¿«ï¼Œæ— éœ€ç½‘ç»œIO
âœ… å¤§è‡´æœ‰åºï¼ŒæŒ‰æ—¶é—´é€’å¢
âœ… å®ç°ç®€å•ï¼Œæ— å¤–éƒ¨ä¾èµ–

ç¼ºç‚¹ï¼š
âŒ æ—¶é’Ÿå›æ‹¨å¯èƒ½å¯¼è‡´é‡å¤
âŒ å¹¶å‘é‡å¤§æ—¶å¯èƒ½é‡å¤
âŒ ä¾èµ–ç³»ç»Ÿæ—¶é’ŸåŒæ­¥
```

### 2.3 ZooKeeperåˆ†å¸ƒå¼IDç”Ÿæˆ


**å®ç°æ–¹æ¡ˆ**ï¼š
```java
public class ZkIdGenerator {
    private ZooKeeper zk;
    
    public long generateId(String businessType) throws Exception {
        String path = "/global_id/" + businessType;
        
        // åˆ›å»ºé¡ºåºèŠ‚ç‚¹
        String nodePath = zk.create(
            path + "/id_", 
            new byte[0], 
            ZooDefs.Ids.OPEN_ACL_UNSAFE, 
            CreateMode.EPHEMERAL_SEQUENTIAL
        );
        
        // æå–åºåˆ—å·
        long id = Long.parseLong(nodePath.substring(nodePath.lastIndexOf("_") + 1));
        
        // åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹
        zk.delete(nodePath, -1);
        return id;
    }
}
```

### 2.4 é›ªèŠ±ç®—æ³•Snowflakeå®ç°


**Snowflakeç®—æ³•ç»“æ„**ï¼š
```
Snowflake IDç»“æ„ (64ä½)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ä½ç¬¦å·ä½ â”‚ 41ä½æ—¶é—´æˆ³ â”‚ 10ä½æœºå™¨ID â”‚ 12ä½åºåˆ—å· â”‚
â”‚    0     â”‚ timestamp â”‚ machine_id â”‚ sequence  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å›ºå®š0   â”‚   æ¯«ç§’çº§   â”‚ å·¥ä½œæœºå™¨æ ‡è¯† â”‚  é€’å¢åºåˆ—  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ”¯æŒï¼š
- 1024ä¸ªå·¥ä½œèŠ‚ç‚¹ (2^10)
- æ¯æ¯«ç§’4096ä¸ªID (2^12)
- ç†è®ºQPSï¼š4096000 (400ä¸‡+)
```

**Javaå®ç°**ï¼š
```java
public class SnowflakeIdGenerator {
    private final long START_TIMESTAMP = 1577808000000L; // 2020-01-01
    private final long SEQUENCE_BITS = 12;
    private final long MACHINE_BITS = 10;
    
    private final long MAX_SEQUENCE = ~(-1L << SEQUENCE_BITS);
    private final long MACHINE_SHIFT = SEQUENCE_BITS;
    private final long TIMESTAMP_SHIFT = SEQUENCE_BITS + MACHINE_BITS;
    
    private final long machineId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public synchronized long generateId() {
        long timestamp = System.currentTimeMillis();
        
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("Clock moved backwards");
        }
        
        if (timestamp == lastTimestamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                timestamp = waitNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        return ((timestamp - START_TIMESTAMP) << TIMESTAMP_SHIFT)
                | (machineId << MACHINE_SHIFT) | sequence;
    }
}
```

---

## 3. ğŸ” è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†


### 3.1 è·¨åˆ†ç‰‡æŸ¥è¯¢çš„æŒ‘æˆ˜


**é€šä¿—ç†è§£**ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢å°±åƒåœ¨å¤šä¸ªä¸åŒçš„å›¾ä¹¦é¦†ä¸­åŒæ—¶æ‰¾ä¹¦ï¼Œéœ€è¦åè°ƒå„ä¸ªå›¾ä¹¦é¦†çš„æœç´¢ç»“æœï¼Œç„¶ååˆå¹¶æˆæœ€ç»ˆç­”æ¡ˆã€‚

**å•åˆ†ç‰‡ vs è·¨åˆ†ç‰‡æŸ¥è¯¢å¯¹æ¯”**ï¼š

```
å•åˆ†ç‰‡æŸ¥è¯¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    DB1      â”‚
â”‚ SELECT ...  â”‚ â†’ ç›´æ¥è¿”å›ç»“æœ
â”‚ WHERE id=1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DB1   â”‚ â”‚   DB2   â”‚ â”‚   DB3   â”‚
â”‚SELECT..â”‚ â”‚SELECT..â”‚ â”‚SELECT..â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ç»“æœåˆå¹¶å¤„ç†  â”‚
          â”‚ æ’åºã€åˆ†é¡µç­‰  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŸ¥è¯¢è·¯ç”±ç­–ç•¥


**åˆ†ç‰‡é”®æŸ¥è¯¢ï¼ˆæœ€ä¼˜ï¼‰**ï¼š
```java
public class ShardingQueryRouter {
    
    // æ ¹æ®åˆ†ç‰‡é”®ç›´æ¥è·¯ç”±åˆ°å…·ä½“åˆ†ç‰‡
    public QueryResult queryByShardingKey(String userId, String sql) {
        int shardIndex = calculateShard(userId);
        DataSource dataSource = getDataSource(shardIndex);
        return executeQuery(dataSource, sql);
    }
    
    private int calculateShard(String userId) {
        return Math.abs(userId.hashCode()) % SHARD_COUNT;
    }
}
```

**éåˆ†ç‰‡é”®æŸ¥è¯¢ï¼ˆéœ€è¦å¹¿æ’­ï¼‰**ï¼š
```java
public class BroadcastQueryHandler {
    
    // å¹¿æ’­æŸ¥è¯¢åˆ°æ‰€æœ‰åˆ†ç‰‡
    public List<QueryResult> broadcastQuery(String sql) {
        List<Future<QueryResult>> futures = new ArrayList<>();
        
        // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡
        for (int i = 0; i < SHARD_COUNT; i++) {
            final int shardIndex = i;
            Future<QueryResult> future = executor.submit(() -> {
                return executeQuery(getDataSource(shardIndex), sql);
            });
            futures.add(future);
        }
        
        // æ”¶é›†ç»“æœ
        return collectResults(futures);
    }
}
```

### 3.3 ç»“æœåˆå¹¶å¤„ç†


**æ’åºåˆå¹¶**ï¼š
```java
public class ResultMerger {
    
    // å¤šè·¯å½’å¹¶æ’åº
    public List<Record> mergeAndSort(List<QueryResult> results, String orderByColumn) {
        PriorityQueue<ResultIterator> pq = new PriorityQueue<>(
            (a, b) -> compareByColumn(a.current(), b.current(), orderByColumn)
        );
        
        // åˆå§‹åŒ–è¿­ä»£å™¨
        for (QueryResult result : results) {
            if (!result.isEmpty()) {
                pq.offer(new ResultIterator(result));
            }
        }
        
        List<Record> mergedResult = new ArrayList<>();
        while (!pq.isEmpty()) {
            ResultIterator iterator = pq.poll();
            mergedResult.add(iterator.current());
            
            if (iterator.hasNext()) {
                iterator.next();
                pq.offer(iterator);
            }
        }
        
        return mergedResult;
    }
}
```

**èšåˆç»“æœåˆå¹¶**ï¼š
```java
public class AggregationMerger {
    
    public long mergeCount(List<QueryResult> results) {
        return results.stream().mapToLong(QueryResult::getCount).sum();
    }
    
    public BigDecimal mergeSum(List<QueryResult> results, String column) {
        return results.stream()
                .map(result -> result.getSum(column))
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    public BigDecimal mergeAvg(List<QueryResult> results, String column) {
        BigDecimal totalSum = mergeSum(results, column);
        long totalCount = results.stream().mapToLong(result -> result.getCount(column)).sum();
        return totalCount > 0 ? totalSum.divide(BigDecimal.valueOf(totalCount), RoundingMode.HALF_UP) : BigDecimal.ZERO;
    }
}
```

---

## 4. ğŸ”„ è·¨åˆ†ç‰‡äº‹åŠ¡æ”¯æŒ


### 4.1 åˆ†å¸ƒå¼äº‹åŠ¡çš„å¤æ‚æ€§


**é€šä¿—ç†è§£**ï¼šè·¨åˆ†ç‰‡äº‹åŠ¡å°±åƒç»„ç»‡å¤šä¸ªé“¶è¡Œä¹‹é—´çš„è½¬è´¦ï¼Œè¦ä¹ˆæ‰€æœ‰é“¶è¡Œéƒ½æˆåŠŸå¤„ç†ï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€ï¼Œä¸èƒ½å‡ºç°ä¸€è¾¹æˆåŠŸä¸€è¾¹å¤±è´¥çš„æƒ…å†µã€‚

**æœ¬åœ°äº‹åŠ¡ vs åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š

```
æœ¬åœ°äº‹åŠ¡ï¼ˆå•åˆ†ç‰‡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      DB1        â”‚
â”‚ BEGIN           â”‚
â”‚ UPDATE account  â”‚
â”‚ INSERT log      â”‚
â”‚ COMMIT          â”‚ â†’ ç®€å•çš„ACIDä¿è¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆè·¨åˆ†ç‰‡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DB1   â”‚ â”‚   DB2   â”‚ â”‚   DB3   â”‚
â”‚ BEGIN   â”‚ â”‚ BEGIN   â”‚ â”‚ BEGIN   â”‚
â”‚ UPDATE..â”‚ â”‚ UPDATE..â”‚ â”‚ UPDATE..â”‚
â”‚ COMMIT? â”‚ â”‚ COMMIT? â”‚ â”‚ COMMIT? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
         éœ€è¦åˆ†å¸ƒå¼åè°ƒ
```

### 4.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰å®ç°


**2PCåè®®æµç¨‹**ï¼š
```java
public class TwoPhaseCommitManager {
    
    public boolean executeDistributedTransaction(List<TransactionBranch> branches) {
        String transactionId = UUID.randomUUID().toString();
        
        try {
            // é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
            boolean allPrepared = preparePhase(transactionId, branches);
            
            if (allPrepared) {
                // é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ
                return commitPhase(transactionId, branches);
            } else {
                // é˜¶æ®µ2ï¼šå›æ»šé˜¶æ®µ
                rollbackPhase(transactionId, branches);
                return false;
            }
        } catch (Exception e) {
            rollbackPhase(transactionId, branches);
            throw new DistributedTransactionException("Transaction failed", e);
        }
    }
    
    private boolean preparePhase(String txId, List<TransactionBranch> branches) {
        return branches.parallelStream().allMatch(branch -> {
            try {
                return branch.prepare(txId);
            } catch (Exception e) {
                return false;
            }
        });
    }
}
```

### 4.3 TCCäº‹åŠ¡æ¨¡å¼


**TCCæ¨¡å¼å®ç°**ï¼š
```java
public interface TCCService {
    boolean tryExecute(String transactionId, Map<String, Object> params);
    boolean confirm(String transactionId);
    boolean cancel(String transactionId);
}

// è´¦æˆ·æœåŠ¡TCCå®ç°
public class AccountTCCService implements TCCService {
    
    @Override
    public boolean tryExecute(String txId, Map<String, Object> params) {
        String accountId = (String) params.get("accountId");
        BigDecimal amount = (BigDecimal) params.get("amount");
        
        // å†»ç»“è´¦æˆ·èµ„é‡‘
        AccountFreeze freeze = new AccountFreeze();
        freeze.setTransactionId(txId);
        freeze.setAccountId(accountId);
        freeze.setAmount(amount);
        
        return accountFreezeMapper.insert(freeze) > 0;
    }
    
    @Override
    public boolean confirm(String txId) {
        AccountFreeze freeze = accountFreezeMapper.selectByTxId(txId);
        if (freeze == null) return false;
        
        // æ‰£å‡è´¦æˆ·ä½™é¢å¹¶åˆ é™¤å†»ç»“è®°å½•
        boolean success = accountMapper.deductBalance(freeze.getAccountId(), freeze.getAmount()) > 0;
        if (success) {
            accountFreezeMapper.deleteByTxId(txId);
        }
        return success;
    }
    
    @Override
    public boolean cancel(String txId) {
        // ç›´æ¥åˆ é™¤å†»ç»“è®°å½•ï¼Œé‡Šæ”¾èµ„æº
        return accountFreezeMapper.deleteByTxId(txId) > 0;
    }
}
```

---

## 5. ğŸ”— JOINæ“ä½œå®ç°


### 5.1 è·¨åˆ†ç‰‡JOINçš„æŒ‘æˆ˜


**é€šä¿—ç†è§£**ï¼šè·¨åˆ†ç‰‡JOINå°±åƒè¦æŠŠæ•£å¸ƒåœ¨ä¸åŒåŸå¸‚å›¾ä¹¦é¦†çš„ä¹¦ç±ä¿¡æ¯è¿›è¡Œå…³è”æŸ¥è¯¢ï¼Œéœ€è¦å…ˆæŠŠç›¸å…³æ•°æ®æ”¶é›†åˆ°ä¸€èµ·ï¼Œå†è¿›è¡ŒåŒ¹é…ã€‚

**JOINç±»å‹ä¸å®ç°å¤æ‚åº¦**ï¼š

| JOINç±»å‹ | å®ç°å¤æ‚åº¦ | æ€§èƒ½å½±å“ | æ¨èç­–ç•¥ |
|---------|----------|---------|---------|
| **åŒåˆ†ç‰‡JOIN** | ä½ | å° | ç›´æ¥åœ¨åˆ†ç‰‡å†…æ‰§è¡Œ |
| **å¹¿æ’­è¡¨JOIN** | ä¸­ | ä¸­ | æ•°æ®é‡å°çš„è¡¨åšå¹¿æ’­ |
| **è·¨åˆ†ç‰‡JOIN** | é«˜ | å¤§ | é¿å…æˆ–é€šè¿‡ä¸­é—´ä»¶å¤„ç† |

### 5.2 å¹¿æ’­è¡¨JOINå®ç°


**å¹¿æ’­è¡¨ç­–ç•¥**ï¼š
```java
public class BroadcastJoinHandler {
    
    public QueryResult executeBroadcastJoin(String mainTable, String broadcastTable, 
                                          String joinCondition, String whereCondition) {
        
        // 1. æŸ¥è¯¢å¹¿æ’­è¡¨æ•°æ®
        QueryResult broadcastData = queryBroadcastTable(broadcastTable, whereCondition);
        
        // 2. æ ¹æ®JOINæ¡ä»¶æ„å»ºINæŸ¥è¯¢
        Set<Object> joinKeys = extractJoinKeys(broadcastData, joinCondition);
        String inClause = buildInClause(joinKeys);
        
        // 3. åœ¨æ‰€æœ‰åˆ†ç‰‡æŸ¥è¯¢ä¸»è¡¨
        String mainQuery = String.format("SELECT * FROM %s WHERE %s IN (%s)", 
                                        mainTable, getJoinColumn(joinCondition), inClause);
        List<QueryResult> mainResults = broadcastQuery(mainQuery);
        
        // 4. åœ¨å†…å­˜ä¸­æ‰§è¡ŒJOIN
        return executeInMemoryJoin(mainResults, broadcastData, joinCondition);
    }
}
```

### 5.3 åˆ†ç‰‡é—´æ•°æ®æ”¶é›†JOIN


**æ•°æ®æ”¶é›†ç­–ç•¥**ï¼š
```java
public class GatherJoinHandler {
    
    public QueryResult executeGatherJoin(String leftTable, String rightTable, 
                                       String joinCondition, String whereCondition) {
        
        JoinAnalysis analysis = analyzeJoin(leftTable, rightTable, joinCondition);
        
        if (analysis.canOptimizeWithShardingKey()) {
            return executeOptimizedJoin(analysis);
        } else {
            return executeFullGatherJoin(analysis);
        }
    }
    
    private QueryResult executeFullGatherJoin(JoinAnalysis analysis) {
        // æ”¶é›†å·¦è¡¨å’Œå³è¡¨æ•°æ®
        List<Record> leftRecords = collectTableData(analysis.getLeftTable());
        List<Record> rightRecords = collectTableData(analysis.getRightTable());
        
        // å†…å­˜ä¸­æ‰§è¡ŒHash JOIN
        return executeHashJoin(leftRecords, rightRecords, analysis.getJoinCondition());
    }
}
```

---

## 6. ğŸ“Š èšåˆæŸ¥è¯¢ä¼˜åŒ–


### 6.1 åˆ†å¸ƒå¼èšåˆçš„å®ç°åŸç†


**é€šä¿—ç†è§£**ï¼šåˆ†å¸ƒå¼èšåˆå°±åƒç»Ÿè®¡å…¨å›½å„çœçš„äººå£æ•°æ®ï¼Œæ¯ä¸ªçœå…ˆç»Ÿè®¡è‡ªå·±çš„æ•°æ®ï¼Œç„¶åå°†ç»“æœæ±‡æ€»åˆ°ä¸­å¤®è¿›è¡Œæœ€ç»ˆè®¡ç®—ã€‚

**èšåˆå‡½æ•°çš„åˆ†ç±»å¤„ç†**ï¼š

```
èšåˆå‡½æ•°åˆ†ç±»ï¼š

ğŸ“Š å¯åˆ†è§£èšåˆï¼ˆæ”¯æŒåˆ†å¸ƒå¼ï¼‰
â”œâ”€ COUNTï¼šå„åˆ†ç‰‡ç»“æœç›´æ¥ç›¸åŠ 
â”œâ”€ SUMï¼šå„åˆ†ç‰‡ç»“æœç›´æ¥ç›¸åŠ   
â”œâ”€ MAXï¼šå„åˆ†ç‰‡ç»“æœå–æœ€å¤§å€¼
â””â”€ MINï¼šå„åˆ†ç‰‡ç»“æœå–æœ€å°å€¼

ğŸ”„ ä¸å¯åˆ†è§£èšåˆï¼ˆéœ€è¦é‡æ–°è®¡ç®—ï¼‰
â”œâ”€ AVGï¼šéœ€è¦SUMå’ŒCOUNTé‡æ–°è®¡ç®—
â”œâ”€ DISTINCT COUNTï¼šéœ€è¦å»é‡åè®¡ç®—
â””â”€ PERCENTILEï¼šéœ€è¦æ’åºåè®¡ç®—
```

### 6.2 åŸºæœ¬èšåˆæ“ä½œå®ç°


**COUNTå’ŒSUMèšåˆ**ï¼š
```java
public class BasicAggregator {
    
    public long executeCountQuery(String table, String whereCondition) {
        String countSql = String.format("SELECT COUNT(*) as count FROM %s WHERE %s", 
                                      table, whereCondition);
        
        return broadcastQuery(countSql).stream()
                .mapToLong(result -> result.getLong("count"))
                .sum();
    }
    
    public BigDecimal executeSumQuery(String table, String column, String whereCondition) {
        String sumSql = String.format("SELECT SUM(%s) as sum_value FROM %s WHERE %s", 
                                    column, table, whereCondition);
        
        return broadcastQuery(sumSql).stream()
                .map(result -> result.getBigDecimal("sum_value"))
                .filter(Objects::nonNull)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}
```

**AVGèšåˆï¼ˆå¤æ‚èšåˆï¼‰**ï¼š
```java
public class AvgAggregator {
    
    public BigDecimal executeAvgQuery(String table, String column, String whereCondition) {
        String avgSql = String.format(
                "SELECT SUM(%s) as sum_value, COUNT(%s) as count_value FROM %s WHERE %s", 
                column, column, table, whereCondition);
        
        List<QueryResult> results = broadcastQuery(avgSql);
        
        BigDecimal totalSum = BigDecimal.ZERO;
        long totalCount = 0;
        
        for (QueryResult result : results) {
            BigDecimal shardSum = result.getBigDecimal("sum_value");
            Long shardCount = result.getLong("count_value");
            
            if (shardSum != null && shardCount != null) {
                totalSum = totalSum.add(shardSum);
                totalCount += shardCount;
            }
        }
        
        return totalCount > 0 ? 
                totalSum.divide(BigDecimal.valueOf(totalCount), 2, RoundingMode.HALF_UP) : 
                BigDecimal.ZERO;
    }
}
```

### 6.3 GROUP BYèšåˆå¤„ç†


**åˆ†å¸ƒå¼GROUP BYå®ç°**ï¼š
```java
public class GroupByAggregator {
    
    public Map<Object, AggregateResult> executeGroupBy(String table, String groupByColumn, 
                                                     List<String> aggregateColumns) {
        
        String groupBySql = buildGroupBySql(table, groupByColumn, aggregateColumns);
        List<QueryResult> shardResults = broadcastQuery(groupBySql);
        
        return mergeGroupByResults(shardResults, aggregateColumns);
    }
    
    private Map<Object, AggregateResult> mergeGroupByResults(List<QueryResult> shardResults, 
                                                           List<String> aggregateColumns) {
        Map<Object, AggregateResult> mergedResults = new HashMap<>();
        
        for (QueryResult shardResult : shardResults) {
            for (Record record : shardResult.getRecords()) {
                Object groupKey = record.get("group_key");
                
                AggregateResult existingResult = mergedResults.computeIfAbsent(groupKey, 
                        k -> new AggregateResult());
                
                mergeAggregateValues(existingResult, record, aggregateColumns);
            }
        }
        
        return mergedResults;
    }
}
```

---

## 7. ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§ä¿è¯


### 7.1 åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§æŒ‘æˆ˜


**é€šä¿—ç†è§£**ï¼šæ•°æ®ä¸€è‡´æ€§å°±åƒç¡®ä¿æ‰€æœ‰é“¶è¡Œçš„è´¦æˆ·ä½™é¢ä¿¡æ¯éƒ½æ˜¯å‡†ç¡®çš„ï¼Œä¸èƒ½å‡ºç°æŸä¸ªåˆ†æ”¯æœºæ„æ˜¾ç¤ºçš„ä½™é¢ä¸å®é™…ä¸ç¬¦çš„æƒ…å†µã€‚

**ä¸€è‡´æ€§çº§åˆ«**ï¼š

```
ä¸€è‡´æ€§å¼ºåº¦çº§åˆ«ï¼š

ğŸ”’ å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰
â”œâ”€ æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒæ•°æ®
â”œâ”€ å®ç°æˆæœ¬é«˜ï¼Œæ€§èƒ½å½±å“å¤§
â””â”€ é€‚ç”¨ï¼šé‡‘èäº¤æ˜“ç­‰å…³é”®ä¸šåŠ¡

âš–ï¸ æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰  
â”œâ”€ èŠ‚ç‚¹é—´æ•°æ®æœ€ç»ˆä¼šä¸€è‡´
â”œâ”€ å…è®¸çŸ­æš‚çš„ä¸ä¸€è‡´
â””â”€ é€‚ç”¨ï¼šå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯

ğŸ• ä¼šè¯ä¸€è‡´æ€§ï¼ˆSession Consistencyï¼‰
â”œâ”€ åŒä¸€ä¼šè¯å†…çœ‹åˆ°ä¸€è‡´æ•°æ®
â”œâ”€ ä¸åŒä¼šè¯å¯èƒ½çœ‹åˆ°ä¸åŒæ•°æ®
â””â”€ é€‚ç”¨ï¼šç”¨æˆ·ç›¸å…³æ“ä½œ
```

### 7.2 è¯»å†™åˆ†ç¦»çš„ä¸€è‡´æ€§å¤„ç†


**è¯»å†™åˆ†ç¦»ä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼š
```java
public class ReadWriteConsistencyManager {
    
    // å¼ºåˆ¶è¯»ä¸»åº“ç­–ç•¥
    public QueryResult readFromMaster(String sql, String sessionId) {
        if (hasRecentWrite(sessionId)) {
            return executeOnMaster(sql);
        } else {
            return executeOnSlave(sql);
        }
    }
    
    // ç‰ˆæœ¬å·ä¸€è‡´æ€§
    public QueryResult readWithVersion(String sql, long expectedVersion) {
        QueryResult result = executeOnSlave(sql);
        
        if (result.getVersion() < expectedVersion) {
            return executeOnMaster(sql); // ç‰ˆæœ¬è¿‡æ—§ï¼Œä»ä¸»åº“è¯»å–
        }
        
        return result;
    }
    
    private boolean hasRecentWrite(String sessionId) {
        SessionInfo session = sessionManager.getSession(sessionId);
        if (session == null) return false;
        
        long lastWriteTime = session.getLastWriteTime();
        return (System.currentTimeMillis() - lastWriteTime) < 5000; // 5ç§’å†…æœ‰å†™æ“ä½œ
    }
}
```

### 7.3 åˆ†å¸ƒå¼é”å®ç°


**åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”**ï¼š
```java
public class DatabaseDistributedLock {
    
    public boolean tryLock(String lockKey, String lockValue, int timeoutSeconds) {
        String sql = """
            INSERT INTO distributed_locks (lock_key, lock_value, expire_time) 
            VALUES (?, ?, DATE_ADD(NOW(), INTERVAL ? SECOND))
            ON DUPLICATE KEY UPDATE
                lock_value = IF(expire_time < NOW(), VALUES(lock_value), lock_value),
                expire_time = IF(expire_time < NOW(), VALUES(expire_time), expire_time)
            """;
        
        try {
            int affectedRows = jdbcTemplate.update(sql, lockKey, lockValue, timeoutSeconds);
            return affectedRows > 0 && isLockOwner(lockKey, lockValue);
        } catch (Exception e) {
            return false;
        }
    }
    
    public void unlock(String lockKey, String lockValue) {
        String sql = "DELETE FROM distributed_locks WHERE lock_key = ? AND lock_value = ?";
        jdbcTemplate.update(sql, lockKey, lockValue);
    }
}
```

**åŸºäºRedisçš„åˆ†å¸ƒå¼é”**ï¼š
```java
public class RedisDistributedLock {
    
    public boolean tryLock(String lockKey, String lockValue, int timeoutSeconds) {
        Boolean result = redisTemplate.opsForValue().setIfAbsent(
                lockKey, lockValue, Duration.ofSeconds(timeoutSeconds));
        return Boolean.TRUE.equals(result);
    }
    
    public void unlock(String lockKey, String lockValue) {
        String luaScript = """
            if redis.call('GET', KEYS[1]) == ARGV[1] then
                return redis.call('DEL', KEYS[1])
            else
                return 0
            end
            """;
        
        redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class), 
                            Collections.singletonList(lockKey), lockValue);
    }
}
```

---

## 8. ğŸ“ˆ åˆ†å¸ƒå¼IDæ€§èƒ½å¯¹æ¯”åˆ†æ


### 8.1 æ€§èƒ½æµ‹è¯•ç»“æœ


**å„æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”**ï¼š

| IDç”Ÿæˆæ–¹æ¡ˆ | QPS | å¹³å‡å“åº”æ—¶é—´(ms) | P99å“åº”æ—¶é—´(ms) | å†…å­˜å ç”¨ | ä¾èµ–ç»„ä»¶ |
|-----------|-----|----------------|---------------|---------|---------|
| **æ•°æ®åº“å•åº“** | 2,000 | 0.5 | 5 | ä½ | MySQL |
| **æ•°æ®åº“å¤šåº“** | 8,000 | 0.2 | 2 | ä½ | MySQL |
| **æ—¶é—´æˆ³æ–¹å¼** | 50,000 | 0.02 | 0.1 | æä½ | æ—  |
| **ZooKeeper** | 1,500 | 2 | 20 | ä¸­ | ZooKeeper |
| **æœ¬åœ°æ–‡ä»¶** | 30,000 | 0.1 | 1 | ä½ | æ–‡ä»¶ç³»ç»Ÿ |
| **Snowflake** | 100,000 | 0.01 | 0.05 | æä½ | NTP |

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æ–¹æ¡ˆ**ï¼š

```
é€‰æ‹©å†³ç­–æ ‘ï¼š

é«˜å¹¶å‘åœºæ™¯ (QPS > 10ä¸‡)
â”œâ”€ å¯¹é¡ºåºæ— è¦æ±‚ â†’ Snowflakeç®—æ³•
â”œâ”€ éœ€è¦å…¨å±€é€’å¢ â†’ æœ¬åœ°æ–‡ä»¶æ‰¹é‡ç”Ÿæˆ
â””â”€ å¯æ¥å—ç•¥å¾®ä¹±åº â†’ æ—¶é—´æˆ³+æœºå™¨ID

ä¸­ç­‰å¹¶å‘åœºæ™¯ (QPS 1ä¸‡-10ä¸‡)
â”œâ”€ ç³»ç»Ÿå¤æ‚åº¦ä½ â†’ æ•°æ®åº“å¤šåº“æ­¥é•¿
â”œâ”€ éœ€è¦ä¸šåŠ¡å«ä¹‰ â†’ è‡ªå®šä¹‰ç»„åˆæ–¹æ¡ˆ
â””â”€ é«˜å¯ç”¨è¦æ±‚ â†’ Redisåˆ†å¸ƒå¼æ–¹æ¡ˆ

ä½å¹¶å‘åœºæ™¯ (QPS < 1ä¸‡)
â”œâ”€ å®ç°ç®€å• â†’ æ•°æ®åº“å•åº“æ–¹æ¡ˆ
â”œâ”€ å¼ºä¸€è‡´æ€§ â†’ ZooKeeperæ–¹æ¡ˆ
â””â”€ æ— å¤–éƒ¨ä¾èµ– â†’ æœ¬åœ°æ–‡ä»¶æ–¹æ¡ˆ
```

---

## 9. ğŸ”„ è·¨åˆ†ç‰‡äº‹åŠ¡è¡¥å¿æœºåˆ¶


### 9.1 äº‹åŠ¡è¡¥å¿çš„åŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šäº‹åŠ¡è¡¥å¿å°±åƒ"åæ‚”è¯"ï¼Œå½“åˆ†å¸ƒå¼äº‹åŠ¡ä¸­æŸä¸ªç¯èŠ‚å‡ºé”™æ—¶ï¼Œé€šè¿‡æ‰§è¡Œç›¸åçš„æ“ä½œæ¥æ’¤é”€å·²ç»å®Œæˆçš„æ“ä½œï¼Œè®©æ•´ä¸ªç³»ç»Ÿå›åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ã€‚

**è¡¥å¿æœºåˆ¶çš„åº”ç”¨åœºæ™¯**ï¼š
- **ğŸ”„ é•¿äº‹åŠ¡å¤„ç†**ï¼šè€—æ—¶è¾ƒé•¿çš„ä¸šåŠ¡æµç¨‹
- **ğŸŒ è·¨ç³»ç»Ÿè°ƒç”¨**ï¼šæ¶‰åŠå¤šä¸ªç‹¬ç«‹ç³»ç»Ÿçš„æ“ä½œ
- **âš¡ é«˜å¹¶å‘åœºæ™¯**ï¼šä¼ ç»Ÿ2PCæ€§èƒ½æ— æ³•æ»¡è¶³éœ€æ±‚
- **ğŸ›¡ï¸ å®¹é”™å¤„ç†**ï¼šç³»ç»Ÿå¼‚å¸¸æ—¶çš„æ•°æ®æ¢å¤

### 9.2 Sagaäº‹åŠ¡æ¨¡å¼å®ç°


**Sagaäº‹åŠ¡ç®¡ç†å™¨**ï¼š
```java
public class SagaTransactionManager {
    
    public void executeSaga(SagaDefinition sagaDefinition) {
        SagaContext context = new SagaContext();
        List<SagaStep> steps = sagaDefinition.getSteps();
        
        try {
            // é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            for (int i = 0; i < steps.size(); i++) {
                SagaStep step = steps.get(i);
                StepResult result = executeStep(step, context);
                
                if (result.isSuccess()) {
                    context.addCompletedStep(i, step, result);
                } else {
                    compensateCompletedSteps(context);
                    throw new SagaExecutionException("Step failed: " + step.getName());
                }
            }
            
            context.markAsCompleted();
            
        } catch (Exception e) {
            compensateCompletedSteps(context);
            throw new SagaExecutionException("Saga execution failed", e);
        }
    }
    
    private void compensateCompletedSteps(SagaContext context) {
        List<CompletedStep> completedSteps = context.getCompletedSteps();
        
        // é€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
        for (int i = completedSteps.size() - 1; i >= 0; i--) {
            CompletedStep completedStep = completedSteps.get(i);
            try {
                executeCompensation(completedStep);
            } catch (Exception e) {
                log.error("Compensation failed for step: " + completedStep.getStepName(), e);
                recordCompensationFailure(completedStep, e);
            }
        }
    }
}
```

### 9.3 æœ€å¤§åŠªåŠ›é€šçŸ¥æ¨¡å¼


**æ¶ˆæ¯å¯é æ€§ä¿è¯**ï¼š
```java
public class ReliableMessageManager {
    
    public void sendReliableMessage(String topic, Object message, String businessId) {
        // 1. è®°å½•æ¶ˆæ¯åˆ°æœ¬åœ°æ•°æ®åº“
        MessageRecord record = new MessageRecord();
        record.setBusinessId(businessId);
        record.setTopic(topic);
        record.setContent(JSON.toJSONString(message));
        record.setStatus("PENDING");
        
        messageRecordMapper.insert(record);
        
        // 2. å‘é€æ¶ˆæ¯åˆ°MQ
        try {
            messageProducer.send(topic, message);
            updateMessageStatus(record.getId(), "SENT");
        } catch (Exception e) {
            updateMessageStatus(record.getId(), "FAILED");
        }
    }
    
    @Scheduled(fixedRate = 30000)
    public void retryFailedMessages() {
        List<MessageRecord> failedMessages = messageRecordMapper.selectFailedMessages();
        
        for (MessageRecord record : failedMessages) {
            if (record.getRetryCount() < MAX_RETRY_COUNT) {
                try {
                    Object message = JSON.parseObject(record.getContent(), Object.class);
                    messageProducer.send(record.getTopic(), message);
                    updateMessageStatus(record.getId(), "SENT");
                } catch (Exception e) {
                    record.setRetryCount(record.getRetryCount() + 1);
                    messageRecordMapper.updateById(record);
                }
            }
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


- **ğŸ”¸ å…¨å±€åºåˆ—å·ç”Ÿæˆ**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¿è¯IDå…¨å±€å”¯ä¸€çš„æŠ€æœ¯æ–¹æ¡ˆ
- **ğŸ”¸ è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†**ï¼šå¤šåˆ†ç‰‡æ•°æ®çš„æŸ¥è¯¢è·¯ç”±ã€ç»“æœåˆå¹¶å’Œä¼˜åŒ–æŠ€æœ¯
- **ğŸ”¸ è·¨åˆ†ç‰‡äº‹åŠ¡æ”¯æŒ**ï¼š2PCã€TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
- **ğŸ”¸ JOINæ“ä½œå®ç°**ï¼šå¹¿æ’­è¡¨JOINã€æ•°æ®æ”¶é›†JOINç­‰è·¨åˆ†ç‰‡å…³è”æŸ¥è¯¢
- **ğŸ”¸ èšåˆæŸ¥è¯¢ä¼˜åŒ–**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„GROUP BYã€COUNTã€SUMç­‰èšåˆæ“ä½œ
- **ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ä¿è¯**ï¼šè¯»å†™åˆ†ç¦»ã€åˆ†å¸ƒå¼é”ã€æ•°æ®ä¿®å¤ç­‰ä¸€è‡´æ€§æ–¹æ¡ˆ
- **ğŸ”¸ äº‹åŠ¡è¡¥å¿æœºåˆ¶**ï¼šSagaæ¨¡å¼ã€æœ€å¤§åŠªåŠ›é€šçŸ¥ç­‰æŸ”æ€§äº‹åŠ¡å¤„ç†

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ IDç”Ÿæˆæ–¹æ¡ˆçš„é€‰æ‹©åŸåˆ™**
```
æ€§èƒ½ä¼˜å…ˆï¼šSnowflake > æœ¬åœ°æ–‡ä»¶ > æ—¶é—´æˆ³ > æ•°æ®åº“ > ZooKeeper
ä¸€è‡´æ€§ä¼˜å…ˆï¼šZooKeeper > æ•°æ®åº“ > æœ¬åœ°æ–‡ä»¶ > Snowflake > æ—¶é—´æˆ³
å®ç°ç®€å•ï¼šæ—¶é—´æˆ³ > æ•°æ®åº“ > æœ¬åœ°æ–‡ä»¶ > Snowflake > ZooKeeper
```

**ğŸ”¹ è·¨åˆ†ç‰‡æ“ä½œçš„å¤æ‚åº¦ç®¡ç†**
```
æŸ¥è¯¢å¤æ‚åº¦ï¼šå•åˆ†ç‰‡ < åˆ†ç‰‡é”®æŸ¥è¯¢ < å¹¿æ’­æŸ¥è¯¢ < è·¨åˆ†ç‰‡JOIN
äº‹åŠ¡å¤æ‚åº¦ï¼šæœ¬åœ°äº‹åŠ¡ < æœ€ç»ˆä¸€è‡´æ€§ < TCC < 2PC
ä¸€è‡´æ€§è¦æ±‚ï¼šæœ€ç»ˆä¸€è‡´æ€§ < ä¼šè¯ä¸€è‡´æ€§ < å¼ºä¸€è‡´æ€§
```

**ğŸ”¹ åˆ†å¸ƒå¼äº‹åŠ¡çš„æƒè¡¡è€ƒè™‘**
```
æ€§èƒ½è¦æ±‚é«˜ï¼šé€‰æ‹©æŸ”æ€§äº‹åŠ¡ï¼ˆSagaã€æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§ï¼‰
ä¸€è‡´æ€§è¦æ±‚é«˜ï¼šé€‰æ‹©å¼ºä¸€è‡´æ€§äº‹åŠ¡ï¼ˆ2PCã€3PCï¼‰
ç³»ç»Ÿå¤æ‚åº¦ï¼šæœ¬åœ°äº‹åŠ¡ < è¡¥å¿äº‹åŠ¡ < åˆ†å¸ƒå¼äº‹åŠ¡
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**æŠ€æœ¯é€‰å‹å†³ç­–æ ‘**ï¼š
```
ä¸šåŠ¡åœºæ™¯åˆ†æï¼š
â”œâ”€ é«˜å¹¶å‘åœºæ™¯ï¼ˆQPS > 10ä¸‡ï¼‰
â”‚  â”œâ”€ IDç”Ÿæˆï¼šSnowflakeç®—æ³•
â”‚  â”œâ”€ æŸ¥è¯¢ï¼šé¿å…è·¨åˆ†ç‰‡JOINï¼Œä½¿ç”¨æ•°æ®å†—ä½™
â”‚  â””â”€ äº‹åŠ¡ï¼šå¼‚æ­¥æ¶ˆæ¯ï¼Œæœ€ç»ˆä¸€è‡´æ€§
â”‚
â”œâ”€ å¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆé‡‘èä¸šåŠ¡ï¼‰
â”‚  â”œâ”€ IDç”Ÿæˆï¼šæ•°æ®åº“æ–¹æ¡ˆä¿è¯ä¸¥æ ¼é€’å¢
â”‚  â”œâ”€ æŸ¥è¯¢ï¼šå…è®¸è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼Œä¿è¯æ•°æ®å‡†ç¡®æ€§
â”‚  â””â”€ äº‹åŠ¡ï¼š2PCæˆ–TCCä¿è¯å¼ºä¸€è‡´æ€§
â”‚
â””â”€ ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯
   â”œâ”€ IDç”Ÿæˆï¼šæœ¬åœ°æ–‡ä»¶æ‰¹é‡æ–¹æ¡ˆ
   â”œâ”€ æŸ¥è¯¢ï¼šå¹¿æ’­è¡¨ä¼˜åŒ–ï¼Œåˆ†ç‰‡é”®è·¯ç”±
   â””â”€ äº‹åŠ¡ï¼šSagaè¡¥å¿äº‹åŠ¡
```

**è¿ç»´ç®¡ç†è¦ç‚¹**ï¼š
```
ç›‘æ§æŒ‡æ ‡ï¼š
âœ… IDç”Ÿæˆæ€§èƒ½ï¼šQPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡
âœ… æŸ¥è¯¢æ€§èƒ½ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ã€å“åº”æ—¶é—´
âœ… äº‹åŠ¡æˆåŠŸç‡ï¼šæäº¤æˆåŠŸç‡ã€è¡¥å¿æˆåŠŸç‡
âœ… æ•°æ®ä¸€è‡´æ€§ï¼šä¸»ä»å»¶è¿Ÿã€æ•°æ®æ ¡éªŒç»“æœ

å‘Šè­¦ç­–ç•¥ï¼š
ğŸ”´ IDç”Ÿæˆå¤±è´¥ç‡ > 1%
ğŸŸ¡ è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹ > 20%
ğŸ”´ äº‹åŠ¡è¡¥å¿å¤±è´¥ç‡ > 5%
ğŸŸ¡ ä¸»ä»æ•°æ®ä¸ä¸€è‡´
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**æ€§èƒ½é—®é¢˜**ï¼š
```
é—®é¢˜ï¼šIDç”Ÿæˆæˆä¸ºç“¶é¢ˆ
è§£å†³ï¼šä½¿ç”¨Snowflakeç®—æ³•æˆ–æœ¬åœ°æ–‡ä»¶æ‰¹é‡ç”Ÿæˆ

é—®é¢˜ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢ç¼“æ…¢
è§£å†³ï¼šä¼˜åŒ–æŸ¥è¯¢è·¯ç”±ï¼Œä½¿ç”¨å¹¿æ’­è¡¨ï¼Œé¿å…ä¸å¿…è¦çš„JOIN

é—®é¢˜ï¼šåˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½å·®
è§£å†³ï¼šæ”¹ç”¨å¼‚æ­¥æ¶ˆæ¯å’Œè¡¥å¿äº‹åŠ¡
```

**ä¸€è‡´æ€§é—®é¢˜**ï¼š
```
é—®é¢˜ï¼šè¯»å†™åˆ†ç¦»æ•°æ®ä¸ä¸€è‡´
è§£å†³ï¼šè¯»å†™åˆ†ç¦»ä¸€è‡´æ€§ç­–ç•¥ï¼Œå¼ºåˆ¶è¯»ä¸»åº“

é—®é¢˜ï¼šåˆ†å¸ƒå¼äº‹åŠ¡éƒ¨åˆ†å¤±è´¥
è§£å†³ï¼šå®ç°å®Œå–„çš„è¡¥å¿æœºåˆ¶å’Œç›‘æ§å‘Šè­¦

é—®é¢˜ï¼šæ—¶é’Ÿå›æ‹¨å¯¼è‡´IDé‡å¤
è§£å†³ï¼šSnowflakeç®—æ³•ä¼˜åŒ–ï¼Œå¢åŠ æ—¶é’Ÿå›æ‹¨æ£€æµ‹
```

### 10.5 å‘å±•è¶‹åŠ¿å±•æœ›


**æŠ€æœ¯å‘å±•æ–¹å‘**ï¼š
- **ğŸ”® AIä¼˜åŒ–**ï¼šæ™ºèƒ½è·¯ç”±é€‰æ‹©ã€è‡ªåŠ¨å‚æ•°è°ƒä¼˜
- **â˜ï¸ äº‘åŸç”Ÿ**ï¼šServerlessåˆ†å¸ƒå¼IDã€æ‰˜ç®¡åˆ†å¸ƒå¼äº‹åŠ¡
- **ğŸš€ æ€§èƒ½æå‡**ï¼šç¡¬ä»¶åŠ é€Ÿã€RDMAç½‘ç»œä¼˜åŒ–
- **ğŸ›¡ï¸ å®‰å…¨å¢å¼º**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®åŠ å¯†å’Œè®¿é—®æ§åˆ¶

**æ¶æ„æ¼”è¿›è¶‹åŠ¿**ï¼š
- **å¾®æœåŠ¡åŒ–**ï¼šæ›´ç»†ç²’åº¦çš„æœåŠ¡æ‹†åˆ†å’Œæ²»ç†
- **äº‹ä»¶é©±åŠ¨**ï¼šåŸºäºäº‹ä»¶çš„æœ€ç»ˆä¸€è‡´æ€§æ¶æ„
- **å¤šæ´»æ¶æ„**ï¼šè·¨åœ°åŸŸçš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§
- **è¾¹ç¼˜è®¡ç®—**ï¼šè¾¹ç¼˜èŠ‚ç‚¹çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼IDç”Ÿæˆè¦å¹³è¡¡æ€§èƒ½ã€ä¸€è‡´æ€§å’Œå®ç°å¤æ‚åº¦
- è·¨åˆ†ç‰‡æ“ä½œåº”å°½é‡é¿å…ï¼Œé€šè¿‡åˆç†çš„åˆ†ç‰‡ç­–ç•¥å‡å°‘è·¨åˆ†ç‰‡éœ€æ±‚
- åˆ†å¸ƒå¼äº‹åŠ¡è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ¨¡å‹
- è¡¥å¿æœºåˆ¶æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¯é æ€§çš„é‡è¦ä¿éšœ
- ç›‘æ§å’Œå‘Šè­¦æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè¿ç»´çš„åŸºç¡€