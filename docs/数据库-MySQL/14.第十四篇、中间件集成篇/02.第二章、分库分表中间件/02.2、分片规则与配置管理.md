---
title: 2ã€åˆ†ç‰‡è§„åˆ™ä¸é…ç½®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [åˆ†ç‰‡è§„åˆ™åŸºç¡€æ¦‚å¿µ](#1-åˆ†ç‰‡è§„åˆ™åŸºç¡€æ¦‚å¿µ)
2. [åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥](#2-åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥)
3. [å¸¸ç”¨åˆ†ç‰‡ç®—æ³•è¯¦è§£](#3-å¸¸ç”¨åˆ†ç‰‡ç®—æ³•è¯¦è§£)
4. [åˆ†ç‰‡è§„åˆ™é…ç½®ç®¡ç†](#4-åˆ†ç‰‡è§„åˆ™é…ç½®ç®¡ç†)
5. [å¤åˆåˆ†ç‰‡ä¸é«˜çº§ç­–ç•¥](#5-å¤åˆåˆ†ç‰‡ä¸é«˜çº§ç­–ç•¥)
6. [çƒ­ç‚¹æ•°æ®å¤„ç†](#6-çƒ­ç‚¹æ•°æ®å¤„ç†)
7. [åŠ¨æ€åˆ†ç‰‡ç®¡ç†](#7-åŠ¨æ€åˆ†ç‰‡ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åˆ†ç‰‡è§„åˆ™åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†ç‰‡è§„åˆ™


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
åˆ†ç‰‡è§„åˆ™ï¼šå†³å®šæ•°æ®åœ¨å¤šä¸ªåˆ†ç‰‡ä¸­å¦‚ä½•åˆ†å¸ƒçš„æ ¸å¿ƒç®—æ³•
ä½œç”¨ï¼šå°†åŸæœ¬å­˜å‚¨åœ¨å•ä¸€æ•°æ®åº“ä¸­çš„æ•°æ®ï¼ŒæŒ‰ç…§ç‰¹å®šè§„åˆ™åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“å®ä¾‹ä¸­
ç›®æ ‡ï¼šå®ç°æ•°æ®çš„æ°´å¹³æ‰©å±•ï¼Œæå‡ç³»ç»Ÿæ•´ä½“æ€§èƒ½å’Œå®¹é‡
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šåˆ†ç‰‡è§„åˆ™å°±åƒæ˜¯ä¸€ä¸ª"æ™ºèƒ½åˆ†æ‹£å‘˜"ï¼Œæ ¹æ®æ•°æ®çš„ç‰¹å¾å†³å®šæŠŠå®ƒä»¬æ”¾åˆ°å“ªä¸ª"ä»“åº“"é‡Œã€‚

### 1.2 åˆ†ç‰‡è§„åˆ™çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡è§„åˆ™**
```
å•åº“å®¹é‡é™åˆ¶ï¼š
- å•è¡¨åƒä¸‡çº§æ•°æ®æŸ¥è¯¢æ€§èƒ½ä¸‹é™
- å­˜å‚¨ç©ºé—´è¾¾åˆ°ç‰©ç†æé™
- å¹¶å‘è®¿é—®æˆä¸ºç“¶é¢ˆ

åˆ†ç‰‡è§£å†³æ–¹æ¡ˆï¼š
- æ•°æ®åˆ†æ•£å­˜å‚¨ï¼Œé™ä½å•åº“å‹åŠ›
- å¹¶è¡ŒæŸ¥è¯¢ï¼Œæå‡æ•´ä½“æ€§èƒ½
- æ°´å¹³æ‰©å±•ï¼Œç†è®ºä¸Šæ— å®¹é‡é™åˆ¶
```

**ğŸ“Š åˆ†ç‰‡å‰åå¯¹æ¯”**
```
åˆ†ç‰‡å‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å•ä¸€æ•°æ®åº“        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1000ä¸‡æ¡ç”¨æˆ·æ•°æ® â”‚ â”‚  â† æ€§èƒ½ç“¶é¢ˆ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†ç‰‡åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“1    â”‚  â”‚   æ•°æ®åº“2    â”‚  â”‚   æ•°æ®åº“3    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚333ä¸‡æ•°æ®â”‚ â”‚  â”‚ â”‚333ä¸‡æ•°æ®â”‚ â”‚  â”‚ â”‚334ä¸‡æ•°æ®â”‚ â”‚  â† è´Ÿè½½å‡è¡¡
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 åˆ†ç‰‡è§„åˆ™çš„æ ¸å¿ƒè¦ç´ 


**ğŸ”‘ å…³é”®ç»„æˆéƒ¨åˆ†**
- **åˆ†ç‰‡é”®ï¼ˆSharding Keyï¼‰**ï¼šç”¨äºåˆ†ç‰‡çš„å­—æ®µ
- **åˆ†ç‰‡ç®—æ³•ï¼ˆSharding Algorithmï¼‰**ï¼šè®¡ç®—æ•°æ®åˆ†å¸ƒçš„æ–¹æ³•
- **åˆ†ç‰‡æ•°é‡ï¼ˆShard Countï¼‰**ï¼šæ€»å…±åˆ†æˆå¤šå°‘ä¸ªåˆ†ç‰‡
- **è·¯ç”±è§„åˆ™ï¼ˆRouting Ruleï¼‰**ï¼šæ ¹æ®åˆ†ç‰‡é”®æ‰¾åˆ°ç›®æ ‡åˆ†ç‰‡

---

## 2. ğŸ¯ åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥


### 2.1 åˆ†ç‰‡é”®çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ“‹ ä»€ä¹ˆæ˜¯åˆ†ç‰‡é”®**
```
åˆ†ç‰‡é”®ï¼šç”¨æ¥å†³å®šæ•°æ®åˆ†å¸ƒåˆ°å“ªä¸ªåˆ†ç‰‡çš„å…³é”®å­—æ®µ
ç‰¹ç‚¹ï¼šæ¯æ¡æ•°æ®æ ¹æ®åˆ†ç‰‡é”®çš„å€¼ï¼Œé€šè¿‡åˆ†ç‰‡ç®—æ³•ç¡®å®šå­˜å‚¨ä½ç½®
è¦æ±‚ï¼šåˆ†ç‰‡é”®å¿…é¡»åœ¨æŸ¥è¯¢ä¸­ç»å¸¸ä½¿ç”¨ï¼Œä¸”åˆ†å¸ƒè¦ç›¸å¯¹å‡åŒ€
```

> ğŸ”§ **å®è·µç†è§£**ï¼šåˆ†ç‰‡é”®å°±åƒæ˜¯å¿«é€’åŒ…è£¹çš„"åœ°å€æ ‡ç­¾"ï¼Œå¿«é€’å‘˜æ ¹æ®åœ°å€å†³å®šæŠŠåŒ…è£¹é€åˆ°å“ªä¸ªåŒºåŸŸã€‚

### 2.2 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™


**âœ… å¥½çš„åˆ†ç‰‡é”®ç‰¹å¾**
```
æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼š
- é¿å…æŸäº›åˆ†ç‰‡æ•°æ®è¿‡å¤šï¼ŒæŸäº›è¿‡å°‘
- ç¤ºä¾‹ï¼šç”¨æˆ·IDæ¯”ç”¨æˆ·ç±»å‹æ›´å‡åŒ€

æŸ¥è¯¢é¢‘ç‡é«˜ï¼š
- å¤§éƒ¨åˆ†æŸ¥è¯¢éƒ½ä¼šåŒ…å«åˆ†ç‰‡é”®
- é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢çš„æ€§èƒ½é—®é¢˜

ç›¸å¯¹ç¨³å®šï¼š
- åˆ†ç‰‡é”®å€¼ä¸åº”è¯¥é¢‘ç¹å˜æ›´
- å˜æ›´ä¼šå¯¼è‡´æ•°æ®è¿ç§»
```

**âŒ é¿å…çš„åˆ†ç‰‡é”®é€‰æ‹©**
```
æ—¶é—´å­—æ®µé—®é¢˜ï¼š
- æ–°æ•°æ®æ€»æ˜¯å†™å…¥æœ€æ–°åˆ†ç‰‡
- å†å²åˆ†ç‰‡idleï¼Œæœ€æ–°åˆ†ç‰‡hot
- é€ æˆå†™å…¥çƒ­ç‚¹é—®é¢˜

çŠ¶æ€å­—æ®µé—®é¢˜ï¼š
- å¤§éƒ¨åˆ†æ•°æ®å¯èƒ½é›†ä¸­åœ¨æŸä¸ªçŠ¶æ€
- å¦‚ï¼šè®¢å•çŠ¶æ€å¤§éƒ¨åˆ†æ˜¯"å·²å®Œæˆ"
- å¯¼è‡´æ•°æ®åˆ†å¸ƒæä¸å‡åŒ€
```

### 2.3 å¸¸è§åˆ†ç‰‡é”®é€‰æ‹©æ¡ˆä¾‹


| **ä¸šåŠ¡åœºæ™¯** | **æ¨èåˆ†ç‰‡é”®** | **åŸå› ** | **é¿å…é€‰æ‹©** |
|-------------|-------------|---------|-------------|
| **ç”¨æˆ·ç³»ç»Ÿ** | `user_id` | `åˆ†å¸ƒå‡åŒ€ï¼ŒæŸ¥è¯¢é¢‘ç¹` | `æ³¨å†Œæ—¶é—´ã€ç”¨æˆ·ç±»å‹` |
| **è®¢å•ç³»ç»Ÿ** | `user_id` æˆ– `order_id` | `ä¸šåŠ¡ç›¸å…³æ€§å¼º` | `è®¢å•çŠ¶æ€ã€åˆ›å»ºæ—¶é—´` |
| **å•†å“ç³»ç»Ÿ** | `product_id` | `è®¿é—®åˆ†æ•£` | `å•†å“åˆ†ç±»ã€ä»·æ ¼åŒºé—´` |
| **æ—¥å¿—ç³»ç»Ÿ** | `user_id + æ—¥æœŸ` | `æ—¶é—´+ç”¨æˆ·åŒé‡åˆ†æ•£` | `å•çº¯æ—¥æœŸå­—æ®µ` |

**ğŸ¯ åˆ†ç‰‡é”®é€‰æ‹©å†³ç­–æ ‘**
```
é€‰æ‹©åˆ†ç‰‡é”®çš„æ€è€ƒæµç¨‹ï¼š
           æ˜¯å¦æŸ¥è¯¢é¢‘ç¹ï¼Ÿ
          /            \
        æ˜¯              å¦
        |               |
   æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Ÿ      é‡æ–°é€‰æ‹©
      /     \
    æ˜¯       å¦
    |        |
  ç†æƒ³é€‰æ‹©   è€ƒè™‘å¤åˆé”®
```

---

## 3. âš™ï¸ å¸¸ç”¨åˆ†ç‰‡ç®—æ³•è¯¦è§£


### 3.1 å–æ¨¡åˆ†ç‰‡ç®—æ³•ï¼ˆmod-longï¼‰


**ğŸ“‹ ç®—æ³•åŸç†**
```java
// åŸºæœ¬å–æ¨¡ç®—æ³•
public int getShardIndex(Long shardingValue, int shardCount) {
    return Math.abs(shardingValue.hashCode()) % shardCount;
}
```

**ğŸ”¸ ç®—æ³•ç‰¹ç‚¹**
- **ç®€å•é«˜æ•ˆ**ï¼šè®¡ç®—å¤æ‚åº¦O(1)
- **åˆ†å¸ƒå‡åŒ€**ï¼šç†è®ºä¸Šæ•°æ®åˆ†å¸ƒç›¸å¯¹å‡åŒ€
- **æ‰©å®¹å›°éš¾**ï¼šå¢åŠ åˆ†ç‰‡éœ€è¦å¤§é‡æ•°æ®è¿ç§»

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```java
// ç”¨æˆ·è¡¨åˆ†ç‰‡é…ç½®
ç”¨æˆ·IDèŒƒå›´ï¼š1-1000000
åˆ†ç‰‡æ•°é‡ï¼š8ä¸ª
åˆ†ç‰‡è§„åˆ™ï¼šuser_id % 8

è®¡ç®—ç¤ºä¾‹ï¼š
user_id = 12345
åˆ†ç‰‡ç´¢å¼• = 12345 % 8 = 1
å­˜å‚¨åœ¨ï¼šuser_db_1

user_id = 67890  
åˆ†ç‰‡ç´¢å¼• = 67890 % 8 = 2
å­˜å‚¨åœ¨ï¼šuser_db_2
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šå–æ¨¡ç®—æ³•æœ€å¤§çš„é—®é¢˜æ˜¯æ‰©å®¹æ—¶éœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰æ•°æ®çš„åˆ†ç‰‡ä½ç½®ã€‚

### 3.2 èŒƒå›´åˆ†ç‰‡ç®—æ³•ï¼ˆrange-longï¼‰


**ğŸ“‹ ç®—æ³•åŸç†**
```java
// èŒƒå›´åˆ†ç‰‡é…ç½®
public class RangeShardingAlgorithm {
    // å®šä¹‰èŒƒå›´è¾¹ç•Œ
    private List<Long> boundaries = Arrays.asList(
        100000L, 200000L, 300000L, 400000L
    );
    
    public int getShardIndex(Long shardingValue) {
        for (int i = 0; i < boundaries.size(); i++) {
            if (shardingValue <= boundaries.get(i)) {
                return i;
            }
        }
        return boundaries.size(); // æœ€åä¸€ä¸ªåˆ†ç‰‡
    }
}
```

**ğŸ”¸ ç®—æ³•ç‰¹ç‚¹**
- **æ‰©å®¹å‹å¥½**ï¼šæ–°å¢åˆ†ç‰‡åªå½±å“è¾¹ç•Œæ•°æ®
- **èŒƒå›´æŸ¥è¯¢é«˜æ•ˆ**ï¼šåŒä¸€èŒƒå›´æ•°æ®åœ¨åŒä¸€åˆ†ç‰‡
- **å¯èƒ½æ•°æ®å€¾æ–œ**ï¼šæŸäº›èŒƒå›´æ•°æ®å¯èƒ½è¿‡å¤š

**ğŸ“Š èŒƒå›´åˆ†ç‰‡ç¤ºä¾‹**
```
ç”¨æˆ·IDåˆ†ç‰‡è§„åˆ™ï¼š
åˆ†ç‰‡0ï¼šuser_id <= 100000      (1-100000)
åˆ†ç‰‡1ï¼šuser_id <= 200000      (100001-200000)  
åˆ†ç‰‡2ï¼šuser_id <= 300000      (200001-300000)
åˆ†ç‰‡3ï¼šuser_id > 300000       (300001-âˆ)

æŸ¥è¯¢ä¼˜åŠ¿ï¼š
SELECT * FROM user WHERE user_id BETWEEN 150000 AND 180000
åªéœ€è¦æŸ¥è¯¢åˆ†ç‰‡1ï¼Œæ— éœ€è·¨åˆ†ç‰‡
```

### 3.3 ä¸€è‡´æ€§Hashç®—æ³•


**ğŸ“‹ ç®—æ³•åŸç†**
```java
public class ConsistentHashSharding {
    private TreeMap<Long, String> hashRing = new TreeMap<>();
    
    // æ„å»ºhashç¯
    public void addShard(String shardName, int virtualNodes) {
        for (int i = 0; i < virtualNodes; i++) {
            String virtualNode = shardName + "#" + i;
            long hash = hash(virtualNode);
            hashRing.put(hash, shardName);
        }
    }
    
    // æ‰¾åˆ°å¯¹åº”åˆ†ç‰‡
    public String getShard(Long shardingValue) {
        long hash = hash(shardingValue.toString());
        Map.Entry<Long, String> entry = hashRing.ceilingEntry(hash);
        return entry != null ? entry.getValue() : hashRing.firstEntry().getValue();
    }
}
```

**ğŸ”¸ ä¸€è‡´æ€§Hashç‰¹ç‚¹**
- **æ‰©å®¹å¹³æ»‘**ï¼šæ–°å¢èŠ‚ç‚¹åªå½±å“ç›¸é‚»èŠ‚ç‚¹æ•°æ®
- **è´Ÿè½½ç›¸å¯¹å‡è¡¡**ï¼šé€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æå‡å‡åŒ€æ€§
- **å¤æ‚åº¦è¾ƒé«˜**ï¼šå®ç°å’Œç»´æŠ¤ç›¸å¯¹å¤æ‚

**ğŸ”„ ä¸€è‡´æ€§Hashç¯ç¤ºæ„å›¾**
```
                    Hashç¯
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             Shard-A      Shard-B
           (Hash: 100)   (Hash: 200)
          /                       \
         /                         \
        /                           \
   Shard-D                     Shard-C
  (Hash: 400)               (Hash: 300)
        \                           /
         \                         /
          \                       /
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®åˆ†å¸ƒï¼š
- Hashå€¼ 0-100: å­˜å‚¨åœ¨ Shard-A
- Hashå€¼ 101-200: å­˜å‚¨åœ¨ Shard-B  
- Hashå€¼ 201-300: å­˜å‚¨åœ¨ Shard-C
- Hashå€¼ 301-400: å­˜å‚¨åœ¨ Shard-D
```

### 3.4 æŒ‰æ—¥æœŸåˆ†ç‰‡ç®—æ³•


**ğŸ“‹ æ—¶é—´åˆ†ç‰‡ç­–ç•¥**
```java
// æŒ‰æœˆåˆ†ç‰‡
public class DateShardingAlgorithm {
    public String getShard(Date createTime) {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMM");
        return "order_" + sdf.format(createTime);
    }
}

// æŒ‰å­£åº¦åˆ†ç‰‡  
public class QuarterShardingAlgorithm {
    public String getShard(Date createTime) {
        Calendar cal = Calendar.getInstance();
        cal.setTime(createTime);
        int year = cal.get(Calendar.YEAR);
        int month = cal.get(Calendar.MONTH) + 1;
        int quarter = (month - 1) / 3 + 1;
        return "order_" + year + "Q" + quarter;
    }
}
```

**ğŸ”¸ æ—¥æœŸåˆ†ç‰‡ç‰¹ç‚¹**
- **ä¸šåŠ¡è¯­ä¹‰æ¸…æ™°**ï¼šç¬¦åˆæ—¶é—´ç»´åº¦çš„ä¸šåŠ¡æŸ¥è¯¢
- **ä¾¿äºæ•°æ®æ¸…ç†**ï¼šè¿‡æœŸæ•°æ®æ•´è¡¨åˆ é™¤
- **å†™å…¥çƒ­ç‚¹é—®é¢˜**ï¼šæ–°æ•°æ®æ€»æ˜¯å†™å…¥æœ€æ–°åˆ†ç‰‡

**ğŸ“… æ—¥æœŸåˆ†ç‰‡åº”ç”¨åœºæ™¯**
```
è®¢å•ç³»ç»Ÿåˆ†ç‰‡ï¼š
order_202401  (2024å¹´1æœˆè®¢å•)
order_202402  (2024å¹´2æœˆè®¢å•)  
order_202403  (2024å¹´3æœˆè®¢å•)

æŸ¥è¯¢ä¼˜åŠ¿ï¼š
- æŸ¥è¯¢æŸä¸ªæœˆçš„è®¢å•ï¼šåªæŸ¥è¯¢å¯¹åº”æœˆä»½åˆ†ç‰‡
- ç»Ÿè®¡å­£åº¦æ•°æ®ï¼šæŸ¥è¯¢å¯¹åº”å­£åº¦çš„3ä¸ªåˆ†ç‰‡
- æ•°æ®å½’æ¡£ï¼šç›´æ¥æ“ä½œæ•´ä¸ªæœˆä»½çš„åˆ†ç‰‡
```

### 3.5 å­—ç¬¦ä¸²Hashåˆ†ç‰‡


**ğŸ“‹ å­—ç¬¦ä¸²å¤„ç†ç®—æ³•**
```java
public class StringHashSharding {
    public int getShard(String shardingValue, int shardCount) {
        // æ–¹æ³•1ï¼šä½¿ç”¨Javaå†…ç½®hashCode
        return Math.abs(shardingValue.hashCode()) % shardCount;
    }
    
    public int getShardByMurmur(String shardingValue, int shardCount) {
        // æ–¹æ³•2ï¼šä½¿ç”¨Murmur3ç®—æ³•ï¼ˆåˆ†å¸ƒæ›´å‡åŒ€ï¼‰
        int hash = MurmurHash.hash32(shardingValue.getBytes());
        return Math.abs(hash) % shardCount;
    }
}
```

**ğŸ”¸ å­—ç¬¦ä¸²åˆ†ç‰‡åº”ç”¨**
```
ç”¨æˆ·ååˆ†ç‰‡ç¤ºä¾‹ï¼š
username = "zhang_san"
hashå€¼ = "zhang_san".hashCode() = 123456789
åˆ†ç‰‡ç´¢å¼• = 123456789 % 4 = 1
å­˜å‚¨åœ¨ï¼šuser_db_1

å•†å“ç¼–ç åˆ†ç‰‡ï¼š
product_code = "PHONE_APPLE_001"  
hashå€¼ = "PHONE_APPLE_001".hashCode() = 987654321
åˆ†ç‰‡ç´¢å¼• = 987654321 % 8 = 1
å­˜å‚¨åœ¨ï¼šproduct_db_1
```

---

## 4. ğŸ”§ åˆ†ç‰‡è§„åˆ™é…ç½®ç®¡ç†


### 4.1 åˆ†ç‰‡é…ç½®æ–‡ä»¶ç»“æ„


**ğŸ“‹ å…¸å‹é…ç½®ç¤ºä¾‹ï¼ˆYAMLæ ¼å¼ï¼‰**
```yaml
# æ•°æ®æºé…ç½®
dataSources:
  user_db_0:
    url: jdbc:mysql://192.168.1.10:3306/user_db_0
    username: root
    password: password
  user_db_1:
    url: jdbc:mysql://192.168.1.11:3306/user_db_1
    username: root
    password: password

# åˆ†ç‰‡è§„åˆ™é…ç½®
shardingRule:
  tables:
    user:
      actualDataNodes: user_db_${0..1}.user_${0..3}
      databaseStrategy:
        standard:
          shardingColumn: user_id
          algorithmExpression: user_db_${user_id % 2}
      tableStrategy:
        standard:
          shardingColumn: user_id  
          algorithmExpression: user_${user_id % 4}
```

### 4.2 åŠ¨æ€é…ç½®ç®¡ç†


**ğŸ”„ é…ç½®çƒ­æ›´æ–°æœºåˆ¶**
```java
@Component
public class ShardingConfigManager {
    
    // é…ç½®å˜æ›´ç›‘å¬
    @EventListener
    public void onConfigChange(ConfigChangeEvent event) {
        if (event.getKey().startsWith("sharding.")) {
            reloadShardingConfig();
        }
    }
    
    // é‡æ–°åŠ è½½åˆ†ç‰‡é…ç½®
    private void reloadShardingConfig() {
        // 1. è¯»å–æ–°é…ç½®
        ShardingRuleConfiguration newConfig = loadConfig();
        
        // 2. éªŒè¯é…ç½®æœ‰æ•ˆæ€§
        validateConfig(newConfig);
        
        // 3. å¹³æ»‘åˆ‡æ¢åˆ°æ–°é…ç½®
        switchToNewConfig(newConfig);
    }
}
```

> ğŸ’¡ **å®è·µå»ºè®®**ï¼šé…ç½®å˜æ›´è¦è°¨æ…ï¼Œå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç°åº¦å‘å¸ƒç­–ç•¥ã€‚

### 4.3 åˆ†ç‰‡è§„åˆ™éªŒè¯


**âœ… é…ç½®éªŒè¯æ£€æŸ¥é¡¹**
```java
public class ShardingConfigValidator {
    
    public ValidationResult validate(ShardingConfig config) {
        List<String> errors = new ArrayList<>();
        
        // 1. æ£€æŸ¥åˆ†ç‰‡é”®æ˜¯å¦å­˜åœ¨
        if (!tableHasColumn(config.getTable(), config.getShardingColumn())) {
            errors.add("åˆ†ç‰‡é”®ä¸å­˜åœ¨äºè¡¨ç»“æ„ä¸­");
        }
        
        // 2. æ£€æŸ¥åˆ†ç‰‡æ•°é‡ä¸å®é™…èŠ‚ç‚¹åŒ¹é…
        if (config.getShardCount() != config.getDataNodes().size()) {
            errors.add("é…ç½®çš„åˆ†ç‰‡æ•°é‡ä¸å®é™…æ•°æ®èŠ‚ç‚¹ä¸åŒ¹é…");
        }
        
        // 3. æ£€æŸ¥ç®—æ³•è¡¨è¾¾å¼è¯­æ³•
        if (!isValidExpression(config.getAlgorithmExpression())) {
            errors.add("åˆ†ç‰‡ç®—æ³•è¡¨è¾¾å¼è¯­æ³•é”™è¯¯");
        }
        
        return new ValidationResult(errors.isEmpty(), errors);
    }
}
```

---

## 5. ğŸ›ï¸ å¤åˆåˆ†ç‰‡ä¸é«˜çº§ç­–ç•¥


### 5.1 å¤åˆåˆ†ç‰‡é”®è®¾è®¡


**ğŸ“‹ ä»€ä¹ˆæ˜¯å¤åˆåˆ†ç‰‡é”®**
```
å¤åˆåˆ†ç‰‡é”®ï¼šä½¿ç”¨å¤šä¸ªå­—æ®µç»„åˆä½œä¸ºåˆ†ç‰‡ä¾æ®
é€‚ç”¨åœºæ™¯ï¼šå•ä¸€å­—æ®µæ— æ³•æ»¡è¶³åˆ†ç‰‡å‡åŒ€æ€§è¦æ±‚
å¸¸è§ç»„åˆï¼šç”¨æˆ·ID + æ—¶é—´ã€åœ°åŒº + ç±»å‹ç­‰
```

**ğŸ”¸ å¤åˆåˆ†ç‰‡ç¤ºä¾‹**
```java
// è®¢å•è¡¨å¤åˆåˆ†ç‰‡ï¼šuser_id + åˆ›å»ºæ—¶é—´
public class CompositeShardingAlgorithm {
    
    public String getDatabaseShard(Long userId, Date createTime) {
        // æ ¹æ®ç”¨æˆ·IDç¡®å®šæ•°æ®åº“
        int dbIndex = userId.intValue() % 4;
        return "order_db_" + dbIndex;
    }
    
    public String getTableShard(Long userId, Date createTime) {
        // æ ¹æ®æ—¶é—´ç¡®å®šè¡¨
        String yearMonth = new SimpleDateFormat("yyyyMM").format(createTime);
        return "order_" + yearMonth;
    }
}
```

**ğŸ“Š å¤åˆåˆ†ç‰‡çš„æ•°æ®åˆ†å¸ƒ**
```
å¤åˆåˆ†ç‰‡ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  order_db_0 â”‚  order_db_1 â”‚  order_db_2 â”‚  order_db_3 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚order_202401 â”‚order_202401 â”‚order_202401 â”‚order_202401 â”‚
â”‚order_202402 â”‚order_202402 â”‚order_202402 â”‚order_202402 â”‚
â”‚order_202403 â”‚order_202403 â”‚order_202403 â”‚order_202403 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢ä¼˜åŠ¿ï¼š
- æŒ‰ç”¨æˆ·æŸ¥è¯¢ï¼šåªæŸ¥è¯¢å¯¹åº”çš„æ•°æ®åº“åˆ†ç‰‡
- æŒ‰æ—¶é—´æŸ¥è¯¢ï¼šåªæŸ¥è¯¢å¯¹åº”çš„æ—¶é—´è¡¨åˆ†ç‰‡  
- æŒ‰ç”¨æˆ·+æ—¶é—´ï¼šç²¾ç¡®å®šä½åˆ°å…·ä½“åˆ†ç‰‡
```

### 5.2 æšä¸¾åˆ†ç‰‡ç®—æ³•


**ğŸ“‹ æšä¸¾åˆ†ç‰‡åº”ç”¨åœºæ™¯**
```java
// æŒ‰åœ°åŒºåˆ†ç‰‡
public class RegionShardingAlgorithm {
    private Map<String, String> regionMapping = Map.of(
        "NORTH", "db_north",    // ååŒ—åœ°åŒº
        "SOUTH", "db_south",    // åå—åœ°åŒº  
        "EAST", "db_east",      // åä¸œåœ°åŒº
        "WEST", "db_west"       // åè¥¿åœ°åŒº
    );
    
    public String getShard(String region) {
        return regionMapping.getOrDefault(region, "db_default");
    }
}
```

**ğŸ”¸ æšä¸¾åˆ†ç‰‡ç‰¹ç‚¹**
- **ä¸šåŠ¡è¯­ä¹‰æ˜ç¡®**ï¼šåˆ†ç‰‡ä¸ä¸šåŠ¡é€»è¾‘å¼ºç›¸å…³
- **æŸ¥è¯¢æ•ˆç‡é«˜**ï¼šç›¸å…³æ•°æ®é›†ä¸­å­˜å‚¨
- **æ‰©å±•éœ€è¦è§„åˆ’**ï¼šæ–°å¢æšä¸¾å€¼éœ€è¦é¢„å…ˆè€ƒè™‘

---

## 6. ğŸ”¥ çƒ­ç‚¹æ•°æ®å¤„ç†


### 6.1 çƒ­ç‚¹é—®é¢˜è¯†åˆ«


**âš ï¸ å¸¸è§çƒ­ç‚¹åœºæ™¯**
```
æ—¶é—´çƒ­ç‚¹ï¼š
- æ–°æ³¨å†Œç”¨æˆ·é›†ä¸­åœ¨æœ€æ–°åˆ†ç‰‡
- å½“æ—¥è®¢å•å…¨éƒ¨å†™å…¥ä»Šæ—¥åˆ†ç‰‡  
- å¯¼è‡´å†™å…¥å‹åŠ›é›†ä¸­

æ•°æ®çƒ­ç‚¹ï¼š
- æ˜æ˜Ÿç”¨æˆ·æ•°æ®è®¿é—®é¢‘ç¹
- çˆ†æ¬¾å•†å“æŸ¥è¯¢é›†ä¸­
- çƒ­é—¨è¯é¢˜ç›¸å…³æ•°æ®

ä¸šåŠ¡çƒ­ç‚¹ï¼š
- ä¿ƒé”€æ´»åŠ¨æœŸé—´æŸäº›å•†å“
- çƒ­ç‚¹æ–°é—»ç›¸å…³å†…å®¹
- èŠ‚å‡æ—¥ç‰¹å®šä¸šåŠ¡æ•°æ®
```

### 6.2 çƒ­ç‚¹æ•°æ®åˆ†æ•£ç­–ç•¥


**ğŸ¯ æ—¶é—´çƒ­ç‚¹è§£å†³æ–¹æ¡ˆ**
```java
// åŠ å…¥éšæœºå› å­åˆ†æ•£çƒ­ç‚¹
public class HotspotAvoidanceAlgorithm {
    
    public String getShardWithRandom(Long userId, Date createTime) {
        // åŸºç¡€åˆ†ç‰‡é€»è¾‘
        String baseShard = getBaseShard(userId, createTime);
        
        // æ·»åŠ éšæœºåç¼€åˆ†æ•£å†™å…¥
        int randomSuffix = userId.intValue() % 10;
        return baseShard + "_" + randomSuffix;
    }
    
    // æŸ¥è¯¢æ—¶éœ€è¦æŸ¥è¯¢æ‰€æœ‰å¯èƒ½çš„åˆ†ç‰‡
    public List<String> getAllPossibleShards(Long userId, Date createTime) {
        String basePattern = getBaseShard(userId, createTime);
        return IntStream.range(0, 10)
                .mapToObj(i -> basePattern + "_" + i)
                .collect(Collectors.toList());
    }
}
```

**ğŸ“Š çƒ­ç‚¹åˆ†æ•£æ•ˆæœå¯¹æ¯”**
```
åˆ†æ•£å‰ï¼š
order_202401: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (100%å†™å…¥å‹åŠ›)

åˆ†æ•£åï¼š  
order_202401_0: â–ˆâ–ˆ (10%å†™å…¥å‹åŠ›)
order_202401_1: â–ˆâ–ˆ (10%å†™å…¥å‹åŠ›)
order_202401_2: â–ˆâ–ˆ (10%å†™å…¥å‹åŠ›)
...
order_202401_9: â–ˆâ–ˆ (10%å†™å…¥å‹åŠ›)
```

> ğŸ’¡ **æƒè¡¡è€ƒè™‘**ï¼šçƒ­ç‚¹åˆ†æ•£ä¼šå¢åŠ æŸ¥è¯¢å¤æ‚åº¦ï¼Œéœ€è¦åœ¨å†™å…¥æ€§èƒ½å’ŒæŸ¥è¯¢ä¾¿åˆ©æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚

### 6.3 ç¼“å­˜ä¸çƒ­ç‚¹æ•°æ®


**ğŸ”„ ç¼“å­˜ç­–ç•¥é…åˆ**
```java
@Service  
public class HotDataService {
    
    @Cacheable(value = "hotUser", key = "#userId")
    public User getHotUser(Long userId) {
        // çƒ­ç‚¹ç”¨æˆ·æ•°æ®ä¼˜å…ˆä»ç¼“å­˜è·å–
        return userMapper.selectById(userId);
    }
    
    @CacheEvict(value = "hotUser", key = "#user.userId")
    public void updateHotUser(User user) {
        // æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
        userMapper.updateById(user);
    }
}
```

---

## 7. ğŸ”„ åŠ¨æ€åˆ†ç‰‡ç®¡ç†


### 7.1 åœ¨çº¿æ‰©å®¹ç­–ç•¥


**ğŸ“‹ æ‰©å®¹æ­¥éª¤æµç¨‹**
```
åŠ¨æ€æ‰©å®¹æµç¨‹ï¼š
1. æ·»åŠ æ–°çš„æ•°æ®åº“èŠ‚ç‚¹
2. ä¿®æ”¹åˆ†ç‰‡é…ç½®æ–‡ä»¶
3. æ‰§è¡Œæ•°æ®é‡æ–°åˆ†å¸ƒ  
4. éªŒè¯æ•°æ®å®Œæ•´æ€§
5. åˆ‡æ¢è·¯ç”±è§„åˆ™
6. æ¸…ç†æ—§æ•°æ®
```

**ğŸ”§ æ‰©å®¹å®ç°ç¤ºä¾‹**
```java
@Component
public class DynamicShardingManager {
    
    // åœ¨çº¿æ·»åŠ åˆ†ç‰‡
    public void addShard(String newShardName, DataSource dataSource) {
        // 1. æ³¨å†Œæ–°æ•°æ®æº
        shardingDataSourceMap.put(newShardName, dataSource);
        
        // 2. æ›´æ–°åˆ†ç‰‡è§„åˆ™
        updateShardingRule(newShardName);
        
        // 3. æ‰§è¡Œæ•°æ®è¿ç§»ï¼ˆå¼‚æ­¥ï¼‰
        asyncDataMigration(newShardName);
    }
    
    // æ•°æ®è¿ç§»é€»è¾‘
    private void asyncDataMigration(String targetShard) {
        CompletableFuture.runAsync(() -> {
            // è®¡ç®—éœ€è¦è¿ç§»çš„æ•°æ®
            List<DataMigrationTask> tasks = calculateMigrationTasks();
            
            // æ‰¹é‡è¿ç§»æ•°æ®
            for (DataMigrationTask task : tasks) {
                migrateDataBatch(task);
            }
        });
    }
}
```

### 7.2 åˆ†ç‰‡ç¼©å®¹ç®¡ç†


**âš ï¸ ç¼©å®¹æ³¨æ„äº‹é¡¹**
```
ç¼©å®¹å‰æ£€æŸ¥ï¼š
âœ… ç¡®è®¤è¦ä¸‹çº¿çš„åˆ†ç‰‡æ•°æ®å·²è¿ç§»å®Œæˆ
âœ… éªŒè¯æ–°åˆ†ç‰‡è§„åˆ™ä¸‹æ•°æ®åˆ†å¸ƒå‡åŒ€
âœ… ç¡®ä¿æ‰€æœ‰åº”ç”¨å·²æ›´æ–°é…ç½®
âœ… å‡†å¤‡å›æ»šæ–¹æ¡ˆä»¥é˜²å‡ºç°é—®é¢˜
```

### 7.3 åˆ†ç‰‡ç›‘æ§ä¸æŠ¥è­¦


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```yaml
# åˆ†ç‰‡ç›‘æ§é…ç½®
monitoring:
  metrics:
    - name: shard_data_count
      description: å„åˆ†ç‰‡æ•°æ®é‡
      threshold: 10000000  # å•åˆ†ç‰‡æ•°æ®é‡å‘Šè­¦
      
    - name: shard_query_latency  
      description: åˆ†ç‰‡æŸ¥è¯¢å»¶è¿Ÿ
      threshold: 1000ms    # æŸ¥è¯¢å»¶è¿Ÿå‘Šè­¦
      
    - name: cross_shard_query_ratio
      description: è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹  
      threshold: 30%       # è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹å‘Šè­¦
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†ç‰‡è§„åˆ™ï¼šæ•°æ®åˆ†å¸ƒçš„æ ¸å¿ƒç®—æ³•ï¼Œå†³å®šç³»ç»Ÿæ‰©å±•æ€§
ğŸ”¸ åˆ†ç‰‡é”®é€‰æ‹©ï¼šå½±å“æŸ¥è¯¢æ€§èƒ½å’Œæ•°æ®åˆ†å¸ƒçš„å…³é”®å†³ç­–
ğŸ”¸ å¸¸ç”¨ç®—æ³•ï¼šå–æ¨¡ã€èŒƒå›´ã€ä¸€è‡´æ€§Hashå„æœ‰é€‚ç”¨åœºæ™¯
ğŸ”¸ çƒ­ç‚¹å¤„ç†ï¼šé¿å…æ•°æ®å€¾æ–œï¼Œä¿è¯ç³»ç»Ÿè´Ÿè½½å‡è¡¡
ğŸ”¸ åŠ¨æ€ç®¡ç†ï¼šæ”¯æŒåœ¨çº¿æ‰©ç¼©å®¹ï¼Œæ»¡è¶³ä¸šåŠ¡å¢é•¿éœ€æ±‚
```

### 8.2 å…³é”®å†³ç­–è¦ç‚¹


**ğŸ”¹ åˆ†ç‰‡ç®—æ³•é€‰æ‹©æŒ‡å—**
```
æ•°æ®é‡ç¨³å®š + æŸ¥è¯¢å‡åŒ€ â†’ å–æ¨¡åˆ†ç‰‡
æ•°æ®æœ‰æ˜æ˜¾èŒƒå›´ç‰¹å¾ â†’ èŒƒå›´åˆ†ç‰‡  
éœ€è¦é¢‘ç¹æ‰©å®¹ â†’ ä¸€è‡´æ€§Hash
æœ‰æ˜ç¡®ä¸šåŠ¡åˆ†ç±» â†’ æšä¸¾åˆ†ç‰‡
æ—¶é—´åºåˆ—æ•°æ® â†’ æŒ‰æ—¶é—´åˆ†ç‰‡
```

**ğŸ”¹ åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™**
```
ä¼˜å…ˆçº§æ’åºï¼š
1. æŸ¥è¯¢é¢‘ç‡ï¼ˆæœ€é‡è¦ï¼‰
2. æ•°æ®åˆ†å¸ƒå‡åŒ€æ€§
3. ä¸šåŠ¡ç›¸å…³æ€§
4. å­—æ®µç¨³å®šæ€§
```

### 8.3 å®è·µç»éªŒæ€»ç»“


**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- **å…ˆä¸šåŠ¡åæŠ€æœ¯**ï¼šæ ¹æ®ä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼é€‰æ‹©åˆ†ç‰‡ç­–ç•¥
- **ç›‘æ§é©±åŠ¨**ï¼šå»ºç«‹å®Œå–„çš„åˆ†ç‰‡ç›‘æ§ä½“ç³»
- **é€æ­¥æ¼”è¿›**ï¼šä»ç®€å•åˆ†ç‰‡å¼€å§‹ï¼Œæ ¹æ®éœ€è¦é€æ­¥ä¼˜åŒ–
- **é¢„ç•™æ‰©å±•**ï¼šè®¾è®¡æ—¶è€ƒè™‘æœªæ¥æ‰©å®¹çš„å¯èƒ½æ€§

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
- é¿å…é€‰æ‹©ç»å¸¸å˜åŒ–çš„å­—æ®µä½œä¸ºåˆ†ç‰‡é”®
- é¿å…è¿‡åº¦å¤æ‚çš„åˆ†ç‰‡è§„åˆ™
- é¿å…å¿½è§†è·¨åˆ†ç‰‡æŸ¥è¯¢çš„æ€§èƒ½å½±å“
- é¿å…åœ¨æ²¡æœ‰ç›‘æ§çš„æƒ…å†µä¸‹è¿›è¡Œåˆ†ç‰‡è°ƒæ•´

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åˆ†ç‰‡è§„åˆ™æ˜¯åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒï¼Œé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®å’Œç®—æ³•è‡³å…³é‡è¦
- ä¸åŒåˆ†ç‰‡ç®—æ³•æœ‰å„è‡ªçš„é€‚ç”¨åœºæ™¯ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©
- çƒ­ç‚¹æ•°æ®å¤„ç†å’ŒåŠ¨æ€æ‰©å®¹æ˜¯å®é™…åº”ç”¨ä¸­çš„é‡è¦è€ƒè™‘å› ç´ 
- é…ç½®ç®¡ç†å’Œç›‘æ§ä½“ç³»æ˜¯ä¿è¯åˆ†ç‰‡ç³»ç»Ÿç¨³å®šè¿è¡Œçš„åŸºç¡€