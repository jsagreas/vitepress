---
title: 9ã€åˆ†ç‰‡å¼•æ“ä¸è§„åˆ™é…ç½®
---
## ğŸ“š ç›®å½•

1. [åˆ†ç‰‡å¼•æ“åŸºç¡€æ¦‚å¿µ](#1-åˆ†ç‰‡å¼•æ“åŸºç¡€æ¦‚å¿µ)
2. [åˆ†ç‰‡ç­–ç•¥ç±»å‹è¯¦è§£](#2-åˆ†ç‰‡ç­–ç•¥ç±»å‹è¯¦è§£)
3. [åˆ†ç‰‡ç®—æ³•å®ç°](#3-åˆ†ç‰‡ç®—æ³•å®ç°)
4. [è¡Œè¡¨è¾¾å¼è¯­æ³•è¯¦è§£](#4-è¡Œè¡¨è¾¾å¼è¯­æ³•è¯¦è§£)
5. [å¤åˆåˆ†ç‰‡é”®é…ç½®](#5-å¤åˆåˆ†ç‰‡é”®é…ç½®)
6. [ç‰¹æ®Šåˆ†ç‰‡é…ç½®](#6-ç‰¹æ®Šåˆ†ç‰‡é…ç½®)
7. [åˆ†ç‰‡è§„åˆ™éªŒè¯ä¸æµ‹è¯•](#7-åˆ†ç‰‡è§„åˆ™éªŒè¯ä¸æµ‹è¯•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ åˆ†ç‰‡å¼•æ“åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†ç‰‡å¼•æ“


**ç®€å•ç†è§£**ï¼šåˆ†ç‰‡å¼•æ“å°±åƒä¸€ä¸ª**æ™ºèƒ½è·¯ç”±å™¨**ï¼Œå®ƒå†³å®šä½ çš„SQLè¯­å¥åº”è¯¥å‘é€åˆ°å“ªä¸ªæ•°æ®åº“ã€å“ªå¼ è¡¨ã€‚

```
æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š
ä½ æœ‰ä¸€ä¸ªç”¨æˆ·è¡¨ï¼Œæ•°æ®å¤ªå¤šäº†ï¼Œåˆ†æˆäº†4ä¸ªåº“ï¼Œæ¯ä¸ªåº“2å¼ è¡¨
ç”¨æˆ·ID=12345 çš„æ•°æ®åº”è¯¥å­˜åœ¨å“ªé‡Œï¼Ÿ
åˆ†ç‰‡å¼•æ“å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼

åŸå§‹SQL: SELECT * FROM user WHERE id = 12345
åˆ†ç‰‡å: å‘é€åˆ° db1.user_1 è¡¨
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ“ **è·¯ç”±å®šä½**ï¼šæ ¹æ®åˆ†ç‰‡é”®ç¡®å®šç›®æ ‡æ•°æ®æºå’Œè¡¨
- ğŸ”„ **SQLæ”¹å†™**ï¼šå°†é€»è¾‘è¡¨åæ›¿æ¢ä¸ºå®é™…è¡¨å
- ğŸ“Š **ç»“æœåˆå¹¶**ï¼šå°†å¤šä¸ªåˆ†ç‰‡çš„æŸ¥è¯¢ç»“æœåˆå¹¶
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…å…¨è¡¨æ‰«æï¼Œç²¾å‡†å®šä½

### 1.2 åˆ†ç‰‡å¼•æ“å·¥ä½œæµç¨‹


```
ç”¨æˆ·å‘èµ·SQLè¯·æ±‚
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  SQLè§£æ    â”‚ â† è§£æSQLè¯­å¥ç»“æ„
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  åˆ†ç‰‡è·¯ç”±   â”‚ â† æ ¹æ®åˆ†ç‰‡è§„åˆ™ç¡®å®šç›®æ ‡
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  SQLæ”¹å†™    â”‚ â† æ›¿æ¢é€»è¾‘è¡¨åä¸ºå®é™…è¡¨å
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  æ‰§è¡ŒSQL    â”‚ â† å‘é€åˆ°ç›®æ ‡æ•°æ®æºæ‰§è¡Œ
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ç»“æœåˆå¹¶   â”‚ â† åˆå¹¶å¤šä¸ªåˆ†ç‰‡ç»“æœ
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
     è¿”å›ç»“æœç»™ç”¨æˆ·
```

### 1.3 åˆ†ç‰‡è§„åˆ™ç»„æˆéƒ¨åˆ†


**åˆ†ç‰‡è§„åˆ™ = åˆ†ç‰‡ç­–ç•¥ + åˆ†ç‰‡ç®—æ³•**

```yaml
# è¿™å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„åˆ†ç‰‡è§„åˆ™
rules:
  - !SHARDING
    tables:
      user:                        # é€»è¾‘è¡¨å
        actualDataNodes: ds${0..1}.user_${0..1}  # å®é™…èŠ‚ç‚¹
        tableStrategy:             # è¡¨åˆ†ç‰‡ç­–ç•¥
          standard:
            shardingColumn: id     # åˆ†ç‰‡é”®
            shardingAlgorithmName: user_table_hash
    shardingAlgorithms:
      user_table_hash:             # åˆ†ç‰‡ç®—æ³•
        type: HASH_MOD
        props:
          sharding-count: 2
```

---

## 2. ğŸ¯ åˆ†ç‰‡ç­–ç•¥ç±»å‹è¯¦è§£


### 2.1 StandardShardingStrategyï¼ˆæ ‡å‡†åˆ†ç‰‡ï¼‰


**æœ€å¸¸ç”¨çš„åˆ†ç‰‡ç­–ç•¥**ï¼Œæ”¯æŒ`=`ã€`IN`ã€`BETWEEN AND`ç­‰æ¡ä»¶æŸ¥è¯¢

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**
- æ ¹æ®å•ä¸ªå­—æ®µè¿›è¡Œåˆ†ç‰‡ï¼ˆå¦‚ç”¨æˆ·IDã€è®¢å•IDï¼‰
- æŸ¥è¯¢æ¡ä»¶æ˜ç¡®ï¼Œæ”¯æŒç²¾ç¡®åŒ¹é…
- å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯çš„é¦–é€‰æ–¹æ¡ˆ

```yaml
# æ ‡å‡†åˆ†ç‰‡é…ç½®ç¤ºä¾‹
tableStrategy:
  standard:
    shardingColumn: user_id        # åˆ†ç‰‡é”®ï¼šç”¨æˆ·ID
    shardingAlgorithmName: user_hash_mod

# æ”¯æŒçš„SQLæŸ¥è¯¢ç±»å‹
SELECT * FROM user WHERE user_id = 1001;           # âœ… æ”¯æŒ
SELECT * FROM user WHERE user_id IN (1001,1002);   # âœ… æ”¯æŒ  
SELECT * FROM user WHERE user_id BETWEEN 1000 AND 2000; # âœ… æ”¯æŒ
```

**å·¥ä½œåŸç†**ï¼š
```
æŸ¥è¯¢æ¡ä»¶: user_id = 1001
1. æå–åˆ†ç‰‡å€¼: 1001
2. æ‰§è¡Œç®—æ³•: 1001 % 4 = 1
3. è·¯ç”±ç»“æœ: user_1 è¡¨
```

### 2.2 ComplexShardingStrategyï¼ˆå¤åˆåˆ†ç‰‡ï¼‰


**ç”¨äºå¤šå­—æ®µè”åˆåˆ†ç‰‡**ï¼Œå½“å•ä¸ªå­—æ®µæ— æ³•æ»¡è¶³åˆ†ç‰‡éœ€æ±‚æ—¶ä½¿ç”¨

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**
- éœ€è¦åŒæ—¶è€ƒè™‘å¤šä¸ªå­—æ®µï¼ˆå¦‚ç”¨æˆ·ID + æ—¶é—´ï¼‰
- ä¸šåŠ¡é€»è¾‘å¤æ‚ï¼Œå•ä¸€å­—æ®µåˆ†ç‰‡ä¸å‡åŒ€
- éœ€è¦è‡ªå®šä¹‰å¤æ‚çš„åˆ†ç‰‡é€»è¾‘

```yaml
# å¤åˆåˆ†ç‰‡é…ç½®
tableStrategy:
  complex:
    shardingColumns: user_id,create_time    # å¤šä¸ªåˆ†ç‰‡é”®
    shardingAlgorithmName: user_complex_algorithm

# è‡ªå®šä¹‰å¤åˆåˆ†ç‰‡ç®—æ³•
public class UserComplexAlgorithm implements ComplexKeysShardingAlgorithm<String> {
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames, 
                                       ComplexKeysShardingValue<String> shardingValue) {
        // è·å–ç”¨æˆ·IDå’Œæ—¶é—´
        Long userId = (Long) shardingValue.getColumnNameAndShardingValuesMap().get("user_id");
        Date createTime = (Date) shardingValue.getColumnNameAndShardingValuesMap().get("create_time");
        
        // å¤åˆåˆ†ç‰‡é€»è¾‘ï¼šç”¨æˆ·IDå–æ¨¡ + æ—¶é—´å¹´ä»½
        int tableIndex = (int)(userId % 2) + (createTime.getYear() % 2);
        return Collections.singletonList("user_" + tableIndex);
    }
}
```

### 2.3 InlineShardingStrategyï¼ˆè¡Œè¡¨è¾¾å¼åˆ†ç‰‡ï¼‰


**ä½¿ç”¨ç®€å•è¡¨è¾¾å¼è¿›è¡Œåˆ†ç‰‡**ï¼Œé…ç½®ç®€å•ï¼Œé€‚åˆè§„åˆ™å›ºå®šçš„åœºæ™¯

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**
- åˆ†ç‰‡è§„åˆ™ç®€å•å›ºå®š
- ä¸éœ€è¦å¤æ‚çš„ç®—æ³•é€»è¾‘
- å¿«é€Ÿé…ç½®ï¼Œä»£ç é‡å°‘

```yaml
# è¡Œè¡¨è¾¾å¼åˆ†ç‰‡é…ç½®
tableStrategy:
  inline:
    shardingColumn: order_id
    algorithmExpression: order_${order_id % 4}    # è¡¨è¾¾å¼åˆ†ç‰‡

# ç­‰ä»·çš„Javaä»£ç é€»è¾‘
// order_id % 4 çš„ç»“æœå†³å®šè·¯ç”±åˆ°å“ªå¼ è¡¨
// order_id = 1001 â†’ order_1
// order_id = 1002 â†’ order_2
```

**è¡¨è¾¾å¼è¯­æ³•**ï¼š
```groovy
# åŸºç¡€å–æ¨¡
user_${user_id % 4}

# æ—¶é—´åˆ†ç‰‡
order_${create_time.format('yyyy_MM')}

# ç»„åˆè¡¨è¾¾å¼
log_${user_id % 2}_${create_time.format('yyyy')}
```

### 2.4 HintShardingStrategyï¼ˆå¼ºåˆ¶åˆ†ç‰‡ï¼‰


**é€šè¿‡ä»£ç å¼ºåˆ¶æŒ‡å®šåˆ†ç‰‡**ï¼Œç»•è¿‡SQLè§£æï¼Œç›´æ¥æŒ‡å®šç›®æ ‡

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**
- SQLæ— æ³•æå–åˆ†ç‰‡é”®ï¼ˆå¦‚å­æŸ¥è¯¢ã€èšåˆæŸ¥è¯¢ï¼‰
- éœ€è¦ä¸´æ—¶æŒ‡å®šç‰¹å®šåˆ†ç‰‡
- ç®¡ç†æ“ä½œæˆ–æ•°æ®è¿ç§»

```java
// å¼ºåˆ¶è·¯ç”±ç¤ºä¾‹
HintManager hintManager = HintManager.getInstance();
try {
    // å¼ºåˆ¶è·¯ç”±åˆ°æŒ‡å®šæ•°æ®æº
    hintManager.addDatabaseShardingValue("user", 1);
    // å¼ºåˆ¶è·¯ç”±åˆ°æŒ‡å®šè¡¨
    hintManager.addTableShardingValue("user", 2);
    
    // æ‰§è¡ŒæŸ¥è¯¢ï¼Œä¼šè·¯ç”±åˆ° ds1.user_2
    List<User> users = userService.findAll();
} finally {
    hintManager.close();
}
```

### 2.5 NoneShardingStrategyï¼ˆä¸åˆ†ç‰‡ï¼‰


**ä¸è¿›è¡Œåˆ†ç‰‡å¤„ç†**ï¼Œé€‚ç”¨äºå¹¿æ’­è¡¨æˆ–å…¨å±€è¡¨

```yaml
# é…ç½®ç¤ºä¾‹
tables:
  config_table:
    actualDataNodes: ds${0..3}.config_table
    tableStrategy:
      none: ~    # ä¸åˆ†ç‰‡ï¼Œå¹¿æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹
```

## 3. âš™ï¸ åˆ†ç‰‡ç®—æ³•å®ç°


### 3.1 å†…ç½®åˆ†ç‰‡ç®—æ³•ç±»å‹


**ğŸ”¸ HASH_MODï¼ˆå“ˆå¸Œå–æ¨¡ï¼‰**
```yaml
shardingAlgorithms:
  user_hash_mod:
    type: HASH_MOD
    props:
      sharding-count: 4    # åˆ†ç‰‡æ•°é‡
      
# ç®—æ³•é€»è¾‘ï¼šhash(sharding_value) % sharding_count
```

**ğŸ”¸ BOUNDARY_RANGEï¼ˆè¾¹ç•ŒèŒƒå›´ï¼‰**
```yaml
shardingAlgorithms:
  order_boundary:
    type: BOUNDARY_RANGE
    props:
      sharding-ranges: 1000,2000,3000    # è¾¹ç•Œå€¼
      
# èŒƒå›´åˆ†ç‰‡ï¼š
# id < 1000  â†’ shard 0
# 1000 â‰¤ id < 2000 â†’ shard 1  
# 2000 â‰¤ id < 3000 â†’ shard 2
# id â‰¥ 3000 â†’ shard 3
```

**ğŸ”¸ VOLUME_RANGEï¼ˆå®¹é‡èŒƒå›´ï¼‰**
```yaml
shardingAlgorithms:
  order_volume:
    type: VOLUME_RANGE
    props:
      range-lower: 1        # èµ·å§‹å€¼
      range-upper: 1000000  # ç»“æŸå€¼
      sharding-volume: 10000 # æ¯ç‰‡å®¹é‡
      
# æ¯10000ä¸ªIDä¸€ä¸ªåˆ†ç‰‡
# 1-10000 â†’ shard0, 10001-20000 â†’ shard1
```

### 3.2 è‡ªå®šä¹‰åˆ†ç‰‡ç®—æ³•


```java
/**
 * è‡ªå®šä¹‰ç”¨æˆ·åˆ†ç‰‡ç®—æ³•
 * è§„åˆ™ï¼šVIPç”¨æˆ·å’Œæ™®é€šç”¨æˆ·åˆ†å¼€å­˜å‚¨
 */
public class UserTypeShardingAlgorithm implements StandardShardingAlgorithm<Long> {
    
    @Override
    public String doSharding(Collection<String> availableTargetNames, 
                           PreciseShardingValue<Long> shardingValue) {
        Long userId = shardingValue.getValue();
        
        // ä¸šåŠ¡é€»è¾‘ï¼šæ ¹æ®ç”¨æˆ·IDåˆ¤æ–­ç”¨æˆ·ç±»å‹
        if (isVipUser(userId)) {
            // VIPç”¨æˆ·è·¯ç”±åˆ°ä¸“é—¨çš„è¡¨
            return "user_vip";
        } else {
            // æ™®é€šç”¨æˆ·æ ¹æ®IDå–æ¨¡åˆ†ç‰‡
            int shardIndex = (int)(userId % 4);
            return "user_" + shardIndex;
        }
    }
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames, 
                                       RangeShardingValue<Long> shardingValue) {
        // èŒƒå›´æŸ¥è¯¢æ—¶çš„å¤„ç†é€»è¾‘
        Range<Long> range = shardingValue.getValueRange();
        List<String> result = new ArrayList<>();
        
        // æ£€æŸ¥èŒƒå›´å†…å¯èƒ½æ¶‰åŠçš„æ‰€æœ‰åˆ†ç‰‡
        for (String targetName : availableTargetNames) {
            if (isRangeMatchTarget(range, targetName)) {
                result.add(targetName);
            }
        }
        return result;
    }
    
    private boolean isVipUser(Long userId) {
        // ç®€å•è§„åˆ™ï¼šç”¨æˆ·ID > 1000000 ä¸ºVIP
        return userId > 1000000L;
    }
}
```

## 4. ğŸ“ è¡Œè¡¨è¾¾å¼è¯­æ³•è¯¦è§£


### 4.1 åŸºç¡€è¯­æ³•è§„åˆ™


**è¡Œè¡¨è¾¾å¼ä½¿ç”¨Groovyè¯­æ³•**ï¼Œæ”¯æŒä¸°å¯Œçš„è¡¨è¾¾å¼æ“ä½œ

```groovy
# åŸºç¡€æ ¼å¼
${expression}

# å¸¸ç”¨æ“ä½œç¬¦
%     # å–æ¨¡è¿ç®—
+     # åŠ æ³•
-     # å‡æ³•  
*     # ä¹˜æ³•
/     # é™¤æ³•
```

### 4.2 æ•°æ®èŠ‚ç‚¹è¡¨è¾¾å¼


```yaml
# åº“è¡¨ç»„åˆè¡¨è¾¾å¼
actualDataNodes: ds${0..1}.user_${0..3}
# å±•å¼€ç»“æœï¼š
# ds0.user_0, ds0.user_1, ds0.user_2, ds0.user_3
# ds1.user_0, ds1.user_1, ds1.user_2, ds1.user_3

# ä¸è¿ç»­æ•°å­—
actualDataNodes: ds${[0,2,4]}.order_${[1,3,5]}

# å­—ç¬¦ä¸²èŠ‚ç‚¹
actualDataNodes: ds_${['bj','sh','gz']}.user_${0..1}
```

### 4.3 åˆ†ç‰‡è¡¨è¾¾å¼ç¤ºä¾‹


```yaml
# åŸºç¡€å–æ¨¡åˆ†ç‰‡
algorithmExpression: user_${user_id % 4}

# æ—¶é—´åˆ†ç‰‡ï¼ˆæŒ‰æœˆï¼‰
algorithmExpression: order_${create_time.format('yyyyMM')}

# å¤åˆæ¡ä»¶åˆ†ç‰‡
algorithmExpression: log_${(user_id.hashCode() ^ ip.hashCode()) % 8}

# å­—ç¬¦ä¸²å¤„ç†
algorithmExpression: user_${name.substring(0,1).toLowerCase()}
```

### 4.4 æ—¶é—´å¤„ç†è¡¨è¾¾å¼


```groovy
# æŒ‰å¹´åˆ†ç‰‡
order_${create_time.format('yyyy')}

# æŒ‰å¹´æœˆåˆ†ç‰‡  
order_${create_time.format('yyyy_MM')}

# æŒ‰å­£åº¦åˆ†ç‰‡
order_Q${(create_time.month-1)/3 + 1}_${create_time.format('yyyy')}

# æŒ‰å‘¨åˆ†ç‰‡
log_W${create_time.format('w')}_${create_time.format('yyyy')}
```

## 5. ğŸ”— å¤åˆåˆ†ç‰‡é”®é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯å¤åˆåˆ†ç‰‡é”®


**å¤åˆåˆ†ç‰‡é”®**å°±æ˜¯ç”¨å¤šä¸ªå­—æ®µç»„åˆèµ·æ¥å†³å®šæ•°æ®å­˜å‚¨ä½ç½®ï¼Œæ¯”å•ä¸€å­—æ®µåˆ†ç‰‡æ›´çµæ´»ã€‚

**ğŸ”¸ ä½¿ç”¨åœºæ™¯**
- å•ä¸€å­—æ®µåˆ†ç‰‡ä¸å‡åŒ€
- ä¸šåŠ¡æŸ¥è¯¢æ¶‰åŠå¤šä¸ªæ¡ä»¶
- éœ€è¦æ›´ç²¾ç»†çš„æ•°æ®åˆ†å¸ƒæ§åˆ¶

```
ä¸¾ä¾‹ï¼šç”µå•†è®¢å•è¡¨
- åªç”¨ç”¨æˆ·IDåˆ†ç‰‡ï¼šå¯èƒ½æŸäº›ç”¨æˆ·è®¢å•ç‰¹åˆ«å¤šï¼Œæ•°æ®å€¾æ–œ
- ç”¨æˆ·ID + è®¢å•æ—¶é—´ï¼šæ—¢è€ƒè™‘ç”¨æˆ·ï¼Œåˆè€ƒè™‘æ—¶é—´ï¼Œåˆ†å¸ƒæ›´å‡åŒ€
```

### 5.2 å¤åˆåˆ†ç‰‡é”®é…ç½®


```yaml
rules:
  - !SHARDING
    tables:
      order:
        actualDataNodes: ds${0..1}.order_${0..3}
        databaseStrategy:
          complex:
            shardingColumns: user_id,region_code    # æ•°æ®åº“åˆ†ç‰‡é”®
            shardingAlgorithmName: db_complex
        tableStrategy:
          complex:
            shardingColumns: user_id,order_time     # è¡¨åˆ†ç‰‡é”®  
            shardingAlgorithmName: table_complex
            
    shardingAlgorithms:
      db_complex:
        type: CLASS_BASED
        props:
          strategy: com.example.DbComplexAlgorithm
      table_complex:
        type: CLASS_BASED  
        props:
          strategy: com.example.TableComplexAlgorithm
```

### 5.3 å¤åˆåˆ†ç‰‡ç®—æ³•å®ç°


```java
/**
 * æ•°æ®åº“å¤åˆåˆ†ç‰‡ç®—æ³•
 * è§„åˆ™ï¼šç”¨æˆ·IDå–æ¨¡ + åœ°åŒºç¼–ç 
 */
public class DbComplexAlgorithm implements ComplexKeysShardingAlgorithm<String> {
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames,
                                       ComplexKeysShardingValue<String> shardingValue) {
        
        Map<String, Collection<String>> columnNameAndShardingValuesMap = 
            shardingValue.getColumnNameAndShardingValuesMap();
            
        // è·å–åˆ†ç‰‡å€¼
        Collection<String> userIds = columnNameAndShardingValuesMap.get("user_id");
        Collection<String> regionCodes = columnNameAndShardingValuesMap.get("region_code");
        
        Set<String> result = new HashSet<>();
        
        // éå†æ‰€æœ‰ç»„åˆ
        for (String userId : userIds) {
            for (String regionCode : regionCodes) {
                // å¤åˆåˆ†ç‰‡é€»è¾‘
                int dbIndex = (userId.hashCode() + regionCode.hashCode()) % 2;
                result.add("ds" + dbIndex);
            }
        }
        
        return result;
    }
}

/**
 * è¡¨å¤åˆåˆ†ç‰‡ç®—æ³•  
 * è§„åˆ™ï¼šç”¨æˆ·IDå–æ¨¡ + æ—¶é—´æœˆä»½
 */
public class TableComplexAlgorithm implements ComplexKeysShardingAlgorithm<String> {
    
    @Override
    public Collection<String> doSharding(Collection<String> availableTargetNames,
                                       ComplexKeysShardingValue<String> shardingValue) {
        
        Map<String, Collection<String>> valueMap = 
            shardingValue.getColumnNameAndShardingValuesMap();
            
        Collection<String> userIds = valueMap.get("user_id");
        Collection<String> orderTimes = valueMap.get("order_time");
        
        Set<String> result = new HashSet<>();
        
        for (String userId : userIds) {
            for (String orderTime : orderTimes) {
                // è§£ææ—¶é—´
                LocalDateTime time = LocalDateTime.parse(orderTime);
                int month = time.getMonthValue();
                
                // å¤åˆè®¡ç®—ï¼šç”¨æˆ·IDæ¨¡2 + æœˆä»½æ¨¡2
                int tableIndex = (Integer.valueOf(userId) % 2) + (month % 2);
                result.add("order_" + tableIndex);
            }
        }
        
        return result;
    }
}
```

## 6. ğŸ¨ ç‰¹æ®Šåˆ†ç‰‡é…ç½®


### 6.1 ç»‘å®šè¡¨ï¼ˆBinding Tableï¼‰é…ç½®


**ç»‘å®šè¡¨**å°±æ˜¯åˆ†ç‰‡è§„åˆ™ç›¸åŒçš„è¡¨ï¼Œå®ƒä»¬æ€»æ˜¯è·¯ç”±åˆ°ç›¸åŒçš„æ•°æ®æºï¼Œé¿å…è·¨åº“å…³è”æŸ¥è¯¢ã€‚

```yaml
# ç»‘å®šè¡¨é…ç½®
rules:
  - !SHARDING
    tables:
      order:
        actualDataNodes: ds${0..1}.order_${0..1}
        tableStrategy:
          inline:
            shardingColumn: user_id
            algorithmExpression: order_${user_id % 2}
      order_item:
        actualDataNodes: ds${0..1}.order_item_${0..1}  
        tableStrategy:
          inline:
            shardingColumn: user_id               # ç›¸åŒåˆ†ç‰‡é”®
            algorithmExpression: order_item_${user_id % 2}  # ç›¸åŒè§„åˆ™
            
    bindingTables:
      - order,order_item    # ç»‘å®šè¡¨å£°æ˜
```

**ç»‘å®šè¡¨çš„å¥½å¤„**ï¼š
```sql
-- è¿™ä¸ªå…³è”æŸ¥è¯¢ä¸ä¼šäº§ç”Ÿè·¨åº“é—®é¢˜
SELECT o.*, oi.* 
FROM order o 
JOIN order_item oi ON o.order_id = oi.order_id 
WHERE o.user_id = 1001;

-- å› ä¸º user_id = 1001 çš„è®¢å•å’Œè®¢å•æ˜ç»†éƒ½åœ¨åŒä¸€ä¸ªåº“çš„åŒä¸€ç»„è¡¨ä¸­
```

### 6.2 å¹¿æ’­è¡¨ï¼ˆBroadcast Tableï¼‰é…ç½®


**å¹¿æ’­è¡¨**å°±æ˜¯æ¯ä¸ªæ•°æ®æºéƒ½æœ‰å®Œæ•´æ•°æ®çš„è¡¨ï¼Œé€šå¸¸æ˜¯é…ç½®è¡¨ã€å­—å…¸è¡¨ç­‰ã€‚

```yaml
# å¹¿æ’­è¡¨é…ç½®
rules:
  - !SHARDING
    broadcastTables:
      - region_config     # åœ°åŒºé…ç½®è¡¨
      - product_category  # å•†å“åˆ†ç±»è¡¨
      - system_config     # ç³»ç»Ÿé…ç½®è¡¨
      
    tables:
      region_config:
        actualDataNodes: ds${0..3}.region_config    # æ¯ä¸ªåº“éƒ½æœ‰
```

**å¹¿æ’­è¡¨ç‰¹ç‚¹**ï¼š
- ğŸ“‹ **æ•°æ®åŒæ­¥**ï¼šå†™å…¥æ—¶è‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
- ğŸ” **æœ¬åœ°æŸ¥è¯¢**ï¼šæŸ¥è¯¢æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œæ— è·¨åº“è®¿é—®  
- ğŸ“Š **æ•°æ®ä¸€è‡´**ï¼šæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¿æŒä¸€è‡´

### 6.3 Hintå¼ºåˆ¶è·¯ç”±


**ä½¿ç”¨åœºæ™¯**ï¼šå½“SQLæ— æ³•è‡ªåŠ¨æå–åˆ†ç‰‡é”®æ—¶ï¼Œæ‰‹åŠ¨æŒ‡å®šè·¯ç”±

```java
@Service
public class OrderService {
    
    /**
     * å¼ºåˆ¶è·¯ç”±æŸ¥è¯¢
     */
    public List<Order> getOrdersByHint(Long userId) {
        HintManager hintManager = HintManager.getInstance();
        try {
            // è®¾ç½®å¼ºåˆ¶è·¯ç”±çš„åˆ†ç‰‡å€¼
            hintManager.addDatabaseShardingValue("order", userId);
            hintManager.addTableShardingValue("order", userId);
            
            // æ‰§è¡ŒæŸ¥è¯¢ - ä¼šæ ¹æ®hintè·¯ç”±åˆ°æŒ‡å®šåˆ†ç‰‡
            return orderMapper.selectAllOrders();
            
        } finally {
            // å¿…é¡»é‡Šæ”¾hintï¼Œå¦åˆ™å½±å“åç»­æŸ¥è¯¢
            hintManager.close();
        }
    }
    
    /**
     * å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“æŸ¥è¯¢
     */
    public Order getOrderFromMaster(Long orderId) {
        HintManager hintManager = HintManager.getInstance();
        try {
            // å¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“
            hintManager.setMasterRouteOnly();
            
            return orderMapper.selectByOrderId(orderId);
        } finally {
            hintManager.close();
        }
    }
}
```

### 6.4 åŠ¨æ€åˆ†ç‰‡è§„åˆ™è°ƒæ•´


```java
/**
 * åŠ¨æ€è°ƒæ•´åˆ†ç‰‡è§„åˆ™
 */
@Component
public class DynamicShardingManager {
    
    @Autowired
    private ShardingSphereDataSource dataSource;
    
    /**
     * åŠ¨æ€æ·»åŠ æ–°çš„åˆ†ç‰‡èŠ‚ç‚¹
     */
    public void addNewShardingNode() {
        // è·å–å½“å‰è§„åˆ™
        ShardingRuleConfiguration currentConfig = getCurrentShardingConfig();
        
        // æ·»åŠ æ–°çš„æ•°æ®èŠ‚ç‚¹
        ShardingTableRuleConfiguration tableConfig = 
            currentConfig.getTables().get("order");
        tableConfig.setActualDataNodes("ds${0..2}.order_${0..3}");  // åŸæ¥æ˜¯0..1ï¼Œç°åœ¨æ‰©å±•åˆ°0..2
        
        // æ›´æ–°åˆ†ç‰‡ç®—æ³•
        updateShardingAlgorithm(currentConfig, "order_hash", 3);  // åˆ†ç‰‡æ•°ä»2æ”¹ä¸º3
        
        // åº”ç”¨æ–°é…ç½®ï¼ˆéœ€è¦é‡å¯æˆ–ä½¿ç”¨é…ç½®ä¸­å¿ƒåŠ¨æ€æ›´æ–°ï¼‰
        applyNewConfiguration(currentConfig);
    }
    
    /**
     * åŠ¨æ€ä¿®æ”¹åˆ†ç‰‡ç®—æ³•å‚æ•°
     */
    public void updateShardingCount(String algorithmName, int newCount) {
        ShardingRuleConfiguration config = getCurrentShardingConfig();
        
        ShardingAlgorithmConfiguration algorithm = 
            config.getShardingAlgorithms().get(algorithmName);
        algorithm.getProps().setProperty("sharding-count", String.valueOf(newCount));
        
        applyNewConfiguration(config);
    }
}
```

## 7. âœ… åˆ†ç‰‡è§„åˆ™éªŒè¯ä¸æµ‹è¯•


### 7.1 åˆ†ç‰‡è§„åˆ™æµ‹è¯•æ–¹æ³•


**ğŸ”¸ å•å…ƒæµ‹è¯•åˆ†ç‰‡ç®—æ³•**
```java
@Test
public class ShardingAlgorithmTest {
    
    private UserHashAlgorithm algorithm = new UserHashAlgorithm();
    
    @Test
    public void testUserSharding() {
        // æµ‹è¯•æ•°æ®
        Collection<String> targets = Arrays.asList("user_0", "user_1", "user_2", "user_3");
        
        // æµ‹è¯•ç²¾ç¡®åˆ†ç‰‡
        PreciseShardingValue<Long> shardingValue = 
            new PreciseShardingValue<>("user", "user_id", 1001L);
            
        String result = algorithm.doSharding(targets, shardingValue);
        
        // éªŒè¯ç»“æœ
        assertEquals("user_1", result);  // 1001 % 4 = 1
    }
    
    @Test
    public void testShardingDistribution() {
        // æµ‹è¯•åˆ†ç‰‡åˆ†å¸ƒæ˜¯å¦å‡åŒ€
        Map<String, Integer> distribution = new HashMap<>();
        
        for (long userId = 1; userId <= 10000; userId++) {
            PreciseShardingValue<Long> value = 
                new PreciseShardingValue<>("user", "user_id", userId);
            String target = algorithm.doSharding(targets, value);
            
            distribution.merge(target, 1, Integer::sum);
        }
        
        // éªŒè¯åˆ†å¸ƒå‡åŒ€æ€§ï¼ˆæ¯ä¸ªåˆ†ç‰‡åº”è¯¥å¤§çº¦2500æ¡ï¼‰
        distribution.values().forEach(count -> {
            assertTrue(Math.abs(count - 2500) < 100);  // å…è®¸ä¸€å®šè¯¯å·®
        });
    }
}
```

### 7.2 SQLè·¯ç”±æµ‹è¯•


```java
@SpringBootTest
public class ShardingRouteTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    public void testInsertRouting() {
        // æµ‹è¯•æ’å…¥è·¯ç”±
        User user = new User();
        user.setUserId(1001L);
        user.setName("å¼ ä¸‰");
        
        // æ‰§è¡Œæ’å…¥ï¼Œè§‚å¯Ÿè·¯ç”±åˆ°å“ªä¸ªåˆ†ç‰‡
        userService.saveUser(user);
        
        // éªŒè¯æ•°æ®ç¡®å®æ’å…¥åˆ°é¢„æœŸåˆ†ç‰‡
        // å¯ä»¥é€šè¿‡æ—¥å¿—æˆ–ç›´æ¥æŸ¥è¯¢éªŒè¯
    }
    
    @Test
    public void testQueryRouting() {
        // æµ‹è¯•æŸ¥è¯¢è·¯ç”±
        User user = userService.getUserById(1001L);
        assertNotNull(user);
        
        // æµ‹è¯•èŒƒå›´æŸ¥è¯¢è·¯ç”±
        List<User> users = userService.getUsersByIdRange(1000L, 2000L);
        assertFalse(users.isEmpty());
    }
    
    @Test
    public void testJoinQuery() {
        // æµ‹è¯•å…³è”æŸ¥è¯¢ï¼ˆç»‘å®šè¡¨ï¼‰
        List<OrderWithItems> orders = orderService.getOrdersWithItems(1001L);
        
        // éªŒè¯å…³è”æŸ¥è¯¢æ²¡æœ‰è·¨åº“é—®é¢˜
        assertFalse(orders.isEmpty());
    }
}
```

### 7.3 åˆ†ç‰‡è§„åˆ™éªŒè¯å·¥å…·


```java
/**
 * åˆ†ç‰‡è§„åˆ™éªŒè¯å·¥å…·
 */
@Component
public class ShardingRuleValidator {
    
    /**
     * éªŒè¯åˆ†ç‰‡é…ç½®æ˜¯å¦æ­£ç¡®
     */
    public ValidationResult validateShardingConfig(ShardingRuleConfiguration config) {
        ValidationResult result = new ValidationResult();
        
        // æ£€æŸ¥æ•°æ®èŠ‚ç‚¹é…ç½®
        validateDataNodes(config, result);
        
        // æ£€æŸ¥åˆ†ç‰‡ç®—æ³•é…ç½®
        validateShardingAlgorithms(config, result);
        
        // æ£€æŸ¥ç»‘å®šè¡¨é…ç½®
        validateBindingTables(config, result);
        
        return result;
    }
    
    private void validateDataNodes(ShardingRuleConfiguration config, ValidationResult result) {
        for (ShardingTableRuleConfiguration table : config.getTables().values()) {
            String actualDataNodes = table.getActualDataNodes();
            
            // æ£€æŸ¥æ•°æ®èŠ‚ç‚¹æ ¼å¼
            if (!isValidDataNodeFormat(actualDataNodes)) {
                result.addError("è¡¨ " + table.getLogicTable() + " çš„æ•°æ®èŠ‚ç‚¹æ ¼å¼é”™è¯¯: " + actualDataNodes);
            }
            
            // æ£€æŸ¥æ•°æ®æºæ˜¯å¦å­˜åœ¨
            validateDataSourceExists(actualDataNodes, result);
        }
    }
    
    /**
     * æ¨¡æ‹ŸæŸ¥è¯¢æµ‹è¯•åˆ†ç‰‡è·¯ç”±
     */
    public Map<String, String> simulateShardingRoute(String sql, Object... params) {
        Map<String, String> routeResult = new HashMap<>();
        
        // è§£æSQLï¼Œæå–åˆ†ç‰‡é”®å€¼
        ShardingValue shardingValue = extractShardingValue(sql, params);
        
        // æ¨¡æ‹Ÿè·¯ç”±è®¡ç®—
        String targetDataSource = calculateDataSourceRoute(shardingValue);
        String targetTable = calculateTableRoute(shardingValue);
        
        routeResult.put("dataSource", targetDataSource);
        routeResult.put("table", targetTable);
        routeResult.put("actualSql", rewriteSQL(sql, targetTable));
        
        return routeResult;
    }
}
```

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†ç‰‡å¼•æ“ï¼šæ™ºèƒ½è·¯ç”±å™¨ï¼Œå†³å®šSQLå‘é€åˆ°å“ªä¸ªåº“è¡¨
ğŸ”¸ åˆ†ç‰‡ç­–ç•¥ï¼š5ç§ç±»å‹ï¼Œå„æœ‰é€‚ç”¨åœºæ™¯
ğŸ”¸ åˆ†ç‰‡ç®—æ³•ï¼šå†…ç½®ç®—æ³•+è‡ªå®šä¹‰ç®—æ³•ï¼Œå®ç°å…·ä½“åˆ†ç‰‡é€»è¾‘  
ğŸ”¸ è¡Œè¡¨è¾¾å¼ï¼šç®€å•åˆ†ç‰‡è§„åˆ™çš„å¿«é€Ÿé…ç½®æ–¹å¼
ğŸ”¸ å¤åˆåˆ†ç‰‡é”®ï¼šå¤šå­—æ®µè”åˆåˆ†ç‰‡ï¼Œåˆ†å¸ƒæ›´å‡åŒ€
ğŸ”¸ ç»‘å®šè¡¨ï¼šç›¸åŒåˆ†ç‰‡è§„åˆ™çš„è¡¨ï¼Œé¿å…è·¨åº“å…³è”
ğŸ”¸ å¹¿æ’­è¡¨ï¼šå…¨å±€æ•°æ®è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å®Œæ•´æ•°æ®
```

### 8.2 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—


| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|---------|---------|
| **æ ‡å‡†åˆ†ç‰‡** | `å•å­—æ®µåˆ†ç‰‡ï¼ŒæŸ¥è¯¢ç®€å•` | `é…ç½®ç®€å•ï¼Œæ€§èƒ½å¥½` | `åªæ”¯æŒå•å­—æ®µ` |
| **å¤åˆåˆ†ç‰‡** | `å¤šå­—æ®µè”åˆåˆ†ç‰‡` | `åˆ†å¸ƒå‡åŒ€ï¼Œé€»è¾‘çµæ´»` | `é…ç½®å¤æ‚ï¼Œæ€§èƒ½ç•¥ä½` |
| **è¡Œè¡¨è¾¾å¼** | `ç®€å•å›ºå®šè§„åˆ™` | `é…ç½®æç®€ï¼Œæ— éœ€ç¼–ç ` | `ä¸å¤Ÿçµæ´»` |
| **å¼ºåˆ¶è·¯ç”±** | `æ— æ³•æå–åˆ†ç‰‡é”®çš„åœºæ™¯` | `å¼ºåˆ¶æ§åˆ¶ï¼Œçµæ´»æ€§é«˜` | `éœ€è¦æ‰‹åŠ¨ç®¡ç†` |
| **ä¸åˆ†ç‰‡** | `å¹¿æ’­è¡¨ï¼Œå…¨å±€è¡¨` | `æ•°æ®ä¸€è‡´ï¼ŒæŸ¥è¯¢æœ¬åœ°åŒ–` | `å­˜å‚¨å†—ä½™` |

### 8.3 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™**
```
ä¸šåŠ¡å¯¼å‘ï¼šæ ¹æ®æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ¡ä»¶é€‰æ‹©
åˆ†å¸ƒå‡åŒ€ï¼šé¿å…æ•°æ®å€¾æ–œï¼Œé€‰æ‹©åˆ†å¸ƒå‡åŒ€çš„å­—æ®µ
æŸ¥è¯¢å‹å¥½ï¼šå°½é‡è®©æŸ¥è¯¢æ¡ä»¶åŒ…å«åˆ†ç‰‡é”®
æ‰©å±•æ€§å¥½ï¼šè€ƒè™‘æœªæ¥çš„æ‰©å®¹éœ€æ±‚
```

**ğŸ”¹ åˆ†ç‰‡ç®—æ³•è®¾è®¡åŸåˆ™**
```
æ€§èƒ½ä¼˜å…ˆï¼šç®—æ³•è¦å¿«ï¼Œé¿å…å¤æ‚è®¡ç®—
ä¸€è‡´æ€§å¥½ï¼šç›¸åŒè¾“å…¥å¿…é¡»äº§ç”Ÿç›¸åŒè¾“å‡º
å¯æ‰©å±•æ€§ï¼šæ”¯æŒåŠ¨æ€å¢å‡åˆ†ç‰‡
å®¹é”™æ€§å¼ºï¼šå¼‚å¸¸æƒ…å†µä¸‹æœ‰åˆç†çš„é»˜è®¤è¡Œä¸º
```

**ğŸ”¹ å¸¸è§é—®é¢˜é¿å…**
```
âŒ é¿å…ï¼šé€‰æ‹©åˆ†å¸ƒä¸å‡çš„åˆ†ç‰‡é”®ï¼ˆå¦‚æ€§åˆ«ã€çŠ¶æ€ç­‰ï¼‰
âŒ é¿å…ï¼šè·¨åˆ†ç‰‡çš„å¤æ‚å…³è”æŸ¥è¯¢
âŒ é¿å…ï¼šåœ¨äº‹åŠ¡ä¸­è·¨å¤šä¸ªåˆ†ç‰‡æ“ä½œ
âŒ é¿å…ï¼šå¿˜è®°é…ç½®ç»‘å®šè¡¨å¯¼è‡´è·¨åº“å…³è”
âœ… æ¨èï¼šä¼˜å…ˆä½¿ç”¨ä¸šåŠ¡ä¸»é”®ä½œä¸ºåˆ†ç‰‡é”®
âœ… æ¨èï¼šåˆç†è§„åˆ’ç»‘å®šè¡¨ï¼Œå‡å°‘è·¨åº“æŸ¥è¯¢
âœ… æ¨èï¼šä½¿ç”¨å¹¿æ’­è¡¨å­˜å‚¨å­—å…¸é…ç½®æ•°æ®
âœ… æ¨èï¼šå®šæœŸéªŒè¯åˆ†ç‰‡åˆ†å¸ƒå‡åŒ€æ€§
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


```
ç®—æ³•ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨ç®€å•çš„å–æ¨¡ç®—æ³•ï¼Œé¿å…å¤æ‚è®¡ç®—
â€¢ ç¼“å­˜åˆ†ç‰‡è·¯ç”±ç»“æœï¼Œå‡å°‘é‡å¤è®¡ç®—
â€¢ é¢„è®¡ç®—åˆ†ç‰‡æ˜ å°„å…³ç³»

é…ç½®ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®åˆ†ç‰‡æ•°é‡ï¼Œé€šå¸¸ä¸º2çš„å¹‚æ¬¡
â€¢ é…ç½®ç»‘å®šè¡¨ï¼Œé¿å…è·¨åº“å…³è”æŸ¥è¯¢
â€¢ ä½¿ç”¨å¹¿æ’­è¡¨å­˜å‚¨å…¨å±€é…ç½®æ•°æ®

ç›‘æ§ä¼˜åŒ–ï¼š
â€¢ ç›‘æ§å„åˆ†ç‰‡çš„æ•°æ®åˆ†å¸ƒæƒ…å†µ
â€¢ å®šæœŸæ£€æŸ¥åˆ†ç‰‡è§„åˆ™çš„æœ‰æ•ˆæ€§
â€¢ åŠæ—¶å‘ç°å’Œå¤„ç†æ•°æ®å€¾æ–œé—®é¢˜
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†ç‰‡å¼•æ“å¦‚è·¯ç”±å™¨ï¼Œæ™ºèƒ½åˆ†å‘SQLè¯·æ±‚åˆ°æ­£ç¡®ä½ç½®
- åˆ†ç‰‡ç­–ç•¥æœ‰äº”ç§ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„
- åˆ†ç‰‡é”®é€‰æ‹©è¦è€ƒè™‘æŸ¥è¯¢æ¨¡å¼å’Œæ•°æ®åˆ†å¸ƒå‡åŒ€æ€§
- ç»‘å®šè¡¨å’Œå¹¿æ’­è¡¨æ˜¯è§£å†³è·¨åº“é—®é¢˜çš„é‡è¦æ‰‹æ®µ