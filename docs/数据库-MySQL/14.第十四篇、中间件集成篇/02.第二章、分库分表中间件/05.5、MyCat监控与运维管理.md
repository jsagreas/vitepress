---
title: 5、MyCat监控与运维管理
---
## 📚 目录

1. [MyCat监控概述](#1-MyCat监控概述)
2. [性能监控指标](#2-性能监控指标)
3. [SQL执行统计与分析](#3-SQL执行统计与分析)
4. [分片路由分析](#4-分片路由分析)
5. [故障诊断工具](#5-故障诊断工具)
6. [MyCat-eye监控平台](#6-MyCat-eye监控平台)
7. [运维管理实践](#7-运维管理实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 MyCat监控概述


### 1.1 为什么需要监控MyCat


**分布式数据库的复杂性**
```
传统单机数据库：
应用 → 数据库

分布式架构：
应用 → MyCat → 多个数据库节点
```

想象一下，如果你是一个餐厅的管理员，原本只需要管理一个厨房，现在需要管理10个厨房的协调工作。你需要知道：
- 每个厨房的忙碌程度
- 订单分配是否合理
- 哪个厨房出现了问题
- 整体服务效率如何

MyCat监控就是解决这些问题的"餐厅管理系统"。

### 1.2 MyCat监控的核心价值


**🎯 主要监控目标**
```
性能监控：确保系统高效运行
故障预警：提前发现潜在问题
容量规划：为系统扩容提供数据支持
优化指导：找出性能瓶颈和优化点
```

### 1.3 监控架构组成


```
┌─────────────────────────────────────────┐
│              应用层                      │
├─────────────────────────────────────────┤
│              MyCat中间件                 │ ← 核心监控对象
├─────────────────────────────────────────┤
│         分片数据库集群                    │
└─────────────────────────────────────────┘
           ↑           ↑           ↑
    ┌─────────┐ ┌─────────┐ ┌─────────┐
    │监控数据 │ │日志收集 │ │性能指标 │
    │收集     │ │分析     │ │统计     │
    └─────────┘ └─────────┘ └─────────┘
```

---

## 2. 📊 性能监控指标


### 2.1 核心性能指标体系


**🔸 连接相关指标**

| 指标名称 | 含义说明 | 正常范围 | 异常表现 |
|---------|---------|---------|---------|
| **活跃连接数** | 当前正在使用的连接 | < 最大连接数的70% | 接近上限时需扩容 |
| **连接创建速率** | 每秒新建连接数 | 稳定增长 | 突然激增可能有问题 |
| **连接等待时间** | 获取连接的等待时长 | < 100ms | > 500ms需要优化 |
| **连接超时数** | 连接超时的次数 | 0 | 频繁超时说明配置不当 |

**🔸 SQL执行指标**

```
QPS (每秒查询数)：
- 含义：系统每秒处理的SQL语句数量
- 计算：总查询数 / 时间段(秒)
- 作用：衡量系统吞吐能力

TPS (每秒事务数)：
- 含义：系统每秒处理的完整事务数
- 关系：TPS ≤ QPS (一个事务可能包含多个查询)
- 意义：更准确反映业务处理能力

响应时间分布：
- P50：50%的请求响应时间
- P95：95%的请求响应时间  
- P99：99%的请求响应时间
```

### 2.2 监控指标获取方法


**通过MyCat管理端口获取**
```bash
# 连接MyCat管理端口(默认9066)
mysql -h127.0.0.1 -P9066 -uroot -p123456

# 查看连接状态
show $$connection;

# 查看SQL统计
show $$sql;

# 查看后端连接状态
show $$backend;
```

**连接状态示例输出**
```
+------+--------+-------+------+-------+
| ID   | HOST   | USER  | SCHEMA| STATE |
+------+--------+-------+------+-------+
| 1    | 127.0.0.1| root | testdb| idle  |
| 2    | 127.0.0.1| root | testdb| query |
+------+--------+-------+------+-------+
```

### 2.3 关键性能阈值设置


**🚨 性能告警阈值建议**
```
连接池使用率：
⚠️  警告：> 70%
🚨 严重：> 85%
💀 紧急：> 95%

平均响应时间：
⚠️  警告：> 100ms
🚨 严重：> 500ms  
💀 紧急：> 1000ms

错误率：
⚠️  警告：> 1%
🚨 严重：> 5%
💀 紧急：> 10%
```

---

## 3. 📈 SQL执行统计与分析


### 3.1 SQL执行统计概述


**什么是SQL执行统计？**

简单来说，就是记录每条SQL语句的"成绩单"：
- 执行了多少次
- 平均耗时多长
- 成功率如何
- 哪个分片执行的

这就像学生考试后的成绩分析，帮助找出问题所在。

### 3.2 SQL统计信息查看


**基础SQL统计查询**
```sql
-- 查看SQL执行统计
show $$sql;

-- 查看慢SQL统计  
show $$sql.slow;

-- 重置SQL统计
reset $$sql;
```

**SQL统计输出解读**
```
+---+------+-------+-------+--------+----------+
|ID |USER  |SQL    |COUNT  |TIME    |MAX_TIME  |
+---+------+-------+-------+--------+----------+
|1  |root  |SELECT |1000   |50ms    |200ms     |
|2  |root  |INSERT |500    |80ms    |300ms     |
+---+------+-------+-------+--------+----------+

解读说明：
- COUNT：SQL执行次数
- TIME：平均执行时间  
- MAX_TIME：最大执行时间
```

### 3.3 SQL执行计划分析


**查看SQL执行路径**
```sql
-- 使用explain查看SQL路由
explain select * from user where id = 1001;

-- 输出示例
+----------+-------------+
| DATA_NODE| SQL         |
+----------+-------------+
| dn1      | SELECT ...  |
+----------+-------------+
```

**分片路由确认**
```sql
-- 检查分片规则是否生效
explain select * from order_table where user_id = 12345;

-- 预期：只路由到一个分片
-- 异常：路由到多个分片(可能分片键选择不当)
```

### 3.4 慢SQL识别与优化


**慢SQL定义与查找**
```bash
# 1. 在server.xml中配置慢SQL阈值
<property name="sqlExecuteTimeout">5000</property>

# 2. 查看慢SQL记录
show $$sql.slow;

# 3. 分析慢SQL原因
explain [慢SQL语句];
```

**慢SQL优化思路**
```
🔸 分片键优化：
问题：SQL没有使用分片键，导致全分片扫描
解决：在WHERE条件中添加分片键

🔸 索引优化：
问题：分片内部索引缺失
解决：在各分片上创建必要索引

🔸 SQL重写：
问题：复杂JOIN查询跨分片
解决：业务层拆分查询或使用全局表
```

---

## 4. 🗺️ 分片路由分析


### 4.1 分片路由原理回顾


**什么是分片路由？**

想象一个快递分拣中心，收到包裹后需要根据地址把包裹分配到不同的车辆：
- 北京的包裹 → 北京专线
- 上海的包裹 → 上海专线
- 广州的包裹 → 广州专线

MyCat的分片路由就是这个"快递分拣员"，根据SQL中的分片键决定数据发送到哪个数据库。

### 4.2 路由分析工具


**EXPLAIN命令详解**
```sql
-- 基础路由分析
explain select * from user_table where user_id = 1001;

-- 输出分析
+----------+----------------------------------+
| DATA_NODE| SQL                              |
+----------+----------------------------------+
| dn1      | select * from user_table where  |
|          | user_id = 1001                   |
+----------+----------------------------------+

✅ 理想情况：只路由到一个节点(dn1)
❌ 问题情况：路由到多个节点
```

**多种查询场景分析**
```sql
-- 1. 单分片查询(推荐)
explain select * from user_table where user_id = 1001;
-- 结果：1个DATA_NODE

-- 2. 多分片查询(需要优化)  
explain select * from user_table where name = 'zhang';
-- 结果：多个DATA_NODE

-- 3. 全分片查询(避免使用)
explain select count(*) from user_table;
-- 结果：所有DATA_NODE
```

### 4.3 路由性能分析


**路由效率评估**
```
单分片路由：
✅ 性能最优
✅ 网络开销最小
✅ 结果聚合简单

多分片路由：
⚠️  性能一般
⚠️  需要结果聚合
⚠️  网络开销增大

全分片路由：
❌ 性能最差
❌ 资源消耗大
❌ 响应时间长
```

### 4.4 路由优化策略


**优化方案总结**
```
🎯 分片键选择原则：
1. 业务查询最常用的字段
2. 数据分布相对均匀的字段
3. 很少作为范围查询条件的字段

💡 SQL优化建议：
1. 查询时尽量包含分片键
2. 避免跨分片的复杂JOIN
3. 使用全局表存储字典数据
4. 合理使用ER分片减少跨分片查询
```

---

## 5. 🔧 故障诊断工具


### 5.1 常见故障类型


**MyCat常见故障分类**
```
连接问题：
- 连接数耗尽
- 连接超时
- 认证失败

路由问题：  
- 分片键缺失
- 路由规则错误
- 跨分片查询异常

性能问题：
- 响应时间过长
- 吞吐量下降
- 内存溢出

数据问题：
- 数据不一致
- 主从延迟
- 分片数据倾斜
```

### 5.2 诊断命令工具


**连接诊断命令**
```sql
-- 查看当前连接状态
show $$connection;

-- 查看后端连接池状态
show $$backend;

-- 查看数据源状态
show $$datasource;

-- 连接详细信息
show $$connection.sql;
```

**性能诊断命令**
```sql
-- 查看处理器状态
show $$processor;

-- 查看缓存命中率
show $$cache;

-- 查看线程池状态  
show $$threadpool;

-- 查看内存使用情况
show $$sysparam;
```

### 5.3 日志分析系统


**MyCat日志类型**
```
wrapper.log：
- MyCat启动日志
- JVM相关信息
- 系统级错误

mycat.log：  
- SQL执行日志
- 路由信息
- 业务层错误

switch.log：
- 主从切换日志
- 故障转移记录
```

**日志分析技巧**
```bash
# 查看错误日志
tail -f logs/mycat.log | grep ERROR

# 查看慢SQL日志
tail -f logs/mycat.log | grep "slow"

# 分析连接问题
grep "connection" logs/mycat.log | tail -100
```

### 5.4 故障排查流程


**标准排查步骤**
```
第一步：确认症状
- 收集错误信息
- 确认影响范围
- 记录故障时间

第二步：检查基础环境
- 服务器资源使用情况
- 网络连接状态
- MyCat进程状态

第三步：分析日志信息
- 查看错误日志
- 分析SQL执行情况
- 检查路由信息

第四步：定位根本原因
- 结合监控数据
- 对比历史情况
- 确认故障原因

第五步：制定解决方案
- 评估修复影响
- 制定回滚计划
- 执行修复操作
```

---

## 6. 👁️ MyCat-eye监控平台


### 6.1 MyCat-eye简介


**什么是MyCat-eye？**

MyCat-eye就像是给MyCat装上了一双"智能眼睛"，能够：
- 实时看到系统状态
- 自动收集性能数据
- 图形化展示运行情况
- 提供历史趋势分析

这就像汽车的仪表盘，让你随时了解"车辆"的运行状态。

### 6.2 MyCat-eye安装配置


**快速安装步骤**
```bash
# 1. 下载MyCat-eye
wget http://dl.mycat.io/mycat-eye-latest.tar.gz

# 2. 解压安装
tar -zxvf mycat-eye-latest.tar.gz
cd mycat-eye

# 3. 配置数据库连接
vim conf/mycat-eye.properties
```

**核心配置文件**
```properties
# 监控数据存储数据库
db.url=jdbc:mysql://localhost:3306/mycat_eye
db.username=root
db.password=123456

# MyCat连接配置
mycat.host=192.168.1.100
mycat.port=9066
mycat.username=root
mycat.password=123456

# Web服务端口
web.port=8082
```

### 6.3 监控界面功能


**核心监控面板**
```
📊 实时监控面板：
- QPS/TPS实时曲线
- 连接数变化趋势
- 响应时间分布
- 错误率统计

📈 历史趋势分析：
- 性能指标历史曲线
- 容量增长趋势
- 故障发生频率
- 优化效果对比

🔍 SQL分析工具：
- 慢SQL Top排行
- SQL执行计划分析
- 路由分布统计
- 执行频次排序
```

### 6.4 告警配置


**告警规则设置**
```json
{
  "alertRules": [
    {
      "metric": "connection_usage",
      "threshold": 80,
      "comparison": ">",
      "level": "warning"
    },
    {
      "metric": "avg_response_time", 
      "threshold": 1000,
      "comparison": ">",
      "level": "critical"
    },
    {
      "metric": "error_rate",
      "threshold": 5,
      "comparison": ">", 
      "level": "critical"
    }
  ]
}
```

**告警通知方式**
```
邮件通知：
- SMTP服务器配置
- 收件人列表管理
- 告警模板定制

短信通知：
- 短信网关集成
- 紧急联系人配置
- 分级通知机制

企业微信/钉钉：
- Webhook集成
- 群组通知
- @特定人员
```

---

## 7. ⚙️ 运维管理实践


### 7.1 运维管理接口


**MyCat管理端口(9066)**

这个端口就像MyCat的"后台管理系统"，专门用于：
- 查看系统状态
- 执行管理命令
- 重新加载配置
- 故障排查分析

```bash
# 连接管理端口
mysql -h127.0.0.1 -P9066 -uroot -p

# 基础管理命令
mysql> show $$help;  # 查看所有可用命令
```

### 7.2 核心管理命令详解


**配置管理命令**
```sql
-- 重新加载配置(无需重启)
reload $$config;

-- 查看当前配置
show $$server;

-- 查看分片配置
show $$schema;

-- 查看数据源配置
show $$datasource;
```

**连接管理命令**
```sql
-- 查看连接详情
show $$connection;

-- 终止特定连接
kill $$connection [connection_id];

-- 查看SQL执行情况
show $$connection.sql;
```

**性能管理命令**
```sql
-- 查看处理器状态
show $$processor;

-- 查看缓存状态
show $$cache;

-- 清空缓存
clear $$cache;

-- 查看系统参数
show $$sysparam;
```

### 7.3 连接池状态监控


**连接池健康检查**
```sql
-- 查看后端连接池详细状态
show $$backend;

/* 输出示例：
+----------+------+-------+--------+--------+
| BACKEND  | HOST | PORT  | ACTIVE | IDLE   |
+----------+------+-------+--------+--------+
| dn1      | 192.168.1.101 | 3306 | 5 | 15 |
| dn2      | 192.168.1.102 | 3306 | 3 | 17 |
+----------+------+-------+--------+--------+
*/
```

**连接池状态解读**
```
ACTIVE：正在使用的连接数
IDLE：空闲可用的连接数
总连接数 = ACTIVE + IDLE

健康状态判断：
✅ 正常：IDLE > 0 且 ACTIVE < 最大连接数的80%
⚠️  警告：IDLE接近0 或 ACTIVE > 最大连接数的80%
❌ 异常：IDLE = 0 且请求等待
```

### 7.4 分片节点健康检查


**节点存活检测**
```sql
-- 查看分片节点状态
show $$datasource;

-- 输出示例
+----------+--------+-------+--------+
| NAME     | TYPE   | HOST  | STATE  |
+----------+--------+-------+--------+
| dn1      | mysql  | 192.168.1.101 | 1 |
| dn2      | mysql  | 192.168.1.102 | 1 |
+----------+--------+-------+--------+

-- STATE说明：
-- 1：正常可用
-- 0：不可用
-- -1：初始化中
```

**自动故障切换**
```xml
<!-- 在dataHost中配置心跳检测 -->
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="1">
    <heartbeat>select user()</heartbeat>
    <writeHost host="hostM1" url="192.168.1.101:3306" 
               user="root" password="123456">
        <readHost host="hostS1" url="192.168.1.102:3306" 
                  user="root" password="123456" />
    </writeHost>
</dataHost>
```

### 7.5 故障预警机制


**多层次预警体系**
```
📊 指标监控：
- CPU使用率 > 80%
- 内存使用率 > 85%  
- 连接使用率 > 90%
- 磁盘IO等待 > 50%

🔍 业务监控：
- 平均响应时间 > 1秒
- 错误率 > 5%
- QPS突然下降 > 50%
- 慢SQL数量激增

⚠️  预警策略：
- 轻微异常：邮件通知
- 严重问题：短信+邮件
- 紧急故障：电话+短信+邮件
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 性能监控：QPS、TPS、响应时间、连接数等关键指标
🔸 SQL分析：执行统计、慢SQL识别、路由分析
🔸 故障诊断：日志分析、状态检查、问题定位
🔸 运维管理：管理命令、配置重载、健康检查
🔸 预警机制：多层次告警、自动化响应
```

### 8.2 关键理解要点


**🔹 监控的本质目的**
```
不是为了监控而监控，而是：
- 提前发现问题，避免故障扩大
- 为性能优化提供数据支持  
- 为容量规划提供决策依据
- 建立标准化运维流程
```

**🔹 监控指标的优先级**
```
一级指标（核心）：
- 服务可用性
- 响应时间
- 错误率
- 连接状态

二级指标（重要）：
- QPS/TPS
- 分片路由效率
- 资源使用率
- 慢SQL数量

三级指标（参考）：
- 缓存命中率
- 网络流量
- JVM状态
- 详细日志
```

### 8.3 实际运维建议


**日常运维检查清单**
```
📅 每日检查：
- 查看告警信息
- 检查关键指标趋势
- 确认备份任务执行
- 查看错误日志摘要

📅 每周检查：
- 分析性能趋势
- 检查慢SQL排行
- 评估容量使用情况
- 回顾故障处理

📅 每月检查：
- 制定容量规划
- 更新运维文档
- 优化监控规则
- 培训运维人员
```

**故障处理最佳实践**
```
⚡ 快速响应：
- 5分钟内确认故障
- 15分钟内启动应急预案
- 30分钟内反馈进展情况

🔍 根因分析：
- 收集完整故障信息
- 分析日志和监控数据
- 找出根本原因
- 制定预防措施

📝 经验总结：
- 记录故障处理过程
- 更新运维手册
- 分享经验教训
- 完善预警规则
```

### 8.4 监控工具选择建议


**工具选择原则**
```
🔸 小型环境：
- MyCat自带管理命令
- 简单的脚本监控
- 基础的告警机制

🔸 中型环境：
- MyCat-eye监控平台
- 第三方APM工具
- 自动化运维脚本

🔸 大型环境：
- 企业级监控平台
- 多维度数据分析
- 智能化故障预测
```

**核心记忆要点**：
- MyCat监控是分布式数据库运维的基础
- 监控不仅要看当前状态，更要关注趋势变化
- 告警机制要分级，避免告警疲劳
- 故障处理要快速响应，根因分析要深入彻底
- 监控工具要根据环境规模合理选择