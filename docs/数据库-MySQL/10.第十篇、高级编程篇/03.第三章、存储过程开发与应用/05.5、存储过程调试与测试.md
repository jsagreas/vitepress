---
title: 5ã€å­˜å‚¨è¿‡ç¨‹è°ƒè¯•ä¸æµ‹è¯•
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨è¿‡ç¨‹è°ƒè¯•åŸºç¡€](#1-å­˜å‚¨è¿‡ç¨‹è°ƒè¯•åŸºç¡€)
2. [è°ƒè¯•æŠ€å·§ä¸æ–¹æ³•](#2-è°ƒè¯•æŠ€å·§ä¸æ–¹æ³•)
3. [æ–­ç‚¹è®¾ç½®ä¸å˜é‡ç›‘æ§](#3-æ–­ç‚¹è®¾ç½®ä¸å˜é‡ç›‘æ§)
4. [æ‰§è¡Œè·Ÿè¸ªä¸æ—¥å¿—è¾“å‡º](#4-æ‰§è¡Œè·Ÿè¸ªä¸æ—¥å¿—è¾“å‡º)
5. [å­˜å‚¨è¿‡ç¨‹å•å…ƒæµ‹è¯•](#5-å­˜å‚¨è¿‡ç¨‹å•å…ƒæµ‹è¯•)
6. [è°ƒè¯•å·¥å…·ä½¿ç”¨æŒ‡å—](#6-è°ƒè¯•å·¥å…·ä½¿ç”¨æŒ‡å—)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å­˜å‚¨è¿‡ç¨‹è°ƒè¯•åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹è°ƒè¯•


**ç®€å•ç†è§£**ï¼šå°±åƒä¿®ç†å®¶ç”µä¸€æ ·ï¼Œå½“å­˜å‚¨è¿‡ç¨‹ä¸å·¥ä½œæˆ–ç»“æœä¸å¯¹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å‡ºé—®é¢˜åœ¨å“ªé‡Œ

```sql
-- æœ‰é—®é¢˜çš„å­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹
DELIMITER $$
CREATE PROCEDURE calculate_bonus(IN emp_id INT, OUT bonus DECIMAL(10,2))
BEGIN
    DECLARE salary DECIMAL(10,2);
    SELECT base_salary INTO salary FROM employees WHERE id = emp_id;
    SET bonus = salary * 0.1;  -- è¿™é‡Œå¯èƒ½æœ‰é€»è¾‘é”™è¯¯
END$$
DELIMITER ;
```

**è°ƒè¯•çš„æœ¬è´¨**ï¼š
- **æ‰¾é”™è¯¯**ï¼šç¨‹åºå“ªé‡Œå†™é”™äº†
- **æŸ¥é€»è¾‘**ï¼šä¸šåŠ¡é€»è¾‘æ˜¯å¦æ­£ç¡®
- **éªŒè¯ç»“æœ**ï¼šè¾“å‡ºæ˜¯å¦ç¬¦åˆé¢„æœŸ

### 1.2 å¸¸è§çš„å­˜å‚¨è¿‡ç¨‹é—®é¢˜


**è¯­æ³•é”™è¯¯**ï¼š
```sql
-- é”™è¯¯ç¤ºä¾‹ï¼šç¼ºå°‘åˆ†å·
CREATE PROCEDURE test_proc()
BEGIN
    DECLARE count INT DEFAULT 0  -- ç¼ºå°‘åˆ†å·
    SELECT COUNT(*) INTO count FROM users;
END
```

**é€»è¾‘é”™è¯¯**ï¼š
```sql
-- é”™è¯¯ç¤ºä¾‹ï¼šæ¡ä»¶åˆ¤æ–­æœ‰è¯¯
CREATE PROCEDURE update_user_status(IN user_id INT)
BEGIN
    IF user_id > 0 THEN  -- åº”è¯¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        UPDATE users SET status = 'active' WHERE id = user_id;
    END IF;
END
```

**æ€§èƒ½é—®é¢˜**ï¼š
```sql
-- ä½æ•ˆçš„æŸ¥è¯¢
CREATE PROCEDURE get_user_orders(IN user_id INT)
BEGIN
    SELECT * FROM orders WHERE user_id = user_id;  -- å¯èƒ½ç¼ºå°‘ç´¢å¼•
END
```

### 1.3 è°ƒè¯•çš„é‡è¦æ€§


> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦è°ƒè¯•**ï¼š
> - **ä¿è¯æ­£ç¡®æ€§**ï¼šç¡®ä¿å­˜å‚¨è¿‡ç¨‹æŒ‰é¢„æœŸå·¥ä½œ
> - **æé«˜æ€§èƒ½**ï¼šå‘ç°å¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢
> - **å‡å°‘ç»´æŠ¤æˆæœ¬**ï¼šæ—©æœŸå‘ç°é—®é¢˜ï¼Œé™ä½åæœŸä¿®å¤éš¾åº¦

---

## 2. ğŸ› ï¸ è°ƒè¯•æŠ€å·§ä¸æ–¹æ³•


### 2.1 åˆ†æ­¥æ‰§è¡Œæ³•


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠå¤æ‚çš„å­˜å‚¨è¿‡ç¨‹æ‹†åˆ†æˆå°æ­¥éª¤ï¼Œé€ä¸€éªŒè¯

```sql
-- åŸå§‹å¤æ‚å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE process_orders()
BEGIN
    -- æ­¥éª¤1ï¼šåˆ›å»ºä¸´æ—¶è¡¨
    CREATE TEMPORARY TABLE temp_orders AS 
    SELECT * FROM orders WHERE status = 'pending';
    
    -- æ­¥éª¤2ï¼šè®¡ç®—æ€»é‡‘é¢
    UPDATE temp_orders SET total = quantity * price;
    
    -- æ­¥éª¤3ï¼šæ›´æ–°åº“å­˜
    UPDATE products p 
    JOIN temp_orders t ON p.id = t.product_id 
    SET p.stock = p.stock - t.quantity;
    
    -- æ­¥éª¤4ï¼šæ›´æ–°è®¢å•çŠ¶æ€
    UPDATE orders SET status = 'processed' 
    WHERE id IN (SELECT id FROM temp_orders);
END$$
DELIMITER ;
```

**åˆ†æ­¥è°ƒè¯•æ–¹æ³•**ï¼š
```sql
-- å•ç‹¬æµ‹è¯•æ¯ä¸ªæ­¥éª¤
-- æ­¥éª¤1æµ‹è¯•
CREATE TEMPORARY TABLE temp_orders AS 
SELECT * FROM orders WHERE status = 'pending';
SELECT COUNT(*) FROM temp_orders; -- æ£€æŸ¥æ•°æ®é‡

-- æ­¥éª¤2æµ‹è¯•
UPDATE temp_orders SET total = quantity * price;
SELECT * FROM temp_orders LIMIT 5; -- æ£€æŸ¥è®¡ç®—ç»“æœ
```

### 2.2 è¾“å‡ºè°ƒè¯•æ³•


**æ–¹æ³•è¯´æ˜**ï¼šåœ¨å…³é”®ä½ç½®è¾“å‡ºå˜é‡å€¼ï¼Œè§‚å¯Ÿç¨‹åºæ‰§è¡Œè¿‡ç¨‹

```sql
DELIMITER $$
CREATE PROCEDURE debug_calculate_discount(IN order_id INT, OUT discount DECIMAL(10,2))
BEGIN
    DECLARE total_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE customer_level VARCHAR(20) DEFAULT '';
    
    -- è°ƒè¯•è¾“å‡º1ï¼šè¾“å…¥å‚æ•°
    SELECT CONCAT('Input order_id: ', order_id) AS debug_info;
    
    -- è·å–è®¢å•æ€»é‡‘é¢
    SELECT total INTO total_amount FROM orders WHERE id = order_id;
    
    -- è°ƒè¯•è¾“å‡º2ï¼šè®¢å•é‡‘é¢
    SELECT CONCAT('Order total: ', IFNULL(total_amount, 'NULL')) AS debug_info;
    
    -- è·å–å®¢æˆ·ç­‰çº§
    SELECT level INTO customer_level 
    FROM customers c JOIN orders o ON c.id = o.customer_id 
    WHERE o.id = order_id;
    
    -- è°ƒè¯•è¾“å‡º3ï¼šå®¢æˆ·ç­‰çº§
    SELECT CONCAT('Customer level: ', IFNULL(customer_level, 'NULL')) AS debug_info;
    
    -- è®¡ç®—æŠ˜æ‰£
    CASE customer_level
        WHEN 'VIP' THEN SET discount = total_amount * 0.2;
        WHEN 'Gold' THEN SET discount = total_amount * 0.1;
        ELSE SET discount = 0;
    END CASE;
    
    -- è°ƒè¯•è¾“å‡º4ï¼šæœ€ç»ˆæŠ˜æ‰£
    SELECT CONCAT('Final discount: ', IFNULL(discount, 'NULL')) AS debug_info;
END$$
DELIMITER ;
```

### 2.3 æ¡ä»¶è°ƒè¯•æ³•


**åº”ç”¨åœºæ™¯**ï¼šåªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¾“å‡ºè°ƒè¯•ä¿¡æ¯

```sql
DELIMITER $$
CREATE PROCEDURE process_with_debug(IN user_id INT, IN debug_mode BOOLEAN DEFAULT FALSE)
BEGIN
    DECLARE user_count INT DEFAULT 0;
    
    SELECT COUNT(*) INTO user_count FROM users WHERE id = user_id;
    
    -- åªåœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºä¿¡æ¯
    IF debug_mode THEN
        SELECT CONCAT('Found ', user_count, ' users with id ', user_id) AS debug_msg;
    END IF;
    
    IF user_count = 0 THEN
        IF debug_mode THEN
            SELECT 'User not found, exiting...' AS debug_msg;
        END IF;
        LEAVE process_label;
    END IF;
    
    -- æ­£å¸¸ä¸šåŠ¡é€»è¾‘
    UPDATE users SET last_login = NOW() WHERE id = user_id;
END$$
DELIMITER ;

-- ä½¿ç”¨æ–¹å¼
CALL process_with_debug(123, TRUE);  -- å¼€å¯è°ƒè¯•æ¨¡å¼
CALL process_with_debug(123, FALSE); -- å…³é—­è°ƒè¯•æ¨¡å¼
```

---

## 3. ğŸ¯ æ–­ç‚¹è®¾ç½®ä¸å˜é‡ç›‘æ§


### 3.1 æ‰‹åŠ¨æ–­ç‚¹å®ç°


**åŸç†è¯´æ˜**ï¼šç”±äºMySQLæ²¡æœ‰å†…ç½®è°ƒè¯•å™¨ï¼Œæˆ‘ä»¬é€šè¿‡ç‰¹æ®Šè¡¨æ¥æ¨¡æ‹Ÿæ–­ç‚¹åŠŸèƒ½

```sql
-- åˆ›å»ºè°ƒè¯•è¡¨
CREATE TABLE debug_breakpoints (
    id INT AUTO_INCREMENT PRIMARY KEY,
    procedure_name VARCHAR(100),
    breakpoint_line INT,
    variable_name VARCHAR(50),
    variable_value TEXT,
    execution_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¸¦æ–­ç‚¹çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE debug_user_registration(IN email VARCHAR(100), IN password VARCHAR(100))
BEGIN
    DECLARE user_exists INT DEFAULT 0;
    DECLARE new_user_id INT DEFAULT 0;
    
    -- æ–­ç‚¹1ï¼šæ£€æŸ¥è¾“å…¥å‚æ•°
    INSERT INTO debug_breakpoints (procedure_name, breakpoint_line, variable_name, variable_value)
    VALUES ('debug_user_registration', 1, 'email', email),
           ('debug_user_registration', 1, 'password', LEFT(password, 3));
    
    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    SELECT COUNT(*) INTO user_exists FROM users WHERE email = email;
    
    -- æ–­ç‚¹2ï¼šæ£€æŸ¥ç”¨æˆ·å­˜åœ¨æ€§
    INSERT INTO debug_breakpoints (procedure_name, breakpoint_line, variable_name, variable_value)
    VALUES ('debug_user_registration', 2, 'user_exists', user_exists);
    
    IF user_exists > 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'User already exists';
    END IF;
    
    -- åˆ›å»ºæ–°ç”¨æˆ·
    INSERT INTO users (email, password, created_at) VALUES (email, MD5(password), NOW());
    SET new_user_id = LAST_INSERT_ID();
    
    -- æ–­ç‚¹3ï¼šè®°å½•æ–°ç”¨æˆ·ID
    INSERT INTO debug_breakpoints (procedure_name, breakpoint_line, variable_name, variable_value)
    VALUES ('debug_user_registration', 3, 'new_user_id', new_user_id);
END$$
DELIMITER ;
```

### 3.2 å˜é‡ç›‘æ§æŠ€å·§


**å®æ—¶å˜é‡æŸ¥çœ‹**ï¼š
```sql
DELIMITER $$
CREATE PROCEDURE monitor_variables_demo(IN start_date DATE, IN end_date DATE)
BEGIN
    DECLARE total_orders INT DEFAULT 0;
    DECLARE total_revenue DECIMAL(15,2) DEFAULT 0;
    DECLARE avg_order_value DECIMAL(10,2) DEFAULT 0;
    
    -- åˆ›å»ºå˜é‡ç›‘æ§è§†å›¾
    CREATE TEMPORARY TABLE var_monitor (
        step_name VARCHAR(50),
        total_orders INT,
        total_revenue DECIMAL(15,2),
        avg_order_value DECIMAL(10,2),
        timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- æ­¥éª¤1ï¼šåˆå§‹çŠ¶æ€
    INSERT INTO var_monitor (step_name, total_orders, total_revenue, avg_order_value)
    VALUES ('Initial', total_orders, total_revenue, avg_order_value);
    
    -- è®¡ç®—è®¢å•æ•°é‡
    SELECT COUNT(*) INTO total_orders 
    FROM orders 
    WHERE order_date BETWEEN start_date AND end_date;
    
    -- æ­¥éª¤2ï¼šè·å–è®¢å•æ•°é‡å
    INSERT INTO var_monitor (step_name, total_orders, total_revenue, avg_order_value)
    VALUES ('After count', total_orders, total_revenue, avg_order_value);
    
    -- è®¡ç®—æ€»æ”¶å…¥
    SELECT SUM(total_amount) INTO total_revenue 
    FROM orders 
    WHERE order_date BETWEEN start_date AND end_date;
    
    -- æ­¥éª¤3ï¼šè·å–æ€»æ”¶å…¥å
    INSERT INTO var_monitor (step_name, total_orders, total_revenue, avg_order_value)
    VALUES ('After revenue', total_orders, total_revenue, avg_order_value);
    
    -- è®¡ç®—å¹³å‡è®¢å•ä»·å€¼
    IF total_orders > 0 THEN
        SET avg_order_value = total_revenue / total_orders;
    END IF;
    
    -- æ­¥éª¤4ï¼šæœ€ç»ˆç»“æœ
    INSERT INTO var_monitor (step_name, total_orders, total_revenue, avg_order_value)
    VALUES ('Final', total_orders, total_revenue, avg_order_value);
    
    -- æ˜¾ç¤ºç›‘æ§ç»“æœ
    SELECT * FROM var_monitor ORDER BY timestamp;
END$$
DELIMITER ;
```

---

## 4. ğŸ“Š æ‰§è¡Œè·Ÿè¸ªä¸æ—¥å¿—è¾“å‡º


### 4.1 æ‰§è¡Œè·¯å¾„è·Ÿè¸ª


**ç›®çš„**ï¼šäº†è§£ç¨‹åºæ‰§è¡Œçš„å…·ä½“è·¯å¾„ï¼Œç‰¹åˆ«æ˜¯æ¡ä»¶åˆ†æ”¯

```sql
-- åˆ›å»ºæ‰§è¡Œè·Ÿè¸ªè¡¨
CREATE TABLE execution_trace (
    trace_id INT AUTO_INCREMENT PRIMARY KEY,
    procedure_name VARCHAR(100),
    trace_point VARCHAR(100),
    condition_result VARCHAR(20),
    trace_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER $$
CREATE PROCEDURE trace_order_processing(IN order_id INT)
BEGIN
    DECLARE order_status VARCHAR(20);
    DECLARE payment_status VARCHAR(20);
    DECLARE stock_available INT DEFAULT 0;
    
    -- è·Ÿè¸ªç‚¹1ï¼šå¼€å§‹æ‰§è¡Œ
    INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
    VALUES ('trace_order_processing', 'START', 'N/A');
    
    -- è·å–è®¢å•çŠ¶æ€
    SELECT status INTO order_status FROM orders WHERE id = order_id;
    
    -- è·Ÿè¸ªç‚¹2ï¼šè®¢å•çŠ¶æ€æ£€æŸ¥
    IF order_status = 'pending' THEN
        INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
        VALUES ('trace_order_processing', 'ORDER_STATUS_CHECK', 'PENDING');
        
        -- æ£€æŸ¥åº“å­˜
        SELECT stock INTO stock_available 
        FROM products p 
        JOIN order_items oi ON p.id = oi.product_id 
        WHERE oi.order_id = order_id;
        
        -- è·Ÿè¸ªç‚¹3ï¼šåº“å­˜æ£€æŸ¥
        IF stock_available > 0 THEN
            INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
            VALUES ('trace_order_processing', 'STOCK_CHECK', 'AVAILABLE');
            
            -- å¤„ç†è®¢å•
            UPDATE orders SET status = 'processing' WHERE id = order_id;
            
        ELSE
            INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
            VALUES ('trace_order_processing', 'STOCK_CHECK', 'INSUFFICIENT');
            
            UPDATE orders SET status = 'out_of_stock' WHERE id = order_id;
        END IF;
        
    ELSE
        INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
        VALUES ('trace_order_processing', 'ORDER_STATUS_CHECK', order_status);
    END IF;
    
    -- è·Ÿè¸ªç‚¹4ï¼šç»“æŸæ‰§è¡Œ
    INSERT INTO execution_trace (procedure_name, trace_point, condition_result)
    VALUES ('trace_order_processing', 'END', 'N/A');
END$$
DELIMITER ;
```

### 4.2 æ€§èƒ½ç›‘æ§ä¸æ—¥å¿—


**æ‰§è¡Œæ—¶é—´ç›‘æ§**ï¼š
```sql
DELIMITER $$
CREATE PROCEDURE performance_monitor_demo(IN user_id INT)
BEGIN
    DECLARE start_time TIMESTAMP DEFAULT NOW(6);
    DECLARE end_time TIMESTAMP;
    DECLARE duration_ms INT;
    
    -- åˆ›å»ºæ€§èƒ½æ—¥å¿—è¡¨
    CREATE TABLE IF NOT EXISTS performance_log (
        log_id INT AUTO_INCREMENT PRIMARY KEY,
        procedure_name VARCHAR(100),
        operation_name VARCHAR(100),
        duration_ms INT,
        record_count INT,
        log_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- æ“ä½œ1ï¼šæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    SET start_time = NOW(6);
    SELECT * FROM users WHERE id = user_id;
    SET end_time = NOW(6);
    SET duration_ms = TIMESTAMPDIFF(MICROSECOND, start_time, end_time) / 1000;
    
    INSERT INTO performance_log (procedure_name, operation_name, duration_ms, record_count)
    VALUES ('performance_monitor_demo', 'SELECT_USER', duration_ms, 1);
    
    -- æ“ä½œ2ï¼šæŸ¥è¯¢ç”¨æˆ·è®¢å•
    SET start_time = NOW(6);
    SELECT COUNT(*) FROM orders WHERE user_id = user_id;
    SET end_time = NOW(6);
    SET duration_ms = TIMESTAMPDIFF(MICROSECOND, start_time, end_time) / 1000;
    
    INSERT INTO performance_log (procedure_name, operation_name, duration_ms, record_count)
    VALUES ('performance_monitor_demo', 'COUNT_ORDERS', duration_ms, 1);
    
    -- æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
    SELECT * FROM performance_log 
    WHERE procedure_name = 'performance_monitor_demo' 
    ORDER BY log_time DESC 
    LIMIT 10;
END$$
DELIMITER ;
```

---

## 5. ğŸ§ª å­˜å‚¨è¿‡ç¨‹å•å…ƒæµ‹è¯•


### 5.1 æµ‹è¯•æ•°æ®å‡†å¤‡


**æµ‹è¯•æ•°æ®çš„é‡è¦æ€§**ï¼šå°±åƒåšå®éªŒéœ€è¦å‡†å¤‡å®éªŒææ–™ä¸€æ ·ï¼Œæµ‹è¯•å­˜å‚¨è¿‡ç¨‹éœ€è¦å‡†å¤‡å„ç§æµ‹è¯•æ•°æ®

```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®å‡†å¤‡è„šæœ¬
DELIMITER $$
CREATE PROCEDURE prepare_test_data()
BEGIN
    -- æ¸…ç†æµ‹è¯•æ•°æ®
    DELETE FROM test_orders WHERE id > 0;
    DELETE FROM test_users WHERE id > 0;
    
    -- é‡ç½®è‡ªå¢ID
    ALTER TABLE test_orders AUTO_INCREMENT = 1;
    ALTER TABLE test_users AUTO_INCREMENT = 1;
    
    -- æ’å…¥æµ‹è¯•ç”¨æˆ·
    INSERT INTO test_users (name, email, status) VALUES
    ('å¼ ä¸‰', 'zhangsan@test.com', 'active'),
    ('æå››', 'lisi@test.com', 'inactive'),
    ('ç‹äº”', 'wangwu@test.com', 'active');
    
    -- æ’å…¥æµ‹è¯•è®¢å•
    INSERT INTO test_orders (user_id, amount, status) VALUES
    (1, 100.00, 'pending'),
    (1, 200.00, 'completed'),
    (2, 150.00, 'pending'),
    (3, 300.00, 'cancelled');
    
    SELECT 'Test data prepared successfully' AS message;
END$$
DELIMITER ;
```

### 5.2 æµ‹è¯•ç”¨ä¾‹è®¾è®¡


**æµ‹è¯•ç”¨ä¾‹è¦†ç›–åŸåˆ™**ï¼š
- **æ­£å¸¸æƒ…å†µ**ï¼šç¬¦åˆé¢„æœŸçš„è¾“å…¥
- **è¾¹ç•Œæƒ…å†µ**ï¼šæå€¼è¾“å…¥
- **å¼‚å¸¸æƒ…å†µ**ï¼šé”™è¯¯è¾“å…¥

```sql
-- åˆ›å»ºæµ‹è¯•ç»“æœè¡¨
CREATE TABLE test_results (
    test_id INT AUTO_INCREMENT PRIMARY KEY,
    test_name VARCHAR(100),
    expected_result VARCHAR(500),
    actual_result VARCHAR(500),
    test_status ENUM('PASS', 'FAIL', 'ERROR'),
    test_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è¢«æµ‹è¯•çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE calculate_user_total(IN user_id INT, OUT total_amount DECIMAL(10,2))
BEGIN
    SELECT IFNULL(SUM(amount), 0) INTO total_amount 
    FROM orders 
    WHERE user_id = user_id AND status = 'completed';
END$$
DELIMITER ;

-- æµ‹è¯•æ¡†æ¶
DELIMITER $$
CREATE PROCEDURE test_calculate_user_total()
BEGIN
    DECLARE actual_total DECIMAL(10,2);
    DECLARE test_status VARCHAR(10);
    
    -- å‡†å¤‡æµ‹è¯•æ•°æ®
    CALL prepare_test_data();
    
    -- æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸ç”¨æˆ·
    CALL calculate_user_total(1, actual_total);
    IF actual_total = 200.00 THEN
        SET test_status = 'PASS';
    ELSE
        SET test_status = 'FAIL';
    END IF;
    
    INSERT INTO test_results (test_name, expected_result, actual_result, test_status)
    VALUES ('Normal user test', '200.00', actual_total, test_status);
    
    -- æµ‹è¯•ç”¨ä¾‹2ï¼šæ— è®¢å•ç”¨æˆ·
    CALL calculate_user_total(999, actual_total);
    IF actual_total = 0.00 THEN
        SET test_status = 'PASS';
    ELSE
        SET test_status = 'FAIL';
    END IF;
    
    INSERT INTO test_results (test_name, expected_result, actual_result, test_status)
    VALUES ('No orders user test', '0.00', actual_total, test_status);
    
    -- æµ‹è¯•ç”¨ä¾‹3ï¼šåªæœ‰æœªå®Œæˆè®¢å•çš„ç”¨æˆ·
    CALL calculate_user_total(2, actual_total);
    IF actual_total = 0.00 THEN
        SET test_status = 'PASS';
    ELSE
        SET test_status = 'FAIL';
    END IF;
    
    INSERT INTO test_results (test_name, expected_result, actual_result, test_status)
    VALUES ('Pending orders only test', '0.00', actual_total, test_status);
    
    -- æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    SELECT 
        test_name,
        expected_result,
        actual_result,
        test_status,
        CASE 
            WHEN test_status = 'PASS' THEN 'âœ…'
            WHEN test_status = 'FAIL' THEN 'âŒ'
            ELSE 'âš ï¸'
        END AS result_icon
    FROM test_results 
    ORDER BY test_id DESC 
    LIMIT 10;
END$$
DELIMITER ;
```

### 5.3 è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶


**æ‰¹é‡æµ‹è¯•ç®¡ç†**ï¼š
```sql
DELIMITER $$
CREATE PROCEDURE run_all_tests()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE test_proc_name VARCHAR(100);
    DECLARE total_tests INT DEFAULT 0;
    DECLARE passed_tests INT DEFAULT 0;
    
    -- æ¸¸æ ‡ï¼šè·å–æ‰€æœ‰æµ‹è¯•è¿‡ç¨‹
    DECLARE test_cursor CURSOR FOR
        SELECT routine_name 
        FROM information_schema.routines 
        WHERE routine_schema = DATABASE() 
        AND routine_name LIKE 'test_%'
        AND routine_type = 'PROCEDURE';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- æ¸…ç†æ—§çš„æµ‹è¯•ç»“æœ
    DELETE FROM test_results WHERE test_time < DATE_SUB(NOW(), INTERVAL 1 DAY);
    
    -- æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    OPEN test_cursor;
    test_loop: LOOP
        FETCH test_cursor INTO test_proc_name;
        IF done THEN
            LEAVE test_loop;
        END IF;
        
        -- åŠ¨æ€æ‰§è¡Œæµ‹è¯•è¿‡ç¨‹
        SET @sql = CONCAT('CALL ', test_proc_name, '()');
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        SET total_tests = total_tests + 1;
    END LOOP;
    CLOSE test_cursor;
    
    -- ç»Ÿè®¡æµ‹è¯•ç»“æœ
    SELECT COUNT(*) INTO passed_tests 
    FROM test_results 
    WHERE test_status = 'PASS' 
    AND test_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);
    
    -- æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
    SELECT 
        total_tests AS 'Total Test Suites',
        passed_tests AS 'Passed Tests',
        (SELECT COUNT(*) FROM test_results WHERE test_status = 'FAIL' AND test_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)) AS 'Failed Tests',
        CONCAT(ROUND(passed_tests / total_tests * 100, 2), '%') AS 'Success Rate';
END$$
DELIMITER ;
```

---

## 6. ğŸ”§ è°ƒè¯•å·¥å…·ä½¿ç”¨æŒ‡å—


### 6.1 MySQL Workbenchè°ƒè¯•å™¨


**åŸºæœ¬ä½¿ç”¨æ–¹æ³•**ï¼šMySQL Workbenchæä¾›äº†å¯è§†åŒ–çš„è°ƒè¯•ç•Œé¢

> ğŸ’¡ **å¯ç”¨è°ƒè¯•åŠŸèƒ½**ï¼š
> 1. åœ¨MySQL Workbenchä¸­æ‰“å¼€å­˜å‚¨è¿‡ç¨‹
> 2. å³é”®é€‰æ‹©"Debug Routine"
> 3. è®¾ç½®è¾“å…¥å‚æ•°
> 4. å¼€å§‹è°ƒè¯•

**è°ƒè¯•ç•Œé¢è¯´æ˜**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒè¯•å·¥å…·æ                           â”‚
â”‚  [å¼€å§‹] [åœæ­¢] [å•æ­¥] [è·³è¿‡] [ç»§ç»­]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»£ç çª—å£                            â”‚
â”‚  â†’ BEGIN                           â”‚
â”‚    DECLARE total INT DEFAULT 0;    â”‚ â† å½“å‰è¡Œ
â”‚    SELECT COUNT(*) INTO total...   â”‚
â”‚    IF total > 0 THEN              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å˜é‡ç›‘è§†çª—å£                        â”‚
â”‚  total: 0 â†’ 150                   â”‚
â”‚  user_id: 123                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è°ƒç”¨å †æ ˆ                            â”‚
â”‚  calculate_bonus() line 5          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å‘½ä»¤è¡Œè°ƒè¯•æŠ€å·§


**ä½¿ç”¨MySQLå‘½ä»¤è¡Œè¿›è¡Œè°ƒè¯•**ï¼š
```bash
# è¿æ¥åˆ°MySQL
mysql -u username -p database_name

# å¼€å¯æŸ¥è¯¢æ—¥å¿—
SET GLOBAL general_log = 'ON';
SET GLOBAL general_log_file = '/tmp/mysql_debug.log';

# æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹
CALL your_procedure(param1, param2);

# æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯çª—å£
tail -f /tmp/mysql_debug.log
```

**è°ƒè¯•ä¼šè¯ç¤ºä¾‹**ï¼š
```sql
-- è®¾ç½®è°ƒè¯•æ¨¡å¼
SET @debug_mode = 1;

-- é€æ­¥è°ƒè¯•
SELECT 'å¼€å§‹è°ƒè¯•å­˜å‚¨è¿‡ç¨‹' AS debug_step;

-- è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
CALL debug_calculate_bonus(123, @result);

-- æ£€æŸ¥ç»“æœ
SELECT @result AS final_result;

-- æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
SELECT * FROM debug_breakpoints WHERE procedure_name = 'debug_calculate_bonus';
```

### 6.3 ç¬¬ä¸‰æ–¹è°ƒè¯•å·¥å…·


**å¸¸ç”¨è°ƒè¯•å·¥å…·å¯¹æ¯”**ï¼š

| å·¥å…·åç§° | **é€‚ç”¨åœºæ™¯** | **ä¸»è¦ç‰¹ç‚¹** | **è´¹ç”¨** |
|---------|-------------|-------------|---------|
| **MySQL Workbench** | `æ—¥å¸¸å¼€å‘è°ƒè¯•` | å…è´¹ã€ç•Œé¢å‹å¥½ã€åŠŸèƒ½åŸºç¡€ | `å…è´¹` |
| **Navicat** | `å•†ä¸šå¼€å‘` | ç•Œé¢ç²¾ç¾ã€åŠŸèƒ½ä¸°å¯Œ | `ä»˜è´¹` |
| **phpMyAdmin** | `Webå¼€å‘` | Webç•Œé¢ã€è½»é‡çº§ | `å…è´¹` |
| **DBeaver** | `è·¨å¹³å°å¼€å‘` | æ”¯æŒå¤šç§æ•°æ®åº“ | `å…è´¹/ä»˜è´¹` |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 è°ƒè¯•åŸºæœ¬åŸåˆ™


> ğŸ§  **è°ƒè¯•æ€ç»´å¯¼å›¾**ï¼š
> ```
> å­˜å‚¨è¿‡ç¨‹è°ƒè¯•
> â”œâ”€â”€ é—®é¢˜å®šä½
> â”‚   â”œâ”€â”€ è¯­æ³•é”™è¯¯ â†’ ä»”ç»†æ£€æŸ¥SQLè¯­æ³•
> â”‚   â”œâ”€â”€ é€»è¾‘é”™è¯¯ â†’ åˆ†æ­¥éªŒè¯ä¸šåŠ¡é€»è¾‘
> â”‚   â””â”€â”€ æ€§èƒ½é—®é¢˜ â†’ ç›‘æ§æ‰§è¡Œæ—¶é—´
> â”œâ”€â”€ è°ƒè¯•æŠ€å·§
> â”‚   â”œâ”€â”€ åˆ†æ­¥æ‰§è¡Œ â†’ åŒ–ç¹ä¸ºç®€
> â”‚   â”œâ”€â”€ è¾“å‡ºè°ƒè¯• â†’ è§‚å¯Ÿå˜é‡å˜åŒ–
> â”‚   â””â”€â”€ æ¡ä»¶è°ƒè¯• â†’ å¯æ§çš„è°ƒè¯•ä¿¡æ¯
> â””â”€â”€ æµ‹è¯•éªŒè¯
>     â”œâ”€â”€ å•å…ƒæµ‹è¯• â†’ éªŒè¯åŠŸèƒ½æ­£ç¡®æ€§
>     â”œâ”€â”€ æ€§èƒ½æµ‹è¯• â†’ ç¡®ä¿æ‰§è¡Œæ•ˆç‡
>     â””â”€â”€ é›†æˆæµ‹è¯• â†’ éªŒè¯æ•´ä½“æµç¨‹
> ```

### 7.2 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæŠ€èƒ½


**ğŸ”¸ åŸºç¡€è°ƒè¯•æŠ€èƒ½**ï¼š
- **æ‰‹åŠ¨æ–­ç‚¹**ï¼šé€šè¿‡è°ƒè¯•è¡¨è®°å½•æ‰§è¡ŒçŠ¶æ€
- **å˜é‡ç›‘æ§**ï¼šå®æ—¶è§‚å¯Ÿå˜é‡å€¼å˜åŒ–
- **æ‰§è¡Œè·Ÿè¸ª**ï¼šäº†è§£ç¨‹åºæ‰§è¡Œè·¯å¾„
- **æ€§èƒ½ç›‘æ§**ï¼šæµ‹é‡å’Œä¼˜åŒ–æ‰§è¡Œæ—¶é—´

**ğŸ”¸ æµ‹è¯•è®¾è®¡æŠ€èƒ½**ï¼š
- **æµ‹è¯•æ•°æ®å‡†å¤‡**ï¼šåˆ›å»ºå„ç§æµ‹è¯•åœºæ™¯
- **ç”¨ä¾‹è®¾è®¡**ï¼šè¦†ç›–æ­£å¸¸ã€è¾¹ç•Œã€å¼‚å¸¸æƒ…å†µ
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šæ‰¹é‡æ‰§è¡Œå’Œç»“æœç»Ÿè®¡

**ğŸ”¸ å·¥å…·ä½¿ç”¨æŠ€èƒ½**ï¼š
- **MySQL Workbench**ï¼šå¯è§†åŒ–è°ƒè¯•ç•Œé¢
- **å‘½ä»¤è¡Œè°ƒè¯•**ï¼šçµæ´»çš„è°ƒè¯•æ–¹å¼
- **æ—¥å¿—åˆ†æ**ï¼šé€šè¿‡æ—¥å¿—å®šä½é—®é¢˜

### 7.3 è°ƒè¯•æœ€ä½³å®è·µ


**ğŸ“ å¼€å‘é˜¶æ®µæœ€ä½³å®è·µ**ï¼š
```sql
-- 1. ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å
DECLARE user_order_count INT DEFAULT 0;  -- âœ… å¥½çš„å‘½å
DECLARE cnt INT DEFAULT 0;               -- âŒ ä¸å¥½çš„å‘½å

-- 2. æ·»åŠ é€‚å½“çš„æ³¨é‡Š
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·
IF user_exists = 0 THEN
    INSERT INTO users (name, email) VALUES (user_name, user_email);
END IF;

-- 3. ä½¿ç”¨å¼‚å¸¸å¤„ç†
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
    ROLLBACK;
    RESIGNAL;
END;
```

**âš ï¸ å¸¸è§è°ƒè¯•è¯¯åŒº**ï¼š
- **è¿‡åº¦è°ƒè¯•**ï¼šä¸è¦åœ¨æ¯ä¸€è¡Œéƒ½æ·»åŠ è°ƒè¯•ä¿¡æ¯
- **è°ƒè¯•ä»£ç æ®‹ç•™**ï¼šæ­£å¼ç¯å¢ƒè¦ç§»é™¤è°ƒè¯•ä»£ç 
- **å¿½ç•¥æ€§èƒ½**ï¼šè°ƒè¯•åŠŸèƒ½ä¸åº”å½±å“æ­£å¸¸æ€§èƒ½

### 7.4 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ åœ¨å®é™…å·¥ä½œä¸­çš„åº”ç”¨**ï¼š
- **å¼€å‘é˜¶æ®µ**ï¼šå¿«é€Ÿå®šä½å’Œä¿®å¤é—®é¢˜
- **æµ‹è¯•é˜¶æ®µ**ï¼šéªŒè¯åŠŸèƒ½æ­£ç¡®æ€§å’Œæ€§èƒ½
- **ç»´æŠ¤é˜¶æ®µ**ï¼šæ’æŸ¥ç”Ÿäº§ç¯å¢ƒé—®é¢˜
- **ä¼˜åŒ–é˜¶æ®µ**ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ

**ğŸ’¡ è°ƒè¯•æŠ€èƒ½çš„ä»·å€¼**ï¼š
- **æé«˜å¼€å‘æ•ˆç‡**ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œå‡å°‘debugæ—¶é—´
- **ä¿è¯ä»£ç è´¨é‡**ï¼šé€šè¿‡æµ‹è¯•ç¡®ä¿ä»£ç å¯é æ€§
- **é™ä½ç»´æŠ¤æˆæœ¬**ï¼šæ—©æœŸå‘ç°é—®é¢˜ï¼Œé¿å…åæœŸå¤§é‡ä¿®æ”¹

**ğŸ”§ æŒç»­æ”¹è¿›å»ºè®®**ï¼š
1. **å»ºç«‹è°ƒè¯•è§„èŒƒ**ï¼šå›¢é˜Ÿç»Ÿä¸€çš„è°ƒè¯•æ–¹æ³•å’Œå·¥å…·
2. **ç§¯ç´¯è°ƒè¯•ç»éªŒ**ï¼šè®°å½•å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
3. **å·¥å…·ç†Ÿç»ƒä½¿ç”¨**ï¼šæŒæ¡å„ç§è°ƒè¯•å·¥å…·çš„é«˜çº§åŠŸèƒ½
4. **ä»£ç å®¡æŸ¥**ï¼šé€šè¿‡reviewå‘ç°æ½œåœ¨é—®é¢˜

> **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> "è°ƒè¯•å¦‚ç ´æ¡ˆï¼Œçº¿ç´¢è¦æ”¶å…¨ï¼›
>  åˆ†æ­¥æ‰¾é—®é¢˜ï¼Œå˜é‡è¦ç›‘çœ‹ï¼›
>  æµ‹è¯•è¦å……åˆ†ï¼Œå·¥å…·è¦ç†Ÿç»ƒï¼›
>  è§„èŒƒå¾ˆé‡è¦ï¼Œç»éªŒè¦ç§¯ç´¯ã€‚"