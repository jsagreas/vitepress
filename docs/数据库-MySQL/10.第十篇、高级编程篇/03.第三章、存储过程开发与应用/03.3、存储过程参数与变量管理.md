---
title: 3、存储过程参数与变量管理
---
## 📚 目录

1. [存储过程参数基础](#1-存储过程参数基础)
2. [参数类型详解](#2-参数类型详解)
3. [变量管理机制](#3-变量管理机制)
4. [参数传递与转换](#4-参数传递与转换)
5. [实际应用案例](#5-实际应用案例)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔧 存储过程参数基础


### 1.1 什么是存储过程参数


**基本概念**：存储过程参数是向存储过程传递数据或从存储过程返回数据的变量。就像函数的参数一样，让存储过程更加灵活和可重用。

```sql
-- 参数基本语法
CREATE PROCEDURE procedure_name(
    parameter_mode parameter_name data_type,
    parameter_mode parameter_name data_type
)
BEGIN
    -- 存储过程体
END;
```

**参数的作用**：
- 🔹 **数据输入** - 向存储过程传递外部数据
- 🔹 **结果输出** - 从存储过程返回处理结果
- 🔹 **双向交互** - 既接收又返回数据

### 1.2 参数声明语法


```sql
-- 完整参数声明格式
CREATE PROCEDURE demo_proc(
    IN input_param INT,           -- 输入参数
    OUT output_param VARCHAR(50), -- 输出参数
    INOUT inout_param DECIMAL(10,2) -- 输入输出参数
)
BEGIN
    -- 存储过程逻辑
END;
```

**语法要点**：
- `parameter_mode`：参数模式（IN/OUT/INOUT）
- `parameter_name`：参数名称（遵循变量命名规则）
- `data_type`：参数数据类型（支持MySQL所有数据类型）

---

## 2. 📊 参数类型详解


### 2.1 输入参数（IN）


**定义**：IN参数用于向存储过程传递数据，这是最常用的参数类型。参数值在存储过程内部可以读取但修改不会影响外部。

```sql
-- 示例：根据用户ID查询用户信息
DELIMITER //
CREATE PROCEDURE GetUserInfo(
    IN user_id INT  -- 输入参数：用户ID
)
BEGIN
    SELECT username, email, created_at 
    FROM users 
    WHERE id = user_id;
END //
DELIMITER ;

-- 调用示例
CALL GetUserInfo(123);
```

**IN参数特点**：
```
传递方式：值传递（复制一份给存储过程）
修改影响：内部修改不影响外部变量
默认模式：不指定模式时默认为IN
使用场景：查询条件、配置参数、标识符等
```

### 2.2 输出参数（OUT）


**定义**：OUT参数用于从存储过程返回数据给调用者。存储过程可以通过OUT参数将处理结果传递回外部。

```sql
-- 示例：计算订单总金额
DELIMITER //
CREATE PROCEDURE CalculateOrderTotal(
    IN order_id INT,           -- 输入：订单ID
    OUT total_amount DECIMAL(10,2)  -- 输出：总金额
)
BEGIN
    SELECT SUM(price * quantity) 
    INTO total_amount
    FROM order_items 
    WHERE order_id = order_id;
    
    -- 如果没有找到订单，设为0
    IF total_amount IS NULL THEN
        SET total_amount = 0.00;
    END IF;
END //
DELIMITER ;

-- 调用示例
SET @result = 0;
CALL CalculateOrderTotal(456, @result);
SELECT @result AS order_total;
```

**OUT参数特点**：
```
初始值：进入存储过程时值为NULL
传递方式：引用传递（修改会影响外部）
返回机制：必须在存储过程内部赋值
使用场景：计算结果、状态码、统计信息等
```

### 2.3 输入输出参数（INOUT）


**定义**：INOUT参数既可以向存储过程传递数据，也可以从存储过程返回数据。它结合了IN和OUT的功能。

```sql
-- 示例：账户余额转账操作
DELIMITER //
CREATE PROCEDURE TransferMoney(
    IN from_account INT,           -- 转出账户
    IN to_account INT,             -- 转入账户
    INOUT amount DECIMAL(10,2)     -- 转账金额（输入）/ 实际转账金额（输出）
)
BEGIN
    DECLARE from_balance DECIMAL(10,2);
    
    -- 检查转出账户余额
    SELECT balance INTO from_balance 
    FROM accounts 
    WHERE account_id = from_account;
    
    -- 如果余额不足，调整转账金额
    IF from_balance < amount THEN
        SET amount = from_balance;  -- 修改INOUT参数
    END IF;
    
    -- 执行转账（简化示例）
    UPDATE accounts SET balance = balance - amount WHERE account_id = from_account;
    UPDATE accounts SET balance = balance + amount WHERE account_id = to_account;
END //
DELIMITER ;

-- 调用示例
SET @transfer_amount = 1000.00;
CALL TransferMoney(123, 456, @transfer_amount);
SELECT @transfer_amount AS actual_transferred;  -- 可能显示实际转账金额
```

**INOUT参数特点**：
```
双向功能：既能接收输入也能返回输出
传递方式：引用传递
初始值：调用时传入的值
使用场景：需要根据处理过程调整的参数
```

### 2.4 参数类型对比


| 参数类型 | **传递方式** | **初始值** | **修改影响** | **常用场景** |
|---------|-------------|-----------|-------------|-------------|
| **IN** | `值传递` | `调用时传入` | `不影响外部` | `查询条件、配置参数` |
| **OUT** | `引用传递` | `NULL` | `影响外部` | `计算结果、状态返回` |
| **INOUT** | `引用传递` | `调用时传入` | `影响外部` | `需要调整的参数值` |

---

## 3. 🗃️ 变量管理机制


### 3.1 局部变量声明与使用


**定义**：局部变量是在存储过程内部声明的变量，只在当前存储过程的作用域内有效。

```sql
-- 局部变量示例
DELIMITER //
CREATE PROCEDURE ProcessOrder(
    IN order_id INT,
    OUT result_message VARCHAR(100)
)
BEGIN
    -- 声明局部变量
    DECLARE order_status VARCHAR(20);
    DECLARE item_count INT DEFAULT 0;
    DECLARE total_price DECIMAL(10,2) DEFAULT 0.00;
    DECLARE done INT DEFAULT 0;
    
    -- 查询订单状态
    SELECT status INTO order_status 
    FROM orders 
    WHERE id = order_id;
    
    -- 检查订单是否存在
    IF order_status IS NULL THEN
        SET result_message = '订单不存在';
    ELSEIF order_status = 'completed' THEN
        SET result_message = '订单已完成';
    ELSE
        -- 计算订单项目数量和总价
        SELECT COUNT(*), SUM(price * quantity) 
        INTO item_count, total_price
        FROM order_items 
        WHERE order_id = order_id;
        
        SET result_message = CONCAT('订单包含', item_count, '个商品，总价：', total_price);
    END IF;
END //
DELIMITER ;
```

**局部变量特点**：
```
声明位置：必须在BEGIN之后，其他语句之前
作用域：仅在当前存储过程内有效
生命周期：存储过程执行开始到结束
默认值：可以设置默认值，否则为NULL
```

### 3.2 变量赋值方法


**SET赋值**：直接给变量赋值
```sql
BEGIN
    DECLARE counter INT DEFAULT 0;
    DECLARE username VARCHAR(50);
    
    -- 使用SET赋值
    SET counter = 10;
    SET username = 'admin';
    SET counter = counter + 1;  -- 递增操作
END
```

**INTO赋值**：从查询结果中赋值
```sql
BEGIN
    DECLARE user_count INT;
    DECLARE max_salary DECIMAL(10,2);
    
    -- 使用INTO从查询结果赋值
    SELECT COUNT(*) INTO user_count FROM users;
    SELECT MAX(salary) INTO max_salary FROM employees;
END
```

### 3.3 系统变量与用户变量


**系统变量**：MySQL预定义的变量，控制服务器行为
```sql
-- 查看和使用系统变量
BEGIN
    -- 查看当前数据库
    SELECT DATABASE() AS current_db;
    
    -- 查看系统变量
    SELECT $$version AS mysql_version;
    SELECT $$max_connections AS max_conn;
END
```

**用户变量**：以`@`开头，在整个会话中有效
```sql
-- 用户变量示例
BEGIN
    -- 设置用户变量
    SET @session_user = USER();
    SET @current_time = NOW();
    
    -- 在存储过程中使用用户变量
    INSERT INTO audit_log(user_name, login_time) 
    VALUES(@session_user, @current_time);
END
```

**变量作用域对比**：
```
局部变量（DECLARE）：
作用域：当前存储过程
生命周期：存储过程执行期间
访问方式：直接使用变量名

用户变量（@var）：
作用域：当前会话
生命周期：会话连接期间
访问方式：@变量名

系统变量（$$var）：
作用域：全局或会话级别
生命周期：服务器运行期间或会话期间
访问方式：$$变量名
```

---

## 4. 🔄 参数传递与转换


### 4.1 参数传递机制


**值传递（IN参数）**：
```sql
-- 值传递示例
DELIMITER //
CREATE PROCEDURE TestValuePass(
    IN input_val INT
)
BEGIN
    SET input_val = input_val * 2;  -- 内部修改
    SELECT input_val AS modified_value;
END //
DELIMITER ;

-- 测试值传递
SET @test_var = 10;
CALL TestValuePass(@test_var);      -- 显示20
SELECT @test_var AS original_value; -- 仍然是10（外部未改变）
```

**引用传递（OUT/INOUT参数）**：
```sql
-- 引用传递示例
DELIMITER //
CREATE PROCEDURE TestRefPass(
    INOUT ref_val INT
)
BEGIN
    SET ref_val = ref_val * 2;  -- 内部修改
END //
DELIMITER ;

-- 测试引用传递
SET @test_var = 10;
CALL TestRefPass(@test_var);        -- 内部计算
SELECT @test_var AS modified_value; -- 显示20（外部已改变）
```

### 4.2 参数类型自动转换


**数值类型转换**：
```sql
DELIMITER //
CREATE PROCEDURE TestTypeConversion(
    IN int_param INT,
    IN decimal_param DECIMAL(10,2),
    OUT result_msg VARCHAR(100)
)
BEGIN
    DECLARE converted_val DECIMAL(10,2);
    
    -- 整数自动转换为小数
    SET converted_val = int_param + decimal_param;
    SET result_msg = CONCAT('转换结果：', converted_val);
END //
DELIMITER ;

-- 调用时自动类型转换
CALL TestTypeConversion('123', 45.67, @msg);  -- 字符串'123'转为整数
SELECT @msg;  -- 显示：转换结果：168.67
```

**字符串类型转换**：
```sql
-- 字符串与数值的转换
BEGIN
    DECLARE str_val VARCHAR(20) DEFAULT '100';
    DECLARE num_val INT;
    
    -- 字符串转数值
    SET num_val = str_val + 50;  -- 结果是150
    
    -- 数值转字符串  
    SET str_val = CONCAT(num_val, ' items');  -- 结果是'150 items'
END
```

### 4.3 参数默认值处理


**模拟默认参数**：MySQL存储过程不直接支持默认参数，但可以通过技巧实现：

```sql
DELIMITER //
CREATE PROCEDURE SearchUsers(
    IN search_name VARCHAR(50),
    IN search_email VARCHAR(100),
    IN page_size INT
)
BEGIN
    -- 处理默认值
    IF page_size IS NULL OR page_size <= 0 THEN
        SET page_size = 10;  -- 默认每页10条
    END IF;
    
    IF search_name IS NULL THEN
        SET search_name = '';  -- 默认空字符串
    END IF;
    
    -- 构建查询
    SELECT * FROM users 
    WHERE (search_name = '' OR username LIKE CONCAT('%', search_name, '%'))
      AND (search_email IS NULL OR email = search_email)
    LIMIT page_size;
END //
DELIMITER ;

-- 调用方式
CALL SearchUsers('john', NULL, NULL);  -- 使用默认页大小
CALL SearchUsers(NULL, NULL, 20);      -- 使用默认搜索条件
```

---

## 5. 🎯 实际应用案例


### 5.1 用户权限检查存储过程


```sql
DELIMITER //
CREATE PROCEDURE CheckUserPermission(
    IN user_id INT,
    IN resource_name VARCHAR(100),
    OUT has_permission BOOLEAN,
    OUT permission_level VARCHAR(20)
)
BEGIN
    DECLARE user_role VARCHAR(50);
    DECLARE role_level INT DEFAULT 0;
    
    -- 获取用户角色
    SELECT role INTO user_role 
    FROM users 
    WHERE id = user_id;
    
    -- 检查角色权限等级
    CASE user_role
        WHEN 'admin' THEN SET role_level = 3;
        WHEN 'manager' THEN SET role_level = 2;
        WHEN 'user' THEN SET role_level = 1;
        ELSE SET role_level = 0;
    END CASE;
    
    -- 检查资源所需权限
    SELECT required_level INTO @required
    FROM resource_permissions 
    WHERE resource = resource_name;
    
    -- 判断权限
    IF role_level >= IFNULL(@required, 999) THEN
        SET has_permission = TRUE;
        SET permission_level = user_role;
    ELSE
        SET has_permission = FALSE;
        SET permission_level = 'insufficient';
    END IF;
END //
DELIMITER ;

-- 使用示例
SET @can_access = FALSE;
SET @level = '';
CALL CheckUserPermission(123, 'admin_panel', @can_access, @level);
SELECT @can_access, @level;
```

### 5.2 批量数据处理存储过程


```sql
DELIMITER //
CREATE PROCEDURE BatchUpdatePrices(
    IN category_id INT,
    IN adjustment_percent DECIMAL(5,2),
    INOUT affected_count INT
)
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE current_price DECIMAL(10,2);
    DECLARE product_id INT;
    DECLARE new_price DECIMAL(10,2);
    
    -- 游标声明
    DECLARE price_cursor CURSOR FOR 
        SELECT id, price FROM products WHERE category_id = category_id;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
    
    SET affected_count = 0;
    
    OPEN price_cursor;
    
    update_loop: LOOP
        FETCH price_cursor INTO product_id, current_price;
        
        IF done THEN
            LEAVE update_loop;
        END IF;
        
        -- 计算新价格
        SET new_price = current_price * (1 + adjustment_percent / 100);
        
        -- 更新价格
        UPDATE products 
        SET price = new_price 
        WHERE id = product_id;
        
        SET affected_count = affected_count + 1;
    END LOOP;
    
    CLOSE price_cursor;
END //
DELIMITER ;

-- 使用示例
SET @count = 0;
CALL BatchUpdatePrices(5, 10.5, @count);  -- 分类5的商品涨价10.5%
SELECT CONCAT('更新了 ', @count, ' 个商品价格') AS result;
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 参数类型：IN（输入）、OUT（输出）、INOUT（输入输出）
🔸 传递机制：IN是值传递，OUT/INOUT是引用传递
🔸 变量作用域：局部变量、用户变量、系统变量的区别
🔸 赋值方法：SET直接赋值，INTO从查询结果赋值
🔸 类型转换：MySQL自动进行合理的类型转换
```

### 6.2 关键理解要点


**🔹 参数的本质作用**
```
数据通道：参数是存储过程与外界交换数据的通道
灵活性：通过参数让存储过程可以处理不同的输入
可重用性：同一个存储过程可以用于不同的数据处理
```

**🔹 变量生命周期管理**
```
局部变量：存储过程执行期间
用户变量：当前数据库连接期间  
系统变量：服务器配置，持续有效
合理选择：根据数据使用范围选择合适的变量类型
```

**🔹 参数传递的注意事项**
```
IN参数：内部修改不影响外部，适合传递条件和配置
OUT参数：用于返回结果，调用前必须准备接收变量
INOUT参数：既要传入又要传出，适合需要调整的值
类型转换：MySQL会自动转换，但要注意精度损失
```

### 6.3 实际应用价值


**🎯 业务场景应用**
- **权限检查**：传入用户ID和资源，返回权限状态
- **数据统计**：传入查询条件，返回统计结果
- **批量处理**：传入处理参数，返回影响行数
- **数据验证**：传入待验证数据，返回验证结果

**🔧 编程实践**
- **模块化**：将复杂业务逻辑封装在存储过程中
- **性能优化**：减少应用程序与数据库的交互次数
- **数据安全**：通过参数化避免SQL注入风险
- **代码复用**：一次编写，多处调用

**核心记忆**：
- IN参数传数据进去，OUT参数拿结果出来，INOUT参数双向交流
- 局部变量只在存储过程内有效，用户变量在会话中共享
- SET直接赋值，INTO从查询赋值，MySQL自动转换类型
- 参数让存储过程更灵活，变量让数据处理更高效