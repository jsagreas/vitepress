---
title: 12ã€å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡æ¦‚è¿°](#1-å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡æ¦‚è¿°)
2. [æ¨¡å—åŒ–è®¾è®¡åŸåˆ™](#2-æ¨¡å—åŒ–è®¾è®¡åŸåˆ™)
3. [åˆ†å±‚æ¶æ„æ¨¡å¼](#3-åˆ†å±‚æ¶æ„æ¨¡å¼)
4. [æ¥å£è®¾è®¡è§„èŒƒ](#4-æ¥å£è®¾è®¡è§„èŒƒ)
5. [ä¾èµ–å…³ç³»ç®¡ç†](#5-ä¾èµ–å…³ç³»ç®¡ç†)
6. [å¼‚å¸¸å¤„ç†æ¶æ„](#6-å¼‚å¸¸å¤„ç†æ¶æ„)
7. [æ—¥å¿—è®°å½•æ¶æ„](#7-æ—¥å¿—è®°å½•æ¶æ„)
8. [é…ç½®ç®¡ç†ç­–ç•¥](#8-é…ç½®ç®¡ç†ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡

å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡å°±åƒ**ç›–æˆ¿å­ä¹‹å‰ç”»è®¾è®¡å›¾**ä¸€æ ·ï¼Œæ˜¯è§„åˆ’æ•´ä¸ªå­˜å‚¨è¿‡ç¨‹ç³»ç»Ÿå¦‚ä½•ç»„ç»‡å’Œå·¥ä½œçš„è“å›¾ã€‚

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒå»ºç­‘è®¾è®¡ï¼š
ğŸ  æ™®é€šåšæ³•ï¼šæƒ³åˆ°å“ªå»ºåˆ°å“ªï¼Œæ‚ä¹±æ— ç« 
ğŸ—ï¸ æ¶æ„è®¾è®¡ï¼šå…ˆè§„åˆ’å¸ƒå±€ï¼Œæˆ¿é—´åŠŸèƒ½åˆ†å·¥æ˜ç¡®

å­˜å‚¨è¿‡ç¨‹ä¹Ÿä¸€æ ·ï¼š
âŒ æ— æ¶æ„ï¼šä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹åŒ…å«æ‰€æœ‰é€»è¾‘
âœ… æœ‰æ¶æ„ï¼šä¸åŒå­˜å‚¨è¿‡ç¨‹è´Ÿè´£ä¸åŒåŠŸèƒ½ï¼Œåˆ†å·¥åä½œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ¶æ„è®¾è®¡


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
```
ç”µå•†ç³»ç»Ÿè®¢å•å¤„ç†ï¼š
- è®¢å•åˆ›å»º
- åº“å­˜æ£€æŸ¥  
- æ”¯ä»˜å¤„ç†
- ç§¯åˆ†è®¡ç®—
- é€šçŸ¥å‘é€

æ— æ¶æ„çš„åšæ³•ï¼š
CREATE PROCEDURE process_order()
BEGIN
    -- 1000è¡Œä»£ç ï¼ŒåŒ…å«æ‰€æœ‰é€»è¾‘
    -- éš¾ä»¥ç»´æŠ¤ã€æµ‹è¯•ã€å¤ç”¨
END

æœ‰æ¶æ„çš„åšæ³•ï¼š
CREATE PROCEDURE create_order()     -- ä¸“é—¨è´Ÿè´£è®¢å•åˆ›å»º
CREATE PROCEDURE check_inventory()  -- ä¸“é—¨è´Ÿè´£åº“å­˜æ£€æŸ¥
CREATE PROCEDURE process_payment()  -- ä¸“é—¨è´Ÿè´£æ”¯ä»˜å¤„ç†
```

### 1.3 æ¶æ„è®¾è®¡çš„æ ¸å¿ƒä»·å€¼


**ğŸ¯ ä¸»è¦å¥½å¤„**ï¼š
- **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½ä¸å½±å“å…¶ä»–åŠŸèƒ½
- **å¯é‡ç”¨æ€§**ï¼šåŒä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨
- **å¯æµ‹è¯•æ€§**ï¼šæ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥å•ç‹¬æµ‹è¯•
- **å›¢é˜Ÿåä½œ**ï¼šä¸åŒå¼€å‘äººå‘˜è´Ÿè´£ä¸åŒæ¨¡å—
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹ä¸åŒåŠŸèƒ½åšä¸“é—¨ä¼˜åŒ–

---

## 2. ğŸ§© æ¨¡å—åŒ–è®¾è®¡åŸåˆ™


### 2.1 å•ä¸€èŒè´£åŸåˆ™

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹åªåšä¸€ä»¶äº‹ï¼Œåšå¥½ä¸€ä»¶äº‹ã€‚

```sql
-- âŒ è¿åå•ä¸€èŒè´£ - ä¸€ä¸ªè¿‡ç¨‹åšå¤ªå¤šäº‹
DELIMITER //
CREATE PROCEDURE bad_user_process(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100)
)
BEGIN
    -- ç”¨æˆ·æ³¨å†Œ
    INSERT INTO users (username, email) VALUES (p_username, p_email);
    
    -- å‘é€é‚®ä»¶
    -- é‚®ä»¶å‘é€é€»è¾‘...
    
    -- åˆ›å»ºé»˜è®¤è®¾ç½®
    -- è®¾ç½®åˆ›å»ºé€»è¾‘...
    
    -- è®°å½•æ—¥å¿—
    -- æ—¥å¿—è®°å½•é€»è¾‘...
END //

-- âœ… éµå¾ªå•ä¸€èŒè´£ - åˆ†è§£æˆå¤šä¸ªä¸“é—¨çš„è¿‡ç¨‹
CREATE PROCEDURE create_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100),
    OUT p_user_id INT
)
BEGIN
    INSERT INTO users (username, email, created_at) 
    VALUES (p_username, p_email, NOW());
    SET p_user_id = LAST_INSERT_ID();
END //

CREATE PROCEDURE send_welcome_email(IN p_user_id INT)
BEGIN
    -- ä¸“é—¨è´Ÿè´£å‘é€æ¬¢è¿é‚®ä»¶
    SELECT email INTO @user_email FROM users WHERE id = p_user_id;
    -- é‚®ä»¶å‘é€é€»è¾‘
END //
```

### 2.2 å¯é‡ç”¨æ€§è®¾è®¡


**è®¾è®¡æ€è·¯**ï¼šæŠŠå¸¸ç”¨çš„åŠŸèƒ½æŠ½å–æˆç‹¬ç«‹çš„å­˜å‚¨è¿‡ç¨‹ã€‚

```sql
-- ğŸ”„ å¯é‡ç”¨çš„é€šç”¨éªŒè¯è¿‡ç¨‹
CREATE PROCEDURE validate_email(
    IN p_email VARCHAR(100),
    OUT p_is_valid BOOLEAN
)
BEGIN
    DECLARE email_pattern VARCHAR(100) DEFAULT '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$';
    SET p_is_valid = (p_email REGEXP email_pattern);
END //

-- ğŸ”„ å¯é‡ç”¨çš„æ—¥å¿—è®°å½•è¿‡ç¨‹
CREATE PROCEDURE log_operation(
    IN p_operation VARCHAR(50),
    IN p_user_id INT,
    IN p_details TEXT
)
BEGIN
    INSERT INTO operation_logs (operation, user_id, details, created_at)
    VALUES (p_operation, p_user_id, p_details, NOW());
END //

-- ä½¿ç”¨å¯é‡ç”¨æ¨¡å—
CREATE PROCEDURE register_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100)
)
BEGIN
    DECLARE v_is_valid BOOLEAN DEFAULT FALSE;
    DECLARE v_user_id INT;
    
    -- é‡ç”¨é‚®ç®±éªŒè¯
    CALL validate_email(p_email, v_is_valid);
    
    IF v_is_valid THEN
        CALL create_user(p_username, p_email, v_user_id);
        -- é‡ç”¨æ—¥å¿—è®°å½•
        CALL log_operation('USER_REGISTER', v_user_id, CONCAT('Username: ', p_username));
    END IF;
END //
```

### 2.3 æ¨¡å—é—´é€šä¿¡è§„èŒƒ


**é€šä¿¡æ–¹å¼**ï¼š
```
ğŸ“ å‚æ•°ä¼ é€’ï¼šæœ€å¸¸ç”¨çš„æ–¹å¼
ğŸ“‹ ä¸´æ—¶è¡¨ï¼šä¼ é€’å¤æ‚æ•°æ®
ğŸ—ƒï¸ ä¼šè¯å˜é‡ï¼šä¼ é€’å…¨å±€çŠ¶æ€
```

```sql
-- ğŸ“ å‚æ•°ä¼ é€’ç¤ºä¾‹
CREATE PROCEDURE calculate_order_total(
    IN p_order_id INT,
    OUT p_total DECIMAL(10,2)
)
BEGIN
    SELECT SUM(price * quantity) INTO p_total
    FROM order_items 
    WHERE order_id = p_order_id;
END //

-- ğŸ“‹ ä¸´æ—¶è¡¨ä¼ é€’å¤æ‚æ•°æ®
CREATE PROCEDURE get_user_permissions(IN p_user_id INT)
BEGIN
    -- åˆ›å»ºä¸´æ—¶è¡¨å­˜å‚¨ç»“æœ
    CREATE TEMPORARY TABLE tmp_permissions (
        permission_name VARCHAR(50),
        resource_type VARCHAR(50)
    );
    
    INSERT INTO tmp_permissions
    SELECT p.name, p.resource_type
    FROM user_roles ur
    JOIN role_permissions rp ON ur.role_id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.id
    WHERE ur.user_id = p_user_id;
END //
```

---

## 3. ğŸ¢ åˆ†å±‚æ¶æ„æ¨¡å¼


### 3.1 ä¸‰å±‚æ¶æ„æ¨¡å¼

åˆ†å±‚æ¶æ„å°±åƒ**å…¬å¸çš„ç»„ç»‡ç»“æ„**ï¼Œä¸åŒå±‚çº§è´Ÿè´£ä¸åŒçš„å·¥ä½œã€‚

```
ğŸ¢ åˆ†å±‚æ¶æ„ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¡¨ç°å±‚ (APIå±‚)     â”‚ â† å¯¹å¤–æ¥å£ï¼Œå‚æ•°éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸šåŠ¡é€»è¾‘å±‚         â”‚ â† æ ¸å¿ƒä¸šåŠ¡è§„åˆ™å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   æ•°æ®è®¿é—®å±‚         â”‚ â† æ•°æ®åº“æ“ä½œï¼ŒCRUD
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¡¨ç°å±‚è®¾è®¡

**èŒè´£**ï¼šå‚æ•°éªŒè¯ã€æƒé™æ£€æŸ¥ã€è°ƒç”¨åè°ƒ

```sql
-- ğŸ“± è¡¨ç°å±‚ï¼šç”¨æˆ·æ³¨å†ŒAPI
CREATE PROCEDURE api_register_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100),
    IN p_password VARCHAR(255),
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_user_id INT DEFAULT 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SET p_result_code = 500;
        SET p_message = 'ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        ROLLBACK;
    END;
    
    START TRANSACTION;
    
    -- å‚æ•°éªŒè¯
    IF p_username IS NULL OR CHAR_LENGTH(p_username) < 3 THEN
        SET p_result_code = 400;
        SET p_message = 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦';
    ELSEIF p_email IS NULL OR p_email NOT REGEXP '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN
        SET p_result_code = 400;
        SET p_message = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
    ELSE
        -- è°ƒç”¨ä¸šåŠ¡å±‚
        CALL biz_create_user(p_username, p_email, p_password, v_user_id, p_result_code, p_message);
    END IF;
    
    IF p_result_code = 200 THEN
        COMMIT;
    ELSE
        ROLLBACK;
    END IF;
END //
```

### 3.3 ä¸šåŠ¡é€»è¾‘å±‚è®¾è®¡

**èŒè´£**ï¼šæ ¸å¿ƒä¸šåŠ¡è§„åˆ™ã€æµç¨‹æ§åˆ¶ã€ä¸šåŠ¡éªŒè¯

```sql
-- ğŸ¢ ä¸šåŠ¡é€»è¾‘å±‚ï¼šç”¨æˆ·åˆ›å»ºä¸šåŠ¡
CREATE PROCEDURE biz_create_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100),
    IN p_password VARCHAR(255),
    OUT p_user_id INT,
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_count INT DEFAULT 0;
    
    -- ä¸šåŠ¡è§„åˆ™æ£€æŸ¥ï¼šç”¨æˆ·åä¸èƒ½é‡å¤
    CALL dal_check_username_exists(p_username, v_count);
    IF v_count > 0 THEN
        SET p_result_code = 409;
        SET p_message = 'ç”¨æˆ·åå·²å­˜åœ¨';
        LEAVE proc_end;
    END IF;
    
    -- ä¸šåŠ¡è§„åˆ™æ£€æŸ¥ï¼šé‚®ç®±ä¸èƒ½é‡å¤
    CALL dal_check_email_exists(p_email, v_count);
    IF v_count > 0 THEN
        SET p_result_code = 409;
        SET p_message = 'é‚®ç®±å·²è¢«æ³¨å†Œ';
        LEAVE proc_end;
    END IF;
    
    -- æ‰§è¡Œç”¨æˆ·åˆ›å»º
    CALL dal_insert_user(p_username, p_email, p_password, p_user_id);
    
    -- åˆ›å»ºé»˜è®¤ç”¨æˆ·è®¾ç½®
    CALL dal_create_user_settings(p_user_id);
    
    SET p_result_code = 200;
    SET p_message = 'æ³¨å†ŒæˆåŠŸ';
    
    proc_end: BEGIN END;
END //
```

### 3.4 æ•°æ®è®¿é—®å±‚è®¾è®¡

**èŒè´£**ï¼šçº¯ç²¹çš„æ•°æ®åº“æ“ä½œï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

```sql
-- ğŸ—„ï¸ æ•°æ®è®¿é—®å±‚ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
CREATE PROCEDURE dal_check_username_exists(
    IN p_username VARCHAR(50),
    OUT p_count INT
)
BEGIN
    SELECT COUNT(*) INTO p_count 
    FROM users 
    WHERE username = p_username;
END //

-- ğŸ—„ï¸ æ•°æ®è®¿é—®å±‚ï¼šæ’å…¥ç”¨æˆ·è®°å½•
CREATE PROCEDURE dal_insert_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100),
    IN p_password VARCHAR(255),
    OUT p_user_id INT
)
BEGIN
    INSERT INTO users (username, email, password_hash, created_at)
    VALUES (p_username, p_email, SHA2(p_password, 256), NOW());
    
    SET p_user_id = LAST_INSERT_ID();
END //

-- ğŸ—„ï¸ æ•°æ®è®¿é—®å±‚ï¼šåˆ›å»ºç”¨æˆ·é»˜è®¤è®¾ç½®
CREATE PROCEDURE dal_create_user_settings(IN p_user_id INT)
BEGIN
    INSERT INTO user_settings (user_id, theme, language, timezone)
    VALUES (p_user_id, 'default', 'zh-CN', 'Asia/Shanghai');
END //
```

---

## 4. ğŸ”Œ æ¥å£è®¾è®¡è§„èŒƒ


### 4.1 å‘½åè§„èŒƒè®¾è®¡

**è§„èŒƒåŸåˆ™**ï¼šè§åçŸ¥æ„ï¼Œç»Ÿä¸€æ ¼å¼

```sql
-- ğŸ“› å‘½åè§„èŒƒç¤ºä¾‹
-- æ ¼å¼ï¼š[å±‚çº§å‰ç¼€]_[åŠ¨ä½œ]_[å¯¹è±¡]

-- APIå±‚ï¼ˆå¯¹å¤–æ¥å£ï¼‰
api_create_user()
api_update_profile()
api_delete_order()

-- ä¸šåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰  
biz_process_payment()
biz_calculate_discount()
biz_validate_order()

-- æ•°æ®å±‚ï¼ˆæ•°æ®æ“ä½œï¼‰
dal_insert_user()
dal_update_order_status()
dal_get_user_by_id()

-- å·¥å…·å±‚ï¼ˆé€šç”¨åŠŸèƒ½ï¼‰
util_validate_email()
util_generate_code()
util_send_notification()
```

### 4.2 å‚æ•°è®¾è®¡è§„èŒƒ


**å‚æ•°è®¾è®¡åŸåˆ™**ï¼š
- **è¾“å…¥å‚æ•°**ï¼šä»¥`p_`å¼€å¤´ï¼Œè¡¨ç¤ºparameter
- **è¾“å‡ºå‚æ•°**ï¼šä»¥`OUT`æ˜ç¡®æ ‡è¯†
- **å±€éƒ¨å˜é‡**ï¼šä»¥`v_`å¼€å¤´ï¼Œè¡¨ç¤ºvariable

```sql
-- ğŸ“‹ æ ‡å‡†å‚æ•°è®¾è®¡
CREATE PROCEDURE api_update_user_profile(
    -- è¾“å…¥å‚æ•°ï¼šä¸šåŠ¡æ•°æ®
    IN p_user_id INT,
    IN p_nickname VARCHAR(50),
    IN p_avatar_url VARCHAR(200),
    
    -- è¾“å‡ºå‚æ•°ï¼šæ‰§è¡Œç»“æœ
    OUT p_result_code INT,
    OUT p_message VARCHAR(200),
    OUT p_affected_rows INT
)
BEGIN
    -- å±€éƒ¨å˜é‡
    DECLARE v_exists_count INT DEFAULT 0;
    DECLARE v_old_nickname VARCHAR(50);
    
    -- å®ç°é€»è¾‘...
END //
```

### 4.3 è¿”å›å€¼æ ‡å‡†åŒ–


**ç»Ÿä¸€çš„è¿”å›ç è®¾è®¡**ï¼š
```sql
-- ğŸ”¢ æ ‡å‡†è¿”å›ç å®šä¹‰
/*
200: æ“ä½œæˆåŠŸ
400: å‚æ•°é”™è¯¯
401: æœªæˆæƒ
403: æƒé™ä¸è¶³
404: èµ„æºä¸å­˜åœ¨
409: æ•°æ®å†²çª
500: ç³»ç»Ÿé”™è¯¯
*/

CREATE PROCEDURE process_with_standard_result(
    IN p_data VARCHAR(100),
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SET p_result_code = 500;
        SET p_message = 'Database error occurred';
    END;
    
    -- å‚æ•°éªŒè¯
    IF p_data IS NULL OR CHAR_LENGTH(p_data) = 0 THEN
        SET p_result_code = 400;
        SET p_message = 'Invalid input parameter';
        LEAVE proc_end;
    END IF;
    
    -- æ­£å¸¸å¤„ç†é€»è¾‘
    -- ... ä¸šåŠ¡ä»£ç  ...
    
    SET p_result_code = 200;
    SET p_message = 'Operation completed successfully';
    
    proc_end: BEGIN END;
END //
```

---

## 5. ğŸ”— ä¾èµ–å…³ç³»ç®¡ç†


### 5.1 ä¾èµ–å…³ç³»åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼šé«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚

```
ğŸ”— ä¾èµ–å…³ç³»å›¾ï¼š
APIå±‚ â”€â”€â”€â”
         â”œâ”€â†’ ä¸šåŠ¡æ¥å£å±‚ â”€â”€â†’ æ•°æ®æ¥å£å±‚
ä¸šåŠ¡å±‚ â”€â”€â”€â”˜                    â†“
                            å…·ä½“æ•°æ®å±‚

ä¸Šå±‚åªä¾èµ–ä¸‹å±‚çš„æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
```

### 5.2 æ¥å£æŠ½è±¡è®¾è®¡


```sql
-- ğŸ­ æŠ½è±¡æ¥å£è®¾è®¡ï¼šç”¨æˆ·æ“ä½œæ¥å£
-- å®šä¹‰æ ‡å‡†çš„ç”¨æˆ·æ“ä½œæ¥å£

-- ç”¨æˆ·æŸ¥è¯¢æ¥å£æ ‡å‡†
CREATE PROCEDURE interface_get_user(
    IN p_user_id INT,
    OUT p_username VARCHAR(50),
    OUT p_email VARCHAR(100),
    OUT p_status VARCHAR(20)
)
BEGIN
    -- è¿™æ˜¯æ¥å£å®šä¹‰ï¼Œå…·ä½“å®ç°å¯ä»¥æœ‰å¤šç§
    CALL dal_get_user_basic_info(p_user_id, p_username, p_email, p_status);
END //

-- å…·ä½“å®ç°1ï¼šä»ä¸»åº“è¯»å–
CREATE PROCEDURE dal_get_user_basic_info(
    IN p_user_id INT,
    OUT p_username VARCHAR(50),
    OUT p_email VARCHAR(100),  
    OUT p_status VARCHAR(20)
)
BEGIN
    SELECT username, email, status 
    INTO p_username, p_email, p_status
    FROM users 
    WHERE id = p_user_id;
END //

-- å…·ä½“å®ç°2ï¼šä»ç¼“å­˜è¯»å–ï¼ˆå¦‚æœéœ€è¦ï¼‰
CREATE PROCEDURE dal_get_user_from_cache(
    IN p_user_id INT,
    OUT p_username VARCHAR(50),
    OUT p_email VARCHAR(100),
    OUT p_status VARCHAR(20)
)
BEGIN
    -- ä»Redisç¼“å­˜è¯»å–ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘
    -- è¿™é‡Œç®€åŒ–æ˜¾ç¤º
    SELECT username, email, status 
    INTO p_username, p_email, p_status
    FROM user_cache 
    WHERE user_id = p_user_id;
END //
```

### 5.3 ä¾èµ–æ³¨å…¥æ¨¡å¼


```sql
-- ğŸ”„ é…ç½®é©±åŠ¨çš„ä¾èµ–ç®¡ç†
CREATE TABLE procedure_config (
    config_key VARCHAR(50) PRIMARY KEY,
    config_value VARCHAR(200),
    description TEXT
);

-- æ’å…¥é…ç½®
INSERT INTO procedure_config VALUES 
('user_data_source', 'dal_get_user_basic_info', 'ç”¨æˆ·æ•°æ®æºé…ç½®'),
('payment_provider', 'dal_alipay_payment', 'æ”¯ä»˜æä¾›å•†é…ç½®');

-- æ ¹æ®é…ç½®è°ƒç”¨ä¸åŒå®ç°
CREATE PROCEDURE biz_get_user_info(
    IN p_user_id INT,
    OUT p_username VARCHAR(50),
    OUT p_email VARCHAR(100)
)
BEGIN
    DECLARE v_data_source VARCHAR(100);
    
    -- è¯»å–é…ç½®å†³å®šä½¿ç”¨å“ªä¸ªæ•°æ®æº
    SELECT config_value INTO v_data_source 
    FROM procedure_config 
    WHERE config_key = 'user_data_source';
    
    -- æ ¹æ®é…ç½®è°ƒç”¨ç›¸åº”çš„å®ç°
    CASE v_data_source
        WHEN 'dal_get_user_basic_info' THEN
            CALL dal_get_user_basic_info(p_user_id, p_username, p_email, @status);
        WHEN 'dal_get_user_from_cache' THEN  
            CALL dal_get_user_from_cache(p_user_id, p_username, p_email, @status);
        ELSE
            CALL dal_get_user_basic_info(p_user_id, p_username, p_email, @status);
    END CASE;
END //
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†æ¶æ„


### 6.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ¨¡å¼

å¼‚å¸¸å¤„ç†å°±åƒ**åŒ»é™¢çš„æ€¥æ•‘ç³»ç»Ÿ**ï¼Œå½“å‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿå¿«é€Ÿå“åº”å’Œå¤„ç†ã€‚

```sql
-- ğŸš¨ å…¨å±€å¼‚å¸¸å¤„ç†æ¨¡æ¿
CREATE PROCEDURE safe_procedure_template(
    IN p_input_param VARCHAR(100),
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_error_code VARCHAR(10) DEFAULT '00000';
    DECLARE v_error_message TEXT DEFAULT '';
    
    -- å£°æ˜å¼‚å¸¸å¤„ç†å™¨
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            v_error_code = MYSQL_ERRNO,
            v_error_message = MESSAGE_TEXT;
            
        -- è®°å½•é”™è¯¯æ—¥å¿—
        CALL log_error('safe_procedure_template', v_error_code, v_error_message, p_input_param);
        
        -- è¿”å›æ ‡å‡†é”™è¯¯ä¿¡æ¯
        SET p_result_code = 500;
        SET p_message = CONCAT('ç³»ç»Ÿé”™è¯¯[', v_error_code, ']');
        
        ROLLBACK;
    END;
    
    START TRANSACTION;
    
    -- ä¸šåŠ¡é€»è¾‘
    IF p_input_param IS NULL THEN
        SET p_result_code = 400;
        SET p_message = 'å‚æ•°ä¸èƒ½ä¸ºç©º';
    ELSE
        -- æ­£å¸¸å¤„ç†é€»è¾‘
        SET p_result_code = 200;
        SET p_message = 'æ“ä½œæˆåŠŸ';
    END IF;
    
    COMMIT;
END //
```

### 6.2 åˆ†çº§å¼‚å¸¸å¤„ç†


```sql
-- ğŸ¯ åˆ†çº§å¼‚å¸¸å¤„ç†ï¼šä¸šåŠ¡å¼‚å¸¸ vs ç³»ç»Ÿå¼‚å¸¸
CREATE PROCEDURE handle_user_login(
    IN p_username VARCHAR(50),
    IN p_password VARCHAR(255),
    OUT p_result_code INT,
    OUT p_message VARCHAR(200),
    OUT p_user_id INT
)
BEGIN
    DECLARE v_stored_password VARCHAR(255);
    DECLARE v_user_status VARCHAR(20);
    DECLARE v_login_attempts INT DEFAULT 0;
    
    -- ç³»ç»Ÿå¼‚å¸¸å¤„ç†
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SET p_result_code = 500;
        SET p_message = 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•';
        CALL log_system_error('handle_user_login', 'SQL_EXCEPTION', p_username);
    END;
    
    -- ä¸šåŠ¡é€»è¾‘å¤„ç†
    SELECT id, password_hash, status, login_attempts
    INTO p_user_id, v_stored_password, v_user_status, v_login_attempts
    FROM users 
    WHERE username = p_username;
    
    -- ä¸šåŠ¡å¼‚å¸¸ï¼šç”¨æˆ·ä¸å­˜åœ¨
    IF p_user_id IS NULL THEN
        SET p_result_code = 404;
        SET p_message = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        CALL log_business_event('LOGIN_FAILED', 'USER_NOT_FOUND', p_username);
        LEAVE proc_end;
    END IF;
    
    -- ä¸šåŠ¡å¼‚å¸¸ï¼šè´¦æˆ·è¢«é”å®š
    IF v_user_status = 'LOCKED' THEN
        SET p_result_code = 403;
        SET p_message = 'è´¦æˆ·å·²è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
        CALL log_business_event('LOGIN_FAILED', 'ACCOUNT_LOCKED', p_username);
        LEAVE proc_end;
    END IF;
    
    -- ä¸šåŠ¡å¼‚å¸¸ï¼šå¯†ç é”™è¯¯
    IF SHA2(p_password, 256) != v_stored_password THEN
        SET p_result_code = 401;
        SET p_message = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
        
        -- æ›´æ–°å¤±è´¥æ¬¡æ•°
        UPDATE users SET login_attempts = login_attempts + 1 WHERE id = p_user_id;
        
        CALL log_business_event('LOGIN_FAILED', 'WRONG_PASSWORD', p_username);
        LEAVE proc_end;
    END IF;
    
    -- ç™»å½•æˆåŠŸ
    SET p_result_code = 200;
    SET p_message = 'ç™»å½•æˆåŠŸ';
    UPDATE users SET login_attempts = 0, last_login = NOW() WHERE id = p_user_id;
    
    proc_end: BEGIN END;
END //
```

### 6.3 é”™è¯¯æ¢å¤æœºåˆ¶


```sql
-- ğŸ”„ è‡ªåŠ¨é‡è¯•æœºåˆ¶
CREATE PROCEDURE retry_safe_operation(
    IN p_operation_type VARCHAR(50),
    IN p_data JSON,
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_retry_count INT DEFAULT 0;
    DECLARE v_max_retries INT DEFAULT 3;
    DECLARE v_success BOOLEAN DEFAULT FALSE;
    
    retry_loop: LOOP
        SET v_retry_count = v_retry_count + 1;
        
        BEGIN
            DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
            BEGIN
                -- å¦‚æœæ˜¯å¯é‡è¯•çš„é”™è¯¯ï¼ˆå¦‚æ­»é”ï¼‰ï¼Œç»§ç»­é‡è¯•
                IF v_retry_count < v_max_retries THEN
                    -- ç­‰å¾…éšæœºæ—¶é—´å†é‡è¯•
                    DO SLEEP(RAND() * 0.1);
                    ITERATE retry_loop;
                ELSE
                    -- é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œè¿”å›å¤±è´¥
                    SET p_result_code = 500;
                    SET p_message = 'æ“ä½œå¤±è´¥ï¼Œå·²é‡è¯•å¤šæ¬¡';
                    LEAVE retry_loop;
                END IF;
            END;
            
            -- æ‰§è¡Œå®é™…æ“ä½œ
            CASE p_operation_type
                WHEN 'UPDATE_INVENTORY' THEN
                    CALL dal_update_inventory(p_data);
                WHEN 'PROCESS_PAYMENT' THEN
                    CALL dal_process_payment(p_data);
                ELSE
                    SET p_result_code = 400;
                    SET p_message = 'ä¸æ”¯æŒçš„æ“ä½œç±»å‹';
                    LEAVE retry_loop;
            END CASE;
            
            -- æ“ä½œæˆåŠŸ
            SET v_success = TRUE;
            SET p_result_code = 200;
            SET p_message = 'æ“ä½œæˆåŠŸ';
            LEAVE retry_loop;
        END;
    END LOOP;
    
    -- è®°å½•é‡è¯•æƒ…å†µ
    IF v_success THEN
        CALL log_retry_success(p_operation_type, v_retry_count);
    ELSE
        CALL log_retry_failed(p_operation_type, v_retry_count);
    END IF;
END //
```

---

## 7. ğŸ“ æ—¥å¿—è®°å½•æ¶æ„


### 7.1 åˆ†çº§æ—¥å¿—ç³»ç»Ÿ

æ—¥å¿—ç³»ç»Ÿå°±åƒ**é£æœºçš„é»‘åŒ£å­**ï¼Œè®°å½•ç³»ç»Ÿè¿è¡Œçš„å…³é”®ä¿¡æ¯ã€‚

```sql
-- ğŸ“Š æ—¥å¿—çº§åˆ«å®šä¹‰
CREATE TABLE log_levels (
    level_id INT PRIMARY KEY,
    level_name VARCHAR(20),
    description VARCHAR(100)
);

INSERT INTO log_levels VALUES
(1, 'DEBUG', 'è°ƒè¯•ä¿¡æ¯'),
(2, 'INFO', 'ä¸€èˆ¬ä¿¡æ¯'),  
(3, 'WARN', 'è­¦å‘Šä¿¡æ¯'),
(4, 'ERROR', 'é”™è¯¯ä¿¡æ¯'),
(5, 'FATAL', 'è‡´å‘½é”™è¯¯');

-- ğŸ“‹ ç»Ÿä¸€æ—¥å¿—è¡¨ç»“æ„
CREATE TABLE system_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    log_level INT,
    category VARCHAR(50),
    procedure_name VARCHAR(100),
    message TEXT,
    details JSON,
    user_id INT,
    session_id VARCHAR(50),
    ip_address VARCHAR(45),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_level_time (log_level, created_at),
    INDEX idx_procedure (procedure_name),
    INDEX idx_user (user_id)
);
```

### 7.2 é€šç”¨æ—¥å¿—è®°å½•æ¥å£


```sql
-- ğŸ“ é€šç”¨æ—¥å¿—è®°å½•è¿‡ç¨‹
CREATE PROCEDURE write_log(
    IN p_level INT,
    IN p_category VARCHAR(50),
    IN p_procedure_name VARCHAR(100),
    IN p_message TEXT,
    IN p_details JSON,
    IN p_user_id INT
)
BEGIN
    DECLARE v_session_id VARCHAR(50);
    DECLARE v_ip_address VARCHAR(45);
    
    -- è·å–ä¼šè¯ä¿¡æ¯
    SET v_session_id = IFNULL(@session_id, 'UNKNOWN');
    SET v_ip_address = IFNULL(@client_ip, 'UNKNOWN');
    
    INSERT INTO system_logs (
        log_level, category, procedure_name, 
        message, details, user_id, 
        session_id, ip_address
    ) VALUES (
        p_level, p_category, p_procedure_name,
        p_message, p_details, p_user_id,
        v_session_id, v_ip_address
    );
END //

-- ğŸ¯ ä¾¿æ·çš„æ—¥å¿—è®°å½•æ¥å£
CREATE PROCEDURE log_info(
    IN p_procedure VARCHAR(100),
    IN p_message TEXT,
    IN p_details JSON
)
BEGIN
    CALL write_log(2, 'INFO', p_procedure, p_message, p_details, @current_user_id);
END //

CREATE PROCEDURE log_error(
    IN p_procedure VARCHAR(100),
    IN p_message TEXT,
    IN p_details JSON
)
BEGIN
    CALL write_log(4, 'ERROR', p_procedure, p_message, p_details, @current_user_id);
END //

CREATE PROCEDURE log_business_event(
    IN p_event_type VARCHAR(50),
    IN p_message TEXT,
    IN p_details JSON
)
BEGIN
    CALL write_log(2, 'BUSINESS', 'BUSINESS_EVENT', 
                   CONCAT(p_event_type, ': ', p_message), p_details, @current_user_id);
END //
```

### 7.3 æ€§èƒ½ç›‘æ§æ—¥å¿—


```sql
-- â±ï¸ æ€§èƒ½ç›‘æ§æ—¥å¿—
CREATE TABLE performance_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    procedure_name VARCHAR(100),
    execution_time_ms INT,
    input_params JSON,
    rows_affected INT,
    memory_used_kb INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_procedure_time (procedure_name, execution_time_ms),
    INDEX idx_created_at (created_at)
);

-- æ€§èƒ½ç›‘æ§è£…é¥°å™¨æ¨¡å¼
CREATE PROCEDURE monitor_performance(
    IN p_procedure_name VARCHAR(100),
    IN p_input_params JSON,
    OUT p_execution_time_ms INT
)
BEGIN
    DECLARE v_start_time BIGINT;
    DECLARE v_end_time BIGINT;
    DECLARE v_rows_affected INT;
    
    -- è®°å½•å¼€å§‹æ—¶é—´ï¼ˆå¾®ç§’ï¼‰
    SET v_start_time = UNIX_TIMESTAMP(NOW(6)) * 1000000 + MICROSECOND(NOW(6));
    
    -- è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„å­˜å‚¨è¿‡ç¨‹
    -- CALL actual_procedure(params...);
    
    -- è®°å½•ç»“æŸæ—¶é—´
    SET v_end_time = UNIX_TIMESTAMP(NOW(6)) * 1000000 + MICROSECOND(NOW(6));
    SET p_execution_time_ms = (v_end_time - v_start_time) / 1000;
    
    -- è·å–å½±å“è¡Œæ•°
    SET v_rows_affected = ROW_COUNT();
    
    -- è®°å½•æ€§èƒ½æ—¥å¿—
    INSERT INTO performance_logs (
        procedure_name, execution_time_ms, 
        input_params, rows_affected
    ) VALUES (
        p_procedure_name, p_execution_time_ms,
        p_input_params, v_rows_affected
    );
    
    -- å¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè®°å½•è­¦å‘Š
    IF p_execution_time_ms > 1000 THEN
        CALL log_warn('PERFORMANCE', 
                     CONCAT('Slow procedure: ', p_procedure_name, ' took ', p_execution_time_ms, 'ms'),
                     p_input_params);
    END IF;
END //
```

---

## 8. âš™ï¸ é…ç½®ç®¡ç†ç­–ç•¥


### 8.1 é…ç½®ä¸­å¿ƒè®¾è®¡

é…ç½®ç®¡ç†å°±åƒ**é¥æ§å™¨**ï¼Œå¯ä»¥éšæ—¶è°ƒæ•´ç³»ç»Ÿçš„è¡Œä¸ºè€Œä¸éœ€è¦é‡å¯ã€‚

```sql
-- ğŸ›ï¸ é…ç½®ç®¡ç†è¡¨è®¾è®¡
CREATE TABLE system_config (
    config_key VARCHAR(100) PRIMARY KEY,
    config_value TEXT,
    data_type ENUM('STRING', 'INT', 'DECIMAL', 'BOOLEAN', 'JSON'),
    category VARCHAR(50),
    description TEXT,
    is_encrypted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_category (category)
);

-- æ’å…¥åŸºç¡€é…ç½®
INSERT INTO system_config VALUES
('email.smtp.host', 'smtp.example.com', 'STRING', 'EMAIL', 'é‚®ä»¶æœåŠ¡å™¨åœ°å€', FALSE, NOW(), NOW()),
('email.max_retries', '3', 'INT', 'EMAIL', 'é‚®ä»¶å‘é€æœ€å¤§é‡è¯•æ¬¡æ•°', FALSE, NOW(), NOW()),
('order.auto_cancel_hours', '24', 'INT', 'ORDER', 'è®¢å•è‡ªåŠ¨å–æ¶ˆæ—¶é—´(å°æ—¶)', FALSE, NOW(), NOW()),
('payment.timeout_seconds', '300', 'INT', 'PAYMENT', 'æ”¯ä»˜è¶…æ—¶æ—¶é—´(ç§’)', FALSE, NOW(), NOW()),
('system.maintenance_mode', 'false', 'BOOLEAN', 'SYSTEM', 'ç³»ç»Ÿç»´æŠ¤æ¨¡å¼', FALSE, NOW(), NOW());
```

### 8.2 é…ç½®è¯»å–æ¥å£


```sql
-- ğŸ“– é€šç”¨é…ç½®è¯»å–æ¥å£
CREATE PROCEDURE get_config(
    IN p_config_key VARCHAR(100),
    OUT p_value TEXT,
    OUT p_data_type VARCHAR(20)
)
BEGIN
    SELECT config_value, data_type 
    INTO p_value, p_data_type
    FROM system_config 
    WHERE config_key = p_config_key;
    
    -- å¦‚æœé…ç½®ä¸å­˜åœ¨ï¼Œè®°å½•è­¦å‘Š
    IF p_value IS NULL THEN
        CALL log_warn('CONFIG', 
                     CONCAT('Configuration not found: ', p_config_key), 
                     JSON_OBJECT('config_key', p_config_key));
    END IF;
END //

-- ğŸ¯ ç±»å‹å®‰å…¨çš„é…ç½®è¯»å–
CREATE PROCEDURE get_config_int(
    IN p_config_key VARCHAR(100),
    IN p_default_value INT,
    OUT p_value INT
)
BEGIN
    DECLARE v_str_value TEXT;
    DECLARE v_data_type VARCHAR(20);
    
    CALL get_config(p_config_key, v_str_value, v_data_type);
    
    IF v_str_value IS NULL THEN
        SET p_value = p_default_value;
    ELSEIF v_data_type = 'INT' THEN
        SET p_value = CAST(v_str_value AS SIGNED);
    ELSE
        SET p_value = p_default_value;
        CALL log_warn('CONFIG', 
                     CONCAT('Configuration type mismatch: ', p_config_key, ' expected INT but got ', v_data_type),
                     JSON_OBJECT('config_key', p_config_key, 'expected_type', 'INT', 'actual_type', v_data_type));
    END IF;
END //

CREATE PROCEDURE get_config_boolean(
    IN p_config_key VARCHAR(100),
    IN p_default_value BOOLEAN,
    OUT p_value BOOLEAN
)
BEGIN
    DECLARE v_str_value TEXT;
    DECLARE v_data_type VARCHAR(20);
    
    CALL get_config(p_config_key, v_str_value, v_data_type);
    
    IF v_str_value IS NULL THEN
        SET p_value = p_default_value;
    ELSEIF v_data_type = 'BOOLEAN' THEN
        SET p_value = (LOWER(v_str_value) IN ('true', '1', 'yes', 'on'));
    ELSE
        SET p_value = p_default_value;
    END IF;
END //
```

### 8.3 åŠ¨æ€é…ç½®åº”ç”¨


```sql
-- ğŸ”„ é…ç½®é©±åŠ¨çš„ä¸šåŠ¡é€»è¾‘
CREATE PROCEDURE process_order_with_config(
    IN p_order_id INT,
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_auto_cancel_hours INT;
    DECLARE v_payment_timeout INT;
    DECLARE v_maintenance_mode BOOLEAN;
    DECLARE v_order_created_at TIMESTAMP;
    
    -- è¯»å–é…ç½®
    CALL get_config_boolean('system.maintenance_mode', FALSE, v_maintenance_mode);
    
    -- æ£€æŸ¥ç»´æŠ¤æ¨¡å¼
    IF v_maintenance_mode THEN
        SET p_result_code = 503;
        SET p_message = 'ç³»ç»Ÿç»´æŠ¤ä¸­ï¼Œæš‚æ—¶æ— æ³•å¤„ç†è®¢å•';
        LEAVE proc_end;
    END IF;
    
    -- è¯»å–è®¢å•é…ç½®
    CALL get_config_int('order.auto_cancel_hours', 24, v_auto_cancel_hours);
    CALL get_config_int('payment.timeout_seconds', 300, v_payment_timeout);
    
    -- æ£€æŸ¥è®¢å•æ˜¯å¦è¶…æ—¶
    SELECT created_at INTO v_order_created_at
    FROM orders WHERE id = p_order_id;
    
    IF TIMESTAMPDIFF(HOUR, v_order_created_at, NOW()) > v_auto_cancel_hours THEN
        UPDATE orders SET status = 'AUTO_CANCELED' WHERE id = p_order_id;
        SET p_result_code = 409;
        SET p_message = 'è®¢å•å·²è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ';
        LEAVE proc_end;
    END IF;
    
    -- æ­£å¸¸å¤„ç†è®¢å•
    SET p_result_code = 200;
    SET p_message = 'è®¢å•å¤„ç†æˆåŠŸ';
    
    proc_end: BEGIN END;
END //
```

### 8.4 é…ç½®çƒ­æ›´æ–°æœºåˆ¶


```sql
-- ğŸ”¥ é…ç½®çƒ­æ›´æ–°é€šçŸ¥
CREATE TABLE config_change_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100),
    old_value TEXT,
    new_value TEXT,
    changed_by VARCHAR(50),
    change_reason TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é…ç½®æ›´æ–°è¿‡ç¨‹
CREATE PROCEDURE update_config(
    IN p_config_key VARCHAR(100),
    IN p_new_value TEXT,
    IN p_changed_by VARCHAR(50),
    IN p_reason TEXT,
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_old_value TEXT;
    DECLARE v_exists BOOLEAN DEFAULT FALSE;
    
    -- æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
    SELECT config_value INTO v_old_value
    FROM system_config 
    WHERE config_key = p_config_key;
    
    SET v_exists = (v_old_value IS NOT NULL);
    
    IF NOT v_exists THEN
        SET p_result_code = 404;
        SET p_message = 'é…ç½®é¡¹ä¸å­˜åœ¨';
        LEAVE proc_end;
    END IF;
    
    -- æ›´æ–°é…ç½®
    UPDATE system_config 
    SET config_value = p_new_value, updated_at = NOW()
    WHERE config_key = p_config_key;
    
    -- è®°å½•å˜æ›´æ—¥å¿—
    INSERT INTO config_change_log (config_key, old_value, new_value, changed_by, change_reason)
    VALUES (p_config_key, v_old_value, p_new_value, p_changed_by, p_reason);
    
    -- è®°å½•ç³»ç»Ÿæ—¥å¿—
    CALL log_info('CONFIG_UPDATE', 
                  CONCAT('Configuration updated: ', p_config_key),
                  JSON_OBJECT('key', p_config_key, 'old_value', v_old_value, 'new_value', p_new_value, 'changed_by', p_changed_by));
    
    SET p_result_code = 200;
    SET p_message = 'é…ç½®æ›´æ–°æˆåŠŸ';
    
    proc_end: BEGIN END;
END //
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ¶æ„åŸåˆ™


> ğŸ“Œ **æ ¸å¿ƒç†å¿µ**  
> å­˜å‚¨è¿‡ç¨‹æ¶æ„è®¾è®¡çš„æœ¬è´¨æ˜¯**åˆ†å·¥åˆä½œ**ï¼Œè®©æ¯ä¸ªæ¨¡å—ä¸“æ³¨åšå¥½è‡ªå·±çš„äº‹æƒ…ï¼Œé€šè¿‡æ ‡å‡†åŒ–çš„æ¥å£è¿›è¡Œåä½œã€‚

**ğŸ¯ å…­å¤§è®¾è®¡åŸåˆ™**ï¼š
1. **å•ä¸€èŒè´£**ï¼šä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **åˆ†å±‚æ¶æ„**ï¼šAPIå±‚ã€ä¸šåŠ¡å±‚ã€æ•°æ®å±‚å„å¸å…¶èŒ  
3. **æ¥å£æ ‡å‡†**ï¼šç»Ÿä¸€çš„å‘½åè§„èŒƒå’Œå‚æ•°è®¾è®¡
4. **ä¾èµ–ç®¡ç†**ï¼šé«˜å±‚ä¸ä¾èµ–ä½å±‚å…·ä½“å®ç°
5. **å¼‚å¸¸å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
6. **é…ç½®ç®¡ç†**ï¼šé€šè¿‡é…ç½®æ§åˆ¶è¡Œä¸ºï¼Œæ”¯æŒçƒ­æ›´æ–°

### 9.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ æ¨¡å—åŒ–è®¾è®¡**ï¼š
```
âŒ é¿å…ï¼šä¸€ä¸ª1000è¡Œçš„è¶…å¤§å­˜å‚¨è¿‡ç¨‹
âœ… æ¨èï¼š10ä¸ª100è¡Œçš„ä¸“é—¨åŒ–å­˜å‚¨è¿‡ç¨‹
```

**ğŸ”¹ æ¥å£è®¾è®¡**ï¼š
```
âœ… å¥½çš„å‘½åï¼šapi_create_user(), biz_validate_order(), dal_update_status()
âŒ åçš„å‘½åï¼šproc1(), user_stuff(), do_something()
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†**ï¼š
```
âœ… ç»Ÿä¸€å¤„ç†ï¼šæ ‡å‡†é”™è¯¯ç  + è¯¦ç»†æ—¥å¿— + è‡ªåŠ¨é‡è¯•
âŒ æ··ä¹±å¤„ç†ï¼šå„è‡ªä¸ºæ”¿ï¼Œé”™è¯¯ä¿¡æ¯ä¸ä¸€è‡´
```

### 9.3 æ¶æ„æ¼”è¿›å»ºè®®


**ğŸŒ± èµ·æ­¥é˜¶æ®µ**ï¼š
- å»ºç«‹åŸºæœ¬çš„åˆ†å±‚ç»“æ„
- å®šä¹‰å‘½åè§„èŒƒå’Œæ¥å£æ ‡å‡†
- å®ç°ç®€å•çš„æ—¥å¿—è®°å½•

**ğŸŒ¿ æˆé•¿é˜¶æ®µ**ï¼š  
- å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶
- å¼•å…¥é…ç½®ç®¡ç†
- å¢åŠ æ€§èƒ½ç›‘æ§

**ğŸŒ³ æˆç†Ÿé˜¶æ®µ**ï¼š
- å®ç°ä¾èµ–æ³¨å…¥
- æ”¯æŒå¤šç§æ•°æ®æº
- å®Œæ•´çš„ç›‘æ§å’Œæ²»ç†ä½“ç³»

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ å¸¸è§é—®é¢˜**ï¼š
- **è¿‡åº¦è®¾è®¡**ï¼šä¸ºç®€å•åŠŸèƒ½è®¾è®¡å¤æ‚æ¶æ„
- **å±‚æ¬¡æ··ä¹±**ï¼šä¸šåŠ¡é€»è¾‘æ•£å¸ƒåœ¨å„å±‚
- **æ¥å£ä¸ç»Ÿä¸€**ï¼šæ¯ä¸ªå¼€å‘äººå‘˜æœ‰è‡ªå·±çš„é£æ ¼
- **ç¼ºä¹ç›‘æ§**ï¼šå‡ºé—®é¢˜æ—¶éš¾ä»¥å®šä½

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
- **æ¸è¿›å¼è®¾è®¡**ï¼šä»ç®€å•å¼€å§‹ï¼Œé€æ­¥å®Œå–„
- **ä»£ç å®¡æŸ¥**ï¼šç¡®ä¿å±‚æ¬¡æ¸…æ™°ï¼ŒèŒè´£æ˜ç¡®
- **è‡ªåŠ¨åŒ–å·¥å…·**ï¼šç”Ÿæˆæ ‡å‡†æ¥å£æ¨¡æ¿
- **ç›‘æ§å…ˆè¡Œ**ï¼šä»ä¸€å¼€å§‹å°±åŠ å…¥æ—¥å¿—å’Œç›‘æ§

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ¶æ„è®¾è®¡å¦‚ç›–æˆ¿å­ï¼Œå…ˆæœ‰å›¾çº¸å†æ–½å·¥
- åˆ†å±‚æ¶æ„å¦‚å…¬å¸ç»„ç»‡ï¼Œå„å¸å…¶èŒåä½œé«˜æ•ˆ  
- æ¥å£æ ‡å‡†å¦‚äº¤é€šè§„åˆ™ï¼Œç»Ÿä¸€è§„èŒƒå‡å°‘æ··ä¹±
- é…ç½®ç®¡ç†å¦‚é¥æ§å™¨ï¼ŒåŠ¨æ€è°ƒæ•´ç³»ç»Ÿè¡Œä¸º