---
title: 6ã€UDFç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°
---
## ğŸ“š ç›®å½•

1. [UDFåŸºç¡€æ¦‚å¿µ](#1-UDFåŸºç¡€æ¦‚å¿µ)
2. [å¼€å‘ç¯å¢ƒæ­å»º](#2-å¼€å‘ç¯å¢ƒæ­å»º)
3. [å‡½æ•°æ¥å£å®šä¹‰](#3-å‡½æ•°æ¥å£å®šä¹‰)
4. [C/C++å®ç°å¼€å‘](#4-C-C++å®ç°å¼€å‘)
5. [ç¼–è¯‘å®‰è£…éƒ¨ç½²](#5-ç¼–è¯‘å®‰è£…éƒ¨ç½²)
6. [å†…å­˜ç®¡ç†ç­–ç•¥](#6-å†…å­˜ç®¡ç†ç­–ç•¥)
7. [çº¿ç¨‹å®‰å…¨è®¾è®¡](#7-çº¿ç¨‹å®‰å…¨è®¾è®¡)
8. [UDF APIæ¥å£è§„èŒƒ](#8-UDF-APIæ¥å£è§„èŒƒ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ UDFåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯UDF

**UDFï¼ˆUser Defined Functionï¼‰** å°±æ˜¯ç”¨æˆ·è‡ªå·±ç¼–å†™çš„å‡½æ•°ï¼Œå¯ä»¥åœ¨MySQLçš„SQLè¯­å¥ä¸­ç›´æ¥è°ƒç”¨ã€‚

**ç®€å•ç†è§£**ï¼š
- **å†…ç½®å‡½æ•°**ï¼šMySQLè‡ªå¸¦çš„å‡½æ•°ï¼Œå¦‚ `SUM()`ã€`COUNT()`
- **UDFå‡½æ•°**ï¼šä½ è‡ªå·±ç”¨C/C++å†™çš„å‡½æ•°ï¼Œç¼–è¯‘åè®©MySQLèƒ½ä½¿ç”¨

```
ä¼ ç»Ÿæ–¹å¼ï¼š               UDFæ–¹å¼ï¼š
SELECT COUNT(*)         SELECT my_custom_count(*)
FROM table;            FROM table;
    â†“                      â†“
ä½¿ç”¨MySQLå†…ç½®å‡½æ•°        ä½¿ç”¨ä½ è‡ªå·±å†™çš„å‡½æ•°
```

### 1.2 UDFçš„åº”ç”¨åœºæ™¯

**ä»€ä¹ˆæ—¶å€™éœ€è¦å†™UDFï¼Ÿ**

> ğŸ’¡ **æ ¸å¿ƒåœºæ™¯**ï¼šå½“MySQLå†…ç½®å‡½æ•°æ— æ³•æ»¡è¶³ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚æ—¶

```
å¸¸è§åº”ç”¨ï¼š
ğŸ”¸ å¤æ‚æ•°å­¦è®¡ç®—ï¼šç‰¹æ®Šçš„ç»Ÿè®¡ç®—æ³•
ğŸ”¸ å­—ç¬¦ä¸²å¤„ç†ï¼šè‡ªå®šä¹‰çš„æ–‡æœ¬åˆ†æ
ğŸ”¸ æ•°æ®åŠ å¯†ï¼šç‰¹å®šçš„åŠ å¯†ç®—æ³•
ğŸ”¸ å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ï¼šè®¿é—®å…¶ä»–æœåŠ¡æ¥å£
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç”¨C/C++æ›¿ä»£å¤æ‚çš„SQLé€»è¾‘
```

### 1.3 UDFç±»å‹åˆ†ç±»

```
æŒ‰è¿”å›å€¼åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡é‡å‡½æ•°       â”‚ â† è¿”å›å•ä¸ªå€¼ï¼Œå¦‚å­—ç¬¦ä¸²ã€æ•°å­—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èšåˆå‡½æ•°       â”‚ â† ç±»ä¼¼SUM()ï¼Œå¤„ç†å¤šè¡Œæ•°æ®è¿”å›ä¸€ä¸ªç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‰å®ç°è¯­è¨€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cè¯­è¨€UDF      â”‚ â† æ€§èƒ½æœ€é«˜ï¼Œæœ€å¸¸ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  C++è¯­è¨€UDF    â”‚ â† é¢å‘å¯¹è±¡ï¼ŒåŠŸèƒ½æ›´å¼º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ å¼€å‘ç¯å¢ƒæ­å»º


### 2.1 å¿…è¦çš„è½¯ä»¶ç¯å¢ƒ

å¼€å‘UDFéœ€è¦å‡†å¤‡è¿™äº›å·¥å…·ï¼š

```bash
# Linuxç¯å¢ƒä¸‹å®‰è£…å¼€å‘å·¥å…·
# CentOS/RHELç³»ç»Ÿ
yum install gcc gcc-c++ make

# Ubuntu/Debianç³»ç»Ÿ  
apt-get install build-essential

# MySQLå¼€å‘åº“ï¼ˆé‡è¦ï¼ï¼‰
yum install mysql-devel
# æˆ–è€…
apt-get install libmysqlclient-dev
```

> âš ï¸ **é‡è¦æé†’**ï¼šå¿…é¡»å®‰è£…MySQLå¼€å‘åº“ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘UDF

### 2.2 è·å–MySQLå¤´æ–‡ä»¶

**ä¸ºä»€ä¹ˆéœ€è¦å¤´æ–‡ä»¶ï¼Ÿ**
å› ä¸ºUDFè¦è°ƒç”¨MySQLçš„APIæ¥å£ï¼Œéœ€è¦çŸ¥é“è¿™äº›æ¥å£çš„å®šä¹‰ã€‚

```bash
# æ–¹æ³•1ï¼šé€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…
yum install mysql-devel

# æ–¹æ³•2ï¼šä»MySQLæºç è·å–
# ä¸‹è½½MySQLæºç åŒ…ï¼Œå¤´æ–‡ä»¶åœ¨includeç›®å½•

# æ£€æŸ¥å¤´æ–‡ä»¶æ˜¯å¦å­˜åœ¨
find /usr -name "mysql.h" 2>/dev/null
# åº”è¯¥èƒ½æ‰¾åˆ°ç±»ä¼¼ï¼š/usr/include/mysql/mysql.h
```

### 2.3 å¼€å‘ç›®å½•ç»“æ„

å»ºè®®åˆ›å»ºè¿™æ ·çš„ç›®å½•ç»“æ„ï¼š

```
udf_project/
â”œâ”€â”€ src/                 â† æºä»£ç æ–‡ä»¶
â”‚   â”œâ”€â”€ my_function.c
â”‚   â””â”€â”€ Makefile
â”œâ”€â”€ include/            â† å¤´æ–‡ä»¶ï¼ˆå¦‚æœæœ‰è‡ªå®šä¹‰çš„ï¼‰
â””â”€â”€ lib/                â† ç¼–è¯‘åçš„åŠ¨æ€åº“
    â””â”€â”€ my_function.so
```

---

## 3. ğŸ“‹ å‡½æ•°æ¥å£å®šä¹‰


### 3.1 UDFå‡½æ•°çš„åŸºæœ¬ç»“æ„

æ¯ä¸ªUDFå‡½æ•°éƒ½éœ€è¦å®ç°å‡ ä¸ªå›ºå®šçš„æ¥å£ï¼š

```c
// ä¸»å‡½æ•°ï¼šå®é™…çš„è®¡ç®—é€»è¾‘
long long my_function(UDF_INIT *initid, UDF_ARGS *args, 
                      char *is_null, char *error);

// åˆå§‹åŒ–å‡½æ•°ï¼šæ£€æŸ¥å‚æ•°ï¼Œåˆ†é…å†…å­˜
my_bool my_function_init(UDF_INIT *initid, UDF_ARGS *args, 
                         char *message);

// æ¸…ç†å‡½æ•°ï¼šé‡Šæ”¾èµ„æº
void my_function_deinit(UDF_INIT *initid);
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼š
> - **ä¸»å‡½æ•°**ï¼šå¹²æ´»çš„ï¼Œå®ç°å…·ä½“åŠŸèƒ½
> - **åˆå§‹åŒ–**ï¼šå¼€å·¥å‰çš„å‡†å¤‡ï¼Œæ£€æŸ¥å·¥å…·æ˜¯å¦é½å…¨
> - **æ¸…ç†å‡½æ•°**ï¼šæ”¶å·¥åçš„æ¸…ç†ï¼Œé¿å…ç•™ä¸‹åƒåœ¾

### 3.2 å‡½æ•°å‘½åè§„èŒƒ

**é‡è¦è§„åˆ™**ï¼šä¸‰ä¸ªå‡½æ•°çš„å‘½åå¿…é¡»éµå¾ªå›ºå®šæ¨¡å¼

```c
// å¦‚æœä¸»å‡½æ•°å« calculate_sum
long long calculate_sum(...);              // ä¸»å‡½æ•°
my_bool calculate_sum_init(...);          // åˆå§‹åŒ–ï¼šä¸»å‡½æ•°å + _init
void calculate_sum_deinit(...);           // æ¸…ç†ï¼šä¸»å‡½æ•°å + _deinit
```

> âš ï¸ **æ³¨æ„**ï¼šå‘½åä¸è§„èŒƒï¼ŒMySQLæ‰¾ä¸åˆ°å‡½æ•°ä¼šæŠ¥é”™

### 3.3 å‚æ•°å’Œè¿”å›å€¼ç±»å‹

**UDFæ”¯æŒçš„æ•°æ®ç±»å‹**ï¼š

| MySQLç±»å‹ | Cè¯­è¨€ç±»å‹ | è¯´æ˜ |
|-----------|-----------|------|
| `INT` | `long long` | æ•´æ•°ç±»å‹ |
| `REAL` | `double` | æµ®ç‚¹æ•°ç±»å‹ |
| `STRING` | `char*` | å­—ç¬¦ä¸²ç±»å‹ |

```c
// è¿”å›æ•´æ•°çš„å‡½æ•°
long long my_int_func(UDF_INIT *initid, UDF_ARGS *args, 
                      char *is_null, char *error);

// è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°  
char* my_string_func(UDF_INIT *initid, UDF_ARGS *args,
                     char *result, unsigned long *length,
                     char *is_null, char *error);
```

---

## 4. ğŸ”§ C/C++å®ç°å¼€å‘


### 4.1 ç®€å•æ•´æ•°å‡½æ•°ç¤ºä¾‹

è®©æˆ‘ä»¬å†™ä¸€ä¸ªè®¡ç®—ä¸¤ä¸ªæ•°å­—ç›¸åŠ çš„UDFå‡½æ•°ï¼š

```c
#include <mysql.h>
#include <string.h>

// ä¸»å‡½æ•°ï¼šè®¡ç®—ä¸¤ä¸ªæ•´æ•°çš„å’Œ
long long my_add_init(UDF_INIT *initid, UDF_ARGS *args, 
                      char *is_null, char *error) {
    // æ£€æŸ¥å‚æ•°ä¸ªæ•°
    if (args->arg_count != 2) {
        strcpy(error, "my_add() requires exactly 2 arguments");
        return 1;
    }
    
    // æ£€æŸ¥å‚æ•°ç±»å‹
    if (args->arg_type[0] != INT_RESULT || 
        args->arg_type[1] != INT_RESULT) {
        strcpy(error, "my_add() requires integer arguments");
        return 1;
    }
    
    return 0;
}

// å®é™…è®¡ç®—å‡½æ•°
long long my_add(UDF_INIT *initid, UDF_ARGS *args,
                 char *is_null, char *error) {
    long long a = *((long long*) args->args[0]);
    long long b = *((long long*) args->args[1]);
    return a + b;
}

// æ¸…ç†å‡½æ•°
void my_add_deinit(UDF_INIT *initid) {
    // è¿™ä¸ªä¾‹å­ä¸éœ€è¦æ¸…ç†èµ„æº
}
```

> ğŸ“ **ä»£ç è§£é‡Š**ï¼š
> - `args->arg_count`ï¼šä¼ å…¥å‚æ•°çš„ä¸ªæ•°
> - `args->arg_type[i]`ï¼šç¬¬iä¸ªå‚æ•°çš„ç±»å‹
> - `args->args[i]`ï¼šç¬¬iä¸ªå‚æ•°çš„å€¼

### 4.2 å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ç¤ºä¾‹

å†™ä¸€ä¸ªæŠŠå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¤§å†™çš„å‡½æ•°ï¼š

```c
#include <mysql.h>
#include <ctype.h>
#include <string.h>
#include <stdlib.h>

// åˆå§‹åŒ–å‡½æ•°
my_bool my_upper_init(UDF_INIT *initid, UDF_ARGS *args, char *message) {
    if (args->arg_count != 1) {
        strcpy(message, "my_upper() requires exactly 1 argument");
        return 1;
    }
    
    if (args->arg_type[0] != STRING_RESULT) {
        strcpy(message, "my_upper() requires string argument");
        return 1;
    }
    
    // é¢„åˆ†é…ç»“æœç¼“å†²åŒº
    initid->max_length = args->lengths[0];
    return 0;
}

// ä¸»å‡½æ•°ï¼šè½¬æ¢ä¸ºå¤§å†™
char* my_upper(UDF_INIT *initid, UDF_ARGS *args, char *result,
               unsigned long *length, char *is_null, char *error) {
    
    char *input = args->args[0];
    unsigned long input_len = args->lengths[0];
    
    // å¤åˆ¶å¹¶è½¬æ¢ä¸ºå¤§å†™
    for (int i = 0; i < input_len; i++) {
        result[i] = toupper(input[i]);
    }
    
    *length = input_len;
    return result;
}

void my_upper_deinit(UDF_INIT *initid) {
    // æ— éœ€æ¸…ç†
}
```

---

## 5. ğŸ› ï¸ ç¼–è¯‘å®‰è£…éƒ¨ç½²


### 5.1 ç¼–å†™Makefile

åˆ›å»ºMakefileç®€åŒ–ç¼–è¯‘è¿‡ç¨‹ï¼š

```makefile
# Makefile for MySQL UDF
CC = gcc
CFLAGS = -fPIC -shared -Wall
MYSQL_INCDIR = /usr/include/mysql
MYSQL_LIBDIR = /usr/lib64/mysql

# ç›®æ ‡æ–‡ä»¶
TARGET = my_functions.so
SOURCES = my_add.c my_upper.c

# ç¼–è¯‘è§„åˆ™
$(TARGET): $(SOURCES)
	$(CC) $(CFLAGS) -I$(MYSQL_INCDIR) -o $(TARGET) $(SOURCES)

# æ¸…ç†è§„åˆ™
clean:
	rm -f $(TARGET)

# å®‰è£…è§„åˆ™ï¼ˆéœ€è¦rootæƒé™ï¼‰
install: $(TARGET)
	cp $(TARGET) $(MYSQL_LIBDIR)/plugin/
```

> ğŸ’¡ **Makefileè§£é‡Š**ï¼š
> - `-fPIC`ï¼šç”Ÿæˆä½ç½®æ— å…³ä»£ç ï¼ŒåŠ¨æ€åº“å¿…éœ€
> - `-shared`ï¼šç”Ÿæˆå…±äº«åº“ï¼ˆ.soæ–‡ä»¶ï¼‰
> - `-I$(MYSQL_INCDIR)`ï¼šæŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„

### 5.2 ç¼–è¯‘è¿‡ç¨‹

```bash
# 1. ç¼–è¯‘ç”ŸæˆåŠ¨æ€åº“
make

# 2. æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
ls -la my_functions.so

# 3. å®‰è£…åˆ°MySQLæ’ä»¶ç›®å½•ï¼ˆéœ€è¦rootæƒé™ï¼‰
sudo make install

# æˆ–è€…æ‰‹åŠ¨å¤åˆ¶
sudo cp my_functions.so /usr/lib64/mysql/plugin/
```

### 5.3 åœ¨MySQLä¸­æ³¨å†Œå‡½æ•°

ç¼–è¯‘å®Œæˆåï¼Œéœ€è¦åœ¨MySQLä¸­æ³¨å†Œè¿™äº›å‡½æ•°ï¼š

```sql
-- æ³¨å†Œmy_addå‡½æ•°
CREATE FUNCTION my_add RETURNS INTEGER 
SONAME 'my_functions.so';

-- æ³¨å†Œmy_upperå‡½æ•°  
CREATE FUNCTION my_upper RETURNS STRING
SONAME 'my_functions.so';

-- æµ‹è¯•å‡½æ•°
SELECT my_add(10, 20);          -- åº”è¯¥è¿”å›30
SELECT my_upper('hello world'); -- åº”è¯¥è¿”å›'HELLO WORLD'

-- åˆ é™¤å‡½æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰
DROP FUNCTION my_add;
DROP FUNCTION my_upper;
```

---

## 6. ğŸ’¾ å†…å­˜ç®¡ç†ç­–ç•¥


### 6.1 å†…å­˜åˆ†é…åŸåˆ™

**UDFä¸­çš„å†…å­˜ç®¡ç†è¦ç‰¹åˆ«å°å¿ƒ**ï¼Œå› ä¸ºå†…å­˜æ³„æ¼ä¼šå½±å“æ•´ä¸ªMySQLæœåŠ¡å™¨ã€‚

> âš ï¸ **æ ¸å¿ƒåŸåˆ™**ï¼šåœ¨å“ªé‡Œåˆ†é…å†…å­˜ï¼Œå°±åœ¨å“ªé‡Œé‡Šæ”¾

```c
// æ­£ç¡®çš„å†…å­˜ç®¡ç†ç¤ºä¾‹
my_bool my_function_init(UDF_INIT *initid, UDF_ARGS *args, char *message) {
    // åˆ†é…å†…å­˜
    char *buffer = (char*)malloc(1024);
    if (!buffer) {
        strcpy(message, "Memory allocation failed");
        return 1;
    }
    
    // ä¿å­˜æŒ‡é’ˆï¼Œåœ¨deinitä¸­é‡Šæ”¾
    initid->ptr = buffer;
    return 0;
}

void my_function_deinit(UDF_INIT *initid) {
    // é‡Šæ”¾åœ¨initä¸­åˆ†é…çš„å†…å­˜
    if (initid->ptr) {
        free(initid->ptr);
        initid->ptr = NULL;
    }
}
```

### 6.2 å­—ç¬¦ä¸²å†…å­˜å¤„ç†

å­—ç¬¦ä¸²å‡½æ•°çš„å†…å­˜ç®¡ç†æ›´å¤æ‚ï¼š

```c
char* my_string_func(UDF_INIT *initid, UDF_ARGS *args, char *result,
                     unsigned long *length, char *is_null, char *error) {
    
    // æ–¹æ³•1ï¼šä½¿ç”¨MySQLæä¾›çš„resultç¼“å†²åŒºï¼ˆæ¨èï¼‰
    // MySQLä¼šè‡ªåŠ¨ç®¡ç†è¿™å—å†…å­˜
    strcpy(result, "Hello World");
    *length = strlen(result);
    return result;
    
    // æ–¹æ³•2ï¼šè¿”å›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼ˆéœ€è¦å°å¿ƒï¼‰
    // char *dynamic_result = malloc(100);
    // æ³¨æ„ï¼šè¿™ç§æ–¹å¼å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šå°½é‡ä½¿ç”¨MySQLæä¾›çš„resultç¼“å†²åŒºï¼Œé¿å…åŠ¨æ€åˆ†é…

### 6.3 å†…å­˜æ³„æ¼æ£€æµ‹

```bash
# ä½¿ç”¨valgrindæ£€æµ‹å†…å­˜æ³„æ¼
valgrind --tool=memcheck --leak-check=full mysqld

# åœ¨MySQLä¸­ç›‘æ§å†…å­˜ä½¿ç”¨
SHOW STATUS LIKE 'Memory%';
```

---

## 7. ğŸ”’ çº¿ç¨‹å®‰å…¨è®¾è®¡


### 7.1 çº¿ç¨‹å®‰å…¨çš„é‡è¦æ€§

MySQLæ˜¯å¤šçº¿ç¨‹æœåŠ¡å™¨ï¼Œå¤šä¸ªè¿æ¥å¯èƒ½åŒæ—¶è°ƒç”¨ä½ çš„UDFå‡½æ•°ã€‚

**çº¿ç¨‹å®‰å…¨é—®é¢˜ç¤ºä¾‹**ï¼š
```c
// âŒ ä¸å®‰å…¨çš„ä»£ç ï¼šå…¨å±€å˜é‡
static int global_counter = 0;

long long unsafe_function(UDF_INIT *initid, UDF_ARGS *args,
                         char *is_null, char *error) {
    global_counter++;  // å¤šçº¿ç¨‹è®¿é—®æ—¶ä¼šå‡ºé—®é¢˜
    return global_counter;
}
```

### 7.2 çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•

**æ–¹æ³•1ï¼šé¿å…å…¨å±€å˜é‡**
```c
// âœ… å®‰å…¨çš„ä»£ç ï¼šä½¿ç”¨å±€éƒ¨å˜é‡
long long safe_function(UDF_INIT *initid, UDF_ARGS *args,
                        char *is_null, char *error) {
    int local_counter = 0;  // æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å‰¯æœ¬
    local_counter++;
    return local_counter;
}
```

**æ–¹æ³•2ï¼šä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨**
```c
#include <pthread.h>

// ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡
__thread int thread_local_counter = 0;

long long thread_safe_function(UDF_INIT *initid, UDF_ARGS *args,
                               char *is_null, char *error) {
    thread_local_counter++;
    return thread_local_counter;
}
```

### 7.3 é”æœºåˆ¶çš„ä½¿ç”¨

å¦‚æœå¿…é¡»ä½¿ç”¨å…±äº«èµ„æºï¼Œè¦åŠ é”ä¿æŠ¤ï¼š

```c
#include <pthread.h>

static pthread_mutex_t global_mutex = PTHREAD_MUTEX_INITIALIZER;
static int shared_resource = 0;

long long locked_function(UDF_INIT *initid, UDF_ARGS *args,
                         char *is_null, char *error) {
    pthread_mutex_lock(&global_mutex);
    shared_resource++;
    int result = shared_resource;
    pthread_mutex_unlock(&global_mutex);
    
    return result;
}
```

> âš ï¸ **æ³¨æ„**ï¼šè¿‡åº¦ä½¿ç”¨é”ä¼šå½±å“æ€§èƒ½ï¼Œèƒ½é¿å…å°±é¿å…

---

## 8. ğŸ“š UDF APIæ¥å£è§„èŒƒ


### 8.1 æ ¸å¿ƒæ•°æ®ç»“æ„

**UDF_INITç»“æ„ä½“**ï¼šä¿å­˜å‡½æ•°çš„åˆå§‹åŒ–ä¿¡æ¯
```c
typedef struct {
    my_bool maybe_null;     // å‡½æ•°æ˜¯å¦å¯èƒ½è¿”å›NULL
    unsigned long max_length; // è¿”å›å€¼çš„æœ€å¤§é•¿åº¦
    unsigned int decimals;   // å°æ•°ä½æ•°ï¼ˆæµ®ç‚¹æ•°ç”¨ï¼‰
    char *ptr;              // ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®æŒ‡é’ˆ
} UDF_INIT;
```

**UDF_ARGSç»“æ„ä½“**ï¼šä¿å­˜ä¼ å…¥çš„å‚æ•°ä¿¡æ¯
```c
typedef struct {
    unsigned int arg_count;    // å‚æ•°ä¸ªæ•°
    enum Item_result *arg_type; // æ¯ä¸ªå‚æ•°çš„ç±»å‹
    char **args;              // å‚æ•°å€¼æ•°ç»„
    unsigned long *lengths;   // æ¯ä¸ªå‚æ•°çš„é•¿åº¦
    char *maybe_null;         // å‚æ•°æ˜¯å¦å¯èƒ½ä¸ºNULL
} UDF_ARGS;
```

### 8.2 å‚æ•°ç±»å‹æ£€æŸ¥

```c
my_bool check_arguments(UDF_ARGS *args, char *message) {
    // æ£€æŸ¥å‚æ•°ä¸ªæ•°
    if (args->arg_count < 1) {
        strcpy(message, "è‡³å°‘éœ€è¦1ä¸ªå‚æ•°");
        return 1;
    }
    
    // æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹
    switch(args->arg_type[0]) {
        case STRING_RESULT:
            // å­—ç¬¦ä¸²å‚æ•°å¤„ç†
            break;
        case INT_RESULT:
            // æ•´æ•°å‚æ•°å¤„ç†
            break;
        case REAL_RESULT:
            // æµ®ç‚¹æ•°å‚æ•°å¤„ç†
            break;
        default:
            strcpy(message, "ä¸æ”¯æŒçš„å‚æ•°ç±»å‹");
            return 1;
    }
    
    return 0;
}
```

### 8.3 é”™è¯¯å¤„ç†è§„èŒƒ

```c
long long my_function(UDF_INIT *initid, UDF_ARGS *args,
                     char *is_null, char *error) {
    
    // æ£€æŸ¥å‚æ•°æ˜¯å¦ä¸ºNULL
    if (args->args[0] == NULL) {
        *is_null = 1;  // è®¾ç½®è¿”å›å€¼ä¸ºNULL
        return 0;
    }
    
    // æ£€æŸ¥ä¸šåŠ¡é€»è¾‘é”™è¯¯
    if (æŸç§é”™è¯¯æ¡ä»¶) {
        strcpy(error, "å…·ä½“çš„é”™è¯¯ä¿¡æ¯");
        return 0;
    }
    
    // æ­£å¸¸å¤„ç†é€»è¾‘
    return è®¡ç®—ç»“æœ;
}
```

### 8.4 èšåˆå‡½æ•°æ¥å£

èšåˆå‡½æ•°ï¼ˆå¦‚SUMã€COUNTç±»å‹ï¼‰éœ€è¦é¢å¤–çš„æ¥å£ï¼š

```c
// èšåˆå‡½æ•°éœ€è¦4ä¸ªæ¥å£
void my_sum_clear(UDF_INIT *initid, char *is_null, char *error);
void my_sum_add(UDF_INIT *initid, UDF_ARGS *args, char *is_null, char *error);
long long my_sum(UDF_INIT *initid, UDF_ARGS *args, char *is_null, char *error);
my_bool my_sum_init(UDF_INIT *initid, UDF_ARGS *args, char *message);
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ

```
ğŸ”¸ UDFæœ¬è´¨ï¼šç”¨C/C++æ‰©å±•MySQLåŠŸèƒ½çš„ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°
ğŸ”¸ å¼€å‘ç¯å¢ƒï¼šéœ€è¦gccç¼–è¯‘å™¨å’ŒMySQLå¼€å‘åº“
ğŸ”¸ å‡½æ•°æ¥å£ï¼šä¸»å‡½æ•°ã€initå‡½æ•°ã€deinitå‡½æ•°ä¸‰ä¸ªå¿…éœ€æ¥å£
ğŸ”¸ ç¼–è¯‘éƒ¨ç½²ï¼šç¼–è¯‘æˆ.soåŠ¨æ€åº“ï¼Œæ³¨å†Œåˆ°MySQLä¸­ä½¿ç”¨
ğŸ”¸ å†…å­˜ç®¡ç†ï¼šè°åˆ†é…è°é‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼
ğŸ”¸ çº¿ç¨‹å®‰å…¨ï¼šé¿å…å…¨å±€å˜é‡ï¼Œæ³¨æ„å¤šçº¿ç¨‹è®¿é—®é—®é¢˜
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ UDFçš„é€‚ç”¨åœºæ™¯**
```
é€‚åˆä½¿ç”¨UDFï¼š
âœ… MySQLå†…ç½®å‡½æ•°æ— æ³•æ»¡è¶³éœ€æ±‚
âœ… éœ€è¦è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿæˆ–åº“
âœ… å¤æ‚è®¡ç®—é€»è¾‘ï¼ŒC/C++æ€§èƒ½æ›´å¥½
âœ… ç‰¹æ®Šçš„æ•°æ®å¤„ç†ç®—æ³•

ä¸é€‚åˆä½¿ç”¨UDFï¼š
âŒ ç®€å•çš„SQLé€»è¾‘èƒ½è§£å†³çš„é—®é¢˜
âŒ å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯
âŒ éœ€è¦é¢‘ç¹ä¿®æ”¹çš„ä¸šåŠ¡é€»è¾‘
```

**ğŸ”¹ å¼€å‘æ³¨æ„äº‹é¡¹**
```
ç¼–ç è§„èŒƒï¼š
â€¢ å‡½æ•°å‘½åå¿…é¡»éµå¾ªMySQLè§„èŒƒ
â€¢ å‚æ•°æ£€æŸ¥è¦ä¸¥æ ¼ï¼Œé˜²æ­¢å´©æºƒ
â€¢ é”™è¯¯ä¿¡æ¯è¦æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ é¿å…å¤æ‚çš„å†…å­˜åˆ†é…
â€¢ å‡å°‘ç³»ç»Ÿè°ƒç”¨
â€¢ æ³¨æ„çº¿ç¨‹å®‰å…¨çš„æ€§èƒ½å¼€é”€

éƒ¨ç½²ç»´æŠ¤ï¼š
â€¢ ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•
â€¢ å¤‡ä»½åŸæœ‰å‡½æ•°
â€¢ ç›‘æ§å†…å­˜å’Œæ€§èƒ½æŒ‡æ ‡
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼

- **åŠŸèƒ½æ‰©å±•**ï¼šä¸ºMySQLå¢åŠ è‡ªå®šä¹‰åŠŸèƒ½ï¼Œæ»¡è¶³ç‰¹æ®Šéœ€æ±‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç”¨C/C++æ›¿ä»£å¤æ‚SQLï¼Œæå‡è®¡ç®—æ•ˆç‡  
- **ç³»ç»Ÿé›†æˆ**ï¼šåœ¨æ•°æ®åº“å±‚é¢è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿæ¥å£
- **ç®—æ³•å®ç°**ï¼šå®ç°MySQLä¸æ”¯æŒçš„ç‰¹æ®Šç®—æ³•

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
UDFæ‰©å±•MySQLåŠŸèƒ½å¼ºï¼ŒCè¯­è¨€ç¼–å†™æ€§èƒ½æ£’
ä¸‰ä¸ªæ¥å£è¦è®°ç‰¢ï¼Œinitä¸»å‡½æ•°åŠ deinit
å†…å­˜ç®¡ç†è¦è°¨æ…ï¼Œçº¿ç¨‹å®‰å…¨ä¸èƒ½å¿˜
ç¼–è¯‘æ³¨å†Œæ‰èƒ½ç”¨ï¼Œé”™è¯¯å¤„ç†ä¿ç¨³å®š
```

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼š
> 1. å…ˆä»ç®€å•çš„æ•°å­¦å‡½æ•°å¼€å§‹ç»ƒä¹ 
> 2. é€æ­¥æŒæ¡å­—ç¬¦ä¸²å’Œèšåˆå‡½æ•°
> 3. é‡ç‚¹å…³æ³¨å†…å­˜ç®¡ç†å’Œçº¿ç¨‹å®‰å…¨
> 4. åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ