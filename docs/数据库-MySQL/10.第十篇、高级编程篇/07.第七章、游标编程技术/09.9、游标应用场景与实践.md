---
title: 9ã€æ¸¸æ ‡åº”ç”¨åœºæ™¯ä¸å®è·µ
---
## ğŸ“š ç›®å½•

1. [æ¸¸æ ‡æŠ€æœ¯æ ¸å¿ƒæ¦‚å¿µ](#1-æ¸¸æ ‡æŠ€æœ¯æ ¸å¿ƒæ¦‚å¿µ)
2. [æ•°æ®è¿ç§»åº”ç”¨åœºæ™¯](#2-æ•°æ®è¿ç§»åº”ç”¨åœºæ™¯)
3. [æŠ¥è¡¨ç”Ÿæˆä¸ç»Ÿè®¡åœºæ™¯](#3-æŠ¥è¡¨ç”Ÿæˆä¸ç»Ÿè®¡åœºæ™¯)
4. [æ•°æ®æ¸…æ´—å¤„ç†å®è·µ](#4-æ•°æ®æ¸…æ´—å¤„ç†å®è·µ)
5. [å¤æ‚ä¸šåŠ¡é€»è¾‘å®ç°](#5-å¤æ‚ä¸šåŠ¡é€»è¾‘å®ç°)
6. [ETLè¿‡ç¨‹ä¸­çš„æ¸¸æ ‡åº”ç”¨](#6-etlè¿‡ç¨‹ä¸­çš„æ¸¸æ ‡åº”ç”¨)
7. [å®æ—¶æµå¤„ç†æ¸¸æ ‡æŠ€æœ¯](#7-å®æ—¶æµå¤„ç†æ¸¸æ ‡æŠ€æœ¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¸¸æ ‡æŠ€æœ¯æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¸¸æ ‡


**ç®€å•ç†è§£**ï¼šæ¸¸æ ‡å°±åƒæ˜¯æ•°æ®åº“é‡Œçš„"æŒ‡é’ˆ"ï¼Œå¯ä»¥ä¸€è¡Œä¸€è¡Œåœ°å¤„ç†æŸ¥è¯¢ç»“æœ

```
ä¼ ç»ŸæŸ¥è¯¢æ–¹å¼ï¼š
SELECT * FROM users; 
â†’ ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰ç»“æœï¼Œå†…å­˜å ç”¨å¤§

æ¸¸æ ‡æ–¹å¼ï¼š
â†’ é€è¡Œè¯»å–ï¼Œé€è¡Œå¤„ç†ï¼Œå†…å­˜å ç”¨å°
â†’ é€‚åˆå¤„ç†å¤§é‡æ•°æ®æˆ–å¤æ‚é€»è¾‘
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **é€è¡Œå¤„ç†**ï¼šä¸€æ¬¡åªå¤„ç†ä¸€è¡Œæ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡º
- **å¯æ§åˆ¶**ï¼šå¯ä»¥å‘å‰ã€å‘åç§»åŠ¨ï¼Œæ§åˆ¶å¤„ç†æµç¨‹
- **é€‚åˆå¤æ‚é€»è¾‘**ï¼šæ¯è¡Œæ•°æ®å¯ä»¥æ‰§è¡Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘

### 1.2 æ¸¸æ ‡çš„åŸºæœ¬è¯­æ³•ç»“æ„


```sql
-- æ¸¸æ ‡çš„å®Œæ•´ä½¿ç”¨æµç¨‹
DELIMITER //
CREATE PROCEDURE cursor_demo()
BEGIN
    -- 1. å£°æ˜å˜é‡
    DECLARE user_id INT;
    DECLARE user_name VARCHAR(100);
    DECLARE done INT DEFAULT FALSE;
    
    -- 2. å£°æ˜æ¸¸æ ‡
    DECLARE user_cursor CURSOR FOR 
        SELECT id, name FROM users WHERE status = 'active';
    
    -- 3. å£°æ˜å¼‚å¸¸å¤„ç†
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- 4. æ‰“å¼€æ¸¸æ ‡
    OPEN user_cursor;
    
    -- 5. å¾ªç¯è¯»å–æ•°æ®
    read_loop: LOOP
        FETCH user_cursor INTO user_id, user_name;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- åœ¨è¿™é‡Œå¤„ç†æ¯è¡Œæ•°æ®
        SELECT CONCAT('å¤„ç†ç”¨æˆ·ï¼š', user_name);
    END LOOP;
    
    -- 6. å…³é—­æ¸¸æ ‡
    CLOSE user_cursor;
END //
DELIMITER ;
```

**å…³é”®æ­¥éª¤è¯´æ˜**ï¼š
- **å£°æ˜å˜é‡**ï¼šå­˜å‚¨ä»æ¸¸æ ‡ä¸­è·å–çš„æ•°æ®
- **å£°æ˜æ¸¸æ ‡**ï¼šå®šä¹‰è¦å¤„ç†çš„æ•°æ®é›†åˆ
- **å¼‚å¸¸å¤„ç†**ï¼šå½“æ²¡æœ‰æ›´å¤šæ•°æ®æ—¶ç»“æŸå¾ªç¯
- **æ‰“å¼€/å…³é—­**ï¼šä½¿ç”¨å‰æ‰“å¼€ï¼Œä½¿ç”¨åå…³é—­é‡Šæ”¾èµ„æº

---

## 2. ğŸ“Š æ•°æ®è¿ç§»åº”ç”¨åœºæ™¯


### 2.1 å¤§è¡¨æ•°æ®è¿ç§»


åœ¨å®é™…å·¥ä½œä¸­ï¼Œç»å¸¸éœ€è¦å°†å¤§è¡¨çš„æ•°æ®è¿ç§»åˆ°æ–°è¡¨ï¼Œç›´æ¥INSERTå®¹æ˜“é€ æˆç³»ç»Ÿå¡é¡¿

```sql
-- åœºæ™¯ï¼šå°†æ—§ç”¨æˆ·è¡¨æ•°æ®è¿ç§»åˆ°æ–°ç”¨æˆ·è¡¨
DELIMITER //
CREATE PROCEDURE migrate_user_data()
BEGIN
    DECLARE old_id INT;
    DECLARE old_name VARCHAR(100);
    DECLARE old_email VARCHAR(150);
    DECLARE old_created_date DATE;
    DECLARE done INT DEFAULT FALSE;
    DECLARE batch_count INT DEFAULT 0;
    
    -- æ¸¸æ ‡ï¼šæ¯æ¬¡å¤„ç†1000æ¡æ•°æ®
    DECLARE migrate_cursor CURSOR FOR 
        SELECT id, username, email, created_at 
        FROM old_users 
        WHERE migrated = 0 
        LIMIT 1000;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN migrate_cursor;
    
    migrate_loop: LOOP
        FETCH migrate_cursor INTO old_id, old_name, old_email, old_created_date;
        IF done THEN
            LEAVE migrate_loop;
        END IF;
        
        -- æ•°æ®è½¬æ¢å’Œæ’å…¥
        INSERT INTO new_users (user_id, full_name, email_address, register_date, status)
        VALUES (old_id, old_name, old_email, old_created_date, 'active');
        
        -- æ ‡è®°å·²è¿ç§»
        UPDATE old_users SET migrated = 1 WHERE id = old_id;
        
        SET batch_count = batch_count + 1;
        
        -- æ¯100æ¡æäº¤ä¸€æ¬¡ï¼Œé¿å…é•¿äº‹åŠ¡
        IF batch_count % 100 = 0 THEN
            COMMIT;
        END IF;
    END LOOP;
    
    CLOSE migrate_cursor;
    SELECT CONCAT('æˆåŠŸè¿ç§» ', batch_count, ' æ¡æ•°æ®') AS result;
END //
DELIMITER ;
```

**ä¸ºä»€ä¹ˆç”¨æ¸¸æ ‡**ï¼š
- **å†…å­˜æ§åˆ¶**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½ç™¾ä¸‡çº§æ•°æ®åˆ°å†…å­˜
- **äº‹åŠ¡æ§åˆ¶**ï¼šå¯ä»¥åˆ†æ‰¹æäº¤ï¼Œé¿å…é•¿äº‹åŠ¡é”è¡¨
- **é”™è¯¯å¤„ç†**ï¼šå•æ¡æ•°æ®å‡ºé”™ä¸å½±å“å…¶ä»–æ•°æ®å¤„ç†

### 2.2 è·¨æ•°æ®åº“æ•°æ®åŒæ­¥


```sql
-- å°†MySQLæ•°æ®åŒæ­¥åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼ˆé€šè¿‡ä¸­é—´è¡¨ï¼‰
DELIMITER //
CREATE PROCEDURE sync_to_external_system()
BEGIN
    DECLARE product_id INT;
    DECLARE product_name VARCHAR(200);
    DECLARE product_price DECIMAL(10,2);
    DECLARE sync_status VARCHAR(20) DEFAULT 'pending';
    DECLARE done INT DEFAULT FALSE;
    
    DECLARE sync_cursor CURSOR FOR 
        SELECT id, name, price 
        FROM products 
        WHERE last_updated > DATE_SUB(NOW(), INTERVAL 1 HOUR);
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN sync_cursor;
    
    sync_loop: LOOP
        FETCH sync_cursor INTO product_id, product_name, product_price;
        IF done THEN
            LEAVE sync_loop;
        END IF;
        
        -- å†™å…¥åŒæ­¥é˜Ÿåˆ—è¡¨
        INSERT INTO sync_queue (
            table_name, 
            record_id, 
            action_type, 
            data_json, 
            status
        ) VALUES (
            'products',
            product_id,
            'update',
            JSON_OBJECT('name', product_name, 'price', product_price),
            'pending'
        );
        
    END LOOP;
    
    CLOSE sync_cursor;
END //
DELIMITER ;
```

---

## 3. ğŸ“ˆ æŠ¥è¡¨ç”Ÿæˆä¸ç»Ÿè®¡åœºæ™¯


### 3.1 å¤æ‚ç»Ÿè®¡æŠ¥è¡¨ç”Ÿæˆ


æ¸¸æ ‡ç‰¹åˆ«é€‚åˆç”Ÿæˆéœ€è¦å¤æ‚è®¡ç®—çš„ç»Ÿè®¡æŠ¥è¡¨

```sql
-- ç”Ÿæˆç”¨æˆ·æ¶ˆè´¹è¡Œä¸ºåˆ†ææŠ¥è¡¨
DELIMITER //
CREATE PROCEDURE generate_user_behavior_report(IN report_month VARCHAR(7))
BEGIN
    DECLARE user_id INT;
    DECLARE user_name VARCHAR(100);
    DECLARE total_orders INT DEFAULT 0;
    DECLARE total_amount DECIMAL(15,2) DEFAULT 0;
    DECLARE avg_order_value DECIMAL(10,2) DEFAULT 0;
    DECLARE user_level VARCHAR(20) DEFAULT 'Bronze';
    DECLARE done INT DEFAULT FALSE;
    
    -- è·å–éœ€è¦åˆ†æçš„ç”¨æˆ·
    DECLARE report_cursor CURSOR FOR 
        SELECT DISTINCT u.id, u.name 
        FROM users u 
        INNER JOIN orders o ON u.id = o.user_id 
        WHERE DATE_FORMAT(o.created_at, '%Y-%m') = report_month;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- å…ˆæ¸…ç©ºæŠ¥è¡¨è¡¨
    DELETE FROM user_behavior_report WHERE report_period = report_month;
    
    OPEN report_cursor;
    
    report_loop: LOOP
        FETCH report_cursor INTO user_id, user_name;
        IF done THEN
            LEAVE report_loop;
        END IF;
        
        -- è®¡ç®—ç”¨æˆ·è®¢å•æ•°é‡
        SELECT COUNT(*) INTO total_orders
        FROM orders 
        WHERE user_id = user_id 
        AND DATE_FORMAT(created_at, '%Y-%m') = report_month;
        
        -- è®¡ç®—ç”¨æˆ·æ¶ˆè´¹é‡‘é¢
        SELECT COALESCE(SUM(total_amount), 0) INTO total_amount
        FROM orders 
        WHERE user_id = user_id 
        AND DATE_FORMAT(created_at, '%Y-%m') = report_month;
        
        -- è®¡ç®—å¹³å‡è®¢å•ä»·å€¼
        IF total_orders > 0 THEN
            SET avg_order_value = total_amount / total_orders;
        ELSE
            SET avg_order_value = 0;
        END IF;
        
        -- æ ¹æ®æ¶ˆè´¹é‡‘é¢åˆ¤æ–­ç”¨æˆ·ç­‰çº§
        IF total_amount >= 10000 THEN
            SET user_level = 'Platinum';
        ELSEIF total_amount >= 5000 THEN
            SET user_level = 'Gold';
        ELSEIF total_amount >= 1000 THEN
            SET user_level = 'Silver';
        ELSE
            SET user_level = 'Bronze';
        END IF;
        
        -- æ’å…¥æŠ¥è¡¨æ•°æ®
        INSERT INTO user_behavior_report (
            report_period, user_id, user_name, 
            order_count, total_spending, avg_order_value, 
            user_level, generated_at
        ) VALUES (
            report_month, user_id, user_name,
            total_orders, total_amount, avg_order_value,
            user_level, NOW()
        );
        
    END LOOP;
    
    CLOSE report_cursor;
    SELECT CONCAT('æŠ¥è¡¨ç”Ÿæˆå®Œæˆï¼Œå¤„ç†ç”¨æˆ·æ•°ï¼š', ROW_COUNT()) AS result;
END //
DELIMITER ;
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- **æœˆåº¦é”€å”®æŠ¥è¡¨**ï¼šéœ€è¦å¯¹æ¯ä¸ªå®¢æˆ·è¿›è¡Œå¤æ‚è®¡ç®—
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šæ ¹æ®å†å²æ•°æ®è®¡ç®—ç”¨æˆ·æ ‡ç­¾
- **ç»©æ•ˆè€ƒæ ¸æŠ¥è¡¨**ï¼šå‘˜å·¥ä¸šç»©çš„å¤šç»´åº¦ç»Ÿè®¡

---

## 4. ğŸ§¹ æ•°æ®æ¸…æ´—å¤„ç†å®è·µ


### 4.1 æ•°æ®è´¨é‡æ£€æŸ¥ä¸ä¿®å¤


åœ¨å®é™…ä¸šåŠ¡ä¸­ï¼Œç»å¸¸éœ€è¦æ¸…æ´—å†å²æ•°æ®ä¸­çš„é—®é¢˜

```sql
-- æ¸…æ´—ç”¨æˆ·æ•°æ®ä¸­çš„é—®é¢˜è®°å½•
DELIMITER //
CREATE PROCEDURE clean_user_data()
BEGIN
    DECLARE user_id INT;
    DECLARE user_email VARCHAR(200);
    DECLARE user_phone VARCHAR(50);
    DECLARE user_name VARCHAR(100);
    DECLARE clean_action VARCHAR(100);
    DECLARE done INT DEFAULT FALSE;
    
    DECLARE clean_cursor CURSOR FOR 
        SELECT id, email, phone, name 
        FROM users 
        WHERE created_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN clean_cursor;
    
    clean_loop: LOOP
        FETCH clean_cursor INTO user_id, user_email, user_phone, user_name;
        IF done THEN
            LEAVE clean_loop;
        END IF;
        
        SET clean_action = '';
        
        -- æ£€æŸ¥é‚®ç®±æ ¼å¼
        IF user_email IS NOT NULL AND user_email NOT LIKE '%@%.%' THEN
            UPDATE users SET email = NULL WHERE id = user_id;
            SET clean_action = CONCAT(clean_action, 'ä¿®å¤é‚®ç®±æ ¼å¼;');
        END IF;
        
        -- æ£€æŸ¥æ‰‹æœºå·æ ¼å¼
        IF user_phone IS NOT NULL AND LENGTH(user_phone) != 11 THEN
            UPDATE users SET phone = NULL WHERE id = user_id;
            SET clean_action = CONCAT(clean_action, 'ä¿®å¤æ‰‹æœºå·æ ¼å¼;');
        END IF;
        
        -- æ£€æŸ¥å§“åé•¿åº¦
        IF user_name IS NOT NULL AND LENGTH(user_name) > 50 THEN
            UPDATE users SET name = LEFT(user_name, 50) WHERE id = user_id;
            SET clean_action = CONCAT(clean_action, 'æˆªæ–­ç”¨æˆ·å§“å;');
        END IF;
        
        -- è®°å½•æ¸…æ´—æ—¥å¿—
        IF clean_action != '' THEN
            INSERT INTO data_clean_log (table_name, record_id, clean_actions, clean_time)
            VALUES ('users', user_id, clean_action, NOW());
        END IF;
        
    END LOOP;
    
    CLOSE clean_cursor;
END //
DELIMITER ;
```

### 4.2 é‡å¤æ•°æ®å¤„ç†


```sql
-- å¤„ç†é‡å¤ç”¨æˆ·æ•°æ®
DELIMITER //
CREATE PROCEDURE remove_duplicate_users()
BEGIN
    DECLARE dup_email VARCHAR(200);
    DECLARE keep_user_id INT;
    DECLARE remove_user_id INT;
    DECLARE done INT DEFAULT FALSE;
    
    -- æ‰¾å‡ºé‡å¤é‚®ç®±ï¼Œä¿ç•™æœ€æ—©æ³¨å†Œçš„ç”¨æˆ·
    DECLARE dup_cursor CURSOR FOR 
        SELECT email, MIN(id) as keep_id
        FROM users 
        WHERE email IS NOT NULL
        GROUP BY email 
        HAVING COUNT(*) > 1;
    
    DECLARE remove_cursor CURSOR FOR 
        SELECT id FROM users 
        WHERE email = dup_email AND id != keep_user_id;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN dup_cursor;
    
    dup_loop: LOOP
        FETCH dup_cursor INTO dup_email, keep_user_id;
        IF done THEN
            LEAVE dup_loop;
        END IF;
        
        -- æ‰“å¼€åˆ é™¤æ¸¸æ ‡
        SET done = FALSE;
        OPEN remove_cursor;
        
        remove_loop: LOOP
            FETCH remove_cursor INTO remove_user_id;
            IF done THEN
                LEAVE remove_loop;
            END IF;
            
            -- è¿ç§»é‡è¦æ•°æ®åˆ°ä¿ç•™ç”¨æˆ·
            UPDATE orders SET user_id = keep_user_id WHERE user_id = remove_user_id;
            
            -- åˆ é™¤é‡å¤ç”¨æˆ·
            DELETE FROM users WHERE id = remove_user_id;
            
            -- è®°å½•æ“ä½œæ—¥å¿—
            INSERT INTO data_clean_log (table_name, record_id, clean_actions, clean_time)
            VALUES ('users', remove_user_id, 
                   CONCAT('åˆ é™¤é‡å¤ç”¨æˆ·ï¼Œæ•°æ®åˆå¹¶åˆ°ç”¨æˆ·ID:', keep_user_id), NOW());
        END LOOP;
        
        CLOSE remove_cursor;
        SET done = FALSE;
        
    END LOOP;
    
    CLOSE dup_cursor;
END //
DELIMITER ;
```

---

## 5. ğŸ”§ å¤æ‚ä¸šåŠ¡é€»è¾‘å®ç°


### 5.1 è®¢å•çŠ¶æ€æ‰¹é‡æ›´æ–°


å®é™…ä¸šåŠ¡ä¸­ç»å¸¸éœ€è¦æ ¹æ®å¤æ‚æ¡ä»¶æ‰¹é‡æ›´æ–°æ•°æ®çŠ¶æ€

```sql
-- è‡ªåŠ¨å¤„ç†è¶…æ—¶è®¢å•
DELIMITER //
CREATE PROCEDURE process_timeout_orders()
BEGIN
    DECLARE order_id INT;
    DECLARE order_status VARCHAR(20);
    DECLARE payment_status VARCHAR(20);
    DECLARE created_time DATETIME;
    DECLARE timeout_hours INT;
    DECLARE new_status VARCHAR(20);
    DECLARE done INT DEFAULT FALSE;
    
    DECLARE order_cursor CURSOR FOR 
        SELECT id, status, payment_status, created_at
        FROM orders 
        WHERE status IN ('pending', 'confirmed')
        AND created_at < DATE_SUB(NOW(), INTERVAL 2 HOUR);
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN order_cursor;
    
    process_loop: LOOP
        FETCH order_cursor INTO order_id, order_status, payment_status, created_time;
        IF done THEN
            LEAVE process_loop;
        END IF;
        
        -- è®¡ç®—è®¢å•è¶…æ—¶æ—¶é—´
        SET timeout_hours = TIMESTAMPDIFF(HOUR, created_time, NOW());
        
        -- æ ¹æ®ä¸åŒæƒ…å†µå¤„ç†è®¢å•
        IF order_status = 'pending' AND timeout_hours >= 24 THEN
            -- å¾…æ”¯ä»˜è®¢å•è¶…è¿‡24å°æ—¶è‡ªåŠ¨å–æ¶ˆ
            SET new_status = 'cancelled';
            
            -- é‡Šæ”¾åº“å­˜
            UPDATE product_inventory pi 
            INNER JOIN order_items oi ON pi.product_id = oi.product_id
            SET pi.available_quantity = pi.available_quantity + oi.quantity
            WHERE oi.order_id = order_id;
            
        ELSEIF order_status = 'confirmed' AND payment_status = 'pending' AND timeout_hours >= 48 THEN
            -- å·²ç¡®è®¤ä½†æœªæ”¯ä»˜è®¢å•è¶…è¿‡48å°æ—¶é€€å›å¾…æ”¯ä»˜
            SET new_status = 'pending';
            
        ELSEIF order_status = 'confirmed' AND payment_status = 'paid' AND timeout_hours >= 72 THEN
            -- å·²æ”¯ä»˜è®¢å•è¶…è¿‡72å°æ—¶è‡ªåŠ¨å‘è´§
            SET new_status = 'shipped';
            
            -- å‘é€å‘è´§é€šçŸ¥
            INSERT INTO notifications (user_id, type, title, content, created_at)
            SELECT user_id, 'order_shipped', 'è®¢å•å·²å‘è´§', 
                   CONCAT('æ‚¨çš„è®¢å• #', order_id, ' å·²å‘è´§'), NOW()
            FROM orders WHERE id = order_id;
        END IF;
        
        -- æ›´æ–°è®¢å•çŠ¶æ€
        IF new_status IS NOT NULL THEN
            UPDATE orders 
            SET status = new_status, updated_at = NOW() 
            WHERE id = order_id;
            
            -- è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—
            INSERT INTO order_status_log (order_id, old_status, new_status, change_reason, created_at)
            VALUES (order_id, order_status, new_status, 'ç³»ç»Ÿè‡ªåŠ¨å¤„ç†', NOW());
        END IF;
        
        SET new_status = NULL;
        
    END LOOP;
    
    CLOSE order_cursor;
END //
DELIMITER ;
```

**åº”ç”¨åœºæ™¯**ï¼š
- **è®¢å•è¶…æ—¶å¤„ç†**ï¼šè‡ªåŠ¨å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜è®¢å•
- **ç”¨æˆ·ç­‰çº§å‡çº§**ï¼šæ ¹æ®æ¶ˆè´¹é‡‘é¢è‡ªåŠ¨è°ƒæ•´ç”¨æˆ·ç­‰çº§
- **åº“å­˜é¢„è­¦å¤„ç†**ï¼šåº“å­˜ä¸è¶³æ—¶è‡ªåŠ¨å‘é€è¡¥è´§æé†’

---

## 6. ğŸ”„ ETLè¿‡ç¨‹ä¸­çš„æ¸¸æ ‡åº”ç”¨


### 6.1 æ•°æ®æŠ½å–è½¬æ¢åŠ è½½


ETLï¼ˆExtract-Transform-Loadï¼‰æ˜¯æ•°æ®ä»“åº“çš„æ ¸å¿ƒæµç¨‹ï¼Œæ¸¸æ ‡åœ¨å…¶ä¸­å‘æŒ¥é‡è¦ä½œç”¨

```sql
-- é”€å”®æ•°æ®ETLå¤„ç†
DELIMITER //
CREATE PROCEDURE etl_sales_data(IN process_date DATE)
BEGIN
    DECLARE source_id INT;
    DECLARE customer_name VARCHAR(100);
    DECLARE product_name VARCHAR(200);
    DECLARE sale_amount DECIMAL(10,2);
    DECLARE sale_date DATE;
    DECLARE region_code VARCHAR(10);
    DECLARE customer_id INT;
    DECLARE product_id INT;
    DECLARE region_id INT;
    DECLARE done INT DEFAULT FALSE;
    
    -- ä»æºç³»ç»ŸæŠ½å–æ•°æ®
    DECLARE etl_cursor CURSOR FOR 
        SELECT id, customer_name, product_name, amount, sale_date, region_code
        FROM raw_sales_data 
        WHERE DATE(created_at) = process_date
        AND processed = 0;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN etl_cursor;
    
    etl_loop: LOOP
        FETCH etl_cursor INTO source_id, customer_name, product_name, 
                              sale_amount, sale_date, region_code;
        IF done THEN
            LEAVE etl_loop;
        END IF;
        
        -- æ•°æ®æ¸…æ´—å’ŒéªŒè¯
        IF sale_amount <= 0 OR customer_name IS NULL THEN
            -- è®°å½•é”™è¯¯æ•°æ®
            INSERT INTO etl_error_log (source_table, source_id, error_reason, created_at)
            VALUES ('raw_sales_data', source_id, 'æ•°æ®ä¸å®Œæ•´æˆ–é‡‘é¢æ— æ•ˆ', NOW());
            ITERATE etl_loop;
        END IF;
        
        -- æŸ¥æ‰¾æˆ–åˆ›å»ºå®¢æˆ·ç»´åº¦
        SELECT id INTO customer_id FROM dim_customer WHERE name = customer_name;
        IF customer_id IS NULL THEN
            INSERT INTO dim_customer (name, created_at) VALUES (customer_name, NOW());
            SET customer_id = LAST_INSERT_ID();
        END IF;
        
        -- æŸ¥æ‰¾æˆ–åˆ›å»ºäº§å“ç»´åº¦
        SELECT id INTO product_id FROM dim_product WHERE name = product_name;
        IF product_id IS NULL THEN
            INSERT INTO dim_product (name, created_at) VALUES (product_name, NOW());
            SET product_id = LAST_INSERT_ID();
        END IF;
        
        -- æŸ¥æ‰¾åœ°åŒºç»´åº¦
        SELECT id INTO region_id FROM dim_region WHERE code = region_code;
        IF region_id IS NULL THEN
            SET region_id = 1; -- é»˜è®¤åœ°åŒº
        END IF;
        
        -- æ’å…¥äº‹å®è¡¨
        INSERT INTO fact_sales (
            customer_id, product_id, region_id, 
            sale_amount, sale_date, source_id, created_at
        ) VALUES (
            customer_id, product_id, region_id,
            sale_amount, sale_date, source_id, NOW()
        );
        
        -- æ ‡è®°æºæ•°æ®å·²å¤„ç†
        UPDATE raw_sales_data SET processed = 1 WHERE id = source_id;
        
    END LOOP;
    
    CLOSE etl_cursor;
    
    -- ç”Ÿæˆå¤„ç†æŠ¥å‘Š
    SELECT CONCAT('ETLå¤„ç†å®Œæˆï¼Œå¤„ç†æ—¥æœŸï¼š', process_date, 
                  'ï¼Œå¤„ç†è®°å½•æ•°ï¼š', ROW_COUNT()) AS result;
END //
DELIMITER ;
```

**ETLæ¸¸æ ‡çš„ä¼˜åŠ¿**ï¼š
- **å†…å­˜æ•ˆç‡**ï¼šä¸éœ€è¦ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
- **é”™è¯¯å¤„ç†**ï¼šå•æ¡è®°å½•é”™è¯¯ä¸å½±å“æ•´ä½“å¤„ç†
- **äº‹åŠ¡æ§åˆ¶**ï¼šå¯ä»¥çµæ´»æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
- **ç›‘æ§å‹å¥½**ï¼šå®¹æ˜“æ·»åŠ è¿›åº¦ç›‘æ§å’Œæ—¥å¿—

---

## 7. âš¡ å®æ—¶æµå¤„ç†æ¸¸æ ‡æŠ€æœ¯


### 7.1 å¢é‡æ•°æ®å¤„ç†


åœ¨å®æ—¶æ•°æ®å¤„ç†åœºæ™¯ä¸­ï¼Œæ¸¸æ ‡å¯ä»¥ç”¨æ¥å¤„ç†å¢é‡æ›´æ–°

```sql
-- å®æ—¶å¤„ç†ç”¨æˆ·è¡Œä¸ºæ•°æ®
DELIMITER //
CREATE PROCEDURE process_user_behavior_stream()
BEGIN
    DECLARE behavior_id INT;
    DECLARE user_id INT;
    DECLARE action_type VARCHAR(50);
    DECLARE action_time DATETIME;
    DECLARE page_url VARCHAR(500);
    DECLARE session_id VARCHAR(100);
    DECLARE processed_count INT DEFAULT 0;
    DECLARE done INT DEFAULT FALSE;
    
    -- å¤„ç†æœ€è¿‘5åˆ†é’Ÿçš„è¡Œä¸ºæ•°æ®
    DECLARE stream_cursor CURSOR FOR 
        SELECT id, user_id, action_type, action_time, page_url, session_id
        FROM user_behavior_log 
        WHERE processed = 0 
        AND action_time >= DATE_SUB(NOW(), INTERVAL 5 MINUTE)
        ORDER BY action_time;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN stream_cursor;
    
    stream_loop: LOOP
        FETCH stream_cursor INTO behavior_id, user_id, action_type, 
                                action_time, page_url, session_id;
        IF done THEN
            LEAVE stream_loop;
        END IF;
        
        -- å®æ—¶ç»Ÿè®¡å¤„ç†
        CASE action_type
            WHEN 'page_view' THEN
                -- æ›´æ–°é¡µé¢è®¿é—®ç»Ÿè®¡
                INSERT INTO page_stats (page_url, view_count, last_viewed)
                VALUES (page_url, 1, action_time)
                ON DUPLICATE KEY UPDATE 
                    view_count = view_count + 1,
                    last_viewed = action_time;
                    
            WHEN 'button_click' THEN
                -- æ›´æ–°ç”¨æˆ·æ´»è·ƒåº¦
                UPDATE user_activity 
                SET click_count = click_count + 1,
                    last_active = action_time
                WHERE user_id = user_id AND DATE(activity_date) = DATE(action_time);
                
            WHEN 'purchase' THEN
                -- è§¦å‘å®æ—¶æ¨èæ›´æ–°
                CALL update_user_recommendations(user_id);
                
        END CASE;
        
        -- ä¼šè¯åˆ†æ
        UPDATE user_sessions 
        SET last_activity = action_time,
            action_count = action_count + 1
        WHERE session_id = session_id;
        
        -- æ ‡è®°å·²å¤„ç†
        UPDATE user_behavior_log SET processed = 1 WHERE id = behavior_id;
        SET processed_count = processed_count + 1;
        
        -- æ¯100æ¡æäº¤ä¸€æ¬¡
        IF processed_count % 100 = 0 THEN
            COMMIT;
        END IF;
        
    END LOOP;
    
    CLOSE stream_cursor;
    SELECT CONCAT('å®æ—¶å¤„ç†å®Œæˆï¼Œå¤„ç†è¡Œä¸ºæ•°æ®ï¼š', processed_count, ' æ¡') AS result;
END //
DELIMITER ;
```

**å®æ—¶å¤„ç†åœºæ™¯**ï¼š
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šå®æ—¶ç»Ÿè®¡ç”¨æˆ·æ“ä½œ
- **ç›‘æ§å‘Šè­¦å¤„ç†**ï¼šå®æ—¶æ£€æµ‹å¼‚å¸¸å¹¶å‘é€å‘Šè­¦
- **æ¨èç³»ç»Ÿæ›´æ–°**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºå®æ—¶è°ƒæ•´æ¨è

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ æ¸¸æ ‡æœ¬è´¨ï¼šé€è¡Œå¤„ç†æ•°æ®çš„æ•°æ®åº“"æŒ‡é’ˆ"
ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šå¤§æ•°æ®é‡ã€å¤æ‚é€»è¾‘ã€éœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯
ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿ï¼šå†…å­˜å¯æ§ã€é€»è¾‘çµæ´»ã€é”™è¯¯éš”ç¦»
ğŸ¯ æ€§èƒ½è€ƒè™‘ï¼šæ¯”æ‰¹é‡æ“ä½œæ…¢ï¼Œä½†åœ¨å¤æ‚åœºæ™¯ä¸‹ä¸å¯æ›¿ä»£
```

### 8.2 æ¸¸æ ‡ä½¿ç”¨æœ€ä½³å®è·µ


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨æ¸¸æ ‡**
```
âœ… æ•°æ®é‡å¾ˆå¤§ï¼Œæ— æ³•ä¸€æ¬¡æ€§å¤„ç†
âœ… æ¯è¡Œæ•°æ®éœ€è¦ä¸åŒçš„ä¸šåŠ¡é€»è¾‘
âœ… éœ€è¦ç²¾ç¡®çš„é”™è¯¯æ§åˆ¶å’Œäº‹åŠ¡ç®¡ç†
âœ… å¤æ‚çš„æ•°æ®è½¬æ¢å’Œè®¡ç®—

âŒ ç®€å•çš„æ‰¹é‡æ’å…¥æˆ–æ›´æ–°
âŒ æ•°æ®é‡è¾ƒå°çš„åœºæ™¯
âŒ å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
```

**ğŸ”¹ æ¸¸æ ‡æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```
ğŸ“Š æ‰¹é‡æäº¤ï¼šæ¯å¤„ç†ä¸€å®šæ•°é‡è®°å½•å°±æäº¤äº‹åŠ¡
ğŸ“Š ç´¢å¼•ä¼˜åŒ–ï¼šæ¸¸æ ‡æŸ¥è¯¢è¯­å¥è¦æœ‰åˆé€‚çš„ç´¢å¼•
ğŸ“Š å†…å­˜æ§åˆ¶ï¼šé¿å…åœ¨æ¸¸æ ‡å¾ªç¯ä¸­å£°æ˜å¤§é‡å˜é‡
ğŸ“Š å¼‚å¸¸å¤„ç†ï¼šåˆç†ä½¿ç”¨CONTINUE HANDLER
```

**ğŸ”¹ å¸¸è§åº”ç”¨æ¨¡å¼æ€»ç»“**
```
ğŸ”¸ æ•°æ®è¿ç§»æ¨¡å¼ï¼š
  - åˆ†æ‰¹å¤„ç†ï¼Œæ§åˆ¶äº‹åŠ¡å¤§å°
  - è®°å½•è¿ç§»è¿›åº¦ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
  
ğŸ”¸ æŠ¥è¡¨ç”Ÿæˆæ¨¡å¼ï¼š
  - é€è¡Œè®¡ç®—å¤æ‚ç»Ÿè®¡æŒ‡æ ‡
  - ç”Ÿæˆå¤šç»´åº¦åˆ†ææ•°æ®
  
ğŸ”¸ æ•°æ®æ¸…æ´—æ¨¡å¼ï¼š
  - æ£€æŸ¥æ•°æ®è´¨é‡ï¼Œä¿®å¤é—®é¢˜æ•°æ®
  - è®°å½•æ¸…æ´—æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ª
  
ğŸ”¸ ä¸šåŠ¡é€»è¾‘æ¨¡å¼ï¼š
  - å®ç°å¤æ‚çš„çŠ¶æ€æœºé€»è¾‘
  - å¤„ç†å¤šè¡¨å…³è”çš„å¤æ‚ä¸šåŠ¡
```

### 8.3 å®é™…å·¥ä½œä¸­çš„åº”ç”¨ä»·å€¼


**ğŸ¯ æ•°æ®ç®¡ç†æ–¹é¢**ï¼š
- **å†å²æ•°æ®æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ— ç”¨æ•°æ®
- **æ•°æ®è´¨é‡ç›‘æ§**ï¼šæ£€æŸ¥å’Œä¿®å¤æ•°æ®è´¨é‡é—®é¢˜
- **ç³»ç»Ÿç»´æŠ¤ä»»åŠ¡**ï¼šæ‰§è¡Œå¤æ‚çš„æ•°æ®ç»´æŠ¤æ“ä½œ

**ğŸ¯ ä¸šåŠ¡æ”¯æŒæ–¹é¢**ï¼š
- **æŠ¥è¡¨ç³»ç»Ÿ**ï¼šç”Ÿæˆå¤æ‚çš„ç»Ÿè®¡åˆ†ææŠ¥è¡¨
- **æ•°æ®åŒæ­¥**ï¼šåœ¨ä¸åŒç³»ç»Ÿé—´åŒæ­¥æ•°æ®
- **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šå®ç°å¤æ‚çš„ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨åŒ–

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ¸¸æ ‡æ˜¯é€è¡Œå¤„ç†åˆ©å™¨ï¼Œå¤æ‚é€»è¾‘çš„å¥½å¸®æ‰‹
- å¤§æ•°æ®åœºæ™¯å†…å­˜å‹å¥½ï¼Œåˆ†æ‰¹å¤„ç†é¿å…å¡é¡¿
- æ‰“å¼€å…³é—­è¦æˆå¯¹ï¼Œå¼‚å¸¸å¤„ç†åˆ«å¿˜è®°
- æ€§èƒ½è™½æ…¢ä½†çµæ´»ï¼Œåˆé€‚åœºæ™¯æ˜¾å¨åŠ›