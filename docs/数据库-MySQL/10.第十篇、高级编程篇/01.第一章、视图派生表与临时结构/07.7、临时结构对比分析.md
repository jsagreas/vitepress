---
title: 7ã€ä¸´æ—¶ç»“æ„å¯¹æ¯”åˆ†æ
---
## ğŸ“š ç›®å½•

1. [ä¸´æ—¶ç»“æ„æ¦‚å¿µè§£æ](#1-ä¸´æ—¶ç»“æ„æ¦‚å¿µè§£æ)
2. [ä¸´æ—¶è¡¨vsæ´¾ç”Ÿè¡¨è¯¦è§£](#2-ä¸´æ—¶è¡¨vsæ´¾ç”Ÿè¡¨è¯¦è§£)
3. [å†…å­˜è¡¨vsä¸´æ—¶è¡¨åŒºåˆ«](#3-å†…å­˜è¡¨vsä¸´æ—¶è¡¨åŒºåˆ«)
4. [CTEä¸å­æŸ¥è¯¢å¯¹æ¯”](#4-CTEä¸å­æŸ¥è¯¢å¯¹æ¯”)
5. [æ€§èƒ½å¯¹æ¯”ä¸æµ‹è¯•](#5-æ€§èƒ½å¯¹æ¯”ä¸æµ‹è¯•)
6. [æ‰§è¡Œè®¡åˆ’Extraå­—æ®µè§£è¯»](#6-æ‰§è¡Œè®¡åˆ’Extraå­—æ®µè§£è¯»)
7. [ä½¿ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—](#7-ä½¿ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä¸´æ—¶ç»“æ„æ¦‚å¿µè§£æ


### 1.1 ä»€ä¹ˆæ˜¯ä¸´æ—¶ç»“æ„


ä¸´æ—¶ç»“æ„å°±æ˜¯åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­MySQLåˆ›å»ºçš„**çŸ­æš‚å­˜åœ¨**çš„æ•°æ®å­˜å‚¨å•å…ƒï¼Œç”¨å®Œå°±é”€æ¯ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**
- **ç”Ÿå‘½å‘¨æœŸçŸ­**ï¼šéšæŸ¥è¯¢çš„å¼€å§‹è€Œåˆ›å»ºï¼Œç»“æŸè€Œé”€æ¯
- **ä½œç”¨åŸŸé™åˆ¶**ï¼šåªåœ¨å½“å‰ä¼šè¯æˆ–æŸ¥è¯¢ä¸­å¯è§
- **æ€§èƒ½è¾…åŠ©**ï¼šä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡è€Œå­˜åœ¨

```
æŸ¥è¯¢æ‰§è¡Œæµç¨‹ï¼š
å¼€å§‹æŸ¥è¯¢ â†’ åˆ›å»ºä¸´æ—¶ç»“æ„ â†’ å­˜å‚¨ä¸­é—´ç»“æœ â†’ è¿”å›æœ€ç»ˆç»“æœ â†’ é”€æ¯ä¸´æ—¶ç»“æ„
```

### 1.2 ä¸´æ—¶ç»“æ„çš„åˆ†ç±»


**ğŸ“Š æŒ‰å­˜å‚¨ä½ç½®åˆ†ç±»**
```
å†…å­˜ä¸´æ—¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å†…å­˜ä¸­     â”‚ â† é€Ÿåº¦å¿«ï¼Œå®¹é‡æœ‰é™
â”‚  (RAMå­˜å‚¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç£ç›˜ä¸´æ—¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç£ç›˜ä¸Š     â”‚ â† å®¹é‡å¤§ï¼Œé€Ÿåº¦æ…¢
â”‚  (ç£ç›˜å­˜å‚¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ æŒ‰åˆ›å»ºæ–¹å¼åˆ†ç±»**
- **æ˜¾å¼åˆ›å»º**ï¼šç”¨æˆ·ä¸»åŠ¨åˆ›å»ºçš„ä¸´æ—¶è¡¨
- **éšå¼åˆ›å»º**ï¼šMySQLè‡ªåŠ¨åˆ›å»ºçš„æ´¾ç”Ÿè¡¨
- **æ··åˆæŸ¥è¯¢**ï¼šCTEã€å­æŸ¥è¯¢ç­‰å¤æ‚ç»“æ„

---

## 2. âš–ï¸ ä¸´æ—¶è¡¨vsæ´¾ç”Ÿè¡¨è¯¦è§£


### 2.1 ä¸´æ—¶è¡¨ - æ˜¾å¼åˆ›å»ºçš„ä¸´æ—¶å­˜å‚¨


**ä»€ä¹ˆæ˜¯ä¸´æ—¶è¡¨**ï¼šç”¨æˆ·æ‰‹åŠ¨åˆ›å»ºçš„ä¸´æ—¶æ•°æ®è¡¨ï¼Œå­˜å‚¨ä¸´æ—¶æ•°æ®ã€‚

```sql
-- åˆ›å»ºä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_sales (
    id INT AUTO_INCREMENT PRIMARY KEY,
    product_name VARCHAR(100),
    sales_amount DECIMAL(10,2)
);

-- æ’å…¥æ•°æ®
INSERT INTO temp_sales VALUES 
(NULL, 'iPhone', 5000.00),
(NULL, 'MacBook', 8000.00);

-- æŸ¥è¯¢ä½¿ç”¨
SELECT * FROM temp_sales WHERE sales_amount > 6000;
```

**ğŸ”¸ ä¸´æ—¶è¡¨ç‰¹æ€§**
- **æ‰‹åŠ¨ç®¡ç†**ï¼šéœ€è¦æ˜¾å¼åˆ›å»ºå’Œåˆ é™¤
- **ç‹¬ç«‹å­˜åœ¨**ï¼šæœ‰è‡ªå·±çš„è¡¨ç»“æ„å’Œæ•°æ®
- **ä¼šè¯éš”ç¦»**ï¼šåªå¯¹å½“å‰è¿æ¥å¯è§

### 2.2 æ´¾ç”Ÿè¡¨ - å­æŸ¥è¯¢çš„åˆ«å


**ä»€ä¹ˆæ˜¯æ´¾ç”Ÿè¡¨**ï¼šåœ¨FROMå­å¥ä¸­çš„å­æŸ¥è¯¢ç»“æœï¼Œç»™å®ƒèµ·ä¸ªåˆ«åå°±å«æ´¾ç”Ÿè¡¨ã€‚

```sql
-- æ´¾ç”Ÿè¡¨ç¤ºä¾‹
SELECT d.category, d.avg_price
FROM (
    SELECT category, AVG(price) as avg_price 
    FROM products 
    GROUP BY category
) AS d
WHERE d.avg_price > 100;
```

**ğŸ”¸ æ´¾ç”Ÿè¡¨ç‰¹æ€§**
- **è‡ªåŠ¨ç®¡ç†**ï¼šMySQLè‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯
- **æŸ¥è¯¢ä¸´æ—¶**ï¼šåªåœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´å­˜åœ¨
- **é€æ˜ä½¿ç”¨**ï¼šå¯¹ç”¨æˆ·å®Œå…¨é€æ˜

### 2.3 å…³é”®åŒºåˆ«å¯¹æ¯”


| ç‰¹æ€§ | **ä¸´æ—¶è¡¨** | **æ´¾ç”Ÿè¡¨** | **ä½¿ç”¨å»ºè®®** |
|------|-----------|-----------|-------------|
| ğŸ”¸ **åˆ›å»ºæ–¹å¼** | `æ‰‹åŠ¨CREATE` | `è‡ªåŠ¨ç”Ÿæˆ` | `å¤æ‚é€»è¾‘ç”¨ä¸´æ—¶è¡¨` |
| ğŸ”¸ **ç”Ÿå‘½å‘¨æœŸ** | `ä¼šè¯çº§åˆ«` | `æŸ¥è¯¢çº§åˆ«` | `å¤šæ¬¡ä½¿ç”¨é€‰ä¸´æ—¶è¡¨` |
| ğŸ”¸ **å­˜å‚¨ç»“æ„** | `å®Œæ•´è¡¨ç»“æ„` | `ç»“æœé›†` | `éœ€è¦ç´¢å¼•ç”¨ä¸´æ—¶è¡¨` |
| ğŸ”¸ **æ€§èƒ½å½±å“** | `å¯ä¼˜åŒ–ç´¢å¼•` | `æ¯æ¬¡é‡ç®—` | `é¢‘ç¹æŸ¥è¯¢ç”¨ä¸´æ—¶è¡¨` |

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```sql
-- ä¸´æ—¶è¡¨ï¼šæ•°æ®é¢„å¤„ç†
CREATE TEMPORARY TABLE user_stats AS
SELECT user_id, COUNT(*) as order_count,
       SUM(amount) as total_amount
FROM orders 
WHERE order_date >= '2024-01-01'
GROUP BY user_id;

-- å¤šæ¬¡ä½¿ç”¨ä¸´æ—¶è¡¨
SELECT * FROM user_stats WHERE order_count > 10;
SELECT * FROM user_stats WHERE total_amount > 5000;

-- æ´¾ç”Ÿè¡¨ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢
SELECT u.username, s.order_count
FROM users u
JOIN (
    SELECT user_id, COUNT(*) as order_count
    FROM orders GROUP BY user_id
) s ON u.id = s.user_id;
```

---

## 3. ğŸ’¾ å†…å­˜è¡¨vsä¸´æ—¶è¡¨åŒºåˆ«


### 3.1 å†…å­˜è¡¨ - ENGINE=MEMORY


**ä»€ä¹ˆæ˜¯å†…å­˜è¡¨**ï¼šå®Œå…¨å­˜å‚¨åœ¨å†…å­˜ä¸­çš„æ°¸ä¹…è¡¨ï¼Œæ•°æ®æ–­ç”µä¸¢å¤±ä½†è¡¨ç»“æ„ä¿ç•™ã€‚

```sql
-- åˆ›å»ºå†…å­˜è¡¨
CREATE TABLE memory_cache (
    id INT PRIMARY KEY,
    cache_key VARCHAR(100),
    cache_value TEXT,
    expire_time TIMESTAMP
) ENGINE=MEMORY;
```

**ğŸ”¸ å†…å­˜è¡¨ç‰¹æ€§**
- **æ°¸ä¹…è¡¨ç»“æ„**ï¼šè¡¨å®šä¹‰æŒä¹…ä¿å­˜
- **å†…å­˜æ•°æ®**ï¼šæ•°æ®åªå­˜åœ¨å†…å­˜ä¸­
- **å…¨å±€å¯è§**ï¼šæ‰€æœ‰è¿æ¥éƒ½èƒ½è®¿é—®

### 3.2 ä¸´æ—¶è¡¨ - TEMPORARY


**ä»€ä¹ˆæ˜¯ä¸´æ—¶è¡¨**ï¼šä¸´æ—¶å­˜åœ¨çš„è¡¨ï¼Œè¿æ¥æ–­å¼€åè‡ªåŠ¨åˆ é™¤ã€‚

```sql
-- åˆ›å»ºä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_calculation (
    step INT,
    result DECIMAL(15,4)
);
```

### 3.3 å­˜å‚¨ä½ç½®å¯¹æ¯”å›¾è§£


```
å†…å­˜è¡¨å­˜å‚¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQLå†…å­˜åŒºåŸŸ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¡¨å®šä¹‰(æŒä¹…) â”‚   æ•°æ®(æ˜“å¤±)     â”‚
â”‚   å­˜å‚¨åœ¨      â”‚    å­˜å‚¨åœ¨       â”‚
â”‚  æ•°æ®å­—å…¸     â”‚    å†…å­˜ä¸­       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸´æ—¶è¡¨å­˜å‚¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ä¼šè¯ä¸´æ—¶ç©ºé—´             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¡¨å®šä¹‰(ä¸´æ—¶) â”‚   æ•°æ®(ä¸´æ—¶)     â”‚
â”‚   ä¼šè¯ç»“æŸ     â”‚   ä¼šè¯ç»“æŸ      â”‚
â”‚   è‡ªåŠ¨åˆ é™¤     â”‚   è‡ªåŠ¨åˆ é™¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 é€‚ç”¨åœºæ™¯åˆ†æ


| ä½¿ç”¨åœºæ™¯ | **å†…å­˜è¡¨** | **ä¸´æ—¶è¡¨** | **æœ€ä½³é€‰æ‹©** |
|---------|-----------|-----------|-------------|
| ğŸ”¸ **ç¼“å­˜æ•°æ®** | `âœ… é€‚åˆ` | `âŒ ä¸é€‚åˆ` | `å†…å­˜è¡¨åšç¼“å­˜` |
| ğŸ”¸ **ä¼šè¯è®¡ç®—** | `âŒ è¿‡é‡` | `âœ… å®Œç¾` | `ä¸´æ—¶è¡¨åšè®¡ç®—` |
| ğŸ”¸ **å…±äº«æ•°æ®** | `âœ… é€‚åˆ` | `âŒ éš”ç¦»` | `å†…å­˜è¡¨å¤šç”¨æˆ·` |
| ğŸ”¸ **ä¸€æ¬¡æ€§å¤„ç†** | `âŒ æµªè´¹` | `âœ… åˆé€‚` | `ä¸´æ—¶è¡¨å¤Ÿç”¨` |

---

## 4. ğŸ”„ CTEä¸å­æŸ¥è¯¢å¯¹æ¯”


### 4.1 CTE - é€šç”¨è¡¨è¡¨è¾¾å¼


**ä»€ä¹ˆæ˜¯CTE**ï¼šCommon Table Expressionï¼Œå°±æ˜¯ç»™å¤æ‚æŸ¥è¯¢èµ·ä¸ªåå­—ï¼Œè®©SQLæ›´å¥½è¯»ã€‚

```sql
-- CTEåŸºæœ¬è¯­æ³•
WITH sales_summary AS (
    SELECT department, SUM(amount) as total_sales
    FROM sales 
    WHERE sale_date >= '2024-01-01'
    GROUP BY department
)
SELECT department, total_sales,
       total_sales / (SELECT SUM(total_sales) FROM sales_summary) as percentage
FROM sales_summary
WHERE total_sales > 10000;
```

**ğŸ”¸ CTEç‰¹ç‚¹**
- **å¯è¯»æ€§å¼º**ï¼šå¤æ‚é€»è¾‘åˆ†æ­¥éª¤å†™
- **å¯é‡å¤å¼•ç”¨**ï¼šåŒä¸€æŸ¥è¯¢ä¸­å¤šæ¬¡ä½¿ç”¨
- **é€’å½’æ”¯æŒ**ï¼šå¯ä»¥å®ç°é€’å½’æŸ¥è¯¢

### 4.2 å­æŸ¥è¯¢ - åµŒå¥—æŸ¥è¯¢


**ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢**ï¼šåœ¨ä¸»æŸ¥è¯¢ä¸­åµŒå¥—çš„æŸ¥è¯¢è¯­å¥ã€‚

```sql
-- ç›¸åŒåŠŸèƒ½çš„å­æŸ¥è¯¢
SELECT department,
       (SELECT SUM(amount) FROM sales s2 
        WHERE s2.department = s1.department 
        AND s2.sale_date >= '2024-01-01') as total_sales
FROM (SELECT DISTINCT department FROM sales) s1;
```

### 4.3 å¯è¯»æ€§å¯¹æ¯”


**ğŸ”¸ CTEç‰ˆæœ¬ - æ¸…æ™°æ˜äº†**
```sql
WITH monthly_sales AS (
    SELECT MONTH(sale_date) as month, SUM(amount) as total
    FROM sales GROUP BY MONTH(sale_date)
),
average_monthly AS (
    SELECT AVG(total) as avg_amount FROM monthly_sales
)
SELECT m.month, m.total,
       CASE WHEN m.total > a.avg_amount THEN 'é«˜äºå¹³å‡' ELSE 'ä½äºå¹³å‡' END
FROM monthly_sales m, average_monthly a;
```

**ğŸ”¸ å­æŸ¥è¯¢ç‰ˆæœ¬ - åµŒå¥—å¤æ‚**
```sql
SELECT m.month, m.total,
       CASE WHEN m.total > (
           SELECT AVG(total) FROM (
               SELECT MONTH(sale_date) as month, SUM(amount) as total
               FROM sales GROUP BY MONTH(sale_date)
           ) avg_calc
       ) THEN 'é«˜äºå¹³å‡' ELSE 'ä½äºå¹³å‡' END
FROM (
    SELECT MONTH(sale_date) as month, SUM(amount) as total
    FROM sales GROUP BY MONTH(sale_date)
) m;
```

### 4.4 æ€§èƒ½å½±å“åˆ†æ


| æ€§èƒ½æ–¹é¢ | **CTE** | **å­æŸ¥è¯¢** | **æ€§èƒ½å»ºè®®** |
|---------|---------|-----------|-------------|
| ğŸ”¸ **æ‰§è¡Œè®¡åˆ’** | `ç‰©åŒ–ä¸€æ¬¡` | `å¯èƒ½é‡å¤æ‰§è¡Œ` | `å¤æ‚é€»è¾‘ç”¨CTE` |
| ğŸ”¸ **å†…å­˜ä½¿ç”¨** | `ä¸´æ—¶å­˜å‚¨` | `åµŒå¥—æ‰§è¡Œ` | `å¤§æ•°æ®é‡ç”¨CTE` |
| ğŸ”¸ **ä¼˜åŒ–å™¨å¤„ç†** | `ç‹¬ç«‹ä¼˜åŒ–` | `æ•´ä½“ä¼˜åŒ–` | `ç®€å•æŸ¥è¯¢ç”¨å­æŸ¥è¯¢` |

---

## 5. ğŸ“Š æ€§èƒ½å¯¹æ¯”ä¸æµ‹è¯•


### 5.1 æµ‹è¯•ç¯å¢ƒå‡†å¤‡


```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    customer_id INT,
    product_id INT,
    order_amount DECIMAL(10,2),
    order_date DATE,
    INDEX idx_customer (customer_id),
    INDEX idx_date (order_date)
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_orders (customer_id, product_id, order_amount, order_date)
SELECT 
    FLOOR(RAND() * 1000) + 1,
    FLOOR(RAND() * 100) + 1,
    RAND() * 1000 + 10,
    DATE_ADD('2024-01-01', INTERVAL FLOOR(RAND() * 365) DAY)
FROM 
    (SELECT 1 UNION SELECT 2 UNION SELECT 3) t1,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3) t2,
    (SELECT 1 UNION SELECT 2 UNION SELECT 3) t3;
```

### 5.2 æ€§èƒ½æµ‹è¯•å¯¹æ¯”


**ğŸ”¸ ä¸´æ—¶è¡¨æ–¹æ¡ˆæµ‹è¯•**
```sql
-- æ–¹æ¡ˆ1ï¼šä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE customer_stats AS
SELECT customer_id, 
       COUNT(*) as order_count,
       SUM(order_amount) as total_amount,
       AVG(order_amount) as avg_amount
FROM test_orders 
GROUP BY customer_id;

-- æŸ¥è¯¢æ—¶é—´ï¼šçº¦50ms
SELECT COUNT(*) FROM customer_stats WHERE order_count > 5;
SELECT COUNT(*) FROM customer_stats WHERE total_amount > 1000;
```

**ğŸ”¸ CTEæ–¹æ¡ˆæµ‹è¯•**
```sql
-- æ–¹æ¡ˆ2ï¼šCTE
WITH customer_stats AS (
    SELECT customer_id, 
           COUNT(*) as order_count,
           SUM(order_amount) as total_amount
    FROM test_orders 
    GROUP BY customer_id
)
SELECT COUNT(*) FROM customer_stats WHERE order_count > 5;
-- æŸ¥è¯¢æ—¶é—´ï¼šçº¦80msï¼ˆæ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—ï¼‰
```

**ğŸ”¸ æ´¾ç”Ÿè¡¨æ–¹æ¡ˆæµ‹è¯•**
```sql
-- æ–¹æ¡ˆ3ï¼šæ´¾ç”Ÿè¡¨
SELECT COUNT(*) 
FROM (
    SELECT customer_id, COUNT(*) as order_count
    FROM test_orders 
    GROUP BY customer_id
) d 
WHERE d.order_count > 5;
-- æŸ¥è¯¢æ—¶é—´ï¼šçº¦75ms
```

### 5.3 èµ„æºæ¶ˆè€—ç›‘æ§


**ğŸ“ˆ å†…å­˜ä½¿ç”¨æƒ…å†µ**
```sql
-- æŸ¥çœ‹ä¸´æ—¶è¡¨å ç”¨
SHOW STATUS LIKE 'Created_tmp_%';

-- ç›‘æ§å†…å­˜ä½¿ç”¨
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE 
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN (
    'Created_tmp_disk_tables',
    'Created_tmp_tables'
);
```

**ğŸ“Š èµ„æºæ¶ˆè€—å¯¹æ¯”è¡¨**

| æ–¹æ¡ˆç±»å‹ | **å†…å­˜å ç”¨** | **ç£ç›˜IO** | **CPUä½¿ç”¨** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-----------|-----------|-------------|
| ğŸ”¸ **ä¸´æ—¶è¡¨** | `ä¸­ç­‰` | `ä½` | `ä½` | `å¤šæ¬¡é‡ç”¨` |
| ğŸ”¸ **CTE** | `é«˜` | `ä¸­ç­‰` | `ä¸­ç­‰` | `ä¸€æ¬¡æ€§å¤æ‚æŸ¥è¯¢` |
| ğŸ”¸ **æ´¾ç”Ÿè¡¨** | `ä½` | `é«˜` | `é«˜` | `ç®€å•ä¸´æ—¶è®¡ç®—` |
| ğŸ”¸ **å†…å­˜è¡¨** | `é«˜` | `æä½` | `ä½` | `é¢‘ç¹è®¿é—®ç¼“å­˜` |

---

## 6. ğŸ” æ‰§è¡Œè®¡åˆ’Extraå­—æ®µè§£è¯»


### 6.1 å¸¸è§Extraå­—æ®µå«ä¹‰


**ä»€ä¹ˆæ˜¯Extraå­—æ®µ**ï¼šæ‰§è¡Œè®¡åˆ’ä¸­æ˜¾ç¤ºMySQLå¦‚ä½•å¤„ç†æŸ¥è¯¢çš„é¢å¤–ä¿¡æ¯ã€‚

```sql
-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT customer_id, COUNT(*) 
FROM test_orders 
GROUP BY customer_id 
HAVING COUNT(*) > 10;
```

**ğŸ”¸ ä¸´æ—¶ç»“æ„ç›¸å…³çš„Extraå€¼**

| Extraå­—æ®µ | **å«ä¹‰è§£é‡Š** | **æ€§èƒ½å½±å“** | **ä¼˜åŒ–å»ºè®®** |
|-----------|-------------|-------------|-------------|
| `Using temporary` | `ä½¿ç”¨äº†ä¸´æ—¶è¡¨` | `å¢åŠ å†…å­˜/ç£ç›˜å¼€é”€` | `æ·»åŠ ç´¢å¼•æˆ–é‡å†™æŸ¥è¯¢` |
| `Using filesort` | `ä½¿ç”¨æ–‡ä»¶æ’åº` | `CPUå’ŒIOå¼€é”€å¤§` | `åˆ›å»ºæ’åºç´¢å¼•` |
| `Using where` | `ä½¿ç”¨WHEREè¿‡æ»¤` | `å½±å“è¾ƒå°` | `ä¼˜åŒ–WHEREæ¡ä»¶` |
| `Using index` | `ä»…ä½¿ç”¨ç´¢å¼•` | `æ€§èƒ½æœ€ä½³` | `ä¿æŒç°çŠ¶` |

### 6.2 æ‰§è¡Œè®¡åˆ’ç¤ºä¾‹åˆ†æ


**ğŸ”¸ äº§ç”Ÿä¸´æ—¶è¡¨çš„æŸ¥è¯¢**
```sql
EXPLAIN 
SELECT department, COUNT(*), AVG(salary)
FROM employees 
GROUP BY department 
ORDER BY COUNT(*) DESC;

-- å¯èƒ½çš„Extraå­—æ®µï¼š
-- Using temporary; Using filesort
```

**ğŸ”¸ ä¼˜åŒ–åçš„æŸ¥è¯¢**
```sql
-- æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_dept_salary ON employees(department, salary);

EXPLAIN 
SELECT department, COUNT(*), AVG(salary)
FROM employees 
GROUP BY department 
ORDER BY department;

-- ä¼˜åŒ–åExtraå­—æ®µï¼š
-- Using index
```

### 6.3 Extraå­—æ®µæ€§èƒ½åˆ¤æ–­


```
æ€§èƒ½ç­‰çº§åˆ¤æ–­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€ä¼˜: Using index                      â”‚ â† åªç”¨ç´¢å¼•ï¼Œæœ€å¿«
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è‰¯å¥½: Using where                      â”‚ â† ç®€å•è¿‡æ»¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  ä¸€èˆ¬: Using temporary                  â”‚ â† ä½¿ç”¨ä¸´æ—¶è¡¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¾ƒå·®: Using filesort                   â”‚ â† æ–‡ä»¶æ’åº
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ€å·®: Using temporary; Using filesort  â”‚ â† ä¸´æ—¶è¡¨+æ’åº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. ğŸ¯ ä½¿ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—


### 7.1 å†³ç­–æµç¨‹å›¾


```
æ•°æ®å¤„ç†éœ€æ±‚åˆ†æ
        â”‚
        â–¼
   éœ€è¦å¤šæ¬¡ä½¿ç”¨ï¼Ÿ
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   æ˜¯           å¦
    â”‚           â”‚
    â–¼           â–¼
æ•°æ®é‡å¤§ï¼Ÿ    æŸ¥è¯¢å¤æ‚ï¼Ÿ
 â”Œâ”€â”´â”€â”       â”Œâ”€â”´â”€â”
æ˜¯   å¦      æ˜¯   å¦
â”‚   â”‚       â”‚   â”‚
â–¼   â–¼       â–¼   â–¼
å†…å­˜è¡¨ ä¸´æ—¶è¡¨  CTE æ´¾ç”Ÿè¡¨/å­æŸ¥è¯¢
```

### 7.2 å…·ä½“åœºæ™¯é€‰æ‹©


**ğŸ”¸ æ•°æ®é¢„å¤„ç†åœºæ™¯**
```sql
-- é€‰æ‹©ï¼šä¸´æ—¶è¡¨
-- åŸå› ï¼šéœ€è¦å¤šæ¬¡æŸ¥è¯¢ï¼Œå¯ä»¥å»ºç´¢å¼•ä¼˜åŒ–

CREATE TEMPORARY TABLE processed_data AS
SELECT customer_id, 
       SUM(amount) as total,
       COUNT(*) as orders
FROM raw_orders 
WHERE status = 'completed'
GROUP BY customer_id;

-- æ·»åŠ ç´¢å¼•æå‡åç»­æŸ¥è¯¢æ€§èƒ½
ALTER TABLE processed_data ADD INDEX(customer_id);
ALTER TABLE processed_data ADD INDEX(total);
```

**ğŸ”¸ æŠ¥è¡¨ç”Ÿæˆåœºæ™¯**
```sql
-- é€‰æ‹©ï¼šCTE
-- åŸå› ï¼šé€»è¾‘å¤æ‚ï¼Œéœ€è¦åˆ†æ­¥éª¤å¤„ç†

WITH monthly_data AS (
    SELECT YEAR(order_date) as year,
           MONTH(order_date) as month,
           SUM(amount) as monthly_total
    FROM orders GROUP BY YEAR(order_date), MONTH(order_date)
),
growth_calc AS (
    SELECT year, month, monthly_total,
           LAG(monthly_total) OVER (ORDER BY year, month) as prev_month
    FROM monthly_data
)
SELECT year, month, monthly_total,
       ROUND((monthly_total - prev_month) / prev_month * 100, 2) as growth_rate
FROM growth_calc
WHERE prev_month IS NOT NULL;
```

**ğŸ”¸ ç®€å•è¿‡æ»¤åœºæ™¯**
```sql
-- é€‰æ‹©ï¼šæ´¾ç”Ÿè¡¨
-- åŸå› ï¼šé€»è¾‘ç®€å•ï¼Œä¸€æ¬¡æ€§ä½¿ç”¨

SELECT u.username, s.order_count
FROM users u
JOIN (
    SELECT user_id, COUNT(*) as order_count
    FROM orders 
    WHERE order_date >= CURDATE() - INTERVAL 30 DAY
    GROUP BY user_id
) s ON u.id = s.user_id
WHERE s.order_count > 5;
```

### 7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ”¸ ä¸´æ—¶è¡¨ä¼˜åŒ–ç­–ç•¥**
```sql
-- 1. åˆç†è®¾ç½®ä¸´æ—¶è¡¨å¤§å°
SET SESSION tmp_table_size = 256*1024*1024;  -- 256MB
SET SESSION max_heap_table_size = 256*1024*1024;

-- 2. åŠæ—¶åˆ é™¤ä¸´æ—¶è¡¨
DROP TEMPORARY TABLE IF EXISTS temp_table_name;

-- 3. é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“
CREATE TEMPORARY TABLE fast_temp (...) ENGINE=MEMORY;
```

**ğŸ”¸ CTEä¼˜åŒ–ç­–ç•¥**
```sql
-- 1. é¿å…é€’å½’è¿‡æ·±
WITH RECURSIVE category_tree AS (
    SELECT id, name, parent_id, 1 as level
    FROM categories WHERE parent_id IS NULL
    UNION ALL
    SELECT c.id, c.name, c.parent_id, ct.level + 1
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.id
    WHERE ct.level < 10  -- é™åˆ¶é€’å½’æ·±åº¦
)
SELECT * FROM category_tree;
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä¸´æ—¶ç»“æ„åˆ†ç±»ç†è§£**
- **ä¸´æ—¶è¡¨**ï¼šæ‰‹åŠ¨åˆ›å»ºï¼Œä¼šè¯çº§ç”Ÿå‘½å‘¨æœŸï¼Œå¯å»ºç´¢å¼•ä¼˜åŒ–
- **æ´¾ç”Ÿè¡¨**ï¼šè‡ªåŠ¨ç”Ÿæˆï¼ŒæŸ¥è¯¢çº§ç”Ÿå‘½å‘¨æœŸï¼Œé€æ˜ä½¿ç”¨
- **å†…å­˜è¡¨**ï¼šæ°¸ä¹…è¡¨ç»“æ„ï¼Œå†…å­˜å­˜å‚¨ï¼Œå…¨å±€å¯è§
- **CTE**ï¼šæŸ¥è¯¢åˆ«åï¼Œæå‡å¯è¯»æ€§ï¼Œæ”¯æŒé€’å½’

**ğŸ”¸ æ€§èƒ½ç‰¹ç‚¹è®°å¿†**
- **ä¸´æ—¶è¡¨**ï¼šå¤šæ¬¡ä½¿ç”¨æ—¶æ€§èƒ½æœ€ä½³
- **CTE**ï¼šå¤æ‚é€»è¾‘æ—¶å¯è¯»æ€§æœ€ä½³  
- **æ´¾ç”Ÿè¡¨**ï¼šç®€å•æŸ¥è¯¢æ—¶å¼€é”€æœ€å°
- **å†…å­˜è¡¨**ï¼šé¢‘ç¹è®¿é—®æ—¶é€Ÿåº¦æœ€å¿«

### 8.2 é€‰æ‹©å†³ç­–è¦ç‚¹


**ğŸ”¹ æ ¹æ®ä½¿ç”¨é¢‘æ¬¡é€‰æ‹©**
```
ä¸€æ¬¡æ€§ä½¿ç”¨ â†’ æ´¾ç”Ÿè¡¨/CTE
å¤šæ¬¡ä½¿ç”¨   â†’ ä¸´æ—¶è¡¨/å†…å­˜è¡¨
æ°¸ä¹…ç¼“å­˜   â†’ å†…å­˜è¡¨
```

**ğŸ”¹ æ ¹æ®æ•°æ®é‡é€‰æ‹©**
```
å°æ•°æ®é‡   â†’ ä»»æ„æ–¹æ¡ˆ
å¤§æ•°æ®é‡   â†’ ä¸´æ—¶è¡¨(å¯ç´¢å¼•ä¼˜åŒ–)
è¶…å¤§æ•°æ®   â†’ åˆ†æ‰¹å¤„ç†+ä¸´æ—¶è¡¨
```

**ğŸ”¹ æ ¹æ®é€»è¾‘å¤æ‚åº¦é€‰æ‹©**
```
ç®€å•æŸ¥è¯¢   â†’ æ´¾ç”Ÿè¡¨
å¤æ‚é€»è¾‘   â†’ CTE
æ•°æ®é¢„å¤„ç† â†’ ä¸´æ—¶è¡¨
```

### 8.3 æ€§èƒ½ç›‘æ§è¦ç‚¹


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
- `Created_tmp_tables`ï¼šåˆ›å»ºçš„ä¸´æ—¶è¡¨æ•°é‡
- `Created_tmp_disk_tables`ï¼šç£ç›˜ä¸´æ—¶è¡¨æ•°é‡  
- æ‰§è¡Œè®¡åˆ’Extraå­—æ®µï¼šä¼˜åŒ–ç›®æ ‡æŒ‡ç¤º
- æŸ¥è¯¢å“åº”æ—¶é—´ï¼šæ•´ä½“æ€§èƒ½æŒ‡æ ‡

### 8.4 æœ€ä½³å®è·µå»ºè®®


1. **ğŸ¯ åˆç†é€‰æ‹©**ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„ä¸´æ—¶ç»“æ„
2. **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šç›‘æ§ä¸´æ—¶è¡¨ä½¿ç”¨ï¼ŒåŠæ—¶ä¼˜åŒ–
3. **ğŸ’¾ èµ„æºç®¡ç†**ï¼šè®¾ç½®åˆç†çš„å†…å­˜é™åˆ¶
4. **ğŸ” æ‰§è¡Œè®¡åˆ’**ï¼šå®šæœŸæ£€æŸ¥æ‰§è¡Œè®¡åˆ’ï¼Œå‘ç°ä¼˜åŒ–ç‚¹
5. **ğŸ§¹ åŠæ—¶æ¸…ç†**ï¼šä¸»åŠ¨åˆ é™¤ä¸éœ€è¦çš„ä¸´æ—¶è¡¨

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¸´æ—¶ç»“æ„æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é‡è¦å·¥å…·
- é€‰æ‹©åˆé€‚çš„ç±»å‹æ¯”ç›²ç›®ä½¿ç”¨æ›´é‡è¦
- æ‰§è¡Œè®¡åˆ’æ˜¯æ€§èƒ½è°ƒä¼˜çš„æŒ‡å—é’ˆ
- èµ„æºç›‘æ§æ˜¯æŒç»­ä¼˜åŒ–çš„åŸºç¡€