---
title: 11、临时表监控与诊断
---
## 📚 目录

1. [临时表监控概述](#1-临时表监控概述)
2. [临时表使用统计](#2-临时表使用统计)
3. [创建频率监控](#3-创建频率监控)
4. [大小监控指标](#4-大小监控指标)
5. [性能影响分析](#5-性能影响分析)
6. [问题诊断方法](#6-问题诊断方法)
7. [优化建议生成](#7-优化建议生成)
8. [自动化监控工具](#8-自动化监控工具)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 临时表监控概述


### 1.1 什么是临时表监控


**临时表监控**就是实时跟踪MySQL中临时表的创建、使用和性能影响的过程。

```
临时表监控的作用：
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   发现问题      │───▶│   分析原因      │───▶│   制定优化      │
│ ·创建过多       │    │ ·查询复杂       │    │ ·添加索引       │
│ ·占用内存       │    │ ·缺少索引       │    │ ·优化查询       │
│ ·磁盘写入       │    │ ·数据量大       │    │ ·调整参数       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 监控的重要性


**为什么要监控临时表**：
- **性能影响**：临时表创建过多会拖慢查询速度
- **内存消耗**：大量临时表占用系统内存
- **磁盘IO**：超出内存限制的临时表会写入磁盘
- **系统稳定性**：及时发现并解决临时表相关问题

### 1.3 监控维度


**监控临时表的四个关键维度**：
```
数量维度：创建了多少个临时表
频率维度：多长时间创建一次
大小维度：临时表占用多少空间
影响维度：对系统性能的影响程度
```

---

## 2. 📊 临时表使用统计


### 2.1 基础统计查询


**查看临时表创建统计**：

```sql
-- 查看临时表相关状态变量
SHOW GLOBAL STATUS LIKE 'Created_tmp%';

-- 结果解释：
-- Created_tmp_tables: 创建的临时表总数
-- Created_tmp_disk_tables: 在磁盘上创建的临时表数
-- Created_tmp_files: 创建的临时文件数
```

**实际示例输出**：
```
+-------------------------+--------+
| Variable_name           | Value  |
+-------------------------+--------+
| Created_tmp_tables      | 15234  |
| Created_tmp_disk_tables | 1205   |
| Created_tmp_files       | 89     |
+-------------------------+--------+
```

### 2.2 计算磁盘临时表比例


**分析磁盘临时表占比**：

```sql
-- 计算磁盘临时表比例
SELECT 
    ($$global.Created_tmp_disk_tables / $$global.Created_tmp_tables) * 100 
    AS disk_tmp_table_pct;

-- 比例分析：
-- < 5%：正常范围
-- 5-15%：需要关注
-- > 15%：需要优化
```

### 2.3 Session级别统计


**查看当前会话的临时表使用**：

```sql
-- 重置会话状态
FLUSH STATUS;

-- 执行查询后检查
SHOW SESSION STATUS LIKE 'Created_tmp%';
```

---

## 3. ⏱️ 创建频率监控


### 3.1 实时监控临时表创建


**监控临时表创建频率的思路**：
```
监控方法：
时间点1 ──────▶ 时间点2
状态值A         状态值B

创建频率 = (状态值B - 状态值A) / 时间间隔
```

**实现监控脚本**：

```sql
-- 创建监控表
CREATE TABLE temp_table_monitor (
    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    tmp_tables_total INT,
    tmp_disk_tables INT,
    tmp_files INT
);

-- 定期插入数据的存储过程
DELIMITER //
CREATE PROCEDURE monitor_temp_tables()
BEGIN
    INSERT INTO temp_table_monitor (tmp_tables_total, tmp_disk_tables, tmp_files)
    SELECT 
        variable_value,
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables'),
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_files')
    FROM performance_schema.global_status 
    WHERE variable_name = 'Created_tmp_tables';
END //
DELIMITER ;
```

### 3.2 分析创建趋势


**查看临时表创建趋势**：

```sql
-- 查看最近1小时的创建趋势
SELECT 
    check_time,
    tmp_tables_total,
    tmp_tables_total - LAG(tmp_tables_total) OVER (ORDER BY check_time) AS created_per_interval,
    tmp_disk_tables - LAG(tmp_disk_tables) OVER (ORDER BY check_time) AS disk_tables_per_interval
FROM temp_table_monitor 
WHERE check_time >= NOW() - INTERVAL 1 HOUR
ORDER BY check_time;
```

### 3.3 设置告警阈值


**创建频率告警规则**：
```
告警级别设置：
┌─────────────┬─────────────────┬─────────────────┐
│  告警级别   │   创建频率      │   磁盘表比例    │
├─────────────┼─────────────────┼─────────────────┤
│    正常     │   < 100/分钟    │      < 5%       │
│    警告     │  100-500/分钟   │     5-15%       │
│    严重     │   > 500/分钟    │     > 15%       │
└─────────────┴─────────────────┴─────────────────┘
```

---

## 4. 📏 大小监控指标


### 4.1 内存使用监控


**监控临时表内存使用**：

```sql
-- 查看临时表相关内存参数
SELECT 
    $$tmp_table_size AS tmp_table_size_mb,
    $$max_heap_table_size AS max_heap_table_size_mb,
    $$sort_buffer_size AS sort_buffer_size_mb;

-- 通过Performance Schema查看内存使用
SELECT 
    event_name,
    current_count_used,
    current_size_allocated,
    current_size_allocated / 1024 / 1024 AS size_mb
FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE '%tmp%' OR event_name LIKE '%temp%';
```

### 4.2 使用sys库监控内存


**通过sys库查看线程内存使用**：

```sql
-- 查看各线程的内存使用情况
SELECT 
    thread_id,
    user,
    current_allocated,
    current_allocated / 1024 / 1024 AS allocated_mb
FROM sys.x$memory_by_thread_by_current_bytes 
WHERE current_allocated > 1024 * 1024  -- 大于1MB的线程
ORDER BY current_allocated DESC 
LIMIT 10;
```

### 4.3 磁盘空间监控


**监控临时文件磁盘使用**：

```sql
-- 查看tmpdir设置
SELECT $$tmpdir;

-- 在操作系统层面监控磁盘使用
-- df -h /tmp  (Linux命令)
```

**临时表大小限制设置**：
```
参数配置建议：
┌─────────────────────┬─────────────────┬─────────────────┐
│       参数名        │    建议值       │      说明       │
├─────────────────────┼─────────────────┼─────────────────┤
│  tmp_table_size     │     64MB        │ 内存临时表上限  │
│ max_heap_table_size │     64MB        │ HEAP表大小上限  │
│  sort_buffer_size   │     2MB         │ 排序缓冲区大小  │
└─────────────────────┴─────────────────┴─────────────────┘
```

---

## 5. ⚡ 性能影响分析


### 5.1 Performance Schema事件监控


**监控临时表相关事件**：

```sql
-- 启用临时表事件监控
UPDATE performance_schema.setup_instruments 
SET enabled = 'YES' 
WHERE name LIKE '%tmp%' OR name LIKE '%temp%';

-- 查看临时表事件统计
SELECT 
    event_name,
    count_star AS event_count,
    sum_timer_wait / 1000000000000 AS total_time_sec,
    avg_timer_wait / 1000000000000 AS avg_time_sec
FROM performance_schema.events_statements_summary_global_by_event_name 
WHERE event_name LIKE '%tmp%'
ORDER BY sum_timer_wait DESC;
```

### 5.2 慢查询中的临时表


**分析慢查询中的临时表使用**：

```sql
-- 查看使用临时表的慢查询
SELECT 
    sql_text,
    exec_count,
    avg_timer_wait / 1000000000000 AS avg_time_sec,
    tmp_tables,
    tmp_disk_tables
FROM performance_schema.events_statements_summary_by_digest 
WHERE tmp_tables > 0 
ORDER BY avg_timer_wait DESC 
LIMIT 10;
```

### 5.3 性能影响评估


**临时表性能影响分析框架**：
```
性能影响评估：

内存临时表：
└── 影响较小，主要是内存消耗

磁盘临时表：
├── 创建开销：需要磁盘IO创建文件
├── 读写开销：数据需要写入和读取磁盘
├── 删除开销：查询结束后清理文件
└── 并发影响：大量磁盘IO影响整体性能
```

---

## 6. 🔧 问题诊断方法


### 6.1 定位临时表产生原因


**诊断步骤**：

```sql
-- 1. 找出产生临时表最多的查询
SELECT 
    digest_text,
    count_star AS exec_count,
    sum_tmp_tables AS total_tmp_tables,
    sum_tmp_disk_tables AS total_disk_tmp_tables,
    avg_tmp_tables AS avg_tmp_tables_per_query
FROM performance_schema.events_statements_summary_by_digest 
WHERE sum_tmp_tables > 0 
ORDER BY sum_tmp_tables DESC 
LIMIT 5;

-- 2. 分析具体查询的执行计划
EXPLAIN FORMAT=JSON 
SELECT column1, column2 FROM large_table 
GROUP BY column1 ORDER BY column2;
```

### 6.2 常见临时表产生场景


**临时表产生的典型场景**：

| **场景** | **原因** | **解决方案** |
|---------|---------|-------------|
| `GROUP BY` | **分组操作需要临时存储** | `添加覆盖索引` |
| `ORDER BY` | **排序字段无索引** | `创建排序索引` |
| `DISTINCT` | **去重操作** | `优化查询逻辑` |
| `UNION` | **合并结果集** | `使用UNION ALL` |
| **子查询** | **复杂子查询** | `改写为JOIN` |

### 6.3 诊断工具脚本


**自动诊断脚本**：

```sql
-- 创建临时表诊断视图
CREATE VIEW v_temp_table_analysis AS
SELECT 
    'High temp table creation rate' AS issue_type,
    CONCAT('Created ', 
           (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables'),
           ' temp tables, ',
           ROUND((SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') /
                 (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables') * 100, 2),
           '% on disk') AS details,
    CASE 
        WHEN (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') /
             (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables') > 0.15 
        THEN 'CRITICAL'
        WHEN (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') /
             (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables') > 0.05
        THEN 'WARNING'
        ELSE 'OK'
    END AS severity;
```

---

## 7. 💡 优化建议生成


### 7.1 自动化建议系统


**根据监控数据生成优化建议**：

```sql
-- 创建优化建议存储过程
DELIMITER //
CREATE PROCEDURE generate_temp_table_recommendations()
BEGIN
    DECLARE disk_ratio DECIMAL(5,2);
    DECLARE total_tables INT;
    
    -- 获取统计数据
    SELECT 
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') /
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables')
    INTO disk_ratio;
    
    SELECT variable_value INTO total_tables
    FROM performance_schema.global_status 
    WHERE variable_name = 'Created_tmp_tables';
    
    -- 生成建议
    IF disk_ratio > 0.15 THEN
        SELECT 'URGENT: High disk temp table ratio detected' AS recommendation,
               'Consider increasing tmp_table_size and max_heap_table_size' AS action;
    ELSEIF total_tables > 10000 THEN
        SELECT 'HIGH: Many temp tables created' AS recommendation,
               'Review queries with GROUP BY, ORDER BY, and DISTINCT' AS action;
    ELSE
        SELECT 'OK: Temp table usage within normal range' AS recommendation,
               'Continue monitoring' AS action;
    END IF;
END //
DELIMITER ;
```

### 7.2 优化建议分类


**基于监控结果的优化策略**：

```
优化建议分类：

📈 参数调优：
├── 增加 tmp_table_size
├── 增加 max_heap_table_size  
└── 调整 sort_buffer_size

🔍 查询优化：
├── 添加适当索引
├── 重写复杂子查询
├── 避免不必要的排序
└── 减少大结果集操作

🏗️ 架构优化：
├── 分表分库
├── 读写分离
└── 缓存策略
```

### 7.3 优化效果验证


**验证优化效果的方法**：

```sql
-- 优化前后对比查询
SELECT 
    'Before Optimization' AS period,
    created_tmp_tables,
    created_tmp_disk_tables,
    ROUND(created_tmp_disk_tables/created_tmp_tables*100, 2) AS disk_ratio_pct
FROM (
    SELECT 
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables') AS created_tmp_tables,
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') AS created_tmp_disk_tables
) AS current_stats;
```

---

## 8. 🤖 自动化监控工具


### 8.1 监控脚本框架


**完整的监控脚本结构**：

```sql
-- 创建监控配置表
CREATE TABLE temp_table_monitoring_config (
    id INT PRIMARY KEY AUTO_INCREMENT,
    check_interval_minutes INT DEFAULT 5,
    disk_ratio_warning_threshold DECIMAL(3,2) DEFAULT 0.05,
    disk_ratio_critical_threshold DECIMAL(3,2) DEFAULT 0.15,
    creation_rate_warning_threshold INT DEFAULT 100,
    creation_rate_critical_threshold INT DEFAULT 500
);

-- 创建告警历史表
CREATE TABLE temp_table_alerts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    alert_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    alert_type ENUM('WARNING', 'CRITICAL'),
    metric_name VARCHAR(50),
    current_value DECIMAL(10,2),
    threshold_value DECIMAL(10,2),
    message TEXT
);
```

### 8.2 事件调度器设置


**设置自动化监控任务**：

```sql
-- 启用事件调度器
SET GLOBAL event_scheduler = ON;

-- 创建监控事件
CREATE EVENT temp_table_monitor_event
ON SCHEDULE EVERY 5 MINUTE
STARTS CURRENT_TIMESTAMP
DO
CALL monitor_temp_tables();

-- 创建告警检查事件
CREATE EVENT temp_table_alert_event
ON SCHEDULE EVERY 1 MINUTE
STARTS CURRENT_TIMESTAMP
DO
BEGIN
    DECLARE disk_ratio DECIMAL(5,2);
    
    SELECT 
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_disk_tables') /
        (SELECT variable_value FROM performance_schema.global_status WHERE variable_name = 'Created_tmp_tables')
    INTO disk_ratio;
    
    IF disk_ratio > 0.15 THEN
        INSERT INTO temp_table_alerts (alert_type, metric_name, current_value, threshold_value, message)
        VALUES ('CRITICAL', 'disk_temp_table_ratio', disk_ratio, 0.15, 'High disk temp table ratio detected');
    END IF;
END;
```

### 8.3 外部监控工具集成


**与监控系统集成**：

```
监控工具集成方案：

📊 Prometheus + Grafana：
├── 使用 mysqld_exporter 收集指标
├── 配置临时表相关的监控面板
└── 设置告警规则

📈 Zabbix：
├── 自定义监控项
├── 创建触发器
└── 配置通知方式

📋 Nagios：
├── 编写检查插件
├── 定义服务检查
└── 设置通知策略
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的监控指标


```
🔸 Created_tmp_tables：总临时表创建数
🔸 Created_tmp_disk_tables：磁盘临时表创建数  
🔸 磁盘临时表比例：影响性能的关键指标
🔸 临时表创建频率：系统负载的重要指标
🔸 内存使用情况：通过sys库和Performance Schema监控
```

### 9.2 关键诊断方法


**🔹 问题定位流程**：
```
监控告警 → 查看统计数据 → 分析慢查询 → 检查执行计划 → 制定优化方案
```

**🔹 常用诊断查询**：
```sql
-- 快速检查临时表状态
SHOW GLOBAL STATUS LIKE 'Created_tmp%';

-- 找出问题查询
SELECT digest_text, sum_tmp_tables 
FROM performance_schema.events_statements_summary_by_digest 
WHERE sum_tmp_tables > 0 ORDER BY sum_tmp_tables DESC LIMIT 5;
```

### 9.3 优化策略要点


**🔹 参数优化**：
- **适当增加** `tmp_table_size` 和 `max_heap_table_size`
- **避免设置过大**，防止内存不足

**🔹 查询优化**：
- **添加合适索引**减少临时表创建
- **重写复杂查询**避免不必要的临时表
- **使用LIMIT**限制结果集大小

**🔹 监控策略**：
- **设置合理阈值**：磁盘临时表比例 < 15%
- **定期检查趋势**：关注长期变化
- **自动化告警**：及时发现问题

### 9.4 最佳实践建议


- **建立基线**：记录正常情况下的临时表使用情况
- **定期分析**：每周分析临时表使用趋势和异常查询
- **持续优化**：根据监控结果不断优化查询和配置
- **文档记录**：记录优化过程和效果，便于后续参考

**核心记忆**：
- 临时表监控重在发现性能瓶颈
- 磁盘临时表比例是关键指标
- Performance Schema提供详细的事件信息
- 自动化监控可以及时发现和解决问题