---
title: 5ã€å¼‚å¸¸å¤„ç†ç­–ç•¥è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å¼‚å¸¸å¤„ç†æœºåˆ¶åŸºç¡€](#1-å¼‚å¸¸å¤„ç†æœºåˆ¶åŸºç¡€)
2. [å¼‚å¸¸åˆ†ç±»ç­–ç•¥](#2-å¼‚å¸¸åˆ†ç±»ç­–ç•¥)
3. [å¤„ç†çº§åˆ«å®šä¹‰](#3-å¤„ç†çº§åˆ«å®šä¹‰)
4. [æ¢å¤ç­–ç•¥è®¾è®¡](#4-æ¢å¤ç­–ç•¥è®¾è®¡)
5. [è¡¥å¿æœºåˆ¶ä¸å®¹é”™è®¾è®¡](#5-è¡¥å¿æœºåˆ¶ä¸å®¹é”™è®¾è®¡)
6. [å¼‚å¸¸å¤„ç†æ¶æ„æ¨¡å¼](#6-å¼‚å¸¸å¤„ç†æ¶æ„æ¨¡å¼)
7. [æœ€ä½³å®è·µæŒ‡å—](#7-æœ€ä½³å®è·µæŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯MySQLå¼‚å¸¸å¤„ç†


å¼‚å¸¸å¤„ç†æ˜¯åœ¨æ•°æ®åº“æ“ä½œé‡åˆ°é”™è¯¯æ—¶ï¼Œç³»ç»Ÿé‡‡å–çš„åº”å¯¹æªæ–½ã€‚ç®€å•è¯´å°±æ˜¯å½“SQLæ‰§è¡Œå‡ºé”™æ—¶ï¼Œæˆ‘ä»¬è¦å¦‚ä½•åº”å¯¹ï¼Œæ˜¯ç›´æ¥å´©æºƒè¿˜æ˜¯ä¼˜é›…åœ°å¤„ç†é”™è¯¯ã€‚

**æ ¸å¿ƒç†å¿µ**ï¼š
```
é”™è¯¯æ˜¯ä¸å¯é¿å…çš„ â†’ éœ€è¦è®¾è®¡åº”å¯¹ç­–ç•¥
ç³»ç»Ÿè¦ä¿æŒç¨³å®š â†’ å¼‚å¸¸ä¸èƒ½è®©æ•´ä¸ªç³»ç»Ÿå´©æºƒ  
ç”¨æˆ·ä½“éªŒå‹å¥½ â†’ ç»™ç”¨æˆ·æœ‰æ„ä¹‰çš„é”™è¯¯æç¤º
æ•°æ®ä¿æŒä¸€è‡´ â†’ å¼‚å¸¸å‘ç”Ÿæ—¶æ•°æ®ä¸èƒ½æŸå
```

### 1.2 MySQLå¼‚å¸¸å¤„ç†çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å¤„ç†ï¼Ÿ**

```
ç°å®æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¯·æ±‚       â”‚â”€â”€â”€â–¶â”‚   åº”ç”¨ç¨‹åº        â”‚â”€â”€â”€â–¶â”‚   MySQLæ•°æ®åº“   â”‚
â”‚ (å¯èƒ½æœ‰é—®é¢˜)     â”‚    â”‚ (éœ€è¦å¤„ç†å¼‚å¸¸)    â”‚    â”‚ (å¯èƒ½å‡ºé”™)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                         â†‘                        â†‘
   ç½‘ç»œæ–­å¼€                   å†…å­˜ä¸è¶³                 è¡¨è¢«é”å®š
   è¾“å…¥é”™è¯¯                   é€»è¾‘é”™è¯¯                 ç£ç›˜æ»¡äº†
   å¹¶å‘å†²çª                   æƒé™ä¸è¶³                 ä¸»é”®å†²çª
```

**ä¸å¤„ç†å¼‚å¸¸çš„åæœ**ï¼š
- ğŸ”¥ ç³»ç»Ÿç›´æ¥å´©æºƒï¼Œç”¨æˆ·æ— æ³•ä½¿ç”¨
- ğŸ’” æ•°æ®å¯èƒ½æŸåæˆ–ä¸ä¸€è‡´
- ğŸ¤· ç”¨æˆ·å¾—åˆ°è«åå…¶å¦™çš„é”™è¯¯ä¿¡æ¯
- ğŸ“‰ ç³»ç»Ÿå¯ç”¨æ€§å¤§å¹…ä¸‹é™

### 1.3 å¼‚å¸¸å¤„ç†çš„åŸºæœ¬åŸåˆ™


**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
```
1. æ—©å‘ç°ï¼šå°½æ—©æ£€æµ‹åˆ°å¼‚å¸¸
2. å¿«æ¢å¤ï¼šè¿…é€Ÿä»å¼‚å¸¸ä¸­æ¢å¤
3. å°‘å½±å“ï¼šé™ä½å¼‚å¸¸å¯¹ç³»ç»Ÿçš„å½±å“
4. å¥½ä½“éªŒï¼šç»™ç”¨æˆ·å‹å¥½çš„æç¤º
5. ä¿æ•°æ®ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§
```

---

## 2. ğŸ“Š å¼‚å¸¸åˆ†ç±»ç­–ç•¥


### 2.1 ä¸šåŠ¡å¼‚å¸¸ vs ç³»ç»Ÿå¼‚å¸¸


ç†è§£å¼‚å¸¸çš„æœ¬è´¨ï¼Œæ‰èƒ½åˆ¶å®šæ­£ç¡®çš„å¤„ç†ç­–ç•¥ã€‚æˆ‘ä»¬æŠŠå¼‚å¸¸åˆ†ä¸ºä¸¤å¤§ç±»ï¼š

**ğŸ”¸ ä¸šåŠ¡å¼‚å¸¸ï¼ˆå¯é¢„æœŸçš„é”™è¯¯ï¼‰**

è¿™ç±»å¼‚å¸¸æ˜¯ä¸šåŠ¡é€»è¾‘ä¸­æ­£å¸¸çš„åˆ†æ”¯ï¼Œè™½ç„¶å«"å¼‚å¸¸"ï¼Œä½†å…¶å®æ˜¯å¯ä»¥é¢„æ–™åˆ°çš„æƒ…å†µã€‚

```sql
-- ä¸šåŠ¡å¼‚å¸¸ç¤ºä¾‹ï¼šä½™é¢ä¸è¶³
UPDATE accounts 
SET balance = balance - 1000 
WHERE user_id = 123 AND balance >= 1000;

-- å¦‚æœæ²¡æœ‰æ›´æ–°ä»»ä½•è¡Œï¼Œè¯´æ˜ä½™é¢ä¸è¶³
-- è¿™æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯ç³»ç»Ÿé”™è¯¯
```

| ç‰¹å¾ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| **å¯é¢„æœŸ** | ä¸šåŠ¡æµç¨‹ä¸­çš„æ­£å¸¸åˆ†æ”¯ | å‹å¥½æç¤ºç”¨æˆ· |
| **å¯æ¢å¤** | ç”¨æˆ·å¯ä»¥é‡‡å–è¡ŒåŠ¨è§£å†³ | ç»™å‡ºè§£å†³å»ºè®® |
| **é¢‘ç¹å‘ç”Ÿ** | æ­£å¸¸è¿è¥ä¸­ç»å¸¸é‡åˆ° | è®°å½•ä½†ä¸å‘Šè­¦ |

**ğŸ”¸ ç³»ç»Ÿå¼‚å¸¸ï¼ˆä¸å¯é¢„æœŸçš„é”™è¯¯ï¼‰**

è¿™ç±»å¼‚å¸¸æ˜¯çœŸæ­£çš„"æ„å¤–"ï¼Œé€šå¸¸è¡¨ç¤ºç³»ç»Ÿæˆ–ç¯å¢ƒå‡ºç°äº†é—®é¢˜ã€‚

```sql
-- ç³»ç»Ÿå¼‚å¸¸ç¤ºä¾‹ï¼šè¿æ¥è¶…æ—¶
ERROR 2013 (HY000): Lost connection to MySQL server

-- ç³»ç»Ÿå¼‚å¸¸ç¤ºä¾‹ï¼šç£ç›˜ç©ºé—´ä¸è¶³  
ERROR 1021 (HY000): Disk full (/tmp/)

-- ç³»ç»Ÿå¼‚å¸¸ç¤ºä¾‹ï¼šè¡¨æŸå
ERROR 1194 (HY000): Table is marked as crashed
```

| ç‰¹å¾ | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|------|------|----------|
| **ä¸å¯é¢„æœŸ** | ç³»ç»Ÿç¯å¢ƒé—®é¢˜å¯¼è‡´ | ç«‹å³å‘Šè­¦é€šçŸ¥ |
| **éš¾æ¢å¤** | éœ€è¦æŠ€æœ¯äººå‘˜ä»‹å…¥ | é™çº§æˆ–ç†”æ–­ |
| **å¶å‘** | æ­£å¸¸æƒ…å†µä¸‹ä¸åº”è¯¥å‡ºç° | è¯¦ç»†æ—¥å¿—è®°å½• |

### 2.2 MySQLå¼‚å¸¸åˆ†ç±»ä½“ç³»


**æŒ‰é”™è¯¯ç±»å‹åˆ†ç±»**ï¼š

```
MySQLå¼‚å¸¸åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è¿æ¥å¼‚å¸¸                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¿æ¥è¶…æ—¶ (2013)                       â”‚
â”‚ â€¢ è¿æ¥æ•°è¶…é™ (1040)                     â”‚
â”‚ â€¢ è®¤è¯å¤±è´¥ (1045)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è¯­æ³•å¼‚å¸¸                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ SQLè¯­æ³•é”™è¯¯ (1064)                    â”‚
â”‚ â€¢ è¡¨ä¸å­˜åœ¨ (1146)                       â”‚
â”‚ â€¢ å­—æ®µä¸å­˜åœ¨ (1054)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®å¼‚å¸¸                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä¸»é”®å†²çª (1062)                       â”‚
â”‚ â€¢ å¤–é”®çº¦æŸ (1452)                       â”‚
â”‚ â€¢ æ•°æ®ç±»å‹é”™è¯¯ (1264)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                èµ„æºå¼‚å¸¸                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ é”ç­‰å¾…è¶…æ—¶ (1205)                     â”‚
â”‚ â€¢ ç£ç›˜ç©ºé—´ä¸è¶³ (1021)                   â”‚
â”‚ â€¢ å†…å­˜ä¸è¶³ (1037)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å¼‚å¸¸ä¸¥é‡ç¨‹åº¦åˆ’åˆ†


**ğŸš¨ ä¸¥é‡çº§åˆ«å®šä¹‰**ï¼š

| çº§åˆ« | å®šä¹‰ | å½±å“èŒƒå›´ | å¤„ç†æ—¶é—´ | ç¤ºä¾‹ |
|------|------|----------|----------|------|
| **ğŸ”¥ è‡´å‘½** | ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨ | æ‰€æœ‰ç”¨æˆ· | ç«‹å³ | æ•°æ®åº“å®•æœº |
| **âš ï¸ ä¸¥é‡** | æ ¸å¿ƒåŠŸèƒ½å—å½±å“ | å¤§éƒ¨åˆ†ç”¨æˆ· | 30åˆ†é’Ÿå†… | ä¸»åº“æ•…éšœ |
| **ğŸŸ¡ è­¦å‘Š** | éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸ | å°éƒ¨åˆ†ç”¨æˆ· | 2å°æ—¶å†… | ä»åº“å»¶è¿Ÿ |
| **â„¹ï¸ ä¿¡æ¯** | è½»å¾®é—®é¢˜ | ä¸ªåˆ«ç”¨æˆ· | 24å°æ—¶å†… | æ…¢æŸ¥è¯¢ |

---

## 3. ğŸšï¸ å¤„ç†çº§åˆ«å®šä¹‰


### 3.1 å¤±è´¥å¿«é€Ÿè¿”å›ç­–ç•¥


å½“é‡åˆ°æ— æ³•å¤„ç†çš„å¼‚å¸¸æ—¶ï¼Œæœ€å¥½çš„ç­–ç•¥å¾€å¾€æ˜¯"å¿«é€Ÿå¤±è´¥"ï¼Œè€Œä¸æ˜¯è®©é”™è¯¯ç»§ç»­ä¼ æ’­ã€‚

**ä»€ä¹ˆæ˜¯å¿«é€Ÿå¤±è´¥ï¼Ÿ**

ç®€å•è¯´å°±æ˜¯ä¸€å‘ç°é—®é¢˜å°±ç«‹å³åœæ­¢ï¼Œä¸è¦ç»§ç»­æ‰§è¡Œå¯èƒ½é€ æˆæ›´å¤§æŸå®³çš„æ“ä½œã€‚

```python
# å¿«é€Ÿå¤±è´¥ç¤ºä¾‹
def transfer_money(from_account, to_account, amount):
    # ç«‹å³æ£€æŸ¥å¹¶å¿«é€Ÿå¤±è´¥
    if amount <= 0:
        raise ValueError("è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0")  # å¿«é€Ÿå¤±è´¥
    
    if not account_exists(from_account):
        raise AccountNotFoundError("è½¬å‡ºè´¦æˆ·ä¸å­˜åœ¨")  # å¿«é€Ÿå¤±è´¥
        
    # åªæœ‰é€šè¿‡æ‰€æœ‰æ£€æŸ¥æ‰ç»§ç»­æ‰§è¡Œ
    return do_transfer(from_account, to_account, amount)
```

**ğŸ¯ å¿«é€Ÿå¤±è´¥çš„å¥½å¤„**ï¼š
- âœ… é¿å…é”™è¯¯æ•°æ®çš„è¿›ä¸€æ­¥ä¼ æ’­
- âœ… æ›´å®¹æ˜“å®šä½é—®é¢˜æ ¹æº
- âœ… å‡å°‘ç³»ç»Ÿèµ„æºçš„æµªè´¹
- âœ… æé«˜ç³»ç»Ÿçš„å¯é¢„æµ‹æ€§

### 3.2 å¼‚å¸¸ä¼ æ’­æ§åˆ¶


å¼‚å¸¸åœ¨ç³»ç»Ÿä¸­çš„ä¼ æ’­å°±åƒå¤šç±³è¯ºéª¨ç‰Œï¼Œæˆ‘ä»¬éœ€è¦åœ¨åˆé€‚çš„åœ°æ–¹"æˆªæ–­"ä¼ æ’­é“¾ã€‚

**å¼‚å¸¸ä¼ æ’­é“¾ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·å±‚ â”€â”€å¼‚å¸¸â”€â”€â–¶ æ§åˆ¶å™¨å±‚ â”€â”€å¼‚å¸¸â”€â”€â–¶ æœåŠ¡å±‚ â”€â”€å¼‚å¸¸â”€â”€â–¶ æ•°æ®å±‚
  â†‘                â†‘               â†‘              â†‘
å‹å¥½æç¤º         è®°å½•æ—¥å¿—        ä¸šåŠ¡å¤„ç†      SQLException
```

**ğŸ”§ æ§åˆ¶ç­–ç•¥**ï¼š

```python
# æ•°æ®è®¿é—®å±‚ï¼šè½¬æ¢å¼‚å¸¸
class UserRepository:
    def get_user(self, user_id):
        try:
            return db.query("SELECT * FROM users WHERE id = %s", user_id)
        except MySQLError as e:
            if e.errno == 1146:  # Table doesn't exist
                raise SystemError("ç”¨æˆ·è¡¨ä¸å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
            raise DatabaseError(f"æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {e}")

# æœåŠ¡å±‚ï¼šå¤„ç†ä¸šåŠ¡å¼‚å¸¸
class UserService:
    def get_user_info(self, user_id):
        try:
            user = self.user_repo.get_user(user_id)
            if not user:
                raise BusinessError("ç”¨æˆ·ä¸å­˜åœ¨")  # ä¸šåŠ¡å¼‚å¸¸
            return user
        except DatabaseError:
            # ç³»ç»Ÿå¼‚å¸¸å‘ä¸Šä¼ æ’­ï¼Œä½†è®°å½•æ—¥å¿—
            logger.error(f"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: user_id={user_id}")
            raise

# æ§åˆ¶å™¨å±‚ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†
class UserController:
    def get_user(self, user_id):
        try:
            return self.user_service.get_user_info(user_id)
        except BusinessError as e:
            return {"error": str(e), "code": 400}  # ä¸šåŠ¡å¼‚å¸¸è¿”å›å‹å¥½æç¤º
        except Exception as e:
            logger.error(f"ç³»ç»Ÿå¼‚å¸¸: {e}")
            return {"error": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨", "code": 500}  # ç³»ç»Ÿå¼‚å¸¸éšè—ç»†èŠ‚
```

### 3.3 å¼‚å¸¸å¤„ç†å±‚æ¬¡ç»“æ„


**ğŸ—ï¸ åˆ†å±‚å¤„ç†æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¡¨ç°å±‚ (UI Layer)           â”‚  â† ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
â”‚ â€¢ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯                          â”‚
â”‚ â€¢ å¼•å¯¼ç”¨æˆ·æ“ä½œ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ§åˆ¶å±‚ (Controller)          â”‚  â† å¼‚å¸¸ç»Ÿä¸€å¤„ç†
â”‚ â€¢ æ•è·å¹¶åˆ†ç±»å¼‚å¸¸                        â”‚
â”‚ â€¢ è®°å½•å…³é”®ä¿¡æ¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             æœåŠ¡å±‚ (Service)            â”‚  â† ä¸šåŠ¡é€»è¾‘å¼‚å¸¸å¤„ç†
â”‚ â€¢ ä¸šåŠ¡è§„åˆ™éªŒè¯                          â”‚
â”‚ â€¢ äº‹åŠ¡å¤„ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ•°æ®è®¿é—®å±‚ (DAO)               â”‚  â† SQLå¼‚å¸¸è½¬æ¢
â”‚ â€¢ æ•°æ®åº“å¼‚å¸¸æ•è·                        â”‚
â”‚ â€¢ è¿æ¥å¼‚å¸¸å¤„ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ”„ æ¢å¤ç­–ç•¥è®¾è®¡


### 4.1 è‡ªåŠ¨æ¢å¤æœºåˆ¶


å½“ç³»ç»Ÿé‡åˆ°ä¸´æ—¶æ€§å¼‚å¸¸æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒèƒ½è‡ªåŠ¨æ¢å¤ï¼Œè€Œä¸æ˜¯ç«‹å³æ”¾å¼ƒã€‚

**ğŸ”¸ é‡è¯•ç­–ç•¥**

é‡è¯•å°±æ˜¯åœ¨å¤±è´¥åå†è¯•å‡ æ¬¡ï¼Œä½†è¦èªæ˜åœ°é‡è¯•ï¼Œä¸æ˜¯ç›²ç›®é‡è¯•ã€‚

```python
import time
import random

class RetryStrategy:
    def __init__(self, max_attempts=3, base_delay=1.0):
        self.max_attempts = max_attempts
        self.base_delay = base_delay
    
    def execute_with_retry(self, func, *args, **kwargs):
        for attempt in range(self.max_attempts):
            try:
                return func(*args, **kwargs)
            except (ConnectionError, TimeoutError) as e:
                if attempt == self.max_attempts - 1:
                    raise  # æœ€åä¸€æ¬¡å°è¯•å¤±è´¥ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸
                
                # æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
                delay = self.base_delay * (2 ** attempt) + random.uniform(0, 1)
                print(f"ç¬¬{attempt + 1}æ¬¡å°è¯•å¤±è´¥ï¼Œ{delay:.2f}ç§’åé‡è¯•...")
                time.sleep(delay)
        
# ä½¿ç”¨ç¤ºä¾‹
retry_strategy = RetryStrategy(max_attempts=3, base_delay=0.5)

def query_database():
    # æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
    return db.execute("SELECT COUNT(*) FROM users")

# å¸¦é‡è¯•çš„æ‰§è¡Œ
result = retry_strategy.execute_with_retry(query_database)
```

**ğŸ”¸ é™çº§ç­–ç•¥**

å½“ä¸»è¦åŠŸèƒ½æ— æ³•ä½¿ç”¨æ—¶ï¼Œæä¾›ç®€åŒ–ç‰ˆæœ¬çš„åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»ŸåŸºæœ¬å¯ç”¨ã€‚

```python
class UserService:
    def get_user_profile(self, user_id):
        try:
            # å°è¯•ä»ä¸»æ•°æ®åº“è·å–å®Œæ•´ä¿¡æ¯
            return self.get_full_profile_from_primary(user_id)
        except DatabaseError:
            try:
                # ä¸»åº“å¤±è´¥ï¼Œå°è¯•ä»ç¼“å­˜è·å–
                return self.get_profile_from_cache(user_id)
            except CacheError:
                # ç¼“å­˜ä¹Ÿå¤±è´¥ï¼Œè¿”å›åŸºæœ¬ä¿¡æ¯
                return self.get_basic_profile(user_id)
    
    def get_basic_profile(self, user_id):
        """é™çº§æ–¹æ¡ˆï¼šåªè¿”å›åŸºæœ¬ä¿¡æ¯"""
        return {
            "user_id": user_id,
            "name": "ç”¨æˆ·",  # é»˜è®¤åç§°
            "avatar": "/default-avatar.png",  # é»˜è®¤å¤´åƒ
            "message": "éƒ¨åˆ†ä¿¡æ¯æš‚æ—¶æ— æ³•åŠ è½½"
        }
```

### 4.2 ç†”æ–­å™¨æ¨¡å¼


ç†”æ–­å™¨å°±åƒå®¶é‡Œçš„ç”µè·¯ä¿é™©ä¸ï¼Œå½“ç”µæµè¿‡å¤§æ—¶è‡ªåŠ¨æ–­ç”µä¿æŠ¤ç”µè·¯ã€‚åœ¨è½¯ä»¶ä¸­ï¼Œå½“å¼‚å¸¸ç‡è¿‡é«˜æ—¶è‡ªåŠ¨"æ–­è·¯"ï¼Œé¿å…è¿é”æ•…éšœã€‚

**ğŸ”¸ ç†”æ–­å™¨çŠ¶æ€**ï¼š

```
æ­£å¸¸çŠ¶æ€ (CLOSED)     å¼‚å¸¸çŠ¶æ€ (OPEN)      æ¢å¤çŠ¶æ€ (HALF_OPEN)
      â”‚                    â”‚                      â”‚
  è¯·æ±‚é€šè¿‡                è¯·æ±‚è¢«æ‹’                å°‘é‡è¯·æ±‚è¯•æ¢
      â”‚                    â”‚                      â”‚
  ç›‘æ§å¼‚å¸¸ç‡              ç­‰å¾…æ¢å¤æ—¶é—´            åˆ¤æ–­æ˜¯å¦æ¢å¤
      â”‚                    â”‚                      â”‚
  â†“å¤±è´¥ç‡è¿‡é«˜              â†“æ—¶é—´åˆ°äº†               â†“æˆåŠŸç‡é«˜
      â”‚                    â”‚                      â”‚
  â”€â”€â”€â”€â”€â”€â–¶ OPEN         HALF_OPEN â—€â”€â”€â”€â”€â”€â”€â”€â”€   â”€â”€â”€â”€â”€â”€â–¶ CLOSED
```

```python
import time
from enum import Enum

class CircuitState(Enum):
    CLOSED = "closed"      # æ­£å¸¸çŠ¶æ€
    OPEN = "open"          # æ–­è·¯çŠ¶æ€  
    HALF_OPEN = "half_open"  # åŠå¼€çŠ¶æ€

class CircuitBreaker:
    def __init__(self, failure_threshold=5, recovery_timeout=60, expected_exception=Exception):
        self.failure_threshold = failure_threshold  # å¤±è´¥é˜ˆå€¼
        self.recovery_timeout = recovery_timeout    # æ¢å¤è¶…æ—¶æ—¶é—´
        self.expected_exception = expected_exception
        
        self.failure_count = 0
        self.last_failure_time = None
        self.state = CircuitState.CLOSED
    
    def call(self, func, *args, **kwargs):
        if self.state == CircuitState.OPEN:
            if time.time() - self.last_failure_time > self.recovery_timeout:
                self.state = CircuitState.HALF_OPEN
            else:
                raise Exception("ç†”æ–­å™¨å¼€å¯ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
        
        try:
            result = func(*args, **kwargs)
            self.on_success()
            return result
        except self.expected_exception as e:
            self.on_failure()
            raise
    
    def on_success(self):
        self.failure_count = 0
        if self.state == CircuitState.HALF_OPEN:
            self.state = CircuitState.CLOSED
    
    def on_failure(self):
        self.failure_count += 1
        self.last_failure_time = time.time()
        
        if self.failure_count >= self.failure_threshold:
            self.state = CircuitState.OPEN

# ä½¿ç”¨ç¤ºä¾‹
db_circuit_breaker = CircuitBreaker(failure_threshold=3, recovery_timeout=30)

def get_user_data(user_id):
    return db_circuit_breaker.call(db.query, "SELECT * FROM users WHERE id = %s", user_id)
```

---

## 5. ğŸ› ï¸ è¡¥å¿æœºåˆ¶ä¸å®¹é”™è®¾è®¡


### 5.1 äº‹åŠ¡è¡¥å¿æœºåˆ¶


å½“ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡æ“ä½œç”±å¤šä¸ªæ­¥éª¤ç»„æˆæ—¶ï¼Œå¦‚æœä¸­é—´æŸæ­¥å¤±è´¥äº†ï¼Œæˆ‘ä»¬éœ€è¦"æ’¤é”€"ä¹‹å‰å·²ç»å®Œæˆçš„æ­¥éª¤ã€‚

**ğŸ”¸ Sagaæ¨¡å¼ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡è¡¥å¿ï¼‰**

Sagaæ¨¡å¼å°†ä¸€ä¸ªå¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°äº‹åŠ¡ï¼Œæ¯ä¸ªå°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

```python
class OrderSaga:
    """è®¢å•å¤„ç†çš„Sagaç¤ºä¾‹"""
    
    def __init__(self):
        self.completed_steps = []  # è®°å½•å·²å®Œæˆçš„æ­¥éª¤
    
    def process_order(self, order_data):
        try:
            # æ­¥éª¤1: å‡å°‘åº“å­˜
            self.reduce_inventory(order_data['product_id'], order_data['quantity'])
            self.completed_steps.append('reduce_inventory')
            
            # æ­¥éª¤2: æ‰£é™¤è´¦æˆ·ä½™é¢
            self.deduct_balance(order_data['user_id'], order_data['amount'])
            self.completed_steps.append('deduct_balance')
            
            # æ­¥éª¤3: åˆ›å»ºè®¢å•è®°å½•
            order_id = self.create_order(order_data)
            self.completed_steps.append('create_order')
            
            # æ­¥éª¤4: å‘é€é€šçŸ¥
            self.send_notification(order_data['user_id'], order_id)
            self.completed_steps.append('send_notification')
            
            return order_id
            
        except Exception as e:
            # å‘ç”Ÿå¼‚å¸¸æ—¶æ‰§è¡Œè¡¥å¿æ“ä½œ
            self.compensate()
            raise
    
    def compensate(self):
        """æ‰§è¡Œè¡¥å¿æ“ä½œï¼ŒæŒ‰ç›¸åé¡ºåºæ’¤é”€å·²å®Œæˆçš„æ­¥éª¤"""
        for step in reversed(self.completed_steps):
            try:
                if step == 'send_notification':
                    pass  # é€šçŸ¥æ— éœ€è¡¥å¿
                elif step == 'create_order':
                    self.cancel_order()
                elif step == 'deduct_balance':
                    self.refund_balance()
                elif step == 'reduce_inventory':
                    self.restore_inventory()
            except Exception as e:
                # è¡¥å¿æ“ä½œå¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ç»§ç»­å…¶ä»–è¡¥å¿
                logger.error(f"è¡¥å¿æ“ä½œå¤±è´¥: {step}, {e}")
```

### 5.2 å®¹é”™è®¾è®¡åŸåˆ™


**ğŸ”¸ ä¼˜é›…é™çº§**

ç³»ç»Ÿåœ¨éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸æ—¶ï¼Œä»èƒ½æä¾›æ ¸å¿ƒæœåŠ¡ã€‚

```python
class RecommendationService:
    """æ¨èæœåŠ¡çš„å®¹é”™è®¾è®¡"""
    
    def get_recommendations(self, user_id):
        try:
            # å°è¯•è·å–ä¸ªæ€§åŒ–æ¨è
            return self.get_personalized_recommendations(user_id)
        except RecommendationServiceError:
            try:
                # ä¸ªæ€§åŒ–æ¨èå¤±è´¥ï¼Œä½¿ç”¨çƒ­é—¨æ¨è
                return self.get_popular_recommendations()
            except Exception:
                # çƒ­é—¨æ¨èä¹Ÿå¤±è´¥ï¼Œè¿”å›é»˜è®¤æ¨è
                return self.get_default_recommendations()
    
    def get_default_recommendations(self):
        """é»˜è®¤æ¨èï¼Œæ°¸è¿œä¸ä¼šå¤±è´¥"""
        return [
            {"id": 1, "title": "ç²¾é€‰å•†å“1", "type": "default"},
            {"id": 2, "title": "ç²¾é€‰å•†å“2", "type": "default"}
        ]
```

**ğŸ”¸ è¶…æ—¶æ§åˆ¶**

ä¸ºæ‰€æœ‰å¤–éƒ¨è°ƒç”¨è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…ã€‚

```python
import signal

class TimeoutHandler:
    def __init__(self, timeout_seconds):
        self.timeout_seconds = timeout_seconds
    
    def __enter__(self):
        signal.signal(signal.SIGALRM, self.timeout_handler)
        signal.alarm(self.timeout_seconds)
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        signal.alarm(0)
    
    def timeout_handler(self, signum, frame):
        raise TimeoutError(f"æ“ä½œè¶…æ—¶ ({self.timeout_seconds}ç§’)")

# ä½¿ç”¨ç¤ºä¾‹
def query_external_service():
    try:
        with TimeoutHandler(5):  # 5ç§’è¶…æ—¶
            return db.execute("SELECT * FROM external_table")
    except TimeoutError:
        # è¶…æ—¶åçš„é™çº§å¤„ç†
        return get_cached_data()
```

---

## 6. ğŸ—ï¸ å¼‚å¸¸å¤„ç†æ¶æ„æ¨¡å¼


### 6.1 ç»Ÿä¸€å¼‚å¸¸å¤„ç†ä¸­å¿ƒ


å»ºç«‹ä¸€ä¸ªé›†ä¸­å¼çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œé¿å…åœ¨æ¯ä¸ªåœ°æ–¹éƒ½å†™é‡å¤çš„å¼‚å¸¸å¤„ç†ä»£ç ã€‚

**ğŸ”¸ å¼‚å¸¸å¤„ç†å™¨è®¾è®¡**ï¼š

```python
from typing import Type, Callable, Dict
import logging

class ExceptionHandler:
    """ç»Ÿä¸€å¼‚å¸¸å¤„ç†ä¸­å¿ƒ"""
    
    def __init__(self):
        self.handlers: Dict[Type[Exception], Callable] = {}
        self.logger = logging.getLogger(__name__)
    
    def register(self, exception_type: Type[Exception], handler: Callable):
        """æ³¨å†Œå¼‚å¸¸å¤„ç†å™¨"""
        self.handlers[exception_type] = handler
    
    def handle(self, exception: Exception) -> dict:
        """å¤„ç†å¼‚å¸¸å¹¶è¿”å›ç»Ÿä¸€æ ¼å¼çš„å“åº”"""
        exception_type = type(exception)
        
        # æŸ¥æ‰¾å…·ä½“çš„å¤„ç†å™¨
        handler = self.handlers.get(exception_type)
        if handler:
            return handler(exception)
        
        # æŸ¥æ‰¾çˆ¶ç±»å¤„ç†å™¨
        for exc_type, handler in self.handlers.items():
            if isinstance(exception, exc_type):
                return handler(exception)
        
        # é»˜è®¤å¤„ç†å™¨
        return self.default_handler(exception)
    
    def default_handler(self, exception: Exception) -> dict:
        """é»˜è®¤å¼‚å¸¸å¤„ç†"""
        self.logger.error(f"æœªå¤„ç†çš„å¼‚å¸¸: {exception}", exc_info=True)
        return {
            "error": "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•",
            "code": 500,
            "details": None  # ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²å¼‚å¸¸è¯¦æƒ…
        }

# åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨
exception_handler = ExceptionHandler()

# æ³¨å†Œå…·ä½“çš„å¼‚å¸¸å¤„ç†å™¨
def handle_database_error(e: DatabaseError) -> dict:
    if "connection" in str(e).lower():
        return {"error": "æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•", "code": 503}
    return {"error": "æ•°æ®æ“ä½œå¤±è´¥", "code": 500}

def handle_business_error(e: BusinessError) -> dict:
    return {"error": str(e), "code": 400}

exception_handler.register(DatabaseError, handle_database_error)
exception_handler.register(BusinessError, handle_business_error)
```

### 6.2 å¼‚å¸¸ç›‘æ§ä¸å‘Šè­¦


**ğŸ”¸ å¼‚å¸¸ç›‘æ§æŒ‡æ ‡**ï¼š

```python
class ExceptionMonitor:
    """å¼‚å¸¸ç›‘æ§ç³»ç»Ÿ"""
    
    def __init__(self):
        self.exception_stats = {}
        self.alert_thresholds = {
            DatabaseError: {"count": 10, "time_window": 300},  # 5åˆ†é’Ÿå†…10æ¬¡
            ConnectionError: {"count": 5, "time_window": 60}   # 1åˆ†é’Ÿå†…5æ¬¡
        }
    
    def record_exception(self, exception: Exception):
        """è®°å½•å¼‚å¸¸å¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦"""
        exc_type = type(exception)
        current_time = time.time()
        
        # è®°å½•å¼‚å¸¸
        if exc_type not in self.exception_stats:
            self.exception_stats[exc_type] = []
        
        self.exception_stats[exc_type].append({
            "time": current_time,
            "message": str(exception),
            "traceback": traceback.format_exc()
        })
        
        # æ£€æŸ¥å‘Šè­¦æ¡ä»¶
        self.check_alert(exc_type, current_time)
    
    def check_alert(self, exc_type: Type[Exception], current_time: float):
        """æ£€æŸ¥æ˜¯å¦è§¦å‘å‘Šè­¦"""
        if exc_type not in self.alert_thresholds:
            return
        
        threshold = self.alert_thresholds[exc_type]
        time_window = threshold["time_window"]
        count_limit = threshold["count"]
        
        # ç»Ÿè®¡æ—¶é—´çª—å£å†…çš„å¼‚å¸¸æ•°é‡
        recent_exceptions = [
            exc for exc in self.exception_stats[exc_type]
            if current_time - exc["time"] <= time_window
        ]
        
        if len(recent_exceptions) >= count_limit:
            self.send_alert(exc_type, recent_exceptions)
    
    def send_alert(self, exc_type: Type[Exception], exceptions: list):
        """å‘é€å‘Šè­¦"""
        alert_message = f"""
        âš ï¸ å¼‚å¸¸å‘Šè­¦ âš ï¸
        å¼‚å¸¸ç±»å‹: {exc_type.__name__}
        å‘ç”Ÿæ¬¡æ•°: {len(exceptions)}
        æ—¶é—´èŒƒå›´: {exceptions[-1]['time'] - exceptions[0]['time']:.0f}ç§’
        æœ€æ–°å¼‚å¸¸: {exceptions[-1]['message']}
        """
        
        # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰å‘Šè­¦æ¸ é“
        logger.critical(alert_message)
        # send_email(alert_message)
        # send_sms(alert_message)
```

---

## 7. â­ æœ€ä½³å®è·µæŒ‡å—


### 7.1 å¼‚å¸¸å¤„ç†çš„é»„é‡‘æ³•åˆ™


**ğŸ¯ æ ¸å¿ƒæ³•åˆ™**ï¼š

```
1. å…·ä½“åŒ–åŸåˆ™ï¼šå¼‚å¸¸ä¿¡æ¯è¦å…·ä½“ï¼Œèƒ½å¸®åŠ©å®šä½é—®é¢˜
   âŒ "æ“ä½œå¤±è´¥"
   âœ… "ç”¨æˆ·IDä¸º123çš„è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢100å…ƒï¼Œå°è¯•æ‰£é™¤500å…ƒ"

2. åˆ†å±‚å¤„ç†ï¼šä¸åŒå±‚çº§å¤„ç†ä¸åŒç±»å‹çš„å¼‚å¸¸
   â€¢ æ•°æ®å±‚ï¼šå¤„ç†SQLå¼‚å¸¸ï¼Œè½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
   â€¢ æœåŠ¡å±‚ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘å¼‚å¸¸
   â€¢ æ§åˆ¶å±‚ï¼šç»Ÿä¸€å¼‚å¸¸å“åº”æ ¼å¼

3. å¿«é€Ÿå¤±è´¥ï¼šå‘ç°é—®é¢˜ç«‹å³åœæ­¢ï¼Œä¸è¦è®©é”™è¯¯ä¼ æ’­
   â€¢ å‚æ•°æ ¡éªŒå¤±è´¥ç«‹å³è¿”å›
   â€¢ ä¾èµ–æœåŠ¡ä¸å¯ç”¨ç«‹å³é™çº§

4. ç”¨æˆ·å‹å¥½ï¼šç»™ç”¨æˆ·æœ‰æ„ä¹‰çš„æç¤ºï¼Œè€Œä¸æ˜¯æŠ€æœ¯é”™è¯¯ä¿¡æ¯
   âŒ "SQLException: Duplicate entry '123' for key 'PRIMARY'"
   âœ… "è¯¥ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å"
```

### 7.2 ä»£ç å®è·µè§„èŒƒ


**ğŸ”¸ å¼‚å¸¸å®šä¹‰è§„èŒƒ**ï¼š

```python
# å®šä¹‰ä¸šåŠ¡å¼‚å¸¸åŸºç±»
class BusinessException(Exception):
    """ä¸šåŠ¡å¼‚å¸¸åŸºç±»"""
    def __init__(self, message: str, code: str = None, details: dict = None):
        super().__init__(message)
        self.message = message
        self.code = code or self.__class__.__name__
        self.details = details or {}

# å…·ä½“ä¸šåŠ¡å¼‚å¸¸
class InsufficientBalanceError(BusinessException):
    """ä½™é¢ä¸è¶³å¼‚å¸¸"""
    def __init__(self, current_balance: float, required_amount: float):
        message = f"ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢{current_balance}å…ƒï¼Œéœ€è¦{required_amount}å…ƒ"
        details = {
            "current_balance": current_balance,
            "required_amount": required_amount,
            "shortfall": required_amount - current_balance
        }
        super().__init__(message, "INSUFFICIENT_BALANCE", details)

class UserNotFoundError(BusinessException):
    """ç”¨æˆ·ä¸å­˜åœ¨å¼‚å¸¸"""
    def __init__(self, user_id: str):
        message = f"ç”¨æˆ·ä¸å­˜åœ¨: {user_id}"
        super().__init__(message, "USER_NOT_FOUND", {"user_id": user_id})
```

**ğŸ”¸ å¼‚å¸¸å¤„ç†æ¨¡æ¿**ï¼š

```python
class UserService:
    def transfer_money(self, from_user_id: str, to_user_id: str, amount: float):
        """è½¬è´¦æœåŠ¡çš„å¼‚å¸¸å¤„ç†ç¤ºä¾‹"""
        
        # 1. å‚æ•°æ ¡éªŒ - å¿«é€Ÿå¤±è´¥
        if amount <= 0:
            raise ValueError("è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0")
        
        try:
            # 2. ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
            with database.transaction():
                from_user = self.get_user(from_user_id)
                to_user = self.get_user(to_user_id)
                
                if from_user.balance < amount:
                    raise InsufficientBalanceError(from_user.balance, amount)
                
                # æ‰§è¡Œè½¬è´¦
                from_user.balance -= amount
                to_user.balance += amount
                
                # è®°å½•è½¬è´¦æ—¥å¿—
                self.create_transfer_log(from_user_id, to_user_id, amount)
                
        except BusinessException:
            # ä¸šåŠ¡å¼‚å¸¸ç›´æ¥å‘ä¸ŠæŠ›å‡º
            raise
        except DatabaseError as e:
            # æ•°æ®åº“å¼‚å¸¸è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
            logger.error(f"è½¬è´¦å¤±è´¥ï¼Œæ•°æ®åº“å¼‚å¸¸: {e}")
            raise SystemException("è½¬è´¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
        except Exception as e:
            # æœªçŸ¥å¼‚å¸¸
            logger.error(f"è½¬è´¦å¤±è´¥ï¼ŒæœªçŸ¥å¼‚å¸¸: {e}", exc_info=True)
            raise SystemException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»å®¢æœ")
```

### 7.3 ç›‘æ§ä¸è¿ç»´


**ğŸ”¸ å¼‚å¸¸ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | é˜ˆå€¼å»ºè®® | å¤„ç†åŠ¨ä½œ |
|----------|----------|----------|----------|
| **å¼‚å¸¸ç‡** | å¼‚å¸¸è¯·æ±‚/æ€»è¯·æ±‚ | >5% | ç«‹å³å‘Šè­¦ |
| **å¼‚å¸¸é¢‘ç‡** | æ¯åˆ†é’Ÿå¼‚å¸¸æ•° | >100 | è§¦å‘ç†”æ–­ |
| **æ¢å¤æ—¶é—´** | ä»å¼‚å¸¸åˆ°æ¢å¤çš„æ—¶é—´ | >5åˆ†é’Ÿ | äººå·¥ä»‹å…¥ |
| **é‡è¯•æˆåŠŸç‡** | é‡è¯•æˆåŠŸ/é‡è¯•æ€»æ•° | <50% | åœæ­¢é‡è¯• |

**ğŸ”¸ æ—¥å¿—è®°å½•è§„èŒƒ**ï¼š

```python
import logging
import json
from datetime import datetime

class StructuredLogger:
    """ç»“æ„åŒ–æ—¥å¿—è®°å½•å™¨"""
    
    def __init__(self, name: str):
        self.logger = logging.getLogger(name)
    
    def log_exception(self, exception: Exception, context: dict = None):
        """è®°å½•å¼‚å¸¸æ—¥å¿—"""
        log_data = {
            "timestamp": datetime.now().isoformat(),
            "level": "ERROR",
            "exception_type": type(exception).__name__,
            "exception_message": str(exception),
            "context": context or {},
            "traceback": traceback.format_exc()
        }
        
        self.logger.error(json.dumps(log_data, ensure_ascii=False))
    
    def log_business_event(self, event: str, details: dict):
        """è®°å½•ä¸šåŠ¡äº‹ä»¶"""
        log_data = {
            "timestamp": datetime.now().isoformat(),
            "level": "INFO", 
            "event": event,
            "details": details
        }
        
        self.logger.info(json.dumps(log_data, ensure_ascii=False))

# ä½¿ç”¨ç¤ºä¾‹
logger = StructuredLogger("user_service")

try:
    result = transfer_money(user1, user2, 100)
    logger.log_business_event("money_transfer_success", {
        "from_user": user1,
        "to_user": user2,
        "amount": 100
    })
except InsufficientBalanceError as e:
    logger.log_exception(e, {
        "operation": "transfer_money",
        "from_user": user1,
        "to_user": user2,
        "amount": 100
    })
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¼‚å¸¸åˆ†ç±»ï¼šä¸šåŠ¡å¼‚å¸¸ vs ç³»ç»Ÿå¼‚å¸¸ï¼Œå½±å“å¤„ç†ç­–ç•¥
ğŸ”¸ å¤„ç†çº§åˆ«ï¼šå¿«é€Ÿå¤±è´¥ã€å¼‚å¸¸ä¼ æ’­æ§åˆ¶ã€åˆ†å±‚å¤„ç†
ğŸ”¸ æ¢å¤æœºåˆ¶ï¼šé‡è¯•ç­–ç•¥ã€é™çº§ç­–ç•¥ã€ç†”æ–­å™¨æ¨¡å¼
ğŸ”¸ è¡¥å¿æœºåˆ¶ï¼šäº‹åŠ¡è¡¥å¿ã€Sagaæ¨¡å¼ã€å®¹é”™è®¾è®¡
ğŸ”¸ æ¶æ„æ¨¡å¼ï¼šç»Ÿä¸€å¤„ç†ä¸­å¿ƒã€ç›‘æ§å‘Šè­¦ã€æœ€ä½³å®è·µ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„æœ¬è´¨**
```
å¼‚å¸¸å¤„ç†ä¸æ˜¯ç®€å•çš„try-catch
è€Œæ˜¯ä¸€å¥—å®Œæ•´çš„é”™è¯¯åº”å¯¹ä½“ç³»ï¼š
â€¢ é¢„é˜²ï¼šé€šè¿‡è®¾è®¡å‡å°‘å¼‚å¸¸å‘ç”Ÿ
â€¢ æ£€æµ‹ï¼šåŠæ—¶å‘ç°å¼‚å¸¸æƒ…å†µ  
â€¢ å¤„ç†ï¼šä¼˜é›…åœ°å¤„ç†å¼‚å¸¸
â€¢ æ¢å¤ï¼šå¿«é€Ÿæ¢å¤æ­£å¸¸æœåŠ¡
â€¢ å­¦ä¹ ï¼šä»å¼‚å¸¸ä¸­æ”¹è¿›ç³»ç»Ÿ
```

**ğŸ”¹ è®¾è®¡åŸåˆ™çš„æƒè¡¡**
```
ç”¨æˆ·ä½“éªŒ vs ç³»ç»Ÿç¨³å®šï¼š
â€¢ ä¼˜å…ˆä¿è¯ç³»ç»Ÿç¨³å®šæ€§
â€¢ åœ¨ç¨³å®šåŸºç¡€ä¸Šæå‡ç”¨æˆ·ä½“éªŒ

æ€§èƒ½ vs å¯é æ€§ï¼š
â€¢ å¯é æ€§ä¼˜äºæ€§èƒ½
â€¢ é€šè¿‡ç¼“å­˜ã€å¼‚æ­¥ç­‰æ‰‹æ®µå¹³è¡¡

å¤æ‚åº¦ vs å¯ç»´æŠ¤æ€§ï¼š
â€¢ é€‰æ‹©é€‚åº¦çš„å¤æ‚åº¦
â€¢ è¿‡åº¦è®¾è®¡ä¹Ÿæ˜¯é—®é¢˜
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¡ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **ç”µå•†ç³»ç»Ÿ**ï¼šæ”¯ä»˜å¼‚å¸¸å¤„ç†ã€åº“å­˜ä¸è¶³å¤„ç†ã€è®¢å•è¡¥å¿
- **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“å¼‚å¸¸å›æ»šã€é£æ§å¼‚å¸¸å¤„ç†ã€æ•°æ®ä¸€è‡´æ€§
- **ç¤¾äº¤ç³»ç»Ÿ**ï¼šæ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•ã€ç”¨æˆ·çŠ¶æ€å¼‚å¸¸æ¢å¤
- **ä¼ä¸šç³»ç»Ÿ**ï¼šæ•°æ®åŒæ­¥å¼‚å¸¸ã€ç¬¬ä¸‰æ–¹æ¥å£å¼‚å¸¸ã€æ‰¹å¤„ç†å¤±è´¥

**ğŸ”§ è¿ç»´å®è·µ**ï¼š
- **ç›‘æ§ä½“ç³»**ï¼šå¼‚å¸¸ç‡ç›‘æ§ã€å“åº”æ—¶é—´ç›‘æ§ã€ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
- **å‘Šè­¦æœºåˆ¶**ï¼šåˆ†çº§å‘Šè­¦ã€æ™ºèƒ½é™å™ªã€è‡ªåŠ¨åŒ–å¤„ç†
- **æ•…éšœæ¢å¤**ï¼šå¿«é€Ÿå®šä½ã€è‡ªåŠ¨å›æ»šã€æ‰‹åŠ¨ä»‹å…¥
- **æŒç»­æ”¹è¿›**ï¼šå¼‚å¸¸åˆ†æã€æ ¹å› åˆ†æã€é¢„é˜²æªæ–½

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¼‚å¸¸å¤„ç†æ˜¯ç³»ç»Ÿç¨³å®šæ€§çš„åŸºçŸ³
- åˆ†ç±»å¤„ç†æ¯”ç»Ÿä¸€å¤„ç†æ›´æœ‰æ•ˆ
- å¿«é€Ÿå¤±è´¥æ¯”ç›²ç›®é‡è¯•æ›´å¯é   
- ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿç¨³å®šè¦å¹³è¡¡
- ç›‘æ§å’Œå‘Šè­¦æ˜¯è¿ç»´çš„çœ¼ç›