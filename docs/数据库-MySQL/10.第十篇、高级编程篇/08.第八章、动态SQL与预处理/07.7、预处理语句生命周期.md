---
title: 7ã€é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸ
---
## ğŸ“š ç›®å½•

1. [é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°](#1-é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°)
2. [è¯­å¥å‡†å¤‡é˜¶æ®µè¯¦è§£](#2-è¯­å¥å‡†å¤‡é˜¶æ®µè¯¦è§£)
3. [æ‰§è¡Œé˜¶æ®µç®¡ç†](#3-æ‰§è¡Œé˜¶æ®µç®¡ç†)
4. [èµ„æºé‡Šæ”¾ä¸æ¸…ç†](#4-èµ„æºé‡Šæ”¾ä¸æ¸…ç†)
5. [è¿æ¥ç®¡ç†ä¸è¶…æ—¶å¤„ç†](#5-è¿æ¥ç®¡ç†ä¸è¶…æ—¶å¤„ç†)
6. [ç”Ÿå‘½å‘¨æœŸç›‘æ§ä¸ä¼˜åŒ–](#6-ç”Ÿå‘½å‘¨æœŸç›‘æ§ä¸ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸ


**é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸ**å°±æ˜¯ä¸€æ¡SQLé¢„å¤„ç†è¯­å¥ä»åˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´è¿‡ç¨‹ã€‚

```
ç®€å•ç†è§£ï¼š
å°±åƒç§Ÿæˆ¿å­ä¸€æ · - å…ˆçœ‹æˆ¿(å‡†å¤‡)ã€ç­¾åˆåŒ(æ‰§è¡Œ)ã€æœ€åé€€æˆ¿(é‡Šæ”¾)
é¢„å¤„ç†è¯­å¥ä¹Ÿè¦ç»å†ï¼šå‡†å¤‡ â†’ æ‰§è¡Œ â†’ æ¸…ç† ä¸‰ä¸ªé˜¶æ®µ
```

### 1.2 ç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹


```
å®¢æˆ·ç«¯                     MySQLæœåŠ¡å™¨
   |                          |
   |--[1]PREPARE è¯­å¥--------->|  â† å‡†å¤‡é˜¶æ®µ
   |                          |  â€¢ è§£æSQLè¯­æ³•
   |<-[2]è¿”å›è¯­å¥ID------------|  â€¢ åˆ›å»ºæ‰§è¡Œè®¡åˆ’
   |                          |  â€¢ åˆ†é…æœåŠ¡å™¨èµ„æº
   |                          |
   |--[3]EXECUTE æ‰§è¡Œ--------->|  â† æ‰§è¡Œé˜¶æ®µ
   |   (å¯å¤šæ¬¡é‡å¤)            |  â€¢ ç»‘å®šå‚æ•°å€¼
   |<-[4]è¿”å›ç»“æœé›†------------|  â€¢ æ‰§è¡ŒæŸ¥è¯¢
   |                          |  â€¢ è¿”å›æ•°æ®
   |                          |
   |--[5]DEALLOCATE é‡Šæ”¾------>|  â† é‡Šæ”¾é˜¶æ®µ
   |                          |  â€¢ æ¸…ç†æ‰§è¡Œè®¡åˆ’
   |<-[6]ç¡®è®¤é‡Šæ”¾--------------|  â€¢ é‡Šæ”¾å†…å­˜èµ„æº
   |                          |  â€¢ ç§»é™¤è¯­å¥ç¼“å­˜
```

### 1.3 ç”Ÿå‘½å‘¨æœŸçš„é‡è¦æ€§


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> 
> é¢„å¤„ç†è¯­å¥ä¸æ˜¯ç”¨å®Œå°±è‡ªåŠ¨æ¶ˆå¤±çš„ï¼Œå®ƒä¼šä¸€ç›´å ç”¨æœåŠ¡å™¨èµ„æºï¼Œç›´åˆ°ä½ ä¸»åŠ¨é‡Šæ”¾æˆ–è¿æ¥æ–­å¼€ã€‚
> 
> å°±åƒå€Ÿä¹¦ä¸€æ ·ï¼Œå€Ÿäº†ä¸è¿˜ä¼šä¸€ç›´å ç”¨å›¾ä¹¦é¦†çš„èµ„æºã€‚

**å¸¸è§é—®é¢˜**ï¼š
- å¿˜è®°é‡Šæ”¾è¯­å¥ â†’ å†…å­˜æ³„æ¼
- é‡å¤å‡†å¤‡ç›¸åŒè¯­å¥ â†’ èµ„æºæµªè´¹  
- è¿æ¥æ–­å¼€æœªå¤„ç† â†’ èµ„æºæ®‹ç•™

---

## 2. ğŸš€ è¯­å¥å‡†å¤‡é˜¶æ®µè¯¦è§£


### 2.1 PREPAREè¯­å¥çš„å·¥ä½œåŸç†


**è¯­å¥å‡†å¤‡**å°±æ˜¯å‘Šè¯‰MySQLï¼š"æˆ‘è¦æ‰§è¡Œè¿™ç§ç±»å‹çš„SQLï¼Œä½ å…ˆå¸®æˆ‘å‡†å¤‡å¥½"ã€‚

```sql
-- å‡†å¤‡ä¸€ä¸ªæŸ¥è¯¢è¯­å¥
PREPARE stmt_user_query FROM 
'SELECT id, name, email FROM users WHERE age > ? AND city = ?';

-- å‡†å¤‡ä¸€ä¸ªæ›´æ–°è¯­å¥
PREPARE stmt_user_update FROM 
'UPDATE users SET last_login = NOW() WHERE id = ?';
```

### 2.2 å‡†å¤‡é˜¶æ®µMySQLå†…éƒ¨å¤„ç†


```
â”Œâ”€ è¯­å¥å‡†å¤‡é˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯­æ³•è§£æ                   â”‚ â† æ£€æŸ¥SQLè¯­æ³•æ˜¯å¦æ­£ç¡®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. è¯­ä¹‰åˆ†æ                   â”‚ â† æ£€æŸ¥è¡¨ã€å­—æ®µæ˜¯å¦å­˜åœ¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ç”Ÿæˆæ‰§è¡Œè®¡åˆ’               â”‚ â† å†³å®šå¦‚ä½•æ‰§è¡ŒæŸ¥è¯¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. åˆ†é…è¯­å¥ID                â”‚ â† ç»™è¿™ä¸ªè¯­å¥ä¸€ä¸ªå”¯ä¸€æ ‡è¯†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. ç¼“å­˜åˆ°è¯­å¥æ±                â”‚ â† ä¿å­˜åˆ°å†…å­˜ä¸­ç­‰å¾…æ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// Javaä¸­çš„é¢„å¤„ç†è¯­å¥å‡†å¤‡
public class PreparedStatementLifecycle {
    
    public void prepareStatement() throws SQLException {
        String sql = "SELECT * FROM users WHERE age > ? AND status = ?";
        
        // å‡†å¤‡é˜¶æ®µï¼šåˆ›å»ºé¢„å¤„ç†è¯­å¥
        PreparedStatement pstmt = connection.prepareStatement(sql);
        
        // æ­¤æ—¶MySQLå·²ç»ï¼š
        // 1. è§£æäº†SQLè¯­æ³•
        // 2. ç”Ÿæˆäº†æ‰§è¡Œè®¡åˆ’  
        // 3. åˆ†é…äº†è¯­å¥ID
        // 4. å ç”¨äº†æœåŠ¡å™¨å†…å­˜
        
        System.out.println("è¯­å¥å·²å‡†å¤‡å®Œæˆï¼Œç­‰å¾…æ‰§è¡Œ");
    }
}
```

### 2.3 å‡†å¤‡é˜¶æ®µçš„èµ„æºæ¶ˆè€—


> **âš ï¸ å¸¸è§è¯¯åŒº**
> 
> å¾ˆå¤šäººä»¥ä¸ºPREPAREåªæ˜¯"å‡†å¤‡ä¸€ä¸‹"ï¼Œä¸æ¶ˆè€—èµ„æºã€‚
> å®é™…ä¸Šå‡†å¤‡é˜¶æ®µå°±å·²ç»å ç”¨äº†æœåŠ¡å™¨å†…å­˜å’ŒCPUèµ„æºã€‚

**èµ„æºæ¶ˆè€—åŒ…æ‹¬**ï¼š
- **å†…å­˜**ï¼šå­˜å‚¨è§£æåçš„è¯­å¥ç»“æ„
- **CPU**ï¼šè¯­æ³•åˆ†æå’Œæ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
- **ç¼“å­˜ç©ºé—´**ï¼šåœ¨è¯­å¥æ± ä¸­ä¿å­˜è¯­å¥ä¿¡æ¯

---

## 3. âš¡ æ‰§è¡Œé˜¶æ®µç®¡ç†


### 3.1 EXECUTEè¯­å¥æ‰§è¡Œ


**æ‰§è¡Œé˜¶æ®µ**å°±æ˜¯çœŸæ­£è¿è¡ŒSQLæŸ¥è¯¢ï¼Œè·å–ç»“æœçš„è¿‡ç¨‹ã€‚

```sql
-- è®¾ç½®å‚æ•°å¹¶æ‰§è¡Œ
SET @min_age = 25;
SET @target_city = 'Shanghai';

-- æ‰§è¡Œé¢„å¤„ç†è¯­å¥
EXECUTE stmt_user_query USING @min_age, @target_city;
```

### 3.2 å‚æ•°ç»‘å®šæœºåˆ¶


```
å‚æ•°ç»‘å®šè¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ? (å ä½ç¬¦) â”‚ â†’  â”‚  å®é™…å‚æ•°å€¼  â”‚ â†’  â”‚  æœ€ç»ˆSQL    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ age > ?     â”‚    â”‚ age > 25    â”‚    â”‚ æ‰§è¡ŒæŸ¥è¯¢    â”‚
â”‚ city = ?    â”‚    â”‚ city='ä¸Šæµ·'  â”‚    â”‚ è¿”å›ç»“æœ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Javaä»£ç ç¤ºä¾‹**ï¼š
```java
public List<User> executeQuery(int minAge, String city) throws SQLException {
    // å‚æ•°ç»‘å®š
    pstmt.setInt(1, minAge);        // ç¬¬1ä¸ª?å· = 25
    pstmt.setString(2, city);       // ç¬¬2ä¸ª?å· = "Shanghai"
    
    // æ‰§è¡ŒæŸ¥è¯¢
    ResultSet rs = pstmt.executeQuery();
    
    // å¤„ç†ç»“æœ
    List<User> users = new ArrayList<>();
    while (rs.next()) {
        User user = new User();
        user.setId(rs.getInt("id"));
        user.setName(rs.getString("name"));
        users.add(user);
    }
    
    return users;
}
```

### 3.3 å¤šæ¬¡æ‰§è¡Œçš„ä¼˜åŠ¿


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> 
> é¢„å¤„ç†è¯­å¥çš„æœ€å¤§ä¼˜åŠ¿å°±æ˜¯"å‡†å¤‡ä¸€æ¬¡ï¼Œæ‰§è¡Œå¤šæ¬¡"ã€‚
> 
> å°±åƒåšé¥­ä¸€æ ·ï¼Œèœè°±å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥åå¤ä½¿ç”¨åšå¾ˆå¤šæ¬¡ã€‚

```java
// æ‰¹é‡æ’å…¥ç”¨æˆ·æ•°æ®
public void batchInsertUsers(List<User> users) throws SQLException {
    String sql = "INSERT INTO users (name, email, age) VALUES (?, ?, ?)";
    PreparedStatement pstmt = connection.prepareStatement(sql);
    
    // å‡†å¤‡ä¸€æ¬¡ï¼Œæ‰§è¡Œå¤šæ¬¡
    for (User user : users) {
        pstmt.setString(1, user.getName());
        pstmt.setString(2, user.getEmail());
        pstmt.setInt(3, user.getAge());
        pstmt.executeUpdate();  // é‡å¤æ‰§è¡Œ
    }
    
    pstmt.close();  // æœ€åé‡Šæ”¾
}
```

---

## 4. ğŸ—‘ï¸ èµ„æºé‡Šæ”¾ä¸æ¸…ç†


### 4.1 DEALLOCATEè¯­å¥é‡Šæ”¾


**é‡Šæ”¾é˜¶æ®µ**å°±æ˜¯å‘Šè¯‰MySQLï¼š"æˆ‘ç”¨å®Œäº†ï¼Œå¯ä»¥æ¸…ç†èµ„æºäº†"ã€‚

```sql
-- é‡Šæ”¾é¢„å¤„ç†è¯­å¥
DEALLOCATE PREPARE stmt_user_query;
DEALLOCATE PREPARE stmt_user_update;
```

### 4.2 é‡Šæ”¾æ—¶æœºçš„é€‰æ‹©


| é‡Šæ”¾æ—¶æœº | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|---------|-------------|-----------|
| ğŸ”„ **ç«‹å³é‡Šæ”¾** | `ç”¨å®Œé©¬ä¸Šé‡Šæ”¾` | `ä¸€æ¬¡æ€§æŸ¥è¯¢` | `å®‰å…¨ä½†æ€§èƒ½è¾ƒä½` |
| â° **å»¶è¿Ÿé‡Šæ”¾** | `ä½¿ç”¨å®Œæ¯•åå»¶è¿Ÿé‡Šæ”¾` | `å¯èƒ½é‡å¤ä½¿ç”¨` | `æ€§èƒ½å¥½ä½†å ç”¨èµ„æº` |
| ğŸ”š **è¿æ¥ç»“æŸé‡Šæ”¾** | `è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡Šæ”¾` | `é•¿è¿æ¥åº”ç”¨` | `ç®€å•ä½†å¯èƒ½æ³„æ¼` |

### 4.3 Javaä¸­çš„èµ„æºç®¡ç†


```java
public class ProperResourceManagement {
    
    // æ¨èæ–¹å¼ï¼štry-with-resourcesè‡ªåŠ¨é‡Šæ”¾
    public void queryUsersProper(int minAge) {
        String sql = "SELECT * FROM users WHERE age > ?";
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setInt(1, minAge);
            ResultSet rs = pstmt.executeQuery();
            
            // å¤„ç†ç»“æœ...
            
        } // è‡ªåŠ¨è°ƒç”¨pstmt.close()é‡Šæ”¾èµ„æº
        catch (SQLException e) {
            logger.error("æŸ¥è¯¢å¤±è´¥", e);
        }
    }
    
    // æ‰‹åŠ¨é‡Šæ”¾æ–¹å¼
    public void queryUsersManual(int minAge) {
        PreparedStatement pstmt = null;
        try {
            String sql = "SELECT * FROM users WHERE age > ?";
            pstmt = connection.prepareStatement(sql);
            pstmt.setInt(1, minAge);
            ResultSet rs = pstmt.executeQuery();
            
            // å¤„ç†ç»“æœ...
            
        } catch (SQLException e) {
            logger.error("æŸ¥è¯¢å¤±è´¥", e);
        } finally {
            // æ‰‹åŠ¨é‡Šæ”¾èµ„æº
            if (pstmt != null) {
                try {
                    pstmt.close();
                } catch (SQLException e) {
                    logger.error("é‡Šæ”¾èµ„æºå¤±è´¥", e);
                }
            }
        }
    }
}
```

---

## 5. ğŸ”— è¿æ¥ç®¡ç†ä¸è¶…æ—¶å¤„ç†


### 5.1 è¿æ¥æ–­å¼€å¯¹é¢„å¤„ç†è¯­å¥çš„å½±å“


**è¿æ¥æ–­å¼€**ä¼šè‡ªåŠ¨æ¸…ç†è¯¥è¿æ¥ä¸Šçš„æ‰€æœ‰é¢„å¤„ç†è¯­å¥ã€‚

```
è¿æ¥æ–­å¼€å¤„ç†æµç¨‹ï¼š
â”Œâ”€ æ­£å¸¸æƒ…å†µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿æ¥æ´»è·ƒ â†’ è¯­å¥å­˜åœ¨ â†’ å¯æ­£å¸¸æ‰§è¡Œ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ è¿æ¥æ–­å¼€
â”Œâ”€ æ–­å¼€å â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿æ¥å…³é—­ â†’ è¯­å¥è‡ªåŠ¨æ¸…ç† â†’ èµ„æºé‡Šæ”¾ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è¶…æ—¶ç®¡ç†æœºåˆ¶


```java
public class StatementTimeoutManagement {
    
    public void setStatementTimeout() throws SQLException {
        String sql = "SELECT * FROM large_table WHERE complex_condition = ?";
        PreparedStatement pstmt = connection.prepareStatement(sql);
        
        // è®¾ç½®æŸ¥è¯¢è¶…æ—¶æ—¶é—´(ç§’)
        pstmt.setQueryTimeout(30);  // 30ç§’è¶…æ—¶
        
        try {
            pstmt.setString(1, "some_value");
            ResultSet rs = pstmt.executeQuery();
            // å¤„ç†ç»“æœ...
        } catch (SQLException e) {
            if (e.getMessage().contains("timeout")) {
                logger.warn("æŸ¥è¯¢è¶…æ—¶ï¼Œè¯­å¥è¢«å–æ¶ˆ");
            }
        } finally {
            pstmt.close();
        }
    }
}
```

### 5.3 è¿æ¥æ± ä¸­çš„é¢„å¤„ç†è¯­å¥ç®¡ç†


> **âš ï¸ å¸¸è§è¯¯åŒº**
> 
> åœ¨è¿æ¥æ± ç¯å¢ƒä¸­ï¼Œè¿æ¥è¢«å¤ç”¨ï¼Œé¢„å¤„ç†è¯­å¥ä¹Ÿä¼šè¢«æ„å¤–å¤ç”¨ã€‚
> å¿…é¡»æ­£ç¡®ç®¡ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…è¯­å¥æ³„æ¼ã€‚

```java
public class ConnectionPoolStatementManagement {
    
    // é”™è¯¯æ–¹å¼ï¼šå¯èƒ½å¯¼è‡´è¯­å¥æ³„æ¼
    public void badExample() {
        Connection conn = dataSource.getConnection();
        try {
            PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM users");
            // æ‰§è¡ŒæŸ¥è¯¢...
            
        } finally {
            conn.close();  // è¿æ¥è¿”å›æ± ä¸­ï¼Œä½†pstmtå¯èƒ½æœªé‡Šæ”¾
        }
    }
    
    // æ­£ç¡®æ–¹å¼ï¼šç¡®ä¿è¯­å¥é‡Šæ”¾
    public void goodExample() {
        try (Connection conn = dataSource.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM users")) {
            
            // æ‰§è¡ŒæŸ¥è¯¢...
            
        } // ç¡®ä¿pstmtå’Œconnéƒ½è¢«æ­£ç¡®é‡Šæ”¾
    }
}
```

---

## 6. ğŸ“Š ç”Ÿå‘½å‘¨æœŸç›‘æ§ä¸ä¼˜åŒ–


### 6.1 é¢„å¤„ç†è¯­å¥ç›‘æ§


**MySQLæä¾›äº†å¤šç§æ–¹å¼ç›‘æ§é¢„å¤„ç†è¯­å¥çš„ä½¿ç”¨æƒ…å†µ**ã€‚

```sql
-- æŸ¥çœ‹å½“å‰é¢„å¤„ç†è¯­å¥ç»Ÿè®¡
SHOW STATUS LIKE 'Com_prepare%';
SHOW STATUS LIKE 'Com_execute%';
SHOW STATUS LIKE 'Com_dealloc%';

-- æŸ¥çœ‹é¢„å¤„ç†è¯­å¥ç¼“å­˜ä½¿ç”¨æƒ…å†µ
SHOW STATUS LIKE 'Prepared_stmt_count';
```

### 6.2 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


| ç›‘æ§æŒ‡æ ‡ | **å«ä¹‰** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸æƒ…å†µ** |
|---------|---------|-------------|-------------|
| ğŸ“ˆ **Prepared_stmt_count** | `å½“å‰é¢„å¤„ç†è¯­å¥æ•°é‡` | `< max_prepared_stmt_countçš„80%` | `æ¥è¿‘ä¸Šé™å€¼` |
| ğŸ”„ **Com_prepare** | `PREPAREå‘½ä»¤æ‰§è¡Œæ¬¡æ•°` | `éšä¸šåŠ¡é‡æ­£å¸¸å¢é•¿` | `å¼‚å¸¸å¿«é€Ÿå¢é•¿` |
| âš¡ **Com_execute** | `EXECUTEå‘½ä»¤æ‰§è¡Œæ¬¡æ•°` | `åº”è¯¥ >> Com_prepare` | `æ¯”Com_prepareè¿˜å°‘` |
| ğŸ—‘ï¸ **Com_dealloc_sql** | `DEALLOCATEå‘½ä»¤æ¬¡æ•°` | `æ¥è¿‘Com_prepareæ•°é‡` | `æ˜æ˜¾å°‘äºCom_prepare` |

### 6.3 è‡ªåŠ¨æ¸…ç†æœºåˆ¶é…ç½®


```sql
-- è®¾ç½®é¢„å¤„ç†è¯­å¥ç›¸å…³å‚æ•°
SET GLOBAL max_prepared_stmt_count = 16382;  -- æœ€å¤§é¢„å¤„ç†è¯­å¥æ•°
SET GLOBAL query_cache_type = 0;             -- å…³é—­æŸ¥è¯¢ç¼“å­˜é¿å…å†²çª

-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW VARIABLES LIKE '%prepared%';
```

### 6.4 ç”Ÿå‘½å‘¨æœŸä¼˜åŒ–ç­–ç•¥


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> 
> ä¼˜åŒ–é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒæ˜¯ï¼š"è¯¥å‡†å¤‡æ—¶å‡†å¤‡ï¼Œè¯¥é‡Šæ”¾æ—¶é‡Šæ”¾ï¼Œè¯¥å¤ç”¨æ—¶å¤ç”¨"ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```java
public class StatementLifecycleOptimization {
    
    // ç­–ç•¥1ï¼šè¯­å¥ç¼“å­˜å¤ç”¨
    private static final Map<String, PreparedStatement> statementCache = 
        new ConcurrentHashMap<>();
    
    public PreparedStatement getCachedStatement(String sql) throws SQLException {
        return statementCache.computeIfAbsent(sql, 
            key -> {
                try {
                    return connection.prepareStatement(key);
                } catch (SQLException e) {
                    throw new RuntimeException(e);
                }
            });
    }
    
    // ç­–ç•¥2ï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–
    public void batchOptimization(List<User> users) throws SQLException {
        String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            for (User user : users) {
                pstmt.setString(1, user.getName());
                pstmt.setString(2, user.getEmail());
                pstmt.addBatch();  // æ·»åŠ åˆ°æ‰¹å¤„ç†
            }
            pstmt.executeBatch();  // æ‰¹é‡æ‰§è¡Œ
        }
    }
    
    // ç­–ç•¥3ï¼šåº”ç”¨å…³é—­æ—¶æ¸…ç†
    @PreDestroy
    public void cleanup() {
        statementCache.values().forEach(stmt -> {
            try {
                stmt.close();
            } catch (SQLException e) {
                logger.error("æ¸…ç†é¢„å¤„ç†è¯­å¥å¤±è´¥", e);
            }
        });
        statementCache.clear();
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸä¸‰é˜¶æ®µï¼šå‡†å¤‡(PREPARE) â†’ æ‰§è¡Œ(EXECUTE) â†’ é‡Šæ”¾(DEALLOCATE)
ğŸ”¸ èµ„æºç®¡ç†åŸåˆ™ï¼šå‡†å¤‡ä¼šå ç”¨èµ„æºï¼Œå¿…é¡»ä¸»åŠ¨é‡Šæ”¾é¿å…æ³„æ¼
ğŸ”¸ æ‰§è¡Œä¼˜åŠ¿ï¼šä¸€æ¬¡å‡†å¤‡ï¼Œå¤šæ¬¡æ‰§è¡Œï¼Œæé«˜æ€§èƒ½
ğŸ”¸ è¿æ¥å½±å“ï¼šè¿æ¥æ–­å¼€ä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰é¢„å¤„ç†è¯­å¥
ğŸ”¸ ç›‘æ§é‡è¦æ€§ï¼šé€šè¿‡ç›‘æ§æŒ‡æ ‡å‘ç°å’Œè§£å†³èµ„æºæ³„æ¼é—®é¢˜
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**
```
èµ„æºæœ‰é™æ€§ï¼š
- MySQLæœåŠ¡å™¨å†…å­˜æœ‰é™
- é¢„å¤„ç†è¯­å¥æ•°é‡æœ‰ä¸Šé™
- ä¸é‡Šæ”¾ä¼šå¯¼è‡´èµ„æºè€—å°½

æ€§èƒ½å½±å“ï¼š
- åˆç†å¤ç”¨æé«˜æ‰§è¡Œæ•ˆç‡
- åŠæ—¶é‡Šæ”¾é¿å…å†…å­˜æ³„æ¼
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
- å¤§é‡çŸ­è¿æ¥å¿«é€Ÿåˆ›å»ºé”€æ¯
- éœ€è¦ä¸¥æ ¼æ§åˆ¶è¯­å¥ç”Ÿå‘½å‘¨æœŸ

é•¿è¿æ¥åº”ç”¨ï¼š
- é¢„å¤„ç†è¯­å¥å¯èƒ½é•¿æœŸå­˜åœ¨
- éœ€è¦å®šæœŸæ¸…ç†æ— ç”¨è¯­å¥

è¿æ¥æ± ç¯å¢ƒï¼š
- è¿æ¥å¤ç”¨å¯¼è‡´è¯­å¥æ®‹ç•™
- å¿…é¡»ç¡®ä¿è¯­å¥æ­£ç¡®é‡Šæ”¾
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å¼€å‘å®è·µ**
- **Webåº”ç”¨**ï¼šè¯·æ±‚ç»“æŸç¡®ä¿è¯­å¥é‡Šæ”¾
- **æ‰¹å¤„ç†**ï¼šå¤ç”¨è¯­å¥æé«˜æ‰¹é‡æ“ä½œæ•ˆç‡
- **å¾®æœåŠ¡**ï¼šæœåŠ¡å…³é—­æ—¶æ¸…ç†æ‰€æœ‰é¢„å¤„ç†è¯­å¥
- **æ•°æ®è¿ç§»**ï¼šå¤§æ‰¹é‡æ“ä½œæ—¶åˆç†ç®¡ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸ

**ğŸ”§ è¿ç»´ç›‘æ§**
- **èµ„æºç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥é¢„å¤„ç†è¯­å¥æ•°é‡
- **æ€§èƒ½åˆ†æ**ï¼šåˆ†æPREPARE/EXECUTEæ¯”ä¾‹
- **æ•…éšœæ’æŸ¥**ï¼šé€šè¿‡ç”Ÿå‘½å‘¨æœŸæ—¥å¿—å®šä½é—®é¢˜
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®è¯­å¥ä½¿ç”¨æƒ…å†µè°ƒæ•´å‚æ•°

> **ğŸ” æ·±å…¥æ€è€ƒ**
> 
> é¢„å¤„ç†è¯­å¥ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯èµ„æºç®¡ç†å’Œç³»ç»Ÿè®¾è®¡é—®é¢˜ã€‚
> 
> å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½è®©ç³»ç»Ÿæ›´ç¨³å®šã€æ›´é«˜æ•ˆã€æ›´å¯ç»´æŠ¤ã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é¢„å¤„ç†è¯­å¥ä¸‰æ­¥èµ°ï¼šå‡†å¤‡æ‰§è¡Œå†é‡Šæ”¾
- èµ„æºæœ‰é™è¦çæƒœï¼Œç”¨å®ŒåŠæ—¶è¦æ¸…ç†  
- ä¸€æ¬¡å‡†å¤‡å¤šæ¬¡ç”¨ï¼Œæ€§èƒ½æå‡æœ‰ä¿è¯
- ç›‘æ§æŒ‡æ ‡å¸¸å…³æ³¨ï¼Œå¼‚å¸¸é—®é¢˜æ—©å‘ç°