---
title: 9ã€SQLæ¨¡æ¿æŠ€æœ¯åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [SQLæ¨¡æ¿æŠ€æœ¯æ¦‚è¿°](#1-sqlæ¨¡æ¿æŠ€æœ¯æ¦‚è¿°)
2. [SQLæ¨¡æ¿å¼•æ“æ ¸å¿ƒåŸç†](#2-sqlæ¨¡æ¿å¼•æ“æ ¸å¿ƒåŸç†)
3. [æ¨¡æ¿è¯­æ³•è§„åˆ™è¯¦è§£](#3-æ¨¡æ¿è¯­æ³•è§„åˆ™è¯¦è§£)
4. [å‚æ•°æ›¿æ¢æœºåˆ¶](#4-å‚æ•°æ›¿æ¢æœºåˆ¶)
5. [æ¡ä»¶åˆ†æ”¯æ¨¡æ¿](#5-æ¡ä»¶åˆ†æ”¯æ¨¡æ¿)
6. [å¾ªç¯æ„å»ºæ¨¡æ¿](#6-å¾ªç¯æ„å»ºæ¨¡æ¿)
7. [æ¨¡æ¿ç¼“å­˜ç­–ç•¥](#7-æ¨¡æ¿ç¼“å­˜ç­–ç•¥)
8. [æ¨¡æ¿å®‰å…¨æ€§é˜²æŠ¤](#8-æ¨¡æ¿å®‰å…¨æ€§é˜²æŠ¤)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ SQLæ¨¡æ¿æŠ€æœ¯æ¦‚è¿°


SQLæ¨¡æ¿æŠ€æœ¯å°±æ˜¯æŠŠSQLè¯­å¥å†™æˆæ¨¡æ¿çš„å½¢å¼ï¼Œé€šè¿‡å ä½ç¬¦å’Œå˜é‡æ¥åŠ¨æ€ç”Ÿæˆæœ€ç»ˆçš„SQLã€‚ç®€å•è¯´å°±æ˜¯ï¼š**å…ˆå†™ä¸ªSQLæ¡†æ¶ï¼Œå†å¾€é‡Œé¢å¡«å…·ä½“çš„å€¼**ã€‚

### 1.1 ä»€ä¹ˆæ˜¯SQLæ¨¡æ¿


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```sql
-- ä¼ ç»Ÿå†™æ³•ï¼šæ¯ä¸ªæŸ¥è¯¢éƒ½è¦å•ç‹¬å†™
SELECT * FROM users WHERE name = 'zhangsan';
SELECT * FROM users WHERE age = 25;
SELECT * FROM users WHERE city = 'beijing';

-- æ¨¡æ¿å†™æ³•ï¼šä¸€ä¸ªæ¨¡æ¿æå®šæ‰€æœ‰æƒ…å†µ
SELECT * FROM users WHERE {condition};
```

> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**  
> SQLæ¨¡æ¿å°±åƒå¡«ç©ºé¢˜çš„é¢˜ç›®æ¨¡æ¿ï¼Œæ¯”å¦‚"æˆ‘çš„åå­—æ˜¯___ï¼Œæˆ‘æ¥è‡ª___"ï¼Œä½ åªéœ€è¦åœ¨ç©ºæ ¼é‡Œå¡«å…¥å…·ä½“ä¿¡æ¯å°±èƒ½ç”Ÿæˆå®Œæ•´çš„å¥å­ã€‚

**ğŸ”¹ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
- **ä»£ç é‡å¤**ï¼šé¿å…å†™å¤§é‡ç›¸ä¼¼çš„SQL
- **åŠ¨æ€æŸ¥è¯¢**ï¼šæ ¹æ®æ¡ä»¶çµæ´»ç”Ÿæˆä¸åŒçš„SQL  
- **ç»´æŠ¤å›°éš¾**ï¼šä¸€ä¸ªæ¨¡æ¿æ”¹ä¸€æ¬¡ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½æ›´æ–°
- **å®‰å…¨é£é™©**ï¼šç»Ÿä¸€å¤„ç†SQLæ³¨å…¥é˜²æŠ¤

### 1.2 åº”ç”¨åœºæ™¯å¯¹æ¯”


| åœºæ™¯ç±»å‹ | **ä¼ ç»Ÿæ–¹å¼** | **æ¨¡æ¿æ–¹å¼** | **ä¼˜åŠ¿** |
|---------|-------------|-------------|----------|
| ğŸ” **æ¡ä»¶æŸ¥è¯¢** | `å†™å¤šä¸ªIF-ELSE` | `ä¸€ä¸ªåŠ¨æ€æ¨¡æ¿` | `ä»£ç ç®€æ´` |
| ğŸ“Š **æŠ¥è¡¨ç”Ÿæˆ** | `æ‹¼æ¥å¤§é‡SQLå­—ç¬¦ä¸²` | `æ¨¡æ¿+æ•°æ®å¡«å……` | `é€»è¾‘æ¸…æ™°` |
| ğŸ”„ **æ‰¹é‡æ“ä½œ** | `å¾ªç¯æ‰§è¡Œå›ºå®šSQL` | `å¾ªç¯æ¨¡æ¿ç”Ÿæˆ` | `æ€§èƒ½æ›´å¥½` |
| ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤** | `æ‰‹åŠ¨è½¬ä¹‰æ¯ä¸ªå‚æ•°` | `æ¨¡æ¿è‡ªåŠ¨å¤„ç†` | `æ›´åŠ å®‰å…¨` |

---

## 2. âš™ï¸ SQLæ¨¡æ¿å¼•æ“æ ¸å¿ƒåŸç†


æ¨¡æ¿å¼•æ“å°±æ˜¯æŠŠæ¨¡æ¿å’Œæ•°æ®ç»“åˆèµ·æ¥ï¼Œç”Ÿæˆæœ€ç»ˆSQLçš„"æœºå™¨"ã€‚

### 2.1 å·¥ä½œæµç¨‹å›¾ç¤º


```
è¾“å…¥æ•°æ® â”€â”€â”€â”€â”
             â”œâ”€â†’ æ¨¡æ¿å¼•æ“ â”€â†’ æœ€ç»ˆSQL â”€â†’ æ•°æ®åº“æ‰§è¡Œ
SQLæ¨¡æ¿ â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ¨¡æ¿å¼•æ“                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ æ¨¡æ¿è§£æå™¨    â”‚  ğŸ”„ å‚æ•°å¤„ç†å™¨    â”‚
â”‚  â€¢ è¯­æ³•åˆ†æ       â”‚  â€¢ ç±»å‹è½¬æ¢       â”‚
â”‚  â€¢ æ ‡ç­¾è¯†åˆ«       â”‚  â€¢ å®‰å…¨è¿‡æ»¤       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ›ï¸ æ¡ä»¶å¤„ç†å™¨    â”‚  ğŸ’¾ ç¼“å­˜ç®¡ç†å™¨    â”‚
â”‚  â€¢ IF/ELSEé€»è¾‘    â”‚  â€¢ æ¨¡æ¿ç¼“å­˜       â”‚
â”‚  â€¢ å¾ªç¯æ§åˆ¶       â”‚  â€¢ ç»“æœç¼“å­˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 åŸºæœ¬å®ç°ç¤ºä¾‹


```java
public class SQLTemplateEngine {
    // æ¨¡æ¿ç¼“å­˜
    private Map<String, Template> templateCache = new HashMap<>();
    
    // è§£æå¹¶æ‰§è¡Œæ¨¡æ¿
    public String processTemplate(String templateName, Map<String, Object> params) {
        // 1. è·å–æ¨¡æ¿ï¼ˆä¼˜å…ˆä»ç¼“å­˜ï¼‰
        Template template = getTemplate(templateName);
        
        // 2. å‚æ•°éªŒè¯å’Œé¢„å¤„ç†
        params = validateAndProcess(params);
        
        // 3. æ¨¡æ¿æ¸²æŸ“
        return template.render(params);
    }
}
```

---

## 3. ğŸ“ æ¨¡æ¿è¯­æ³•è§„åˆ™è¯¦è§£


æ¯ä¸ªæ¨¡æ¿å¼•æ“éƒ½æœ‰è‡ªå·±çš„è¯­æ³•è§„åˆ™ï¼Œå°±åƒä¸åŒçš„"æ–¹è¨€"ã€‚

### 3.1 å ä½ç¬¦è¯­æ³•å¯¹æ¯”


**ğŸ”¸ åŸºç¡€å ä½ç¬¦**
```sql
-- æ–¹å¼1ï¼šMyBatisé£æ ¼
SELECT * FROM users WHERE name = #{userName}

-- æ–¹å¼2ï¼šFreemarkeré£æ ¼  
SELECT * FROM users WHERE name = '${userName}'

-- æ–¹å¼3ï¼šMustacheé£æ ¼
SELECT * FROM users WHERE name = '{{userName}}'

-- æ–¹å¼4ï¼šè‡ªå®šä¹‰é£æ ¼
SELECT * FROM users WHERE name = '{userName}'
```

### 3.2 è¯­æ³•è§„åˆ™è¯¦è§£


**ğŸ“‹ MyBatisæ¨¡æ¿è¯­æ³•ï¼ˆæœ€å¸¸ç”¨ï¼‰**
```xml
<!-- åŸºæœ¬å‚æ•°æ›¿æ¢ -->
<select id="findUser">
    SELECT * FROM users 
    WHERE id = #{userId}
    AND status = #{status}
</select>

<!-- åŠ¨æ€WHEREæ¡ä»¶ -->
<select id="searchUsers">
    SELECT * FROM users
    <where>
        <if test="name != null">
            AND name LIKE #{name}
        </if>
        <if test="age != null">
            AND age = #{age}
        </if>
    </where>
</select>
```

> **âš ï¸ é‡è¦åŒºåˆ«**  
> `#{å‚æ•°}` ä¼šè‡ªåŠ¨åŠ å¼•å·å’Œè½¬ä¹‰ï¼ˆå®‰å…¨ï¼‰  
> `${å‚æ•°}` ç›´æ¥æ›¿æ¢ï¼Œä¸åŠ å¼•å·ï¼ˆå±é™©ï¼Œå¯èƒ½SQLæ³¨å…¥ï¼‰

---

## 4. ğŸ”„ å‚æ•°æ›¿æ¢æœºåˆ¶


å‚æ•°æ›¿æ¢å°±æ˜¯æŠŠæ¨¡æ¿ä¸­çš„å ä½ç¬¦æ¢æˆçœŸå®çš„å€¼ã€‚

### 4.1 æ›¿æ¢æœºåˆ¶ç±»å‹


**ğŸ”¸ å®‰å…¨æ›¿æ¢ï¼ˆé¢„å¤„ç†ï¼‰**
```java
// æ¨¡æ¿
String template = "SELECT * FROM users WHERE name = ? AND age = ?";

// å‚æ•°
Object[] params = {"å¼ ä¸‰", 25};

// æœ€ç»ˆç”Ÿæˆï¼ˆæ•°æ®åº“å±‚é¢å¤„ç†ï¼‰
PreparedStatement ps = conn.prepareStatement(template);
ps.setString(1, "å¼ ä¸‰");
ps.setInt(2, 25);
```

**ğŸ”¸ ç›´æ¥æ›¿æ¢ï¼ˆå­—ç¬¦ä¸²æ›¿æ¢ï¼‰**
```java
// æ¨¡æ¿
String template = "SELECT * FROM users WHERE name = '{name}' AND age = {age}";

// å‚æ•°
Map<String, Object> params = Map.of("name", "å¼ ä¸‰", "age", 25);

// æœ€ç»ˆSQL
String sql = "SELECT * FROM users WHERE name = 'å¼ ä¸‰' AND age = 25";
```

### 4.2 ç±»å‹è½¬æ¢å¤„ç†


```java
public class ParameterConverter {
    
    public String convertParameter(Object value, String sqlType) {
        if (value == null) return "NULL";
        
        switch (sqlType.toUpperCase()) {
            case "STRING":
            case "VARCHAR":
                return "'" + escapeString(value.toString()) + "'";
                
            case "INT":
            case "BIGINT":
                return String.valueOf(((Number) value).longValue());
                
            case "DATE":
                return "'" + formatDate((Date) value) + "'";
                
            default:
                return value.toString();
        }
    }
}
```

### 4.3 å‚æ•°éªŒè¯æœºåˆ¶


```java
// å‚æ•°æ ¡éªŒç¤ºä¾‹
public void validateParameters(Map<String, Object> params, Template template) {
    // æ£€æŸ¥å¿…éœ€å‚æ•°
    for (String required : template.getRequiredParams()) {
        if (!params.containsKey(required)) {
            throw new IllegalArgumentException("ç¼ºå°‘å¿…éœ€å‚æ•°: " + required);
        }
    }
    
    // æ£€æŸ¥å‚æ•°ç±»å‹
    for (Entry<String, Object> entry : params.entrySet()) {
        String expectedType = template.getParameterType(entry.getKey());
        if (!isValidType(entry.getValue(), expectedType)) {
            throw new IllegalArgumentException("å‚æ•°ç±»å‹é”™è¯¯: " + entry.getKey());
        }
    }
}
```

---

## 5. ğŸ›ï¸ æ¡ä»¶åˆ†æ”¯æ¨¡æ¿


æ¡ä»¶åˆ†æ”¯å°±æ˜¯æ ¹æ®ä¸åŒæƒ…å†µç”Ÿæˆä¸åŒçš„SQLç‰‡æ®µï¼Œå°±åƒç¨‹åºé‡Œçš„if-elseã€‚

### 5.1 åŸºæœ¬æ¡ä»¶è¯­æ³•


**ğŸ”¸ ç®€å•æ¡ä»¶åˆ¤æ–­**
```xml
<select id="findUsers">
    SELECT * FROM users
    WHERE 1=1
    <if test="name != null">
        AND name = #{name}
    </if>
    <if test="age != null">
        AND age = #{age}
    </if>
</select>
```

**ğŸ”¸ å¤šé‡æ¡ä»¶é€‰æ‹©**
```xml
<select id="getUsersByType">
    SELECT * FROM users
    <where>
        <choose>
            <when test="type == 'vip'">
                AND level >= 5
            </when>
            <when test="type == 'normal'">
                AND level BETWEEN 1 AND 4
            </when>
            <otherwise>
                AND level = 0
            </otherwise>
        </choose>
    </where>
</select>
```

### 5.2 æ¡ä»¶ç»„åˆæ¡ˆä¾‹


```xml
<!-- å¤æ‚æœç´¢æ¡ä»¶ -->
<select id="searchProducts">
    SELECT * FROM products
    <where>
        <!-- å¿…å¡«æ¡ä»¶ï¼šçŠ¶æ€ -->
        status = 'active'
        
        <!-- å¯é€‰æ¡ä»¶ï¼šåˆ†ç±» -->
        <if test="categoryId != null">
            AND category_id = #{categoryId}
        </if>
        
        <!-- å¯é€‰æ¡ä»¶ï¼šä»·æ ¼èŒƒå›´ -->
        <if test="minPrice != null">
            AND price >= #{minPrice}
        </if>
        <if test="maxPrice != null">
            AND price <= #{maxPrice}
        </if>
        
        <!-- å¯é€‰æ¡ä»¶ï¼šå…³é”®å­—æœç´¢ -->
        <if test="keyword != null and keyword != ''">
            AND (name LIKE #{keyword} OR description LIKE #{keyword})
        </if>
    </where>
    
    <!-- åŠ¨æ€æ’åº -->
    <if test="orderBy != null">
        ORDER BY ${orderBy}
    </if>
</select>
```

### 5.3 æ¡ä»¶å¤„ç†å®ç°


```java
public class ConditionProcessor {
    
    public String processCondition(String template, Map<String, Object> params) {
        StringBuilder sql = new StringBuilder();
        
        // è§£æIFæ¡ä»¶
        Pattern ifPattern = Pattern.compile("<if test=\"([^\"]+)\">(.*?)</if>", 
                                          Pattern.DOTALL);
        Matcher matcher = ifPattern.matcher(template);
        
        while (matcher.find()) {
            String condition = matcher.group(1);  // test="name != null"
            String content = matcher.group(2);    // AND name = #{name}
            
            if (evaluateCondition(condition, params)) {
                sql.append(content);
            }
        }
        
        return sql.toString();
    }
    
    // æ¡ä»¶æ±‚å€¼
    private boolean evaluateCondition(String condition, Map<String, Object> params) {
        // ç®€åŒ–ç‰ˆæ¡ä»¶è§£æ
        if (condition.contains("!= null")) {
            String paramName = condition.split(" ")[0];
            return params.get(paramName) != null;
        }
        return false;
    }
}
```

---

## 6. ğŸ” å¾ªç¯æ„å»ºæ¨¡æ¿


å¾ªç¯æ¨¡æ¿ç”¨æ¥å¤„ç†æ‰¹é‡æ•°æ®ï¼Œæ¯”å¦‚æ‰¹é‡æ’å…¥ã€INæŸ¥è¯¢ç­‰ã€‚

### 6.1 åŸºç¡€å¾ªç¯è¯­æ³•


**ğŸ”¸ ç®€å•åˆ—è¡¨å¾ªç¯**
```xml
<select id="findUsersByIds">
    SELECT * FROM users 
    WHERE id IN 
    <foreach item="id" collection="userIds" 
             open="(" separator="," close=")">
        #{id}
    </foreach>
</select>
```

**ğŸ”¸ æ‰¹é‡æ’å…¥å¾ªç¯**
```xml
<insert id="batchInsertUsers">
    INSERT INTO users (name, age, email) VALUES
    <foreach item="user" collection="users" separator=",">
        (#{user.name}, #{user.age}, #{user.email})
    </foreach>
</insert>
```

### 6.2 å¤æ‚å¾ªç¯æ¡ˆä¾‹


**ğŸ”¸ åŠ¨æ€æ‰¹é‡æ›´æ–°**
```xml
<update id="batchUpdateUsers">
    <foreach collection="users" item="user" separator=";">
        UPDATE users 
        SET name = #{user.name}, age = #{user.age}
        WHERE id = #{user.id}
    </foreach>
</update>
```

**ğŸ”¸ å¤šæ¡ä»¶ORæŸ¥è¯¢**
```xml
<select id="findUsersByMultipleConditions">
    SELECT * FROM users
    <where>
        <foreach collection="conditions" item="condition" separator=" OR ">
            (name = #{condition.name} AND age = #{condition.age})
        </foreach>
    </where>
</select>
```

### 6.3 å¾ªç¯å¤„ç†å®ç°


```java
public class ForeachProcessor {
    
    public String processForeach(String template, List<Object> collection, 
                                String itemName, String separator) {
        StringBuilder result = new StringBuilder();
        
        for (int i = 0; i < collection.size(); i++) {
            Object item = collection.get(i);
            
            // æ›¿æ¢æ¨¡æ¿ä¸­çš„itemå˜é‡
            String processedTemplate = template.replace("#{" + itemName + "}", 
                                                      convertToSql(item));
            result.append(processedTemplate);
            
            // æ·»åŠ åˆ†éš”ç¬¦ï¼ˆæœ€åä¸€ä¸ªä¸åŠ ï¼‰
            if (i < collection.size() - 1) {
                result.append(separator);
            }
        }
        
        return result.toString();
    }
}
```

---

## 7. ğŸ’¾ æ¨¡æ¿ç¼“å­˜ç­–ç•¥


æ¨¡æ¿ç¼“å­˜å°±æ˜¯æŠŠè§£æå¥½çš„æ¨¡æ¿å­˜èµ·æ¥ï¼Œé¿å…é‡å¤è§£ææé«˜æ€§èƒ½ã€‚

### 7.1 ç¼“å­˜æœºåˆ¶è®¾è®¡


```
ç¬¬ä¸€æ¬¡ä½¿ç”¨æ¨¡æ¿ï¼š
è§£ææ¨¡æ¿ â†’ ç¼–è¯‘æ¨¡æ¿ â†’ æ‰§è¡Œæ¨¡æ¿ â†’ ç¼“å­˜ç»“æœ

åç»­ä½¿ç”¨ï¼š
ç›´æ¥ä»ç¼“å­˜è·å– â†’ å¡«å……å‚æ•° â†’ ç”ŸæˆSQL
```

### 7.2 å¤šçº§ç¼“å­˜æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¼“å­˜å±‚çº§                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L1: JVMå†…å­˜ç¼“å­˜ï¼ˆæœ€å¿«ï¼Œå®¹é‡å°ï¼‰          â”‚
â”‚  â€¢ ConcurrentHashMap                    â”‚
â”‚  â€¢ å­˜å‚¨ç¼–è¯‘åçš„æ¨¡æ¿å¯¹è±¡                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L2: æœ¬åœ°æ–‡ä»¶ç¼“å­˜ï¼ˆå¿«ï¼Œå®¹é‡ä¸­ï¼‰           â”‚
â”‚  â€¢ åºåˆ—åŒ–æ¨¡æ¿åˆ°ç£ç›˜                      â”‚
â”‚  â€¢ é‡å¯åå¯æ¢å¤                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L3: Redisç¼“å­˜ï¼ˆä¸­ç­‰ï¼Œå®¹é‡å¤§ï¼‰            â”‚
â”‚  â€¢ åˆ†å¸ƒå¼å…±äº«ç¼“å­˜                        â”‚
â”‚  â€¢ é›†ç¾¤é—´æ¨¡æ¿åŒæ­¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ç¼“å­˜å®ç°ç¤ºä¾‹


```java
public class TemplateCache {
    // L1ç¼“å­˜ï¼šå†…å­˜ç¼“å­˜
    private final Map<String, CompiledTemplate> memoryCache = 
        new ConcurrentHashMap<>();
    
    // ç¼“å­˜é…ç½®
    private final int maxSize = 1000;
    private final long expireTime = 3600000; // 1å°æ—¶
    
    public CompiledTemplate getTemplate(String templateName) {
        // 1. å…ˆæŸ¥å†…å­˜ç¼“å­˜
        CompiledTemplate template = memoryCache.get(templateName);
        if (template != null && !isExpired(template)) {
            return template;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŠ è½½å¹¶ç¼–è¯‘æ¨¡æ¿
        template = loadAndCompileTemplate(templateName);
        
        // 3. å­˜å…¥ç¼“å­˜ï¼ˆæ£€æŸ¥å®¹é‡é™åˆ¶ï¼‰
        if (memoryCache.size() < maxSize) {
            memoryCache.put(templateName, template);
        } else {
            // ç¼“å­˜æ»¡äº†ï¼Œä½¿ç”¨LRUç­–ç•¥æ¸…ç†
            evictOldestTemplate();
            memoryCache.put(templateName, template);
        }
        
        return template;
    }
}
```

### 7.4 ç¼“å­˜æ›´æ–°ç­–ç•¥


| ç­–ç•¥ç±»å‹ | **è§¦å‘æ¡ä»¶** | **æ›´æ–°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| ğŸ• **å®šæ—¶æ›´æ–°** | `å›ºå®šæ—¶é—´é—´éš”` | `æ‰¹é‡é‡æ–°åŠ è½½` | `å¼€å‘ç¯å¢ƒ` |
| ğŸ”” **æ–‡ä»¶ç›‘å¬** | `æ¨¡æ¿æ–‡ä»¶ä¿®æ”¹` | `å®æ—¶æ›´æ–°` | `ç”Ÿäº§ç¯å¢ƒ` |
| ğŸ–±ï¸ **æ‰‹åŠ¨åˆ·æ–°** | `ç®¡ç†å‘˜æ“ä½œ` | `æŒ‡å®šæ¨¡æ¿æ›´æ–°` | `ç´§æ€¥ä¿®å¤` |
| ğŸ”„ **ç‰ˆæœ¬æ§åˆ¶** | `ç‰ˆæœ¬å·å˜åŒ–` | `å¢é‡æ›´æ–°` | `åˆ†å¸ƒå¼ç³»ç»Ÿ` |

---

## 8. ğŸ›¡ï¸ æ¨¡æ¿å®‰å…¨æ€§é˜²æŠ¤


æ¨¡æ¿å®‰å…¨æ˜¯é˜²æ­¢SQLæ³¨å…¥å’Œå…¶ä»–å®‰å…¨é£é™©çš„å…³é”®ã€‚

### 8.1 SQLæ³¨å…¥é˜²æŠ¤


**ğŸ”¸ å±é™©ç¤ºä¾‹ï¼ˆå®¹æ˜“è¢«æ³¨å…¥ï¼‰**
```java
// å±é™©ï¼šç›´æ¥å­—ç¬¦ä¸²æ‹¼æ¥
String sql = "SELECT * FROM users WHERE name = '" + userName + "'";
// å¦‚æœuserName = "'; DROP TABLE users; --"
// æœ€ç»ˆSQL = "SELECT * FROM users WHERE name = ''; DROP TABLE users; --'"
```

**ğŸ”¸ å®‰å…¨ç¤ºä¾‹ï¼ˆé¢„å¤„ç†é˜²æŠ¤ï¼‰**
```java
// å®‰å…¨ï¼šä½¿ç”¨é¢„å¤„ç†å‚æ•°
String template = "SELECT * FROM users WHERE name = #{userName}";
// ä¼šè‡ªåŠ¨è½¬ä¹‰å’ŒåŠ å¼•å·ï¼Œæ— æ³•è¿›è¡ŒSQLæ³¨å…¥
```

### 8.2 å‚æ•°è¿‡æ»¤æœºåˆ¶


```java
public class SecurityFilter {
    
    // SQLå…³é”®å­—é»‘åå•
    private static final Set<String> DANGEROUS_KEYWORDS = Set.of(
        "DROP", "DELETE", "TRUNCATE", "ALTER", "EXEC", "UNION"
    );
    
    public String filterParameter(String param) {
        if (param == null) return null;
        
        // 1. æ£€æŸ¥å±é™©å…³é”®å­—
        String upperParam = param.toUpperCase();
        for (String keyword : DANGEROUS_KEYWORDS) {
            if (upperParam.contains(keyword)) {
                throw new SecurityException("å‚æ•°åŒ…å«å±é™©å…³é”®å­—: " + keyword);
            }
        }
        
        // 2. è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
        param = param.replace("'", "''");  // SQLè½¬ä¹‰å•å¼•å·
        param = param.replace("\\", "\\\\");  // è½¬ä¹‰åæ–œæ 
        
        // 3. é•¿åº¦é™åˆ¶
        if (param.length() > 1000) {
            throw new SecurityException("å‚æ•°é•¿åº¦è¶…å‡ºé™åˆ¶");
        }
        
        return param;
    }
}
```

### 8.3 æƒé™æ§åˆ¶æœºåˆ¶


```java
public class TemplatePermissionManager {
    
    // ç”¨æˆ·æƒé™æ˜ å°„
    private Map<String, Set<String>> userPermissions = new HashMap<>();
    
    public boolean checkTemplatePermission(String userId, String templateName) {
        Set<String> permissions = userPermissions.get(userId);
        if (permissions == null) {
            return false;  // ç”¨æˆ·æ— ä»»ä½•æƒé™
        }
        
        // æ£€æŸ¥å…·ä½“æ¨¡æ¿æƒé™
        if (permissions.contains(templateName)) {
            return true;
        }
        
        // æ£€æŸ¥é€šé…ç¬¦æƒé™
        String category = getTemplateCategory(templateName);
        return permissions.contains(category + ".*");
    }
    
    // æ•æ„Ÿæ“ä½œé¢å¤–æ£€æŸ¥
    public void checkSensitiveOperation(String templateName) {
        if (isSensitiveTemplate(templateName)) {
            // è®°å½•æ•æ„Ÿæ“ä½œæ—¥å¿—
            auditLogger.log("æ•æ„Ÿæ¨¡æ¿è®¿é—®: " + templateName);
            
            // å¯ä»¥æ·»åŠ é¢å¤–éªŒè¯ï¼Œå¦‚çŸ­ä¿¡éªŒè¯ç ç­‰
            requireAdditionalAuthentication();
        }
    }
}
```

### 8.4 å®‰å…¨é…ç½®å»ºè®®


> **ğŸ”’ å®‰å…¨é…ç½®æ¸…å•**
> - âœ… ä½¿ç”¨é¢„å¤„ç†è¯­å¥ï¼ˆ`#{param}`ï¼‰è€Œä¸æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆ`${param}`ï¼‰
> - âœ… å¯¹æ‰€æœ‰è¾“å…¥å‚æ•°è¿›è¡Œç±»å‹éªŒè¯å’Œé•¿åº¦é™åˆ¶
> - âœ… å»ºç«‹SQLå…³é”®å­—é»‘åå•è¿‡æ»¤
> - âœ… é™åˆ¶æ¨¡æ¿è®¿é—®æƒé™ï¼Œæ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–è®¤è¯
> - âœ… è®°å½•æ‰€æœ‰æ¨¡æ¿æ‰§è¡Œæ—¥å¿—ï¼Œä¾¿äºå®¡è®¡
> - âœ… å®šæœŸæ£€æŸ¥å’Œæ›´æ–°å®‰å…¨è§„åˆ™

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SQLæ¨¡æ¿ï¼šæŠŠSQLå†™æˆå¯å¤ç”¨çš„æ¨¡æ¿ï¼Œé€šè¿‡å ä½ç¬¦åŠ¨æ€å¡«å……æ•°æ®
ğŸ”¸ æ¨¡æ¿å¼•æ“ï¼šè§£ææ¨¡æ¿ã€å¤„ç†å‚æ•°ã€ç”Ÿæˆæœ€ç»ˆSQLçš„æ ¸å¿ƒç»„ä»¶
ğŸ”¸ å‚æ•°æ›¿æ¢ï¼šå®‰å…¨åœ°å°†å˜é‡å€¼æ›¿æ¢åˆ°SQLæ¨¡æ¿ä¸­çš„æœºåˆ¶
ğŸ”¸ æ¡ä»¶åˆ†æ”¯ï¼šæ ¹æ®ä¸åŒæ¡ä»¶åŠ¨æ€ç”Ÿæˆä¸åŒSQLç‰‡æ®µçš„é€»è¾‘
ğŸ”¸ å¾ªç¯æ„å»ºï¼šå¤„ç†æ‰¹é‡æ•°æ®æ“ä½œçš„æ¨¡æ¿å¾ªç¯æœºåˆ¶
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šæé«˜æ¨¡æ¿è§£æå’Œæ‰§è¡Œæ€§èƒ½çš„ç¼“å­˜æœºåˆ¶
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šé˜²æ­¢SQLæ³¨å…¥ç­‰å®‰å…¨é£é™©çš„ä¿æŠ¤æœºåˆ¶
```

### 9.2 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
- **ä»£ç å¤ç”¨**ï¼šä¸€ä¸ªæ¨¡æ¿å¤„ç†å¤šç§ç›¸ä¼¼åœºæ™¯
- **åŠ¨æ€æŸ¥è¯¢**ï¼šæ ¹æ®æ¡ä»¶çµæ´»ç”ŸæˆSQL
- **æ‰¹é‡å¤„ç†**ï¼šé«˜æ•ˆå¤„ç†å¤§é‡æ•°æ®æ“ä½œ
- **å®‰å…¨é˜²æŠ¤**ï¼šç»Ÿä¸€çš„SQLæ³¨å…¥é˜²æŠ¤æœºåˆ¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜æœºåˆ¶æå‡æ‰§è¡Œæ•ˆç‡

**ğŸ› ï¸ æŠ€æœ¯é€‰å‹å»ºè®®**

| åº”ç”¨åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **æ ¸å¿ƒä¼˜åŠ¿** |
|---------|-------------|-------------|
| ğŸ¢ **ä¼ä¸šçº§åº”ç”¨** | `MyBatis + è‡ªå®šä¹‰æ¨¡æ¿` | `æˆç†Ÿç¨³å®šï¼ŒåŠŸèƒ½å…¨é¢` |
| ğŸš€ **å¿«é€Ÿå¼€å‘** | `JPA + Criteria API` | `å¼€å‘æ•ˆç‡é«˜` |
| ğŸ“Š **å¤æ‚æŠ¥è¡¨** | `Freemarker + JDBC` | `æ¨¡æ¿åŠŸèƒ½å¼ºå¤§` |
| ğŸ”§ **å®šåˆ¶éœ€æ±‚** | `è‡ªç ”æ¨¡æ¿å¼•æ“` | `å®Œå…¨å¯æ§` |

### 9.3 æœ€ä½³å®è·µè¦ç‚¹


> **ğŸ’¡ å¼€å‘å»ºè®®**
> 1. **æ¨¡æ¿è®¾è®¡**ï¼šä¿æŒæ¨¡æ¿ç®€å•æ¸…æ™°ï¼Œé¿å…è¿‡äºå¤æ‚çš„é€»è¾‘
> 2. **å‚æ•°éªŒè¯**ï¼šå¯¹æ‰€æœ‰è¾“å…¥å‚æ•°è¿›è¡Œä¸¥æ ¼éªŒè¯
> 3. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…é‡å¤è§£æ
> 4. **å®‰å…¨ç¬¬ä¸€**ï¼šæ°¸è¿œä½¿ç”¨é¢„å¤„ç†å‚æ•°ï¼Œä¸è¦ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²
> 5. **æ–‡æ¡£å®Œå–„**ï¼šä¸ºæ¯ä¸ªæ¨¡æ¿ç¼–å†™æ¸…æ™°çš„ä½¿ç”¨è¯´æ˜

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
- æ¨¡æ¿å¤ç”¨æ•ˆç‡é«˜ï¼Œå‚æ•°å®‰å…¨æ˜¯é¦–è¦
- æ¡ä»¶åˆ†æ”¯é€»è¾‘æ¸…ï¼Œå¾ªç¯æ‰¹é‡æ€§èƒ½å¥½  
- ç¼“å­˜ç­–ç•¥æé€Ÿåº¦ï¼Œå®‰å…¨é˜²æŠ¤ä¸å¯å°‘
- SQLæ³¨å…¥è¦é¢„é˜²ï¼Œæƒé™æ§åˆ¶å¾ˆé‡è¦

**æ ¸å¿ƒä»·å€¼**ï¼šSQLæ¨¡æ¿æŠ€æœ¯è®©æ•°æ®åº“æ“ä½œæ›´çµæ´»ã€æ›´å®‰å…¨ã€æ›´é«˜æ•ˆï¼Œæ˜¯ç°ä»£åº”ç”¨å¼€å‘ä¸­ä¸å¯ç¼ºå°‘çš„é‡è¦æŠ€æœ¯ã€‚æŒæ¡è¿™äº›çŸ¥è¯†ç‚¹ï¼Œèƒ½å¤Ÿæ˜¾è‘—æå‡æ•°æ®åº“åº”ç”¨çš„å¼€å‘è´¨é‡å’Œç»´æŠ¤æ•ˆç‡ã€‚