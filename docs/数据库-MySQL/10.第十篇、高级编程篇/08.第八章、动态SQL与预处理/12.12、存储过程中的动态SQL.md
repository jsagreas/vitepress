---
title: 12ã€å­˜å‚¨è¿‡ç¨‹ä¸­çš„åŠ¨æ€SQL
---
## ğŸ“š ç›®å½•

1. [åŠ¨æ€SQLåŸºç¡€æ¦‚å¿µ](#1-åŠ¨æ€SQLåŸºç¡€æ¦‚å¿µ)
2. [å­˜å‚¨è¿‡ç¨‹åŠ¨æ€SQLè¯­æ³•](#2-å­˜å‚¨è¿‡ç¨‹åŠ¨æ€SQLè¯­æ³•)
3. [å˜é‡æ‹¼æ¥æŠ€æœ¯](#3-å˜é‡æ‹¼æ¥æŠ€æœ¯)
4. [æ¡ä»¶åˆ¤æ–­æ„å»º](#4-æ¡ä»¶åˆ¤æ–­æ„å»º)
5. [å¾ªç¯åŠ¨æ€ç”Ÿæˆ](#5-å¾ªç¯åŠ¨æ€ç”Ÿæˆ)
6. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#6-å¼‚å¸¸å¤„ç†æœºåˆ¶)
7. [è°ƒè¯•æŠ€æœ¯](#7-è°ƒè¯•æŠ€æœ¯)
8. [æ€§èƒ½è€ƒè™‘](#8-æ€§èƒ½è€ƒè™‘)
9. [å­˜å‚¨è¿‡ç¨‹SQLæ„å»ºå™¨](#9-å­˜å‚¨è¿‡ç¨‹SQLæ„å»ºå™¨)
10. [åŠ¨æ€æ¸¸æ ‡å¤„ç†](#10-åŠ¨æ€æ¸¸æ ‡å¤„ç†)
11. [å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥é˜²æŠ¤](#11-å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥é˜²æŠ¤)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åŠ¨æ€SQLåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€SQL

**ç®€å•ç†è§£**ï¼šåŠ¨æ€SQLå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ä¸´æ—¶æ‹¼è£…å‡ºæ¥çš„SQLè¯­å¥ï¼Œè€Œä¸æ˜¯å†™æ­»çš„å›ºå®šè¯­å¥ã€‚

```
é™æ€SQLï¼ˆå›ºå®šçš„ï¼‰ï¼š
SELECT * FROM users WHERE id = 1;

åŠ¨æ€SQLï¼ˆè¿è¡Œæ—¶ç”Ÿæˆçš„ï¼‰ï¼š
æ ¹æ®æ¡ä»¶å¯èƒ½å˜æˆï¼š
SELECT * FROM users WHERE age > 25;
SELECT * FROM users WHERE name LIKE '%å¼ %';
SELECT name, email FROM users WHERE city = 'åŒ—äº¬';
```

â”Œâ”€ æ ¸å¿ƒæ¦‚å¿µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€SQLï¼Ÿ**    â”‚
â”‚ â€¢ æŸ¥è¯¢æ¡ä»¶ä¸ç¡®å®š           â”‚
â”‚ â€¢ è¡¨åæˆ–å­—æ®µåå¯å˜         â”‚
â”‚ â€¢ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­       â”‚
â”‚ â€¢ æé«˜ä»£ç å¤ç”¨æ€§           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 1.2 åŠ¨æ€SQLçš„åº”ç”¨åœºæ™¯

**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š

ğŸ”¸ **å¤šæ¡ä»¶æŸ¥è¯¢**
```sql
-- ç”¨æˆ·å¯èƒ½é€‰æ‹©æŒ‰å§“åã€å¹´é¾„ã€åŸå¸‚ç­‰ä¸åŒæ¡ä»¶æŸ¥è¯¢
-- éœ€è¦æ ¹æ®ç”¨æˆ·è¾“å…¥åŠ¨æ€ç»„è£…WHEREå­å¥
```

ğŸ”¸ **åŠ¨æ€è¡¨æ“ä½œ**
```sql
-- æ ¹æ®æ—¥æœŸåˆ›å»ºä¸åŒçš„æ—¥å¿—è¡¨
-- å¦‚ï¼šlog_2024_01, log_2024_02
```

ğŸ”¸ **å­—æ®µåŠ¨æ€é€‰æ‹©**
```sql
-- æ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºä¸åŒå­—æ®µ
-- æ™®é€šç”¨æˆ·çœ‹åŸºæœ¬ä¿¡æ¯ï¼Œç®¡ç†å‘˜çœ‹å…¨éƒ¨ä¿¡æ¯
```

---

## 2. âš™ï¸ å­˜å‚¨è¿‡ç¨‹åŠ¨æ€SQLè¯­æ³•


### 2.1 PREPAREè¯­å¥åŸºç¡€

**æ ¸å¿ƒè¯­æ³•**ï¼šä½¿ç”¨PREPAREå‡†å¤‡åŠ¨æ€SQLï¼Œç„¶åEXECUTEæ‰§è¡Œ

```sql
-- åŸºæœ¬è¯­æ³•ç»“æ„
PREPARE stmt_name FROM sql_string;
EXECUTE stmt_name [USING variable_list];
DEALLOCATE PREPARE stmt_name;
```

**ç®€å•ç¤ºä¾‹**ï¼š
```sql
DELIMITER //
CREATE PROCEDURE demo_dynamic_basic(IN table_name VARCHAR(50))
BEGIN
    SET @sql = CONCAT('SELECT COUNT(*) FROM ', table_name);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;

-- è°ƒç”¨ç¤ºä¾‹
CALL demo_dynamic_basic('users');  -- æŸ¥è¯¢usersè¡¨è®°å½•æ•°
```

### 2.2 å˜é‡ä¸å‚æ•°ä¼ é€’

**å‚æ•°ç»‘å®š**ï¼šä½¿ç”¨USINGå­å¥ä¼ é€’å‚æ•°ï¼Œé¿å…SQLæ³¨å…¥

```sql
DELIMITER //
CREATE PROCEDURE search_user_by_age(IN min_age INT, IN max_age INT)
BEGIN
    SET @sql = 'SELECT id, name, age FROM users WHERE age BETWEEN ? AND ?';
    PREPARE stmt FROM @sql;
    EXECUTE stmt USING min_age, max_age;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

ğŸ’¡ **å…³é”®ç†è§£**ï¼š
- `?` æ˜¯å‚æ•°å ä½ç¬¦
- `USING` åé¢æŒ‰é¡ºåºä¼ é€’å‚æ•°å€¼
- è¿™ç§æ–¹å¼æ¯”å­—ç¬¦ä¸²æ‹¼æ¥æ›´å®‰å…¨

---

## 3. ğŸ”§ å˜é‡æ‹¼æ¥æŠ€æœ¯


### 3.1 å­—ç¬¦ä¸²æ‹¼æ¥æ–¹æ³•

**CONCATå‡½æ•°**ï¼šæœ€å¸¸ç”¨çš„å­—ç¬¦ä¸²æ‹¼æ¥æ–¹æ³•

```sql
DELIMITER //
CREATE PROCEDURE build_query_concat(
    IN search_field VARCHAR(50),
    IN search_value VARCHAR(100)
)
BEGIN
    DECLARE sql_text TEXT;
    
    -- ä½¿ç”¨CONCATæ‹¼æ¥SQLè¯­å¥
    SET sql_text = CONCAT(
        'SELECT id, name, email FROM users WHERE ',
        search_field, ' = ''', search_value, ''''
    );
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 3.2 å®‰å…¨çš„å‚æ•°åŒ–æ‹¼æ¥

**æ¨èæ–¹å¼**ï¼šç»“åˆCONCATå’Œå‚æ•°å ä½ç¬¦

```sql
DELIMITER //
CREATE PROCEDURE safe_dynamic_query(
    IN table_name VARCHAR(50),
    IN where_field VARCHAR(50),
    IN where_value VARCHAR(100)
)
BEGIN
    DECLARE sql_text TEXT;
    
    -- æ‹¼æ¥SQLç»“æ„ï¼Œä½¿ç”¨?å ä½ç¬¦
    SET sql_text = CONCAT(
        'SELECT * FROM ', table_name,
        ' WHERE ', where_field, ' = ?'
    );
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt USING where_value;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 3.3 å¤æ‚æ‹¼æ¥ç¤ºä¾‹

**å¤šæ®µæ‹¼æ¥**ï¼šå¤„ç†å¤æ‚çš„SQLç»“æ„

```sql
DELIMITER //
CREATE PROCEDURE complex_query_builder(
    IN select_fields TEXT,
    IN from_table VARCHAR(50),
    IN where_condition TEXT,
    IN order_field VARCHAR(50)
)
BEGIN
    DECLARE sql_text TEXT DEFAULT '';
    
    -- åˆ†æ®µæ„å»ºSQL
    SET sql_text = CONCAT('SELECT ', IFNULL(select_fields, '*'));
    SET sql_text = CONCAT(sql_text, ' FROM ', from_table);
    
    IF where_condition IS NOT NULL AND where_condition != '' THEN
        SET sql_text = CONCAT(sql_text, ' WHERE ', where_condition);
    END IF;
    
    IF order_field IS NOT NULL AND order_field != '' THEN
        SET sql_text = CONCAT(sql_text, ' ORDER BY ', order_field);
    END IF;
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

---

## 4. ğŸ›ï¸ æ¡ä»¶åˆ¤æ–­æ„å»º


### 4.1 åŸºç¡€æ¡ä»¶åˆ¤æ–­

**IF-ELSEæ„å»º**ï¼šæ ¹æ®ä¸åŒæ¡ä»¶ç”Ÿæˆä¸åŒçš„SQL

```sql
DELIMITER //
CREATE PROCEDURE conditional_query(
    IN search_type VARCHAR(20),
    IN search_value VARCHAR(100)
)
BEGIN
    DECLARE sql_text TEXT;
    
    IF search_type = 'name' THEN
        SET sql_text = 'SELECT * FROM users WHERE name LIKE ?';
        SET @param = CONCAT('%', search_value, '%');
    ELSEIF search_type = 'email' THEN
        SET sql_text = 'SELECT * FROM users WHERE email = ?';
        SET @param = search_value;
    ELSEIF search_type = 'age' THEN
        SET sql_text = 'SELECT * FROM users WHERE age = ?';
        SET @param = search_value;
    ELSE
        SET sql_text = 'SELECT * FROM users LIMIT 10';
        SET @param = NULL;
    END IF;
    
    PREPARE stmt FROM sql_text;
    IF @param IS NOT NULL THEN
        EXECUTE stmt USING @param;
    ELSE
        EXECUTE stmt;
    END IF;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 4.2 å¤šæ¡ä»¶ç»„åˆåˆ¤æ–­

**å¤æ‚æ¡ä»¶æ„å»º**ï¼šå¤„ç†å¤šä¸ªå¯é€‰æ¡ä»¶

```sql
DELIMITER //
CREATE PROCEDURE multi_condition_search(
    IN p_name VARCHAR(50),
    IN p_min_age INT,
    IN p_max_age INT,
    IN p_city VARCHAR(50)
)
BEGIN
    DECLARE sql_text TEXT;
    DECLARE where_clause TEXT DEFAULT '';
    DECLARE first_condition BOOLEAN DEFAULT TRUE;
    
    SET sql_text = 'SELECT id, name, age, city FROM users';
    
    -- åŠ¨æ€æ„å»ºWHEREå­å¥
    IF p_name IS NOT NULL THEN
        IF first_condition THEN
            SET where_clause = ' WHERE';
            SET first_condition = FALSE;
        ELSE
            SET where_clause = CONCAT(where_clause, ' AND');
        END IF;
        SET where_clause = CONCAT(where_clause, ' name LIKE ''%', p_name, '%''');
    END IF;
    
    IF p_min_age IS NOT NULL THEN
        IF first_condition THEN
            SET where_clause = ' WHERE';
            SET first_condition = FALSE;
        ELSE
            SET where_clause = CONCAT(where_clause, ' AND');
        END IF;
        SET where_clause = CONCAT(where_clause, ' age >= ', p_min_age);
    END IF;
    
    IF p_max_age IS NOT NULL THEN
        IF first_condition THEN
            SET where_clause = ' WHERE';
            SET first_condition = FALSE;
        ELSE
            SET where_clause = CONCAT(where_clause, ' AND');
        END IF;
        SET where_clause = CONCAT(where_clause, ' age <= ', p_max_age);
    END IF;
    
    IF p_city IS NOT NULL THEN
        IF first_condition THEN
            SET where_clause = ' WHERE';
            SET first_condition = FALSE;
        ELSE
            SET where_clause = CONCAT(where_clause, ' AND');
        END IF;
        SET where_clause = CONCAT(where_clause, ' city = ''', p_city, '''');
    END IF;
    
    -- ç»„åˆæœ€ç»ˆSQL
    SET sql_text = CONCAT(sql_text, where_clause);
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

---

## 5. ğŸ”„ å¾ªç¯åŠ¨æ€ç”Ÿæˆ


### 5.1 åŸºç¡€å¾ªç¯æ„å»º

**WHILEå¾ªç¯**ï¼šåŠ¨æ€ç”Ÿæˆé‡å¤çš„SQLç‰‡æ®µ

```sql
DELIMITER //
CREATE PROCEDURE create_batch_insert(
    IN table_name VARCHAR(50),
    IN batch_size INT
)
BEGIN
    DECLARE sql_text TEXT;
    DECLARE values_part TEXT DEFAULT '';
    DECLARE i INT DEFAULT 1;
    
    SET sql_text = CONCAT('INSERT INTO ', table_name, ' (name, status) VALUES ');
    
    -- å¾ªç¯æ„å»ºVALUESéƒ¨åˆ†
    WHILE i <= batch_size DO
        IF i > 1 THEN
            SET values_part = CONCAT(values_part, ', ');
        END IF;
        SET values_part = CONCAT(values_part, '(''user_', i, ''', ''active'')');
        SET i = i + 1;
    END WHILE;
    
    SET sql_text = CONCAT(sql_text, values_part);
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 5.2 æ¸¸æ ‡å¾ªç¯åŠ¨æ€ç”Ÿæˆ

**ç»“åˆæ¸¸æ ‡**ï¼šæ ¹æ®æŸ¥è¯¢ç»“æœåŠ¨æ€ç”ŸæˆSQL

```sql
DELIMITER //
CREATE PROCEDURE dynamic_table_operations()
BEGIN
    DECLARE done BOOLEAN DEFAULT FALSE;
    DECLARE table_name VARCHAR(50);
    DECLARE sql_text TEXT;
    
    -- å£°æ˜æ¸¸æ ‡
    DECLARE table_cursor CURSOR FOR 
        SELECT table_name FROM information_schema.tables 
        WHERE table_schema = DATABASE() AND table_name LIKE 'temp_%';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN table_cursor;
    
    table_loop: LOOP
        FETCH table_cursor INTO table_name;
        IF done THEN
            LEAVE table_loop;
        END IF;
        
        -- ä¸ºæ¯ä¸ªè¡¨åŠ¨æ€ç”Ÿæˆæ¸…ç©ºæ“ä½œ
        SET sql_text = CONCAT('DELETE FROM ', table_name, ' WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY)');
        
        PREPARE stmt FROM sql_text;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
    END LOOP;
    
    CLOSE table_cursor;
END //
DELIMITER ;
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 6.1 åŸºç¡€å¼‚å¸¸å¤„ç†

**DECLARE HANDLER**ï¼šå¤„ç†åŠ¨æ€SQLæ‰§è¡Œä¸­çš„å¼‚å¸¸

```sql
DELIMITER //
CREATE PROCEDURE safe_dynamic_query(IN query_text TEXT)
BEGIN
    DECLARE sql_error BOOLEAN DEFAULT FALSE;
    DECLARE error_msg TEXT;
    
    -- å£°æ˜å¼‚å¸¸å¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        SET sql_error = TRUE;
        GET DIAGNOSTICS CONDITION 1
            error_msg = MESSAGE_TEXT;
    END;
    
    -- æ‰§è¡ŒåŠ¨æ€SQL
    PREPARE stmt FROM query_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
    IF sql_error THEN
        SELECT CONCAT('SQLæ‰§è¡Œé”™è¯¯: ', error_msg) AS error_message;
    ELSE
        SELECT 'æ‰§è¡ŒæˆåŠŸ' AS status;
    END IF;
END //
DELIMITER ;
```

### 6.2 è¯¦ç»†é”™è¯¯ä¿¡æ¯å¤„ç†

**å®Œæ•´å¼‚å¸¸ä¿¡æ¯**ï¼šè·å–è¯¦ç»†çš„é”™è¯¯è¯Šæ–­ä¿¡æ¯

```sql
DELIMITER //
CREATE PROCEDURE robust_dynamic_sql(IN sql_statement TEXT)
BEGIN
    DECLARE sql_error BOOLEAN DEFAULT FALSE;
    DECLARE error_code CHAR(5);
    DECLARE error_msg TEXT;
    DECLARE mysql_errno INT;
    
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        SET sql_error = TRUE;
        GET DIAGNOSTICS CONDITION 1
            error_code = RETURNED_SQLSTATE,
            error_msg = MESSAGE_TEXT,
            mysql_errno = MYSQL_ERRNO;
    END;
    
    PREPARE stmt FROM sql_statement;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    IF sql_error THEN
        SELECT 
            'ERROR' AS status,
            error_code AS sql_state,
            mysql_errno AS error_number,
            error_msg AS error_message;
    ELSE
        SELECT 'SUCCESS' AS status;
    END IF;
END //
DELIMITER ;
```

---

## 7. ğŸ” è°ƒè¯•æŠ€æœ¯


### 7.1 SQLè¯­å¥è°ƒè¯•è¾“å‡º

**è°ƒè¯•æŸ¥çœ‹**ï¼šè¾“å‡ºç”Ÿæˆçš„SQLè¯­å¥è¿›è¡Œè°ƒè¯•

```sql
DELIMITER //
CREATE PROCEDURE debug_dynamic_sql(
    IN table_name VARCHAR(50),
    IN debug_mode BOOLEAN
)
BEGIN
    DECLARE sql_text TEXT;
    
    SET sql_text = CONCAT('SELECT COUNT(*) as record_count FROM ', table_name);
    
    -- è°ƒè¯•æ¨¡å¼ï¼šæ˜¾ç¤ºç”Ÿæˆçš„SQL
    IF debug_mode THEN
        SELECT sql_text AS generated_sql;
    END IF;
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;

-- è°ƒè¯•è°ƒç”¨
CALL debug_dynamic_sql('users', TRUE);  -- æ˜¾ç¤ºç”Ÿæˆçš„SQL
CALL debug_dynamic_sql('users', FALSE); -- åªæ‰§è¡Œä¸æ˜¾ç¤º
```

### 7.2 åˆ†æ­¥è°ƒè¯•æŠ€æœ¯

**åˆ†æ­¥éªŒè¯**ï¼šé€æ­¥æ„å»ºå’ŒéªŒè¯SQL

```sql
DELIMITER //
CREATE PROCEDURE step_by_step_debug(
    IN p_table VARCHAR(50),
    IN p_where TEXT,
    IN p_debug BOOLEAN
)
BEGIN
    DECLARE sql_base TEXT;
    DECLARE sql_where TEXT;
    DECLARE sql_final TEXT;
    
    -- æ­¥éª¤1ï¼šæ„å»ºåŸºç¡€æŸ¥è¯¢
    SET sql_base = CONCAT('SELECT * FROM ', p_table);
    IF p_debug THEN
        SELECT sql_base AS step1_base_sql;
    END IF;
    
    -- æ­¥éª¤2ï¼šæ·»åŠ WHEREæ¡ä»¶
    IF p_where IS NOT NULL AND p_where != '' THEN
        SET sql_where = CONCAT(' WHERE ', p_where);
        IF p_debug THEN
            SELECT sql_where AS step2_where_clause;
        END IF;
    ELSE
        SET sql_where = '';
    END IF;
    
    -- æ­¥éª¤3ï¼šç»„åˆæœ€ç»ˆSQL
    SET sql_final = CONCAT(sql_base, sql_where);
    IF p_debug THEN
        SELECT sql_final AS step3_final_sql;
    END IF;
    
    -- æ­¥éª¤4ï¼šæ‰§è¡Œ
    PREPARE stmt FROM sql_final;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

---

## 8. âš¡ æ€§èƒ½è€ƒè™‘


### 8.1 é¢„å¤„ç†è¯­å¥é‡ç”¨

**æ€§èƒ½ä¼˜åŒ–**ï¼šé‡ç”¨PREPAREè¯­å¥é¿å…é‡å¤è§£æ

```sql
DELIMITER //
CREATE PROCEDURE optimized_batch_query()
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE user_id INT;
    
    -- ä¸€æ¬¡å‡†å¤‡ï¼Œå¤šæ¬¡æ‰§è¡Œ
    PREPARE stmt FROM 'SELECT name, email FROM users WHERE id = ?';
    
    WHILE i <= 100 DO
        SET user_id = i;
        EXECUTE stmt USING user_id;
        SET i = i + 1;
    END WHILE;
    
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 8.2 SQLé•¿åº¦æ§åˆ¶

**é¿å…è¿‡é•¿SQL**ï¼šæ§åˆ¶åŠ¨æ€ç”Ÿæˆçš„SQLé•¿åº¦

```sql
DELIMITER //
CREATE PROCEDURE controlled_dynamic_sql(IN condition_count INT)
BEGIN
    DECLARE sql_text TEXT;
    DECLARE where_part TEXT DEFAULT '';
    DECLARE i INT DEFAULT 1;
    
    SET sql_text = 'SELECT * FROM users WHERE 1=1';
    
    -- é™åˆ¶æ¡ä»¶æ•°é‡ï¼Œé¿å…SQLè¿‡é•¿
    IF condition_count > 50 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'æ¡ä»¶æ•°é‡è¿‡å¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½';
    END IF;
    
    WHILE i <= condition_count DO
        SET where_part = CONCAT(where_part, ' AND status = ''active''');
        SET i = i + 1;
    END WHILE;
    
    SET sql_text = CONCAT(sql_text, where_part);
    
    -- æ£€æŸ¥SQLé•¿åº¦
    IF CHAR_LENGTH(sql_text) > 10000 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'SQLè¯­å¥è¿‡é•¿';
    END IF;
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

---

## 9. ğŸ—ï¸ å­˜å‚¨è¿‡ç¨‹SQLæ„å»ºå™¨


### 9.1 é€šç”¨æŸ¥è¯¢æ„å»ºå™¨

**å¤ç”¨æ€§è®¾è®¡**ï¼šåˆ›å»ºé€šç”¨çš„SQLæ„å»ºå·¥å…·

```sql
DELIMITER //
CREATE PROCEDURE query_builder(
    IN p_select_fields TEXT,
    IN p_from_table VARCHAR(100),
    IN p_join_clause TEXT,
    IN p_where_conditions TEXT,
    IN p_group_by TEXT,
    IN p_having TEXT,
    IN p_order_by TEXT,
    IN p_limit_clause TEXT
)
BEGIN
    DECLARE sql_text TEXT DEFAULT '';
    
    -- SELECTéƒ¨åˆ†
    SET sql_text = CONCAT('SELECT ', IFNULL(p_select_fields, '*'));
    
    -- FROMéƒ¨åˆ†
    SET sql_text = CONCAT(sql_text, ' FROM ', p_from_table);
    
    -- JOINéƒ¨åˆ†
    IF p_join_clause IS NOT NULL AND p_join_clause != '' THEN
        SET sql_text = CONCAT(sql_text, ' ', p_join_clause);
    END IF;
    
    -- WHEREéƒ¨åˆ†
    IF p_where_conditions IS NOT NULL AND p_where_conditions != '' THEN
        SET sql_text = CONCAT(sql_text, ' WHERE ', p_where_conditions);
    END IF;
    
    -- GROUP BYéƒ¨åˆ†
    IF p_group_by IS NOT NULL AND p_group_by != '' THEN
        SET sql_text = CONCAT(sql_text, ' GROUP BY ', p_group_by);
    END IF;
    
    -- HAVINGéƒ¨åˆ†
    IF p_having IS NOT NULL AND p_having != '' THEN
        SET sql_text = CONCAT(sql_text, ' HAVING ', p_having);
    END IF;
    
    -- ORDER BYéƒ¨åˆ†
    IF p_order_by IS NOT NULL AND p_order_by != '' THEN
        SET sql_text = CONCAT(sql_text, ' ORDER BY ', p_order_by);
    END IF;
    
    -- LIMITéƒ¨åˆ†
    IF p_limit_clause IS NOT NULL AND p_limit_clause != '' THEN
        SET sql_text = CONCAT(sql_text, ' LIMIT ', p_limit_clause);
    END IF;
    
    PREPARE stmt FROM sql_text;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;

-- ä½¿ç”¨ç¤ºä¾‹
CALL query_builder(
    'name, age, city',              -- SELECTå­—æ®µ
    'users',                        -- FROMè¡¨
    'LEFT JOIN orders ON users.id = orders.user_id',  -- JOIN
    'age > 18 AND status = ''active''',  -- WHEREæ¡ä»¶
    NULL,                           -- GROUP BY
    NULL,                           -- HAVING
    'age DESC',                     -- ORDER BY
    '10'                            -- LIMIT
);
```

### 9.2 æ¡ä»¶æ„å»ºåŠ©æ‰‹

**æ¡ä»¶æ„å»ºå·¥å…·**ï¼šç®€åŒ–å¤æ‚æ¡ä»¶çš„æ„å»º

```sql
DELIMITER //
CREATE PROCEDURE condition_builder_helper(
    IN field_name VARCHAR(50),
    IN operator_type VARCHAR(10),
    IN field_value TEXT,
    OUT condition_result TEXT
)
BEGIN
    CASE operator_type
        WHEN 'eq' THEN
            SET condition_result = CONCAT(field_name, ' = ''', field_value, '''');
        WHEN 'like' THEN
            SET condition_result = CONCAT(field_name, ' LIKE ''%', field_value, '%''');
        WHEN 'gt' THEN
            SET condition_result = CONCAT(field_name, ' > ', field_value);
        WHEN 'lt' THEN
            SET condition_result = CONCAT(field_name, ' < ', field_value);
        WHEN 'in' THEN
            SET condition_result = CONCAT(field_name, ' IN (', field_value, ')');
        ELSE
            SET condition_result = CONCAT(field_name, ' = ''', field_value, '''');
    END CASE;
END //
DELIMITER ;
```

---

## 10. ğŸ¯ åŠ¨æ€æ¸¸æ ‡å¤„ç†


### 10.1 åŠ¨æ€æ¸¸æ ‡åŸºç¡€

**åŠ¨æ€æ¸¸æ ‡**ï¼šæ ¹æ®æ¡ä»¶åŠ¨æ€ç¡®å®šæ¸¸æ ‡æŸ¥è¯¢

```sql
DELIMITER //
CREATE PROCEDURE dynamic_cursor_demo(IN table_name VARCHAR(50))
BEGIN
    DECLARE done BOOLEAN DEFAULT FALSE;
    DECLARE record_id INT;
    DECLARE record_name VARCHAR(100);
    DECLARE sql_text TEXT;
    
    -- åŠ¨æ€æ„å»ºæ¸¸æ ‡æŸ¥è¯¢
    SET sql_text = CONCAT('SELECT id, name FROM ', table_name, ' ORDER BY id');
    
    -- åˆ›å»ºä¸´æ—¶è¡¨å­˜å‚¨æ¸¸æ ‡æŸ¥è¯¢ç»“æœ
    DROP TEMPORARY TABLE IF EXISTS temp_cursor_data;
    SET @create_temp = CONCAT(
        'CREATE TEMPORARY TABLE temp_cursor_data AS ',
        sql_text
    );
    PREPARE stmt FROM @create_temp;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- ä½¿ç”¨å›ºå®šæ¸¸æ ‡æŸ¥è¯¢ä¸´æ—¶è¡¨
    DECLARE cursor_dynamic CURSOR FOR 
        SELECT id, name FROM temp_cursor_data;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cursor_dynamic;
    
    cursor_loop: LOOP
        FETCH cursor_dynamic INTO record_id, record_name;
        IF done THEN
            LEAVE cursor_loop;
        END IF;
        
        -- å¤„ç†æ¯æ¡è®°å½•
        SELECT CONCAT('å¤„ç†è®°å½•: ', record_id, ' - ', record_name) AS processing;
        
    END LOOP;
    
    CLOSE cursor_dynamic;
    DROP TEMPORARY TABLE temp_cursor_data;
END //
DELIMITER ;
```

---

## 11. ğŸ›¡ï¸ å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥é˜²æŠ¤


### 11.1 å‚æ•°åŒ–æŸ¥è¯¢é˜²æŠ¤

**å®‰å…¨ç¬¬ä¸€**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥

```sql
-- âŒ å±é™©çš„åšæ³•ï¼ˆSQLæ³¨å…¥é£é™©ï¼‰
DELIMITER //
CREATE PROCEDURE unsafe_query(IN user_input VARCHAR(100))
BEGIN
    SET @sql = CONCAT('SELECT * FROM users WHERE name = ''', user_input, '''');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;

-- âœ… å®‰å…¨çš„åšæ³•ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
DELIMITER //
CREATE PROCEDURE safe_query(IN user_input VARCHAR(100))
BEGIN
    PREPARE stmt FROM 'SELECT * FROM users WHERE name = ?';
    EXECUTE stmt USING user_input;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 11.2 è¾“å…¥éªŒè¯ä¸è¿‡æ»¤

**è¾“å…¥æ£€æŸ¥**ï¼šéªŒè¯å’Œæ¸…ç†è¾“å…¥å‚æ•°

```sql
DELIMITER //
CREATE PROCEDURE secure_dynamic_query(
    IN table_name VARCHAR(50),
    IN search_value VARCHAR(100)
)
BEGIN
    DECLARE clean_table_name VARCHAR(50);
    DECLARE clean_search_value VARCHAR(100);
    
    -- éªŒè¯è¡¨åï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
    IF table_name REGEXP '^[a-zA-Z0-9_]+$' THEN
        SET clean_table_name = table_name;
    ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'æ— æ•ˆçš„è¡¨å';
    END IF;
    
    -- æ¸…ç†æœç´¢å€¼ï¼ˆç§»é™¤æ½œåœ¨å±é™©å­—ç¬¦ï¼‰
    SET clean_search_value = REPLACE(search_value, '''', '''''');
    SET clean_search_value = REPLACE(clean_search_value, ';', '');
    SET clean_search_value = REPLACE(clean_search_value, '--', '');
    
    -- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    SET @sql = CONCAT('SELECT * FROM ', clean_table_name, ' WHERE name = ?');
    PREPARE stmt FROM @sql;
    EXECUTE stmt USING clean_search_value;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

### 11.3 ç™½åå•éªŒè¯

**ç™½åå•æœºåˆ¶**ï¼šåªå…è®¸é¢„å®šä¹‰çš„å®‰å…¨å€¼

```sql
DELIMITER //
CREATE PROCEDURE whitelist_protected_query(
    IN table_name VARCHAR(50),
    IN sort_field VARCHAR(50)
)
BEGIN
    DECLARE is_valid_table BOOLEAN DEFAULT FALSE;
    DECLARE is_valid_field BOOLEAN DEFAULT FALSE;
    
    -- éªŒè¯è¡¨åç™½åå•
    IF table_name IN ('users', 'orders', 'products', 'categories') THEN
        SET is_valid_table = TRUE;
    END IF;
    
    -- éªŒè¯å­—æ®µåç™½åå•
    IF sort_field IN ('id', 'name', 'created_at', 'updated_at') THEN
        SET is_valid_field = TRUE;
    END IF;
    
    IF NOT is_valid_table THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä¸å…è®¸çš„è¡¨å';
    END IF;
    
    IF NOT is_valid_field THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä¸å…è®¸çš„å­—æ®µå';
    END IF;
    
    -- å®‰å…¨æ„å»ºSQL
    SET @sql = CONCAT('SELECT * FROM ', table_name, ' ORDER BY ', sort_field);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //
DELIMITER ;
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


â”Œâ”€ æ ¸å¿ƒæŒæ¡ç‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¸ **PREPAREè¯­å¥**ï¼šåŠ¨æ€SQLçš„åŸºç¡€è¯­æ³•   â”‚
â”‚ ğŸ”¸ **å‚æ•°åŒ–æŸ¥è¯¢**ï¼šä½¿ç”¨?å ä½ç¬¦å’ŒUSING    â”‚
â”‚ ğŸ”¸ **å­—ç¬¦ä¸²æ‹¼æ¥**ï¼šCONCATå‡½æ•°çš„ä½¿ç”¨     â”‚
â”‚ ğŸ”¸ **æ¡ä»¶æ„å»º**ï¼šIF-ELSEåŠ¨æ€æ„å»ºSQL     â”‚
â”‚ ğŸ”¸ **å¼‚å¸¸å¤„ç†**ï¼šHANDLERå¤„ç†æ‰§è¡Œé”™è¯¯    â”‚
â”‚ ğŸ”¸ **å®‰å…¨é˜²æŠ¤**ï¼šé˜²æ­¢SQLæ³¨å…¥æ”»å‡»        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åŠ¨æ€SQLçš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
â€¢ è¿è¡Œæ—¶æ„å»ºSQLï¼Œè€Œä¸æ˜¯ç¼–å†™æ—¶å›ºå®š
â€¢ æä¾›çµæ´»æ€§ï¼Œä½†å¢åŠ å¤æ‚æ€§å’Œé£é™©
â€¢ éœ€è¦åœ¨çµæ´»æ€§å’Œå®‰å…¨æ€§ä¹‹é—´æ‰¾å¹³è¡¡
```

**ğŸ”¹ å‚æ•°åŒ–æŸ¥è¯¢çš„é‡è¦æ€§**
```
å®‰å…¨è€ƒè™‘ï¼š
â€¢ ä½¿ç”¨?å ä½ç¬¦æ¯”å­—ç¬¦ä¸²æ‹¼æ¥æ›´å®‰å…¨
â€¢ USINGå­å¥ä¼ é€’å‚æ•°é¿å…SQLæ³¨å…¥
â€¢ å³ä½¿åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä¹Ÿè¦éµå¾ªå®‰å…¨åŸåˆ™
```

**ğŸ”¹ æ€§èƒ½å½±å“**
```
æ€§èƒ½è¦ç‚¹ï¼š
â€¢ PREPAREæœ‰è§£æå¼€é”€ï¼Œé€‚åˆé‡å¤æ‰§è¡Œ
â€¢ é¿å…è¿‡é•¿çš„SQLè¯­å¥
â€¢ åˆç†ä½¿ç”¨DEALLOCATEé‡Šæ”¾èµ„æº
```

### 12.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **å¤šæ¡ä»¶æŸ¥è¯¢**ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ¨æ€ç»„è£…æŸ¥è¯¢æ¡ä»¶
- **æŠ¥è¡¨ç”Ÿæˆ**ï¼šæ ¹æ®å‚æ•°ç”Ÿæˆä¸åŒçš„ç»Ÿè®¡æŠ¥è¡¨
- **æ•°æ®è¿ç§»**ï¼šæ‰¹é‡å¤„ç†ä¸åŒç»“æ„çš„è¡¨
- **æƒé™æ§åˆ¶**ï¼šæ ¹æ®ç”¨æˆ·æƒé™æ˜¾ç¤ºä¸åŒå­—æ®µ
- **åŠ¨æ€è¡¨æ“ä½œ**ï¼šå¤„ç†æŒ‰æ—¶é—´åˆ†ç‰‡çš„è¡¨ç»“æ„

**ğŸ”§ æœ€ä½³å®è·µ**
- **å®‰å…¨ç¬¬ä¸€**ï¼šå§‹ç»ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- **è°ƒè¯•å‹å¥½**ï¼šæä¾›è°ƒè¯•æ¨¡å¼æ˜¾ç¤ºç”Ÿæˆçš„SQL
- **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **æ€§èƒ½è€ƒè™‘**ï¼šé¿å…è¿‡åº¦å¤æ‚çš„åŠ¨æ€SQL
- **ä»£ç å¤ç”¨**ï¼šåˆ›å»ºé€šç”¨çš„SQLæ„å»ºå·¥å…·

**ğŸ’¡ å­¦ä¹ è¦ç‚¹**
- æŒæ¡åŸºç¡€è¯­æ³•æ˜¯å‰æ
- ç†è§£å®‰å…¨é£é™©å’Œé˜²æŠ¤æ–¹æ³•
- åœ¨å®é™…é¡¹ç›®ä¸­é€æ­¥ç§¯ç´¯ç»éªŒ
- å¹³è¡¡çµæ´»æ€§å’Œå¤æ‚æ€§

**æ ¸å¿ƒè®°å¿†**ï¼š
- åŠ¨æ€SQLæä¾›çµæ´»æ€§ï¼Œä½†è¦æ³¨æ„å®‰å…¨æ€§
- PREPARE-EXECUTE-DEALLOCATEæ˜¯åŸºæœ¬æµç¨‹
- å‚æ•°åŒ–æŸ¥è¯¢æ˜¯é˜²æ­¢SQLæ³¨å…¥çš„å…³é”®
- å¼‚å¸¸å¤„ç†å’Œè°ƒè¯•æŠ€æœ¯ä¸å¯å¿½è§†