---
title: 7ã€pt-heartbeatå¤åˆ¶å»¶è¿Ÿç›‘æ§
---
## ğŸ“š ç›®å½•

1. [pt-heartbeatå·¥å…·æ¦‚è¿°](#1-pt-heartbeatå·¥å…·æ¦‚è¿°)
2. [å¿ƒè·³æœºåˆ¶å·¥ä½œåŸç†](#2-å¿ƒè·³æœºåˆ¶å·¥ä½œåŸç†)
3. [å¤åˆ¶å»¶è¿Ÿæµ‹é‡æ–¹æ³•](#3-å¤åˆ¶å»¶è¿Ÿæµ‹é‡æ–¹æ³•)
4. [å·¥å…·å®‰è£…ä¸åŸºç¡€é…ç½®](#4-å·¥å…·å®‰è£…ä¸åŸºç¡€é…ç½®)
5. [å»¶è¿Ÿç›‘æ§å®æˆ˜æ“ä½œ](#5-å»¶è¿Ÿç›‘æ§å®æˆ˜æ“ä½œ)
6. [å»¶è¿Ÿç»Ÿè®¡åˆ†æ](#6-å»¶è¿Ÿç»Ÿè®¡åˆ†æ)
7. [å®æ—¶ç›‘æ§ä¸å‘Šè­¦](#7-å®æ—¶ç›‘æ§ä¸å‘Šè­¦)
8. [å¤šçº§å¤åˆ¶å»¶è¿Ÿç›‘æ§](#8-å¤šçº§å¤åˆ¶å»¶è¿Ÿç›‘æ§)
9. [å»¶è¿Ÿæ ¹å› åˆ†æä¸ä¼˜åŒ–](#9-å»¶è¿Ÿæ ¹å› åˆ†æä¸ä¼˜åŒ–)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” pt-heartbeatå·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pt-heartbeat


**ğŸ“ ç®€å•ç†è§£**ï¼š
`pt-heartbeat`æ˜¯Perconaå·¥å…·é›†ä¸­ä¸“é—¨ç”¨æ¥**æµ‹é‡MySQLå¤åˆ¶å»¶è¿Ÿ**çš„å·¥å…·ã€‚å°±åƒç»™æ•°æ®åº“çš„"å¿ƒè·³"åšä½“æ£€ï¼Œå®æ—¶ç›‘æ§ä¸»ä»å¤åˆ¶çš„å¥åº·çŠ¶å†µã€‚

```
ç®€å•æ¯”å–»ï¼š
ä¸»åº“ â†’ ä»åº“ çš„æ•°æ®å¤åˆ¶å°±åƒæ¥åŠ›èµ›
pt-heartbeat å°±æ˜¯é‚£ä¸ªè®¡æ—¶å™¨
æµ‹é‡æ•°æ®ä»ä¸»åº“è·‘åˆ°ä»åº“ç”¨äº†å¤šé•¿æ—¶é—´
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**ï¼š
- **ç²¾ç¡®æµ‹é‡**ï¼šå‡†ç¡®è®¡ç®—å¤åˆ¶å»¶è¿Ÿæ—¶é—´
- **æŒç»­ç›‘æ§**ï¼š7x24å°æ—¶ä¸é—´æ–­ç›‘æ§
- **æ€§èƒ½è¯„ä¼°**ï¼šè¯„ä¼°ä»åº“çš„å¤åˆ¶æ€§èƒ½
- **é—®é¢˜é¢„è­¦**ï¼šå»¶è¿Ÿè¶…æ ‡æ—¶åŠæ—¶å‘Šè­¦

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§å¤åˆ¶å»¶è¿Ÿ


**ğŸš¨ å»¶è¿Ÿå¸¦æ¥çš„é—®é¢˜**ï¼š
```
è¯»å†™åˆ†ç¦»æ¶æ„ä¸­ï¼š
åº”ç”¨å†™å…¥ä¸»åº“ â†’ ç«‹å³ä»ä»åº“è¯»å–
å¦‚æœå»¶è¿Ÿè¿‡å¤§ â†’ è¯»ä¸åˆ°åˆšå†™å…¥çš„æ•°æ®
ç”¨æˆ·ä½“éªŒï¼šåˆšå‘çš„è¯„è®ºçœ‹ä¸åˆ°ï¼Œåˆšä¸‹çš„è®¢å•æŸ¥ä¸åˆ°
```

**ğŸ’¡ å»¶è¿Ÿç›‘æ§çš„ä»·å€¼**ï¼š
- **ä¸šåŠ¡ä¿éšœ**ï¼šç¡®ä¿è¯»å†™åˆ†ç¦»çš„æ•°æ®ä¸€è‡´æ€§
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŠæ—¶å‘ç°å¤åˆ¶æ€§èƒ½ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’**ï¼šè¯„ä¼°ä»åº“æ‰¿è½½èƒ½åŠ›
- **æ•…éšœé¢„é˜²**ï¼šå»¶è¿Ÿå¼‚å¸¸å¾€å¾€æ˜¯æ•…éšœå‰å…†

### 1.3 pt-heartbeat vs ä¼ ç»Ÿç›‘æ§æ–¹æ³•


**ä¼ ç»Ÿæ–¹æ³•çš„å±€é™**ï¼š
```sql
-- ä¼ ç»Ÿæ–¹æ³•ï¼šSHOW SLAVE STATUS
SHOW SLAVE STATUS\G
-- åªèƒ½çœ‹åˆ° Seconds_Behind_Master
-- ç²¾åº¦ä¸å¤Ÿï¼Œæ›´æ–°é¢‘ç‡ä½
-- æ— æ³•åŒºåˆ†ç½‘ç»œå»¶è¿Ÿå’Œå¤åˆ¶å»¶è¿Ÿ
```

**pt-heartbeatçš„ä¼˜åŠ¿**ï¼š
```
âœ… é«˜ç²¾åº¦ï¼šæ¯«ç§’çº§å»¶è¿Ÿæµ‹é‡
âœ… å®æ—¶æ€§ï¼šæŒç»­æ›´æ–°ï¼Œä¸é—´æ–­ç›‘æ§  
âœ… å¯å®šåˆ¶ï¼šçµæ´»çš„ç›‘æ§é—´éš”å’Œç»Ÿè®¡å‘¨æœŸ
âœ… å¤šç»´åº¦ï¼šåŒºåˆ†ç½‘ç»œå»¶è¿Ÿå’Œå¤„ç†å»¶è¿Ÿ
âœ… å†å²è®°å½•ï¼šä¿å­˜å»¶è¿Ÿå†å²æ•°æ®ç”¨äºåˆ†æ
```

---

## 2. âš¡ å¿ƒè·³æœºåˆ¶å·¥ä½œåŸç†


### 2.1 å¿ƒè·³æœºåˆ¶åŸºæœ¬åŸç†


**ğŸ’“ å¿ƒè·³çš„æœ¬è´¨**ï¼š
å¿ƒè·³æœºåˆ¶å°±æ˜¯åœ¨ä¸»åº“å®šæœŸæ’å…¥ä¸€æ¡**æ—¶é—´æˆ³è®°å½•**ï¼Œç„¶åæ£€æŸ¥è¿™æ¡è®°å½•ä»€ä¹ˆæ—¶å€™å‡ºç°åœ¨ä»åº“ï¼Œè®¡ç®—æ—¶é—´å·®å°±æ˜¯å¤åˆ¶å»¶è¿Ÿã€‚

```
å¿ƒè·³å·¥ä½œæµç¨‹ï¼š
                æ—¶é—´æˆ³T1
ä¸»åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä»åº“
     å†™å…¥å¿ƒè·³è®°å½•        æ—¶é—´æˆ³T2

å»¶è¿Ÿ = T2 - T1
```

**ğŸ”§ å…·ä½“å®ç°æ­¥éª¤**ï¼š
1. **ä¸»åº“å†™å…¥**ï¼šæ¯éš”Nç§’åœ¨ä¸»åº“æ’å…¥å½“å‰æ—¶é—´æˆ³
2. **ä»åº“è¯»å–**ï¼šä»åº“è¯»å–å¿ƒè·³è¡¨ä¸­çš„æœ€æ–°æ—¶é—´æˆ³
3. **è®¡ç®—å»¶è¿Ÿ**ï¼šå½“å‰æ—¶é—´ - å¿ƒè·³æ—¶é—´æˆ³ = å¤åˆ¶å»¶è¿Ÿ
4. **è®°å½•ç»“æœ**ï¼šä¿å­˜å»¶è¿Ÿæ•°æ®ç”¨äºç»Ÿè®¡åˆ†æ

### 2.2 å¿ƒè·³è¡¨ç»“æ„è®¾è®¡


**ğŸ“‹ å¿ƒè·³è¡¨çš„ç»“æ„**ï¼š
```sql
-- pt-heartbeat ä¼šè‡ªåŠ¨åˆ›å»ºè¿™æ ·çš„è¡¨
CREATE TABLE heartbeat (
    ts VARCHAR(26) NOT NULL,           -- æ—¶é—´æˆ³å­—ç¬¦ä¸²
    server_id INT UNSIGNED NOT NULL,   -- æœåŠ¡å™¨ID  
    file VARCHAR(255) DEFAULT NULL,    -- binlogæ–‡ä»¶å
    position BIGINT DEFAULT NULL,      -- binlogä½ç½®
    relay_master_log_file VARCHAR(255), -- ä¸­ç»§æ—¥å¿—ä¿¡æ¯
    exec_master_log_pos BIGINT,        -- æ‰§è¡Œä½ç½®
    PRIMARY KEY (server_id)
);
```

**ğŸ” å­—æ®µå«ä¹‰è§£é‡Š**ï¼š
- `ts`ï¼šå¿ƒè·³æ—¶é—´æˆ³ï¼Œè¿™æ˜¯**æœ€å…³é”®çš„å­—æ®µ**
- `server_id`ï¼šåŒºåˆ†ä¸åŒçš„MySQLæœåŠ¡å™¨
- `file/position`ï¼šè®°å½•binlogä½ç½®ï¼Œç”¨äºç²¾ç¡®å®šä½
- å…¶ä»–å­—æ®µï¼šç”¨äºæ›´è¯¦ç»†çš„å»¶è¿Ÿåˆ†æ

### 2.3 å¿ƒè·³æ›´æ–°æœºåˆ¶


**â° ä¸»åº“ç«¯çš„å¿ƒè·³æ›´æ–°**ï¼š
```sql
-- pt-heartbeat åœ¨ä¸»åº“æ‰§è¡Œç±»ä¼¼è¿™æ ·çš„æ›´æ–°
UPDATE heartbeat 
SET ts = NOW(6),           -- ç²¾ç¡®åˆ°å¾®ç§’
    file = $$BINLOG_FILE,  -- å½“å‰binlogæ–‡ä»¶
    position = $$BINLOG_POS -- å½“å‰binlogä½ç½®
WHERE server_id = $$SERVER_ID;
```

**ğŸ“– ä»åº“ç«¯çš„å»¶è¿Ÿæ£€æµ‹**ï¼š
```sql
-- pt-heartbeat åœ¨ä»åº“æ‰§è¡Œç±»ä¼¼è¿™æ ·çš„æŸ¥è¯¢
SELECT 
    UNIX_TIMESTAMP(NOW(6)) - UNIX_TIMESTAMP(ts) as delay
FROM heartbeat 
WHERE server_id = @master_server_id;
```

**ğŸ¯ å…³é”®è®¾è®¡è¦ç‚¹**ï¼š
- **å¾®ç§’ç²¾åº¦**ï¼š`NOW(6)`æä¾›å¾®ç§’çº§æ—¶é—´ç²¾åº¦
- **åŸå­æ›´æ–°**ï¼šä½¿ç”¨UPDATEè€Œä¸æ˜¯INSERTé¿å…ä¸»é”®å†²çª
- **è½»é‡æ“ä½œ**ï¼šæœ€å°åŒ–å¯¹ä¸»åº“æ€§èƒ½çš„å½±å“

---

## 3. ğŸ“ å¤åˆ¶å»¶è¿Ÿæµ‹é‡æ–¹æ³•


### 3.1 å»¶è¿Ÿæµ‹é‡çš„ç±»å‹


**ğŸ”¸ ä¸‰ç§ä¸åŒçš„å»¶è¿Ÿæ¦‚å¿µ**ï¼š

```
å®Œæ•´çš„å¤åˆ¶é“¾è·¯ï¼š
åº”ç”¨å†™å…¥ â†’ ä¸»åº“å¤„ç† â†’ binlogå†™å…¥ â†’ ç½‘ç»œä¼ è¾“ â†’ ä»åº“æ¥æ”¶ â†’ ä»åº“æ‰§è¡Œ

å¯¹åº”çš„å»¶è¿Ÿç±»å‹ï¼š
â”œâ”€ ç½‘ç»œå»¶è¿Ÿï¼šæ•°æ®ä¼ è¾“æ—¶é—´
â”œâ”€ é˜Ÿåˆ—å»¶è¿Ÿï¼šä»åº“æ‰§è¡Œé˜Ÿåˆ—å †ç§¯
â””â”€ æ€»ä½“å»¶è¿Ÿï¼šç«¯åˆ°ç«¯çš„å®Œæ•´æ—¶é—´
```

**ğŸ’¡ pt-heartbeatæµ‹é‡çš„æ˜¯æ€»ä½“å»¶è¿Ÿ**ï¼š
```sql
-- è¿™æ˜¯å®é™…çš„ç«¯åˆ°ç«¯å»¶è¿Ÿ
-- åŒ…å«äº†ç½‘ç»œä¼ è¾“ + ä»åº“å¤„ç†çš„æ€»æ—¶é—´
SELECT 
    ts,
    ROUND(
        (UNIX_TIMESTAMP(NOW(6)) - UNIX_TIMESTAMP(ts)) * 1000, 2
    ) AS delay_ms
FROM heartbeat;
```

### 3.2 å»¶è¿Ÿç²¾åº¦ä¸å‡†ç¡®æ€§


**â±ï¸ æ—¶é—´ç²¾åº¦ç­‰çº§**ï¼š
```
ç§’çº§ç²¾åº¦ï¼šNOW()          - é€‚åˆç²—ç•¥ç›‘æ§
æ¯«ç§’ç²¾åº¦ï¼šNOW(3)         - é€‚åˆä¸€èˆ¬ç›‘æ§  
å¾®ç§’ç²¾åº¦ï¼šNOW(6)         - é€‚åˆç²¾ç¡®ç›‘æ§ â† pt-heartbeatä½¿ç”¨
```

**ğŸ¯ æµ‹é‡å‡†ç¡®æ€§å½±å“å› ç´ **ï¼š
- **å¿ƒè·³é¢‘ç‡**ï¼šæ›´é¢‘ç¹çš„å¿ƒè·³ = æ›´å‡†ç¡®çš„å»¶è¿Ÿæµ‹é‡
- **æ—¶é’ŸåŒæ­¥**ï¼šä¸»ä»æœåŠ¡å™¨çš„æ—¶é’Ÿå¿…é¡»åŒæ­¥
- **è´Ÿè½½å½±å“**ï¼šé«˜è´Ÿè½½å¯èƒ½å½±å“å¿ƒè·³çš„åŠæ—¶æ›´æ–°

### 3.3 ç½‘ç»œå»¶è¿Ÿvså¤åˆ¶å»¶è¿Ÿ


**ğŸŒ åŒºåˆ†ç½‘ç»œå»¶è¿Ÿçš„æ–¹æ³•**ï¼š

```bash
# pt-heartbeat å¯ä»¥é€šè¿‡å‚æ•°åŒºåˆ†
--check-read-only    # æ£€æŸ¥ä»åº“çŠ¶æ€
--recurse           # é€’å½’æ£€æŸ¥å¤šçº§å¤åˆ¶
--dbi               # æ•°æ®åº“è¿æ¥ä¿¡æ¯
```

**ğŸ“Š å»¶è¿Ÿåˆ†è§£ç¤ºä¾‹**ï¼š
```
æ€»å»¶è¿Ÿ = 10ms
â”œâ”€ ç½‘ç»œå»¶è¿Ÿï¼š2ms    (pingä¸»ä»ä¹‹é—´çš„ç½‘ç»œå»¶è¿Ÿ)
â”œâ”€ é˜Ÿåˆ—ç­‰å¾…ï¼š3ms    (ä»åº“SQLçº¿ç¨‹é˜Ÿåˆ—ç­‰å¾…)  
â””â”€ æ‰§è¡Œå»¶è¿Ÿï¼š5ms    (å®é™…SQLæ‰§è¡Œæ—¶é—´)
```

---

## 4. ğŸ› ï¸ å·¥å…·å®‰è£…ä¸åŸºç¡€é…ç½®


### 4.1 pt-heartbeatå®‰è£…


**ğŸ“¦ å®‰è£…Perconaå·¥å…·é›†**ï¼š
```bash
# CentOS/RHEL å®‰è£…
sudo yum install percona-toolkit

# Ubuntu/Debian å®‰è£…  
sudo apt-get install percona-toolkit

# éªŒè¯å®‰è£…
pt-heartbeat --version
```

**ğŸ”§ æ‰‹åŠ¨å®‰è£…ï¼ˆå¦‚æœåŒ…ç®¡ç†å™¨ä¸å¯ç”¨ï¼‰**ï¼š
```bash
# ä¸‹è½½å¹¶å®‰è£…
wget https://www.percona.com/downloads/percona-toolkit/
tar -xzf percona-toolkit-*.tar.gz
sudo cp pt-heartbeat /usr/local/bin/
```

### 4.2 æ•°æ®åº“ç”¨æˆ·æƒé™é…ç½®


**ğŸ‘¤ åˆ›å»ºä¸“ç”¨ç›‘æ§ç”¨æˆ·**ï¼š
```sql
-- åœ¨ä¸»åº“æ‰§è¡Œ
CREATE USER 'heartbeat'@'%' IDENTIFIED BY 'secure_password';

-- æˆäºˆå¿…è¦æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON *.* TO 'heartbeat'@'%';
GRANT REPLICATION CLIENT ON *.* TO 'heartbeat'@'%';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

**ğŸ” æƒé™è¯´æ˜**ï¼š
- `SELECT`ï¼šè¯»å–å¿ƒè·³è¡¨æ•°æ®
- `INSERT/UPDATE/DELETE`ï¼šç»´æŠ¤å¿ƒè·³è¡¨
- `REPLICATION CLIENT`ï¼šæŸ¥çœ‹å¤åˆ¶çŠ¶æ€

### 4.3 åŸºç¡€é…ç½®æ–‡ä»¶


**ğŸ“„ åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š
```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p /etc/percona-toolkit

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /etc/percona-toolkit/pt-heartbeat.conf << 'EOF'
[client]
user=heartbeat
password=secure_password
host=localhost
port=3306

[pt-heartbeat]
database=test
table=heartbeat
interval=1
run-time=3600
log=/var/log/pt-heartbeat.log
EOF
```

**âš™ï¸ é…ç½®å‚æ•°è¯´æ˜**ï¼š
- `interval=1`ï¼šå¿ƒè·³é—´éš”1ç§’
- `run-time=3600`ï¼šè¿è¡Œæ—¶é—´1å°æ—¶
- `database=test`ï¼šå¿ƒè·³è¡¨æ‰€åœ¨æ•°æ®åº“
- `table=heartbeat`ï¼šå¿ƒè·³è¡¨å

---

## 5. ğŸš€ å»¶è¿Ÿç›‘æ§å®æˆ˜æ“ä½œ


### 5.1 å¯åŠ¨å¿ƒè·³ç›‘æ§


**ğŸ’“ åœ¨ä¸»åº“å¯åŠ¨å¿ƒè·³å‘é€**ï¼š
```bash
# å¯åŠ¨å¿ƒè·³å†™å…¥ï¼ˆä¸»åº“æ‰§è¡Œï¼‰
pt-heartbeat \
    --daemonize \
    --interval=1 \
    --update \
    --database=test \
    --table=heartbeat \
    --create-table \
    --host=192.168.1.10 \
    --user=heartbeat \
    --password=secure_password
```

**ğŸ“Š åœ¨ä»åº“ç›‘æ§å»¶è¿Ÿ**ï¼š
```bash
# ç›‘æ§å»¶è¿Ÿï¼ˆä»åº“æ‰§è¡Œï¼‰
pt-heartbeat \
    --monitor \
    --database=test \
    --table=heartbeat \
    --master-server-id=1 \
    --host=192.168.1.11 \
    --user=heartbeat \
    --password=secure_password
```

### 5.2 å¸¸ç”¨ç›‘æ§å‚æ•°


**ğŸ”§ é‡è¦å‚æ•°è¯¦è§£**ï¼š
```bash
# å®Œæ•´çš„ç›‘æ§å‘½ä»¤
pt-heartbeat \
    --monitor \                    # ç›‘æ§æ¨¡å¼
    --check-read-only \           # æ£€æŸ¥åªè¯»çŠ¶æ€
    --interval=1 \                # æ£€æŸ¥é—´éš”1ç§’
    --frames=60 \                 # ç»Ÿè®¡60ä¸ªæ ·æœ¬
    --database=test \             # æ•°æ®åº“å
    --table=heartbeat \           # è¡¨å
    --master-server-id=1 \        # ä¸»åº“server_id
    --print-master-server-id \    # æ˜¾ç¤ºä¸»åº“ID
    --daemonize                   # åå°è¿è¡Œ
```

**ğŸ“‹ å‚æ•°å«ä¹‰è¯´æ˜**ï¼š
- `--monitor`ï¼šç›‘æ§æ¨¡å¼ï¼ŒæŒç»­æ£€æŸ¥å»¶è¿Ÿ
- `--frames=60`ï¼šç»Ÿè®¡æœ€è¿‘60ä¸ªé‡‡æ ·ç‚¹
- `--check-read-only`ï¼šç¡®è®¤ä»åº“å¤„äºåªè¯»çŠ¶æ€
- `--print-master-server-id`ï¼šè¾“å‡ºä¸­æ˜¾ç¤ºä¸»åº“ID

### 5.3 ç›‘æ§è¾“å‡ºè§£è¯»


**ğŸ“ˆ å…¸å‹çš„ç›‘æ§è¾“å‡º**ï¼š
```bash
# pt-heartbeat çš„è¾“å‡ºç¤ºä¾‹
2025-01-21T15:30:01 0.12s [ 0.05s,  0.25s,  0.12s]
2025-01-21T15:30:02 0.08s [ 0.03s,  0.15s,  0.09s]  
2025-01-21T15:30:03 0.15s [ 0.08s,  0.22s,  0.13s]
```

**ğŸ” è¾“å‡ºå­—æ®µè§£é‡Š**ï¼š
```
æ—¶é—´æˆ³           å½“å‰å»¶è¿Ÿ    [æœ€å°å€¼, æœ€å¤§å€¼, å¹³å‡å€¼]
â”œâ”€ 15:30:01     0.12s      æœ€è¿‘60ä¸ªæ ·æœ¬çš„ç»Ÿè®¡
â”œâ”€ 15:30:02     0.08s      å®æ—¶å»¶è¿Ÿå˜åŒ–
â””â”€ 15:30:03     0.15s      å»¶è¿Ÿè¶‹åŠ¿åˆ†æ
```

---

## 6. ğŸ“Š å»¶è¿Ÿç»Ÿè®¡åˆ†æ


### 6.1 å»¶è¿Ÿæ•°æ®ç»Ÿè®¡


**ğŸ“ˆ ç”Ÿæˆå»¶è¿Ÿç»Ÿè®¡æŠ¥å‘Š**ï¼š
```bash
# è¿è¡Œ60ç§’å¹¶ç”Ÿæˆç»Ÿè®¡
pt-heartbeat \
    --monitor \
    --run-time=60 \
    --interval=1 \
    --frames=60 \
    --database=test \
    --table=heartbeat \
    --master-server-id=1 > delay_report.txt
```

**ğŸ”¢ ç»Ÿè®¡æ•°æ®è§£è¯»**ï¼š
```
å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡ï¼š
æœ€å°å»¶è¿Ÿï¼š0.05s    â† ç½‘ç»œåŸºç¡€å»¶è¿Ÿ
æœ€å¤§å»¶è¿Ÿï¼š2.30s    â† å¯èƒ½æœ‰æ€§èƒ½ç“¶é¢ˆ  
å¹³å‡å»¶è¿Ÿï¼š0.15s    â† æ­£å¸¸æ°´å¹³
95%åˆ†ä½ï¼š0.25s     â† å¤§éƒ¨åˆ†è¯·æ±‚çš„å»¶è¿Ÿä¸Šé™
99%åˆ†ä½ï¼š0.45s     â† å‡ ä¹æ‰€æœ‰è¯·æ±‚çš„å»¶è¿Ÿä¸Šé™
```

### 6.2 å»¶è¿Ÿè¶‹åŠ¿åˆ†æ


**ğŸ“‰ åˆ›å»ºå»¶è¿Ÿè¶‹åŠ¿å›¾**ï¼š
```bash
# æŒç»­ç›‘æ§å¹¶ä¿å­˜åˆ°æ–‡ä»¶
pt-heartbeat \
    --monitor \
    --run-time=3600 \
    --interval=5 \
    --database=test \
    --table=heartbeat \
    --master-server-id=1 \
    --log=/var/log/heartbeat_trend.log
```

**ğŸ“Š åˆ†æå»¶è¿Ÿæ¨¡å¼**ï¼š
```
æ—¶é—´æ®µåˆ†æï¼š
08:00-12:00  å¹³å‡å»¶è¿Ÿ 0.1s   â† ä¸šåŠ¡ä½å³°æœŸ
12:00-14:00  å¹³å‡å»¶è¿Ÿ 0.3s   â† åˆé—´é«˜å³°æœŸ  
14:00-18:00  å¹³å‡å»¶è¿Ÿ 0.2s   â† ä¸‹åˆç¨³å®šæœŸ
18:00-22:00  å¹³å‡å»¶è¿Ÿ 0.5s   â† æ™šé—´é«˜å³°æœŸ
```

### 6.3 ä»åº“æ€§èƒ½è¯„ä¼°


**âš–ï¸ åŸºäºå»¶è¿Ÿè¯„ä¼°ä»åº“æ€§èƒ½**ï¼š
```bash
# ç»¼åˆæ€§èƒ½è¯„ä¼°è„šæœ¬
cat > evaluate_slave.sh << 'EOF'
#!/bin/bash

echo "=== ä»åº“æ€§èƒ½è¯„ä¼°æŠ¥å‘Š ==="

# è·å–å½“å‰å»¶è¿Ÿ
CURRENT_DELAY=$(pt-heartbeat --monitor --check --database=test --table=heartbeat --master-server-id=1)

# è¯„ä¼°æ€§èƒ½ç­‰çº§
if (( $(echo "$CURRENT_DELAY < 0.1" | bc -l) )); then
    echo "æ€§èƒ½ç­‰çº§: ä¼˜ç§€ (å»¶è¿Ÿ < 0.1s)"
elif (( $(echo "$CURRENT_DELAY < 0.5" | bc -l) )); then
    echo "æ€§èƒ½ç­‰çº§: è‰¯å¥½ (å»¶è¿Ÿ < 0.5s)"
elif (( $(echo "$CURRENT_DELAY < 1.0" | bc -l) )); then
    echo "æ€§èƒ½ç­‰çº§: ä¸€èˆ¬ (å»¶è¿Ÿ < 1.0s)"
else
    echo "æ€§èƒ½ç­‰çº§: éœ€è¦ä¼˜åŒ– (å»¶è¿Ÿ â‰¥ 1.0s)"
fi
EOF
```

---

## 7. ğŸš¨ å®æ—¶ç›‘æ§ä¸å‘Šè­¦


### 7.1 å»¶è¿Ÿé˜ˆå€¼å‘Šè­¦


**âš ï¸ è®¾ç½®å‘Šè­¦è„šæœ¬**ï¼š
```bash
# åˆ›å»ºå»¶è¿Ÿå‘Šè­¦è„šæœ¬
cat > heartbeat_alert.sh << 'EOF'
#!/bin/bash

# é…ç½®å‘Šè­¦é˜ˆå€¼
WARNING_THRESHOLD=0.5   # è­¦å‘Šé˜ˆå€¼ï¼š0.5ç§’
CRITICAL_THRESHOLD=2.0  # ä¸¥é‡é˜ˆå€¼ï¼š2.0ç§’

# è·å–å½“å‰å»¶è¿Ÿ
DELAY=$(pt-heartbeat --check --database=test --table=heartbeat --master-server-id=1)

# æ£€æŸ¥å‘Šè­¦çº§åˆ«
if (( $(echo "$DELAY > $CRITICAL_THRESHOLD" | bc -l) )); then
    echo "CRITICAL: å¤åˆ¶å»¶è¿Ÿä¸¥é‡ ${DELAY}s"
    # å‘é€ç´§æ€¥å‘Šè­¦é‚®ä»¶
    echo "ä¸»ä»å¤åˆ¶å»¶è¿Ÿè¾¾åˆ° ${DELAY}sï¼Œè¶…è¿‡ä¸´ç•Œå€¼ ${CRITICAL_THRESHOLD}s" | \
    mail -s "MySQLå¤åˆ¶å»¶è¿Ÿä¸¥é‡å‘Šè­¦" admin@company.com
    
elif (( $(echo "$DELAY > $WARNING_THRESHOLD" | bc -l) )); then
    echo "WARNING: å¤åˆ¶å»¶è¿Ÿåé«˜ ${DELAY}s"  
    # è®°å½•è­¦å‘Šæ—¥å¿—
    echo "$(date): å¤åˆ¶å»¶è¿Ÿè­¦å‘Š ${DELAY}s" >> /var/log/mysql_delay_warning.log
    
else
    echo "OK: å¤åˆ¶å»¶è¿Ÿæ­£å¸¸ ${DELAY}s"
fi
EOF

chmod +x heartbeat_alert.sh
```

### 7.2 é›†æˆç›‘æ§ç³»ç»Ÿ


**ğŸ“¡ ä¸Nagiosé›†æˆ**ï¼š
```bash
# Nagiosæ£€æŸ¥è„šæœ¬
cat > /usr/local/nagios/libexec/check_mysql_replication_delay << 'EOF'
#!/bin/bash

WARNING=$1
CRITICAL=$2

if [ -z "$WARNING" ] || [ -z "$CRITICAL" ]; then
    echo "Usage: $0 <warning_threshold> <critical_threshold>"
    exit 3
fi

DELAY=$(pt-heartbeat --check --database=test --table=heartbeat --master-server-id=1 2>/dev/null)

if [ $? -ne 0 ]; then
    echo "UNKNOWN: æ— æ³•è·å–å¤åˆ¶å»¶è¿Ÿ"
    exit 3
fi

if (( $(echo "$DELAY > $CRITICAL" | bc -l) )); then
    echo "CRITICAL: å¤åˆ¶å»¶è¿Ÿ ${DELAY}s | delay=${DELAY}s;${WARNING};${CRITICAL}"
    exit 2
elif (( $(echo "$DELAY > $WARNING" | bc -l) )); then  
    echo "WARNING: å¤åˆ¶å»¶è¿Ÿ ${DELAY}s | delay=${DELAY}s;${WARNING};${CRITICAL}"
    exit 1
else
    echo "OK: å¤åˆ¶å»¶è¿Ÿ ${DELAY}s | delay=${DELAY}s;${WARNING};${CRITICAL}"
    exit 0
fi
EOF
```

### 7.3 å»¶è¿Ÿé¢„è­¦æœºåˆ¶


**ğŸ”® è¶‹åŠ¿é¢„è­¦ç³»ç»Ÿ**ï¼š
```bash
# å»¶è¿Ÿè¶‹åŠ¿é¢„è­¦
cat > trend_alert.sh << 'EOF'  
#!/bin/bash

# è·å–æœ€è¿‘10åˆ†é’Ÿçš„å»¶è¿Ÿæ•°æ®
RECENT_DELAYS=$(tail -n 600 /var/log/heartbeat_trend.log | awk '{print $2}')

# è®¡ç®—å¹³å‡å»¶è¿Ÿ
AVG_DELAY=$(echo "$RECENT_DELAYS" | awk '{sum+=$1; count++} END {print sum/count}')

# æ£€æŸ¥å»¶è¿Ÿå¢é•¿è¶‹åŠ¿
TREND=$(echo "$RECENT_DELAYS" | awk '
    NR==1 {first=$1}
    END {
        if(NR>1) {
            trend = ($1 - first) / first * 100
            print trend
        } else {
            print 0
        }
    }
')

# è¶‹åŠ¿å‘Šè­¦
if (( $(echo "$TREND > 50" | bc -l) )); then
    echo "ALERT: å»¶è¿Ÿå¢é•¿è¶‹åŠ¿å¼‚å¸¸ï¼Œå¢é•¿${TREND}%"
    echo "å¹³å‡å»¶è¿Ÿï¼š${AVG_DELAY}s"
fi
EOF
```

---

## 8. ğŸ”— å¤šçº§å¤åˆ¶å»¶è¿Ÿç›‘æ§


### 8.1 å¤šçº§å¤åˆ¶æ¶æ„ç†è§£


**ğŸ—ï¸ å¤šçº§å¤åˆ¶æ¶æ„ç¤ºä¾‹**ï¼š
```
å¤šçº§å¤åˆ¶é“¾è·¯ï¼š
ä¸»åº“(Master) â†’ ä»åº“1(Slave1) â†’ ä»åº“2(Slave2) â†’ ä»åº“3(Slave3)
     â†“              â†“              â†“              â†“
   å†™å…¥æ•°æ®      ç¬¬1çº§å»¶è¿Ÿ      ç¬¬2çº§å»¶è¿Ÿ      ç¬¬3çº§å»¶è¿Ÿ

ç´¯ç§¯å»¶è¿Ÿ = ç¬¬1çº§ + ç¬¬2çº§ + ç¬¬3çº§
```

**ğŸ¯ ç›‘æ§æŒ‘æˆ˜**ï¼š
- **ç´¯ç§¯æ•ˆåº”**ï¼šä¸‹çº§ä»åº“çš„å»¶è¿Ÿä¼šç´¯ç§¯ä¸Šçº§çš„å»¶è¿Ÿ
- **æ•…éšœä¼ æ’­**ï¼šä¸Šçº§æ•…éšœä¼šå½±å“æ‰€æœ‰ä¸‹çº§ä»åº“  
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šéœ€è¦è¯†åˆ«å“ªä¸€çº§æ˜¯ç“¶é¢ˆ

### 8.2 é…ç½®å¤šçº§ç›‘æ§


**ğŸ”§ ä¸»åº“é…ç½®ï¼ˆç¬¬0çº§ï¼‰**ï¼š
```bash
# ä¸»åº“å¯åŠ¨å¿ƒè·³
pt-heartbeat \
    --update \
    --database=test \
    --table=heartbeat \
    --interval=1 \
    --host=master.db.com \
    --user=heartbeat \
    --daemonize
```

**ğŸ“Š å„çº§ä»åº“ç›‘æ§é…ç½®**ï¼š
```bash
# ç¬¬1çº§ä»åº“ç›‘æ§ï¼ˆç›´æ¥è¿æ¥ä¸»åº“ï¼‰
pt-heartbeat \
    --monitor \
    --database=test \
    --table=heartbeat \
    --master-server-id=1 \
    --host=slave1.db.com \
    --interval=1 \
    --log=/var/log/slave1_delay.log &

# ç¬¬2çº§ä»åº“ç›‘æ§ï¼ˆè¿æ¥ç¬¬1çº§ä»åº“ï¼‰  
pt-heartbeat \
    --monitor \
    --database=test \
    --table=heartbeat \
    --master-server-id=1 \
    --host=slave2.db.com \
    --interval=1 \
    --log=/var/log/slave2_delay.log &
```

### 8.3 å¤šçº§å»¶è¿Ÿåˆ†æ


**ğŸ“ˆ å»¶è¿Ÿåˆ†è§£åˆ†æè„šæœ¬**ï¼š
```bash
# å¤šçº§å»¶è¿Ÿåˆ†æå·¥å…·
cat > multilevel_delay_analysis.sh << 'EOF'
#!/bin/bash

echo "=== å¤šçº§å¤åˆ¶å»¶è¿Ÿåˆ†æ ==="

# è·å–å„çº§å»¶è¿Ÿ
DELAY_L1=$(pt-heartbeat --check --host=slave1.db.com --database=test --table=heartbeat --master-server-id=1)
DELAY_L2=$(pt-heartbeat --check --host=slave2.db.com --database=test --table=heartbeat --master-server-id=1)  
DELAY_L3=$(pt-heartbeat --check --host=slave3.db.com --database=test --table=heartbeat --master-server-id=1)

echo "ç¬¬1çº§ä»åº“å»¶è¿Ÿ: ${DELAY_L1}s"
echo "ç¬¬2çº§ä»åº“å»¶è¿Ÿ: ${DELAY_L2}s"  
echo "ç¬¬3çº§ä»åº“å»¶è¿Ÿ: ${DELAY_L3}s"

# è®¡ç®—å„çº§ç‹¬ç«‹å»¶è¿Ÿ
INDEPENDENT_L2=$(echo "$DELAY_L2 - $DELAY_L1" | bc -l)
INDEPENDENT_L3=$(echo "$DELAY_L3 - $DELAY_L2" | bc -l)

echo ""
echo "=== å„çº§ç‹¬ç«‹å»¶è¿Ÿ ==="
echo "ä¸»åº“â†’ç¬¬1çº§: ${DELAY_L1}s"
echo "ç¬¬1çº§â†’ç¬¬2çº§: ${INDEPENDENT_L2}s"
echo "ç¬¬2çº§â†’ç¬¬3çº§: ${INDEPENDENT_L3}s"

# è¯†åˆ«ç“¶é¢ˆ
MAX_DELAY=$DELAY_L1
BOTTLENECK="ç¬¬1çº§ä»åº“"

if (( $(echo "$INDEPENDENT_L2 > $MAX_DELAY" | bc -l) )); then
    MAX_DELAY=$INDEPENDENT_L2
    BOTTLENECK="ç¬¬2çº§ä»åº“"
fi

if (( $(echo "$INDEPENDENT_L3 > $MAX_DELAY" | bc -l) )); then
    BOTTLENECK="ç¬¬3çº§ä»åº“"
fi

echo ""
echo "æ€§èƒ½ç“¶é¢ˆ: $BOTTLENECK"
EOF
```

---

## 9. ğŸ”§ å»¶è¿Ÿæ ¹å› åˆ†æä¸ä¼˜åŒ–


### 9.1 å»¶è¿Ÿæ ¹å› åˆ†æ


**ğŸ•µï¸ å»¶è¿ŸåŸå› è¯Šæ–­æµç¨‹**ï¼š
```
å»¶è¿Ÿæ ¹å› åˆ†ææµç¨‹ï¼š
â”œâ”€ 1. ç½‘ç»œå±‚é¢æ£€æŸ¥
â”‚   â”œâ”€ pingæµ‹è¯•ï¼šä¸»ä»ä¹‹é—´ç½‘ç»œå»¶è¿Ÿ
â”‚   â”œâ”€ å¸¦å®½æµ‹è¯•ï¼šç½‘ç»œååé‡æ˜¯å¦è¶³å¤Ÿ
â”‚   â””â”€ ä¸¢åŒ…ç‡æ£€æŸ¥ï¼šç½‘ç»œç¨³å®šæ€§
â”‚
â”œâ”€ 2. MySQLé…ç½®æ£€æŸ¥  
â”‚   â”œâ”€ binlogé…ç½®ï¼šsync_binlogè®¾ç½®
â”‚   â”œâ”€ å¤åˆ¶é…ç½®ï¼šslave_parallel_workers
â”‚   â””â”€ ç¼“å†²åŒºé…ç½®ï¼šinnodb_buffer_pool_size
â”‚
â”œâ”€ 3. ç³»ç»Ÿèµ„æºæ£€æŸ¥
â”‚   â”œâ”€ CPUä½¿ç”¨ç‡ï¼šæ˜¯å¦CPUç“¶é¢ˆ
â”‚   â”œâ”€ å†…å­˜ä½¿ç”¨ï¼šæ˜¯å¦å†…å­˜ä¸è¶³
â”‚   â”œâ”€ ç£ç›˜IOï¼šæ˜¯å¦IOç“¶é¢ˆ  
â”‚   â””â”€ è´Ÿè½½å‡è¡¡ï¼šè¯»å†™å‹åŠ›åˆ†å¸ƒ
â”‚
â””â”€ 4. åº”ç”¨å±‚é¢æ£€æŸ¥
    â”œâ”€ å¤§äº‹åŠ¡ï¼šé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
    â”œâ”€ é”ç­‰å¾…ï¼šè¡¨é”ã€è¡Œé”å†²çª
    â””â”€ æŸ¥è¯¢æ€§èƒ½ï¼šæ…¢æŸ¥è¯¢å½±å“
```

**ğŸ” å…·ä½“è¯Šæ–­è„šæœ¬**ï¼š
```bash
# å»¶è¿Ÿæ ¹å› åˆ†æè„šæœ¬
cat > delay_root_cause_analysis.sh << 'EOF'
#!/bin/bash

echo "=== MySQLå¤åˆ¶å»¶è¿Ÿæ ¹å› åˆ†æ ==="

# 1. ç½‘ç»œå±‚é¢æ£€æŸ¥
echo "1. ç½‘ç»œè¿æ¥æ£€æŸ¥:"
ping -c 3 slave1.db.com | grep "time="

# 2. å¤åˆ¶çŠ¶æ€æ£€æŸ¥
echo "2. å¤åˆ¶çŠ¶æ€æ£€æŸ¥:"
mysql -h slave1.db.com -u heartbeat -p -e "
    SELECT 
        Slave_IO_Running,
        Slave_SQL_Running, 
        Seconds_Behind_Master,
        Last_IO_Error,
        Last_SQL_Error
    FROM information_schema.SLAVE_HOSTS\G
"

# 3. ç³»ç»Ÿèµ„æºæ£€æŸ¥
echo "3. ä»åº“ç³»ç»Ÿèµ„æº:"
ssh slave1.db.com "
    echo 'CPUä½¿ç”¨ç‡:'; top -bn1 | grep 'Cpu(s)'
    echo 'å†…å­˜ä½¿ç”¨:'; free -h
    echo 'ç£ç›˜IO:'; iostat -x 1 1
"

# 4. MySQLè¿›ç¨‹çŠ¶æ€
echo "4. MySQLè¿›ç¨‹çŠ¶æ€:"
mysql -h slave1.db.com -u heartbeat -p -e "
    SHOW PROCESSLIST\G
" | grep -E "State:|Time:|Info:"

# 5. é…ç½®å‚æ•°æ£€æŸ¥
echo "5. å…³é”®é…ç½®å‚æ•°:"
mysql -h slave1.db.com -u heartbeat -p -e "
    SHOW VARIABLES LIKE 'slave_parallel_workers';
    SHOW VARIABLES LIKE 'sync_binlog';  
    SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
"
EOF
```

### 9.2 å»¶è¿Ÿä¼˜åŒ–å»ºè®®


**âš¡ å¸¸è§ä¼˜åŒ–ç­–ç•¥**ï¼š

```
ä¼˜åŒ–æ–¹å‘ä¸€ï¼šç¡¬ä»¶èµ„æºä¼˜åŒ–
â”œâ”€ CPUå‡çº§ï¼šæé«˜ä¸»é¢‘ï¼Œå¢åŠ æ ¸å¿ƒæ•°
â”œâ”€ å†…å­˜æ‰©å®¹ï¼šå¢å¤§buffer poolï¼Œå‡å°‘ç£ç›˜IO
â”œâ”€ ç£ç›˜ä¼˜åŒ–ï¼šä½¿ç”¨SSDï¼Œé…ç½®RAID
â””â”€ ç½‘ç»œä¼˜åŒ–ï¼šä¸‡å…†ç½‘å¡ï¼Œä¸“ç”¨ç½‘ç»œ

ä¼˜åŒ–æ–¹å‘äºŒï¼šMySQLé…ç½®ä¼˜åŒ–
â”œâ”€ å¹¶è¡Œå¤åˆ¶ï¼šslave_parallel_workers > 1
â”œâ”€ binlogä¼˜åŒ–ï¼šsync_binlog = 0 (æ€§èƒ½ä¼˜å…ˆåœºæ™¯)
â”œâ”€ ç¼“å­˜ä¼˜åŒ–ï¼šinnodb_buffer_pool_sizeè°ƒä¼˜
â””â”€ è¿æ¥ä¼˜åŒ–ï¼šå¢å¤§max_connections

ä¼˜åŒ–æ–¹å‘ä¸‰ï¼šåº”ç”¨å±‚ä¼˜åŒ–
â”œâ”€ äº‹åŠ¡æ‹†åˆ†ï¼šé¿å…å¤§äº‹åŠ¡é˜»å¡å¤åˆ¶
â”œâ”€ è¯»å†™åˆ†ç¦»ï¼šåˆç†åˆ†é…è¯»å†™å‹åŠ›
â”œâ”€ æŸ¥è¯¢ä¼˜åŒ–ï¼šæ¶ˆé™¤æ…¢æŸ¥è¯¢
â””â”€ ç´¢å¼•ä¼˜åŒ–ï¼šå‡å°‘é”ç­‰å¾…æ—¶é—´
```

**ğŸ› ï¸ ä¼˜åŒ–é…ç½®ç¤ºä¾‹**ï¼š
```sql
-- MySQLä»åº“ä¼˜åŒ–é…ç½®
SET GLOBAL slave_parallel_workers = 4;           -- å¼€å¯å¹¶è¡Œå¤åˆ¶
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK'; -- å¹¶è¡Œå¤åˆ¶ç±»å‹
SET GLOBAL slave_preserve_commit_order = 1;       -- ä¿æŒæäº¤é¡ºåº

-- InnoDBä¼˜åŒ–
SET GLOBAL innodb_buffer_pool_size = '8G';        -- æ ¹æ®å†…å­˜è°ƒæ•´
SET GLOBAL innodb_log_file_size = '512M';         -- å¢å¤§redo log
SET GLOBAL innodb_flush_log_at_trx_commit = 2;    -- æ€§èƒ½ä¼˜å…ˆè®¾ç½®
```

### 9.3 å»¶è¿ŸSLAç®¡ç†


**ğŸ“‹ å»ºç«‹å»¶è¿ŸSLAæ ‡å‡†**ï¼š
```
å»¶è¿ŸSLAç­‰çº§å®šä¹‰ï¼š
â”œâ”€ é‡‘ç‰ŒæœåŠ¡ï¼šå»¶è¿Ÿ < 100msï¼Œå¯ç”¨æ€§ 99.9%
â”œâ”€ é“¶ç‰ŒæœåŠ¡ï¼šå»¶è¿Ÿ < 500msï¼Œå¯ç”¨æ€§ 99.5%  
â”œâ”€ é“œç‰ŒæœåŠ¡ï¼šå»¶è¿Ÿ < 1000msï¼Œå¯ç”¨æ€§ 99.0%
â””â”€ åŸºç¡€æœåŠ¡ï¼šå»¶è¿Ÿ < 2000msï¼Œå¯ç”¨æ€§ 95.0%
```

**ğŸ“Š SLAç›‘æ§æŠ¥å‘Š**ï¼š
```bash
# SLAè¾¾æ ‡ç‡ç»Ÿè®¡è„šæœ¬
cat > sla_report.sh << 'EOF'
#!/bin/bash

# åˆ†ææœ€è¿‘24å°æ—¶çš„å»¶è¿Ÿæ•°æ®
LOGFILE="/var/log/heartbeat_trend.log"
TOTAL_SAMPLES=$(wc -l < $LOGFILE)

# ç»Ÿè®¡å„SLAç­‰çº§è¾¾æ ‡ç‡
GOLD_COUNT=$(awk '$2 < 0.1 {count++} END {print count+0}' $LOGFILE)
SILVER_COUNT=$(awk '$2 < 0.5 {count++} END {print count+0}' $LOGFILE)  
BRONZE_COUNT=$(awk '$2 < 1.0 {count++} END {print count+0}' $LOGFILE)

echo "=== å»¶è¿ŸSLAè¾¾æ ‡ç‡æŠ¥å‘Š ==="
echo "æ€»æ ·æœ¬æ•°: $TOTAL_SAMPLES"
echo "é‡‘ç‰Œè¾¾æ ‡ç‡: $(echo "scale=2; $GOLD_COUNT * 100 / $TOTAL_SAMPLES" | bc)%"
echo "é“¶ç‰Œè¾¾æ ‡ç‡: $(echo "scale=2; $SILVER_COUNT * 100 / $TOTAL_SAMPLES" | bc)%"  
echo "é“œç‰Œè¾¾æ ‡ç‡: $(echo "scale=2; $BRONZE_COUNT * 100 / $TOTAL_SAMPLES" | bc)%"
EOF
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ pt-heartbeatæœ¬è´¨ï¼šé€šè¿‡å¿ƒè·³æœºåˆ¶ç²¾ç¡®æµ‹é‡MySQLå¤åˆ¶å»¶è¿Ÿçš„ä¸“ä¸šå·¥å…·
ğŸ”¸ å·¥ä½œåŸç†ï¼šä¸»åº“å®šæœŸå†™å…¥æ—¶é—´æˆ³ï¼Œä»åº“è¯»å–è®¡ç®—å»¶è¿Ÿï¼Œå®ç°ç«¯åˆ°ç«¯ç›‘æ§
ğŸ”¸ å»¶è¿Ÿç±»å‹ï¼šç½‘ç»œå»¶è¿Ÿã€é˜Ÿåˆ—å»¶è¿Ÿã€æ‰§è¡Œå»¶è¿Ÿçš„ç»¼åˆæµ‹é‡
ğŸ”¸ ç›‘æ§ä»·å€¼ï¼šä¿éšœè¯»å†™åˆ†ç¦»æ•°æ®ä¸€è‡´æ€§ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ
ğŸ”¸ å¤šçº§å¤åˆ¶ï¼šæ”¯æŒå¤æ‚æ‹“æ‰‘ç»“æ„çš„å»¶è¿Ÿç›‘æ§å’Œç“¶é¢ˆåˆ†æ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ä¸“ä¸šçš„å»¶è¿Ÿç›‘æ§å·¥å…·**
```
ä¼ ç»ŸSHOW SLAVE STATUSçš„å±€é™ï¼š
- ç²¾åº¦ä¸å¤Ÿï¼šåªèƒ½åˆ°ç§’çº§
- æ›´æ–°é¢‘ç‡ä½ï¼šä¸æ˜¯å®æ—¶çš„  
- ä¿¡æ¯æœ‰é™ï¼šæ— æ³•åŒºåˆ†å»¶è¿Ÿç±»å‹
- åˆ†æå›°éš¾ï¼šç¼ºä¹å†å²æ•°æ®å’Œè¶‹åŠ¿

pt-heartbeatçš„ä¼˜åŠ¿ï¼š
- å¾®ç§’çº§ç²¾åº¦çš„å®æ—¶ç›‘æ§
- æŒç»­çš„å†å²æ•°æ®è®°å½•
- å¤šç»´åº¦çš„å»¶è¿Ÿåˆ†æ
- çµæ´»çš„å‘Šè­¦å’Œç»Ÿè®¡åŠŸèƒ½
```

**ğŸ”¹ å¿ƒè·³æœºåˆ¶çš„è®¾è®¡ç²¾å¦™ä¹‹å¤„**
```
è½»é‡åŒ–è®¾è®¡ï¼š
- æœ€å°åŒ–å¯¹ä¸»åº“æ€§èƒ½å½±å“
- ä½¿ç”¨UPDATEè€Œä¸æ˜¯INSERTé¿å…ä¸»é”®å†²çª
- ç²¾ç¡®åˆ°å¾®ç§’çš„æ—¶é—´æˆ³

å‡†ç¡®æ€§ä¿éšœï¼š
- ç«¯åˆ°ç«¯çš„çœŸå®å»¶è¿Ÿæµ‹é‡
- è€ƒè™‘äº†ç½‘ç»œä¼ è¾“å’Œä»åº“å¤„ç†æ—¶é—´
- é€šè¿‡ç»Ÿè®¡åˆ†ææä¾›å¯é æ•°æ®
```

**ğŸ”¹ å¤šçº§å¤åˆ¶ç›‘æ§çš„å…³é”®ç‚¹**
```
ç´¯ç§¯æ•ˆåº”ç†è§£ï¼š
- ä¸‹çº§ä»åº“å»¶è¿ŸåŒ…å«ä¸Šçº§å»¶è¿Ÿ
- éœ€è¦è®¡ç®—å„çº§ç‹¬ç«‹å»¶è¿Ÿ
- è¯†åˆ«çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆèŠ‚ç‚¹

ç›‘æ§ç­–ç•¥ï¼š
- æ¯çº§éƒ½éœ€è¦ç‹¬ç«‹ç›‘æ§
- å¯¹æ¯”åˆ†ææ‰¾å‡ºç“¶é¢ˆ
- ä¼˜åŒ–è¦ä»ç“¶é¢ˆèŠ‚ç‚¹å¼€å§‹
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ éƒ¨ç½²å»ºè®®**
```
ç›‘æ§é¢‘ç‡é€‰æ‹©ï¼š
âœ… é«˜é¢‘ä¸šåŠ¡ï¼š1ç§’é—´éš”ç›‘æ§
âœ… ä¸€èˆ¬ä¸šåŠ¡ï¼š5ç§’é—´éš”ç›‘æ§  
âœ… åå°ä¸šåŠ¡ï¼š30ç§’é—´éš”ç›‘æ§

å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
âœ… è­¦å‘Šé˜ˆå€¼ï¼šä¸šåŠ¡èƒ½å®¹å¿çš„æœ€å¤§å»¶è¿Ÿ
âœ… ä¸¥é‡é˜ˆå€¼ï¼šå½±å“ç”¨æˆ·ä½“éªŒçš„å»¶è¿Ÿ
âœ… è¶‹åŠ¿å‘Šè­¦ï¼šå»¶è¿Ÿå¢é•¿è¶…è¿‡50%
```

**ğŸ› ï¸ ä¼˜åŒ–å®è·µ**
```
æ€§èƒ½ä¼˜åŒ–é¡ºåºï¼š
1. ç¡¬ä»¶èµ„æºï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
2. MySQLé…ç½®ï¼šå¹¶è¡Œå¤åˆ¶ã€ç¼“å†²åŒºã€binlog
3. åº”ç”¨ä¼˜åŒ–ï¼šäº‹åŠ¡æ‹†åˆ†ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•
4. æ¶æ„è°ƒæ•´ï¼šè¯»å†™åˆ†ç¦»ã€è´Ÿè½½å‡è¡¡

ç›‘æ§é›†æˆï¼š
- ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿé›†æˆ
- å»ºç«‹å®Œæ•´çš„å‘Šè­¦æœºåˆ¶  
- å®šæœŸç”ŸæˆSLAæŠ¥å‘Š
- æŒç»­ä¼˜åŒ–ç›‘æ§ç­–ç•¥
```

### 10.4 æ•…éšœå¤„ç†æµç¨‹


**ğŸš¨ å»¶è¿Ÿå¼‚å¸¸å¤„ç†æ­¥éª¤**
```
1. ç«‹å³å“åº”ï¼š
   - ç¡®è®¤å‘Šè­¦çœŸå®æ€§
   - è¯„ä¼°ä¸šåŠ¡å½±å“èŒƒå›´
   - å¯åŠ¨åº”æ€¥é¢„æ¡ˆ

2. å¿«é€Ÿè¯Šæ–­ï¼š
   - æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
   - æŸ¥çœ‹MySQLå¤åˆ¶çŠ¶æ€  
   - åˆ†æç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
   - æ£€æŸ¥æ˜¯å¦æœ‰å¤§äº‹åŠ¡é˜»å¡

3. ç´§æ€¥å¤„ç†ï¼š
   - å¦‚æœæ˜¯ç½‘ç»œé—®é¢˜ï¼šè”ç³»ç½‘ç»œå›¢é˜Ÿ
   - å¦‚æœæ˜¯èµ„æºé—®é¢˜ï¼šä¸´æ—¶æ‰©å®¹æˆ–é™æµ
   - å¦‚æœæ˜¯é…ç½®é—®é¢˜ï¼šè°ƒæ•´MySQLå‚æ•°
   - å¦‚æœæ˜¯åº”ç”¨é—®é¢˜ï¼šä¼˜åŒ–æˆ–åœæ­¢é—®é¢˜æŸ¥è¯¢

4. æ ¹æœ¬è§£å†³ï¼š
   - åˆ†æå»¶è¿Ÿæ ¹æœ¬åŸå› 
   - åˆ¶å®šé•¿æœŸä¼˜åŒ–æ–¹æ¡ˆ
   - æ›´æ–°ç›‘æ§å’Œå‘Šè­¦ç­–ç•¥
   - å®Œå–„é¢„é˜²æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- pt-heartbeatæ˜¯MySQLå¤åˆ¶å»¶è¿Ÿç›‘æ§çš„ä¸“ä¸šå·¥å…·
- é€šè¿‡å¿ƒè·³æœºåˆ¶å®ç°ç²¾ç¡®çš„ç«¯åˆ°ç«¯å»¶è¿Ÿæµ‹é‡  
- æ”¯æŒå®æ—¶ç›‘æ§ã€å†å²åˆ†æã€å¤šçº§å¤åˆ¶ç­‰å¤æ‚åœºæ™¯
- å…³é”®æ˜¯å»ºç«‹å®Œæ•´çš„ç›‘æ§ã€å‘Šè­¦ã€ä¼˜åŒ–ä½“ç³»
- å»¶è¿Ÿä¼˜åŒ–éœ€è¦ä»ç¡¬ä»¶ã€é…ç½®ã€åº”ç”¨ç­‰å¤šä¸ªå±‚é¢å…¥æ‰‹