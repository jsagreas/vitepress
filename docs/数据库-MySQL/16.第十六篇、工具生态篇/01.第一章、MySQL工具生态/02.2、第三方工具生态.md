---
title: 2ã€ç¬¬ä¸‰æ–¹å·¥å…·ç”Ÿæ€
---
## ğŸ“š ç›®å½•

1. [å·¥å…·ç”Ÿæ€æ¦‚è¿°](#1-å·¥å…·ç”Ÿæ€æ¦‚è¿°)
2. [Perconaå·¥å…·åŒ…å®¶æ—](#2-perconaå·¥å…·åŒ…å®¶æ—)
3. [å¤‡ä»½æ¢å¤å·¥å…·](#3-å¤‡ä»½æ¢å¤å·¥å…·)
4. [åœ¨çº¿DDLå·¥å…·](#4-åœ¨çº¿ddlå·¥å…·)
5. [é«˜å¯ç”¨ç®¡ç†å·¥å…·](#5-é«˜å¯ç”¨ç®¡ç†å·¥å…·)
6. [æ•°æ®åº“ä¸­é—´ä»¶](#6-æ•°æ®åº“ä¸­é—´ä»¶)
7. [æ€§èƒ½åˆ†æå·¥å…·](#7-æ€§èƒ½åˆ†æå·¥å…·)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ å·¥å…·ç”Ÿæ€æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç¬¬ä¸‰æ–¹å·¥å…·


**åŸç”ŸMySQLçš„å±€é™æ€§**ï¼š
```
MySQLå®˜æ–¹åŠŸèƒ½        ç¬¬ä¸‰æ–¹å·¥å…·è¡¥å¼º
â”œâ”€ åŸºç¡€å¤‡ä»½          â†’ å¹¶è¡Œå¤‡ä»½ã€å¢é‡å¤‡ä»½
â”œâ”€ ç®€å•å¤åˆ¶          â†’ æ™ºèƒ½æ•…éšœè½¬ç§»
â”œâ”€ è¡¨é”DDL          â†’ åœ¨çº¿æ— é”DDL  
â”œâ”€ å•æœºæœåŠ¡          â†’ è´Ÿè½½å‡è¡¡ã€è¯»å†™åˆ†ç¦»
â””â”€ åŸºç¡€ç›‘æ§          â†’ æ·±åº¦æ€§èƒ½åˆ†æ
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼**ï¼š
- **è¿ç»´è‡ªåŠ¨åŒ–** - å‡å°‘äººå·¥æ“ä½œï¼Œé™ä½å‡ºé”™ç‡
- **æ€§èƒ½ä¼˜åŒ–** - ä¸“ä¸šå·¥å…·æ·±åº¦åˆ†æå’Œè°ƒä¼˜
- **é«˜å¯ç”¨ä¿éšœ** - æ™ºèƒ½æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨åˆ‡æ¢
- **æ‰©å±•æ€§æ”¯æŒ** - åˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»è§£å†³æ–¹æ¡ˆ

### 1.2 å·¥å…·ç”Ÿæ€åˆ†ç±»


```
MySQLç¬¬ä¸‰æ–¹å·¥å…·ç”Ÿæ€å›¾è°±ï¼š

â”Œâ”€ å¤‡ä»½æ¢å¤ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  XtraBackup  mydumper  MyLoader  pt-archiver    â”‚
â”œâ”€ åœ¨çº¿DDLç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  pt-online-schema-change  gh-ost               â”‚
â”œâ”€ é«˜å¯ç”¨ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Orchestrator  MHA  Keepalived                 â”‚
â”œâ”€ ä¸­é—´ä»¶ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ProxySQL  MaxScale  MyCat  ShardingSphere     â”‚
â”œâ”€ æ€§èƒ½åˆ†æç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  pt-query-digest  mysqldumpslow               â”‚
â””â”€ åˆ†å¸ƒå¼ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Vitess  TDDL  Cobar  DBProxy
```

---

## 2. ğŸ”§ Perconaå·¥å…·åŒ…å®¶æ—


### 2.1 Percona Toolkitç®€ä»‹


**ä»€ä¹ˆæ˜¯Percona Toolkit**ï¼š
Percona Toolkitæ˜¯ä¸€å¥—ä¸“é—¨ä¸ºMySQLå’ŒMongoDBè®¾è®¡çš„å‘½ä»¤è¡Œå·¥å…·é›†åˆï¼Œç”±æ•°æ®åº“ä¸“å®¶å¼€å‘ï¼Œè§£å†³æ—¥å¸¸è¿ç»´ä¸­çš„å„ç§é—®é¢˜ã€‚

```bash
# å®‰è£…Percona Toolkit
yum install percona-toolkit
# æˆ–
apt-get install percona-toolkit
```

### 2.2 pt-online-schema-changeè¯¦è§£


**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼šåœ¨çº¿ä¿®æ”¹è¡¨ç»“æ„ï¼Œé¿å…é•¿æ—¶é—´é”è¡¨

**å·¥ä½œåŸç†**ï¼š
```
ä¼ ç»ŸALTER TABLEçš„é—®é¢˜ï¼š
ç”¨æˆ·è¡¨(users) â†’ åŠ è¡¨é” â†’ ä¿®æ”¹ç»“æ„ â†’ é‡Šæ”¾é”
         â†“
    ä¸šåŠ¡å®Œå…¨åœæ­¢(å¯èƒ½æ•°å°æ—¶)

pt-oscçš„è§£å†³æ–¹æ¡ˆï¼š
1. åˆ›å»ºæ–°è¡¨(users_new) â†’ å¤åˆ¶è¡¨ç»“æ„å¹¶ä¿®æ”¹
2. åˆ›å»ºè§¦å‘å™¨ â†’ åŒæ­¥å¢é‡æ•°æ®  
3. åˆ†æ‰¹å¤åˆ¶æ•°æ® â†’ ä¸å½±å“ä¸šåŠ¡
4. åŸå­åˆ‡æ¢ â†’ ç¬é—´å®Œæˆæ›¿æ¢
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# ç»™ç”¨æˆ·è¡¨æ·»åŠ ç´¢å¼•ï¼Œä¸å½±å“ä¸šåŠ¡
pt-online-schema-change \
  --alter "ADD INDEX idx_email (email)" \
  --execute \
  h=localhost,D=testdb,t=users

# ä¸»è¦å‚æ•°è¯´æ˜
--dry-run          # è¯•è¿è¡Œï¼Œä¸å®é™…æ‰§è¡Œ
--execute          # çœŸæ­£æ‰§è¡Œå˜æ›´
--chunk-size=1000  # æ¯æ¬¡å¤„ç†1000è¡Œ
--max-load=80      # CPUè´Ÿè½½è¶…è¿‡80%æ—¶æš‚åœ
```

**âš ï¸ ä½¿ç”¨æ³¨æ„**ï¼š
- è¡¨å¿…é¡»æœ‰ä¸»é”®æˆ–å”¯ä¸€é”®
- ä¸æ”¯æŒå¤–é”®è¡¨
- éœ€è¦é¢å¤–çš„ç£ç›˜ç©ºé—´

### 2.3 pt-query-digestæŸ¥è¯¢åˆ†æ


**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**ï¼šåˆ†æMySQLæ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ

```bash
# åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
pt-query-digest /var/log/mysql/slow.log

# è¾“å‡ºç¤ºä¾‹åˆ†æ
# Rank Query ID           Response time  Calls R/Call  Apdx V/M   Item
# ==== ================== ============== ===== ======= ==== ===== =======
#    1 0x1234567890ABCDEF  45.2s  15.1%    100  0.4520  1.00  0.05 SELECT users
#    2 0xFEDCBA0987654321  32.1s  10.7%     50  0.6420  0.98  0.12 UPDATE orders
```

**æŠ¥å‘Šè§£è¯»**ï¼š
- **Response time**: æ€»å“åº”æ—¶é—´å’Œå æ¯”
- **Calls**: æŸ¥è¯¢æ‰§è¡Œæ¬¡æ•°  
- **R/Call**: å¹³å‡æ¯æ¬¡æ‰§è¡Œæ—¶é—´
- **Item**: æŸ¥è¯¢ç±»å‹å’Œæ¶‰åŠçš„è¡¨

---

## 3. ğŸ’¾ å¤‡ä»½æ¢å¤å·¥å…·


### 3.1 XtraBackupç‰©ç†å¤‡ä»½


**ğŸ”¸ ä»€ä¹ˆæ˜¯XtraBackup**ï¼š
Perconaå¼€å‘çš„MySQLç‰©ç†å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒçƒ­å¤‡ä»½ï¼Œå¤‡ä»½è¿‡ç¨‹ä¸é”è¡¨ï¼Œä¸šåŠ¡å¯æ­£å¸¸è¿è¡Œã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
ä¼ ç»Ÿmysqldumpå¤‡ä»½ï¼š
â”œâ”€ é€»è¾‘å¤‡ä»½ â†’ å¯¼å‡ºSQLè¯­å¥
â”œâ”€ é€Ÿåº¦æ…¢ â†’ å¤§è¡¨éœ€è¦æ•°å°æ—¶  
â”œâ”€ é”è¡¨ â†’ å½±å“ä¸šåŠ¡
â””â”€ æ–‡ä»¶å¤§ â†’ åŒ…å«å¤§é‡SQL

XtraBackupç‰©ç†å¤‡ä»½ï¼š  
â”œâ”€ ç‰©ç†å¤‡ä»½ â†’ ç›´æ¥å¤åˆ¶æ•°æ®æ–‡ä»¶
â”œâ”€ é€Ÿåº¦å¿« â†’ ç½‘ç»œIOé™åˆ¶
â”œâ”€ çƒ­å¤‡ä»½ â†’ ä¸å½±å“ä¸šåŠ¡
â””â”€ æ–‡ä»¶å° â†’ åŸå§‹æ•°æ®å¤§å°
```

**åŸºæœ¬ä½¿ç”¨**ï¼š
```bash
# å…¨é‡å¤‡ä»½
xtrabackup --backup \
  --target-dir=/backup/full-backup \
  --user=backup --password=password

# å¢é‡å¤‡ä»½
xtrabackup --backup \
  --target-dir=/backup/inc-backup \
  --incremental-basedir=/backup/full-backup \
  --user=backup --password=password

# å¤‡ä»½å‡†å¤‡(åº”ç”¨æ—¥å¿—)
xtrabackup --prepare --target-dir=/backup/full-backup

# æ¢å¤å¤‡ä»½
xtrabackup --copy-back --target-dir=/backup/full-backup
```

### 3.2 mydumperå¹¶è¡Œå¤‡ä»½


**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼šå¤šçº¿ç¨‹å¹¶è¡Œå¤‡ä»½ï¼Œæ¯”mysqldumpå¿«å¾ˆå¤šå€

```bash
# ä½¿ç”¨mydumperå¤‡ä»½
mydumper \
  --database=testdb \
  --outputdir=/backup/mydumper \
  --threads=4 \
  --compress \
  --events --routines --triggers

# ä½¿ç”¨myloaderæ¢å¤  
myloader \
  --directory=/backup/mydumper \
  --database=testdb_new \
  --threads=4 \
  --overwrite-tables
```

**æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**ï¼š
```
å·¥å…·å¯¹æ¯” (100GBæ•°æ®åº“)ï¼š
mysqldump:    8å°æ—¶
mydumper:     2å°æ—¶ (4çº¿ç¨‹)
XtraBackup:   1å°æ—¶ (ç‰©ç†å¤‡ä»½)
```

---

## 4. ğŸ”„ åœ¨çº¿DDLå·¥å…·


### 4.1 gh-oståœ¨çº¿DDL


**ğŸ”¸ ä»€ä¹ˆæ˜¯gh-ost**ï¼š
GitHubå¼€å‘çš„MySQLåœ¨çº¿è¡¨ç»“æ„å˜æ›´å·¥å…·ï¼Œæ¯”pt-oscæ›´å®‰å…¨å¯æ§ã€‚

**æ ¸å¿ƒæ”¹è¿›**ï¼š
```
pt-oscæ–¹æ¡ˆï¼š           gh-ostæ–¹æ¡ˆï¼š
åŸè¡¨ â†’ è§¦å‘å™¨åŒæ­¥ â†’ æ–°è¡¨   åŸè¡¨ â†’ binlogè§£æ â†’ æ–°è¡¨
      â†“é—®é¢˜                    â†“ä¼˜åŠ¿  
   è§¦å‘å™¨å¼€é”€å¤§              æ— è§¦å‘å™¨å¼€é”€
   éš¾ä»¥æš‚åœæ¢å¤              å¯éšæ—¶æš‚åœæ¢å¤
   é”ç«äº‰é£é™©                æ›´å®‰å…¨å¯æ§
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# gh-oståœ¨çº¿DDL
gh-ost \
  --user="root" \
  --password="password" \
  --host=localhost \
  --database="testdb" \
  --table="users" \
  --alter="ADD COLUMN age INT DEFAULT 0" \
  --execute

# å®æ—¶ç›‘æ§è¿›åº¦
gh-ost \
  --user="root" \
  --password="password" \
  --host=localhost \
  --database="testdb" \
  --table="users" \
  --alter="ADD INDEX idx_name (name)" \
  --throttle-query="SHOW PROCESSLIST" \
  --max-load=Threads_running=20 \
  --execute
```

### 4.2 ä¸¤ç§å·¥å…·å¯¹æ¯”


| ç‰¹æ€§ | **pt-osc** | **gh-ost** |
|------|-----------|------------|
| **å®ç°æ–¹å¼** | `è§¦å‘å™¨åŒæ­¥` | `binlogè§£æ` |
| **æ€§èƒ½å½±å“** | `è§¦å‘å™¨æœ‰é¢å¤–å¼€é”€` | `å‡ ä¹æ— é¢å¤–å¼€é”€` |
| **æš‚åœæ¢å¤** | `æ”¯æŒä½†å¤æ‚` | `éšæ—¶å¯æš‚åœæ¢å¤` |
| **ä¸»ä»å»¶è¿Ÿ** | `å¯èƒ½åŠ å‰§å»¶è¿Ÿ` | `è‡ªåŠ¨æ£€æµ‹å’Œæ§åˆ¶` |
| **å›æ»šèƒ½åŠ›** | `å›°éš¾` | `ç›¸å¯¹å®¹æ˜“` |
| **é€‚ç”¨åœºæ™¯** | `ä¼ ç»Ÿç¯å¢ƒ` | `äº‘ç¯å¢ƒå’Œå¤§è¡¨` |

---

## 5. ğŸ›ï¸ é«˜å¯ç”¨ç®¡ç†å·¥å…·


### 5.1 Orchestratoré«˜å¯ç”¨ç®¡ç†


**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**ï¼šMySQLå¤åˆ¶æ‹“æ‰‘ç®¡ç†å’Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢

**ä¸»è¦ç‰¹æ€§**ï¼š
```
OrchestratoråŠŸèƒ½æ¶æ„ï¼š

Webç•Œé¢ â†â†’ OrchestratoræœåŠ¡ â†â†’ MySQLé›†ç¾¤
    â†“            â†“                 â†“
 æ‹“æ‰‘å¯è§†åŒ–    æ•…éšœæ£€æµ‹         è‡ªåŠ¨åˆ‡æ¢
 æ‰‹åŠ¨æ“ä½œ      å¥åº·ç›‘æ§         æ‹“æ‰‘æ¢å¤
 é…ç½®ç®¡ç†      å†³ç­–å¼•æ“         æ—¥å¿—è®°å½•
```

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "MySQLTopologyUser": "orchestrator",
  "MySQLTopologyPassword": "password",
  "MySQLOrchestratorHost": "127.0.0.1",
  "MySQLOrchestratorPort": 3306,
  "MySQLOrchestratorDatabase": "orchestrator",
  
  "DetectClusterAliasQuery": "SELECT SUBSTRING_INDEX($$hostname, '.', 1)",
  "DetectInstanceAliasQuery": "SELECT $$server_id",
  "SkipBinlogServerUnresolveCheck": true,
  
  "AutoFailoverEnabled": true,
  "RecoverMasterClusterFilters": ["*"],
  "RecoverIntermediateMasterClusterFilters": ["*"]
}
```

**æ•…éšœåˆ‡æ¢æµç¨‹**ï¼š
```
æ•…éšœæ£€æµ‹æµç¨‹ï¼š
1. å¿ƒè·³æ£€æµ‹ â†’ å‘ç°ä¸»åº“æ•…éšœ
2. ç¡®è®¤æ•…éšœ â†’ å¤šæ¬¡æ£€æµ‹ç¡®ä¿ä¸æ˜¯ç½‘ç»œæŠ–åŠ¨  
3. é€‰æ‹©æ–°ä¸» â†’ æ ¹æ®ç­–ç•¥é€‰æ‹©æœ€ä½³ä»åº“
4. æå‡æ–°ä¸» â†’ æ‰§è¡ŒSTOP SLAVE; RESET MASTER
5. é‡é…ä»åº“ â†’ å…¶ä»–ä»åº“æŒ‡å‘æ–°ä¸»åº“
6. åº”ç”¨åˆ‡æ¢ â†’ é€šçŸ¥åº”ç”¨ç¨‹åºæ–°çš„ä¸»åº“åœ°å€
```

---

## 6. ğŸŒ‰ æ•°æ®åº“ä¸­é—´ä»¶


### 6.1 ProxySQLä»£ç†ä¸­é—´ä»¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯ProxySQL**ï¼š
é«˜æ€§èƒ½çš„MySQLä»£ç†ä¸­é—´ä»¶ï¼Œæä¾›è¯»å†™åˆ†ç¦»ã€è´Ÿè½½å‡è¡¡ã€è¿æ¥æ± ã€æŸ¥è¯¢ç¼“å­˜ç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒæ¶æ„**ï¼š
```
åº”ç”¨ç¨‹åºè¿æ¥ProxySQLï¼š

åº”ç”¨ â†’ ProxySQLä»£ç† â†’ MySQLé›†ç¾¤
     â”œâ”€ è¯»å†™åˆ†ç¦»      â”œâ”€ ä¸»åº“(å†™)
     â”œâ”€ è´Ÿè½½å‡è¡¡      â”œâ”€ ä»åº“1(è¯»)  
     â”œâ”€ è¿æ¥æ±         â”œâ”€ ä»åº“2(è¯»)
     â””â”€ æŸ¥è¯¢è·¯ç”±      â””â”€ ä»åº“3(è¯»)
```

**é…ç½®ç¤ºä¾‹**ï¼š
```sql
-- é…ç½®MySQLæœåŠ¡å™¨
INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight) VALUES
(0, '192.168.1.10', 3306, 1000),  -- ä¸»åº“
(1, '192.168.1.11', 3306, 900),   -- ä»åº“1
(1, '192.168.1.12', 3306, 800);   -- ä»åº“2

-- é…ç½®ç”¨æˆ·
INSERT INTO mysql_users(username, password, default_hostgroup) VALUES
('app_user', 'password', 0);

-- é…ç½®æŸ¥è¯¢è§„åˆ™(è¯»å†™åˆ†ç¦»)
INSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply) VALUES
(1, '^SELECT.*', 1, 1),  -- SELECTè·¯ç”±åˆ°è¯»ç»„
(2, '^INSERT|UPDATE|DELETE.*', 0, 1);  -- å†™æ“ä½œè·¯ç”±åˆ°å†™ç»„

-- åº”ç”¨é…ç½®
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL USERS TO RUNTIME;  
LOAD MYSQL QUERY RULES TO RUNTIME;
```

### 6.2 MyCatåˆ†åº“åˆ†è¡¨ä¸­é—´ä»¶


**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**ï¼šå¼€æºçš„æ•°æ®åº“åˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ

**åˆ†ç‰‡ç­–ç•¥**ï¼š
```
MyCatåˆ†ç‰‡æ–¹æ¡ˆï¼š

é€»è¾‘åº“(mycat_db)
â”œâ”€ ç”¨æˆ·è¡¨åˆ†ç‰‡
â”‚  â”œâ”€ users_0 â†’ ç‰©ç†åº“1  
â”‚  â”œâ”€ users_1 â†’ ç‰©ç†åº“2
â”‚  â””â”€ users_2 â†’ ç‰©ç†åº“3
â””â”€ è®¢å•è¡¨åˆ†ç‰‡  
   â”œâ”€ orders_2023 â†’ æŒ‰æ—¶é—´åˆ†ç‰‡
   â”œâ”€ orders_2024 â†’ æŒ‰æ—¶é—´åˆ†ç‰‡
   â””â”€ orders_2025 â†’ æŒ‰æ—¶é—´åˆ†ç‰‡
```

**schema.xmlé…ç½®**ï¼š
```xml
<mycat:schema>
  <schema name="TESTDB" checkSQLschema="false" sqlMaxLimit="100">
    <!-- åˆ†ç‰‡è¡¨é…ç½® -->
    <table name="users" dataNode="dn1,dn2,dn3" rule="auto-sharding-long" />
    <table name="orders" dataNode="dn1,dn2,dn3" rule="sharding-by-date" />
  </schema>
  
  <!-- æ•°æ®èŠ‚ç‚¹é…ç½® -->
  <dataNode name="dn1" dataHost="localhost1" database="db1" />
  <dataNode name="dn2" dataHost="localhost2" database="db2" />
  <dataNode name="dn3" dataHost="localhost3" database="db3" />
  
  <!-- æ•°æ®æºé…ç½® -->
  <dataHost name="localhost1" maxCon="1000" minCon="10" balance="0">
    <writeHost host="hostM1" url="192.168.1.10:3306" user="root" password="password">
      <readHost host="hostS1" url="192.168.1.11:3306" user="root" password="password" />
    </writeHost>
  </dataHost>
</mycat:schema>
```

### 6.3 ShardingSphereåˆ†ç‰‡ä¸­é—´ä»¶


**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼šApacheé¡¶çº§é¡¹ç›®ï¼Œæä¾›æ ‡å‡†åŒ–çš„åˆ†åº“åˆ†è¡¨è§£å†³æ–¹æ¡ˆ

**ä¸‰ç§äº§å“å½¢æ€**ï¼š
```
ShardingSphereç”Ÿæ€ï¼š
â”œâ”€ Sharding-JDBC â†’ å®¢æˆ·ç«¯ä»£ç†(JARåŒ…)
â”œâ”€ Sharding-Proxy â†’ ç‹¬ç«‹ä»£ç†æœåŠ¡  
â””â”€ Sharding-Sidecar â†’ äº‘åŸç”Ÿä»£ç†
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# sharding-jdbcé…ç½®
dataSources:
  ds_0: 
    url: jdbc:mysql://192.168.1.10:3306/demo_ds_0
    username: root
    password: password
  ds_1:
    url: jdbc:mysql://192.168.1.11:3306/demo_ds_1  
    username: root
    password: password

rules:
- !SHARDING
  tables:
    t_user:
      actualDataNodes: ds_${0..1}.t_user_${0..1}
      tableStrategy:
        standard:
          shardingColumn: user_id
          shardingAlgorithmName: t_user_inline
      keyGenerateStrategy:
        column: user_id
        keyGeneratorName: snowflake
  
  shardingAlgorithms:
    t_user_inline:
      type: INLINE
      props:
        algorithm-expression: t_user_${user_id % 2}
```

---

## 7. ğŸ“Š æ€§èƒ½åˆ†æå·¥å…·


### 7.1 pt-query-digestæ·±åº¦åˆ†æ


**ğŸ”¸ é«˜çº§åŠŸèƒ½**ï¼šé™¤äº†åŸºæœ¬çš„æ…¢æŸ¥è¯¢åˆ†æï¼Œè¿˜æä¾›æ›´æ·±å…¥çš„æ€§èƒ½æ´å¯Ÿ

```bash
# åˆ†ææœ€è¿‘1å°æ—¶çš„æŸ¥è¯¢
pt-query-digest \
  --processlist h=localhost,u=root,p=password \
  --run-time 3600

# å¯¹æ¯”ä¸¤ä¸ªæ—¶é—´æ®µçš„æ€§èƒ½
pt-query-digest \
  --review h=localhost,D=query_review \
  --create-review-table \
  slow.log

# ç”ŸæˆHTMLæŠ¥å‘Š  
pt-query-digest --output html slow.log > report.html
```

**æŠ¥å‘Šå…³é”®æŒ‡æ ‡**ï¼š
```
æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡è§£è¯»ï¼š
â”œâ”€ Query_time â†’ æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
â”œâ”€ Lock_time â†’ ç­‰å¾…é”çš„æ—¶é—´  
â”œâ”€ Rows_sent â†’ è¿”å›è¡Œæ•°
â”œâ”€ Rows_examined â†’ æ‰«æè¡Œæ•°
â””â”€ Rows_affected â†’ å½±å“è¡Œæ•°

æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š
ğŸ¯ Rows_examined/Rows_sentæ¯”å€¼è¿‡å¤§ â†’ éœ€è¦ä¼˜åŒ–ç´¢å¼•
ğŸ¯ Lock_timeè¿‡é•¿ â†’ å¯èƒ½æœ‰é”ç«äº‰é—®é¢˜  
ğŸ¯ Query_timeä¸ç¨³å®š â†’ æŸ¥çœ‹æ˜¯å¦æœ‰æ…¢SQL
```

### 7.2 å…¶ä»–å®ç”¨å·¥å…·


**MaxScaleè´Ÿè½½å‡è¡¡**ï¼š
```bash
# MaxScaleè¯»å†™åˆ†ç¦»é…ç½®
[Read-Write-Service]
type=service
router=readwritesplit
servers=server1,server2,server3
user=maxscale
password=password

[Read-Write-Listener]  
type=listener
service=Read-Write-Service
protocol=MySQLClient
port=3306
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å·¥å…·ç±»å‹


```
ğŸ”¸ å¤‡ä»½æ¢å¤ï¼šXtraBackup(ç‰©ç†) + mydumper(é€»è¾‘)
ğŸ”¸ åœ¨çº¿DDLï¼špt-osc(ä¼ ç»Ÿ) + gh-ost(ç°ä»£)  
ğŸ”¸ é«˜å¯ç”¨ï¼šOrchestratorè‡ªåŠ¨åŒ–ç®¡ç†
ğŸ”¸ ä¸­é—´ä»¶ï¼šProxySQLä»£ç† + åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ
ğŸ”¸ æ€§èƒ½åˆ†æï¼špt-query-digestæ…¢æŸ¥è¯¢åˆ†æ
```

### 8.2 å·¥å…·é€‰æ‹©æŒ‡å¯¼


**ğŸ“Š å·¥å…·é€‰æ‹©å†³ç­–æ ‘**ï¼š
```
éœ€æ±‚åˆ†æ â†’ å·¥å…·é€‰æ‹©ï¼š

å¤‡ä»½éœ€æ±‚ï¼š
â”œâ”€ å°åº“(<10GB) â†’ mysqldump  
â”œâ”€ ä¸­åº“(10-100GB) â†’ mydumper
â””â”€ å¤§åº“(>100GB) â†’ XtraBackup

DDLéœ€æ±‚ï¼š
â”œâ”€ å°è¡¨(<1000ä¸‡è¡Œ) â†’ ALTER TABLE
â”œâ”€ å¤§è¡¨ç¨³å®šç¯å¢ƒ â†’ pt-osc  
â””â”€ å¤§è¡¨ç”Ÿäº§ç¯å¢ƒ â†’ gh-ost

é«˜å¯ç”¨éœ€æ±‚ï¼š
â”œâ”€ ç®€å•ä¸»ä» â†’ MHA
â”œâ”€ å¤æ‚æ‹“æ‰‘ â†’ Orchestrator
â””â”€ äº‘ç¯å¢ƒ â†’ äº‘å‚å•†æ–¹æ¡ˆ

åˆ†åº“åˆ†è¡¨éœ€æ±‚ï¼š
â”œâ”€ Javaåº”ç”¨ â†’ ShardingSphere  
â”œâ”€ å¤šè¯­è¨€åº”ç”¨ â†’ MyCat
â””â”€ é«˜æ€§èƒ½è¦æ±‚ â†’ å®šåˆ¶å¼€å‘
```

### 8.3 å®è·µå»ºè®®


**ğŸ¯ è¿ç»´æœ€ä½³å®è·µ**ï¼š
- **æµ‹è¯•å…ˆè¡Œ** - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰å¿…é¡»å……åˆ†æµ‹è¯•
- **ç›‘æ§å‘Šè­¦** - æ¯ä¸ªå·¥å…·éƒ½è¦é…ç½®ç›¸åº”çš„ç›‘æ§
- **å¤‡ä»½ç­–ç•¥** - ä½¿ç”¨å‰åšå¥½æ•°æ®å¤‡ä»½
- **æ–‡æ¡£è®°å½•** - è¯¦ç»†è®°å½•é…ç½®å’Œä½¿ç”¨è¿‡ç¨‹
- **å›¢é˜ŸåŸ¹è®­** - ç¡®ä¿å›¢é˜Ÿæˆå‘˜éƒ½ä¼šä½¿ç”¨å…³é”®å·¥å…·

**âš ï¸ å¸¸è§è¯¯åŒº**ï¼š
```
è¯¯åŒº1ï¼šå·¥å…·è¶Šå¤šè¶Šå¥½
æ­£ç¡®ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©ï¼Œé¿å…è¿‡åº¦å¤æ‚åŒ–

è¯¯åŒº2ï¼šå®Œå…¨ä¾èµ–å·¥å…·  
æ­£ç¡®ï¼šå·¥å…·æ˜¯è¾…åŠ©ï¼Œæ ¸å¿ƒè¿˜æ˜¯è¦ç†è§£MySQLåŸç†

è¯¯åŒº3ï¼šä¸åšå……åˆ†æµ‹è¯•
æ­£ç¡®ï¼šä»»ä½•å·¥å…·ä¸Šç”Ÿäº§å‰éƒ½è¦åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

è¯¯åŒº4ï¼šå¿½è§†ç‰ˆæœ¬å…¼å®¹æ€§
æ­£ç¡®ï¼šç¡®ä¿å·¥å…·ç‰ˆæœ¬ä¸MySQLç‰ˆæœ¬å…¼å®¹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å·¥å…·æ˜¯ä¸ºäº†è§£å†³ç‰¹å®šé—®é¢˜ï¼Œä¸æ˜¯ä¸ºäº†ç‚«æŠ€
- ç†è§£åŸç†æ¯”ä¼šç”¨å·¥å…·æ›´é‡è¦  
- æµ‹è¯•éªŒè¯æ˜¯ä½¿ç”¨ä»»ä½•å·¥å…·çš„å‰æ
- ç›‘æ§å’Œæ–‡æ¡£æ˜¯å·¥å…·è½åœ°çš„ä¿éšœ