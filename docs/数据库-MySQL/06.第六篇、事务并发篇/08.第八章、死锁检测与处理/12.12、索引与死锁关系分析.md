---
title: 12ã€ç´¢å¼•ä¸æ­»é”å…³ç³»åˆ†æ
---
## ğŸ“š ç›®å½•

1. [ç´¢å¼•é”é¡ºåºå½±å“æœºåˆ¶](#1-ç´¢å¼•é”é¡ºåºå½±å“æœºåˆ¶)
2. [äºŒçº§ç´¢å¼•æ­»é”åˆ†æ](#2-äºŒçº§ç´¢å¼•æ­»é”åˆ†æ)
3. [å”¯ä¸€ç´¢å¼•å†²çªæ­»é”](#3-å”¯ä¸€ç´¢å¼•å†²çªæ­»é”)
4. [ç´¢å¼•åˆå¹¶æ­»é”é—®é¢˜](#4-ç´¢å¼•åˆå¹¶æ­»é”é—®é¢˜)
5. [å¤åˆç´¢å¼•æ­»é”æ¨¡å¼](#5-å¤åˆç´¢å¼•æ­»é”æ¨¡å¼)
6. [ç´¢å¼•è®¾è®¡æ­»é”é¿å…](#6-ç´¢å¼•è®¾è®¡æ­»é”é¿å…)
7. [ç´¢å¼•ä¼˜åŒ–é˜²æ­»é”ç­–ç•¥](#7-ç´¢å¼•ä¼˜åŒ–é˜²æ­»é”ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ç´¢å¼•é”é¡ºåºå½±å“æœºåˆ¶


### 1.1 åŸºæœ¬æ¦‚å¿µ


ç´¢å¼•é”é¡ºåºæŒ‡çš„æ˜¯å½“å¤šä¸ªäº‹åŠ¡è®¿é—®åŒä¸€å¼ è¡¨çš„ä¸åŒç´¢å¼•æ—¶ï¼Œè·å–é”çš„å…ˆåé¡ºåºã€‚ä¸åŒçš„é”è·å–é¡ºåºå¯èƒ½å¯¼è‡´æ­»é”çš„äº§ç”Ÿã€‚

**æ ¸å¿ƒåŸç†**ï¼š
```
æ­»é”äº§ç”Ÿçš„æ ¹æœ¬åŸå› ï¼š
äº‹åŠ¡Aï¼šå…ˆé”ç´¢å¼•1ï¼Œå†é”ç´¢å¼•2
äº‹åŠ¡Bï¼šå…ˆé”ç´¢å¼•2ï¼Œå†é”ç´¢å¼•1

ç»“æœï¼šå½¢æˆç¯å½¢ç­‰å¾…ï¼Œå¯¼è‡´æ­»é”
```

### 1.2 ç´¢å¼•é”è·å–é¡ºåºç¤ºä¾‹


**ç»å…¸æ­»é”åœºæ™¯**ï¼š
```sql
-- è¡¨ç»“æ„
CREATE TABLE users (
    id INT PRIMARY KEY,
    email VARCHAR(100) UNIQUE,
    name VARCHAR(50),
    INDEX idx_name (name)
);

-- äº‹åŠ¡1ï¼šæŒ‰ä¸»é”®->å”¯ä¸€ç´¢å¼•é¡ºåº
BEGIN;
UPDATE users SET name = 'Alice' WHERE id = 100;     -- é”å®šä¸»é”®ç´¢å¼•
UPDATE users SET name = 'Bob' WHERE email = 'test@example.com';  -- é”å®šå”¯ä¸€ç´¢å¼•

-- äº‹åŠ¡2ï¼šæŒ‰å”¯ä¸€ç´¢å¼•->ä¸»é”®é¡ºåº  
BEGIN;
UPDATE users SET name = 'Charlie' WHERE email = 'user@example.com';  -- é”å®šå”¯ä¸€ç´¢å¼•
UPDATE users SET name = 'David' WHERE id = 200;     -- é”å®šä¸»é”®ç´¢å¼•
-- æ­¤æ—¶å¯èƒ½å‘ç”Ÿæ­»é”
```

### 1.3 é”è·å–é¡ºåºå¯è§†åŒ–


```
æ—¶é—´è½´ä¸Šçš„é”è·å–è¿‡ç¨‹ï¼š

T1    äº‹åŠ¡1è·å–ä¸»é”®ç´¢å¼•é”(id=100)
 â”‚    
T2    äº‹åŠ¡2è·å–å”¯ä¸€ç´¢å¼•é”(emailç´¢å¼•)
 â”‚    
T3    äº‹åŠ¡1ç­‰å¾…å”¯ä¸€ç´¢å¼•é” â†â”€â”€â”
 â”‚                        â”‚  ç­‰å¾…ç¯å½¢æˆ
T4    äº‹åŠ¡2ç­‰å¾…ä¸»é”®ç´¢å¼•é” â†â”€â”€â”˜
 â”‚    
T5    æ­»é”æ£€æµ‹å™¨ä»‹å…¥ï¼Œå›æ»šä¸€ä¸ªäº‹åŠ¡

é”ç­‰å¾…å›¾ï¼š
äº‹åŠ¡1 â”€â”€ç­‰å¾…â”€â”€â†’ å”¯ä¸€ç´¢å¼• â”€â”€æŒæœ‰â”€â”€â†’ äº‹åŠ¡2
  â†‘                               â”‚
  â”‚                               â–¼
æŒæœ‰ â†â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»é”®ç´¢å¼• â†â”€â”€â”€ç­‰å¾…â”€â”€â”˜
```

### 1.4 ç´¢å¼•é”é¡ºåºæ£€æµ‹æœºåˆ¶


```cpp
class IndexLockOrderDetector {
private:
    struct LockRequest {
        trx_id_t transaction_id;
        index_id_t index_id;
        lock_mode_t mode;
        timestamp_t request_time;
    };
    
    map<trx_id_t, vector<LockRequest>> trx_lock_history;
    
public:
    bool checkLockOrder(trx_id_t trx_id, index_id_t index_id) {
        auto& history = trx_lock_history[trx_id];
        
        // æ£€æŸ¥æ˜¯å¦è¿åäº†é”é¡ºåº
        for (auto& prev_lock : history) {
            if (prev_lock.index_id > index_id) {
                // å‘ç°é€†åºè®¿é—®ï¼Œå¯èƒ½å¯¼è‡´æ­»é”
                return false;
            }
        }
        return true;
    }
};
```

---

## 2. ğŸ“Š äºŒçº§ç´¢å¼•æ­»é”åˆ†æ


### 2.1 äºŒçº§ç´¢å¼•åŸºæœ¬æ¦‚å¿µ


äºŒçº§ç´¢å¼•ï¼ˆSecondary Indexï¼‰æ˜¯é™¤ä¸»é”®ç´¢å¼•å¤–çš„å…¶ä»–ç´¢å¼•ï¼ŒåŒ…å«ç´¢å¼•é”®å€¼å’Œå¯¹åº”çš„ä¸»é”®å€¼ã€‚è®¿é—®äºŒçº§ç´¢å¼•æ—¶å¯èƒ½éœ€è¦å›è¡¨æŸ¥è¯¢ï¼Œå¢åŠ äº†æ­»é”çš„å¤æ‚æ€§ã€‚

### 2.2 äºŒçº§ç´¢å¼•æ­»é”å…¸å‹åœºæ™¯


**åœºæ™¯1ï¼šç´¢å¼•è¦†ç›–ä¸å›è¡¨æ··åˆ**ï¼š
```sql
-- è¡¨ç»“æ„
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    status VARCHAR(20),
    amount DECIMAL(10,2),
    INDEX idx_user_status (user_id, status),
    INDEX idx_amount (amount)
);

-- æ­»é”åœºæ™¯
-- äº‹åŠ¡1ï¼šä½¿ç”¨å¤åˆç´¢å¼•ï¼Œéœ€è¦å›è¡¨
UPDATE orders SET amount = 999.99 
WHERE user_id = 123 AND status = 'pending';

-- äº‹åŠ¡2ï¼šä½¿ç”¨å•åˆ—ç´¢å¼•ï¼Œä¹Ÿéœ€è¦å›è¡¨  
UPDATE orders SET status = 'completed'
WHERE amount > 500.00;
```

### 2.3 äºŒçº§ç´¢å¼•æ­»é”å½¢æˆè¿‡ç¨‹


```
äºŒçº§ç´¢å¼•æ­»é”çš„è¯¦ç»†æ­¥éª¤ï¼š

æ­¥éª¤1ï¼šäº‹åŠ¡1æ‰«æidx_user_statusç´¢å¼•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–ç´¢å¼•é¡µé”                     â”‚
â”‚ æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç´¢å¼•è®°å½•           â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
æ­¥éª¤2ï¼šäº‹åŠ¡1å›è¡¨è®¿é—®ä¸»é”®ç´¢å¼•        
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¹æ®ä¸»é”®å€¼è®¿é—®èšé›†ç´¢å¼•           â”‚
â”‚ è·å–æ•°æ®é¡µé”                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
æ­¥éª¤3ï¼šäº‹åŠ¡2æ‰«æidx_amountç´¢å¼•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·å–ä¸åŒçš„ç´¢å¼•é¡µé”               â”‚
â”‚ æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç´¢å¼•è®°å½•           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
æ­¥éª¤4ï¼šäº‹åŠ¡2å°è¯•å›è¡¨è®¿é—®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°è¯•è®¿é—®å·²è¢«äº‹åŠ¡1é”å®šçš„æ•°æ®é¡µ    â”‚
â”‚ è¿›å…¥ç­‰å¾…çŠ¶æ€                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
æ­¥éª¤5ï¼šäº‹åŠ¡1å°è¯•è®¿é—®äº‹åŠ¡2çš„ç´¢å¼•é¡µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½¢æˆç¯å½¢ç­‰å¾…                     â”‚
â”‚ æ­»é”æ£€æµ‹å™¨è§¦å‘                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 äºŒçº§ç´¢å¼•æ­»é”é¢„é˜²


```cpp
class SecondaryIndexDeadlockPrevention {
public:
    // ç»Ÿä¸€ç´¢å¼•è®¿é—®é¡ºåº
    void accessIndexesInOrder(vector<index_id_t>& indexes) {
        // æŒ‰ç´¢å¼•IDæ’åºï¼Œç¡®ä¿ä¸€è‡´çš„è®¿é—®é¡ºåº
        sort(indexes.begin(), indexes.end());
        
        for (auto index_id : indexes) {
            acquireIndexLock(index_id);
        }
    }
    
    // æ‰¹é‡é”å®šç­–ç•¥
    bool batchLockAcquisition(const QueryPlan& plan) {
        vector<lock_target_t> all_locks;
        
        // æ”¶é›†æ‰€æœ‰éœ€è¦çš„é”
        for (auto& step : plan.steps) {
            auto locks = extractRequiredLocks(step);
            all_locks.insert(all_locks.end(), locks.begin(), locks.end());
        }
        
        // ç»Ÿä¸€æ’åºåè·å–
        sort(all_locks.begin(), all_locks.end());
        return acquireLocksInBatch(all_locks);
    }
};
```

---

## 3. ğŸ”‘ å”¯ä¸€ç´¢å¼•å†²çªæ­»é”


### 3.1 å”¯ä¸€ç´¢å¼•å†²çªæœºåˆ¶


å”¯ä¸€ç´¢å¼•å†²çªæ­»é”å‘ç”Ÿåœ¨å¤šä¸ªäº‹åŠ¡åŒæ—¶å°è¯•æ’å…¥ç›¸åŒå”¯ä¸€é”®å€¼æ—¶ï¼Œç”±äºæ’å…¥æ„å‘é”å’Œå”¯ä¸€æ€§æ£€æŸ¥çš„äº¤äº’è€Œäº§ç”Ÿã€‚

### 3.2 å”¯ä¸€ç´¢å¼•æ­»é”åœºæ™¯


**å…¸å‹æ­»é”ç¤ºä¾‹**ï¼š
```sql
-- è¡¨ç»“æ„
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) UNIQUE,
    username VARCHAR(50) UNIQUE
);

-- æ­»é”åœºæ™¯ï¼šåŒå”¯ä¸€é”®å†²çª
-- äº‹åŠ¡1
BEGIN;
INSERT INTO users (email, username) VALUES ('user1@test.com', 'username2');
-- å¦‚æœusername2å·²å­˜åœ¨ï¼Œä¼šè·å–å”¯ä¸€ç´¢å¼•çš„å…±äº«é”ç­‰å¾…

-- äº‹åŠ¡2  
BEGIN;
INSERT INTO users (email, username) VALUES ('user2@test.com', 'username1');
-- å¦‚æœusername1å·²å­˜åœ¨ï¼ŒåŒæ ·è·å–å…±äº«é”ç­‰å¾…

-- æ¥ä¸‹æ¥åŒæ–¹éƒ½å°è¯•æ’å…¥å¯¹æ–¹æ­£åœ¨ç­‰å¾…çš„è®°å½•ï¼Œå½¢æˆæ­»é”
```

### 3.3 å”¯ä¸€ç´¢å¼•æ­»é”åˆ†æ


```
å”¯ä¸€ç´¢å¼•å†²çªçš„é”æœºåˆ¶ï¼š

æ’å…¥è¿‡ç¨‹ä¸­çš„é”è·å–ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ’å…¥æ„å‘é”   â”‚  â† è¡¨ç¤ºè¦åœ¨é—´éš™ä¸­æ’å…¥
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å”¯ä¸€æ€§æ£€æŸ¥   â”‚  â† æ£€æŸ¥æ˜¯å¦è¿åå”¯ä¸€çº¦æŸ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è·å–æ’ä»–é”   â”‚  â† å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œè·å–è®°å½•é”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†²çªæ—¶çš„ç­‰å¾…å…³ç³»ï¼š
äº‹åŠ¡Aç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾å…±äº«é”
äº‹åŠ¡Bç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾å…±äº«é”
â†“
å½¢æˆç¯å½¢ç­‰å¾… â†’ æ­»é”
```

### 3.4 å”¯ä¸€ç´¢å¼•æ­»é”å¤„ç†


```cpp
class UniqueIndexDeadlockHandler {
private:
    static const int MAX_RETRY_COUNT = 3;
    
public:
    bool insertWithRetry(const InsertStatement& stmt) {
        int retry_count = 0;
        
        while (retry_count < MAX_RETRY_COUNT) {
            try {
                return executeInsert(stmt);
            } catch (const DeadlockException& e) {
                retry_count++;
                
                // æŒ‡æ•°é€€é¿é‡è¯•
                int wait_time = pow(2, retry_count) * 100; // ms
                this_thread::sleep_for(chrono::milliseconds(wait_time));
                
                if (retry_count >= MAX_RETRY_COUNT) {
                    throw DeadlockRetryExhaustedException();
                }
            }
        }
        return false;
    }
    
    // é¢„æ£€æŸ¥å”¯ä¸€æ€§
    bool preCheckUniqueness(const InsertStatement& stmt) {
        // åœ¨æ’å…¥å‰æ£€æŸ¥æ‰€æœ‰å”¯ä¸€çº¦æŸ
        for (auto& unique_constraint : getUniqueConstraints(stmt.table)) {
            if (violatesConstraint(stmt.values, unique_constraint)) {
                throw UniqueConstraintViolationException();
            }
        }
        return true;
    }
};
```

---

## 4. ğŸ”€ ç´¢å¼•åˆå¹¶æ­»é”é—®é¢˜


### 4.1 ç´¢å¼•åˆå¹¶åŸºæœ¬æ¦‚å¿µ


ç´¢å¼•åˆå¹¶ï¼ˆIndex Mergeï¼‰æ˜¯MySQLä¼˜åŒ–å™¨çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œå½“æŸ¥è¯¢æ¡ä»¶æ¶‰åŠå¤šä¸ªç´¢å¼•æ—¶ï¼Œä¼˜åŒ–å™¨å¯èƒ½é€‰æ‹©ä½¿ç”¨å¤šä¸ªç´¢å¼•å¹¶åˆå¹¶ç»“æœã€‚

### 4.2 ç´¢å¼•åˆå¹¶æ­»é”åœºæ™¯


```sql
-- è¡¨ç»“æ„
CREATE TABLE products (
    id INT PRIMARY KEY,
    category_id INT,
    price DECIMAL(10,2),
    status VARCHAR(20),
    INDEX idx_category (category_id),
    INDEX idx_price (price),
    INDEX idx_status (status)
);

-- å¤æ‚æŸ¥è¯¢è§¦å‘ç´¢å¼•åˆå¹¶
SELECT * FROM products 
WHERE category_id = 100 
   OR price BETWEEN 50.00 AND 100.00
   OR status = 'active';
   
-- å¯èƒ½çš„æ­»é”åœºæ™¯ï¼š
-- äº‹åŠ¡1ï¼šä½¿ç”¨idx_category + idx_priceåˆå¹¶
-- äº‹åŠ¡2ï¼šä½¿ç”¨idx_price + idx_statusåˆå¹¶
-- é”è·å–é¡ºåºä¸åŒå¯èƒ½å¯¼è‡´æ­»é”
```

### 4.3 ç´¢å¼•åˆå¹¶æ­»é”åˆ†æ


```
ç´¢å¼•åˆå¹¶çš„é”è·å–æ¨¡å¼ï¼š

å•ä¸ªäº‹åŠ¡çš„ç´¢å¼•åˆå¹¶è¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰«æç´¢å¼•A    â”‚ -> â”‚ æ‰«æç´¢å¼•B    â”‚ -> â”‚ åˆå¹¶ç»“æœ     â”‚
â”‚ è·å–Aé¡µé”   â”‚    â”‚ è·å–Bé¡µé”   â”‚    â”‚ è®¿é—®ä¸»é”®     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤šäº‹åŠ¡å¹¶å‘æ—¶çš„å†²çªï¼š
äº‹åŠ¡1è·¯å¾„ï¼šç´¢å¼•A -> ç´¢å¼•B -> ä¸»é”®
äº‹åŠ¡2è·¯å¾„ï¼šç´¢å¼•B -> ç´¢å¼•A -> ä¸»é”®

ç­‰å¾…å›¾ï¼š
äº‹åŠ¡1 â”€â”€ç­‰å¾…â”€â”€â†’ ç´¢å¼•B â”€â”€æŒæœ‰â”€â”€â†’ äº‹åŠ¡2
  â†‘                               â”‚
  â”‚                               â–¼
æŒæœ‰ â†â”€â”€â”€â”€â”€â”€â”€â”€ ç´¢å¼•A â†â”€â”€â”€ç­‰å¾…â”€â”€â”˜
```

### 4.4 ç´¢å¼•åˆå¹¶ä¼˜åŒ–ç­–ç•¥


```cpp
class IndexMergeOptimizer {
public:
    // ç´¢å¼•åˆå¹¶é¡ºåºæ ‡å‡†åŒ–
    QueryPlan optimizeIndexMerge(const Query& query) {
        auto indexes = identifyUsableIndexes(query);
        
        // æŒ‰ç´¢å¼•IDæ’åºï¼Œç¡®ä¿ä¸€è‡´çš„è®¿é—®é¡ºåº
        sort(indexes.begin(), indexes.end(), 
             [](const IndexInfo& a, const IndexInfo& b) {
                 return a.index_id < b.index_id;
             });
        
        return createMergePlan(indexes);
    }
    
    // é¿å…å¤æ‚ç´¢å¼•åˆå¹¶
    bool shouldAvoidMerge(const vector<IndexInfo>& indexes) {
        // å¦‚æœæ¶‰åŠè¶…è¿‡2ä¸ªç´¢å¼•ï¼Œè€ƒè™‘é¿å…åˆå¹¶
        if (indexes.size() > 2) return true;
        
        // å¦‚æœé¢„ä¼°é”å†²çªæ¦‚ç‡é«˜ï¼Œé¿å…åˆå¹¶
        if (estimateDeadlockRisk(indexes) > 0.1) return true;
        
        return false;
    }
};
```

---

## 5. ğŸ”— å¤åˆç´¢å¼•æ­»é”æ¨¡å¼


### 5.1 å¤åˆç´¢å¼•ç‰¹ç‚¹


å¤åˆç´¢å¼•ï¼ˆComposite Indexï¼‰åŒ…å«å¤šä¸ªåˆ—ï¼Œé”å®šæ—¶éœ€è¦è€ƒè™‘å‰ç¼€åŒ¹é…å’Œåˆ—é¡ºåºï¼Œè¿™å¢åŠ äº†æ­»é”åœºæ™¯çš„å¤æ‚æ€§ã€‚

### 5.2 å¤åˆç´¢å¼•æ­»é”å…¸å‹æ¨¡å¼


```sql
-- è¡¨ç»“æ„
CREATE TABLE order_items (
    id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT,
    INDEX idx_order_product (order_id, product_id),
    INDEX idx_product_order (product_id, order_id)
);

-- æ­»é”åœºæ™¯ï¼šä¸åŒå‰ç¼€è®¿é—®
-- äº‹åŠ¡1ï¼šæŒ‰order_idå‰ç¼€æŸ¥è¯¢
UPDATE order_items SET quantity = 5 
WHERE order_id = 100 AND product_id = 200;

-- äº‹åŠ¡2ï¼šæŒ‰product_idå‰ç¼€æŸ¥è¯¢  
UPDATE order_items SET quantity = 3
WHERE product_id = 200 AND order_id = 100;
```

### 5.3 å¤åˆç´¢å¼•é”å®šåˆ†æ


```
å¤åˆç´¢å¼•é”å®šçš„å±‚æ¬¡ç»“æ„ï¼š

å¤åˆç´¢å¼• (order_id, product_id)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¹èŠ‚ç‚¹ï¼šåŒ…å«æ‰€æœ‰é”®å€¼èŒƒå›´         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸­é—´èŠ‚ç‚¹ï¼šæŒ‰order_idåˆ†ç»„         â”‚
â”‚ â”œâ”€ order_id=100                â”‚
â”‚ â”‚  â”œâ”€ product_id=200          â”‚
â”‚ â”‚  â””â”€ product_id=300          â”‚
â”‚ â””â”€ order_id=200                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é”å®šç²’åº¦ï¼š
â€¢ å‰ç¼€é”ï¼šé”å®šorder_id=100çš„æ‰€æœ‰è®°å½•
â€¢ ç²¾ç¡®é”ï¼šé”å®š(order_id=100, product_id=200)
â€¢ èŒƒå›´é”ï¼šé”å®šorder_idåœ¨[100,200]èŒƒå›´å†…çš„è®°å½•
```

### 5.4 å¤åˆç´¢å¼•æ­»é”é¢„é˜²


```cpp
class CompositeIndexLockManager {
private:
    // æ ‡å‡†åŒ–ç´¢å¼•è®¿é—®è·¯å¾„
    vector<IndexPath> normalizeIndexPaths(const Query& query) {
        vector<IndexPath> paths;
        
        for (auto& condition : query.conditions) {
            IndexPath path = createIndexPath(condition);
            
            // æ ‡å‡†åŒ–è·¯å¾„ï¼šæ€»æ˜¯ä»æœ€é€‰æ‹©æ€§çš„åˆ—å¼€å§‹
            path = normalizeBySelectivity(path);
            paths.push_back(path);
        }
        
        // æŒ‰è·¯å¾„æ’åºï¼Œç¡®ä¿ä¸€è‡´çš„è®¿é—®é¡ºåº
        sort(paths.begin(), paths.end());
        return paths;
    }
    
public:
    bool acquireCompositeIndexLocks(const vector<IndexPath>& paths) {
        // æŒ‰æ ‡å‡†åŒ–é¡ºåºè·å–é”
        for (const auto& path : paths) {
            if (!acquireIndexLock(path)) {
                // è·å–å¤±è´¥ï¼Œé‡Šæ”¾å·²è·å–çš„é”
                releaseAcquiredLocks();
                return false;
            }
        }
        return true;
    }
};
```

---

## 6. ğŸ›¡ï¸ ç´¢å¼•è®¾è®¡æ­»é”é¿å…


### 6.1 ç´¢å¼•è®¾è®¡åŸºæœ¬åŸåˆ™


åˆç†çš„ç´¢å¼•è®¾è®¡å¯ä»¥ä»æ ¹æœ¬ä¸Šå‡å°‘æ­»é”çš„å‘ç”Ÿæ¦‚ç‡ï¼Œé€šè¿‡ä¼˜åŒ–ç´¢å¼•ç»“æ„å’Œè®¿é—®æ¨¡å¼æ¥é¿å…å†²çªã€‚

**æ ¸å¿ƒè®¾è®¡åŸåˆ™**ï¼š
- å‡å°‘ä¸å¿…è¦çš„ç´¢å¼•æ•°é‡
- ä¼˜åŒ–ç´¢å¼•åˆ—é¡ºåº
- é¿å…è¿‡åº¦çš„ç´¢å¼•é‡å 

### 6.2 ç´¢å¼•æ•°é‡ä¼˜åŒ–


```sql
-- ä¸è‰¯è®¾è®¡ï¼šè¿‡å¤šé‡å ç´¢å¼•
CREATE INDEX idx_user_id ON orders (user_id);
CREATE INDEX idx_user_status ON orders (user_id, status);
CREATE INDEX idx_user_date ON orders (user_id, order_date);
CREATE INDEX idx_status ON orders (status);

-- ä¼˜åŒ–è®¾è®¡ï¼šç²¾ç®€ç´¢å¼•ç»“æ„
CREATE INDEX idx_user_comprehensive ON orders (user_id, status, order_date);
CREATE INDEX idx_status_date ON orders (status, order_date);

-- ä¼˜åŠ¿ï¼š
-- 1. å‡å°‘ç´¢å¼•ç»´æŠ¤å¼€é”€
-- 2. é™ä½é”å†²çªæ¦‚ç‡  
-- 3. æé«˜æŸ¥è¯¢æ€§èƒ½
```

### 6.3 ç´¢å¼•åˆ—é¡ºåºä¼˜åŒ–


```sql
-- è¡¨ç»“æ„ä¼˜åŒ–ç¤ºä¾‹
CREATE TABLE user_activities (
    id INT PRIMARY KEY,
    user_id INT,
    activity_type VARCHAR(50),
    created_at TIMESTAMP,
    status VARCHAR(20)
);

-- æŒ‰æŸ¥è¯¢é¢‘ç‡å’Œé€‰æ‹©æ€§æ’åº
CREATE INDEX idx_optimized ON user_activities 
(user_id, activity_type, status, created_at);

-- è€Œä¸æ˜¯éšæ„é¡ºåºï¼š
-- CREATE INDEX idx_random (created_at, status, user_id, activity_type);
```

### 6.4 ç´¢å¼•è®¾è®¡è¯„ä¼°å·¥å…·


```cpp
class IndexDesignEvaluator {
private:
    struct IndexMetrics {
        double selectivity;      // é€‰æ‹©æ€§
        int usage_frequency;     // ä½¿ç”¨é¢‘ç‡
        double deadlock_risk;    // æ­»é”é£é™©
        int maintenance_cost;    // ç»´æŠ¤æˆæœ¬
    };
    
public:
    // è¯„ä¼°ç´¢å¼•è®¾è®¡è´¨é‡
    double evaluateIndexDesign(const vector<IndexInfo>& indexes) {
        double total_score = 0.0;
        
        for (const auto& index : indexes) {
            IndexMetrics metrics = calculateMetrics(index);
            
            // ç»¼åˆè¯„åˆ†å…¬å¼
            double score = 
                metrics.selectivity * 0.3 +
                metrics.usage_frequency * 0.3 +
                (1.0 - metrics.deadlock_risk) * 0.25 +
                (1.0 - metrics.maintenance_cost) * 0.15;
                
            total_score += score;
        }
        
        return total_score / indexes.size();
    }
    
    // è¯†åˆ«å†—ä½™ç´¢å¼•
    vector<IndexInfo> findRedundantIndexes(const vector<IndexInfo>& indexes) {
        vector<IndexInfo> redundant;
        
        for (size_t i = 0; i < indexes.size(); i++) {
            for (size_t j = i + 1; j < indexes.size(); j++) {
                if (isRedundant(indexes[i], indexes[j])) {
                    redundant.push_back(indexes[j]);
                }
            }
        }
        
        return redundant;
    }
};
```

---

## 7. âš¡ ç´¢å¼•ä¼˜åŒ–é˜²æ­»é”ç­–ç•¥


### 7.1 æŸ¥è¯¢é‡å†™æŠ€æœ¯


é€šè¿‡é‡å†™æŸ¥è¯¢è¯­å¥æ¥æ”¹å˜ç´¢å¼•è®¿é—®æ¨¡å¼ï¼Œä»è€Œé¿å…æ½œåœ¨çš„æ­»é”é£é™©ã€‚

```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆå®¹æ˜“æ­»é”ï¼‰
UPDATE products p1 
SET stock = stock - 1 
WHERE product_id IN (
    SELECT product_id FROM order_items 
    WHERE order_id = 123
)
AND EXISTS (
    SELECT 1 FROM inventory 
    WHERE product_id = p1.product_id AND quantity > 0
);

-- é‡å†™åæŸ¥è¯¢ï¼ˆå‡å°‘æ­»é”é£é™©ï¼‰
UPDATE products 
SET stock = stock - 1 
WHERE product_id IN (123, 456, 789)  -- å…·ä½“çš„IDåˆ—è¡¨
ORDER BY product_id;  -- å¼ºåˆ¶æŒ‰IDé¡ºåºå¤„ç†
```

### 7.2 æ‰¹å¤„ç†ç­–ç•¥


```cpp
class BatchProcessingStrategy {
public:
    // æŒ‰ç´¢å¼•é¡ºåºæ‰¹å¤„ç†
    void processBatchByIndexOrder(vector<UpdateRequest>& requests) {
        // æŒ‰ä¸»é”®æ’åº
        sort(requests.begin(), requests.end(),
             [](const UpdateRequest& a, const UpdateRequest& b) {
                 return a.primary_key < b.primary_key;
             });
        
        // åˆ†æ‰¹å¤„ç†
        const size_t BATCH_SIZE = 1000;
        for (size_t i = 0; i < requests.size(); i += BATCH_SIZE) {
            auto batch_end = min(i + BATCH_SIZE, requests.size());
            processBatch(requests.begin() + i, requests.begin() + batch_end);
        }
    }
    
    // ç´¢å¼•é¢„çƒ­
    void warmupIndexes(const vector<index_id_t>& indexes) {
        for (auto index_id : indexes) {
            // é¢„å…ˆåŠ è½½ç´¢å¼•é¡µåˆ°ç¼“å†²æ± 
            preloadIndexPages(index_id);
        }
    }
};
```

### 7.3 åº”ç”¨å±‚ä¼˜åŒ–


```cpp
class ApplicationLevelOptimization {
private:
    static const int RETRY_DELAY_MS = 50;
    
public:
    // æ™ºèƒ½é‡è¯•æœºåˆ¶
    template<typename Operation>
    bool executeWithRetry(Operation op, int max_retries = 3) {
        for (int attempt = 0; attempt < max_retries; attempt++) {
            try {
                return op();
            } catch (const DeadlockException& e) {
                if (attempt == max_retries - 1) throw;
                
                // éšæœºé€€é¿ï¼Œé¿å…é‡è¯•é£æš´
                int delay = RETRY_DELAY_MS * (1 + rand() % 4);
                this_thread::sleep_for(chrono::milliseconds(delay));
            }
        }
        return false;
    }
    
    // æ“ä½œæ’åº
    void sortOperationsByDeadlockRisk(vector<DatabaseOperation>& ops) {
        sort(ops.begin(), ops.end(),
             [this](const DatabaseOperation& a, const DatabaseOperation& b) {
                 return calculateDeadlockRisk(a) < calculateDeadlockRisk(b);
             });
    }
};
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç´¢å¼•é”é¡ºåºï¼šä¸åŒäº‹åŠ¡è®¿é—®ç´¢å¼•çš„é¡ºåºå·®å¼‚æ˜¯æ­»é”çš„ä¸»è¦åŸå› 
ğŸ”¸ äºŒçº§ç´¢å¼•å›è¡¨ï¼šå›è¡¨æ“ä½œå¢åŠ äº†é¢å¤–çš„é”è·å–æ­¥éª¤ï¼Œæé«˜æ­»é”é£é™©  
ğŸ”¸ å”¯ä¸€ç´¢å¼•å†²çªï¼šå¹¶å‘æ’å…¥ç›¸åŒå”¯ä¸€é”®æ—¶çš„ç‰¹æ®Šæ­»é”æ¨¡å¼
ğŸ”¸ ç´¢å¼•åˆå¹¶é£é™©ï¼šå¤šç´¢å¼•åˆå¹¶æŸ¥è¯¢å¯èƒ½äº§ç”Ÿå¤æ‚çš„é”ä¾èµ–å…³ç³»
ğŸ”¸ å¤åˆç´¢å¼•ç‰¹æ€§ï¼šå‰ç¼€åŒ¹é…å’Œåˆ—é¡ºåºå½±å“é”çš„ç²’åº¦å’ŒèŒƒå›´
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆç´¢å¼•ä¼šå¢åŠ æ­»é”é£é™©**
```
ç´¢å¼•å¢åŠ æ­»é”é£é™©çš„åŸå› ï¼š
â€¢ å¤šå±‚é”å®šï¼šç´¢å¼•é¡µé” + æ•°æ®é¡µé”
â€¢ è®¿é—®è·¯å¾„å¤šæ ·ï¼šä¸åŒç´¢å¼•æä¾›ä¸åŒçš„è®¿é—®è·¯å¾„
â€¢ å›è¡¨æ“ä½œï¼šäºŒçº§ç´¢å¼•éœ€è¦é¢å¤–çš„ä¸»é”®è®¿é—®
â€¢ é”å‡çº§ï¼šä»è¡Œé”å‡çº§åˆ°é¡µé”æˆ–è¡¨é”

ç±»æ¯”ç†è§£ï¼š
ç´¢å¼•å°±åƒåŸå¸‚çš„å¤šæ¡é“è·¯ï¼Œè™½ç„¶æä¾›äº†æ›´å¤šé€‰æ‹©ï¼Œ
ä½†ä¸åŒçš„è·¯çº¿é€‰æ‹©å¯èƒ½å¯¼è‡´äº¤é€šæ­»é”ï¼Œ
éœ€è¦ç»Ÿä¸€çš„äº¤é€šè§„åˆ™ï¼ˆé”è·å–é¡ºåºï¼‰æ¥é¿å…ã€‚
```

**ğŸ”¹ å¦‚ä½•è¯†åˆ«ç´¢å¼•ç›¸å…³çš„æ­»é”**
```
è¯†åˆ«æ–¹æ³•ï¼š
â€¢ åˆ†ææ­»é”æ—¥å¿—ä¸­çš„ç´¢å¼•ä¿¡æ¯
â€¢ è§‚å¯Ÿé”ç­‰å¾…çš„ç´¢å¼•ç±»å‹
â€¢ æ£€æŸ¥æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ä¸­çš„ç´¢å¼•ä½¿ç”¨
â€¢ ç›‘æ§ç´¢å¼•é”äº‰ç”¨ç»Ÿè®¡

æ­»é”æ—¥å¿—å…³é”®ä¿¡æ¯ï¼š
- lock_mode: é”æ¨¡å¼
- index: æ¶‰åŠçš„ç´¢å¼•åç§°  
- space id: è¡¨ç©ºé—´ID
- page_no: é¡µå·
```

**ğŸ”¹ ç´¢å¼•è®¾è®¡ä¸æ­»é”çš„å¹³è¡¡**
```
è®¾è®¡è€ƒè™‘å› ç´ ï¼š
â€¢ æŸ¥è¯¢æ€§èƒ½ vs æ­»é”é£é™©
â€¢ ç´¢å¼•æ•°é‡ vs ç»´æŠ¤æˆæœ¬
â€¢ ç´¢å¼•è¦†ç›– vs é”ç«äº‰
â€¢ ä¸šåŠ¡éœ€æ±‚ vs æŠ€æœ¯çº¦æŸ

å¹³è¡¡ç­–ç•¥ï¼š
â€¢ ä¿ç•™å¿…éœ€çš„ç´¢å¼•
â€¢ åˆå¹¶åŠŸèƒ½ç›¸ä¼¼çš„ç´¢å¼•
â€¢ ä¼˜åŒ–ç´¢å¼•åˆ—é¡ºåº
â€¢ å®æ–½ç»Ÿä¸€çš„è®¿é—®æ¨¡å¼
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ç´¢å¼•è®¾è®¡æŒ‡å¯¼**ï¼š
- **å‡å°‘ç´¢å¼•æ•°é‡**ï¼šé¿å…è¿‡å¤šé‡å ç´¢å¼•å¢åŠ æ­»é”é£é™©
- **ä¼˜åŒ–åˆ—é¡ºåº**ï¼šæŒ‰æŸ¥è¯¢æ¨¡å¼å’Œé€‰æ‹©æ€§æ’åºç´¢å¼•åˆ—
- **ç»Ÿä¸€è®¿é—®æ¨¡å¼**ï¼šåœ¨åº”ç”¨å±‚ç¡®ä¿ä¸€è‡´çš„ç´¢å¼•è®¿é—®é¡ºåº

**æŸ¥è¯¢ä¼˜åŒ–å®è·µ**ï¼š
- **å¼ºåˆ¶ç´¢å¼•é¡ºåº**ï¼šä½¿ç”¨ORDER BYç¡®ä¿ä¸€è‡´çš„å¤„ç†é¡ºåº
- **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼šæŒ‰é”®å€¼æ’åºåæ‰¹é‡å¤„ç†
- **æŸ¥è¯¢é‡å†™**ï¼šé¿å…å¤æ‚çš„å¤šç´¢å¼•æŸ¥è¯¢

**ç›‘æ§å’Œè¿ç»´**ï¼š
- **æ­»é”åˆ†æ**ï¼šé‡ç‚¹å…³æ³¨ç´¢å¼•ç›¸å…³çš„æ­»é”æ¨¡å¼
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ç´¢å¼•é”ç­‰å¾…å’Œäº‰ç”¨æƒ…å†µ
- **å®¹é‡è§„åˆ’**ï¼šè¯„ä¼°ç´¢å¼•å¯¹ç³»ç»Ÿèµ„æºçš„å½±å“

### 8.4 é¢„é˜²ç­–ç•¥æ€»ç»“


**è®¾è®¡é˜¶æ®µé¢„é˜²**ï¼š
```
â€¢ ç²¾ç®€ç´¢å¼•è®¾è®¡ï¼Œé¿å…å†—ä½™
â€¢ æ ‡å‡†åŒ–ç´¢å¼•åˆ—é¡ºåº
â€¢ è€ƒè™‘æŸ¥è¯¢æ¨¡å¼çš„ç´¢å¼•è¦†ç›–
â€¢ è¯„ä¼°ç´¢å¼•ç»´æŠ¤æˆæœ¬
```

**å¼€å‘é˜¶æ®µé¢„é˜²**ï¼š
```
â€¢ ç»Ÿä¸€æ•°æ®è®¿é—®é¡ºåº
â€¢ ä½¿ç”¨æ‰¹å¤„ç†å‡å°‘äº‹åŠ¡æ•°é‡
â€¢ å®ç°æ™ºèƒ½é‡è¯•æœºåˆ¶
â€¢ ä¼˜åŒ–æŸ¥è¯¢è¯­å¥ç»“æ„
```

**è¿ç»´é˜¶æ®µé¢„é˜²**ï¼š
```
â€¢ ç›‘æ§æ­»é”å‘ç”Ÿæ¨¡å¼
â€¢ å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
â€¢ åŠæ—¶æ¸…ç†æ— ç”¨ç´¢å¼•
â€¢ è°ƒæ•´æ•°æ®åº“å‚æ•°é…ç½®
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ç´¢å¼•è™½ç„¶æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œä½†ä¹Ÿå¢åŠ äº†æ­»é”çš„å¤æ‚æ€§
- ç»Ÿä¸€çš„ç´¢å¼•è®¿é—®é¡ºåºæ˜¯é¢„é˜²æ­»é”çš„å…³é”®
- åˆç†çš„ç´¢å¼•è®¾è®¡å¯ä»¥åœ¨æ€§èƒ½å’Œç¨³å®šæ€§é—´æ‰¾åˆ°å¹³è¡¡
- åº”ç”¨å±‚çš„è®¿é—®æ¨¡å¼ä¼˜åŒ–åŒæ ·é‡è¦