---
title: 9ã€æ­»é”é¢„è­¦ç³»ç»Ÿ
---
## ğŸ“š ç›®å½•

1. [é¢„è­¦ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-é¢„è­¦ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [é¢„è­¦æŒ‡æ ‡å®šä¹‰](#2-é¢„è­¦æŒ‡æ ‡å®šä¹‰)
3. [é˜ˆå€¼åŠ¨æ€è°ƒæ•´](#3-é˜ˆå€¼åŠ¨æ€è°ƒæ•´)
4. [å¤šçº§é¢„è­¦æœºåˆ¶](#4-å¤šçº§é¢„è­¦æœºåˆ¶)
5. [é€šçŸ¥æ¸ é“é…ç½®](#5-é€šçŸ¥æ¸ é“é…ç½®)
6. [é¢„è­¦æ¶ˆæ¯æ¨¡æ¿](#6-é¢„è­¦æ¶ˆæ¯æ¨¡æ¿)
7. [é¢„è­¦å“åº”æµç¨‹](#7-é¢„è­¦å“åº”æµç¨‹)
8. [å†å²æ•°æ®åˆ†æ](#8-å†å²æ•°æ®åˆ†æ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ é¢„è­¦ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 æ­»é”é¢„è­¦çš„å¿…è¦æ€§


æ­»é”é¢„è­¦ç³»ç»Ÿæ˜¯åœ¨æ­»é”çœŸæ­£å‘ç”Ÿä¹‹å‰ï¼Œé€šè¿‡ç›‘æ§å„ç§é£é™©æŒ‡æ ‡æ¥æå‰å‘ç°æ½œåœ¨é—®é¢˜çš„æœºåˆ¶ã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©DBAåœ¨é—®é¢˜æ¶åŒ–å‰é‡‡å–é¢„é˜²æªæ–½ã€‚

**ğŸ”¸ é¢„è­¦ç³»ç»Ÿä»·å€¼**
```
é¢„è­¦çš„æ ¸å¿ƒä½œç”¨ï¼š

â”Œâ”€ æå‰å‘ç° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç›‘æ§é”ç­‰å¾…æ—¶é—´å¼‚å¸¸å¢é•¿         â”‚
â”‚ â€¢ æ£€æµ‹äº‹åŠ¡æŒé”æ—¶é—´è¿‡é•¿           â”‚
â”‚ â€¢ å‘ç°èµ„æºç«äº‰çƒ­ç‚¹               â”‚
â”‚ â€¢ è¯†åˆ«æ½œåœ¨çš„æ­»é”æ¨¡å¼             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ é¢„é˜²æ§åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ åŠæ—¶è°ƒæ•´åº”ç”¨ç¨‹åºè¡Œä¸º           â”‚
â”‚ â€¢ ä¼˜åŒ–SQLæ‰§è¡Œè®¡åˆ’               â”‚
â”‚ â€¢ è°ƒæ•´æ•°æ®åº“é…ç½®å‚æ•°             â”‚
â”‚ â€¢ åè°ƒä¸šåŠ¡æµé‡å³°å€¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼šé¢„è­¦ç³»ç»Ÿçš„ç›®æ ‡æ˜¯"é¢„é˜²èƒœäºæ²»ç–—"ï¼Œé€šè¿‡æå‰ç›‘æ§é¿å…æ­»é”çš„å®é™…å‘ç”Ÿã€‚

### 1.2 é¢„è­¦ç³»ç»Ÿæ¶æ„è®¾è®¡


**ğŸ—ï¸ ç³»ç»Ÿç»„ä»¶æ„æˆ**
```
é¢„è­¦ç³»ç»Ÿæ¶æ„ï¼š

æ•°æ®é‡‡é›†å±‚ â”€â”€â”€â”€â”
              â”‚
æŒ‡æ ‡è®¡ç®—å±‚ â”€â”€â”€â”€â”¼â”€â†’ é¢„è­¦å¼•æ“ â”€â†’ é€šçŸ¥ç³»ç»Ÿ
              â”‚
é˜ˆå€¼ç®¡ç†å±‚ â”€â”€â”€â”€â”˜

æ•°æ®å­˜å‚¨ï¼šå†å²æ•°æ® + é…ç½®ä¿¡æ¯
```

---

## 2. ğŸ“Š é¢„è­¦æŒ‡æ ‡å®šä¹‰


### 2.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


é¢„è­¦ç³»ç»Ÿéœ€è¦ç›‘æ§å¤šä¸ªç»´åº¦çš„æŒ‡æ ‡æ¥å…¨é¢è¯„ä¼°æ­»é”é£é™©ï¼Œæ¯ä¸ªæŒ‡æ ‡éƒ½æœ‰å…¶ç‰¹å®šçš„å«ä¹‰å’Œä½œç”¨ã€‚

**ğŸ”¸ å…³é”®é¢„è­¦æŒ‡æ ‡**
```sql
-- æ­»é”é¢„è­¦æŒ‡æ ‡è¡¨
CREATE TABLE deadlock_warning_metrics (
    metric_id INT AUTO_INCREMENT PRIMARY KEY,
    metric_name VARCHAR(50) NOT NULL,
    metric_value DECIMAL(10,3),
    threshold_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'),
    measurement_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_time_metric (measurement_time, metric_name)
);

-- æŒ‡æ ‡å®šä¹‰
INSERT INTO metric_definitions VALUES
('lock_wait_ratio', 'é”ç­‰å¾…æ¯”ä¾‹', 'ç­‰å¾…é”çš„äº‹åŠ¡æ•°/æ€»äº‹åŠ¡æ•°'),
('avg_lock_wait_time', 'å¹³å‡é”ç­‰å¾…æ—¶é—´', 'æ‰€æœ‰é”ç­‰å¾…çš„å¹³å‡æ—¶é•¿'),
('long_transaction_count', 'é•¿äº‹åŠ¡æ•°é‡', 'è¿è¡Œè¶…è¿‡é˜ˆå€¼æ—¶é—´çš„äº‹åŠ¡æ•°'),
('resource_contention_index', 'èµ„æºç«äº‰æŒ‡æ•°', 'çƒ­ç‚¹èµ„æºçš„è®¿é—®å†²çªç¨‹åº¦');
```

**ğŸ”¹ æŒ‡æ ‡åˆ†ç±»è¯¦è§£**
```
æŒ‡æ ‡åˆ†ç±»ä½“ç³»ï¼š

ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡
â”œâ”€ é”ç­‰å¾…æ—¶é—´ï¼šåæ˜ èµ„æºç«äº‰æ¿€çƒˆç¨‹åº¦
â”œâ”€ äº‹åŠ¡æ‰§è¡Œæ—¶é—´ï¼šè¯†åˆ«å¼‚å¸¸ç¼“æ…¢çš„äº‹åŠ¡
â”œâ”€ å¹¶å‘äº‹åŠ¡æ•°ï¼šè¯„ä¼°ç³»ç»Ÿè´Ÿè½½æ°´å¹³
â””â”€ é”å‡çº§é¢‘ç‡ï¼šç›‘æ§é”ç²’åº¦å˜åŒ–

ğŸ¯ é£é™©æŒ‡æ ‡  
â”œâ”€ å¾ªç¯ç­‰å¾…æ£€æµ‹ï¼šå‘ç°æ½œåœ¨æ­»é”ç¯è·¯
â”œâ”€ çƒ­ç‚¹èµ„æºè®¿é—®ï¼šè¯†åˆ«é«˜ç«äº‰èµ„æº
â”œâ”€ äº‹åŠ¡å›æ»šç‡ï¼šå¼‚å¸¸å›æ»šå¯èƒ½è¡¨ç¤ºå†²çª
â””â”€ é”è¶…æ—¶é¢‘ç‡ï¼šç­‰å¾…è¶…æ—¶å¯èƒ½é¢„ç¤ºé—®é¢˜
```

### 2.2 æŒ‡æ ‡é‡‡é›†å®ç°


**ğŸ“Š å®æ—¶æŒ‡æ ‡é‡‡é›†**
```sql
-- é‡‡é›†é”ç­‰å¾…æŒ‡æ ‡
DELIMITER $$
CREATE PROCEDURE collect_lock_metrics()
BEGIN
    DECLARE v_lock_wait_ratio DECIMAL(5,2);
    DECLARE v_avg_wait_time DECIMAL(10,3);
    DECLARE v_long_tx_count INT;
    
    -- è®¡ç®—é”ç­‰å¾…æ¯”ä¾‹
    SELECT 
        (COUNT(CASE WHEN trx_state = 'LOCK WAIT' THEN 1 END) * 100.0 / COUNT(*))
    INTO v_lock_wait_ratio
    FROM information_schema.innodb_trx;
    
    -- è®¡ç®—å¹³å‡ç­‰å¾…æ—¶é—´
    SELECT AVG(trx_wait_started) INTO v_avg_wait_time
    FROM information_schema.innodb_trx 
    WHERE trx_state = 'LOCK WAIT';
    
    -- ç»Ÿè®¡é•¿äº‹åŠ¡æ•°é‡
    SELECT COUNT(*) INTO v_long_tx_count
    FROM information_schema.innodb_trx
    WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 30;
    
    -- æ’å…¥æŒ‡æ ‡æ•°æ®
    INSERT INTO deadlock_warning_metrics (metric_name, metric_value) VALUES
    ('lock_wait_ratio', v_lock_wait_ratio),
    ('avg_lock_wait_time', v_avg_wait_time),
    ('long_transaction_count', v_long_tx_count);
END$$
DELIMITER ;
```

---

## 3. âš–ï¸ é˜ˆå€¼åŠ¨æ€è°ƒæ•´


### 3.1 é˜ˆå€¼ç®¡ç†ç­–ç•¥


é¢„è­¦é˜ˆå€¼ä¸åº”è¯¥æ˜¯å›ºå®šä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®ç³»ç»Ÿçš„å†å²è¡¨ç°ã€ä¸šåŠ¡æ¨¡å¼å’Œå½“å‰è´Ÿè½½åŠ¨æ€è°ƒæ•´ï¼Œä»¥å‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥ã€‚

**ğŸ”¸ é˜ˆå€¼é…ç½®è¡¨**
```sql
-- åŠ¨æ€é˜ˆå€¼é…ç½®
CREATE TABLE dynamic_thresholds (
    metric_name VARCHAR(50) PRIMARY KEY,
    base_threshold DECIMAL(10,3),
    low_threshold DECIMAL(10,3),
    medium_threshold DECIMAL(10,3),
    high_threshold DECIMAL(10,3),
    critical_threshold DECIMAL(10,3),
    adjustment_factor DECIMAL(3,2) DEFAULT 1.0,
    last_adjustment TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é»˜è®¤é˜ˆå€¼é…ç½®
INSERT INTO dynamic_thresholds VALUES
('lock_wait_ratio', 5.0, 3.0, 5.0, 10.0, 20.0, 1.0, NOW()),
('avg_lock_wait_time', 1000, 500, 1000, 3000, 10000, 1.0, NOW()),
('long_transaction_count', 10, 5, 10, 20, 50, 1.0, NOW());
```

### 3.2 è‡ªé€‚åº”é˜ˆå€¼ç®—æ³•


**ğŸ“ˆ æ™ºèƒ½é˜ˆå€¼è°ƒæ•´**
```sql
-- åŸºäºå†å²æ•°æ®çš„é˜ˆå€¼è‡ªé€‚åº”è°ƒæ•´
DELIMITER $$
CREATE PROCEDURE adaptive_threshold_adjustment()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_metric_name VARCHAR(50);
    DECLARE v_avg_value DECIMAL(10,3);
    DECLARE v_std_dev DECIMAL(10,3);
    DECLARE v_new_base DECIMAL(10,3);
    
    DECLARE metric_cursor CURSOR FOR
        SELECT metric_name FROM dynamic_thresholds;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN metric_cursor;
    
    adjustment_loop: LOOP
        FETCH metric_cursor INTO v_metric_name;
        IF done THEN LEAVE adjustment_loop; END IF;
        
        -- è®¡ç®—è¿‡å»24å°æ—¶çš„ç»Ÿè®¡æ•°æ®
        SELECT 
            AVG(metric_value),
            STDDEV(metric_value)
        INTO v_avg_value, v_std_dev
        FROM deadlock_warning_metrics
        WHERE metric_name = v_metric_name
        AND measurement_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR);
        
        -- åŸºäºå‡å€¼å’Œæ ‡å‡†å·®è°ƒæ•´é˜ˆå€¼
        SET v_new_base = v_avg_value + 2 * v_std_dev;
        
        UPDATE dynamic_thresholds SET
            base_threshold = v_new_base,
            low_threshold = v_new_base * 0.7,
            medium_threshold = v_new_base,
            high_threshold = v_new_base * 2.0,
            critical_threshold = v_new_base * 4.0,
            last_adjustment = NOW()
        WHERE metric_name = v_metric_name;
        
    END LOOP;
    
    CLOSE metric_cursor;
END$$
DELIMITER ;
```

---

## 4. ğŸš¦ å¤šçº§é¢„è­¦æœºåˆ¶


### 4.1 é¢„è­¦çº§åˆ«è®¾è®¡


å¤šçº§é¢„è­¦æœºåˆ¶èƒ½å¤Ÿæ ¹æ®é£é™©ç¨‹åº¦æä¾›ä¸åŒçº§åˆ«çš„è­¦å‘Šï¼Œå¸®åŠ©è¿ç»´äººå‘˜åˆç†å®‰æ’å“åº”ä¼˜å…ˆçº§ã€‚

**ğŸ”¸ é¢„è­¦çº§åˆ«å®šä¹‰**
```
é¢„è­¦çº§åˆ«ä½“ç³»ï¼š

ğŸŸ¢ LOWï¼ˆç›‘æ§çº§åˆ«ï¼‰
â”œâ”€ é£é™©ç¨‹åº¦ï¼šè½»å¾®å¼‚å¸¸
â”œâ”€ å“åº”è¦æ±‚ï¼šæŒç»­è§‚å¯Ÿ
â”œâ”€ é€šçŸ¥æ–¹å¼ï¼šæ—¥å¿—è®°å½•
â””â”€ å¤„ç†æ—¶é™ï¼šæ— ç´§æ€¥è¦æ±‚

ğŸŸ¡ MEDIUMï¼ˆæ³¨æ„çº§åˆ«ï¼‰
â”œâ”€ é£é™©ç¨‹åº¦ï¼šå€¼å¾—å…³æ³¨
â”œâ”€ å“åº”è¦æ±‚ï¼šæ£€æŸ¥åŸå› 
â”œâ”€ é€šçŸ¥æ–¹å¼ï¼šé‚®ä»¶é€šçŸ¥
â””â”€ å¤„ç†æ—¶é™ï¼š1å°æ—¶å†…å“åº”

ğŸŸ  HIGHï¼ˆè­¦å‘Šçº§åˆ«ï¼‰
â”œâ”€ é£é™©ç¨‹åº¦ï¼šå¯èƒ½å½±å“æ€§èƒ½
â”œâ”€ å“åº”è¦æ±‚ï¼šä¸»åŠ¨å¹²é¢„
â”œâ”€ é€šçŸ¥æ–¹å¼ï¼šçŸ­ä¿¡+é‚®ä»¶
â””â”€ å¤„ç†æ—¶é™ï¼š15åˆ†é’Ÿå†…å“åº”

ğŸ”´ CRITICALï¼ˆç´§æ€¥çº§åˆ«ï¼‰
â”œâ”€ é£é™©ç¨‹åº¦ï¼šä¸¥é‡å½±å“ç³»ç»Ÿ
â”œâ”€ å“åº”è¦æ±‚ï¼šç«‹å³å¤„ç†
â”œâ”€ é€šçŸ¥æ–¹å¼ï¼šç”µè¯+çŸ­ä¿¡+é‚®ä»¶
â””â”€ å¤„ç†æ—¶é™ï¼š5åˆ†é’Ÿå†…å“åº”
```

### 4.2 é¢„è­¦çº§åˆ«åˆ¤å®š


**ğŸ¯ æ™ºèƒ½é¢„è­¦åˆ¤å®š**
```sql
-- é¢„è­¦çº§åˆ«åˆ¤å®šå‡½æ•°
DELIMITER $$
CREATE FUNCTION determine_warning_level(
    p_metric_name VARCHAR(50),
    p_current_value DECIMAL(10,3)
) RETURNS VARCHAR(20)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_level VARCHAR(20) DEFAULT 'NORMAL';
    DECLARE v_critical DECIMAL(10,3);
    DECLARE v_high DECIMAL(10,3);
    DECLARE v_medium DECIMAL(10,3);
    DECLARE v_low DECIMAL(10,3);
    
    -- è·å–å½“å‰é˜ˆå€¼
    SELECT critical_threshold, high_threshold, medium_threshold, low_threshold
    INTO v_critical, v_high, v_medium, v_low
    FROM dynamic_thresholds
    WHERE metric_name = p_metric_name;
    
    -- åˆ¤å®šé¢„è­¦çº§åˆ«
    CASE
        WHEN p_current_value >= v_critical THEN SET v_level = 'CRITICAL';
        WHEN p_current_value >= v_high THEN SET v_level = 'HIGH';
        WHEN p_current_value >= v_medium THEN SET v_level = 'MEDIUM';
        WHEN p_current_value >= v_low THEN SET v_level = 'LOW';
        ELSE SET v_level = 'NORMAL';
    END CASE;
    
    RETURN v_level;
END$$
DELIMITER ;

-- é¢„è­¦è§¦å‘æ£€æŸ¥
CREATE PROCEDURE check_warning_triggers()
BEGIN
    INSERT INTO warning_events (metric_name, current_value, warning_level, trigger_time)
    SELECT 
        metric_name,
        metric_value,
        determine_warning_level(metric_name, metric_value),
        NOW()
    FROM deadlock_warning_metrics dwm
    WHERE measurement_time >= DATE_SUB(NOW(), INTERVAL 5 MINUTE)
    AND determine_warning_level(metric_name, metric_value) != 'NORMAL';
END;
```

---

## 5. ğŸ“ é€šçŸ¥æ¸ é“é…ç½®


### 5.1 é€šçŸ¥æ¸ é“ç®¡ç†


é¢„è­¦ç³»ç»Ÿéœ€è¦æ”¯æŒå¤šç§é€šçŸ¥æ¸ é“ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ ¹æ®é¢„è­¦çº§åˆ«å’Œæ—¶é—´æ®µé€‰æ‹©åˆé€‚çš„é€šçŸ¥æ–¹å¼ã€‚

**ğŸ”¸ é€šçŸ¥æ¸ é“é…ç½®**
```sql
-- é€šçŸ¥æ¸ é“é…ç½®è¡¨
CREATE TABLE notification_channels (
    channel_id INT AUTO_INCREMENT PRIMARY KEY,
    channel_name VARCHAR(50) NOT NULL,
    channel_type ENUM('EMAIL', 'SMS', 'PHONE', 'WEBHOOK', 'SLACK'),
    endpoint VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0
);

-- é¢„è­¦çº§åˆ«ä¸é€šçŸ¥æ¸ é“æ˜ å°„
CREATE TABLE warning_notification_rules (
    rule_id INT AUTO_INCREMENT PRIMARY KEY,
    warning_level VARCHAR(20),
    channel_id INT,
    time_window_start TIME,
    time_window_end TIME,
    cooldown_minutes INT DEFAULT 30,
    FOREIGN KEY (channel_id) REFERENCES notification_channels(channel_id)
);

-- é…ç½®ç¤ºä¾‹
INSERT INTO notification_channels VALUES
(1, 'DBAé‚®ç®±', 'EMAIL', 'dba@company.com', TRUE, 1),
(2, 'DBAæ‰‹æœº', 'SMS', '+8613800138000', TRUE, 2),
(3, 'Slackè¿ç»´ç¾¤', 'WEBHOOK', 'https://hooks.slack.com/xxx', TRUE, 3);
```

### 5.2 é€šçŸ¥å‘é€é€»è¾‘


**ğŸ“¬ æ™ºèƒ½é€šçŸ¥åˆ†å‘**
```sql
-- å‘é€é¢„è­¦é€šçŸ¥
DELIMITER $$
CREATE PROCEDURE send_warning_notification(
    IN p_warning_level VARCHAR(20),
    IN p_metric_name VARCHAR(50),
    IN p_current_value DECIMAL(10,3)
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_channel_type VARCHAR(20);
    DECLARE v_endpoint VARCHAR(255);
    DECLARE v_last_sent TIMESTAMP;
    DECLARE v_cooldown INT;
    
    DECLARE channel_cursor CURSOR FOR
        SELECT nc.channel_type, nc.endpoint, wnr.cooldown_minutes
        FROM warning_notification_rules wnr
        JOIN notification_channels nc ON wnr.channel_id = nc.channel_id
        WHERE wnr.warning_level = p_warning_level
        AND nc.is_active = TRUE
        AND (wnr.time_window_start IS NULL 
             OR TIME(NOW()) BETWEEN wnr.time_window_start AND wnr.time_window_end);
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN channel_cursor;
    
    notification_loop: LOOP
        FETCH channel_cursor INTO v_channel_type, v_endpoint, v_cooldown;
        IF done THEN LEAVE notification_loop; END IF;
        
        -- æ£€æŸ¥å†·å´æ—¶é—´
        SELECT last_notification_time INTO v_last_sent
        FROM notification_log
        WHERE metric_name = p_metric_name 
        AND channel_endpoint = v_endpoint
        ORDER BY last_notification_time DESC LIMIT 1;
        
        IF v_last_sent IS NULL 
           OR TIMESTAMPDIFF(MINUTE, v_last_sent, NOW()) >= v_cooldown THEN
            
            -- è°ƒç”¨å¤–éƒ¨é€šçŸ¥æ¥å£ï¼ˆæ­¤å¤„ç®€åŒ–ä¸ºæ’å…¥æ—¥å¿—ï¼‰
            INSERT INTO outbound_notifications (
                channel_type, endpoint, message, created_time
            ) VALUES (
                v_channel_type,
                v_endpoint,
                CONCAT('æ­»é”é¢„è­¦: ', p_metric_name, ' = ', p_current_value),
                NOW()
            );
            
            -- è®°å½•é€šçŸ¥æ—¥å¿—
            INSERT INTO notification_log VALUES
            (p_metric_name, v_endpoint, NOW());
        END IF;
        
    END LOOP;
    
    CLOSE channel_cursor;
END$$
DELIMITER ;
```

---

## 6. ğŸ“ é¢„è­¦æ¶ˆæ¯æ¨¡æ¿


### 6.1 æ¶ˆæ¯æ¨¡æ¿è®¾è®¡


æ ‡å‡†åŒ–çš„æ¶ˆæ¯æ¨¡æ¿èƒ½å¤Ÿç¡®ä¿é¢„è­¦ä¿¡æ¯çš„ä¸€è‡´æ€§å’Œå¯è¯»æ€§ï¼Œå¸®åŠ©æ¥æ”¶è€…å¿«é€Ÿç†è§£é—®é¢˜çš„ä¸¥é‡ç¨‹åº¦å’Œå¤„ç†å»ºè®®ã€‚

**ğŸ”¸ æ¶ˆæ¯æ¨¡æ¿ç»“æ„**
```sql
-- é¢„è­¦æ¶ˆæ¯æ¨¡æ¿
CREATE TABLE warning_message_templates (
    template_id INT AUTO_INCREMENT PRIMARY KEY,
    warning_level VARCHAR(20),
    metric_name VARCHAR(50),
    template_type ENUM('EMAIL', 'SMS', 'SLACK'),
    subject_template VARCHAR(200),
    body_template TEXT,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ¨¡æ¿ç¤ºä¾‹
INSERT INTO warning_message_templates VALUES
(1, 'CRITICAL', 'lock_wait_ratio', 'EMAIL', 
 'ã€ç´§æ€¥ã€‘æ•°æ®åº“æ­»é”é£é™© - {metric_name}', 
 'ç³»ç»Ÿæ£€æµ‹åˆ°ä¸¥é‡æ­»é”é£é™©ï¼š\nå½“å‰å€¼ï¼š{current_value}\né˜ˆå€¼ï¼š{threshold}\nå»ºè®®ç«‹å³æ£€æŸ¥é•¿äº‹åŠ¡å’Œé”ç­‰å¾…æƒ…å†µã€‚'),
(2, 'HIGH', 'avg_lock_wait_time', 'SMS',
 'æ­»é”é¢„è­¦', 
 'é”ç­‰å¾…æ—¶é—´å¼‚å¸¸ï¼š{current_value}msï¼Œè¯·åŠæ—¶å¤„ç†');
```

### 6.2 åŠ¨æ€æ¶ˆæ¯ç”Ÿæˆ


**ğŸ“‹ æ¨¡æ¿æ¸²æŸ“å¼•æ“**
```sql
-- æ¶ˆæ¯æ¨¡æ¿æ¸²æŸ“å‡½æ•°
DELIMITER $$
CREATE FUNCTION render_warning_message(
    p_template_id INT,
    p_current_value DECIMAL(10,3),
    p_threshold DECIMAL(10,3),
    p_metric_name VARCHAR(50)
) RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_template TEXT;
    DECLARE v_rendered_message TEXT;
    
    -- è·å–æ¨¡æ¿
    SELECT body_template INTO v_template
    FROM warning_message_templates
    WHERE template_id = p_template_id;
    
    -- æ›¿æ¢æ¨¡æ¿å˜é‡
    SET v_rendered_message = v_template;
    SET v_rendered_message = REPLACE(v_rendered_message, '{current_value}', p_current_value);
    SET v_rendered_message = REPLACE(v_rendered_message, '{threshold}', p_threshold);
    SET v_rendered_message = REPLACE(v_rendered_message, '{metric_name}', p_metric_name);
    SET v_rendered_message = REPLACE(v_rendered_message, '{timestamp}', NOW());
    
    RETURN v_rendered_message;
END$$
DELIMITER ;
```

---

## 7. ğŸ”„ é¢„è­¦å“åº”æµç¨‹


### 7.1 å“åº”æµç¨‹è®¾è®¡


å½“é¢„è­¦è§¦å‘æ—¶ï¼Œç³»ç»Ÿéœ€è¦æœ‰æ˜ç¡®çš„å“åº”æµç¨‹æ¥æŒ‡å¯¼è¿ç»´äººå‘˜è¿›è¡Œé—®é¢˜å¤„ç†ï¼Œç¡®ä¿èƒ½å¤Ÿå¿«é€Ÿæœ‰æ•ˆåœ°è§£å†³æ½œåœ¨çš„æ­»é”é£é™©ã€‚

**ğŸ”¸ å“åº”æµç¨‹æ¶æ„**
```
é¢„è­¦å“åº”æµç¨‹ï¼š

é¢„è­¦è§¦å‘ â”€â”€â”
          â”‚
è‡ªåŠ¨åˆ†æ â”€â”€â”¼â”€â†’ ç”Ÿæˆå»ºè®® â”€â†’ é€šçŸ¥ç›¸å…³äººå‘˜
          â”‚
å†å²å¯¹æ¯” â”€â”€â”˜
          
å“åº”åŠ¨ä½œï¼š
â”œâ”€ ç«‹å³å“åº”ï¼šç´§æ€¥å¤„ç†æªæ–½
â”œâ”€ åˆ†æè¯Šæ–­ï¼šé—®é¢˜æ ¹å› åˆ†æ  
â”œâ”€ å¤„ç†æ‰§è¡Œï¼šå…·ä½“è§£å†³æ–¹æ¡ˆ
â””â”€ è·Ÿè¸ªéªŒè¯ï¼šæ•ˆæœç¡®è®¤åé¦ˆ
```

### 7.2 è‡ªåŠ¨å“åº”æœºåˆ¶


**âš¡ æ™ºèƒ½å“åº”å»ºè®®**
```sql
-- å“åº”å»ºè®®ç”Ÿæˆ
CREATE TABLE response_suggestions (
    suggestion_id INT AUTO_INCREMENT PRIMARY KEY,
    metric_name VARCHAR(50),
    warning_level VARCHAR(20),
    condition_pattern VARCHAR(200),
    suggested_action TEXT,
    auto_executable BOOLEAN DEFAULT FALSE
);

-- å“åº”å»ºè®®é…ç½®
INSERT INTO response_suggestions VALUES
(1, 'lock_wait_ratio', 'CRITICAL', 'value > 15', 
 'å»ºè®®ï¼š1.æŸ¥çœ‹SHOW PROCESSLISTè¯†åˆ«é•¿äº‹åŠ¡ 2.è€ƒè™‘ç»ˆæ­¢å¼‚å¸¸äº‹åŠ¡ 3.æ£€æŸ¥åº”ç”¨ç¨‹åºé”è·å–é¡ºåº', FALSE),
(2, 'long_transaction_count', 'HIGH', 'value > 20',
 'å»ºè®®ï¼š1.åˆ†æé•¿äº‹åŠ¡SQL 2.ä¼˜åŒ–äº‹åŠ¡èŒƒå›´ 3.è€ƒè™‘å¢åŠ äº‹åŠ¡è¶…æ—¶æ—¶é—´', FALSE);

-- ç”Ÿæˆå“åº”å»ºè®®
DELIMITER $$
CREATE FUNCTION generate_response_suggestion(
    p_metric_name VARCHAR(50),
    p_warning_level VARCHAR(20),
    p_current_value DECIMAL(10,3)
) RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_suggestion TEXT DEFAULT 'è¯·è”ç³»DBAè¿›è¡Œè¯¦ç»†åˆ†æ';
    
    SELECT suggested_action INTO v_suggestion
    FROM response_suggestions
    WHERE metric_name = p_metric_name 
    AND warning_level = p_warning_level
    LIMIT 1;
    
    RETURN COALESCE(v_suggestion, 'è¯·è”ç³»DBAè¿›è¡Œè¯¦ç»†åˆ†æ');
END$$
DELIMITER ;
```

---

## 8. ğŸ“ˆ å†å²æ•°æ®åˆ†æ


### 8.1 è¶‹åŠ¿åˆ†æåŠŸèƒ½


é€šè¿‡åˆ†æå†å²é¢„è­¦æ•°æ®ï¼Œå¯ä»¥å‘ç°ç³»ç»Ÿçš„è§„å¾‹æ€§é—®é¢˜å’Œæ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆï¼Œä¸ºå®¹é‡è§„åˆ’å’Œä¼˜åŒ–å†³ç­–æä¾›æ•°æ®æ”¯æŒã€‚

**ğŸ”¸ å†å²æ•°æ®å­˜å‚¨**
```sql
-- å†å²é¢„è­¦æ•°æ®æ±‡æ€»è¡¨
CREATE TABLE warning_history_summary (
    summary_id INT AUTO_INCREMENT PRIMARY KEY,
    summary_date DATE,
    metric_name VARCHAR(50),
    warning_level VARCHAR(20),
    occurrence_count INT,
    avg_value DECIMAL(10,3),
    max_value DECIMAL(10,3),
    INDEX idx_date_metric (summary_date, metric_name)
);

-- æ¯æ—¥æ±‡æ€»ç”Ÿæˆ
CREATE EVENT daily_warning_summary
ON SCHEDULE EVERY 1 DAY
STARTS CURRENT_DATE + INTERVAL 1 DAY
DO
INSERT INTO warning_history_summary 
SELECT 
    NULL,
    DATE(trigger_time),
    metric_name,
    warning_level,
    COUNT(*),
    AVG(current_value),
    MAX(current_value)
FROM warning_events
WHERE DATE(trigger_time) = CURDATE() - INTERVAL 1 DAY
GROUP BY DATE(trigger_time), metric_name, warning_level;
```

### 8.2 æ¨¡å¼è¯†åˆ«åˆ†æ


**ğŸ” æ™ºèƒ½æ¨¡å¼å‘ç°**
```sql
-- é¢„è­¦æ¨¡å¼åˆ†æ
DELIMITER $$
CREATE PROCEDURE analyze_warning_patterns()
BEGIN
    -- æŸ¥æ‰¾å‘¨æœŸæ€§é¢„è­¦æ¨¡å¼
    SELECT 
        metric_name,
        HOUR(trigger_time) as warning_hour,
        COUNT(*) as occurrence_count,
        AVG(current_value) as avg_value
    FROM warning_events
    WHERE trigger_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND warning_level IN ('HIGH', 'CRITICAL')
    GROUP BY metric_name, HOUR(trigger_time)
    HAVING occurrence_count >= 5
    ORDER BY metric_name, warning_hour;
    
    -- æŸ¥æ‰¾å…³è”æ€§é¢„è­¦
    SELECT 
        we1.metric_name as metric1,
        we2.metric_name as metric2,
        COUNT(*) as co_occurrence
    FROM warning_events we1
    JOIN warning_events we2 ON (
        ABS(TIMESTAMPDIFF(MINUTE, we1.trigger_time, we2.trigger_time)) <= 10
        AND we1.metric_name < we2.metric_name
    )
    WHERE we1.trigger_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
    GROUP BY we1.metric_name, we2.metric_name
    HAVING co_occurrence >= 3
    ORDER BY co_occurrence DESC;
END$$
DELIMITER ;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 é¢„è­¦ç³»ç»Ÿæ ¸å¿ƒä»·å€¼


```
ğŸ¯ æ­»é”é¢„è­¦ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ï¼š

ğŸ”¸ æå‰å‘ç°ï¼šé€šè¿‡ç›‘æ§å…³é”®æŒ‡æ ‡æå‰è¯†åˆ«æ­»é”é£é™©
ğŸ”¸ åˆ†çº§å“åº”ï¼šæ ¹æ®é£é™©ç¨‹åº¦æä¾›ä¸åŒçº§åˆ«çš„é¢„è­¦
ğŸ”¸ æ™ºèƒ½é€šçŸ¥ï¼šå¤šæ¸ é“é€šçŸ¥ç¡®ä¿åŠæ—¶å“åº”
ğŸ”¸ è‡ªåŠ¨å»ºè®®ï¼šåŸºäºç»éªŒåº“æä¾›å¤„ç†å»ºè®®
ğŸ”¸ æŒç»­ä¼˜åŒ–ï¼šé€šè¿‡å†å²åˆ†æä¸æ–­æ”¹è¿›é¢„è­¦å‡†ç¡®æ€§
```

### 9.2 å®æ–½å…³é”®è¦ç‚¹


**ğŸ’¡ éƒ¨ç½²å’Œé…ç½®å»ºè®®**
```
é¢„è­¦ç³»ç»Ÿå®æ–½è¦ç‚¹ï¼š

âœ… æŒ‡æ ‡é€‰æ‹©
â”œâ”€ é€‰æ‹©ä¸æ­»é”é«˜åº¦ç›¸å…³çš„æŒ‡æ ‡
â”œâ”€ å¹³è¡¡æŒ‡æ ‡æ•°é‡ä¸ç›‘æ§å¼€é”€
â”œâ”€ ç¡®ä¿æŒ‡æ ‡é‡‡é›†çš„å®æ—¶æ€§
â””â”€ å»ºç«‹æŒ‡æ ‡ä¹‹é—´çš„å…³è”å…³ç³»

âœ… é˜ˆå€¼è®¾å®š
â”œâ”€ åŸºäºå†å²æ•°æ®è®¾å®šåˆå§‹é˜ˆå€¼
â”œâ”€ å®æ–½åŠ¨æ€è°ƒæ•´æœºåˆ¶
â”œâ”€ é¿å…è¿‡äºæ•æ„Ÿå¯¼è‡´è¯¯æŠ¥
â””â”€ å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–é˜ˆå€¼

âœ… é€šçŸ¥ç­–ç•¥
â”œâ”€ æ ¹æ®æ—¶é—´æ®µè°ƒæ•´é€šçŸ¥æ–¹å¼
â”œâ”€ è®¾ç½®åˆç†çš„å†·å´æ—¶é—´
â”œâ”€ ç¡®ä¿å…³é”®äººå‘˜èƒ½åŠæ—¶æ”¶åˆ°é€šçŸ¥
â””â”€ å»ºç«‹å‡çº§æœºåˆ¶å¤„ç†æœªå“åº”æƒ…å†µ
```

### 9.3 è¿ç»´æœ€ä½³å®è·µ


**ğŸ”§ æ—¥å¸¸è¿ç»´å»ºè®®**
```
é¢„è­¦ç³»ç»Ÿè¿ç»´è¦ç‚¹ï¼š

å®šæœŸæ£€æŸ¥ï¼š
â€¢ æ¯å‘¨æ£€æŸ¥é¢„è­¦ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
â€¢ éªŒè¯é€šçŸ¥æ¸ é“çš„æœ‰æ•ˆæ€§
â€¢ åˆ†æé¢„è­¦å‡†ç¡®æ€§å’Œå“åº”æ•ˆæœ

æŒç»­ä¼˜åŒ–ï¼š
â€¢ æ ¹æ®è¯¯æŠ¥æƒ…å†µè°ƒæ•´é˜ˆå€¼
â€¢ ä¼˜åŒ–é¢„è­¦æ¶ˆæ¯æ¨¡æ¿
â€¢ å®Œå–„å“åº”æµç¨‹å’Œå»ºè®®åº“

æ€§èƒ½ç›‘æ§ï¼š
â€¢ ç›‘æ§é¢„è­¦ç³»ç»Ÿæœ¬èº«çš„æ€§èƒ½å¼€é”€
â€¢ ç¡®ä¿ä¸å½±å“ä¸»ä¸šåŠ¡ç³»ç»Ÿ
â€¢ ä¼˜åŒ–æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢æ•ˆç‡
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - **å¤šç»´ç›‘æ§**ï¼šä»å¤šä¸ªè§’åº¦ç›‘æ§æ­»é”é£é™©æŒ‡æ ‡
> - **åŠ¨æ€é˜ˆå€¼**ï¼šæ ¹æ®å†å²æ•°æ®è‡ªé€‚åº”è°ƒæ•´é¢„è­¦é˜ˆå€¼  
> - **åˆ†çº§å“åº”**ï¼šä¸åŒçº§åˆ«é¢„è­¦é‡‡ç”¨ä¸åŒçš„é€šçŸ¥å’Œå¤„ç†ç­–ç•¥
> - **æ™ºèƒ½å»ºè®®**ï¼šåŸºäºç»éªŒåº“è‡ªåŠ¨ç”Ÿæˆå¤„ç†å»ºè®®
> - **æŒç»­æ”¹è¿›**ï¼šé€šè¿‡å†å²åˆ†æä¸æ–­ä¼˜åŒ–é¢„è­¦æ•ˆæœ