---
title: 4ã€è¯»å†™åˆ†ç¦»äº‹åŠ¡å¤„ç†
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»æ¶æ„åŸºç¡€](#1-è¯»å†™åˆ†ç¦»æ¶æ„åŸºç¡€)
2. [ä¸»ä»å»¶è¿Ÿå¯¹äº‹åŠ¡å½±å“](#2-ä¸»ä»å»¶è¿Ÿå¯¹äº‹åŠ¡å½±å“)
3. [è¯»å†™è·¯ç”±ç­–ç•¥](#3-è¯»å†™è·¯ç”±ç­–ç•¥)
4. [è¯»å†™åˆ†ç¦»ä¸€è‡´æ€§ä¿è¯](#4-è¯»å†™åˆ†ç¦»ä¸€è‡´æ€§ä¿è¯)
5. [æ•…éšœåˆ‡æ¢äº‹åŠ¡å¤„ç†](#5-æ•…éšœåˆ‡æ¢äº‹åŠ¡å¤„ç†)
6. [è¯»å†™åˆ†ç¦»äº‹åŠ¡å®Œæ•´æ–¹æ¡ˆ](#6-è¯»å†™åˆ†ç¦»äº‹åŠ¡å®Œæ•´æ–¹æ¡ˆ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ è¯»å†™åˆ†ç¦»æ¶æ„åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»

**é€šä¿—ç†è§£**ï¼šå°±åƒå›¾ä¹¦é¦†åˆ†å·¥ä¸€æ ·ï¼Œæœ‰ä¸“é—¨çš„äººè´Ÿè´£æ•´ç†ä¹¦ç±ï¼ˆå†™ï¼‰ï¼Œæœ‰ä¸“é—¨çš„äººè´Ÿè´£å€Ÿé˜…æœåŠ¡ï¼ˆè¯»ï¼‰

```
ä¼ ç»Ÿå•æœºæ¨¡å¼ï¼š           è¯»å†™åˆ†ç¦»æ¨¡å¼ï¼š
åº”ç”¨ â†’ MySQL            åº”ç”¨ â†’ ä¸»åº“ï¼ˆå†™æ“ä½œï¼‰
                         â†“   â†˜
                       å¤åˆ¶   ä»åº“1ï¼ˆè¯»æ“ä½œï¼‰
                         â†“   â†˜ 
                       å»¶è¿Ÿ   ä»åº“2ï¼ˆè¯»æ“ä½œï¼‰
```

**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**
```
èŒè´£åˆ†ç¦»ï¼š
â€¢ ä¸»åº“ï¼ˆMasterï¼‰ï¼šä¸“é—¨å¤„ç†å†™æ“ä½œï¼ˆINSERTã€UPDATEã€DELETEï¼‰
â€¢ ä»åº“ï¼ˆSlaveï¼‰ï¼šä¸“é—¨å¤„ç†è¯»æ“ä½œï¼ˆSELECTï¼‰
â€¢ æ•°æ®åŒæ­¥ï¼šä¸»åº“å˜æ›´è‡ªåŠ¨å¤åˆ¶åˆ°ä»åº“

ä¼˜åŠ¿ä½“ç°ï¼š
â€¢ è¯»å†™æ€§èƒ½åˆ†åˆ«ä¼˜åŒ–
â€¢ è¯»æ“ä½œå¯ä»¥æ°´å¹³æ‰©å±•
â€¢ å‡å°‘ä¸»åº“å‹åŠ›
â€¢ æé«˜ç³»ç»Ÿæ•´ä½“å¹¶å‘èƒ½åŠ›
```

### 1.2 è¯»å†™åˆ†ç¦»åŸºæœ¬æ¶æ„


**ğŸ”§ æ¶æ„å±‚æ¬¡**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚      â”‚ â† ä¸šåŠ¡é€»è¾‘å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»£ç†å±‚      â”‚ â† è¯»å†™è·¯ç”±ä¸­é—´ä»¶  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®åº“å±‚    â”‚ â† ä¸»ä»æ•°æ®åº“é›†ç¾¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ ç»„ä»¶èŒè´£è¯´æ˜**
```
åº”ç”¨å±‚ï¼š
â€¢ å‘èµ·æ•°æ®åº“æ“ä½œè¯·æ±‚
â€¢ æ ‡è¯†æ“ä½œç±»å‹ï¼ˆè¯»/å†™ï¼‰
â€¢ å¤„ç†ä¸šåŠ¡é€»è¾‘

ä»£ç†å±‚ï¼ˆå…³é”®ç»„ä»¶ï¼‰ï¼š
â€¢ è§£æSQLè¯­å¥
â€¢ åˆ¤æ–­è¯»å†™æ“ä½œç±»å‹
â€¢ è·¯ç”±åˆ°å¯¹åº”æ•°æ®åº“
â€¢ è¿æ¥æ± ç®¡ç†

æ•°æ®åº“å±‚ï¼š
â€¢ ä¸»åº“ï¼šå¤„ç†æ‰€æœ‰å†™æ“ä½œ
â€¢ ä»åº“ï¼šå¤„ç†åªè¯»æŸ¥è¯¢
â€¢ ä¸»ä»æ•°æ®åŒæ­¥
```

---

## 2. â° ä¸»ä»å»¶è¿Ÿå¯¹äº‹åŠ¡å½±å“


### 2.1 ä¸»ä»å»¶è¿Ÿç°è±¡

**ç›´è§‚ç†è§£**ï¼šå°±åƒæ–°é—»ä¼ æ’­ä¸€æ ·ï¼Œæ€»éƒ¨å‘å¸ƒæ¶ˆæ¯åï¼Œå„åœ°åˆ†éƒ¨æ”¶åˆ°æ¶ˆæ¯éœ€è¦ä¸€å®šæ—¶é—´

```
ä¸»åº“æ“ä½œæ—¶é—´çº¿ï¼š
T1: INSERT user (id=100, name='å¼ ä¸‰')  â† ä¸»åº“ç«‹å³æ‰§è¡Œ
T2: åº”ç”¨æŸ¥è¯¢ SELECT * FROM user WHERE id=100

ä»åº“åŒæ­¥æ—¶é—´çº¿ï¼š
T1: [ä¸»åº“å†™å…¥]
T1+Î´: ä»åº“æ¥æ”¶åˆ°binlog  â† å­˜åœ¨å»¶è¿ŸÎ´
T2: ä»åº“æŸ¥è¯¢å¯èƒ½æŸ¥ä¸åˆ°æ•°æ®  â† ä¸€è‡´æ€§é—®é¢˜
```

**âš ï¸ å»¶è¿Ÿäº§ç”ŸåŸå› **
```
ç½‘ç»œå»¶è¿Ÿï¼š
â€¢ ä¸»ä»åº“é—´ç½‘ç»œä¼ è¾“è€—æ—¶
â€¢ è·¨æœºæˆ¿éƒ¨ç½²ç½‘ç»œæŠ–åŠ¨
â€¢ å¸¦å®½é™åˆ¶å½±å“åŒæ­¥é€Ÿåº¦

æ‰§è¡Œå»¶è¿Ÿï¼š
â€¢ ä»åº“SQLæ‰§è¡Œæ’é˜Ÿ
â€¢ å¤§äº‹åŠ¡åŒæ­¥è€—æ—¶é•¿
â€¢ ä»åº“æ€§èƒ½å·®å¼‚

é…ç½®å»¶è¿Ÿï¼š
â€¢ åŒæ­¥æ¨¡å¼é…ç½®ï¼ˆå¼‚æ­¥/åŠåŒæ­¥ï¼‰
â€¢ binlogæ ¼å¼å½±å“è§£æé€Ÿåº¦
â€¢ å¹¶è¡Œå¤åˆ¶å‚æ•°è®¾ç½®
```

### 2.2 äº‹åŠ¡ä¸€è‡´æ€§æŒ‘æˆ˜


**ğŸ“Š ä¸€è‡´æ€§çº§åˆ«å¯¹æ¯”**
| ä¸€è‡´æ€§ç±»å‹ | **ç‰¹ç‚¹** | **å»¶è¿Ÿå½±å“** | **é€‚ç”¨åœºæ™¯** |
|------------|----------|--------------|--------------|
| ğŸ”´ **å¼ºä¸€è‡´æ€§** | `ä¸»åº“è¯»å†™` | `æ— å»¶è¿Ÿé—®é¢˜` | `é‡‘èäº¤æ˜“` |
| ğŸŸ¡ **æœ€ç»ˆä¸€è‡´æ€§** | `å…è®¸çŸ­æœŸä¸ä¸€è‡´` | `å­˜åœ¨å»¶è¿Ÿ` | `å†…å®¹å±•ç¤º` |
| ğŸŸ¢ **ä¼šè¯ä¸€è‡´æ€§** | `åŒä¸€ä¼šè¯å†…ä¸€è‡´` | `å¯æ§å»¶è¿Ÿ` | `ç”¨æˆ·æ“ä½œ` |

**ğŸ’¼ å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ**
```
åœºæ™¯1ï¼šç”¨æˆ·æ³¨å†Œåç«‹å³ç™»å½•
é—®é¢˜ï¼šæ³¨å†Œä¿¡æ¯å†™å…¥ä¸»åº“ï¼Œç™»å½•æŸ¥è¯¢å¯èƒ½æŸ¥ä¸åˆ°
å½±å“ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œå‡ºç°"åˆšæ³¨å†Œå°±æ— æ³•ç™»å½•"

åœºæ™¯2ï¼šä¸‹å•åæŸ¥çœ‹è®¢å•è¯¦æƒ…  
é—®é¢˜ï¼šè®¢å•å†™å…¥ä¸»åº“ï¼ŒæŸ¥è¯¢è®¢å•å¯èƒ½æ˜¾ç¤ºä¸å­˜åœ¨
å½±å“ï¼šç”¨æˆ·å›°æƒ‘ï¼Œå¯èƒ½é‡å¤ä¸‹å•

åœºæ™¯3ï¼šå‘å¸ƒæ–‡ç« åç«‹å³é¢„è§ˆ
é—®é¢˜ï¼šæ–‡ç« å†™å…¥ä¸»åº“ï¼Œé¢„è§ˆæŸ¥è¯¢å¯èƒ½æ˜¾ç¤º404
å½±å“ï¼šç”¨æˆ·ä»¥ä¸ºå‘å¸ƒå¤±è´¥ï¼Œå¯èƒ½é‡å¤æ“ä½œ
```

---

## 3. ğŸ”„ è¯»å†™è·¯ç”±ç­–ç•¥


### 3.1 åŸºäºSQLç±»å‹è·¯ç”±

**åŸºæœ¬æ€è·¯**ï¼šåˆ†æSQLè¯­å¥ï¼Œæ ¹æ®æ“ä½œç±»å‹å†³å®šè·¯ç”±ç›®æ ‡

```java
// ç®€åŒ–çš„è·¯ç”±åˆ¤æ–­é€»è¾‘
public class SQLRouter {
    public DataSource route(String sql) {
        String upperSQL = sql.trim().toUpperCase();
        
        // å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“
        if (upperSQL.startsWith("INSERT") || 
            upperSQL.startsWith("UPDATE") || 
            upperSQL.startsWith("DELETE")) {
            return masterDataSource;
        }
        
        // è¯»æ“ä½œè·¯ç”±åˆ°ä»åº“
        if (upperSQL.startsWith("SELECT")) {
            return slaveDataSource;
        }
        
        // é»˜è®¤è·¯ç”±åˆ°ä¸»åº“ï¼ˆå®‰å…¨ç­–ç•¥ï¼‰
        return masterDataSource;
    }
}
```

**ğŸ¯ è·¯ç”±è§„åˆ™ç»†åŒ–**
```
å†™æ“ä½œï¼ˆå¿…é¡»ä¸»åº“ï¼‰ï¼š
â€¢ INSERTã€UPDATEã€DELETE
â€¢ DDLæ“ä½œï¼ˆCREATEã€ALTERã€DROPï¼‰
â€¢ å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ï¼ˆå¯èƒ½åŒ…å«å†™æ“ä½œï¼‰

è¯»æ“ä½œï¼ˆå¯ç”¨ä»åº“ï¼‰ï¼š
â€¢ ç®€å•SELECTæŸ¥è¯¢
â€¢ ç»Ÿè®¡åˆ†ææŸ¥è¯¢
â€¢ æŠ¥è¡¨ç”ŸæˆæŸ¥è¯¢

ç‰¹æ®Šæƒ…å†µï¼ˆå»ºè®®ä¸»åº“ï¼‰ï¼š
â€¢ SELECT ... FOR UPDATEï¼ˆæ‚²è§‚é”ï¼‰
â€¢ äº‹åŠ¡å†…çš„SELECTï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
â€¢ å®æ—¶æ€§è¦æ±‚é«˜çš„æŸ¥è¯¢
```

### 3.2 åŸºäºäº‹åŠ¡ä¸Šä¸‹æ–‡è·¯ç”±


**æ ¸å¿ƒæ€æƒ³**ï¼šäº‹åŠ¡å†…çš„æ‰€æœ‰æ“ä½œéƒ½è·¯ç”±åˆ°åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä¿è¯äº‹åŠ¡ACIDç‰¹æ€§

```java
// äº‹åŠ¡æ„ŸçŸ¥çš„è·¯ç”±ç­–ç•¥
@Component
public class TransactionAwareRouter {
    private ThreadLocal<Boolean> inTransaction = new ThreadLocal<>();
    private ThreadLocal<DataSource> transactionDataSource = new ThreadLocal<>();
    
    @Transactional
    public void handleTransactionalOperation(String sql) {
        // äº‹åŠ¡å¼€å§‹æ—¶ç¡®å®šæ•°æ®æº
        if (!inTransaction.get()) {
            DataSource dataSource = determineDataSource(sql);
            transactionDataSource.set(dataSource);
            inTransaction.set(true);
        }
        
        // äº‹åŠ¡å†…æ‰€æœ‰æ“ä½œä½¿ç”¨åŒä¸€æ•°æ®æº
        executeSQL(transactionDataSource.get(), sql);
    }
}
```

**ğŸ“‹ äº‹åŠ¡è·¯ç”±ç­–ç•¥**
```
äº‹åŠ¡è·¯ç”±åŸåˆ™ï¼š
1. é¦–ä¸ªæ“ä½œå†³å®šæ•´ä¸ªäº‹åŠ¡çš„æ•°æ®æº
2. å†™æ“ä½œä¼˜å…ˆï¼šæœ‰å†™æ“ä½œå°±ç”¨ä¸»åº“
3. çº¯è¯»äº‹åŠ¡ï¼šå¯ä»¥è€ƒè™‘ä½¿ç”¨ä»åº“
4. è·¨åº“äº‹åŠ¡ï¼šéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†

ç¤ºä¾‹åœºæ™¯ï¼š
BEGIN;
  SELECT count(*) FROM orders;     â† ç¡®å®šä½¿ç”¨ä»åº“
  SELECT * FROM order_items;      â† ç»§ç»­ä½¿ç”¨ä»åº“
COMMIT;

BEGIN;
  SELECT * FROM user WHERE id=1;  â† å¯èƒ½é€‰æ‹©ä»åº“
  UPDATE user SET name='æ–°åå­—';   â† å¿…é¡»åˆ‡æ¢åˆ°ä¸»åº“ï¼
COMMIT;
```

### 3.3 æ™ºèƒ½è·¯ç”±ç­–ç•¥


**ğŸ§  å»¶è¿Ÿæ„ŸçŸ¥è·¯ç”±**
```java
// å»¶è¿Ÿæ„ŸçŸ¥çš„æ™ºèƒ½è·¯ç”±
public class DelayAwareRouter {
    private Map<String, Long> slaveDelayMap = new ConcurrentHashMap<>();
    
    public DataSource selectBestSlave() {
        // é€‰æ‹©å»¶è¿Ÿæœ€å°çš„ä»åº“
        return slaveDelayMap.entrySet()
            .stream()
            .min(Map.Entry.comparingByValue())
            .map(entry -> getDataSource(entry.getKey()))
            .orElse(masterDataSource);
    }
    
    // å®šæœŸæ£€æµ‹ä»åº“å»¶è¿Ÿ
    @Scheduled(fixedRate = 5000)
    public void updateSlaveDelay() {
        for (String slaveId : slaveList) {
            long delay = measureReplicationDelay(slaveId);
            slaveDelayMap.put(slaveId, delay);
        }
    }
}
```

---

## 4. ğŸ”’ è¯»å†™åˆ†ç¦»ä¸€è‡´æ€§ä¿è¯


### 4.1 å¼ºåˆ¶è¯»ä¸»åº“ç­–ç•¥

**åº”ç”¨åœºæ™¯**ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„æ“ä½œ

```java
// å¼ºåˆ¶è¯»ä¸»åº“çš„æ³¨è§£å®ç°
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
public @interface ForceMaster {
    String reason() default "ä¸€è‡´æ€§è¦æ±‚";
}

@Service
public class UserService {
    
    @ForceMaster(reason = "æ³¨å†Œåç«‹å³éªŒè¯")
    public User getUserAfterRegister(Long userId) {
        // è¿™ä¸ªæŸ¥è¯¢ä¼šå¼ºåˆ¶è·¯ç”±åˆ°ä¸»åº“
        return userMapper.selectById(userId);
    }
}
```

**ğŸ¯ å¼ºåˆ¶è¯»ä¸»åº“çš„å…¸å‹åœºæ™¯**
```
ä¸šåŠ¡æ•æ„Ÿæ“ä½œï¼š
â€¢ ç”¨æˆ·æ³¨å†Œåçš„èº«ä»½éªŒè¯
â€¢ æ”¯ä»˜å®Œæˆåçš„è®¢å•ç¡®è®¤
â€¢ æƒé™å˜æ›´åçš„è®¿é—®æ§åˆ¶
â€¢ åº“å­˜æ‰£å‡åçš„æ•°é‡æ£€æŸ¥

æŠ€æœ¯è¦æ±‚ï¼š
â€¢ äº‹åŠ¡å†…çš„è¯»æ“ä½œ
â€¢ å†™åç«‹å³è¯»çš„åœºæ™¯
â€¢ æ•°æ®æ ¡éªŒå’Œå®¡è®¡
â€¢ å®æ—¶æ€§è¦æ±‚æé«˜çš„æŸ¥è¯¢
```

### 4.2 å»¶è¿Ÿè¡¥å¿æœºåˆ¶


**ğŸ’¡ å»¶è¿Ÿæ£€æµ‹ä¸è¡¥å¿**
```java
// å»¶è¿Ÿè¡¥å¿çš„å®ç°ç­–ç•¥
@Component
public class DelayCompensationService {
    
    public <T> T readWithCompensation(String sql, Class<T> returnType) {
        // 1. å…ˆå°è¯•ä»åº“æŸ¥è¯¢
        T result = slaveTemplate.queryForObject(sql, returnType);
        
        // 2. æ£€æŸ¥æ˜¯å¦å¯èƒ½å—å»¶è¿Ÿå½±å“
        if (result == null && mayAffectedByDelay(sql)) {
            // 3. å›é€€åˆ°ä¸»åº“æŸ¥è¯¢
            result = masterTemplate.queryForObject(sql, returnType);
        }
        
        return result;
    }
    
    private boolean mayAffectedByDelay(String sql) {
        // æ£€æŸ¥æœ€è¿‘æ˜¯å¦æœ‰ç›¸å…³å†™æ“ä½œ
        return recentWriteOperationExists(sql);
    }
}
```

### 4.3 ä¼šè¯çº§ä¸€è‡´æ€§ä¿è¯


**æ ¸å¿ƒæ€è·¯**ï¼šåŒä¸€ç”¨æˆ·ä¼šè¯å†…ä¿è¯æ•°æ®ä¸€è‡´æ€§

```java
// ä¼šè¯çº§ä¸€è‡´æ€§å®ç°
@Component
public class SessionConsistencyManager {
    
    // è®°å½•ç”¨æˆ·æœ€åçš„å†™æ“ä½œæ—¶é—´
    private Map<String, Long> userLastWriteTime = new ConcurrentHashMap<>();
    
    public DataSource getDataSourceForUser(String userId, String sql) {
        Long lastWriteTime = userLastWriteTime.get(userId);
        
        // å¦‚æœæœ€è¿‘æœ‰å†™æ“ä½œï¼Œåœ¨å»¶è¿Ÿçª—å£å†…å¼ºåˆ¶è¯»ä¸»åº“
        if (lastWriteTime != null && 
            System.currentTimeMillis() - lastWriteTime < DELAY_WINDOW) {
            return masterDataSource;
        }
        
        // å¦åˆ™å¯ä»¥è¯»ä»åº“
        return isReadOperation(sql) ? slaveDataSource : masterDataSource;
    }
    
    public void recordWriteOperation(String userId) {
        userLastWriteTime.put(userId, System.currentTimeMillis());
    }
}
```

---

## 5. ğŸš¨ æ•…éšœåˆ‡æ¢äº‹åŠ¡å¤„ç†


### 5.1 ä¸»åº“æ•…éšœå¤„ç†

**æ•…éšœåœºæ™¯**ï¼šä¸»åº“å®•æœºæˆ–ä¸å¯ç”¨æ—¶çš„äº‹åŠ¡å¤„ç†ç­–ç•¥

```
æ•…éšœåˆ‡æ¢æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ•…éšœæ£€æµ‹    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»åº“   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   ç›‘æ§   â”‚
â”‚ (æ•…éšœ)   â”‚               â”‚   ç³»ç»Ÿ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                            é€‰æ‹©æ–°ä¸»åº“
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æå‡ä¸ºä¸»    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»åº“1   â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ æ•…éšœåˆ‡æ¢ â”‚
â”‚ (æ–°ä¸»)   â”‚               â”‚   ç»„ä»¶   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ äº‹åŠ¡å¤„ç†ç­–ç•¥**
```
æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡ï¼š
â€¢ å·²æäº¤äº‹åŠ¡ï¼šæ•°æ®å®‰å…¨ï¼Œæ— éœ€å¤„ç†
â€¢ æœªæäº¤äº‹åŠ¡ï¼šå¯èƒ½ä¸¢å¤±ï¼Œéœ€è¦é‡è¯•æœºåˆ¶
â€¢ é•¿äº‹åŠ¡ï¼šé£é™©æœ€å¤§ï¼Œéœ€è¦åˆ†æ®µå¤„ç†

åº”ç”¨å±‚å¤„ç†ï¼š
â€¢ äº‹åŠ¡é‡è¯•æœºåˆ¶
â€¢ å¹‚ç­‰æ€§ä¿è¯
â€¢ çŠ¶æ€æ£€æŸ¥å’Œæ¢å¤
â€¢ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
```

### 5.2 ä»åº“æ•…éšœå¤„ç†


**ğŸ“Š å¤šä»åº“æ•…éšœå¤„ç†**
```java
// ä»åº“æ•…éšœæ„ŸçŸ¥å’Œåˆ‡æ¢
@Component
public class SlaveFailoverHandler {
    private List<DataSource> availableSlaves = new ArrayList<>();
    private Set<DataSource> failedSlaves = new ConcurrentHashMap<>();
    
    public DataSource getHealthySlave() {
        // è¿‡æ»¤æ‰æ•…éšœçš„ä»åº“
        List<DataSource> healthySlaves = availableSlaves.stream()
            .filter(ds -> !failedSlaves.contains(ds))
            .collect(Collectors.toList());
            
        if (healthySlaves.isEmpty()) {
            // æ‰€æœ‰ä»åº“éƒ½æ•…éšœï¼Œå›é€€åˆ°ä¸»åº“
            return masterDataSource;
        }
        
        // è´Ÿè½½å‡è¡¡é€‰æ‹©å¥åº·çš„ä»åº“
        return loadBalance(healthySlaves);
    }
    
    // å®šæœŸæ£€æŸ¥æ•…éšœä»åº“æ˜¯å¦æ¢å¤
    @Scheduled(fixedRate = 30000)
    public void checkFailedSlaves() {
        failedSlaves.removeIf(this::isSlaveRecovered);
    }
}
```

---

## 6. ğŸ¯ è¯»å†™åˆ†ç¦»äº‹åŠ¡å®Œæ•´æ–¹æ¡ˆ


### 6.1 å®Œæ•´æ¶æ„è®¾è®¡


**ğŸ—ï¸ åˆ†å±‚æ¶æ„è®¾è®¡**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åº”ç”¨ä¸šåŠ¡å±‚                â”‚ â† ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        äº‹åŠ¡ç®¡ç†å±‚                â”‚ â† äº‹åŠ¡æ§åˆ¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚        è·¯ç”±ç­–ç•¥å±‚                â”‚ â† è¯»å†™è·¯ç”±
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        è¿æ¥ç®¡ç†å±‚                â”‚ â† è¿æ¥æ± 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æ•°æ®æºå±‚                  â”‚ â† ä¸»ä»åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ ¸å¿ƒé…ç½®ç¤ºä¾‹**
```yaml
# æ•°æ®æºé…ç½®
spring:
  datasource:
    master:
      url: jdbc:mysql://master:3306/mydb
      username: master_user
      password: master_pass
      
    slave:
      - url: jdbc:mysql://slave1:3306/mydb
        username: slave_user
        password: slave_pass
      - url: jdbc:mysql://slave2:3306/mydb
        username: slave_user
        password: slave_pass

# è¯»å†™åˆ†ç¦»é…ç½®        
rw-separation:
  default-datasource: slave
  force-master-operations:
    - "SELECT.*FOR UPDATE"
    - "INSERT.*"
    - "UPDATE.*" 
    - "DELETE.*"
  delay-threshold: 1000ms
  failover-enabled: true
```

### 6.2 æœ€ä½³å®è·µé…ç½®


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```java
@Configuration
public class ReadWriteSeparationConfig {
    
    @Bean
    @Primary
    public DataSource dataSource() {
        ReadWriteSplittingDataSource dataSource = 
            new ReadWriteSplittingDataSource();
            
        // ä¸»åº“é…ç½®
        dataSource.setMasterDataSource(masterDataSource());
        
        // ä»åº“é…ç½®
        dataSource.setSlaveDataSources(slaveDataSources());
        
        // è·¯ç”±ç­–ç•¥é…ç½®
        dataSource.setRoutingStrategy(routingStrategy());
        
        // æ•…éšœåˆ‡æ¢é…ç½®
        dataSource.setFailoverStrategy(failoverStrategy());
        
        return dataSource;
    }
    
    private RoutingStrategy routingStrategy() {
        return RoutingStrategy.builder()
            .forceMasterForTransaction(true)
            .delayThreshold(Duration.ofMillis(500))
            .sessionConsistency(true)
            .build();
    }
}
```

### 6.3 ç›‘æ§å’Œè¿ç»´æ–¹æ¡ˆ


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```
æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ ä¸»ä»å»¶è¿Ÿæ—¶é—´ï¼š< 100ms
â€¢ è¯»å†™QPSåˆ†å¸ƒï¼šè¯»å†™æ¯”ä¾‹
â€¢ è¿æ¥æ± ä½¿ç”¨ç‡ï¼š< 80%
â€¢ å“åº”æ—¶é—´ï¼šP99 < 50ms

å¯ç”¨æ€§æŒ‡æ ‡ï¼š
â€¢ ä¸»åº“å¯ç”¨ç‡ï¼š99.9%
â€¢ ä»åº“å¯ç”¨ç‡ï¼š99.5%
â€¢ æ•…éšœåˆ‡æ¢æ—¶é—´ï¼š< 30s
â€¢ æ•°æ®ä¸€è‡´æ€§ï¼š100%

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ å¼ºåˆ¶è¯»ä¸»åº“æ¯”ä¾‹ï¼š< 20%
â€¢ äº‹åŠ¡å›æ»šç‡ï¼š< 0.1%
â€¢ ç”¨æˆ·æŠ•è¯‰ç‡ï¼š< 0.01%
```

**ğŸ” æ•…éšœæ’æŸ¥æ¸…å•**
```
å¸¸è§é—®é¢˜æ’æŸ¥ï¼š
1. ä¸»ä»å»¶è¿Ÿè¿‡å¤§
   â†’ æ£€æŸ¥ç½‘ç»œè¿æ¥
   â†’ æ£€æŸ¥ä»åº“æ€§èƒ½
   â†’ ä¼˜åŒ–binlogé…ç½®

2. æ•°æ®ä¸ä¸€è‡´
   â†’ æ£€æŸ¥è·¯ç”±ç­–ç•¥
   â†’ éªŒè¯äº‹åŠ¡å¤„ç†
   â†’ ç¡®è®¤å¼ºåˆ¶è¯»ä¸»åº“ç­–ç•¥

3. æ€§èƒ½ä¸‹é™  
   â†’ åˆ†æè¯»å†™æ¯”ä¾‹
   â†’ æ£€æŸ¥è¿æ¥æ± é…ç½®
   â†’ ä¼˜åŒ–SQLè¯­å¥

4. æ•…éšœåˆ‡æ¢å¤±è´¥
   â†’ æ£€æŸ¥ç›‘æ§ç»„ä»¶
   â†’ éªŒè¯åˆ‡æ¢é€»è¾‘
   â†’ æµ‹è¯•æ•…éšœæ¼”ç»ƒ
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ

```
ğŸ”¸ è¯»å†™åˆ†ç¦»æœ¬è´¨ï¼šé€šè¿‡ä¸»ä»æ¶æ„å®ç°è¯»å†™æ“ä½œçš„åˆ†ç¦»å’Œè´Ÿè½½åˆ†æ‹…
ğŸ”¸ ä¸»ä»å»¶è¿Ÿå½±å“ï¼šå¼‚æ­¥å¤åˆ¶å¯¼è‡´çš„æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
ğŸ”¸ è·¯ç”±ç­–ç•¥ï¼šåŸºäºSQLç±»å‹ã€äº‹åŠ¡ä¸Šä¸‹æ–‡çš„æ™ºèƒ½è·¯ç”±å†³ç­–
ğŸ”¸ ä¸€è‡´æ€§ä¿è¯ï¼šå¼ºåˆ¶è¯»ä¸»åº“ã€å»¶è¿Ÿè¡¥å¿ã€ä¼šè¯çº§ä¸€è‡´æ€§
ğŸ”¸ æ•…éšœå¤„ç†ï¼šä¸»ä»æ•…éšœçš„æ£€æµ‹ã€åˆ‡æ¢å’Œæ¢å¤æœºåˆ¶
ğŸ”¸ å®Œæ•´æ–¹æ¡ˆï¼šä»æ¶æ„è®¾è®¡åˆ°è¿ç»´ç›‘æ§çš„å…¨é“¾è·¯è§£å†³æ–¹æ¡ˆ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¯»å†™åˆ†ç¦»çš„ä»·å€¼**
```
æ€§èƒ½æå‡ï¼š
â€¢ è¯»æ“ä½œå¯ä»¥æ°´å¹³æ‰©å±•
â€¢ ä¸»åº“ä¸“æ³¨å¤„ç†å†™æ“ä½œ
â€¢ æ•´ä½“å¹¶å‘èƒ½åŠ›å¤§å¹…æå‡

æ¶æ„ä¼˜åŠ¿ï¼š
â€¢ èŒè´£åˆ†ç¦»ï¼Œä¾¿äºä¼˜åŒ–
â€¢ å¯ç‹¬ç«‹æ‰©å±•è¯»å†™èƒ½åŠ›
â€¢ æä¾›æ•…éšœéš”ç¦»èƒ½åŠ›
```

**ğŸ”¹ ä¸€è‡´æ€§ä¸æ€§èƒ½çš„å¹³è¡¡**
```
å¼ºä¸€è‡´æ€§ï¼š
â€¢ æ‰€æœ‰æ“ä½œéƒ½è¯»ä¸»åº“
â€¢ ä¿è¯æ•°æ®ç»å¯¹ä¸€è‡´
â€¢ æ€§èƒ½æå‡æœ‰é™

æœ€ç»ˆä¸€è‡´æ€§ï¼š
â€¢ å…è®¸çŸ­æœŸæ•°æ®ä¸ä¸€è‡´
â€¢ å……åˆ†åˆ©ç”¨ä»åº“æ€§èƒ½
â€¢ éœ€è¦ä¸šåŠ¡å®¹é”™è®¾è®¡

ä¼šè¯ä¸€è‡´æ€§ï¼š
â€¢ åŒä¸€ç”¨æˆ·ä¼šè¯å†…ä¸€è‡´
â€¢ å¹³è¡¡æ€§èƒ½å’Œä½“éªŒ
â€¢ æœ€å®ç”¨çš„æŠ˜ä¸­æ–¹æ¡ˆ
```

**ğŸ”¹ æ•…éšœå¤„ç†çš„é‡è¦æ€§**
```
é«˜å¯ç”¨ä¿éšœï¼š
â€¢ ä¸»åº“æ•…éšœä¸å½±å“è¯»æ“ä½œ
â€¢ ä»åº“æ•…éšœè‡ªåŠ¨åˆ‡æ¢
â€¢ æœ€å°åŒ–æœåŠ¡ä¸­æ–­æ—¶é—´

æ•°æ®å®‰å…¨ï¼š
â€¢ äº‹åŠ¡å®Œæ•´æ€§ä¿æŠ¤
â€¢ æ•…éšœæ¢å¤æœºåˆ¶
â€¢ æ•°æ®ä¸ä¸¢å¤±ä¿è¯
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šå•†å“æµè§ˆè¯»ä»åº“ï¼Œè®¢å•å¤„ç†è¯»ä¸»åº“
- **å†…å®¹å¹³å°**ï¼šæ–‡ç« å±•ç¤ºè¯»ä»åº“ï¼Œå‘å¸ƒç¼–è¾‘è¯»ä¸»åº“  
- **ç”¨æˆ·ç³»ç»Ÿ**ï¼šä¿¡æ¯æŸ¥è¯¢è¯»ä»åº“ï¼Œæ³¨å†Œç™»å½•è¯»ä¸»åº“
- **ç›‘æ§ç³»ç»Ÿ**ï¼šæ•°æ®å±•ç¤ºè¯»ä»åº“ï¼Œå‘Šè­¦å¤„ç†è¯»ä¸»åº“

**ğŸ”§ æŠ€æœ¯å®è·µè¦ç‚¹**
- **æ¶æ„è®¾è®¡**ï¼šåˆç†è§„åˆ’ä¸»ä»æ‹“æ‰‘å’Œè·¯ç”±ç­–ç•¥
- **æ€§èƒ½è°ƒä¼˜**ï¼šåŸºäºä¸šåŠ¡ç‰¹ç‚¹ä¼˜åŒ–è¯»å†™æ¯”ä¾‹
- **ç›‘æ§è¿ç»´**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œæ•…éšœå¤„ç†æœºåˆ¶
- **ä¸šåŠ¡é€‚é…**ï¼šæ ¹æ®ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©åˆé€‚çš„ç­–ç•¥

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è¯»å†™åˆ†ç¦»èŒè´£æ¸…ï¼Œä¸»å†™ä»è¯»æ€§èƒ½ä½³
- å»¶è¿Ÿé—®é¢˜è¦è€ƒè™‘ï¼Œä¸€è‡´æ€§ç­–ç•¥éœ€æƒè¡¡  
- æ•…éšœåˆ‡æ¢è¦åŠæ—¶ï¼Œç›‘æ§è¿ç»´ä¸å¯å°‘
- ä¸šåŠ¡ç‰¹ç‚¹å®šç­–ç•¥ï¼Œæ¶æ„è®¾è®¡è¦åˆç†