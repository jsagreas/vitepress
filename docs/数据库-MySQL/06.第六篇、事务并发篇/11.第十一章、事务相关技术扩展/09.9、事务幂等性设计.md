---
title: 9ã€äº‹åŠ¡å¹‚ç­‰æ€§è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ](#1-å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ)
2. [å¹‚ç­‰æ€§å®ç°ç­–ç•¥](#2-å¹‚ç­‰æ€§å®ç°ç­–ç•¥)
3. [ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡](#3-ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡)
4. [æŠ€æœ¯å¹‚ç­‰æ€§ä¿è¯](#4-æŠ€æœ¯å¹‚ç­‰æ€§ä¿è¯)
5. [å¹‚ç­‰æ€§æ£€æŸ¥æœºåˆ¶](#5-å¹‚ç­‰æ€§æ£€æŸ¥æœºåˆ¶)
6. [å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯](#6-å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**ç®€å•ç†è§£**ï¼šåŒæ ·çš„æ“ä½œæ‰§è¡Œä¸€æ¬¡å’Œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœå®Œå…¨ä¸€æ ·

> ğŸ“Œ **æ ¸å¿ƒæ¦‚å¿µ**  
> å¹‚ç­‰æ€§å°±åƒæŒ‰ç”µæ¢¯æŒ‰é’®ï¼Œä¸ç®¡ä½ æŒ‰1æ¬¡è¿˜æ˜¯æŒ‰10æ¬¡ï¼Œç”µæ¢¯éƒ½åªä¼šæ¥1æ¬¡ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œå¹‚ç­‰æ“ä½œä¿è¯é‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ã€‚

```
ç”Ÿæ´»ä¸­çš„å¹‚ç­‰æ€§ä¾‹å­ï¼š
å¼€å…³ç¯ï¼šå¼€äº†å°±æ˜¯å¼€ï¼Œå†å¼€è¿˜æ˜¯å¼€ï¼ˆå¹‚ç­‰ï¼‰
éŸ³é‡+1ï¼šæ¯æŒ‰ä¸€æ¬¡éƒ½ä¼šå¢åŠ ï¼ˆéå¹‚ç­‰ï¼‰

æ•°æ®åº“ä¸­çš„å¹‚ç­‰æ€§ï¼š
SELECTæ“ä½œï¼šæŸ¥è¯¢å¤šæ¬¡ç»“æœä¸€æ ·ï¼ˆå¤©ç„¶å¹‚ç­‰ï¼‰
INSERTæ“ä½œï¼šé‡å¤æ’å…¥ä¼šäº§ç”Ÿå¤šæ¡è®°å½•ï¼ˆéå¹‚ç­‰ï¼‰
UPDATE SET amount=100ï¼šè®¾ç½®å›ºå®šå€¼ï¼ˆå¹‚ç­‰ï¼‰
UPDATE SET amount=amount+100ï¼šç´¯åŠ æ“ä½œï¼ˆéå¹‚ç­‰ï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§


**æ ¸å¿ƒé—®é¢˜**ï¼šç½‘ç»œä¸ç¨³å®šã€ç³»ç»Ÿæ•…éšœä¼šå¯¼è‡´é‡å¤è¯·æ±‚

```
å¸¸è§é‡å¤è¯·æ±‚åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç½‘ç»œè¶…æ—¶     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   æœåŠ¡ç«¯    â”‚
â”‚            â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚            â”‚
â”‚  é‡è¯•è¯·æ±‚   â”‚    å®é™…å·²å¤„ç†     â”‚  è®¢å•å·²åˆ›å»º  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šå®¢æˆ·ç«¯ä»¥ä¸ºå¤±è´¥äº†ï¼Œé‡æ–°å‘èµ·è¯·æ±‚
ç»“æœï¼šå¯èƒ½åˆ›å»ºé‡å¤è®¢å•ã€é‡å¤æ‰£æ¬¾
```

**å¹‚ç­‰æ€§çš„ä»·å€¼**ï¼š
- ğŸ›¡ï¸ **é˜²æ­¢é‡å¤å¤„ç†**ï¼šé¿å…é‡å¤æ‰£æ¬¾ã€é‡å¤ä¸‹å•
- ğŸ”„ **æ”¯æŒå®‰å…¨é‡è¯•**ï¼šå®¢æˆ·ç«¯å¯ä»¥æ”¾å¿ƒé‡è¯•
- ğŸ“Š **ä¿è¯æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ä¸šåŠ¡çŠ¶æ€æ­£ç¡®

### 1.3 å¹‚ç­‰æ€§çš„åˆ†ç±»


```
ğŸ“Š å¹‚ç­‰æ€§åˆ†ç±»å¯¹æ¯”ï¼š

| å¹‚ç­‰ç±»å‹ | **ç‰¹ç‚¹** | **ç¤ºä¾‹** | **å®ç°éš¾åº¦** |
|---------|---------|---------|-------------|
| ğŸ” **æŸ¥è¯¢å¹‚ç­‰** | å¤©ç„¶å¹‚ç­‰ | SELECTè¯­å¥ | â­ ç®€å• |
| ğŸ“ **å†™å…¥å¹‚ç­‰** | éœ€è¦è®¾è®¡ | INSERT/UPDATE | â­â­ ä¸­ç­‰ |
| ğŸ”„ **ä¸šåŠ¡å¹‚ç­‰** | å¤æ‚é€»è¾‘ | ä¸‹å•/æ”¯ä»˜ | â­â­â­ å›°éš¾ |
```

---

## 2. âš™ï¸ å¹‚ç­‰æ€§å®ç°ç­–ç•¥


### 2.1 å”¯ä¸€çº¦æŸç­–ç•¥


**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨æ•°æ®åº“å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ’å…¥

```sql
-- åˆ›å»ºè®¢å•è¡¨ï¼Œä½¿ç”¨ä¸šåŠ¡IDä½œä¸ºå”¯ä¸€çº¦æŸ
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL COMMENT 'è®¢å•å·',
    user_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    status TINYINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¹‚ç­‰æ’å…¥ç¤ºä¾‹
INSERT IGNORE INTO orders (order_no, user_id, amount) 
VALUES ('ORD20250906001', 12345, 99.50);
```

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> `INSERT IGNORE` é‡åˆ°é‡å¤é”®ä¼šå¿½ç•¥æ’å…¥ï¼Œä¸ä¼šæŠ¥é”™ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ `ON DUPLICATE KEY UPDATE` æ¥æ›´æ–°å·²å­˜åœ¨çš„è®°å½•ã€‚

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š

| ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|
| âœ… å®ç°ç®€å•ï¼Œæ•°æ®åº“å±‚é¢ä¿è¯ | âŒ åªé€‚ç”¨äºINSERTæ“ä½œ |
| âœ… æ€§èƒ½å¥½ï¼Œæ— éœ€é¢å¤–æŸ¥è¯¢ | âŒ éœ€è¦é¢„å…ˆè®¾è®¡å”¯ä¸€å­—æ®µ |
| âœ… å¹¶å‘å®‰å…¨ï¼Œæ— ç«æ€æ¡ä»¶ | âŒ é”™è¯¯å¤„ç†éœ€è¦ç‰¹æ®Šé€»è¾‘ |

### 2.2 çŠ¶æ€æœºç­–ç•¥


**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡çŠ¶æ€æµè½¬æ§åˆ¶æ“ä½œçš„æ‰§è¡Œ

```sql
-- çŠ¶æ€æœºç¤ºä¾‹ï¼šè®¢å•çŠ¶æ€æµè½¬
CREATE TABLE order_status_flow (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    from_status TINYINT NOT NULL COMMENT 'åŸçŠ¶æ€',
    to_status TINYINT NOT NULL COMMENT 'ç›®æ ‡çŠ¶æ€',
    operation VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_order_operation (order_id, operation)
);

-- å¹‚ç­‰çš„çŠ¶æ€æ›´æ–°
UPDATE orders 
SET status = 2 -- å·²æ”¯ä»˜
WHERE id = 123 
  AND status = 1; -- åªæœ‰æœªæ”¯ä»˜çŠ¶æ€æ‰èƒ½è½¬ä¸ºå·²æ”¯ä»˜
```

**çŠ¶æ€æµè½¬å›¾**ï¼š
```
è®¢å•çŠ¶æ€æµè½¬ï¼š
å¾…æ”¯ä»˜(1) â”€â”€æ”¯ä»˜â”€â”€â†’ å·²æ”¯ä»˜(2) â”€â”€å‘è´§â”€â”€â†’ å·²å‘è´§(3)
    â†“                    â†“              â†“
  å–æ¶ˆ(0)            é€€æ¬¾(-1)        å®Œæˆ(4)

å¹‚ç­‰ä¿è¯ï¼šåªæœ‰ç‰¹å®šçŠ¶æ€æ‰èƒ½æ‰§è¡Œç‰¹å®šæ“ä½œ
```

### 2.3 Tokenæœºåˆ¶ç­–ç•¥


**æ ¸å¿ƒæ€æƒ³**ï¼šé¢„å…ˆç”Ÿæˆå”¯ä¸€ä»¤ç‰Œï¼Œæ“ä½œæ—¶æ¶ˆè´¹ä»¤ç‰Œ

```sql
-- åˆ›å»ºå¹‚ç­‰ä»¤ç‰Œè¡¨
CREATE TABLE idempotent_tokens (
    token VARCHAR(64) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    business_type VARCHAR(50) NOT NULL,
    used TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å·²ä½¿ç”¨',
    expire_time TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_business (user_id, business_type)
);

-- ç”ŸæˆTokençš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE GenerateToken(
    IN p_user_id BIGINT,
    IN p_business_type VARCHAR(50),
    OUT p_token VARCHAR(64)
)
BEGIN
    SET p_token = CONCAT(p_business_type, '_', UNIX_TIMESTAMP(), '_', 
                        SUBSTRING(MD5(CONCAT(p_user_id, RAND())), 1, 16));
    
    INSERT INTO idempotent_tokens (token, user_id, business_type, expire_time)
    VALUES (p_token, p_user_id, p_business_type, DATE_ADD(NOW(), INTERVAL 10 MINUTE));
END //
DELIMITER ;
```

**Tokenä½¿ç”¨æµç¨‹**ï¼š
```
Tokenå¹‚ç­‰æµç¨‹ï¼š
å®¢æˆ·ç«¯                   æœåŠ¡ç«¯                   æ•°æ®åº“
   |                      |                       |
   |â”€â”€[1]ç”³è¯·Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|                       |
   |                      |â”€â”€[2]ç”ŸæˆTokenâ”€â”€â”€â”€â”€â”€â”€â”€â†’|
   |                      |â†â”€[3]è¿”å›Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”‚|
   |â†â”€[4]è¿”å›Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€|                       |
   |                      |                       |
   |â”€â”€[5]ä¸šåŠ¡è¯·æ±‚+Tokenâ”€â”€â”€â”€â†’|                       |
   |                      |â”€â”€[6]æ£€æŸ¥å¹¶æ¶ˆè´¹Tokenâ”€â”€â†’|
   |                      |â†â”€[7]æ‰§è¡Œä¸šåŠ¡é€»è¾‘â”€â”€â”€â”€â”€â”€â”‚|
   |â†â”€[8]è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚|                       |
```

---

## 3. ğŸ¢ ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡


### 3.1 ç”µå•†è®¢å•å¹‚ç­‰è®¾è®¡


**ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·ä¸‹å•æ“ä½œéœ€è¦ä¿è¯å¹‚ç­‰æ€§

```sql
-- è®¢å•ä¸»è¡¨
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status TINYINT DEFAULT 1 COMMENT '1:å¾…æ”¯ä»˜ 2:å·²æ”¯ä»˜ 3:å·²å‘è´§ 4:å·²å®Œæˆ 0:å·²å–æ¶ˆ',
    idempotent_key VARCHAR(64) UNIQUE COMMENT 'å¹‚ç­‰é”®',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è®¢å•å•†å“æ˜ç»†è¡¨
CREATE TABLE order_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    INDEX idx_order_id (order_id)
);
```

**å¹‚ç­‰ä¸‹å•å®ç°**ï¼š
```sql
-- å¹‚ç­‰ä¸‹å•çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE CreateOrderIdempotent(
    IN p_idempotent_key VARCHAR(64),
    IN p_user_id BIGINT,
    IN p_product_data JSON,
    OUT p_result_code INT,
    OUT p_order_no VARCHAR(32)
)
BEGIN
    DECLARE v_order_id BIGINT DEFAULT 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result_code = -1;
    END;
    
    START TRANSACTION;
    
    -- æ£€æŸ¥å¹‚ç­‰é”®æ˜¯å¦å·²å­˜åœ¨
    SELECT order_no INTO p_order_no 
    FROM orders 
    WHERE idempotent_key = p_idempotent_key;
    
    IF p_order_no IS NOT NULL THEN
        -- å·²å­˜åœ¨ï¼Œè¿”å›åŸè®¢å•å·
        SET p_result_code = 0;
        COMMIT;
    ELSE
        -- åˆ›å»ºæ–°è®¢å•
        SET p_order_no = CONCAT('ORD', DATE_FORMAT(NOW(), '%Y%m%d'), 
                               LPAD(FLOOR(RAND() * 999999), 6, '0'));
        
        INSERT INTO orders (order_no, user_id, total_amount, idempotent_key)
        VALUES (p_order_no, p_user_id, 
               JSON_UNQUOTE(JSON_EXTRACT(p_product_data, '$.total_amount')), 
               p_idempotent_key);
        
        SET v_order_id = LAST_INSERT_ID();
        
        -- æ’å…¥è®¢å•æ˜ç»†ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        INSERT INTO order_items (order_id, product_id, quantity, price)
        SELECT v_order_id,
               JSON_UNQUOTE(JSON_EXTRACT(item, '$.product_id')),
               JSON_UNQUOTE(JSON_EXTRACT(item, '$.quantity')),
               JSON_UNQUOTE(JSON_EXTRACT(item, '$.price'))
        FROM JSON_TABLE(p_product_data, '$.items[*]' 
                       COLUMNS (item JSON PATH '$')) AS jt;
        
        SET p_result_code = 1;
        COMMIT;
    END IF;
END //
DELIMITER ;
```

### 3.2 æ”¯ä»˜å¹‚ç­‰è®¾è®¡


**ä¸šåŠ¡åœºæ™¯**ï¼šæ”¯ä»˜æ“ä½œå¿…é¡»ä¸¥æ ¼ä¿è¯å¹‚ç­‰æ€§

```sql
-- æ”¯ä»˜è®°å½•è¡¨
CREATE TABLE payment_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    payment_no VARCHAR(32) UNIQUE NOT NULL,
    order_no VARCHAR(32) NOT NULL,
    user_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    payment_method TINYINT NOT NULL COMMENT '1:æ”¯ä»˜å® 2:å¾®ä¿¡ 3:é“¶è¡Œå¡',
    external_trade_no VARCHAR(64) COMMENT 'ç¬¬ä¸‰æ–¹äº¤æ˜“å·',
    status TINYINT DEFAULT 1 COMMENT '1:å¤„ç†ä¸­ 2:æˆåŠŸ 3:å¤±è´¥',
    idempotent_key VARCHAR(64) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**æ”¯ä»˜å¹‚ç­‰é€»è¾‘**ï¼š
```sql
-- å¹‚ç­‰æ”¯ä»˜å¤„ç†
DELIMITER //
CREATE PROCEDURE ProcessPaymentIdempotent(
    IN p_idempotent_key VARCHAR(64),
    IN p_order_no VARCHAR(32),
    IN p_amount DECIMAL(10,2),
    OUT p_result_code INT,
    OUT p_payment_no VARCHAR(32)
)
BEGIN
    DECLARE v_existing_status TINYINT DEFAULT 0;
    
    -- æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ”¯ä»˜è®°å½•
    SELECT payment_no, status 
    INTO p_payment_no, v_existing_status
    FROM payment_records 
    WHERE idempotent_key = p_idempotent_key;
    
    IF p_payment_no IS NOT NULL THEN
        -- å·²å­˜åœ¨æ”¯ä»˜è®°å½•
        CASE v_existing_status
            WHEN 1 THEN SET p_result_code = 1; -- å¤„ç†ä¸­
            WHEN 2 THEN SET p_result_code = 2; -- å·²æˆåŠŸ
            WHEN 3 THEN SET p_result_code = 3; -- å·²å¤±è´¥
        END CASE;
    ELSE
        -- åˆ›å»ºæ–°æ”¯ä»˜è®°å½•
        SET p_payment_no = CONCAT('PAY', DATE_FORMAT(NOW(), '%Y%m%d'), 
                                 LPAD(FLOOR(RAND() * 999999), 6, '0'));
        
        INSERT INTO payment_records (payment_no, order_no, amount, idempotent_key)
        VALUES (p_payment_no, p_order_no, p_amount, p_idempotent_key);
        
        SET p_result_code = 0; -- æ–°åˆ›å»º
    END IF;
END //
DELIMITER ;
```

---

## 4. ğŸ”§ æŠ€æœ¯å¹‚ç­‰æ€§ä¿è¯


### 4.1 åˆ†å¸ƒå¼é”å®ç°


**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡åˆ†å¸ƒå¼é”ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¯·æ±‚åœ¨å¤„ç†

```sql
-- åŸºäºMySQLçš„åˆ†å¸ƒå¼é”è¡¨
CREATE TABLE distributed_locks (
    lock_key VARCHAR(128) PRIMARY KEY,
    holder VARCHAR(64) NOT NULL COMMENT 'é”æŒæœ‰è€…æ ‡è¯†',
    expire_time TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_expire_time (expire_time)
);

-- è·å–åˆ†å¸ƒå¼é”çš„å‡½æ•°
DELIMITER //
CREATE FUNCTION AcquireLock(
    p_lock_key VARCHAR(128),
    p_holder VARCHAR(64),
    p_timeout_seconds INT
) RETURNS TINYINT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_result TINYINT DEFAULT 0;
    DECLARE v_expire_time TIMESTAMP;
    
    SET v_expire_time = DATE_ADD(NOW(), INTERVAL p_timeout_seconds SECOND);
    
    -- å°è¯•æ’å…¥é”è®°å½•
    INSERT IGNORE INTO distributed_locks (lock_key, holder, expire_time)
    VALUES (p_lock_key, p_holder, v_expire_time);
    
    -- æ£€æŸ¥æ˜¯å¦è·å–æˆåŠŸ
    IF ROW_COUNT() > 0 THEN
        SET v_result = 1;
    ELSE
        -- æ¸…ç†è¿‡æœŸé”
        DELETE FROM distributed_locks 
        WHERE lock_key = p_lock_key AND expire_time < NOW();
        
        -- å†æ¬¡å°è¯•è·å–
        INSERT IGNORE INTO distributed_locks (lock_key, holder, expire_time)
        VALUES (p_lock_key, p_holder, v_expire_time);
        
        IF ROW_COUNT() > 0 THEN
            SET v_result = 1;
        END IF;
    END IF;
    
    RETURN v_result;
END //
DELIMITER ;
```

### 4.2 ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶


**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡ç‰ˆæœ¬å·æ§åˆ¶å¹¶å‘æ›´æ–°

```sql
-- å¸¦ç‰ˆæœ¬æ§åˆ¶çš„è´¦æˆ·è¡¨
CREATE TABLE user_accounts (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    balance DECIMAL(15,2) DEFAULT 0.00,
    version INT DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- å¹‚ç­‰çš„ä½™é¢æ›´æ–°
DELIMITER //
CREATE PROCEDURE UpdateBalanceIdempotent(
    IN p_user_id BIGINT,
    IN p_amount DECIMAL(15,2),
    IN p_operation_id VARCHAR(64),
    OUT p_result_code INT
)
BEGIN
    DECLARE v_current_version INT DEFAULT 0;
    DECLARE v_affected_rows INT DEFAULT 0;
    DECLARE v_retry_count INT DEFAULT 0;
    DECLARE v_max_retries INT DEFAULT 3;
    
    -- æ£€æŸ¥æ“ä½œæ˜¯å¦å·²æ‰§è¡Œ
    IF EXISTS(SELECT 1 FROM operation_logs WHERE operation_id = p_operation_id) THEN
        SET p_result_code = 0; -- å·²æ‰§è¡Œè¿‡
        LEAVE proc_exit;
    END IF;
    
    retry_loop: LOOP
        -- è·å–å½“å‰ç‰ˆæœ¬
        SELECT version INTO v_current_version 
        FROM user_accounts 
        WHERE user_id = p_user_id;
        
        -- å°è¯•æ›´æ–°
        UPDATE user_accounts 
        SET balance = balance + p_amount,
            version = version + 1
        WHERE user_id = p_user_id 
          AND version = v_current_version
          AND balance + p_amount >= 0; -- é˜²æ­¢ä½™é¢ä¸ºè´Ÿ
        
        SET v_affected_rows = ROW_COUNT();
        
        IF v_affected_rows > 0 THEN
            -- è®°å½•æ“ä½œæ—¥å¿—
            INSERT INTO operation_logs (operation_id, user_id, amount, operation_type)
            VALUES (p_operation_id, p_user_id, p_amount, 'BALANCE_UPDATE');
            
            SET p_result_code = 1; -- æˆåŠŸ
            LEAVE retry_loop;
        ELSE
            SET v_retry_count = v_retry_count + 1;
            IF v_retry_count >= v_max_retries THEN
                SET p_result_code = -1; -- å¤±è´¥
                LEAVE retry_loop;
            END IF;
            
            -- çŸ­æš‚ç­‰å¾…åé‡è¯•
            DO SLEEP(0.01);
        END IF;
    END LOOP retry_loop;
    
    proc_exit: BEGIN END;
END //
DELIMITER ;
```

### 4.3 åŸºäºæ—¶é—´çª—å£çš„å»é‡


**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨æŒ‡å®šæ—¶é—´çª—å£å†…é˜²æ­¢é‡å¤æ“ä½œ

```sql
-- æ“ä½œå»é‡è¡¨
CREATE TABLE operation_dedup (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    operation_type VARCHAR(50) NOT NULL,
    operation_key VARCHAR(128) NOT NULL,
    business_data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_dedup (user_id, operation_type, operation_key),
    INDEX idx_created_at (created_at)
);

-- æ—¶é—´çª—å£å»é‡æ£€æŸ¥
DELIMITER //
CREATE FUNCTION CheckDuplicateOperation(
    p_user_id BIGINT,
    p_operation_type VARCHAR(50),
    p_operation_key VARCHAR(128),
    p_window_minutes INT
) RETURNS TINYINT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_count INT DEFAULT 0;
    DECLARE v_time_threshold TIMESTAMP;
    
    SET v_time_threshold = DATE_SUB(NOW(), INTERVAL p_window_minutes MINUTE);
    
    SELECT COUNT(*) INTO v_count
    FROM operation_dedup
    WHERE user_id = p_user_id
      AND operation_type = p_operation_type
      AND operation_key = p_operation_key
      AND created_at > v_time_threshold;
    
    RETURN IF(v_count > 0, 1, 0);
END //
DELIMITER ;
```

---

## 5. ğŸ” å¹‚ç­‰æ€§æ£€æŸ¥æœºåˆ¶


### 5.1 å¹‚ç­‰æ€§éªŒè¯æ¡†æ¶


**è®¾è®¡æ€è·¯**ï¼šå»ºç«‹ç»Ÿä¸€çš„å¹‚ç­‰æ€§æ£€æŸ¥å’ŒéªŒè¯æœºåˆ¶

```sql
-- å¹‚ç­‰æ€§è§„åˆ™é…ç½®è¡¨
CREATE TABLE idempotent_rules (
    id INT AUTO_INCREMENT PRIMARY KEY,
    business_type VARCHAR(50) NOT NULL COMMENT 'ä¸šåŠ¡ç±»å‹',
    rule_type ENUM('unique_key', 'token', 'time_window', 'status_machine') NOT NULL,
    rule_config JSON NOT NULL COMMENT 'è§„åˆ™é…ç½®',
    is_active TINYINT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥è§„åˆ™é…ç½®ç¤ºä¾‹
INSERT INTO idempotent_rules (business_type, rule_type, rule_config) VALUES
('order_create', 'unique_key', '{"table": "orders", "column": "idempotent_key"}'),
('payment', 'token', '{"table": "idempotent_tokens", "expire_minutes": 10}'),
('balance_update', 'time_window', '{"window_minutes": 5, "max_operations": 1}');
```

**é€šç”¨å¹‚ç­‰æ£€æŸ¥å­˜å‚¨è¿‡ç¨‹**ï¼š
```sql
DELIMITER //
CREATE PROCEDURE CheckIdempotent(
    IN p_business_type VARCHAR(50),
    IN p_idempotent_key VARCHAR(128),
    IN p_user_id BIGINT,
    OUT p_is_duplicate TINYINT,
    OUT p_previous_result JSON
)
BEGIN
    DECLARE v_rule_type VARCHAR(50);
    DECLARE v_rule_config JSON;
    DECLARE v_table_name VARCHAR(100);
    DECLARE v_column_name VARCHAR(100);
    DECLARE v_sql_text TEXT;
    
    -- è·å–å¹‚ç­‰è§„åˆ™
    SELECT rule_type, rule_config 
    INTO v_rule_type, v_rule_config
    FROM idempotent_rules 
    WHERE business_type = p_business_type AND is_active = 1;
    
    IF v_rule_type IS NULL THEN
        SET p_is_duplicate = 0;
        SET p_previous_result = NULL;
    ELSE
        CASE v_rule_type
            WHEN 'unique_key' THEN
                SET v_table_name = JSON_UNQUOTE(JSON_EXTRACT(v_rule_config, '$.table'));
                SET v_column_name = JSON_UNQUOTE(JSON_EXTRACT(v_rule_config, '$.column'));
                
                SET @sql = CONCAT(
                    'SELECT COUNT(*) INTO @dup_count FROM ', v_table_name,
                    ' WHERE ', v_column_name, ' = ?'
                );
                
                PREPARE stmt FROM @sql;
                SET @key_param = p_idempotent_key;
                EXECUTE stmt USING @key_param;
                DEALLOCATE PREPARE stmt;
                
                SET p_is_duplicate = IF(@dup_count > 0, 1, 0);
                
            WHEN 'time_window' THEN
                -- æ—¶é—´çª—å£æ£€æŸ¥é€»è¾‘
                SET p_is_duplicate = CheckDuplicateOperation(
                    p_user_id, 
                    p_business_type, 
                    p_idempotent_key,
                    JSON_UNQUOTE(JSON_EXTRACT(v_rule_config, '$.window_minutes'))
                );
        END CASE;
    END IF;
END //
DELIMITER ;
```

### 5.2 å¹‚ç­‰æ€§å®¡è®¡æ—¥å¿—


**ç›®çš„**ï¼šè®°å½•æ‰€æœ‰å¹‚ç­‰æ€§æ£€æŸ¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

```sql
-- å¹‚ç­‰æ€§å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE idempotent_audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    request_id VARCHAR(64) NOT NULL COMMENT 'è¯·æ±‚ID',
    business_type VARCHAR(50) NOT NULL,
    idempotent_key VARCHAR(128) NOT NULL,
    user_id BIGINT,
    check_result ENUM('pass', 'duplicate', 'error') NOT NULL,
    rule_type VARCHAR(50),
    execution_time_ms INT COMMENT 'æ‰§è¡Œè€—æ—¶(æ¯«ç§’)',
    error_message TEXT,
    request_data JSON,
    response_data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_business_key (business_type, idempotent_key),
    INDEX idx_user_time (user_id, created_at),
    INDEX idx_request_id (request_id)
);

-- è®°å½•å®¡è®¡æ—¥å¿—çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE LogIdempotentCheck(
    IN p_request_id VARCHAR(64),
    IN p_business_type VARCHAR(50),
    IN p_idempotent_key VARCHAR(128),
    IN p_user_id BIGINT,
    IN p_check_result VARCHAR(20),
    IN p_rule_type VARCHAR(50),
    IN p_execution_time_ms INT,
    IN p_error_message TEXT,
    IN p_request_data JSON,
    IN p_response_data JSON
)
BEGIN
    INSERT INTO idempotent_audit_logs (
        request_id, business_type, idempotent_key, user_id,
        check_result, rule_type, execution_time_ms, error_message,
        request_data, response_data
    ) VALUES (
        p_request_id, p_business_type, p_idempotent_key, p_user_id,
        p_check_result, p_rule_type, p_execution_time_ms, p_error_message,
        p_request_data, p_response_data
    );
END //
DELIMITER ;
```

---

## 6. ğŸ§ª å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯


### 6.1 å¹¶å‘æµ‹è¯•åœºæ™¯


**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¹‚ç­‰æ€§æ˜¯å¦æ­£ç¡®å·¥ä½œ

```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®è¡¨
CREATE TABLE test_concurrent_orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    idempotent_key VARCHAR(64) UNIQUE,
    thread_id VARCHAR(20) COMMENT 'æµ‹è¯•çº¿ç¨‹æ ‡è¯†',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¹¶å‘æµ‹è¯•å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE TestConcurrentIdempotent(
    IN p_idempotent_key VARCHAR(64),
    IN p_user_id BIGINT,
    IN p_amount DECIMAL(10,2),
    IN p_thread_id VARCHAR(20),
    OUT p_result VARCHAR(50)
)
BEGIN
    DECLARE v_order_count INT DEFAULT 0;
    DECLARE v_order_no VARCHAR(32);
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result = 'ERROR';
    END;
    
    START TRANSACTION;
    
    -- å°è¯•åˆ›å»ºè®¢å•
    SET v_order_no = CONCAT('TEST_', DATE_FORMAT(NOW(), '%Y%m%d_%H%i%s'), '_', p_thread_id);
    
    INSERT IGNORE INTO test_concurrent_orders 
    (order_no, user_id, amount, idempotent_key, thread_id)
    VALUES (v_order_no, p_user_id, p_amount, p_idempotent_key, p_thread_id);
    
    -- æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ
    SELECT COUNT(*) INTO v_order_count 
    FROM test_concurrent_orders 
    WHERE idempotent_key = p_idempotent_key;
    
    IF v_order_count = 1 THEN
        -- æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹åˆ›å»ºçš„
        IF EXISTS(SELECT 1 FROM test_concurrent_orders 
                 WHERE idempotent_key = p_idempotent_key 
                   AND thread_id = p_thread_id) THEN
            SET p_result = 'SUCCESS_CREATED';
        ELSE
            SET p_result = 'SUCCESS_EXISTED';
        END IF;
    ELSE
        SET p_result = 'DUPLICATE_ERROR';
    END IF;
    
    COMMIT;
END //
DELIMITER ;
```

### 6.2 å¹‚ç­‰æ€§å‹åŠ›æµ‹è¯•


**æµ‹è¯•è„šæœ¬**ï¼šæ¨¡æ‹Ÿå¤§é‡å¹¶å‘è¯·æ±‚éªŒè¯å¹‚ç­‰æ€§

```sql
-- æµ‹è¯•ç»“æœç»Ÿè®¡è¡¨
CREATE TABLE idempotent_test_results (
    id INT AUTO_INCREMENT PRIMARY KEY,
    test_batch VARCHAR(50) NOT NULL,
    total_requests INT NOT NULL,
    success_created INT NOT NULL,
    success_existed INT NOT NULL,
    errors INT NOT NULL,
    test_duration_seconds INT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ‰¹é‡æµ‹è¯•å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE BatchTestIdempotent(
    IN p_test_batch VARCHAR(50),
    IN p_concurrent_count INT,
    IN p_idempotent_key VARCHAR(64)
)
BEGIN
    DECLARE v_i INT DEFAULT 1;
    DECLARE v_start_time TIMESTAMP DEFAULT NOW();
    DECLARE v_end_time TIMESTAMP;
    DECLARE v_success_created INT DEFAULT 0;
    DECLARE v_success_existed INT DEFAULT 0;
    DECLARE v_errors INT DEFAULT 0;
    DECLARE v_result VARCHAR(50);
    
    -- æ¸…ç†æµ‹è¯•æ•°æ®
    DELETE FROM test_concurrent_orders WHERE idempotent_key = p_idempotent_key;
    
    -- æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚
    WHILE v_i <= p_concurrent_count DO
        CALL TestConcurrentIdempotent(
            p_idempotent_key,
            12345, -- å›ºå®šç”¨æˆ·ID
            99.99, -- å›ºå®šé‡‘é¢
            CONCAT('THREAD_', v_i),
            v_result
        );
        
        CASE v_result
            WHEN 'SUCCESS_CREATED' THEN SET v_success_created = v_success_created + 1;
            WHEN 'SUCCESS_EXISTED' THEN SET v_success_existed = v_success_existed + 1;
            ELSE SET v_errors = v_errors + 1;
        END CASE;
        
        SET v_i = v_i + 1;
    END WHILE;
    
    SET v_end_time = NOW();
    
    -- è®°å½•æµ‹è¯•ç»“æœ
    INSERT INTO idempotent_test_results (
        test_batch, total_requests, success_created, success_existed, errors,
        test_duration_seconds
    ) VALUES (
        p_test_batch, p_concurrent_count, v_success_created, v_success_existed, 
        v_errors, TIMESTAMPDIFF(SECOND, v_start_time, v_end_time)
    );
    
    -- æ˜¾ç¤ºç»“æœ
    SELECT 
        CONCAT('æµ‹è¯•æ‰¹æ¬¡: ', p_test_batch) AS test_info,
        CONCAT('æ€»è¯·æ±‚æ•°: ', p_concurrent_count) AS total_requests,
        CONCAT('æˆåŠŸåˆ›å»º: ', v_success_created) AS created,
        CONCAT('å¹‚ç­‰è¿”å›: ', v_success_existed) AS existed,
        CONCAT('é”™è¯¯æ•°: ', v_errors) AS errors,
        CONCAT('å¹‚ç­‰ç‡: ', ROUND(v_success_existed * 100.0 / p_concurrent_count, 2), '%') AS idempotent_rate;
END //
DELIMITER ;
```

### 6.3 å¹‚ç­‰æ€§éªŒè¯è§„åˆ™


**éªŒè¯æ¸…å•**ï¼šç¡®ä¿å¹‚ç­‰æ€§å®ç°çš„æ­£ç¡®æ€§

> âœ… **è‡ªæ£€æ¸…å•**ï¼š
> - [ ] ç›¸åŒå‚æ•°çš„é‡å¤è°ƒç”¨è¿”å›ç›¸åŒç»“æœ
> - [ ] æ•°æ®åº“ä¸­ä¸ä¼šäº§ç”Ÿé‡å¤è®°å½•
> - [ ] å¹¶å‘åœºæ™¯ä¸‹åªæœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸæ‰§è¡Œ
> - [ ] ç½‘ç»œè¶…æ—¶é‡è¯•ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
> - [ ] å¼‚å¸¸æƒ…å†µä¸‹èƒ½æ­£ç¡®å›æ»š
> - [ ] å¹‚ç­‰é”®çš„å”¯ä¸€æ€§å¾—åˆ°ä¿è¯

```sql
-- å¹‚ç­‰æ€§éªŒè¯è§†å›¾
CREATE VIEW v_idempotent_validation AS
SELECT 
    business_type,
    DATE(created_at) as test_date,
    COUNT(*) as total_operations,
    COUNT(DISTINCT idempotent_key) as unique_keys,
    COUNT(*) - COUNT(DISTINCT idempotent_key) as duplicate_count,
    ROUND((COUNT(*) - COUNT(DISTINCT idempotent_key)) * 100.0 / COUNT(*), 2) as duplicate_rate
FROM idempotent_audit_logs
WHERE check_result IN ('pass', 'duplicate')
GROUP BY business_type, DATE(created_at)
ORDER BY test_date DESC, business_type;
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹‚ç­‰æ€§æœ¬è´¨ï¼šåŒæ ·æ“ä½œæ‰§è¡Œå¤šæ¬¡ç»“æœå®Œå…¨ä¸€æ ·
ğŸ”¸ å®ç°ç­–ç•¥ï¼šå”¯ä¸€çº¦æŸã€çŠ¶æ€æœºã€Tokenæœºåˆ¶ã€åˆ†å¸ƒå¼é”
ğŸ”¸ ä¸šåŠ¡è®¾è®¡ï¼šè®¢å•åˆ›å»ºã€æ”¯ä»˜å¤„ç†ã€ä½™é¢æ›´æ–°ç­‰æ ¸å¿ƒåœºæ™¯
ğŸ”¸ æŠ€æœ¯ä¿è¯ï¼šç‰ˆæœ¬æ§åˆ¶ã€æ—¶é—´çª—å£ã€åˆ†å¸ƒå¼é”æœºåˆ¶
ğŸ”¸ æ£€æŸ¥æœºåˆ¶ï¼šç»Ÿä¸€éªŒè¯æ¡†æ¶ã€å®¡è®¡æ—¥å¿—ã€æµ‹è¯•éªŒè¯
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¹‚ç­‰æ€§ä¸æ˜¯é“¶å¼¹**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… é‡å¤æ‰§è¡Œæœ‰å®³çš„æ“ä½œï¼ˆæ‰£æ¬¾ã€ä¸‹å•ï¼‰
âœ… ç½‘ç»œä¸ç¨³å®šéœ€è¦é‡è¯•çš„åœºæ™¯
âœ… åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§è¦æ±‚

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ å¤©ç„¶å¹‚ç­‰çš„æŸ¥è¯¢æ“ä½œ
âŒ æœ‰åºæ‰§è¡Œçš„æ—¶é—´æ•æ„Ÿæ“ä½œ
âŒ éœ€è¦ç´¯ç§¯æ•ˆæœçš„ç»Ÿè®¡æ“ä½œ
```

**ğŸ”¹ é€‰æ‹©åˆé€‚çš„å®ç°ç­–ç•¥**
```
ç­–ç•¥é€‰æ‹©åŸåˆ™ï¼š
â€¢ ç®€å•åœºæ™¯ â†’ å”¯ä¸€çº¦æŸ
â€¢ å¤æ‚ä¸šåŠ¡ â†’ çŠ¶æ€æœº
â€¢ é«˜å¹¶å‘ â†’ Tokenæœºåˆ¶
â€¢ åˆ†å¸ƒå¼ â†’ åˆ†å¸ƒå¼é”
```

**ğŸ”¹ æ€§èƒ½ä¸å¯é æ€§çš„æƒè¡¡**
```
æ€§èƒ½è€ƒè™‘ï¼š
- å¹‚ç­‰æ£€æŸ¥å¢åŠ å“åº”æ—¶é—´
- éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´
- å¯èƒ½å¼•å…¥é¢å¤–çš„é”ç«äº‰

å¯é æ€§æ”¶ç›Šï¼š
- é˜²æ­¢é‡å¤æ‰§è¡Œå¸¦æ¥çš„æŸå¤±
- æé«˜ç³»ç»Ÿå®¹é”™èƒ½åŠ›
- ç®€åŒ–å®¢æˆ·ç«¯é‡è¯•é€»è¾‘
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼**
- **é‡‘èå®‰å…¨**ï¼šé˜²æ­¢é‡å¤æ‰£æ¬¾ã€é‡å¤è½¬è´¦
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ”¯æŒå®‰å…¨é‡è¯•ï¼Œå‡å°‘ç”¨æˆ·å›°æ‰°
- **ç³»ç»Ÿç¨³å®š**ï¼šæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯é æ€§
- **è¿ç»´ç®€åŒ–**ï¼šå‡å°‘äººå·¥å¤„ç†é‡å¤æ•°æ®çš„å·¥ä½œé‡

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- **æ¶æ„è®¾è®¡**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿçš„é‡è¦è®¾è®¡åŸåˆ™
- **ä»£ç è´¨é‡**ï¼šæé«˜ç³»ç»Ÿçš„å¥å£®æ€§å’Œå®¹é”™æ€§
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…æ— æ•ˆçš„é‡å¤å¤„ç†
- **ç›‘æ§è¿ç»´**ï¼šæä¾›æ¸…æ™°çš„æ“ä½œå®¡è®¡è½¨è¿¹

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®‰å…¨ä¿éšœ
- é€‰æ‹©åˆé€‚çš„å®ç°ç­–ç•¥æœ€é‡è¦
- æµ‹è¯•éªŒè¯ç¡®ä¿å¹‚ç­‰æ€§çœŸæ­£æœ‰æ•ˆ
- å¹³è¡¡æ€§èƒ½å’Œå¯é æ€§çš„å…³ç³»