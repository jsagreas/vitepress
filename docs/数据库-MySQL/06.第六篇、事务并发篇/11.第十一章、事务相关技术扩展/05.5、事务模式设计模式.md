---
title: 5ã€äº‹åŠ¡æ¨¡å¼è®¾è®¡æ¨¡å¼
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ](#1-äº‹åŠ¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ)
2. [äº‹åŠ¡è„šæœ¬æ¨¡å¼](#2-äº‹åŠ¡è„šæœ¬æ¨¡å¼)
3. [é¢†åŸŸæ¨¡å‹äº‹åŠ¡](#3-é¢†åŸŸæ¨¡å‹äº‹åŠ¡)
4. [æ•°æ®æ˜ å°„å™¨äº‹åŠ¡](#4-æ•°æ®æ˜ å°„å™¨äº‹åŠ¡)
5. [Unit of Workæ¨¡å¼](#5-unit-of-workæ¨¡å¼)
6. [äº‹åŠ¡è¾¹ç•Œæ¨¡å¼](#6-äº‹åŠ¡è¾¹ç•Œæ¨¡å¼)
7. [æ¨¡å¼é€‰æ‹©ç­–ç•¥](#7-æ¨¡å¼é€‰æ‹©ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡æ¨¡å¼åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡è®¾è®¡æ¨¡å¼


**ç®€å•ç†è§£**ï¼šäº‹åŠ¡è®¾è®¡æ¨¡å¼å°±æ˜¯ç®¡ç†æ•°æ®åº“æ“ä½œçš„ä¸åŒæ–¹æ³•ï¼Œå°±åƒæ•´ç†æˆ¿é—´æœ‰ä¸åŒçš„ç­–ç•¥ä¸€æ ·ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
æ•´ç†æˆ¿é—´çš„æ–¹å¼ï¼š
æ–¹å¼1ï¼šä¸€æ¬¡æ€§æŠŠæ‰€æœ‰ä¸œè¥¿éƒ½æ•´ç†å®Œ â†’ äº‹åŠ¡è„šæœ¬æ¨¡å¼
æ–¹å¼2ï¼šåˆ†ç±»æ•´ç†ï¼Œè¡£æœå½’è¡£æœï¼Œä¹¦å½’ä¹¦ â†’ é¢†åŸŸæ¨¡å‹æ¨¡å¼  
æ–¹å¼3ï¼šè®°å½•æ¯ä¸ªç‰©å“çš„ä½ç½®å˜åŒ– â†’ Unit of Workæ¨¡å¼
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ç›¸å…³æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- **å¹¶å‘æ§åˆ¶**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶æ“ä½œæ—¶ä¸ä¼šå‡ºç°å†²çª
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡
- **ä»£ç ç»„ç»‡**ï¼šè®©äº‹åŠ¡ç›¸å…³ä»£ç æ›´æ¸…æ™°ã€æ›´å¥½ç»´æŠ¤

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡æ¨¡å¼


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
è½¬è´¦æ“ä½œï¼š
- ä»Aè´¦æˆ·æ‰£é’±ï¼šUPDATE account SET balance = balance - 100 WHERE id = 1
- ç»™Bè´¦æˆ·åŠ é’±ï¼šUPDATE account SET balance = balance + 100 WHERE id = 2
- è®°å½•è½¬è´¦æ—¥å¿—ï¼šINSERT INTO transfer_log (from_id, to_id, amount) VALUES (1, 2, 100)

é—®é¢˜ï¼šå¦‚æœç¬¬äºŒæ­¥å¤±è´¥äº†æ€ä¹ˆåŠï¼ŸAçš„é’±æ‰£äº†ï¼ŒBæ²¡æ”¶åˆ°ï¼
è§£å†³ï¼šç”¨äº‹åŠ¡æ¨¡å¼ç¡®ä¿ä¸‰ä¸ªæ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å›æ»š
```

---

## 2. ğŸ“ äº‹åŠ¡è„šæœ¬æ¨¡å¼


### 2.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šæŠŠæ‰€æœ‰ç›¸å…³çš„æ•°æ®åº“æ“ä½œå†™åœ¨ä¸€ä¸ªæ–¹æ³•é‡Œï¼Œå°±åƒå†™å‰§æœ¬ä¸€æ ·æŒ‰é¡ºåºæ‰§è¡Œã€‚

**ğŸ”¸ ç‰¹ç‚¹**ï¼š
- **ç®€å•ç›´æ¥**ï¼šæ‰€æœ‰SQLéƒ½å†™åœ¨ä¸€ä¸ªåœ°æ–¹
- **è¿‡ç¨‹å¼**ï¼šæŒ‰æ­¥éª¤ä¸€æ­¥æ­¥æ‰§è¡Œ
- **å®¹æ˜“ç†è§£**ï¼šæ–°æ‰‹æœ€å®¹æ˜“æŒæ¡çš„æ–¹å¼

### 2.2 å®ç°ç¤ºä¾‹


```java
// äº‹åŠ¡è„šæœ¬æ¨¡å¼ - ç”¨æˆ·ä¸‹è®¢å•
public class OrderTransactionScript {
    
    public void createOrder(int userId, List<OrderItem> items) {
        Connection conn = null;
        try {
            conn = dataSource.getConnection();
            conn.setAutoCommit(false); // å¼€å§‹äº‹åŠ¡
            
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            int orderId = insertOrder(conn, userId);
            
            // æ­¥éª¤2ï¼šæ·»åŠ è®¢å•é¡¹
            for (OrderItem item : items) {
                insertOrderItem(conn, orderId, item);
                updateProductStock(conn, item.getProductId(), item.getQuantity());
            }
            
            // æ­¥éª¤3ï¼šè®¡ç®—æ€»ä»·å¹¶æ›´æ–°
            BigDecimal totalAmount = calculateTotal(conn, orderId);
            updateOrderAmount(conn, orderId, totalAmount);
            
            conn.commit(); // æäº¤äº‹åŠ¡
            
        } catch (Exception e) {
            if (conn != null) conn.rollback(); // å›æ»šäº‹åŠ¡
            throw new RuntimeException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        } finally {
            if (conn != null) conn.close();
        }
    }
}
```

### 2.3 é€‚ç”¨åœºæ™¯


**âœ… é€‚åˆä½¿ç”¨çš„æƒ…å†µ**ï¼š
- **ç®€å•ä¸šåŠ¡**ï¼šé€»è¾‘ä¸å¤æ‚ï¼Œæ­¥éª¤æ¸…æ™°
- **å¿«é€Ÿå¼€å‘**ï¼šéœ€è¦å¿«é€Ÿå®ç°åŠŸèƒ½
- **å›¢é˜Ÿæ–°æ‰‹å¤š**ï¼šå®¹æ˜“ç†è§£å’Œç»´æŠ¤

**âŒ ä¸é€‚åˆçš„æƒ…å†µ**ï¼š
- **å¤æ‚ä¸šåŠ¡**ï¼šæ¶‰åŠå¤šä¸ªä¸šåŠ¡å¯¹è±¡çš„å¤æ‚æ“ä½œ
- **é¢‘ç¹å˜åŒ–**ï¼šä¸šåŠ¡è§„åˆ™ç»å¸¸æ”¹å˜
- **å¤§å‹é¡¹ç›®**ï¼šä»£ç ä¼šå˜å¾—å¾ˆéš¾ç»´æŠ¤

---

## 3. ğŸ—ï¸ é¢†åŸŸæ¨¡å‹äº‹åŠ¡


### 3.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šæŠŠä¸šåŠ¡æ“ä½œå°è£…åˆ°å¯¹è±¡é‡Œï¼Œæ¯ä¸ªå¯¹è±¡è´Ÿè´£è‡ªå·±çš„äº‹åŠ¡ç®¡ç†ï¼Œå°±åƒæ¯ä¸ªéƒ¨é—¨ç®¡ç†è‡ªå·±çš„äº‹æƒ…ä¸€æ ·ã€‚

**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**ï¼š
- **ä¸šåŠ¡å¯¹è±¡**ï¼šæ¯ä¸ªä¸šåŠ¡æ¦‚å¿µéƒ½æœ‰å¯¹åº”çš„ç±»
- **å°è£…è¡Œä¸º**ï¼šä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ“ä½œéƒ½åœ¨å¯¹è±¡å†…éƒ¨
- **èŒè´£æ˜ç¡®**ï¼šæ¯ä¸ªå¯¹è±¡åªç®¡è‡ªå·±ç›¸å…³çš„äº‹åŠ¡

### 3.2 å®ç°ç¤ºä¾‹


```java
// é¢†åŸŸæ¨¡å‹ - è®¢å•ç±»
@Entity
@Transactional
public class Order {
    private Long id;
    private Long userId;
    private List<OrderItem> items;
    private OrderStatus status;
    private BigDecimal totalAmount;
    
    // ä¸šåŠ¡æ–¹æ³• - æ·»åŠ å•†å“åˆ°è®¢å•
    public void addItem(Product product, int quantity) {
        // æ£€æŸ¥åº“å­˜
        if (!product.hasStock(quantity)) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // æ·»åŠ è®¢å•é¡¹
        OrderItem item = new OrderItem(product, quantity);
        this.items.add(item);
        
        // å‡å°‘åº“å­˜
        product.reduceStock(quantity);
        
        // é‡æ–°è®¡ç®—æ€»ä»·
        this.recalculateTotal();
    }
    
    // ä¸šåŠ¡æ–¹æ³• - ç¡®è®¤è®¢å•
    public void confirm() {
        if (this.status != OrderStatus.PENDING) {
            throw new InvalidOrderStatusException("è®¢å•çŠ¶æ€é”™è¯¯");
        }
        
        this.status = OrderStatus.CONFIRMED;
        this.confirmTime = LocalDateTime.now();
        
        // è§¦å‘åº“å­˜é¢„ç•™
        for (OrderItem item : items) {
            item.getProduct().reserveStock(item.getQuantity());
        }
    }
}
```

### 3.3 ä¼˜ç¼ºç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**ï¼š
- **ä¸šåŠ¡æ¸…æ™°**ï¼šä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨é¢†åŸŸå¯¹è±¡ä¸­
- **å¤ç”¨æ€§å¥½**ï¼šä¸šåŠ¡æ–¹æ³•å¯ä»¥åœ¨å¤šå¤„è°ƒç”¨
- **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•ä¸šåŠ¡é€»è¾‘

**âŒ ç¼ºç‚¹**ï¼š
- **å­¦ä¹ æˆæœ¬**ï¼šéœ€è¦ç†è§£é¢†åŸŸé©±åŠ¨è®¾è®¡æ¦‚å¿µ
- **æ€§èƒ½å¼€é”€**ï¼šå¯¹è±¡åˆ›å»ºå’Œæ–¹æ³•è°ƒç”¨çš„å¼€é”€
- **å¤æ‚æ€§**ï¼šå¯¹äºç®€å•ä¸šåŠ¡å¯èƒ½è¿‡åº¦è®¾è®¡

---

## 4. ğŸ”„ æ•°æ®æ˜ å°„å™¨äº‹åŠ¡


### 4.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šæŠŠæ•°æ®åº“æ“ä½œå’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œæ•°æ®æ˜ å°„å™¨ä¸“é—¨è´Ÿè´£æ•°æ®çš„å­˜å–ï¼Œå°±åƒä¸“é—¨çš„æ¬è¿å·¥ä¸€æ ·ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **èŒè´£åˆ†ç¦»**ï¼šä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®å®Œå…¨åˆ†å¼€
- **æ˜ å°„ç®¡ç†**ï¼šä¸“é—¨çš„ç±»è´Ÿè´£å¯¹è±¡å’Œæ•°æ®åº“ä¹‹é—´çš„è½¬æ¢
- **äº‹åŠ¡åè°ƒ**ï¼šé€šè¿‡æ˜ å°„å™¨ç»Ÿä¸€ç®¡ç†äº‹åŠ¡

### 4.2 å®ç°ç¤ºä¾‹


```java
// æ•°æ®æ˜ å°„å™¨
public class OrderMapper {
    
    @Transactional
    public void saveOrder(Order order) {
        // ä¿å­˜è®¢å•ä¸»è®°å½•
        if (order.getId() == null) {
            insertOrder(order);
        } else {
            updateOrder(order);
        }
        
        // ä¿å­˜è®¢å•é¡¹
        for (OrderItem item : order.getItems()) {
            if (item.isNew()) {
                insertOrderItem(item);
            } else if (item.isModified()) {
                updateOrderItem(item);
            }
        }
        
        // æ›´æ–°ç›¸å…³äº§å“åº“å­˜
        updateProductStocks(order.getItems());
    }
    
    public Order findById(Long orderId) {
        // æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯
        Order order = selectOrderById(orderId);
        
        // æŸ¥è¯¢è®¢å•é¡¹
        List<OrderItem> items = selectOrderItems(orderId);
        order.setItems(items);
        
        return order;
    }
}

// ä¸šåŠ¡æœåŠ¡
public class OrderService {
    private OrderMapper orderMapper;
    
    public void processOrder(Long orderId, List<OrderItemDto> newItems) {
        // åŠ è½½è®¢å•
        Order order = orderMapper.findById(orderId);
        
        // ä¸šåŠ¡å¤„ç†
        for (OrderItemDto itemDto : newItems) {
            Product product = productService.findById(itemDto.getProductId());
            order.addItem(product, itemDto.getQuantity());
        }
        
        // ä¿å­˜æ›´æ”¹
        orderMapper.saveOrder(order);
    }
}
```

### 4.3 é€‚ç”¨åœºæ™¯


**âœ… é€‚åˆçš„é¡¹ç›®**ï¼š
- **å¤§å‹ç³»ç»Ÿ**ï¼šéœ€è¦æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- **å¤æ‚æ˜ å°„**ï¼šå¯¹è±¡å’Œæ•°æ®åº“ç»“æ„å·®å¼‚è¾ƒå¤§
- **å›¢é˜Ÿåä½œ**ï¼šä¸åŒäººè´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®

---

## 5. ğŸ”§ Unit of Workæ¨¡å¼


### 5.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šUnit of Workå°±åƒä¸€ä¸ª"å·¥ä½œè®°å½•æœ¬"ï¼Œè®°å½•ä½ è¦å¯¹æ•°æ®åº“åšçš„æ‰€æœ‰æ”¹åŠ¨ï¼Œæœ€åä¸€æ¬¡æ€§æäº¤ï¼Œå°±åƒè´­ç‰©è½¦ä¸€æ ·ã€‚

**ğŸ”¸ æ ¸å¿ƒæœºåˆ¶**ï¼š
```
å·¥ä½œæµç¨‹ï¼š
1. æ³¨å†Œå˜æ›´ï¼šè®°å½•è¦æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤çš„å¯¹è±¡
2. è¿½è¸ªçŠ¶æ€ï¼šè·Ÿè¸ªæ¯ä¸ªå¯¹è±¡çš„çŠ¶æ€å˜åŒ–
3. æ‰¹é‡æäº¤ï¼šäº‹åŠ¡ç»“æŸæ—¶ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰SQL
4. å†²çªæ£€æµ‹ï¼šæ£€æŸ¥å¹¶å‘ä¿®æ”¹å†²çª
```

### 5.2 å®ç°ç¤ºä¾‹


```java
// Unit of Work å®ç°
public class UnitOfWork {
    private List<Object> newObjects = new ArrayList<>();
    private List<Object> changedObjects = new ArrayList<>();
    private List<Object> removedObjects = new ArrayList<>();
    private Map<Object, Object> identityMap = new HashMap<>();
    
    // æ³¨å†Œæ–°å¯¹è±¡
    public void registerNew(Object obj) {
        if (!newObjects.contains(obj)) {
            newObjects.add(obj);
        }
    }
    
    // æ³¨å†Œä¿®æ”¹å¯¹è±¡
    public void registerDirty(Object obj) {
        if (!changedObjects.contains(obj) && !newObjects.contains(obj)) {
            changedObjects.add(obj);
        }
    }
    
    // æ³¨å†Œåˆ é™¤å¯¹è±¡
    public void registerRemoved(Object obj) {
        if (newObjects.contains(obj)) {
            newObjects.remove(obj);
            return;
        }
        if (!removedObjects.contains(obj)) {
            removedObjects.remove(obj);
        }
    }
    
    // æäº¤æ‰€æœ‰å˜æ›´
    @Transactional
    public void commit() {
        try {
            // å…ˆæ’å…¥æ–°å¯¹è±¡
            for (Object obj : newObjects) {
                insertObject(obj);
            }
            
            // å†æ›´æ–°ä¿®æ”¹çš„å¯¹è±¡
            for (Object obj : changedObjects) {
                updateObject(obj);
            }
            
            // æœ€ååˆ é™¤å¯¹è±¡
            for (Object obj : removedObjects) {
                deleteObject(obj);
            }
            
        } finally {
            // æ¸…ç†å·¥ä½œå•å…ƒ
            clearAll();
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class OrderService {
    private UnitOfWork unitOfWork;
    
    public void processMultipleOrders() {
        try {
            // å¤„ç†å¤šä¸ªè®¢å•
            Order order1 = new Order();
            order1.addItem(product1, 2);
            unitOfWork.registerNew(order1);
            
            Order order2 = orderRepository.findById(123L);
            order2.updateStatus(OrderStatus.CONFIRMED);
            unitOfWork.registerDirty(order2);
            
            Order order3 = orderRepository.findById(124L);
            unitOfWork.registerRemoved(order3);
            
            // ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰å˜æ›´
            unitOfWork.commit();
            
        } catch (Exception e) {
            // è‡ªåŠ¨å›æ»š
            throw e;
        }
    }
}
```

### 5.3 ä¼˜åŠ¿åˆ†æ


**ğŸ”¸ æ€§èƒ½ä¼˜åŠ¿**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼š
ä¿å­˜è®¢å•1 â†’ æ•°æ®åº“äº¤äº’1æ¬¡
ä¿å­˜è®¢å•2 â†’ æ•°æ®åº“äº¤äº’1æ¬¡  
ä¿å­˜è®¢å•3 â†’ æ•°æ®åº“äº¤äº’1æ¬¡
æ€»è®¡ï¼š3æ¬¡æ•°æ®åº“äº¤äº’

Unit of Workæ–¹å¼ï¼š
æ‰¹é‡ä¿å­˜ â†’ æ•°æ®åº“äº¤äº’1æ¬¡
æ€»è®¡ï¼š1æ¬¡æ•°æ®åº“äº¤äº’ï¼Œæ€§èƒ½æå‡3å€
```

**ğŸ”¸ ä¸€è‡´æ€§ä¿éšœ**ï¼š
- **åŸå­æ€§**ï¼šæ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- **é¡ºåºä¿è¯**ï¼šæŒ‰æ­£ç¡®é¡ºåºæ‰§è¡ŒINSERTã€UPDATEã€DELETE
- **å†²çªæ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶å‘ä¿®æ”¹å†²çª

---

## 6. ğŸ­ äº‹åŠ¡è¾¹ç•Œæ¨¡å¼


### 6.1 åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼šäº‹åŠ¡è¾¹ç•Œå°±æ˜¯åˆ’å®š"è¿™äº›æ“ä½œå¿…é¡»ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥"çš„èŒƒå›´ï¼Œå°±åƒç”»ä¸€ä¸ªåœˆï¼Œåœˆå†…çš„äº‹æƒ…è¦ä¹ˆå…¨åšå®Œï¼Œè¦ä¹ˆå…¨ä¸åšã€‚

**ğŸ”¸ å¸¸è§è¾¹ç•Œç­–ç•¥**ï¼š
```
æ–¹æ³•çº§è¾¹ç•Œï¼š     ä¸€ä¸ªæ–¹æ³• = ä¸€ä¸ªäº‹åŠ¡
ç±»çº§è¾¹ç•Œï¼š       ä¸€ä¸ªä¸šåŠ¡æ“ä½œ = ä¸€ä¸ªäº‹åŠ¡  
è¯·æ±‚çº§è¾¹ç•Œï¼š     ä¸€ä¸ªHTTPè¯·æ±‚ = ä¸€ä¸ªäº‹åŠ¡
ä¼šè¯çº§è¾¹ç•Œï¼š     ä¸€ä¸ªç”¨æˆ·ä¼šè¯ = ä¸€ä¸ªäº‹åŠ¡
```

### 6.2 æ–¹æ³•çº§äº‹åŠ¡è¾¹ç•Œ


```java
// æ–¹æ³•çº§äº‹åŠ¡ - æœ€å¸¸è§çš„æ–¹å¼
@Service
public class OrderService {
    
    @Transactional // æ–¹æ³•çº§äº‹åŠ¡è¾¹ç•Œ
    public void createOrder(OrderRequest request) {
        // æ•´ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡
        Order order = new Order(request.getUserId());
        
        for (OrderItemRequest item : request.getItems()) {
            Product product = productService.findById(item.getProductId());
            order.addItem(product, item.getQuantity());
        }
        
        orderRepository.save(order);
        emailService.sendOrderConfirmation(order); // å¦‚æœå‘é‚®ä»¶å¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»š
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void processPayment(Long orderId) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–éƒ¨äº‹åŠ¡å½±å“
        Order order = orderRepository.findById(orderId);
        PaymentResult result = paymentGateway.charge(order.getTotalAmount());
        
        if (result.isSuccess()) {
            order.markAsPaid();
            orderRepository.save(order);
        }
    }
}
```

### 6.3 è¯·æ±‚çº§äº‹åŠ¡è¾¹ç•Œ


```java
// è¯·æ±‚çº§äº‹åŠ¡ - é€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹
@RestController
public class OrderController {
    
    @PostMapping("/orders/batch")
    @Transactional // æ•´ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªå¤§äº‹åŠ¡
    public ResponseEntity<String> processBatchOrders(@RequestBody List<OrderRequest> requests) {
        
        List<Order> createdOrders = new ArrayList<>();
        
        // å¤„ç†å¤šä¸ªè®¢å•
        for (OrderRequest request : requests) {
            Order order = orderService.createOrderInternal(request); // å†…éƒ¨æ–¹æ³•ï¼Œä¸å¼€æ–°äº‹åŠ¡
            createdOrders.add(order);
        }
        
        // æ‰¹é‡ä¼˜åŒ–å¤„ç†
        inventoryService.batchUpdateStock(createdOrders); 
        emailService.batchSendConfirmations(createdOrders);
        
        return ResponseEntity.ok("æ‰¹é‡è®¢å•å¤„ç†æˆåŠŸ");
    }
}
```

### 6.4 äº‹åŠ¡ä¼ æ’­è¡Œä¸º


**ğŸ”¸ å¸¸ç”¨ä¼ æ’­è¡Œä¸ºå¯¹æ¯”**ï¼š

| ä¼ æ’­è¡Œä¸º | **è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|---------|----------|-------------|
| `REQUIRED` | `å¦‚æœæœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º` | `æœ€å¸¸ç”¨çš„é»˜è®¤è¡Œä¸º` |
| `REQUIRES_NEW` | `æ€»æ˜¯åˆ›å»ºæ–°äº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡` | `ç‹¬ç«‹æ“ä½œï¼Œå¦‚æ—¥å¿—è®°å½•` |
| `NESTED` | `åµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥ç‹¬ç«‹å›æ»š` | `éƒ¨åˆ†å¤±è´¥ä¸å½±å“ä¸»æµç¨‹` |
| `NOT_SUPPORTED` | `æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Œä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œ` | `æŸ¥è¯¢æ“ä½œï¼Œä¸éœ€è¦äº‹åŠ¡` |

---

## 7. ğŸ¯ æ¨¡å¼é€‰æ‹©ç­–ç•¥


### 7.1 é€‰æ‹©å†³ç­–æ ‘


```
é¡¹ç›®ç‰¹ç‚¹åˆ†æï¼š

ä¸šåŠ¡å¤æ‚åº¦ï¼š
â”œâ”€ ç®€å•ä¸šåŠ¡ï¼ˆCRUDæ“ä½œï¼‰
â”‚  â””â”€ é€‰æ‹©ï¼šäº‹åŠ¡è„šæœ¬æ¨¡å¼
â”œâ”€ ä¸­ç­‰å¤æ‚åº¦ï¼ˆæ¶‰åŠå¤šä¸ªå¯¹è±¡ï¼‰  
â”‚  â””â”€ é€‰æ‹©ï¼šé¢†åŸŸæ¨¡å‹äº‹åŠ¡
â””â”€ é«˜å¤æ‚åº¦ï¼ˆå¤æ‚ä¸šåŠ¡æµç¨‹ï¼‰
   â””â”€ é€‰æ‹©ï¼šUnit of Work + æ•°æ®æ˜ å°„å™¨

å›¢é˜ŸæŠ€èƒ½ï¼š
â”œâ”€ æ–°æ‰‹å›¢é˜Ÿ â†’ äº‹åŠ¡è„šæœ¬æ¨¡å¼
â”œâ”€ æœ‰ç»éªŒå›¢é˜Ÿ â†’ é¢†åŸŸæ¨¡å‹äº‹åŠ¡
â””â”€ èµ„æ·±å›¢é˜Ÿ â†’ Unit of Workæ¨¡å¼

æ€§èƒ½è¦æ±‚ï¼š
â”œâ”€ ä¸€èˆ¬æ€§èƒ½è¦æ±‚ â†’ äº‹åŠ¡è„šæœ¬/é¢†åŸŸæ¨¡å‹
â””â”€ é«˜æ€§èƒ½è¦æ±‚ â†’ Unit of Work + æ‰¹é‡æ“ä½œ
```

### 7.2 æ¨¡å¼ç»„åˆä½¿ç”¨


**ğŸ”¸ å®é™…é¡¹ç›®ä¸­çš„ç»„åˆç­–ç•¥**ï¼š

```java
// ç»„åˆä½¿ç”¨ç¤ºä¾‹ - ç”µå•†ç³»ç»Ÿ
public class ECommerceTransactionManager {
    
    // ç®€å•æ“ä½œç”¨äº‹åŠ¡è„šæœ¬
    @Transactional
    public void updateUserProfile(Long userId, UserProfile profile) {
        userRepository.updateProfile(userId, profile);
    }
    
    // å¤æ‚ä¸šåŠ¡ç”¨é¢†åŸŸæ¨¡å‹
    @Transactional  
    public void processOrder(OrderCommand command) {
        Order order = Order.createNew(command.getUserId());
        
        for (OrderItemCommand item : command.getItems()) {
            Product product = productRepository.findById(item.getProductId());
            order.addItem(product, item.getQuantity()); // é¢†åŸŸå¯¹è±¡å¤„ç†ä¸šåŠ¡é€»è¾‘
        }
        
        orderRepository.save(order); // æ•°æ®æ˜ å°„å™¨ä¿å­˜
    }
    
    // æ‰¹é‡æ“ä½œç”¨Unit of Work
    @Transactional
    public void batchProcessReturns(List<ReturnRequest> returns) {
        UnitOfWork uow = new UnitOfWork();
        
        for (ReturnRequest returnRequest : returns) {
            Order order = orderRepository.findById(returnRequest.getOrderId());
            order.processReturn(returnRequest);
            uow.registerDirty(order);
        }
        
        uow.commit(); // æ‰¹é‡æäº¤
    }
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ”¸ é€šç”¨ä¼˜åŒ–åŸåˆ™**ï¼š

```
è¿æ¥æ± ä¼˜åŒ–ï¼š
- åˆç†è®¾ç½®è¿æ¥æ± å¤§å°
- ç›‘æ§è¿æ¥ä½¿ç”¨æƒ…å†µ
- é¿å…è¿æ¥æ³„æ¼

æ‰¹é‡æ“ä½œï¼š
- ä½¿ç”¨æ‰¹é‡INSERT/UPDATE
- å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
- åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°

äº‹åŠ¡èŒƒå›´ï¼š
- ä¿æŒäº‹åŠ¡å°½å¯èƒ½çŸ­
- é¿å…åœ¨äº‹åŠ¡ä¸­è°ƒç”¨å¤–éƒ¨æœåŠ¡
- åˆç†ä½¿ç”¨åªè¯»äº‹åŠ¡

ç¼“å­˜ç­–ç•¥ï¼š
- ä¸€çº§ç¼“å­˜ï¼šä¼šè¯çº§ç¼“å­˜
- äºŒçº§ç¼“å­˜ï¼šåº”ç”¨çº§ç¼“å­˜  
- æŸ¥è¯¢ç¼“å­˜ï¼šç»“æœé›†ç¼“å­˜
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡è„šæœ¬æ¨¡å¼ï¼šç®€å•ç›´æ¥ï¼Œé€‚åˆæ–°æ‰‹å’Œç®€å•ä¸šåŠ¡
ğŸ”¸ é¢†åŸŸæ¨¡å‹äº‹åŠ¡ï¼šä¸šåŠ¡é€»è¾‘å°è£…ï¼Œé€‚åˆä¸­ç­‰å¤æ‚åº¦é¡¹ç›®
ğŸ”¸ æ•°æ®æ˜ å°„å™¨äº‹åŠ¡ï¼šèŒè´£åˆ†ç¦»ï¼Œé€‚åˆå¤§å‹ç³»ç»Ÿ
ğŸ”¸ Unit of Workæ¨¡å¼ï¼šæ‰¹é‡å¤„ç†ï¼Œé€‚åˆé«˜æ€§èƒ½è¦æ±‚
ğŸ”¸ äº‹åŠ¡è¾¹ç•Œæ¨¡å¼ï¼šå®šä¹‰äº‹åŠ¡èŒƒå›´ï¼Œæ§åˆ¶ä¸€è‡´æ€§è¾¹ç•Œ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¨¡å¼é€‰æ‹©çš„æ ¸å¿ƒå› ç´ **ï¼š
```
ä¸šåŠ¡å¤æ‚åº¦ â†’ å†³å®šæ˜¯å¦éœ€è¦å¤æ‚æ¨¡å¼
å›¢é˜ŸæŠ€èƒ½ â†’ å†³å®šèƒ½å¦é©¾é©­å¤æ‚æ¨¡å¼  
æ€§èƒ½è¦æ±‚ â†’ å†³å®šæ˜¯å¦éœ€è¦ä¼˜åŒ–æ¨¡å¼
é¡¹ç›®è§„æ¨¡ â†’ å†³å®šç»´æŠ¤æˆæœ¬æ˜¯å¦å€¼å¾—
```

**ğŸ”¹ äº‹åŠ¡ç®¡ç†çš„æ ¸å¿ƒåŸåˆ™**ï¼š
```
ACIDåŸåˆ™ï¼š
- Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šæ•°æ®ä¿æŒä¸šåŠ¡è§„åˆ™çš„å®Œæ•´æ€§
- Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¹¶å‘äº‹åŠ¡ç›¸äº’ä¸å½±å“
- Durabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šæäº¤çš„æ•°æ®æ°¸ä¹…ä¿å­˜
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç‚¹**ï¼š
```
å‡å°‘æ•°æ®åº“äº¤äº’ï¼š
- æ‰¹é‡æ“ä½œä»£æ›¿é€æ¡æ“ä½œ
- åˆç†ä½¿ç”¨ç¼“å­˜
- ä¼˜åŒ–SQLæŸ¥è¯¢

æ§åˆ¶äº‹åŠ¡èŒƒå›´ï¼š
- äº‹åŠ¡å°½å¯èƒ½çŸ­
- é¿å…é•¿æ—¶é—´æŒæœ‰é”
- åˆç†è®¾ç½®éš”ç¦»çº§åˆ«
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ä¸šåŠ¡æ•°æ®çš„å®Œæ•´æ€§
- **å¹¶å‘å®‰å…¨**ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œä¸ä¼šå‡ºç°æ•°æ®é”™è¯¯  
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæé«˜å“åº”é€Ÿåº¦
- **ä»£ç ç»´æŠ¤**ï¼šè®©äº‹åŠ¡ç›¸å…³ä»£ç æ›´æ¸…æ™°ã€æ›´å¥½ç»´æŠ¤

**ğŸ”§ åœ¨é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•å¤„ç†ã€åº“å­˜ç®¡ç†ã€æ”¯ä»˜æµç¨‹
- **é‡‘èç³»ç»Ÿ**ï¼šè½¬è´¦æ“ä½œã€è´¦æˆ·ç®¡ç†ã€é£æ§å¤„ç†
- **å†…å®¹ç®¡ç†**ï¼šæ–‡ç« å‘å¸ƒã€ç”¨æˆ·æƒé™ã€æ•°æ®åŒæ­¥
- **ä¼ä¸šåº”ç”¨**ï¼šå·¥ä½œæµç¨‹ã€å®¡æ‰¹ç³»ç»Ÿã€æ•°æ®é›†æˆ

**ğŸ’¡ å­¦ä¹ å»ºè®®**ï¼š
1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡äº‹åŠ¡è„šæœ¬æ¨¡å¼
2. **ç†è§£ä¸šåŠ¡**ï¼šæ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚æ¨¡å¼
3. **å®è·µéªŒè¯**ï¼šé€šè¿‡é¡¹ç›®å®è·µåŠ æ·±ç†è§£
4. **æ€§èƒ½æµ‹è¯•**ï¼šåœ¨å®é™…ç¯å¢ƒä¸­éªŒè¯æ€§èƒ½æ•ˆæœ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç®€å•ä¸šåŠ¡ç”¨è„šæœ¬ï¼Œå¤æ‚ä¸šåŠ¡ç”¨é¢†åŸŸ
- å¤§å‹é¡¹ç›®åˆ†å±‚æ¬¡ï¼Œé«˜æ€§èƒ½ç”¨æ‰¹é‡
- äº‹åŠ¡è¾¹ç•Œè¦æ˜ç¡®ï¼ŒACIDåŸåˆ™è®°å¿ƒä¸­