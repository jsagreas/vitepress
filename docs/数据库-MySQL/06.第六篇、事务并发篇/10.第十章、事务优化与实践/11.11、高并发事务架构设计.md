---
title: 11ã€é«˜å¹¶å‘äº‹åŠ¡æ¶æ„è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„](#1-åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„)
2. [å¾®æœåŠ¡äº‹åŠ¡å¤„ç†](#2-å¾®æœåŠ¡äº‹åŠ¡å¤„ç†)
3. [è¯»å†™åˆ†ç¦»æ¶æ„](#3-è¯»å†™åˆ†ç¦»æ¶æ„)
4. [åˆ†åº“åˆ†è¡¨äº‹åŠ¡](#4-åˆ†åº“åˆ†è¡¨äº‹åŠ¡)
5. [ç¼“å­˜äº‹åŠ¡ä¸€è‡´æ€§](#5-ç¼“å­˜äº‹åŠ¡ä¸€è‡´æ€§)
6. [æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡](#6-æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡)
7. [æ¶æ„æ¼”è¿›ç­–ç•¥](#7-æ¶æ„æ¼”è¿›ç­–ç•¥)
8. [é«˜å¹¶å‘æ¶æ„å®Œæ•´è®¾è®¡](#8-é«˜å¹¶å‘æ¶æ„å®Œæ•´è®¾è®¡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡æ¶æ„


### 1.1 åˆ†å¸ƒå¼äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**
å½“ä¸€ä¸ªä¸šåŠ¡æ“ä½œéœ€è¦è·¨è¶Šå¤šä¸ªæ•°æ®åº“æˆ–å¤šä¸ªæœåŠ¡æ—¶ï¼Œå°±éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

```
ä¼ ç»Ÿå•æœºäº‹åŠ¡ï¼š
ç”¨æˆ·ä¸‹å• â†’ æ‰£å‡åº“å­˜ â†’ æ‰£å‡ä½™é¢ â†’ ç”Ÿæˆè®¢å•
ï¼ˆæ‰€æœ‰æ“ä½œåœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ï¼‰

åˆ†å¸ƒå¼äº‹åŠ¡ï¼š
ç”¨æˆ·ä¸‹å• â†’ åº“å­˜æœåŠ¡ï¼ˆæ•°æ®åº“Aï¼‰â†’ è´¦æˆ·æœåŠ¡ï¼ˆæ•°æ®åº“Bï¼‰â†’ è®¢å•æœåŠ¡ï¼ˆæ•°æ®åº“Cï¼‰
ï¼ˆæ“ä½œè·¨è¶Šå¤šä¸ªæ•°æ®åº“ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰ç›¸å…³æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šé¿å…å‡ºç°"æ‰£äº†é’±ä½†æ²¡å‡åº“å­˜"è¿™æ ·çš„ä¸ä¸€è‡´çŠ¶æ€

### 1.2 åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰**
```
ä¸¤é˜¶æ®µæäº¤æµç¨‹ï¼š

é˜¶æ®µ1 - å‡†å¤‡é˜¶æ®µï¼š
åè°ƒè€… â†’ å„å‚ä¸è€…ï¼šè¯·é—®ä½ ä»¬èƒ½æäº¤äº‹åŠ¡å—ï¼Ÿ
å‚ä¸è€… â†’ åè°ƒè€…ï¼šå¯ä»¥æäº¤ / æ— æ³•æäº¤

é˜¶æ®µ2 - æäº¤é˜¶æ®µï¼š
if (æ‰€æœ‰å‚ä¸è€…éƒ½è¯´å¯ä»¥) {
    åè°ƒè€… â†’ å„å‚ä¸è€…ï¼šæ­£å¼æäº¤äº‹åŠ¡
} else {
    åè°ƒè€… â†’ å„å‚ä¸è€…ï¼šå›æ»šäº‹åŠ¡
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¼ºä¸€è‡´æ€§ä¿è¯
- âœ… åŸç†ç®€å•æ˜“ç†è§£

**ç¼ºç‚¹**ï¼š
- âŒ æ€§èƒ½è¾ƒå·®ï¼ˆä¸¤æ¬¡ç½‘ç»œé€šä¿¡ï¼‰
- âŒ å­˜åœ¨å•ç‚¹æ•…éšœï¼ˆåè°ƒè€…æŒ‚æ‰ï¼‰
- âŒ é˜»å¡é—®é¢˜ï¼ˆå‚ä¸è€…ç­‰å¾…åè°ƒè€…ï¼‰

**ğŸ”¸ TCCæ¨¡å¼ï¼ˆTry-Confirm-Cancelï¼‰**
```sql
-- TCCä¸‰ä¸ªé˜¶æ®µç¤ºä¾‹ï¼šè½¬è´¦ä¸šåŠ¡
-- Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
UPDATE account SET frozen_amount = frozen_amount + 100 WHERE user_id = 'A';
UPDATE account SET frozen_amount = frozen_amount + 100 WHERE user_id = 'B';

-- Confirmé˜¶æ®µï¼šç¡®è®¤æ“ä½œ
UPDATE account SET balance = balance - 100, frozen_amount = frozen_amount - 100 WHERE user_id = 'A';
UPDATE account SET balance = balance + 100, frozen_amount = frozen_amount - 100 WHERE user_id = 'B';

-- Cancelé˜¶æ®µï¼šå–æ¶ˆæ“ä½œ
UPDATE account SET frozen_amount = frozen_amount - 100 WHERE user_id = 'A';
UPDATE account SET frozen_amount = frozen_amount - 100 WHERE user_id = 'B';
```

**TCCç‰¹ç‚¹**ï¼š
- ğŸ’¡ **ä¸šåŠ¡ä¾µå…¥æ€§**ï¼šéœ€è¦ä¸šåŠ¡æ–¹å®ç°ä¸‰ä¸ªæ¥å£
- âš¡ **æ€§èƒ½è¾ƒå¥½**ï¼šæ— é•¿æ—¶é—´é”å®šèµ„æº
- ğŸ”§ **å®ç°å¤æ‚**ï¼šéœ€è¦è€ƒè™‘å„ç§å¼‚å¸¸æƒ…å†µ

### 1.3 Sagaæ¨¡å¼


**ä»€ä¹ˆæ˜¯Sagaï¼Ÿ**
å°†åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

```
æ­£å‘æµç¨‹ï¼š
è®¢å•æœåŠ¡.åˆ›å»ºè®¢å• â†’ åº“å­˜æœåŠ¡.æ‰£å‡åº“å­˜ â†’ æ”¯ä»˜æœåŠ¡.æ‰£æ¬¾

å¤±è´¥æ—¶è¡¥å¿æµç¨‹ï¼š
æ”¯ä»˜æœåŠ¡.é€€æ¬¾ â†’ åº“å­˜æœåŠ¡.æ¢å¤åº“å­˜ â†’ è®¢å•æœåŠ¡.å–æ¶ˆè®¢å•
```

**Sagaå®ç°æ–¹å¼**ï¼š

**ç¼–æ’æ¨¡å¼ï¼ˆOrchestrationï¼‰**ï¼š
```java
// ä¸­å¤®åè°ƒå™¨æ§åˆ¶æ•´ä¸ªæµç¨‹
public class OrderSagaOrchestrator {
    public void processOrder(Order order) {
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            orderService.createOrder(order);
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            inventoryService.reduceStock(order.getProductId(), order.getQuantity());
            // æ­¥éª¤3ï¼šå¤„ç†æ”¯ä»˜
            paymentService.processPayment(order.getAmount());
        } catch (Exception e) {
            // æ‰§è¡Œè¡¥å¿æ“ä½œ
            compensate(order);
        }
    }
}
```

**ç¼–èˆæ¨¡å¼ï¼ˆChoreographyï¼‰**ï¼š
```java
// æ¯ä¸ªæœåŠ¡çŸ¥é“ä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆ
@EventListener
public void handleOrderCreated(OrderCreatedEvent event) {
    try {
        inventoryService.reduceStock(event.getProductId(), event.getQuantity());
        // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
        eventPublisher.publish(new StockReducedEvent(event.getOrderId()));
    } catch (Exception e) {
        // å‘å¸ƒåº“å­˜æ‰£å‡å¤±è´¥äº‹ä»¶
        eventPublisher.publish(new StockReduceFailedEvent(event.getOrderId()));
    }
}
```

---

## 2. ğŸ—ï¸ å¾®æœåŠ¡äº‹åŠ¡å¤„ç†


### 2.1 å¾®æœåŠ¡äº‹åŠ¡æŒ‘æˆ˜


**å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„äº‹åŠ¡é—®é¢˜**ï¼š
```
å•ä½“åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          è®¢å•ç³»ç»Ÿ            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚è®¢å• â”‚ â”‚ åº“å­˜ â”‚ â”‚ æ”¯ä»˜ â”‚   â”‚  â† åŒä¸€ä¸ªæ•°æ®åº“ï¼Œæœ¬åœ°äº‹åŠ¡
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â”‚    â”‚ åº“å­˜æœåŠ¡ â”‚    â”‚ æ”¯ä»˜æœåŠ¡ â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚    â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚â”‚æ•°æ®åº“Aâ”‚â”‚    â”‚â”‚æ•°æ®åº“Bâ”‚â”‚    â”‚â”‚æ•°æ®åº“Câ”‚â”‚  â† è·¨æ•°æ®åº“ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»è¦æŒ‘æˆ˜**ï¼š
- ğŸ”¸ **æ•°æ®ä¸€è‡´æ€§**ï¼šå¦‚ä½•ä¿è¯è·¨æœåŠ¡æ“ä½œçš„åŸå­æ€§
- ğŸ”¸ **ç½‘ç»œå»¶è¿Ÿ**ï¼šæœåŠ¡é—´è°ƒç”¨çš„ä¸ç¡®å®šæ€§
- ğŸ”¸ **æœåŠ¡æ•…éšœ**ï¼šæŸä¸ªæœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤„ç†
- ğŸ”¸ **æ€§èƒ½å½±å“**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“

### 2.2 å¾®æœåŠ¡äº‹åŠ¡æ¨¡å¼


**ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼**
```java
// åŸºäºäº‹ä»¶çš„æœ€ç»ˆä¸€è‡´æ€§
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        eventPublisher.publish(new OrderCreatedEvent(order));
        
        // æ³¨æ„ï¼šæ­¤æ—¶åº“å­˜å’Œæ”¯ä»˜è¿˜æœªå¤„ç†ï¼Œæ•°æ®æš‚æ—¶ä¸ä¸€è‡´
        // ä½†æœ€ç»ˆä¼šé€šè¿‡äº‹ä»¶å¤„ç†è¾¾åˆ°ä¸€è‡´æ€§
    }
}

@EventListener
public class InventoryEventHandler {
    
    @Transactional
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            inventoryService.reduceStock(event.getProductId(), event.getQuantity());
            // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            eventPublisher.publish(new StockReducedEvent(event.getOrderId()));
        } catch (InsufficientStockException e) {
            // å‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶ï¼Œè§¦å‘è®¢å•å–æ¶ˆ
            eventPublisher.publish(new StockInsufficientEvent(event.getOrderId()));
        }
    }
}
```

**ğŸ”¸ è¡¥å¿æ¨¡å¼**
```java
// ä¸šåŠ¡æ“ä½œä¸è¡¥å¿æ“ä½œæˆå¯¹å‡ºç°
public class PaymentService {
    
    // æ­£å‘æ“ä½œï¼šæ‰£æ¬¾
    @Transactional
    public PaymentResult processPayment(String orderId, BigDecimal amount) {
        Payment payment = new Payment(orderId, amount);
        paymentRepository.save(payment);
        return new PaymentResult(true, payment.getId());
    }
    
    // è¡¥å¿æ“ä½œï¼šé€€æ¬¾
    @Transactional
    public void compensatePayment(String paymentId) {
        Payment payment = paymentRepository.findById(paymentId);
        payment.setStatus(PaymentStatus.REFUNDED);
        paymentRepository.save(payment);
    }
}
```

### 2.3 äº‹åŠ¡çŠ¶æ€ç®¡ç†


**äº‹åŠ¡çŠ¶æ€è·Ÿè¸ªè¡¨è®¾è®¡**ï¼š
```sql
-- åˆ†å¸ƒå¼äº‹åŠ¡çŠ¶æ€è¡¨
CREATE TABLE distributed_transaction (
    id VARCHAR(64) PRIMARY KEY,
    business_type VARCHAR(32) NOT NULL,
    business_id VARCHAR(64) NOT NULL,
    status ENUM('PENDING', 'SUCCESS', 'FAILED', 'COMPENSATING', 'COMPENSATED') NOT NULL,
    steps JSON NOT NULL,  -- è®°å½•å„ä¸ªæ­¥éª¤çš„æ‰§è¡ŒçŠ¶æ€
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_business (business_type, business_id),
    INDEX idx_status_time (status, create_time)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO distributed_transaction VALUES (
    'tx_order_20250121001',
    'CREATE_ORDER',
    'order_123456',
    'PENDING',
    JSON_OBJECT(
        'create_order', 'SUCCESS',
        'reduce_stock', 'PENDING',
        'process_payment', 'PENDING'
    ),
    NOW(),
    NOW()
);
```

---

## 3. ğŸ“– è¯»å†™åˆ†ç¦»æ¶æ„


### 3.1 è¯»å†™åˆ†ç¦»åŸºæœ¬åŸç†


**ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»ï¼Ÿ**
å°†æ•°æ®åº“çš„è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«è·¯ç”±åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼Œæé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚

```
è¯»å†™åˆ†ç¦»æ¶æ„ï¼š
                    åº”ç”¨ç¨‹åº
                        â”‚
                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
                   â”‚  æ•°æ®è®¿é—®å±‚ â”‚
                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚         â”‚         â”‚
           å†™æ“ä½œ      è¯»æ“ä½œ    è¯»æ“ä½œ
              â”‚         â”‚         â”‚
              â–¼         â–¼         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ä¸»æ•°æ®åº“ â”‚ â”‚ ä»æ•°æ®åº“1â”‚ â”‚ ä»æ•°æ®åº“2â”‚
        â”‚(Master) â”‚ â”‚ (Slave) â”‚ â”‚ (Slave) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚         â–²         â–²
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    æ•°æ®åŒæ­¥
```

**æ ¸å¿ƒåŸç†**ï¼š
- ğŸ”¸ **ä¸»åº“**ï¼šå¤„ç†æ‰€æœ‰å†™æ“ä½œï¼ˆINSERTã€UPDATEã€DELETEï¼‰
- ğŸ”¸ **ä»åº“**ï¼šå¤„ç†æ‰€æœ‰è¯»æ“ä½œï¼ˆSELECTï¼‰
- ğŸ”¸ **æ•°æ®åŒæ­¥**ï¼šä¸»åº“çš„æ•°æ®å˜æ›´åŒæ­¥åˆ°ä»åº“

### 3.2 è¯»å†™åˆ†ç¦»äº‹åŠ¡å¤„ç†


**äº‹åŠ¡ä¸­çš„è¯»å†™åˆ†ç¦»æŒ‘æˆ˜**ï¼š
```java
// é—®é¢˜åœºæ™¯ï¼šäº‹åŠ¡ä¸­çš„è¯»å†™æ“ä½œ
@Transactional
public void updateUserInfo(Long userId, String newEmail) {
    // 1. æ›´æ–°æ“ä½œï¼ˆå†™å…¥ä¸»åº“ï¼‰
    userRepository.updateEmail(userId, newEmail);
    
    // 2. ç«‹å³æŸ¥è¯¢ï¼ˆå¯èƒ½è¯»å–ä»åº“ï¼‰
    User user = userRepository.findById(userId);
    
    // é—®é¢˜ï¼šç”±äºä¸»ä»åŒæ­¥å»¶è¿Ÿï¼Œå¯èƒ½è¯»ä¸åˆ°åˆšæ‰çš„æ›´æ–°ï¼
    if (!newEmail.equals(user.getEmail())) {
        throw new RuntimeException("é‚®ç®±æ›´æ–°å¤±è´¥");
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

**ğŸ”¸ äº‹åŠ¡å†…å¼ºåˆ¶è¯»ä¸»åº“**
```java
@Service
public class UserService {
    
    @Transactional
    public void updateUserInfo(Long userId, String newEmail) {
        // æ›´æ–°æ“ä½œ
        userRepository.updateEmail(userId, newEmail);
        
        // å¼ºåˆ¶ä»ä¸»åº“è¯»å–
        User user = userRepository.findByIdFromMaster(userId);
        
        // ç°åœ¨å¯ä»¥æ­£ç¡®éªŒè¯æ›´æ–°ç»“æœ
        assert newEmail.equals(user.getEmail());
    }
}

// æ•°æ®è®¿é—®å±‚å®ç°
@Repository
public class UserRepository {
    
    @Master  // è‡ªå®šä¹‰æ³¨è§£ï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸»åº“
    public User findByIdFromMaster(Long id) {
        return entityManager.find(User.class, id);
    }
    
    @Slave   // ä½¿ç”¨ä»åº“ï¼ˆé»˜è®¤ï¼‰
    public User findById(Long id) {
        return entityManager.find(User.class, id);
    }
}
```

**ğŸ”¸ å»¶è¿Ÿè¯»å–ç­–ç•¥**
```java
@Service
public class OrderService {
    
    @Transactional
    public OrderResult createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆå†™ä¸»åº“ï¼‰
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. å¼‚æ­¥å¤„ç†åç»­è¯»å–æ“ä½œ
        CompletableFuture.runAsync(() -> {
            // ç­‰å¾…ä¸»ä»åŒæ­¥å®Œæˆ
            Thread.sleep(100);
            // ä»ä»åº“è¯»å–è®¢å•è¯¦æƒ…
            Order savedOrder = orderRepository.findById(order.getId());
            // å‘é€ç¡®è®¤é‚®ä»¶ç­‰åç»­å¤„ç†
            emailService.sendOrderConfirmation(savedOrder);
        });
        
        return new OrderResult(order.getId());
    }
}
```

### 3.3 ä¸»ä»åŒæ­¥å»¶è¿Ÿå¤„ç†


**ç›‘æ§ä¸»ä»å»¶è¿Ÿ**ï¼š
```sql
-- æ£€æŸ¥ä¸»ä»åŒæ­¥å»¶è¿Ÿ
SHOW SLAVE STATUS\G

-- å…³é”®æŒ‡æ ‡ï¼š
-- Seconds_Behind_Master: ä»åº“å»¶è¿Ÿç§’æ•°
-- Slave_IO_Running: IOçº¿ç¨‹çŠ¶æ€
-- Slave_SQL_Running: SQLçº¿ç¨‹çŠ¶æ€
```

**å»¶è¿Ÿå¤„ç†ç­–ç•¥**ï¼š
```java
@Component
public class ReplicationLagHandler {
    
    private static final int MAX_LAG_SECONDS = 5;
    
    public <T> T readWithLagCheck(Supplier<T> readOperation) {
        int currentLag = getCurrentReplicationLag();
        
        if (currentLag > MAX_LAG_SECONDS) {
            // å»¶è¿Ÿè¿‡å¤§ï¼Œä»ä¸»åº“è¯»å–
            return readFromMaster(readOperation);
        } else {
            // å»¶è¿Ÿå¯æ¥å—ï¼Œä»ä»åº“è¯»å–
            return readOperation.get();
        }
    }
    
    private int getCurrentReplicationLag() {
        // æŸ¥è¯¢ SHOW SLAVE STATUS è·å–å»¶è¿Ÿä¿¡æ¯
        return jdbcTemplate.queryForObject(
            "SELECT COALESCE(SECONDS_BEHIND_MASTER, 999) FROM information_schema.replica_host_status",
            Integer.class
        );
    }
}
```

---

## 4. ğŸ—‚ï¸ åˆ†åº“åˆ†è¡¨äº‹åŠ¡


### 4.1 åˆ†åº“åˆ†è¡¨åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨ï¼Ÿ**
å½“å•ä¸ªæ•°æ®åº“æ— æ³•æ‰¿è½½ä¸šåŠ¡å‹åŠ›æ—¶ï¼Œå°†æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“æˆ–å¤šä¸ªè¡¨ä¸­ã€‚

```
åˆ†åº“ç¤ºä¾‹ï¼š
åŸå§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·æ•°æ®åº“     â”‚
â”‚ user_id: 1-1000ä¸‡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†åº“åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“1    â”‚  â”‚   æ•°æ®åº“2    â”‚  â”‚   æ•°æ®åº“3    â”‚
â”‚user_id:1-300ä¸‡â”‚ â”‚user_id:300-600ä¸‡â”‚ â”‚user_id:600-1000ä¸‡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†è¡¨ç¤ºä¾‹ï¼š
åŸå§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     è®¢å•è¡¨       â”‚
â”‚   order_table   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†è¡¨åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  order_2024_01â”‚  â”‚  order_2024_02â”‚  â”‚  order_2024_03â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 åˆ†åº“åˆ†è¡¨äº‹åŠ¡æŒ‘æˆ˜


**è·¨åº“äº‹åŠ¡é—®é¢˜**ï¼š
```java
// é—®é¢˜åœºæ™¯ï¼šè½¬è´¦ä¸šåŠ¡è·¨åº“æ“ä½œ
public void transfer(String fromUserId, String toUserId, BigDecimal amount) {
    // æ ¹æ®ç”¨æˆ·IDè®¡ç®—åˆ†åº“
    String fromDbKey = getDbKey(fromUserId);  // å¯èƒ½æ˜¯ db1
    String toDbKey = getDbKey(toUserId);      // å¯èƒ½æ˜¯ db2
    
    if (!fromDbKey.equals(toDbKey)) {
        // è·¨åº“æ“ä½œï¼æ— æ³•ä½¿ç”¨æœ¬åœ°äº‹åŠ¡
        // éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
    }
}
```

**åˆ†è¡¨äº‹åŠ¡é—®é¢˜**ï¼š
```sql
-- é—®é¢˜ï¼šéœ€è¦åœ¨å¤šä¸ªåˆ†è¡¨ä¸­æŸ¥è¯¢æ•°æ®
-- æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰è®¢å•ï¼ˆå¯èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæœˆä»½è¡¨ä¸­ï¼‰
SELECT * FROM order_2024_01 WHERE user_id = 12345
UNION ALL
SELECT * FROM order_2024_02 WHERE user_id = 12345
UNION ALL
SELECT * FROM order_2024_03 WHERE user_id = 12345;

-- é—®é¢˜ï¼šæ— æ³•åœ¨å¤šä¸ªåˆ†è¡¨é—´ä½¿ç”¨äº‹åŠ¡
BEGIN;
INSERT INTO order_2024_03 (...) VALUES (...);
UPDATE order_stat_2024_03 SET total = total + 1;  -- ç»Ÿè®¡è¡¨ä¹Ÿåˆ†è¡¨äº†
COMMIT;  -- åªèƒ½ä¿è¯å•è¡¨äº‹åŠ¡
```

### 4.3 åˆ†åº“åˆ†è¡¨äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ å°½é‡é¿å…è·¨åº“äº‹åŠ¡**
```java
// è®¾è®¡åŸåˆ™ï¼šç›¸å…³æ•°æ®å­˜å‚¨åœ¨åŒä¸€åˆ†åº“
public class UserShardingStrategy {
    
    // æŒ‰ç”¨æˆ·IDåˆ†åº“ï¼šç¡®ä¿åŒä¸€ç”¨æˆ·çš„æ•°æ®åœ¨åŒä¸€åº“
    public String getDbKey(String userId) {
        int hash = userId.hashCode();
        int dbIndex = Math.abs(hash) % 4;  // 4ä¸ªåˆ†åº“
        return "db" + dbIndex;
    }
    
    // ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰è¡¨éƒ½æŒ‰ç›¸åŒè§„åˆ™åˆ†åº“
    public void createOrder(String userId, OrderRequest request) {
        String dbKey = getDbKey(userId);
        
        // åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­æ“ä½œå¤šä¸ªè¡¨
        try (Connection conn = getConnection(dbKey)) {
            conn.setAutoCommit(false);
            
            // è®¢å•è¡¨
            insertOrder(conn, request);
            // ç”¨æˆ·ç»Ÿè®¡è¡¨  
            updateUserStats(conn, userId);
            // ç§¯åˆ†è¡¨
            updateUserPoints(conn, userId, request.getAmount());
            
            conn.commit();  // æœ¬åœ°äº‹åŠ¡å³å¯
        }
    }
}
```

**ğŸ”¸ ä¸šåŠ¡å±‚é¢é¿å…å¼ºä¸€è‡´æ€§**
```java
// å°†å¼ºä¸€è‡´æ€§æ”¹ä¸ºæœ€ç»ˆä¸€è‡´æ€§
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(OrderRequest request) {
        // 1. å…ˆåˆ›å»ºè®¢å•ï¼ˆå¯èƒ½åœ¨åˆ†åº“Aï¼‰
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. å¼‚æ­¥æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ï¼ˆå¯èƒ½åœ¨åˆ†åº“Bï¼‰
        eventPublisher.publish(new OrderCreatedEvent(order));
        
        // 3. å¼‚æ­¥æ›´æ–°å•†å“é”€é‡ï¼ˆå¯èƒ½åœ¨åˆ†åº“Cï¼‰
        eventPublisher.publish(new ProductSoldEvent(order.getProductId(), order.getQuantity()));
    }
}

@EventListener
public class UserStatsHandler {
    
    @Async
    @Transactional
    public void handleOrderCreated(OrderCreatedEvent event) {
        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        userStatsService.incrementOrderCount(event.getUserId());
    }
}
```

**ğŸ”¸ ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­é—´ä»¶**
```java
// ä½¿ç”¨ Seata ç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶
@GlobalTransactional  // Seata å…¨å±€äº‹åŠ¡æ³¨è§£
public void createOrderWithDistributedTransaction(OrderRequest request) {
    
    // æ“ä½œ1ï¼šåˆ›å»ºè®¢å•ï¼ˆå¯èƒ½åœ¨æ•°æ®åº“1ï¼‰
    orderService.createOrder(request);
    
    // æ“ä½œ2ï¼šæ‰£å‡åº“å­˜ï¼ˆå¯èƒ½åœ¨æ•°æ®åº“2ï¼‰  
    inventoryService.reduceStock(request.getProductId(), request.getQuantity());
    
    // æ“ä½œ3ï¼šæ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆå¯èƒ½åœ¨æ•°æ®åº“3ï¼‰
    accountService.deductBalance(request.getUserId(), request.getAmount());
    
    // å¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼ŒSeataä¼šè‡ªåŠ¨å›æ»šæ‰€æœ‰æ“ä½œ
}
```

---

## 5. ğŸ’¾ ç¼“å­˜äº‹åŠ¡ä¸€è‡´æ€§


### 5.1 ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜


**ç¼“å­˜ä¸æ•°æ®åº“ä¸€è‡´æ€§æŒ‘æˆ˜**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
1. æ›´æ–°æ•°æ®åº“ âœ“
2. åˆ é™¤ç¼“å­˜ âœ— (å¤±è´¥)
3. ä¸‹æ¬¡è¯»å–æ—¶ï¼Œè¯»åˆ°äº†æ—§çš„ç¼“å­˜æ•°æ®

æˆ–è€…ï¼š
1. åˆ é™¤ç¼“å­˜ âœ“  
2. æ›´æ–°æ•°æ®åº“ âœ— (å¤±è´¥)
3. ä¸‹æ¬¡è¯»å–æ—¶ï¼Œç¼“å­˜æ²¡æœ‰æ•°æ®ï¼Œä»æ•°æ®åº“è¯»å–åˆ°æ—§æ•°æ®å¹¶é‡æ–°ç¼“å­˜
```

**å¸¸è§é—®é¢˜**ï¼š
- ğŸ”¸ **æ›´æ–°ä¸¢å¤±**ï¼šæ•°æ®åº“æ›´æ–°äº†ï¼Œç¼“å­˜æ²¡æ›´æ–°
- ğŸ”¸ **è„è¯»**ï¼šè¯»åˆ°äº†è¿‡æœŸçš„ç¼“å­˜æ•°æ®
- ğŸ”¸ **æ•°æ®ä¸ä¸€è‡´**ï¼šæ•°æ®åº“å’Œç¼“å­˜æ•°æ®ä¸åŒ

### 5.2 ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥


**ğŸ”¸ Cache Aside æ¨¡å¼**
```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired  
    private RedisTemplate<String, User> redisTemplate;
    
    // è¯»å–æ•°æ®
    public User getUserById(Long userId) {
        String cacheKey = "user:" + userId;
        
        // 1. å…ˆä»ç¼“å­˜è¯»å–
        User user = redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼Œä»æ•°æ®åº“è¯»å–
        user = userRepository.findById(userId);
        if (user != null) {
            // 3. å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, user, Duration.ofHours(1));
        }
        
        return user;
    }
    
    // æ›´æ–°æ•°æ®
    @Transactional
    public void updateUser(User user) {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        userRepository.save(user);
        
        // 2. å†åˆ é™¤ç¼“å­˜
        String cacheKey = "user:" + user.getId();
        redisTemplate.delete(cacheKey);
        
        // ä¸‹æ¬¡è¯»å–æ—¶ä¼šä»æ•°æ®åº“é‡æ–°åŠ è½½æœ€æ–°æ•°æ®
    }
}
```

**ğŸ”¸ Write Through æ¨¡å¼**
```java
@Service  
public class ProductService {
    
    // å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
    @Transactional
    public void updateProduct(Product product) {
        try {
            // 1. æ›´æ–°æ•°æ®åº“
            productRepository.save(product);
            
            // 2. æ›´æ–°ç¼“å­˜
            String cacheKey = "product:" + product.getId();
            redisTemplate.opsForValue().set(cacheKey, product);
            
        } catch (Exception e) {
            // å¦‚æœç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œå›æ»šæ•°æ®åº“æ“ä½œ
            throw new RuntimeException("ç¼“å­˜æ›´æ–°å¤±è´¥", e);
        }
    }
}
```

**ğŸ”¸ Write Behind æ¨¡å¼ï¼ˆå¼‚æ­¥å†™å…¥ï¼‰**
```java
@Service
public class OrderService {
    
    private final BlockingQueue<Order> writeQueue = new LinkedBlockingQueue<>();
    
    // å¼‚æ­¥å†™å…¥æ•°æ®åº“
    @PostConstruct
    public void startAsyncWriter() {
        CompletableFuture.runAsync(() -> {
            while (true) {
                try {
                    Order order = writeQueue.take();
                    // æ‰¹é‡å†™å…¥æ•°æ®åº“
                    orderRepository.save(order);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        });
    }
    
    public void createOrder(Order order) {
        // 1. ç«‹å³å†™å…¥ç¼“å­˜
        String cacheKey = "order:" + order.getId();
        redisTemplate.opsForValue().set(cacheKey, order);
        
        // 2. å¼‚æ­¥å†™å…¥æ•°æ®åº“
        writeQueue.offer(order);
    }
}
```

### 5.3 åˆ†å¸ƒå¼ç¼“å­˜äº‹åŠ¡


**Redis äº‹åŠ¡æ”¯æŒ**ï¼š
```java
@Service
public class CartService {
    
    // Redis äº‹åŠ¡ï¼šå¤šä¸ªæ“ä½œåŸå­æ‰§è¡Œ
    public void addToCart(String userId, String productId, int quantity) {
        String cartKey = "cart:" + userId;
        String stockKey = "stock:" + productId;
        
        redisTemplate.execute(new SessionCallback<Object>() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                // å¼€å¯äº‹åŠ¡
                operations.multi();
                
                // æ“ä½œ1ï¼šå‡å°‘åº“å­˜
                operations.opsForValue().decrement(stockKey, quantity);
                
                // æ“ä½œ2ï¼šæ·»åŠ åˆ°è´­ç‰©è½¦
                operations.opsForHash().increment(cartKey, productId, quantity);
                
                // æäº¤äº‹åŠ¡
                return operations.exec();
            }
        });
    }
}
```

**Luaè„šæœ¬ä¿è¯åŸå­æ€§**ï¼š
```java
@Service
public class LuaScriptService {
    
    private final String transferScript = 
        "local from_key = KEYS[1] " +
        "local to_key = KEYS[2] " +
        "local amount = tonumber(ARGV[1]) " +
        "local from_balance = tonumber(redis.call('get', from_key) or 0) " +
        "if from_balance >= amount then " +
        "    redis.call('decrby', from_key, amount) " +
        "    redis.call('incrby', to_key, amount) " +
        "    return 1 " +
        "else " +
        "    return 0 " +
        "end";
    
    public boolean transfer(String fromAccount, String toAccount, int amount) {
        DefaultRedisScript<Long> script = new DefaultRedisScript<>();
        script.setScriptText(transferScript);
        script.setResultType(Long.class);
        
        Long result = redisTemplate.execute(script, 
            Arrays.asList("balance:" + fromAccount, "balance:" + toAccount),
            String.valueOf(amount));
            
        return result != null && result == 1;
    }
}
```

---

## 6. ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡


### 6.1 æ¶ˆæ¯é˜Ÿåˆ—äº‹åŠ¡æ¨¡å¼


**æœ¬åœ°æ¶ˆæ¯è¡¨æ¨¡å¼**ï¼š
```sql
-- æœ¬åœ°æ¶ˆæ¯è¡¨è®¾è®¡
CREATE TABLE local_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    business_id VARCHAR(64) NOT NULL,
    message_type VARCHAR(32) NOT NULL,
    message_content JSON NOT NULL,
    status ENUM('PENDING', 'SENT', 'CONFIRMED') DEFAULT 'PENDING',
    max_retry_count INT DEFAULT 3,
    retry_count INT DEFAULT 0,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status_time (status, create_time)
);
```

```java
@Service
@Transactional
public class OrderService {
    
    public void createOrder(OrderRequest request) {
        // 1. æœ¬åœ°äº‹åŠ¡ï¼šåŒæ—¶ä¿å­˜ä¸šåŠ¡æ•°æ®å’Œæ¶ˆæ¯
        Order order = new Order(request);
        orderRepository.save(order);
        
        // 2. ä¿å­˜å¾…å‘é€æ¶ˆæ¯ï¼ˆä¸ä¸šåŠ¡æ•°æ®åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
        LocalMessage message = new LocalMessage();
        message.setBusinessId(order.getId());
        message.setMessageType("ORDER_CREATED");
        message.setMessageContent(JsonUtils.toJson(order));
        message.setStatus(MessageStatus.PENDING);
        localMessageRepository.save(message);
        
        // æœ¬åœ°äº‹åŠ¡æäº¤åï¼Œå¼‚æ­¥å‘é€æ¶ˆæ¯
    }
}

// å¼‚æ­¥æ¶ˆæ¯å‘é€å™¨
@Component
public class MessageSender {
    
    @Scheduled(fixedDelay = 5000)  // æ¯5ç§’æ‰«æä¸€æ¬¡
    public void sendPendingMessages() {
        List<LocalMessage> pendingMessages = localMessageRepository
            .findByStatusAndRetryCountLessThan(MessageStatus.PENDING, 3);
            
        for (LocalMessage message : pendingMessages) {
            try {
                // å‘é€æ¶ˆæ¯åˆ°MQ
                rabbitTemplate.convertAndSend("order.exchange", "order.created", 
                    message.getMessageContent());
                
                // æ ‡è®°ä¸ºå·²å‘é€
                message.setStatus(MessageStatus.SENT);
                localMessageRepository.save(message);
                
            } catch (Exception e) {
                // å¢åŠ é‡è¯•æ¬¡æ•°
                message.setRetryCount(message.getRetryCount() + 1);
                localMessageRepository.save(message);
            }
        }
    }
}
```

**äº‹åŠ¡æ¶ˆæ¯æ¨¡å¼ï¼ˆRocketMQï¼‰**ï¼š
```java
@Service
public class OrderTransactionService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void createOrderWithTransactionMessage(OrderRequest request) {
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        Message<OrderCreatedEvent> message = MessageBuilder
            .withPayload(new OrderCreatedEvent(request))
            .setHeader("orderId", request.getOrderId())
            .build();
            
        // å‘é€åŠæ¶ˆæ¯ï¼ˆHalf Messageï¼‰
        rocketMQTemplate.sendMessageInTransaction("order-topic", message, request);
    }
    
    // æœ¬åœ°äº‹åŠ¡æ‰§è¡Œ
    @RocketMQTransactionListener
    public class OrderTransactionListener implements RocketMQLocalTransactionListener {
        
        @Override
        public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            try {
                OrderRequest request = (OrderRequest) arg;
                
                // æ‰§è¡Œæœ¬åœ°ä¸šåŠ¡äº‹åŠ¡
                Order order = new Order(request);
                orderRepository.save(order);
                
                return RocketMQLocalTransactionState.COMMIT;  // æäº¤æ¶ˆæ¯
            } catch (Exception e) {
                return RocketMQLocalTransactionState.ROLLBACK;  // å›æ»šæ¶ˆæ¯
            }
        }
        
        // äº‹åŠ¡çŠ¶æ€å›æŸ¥
        @Override
        public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
            String orderId = (String) msg.getHeaders().get("orderId");
            Order order = orderRepository.findByOrderId(orderId);
            
            if (order != null) {
                return RocketMQLocalTransactionState.COMMIT;
            } else {
                return RocketMQLocalTransactionState.ROLLBACK;
            }
        }
    }
}
```

### 6.2 æ¶ˆæ¯å¹‚ç­‰æ€§å¤„ç†


**æ¶ˆæ¯å»é‡è¡¨**ï¼š
```sql
-- æ¶ˆæ¯æ¶ˆè´¹è®°å½•è¡¨
CREATE TABLE message_consume_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) UNIQUE NOT NULL,
    consumer_group VARCHAR(64) NOT NULL,
    topic VARCHAR(64) NOT NULL,
    consume_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_message_group (message_id, consumer_group)
);
```

```java
@Service
public class IdempotentMessageHandler {
    
    @RabbitListener(queues = "order.queue")
    public void handleOrderMessage(OrderCreatedEvent event, 
                                   @Header("messageId") String messageId) {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡æ­¤æ¶ˆæ¯
        if (messageConsumeRecordRepository.existsByMessageId(messageId)) {
            log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡ï¼Œå¿½ç•¥: {}", messageId);
            return;
        }
        
        try {
            // 2. å¤„ç†ä¸šåŠ¡é€»è¾‘
            processOrderCreated(event);
            
            // 3. è®°å½•æ¶ˆæ¯å¤„ç†çŠ¶æ€
            MessageConsumeRecord record = new MessageConsumeRecord();
            record.setMessageId(messageId);
            record.setConsumerGroup("order-consumer");
            record.setTopic("order.topic");
            messageConsumeRecordRepository.save(record);
            
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•æ¶ˆæ¯å¤±è´¥: {}", messageId, e);
            throw e;  // æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘æ¶ˆæ¯é‡è¯•
        }
    }
    
    @Transactional
    private void processOrderCreated(OrderCreatedEvent event) {
        // å…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
        // ä¾‹å¦‚ï¼šå‘é€ç¡®è®¤é‚®ä»¶ã€æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ç­‰
    }
}
```

---

## 7. ğŸ“ˆ æ¶æ„æ¼”è¿›ç­–ç•¥


### 7.1 æ¶æ„æ¼”è¿›è·¯å¾„


**å•ä½“æ¶æ„ â†’ å¾®æœåŠ¡æ¶æ„æ¼”è¿›**ï¼š
```
é˜¶æ®µ1ï¼šå•ä½“åº”ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è®¢å•ç³»ç»Ÿ               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚è®¢å• â”‚ â”‚ åº“å­˜ â”‚ â”‚ æ”¯ä»˜ â”‚      â”‚ â† æœ¬åœ°äº‹åŠ¡ï¼Œç®€å•ç›´æ¥
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ2ï¼šè¯»å†™åˆ†ç¦»
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è®¢å•ç³»ç»Ÿ               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚è®¢å• â”‚ â”‚ åº“å­˜ â”‚ â”‚ æ”¯ä»˜ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
    â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ä¸»æ•°æ®åº“â”‚ â”‚ä»æ•°æ®åº“1â”‚ â”‚ä»æ•°æ®åº“2â”‚ â† è¯»å†™åˆ†ç¦»ï¼Œæå‡æ€§èƒ½
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ3ï¼šå‚ç›´æ‹†åˆ†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â”‚    â”‚ åº“å­˜æœåŠ¡ â”‚    â”‚ æ”¯ä»˜æœåŠ¡ â”‚ â† æŒ‰ä¸šåŠ¡å‚ç›´æ‹†åˆ†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ4ï¼šæ°´å¹³æ‹†åˆ†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è®¢å•æœåŠ¡1 â”‚    â”‚è®¢å•æœåŠ¡2 â”‚    â”‚è®¢å•æœåŠ¡3 â”‚ â† æŒ‰æ•°æ®é‡æ°´å¹³æ‹†åˆ†
â”‚ åˆ†ç‰‡1   â”‚    â”‚ åˆ†ç‰‡2   â”‚    â”‚ åˆ†ç‰‡3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ¼”è¿›ç­–ç•¥


**ğŸ”¸ æ¸è¿›å¼æ¼”è¿›**
```java
// ç¬¬ä¸€æ­¥ï¼šåœ¨å•ä½“åº”ç”¨ä¸­å¼•å…¥äº‹ä»¶æœºåˆ¶
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(OrderRequest request) {
        // åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
        Order order = createOrderInternal(request);
        updateInventory(request.getProductId(), request.getQuantity());
        processPayment(request.getAmount());
        
        // æ–°å¢ï¼šå‘å¸ƒäº‹ä»¶ï¼ˆä¸ºåç»­æ‹†åˆ†åšå‡†å¤‡ï¼‰
        eventPublisher.publish(new OrderCreatedEvent(order));
    }
    
    // äº‹ä»¶å¤„ç†å™¨ï¼ˆæš‚æ—¶åœ¨åŒä¸€ä¸ªåº”ç”¨ä¸­ï¼‰
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        // ä¸€äº›éæ ¸å¿ƒé€»è¾‘ï¼Œä¸ºåç»­æå–æˆç‹¬ç«‹æœåŠ¡åšå‡†å¤‡
        sendConfirmationEmail(event.getOrder());
        updateUserStatistics(event.getOrder().getUserId());
    }
}
```

**ğŸ”¸ æ•°æ®åº“æ‹†åˆ†ç­–ç•¥**
```java
// ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“å‚ç›´æ‹†åˆ†
public class DatabaseMigrationStrategy {
    
    // åŸå§‹é…ç½®ï¼šå•ä¸€æ•°æ®æº
    @Primary
    @Bean("masterDataSource")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create()
            .url("jdbc:mysql://localhost:3306/ecommerce")
            .build();
    }
    
    // æ–°å¢é…ç½®ï¼šæŒ‰ä¸šåŠ¡æ‹†åˆ†æ•°æ®æº
    @Bean("orderDataSource")
    public DataSource orderDataSource() {
        return DataSourceBuilder.create()
            .url("jdbc:mysql://localhost:3306/order_db")
            .build();
    }
    
    @Bean("inventoryDataSource")  
    public DataSource inventoryDataSource() {
        return DataSourceBuilder.create()
            .url("jdbc:mysql://localhost:3306/inventory_db")
            .build();
    }
    
    @Bean("paymentDataSource")
    public DataSource paymentDataSource() {
        return DataSourceBuilder.create()
            .url("jdbc:mysql://localhost:3306/payment_db")
            .build();
    }
}
```

**ğŸ”¸ æœåŠ¡æ‹†åˆ†ç­–ç•¥**
```java
// ç¬¬ä¸‰æ­¥ï¼šé€æ­¥æå–å¾®æœåŠ¡
// åŸå§‹æœåŠ¡ä¿æŒå‘åå…¼å®¹
@RestController
public class OrderController {
    
    @PostMapping("/orders")
    public ResponseEntity<OrderResult> createOrder(@RequestBody OrderRequest request) {
        
        // åˆ¤æ–­æ˜¯å¦å¯ç”¨æ–°æ¶æ„
        if (featureToggle.isEnabled("microservice_architecture")) {
            // è°ƒç”¨æ–°çš„å¾®æœåŠ¡
            return createOrderViaMicroservices(request);
        } else {
            // ä½¿ç”¨åŸæœ‰å•ä½“é€»è¾‘
            return createOrderViaMonolith(request);
        }
    }
    
    private ResponseEntity<OrderResult> createOrderViaMicroservices(OrderRequest request) {
        // ä½¿ç”¨ Saga æ¨¡å¼åè°ƒå¤šä¸ªå¾®æœåŠ¡
        SagaTransaction saga = sagaManager.begin("CREATE_ORDER");
        
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            OrderCreatedResult orderResult = orderServiceClient.createOrder(request);
            saga.addCompensation(() -> orderServiceClient.cancelOrder(orderResult.getOrderId()));
            
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            InventoryResult inventoryResult = inventoryServiceClient.reduceStock(
                request.getProductId(), request.getQuantity());
            saga.addCompensation(() -> inventoryServiceClient.restoreStock(
                request.getProductId(), request.getQuantity()));
            
            // æ­¥éª¤3ï¼šå¤„ç†æ”¯ä»˜
            PaymentResult paymentResult = paymentServiceClient.processPayment(
                request.getUserId(), request.getAmount());
            saga.addCompensation(() -> paymentServiceClient.refund(paymentResult.getPaymentId()));
            
            saga.commit();
            return ResponseEntity.ok(new OrderResult(orderResult.getOrderId()));
            
        } catch (Exception e) {
            saga.compensate();
            throw e;
        }
    }
}
```

---

## 8. ğŸ—ï¸ é«˜å¹¶å‘æ¶æ„å®Œæ•´è®¾è®¡


### 8.1 æ¶æ„æ•´ä½“è®¾è®¡


**é«˜å¹¶å‘äº‹åŠ¡æ¶æ„å›¾**ï¼š
```
                            è´Ÿè½½å‡è¡¡å™¨
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           â”‚           â”‚
                åº”ç”¨æœåŠ¡1     åº”ç”¨æœåŠ¡2     åº”ç”¨æœåŠ¡3
                    â”‚           â”‚           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    æ¶ˆæ¯é˜Ÿåˆ—     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                 â”‚                 â”‚
          è®¢å•æœåŠ¡           åº“å­˜æœåŠ¡          æ”¯ä»˜æœåŠ¡
              â”‚                 â”‚                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚      â”‚         â”‚       â”‚       â”‚
 è®¢å•ä¸»åº“   è®¢å•ä»åº“  è®¢å•ç¼“å­˜  åº“å­˜åˆ†ç‰‡  æ”¯ä»˜ä¸»åº“ æ”¯ä»˜ä»åº“ æ”¯ä»˜ç¼“å­˜
```

**æ ¸å¿ƒç»„ä»¶é…ç½®**ï¼š
```java
@Configuration
public class HighConcurrencyTransactionConfig {
    
    // 1. æ•°æ®æºé…ç½®ï¼ˆè¯»å†™åˆ†ç¦» + åˆ†åº“åˆ†è¡¨ï¼‰
    @Bean
    public DataSource shardingDataSource() {
        Map<String, DataSource> dataSourceMap = new HashMap<>();
        
        // ä¸»åº“é…ç½®
        dataSourceMap.put("order_master", createDataSource("jdbc:mysql://master:3306/order_db"));
        // ä»åº“é…ç½®  
        dataSourceMap.put("order_slave_1", createDataSource("jdbc:mysql://slave1:3306/order_db"));
        dataSourceMap.put("order_slave_2", createDataSource("jdbc:mysql://slave2:3306/order_db"));
        
        // åˆ†ç‰‡è§„åˆ™é…ç½®
        ShardingRuleConfiguration shardingRule = new ShardingRuleConfiguration();
        shardingRule.getTableRuleConfigs().add(getOrderTableRule());
        shardingRule.getMasterSlaveRuleConfigs().add(getMasterSlaveRule());
        
        return ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRule, new Properties());
    }
    
    // 2. ç¼“å­˜é…ç½®ï¼ˆRedisé›†ç¾¤ï¼‰
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        
        // Redisé›†ç¾¤é…ç½®
        RedisClusterConfiguration clusterConfig = new RedisClusterConfiguration();
        clusterConfig.clusterNode("redis-node1", 7000);
        clusterConfig.clusterNode("redis-node2", 7001);
        clusterConfig.clusterNode("redis-node3", 7002);
        
        JedisConnectionFactory factory = new JedisConnectionFactory(clusterConfig);
        template.setConnectionFactory(factory);
        
        return template;
    }
    
    // 3. æ¶ˆæ¯é˜Ÿåˆ—é…ç½®
    @Bean
    public RabbitTemplate rabbitTemplate() {
        ConnectionFactory connectionFactory = new CachingConnectionFactory("rabbitmq-cluster");
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å‘é€ç¡®è®¤é…ç½®
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (!ack) {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}", cause);
            }
        });
        
        return template;
    }
}
```

### 8.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ è¿æ¥æ± ä¼˜åŒ–**
```java
@Configuration
public class ConnectionPoolConfig {
    
    @Bean
    public DataSource optimizedDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/db");
        config.setUsername("user");
        config.setPassword("password");
        
        // æ€§èƒ½ä¼˜åŒ–å‚æ•°
        config.setMaximumPoolSize(50);           // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(10);               // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);      // è¿æ¥è¶…æ—¶
        config.setIdleTimeout(600000);           // ç©ºé—²è¶…æ—¶
        config.setMaxLifetime(1800000);          // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        config.setLeakDetectionThreshold(60000); // è¿æ¥æ³„æ¼æ£€æµ‹
        
        // MySQLä¼˜åŒ–å‚æ•°
        config.addDataSourceProperty("cachePrepStmts", "true");
        config.addDataSourceProperty("prepStmtCacheSize", "250");
        config.addDataSourceProperty("prepStmtCacheSqlLimit", "2048");
        config.addDataSourceProperty("useServerPrepStmts", "true");
        config.addDataSourceProperty("rewriteBatchedStatements", "true");
        
        return new HikariDataSource(config);
    }
}
```

**ğŸ”¸ äº‹åŠ¡ç®¡ç†ä¼˜åŒ–**
```java
@Service
public class OptimizedTransactionService {
    
    // åªè¯»äº‹åŠ¡ä¼˜åŒ–
    @Transactional(readOnly = true)
    public List<Order> getOrderHistory(String userId) {
        // åªè¯»äº‹åŠ¡ä¼šè¢«è·¯ç”±åˆ°ä»åº“ï¼Œæå‡æ€§èƒ½
        return orderRepository.findByUserIdOrderByCreateTimeDesc(userId);
    }
    
    // äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¼˜åŒ–
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void asyncProcessOrder(String orderId) {
        // ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å½±å“ä¸»äº‹åŠ¡
        Order order = orderRepository.findById(orderId);
        // æ‰§è¡Œä¸€äº›å¯ä»¥å¤±è´¥çš„æ“ä½œï¼Œå¦‚å‘é€é‚®ä»¶
        emailService.sendOrderConfirmation(order);
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–
    @Transactional
    public void batchUpdateOrderStatus(List<String> orderIds, OrderStatus status) {
        // æ‰¹é‡æ›´æ–°ï¼Œå‡å°‘äº‹åŠ¡å¼€é”€
        orderRepository.batchUpdateStatus(orderIds, status);
    }
}
```

**ğŸ”¸ ç¼“å­˜é¢„çƒ­ç­–ç•¥**
```java
@Component
public class CacheWarmupService {
    
    @PostConstruct
    @Async
    public void warmupCache() {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        
        // é¢„çƒ­çƒ­é—¨å•†å“ä¿¡æ¯
        List<String> hotProductIds = getHotProductIds();
        for (String productId : hotProductIds) {
            Product product = productRepository.findById(productId);
            redisTemplate.opsForValue().set("product:" + productId, product, Duration.ofHours(2));
        }
        
        // é¢„çƒ­ç”¨æˆ·åŸºç¡€ä¿¡æ¯
        List<String> activeUserIds = getActiveUserIds();
        for (String userId : activeUserIds) {
            User user = userRepository.findById(userId);
            redisTemplate.opsForValue().set("user:" + userId, user, Duration.ofMinutes(30));
        }
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
    
    // è·å–çƒ­é—¨å•†å“IDï¼ˆå¯ä»¥ä»ç»Ÿè®¡ç³»ç»Ÿè·å–ï¼‰
    private List<String> getHotProductIds() {
        return productStatRepository.findTopProductIds(100);
    }
}
```

### 8.3 ç›‘æ§ä¸å‘Šè­¦


**äº‹åŠ¡ç›‘æ§é…ç½®**ï¼š
```java
@Component
public class TransactionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter transactionCounter;
    private final Timer transactionTimer;
    
    public TransactionMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.transactionCounter = Counter.builder("transaction.count")
            .tag("type", "distributed")
            .register(meterRegistry);
        this.transactionTimer = Timer.builder("transaction.duration")
            .register(meterRegistry);
    }
    
    @EventListener
    public void handleTransactionStart(TransactionStartEvent event) {
        transactionCounter.increment();
        // è®°å½•äº‹åŠ¡å¼€å§‹æ—¶é—´
    }
    
    @EventListener  
    public void handleTransactionEnd(TransactionEndEvent event) {
        transactionTimer.record(event.getDuration(), TimeUnit.MILLISECONDS);
        
        // æ…¢äº‹åŠ¡å‘Šè­¦
        if (event.getDuration() > 5000) {
            alertService.sendSlowTransactionAlert(event);
        }
        
        // å¤±è´¥äº‹åŠ¡å‘Šè­¦
        if (event.isFailure()) {
            alertService.sendTransactionFailureAlert(event);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼šè·¨å¤šä¸ªæ•°æ®åº“æˆ–æœåŠ¡çš„äº‹åŠ¡å¤„ç†
ğŸ”¸ å¾®æœåŠ¡äº‹åŠ¡ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸‹çš„äº‹åŠ¡ç®¡ç†æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šæå‡æ•°æ®åº“å¹¶å‘æ€§èƒ½çš„é‡è¦æ‰‹æ®µ
ğŸ”¸ åˆ†åº“åˆ†è¡¨ï¼šè§£å†³å•åº“å•è¡¨æ€§èƒ½ç“¶é¢ˆçš„åˆ†ç‰‡ç­–ç•¥
ğŸ”¸ ç¼“å­˜ä¸€è‡´æ€§ï¼šä¿è¯ç¼“å­˜ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´æ€§çš„å…³é”®é—®é¢˜
ğŸ”¸ æ¶ˆæ¯äº‹åŠ¡ï¼šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—å®ç°çš„äº‹åŠ¡å¤„ç†æ¨¡å¼
ğŸ”¸ æ¶æ„æ¼”è¿›ï¼šä»å•ä½“åˆ°åˆ†å¸ƒå¼çš„æ¸è¿›å¼æ¼”è¿›ç­–ç•¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡ä¸€è‡´æ€§çš„æƒè¡¡**
```
å¼ºä¸€è‡´æ€§ vs æœ€ç»ˆä¸€è‡´æ€§ï¼š
- å¼ºä¸€è‡´æ€§ï¼šæ•°æ®æ—¶åˆ»ä¿æŒä¸€è‡´ï¼Œä½†æ€§èƒ½å’Œå¯ç”¨æ€§å—å½±å“
- æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€

é€‰æ‹©åŸåˆ™ï¼š
- æ ¸å¿ƒä¸šåŠ¡ï¼ˆå¦‚æ”¯ä»˜ï¼‰ï¼šé€‰æ‹©å¼ºä¸€è‡´æ€§
- éæ ¸å¿ƒä¸šåŠ¡ï¼ˆå¦‚ç»Ÿè®¡ï¼‰ï¼šé€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ æ€§èƒ½ä¸å¯é æ€§çš„å¹³è¡¡**
```
é«˜æ€§èƒ½ç­–ç•¥ï¼š
- è¯»å†™åˆ†ç¦»ï¼šæå‡å¹¶å‘è¯»å–èƒ½åŠ›
- åˆ†åº“åˆ†è¡¨ï¼šåˆ†æ•£å•ç‚¹å‹åŠ›
- ç¼“å­˜é¢„çƒ­ï¼šå‡å°‘æ•°æ®åº“è®¿é—®

é«˜å¯é æ€§ç­–ç•¥ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- è¡¥å¿æœºåˆ¶ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ
- ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ”¹ æ¶æ„æ¼”è¿›çš„æ¸è¿›æ€§**
```
æ¼”è¿›åŸåˆ™ï¼š
- é€æ­¥æ›¿æ¢ï¼šä¸æ˜¯ä¸€æ¬¡æ€§é‡å†™æ‰€æœ‰ä»£ç 
- å‘åå…¼å®¹ï¼šæ–°æ—§ç³»ç»Ÿå¹¶å­˜ä¸€æ®µæ—¶é—´
- ç°åº¦å‘å¸ƒï¼šå°æµé‡éªŒè¯åå†å…¨é‡åˆ‡æ¢
- å›æ»šå‡†å¤‡ï¼šå‡ºç°é—®é¢˜èƒ½å¿«é€Ÿå›åˆ°åŸæœ‰æ¶æ„
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•ã€åº“å­˜ã€æ”¯ä»˜çš„åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **é‡‘èç³»ç»Ÿ**ï¼šè½¬è´¦ã€æ¸…ç®—çš„å¼ºä¸€è‡´æ€§è¦æ±‚
- **ç¤¾äº¤ç³»ç»Ÿ**ï¼šç”¨æˆ·æ•°æ®ã€å†…å®¹æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§
- **ç‰©æµç³»ç»Ÿ**ï¼šè®¢å•çŠ¶æ€ã€ä½ç½®ä¿¡æ¯çš„å®æ—¶åŒæ­¥

**ğŸ”§ æŠ€æœ¯é€‰å‹æŒ‡å¯¼**
- **å°å‹é¡¹ç›®**ï¼šå•ä½“æ¶æ„ + æœ¬åœ°äº‹åŠ¡
- **ä¸­å‹é¡¹ç›®**ï¼šè¯»å†™åˆ†ç¦» + æ¶ˆæ¯é˜Ÿåˆ—
- **å¤§å‹é¡¹ç›®**ï¼šå¾®æœåŠ¡ + åˆ†å¸ƒå¼äº‹åŠ¡
- **è¶…å¤§å‹é¡¹ç›®**ï¼šåˆ†åº“åˆ†è¡¨ + å¤šçº§ç¼“å­˜

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
- ä¼˜å…ˆè€ƒè™‘ä¸šåŠ¡å±‚é¢é¿å…åˆ†å¸ƒå¼äº‹åŠ¡
- åˆç†ä½¿ç”¨ç¼“å­˜æå‡æ€§èƒ½ï¼Œä½†è¦æ³¨æ„ä¸€è‡´æ€§
- ç›‘æ§å’Œå‘Šè­¦æ˜¯é«˜å¹¶å‘ç³»ç»Ÿçš„å¿…å¤‡ç»„ä»¶
- æ¶æ„æ¼”è¿›è¦å¾ªåºæ¸è¿›ï¼Œä¸è¦ä¸€æ­¥åˆ°ä½

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ•°æ®ä¸€è‡´æ€§ï¼Œä½†ä¼šç‰ºç‰²æ€§èƒ½
- è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨æ˜¯æå‡æ€§èƒ½çš„æœ‰æ•ˆæ‰‹æ®µ
- ç¼“å­˜èƒ½å¤§å¹…æå‡æ€§èƒ½ï¼Œä½†è¦å¤„ç†å¥½ä¸€è‡´æ€§é—®é¢˜
- æ¶æ„æ¼”è¿›è¦æ¸è¿›å¼ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šæ€§