---
title: 12ã€äº‹åŠ¡å¹¶å‘å¼‚å¸¸å®Œæ•´åˆ†ç±»
---
## ğŸ“š ç›®å½•

1. [å¹¶å‘å¼‚å¸¸ç†è®ºå®Œæ•´ä½“ç³»](#1-å¹¶å‘å¼‚å¸¸ç†è®ºå®Œæ•´ä½“ç³»)
2. [å†™åå·®Write Skewæ·±åº¦åˆ†æ](#2-å†™åå·®write-skewæ·±åº¦åˆ†æ)
3. [è¯»åå·®Read Skewæœºåˆ¶](#3-è¯»åå·®read-skewæœºåˆ¶)
4. [ä¸¢å¤±æ›´æ–°Lost Updateç»†åˆ†ç±»å‹](#4-ä¸¢å¤±æ›´æ–°lost-updateç»†åˆ†ç±»å‹)
5. [çº¦æŸè¿åå¼‚å¸¸](#5-çº¦æŸè¿åå¼‚å¸¸)
6. [å¼‚å¸¸ç­‰çº§åˆ†ç±»ä½“ç³»](#6-å¼‚å¸¸ç­‰çº§åˆ†ç±»ä½“ç³»)
7. [å¹¶å‘å¼‚å¸¸æ£€æµ‹ç®—æ³•](#7-å¹¶å‘å¼‚å¸¸æ£€æµ‹ç®—æ³•)
8. [ä¸šåŠ¡å±‚é¢å¹¶å‘å¼‚å¸¸](#8-ä¸šåŠ¡å±‚é¢å¹¶å‘å¼‚å¸¸)
9. [å¼‚å¸¸æ£€æµ‹ä¸é˜²æŠ¤æœºåˆ¶](#9-å¼‚å¸¸æ£€æµ‹ä¸é˜²æŠ¤æœºåˆ¶)
10. [å¼‚å¸¸å¤„ç†ç­–ç•¥æ¡†æ¶](#10-å¼‚å¸¸å¤„ç†ç­–ç•¥æ¡†æ¶)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§  å¹¶å‘å¼‚å¸¸ç†è®ºå®Œæ•´ä½“ç³»


### 1.1 å¹¶å‘å¼‚å¸¸çš„å®šä¹‰ä¸æœ¬è´¨


**ä»€ä¹ˆæ˜¯å¹¶å‘å¼‚å¸¸**ï¼šå½“å¤šä¸ªäº‹åŠ¡åŒæ—¶è®¿é—®æ•°æ®åº“æ—¶ï¼Œç”±äºç¼ºä¹é€‚å½“çš„éš”ç¦»æœºåˆ¶ï¼Œå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´æˆ–é€»è¾‘é”™è¯¯ç°è±¡ã€‚

**ç°å®ç”Ÿæ´»ç±»æ¯”**ï¼š
```
é“¶è¡ŒATMå–æ¬¾åœºæ™¯ï¼š
å¤«å¦»ä¸¤äººåŒæ—¶åœ¨ä¸åŒATMå–æ¬¾
è´¦æˆ·ä½™é¢ï¼š1000å…ƒ

ä¸ˆå¤«å–500å…ƒï¼šæŸ¥çœ‹ä½™é¢1000 â†’ è®¡ç®—1000-500=500 â†’ å†™å…¥500
å¦»å­å–600å…ƒï¼šæŸ¥çœ‹ä½™é¢1000 â†’ è®¡ç®—1000-600=400 â†’ å†™å…¥400

ç»“æœï¼šæœ€ç»ˆä½™é¢å¯èƒ½æ˜¯500æˆ–400ï¼Œè€Œä¸æ˜¯æ­£ç¡®çš„-100ï¼ˆé€æ”¯ï¼‰
è¿™å°±æ˜¯å…¸å‹çš„ä¸¢å¤±æ›´æ–°å¼‚å¸¸
```

### 1.2 å¹¶å‘å¼‚å¸¸çš„åˆ†ç±»ä½“ç³»


**ğŸ”¸ æŒ‰å½±å“èŒƒå›´åˆ†ç±»**
```
æ•°æ®çº§å¼‚å¸¸ï¼š
â”œâ”€ è„è¯»(Dirty Read)
â”œâ”€ ä¸å¯é‡å¤è¯»(Non-Repeatable Read)  
â”œâ”€ å¹»è¯»(Phantom Read)
â””â”€ ä¸¢å¤±æ›´æ–°(Lost Update)

é€»è¾‘çº§å¼‚å¸¸ï¼š
â”œâ”€ å†™åå·®(Write Skew)
â”œâ”€ è¯»åå·®(Read Skew)
â””â”€ çº¦æŸè¿å(Constraint Violation)

ä¸šåŠ¡çº§å¼‚å¸¸ï¼š
â”œâ”€ åº“å­˜è¶…å–
â”œâ”€ ä½™é¢é€æ”¯
â””â”€ é‡å¤è®¢å•
```

**ğŸ”¸ æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç±»**
```
ä¸¥é‡çº§åˆ«åˆ†å¸ƒï¼š

ğŸ”´ è‡´å‘½çº§(Critical)ï¼š
â€¢ æ•°æ®å®Œæ•´æ€§è¢«ç ´å
â€¢ ä¸šåŠ¡é€»è¾‘ä¸¥é‡é”™è¯¯
â€¢ ç¤ºä¾‹ï¼šé“¶è¡Œä½™é¢è®¡ç®—é”™è¯¯

ğŸŸ¡ é‡è¦çº§(Important)ï¼š
â€¢ æ•°æ®ä¸ä¸€è‡´ä½†ä¸è‡´å‘½
â€¢ å½±å“ç”¨æˆ·ä½“éªŒ
â€¢ ç¤ºä¾‹ï¼šå•†å“åº“å­˜æ˜¾ç¤ºé”™è¯¯

ğŸŸ¢ ä¸€èˆ¬çº§(Normal)ï¼š
â€¢ ä¸´æ—¶æ€§æ•°æ®ä¸ä¸€è‡´
â€¢ ä¸å½±å“æœ€ç»ˆç»“æœ
â€¢ ç¤ºä¾‹ï¼šæµè§ˆé‡ç»Ÿè®¡åå·®
```

### 1.3 å¹¶å‘å¼‚å¸¸çš„ç†è®ºåŸºç¡€


**ACIDå±æ€§ä¸å¹¶å‘å¼‚å¸¸çš„å…³ç³»**ï¼š
```
åŸå­æ€§(Atomicity) â†â†’ ä¸¢å¤±æ›´æ–°å¼‚å¸¸
ä¸€è‡´æ€§(Consistency) â†â†’ çº¦æŸè¿åå¼‚å¸¸  
éš”ç¦»æ€§(Isolation) â†â†’ æ‰€æœ‰å¹¶å‘å¼‚å¸¸
æŒä¹…æ€§(Durability) â†â†’ æ•°æ®ä¸¢å¤±å¼‚å¸¸

æ ¸å¿ƒå…³ç³»ï¼š
éš”ç¦»æ€§ä¸è¶³ â†’ å¹¶å‘å¼‚å¸¸äº§ç”Ÿ
å¹¶å‘å¼‚å¸¸ â†’ ä¸€è‡´æ€§è¢«ç ´å
```

**CAPç†è®ºåœ¨å¹¶å‘æ§åˆ¶ä¸­çš„ä½“ç°**ï¼š
```
ä¸€è‡´æ€§(Consistency)ï¼š
â€¢ å¼ºä¸€è‡´æ€§ â†’ ä¸¥æ ¼éš”ç¦» â†’ æ€§èƒ½ä¸‹é™
â€¢ å¼±ä¸€è‡´æ€§ â†’ å…è®¸å¼‚å¸¸ â†’ æ€§èƒ½æå‡

å¯ç”¨æ€§(Availability)ï¼š
â€¢ é«˜å¯ç”¨ â†’ å¹¶å‘åº¦é«˜ â†’ å¼‚å¸¸æ¦‚ç‡å¢åŠ 
â€¢ ä½å¯ç”¨ â†’ å¹¶å‘åº¦ä½ â†’ å¼‚å¸¸æ¦‚ç‡é™ä½

åˆ†åŒºå®¹é”™(Partition Tolerance)ï¼š
â€¢ åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¹¶å‘å¼‚å¸¸æ›´å¤æ‚
â€¢ ç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´æ•°æ®ä¸åŒæ­¥
```

---

## 2. ğŸ”€ å†™åå·®Write Skewæ·±åº¦åˆ†æ


### 2.1 å†™åå·®çš„æ ¸å¿ƒæ¦‚å¿µ


**å†™åå·®å®šä¹‰**ï¼šä¸¤ä¸ªäº‹åŠ¡è¯»å–ç›¸åŒçš„æ•°æ®é›†ï¼Œç„¶åå„è‡ªæ›´æ–°å…¶ä¸­çš„ä¸åŒå­é›†ï¼Œå¯¼è‡´æ•´ä½“çº¦æŸè¢«è¿åçš„ç°è±¡ã€‚

**ç»å…¸åŒ»é™¢å€¼ç­ç¤ºä¾‹**ï¼š
```
åŒ»é™¢è§„å®šï¼šè‡³å°‘è¦æœ‰1ååŒ»ç”Ÿå€¼ç­

åˆå§‹çŠ¶æ€ï¼š
åŒ»ç”ŸAï¼šå€¼ç­ä¸­
åŒ»ç”ŸBï¼šå€¼ç­ä¸­

æ—¶é—´çº¿ï¼š
T1        T2
äº‹åŠ¡1(åŒ»ç”ŸA)  äº‹åŠ¡2(åŒ»ç”ŸB)
â”‚           â”‚
â”œâ”€ æŸ¥è¯¢ï¼šå½“å‰å€¼ç­åŒ»ç”Ÿæ•° = 2
â”‚           â”œâ”€ æŸ¥è¯¢ï¼šå½“å‰å€¼ç­åŒ»ç”Ÿæ•° = 2
â”œâ”€ åˆ¤æ–­ï¼š2-1=1â‰¥1ï¼Œå¯ä»¥ä¸‹ç­
â”‚           â”œâ”€ åˆ¤æ–­ï¼š2-1=1â‰¥1ï¼Œå¯ä»¥ä¸‹ç­  
â”œâ”€ æ›´æ–°ï¼šAä¸‹ç­
â”‚           â”œâ”€ æ›´æ–°ï¼šBä¸‹ç­
â”‚           â”‚
æäº¤        æäº¤

ç»“æœï¼šæ²¡æœ‰åŒ»ç”Ÿå€¼ç­ï¼Œè¿åäº†"è‡³å°‘1ååŒ»ç”Ÿ"çš„çº¦æŸ
```

### 2.2 å†™åå·®çš„æŠ€æœ¯åŸç†


**ğŸ”¸ å†™åå·®å‘ç”Ÿçš„æ¡ä»¶**
```
å¿…è¦æ¡ä»¶ï¼š
1. å¤šä¸ªäº‹åŠ¡è¯»å–é‡å çš„æ•°æ®é›†
2. äº‹åŠ¡åŸºäºè¯»å–çš„æ•°æ®åšå‡ºå†³ç­–
3. äº‹åŠ¡æ›´æ–°ä¸åŒçš„æ•°æ®é¡¹
4. å­˜åœ¨è·¨è®°å½•çš„çº¦æŸæ¡ä»¶
5. éš”ç¦»çº§åˆ«ä¸è¶³ä»¥é˜²æ­¢æ­¤ç±»å¼‚å¸¸

æŠ€æœ¯å®è´¨ï¼š
è¯»å–é›†åˆ âˆ© å†™å…¥é›†åˆ = âˆ…ï¼ˆç©ºé›†ï¼‰
è¿™ä½¿å¾—ä¼ ç»Ÿçš„è¯»å†™é”æ— æ³•æ£€æµ‹åˆ°å†²çª
```

**ğŸ”¸ å†™åå·®çš„æ•°æ®åº“å®ç°åŸç†**
```sql
-- åŒ»ç”Ÿå€¼ç­åœºæ™¯çš„SQLå®ç°
-- äº‹åŠ¡1ï¼ˆåŒ»ç”ŸAä¸‹ç­ï¼‰
BEGIN;
SELECT COUNT(*) FROM doctors WHERE on_duty = true; -- ç»“æœï¼š2
-- åŸºäºæŸ¥è¯¢ç»“æœåˆ¤æ–­å¯ä»¥ä¸‹ç­
UPDATE doctors SET on_duty = false WHERE doctor_id = 'A';
COMMIT;

-- äº‹åŠ¡2ï¼ˆåŒ»ç”ŸBä¸‹ç­ï¼‰åŒæ—¶æ‰§è¡Œ
BEGIN; 
SELECT COUNT(*) FROM doctors WHERE on_duty = true; -- ç»“æœï¼š2
-- åŸºäºæŸ¥è¯¢ç»“æœåˆ¤æ–­å¯ä»¥ä¸‹ç­
UPDATE doctors SET on_duty = false WHERE doctor_id = 'B';
COMMIT;

-- æœ€ç»ˆç»“æœï¼šCOUNT(*) = 0ï¼Œè¿åçº¦æŸ
```

### 2.3 å†™åå·®çš„å˜ç§ç±»å‹


**ğŸ”¸ é€‰æ‹©æ€§å†™åå·®**
```
åœºæ™¯ï¼šä¼šè®®å®¤é¢„è®¢ç³»ç»Ÿ
çº¦æŸï¼šåŒä¸€æ—¶é—´æ®µå†…ä¼šè®®å®¤ä¸èƒ½è¢«é‡å¤é¢„è®¢

äº‹åŠ¡Aï¼šæŸ¥è¯¢ä¼šè®®å®¤Xåœ¨14:00-15:00çš„é¢„è®¢æƒ…å†µ â†’ ç©ºé—² â†’ é¢„è®¢
äº‹åŠ¡Bï¼šæŸ¥è¯¢ä¼šè®®å®¤Xåœ¨14:00-15:00çš„é¢„è®¢æƒ…å†µ â†’ ç©ºé—² â†’ é¢„è®¢

ç»“æœï¼šåŒä¸€æ—¶é—´æ®µè¢«é‡å¤é¢„è®¢
```

**ğŸ”¸ ç´¯ç§¯æ€§å†™åå·®**
```
åœºæ™¯ï¼šé“¶è¡Œè´¦æˆ·ä½™é¢æ£€æŸ¥
çº¦æŸï¼šè”åˆè´¦æˆ·æ€»ä½™é¢ä¸èƒ½ä¸ºè´Ÿ

è´¦æˆ·Aä½™é¢ï¼š1000å…ƒï¼Œè´¦æˆ·Bä½™é¢ï¼š1000å…ƒï¼Œä¿¡ç”¨é¢åº¦ï¼š500å…ƒ

äº‹åŠ¡1ï¼šæŸ¥è¯¢æ€»ä½™é¢2000å…ƒ â†’ åˆ¤æ–­å¯å–1500å…ƒ â†’ ä»è´¦æˆ·Aå–1500å…ƒ
äº‹åŠ¡2ï¼šæŸ¥è¯¢æ€»ä½™é¢2000å…ƒ â†’ åˆ¤æ–­å¯å–1500å…ƒ â†’ ä»è´¦æˆ·Bå–1500å…ƒ

ç»“æœï¼šæ€»ä½™é¢-1000å…ƒï¼Œè¶…å‡ºä¿¡ç”¨é¢åº¦
```

### 2.4 å†™åå·®æ£€æµ‹æ–¹æ³•


**ğŸ”¸ çº¦æŸä¾èµ–åˆ†æ**
```
æ£€æµ‹ç®—æ³•ï¼š
1. è¯†åˆ«äº‹åŠ¡çš„è¯»å–é›†(Read Set)
2. è¯†åˆ«äº‹åŠ¡çš„å†™å…¥é›†(Write Set)  
3. æ£€æŸ¥æ˜¯å¦å­˜åœ¨çº¦æŸä¾èµ–å…³ç³»
4. éªŒè¯çº¦æŸåœ¨å¹¶å‘æ‰§è¡Œåæ˜¯å¦ä»ç„¶æˆç«‹

ä¼ªä»£ç ï¼š
function detectWriteSkew(transaction1, transaction2) {
    readSet1 = transaction1.getReadSet();
    writeSet1 = transaction1.getWriteSet();
    readSet2 = transaction2.getReadSet();
    writeSet2 = transaction2.getWriteSet();
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†™åå·®æ¨¡å¼
    if (readSet1.intersects(readSet2) && 
        !writeSet1.intersects(writeSet2)) {
        return checkConstraintViolation();
    }
}
```

---

## 3. ğŸ“– è¯»åå·®Read Skewæœºåˆ¶


### 3.1 è¯»åå·®çš„å®šä¹‰ä¸ç‰¹å¾


**è¯»åå·®å®šä¹‰**ï¼šåŒä¸€äº‹åŠ¡å†…çš„å¤šæ¬¡è¯»å–ï¼Œçœ‹åˆ°äº†æ•°æ®çš„ä¸ä¸€è‡´çŠ¶æ€ï¼Œå³è¯»å–åˆ°äº†å…¶ä»–äº‹åŠ¡éƒ¨åˆ†æäº¤çš„ç»“æœã€‚

**ç»å…¸è½¬è´¦ç¤ºä¾‹**ï¼š
```
è´¦æˆ·çŠ¶æ€ï¼š
è´¦æˆ·Aï¼š1000å…ƒ
è´¦æˆ·Bï¼š2000å…ƒ
æ€»é¢ï¼š3000å…ƒ

è½¬è´¦äº‹åŠ¡ï¼ˆAè½¬ç»™B 500å…ƒï¼‰ï¼š
1. A = 1000 - 500 = 500å…ƒ
2. B = 2000 + 500 = 2500å…ƒ

è¯»å–äº‹åŠ¡åœ¨è½¬è´¦è¿›è¡Œä¸­æŸ¥è¯¢ï¼š
æ—¶é—´ç‚¹1ï¼šè¯»å–Aè´¦æˆ· = 500å…ƒï¼ˆå·²æ›´æ–°ï¼‰
æ—¶é—´ç‚¹2ï¼šè¯»å–Bè´¦æˆ· = 2000å…ƒï¼ˆæœªæ›´æ–°ï¼‰
è®¡ç®—æ€»é¢ï¼š500 + 2000 = 2500å…ƒï¼ˆé”™è¯¯ï¼åº”è¯¥æ˜¯3000å…ƒï¼‰

é—®é¢˜ï¼šè¯»å–äº‹åŠ¡çœ‹åˆ°äº†ä¸ä¸€è‡´çš„ä¸­é—´çŠ¶æ€
```

### 3.2 è¯»åå·®çš„æŠ€æœ¯æœºåˆ¶


**ğŸ”¸ è¯»åå·®å‘ç”Ÿçš„æ—¶æœº**
```
å…¸å‹æ—¶åºå›¾ï¼š

äº‹åŠ¡T1(è½¬è´¦)    äº‹åŠ¡T2(æŸ¥è¯¢æ€»é¢)
    â”‚              â”‚
    â”œâ”€ æ›´æ–°Aè´¦æˆ·    â”‚
    â”‚              â”œâ”€ è¯»å–Aè´¦æˆ·ï¼ˆå·²æ›´æ–°ï¼‰
    â”œâ”€ æ›´æ–°Bè´¦æˆ·    â”‚
    â”‚              â”œâ”€ è¯»å–Bè´¦æˆ·ï¼ˆæœªæ›´æ–°ï¼‰
    â”œâ”€ æäº¤        â”‚
    â”‚              â”œâ”€ è®¡ç®—æ€»é¢ï¼ˆé”™è¯¯ï¼‰
    â”‚              â”‚

å…³é”®ï¼šT2åœ¨T1çš„æ‰§è¡Œè¿‡ç¨‹ä¸­è¯»å–æ•°æ®
```

**ğŸ”¸ è¯»åå·®ä¸ä¸å¯é‡å¤è¯»çš„åŒºåˆ«**
```
ä¸å¯é‡å¤è¯»ï¼š
â€¢ åŒä¸€æ•°æ®é¡¹çš„å¤šæ¬¡è¯»å–ç»“æœä¸åŒ
â€¢ é’ˆå¯¹å•ä¸ªæ•°æ®é¡¹
â€¢ ç¤ºä¾‹ï¼šè¯»å–ä½™é¢1000ï¼Œå†æ¬¡è¯»å–å˜æˆ800

è¯»åå·®ï¼š
â€¢ å¤šä¸ªç›¸å…³æ•°æ®é¡¹çš„è¯»å–ä¸ä¸€è‡´
â€¢ é’ˆå¯¹æ•°æ®é›†åˆ
â€¢ ç¤ºä¾‹ï¼šè¯»å–Aè´¦æˆ·500ï¼ŒBè´¦æˆ·2000ï¼Œæ€»é¢ä¸ç¬¦åˆä¸šåŠ¡é€»è¾‘
```

### 3.3 è¯»åå·®çš„ä¸šåŠ¡å½±å“


**ğŸ”¸ æŠ¥è¡¨ç”Ÿæˆåœºæ™¯**
```sql
-- ç”Ÿæˆè´¢åŠ¡æŠ¥è¡¨çš„æŸ¥è¯¢
SELECT 
    SUM(debit_amount) as total_debit,
    SUM(credit_amount) as total_credit,
    SUM(debit_amount) - SUM(credit_amount) as balance
FROM account_transactions 
WHERE report_date = '2024-01-31';

-- å¦‚æœåœ¨æŸ¥è¯¢æœŸé—´æœ‰äº‹åŠ¡æ­£åœ¨å¤„ç†ï¼š
-- 1. å…ˆæ›´æ–°äº†debit_amount
-- 2. è¿˜æœªæ›´æ–°credit_amount
-- ç»“æœï¼šæŠ¥è¡¨æ˜¾ç¤ºé”™è¯¯çš„ä½™é¢
```

**ğŸ”¸ åº“å­˜ç›˜ç‚¹åœºæ™¯**
```
ä»“åº“ç›˜ç‚¹ç³»ç»Ÿï¼š
1. æŸ¥è¯¢åŸææ–™åº“å­˜ï¼š1000ä»¶
2. æŸ¥è¯¢äº§å“åº“å­˜ï¼š500ä»¶
3. è®¡ç®—æ€»ä»·å€¼ï¼š1000*10 + 500*50 = 35000å…ƒ

åœ¨ç›˜ç‚¹æœŸé—´ï¼Œç”Ÿäº§äº‹åŠ¡æ‰§è¡Œï¼š
1. æ¶ˆè€—åŸææ–™100ä»¶ â†’ 900ä»¶
2. ç”Ÿäº§äº§å“50ä»¶ â†’ 550ä»¶

å¦‚æœç›˜ç‚¹äº‹åŠ¡è¯»å–åˆ°ä¸­é—´çŠ¶æ€ï¼š
åŸææ–™ï¼š900ä»¶ï¼Œäº§å“ï¼š500ä»¶
è®¡ç®—æ€»ä»·å€¼ï¼š900*10 + 500*50 = 34000å…ƒï¼ˆé”™è¯¯ï¼‰
```

### 3.4 è¯»åå·®çš„é˜²æŠ¤ç­–ç•¥


**ğŸ”¸ å¿«ç…§éš”ç¦»**
```sql
-- ä½¿ç”¨å¿«ç…§éš”ç¦»é˜²æ­¢è¯»åå·®
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
-- æ‰€æœ‰è¯»å–æ“ä½œéƒ½åŸºäºäº‹åŠ¡å¼€å§‹æ—¶çš„å¿«ç…§
SELECT * FROM accounts WHERE account_type = 'savings';
-- ... å…¶ä»–è¯»å–æ“ä½œ
COMMIT;
```

**ğŸ”¸ è¯»é”ç­–ç•¥**
```sql
-- ä½¿ç”¨å…±äº«é”ç¡®ä¿è¯»å–ä¸€è‡´æ€§
BEGIN;
SELECT * FROM accounts WHERE account_id IN ('A', 'B') FOR SHARE;
-- è®¡ç®—æ€»é¢ç­‰ä¸šåŠ¡é€»è¾‘
COMMIT;
```

---

## 4. ğŸ’” ä¸¢å¤±æ›´æ–°Lost Updateç»†åˆ†ç±»å‹


### 4.1 ä¸¢å¤±æ›´æ–°çš„åŸºæœ¬æ¦‚å¿µ


**ä¸¢å¤±æ›´æ–°å®šä¹‰**ï¼šä¸¤ä¸ªäº‹åŠ¡è¯»å–åŒä¸€æ•°æ®ï¼Œç„¶åéƒ½å°è¯•æ›´æ–°å®ƒï¼Œåæäº¤çš„äº‹åŠ¡è¦†ç›–äº†å‰ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ï¼Œå¯¼è‡´æ›´æ–°ä¸¢å¤±ã€‚

**ç»å…¸åº“å­˜æ›´æ–°ç¤ºä¾‹**ï¼š
```
å•†å“åº“å­˜ï¼š100ä»¶

äº‹åŠ¡Aï¼ˆå–å‡º30ä»¶ï¼‰ï¼š
1. è¯»å–åº“å­˜ï¼š100ä»¶
2. è®¡ç®—ï¼š100-30=70ä»¶  
3. å†™å…¥ï¼š70ä»¶

äº‹åŠ¡Bï¼ˆå–å‡º50ä»¶ï¼‰ï¼š
1. è¯»å–åº“å­˜ï¼š100ä»¶
2. è®¡ç®—ï¼š100-50=50ä»¶
3. å†™å…¥ï¼š50ä»¶

å¦‚æœBåæäº¤ï¼šæœ€ç»ˆåº“å­˜50ä»¶
å®é™…åº”è¯¥ï¼š100-30-50=20ä»¶
ä¸¢å¤±äº†Açš„æ›´æ–°
```

### 4.2 ä¸¢å¤±æ›´æ–°çš„è¯¦ç»†åˆ†ç±»


**ğŸ”¸ ç¬¬ä¸€ç±»ä¸¢å¤±æ›´æ–°ï¼ˆè„å†™ï¼‰**
```
ç‰¹å¾ï¼šä¸€ä¸ªäº‹åŠ¡è¦†ç›–å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹

æ—¶åºï¼š
äº‹åŠ¡A    äº‹åŠ¡B
â”‚        â”‚
â”œâ”€è¯»å–X=10
â”‚        â”œâ”€è¯»å–X=10  
â”œâ”€å†™å…¥X=20
â”‚        â”œâ”€å†™å…¥X=30ï¼ˆè¦†ç›–äº†Açš„ä¿®æ”¹ï¼‰
â”œâ”€å›æ»š     â”‚
â”‚        â”œâ”€æäº¤
â”‚        â”‚

ç»“æœï¼šX=30ï¼Œä½†Aå›æ»šäº†ï¼Œé€»è¾‘ä¸ŠXåº”è¯¥=10
```

**ğŸ”¸ ç¬¬äºŒç±»ä¸¢å¤±æ›´æ–°ï¼ˆè¦†ç›–å†™ï¼‰**
```
ç‰¹å¾ï¼šä¸€ä¸ªäº‹åŠ¡è¦†ç›–å¦ä¸€ä¸ªå·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹

æ—¶åºï¼š
äº‹åŠ¡A    äº‹åŠ¡B  
â”‚        â”‚
â”œâ”€è¯»å–X=10
â”‚        â”œâ”€è¯»å–X=10
â”œâ”€å†™å…¥X=20
â”œâ”€æäº¤    â”‚
â”‚        â”œâ”€å†™å…¥X=30
â”‚        â”œâ”€æäº¤

ç»“æœï¼šX=30ï¼ŒAçš„ä¿®æ”¹è¢«å®Œå…¨è¦†ç›–
```

**ğŸ”¸ ç´¯ç§¯ä¸¢å¤±æ›´æ–°**
```
ç‰¹å¾ï¼šå¤šä¸ªäº‹åŠ¡çš„ç´¯ç§¯ä¿®æ”¹éƒ¨åˆ†ä¸¢å¤±

åœºæ™¯ï¼šè®¡æ•°å™¨æ›´æ–°
åˆå§‹å€¼ï¼šcounter = 100

äº‹åŠ¡Aï¼šcounter += 10 â†’ åº”è¯¥å˜æˆ110
äº‹åŠ¡Bï¼šcounter += 20 â†’ åº”è¯¥å˜æˆ130  
äº‹åŠ¡Cï¼šcounter += 5  â†’ åº”è¯¥å˜æˆ135

å¦‚æœå‘ç”Ÿä¸¢å¤±æ›´æ–°ï¼šæœ€ç»ˆå¯èƒ½åªæ˜¯125ï¼ˆåªä¿ç•™äº†éƒ¨åˆ†æ›´æ–°ï¼‰
æ­£ç¡®ç»“æœåº”è¯¥æ˜¯ï¼š135
```

### 4.3 ä¸¢å¤±æ›´æ–°çš„æ£€æµ‹æœºåˆ¶


**ğŸ”¸ åŸºäºç‰ˆæœ¬å·çš„æ£€æµ‹**
```sql
-- ä½¿ç”¨ç‰ˆæœ¬å·é˜²æ­¢ä¸¢å¤±æ›´æ–°
UPDATE products 
SET stock = stock - 30, version = version + 1
WHERE product_id = 'P001' AND version = @current_version;

-- å¦‚æœå½±å“è¡Œæ•°ä¸º0ï¼Œè¯´æ˜å‘ç”Ÿäº†ä¸¢å¤±æ›´æ–°
IF $$ROWCOUNT = 0
    THROW 50001, 'Concurrent update detected', 1;
```

**ğŸ”¸ åŸºäºæ—¶é—´æˆ³çš„æ£€æµ‹**
```sql
-- ä½¿ç”¨æœ€åä¿®æ”¹æ—¶é—´æ£€æµ‹
UPDATE accounts 
SET balance = balance - 100, 
    last_modified = NOW()
WHERE account_id = 'A001' 
  AND last_modified = @read_timestamp;
```

### 4.4 ä¸¢å¤±æ›´æ–°çš„é˜²æŠ¤æ–¹æ³•


**ğŸ”¸ åŸå­æ“ä½œ**
```sql
-- ä½¿ç”¨åŸå­æ“ä½œé¿å…ä¸¢å¤±æ›´æ–°
UPDATE products 
SET stock = stock - @quantity 
WHERE product_id = @pid AND stock >= @quantity;

-- æ£€æŸ¥æ˜¯å¦æˆåŠŸ
IF $$ROWCOUNT = 0
    THROW 50002, 'Insufficient stock', 1;
```

**ğŸ”¸ æ¯”è¾ƒå¹¶äº¤æ¢(CAS)**
```java
// Javaä¸­çš„CASæ“ä½œç¤ºä¾‹
public boolean updateStock(String productId, int reduceAmount) {
    while (true) {
        Product product = getProduct(productId);
        int currentStock = product.getStock();
        int newStock = currentStock - reduceAmount;
        
        if (newStock < 0) return false; // åº“å­˜ä¸è¶³
        
        // å°è¯•CASæ›´æ–°
        if (compareAndSwap(productId, currentStock, newStock)) {
            return true; // æ›´æ–°æˆåŠŸ
        }
        // CASå¤±è´¥ï¼Œé‡è¯•
    }
}
```

---

## 5. âš ï¸ çº¦æŸè¿åå¼‚å¸¸


### 5.1 çº¦æŸè¿åçš„å®šä¹‰ä¸åˆ†ç±»


**çº¦æŸè¿åå®šä¹‰**ï¼šç”±äºå¹¶å‘äº‹åŠ¡çš„æ‰§è¡Œï¼Œå¯¼è‡´æ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸè¢«è¿åï¼Œæ•°æ®è¿›å…¥ä¸ä¸€è‡´çŠ¶æ€ã€‚

**çº¦æŸç±»å‹åˆ†ç±»**ï¼š
```
æ•°æ®åº“çº¦æŸï¼š
â”œâ”€ ä¸»é”®çº¦æŸ(Primary Key)
â”œâ”€ å¤–é”®çº¦æŸ(Foreign Key)  
â”œâ”€ å”¯ä¸€æ€§çº¦æŸ(Unique)
â”œâ”€ æ£€æŸ¥çº¦æŸ(Check)
â””â”€ éç©ºçº¦æŸ(Not Null)

ä¸šåŠ¡çº¦æŸï¼š
â”œâ”€ ä½™é¢éè´Ÿçº¦æŸ
â”œâ”€ åº“å­˜éè´Ÿçº¦æŸ
â”œâ”€ ç”¨æˆ·è§’è‰²ä¸€è‡´æ€§
â””â”€ å·¥ä½œæµçŠ¶æ€çº¦æŸ
```

### 5.2 çº¦æŸè¿åçš„å…¸å‹åœºæ™¯


**ğŸ”¸ å¤–é”®çº¦æŸè¿å**
```
åœºæ™¯ï¼šè®¢å•å’Œå®¢æˆ·å…³ç³»

æ­£å¸¸æµç¨‹ï¼š
1. å®¢æˆ·å­˜åœ¨ â†’ åˆ›å»ºè®¢å• â†’ å»ºç«‹å¤–é”®å…³ç³»

å¼‚å¸¸æƒ…å†µï¼š
äº‹åŠ¡Aï¼šåˆ é™¤å®¢æˆ·è®°å½•
äº‹åŠ¡Bï¼šä¸ºè¯¥å®¢æˆ·åˆ›å»ºè®¢å•

å¦‚æœBåœ¨Aæäº¤åæ‰§è¡Œï¼š
INSERT INTO orders (customer_id, amount) VALUES (deleted_customer_id, 100);
-- è¿åå¤–é”®çº¦æŸ
```

**ğŸ”¸ ä¸šåŠ¡çº¦æŸè¿å**
```sql
-- é“¶è¡Œè´¦æˆ·ä½™é¢çº¦æŸï¼šä½™é¢ä¸èƒ½ä¸ºè´Ÿ
-- åœºæ™¯ï¼šå¤«å¦»å…±åŒè´¦æˆ·åŒæ—¶å–æ¬¾

-- äº‹åŠ¡Aï¼ˆå¦»å­å–æ¬¾500ï¼‰
BEGIN;
SELECT balance FROM accounts WHERE account_id = 'JOINT001'; -- 600å…ƒ
UPDATE accounts 
SET balance = balance - 500 
WHERE account_id = 'JOINT001'; -- ä½™é¢å˜æˆ100å…ƒ
COMMIT;

-- äº‹åŠ¡Bï¼ˆä¸ˆå¤«å–æ¬¾400ï¼‰
BEGIN;
SELECT balance FROM accounts WHERE account_id = 'JOINT001'; -- 600å…ƒ
UPDATE accounts 
SET balance = balance - 400 
WHERE account_id = 'JOINT001'; -- ä½™é¢å˜æˆ200å…ƒï¼Ÿ
COMMIT;

-- å®é™…ç»“æœï¼šä½™é¢å¯èƒ½å˜æˆè´Ÿæ•°ï¼Œè¿åä¸šåŠ¡çº¦æŸ
```

### 5.3 çº¦æŸè¿åçš„æ£€æµ‹ç­–ç•¥


**ğŸ”¸ å³æ—¶æ£€æµ‹**
```sql
-- åœ¨æ¯ä¸ªä¿®æ”¹æ“ä½œåç«‹å³æ£€æŸ¥çº¦æŸ
UPDATE accounts SET balance = balance - @amount 
WHERE account_id = @account_id;

-- ç«‹å³æ£€æŸ¥çº¦æŸ
IF (SELECT balance FROM accounts WHERE account_id = @account_id) < 0
BEGIN
    ROLLBACK;
    THROW 50003, 'Account balance cannot be negative', 1;
END
```

**ğŸ”¸ å»¶è¿Ÿæ£€æµ‹**
```sql
-- åœ¨äº‹åŠ¡æäº¤å‰æ£€æŸ¥æ‰€æœ‰çº¦æŸ
-- è®¾ç½®å»¶è¿Ÿçº¦æŸæ£€æŸ¥
SET CONSTRAINTS ALL DEFERRED;

BEGIN;
-- æ‰§è¡Œå¯èƒ½è¿åçº¦æŸçš„æ“ä½œ
UPDATE accounts SET balance = balance - 1000 WHERE account_id = 'A001';
UPDATE accounts SET balance = balance + 1000 WHERE account_id = 'A002';

-- æäº¤æ—¶æ£€æŸ¥æ‰€æœ‰çº¦æŸ
COMMIT; -- å¦‚æœæœ‰çº¦æŸè¿åï¼Œè¿™é‡Œä¼šå¤±è´¥
```

### 5.4 çº¦æŸç»´æŠ¤æœºåˆ¶


**ğŸ”¸ è¡¥å¿æœºåˆ¶**
```java
// çº¦æŸè¿åçš„è¡¥å¿å¤„ç†
public class ConstraintViolationHandler {
    
    public void handleBalanceViolation(String accountId, double amount) {
        try {
            // å°è¯•ä»å…³è”è´¦æˆ·è½¬è´¦è¡¥å¿
            transferFromLinkedAccount(accountId, amount);
        } catch (InsufficientFundsException e) {
            // è§¦å‘é€æ”¯ä¿æŠ¤æœºåˆ¶
            activateOverdraftProtection(accountId, amount);
        }
    }
    
    public void handleStockViolation(String productId, int quantity) {
        // è‡ªåŠ¨è¡¥è´§
        scheduleRestocking(productId, quantity);
        // é€šçŸ¥åº“å­˜ç®¡ç†å‘˜
        notifyInventoryManager(productId, quantity);
    }
}
```

---

## 6. ğŸ“Š å¼‚å¸¸ç­‰çº§åˆ†ç±»ä½“ç³»


### 6.1 å¼‚å¸¸ä¸¥é‡ç¨‹åº¦åˆ†çº§


**ğŸ”¸ ä¸¥é‡ç¨‹åº¦çŸ©é˜µ**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼‚å¸¸ç±»å‹     â”‚ æ•°æ®å½±å“     â”‚ ä¸šåŠ¡å½±å“     â”‚ ä¸¥é‡ç­‰çº§     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è„å†™        â”‚ æ•°æ®æŸå     â”‚ é€»è¾‘é”™è¯¯     â”‚ ğŸ”´ è‡´å‘½      â”‚
â”‚ ä¸¢å¤±æ›´æ–°     â”‚ æ•°æ®ä¸¢å¤±     â”‚ é‡‘é¢é”™è¯¯     â”‚ ğŸ”´ è‡´å‘½      â”‚
â”‚ å†™åå·®      â”‚ çº¦æŸè¿å     â”‚ è§„åˆ™ç ´å     â”‚ ğŸŸ¡ ä¸¥é‡      â”‚
â”‚ è¯»åå·®      â”‚ ä¸´æ—¶ä¸ä¸€è‡´   â”‚ æŠ¥è¡¨é”™è¯¯     â”‚ ğŸŸ¡ ä¸¥é‡      â”‚
â”‚ å¹»è¯»        â”‚ è®°å½•æ•°å¼‚å¸¸   â”‚ ç»Ÿè®¡åå·®     â”‚ ğŸŸ¢ ä¸€èˆ¬      â”‚
â”‚ ä¸å¯é‡å¤è¯»   â”‚ å€¼å˜åŒ–      â”‚ æŸ¥è¯¢ä¸ç¨³å®š   â”‚ ğŸŸ¢ ä¸€èˆ¬      â”‚
â”‚ è„è¯»        â”‚ æœªæäº¤æ•°æ®   â”‚ ä¸´æ—¶é”™è¯¯     â”‚ ğŸŸ¢ ä¸€èˆ¬      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å¼‚å¸¸å½±å“èŒƒå›´åˆ†æ


**ğŸ”¸ å½±å“èŒƒå›´å±‚æ¬¡**
```
ç³»ç»Ÿçº§å½±å“ï¼š
â€¢ æ•°æ®åº“å®Œæ•´æ€§è¢«ç ´å
â€¢ ç³»ç»Ÿæ€§èƒ½ä¸¥é‡ä¸‹é™
â€¢ æœåŠ¡ä¸å¯ç”¨

åº”ç”¨çº§å½±å“ï¼š
â€¢ ä¸šåŠ¡é€»è¾‘é”™è¯¯
â€¢ åŠŸèƒ½å¼‚å¸¸
â€¢ ç”¨æˆ·ä½“éªŒä¸‹é™

äº‹åŠ¡çº§å½±å“ï¼š
â€¢ å•ä¸ªäº‹åŠ¡é”™è¯¯
â€¢ æ•°æ®ä¸ä¸€è‡´
â€¢ æ“ä½œå¤±è´¥
```

### 6.3 å¼‚å¸¸å¤„ç†ä¼˜å…ˆçº§


**ğŸ”¸ å¤„ç†ä¼˜å…ˆçº§é˜Ÿåˆ—**
```
å¤„ç†ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

P0 - ç´§æ€¥ï¼š
â€¢ é‡‘èäº¤æ˜“é”™è¯¯
â€¢ æ•°æ®å®Œæ•´æ€§ç ´å
â€¢ å®‰å…¨ç›¸å…³å¼‚å¸¸

P1 - é‡è¦ï¼š
â€¢ ä¸šåŠ¡çº¦æŸè¿å
â€¢ åº“å­˜ç®¡ç†é”™è¯¯
â€¢ ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´

P2 - ä¸€èˆ¬ï¼š
â€¢ ç»Ÿè®¡æ•°æ®åå·®
â€¢ æŠ¥è¡¨ä¸´æ—¶é”™è¯¯
â€¢ ç¼“å­˜ä¸ä¸€è‡´

P3 - ä½ä¼˜å…ˆçº§ï¼š
â€¢ æ—¥å¿—è®°å½•å¼‚å¸¸
â€¢ ç›‘æ§æ•°æ®åå·®
â€¢ éå…³é”®åŠŸèƒ½å¼‚å¸¸
```

---

## 7. ğŸ” å¹¶å‘å¼‚å¸¸æ£€æµ‹ç®—æ³•


### 7.1 é™æ€æ£€æµ‹ç®—æ³•


**ğŸ”¸ ä¾èµ–å›¾åˆ†æ**
```
ç®—æ³•åŸç†ï¼šæ„å»ºäº‹åŠ¡é—´çš„ä¾èµ–å…³ç³»å›¾ï¼Œæ£€æµ‹å¯èƒ½çš„å¼‚å¸¸æ¨¡å¼

ä¼ªä»£ç ï¼š
function buildDependencyGraph(transactions) {
    graph = new Graph();
    
    for (t1 in transactions) {
        for (t2 in transactions) {
            if (hasConflict(t1, t2)) {
                graph.addEdge(t1, t2, getConflictType(t1, t2));
            }
        }
    }
    
    return graph;
}

function detectAnomalies(graph) {
    // æ£€æµ‹ç¯è·¯ï¼ˆå¯èƒ½çš„æ­»é”ï¼‰
    cycles = graph.findCycles();
    
    // æ£€æµ‹å¼‚å¸¸æ¨¡å¼
    writeSkews = detectWriteSkewPattern(graph);
    lostUpdates = detectLostUpdatePattern(graph);
    
    return {cycles, writeSkews, lostUpdates};
}
```

### 7.2 åŠ¨æ€æ£€æµ‹ç®—æ³•


**ğŸ”¸ è¿è¡Œæ—¶ç›‘æ§**
```java
// è¿è¡Œæ—¶å¼‚å¸¸æ£€æµ‹å™¨
public class RuntimeAnomalyDetector {
    
    private Map<String, TransactionInfo> activeTransactions = new ConcurrentHashMap<>();
    
    public void onTransactionStart(String txnId) {
        activeTransactions.put(txnId, new TransactionInfo(txnId));
    }
    
    public void onRead(String txnId, String resourceId, Object value) {
        TransactionInfo txn = activeTransactions.get(txnId);
        txn.addRead(resourceId, value);
        
        // æ£€æµ‹è¯»åå·®
        checkReadSkew(txn);
    }
    
    public void onWrite(String txnId, String resourceId, Object value) {
        TransactionInfo txn = activeTransactions.get(txnId);
        txn.addWrite(resourceId, value);
        
        // æ£€æµ‹å†™å†²çª
        checkWriteConflicts(txn);
    }
    
    private void checkWriteSkew(TransactionInfo txn) {
        // æ£€æŸ¥å†™åå·®æ¨¡å¼
        if (hasWriteSkewPattern(txn)) {
            alertManager.raiseAlert("Write skew detected", txn);
        }
    }
}
```

### 7.3 æœºå™¨å­¦ä¹ æ£€æµ‹


**ğŸ”¸ å¼‚å¸¸æ¨¡å¼å­¦ä¹ **
```
ç‰¹å¾æå–ï¼š
â€¢ è¯»å†™é›†åˆå¤§å°
â€¢ è®¿é—®æ¨¡å¼é¢‘ç‡
â€¢ äº‹åŠ¡æ‰§è¡Œæ—¶é—´
â€¢ å†²çªå‘ç”Ÿæ¦‚ç‡

æ¨¡å‹è®­ç»ƒï¼š
1. æ”¶é›†å†å²å¼‚å¸¸æ•°æ®
2. æå–ç‰¹å¾å‘é‡
3. è®­ç»ƒåˆ†ç±»æ¨¡å‹
4. éªŒè¯æ¨¡å‹å‡†ç¡®æ€§

å®æ—¶é¢„æµ‹ï¼š
1. ç›‘æ§äº‹åŠ¡è¡Œä¸º
2. è®¡ç®—ç‰¹å¾å‘é‡
3. æ¨¡å‹é¢„æµ‹å¼‚å¸¸æ¦‚ç‡
4. è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
```

---

## 8. ğŸ¢ ä¸šåŠ¡å±‚é¢å¹¶å‘å¼‚å¸¸


### 8.1 ä¸šåŠ¡å¹¶å‘å¼‚å¸¸åˆ†ç±»


**ğŸ”¸ èµ„æºç«äº‰ç±»å¼‚å¸¸**
```
åº“å­˜è¶…å–ï¼š
â€¢ å•†å“åº“å­˜100ä»¶
â€¢ åŒæ—¶100ä¸ªè®¢å•ï¼Œæ¯ä¸ªè´­ä¹°1ä»¶  
â€¢ ç»“æœï¼šå¯èƒ½äº§ç”Ÿ105ä¸ªæˆåŠŸè®¢å•
â€¢ åæœï¼šåº“å­˜ä¸ºè´Ÿï¼Œæ— æ³•å‘è´§

åº§ä½é‡å¤é¢„è®¢ï¼š
â€¢ ç”µå½±é™¢åº§ä½A1
â€¢ åŒæ—¶å¤šäººé¢„è®¢
â€¢ ç»“æœï¼šä¸€ä¸ªåº§ä½å¤šå¼ ç¥¨
â€¢ åæœï¼šç°åœºå†²çªï¼Œç”¨æˆ·æŠ•è¯‰
```

**ğŸ”¸ çŠ¶æ€ä¸€è‡´æ€§å¼‚å¸¸**
```
è®¢å•çŠ¶æ€ä¸ä¸€è‡´ï¼š
â€¢ è®¢å•çŠ¶æ€ï¼šå·²æ”¯ä»˜
â€¢ åº“å­˜çŠ¶æ€ï¼šæœªæ‰£å‡
â€¢ ç‰©æµçŠ¶æ€ï¼šæœªç”Ÿæˆ
â€¢ åæœï¼šä¸šåŠ¡æµç¨‹æ··ä¹±

ç”¨æˆ·æƒé™å¼‚å¸¸ï¼š
â€¢ ç”¨æˆ·å‡çº§ä¸ºVIP
â€¢ æŠ˜æ‰£ç³»ç»ŸæœªåŒæ­¥
â€¢ ç§¯åˆ†ç³»ç»ŸæœªåŒæ­¥  
â€¢ åæœï¼šæƒç›Šä¸ä¸€è‡´
```

### 8.2 ç”µå•†åœºæ™¯å¼‚å¸¸åˆ†æ


**ğŸ”¸ ç§’æ€æ´»åŠ¨å¼‚å¸¸**
```
åœºæ™¯ï¼šé™é‡å•†å“1000ä»¶ï¼Œç§’æ€æ´»åŠ¨

å¼‚å¸¸è¡¨ç°ï¼š
1. è¶…å–ï¼šæœ€ç»ˆå–å‡º1050ä»¶
2. å°‘å–ï¼šç³»ç»Ÿæ˜¾ç¤ºå–å‡º800ä»¶ï¼Œå®é™…åº“å­˜è¿˜æœ‰300ä»¶
3. é‡å¤ä¸‹å•ï¼šç”¨æˆ·é‡å¤ç‚¹å‡»ï¼Œäº§ç”Ÿå¤šä¸ªè®¢å•
4. æ”¯ä»˜å¼‚å¸¸ï¼šæ‰£æ¬¾æˆåŠŸä½†è®¢å•å¤±è´¥

æ ¹æœ¬åŸå› ï¼š
â€¢ åº“å­˜æ£€æŸ¥å’Œæ‰£å‡ä¸æ˜¯åŸå­æ“ä½œ
â€¢ è®¢å•åˆ›å»ºå’Œæ”¯ä»˜å¤„ç†å¹¶å‘æ‰§è¡Œ
â€¢ ç¼ºä¹æœ‰æ•ˆçš„é‡å¤æäº¤é˜²æŠ¤
```

### 8.3 é‡‘èåœºæ™¯å¼‚å¸¸åˆ†æ


**ğŸ”¸ è½¬è´¦ä¸šåŠ¡å¼‚å¸¸**
```sql
-- è½¬è´¦æ“ä½œçš„å¹¶å‘å¼‚å¸¸
-- ä»è´¦æˆ·Aè½¬1000å…ƒåˆ°è´¦æˆ·B

-- é”™è¯¯çš„å®ç°æ–¹å¼
BEGIN;
SELECT balance FROM accounts WHERE id = 'A'; -- è¯»å–ä½™é¢2000
UPDATE accounts SET balance = 2000 - 1000 WHERE id = 'A';
UPDATE accounts SET balance = balance + 1000 WHERE id = 'B';
COMMIT;

-- å¯èƒ½çš„å¼‚å¸¸ï¼š
-- 1. Aè´¦æˆ·ä½™é¢å˜æˆè´Ÿæ•°ï¼ˆå¦‚æœæœ‰å…¶ä»–å¹¶å‘è½¬å‡ºï¼‰
-- 2. Bè´¦æˆ·é‡‘é¢ä¸æ­£ç¡®ï¼ˆå¦‚æœæœ‰å…¶ä»–å¹¶å‘è½¬å…¥ï¼‰
-- 3. æ€»é‡‘é¢ä¸å®ˆæ’ï¼ˆç³»ç»Ÿæ€§é£é™©ï¼‰
```

### 8.4 ä¸šåŠ¡å¼‚å¸¸é˜²æŠ¤ç­–ç•¥


**ğŸ”¸ ä¸šåŠ¡é”æœºåˆ¶**
```java
// ä¸šåŠ¡çº§åˆ«çš„é”å®šæœºåˆ¶
public class BusinessLockManager {
    
    public boolean acquireProductLock(String productId, int quantity) {
        String lockKey = "product_lock:" + productId;
        return redisTemplate.opsForValue()
            .setIfAbsent(lockKey, quantity, Duration.ofSeconds(30));
    }
    
    public void releaseProductLock(String productId) {
        String lockKey = "product_lock:" + productId;
        redisTemplate.delete(lockKey);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public OrderResult createOrder(String productId, int quantity) {
    if (!lockManager.acquireProductLock(productId, quantity)) {
        return OrderResult.failed("Product is being processed by another order");
    }
    
    try {
        // æ£€æŸ¥åº“å­˜å¹¶åˆ›å»ºè®¢å•
        return processOrder(productId, quantity);
    } finally {
        lockManager.releaseProductLock(productId);
    }
}
```

---

## 9. ğŸ›¡ï¸ å¼‚å¸¸æ£€æµ‹ä¸é˜²æŠ¤æœºåˆ¶


### 9.1 å¤šå±‚é˜²æŠ¤ä½“ç³»


**ğŸ”¸ é˜²æŠ¤å±‚æ¬¡æ¶æ„**
```
åº”ç”¨å±‚é˜²æŠ¤ï¼š
â”œâ”€ ä¸šåŠ¡é€»è¾‘æ ¡éªŒ
â”œâ”€ é‡å¤æäº¤æ£€æµ‹
â”œâ”€ å¹¶å‘æ§åˆ¶ç­–ç•¥
â””â”€ å¼‚å¸¸æ¢å¤æœºåˆ¶

ä¸­é—´ä»¶å±‚é˜²æŠ¤ï¼š
â”œâ”€ è¿æ¥æ± ç®¡ç†
â”œâ”€ äº‹åŠ¡ç®¡ç†å™¨
â”œâ”€ æ¶ˆæ¯é˜Ÿåˆ—
â””â”€ ç¼“å­˜ä¸€è‡´æ€§

æ•°æ®åº“å±‚é˜²æŠ¤ï¼š
â”œâ”€ éš”ç¦»çº§åˆ«æ§åˆ¶
â”œâ”€ é”æœºåˆ¶
â”œâ”€ çº¦æŸæ£€æŸ¥
â””â”€ æ­»é”æ£€æµ‹
```

### 9.2 å®æ—¶ç›‘æ§ç³»ç»Ÿ


**ğŸ”¸ ç›‘æ§æŒ‡æ ‡ä½“ç³»**
```java
// å¹¶å‘å¼‚å¸¸ç›‘æ§æŒ‡æ ‡
public class ConcurrencyMetrics {
    
    // å¼‚å¸¸è®¡æ•°å™¨
    private Counter dirtyReadCount = Counter.create("dirty_read_total");
    private Counter lostUpdateCount = Counter.create("lost_update_total");
    private Counter writeSkewCount = Counter.create("write_skew_total");
    
    // æ€§èƒ½æŒ‡æ ‡
    private Timer transactionDuration = Timer.create("transaction_duration");
    private Gauge activeTransactions = Gauge.create("active_transactions");
    
    public void recordAnomaly(AnomalyType type) {
        switch (type) {
            case DIRTY_READ: dirtyReadCount.increment(); break;
            case LOST_UPDATE: lostUpdateCount.increment(); break;
            case WRITE_SKEW: writeSkewCount.increment(); break;
        }
    }
}
```

### 9.3 è‡ªé€‚åº”é˜²æŠ¤æœºåˆ¶


**ğŸ”¸ åŠ¨æ€éš”ç¦»çº§åˆ«è°ƒæ•´**
```java
public class AdaptiveIsolationManager {
    
    private volatile IsolationLevel currentLevel = IsolationLevel.READ_COMMITTED;
    private final AnomalyMonitor monitor;
    
    public void adjustIsolationLevel() {
        double anomalyRate = monitor.getAnomalyRate(Duration.ofMinutes(5));
        
        if (anomalyRate > 0.1) { // å¼‚å¸¸ç‡è¶…è¿‡10%
            upgradeIsolationLevel();
        } else if (anomalyRate < 0.01) { // å¼‚å¸¸ç‡ä½äº1%
            downgradeIsolationLevel();
        }
    }
    
    private void upgradeIsolationLevel() {
        switch (currentLevel) {
            case READ_uncommitted: currentLevel = READ_COMMITTED; break;
            case READ_committed: currentLevel = REPEATABLE_READ; break;
            case repeatable_read: currentLevel = SERIALIZABLE; break;
        }
    }
}
```

---

## 10. ğŸ¯ å¼‚å¸¸å¤„ç†ç­–ç•¥æ¡†æ¶


### 10.1 å¼‚å¸¸å¤„ç†ç­–ç•¥åˆ†ç±»


**ğŸ”¸ é¢„é˜²ç­–ç•¥**
```
è®¾è®¡æ—¶é¢„é˜²ï¼š
â€¢ åˆç†çš„è¡¨ç»“æ„è®¾è®¡
â€¢ é€‚å½“çš„ç´¢å¼•ç­–ç•¥
â€¢ çº¦æŸå®šä¹‰å®Œæ•´æ€§

è¿è¡Œæ—¶é¢„é˜²ï¼š
â€¢ é€‚å½“çš„éš”ç¦»çº§åˆ«
â€¢ é”ç²’åº¦æ§åˆ¶
â€¢ äº‹åŠ¡è¶…æ—¶è®¾ç½®
```

**ğŸ”¸ æ£€æµ‹ç­–ç•¥**
```
å®æ—¶æ£€æµ‹ï¼š
â€¢ äº‹åŠ¡æ‰§è¡Œç›‘æ§
â€¢ å¼‚å¸¸æ¨¡å¼è¯†åˆ«
â€¢ æ€§èƒ½æŒ‡æ ‡ç›‘æ§

ç¦»çº¿åˆ†æï¼š
â€¢ æ—¥å¿—åˆ†æ
â€¢ å†å²æ•°æ®æŒ–æ˜
â€¢ è¶‹åŠ¿é¢„æµ‹
```

**ğŸ”¸ æ¢å¤ç­–ç•¥**
```
è‡ªåŠ¨æ¢å¤ï¼š
â€¢ äº‹åŠ¡é‡è¯•
â€¢ è¡¥å¿æ“ä½œ
â€¢ æ•°æ®ä¿®å¤

äººå·¥å¹²é¢„ï¼š
â€¢ å¼‚å¸¸å‘Šè­¦
â€¢ ä¸“å®¶åˆ†æ
â€¢ æ‰‹åŠ¨ä¿®å¤
```

### 10.2 å¼‚å¸¸å“åº”æœºåˆ¶


**ğŸ”¸ åˆ†çº§å“åº”æµç¨‹**
```
å¼‚å¸¸å“åº”æµç¨‹ï¼š

æ£€æµ‹åˆ°å¼‚å¸¸
    â†“
è¯„ä¼°å¼‚å¸¸çº§åˆ«
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½çº§åˆ«   â”‚ ä¸­çº§åˆ«   â”‚ é«˜çº§åˆ«   â”‚
â”‚ è®°å½•æ—¥å¿— â”‚ è‡ªåŠ¨é‡è¯• â”‚ ç«‹å³å‘Šè­¦ â”‚
â”‚ ç»§ç»­æ‰§è¡Œ â”‚ é™çº§æœåŠ¡ â”‚ åœæ­¢æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ‰§è¡Œæ¢å¤ç­–ç•¥
    â†“
éªŒè¯æ¢å¤ç»“æœ
    â†“
æ›´æ–°ç›‘æ§çŠ¶æ€
```

### 10.3 æœ€ä½³å®è·µæŒ‡å¯¼


**ğŸ”¸ ä»£ç å®ç°æœ€ä½³å®è·µ**
```java
// äº‹åŠ¡å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µ
@Service
public class OrderService {
    
    @Transactional(isolation = Isolation.REPEATABLE_READ, 
                   timeout = 30,
                   rollbackFor = Exception.class)
    public OrderResult createOrder(OrderRequest request) {
        try {
            // 1. å‚æ•°éªŒè¯
            validateRequest(request);
            
            // 2. ä¹è§‚é”æ£€æŸ¥åº“å­˜
            Product product = productRepository.findByIdWithVersion(request.getProductId());
            if (product.getStock() < request.getQuantity()) {
                throw new InsufficientStockException();
            }
            
            // 3. åŸå­æ€§æ›´æ–°åº“å­˜
            int updated = productRepository.updateStockWithVersion(
                product.getId(), 
                product.getVersion(), 
                request.getQuantity()
            );
            
            if (updated == 0) {
                throw new ConcurrentUpdateException("Product was modified by another transaction");
            }
            
            // 4. åˆ›å»ºè®¢å•
            return createOrderRecord(request);
            
        } catch (ConcurrentUpdateException e) {
            // å¹¶å‘æ›´æ–°å¼‚å¸¸ï¼šé‡è¯•
            return retryCreateOrder(request);
        } catch (InsufficientStockException e) {
            // åº“å­˜ä¸è¶³ï¼šè¿”å›å¤±è´¥
            return OrderResult.failed("Insufficient stock");
        }
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹¶å‘å¼‚å¸¸æœ¬è´¨ï¼šå¤šäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶æ•°æ®ä¸€è‡´æ€§è¢«ç ´åçš„ç°è±¡
ğŸ”¸ å†™åå·®æœºåˆ¶ï¼šè¯»å–ç›¸åŒæ•°æ®é›†ï¼Œæ›´æ–°ä¸åŒå­é›†ï¼Œè¿åæ•´ä½“çº¦æŸ
ğŸ”¸ è¯»åå·®ç‰¹å¾ï¼šåŒä¸€äº‹åŠ¡å†…è¯»å–åˆ°ä¸ä¸€è‡´çš„ä¸­é—´çŠ¶æ€
ğŸ”¸ ä¸¢å¤±æ›´æ–°ç±»å‹ï¼šç¬¬ä¸€ç±»ï¼ˆè„å†™ï¼‰ã€ç¬¬äºŒç±»ï¼ˆè¦†ç›–å†™ï¼‰ã€ç´¯ç§¯ä¸¢å¤±
ğŸ”¸ çº¦æŸè¿åï¼šå¹¶å‘æ‰§è¡Œå¯¼è‡´æ•°æ®åº“å®Œæ•´æ€§çº¦æŸè¢«ç ´å
ğŸ”¸ å¼‚å¸¸ç­‰çº§ï¼šæŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ä¸ºè‡´å‘½ã€é‡è¦ã€ä¸€èˆ¬ä¸‰ä¸ªçº§åˆ«
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¹¶å‘å¼‚å¸¸çš„æ ¹æœ¬åŸå› **
```
æŠ€æœ¯å±‚é¢ï¼š
â€¢ éš”ç¦»æœºåˆ¶ä¸è¶³
â€¢ é”ç²’åº¦ä¸å½“
â€¢ äº‹åŠ¡è®¾è®¡ç¼ºé™·

ä¸šåŠ¡å±‚é¢ï¼š
â€¢ çº¦æŸå®šä¹‰ä¸å®Œæ•´
â€¢ ä¸šåŠ¡é€»è¾‘å¤æ‚
â€¢ å¹¶å‘åœºæ™¯è€ƒè™‘ä¸è¶³
```

**ğŸ”¹ å¼‚å¸¸æ£€æµ‹çš„é‡è¦æ€§**
```
æ—©æœŸå‘ç°ï¼š
â€¢ é¿å…æ•°æ®æŸåæ‰©æ•£
â€¢ å‡å°‘ä¸šåŠ¡å½±å“èŒƒå›´
â€¢ é™ä½ä¿®å¤æˆæœ¬

å®æ—¶ç›‘æ§ï¼š
â€¢ æä¾›å†³ç­–ä¾æ®
â€¢ æ”¯æŒè‡ªåŠ¨åŒ–å¤„ç†
â€¢ æé«˜ç³»ç»Ÿå¯é æ€§
```

**ğŸ”¹ é˜²æŠ¤ç­–ç•¥çš„é€‰æ‹©åŸåˆ™**
```
ä¸šåŠ¡ç‰¹å¾è€ƒè™‘ï¼š
â€¢ æ•°æ®ä¸€è‡´æ€§è¦æ±‚
â€¢ æ€§èƒ½æŒ‡æ ‡è¦æ±‚
â€¢ å¯ç”¨æ€§è¦æ±‚

æŠ€æœ¯å› ç´ è€ƒè™‘ï¼š
â€¢ ç³»ç»Ÿå¹¶å‘åº¦
â€¢ æ•°æ®è®¿é—®æ¨¡å¼
â€¢ èµ„æºé™åˆ¶
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ è®¾è®¡é˜¶æ®µ**
- **å¼‚å¸¸è¯„ä¼°**ï¼šè¯†åˆ«å¯èƒ½çš„å¹¶å‘å¼‚å¸¸åœºæ™¯
- **é˜²æŠ¤è®¾è®¡**ï¼šé€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«å’Œé”ç­–ç•¥
- **ç›‘æ§è§„åˆ’**ï¼šè®¾è®¡å¼‚å¸¸æ£€æµ‹å’Œå‘Šè­¦æœºåˆ¶

**ğŸ”¸ å¼€å‘é˜¶æ®µ** 
- **ä»£ç è§„èŒƒ**ï¼šä½¿ç”¨äº‹åŠ¡æ³¨è§£å’Œå¼‚å¸¸å¤„ç†
- **æµ‹è¯•ç”¨ä¾‹**ï¼šç¼–å†™å¹¶å‘åœºæ™¯çš„æµ‹è¯•ç”¨ä¾‹
- **æ€§èƒ½æµ‹è¯•**ï¼šéªŒè¯å¹¶å‘æ€§èƒ½å’Œå¼‚å¸¸å¤„ç†æ•ˆæœ

**ğŸ”¸ è¿ç»´é˜¶æ®µ**
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å¼‚å¸¸å‘ç”Ÿæƒ…å†µ
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ç›‘æ§æ•°æ®è°ƒæ•´ç­–ç•¥
- **åº”æ€¥å“åº”**ï¼šå»ºç«‹å¼‚å¸¸å¤„ç†çš„åº”æ€¥æµç¨‹

### 11.4 å­¦ä¹ å»ºè®®


**ğŸ”¸ ç†è®ºåŸºç¡€**
- æ·±å…¥ç†è§£ACIDå±æ€§å’Œéš”ç¦»çº§åˆ«
- æŒæ¡å„ç§å¹¶å‘å¼‚å¸¸çš„å‘ç”Ÿæœºåˆ¶
- äº†è§£æ•°æ®åº“å¹¶å‘æ§åˆ¶åŸç†

**ğŸ”¸ å®è·µèƒ½åŠ›**
- åŠ¨æ‰‹å®éªŒå„ç§å¼‚å¸¸åœºæ™¯
- ç»ƒä¹ å¼‚å¸¸æ£€æµ‹å’Œå¤„ç†ä»£ç 
- æŒæ¡ç›‘æ§å·¥å…·çš„ä½¿ç”¨

**ğŸ”¸ ä¸šåŠ¡ç†è§£**
- åˆ†æå…·ä½“ä¸šåŠ¡åœºæ™¯çš„å¹¶å‘é£é™©
- è®¾è®¡åˆé€‚çš„å¼‚å¸¸é˜²æŠ¤ç­–ç•¥
- å»ºç«‹å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å¹¶å‘å¼‚å¸¸æ˜¯å¤šäº‹åŠ¡ç¯å¢ƒä¸‹çš„å¿…ç„¶æŒ‘æˆ˜
- ä¸åŒå¼‚å¸¸æœ‰ä¸åŒçš„å‘ç”Ÿæœºåˆ¶å’Œå½±å“ç¨‹åº¦
- æ£€æµ‹å’Œé˜²æŠ¤éœ€è¦å¤šå±‚æ¬¡çš„ç»¼åˆç­–ç•¥
- ä¸šåŠ¡ç‰¹å¾å†³å®šäº†å¼‚å¸¸å¤„ç†çš„ä¼˜å…ˆçº§å’Œç­–ç•¥é€‰æ‹©