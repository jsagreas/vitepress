---
title: 17ã€äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†æ¦‚è¿°](#1-äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†æ¦‚è¿°)
2. [äº‹åŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶](#2-äº‹åŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶)
3. [çº¿ç¨‹æœ¬åœ°äº‹åŠ¡çŠ¶æ€ç®¡ç†](#3-çº¿ç¨‹æœ¬åœ°äº‹åŠ¡çŠ¶æ€ç®¡ç†)
4. [åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡](#4-åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡)
5. [ä¸Šä¸‹æ–‡åºåˆ—åŒ–ä¸ä¼ è¾“](#5-ä¸Šä¸‹æ–‡åºåˆ—åŒ–ä¸ä¼ è¾“)
6. [ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†](#6-ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†)
7. [ä¸Šä¸‹æ–‡å®‰å…¨æ€§ä¿éšœ](#7-ä¸Šä¸‹æ–‡å®‰å…¨æ€§ä¿éšœ)
8. [ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æœºåˆ¶](#8-ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æœºåˆ¶)
9. [ä¸Šä¸‹æ–‡ä¼˜åŒ–ç­–ç•¥](#9-ä¸Šä¸‹æ–‡ä¼˜åŒ–ç­–ç•¥)
10. [ä¸Šä¸‹æ–‡å¼‚å¸¸å¤„ç†](#10-ä¸Šä¸‹æ–‡å¼‚å¸¸å¤„ç†)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¸Šä¸‹æ–‡


**ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**
```
å°±åƒä½ åœ¨é“¶è¡ŒåŠäº‹æ—¶çš„ä¸šåŠ¡å•å·ï¼š
- å•å·è®°å½•äº†ä½ çš„åŠäº‹è¿›åº¦å’ŒçŠ¶æ€
- ä¸åŒçª—å£çš„å·¥ä½œäººå‘˜éƒ½èƒ½çœ‹åˆ°ä½ çš„åŠäº‹æƒ…å†µ  
- å³ä½¿æ¢äº†å·¥ä½œäººå‘˜ï¼Œä¸šåŠ¡ä¹Ÿèƒ½ç»§ç»­è¿›è¡Œ
- åŠå®Œäº‹åï¼Œè¿™ä¸ªå•å·å°±å¤±æ•ˆäº†

äº‹åŠ¡ä¸Šä¸‹æ–‡å°±æ˜¯æ•°æ®åº“æ“ä½œçš„"ä¸šåŠ¡å•å·"
```

**ğŸ” æŠ€æœ¯å®šä¹‰**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼ˆTransaction Contextï¼‰ï¼š
â€¢ å®šä¹‰ï¼šå­˜å‚¨å’Œç®¡ç†äº‹åŠ¡ç›¸å…³ä¿¡æ¯çš„è¿è¡Œæ—¶ç¯å¢ƒ
â€¢ ä½œç”¨ï¼šè·Ÿè¸ªäº‹åŠ¡çŠ¶æ€ã€ä¼ æ’­äº‹åŠ¡ä¿¡æ¯ã€åè°ƒäº‹åŠ¡æ“ä½œ
â€¢ èŒƒå›´ï¼šå¯ä»¥æ˜¯çº¿ç¨‹çº§ã€è¿›ç¨‹çº§æˆ–åˆ†å¸ƒå¼çº§åˆ«
â€¢ ç”Ÿå‘½å‘¨æœŸï¼šä»äº‹åŠ¡å¼€å§‹åˆ°äº‹åŠ¡ç»“æŸçš„æ•´ä¸ªè¿‡ç¨‹
```

### 1.2 äº‹åŠ¡ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒç»„æˆ


**ğŸ“‹ ä¸Šä¸‹æ–‡ä¿¡æ¯ç»“æ„**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡åŒ…å«çš„å…³é”®ä¿¡æ¯ï¼š

ğŸ”¸ äº‹åŠ¡æ ‡è¯†ä¿¡æ¯
â€¢ äº‹åŠ¡IDï¼šå…¨å±€å”¯ä¸€çš„äº‹åŠ¡æ ‡è¯†ç¬¦
â€¢ äº‹åŠ¡ç±»å‹ï¼šæœ¬åœ°äº‹åŠ¡ vs åˆ†å¸ƒå¼äº‹åŠ¡
â€¢ äº‹åŠ¡æºï¼šå‘èµ·äº‹åŠ¡çš„åº”ç”¨æˆ–æœåŠ¡

ğŸ”¸ äº‹åŠ¡çŠ¶æ€ä¿¡æ¯  
â€¢ å½“å‰çŠ¶æ€ï¼šæ´»è·ƒã€å‡†å¤‡ã€æäº¤ã€å›æ»š
â€¢ å¼€å§‹æ—¶é—´ï¼šäº‹åŠ¡åˆ›å»ºçš„æ—¶é—´æˆ³
â€¢ è¶…æ—¶è®¾ç½®ï¼šäº‹åŠ¡çš„æœ€å¤§å­˜æ´»æ—¶é—´

ğŸ”¸ äº‹åŠ¡é…ç½®ä¿¡æ¯
â€¢ éš”ç¦»çº§åˆ«ï¼šREAD_COMMITTEDã€REPEATABLE_READç­‰
â€¢ ä¼ æ’­è¡Œä¸ºï¼šREQUIREDã€REQUIRES_NEWç­‰
â€¢ åªè¯»æ ‡è¯†ï¼šæ˜¯å¦ä¸ºåªè¯»äº‹åŠ¡

ğŸ”¸ å‚ä¸è€…ä¿¡æ¯
â€¢ æ•°æ®åº“è¿æ¥ï¼šå‚ä¸äº‹åŠ¡çš„æ•°æ®åº“è¿æ¥
â€¢ èµ„æºç®¡ç†å™¨ï¼šXAèµ„æºã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰
â€¢ åµŒå¥—äº‹åŠ¡ï¼šçˆ¶å­äº‹åŠ¡å…³ç³»
```

### 1.3 ä¸Šä¸‹æ–‡ç®¡ç†çš„é‡è¦æ€§


**âš¡ æ ¸å¿ƒä»·å€¼**
```
ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†ï¼Ÿ

ğŸ¯ çŠ¶æ€ä¸€è‡´æ€§
â€¢ ç¡®ä¿æ‰€æœ‰å‚ä¸è€…çœ‹åˆ°ç›¸åŒçš„äº‹åŠ¡çŠ¶æ€
â€¢ é¿å…çŠ¶æ€ä¸åŒæ­¥å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

ğŸ¯ æ“ä½œåè°ƒæ€§  
â€¢ ç»Ÿä¸€ç®¡ç†å¤šä¸ªèµ„æºçš„äº‹åŠ¡å‚ä¸
â€¢ åè°ƒåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„äº‹åŠ¡æ“ä½œ

ğŸ¯ å¼‚å¸¸æ¢å¤èƒ½åŠ›
â€¢ è®°å½•äº‹åŠ¡æ‰§è¡Œè½¨è¿¹ï¼Œæ”¯æŒæ•…éšœæ¢å¤
â€¢ æä¾›äº‹åŠ¡å›æ»šçš„å®Œæ•´ä¿¡æ¯

ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ”¯æŒ
â€¢ å¤ç”¨äº‹åŠ¡è¿æ¥ï¼Œå‡å°‘å¼€é”€
â€¢ æ‰¹é‡æäº¤ä¼˜åŒ–ï¼Œæå‡æ€§èƒ½
```

---

## 2. ğŸ”„ äº‹åŠ¡ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶


### 2.1 ä¸Šä¸‹æ–‡ä¼ æ’­çš„åŸºæœ¬åŸç†


**ğŸ”— ä¼ æ’­é“¾æ¡æ¦‚å¿µ**
```
æ–¹æ³•è°ƒç”¨é“¾ä¸­çš„äº‹åŠ¡ä¼ æ’­ï¼š

Service A.method1() 
    â†“ [ä¼ æ’­äº‹åŠ¡ä¸Šä¸‹æ–‡]
Service B.method2()
    â†“ [ç»§æ‰¿æˆ–åˆ›å»ºæ–°ä¸Šä¸‹æ–‡]  
Service C.method3()

æ¯ä¸€å±‚è°ƒç”¨éƒ½éœ€è¦å†³å®šï¼š
â€¢ ä½¿ç”¨å½“å‰äº‹åŠ¡ï¼Ÿ
â€¢ åˆ›å»ºæ–°äº‹åŠ¡ï¼Ÿ
â€¢ æŒ‚èµ·å½“å‰äº‹åŠ¡ï¼Ÿ
```

### 2.2 Springäº‹åŠ¡ä¼ æ’­è¡Œä¸ºè¯¦è§£


**ğŸ“Š ä¼ æ’­è¡Œä¸ºå¯¹æ¯”è¡¨**

| ä¼ æ’­è¡Œä¸º | **æè¿°** | **æœ‰äº‹åŠ¡æ—¶** | **æ— äº‹åŠ¡æ—¶** | **å…¸å‹åœºæ™¯** |
|---------|---------|------------|------------|------------|
| `REQUIRED` | `éœ€è¦äº‹åŠ¡` | `åŠ å…¥å½“å‰äº‹åŠ¡` | `åˆ›å»ºæ–°äº‹åŠ¡` | `æ™®é€šä¸šåŠ¡æ–¹æ³•` |
| `REQUIRES_NEW` | `æ€»æ˜¯æ–°äº‹åŠ¡` | `æŒ‚èµ·å½“å‰ï¼Œåˆ›å»ºæ–°çš„` | `åˆ›å»ºæ–°äº‹åŠ¡` | `ç‹¬ç«‹çš„æ—¥å¿—è®°å½•` |
| `SUPPORTS` | `æ”¯æŒäº‹åŠ¡` | `åŠ å…¥å½“å‰äº‹åŠ¡` | `éäº‹åŠ¡æ‰§è¡Œ` | `æŸ¥è¯¢æ–¹æ³•` |
| `NOT_SUPPORTED` | `ä¸æ”¯æŒäº‹åŠ¡` | `æŒ‚èµ·å½“å‰äº‹åŠ¡` | `éäº‹åŠ¡æ‰§è¡Œ` | `æ–‡ä»¶æ“ä½œ` |
| `MANDATORY` | `å¼ºåˆ¶è¦æ±‚äº‹åŠ¡` | `åŠ å…¥å½“å‰äº‹åŠ¡` | `æŠ›å‡ºå¼‚å¸¸` | `æ ¸å¿ƒä¸šåŠ¡é€»è¾‘` |
| `NEVER` | `ç¦æ­¢äº‹åŠ¡` | `æŠ›å‡ºå¼‚å¸¸` | `éäº‹åŠ¡æ‰§è¡Œ` | `åªè¯»æ“ä½œ` |

**ğŸ’¡ ä¼ æ’­è¡Œä¸ºç¤ºä¾‹**
```java
@Service
public class OrderService {
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired  
    private LogService logService;
    
    // REQUIREDï¼šéœ€è¦äº‹åŠ¡ï¼Œæ²¡æœ‰å°±åˆ›å»º
    @Transactional(propagation = Propagation.REQUIRED)
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderDao.save(order);
        
        // è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆåŠ å…¥å½“å‰äº‹åŠ¡ï¼‰
        paymentService.processPayment(order.getPayment());
        
        // è®°å½•æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
        logService.recordOperation("CREATE_ORDER", order.getId());
    }
}

@Service  
public class PaymentService {
    
    // REQUIREDï¼šåŠ å…¥å¤–å±‚äº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRED)
    public void processPayment(Payment payment) {
        paymentDao.save(payment);
        // å¦‚æœè¿™é‡Œå‡ºé”™ï¼Œæ•´ä¸ªè®¢å•åˆ›å»ºéƒ½ä¼šå›æ»š
    }
}

@Service
public class LogService {
    
    // REQUIRES_NEWï¼šç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—å¤–å±‚å½±å“
    @Transactional(propagation = Propagation.REQUIRES_NEW)  
    public void recordOperation(String operation, Long orderId) {
        logDao.save(new OperationLog(operation, orderId));
        // å³ä½¿å¤–å±‚äº‹åŠ¡å›æ»šï¼Œæ—¥å¿—ä¹Ÿä¼šä¿å­˜
    }
}
```

### 2.3 ä¸Šä¸‹æ–‡ä¼ æ’­çš„å®ç°æœºåˆ¶


**ğŸ”§ ä¼ æ’­å®ç°åŸç†**
```
ä¸Šä¸‹æ–‡ä¼ æ’­çš„æŠ€æœ¯å®ç°ï¼š

ğŸ”¸ çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThreadLocalï¼‰
â€¢ æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤è‡ªå·±çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
â€¢ åœ¨æ–¹æ³•è°ƒç”¨æ—¶è‡ªåŠ¨ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨æ¸…ç†ä¸Šä¸‹æ–‡

ğŸ”¸ è°ƒç”¨æ ˆç®¡ç†
â€¢ ç»´æŠ¤äº‹åŠ¡ä¸Šä¸‹æ–‡çš„è°ƒç”¨æ ˆ
â€¢ æ”¯æŒäº‹åŠ¡çš„åµŒå¥—å’ŒæŒ‚èµ·/æ¢å¤
â€¢ ç¡®ä¿å¼‚å¸¸æ—¶èƒ½æ­£ç¡®æ¢å¤ä¸Šä¸‹æ–‡

ğŸ”¸ åŠ¨æ€ä»£ç†å¢å¼º
â€¢ AOPæ‹¦æˆªäº‹åŠ¡æ–¹æ³•è°ƒç”¨
â€¢ åœ¨æ–¹æ³•æ‰§è¡Œå‰åç®¡ç†äº‹åŠ¡ä¸Šä¸‹æ–‡
â€¢ æ ¹æ®ä¼ æ’­è¡Œä¸ºå†³å®šä¸Šä¸‹æ–‡å¤„ç†æ–¹å¼
```

**ğŸ“‹ ä¸Šä¸‹æ–‡ä¼ æ’­æµç¨‹å›¾**
```
æ–¹æ³•è°ƒç”¨æµç¨‹ï¼š

è°ƒç”¨æ–¹æ³•Aï¼ˆREQUIREDï¼‰
    â†“
[æ£€æŸ¥å½“å‰çº¿ç¨‹äº‹åŠ¡ä¸Šä¸‹æ–‡]
    â†“
å­˜åœ¨äº‹åŠ¡ï¼Ÿ
â”œâ”€ æ˜¯ â†’ åŠ å…¥å½“å‰äº‹åŠ¡
â”‚   â”œâ”€ ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡
â”‚   â”œâ”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
â”‚   â””â”€ æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
â””â”€ å¦ â†’ åˆ›å»ºæ–°äº‹åŠ¡
    â”œâ”€ åˆ›å»ºæ–°çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
    â”œâ”€ ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
    â”œâ”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    â””â”€ æäº¤æˆ–å›æ»šäº‹åŠ¡
```

---

## 3. ğŸ§µ çº¿ç¨‹æœ¬åœ°äº‹åŠ¡çŠ¶æ€ç®¡ç†


### 3.1 ThreadLocalåœ¨äº‹åŠ¡ä¸­çš„ä½œç”¨


**ğŸ’­ ä¸ºä»€ä¹ˆéœ€è¦ThreadLocalï¼Ÿ**
```
å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„äº‹åŠ¡éš”ç¦»é—®é¢˜ï¼š

çº¿ç¨‹Aï¼šå¤„ç†è®¢å•Açš„äº‹åŠ¡
çº¿ç¨‹Bï¼šå¤„ç†è®¢å•Bçš„äº‹åŠ¡

é—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹çš„äº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Ÿ
è§£å†³ï¼šæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤è‡ªå·±çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
```

**ğŸ” ThreadLocaläº‹åŠ¡ä¸Šä¸‹æ–‡ç»“æ„**
```java
// ç®€åŒ–çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨
public class TransactionContextManager {
    
    // çº¿ç¨‹æœ¬åœ°çš„äº‹åŠ¡ä¸Šä¸‹æ–‡å­˜å‚¨
    private static final ThreadLocal<TransactionContext> contextHolder = 
        new ThreadLocal<>();
    
    // è·å–å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
    public static TransactionContext getCurrentContext() {
        return contextHolder.get();
    }
    
    // è®¾ç½®å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
    public static void setCurrentContext(TransactionContext context) {
        contextHolder.set(context);
    }
    
    // æ¸…ç†å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
    public static void clearContext() {
        contextHolder.remove();
    }
}

// äº‹åŠ¡ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„
public class TransactionContext {
    private String transactionId;           // äº‹åŠ¡ID
    private TransactionStatus status;       // äº‹åŠ¡çŠ¶æ€
    private IsolationLevel isolation;       // éš”ç¦»çº§åˆ«
    private boolean readOnly;               // åªè¯»æ ‡è¯†
    private int timeout;                    // è¶…æ—¶æ—¶é—´
    private List<Resource> resources;       // å‚ä¸çš„èµ„æº
    private TransactionContext parent;      // çˆ¶äº‹åŠ¡ä¸Šä¸‹æ–‡
}
```

### 3.2 çº¿ç¨‹æœ¬åœ°çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ


**ğŸ”„ çŠ¶æ€ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
çº¿ç¨‹æœ¬åœ°äº‹åŠ¡çŠ¶æ€çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š

1ï¸âƒ£ åˆ›å»ºé˜¶æ®µ
   â”œâ”€ æ£€æµ‹å½“å‰çº¿ç¨‹æ˜¯å¦å·²æœ‰äº‹åŠ¡
   â”œâ”€ æ ¹æ®ä¼ æ’­è¡Œä¸ºå†³å®šåˆ›å»ºæˆ–åŠ å…¥
   â””â”€ åˆå§‹åŒ–äº‹åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯

2ï¸âƒ£ ç»‘å®šé˜¶æ®µ  
   â”œâ”€ å°†ä¸Šä¸‹æ–‡ç»‘å®šåˆ°ThreadLocal
   â”œâ”€ è·å–æ•°æ®åº“è¿æ¥å¹¶ç»‘å®š
   â””â”€ è®¾ç½®è¿æ¥çš„äº‹åŠ¡å±æ€§

3ï¸âƒ£ ä¼ æ’­é˜¶æ®µ
   â”œâ”€ åœ¨æ–¹æ³•è°ƒç”¨é—´ä¼ é€’ä¸Šä¸‹æ–‡
   â”œâ”€ å¤„ç†åµŒå¥—äº‹åŠ¡çš„ä¸Šä¸‹æ–‡æ ˆ
   â””â”€ ç®¡ç†æŒ‚èµ·å’Œæ¢å¤æ“ä½œ

4ï¸âƒ£ æ¸…ç†é˜¶æ®µ
   â”œâ”€ æäº¤æˆ–å›æ»šäº‹åŠ¡
   â”œâ”€ é‡Šæ”¾æ•°æ®åº“è¿æ¥
   â””â”€ æ¸…ç†ThreadLocalé¿å…å†…å­˜æ³„æ¼
```

### 3.3 çº¿ç¨‹åˆ‡æ¢æ—¶çš„ä¸Šä¸‹æ–‡ä¼ é€’


**âš ï¸ çº¿ç¨‹åˆ‡æ¢çš„æŒ‘æˆ˜**
```
å¼‚æ­¥è°ƒç”¨ä¸­çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜ï¼š

ä¸»çº¿ç¨‹ï¼šå¼€å¯äº‹åŠ¡A
    â†“
å¼‚æ­¥çº¿ç¨‹ï¼šæ‰§è¡Œæ•°æ®åº“æ“ä½œ
    â†“ 
é—®é¢˜ï¼šå¼‚æ­¥çº¿ç¨‹æ— æ³•è®¿é—®ä¸»çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼

åŸå› ï¼šThreadLocalåªåœ¨å½“å‰çº¿ç¨‹æœ‰æ•ˆ
```

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**
```java
// æ‰‹åŠ¨ä¼ é€’äº‹åŠ¡ä¸Šä¸‹æ–‡
@Service
public class AsyncOrderService {
    
    @Async
    public CompletableFuture<Void> processOrderAsync(Order order) {
        // è·å–å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
        TransactionContext context = TransactionContextManager.getCurrentContext();
        
        return CompletableFuture.supplyAsync(() -> {
            try {
                // åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è®¾ç½®äº‹åŠ¡ä¸Šä¸‹æ–‡
                TransactionContextManager.setCurrentContext(context);
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                return processOrder(order);
            } finally {
                // æ¸…ç†ä¸Šä¸‹æ–‡
                TransactionContextManager.clearContext();
            }
        });
    }
}

// ä½¿ç”¨äº‹åŠ¡æ¨¡æ¿å¤„ç†å¼‚æ­¥æ“ä½œ
@Service  
public class OrderService {
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    public void createOrderWithAsync(Order order) {
        // åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº‹åŠ¡æ“ä½œ
        transactionTemplate.execute(status -> {
            orderDao.save(order);
            
            // å¼‚æ­¥æ“ä½œä¸å‚ä¸ä¸»äº‹åŠ¡
            asyncService.notifyUser(order.getUserId());
            
            return null;
        });
    }
}
```

---

## 4. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡


### 4.1 åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ç‰¹ç‚¹


**ğŸ” åˆ†å¸ƒå¼ vs æœ¬åœ°äº‹åŠ¡ä¸Šä¸‹æ–‡**
```
æœ¬åœ°äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡å™¨A     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ äº‹åŠ¡ä¸Šä¸‹æ–‡   â”‚ â”‚
â”‚  â”‚ - äº‹åŠ¡ID    â”‚ â”‚  
â”‚  â”‚ - è¿æ¥ä¿¡æ¯   â”‚ â”‚
â”‚  â”‚ - çŠ¶æ€ä¿¡æ¯   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡å™¨A     â”‚    â”‚  åº”ç”¨æœåŠ¡å™¨B     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚å…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡â”‚ â”‚â—„â”€â”€â–ºâ”‚  â”‚å…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡â”‚ â”‚
â”‚  â”‚- å…¨å±€äº‹åŠ¡ID â”‚ â”‚    â”‚  â”‚- å…¨å±€äº‹åŠ¡ID â”‚ â”‚
â”‚  â”‚- åˆ†æ”¯äº‹åŠ¡ID â”‚ â”‚    â”‚  â”‚- åˆ†æ”¯äº‹åŠ¡ID â”‚ â”‚
â”‚  â”‚- åè°ƒè€…ä¿¡æ¯ â”‚ â”‚    â”‚  â”‚- åè°ƒè€…ä¿¡æ¯ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡æ ¸å¿ƒç‰¹å¾**
```
ğŸ”¸ å…¨å±€å”¯ä¸€æ€§
â€¢ å…¨å±€äº‹åŠ¡IDï¼ˆGIDï¼‰ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†
â€¢ åˆ†æ”¯äº‹åŠ¡IDï¼ˆBIDï¼‰ï¼šæ¯ä¸ªå‚ä¸èŠ‚ç‚¹çš„äº‹åŠ¡åˆ†æ”¯æ ‡è¯†
â€¢ ç¡®ä¿æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº‹åŠ¡çš„å”¯ä¸€æ€§

ğŸ”¸ è·¨æœåŠ¡ä¼ æ’­
â€¢ HTTPå¤´ä¼ é€’ï¼šé€šè¿‡HTTPè¯·æ±‚å¤´ä¼ é€’äº‹åŠ¡ä¿¡æ¯
â€¢ RPCè°ƒç”¨ä¼ é€’ï¼šåœ¨RPCæ¡†æ¶ä¸­è‡ªåŠ¨ä¼ æ’­ä¸Šä¸‹æ–‡
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’ï¼šé€šè¿‡æ¶ˆæ¯å±æ€§ä¼ é€’äº‹åŠ¡æ ‡è¯†

ğŸ”¸ çŠ¶æ€åŒæ­¥
â€¢ å…¨å±€çŠ¶æ€ç®¡ç†ï¼šæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€éœ€è¦åŒæ­¥
â€¢ äºŒé˜¶æ®µæäº¤ï¼šprepareå’Œcommité˜¶æ®µçš„çŠ¶æ€åè°ƒ
â€¢ å¼‚å¸¸å¤„ç†ï¼šä»»ä¸€èŠ‚ç‚¹å¼‚å¸¸æ—¶çš„å…¨å±€å›æ»š

ğŸ”¸ è¶…æ—¶ç®¡ç†
â€¢ å…¨å±€è¶…æ—¶ï¼šæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„è¶…æ—¶æ§åˆ¶
â€¢ åˆ†æ”¯è¶…æ—¶ï¼šå•ä¸ªæœåŠ¡èŠ‚ç‚¹çš„è¶…æ—¶è®¾ç½®
â€¢ çº§è”è¶…æ—¶ï¼šè¶…æ—¶å¼‚å¸¸çš„çº§è”å¤„ç†
```

### 4.2 Seataåˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡


**ğŸ”§ Seataä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶**
```java
// Seataå…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡
public class SeataTransactionContext {
    
    // å¼€å¯å…¨å±€äº‹åŠ¡
    @GlobalTransactional
    public void createOrderWithPayment(Order order) {
        // è·å–å…¨å±€äº‹åŠ¡ID
        String xid = RootContext.getXID();
        log.info("å¼€å§‹å…¨å±€äº‹åŠ¡: {}", xid);
        
        try {
            // è°ƒç”¨è®¢å•æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨ä¼ æ’­äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼‰
            orderService.createOrder(order);
            
            // è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆåˆ†æ”¯äº‹åŠ¡ï¼‰
            paymentService.processPayment(order.getPayment());
            
            // è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆåˆ†æ”¯äº‹åŠ¡ï¼‰
            inventoryService.deductStock(order.getItems());
            
        } catch (Exception e) {
            // å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»šæ‰€æœ‰åˆ†æ”¯äº‹åŠ¡
            log.error("å…¨å±€äº‹åŠ¡å›æ»š: {}", xid, e);
            throw e;
        }
    }
}

// åˆ†æ”¯äº‹åŠ¡å‚ä¸è€…
@Service
public class PaymentService {
    
    // æœ¬åœ°äº‹åŠ¡æ³¨è§£ï¼Œå‚ä¸å…¨å±€äº‹åŠ¡
    @Transactional
    public void processPayment(Payment payment) {
        // è·å–å…¨å±€äº‹åŠ¡IDå’Œåˆ†æ”¯ID
        String xid = RootContext.getXID();
        Long branchId = RootContext.getBranchId();
        
        log.info("æ‰§è¡Œæ”¯ä»˜åˆ†æ”¯äº‹åŠ¡ - XID: {}, BranchID: {}", xid, branchId);
        
        // æ‰§è¡Œæ”¯ä»˜é€»è¾‘
        paymentDao.save(payment);
    }
}
```

### 4.3 åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡ä¼ æ’­å®ç°


**ğŸŒ HTTPä¼ æ’­æ–¹å¼**
```java
// HTTPè¯·æ±‚æ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨ä¼ æ’­äº‹åŠ¡ä¸Šä¸‹æ–‡
@Component
public class TransactionContextInterceptor implements HandlerInterceptor {
    
    private static final String TX_XID_HEADER = "TX_XID";
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        // ä»HTTPå¤´ä¸­è·å–äº‹åŠ¡ID
        String xid = request.getHeader(TX_XID_HEADER);
        
        if (StringUtils.hasText(xid)) {
            // ç»‘å®šåˆ°å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
            RootContext.bind(xid);
            log.debug("ç»‘å®šå…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡: {}", xid);
        }
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request,
                              HttpServletResponse response,
                              Object handler, Exception ex) {
        // æ¸…ç†äº‹åŠ¡ä¸Šä¸‹æ–‡
        String xid = RootContext.getXID();
        if (StringUtils.hasText(xid)) {
            RootContext.unbind();
            log.debug("æ¸…ç†å…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡: {}", xid);
        }
    }
}

// Feignå®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼Œä¼ æ’­äº‹åŠ¡ä¸Šä¸‹æ–‡
@Component
public class TransactionFeignInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // è·å–å½“å‰çº¿ç¨‹çš„å…¨å±€äº‹åŠ¡ID
        String xid = RootContext.getXID();
        
        if (StringUtils.hasText(xid)) {
            // æ·»åŠ åˆ°HTTPè¯·æ±‚å¤´
            template.header("TX_XID", xid);
            log.debug("ä¼ æ’­å…¨å±€äº‹åŠ¡ä¸Šä¸‹æ–‡: {}", xid);
        }
    }
}
```

---

## 5. ğŸ“¦ ä¸Šä¸‹æ–‡åºåˆ—åŒ–ä¸ä¼ è¾“


### 5.1 ä¸Šä¸‹æ–‡åºåˆ—åŒ–çš„å¿…è¦æ€§


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–ï¼Ÿ**
```
è·¨ç½‘ç»œä¼ è¾“çš„åœºæ™¯ï¼š

æœåŠ¡Aï¼ˆè®¢å•æœåŠ¡ï¼‰
    â†“ [RPCè°ƒç”¨]
æœåŠ¡Bï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰  
    â†“ [æ¶ˆæ¯é˜Ÿåˆ—]
æœåŠ¡Cï¼ˆé€šçŸ¥æœåŠ¡ï¼‰

é—®é¢˜ï¼šJavaå¯¹è±¡æ— æ³•ç›´æ¥åœ¨ç½‘ç»œé—´ä¼ è¾“
è§£å†³ï¼šå°†äº‹åŠ¡ä¸Šä¸‹æ–‡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµæˆ–æ–‡æœ¬æ ¼å¼
```

### 5.2 åºåˆ—åŒ–æ ¼å¼é€‰æ‹©


**ğŸ“Š å¸¸è§åºåˆ—åŒ–æ ¼å¼å¯¹æ¯”**

| æ ¼å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|-----|---------|---------|------------|
| `JSON` | `æ˜“è¯»ã€è·¨è¯­è¨€ã€è½»é‡` | `æ— ç±»å‹ä¿¡æ¯ã€æ€§èƒ½ä¸€èˆ¬` | `HTTPä¼ è¾“ã€è°ƒè¯•` |
| `Protobuf` | `é«˜æ€§èƒ½ã€ç´§å‡‘ã€æœ‰schema` | `éœ€è¦é¢„å®šä¹‰ã€ä¸æ˜“è¯»` | `é«˜æ€§èƒ½RPC` |
| `Javaåºåˆ—åŒ–` | `å®Œæ•´å¯¹è±¡ã€ç±»å‹å®‰å…¨` | `ä»…Javaã€ä½“ç§¯å¤§` | `Javaå†…éƒ¨è°ƒç”¨` |
| `Avro` | `schemaæ¼”åŒ–ã€ç´§å‡‘` | `å¤æ‚ã€å­¦ä¹ æˆæœ¬é«˜` | `æ•°æ®å­˜å‚¨ä¼ è¾“` |

**ğŸ”§ JSONåºåˆ—åŒ–ç¤ºä¾‹**
```java
// äº‹åŠ¡ä¸Šä¸‹æ–‡çš„JSONåºåˆ—åŒ–
public class TransactionContextSerializer {
    
    private static final ObjectMapper mapper = new ObjectMapper();
    
    // åºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²
    public static String serialize(TransactionContext context) {
        try {
            TransactionContextDto dto = new TransactionContextDto();
            dto.setTransactionId(context.getTransactionId());
            dto.setStatus(context.getStatus().name());
            dto.setIsolationLevel(context.getIsolationLevel().value());
            dto.setReadOnly(context.isReadOnly());
            dto.setTimeout(context.getTimeout());
            dto.setStartTime(context.getStartTime());
            
            return mapper.writeValueAsString(dto);
        } catch (Exception e) {
            throw new RuntimeException("äº‹åŠ¡ä¸Šä¸‹æ–‡åºåˆ—åŒ–å¤±è´¥", e);
        }
    }
    
    // ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–
    public static TransactionContext deserialize(String json) {
        try {
            TransactionContextDto dto = mapper.readValue(json, 
                TransactionContextDto.class);
            
            TransactionContext context = new TransactionContext();
            context.setTransactionId(dto.getTransactionId());
            context.setStatus(TransactionStatus.valueOf(dto.getStatus()));
            context.setIsolationLevel(IsolationLevel.valueOf(dto.getIsolationLevel()));
            context.setReadOnly(dto.isReadOnly());
            context.setTimeout(dto.getTimeout());
            context.setStartTime(dto.getStartTime());
            
            return context;
        } catch (Exception e) {
            throw new RuntimeException("äº‹åŠ¡ä¸Šä¸‹æ–‡ååºåˆ—åŒ–å¤±è´¥", e);
        }
    }
}

// ä¼ è¾“æ•°æ®å¯¹è±¡
public class TransactionContextDto {
    private String transactionId;
    private String status;
    private int isolationLevel;
    private boolean readOnly;
    private int timeout;
    private long startTime;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

### 5.3 ä¼ è¾“é€šé“ä¸åè®®


**ğŸŒ ä¸åŒä¼ è¾“æ–¹å¼çš„ä¸Šä¸‹æ–‡å¤„ç†**
```
ğŸ”¸ HTTPä¼ è¾“
â€¢ è¯·æ±‚å¤´ï¼šé€‚åˆè½»é‡çº§çš„äº‹åŠ¡æ ‡è¯†
â€¢ è¯·æ±‚ä½“ï¼šé€‚åˆå¤æ‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ Cookieï¼šé€‚åˆä¼šè¯çº§çš„äº‹åŠ¡ä¿¡æ¯

ğŸ”¸ RPCä¼ è¾“
â€¢ å…ƒæ•°æ®ï¼šgRPCçš„metadataã€Dubboçš„attachment
â€¢ è‡ªå®šä¹‰åè®®ï¼šåœ¨RPCåè®®ä¸­åµŒå…¥äº‹åŠ¡ä¿¡æ¯
â€¢ æ‹¦æˆªå™¨ï¼šåœ¨è°ƒç”¨å‰åè‡ªåŠ¨å¤„ç†ä¸Šä¸‹æ–‡

ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—
â€¢ æ¶ˆæ¯å±æ€§ï¼šå°†äº‹åŠ¡ä¿¡æ¯æ”¾åœ¨æ¶ˆæ¯å¤´éƒ¨
â€¢ æ¶ˆæ¯ä½“ï¼šå°†ä¸Šä¸‹æ–‡ä½œä¸ºæ¶ˆæ¯å†…å®¹çš„ä¸€éƒ¨åˆ†
â€¢ å»¶è¿Ÿæ¶ˆæ¯ï¼šæ”¯æŒäº‹åŠ¡è¶…æ—¶åçš„è¡¥å¿å¤„ç†
```

---

## 6. â° ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 6.1 ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ


**ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

1ï¸âƒ£ åˆå§‹åŒ–é˜¶æ®µ
   â”œâ”€ ç”Ÿæˆå”¯ä¸€äº‹åŠ¡æ ‡è¯†
   â”œâ”€ è®¾ç½®äº‹åŠ¡å±æ€§å’Œé…ç½®
   â”œâ”€ åˆ›å»ºèµ„æºç®¡ç†å™¨
   â””â”€ ç»‘å®šåˆ°æ‰§è¡Œçº¿ç¨‹

2ï¸âƒ£ æ´»è·ƒé˜¶æ®µ
   â”œâ”€ ç®¡ç†æ•°æ®åº“è¿æ¥
   â”œâ”€ è·Ÿè¸ªäº‹åŠ¡æ“ä½œ
   â”œâ”€ å¤„ç†åµŒå¥—äº‹åŠ¡
   â””â”€ ç›‘æ§äº‹åŠ¡çŠ¶æ€

3ï¸âƒ£ å‡†å¤‡é˜¶æ®µï¼ˆåˆ†å¸ƒå¼ï¼‰
   â”œâ”€ åè°ƒå„åˆ†æ”¯äº‹åŠ¡å‡†å¤‡
   â”œâ”€ æ”¶é›†å„èŠ‚ç‚¹çš„æŠ•ç¥¨ç»“æœ
   â”œâ”€ æ£€æŸ¥èµ„æºé”å®šæƒ…å†µ
   â””â”€ å†³å®šæœ€ç»ˆæäº¤æˆ–å›æ»š

4ï¸âƒ£ å®Œæˆé˜¶æ®µ
   â”œâ”€ æ‰§è¡Œæäº¤æˆ–å›æ»šæ“ä½œ
   â”œâ”€ é‡Šæ”¾æ‰€æœ‰å ç”¨èµ„æº
   â”œâ”€ æ¸…ç†ä¸Šä¸‹æ–‡ä¿¡æ¯
   â””â”€ è§£ç»‘çº¿ç¨‹å…³è”
```

### 6.2 èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”§ èµ„æºç®¡ç†ç­–ç•¥**
```java
// äº‹åŠ¡èµ„æºç®¡ç†å™¨
public class TransactionResourceManager {
    
    // äº‹åŠ¡å¼€å§‹æ—¶æ³¨å†Œèµ„æº
    public void registerResource(TransactionContext context, 
                               TransactionalResource resource) {
        try {
            // å°†èµ„æºåŠ å…¥äº‹åŠ¡ä¸Šä¸‹æ–‡
            context.addResource(resource);
            
            // è®¾ç½®èµ„æºçš„äº‹åŠ¡å±æ€§
            resource.setTransactionIsolation(context.getIsolationLevel());
            resource.setReadOnly(context.isReadOnly());
            resource.setQueryTimeout(context.getTimeout());
            
            log.debug("æ³¨å†Œäº‹åŠ¡èµ„æº: {}", resource.getName());
            
        } catch (Exception e) {
            log.error("æ³¨å†Œäº‹åŠ¡èµ„æºå¤±è´¥", e);
            throw new RuntimeException("æ— æ³•æ³¨å†Œäº‹åŠ¡èµ„æº", e);
        }
    }
    
    // äº‹åŠ¡ç»“æŸæ—¶æ¸…ç†èµ„æº
    public void cleanupResources(TransactionContext context) {
        List<TransactionalResource> resources = context.getResources();
        
        for (TransactionalResource resource : resources) {
            try {
                // å…³é—­æ•°æ®åº“è¿æ¥
                if (resource instanceof DataSource) {
                    Connection conn = ((DataSource) resource).getConnection();
                    if (!conn.isClosed()) {
                        conn.close();
                    }
                }
                
                log.debug("æ¸…ç†äº‹åŠ¡èµ„æº: {}", resource.getName());
                
            } catch (Exception e) {
                log.warn("æ¸…ç†èµ„æºå¤±è´¥: {}", resource.getName(), e);
            }
        }
        
        // æ¸…ç©ºèµ„æºåˆ—è¡¨
        context.clearResources();
    }
}
```

### 6.3 è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†


**â° è¶…æ—¶ç®¡ç†æœºåˆ¶**
```java
// äº‹åŠ¡è¶…æ—¶ç›‘æ§å™¨
@Component
public class TransactionTimeoutMonitor {
    
    private final ScheduledExecutorService scheduler = 
        Executors.newScheduledThreadPool(2);
    
    // å¯åŠ¨è¶…æ—¶ç›‘æ§
    public void startTimeoutMonitoring(TransactionContext context) {
        long timeoutSeconds = context.getTimeout();
        
        if (timeoutSeconds > 0) {
            ScheduledFuture<?> timeoutTask = scheduler.schedule(() -> {
                handleTimeout(context);
            }, timeoutSeconds, TimeUnit.SECONDS);
            
            // å°†è¶…æ—¶ä»»åŠ¡å…³è”åˆ°ä¸Šä¸‹æ–‡
            context.setTimeoutTask(timeoutTask);
        }
    }
    
    // å¤„ç†äº‹åŠ¡è¶…æ—¶
    private void handleTimeout(TransactionContext context) {
        String transactionId = context.getTransactionId();
        log.warn("äº‹åŠ¡è¶…æ—¶ï¼Œå¼€å§‹å›æ»š: {}", transactionId);
        
        try {
            // æ ‡è®°äº‹åŠ¡ä¸ºè¶…æ—¶çŠ¶æ€
            context.setStatus(TransactionStatus.TIMEOUT);
            
            // æ‰§è¡Œå›æ»šæ“ä½œ
            rollbackTransaction(context);
            
        } catch (Exception e) {
            log.error("å¤„ç†äº‹åŠ¡è¶…æ—¶å¼‚å¸¸", e);
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            cleanupContext(context);
        }
    }
    
    // å–æ¶ˆè¶…æ—¶ç›‘æ§
    public void cancelTimeoutMonitoring(TransactionContext context) {
        ScheduledFuture<?> timeoutTask = context.getTimeoutTask();
        if (timeoutTask != null && !timeoutTask.isDone()) {
            timeoutTask.cancel(false);
        }
    }
}
```

---

## 7. ğŸ” ä¸Šä¸‹æ–‡å®‰å…¨æ€§ä¿éšœ


### 7.1 å®‰å…¨å¨èƒä¸é˜²æŠ¤


**âš ï¸ ä¸»è¦å®‰å…¨é£é™©**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡é¢ä¸´çš„å®‰å…¨å¨èƒï¼š

ğŸ”¸ ä¿¡æ¯æ³„éœ²é£é™©
â€¢ äº‹åŠ¡IDæ³„éœ²ï¼šå¯èƒ½è¢«æ¶æ„åˆ©ç”¨ä¼ªé€ äº‹åŠ¡
â€¢ æ•°æ®åº“è¿æ¥ä¿¡æ¯æ³„éœ²ï¼šæš´éœ²æ•°æ®åº“è®¿é—®å‡­æ®
â€¢ ä¸šåŠ¡æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼šäº‹åŠ¡ä¸­åŒ…å«çš„ä¸šåŠ¡æ•°æ®

ğŸ”¸ ä¼ªé€ æ”»å‡»é£é™©  
â€¢ äº‹åŠ¡IDä¼ªé€ ï¼šæ¶æ„æ„é€ è™šå‡çš„äº‹åŠ¡æ ‡è¯†
â€¢ çŠ¶æ€ç¯¡æ”¹ï¼šéæ³•ä¿®æ”¹äº‹åŠ¡çŠ¶æ€ä¿¡æ¯
â€¢ æƒé™ç»•è¿‡ï¼šåˆ©ç”¨äº‹åŠ¡ä¸Šä¸‹æ–‡ç»•è¿‡æƒé™æ£€æŸ¥

ğŸ”¸ æ‹’ç»æœåŠ¡é£é™©
â€¢ äº‹åŠ¡æ´ªæ³›ï¼šå¤§é‡æ— æ•ˆäº‹åŠ¡æ¶ˆè€—ç³»ç»Ÿèµ„æº
â€¢ é•¿äº‹åŠ¡æ”»å‡»ï¼šæ•…æ„åˆ›å»ºé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
â€¢ èµ„æºè€—å°½ï¼šé€šè¿‡äº‹åŠ¡å ç”¨è¿‡å¤šç³»ç»Ÿèµ„æº
```

### 7.2 è®¿é—®æ§åˆ¶ä¸æƒé™éªŒè¯


**ğŸ”’ å®‰å…¨æ§åˆ¶æœºåˆ¶**
```java
// äº‹åŠ¡å®‰å…¨ç®¡ç†å™¨
@Component
public class TransactionSecurityManager {
    
    // éªŒè¯äº‹åŠ¡è®¿é—®æƒé™
    public boolean validateTransactionAccess(String transactionId, 
                                           String userId, 
                                           String operation) {
        try {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®æ­¤äº‹åŠ¡
            TransactionContext context = getTransactionContext(transactionId);
            
            if (context == null) {
                log.warn("å°è¯•è®¿é—®ä¸å­˜åœ¨çš„äº‹åŠ¡: {}", transactionId);
                return false;
            }
            
            // éªŒè¯äº‹åŠ¡æ‰€æœ‰è€…
            if (!context.getOwner().equals(userId)) {
                log.warn("ç”¨æˆ· {} å°è¯•è®¿é—®ä»–äººäº‹åŠ¡: {}", userId, transactionId);
                return false;
            }
            
            // éªŒè¯æ“ä½œæƒé™
            if (!hasOperationPermission(userId, operation)) {
                log.warn("ç”¨æˆ· {} æ— æƒæ‰§è¡Œæ“ä½œ: {}", userId, operation);
                return false;
            }
            
            return true;
            
        } catch (Exception e) {
            log.error("éªŒè¯äº‹åŠ¡è®¿é—®æƒé™å¤±è´¥", e);
            return false;
        }
    }
    
    // åŠ å¯†æ•æ„Ÿä¿¡æ¯
    public String encryptSensitiveData(String data) {
        try {
            // ä½¿ç”¨AESåŠ å¯†æ•æ„Ÿä¿¡æ¯
            SecretKeySpec secretKey = new SecretKeySpec(
                getEncryptionKey(), "AES");
            Cipher cipher = Cipher.getInstance("AES");
            cipher.init(Cipher.ENCRYPT_MODE, secretKey);
            
            byte[] encrypted = cipher.doFinal(data.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
            
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // è®°å½•å®‰å…¨äº‹ä»¶
    public void logSecurityEvent(String eventType, String details) {
        SecurityEvent event = new SecurityEvent();
        event.setEventType(eventType);
        event.setDetails(details);
        event.setTimestamp(System.currentTimeMillis());
        event.setSourceIp(getCurrentClientIp());
        
        securityEventLogger.log(event);
    }
}
```

### 7.3 æ•°æ®ä¿æŠ¤ä¸éšç§


**ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ç­–ç•¥**
```java
// æ•æ„Ÿæ•°æ®å¤„ç†å™¨
public class SensitiveDataProcessor {
    
    // è„±æ•å¤„ç†
    public TransactionContext sanitizeContext(TransactionContext context) {
        TransactionContext sanitized = context.clone();
        
        // ç§»é™¤æ•æ„Ÿä¿¡æ¯
        sanitized.setDatabasePassword(null);
        sanitized.setUserCredentials(null);
        
        // è„±æ•æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
        String url = sanitized.getDatabaseUrl();
        if (url != null) {
            sanitized.setDatabaseUrl(maskSensitiveInfo(url));
        }
        
        return sanitized;
    }
    
    // æ©ç æ•æ„Ÿä¿¡æ¯
    private String maskSensitiveInfo(String input) {
        if (input == null || input.length() <= 4) {
            return "****";
        }
        
        int visibleLength = Math.min(4, input.length() / 4);
        String visible = input.substring(0, visibleLength);
        String masked = "*".repeat(input.length() - visibleLength);
        
        return visible + masked;
    }
}
```

---

## 8. ğŸ”§ ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æœºåˆ¶


### 8.1 ç»Ÿä¸€ä¸Šä¸‹æ–‡ç®¡ç†æ¶æ„


**ğŸ—ï¸ å®Œæ•´ç®¡ç†æ¶æ„è®¾è®¡**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ä¸šåŠ¡æœåŠ¡A   â”‚ â”‚ ä¸šåŠ¡æœåŠ¡B   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       äº‹åŠ¡ç®¡ç†å±‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚    äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ä¸Šä¸‹æ–‡   â”‚ â”‚ä¼ æ’­     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚å­˜å‚¨å™¨   â”‚ â”‚ç®¡ç†å™¨   â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       èµ„æºç®¡ç†å±‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æ•°æ®åº“è¿æ¥  â”‚ â”‚ æ¶ˆæ¯é˜Ÿåˆ—   â”‚    â”‚
â”‚  â”‚ ç®¡ç†å™¨      â”‚ â”‚ ç®¡ç†å™¨     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ ¸å¿ƒç®¡ç†ç»„ä»¶


**ğŸ”§ å®Œæ•´ç®¡ç†å™¨å®ç°**
```java
// äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸»ç±»
@Component
public class TransactionContextManager {
    
    @Autowired
    private TransactionContextStorage storage;
    
    @Autowired
    private TransactionPropagationManager propagation;
    
    @Autowired
    private TransactionResourceManager resourceManager;
    
    @Autowired
    private TransactionSecurityManager securityManager;
    
    // åˆ›å»ºæ–°çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
    public TransactionContext createContext(TransactionDefinition definition) {
        // ç”Ÿæˆå”¯ä¸€äº‹åŠ¡ID
        String transactionId = generateTransactionId();
        
        // åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡
        TransactionContext context = new TransactionContext();
        context.setTransactionId(transactionId);
        context.setIsolationLevel(definition.getIsolationLevel());
        context.setPropagationBehavior(definition.getPropagationBehavior());
        context.setTimeout(definition.getTimeout());
        context.setReadOnly(definition.isReadOnly());
        context.setStartTime(System.currentTimeMillis());
        context.setStatus(TransactionStatus.ACTIVE);
        
        // å­˜å‚¨ä¸Šä¸‹æ–‡
        storage.storeContext(context);
        
        // ç»‘å®šåˆ°å½“å‰çº¿ç¨‹
        bindToCurrentThread(context);
        
        log.info("åˆ›å»ºäº‹åŠ¡ä¸Šä¸‹æ–‡: {}", transactionId);
        return context;
    }
    
    // è·å–å½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡
    public TransactionContext getCurrentContext() {
        return storage.getCurrentThreadContext();
    }
    
    // æäº¤äº‹åŠ¡
    public void commit(TransactionContext context) {
        String transactionId = context.getTransactionId();
        
        try {
            // æ£€æŸ¥æƒé™
            securityManager.validateTransactionAccess(
                transactionId, getCurrentUserId(), "COMMIT");
            
            // æ›´æ–°çŠ¶æ€ä¸ºæäº¤ä¸­
            context.setStatus(TransactionStatus.COMMITTING);
            
            // æäº¤æ‰€æœ‰èµ„æº
            resourceManager.commitAll(context);
            
            // æ›´æ–°çŠ¶æ€ä¸ºå·²æäº¤
            context.setStatus(TransactionStatus.COMMITTED);
            
            log.info("äº‹åŠ¡æäº¤æˆåŠŸ: {}", transactionId);
            
        } catch (Exception e) {
            log.error("äº‹åŠ¡æäº¤å¤±è´¥: {}", transactionId, e);
            rollback(context);
            throw e;
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            cleanup(context);
        }
    }
    
    // å›æ»šäº‹åŠ¡
    public void rollback(TransactionContext context) {
        String transactionId = context.getTransactionId();
        
        try {
            // æ›´æ–°çŠ¶æ€ä¸ºå›æ»šä¸­
            context.setStatus(TransactionStatus.ROLLING_BACK);
            
            // å›æ»šæ‰€æœ‰èµ„æº
            resourceManager.rollbackAll(context);
            
            // æ›´æ–°çŠ¶æ€ä¸ºå·²å›æ»š
            context.setStatus(TransactionStatus.ROLLED_BACK);
            
            log.info("äº‹åŠ¡å›æ»šæˆåŠŸ: {}", transactionId);
            
        } catch (Exception e) {
            log.error("äº‹åŠ¡å›æ»šå¤±è´¥: {}", transactionId, e);
            context.setStatus(TransactionStatus.UNKNOWN);
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            cleanup(context);
        }
    }
    
    // æ¸…ç†äº‹åŠ¡ä¸Šä¸‹æ–‡
    private void cleanup(TransactionContext context) {
        try {
            // è§£ç»‘çº¿ç¨‹
            unbindFromCurrentThread();
            
            // æ¸…ç†èµ„æº
            resourceManager.cleanupResources(context);
            
            // ç§»é™¤å­˜å‚¨
            storage.removeContext(context.getTransactionId());
            
        } catch (Exception e) {
            log.warn("æ¸…ç†äº‹åŠ¡ä¸Šä¸‹æ–‡å¼‚å¸¸", e);
        }
    }
}
```

### 8.3 é…ç½®ä¸ç›‘æ§


**ğŸ“Š ç®¡ç†é…ç½®ç¤ºä¾‹**
```java
// äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†é…ç½®
@Configuration
@EnableTransactionManagement
public class TransactionContextConfig {
    
    @Bean
    public TransactionContextManager transactionContextManager() {
        TransactionContextManager manager = new TransactionContextManager();
        
        // é…ç½®å­˜å‚¨ç­–ç•¥
        manager.setStorageStrategy(StorageStrategy.THREAD_LOCAL);
        
        // é…ç½®ä¼ æ’­ç­–ç•¥
        manager.setPropagationStrategy(PropagationStrategy.REQUIRED);
        
        // é…ç½®å®‰å…¨ç­–ç•¥
        manager.setSecurityEnabled(true);
        
        // é…ç½®ç›‘æ§ç­–ç•¥
        manager.setMonitoringEnabled(true);
        
        return manager;
    }
    
    // äº‹åŠ¡ç›‘æ§é…ç½®
    @Bean
    public TransactionMonitor transactionMonitor() {
        TransactionMonitor monitor = new TransactionMonitor();
        
        // é…ç½®ç›‘æ§æŒ‡æ ‡
        monitor.setEnablePerformanceMetrics(true);
        monitor.setEnableSecurityMetrics(true);
        monitor.setEnableResourceMetrics(true);
        
        // é…ç½®å‘Šè­¦é˜ˆå€¼
        monitor.setMaxTransactionDuration(Duration.ofMinutes(30));
        monitor.setMaxConcurrentTransactions(1000);
        monitor.setMaxResourceUsage(0.8);
        
        return monitor;
    }
}
```

---

## 9. âš¡ ä¸Šä¸‹æ–‡ä¼˜åŒ–ç­–ç•¥


### 9.1 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯


**ğŸš€ æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç‚¹ï¼š

ğŸ”¸ å†…å­˜ä¼˜åŒ–
â€¢ å¯¹è±¡æ± ï¼šå¤ç”¨äº‹åŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå‡å°‘GCå‹åŠ›
â€¢ å»¶è¿ŸåŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»ºå¤æ‚å¯¹è±¡
â€¢ å¼±å¼•ç”¨ï¼šå¯¹äºå¤§å¯¹è±¡ä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼

ğŸ”¸ CPUä¼˜åŒ–
â€¢ ç¼“å­˜æœºåˆ¶ï¼šç¼“å­˜é¢‘ç¹è®¿é—®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ æ‰¹é‡å¤„ç†ï¼šåˆå¹¶å¤šä¸ªå°æ“ä½œä¸ºæ‰¹é‡æ“ä½œ
â€¢ å¼‚æ­¥å¤„ç†ï¼šéå…³é”®è·¯å¾„æ“ä½œå¼‚æ­¥æ‰§è¡Œ

ğŸ”¸ ç½‘ç»œä¼˜åŒ–
â€¢ å‹ç¼©ä¼ è¾“ï¼šå‹ç¼©åºåˆ—åŒ–åçš„ä¸Šä¸‹æ–‡æ•°æ®
â€¢ è¿æ¥å¤ç”¨ï¼šå¤ç”¨ç½‘ç»œè¿æ¥å‡å°‘å»ºè¿å¼€é”€
â€¢ æœ¬åœ°ç¼“å­˜ï¼šåœ¨æœ¬åœ°ç¼“å­˜è¿œç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯
```

### 9.2 ç¼“å­˜ä¼˜åŒ–æœºåˆ¶


**ğŸ’¾ ä¸Šä¸‹æ–‡ç¼“å­˜ç­–ç•¥**
```java
// äº‹åŠ¡ä¸Šä¸‹æ–‡ç¼“å­˜ç®¡ç†å™¨
@Component
public class TransactionContextCache {
    
    // ä½¿ç”¨Caffeineä½œä¸ºæœ¬åœ°ç¼“å­˜
    private final Cache<String, TransactionContext> localCache = 
        Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(Duration.ofMinutes(30))
            .recordStats()
            .build();
    
    // ä½¿ç”¨Redisä½œä¸ºåˆ†å¸ƒå¼ç¼“å­˜
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // è·å–äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼ˆä¼˜å…ˆæœ¬åœ°ç¼“å­˜ï¼‰
    public TransactionContext getContext(String transactionId) {
        // å…ˆä»æœ¬åœ°ç¼“å­˜è·å–
        TransactionContext context = localCache.getIfPresent(transactionId);
        
        if (context != null) {
            return context;
        }
        
        // ä»Redisè·å–
        String cacheKey = "tx_context:" + transactionId;
        String contextJson = redisTemplate.opsForValue().get(cacheKey);
        
        if (contextJson != null) {
            context = deserializeContext(contextJson);
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(transactionId, context);
            return context;
        }
        
        return null;
    }
    
    // ç¼“å­˜äº‹åŠ¡ä¸Šä¸‹æ–‡
    public void putContext(TransactionContext context) {
        String transactionId = context.getTransactionId();
        
        // æ›´æ–°æœ¬åœ°ç¼“å­˜
        localCache.put(transactionId, context);
        
        // æ›´æ–°Redisç¼“å­˜
        String cacheKey = "tx_context:" + transactionId;
        String contextJson = serializeContext(context);
        redisTemplate.opsForValue().set(cacheKey, contextJson, 
            Duration.ofMinutes(30));
    }
    
    // ç§»é™¤ç¼“å­˜
    public void removeContext(String transactionId) {
        localCache.invalidate(transactionId);
        
        String cacheKey = "tx_context:" + transactionId;
        redisTemplate.delete(cacheKey);
    }
}
```

### 9.3 èµ„æºæ± åŒ–æŠ€æœ¯


**ğŸŠ è¿æ¥æ± ä¼˜åŒ–**
```java
// äº‹åŠ¡è¿æ¥æ± ç®¡ç†å™¨
@Component
public class TransactionConnectionPoolManager {
    
    // é…ç½®ä¸åŒéš”ç¦»çº§åˆ«çš„è¿æ¥æ± 
    private final Map<IsolationLevel, HikariDataSource> connectionPools = 
        new EnumMap<>(IsolationLevel.class);
    
    @PostConstruct
    public void initConnectionPools() {
        // ä¸ºæ¯ä¸ªéš”ç¦»çº§åˆ«åˆ›å»ºç‹¬ç«‹çš„è¿æ¥æ± 
        for (IsolationLevel level : IsolationLevel.values()) {
            HikariConfig config = new HikariConfig();
            config.setJdbcUrl(getJdbcUrl());
            config.setUsername(getUsername());
            config.setPassword(getPassword());
            
            // æ ¹æ®éš”ç¦»çº§åˆ«ä¼˜åŒ–è¿æ¥æ± é…ç½®
            switch (level) {
                case READ_UNCOMMITTED:
                    config.setMaximumPoolSize(50);
                    config.setConnectionTimeout(5000);
                    break;
                case READ_COMMITTED:
                    config.setMaximumPoolSize(100);
                    config.setConnectionTimeout(10000);
                    break;
                case REPEATABLE_READ:
                    config.setMaximumPoolSize(80);
                    config.setConnectionTimeout(15000);
                    break;
                case SERIALIZABLE:
                    config.setMaximumPoolSize(30);
                    config.setConnectionTimeout(20000);
                    break;
            }
            
            connectionPools.put(level, new HikariDataSource(config));
        }
    }
    
    // æ ¹æ®äº‹åŠ¡ä¸Šä¸‹æ–‡è·å–è¿æ¥
    public Connection getConnection(TransactionContext context) {
        IsolationLevel level = context.getIsolationLevel();
        HikariDataSource dataSource = connectionPools.get(level);
        
        try {
            Connection connection = dataSource.getConnection();
            
            // è®¾ç½®äº‹åŠ¡å±æ€§
            connection.setAutoCommit(false);
            connection.setTransactionIsolation(level.value());
            connection.setReadOnly(context.isReadOnly());
            
            return connection;
            
        } catch (SQLException e) {
            throw new RuntimeException("è·å–æ•°æ®åº“è¿æ¥å¤±è´¥", e);
        }
    }
}
```

---

## 10. ğŸš¨ ä¸Šä¸‹æ–‡å¼‚å¸¸å¤„ç†


### 10.1 å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†ç­–ç•¥


**âš ï¸ å¼‚å¸¸ç±»å‹åˆ†æ**
```
äº‹åŠ¡ä¸Šä¸‹æ–‡å¼‚å¸¸çš„ä¸»è¦ç±»å‹ï¼š

ğŸ”¸ ç³»ç»Ÿå¼‚å¸¸
â€¢ ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼šç½‘ç»œä¸­æ–­ã€è¿æ¥è¶…æ—¶
â€¢ æ•°æ®åº“å¼‚å¸¸ï¼šè¿æ¥å¤±è´¥ã€SQLæ‰§è¡Œé”™è¯¯
â€¢ èµ„æºä¸è¶³å¼‚å¸¸ï¼šå†…å­˜ä¸è¶³ã€è¿æ¥æ± è€—å°½

ğŸ”¸ ä¸šåŠ¡å¼‚å¸¸
â€¢ æ•°æ®éªŒè¯å¼‚å¸¸ï¼šæ•°æ®æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡è§„åˆ™å†²çª
â€¢ æƒé™å¼‚å¸¸ï¼šæ— æƒé™è®¿é—®ã€æ“ä½œè¢«æ‹’ç»
â€¢ çŠ¶æ€å¼‚å¸¸ï¼šäº‹åŠ¡çŠ¶æ€ä¸æ­£ç¡®ã€é‡å¤æ“ä½œ

ğŸ”¸ é…ç½®å¼‚å¸¸
â€¢ å‚æ•°é…ç½®é”™è¯¯ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®ä¸å½“
â€¢ ç‰ˆæœ¬å…¼å®¹å¼‚å¸¸ï¼šä¸åŒç‰ˆæœ¬é—´çš„å…¼å®¹æ€§é—®é¢˜
â€¢ ç¯å¢ƒå¼‚å¸¸ï¼šå¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå·®å¼‚
```

### 10.2 å¼‚å¸¸æ¢å¤æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ¢å¤ç­–ç•¥**
```java
// äº‹åŠ¡å¼‚å¸¸å¤„ç†å™¨
@Component
public class TransactionExceptionHandler {
    
    // å¤„ç†äº‹åŠ¡å¼‚å¸¸
    public void handleTransactionException(TransactionContext context, 
                                         Exception exception) {
        String transactionId = context.getTransactionId();
        
        // è®°å½•å¼‚å¸¸ä¿¡æ¯
        logException(transactionId, exception);
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹é‡‡å–ä¸åŒçš„å¤„ç†ç­–ç•¥
        if (exception instanceof SQLTransientException) {
            // ç½‘ç»œæˆ–ä¸´æ—¶æ€§å¼‚å¸¸ï¼Œå°è¯•é‡è¯•
            handleRetryableException(context, exception);
            
        } else if (exception instanceof SQLDataException) {
            // æ•°æ®å¼‚å¸¸ï¼Œç›´æ¥å›æ»š
            handleNonRetryableException(context, exception);
            
        } else if (exception instanceof TimeoutException) {
            // è¶…æ—¶å¼‚å¸¸ï¼Œæ£€æŸ¥äº‹åŠ¡çŠ¶æ€åå†³å®šå¤„ç†æ–¹å¼
            handleTimeoutException(context, exception);
            
        } else {
            // å…¶ä»–å¼‚å¸¸ï¼Œé»˜è®¤å›æ»šå¤„ç†
            handleDefaultException(context, exception);
        }
    }
    
    // å¤„ç†å¯é‡è¯•å¼‚å¸¸
    private void handleRetryableException(TransactionContext context, 
                                        Exception exception) {
        int retryCount = context.getRetryCount();
        int maxRetries = context.getMaxRetries();
        
        if (retryCount < maxRetries) {
            // å¢åŠ é‡è¯•è®¡æ•°
            context.setRetryCount(retryCount + 1);
            
            // å»¶è¿Ÿé‡è¯•
            try {
                Thread.sleep(getRetryDelay(retryCount));
                retryTransaction(context);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                rollbackTransaction(context);
            }
        } else {
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œå›æ»šäº‹åŠ¡
            log.error("äº‹åŠ¡é‡è¯•æ¬¡æ•°è¶…é™ï¼Œå›æ»šäº‹åŠ¡: {}", 
                context.getTransactionId());
            rollbackTransaction(context);
        }
    }
    
    // å¤„ç†è¶…æ—¶å¼‚å¸¸
    private void handleTimeoutException(TransactionContext context, 
                                      Exception exception) {
        // æ£€æŸ¥äº‹åŠ¡æ˜¯å¦å·²ç»æäº¤
        if (isTransactionCommitted(context)) {
            // å·²æäº¤ï¼Œåªéœ€æ¸…ç†èµ„æº
            cleanupResources(context);
        } else {
            // æœªæäº¤ï¼Œæ‰§è¡Œå›æ»š
            rollbackTransaction(context);
        }
    }
    
    // è®¡ç®—é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
    private long getRetryDelay(int retryCount) {
        return Math.min(1000 * (1L << retryCount), 30000);
    }
}
```

### 10.3 å¼‚å¸¸ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š å¼‚å¸¸ç›‘æ§æœºåˆ¶**
```java
// äº‹åŠ¡å¼‚å¸¸ç›‘æ§å™¨
@Component
public class TransactionExceptionMonitor {
    
    // å¼‚å¸¸ç»Ÿè®¡è®¡æ•°å™¨
    private final Counter exceptionCounter = Counter.build()
        .name("transaction_exceptions_total")
        .help("äº‹åŠ¡å¼‚å¸¸æ€»æ•°")
        .labelNames("exception_type", "transaction_type")
        .register();
    
    // å¼‚å¸¸å¤„ç†æ—¶é—´ç»Ÿè®¡
    private final Histogram exceptionHandlingTime = Histogram.build()
        .name("transaction_exception_handling_duration_seconds")
        .help("äº‹åŠ¡å¼‚å¸¸å¤„ç†è€—æ—¶")
        .register();
    
    // è®°å½•å¼‚å¸¸äº‹ä»¶
    public void recordException(String transactionId, 
                              Exception exception,
                              String transactionType) {
        // æ›´æ–°å¼‚å¸¸è®¡æ•°
        exceptionCounter.labels(
            exception.getClass().getSimpleName(),
            transactionType
        ).inc();
        
        // è®°å½•å¼‚å¸¸è¯¦æƒ…
        ExceptionEvent event = new ExceptionEvent();
        event.setTransactionId(transactionId);
        event.setExceptionType(exception.getClass().getSimpleName());
        event.setExceptionMessage(exception.getMessage());
        event.setTimestamp(System.currentTimeMillis());
        event.setStackTrace(getStackTrace(exception));
        
        // å‘é€åˆ°æ—¥å¿—ç³»ç»Ÿ
        exceptionEventLogger.log(event);
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
        checkAlertConditions(exception, transactionType);
    }
    
    // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
    private void checkAlertConditions(Exception exception, 
                                    String transactionType) {
        // ä¸¥é‡å¼‚å¸¸ç«‹å³å‘Šè­¦
        if (isCriticalException(exception)) {
            sendAlert("ä¸¥é‡äº‹åŠ¡å¼‚å¸¸", 
                "å‘ç”Ÿä¸¥é‡äº‹åŠ¡å¼‚å¸¸: " + exception.getMessage());
        }
        
        // æ£€æŸ¥å¼‚å¸¸é¢‘ç‡
        double exceptionRate = getExceptionRate(transactionType);
        if (exceptionRate > 0.1) { // å¼‚å¸¸ç‡è¶…è¿‡10%
            sendAlert("äº‹åŠ¡å¼‚å¸¸ç‡è¿‡é«˜", 
                String.format("äº‹åŠ¡ç±»å‹ %s å¼‚å¸¸ç‡è¾¾åˆ° %.2f%%", 
                    transactionType, exceptionRate * 100));
        }
    }
    
    // å‘é€å‘Šè­¦
    private void sendAlert(String title, String message) {
        // å®ç°å‘Šè­¦å‘é€é€»è¾‘ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰
        alertService.send(title, message);
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡ä¸Šä¸‹æ–‡æœ¬è´¨ï¼šå­˜å‚¨å’Œç®¡ç†äº‹åŠ¡ä¿¡æ¯çš„è¿è¡Œæ—¶ç¯å¢ƒ
ğŸ”¸ ä¼ æ’­æœºåˆ¶ï¼šæ§åˆ¶äº‹åŠ¡åœ¨æ–¹æ³•è°ƒç”¨é“¾ä¸­çš„ä¼ é€’è¡Œä¸º
ğŸ”¸ çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼šç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹äº‹åŠ¡éš”ç¦»
ğŸ”¸ åˆ†å¸ƒå¼ä¸Šä¸‹æ–‡ï¼šè·¨æœåŠ¡çš„å…¨å±€äº‹åŠ¡ä¿¡æ¯ç®¡ç†
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šä»åˆ›å»ºåˆ°é”€æ¯çš„å®Œæ•´è¿‡ç¨‹æ§åˆ¶
ğŸ”¸ å®‰å…¨ä¿éšœï¼šè®¿é—®æ§åˆ¶ã€æ•°æ®ä¿æŠ¤ã€å¼‚å¸¸å¤„ç†
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†**
```
æ ¸å¿ƒä»·å€¼ï¼š
â€¢ çŠ¶æ€ä¸€è‡´æ€§ï¼šç¡®ä¿æ‰€æœ‰å‚ä¸è€…çœ‹åˆ°ç›¸åŒçŠ¶æ€
â€¢ æ“ä½œåè°ƒæ€§ï¼šç»Ÿä¸€ç®¡ç†å¤šèµ„æºäº‹åŠ¡å‚ä¸
â€¢ å¼‚å¸¸æ¢å¤èƒ½åŠ›ï¼šæ”¯æŒæ•…éšœæ¢å¤å’Œäº‹åŠ¡å›æ»š
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥å¤ç”¨ã€æ‰¹é‡æ“ä½œç­‰ä¼˜åŒ–
```

**ğŸ”¹ ä¼ æ’­è¡Œä¸ºçš„é€‰æ‹©åŸåˆ™**
```
é€‰æ‹©æŒ‡å¯¼ï¼š
â€¢ REQUIREDï¼šé»˜è®¤é€‰æ‹©ï¼Œé€‚åˆå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯
â€¢ REQUIRES_NEWï¼šéœ€è¦ç‹¬ç«‹äº‹åŠ¡æ—¶ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰
â€¢ SUPPORTSï¼šæŸ¥è¯¢æ“ä½œï¼Œå¯é€‰äº‹åŠ¡æ”¯æŒ
â€¢ NOT_SUPPORTEDï¼šæ–‡ä»¶æ“ä½œç­‰éäº‹åŠ¡æ€§æ“ä½œ
```

**ğŸ”¹ åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šä¸‹æ–‡çš„å¤æ‚æ€§**
```
å…³é”®æŒ‘æˆ˜ï¼š
â€¢ è·¨ç½‘ç»œä¼ è¾“ï¼šåºåˆ—åŒ–ã€ç½‘ç»œå»¶è¿Ÿã€ä¼ è¾“å®‰å…¨
â€¢ çŠ¶æ€åŒæ­¥ï¼šå¤šèŠ‚ç‚¹çŠ¶æ€ä¸€è‡´æ€§ä¿éšœ
â€¢ å¼‚å¸¸å¤„ç†ï¼šéƒ¨åˆ†å¤±è´¥çš„å¤„ç†ç­–ç•¥
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ç½‘ç»œå¼€é”€ã€æå‡å“åº”é€Ÿåº¦
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
ğŸ¯ è®¾è®¡åŸåˆ™
â€¢ æœ€å°åŒ–ä¸Šä¸‹æ–‡ï¼šåªåŒ…å«å¿…è¦çš„ä¿¡æ¯
â€¢ åŠæ—¶æ¸…ç†ï¼šé¿å…å†…å­˜æ³„æ¼å’Œèµ„æºå ç”¨
â€¢ å¼‚å¸¸å®‰å…¨ï¼šç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹çš„èµ„æºé‡Šæ”¾
â€¢ æ€§èƒ½ä¼˜å…ˆï¼šå¹³è¡¡åŠŸèƒ½éœ€æ±‚ä¸æ€§èƒ½è¦æ±‚

ğŸ¯ æ€§èƒ½ä¼˜åŒ–
â€¢ ä½¿ç”¨è¿æ¥æ± ï¼šé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯è¿æ¥
â€¢ å®æ–½ç¼“å­˜ï¼šç¼“å­˜é¢‘ç¹è®¿é—®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ æ‰¹é‡æ“ä½œï¼šåˆå¹¶å¤šä¸ªæ“ä½œå‡å°‘å¼€é”€
â€¢ å¼‚æ­¥å¤„ç†ï¼šéå…³é”®è·¯å¾„æ“ä½œå¼‚æ­¥æ‰§è¡Œ

ğŸ¯ å®‰å…¨è€ƒè™‘
â€¢ è®¿é—®æ§åˆ¶ï¼šéªŒè¯ç”¨æˆ·å¯¹äº‹åŠ¡çš„è®¿é—®æƒé™
â€¢ æ•°æ®ä¿æŠ¤ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å’Œè„±æ•å¤„ç†
â€¢ å®¡è®¡æ—¥å¿—ï¼šè®°å½•å…³é”®æ“ä½œä¾¿äºè¿½æº¯
â€¢ å¼‚å¸¸ç›‘æ§ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸æƒ…å†µ
```

### 11.4 æ•…éšœæ’æŸ¥æŒ‡å—


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**
```
ğŸ”¸ äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸¢å¤±
â€¢ æ£€æŸ¥ThreadLocalç»‘å®šæ˜¯å¦æ­£ç¡®
â€¢ ç¡®è®¤å¼‚æ­¥è°ƒç”¨æ—¶çš„ä¸Šä¸‹æ–‡ä¼ é€’
â€¢ éªŒè¯åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹

ğŸ”¸ äº‹åŠ¡ä¼ æ’­å¼‚å¸¸
â€¢ æ£€æŸ¥ä¼ æ’­è¡Œä¸ºé…ç½®æ˜¯å¦æ­£ç¡®
â€¢ ç¡®è®¤AOPä»£ç†æ˜¯å¦ç”Ÿæ•ˆ
â€¢ éªŒè¯æ–¹æ³•è°ƒç”¨æ–¹å¼ï¼ˆç›´æ¥è°ƒç”¨vsä»£ç†è°ƒç”¨ï¼‰

ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥
â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å¯ç”¨æ€§
â€¢ ç¡®è®¤äº‹åŠ¡IDçš„ç”Ÿæˆå’Œä¼ é€’
â€¢ éªŒè¯å„èŠ‚ç‚¹çš„äº‹åŠ¡çŠ¶æ€åŒæ­¥

ğŸ”¸ æ€§èƒ½é—®é¢˜æ’æŸ¥
â€¢ ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
â€¢ æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
â€¢ åˆ†æäº‹åŠ¡æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
â€¢ æ’æŸ¥èµ„æºé”ç«äº‰é—®é¢˜
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸Šä¸‹æ–‡ç®¡ç†äº‹åŠ¡é­‚ï¼Œä¼ æ’­æœºåˆ¶æ˜¯å…³é”®
- çº¿ç¨‹æœ¬åœ°ä¿éš”ç¦»ï¼Œåˆ†å¸ƒå…¨å±€è¦åè°ƒ  
- ç”Ÿå‘½å‘¨æœŸä¸¥ç®¡æ§ï¼Œå®‰å…¨é˜²æŠ¤ä¸å¯å°‘
- æ€§èƒ½ä¼˜åŒ–ææ•ˆç‡ï¼Œå¼‚å¸¸å¤„ç†ä¿ç¨³å®š