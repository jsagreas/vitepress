---
title: 6ã€MySQLåµŒå¥—äº‹åŠ¡å®ç°
---
## ğŸ“š ç›®å½•

1. [åµŒå¥—äº‹åŠ¡åŸºç¡€ç†è®º](#1-åµŒå¥—äº‹åŠ¡åŸºç¡€ç†è®º)
2. [MySQLåµŒå¥—äº‹åŠ¡å®ç°æ–¹å¼](#2-MySQLåµŒå¥—äº‹åŠ¡å®ç°æ–¹å¼)
3. [äº‹åŠ¡æ ‘ç»“æ„ç®¡ç†](#3-äº‹åŠ¡æ ‘ç»“æ„ç®¡ç†)
4. [çº§è”å›æ»šæ§åˆ¶æœºåˆ¶](#4-çº§è”å›æ»šæ§åˆ¶æœºåˆ¶)
5. [å­˜å‚¨è¿‡ç¨‹ä¸­çš„äº‹åŠ¡å¤„ç†](#5-å­˜å‚¨è¿‡ç¨‹ä¸­çš„äº‹åŠ¡å¤„ç†)
6. [å¼‚å¸¸å¤„ç†ä¸é”™è¯¯æ¢å¤](#6-å¼‚å¸¸å¤„ç†ä¸é”™è¯¯æ¢å¤)
7. [æ€§èƒ½è€ƒé‡ä¸æœ€ä½³å®è·µ](#7-æ€§èƒ½è€ƒé‡ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ³ åµŒå¥—äº‹åŠ¡åŸºç¡€ç†è®º


### 1.1 ä»€ä¹ˆæ˜¯åµŒå¥—äº‹åŠ¡


**ğŸ”¸ åµŒå¥—äº‹åŠ¡çš„åŸºæœ¬æ¦‚å¿µ**
```
ä¼ ç»Ÿå¹³é¢äº‹åŠ¡ï¼š
BEGIN â†’ æ‰§è¡ŒSQL â†’ COMMIT/ROLLBACK

åµŒå¥—äº‹åŠ¡ï¼š
BEGIN (ä¸»äº‹åŠ¡)
  BEGIN (å­äº‹åŠ¡1)
    æ‰§è¡ŒSQL1
  COMMIT/ROLLBACK (å­äº‹åŠ¡1)
  BEGIN (å­äº‹åŠ¡2)
    æ‰§è¡ŒSQL2
  COMMIT/ROLLBACK (å­äº‹åŠ¡2)
COMMIT/ROLLBACK (ä¸»äº‹åŠ¡)

ç†è§£è¦ç‚¹ï¼š
â€¢ å­äº‹åŠ¡å¯ä»¥ç‹¬ç«‹æäº¤æˆ–å›æ»š
â€¢ çˆ¶äº‹åŠ¡å›æ»šä¼šå½±å“æ‰€æœ‰å­äº‹åŠ¡
â€¢ å­äº‹åŠ¡å›æ»šä¸å½±å“çˆ¶äº‹åŠ¡
```

### 1.2 åµŒå¥—äº‹åŠ¡ç†è®ºæ¨¡å‹


**ğŸ“Š äº‹åŠ¡å±‚æ¬¡ç»“æ„**
```
åµŒå¥—äº‹åŠ¡æ ‘å½¢ç»“æ„ï¼š
          ä¸»äº‹åŠ¡T1
         /    |    \
    å­äº‹åŠ¡A  å­äº‹åŠ¡B  å­äº‹åŠ¡C
      |       |       |
    å­™äº‹åŠ¡A1  å­™äº‹åŠ¡B1  å­™äº‹åŠ¡C1
             /  \
        æ›¾å­™äº‹åŠ¡B1-1 æ›¾å­™äº‹åŠ¡B1-2

å…³é”®ç‰¹æ€§ï¼š
â€¢ çˆ¶å­å…³ç³»ï¼šçˆ¶äº‹åŠ¡æ§åˆ¶å­äº‹åŠ¡
â€¢ ç‹¬ç«‹æ€§ï¼šåŒçº§äº‹åŠ¡ç›¸äº’ç‹¬ç«‹
â€¢ å±‚æ¬¡æ€§ï¼šæ”¯æŒå¤šçº§åµŒå¥—
â€¢ åŸå­æ€§ï¼šæ¯å±‚éƒ½ä¿æŒåŸå­æ€§
```

### 1.3 MySQLå¯¹åµŒå¥—äº‹åŠ¡çš„æ”¯æŒ


**âš ï¸ MySQLçš„é™åˆ¶ä¸æ›¿ä»£æ–¹æ¡ˆ**
```
MySQLåŸç”Ÿé™åˆ¶ï¼š
â€¢ ä¸æ”¯æŒçœŸæ­£çš„åµŒå¥—äº‹åŠ¡
â€¢ BEGIN TRANSACTIONåµŒå¥—ä¼šè¢«å¿½ç•¥
â€¢ åªæœ‰ä¸€ä¸ªæ´»è·ƒäº‹åŠ¡ä¸Šä¸‹æ–‡

æ›¿ä»£å®ç°æ–¹å¼ï¼š
1. SAVEPOINTæœºåˆ¶ï¼ˆä¿å­˜ç‚¹ï¼‰
2. å­˜å‚¨è¿‡ç¨‹ä¸­çš„æ‰‹åŠ¨ç®¡ç†
3. åº”ç”¨å±‚é€»è¾‘æ§åˆ¶
4. å¼‚å¸¸å¤„ç†æœºåˆ¶
```

**ğŸ”§ ç®€å•æµ‹è¯•MySQLåµŒå¥—é™åˆ¶**
```sql
-- æµ‹è¯•åµŒå¥—BEGINçš„è¡Œä¸º
START TRANSACTION;
INSERT INTO test_table VALUES (1, 'outer');

START TRANSACTION;  -- è¿™ä¸ªä¼šè¢«å¿½ç•¥
INSERT INTO test_table VALUES (2, 'inner');

ROLLBACK;  -- å›æ»šæ‰€æœ‰æ“ä½œ
SELECT * FROM test_table;  -- ä¸¤æ¡è®°å½•éƒ½è¢«å›æ»š
```

---

## 2. ğŸ”§ MySQLåµŒå¥—äº‹åŠ¡å®ç°æ–¹å¼


### 2.1 ä½¿ç”¨SAVEPOINTå®ç°ä¼ªåµŒå¥—


**ğŸ”¸ SAVEPOINTçš„å·¥ä½œåŸç†**
```
SAVEPOINTæœºåˆ¶ï¼š
â€¢ åœ¨äº‹åŠ¡ä¸­åˆ›å»ºä¿å­˜ç‚¹
â€¢ å¯ä»¥å›æ»šåˆ°æŒ‡å®šä¿å­˜ç‚¹
â€¢ ä¿å­˜ç‚¹å¯ä»¥åµŒå¥—åˆ›å»º
â€¢ å®ç°ç±»ä¼¼åµŒå¥—äº‹åŠ¡çš„æ•ˆæœ

ä¼˜åŠ¿ï¼š
â€¢ MySQLåŸç”Ÿæ”¯æŒ
â€¢ æ€§èƒ½å¼€é”€è¾ƒå°
â€¢ æ˜“äºç†è§£å’Œå®ç°

é™åˆ¶ï¼š
â€¢ ä¸æ˜¯çœŸæ­£çš„åµŒå¥—äº‹åŠ¡
â€¢ æ‰€æœ‰æ“ä½œä»åœ¨åŒä¸€äº‹åŠ¡ä¸­
```

**ğŸ”§ SAVEPOINTåŸºæœ¬ç”¨æ³•**
```sql
-- åŸºæœ¬SAVEPOINTç¤ºä¾‹
START TRANSACTION;

-- ä¸»äº‹åŠ¡æ“ä½œ
INSERT INTO orders (customer_id, amount) VALUES (1, 100);
SAVEPOINT sp_after_order;

-- å­äº‹åŠ¡æ“ä½œ1
INSERT INTO order_items (order_id, product_id, quantity) VALUES (1, 101, 2);
SAVEPOINT sp_after_items;

-- å­äº‹åŠ¡æ“ä½œ2
UPDATE inventory SET stock = stock - 2 WHERE product_id = 101;

-- å¦‚æœåº“å­˜ä¸è¶³ï¼Œå›æ»šåˆ°å•†å“æ·»åŠ å
-- ROLLBACK TO sp_after_items;

-- æœ€ç»ˆæäº¤
COMMIT;
```

### 2.2 åµŒå¥—ä¿å­˜ç‚¹ç®¡ç†


**ğŸ”§ å¤šçº§ä¿å­˜ç‚¹å®ç°**
```sql
-- åˆ›å»ºæ¼”ç¤ºè¡¨
CREATE TABLE nested_demo (
    id INT AUTO_INCREMENT PRIMARY KEY,
    level_info VARCHAR(50),
    operation_type VARCHAR(20),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å¤šçº§åµŒå¥—ä¿å­˜ç‚¹ç¤ºä¾‹
START TRANSACTION;

-- ç¬¬ä¸€å±‚ï¼šä¸»äº‹åŠ¡
INSERT INTO nested_demo (level_info, operation_type) 
VALUES ('Level 1 - Main Transaction', 'INSERT');
SAVEPOINT level_1;

-- ç¬¬äºŒå±‚ï¼šå­äº‹åŠ¡
INSERT INTO nested_demo (level_info, operation_type) 
VALUES ('Level 2 - Sub Transaction', 'INSERT');
SAVEPOINT level_2;

-- ç¬¬ä¸‰å±‚ï¼šå­™äº‹åŠ¡
INSERT INTO nested_demo (level_info, operation_type) 
VALUES ('Level 3 - Grandson Transaction', 'INSERT');
SAVEPOINT level_3;

-- æ¨¡æ‹Ÿé”™è¯¯ï¼Œå›æ»šåˆ°level_2
ROLLBACK TO level_2;

-- ç»§ç»­å…¶ä»–æ“ä½œ
INSERT INTO nested_demo (level_info, operation_type) 
VALUES ('Level 2 - Alternative Operation', 'INSERT');

COMMIT;

-- æŸ¥çœ‹ç»“æœ
SELECT * FROM nested_demo ORDER BY id;
```

### 2.3 åŠ¨æ€ä¿å­˜ç‚¹å‘½å


**ğŸ”§ ç¨‹åºåŒ–ä¿å­˜ç‚¹ç®¡ç†**
```sql
-- åŠ¨æ€ä¿å­˜ç‚¹å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE CreateNestedSavepoint(
    IN sp_name VARCHAR(64),
    IN parent_sp VARCHAR(64) DEFAULT NULL
)
BEGIN
    DECLARE sp_sql VARCHAR(200);
    
    -- åˆ›å»ºä¿å­˜ç‚¹
    SET sp_sql = CONCAT('SAVEPOINT ', sp_name);
    SET @sql = sp_sql;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- è®°å½•ä¿å­˜ç‚¹ä¿¡æ¯
    INSERT INTO savepoint_log (name, parent, created_at) 
    VALUES (sp_name, parent_sp, NOW());
END //
DELIMITER ;

-- ä½¿ç”¨ç¤ºä¾‹
START TRANSACTION;
CALL CreateNestedSavepoint('main_sp', NULL);
CALL CreateNestedSavepoint('sub_sp', 'main_sp');
```

---

## 3. ğŸŒ² äº‹åŠ¡æ ‘ç»“æ„ç®¡ç†


### 3.1 äº‹åŠ¡æ ‘çš„æ•°æ®ç»“æ„


**ğŸ“Š äº‹åŠ¡å…³ç³»è¡¨è®¾è®¡**
```sql
-- äº‹åŠ¡ç®¡ç†è¡¨
CREATE TABLE transaction_tree (
    tx_id VARCHAR(64) PRIMARY KEY,
    parent_tx_id VARCHAR(64),
    tx_level INT NOT NULL DEFAULT 0,
    tx_status ENUM('ACTIVE', 'COMMITTED', 'ABORTED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    INDEX idx_parent (parent_tx_id),
    INDEX idx_level (tx_level)
);

-- ä¿å­˜ç‚¹ç®¡ç†è¡¨
CREATE TABLE savepoint_registry (
    sp_id VARCHAR(64) PRIMARY KEY,
    tx_id VARCHAR(64) NOT NULL,
    sp_name VARCHAR(64) NOT NULL,
    sp_level INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tx_id) REFERENCES transaction_tree(tx_id)
);
```

### 3.2 äº‹åŠ¡æ ‘æ“ä½œå‡½æ•°


**ğŸ”§ äº‹åŠ¡æ ‘ç®¡ç†å­˜å‚¨è¿‡ç¨‹**
```sql
DELIMITER //

-- å¼€å§‹åµŒå¥—äº‹åŠ¡
CREATE PROCEDURE BeginNestedTransaction(
    IN tx_name VARCHAR(64),
    IN parent_tx VARCHAR(64) DEFAULT NULL,
    OUT new_tx_id VARCHAR(64)
)
BEGIN
    DECLARE tx_level INT DEFAULT 0;
    
    -- ç”Ÿæˆäº‹åŠ¡ID
    SET new_tx_id = CONCAT('TX_', UNIX_TIMESTAMP(), '_', CONNECTION_ID());
    
    -- è®¡ç®—äº‹åŠ¡å±‚çº§
    IF parent_tx IS NOT NULL THEN
        SELECT tx_level + 1 INTO tx_level 
        FROM transaction_tree 
        WHERE tx_id = parent_tx;
    END IF;
    
    -- è®°å½•äº‹åŠ¡
    INSERT INTO transaction_tree (tx_id, parent_tx_id, tx_level) 
    VALUES (new_tx_id, parent_tx, tx_level);
    
    -- åˆ›å»ºå¯¹åº”çš„ä¿å­˜ç‚¹
    SET @sp_sql = CONCAT('SAVEPOINT ', tx_name);
    PREPARE stmt FROM @sp_sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- è®°å½•ä¿å­˜ç‚¹
    INSERT INTO savepoint_registry (sp_id, tx_id, sp_name, sp_level) 
    VALUES (CONCAT('SP_', new_tx_id), new_tx_id, tx_name, tx_level);
END //

-- æäº¤åµŒå¥—äº‹åŠ¡
CREATE PROCEDURE CommitNestedTransaction(IN tx_id VARCHAR(64))
BEGIN
    -- æ›´æ–°äº‹åŠ¡çŠ¶æ€
    UPDATE transaction_tree 
    SET tx_status = 'COMMITTED', completed_at = NOW()
    WHERE tx_id = tx_id;
    
    -- é‡Šæ”¾ä¿å­˜ç‚¹
    UPDATE savepoint_registry 
    SET is_active = FALSE 
    WHERE tx_id = tx_id;
END //

DELIMITER ;
```

### 3.3 äº‹åŠ¡å±‚æ¬¡æŸ¥è¯¢


**ğŸ” æŸ¥çœ‹äº‹åŠ¡æ ‘ç»“æ„**
```sql
-- é€’å½’æŸ¥è¯¢äº‹åŠ¡æ ‘
WITH RECURSIVE transaction_hierarchy AS (
    -- æ ¹èŠ‚ç‚¹
    SELECT tx_id, parent_tx_id, tx_level, tx_status, 
           CAST(tx_id AS CHAR(500)) as path
    FROM transaction_tree 
    WHERE parent_tx_id IS NULL
    
    UNION ALL
    
    -- é€’å½’éƒ¨åˆ†
    SELECT t.tx_id, t.parent_tx_id, t.tx_level, t.tx_status,
           CONCAT(th.path, ' -> ', t.tx_id) as path
    FROM transaction_tree t
    JOIN transaction_hierarchy th ON t.parent_tx_id = th.tx_id
)
SELECT tx_level, tx_id, tx_status, path
FROM transaction_hierarchy
ORDER BY tx_level, tx_id;
```

---

## 4. ğŸ”„ çº§è”å›æ»šæ§åˆ¶æœºåˆ¶


### 4.1 çº§è”å›æ»šç­–ç•¥


**ğŸ”¸ å›æ»šç­–ç•¥ç±»å‹**
```
å®Œå…¨çº§è”å›æ»šï¼š
â€¢ çˆ¶äº‹åŠ¡å›æ»š â†’ æ‰€æœ‰å­äº‹åŠ¡å›æ»š
â€¢ é€‚ç”¨äºä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚

éƒ¨åˆ†çº§è”å›æ»šï¼š
â€¢ åªå›æ»šæŒ‡å®šå±‚çº§çš„äº‹åŠ¡
â€¢ é€‚ç”¨äºçµæ´»æ€§è¦æ±‚

ç‹¬ç«‹å›æ»šï¼š
â€¢ å­äº‹åŠ¡å›æ»šä¸å½±å“çˆ¶äº‹åŠ¡
â€¢ é€‚ç”¨äºå®¹é”™æ€§è¦æ±‚
```

### 4.2 çº§è”å›æ»šå®ç°


**ğŸ”§ çº§è”å›æ»šå­˜å‚¨è¿‡ç¨‹**
```sql
DELIMITER //

CREATE PROCEDURE CascadeRollback(
    IN target_tx_id VARCHAR(64),
    IN cascade_type ENUM('FULL', 'PARTIAL', 'SELF_ONLY') DEFAULT 'FULL'
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE child_tx VARCHAR(64);
    DECLARE sp_name VARCHAR(64);
    
    -- æ¸¸æ ‡ï¼šè·å–æ‰€æœ‰å­äº‹åŠ¡
    DECLARE child_cursor CURSOR FOR
        SELECT tx_id FROM transaction_tree 
        WHERE parent_tx_id = target_tx_id AND tx_status = 'ACTIVE';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- æ ¹æ®ç­–ç•¥æ‰§è¡Œå›æ»š
    CASE cascade_type
        WHEN 'FULL' THEN
            -- é€’å½’å›æ»šæ‰€æœ‰å­äº‹åŠ¡
            OPEN child_cursor;
            rollback_loop: LOOP
                FETCH child_cursor INTO child_tx;
                IF done THEN LEAVE rollback_loop; END IF;
                
                CALL CascadeRollback(child_tx, 'FULL');
            END LOOP;
            CLOSE child_cursor;
            
        WHEN 'PARTIAL' THEN
            -- åªå›æ»šç›´æ¥å­äº‹åŠ¡
            UPDATE transaction_tree 
            SET tx_status = 'ABORTED', completed_at = NOW()
            WHERE parent_tx_id = target_tx_id;
            
        WHEN 'SELF_ONLY' THEN
            -- åªå›æ»šè‡ªå·±
            NULL;
    END CASE;
    
    -- æ‰§è¡Œå®é™…çš„ä¿å­˜ç‚¹å›æ»š
    SELECT sp_name INTO sp_name 
    FROM savepoint_registry 
    WHERE tx_id = target_tx_id AND is_active = TRUE;
    
    IF sp_name IS NOT NULL THEN
        SET @rollback_sql = CONCAT('ROLLBACK TO ', sp_name);
        PREPARE stmt FROM @rollback_sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END IF;
    
    -- æ›´æ–°äº‹åŠ¡çŠ¶æ€
    UPDATE transaction_tree 
    SET tx_status = 'ABORTED', completed_at = NOW()
    WHERE tx_id = target_tx_id;
END //

DELIMITER ;
```

### 4.3 é€‰æ‹©æ€§å›æ»š


**ğŸ”§ å›æ»šåˆ°æŒ‡å®šå±‚çº§**
```sql
-- å›æ»šåˆ°æŒ‡å®šå±‚çº§çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE RollbackToLevel(IN target_level INT)
BEGIN
    DECLARE sp_name VARCHAR(64);
    
    -- æ‰¾åˆ°ç›®æ ‡å±‚çº§çš„ä¿å­˜ç‚¹
    SELECT sr.sp_name INTO sp_name
    FROM savepoint_registry sr
    JOIN transaction_tree tt ON sr.tx_id = tt.tx_id
    WHERE tt.tx_level = target_level 
      AND sr.is_active = TRUE
    ORDER BY sr.created_at DESC
    LIMIT 1;
    
    IF sp_name IS NOT NULL THEN
        -- æ‰§è¡Œå›æ»š
        SET @sql = CONCAT('ROLLBACK TO ', sp_name);
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        -- æ ‡è®°é«˜å±‚çº§çš„ä¿å­˜ç‚¹ä¸ºæ— æ•ˆ
        UPDATE savepoint_registry sr
        JOIN transaction_tree tt ON sr.tx_id = tt.tx_id
        SET sr.is_active = FALSE
        WHERE tt.tx_level > target_level;
    END IF;
END //
DELIMITER ;
```

---

## 5. ğŸ“¦ å­˜å‚¨è¿‡ç¨‹ä¸­çš„äº‹åŠ¡å¤„ç†


### 5.1 å­˜å‚¨è¿‡ç¨‹äº‹åŠ¡æ¨¡å¼


**ğŸ”¸ äº‹åŠ¡å¤„ç†æ¨¡å¼é€‰æ‹©**
```
è‡ªåŠ¨æäº¤æ¨¡å¼ï¼š
â€¢ æ¯ä¸ªSQLè‡ªåŠ¨æäº¤
â€¢ é€‚åˆç®€å•æ“ä½œ

æ‰‹åŠ¨äº‹åŠ¡æ¨¡å¼ï¼š
â€¢ æ˜¾å¼æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ
â€¢ é€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘

åµŒå¥—äº‹åŠ¡æ¨¡å¼ï¼š
â€¢ ä½¿ç”¨ä¿å­˜ç‚¹ç®¡ç†
â€¢ é€‚åˆå±‚æ¬¡åŒ–æ“ä½œ
```

**ğŸ”§ å­˜å‚¨è¿‡ç¨‹äº‹åŠ¡æ¨¡æ¿**
```sql
DELIMITER //
CREATE PROCEDURE BusinessProcess()
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- ä¸»ä¸šåŠ¡é€»è¾‘
    INSERT INTO orders (customer_id, amount) VALUES (1, 100);
    SAVEPOINT after_order;
    
    -- å­ä¸šåŠ¡é€»è¾‘1
    CALL ProcessOrderItems(LAST_INSERT_ID());
    SAVEPOINT after_items;
    
    -- å­ä¸šåŠ¡é€»è¾‘2  
    CALL UpdateInventory(LAST_INSERT_ID());
    
    COMMIT;
END //
DELIMITER ;
```

### 5.2 å¼‚å¸¸å¤„ç†é›†æˆ


**ğŸ”§ å¸¦å¼‚å¸¸å¤„ç†çš„åµŒå¥—äº‹åŠ¡**
```sql
DELIMITER //
CREATE PROCEDURE SafeNestedOperation()
BEGIN
    DECLARE err_count INT DEFAULT 0;
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION 
        SET err_count = err_count + 1;
    
    START TRANSACTION;
    
    -- ç¬¬ä¸€å±‚æ“ä½œ
    INSERT INTO table1 VALUES (1, 'data1');
    SAVEPOINT sp1;
    
    -- ç¬¬äºŒå±‚æ“ä½œï¼ˆå¯èƒ½å¤±è´¥ï¼‰
    INSERT INTO table2 VALUES (1, 'data2');
    
    IF err_count > 0 THEN
        ROLLBACK TO sp1;
        INSERT INTO error_log VALUES ('table2 operation failed');
    END IF;
    
    SAVEPOINT sp2;
    
    -- ç¬¬ä¸‰å±‚æ“ä½œ
    INSERT INTO table3 VALUES (1, 'data3');
    
    IF err_count > 0 THEN
        ROLLBACK TO sp2;
    END IF;
    
    COMMIT;
END //
DELIMITER ;
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†ä¸é”™è¯¯æ¢å¤


### 6.1 å¼‚å¸¸å¤„ç†æœºåˆ¶


**ğŸ”¸ MySQLå¼‚å¸¸å¤„ç†å±‚æ¬¡**
```
å¼‚å¸¸ç±»å‹ï¼š
â€¢ SQLå¼‚å¸¸ï¼šè¯­æ³•é”™è¯¯ã€çº¦æŸè¿å
â€¢ ä¸šåŠ¡å¼‚å¸¸ï¼šé€»è¾‘é”™è¯¯ã€æ•°æ®å†²çª
â€¢ ç³»ç»Ÿå¼‚å¸¸ï¼šè¿æ¥æ–­å¼€ã€ç£ç›˜æ»¡

å¤„ç†ç­–ç•¥ï¼š
â€¢ ç«‹å³å›æ»šï¼šæ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆ
â€¢ éƒ¨åˆ†é‡è¯•ï¼šä¸šåŠ¡è¿ç»­æ€§ä¼˜å…ˆ  
â€¢ è®°å½•æ—¥å¿—ï¼šé—®é¢˜è¿½è¸ªä¼˜å…ˆ
```

**ğŸ”§ ç»¼åˆå¼‚å¸¸å¤„ç†**
```sql
DELIMITER //
CREATE PROCEDURE RobustNestedTransaction()
BEGIN
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_error_msg TEXT;
    DECLARE v_savepoint_name VARCHAR(64);
    
    -- å¼‚å¸¸å¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            v_error_msg = MESSAGE_TEXT;
        SET v_error_count = v_error_count + 1;
        
        INSERT INTO error_log (error_msg, occurred_at) 
        VALUES (v_error_msg, NOW());
    END;
    
    START TRANSACTION;
    
    -- åˆ›å»ºä¸»ä¿å­˜ç‚¹
    SAVEPOINT main_operation;
    
    -- ä¸šåŠ¡æ“ä½œ1
    INSERT INTO business_table1 VALUES (1, 'data');
    
    IF v_error_count = 0 THEN
        SAVEPOINT operation_1_success;
    ELSE
        ROLLBACK TO main_operation;
        SELECT 'Operation 1 failed, rolled back' as status;
        COMMIT;
        LEAVE;
    END IF;
    
    -- ä¸šåŠ¡æ“ä½œ2
    INSERT INTO business_table2 VALUES (1, 'data');
    
    IF v_error_count > 0 THEN
        ROLLBACK TO operation_1_success;
        SELECT 'Operation 2 failed, partial rollback' as status;
    END IF;
    
    COMMIT;
    SELECT 'All operations completed successfully' as status;
END //
DELIMITER ;
```

### 6.2 é”™è¯¯æ¢å¤ç­–ç•¥


**ğŸ”§ è‡ªåŠ¨é‡è¯•æœºåˆ¶**
```sql
DELIMITER //
CREATE PROCEDURE RetryableNestedTransaction(IN max_retries INT DEFAULT 3)
BEGIN
    DECLARE retry_count INT DEFAULT 0;
    DECLARE operation_success BOOLEAN DEFAULT FALSE;
    
    retry_loop: WHILE retry_count < max_retries AND NOT operation_success DO
        BEGIN
            DECLARE EXIT HANDLER FOR SQLEXCEPTION
            BEGIN
                SET retry_count = retry_count + 1;
                ROLLBACK;
                
                IF retry_count < max_retries THEN
                    SELECT CONCAT('Retry ', retry_count, ' of ', max_retries) as retry_status;
                    -- å¯é€‰ï¼šæ·»åŠ å»¶è¿Ÿ
                    DO SLEEP(retry_count * 0.1);
                ELSE
                    SELECT 'Max retries reached, operation failed' as final_status;
                END IF;
            END;
            
            START TRANSACTION;
            
            -- æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            INSERT INTO critical_table VALUES (UUID(), NOW());
            SAVEPOINT critical_point;
            
            -- æ›´å¤æ‚çš„æ“ä½œ
            UPDATE summary_table SET count = count + 1;
            
            COMMIT;
            SET operation_success = TRUE;
            SELECT 'Operation completed successfully' as success_status;
        END;
    END WHILE;
END //
DELIMITER ;
```

---

## 7. âš¡ æ€§èƒ½è€ƒé‡ä¸æœ€ä½³å®è·µ


### 7.1 åµŒå¥—äº‹åŠ¡æ€§èƒ½å½±å“


**ğŸ“Š æ€§èƒ½å½±å“å› ç´ **

| å› ç´  | **å½±å“ç¨‹åº¦** | **ä¼˜åŒ–å»ºè®®** |
|------|-------------|-------------|
| `ä¿å­˜ç‚¹æ•°é‡` | `ä¸­ç­‰` | `é™åˆ¶åµŒå¥—å±‚æ•°` |
| `äº‹åŠ¡é•¿åº¦` | `é«˜` | `å°½å¿«æäº¤` |
| `é”ç«äº‰` | `é«˜` | `å‡å°‘é”èŒƒå›´` |
| `æ—¥å¿—å†™å…¥` | `ä¸­ç­‰` | `æ‰¹é‡æ“ä½œ` |

### 7.2 æœ€ä½³å®è·µæŒ‡å—


**â­ åµŒå¥—äº‹åŠ¡ä½¿ç”¨åŸåˆ™**
```sql
-- âœ… æ¨èï¼šæµ…å±‚åµŒå¥—ï¼Œå¿«é€Ÿæäº¤
START TRANSACTION;
-- ä¸»è¦æ“ä½œ
SAVEPOINT sp1;
-- å¯é€‰æ“ä½œ
COMMIT;

-- âŒ é¿å…ï¼šè¿‡æ·±åµŒå¥—
START TRANSACTION;
SAVEPOINT sp1;
  SAVEPOINT sp2;
    SAVEPOINT sp3;
      SAVEPOINT sp4;  -- å¤ªæ·±äº†
```

**ğŸ”§ æ€§èƒ½ç›‘æ§æŸ¥è¯¢**
```sql
-- ç›‘æ§äº‹åŠ¡çŠ¶æ€
SELECT 
    trx_id,
    trx_state,
    trx_started,
    trx_isolation_level,
    trx_rows_locked,
    trx_rows_modified
FROM information_schema.INNODB_TRX
WHERE trx_started < DATE_SUB(NOW(), INTERVAL 30 SECOND);

-- æ£€æŸ¥é”ç­‰å¾…
SELECT 
    waiting_trx_id,
    waiting_query,
    blocking_trx_id,
    blocking_query
FROM information_schema.INNODB_LOCK_WAITS;
```

### 7.3 é…ç½®ä¼˜åŒ–å»ºè®®


**âš™ï¸ ç›¸å…³å‚æ•°è°ƒä¼˜**
```sql
-- æŸ¥çœ‹äº‹åŠ¡ç›¸å…³é…ç½®
SHOW VARIABLES LIKE '%timeout%';
SHOW VARIABLES LIKE '%isolation%';

-- æ¨èè®¾ç½®
SET SESSION innodb_lock_wait_timeout = 5;        -- é”ç­‰å¾…è¶…æ—¶
SET SESSION transaction_isolation = 'READ-COMMITTED';  -- éš”ç¦»çº§åˆ«
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ åµŒå¥—äº‹åŠ¡çš„æœ¬è´¨ç†è§£**
```
å…³é”®è®¤çŸ¥ï¼š
â€¢ MySQLä¸æ”¯æŒçœŸæ­£çš„åµŒå¥—äº‹åŠ¡
â€¢ SAVEPOINTæ˜¯æœ€ä½³æ›¿ä»£æ–¹æ¡ˆ
â€¢ äº‹åŠ¡ä»ç„¶æ˜¯å¹³é¢çš„ï¼Œåªæ˜¯æœ‰äº†å›æ»šç‚¹
â€¢ æ‰€æœ‰æ“ä½œéƒ½åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­
```

**ğŸ”¸ SAVEPOINTæœºåˆ¶çš„ä¼˜åŠ¿ä¸é™åˆ¶**
```
ä¼˜åŠ¿ï¼š
â€¢ æä¾›å±€éƒ¨å›æ»šèƒ½åŠ›
â€¢ æ€§èƒ½å¼€é”€ç›¸å¯¹è¾ƒå°
â€¢ å®ç°ç›¸å¯¹ç®€å•

é™åˆ¶ï¼š
â€¢ ä¸æ˜¯çœŸæ­£çš„äº‹åŠ¡ç‹¬ç«‹æ€§
â€¢ æ— æ³•å¹¶è¡Œæ‰§è¡Œå­äº‹åŠ¡
â€¢ æ‰€æœ‰é”ä»ç„¶ç”±ä¸»äº‹åŠ¡æŒæœ‰
```

### 8.2 å®é™…åº”ç”¨è¦ç‚¹


**ğŸ”¹ ä½•æ—¶ä½¿ç”¨åµŒå¥—äº‹åŠ¡æ¨¡å¼**
```
é€‚ç”¨åœºæ™¯ï¼š
â€¢ å¤æ‚çš„ä¸šåŠ¡æµç¨‹æ§åˆ¶
â€¢ éœ€è¦éƒ¨åˆ†å›æ»šçš„æ“ä½œ
â€¢ é”™è¯¯æ¢å¤å’Œé‡è¯•é€»è¾‘
â€¢ å­˜å‚¨è¿‡ç¨‹ä¸­çš„å¼‚å¸¸å¤„ç†

ä¸é€‚ç”¨åœºæ™¯ï¼š
â€¢ ç®€å•çš„CRUDæ“ä½œ
â€¢ é«˜å¹¶å‘åœºæ™¯
â€¢ å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
```

**ğŸ”¹ å®ç°å¤æ‚æ€§ç®¡ç†**
```
å¤æ‚æ€§æ¥æºï¼š
â€¢ ä¿å­˜ç‚¹çš„å‘½åå’Œç®¡ç†
â€¢ å¼‚å¸¸å¤„ç†çš„å±‚æ¬¡åŒ–
â€¢ å›æ»šç­–ç•¥çš„é€‰æ‹©
â€¢ äº‹åŠ¡çŠ¶æ€çš„è·Ÿè¸ª

ç®€åŒ–ç­–ç•¥ï¼š
â€¢ é™åˆ¶åµŒå¥—å±‚æ•°ï¼ˆå»ºè®®â‰¤3å±‚ï¼‰
â€¢ ä½¿ç”¨æ ‡å‡†åŒ–çš„å‘½åçº¦å®š
â€¢ å»ºç«‹å®Œå–„çš„æ—¥å¿—è®°å½•
â€¢ æä¾›è¾…åŠ©ç®¡ç†å·¥å…·
```

### 8.3 ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é™·é˜±ä¸é¿å…æ–¹æ³•**
```
é™·é˜±1ï¼šè¿‡åº¦åµŒå¥—
â€¢ å½±å“ï¼šæ€§èƒ½ä¸‹é™ï¼Œéš¾ä»¥ç»´æŠ¤
â€¢ é¿å…ï¼šé™åˆ¶å±‚æ•°ï¼Œç®€åŒ–é€»è¾‘

é™·é˜±2ï¼šå¿˜è®°å¼‚å¸¸å¤„ç†
â€¢ å½±å“ï¼šæ•°æ®ä¸ä¸€è‡´ï¼Œéš¾ä»¥è°ƒè¯•
â€¢ é¿å…ï¼šæ¯å±‚éƒ½è¦æœ‰å¼‚å¸¸å¤„ç†

é™·é˜±3ï¼šé•¿äº‹åŠ¡
â€¢ å½±å“ï¼šé”ç«äº‰ï¼Œæ€§èƒ½é—®é¢˜
â€¢ é¿å…ï¼šå°½å¿«æäº¤ï¼Œå‡å°‘é”æ—¶é—´

é™·é˜±4ï¼šä¿å­˜ç‚¹æ³„éœ²
â€¢ å½±å“ï¼šå†…å­˜æ³„éœ²ï¼Œæ€§èƒ½ä¸‹é™
â€¢ é¿å…ï¼šåŠæ—¶æ¸…ç†æ— ç”¨ä¿å­˜ç‚¹
```

**ğŸ› ï¸ æœ€ä½³å®è·µæ€»ç»“**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ ç®€å•ä¼˜äºå¤æ‚
â€¢ å¿«é€Ÿæäº¤
â€¢ å¼‚å¸¸ä¼˜é›…å¤„ç†
â€¢ å……åˆ†çš„æ—¥å¿—è®°å½•

ç›‘æ§è¦ç‚¹ï¼š
â€¢ äº‹åŠ¡æ‰§è¡Œæ—¶é—´
â€¢ é”ç­‰å¾…æƒ…å†µ
â€¢ å›æ»šé¢‘ç‡
â€¢ é”™è¯¯æ—¥å¿—

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ å‡å°‘åµŒå¥—å±‚æ•°
â€¢ ä¼˜åŒ–SQLè¯­å¥
â€¢ åˆç†ä½¿ç”¨ç´¢å¼•
â€¢ é¿å…é•¿äº‹åŠ¡
```

**ğŸ’¡ å­¦ä¹ å»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬SAVEPOINTç”¨æ³•
- **ç†è§£é™åˆ¶**ï¼šæ˜ç¡®MySQLçš„åµŒå¥—äº‹åŠ¡é™åˆ¶
- **å®è·µéªŒè¯**ï¼šé€šè¿‡æµ‹è¯•ç†è§£è¡Œä¸ºç‰¹å¾
- **ç›‘æ§ä¼˜åŒ–**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŒç»­ç›‘æ§å’Œä¼˜åŒ–
- **å¼‚å¸¸å¤„ç†**ï¼šé‡è§†å¼‚å¸¸å¤„ç†æœºåˆ¶çš„è®¾è®¡

**æ ¸å¿ƒè®°å¿†**ï¼š
- MySQLç”¨SAVEPOINTæ¨¡æ‹ŸåµŒå¥—äº‹åŠ¡ï¼Œæœ¬è´¨è¿˜æ˜¯å•äº‹åŠ¡
- åµŒå¥—äº‹åŠ¡ä¸»è¦ç”¨äºå¤æ‚ä¸šåŠ¡æµç¨‹çš„é”™è¯¯å¤„ç†å’Œå›æ»šæ§åˆ¶
- æ€§èƒ½å’Œå¤æ‚æ€§éœ€è¦å¹³è¡¡ï¼Œä¸è¦è¿‡åº¦è®¾è®¡
- å¼‚å¸¸å¤„ç†å’Œç›‘æ§åŒç­‰é‡è¦ï¼Œç¼ºä¸€ä¸å¯