---
title: 9ã€é”ç­‰å¾…é˜Ÿåˆ—æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ç­‰å¾…é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ](#1-ç­‰å¾…é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ)
2. [é˜Ÿåˆ—æ•°æ®ç»“æ„è®¾è®¡](#2-é˜Ÿåˆ—æ•°æ®ç»“æ„è®¾è®¡)
3. [FIFOç­‰å¾…ç­–ç•¥](#3-FIFOç­‰å¾…ç­–ç•¥)
4. [ä¼˜å…ˆçº§ç­‰å¾…é˜Ÿåˆ—](#4-ä¼˜å…ˆçº§ç­‰å¾…é˜Ÿåˆ—)
5. [é˜Ÿåˆ—ç®¡ç†ç®—æ³•](#5-é˜Ÿåˆ—ç®¡ç†ç®—æ³•)
6. [çº¿ç¨‹å”¤é†’æœºåˆ¶](#6-çº¿ç¨‹å”¤é†’æœºåˆ¶)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [ç­‰å¾…è¶…æ—¶å¤„ç†](#8-ç­‰å¾…è¶…æ—¶å¤„ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç­‰å¾…é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ


### 1.1 é”ç­‰å¾…é˜Ÿåˆ—çš„ä½œç”¨


å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯·æ±‚åŒä¸€ä¸ªé”èµ„æºæ—¶ï¼Œæ•°æ®åº“éœ€è¦ä¸€ç§æœºåˆ¶æ¥ç®¡ç†è¿™äº›ç­‰å¾…çš„çº¿ç¨‹ã€‚é”ç­‰å¾…é˜Ÿåˆ—å°±æ˜¯ä¸“é—¨ç”¨æ¥æ’é˜Ÿç®¡ç†ç­‰å¾…è·å–é”çš„çº¿ç¨‹çš„æ•°æ®ç»“æ„ã€‚

**ğŸ”¸ ç­‰å¾…é˜Ÿåˆ—è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
å¹¶å‘å†²çªç®¡ç†ï¼š
â”Œâ”€ é—®é¢˜åœºæ™¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ å¤šä¸ªäº‹åŠ¡åŒæ—¶è¯·æ±‚ç›¸åŒèµ„æºé”      â”‚
â”‚ â€¢ éœ€è¦å…¬å¹³åˆ†é…é”è·å–æœºä¼š         â”‚
â”‚ â€¢ é¿å…é¥¥é¥¿ç°è±¡å’Œä¼˜å…ˆçº§åè½¬       â”‚
â”‚ â€¢ ç¡®ä¿é”é‡Šæ”¾åæœ‰åºå”¤é†’ç­‰å¾…è€…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ é˜Ÿåˆ—ä½œç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç»´æŠ¤ç­‰å¾…çº¿ç¨‹çš„æœ‰åºåˆ—è¡¨         â”‚
â”‚ â€¢ æä¾›å…¬å¹³çš„é”åˆ†é…ç­–ç•¥           â”‚
â”‚ â€¢ æ”¯æŒä¼˜å…ˆçº§å’Œè¶…æ—¶æœºåˆ¶           â”‚
â”‚ â€¢ ä¼˜åŒ–ç³»ç»Ÿèµ„æºä½¿ç”¨æ•ˆç‡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**ï¼šç­‰å¾…é˜Ÿåˆ—æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ç®¡ç†å™¨ï¼Œè´Ÿè´£åè°ƒå¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®é¡ºåºã€‚

### 1.2 ç­‰å¾…é˜Ÿåˆ—çš„åŸºæœ¬å·¥ä½œæµç¨‹


**ğŸ”„ é˜Ÿåˆ—å·¥ä½œæœºåˆ¶**
```
é”è¯·æ±‚å¤„ç†æµç¨‹ï¼š

çº¿ç¨‹Aè¯·æ±‚é” â”€â”€â”€â”€â”
                â”‚
çº¿ç¨‹Bè¯·æ±‚é” â”€â”€â”€â”€â”¼â”€â†’ æ£€æŸ¥é”çŠ¶æ€
                â”‚
çº¿ç¨‹Cè¯·æ±‚é” â”€â”€â”€â”€â”˜
                
å¦‚æœé”å¯ç”¨ï¼šç›´æ¥è·å–
å¦‚æœé”è¢«å ç”¨ï¼š
    â†“
å°†çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
    â†“
çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€
    â†“
é”é‡Šæ”¾æ—¶å”¤é†’é˜Ÿé¦–çº¿ç¨‹
    â†“
è¢«å”¤é†’çº¿ç¨‹è·å–é”
```

---

## 2. ğŸ—ï¸ é˜Ÿåˆ—æ•°æ®ç»“æ„è®¾è®¡


### 2.1 ç­‰å¾…é˜Ÿåˆ—çš„å†…éƒ¨ç»“æ„


æ•°æ®åº“ç³»ç»Ÿä¸­çš„é”ç­‰å¾…é˜Ÿåˆ—é€šå¸¸é‡‡ç”¨é“¾è¡¨æˆ–æ•°ç»„çš„å½¢å¼å®ç°ï¼Œæ¯ä¸ªç­‰å¾…èŠ‚ç‚¹åŒ…å«çº¿ç¨‹ä¿¡æ¯ã€ç­‰å¾…æ—¶é—´ã€ä¼˜å…ˆçº§ç­‰å…³é”®æ•°æ®ã€‚

**ğŸ”¸ é˜Ÿåˆ—èŠ‚ç‚¹ç»“æ„**
```sql
-- ç­‰å¾…èŠ‚ç‚¹çš„é€»è¾‘ç»“æ„
CREATE TABLE lock_wait_node (
    thread_id BIGINT,           -- ç­‰å¾…çº¿ç¨‹ID
    lock_resource VARCHAR(255), -- è¯·æ±‚çš„é”èµ„æº
    lock_mode ENUM('S', 'X'),   -- é”æ¨¡å¼ï¼šå…±äº«æˆ–æ’ä»–
    wait_start_time TIMESTAMP,  -- å¼€å§‹ç­‰å¾…æ—¶é—´
    priority INT DEFAULT 0,     -- ä¼˜å…ˆçº§
    timeout_ms INT,             -- è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    next_node_id BIGINT         -- æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
);
```

**ğŸ”¸ é˜Ÿåˆ—ç®¡ç†ç»“æ„**
```
ç­‰å¾…é˜Ÿåˆ—æ•´ä½“ç»“æ„ï¼š

â”Œâ”€ é˜Ÿåˆ—å¤´éƒ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ queue_id: é˜Ÿåˆ—å”¯ä¸€æ ‡è¯†          â”‚
â”‚ resource_id: é”å®šçš„èµ„æºæ ‡è¯†     â”‚
â”‚ head_node: æŒ‡å‘é˜Ÿé¦–èŠ‚ç‚¹         â”‚
â”‚ tail_node: æŒ‡å‘é˜Ÿå°¾èŠ‚ç‚¹         â”‚
â”‚ queue_length: å½“å‰é˜Ÿåˆ—é•¿åº¦      â”‚
â”‚ creation_time: é˜Ÿåˆ—åˆ›å»ºæ—¶é—´     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€ ç­‰å¾…èŠ‚ç‚¹1 â”€â”¬â”€ ç­‰å¾…èŠ‚ç‚¹2 â”€â”¬â”€ ç­‰å¾…èŠ‚ç‚¹3 â”
â”‚ thread_100  â”‚ thread_101  â”‚ thread_102 â”‚
â”‚ priority: 5 â”‚ priority: 3 â”‚ priority: 1 â”‚
â”‚ wait: 10ms  â”‚ wait: 5ms   â”‚ wait: 2ms  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é˜Ÿåˆ—æ“ä½œæ¥å£


**ğŸ”§ åŸºæœ¬é˜Ÿåˆ—æ“ä½œ**
```sql
-- æ·»åŠ ç­‰å¾…çº¿ç¨‹åˆ°é˜Ÿåˆ—
CALL add_to_wait_queue(
    @thread_id = 12345,
    @resource = 'table_users_row_100',
    @lock_mode = 'X',
    @priority = 5,
    @timeout = 30000
);

-- ä»é˜Ÿåˆ—ä¸­ç§»é™¤çº¿ç¨‹
CALL remove_from_wait_queue(
    @thread_id = 12345,
    @resource = 'table_users_row_100'
);

-- æŸ¥è¯¢é˜Ÿåˆ—çŠ¶æ€
SELECT 
    queue_length,
    head_thread_id,
    avg_wait_time
FROM lock_wait_queue_status 
WHERE resource_id = 'table_users_row_100';
```

---

## 3. âš¡ FIFOç­‰å¾…ç­–ç•¥


### 3.1 å…ˆè¿›å…ˆå‡ºçš„åŸºæœ¬åŸç†


FIFOï¼ˆFirst In, First Outï¼‰æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯æœ€å…¬å¹³çš„ç­‰å¾…ç­–ç•¥ï¼ŒæŒ‰ç…§çº¿ç¨‹è¯·æ±‚é”çš„æ—¶é—´é¡ºåºæ¥åˆ†é…é”èµ„æºã€‚

**ğŸ”¸ FIFOç­–ç•¥ç‰¹ç‚¹**
```
FIFOç­‰å¾…ç­–ç•¥ä¼˜åŠ¿ï¼š
âœ… å®ç°ç®€å•ï¼šæŒ‰æ—¶é—´é¡ºåºæ’é˜Ÿ
âœ… å…¬å¹³æ€§å¥½ï¼šä¸ä¼šå‡ºç°é¥¥é¥¿ç°è±¡
âœ… å¯é¢„æµ‹æ€§ï¼šç­‰å¾…æ—¶é—´ç›¸å¯¹ç¡®å®š
âœ… æ— ä¼˜å…ˆçº§å†²çªï¼šé¿å…å¤æ‚çš„è°ƒåº¦é€»è¾‘

FIFOç­–ç•¥å±€é™ï¼š
âŒ ç¼ºä¹çµæ´»æ€§ï¼šæ— æ³•å¤„ç†ç´§æ€¥è¯·æ±‚
âŒ å¯èƒ½é™ä½æ•ˆç‡ï¼šé«˜ä¼˜å…ˆçº§äº‹åŠ¡ä¹Ÿéœ€æ’é˜Ÿ
âŒ ä¸é€‚åˆå®æ—¶ç³»ç»Ÿï¼šæ— æ³•ä¿è¯å“åº”æ—¶é—´
```

### 3.2 FIFOé˜Ÿåˆ—å®ç°


**ğŸ”„ FIFOé˜Ÿåˆ—æ“ä½œæµç¨‹**
```sql
-- FIFOå…¥é˜Ÿæ“ä½œ
DELIMITER $$
CREATE PROCEDURE fifo_enqueue(
    IN p_thread_id BIGINT,
    IN p_resource VARCHAR(255),
    IN p_lock_mode CHAR(1)
)
BEGIN
    DECLARE v_current_time TIMESTAMP DEFAULT NOW();
    
    -- æ’å…¥åˆ°é˜Ÿå°¾
    INSERT INTO lock_wait_queue (
        thread_id, 
        resource_id, 
        lock_mode,
        enqueue_time,
        position
    ) VALUES (
        p_thread_id,
        p_resource,
        p_lock_mode,
        v_current_time,
        (SELECT COALESCE(MAX(position), 0) + 1 
         FROM lock_wait_queue 
         WHERE resource_id = p_resource)
    );
END$$

-- FIFOå‡ºé˜Ÿæ“ä½œ
CREATE PROCEDURE fifo_dequeue(
    IN p_resource VARCHAR(255),
    OUT p_next_thread_id BIGINT
)
BEGIN
    -- è·å–é˜Ÿé¦–çº¿ç¨‹
    SELECT thread_id INTO p_next_thread_id
    FROM lock_wait_queue
    WHERE resource_id = p_resource
    ORDER BY position ASC
    LIMIT 1;
    
    -- ç§»é™¤é˜Ÿé¦–å…ƒç´ 
    DELETE FROM lock_wait_queue
    WHERE resource_id = p_resource
    AND thread_id = p_next_thread_id;
END$$
DELIMITER ;
```

### 3.3 FIFOé˜Ÿåˆ—æ€§èƒ½åˆ†æ


**ğŸ“Š æ€§èƒ½ç‰¹å¾åˆ†æ**
```
FIFOé˜Ÿåˆ—æ€§èƒ½æŒ‡æ ‡ï¼š

æ—¶é—´å¤æ‚åº¦ï¼š
â€¢ å…¥é˜Ÿæ“ä½œï¼šO(1) - ç›´æ¥æ·»åŠ åˆ°é˜Ÿå°¾
â€¢ å‡ºé˜Ÿæ“ä½œï¼šO(1) - ç›´æ¥ç§»é™¤é˜Ÿé¦–
â€¢ æŸ¥æ‰¾æ“ä½œï¼šO(n) - éœ€è¦éå†æŸ¥æ‰¾

ç©ºé—´å¤æ‚åº¦ï¼š
â€¢ å­˜å‚¨å¼€é”€ï¼šO(n) - nä¸ºç­‰å¾…çº¿ç¨‹æ•°
â€¢ é¢å¤–å¼€é”€ï¼šæœ€å°ï¼Œåªéœ€ç»´æŠ¤å¤´å°¾æŒ‡é’ˆ

å¹¶å‘æ€§èƒ½ï¼š
â€¢ é˜Ÿåˆ—æ“ä½œéœ€è¦åŠ é”ä¿æŠ¤
â€¢ é«˜å¹¶å‘æ—¶å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
â€¢ é€‚åˆç­‰å¾…é˜Ÿåˆ—è¾ƒçŸ­çš„åœºæ™¯
```

---

## 4. ğŸ¯ ä¼˜å…ˆçº§ç­‰å¾…é˜Ÿåˆ—


### 4.1 ä¼˜å…ˆçº§é˜Ÿåˆ—çš„è®¾è®¡æ€è·¯


åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸åŒçš„äº‹åŠ¡å…·æœ‰ä¸åŒçš„é‡è¦æ€§ï¼Œéœ€è¦æ ¹æ®ä¼˜å…ˆçº§æ¥è°ƒæ•´ç­‰å¾…é¡ºåºï¼Œè€Œä¸æ˜¯ç®€å•çš„å…ˆæ¥å…ˆæœåŠ¡ã€‚

**ğŸ”¸ ä¼˜å…ˆçº§åˆ†ç±»ä½“ç³»**
```
ä¼˜å…ˆçº§ç­‰çº§è®¾è®¡ï¼š

â”Œâ”€ ç´§æ€¥çº§åˆ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜å…ˆçº§ï¼š10 - ç³»ç»Ÿå…³é”®äº‹åŠ¡        â”‚
â”‚ åœºæ™¯ï¼šæ­»é”æ£€æµ‹ã€ç³»ç»Ÿæ¢å¤         â”‚
â”‚ ç‰¹ç‚¹ï¼šå¯æŠ¢å ä½ä¼˜å…ˆçº§é”           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ é«˜ä¼˜å…ˆçº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜å…ˆçº§ï¼š7-9 - é‡è¦ä¸šåŠ¡äº‹åŠ¡       â”‚
â”‚ åœºæ™¯ï¼šæ”¯ä»˜äº¤æ˜“ã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹     â”‚
â”‚ ç‰¹ç‚¹ï¼šä¼˜å…ˆè·å–é”ï¼Œè¾ƒçŸ­ç­‰å¾…æ—¶é—´   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ™®é€šä¼˜å…ˆçº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜å…ˆçº§ï¼š4-6 - å¸¸è§„ä¸šåŠ¡äº‹åŠ¡       â”‚
â”‚ åœºæ™¯ï¼šç”¨æˆ·æŸ¥è¯¢ã€æ•°æ®æ›´æ–°         â”‚
â”‚ ç‰¹ç‚¹ï¼šæŒ‰æ­£å¸¸é¡ºåºç­‰å¾…             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ä½ä¼˜å…ˆçº§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜å…ˆçº§ï¼š1-3 - åå°æ‰¹å¤„ç†ä»»åŠ¡     â”‚
â”‚ åœºæ™¯ï¼šæ•°æ®åˆ†æã€ç»Ÿè®¡æŠ¥è¡¨         â”‚
â”‚ ç‰¹ç‚¹ï¼šå¯è¢«é«˜ä¼˜å…ˆçº§äº‹åŠ¡æ’é˜Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°


**ğŸ—ï¸ ä¼˜å…ˆçº§é˜Ÿåˆ—ç»“æ„**
```sql
-- ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°
CREATE TABLE priority_wait_queue (
    queue_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    thread_id BIGINT NOT NULL,
    resource_id VARCHAR(255) NOT NULL,
    lock_mode CHAR(1) NOT NULL,
    priority INT NOT NULL DEFAULT 5,
    base_priority INT NOT NULL,  -- åŸºç¡€ä¼˜å…ˆçº§
    dynamic_boost INT DEFAULT 0, -- åŠ¨æ€æå‡å€¼
    enqueue_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    wait_duration BIGINT AS (
        TIMESTAMPDIFF(MICROSECOND, enqueue_time, NOW())
    ) STORED,
    INDEX idx_resource_priority (resource_id, priority DESC, enqueue_time)
);

-- ä¼˜å…ˆçº§è®¡ç®—å‡½æ•°
DELIMITER $$
CREATE FUNCTION calculate_effective_priority(
    base_priority INT,
    wait_duration BIGINT,
    aging_factor DECIMAL(3,2) DEFAULT 0.01
) RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE effective_priority INT;
    
    -- åŸºç¡€ä¼˜å…ˆçº§ + ç­‰å¾…æ—¶é—´è€åŒ–åŠ æˆ
    SET effective_priority = base_priority + 
        FLOOR(wait_duration / 1000000 * aging_factor);
        
    -- ç¡®ä¿ä¼˜å…ˆçº§åœ¨åˆç†èŒƒå›´å†…
    IF effective_priority > 10 THEN
        SET effective_priority = 10;
    END IF;
    
    RETURN effective_priority;
END$$
DELIMITER ;
```

### 4.3 ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•


**âš–ï¸ æ™ºèƒ½è°ƒåº¦ç­–ç•¥**
```sql
-- è·å–ä¸‹ä¸€ä¸ªåº”è¯¥è·å¾—é”çš„çº¿ç¨‹
DELIMITER $$
CREATE PROCEDURE get_next_priority_thread(
    IN p_resource_id VARCHAR(255),
    OUT p_thread_id BIGINT
)
BEGIN
    DECLARE v_current_time TIMESTAMP DEFAULT NOW();
    
    -- æ ¹æ®æœ‰æ•ˆä¼˜å…ˆçº§é€‰æ‹©ä¸‹ä¸€ä¸ªçº¿ç¨‹
    SELECT thread_id INTO p_thread_id
    FROM priority_wait_queue
    WHERE resource_id = p_resource_id
    ORDER BY 
        calculate_effective_priority(
            base_priority, 
            TIMESTAMPDIFF(MICROSECOND, enqueue_time, v_current_time)
        ) DESC,
        enqueue_time ASC  -- ç›¸åŒä¼˜å…ˆçº§æŒ‰FIFO
    LIMIT 1;
    
    -- ç§»é™¤é€‰ä¸­çš„çº¿ç¨‹
    DELETE FROM priority_wait_queue
    WHERE resource_id = p_resource_id 
    AND thread_id = p_thread_id;
END$$
DELIMITER ;
```

> âš ï¸ **æ³¨æ„**ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—éœ€è¦é˜²æ­¢ä½ä¼˜å…ˆçº§çº¿ç¨‹é•¿æœŸé¥¥é¥¿ï¼Œé€šå¸¸é‡‡ç”¨ä¼˜å…ˆçº§è€åŒ–æœºåˆ¶æ¥è§£å†³ã€‚

---

## 5. ğŸ”§ é˜Ÿåˆ—ç®¡ç†ç®—æ³•


### 5.1 é˜Ÿåˆ—ç»´æŠ¤ç­–ç•¥


ç­‰å¾…é˜Ÿåˆ—éœ€è¦é«˜æ•ˆçš„ç®¡ç†ç®—æ³•æ¥å¤„ç†çº¿ç¨‹çš„åŠ å…¥ã€ç§»é™¤ã€è¶…æ—¶æ¸…ç†ç­‰æ“ä½œï¼ŒåŒæ—¶ä¿è¯é˜Ÿåˆ—çš„ä¸€è‡´æ€§å’Œæ€§èƒ½ã€‚

**ğŸ”¸ é˜Ÿåˆ—ç®¡ç†æ ¸å¿ƒç®—æ³•**
```sql
-- é˜Ÿåˆ—å¥åº·çŠ¶æ€ç›‘æ§
CREATE TABLE queue_health_metrics (
    resource_id VARCHAR(255) PRIMARY KEY,
    queue_length INT DEFAULT 0,
    avg_wait_time DECIMAL(10,3),
    max_wait_time DECIMAL(10,3),
    timeout_count INT DEFAULT 0,
    last_update TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- é˜Ÿåˆ—ç»´æŠ¤å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE maintain_wait_queue(IN p_resource_id VARCHAR(255))
BEGIN
    DECLARE v_queue_length INT DEFAULT 0;
    DECLARE v_avg_wait DECIMAL(10,3);
    DECLARE v_max_wait DECIMAL(10,3);
    DECLARE v_timeout_threshold INT DEFAULT 30000; -- 30ç§’è¶…æ—¶
    
    -- æ¸…ç†è¶…æ—¶çš„ç­‰å¾…çº¿ç¨‹
    DELETE FROM lock_wait_queue
    WHERE resource_id = p_resource_id
    AND TIMESTAMPDIFF(MICROSECOND, enqueue_time, NOW()) > v_timeout_threshold * 1000;
    
    -- è®¡ç®—é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
    SELECT 
        COUNT(*),
        AVG(TIMESTAMPDIFF(MICROSECOND, enqueue_time, NOW()) / 1000),
        MAX(TIMESTAMPDIFF(MICROSECOND, enqueue_time, NOW()) / 1000)
    INTO v_queue_length, v_avg_wait, v_max_wait
    FROM lock_wait_queue
    WHERE resource_id = p_resource_id;
    
    -- æ›´æ–°é˜Ÿåˆ—å¥åº·æŒ‡æ ‡
    INSERT INTO queue_health_metrics 
    VALUES (p_resource_id, v_queue_length, v_avg_wait, v_max_wait, 0)
    ON DUPLICATE KEY UPDATE
        queue_length = v_queue_length,
        avg_wait_time = v_avg_wait,
        max_wait_time = v_max_wait;
END$$
DELIMITER ;
```

### 5.2 é˜Ÿåˆ—åŠ¨æ€è°ƒæ•´æœºåˆ¶


**ğŸ“ˆ è‡ªé€‚åº”é˜Ÿåˆ—ç®¡ç†**
```sql
-- åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å‚æ•°
DELIMITER $$
CREATE PROCEDURE adaptive_queue_tuning(IN p_resource_id VARCHAR(255))
BEGIN
    DECLARE v_queue_length INT;
    DECLARE v_avg_wait DECIMAL(10,3);
    DECLARE v_new_timeout INT;
    
    -- è·å–å½“å‰é˜Ÿåˆ—çŠ¶æ€
    SELECT queue_length, avg_wait_time 
    INTO v_queue_length, v_avg_wait
    FROM queue_health_metrics
    WHERE resource_id = p_resource_id;
    
    -- æ ¹æ®é˜Ÿåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´è¶…æ—¶æ—¶é—´
    CASE 
        WHEN v_queue_length > 50 THEN
            SET v_new_timeout = 10000; -- é˜Ÿåˆ—è¿‡é•¿ï¼Œç¼©çŸ­è¶…æ—¶
        WHEN v_queue_length > 20 THEN
            SET v_new_timeout = 20000; -- é˜Ÿåˆ—è¾ƒé•¿ï¼Œé€‚ä¸­è¶…æ—¶
        ELSE
            SET v_new_timeout = 30000; -- é˜Ÿåˆ—æ­£å¸¸ï¼Œæ ‡å‡†è¶…æ—¶
    END CASE;
    
    -- æ›´æ–°é˜Ÿåˆ—é…ç½®
    UPDATE queue_configuration 
    SET timeout_ms = v_new_timeout,
        last_adjusted = NOW()
    WHERE resource_id = p_resource_id;
END$$
DELIMITER ;
```

---

## 6. ğŸ”” çº¿ç¨‹å”¤é†’æœºåˆ¶


### 6.1 å”¤é†’ç­–ç•¥è®¾è®¡


å½“é”è¢«é‡Šæ”¾æ—¶ï¼Œç³»ç»Ÿéœ€è¦ä»ç­‰å¾…é˜Ÿåˆ—ä¸­é€‰æ‹©åˆé€‚çš„çº¿ç¨‹è¿›è¡Œå”¤é†’ã€‚å”¤é†’æœºåˆ¶çš„æ•ˆç‡ç›´æ¥å½±å“ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚

**ğŸ”¸ å”¤é†’æ—¶æœºå’Œç­–ç•¥**
```
çº¿ç¨‹å”¤é†’è§¦å‘æ¡ä»¶ï¼š

â”Œâ”€ é”é‡Šæ”¾å”¤é†’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æŒé”äº‹åŠ¡æäº¤æˆ–å›æ»š            â”‚
â”‚ â€¢ æ˜¾å¼é‡Šæ”¾é”                    â”‚
â”‚ â€¢ é”è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ é”å…¼å®¹æ€§å”¤é†’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ’ä»–é”é™çº§ä¸ºå…±äº«é”            â”‚
â”‚ â€¢ å…±äº«é”å¯ä»¥å”¤é†’å…¶ä»–å…±äº«é”è¯·æ±‚  â”‚
â”‚ â€¢ æ„å‘é”é‡Šæ”¾åå”¤é†’ç­‰å¾…è€…        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ä¼˜å…ˆçº§æŠ¢å å”¤é†’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ é«˜ä¼˜å…ˆçº§äº‹åŠ¡æŠ¢å ä½ä¼˜å…ˆçº§é”    â”‚
â”‚ â€¢ ç³»ç»Ÿç´§æ€¥äº‹åŠ¡å¼ºåˆ¶å”¤é†’          â”‚
â”‚ â€¢ æ­»é”è§£é™¤åçš„å—å®³è€…å”¤é†’        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å”¤é†’ç®—æ³•å®ç°


**âš¡ é«˜æ•ˆå”¤é†’æœºåˆ¶**
```sql
-- æ™ºèƒ½çº¿ç¨‹å”¤é†’ç®—æ³•
DELIMITER $$
CREATE PROCEDURE wake_up_waiting_threads(
    IN p_resource_id VARCHAR(255),
    IN p_released_lock_mode CHAR(1)
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_thread_id BIGINT;
    DECLARE v_lock_mode CHAR(1);
    DECLARE v_priority INT;
    
    -- å£°æ˜æ¸¸æ ‡éå†ç­‰å¾…é˜Ÿåˆ—
    DECLARE wake_cursor CURSOR FOR
        SELECT thread_id, lock_mode, priority
        FROM lock_wait_queue
        WHERE resource_id = p_resource_id
        ORDER BY priority DESC, enqueue_time ASC;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN wake_cursor;
    
    wake_loop: LOOP
        FETCH wake_cursor INTO v_thread_id, v_lock_mode, v_priority;
        
        IF done THEN
            LEAVE wake_loop;
        END IF;
        
        -- æ£€æŸ¥é”å…¼å®¹æ€§
        IF is_lock_compatible(p_released_lock_mode, v_lock_mode) THEN
            -- å”¤é†’å…¼å®¹çš„ç­‰å¾…çº¿ç¨‹
            CALL wake_thread(v_thread_id);
            
            -- ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤
            DELETE FROM lock_wait_queue
            WHERE thread_id = v_thread_id 
            AND resource_id = p_resource_id;
            
            -- å¦‚æœæ˜¯æ’ä»–é”ï¼Œåªèƒ½å”¤é†’ä¸€ä¸ªçº¿ç¨‹
            IF v_lock_mode = 'X' THEN
                LEAVE wake_loop;
            END IF;
        END IF;
        
    END LOOP;
    
    CLOSE wake_cursor;
END$$

-- é”å…¼å®¹æ€§æ£€æŸ¥å‡½æ•°
CREATE FUNCTION is_lock_compatible(
    current_mode CHAR(1),
    request_mode CHAR(1)
) RETURNS BOOLEAN
READS SQL DATA
DETERMINISTIC
BEGIN
    -- å…¼å®¹æ€§çŸ©é˜µ
    IF current_mode IS NULL THEN
        RETURN TRUE; -- æ— é”çŠ¶æ€ï¼Œå…¼å®¹æ‰€æœ‰è¯·æ±‚
    ELSEIF current_mode = 'S' AND request_mode = 'S' THEN
        RETURN TRUE; -- å…±äº«é”å…¼å®¹å…±äº«é”
    ELSE
        RETURN FALSE; -- å…¶ä»–æƒ…å†µä¸å…¼å®¹
    END IF;
END$$
DELIMITER ;
```

### 6.3 æ‰¹é‡å”¤é†’ä¼˜åŒ–


**ğŸš€ æ‰¹é‡å¤„ç†æå‡æ€§èƒ½**
```sql
-- æ‰¹é‡å”¤é†’ç­‰å¾…çš„å…±äº«é”è¯·æ±‚
DELIMITER $$
CREATE PROCEDURE batch_wake_shared_locks(IN p_resource_id VARCHAR(255))
BEGIN
    DECLARE v_wake_count INT DEFAULT 0;
    
    -- æ‰¹é‡è·å–æ‰€æœ‰ç­‰å¾…å…±äº«é”çš„çº¿ç¨‹
    CREATE TEMPORARY TABLE temp_wake_list AS
    SELECT thread_id, enqueue_time
    FROM lock_wait_queue
    WHERE resource_id = p_resource_id
    AND lock_mode = 'S'
    ORDER BY priority DESC, enqueue_time ASC;
    
    -- æ‰¹é‡å”¤é†’æ‰€æœ‰å…±äº«é”ç­‰å¾…è€…
    UPDATE thread_status ts
    JOIN temp_wake_list tw ON ts.thread_id = tw.thread_id
    SET ts.status = 'RUNNABLE',
        ts.wake_time = NOW();
    
    -- ä»ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰¹é‡ç§»é™¤
    DELETE lwq FROM lock_wait_queue lwq
    JOIN temp_wake_list tw ON lwq.thread_id = tw.thread_id
    WHERE lwq.resource_id = p_resource_id;
    
    -- è®°å½•å”¤é†’æ•°é‡
    SELECT ROW_COUNT() INTO v_wake_count;
    
    DROP TEMPORARY TABLE temp_wake_list;
    
    -- è®°å½•å”¤é†’ç»Ÿè®¡
    INSERT INTO wake_statistics (resource_id, wake_count, wake_time)
    VALUES (p_resource_id, v_wake_count, NOW());
END$$
DELIMITER ;
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 é˜Ÿåˆ—ç»“æ„ä¼˜åŒ–


ä¸ºäº†æå‡ç­‰å¾…é˜Ÿåˆ—çš„æ€§èƒ½ï¼Œéœ€è¦ä»æ•°æ®ç»“æ„ã€ç´¢å¼•è®¾è®¡ã€å†…å­˜ä½¿ç”¨ç­‰å¤šä¸ªè§’åº¦è¿›è¡Œä¼˜åŒ–ã€‚

**ğŸ”¸ ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**
```sql
-- é’ˆå¯¹ç­‰å¾…é˜Ÿåˆ—çš„ç´¢å¼•ä¼˜åŒ–
-- å¤åˆç´¢å¼•ï¼šèµ„æºID + ä¼˜å…ˆçº§ + å…¥é˜Ÿæ—¶é—´
CREATE INDEX idx_queue_resource_priority_time 
ON lock_wait_queue (resource_id, priority DESC, enqueue_time ASC);

-- è¦†ç›–ç´¢å¼•ï¼šé¿å…å›è¡¨æŸ¥è¯¢
CREATE INDEX idx_queue_cover 
ON lock_wait_queue (resource_id, thread_id, lock_mode, priority, enqueue_time);

-- å±€éƒ¨ç´¢å¼•ï¼šåªå¯¹æ´»è·ƒé˜Ÿåˆ—å»ºç´¢å¼•
CREATE INDEX idx_active_queue 
ON lock_wait_queue (resource_id, enqueue_time)
WHERE enqueue_time > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### 7.2 å†…å­˜ä¼˜åŒ–æŠ€æœ¯


**ğŸš€ ç¼“å­˜å’Œé¢„åŠ è½½ç­–ç•¥**
```sql
-- çƒ­ç‚¹é˜Ÿåˆ—å†…å­˜ç¼“å­˜
CREATE TABLE hot_queue_cache (
    resource_id VARCHAR(255) PRIMARY KEY,
    queue_data JSON,  -- åºåˆ—åŒ–çš„é˜Ÿåˆ—æ•°æ®
    last_access TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    access_count INT DEFAULT 1
);

-- ç¼“å­˜æ›´æ–°ç­–ç•¥
DELIMITER $$
CREATE PROCEDURE update_queue_cache(
    IN p_resource_id VARCHAR(255)
)
BEGIN
    DECLARE v_queue_json JSON;
    
    -- æ„å»ºé˜Ÿåˆ—å¿«ç…§
    SELECT JSON_ARRAYAGG(
        JSON_OBJECT(
            'thread_id', thread_id,
            'priority', priority,
            'wait_time', TIMESTAMPDIFF(SECOND, enqueue_time, NOW()),
            'lock_mode', lock_mode
        )
    ) INTO v_queue_json
    FROM lock_wait_queue
    WHERE resource_id = p_resource_id
    ORDER BY priority DESC, enqueue_time ASC;
    
    -- æ›´æ–°æˆ–æ’å…¥ç¼“å­˜
    INSERT INTO hot_queue_cache (resource_id, queue_data)
    VALUES (p_resource_id, v_queue_json)
    ON DUPLICATE KEY UPDATE
        queue_data = v_queue_json,
        access_count = access_count + 1;
END$$
DELIMITER ;
```

### 7.3 å¹¶å‘ä¼˜åŒ–æŠ€æœ¯


**ğŸ”„ å‡å°‘é”ç«äº‰çš„æŠ€æœ¯**
```sql
-- åˆ†æ®µé”å‡å°‘é˜Ÿåˆ—æ“ä½œç«äº‰
CREATE TABLE queue_segment_locks (
    segment_id INT PRIMARY KEY,
    lock_owner_thread BIGINT,
    lock_time TIMESTAMP,
    INDEX idx_owner (lock_owner_thread)
);

-- è®¡ç®—èµ„æºå¯¹åº”çš„é˜Ÿåˆ—æ®µ
DELIMITER $$
CREATE FUNCTION get_queue_segment(resource_id VARCHAR(255))
RETURNS INT
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN CRC32(resource_id) % 16;  -- 16ä¸ªæ®µ
END$$

-- æ— é”é˜Ÿåˆ—æ“ä½œï¼ˆä½¿ç”¨åŸå­æ“ä½œï¼‰
CREATE PROCEDURE atomic_queue_operation(
    IN p_operation VARCHAR(20),
    IN p_resource_id VARCHAR(255),
    IN p_thread_id BIGINT
)
BEGIN
    DECLARE v_segment INT;
    DECLARE v_retry_count INT DEFAULT 0;
    DECLARE v_max_retries INT DEFAULT 3;
    
    SET v_segment = get_queue_segment(p_resource_id);
    
    retry_loop: LOOP
        -- å°è¯•è·å–æ®µé”
        UPDATE queue_segment_locks 
        SET lock_owner_thread = p_thread_id,
            lock_time = NOW()
        WHERE segment_id = v_segment 
        AND (lock_owner_thread IS NULL 
             OR TIMESTAMPDIFF(SECOND, lock_time, NOW()) > 1);
        
        IF ROW_COUNT() > 0 THEN
            -- è·å–é”æˆåŠŸï¼Œæ‰§è¡Œé˜Ÿåˆ—æ“ä½œ
            CASE p_operation
                WHEN 'ENQUEUE' THEN
                    CALL enqueue_operation(p_resource_id, p_thread_id);
                WHEN 'DEQUEUE' THEN
                    CALL dequeue_operation(p_resource_id, p_thread_id);
            END CASE;
            
            -- é‡Šæ”¾æ®µé”
            UPDATE queue_segment_locks 
            SET lock_owner_thread = NULL 
            WHERE segment_id = v_segment;
            
            LEAVE retry_loop;
        END IF;
        
        SET v_retry_count = v_retry_count + 1;
        IF v_retry_count >= v_max_retries THEN
            LEAVE retry_loop;
        END IF;
        
        -- çŸ­æš‚ç­‰å¾…åé‡è¯•
        DO SLEEP(0.001 * v_retry_count);  -- æŒ‡æ•°é€€é¿
    END LOOP;
END$$
DELIMITER ;
```

---

## 8. â° ç­‰å¾…è¶…æ—¶å¤„ç†


### 8.1 è¶…æ—¶æœºåˆ¶è®¾è®¡


ç­‰å¾…è¶…æ—¶æ˜¯é˜²æ­¢çº¿ç¨‹æ— é™æœŸç­‰å¾…çš„é‡è¦æœºåˆ¶ï¼Œéœ€è¦è®¾è®¡åˆç†çš„è¶…æ—¶ç­–ç•¥å’Œæ¸…ç†æœºåˆ¶ã€‚

**ğŸ”¸ è¶…æ—¶ç­–ç•¥åˆ†ç±»**
```
è¶…æ—¶ç±»å‹è®¾è®¡ï¼š

â”Œâ”€ å›ºå®šè¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ‰€æœ‰ç­‰å¾…è¯·æ±‚ç»Ÿä¸€è¶…æ—¶æ—¶é—´       â”‚
â”‚ â€¢ ç®€å•æ˜“å®ç°ï¼Œé…ç½®æ–¹ä¾¿           â”‚
â”‚ â€¢ é€‚ç”¨ï¼šèµ„æºè®¿é—®æ¨¡å¼ç›¸å¯¹ç¨³å®š     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ åŠ¨æ€è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ ¹æ®é˜Ÿåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´           â”‚
â”‚ â€¢ æ ¹æ®å†å²ç­‰å¾…æ—¶é—´è‡ªé€‚åº”         â”‚
â”‚ â€¢ é€‚ç”¨ï¼šè´Ÿè½½å˜åŒ–è¾ƒå¤§çš„ç³»ç»Ÿ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ åˆ†çº§è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ä¸åŒä¼˜å…ˆçº§è®¾ç½®ä¸åŒè¶…æ—¶æ—¶é—´     â”‚
â”‚ â€¢ é‡è¦äº‹åŠ¡æ›´é•¿è¶…æ—¶æ—¶é—´           â”‚
â”‚ â€¢ é€‚ç”¨ï¼šä¸šåŠ¡ä¼˜å…ˆçº§æ˜ç¡®çš„åœºæ™¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 è¶…æ—¶æ£€æµ‹å®ç°


**â° è¶…æ—¶ç›‘æ§æœºåˆ¶**
```sql
-- è¶…æ—¶é…ç½®è¡¨
CREATE TABLE timeout_config (
    priority_level INT PRIMARY KEY,
    base_timeout_ms INT NOT NULL,
    max_timeout_ms INT NOT NULL,
    dynamic_factor DECIMAL(3,2) DEFAULT 1.0
);

-- æ’å…¥é»˜è®¤è¶…æ—¶é…ç½®
INSERT INTO timeout_config VALUES
(10, 60000, 300000, 2.0),  -- æœ€é«˜ä¼˜å…ˆçº§ï¼š1-5åˆ†é’Ÿ
(5,  30000, 120000, 1.5),  -- æ™®é€šä¼˜å…ˆçº§ï¼š30ç§’-2åˆ†é’Ÿ
(1,  10000, 30000,  1.0);  -- ä½ä¼˜å…ˆçº§ï¼š10-30ç§’

-- è¶…æ—¶æ£€æµ‹å’Œæ¸…ç†
DELIMITER $$
CREATE PROCEDURE cleanup_timeout_threads()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_thread_id BIGINT;
    DECLARE v_resource_id VARCHAR(255);
    DECLARE v_wait_time INT;
    
    DECLARE timeout_cursor CURSOR FOR
        SELECT 
            lwq.thread_id,
            lwq.resource_id,
            TIMESTAMPDIFF(MICROSECOND, lwq.enqueue_time, NOW()) / 1000 as wait_ms
        FROM lock_wait_queue lwq
        JOIN timeout_config tc ON (
            lwq.priority BETWEEN tc.priority_level - 2 AND tc.priority_level + 2
        )
        WHERE TIMESTAMPDIFF(MICROSECOND, lwq.enqueue_time, NOW()) / 1000 
              > tc.base_timeout_ms;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN timeout_cursor;
    
    cleanup_loop: LOOP
        FETCH timeout_cursor INTO v_thread_id, v_resource_id, v_wait_time;
        
        IF done THEN
            LEAVE cleanup_loop;
        END IF;
        
        -- è®°å½•è¶…æ—¶äº‹ä»¶
        INSERT INTO timeout_events (
            thread_id, 
            resource_id, 
            wait_time_ms, 
            timeout_time
        ) VALUES (
            v_thread_id, 
            v_resource_id, 
            v_wait_time, 
            NOW()
        );
        
        -- ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤è¶…æ—¶çº¿ç¨‹
        DELETE FROM lock_wait_queue
        WHERE thread_id = v_thread_id 
        AND resource_id = v_resource_id;
        
        -- é€šçŸ¥çº¿ç¨‹è¶…æ—¶
        UPDATE thread_status 
        SET status = 'TIMEOUT',
            message = CONCAT('Lock wait timeout after ', v_wait_time, 'ms')
        WHERE thread_id = v_thread_id;
        
    END LOOP;
    
    CLOSE timeout_cursor;
END$$
DELIMITER ;
```

### 8.3 è¶…æ—¶æ¢å¤æœºåˆ¶


**ğŸ”„ è¶…æ—¶åçš„æ¢å¤ç­–ç•¥**
```sql
-- è¶…æ—¶åçš„è‡ªåŠ¨é‡è¯•æœºåˆ¶
DELIMITER $$
CREATE PROCEDURE handle_timeout_retry(
    IN p_thread_id BIGINT,
    IN p_resource_id VARCHAR(255),
    IN p_max_retries INT DEFAULT 3
)
BEGIN
    DECLARE v_retry_count INT;
    DECLARE v_backoff_ms INT;
    
    -- è·å–å½“å‰é‡è¯•æ¬¡æ•°
    SELECT COALESCE(retry_count, 0) INTO v_retry_count
    FROM thread_retry_state
    WHERE thread_id = p_thread_id AND resource_id = p_resource_id;
    
    IF v_retry_count < p_max_retries THEN
        -- è®¡ç®—é€€é¿æ—¶é—´
        SET v_backoff_ms = POWER(2, v_retry_count) * 1000;  -- æŒ‡æ•°é€€é¿
        
        -- æ›´æ–°é‡è¯•çŠ¶æ€
        INSERT INTO thread_retry_state (
            thread_id, 
            resource_id, 
            retry_count, 
            next_retry_time
        ) VALUES (
            p_thread_id, 
            p_resource_id, 
            v_retry_count + 1,
            DATE_ADD(NOW(), INTERVAL v_backoff_ms MICROSECOND)
        ) ON DUPLICATE KEY UPDATE
            retry_count = v_retry_count + 1,
            next_retry_time = DATE_ADD(NOW(), INTERVAL v_backoff_ms MICROSECOND);
        
        -- å®‰æ’é‡æ–°å…¥é˜Ÿ
        INSERT INTO delayed_queue_operations (
            thread_id,
            resource_id,
            operation,
            scheduled_time
        ) VALUES (
            p_thread_id,
            p_resource_id,
            'RETRY_ENQUEUE',
            DATE_ADD(NOW(), INTERVAL v_backoff_ms MICROSECOND)
        );
    ELSE
        -- é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œæœ€ç»ˆå¤±è´¥
        UPDATE thread_status 
        SET status = 'FAILED',
            message = 'Max retries exceeded for lock acquisition'
        WHERE thread_id = p_thread_id;
    END IF;
END$$
DELIMITER ;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 ç­‰å¾…é˜Ÿåˆ—æœºåˆ¶æ ¸å¿ƒè¦ç‚¹


```
ğŸ¯ é˜Ÿåˆ—æœºåˆ¶æ ¸å¿ƒåŠŸèƒ½ï¼š

ğŸ”¸ å…¬å¹³æ€§ä¿è¯ï¼šFIFOç­–ç•¥ç¡®ä¿ç­‰å¾…çº¿ç¨‹æŒ‰é¡ºåºè·å¾—é”
ğŸ”¸ ä¼˜å…ˆçº§æ”¯æŒï¼šé‡è¦äº‹åŠ¡å¯ä»¥ä¼˜å…ˆè·å¾—èµ„æº
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡åˆç†çš„æ•°æ®ç»“æ„å’Œç®—æ³•æå‡æ•ˆç‡
ğŸ”¸ è¶…æ—¶ä¿æŠ¤ï¼šé˜²æ­¢çº¿ç¨‹æ— é™æœŸç­‰å¾…é€ æˆèµ„æºæµªè´¹
ğŸ”¸ åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½è‡ªé€‚åº”è°ƒæ•´å‚æ•°
```

### 9.2 è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ


**ğŸ’¡ å…³é”®è®¾è®¡åŸåˆ™**
```
é˜Ÿåˆ—è®¾è®¡è¦ç‚¹ï¼š

âœ… æ•°æ®ç»“æ„é€‰æ‹©
â”œâ”€ ç®€å•åœºæ™¯ï¼šä½¿ç”¨FIFOé“¾è¡¨
â”œâ”€ å¤æ‚åœºæ™¯ï¼šä½¿ç”¨ä¼˜å…ˆçº§å †
â””â”€ é«˜å¹¶å‘åœºæ™¯ï¼šä½¿ç”¨åˆ†æ®µé”

âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
â”œâ”€ åˆç†è®¾è®¡ç´¢å¼•å‡å°‘æŸ¥è¯¢å¼€é”€
â”œâ”€ ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
â”œâ”€ æ‰¹é‡æ“ä½œæå‡å¤„ç†æ•ˆç‡
â””â”€ åˆ†æ®µé”å‡å°‘å¹¶å‘ç«äº‰

âœ… å¯é æ€§ä¿éšœ
â”œâ”€ è¶…æ—¶æœºåˆ¶é˜²æ­¢æ— é™ç­‰å¾…
â”œâ”€ é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶å¤±è´¥
â”œâ”€ ç›‘æ§æœºåˆ¶åŠæ—¶å‘ç°é—®é¢˜
â””â”€ æ¸…ç†æœºåˆ¶å›æ”¶èµ„æº
```

### 9.3 åº”ç”¨åœºæ™¯æŒ‡å¯¼


**ğŸ”§ å®é™…åº”ç”¨å»ºè®®**
```
åœºæ™¯é€‰æ‹©æŒ‡å—ï¼š

é«˜å¹¶å‘OLTPç³»ç»Ÿï¼š
â€¢ ä½¿ç”¨ç®€å•FIFOé˜Ÿåˆ—
â€¢ è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
â€¢ é‡ç‚¹ä¼˜åŒ–é˜Ÿåˆ—æ“ä½œæ€§èƒ½

ä¼˜å…ˆçº§ä¸šåŠ¡ç³»ç»Ÿï¼š
â€¢ ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—
â€¢ å®ç°è€åŒ–æœºåˆ¶é˜²æ­¢é¥¥é¥¿
â€¢ åŠ¨æ€è°ƒæ•´ä¼˜å…ˆçº§å‚æ•°

æ‰¹å¤„ç†ç³»ç»Ÿï¼š
â€¢ ä½¿ç”¨è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
â€¢ æ”¯æŒæ‰¹é‡å”¤é†’æ“ä½œ
â€¢ ä¼˜åŒ–å¤§é˜Ÿåˆ—çš„å¤„ç†æ€§èƒ½
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - **FIFOé˜Ÿåˆ—**ï¼šå…¬å¹³ç®€å•ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
> - **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šé‡è¦æ€§åŒºåˆ†ï¼Œéœ€è¦é˜²æ­¢é¥¥é¥¿
> - **è¶…æ—¶æœºåˆ¶**ï¼šå¿…å¤‡åŠŸèƒ½ï¼Œä¿æŠ¤ç³»ç»Ÿèµ„æº
> - **æ€§èƒ½ä¼˜åŒ–**ï¼šç´¢å¼•ã€ç¼“å­˜ã€åˆ†æ®µé”æ˜¯å…³é”®
> - **ç›‘æ§ç®¡ç†**ï¼šé˜Ÿåˆ—å¥åº·çŠ¶æ€éœ€è¦æŒç»­ç›‘æ§