---
title: 16ã€é”çš„å…¬å¹³æ€§æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [é”å…¬å¹³æ€§åŸºæœ¬æ¦‚å¿µ](#1-é”å…¬å¹³æ€§åŸºæœ¬æ¦‚å¿µ)
2. [FIFOç­‰å¾…é˜Ÿåˆ—æœºåˆ¶](#2-FIFOç­‰å¾…é˜Ÿåˆ—æœºåˆ¶)
3. [ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥](#3-ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥)
4. [é¥¥é¥¿é—®é¢˜é˜²æ­¢](#4-é¥¥é¥¿é—®é¢˜é˜²æ­¢)
5. [å…¬å¹³æ€§ç›‘æ§æŒ‡æ ‡](#5-å…¬å¹³æ€§ç›‘æ§æŒ‡æ ‡)
6. [å…¬å¹³æ€§ä¸æ€§èƒ½æƒè¡¡](#6-å…¬å¹³æ€§ä¸æ€§èƒ½æƒè¡¡)
7. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#7-å¼‚å¸¸å¤„ç†æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. âš–ï¸ é”å…¬å¹³æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é”å…¬å¹³æ€§


**é”å…¬å¹³æ€§**æŒ‡çš„æ˜¯å¤šä¸ªäº‹åŠ¡ç«äº‰åŒä¸€èµ„æºæ—¶ï¼ŒæŒ‰ç…§åˆç†çš„é¡ºåºè·å¾—é”ï¼Œé¿å…æŸäº›äº‹åŠ¡é•¿æœŸå¾—ä¸åˆ°æ‰§è¡Œæœºä¼šã€‚å°±åƒæ’é˜Ÿä¹°ç¥¨ï¼Œåº”è¯¥"å…ˆæ¥å…ˆæœåŠ¡"ã€‚

```
å…¬å¹³æ€§ç¤ºæ„å›¾ï¼š
äº‹åŠ¡A â†’ ç­‰å¾…é˜Ÿåˆ— â†’ [A] [B] [C] [D] â†’ æŒ‰é¡ºåºè·å–é”
äº‹åŠ¡B â†’ è¯·æ±‚é”   â†‘                   â†“
äº‹åŠ¡C â†’          |                 é”æŒæœ‰è€…
äº‹åŠ¡D â†’          é˜Ÿåˆ—ç®¡ç†              â†“
                                   é‡Šæ”¾é”
```

### 1.2 å…¬å¹³æ€§ç±»å‹åˆ†æ


**é”è·å–å…¬å¹³æ€§åˆ†ç±»**

| å…¬å¹³æ€§ç±»å‹ | **è°ƒåº¦æ–¹å¼** | **æ€§èƒ½å½±å“** | **é€‚ç”¨åœºæ™¯** |
|-----------|------------|-------------|-------------|
| ğŸŸ¢ **å¼ºå…¬å¹³** | `ä¸¥æ ¼FIFO` | `æ€§èƒ½è¾ƒä½` | `è¦æ±‚ç»å¯¹å…¬å¹³` |
| ğŸŸ¡ **å¼±å…¬å¹³** | `å¤§è‡´æœ‰åº` | `æ€§èƒ½ä¸­ç­‰` | `ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯` |
| ğŸ”´ **éå…¬å¹³** | `æŠ¢å å¼` | `æ€§èƒ½æœ€é«˜` | `é«˜å¹¶å‘åœºæ™¯` |

### 1.3 å…¬å¹³æ€§çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å…¬å¹³æ€§**
- **é¿å…é¥¥é¥¿**ï¼šé˜²æ­¢æŸäº›äº‹åŠ¡æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œ
- **ç³»ç»Ÿç¨³å®š**ï¼šä¿è¯æ‰€æœ‰ç”¨æˆ·è¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…éƒ¨åˆ†ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…
- **èµ„æºå‡è¡¡**ï¼šåˆç†åˆ†é…ç³»ç»Ÿèµ„æº

---

## 2. ğŸ“‹ FIFOç­‰å¾…é˜Ÿåˆ—æœºåˆ¶


### 2.1 FIFOé˜Ÿåˆ—åŸºæœ¬åŸç†


**FIFOï¼ˆFirst In First Outï¼‰**æ˜¯æœ€åŸºæœ¬çš„å…¬å¹³æ€§ä¿è¯æœºåˆ¶ï¼Œå°±åƒé“¶è¡Œæ’é˜Ÿå«å·ç³»ç»Ÿã€‚

```
FIFOé˜Ÿåˆ—ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é”ç­‰å¾…é˜Ÿåˆ—     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº‹åŠ¡1 (ç­‰å¾…3s)  â”‚ â† é˜Ÿåˆ—å¤´éƒ¨ï¼Œä¼˜å…ˆè·å–
â”‚ äº‹åŠ¡2 (ç­‰å¾…2s)  â”‚
â”‚ äº‹åŠ¡3 (ç­‰å¾…1s)  â”‚
â”‚ äº‹åŠ¡4 (åˆšåŠ å…¥)  â”‚ â† é˜Ÿåˆ—å°¾éƒ¨ï¼Œæœ€åè·å–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 InnoDBä¸­çš„ç­‰å¾…é˜Ÿåˆ—


```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    waiting_pid,
    waiting_query,
    blocking_pid,
    wait_age
FROM sys.innodb_lock_waits;

-- ç¤ºä¾‹ç»“æœ
-- waiting_pid | blocking_pid | wait_age
-- 100        | 99          | 00:00:15
-- 101        | 99          | 00:00:12  
-- 102        | 99          | 00:00:08
```

### 2.3 é˜Ÿåˆ—ç®¡ç†æœºåˆ¶


**å…¥é˜Ÿå’Œå‡ºé˜Ÿè¿‡ç¨‹**

```sql
-- äº‹åŠ¡AæŒæœ‰é”
START TRANSACTION;
SELECT * FROM orders WHERE id = 1 FOR UPDATE;

-- äº‹åŠ¡Bè¯·æ±‚åŒä¸€è¡Œé”ï¼ˆè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼‰
-- Session B
START TRANSACTION;
SELECT * FROM orders WHERE id = 1 FOR UPDATE; -- ç­‰å¾…

-- äº‹åŠ¡Cä¹Ÿè¯·æ±‚ç›¸åŒé”ï¼ˆæ’åœ¨Båé¢ï¼‰
-- Session C  
START TRANSACTION;
SELECT * FROM orders WHERE id = 1 FOR UPDATE; -- æ’é˜Ÿç­‰å¾…
```

**é˜Ÿåˆ—çŠ¶æ€æŸ¥è¯¢**
```sql
-- æŸ¥çœ‹é”ç­‰å¾…é˜Ÿåˆ—çŠ¶æ€
SELECT 
    r.trx_id AS waiting_trx,
    r.trx_mysql_thread_id AS waiting_thread,
    TIMESTAMPDIFF(SECOND, r.trx_wait_started, NOW()) AS wait_time,
    b.trx_id AS blocking_trx
FROM 
    information_schema.innodb_lock_waits w
    JOIN information_schema.innodb_trx r ON w.requesting_trx_id = r.trx_id
    JOIN information_schema.innodb_trx b ON w.blocking_trx_id = b.trx_id
ORDER BY wait_time DESC;
```

---

## 3. ğŸ¯ ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥


### 3.1 äº‹åŠ¡ä¼˜å…ˆçº§è®¾ç½®


MySQLæ”¯æŒé€šè¿‡äº‹åŠ¡ä¼˜å…ˆçº§æ¥å½±å“é”è·å–é¡ºåºï¼Œé«˜ä¼˜å…ˆçº§äº‹åŠ¡å¯ä»¥ä¼˜å…ˆè·å¾—é”ã€‚

```sql
-- è®¾ç½®äº‹åŠ¡ä¼˜å…ˆçº§
START TRANSACTION;
SET innodb_trx_priority = 1;  -- é«˜ä¼˜å…ˆçº§(é»˜è®¤ä¸º0)

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
```

### 3.2 ä¼˜å…ˆçº§è°ƒåº¦è§„åˆ™


**ä¼˜å…ˆçº§å½±å“å› ç´ **

| ä¼˜å…ˆçº§å› ç´  | **æƒé‡** | **å½±å“ç¨‹åº¦** | **ä½¿ç”¨åœºæ™¯** |
|-----------|---------|-------------|-------------|
| ğŸ”¥ **ç³»ç»Ÿäº‹åŠ¡** | `æœ€é«˜` | `ç«‹å³ä¼˜å…ˆ` | `å…ƒæ•°æ®æ“ä½œ` |
| â­ **æ˜¾å¼ä¼˜å…ˆçº§** | `é«˜` | `æ˜æ˜¾ä¼˜å…ˆ` | `é‡è¦ä¸šåŠ¡` |
| ğŸ“Š **äº‹åŠ¡å¤§å°** | `ä¸­` | `é€‚åº¦ä¼˜å…ˆ` | `å¤§äº‹åŠ¡ä¼˜å…ˆ` |
| â±ï¸ **ç­‰å¾…æ—¶é—´** | `ä½` | `å¾®è°ƒä¼˜å…ˆ` | `é˜²æ­¢é¥¥é¥¿` |

### 3.3 ä¼˜å…ˆçº§è°ƒåº¦ç¤ºä¾‹


```sql
-- æ™®é€šäº‹åŠ¡
START TRANSACTION;
UPDATE products SET stock = stock - 1 WHERE id = 100;

-- é«˜ä¼˜å…ˆçº§äº‹åŠ¡ï¼ˆæ¯”å¦‚ç®¡ç†å‘˜æ“ä½œï¼‰
START TRANSACTION;
SET innodb_trx_priority = 5;
UPDATE products SET status = 'discontinued' WHERE id = 100;
-- è¿™ä¸ªäº‹åŠ¡ä¼šä¼˜å…ˆè·å¾—é”
```

---

## 4. ğŸš« é¥¥é¥¿é—®é¢˜é˜²æ­¢


### 4.1 ä»€ä¹ˆæ˜¯é”é¥¥é¥¿


**é”é¥¥é¥¿ç°è±¡**æŒ‡æŸäº›äº‹åŠ¡å› ä¸ºä¼˜å…ˆçº§ä½æˆ–è¿æ°”ä¸å¥½ï¼Œé•¿æ—¶é—´æ— æ³•è·å¾—æ‰€éœ€çš„é”ã€‚

```
é¥¥é¥¿åœºæ™¯ç¤ºä¾‹ï¼š
æ—¶é—´çº¿ï¼šT1 â†’ T2 â†’ T3 â†’ T4 â†’ T5
äº‹åŠ¡Aï¼š     [ç­‰å¾…] [ç­‰å¾…] [ç­‰å¾…] [ç­‰å¾…] [ç­‰å¾…]  â† ä¸€ç›´é¥¥é¥¿
äº‹åŠ¡Bï¼š     [æŒé”] é‡Šæ”¾                          
äº‹åŠ¡Cï¼š           [æŒé”] é‡Šæ”¾
äº‹åŠ¡Dï¼š                 [æŒé”] é‡Šæ”¾  
äº‹åŠ¡Eï¼š                       [æŒé”]
```

### 4.2 MySQLé¥¥é¥¿é˜²æ­¢æœºåˆ¶


**å†…ç½®é˜²é¥¥é¥¿ç­–ç•¥**

```sql
-- æŸ¥çœ‹äº‹åŠ¡ç­‰å¾…è¶…æ—¶è®¾ç½®
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
-- é»˜è®¤50ç§’ï¼Œé˜²æ­¢æ— é™ç­‰å¾…

-- æ­»é”æ£€æµ‹æœºåˆ¶
SHOW VARIABLES LIKE 'innodb_deadlock_detect';
-- è‡ªåŠ¨æ£€æµ‹å¹¶è§£å†³æ­»é”ï¼Œé‡Šæ”¾èµ„æº
```

### 4.3 é¥¥é¥¿é¢„é˜²é…ç½®


```sql
-- é…ç½®ç­‰å¾…è¶…æ—¶æ—¶é—´
SET GLOBAL innodb_lock_wait_timeout = 30;

-- å¯ç”¨æ­»é”æ£€æµ‹
SET GLOBAL innodb_deadlock_detect = ON;

-- é…ç½®å›æ»šç­–ç•¥
-- åœ¨ my.cnf ä¸­è®¾ç½®
[mysqld]
innodb_lock_wait_timeout = 30
innodb_deadlock_detect = ON
```

### 4.4 åº”ç”¨å±‚é˜²é¥¥é¥¿ç­–ç•¥


```sql
-- åº”ç”¨å±‚é‡è¯•æœºåˆ¶
DELIMITER $$
CREATE PROCEDURE safe_update_with_retry()
BEGIN
    DECLARE retry_count INT DEFAULT 0;
    DECLARE max_retries INT DEFAULT 3;
    DECLARE done BOOLEAN DEFAULT FALSE;
    
    REPEAT
        BEGIN
            DECLARE CONTINUE HANDLER FOR 1205  -- é”ç­‰å¾…è¶…æ—¶
            BEGIN
                SET retry_count = retry_count + 1;
                IF retry_count >= max_retries THEN
                    SET done = TRUE;
                END IF;
            END;
            
            START TRANSACTION;
            UPDATE accounts SET balance = balance - 100 WHERE id = 1;
            COMMIT;
            SET done = TRUE;
        END;
        
        IF NOT done THEN
            -- éšæœºç­‰å¾…é¿å…åŒæ—¶é‡è¯•
            SELECT SLEEP(RAND() * 2);
        END IF;
        
    UNTIL done END REPEAT;
END$$
```

---

## 5. ğŸ“Š å…¬å¹³æ€§ç›‘æ§æŒ‡æ ‡


### 5.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**å…¬å¹³æ€§ç›‘æ§æŒ‡æ ‡ä½“ç³»**

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§é¡¹ç›®** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸é˜ˆå€¼** |
|---------|------------|-------------|-------------|
| â±ï¸ **ç­‰å¾…æ—¶é—´** | `å¹³å‡ç­‰å¾…æ—¶é•¿` | `< 5ç§’` | `> 30ç§’` |
| ğŸ“ˆ **é˜Ÿåˆ—é•¿åº¦** | `ç­‰å¾…é˜Ÿåˆ—æ·±åº¦` | `< 10` | `> 50` |
| ğŸ”„ **è¶…æ—¶é¢‘ç‡** | `é”ç­‰å¾…è¶…æ—¶ç‡` | `< 1%` | `> 5%` |
| âš–ï¸ **å…¬å¹³æ€§æŒ‡æ•°** | `ç­‰å¾…æ—¶é—´æ–¹å·®` | `ä½æ–¹å·®` | `é«˜æ–¹å·®` |

### 5.2 ç›‘æ§æŸ¥è¯¢è¯­å¥


```sql
-- ç›‘æ§å½“å‰é”ç­‰å¾…çŠ¶å†µ
SELECT 
    COUNT(*) AS waiting_transactions,
    AVG(TIMESTAMPDIFF(SECOND, trx_wait_started, NOW())) AS avg_wait_time,
    MAX(TIMESTAMPDIFF(SECOND, trx_wait_started, NOW())) AS max_wait_time
FROM information_schema.innodb_trx 
WHERE trx_state = 'LOCK WAIT';

-- ç›‘æ§é”ç­‰å¾…è¶…æ—¶æƒ…å†µ
SELECT 
    VARIABLE_VALUE AS lock_timeouts
FROM performance_schema.global_status 
WHERE VARIABLE_NAME = 'Innodb_lock_wait_timeouts';
```

### 5.3 å…¬å¹³æ€§åˆ†ææŸ¥è¯¢


```sql
-- åˆ†æé”ç­‰å¾…åˆ†å¸ƒæƒ…å†µ
SELECT 
    CASE 
        WHEN wait_time < 1 THEN '< 1ç§’'
        WHEN wait_time < 5 THEN '1-5ç§’' 
        WHEN wait_time < 10 THEN '5-10ç§’'
        WHEN wait_time < 30 THEN '10-30ç§’'
        ELSE '> 30ç§’'
    END AS wait_time_range,
    COUNT(*) AS transaction_count
FROM (
    SELECT TIMESTAMPDIFF(SECOND, trx_wait_started, NOW()) AS wait_time
    FROM information_schema.innodb_trx 
    WHERE trx_state = 'LOCK WAIT'
) AS wait_times
GROUP BY wait_time_range;
```

---

## 6. âš¡ å…¬å¹³æ€§ä¸æ€§èƒ½æƒè¡¡


### 6.1 æƒè¡¡å…³ç³»åˆ†æ


**å…¬å¹³æ€§ä¸æ€§èƒ½çš„çŸ›ç›¾**

```
æ€§èƒ½ä¼˜å…ˆç­–ç•¥ï¼š
â”œâ”€â”€ æŠ¢å å¼é”è·å–
â”œâ”€â”€ æ— é˜Ÿåˆ—ç®¡ç†å¼€é”€  
â”œâ”€â”€ é«˜ååé‡
â””â”€â”€ å¯èƒ½å¯¼è‡´é¥¥é¥¿

å…¬å¹³æ€§ä¼˜å…ˆç­–ç•¥ï¼š
â”œâ”€â”€ FIFOé˜Ÿåˆ—ç®¡ç†
â”œâ”€â”€ é¢å¤–è°ƒåº¦å¼€é”€
â”œâ”€â”€ ååé‡ä¸‹é™
â””â”€â”€ ä¿è¯æ‰€æœ‰äº‹åŠ¡æ‰§è¡Œ
```

### 6.2 ä¸åŒåœºæ™¯çš„é€‰æ‹©ç­–ç•¥


**åœºæ™¯é©±åŠ¨çš„é…ç½®é€‰æ‹©**

| ä¸šåŠ¡åœºæ™¯ | **å…¬å¹³æ€§è¦æ±‚** | **æ€§èƒ½è¦æ±‚** | **æ¨èé…ç½®** |
|---------|--------------|-------------|-------------|
| ğŸª **ç”µå•†ç§’æ€** | `ä½` | `æé«˜` | `éå…¬å¹³é”ï¼ŒçŸ­è¶…æ—¶` |
| ğŸ¦ **é“¶è¡Œè½¬è´¦** | `é«˜` | `ä¸­ç­‰` | `å…¬å¹³é”ï¼Œé€‚ä¸­è¶…æ—¶` |
| ğŸ“Š **æŠ¥è¡¨ç”Ÿæˆ** | `ä¸­` | `ä½` | `å¼±å…¬å¹³ï¼Œé•¿è¶…æ—¶` |
| ğŸ® **æ¸¸æˆæ’è¡Œæ¦œ** | `ä¸­` | `é«˜` | `å¼±å…¬å¹³ï¼ŒçŸ­è¶…æ—¶` |

### 6.3 åŠ¨æ€è°ƒæ•´ç­–ç•¥


```sql
-- æ ¹æ®ä¸šåŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´
-- é«˜å³°æœŸé…ç½®ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
SET GLOBAL innodb_lock_wait_timeout = 10;

-- ä½å³°æœŸé…ç½®ï¼ˆå…¬å¹³æ€§ä¼˜å…ˆï¼‰ 
SET GLOBAL innodb_lock_wait_timeout = 60;

-- ç›‘æ§è´Ÿè½½å¹¶è‡ªåŠ¨è°ƒæ•´çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE auto_adjust_lock_timeout()
BEGIN
    DECLARE current_load INT;
    
    -- è·å–å½“å‰ç­‰å¾…äº‹åŠ¡æ•°
    SELECT COUNT(*) INTO current_load
    FROM information_schema.innodb_trx 
    WHERE trx_state = 'LOCK WAIT';
    
    -- æ ¹æ®è´Ÿè½½è°ƒæ•´è¶…æ—¶æ—¶é—´
    IF current_load > 50 THEN
        SET GLOBAL innodb_lock_wait_timeout = 10;  -- é«˜è´Ÿè½½çŸ­è¶…æ—¶
    ELSEIF current_load > 20 THEN
        SET GLOBAL innodb_lock_wait_timeout = 30;  -- ä¸­è´Ÿè½½ä¸­ç­‰è¶…æ—¶
    ELSE
        SET GLOBAL innodb_lock_wait_timeout = 60;  -- ä½è´Ÿè½½é•¿è¶…æ—¶
    END IF;
END$$
```

---

## 7. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 7.1 å…¬å¹³æ€§å¼‚å¸¸ç±»å‹


**å¸¸è§å…¬å¹³æ€§å¼‚å¸¸æƒ…å†µ**

```
å¼‚å¸¸ç±»å‹åˆ†ç±»ï¼š
â”œâ”€â”€ é”ç­‰å¾…è¶…æ—¶
â”‚   â”œâ”€â”€ å•ä¸ªäº‹åŠ¡è¶…æ—¶
â”‚   â””â”€â”€ æ‰¹é‡äº‹åŠ¡è¶…æ—¶
â”œâ”€â”€ æ­»é”æ£€æµ‹
â”‚   â”œâ”€â”€ ç®€å•ç¯å½¢æ­»é”
â”‚   â””â”€â”€ å¤æ‚å¤šæ–¹æ­»é”  
â”œâ”€â”€ ä¼˜å…ˆçº§å€’ç½®
â”‚   â”œâ”€â”€ ä½ä¼˜å…ˆçº§é˜»å¡é«˜ä¼˜å…ˆçº§
â”‚   â””â”€â”€ é•¿æ—¶é—´ä¼˜å…ˆçº§æ··ä¹±
â””â”€â”€ ç³»ç»Ÿèµ„æºä¸è¶³
    â”œâ”€â”€ å†…å­˜ä¸è¶³
    â””â”€â”€ è¿æ¥æ•°è¿‡å¤š
```

### 7.2 å¼‚å¸¸æ£€æµ‹ä¸å¤„ç†


```sql
-- æ­»é”æ£€æµ‹æŸ¥è¯¢
SELECT 
    r.trx_id AS request_trx_id,
    r.trx_mysql_thread_id AS request_thread,
    b.trx_id AS blocking_trx_id,
    b.trx_mysql_thread_id AS blocking_thread
FROM information_schema.innodb_lock_waits w
JOIN information_schema.innodb_trx r ON w.requesting_trx_id = r.trx_id  
JOIN information_schema.innodb_trx b ON w.blocking_trx_id = b.trx_id;

-- é•¿æ—¶é—´ç­‰å¾…æ£€æµ‹
SELECT 
    trx_id,
    trx_mysql_thread_id,
    trx_state,
    TIMESTAMPDIFF(SECOND, trx_wait_started, NOW()) AS wait_seconds
FROM information_schema.innodb_trx 
WHERE trx_state = 'LOCK WAIT' 
AND trx_wait_started < DATE_SUB(NOW(), INTERVAL 30 SECOND);
```

### 7.3 è‡ªåŠ¨æ¢å¤æœºåˆ¶


```sql
-- è‡ªåŠ¨å¤„ç†å¼‚å¸¸ç­‰å¾…çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE handle_lock_exceptions()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE thread_id INT;
    DECLARE wait_time INT;
    
    DECLARE cur CURSOR FOR 
        SELECT trx_mysql_thread_id, 
               TIMESTAMPDIFF(SECOND, trx_wait_started, NOW())
        FROM information_schema.innodb_trx 
        WHERE trx_state = 'LOCK WAIT' 
        AND trx_wait_started < DATE_SUB(NOW(), INTERVAL 60 SECOND);
        
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur;
    
    read_loop: LOOP
        FETCH cur INTO thread_id, wait_time;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- è®°å½•å¼‚å¸¸æƒ…å†µ
        INSERT INTO lock_exception_log(thread_id, wait_time, action, created_at)
        VALUES(thread_id, wait_time, 'KILLED', NOW());
        
        -- ç»ˆæ­¢é•¿æ—¶é—´ç­‰å¾…çš„äº‹åŠ¡
        SET @sql = CONCAT('KILL ', thread_id);
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
    END LOOP;
    
    CLOSE cur;
END$$
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å…¬å¹³æ€§æœ¬è´¨ï¼šä¿è¯æ‰€æœ‰äº‹åŠ¡éƒ½æœ‰å…¬å¹³çš„æ‰§è¡Œæœºä¼š
ğŸ”¸ FIFOé˜Ÿåˆ—ï¼šå…ˆæ¥å…ˆæœåŠ¡çš„åŸºæœ¬å…¬å¹³æ€§ä¿è¯æœºåˆ¶  
ğŸ”¸ ä¼˜å…ˆçº§è°ƒåº¦ï¼šåŸºäºäº‹åŠ¡é‡è¦æ€§çš„å·®å¼‚åŒ–å¤„ç†
ğŸ”¸ é¥¥é¥¿é˜²æ­¢ï¼šé€šè¿‡è¶…æ—¶å’Œæ£€æµ‹æœºåˆ¶é¿å…æ°¸ä¹…ç­‰å¾…
ğŸ”¸ ç›‘æ§æŒ‡æ ‡ï¼šç­‰å¾…æ—¶é—´ã€é˜Ÿåˆ—é•¿åº¦ã€è¶…æ—¶ç‡ç­‰å…³é”®æŒ‡æ ‡
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å…¬å¹³æ€§çš„æ ¸å¿ƒä»·å€¼**
```
ç³»ç»Ÿç¨³å®šæ€§ï¼šé˜²æ­¢éƒ¨åˆ†äº‹åŠ¡æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œ
ç”¨æˆ·ä½“éªŒï¼šé¿å…ç”¨æˆ·æ„Ÿå—åˆ°æ˜æ˜¾çš„ä¸å…¬å¹³
èµ„æºåˆ©ç”¨ï¼šåˆç†åˆ†é…ç³»ç»Ÿèµ„æºï¼Œæé«˜æ•´ä½“æ•ˆç‡
```

**ğŸ”¹ æ€§èƒ½ä¸å…¬å¹³æ€§çš„å¹³è¡¡**
```
ç»å¯¹å…¬å¹³ï¼šæ€§èƒ½å¼€é”€å¤§ï¼Œä½†ä¿è¯ä¸¥æ ¼é¡ºåº
ç›¸å¯¹å…¬å¹³ï¼šæ€§èƒ½è¾ƒå¥½ï¼Œå…è®¸é€‚åº¦çš„è°ƒåº¦ä¼˜åŒ–
æ€§èƒ½ä¼˜å…ˆï¼šé«˜ååé‡ï¼Œä½†å¯èƒ½äº§ç”Ÿé¥¥é¥¿ç°è±¡
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§**
```
é¢„é˜²æœºåˆ¶ï¼šé€šè¿‡è¶…æ—¶è®¾ç½®é˜²æ­¢æ— é™ç­‰å¾…
æ£€æµ‹æœºåˆ¶ï¼šåŠæ—¶å‘ç°æ­»é”å’Œå¼‚å¸¸ç­‰å¾…
æ¢å¤æœºåˆ¶ï¼šè‡ªåŠ¨å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œç»´æŠ¤ç³»ç»Ÿç¨³å®š
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


- **ğŸ¯ ç³»ç»Ÿç¨³å®šæ€§**ï¼šé˜²æ­¢é”é¥¥é¥¿å¯¼è‡´çš„ç³»ç»Ÿå¼‚å¸¸
- **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨å…¬å¹³æ€§å’Œæ€§èƒ½é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹
- **ğŸ” é—®é¢˜è¯Šæ–­**ï¼šé€šè¿‡ç›‘æ§æŒ‡æ ‡å¿«é€Ÿå®šä½é”ç›¸å…³é—®é¢˜
- **ğŸ› ï¸ è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå»ºç«‹è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æœºåˆ¶
- **ğŸ“Š å®¹é‡è§„åˆ’**ï¼šåŸºäºå…¬å¹³æ€§æŒ‡æ ‡è¿›è¡Œç³»ç»Ÿå®¹é‡è¯„ä¼°

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å…¬å¹³æ€§æ˜¯å¤šäº‹åŠ¡ç¯å¢ƒä¸‹çš„é‡è¦ä¿è¯æœºåˆ¶
- FIFOé˜Ÿåˆ—æä¾›åŸºæœ¬å…¬å¹³æ€§ï¼Œä¼˜å…ˆçº§è°ƒåº¦æä¾›çµæ´»æ€§
- éœ€è¦åœ¨å…¬å¹³æ€§å’Œæ€§èƒ½ä¹‹é—´æ ¹æ®ä¸šåŠ¡éœ€æ±‚åšæƒè¡¡
- å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶ç¡®ä¿ç³»ç»Ÿç¨³å®š