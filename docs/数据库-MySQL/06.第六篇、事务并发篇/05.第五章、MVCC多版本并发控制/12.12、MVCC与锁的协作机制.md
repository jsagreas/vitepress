---
title: 12ã€MVCCä¸é”çš„åä½œæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [MVCCä¸é”åä½œæ¦‚è¿°](#1-mvccä¸é”åä½œæ¦‚è¿°)
2. [å¿«ç…§è¯»æ— é”æœºåˆ¶è¯¦è§£](#2-å¿«ç…§è¯»æ— é”æœºåˆ¶è¯¦è§£)
3. [å½“å‰è¯»åŠ é”ç­–ç•¥](#3-å½“å‰è¯»åŠ é”ç­–ç•¥)
4. [é”ä¸ç‰ˆæœ¬å…¼å®¹æ€§åŸç†](#4-é”ä¸ç‰ˆæœ¬å…¼å®¹æ€§åŸç†)
5. [å¹¶å‘æ§åˆ¶åè°ƒæœºåˆ¶](#5-å¹¶å‘æ§åˆ¶åè°ƒæœºåˆ¶)
6. [è¯»å†™å†²çªå¤„ç†ç­–ç•¥](#6-è¯»å†™å†²çªå¤„ç†ç­–ç•¥)
7. [æ··åˆå¹¶å‘æ§åˆ¶å®ç°](#7-æ··åˆå¹¶å‘æ§åˆ¶å®ç°)
8. [åä½œæœºåˆ¶æ€§èƒ½ä¼˜åŒ–](#8-åä½œæœºåˆ¶æ€§èƒ½ä¼˜åŒ–)
9. [åä½œæ•…éšœå¤„ç†](#9-åä½œæ•…éšœå¤„ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤ MVCCä¸é”åä½œæ¦‚è¿°


### 1.1 åä½œæœºåˆ¶çš„æœ¬è´¨


**ä»€ä¹ˆæ˜¯MVCCä¸é”çš„åä½œï¼Ÿ**

MVCCï¼ˆMulti-Version Concurrency Controlï¼‰ä¸é”æœºåˆ¶çš„åä½œï¼Œå°±åƒæ˜¯**ç°ä»£å›¾ä¹¦é¦†çš„æ™ºèƒ½ç®¡ç†ç³»ç»Ÿ**ï¼š

```
ä¼ ç»Ÿé”æœºåˆ¶ï¼ˆè€å¼å›¾ä¹¦é¦†ï¼‰ï¼š
è¯»è€…Aå€Ÿä¹¦ â†’ å›¾ä¹¦è¢«é”å®š â†’ å…¶ä»–äººç­‰å¾… â†’ è¿˜ä¹¦åè§£é”

MVCCåä½œï¼ˆç°ä»£å›¾ä¹¦é¦†ï¼‰ï¼š
è¯»è€…Aè¦ç¬¬3ç‰ˆ â†’ ç›´æ¥å€Ÿèµ°ï¼Œä¸å½±å“ä»–äºº
è¯»è€…Bè¦æœ€æ–°ç‰ˆ â†’ å¯ä»¥åŒæ—¶å€Ÿé˜…
ä¿®æ”¹è€…Cæ›´æ–° â†’ åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œä¸å¹²æ‰°ç°æœ‰è¯»è€…
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼šMVCCè®©è¯»æ“ä½œ"å‡ ä¹æ— é”"ï¼Œå†™æ“ä½œç²¾ç¡®åŠ é”ï¼Œä¸¤è€…å®Œç¾é…åˆå®ç°é«˜å¹¶å‘

### 1.2 åä½œæœºåˆ¶çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦MVCCä¸é”åä½œï¼Ÿ**

```
å•çº¯MVCCçš„å±€é™ï¼š
â€¢ è¯»æ“ä½œå¾ˆå¿«ï¼Œä½†å†™æ“ä½œå†²çªå¤æ‚
â€¢ æ— æ³•è§£å†³å¹»è¯»ç­‰ç‰¹æ®Šé—®é¢˜
â€¢ ç‰ˆæœ¬ç®¡ç†å¼€é”€å¯èƒ½å¾ˆå¤§

å•çº¯é”æœºåˆ¶çš„é—®é¢˜ï¼š
â€¢ è¯»å†™äº’æ–¥ï¼Œå¹¶å‘æ€§èƒ½å·®
â€¢ å®¹æ˜“äº§ç”Ÿæ­»é”
â€¢ é•¿äº‹åŠ¡é˜»å¡ä¸¥é‡

åä½œçš„ä¼˜åŠ¿ï¼š
â€¢ è¯»å¤šå†™å°‘åœºæ™¯æ€§èƒ½ä¼˜ç§€
â€¢ ä¿è¯æ•°æ®ä¸€è‡´æ€§
â€¢ é¿å…å¤§éƒ¨åˆ†é”ç«äº‰
```

### 1.3 åä½œæœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³


**åŒè½¨åˆ¶å¹¶å‘æ§åˆ¶**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¿«ç…§è¯»è·¯å¾„     â”‚    â”‚   å½“å‰è¯»è·¯å¾„     â”‚
â”‚  (Snapshot Read) â”‚    â”‚ (Current Read)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¯»å†å²ç‰ˆæœ¬     â”‚    â”‚ â€¢ è¯»æœ€æ–°ç‰ˆæœ¬     â”‚
â”‚ â€¢ æ— éœ€åŠ é”       â”‚    â”‚ â€¢ éœ€è¦åŠ é”       â”‚
â”‚ â€¢ MVCCæœºåˆ¶       â”‚    â”‚ â€¢ é”æœºåˆ¶         â”‚
â”‚ â€¢ é«˜å¹¶å‘æ€§èƒ½     â”‚    â”‚ â€¢ å¼ºä¸€è‡´æ€§       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   åè°ƒä¸­å¿ƒ       â”‚
        â”‚ â€¢ ç‰ˆæœ¬ç®¡ç†       â”‚
        â”‚ â€¢ é”çŠ¶æ€è·Ÿè¸ª     â”‚
        â”‚ â€¢ å†²çªæ£€æµ‹       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ‘€ å¿«ç…§è¯»æ— é”æœºåˆ¶è¯¦è§£


### 2.1 å¿«ç…§è¯»çš„å·¥ä½œåŸç†


**ä»€ä¹ˆæ˜¯å¿«ç…§è¯»ï¼Ÿ**

å¿«ç…§è¯»å°±åƒç»™æ•°æ®åº“æ‹ç…§ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½æ˜¯**äº‹åŠ¡å¼€å§‹æ—¶åˆ»çš„æ•°æ®å¿«ç…§**ï¼Œä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹å½±å“ã€‚

```sql
-- å¿«ç…§è¯»ç¤ºä¾‹ï¼ˆæ— é”æ“ä½œï¼‰
BEGIN;
SELECT * FROM users WHERE id = 1;  -- è¯»å–å¿«ç…§ç‰ˆæœ¬
-- å³ä½¿å…¶ä»–äº‹åŠ¡ä¿®æ”¹äº†id=1çš„è®°å½•ï¼Œè¿™é‡Œè¯»åˆ°çš„è¿˜æ˜¯å¿«ç…§ç‰ˆæœ¬
COMMIT;
```

### 2.2 å¿«ç…§è¯»çš„ç‰ˆæœ¬é€‰æ‹©æœºåˆ¶


**ç‰ˆæœ¬å¯è§æ€§è§„åˆ™**ï¼š

```
æ•°æ®ç‰ˆæœ¬é“¾ç¤ºä¾‹ï¼š
ç‰ˆæœ¬4 [id=1, name="Alice_v4", trx_id=104, del_flag=0] â† æœ€æ–°ç‰ˆæœ¬
ç‰ˆæœ¬3 [id=1, name="Alice_v3", trx_id=103, del_flag=0]
ç‰ˆæœ¬2 [id=1, name="Alice_v2", trx_id=102, del_flag=0]  
ç‰ˆæœ¬1 [id=1, name="Alice_v1", trx_id=101, del_flag=0] â† æœ€è€ç‰ˆæœ¬

äº‹åŠ¡100çš„å¿«ç…§è¯»ï¼š
â€¢ äº‹åŠ¡IDï¼š100
â€¢ è¯»è§†å›¾ï¼š[101, 102, 103] ï¼ˆæ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼‰
â€¢ å¯è§ç‰ˆæœ¬ï¼šç‰ˆæœ¬1ï¼ˆtrx_id=101 < å½“å‰äº‹åŠ¡IDä¸”å·²æäº¤ï¼‰
```

**ç‰ˆæœ¬é€‰æ‹©ç®—æ³•**ï¼š

```java
// ç®€åŒ–çš„ç‰ˆæœ¬å¯è§æ€§åˆ¤æ–­
class VersionVisibility {
    boolean isVisible(DataVersion version, ReadView readView) {
        long versionTrxId = version.getTransactionId();
        long currentTrxId = readView.getCurrentTrxId();
        
        // è§„åˆ™1ï¼šè‡ªå·±ä¿®æ”¹çš„ç‰ˆæœ¬æ€»æ˜¯å¯è§
        if (versionTrxId == currentTrxId) {
            return true;
        }
        
        // è§„åˆ™2ï¼šæ¯”ReadViewåˆ›å»ºæ—¶é—´æ—©ä¸”å·²æäº¤çš„ç‰ˆæœ¬å¯è§
        if (versionTrxId < readView.getMinActiveTrxId() 
            && isCommitted(versionTrxId)) {
            return true;
        }
        
        // è§„åˆ™3ï¼šåœ¨æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ä¸­çš„ç‰ˆæœ¬ä¸å¯è§
        if (readView.getActiveTrxIds().contains(versionTrxId)) {
            return false;
        }
        
        return false;
    }
}
```

### 2.3 å¿«ç…§è¯»çš„æ€§èƒ½ä¼˜åŠ¿


**æ— é”å¸¦æ¥çš„æ€§èƒ½æå‡**ï¼š

```
ä¼ ç»ŸåŠ é”è¯»å–ï¼š
è¯»è¯·æ±‚ â†’ ç”³è¯·å…±äº«é” â†’ ç­‰å¾…é” â†’ è¯»å–æ•°æ® â†’ é‡Šæ”¾é”
æ—¶é—´å¼€é”€ï¼šé”ç®¡ç† + ç­‰å¾…æ—¶é—´ + è¯»å–æ—¶é—´

MVCCå¿«ç…§è¯»ï¼š
è¯»è¯·æ±‚ â†’ ç‰ˆæœ¬é€‰æ‹© â†’ ç›´æ¥è¯»å–
æ—¶é—´å¼€é”€ï¼šç‰ˆæœ¬åˆ¤æ–­ + è¯»å–æ—¶é—´

æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ“ä½œç±»å‹    â”‚ ä¼ ç»Ÿé”   â”‚  MVCC   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•çº¯è¯»æ“ä½œ    â”‚  100ms  â”‚   5ms   â”‚
â”‚ è¯»å†™æ··åˆ      â”‚  300ms  â”‚  50ms   â”‚  
â”‚ é«˜å¹¶å‘è¯»      â”‚ 1000ms  â”‚  20ms   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ”’ å½“å‰è¯»åŠ é”ç­–ç•¥


### 3.1 ä»€ä¹ˆæ˜¯å½“å‰è¯»


**å½“å‰è¯»**ï¼šè¯»å–æ•°æ®çš„**æœ€æ–°ç‰ˆæœ¬**ï¼Œå¹¶ä¸”è¯»å–æ—¶éœ€è¦**åŠ é”ä¿æŠ¤**ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šè¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ã€‚

```sql
-- å½“å‰è¯»æ“ä½œï¼ˆéœ€è¦åŠ é”ï¼‰
SELECT * FROM users WHERE id = 1 FOR UPDATE;    -- æ’ä»–é”
SELECT * FROM users WHERE id = 1 LOCK IN SHARE MODE; -- å…±äº«é”

-- UPDATE/DELETEå¤©ç„¶æ˜¯å½“å‰è¯»
UPDATE users SET name = 'Bob' WHERE id = 1;     -- è‡ªåŠ¨åŠ æ’ä»–é”
DELETE FROM users WHERE id = 1;                 -- è‡ªåŠ¨åŠ æ’ä»–é”
```

### 3.2 å½“å‰è¯»çš„åŠ é”ç­–ç•¥


**ä¸åŒæ“ä½œçš„åŠ é”è§„åˆ™**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ“ä½œç±»å‹      â”‚   é”ç±»å‹     â”‚   é”å®šèŒƒå›´     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELECT FOR      â”‚   æ’ä»–é”     â”‚   è¡Œé”        â”‚
â”‚ UPDATE          â”‚   (X-Lock)   â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELECT LOCK IN  â”‚   å…±äº«é”     â”‚   è¡Œé”        â”‚
â”‚ SHARE MODE      â”‚   (S-Lock)   â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UPDATE/DELETE   â”‚   æ’ä»–é”     â”‚ è¡Œé”+é—´éš™é”   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ INSERT          â”‚   æ’ä»–é”     â”‚ æ’å…¥æ„å‘é”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠ é”å®ç°æœºåˆ¶**ï¼š

```java
// å½“å‰è¯»åŠ é”é€»è¾‘
class CurrentReadLocking {
    void lockForCurrentRead(RowKey rowKey, LockType lockType) {
        // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦ç­‰å¾…å…¶ä»–é”
        if (hasConflictingLocks(rowKey, lockType)) {
            waitForLockRelease(rowKey);
        }
        
        // 2. è·å–æœ€æ–°ç‰ˆæœ¬
        DataVersion latestVersion = getLatestVersion(rowKey);
        
        // 3. åŠ é”ä¿æŠ¤
        acquireLock(rowKey, lockType);
        
        // 4. è¿”å›å½“å‰ç‰ˆæœ¬æ•°æ®
        return latestVersion.getData();
    }
}
```

### 3.3 åŠ é”çš„å¿…è¦æ€§åˆ†æ


**ä¸ºä»€ä¹ˆå½“å‰è¯»å¿…é¡»åŠ é”ï¼Ÿ**

```
åœºæ™¯åˆ†æï¼šé“¶è¡Œè½¬è´¦
ç”¨æˆ·Aä½™é¢ï¼š1000å…ƒ

ä¸åŠ é”çš„é—®é¢˜ï¼š
æ—¶åˆ»T1: äº‹åŠ¡1è¯»å–ä½™é¢ 1000å…ƒ (MVCCè¯»å–)
æ—¶åˆ»T2: äº‹åŠ¡2è¯»å–ä½™é¢ 1000å…ƒ (MVCCè¯»å–)  
æ—¶åˆ»T3: äº‹åŠ¡1è½¬å‡º500å…ƒï¼Œä½™é¢=500å…ƒ
æ—¶åˆ»T4: äº‹åŠ¡2è½¬å‡º800å…ƒï¼Œä½™é¢=200å…ƒ (åŸºäº1000å…ƒè®¡ç®—)
ç»“æœï¼šå®é™…è½¬å‡º1300å…ƒï¼Œä½™é¢200å…ƒ âŒé”™è¯¯ï¼

åŠ é”çš„ä¿æŠ¤ï¼š
æ—¶åˆ»T1: äº‹åŠ¡1è¯»å–ä½™é¢ 1000å…ƒ (åŠ æ’ä»–é”)
æ—¶åˆ»T2: äº‹åŠ¡2ç­‰å¾…é”é‡Šæ”¾...
æ—¶åˆ»T3: äº‹åŠ¡1è½¬å‡º500å…ƒï¼Œä½™é¢=500å…ƒï¼Œé‡Šæ”¾é”
æ—¶åˆ»T4: äº‹åŠ¡2è¯»å–ä½™é¢ 500å…ƒï¼Œè½¬å‡ºæ“ä½œå¤±è´¥ âœ…æ­£ç¡®ï¼
```

---

## 4. ğŸ”— é”ä¸ç‰ˆæœ¬å…¼å®¹æ€§åŸç†


### 4.1 å…¼å®¹æ€§çŸ©é˜µ


**é”ç±»å‹ä¸MVCCç‰ˆæœ¬çš„å…¼å®¹å…³ç³»**ï¼š

```
å…¼å®¹æ€§çŸ©é˜µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    é”ç±»å‹    â”‚ å¿«ç…§è¯»   â”‚ å½“å‰è¯»S  â”‚ å½“å‰è¯»X  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— é”(å¿«ç…§è¯») â”‚   âœ…    â”‚   âœ…    â”‚   âœ…    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…±äº«é”(S)   â”‚   âœ…    â”‚   âœ…    â”‚   âŒ    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ’ä»–é”(X)   â”‚   âœ…    â”‚   âŒ    â”‚   âŒ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç†è§£ï¼šå¿«ç…§è¯»ä¸ä»»ä½•é”éƒ½å…¼å®¹ï¼
```

### 4.2 ç‰ˆæœ¬ä¸é”çš„åè°ƒæœºåˆ¶


**ç‰ˆæœ¬é€‰æ‹©ä¸é”çŠ¶æ€çš„å…³ç³»**ï¼š

```
æ•°æ®è¡ŒçŠ¶æ€ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Row ID: 1                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰ç‰ˆæœ¬ï¼šv4 [name="Alice", trx_id=104] â”‚
â”‚ é”çŠ¶æ€ï¼šX-Lock by Transaction 105       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç‰ˆæœ¬é“¾ï¼š                                 â”‚
â”‚ v4 â†’ v3 â†’ v2 â†’ v1                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸åŒè¯»å–æ–¹å¼çš„ç»“æœï¼š
â€¢ å¿«ç…§è¯»(trx_100)ï¼šè¯»å–v2ç‰ˆæœ¬ï¼Œæ— è§†é”çŠ¶æ€
â€¢ å½“å‰è¯»(trx_106)ï¼šç­‰å¾…105é‡Šæ”¾é”ï¼Œè¯»å–v4ç‰ˆæœ¬
â€¢ å½“å‰è¯»(trx_105)ï¼šç›´æ¥è¯»å–v4ç‰ˆæœ¬ï¼ˆè‡ªå·±çš„é”ï¼‰
```

### 4.3 åè°ƒç®—æ³•å®ç°


```java
class LockVersionCoordinator {
    ReadResult coordinateRead(RowKey key, ReadType readType, 
                            TransactionContext ctx) {
        if (readType == ReadType.SNAPSHOT) {
            // å¿«ç…§è¯»ï¼šç›´æ¥èµ°MVCCç‰ˆæœ¬é€‰æ‹©
            return mvccRead(key, ctx.getReadView());
        } else {
            // å½“å‰è¯»ï¼šéœ€è¦è€ƒè™‘é”çŠ¶æ€
            return currentRead(key, ctx);
        }
    }
    
    ReadResult currentRead(RowKey key, TransactionContext ctx) {
        // 1. æ£€æŸ¥é”å†²çª
        LockInfo lockInfo = lockManager.getLockInfo(key);
        if (hasLockConflict(lockInfo, ctx)) {
            waitForLockOrTimeout(key, ctx);
        }
        
        // 2. è·å–æœ€æ–°ç‰ˆæœ¬
        DataVersion version = versionManager.getLatestVersion(key);
        
        // 3. åŠ é”ä¿æŠ¤
        lockManager.acquireLock(key, ctx.getLockType());
        
        return new ReadResult(version.getData());
    }
}
```

---

## 5. âš™ï¸ å¹¶å‘æ§åˆ¶åè°ƒæœºåˆ¶


### 5.1 åè°ƒä¸­å¿ƒçš„ä½œç”¨


**MVCCä¸é”çš„åè°ƒä¸­å¿ƒ**å°±åƒ**äº¤é€šç®¡åˆ¶ä¸­å¿ƒ**ï¼š

```
åè°ƒä¸­å¿ƒèŒè´£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰ˆæœ¬ç®¡ç†å™¨     â”‚    â”‚   é”ç®¡ç†å™¨       â”‚
â”‚ â€¢ ç‰ˆæœ¬é“¾ç»´æŠ¤     â”‚    â”‚ â€¢ é”çŠ¶æ€è·Ÿè¸ª     â”‚
â”‚ â€¢ å¯è§æ€§åˆ¤æ–­     â”‚    â”‚ â€¢ æ­»é”æ£€æµ‹       â”‚
â”‚ â€¢ ç‰ˆæœ¬æ¸…ç†       â”‚    â”‚ â€¢ é”å‡çº§ç®¡ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   åè°ƒè°ƒåº¦å™¨     â”‚
        â”‚ â€¢ è¯»å†™è·¯ç”±       â”‚
        â”‚ â€¢ å†²çªä»²è£       â”‚
        â”‚ â€¢ æ€§èƒ½ç›‘æ§       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¹¶å‘åœºæ™¯çš„åè°ƒç­–ç•¥


**è¯»å¤šå†™å°‘åœºæ™¯**ï¼š

```
ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ 90%æ“ä½œèµ°å¿«ç…§è¯»è·¯å¾„ï¼ˆæ— é”ï¼‰
â€¢ 10%æ“ä½œèµ°å½“å‰è¯»è·¯å¾„ï¼ˆåŠ é”ï¼‰
â€¢ ç‰ˆæœ¬æ¸…ç†é¢‘ç‡é€‚ä¸­
â€¢ é”ç²’åº¦æœ€å°åŒ–

æ€§èƒ½è¡¨ç°ï¼š
å¹¶å‘è¯»å–ï¼š1000 QPS â†’ 10000 QPS (10å€æå‡)
å†™å…¥å»¶è¿Ÿï¼š50ms â†’ 80ms (ç•¥å¾®å¢åŠ )
æ€»ä½“ååï¼šæå‡700%
```

**è¯»å†™å‡è¡¡åœºæ™¯**ï¼š

```
å¹³è¡¡ç­–ç•¥ï¼š
â€¢ 50%å¿«ç…§è¯» + 50%å½“å‰è¯»
â€¢ é”è¶…æ—¶æœºåˆ¶é˜²æ­¢é•¿æ—¶é—´é˜»å¡
â€¢ ç§¯æçš„ç‰ˆæœ¬æ¸…ç†
â€¢ æ­»é”å¿«é€Ÿæ£€æµ‹

æ€§èƒ½è¡¨ç°ï¼š
å¹¶å‘å¤„ç†ï¼š500 TPS â†’ 1200 TPS
å¹³å‡å»¶è¿Ÿï¼š100ms â†’ 120ms
æ­»é”ç‡ï¼šä»5%é™åˆ°1%
```

### 5.3 åè°ƒç®—æ³•æ ¸å¿ƒé€»è¾‘


```java
class ConcurrencyCoordinator {
    // æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®æ“ä½œç±»å‹é€‰æ‹©æœ€ä¼˜è·¯å¾„
    ExecutionPath chooseOptimalPath(SQLStatement sql, 
                                  WorkloadPattern workload) {
        if (sql.isReadOnly() && !sql.requiresCurrentData()) {
            return ExecutionPath.SNAPSHOT_READ;
        }
        
        if (workload.getReadWriteRatio() > 0.8) {
            // è¯»å¤šå†™å°‘ï¼Œä¼˜å…ˆæ— é”è·¯å¾„
            return ExecutionPath.MVCC_OPTIMIZED;
        }
        
        return ExecutionPath.LOCKED_READ;
    }
    
    // å†²çªè§£å†³ï¼šåŠ¨æ€è°ƒæ•´å¹¶å‘ç­–ç•¥
    void resolveConflict(ConflictEvent conflict) {
        switch (conflict.getType()) {
            case LOCK_TIMEOUT:
                // å°è¯•é™çº§ä¸ºå¿«ç…§è¯»
                tryDowngradeToSnapshot(conflict);
                break;
            case VERSION_TOO_OLD:
                // è§¦å‘ç‰ˆæœ¬æ¸…ç†
                scheduleVersionCleanup(conflict.getRowKey());
                break;
        }
    }
}
```

---

## 6. âš”ï¸ è¯»å†™å†²çªå¤„ç†ç­–ç•¥


### 6.1 å†²çªç±»å‹åˆ†æ


**ä¸»è¦çš„è¯»å†™å†²çªåœºæ™¯**ï¼š

```
ç±»å‹1ï¼šå†™é˜»å¡å½“å‰è¯»
åœºæ™¯ï¼šäº‹åŠ¡Aæ­£åœ¨UPDATEï¼Œäº‹åŠ¡Bæ‰§è¡ŒSELECT FOR UPDATE
å¤„ç†ï¼šBç­‰å¾…Aå®Œæˆæˆ–è¶…æ—¶

ç±»å‹2ï¼šé•¿äº‹åŠ¡é˜»å¡å†™å…¥  
åœºæ™¯ï¼šäº‹åŠ¡Aé•¿æ—¶é—´æŒæœ‰é”ï¼Œäº‹åŠ¡Bç­‰å¾…å†™å…¥
å¤„ç†ï¼šé”è¶…æ—¶ + äº‹åŠ¡ä¼˜å…ˆçº§

ç±»å‹3ï¼šç‰ˆæœ¬ç§¯å‹
åœºæ™¯ï¼šå¤§é‡å¿«ç…§è¯»ä½¿ç”¨è€ç‰ˆæœ¬ï¼Œé˜»æ­¢ç‰ˆæœ¬æ¸…ç†
å¤„ç†ï¼šå¼ºåˆ¶æ¸…ç† + è¯»å–é‡è¯•

ç±»å‹4ï¼šå¹»è¯»é—®é¢˜
åœºæ™¯ï¼šå¿«ç…§è¯»çœ‹ä¸åˆ°æ–°æ’å…¥çš„æ•°æ®
å¤„ç†ï¼šèŒƒå›´é” + é—´éš™é”
```

### 6.2 å†²çªå¤„ç†ç­–ç•¥


**ç­‰å¾…ç­–ç•¥**ï¼š

```java
class ConflictWaitStrategy {
    boolean waitForConflictResolution(ConflictContext ctx) {
        long waitTime = 0;
        long maxWait = getMaxWaitTime(ctx.getPriority());
        
        while (waitTime < maxWait) {
            if (isConflictResolved(ctx)) {
                return true; // å†²çªè§£é™¤
            }
            
            // æŒ‡æ•°é€€é¿ç­‰å¾…
            long sleepTime = Math.min(1000, 100 * (1 << (waitTime/1000)));
            Thread.sleep(sleepTime);
            waitTime += sleepTime;
            
            // æ£€æŸ¥æ­»é”
            if (deadlockDetector.isDeadlock(ctx)) {
                throw new DeadlockException();
            }
        }
        
        return false; // è¶…æ—¶
    }
}
```

**ä¼˜å…ˆçº§ç­–ç•¥**ï¼š

```
äº‹åŠ¡ä¼˜å…ˆçº§è§„åˆ™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   äº‹åŠ¡ç±»å‹       â”‚ ä¼˜å…ˆçº§   â”‚   å¤„ç†ç­–ç•¥   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åœ¨çº¿ä¸šåŠ¡äº‹åŠ¡     â”‚   é«˜     â”‚ ä¼˜å…ˆè·å¾—é”   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰¹å¤„ç†äº‹åŠ¡       â”‚   ä¸­     â”‚ é€‚å½“ç­‰å¾…     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†ææŸ¥è¯¢äº‹åŠ¡     â”‚   ä½     â”‚ å¿«ç…§è¯»ä¸ºä¸»   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å†²çªé¿å…æœºåˆ¶


**é¢„é˜²æ€§ç­–ç•¥**ï¼š

```java
class ConflictPrevention {
    // æ™ºèƒ½é”é™çº§
    void attemptLockDowngrade(Transaction txn) {
        if (txn.canUseSnapshotRead()) {
            // å°†å½“å‰è¯»é™çº§ä¸ºå¿«ç…§è¯»
            txn.downgradeToSnapshot();
            lockManager.releaseLocks(txn.getId());
        }
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–
    void optimizeBatchOperations(BatchOperation batch) {
        // å°†å¤šä¸ªå°é”åˆå¹¶ä¸ºèŒƒå›´é”
        List<RangeLock> rangeLocks = mergeLocks(batch.getLocks());
        
        // é¢„æ’åºå‡å°‘æ­»é”æ¦‚ç‡
        rangeLocks.sort(Comparator.comparing(RangeLock::getStartKey));
        
        lockManager.acquireRangeLocks(rangeLocks);
    }
}
```

---

## 7. ğŸ”„ æ··åˆå¹¶å‘æ§åˆ¶å®ç°


### 7.1 æ··åˆæ§åˆ¶æ¶æ„


**MVCC+é”çš„åˆ†å±‚æ¶æ„**ï¼š

```
åº”ç”¨å±‚è¯·æ±‚
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SQLè§£æå±‚      â”‚ â† è¯†åˆ«è¯»å†™ç±»å‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¹¶å‘æ§åˆ¶è·¯ç”±    â”‚ â† é€‰æ‹©æ§åˆ¶ç­–ç•¥  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚ MVCCå¼•æ“  â”‚  â”‚ â”‚  é”ç®¡ç†å™¨   â”‚
â”‚  â”‚â€¢ ç‰ˆæœ¬é“¾   â”‚  â”‚ â”‚ â€¢ è¡Œé”      â”‚
â”‚  â”‚â€¢ è¯»è§†å›¾   â”‚  â”‚ â”‚ â€¢ é—´éš™é”    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å­˜å‚¨å¼•æ“å±‚     â”‚ â† ç»Ÿä¸€æ•°æ®è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ··åˆæ§åˆ¶å†³ç­–ç®—æ³•


```java
class HybridConcurrencyController {
    ConcurrencyStrategy selectStrategy(SQLContext context) {
        // åˆ†æSQLç±»å‹å’Œæ•°æ®è®¿é—®æ¨¡å¼
        AccessPattern pattern = analyzeAccessPattern(context.getSql());
        
        // æ ¹æ®ä¸šåŠ¡ç‰¹å¾é€‰æ‹©ç­–ç•¥
        if (pattern.isReadOnly() && pattern.allowsStaleRead()) {
            return ConcurrencyStrategy.MVCC_SNAPSHOT;
        }
        
        if (pattern.requiresConsistency()) {
            return ConcurrencyStrategy.LOCK_BASED;
        }
        
        if (pattern.isHighConcurrency()) {
            return ConcurrencyStrategy.HYBRID_OPTIMISTIC;
        }
        
        return ConcurrencyStrategy.HYBRID_BALANCED;
    }
    
    // æ‰§è¡Œæ··åˆå¹¶å‘æ§åˆ¶
    Result executeConcurrencyControl(SQLContext context) {
        ConcurrencyStrategy strategy = selectStrategy(context);
        
        switch (strategy) {
            case MVCC_SNAPSHOT:
                return mvccEngine.executeSnapshot(context);
            case LOCK_BASED:
                return lockManager.executeWithLocks(context);
            case HYBRID_OPTIMISTIC:
                return executeOptimisticHybrid(context);
            case HYBRID_BALANCED:
                return executeBalancedHybrid(context);
        }
    }
}
```

### 7.3 æ··åˆæ§åˆ¶çš„å®é™…æ¡ˆä¾‹


**ç”µå•†è®¢å•ç³»ç»Ÿ**ï¼š

```sql
-- åœºæ™¯1ï¼šå•†å“æµè§ˆï¼ˆå¿«ç…§è¯»ï¼‰
SELECT name, price, description 
FROM products 
WHERE category = 'electronics';
-- ç­–ç•¥ï¼šMVCCå¿«ç…§è¯»ï¼Œæ— é”é«˜å¹¶å‘

-- åœºæ™¯2ï¼šåº“å­˜æŸ¥è¯¢ï¼ˆå½“å‰è¯»ï¼‰  
SELECT stock_count 
FROM inventory 
WHERE product_id = 12345 
FOR UPDATE;
-- ç­–ç•¥ï¼šå½“å‰è¯»åŠ é”ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®æ€§

-- åœºæ™¯3ï¼šè®¢å•åˆ›å»ºï¼ˆæ··åˆæ§åˆ¶ï¼‰
BEGIN;
-- è¯»å–å•†å“ä¿¡æ¯ï¼ˆå¿«ç…§è¯»ï¼‰
SELECT price FROM products WHERE id = 12345;
-- æ£€æŸ¥åº“å­˜ï¼ˆå½“å‰è¯»+é”ï¼‰
SELECT stock_count FROM inventory WHERE product_id = 12345 FOR UPDATE;
-- åˆ›å»ºè®¢å•ï¼ˆå†™æ“ä½œ+é”ï¼‰
INSERT INTO orders (product_id, quantity, total) VALUES (12345, 2, 199.8);
-- æ›´æ–°åº“å­˜ï¼ˆå†™æ“ä½œ+é”ï¼‰  
UPDATE inventory SET stock_count = stock_count - 2 WHERE product_id = 12345;
COMMIT;
```

---

## 8. ğŸš€ åä½œæœºåˆ¶æ€§èƒ½ä¼˜åŒ–


### 8.1 ç‰ˆæœ¬é“¾ä¼˜åŒ–


**ç‰ˆæœ¬é“¾é•¿åº¦æ§åˆ¶**ï¼š

```java
class VersionChainOptimizer {
    // æ™ºèƒ½ç‰ˆæœ¬æ¸…ç†
    void optimizeVersionChain(RowKey rowKey) {
        VersionChain chain = getVersionChain(rowKey);
        
        // è®¡ç®—æ¸…ç†é˜ˆå€¼
        int maxVersions = calculateMaxVersions(rowKey);
        
        if (chain.length() > maxVersions) {
            // æ‰¾åˆ°æœ€è€çš„æ´»è·ƒäº‹åŠ¡
            long oldestActiveTrx = getOldestActiveTransaction();
            
            // æ¸…ç†ä¸å†éœ€è¦çš„ç‰ˆæœ¬
            chain.purgeVersionsOlderThan(oldestActiveTrx);
        }
    }
    
    int calculateMaxVersions(RowKey rowKey) {
        // æ ¹æ®è®¿é—®é¢‘ç‡åŠ¨æ€è°ƒæ•´
        AccessFrequency freq = getAccessFrequency(rowKey);
        
        if (freq.isHotData()) {
            return 10; // çƒ­ç‚¹æ•°æ®ä¿ç•™æ›´å¤šç‰ˆæœ¬
        } else if (freq.isColdData()) {
            return 3;  // å†·æ•°æ®ä¿ç•™è¾ƒå°‘ç‰ˆæœ¬
        }
        
        return 5; // é»˜è®¤ç‰ˆæœ¬æ•°
    }
}
```

### 8.2 é”ä¼˜åŒ–ç­–ç•¥


**é”ç²’åº¦è‡ªé€‚åº”è°ƒæ•´**ï¼š

```
é”ç²’åº¦ä¼˜åŒ–è§„åˆ™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¿é—®æ¨¡å¼       â”‚   é”ç²’åº¦     â”‚   ä¼˜åŒ–ç­–ç•¥   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é«˜å¹¶å‘ç‚¹æŸ¥è¯¢     â”‚   è¡Œçº§é”     â”‚ å¿«é€Ÿè·å–é‡Šæ”¾ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èŒƒå›´æ‰«æ        â”‚   é¡µçº§é”     â”‚ å‡å°‘é”æ•°é‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰¹é‡æ“ä½œ        â”‚   è¡¨çº§é”     â”‚ é¿å…é”å‡çº§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
class LockGranularityOptimizer {
    LockGranularity chooseLockGranularity(OperationContext ctx) {
        int affectedRows = ctx.getEstimatedRowCount();
        double tableSize = ctx.getTableSize();
        
        // å½±å“è¡Œæ•°å°‘äº100ä¸”è¡¨è¾ƒå¤§ï¼Œä½¿ç”¨è¡Œé”
        if (affectedRows < 100 && tableSize > 10000) {
            return LockGranularity.ROW_LEVEL;
        }
        
        // å½±å“è¶…è¿‡20%çš„æ•°æ®ï¼Œä½¿ç”¨è¡¨é”
        if (affectedRows / tableSize > 0.2) {
            return LockGranularity.TABLE_LEVEL;
        }
        
        return LockGranularity.PAGE_LEVEL;
    }
}
```

### 8.3 ç¼“å­˜æœºåˆ¶ä¼˜åŒ–


**è¯»è§†å›¾ç¼“å­˜**ï¼š

```java
class ReadViewCache {
    private final ConcurrentHashMap<Long, ReadView> cache = 
        new ConcurrentHashMap<>();
    
    ReadView getReadView(long transactionId) {
        return cache.computeIfAbsent(transactionId, this::createReadView);
    }
    
    ReadView createReadView(long transactionId) {
        // è·å–å½“å‰æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼ˆå¼€é”€è¾ƒå¤§ï¼‰
        List<Long> activeTrxIds = getActiveTransactions();
        
        return new ReadView(transactionId, activeTrxIds, 
                           System.currentTimeMillis());
    }
    
    // å®šæœŸæ¸…ç†è¿‡æœŸçš„è¯»è§†å›¾
    void cleanupExpiredViews() {
        long now = System.currentTimeMillis();
        cache.entrySet().removeIf(entry -> 
            now - entry.getValue().getCreateTime() > READ_VIEW_TTL);
    }
}
```

---

## 9. ğŸ”§ åä½œæ•…éšœå¤„ç†


### 9.1 å¸¸è§æ•…éšœç±»å‹


**æ­»é”æ£€æµ‹ä¸å¤„ç†**ï¼š

```
æ­»é”åœºæ™¯ï¼š
äº‹åŠ¡Aï¼šé”å®šRow1 â†’ ç­‰å¾…Row2
äº‹åŠ¡Bï¼šé”å®šRow2 â†’ ç­‰å¾…Row1

æ£€æµ‹ç®—æ³•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç­‰å¾…    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹åŠ¡A   â”‚ --------â†’ â”‚ äº‹åŠ¡B   â”‚
â”‚ (Row1)  â”‚           â”‚ (Row2)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€ ç­‰å¾… â†-------â”˜
     å½¢æˆç¯è·¯ = æ­»é”ï¼
```

```java
class DeadlockDetector {
    boolean detectDeadlock(WaitForGraph graph) {
        // ä½¿ç”¨DFSæ£€æµ‹ç¯è·¯
        Set<Long> visited = new HashSet<>();
        Set<Long> recursionStack = new HashSet<>();
        
        for (Long txnId : graph.getAllTransactions()) {
            if (hasCycle(graph, txnId, visited, recursionStack)) {
                return true;
            }
        }
        return false;
    }
    
    void resolveDeadlock(List<Long> deadlockTxns) {
        // é€‰æ‹©ä»£ä»·æœ€å°çš„äº‹åŠ¡è¿›è¡Œå›æ»š
        Long victimTxn = selectVictim(deadlockTxns);
        
        // å›æ»šå—å®³è€…äº‹åŠ¡
        transactionManager.rollback(victimTxn);
        
        // é€šçŸ¥å…¶ä»–äº‹åŠ¡ç»§ç»­æ‰§è¡Œ
        notifyWaitingTransactions(deadlockTxns, victimTxn);
    }
}
```

### 9.2 ç‰ˆæœ¬é“¾å¼‚å¸¸å¤„ç†


**ç‰ˆæœ¬é“¾æŸåä¿®å¤**ï¼š

```java
class VersionChainRecovery {
    void repairVersionChain(RowKey rowKey) {
        try {
            VersionChain chain = loadVersionChain(rowKey);
            
            // æ£€æŸ¥ç‰ˆæœ¬é“¾å®Œæ•´æ€§
            validateVersionChain(chain);
            
        } catch (VersionChainCorruptedException e) {
            // ä»å¤‡ä»½é‡å»ºç‰ˆæœ¬é“¾
            rebuildVersionChain(rowKey);
        }
    }
    
    void validateVersionChain(VersionChain chain) {
        DataVersion prev = null;
        
        for (DataVersion version : chain.getVersions()) {
            // æ£€æŸ¥ç‰ˆæœ¬å·é€’å¢
            if (prev != null && version.getVersionId() <= prev.getVersionId()) {
                throw new VersionChainCorruptedException("ç‰ˆæœ¬å·ä¸é€’å¢");
            }
            
            // æ£€æŸ¥äº‹åŠ¡IDæœ‰æ•ˆæ€§
            if (!isValidTransactionId(version.getTransactionId())) {
                throw new VersionChainCorruptedException("æ— æ•ˆäº‹åŠ¡ID");
            }
            
            prev = version;
        }
    }
}
```

### 9.3 æ€§èƒ½å¼‚å¸¸å¤„ç†


**é”ç­‰å¾…è¶…æ—¶å¤„ç†**ï¼š

```java
class LockTimeoutHandler {
    void handleLockTimeout(LockWaitContext context) {
        // è®°å½•è¶…æ—¶äº‹ä»¶
        logLockTimeout(context);
        
        // å°è¯•é™çº§ç­–ç•¥
        if (canDowngradeToSnapshot(context)) {
            // é™çº§ä¸ºå¿«ç…§è¯»
            executeSnapshotRead(context);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ­»é”
        if (isDeadlockSuspected(context)) {
            triggerDeadlockDetection();
        }
        
        // æŠ›å‡ºè¶…æ—¶å¼‚å¸¸
        throw new LockTimeoutException(
            "Lock wait timeout: " + context.getWaitTime() + "ms");
    }
    
    boolean canDowngradeToSnapshot(LockWaitContext context) {
        return context.getIsolationLevel() != IsolationLevel.SERIALIZABLE
            && context.allowsStaleRead();
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åä½œæœ¬è´¨ï¼šMVCCè´Ÿè´£è¯»æ€§èƒ½ï¼Œé”æœºåˆ¶ä¿è¯å†™ä¸€è‡´æ€§
ğŸ”¸ åŒè½¨åˆ¶ï¼šå¿«ç…§è¯»èµ°MVCCè·¯å¾„ï¼Œå½“å‰è¯»èµ°é”è·¯å¾„
ğŸ”¸ å…¼å®¹æ€§ï¼šå¿«ç…§è¯»ä¸ä»»ä½•é”éƒ½å…¼å®¹ï¼Œæ˜¯é«˜å¹¶å‘çš„å…³é”®
ğŸ”¸ ç‰ˆæœ¬é€‰æ‹©ï¼šåŸºäºäº‹åŠ¡IDå’Œæ´»è·ƒäº‹åŠ¡åˆ—è¡¨åˆ¤æ–­ç‰ˆæœ¬å¯è§æ€§
ğŸ”¸ æ··åˆæ§åˆ¶ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯åŠ¨æ€é€‰æ‹©æœ€ä¼˜å¹¶å‘ç­–ç•¥
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦åä½œæœºåˆ¶**
```
å•çº¯MVCCé—®é¢˜ï¼š
â€¢ å†™å†™å†²çªå¤„ç†å¤æ‚
â€¢ æ— æ³•è§£å†³å¹»è¯»
â€¢ ç‰ˆæœ¬ç§¯å‹å½±å“æ€§èƒ½

å•çº¯é”é—®é¢˜ï¼š
â€¢ è¯»å†™äº’æ–¥æ€§èƒ½å·®
â€¢ æ­»é”é£é™©é«˜
â€¢ é•¿äº‹åŠ¡é˜»å¡ä¸¥é‡

åä½œä¼˜åŠ¿ï¼š
â€¢ è¯»æ“ä½œå‡ ä¹æ— é”ï¼Œé«˜å¹¶å‘
â€¢ å†™æ“ä½œç²¾ç¡®åŠ é”ï¼Œå¼ºä¸€è‡´æ€§
â€¢ çµæ´»çš„æ€§èƒ½è°ƒä¼˜ç©ºé—´
```

**ğŸ”¹ åä½œæœºåˆ¶çš„æ€§èƒ½å½±å“**
```
è¯»å¤šå†™å°‘åœºæ™¯ï¼š
â€¢ æ€§èƒ½æå‡ï¼š5-10å€
â€¢ å¹¶å‘èƒ½åŠ›ï¼šæ˜¾è‘—å¢å¼º
â€¢ èµ„æºæ¶ˆè€—ï¼šç‰ˆæœ¬å­˜å‚¨å¼€é”€

è¯»å†™å¹³è¡¡åœºæ™¯ï¼š  
â€¢ æ€§èƒ½æå‡ï¼š2-3å€
â€¢ å¤æ‚åº¦ï¼šç®¡ç†æˆæœ¬å¢åŠ 
â€¢ è°ƒä¼˜è¦æ±‚ï¼šæ›´ç²¾ç»†çš„å‚æ•°è®¾ç½®
```

**ğŸ”¹ æ•…éšœå¤„ç†çš„é‡è¦æ€§**
```
å¸¸è§é—®é¢˜ï¼š
â€¢ æ­»é”æ£€æµ‹å’Œè§£å†³
â€¢ ç‰ˆæœ¬é“¾ç»´æŠ¤
â€¢ é”ç­‰å¾…è¶…æ—¶

å¤„ç†åŸåˆ™ï¼š
â€¢ å¿«é€Ÿæ£€æµ‹
â€¢ æ™ºèƒ½é™çº§
â€¢ è‡ªåŠ¨æ¢å¤
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é€‚ç”¨åœºæ™¯è¯„ä¼°**ï¼š
```
âœ… æ¨èä½¿ç”¨åœºæ™¯ï¼š
â€¢ è¯»å¤šå†™å°‘çš„OLTPç³»ç»Ÿ
â€¢ é«˜å¹¶å‘Webåº”ç”¨
â€¢ å®æ—¶åˆ†æç³»ç»Ÿ
â€¢ æ··åˆå·¥ä½œè´Ÿè½½

âŒ ä¸æ¨èåœºæ™¯ï¼š
â€¢ å¤§é‡é•¿äº‹åŠ¡çš„ç³»ç»Ÿ
â€¢ å†™å¯†é›†å‹åº”ç”¨
â€¢ å¯¹å­˜å‚¨ç©ºé—´ææ•æ„Ÿçš„ç¯å¢ƒ
â€¢ ç®€å•çš„å•ç”¨æˆ·ç³»ç»Ÿ
```

**æ€§èƒ½è°ƒä¼˜æŒ‡å¯¼**ï¼š
```
ç‰ˆæœ¬ç®¡ç†è°ƒä¼˜ï¼š
â€¢ æ ¹æ®äº‹åŠ¡æŒç»­æ—¶é—´è®¾ç½®ç‰ˆæœ¬ä¿ç•™ç­–ç•¥
â€¢ ç›‘æ§ç‰ˆæœ¬é“¾é•¿åº¦ï¼ŒåŠæ—¶æ¸…ç†
â€¢ çƒ­ç‚¹æ•°æ®é€‚å½“å¢åŠ ç‰ˆæœ¬æ•°

é”ç®¡ç†è°ƒä¼˜ï¼š
â€¢ æ ¹æ®è®¿é—®æ¨¡å¼é€‰æ‹©é”ç²’åº¦
â€¢ è®¾ç½®åˆç†çš„é”ç­‰å¾…è¶…æ—¶æ—¶é—´
â€¢ å¯ç”¨æ­»é”æ£€æµ‹å’Œè‡ªåŠ¨è§£å†³

æ··åˆç­–ç•¥è°ƒä¼˜ï¼š
â€¢ åˆ†æä¸šåŠ¡è®¿é—®æ¨¡å¼
â€¢ åŠ¨æ€è°ƒæ•´è¯»å†™è·¯å¾„é€‰æ‹©
â€¢ ç›‘æ§æ€§èƒ½æŒ‡æ ‡å¹¶ä¼˜åŒ–
```

### 10.4 æœ€ä½³å®è·µæ€»ç»“


**è®¾è®¡åŸåˆ™**ï¼š
```
1. è¯»å†™åˆ†ç¦»ï¼šæ˜ç¡®åŒºåˆ†å¿«ç…§è¯»å’Œå½“å‰è¯»
2. æœ€å°é”å®šï¼šåªåœ¨å¿…è¦æ—¶åŠ é”ï¼Œå°½æ—©é‡Šæ”¾
3. æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®SQLç±»å‹é€‰æ‹©æœ€ä¼˜æ‰§è¡Œè·¯å¾„
4. ä¸»åŠ¨ç›‘æ§ï¼šå®æ—¶ç›‘æ§æ€§èƒ½æŒ‡æ ‡å’Œå¼‚å¸¸æƒ…å†µ
5. æ¸è¿›ä¼˜åŒ–ï¼šæ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´å‚æ•°
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
```
æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ å¿«ç…§è¯»QPS vs å½“å‰è¯»QPS
â€¢ å¹³å‡é”ç­‰å¾…æ—¶é—´
â€¢ æ­»é”å‘ç”Ÿé¢‘ç‡
â€¢ ç‰ˆæœ¬é“¾å¹³å‡é•¿åº¦

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ äº‹åŠ¡å“åº”æ—¶é—´
â€¢ å¹¶å‘å¤„ç†èƒ½åŠ›
â€¢ ç³»ç»Ÿååé‡
â€¢ é”™è¯¯ç‡å’Œè¶…æ—¶ç‡
```

> **ğŸ’¡ æ ¸å¿ƒè®°å¿†**ï¼š
> MVCCä¸é”åä½œçš„ç²¾é«“åœ¨äº"è¯»å†™åˆ†ç¦»ï¼ŒæŒ‰éœ€åŠ é”"
> å¿«ç…§è¯»è¿½æ±‚æ€§èƒ½ï¼Œå½“å‰è¯»ä¿è¯ä¸€è‡´æ€§
> ä¸¤è€…é…åˆå®ç°é«˜å¹¶å‘ä¸å¼ºä¸€è‡´æ€§çš„å®Œç¾å¹³è¡¡

