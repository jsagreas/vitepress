---
title: 22ã€åƒåœ¾å›æ”¶æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [MVCCåƒåœ¾å›æ”¶æ¦‚è¿°](#1-mvccåƒåœ¾å›æ”¶æ¦‚è¿°)
2. [ç‰ˆæœ¬åƒåœ¾å›æ”¶ç®—æ³•](#2-ç‰ˆæœ¬åƒåœ¾å›æ”¶ç®—æ³•)
3. [å¼•ç”¨è®¡æ•°å›æ”¶æœºåˆ¶](#3-å¼•ç”¨è®¡æ•°å›æ”¶æœºåˆ¶)
4. [æ ‡è®°æ¸…é™¤å›æ”¶ç­–ç•¥](#4-æ ‡è®°æ¸…é™¤å›æ”¶ç­–ç•¥)
5. [åˆ†ä»£å›æ”¶ç­–ç•¥](#5-åˆ†ä»£å›æ”¶ç­–ç•¥)
6. [å¢é‡å›æ”¶æœºåˆ¶](#6-å¢é‡å›æ”¶æœºåˆ¶)
7. [å›æ”¶æ€§èƒ½ä¼˜åŒ–](#7-å›æ”¶æ€§èƒ½ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—‘ï¸ MVCCåƒåœ¾å›æ”¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MVCCåƒåœ¾å›æ”¶


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**

åœ¨MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ç³»ç»Ÿä¸­ï¼Œæ•°æ®çš„æ¯æ¬¡ä¿®æ”¹éƒ½ä¼šäº§ç”Ÿæ–°ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯ç›´æ¥è¦†ç›–æ—§æ•°æ®ã€‚è¿™å°±åƒæ˜¯æ–‡æ¡£çš„ç‰ˆæœ¬å†å² - æ¯æ¬¡ç¼–è¾‘éƒ½ä¿å­˜ä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚

```
ğŸŒ° ç”Ÿæ´»ä¾‹å­ï¼š
æƒ³è±¡ä½ çš„æ‰‹æœºç…§ç‰‡ç›¸å†Œï¼š
- åŸå›¾ï¼šversion_1
- åŠ æ»¤é•œï¼šversion_2  
- è°ƒäº®åº¦ï¼šversion_3
æ—¶é—´ä¹…äº†ï¼Œæ—§ç‰ˆæœ¬æ²¡äººçœ‹äº†ï¼Œå°±éœ€è¦æ¸…ç†è…¾ç©ºé—´
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶**

```
é—®é¢˜äº§ç”Ÿè¿‡ç¨‹ï¼š
ä¿®æ”¹æ“ä½œ â†’ äº§ç”Ÿæ–°ç‰ˆæœ¬ â†’ æ—§ç‰ˆæœ¬ç´¯ç§¯ â†’ å­˜å‚¨ç©ºé—´è†¨èƒ€

å…·ä½“è¡¨ç°ï¼š
â€¢ ç£ç›˜ç©ºé—´ä¸æ–­å¢é•¿
â€¢ æŸ¥è¯¢æ€§èƒ½é€æ¸ä¸‹é™  
â€¢ å†…å­˜ä½¿ç”¨é‡æ¿€å¢
â€¢ ç³»ç»Ÿå“åº”å˜æ…¢
```

### 1.2 åƒåœ¾å›æ”¶çš„å·¥ä½œåŸç†


**ğŸ”„ åŸºæœ¬å·¥ä½œæµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯†åˆ«åƒåœ¾   â”‚ â†’  â”‚  æ ‡è®°åˆ é™¤   â”‚ â†’  â”‚  å›æ”¶ç©ºé—´   â”‚
â”‚ (å“ªäº›è¦åˆ )   â”‚    â”‚ (åšå¥½æ ‡è®°)   â”‚    â”‚ (é‡Šæ”¾èµ„æº)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  è§¦å‘æ¡ä»¶  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ åƒåœ¾ç‰ˆæœ¬çš„åˆ¤æ–­æ ‡å‡†**

ç‰ˆæœ¬æ•°æ®è¢«è®¤ä¸ºæ˜¯"åƒåœ¾"éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š

1. **å¯è§æ€§æ¡ä»¶**ï¼šæ²¡æœ‰ä»»ä½•äº‹åŠ¡èƒ½çœ‹åˆ°è¿™ä¸ªç‰ˆæœ¬
2. **å®‰å…¨æ€§æ¡ä»¶**ï¼šç¡®ä¿åˆ é™¤åä¸å½±å“æ•°æ®ä¸€è‡´æ€§

```
ç¤ºä¾‹åœºæ™¯ï¼š
æ•°æ®è¡Œ ID=100:
version_1 (åˆ›å»ºæ—¶é—´: T1, åˆ é™¤æ—¶é—´: T3)  â† å¯èƒ½æ˜¯åƒåœ¾
version_2 (åˆ›å»ºæ—¶é—´: T3, åˆ é™¤æ—¶é—´: T5)  â† å½“å‰æ´»è·ƒç‰ˆæœ¬
version_3 (åˆ›å»ºæ—¶é—´: T5, åˆ é™¤æ—¶é—´: âˆ)   â† æœ€æ–°ç‰ˆæœ¬

å¦‚æœæ‰€æœ‰è¿è¡Œä¸­çš„äº‹åŠ¡æ—¶é—´éƒ½ > T3ï¼Œé‚£ä¹ˆ version_1 å°±æ˜¯åƒåœ¾
```

### 1.3 åƒåœ¾å›æ”¶çš„æŒ‘æˆ˜


**âš ï¸ ä¸»è¦æŠ€æœ¯æŒ‘æˆ˜**

```
æ€§èƒ½æŒ‘æˆ˜ï¼š
â€¢ å›æ”¶è¿‡ç¨‹ä¸èƒ½é˜»å¡æ­£å¸¸ä¸šåŠ¡
â€¢ éœ€è¦å¹³è¡¡å›æ”¶é¢‘ç‡å’Œç³»ç»Ÿè´Ÿè½½
â€¢ å¤§æ•°æ®é‡ä¸‹çš„æ‰«ææ•ˆç‡é—®é¢˜

å‡†ç¡®æ€§æŒ‘æˆ˜ï¼š
â€¢ è¯¯åˆ æ´»è·ƒç‰ˆæœ¬ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±
â€¢ éœ€è¦ç²¾ç¡®åˆ¤æ–­ç‰ˆæœ¬çš„å¯è§æ€§
â€¢ äº‹åŠ¡å¹¶å‘è®¿é—®çš„å¤æ‚æ€§

ä¸€è‡´æ€§æŒ‘æˆ˜ï¼š
â€¢ å›æ”¶è¿‡ç¨‹ä¸­ä¿æŒæ•°æ®ä¸€è‡´æ€§
â€¢ é¿å…è¯»å†™å†²çª
â€¢ ç¡®ä¿äº‹åŠ¡éš”ç¦»çº§åˆ«
```

---

## 2. ğŸ”„ ç‰ˆæœ¬åƒåœ¾å›æ”¶ç®—æ³•


### 2.1 åŸºäºæ—¶é—´æˆ³çš„å›æ”¶ç®—æ³•


**â° ç®—æ³•æ ¸å¿ƒæ€æƒ³**

é€šè¿‡æ¯”è¾ƒç‰ˆæœ¬çš„æ—¶é—´æˆ³å’Œå½“å‰æ´»è·ƒäº‹åŠ¡çš„æ—¶é—´èŒƒå›´ï¼Œç¡®å®šå“ªäº›ç‰ˆæœ¬å¯ä»¥å®‰å…¨åˆ é™¤ã€‚

```
æ—¶é—´è½´ç¤ºæ„ï¼š
T1    T2    T3    T4    T5    T6   (æ—¶é—´)
â”‚     â”‚     â”‚     â”‚     â”‚     â”‚
v1   v2    v3   (T4)  v4    v5   (ç‰ˆæœ¬åˆ›å»ºæ—¶é—´)
      â””â”€åˆ é™¤â”€â”˜          ^
                    å½“å‰æœ€è€äº‹åŠ¡

åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœç‰ˆæœ¬åˆ é™¤æ—¶é—´ < æœ€è€æ´»è·ƒäº‹åŠ¡æ—¶é—´ï¼Œåˆ™å¯å›æ”¶
```

**ğŸ’» ç®€åŒ–ç®—æ³•å®ç°**

```java
public class TimestampGC {
    
    // è·å–å¯å›æ”¶ç‰ˆæœ¬
    public List<Version> getGarbageVersions() {
        long oldestActiveTransaction = getOldestActiveTransactionTime();
        List<Version> garbage = new ArrayList<>();
        
        for (Version version : allVersions) {
            // ç‰ˆæœ¬å·²è¢«åˆ é™¤ ä¸” åˆ é™¤æ—¶é—´æ—©äºæœ€è€äº‹åŠ¡
            if (version.isDeleted() && 
                version.getDeleteTime() < oldestActiveTransaction) {
                garbage.add(version);
            }
        }
        
        return garbage;
    }
    
    // æ‰§è¡Œå›æ”¶
    public void performGC() {
        List<Version> garbageVersions = getGarbageVersions();
        
        for (Version version : garbageVersions) {
            // ç‰©ç†åˆ é™¤ç‰ˆæœ¬æ•°æ®
            physicalDelete(version);
            // æ›´æ–°ç´¢å¼•
            updateIndexes(version);
        }
    }
}
```

### 2.2 åŸºäºå¯è§æ€§çš„å›æ”¶ç®—æ³•


**ğŸ‘ï¸ å¯è§æ€§åˆ¤æ–­æœºåˆ¶**

è¿™ç§ç®—æ³•æ›´ç²¾ç¡®ï¼Œé€šè¿‡åˆ†ææ¯ä¸ªç‰ˆæœ¬å¯¹äºæ‰€æœ‰å¯èƒ½çš„äº‹åŠ¡æ˜¯å¦å¯è§æ¥å†³å®šå›æ”¶ã€‚

```
å¯è§æ€§çŸ©é˜µç¤ºä¾‹ï¼š
        äº‹åŠ¡T1  äº‹åŠ¡T2  äº‹åŠ¡T3  å¯å›æ”¶?
ç‰ˆæœ¬v1    âŒ     âŒ     âŒ     âœ… 
ç‰ˆæœ¬v2    âœ…     âŒ     âŒ     âŒ
ç‰ˆæœ¬v3    âœ…     âœ…     âœ…     âŒ

åªæœ‰å¯¹æ‰€æœ‰æ´»è·ƒäº‹åŠ¡éƒ½ä¸å¯è§çš„ç‰ˆæœ¬æ‰èƒ½å›æ”¶
```

**ğŸ” å¯è§æ€§æ£€æŸ¥ç®—æ³•**

```java
public class VisibilityGC {
    
    // æ£€æŸ¥ç‰ˆæœ¬å¯¹äº‹åŠ¡çš„å¯è§æ€§
    private boolean isVisible(Version version, Transaction txn) {
        // ç‰ˆæœ¬åˆ›å»ºæ—¶é—´ <= äº‹åŠ¡å¼€å§‹æ—¶é—´ <= ç‰ˆæœ¬åˆ é™¤æ—¶é—´
        return version.getCreateTime() <= txn.getStartTime() &&
               (version.getDeleteTime() == null || 
                txn.getStartTime() < version.getDeleteTime());
    }
    
    // è·å–å¯å›æ”¶ç‰ˆæœ¬
    public List<Version> getGarbageVersions() {
        List<Transaction> activeTransactions = getActiveTransactions();
        List<Version> garbage = new ArrayList<>();
        
        for (Version version : allVersions) {
            boolean visibleToAny = false;
            
            // æ£€æŸ¥æ˜¯å¦å¯¹ä»»ä½•æ´»è·ƒäº‹åŠ¡å¯è§
            for (Transaction txn : activeTransactions) {
                if (isVisible(version, txn)) {
                    visibleToAny = true;
                    break;
                }
            }
            
            // å¯¹æ‰€æœ‰äº‹åŠ¡éƒ½ä¸å¯è§ï¼Œå¯ä»¥å›æ”¶
            if (!visibleToAny) {
                garbage.add(version);
            }
        }
        
        return garbage;
    }
}
```

### 2.3 æ··åˆå›æ”¶ç®—æ³•


**ğŸ”€ ç®—æ³•ç»„åˆç­–ç•¥**

åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œå¾€å¾€ç»“åˆå¤šç§ç®—æ³•çš„ä¼˜åŠ¿ï¼š

```
åˆ†å±‚å›æ”¶ç­–ç•¥ï¼š
ç¬¬1å±‚ï¼šæ—¶é—´æˆ³å¿«é€Ÿè¿‡æ»¤  â† ç²—ç­›ï¼Œè¿‡æ»¤æ˜æ˜¾çš„åƒåœ¾
ç¬¬2å±‚ï¼šå¯è§æ€§ç²¾ç¡®åˆ¤æ–­  â† ç»†ç­›ï¼Œç¡®ä¿å‡†ç¡®æ€§
ç¬¬3å±‚ï¼šå®‰å…¨æ€§æœ€ç»ˆæ£€æŸ¥  â† ä¿é™©ï¼Œé˜²æ­¢è¯¯åˆ 
```

---

## 3. ğŸ”¢ å¼•ç”¨è®¡æ•°å›æ”¶æœºåˆ¶


### 3.1 å¼•ç”¨è®¡æ•°çš„åŸºæœ¬åŸç†


**ğŸ“Š è®¡æ•°æœºåˆ¶**

ä¸ºæ¯ä¸ªæ•°æ®ç‰ˆæœ¬ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œè®°å½•æœ‰å¤šå°‘ä¸ªäº‹åŠ¡æ­£åœ¨ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬ã€‚

```
ğŸŒ° å¼•ç”¨è®¡æ•°ç±»æ¯”ï¼š
å°±åƒå›¾ä¹¦é¦†çš„å€Ÿé˜…è®°å½•ï¼š
- æ¯æœ¬ä¹¦æœ‰å€Ÿé˜…è®¡æ•°
- æœ‰äººå€Ÿä¹¦ â†’ è®¡æ•°+1
- æœ‰äººè¿˜ä¹¦ â†’ è®¡æ•°-1  
- è®¡æ•°=0 â†’ å¯ä»¥ä¸‹æ¶å¤„ç†
```

**ğŸ”„ è®¡æ•°æ›´æ–°æ—¶æœº**

```
å¼•ç”¨è®¡æ•°ç”Ÿå‘½å‘¨æœŸï¼š
äº‹åŠ¡å¼€å§‹è®¿é—®ç‰ˆæœ¬ â†’ è®¡æ•°å™¨ +1
äº‹åŠ¡ç»“æŸè®¿é—®ç‰ˆæœ¬ â†’ è®¡æ•°å™¨ -1
è®¡æ•°å™¨å½’é›¶æ—¶åˆ» â†’ æ ‡è®°ä¸ºå¯å›æ”¶

ç¤ºä¾‹ï¼š
ç‰ˆæœ¬V1çš„å¼•ç”¨è®¡æ•°å˜åŒ–ï¼š
T1è®¿é—®: count=1
T2è®¿é—®: count=2  
T1ç»“æŸ: count=1
T2ç»“æŸ: count=0 â† å¯ä»¥å›æ”¶äº†
```

### 3.2 å¼•ç”¨è®¡æ•°å®ç°


**ğŸ’» å¼•ç”¨è®¡æ•°å™¨è®¾è®¡**

```java
public class ReferenceCountingGC {
    // ç‰ˆæœ¬å¼•ç”¨è®¡æ•°æ˜ å°„
    private Map<VersionId, AtomicInteger> refCounts = new ConcurrentHashMap<>();
    // å¾…å›æ”¶ç‰ˆæœ¬é˜Ÿåˆ—
    private Queue<VersionId> gcQueue = new ConcurrentLinkedQueue<>();
    
    // äº‹åŠ¡å¼€å§‹è®¿é—®ç‰ˆæœ¬
    public void addReference(VersionId versionId) {
        refCounts.computeIfAbsent(versionId, k -> new AtomicInteger(0))
                .incrementAndGet();
    }
    
    // äº‹åŠ¡ç»“æŸè®¿é—®ç‰ˆæœ¬  
    public void removeReference(VersionId versionId) {
        AtomicInteger count = refCounts.get(versionId);
        if (count != null && count.decrementAndGet() == 0) {
            // å¼•ç”¨è®¡æ•°å½’é›¶ï¼ŒåŠ å…¥å›æ”¶é˜Ÿåˆ—
            gcQueue.offer(versionId);
            refCounts.remove(versionId);
        }
    }
    
    // æ‰§è¡Œåƒåœ¾å›æ”¶
    public void performGC() {
        VersionId versionId;
        while ((versionId = gcQueue.poll()) != null) {
            // äºŒæ¬¡ç¡®è®¤ï¼šç¡®ä¿çœŸçš„æ²¡æœ‰å¼•ç”¨äº†
            if (!refCounts.containsKey(versionId)) {
                physicalDelete(versionId);
            }
        }
    }
}
```

### 3.3 å¼•ç”¨è®¡æ•°çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹åˆ†æ**

| ç‰¹ç‚¹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **å®æ—¶æ€§å¥½** | å¼•ç”¨å½’é›¶ç«‹å³å¯å›æ”¶ | å†…å­˜æ•æ„Ÿçš„ç³»ç»Ÿ |
| **å¼€é”€åˆ†æ‘Š** | å›æ”¶å·¥ä½œåˆ†æ•£è¿›è¡Œ | ä½å»¶è¿Ÿè¦æ±‚ |
| **é€»è¾‘ç®€å•** | è®¡æ•°æœºåˆ¶å®¹æ˜“ç†è§£ | ç®€å•çš„è®¿é—®æ¨¡å¼ |

**âŒ ç¼ºç‚¹åˆ†æ**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **å¾ªç¯å¼•ç”¨** | Aå¼•ç”¨Bï¼ŒBå¼•ç”¨A | å‘¨æœŸæ€§æ£€æµ‹ |
| **è®¡æ•°å¼€é”€** | æ¯æ¬¡è®¿é—®éƒ½è¦æ›´æ–° | æ‰¹é‡æ›´æ–° |
| **å¹¶å‘å¤æ‚** | å¤šçº¿ç¨‹è®¡æ•°åŒæ­¥ | åŸå­æ“ä½œ |

---

## 4. ğŸ·ï¸ æ ‡è®°æ¸…é™¤å›æ”¶ç­–ç•¥


### 4.1 æ ‡è®°æ¸…é™¤ç®—æ³•æ¦‚è¿°


**ğŸ¯ ä¸¤é˜¶æ®µå·¥ä½œæ¨¡å¼**

æ ‡è®°æ¸…é™¤ç®—æ³•åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå°±åƒå¤§æ‰«é™¤ä¸€æ ·å…ˆæ ‡è®°åƒåœ¾ï¼Œå†ç»Ÿä¸€æ¸…ç†ã€‚

```
é˜¶æ®µåˆ’åˆ†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ‡è®°é˜¶æ®µ   â”‚ â†’  â”‚  æ¸…é™¤é˜¶æ®µ   â”‚
â”‚ Mark Phase  â”‚    â”‚ Sweep Phase â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚
     â–¼                    â–¼
æ‰¾åˆ°æ‰€æœ‰åƒåœ¾        ç‰©ç†åˆ é™¤åƒåœ¾
```

**ğŸ” æ ‡è®°é˜¶æ®µå·¥ä½œåŸç†**

ä»æ´»è·ƒäº‹åŠ¡å¼€å§‹ï¼Œè¿½è¸ªæ‰€æœ‰å¯è®¿é—®çš„ç‰ˆæœ¬ï¼Œæœªè¢«æ ‡è®°çš„å°±æ˜¯åƒåœ¾ã€‚

```
æ ‡è®°è¿‡ç¨‹ç¤ºæ„ï¼š
æ´»è·ƒäº‹åŠ¡: T1, T2, T3
     â”‚
     â–¼
   å¯è®¿é—®ç‰ˆæœ¬: V1, V3, V5  â† æ ‡è®°ä¸º"æ´»è·ƒ"
   
   æ•°æ®åº“ä¸­æ‰€æœ‰ç‰ˆæœ¬: V1, V2, V3, V4, V5, V6
   å‡å»æ ‡è®°çš„ç‰ˆæœ¬: V1, V3, V5
   å‰©ä½™çš„å°±æ˜¯åƒåœ¾: V2, V4, V6  â† æ ‡è®°ä¸º"åƒåœ¾"
```

### 4.2 æ ‡è®°æ¸…é™¤å®ç°


**ğŸ”§ ç®—æ³•å®ç°æ¡†æ¶**

```java
public class MarkAndSweepGC {
    private Set<VersionId> markedVersions = new HashSet<>();
    
    // æ ‡è®°é˜¶æ®µï¼šæ‰¾åˆ°æ‰€æœ‰æ´»è·ƒç‰ˆæœ¬
    public void markPhase() {
        markedVersions.clear();
        
        // ä»æ‰€æœ‰æ´»è·ƒäº‹åŠ¡å¼€å§‹æ ‡è®°
        for (Transaction txn : getActiveTransactions()) {
            markAccessibleVersions(txn);
        }
    }
    
    // é€’å½’æ ‡è®°äº‹åŠ¡å¯è®¿é—®çš„ç‰ˆæœ¬
    private void markAccessibleVersions(Transaction txn) {
        for (VersionId versionId : getAccessibleVersions(txn)) {
            if (!markedVersions.contains(versionId)) {
                markedVersions.add(versionId);
                // é€’å½’æ ‡è®°ç›¸å…³ç‰ˆæœ¬
                markRelatedVersions(versionId);
            }
        }
    }
    
    // æ¸…é™¤é˜¶æ®µï¼šåˆ é™¤æœªæ ‡è®°çš„ç‰ˆæœ¬
    public void sweepPhase() {
        for (VersionId versionId : getAllVersions()) {
            if (!markedVersions.contains(versionId)) {
                physicalDelete(versionId);
            }
        }
    }
    
    // å®Œæ•´çš„GCå‘¨æœŸ
    public void performGC() {
        markPhase();    // æ ‡è®°æ´»è·ƒç‰ˆæœ¬
        sweepPhase();   // æ¸…é™¤åƒåœ¾ç‰ˆæœ¬
    }
}
```

### 4.3 æ ‡è®°æ¸…é™¤çš„ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯**

```
å¹¶è¡Œæ ‡è®°ï¼š
å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›è¡Œæ ‡è®°ï¼ŒåŠ é€Ÿæ ‡è®°é˜¶æ®µ
  
å¢é‡æ ‡è®°ï¼š
å°†æ ‡è®°å·¥ä½œåˆ†æ•£åˆ°å¤šä¸ªæ—¶é—´ç‰‡
  
å†™å±éšœï¼š
è®°å½•æ ‡è®°æœŸé—´çš„æ•°æ®å˜åŒ–
```

**ğŸ”„ ä¸‰è‰²æ ‡è®°ç®—æ³•**

æ›´ç²¾ç»†çš„æ ‡è®°ç­–ç•¥ï¼Œè§£å†³å¹¶å‘æ ‡è®°çš„é—®é¢˜ï¼š

```
ä¸‰è‰²åˆ†ç±»ï¼š
âšª ç™½è‰²ï¼šæœªè®¿é—®çš„å¯¹è±¡ï¼ˆæ½œåœ¨åƒåœ¾ï¼‰
ğŸ”˜ ç°è‰²ï¼šå·²è®¿é—®ä½†å­å¯¹è±¡æœªå…¨éƒ¨è®¿é—®
âš« é»‘è‰²ï¼šå·²è®¿é—®ä¸”å­å¯¹è±¡å…¨éƒ¨è®¿é—®

æ ‡è®°è§„åˆ™ï¼š
â€¢ åˆå§‹æ—¶æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²
â€¢ ä»æ ¹å¯¹è±¡å¼€å§‹ï¼Œæ ‡è®°ä¸ºç°è‰²
â€¢ è®¿é—®ç°è‰²å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œå­å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œè‡ªå·±å˜ä¸ºé»‘è‰²
â€¢ æœ€ç»ˆç™½è‰²å¯¹è±¡å°±æ˜¯åƒåœ¾
```

---

## 5. ğŸ”„ åˆ†ä»£å›æ”¶ç­–ç•¥


### 5.1 åˆ†ä»£å›æ”¶çš„æ ¸å¿ƒæ€æƒ³


**ğŸ§¬ ä¸–ä»£å‡è¯´ç†è®º**

åˆ†ä»£å›æ”¶åŸºäºä¸€ä¸ªé‡è¦è§‚å¯Ÿï¼šå¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯"æœç”Ÿå¤•æ­»"çš„ï¼Œæ–°åˆ›å»ºçš„ç‰ˆæœ¬æ›´å®¹æ˜“å˜æˆåƒåœ¾ã€‚

```
ğŸŒ° ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒæ•´ç†è¡£æŸœï¼š
æ–°ä¹°çš„è¡£æœï¼šç»å¸¸è¦æ¢æ´—  â† å¹´è½»ä»£ï¼Œå›æ”¶é¢‘ç¹
ç»å…¸æ¬¾å¼ï¼šå¾ˆå°‘åŠ¨å®ƒä»¬    â† è€å¹´ä»£ï¼Œå›æ”¶è¾ƒå°‘
å‹ç®±åº•çš„ï¼šåŸºæœ¬ä¸åŠ¨      â† æŒä¹…ä»£ï¼Œå¾ˆå°‘å›æ”¶
```

**ğŸ·ï¸ ç‰ˆæœ¬åˆ†ä»£ç­–ç•¥**

```
åˆ†ä»£æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–°ç”Ÿä»£    â”‚â†’ â”‚   æˆç†Ÿä»£    â”‚â†’ â”‚   è€å¹´ä»£    â”‚
â”‚  Young Gen  â”‚  â”‚  Mature Gen â”‚  â”‚   Old Gen   â”‚
â”‚  å›æ”¶é¢‘ç¹   â”‚  â”‚  å›æ”¶é€‚ä¸­   â”‚  â”‚  å›æ”¶è¾ƒå°‘   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     å°ä¸”å¿«           ä¸­ç­‰           å¤§ä¸”æ…¢
```

### 5.2 åˆ†ä»£å›æ”¶ç®—æ³•å®ç°


**ğŸ”§ åˆ†ä»£ç®¡ç†æœºåˆ¶**

```java
public class GenerationalGC {
    // ä¸åŒä»£çš„ç‰ˆæœ¬å­˜å‚¨
    private List<VersionId> youngGeneration = new ArrayList<>();
    private List<VersionId> matureGeneration = new ArrayList<>();  
    private List<VersionId> oldGeneration = new ArrayList<>();
    
    // ç‰ˆæœ¬åˆ›å»ºæ—¶çš„åˆ†ä»£åˆ†é…
    public void allocateVersion(VersionId versionId) {
        // æ–°ç‰ˆæœ¬é¦–å…ˆåˆ†é…åˆ°å¹´è½»ä»£
        youngGeneration.add(versionId);
    }
    
    // å¹´è½»ä»£å›æ”¶ï¼ˆé¢‘ç¹æ‰§è¡Œï¼‰
    public void minorGC() {
        List<VersionId> survivors = new ArrayList<>();
        
        for (VersionId versionId : youngGeneration) {
            if (isReferencedByActiveTransaction(versionId)) {
                // å­˜æ´»çš„ç‰ˆæœ¬æå‡åˆ°æˆç†Ÿä»£
                survivors.add(versionId);
            } else {
                // åƒåœ¾ç‰ˆæœ¬ç›´æ¥åˆ é™¤
                physicalDelete(versionId);
            }
        }
        
        // å­˜æ´»è€…æå‡åˆ°ä¸‹ä¸€ä»£
        matureGeneration.addAll(survivors);
        youngGeneration.clear();
    }
    
    // å…¨ä»£å›æ”¶ï¼ˆè¾ƒå°‘æ‰§è¡Œï¼‰
    public void majorGC() {
        minorGC();                    // å…ˆå›æ”¶å¹´è½»ä»£
        processGeneration(matureGeneration);  // å¤„ç†æˆç†Ÿä»£
        processGeneration(oldGeneration);     // å¤„ç†è€å¹´ä»£
    }
    
    private void processGeneration(List<VersionId> generation) {
        generation.removeIf(versionId -> {
            if (!isReferencedByActiveTransaction(versionId)) {
                physicalDelete(versionId);
                return true;
            }
            return false;
        });
    }
}
```

### 5.3 åˆ†ä»£å›æ”¶çš„è°ƒä¼˜ç­–ç•¥


**ğŸ“Š åˆ†ä»£å‚æ•°è°ƒä¼˜**

| å‚æ•° | è¯´æ˜ | å…¸å‹å€¼ | è°ƒä¼˜å»ºè®® |
|------|------|--------|----------|
| **å¹´è½»ä»£å¤§å°** | æ–°ç‰ˆæœ¬å­˜å‚¨ç©ºé—´ | æ€»ç©ºé—´çš„1/3 | äº‹åŠ¡çŸ­â†’å¤§ï¼Œäº‹åŠ¡é•¿â†’å° |
| **æå‡é˜ˆå€¼** | ç‰ˆæœ¬å‡ä»£çš„æ¡ä»¶ | å­˜æ´»2æ¬¡GC | æ•°æ®çƒ­åº¦ä½â†’é™ä½ |
| **å›æ”¶é¢‘ç‡** | å„ä»£GCçš„é¢‘ç‡ | 10:3:1 | è´Ÿè½½é«˜â†’é™ä½é¢‘ç‡ |

**âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

```
ç©ºé—´åˆ†é…ä¼˜åŒ–ï¼š
â€¢ å¹´è½»ä»£ä½¿ç”¨è¿ç»­å†…å­˜ï¼Œæé«˜åˆ†é…é€Ÿåº¦
â€¢ è€å¹´ä»£ä½¿ç”¨é“¾è¡¨ç»“æ„ï¼Œä¾¿äºç®¡ç†å¤§å¯¹è±¡

å›æ”¶æ—¶æœºä¼˜åŒ–ï¼š  
â€¢ å¹´è½»ä»£ï¼šäº‹åŠ¡æäº¤åç«‹å³æ£€æŸ¥
â€¢ æˆç†Ÿä»£ï¼šç³»ç»Ÿç©ºé—²æ—¶è¿›è¡Œ
â€¢ è€å¹´ä»£ï¼šå®šæœŸæˆ–ç©ºé—´ä¸è¶³æ—¶è§¦å‘

å¹¶å‘ä¼˜åŒ–ï¼š
â€¢ å¹´è½»ä»£å›æ”¶ä¸ä¸šåŠ¡å¹¶å‘æ‰§è¡Œ
â€¢ è€å¹´ä»£å›æ”¶ä½¿ç”¨å¢é‡æ–¹å¼
â€¢ å…³é”®è·¯å¾„é¿å…GCé˜»å¡
```

---

## 6. âš¡ å¢é‡å›æ”¶æœºåˆ¶


### 6.1 å¢é‡å›æ”¶çš„è®¾è®¡æ€æƒ³


**ğŸ•°ï¸ æ—¶é—´åˆ†ç‰‡ç­–ç•¥**

å¢é‡å›æ”¶å°†åƒåœ¾å›æ”¶å·¥ä½œåˆ†æ•£åˆ°å¤šä¸ªå°çš„æ—¶é—´ç‰‡ä¸­ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ç³»ç»Ÿã€‚

```
ä¼ ç»Ÿå›æ”¶ vs å¢é‡å›æ”¶ï¼š

ä¼ ç»Ÿå›æ”¶ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” (ä¸€æ¬¡å®Œæˆï¼Œè€—æ—¶é•¿)
ä¸šåŠ¡æš‚åœ                ä¸šåŠ¡ç»§ç»­

å¢é‡å›æ”¶ï¼š  
â”â”â” â–ª â”â”â” â–ª â”â”â” â–ª â”â”â” (åˆ†ç‰‡æ‰§è¡Œï¼Œè€—æ—¶çŸ­)
å›æ”¶  ä¸šåŠ¡  å›æ”¶  ä¸šåŠ¡  å›æ”¶  ä¸šåŠ¡
```

**ğŸ¯ å¢é‡å›æ”¶çš„æ ¸å¿ƒç›®æ ‡**

```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ å•æ¬¡å›æ”¶æ—¶é—´ < 10ms
â€¢ ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€å°åŒ–  
â€¢ å›æ”¶æ•ˆç‡ä¿æŒåˆç†
â€¢ å†…å­˜ä½¿ç”¨å¹³ç¨³å¢é•¿
```

### 6.2 å¢é‡å›æ”¶å®ç°æœºåˆ¶


**ğŸ”§ å·¥ä½œé˜Ÿåˆ—ç®¡ç†**

```java
public class IncrementalGC {
    // å›æ”¶å·¥ä½œé˜Ÿåˆ—
    private Queue<GCTask> gcTaskQueue = new LinkedList<>();
    private AtomicBoolean gcRunning = new AtomicBoolean(false);
    
    // GCä»»åŠ¡å®šä¹‰
    static class GCTask {
        private final VersionId versionId;
        private final GCPhase phase;
        
        enum GCPhase {
            MARK,    // æ ‡è®°é˜¶æ®µ
            SWEEP,   // æ¸…é™¤é˜¶æ®µ  
            COMPACT  // æ•´ç†é˜¶æ®µ
        }
    }
    
    // æäº¤å¢é‡GCä»»åŠ¡
    public void scheduleIncrementalGC() {
        if (gcRunning.compareAndSet(false, true)) {
            // å°†å¤§ä»»åŠ¡åˆ†è§£ä¸ºå°ä»»åŠ¡
            decomposeGCWork();
            
            // å¯åŠ¨å¢é‡æ‰§è¡Œ
            scheduleNextIncrement();
        }
    }
    
    // æ‰§è¡Œä¸€ä¸ªå¢é‡
    private void executeIncrement() {
        long startTime = System.currentTimeMillis();
        int taskCount = 0;
        
        // åœ¨æ—¶é—´é™åˆ¶å†…æ‰§è¡Œå°½å¯èƒ½å¤šçš„ä»»åŠ¡
        while (System.currentTimeMillis() - startTime < 5 && // 5msæ—¶é—´ç‰‡
               taskCount < 100 && // æœ€å¤š100ä¸ªä»»åŠ¡
               !gcTaskQueue.isEmpty()) {
            
            GCTask task = gcTaskQueue.poll();
            executeTask(task);
            taskCount++;
        }
        
        // å¦‚æœè¿˜æœ‰ä»»åŠ¡ï¼Œå®‰æ’ä¸‹ä¸€ä¸ªå¢é‡
        if (!gcTaskQueue.isEmpty()) {
            scheduleNextIncrement();
        } else {
            gcRunning.set(false);
        }
    }
    
    // å®‰æ’ä¸‹ä¸€ä¸ªå¢é‡æ‰§è¡Œ
    private void scheduleNextIncrement() {
        // å¯ä»¥ä½¿ç”¨å®šæ—¶å™¨æˆ–åœ¨ä¸šåŠ¡ç©ºé—²æ—¶æ‰§è¡Œ
        Timer.schedule(() -> executeIncrement(), 1); // 1msåæ‰§è¡Œ
    }
}
```

### 6.3 å†™å±éšœæŠ€æœ¯


**ğŸ›¡ï¸ å¹¶å‘å®‰å…¨ä¿éšœ**

åœ¨å¢é‡GCæœŸé—´ï¼Œéœ€è¦å¤„ç†ä¸šåŠ¡çº¿ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œå†™å±éšœæŠ€æœ¯ç¡®ä¿GCçš„æ­£ç¡®æ€§ã€‚

```java
public class WriteBarrier {
    private Set<VersionId> graySet = ConcurrentHashMap.newKeySet();
    private volatile boolean gcInProgress = false;
    
    // å†™å±éšœï¼šæ‹¦æˆªå†™æ“ä½œ
    public void writeBarrier(VersionId oldVersion, VersionId newVersion) {
        if (gcInProgress) {
            // å¦‚æœæ—§ç‰ˆæœ¬å·²ç»è¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œæ–°ç‰ˆæœ¬éœ€è¦æ ‡è®°ä¸ºç°è‰²
            if (isBlack(oldVersion) && isWhite(newVersion)) {
                markGray(newVersion);
            }
        }
    }
    
    // æ ‡è®°ä¸ºç°è‰²ï¼ˆéœ€è¦é‡æ–°æ‰«æï¼‰
    private void markGray(VersionId versionId) {
        graySet.add(versionId);
    }
    
    // é‡æ–°æ‰«æç°è‰²å¯¹è±¡
    public void rescanGrayObjects() {
        for (VersionId versionId : graySet) {
            scanVersion(versionId);
        }
        graySet.clear();
    }
}
```

---

## 7. ğŸš€ å›æ”¶æ€§èƒ½ä¼˜åŒ–


### 7.1 å›æ”¶è§¦å‘ç­–ç•¥ä¼˜åŒ–


**ğŸ“Š æ™ºèƒ½è§¦å‘æœºåˆ¶**

åŸºäºå¤šä¸ªæŒ‡æ ‡ç»¼åˆåˆ¤æ–­GCè§¦å‘æ—¶æœºï¼Œè€Œä¸æ˜¯ç®€å•çš„å®šæ—¶æˆ–é˜ˆå€¼è§¦å‘ã€‚

```
è§¦å‘æ¡ä»¶çŸ©é˜µï¼š
                ä½è´Ÿè½½    ä¸­è´Ÿè½½    é«˜è´Ÿè½½
å†…å­˜ä½¿ç”¨ç‡é«˜      ç«‹å³      å»¶è¿Ÿ      å°å¢é‡
ç‰ˆæœ¬ç§¯ç´¯å¤š        ç«‹å³      ç«‹å³      æ‰¹é‡å¤„ç†  
ç³»ç»Ÿç©ºé—²æ—¶        ä¸»åŠ¨      é€‚ä¸­      è·³è¿‡

å†³ç­–ç®—æ³•ï¼š
score = å†…å­˜å‹åŠ› Ã— 0.4 + ç‰ˆæœ¬å‹åŠ› Ã— 0.3 + è´Ÿè½½å‹åŠ› Ã— 0.3
if score > 0.7: ç«‹å³GC
elif score > 0.4: å¢é‡GC  
else: å»¶è¿ŸGC
```

**ğŸ¯ è‡ªé€‚åº”è°ƒèŠ‚æœºåˆ¶**

```java
public class AdaptiveGCTrigger {
    private MovingAverage responseTimeAvg = new MovingAverage(100);
    private MovingAverage memoryUsageAvg = new MovingAverage(50);
    
    // è®¡ç®—GCç´§æ€¥ç¨‹åº¦
    public double calculateGCUrgency() {
        double memoryPressure = memoryUsageAvg.getAverage();
        double performancePressure = responseTimeAvg.getAverage() / TARGET_RESPONSE_TIME;
        double versionPressure = getVersionCount() / MAX_VERSION_COUNT;
        
        return memoryPressure * 0.4 + 
               performancePressure * 0.3 + 
               versionPressure * 0.3;
    }
    
    // å†³å®šGCç­–ç•¥
    public GCStrategy decideGCStrategy() {
        double urgency = calculateGCUrgency();
        
        if (urgency > 0.8) {
            return GCStrategy.AGGRESSIVE;  // æ¿€è¿›å›æ”¶
        } else if (urgency > 0.5) {
            return GCStrategy.INCREMENTAL; // å¢é‡å›æ”¶
        } else {
            return GCStrategy.LAZY;        // æ‡’æƒ°å›æ”¶
        }
    }
}
```

### 7.2 å¹¶è¡Œå›æ”¶ä¼˜åŒ–


**ğŸ”€ å¤šçº¿ç¨‹åä½œæ¨¡å¼**

```
å¹¶è¡Œå›æ”¶æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ‡è®°çº¿ç¨‹1â”‚  â”‚ æ ‡è®°çº¿ç¨‹2â”‚  â”‚ æ¸…é™¤çº¿ç¨‹1â”‚  â”‚ æ¸…é™¤çº¿ç¨‹2â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  åè°ƒè°ƒåº¦å™¨  â”‚ â”‚  è¿›åº¦ç›‘æ§å™¨  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ å·¥ä½œçªƒå–ç®—æ³•**

```java
public class ParallelGC {
    private final WorkStealingQueue[] workerQueues;
    private final AtomicInteger completedWorkers = new AtomicInteger(0);
    
    // å¹¶è¡Œæ ‡è®°é˜¶æ®µ
    public void parallelMark() {
        int numWorkers = Runtime.getRuntime().availableProcessors();
        CountDownLatch latch = new CountDownLatch(numWorkers);
        
        // å¯åŠ¨å¤šä¸ªå·¥ä½œçº¿ç¨‹
        for (int i = 0; i < numWorkers; i++) {
            final int workerId = i;
            executor.submit(() -> {
                try {
                    markWorker(workerId);
                } finally {
                    latch.countDown();
                }
            });
        }
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        latch.await();
    }
    
    // å•ä¸ªæ ‡è®°å·¥ä½œçº¿ç¨‹
    private void markWorker(int workerId) {
        WorkStealingQueue myQueue = workerQueues[workerId];
        
        while (true) {
            VersionId version = myQueue.poll();
            
            // å¦‚æœè‡ªå·±é˜Ÿåˆ—ä¸ºç©ºï¼Œå°è¯•ä»å…¶ä»–é˜Ÿåˆ—å·å–ä»»åŠ¡
            if (version == null) {
                version = stealWork(workerId);
                if (version == null) break; // æ‰€æœ‰å·¥ä½œå®Œæˆ
            }
            
            // æ ‡è®°ç‰ˆæœ¬å¹¶æ·»åŠ ç›¸å…³ç‰ˆæœ¬åˆ°é˜Ÿåˆ—
            markVersion(version);
            for (VersionId related : getRelatedVersions(version)) {
                myQueue.offer(related);
            }
        }
    }
}
```

### 7.3 å†…å­˜ç®¡ç†ä¼˜åŒ–


**ğŸ§  å†…å­˜å¸ƒå±€ä¼˜åŒ–**

```
å†…å­˜åŒºåŸŸåˆ’åˆ†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MVCCå­˜å‚¨åŒºåŸŸ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç‰ˆæœ¬å…ƒæ•°æ®  â”‚  ç‰ˆæœ¬æ•°æ®   â”‚     GCå·¥ä½œåŒºåŸŸ      â”‚
â”‚   (ç´¢å¼•)    â”‚  (å®é™…å†…å®¹)  â”‚   (ä¸´æ—¶æ ‡è®°ç­‰)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   å¿«é€Ÿè®¿é—®       å¤§å®¹é‡         ä¸“ç”¨ä¼˜åŒ–
```

**ğŸ“ˆ ç¼“å­˜å‹å¥½çš„æ•°æ®ç»“æ„**

```java
// ç‰ˆæœ¬é“¾è¡¨ï¼šæŒ‰æ—¶é—´é¡ºåºç»„ç»‡ï¼Œæé«˜æ‰«ææ•ˆç‡
public class VersionChain {
    private VersionNode head;
    private VersionNode tail;
    
    static class VersionNode {
        VersionId versionId;
        long timestamp;
        VersionNode next;
        boolean marked;  // GCæ ‡è®°ä½ï¼Œç´§æŒ¨ç€æ”¾ç½®æé«˜ç¼“å­˜æ•ˆç‡
    }
    
    // æ‰¹é‡æ ‡è®°ï¼šä¸€æ¬¡æ€§æ ‡è®°å¤šä¸ªè¿ç»­ç‰ˆæœ¬
    public void batchMark(long startTime, long endTime) {
        VersionNode current = head;
        while (current != null && current.timestamp <= endTime) {
            if (current.timestamp >= startTime) {
                current.marked = true;
            }
            current = current.next;
        }
    }
}
```

### 7.4 GCæ€§èƒ½ç›‘æ§


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | ç›®æ ‡å€¼ | ç›‘æ§æ–¹æ³• |
|----------|----------|--------|----------|
| **å»¶è¿ŸæŒ‡æ ‡** | GCåœé¡¿æ—¶é—´ | < 10ms | æ—¶é—´æˆ³è®°å½• |
| **ååæŒ‡æ ‡** | å›æ”¶ç‰ˆæœ¬æ•°/ç§’ | > 1000 | è®¡æ•°ç»Ÿè®¡ |
| **æ•ˆç‡æŒ‡æ ‡** | å›æ”¶ç‡ | > 90% | å‰åå¯¹æ¯” |
| **èµ„æºæŒ‡æ ‡** | CPU/å†…å­˜ä½¿ç”¨ | < 20% | ç³»ç»Ÿç›‘æ§ |

**âš ï¸ æ€§èƒ½å‘Šè­¦æœºåˆ¶**

```java
public class GCMonitor {
    private final PerformanceMetrics metrics = new PerformanceMetrics();
    
    // è®°å½•GCæ€§èƒ½æ•°æ®
    public void recordGCPerformance(long duration, int versionsCollected) {
        metrics.addGCDuration(duration);
        metrics.addVersionsCollected(versionsCollected);
        
        // æ£€æŸ¥æ€§èƒ½é˜ˆå€¼
        if (duration > GC_DURATION_THRESHOLD) {
            alertManager.sendAlert("GC duration exceeded threshold: " + duration + "ms");
        }
        
        // æ£€æŸ¥å›æ”¶æ•ˆç‡
        double efficiency = calculateEfficiency();
        if (efficiency < EFFICIENCY_THRESHOLD) {
            alertManager.sendAlert("GC efficiency too low: " + efficiency);
        }
    }
    
    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
    public GCReport generateReport() {
        return GCReport.builder()
            .averageDuration(metrics.getAverageGCDuration())
            .totalVersionsCollected(metrics.getTotalVersionsCollected())
            .gcFrequency(metrics.getGCFrequency())
            .memoryReclaimed(metrics.getMemoryReclaimed())
            .build();
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ MVCCåƒåœ¾å›æ”¶ï¼šæ¸…ç†ä¸å†éœ€è¦çš„æ•°æ®ç‰ˆæœ¬ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´
ğŸ”¸ ç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»º â†’ ä½¿ç”¨ â†’ ä¸å¯è§ â†’ å›æ”¶
ğŸ”¸ å›æ”¶å®‰å…¨æ€§ï¼šç¡®ä¿ä¸è¯¯åˆ æ´»è·ƒç‰ˆæœ¬ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§  
ğŸ”¸ æ€§èƒ½å¹³è¡¡ï¼šå›æ”¶æ•ˆç‡ vs ç³»ç»Ÿå“åº”æ—¶é—´çš„æƒè¡¡
ğŸ”¸ å¹¶å‘å¤„ç†ï¼šå›æ”¶è¿‡ç¨‹ä¸æ­£å¸¸ä¸šåŠ¡æ“ä½œçš„åè°ƒ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶**
```
æ ¹æœ¬åŸå› ï¼š
MVCCé€šè¿‡ä¿ç•™å¤šç‰ˆæœ¬å®ç°å¹¶å‘æ§åˆ¶ï¼Œä½†ç‰ˆæœ¬ä¼šæ— é™ç´¯ç§¯
è§£å†³é—®é¢˜ï¼š
â€¢ æ§åˆ¶å­˜å‚¨ç©ºé—´å¢é•¿
â€¢ ç»´æŒæŸ¥è¯¢æ€§èƒ½  
â€¢ æé«˜ç³»ç»Ÿç¨³å®šæ€§
```

**ğŸ”¹ å›æ”¶ç®—æ³•çš„é€‰æ‹©åŸåˆ™**
```
å¼•ç”¨è®¡æ•°ï¼šé€‚åˆå†…å­˜æ•æ„Ÿã€ä½å»¶è¿Ÿåœºæ™¯
æ ‡è®°æ¸…é™¤ï¼šé€‚åˆé€šç”¨åœºæ™¯ï¼Œç®—æ³•æˆç†Ÿ  
åˆ†ä»£å›æ”¶ï¼šé€‚åˆå¤§æ•°æ®é‡ã€å¤æ‚è®¿é—®æ¨¡å¼
å¢é‡å›æ”¶ï¼šé€‚åˆé«˜å¯ç”¨ã€ä½åœé¡¿è¦æ±‚
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**  
```
æ—¶é—´ä¼˜åŒ–ï¼šåˆ†ç‰‡æ‰§è¡Œã€å¹¶è¡Œå¤„ç†ã€æ™ºèƒ½è§¦å‘
ç©ºé—´ä¼˜åŒ–ï¼šå†…å­˜å¸ƒå±€ã€ç¼“å­˜å‹å¥½ã€æ‰¹é‡æ“ä½œ
æ•ˆç‡ä¼˜åŒ–ï¼šç²¾ç¡®æ ‡è®°ã€å¿«é€Ÿæ‰«æã€è‡ªé€‚åº”è°ƒèŠ‚
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‰æ‹©åˆé€‚çš„å›æ”¶ç­–ç•¥**

```
ä¸šåŠ¡ç‰¹å¾åˆ†æï¼š
â€¢ äº‹åŠ¡é•¿åº¦ï¼šçŸ­äº‹åŠ¡ â†’ å¼•ç”¨è®¡æ•°ï¼Œé•¿äº‹åŠ¡ â†’ æ ‡è®°æ¸…é™¤
â€¢ æ•°æ®è§„æ¨¡ï¼šå°è§„æ¨¡ â†’ ç®€å•ç®—æ³•ï¼Œå¤§è§„æ¨¡ â†’ åˆ†ä»£å›æ”¶  
â€¢ æ€§èƒ½è¦æ±‚ï¼šä½å»¶è¿Ÿ â†’ å¢é‡å›æ”¶ï¼Œé«˜åå â†’ æ‰¹é‡å›æ”¶
â€¢ èµ„æºé™åˆ¶ï¼šå†…å­˜å—é™ â†’ æ¿€è¿›å›æ”¶ï¼ŒCPUå—é™ â†’ æ‡’æƒ°å›æ”¶
```

**âš¡ è°ƒä¼˜æœ€ä½³å®è·µ**

```
ç›‘æ§é©±åŠ¨è°ƒä¼˜ï¼š
1. å»ºç«‹å®Œå–„çš„æ€§èƒ½ç›‘æ§ä½“ç³»
2. è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼  
3. å®šæœŸåˆ†ææ€§èƒ½è¶‹åŠ¿
4. æ ¹æ®æ•°æ®è°ƒæ•´å‚æ•°

å‚æ•°è°ƒä¼˜æ­¥éª¤ï¼š
1. ç¡®å®šä¸šåŠ¡åŸºå‡†æ€§èƒ½
2. é€ä¸ªè°ƒæ•´å…³é”®å‚æ•°
3. è§‚å¯Ÿæ€§èƒ½å˜åŒ–è¶‹åŠ¿
4. æ‰¾åˆ°æœ€ä¼˜å‚æ•°ç»„åˆ

å¸¸è§è°ƒä¼˜å‚æ•°ï¼š
â€¢ GCè§¦å‘é¢‘ç‡ï¼šå¹³è¡¡å›æ”¶åŠæ—¶æ€§å’Œå¼€é”€
â€¢ æ‰¹å¤„ç†å¤§å°ï¼šå¹³è¡¡æ•ˆç‡å’Œå»¶è¿Ÿ
â€¢ å¹¶å‘çº¿ç¨‹æ•°ï¼šå¹³è¡¡ååé‡å’Œèµ„æºæ¶ˆè€—
```

### 8.4 æœªæ¥å‘å±•è¶‹åŠ¿


**ğŸš€ æŠ€æœ¯å‘å±•æ–¹å‘**

```
æ™ºèƒ½åŒ–GCï¼š
â€¢ æœºå™¨å­¦ä¹ é¢„æµ‹æœ€ä½³å›æ”¶æ—¶æœº
â€¢ è‡ªé€‚åº”å‚æ•°è°ƒèŠ‚
â€¢ æ™ºèƒ½è´Ÿè½½æ„ŸçŸ¥

ç¡¬ä»¶åŠ é€Ÿï¼š
â€¢ GPUå¹¶è¡Œå›æ”¶
â€¢ ä¸“ç”¨GCç¡¬ä»¶  
â€¢ å†…å­˜è®¡ç®—ä¸€ä½“åŒ–

åˆ†å¸ƒå¼GCï¼š
â€¢ è·¨èŠ‚ç‚¹åè°ƒå›æ”¶
â€¢ å…¨å±€è§†å›¾ä¼˜åŒ–
â€¢ äº‘åŸç”ŸGCæœåŠ¡
```

**ğŸ§  æ ¸å¿ƒè®°å¿†è¦ç‚¹**

- MVCCç‰ˆæœ¬ç´¯ç§¯éœ€å›æ”¶ï¼Œåƒåœ¾æ¸…ç†ä¿æ€§èƒ½
- å¼•ç”¨è®¡æ•°å®æ—¶å‡†ï¼Œæ ‡è®°æ¸…é™¤æ›´é€šç”¨  
- åˆ†ä»£å›æ”¶é€‚å¤§é‡ï¼Œå¢é‡å›æ”¶é™å»¶è¿Ÿ
- å¹¶å‘å®‰å…¨å†™å±éšœï¼Œæ€§èƒ½ç›‘æ§åŠ©è°ƒä¼˜
- ç®—æ³•é€‰æ‹©çœ‹åœºæ™¯ï¼Œå‚æ•°è°ƒä¼˜é æ•°æ®