---
title: 5ã€å¹¶å‘æ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [å¹¶å‘æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-å¹¶å‘æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [é”ç²’åº¦ä¼˜åŒ–](#2-é”ç²’åº¦ä¼˜åŒ–)
3. [é”æŒæœ‰æ—¶é—´æ§åˆ¶](#3-é”æŒæœ‰æ—¶é—´æ§åˆ¶)
4. [æ‰¹é‡æ“ä½œä¼˜åŒ–](#4-æ‰¹é‡æ“ä½œä¼˜åŒ–)
5. [ç´¢å¼•ä¼˜åŒ–å‡é”](#5-ç´¢å¼•ä¼˜åŒ–å‡é”)
6. [è¿æ¥æ± é…ç½®](#6-è¿æ¥æ± é…ç½®)
7. [äº‹åŠ¡å¤§å°æ§åˆ¶](#7-äº‹åŠ¡å¤§å°æ§åˆ¶)
8. [å¹¶å‘åº¦è°ƒä¼˜](#8-å¹¶å‘åº¦è°ƒä¼˜)
9. [èµ„æºäº‰ç”¨åˆ†æ](#9-èµ„æºäº‰ç”¨åˆ†æ)
10. [æ€§èƒ½ä¼˜åŒ–å®Œæ•´ä½“ç³»](#10-æ€§èƒ½ä¼˜åŒ–å®Œæ•´ä½“ç³»)
11. [ä¼˜åŒ–ç­–ç•¥é€‰æ‹©](#11-ä¼˜åŒ–ç­–ç•¥é€‰æ‹©)
12. [æ€§èƒ½ç›‘æ§è¯„ä¼°](#12-æ€§èƒ½ç›‘æ§è¯„ä¼°)
13. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#13-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ å¹¶å‘æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¹¶å‘æ€§èƒ½ä¼˜åŒ–


**å¹¶å‘æ€§èƒ½ä¼˜åŒ–**æ˜¯æŒ‡é€šè¿‡è°ƒæ•´æ•°æ®åº“ç³»ç»Ÿçš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œæœ€å¤§åŒ–å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œçš„æ•ˆç‡ã€‚

**ğŸ”¸ æ ¸å¿ƒç›®æ ‡**
```
ä¼˜åŒ–ç›®æ ‡ï¼š
- æé«˜ç³»ç»Ÿååé‡ï¼šå•ä½æ—¶é—´å¤„ç†æ›´å¤šäº‹åŠ¡
- é™ä½å“åº”å»¶è¿Ÿï¼šå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´
- æå‡èµ„æºåˆ©ç”¨ç‡ï¼šå……åˆ†å‘æŒ¥ç¡¬ä»¶æ€§èƒ½
- å‡å°‘é”äº‰ç”¨ï¼šé™ä½äº‹åŠ¡é—´çš„å†²çª
```

**âš ï¸ å¸¸è§æ€§èƒ½ç“¶é¢ˆ**
```
å¹¶å‘æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é”äº‰ç”¨ç“¶é¢ˆï¼š                     â”‚
â”‚    å¤šä¸ªäº‹åŠ¡ç«äº‰ç›¸åŒèµ„æº             â”‚
â”‚                                     â”‚
â”‚ 2. I/Oç“¶é¢ˆï¼š                        â”‚
â”‚    ç£ç›˜è¯»å†™æˆä¸ºæ€§èƒ½é™åˆ¶å› ç´          â”‚
â”‚                                     â”‚
â”‚ 3. CPUç“¶é¢ˆï¼š                        â”‚
â”‚    è®¡ç®—å¯†é›†å‹æ“ä½œå ç”¨è¿‡å¤šCPU        â”‚
â”‚                                     â”‚
â”‚ 4. å†…å­˜ç“¶é¢ˆï¼š                       â”‚
â”‚    ç¼“å†²æ± ä¸è¶³å¯¼è‡´é¢‘ç¹ç£ç›˜è®¿é—®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¼˜åŒ–ç­–ç•¥æ¦‚è§ˆ


**ğŸ“Š ä¼˜åŒ–ç­–ç•¥åˆ†ç±»**
```
ä¼˜åŒ–ç­–ç•¥ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”ä¼˜åŒ–ï¼š                            â”‚
â”‚ - å‡å°‘é”ç²’åº¦                        â”‚
â”‚ - ç¼©çŸ­é”æŒæœ‰æ—¶é—´                    â”‚
â”‚ - é¿å…é”å‡çº§                        â”‚
â”‚                                     â”‚
â”‚ äº‹åŠ¡ä¼˜åŒ–ï¼š                          â”‚
â”‚ - æ§åˆ¶äº‹åŠ¡å¤§å°                      â”‚
â”‚ - åˆç†æ‰¹é‡æ“ä½œ                      â”‚
â”‚ - ä¼˜åŒ–äº‹åŠ¡éš”ç¦»çº§åˆ«                  â”‚
â”‚                                     â”‚
â”‚ ç´¢å¼•ä¼˜åŒ–ï¼š                          â”‚
â”‚ - å‡å°‘é”å®šèŒƒå›´                      â”‚
â”‚ - æé«˜æŸ¥è¯¢æ•ˆç‡                      â”‚
â”‚ - é¿å…å…¨è¡¨æ‰«æ                      â”‚
â”‚                                     â”‚
â”‚ è¿æ¥ä¼˜åŒ–ï¼š                          â”‚
â”‚ - åˆç†é…ç½®è¿æ¥æ±                     â”‚
â”‚ - æ§åˆ¶å¹¶å‘è¿æ¥æ•°                    â”‚
â”‚ - ä¼˜åŒ–è¿æ¥å¤ç”¨                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ é”ç²’åº¦ä¼˜åŒ–


### 2.1 é”ç²’åº¦çš„åŸºæœ¬æ¦‚å¿µ


**é”ç²’åº¦**å†³å®šäº†é”å®šèµ„æºçš„èŒƒå›´å¤§å°ï¼Œç²’åº¦é€‰æ‹©ç›´æ¥å½±å“å¹¶å‘æ€§èƒ½ã€‚

**ğŸ”¸ é”ç²’åº¦å±‚æ¬¡**
```
é”ç²’åº¦å±‚æ¬¡ï¼ˆä»ç²—åˆ°ç»†ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åº“çº§é”ï¼š                        â”‚
â”‚ é”å®šæ•´ä¸ªæ•°æ®åº“ï¼Œå½±å“èŒƒå›´æœ€å¤§        â”‚
â”‚                                     â”‚
â”‚ è¡¨çº§é”ï¼š                            â”‚
â”‚ é”å®šæ•´å¼ è¡¨ï¼Œé€‚ç”¨äºæ‰¹é‡æ“ä½œ          â”‚
â”‚                                     â”‚
â”‚ é¡µçº§é”ï¼š                            â”‚
â”‚ é”å®šæ•°æ®é¡µï¼Œä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´      â”‚
â”‚                                     â”‚
â”‚ è¡Œçº§é”ï¼š                            â”‚
â”‚ é”å®šå•è¡Œè®°å½•ï¼Œå¹¶å‘åº¦æœ€é«˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¡Œçº§é”ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ è¡Œçº§é”çš„æœ€ä½³å®è·µ**
```sql
-- ä¼˜åŒ–å‰ï¼šé”å®šèŒƒå›´è¿‡å¤§
SELECT * FROM orders WHERE status = 'pending' FOR UPDATE;
-- é—®é¢˜ï¼šé”å®šæ‰€æœ‰å¾…å¤„ç†è®¢å•

-- ä¼˜åŒ–åï¼šç²¾ç¡®é”å®š
SELECT * FROM orders WHERE order_id = 12345 FOR UPDATE;
-- ä¼˜åŠ¿ï¼šåªé”å®šç‰¹å®šè®¢å•ï¼Œæé«˜å¹¶å‘åº¦

-- æ‰¹é‡æ›´æ–°ä¼˜åŒ–
-- ä¼ ç»Ÿæ–¹å¼ï¼šé•¿æ—¶é—´æŒé”
UPDATE orders SET status = 'processing' 
WHERE status = 'pending' AND create_time < '2024-01-01';

-- ä¼˜åŒ–æ–¹å¼ï¼šåˆ†æ‰¹å¤„ç†
UPDATE orders SET status = 'processing' 
WHERE order_id IN (
    SELECT order_id FROM orders 
    WHERE status = 'pending' AND create_time < '2024-01-01'
    LIMIT 1000
);
```

### 2.3 é”ç²’åº¦é€‰æ‹©ç­–ç•¥


**âš–ï¸ ç²’åº¦é€‰æ‹©åŸåˆ™**
```java
public class LockGranularityOptimizer {
    
    // æ ¹æ®æ“ä½œç±»å‹é€‰æ‹©é”ç²’åº¦
    public LockType chooseLockGranularity(OperationType operation) {
        switch (operation) {
            case SINGLE_ROW_UPDATE:
                return LockType.ROW_LOCK;  // å•è¡Œæ“ä½œä½¿ç”¨è¡Œé”
                
            case BATCH_INSERT:
                return LockType.TABLE_LOCK;  // æ‰¹é‡æ’å…¥è€ƒè™‘è¡¨é”
                
            case RANGE_QUERY:
                return LockType.GAP_LOCK;  // èŒƒå›´æŸ¥è¯¢ä½¿ç”¨é—´éš™é”
                
            case FULL_TABLE_SCAN:
                return LockType.TABLE_LOCK;  // å…¨è¡¨æ‰«æä½¿ç”¨è¡¨é”
        }
    }
}
```

**ğŸ“Š ç²’åº¦å¯¹æ¯”åˆ†æ**
```
é”ç²’åº¦æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é”ç²’åº¦      â”‚ å¹¶å‘åº¦      â”‚ å¼€é”€        â”‚ é€‚ç”¨åœºæ™¯    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡Œçº§é”      â”‚    æœ€é«˜     â”‚    æœ€é«˜     â”‚ å•è¡Œæ“ä½œ    â”‚
â”‚ é¡µçº§é”      â”‚     ä¸­      â”‚     ä¸­      â”‚ å°èŒƒå›´æ“ä½œ  â”‚
â”‚ è¡¨çº§é”      â”‚    æœ€ä½     â”‚    æœ€ä½     â”‚ æ‰¹é‡æ“ä½œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. â±ï¸ é”æŒæœ‰æ—¶é—´æ§åˆ¶


### 3.1 é”æŒæœ‰æ—¶é—´çš„å½±å“


**é”æŒæœ‰æ—¶é—´ç›´æ¥å†³å®šäº†å…¶ä»–äº‹åŠ¡çš„ç­‰å¾…æ—¶é—´ï¼Œæ˜¯ä¼˜åŒ–å¹¶å‘æ€§èƒ½çš„å…³é”®å› ç´ ã€‚**

**âš ï¸ é•¿æ—¶é—´æŒé”çš„é—®é¢˜**
```
é•¿æ—¶é—´æŒé”çš„å½±å“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é˜»å¡å…¶ä»–äº‹åŠ¡ï¼š                   â”‚
â”‚    ç­‰å¾…é˜Ÿåˆ—ä¸æ–­å¢é•¿                 â”‚
â”‚                                     â”‚
â”‚ 2. é™ä½ç³»ç»Ÿååé‡ï¼š                 â”‚
â”‚    å¯ç”¨å¹¶å‘åº¦ä¸‹é™                   â”‚
â”‚                                     â”‚
â”‚ 3. å¢åŠ æ­»é”é£é™©ï¼š                   â”‚
â”‚    é•¿äº‹åŠ¡æ›´å®¹æ˜“å½¢æˆå¾ªç¯ç­‰å¾…         â”‚
â”‚                                     â”‚
â”‚ 4. å½±å“ç”¨æˆ·ä½“éªŒï¼š                   â”‚
â”‚    å“åº”æ—¶é—´å¤§å¹…å¢åŠ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å‡å°‘é”æŒæœ‰æ—¶é—´çš„æŠ€å·§


**ğŸš€ å¿«é€Ÿé‡Šæ”¾é”çš„ç­–ç•¥**
```sql
-- ä¼˜åŒ–å‰ï¼šé•¿æ—¶é—´æŒé”
BEGIN;
SELECT * FROM accounts WHERE user_id = 1001 FOR UPDATE;
-- æ‰§è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘è®¡ç®—ï¼ˆè€—æ—¶5ç§’ï¼‰
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1001;
COMMIT;

-- ä¼˜åŒ–åï¼šå¿«é€Ÿé‡Šæ”¾é”
-- æ­¥éª¤1ï¼šé¢„å…ˆè®¡ç®—ä¸šåŠ¡é€»è¾‘
SET @new_balance = (
    SELECT balance - 100 FROM accounts WHERE user_id = 1001
);

-- æ­¥éª¤2ï¼šå¿«é€Ÿæ›´æ–°
BEGIN;
UPDATE accounts SET balance = @new_balance 
WHERE user_id = 1001 AND balance >= 100;
COMMIT;
```

**ğŸ”§ äº‹åŠ¡æ‹†åˆ†ç­–ç•¥**
```java
public class LockTimeOptimizer {
    
    // ä¼˜åŒ–å‰ï¼šå¤§äº‹åŠ¡
    public void processOrderTraditional(Order order) {
        try (Connection conn = getConnection()) {
            conn.setAutoCommit(false);
            
            // é”å®šåº“å­˜ï¼ˆæŒé”å¼€å§‹ï¼‰
            lockInventory(order.getProductId());
            
            // å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆæŒé”5ç§’ï¼‰
            calculateDiscount(order);
            validatePayment(order);
            generateInvoice(order);
            
            // æ›´æ–°åº“å­˜ï¼ˆæŒé”ç»“æŸï¼‰
            updateInventory(order);
            conn.commit();
        }
    }
    
    // ä¼˜åŒ–åï¼šçŸ­äº‹åŠ¡
    public void processOrderOptimized(Order order) {
        // é¢„å¤„ç†ï¼ˆæ— é”ï¼‰
        order.setDiscount(calculateDiscount(order));
        validatePayment(order);
        String invoice = generateInvoice(order);
        
        // å¿«é€Ÿäº‹åŠ¡ï¼ˆæŒé”0.1ç§’ï¼‰
        try (Connection conn = getConnection()) {
            conn.setAutoCommit(false);
            lockInventory(order.getProductId());
            updateInventory(order);
            conn.commit();
        }
    }
}
```

### 3.3 é”æŒæœ‰æ—¶é—´ç›‘æ§


**ğŸ“Š ç›‘æ§å…³é”®æŒ‡æ ‡**
```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id AS waiting_trx,
    r.trx_mysql_thread_id AS waiting_thread,
    r.trx_query AS waiting_query,
    b.trx_id AS blocking_trx,
    b.trx_mysql_thread_id AS blocking_thread,
    b.trx_query AS blocking_query,
    p.TIME AS lock_wait_time
FROM 
    information_schema.INNODB_LOCK_WAITS w
    JOIN information_schema.INNODB_TRX r ON r.trx_id = w.requesting_trx_id
    JOIN information_schema.INNODB_TRX b ON b.trx_id = w.blocking_trx_id
    JOIN information_schema.PROCESSLIST p ON p.ID = r.trx_mysql_thread_id;

-- ç›‘æ§å¹³å‡é”ç­‰å¾…æ—¶é—´
SELECT 
    AVG(TIMER_WAIT/1000000000) AS avg_lock_wait_seconds
FROM performance_schema.events_waits_history_long 
WHERE EVENT_NAME LIKE 'wait/synch/mutex/innodb%';
```

---

## 4. ğŸ“¦ æ‰¹é‡æ“ä½œä¼˜åŒ–


### 4.1 æ‰¹é‡æ“ä½œçš„ä¼˜åŠ¿


**æ‰¹é‡æ“ä½œé€šè¿‡å‡å°‘äº‹åŠ¡å¼€é”€å’Œç½‘ç»œå¾€è¿”ï¼Œæ˜¾è‘—æå‡å¹¶å‘æ€§èƒ½ã€‚**

**ğŸ¯ æ‰¹é‡æ“ä½œçš„æ”¶ç›Š**
```
æ‰¹é‡æ“ä½œä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‡å°‘äº‹åŠ¡å¼€é”€ï¼š                   â”‚
â”‚    å¤šä¸ªæ“ä½œå…±äº«ä¸€ä¸ªäº‹åŠ¡             â”‚
â”‚                                     â”‚
â”‚ 2. å‡å°‘ç½‘ç»œå¾€è¿”ï¼š                   â”‚
â”‚    ä¸€æ¬¡ä¼ è¾“å¤šä¸ªSQLè¯­å¥              â”‚
â”‚                                     â”‚
â”‚ 3. æé«˜é”æ•ˆç‡ï¼š                     â”‚
â”‚    å‡å°‘é”è·å–å’Œé‡Šæ”¾æ¬¡æ•°             â”‚
â”‚                                     â”‚
â”‚ 4. ä¼˜åŒ–I/Oæ¨¡å¼ï¼š                    â”‚
â”‚    é¡ºåºå†™å…¥æ€§èƒ½æ›´å¥½                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ‰¹é‡æ’å…¥ä¼˜åŒ–


**ğŸš€ é«˜æ•ˆæ‰¹é‡æ’å…¥ç­–ç•¥**
```sql
-- ä¼˜åŒ–å‰ï¼šé€æ¡æ’å…¥
INSERT INTO products (name, price) VALUES ('Product1', 10.00);
INSERT INTO products (name, price) VALUES ('Product2', 20.00);
INSERT INTO products (name, price) VALUES ('Product3', 30.00);
-- é—®é¢˜ï¼šæ¯æ¡INSERTéƒ½æ˜¯ä¸€ä¸ªäº‹åŠ¡

-- ä¼˜åŒ–åï¼šæ‰¹é‡æ’å…¥
INSERT INTO products (name, price) VALUES 
    ('Product1', 10.00),
    ('Product2', 20.00),
    ('Product3', 30.00),
    ('Product4', 40.00),
    ('Product5', 50.00);
-- ä¼˜åŠ¿ï¼šå•ä¸ªäº‹åŠ¡ï¼Œå‡å°‘å¼€é”€

-- å¤§æ‰¹é‡æ’å…¥ä¼˜åŒ–
LOAD DATA INFILE '/path/to/products.csv'
INTO TABLE products
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
(name, price);
```

### 4.3 æ‰¹é‡æ›´æ–°ç­–ç•¥


**âš¡ æ™ºèƒ½æ‰¹é‡æ›´æ–°**
```java
public class BatchUpdateOptimizer {
    
    // æ‰¹é‡æ›´æ–°å®ç°
    public void batchUpdate(List<Product> products) {
        String sql = "UPDATE products SET price = ? WHERE id = ?";
        
        try (PreparedStatement stmt = connection.prepareStatement(sql)) {
            connection.setAutoCommit(false);
            
            for (Product product : products) {
                stmt.setDouble(1, product.getPrice());
                stmt.setLong(2, product.getId());
                stmt.addBatch();
                
                // æ¯1000æ¡æ‰§è¡Œä¸€æ¬¡ï¼Œé¿å…å†…å­˜æº¢å‡º
                if (products.indexOf(product) % 1000 == 0) {
                    stmt.executeBatch();
                    stmt.clearBatch();
                }
            }
            
            stmt.executeBatch();  // æ‰§è¡Œå‰©ä½™çš„æ‰¹æ¬¡
            connection.commit();
        }
    }
    
    // åŸºäºæ¡ä»¶çš„æ‰¹é‡æ›´æ–°
    public void conditionalBatchUpdate() {
        String sql = "UPDATE orders SET status = 'shipped' " +
                    "WHERE status = 'pending' AND create_time < ? " +
                    "LIMIT 5000";  // é™åˆ¶æ¯æ¬¡æ›´æ–°æ•°é‡
        
        try (PreparedStatement stmt = connection.prepareStatement(sql)) {
            stmt.setTimestamp(1, yesterday);
            int updatedRows = stmt.executeUpdate();
            
            // å¦‚æœè¿˜æœ‰æ›´å¤šè®°å½•ï¼Œç»§ç»­å¤„ç†
            while (updatedRows > 0) {
                updatedRows = stmt.executeUpdate();
            }
        }
    }
}
```

### 4.4 æ‰¹é‡æ“ä½œæ€§èƒ½æµ‹è¯•


**ğŸ“Š æ€§èƒ½å¯¹æ¯”æ•°æ®**
```
æ‰¹é‡æ“ä½œæ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œæ–¹å¼    â”‚ 10ä¸‡æ¡è®°å½•  â”‚ é”æŒæœ‰æ—¶é—´  â”‚ ååé‡æå‡  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€æ¡æ’å…¥    â”‚   300ç§’     â”‚    é•¿       â”‚     1x      â”‚
â”‚ æ‰¹é‡æ’å…¥    â”‚    15ç§’     â”‚    çŸ­       â”‚    20x      â”‚
â”‚ LOAD DATA   â”‚     5ç§’     â”‚    æçŸ­     â”‚    60x      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ğŸ¯ ç´¢å¼•ä¼˜åŒ–å‡é”


### 5.1 ç´¢å¼•å¯¹é”å®šèŒƒå›´çš„å½±å“


**åˆç†çš„ç´¢å¼•è®¾è®¡å¯ä»¥æ˜¾è‘—å‡å°‘é”å®šçš„æ•°æ®èŒƒå›´ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚**

**ğŸ”¸ ç´¢å¼•å‡é”åŸç†**
```
ç´¢å¼•å‡é”æœºåˆ¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ— ç´¢å¼•ï¼š                            â”‚
â”‚ å…¨è¡¨æ‰«æ â†’ é”å®šå¤§é‡è®°å½•             â”‚
â”‚                                     â”‚
â”‚ æœ‰ç´¢å¼•ï¼š                            â”‚
â”‚ ç²¾ç¡®å®šä½ â†’ åªé”å®šå¿…è¦è®°å½•           â”‚
â”‚                                     â”‚
â”‚ è¦†ç›–ç´¢å¼•ï¼š                          â”‚
â”‚ é¿å…å›è¡¨ â†’ å‡å°‘é”å®šæ—¶é—´             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç´¢å¼•è®¾è®¡ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ å‡é”çš„ç´¢å¼•è®¾è®¡**
```sql
-- åœºæ™¯1ï¼šèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
-- è¡¨ç»“æ„
CREATE TABLE orders (
    order_id INT PRIMARY KEY,
    user_id INT,
    status VARCHAR(20),
    create_time DATETIME,
    amount DECIMAL(10,2)
);

-- ä¼˜åŒ–å‰ï¼šç¼ºå°‘ç´¢å¼•ï¼Œé”å®šèŒƒå›´å¤§
SELECT * FROM orders 
WHERE user_id = 1001 AND status = 'pending'
FOR UPDATE;
-- é—®é¢˜ï¼šå¯èƒ½éœ€è¦æ‰«æå¤§é‡è®°å½•

-- ä¼˜åŒ–åï¼šåˆ›å»ºåˆé€‚ç´¢å¼•
CREATE INDEX idx_user_status ON orders(user_id, status);
-- ä¼˜åŠ¿ï¼šå¿«é€Ÿå®šä½ï¼Œå‡å°‘é”å®šèŒƒå›´

-- åœºæ™¯2ï¼šé¿å…å›è¡¨çš„è¦†ç›–ç´¢å¼•
-- æŸ¥è¯¢éœ€æ±‚
SELECT order_id, status FROM orders WHERE user_id = 1001;

-- è¦†ç›–ç´¢å¼•è®¾è®¡
CREATE INDEX idx_user_cover ON orders(user_id, order_id, status);
-- ä¼˜åŠ¿ï¼šç´¢å¼•åŒ…å«æ‰€æœ‰æŸ¥è¯¢å­—æ®µï¼Œé¿å…å›è¡¨
```

### 5.3 ç´¢å¼•ä½¿ç”¨ç›‘æ§


**ğŸ“Š ç´¢å¼•æ•ˆæœåˆ†æ**
```sql
-- åˆ†ææŸ¥è¯¢çš„é”å®šæƒ…å†µ
EXPLAIN FORMAT=JSON 
SELECT * FROM orders WHERE user_id = 1001 FOR UPDATE;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    object_schema,
    object_name,
    index_name,
    count_read,
    count_write,
    sum_timer_wait/1000000000 as total_wait_seconds
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'your_database'
ORDER BY sum_timer_wait DESC;

-- æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    schema_name,
    table_name,
    index_name
FROM information_schema.statistics s
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage p
    ON s.table_schema = p.object_schema 
    AND s.table_name = p.object_name 
    AND s.index_name = p.index_name
WHERE p.index_name IS NULL 
    AND s.table_schema = 'your_database';
```

### 5.4 ç´¢å¼•ä¼˜åŒ–å®ä¾‹


**ğŸ”§ å®é™…ä¼˜åŒ–æ¡ˆä¾‹**
```java
public class IndexOptimizationExample {
    
    // ä¼˜åŒ–å‰ï¼šæ…¢æŸ¥è¯¢å¯¼è‡´é•¿æ—¶é—´æŒé”
    public List<Order> getOrdersSlow(int userId, String status) {
        String sql = "SELECT * FROM orders WHERE user_id = ? AND status = ?";
        // é—®é¢˜ï¼šæ²¡æœ‰åˆé€‚ç´¢å¼•ï¼Œæ‰«æå¤§é‡æ•°æ®
        return queryForList(sql, userId, status);
    }
    
    // ä¼˜åŒ–åï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•
    public List<Order> getOrdersFast(int userId, String status) {
        // ç¡®ä¿å­˜åœ¨ç´¢å¼•ï¼šidx_user_status_cover(user_id, status, order_id, amount)
        String sql = "SELECT order_id, user_id, status, amount " +
                    "FROM orders WHERE user_id = ? AND status = ?";
        // ä¼˜åŠ¿ï¼šè¦†ç›–ç´¢å¼•ï¼Œå¿«é€Ÿè¿”å›ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´
        return queryForList(sql, userId, status);
    }
}
```

---

## 6. ğŸ”— è¿æ¥æ± é…ç½®


### 6.1 è¿æ¥æ± å¯¹å¹¶å‘æ€§èƒ½çš„å½±å“


**åˆç†çš„è¿æ¥æ± é…ç½®ç›´æ¥å½±å“æ•°æ®åº“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚**

**ğŸ”¸ è¿æ¥æ± çš„ä½œç”¨**
```
è¿æ¥æ± ä¼˜åŒ–ç›®æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‡å°‘è¿æ¥å¼€é”€ï¼š                   â”‚
â”‚    å¤ç”¨è¿æ¥ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯       â”‚
â”‚                                     â”‚
â”‚ 2. æ§åˆ¶å¹¶å‘æ•°ï¼š                     â”‚
â”‚    é˜²æ­¢è¿‡å¤šè¿æ¥å‹å®æ•°æ®åº“           â”‚
â”‚                                     â”‚
â”‚ 3. æé«˜å“åº”é€Ÿåº¦ï¼š                   â”‚
â”‚    é¢„åˆ›å»ºè¿æ¥ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´         â”‚
â”‚                                     â”‚
â”‚ 4. èµ„æºä¿æŠ¤ï¼š                       â”‚
â”‚    é˜²æ­¢è¿æ¥æ³„æ¼ï¼Œä¿æŠ¤æ•°æ®åº“ç¨³å®š     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è¿æ¥æ± å‚æ•°ä¼˜åŒ–


**âš™ï¸ å…³é”®å‚æ•°é…ç½®**
```java
// HikariCPè¿æ¥æ± é…ç½®ç¤ºä¾‹
public class ConnectionPoolConfig {
    
    public DataSource createOptimizedDataSource() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€è¿æ¥é…ç½®
        config.setJdbcUrl("jdbc:mysql://localhost:3306/db");
        config.setUsername("user");
        config.setPassword("password");
        
        // è¿æ¥æ± å¤§å°é…ç½®
        config.setMinimumIdle(10);          // æœ€å°ç©ºé—²è¿æ¥æ•°
        config.setMaximumPoolSize(50);      // æœ€å¤§è¿æ¥æ•°
        
        // è¿æ¥è¶…æ—¶é…ç½®
        config.setConnectionTimeout(30000); // 30ç§’è¿æ¥è¶…æ—¶
        config.setIdleTimeout(600000);      // 10åˆ†é’Ÿç©ºé—²è¶…æ—¶
        config.setMaxLifetime(1800000);     // 30åˆ†é’Ÿæœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        
        // æ€§èƒ½ä¼˜åŒ–é…ç½®
        config.setLeakDetectionThreshold(60000); // è¿æ¥æ³„æ¼æ£€æµ‹
        config.setValidationTimeout(5000);       // è¿æ¥éªŒè¯è¶…æ—¶
        
        return new HikariDataSource(config);
    }
}
```

### 6.3 è¿æ¥æ± å¤§å°è®¡ç®—


**ğŸ“Š è¿æ¥æ± å¤§å°ä¼˜åŒ–**
```
è¿æ¥æ± å¤§å°è®¡ç®—å…¬å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç†è®ºæœ€ä¼˜è¿æ¥æ•° = CPUæ ¸å¿ƒæ•° Ã— 2       â”‚
â”‚                                     â”‚
â”‚ å®é™…è€ƒè™‘å› ç´ ï¼š                      â”‚
â”‚ - åº”ç”¨æœåŠ¡å™¨æ•°é‡                    â”‚
â”‚ - å¹³å‡äº‹åŠ¡æ‰§è¡Œæ—¶é—´                  â”‚
â”‚ - ç›®æ ‡å“åº”æ—¶é—´                      â”‚
â”‚ - æ•°æ®åº“æœåŠ¡å™¨æ€§èƒ½                  â”‚
â”‚                                     â”‚
â”‚ æ¨èé…ç½®ï¼š                          â”‚
â”‚ æœ€å°è¿æ¥æ•° = æ ¸å¿ƒæ•°                 â”‚
â”‚ æœ€å¤§è¿æ¥æ•° = æ ¸å¿ƒæ•° Ã— (2-4)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ§ª è¿æ¥æ± æ€§èƒ½æµ‹è¯•**
```java
public class ConnectionPoolTuning {
    
    // è¿æ¥æ± å‹åŠ›æµ‹è¯•
    public void performanceTest() {
        // æµ‹è¯•ä¸åŒè¿æ¥æ± å¤§å°çš„æ€§èƒ½
        int[] poolSizes = {10, 20, 50, 100, 200};
        
        for (int poolSize : poolSizes) {
            DataSource ds = createDataSource(poolSize);
            
            // å¹¶å‘æµ‹è¯•
            long startTime = System.currentTimeMillis();
            ExecutorService executor = Executors.newFixedThreadPool(100);
            
            for (int i = 0; i < 1000; i++) {
                executor.submit(() -> {
                    try (Connection conn = ds.getConnection()) {
                        executeQuery(conn);
                    } catch (SQLException e) {
                        // è®°å½•é”™è¯¯
                    }
                });
            }
            
            long duration = System.currentTimeMillis() - startTime;
            System.out.printf("æ± å¤§å°: %d, è€—æ—¶: %d ms%n", poolSize, duration);
        }
    }
}
```

### 6.4 è¿æ¥æ± ç›‘æ§


**ğŸ“Š ç›‘æ§å…³é”®æŒ‡æ ‡**
```sql
-- MySQLè¿æ¥çŠ¶æ€ç›‘æ§
SHOW PROCESSLIST;

-- æŸ¥çœ‹è¿æ¥æ•°ç»Ÿè®¡
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Threads_running';
SHOW STATUS LIKE 'Max_used_connections';

-- è¿æ¥æ± æ€§èƒ½æŒ‡æ ‡
SELECT 
    COUNT(*) as total_connections,
    SUM(CASE WHEN command = 'Sleep' THEN 1 ELSE 0 END) as idle_connections,
    SUM(CASE WHEN command != 'Sleep' THEN 1 ELSE 0 END) as active_connections
FROM information_schema.processlist;
```

---

## 7. ğŸ“ äº‹åŠ¡å¤§å°æ§åˆ¶


### 7.1 äº‹åŠ¡å¤§å°å¯¹æ€§èƒ½çš„å½±å“


**äº‹åŠ¡å¤§å°ç›´æ¥å½±å“é”æŒæœ‰æ—¶é—´å’Œç³»ç»Ÿå¹¶å‘åº¦ã€‚**

**âš ï¸ å¤§äº‹åŠ¡çš„é—®é¢˜**
```
å¤§äº‹åŠ¡çš„è´Ÿé¢å½±å“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é•¿æ—¶é—´æŒé”ï¼š                     â”‚
â”‚    é˜»å¡å…¶ä»–äº‹åŠ¡ï¼Œé™ä½å¹¶å‘åº¦         â”‚
â”‚                                     â”‚
â”‚ 2. å›æ»šä»£ä»·é«˜ï¼š                     â”‚
â”‚    å¤±è´¥æ—¶éœ€è¦æ’¤é”€å¤§é‡æ“ä½œ           â”‚
â”‚                                     â”‚
â”‚ 3. å†…å­˜æ¶ˆè€—å¤§ï¼š                     â”‚
â”‚    undoæ—¥å¿—å ç”¨å¤§é‡å†…å­˜             â”‚
â”‚                                     â”‚
â”‚ 4. æ­»é”é£é™©é«˜ï¼š                     â”‚
â”‚    æ¶‰åŠèµ„æºå¤šï¼Œæ›´æ˜“å½¢æˆæ­»é”         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 äº‹åŠ¡æ‹†åˆ†ç­–ç•¥


**ğŸ”§ æ™ºèƒ½äº‹åŠ¡æ‹†åˆ†**
```java
public class TransactionSizeOptimizer {
    
    // ä¼˜åŒ–å‰ï¼šå¤§äº‹åŠ¡å¤„ç†
    @Transactional
    public void processBigTransaction(List<Order> orders) {
        // é—®é¢˜ï¼šä¸€æ¬¡æ€§å¤„ç†10ä¸‡ä¸ªè®¢å•
        for (Order order : orders) {
            validateOrder(order);
            updateInventory(order);
            createInvoice(order);
            sendNotification(order);
        }
        // æŒé”æ—¶é—´å¯èƒ½é•¿è¾¾æ•°åˆ†é’Ÿ
    }
    
    // ä¼˜åŒ–åï¼šå°æ‰¹é‡äº‹åŠ¡
    public void processInBatches(List<Order> orders) {
        int batchSize = 100;  // æ¯æ‰¹å¤„ç†100ä¸ªè®¢å•
        
        for (int i = 0; i < orders.size(); i += batchSize) {
            List<Order> batch = orders.subList(i, 
                Math.min(i + batchSize, orders.size()));
            
            processBatch(batch);  // æ¯æ‰¹ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡
        }
    }
    
    @Transactional
    public void processBatch(List<Order> batch) {
        // å°äº‹åŠ¡ï¼šå¤„ç†100ä¸ªè®¢å•ï¼ŒæŒé”æ—¶é—´çŸ­
        for (Order order : batch) {
            validateOrder(order);
            updateInventory(order);
            createInvoice(order);
        }
        // é€šçŸ¥ç­‰éå…³é”®æ“ä½œæ”¾åœ¨äº‹åŠ¡å¤–
        for (Order order : batch) {
            sendNotificationAsync(order);
        }
    }
}
```

### 7.3 äº‹åŠ¡è¾¹ç•Œä¼˜åŒ–


**ğŸ¯ ç²¾ç¡®æ§åˆ¶äº‹åŠ¡è¾¹ç•Œ**
```sql
-- ä¼˜åŒ–å‰ï¼šäº‹åŠ¡è¾¹ç•Œè¿‡å¤§
BEGIN;
SELECT user_info FROM users WHERE user_id = 1001;
-- å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¯èƒ½å¾ˆè€—æ—¶ï¼‰
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1001;
INSERT INTO transaction_log (user_id, amount, type) VALUES (1001, -100, 'debit');
COMMIT;

-- ä¼˜åŒ–åï¼šæœ€å°åŒ–äº‹åŠ¡è¾¹ç•Œ
-- æ­¥éª¤1ï¼šäº‹åŠ¡å¤–çš„å‡†å¤‡å·¥ä½œ
SELECT user_info FROM users WHERE user_id = 1001;
-- ä¸šåŠ¡é€»è¾‘éªŒè¯å’Œè®¡ç®—

-- æ­¥éª¤2ï¼šæœ€å°äº‹åŠ¡
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1001;
INSERT INTO transaction_log (user_id, amount, type) VALUES (1001, -100, 'debit');
COMMIT;

-- æ­¥éª¤3ï¼šäº‹åŠ¡åçš„æ¸…ç†å·¥ä½œ
-- å‘é€é€šçŸ¥ã€æ›´æ–°ç¼“å­˜ç­‰
```

### 7.4 äº‹åŠ¡å¤§å°ç›‘æ§


**ğŸ“Š äº‹åŠ¡æ€§èƒ½ç›‘æ§**
```sql
-- ç›‘æ§é•¿äº‹åŠ¡
SELECT 
    trx_id,
    trx_state,
    trx_started,
    TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration_seconds,
    trx_tables_in_use,
    trx_tables_locked,
    trx_lock_structs,
    trx_rows_locked
FROM information_schema.INNODB_TRX
WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 10
ORDER BY duration_seconds DESC;

-- äº‹åŠ¡ç­‰å¾…åˆ†æ
SELECT 
    waiting_trx_id,
    waiting_pid,
    blocking_trx_id,
    blocking_pid,
    wait_started,
    TIMESTAMPDIFF(SECOND, wait_started, NOW()) as wait_duration
FROM information_schema.INNODB_LOCK_WAITS;
```

---

## 8. âš™ï¸ å¹¶å‘åº¦è°ƒä¼˜


### 8.1 å¹¶å‘åº¦æ§åˆ¶å‚æ•°


**MySQLæä¾›äº†å¤šä¸ªå‚æ•°æ¥æ§åˆ¶ç³»ç»Ÿçš„å¹¶å‘åº¦ã€‚**

**ğŸ”¸ å…³é”®å¹¶å‘å‚æ•°**
```sql
-- æŸ¥çœ‹å½“å‰å¹¶å‘è®¾ç½®
SHOW VARIABLES LIKE 'innodb_thread_concurrency';
SHOW VARIABLES LIKE 'max_connections';
SHOW VARIABLES LIKE 'thread_cache_size';

-- InnoDBå¹¶å‘è®¾ç½®
SET GLOBAL innodb_thread_concurrency = 16;    -- InnoDBå¹¶å‘çº¿ç¨‹æ•°
SET GLOBAL innodb_concurrency_tickets = 5000; -- å¹¶å‘ç¥¨æ®æ•°é‡
SET GLOBAL innodb_commit_concurrency = 0;     -- æäº¤å¹¶å‘æ•°

-- è¿æ¥ç›¸å…³è®¾ç½®
SET GLOBAL max_connections = 500;             -- æœ€å¤§è¿æ¥æ•°
SET GLOBAL max_user_connections = 100;        -- æ¯ç”¨æˆ·æœ€å¤§è¿æ¥æ•°
SET GLOBAL thread_cache_size = 50;            -- çº¿ç¨‹ç¼“å­˜å¤§å°
```

### 8.2 åŠ¨æ€å¹¶å‘åº¦è°ƒæ•´


**âš¡ è‡ªé€‚åº”å¹¶å‘æ§åˆ¶**
```java
public class ConcurrencyTuner {
    
    private static final int MIN_CONCURRENCY = 8;
    private static final int MAX_CONCURRENCY = 64;
    
    // åŠ¨æ€è°ƒæ•´å¹¶å‘åº¦
    public void adjustConcurrency() {
        DatabaseMetrics metrics = collectMetrics();
        
        int currentConcurrency = getCurrentConcurrency();
        int newConcurrency = calculateOptimalConcurrency(metrics);
        
        if (Math.abs(newConcurrency - currentConcurrency) > 2) {
            setConcurrency(newConcurrency);
            logConcurrencyChange(currentConcurrency, newConcurrency);
        }
    }
    
    private int calculateOptimalConcurrency(DatabaseMetrics metrics) {
        // åŸºäºCPUä½¿ç”¨ç‡è°ƒæ•´
        if (metrics.getCpuUsage() > 0.9) {
            return Math.max(MIN_CONCURRENCY, 
                          getCurrentConcurrency() - 4);
        }
        
        // åŸºäºé”ç­‰å¾…æƒ…å†µè°ƒæ•´
        if (metrics.getAvgLockWaitTime() > 100) {
            return Math.max(MIN_CONCURRENCY, 
                          getCurrentConcurrency() - 2);
        }
        
        // åŸºäºååé‡è°ƒæ•´
        if (metrics.getThroughput() > metrics.getTargetThroughput()) {
            return Math.min(MAX_CONCURRENCY, 
                          getCurrentConcurrency() + 2);
        }
        
        return getCurrentConcurrency();
    }
}
```

### 8.3 å¹¶å‘åº¦æµ‹è¯•æ–¹æ³•


**ğŸ§ª å¹¶å‘æ€§èƒ½åŸºå‡†æµ‹è¯•**
```java
public class ConcurrencyBenchmark {
    
    public void benchmarkConcurrency() {
        int[] concurrencyLevels = {4, 8, 16, 32, 64, 128};
        
        for (int concurrency : concurrencyLevels) {
            setConcurrencyLevel(concurrency);
            
            // é¢„çƒ­
            warmup();
            
            // æµ‹è¯•
            BenchmarkResult result = runBenchmark(concurrency);
            
            System.out.printf("å¹¶å‘åº¦: %d, TPS: %.2f, å“åº”æ—¶é—´: %.2f ms%n",
                concurrency, result.getTps(), result.getAvgResponseTime());
        }
    }
    
    private BenchmarkResult runBenchmark(int concurrency) {
        ExecutorService executor = Executors.newFixedThreadPool(concurrency);
        CountDownLatch latch = new CountDownLatch(concurrency * 100);
        
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < concurrency * 100; i++) {
            executor.submit(() -> {
                try {
                    executeTestQuery();
                } finally {
                    latch.countDown();
                }
            });
        }
        
        latch.await();
        long duration = System.currentTimeMillis() - startTime;
        
        return new BenchmarkResult(concurrency * 100 * 1000.0 / duration, 
                                 duration / (concurrency * 100.0));
    }
}
```

---

## 9. ğŸ” èµ„æºäº‰ç”¨åˆ†æ


### 9.1 è¯†åˆ«èµ„æºäº‰ç”¨çƒ­ç‚¹


**èµ„æºäº‰ç”¨åˆ†ææ˜¯ä¼˜åŒ–å¹¶å‘æ€§èƒ½çš„å…³é”®æ­¥éª¤ã€‚**

**ğŸ”¸ å¸¸è§äº‰ç”¨ç±»å‹**
```
èµ„æºäº‰ç”¨åˆ†æç»´åº¦ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é”äº‰ç”¨ï¼š                         â”‚
â”‚    è¡Œé”ã€è¡¨é”ã€é—´éš™é”ç­‰ç­‰å¾…æƒ…å†µ     â”‚
â”‚                                     â”‚
â”‚ 2. I/Oäº‰ç”¨ï¼š                        â”‚
â”‚    ç£ç›˜è¯»å†™ã€å†…å­˜é¡µé¢ç«äº‰           â”‚
â”‚                                     â”‚
â”‚ 3. CPUäº‰ç”¨ï¼š                        â”‚
â”‚    é«˜CPUä½¿ç”¨ç‡ã€ä¸Šä¸‹æ–‡åˆ‡æ¢          â”‚
â”‚                                     â”‚
â”‚ 4. å†…å­˜äº‰ç”¨ï¼š                       â”‚
â”‚    ç¼“å†²æ± å‘½ä¸­ç‡ã€å†…å­˜åˆ†é…           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 äº‰ç”¨åˆ†æå·¥å…·


**ğŸ”§ åˆ†æå·¥å…·å’Œæ–¹æ³•**
```sql
-- é”äº‰ç”¨åˆ†æ
SELECT 
    object_schema,
    object_name,
    lock_type,
    lock_mode,
    COUNT(*) as lock_count
FROM performance_schema.data_locks
GROUP BY object_schema, object_name, lock_type, lock_mode
ORDER BY lock_count DESC;

-- I/Oäº‰ç”¨åˆ†æ
SELECT 
    file_name,
    event_name,
    COUNT_READ,
    COUNT_WRITE,
    SUM_TIMER_READ/1000000000 as read_time_seconds,
    SUM_TIMER_WRITE/1000000000 as write_time_seconds
FROM performance_schema.file_summary_by_instance
ORDER BY (SUM_TIMER_READ + SUM_TIMER_WRITE) DESC
LIMIT 10;

-- çƒ­ç‚¹è¡¨åˆ†æ
SELECT 
    object_schema,
    object_name,
    COUNT_READ + COUNT_WRITE as total_operations,
    COUNT_READ,
    COUNT_WRITE
FROM performance_schema.table_io_waits_summary_by_table
ORDER BY total_operations DESC
LIMIT 10;
```

### 9.3 äº‰ç”¨è§£å†³ç­–ç•¥


**âš¡ é’ˆå¯¹æ€§ä¼˜åŒ–æ–¹æ¡ˆ**
```java
public class ContentionResolver {
    
    // è§£å†³é”äº‰ç”¨
    public void resolveLockContention() {
        // ç­–ç•¥1ï¼šæ‹†åˆ†çƒ­ç‚¹è¡¨
        partitionHotTable();
        
        // ç­–ç•¥2ï¼šä¼˜åŒ–æŸ¥è¯¢ï¼Œå‡å°‘é”å®šèŒƒå›´
        optimizeQuerySelectivity();
        
        // ç­–ç•¥3ï¼šè°ƒæ•´äº‹åŠ¡éš”ç¦»çº§åˆ«
        adjustIsolationLevel();
    }
    
    // è§£å†³I/Oäº‰ç”¨
    public void resolveIOContention() {
        // ç­–ç•¥1ï¼šå¢åŠ ç¼“å†²æ± å¤§å°
        increaseBufferPoolSize();
        
        // ç­–ç•¥2ï¼šä½¿ç”¨SSDå­˜å‚¨
        migrateTofasterStorage();
        
        // ç­–ç•¥3ï¼šä¼˜åŒ–ç´¢å¼•è®¾è®¡
        optimizeIndexes();
    }
    
    // è§£å†³CPUäº‰ç”¨
    public void resolveCPUContention() {
        // ç­–ç•¥1ï¼šå‡å°‘ä¸å¿…è¦çš„è®¡ç®—
        optimizeBusinessLogic();
        
        // ç­–ç•¥2ï¼šä½¿ç”¨è¯»å†™åˆ†ç¦»
        implementReadWriteSplit();
        
        // ç­–ç•¥3ï¼šè°ƒæ•´å¹¶å‘å‚æ•°
        tuneConcurrencyParameters();
    }
}
```

### 9.4 äº‰ç”¨ç›‘æ§å‘Šè­¦


**ğŸ“Š å®æ—¶ç›‘æ§ä½“ç³»**
```java
public class ContentionMonitor {
    
    // äº‰ç”¨ç›‘æ§æŒ‡æ ‡
    public class ContentionMetrics {
        private double lockWaitRatio;      // é”ç­‰å¾…æ¯”ä¾‹
        private double bufferHitRatio;     // ç¼“å†²åŒºå‘½ä¸­ç‡
        private double cpuUsage;           // CPUä½¿ç”¨ç‡
        private int activeConnections;     // æ´»è·ƒè¿æ¥æ•°
        
        public boolean hasContention() {
            return lockWaitRatio > 0.1 ||     // é”ç­‰å¾…è¶…è¿‡10%
                   bufferHitRatio < 0.95 ||   // ç¼“å†²å‘½ä¸­ç‡ä½äº95%
                   cpuUsage > 0.8 ||          // CPUä½¿ç”¨ç‡è¶…è¿‡80%
                   activeConnections > 200;   // æ´»è·ƒè¿æ¥è¿‡å¤š
        }
    }
    
    // è‡ªåŠ¨å‘Šè­¦
    public void checkAndAlert() {
        ContentionMetrics metrics = collectMetrics();
        
        if (metrics.hasContention()) {
            String alertMessage = buildAlertMessage(metrics);
            sendAlert(alertMessage);
            
            // è‡ªåŠ¨è§¦å‘ä¼˜åŒ–æªæ–½
            triggerAutoOptimization(metrics);
        }
    }
}
```

---

## 10. ğŸ—ï¸ æ€§èƒ½ä¼˜åŒ–å®Œæ•´ä½“ç³»


### 10.1 ä¼˜åŒ–ä½“ç³»æ¶æ„


**æ„å»ºç³»ç»Ÿæ€§çš„æ€§èƒ½ä¼˜åŒ–æ¡†æ¶ã€‚**

**ğŸ”¸ ä¼˜åŒ–å±‚æ¬¡ç»“æ„**
```
æ€§èƒ½ä¼˜åŒ–ä½“ç³»æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨å±‚ä¼˜åŒ–ï¼š                        â”‚
â”‚ - è¿æ¥æ± é…ç½®                        â”‚
â”‚ - äº‹åŠ¡è®¾è®¡                          â”‚
â”‚ - æ‰¹é‡æ“ä½œ                          â”‚
â”‚                                     â”‚
â”‚ SQLå±‚ä¼˜åŒ–ï¼š                         â”‚
â”‚ - æŸ¥è¯¢ä¼˜åŒ–                          â”‚
â”‚ - ç´¢å¼•è®¾è®¡                          â”‚
â”‚ - é”ç­–ç•¥                            â”‚
â”‚                                     â”‚
â”‚ æ•°æ®åº“å±‚ä¼˜åŒ–ï¼š                      â”‚
â”‚ - å‚æ•°è°ƒä¼˜                          â”‚
â”‚ - å­˜å‚¨å¼•æ“                          â”‚
â”‚ - æ¶æ„è®¾è®¡                          â”‚
â”‚                                     â”‚
â”‚ ç³»ç»Ÿå±‚ä¼˜åŒ–ï¼š                        â”‚
â”‚ - ç¡¬ä»¶é…ç½®                          â”‚
â”‚ - æ“ä½œç³»ç»Ÿ                          â”‚
â”‚ - ç½‘ç»œé…ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 ä¼˜åŒ–æµç¨‹è®¾è®¡


**ğŸ“‹ æ ‡å‡†åŒ–ä¼˜åŒ–æµç¨‹**
```java
public class PerformanceOptimizationFramework {
    
    // ä¼˜åŒ–æµç¨‹æ‰§è¡Œå™¨
    public class OptimizationPipeline {
        
        public void executeOptimization() {
            // é˜¶æ®µ1ï¼šæ€§èƒ½åŸºçº¿æµ‹è¯•
            PerformanceBaseline baseline = establishBaseline();
            
            // é˜¶æ®µ2ï¼šç“¶é¢ˆè¯†åˆ«
            List<Bottleneck> bottlenecks = identifyBottlenecks();
            
            // é˜¶æ®µ3ï¼šä¼˜åŒ–ç­–ç•¥åˆ¶å®š
            OptimizationPlan plan = createOptimizationPlan(bottlenecks);
            
            // é˜¶æ®µ4ï¼šåˆ†æ­¥éª¤æ‰§è¡Œä¼˜åŒ–
            for (OptimizationStep step : plan.getSteps()) {
                executeStep(step);
                validateImprovement(step, baseline);
            }
            
            // é˜¶æ®µ5ï¼šæ•ˆæœè¯„ä¼°
            PerformanceReport report = generateReport(baseline);
            
            // é˜¶æ®µ6ï¼šæŒç»­ç›‘æ§
            enableContinuousMonitoring();
        }
    }
    
    // ä¼˜åŒ–ç­–ç•¥é€‰æ‹©å™¨
    public OptimizationStrategy selectStrategy(Bottleneck bottleneck) {
        switch (bottleneck.getType()) {
            case LOCK_CONTENTION:
                return new LockOptimizationStrategy();
            case IO_BOTTLENECK:
                return new IOOptimizationStrategy();
            case CPU_BOTTLENECK:
                return new CPUOptimizationStrategy();
            case MEMORY_PRESSURE:
                return new MemoryOptimizationStrategy();
            default:
                return new GeneralOptimizationStrategy();
        }
    }
}
```

### 10.3 ä¼˜åŒ–æ•ˆæœè¯„ä¼°


**ğŸ“Š é‡åŒ–è¯„ä¼°ä½“ç³»**
```java
public class OptimizationEvaluator {
    
    // æ€§èƒ½æŒ‡æ ‡å®šä¹‰
    public class PerformanceMetrics {
        private double throughput;         // ååé‡ (TPS)
        private double responseTime;       // å“åº”æ—¶é—´ (ms)
        private double cpuUtilization;     // CPUåˆ©ç”¨ç‡
        private double lockWaitTime;       // é”ç­‰å¾…æ—¶é—´
        private int concurrentUsers;       // å¹¶å‘ç”¨æˆ·æ•°
        
        // è®¡ç®—æ€§èƒ½åˆ†æ•°
        public double calculateScore() {
            return (throughput * 0.4) +
                   ((1000.0 / responseTime) * 0.3) +
                   (cpuUtilization * 0.2) +
                   ((1.0 - lockWaitTime / 1000.0) * 0.1);
        }
    }
    
    // ä¼˜åŒ–æ•ˆæœè¯„ä¼°
    public OptimizationResult evaluateOptimization(
            PerformanceMetrics before, 
            PerformanceMetrics after) {
        
        double improvement = 
            (after.calculateScore() - before.calculateScore()) 
            / before.calculateScore() * 100;
        
        return new OptimizationResult(
            improvement,
            before,
            after,
            improvement > 10 ? "æ˜¾è‘—æ”¹å–„" : "æ”¹å–„æœ‰é™"
        );
    }
}
```

---

## 11. ğŸ¯ ä¼˜åŒ–ç­–ç•¥é€‰æ‹©


### 11.1 åœºæ™¯åŒ–ä¼˜åŒ–ç­–ç•¥


**æ ¹æ®ä¸åŒä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç­–ç•¥ã€‚**

**ğŸ”¸ ç­–ç•¥é€‰æ‹©çŸ©é˜µ**
```
ä¼˜åŒ–ç­–ç•¥é€‰æ‹©çŸ©é˜µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡ç‰¹å¾    â”‚ ä¸»è¦ç“¶é¢ˆ    â”‚ ä¼˜åŒ–é‡ç‚¹    â”‚ æ¨èç­–ç•¥    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯»å¯†é›†å‹    â”‚ æŸ¥è¯¢æ€§èƒ½    â”‚ ç´¢å¼•ä¼˜åŒ–    â”‚ è¯»å†™åˆ†ç¦»    â”‚
â”‚ å†™å¯†é›†å‹    â”‚ é”äº‰ç”¨      â”‚ æ‰¹é‡æ“ä½œ    â”‚ åˆ†åº“åˆ†è¡¨    â”‚
â”‚ äº‹åŠ¡å¯†é›†    â”‚ é”ç­‰å¾…      â”‚ äº‹åŠ¡ä¼˜åŒ–    â”‚ éš”ç¦»çº§åˆ«    â”‚
â”‚ é«˜å¹¶å‘      â”‚ è¿æ¥æ•°      â”‚ è¿æ¥æ±       â”‚ è´Ÿè½½å‡è¡¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 ä¼˜åŒ–ç­–ç•¥å†³ç­–æ ‘


**ğŸŒ³ å†³ç­–æµç¨‹å›¾**
```java
public class OptimizationStrategySelector {
    
    public OptimizationStrategy selectStrategy(WorkloadCharacteristics workload) {
        // å†³ç­–æ ‘é€»è¾‘
        if (workload.getReadWriteRatio() > 0.8) {
            // è¯»å¯†é›†å‹è´Ÿè½½
            if (workload.getConcurrency() > 1000) {
                return new ReadScaleOutStrategy();  // è¯»æ‰©å±•ç­–ç•¥
            } else {
                return new IndexOptimizationStrategy();  // ç´¢å¼•ä¼˜åŒ–
            }
        } else if (workload.getWriteRatio() > 0.6) {
            // å†™å¯†é›†å‹è´Ÿè½½
            if (workload.hasHotspots()) {
                return new ShardingStrategy();  // åˆ†ç‰‡ç­–ç•¥
            } else {
                return new BatchOptimizationStrategy();  // æ‰¹é‡ä¼˜åŒ–
            }
        } else {
            // æ··åˆè´Ÿè½½
            return new ComprehensiveOptimizationStrategy();  // ç»¼åˆä¼˜åŒ–
        }
    }
    
    // ç­–ç•¥ç»„åˆé€‰æ‹©
    public List<OptimizationStrategy> selectMultipleStrategies(
            PerformanceProfile profile) {
        List<OptimizationStrategy> strategies = new ArrayList<>();
        
        // åŸºç¡€ä¼˜åŒ–ï¼ˆæ€»æ˜¯æ‰§è¡Œï¼‰
        strategies.add(new BasicTuningStrategy());
        
        // æ ¹æ®ç“¶é¢ˆæ·»åŠ ç‰¹å®šç­–ç•¥
        if (profile.hasLockContention()) {
            strategies.add(new LockOptimizationStrategy());
        }
        
        if (profile.hasIOBottleneck()) {
            strategies.add(new IOOptimizationStrategy());
        }
        
        if (profile.hasHighConcurrency()) {
            strategies.add(new ConcurrencyTuningStrategy());
        }
        
        return strategies;
    }
}
```

### 11.3 ç­–ç•¥å®æ–½ä¼˜å…ˆçº§


**ğŸ“ˆ ä¼˜åŒ–ä¼˜å…ˆçº§æ’åº**
```
ä¼˜åŒ–ç­–ç•¥ä¼˜å…ˆçº§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰ï¼š              â”‚
â”‚ 1. ä¿®å¤æ˜æ˜¾çš„SQLæ€§èƒ½é—®é¢˜            â”‚
â”‚ 2. æ·»åŠ ç¼ºå¤±çš„å…³é”®ç´¢å¼•               â”‚
â”‚ 3. ä¼˜åŒ–é•¿äº‹åŠ¡                       â”‚
â”‚                                     â”‚
â”‚ ä¸­ä¼˜å…ˆçº§ï¼ˆè®¡åˆ’æ‰§è¡Œï¼‰ï¼š              â”‚
â”‚ 1. è°ƒæ•´è¿æ¥æ± é…ç½®                   â”‚
â”‚ 2. æ‰¹é‡æ“ä½œä¼˜åŒ–                     â”‚
â”‚ 3. å‚æ•°è°ƒä¼˜                         â”‚
â”‚                                     â”‚
â”‚ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸè§„åˆ’ï¼‰ï¼š              â”‚
â”‚ 1. æ¶æ„é‡æ„                         â”‚
â”‚ 2. ç¡¬ä»¶å‡çº§                         â”‚
â”‚ 3. åˆ†åº“åˆ†è¡¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. ğŸ“Š æ€§èƒ½ç›‘æ§è¯„ä¼°


### 12.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**å»ºç«‹å…¨é¢çš„æ€§èƒ½ç›‘æ§ä½“ç³»ã€‚**

**ğŸ”¸ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```sql
-- 1. åŸºç¡€æ€§èƒ½æŒ‡æ ‡
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME IN (
    'Threads_connected',
    'Threads_running',
    'Queries_per_second_avg',
    'Innodb_buffer_pool_reads',
    'Innodb_buffer_pool_read_requests'
);

-- 2. é”ç›‘æ§æŒ‡æ ‡
SELECT 
    COUNT(*) as active_locks,
    AVG(LOCK_DURATION) as avg_lock_duration
FROM information_schema.DATA_LOCKS;

-- 3. äº‹åŠ¡ç›‘æ§æŒ‡æ ‡
SELECT 
    COUNT(*) as active_transactions,
    AVG(TIMESTAMPDIFF(SECOND, trx_started, NOW())) as avg_transaction_time
FROM information_schema.INNODB_TRX;
```

### 12.2 è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿ


**âš™ï¸ ç›‘æ§ç³»ç»Ÿå®ç°**
```java
public class PerformanceMonitoringSystem {
    
    // ç›‘æ§æ•°æ®æ”¶é›†å™¨
    public class MetricsCollector {
        
        public DatabaseMetrics collectMetrics() {
            DatabaseMetrics metrics = new DatabaseMetrics();
            
            // æ”¶é›†åŸºç¡€æŒ‡æ ‡
            metrics.setTps(getCurrentTPS());
            metrics.setResponseTime(getAverageResponseTime());
            metrics.setCpuUsage(getCPUUsage());
            
            // æ”¶é›†é”ç›¸å…³æŒ‡æ ‡
            metrics.setLockWaitCount(getLockWaitCount());
            metrics.setDeadlockCount(getDeadlockCount());
            
            // æ”¶é›†è¿æ¥æ± æŒ‡æ ‡
            metrics.setActiveConnections(getActiveConnections());
            metrics.setConnectionUtilization(getConnectionUtilization());
            
            return metrics;
        }
    }
    
    // å¼‚å¸¸æ£€æµ‹å™¨
    public class AnomalyDetector {
        
        public List<PerformanceAnomaly> detectAnomalies(DatabaseMetrics metrics) {
            List<PerformanceAnomaly> anomalies = new ArrayList<>();
            
            // TPSå¼‚å¸¸æ£€æµ‹
            if (metrics.getTps() < expectedTPS * 0.7) {
                anomalies.add(new PerformanceAnomaly(
                    "TPSè¿‡ä½", 
                    metrics.getTps(), 
                    expectedTPS
                ));
            }
            
            // å“åº”æ—¶é—´å¼‚å¸¸æ£€æµ‹
            if (metrics.getResponseTime() > maxAcceptableResponseTime) {
                anomalies.add(new PerformanceAnomaly(
                    "å“åº”æ—¶é—´è¿‡é•¿", 
                    metrics.getResponseTime(), 
                    maxAcceptableResponseTime
                ));
            }
            
            return anomalies;
        }
    }
}
```

### 12.3 æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ


**ğŸ“Š è‡ªåŠ¨åŒ–æŠ¥å‘Šç³»ç»Ÿ**
```java
public class PerformanceReportGenerator {
    
    public PerformanceReport generateDailyReport() {
        // æ”¶é›†24å°æ—¶æ€§èƒ½æ•°æ®
        List<DatabaseMetrics> dailyMetrics = collectDailyMetrics();
        
        // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        PerformanceStatistics stats = calculateStatistics(dailyMetrics);
        
        // ç”Ÿæˆè¶‹åŠ¿åˆ†æ
        TrendAnalysis trends = analyzeTrends(dailyMetrics);
        
        // è¯†åˆ«æ€§èƒ½é—®é¢˜
        List<PerformanceIssue> issues = identifyIssues(dailyMetrics);
        
        // ç”Ÿæˆä¼˜åŒ–å»ºè®®
        List<OptimizationRecommendation> recommendations = 
            generateRecommendations(issues);
        
        return new PerformanceReport(stats, trends, issues, recommendations);
    }
    
    // æ€§èƒ½è¯„åˆ†è®¡ç®—
    public double calculatePerformanceScore(DatabaseMetrics metrics) {
        double tpsScore = Math.min(metrics.getTps() / targetTPS, 1.0) * 30;
        double responseScore = Math.max(1 - metrics.getResponseTime() / 1000, 0) * 25;
        double cpuScore = Math.max(1 - metrics.getCpuUsage(), 0) * 20;
        double lockScore = Math.max(1 - metrics.getLockWaitRatio(), 0) * 25;
        
        return tpsScore + responseScore + cpuScore + lockScore;
    }
}
```

### 12.4 æŒç»­ä¼˜åŒ–å»ºè®®


**ğŸ”„ æŒç»­æ”¹è¿›æµç¨‹**
```
æŒç»­ä¼˜åŒ–å¾ªç¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç›‘æ§æ”¶é›†ï¼š                       â”‚
â”‚    æŒç»­æ”¶é›†æ€§èƒ½æŒ‡æ ‡æ•°æ®             â”‚
â”‚                                     â”‚
â”‚ 2. åˆ†æè¯„ä¼°ï¼š                       â”‚
â”‚    å®šæœŸåˆ†ææ€§èƒ½è¶‹åŠ¿å’Œç“¶é¢ˆ           â”‚
â”‚                                     â”‚
â”‚ 3. ç­–ç•¥è°ƒæ•´ï¼š                       â”‚
â”‚    æ ¹æ®åˆ†æç»“æœè°ƒæ•´ä¼˜åŒ–ç­–ç•¥         â”‚
â”‚                                     â”‚
â”‚ 4. å®æ–½éªŒè¯ï¼š                       â”‚
â”‚    æ‰§è¡Œä¼˜åŒ–æªæ–½å¹¶éªŒè¯æ•ˆæœ           â”‚
â”‚                                     â”‚
â”‚ 5. åé¦ˆæ”¹è¿›ï¼š                       â”‚
â”‚    æ€»ç»“ç»éªŒï¼Œå®Œå–„ä¼˜åŒ–æ–¹æ³•           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 13. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 13.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹¶å‘ä¼˜åŒ–æœ¬è´¨ï¼šé€šè¿‡å‡å°‘èµ„æºäº‰ç”¨ï¼Œæé«˜ç³»ç»Ÿå¹¶è¡Œå¤„ç†èƒ½åŠ›
ğŸ”¸ é”ç²’åº¦ä¼˜åŒ–ï¼šé€‰æ‹©åˆé€‚çš„é”ç²’åº¦ï¼Œå¹³è¡¡å¹¶å‘åº¦å’Œä¸€è‡´æ€§
ğŸ”¸ äº‹åŠ¡æ§åˆ¶ï¼šæ§åˆ¶äº‹åŠ¡å¤§å°å’ŒæŒæœ‰æ—¶é—´ï¼Œå‡å°‘é”äº‰ç”¨
ğŸ”¸ æ‰¹é‡æ“ä½œï¼šé€šè¿‡æ‰¹é‡å¤„ç†å‡å°‘äº‹åŠ¡å¼€é”€ï¼Œæå‡æ€§èƒ½
ğŸ”¸ è¿æ¥æ± é…ç½®ï¼šåˆç†é…ç½®è¿æ¥æ± å‚æ•°ï¼Œæ§åˆ¶å¹¶å‘æ•°
ğŸ”¸ ç›‘æ§è¯„ä¼°ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒæŒç»­ä¼˜åŒ–æ€§èƒ½
```

### 13.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¹¶å‘ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**
```
ä¼˜åŒ–æ€è·¯ï¼š
å‡å°‘äº‰ç”¨ â†’ ç¼©çŸ­ç­‰å¾… â†’ æé«˜å¹¶å‘åº¦ â†’ æå‡æ€§èƒ½
```

**ğŸ”¹ ä¼˜åŒ–ç­–ç•¥çš„é€‰æ‹©åŸåˆ™**
```
é€‰æ‹©åŸåˆ™ï¼š
1. å…ˆè§£å†³æ˜æ˜¾ç“¶é¢ˆ
2. ä¼˜å…ˆä½æˆæœ¬é«˜æ”¶ç›Šæ–¹æ¡ˆ
3. æ ¹æ®ä¸šåŠ¡ç‰¹å¾å®šåˆ¶ç­–ç•¥
4. æŒç»­ç›‘æ§å’Œè°ƒæ•´
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å¹³è¡¡ç‚¹**
```
å¹³è¡¡è€ƒè™‘ï¼š
ä¸€è‡´æ€§ vs æ€§èƒ½ï¼šé€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
èµ„æºæ¶ˆè€— vs æ•ˆæœï¼šè¯„ä¼°ä¼˜åŒ–çš„æŠ•å…¥äº§å‡ºæ¯”
å¤æ‚åº¦ vs ç»´æŠ¤æ€§ï¼šé¿å…è¿‡åº¦ä¼˜åŒ–å¢åŠ å¤æ‚åº¦
```

### 13.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ä¼˜åŒ–å®æ–½å»ºè®®**
- **å¾ªåºæ¸è¿›**ï¼šä»åŸºç¡€ä¼˜åŒ–å¼€å§‹ï¼Œé€æ­¥æ·±å…¥
- **é‡åŒ–è¯„ä¼°**ï¼šç”¨æ•°æ®è¯´è¯ï¼Œå®¢è§‚è¯„ä¼°æ•ˆæœ
- **ç›‘æ§é©±åŠ¨**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›è¡Œä¼˜åŒ–å†³ç­–
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ä¼˜åŒ–è¿‡ç¨‹å’Œæ•ˆæœï¼Œä¾¿äºåç»­å‚è€ƒ

**ğŸ”§ å¸¸è§ä¼˜åŒ–è¯¯åŒº**
- **è¿‡åº¦ä¼˜åŒ–**ï¼šåœ¨æ€§èƒ½å·²è¶³å¤Ÿçš„æƒ…å†µä¸‹è¿‡åº¦ä¼˜åŒ–
- **ç›²ç›®è°ƒå‚**ï¼šä¸ç†è§£å‚æ•°å«ä¹‰å°±éšæ„è°ƒæ•´
- **å¿½è§†ç›‘æ§**ï¼šæ²¡æœ‰å»ºç«‹æœ‰æ•ˆçš„ç›‘æ§ä½“ç³»
- **å±€éƒ¨ä¼˜åŒ–**ï¼šåªå…³æ³¨å•ç‚¹ä¼˜åŒ–ï¼Œå¿½è§†æ•´ä½“åè°ƒ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å¹¶å‘ä¼˜åŒ–è¦ç³»ç»Ÿæ€§æ€è€ƒï¼Œä¸èƒ½å¤´ç—›åŒ»å¤´
- é”ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯å‡å°‘äº‰ç”¨èŒƒå›´å’Œæ—¶é—´
- ç›‘æ§æ˜¯ä¼˜åŒ–çš„åŸºç¡€ï¼Œæ²¡æœ‰ç›‘æ§å°±æ²¡æœ‰ä¼˜åŒ–
- ä¼˜åŒ–è¦æŒç»­è¿›è¡Œï¼Œæ€§èƒ½ç®¡ç†æ˜¯é•¿æœŸå·¥ç¨‹