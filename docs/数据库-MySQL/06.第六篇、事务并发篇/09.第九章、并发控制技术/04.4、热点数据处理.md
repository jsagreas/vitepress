---
title: 4ã€çƒ­ç‚¹æ•°æ®å¤„ç†
---
## ğŸ“š ç›®å½•

1. [çƒ­ç‚¹æ•°æ®æ¦‚è¿°](#1-çƒ­ç‚¹æ•°æ®æ¦‚è¿°)
2. [çƒ­ç‚¹æ•°æ®è¯†åˆ«](#2-çƒ­ç‚¹æ•°æ®è¯†åˆ«)
3. [è¯»å†™åˆ†ç¦»ç­–ç•¥](#3-è¯»å†™åˆ†ç¦»ç­–ç•¥)
4. [ç¼“å­˜å±‚è®¾è®¡](#4-ç¼“å­˜å±‚è®¾è®¡)
5. [åˆ†ç‰‡å­˜å‚¨æ–¹æ¡ˆ](#5-åˆ†ç‰‡å­˜å‚¨æ–¹æ¡ˆ)
6. [é˜Ÿåˆ—åŒ–å¤„ç†](#6-é˜Ÿåˆ—åŒ–å¤„ç†)
7. [å¼‚æ­¥æ›´æ–°æœºåˆ¶](#7-å¼‚æ­¥æ›´æ–°æœºåˆ¶)
8. [å†²çªé¿å…ç­–ç•¥](#8-å†²çªé¿å…ç­–ç•¥)
9. [æ€§èƒ½ç›‘æ§ä¼˜åŒ–](#9-æ€§èƒ½ç›‘æ§ä¼˜åŒ–)
10. [çƒ­ç‚¹å¤„ç†å®Œæ•´æ–¹æ¡ˆ](#10-çƒ­ç‚¹å¤„ç†å®Œæ•´æ–¹æ¡ˆ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”¥ çƒ­ç‚¹æ•°æ®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯çƒ­ç‚¹æ•°æ®


**çƒ­ç‚¹æ•°æ®**æ˜¯æŒ‡åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹è¢«é¢‘ç¹è®¿é—®å’Œä¿®æ”¹çš„æ•°æ®è®°å½•ï¼Œè¿™äº›æ•°æ®æˆä¸ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆçš„ä¸»è¦åŸå› ã€‚

```
ç°å®ç±»æ¯”ï¼š
çƒ­ç‚¹æ•°æ®å°±åƒçƒ­é—¨å•†å“çš„åº“å­˜ï¼š
- ç§’æ€å•†å“ï¼šç¬é—´å¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­
- æ˜æ˜Ÿæ¼”å”±ä¼šé—¨ç¥¨ï¼šå¼€å”®ç¬é—´æœåŠ¡å™¨å‹åŠ›å·¨å¤§
- çƒ­é—¨æ–‡ç« ç‚¹èµæ•°ï¼šå¤§é‡ç”¨æˆ·åŒæ—¶ç‚¹èµé€ æˆæ›´æ–°å†²çª
```

**ğŸ”¸ çƒ­ç‚¹æ•°æ®ç‰¹å¾**
- **é«˜è®¿é—®é¢‘ç‡**ï¼šå•ä½æ—¶é—´å†…è®¿é—®é‡è¿œè¶…å…¶ä»–æ•°æ®
- **å¹¶å‘å†²çª**ï¼šå¤šä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹ç›¸åŒè®°å½•
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½åˆ¶çº¦å› ç´ 
- **ä¸šåŠ¡å…³é”®**ï¼šå¾€å¾€æ˜¯æ ¸å¿ƒä¸šåŠ¡æ•°æ®

### 1.2 çƒ­ç‚¹æ•°æ®äº§ç”Ÿçš„é—®é¢˜


**âš ï¸ å…¸å‹é—®é¢˜è¡¨ç°**
```sql
-- çƒ­ç‚¹é—®é¢˜åœºæ™¯ï¼šç§’æ€å•†å“åº“å­˜
UPDATE products SET stock = stock - 1 WHERE id = 1;
-- é—®é¢˜ï¼šæ•°åƒä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æ‰§è¡Œï¼Œå¯¼è‡´ï¼š
-- 1. å¤§é‡é”ç­‰å¾…
-- 2. æ•°æ®åº“è¿æ¥è€—å°½  
-- 3. å“åº”æ—¶é—´æ€¥å‰§ä¸Šå‡
-- 4. ç³»ç»Ÿæ•´ä½“æ€§èƒ½ä¸‹é™
```

**ğŸ“Š æ€§èƒ½å½±å“åˆ†æ**
```
æ­£å¸¸æ•°æ®è®¿é—®ï¼š
- å¹¶å‘åº¦ï¼š100 TPS
- å“åº”æ—¶é—´ï¼š10ms
- é”ç­‰å¾…ï¼šå‡ ä¹æ— 

çƒ­ç‚¹æ•°æ®è®¿é—®ï¼š
- å¹¶å‘åº¦ï¼š10000 TPS
- å“åº”æ—¶é—´ï¼š5000ms
- é”ç­‰å¾…ï¼šä¸¥é‡é˜»å¡
```

### 1.3 çƒ­ç‚¹æ•°æ®çš„ä¸šåŠ¡åœºæ™¯


**ğŸ¯ å…¸å‹ä¸šåŠ¡åœºæ™¯**
- **ç”µå•†ç§’æ€**ï¼šé™é‡å•†å“çš„åº“å­˜æ‰£å‡
- **ç¤¾äº¤åª’ä½“**ï¼šçƒ­é—¨å†…å®¹çš„ç‚¹èµã€è¯„è®ºè®¡æ•°
- **é‡‘èç³»ç»Ÿ**ï¼šçƒ­é—¨åŸºé‡‘çš„ç”³è´­èµå›
- **æ¸¸æˆç³»ç»Ÿ**ï¼šæ’è¡Œæ¦œã€ç§¯åˆ†æ›´æ–°
- **å†…å®¹å¹³å°**ï¼šçƒ­é—¨è§†é¢‘çš„æ’­æ”¾é‡ç»Ÿè®¡

---

## 2. ğŸ” çƒ­ç‚¹æ•°æ®è¯†åˆ«


### 2.1 è¯†åˆ«ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- 1. è®¿é—®é¢‘ç‡ç»Ÿè®¡
SELECT 
    table_name,
    object_name,
    COUNT(*) as access_count
FROM performance_schema.events_statements_history
WHERE sql_text LIKE '%UPDATE%products%'
GROUP BY object_name
ORDER BY access_count DESC;

-- 2. é”ç­‰å¾…ç»Ÿè®¡
SELECT 
    object_name,
    COUNT(*) as lock_waits,
    AVG(timer_wait/1000000) as avg_wait_ms
FROM performance_schema.events_waits_history
WHERE event_name LIKE '%lock%'
GROUP BY object_name;
```

### 2.2 è‡ªåŠ¨è¯†åˆ«æœºåˆ¶


**ğŸ¤– å®æ—¶ç›‘æ§ç³»ç»Ÿ**
```sql
-- åˆ›å»ºçƒ­ç‚¹æ•°æ®ç›‘æ§è¡¨
CREATE TABLE hotspot_monitor (
    table_name VARCHAR(64),
    record_id BIGINT,
    access_count INT,
    last_update TIMESTAMP,
    INDEX idx_table_id (table_name, record_id)
);

-- ç›‘æ§è§¦å‘å™¨ç¤ºä¾‹
DELIMITER $$
CREATE TRIGGER tr_hotspot_monitor
AFTER UPDATE ON products
FOR EACH ROW
BEGIN
    INSERT INTO hotspot_monitor (table_name, record_id, access_count, last_update)
    VALUES ('products', NEW.id, 1, NOW())
    ON DUPLICATE KEY UPDATE 
        access_count = access_count + 1,
        last_update = NOW();
END$$
DELIMITER ;
```

### 2.3 çƒ­ç‚¹é˜ˆå€¼è®¾å®š


**âš¡ é˜ˆå€¼é…ç½®ç­–ç•¥**
```
çƒ­ç‚¹åˆ¤å®šæ ‡å‡†ï¼š
1. è®¿é—®é¢‘ç‡ï¼š> 1000 æ¬¡/åˆ†é’Ÿ
2. å¹¶å‘åº¦ï¼š> 100 ä¸ªå¹¶å‘äº‹åŠ¡
3. é”ç­‰å¾…ï¼šå¹³å‡ç­‰å¾…æ—¶é—´ > 100ms
4. å“åº”æ—¶é—´ï¼š> æ­£å¸¸æƒ…å†µçš„ 5 å€

åŠ¨æ€è°ƒæ•´æœºåˆ¶ï¼š
- æ ¹æ®å†å²æ•°æ®è°ƒæ•´é˜ˆå€¼
- è€ƒè™‘ä¸šåŠ¡é«˜å³°æœŸç‰¹ç‚¹
- ç»“åˆç³»ç»Ÿæ•´ä½“è´Ÿè½½æƒ…å†µ
```

---

## 3. ğŸ“– è¯»å†™åˆ†ç¦»ç­–ç•¥


### 3.1 è¯»å†™åˆ†ç¦»åŸºæœ¬åŸç†


**è¯»å†™åˆ†ç¦»**é€šè¿‡å°†è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†å‘åˆ°ä¸åŒçš„æ•°æ®åº“å®ä¾‹ï¼Œå‡è½»ä¸»åº“å‹åŠ›ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“å¹¶å‘èƒ½åŠ›ã€‚

```
æ¶æ„ç¤ºæ„ï¼š
åº”ç”¨ç¨‹åº
    â”œâ”€â”€ å†™æ“ä½œ â†’ ä¸»åº“ï¼ˆMasterï¼‰
    â””â”€â”€ è¯»æ“ä½œ â†’ ä»åº“ï¼ˆSlave1, Slave2, Slave3ï¼‰
```

### 3.2 è¯»å†™åˆ†ç¦»å®ç°


**ğŸ”§ åº”ç”¨å±‚è¯»å†™åˆ†ç¦»**
```java
// ç®€åŒ–çš„è¯»å†™åˆ†ç¦»å®ç°
@Service
public class ProductService {
    
    @Autowired
    private ProductWriteRepository writeRepo; // ä¸»åº“
    
    @Autowired  
    private ProductReadRepository readRepo;   // ä»åº“
    
    // å†™æ“ä½œï¼šä½¿ç”¨ä¸»åº“
    public void updateStock(Long productId, int quantity) {
        writeRepo.updateStock(productId, quantity);
    }
    
    // è¯»æ“ä½œï¼šä½¿ç”¨ä»åº“
    public Product getProduct(Long productId) {
        return readRepo.findById(productId);
    }
}
```

### 3.3 çƒ­ç‚¹æ•°æ®çš„è¯»å†™ä¼˜åŒ–


**ğŸ“Š çƒ­ç‚¹è¯»å–ä¼˜åŒ–**
```sql
-- ä»åº“è´Ÿè½½å‡è¡¡é…ç½®
-- é…ç½®å¤šä¸ªä»åº“åˆ†æ‹…è¯»å‹åŠ›
-- slave1: æ‰¿æ‹… 40% è¯»æµé‡
-- slave2: æ‰¿æ‹… 35% è¯»æµé‡  
-- slave3: æ‰¿æ‹… 25% è¯»æµé‡ï¼ˆå¤‡ç”¨ï¼‰

-- è¯»å–çƒ­ç‚¹æ•°æ®ç¤ºä¾‹
SELECT product_name, stock, price 
FROM products 
WHERE id = 1; -- ä»ä»åº“è¯»å–ï¼Œå‡è½»ä¸»åº“å‹åŠ›
```

**âš ï¸ æ•°æ®ä¸€è‡´æ€§å¤„ç†**
```java
// å¤„ç†ä¸»ä»å»¶è¿Ÿçš„ç­–ç•¥
public Product getProductWithConsistency(Long productId) {
    // å¯¹äºçƒ­ç‚¹æ•°æ®ï¼Œå¯èƒ½éœ€è¦å¼ºä¸€è‡´æ€§
    if (isHotspotData(productId)) {
        // ä»ä¸»åº“è¯»å–ç¡®ä¿ä¸€è‡´æ€§
        return writeRepo.findById(productId);
    } else {
        // æ™®é€šæ•°æ®ä»ä»åº“è¯»å–
        return readRepo.findById(productId);
    }
}
```

---

## 4. ğŸ’¾ ç¼“å­˜å±‚è®¾è®¡


### 4.1 å¤šçº§ç¼“å­˜æ¶æ„


**ç¼“å­˜å±‚æ¬¡è®¾è®¡**ç”¨äºå‡å°‘å¯¹æ•°æ®åº“çš„ç›´æ¥è®¿é—®ï¼Œç‰¹åˆ«æ˜¯å¯¹çƒ­ç‚¹æ•°æ®çš„é¢‘ç¹æŸ¥è¯¢ã€‚

```
ç¼“å­˜å±‚æ¬¡æ¶æ„ï¼š
åº”ç”¨ç¨‹åº
    â”œâ”€â”€ L1: æœ¬åœ°ç¼“å­˜ï¼ˆJVMå†…å­˜ï¼‰
    â”œâ”€â”€ L2: åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
    â””â”€â”€ L3: æ•°æ®åº“ç¼“å­˜ï¼ˆMySQL Buffer Poolï¼‰
```

### 4.2 çƒ­ç‚¹æ•°æ®ç¼“å­˜ç­–ç•¥


**ğŸš€ ç¼“å­˜å®ç°ç¤ºä¾‹**
```java
// å¤šçº§ç¼“å­˜å®ç°
@Service  
public class HotspotProductService {
    
    private final LoadingCache<Long, Product> localCache;
    private final RedisTemplate<String, Product> redisTemplate;
    
    public Product getProduct(Long productId) {
        // L1: æœ¬åœ°ç¼“å­˜
        Product product = localCache.getIfPresent(productId);
        if (product != null) return product;
        
        // L2: Redisç¼“å­˜
        product = redisTemplate.opsForValue()
            .get("product:" + productId);
        if (product != null) {
            localCache.put(productId, product);
            return product;
        }
        
        // L3: æ•°æ®åº“æŸ¥è¯¢
        product = productRepository.findById(productId);
        if (product != null) {
            redisTemplate.opsForValue()
                .set("product:" + productId, product, 300, TimeUnit.SECONDS);
            localCache.put(productId, product);
        }
        return product;
    }
}
```

### 4.3 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ä¿è¯**
```sql
-- æ•°æ®æ›´æ–°æ—¶çš„ç¼“å­˜å¤„ç†
UPDATE products SET stock = stock - 1 WHERE id = 1;

-- å¯¹åº”çš„ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼š
-- 1. Cache Aside: åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½
-- 2. Write Through: åŒæ—¶æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜
-- 3. Write Behind: å…ˆæ›´æ–°ç¼“å­˜ï¼Œå¼‚æ­¥æ›´æ–°æ•°æ®åº“
```

---

## 5. ğŸ—‚ï¸ åˆ†ç‰‡å­˜å‚¨æ–¹æ¡ˆ


### 5.1 æ°´å¹³åˆ†ç‰‡ç­–ç•¥


**åˆ†ç‰‡å­˜å‚¨**é€šè¿‡å°†çƒ­ç‚¹æ•°æ®åˆ†å¸ƒåˆ°å¤šä¸ªæ•°æ®åº“å®ä¾‹ï¼Œåˆ†æ•£è®¿é—®å‹åŠ›ã€‚

```sql
-- æŒ‰å•†å“IDåˆ†ç‰‡ç¤ºä¾‹
-- åˆ†ç‰‡è§„åˆ™ï¼šproduct_id % 4
-- shard_0: product_id % 4 = 0
-- shard_1: product_id % 4 = 1  
-- shard_2: product_id % 4 = 2
-- shard_3: product_id % 4 = 3

-- è·¯ç”±é€»è¾‘
SELECT * FROM products_shard_1 WHERE id = 5; -- 5 % 4 = 1
```

### 5.2 çƒ­ç‚¹æ•°æ®åˆ†ç‰‡


**ğŸ¯ æ™ºèƒ½åˆ†ç‰‡ç­–ç•¥**
```java
// çƒ­ç‚¹æ„ŸçŸ¥çš„åˆ†ç‰‡è·¯ç”±
public class HotspotShardingStrategy {
    
    public String getShardKey(Long productId) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºçƒ­ç‚¹æ•°æ®
        if (hotspotService.isHotspot(productId)) {
            // çƒ­ç‚¹æ•°æ®ä½¿ç”¨ä¸“ç”¨åˆ†ç‰‡ï¼Œé¿å…å½±å“å…¶ä»–æ•°æ®
            return "hotspot_shard_" + (productId % 2);
        } else {
            // æ™®é€šæ•°æ®ä½¿ç”¨å¸¸è§„åˆ†ç‰‡
            return "normal_shard_" + (productId % 8);
        }
    }
}
```

### 5.3 åˆ†ç‰‡é—´è´Ÿè½½å‡è¡¡


**âš–ï¸ åŠ¨æ€è´Ÿè½½è°ƒæ•´**
```
è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
1. ç›‘æ§å„åˆ†ç‰‡çš„ QPS å’Œå“åº”æ—¶é—´
2. è¯†åˆ«è´Ÿè½½è¿‡é«˜çš„åˆ†ç‰‡
3. åŠ¨æ€è°ƒæ•´çƒ­ç‚¹æ•°æ®çš„åˆ†ç‰‡åˆ†å¸ƒ
4. ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œå‡å°‘æ•°æ®è¿ç§»æˆæœ¬
```

---

## 6. ğŸ”„ é˜Ÿåˆ—åŒ–å¤„ç†


### 6.1 å¼‚æ­¥é˜Ÿåˆ—è®¾è®¡


**é˜Ÿåˆ—åŒ–å¤„ç†**å°†å¯¹çƒ­ç‚¹æ•°æ®çš„å¹¶å‘å†™æ“ä½œè½¬æ¢ä¸ºä¸²è¡Œå¤„ç†ï¼Œé¿å…é”ç«äº‰ã€‚

```java
// åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„çƒ­ç‚¹æ•°æ®å¤„ç†
@Component
public class StockUpdateProcessor {
    
    @RabbitListener(queues = "stock.update.queue")
    public void processStockUpdate(StockUpdateMessage message) {
        // ä¸²è¡Œå¤„ç†åº“å­˜æ›´æ–°ï¼Œé¿å…å¹¶å‘å†²çª
        productService.updateStockSerial(
            message.getProductId(), 
            message.getQuantity()
        );
    }
}
```

### 6.2 é˜Ÿåˆ—ä¼˜å…ˆçº§ç®¡ç†


**ğŸ“‹ ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°**
```java
// æŒ‰ä¼˜å…ˆçº§å¤„ç†çƒ­ç‚¹æ•°æ®
public class PriorityStockProcessor {
    
    private final PriorityQueue<StockUpdateTask> taskQueue;
    
    public void addTask(Long productId, int quantity, int priority) {
        StockUpdateTask task = new StockUpdateTask(productId, quantity, priority);
        taskQueue.offer(task);
    }
    
    @Scheduled(fixedDelay = 10) // æ¯10mså¤„ç†ä¸€æ‰¹
    public void processTasks() {
        StockUpdateTask task = taskQueue.poll();
        if (task != null) {
            executeStockUpdate(task);
        }
    }
}
```

### 6.3 é˜Ÿåˆ—å®¹é‡ä¸æµæ§


**ğŸš¦ æµé‡æ§åˆ¶æœºåˆ¶**
```
é˜Ÿåˆ—å®¹é‡ç®¡ç†ï¼š
1. è®¾ç½®é˜Ÿåˆ—æœ€å¤§é•¿åº¦é˜²æ­¢å†…å­˜æº¢å‡º
2. å®ç°èƒŒå‹æœºåˆ¶ï¼Œé˜Ÿåˆ—æ»¡æ—¶æ‹’ç»æ–°è¯·æ±‚
3. ç›‘æ§é˜Ÿåˆ—é•¿åº¦ï¼ŒåŠ¨æ€è°ƒæ•´å¤„ç†é€Ÿåº¦
4. æä¾›é™çº§æœºåˆ¶ï¼Œé˜Ÿåˆ—å¼‚å¸¸æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
```

---

## 7. â° å¼‚æ­¥æ›´æ–°æœºåˆ¶


### 7.1 æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡


**å¼‚æ­¥æ›´æ–°**å…è®¸æ•°æ®åœ¨çŸ­æ—¶é—´å†…ä¸ä¸€è‡´ï¼Œé€šè¿‡åå°è¿›ç¨‹ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

```sql
-- å¼‚æ­¥æ›´æ–°è¡¨è®¾è®¡
CREATE TABLE async_updates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(64),
    record_id BIGINT,
    update_type VARCHAR(32),
    update_data JSON,
    status ENUM('pending', 'processing', 'completed', 'failed'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_status_created (status, created_at)
);
```

### 7.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


**ğŸ“¦ æ‰¹é‡å¤„ç†ç­–ç•¥**
```java
// æ‰¹é‡å¼‚æ­¥æ›´æ–°å¤„ç†å™¨
@Component
public class BatchUpdateProcessor {
    
    @Scheduled(fixedDelay = 1000) // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
    public void processBatchUpdates() {
        List<AsyncUpdate> updates = asyncUpdateService
            .getPendingUpdates(100); // æ‰¹é‡è·å–100æ¡
        
        if (!updates.isEmpty()) {
            // æŒ‰è¡¨ååˆ†ç»„æ‰¹é‡å¤„ç†
            Map<String, List<AsyncUpdate>> groupedUpdates = 
                updates.stream()
                    .collect(Collectors.groupingBy(AsyncUpdate::getTableName));
            
            groupedUpdates.forEach(this::processBatchUpdateByTable);
        }
    }
}
```

### 7.3 è¡¥å¿æœºåˆ¶è®¾è®¡


**ğŸ”§ å¤±è´¥é‡è¯•ä¸è¡¥å¿**
```sql
-- è¡¥å¿å¤„ç†é€»è¾‘
UPDATE async_updates 
SET retry_count = retry_count + 1,
    last_retry = NOW(),
    status = 'pending'
WHERE status = 'failed' 
    AND retry_count < 3 
    AND last_retry < DATE_SUB(NOW(), INTERVAL 5 MINUTE);
```

---

## 8. ğŸ›¡ï¸ å†²çªé¿å…ç­–ç•¥


### 8.1 ä¹è§‚é”æœºåˆ¶


**ä¹è§‚é”**é€šè¿‡ç‰ˆæœ¬å·æˆ–æ—¶é—´æˆ³æ£€æµ‹æ•°æ®å†²çªï¼Œé€‚åˆè¯»å¤šå†™å°‘çš„çƒ­ç‚¹æ•°æ®åœºæ™¯ã€‚

```sql
-- ä¹è§‚é”å®ç°
-- 1. è¡¨ç»“æ„å¢åŠ ç‰ˆæœ¬å­—æ®µ
ALTER TABLE products ADD COLUMN version INT DEFAULT 0;

-- 2. æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
UPDATE products 
SET stock = stock - 1, version = version + 1
WHERE id = 1 AND version = 5; -- åŸç‰ˆæœ¬å·

-- 3. æ£€æŸ¥å½±å“è¡Œæ•°åˆ¤æ–­æ˜¯å¦æˆåŠŸ
-- affected_rows = 0 è¡¨ç¤ºå‘ç”Ÿå†²çª
```

### 8.2 åˆ†æ®µé”ç­–ç•¥


**ğŸ”’ å‡å°‘é”ç«äº‰èŒƒå›´**
```sql
-- åˆ†æ®µåº“å­˜è®¾è®¡
CREATE TABLE product_stock_segments (
    product_id BIGINT,
    segment_id TINYINT,
    stock INT,
    PRIMARY KEY (product_id, segment_id)
);

-- éšæœºé€‰æ‹©åˆ†æ®µè¿›è¡Œæ‰£å‡
UPDATE product_stock_segments 
SET stock = stock - 1 
WHERE product_id = 1 
    AND segment_id = FLOOR(RAND() * 10) -- éšæœºé€‰æ‹©0-9åˆ†æ®µ
    AND stock > 0;
```

### 8.3 é¢„åˆ†é…ç­–ç•¥


**ğŸ“‹ åº“å­˜é¢„åˆ†é…æœºåˆ¶**
```java
// åº“å­˜é¢„åˆ†é…æœåŠ¡
@Service
public class StockPreAllocationService {
    
    // ä¸ºç”¨æˆ·é¢„åˆ†é…åº“å­˜
    public boolean preAllocateStock(Long userId, Long productId, int quantity) {
        // 1. æ£€æŸ¥é¢„åˆ†é…æ± 
        int available = getAvailablePreAllocation(productId);
        if (available >= quantity) {
            // 2. åˆ›å»ºé¢„åˆ†é…è®°å½•
            createPreAllocation(userId, productId, quantity);
            return true;
        }
        return false;
    }
    
    // å®šæ—¶é‡Šæ”¾è¿‡æœŸçš„é¢„åˆ†é…
    @Scheduled(fixedDelay = 60000)
    public void releaseExpiredAllocations() {
        List<PreAllocation> expired = findExpiredAllocations();
        expired.forEach(this::releaseAllocation);
    }
}
```

---

## 9. ğŸ“Š æ€§èƒ½ç›‘æ§ä¼˜åŒ–


### 9.1 å…³é”®æŒ‡æ ‡ç›‘æ§


**ç›‘æ§æŒ‡æ ‡ä½“ç³»**ç”¨äºå®æ—¶è·Ÿè¸ªçƒ­ç‚¹æ•°æ®çš„æ€§èƒ½è¡¨ç°å’Œç³»ç»Ÿå¥åº·çŠ¶å†µã€‚

```sql
-- æ€§èƒ½ç›‘æ§æŸ¥è¯¢
-- 1. çƒ­ç‚¹è¡¨çš„QPSç»Ÿè®¡
SELECT 
    object_name,
    COUNT(*) / 60 as qps_per_minute
FROM performance_schema.events_statements_history 
WHERE timer_start > UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 MINUTE)) * 1000000000
GROUP BY object_name;

-- 2. é”ç­‰å¾…æ—¶é—´ç»Ÿè®¡  
SELECT 
    object_name,
    AVG(timer_wait / 1000000) as avg_wait_ms,
    MAX(timer_wait / 1000000) as max_wait_ms
FROM performance_schema.events_waits_history
WHERE event_name LIKE '%lock%';
```

### 9.2 å®æ—¶å‘Šè­¦æœºåˆ¶


**ğŸš¨ è‡ªåŠ¨å‘Šè­¦é…ç½®**
```java
// æ€§èƒ½å‘Šè­¦æœåŠ¡
@Component
public class HotspotAlertService {
    
    @EventListener
    public void onHighConcurrency(HighConcurrencyEvent event) {
        if (event.getConcurrency() > 1000) {
            // é«˜å¹¶å‘å‘Šè­¦
            alertService.sendAlert(
                "Hot spot detected: " + event.getResourceId() +
                " concurrency: " + event.getConcurrency()
            );
        }
    }
    
    @EventListener  
    public void onLockTimeout(LockTimeoutEvent event) {
        // é”è¶…æ—¶å‘Šè­¦
        alertService.sendAlert(
            "Lock timeout on: " + event.getTableName() +
            " wait time: " + event.getWaitTime() + "ms"
        );
    }
}
```

### 9.3 è‡ªåŠ¨ä¼˜åŒ–è°ƒæ•´


**ğŸ¤– æ™ºèƒ½å‚æ•°è°ƒä¼˜**
```
è‡ªåŠ¨ä¼˜åŒ–ç­–ç•¥ï¼š
1. æ ¹æ®QPSåŠ¨æ€è°ƒæ•´ç¼“å­˜TTL
2. åŸºäºå“åº”æ—¶é—´è°ƒæ•´è¿æ¥æ± å¤§å°  
3. ç›‘æ§é”ç­‰å¾…è‡ªåŠ¨åˆ‡æ¢å¤„ç†ç­–ç•¥
4. æ£€æµ‹çƒ­ç‚¹è¿ç§»æ•°æ®åˆ†ç‰‡åˆ†å¸ƒ
```

---

## 10. ğŸ¯ çƒ­ç‚¹å¤„ç†å®Œæ•´æ–¹æ¡ˆ


### 10.1 ç»¼åˆæ¶æ„è®¾è®¡


**å®Œæ•´çš„çƒ­ç‚¹æ•°æ®å¤„ç†æ¶æ„**æ•´åˆå¤šç§æŠ€æœ¯æ‰‹æ®µï¼Œæä¾›å…¨é¢çš„è§£å†³æ–¹æ¡ˆã€‚

```
å®Œæ•´æ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åº”ç”¨å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœ¬åœ°ç¼“å­˜  â”‚  åˆ†å¸ƒå¼ç¼“å­˜  â”‚  æ¶ˆæ¯é˜Ÿåˆ—  â”‚  ç›‘æ§å‘Šè­¦    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶ + åˆ†ç‰‡è·¯ç”±                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»åº“  â”‚  ä»åº“1  â”‚  ä»åº“2  â”‚  çƒ­ç‚¹ä¸“ç”¨åº“  â”‚  åˆ†ç‰‡åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 åˆ†å±‚å¤„ç†ç­–ç•¥


**ğŸ—ï¸ åˆ†å±‚ä¼˜åŒ–æ–¹æ¡ˆ**
```java
// å®Œæ•´çš„çƒ­ç‚¹æ•°æ®å¤„ç†æœåŠ¡
@Service
public class ComprehensiveHotspotService {
    
    public Product getProduct(Long productId) {
        // Layer 1: æœ¬åœ°ç¼“å­˜
        Product product = localCache.get(productId);
        if (product != null) return product;
        
        // Layer 2: åˆ†å¸ƒå¼ç¼“å­˜  
        product = redisCache.get(productId);
        if (product != null) return product;
        
        // Layer 3: è¯»å†™åˆ†ç¦»
        if (isHotspot(productId)) {
            product = hotspotReadService.getProduct(productId);
        } else {
            product = normalReadService.getProduct(productId);
        }
        
        return product;
    }
    
    public void updateStock(Long productId, int quantity) {
        if (isHotspot(productId)) {
            // çƒ­ç‚¹æ•°æ®ï¼šé˜Ÿåˆ—åŒ–å¤„ç†
            stockUpdateQueue.push(new StockUpdate(productId, quantity));
        } else {
            // æ™®é€šæ•°æ®ï¼šç›´æ¥æ›´æ–°
            productService.updateStock(productId, quantity);
        }
    }
}
```

### 10.3 é™çº§æ–¹æ¡ˆè®¾è®¡


**ğŸ›Ÿ ç³»ç»Ÿé™çº§ç­–ç•¥**
```java
// é™çº§å¤„ç†æœºåˆ¶
@Component
public class HotspotDegradationService {
    
    public boolean processOrder(OrderRequest request) {
        try {
            // æ­£å¸¸æµç¨‹ï¼šå®æ—¶åº“å­˜æ‰£å‡
            return stockService.decreaseStock(
                request.getProductId(), 
                request.getQuantity()
            );
        } catch (HighConcurrencyException e) {
            // é™çº§æ–¹æ¡ˆ1ï¼šé¢„æ‰£åº“å­˜
            return preStockService.allocateStock(request);
        } catch (DatabaseTimeoutException e) {
            // é™çº§æ–¹æ¡ˆ2ï¼šå¼‚æ­¥å¤„ç†
            return asyncOrderService.submitOrder(request);
        } catch (Exception e) {
            // æœ€ç»ˆé™çº§ï¼šæ‹’ç»æœåŠ¡
            throw new ServiceUnavailableException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çƒ­ç‚¹æ•°æ®ï¼šé«˜å¹¶å‘è®¿é—®çš„æ•°æ®ï¼Œæ˜¯ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
ğŸ”¸ è¯†åˆ«æœºåˆ¶ï¼šé€šè¿‡ç›‘æ§è®¿é—®é¢‘ç‡ã€é”ç­‰å¾…ã€å“åº”æ—¶é—´è¯†åˆ«
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šåˆ†ç¦»è¯»å†™æ“ä½œï¼Œå‡è½»æ•°æ®åº“å‹åŠ›
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šå¤šçº§ç¼“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
ğŸ”¸ åˆ†ç‰‡å­˜å‚¨ï¼šåˆ†æ•£çƒ­ç‚¹æ•°æ®åˆ°å¤šä¸ªå®ä¾‹
ğŸ”¸ é˜Ÿåˆ—å¤„ç†ï¼šä¸²è¡ŒåŒ–å¤„ç†é¿å…å¹¶å‘å†²çª
ğŸ”¸ å¼‚æ­¥æ›´æ–°ï¼šæœ€ç»ˆä¸€è‡´æ€§æé«˜ç³»ç»Ÿåå
ğŸ”¸ å†²çªé¿å…ï¼šä¹è§‚é”ã€åˆ†æ®µé”ç­‰ç­–ç•¥å‡å°‘ç«äº‰
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ çƒ­ç‚¹é—®é¢˜çš„æœ¬è´¨**
```
æ ¹æœ¬åŸå› ï¼š
- æ•°æ®è®¿é—®åˆ†å¸ƒä¸å‡ï¼šå°‘é‡æ•°æ®æ‰¿æ‹…å¤§é‡è®¿é—®
- å¹¶å‘å†²çªï¼šå¤šä¸ªäº‹åŠ¡ç«äº‰ç›¸åŒèµ„æº
- é”æœºåˆ¶é™åˆ¶ï¼šæ•°æ®åº“é”æˆä¸ºæ€§èƒ½ç“¶é¢ˆ

è§£å†³æ€è·¯ï¼š
- åˆ†æ•£å‹åŠ›ï¼šé€šè¿‡ç¼“å­˜ã€åˆ†ç‰‡åˆ†æ•£è®¿é—®
- å‡å°‘å†²çªï¼šé€šè¿‡é˜Ÿåˆ—ã€å¼‚æ­¥å‡å°‘å¹¶å‘
- ä¼˜åŒ–ç­–ç•¥ï¼šé’ˆå¯¹æ€§çš„æŠ€æœ¯æ–¹æ¡ˆç»„åˆ
```

**ğŸ”¹ æŠ€æœ¯æ–¹æ¡ˆçš„æƒè¡¡**
```
æ–¹æ¡ˆé€‰æ‹©è€ƒè™‘ï¼š
- ä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´vsæœ€ç»ˆä¸€è‡´
- ç³»ç»Ÿå¤æ‚åº¦ï¼šç®€å•æ–¹æ¡ˆvså®Œæ•´æ–¹æ¡ˆ  
- æ€§èƒ½ç›®æ ‡ï¼šå“åº”æ—¶é—´vsååé‡
- æˆæœ¬é¢„ç®—ï¼šç¡¬ä»¶æˆæœ¬vså¼€å‘æˆæœ¬

ç»„åˆç­–ç•¥ï¼š
- ä¸åŒçƒ­ç‚¹æ•°æ®é‡‡ç”¨ä¸åŒç­–ç•¥
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´æŠ€æœ¯ç»„åˆ
- å¹³è¡¡æ€§èƒ½æå‡ä¸ç³»ç»Ÿå¤æ‚åº¦
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æœ€ä½³å®è·µ**
- **åˆ†å±‚è®¾è®¡**ï¼šç¼“å­˜+åˆ†ç¦»+åˆ†ç‰‡çš„å±‚æ¬¡åŒ–æ–¹æ¡ˆ
- **ç›‘æ§å…ˆè¡Œ**ï¼šå»ºç«‹å®Œå–„çš„çƒ­ç‚¹è¯†åˆ«å’Œå‘Šè­¦æœºåˆ¶
- **æ¸è¿›ä¼˜åŒ–**ï¼šä»ç®€å•æ–¹æ¡ˆé€æ­¥æ¼”è¿›åˆ°å¤æ‚æ–¹æ¡ˆ
- **é™çº§é¢„æ¡ˆ**ï¼šå‡†å¤‡å¤šçº§é™çº§æ–¹æ¡ˆåº”å¯¹æç«¯æƒ…å†µ
- **æ€§èƒ½æµ‹è¯•**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒå‰å……åˆ†éªŒè¯æ–¹æ¡ˆæ•ˆæœ

**âš ï¸ å¸¸è§é™·é˜±**
```
è®¾è®¡é™·é˜±ï¼š
- è¿‡åº¦è®¾è®¡ï¼šä¸€å¼€å§‹å°±ä½¿ç”¨å¤æ‚æ–¹æ¡ˆ
- ç¼“å­˜é—®é¢˜ï¼šç¼“å­˜å‡»ç©¿ã€é›ªå´©ç­‰é—®é¢˜
- ä¸€è‡´æ€§é—®é¢˜ï¼šå¿½ç•¥æœ€ç»ˆä¸€è‡´æ€§çš„ä¸šåŠ¡å½±å“
- ç›‘æ§ç›²åŒºï¼šç¼ºä¹æœ‰æ•ˆçš„çƒ­ç‚¹è¯†åˆ«æœºåˆ¶

å®ç°é™·é˜±ï¼š
- ç¼“å­˜æ›´æ–°ï¼šç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§å¤„ç†
- é˜Ÿåˆ—ç§¯å‹ï¼šå¼‚æ­¥å¤„ç†èƒ½åŠ›ä¸è¶³å¯¼è‡´é˜Ÿåˆ—å †ç§¯
- é™çº§è§¦å‘ï¼šé™çº§æ¡ä»¶è®¾ç½®ä¸åˆç†
- èµ„æºæ³„éœ²ï¼šå¼‚æ­¥ä»»åŠ¡ã€è¿æ¥æ± ç­‰èµ„æºç®¡ç†
```

### 11.4 æ–¹æ¡ˆè¯„ä¼°æ ‡å‡†


**ğŸ“Š æ•ˆæœè¯„ä¼°æŒ‡æ ‡**
- å¹¶å‘å¤„ç†èƒ½åŠ›æå‡å€æ•°
- å“åº”æ—¶é—´æ”¹å–„ç¨‹åº¦  
- æ•°æ®åº“è´Ÿè½½ä¸‹é™æ¯”ä¾‹
- ç³»ç»Ÿç¨³å®šæ€§æŒ‡æ ‡

**ğŸ”§ å®æ–½æˆæœ¬è€ƒé‡**
- å¼€å‘å¤æ‚åº¦å¢åŠ 
- è¿ç»´å¤æ‚åº¦æå‡
- ç¡¬ä»¶èµ„æºæŠ•å…¥
- å›¢é˜ŸæŠ€èƒ½è¦æ±‚

**æ ¸å¿ƒè®°å¿†**ï¼š
- çƒ­ç‚¹æ•°æ®å¤„ç†éœ€è¦å¤šæŠ€æœ¯ç»„åˆï¼Œæ²¡æœ‰é“¶å¼¹è§£å†³æ–¹æ¡ˆ
- ç›‘æ§è¯†åˆ«æ˜¯åŸºç¡€ï¼ŒæŠ€æœ¯æ–¹æ¡ˆè¦åŒ¹é…å…·ä½“çš„çƒ­ç‚¹ç‰¹å¾
- å¹³è¡¡æ€§èƒ½æå‡ä¸ç³»ç»Ÿå¤æ‚åº¦ï¼Œæ¸è¿›å¼ä¼˜åŒ–æœ€å¯é 
- é™çº§æ–¹æ¡ˆå’Œç›‘æ§å‘Šè­¦æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…è¦ä¿éšœ