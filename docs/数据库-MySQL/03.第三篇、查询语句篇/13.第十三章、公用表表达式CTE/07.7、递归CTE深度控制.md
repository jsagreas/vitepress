---
title: 7ã€é€’å½’CTEæ·±åº¦æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [é€’å½’CTEæ·±åº¦æ§åˆ¶æ¦‚è¿°](#1-é€’å½’CTEæ·±åº¦æ§åˆ¶æ¦‚è¿°)
2. [cte_max_recursion_depthç³»ç»Ÿå˜é‡](#2-cte_max_recursion_depthç³»ç»Ÿå˜é‡)
3. [é€’å½’ç»ˆæ­¢æ¡ä»¶è®¾è®¡](#3-é€’å½’ç»ˆæ­¢æ¡ä»¶è®¾è®¡)
4. [æ— é™é€’å½’æ£€æµ‹ä¸é˜²æŠ¤](#4-æ— é™é€’å½’æ£€æµ‹ä¸é˜²æŠ¤)
5. [é€’å½’æ·±åº¦ç›‘æ§ä¸æŠ¥è­¦](#5-é€’å½’æ·±åº¦ç›‘æ§ä¸æŠ¥è­¦)
6. [é€’å½’æ€§èƒ½æ§åˆ¶ç­–ç•¥](#6-é€’å½’æ€§èƒ½æ§åˆ¶ç­–ç•¥)
7. [é€’å½’å®‰å…¨é˜²æŠ¤æœºåˆ¶](#7-é€’å½’å®‰å…¨é˜²æŠ¤æœºåˆ¶)
8. [å®é™…åº”ç”¨æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ](#8-å®é™…åº”ç”¨æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¦ é€’å½’CTEæ·±åº¦æ§åˆ¶æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ·±åº¦æ§åˆ¶


**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**ï¼šé€’å½’CTEå°±åƒçˆ¬æ¥¼æ¢¯ï¼Œå¦‚æœæ²¡æœ‰ç»ˆç‚¹ï¼Œå°±ä¼šä¸€ç›´çˆ¬ä¸‹å»ç›´åˆ°ç´¯æ­»ã€‚æ•°æ®åº“ä¹Ÿä¸€æ ·ï¼Œæ— é™é€’å½’ä¼šè€—å°½ç³»ç»Ÿèµ„æºã€‚

```
é—®é¢˜åœºæ™¯ï¼š
å‘˜å·¥å±‚çº§æŸ¥è¯¢ï¼šAç®¡ç†Bï¼ŒBç®¡ç†Cï¼ŒCç®¡ç†A  â† å½¢æˆç¯è·¯ï¼
æ— é™é€’å½’ï¼šAâ†’Bâ†’Câ†’Aâ†’Bâ†’Câ†’Aâ†’Bâ†’C...æ°¸è¿œåœä¸ä¸‹æ¥

åæœï¼š
ğŸ’€ CPUèµ„æºè€—å°½
ğŸ’€ å†…å­˜çˆ†æ»¡
ğŸ’€ æ•°æ®åº“æœåŠ¡å´©æºƒ
ğŸ’€ æ•´ä¸ªåº”ç”¨ç˜«ç—ª
```

### 1.2 æ·±åº¦æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼


**ğŸ¯ å®‰å…¨ä¿éšœ**ï¼š
- **ğŸ›¡ï¸ ç³»ç»Ÿä¿æŠ¤**ï¼šé˜²æ­¢æ— é™é€’å½’å¯¼è‡´æ•°æ®åº“å´©æºƒ
- **ğŸ“Š èµ„æºæ§åˆ¶**ï¼šåˆç†åˆ†é…CPUå’Œå†…å­˜èµ„æº
- **â° æ€§èƒ½ä¿è¯**ï¼šé¿å…æŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¿‡é•¿

**ğŸ”§ å®ç”¨ä»·å€¼**ï¼š
```
å®é™…ä¸šåŠ¡åœºæ™¯ï¼š
âœ… ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼šé™åˆ¶å±‚çº§æ·±åº¦åœ¨åˆç†èŒƒå›´
âœ… äº§å“åˆ†ç±»æ ‘ï¼šæ§åˆ¶åˆ†ç±»å±‚çº§ï¼Œé¿å…è¿‡æ·±åµŒå¥—
âœ… åœ°ç†åŒºåŸŸæŸ¥è¯¢ï¼šçœâ†’å¸‚â†’åŒºâ†’è¡—é“ï¼Œå±‚çº§æœ‰é™
âœ… æ–‡ä»¶ç›®å½•éå†ï¼šé˜²æ­¢è½¯é“¾æ¥å½¢æˆçš„æ— é™å¾ªç¯
```

### 1.3 æ·±åº¦æ§åˆ¶æ–¹æ³•æ¦‚è§ˆ


```
é€’å½’æ·±åº¦æ§åˆ¶çš„ä¸‰å¤§æ³•å®ï¼š

ğŸ”¥ ç³»ç»Ÿå˜é‡æ§åˆ¶ï¼š
   cte_max_recursion_depth = 1000ï¼ˆMySQLé»˜è®¤ï¼‰
   â†“
   è¶…è¿‡1000å±‚è‡ªåŠ¨ç»ˆæ­¢

ğŸ”¸ ç»ˆæ­¢æ¡ä»¶è®¾è®¡ï¼š
   åœ¨é€’å½’æŸ¥è¯¢ä¸­åŠ å…¥åˆç†çš„WHEREæ¡ä»¶
   â†“
   æ»¡è¶³æ¡ä»¶æ—¶è‡ªç„¶åœæ­¢

ğŸ”¸ ç›‘æ§æŠ¥è­¦æœºåˆ¶ï¼š
   æ£€æµ‹é€’å½’æ·±åº¦ï¼Œæå‰é¢„è­¦
   â†“
   é˜²æ‚£äºæœªç„¶
```

---

## 2. ğŸ”¥ cte_max_recursion_depthç³»ç»Ÿå˜é‡


### 2.1 ç³»ç»Ÿå˜é‡åŸºæœ¬æ¦‚å¿µ


**ğŸ“– æ ¸å¿ƒå®šä¹‰**ï¼š
```
cte_max_recursion_depthï¼šMySQLç³»ç»Ÿå˜é‡
ä½œç”¨ï¼šé™åˆ¶é€’å½’CTEçš„æœ€å¤§è¿­ä»£æ¬¡æ•°
é»˜è®¤å€¼ï¼š1000æ¬¡
èŒƒå›´ï¼š0 - 4294967295
ç”Ÿæ•ˆèŒƒå›´ï¼šå…¨å±€æˆ–ä¼šè¯çº§åˆ«
```

**ğŸ’¡ é€šä¿—ç†è§£**ï¼šå°±åƒç»™é€’å½’æŸ¥è¯¢è®¾ç½®äº†ä¸€ä¸ª"ä¿é™©ä¸"ï¼Œå½“é€’å½’å±‚æ•°è¶…è¿‡è®¾å®šå€¼æ—¶ï¼ŒMySQLä¼šè‡ªåŠ¨"æ–­ç”µ"åœæ­¢æŸ¥è¯¢ï¼Œä¿æŠ¤æ•°æ®åº“ä¸è¢«æ‹–å®ã€‚

### 2.2 æŸ¥çœ‹å’Œè®¾ç½®ç³»ç»Ÿå˜é‡


**ğŸ” æŸ¥çœ‹å½“å‰è®¾ç½®**ï¼š
```sql
-- æŸ¥çœ‹å…¨å±€è®¾ç½®
SHOW GLOBAL VARIABLES LIKE 'cte_max_recursion_depth';

-- æŸ¥çœ‹ä¼šè¯è®¾ç½®  
SHOW SESSION VARIABLES LIKE 'cte_max_recursion_depth';

-- æˆ–è€…ç”¨SELECTæ–¹å¼
SELECT $$global.cte_max_recursion_depth AS global_limit,
       $$session.cte_max_recursion_depth AS session_limit;
```

**âš™ï¸ ä¿®æ”¹è®¾ç½®æ–¹æ³•**ï¼š
```sql
-- ä¿®æ”¹å½“å‰ä¼šè¯çš„é™åˆ¶ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰
SET SESSION cte_max_recursion_depth = 500;

-- ä¿®æ”¹å…¨å±€è®¾ç½®ï¼ˆé‡å¯åå¤±æ•ˆï¼‰
SET GLOBAL cte_max_recursion_depth = 2000;

-- æ°¸ä¹…ä¿®æ”¹ï¼ˆå†™å…¥é…ç½®æ–‡ä»¶ï¼‰
-- åœ¨my.cnfä¸­æ·»åŠ ï¼š
-- cte_max_recursion_depth = 2000
```

### 2.3 è®¾ç½®å€¼çš„é€‰æ‹©ç­–ç•¥


**ğŸ“Š æ¨èé…ç½®è¡¨**ï¼š

| åº”ç”¨åœºæ™¯ | **æ¨èå€¼** | **è¯´æ˜** | **é£é™©è¯„ä¼°** |
|---------|----------|---------|-------------|
| ğŸ¢ **ä¼ä¸šç»„ç»‡æ¶æ„** | `10-50` | `ç»„ç»‡å±‚çº§é€šå¸¸ä¸è¶…è¿‡10å±‚` | `ğŸŸ¢ å®‰å…¨` |
| ğŸ“ **æ–‡ä»¶ç›®å½•éå†** | `20-100` | `æ–‡ä»¶ç³»ç»Ÿå±‚çº§ç›¸å¯¹æœ‰é™` | `ğŸŸ¡ è¾ƒå®‰å…¨` |
| ğŸ›’ **äº§å“åˆ†ç±»æ ‘** | `5-20` | `ç”µå•†åˆ†ç±»ä¸€èˆ¬3-5å±‚` | `ğŸŸ¢ å®‰å…¨` |
| ğŸŒ **ç½‘ç»œæ‹“æ‰‘åˆ†æ** | `100-500` | `ç½‘ç»œå±‚çº§å¯èƒ½è¾ƒæ·±` | `ğŸŸ¡ éœ€ç›‘æ§` |
| ğŸ”¬ **æ•°æ®æŒ–æ˜åˆ†æ** | `1000+` | `æ·±åº¦åˆ†æéœ€æ±‚` | `ğŸ”´ éœ€è°¨æ…` |

**ğŸ¯ é€‰æ‹©åŸåˆ™**ï¼š
```
ä¸šåŠ¡å¯¼å‘é€‰æ‹©ï¼š
1ï¸âƒ£ åˆ†æä¸šåŠ¡åœºæ™¯çš„æœ€å¤§åˆç†æ·±åº¦
2ï¸âƒ£ åœ¨åˆç†å€¼åŸºç¡€ä¸Šå¢åŠ 50%å®‰å…¨è¾¹ç•Œ
3ï¸âƒ£ å®šæœŸå®¡æ ¸å’Œè°ƒæ•´

ä¾‹å¦‚ï¼šä¼ä¸šç»„ç»‡æ¶æ„
å®é™…æœ€å¤§å±‚çº§ï¼š6å±‚ï¼ˆCEOâ†’VPâ†’æ€»ç›‘â†’ç»ç†â†’ä¸»ç®¡â†’å‘˜å·¥ï¼‰
è®¾ç½®å€¼ï¼š6 Ã— 1.5 = 9ï¼Œå‘ä¸Šå–æ•´åˆ°10
```

### 2.4 æ·±åº¦é™åˆ¶çš„å·¥ä½œæœºåˆ¶


**âš™ï¸ å†…éƒ¨å·¥ä½œåŸç†**ï¼š
```
MySQLé€’å½’æ‰§è¡Œè¿‡ç¨‹ï¼š

åˆå§‹åŒ–ï¼šé€’å½’è®¡æ•°å™¨ = 0
æ¯æ¬¡é€’å½’ï¼šè®¡æ•°å™¨ + 1
æ£€æŸ¥ï¼šif (è®¡æ•°å™¨ > cte_max_recursion_depth)
      æŠ›å‡ºé”™è¯¯ï¼šERROR 3636 (HY000): Recursive query aborted
ç»ˆæ­¢ï¼šåœæ­¢æŸ¥è¯¢æ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº

å®é™…ç¤ºä¾‹ï¼š
WITH RECURSIVE countdown(n) AS (
  SELECT 5
  UNION ALL
  SELECT n-1 FROM countdown WHERE n > 0  -- è¿™é‡Œæ˜¯ç»ˆæ­¢æ¡ä»¶
)
SELECT * FROM countdown;

å¦‚æœæ²¡æœ‰WHERE n > 0è¿™ä¸ªç»ˆæ­¢æ¡ä»¶ï¼š
ç¬¬1æ¬¡ï¼šn=5
ç¬¬2æ¬¡ï¼šn=4
...
ç¬¬1001æ¬¡ï¼šè§¦å‘ cte_max_recursion_depth é™åˆ¶ï¼ŒæŠ¥é”™ï¼
```

---

## 3. ğŸ›‘ é€’å½’ç»ˆæ­¢æ¡ä»¶è®¾è®¡


### 3.1 ç»ˆæ­¢æ¡ä»¶çš„é‡è¦æ€§


**ğŸ¯ æ ¸å¿ƒä½œç”¨**ï¼šç»ˆæ­¢æ¡ä»¶æ˜¯é€’å½’æŸ¥è¯¢çš„"åˆ¹è½¦ç³»ç»Ÿ"ï¼Œå†³å®šäº†é€’å½’ä½•æ—¶åœæ­¢ã€‚

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒå¼€è½¦æ—¶çš„çº¢ç»¿ç¯ï¼Œå‘Šè¯‰ä½ ä»€ä¹ˆæ—¶å€™è¯¥åœä¸‹æ¥ã€‚æ²¡æœ‰çº¢ç»¿ç¯çš„è·¯å£ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿäº¤é€šæ··ä¹±ï¼æ²¡æœ‰ç»ˆæ­¢æ¡ä»¶çš„é€’å½’ä¹Ÿä¼š"æ’è½¦"ã€‚

### 3.2 å¸¸è§ç»ˆæ­¢æ¡ä»¶ç±»å‹


#### ğŸ”¢ æ•°å€¼æ¡ä»¶ç»ˆæ­¢


**ç¤ºä¾‹ï¼šå€’è®¡æ—¶æŸ¥è¯¢**
```sql
WITH RECURSIVE countdown(n) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šèµ·å§‹å€¼
    SELECT 10 AS n
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šæ¯æ¬¡å‡1
    SELECT n - 1 
    FROM countdown 
    WHERE n > 0  -- ğŸ¯ å…³é”®ç»ˆæ­¢æ¡ä»¶ï¼šå½“n <= 0æ—¶åœæ­¢
)
SELECT * FROM countdown;

æ‰§è¡Œè¿‡ç¨‹ï¼š
ç¬¬1æ¬¡ï¼šn = 10ï¼Œ10 > 0 âœ… ç»§ç»­
ç¬¬2æ¬¡ï¼šn = 9ï¼Œ 9 > 0 âœ… ç»§ç»­  
...
ç¬¬11æ¬¡ï¼šn = 0ï¼Œ 0 > 0 âŒ åœæ­¢é€’å½’
```

#### ğŸŒ³ å±‚çº§æ·±åº¦æ¡ä»¶ç»ˆæ­¢


**ç¤ºä¾‹ï¼šç»„ç»‡æ¶æ„æŸ¥è¯¢**
```sql
WITH RECURSIVE emp_hierarchy(employee_id, name, manager_id, level) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šæ‰¾åˆ°é¡¶çº§é¢†å¯¼
    SELECT employee_id, name, manager_id, 1 as level
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šé€å±‚æŸ¥æ‰¾ä¸‹å±
    SELECT e.employee_id, e.name, e.manager_id, h.level + 1
    FROM employees e
    INNER JOIN emp_hierarchy h ON e.manager_id = h.employee_id
    WHERE h.level < 5  -- ğŸ¯ å…³é”®ï¼šé™åˆ¶æœ€å¤šæŸ¥è¯¢5å±‚
)
SELECT * FROM emp_hierarchy ORDER BY level, employee_id;

ä¸šåŠ¡å«ä¹‰ï¼š
level = 1ï¼šCEOçº§åˆ«
level = 2ï¼šVPçº§åˆ«  
level = 3ï¼šæ€»ç›‘çº§åˆ«
level = 4ï¼šç»ç†çº§åˆ«
level = 5ï¼šä¸»ç®¡çº§åˆ«
è¶…è¿‡5å±‚ï¼šåœæ­¢æŸ¥è¯¢ï¼ˆé¿å…è¿‡æ·±çš„ç»„ç»‡ç»“æ„ï¼‰
```

#### ğŸš« æ•°æ®å­˜åœ¨æ€§æ¡ä»¶ç»ˆæ­¢


**ç¤ºä¾‹ï¼šè·¯å¾„æŸ¥æ‰¾**
```sql
WITH RECURSIVE route_finder(start_city, end_city, path, total_distance, hops) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šèµ·å§‹åŸå¸‚
    SELECT start_city, end_city, 
           CAST(start_city AS CHAR(1000)) as path,
           distance as total_distance,
           1 as hops
    FROM routes 
    WHERE start_city = 'åŒ—äº¬'
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šå¯»æ‰¾è¿æ¥è·¯å¾„
    SELECT r.start_city, r.end_city,
           CONCAT(rf.path, '->', r.end_city) as path,
           rf.total_distance + r.distance,
           rf.hops + 1
    FROM routes r
    INNER JOIN route_finder rf ON r.start_city = rf.end_city
    WHERE rf.hops < 10  -- ğŸ¯ é˜²æ­¢è·¯å¾„è¿‡é•¿
      AND FIND_IN_SET(r.end_city, rf.path) = 0  -- ğŸ¯ é˜²æ­¢ç¯è·¯
)
SELECT * FROM route_finder WHERE end_city = 'ä¸Šæµ·';
```

### 3.3 ç»ˆæ­¢æ¡ä»¶è®¾è®¡åŸåˆ™


**ğŸ¨ è®¾è®¡é»„é‡‘æ³•åˆ™**ï¼š

```
1ï¸âƒ£ ä¸šåŠ¡é€»è¾‘åˆç†æ€§ï¼š
   âœ… ç¬¦åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„æœ€å¤§æ·±åº¦
   âœ… è€ƒè™‘æ•°æ®çš„è‡ªç„¶è¾¹ç•Œ
   ä¾‹ï¼šå…¬å¸ç»„ç»‡æ¶æ„ä¸€èˆ¬ä¸è¶…è¿‡8å±‚

2ï¸âƒ£ æ€§èƒ½è€ƒè™‘ï¼š
   âœ… é¿å…æŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¿‡é•¿
   âœ… æ§åˆ¶å†…å­˜å’ŒCPUä½¿ç”¨
   ä¾‹ï¼šè®¾ç½®åˆç†çš„å±‚çº§é™åˆ¶

3ï¸âƒ£ å®‰å…¨é˜²æŠ¤ï¼š
   âœ… é˜²æ­¢æ— é™å¾ªç¯
   âœ… é˜²æ­¢æ¶æ„çš„æ·±åº¦æŸ¥è¯¢
   ä¾‹ï¼šæ£€æµ‹å·²è®¿é—®è¿‡çš„èŠ‚ç‚¹

4ï¸âƒ£ å¯ç»´æŠ¤æ€§ï¼š
   âœ… ç»ˆæ­¢æ¡ä»¶æ¸…æ™°æ˜ç¡®
   âœ… å®¹æ˜“ç†è§£å’Œä¿®æ”¹
   ä¾‹ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µåå’Œæ³¨é‡Š
```

**âš ï¸ å¸¸è§è®¾è®¡é™·é˜±**ï¼š
```
âŒ åªä¾èµ–ç³»ç»Ÿå˜é‡ï¼š
   SET cte_max_recursion_depth = 10000;  -- å¤ªè¢«åŠ¨ï¼Œé£é™©é«˜

âŒ ç»ˆæ­¢æ¡ä»¶å¤ªå®½æ¾ï¼š
   WHERE level < 1000  -- å®é™…ä¸šåŠ¡ç”¨ä¸åˆ°è¿™ä¹ˆæ·±

âŒ æ²¡æœ‰é˜²ç¯å¤„ç†ï¼š
   å¿˜è®°æ£€æŸ¥é‡å¤è®¿é—®çš„èŠ‚ç‚¹

âœ… æ­£ç¡®çš„ç»„åˆæ–¹å¼ï¼š
   ç³»ç»Ÿå˜é‡ + ä¸šåŠ¡é€»è¾‘æ¡ä»¶ + ç¯è·¯æ£€æµ‹
```

---

## 4. ğŸ” æ— é™é€’å½’æ£€æµ‹ä¸é˜²æŠ¤


### 4.1 æ— é™é€’å½’äº§ç”Ÿçš„åŸå› 


**ğŸ”„ ç¯è·¯é—®é¢˜**ï¼šæœ€å¸¸è§çš„æ— é™é€’å½’åŸå› å°±æ˜¯æ•°æ®ä¸­å­˜åœ¨ç¯è·¯ã€‚

```
å‘˜å·¥ç®¡ç†å…³ç³»ä¸­çš„ç¯è·¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼ ä¸‰    â”‚â”€â”€â”€â–¶â”‚ æå››    â”‚â”€â”€â”€â–¶â”‚ ç‹äº”    â”‚
â”‚(ID:100) â”‚    â”‚(ID:101) â”‚    â”‚(ID:102) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                             â”‚
     â”‚                             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     
æ•°æ®è¡¨å†…å®¹ï¼š
| employee_id | name | manager_id |
|------------|------|------------|
| 100        | å¼ ä¸‰  | 102        |  â† å¼ ä¸‰çš„ä¸Šçº§æ˜¯ç‹äº”
| 101        | æå››  | 100        |  â† æå››çš„ä¸Šçº§æ˜¯å¼ ä¸‰  
| 102        | ç‹äº”  | 101        |  â† ç‹äº”çš„ä¸Šçº§æ˜¯æå››

é€’å½’æŸ¥è¯¢å¼ ä¸‰çš„æ‰€æœ‰ä¸‹å±æ—¶ï¼š
å¼ ä¸‰ â†’ æå›› â†’ ç‹äº” â†’ å¼ ä¸‰ â†’ æå›› â†’ ç‹äº”...æ— é™å¾ªç¯ï¼
```

### 4.2 ç¯è·¯æ£€æµ‹æœºåˆ¶


**ğŸ” è·¯å¾„è®°å½•æ³•**ï¼šåœ¨é€’å½’è¿‡ç¨‹ä¸­è®°å½•å·²ç»è®¿é—®è¿‡çš„èŠ‚ç‚¹ã€‚

```sql
WITH RECURSIVE safe_hierarchy(employee_id, name, path, level) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šèµ·å§‹èŠ‚ç‚¹
    SELECT employee_id, name, 
           CAST(employee_id AS CHAR(1000)) as path,  -- è®°å½•è®¿é—®è·¯å¾„
           1 as level
    FROM employees 
    WHERE employee_id = 100  -- ä»å¼ ä¸‰å¼€å§‹æŸ¥è¯¢
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šå®‰å…¨æ£€æŸ¥
    SELECT e.employee_id, e.name,
           CONCAT(h.path, '->', e.employee_id) as path,
           h.level + 1
    FROM employees e
    INNER JOIN safe_hierarchy h ON e.manager_id = h.employee_id
    WHERE h.level < 10  -- å±‚çº§é™åˆ¶
      AND FIND_IN_SET(e.employee_id, h.path) = 0  -- ğŸ¯ å…³é”®ï¼šæ£€æµ‹æ˜¯å¦é‡å¤è®¿é—®
)
SELECT * FROM safe_hierarchy;

è§£é‡Šï¼š
FIND_IN_SET(e.employee_id, h.path) = 0
æ„æ€æ˜¯ï¼šå¦‚æœå‘˜å·¥IDå·²ç»åœ¨è·¯å¾„ä¸­å‡ºç°è¿‡ï¼Œå°±ä¸å†é€’å½’
è¿™æ ·å°±é¿å…äº† Aâ†’Bâ†’Câ†’A çš„æ— é™å¾ªç¯
```

**ğŸ”¢ è®¡æ•°å™¨æ³•**ï¼šä½¿ç”¨è®¡æ•°å™¨è¿½è¸ªè®¿é—®æ¬¡æ•°ã€‚

```sql
WITH RECURSIVE visit_counter AS (
    SELECT node_id, parent_id, 1 as visit_count
    FROM tree_table 
    WHERE node_id = 'root'
    
    UNION ALL
    
    SELECT t.node_id, t.parent_id, v.visit_count + 1
    FROM tree_table t
    INNER JOIN visit_counter v ON t.parent_id = v.node_id
    WHERE v.visit_count <= 100  -- ğŸ¯ é™åˆ¶è®¿é—®æ¬¡æ•°
      AND t.node_id NOT IN (
          SELECT node_id FROM visit_counter  -- é˜²æ­¢é‡å¤è®¿é—®
      )
)
SELECT * FROM visit_counter;
```

### 4.3 æ— é™é€’å½’è¯†åˆ«æœºåˆ¶


**ğŸ“ˆ è¯†åˆ«æŒ‡æ ‡**ï¼š

```
ğŸš¨ å±é™©ä¿¡å·è¯†åˆ«ï¼š

1ï¸âƒ£ æ‰§è¡Œæ—¶é—´å¼‚å¸¸ï¼š
   æ­£å¸¸æŸ¥è¯¢ï¼š< 1ç§’
   å¯ç–‘æŸ¥è¯¢ï¼š> 10ç§’
   å±é™©æŸ¥è¯¢ï¼š> 30ç§’

2ï¸âƒ£ CPUä½¿ç”¨ç‡é£™å‡ï¼š
   æ­£å¸¸æƒ…å†µï¼š< 30%
   å¯ç–‘æƒ…å†µï¼š> 80%
   å±é™©æƒ…å†µï¼š> 95%

3ï¸âƒ£ å†…å­˜ä½¿ç”¨æ¿€å¢ï¼š
   æ­£å¸¸å¢é•¿ï¼šçº¿æ€§å¢é•¿
   å¼‚å¸¸å¢é•¿ï¼šæŒ‡æ•°çº§å¢é•¿

4ï¸âƒ£ é€’å½’æ·±åº¦è¶…æ ‡ï¼š
   æ¥è¿‘ç³»ç»Ÿé™åˆ¶ï¼š> 80% * cte_max_recursion_depth
   ä¾‹ï¼šé»˜è®¤1000ï¼Œå½“æ·±åº¦ > 800æ—¶è¦è­¦æƒ•
```

**ğŸ”¬ æ£€æµ‹æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
-- æ£€æµ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„é€’å½’æŸ¥è¯¢
SELECT 
    p.ID,
    p.USER,
    p.HOST,
    p.DB,
    p.COMMAND,
    p.TIME,  -- æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
    p.STATE,
    p.INFO   -- å…·ä½“SQLè¯­å¥
FROM information_schema.PROCESSLIST p
WHERE p.INFO LIKE '%WITH RECURSIVE%'  -- æ‰¾åˆ°é€’å½’CTEæŸ¥è¯¢
  AND p.TIME > 10;  -- æ‰§è¡Œè¶…è¿‡10ç§’çš„æŸ¥è¯¢

-- å¦‚æœå‘ç°å¯ç–‘æŸ¥è¯¢ï¼Œå¯ä»¥ç»ˆæ­¢å®ƒ
-- KILL QUERY [process_id];
```

---

## 5. ğŸ“Š é€’å½’æ·±åº¦ç›‘æ§ä¸æŠ¥è­¦


### 5.1 ç›‘æ§ç³»ç»Ÿè®¾è®¡


**ğŸ¯ ç›‘æ§ç›®æ ‡**ï¼š
- **ğŸ“ˆ å®æ—¶ç›‘æ§**ï¼šé€’å½’æŸ¥è¯¢çš„æ‰§è¡ŒçŠ¶æ€
- **âš ï¸ æ—©æœŸé¢„è­¦**ï¼šåœ¨é—®é¢˜ä¸¥é‡åŒ–ä¹‹å‰å‘ç°
- **ğŸ“Š ç»Ÿè®¡åˆ†æ**ï¼šé€’å½’æŸ¥è¯¢çš„ä½¿ç”¨æ¨¡å¼

### 5.2 å®æ—¶ç›‘æ§å®ç°


**ğŸ“º ç›‘æ§é¢æ¿æŸ¥è¯¢**ï¼š
```sql
-- åˆ›å»ºç›‘æ§è§†å›¾
CREATE VIEW recursive_cte_monitor AS
SELECT 
    p.ID as process_id,
    p.USER as db_user,
    p.HOST as client_host,
    p.TIME as execution_seconds,
    CASE 
        WHEN p.TIME < 5 THEN 'ğŸŸ¢ æ­£å¸¸'
        WHEN p.TIME < 15 THEN 'ğŸŸ¡ æ³¨æ„'
        WHEN p.TIME < 30 THEN 'ğŸŸ  è­¦å‘Š'
        ELSE 'ğŸ”´ å±é™©'
    END as status_level,
    -- ä¼°ç®—å½“å‰é€’å½’æ·±åº¦ï¼ˆåŸºäºæ‰§è¡Œæ—¶é—´ï¼‰
    ROUND(p.TIME * 10) as estimated_depth,
    $$session.cte_max_recursion_depth as depth_limit,
    ROUND((p.TIME * 10) / $$session.cte_max_recursion_depth * 100, 2) as depth_percentage,
    LEFT(p.INFO, 100) as query_preview
FROM information_schema.PROCESSLIST p
WHERE p.INFO LIKE '%WITH RECURSIVE%'
  AND p.COMMAND = 'Query';

-- ä½¿ç”¨ç›‘æ§è§†å›¾
SELECT * FROM recursive_cte_monitor 
ORDER BY execution_seconds DESC;
```

**ğŸ“± è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬**ï¼š
```sql
-- åˆ›å»ºç›‘æ§å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE monitor_recursive_cte()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE proc_id BIGINT;
    DECLARE exec_time INT;
    DECLARE user_name VARCHAR(100);
    
    -- å£°æ˜æ¸¸æ ‡
    DECLARE cte_cursor CURSOR FOR
        SELECT ID, TIME, USER
        FROM information_schema.PROCESSLIST
        WHERE INFO LIKE '%WITH RECURSIVE%'
          AND TIME > 15;  -- æ‰§è¡Œè¶…è¿‡15ç§’
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cte_cursor;
    
    read_loop: LOOP
        FETCH cte_cursor INTO proc_id, exec_time, user_name;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- è®°å½•å‘Šè­¦æ—¥å¿—
        INSERT INTO cte_alert_log (process_id, user_name, execution_time, alert_time)
        VALUES (proc_id, user_name, exec_time, NOW());
        
        -- å¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥é€‰æ‹©ç»ˆæ­¢
        IF exec_time > 60 THEN
            SET @kill_sql = CONCAT('KILL QUERY ', proc_id);
            PREPARE stmt FROM @kill_sql;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;
        END IF;
        
    END LOOP;
    
    CLOSE cte_cursor;
END //
DELIMITER ;

-- åˆ›å»ºå‘Šè­¦æ—¥å¿—è¡¨
CREATE TABLE cte_alert_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    process_id BIGINT,
    user_name VARCHAR(100),
    execution_time INT,
    alert_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_alert_time (alert_time)
);
```

### 5.3 é¢„è­¦æœºåˆ¶è®¾è®¡


**ğŸš¨ å¤šçº§é¢„è­¦ä½“ç³»**ï¼š

```
é¢„è­¦çº§åˆ«è®¾è®¡ï¼š

ğŸŸ¢ ç»¿è‰²ï¼ˆæ­£å¸¸ï¼‰ï¼š
   æ‰§è¡Œæ—¶é—´ï¼š< 5ç§’
   é€’å½’æ·±åº¦ï¼š< 20%é™åˆ¶å€¼
   æ“ä½œï¼šæ­£å¸¸ç›‘æ§

ğŸŸ¡ é»„è‰²ï¼ˆæ³¨æ„ï¼‰ï¼š
   æ‰§è¡Œæ—¶é—´ï¼š5-15ç§’
   é€’å½’æ·±åº¦ï¼š20%-50%é™åˆ¶å€¼
   æ“ä½œï¼šåŠ å¼ºç›‘æ§ï¼Œè®°å½•æ—¥å¿—

ğŸŸ  æ©™è‰²ï¼ˆè­¦å‘Šï¼‰ï¼š
   æ‰§è¡Œæ—¶é—´ï¼š15-30ç§’
   é€’å½’æ·±åº¦ï¼š50%-80%é™åˆ¶å€¼
   æ“ä½œï¼šå‘é€å‘Šè­¦é€šçŸ¥

ğŸ”´ çº¢è‰²ï¼ˆå±é™©ï¼‰ï¼š
   æ‰§è¡Œæ—¶é—´ï¼š> 30ç§’
   é€’å½’æ·±åº¦ï¼š> 80%é™åˆ¶å€¼
   æ“ä½œï¼šè€ƒè™‘å¼ºåˆ¶ç»ˆæ­¢æŸ¥è¯¢
```

**ğŸ“§ å‘Šè­¦é€šçŸ¥å®ç°**ï¼š
```sql
-- åˆ›å»ºå‘Šè­¦è§¦å‘å™¨ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
DELIMITER //
CREATE TRIGGER cte_performance_alert
AFTER INSERT ON cte_alert_log
FOR EACH ROW
BEGIN
    IF NEW.execution_time > 30 THEN
        -- å‘é€é«˜ä¼˜å…ˆçº§å‘Šè­¦
        INSERT INTO alert_queue (alert_type, message, priority, create_time)
        VALUES (
            'CTE_DANGER',
            CONCAT('é€’å½’CTEæ‰§è¡Œæ—¶é—´è¿‡é•¿: ', NEW.execution_time, 'ç§’, è¿›ç¨‹ID: ', NEW.process_id),
            'HIGH',
            NOW()
        );
    ELSEIF NEW.execution_time > 15 THEN
        -- å‘é€ä¸­ç­‰ä¼˜å…ˆçº§å‘Šè­¦
        INSERT INTO alert_queue (alert_type, message, priority, create_time)
        VALUES (
            'CTE_WARNING', 
            CONCAT('é€’å½’CTEæ‰§è¡Œæ—¶é—´è¾ƒé•¿: ', NEW.execution_time, 'ç§’'),
            'MEDIUM',
            NOW()
        );
    END IF;
END //
DELIMITER ;
```

---

## 6. âš¡ é€’å½’æ€§èƒ½æ§åˆ¶ç­–ç•¥


### 6.1 æ€§èƒ½ä¼˜åŒ–åŸºæœ¬ç­–ç•¥


**ğŸ¯ ä¼˜åŒ–ç›®æ ‡**ï¼šåœ¨ä¿è¯åŠŸèƒ½çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–é€’å½’æŸ¥è¯¢çš„æ€§èƒ½ã€‚

### 6.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


**ğŸ“Š å…³é”®ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- å‘˜å·¥å±‚çº§è¡¨çš„ç´¢å¼•ç­–ç•¥
CREATE TABLE employees (
    employee_id INT PRIMARY KEY,
    name VARCHAR(100),
    manager_id INT,
    department_id INT,
    
    -- ğŸ”¥ æ ¸å¿ƒç´¢å¼•ï¼šé€’å½’æŸ¥è¯¢çš„å…³é”®
    INDEX idx_manager_emp (manager_id, employee_id),  -- æ”¯æŒé€’å½’è¿æ¥
    INDEX idx_emp_manager (employee_id, manager_id),  -- æ”¯æŒåå‘æŸ¥è¯¢
    INDEX idx_department (department_id)              -- æ”¯æŒéƒ¨é—¨è¿‡æ»¤
);

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ç´¢å¼•ï¼š
1. idx_manager_empï¼šæ ¹æ®ç®¡ç†è€…å¿«é€Ÿæ‰¾åˆ°ä¸‹å±
2. idx_emp_managerï¼šæ ¹æ®å‘˜å·¥å¿«é€Ÿæ‰¾åˆ°ç®¡ç†è€…
3. å¤åˆç´¢å¼•é¡ºåºï¼šæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µæ”¾åœ¨å‰é¢
```

**ğŸ” ç´¢å¼•ä½¿ç”¨éªŒè¯**ï¼š
```sql
-- æ£€æŸ¥é€’å½’æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN FORMAT=JSON
WITH RECURSIVE emp_tree(employee_id, name, manager_id, level) AS (
    SELECT employee_id, name, manager_id, 1
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    SELECT e.employee_id, e.name, e.manager_id, t.level + 1
    FROM employees e
    INNER JOIN emp_tree t ON e.manager_id = t.employee_id
    WHERE t.level < 5
)
SELECT * FROM emp_tree;

-- å…³æ³¨æ‰§è¡Œè®¡åˆ’ä¸­çš„ï¼š
-- 1. æ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•ï¼ˆkeyå­—æ®µï¼‰
-- 2. æ‰«æè¡Œæ•°ï¼ˆrowså­—æ®µï¼‰  
-- 3. è¿æ¥ç±»å‹ï¼ˆtypeå­—æ®µï¼šindex > range > ref > eq_refï¼‰
```

### 6.3 æŸ¥è¯¢ç»“æ„ä¼˜åŒ–


**âš™ï¸ å‡å°‘æ•°æ®ä¼ è¾“**ï¼š
```sql
-- âŒ ä½æ•ˆå†™æ³•ï¼šä¼ è¾“ä¸å¿…è¦çš„æ•°æ®
WITH RECURSIVE bad_example(employee_id, name, email, phone, address, department, manager_id, level) AS (
    SELECT employee_id, name, email, phone, address, department, manager_id, 1
    FROM employees 
    WHERE manager_id IS NULL
    -- ä¼ è¾“äº†å¤§é‡å¯èƒ½ç”¨ä¸åˆ°çš„å­—æ®µ
)

-- âœ… é«˜æ•ˆå†™æ³•ï¼šåªä¼ è¾“å¿…è¦æ•°æ®
WITH RECURSIVE good_example(employee_id, name, manager_id, level) AS (
    SELECT employee_id, name, manager_id, 1  -- åªé€‰æ‹©å¿…è¦å­—æ®µ
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    SELECT e.employee_id, e.name, e.manager_id, g.level + 1
    FROM employees e
    INNER JOIN good_example g ON e.manager_id = g.employee_id
    WHERE g.level < 5
)
-- åœ¨æœ€åéœ€è¦è¯¦ç»†ä¿¡æ¯æ—¶å†å…³è”
SELECT h.*, e.email, e.phone, e.department
FROM good_example h
LEFT JOIN employees e ON h.employee_id = e.employee_id;
```

### 6.4 æ‰¹é‡å¤„ç†ä¼˜åŒ–


**ğŸ“¦ åˆ†æ‰¹å¤„ç†ç­–ç•¥**ï¼š
```sql
-- å¯¹äºå¤§å‹æ•°æ®é›†ï¼Œåˆ†æ‰¹å¤„ç†é€’å½’æŸ¥è¯¢
DELIMITER //
CREATE PROCEDURE process_hierarchy_batch(IN batch_size INT)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE current_id INT;
    DECLARE batch_count INT DEFAULT 0;
    
    -- è·å–æ‰€æœ‰æ ¹èŠ‚ç‚¹
    DECLARE root_cursor CURSOR FOR
        SELECT employee_id FROM employees WHERE manager_id IS NULL;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN root_cursor;
    
    batch_loop: LOOP
        FETCH root_cursor INTO current_id;
        IF done THEN
            LEAVE batch_loop;
        END IF;
        
        -- ä¸ºæ¯ä¸ªæ ¹èŠ‚ç‚¹å•ç‹¬æ‰§è¡Œé€’å½’æŸ¥è¯¢
        WITH RECURSIVE single_tree(employee_id, name, manager_id, level) AS (
            SELECT employee_id, name, manager_id, 1
            FROM employees 
            WHERE employee_id = current_id
            
            UNION ALL
            
            SELECT e.employee_id, e.name, e.manager_id, s.level + 1
            FROM employees e
            INNER JOIN single_tree s ON e.manager_id = s.employee_id
            WHERE s.level < 8
        )
        INSERT INTO hierarchy_result 
        SELECT * FROM single_tree;
        
        SET batch_count = batch_count + 1;
        
        -- æ¯å¤„ç†ä¸€å®šæ•°é‡åæš‚åœï¼Œé‡Šæ”¾èµ„æº
        IF batch_count >= batch_size THEN
            SELECT SLEEP(0.1);  -- æš‚åœ100æ¯«ç§’
            SET batch_count = 0;
        END IF;
        
    END LOOP;
    
    CLOSE root_cursor;
END //
DELIMITER ;
```

---

## 7. ğŸ›¡ï¸ é€’å½’å®‰å…¨é˜²æŠ¤æœºåˆ¶


### 7.1 å¤šå±‚é˜²æŠ¤ä½“ç³»


**ğŸ° é˜²æŠ¤å±‚çº§è®¾è®¡**ï¼š

```
ç¬¬ä¸€å±‚ï¼šè¾“å…¥éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ å‚æ•°åˆæ³•æ€§æ£€æŸ¥                     â”‚
â”‚ â€¢ ç”¨æˆ·æƒé™éªŒè¯                       â”‚  
â”‚ â€¢ SQLæ³¨å…¥é˜²æŠ¤                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
ç¬¬äºŒå±‚ï¼šç³»ç»Ÿå˜é‡é™åˆ¶  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ cte_max_recursion_depthè®¾ç½®        â”‚
â”‚ â€¢ æ‰§è¡Œæ—¶é—´é™åˆ¶                       â”‚
â”‚ â€¢ å†…å­˜ä½¿ç”¨é™åˆ¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
ç¬¬ä¸‰å±‚ï¼šä¸šåŠ¡é€»è¾‘æ§åˆ¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ åˆç†çš„ç»ˆæ­¢æ¡ä»¶                     â”‚
â”‚ â€¢ ç¯è·¯æ£€æµ‹æœºåˆ¶                       â”‚
â”‚ â€¢ æ·±åº¦ä¸šåŠ¡é™åˆ¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
ç¬¬å››å±‚ï¼šç›‘æ§æŠ¥è­¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ å®æ—¶æ€§èƒ½ç›‘æ§                       â”‚
â”‚ â€¢ è‡ªåŠ¨å‘Šè­¦æœºåˆ¶                       â”‚
â”‚ â€¢ ç´§æ€¥åœæ­¢æœºåˆ¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æƒé™æ§åˆ¶æœºåˆ¶


**ğŸ‘® ç”¨æˆ·æƒé™ç®¡ç†**ï¼š
```sql
-- åˆ›å»ºä¸“é—¨çš„é€’å½’æŸ¥è¯¢è§’è‰²
CREATE ROLE 'recursive_query_user';

-- æˆäºˆåŸºæœ¬æŸ¥è¯¢æƒé™
GRANT SELECT ON company.employees TO 'recursive_query_user';
GRANT SELECT ON company.departments TO 'recursive_query_user';

-- é™åˆ¶é€’å½’æ·±åº¦æƒé™ï¼ˆé€šè¿‡è§†å›¾ï¼‰
CREATE VIEW limited_employees AS
SELECT employee_id, name, manager_id, department_id
FROM employees;

-- åªå…è®¸é€šè¿‡è§†å›¾è®¿é—®ï¼Œåœ¨è§†å›¾ä¸­å†…ç½®æ·±åº¦é™åˆ¶
GRANT SELECT ON company.limited_employees TO 'recursive_query_user';
REVOKE SELECT ON company.employees FROM 'recursive_query_user';

-- ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®é€’å½’æ·±åº¦é™åˆ¶
-- å¯ä»¥åœ¨ç”¨æˆ·è¿æ¥æ—¶è‡ªåŠ¨è®¾ç½®
DELIMITER //
CREATE PROCEDURE set_user_recursion_limit(IN username VARCHAR(100))
BEGIN
    CASE username
        WHEN 'junior_analyst' THEN
            SET SESSION cte_max_recursion_depth = 50;
        WHEN 'senior_analyst' THEN  
            SET SESSION cte_max_recursion_depth = 200;
        WHEN 'admin_user' THEN
            SET SESSION cte_max_recursion_depth = 1000;
        ELSE
            SET SESSION cte_max_recursion_depth = 10;  -- é»˜è®¤æœ€å°æƒé™
    END CASE;
END //
DELIMITER ;
```

### 7.3 èµ„æºä¿æŠ¤æœºåˆ¶


**ğŸ’¾ å†…å­˜ä¿æŠ¤ç­–ç•¥**ï¼š
```sql
-- è®¾ç½®æŸ¥è¯¢å†…å­˜é™åˆ¶ï¼ˆMySQL 8.0+ï¼‰
SET SESSION max_execution_time = 30000;  -- 30ç§’è¶…æ—¶

-- åˆ›å»ºèµ„æºç›‘æ§è¡¨
CREATE TABLE recursive_query_stats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_name VARCHAR(100),
    query_start_time TIMESTAMP,
    query_end_time TIMESTAMP,
    execution_seconds INT,
    estimated_memory_mb DECIMAL(10,2),
    max_recursion_depth INT,
    query_hash VARCHAR(64),
    status ENUM('completed', 'timeout', 'error', 'killed'),
    INDEX idx_user_time (user_name, query_start_time)
);

-- æŸ¥è¯¢æ‰§è¡Œè®°å½•å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE log_recursive_query(
    IN p_user VARCHAR(100),
    IN p_start_time TIMESTAMP,
    IN p_exec_seconds INT,
    IN p_status VARCHAR(20)
)
BEGIN
    INSERT INTO recursive_query_stats 
    (user_name, query_start_time, query_end_time, execution_seconds, status)
    VALUES 
    (p_user, p_start_time, NOW(), p_exec_seconds, p_status);
    
    -- å¦‚æœç”¨æˆ·çš„é€’å½’æŸ¥è¯¢é¢‘ç¹è¶…æ—¶ï¼Œè‡ªåŠ¨é™ä½å…¶æƒé™
    IF p_status = 'timeout' THEN
        SET @timeout_count = (
            SELECT COUNT(*) 
            FROM recursive_query_stats 
            WHERE user_name = p_user 
              AND status = 'timeout'
              AND query_start_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
        );
        
        IF @timeout_count >= 3 THEN
            -- é™ä½ç”¨æˆ·çš„é€’å½’æ·±åº¦é™åˆ¶
            SET @new_limit = GREATEST(10, $$session.cte_max_recursion_depth * 0.5);
            SET @sql = CONCAT('SET @user_limit_', REPLACE(p_user, ' ', '_'), ' = ', @new_limit);
            PREPARE stmt FROM @sql;
            EXECUTE stmt;
            DEALLOCATE PREPARE stmt;
        END IF;
    END IF;
END //
DELIMITER ;
```

---

## 8. ğŸ’¼ å®é™…åº”ç”¨æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ


### 8.1 ä¼ä¸šç»„ç»‡æ¶æ„æŸ¥è¯¢æ¡ˆä¾‹


**ğŸ¢ å®é™…ä¸šåŠ¡åœºæ™¯**ï¼šæŸ¥è¯¢æŸä¸ªéƒ¨é—¨ç»ç†çš„æ‰€æœ‰ä¸‹å±å‘˜å·¥ã€‚

```sql
-- å®Œæ•´çš„å®‰å…¨é€’å½’æŸ¥è¯¢å®ç°
WITH RECURSIVE department_hierarchy(
    employee_id, 
    name, 
    manager_id, 
    department, 
    level,
    hierarchy_path,
    total_subordinates
) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šéƒ¨é—¨ç»ç†
    SELECT 
        employee_id,
        name,
        manager_id,
        department,
        1 as level,
        CAST(CONCAT('/', name) AS CHAR(2000)) as hierarchy_path,
        0 as total_subordinates
    FROM employees 
    WHERE employee_id = 1001  -- å‡è®¾æŸ¥è¯¢IDä¸º1001çš„ç»ç†
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šé€å±‚æŸ¥æ‰¾ä¸‹å±
    SELECT 
        e.employee_id,
        e.name,
        e.manager_id,
        e.department,
        h.level + 1,
        CONCAT(h.hierarchy_path, '/', e.name),
        0
    FROM employees e
    INNER JOIN department_hierarchy h ON e.manager_id = h.employee_id
    WHERE h.level < 6  -- ğŸ¯ ä¸šåŠ¡é™åˆ¶ï¼šæœ€å¤š6å±‚ç®¡ç†å±‚çº§
      AND CHAR_LENGTH(h.hierarchy_path) < 1900  -- ğŸ¯ é˜²æ­¢è·¯å¾„è¿‡é•¿
      AND FIND_IN_SET(e.employee_id, 
          REPLACE(SUBSTRING(h.hierarchy_path, 2), '/', ',')) = 0  -- ğŸ¯ é˜²æ­¢ç¯è·¯
)
-- æŸ¥è¯¢ç»“æœç»Ÿè®¡
SELECT 
    level,
    COUNT(*) as employees_count,
    GROUP_CONCAT(name ORDER BY name SEPARATOR ', ') as employees_list
FROM department_hierarchy 
GROUP BY level
ORDER BY level;

-- åŒæ—¶ç»Ÿè®¡æ¯å±‚çš„äººæ•°åˆ†å¸ƒ
SELECT 
    h1.employee_id,
    h1.name,
    h1.level,
    (SELECT COUNT(*) 
     FROM department_hierarchy h2 
     WHERE h2.hierarchy_path LIKE CONCAT(h1.hierarchy_path, '%')
       AND h2.level > h1.level
    ) as direct_and_indirect_subordinates
FROM department_hierarchy h1
ORDER BY level, employee_id;
```

### 8.2 äº§å“åˆ†ç±»æ ‘æŸ¥è¯¢æ¡ˆä¾‹


**ğŸ›’ ç”µå•†åˆ†ç±»åœºæ™¯**ï¼šæŸ¥è¯¢æŸä¸ªåˆ†ç±»ä¸‹çš„æ‰€æœ‰å­åˆ†ç±»å’Œå•†å“æ•°é‡ã€‚

```sql
-- äº§å“åˆ†ç±»é€’å½’æŸ¥è¯¢ï¼ˆå¸¦æ€§èƒ½ä¼˜åŒ–ï¼‰
WITH RECURSIVE category_tree(
    category_id,
    category_name,
    parent_id,
    level,
    category_path,
    product_count
) AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼šæŒ‡å®šçš„çˆ¶åˆ†ç±»
    SELECT 
        c.category_id,
        c.category_name,
        c.parent_id,
        1 as level,
        CAST(c.category_name AS CHAR(500)) as category_path,
        COALESCE(p.product_count, 0) as product_count
    FROM categories c
    LEFT JOIN (
        -- é¢„è®¡ç®—æ¯ä¸ªåˆ†ç±»çš„å•†å“æ•°é‡
        SELECT category_id, COUNT(*) as product_count
        FROM products 
        WHERE status = 'active'
        GROUP BY category_id
    ) p ON c.category_id = p.category_id
    WHERE c.category_id = 100  -- æŸ¥è¯¢åˆ†ç±»IDä¸º100çš„å­æ ‘
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šå­åˆ†ç±»
    SELECT 
        c.category_id,
        c.category_name,
        c.parent_id,
        t.level + 1,
        CONCAT(t.category_path, ' > ', c.category_name),
        COALESCE(p.product_count, 0)
    FROM categories c
    INNER JOIN category_tree t ON c.parent_id = t.category_id
    LEFT JOIN (
        SELECT category_id, COUNT(*) as product_count
        FROM products 
        WHERE status = 'active'
        GROUP BY category_id
    ) p ON c.category_id = p.category_id
    WHERE t.level < 5  -- ğŸ¯ ç”µå•†åˆ†ç±»ä¸€èˆ¬ä¸è¶…è¿‡5å±‚
      AND c.status = 'active'  -- åªæŸ¥è¯¢æœ‰æ•ˆåˆ†ç±»
)
-- ç»“æœæ±‡æ€»
SELECT 
    level,
    COUNT(*) as category_count,
    SUM(product_count) as total_products,
    GROUP_CONCAT(category_name ORDER BY category_name) as categories
FROM category_tree
GROUP BY level
ORDER BY level;
```

### 8.3 æœ€ä½³å®è·µæ€»ç»“


**ğŸ† é€’å½’CTEæœ€ä½³å®è·µæ¸…å•**ï¼š

```
ğŸ”¸ è®¾è®¡é˜¶æ®µï¼š
âœ… åˆ†æä¸šåŠ¡åœºæ™¯çš„æœ€å¤§åˆç†æ·±åº¦
âœ… è®¾è®¡åˆé€‚çš„æ•°æ®è¡¨ç»“æ„å’Œç´¢å¼•
âœ… è€ƒè™‘æ•°æ®ä¸­å¯èƒ½å­˜åœ¨çš„ç¯è·¯æƒ…å†µ

ğŸ”¸ å¼€å‘é˜¶æ®µï¼š
âœ… å§‹ç»ˆåŒ…å«ç»ˆæ­¢æ¡ä»¶ï¼ˆWHERE level < Nï¼‰
âœ… æ·»åŠ ç¯è·¯æ£€æµ‹æœºåˆ¶ï¼ˆè·¯å¾„è®°å½•æˆ–è®¿é—®æ ‡è®°ï¼‰
âœ… åˆç†è®¾ç½® cte_max_recursion_depth
âœ… åªé€‰æ‹©å¿…è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“

ğŸ”¸ æµ‹è¯•é˜¶æ®µï¼š
âœ… æµ‹è¯•æ­£å¸¸æ•°æ®çš„æŸ¥è¯¢æ•ˆæœ
âœ… æµ‹è¯•åŒ…å«ç¯è·¯çš„å¼‚å¸¸æ•°æ®
âœ… æµ‹è¯•æé™æ·±åº¦çš„æ€§èƒ½è¡¨ç°
âœ… éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶

ğŸ”¸ ç”Ÿäº§é˜¶æ®µï¼š
âœ… è®¾ç½®ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
âœ… å®šæœŸæ£€æŸ¥é€’å½’æŸ¥è¯¢çš„æ€§èƒ½
âœ… æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´å‚æ•°
âœ… å»ºç«‹åº”æ€¥å¤„ç†é¢„æ¡ˆ
```

**âš ï¸ å¸¸è§é”™è¯¯é¿å…**ï¼š
```
âŒ å¿˜è®°è®¾ç½®ç»ˆæ­¢æ¡ä»¶
âŒ ç»ˆæ­¢æ¡ä»¶è®¾ç½®è¿‡å®½æ¾
âŒ æ²¡æœ‰è€ƒè™‘æ•°æ®ä¸­çš„ç¯è·¯
âŒ ç³»ç»Ÿå˜é‡è®¾ç½®è¿‡å¤§
âŒ ç¼ºå°‘æ€§èƒ½ç›‘æ§
âŒ é€‰æ‹©è¿‡å¤šä¸å¿…è¦çš„å­—æ®µ
âŒ æ²¡æœ‰å»ºç«‹ç´¢å¼•ä¼˜åŒ–
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¥ cte_max_recursion_depthï¼š
   â€¢ MySQLé€’å½’æ·±åº¦çš„ç¡¬æ€§é™åˆ¶
   â€¢ é»˜è®¤1000æ¬¡ï¼Œå¯è°ƒæ•´
   â€¢ å…¨å±€å’Œä¼šè¯ä¸¤ä¸ªçº§åˆ«
   â€¢ è¶…è¿‡é™åˆ¶ä¼šæŠ›å‡ºERROR 3636é”™è¯¯

ğŸ”¸ é€’å½’ç»ˆæ­¢æ¡ä»¶ï¼š
   â€¢ WHEREå­å¥ä¸­çš„é™åˆ¶æ¡ä»¶
   â€¢ å†³å®šé€’å½’ä½•æ—¶è‡ªç„¶åœæ­¢
   â€¢ å¿…é¡»åŸºäºä¸šåŠ¡é€»è¾‘è®¾è®¡

ğŸ”¸ æ— é™é€’å½’æ£€æµ‹ï¼š
   â€¢ è¯†åˆ«å’Œé˜²æ­¢ç¯è·¯é—®é¢˜
   â€¢ è·¯å¾„è®°å½•æ³•å’Œè®¡æ•°å™¨æ³•
   â€¢ æ—©æœŸå‘ç°å¼‚å¸¸æƒ…å†µ

ğŸ”¸ æ·±åº¦ç›‘æ§æœºåˆ¶ï¼š
   â€¢ å®æ—¶ç›‘æ§é€’å½’æŸ¥è¯¢çŠ¶æ€
   â€¢ å¤šçº§é¢„è­¦ä½“ç³»
   â€¢ è‡ªåŠ¨å‘Šè­¦å’Œå¹²é¢„
```

### 9.2 å…³é”®å®‰å…¨ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤ä¸‰è¦ç´ **ï¼š
```
1ï¸âƒ£ è®¾ç½®åˆç†é™åˆ¶ï¼š
   ç³»ç»Ÿå˜é‡ + ä¸šåŠ¡æ¡ä»¶ + æ€§èƒ½è€ƒè™‘
   
2ï¸âƒ£ ç¯è·¯æ£€æµ‹é˜²æŠ¤ï¼š
   è·¯å¾„è®°å½• + é‡å¤è®¿é—®æ£€æŸ¥
   
3ï¸âƒ£ ç›‘æ§å‘Šè­¦ä½“ç³»ï¼š
   å®æ—¶ç›‘æ§ + è‡ªåŠ¨é¢„è­¦ + åº”æ€¥å¤„ç†
```

### 9.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


```
âš¡ æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒï¼š
â€¢ ç´¢å¼•è®¾è®¡ï¼šæ”¯æŒé€’å½’è¿æ¥çš„å¤åˆç´¢å¼•
â€¢ å­—æ®µé€‰æ‹©ï¼šåªæŸ¥è¯¢å¿…è¦å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
â€¢ æ‰¹é‡å¤„ç†ï¼šå¤§æ•°æ®é›†åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å•æ¬¡æŸ¥è¯¢è¿‡é‡
â€¢ ç¼“å­˜ç­–ç•¥ï¼šå¯¹ç¨³å®šçš„å±‚çº§ç»“æ„è¿›è¡Œç¼“å­˜
```

### 9.4 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ åº”ç”¨åœºæ™¯åŒ¹é…**ï¼š
```
ğŸ“Š ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼š
   æ¨èæ·±åº¦ï¼š5-8å±‚
   ä¸»è¦é£é™©ï¼šäººäº‹å˜åŠ¨å¯¼è‡´çš„ç¯è·¯
   
ğŸ›’ å•†å“åˆ†ç±»æŸ¥è¯¢ï¼š
   æ¨èæ·±åº¦ï¼š3-5å±‚  
   ä¸»è¦é£é™©ï¼šåˆ†ç±»è°ƒæ•´å¯¼è‡´çš„å¾ªç¯å¼•ç”¨
   
ğŸ“ æ–‡ä»¶ç³»ç»Ÿéå†ï¼š
   æ¨èæ·±åº¦ï¼š10-20å±‚
   ä¸»è¦é£é™©ï¼šè½¯é“¾æ¥å½¢æˆçš„æ— é™å¾ªç¯
   
ğŸŒ ç½‘ç»œæ‹“æ‰‘åˆ†æï¼š
   æ¨èæ·±åº¦ï¼š50-100å±‚
   ä¸»è¦é£é™©ï¼šè·¯ç”±ç¯è·¯å’Œå¤æ‚ç½‘ç»œç»“æ„
```

### 9.5 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®


**ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… ç³»ç»Ÿé…ç½®ï¼š
   - [ ] è®¾ç½®åˆé€‚çš„ cte_max_recursion_depth
   - [ ] é…ç½®æŸ¥è¯¢è¶…æ—¶æ—¶é—´
   - [ ] å»ºç«‹æ€§èƒ½ç›‘æ§

âœ… ä»£ç è´¨é‡ï¼š
   - [ ] æ‰€æœ‰é€’å½’CTEéƒ½æœ‰ç»ˆæ­¢æ¡ä»¶
   - [ ] åŒ…å«ç¯è·¯æ£€æµ‹æœºåˆ¶
   - [ ] å¼‚å¸¸å¤„ç†å®Œå¤‡

âœ… è¿ç»´å‡†å¤‡ï¼š
   - [ ] ç›‘æ§å‘Šè­¦è§„åˆ™é…ç½®
   - [ ] åº”æ€¥å¤„ç†æµç¨‹åˆ¶å®š
   - [ ] æ€§èƒ½åŸºçº¿å»ºç«‹
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
é€’å½’æ·±åº¦è¦é™åˆ¶ï¼Œç³»ç»Ÿå˜é‡æ˜¯åŸºç¡€
ç»ˆæ­¢æ¡ä»¶å¿…é¡»æœ‰ï¼Œç¯è·¯æ£€æµ‹ä¸èƒ½å°‘  
ç›‘æ§å‘Šè­¦è¦è·Ÿä¸Šï¼Œæ€§èƒ½å®‰å…¨ä¸¤æ‰‹æŠ“
ç´¢å¼•ä¼˜åŒ–ææ•ˆç‡ï¼Œåˆ†æ‰¹å¤„ç†æ§èµ„æº
```

**ğŸ¯ å…³é”®æŠ€èƒ½**ï¼š
- ç†è§£ `cte_max_recursion_depth` çš„ä½œç”¨å’Œè®¾ç½®æ–¹æ³•
- æŒæ¡è®¾è®¡åˆç†ç»ˆæ­¢æ¡ä»¶çš„æŠ€å·§
- å­¦ä¼šè¯†åˆ«å’Œé˜²æ­¢æ— é™é€’å½’çš„æ–¹æ³•
- å»ºç«‹æœ‰æ•ˆçš„ç›‘æ§å’Œé¢„è­¦æœºåˆ¶
- é€šè¿‡æ€§èƒ½ä¼˜åŒ–æå‡é€’å½’æŸ¥è¯¢æ•ˆç‡

**æ ¸å¿ƒç†å¿µ**ï¼šé€’å½’CTEæ˜¯å¼ºå¤§çš„å·¥å…·ï¼Œä½†"èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§"ã€‚å¿…é¡»åœ¨äº«å—å…¶ä¾¿åˆ©çš„åŒæ—¶ï¼Œæ—¶åˆ»å…³æ³¨å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œåšåˆ°æ—¢èƒ½å‘æŒ¥ä½œç”¨ï¼Œåˆä¸ä¼šç»™ç³»ç»Ÿå¸¦æ¥é£é™©ã€‚