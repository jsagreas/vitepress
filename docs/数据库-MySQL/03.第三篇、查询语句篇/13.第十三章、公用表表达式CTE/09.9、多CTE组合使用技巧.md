---
title: 9ã€å¤šCTEç»„åˆä½¿ç”¨æŠ€å·§
---
## ğŸ“š ç›®å½•

1. [å¤šCTEåŸºç¡€æ¦‚å¿µ](#1-å¤šCTEåŸºç¡€æ¦‚å¿µ)
2. [CTEä¸²è”å®šä¹‰è¯­æ³•](#2-CTEä¸²è”å®šä¹‰è¯­æ³•)
3. [CTEä¾èµ–å…³ç³»ç®¡ç†](#3-CTEä¾èµ–å…³ç³»ç®¡ç†)
4. [å¤æ‚ä¸šåŠ¡é€»è¾‘æ‹†åˆ†](#4-å¤æ‚ä¸šåŠ¡é€»è¾‘æ‹†åˆ†)
5. [å¯å¤ç”¨CTEè®¾è®¡åŸåˆ™](#5-å¯å¤ç”¨CTEè®¾è®¡åŸåˆ™)
6. [å¤šCTEæ€§èƒ½ä¼˜åŒ–](#6-å¤šCTEæ€§èƒ½ä¼˜åŒ–)
7. [å‘½åç­–ç•¥ä¸è§„èŒƒ](#7-å‘½åç­–ç•¥ä¸è§„èŒƒ)
8. [å®é™…åº”ç”¨æ¡ˆä¾‹](#8-å®é™…åº”ç”¨æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— å¤šCTEåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šCTEç»„åˆ


**ğŸ”¸ å¤šCTEå®šä¹‰**
```
å¤šCTEï¼šåœ¨ä¸€ä¸ªSQLè¯­å¥ä¸­å®šä¹‰å’Œä½¿ç”¨å¤šä¸ªå…¬ç”¨è¡¨è¡¨è¾¾å¼

ç”Ÿæ´»ç±»æ¯”ï¼š
å•CTE = åšä¸€é“èœçš„å‡†å¤‡å·¥ä½œ
å¤šCTE = åšæ»¡æ±‰å…¨å¸­çš„åˆ†å·¥åä½œ

æ¯”å¦‚åšå®«ä¿é¸¡ä¸ï¼š
â€¢ CTE1ï¼šå‡†å¤‡é¸¡è‚‰ä¸ï¼ˆåˆ‡ä¸ã€è…Œåˆ¶ï¼‰
â€¢ CTE2ï¼šå‡†å¤‡èŠ±ç”Ÿç±³ï¼ˆç‚¸åˆ¶ã€è°ƒå‘³ï¼‰
â€¢ CTE3ï¼šå‡†å¤‡è°ƒæ–™æ±ï¼ˆæ··åˆå„ç§è°ƒæ–™ï¼‰
â€¢ æœ€ç»ˆï¼šå°†ä¸‰éƒ¨åˆ†ç»„åˆç‚’åˆ¶æˆèœ

MySQLå¤šCTEï¼š
â€¢ æ¯ä¸ªCTEè´Ÿè´£ä¸€éƒ¨åˆ†é€»è¾‘å¤„ç†
â€¢ CTEé—´å¯ä»¥ç›¸äº’å¼•ç”¨å’Œä¾èµ–
â€¢ æœ€ç»ˆæŸ¥è¯¢ä½¿ç”¨è¿™äº›CTEçš„ç»“æœ
â€¢ æé«˜SQLçš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
```

**ğŸ’¡ å¤šCTE vs å•ä¸€å¤æ‚æŸ¥è¯¢**

| æ–¹å¼ | **å¯è¯»æ€§** | **ç»´æŠ¤æ€§** | **è°ƒè¯•éš¾åº¦** | **æ€§èƒ½** |
|------|-----------|-----------|-------------|---------|
| ğŸ”¸ **å•ä¸€å¤æ‚æŸ¥è¯¢** | `å·®` | `å·®` | `é«˜` | `å¯èƒ½æ›´ä¼˜` |
| ğŸ”— **å¤šCTEç»„åˆ** | `å¥½` | `å¥½` | `ä½` | `åŸºæœ¬ç›¸å½“` |

### 1.2 å¤šCTEè§£å†³çš„é—®é¢˜


**ğŸ¯ æ ¸å¿ƒä»·å€¼**
```
å¤æ‚é€»è¾‘åˆ†è§£ï¼š
âŒ é—®é¢˜ï¼šä¸€ä¸ªSQLåŒ…å«æ•°ç™¾è¡Œï¼Œé€»è¾‘å¤æ‚éš¾æ‡‚
âœ… è§£å†³ï¼šåˆ†è§£ä¸ºå¤šä¸ªCTEï¼Œæ¯ä¸ªCTEèŒè´£æ˜ç¡®

ä»£ç å¤ç”¨ï¼š
âŒ é—®é¢˜ï¼šç›¸åŒçš„å­æŸ¥è¯¢åœ¨å¤šå¤„é‡å¤å‡ºç°
âœ… è§£å†³ï¼šå®šä¹‰ä¸€æ¬¡CTEï¼Œå¤šå¤„å¼•ç”¨

è°ƒè¯•ä¾¿åˆ©ï¼š
âŒ é—®é¢˜ï¼šå¤æ‚æŸ¥è¯¢å‡ºé”™æ—¶éš¾ä»¥å®šä½é—®é¢˜
âœ… è§£å†³ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªCTEçš„ç»“æœ

å›¢é˜Ÿåä½œï¼š
âŒ é—®é¢˜ï¼šå¤æ‚SQLéš¾ä»¥ç†è§£å’Œä¿®æ”¹
âœ… è§£å†³ï¼šæ¸…æ™°çš„CTEç»“æ„ä¾¿äºå›¢é˜Ÿç»´æŠ¤
```

### 1.3 å¤šCTEåŸºæœ¬ç»“æ„


**ğŸ—ï¸ å¤šCTEè¯­æ³•æ¡†æ¶**
```sql
-- å¤šCTEåŸºæœ¬ç»“æ„
WITH 
    cte1_name (column1, column2) AS (
        -- ç¬¬ä¸€ä¸ªCTEå®šä¹‰
        SELECT ... FROM ...
    ),
    cte2_name AS (
        -- ç¬¬äºŒä¸ªCTEï¼Œå¯ä»¥å¼•ç”¨cte1
        SELECT ... FROM cte1_name ...
    ),
    cte3_name AS (
        -- ç¬¬ä¸‰ä¸ªCTEï¼Œå¯ä»¥å¼•ç”¨å‰é¢çš„CTE
        SELECT ... FROM cte1_name JOIN cte2_name ...
    )
-- ä¸»æŸ¥è¯¢ä½¿ç”¨è¿™äº›CTE
SELECT ... FROM cte1_name, cte2_name, cte3_name;
```

---

## 2. ğŸ“ CTEä¸²è”å®šä¹‰è¯­æ³•


### 2.1 åŸºç¡€ä¸²è”è¯­æ³•


**ğŸ”¸ å¤šCTEå®šä¹‰è§„åˆ™**
```
è¯­æ³•è¦ç‚¹ï¼š
â€¢ ç”¨é€—å·åˆ†éš”å¤šä¸ªCTEå®šä¹‰
â€¢ æ¯ä¸ªCTEéƒ½æœ‰ç‹¬ç«‹çš„åç§°å’Œç»“æ„
â€¢ åå®šä¹‰çš„CTEå¯ä»¥å¼•ç”¨å‰é¢å®šä¹‰çš„CTE
â€¢ æ‰€æœ‰CTEå®šä¹‰å®Œæˆåæ‰èƒ½å†™ä¸»æŸ¥è¯¢
```

```sql
-- åŸºç¡€ç¤ºä¾‹ï¼šé”€å”®æ•°æ®åˆ†æ
WITH 
    -- CTE1ï¼šè®¡ç®—æ¯ä¸ªé”€å”®å‘˜çš„é”€å”®é¢
    sales_summary AS (
        SELECT 
            salesperson_id,
            COUNT(*) AS order_count,
            SUM(amount) AS total_sales
        FROM orders
        WHERE order_date >= '2024-01-01'
        GROUP BY salesperson_id
    ),
    
    -- CTE2ï¼šè®¡ç®—é”€å”®å‘˜æ’å
    sales_ranking AS (
        SELECT 
            salesperson_id,
            total_sales,
            RANK() OVER (ORDER BY total_sales DESC) AS sales_rank
        FROM sales_summary
    ),
    
    -- CTE3ï¼šè·å–é”€å”®å‘˜åŸºæœ¬ä¿¡æ¯
    salesperson_info AS (
        SELECT 
            sp.id,
            sp.name,
            sp.department,
            sr.total_sales,
            sr.sales_rank
        FROM salesperson sp
        JOIN sales_ranking sr ON sp.id = sr.salesperson_id
    )

-- ä¸»æŸ¥è¯¢ï¼šå±•ç¤ºæœ€ç»ˆç»“æœ
SELECT 
    name,
    department,
    total_sales,
    sales_rank,
    CASE 
        WHEN sales_rank <= 3 THEN 'é‡‘ç‰Œé”€å”®'
        WHEN sales_rank <= 10 THEN 'é“¶ç‰Œé”€å”®'
        ELSE 'æ™®é€šé”€å”®'
    END AS performance_level
FROM salesperson_info
ORDER BY sales_rank;
```

### 2.2 CTEé—´çš„æ•°æ®æµè½¬


**ğŸ”„ æ•°æ®æµè½¬å›¾ç¤º**
```
æ•°æ®æµè½¬ç¤ºæ„ï¼š

åŸå§‹è¡¨          CTE1å¤„ç†         CTE2å¤„ç†         CTE3æ•´åˆ         æœ€ç»ˆç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orders  â”‚â”€â”€â”€â–¶â”‚sales_   â”‚â”€â”€â”€â–¶â”‚sales_   â”‚â”€â”€â”€â–¶â”‚sales_   â”‚â”€â”€â”€â–¶â”‚æœ€ç»ˆ    â”‚
â”‚ table   â”‚    â”‚summary  â”‚    â”‚ranking  â”‚    â”‚person_  â”‚    â”‚æŠ¥è¡¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚info     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚         â”‚
â”‚sales_   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚
â”‚person   â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ æ¯ä¸ªCTEæ¥æ”¶å‰ä¸€æ­¥çš„å¤„ç†ç»“æœ
â€¢ å¯ä»¥å¼•ç”¨å¤šä¸ªå‰é¢çš„CTE
â€¢ å½¢æˆæ¸…æ™°çš„æ•°æ®å¤„ç†ç®¡é“
```

### 2.3 é€’å½’CTEä¸éé€’å½’CTEç»„åˆ


```sql
-- é€’å½’CTEä¸æ™®é€šCTEæ··åˆä½¿ç”¨
WITH RECURSIVE
    -- æ™®é€šCTEï¼šéƒ¨é—¨ä¿¡æ¯
    dept_info AS (
        SELECT 
            dept_id,
            dept_name,
            manager_id
        FROM departments
        WHERE status = 'active'
    ),
    
    -- é€’å½’CTEï¼šç»„ç»‡æ¶æ„å±‚çº§
    org_hierarchy AS (
        -- é”šç‚¹ï¼šé¡¶çº§éƒ¨é—¨
        SELECT 
            dept_id,
            dept_name,
            manager_id,
            0 AS level,
            CAST(dept_name AS CHAR(500)) AS path
        FROM dept_info
        WHERE manager_id IS NULL
        
        UNION ALL
        
        -- é€’å½’ï¼šå­éƒ¨é—¨
        SELECT 
            d.dept_id,
            d.dept_name,
            d.manager_id,
            oh.level + 1,
            CONCAT(oh.path, ' > ', d.dept_name)
        FROM dept_info d
        JOIN org_hierarchy oh ON d.manager_id = oh.dept_id
        WHERE oh.level < 5  -- é˜²æ­¢æ— é™é€’å½’
    ),
    
    -- æ™®é€šCTEï¼šå‘˜å·¥ç»Ÿè®¡
    dept_employee_count AS (
        SELECT 
            dept_id,
            COUNT(*) AS employee_count
        FROM employees
        WHERE status = 'active'
        GROUP BY dept_id
    )

-- ä¸»æŸ¥è¯¢ï¼šç»„ç»‡æ¶æ„æŠ¥è¡¨
SELECT 
    oh.dept_name,
    oh.level,
    oh.path,
    COALESCE(dec.employee_count, 0) AS employee_count
FROM org_hierarchy oh
LEFT JOIN dept_employee_count dec ON oh.dept_id = dec.dept_id
ORDER BY oh.path;
```

---

## 3. ğŸ”„ CTEä¾èµ–å…³ç³»ç®¡ç†


### 3.1 ä¾èµ–å…³ç³»åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ CTEä¾èµ–å…³ç³»**
```
ä¾èµ–å…³ç³»ç±»å‹ï¼š

çº¿æ€§ä¾èµ–ï¼šA â†’ B â†’ C â†’ D
â€¢ CTE Bä¾èµ–CTE A
â€¢ CTE Cä¾èµ–CTE B
â€¢ å½¢æˆå¤„ç†é“¾æ¡

å¹¶è¡Œä¾èµ–ï¼šA â†’ B, A â†’ C â†’ D
â€¢ CTE Bå’ŒCTE Céƒ½ä¾èµ–CTE A
â€¢ CTE Dä¾èµ–CTE C
â€¢ å¯ä»¥å¹¶è¡Œå¤„ç†Bå’ŒC

å¤æ‚ä¾èµ–ï¼šå¤šå¯¹å¤šå¼•ç”¨å…³ç³»
â€¢ éœ€è¦ä»”ç»†ç®¡ç†ä¾èµ–é¡ºåº
â€¢ é¿å…å¾ªç¯ä¾èµ–
```

**ğŸ”— ä¾èµ–å…³ç³»å›¾ç¤º**
```
ä¾èµ–å…³ç³»ç¤ºä¾‹ï¼š

åœºæ™¯ï¼šç”µå•†è®¢å•åˆ†ææŠ¥è¡¨

åŸå§‹æ•°æ®         å¤„ç†å±‚çº§1        å¤„ç†å±‚çº§2         æœ€ç»ˆæ•´åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orders  â”‚â”€â”€â”€â”€â–¶â”‚order_   â”‚â”€â”€â”€â”€â–¶â”‚order_   â”‚â”€â”€â”€â”€â–¶â”‚final_   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚summary  â”‚     â”‚metrics  â”‚     â”‚report   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚products â”‚â”€â”€â”€â”€â–¶â”‚product_ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚info     â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚customersâ”‚â”€â”€â”€â”€â–¶â”‚customer_â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚profile  â”‚           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚final_   â”‚
                                â”‚report   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾èµ–å…³ç³»ï¼š
â€¢ order_metrics ä¾èµ– order_summary å’Œ product_info
â€¢ final_report ä¾èµ– order_metrics å’Œ customer_profile
```

### 3.2 ä¾èµ–å…³ç³»è®¾è®¡åŸåˆ™


**ğŸ“‹ è®¾è®¡åŸåˆ™**
```
ğŸ”¸ å•ä¸€èŒè´£åŸåˆ™ï¼š
â€¢ æ¯ä¸ªCTEåªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡é€»è¾‘
â€¢ é¿å…åœ¨ä¸€ä¸ªCTEä¸­å¤„ç†å¤šç§ä¸ç›¸å…³çš„è®¡ç®—

ğŸ”¸ æœ€å°ä¾èµ–åŸåˆ™ï¼š
â€¢ å‡å°‘CTEé—´çš„ä¾èµ–å…³ç³»
â€¢ èƒ½ç‹¬ç«‹è®¡ç®—çš„é€»è¾‘å°½é‡ç‹¬ç«‹

ğŸ”¸ å±‚æ¬¡æ¸…æ™°åŸåˆ™ï¼š
â€¢ æŒ‰å¤„ç†å±‚æ¬¡ç»„ç»‡CTE
â€¢ æ•°æ®æµå‘æ¸…æ™°å¯è§

ğŸ”¸ å¯æµ‹è¯•åŸåˆ™ï¼š
â€¢ æ¯ä¸ªCTEéƒ½å¯ä»¥å•ç‹¬æµ‹è¯•
â€¢ ä¾¿äºè°ƒè¯•å’ŒéªŒè¯ç»“æœ
```

### 3.3 ä¾èµ–å…³ç³»å®ç°


```sql
-- ä¾èµ–å…³ç³»ç®¡ç†ç¤ºä¾‹ï¼šå­¦ç”Ÿæˆç»©åˆ†æ
WITH 
    -- å±‚çº§1ï¼šåŸºç¡€æ•°æ®æ¸…æ´—
    clean_scores AS (
        SELECT 
            student_id,
            course_id,
            score,
            exam_date
        FROM exam_scores
        WHERE score BETWEEN 0 AND 100
          AND exam_date >= '2024-01-01'
    ),
    
    -- å±‚çº§1ï¼šè¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ï¼ˆä¸clean_scoreså¹¶è¡Œï¼‰
    course_info AS (
        SELECT 
            course_id,
            course_name,
            credit_hours,
            course_type
        FROM courses
        WHERE status = 'active'
    ),
    
    -- å±‚çº§2ï¼šå­¦ç”Ÿå¹³å‡æˆç»©ï¼ˆä¾èµ–clean_scoresï¼‰
    student_avg_scores AS (
        SELECT 
            student_id,
            AVG(score) AS avg_score,
            COUNT(*) AS exam_count
        FROM clean_scores
        GROUP BY student_id
    ),
    
    -- å±‚çº§2ï¼šè¯¾ç¨‹å¹³å‡æˆç»©ï¼ˆä¾èµ–clean_scoresï¼‰
    course_avg_scores AS (
        SELECT 
            course_id,
            AVG(score) AS course_avg,
            COUNT(*) AS student_count
        FROM clean_scores
        GROUP BY course_id
    ),
    
    -- å±‚çº§3ï¼šç»¼åˆåˆ†æï¼ˆä¾èµ–å¤šä¸ªå‰é¢çš„CTEï¼‰
    comprehensive_analysis AS (
        SELECT 
            cs.student_id,
            cs.course_id,
            ci.course_name,
            cs.score,
            sas.avg_score AS student_avg,
            cas.course_avg,
            -- è®¡ç®—ç›¸å¯¹è¡¨ç°
            cs.score - cas.course_avg AS relative_performance
        FROM clean_scores cs
        JOIN course_info ci ON cs.course_id = ci.course_id
        JOIN student_avg_scores sas ON cs.student_id = sas.student_id
        JOIN course_avg_scores cas ON cs.course_id = cas.course_id
    )

-- ä¸»æŸ¥è¯¢ï¼šç”Ÿæˆæœ€ç»ˆæŠ¥è¡¨
SELECT 
    student_id,
    course_name,
    score,
    student_avg,
    course_avg,
    relative_performance,
    CASE 
        WHEN relative_performance > 10 THEN 'è¶…è¶Šå¹³å‡'
        WHEN relative_performance > -5 THEN 'æ¥è¿‘å¹³å‡'
        ELSE 'ä½äºå¹³å‡'
    END AS performance_category
FROM comprehensive_analysis
ORDER BY student_id, relative_performance DESC;
```

---

## 4. ğŸ§© å¤æ‚ä¸šåŠ¡é€»è¾‘æ‹†åˆ†


### 4.1 ä¸šåŠ¡é€»è¾‘æ‹†åˆ†ç­–ç•¥


**ğŸ”¸ æ‹†åˆ†åŸåˆ™**
```
æŒ‰æ•°æ®å¤„ç†é˜¶æ®µæ‹†åˆ†ï¼š
â€¢ æ•°æ®æŠ½å–å’Œè¿‡æ»¤
â€¢ æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–
â€¢ ä¸šåŠ¡è®¡ç®—å’Œç»Ÿè®¡
â€¢ ç»“æœæ•´åˆå’Œè¾“å‡º

æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼š
â€¢ è®¢å•ç›¸å…³é€»è¾‘
â€¢ å®¢æˆ·ç›¸å…³é€»è¾‘
â€¢ äº§å“ç›¸å…³é€»è¾‘
â€¢ è´¢åŠ¡ç›¸å…³é€»è¾‘

æŒ‰è®¡ç®—å¤æ‚åº¦æ‹†åˆ†ï¼š
â€¢ ç®€å•èšåˆè®¡ç®—
â€¢ å¤æ‚çš„çª—å£å‡½æ•°
â€¢ æ¡ä»¶é€»è¾‘åˆ¤æ–­
â€¢ è·¨è¡¨å…³è”æŸ¥è¯¢
```

### 4.2 å¤æ‚æŠ¥è¡¨æ‹†åˆ†æ¡ˆä¾‹


**ğŸ“Š ç”µå•†é”€å”®æŠ¥è¡¨æ‹†åˆ†**
```sql
-- å¤æ‚çš„ç”µå•†é”€å”®åˆ†ææŠ¥è¡¨
WITH 
    -- ç¬¬1æ­¥ï¼šè®¢å•åŸºç¡€æ•°æ®æ¸…æ´—
    clean_orders AS (
        SELECT 
            order_id,
            customer_id,
            product_id,
            quantity,
            unit_price,
            quantity * unit_price AS line_total,
            order_date,
            status
        FROM order_items oi
        JOIN orders o ON oi.order_id = o.id
        WHERE o.status = 'completed'
          AND o.order_date >= '2024-01-01'
    ),
    
    -- ç¬¬2æ­¥ï¼šå®¢æˆ·åˆ†ç±»ï¼ˆVIPã€æ™®é€šã€æ–°å®¢æˆ·ï¼‰
    customer_segments AS (
        SELECT 
            c.customer_id,
            c.register_date,
            COUNT(DISTINCT co.order_id) AS total_orders,
            SUM(co.line_total) AS total_spent,
            CASE 
                WHEN SUM(co.line_total) > 10000 THEN 'VIP'
                WHEN COUNT(DISTINCT co.order_id) > 5 THEN 'Regular'
                ELSE 'New'
            END AS customer_segment
        FROM customers c
        LEFT JOIN clean_orders co ON c.customer_id = co.customer_id
        GROUP BY c.customer_id, c.register_date
    ),
    
    -- ç¬¬3æ­¥ï¼šäº§å“é”€å”®ç»Ÿè®¡
    product_performance AS (
        SELECT 
            product_id,
            SUM(quantity) AS total_quantity,
            SUM(line_total) AS total_revenue,
            COUNT(DISTINCT customer_id) AS unique_customers,
            AVG(unit_price) AS avg_price
        FROM clean_orders
        GROUP BY product_id
    ),
    
    -- ç¬¬4æ­¥ï¼šæœˆåº¦é”€å”®è¶‹åŠ¿
    monthly_trends AS (
        SELECT 
            DATE_FORMAT(order_date, '%Y-%m') AS month,
            COUNT(DISTINCT order_id) AS monthly_orders,
            SUM(line_total) AS monthly_revenue,
            COUNT(DISTINCT customer_id) AS monthly_customers
        FROM clean_orders
        GROUP BY DATE_FORMAT(order_date, '%Y-%m')
    ),
    
    -- ç¬¬5æ­¥ï¼šç»¼åˆæŒ‡æ ‡è®¡ç®—
    comprehensive_metrics AS (
        SELECT 
            co.product_id,
            p.product_name,
            pp.total_quantity,
            pp.total_revenue,
            cs.customer_segment,
            COUNT(*) AS segment_orders
        FROM clean_orders co
        JOIN products p ON co.product_id = p.id
        JOIN product_performance pp ON co.product_id = pp.product_id
        JOIN customer_segments cs ON co.customer_id = cs.customer_id
        GROUP BY co.product_id, p.product_name, pp.total_quantity, 
                 pp.total_revenue, cs.customer_segment
    )

-- æœ€ç»ˆæŠ¥è¡¨æŸ¥è¯¢
SELECT 
    product_name,
    total_quantity,
    total_revenue,
    customer_segment,
    segment_orders,
    ROUND(segment_orders * 100.0 / total_quantity, 2) AS segment_percentage
FROM comprehensive_metrics
ORDER BY total_revenue DESC, customer_segment;
```

### 4.3 åˆ†æ­¥è°ƒè¯•æŠ€å·§


**ğŸ” CTEè°ƒè¯•æ–¹æ³•**
```sql
-- è°ƒè¯•æŠ€å·§ï¼šé€æ­¥éªŒè¯æ¯ä¸ªCTE
-- æ­¥éª¤1ï¼šå•ç‹¬æµ‹è¯•ç¬¬ä¸€ä¸ªCTE
WITH clean_orders AS (
    SELECT order_id, customer_id, quantity * unit_price AS line_total
    FROM order_items oi JOIN orders o ON oi.order_id = o.id
    WHERE o.status = 'completed'
)
SELECT COUNT(*), SUM(line_total) FROM clean_orders;

-- æ­¥éª¤2ï¼šæµ‹è¯•åˆ°ç¬¬äºŒä¸ªCTE
WITH 
    clean_orders AS (...),
    customer_segments AS (
        SELECT customer_id, 
               SUM(line_total) AS total_spent,
               CASE WHEN SUM(line_total) > 10000 THEN 'VIP' ELSE 'Regular' END AS segment
        FROM clean_orders GROUP BY customer_id
    )
SELECT segment, COUNT(*) FROM customer_segments GROUP BY segment;

-- æ­¥éª¤3ï¼šé€æ­¥æ·»åŠ æ›´å¤šCTEè¿›è¡Œæµ‹è¯•
-- ...

è°ƒè¯•åŸåˆ™ï¼š
â€¢ ä»ç®€å•CTEå¼€å§‹æµ‹è¯•
â€¢ é€ä¸ªæ·»åŠ CTEéªŒè¯ç»“æœ
â€¢ æ£€æŸ¥æ•°æ®é‡å’Œè®¡ç®—ç»“æœçš„åˆç†æ€§
â€¢ ç¡®è®¤æ¯æ­¥çš„ä¸šåŠ¡é€»è¾‘æ­£ç¡®
```

---

## 5. ğŸ”§ å¯å¤ç”¨CTEè®¾è®¡åŸåˆ™


### 5.1 å¯å¤ç”¨è®¾è®¡æ€è·¯


**ğŸ”¸ å¤ç”¨è®¾è®¡åŸåˆ™**
```
é€šç”¨æ€§è®¾è®¡ï¼š
â€¢ CTEé€»è¾‘å…·æœ‰é€šç”¨æ€§ï¼Œä¸è¿‡åº¦ä¸“ç”¨åŒ–
â€¢ å‚æ•°åŒ–å¤„ç†ï¼Œæ”¯æŒä¸åŒæ¡ä»¶
â€¢ æ ‡å‡†åŒ–çš„è¾“å‡ºæ ¼å¼

æ¨¡å—åŒ–è®¾è®¡ï¼š
â€¢ æ¯ä¸ªCTEæ˜¯ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—
â€¢ è¾“å…¥è¾“å‡ºæ¥å£æ¸…æ™°
â€¢ å¯ä»¥åœ¨ä¸åŒæŸ¥è¯¢ä¸­é‡å¤ä½¿ç”¨

åˆ†å±‚è®¾è®¡ï¼š
â€¢ åŸºç¡€å±‚ï¼šæ•°æ®æ¸…æ´—ã€æ ¼å¼è½¬æ¢
â€¢ ä¸šåŠ¡å±‚ï¼šä¸šåŠ¡è§„åˆ™è®¡ç®—
â€¢ å±•ç°å±‚ï¼šç»“æœæ ¼å¼åŒ–
```

### 5.2 é€šç”¨CTEæ¨¡æ¿


```sql
-- å¯å¤ç”¨çš„æ—¶é—´ç»´åº¦CTEæ¨¡æ¿
WITH 
    -- é€šç”¨æ—¶é—´ç»´åº¦å¤„ç†
    time_dimensions AS (
        SELECT 
            date_col,
            YEAR(date_col) AS year,
            MONTH(date_col) AS month,
            QUARTER(date_col) AS quarter,
            WEEKOFYEAR(date_col) AS week,
            DAYOFWEEK(date_col) AS weekday,
            CASE 
                WHEN DAYOFWEEK(date_col) IN (1, 7) THEN 'å‘¨æœ«'
                ELSE 'å·¥ä½œæ—¥'
            END AS day_type
        FROM (SELECT DISTINCT order_date AS date_col FROM orders) dates
    ),
    
    -- é€šç”¨æ•°æ®æ¸…æ´—CTE
    data_cleaner AS (
        SELECT 
            *,
            CASE 
                WHEN amount IS NULL THEN 0
                WHEN amount < 0 THEN 0
                ELSE amount
            END AS clean_amount,
            TRIM(UPPER(status)) AS clean_status
        FROM raw_table
        WHERE created_date >= '2024-01-01'
    ),
    
    -- é€šç”¨æ’åè®¡ç®—CTE
    ranking_calculator AS (
        SELECT 
            *,
            ROW_NUMBER() OVER (PARTITION BY category ORDER BY amount DESC) AS rank_in_category,
            PERCENT_RANK() OVER (ORDER BY amount) AS percentile_rank
        FROM data_cleaner
    )

-- å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä½¿ç”¨å“ªäº›CTE
SELECT * FROM ranking_calculator WHERE rank_in_category <= 10;
```

### 5.3 CTEå¤ç”¨æ¨¡å¼


**ğŸ”„ å¸¸è§å¤ç”¨æ¨¡å¼**

```sql
-- æ¨¡å¼1ï¼šåŸºç¡€æ•°æ®å‡†å¤‡CTEï¼ˆé«˜å¤ç”¨æ€§ï¼‰
WITH 
    base_customer_info AS (
        SELECT 
            customer_id,
            customer_name,
            register_date,
            customer_type,
            DATEDIFF(NOW(), register_date) AS customer_age_days
        FROM customers
        WHERE status = 'active'
    ),
    
    base_order_info AS (
        SELECT 
            order_id,
            customer_id,
            order_date,
            total_amount,
            DATE_FORMAT(order_date, '%Y-%m') AS order_month
        FROM orders
        WHERE status = 'completed'
    )

-- ç”¨æ³•1ï¼šå®¢æˆ·è®¢å•ç»Ÿè®¡
SELECT 
    bci.customer_name,
    COUNT(boi.order_id) AS order_count,
    SUM(boi.total_amount) AS total_spent
FROM base_customer_info bci
LEFT JOIN base_order_info boi ON bci.customer_id = boi.customer_id
GROUP BY bci.customer_id, bci.customer_name;

-- ç”¨æ³•2ï¼šæœˆåº¦é”€å”®ç»Ÿè®¡ï¼ˆå¤ç”¨ç›¸åŒçš„CTEï¼‰
WITH 
    base_customer_info AS (...),  -- é‡å¤ä½¿ç”¨
    base_order_info AS (...)      -- é‡å¤ä½¿ç”¨
SELECT 
    order_month,
    COUNT(*) AS monthly_orders,
    SUM(total_amount) AS monthly_revenue
FROM base_order_info
GROUP BY order_month
ORDER BY order_month;
```

---

## 6. âš¡ å¤šCTEæ€§èƒ½ä¼˜åŒ–


### 6.1 æ€§èƒ½å½±å“å› ç´ 


**ğŸ“Š æ€§èƒ½å½±å“åˆ†æ**
```
CTEæ•°é‡å½±å“ï¼š
â€¢ è¿‡å¤šCTEå¢åŠ æŸ¥è¯¢å¤æ‚åº¦
â€¢ æ¯ä¸ªCTEéƒ½éœ€è¦å†…å­˜å­˜å‚¨ä¸­é—´ç»“æœ
â€¢ ä¼˜åŒ–å™¨å¤„ç†å¤æ‚åº¦å¢åŠ 

ä¾èµ–å…³ç³»å½±å“ï¼š
â€¢ çº¿æ€§ä¾èµ–ï¼šé¡ºåºæ‰§è¡Œï¼Œæ€§èƒ½å¯é¢„æµ‹
â€¢ å¤æ‚ä¾èµ–ï¼šå¯èƒ½å½±å“ä¼˜åŒ–å™¨é€‰æ‹©æ‰§è¡Œè®¡åˆ’
â€¢ å¾ªç¯å¼•ç”¨ï¼šä¼šå¯¼è‡´æŸ¥è¯¢å¤±è´¥

æ•°æ®é‡å½±å“ï¼š
â€¢ å¤§æ•°æ®é‡çš„CTEå ç”¨æ›´å¤šå†…å­˜
â€¢ ä¸­é—´ç»“æœé›†è¿‡å¤§å½±å“åç»­å¤„ç†
â€¢ éœ€è¦è€ƒè™‘æ•°æ®é‡åœ¨å„CTEé—´çš„å˜åŒ–
```

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ ä¼˜åŒ–æŠ€å·§**

| ä¼˜åŒ–ç­–ç•¥ | **å®ç°æ–¹æ³•** | **é€‚ç”¨åœºæ™¯** | **æ•ˆæœ** |
|---------|------------|-------------|---------|
| ğŸ” **æ—©æœŸè¿‡æ»¤** | `åœ¨ç¬¬ä¸€ä¸ªCTEä¸­å°½æ—©è¿‡æ»¤æ•°æ®` | `å¤§è¡¨æŸ¥è¯¢` | `å‡å°‘åç»­CTEå¤„ç†é‡` |
| ğŸ“Š **ç´¢å¼•åˆ©ç”¨** | `ç¡®ä¿CTEæŸ¥è¯¢èƒ½ä½¿ç”¨ç´¢å¼•` | `å…³è”æŸ¥è¯¢å¤š` | `æå‡æŸ¥è¯¢é€Ÿåº¦` |
| ğŸ’¾ **ä¸­é—´ç»“æœä¼˜åŒ–** | `æ§åˆ¶ä¸­é—´ç»“æœé›†å¤§å°` | `å¤šå±‚CTE` | `å‡å°‘å†…å­˜å ç”¨` |
| ğŸ”„ **æ‰§è¡Œé¡ºåº** | `åˆç†å®‰æ’CTEå®šä¹‰é¡ºåº` | `å¤æ‚ä¾èµ–` | `ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’` |

```sql
-- æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
WITH 
    -- ä¼˜åŒ–1ï¼šæ—©æœŸè¿‡æ»¤ï¼Œå‡å°‘æ•°æ®é‡
    filtered_orders AS (
        SELECT order_id, customer_id, product_id, amount
        FROM orders
        WHERE order_date >= '2024-01-01'  -- å°½æ—©è¿‡æ»¤
          AND status = 'completed'
          AND amount > 0
    ),
    
    -- ä¼˜åŒ–2ï¼šåˆ©ç”¨ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æ
    indexed_products AS (
        SELECT product_id, product_name, category_id
        FROM products
        WHERE category_id IN (1, 2, 3)  -- ä½¿ç”¨ç´¢å¼•å­—æ®µ
    ),
    
    -- ä¼˜åŒ–3ï¼šæ§åˆ¶ç»“æœé›†å¤§å°
    top_products AS (
        SELECT 
            p.product_id,
            p.product_name,
            SUM(fo.amount) AS revenue
        FROM filtered_orders fo
        JOIN indexed_products p ON fo.product_id = p.product_id
        GROUP BY p.product_id, p.product_name
        ORDER BY revenue DESC
        LIMIT 100  -- é™åˆ¶ç»“æœé›†å¤§å°
    )

SELECT * FROM top_products;
```

### 6.3 æ‰§è¡Œè®¡åˆ’åˆ†æ


```sql
-- åˆ†æå¤šCTEæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN FORMAT=JSON
WITH 
    cte1 AS (SELECT ...),
    cte2 AS (SELECT ...),
    cte3 AS (SELECT ...)
SELECT ... FROM cte1 JOIN cte2 ON ... JOIN cte3 ON ...;

-- å…³æ³¨ç‚¹ï¼š
-- 1. æ¯ä¸ªCTEæ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•
-- 2. å…³è”æ“ä½œçš„æˆæœ¬
-- 3. ä¸´æ—¶è¡¨çš„ä½¿ç”¨æƒ…å†µ
-- 4. æ•´ä½“æŸ¥è¯¢çš„æˆæœ¬ä¼°ç®—
```

---

## 7. ğŸ“ å‘½åç­–ç•¥ä¸è§„èŒƒ


### 7.1 CTEå‘½åæœ€ä½³å®è·µ


**ğŸ·ï¸ å‘½åè§„èŒƒ**
```
å‘½ååŸåˆ™ï¼š
â€¢ è¯­ä¹‰åŒ–ï¼šåç§°èƒ½æ¸…æ¥šè¡¨è¾¾CTEçš„ç”¨é€”
â€¢ å±‚æ¬¡åŒ–ï¼šä½“ç°CTEåœ¨å¤„ç†æµç¨‹ä¸­çš„ä½ç½®
â€¢ ä¸€è‡´æ€§ï¼šå›¢é˜Ÿå†…ç»Ÿä¸€çš„å‘½åé£æ ¼
â€¢ ç®€æ´æ€§ï¼šé¿å…è¿‡é•¿çš„åç§°å½±å“å¯è¯»æ€§

æ¨èå‘½åæ¨¡å¼ï¼š
â€¢ æ•°æ®æ¸…æ´—ï¼šclean_xxx, filtered_xxx
â€¢ ä¸šåŠ¡è®¡ç®—ï¼šcalc_xxx, summary_xxx
â€¢ ç»Ÿè®¡æ±‡æ€»ï¼šstats_xxx, metrics_xxx
â€¢ æœ€ç»ˆç»“æœï¼šfinal_xxx, result_xxx
```

**ğŸ“‹ å‘½åè§„èŒƒç¤ºä¾‹**
```sql
WITH 
    -- æ•°æ®æ¸…æ´—å±‚
    clean_sales_data AS (...),
    filtered_customers AS (...),
    
    -- è®¡ç®—å¤„ç†å±‚
    calc_monthly_revenue AS (...),
    calc_customer_lifetime_value AS (...),
    
    -- ç»Ÿè®¡æ±‡æ€»å±‚
    stats_product_performance AS (...),
    metrics_customer_segments AS (...),
    
    -- æœ€ç»ˆç»“æœå±‚
    final_dashboard_data AS (...)

SELECT * FROM final_dashboard_data;
```

### 7.2 æ³¨é‡Šå’Œæ–‡æ¡£è§„èŒƒ


```sql
-- å®Œæ•´çš„CTEæ–‡æ¡£ç¤ºä¾‹
WITH 
    /*
     * CTE: clean_order_data
     * åŠŸèƒ½: æ¸…æ´—è®¢å•æ•°æ®ï¼Œè¿‡æ»¤æ— æ•ˆè®°å½•
     * è¾“å…¥: orders, order_itemsè¡¨
     * è¾“å‡º: æ¸…æ´—åçš„è®¢å•æ˜ç»†æ•°æ®
     * ä¾èµ–: æ— 
     */
    clean_order_data AS (
        SELECT 
            o.order_id,
            o.customer_id,
            oi.product_id,
            oi.quantity,
            oi.unit_price,
            oi.quantity * oi.unit_price AS line_amount  -- è®¡ç®—è¡Œé‡‘é¢
        FROM orders o
        JOIN order_items oi ON o.order_id = oi.order_id
        WHERE o.status = 'completed'
          AND o.order_date >= '2024-01-01'
          AND oi.quantity > 0                          -- è¿‡æ»¤æ— æ•ˆæ•°é‡
          AND oi.unit_price > 0                        -- è¿‡æ»¤æ— æ•ˆä»·æ ¼
    ),
    
    /*
     * CTE: customer_metrics
     * åŠŸèƒ½: è®¡ç®—å®¢æˆ·æ¶ˆè´¹æŒ‡æ ‡
     * è¾“å…¥: clean_order_data
     * è¾“å‡º: å®¢æˆ·çº§åˆ«çš„æ¶ˆè´¹ç»Ÿè®¡
     * ä¾èµ–: clean_order_data
     */
    customer_metrics AS (
        SELECT 
            customer_id,
            COUNT(DISTINCT order_id) AS order_count,
            SUM(line_amount) AS total_spent,
            AVG(line_amount) AS avg_order_value,
            MAX(line_amount) AS max_order_value
        FROM clean_order_data
        GROUP BY customer_id
    )

SELECT * FROM customer_metrics;
```

---

## 8. ğŸ­ å®é™…åº”ç”¨æ¡ˆä¾‹


### 8.1 è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ


**ğŸ’° è´¢åŠ¡æ•°æ®å¤„ç†æµç¨‹**
```sql
-- è´¢åŠ¡æœˆæŠ¥å¤šCTEå®ç°
WITH 
    -- æ”¶å…¥æ•°æ®å¤„ç†
    revenue_data AS (
        SELECT 
            DATE_FORMAT(order_date, '%Y-%m') AS month,
            SUM(amount) AS monthly_revenue,
            COUNT(*) AS order_count
        FROM orders
        WHERE status = 'completed'
          AND order_date >= '2024-01-01'
        GROUP BY DATE_FORMAT(order_date, '%Y-%m')
    ),
    
    -- æˆæœ¬æ•°æ®å¤„ç†
    cost_data AS (
        SELECT 
            DATE_FORMAT(expense_date, '%Y-%m') AS month,
            SUM(amount) AS monthly_cost
        FROM expenses
        WHERE expense_date >= '2024-01-01'
        GROUP BY DATE_FORMAT(expense_date, '%Y-%m')
    ),
    
    -- åˆ©æ¶¦è®¡ç®—
    profit_analysis AS (
        SELECT 
            r.month,
            r.monthly_revenue,
            COALESCE(c.monthly_cost, 0) AS monthly_cost,
            r.monthly_revenue - COALESCE(c.monthly_cost, 0) AS monthly_profit,
            r.order_count
        FROM revenue_data r
        LEFT JOIN cost_data c ON r.month = c.month
    )

SELECT 
    month,
    monthly_revenue,
    monthly_cost,
    monthly_profit,
    ROUND(monthly_profit * 100.0 / monthly_revenue, 2) AS profit_margin
FROM profit_analysis
ORDER BY month;
```

### 8.2 ç”¨æˆ·è¡Œä¸ºåˆ†æ


```sql
-- ç”¨æˆ·è¡Œä¸ºæ¼æ–—åˆ†æ
WITH 
    -- é¡µé¢è®¿é—®ç»Ÿè®¡
    page_views AS (
        SELECT 
            user_id,
            COUNT(*) AS pv_count,
            COUNT(DISTINCT page_url) AS unique_pages
        FROM user_logs
        WHERE action = 'page_view'
          AND log_date >= '2024-01-01'
        GROUP BY user_id
    ),
    
    -- å•†å“æŸ¥çœ‹ç»Ÿè®¡
    product_views AS (
        SELECT 
            user_id,
            COUNT(*) AS product_view_count,
            COUNT(DISTINCT product_id) AS unique_products_viewed
        FROM user_logs
        WHERE action = 'product_view'
          AND log_date >= '2024-01-01'
        GROUP BY user_id
    ),
    
    -- è´­ä¹°è¡Œä¸ºç»Ÿè®¡
    purchases AS (
        SELECT 
            customer_id AS user_id,
            COUNT(*) AS purchase_count,
            SUM(amount) AS total_spent
        FROM orders
        WHERE status = 'completed'
          AND order_date >= '2024-01-01'
        GROUP BY customer_id
    ),
    
    -- ç”¨æˆ·è¡Œä¸ºæ¼æ–—
    user_funnel AS (
        SELECT 
            pv.user_id,
            pv.pv_count,
            COALESCE(pdv.product_view_count, 0) AS product_views,
            COALESCE(p.purchase_count, 0) AS purchases,
            COALESCE(p.total_spent, 0) AS spent_amount
        FROM page_views pv
        LEFT JOIN product_views pdv ON pv.user_id = pdv.user_id
        LEFT JOIN purchases p ON pv.user_id = p.user_id
    )

SELECT 
    'æ€»è®¿é—®ç”¨æˆ·' AS funnel_stage,
    COUNT(*) AS user_count,
    COUNT(*) AS conversion_rate
FROM user_funnel

UNION ALL

SELECT 
    'å•†å“æŸ¥çœ‹ç”¨æˆ·',
    COUNT(*) AS user_count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM user_funnel), 2)
FROM user_funnel WHERE product_views > 0

UNION ALL

SELECT 
    'è´­ä¹°ç”¨æˆ·',
    COUNT(*),
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM user_funnel), 2)
FROM user_funnel WHERE purchases > 0;
```

### 8.3 åº“å­˜é¢„è­¦ç³»ç»Ÿ


```sql
-- åº“å­˜é¢„è­¦å¤šå±‚åˆ†æ
WITH 
    -- åŸºç¡€åº“å­˜æ•°æ®
    current_inventory AS (
        SELECT 
            product_id,
            current_stock,
            safety_stock,
            reorder_point
        FROM inventory
        WHERE status = 'active'
    ),
    
    -- é”€å”®é€Ÿåº¦è®¡ç®—
    sales_velocity AS (
        SELECT 
            product_id,
            COUNT(*) AS sales_count,
            SUM(quantity) AS total_sold,
            AVG(quantity) AS avg_daily_sales
        FROM order_items oi
        JOIN orders o ON oi.order_id = o.id
        WHERE o.order_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
          AND o.status = 'completed'
        GROUP BY product_id
    ),
    
    -- é¢„è­¦çº§åˆ«è®¡ç®—
    stock_alerts AS (
        SELECT 
            ci.product_id,
            ci.current_stock,
            ci.safety_stock,
            COALESCE(sv.avg_daily_sales, 0) AS daily_sales,
            -- é¢„è®¡å¯ç”¨å¤©æ•°
            CASE 
                WHEN COALESCE(sv.avg_daily_sales, 0) = 0 THEN 999
                ELSE ci.current_stock / sv.avg_daily_sales
            END AS days_available,
            -- é¢„è­¦çº§åˆ«
            CASE 
                WHEN ci.current_stock <= 0 THEN 'ç¼ºè´§'
                WHEN ci.current_stock <= ci.safety_stock THEN 'ä¸¥é‡é¢„è­¦'
                WHEN ci.current_stock <= ci.reorder_point THEN 'ä¸€èˆ¬é¢„è­¦'
                ELSE 'æ­£å¸¸'
            END AS alert_level
        FROM current_inventory ci
        LEFT JOIN sales_velocity sv ON ci.product_id = sv.product_id
    )

SELECT 
    p.product_name,
    sa.current_stock,
    sa.daily_sales,
    sa.days_available,
    sa.alert_level
FROM stock_alerts sa
JOIN products p ON sa.product_id = p.id
WHERE sa.alert_level != 'æ­£å¸¸'
ORDER BY 
    FIELD(sa.alert_level, 'ç¼ºè´§', 'ä¸¥é‡é¢„è­¦', 'ä¸€èˆ¬é¢„è­¦'),
    sa.days_available;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šCTEä¸²è”ï¼šç”¨é€—å·åˆ†éš”å®šä¹‰å¤šä¸ªCTEï¼Œåå®šä¹‰çš„CTEå¯å¼•ç”¨å‰é¢çš„CTE
ğŸ”¸ ä¾èµ–å…³ç³»ï¼šCTEé—´çš„å¼•ç”¨å…³ç³»ï¼Œéœ€è¦åˆç†è®¾è®¡é¿å…å¤æ‚åº¦è¿‡é«˜
ğŸ”¸ ä¸šåŠ¡é€»è¾‘æ‹†åˆ†ï¼šå°†å¤æ‚æŸ¥è¯¢æ‹†åˆ†ä¸ºå¤šä¸ªèŒè´£æ˜ç¡®çš„CTEæ¨¡å—
ğŸ”¸ å¯å¤ç”¨è®¾è®¡ï¼šè®¾è®¡é€šç”¨æ€§å¼ºçš„CTEæ¨¡å—ï¼Œåœ¨ä¸åŒæŸ¥è¯¢ä¸­å¤ç”¨
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡æ—©æœŸè¿‡æ»¤ã€ç´¢å¼•åˆ©ç”¨ç­‰ç­–ç•¥ä¼˜åŒ–å¤šCTEæŸ¥è¯¢æ€§èƒ½
ğŸ”¸ å‘½åè§„èŒƒï¼šå»ºç«‹æ¸…æ™°çš„CTEå‘½åå’Œæ³¨é‡Šè§„èŒƒï¼Œæé«˜ä»£ç å¯ç»´æŠ¤æ€§
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä½¿ç”¨å¤šCTE**
```
å¤æ‚é€»è¾‘ç®¡ç†ï¼š
â€¢ å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ†è§£ä¸ºå¤šä¸ªç®€å•æ­¥éª¤
â€¢ æ¯ä¸ªCTEèŒè´£å•ä¸€ï¼Œé€»è¾‘æ¸…æ™°
â€¢ ä¾¿äºç†è§£ã€è°ƒè¯•å’Œç»´æŠ¤

ä»£ç å¤ç”¨æ€§ï¼š
â€¢ é¿å…é‡å¤çš„å­æŸ¥è¯¢é€»è¾‘
â€¢ ä¸€æ¬¡å®šä¹‰ï¼Œå¤šå¤„ä½¿ç”¨
â€¢ æé«˜å¼€å‘æ•ˆç‡

å›¢é˜Ÿåä½œï¼š
â€¢ ä¸åŒå¼€å‘äººå‘˜å¯ä»¥è´Ÿè´£ä¸åŒçš„CTE
â€¢ æ ‡å‡†åŒ–çš„æ¥å£ä¾¿äºé›†æˆ
â€¢ é™ä½ä»£ç è€¦åˆåº¦
```

**ğŸ”¹ å¤šCTEè®¾è®¡åŸåˆ™**
```
åˆ†å±‚è®¾è®¡ï¼š
â€¢ åŸºç¡€å±‚ï¼šæ•°æ®æ¸…æ´—ã€è¿‡æ»¤
â€¢ ä¸šåŠ¡å±‚ï¼šä¸šåŠ¡è§„åˆ™è®¡ç®—
â€¢ å±•ç°å±‚ï¼šç»“æœæ ¼å¼åŒ–

ä¾èµ–ç®¡ç†ï¼š
â€¢ æœ€å°åŒ–CTEé—´çš„ä¾èµ–å…³ç³»
â€¢ é¿å…å¾ªç¯ä¾èµ–
â€¢ ä¿æŒæ•°æ®æµå‘æ¸…æ™°

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ æ—©æœŸè¿‡æ»¤å‡å°‘æ•°æ®é‡
â€¢ åˆç†åˆ©ç”¨ç´¢å¼•
â€¢ æ§åˆ¶ä¸­é—´ç»“æœé›†å¤§å°
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å¤æ‚çš„æŠ¥è¡¨æŸ¥è¯¢éœ€è¦å¤šæ­¥éª¤å¤„ç†
âœ… ä¸šåŠ¡é€»è¾‘å¤æ‚ï¼Œéœ€è¦åˆ†æ­¥éª¤è®¡ç®—
âœ… éœ€è¦é‡å¤ä½¿ç”¨æŸäº›è®¡ç®—ç»“æœ
âœ… å›¢é˜Ÿåä½œå¼€å‘å¤æ‚æŸ¥è¯¢

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ç®€å•çš„å•è¡¨æŸ¥è¯¢
âŒ æ€§èƒ½è¦æ±‚æé«˜çš„ç®€å•æŸ¥è¯¢
âŒ æ•°æ®é‡ç‰¹åˆ«å¤§çš„å®æ—¶æŸ¥è¯¢
âŒ é¢‘ç¹æ‰§è¡Œçš„ç®€å•ç»Ÿè®¡æŸ¥è¯¢
```

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
```
è®¾è®¡é˜¶æ®µï¼š
âœ… åˆ†æä¸šåŠ¡é€»è¾‘ï¼Œç¡®å®šCTEæ‹†åˆ†ç­–ç•¥
âœ… è®¾è®¡CTEé—´çš„ä¾èµ–å…³ç³»
âœ… åˆ¶å®šå‘½åå’Œæ³¨é‡Šè§„èŒƒ

å¼€å‘é˜¶æ®µï¼š
âœ… é€ä¸ªå¼€å‘å’Œæµ‹è¯•æ¯ä¸ªCTE
âœ… æ³¨æ„æ—©æœŸè¿‡æ»¤å’Œæ€§èƒ½ä¼˜åŒ–
âœ… æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜

ç»´æŠ¤é˜¶æ®µï¼š
âœ… å®šæœŸæ£€æŸ¥CTEæŸ¥è¯¢æ€§èƒ½
âœ… æ ¹æ®ä¸šåŠ¡å˜åŒ–è°ƒæ•´CTEé€»è¾‘
âœ… ä¿æŒæ–‡æ¡£å’Œä»£ç åŒæ­¥æ›´æ–°
```

### 9.4 æœ€ä½³å®è·µæ€»ç»“


**âœ… è®¾è®¡æœ€ä½³å®è·µ**
```
ç»“æ„è®¾è®¡ï¼š
â€¢ æŒ‰æ•°æ®å¤„ç†æµç¨‹åˆ†å±‚å®šä¹‰CTE
â€¢ æ¯ä¸ªCTEåŠŸèƒ½å•ä¸€ï¼ŒèŒè´£æ˜ç¡®
â€¢ ä¿æŒåˆç†çš„ä¾èµ–å…³ç³»å±‚æ¬¡

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åœ¨ç¬¬ä¸€ä¸ªCTEä¸­å°½æ—©è¿‡æ»¤æ•°æ®
â€¢ ç¡®ä¿å…³é”®CTEèƒ½å¤Ÿä½¿ç”¨ç´¢å¼•
â€¢ æ§åˆ¶ä¸­é—´ç»“æœé›†çš„å¤§å°
â€¢ é¿å…ä¸å¿…è¦çš„å¤æ‚å…³è”

ä»£ç è´¨é‡ï¼š
â€¢ ä½¿ç”¨è¯­ä¹‰åŒ–çš„CTEå‘½å
â€¢ æ·»åŠ è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
â€¢ ä¿æŒä»£ç æ ¼å¼æ•´æ´ä¸€è‡´
â€¢ ä¾¿äºå›¢é˜Ÿåä½œå’Œç»´æŠ¤
```

**ğŸš« å¸¸è§é™·é˜±é¿å…**
```
è®¾è®¡é™·é˜±ï¼š
âŒ CTEè¿‡å¤šå¯¼è‡´æŸ¥è¯¢å¤æ‚åº¦è¿‡é«˜
âŒ ä¾èµ–å…³ç³»æ··ä¹±ï¼Œéš¾ä»¥ç†è§£å’Œç»´æŠ¤
âŒ CTEèŒè´£ä¸æ¸…ï¼Œé€»è¾‘é‡å¤

æ€§èƒ½é™·é˜±ï¼š
âŒ å¿½ç•¥æ—©æœŸè¿‡æ»¤ï¼Œå¤„ç†æ•°æ®é‡è¿‡å¤§
âŒ CTEæŸ¥è¯¢æ— æ³•ä½¿ç”¨ç´¢å¼•
âŒ ä¸­é—´ç»“æœé›†è¿‡å¤§å ç”¨å†…å­˜

ç»´æŠ¤é™·é˜±ï¼š
âŒ ç¼ºä¹æ³¨é‡Šï¼Œåç»­ç»´æŠ¤å›°éš¾
âŒ å‘½åä¸è§„èŒƒï¼Œéš¾ä»¥ç†è§£ç”¨é€”
âŒ ç¼ºä¹æµ‹è¯•ï¼Œä¿®æ”¹æ—¶å®¹æ˜“å¼•å…¥é”™è¯¯
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ¯ å¤šCTEè®¾è®¡è¦é¢†ï¼š
"é€»è¾‘æ‹†åˆ†è¦æ¸…æ™°ï¼Œä¾èµ–å…³ç³»è¦åˆç†
å‘½åè§„èŒƒè¦ç»Ÿä¸€ï¼Œæ³¨é‡Šæ–‡æ¡£è¦è¯¦ç»†
æ€§èƒ½ä¼˜åŒ–è¦æå‰ï¼Œæµ‹è¯•è°ƒè¯•è¦å……åˆ†"

ğŸ’¡ å®é™…åº”ç”¨è¦ç‚¹ï¼š
"å¤æ‚æŠ¥è¡¨å¤šCTEï¼Œç®€å•æŸ¥è¯¢åˆ«æ»¥ç”¨
åˆ†å±‚è®¾è®¡èŒè´£æ˜ï¼Œæ—©æœŸè¿‡æ»¤æ•°æ®å°‘
å›¢é˜Ÿåä½œé è§„èŒƒï¼Œç»´æŠ¤å‡çº§æœ‰æ–‡æ¡£"
```