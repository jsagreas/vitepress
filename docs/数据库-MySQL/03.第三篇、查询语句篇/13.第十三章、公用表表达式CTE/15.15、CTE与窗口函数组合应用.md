---
title: 15ã€CTEä¸çª—å£å‡½æ•°ç»„åˆåº”ç”¨
---
## ğŸ“š ç›®å½•

1. [CTEä¸çª—å£å‡½æ•°åŸºç¡€æ¦‚å¿µ](#1-CTEä¸çª—å£å‡½æ•°åŸºç¡€æ¦‚å¿µ)
2. [CTEä¸çª—å£å‡½æ•°ç»“åˆåŸç†](#2-CTEä¸çª—å£å‡½æ•°ç»“åˆåŸç†)
3. [åˆ†å±‚åˆ†æå®ç°æŠ€å·§](#3-åˆ†å±‚åˆ†æå®ç°æŠ€å·§)
4. [å¤æ‚ç»Ÿè®¡åˆ†æåº”ç”¨](#4-å¤æ‚ç»Ÿè®¡åˆ†æåº”ç”¨)
5. [å¤šç»´åº¦æ•°æ®åˆ†æ](#5-å¤šç»´åº¦æ•°æ®åˆ†æ)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [CTEçª—å£å‡½æ•°ç»„åˆè®¾è®¡](#8-CTEçª—å£å‡½æ•°ç»„åˆè®¾è®¡)
9. [åˆ†å±‚åˆ†æä¼˜åŒ–ç­–ç•¥](#9-åˆ†å±‚åˆ†æä¼˜åŒ–ç­–ç•¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” CTEä¸çª—å£å‡½æ•°åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯CTEå’Œçª—å£å‡½æ•°


> ğŸ’¡ **ä¸€å¥è¯ç†è§£**ï¼šCTEåƒæ˜¯ç»™å¤æ‚æŸ¥è¯¢èµ·ä¸ª"ä¸´æ—¶åå­—"ï¼Œçª—å£å‡½æ•°åƒæ˜¯ç»™æ¯ä¸€è¡Œæ•°æ®"å¼€ä¸ªå°çª—"çœ‹åˆ°ç›¸å…³æ•°æ®ï¼Œä¸¤è€…ç»“åˆå°±åƒç»„è£…ç§¯æœ¨ä¸€æ ·æ„å»ºå¤æ‚åˆ†æã€‚

**ğŸ”¸ CTEåŸºç¡€æ¦‚å¿µ**
```
CTE (Common Table Expression)ï¼šå…¬ç”¨è¡¨è¡¨è¾¾å¼
æœ¬è´¨ï¼šä¸´æ—¶å‘½åçš„æŸ¥è¯¢ç»“æœé›†
ä½œç”¨ï¼šå°†å¤æ‚æŸ¥è¯¢æ‹†åˆ†æˆå¤šä¸ªæ­¥éª¤
ä¼˜åŠ¿ï¼šä»£ç å¯è¯»æ€§å¼ºï¼Œé€»è¾‘æ¸…æ™°
```

**ğŸ”¸ çª—å£å‡½æ•°åŸºç¡€æ¦‚å¿µ**
```
çª—å£å‡½æ•°ï¼šåœ¨ç»“æœé›†çš„"çª—å£"å†…è¿›è¡Œè®¡ç®—
ç‰¹ç‚¹ï¼šä¸æ”¹å˜ç»“æœé›†è¡Œæ•°ï¼Œä¸ºæ¯è¡Œæ·»åŠ è®¡ç®—ç»“æœ
ç±»å‹ï¼šæ’åå‡½æ•°ã€èšåˆå‡½æ•°ã€åˆ†æå‡½æ•°
è¯­æ³•ï¼šfunction() OVER (PARTITION BY ... ORDER BY ...)
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç»„åˆä½¿ç”¨


**ğŸ’¡ ç»„åˆçš„ä¼˜åŠ¿**
```
å•ç‹¬ä½¿ç”¨çš„å±€é™ï¼š
CTEå•ç‹¬ï¼šåªèƒ½ç®€åŒ–æŸ¥è¯¢ç»“æ„ï¼Œè®¡ç®—èƒ½åŠ›æœ‰é™
çª—å£å‡½æ•°å•ç‹¬ï¼šè®¡ç®—ä¸°å¯Œä½†éš¾ä»¥å¤„ç†å¤æ‚å±‚æ¬¡å…³ç³»

ç»„åˆä½¿ç”¨çš„å¨åŠ›ï¼š
â”Œâ”€ CTEæ„å»ºæ•°æ®å±‚æ¬¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šåŸºç¡€æ•°æ®ç­›é€‰å’Œæ¸…æ´—    â”‚
â”‚ ç¬¬2å±‚ï¼šä¸­é—´è®¡ç®—å’Œæ±‡æ€»        â”‚ 
â”‚ ç¬¬3å±‚ï¼šé«˜çº§åˆ†æå’Œæ’å        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€ çª—å£å‡½æ•°ç²¾ç¡®è®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ åœ¨æ¯å±‚æ•°æ®ä¸Šåšç²¾ç¡®è®¡ç®—     â”‚
â”‚ â€¢ æ’åã€å æ¯”ã€ç´¯è®¡ç­‰åˆ†æ     â”‚
â”‚ â€¢ åŒæ¯”ã€ç¯æ¯”ç­‰å¯¹æ¯”åˆ†æ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å…¸å‹åº”ç”¨åœºæ™¯


**ğŸ¯ æ ¸å¿ƒåº”ç”¨åœºæ™¯**
```
ä¸šåŠ¡åˆ†æåœºæ™¯ï¼š
â€¢ é”€å”®ä¸šç»©åˆ†å±‚æ’ååˆ†æ
â€¢ ç”¨æˆ·è¡Œä¸ºè·¯å¾„åˆ†æ  
â€¢ å•†å“é”€å”®è¶‹åŠ¿åˆ†æ
â€¢ åœ°åŒºä¸šç»©å¯¹æ¯”åˆ†æ

æŠ€æœ¯åˆ†æåœºæ™¯ï¼š
â€¢ å¤æ‚æŠ¥è¡¨ç”Ÿæˆ
â€¢ æ•°æ®ä»“åº“ETLå¤„ç†
â€¢ å®æ—¶æ•°æ®åˆ†æ
â€¢ å¤šç»´åº¦OLAPæŸ¥è¯¢
```

---

## 2. ğŸ”„ CTEä¸çª—å£å‡½æ•°ç»“åˆåŸç†


### 2.1 ç»„åˆæ‰§è¡ŒåŸç†


> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šCTEå’Œçª—å£å‡½æ•°çš„ç»„åˆå°±åƒå·¥å‚æµæ°´çº¿ï¼ŒCTEè´Ÿè´£"åŠ å·¥åŸææ–™"ï¼Œçª—å£å‡½æ•°è´Ÿè´£"ç²¾ç»†åŒ…è£…"ï¼Œå±‚å±‚é€’è¿›å®Œæˆå¤æ‚ä»»åŠ¡ã€‚

**ğŸ—ï¸ æ‰§è¡Œæµç¨‹åˆ†æ**
```
æ‰§è¡Œé¡ºåºå›¾ï¼š
â”Œâ”€ ç¬¬1æ­¥ï¼šCTEæ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WITH base_data AS (           â”‚
â”‚   SELECT ... FROM tables      â”‚ â† æ•°æ®ç­›é€‰å’Œé¢„å¤„ç†
â”‚ )                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€ ç¬¬2æ­¥ï¼šçª—å£å‡½æ•°è®¡ç®— â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT                        â”‚
â”‚   col1,                       â”‚
â”‚   ROW_NUMBER() OVER(...)  â† çª—å£è®¡ç®—
â”‚ FROM base_data                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€ ç¬¬3æ­¥ï¼šç»“æœè¾“å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆç»“æœé›†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®å¤„ç†å±‚æ¬¡


**ğŸ“Š å¤šå±‚æ¬¡æ•°æ®å¤„ç†æ¨¡å¼**

```sql
-- æ ‡å‡†çš„ä¸‰å±‚å¤„ç†æ¨¡å¼
WITH 
-- ç¬¬1å±‚ï¼šåŸºç¡€æ•°æ®æ¸…æ´—å’Œç­›é€‰
cleaned_data AS (
    SELECT 
        customer_id,
        product_id,
        order_date,
        quantity,
        unit_price,
        quantity * unit_price AS amount
    FROM orders 
    WHERE order_date >= '2024-01-01'
      AND status = 'completed'
),

-- ç¬¬2å±‚ï¼šæŒ‰ç»´åº¦æ±‡æ€»
summary_data AS (
    SELECT 
        customer_id,
        DATE_FORMAT(order_date, '%Y-%m') AS order_month,
        SUM(amount) AS monthly_amount,
        COUNT(*) AS order_count
    FROM cleaned_data
    GROUP BY customer_id, DATE_FORMAT(order_date, '%Y-%m')
),

-- ç¬¬3å±‚ï¼šçª—å£å‡½æ•°åˆ†æ
final_analysis AS (
    SELECT 
        customer_id,
        order_month,
        monthly_amount,
        -- å®¢æˆ·æœˆåº¦æ’å
        ROW_NUMBER() OVER (PARTITION BY order_month ORDER BY monthly_amount DESC) AS month_rank,
        -- å®¢æˆ·ç´¯è®¡é‡‘é¢
        SUM(monthly_amount) OVER (PARTITION BY customer_id ORDER BY order_month) AS cumulative_amount,
        -- åŒæ¯”å¢é•¿ç‡
        LAG(monthly_amount, 12) OVER (PARTITION BY customer_id ORDER BY order_month) AS same_month_last_year
    FROM summary_data
)

SELECT 
    customer_id,
    order_month,
    monthly_amount,
    month_rank,
    cumulative_amount,
    CASE 
        WHEN same_month_last_year IS NOT NULL THEN
            ROUND((monthly_amount - same_month_last_year) * 100.0 / same_month_last_year, 2)
        ELSE NULL
    END AS yoy_growth_rate
FROM final_analysis
WHERE month_rank <= 10;  -- åªçœ‹æ¯æœˆå‰10åå®¢æˆ·
```

---

## 3. ğŸ“ˆ åˆ†å±‚åˆ†æå®ç°æŠ€å·§


### 3.1 é€’å½’CTEä¸çª—å£å‡½æ•°


> **ğŸ¤” å¸¸è§ç–‘é—®**ï¼šä»€ä¹ˆæ˜¯é€’å½’CTEï¼Ÿ
> **ğŸ’¡ ç­”æ¡ˆ**ï¼šé€’å½’CTEå°±åƒçˆ¬æ¥¼æ¢¯ï¼Œæ¯ä¸€å±‚éƒ½åŸºäºä¸Šä¸€å±‚çš„ç»“æœï¼Œç›´åˆ°æ‰¾åˆ°é¡¶å±‚ã€‚æ¯”å¦‚åˆ†æç»„ç»‡æ¶æ„ã€äº§å“åˆ†ç±»å±‚çº§ç­‰ã€‚

**ğŸŒ³ ç»„ç»‡æ¶æ„åˆ†æ**

```sql
-- é€’å½’CTEåˆ†æç»„ç»‡å±‚æ¬¡
WITH RECURSIVE org_hierarchy AS (
    -- ç¬¬1æ­¥ï¼šæ‰¾åˆ°é¡¶çº§é¢†å¯¼
    SELECT 
        employee_id,
        employee_name,
        manager_id,
        salary,
        1 AS level,
        CAST(employee_name AS CHAR(1000)) AS hierarchy_path
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- ç¬¬2æ­¥ï¼šé€’å½’æ‰¾ä¸‹çº§
    SELECT 
        e.employee_id,
        e.employee_name,
        e.manager_id,
        e.salary,
        oh.level + 1,
        CONCAT(oh.hierarchy_path, ' -> ', e.employee_name)
    FROM employees e
    INNER JOIN org_hierarchy oh ON e.manager_id = oh.employee_id
),

-- ç¬¬3æ­¥ï¼šçª—å£å‡½æ•°åˆ†ææ¯å±‚æ•°æ®
level_analysis AS (
    SELECT 
        *,
        -- åŒçº§åˆ«æ’å
        ROW_NUMBER() OVER (PARTITION BY level ORDER BY salary DESC) AS level_rank,
        -- åŒçº§åˆ«è–ªèµ„å æ¯”
        ROUND(salary * 100.0 / SUM(salary) OVER (PARTITION BY level), 2) AS level_salary_pct,
        -- å…¨å…¬å¸è–ªèµ„æ’å
        DENSE_RANK() OVER (ORDER BY salary DESC) AS company_rank
    FROM org_hierarchy
)

SELECT 
    level,
    hierarchy_path,
    salary,
    level_rank,
    level_salary_pct,
    company_rank,
    CASE 
        WHEN level_rank = 1 THEN 'ğŸ¥‡ åŒçº§ç¬¬ä¸€'
        WHEN level_rank <= 3 THEN 'ğŸ¥ˆ åŒçº§å‰ä¸‰'
        ELSE 'ğŸ’¼ æ™®é€šå‘˜å·¥'
    END AS performance_level
FROM level_analysis
ORDER BY level, level_rank;
```

### 3.2 æ—¶é—´åºåˆ—åˆ†å±‚åˆ†æ


**ğŸ“… æ—¶é—´ç»´åº¦åˆ†å±‚å¤„ç†**

```sql
-- é”€å”®æ•°æ®æ—¶é—´åˆ†å±‚åˆ†æ
WITH
-- ç¬¬1å±‚ï¼šæ—¥é”€å”®æ±‡æ€»
daily_sales AS (
    SELECT 
        DATE(order_date) AS sale_date,
        SUM(amount) AS daily_amount,
        COUNT(*) AS daily_orders
    FROM orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
    GROUP BY DATE(order_date)
),

-- ç¬¬2å±‚ï¼šå‘¨é”€å”®æ±‡æ€»
weekly_sales AS (
    SELECT 
        YEARWEEK(sale_date) AS sale_week,
        SUM(daily_amount) AS weekly_amount,
        SUM(daily_orders) AS weekly_orders,
        -- æœ¬å‘¨å†…æ—¥é”€å”®æ’å
        AVG(ROW_NUMBER() OVER (PARTITION BY YEARWEEK(sale_date) ORDER BY daily_amount DESC)) AS avg_daily_rank
    FROM daily_sales
    GROUP BY YEARWEEK(sale_date)
),

-- ç¬¬3å±‚ï¼šæœˆé”€å”®åˆ†æ
monthly_analysis AS (
    SELECT 
        DATE_FORMAT(STR_TO_DATE(CONCAT(sale_week, '1'), '%X%V%w'), '%Y-%m') AS sale_month,
        SUM(weekly_amount) AS monthly_amount,
        -- å‘¨åº¦ç¯æ¯”å¢é•¿
        LAG(weekly_amount) OVER (ORDER BY sale_week) AS prev_week_amount,
        -- æœˆå†…å‘¨æ’å
        ROW_NUMBER() OVER (PARTITION BY DATE_FORMAT(STR_TO_DATE(CONCAT(sale_week, '1'), '%X%V%w'), '%Y-%m') 
                          ORDER BY weekly_amount DESC) AS week_rank_in_month
    FROM weekly_sales
)

SELECT 
    sale_month,
    monthly_amount,
    week_rank_in_month,
    CASE 
        WHEN prev_week_amount IS NOT NULL THEN
            ROUND((weekly_amount - prev_week_amount) * 100.0 / prev_week_amount, 2)
        ELSE NULL
    END AS week_over_week_growth,
    CASE 
        WHEN week_rank_in_month = 1 THEN 'ğŸ”¥ æœˆå†…æœ€ä½³å‘¨'
        WHEN week_rank_in_month <= 2 THEN 'ğŸ“ˆ è¡¨ç°è‰¯å¥½'
        ELSE 'ğŸ“Š æ­£å¸¸è¡¨ç°'
    END AS performance_indicator
FROM monthly_analysis
ORDER BY sale_month, week_rank_in_month;
```

---

## 4. ğŸ“Š å¤æ‚ç»Ÿè®¡åˆ†æåº”ç”¨


### 4.1 å¤šæŒ‡æ ‡ç»¼åˆåˆ†æ


> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šå¤æ‚ç»Ÿè®¡åˆ†æå°±åƒç»™å…¬å¸åšå…¨é¢ä½“æ£€ï¼Œä¸ä»…çœ‹å•ä¸ªæŒ‡æ ‡ï¼Œè¿˜è¦çœ‹å„æŒ‡æ ‡ä¹‹é—´çš„å…³ç³»å’Œå˜åŒ–è¶‹åŠ¿ã€‚

**ğŸ“ˆ é”€å”®ä¸šç»©ç»¼åˆåˆ†æ**

```sql
-- é”€å”®äººå‘˜å¤šç»´åº¦ä¸šç»©åˆ†æ
WITH
-- åŸºç¡€é”€å”®æ•°æ®
sales_base AS (
    SELECT 
        s.salesperson_id,
        s.salesperson_name,
        o.order_date,
        o.amount,
        o.customer_id,
        p.category AS product_category
    FROM orders o
    JOIN salespeople s ON o.salesperson_id = s.salesperson_id
    JOIN order_items oi ON o.id = oi.order_id
    JOIN products p ON oi.product_id = p.id
    WHERE o.order_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
),

-- æœˆåº¦ä¸šç»©æ±‡æ€»
monthly_performance AS (
    SELECT 
        salesperson_id,
        salesperson_name,
        DATE_FORMAT(order_date, '%Y-%m') AS sale_month,
        SUM(amount) AS monthly_sales,
        COUNT(DISTINCT customer_id) AS unique_customers,
        COUNT(DISTINCT product_category) AS category_coverage
    FROM sales_base
    GROUP BY salesperson_id, salesperson_name, DATE_FORMAT(order_date, '%Y-%m')
),

-- çª—å£å‡½æ•°ç»¼åˆåˆ†æ
performance_analysis AS (
    SELECT 
        *,
        -- é”€å”®é¢æ’åï¼ˆæœˆåº¦ï¼‰
        ROW_NUMBER() OVER (PARTITION BY sale_month ORDER BY monthly_sales DESC) AS monthly_rank,
        -- é”€å”®é¢ç¯æ¯”
        LAG(monthly_sales) OVER (PARTITION BY salesperson_id ORDER BY sale_month) AS prev_month_sales,
        -- ç´¯è®¡é”€å”®é¢
        SUM(monthly_sales) OVER (PARTITION BY salesperson_id ORDER BY sale_month) AS cumulative_sales,
        -- å¹³å‡æœˆåº¦é”€å”®é¢
        AVG(monthly_sales) OVER (PARTITION BY salesperson_id ORDER BY sale_month 
                                ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS avg_3month_sales
    FROM monthly_performance
)

SELECT 
    salesperson_name,
    sale_month,
    monthly_sales,
    monthly_rank,
    unique_customers,
    category_coverage,
    CASE 
        WHEN prev_month_sales IS NOT NULL THEN
            ROUND((monthly_sales - prev_month_sales) * 100.0 / prev_month_sales, 2)
        ELSE NULL
    END AS month_over_month_growth,
    cumulative_sales,
    CASE 
        WHEN monthly_rank <= 3 THEN 'ğŸ† æœˆåº¦å‰ä¸‰'
        WHEN monthly_sales > avg_3month_sales * 1.2 THEN 'ğŸ“ˆ è¶…é¢å®Œæˆ'
        WHEN monthly_sales < avg_3month_sales * 0.8 THEN 'ğŸ“‰ éœ€è¦æ”¹è¿›'
        ELSE 'ğŸ“Š æ­£å¸¸è¡¨ç°'
    END AS performance_level
FROM performance_analysis
ORDER BY salesperson_id, sale_month;
```

### 4.2 åŒæœŸå¯¹æ¯”åˆ†æ


**ğŸ“Š åŒæ¯”ç¯æ¯”åˆ†æå®ç°**

```sql
-- é”€å”®æ•°æ®åŒæ¯”ç¯æ¯”åˆ†æ
WITH
-- åŸºç¡€æ—¶é—´é”€å”®æ•°æ®
time_sales AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y') AS year,
        DATE_FORMAT(order_date, '%m') AS month,
        DATE_FORMAT(order_date, '%Y-%m') AS year_month,
        SUM(amount) AS monthly_sales
    FROM orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 24 MONTH)
    GROUP BY DATE_FORMAT(order_date, '%Y'), DATE_FORMAT(order_date, '%m')
),

-- æ—¶é—´å¯¹æ¯”åˆ†æ
comparison_analysis AS (
    SELECT 
        year_month,
        monthly_sales,
        -- ç¯æ¯”ï¼šä¸ä¸Šæœˆå¯¹æ¯”
        LAG(monthly_sales, 1) OVER (ORDER BY year_month) AS prev_month_sales,
        -- åŒæ¯”ï¼šä¸å»å¹´åŒæœˆå¯¹æ¯”  
        LAG(monthly_sales, 12) OVER (ORDER BY year_month) AS same_month_last_year,
        -- å¹´å†…ç´¯è®¡
        SUM(monthly_sales) OVER (PARTITION BY year ORDER BY month) AS year_cumulative,
        -- å¹´å†…æ’å
        ROW_NUMBER() OVER (PARTITION BY year ORDER BY monthly_sales DESC) AS year_month_rank
    FROM time_sales
)

SELECT 
    year_month,
    monthly_sales,
    -- ç¯æ¯”å¢é•¿ç‡
    CASE 
        WHEN prev_month_sales IS NOT NULL THEN
            ROUND((monthly_sales - prev_month_sales) * 100.0 / prev_month_sales, 2)
        ELSE NULL
    END AS mom_growth_rate,
    -- åŒæ¯”å¢é•¿ç‡
    CASE 
        WHEN same_month_last_year IS NOT NULL THEN
            ROUND((monthly_sales - same_month_last_year) * 100.0 / same_month_last_year, 2)
        ELSE NULL
    END AS yoy_growth_rate,
    year_cumulative,
    year_month_rank,
    CASE 
        WHEN year_month_rank = 1 THEN 'ğŸ¥‡ å¹´åº¦æœ€ä½³æœˆ'
        WHEN year_month_rank <= 3 THEN 'ğŸ¥ˆ å¹´åº¦å‰ä¸‰æœˆ'
        ELSE 'ğŸ“… æ™®é€šæœˆä»½'
    END AS month_performance
FROM comparison_analysis
ORDER BY year_month;
```

---

## 5. ğŸ“Š å¤šç»´åº¦æ•°æ®åˆ†æ


### 5.1 å®¢æˆ·ä»·å€¼åˆ†å±‚åˆ†æ


**ğŸ‘¥ å®¢æˆ·RFMåˆ†æå®ç°**

```sql
-- å®¢æˆ·RFMåˆ†æï¼ˆæœ€è¿‘è´­ä¹°æ—¶é—´ã€è´­ä¹°é¢‘ç‡ã€è´­ä¹°é‡‘é¢ï¼‰
WITH
-- åŸºç¡€å®¢æˆ·äº¤æ˜“æ•°æ®
customer_transactions AS (
    SELECT 
        customer_id,
        order_date,
        amount,
        DATEDIFF(CURDATE(), order_date) AS days_since_purchase
    FROM orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 365 DAY)
),

-- RFMæŒ‡æ ‡è®¡ç®—
rfm_metrics AS (
    SELECT 
        customer_id,
        -- R: Recency æœ€è¿‘è´­ä¹°é—´éš”
        MIN(days_since_purchase) AS recency_days,
        -- F: Frequency è´­ä¹°é¢‘ç‡
        COUNT(*) AS frequency_count,
        -- M: Monetary è´­ä¹°é‡‘é¢
        SUM(amount) AS monetary_total
    FROM customer_transactions
    GROUP BY customer_id
),

-- RFMè¯„åˆ†ï¼ˆä½¿ç”¨çª—å£å‡½æ•°åˆ†å±‚ï¼‰
rfm_scores AS (
    SELECT 
        customer_id,
        recency_days,
        frequency_count,
        monetary_total,
        -- Rè¯„åˆ†ï¼šæœ€è¿‘è´­ä¹°è¶Šè¿‘åˆ†æ•°è¶Šé«˜
        CASE 
            WHEN PERCENT_RANK() OVER (ORDER BY recency_days DESC) >= 0.8 THEN 5
            WHEN PERCENT_RANK() OVER (ORDER BY recency_days DESC) >= 0.6 THEN 4
            WHEN PERCENT_RANK() OVER (ORDER BY recency_days DESC) >= 0.4 THEN 3
            WHEN PERCENT_RANK() OVER (ORDER BY recency_days DESC) >= 0.2 THEN 2
            ELSE 1
        END AS r_score,
        -- Fè¯„åˆ†ï¼šè´­ä¹°é¢‘ç‡è¶Šé«˜åˆ†æ•°è¶Šé«˜
        CASE 
            WHEN PERCENT_RANK() OVER (ORDER BY frequency_count) >= 0.8 THEN 5
            WHEN PERCENT_RANK() OVER (ORDER BY frequency_count) >= 0.6 THEN 4
            WHEN PERCENT_RANK() OVER (ORDER BY frequency_count) >= 0.4 THEN 3
            WHEN PERCENT_RANK() OVER (ORDER BY frequency_count) >= 0.2 THEN 2
            ELSE 1
        END AS f_score,
        -- Mè¯„åˆ†ï¼šè´­ä¹°é‡‘é¢è¶Šé«˜åˆ†æ•°è¶Šé«˜
        CASE 
            WHEN PERCENT_RANK() OVER (ORDER BY monetary_total) >= 0.8 THEN 5
            WHEN PERCENT_RANK() OVER (ORDER BY monetary_total) >= 0.6 THEN 4
            WHEN PERCENT_RANK() OVER (ORDER BY monetary_total) >= 0.4 THEN 3
            WHEN PERCENT_RANK() OVER (ORDER BY monetary_total) >= 0.2 THEN 2
            ELSE 1
        END AS m_score
    FROM rfm_metrics
)

SELECT 
    customer_id,
    r_score,
    f_score,
    m_score,
    CONCAT(r_score, f_score, m_score) AS rfm_code,
    CASE 
        WHEN r_score >= 4 AND f_score >= 4 AND m_score >= 4 THEN 'ğŸ’ VIPå®¢æˆ·'
        WHEN r_score >= 3 AND f_score >= 3 AND m_score >= 3 THEN 'ğŸŒŸ é‡è¦å®¢æˆ·'
        WHEN r_score <= 2 AND f_score <= 2 THEN 'ğŸ˜´ æµå¤±é£é™©å®¢æˆ·'
        WHEN r_score >= 4 AND f_score <= 2 THEN 'ğŸ†• æ–°å®¢æˆ·'
        ELSE 'ğŸ‘¤ æ™®é€šå®¢æˆ·'
    END AS customer_segment,
    recency_days,
    frequency_count,
    monetary_total
FROM rfm_scores
ORDER BY m_score DESC, f_score DESC, r_score DESC;
```

### 5.2 äº§å“é”€å”®çŸ©é˜µåˆ†æ


**ğŸ“¦ äº§å“ABCåˆ†æ**

```sql
-- äº§å“ABCåˆ†æï¼ˆå¸•ç´¯æ‰˜åˆ†æï¼‰
WITH
-- äº§å“é”€å”®æ±‡æ€»
product_sales AS (
    SELECT 
        p.product_id,
        p.product_name,
        p.category,
        SUM(oi.quantity * oi.unit_price) AS total_revenue,
        SUM(oi.quantity) AS total_quantity
    FROM products p
    JOIN order_items oi ON p.product_id = oi.product_id
    JOIN orders o ON oi.order_id = o.id
    WHERE o.order_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    GROUP BY p.product_id, p.product_name, p.category
),

-- ABCåˆ†ç±»åˆ†æ
abc_analysis AS (
    SELECT 
        *,
        -- æ”¶å…¥æ’å
        ROW_NUMBER() OVER (ORDER BY total_revenue DESC) AS revenue_rank,
        -- æ”¶å…¥å æ¯”
        ROUND(total_revenue * 100.0 / SUM(total_revenue) OVER (), 2) AS revenue_percentage,
        -- ç´¯è®¡æ”¶å…¥å æ¯”
        ROUND(SUM(total_revenue) OVER (ORDER BY total_revenue DESC) * 100.0 / 
              SUM(total_revenue) OVER (), 2) AS cumulative_percentage
    FROM product_sales
)

SELECT 
    product_name,
    category,
    total_revenue,
    revenue_percentage,
    cumulative_percentage,
    CASE 
        WHEN cumulative_percentage <= 70 THEN 'Aç±»äº§å“ (æ ¸å¿ƒ)'
        WHEN cumulative_percentage <= 90 THEN 'Bç±»äº§å“ (é‡è¦)'
        ELSE 'Cç±»äº§å“ (ä¸€èˆ¬)'
    END AS abc_category,
    CASE 
        WHEN cumulative_percentage <= 70 THEN 'ğŸ’°'
        WHEN cumulative_percentage <= 90 THEN 'ğŸ“Š'
        ELSE 'ğŸ“¦'
    END AS category_icon,
    revenue_rank
FROM abc_analysis
ORDER BY revenue_rank;
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 CTEæ‰§è¡Œè®¡åˆ’ä¼˜åŒ–


> **ğŸ¤” æ€§èƒ½ç–‘é—®**ï¼šCTEä¼šå½±å“æŸ¥è¯¢æ€§èƒ½å—ï¼Ÿ
> **ğŸ’¡ ç­”æ¡ˆ**ï¼šCTEæœ¬èº«ä¸å½±å“æ€§èƒ½ï¼Œå…³é”®çœ‹æŸ¥è¯¢é€»è¾‘ã€‚å°±åƒæ­ç§¯æœ¨ï¼Œç§¯æœ¨å—ï¼ˆCTEï¼‰æœ¬èº«ä¸é‡ï¼Œé‡çš„æ˜¯ä½ æ­çš„é€ å‹ï¼ˆæŸ¥è¯¢é€»è¾‘ï¼‰å¤æ‚ç¨‹åº¦ã€‚

**ğŸ”¸ CTEæ€§èƒ½ç‰¹ç‚¹åˆ†æ**
```
CTEæ€§èƒ½ç‰¹ç‚¹ï¼š
â”Œâ”€ ä¼˜åŠ¿æ–¹é¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æé«˜ä»£ç å¯è¯»æ€§             â”‚
â”‚ â€¢ é¿å…é‡å¤å­æŸ¥è¯¢             â”‚
â”‚ â€¢ ä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–             â”‚
â”‚ â€¢ æ”¯æŒé€’å½’æŸ¥è¯¢               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ³¨æ„äº‹é¡¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¸´æ—¶è¡¨         â”‚
â”‚ â€¢ æ¯æ¬¡å¼•ç”¨éƒ½ä¼šé‡æ–°æ‰§è¡Œ       â”‚
â”‚ â€¢ å¤æ‚CTEå¯èƒ½å½±å“æ€§èƒ½        â”‚
â”‚ â€¢ éœ€è¦åˆç†è®¾è®¡æ‰§è¡Œé¡ºåº       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ CTEä¼˜åŒ–æŠ€å·§**

| ä¼˜åŒ–ç­–ç•¥ | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|---------|----------|-------------|----------|
| **ç´¢å¼•ä¼˜åŒ–** | åœ¨CTEæ¶‰åŠçš„å­—æ®µä¸Šå»ºç´¢å¼• | å¤§æ•°æ®é‡æŸ¥è¯¢ | `CREATE INDEX idx_order_date ON orders(order_date)` |
| **åˆ†æ­¥æ‰§è¡Œ** | å°†å¤æ‚CTEæ‹†åˆ†ä¸ºå¤šä¸ªç®€å•CTE | å¤æ‚ä¸šåŠ¡é€»è¾‘ | å¤šä¸ªWITHå­å¥ |
| **æ•°æ®è¿‡æ»¤** | åœ¨CTEæ—©æœŸé˜¶æ®µè¿‡æ»¤æ•°æ® | å‡å°‘æ•°æ®å¤„ç†é‡ | `WHERE order_date >= '2024-01-01'` |
| **é¿å…é‡å¤** | å¤šæ¬¡ä½¿ç”¨çš„CTEè¦åˆç†è®¾è®¡ | å¤æ‚åµŒå¥—æŸ¥è¯¢ | åˆå¹¶ç›¸ä¼¼çš„CTE |

### 6.2 çª—å£å‡½æ•°æ€§èƒ½ä¼˜åŒ–


**ğŸ“Š çª—å£å‡½æ•°ä¼˜åŒ–è¦ç‚¹**

```sql
-- æ€§èƒ½ä¼˜åŒ–å¯¹æ¯”ç¤ºä¾‹

-- âŒ æ€§èƒ½è¾ƒå·®çš„å†™æ³•
SELECT 
    customer_id,
    order_date,
    amount,
    (SELECT COUNT(*) FROM orders o2 WHERE o2.customer_id = o1.customer_id AND o2.order_date <= o1.order_date) AS running_count
FROM orders o1;

-- âœ… æ€§èƒ½ä¼˜åŒ–çš„å†™æ³•
WITH ordered_data AS (
    SELECT 
        customer_id,
        order_date,
        amount
    FROM orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 365 DAY)  -- æå‰è¿‡æ»¤
)
SELECT 
    customer_id,
    order_date,
    amount,
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date) AS running_count
FROM ordered_data;
```

### 6.3 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**ğŸ§  å†…å­˜ç®¡ç†ç­–ç•¥**

```sql
-- åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡
WITH batch_config AS (
    SELECT 10000 AS batch_size, 0 AS current_offset
),

-- åˆ†æ‰¹æŸ¥è¯¢
batch_data AS (
    SELECT 
        customer_id,
        SUM(amount) AS total_amount,
        COUNT(*) AS order_count
    FROM orders o
    CROSS JOIN batch_config bc
    WHERE o.id BETWEEN bc.current_offset AND (bc.current_offset + bc.batch_size)
    GROUP BY customer_id
)

SELECT 
    customer_id,
    total_amount,
    order_count,
    NTILE(10) OVER (ORDER BY total_amount) AS decile_group
FROM batch_data;
```

---

## 7. ğŸ¯ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 ç”µå•†å¹³å°ç”¨æˆ·è¡Œä¸ºåˆ†æ


**ğŸ›’ ç”¨æˆ·è´­ä¹°è·¯å¾„åˆ†æ**

```sql
-- ç”¨æˆ·è´­ä¹°è¡Œä¸ºåˆ†æ
WITH
-- ç”¨æˆ·è¡Œä¸ºäº‹ä»¶
user_events AS (
    SELECT 
        user_id,
        event_time,
        event_type,  -- 'view', 'cart', 'purchase'
        product_id
    FROM user_behavior_log
    WHERE event_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
),

-- è´­ä¹°è·¯å¾„åˆ†æ
purchase_funnel AS (
    SELECT 
        user_id,
        product_id,
        -- æŸ¥çœ‹æ¬¡æ•°
        SUM(CASE WHEN event_type = 'view' THEN 1 ELSE 0 END) AS view_count,
        -- åŠ è´­æ¬¡æ•°
        SUM(CASE WHEN event_type = 'cart' THEN 1 ELSE 0 END) AS cart_count,
        -- è´­ä¹°æ¬¡æ•°
        SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS purchase_count,
        -- è½¬åŒ–æ—¶é—´åˆ†æ
        MAX(CASE WHEN event_type = 'view' THEN event_time END) AS last_view_time,
        MAX(CASE WHEN event_type = 'purchase' THEN event_time END) AS purchase_time
    FROM user_events
    GROUP BY user_id, product_id
)

SELECT 
    user_id,
    product_id,
    view_count,
    cart_count, 
    purchase_count,
    CASE 
        WHEN purchase_count > 0 THEN 'âœ… å·²è´­ä¹°'
        WHEN cart_count > 0 THEN 'ğŸ›’ å·²åŠ è´­ç‰©è½¦'
        WHEN view_count > 0 THEN 'ğŸ‘€ ä»…æµè§ˆ'
        ELSE 'â“ æ— è¡Œä¸º'
    END AS user_stage,
    CASE 
        WHEN purchase_time IS NOT NULL AND last_view_time IS NOT NULL THEN
            TIMESTAMPDIFF(HOUR, last_view_time, purchase_time)
        ELSE NULL
    END AS decision_hours
FROM purchase_funnel
WHERE view_count > 0
ORDER BY user_id, view_count DESC;
```

### 7.2 è´¢åŠ¡æ•°æ®åˆ†æ


**ğŸ’° è´¢åŠ¡æŒ‡æ ‡åˆ†æ**

```sql
-- æœˆåº¦è´¢åŠ¡æŒ‡æ ‡åˆ†æ
WITH
-- æœˆåº¦æ”¶æ”¯æ•°æ®
monthly_finance AS (
    SELECT 
        DATE_FORMAT(transaction_date, '%Y-%m') AS month,
        SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) AS income,
        SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) AS expense
    FROM financial_transactions
    WHERE transaction_date >= DATE_SUB(CURDATE(), INTERVAL 24 MONTH)
    GROUP BY DATE_FORMAT(transaction_date, '%Y-%m')
),

-- è´¢åŠ¡åˆ†ææŒ‡æ ‡
finance_analysis AS (
    SELECT 
        month,
        income,
        expense,
        income - expense AS profit,
        -- åˆ©æ¶¦ç‡
        ROUND((income - expense) * 100.0 / income, 2) AS profit_margin,
        -- ç¯æ¯”å¢é•¿
        LAG(income) OVER (ORDER BY month) AS prev_income,
        LAG(expense) OVER (ORDER BY month) AS prev_expense,
        -- ç´¯è®¡åˆ©æ¶¦
        SUM(income - expense) OVER (ORDER BY month) AS cumulative_profit
    FROM monthly_finance
)

SELECT 
    month,
    income,
    expense,
    profit,
    profit_margin,
    CASE 
        WHEN prev_income IS NOT NULL THEN
            ROUND((income - prev_income) * 100.0 / prev_income, 2)
        ELSE NULL
    END AS income_growth,
    cumulative_profit,
    CASE 
        WHEN profit > 0 THEN 'ğŸ“ˆ ç›ˆåˆ©'
        WHEN profit = 0 THEN 'âš–ï¸ ç›ˆäºå¹³è¡¡'
        ELSE 'ğŸ“‰ äºæŸ'
    END AS profit_status
FROM finance_analysis
ORDER BY month;
```

---

## 8. ğŸ—ï¸ CTEçª—å£å‡½æ•°ç»„åˆè®¾è®¡


### 8.1 åˆ†å±‚æ¶æ„è®¾è®¡æ¨¡å¼


> **ğŸ’¡ è®¾è®¡æ€è·¯**ï¼šå¥½çš„CTEçª—å£å‡½æ•°ç»„åˆå°±åƒç›–æˆ¿å­ï¼Œå…ˆæ‰“åœ°åŸºï¼ˆåŸºç¡€æ•°æ®ï¼‰ï¼Œå†å»ºæ¡†æ¶ï¼ˆä¸­é—´å¤„ç†ï¼‰ï¼Œæœ€åè£…ä¿®ï¼ˆçª—å£åˆ†æï¼‰ã€‚

**ğŸ—ï¸ æ ‡å‡†åˆ†å±‚æ¶æ„**

```
CTEåˆ†å±‚è®¾è®¡æ¨¡å¼ï¼š
â”Œâ”€ ç¬¬1å±‚ï¼šæ•°æ®åŸºç¡€å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–           â”‚
â”‚ â€¢ åŸºç¡€å­—æ®µè®¡ç®—               â”‚
â”‚ â€¢ æ•°æ®è´¨é‡è¿‡æ»¤               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€ ç¬¬2å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ä¸šåŠ¡è§„åˆ™åº”ç”¨               â”‚
â”‚ â€¢ ç»´åº¦æ±‡æ€»è®¡ç®—               â”‚  
â”‚ â€¢ ä¸­é—´ç»“æœå­˜å‚¨               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€ ç¬¬3å±‚ï¼šåˆ†æå±•ç¤ºå±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ çª—å£å‡½æ•°é«˜çº§åˆ†æ           â”‚
â”‚ â€¢ æ’åå’Œè¶‹åŠ¿è®¡ç®—             â”‚
â”‚ â€¢ æœ€ç»ˆç»“æœå±•ç¤º               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» æ¶æ„å®ç°æ¨¡æ¿**

```sql
-- æ ‡å‡†ä¸‰å±‚CTEæ¶æ„æ¨¡æ¿
WITH
-- ã€æ•°æ®åŸºç¡€å±‚ã€‘
base_data AS (
    SELECT 
        -- åŸºç¡€å­—æ®µæ¸…æ´—
        id,
        TRIM(name) AS clean_name,
        COALESCE(amount, 0) AS clean_amount,
        date_field
    FROM source_table
    WHERE date_field >= DATE_SUB(CURDATE(), INTERVAL 365 DAY)
      AND status = 'active'
),

-- ã€ä¸šåŠ¡é€»è¾‘å±‚ã€‘  
business_data AS (
    SELECT 
        -- ä¸šåŠ¡è®¡ç®—
        clean_name,
        SUM(clean_amount) AS total_amount,
        COUNT(*) AS record_count,
        DATE_FORMAT(date_field, '%Y-%m') AS period
    FROM base_data
    GROUP BY clean_name, DATE_FORMAT(date_field, '%Y-%m')
),

-- ã€åˆ†æå±•ç¤ºå±‚ã€‘
analysis_result AS (
    SELECT 
        *,
        -- çª—å£å‡½æ•°åˆ†æ
        ROW_NUMBER() OVER (PARTITION BY period ORDER BY total_amount DESC) AS period_rank,
        ROUND(total_amount * 100.0 / SUM(total_amount) OVER (PARTITION BY period), 2) AS percentage
    FROM business_data
)

SELECT * FROM analysis_result WHERE period_rank <= 10;
```

### 8.2 å¤ç”¨æ€§è®¾è®¡


**ğŸ”„ å¯å¤ç”¨CTEç»„ä»¶è®¾è®¡**

```sql
-- é€šç”¨æ—¶é—´ç»´åº¦CTE
WITH time_dimension AS (
    SELECT 
        date_value,
        DATE_FORMAT(date_value, '%Y') AS year,
        DATE_FORMAT(date_value, '%Y-%m') AS year_month,
        DATE_FORMAT(date_value, '%Y-%u') AS year_week,
        QUARTER(date_value) AS quarter,
        DAYNAME(date_value) AS day_name
    FROM (
        SELECT DATE_SUB(CURDATE(), INTERVAL seq DAY) AS date_value
        FROM (SELECT 0 seq UNION SELECT 1 UNION SELECT 2 /* ... ç»§ç»­åˆ°365 */) AS sequence
        WHERE seq <= 365
    ) AS date_range
),

-- å¤ç”¨æ—¶é—´ç»´åº¦è¿›è¡Œåˆ†æ
sales_by_time AS (
    SELECT 
        td.year_month,
        td.quarter,
        SUM(o.amount) AS monthly_sales
    FROM time_dimension td
    LEFT JOIN orders o ON DATE(o.order_date) = td.date_value
    GROUP BY td.year_month, td.quarter
)

SELECT 
    year_month,
    monthly_sales,
    AVG(monthly_sales) OVER (PARTITION BY quarter) AS quarter_avg,
    CASE 
        WHEN monthly_sales > AVG(monthly_sales) OVER (PARTITION BY quarter) THEN 'ğŸ“ˆ é«˜äºå­£åº¦å‡å€¼'
        ELSE 'ğŸ“Š ä½äºå­£åº¦å‡å€¼'
    END AS performance_vs_quarter
FROM sales_by_time
WHERE monthly_sales IS NOT NULL;
```

---

## 9. ğŸ“ˆ åˆ†å±‚åˆ†æä¼˜åŒ–ç­–ç•¥


### 9.1 æŸ¥è¯¢æ‰§è¡Œä¼˜åŒ–


**âš¡ æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–**

```sql
-- ä¼˜åŒ–å‰ï¼šå¤šå±‚åµŒå¥—æŸ¥è¯¢
SELECT customer_id, total_orders
FROM (
    SELECT customer_id, COUNT(*) AS total_orders,
           ROW_NUMBER() OVER (ORDER BY COUNT(*) DESC) AS rank
    FROM (
        SELECT customer_id FROM orders WHERE amount > 100
    ) AS filtered_orders
    GROUP BY customer_id
) AS ranked_customers
WHERE rank <= 10;

-- ä¼˜åŒ–åï¼šä½¿ç”¨CTEåˆ†å±‚
WITH
filtered_orders AS (
    SELECT customer_id
    FROM orders 
    WHERE amount > 100
      AND order_date >= DATE_SUB(CURDATE(), INTERVAL 365 DAY)  -- æ·»åŠ æ—¶é—´è¿‡æ»¤
),
customer_stats AS (
    SELECT 
        customer_id,
        COUNT(*) AS total_orders
    FROM filtered_orders
    GROUP BY customer_id
)
SELECT 
    customer_id,
    total_orders,
    ROW_NUMBER() OVER (ORDER BY total_orders DESC) AS rank
FROM customer_stats
QUALIFY ROW_NUMBER() OVER (ORDER BY total_orders DESC) <= 10;  -- MySQL 8.0+æ”¯æŒQUALIFY
```

### 9.2 ç´¢å¼•ç­–ç•¥é…åˆ


**ğŸ” ç´¢å¼•è®¾è®¡å»ºè®®**

```sql
-- é’ˆå¯¹CTEçª—å£å‡½æ•°çš„ç´¢å¼•è®¾è®¡
-- åŸºç¡€æ•°æ®è¡¨ç´¢å¼•
CREATE INDEX idx_orders_composite ON orders(customer_id, order_date, amount);
CREATE INDEX idx_order_date ON orders(order_date);

-- éªŒè¯ç´¢å¼•æ•ˆæœ
EXPLAIN 
WITH customer_monthly AS (
    SELECT 
        customer_id,
        DATE_FORMAT(order_date, '%Y-%m') AS month,
        SUM(amount) AS monthly_amount
    FROM orders
    WHERE order_date >= '2024-01-01'  -- åˆ©ç”¨idx_order_date
    GROUP BY customer_id, DATE_FORMAT(order_date, '%Y-%m')
)
SELECT 
    customer_id,
    month,
    monthly_amount,
    LAG(monthly_amount) OVER (PARTITION BY customer_id ORDER BY month) AS prev_month
FROM customer_monthly;
```

---

## 10. ğŸ’¼ å®é™…åº”ç”¨æ¡ˆä¾‹


### 10.1 é”€å”®æ¼æ–—åˆ†æ


**ğŸ¯ é”€å”®è½¬åŒ–åˆ†æ**

```sql
-- é”€å”®æ¼æ–—è½¬åŒ–åˆ†æ
WITH
-- çº¿ç´¢é˜¶æ®µç»Ÿè®¡
lead_stage AS (
    SELECT 
        DATE_FORMAT(created_date, '%Y-%m') AS month,
        stage,
        COUNT(*) AS stage_count
    FROM sales_leads
    WHERE created_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    GROUP BY DATE_FORMAT(created_date, '%Y-%m'), stage
),

-- è½¬åŒ–ç‡è®¡ç®—
conversion_analysis AS (
    SELECT 
        month,
        SUM(CASE WHEN stage = 'lead' THEN stage_count ELSE 0 END) AS leads,
        SUM(CASE WHEN stage = 'qualified' THEN stage_count ELSE 0 END) AS qualified,
        SUM(CASE WHEN stage = 'opportunity' THEN stage_count ELSE 0 END) AS opportunities,
        SUM(CASE WHEN stage = 'closed_won' THEN stage_count ELSE 0 END) AS closed_won
    FROM lead_stage
    GROUP BY month
)

SELECT 
    month,
    leads,
    qualified,
    opportunities,
    closed_won,
    -- å„é˜¶æ®µè½¬åŒ–ç‡
    ROUND(qualified * 100.0 / NULLIF(leads, 0), 2) AS lead_to_qualified_rate,
    ROUND(opportunities * 100.0 / NULLIF(qualified, 0), 2) AS qualified_to_opp_rate,
    ROUND(closed_won * 100.0 / NULLIF(opportunities, 0), 2) AS opp_to_close_rate,
    -- æ•´ä½“è½¬åŒ–ç‡
    ROUND(closed_won * 100.0 / NULLIF(leads, 0), 2) AS overall_conversion_rate,
    -- è½¬åŒ–ç‡è¶‹åŠ¿
    LAG(ROUND(closed_won * 100.0 / NULLIF(leads, 0), 2)) OVER (ORDER BY month) AS prev_conversion_rate
FROM conversion_analysis
ORDER BY month;
```

### 10.2 åº“å­˜å‘¨è½¬åˆ†æ


**ğŸ“¦ åº“å­˜ç®¡ç†åˆ†æ**

```sql
-- å•†å“åº“å­˜å‘¨è½¬åˆ†æ
WITH
-- åº“å­˜åŸºç¡€æ•°æ®
inventory_base AS (
    SELECT 
        product_id,
        DATE_FORMAT(date, '%Y-%m') AS month,
        AVG(stock_quantity) AS avg_stock,
        SUM(sales_quantity) AS total_sales
    FROM daily_inventory
    WHERE date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    GROUP BY product_id, DATE_FORMAT(date, '%Y-%m')
),

-- å‘¨è½¬ç‡è®¡ç®—
turnover_analysis AS (
    SELECT 
        product_id,
        month,
        avg_stock,
        total_sales,
        -- åº“å­˜å‘¨è½¬ç‡ = é”€é‡ / å¹³å‡åº“å­˜
        CASE 
            WHEN avg_stock > 0 THEN ROUND(total_sales / avg_stock, 2)
            ELSE 0
        END AS turnover_rate,
        -- å‘¨è½¬ç‡æ’å
        ROW_NUMBER() OVER (PARTITION BY month ORDER BY 
            CASE WHEN avg_stock > 0 THEN total_sales / avg_stock ELSE 0 END DESC
        ) AS turnover_rank
    FROM inventory_base
)

SELECT 
    product_id,
    month,
    avg_stock,
    total_sales,
    turnover_rate,
    turnover_rank,
    CASE 
        WHEN turnover_rate >= 10 THEN 'ğŸ”¥ é«˜å‘¨è½¬'
        WHEN turnover_rate >= 5 THEN 'ğŸ“ˆ æ­£å¸¸å‘¨è½¬'  
        WHEN turnover_rate >= 1 THEN 'ğŸ“Š ä½å‘¨è½¬'
        ELSE 'âš ï¸ æ»é”€å•†å“'
    END AS turnover_category
FROM turnover_analysis
WHERE turnover_rank <= 20
ORDER BY month, turnover_rank;
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CTEçª—å£å‡½æ•°ç»„åˆï¼šåˆ†å±‚å¤„ç†å¤æ‚åˆ†æï¼Œæå‡ä»£ç å¯è¯»æ€§
ğŸ”¸ åˆ†å±‚åˆ†ææ€è·¯ï¼šåŸºç¡€å±‚â†’ä¸šåŠ¡å±‚â†’åˆ†æå±‚çš„é€’è¿›å¼å¤„ç†
ğŸ”¸ å¤æ‚ç»Ÿè®¡å®ç°ï¼šå¤šæŒ‡æ ‡ç»¼åˆåˆ†æï¼Œæ—¶é—´åºåˆ—å¯¹æ¯”åˆ†æ
ğŸ”¸ å¤šç»´åº¦åˆ†æï¼šå®¢æˆ·ã€äº§å“ã€æ—¶é—´ç­‰å¤šä¸ªç»´åº¦äº¤å‰åˆ†æ
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼šåˆç†è®¾è®¡CTEå±‚æ¬¡ï¼Œé…åˆç´¢å¼•ä½¿ç”¨
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CTEä¸çª—å£å‡½æ•°çš„ååŒä»·å€¼**
```
CTEçš„ä»·å€¼ï¼š
â€¢ ç®€åŒ–å¤æ‚æŸ¥è¯¢ï¼šå°†å¤§æŸ¥è¯¢æ‹†åˆ†ä¸ºå°æ­¥éª¤
â€¢ æé«˜å¯è¯»æ€§ï¼šæ¯ä¸ªCTEéƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰
â€¢ ä¾¿äºè°ƒè¯•ï¼šå¯ä»¥å•ç‹¬æ‰§è¡Œæ¯ä¸ªCTEéªŒè¯ç»“æœ
â€¢ æ”¯æŒé€’å½’ï¼šå¤„ç†å±‚æ¬¡åŒ–æ•°æ®ç»“æ„

çª—å£å‡½æ•°çš„ä»·å€¼ï¼š
â€¢ è¡Œçº§è®¡ç®—ï¼šä¸ºæ¯è¡Œæ•°æ®æä¾›ä¸Šä¸‹æ–‡è®¡ç®—
â€¢ ä¿æŒè¡Œæ•°ï¼šä¸åƒGROUP BYä¼šå‡å°‘è¡Œæ•°
â€¢ ä¸°å¯Œåˆ†æï¼šæ’åã€ç´¯è®¡ã€å¯¹æ¯”ç­‰é«˜çº§åˆ†æ
â€¢ æ€§èƒ½ä¼˜è¶Šï¼šæ¯”å­æŸ¥è¯¢æ€§èƒ½æ›´å¥½
```

**ğŸ”¹ ç»„åˆä½¿ç”¨çš„æœ€ä½³å®è·µ**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ åˆ†å±‚æ¸…æ™°ï¼šæ¯å±‚CTEèŒè´£å•ä¸€æ˜ç¡®
â€¢ æ•°æ®è¿‡æ»¤ï¼šæ—©æœŸè¿‡æ»¤å‡å°‘æ•°æ®é‡
â€¢ ç´¢å¼•é…åˆï¼šæ ¹æ®CTEæŸ¥è¯¢æ¡ä»¶å»ºç«‹ç´¢å¼•
â€¢ é€‚åº¦å¤æ‚ï¼šé¿å…è¿‡åº¦åµŒå¥—å½±å“æ€§èƒ½

å¸¸è§æ¨¡å¼ï¼š
â€¢ æ•°æ®å‡†å¤‡ + ä¸šåŠ¡è®¡ç®— + çª—å£åˆ†æ
â€¢ é€’å½’æŸ¥è¯¢ + å±‚æ¬¡åˆ†æ + æ’åç»Ÿè®¡
â€¢ æ—¶é—´åºåˆ— + å¯¹æ¯”åˆ†æ + è¶‹åŠ¿é¢„æµ‹
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“‹ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å¤æ‚çš„å¤šæ­¥éª¤åˆ†ææŸ¥è¯¢
âœ… éœ€è¦å¤šä¸ªç»´åº¦äº¤å‰åˆ†æ
âœ… é€’å½’å±‚æ¬¡ç»“æ„åˆ†æ
âœ… æ—¶é—´åºåˆ—å¯¹æ¯”åˆ†æ
âœ… éœ€è¦æé«˜æŸ¥è¯¢å¯è¯»æ€§

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ç®€å•çš„å•è¡¨æŸ¥è¯¢
âŒ å®æ—¶æ€§è¦æ±‚æé«˜çš„æŸ¥è¯¢
âŒ æ•°æ®é‡æå¤§ä¸”èµ„æºå—é™
âŒ é¢‘ç¹æ‰§è¡Œçš„ç®€å•æŸ¥è¯¢
```

**âš–ï¸ æ€§èƒ½æƒè¡¡è€ƒè™‘**
```
æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ æ—©æœŸæ•°æ®è¿‡æ»¤ï¼šåœ¨ç¬¬ä¸€å±‚CTEä¸­è¿‡æ»¤æ•°æ®
â€¢ åˆç†åˆ†å±‚ï¼šé¿å…è¿‡åº¦åµŒå¥—
â€¢ ç´¢å¼•æ”¯æŒï¼šä¸ºCTEæŸ¥è¯¢æ¡ä»¶å»ºç«‹åˆé€‚ç´¢å¼•
â€¢ æ‰§è¡Œè®¡åˆ’ï¼šä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢æ€§èƒ½

æ›¿ä»£æ–¹æ¡ˆï¼š
â€¢ ç®€å•æŸ¥è¯¢ï¼šç›´æ¥ä½¿ç”¨çª—å£å‡½æ•°
â€¢ é¢‘ç¹æŸ¥è¯¢ï¼šè€ƒè™‘ç‰©åŒ–è§†å›¾
â€¢ å¤§æ•°æ®é‡ï¼šè€ƒè™‘åˆ†è¡¨åˆ†åº“
â€¢ å®æ—¶åˆ†æï¼šè€ƒè™‘æµå¤„ç†æ¡†æ¶
```

> **ğŸ’¡ ä¸€å¥è¯æ€»ç»“**ï¼šCTEä¸çª—å£å‡½æ•°çš„ç»„åˆæ˜¯SQLåˆ†æçš„"ç‘å£«å†›åˆ€"ï¼Œèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¤æ‚çš„å¤šç»´åº¦æ•°æ®åˆ†æéœ€æ±‚ã€‚

### 11.4 å­¦ä¹ å»ºè®®å’Œè¿›é˜¶æ–¹å‘


**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**
```
åŸºç¡€æŠ€èƒ½ï¼š
â€¢ ç†Ÿç»ƒæŒæ¡åŸºæœ¬CTEè¯­æ³•å’Œçª—å£å‡½æ•°
â€¢ ç†è§£åˆ†å±‚è®¾è®¡æ€è·¯å’Œæœ€ä½³å®è·µ
â€¢ æŒæ¡å¸¸è§åˆ†æåœºæ™¯çš„å®ç°æ–¹æ³•

è¿›é˜¶æŠ€èƒ½ï¼š
â€¢ å¤æ‚é€’å½’CTEçš„è®¾è®¡å’Œä¼˜åŒ–
â€¢ å¤§æ•°æ®é‡åœºæ™¯çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§  
â€¢ å¤šç»´åº¦åˆ†ææ¨¡å‹çš„è®¾è®¡æ–¹æ³•

ä¸“å®¶æŠ€èƒ½ï¼š
â€¢ åˆ†æå‹æ•°æ®åº“æ¶æ„è®¾è®¡
â€¢ å®æ—¶åˆ†æç³»ç»Ÿè®¾è®¡
â€¢ æ•°æ®ä»“åº“ETLæµç¨‹è®¾è®¡
```

**ğŸ”— çŸ¥è¯†å…³è”**
- â† å‰ç½®çŸ¥è¯†ï¼šåŸºç¡€SQLæŸ¥è¯¢ã€èšåˆå‡½æ•°ã€å­æŸ¥è¯¢
- â†’ åç»­å­¦ä¹ ï¼šæ•°æ®ä»“åº“å»ºæ¨¡ã€OLAPåˆ†æã€BIæŠ¥è¡¨å¼€å‘

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
â”Œâ”€ CTEçª—å£å‡½æ•°ç»„åˆè¦è¯€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å±‚è®¾è®¡æ€è·¯æ¸…ï¼ŒCTEçª—å£å·§é…åˆ  â”‚
â”‚ åŸºç¡€ä¸šåŠ¡åˆ†æå±‚ï¼Œé€’è¿›åˆ†ææ•ˆæœä½³  â”‚
â”‚ æ€§èƒ½ä¼˜åŒ–è¦ç‰¢è®°ï¼Œç´¢å¼•è¿‡æ»¤æ˜¯å…³é”®  â”‚
â”‚ å¤æ‚åˆ†æå˜ç®€å•ï¼Œæ•°æ®æ´å¯Ÿæ›´æ·±å…¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```