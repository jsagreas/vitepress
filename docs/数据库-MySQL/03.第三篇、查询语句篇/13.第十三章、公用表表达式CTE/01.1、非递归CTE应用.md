---
title: 1ã€éé€’å½’CTEåº”ç”¨
---
## ğŸ“š ç›®å½•

1. [CTEåŸºæœ¬æ¦‚å¿µä¸èƒŒæ™¯](#1-CTEåŸºæœ¬æ¦‚å¿µä¸èƒŒæ™¯)
2. [WITHå­å¥è¯­æ³•è¯¦è§£](#2-WITHå­å¥è¯­æ³•è¯¦è§£)
3. [éé€’å½’CTEæ ¸å¿ƒåº”ç”¨](#3-éé€’å½’CTEæ ¸å¿ƒåº”ç”¨)
4. [CTEä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”](#4-CTEä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”)
5. [CTEæŸ¥è¯¢è®¾è®¡åŸåˆ™](#5-CTEæŸ¥è¯¢è®¾è®¡åŸåˆ™)
6. [å®é™…åº”ç”¨åœºæ™¯æ·±å…¥](#6-å®é™…åº”ç”¨åœºæ™¯æ·±å…¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ CTEåŸºæœ¬æ¦‚å¿µä¸èƒŒæ™¯


### 1.1 ä»€ä¹ˆæ˜¯CTEï¼ˆCommon Table Expressionï¼‰


**ğŸ”¸ ç®€å•ç†è§£**
CTEå°±æ˜¯ç»™å¤æ‚æŸ¥è¯¢å–ä¸ªä¸´æ—¶åå­—ï¼Œè®©SQLè¯­å¥æ›´å¥½è¯»æ‡‚ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å†™æ–‡ç« æ—¶å…ˆåˆ—æçº² â†’ CTEå®šä¹‰ä¸´æ—¶ç»“æœ
æŒ‰æçº²å†™æ­£æ–‡     â†’ ä¸»æŸ¥è¯¢ä½¿ç”¨CTE

å¥½å¤„ï¼šæ€è·¯æ¸…æ™°ï¼Œç»“æ„åˆ†æ˜
```

**ğŸ“‹ æŠ€æœ¯å®šä¹‰**
```sql
CTEï¼ˆå…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼‰ï¼š
â€¢ æ˜¯ä¸€ä¸ªä¸´æ—¶çš„å‘½åç»“æœé›†
â€¢ åªåœ¨å½“å‰æŸ¥è¯¢è¯­å¥ä¸­æœ‰æ•ˆ
â€¢ å¯ä»¥åœ¨ä¸»æŸ¥è¯¢ä¸­å¤šæ¬¡å¼•ç”¨
â€¢ è®©å¤æ‚æŸ¥è¯¢å˜å¾—ç»“æ„åŒ–å’Œæ˜“è¯»
```

### 1.2 CTEå‘å±•èƒŒæ™¯ä¸å¿…è¦æ€§


**ğŸ“ˆ ä¸ºä»€ä¹ˆéœ€è¦CTEï¼Ÿ**

```
ä¼ ç»Ÿé—®é¢˜ï¼šå¤æ‚æŸ¥è¯¢éš¾ä»¥ç†è§£å’Œç»´æŠ¤

ç¤ºä¾‹ï¼šæŸ¥æ‰¾æ¯ä¸ªéƒ¨é—¨å·¥èµ„æœ€é«˜çš„å‘˜å·¥
-- ä¼ ç»Ÿå†™æ³•ï¼ˆå­æŸ¥è¯¢åµŒå¥—ï¼‰
SELECT e.name, e.salary, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.id
WHERE e.salary = (
    SELECT MAX(salary) 
    FROM employees e2 
    WHERE e2.dept_id = e.dept_id
);

é—®é¢˜ï¼š
âŒ é€»è¾‘å±‚å±‚åµŒå¥—ï¼Œéš¾ä»¥ç†è§£
âŒ å­æŸ¥è¯¢é‡å¤æ‰§è¡Œï¼Œæ€§èƒ½å¯èƒ½è¾ƒå·®
âŒ ä¿®æ”¹å›°éš¾ï¼Œå®¹æ˜“å‡ºé”™
```

**ğŸ’¡ CTEè§£å†³æ–¹æ¡ˆ**
```sql
-- CTEå†™æ³•ï¼ˆç»“æ„åŒ–åˆ†è§£ï¼‰
WITH dept_max_salary AS (
    SELECT dept_id, MAX(salary) as max_sal
    FROM employees
    GROUP BY dept_id
)
SELECT e.name, e.salary, d.dept_name
FROM employees e
JOIN departments d ON e.dept_id = d.id
JOIN dept_max_salary dms ON e.dept_id = dms.dept_id 
                        AND e.salary = dms.max_sal;

ä¼˜åŠ¿ï¼š
âœ… é€»è¾‘æ¸…æ™°ï¼Œå…ˆå®šä¹‰åä½¿ç”¨
âœ… å¯è¯»æ€§å¼ºï¼Œåƒåˆ†æ­¥éª¤è§£é¢˜
âœ… æ˜“äºè°ƒè¯•å’Œä¿®æ”¹
âœ… å¯é‡å¤å¼•ç”¨ï¼Œæé«˜æ•ˆç‡
```

### 1.3 CTEçš„ç»“æ„åŒ–æŸ¥è¯¢è®¾è®¡æ€æƒ³


**ğŸ—ï¸ è®¾è®¡ç†å¿µ**
```
ä¼ ç»ŸSQLæ€ç»´ï¼š        CTEç»“æ„åŒ–æ€ç»´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€ æ­¥éª¤1ï¼šå®šä¹‰ä¸­é—´ç»“æœ â”€â”
â”‚ ä¸€å£æ°”å†™å®Œæ•´å¥ â”‚  â†’  â”‚ WITH table1 AS (...)  â”‚
â”‚ é€»è¾‘å…¨åœ¨è„‘å­é‡Œ â”‚     â”‚ WITH table2 AS (...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”œâ”€ æ­¥éª¤2ï¼šä½¿ç”¨ä¸­é—´ç»“æœ â”€â”¤
                     â”‚ SELECT ... FROM ...   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒæ€æƒ³ï¼šåˆ†è€Œæ²»ä¹‹ï¼Œé€æ­¥æ±‚è§£
```

**ğŸ§  è®¤çŸ¥è´Ÿæ‹…å‡è½»**
```
äººè„‘å¤„ç†å¤æ‚é—®é¢˜çš„æ–¹å¼ï¼š
é—®é¢˜åˆ†è§£ â†’ é€æ­¥è§£å†³ â†’ ç»„åˆç»“æœ

CTEå¥‘åˆè¿™ç§æ€ç»´æ¨¡å¼ï¼š
å¤æ‚æŸ¥è¯¢ â†’ åˆ†è§£æˆCTE â†’ ç»„åˆæˆæœ€ç»ˆæŸ¥è¯¢
```

---

## 2. âš™ï¸ WITHå­å¥è¯­æ³•è¯¦è§£


### 2.1 åŸºæœ¬è¯­æ³•ç»“æ„


**ğŸ“ æ ‡å‡†è¯­æ³•**
```sql
WITH cte_name [(column_list)] AS (
    -- CTEæŸ¥è¯¢å®šä¹‰
    SELECT ...
)
-- ä¸»æŸ¥è¯¢
SELECT ... FROM cte_name ...
```

**ğŸ¯ è¯­æ³•è¦ç‚¹è§£æ**
- **`WITH`å…³é”®å­—**ï¼šæ ‡è¯†CTEå¼€å§‹ï¼Œå¿…é¡»æ”¾åœ¨æŸ¥è¯¢æœ€å‰é¢
- **`cte_name`**ï¼šCTEçš„åå­—ï¼Œç±»ä¼¼ç»™ä¸´æ—¶è¡¨èµ·å
- **`column_list`**ï¼šå¯é€‰ï¼ŒæŒ‡å®šCTEçš„åˆ—å
- **`AS`**ï¼šè¿æ¥CTEåç§°å’Œå®šä¹‰
- **æ‹¬å·å†…å®¹**ï¼šCTEçš„å…·ä½“æŸ¥è¯¢é€»è¾‘

### 2.2 CTEåˆ—åå®šä¹‰æ–¹å¼


**ğŸ”¥ ä¸¤ç§åˆ—åå®šä¹‰æ–¹æ³•**

**æ–¹æ³•1ï¼šåœ¨CTEåç§°åå®šä¹‰**
```sql
WITH sales_summary(region, total_sales, avg_sales) AS (
    SELECT 
        region,
        SUM(amount),
        AVG(amount)
    FROM sales
    GROUP BY region
)
SELECT * FROM sales_summary;
```

**æ–¹æ³•2ï¼šåœ¨SELECTå­å¥ä¸­å®šä¹‰**
```sql
WITH sales_summary AS (
    SELECT 
        region,
        SUM(amount) AS total_sales,
        AVG(amount) AS avg_sales
    FROM sales
    GROUP BY region
)
SELECT * FROM sales_summary;
```

**ğŸ¤” é€‰æ‹©å»ºè®®**
```
æ¨èç”¨æ³•ï¼šæ–¹æ³•2ï¼ˆåœ¨SELECTä¸­å®šä¹‰ï¼‰
åŸå› ï¼š
â€¢ åˆ—åå’Œæ•°æ®ç±»å‹åœ¨ä¸€å¤„ï¼Œæ›´æ¸…æ™°
â€¢ ç¬¦åˆå¸¸è§„SQLå†™æ³•ä¹ æƒ¯
â€¢ ä¿®æ”¹åˆ—åæ—¶åªéœ€æ”¹ä¸€ä¸ªåœ°æ–¹
```

### 2.3 å¤šCTEå®šä¹‰


**ğŸ”— å¤šä¸ªCTEé“¾å¼å®šä¹‰**
```sql
WITH 
-- ç¬¬ä¸€ä¸ªCTEï¼šç»Ÿè®¡æ¯ä¸ªé”€å”®å‘˜çš„ä¸šç»©
salesperson_stats AS (
    SELECT 
        salesperson_id,
        COUNT(*) as order_count,
        SUM(amount) as total_sales
    FROM orders
    WHERE order_date >= '2024-01-01'
    GROUP BY salesperson_id
),
-- ç¬¬äºŒä¸ªCTEï¼šè®¡ç®—å¹³å‡ä¸šç»©
avg_performance AS (
    SELECT 
        AVG(total_sales) as avg_sales,
        AVG(order_count) as avg_orders
    FROM salesperson_stats
),
-- ç¬¬ä¸‰ä¸ªCTEï¼šæ ‡è¯†é«˜ç»©æ•ˆå‘˜å·¥
high_performers AS (
    SELECT s.*
    FROM salesperson_stats s
    CROSS JOIN avg_performance a
    WHERE s.total_sales > a.avg_sales * 1.2
)
-- ä¸»æŸ¥è¯¢ï¼šè·å–é«˜ç»©æ•ˆå‘˜å·¥è¯¦ç»†ä¿¡æ¯
SELECT 
    e.name,
    hp.order_count,
    hp.total_sales,
    e.hire_date
FROM high_performers hp
JOIN employees e ON hp.salesperson_id = e.id
ORDER BY hp.total_sales DESC;
```

**ğŸ“Š å¤šCTEè®¾è®¡è¦ç‚¹**
```
è®¾è®¡åŸåˆ™ï¼š
ğŸ”¸ æ¯ä¸ªCTEè§£å†³ä¸€ä¸ªæ˜ç¡®çš„å­é—®é¢˜
ğŸ”¸ CTEä¹‹é—´å¯ä»¥ç›¸äº’å¼•ç”¨ï¼ˆæŒ‰å®šä¹‰é¡ºåºï¼‰
ğŸ”¸ é¿å…CTEä¹‹é—´çš„å¾ªç¯ä¾èµ–
ğŸ”¸ ä¿æŒæ¯ä¸ªCTEçš„é€»è¾‘ç®€å•æ¸…æ™°

å¼•ç”¨è§„åˆ™ï¼š
â”Œâ”€ CTE1 â”€â”€â”
â”œâ”€ CTE2 â”€â”€â”¤ â† å¯ä»¥å¼•ç”¨CTE1
â”œâ”€ CTE3 â”€â”€â”¤ â† å¯ä»¥å¼•ç”¨CTE1å’ŒCTE2
â””â”€ ä¸»æŸ¥è¯¢ â”€â”˜ â† å¯ä»¥å¼•ç”¨æ‰€æœ‰CTE
```

### 2.4 CTEä½œç”¨åŸŸæ§åˆ¶


**ğŸ¯ ä½œç”¨åŸŸè§„åˆ™**
```sql
-- CTEåªåœ¨å½“å‰æŸ¥è¯¢ä¸­æœ‰æ•ˆ
WITH temp_data AS (
    SELECT id, name FROM users WHERE active = 1
)
SELECT * FROM temp_data;  -- âœ… æœ‰æ•ˆ

-- æ–°çš„æŸ¥è¯¢è¯­å¥ä¸­æ— æ³•ä½¿ç”¨ä¹‹å‰çš„CTE
SELECT * FROM temp_data;  -- âŒ é”™è¯¯ï¼štemp_dataä¸å­˜åœ¨
```

**ğŸ”„ ä½œç”¨åŸŸç‰¹ç‚¹**
```
ç”Ÿå‘½å‘¨æœŸï¼š
â”Œâ”€ æŸ¥è¯¢å¼€å§‹ â”€â”
â”‚ WITHå®šä¹‰   â”‚ â† CTEåœ¨è¿™é‡Œ"å‡ºç”Ÿ"
â”‚ ä¸»æŸ¥è¯¢æ‰§è¡Œ â”‚ â† CTEåœ¨è¿™é‡Œ"å·¥ä½œ"
â””â”€ æŸ¥è¯¢ç»“æŸ â”€â”˜ â† CTEåœ¨è¿™é‡Œ"æ¶ˆå¤±"

å½±å“èŒƒå›´ï¼š
â€¢ åªåœ¨å½“å‰SQLè¯­å¥å†…æœ‰æ•ˆ
â€¢ ä¸èƒ½è·¨è¯­å¥æˆ–è·¨è¿æ¥ä½¿ç”¨
â€¢ ä¸ä¼šåœ¨æ•°æ®åº“ä¸­ç•™ä¸‹ä»»ä½•ç—•è¿¹
```

---

## 3. ğŸš€ éé€’å½’CTEæ ¸å¿ƒåº”ç”¨


### 3.1 å¤æ‚æŸ¥è¯¢åˆ†è§£


**ğŸ’¡ æ ¸å¿ƒä»·å€¼ï¼šåŒ–ç¹ä¸ºç®€**

```
ä¸šåŠ¡éœ€æ±‚ï¼šåˆ†æç”µå•†å¹³å°çš„ç”¨æˆ·è´­ä¹°è¡Œä¸º
è¦æ±‚ï¼šæ‰¾å‡ºè¿ç»­ä¸‰ä¸ªæœˆéƒ½æœ‰è´­ä¹°çš„é«˜ä»·å€¼ç”¨æˆ·

ä¼ ç»Ÿæ€è·¯å›°å¢ƒï¼š
âŒ å¤æ‚çš„æ—¥æœŸè®¡ç®—
âŒ å¤šå±‚åµŒå¥—å­æŸ¥è¯¢
âŒ é€»è¾‘æ··ä¹±éš¾ä»¥ç†è§£
```

**ğŸ¯ CTEåˆ†è§£æ³•**
```sql
WITH 
-- æ­¥éª¤1ï¼šè®¡ç®—æ¯ä¸ªç”¨æˆ·æ¯æœˆçš„è´­ä¹°æƒ…å†µ
monthly_purchases AS (
    SELECT 
        user_id,
        DATE_FORMAT(order_date, '%Y-%m') as month_year,
        COUNT(*) as order_count,
        SUM(amount) as month_total
    FROM orders
    WHERE order_date >= DATE_SUB(CURRENT_DATE, INTERVAL 3 MONTH)
    GROUP BY user_id, DATE_FORMAT(order_date, '%Y-%m')
),
-- æ­¥éª¤2ï¼šæ‰¾å‡ºè¿ç»­è´­ä¹°çš„ç”¨æˆ·
continuous_buyers AS (
    SELECT user_id
    FROM monthly_purchases
    GROUP BY user_id
    HAVING COUNT(DISTINCT month_year) = 3  -- ä¸‰ä¸ªæœˆéƒ½æœ‰è´­ä¹°
),
-- æ­¥éª¤3ï¼šè®¡ç®—é«˜ä»·å€¼æ ‡å‡†
high_value_threshold AS (
    SELECT AVG(month_total) * 2 as threshold
    FROM monthly_purchases
),
-- æ­¥éª¤4ï¼šè¯†åˆ«é«˜ä»·å€¼ç”¨æˆ·
high_value_users AS (
    SELECT DISTINCT mp.user_id
    FROM monthly_purchases mp
    CROSS JOIN high_value_threshold hvt
    WHERE mp.month_total > hvt.threshold
)
-- æœ€ç»ˆæŸ¥è¯¢ï¼šè¿ç»­è´­ä¹°ä¸”é«˜ä»·å€¼çš„ç”¨æˆ·
SELECT 
    u.username,
    u.email,
    SUM(mp.month_total) as total_spent,
    COUNT(mp.month_year) as active_months
FROM continuous_buyers cb
JOIN high_value_users hvu ON cb.user_id = hvu.user_id
JOIN monthly_purchases mp ON cb.user_id = mp.user_id
JOIN users u ON cb.user_id = u.id
GROUP BY u.id, u.username, u.email
ORDER BY total_spent DESC;
```

**âœ¨ åˆ†è§£çš„å¥½å¤„**
```
æ€ç»´è¿‡ç¨‹æ¸…æ™°ï¼š
1ï¸âƒ£ å…ˆç®—å‡ºæ¯æœˆè´­ä¹°æƒ…å†µ
2ï¸âƒ£ å†æ‰¾è¿ç»­è´­ä¹°çš„ç”¨æˆ·  
3ï¸âƒ£ ç„¶åå®šä¹‰é«˜ä»·å€¼æ ‡å‡†
4ï¸âƒ£ æœ€åç»„åˆæ‰€æœ‰æ¡ä»¶

æŠ€æœ¯ä¼˜åŠ¿ï¼š
â€¢ æ¯ä¸ªCTEè§£å†³ä¸€ä¸ªå­é—®é¢˜
â€¢ é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•
â€¢ å¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªCTE
â€¢ ä¿®æ”¹æŸä¸ªæ¡ä»¶åªéœ€æ”¹å¯¹åº”CTE
```

### 3.2 ä¸´æ—¶ç»“æœé›†çš„çµæ´»è¿ç”¨


**ğŸ­ åœºæ™¯ï¼šæ•°æ®æŠ¥è¡¨ç”Ÿæˆ**

```sql
-- ä¸šåŠ¡éœ€æ±‚ï¼šç”Ÿæˆé”€å”®ä¸šç»©å¯¹æ¯”æŠ¥è¡¨
WITH 
-- å½“å‰å­£åº¦ä¸šç»©
current_quarter AS (
    SELECT 
        salesperson_id,
        SUM(amount) as current_sales,
        COUNT(*) as current_orders
    FROM sales
    WHERE sale_date >= DATE_SUB(CURRENT_DATE, INTERVAL 3 MONTH)
    GROUP BY salesperson_id
),
-- ä¸Šä¸€å­£åº¦ä¸šç»©
previous_quarter AS (
    SELECT 
        salesperson_id,
        SUM(amount) as previous_sales,
        COUNT(*) as previous_orders
    FROM sales
    WHERE sale_date BETWEEN 
        DATE_SUB(CURRENT_DATE, INTERVAL 6 MONTH) 
        AND DATE_SUB(CURRENT_DATE, INTERVAL 3 MONTH)
    GROUP BY salesperson_id
),
-- ä¸šç»©å¯¹æ¯”åˆ†æ
performance_comparison AS (
    SELECT 
        COALESCE(cq.salesperson_id, pq.salesperson_id) as salesperson_id,
        COALESCE(cq.current_sales, 0) as current_sales,
        COALESCE(pq.previous_sales, 0) as previous_sales,
        CASE 
            WHEN pq.previous_sales > 0 THEN
                ROUND((cq.current_sales - pq.previous_sales) / pq.previous_sales * 100, 2)
            ELSE NULL
        END as growth_rate
    FROM current_quarter cq
    FULL OUTER JOIN previous_quarter pq 
        ON cq.salesperson_id = pq.salesperson_id
)
-- ç”Ÿæˆæœ€ç»ˆæŠ¥è¡¨
SELECT 
    e.name as å‘˜å·¥å§“å,
    pc.current_sales as æœ¬å­£é”€å”®é¢,
    pc.previous_sales as ä¸Šå­£é”€å”®é¢,
    pc.growth_rate as å¢é•¿ç‡,
    CASE 
        WHEN pc.growth_rate > 20 THEN 'ğŸ† ä¼˜ç§€'
        WHEN pc.growth_rate > 0 THEN 'ğŸ“ˆ è‰¯å¥½'  
        WHEN pc.growth_rate < -10 THEN 'ğŸ“‰ éœ€æ”¹è¿›'
        ELSE 'â– æŒå¹³'
    END as ç»©æ•ˆè¯„çº§
FROM performance_comparison pc
JOIN employees e ON pc.salesperson_id = e.id
ORDER BY pc.growth_rate DESC;
```

**ğŸ¨ ç»“æ„åŒ–æ€ç»´ä½“ç°**
```
ä¸šåŠ¡é€»è¾‘åˆ†è§£ï¼š
ç¬¬1æ­¥ï¼šè·å–å½“å‰å­£åº¦æ•°æ® â†’ current_quarter CTE
ç¬¬2æ­¥ï¼šè·å–å†å²å­£åº¦æ•°æ® â†’ previous_quarter CTE  
ç¬¬3æ­¥ï¼šè®¡ç®—å¯¹æ¯”æŒ‡æ ‡     â†’ performance_comparison CTE
ç¬¬4æ­¥ï¼šç¾åŒ–è¾“å‡ºç»“æœ     â†’ ä¸»æŸ¥è¯¢

ä¼˜åŠ¿å¯¹æ¯”ï¼š
ä¼ ç»Ÿæ–¹æ³•ï¼šæ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ·ï¼Œæ”¹ä¸€å¤„ç‰µæ‰¯å…¨èº«
CTEæ–¹æ³•ï¼šæ¨¡å—åŒ–å¤„ç†ï¼Œä¿®æ”¹æŸä¸ªç»Ÿè®¡ç»´åº¦åªéœ€æ”¹å¯¹åº”CTE
```

### 3.3 CTEå¯è¯»æ€§æå‡å®ä¾‹


**ğŸ“– å¯è¯»æ€§å¯¹æ¯”åˆ†æ**

> âš ï¸ **å¤æ‚æŸ¥è¯¢çš„å™©æ¢¦**
> 
> æ²¡æœ‰CTEæ—¶ï¼Œå¤æ‚æŸ¥è¯¢åƒä¿„ç½—æ–¯å¥—å¨ƒï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œè¯»èµ·æ¥è®©äººå¤´å¤§

**ä¼ ç»Ÿå¤æ‚æŸ¥è¯¢**ï¼š
```sql
-- éš¾ä»¥ç†è§£çš„åµŒå¥—æŸ¥è¯¢
SELECT 
    category_name,
    product_count,
    avg_price,
    price_rank
FROM (
    SELECT 
        c.name as category_name,
        category_stats.product_count,
        category_stats.avg_price,
        ROW_NUMBER() OVER (ORDER BY category_stats.avg_price DESC) as price_rank
    FROM categories c
    JOIN (
        SELECT 
            category_id,
            COUNT(*) as product_count,
            AVG(price) as avg_price
        FROM products
        WHERE status = 'active'
        GROUP BY category_id
        HAVING COUNT(*) >= 5
    ) category_stats ON c.id = category_stats.category_id
) ranked_categories
WHERE price_rank <= 10;
```

**CTEç»“æ„åŒ–æŸ¥è¯¢**ï¼š
```sql
-- æ¸…æ™°æ˜“æ‡‚çš„CTEç‰ˆæœ¬
WITH 
-- ç¬¬1æ­¥ï¼šç»Ÿè®¡æ¯ä¸ªç±»åˆ«çš„åŸºæœ¬ä¿¡æ¯
active_category_stats AS (
    SELECT 
        category_id,
        COUNT(*) as product_count,
        AVG(price) as avg_price
    FROM products
    WHERE status = 'active'
    GROUP BY category_id
    HAVING COUNT(*) >= 5  -- è‡³å°‘5ä¸ªäº§å“çš„ç±»åˆ«
),
-- ç¬¬2æ­¥ï¼šæ·»åŠ ç±»åˆ«åç§°ä¿¡æ¯
category_with_names AS (
    SELECT 
        c.name as category_name,
        acs.product_count,
        acs.avg_price
    FROM active_category_stats acs
    JOIN categories c ON acs.category_id = c.id
),
-- ç¬¬3æ­¥ï¼šæŒ‰å¹³å‡ä»·æ ¼æ’å
ranked_categories AS (
    SELECT 
        *,
        ROW_NUMBER() OVER (ORDER BY avg_price DESC) as price_rank
    FROM category_with_names
)
-- ç¬¬4æ­¥ï¼šè·å–å‰10å
SELECT 
    category_name as å•†å“ç±»åˆ«,
    product_count as äº§å“æ•°é‡,
    ROUND(avg_price, 2) as å¹³å‡ä»·æ ¼,
    price_rank as ä»·æ ¼æ’å
FROM ranked_categories
WHERE price_rank <= 10;
```

**ğŸ¨ å¯è¯»æ€§æå‡æ•ˆæœ**
```
æ”¹è¿›æ•ˆæœå¯¹æ¯”ï¼š

ç†è§£éš¾åº¦ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼ˆéœ€è¦é€†å‘åˆ†æï¼‰
CTEæ–¹å¼ï¼šâ˜…â˜…â˜†â˜†â˜†ï¼ˆé¡ºåºé˜…è¯»å³å¯ï¼‰

ç»´æŠ¤æˆæœ¬ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šä¿®æ”¹é€»è¾‘éœ€è¦é‡å†™å¤§æ®µä»£ç 
CTEæ–¹å¼ï¼šä¿®æ”¹æŸä¸ªæ­¥éª¤åªéœ€è°ƒæ•´å¯¹åº”CTE

è°ƒè¯•æ•ˆç‡ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šé”™è¯¯å®šä½å›°éš¾ï¼Œéœ€è¦æ‹†è§£æ•´ä¸ªæŸ¥è¯¢
CTEæ–¹å¼ï¼šå¯ä»¥é€ä¸ªCTEæµ‹è¯•ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
```

---

## 3. ğŸ”§ CTEä¸å…¶ä»–æŠ€æœ¯å¯¹æ¯”


### 3.1 CTE vs è§†å›¾(View)


**ğŸ“Š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”**

| å¯¹æ¯”ç»´åº¦ | **CTE** | **è§†å›¾(View)** |
|---------|---------|----------------|
| **ç”Ÿå‘½å‘¨æœŸ** | `æŸ¥è¯¢æœŸé—´ä¸´æ—¶å­˜åœ¨` | `æ°¸ä¹…å­˜å‚¨åœ¨æ•°æ®åº“ä¸­` |
| **ä½œç”¨èŒƒå›´** | `å½“å‰æŸ¥è¯¢è¯­å¥å†…` | `æ•´ä¸ªæ•°æ®åº“å†…éƒ½å¯ç”¨` |
| **å­˜å‚¨æ–¹å¼** | `ä¸å ç”¨å­˜å‚¨ç©ºé—´` | `å®šä¹‰å­˜å‚¨åœ¨æ•°æ®å­—å…¸ä¸­` |
| **å‚æ•°åŒ–** | `å¯ä»¥åœ¨æŸ¥è¯¢ä¸­åŠ¨æ€æ„å»º` | `é™æ€å®šä¹‰ï¼Œä¸æ”¯æŒå‚æ•°` |
| **æ€§èƒ½å½±å“** | `æŸ¥è¯¢æ—¶æ‰è®¡ç®—` | `æ¯æ¬¡è®¿é—®éƒ½é‡æ–°è®¡ç®—` |
| **æƒé™ç®¡ç†** | `ç»§æ‰¿åŸºè¡¨æƒé™` | `å¯ä»¥å•ç‹¬è®¾ç½®æƒé™` |

**ğŸ¯ ä½¿ç”¨åœºæ™¯å¯¹æ¯”**
```
é€‰æ‹©CTEçš„æƒ…å†µï¼š
âœ… åªåœ¨å½“å‰æŸ¥è¯¢ä¸­ä½¿ç”¨
âœ… é€»è¾‘å¤æ‚éœ€è¦åˆ†æ­¥éª¤å¤„ç†
âœ… éœ€è¦å¤šæ¬¡å¼•ç”¨ä¸­é—´ç»“æœ
âœ… ä¸´æ—¶æ€§çš„æ•°æ®åˆ†æ

é€‰æ‹©è§†å›¾çš„æƒ…å†µï¼š
âœ… å¤šä¸ªæŸ¥è¯¢éƒ½éœ€è¦ç›¸åŒçš„æ•°æ®é€»è¾‘
âœ… éœ€è¦æƒé™æ§åˆ¶å’Œå®‰å…¨éš”ç¦»
âœ… ç®€åŒ–å¤æ‚è¡¨ç»“æ„çš„å¯¹å¤–æ¥å£
âœ… æ•°æ®æŠ½è±¡å’Œé€»è¾‘å¤ç”¨
```

### 3.2 CTE vs å­æŸ¥è¯¢


**ğŸ” è¯¦ç»†å¯¹æ¯”åˆ†æ**

**å­æŸ¥è¯¢æ–¹å¼**ï¼š
```sql
-- ä½¿ç”¨å­æŸ¥è¯¢çš„å¤æ‚ç»Ÿè®¡
SELECT 
    d.dept_name,
    d.avg_salary,
    CASE 
        WHEN d.avg_salary > (SELECT AVG(salary) FROM employees) 
        THEN 'é«˜äºå¹³å‡'
        ELSE 'ä½äºå¹³å‡'
    END as salary_level
FROM (
    SELECT 
        dept_id,
        AVG(salary) as avg_salary
    FROM employees
    GROUP BY dept_id
) dept_avg
JOIN departments d ON dept_avg.dept_id = d.id;
```

**CTEæ–¹å¼**ï¼š
```sql
-- ä½¿ç”¨CTEçš„ç›¸åŒé€»è¾‘
WITH 
-- è®¡ç®—æ•´ä½“å¹³å‡è–ªèµ„
company_avg AS (
    SELECT AVG(salary) as avg_salary 
    FROM employees
),
-- è®¡ç®—å„éƒ¨é—¨å¹³å‡è–ªèµ„
dept_avg AS (
    SELECT 
        dept_id,
        AVG(salary) as avg_salary
    FROM employees
    GROUP BY dept_id
)
-- ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
SELECT 
    d.dept_name,
    da.avg_salary,
    CASE 
        WHEN da.avg_salary > ca.avg_salary 
        THEN 'é«˜äºå¹³å‡'
        ELSE 'ä½äºå¹³å‡'
    END as salary_level
FROM dept_avg da
JOIN departments d ON da.dept_id = d.id
CROSS JOIN company_avg ca;
```

**ğŸš€ ä¼˜åŠ¿åˆ†æ**
```
å¯è¯»æ€§ï¼š
å­æŸ¥è¯¢ï¼šé€»è¾‘åµŒå¥—ï¼Œéœ€è¦ä»å†…å‘å¤–ç†è§£
CTEï¼š   é€»è¾‘é¡ºåºï¼ŒæŒ‰æ­¥éª¤ä¾æ¬¡é˜…è¯»

æ€§èƒ½ï¼š
å­æŸ¥è¯¢ï¼šå¯èƒ½é‡å¤æ‰§è¡Œç›¸åŒé€»è¾‘
CTEï¼š   ä¸­é—´ç»“æœå¯ä»¥é‡å¤å¼•ç”¨

ç»´æŠ¤æ€§ï¼š
å­æŸ¥è¯¢ï¼šä¿®æ”¹é€»è¾‘éœ€è¦æ‰¾åˆ°åµŒå¥—ä½ç½®
CTEï¼š   æ¯ä¸ªéƒ¨åˆ†ç‹¬ç«‹ï¼Œä¿®æ”¹æ›´å®¹æ˜“
```

### 3.3 CTE vs ä¸´æ—¶è¡¨


**ğŸ—ƒï¸ æŠ€æœ¯å¯¹æ¯”**

**ä¸´æ—¶è¡¨æ–¹å¼**ï¼š
```sql
-- åˆ›å»ºä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_sales_analysis (
    region VARCHAR(50),
    total_sales DECIMAL(10,2),
    order_count INT
);

-- æ’å…¥æ•°æ®
INSERT INTO temp_sales_analysis
SELECT region, SUM(amount), COUNT(*)
FROM sales
GROUP BY region;

-- ä½¿ç”¨ä¸´æ—¶è¡¨
SELECT * FROM temp_sales_analysis 
WHERE total_sales > 10000;

-- æ¸…ç†ä¸´æ—¶è¡¨
DROP TEMPORARY TABLE temp_sales_analysis;
```

**CTEæ–¹å¼**ï¼š
```sql
-- ä¸€ä¸ªæŸ¥è¯¢å®Œæˆç›¸åŒåŠŸèƒ½
WITH sales_analysis AS (
    SELECT 
        region,
        SUM(amount) as total_sales,
        COUNT(*) as order_count
    FROM sales
    GROUP BY region
)
SELECT * FROM sales_analysis 
WHERE total_sales > 10000;
```

**âš–ï¸ é€‰æ‹©æŒ‡å¯¼**
```
é€‰æ‹©ä¸´æ—¶è¡¨çš„æƒ…å†µï¼š
âœ… éœ€è¦åˆ›å»ºç´¢å¼•æå‡æ€§èƒ½
âœ… æ•°æ®é‡å¾ˆå¤§ï¼Œéœ€è¦å¤šæ¬¡è®¿é—®
âœ… éœ€è¦åœ¨å¤šä¸ªæŸ¥è¯¢é—´å…±äº«
âœ… éœ€è¦è¿›è¡ŒDMLæ“ä½œï¼ˆINSERTã€UPDATEï¼‰

é€‰æ‹©CTEçš„æƒ…å†µï¼š
âœ… ä¸€æ¬¡æ€§ä½¿ç”¨çš„ä¸­é—´ç»“æœ
âœ… é€»è¾‘åˆ†è§£å’Œå¯è¯»æ€§ä¼˜å…ˆ
âœ… ä¸éœ€è¦ç´¢å¼•å’Œç‰©ç†å­˜å‚¨
âœ… ç®€å•çš„æ•°æ®æŸ¥è¯¢å’Œåˆ†æ
```

---

## 4. ğŸ¯ CTEæŸ¥è¯¢è®¾è®¡åŸåˆ™


### 4.1 ç»“æ„åŒ–è®¾è®¡åŸåˆ™


**ğŸ—ï¸ åˆ†å±‚è®¾è®¡æ€æƒ³**

```
CTEè®¾è®¡çš„"é‡‘å­—å¡”åŸç†"ï¼š

åŸºç¡€æ•°æ®å±‚(åº•å±‚CTE)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®æ¸…æ´—ã€è¿‡æ»¤ã€åŸºç¡€è®¡ç®— â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â¬†
ä¸šåŠ¡é€»è¾‘å±‚(ä¸­å±‚CTE)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡è§„åˆ™ã€èšåˆç»Ÿè®¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â¬†
è¡¨ç°å±‚(ä¸»æŸ¥è¯¢)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¼å¼åŒ–ã€æ’åºã€æœ€ç»ˆè¾“å‡º  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”‘ è®¾è®¡åŸåˆ™**
```
1. å•ä¸€èŒè´£åŸåˆ™ï¼š
   æ¯ä¸ªCTEåªè§£å†³ä¸€ä¸ªæ˜ç¡®çš„é—®é¢˜
   
2. é€å±‚æŠ½è±¡åŸåˆ™ï¼š
   åº•å±‚CTEå¤„ç†åŸºç¡€æ•°æ®
   ä¸Šå±‚CTEå¤„ç†ä¸šåŠ¡é€»è¾‘
   
3. å‘½åæ¸…æ™°åŸåˆ™ï¼š
   CTEåç§°è¦ä½“ç°å…¶åŠŸèƒ½
   å¦‚ï¼šfiltered_orders, monthly_stats
   
4. é€»è¾‘ç‹¬ç«‹åŸåˆ™ï¼š
   æ¯ä¸ªCTEåº”è¯¥å°½å¯èƒ½ç‹¬ç«‹
   é¿å…è¿‡åº¦è€¦åˆ
```

### 4.2 å‘½åè§„èŒƒä¸æœ€ä½³å®è·µ


**ğŸ“ CTEå‘½åè§„èŒƒ**
```sql
-- âœ… å¥½çš„å‘½åç¤ºä¾‹
WITH 
active_users AS (...),           -- æ¸…æ™°è¡¨æ˜æ˜¯æ´»è·ƒç”¨æˆ·
monthly_sales_summary AS (...),  -- è¡¨æ˜æ—¶é—´èŒƒå›´å’Œå†…å®¹
high_value_customers AS (...),   -- è¡¨æ˜æ˜¯é«˜ä»·å€¼å®¢æˆ·
region_performance_ranks AS (...) -- è¡¨æ˜æ˜¯åœ°åŒºç»©æ•ˆæ’å

-- âŒ ä¸å¥½çš„å‘½åç¤ºä¾‹  
WITH 
temp1 AS (...),     -- æ²¡æœ‰æ„ä¹‰çš„åç§°
data AS (...),      -- è¿‡äºæ³›åŒ–
result AS (...),    -- ä¸çŸ¥é“æ˜¯ä»€ä¹ˆç»“æœ
t AS (...)          -- è¿‡äºç®€åŒ–
```

**ğŸ¨ æœ€ä½³å®è·µ**
```
å‘½åæŠ€å·§ï¼š
â€¢ ä½¿ç”¨åŠ¨è¯+åè¯ï¼šfiltered_products, calculated_totals
â€¢ ä½“ç°æ—¶é—´èŒƒå›´ï¼šcurrent_month_data, last_year_summary  
â€¢ ä½“ç°ä¸šåŠ¡å«ä¹‰ï¼šeligible_customers, qualified_orders
â€¢ ä¿æŒä¸€è‡´æ€§ï¼šåŒç±»CTEä½¿ç”¨ç›¸ä¼¼å‘½åæ¨¡å¼

ä»£ç ç»„ç»‡ï¼š
â€¢ ç›¸å…³CTEæ”¾åœ¨ä¸€èµ·
â€¢ å¤æ‚CTEå†…éƒ¨é€‚å½“æ·»åŠ æ³¨é‡Š
â€¢ ä¿æŒç¼©è¿›å’Œæ ¼å¼ä¸€è‡´
â€¢ åœ¨CTEä¹‹é—´æ·»åŠ ç©ºè¡Œåˆ†éš”
```

### 4.3 CTEé‡å¤å¼•ç”¨ä¼˜åŒ–


**â™»ï¸ å¤šæ¬¡å¼•ç”¨çš„ä»·å€¼**

```sql
-- åœºæ™¯ï¼šéœ€è¦åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨ç›¸åŒçš„ä¸­é—´ç»“æœ
WITH 
-- å®šä¹‰ä¸€æ¬¡ï¼Œå¤šå¤„ä½¿ç”¨
valid_orders AS (
    SELECT 
        order_id,
        customer_id,
        amount,
        order_date
    FROM orders
    WHERE status = 'completed'
      AND amount > 0
      AND order_date >= '2024-01-01'
)
SELECT 
    'æ€»è®¢å•æ•°' as æŒ‡æ ‡,
    COUNT(*) as æ•°å€¼
FROM valid_orders

UNION ALL

SELECT 
    'æ€»é”€å”®é¢' as æŒ‡æ ‡,
    SUM(amount) as æ•°å€¼
FROM valid_orders

UNION ALL

SELECT 
    'å¹³å‡è®¢å•é¢' as æŒ‡æ ‡,
    AVG(amount) as æ•°å€¼
FROM valid_orders

UNION ALL

SELECT 
    'æ´»è·ƒå®¢æˆ·æ•°' as æŒ‡æ ‡,
    COUNT(DISTINCT customer_id) as æ•°å€¼
FROM valid_orders;
```

**ğŸ”„ é‡å¤å¼•ç”¨çš„å¥½å¤„**
```
æ€§èƒ½ä¼˜åŠ¿ï¼š
â€¢ é¿å…é‡å¤æ‰§è¡Œç›¸åŒçš„è¿‡æ»¤å’Œè®¡ç®—é€»è¾‘
â€¢ æ•°æ®åº“ä¼˜åŒ–å™¨å¯ä»¥ç¼“å­˜CTEç»“æœ
â€¢ å‡å°‘è¡¨çš„é‡å¤æ‰«æ

ç»´æŠ¤ä¼˜åŠ¿ï¼š
â€¢ ä¿®æ”¹è¿‡æ»¤æ¡ä»¶åªéœ€æ”¹CTEå®šä¹‰
â€¢ ä¿è¯æ‰€æœ‰å¼•ç”¨ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ ‡å‡†
â€¢ é™ä½é€»è¾‘ä¸ä¸€è‡´çš„é£é™©

ä»£ç è´¨é‡ï¼š
â€¢ DRYåŸåˆ™ï¼ˆDon't Repeat Yourselfï¼‰
â€¢ é€»è¾‘é›†ä¸­ç®¡ç†
â€¢ æé«˜ä»£ç å¤ç”¨æ€§
```

---

## 5. ğŸª å®é™…åº”ç”¨åœºæ™¯æ·±å…¥


### 5.1 æ•°æ®åˆ†ææŠ¥è¡¨åœºæ™¯


**ğŸ“Š åœºæ™¯ï¼šç”µå•†å¹³å°æœˆåº¦è¿è¥æŠ¥è¡¨**

```sql
-- å¤æ‚çš„æœˆåº¦åˆ†ææŠ¥è¡¨
WITH 
-- åŸºç¡€æ•°æ®è¿‡æ»¤
base_orders AS (
    SELECT 
        o.order_id,
        o.customer_id,
        o.amount,
        o.order_date,
        c.region,
        c.customer_type
    FROM orders o
    JOIN customers c ON o.customer_id = c.id
    WHERE o.order_date >= DATE_SUB(CURRENT_DATE, INTERVAL 1 MONTH)
      AND o.status = 'completed'
),
-- åœ°åŒºé”€å”®ç»Ÿè®¡
region_stats AS (
    SELECT 
        region,
        COUNT(*) as order_count,
        SUM(amount) as total_sales,
        AVG(amount) as avg_order_value,
        COUNT(DISTINCT customer_id) as unique_customers
    FROM base_orders
    GROUP BY region
),
-- å®¢æˆ·ç±»å‹åˆ†æ
customer_type_stats AS (
    SELECT 
        customer_type,
        COUNT(*) as order_count,
        SUM(amount) as total_sales
    FROM base_orders
    GROUP BY customer_type
),
-- æ•´ä½“ä¸šç»©æŒ‡æ ‡
overall_metrics AS (
    SELECT 
        COUNT(*) as total_orders,
        SUM(amount) as total_revenue,
        AVG(amount) as avg_order_value,
        COUNT(DISTINCT customer_id) as active_customers
    FROM base_orders
)
-- ç”Ÿæˆç»¼åˆæŠ¥è¡¨
SELECT 
    'åœ°åŒºåˆ†æ' as æŠ¥è¡¨ç±»å‹,
    region as ç»´åº¦,
    order_count as è®¢å•æ•°,
    total_sales as é”€å”®é¢,
    unique_customers as å®¢æˆ·æ•°
FROM region_stats

UNION ALL

SELECT 
    'å®¢æˆ·ç±»å‹åˆ†æ' as æŠ¥è¡¨ç±»å‹,
    customer_type as ç»´åº¦,
    order_count as è®¢å•æ•°,
    total_sales as é”€å”®é¢,
    NULL as å®¢æˆ·æ•°
FROM customer_type_stats

UNION ALL

SELECT 
    'æ•´ä½“æŒ‡æ ‡' as æŠ¥è¡¨ç±»å‹,
    'å…¨å¹³å°' as ç»´åº¦,
    total_orders as è®¢å•æ•°,
    total_revenue as é”€å”®é¢,
    active_customers as å®¢æˆ·æ•°
FROM overall_metrics

ORDER BY æŠ¥è¡¨ç±»å‹, é”€å”®é¢ DESC;
```

**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**
```
åˆ†æç»´åº¦ä¸°å¯Œï¼š
â€¢ åœ°åŒºç»´åº¦ï¼šå“ªä¸ªåœ°åŒºä¸šç»©æœ€å¥½
â€¢ å®¢æˆ·ç»´åº¦ï¼šå“ªç±»å®¢æˆ·è´¡çŒ®æœ€å¤§
â€¢ æ•´ä½“æŒ‡æ ‡ï¼šå¹³å°æ•´ä½“è¿è¥çŠ¶å†µ

å†³ç­–æ”¯æŒï¼š
â€¢ èµ„æºæŠ•å…¥ï¼šå‘é«˜äº§å‡ºåœ°åŒºå€¾æ–œèµ„æº
â€¢ è¥é”€ç­–ç•¥ï¼šé’ˆå¯¹é«˜ä»·å€¼å®¢æˆ·ç¾¤ä½“
â€¢ è¿è¥ä¼˜åŒ–ï¼šåŸºäºæ•°æ®è°ƒæ•´ç­–ç•¥
```

### 5.2 æ•°æ®æ¸…æ´—ä¸é¢„å¤„ç†åœºæ™¯


**ğŸ§¹ åœºæ™¯ï¼šé”€å”®æ•°æ®è´¨é‡åˆ†æ**

```sql
-- æ•°æ®è´¨é‡æ£€æŸ¥å’Œæ¸…æ´—
WITH 
-- ç¬¬1æ­¥ï¼šè¯†åˆ«æ•°æ®è´¨é‡é—®é¢˜
data_quality_check AS (
    SELECT 
        order_id,
        customer_id,
        amount,
        order_date,
        CASE 
            WHEN customer_id IS NULL THEN 'missing_customer'
            WHEN amount <= 0 THEN 'invalid_amount' 
            WHEN order_date > CURRENT_DATE THEN 'future_date'
            WHEN order_date < '2020-01-01' THEN 'too_old'
            ELSE 'valid'
        END as data_status
    FROM raw_orders
),
-- ç¬¬2æ­¥ï¼šç»Ÿè®¡æ•°æ®è´¨é‡æƒ…å†µ
quality_summary AS (
    SELECT 
        data_status,
        COUNT(*) as record_count,
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
    FROM data_quality_check
    GROUP BY data_status
),
-- ç¬¬3æ­¥ï¼šæå–æœ‰æ•ˆæ•°æ®
clean_data AS (
    SELECT *
    FROM data_quality_check
    WHERE data_status = 'valid'
),
-- ç¬¬4æ­¥ï¼šè¿›è¡Œä¸šåŠ¡åˆ†æ
business_analysis AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') as month,
        COUNT(*) as order_count,
        SUM(amount) as total_sales,
        COUNT(DISTINCT customer_id) as unique_customers
    FROM clean_data
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
)
-- è¾“å‡ºæ•°æ®è´¨é‡æŠ¥å‘Šå’Œä¸šåŠ¡åˆ†æ
SELECT 
    'Data Quality Report' as report_type,
    data_status as metric,
    record_count as value,
    CONCAT(percentage, '%') as percentage
FROM quality_summary

UNION ALL

SELECT 
    'Business Analysis' as report_type,
    month as metric,
    total_sales as value,
    CONCAT(order_count, ' orders') as percentage
FROM business_analysis

ORDER BY report_type, value DESC;
```

**ğŸ¨ æ•°æ®å¤„ç†æµç¨‹**
```
æ•°æ®å¤„ç†ç®¡é“ï¼š
åŸå§‹æ•°æ® â†’ è´¨é‡æ£€æŸ¥ â†’ é—®é¢˜æ ‡è¯† â†’ æ¸…æ´—è¿‡æ»¤ â†’ ä¸šåŠ¡åˆ†æ
   â¬‡         â¬‡         â¬‡         â¬‡         â¬‡
raw_orders â†’ data_quality_check â†’ quality_summary â†’ clean_data â†’ business_analysis
```

### 5.3 å¤æ‚ä¸šåŠ¡é€»è¾‘å¤„ç†åœºæ™¯


**ğŸ¯ åœºæ™¯ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ**

```sql
-- ç”¨æˆ·è´­ä¹°è¡Œä¸ºæ·±åº¦åˆ†æ
WITH 
-- ç”¨æˆ·åŸºç¡€è´­ä¹°ç»Ÿè®¡
user_purchase_basic AS (
    SELECT 
        customer_id,
        COUNT(*) as total_orders,
        SUM(amount) as total_spent,
        MIN(order_date) as first_purchase,
        MAX(order_date) as last_purchase,
        AVG(amount) as avg_order_value
    FROM orders
    WHERE status = 'completed'
    GROUP BY customer_id
),
-- ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸè®¡ç®—
user_lifecycle AS (
    SELECT 
        *,
        DATEDIFF(last_purchase, first_purchase) as customer_lifespan_days,
        DATEDIFF(CURRENT_DATE, last_purchase) as days_since_last_order
    FROM user_purchase_basic
),
-- ç”¨æˆ·ä»·å€¼åˆ†çº§
user_segments AS (
    SELECT 
        *,
        CASE 
            WHEN total_spent >= 5000 AND days_since_last_order <= 30 
            THEN 'ğŸ† VIPæ´»è·ƒç”¨æˆ·'
            WHEN total_spent >= 2000 AND days_since_last_order <= 90 
            THEN 'ğŸ’ é«˜ä»·å€¼ç”¨æˆ·'
            WHEN total_orders >= 10 AND days_since_last_order <= 180 
            THEN 'ğŸ”„ å¿ å®ç”¨æˆ·'
            WHEN days_since_last_order > 365 
            THEN 'ğŸ˜´ æµå¤±ç”¨æˆ·'
            ELSE 'ğŸ†• æ™®é€šç”¨æˆ·'
        END as user_segment
    FROM user_lifecycle
),
-- åˆ†æ®µç»Ÿè®¡åˆ†æ
segment_analysis AS (
    SELECT 
        user_segment,
        COUNT(*) as user_count,
        AVG(total_spent) as avg_lifetime_value,
        AVG(total_orders) as avg_order_frequency,
        AVG(customer_lifespan_days) as avg_lifespan
    FROM user_segments
    GROUP BY user_segment
)
-- ç”Ÿæˆç”¨æˆ·ç”»åƒæŠ¥å‘Š
SELECT 
    user_segment as ç”¨æˆ·ç±»å‹,
    user_count as ç”¨æˆ·æ•°é‡,
    ROUND(avg_lifetime_value, 2) as å¹³å‡æ¶ˆè´¹é¢,
    ROUND(avg_order_frequency, 1) as å¹³å‡è®¢å•æ•°,
    ROUND(avg_lifespan / 30.0, 1) as å¹³å‡ç”Ÿå‘½å‘¨æœŸæœˆæ•°,
    ROUND(user_count * 100.0 / SUM(user_count) OVER(), 2) as å æ¯”
FROM segment_analysis
ORDER BY avg_lifetime_value DESC;
```

**ğŸ­ ä¸šåŠ¡é€»è¾‘åˆ†è§£**
```
åˆ†ææ€è·¯ï¼š
ğŸ”¸ ç¬¬1å±‚ï¼šåŸºç¡€æ•°æ®èšåˆï¼ˆè´­ä¹°é¢‘æ¬¡ã€é‡‘é¢ã€æ—¶é—´ï¼‰
ğŸ”¸ ç¬¬2å±‚ï¼šæ—¶é—´è®¡ç®—ï¼ˆç”Ÿå‘½å‘¨æœŸã€æ´»è·ƒåº¦ï¼‰
ğŸ”¸ ç¬¬3å±‚ï¼šä¸šåŠ¡åˆ†çº§ï¼ˆæ ¹æ®ä»·å€¼å’Œæ´»è·ƒåº¦åˆ†ç±»ï¼‰
ğŸ”¸ ç¬¬4å±‚ï¼šç»Ÿè®¡åˆ†æï¼ˆå„ç±»ç”¨æˆ·çš„ç‰¹å¾ï¼‰
ğŸ”¸ ç¬¬5å±‚ï¼šæŠ¥è¡¨è¾“å‡ºï¼ˆç®¡ç†å±‚éœ€è¦çš„ä¿¡æ¯ï¼‰

ä»·å€¼ä½“ç°ï¼š
â€¢ å®¢æˆ·ç»†åˆ†ï¼šç²¾å‡†è¯†åˆ«ä¸åŒä»·å€¼çš„ç”¨æˆ·ç¾¤ä½“
â€¢ è¥é”€ç­–ç•¥ï¼šé’ˆå¯¹æ€§çš„ç”¨æˆ·è¿è¥ç­–ç•¥
â€¢ æµå¤±é¢„è­¦ï¼šåŠæ—¶å‘ç°å¯èƒ½æµå¤±çš„ç”¨æˆ·
â€¢ ä»·å€¼æŒ–æ˜ï¼šå‘ç°é«˜æ½œåŠ›å®¢æˆ·
```

---

## 6. ğŸ” CTEæ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹


### 6.1 CTEæ€§èƒ½ç‰¹ç‚¹


**âš¡ æ€§èƒ½æœºåˆ¶ç†è§£**

```
CTEæ‰§è¡Œæ–¹å¼ï¼š
â”Œâ”€ æ•°æ®åº“ä¼˜åŒ–å™¨è§†è§’ â”€â”€â”
â”‚ CTE â‰ˆ å†…è”å­æŸ¥è¯¢    â”‚
â”‚ ä¸æ˜¯ç‰©ç†ä¸´æ—¶è¡¨      â”‚
â”‚ æŒ‰éœ€è®¡ç®—å’Œç¼“å­˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œè®¡åˆ’ï¼š
WITH my_cte AS (SELECT ...)
SELECT * FROM my_cte;

ç­‰ä»·äºï¼š
SELECT * FROM (SELECT ...) AS my_cte;
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æŒ‡å¯¼**
```
âœ… CTEæ€§èƒ½ä¼˜åŠ¿åœºæ™¯ï¼š
â€¢ é¿å…é‡å¤å­æŸ¥è¯¢
â€¢ å¤æ‚é€»è¾‘åˆ†è§£åä¼˜åŒ–å™¨æ›´å®¹æ˜“å¤„ç†
â€¢ ä¸­é—´ç»“æœå¯ä»¥è¢«é‡å¤å¼•ç”¨

âš ï¸ éœ€è¦æ³¨æ„çš„æ€§èƒ½é—®é¢˜ï¼š
â€¢ å¤§æ•°æ®é‡çš„CTEå¯èƒ½å½±å“æ€§èƒ½
â€¢ æŸäº›æ•°æ®åº“CTEä¸æ”¯æŒç´¢å¼•
â€¢ å¤æ‚CTEå¯èƒ½é˜»ç¢ä¼˜åŒ–å™¨ä¼˜åŒ–
```

### 6.2 ä½¿ç”¨æ³¨æ„äº‹é¡¹


**ğŸš¨ å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ**

```sql
-- âŒ é”™è¯¯ï¼šCTEå®šä¹‰ä½†æœªä½¿ç”¨
WITH unused_cte AS (
    SELECT * FROM orders
)
SELECT * FROM customers;  -- æ²¡æœ‰ä½¿ç”¨CTE

-- âœ… æ­£ç¡®ï¼šå®šä¹‰çš„CTEå¿…é¡»è¢«ä½¿ç”¨
WITH order_summary AS (
    SELECT customer_id, SUM(amount) as total
    FROM orders
    GROUP BY customer_id
)
SELECT c.name, os.total
FROM customers c
LEFT JOIN order_summary os ON c.id = os.customer_id;
```

**ğŸ”§ æœ€ä½³å®è·µ**
```
å¼€å‘å»ºè®®ï¼š
1. å…ˆå†™ç®€å•ç‰ˆæœ¬ï¼Œé€æ­¥ä¼˜åŒ–
2. æ¯ä¸ªCTEå•ç‹¬æµ‹è¯•éªŒè¯
3. å¤æ‚CTEæ·»åŠ æ³¨é‡Šè¯´æ˜
4. æ³¨æ„CTEçš„ä½œç”¨åŸŸé™åˆ¶

è°ƒè¯•æŠ€å·§ï¼š
1. å•ç‹¬æ‰§è¡Œæ¯ä¸ªCTEæ£€æŸ¥ç»“æœ
2. ä»ç®€å•CTEå¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¤æ‚åº¦
3. ä½¿ç”¨EXPLAINæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
4. å¯¹æ¯”CTEå’Œä¼ ç»Ÿå†™æ³•çš„æ€§èƒ½
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CTEæœ¬è´¨ï¼šä¸´æ—¶å‘½åçš„ç»“æœé›†ï¼Œè®©å¤æ‚æŸ¥è¯¢ç»“æ„åŒ–
ğŸ”¸ WITHè¯­æ³•ï¼šå®šä¹‰CTEçš„æ ‡å‡†è¯­æ³•ï¼Œæ”¯æŒå¤šä¸ªCTEé“¾å¼å®šä¹‰
ğŸ”¸ ä½œç”¨åŸŸï¼šåªåœ¨å½“å‰æŸ¥è¯¢ä¸­æœ‰æ•ˆï¼ŒæŸ¥è¯¢ç»“æŸå³æ¶ˆå¤±
ğŸ”¸ å¯é‡å¤å¼•ç”¨ï¼šä¸€æ¬¡å®šä¹‰ï¼Œå¤šå¤„ä½¿ç”¨ï¼Œæé«˜æ•ˆç‡
ğŸ”¸ åˆ—åå®šä¹‰ï¼šæ”¯æŒä¸¤ç§æ–¹å¼ï¼Œæ¨èåœ¨SELECTä¸­å®šä¹‰
```

### 7.2 å…³é”®åº”ç”¨ä»·å€¼


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
å¯è¯»æ€§é—®é¢˜ï¼š
ä¼ ç»Ÿæ–¹æ³•ï¼šå¤æ‚åµŒå¥—ï¼Œéš¾ä»¥ç†è§£
CTEæ–¹æ³•ï¼šåˆ†æ­¥éª¤ï¼Œé€»è¾‘æ¸…æ™°

ç»´æŠ¤æ€§é—®é¢˜ï¼š
ä¼ ç»Ÿæ–¹æ³•ï¼šä¿®æ”¹ä¸€å¤„å½±å“å…¨å±€
CTEæ–¹æ³•ï¼šæ¨¡å—åŒ–ä¿®æ”¹ï¼Œå½±å“å±€éƒ¨

å¤ç”¨æ€§é—®é¢˜ï¼š
ä¼ ç»Ÿæ–¹æ³•ï¼šé‡å¤é€»è¾‘éœ€è¦é‡å†™
CTEæ–¹æ³•ï¼šå®šä¹‰ä¸€æ¬¡ï¼Œå¤šå¤„å¼•ç”¨
```

**ğŸ’¡ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… é€‚åˆä½¿ç”¨CTEï¼š
â€¢ æŸ¥è¯¢é€»è¾‘å¤æ‚ï¼ŒåµŒå¥—å±‚æ¬¡å¤š
â€¢ éœ€è¦å¤šæ¬¡å¼•ç”¨ç›¸åŒçš„ä¸­é—´ç»“æœ
â€¢ å›¢é˜Ÿåˆä½œï¼Œéœ€è¦æé«˜ä»£ç å¯è¯»æ€§
â€¢ å¤æ‚æŠ¥è¡¨å’Œæ•°æ®åˆ†æ

âŒ ä¸é€‚åˆä½¿ç”¨CTEï¼š
â€¢ ç®€å•çš„å•è¡¨æŸ¥è¯¢
â€¢ æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
â€¢ éœ€è¦åˆ›å»ºç´¢å¼•çš„ä¸´æ—¶æ•°æ®
â€¢ éœ€è¦è·¨æŸ¥è¯¢å…±äº«çš„ä¸´æ—¶ç»“æœ
```

### 7.3 ä¸å…¶ä»–æŠ€æœ¯çš„é€‰æ‹©æŒ‡å¯¼


**ğŸ”€ æŠ€æœ¯é€‰æ‹©å†³ç­–æ ‘**
```
éœ€è¦ä¸´æ—¶ç»“æœï¼Ÿ
â”œâ”€ æ˜¯ â†’ åªåœ¨å½“å‰æŸ¥è¯¢ä½¿ç”¨ï¼Ÿ
â”‚       â”œâ”€ æ˜¯ â†’ ä½¿ç”¨CTE âœ…
â”‚       â””â”€ å¦ â†’ è€ƒè™‘è§†å›¾æˆ–ä¸´æ—¶è¡¨
â””â”€ å¦ â†’ ç›´æ¥å†™å­æŸ¥è¯¢
```

**ğŸ“Š å¯¹æ¯”è®°å¿†è¡¨**
| ä½¿ç”¨åœºæ™¯ | **CTE** | **å­æŸ¥è¯¢** | **è§†å›¾** | **ä¸´æ—¶è¡¨** |
|---------|---------|-----------|----------|-----------|
| **ä¸€æ¬¡æ€§å¤æ‚æŸ¥è¯¢** | `âœ…æœ€ä½³` | `å¯ä»¥ï¼Œä½†ä¸å¤Ÿæ¸…æ™°` | `è¿‡åº¦è®¾è®¡` | `è¿‡åº¦è®¾è®¡` |
| **é€»è¾‘åˆ†è§£** | `âœ…æœ€ä½³` | `åµŒå¥—å¤æ‚` | `ä¸é€‚åˆ` | `ä¸é€‚åˆ` |
| **é‡å¤å¼•ç”¨** | `âœ…æœ€ä½³` | `é‡å¤æ‰§è¡Œä½æ•ˆ` | `å¦‚æœæ°¸ä¹…éœ€è¦å¯è€ƒè™‘` | `å¦‚æœæ•°æ®é‡å¤§å¯è€ƒè™‘` |
| **è·¨æŸ¥è¯¢å…±äº«** | `âŒä¸æ”¯æŒ` | `âŒä¸æ”¯æŒ` | `âœ…æ”¯æŒ` | `âœ…æ”¯æŒ` |

### 7.4 å­¦ä¹ å»ºè®®ä¸å®è·µè¦ç‚¹


**ğŸ“ å­¦ä¹ è·¯å¾„**
```
å…¥é—¨é˜¶æ®µï¼š
1. æŒæ¡åŸºæœ¬WITHè¯­æ³•
2. ç»ƒä¹ ç®€å•çš„CTEåˆ†è§£
3. ç†è§£CTEä¸å­æŸ¥è¯¢çš„åŒºåˆ«

è¿›é˜¶é˜¶æ®µï¼š
1. å¤šCTEé“¾å¼ä½¿ç”¨
2. å¤æ‚ä¸šåŠ¡é€»è¾‘åˆ†è§£
3. æ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ

é«˜çº§é˜¶æ®µï¼š
1. ç»“åˆçª—å£å‡½æ•°ä½¿ç”¨
2. å¤æ‚æ•°æ®åˆ†æåœºæ™¯
3. ä¸é€’å½’CTEçš„åŒºåˆ«å’Œåº”ç”¨
```

**ğŸ§ª åŠ¨æ‰‹ç»ƒä¹ å»ºè®®**
```
ç»ƒä¹ 1ï¼šå°†åµŒå¥—å­æŸ¥è¯¢æ”¹å†™ä¸ºCTE
ç»ƒä¹ 2ï¼šè®¾è®¡ä¸€ä¸ªå¤šæ­¥éª¤çš„æ•°æ®åˆ†ææŸ¥è¯¢
ç»ƒä¹ 3ï¼šæ¯”è¾ƒCTEå’Œå…¶ä»–æ–¹æ³•çš„æ€§èƒ½å·®å¼‚
ç»ƒä¹ 4ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨CTEä¼˜åŒ–æŸ¥è¯¢
```

**ğŸ¯ å…³é”®è®°å¿†ç‚¹**
```
ä¸€å¥è¯ç²¾åï¼š
CTEå°±åƒç»™å¤æ‚é—®é¢˜åˆ—æçº²ï¼Œå…ˆåˆ†è§£å†ç»„åˆï¼Œè®©SQLé€»è¾‘æ›´æ¸…æ™°

æ ¸å¿ƒä»·å€¼ï¼š
ä¸æ˜¯ä¸ºäº†ç‚«æŠ€ï¼Œè€Œæ˜¯ä¸ºäº†è®©å¤æ‚æŸ¥è¯¢å˜å¾—äººäººéƒ½èƒ½çœ‹æ‡‚

ä½¿ç”¨åŸåˆ™ï¼š
å¤æ‚å°±ç”¨CTEåˆ†è§£ï¼Œç®€å•å°±ç›´æ¥å†™ï¼Œä¸è¦ä¸ºäº†ç”¨è€Œç”¨
```

**ğŸ”‘ æŒæ¡ç¨‹åº¦è‡ªæ£€**
```
åŸºç¡€è¦æ±‚ï¼šâ˜…â˜…â˜…â˜…â˜…
â–¡ èƒ½å†™å‡ºåŸºæœ¬çš„WITHè¯­æ³•
â–¡ ç†è§£CTEçš„ä½œç”¨åŸŸå’Œç”Ÿå‘½å‘¨æœŸ
â–¡ çŸ¥é“CTEä¸è§†å›¾ã€å­æŸ¥è¯¢çš„åŒºåˆ«

è¿›é˜¶è¦æ±‚ï¼šâ˜…â˜…â˜…â˜†â˜†
â–¡ èƒ½è®¾è®¡å¤šä¸ªCTEåä½œçš„å¤æ‚æŸ¥è¯¢
â–¡ æŒæ¡CTEå‘½åå’Œä»£ç ç»„ç»‡æœ€ä½³å®è·µ
â–¡ èƒ½åˆ¤æ–­ä»€ä¹ˆæ—¶å€™é€‚åˆä½¿ç”¨CTE

å®æˆ˜è¦æ±‚ï¼šâ˜…â˜…â˜†â˜†â˜†
â–¡ èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨CTEä¼˜åŒ–æŸ¥è¯¢
â–¡ èƒ½è¿›è¡ŒCTEæ€§èƒ½è°ƒä¼˜
â–¡ èƒ½è®¾è®¡ç»“æ„åŒ–çš„æ•°æ®åˆ†ææŸ¥è¯¢
```

---

> ğŸ“š **æ‹“å±•å­¦ä¹ **
> 
> - **ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼šé€’å½’CTEçš„åº”ç”¨ï¼ˆå¤„ç†å±‚æ¬¡æ•°æ®ï¼‰
> - **ç›¸å…³ä¸»é¢˜**ï¼šçª—å£å‡½æ•°ä¸CTEçš„ç»“åˆä½¿ç”¨
> - **å®è·µé¡¹ç›®**ï¼šè®¾è®¡ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åˆ†ææŸ¥è¯¢ç³»ç»Ÿ

**ğŸ’¡ è®°å¿†å£è¯€**ï¼š
CTEåƒæ­ç§¯æœ¨ï¼Œå…ˆæ­å¥½é›¶ä»¶å†ç»„è£…ï¼Œå¤æ‚æŸ¥è¯¢ä¸å†ä¹±ï¼