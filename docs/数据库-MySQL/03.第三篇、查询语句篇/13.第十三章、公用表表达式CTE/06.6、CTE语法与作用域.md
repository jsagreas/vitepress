---
title: 6ã€CTEè¯­æ³•ä¸ä½œç”¨åŸŸ
---
## ğŸ“š ç›®å½•

1. [CTEåŸºç¡€æ¦‚å¿µä¸è¯­æ³•](#1-CTEåŸºç¡€æ¦‚å¿µä¸è¯­æ³•)
2. [WITHå­å¥å®Œæ•´è¯­æ³•è¯¦è§£](#2-WITHå­å¥å®Œæ•´è¯­æ³•è¯¦è§£)
3. [CTEå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ](#3-CTEå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ)
4. [CTEä½œç”¨åŸŸèŒƒå›´æ§åˆ¶](#4-CTEä½œç”¨åŸŸèŒƒå›´æ§åˆ¶)
5. [CTEç”Ÿå‘½å‘¨æœŸç®¡ç†](#5-CTEç”Ÿå‘½å‘¨æœŸç®¡ç†)
6. [åµŒå¥—CTEå®šä¹‰ä¸å‰å‘å¼•ç”¨](#6-åµŒå¥—CTEå®šä¹‰ä¸å‰å‘å¼•ç”¨)
7. [åˆ—åå®šä¹‰æ–¹å¼è¯¦è§£](#7-åˆ—åå®šä¹‰æ–¹å¼è¯¦è§£)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CTEåŸºç¡€æ¦‚å¿µä¸è¯­æ³•


### 1.1 ä»€ä¹ˆæ˜¯CTEï¼Ÿ


â”Œâ”€ ğŸ’¡ ä¸€å¥è¯è§£é‡Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CTEå°±æ˜¯SQLä¸­çš„"ä¸´æ—¶è¡¨æ ¼" â”‚
â”‚ ç”¨å®Œå°±æ‰”ï¼Œä¸å ç”¨å­˜å‚¨ç©ºé—´ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**CTE (Common Table Expression)** = **å…¬ç”¨è¡¨è¡¨è¾¾å¼**

ğŸŒŸ **ç”Ÿæ´»ç±»æ¯”**
> CTEå°±åƒåšèœæ—¶çš„å‡†å¤‡å·¥ä½œå°ï¼š
> - ä½ å…ˆæŠŠå„ç§é£Ÿææ´—å¥½ã€åˆ‡å¥½æ”¾åœ¨å·¥ä½œå°ä¸Š
> - ç„¶åç”¨è¿™äº›å‡†å¤‡å¥½çš„é£Ÿæç‚’èœ
> - åšå®Œèœåï¼Œå·¥ä½œå°å°±æ¸…ç†æ‰äº†
> - CTEå°±æ˜¯SQLçš„"å·¥ä½œå°"ï¼Œå¸®ä½ æ•´ç†æ•°æ®åå†æŸ¥è¯¢

### 1.2 CTEè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ


**ä¼ ç»ŸSQLçš„ç—›ç‚¹ï¼š**
```sql
-- ğŸ˜µ å¤æ‚æŸ¥è¯¢åµŒå¥—åœ°ç‹±
SELECT d.dept_name, AVG(subquery.salary)
FROM departments d
JOIN (
    SELECT dept_id, salary 
    FROM (
        SELECT dept_id, salary, 
               ROW_NUMBER() OVER(PARTITION BY dept_id ORDER BY salary DESC) as rn
        FROM employees 
        WHERE hire_date > '2020-01-01'
    ) ranked 
    WHERE rn <= 3
) subquery ON d.dept_id = subquery.dept_id
GROUP BY d.dept_name;
```

**CTEè®©æŸ¥è¯¢å˜æ¸…æ™°ï¼š**
```sql
-- ğŸ˜Š ç”¨CTEé‡å†™ï¼Œé€»è¾‘æ¸…æ™°
WITH recent_employees AS (
    -- ç¬¬ä¸€æ­¥ï¼šç­›é€‰è¿‘æœŸå‘˜å·¥
    SELECT dept_id, salary, 
           ROW_NUMBER() OVER(PARTITION BY dept_id ORDER BY salary DESC) as rn
    FROM employees 
    WHERE hire_date > '2020-01-01'
),
top_salaries AS (
    -- ç¬¬äºŒæ­¥ï¼šé€‰å‡ºå‰3å
    SELECT dept_id, salary
    FROM recent_employees 
    WHERE rn <= 3
)
-- ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—å¹³å‡è–ªèµ„
SELECT d.dept_name, AVG(ts.salary)
FROM departments d
JOIN top_salaries ts ON d.dept_id = ts.dept_id
GROUP BY d.dept_name;
```

ğŸ”¥ **CTEçš„æ ¸å¿ƒä»·å€¼**
- **å¯è¯»æ€§**ï¼šæŠŠå¤æ‚æŸ¥è¯¢æ‹†åˆ†æˆå¤šä¸ªæ­¥éª¤
- **å¯ç»´æŠ¤æ€§**ï¼šæ¯ä¸ªCTEèŒè´£å•ä¸€ï¼Œå®¹æ˜“ä¿®æ”¹
- **å¯é‡ç”¨æ€§**ï¼šåŒä¸€ä¸ªCTEå¯ä»¥åœ¨åç»­å¤šæ¬¡ä½¿ç”¨

---

## 2. ğŸ“ WITHå­å¥å®Œæ•´è¯­æ³•è¯¦è§£


### 2.1 WITHå­å¥åŸºæœ¬è¯­æ³•


**ğŸ”¸ æ ‡å‡†è¯­æ³•ç»“æ„**
```sql
WITH cte_name [(column1, column2, ...)] AS (
    -- CTEæŸ¥è¯¢å®šä¹‰
    SELECT ...
)
-- ä¸»æŸ¥è¯¢ä½¿ç”¨CTE
SELECT ... FROM cte_name ...
```

**ğŸ“‹ è¯­æ³•ç»„æˆéƒ¨åˆ†ï¼š**

| éƒ¨åˆ† | **å¿…éœ€æ€§** | **ä½œç”¨** | **ç¤ºä¾‹** |
|------|-----------|---------|----------|
| `WITH` | **å¿…é¡»** | CTEå…³é”®å­— | `WITH` |
| `cte_name` | **å¿…é¡»** | CTEåç§° | `employee_stats` |
| `(åˆ—ååˆ—è¡¨)` | å¯é€‰ | æŒ‡å®šåˆ—å | `(name, salary, rank)` |
| `AS` | **å¿…é¡»** | è¿æ¥ç¬¦ | `AS` |
| `(æŸ¥è¯¢è¯­å¥)` | **å¿…é¡»** | CTEå†…å®¹ | `(SELECT ...)` |

### 2.2 WITHå­å¥é«˜çº§è¯­æ³•


**ğŸ”¸ å¤šä¸ªCTEå®šä¹‰**
```sql
WITH 
-- ç¬¬ä¸€ä¸ªCTE
high_performers AS (
    SELECT employee_id, name, salary
    FROM employees
    WHERE performance_score > 8
),
-- ç¬¬äºŒä¸ªCTE  
recent_hires AS (
    SELECT employee_id, name, hire_date
    FROM employees
    WHERE hire_date > '2023-01-01'
),
-- ç¬¬ä¸‰ä¸ªCTEï¼Œå¯ä»¥å¼•ç”¨å‰é¢çš„CTE
top_new_talent AS (
    SELECT hp.name, hp.salary, rh.hire_date
    FROM high_performers hp
    JOIN recent_hires rh ON hp.employee_id = rh.employee_id
)
-- ä¸»æŸ¥è¯¢
SELECT * FROM top_new_talent;
```

ğŸ’¡ **è¯­æ³•è¦ç‚¹**
- å¤šä¸ªCTEç”¨é€—å·åˆ†éš”
- åé¢çš„CTEå¯ä»¥å¼•ç”¨å‰é¢çš„CTE
- æœ€åä¸€ä¸ªCTEåé¢æ²¡æœ‰é€—å·
- WITHåªèƒ½å‡ºç°åœ¨æŸ¥è¯¢æœ€å¼€å§‹

### 2.3 é€’å½’CTEè¯­æ³•ï¼ˆé«˜çº§ç‰¹æ€§ï¼‰


**ğŸ”¸ é€’å½’CTEç»“æ„**
```sql
WITH RECURSIVE cte_name AS (
    -- é”šç‚¹æŸ¥è¯¢ï¼ˆåˆå§‹æ¡ä»¶ï¼‰
    SELECT ... 
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼ˆå¼•ç”¨è‡ªèº«ï¼‰
    SELECT ... 
    FROM cte_name
    WHERE ...
)
SELECT * FROM cte_name;
```

**ğŸŒŸ ç»„ç»‡æ¶æ„é€’å½’ç¤ºä¾‹**
```sql
-- æŸ¥æ‰¾æŸç»ç†ä¸‹çš„æ‰€æœ‰ä¸‹å±ï¼ˆåŒ…æ‹¬ä¸‹å±çš„ä¸‹å±ï¼‰
WITH RECURSIVE employee_hierarchy AS (
    -- é”šç‚¹ï¼šç›´æ¥ä¸‹å±
    SELECT employee_id, name, manager_id, 1 as level
    FROM employees
    WHERE manager_id = 100  -- ä»ID=100çš„ç»ç†å¼€å§‹
    
    UNION ALL
    
    -- é€’å½’ï¼šä¸‹å±çš„ä¸‹å±
    SELECT e.employee_id, e.name, e.manager_id, eh.level + 1
    FROM employees e
    JOIN employee_hierarchy eh ON e.manager_id = eh.employee_id
    WHERE eh.level < 5  -- é˜²æ­¢æ— é™é€’å½’
)
SELECT * FROM employee_hierarchy ORDER BY level, name;
```

âš ï¸ **é€’å½’CTEæ³¨æ„äº‹é¡¹**
- å¿…é¡»æœ‰ç»ˆæ­¢æ¡ä»¶ï¼Œå¦åˆ™æ— é™å¾ªç¯
- ä½¿ç”¨`RECURSIVE`å…³é”®å­—
- é€‚åˆå¤„ç†å±‚çº§æ•°æ®ï¼ˆç»„ç»‡æ¶æ„ã€åˆ†ç±»ç›®å½•ç­‰ï¼‰

---

## 3. ğŸ“Œ CTEå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ


### 3.1 CTEå‘½åè§„èŒƒæ ‡å‡†


**ğŸ”¸ å‘½ååŸåˆ™**

| è§„èŒƒç±»å‹ | **è§„åˆ™** | **ç¤ºä¾‹** | **è¯´æ˜** |
|---------|---------|----------|----------|
| **æè¿°æ€§å‘½å** | è§åçŸ¥æ„ | `active_customers` | æ¯”`cte1`å¥½ç†è§£ |
| **åŠ¨ä½œ+å¯¹è±¡** | åŠ¨è¯+åè¯ | `filtered_orders` | è¯´æ˜å¯¹æ•°æ®åšäº†ä»€ä¹ˆ |
| **ä¸šåŠ¡å«ä¹‰** | ä½“ç°ä¸šåŠ¡é€»è¾‘ | `monthly_revenue` | åæ˜ ä¸šåŠ¡æ¦‚å¿µ |
| **å±‚çº§æ ‡è¯†** | æ ‡æ˜å¤„ç†å±‚æ¬¡ | `raw_data` â†’ `cleaned_data` | ä½“ç°æ•°æ®æµå‘ |

**ğŸ’­ å‘½åç¤ºä¾‹å¯¹æ¯”**

âŒ **ä¸å¥½çš„å‘½å**
```sql
WITH 
t1 AS (SELECT ...),        -- å¤ªç®€å•ï¼Œä¸çŸ¥é“å«ä¹‰
data AS (SELECT ...),      -- å¤ªæ³›æ³›ï¼Œä¸å…·ä½“  
temp AS (SELECT ...),      -- ä¸´æ—¶æ€§è´¨ä¸æ˜ç¡®
result AS (SELECT ...)     -- ç»“æœæ˜¯ä»€ä¹ˆä¸æ¸…æ¥š
```

âœ… **å¥½çš„å‘½å**
```sql
WITH 
active_customers AS (SELECT ...),     -- æ¸…æ¥šæ˜¯æ´»è·ƒå®¢æˆ·
monthly_sales AS (SELECT ...),        -- æ˜ç¡®æ˜¯æœˆåº¦é”€å”®
top_products AS (SELECT ...),         -- çŸ¥é“æ˜¯çƒ­é—¨äº§å“
customer_summary AS (SELECT ...)      -- æ˜ç¡®æ˜¯å®¢æˆ·æ±‡æ€»
```

### 3.2 å‘½åè§„èŒƒå®æˆ˜


**ğŸ”¸ ä¸šåŠ¡åœºæ™¯å‘½åç¤ºä¾‹**
```sql
-- ç”µå•†æ•°æ®åˆ†æCTEå‘½å
WITH 
-- åŸºç¡€æ•°æ®å±‚
valid_orders AS (
    SELECT * FROM orders WHERE status = 'completed'
),
-- è®¡ç®—å±‚
order_metrics AS (
    SELECT customer_id, COUNT(*) as order_count, SUM(amount) as total_spent
    FROM valid_orders
    GROUP BY customer_id
),
-- åˆ†ç±»å±‚
customer_segments AS (
    SELECT customer_id, 
           CASE 
               WHEN total_spent > 10000 THEN 'VIP'
               WHEN total_spent > 1000 THEN 'Premium'
               ELSE 'Regular'
           END as segment
    FROM order_metrics
)
SELECT * FROM customer_segments;
```

**ğŸ¯ å‘½åæœ€ä½³å®è·µ**
- ä½¿ç”¨`snake_case`ï¼ˆä¸‹åˆ’çº¿ï¼‰è€Œä¸æ˜¯`camelCase`
- é¿å…SQLå…³é”®å­—ä½œä¸ºCTEåç§°
- å›¢é˜Ÿå†…ä¿æŒå‘½åé£æ ¼ç»Ÿä¸€
- å¤æ‚é¡¹ç›®å»ºç«‹å‘½åè§„èŒƒæ–‡æ¡£

---

## 4. ğŸ¯ CTEä½œç”¨åŸŸèŒƒå›´æ§åˆ¶


### 4.1 CTEä½œç”¨åŸŸåŸºæœ¬æ¦‚å¿µ


â”Œâ”€ ğŸ¯ ä¸€å¥è¯è§£é‡Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CTEåªåœ¨å®šä¹‰å®ƒçš„æŸ¥è¯¢å†…æœ‰æ•ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**ğŸ”¸ ä½œç”¨åŸŸè¾¹ç•Œ**

```
CTEä½œç”¨åŸŸèŒƒå›´å›¾ç¤ºï¼š

â”Œâ”€ æŸ¥è¯¢è¯­å¥A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WITH my_cte AS (...)       â”‚ â† CTEå®šä¹‰
â”‚ SELECT * FROM my_cte       â”‚ â† å¯ä»¥ä½¿ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æŸ¥è¯¢è¯­å¥B â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ SELECT * FROM my_cte       â”‚ â† âŒ é”™è¯¯ï¼æ‰¾ä¸åˆ°my_cte
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä½œç”¨åŸŸè¾¹ç•Œå®ä¾‹


**âœ… æ­£ç¡®çš„ä½œç”¨åŸŸä½¿ç”¨**
```sql
-- CTEåœ¨åŒä¸€ä¸ªæŸ¥è¯¢è¯­å¥å†…æœ‰æ•ˆ
WITH department_stats AS (
    SELECT dept_id, COUNT(*) as employee_count
    FROM employees
    GROUP BY dept_id
)
SELECT d.dept_name, ds.employee_count
FROM departments d
JOIN department_stats ds ON d.dept_id = ds.dept_id;  -- âœ… å¯ä»¥ä½¿ç”¨
```

**âŒ é”™è¯¯çš„ä½œç”¨åŸŸä½¿ç”¨**
```sql
-- ç¬¬ä¸€ä¸ªæŸ¥è¯¢å®šä¹‰CTE
WITH department_stats AS (
    SELECT dept_id, COUNT(*) as employee_count
    FROM employees
    GROUP BY dept_id
)
SELECT * FROM department_stats;

-- ç¬¬äºŒä¸ªæŸ¥è¯¢å°è¯•ä½¿ç”¨CTE
SELECT * FROM department_stats;  -- âŒ é”™è¯¯ï¼CTEå·²ç»å¤±æ•ˆ
```

### 4.3 ä½œç”¨åŸŸè¾¹ç•Œçš„å®é™…å½±å“


**ğŸ”¸ å­æŸ¥è¯¢ä¸­çš„CTEä½œç”¨åŸŸ**
```sql
WITH outer_cte AS (
    SELECT dept_id, COUNT(*) as emp_count
    FROM employees
    GROUP BY dept_id
)
SELECT dept_name,
       (SELECT emp_count 
        FROM outer_cte 
        WHERE outer_cte.dept_id = d.dept_id) as employee_count  -- âœ… å¯ä»¥è®¿é—®
FROM departments d;
```

**ğŸ”¸ UNIONæŸ¥è¯¢ä¸­çš„CTEä½œç”¨åŸŸ**
```sql
WITH recent_orders AS (
    SELECT customer_id, order_date, amount
    FROM orders
    WHERE order_date > '2024-01-01'
)
SELECT customer_id, 'recent' as order_type, COUNT(*)
FROM recent_orders          -- âœ… ç¬¬ä¸€ä¸ªæŸ¥è¯¢å¯ä»¥ä½¿ç”¨
GROUP BY customer_id

UNION ALL

SELECT customer_id, 'old' as order_type, COUNT(*)  
FROM recent_orders          -- âŒ é”™è¯¯ï¼UNIONåçš„æŸ¥è¯¢æ— æ³•è®¿é—®CTE
WHERE order_date <= '2024-01-01';
```

**æ­£ç¡®åšæ³•ï¼š**
```sql
WITH recent_orders AS (...),
     old_orders AS (...)
SELECT ... FROM recent_orders
UNION ALL
SELECT ... FROM old_orders;
```

---

## 5. â° CTEç”Ÿå‘½å‘¨æœŸç®¡ç†


### 5.1 CTEç”Ÿå‘½å‘¨æœŸé˜¶æ®µ


```
CTEç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ï¼š

å®šä¹‰é˜¶æ®µ â†’ ç¼–è¯‘é˜¶æ®µ â†’ æ‰§è¡Œé˜¶æ®µ â†’ é”€æ¯é˜¶æ®µ
    â†“          â†“          â†“          â†“
WITHå­å¥   è¯­æ³•æ£€æŸ¥   æ•°æ®ç”Ÿæˆ   å†…å­˜é‡Šæ”¾
   è§£æ      ä½œç”¨åŸŸ      æŸ¥è¯¢ç»“æœ     æ¸…ç†
             éªŒè¯        ç¼“å­˜
```

**ğŸ”¸ å„é˜¶æ®µè¯¦è§£**

**å®šä¹‰é˜¶æ®µï¼ˆParse Timeï¼‰**
```sql
WITH employee_summary AS (  -- â† è¿™é‡Œæ˜¯å®šä¹‰é˜¶æ®µ
    SELECT dept_id, COUNT(*) as count
    FROM employees
    GROUP BY dept_id
)
-- æ­¤æ—¶CTEè¿˜æ²¡æœ‰æ‰§è¡Œï¼Œåªæ˜¯å®šä¹‰äº†ä¸€ä¸ª"æ¨¡æ¿"
```

**ç¼–è¯‘é˜¶æ®µï¼ˆCompile Timeï¼‰**
- æ£€æŸ¥CTEè¯­æ³•æ˜¯å¦æ­£ç¡®
- éªŒè¯å¼•ç”¨çš„è¡¨å’Œåˆ—æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ä½œç”¨åŸŸè§„åˆ™æ˜¯å¦è¿å
- ç”Ÿæˆæ‰§è¡Œè®¡åˆ’

**æ‰§è¡Œé˜¶æ®µï¼ˆRuntimeï¼‰**
- å®é™…æ‰§è¡ŒCTEä¸­çš„æŸ¥è¯¢
- å°†ç»“æœå­˜å‚¨åœ¨å†…å­˜ä¸­
- ä¸»æŸ¥è¯¢å¯ä»¥å¤šæ¬¡å¼•ç”¨è¿™ä¸ªç»“æœ

**é”€æ¯é˜¶æ®µï¼ˆCleanupï¼‰**
- æŸ¥è¯¢å®Œæˆåè‡ªåŠ¨æ¸…ç†CTEç»“æœ
- é‡Šæ”¾å ç”¨çš„å†…å­˜ç©ºé—´
- CTEåç§°ä»ä½œç”¨åŸŸä¸­ç§»é™¤

### 5.2 CTEç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥


**ğŸ”¸ å†…å­˜ä½¿ç”¨ä¼˜åŒ–**
```sql
-- âŒ ç”Ÿæˆå¤§é‡æ•°æ®çš„CTE
WITH huge_dataset AS (
    SELECT * FROM orders o
    CROSS JOIN customers c  -- ç¬›å¡å°”ç§¯ï¼Œæ•°æ®é‡çˆ†ç‚¸ï¼
    CROSS JOIN products p
)
SELECT COUNT(*) FROM huge_dataset;

-- âœ… å…ˆè¿‡æ»¤å†å…³è”
WITH filtered_orders AS (
    SELECT customer_id, product_id, amount
    FROM orders
    WHERE order_date > '2024-01-01'  -- å…ˆè¿‡æ»¤
),
order_details AS (
    SELECT fo.*, c.customer_name, p.product_name
    FROM filtered_orders fo
    JOIN customers c ON fo.customer_id = c.customer_id
    JOIN products p ON fo.product_id = p.product_id
)
SELECT * FROM order_details;
```

**ğŸ’¡ ç”Ÿå‘½å‘¨æœŸç®¡ç†æœ€ä½³å®è·µ**
- **åŠæ—¶è¿‡æ»¤**ï¼šåœ¨CTEä¸­å°½æ—©è¿‡æ»¤æ•°æ®ï¼Œå‡å°‘å†…å­˜å ç”¨
- **åˆç†åˆ†å±‚**ï¼šä¸è¦åœ¨å•ä¸ªCTEä¸­åšå¤ªå¤šäº‹æƒ…
- **é¿å…ç¬›å¡å°”ç§¯**ï¼šæ³¨æ„JOINæ¡ä»¶ï¼Œé˜²æ­¢æ•°æ®çˆ†ç‚¸
- **ç›‘æ§æ€§èƒ½**ï¼šå¤§æ•°æ®é‡æ—¶å…³æ³¨CTEçš„æ‰§è¡Œæ—¶é—´

---

## 6. ğŸ—ï¸ åµŒå¥—CTEå®šä¹‰ä¸å‰å‘å¼•ç”¨


### 6.1 CTEå¼•ç”¨è§„åˆ™


**ğŸ”¸ å‰å‘å¼•ç”¨è§„åˆ™**

```
CTEå¼•ç”¨å…³ç³»å›¾ï¼š

CTE_A  â†’  CTE_B  â†’  CTE_C  â†’  ä¸»æŸ¥è¯¢
  â†‘        â†‘        â†‘
å®šä¹‰é¡ºåº  å¯ä»¥å¼•ç”¨   å¯ä»¥å¼•ç”¨   å¯ä»¥å¼•ç”¨
         CTE_A     CTE_A,B    æ‰€æœ‰CTE
```

âœ… **æ­£ç¡®çš„å¼•ç”¨é¡ºåº**
```sql
WITH 
-- ç¬¬1å±‚ï¼šåŸºç¡€æ•°æ®
base_data AS (
    SELECT customer_id, order_date, amount
    FROM orders
    WHERE status = 'completed'
),
-- ç¬¬2å±‚ï¼šå¼•ç”¨ç¬¬1å±‚
monthly_summary AS (
    SELECT customer_id, 
           DATE_TRUNC('month', order_date) as month,
           SUM(amount) as monthly_total
    FROM base_data  -- âœ… å¯ä»¥å¼•ç”¨å‰é¢å®šä¹‰çš„CTE
    GROUP BY customer_id, DATE_TRUNC('month', order_date)
),
-- ç¬¬3å±‚ï¼šå¼•ç”¨å‰é¢çš„CTE
customer_trends AS (
    SELECT customer_id,
           AVG(monthly_total) as avg_monthly_spend,
           COUNT(DISTINCT month) as active_months
    FROM monthly_summary  -- âœ… å¯ä»¥å¼•ç”¨å‰é¢çš„CTE
    GROUP BY customer_id
)
-- ä¸»æŸ¥è¯¢ï¼šå¯ä»¥å¼•ç”¨ä»»ä½•CTE
SELECT * FROM customer_trends WHERE avg_monthly_spend > 1000;
```

**âŒ é”™è¯¯çš„å¼•ç”¨ç¤ºä¾‹**
```sql
WITH 
summary_data AS (
    SELECT customer_id, total_amount
    FROM base_data  -- âŒ é”™è¯¯ï¼base_dataè¿˜æ²¡å®šä¹‰
    GROUP BY customer_id
),
base_data AS (
    SELECT customer_id, amount as total_amount
    FROM orders
)
SELECT * FROM summary_data;
```

### 6.2 åµŒå¥—CTEè®¾è®¡æ¨¡å¼


**ğŸ”¸ æ•°æ®å¤„ç†ç®¡é“æ¨¡å¼**
```sql
WITH 
-- ç®¡é“ç¬¬1æ­¥ï¼šæ•°æ®æ¸…æ´—
cleaned_data AS (
    SELECT customer_id, 
           TRIM(customer_name) as customer_name,
           amount
    FROM raw_orders
    WHERE amount > 0 AND customer_id IS NOT NULL
),
-- ç®¡é“ç¬¬2æ­¥ï¼šæ•°æ®èšåˆ
aggregated_data AS (
    SELECT customer_id, customer_name,
           COUNT(*) as order_count,
           SUM(amount) as total_amount,
           AVG(amount) as avg_amount
    FROM cleaned_data
    GROUP BY customer_id, customer_name
),
-- ç®¡é“ç¬¬3æ­¥ï¼šæ•°æ®åˆ†ç±»
categorized_data AS (
    SELECT *,
           CASE 
               WHEN total_amount > 10000 THEN 'VIP'
               WHEN total_amount > 1000 THEN 'Gold'
               ELSE 'Silver'
           END as customer_tier
    FROM aggregated_data
)
-- æœ€ç»ˆè¾“å‡º
SELECT customer_tier, COUNT(*) as customer_count, AVG(avg_amount)
FROM categorized_data
GROUP BY customer_tier;
```

**ğŸ¯ ç®¡é“è®¾è®¡åŸåˆ™**
- æ¯ä¸ªCTEèŒè´£å•ä¸€æ˜ç¡®
- æ•°æ®é€æ­¥ç²¾ç‚¼ï¼Œä»ç²—åˆ°ç»†
- ä¾¿äºè°ƒè¯•ï¼šå¯ä»¥å•ç‹¬æŸ¥çœ‹ä»»ä½•ä¸€å±‚çš„ç»“æœ
- ä¾¿äºç»´æŠ¤ï¼šä¿®æ”¹æŸä¸€å±‚ä¸å½±å“å…¶ä»–å±‚

### 6.3 CTEä¾èµ–å…³ç³»ç®¡ç†


**ğŸ”¸ å¤æ‚ä¾èµ–å…³ç³»ç¤ºä¾‹**
```sql
-- é”€å”®åˆ†æçš„å¤šå±‚CTE
WITH 
-- åŸºç¡€å±‚
orders_base AS (
    SELECT order_id, customer_id, product_id, amount, order_date
    FROM orders
    WHERE order_date BETWEEN '2024-01-01' AND '2024-12-31'
),
customers_base AS (
    SELECT customer_id, customer_name, region
    FROM customers
    WHERE status = 'active'
),
-- å…³è”å±‚
order_customer AS (
    SELECT ob.*, cb.customer_name, cb.region
    FROM orders_base ob
    JOIN customers_base cb ON ob.customer_id = cb.customer_id
),
-- èšåˆå±‚
regional_summary AS (
    SELECT region, 
           COUNT(DISTINCT customer_id) as unique_customers,
           COUNT(*) as total_orders,
           SUM(amount) as total_revenue
    FROM order_customer
    GROUP BY region
),
-- æ’åå±‚
regional_ranking AS (
    SELECT *,
           RANK() OVER(ORDER BY total_revenue DESC) as revenue_rank
    FROM regional_summary
)
-- æœ€ç»ˆæŸ¥è¯¢
SELECT region, unique_customers, total_revenue, revenue_rank
FROM regional_ranking
WHERE revenue_rank <= 5;
```

**ä¾èµ–å…³ç³»å›¾ï¼š**
```
orders_base â”€â”€â”
              â”œâ”€â†’ order_customer â”€â†’ regional_summary â”€â†’ regional_ranking
customers_base â”˜
```

---

## 7. ğŸ“‹ åˆ—åå®šä¹‰æ–¹å¼è¯¦è§£


### 7.1 åˆ—åå®šä¹‰çš„ä¸‰ç§æ–¹å¼


**ğŸ”¸ æ–¹å¼ä¸€ï¼šåœ¨CTEåç§°åå®šä¹‰**
```sql
-- åœ¨CTEåç§°åé¢æŒ‡å®šæ‰€æœ‰åˆ—å
WITH employee_stats (emp_id, emp_name, emp_salary, emp_rank) AS (
    SELECT employee_id, name, salary,
           RANK() OVER(ORDER BY salary DESC)
    FROM employees
)
SELECT emp_name, emp_salary FROM employee_stats WHERE emp_rank <= 10;
```

**ğŸ”¸ æ–¹å¼äºŒï¼šåœ¨SELECTä¸­å®šä¹‰åˆ«å**
```sql
-- åœ¨SELECTå­å¥ä¸­ä½¿ç”¨ASå®šä¹‰åˆ«å
WITH employee_stats AS (
    SELECT employee_id as emp_id,
           name as emp_name, 
           salary as emp_salary,
           RANK() OVER(ORDER BY salary DESC) as emp_rank
    FROM employees
)
SELECT emp_name, emp_salary FROM employee_stats WHERE emp_rank <= 10;
```

**ğŸ”¸ æ–¹å¼ä¸‰ï¼šä½¿ç”¨åŸå§‹åˆ—å**
```sql
-- ç›´æ¥ä½¿ç”¨åŸè¡¨çš„åˆ—å
WITH top_employees AS (
    SELECT employee_id, name, salary
    FROM employees
    WHERE salary > 50000
)
SELECT name, salary FROM top_employees;
```

### 7.2 åˆ—åå®šä¹‰æ–¹å¼é€‰æ‹©æŒ‡å—


| åœºæ™¯ | **æ¨èæ–¹å¼** | **åŸå› ** | **ç¤ºä¾‹** |
|------|-------------|----------|----------|
| **ç®€å•æŸ¥è¯¢** | æ–¹å¼ä¸‰ | ç®€æ´æ˜äº† | `SELECT name, salary` |
| **å¤æ‚è®¡ç®—** | æ–¹å¼äºŒ | é€»è¾‘æ¸…æ™° | `SUM(amount) as total` |
| **åˆ—åæ˜ å°„** | æ–¹å¼ä¸€ | ç»Ÿä¸€è§„èŒƒ | `(id, name, value)` |
| **å›¢é˜Ÿåä½œ** | æ–¹å¼ä¸€ | æ¥å£æ˜ç¡® | å®šä¹‰æ¸…æ™°çš„"å¥‘çº¦" |

### 7.3 åˆ—åå®šä¹‰å®æˆ˜æŠ€å·§


**ğŸ”¸ å¤„ç†è®¡ç®—åˆ—**
```sql
-- å¤æ‚è®¡ç®—æ—¶ï¼Œæ–¹å¼äºŒæ›´æ¸…æ™°
WITH sales_analysis AS (
    SELECT customer_id,
           COUNT(*) as order_count,                    -- è®¢å•æ•°é‡
           SUM(amount) as total_spent,                 -- æ€»æ¶ˆè´¹
           AVG(amount) as avg_order_value,             -- å¹³å‡è®¢å•å€¼
           MAX(order_date) as last_order_date,         -- æœ€åä¸‹å•æ—¥æœŸ
           DATEDIFF(CURRENT_DATE, MAX(order_date)) as days_since_last_order
    FROM orders
    GROUP BY customer_id
)
SELECT customer_id, 
       total_spent,
       CASE 
           WHEN days_since_last_order > 365 THEN 'æµå¤±å®¢æˆ·'
           WHEN days_since_last_order > 90 THEN 'æ²‰ç¡å®¢æˆ·'
           ELSE 'æ´»è·ƒå®¢æˆ·'
       END as customer_status
FROM sales_analysis;
```

**ğŸ”¸ åˆ—åå†²çªå¤„ç†**
```sql
-- å½“å¤šè¡¨æœ‰åŒååˆ—æ—¶ï¼Œä½¿ç”¨æ˜ç¡®çš„åˆ«å
WITH order_summary AS (
    SELECT o.customer_id,
           o.order_date as order_date,           -- æ˜ç¡®æ¥æº
           c.created_date as customer_reg_date,  -- é¿å…æ··æ·†
           o.amount
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
)
SELECT customer_id, 
       order_date, 
       customer_reg_date,
       DATEDIFF(order_date, customer_reg_date) as days_to_first_order
FROM order_summary;
```

---

## 8. ğŸ”§ åµŒå¥—CTEä½œç”¨åŸŸè§„åˆ™


### 8.1 åµŒå¥—ä½œç”¨åŸŸå±‚æ¬¡


```
åµŒå¥—CTEä½œç”¨åŸŸå›¾ç¤ºï¼š

å¤–å±‚æŸ¥è¯¢ä½œç”¨åŸŸ
â”œâ”€ WITH outer_cte AS (...)
â”œâ”€ SELECT ... 
â”‚   â””â”€ å­æŸ¥è¯¢ä½œç”¨åŸŸ
â”‚       â”œâ”€ WITH inner_cte AS (...)  â† åªåœ¨è¿™ä¸ªå­æŸ¥è¯¢å†…æœ‰æ•ˆ
â”‚       â””â”€ SELECT ... FROM inner_cte, outer_cte  â† éƒ½å¯ä»¥è®¿é—®
â””â”€ FROM outer_cte  â† åªèƒ½è®¿é—®å¤–å±‚CTE
```

**ğŸ”¸ å®é™…ç¤ºä¾‹**
```sql
-- å¤–å±‚CTE
WITH department_info AS (
    SELECT dept_id, dept_name, budget
    FROM departments
)
SELECT dept_name,
       budget,
       -- å­æŸ¥è¯¢ä¸­çš„CTE
       (SELECT emp_count 
        FROM (
            WITH dept_employees AS (  -- å†…å±‚CTE
                SELECT dept_id, COUNT(*) as emp_count
                FROM employees
                GROUP BY dept_id
            )
            SELECT emp_count 
            FROM dept_employees 
            WHERE dept_employees.dept_id = department_info.dept_id
        )) as employee_count
FROM department_info;
```

### 8.2 åµŒå¥—CTEçš„å®é™…åº”ç”¨


**ğŸ”¸ åˆ†å±‚æ•°æ®å¤„ç†**
```sql
-- å®¢æˆ·ä»·å€¼åˆ†æçš„åµŒå¥—CTE
WITH customer_orders AS (
    -- ç¬¬1å±‚ï¼šå®¢æˆ·è®¢å•åŸºç¡€æ•°æ®
    SELECT customer_id, order_date, amount
    FROM orders
    WHERE status = 'completed' AND order_date > '2023-01-01'
),
customer_metrics AS (
    -- ç¬¬2å±‚ï¼šå®¢æˆ·æŒ‡æ ‡è®¡ç®—
    SELECT customer_id,
           COUNT(*) as order_frequency,
           SUM(amount) as total_value,
           AVG(amount) as avg_order_value,
           MAX(order_date) as last_order_date
    FROM customer_orders
    GROUP BY customer_id
),
customer_segments AS (
    -- ç¬¬3å±‚ï¼šå®¢æˆ·åˆ†å±‚
    SELECT customer_id,
           total_value,
           CASE 
               WHEN total_value > 10000 AND order_frequency > 20 THEN 'VIP'
               WHEN total_value > 5000 OR order_frequency > 10 THEN 'Premium'
               ELSE 'Regular'
           END as segment,
           CASE 
               WHEN DATEDIFF(CURRENT_DATE, last_order_date) > 180 THEN 'At Risk'
               ELSE 'Active'
           END as activity_status
    FROM customer_metrics
)
-- æœ€ç»ˆåˆ†ææŸ¥è¯¢
SELECT segment, 
       activity_status,
       COUNT(*) as customer_count,
       AVG(total_value) as avg_customer_value
FROM customer_segments
GROUP BY segment, activity_status
ORDER BY segment, activity_status;
```

**ğŸ’¡ åµŒå¥—è®¾è®¡åŸåˆ™**
- **å±‚æ¬¡æ¸…æ™°**ï¼šæ¯å±‚æœ‰æ˜ç¡®çš„æ•°æ®å¤„ç†ç›®æ ‡
- **é€æ­¥ç²¾ç‚¼**ï¼šä»åŸå§‹æ•°æ®åˆ°æœ€ç»ˆåˆ†æç»“æœ
- **ä¾¿äºè°ƒè¯•**ï¼šå¯ä»¥å•ç‹¬è¿è¡Œä»»ä½•ä¸€å±‚æŸ¥çœ‹ä¸­é—´ç»“æœ
- **ä¾¿äºå¤ç”¨**ï¼šåº•å±‚CTEå¯ä»¥è¢«å¤šä¸ªä¸Šå±‚CTEä½¿ç”¨

---

## 8. ğŸ“š æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¥ **CTEæ ¸å¿ƒæœ¬è´¨**
CTE = SQLä¸­çš„ä¸´æ—¶å·¥ä½œå°ï¼Œç”¨å®Œå°±æ¸…ç†ï¼Œè®©å¤æ‚æŸ¥è¯¢å˜å¾—æ¸…æ™°æ˜“æ‡‚

ğŸ”‘ **è¯­æ³•è¦ç‚¹**
â€¢ WITHå­å¥ï¼šå®šä¹‰CTEçš„å…³é”®å­—
â€¢ ä½œç”¨åŸŸï¼šåªåœ¨å®šä¹‰å®ƒçš„æŸ¥è¯¢è¯­å¥å†…æœ‰æ•ˆ
â€¢ ç”Ÿå‘½å‘¨æœŸï¼šæŸ¥è¯¢æ‰§è¡ŒæœŸé—´å­˜åœ¨ï¼Œå®Œæˆåè‡ªåŠ¨æ¸…ç†
â€¢ å¼•ç”¨è§„åˆ™ï¼šåå®šä¹‰çš„CTEå¯ä»¥å¼•ç”¨å‰é¢å®šä¹‰çš„CTE
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½œç”¨åŸŸè¾¹ç•Œçš„é‡è¦æ€§**
```
è®°å¿†è¦ç‚¹ï¼š
â€¢ CTEåƒå‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œå‡ºäº†å‡½æ•°å°±å¤±æ•ˆ
â€¢ ä¸€ä¸ªWITHè¯­å¥å†…çš„æ‰€æœ‰CTEå…±äº«ä½œç”¨åŸŸ
â€¢ å­æŸ¥è¯¢å†…çš„CTEä¸èƒ½è¢«å¤–å±‚æŸ¥è¯¢è®¿é—®
â€¢ ä¸»æŸ¥è¯¢ç»“æŸï¼Œæ‰€æœ‰CTEéƒ½è¢«æ¸…ç†
```

**ğŸ”¹ å‘½åè§„èŒƒçš„ä»·å€¼**
```
ä¸šåŠ¡ä»·å€¼ï¼š
â€¢ å¥½çš„å‘½åæ˜¯ä»£ç çš„æ³¨é‡Š
â€¢ å›¢é˜Ÿåä½œæ—¶å‡å°‘æ²Ÿé€šæˆæœ¬
â€¢ ç»´æŠ¤æ—¶å¿«é€Ÿç†è§£ä¸šåŠ¡é€»è¾‘
â€¢ æ–°äººæ¥æ‰‹æ—¶é™ä½å­¦ä¹ é—¨æ§›
```

**ğŸ”¹ åµŒå¥—CTEçš„è®¾è®¡æ€ç»´**
```
è®¾è®¡æ€è·¯ï¼š
â€¢ æŠŠå¤æ‚é—®é¢˜åˆ†è§£æˆå¤šä¸ªç®€å•æ­¥éª¤
â€¢ æ¯ä¸ªCTEè§£å†³ä¸€ä¸ªå…·ä½“é—®é¢˜
â€¢ æ­¥éª¤ä¹‹é—´æœ‰æ¸…æ™°çš„è¾“å…¥è¾“å‡ºå…³ç³»
â€¢ æœ€ç»ˆç»„åˆæˆå®Œæ•´çš„è§£å†³æ–¹æ¡ˆ
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨CTE**
- âœ… å¤æ‚æŸ¥è¯¢éœ€è¦åˆ†æ­¥éª¤å¤„ç†
- âœ… åŒä¸€ä¸ªå­æŸ¥è¯¢éœ€è¦å¤šæ¬¡ä½¿ç”¨
- âœ… éœ€è¦é€’å½’å¤„ç†å±‚çº§æ•°æ®
- âœ… æƒ³è®©SQLé€»è¾‘æ›´æ¸…æ™°æ˜“æ‡‚

**ğŸ› ï¸ CTEä½¿ç”¨æŠ€å·§**
- **å…ˆç®€å•åå¤æ‚**ï¼šä»ç®€å•CTEå¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¤æ‚é€»è¾‘
- **ä¸€æ¬¡ä¸€ä¸ªåŠŸèƒ½**ï¼šæ¯ä¸ªCTEåªåšä¸€ä»¶äº‹
- **å‘½åè¦æè¿°æ€§**ï¼šè®©åˆ«äººä¸€çœ¼çœ‹æ‡‚CTEçš„ä½œç”¨
- **æ³¨æ„æ€§èƒ½**ï¼šå¤§æ•°æ®é‡æ—¶è€ƒè™‘CTEçš„æ‰§è¡Œæ•ˆç‡

**âš ï¸ å¸¸è§è¯¯åŒº**
- **è¯¯åŒº1**ï¼šä»¥ä¸ºCTEæ˜¯ç‰©ç†è¡¨ï¼Œå®é™…ä¸Šæ˜¯ä¸´æ—¶ç»“æœé›†
- **è¯¯åŒº2**ï¼šåœ¨ä¸åŒæŸ¥è¯¢é—´å…±äº«CTEï¼Œå®é™…ä¸Šä½œç”¨åŸŸæœ‰é™
- **è¯¯åŒº3**ï¼šè¿‡åº¦åµŒå¥—CTEï¼Œå¯¼è‡´é€»è¾‘éš¾ä»¥ç†è§£

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ“š **å­¦ä¹ è¿›åº¦**
â–¡ ç†è§£CTEåŸºæœ¬æ¦‚å¿µå’Œè¯­æ³•
â–¡ æŒæ¡WITHå­å¥çš„å®Œæ•´ç”¨æ³•  
â–¡ ç†Ÿç»ƒCTEå‘½åè§„èŒƒ
â–¡ ç†è§£ä½œç”¨åŸŸå’Œç”Ÿå‘½å‘¨æœŸ
â–¡ èƒ½å¤Ÿè®¾è®¡åµŒå¥—CTEç»“æ„
â–¡ æŒæ¡é€’å½’CTEçš„ä½¿ç”¨

ğŸ¯ **å®è·µå»ºè®®**
1. ä»ç®€å•çš„WITHå¼€å§‹ç»ƒä¹ 
2. å°è¯•ç”¨CTEé‡å†™å¤æ‚çš„åµŒå¥—æŸ¥è¯¢
3. ç»ƒä¹ å¤šå±‚CTEçš„æ•°æ®å¤„ç†ç®¡é“
4. åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨CTEä¼˜åŒ–SQL
```

**ğŸ’¡ ä¸€å¥è¯æ€»ç»“**
> CTEè®©SQLä»"å†™ç»™æœºå™¨çœ‹"å˜æˆ"å†™ç»™äººçœ‹"ï¼Œæ˜¯æå‡SQLå¯è¯»æ€§å’Œç»´æŠ¤æ€§çš„é‡è¦å·¥å…·ï¼ŒæŒæ¡äº†CTEå°±æŒæ¡äº†ç¼–å†™ä¼˜é›…SQLçš„å…³é”®æŠ€èƒ½ï¼