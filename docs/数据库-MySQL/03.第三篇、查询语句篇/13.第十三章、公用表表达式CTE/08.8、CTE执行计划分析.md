---
title: 8ã€CTEæ‰§è¡Œè®¡åˆ’åˆ†æ
---
## ğŸ“š ç›®å½•

1. [CTEæ‰§è¡Œè®¡åˆ’åŸºç¡€æ¦‚å¿µ](#1-CTEæ‰§è¡Œè®¡åˆ’åŸºç¡€æ¦‚å¿µ)
2. [æ‰§è¡Œè®¡åˆ’è§£è¯»æ–¹æ³•](#2-æ‰§è¡Œè®¡åˆ’è§£è¯»æ–¹æ³•)
3. [ç‰©åŒ–ä¸éç‰©åŒ–ç­–ç•¥](#3-ç‰©åŒ–ä¸éç‰©åŒ–ç­–ç•¥)
4. [æˆæœ¬è¯„ä¼°æœºåˆ¶](#4-æˆæœ¬è¯„ä¼°æœºåˆ¶)
5. [ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹](#5-ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹)
6. [æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŠ€å·§](#6-æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŠ€å·§)
7. [æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#7-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
8. [CTEæ‰§è¡Œè®¡åˆ’å®æˆ˜åˆ†æ](#8-CTEæ‰§è¡Œè®¡åˆ’å®æˆ˜åˆ†æ)
9. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#9-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š CTEæ‰§è¡Œè®¡åˆ’åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯CTEæ‰§è¡Œè®¡åˆ’


**ğŸ”¸ æ‰§è¡Œè®¡åˆ’çš„æœ¬è´¨**
æ‰§è¡Œè®¡åˆ’å°±åƒæ˜¯åšèœçš„èœè°±ï¼Œå‘Šè¯‰æ•°æ®åº“å¦‚ä½•ä¸€æ­¥æ­¥æ‰§è¡Œä½ çš„SQLæŸ¥è¯¢ã€‚å¯¹äºCTEæ¥è¯´ï¼Œæ‰§è¡Œè®¡åˆ’æ›´åŠ å¤æ‚ï¼Œå› ä¸ºè¦å†³å®šå¦‚ä½•å¤„ç†è¿™äº›"ä¸´æ—¶çš„æŸ¥è¯¢ç»“æœ"ã€‚

```
ç®€å•æŸ¥è¯¢ vs CTEæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’å·®å¼‚ï¼š

æ™®é€šæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼š
æŸ¥è¯¢ â”€â”€â†’ æ‰«æè¡¨ â”€â”€â†’ åº”ç”¨æ¡ä»¶ â”€â”€â†’ è¿”å›ç»“æœ

CTEæŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼š
æŸ¥è¯¢ â”€â”€â†’ æ‰§è¡ŒCTE1 â”€â”€â†’ å­˜å‚¨/å¼•ç”¨ç»“æœ â”€â”€â†’ æ‰§è¡ŒCTE2 â”€â”€â†’ æœ€ç»ˆæŸ¥è¯¢ â”€â”€â†’ è¿”å›ç»“æœ
         â†“
    éœ€è¦å†³ç­–ï¼šæ˜¯å­˜å‚¨è¿˜æ˜¯æ¯æ¬¡é‡æ–°è®¡ç®—ï¼Ÿ
```

**ğŸ”¸ CTEæ‰§è¡Œè®¡åˆ’çš„ç‰¹æ®Šæ€§**
```
CTEæ‰§è¡Œè®¡åˆ’è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š

1. ç‰©åŒ–å†³ç­–ï¼šCTEç»“æœæ˜¯å¦è¦å­˜å‚¨åˆ°ä¸´æ—¶è¡¨ï¼Ÿ
2. é‡ç”¨ç­–ç•¥ï¼šå¤šæ¬¡å¼•ç”¨çš„CTEå¦‚ä½•é¿å…é‡å¤è®¡ç®—ï¼Ÿ  
3. å†…å­˜ç®¡ç†ï¼šCTEç»“æœé›†æ”¾å†…å­˜è¿˜æ˜¯ç£ç›˜ï¼Ÿ
4. æ‰§è¡Œé¡ºåºï¼šå¤šä¸ªCTEçš„æœ€ä¼˜æ‰§è¡Œé¡ºåºï¼Ÿ
5. ç´¢å¼•åˆ©ç”¨ï¼šå¦‚ä½•åœ¨CTEä¸Šä½¿ç”¨ç´¢å¼•ï¼Ÿ
```

### 1.2 CTEåœ¨æŸ¥è¯¢å¤„ç†ä¸­çš„ä½ç½®


**ğŸ—ï¸ æŸ¥è¯¢å¤„ç†æµç¨‹**

```
SQLæŸ¥è¯¢çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼š

ç”¨æˆ·SQL
    â”œâ”€â†’ è¯­æ³•è§£æï¼ˆParserï¼‰
    â”œâ”€â†’ è¯­ä¹‰åˆ†æï¼ˆAnalyzerï¼‰  
    â”œâ”€â†’ æŸ¥è¯¢ä¼˜åŒ–ï¼ˆOptimizerï¼‰â† CTEå¤„ç†åœ¨è¿™é‡Œ
    â”œâ”€â†’ æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
    â”œâ”€â†’ æ‰§è¡Œå¼•æ“æ‰§è¡Œ
    â””â”€â†’ è¿”å›ç»“æœ

CTEå¤„ç†çš„å…·ä½“æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯†åˆ«CTEå®šä¹‰                       â”‚
â”‚ 2. åˆ†æCTEä¾èµ–å…³ç³»                   â”‚
â”‚ 3. å†³å®šç‰©åŒ–ç­–ç•¥                     â”‚
â”‚ 4. ç”ŸæˆCTEæ‰§è¡Œå­è®¡åˆ’                 â”‚
â”‚ 5. æ•´åˆåˆ°ä¸»æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ä¸­             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æ‰§è¡Œè®¡åˆ’æŸ¥çœ‹æ–¹æ³•


**ğŸ”§ å„æ•°æ®åº“çš„æ‰§è¡Œè®¡åˆ’æŸ¥çœ‹**

```sql
-- MySQL/PostgreSQL
EXPLAIN (ANALYZE, BUFFERS) 
WITH sales_summary AS (
    SELECT product_id, SUM(amount) as total_sales
    FROM orders 
    WHERE order_date >= '2024-01-01'
    GROUP BY product_id
)
SELECT p.name, s.total_sales
FROM products p
JOIN sales_summary s ON p.id = s.product_id;

-- SQL Server  
SET SHOWPLAN_ALL ON;
WITH sales_summary AS (...)
SELECT ...;

-- Oracle
EXPLAIN PLAN FOR
WITH sales_summary AS (...)
SELECT ...;
SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);
```

> **ğŸ’¡ å…³é”®ç†è§£**ï¼šæ‰§è¡Œè®¡åˆ’æ˜¯æ•°æ®åº“ä¼˜åŒ–å™¨ä¸ºä½ çš„SQLé€‰æ‹©çš„"æœ€ä½³"æ‰§è¡Œè·¯å¾„ï¼Œç†è§£æ‰§è¡Œè®¡åˆ’å°±æ˜¯ç†è§£æ•°æ®åº“å¦‚ä½•æ€è€ƒå’Œå·¥ä½œçš„ã€‚

---

## 2. ğŸ“‹ æ‰§è¡Œè®¡åˆ’è§£è¯»æ–¹æ³•


### 2.1 æ‰§è¡Œè®¡åˆ’çš„åŸºæœ¬ç»“æ„


**ğŸ”¸ æ‰§è¡Œè®¡åˆ’çš„ç»„æˆéƒ¨åˆ†**

æŠŠæ‰§è¡Œè®¡åˆ’æƒ³è±¡æˆä¸€ä¸ªå€’ç½®çš„æ ‘çŠ¶å›¾ï¼Œæ ¹èŠ‚ç‚¹æ˜¯æœ€ç»ˆç»“æœï¼Œå¶å­èŠ‚ç‚¹æ˜¯åŸºç¡€è¡¨æ‰«æã€‚

```
å…¸å‹CTEæ‰§è¡Œè®¡åˆ’ç»“æ„ï¼š

                    æœ€ç»ˆç»“æœ
                       â†‘
                   Hash Join
                   â†™      â†˜
            Table Scan    CTE Scan
            (products)    (sales_summary)
                             â†‘
                         Hash Aggregate
                             â†‘
                         Index Scan
                         (orders)
```

**ğŸ“Š æ‰§è¡Œè®¡åˆ’å…³é”®ä¿¡æ¯**

| ä¿¡æ¯ç±»å‹ | **å«ä¹‰** | **é‡è¦æ€§** | **å…³æ³¨è¦ç‚¹** |
|---------|---------|-----------|-------------|
| `æ“ä½œç±»å‹` | `æ‰«æã€è¿æ¥ã€æ’åºç­‰` | `â˜…â˜…â˜…â˜…â˜…` | `æ˜¯å¦ä½¿ç”¨ç´¢å¼•` |
| `è¡Œæ•°é¢„ä¼°` | `ä¼˜åŒ–å™¨é¢„ä¼°çš„å¤„ç†è¡Œæ•°` | `â˜…â˜…â˜…â˜…â˜†` | `é¢„ä¼°æ˜¯å¦å‡†ç¡®` |
| `æˆæœ¬ä¼°ç®—` | `æ“ä½œçš„èµ„æºæ¶ˆè€—ä¼°ç®—` | `â˜…â˜…â˜…â˜†â˜†` | `ç›¸å¯¹æˆæœ¬é«˜ä½` |
| `å®é™…ç»Ÿè®¡` | `çœŸå®çš„æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯` | `â˜…â˜…â˜…â˜…â˜…` | `é¢„ä¼°vså®é™…å·®å¼‚` |

### 2.2 è¯»æ‡‚CTEæ‰§è¡Œè®¡åˆ’


**ğŸ”§ PostgreSQL CTEæ‰§è¡Œè®¡åˆ’ç¤ºä¾‹**

```sql
-- ç¤ºä¾‹æŸ¥è¯¢ï¼šåˆ†æé”€å”®æ•°æ®
WITH monthly_sales AS (
    SELECT 
        DATE_TRUNC('month', order_date) as month,
        product_id,
        SUM(amount) as monthly_total
    FROM orders 
    WHERE order_date >= '2024-01-01'
    GROUP BY DATE_TRUNC('month', order_date), product_id
),
top_products AS (
    SELECT product_id, SUM(monthly_total) as total
    FROM monthly_sales
    GROUP BY product_id
    ORDER BY total DESC
    LIMIT 10
)
SELECT p.name, tp.total
FROM products p
JOIN top_products tp ON p.id = tp.product_id;
```

**æ‰§è¡Œè®¡åˆ’è§£è¯»ï¼š**

```
QUERY PLAN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Hash Join  (cost=1234.56..5678.90 rows=10 width=64)
  Hash Cond: (p.id = tp.product_id)
  CTE monthly_sales
    ->  HashAggregate  (cost=100.00..200.00 rows=1000 width=20)
          Group Key: date_trunc('month'::text, order_date), product_id
          ->  Index Scan using idx_order_date on orders  
              (cost=0.43..150.00 rows=5000 width=16)
              Index Cond: (order_date >= '2024-01-01'::date)
  CTE top_products
    ->  Limit  (cost=300.00..350.00 rows=10 width=12)
          ->  Sort  (cost=300.00..325.00 rows=1000 width=12)
                Sort Key: (sum(monthly_total)) DESC
                ->  HashAggregate  (cost=200.00..275.00 rows=1000 width=12)
                      Group Key: product_id
                      ->  CTE Scan on monthly_sales ms  
                          (cost=0.00..20.00 rows=1000 width=12)
  ->  Seq Scan on products p  (cost=0.00..50.00 rows=2000 width=64)
  ->  Hash  (cost=350.00..350.00 rows=10 width=4)
        ->  CTE Scan on top_products tp  (cost=0.00..350.00 rows=10 width=12)
```

### 2.3 æ‰§è¡Œè®¡åˆ’å…³é”®æŒ‡æ ‡è§£è¯»


**ğŸ“Š æˆæœ¬å’Œæ—¶é—´æŒ‡æ ‡**

```
æˆæœ¬æŒ‡æ ‡è§£è¯»ï¼š

cost=1234.56..5678.90
  â†‘           â†‘
å¯åŠ¨æˆæœ¬    æ€»æˆæœ¬
  â”‚           â”‚
  â”‚           â””â”€â”€ å®Œæˆæ‰€æœ‰æ“ä½œçš„æ€»æˆæœ¬
  â””â”€â”€ å¼€å§‹è¿”å›ç¬¬ä¸€è¡Œæ•°æ®çš„æˆæœ¬

rows=10  â† ä¼˜åŒ–å™¨é¢„ä¼°è¿”å›è¡Œæ•°
width=64 â† é¢„ä¼°æ¯è¡Œçš„å¹³å‡å­—èŠ‚æ•°

å®é™…æ„ä¹‰ï¼š
â€¢ å¯åŠ¨æˆæœ¬é«˜ï¼šæŸ¥è¯¢å¼€å§‹æ…¢ï¼Œé€‚åˆæ‰¹é‡å¤„ç†
â€¢ æ€»æˆæœ¬é«˜ï¼šæ•´ä½“èµ„æºæ¶ˆè€—å¤§ï¼Œéœ€è¦ä¼˜åŒ–
â€¢ è¡Œæ•°é¢„ä¼°ä¸å‡†ï¼šå¯èƒ½å¯¼è‡´é”™è¯¯çš„æ‰§è¡Œç­–ç•¥
```

**ğŸ” æ€§èƒ½åˆ†æè¦ç‚¹**

```
ğŸ“‹ **æ‰§è¡Œè®¡åˆ’åˆ†ææ£€æŸ¥æ¸…å•**
- [ ] CTEæ˜¯å¦è¢«ç‰©åŒ–ï¼ˆçœ‹æ˜¯å¦æœ‰CTE Scanï¼‰
- [ ] æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„ç´¢å¼•ï¼ˆé¿å…å…¨è¡¨æ‰«æï¼‰
- [ ] æˆæœ¬é¢„ä¼°æ˜¯å¦åˆç†ï¼ˆä¸å®é™…æ‰§è¡Œæ—¶é—´å¯¹æ¯”ï¼‰
- [ ] æ˜¯å¦æœ‰ä¸å¿…è¦çš„æ’åºæ“ä½œ
- [ ] è¿æ¥é¡ºåºæ˜¯å¦æœ€ä¼˜
- [ ] å†…å­˜ä½¿ç”¨æ˜¯å¦å……è¶³ï¼ˆé¿å…ç£ç›˜ä¸´æ—¶è¡¨ï¼‰
```

---

## 3. ğŸ”„ ç‰©åŒ–ä¸éç‰©åŒ–ç­–ç•¥


### 3.1 ç‰©åŒ–ç­–ç•¥çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯CTEç‰©åŒ–**

æŠŠCTEç‰©åŒ–æƒ³è±¡æˆåšé¥­æ—¶çš„"å¤‡èœ"è¿‡ç¨‹ï¼š
- **ç‰©åŒ–**ï¼šæå‰æŠŠæ‰€æœ‰èœéƒ½åˆ‡å¥½æ”¾ç›˜å­é‡Œï¼Œåé¢ç›´æ¥ç”¨
- **éç‰©åŒ–**ï¼šæ¯åšä¸€é“èœæ—¶æ‰ç°åˆ‡éœ€è¦çš„èœ

```
ç‰©åŒ–ç­–ç•¥å¯¹æ¯”ï¼š

éç‰©åŒ–ï¼ˆå†…è”å±•å¼€ï¼‰ï¼š
WITH sales AS (SELECT ...)
SELECT * FROM sales WHERE condition1
UNION ALL  
SELECT * FROM sales WHERE condition2
         â†“
å®é™…æ‰§è¡Œï¼šå­æŸ¥è¯¢æ‰§è¡Œ2æ¬¡

ç‰©åŒ–ï¼ˆä¸´æ—¶è¡¨ï¼‰ï¼š
WITH sales AS (SELECT ...)  
SELECT * FROM sales WHERE condition1
UNION ALL
SELECT * FROM sales WHERE condition2
         â†“
å®é™…æ‰§è¡Œï¼šå­æŸ¥è¯¢æ‰§è¡Œ1æ¬¡ï¼Œç»“æœå­˜ä¸´æ—¶è¡¨ï¼Œè¯»å–2æ¬¡
```

### 3.2 æ•°æ®åº“ç‰©åŒ–å†³ç­–æœºåˆ¶


**ğŸ”¸ MySQLç‰©åŒ–å†³ç­–è§„åˆ™**

```sql
-- MySQL CTEç‰©åŒ–å†³ç­–ç¤ºä¾‹

-- æƒ…å†µ1ï¼šCTEåªè¢«å¼•ç”¨ä¸€æ¬¡ â†’ é€šå¸¸éç‰©åŒ–
WITH recent_orders AS (
    SELECT * FROM orders WHERE order_date >= CURDATE()
)
SELECT COUNT(*) FROM recent_orders;
-- æ‰§è¡Œè®¡åˆ’ï¼šç›´æ¥å†…è”å±•å¼€ï¼Œä¸åˆ›å»ºä¸´æ—¶è¡¨

-- æƒ…å†µ2ï¼šCTEè¢«å¼•ç”¨å¤šæ¬¡ â†’ é€šå¸¸ç‰©åŒ–
WITH recent_orders AS (
    SELECT * FROM orders WHERE order_date >= CURDATE()  
)
SELECT COUNT(*) FROM recent_orders
UNION ALL
SELECT AVG(amount) FROM recent_orders;
-- æ‰§è¡Œè®¡åˆ’ï¼šåˆ›å»ºä¸´æ—¶è¡¨å­˜å‚¨CTEç»“æœ

-- æƒ…å†µ3ï¼šå¤æ‚CTE â†’ å¼ºåˆ¶ç‰©åŒ–
WITH RECURSIVE employee_hierarchy AS (
    SELECT id, name, manager_id, 1 as level
    FROM employees WHERE manager_id IS NULL
    UNION ALL
    SELECT e.id, e.name, e.manager_id, eh.level + 1
    FROM employees e
    JOIN employee_hierarchy eh ON e.manager_id = eh.id
)
SELECT * FROM employee_hierarchy;
-- é€’å½’CTEæ€»æ˜¯ç‰©åŒ–
```

### 3.3 æ‰‹åŠ¨æ§åˆ¶ç‰©åŒ–ç­–ç•¥


**ğŸ”§ å¼ºåˆ¶ç‰©åŒ–æ§åˆ¶**

```sql
-- PostgreSQL: ä½¿ç”¨MATERIALIZEDå…³é”®å­—
WITH sales_summary AS MATERIALIZED (
    SELECT product_id, SUM(amount) as total
    FROM orders
    GROUP BY product_id
)
SELECT * FROM sales_summary WHERE total > 1000;

-- å¼ºåˆ¶ä¸ç‰©åŒ–  
WITH sales_summary AS NOT MATERIALIZED (
    SELECT product_id, SUM(amount) as total
    FROM orders
    GROUP BY product_id
)
SELECT * FROM sales_summary WHERE total > 1000;

-- MySQL: é€šè¿‡ä¼˜åŒ–å™¨æç¤ºé—´æ¥æ§åˆ¶
SELECT /*+ USE_INDEX(orders, idx_product_date) */ 
       product_id, SUM(amount)
FROM orders
GROUP BY product_id;
```

### 3.4 ç‰©åŒ–ç­–ç•¥é€‰æ‹©æŒ‡å—


**ğŸ“Š ç‰©åŒ–ç­–ç•¥å†³ç­–æ ‘**

```
ç‰©åŒ–ç­–ç•¥é€‰æ‹©æµç¨‹ï¼š

CTEè¢«å¼•ç”¨æ¬¡æ•°ï¼Ÿ
â”œâ”€ 1æ¬¡ â”€â”€â†’ é€šå¸¸é€‰æ‹©éç‰©åŒ–
â”‚          â””â”€ é™¤éCTEè®¡ç®—éå¸¸å¤æ‚
â”‚
â””â”€ å¤šæ¬¡ â”€â”€â†’ è¿›ä¸€æ­¥åˆ†æ
           â”œâ”€ CTEç»“æœé›†å°(<1000è¡Œ) â”€â”€â†’ ç‰©åŒ–åˆ°å†…å­˜
           â”œâ”€ CTEç»“æœé›†ä¸­(1000-10ä¸‡è¡Œ) â”€â”€â†’ ç‰©åŒ–åˆ°ä¸´æ—¶è¡¨
           â””â”€ CTEç»“æœé›†å¤§(>10ä¸‡è¡Œ) â”€â”€â†’ è€ƒè™‘é‡å†™æŸ¥è¯¢

CTEè®¡ç®—å¤æ‚åº¦ï¼Ÿ
â”œâ”€ ç®€å•è¿‡æ»¤ â”€â”€â†’ éç‰©åŒ–ï¼Œç›´æ¥å†…è”
â”œâ”€ å¤æ‚èšåˆ â”€â”€â†’ ç‰©åŒ–ï¼Œé¿å…é‡å¤è®¡ç®—  
â””â”€ é€’å½’è®¡ç®— â”€â”€â†’ å¿…é¡»ç‰©åŒ–
```

> **ğŸ’¡ å…³é”®ç†è§£**ï¼šç‰©åŒ–å°±æ˜¯"ç©ºé—´æ¢æ—¶é—´"çš„ç­–ç•¥ã€‚å½“CTEè¢«å¤šæ¬¡ä½¿ç”¨ä¸”è®¡ç®—æˆæœ¬è¾ƒé«˜æ—¶ï¼Œä¸€æ¬¡è®¡ç®—å¤šæ¬¡ä½¿ç”¨æ¯”æ¯æ¬¡é‡æ–°è®¡ç®—æ›´åˆ’ç®—ã€‚

---

## 4. ğŸ’° æˆæœ¬è¯„ä¼°æœºåˆ¶


### 4.1 æ•°æ®åº“æˆæœ¬æ¨¡å‹


**ğŸ”¸ æˆæœ¬è®¡ç®—çš„åŸºæœ¬åŸç†**

æ•°æ®åº“çš„æˆæœ¬è¯„ä¼°å°±åƒæ˜¯å¿«é€’å…¬å¸è®¡ç®—è¿è´¹ï¼šè¦è€ƒè™‘è·ç¦»ï¼ˆI/Oæ¬¡æ•°ï¼‰ã€é‡é‡ï¼ˆæ•°æ®é‡ï¼‰ã€æ—¶é—´ï¼ˆCPUå¤„ç†æ—¶é—´ï¼‰ç­‰å¤šä¸ªå› ç´ ã€‚

```
æ•°æ®åº“æˆæœ¬è®¡ç®—å…¬å¼ï¼š

æ€»æˆæœ¬ = I/Oæˆæœ¬ + CPUæˆæœ¬ + å†…å­˜æˆæœ¬

å…¶ä¸­ï¼š
I/Oæˆæœ¬ = é¡µé¢è¯»å–æ¬¡æ•° Ã— æ¯æ¬¡I/Oæˆæœ¬
CPUæˆæœ¬ = å¤„ç†è¡Œæ•° Ã— æ¯è¡Œå¤„ç†æˆæœ¬  
å†…å­˜æˆæœ¬ = å†…å­˜åˆ†é…å¤§å° Ã— å†…å­˜æˆæœ¬ç³»æ•°

å…¸å‹æˆæœ¬æƒé‡ï¼ˆç›¸å¯¹å€¼ï¼‰ï¼š
éšæœºI/Oï¼š    10.0
é¡ºåºI/Oï¼š     1.0  
CPUå¤„ç†ï¼š     0.1
å†…å­˜åˆ†é…ï¼š    0.01
```

### 4.2 CTEæˆæœ¬è¯„ä¼°å®ä¾‹


**ğŸ”§ CTEæˆæœ¬åˆ†æç¤ºä¾‹**

```sql
-- åˆ†æè¿™ä¸ªCTEçš„æ‰§è¡Œæˆæœ¬
EXPLAIN (ANALYZE, BUFFERS, COSTS)
WITH product_stats AS (
    SELECT 
        product_id,
        COUNT(*) as order_count,
        SUM(amount) as total_amount,
        AVG(amount) as avg_amount
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    WHERE o.order_date BETWEEN '2024-01-01' AND '2024-12-31'
    GROUP BY product_id
    HAVING COUNT(*) > 100
)
SELECT 
    p.name,
    ps.order_count,
    ps.total_amount,
    ps.avg_amount
FROM products p
JOIN product_stats ps ON p.id = ps.product_id
ORDER BY ps.total_amount DESC;
```

**æ‰§è¡Œè®¡åˆ’æˆæœ¬è§£è¯»ï¼š**

```
QUERY PLAN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Sort (cost=2156.89..2159.39 rows=1000 width=32) 
     (actual time=45.123..45.567 rows=850 loops=1)
  Sort Key: ps.total_amount DESC
  Sort Method: quicksort  Memory: 89kB
  Buffers: shared hit=1234 read=567
  ->  Hash Join (cost=1456.78..1789.12 rows=1000 width=32)
               (actual time=12.345..23.456 rows=850 loops=1)
        Hash Cond: (p.id = ps.product_id)
        Buffers: shared hit=1134 read=467
        ->  Seq Scan on products p (cost=0.00..45.00 rows=2000 width=20)
                                  (actual time=0.012..0.234 rows=2000 loops=1)
              Buffers: shared hit=34
        ->  Hash (cost=1234.56..1234.56 rows=1000 width=12)
                  (actual time=11.234..11.234 rows=850 loops=1)
              Buckets: 1024  Batches: 1  Memory Usage: 67kB
              Buffers: shared hit=1100 read=467
              ->  CTE Scan on product_stats ps (cost=0.00..1234.56 rows=1000 width=12)
                                               (actual time=0.123..8.456 rows=850 loops=1)
                    Buffers: shared hit=1100 read=467
```

### 4.3 æˆæœ¬é¢„ä¼°å‡†ç¡®æ€§åˆ†æ


**ğŸ“Š é¢„ä¼°vså®é™…å¯¹æ¯”**

```
æˆæœ¬é¢„ä¼°åˆ†æè¦ç‚¹ï¼š

è¡Œæ•°é¢„ä¼°å‡†ç¡®æ€§ï¼š
é¢„ä¼°ï¼š1000è¡Œ  å®é™…ï¼š850è¡Œ  
åå·®ï¼š17.6%   è¯„ä¼°ï¼šå¯æ¥å—èŒƒå›´å†…

æ—¶é—´é¢„ä¼°å‡†ç¡®æ€§ï¼š  
é¢„ä¼°æˆæœ¬ï¼š2159.39  å®é™…æ—¶é—´ï¼š45.567ms
å¦‚æœæˆæœ¬å•ä½=0.02msï¼Œé¢„ä¼°æ—¶é—´=43.19ms
åå·®ï¼š5.5%   è¯„ä¼°ï¼šé¢„ä¼°ç›¸å½“å‡†ç¡®

ç¼“å†²åŒºä½¿ç”¨ï¼š
shared hit=1234ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
read=567ï¼ˆç£ç›˜è¯»å–ï¼‰
ç¼“å­˜å‘½ä¸­ç‡=68.5%ï¼ˆè¾ƒå¥½ï¼‰
```

> **ğŸ” æ·±å…¥åˆ†æ**ï¼šå½“é¢„ä¼°è¡Œæ•°ä¸å®é™…è¡Œæ•°å·®å¼‚å¾ˆå¤§æ—¶ï¼ˆè¶…è¿‡50%ï¼‰ï¼Œè¯´æ˜ç»Ÿè®¡ä¿¡æ¯å¯èƒ½è¿‡æ—¶ï¼Œéœ€è¦æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯ã€‚

**ğŸ”§ ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**

```sql
-- MySQLæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE orders, products;

-- PostgreSQLæ›´æ–°ç»Ÿè®¡ä¿¡æ¯  
ANALYZE orders;
ANALYZE products;

-- SQL Serveræ›´æ–°ç»Ÿè®¡ä¿¡æ¯
UPDATE STATISTICS orders;
UPDATE STATISTICS products;
```

---

## 5. ğŸ§  ä¼˜åŒ–å™¨å†³ç­–è¿‡ç¨‹


### 5.1 ä¼˜åŒ–å™¨çš„æ€è€ƒè¿‡ç¨‹


**ğŸ”¸ ä¼˜åŒ–å™¨å¦‚ä½•é€‰æ‹©CTEç­–ç•¥**

æ•°æ®åº“ä¼˜åŒ–å™¨å°±åƒæ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„é¡¹ç›®ç»ç†ï¼Œè¦åœ¨å¤šä¸ªæ–¹æ¡ˆä¸­é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œç­–ç•¥ã€‚

```
ä¼˜åŒ–å™¨å†³ç­–æµç¨‹ï¼š

1. åˆ†æé˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ è§£æCTEå®šä¹‰å’Œå¼•ç”¨å…³ç³»             â”‚
â”‚ â€¢ æ”¶é›†è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆè¡Œæ•°ã€ç´¢å¼•ç­‰ï¼‰    â”‚  
â”‚ â€¢ åˆ†ææŸ¥è¯¢æ¡ä»¶çš„é€‰æ‹©æ€§              â”‚
â”‚ â€¢ è¯„ä¼°å¯ç”¨å†…å­˜å’Œç³»ç»Ÿèµ„æº            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
2. ç­–ç•¥ç”Ÿæˆé˜¶æ®µ  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆå¤šä¸ªå¯èƒ½çš„æ‰§è¡Œç­–ç•¥ï¼š             â”‚
â”‚ â€¢ ç­–ç•¥Aï¼šCTEå†…è”å±•å¼€                â”‚
â”‚ â€¢ ç­–ç•¥Bï¼šCTEç‰©åŒ–ä¸ºå†…å­˜ä¸´æ—¶è¡¨        â”‚  
â”‚ â€¢ ç­–ç•¥Cï¼šCTEç‰©åŒ–ä¸ºç£ç›˜ä¸´æ—¶è¡¨        â”‚
â”‚ â€¢ ç­–ç•¥Dï¼šCTEéƒ¨åˆ†ç‰©åŒ–               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
3. æˆæœ¬è¯„ä¼°é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹æ¯ä¸ªç­–ç•¥è®¡ç®—æˆæœ¬ï¼š                â”‚
â”‚ â€¢ I/Oæˆæœ¬ï¼šç£ç›˜è¯»å†™æ¬¡æ•°             â”‚
â”‚ â€¢ CPUæˆæœ¬ï¼šæ•°æ®å¤„ç†å’Œè®¡ç®—é‡         â”‚
â”‚ â€¢ å†…å­˜æˆæœ¬ï¼šä¸´æ—¶è¡¨å’Œç¼“å†²åŒºä½¿ç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“  
4. æœ€ä¼˜é€‰æ‹©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©æ€»æˆæœ¬æœ€ä½çš„æ‰§è¡Œç­–ç•¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å½±å“ä¼˜åŒ–å™¨å†³ç­–çš„å…³é”®å› ç´ 


**ğŸ“Š å†³ç­–å› ç´ æƒé‡åˆ†æ**

```
CTEå¼•ç”¨æ¬¡æ•°çš„å½±å“ï¼š

å¼•ç”¨1æ¬¡ï¼š
å†…è”æˆæœ¬ = å­æŸ¥è¯¢æ‰§è¡Œæˆæœ¬ Ã— 1
ç‰©åŒ–æˆæœ¬ = ç‰©åŒ–åˆ›å»ºæˆæœ¬ + è¯»å–æˆæœ¬ Ã— 1
é€šå¸¸é€‰æ‹©ï¼šå†…è”ï¼ˆæˆæœ¬æ›´ä½ï¼‰

å¼•ç”¨3æ¬¡ï¼š  
å†…è”æˆæœ¬ = å­æŸ¥è¯¢æ‰§è¡Œæˆæœ¬ Ã— 3
ç‰©åŒ–æˆæœ¬ = ç‰©åŒ–åˆ›å»ºæˆæœ¬ + è¯»å–æˆæœ¬ Ã— 3
é€‰æ‹©å–å†³äºï¼šå­æŸ¥è¯¢å¤æ‚åº¦

å¼•ç”¨10æ¬¡ï¼š
å†…è”æˆæœ¬ = å­æŸ¥è¯¢æ‰§è¡Œæˆæœ¬ Ã— 10  
ç‰©åŒ–æˆæœ¬ = ç‰©åŒ–åˆ›å»ºæˆæœ¬ + è¯»å–æˆæœ¬ Ã— 10
é€šå¸¸é€‰æ‹©ï¼šç‰©åŒ–ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
```

**ğŸ”§ ä¼˜åŒ–å™¨æç¤ºæ§åˆ¶**

```sql
-- PostgreSQL: å½±å“ä¼˜åŒ–å™¨å†³ç­–
SET work_mem = '256MB';  -- å¢å¤§å·¥ä½œå†…å­˜ï¼Œå€¾å‘äºå†…å­˜æ“ä½œ
SET random_page_cost = 1.1;  -- é™ä½éšæœºI/Oæˆæœ¬æƒé‡

-- MySQL: ä¼˜åŒ–å™¨æç¤º
SELECT /*+ 
    USE_INDEX(orders idx_order_date)
    HASH_JOIN(products, product_stats)
*/ 
p.name, ps.total
FROM products p
JOIN product_stats ps ON p.id = ps.product_id;

-- SQL Server: æŸ¥è¯¢æç¤º
WITH product_stats AS (
    SELECT product_id, SUM(amount) as total
    FROM orders WITH(INDEX(ix_order_date))
    GROUP BY product_id
)
SELECT * FROM product_stats
OPTION (HASH JOIN, MAXDOP 4);
```

### 5.3 é€’å½’CTEçš„ç‰¹æ®Šå¤„ç†


**ğŸ”¸ é€’å½’CTEæ‰§è¡Œæœºåˆ¶**

é€’å½’CTEå°±åƒæ˜¯çˆ¬æ¥¼æ¢¯ï¼Œæ¯æ¬¡åªèƒ½ä»å½“å‰å±‚çˆ¬åˆ°ä¸‹ä¸€å±‚ï¼Œéœ€è¦è®°ä½æ¯ä¸€å±‚çš„çŠ¶æ€ã€‚

```sql
-- é€’å½’CTEç¤ºä¾‹ï¼šç»„ç»‡æ¶æ„å±‚çº§
WITH RECURSIVE org_hierarchy AS (
    -- åŸºç¡€æŸ¥è¯¢ï¼ˆç¬¬0å±‚ï¼‰
    SELECT 
        employee_id, 
        name, 
        manager_id,
        0 as level,
        CAST(name AS VARCHAR(1000)) as path
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼ˆç¬¬1,2,3...å±‚ï¼‰
    SELECT 
        e.employee_id,
        e.name, 
        e.manager_id,
        oh.level + 1,
        CONCAT(oh.path, ' -> ', e.name)
    FROM employees e
    JOIN org_hierarchy oh ON e.manager_id = oh.employee_id
    WHERE oh.level < 10  -- é˜²æ­¢æ— é™é€’å½’
)
SELECT level, name, path 
FROM org_hierarchy 
ORDER BY level, name;
```

**é€’å½’CTEæ‰§è¡Œè¿‡ç¨‹ï¼š**

```
é€’å½’CTEæ‰§è¡Œæµç¨‹ï¼š

åˆå§‹åŒ–é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡ŒåŸºç¡€æŸ¥è¯¢                    â”‚
â”‚ ç»“æœå­˜å…¥å·¥ä½œè¡¨ï¼ˆWorking Tableï¼‰ â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
è¿­ä»£é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ ç¬¬1è½®ï¼šç”¨å·¥ä½œè¡¨ + åŸºè¡¨ åšJOIN   â”‚
â”‚ ç¬¬2è½®ï¼šç”¨æ–°ç»“æœ + åŸºè¡¨ åšJOIN   â”‚
â”‚ ...                             â”‚
â”‚ ç›´åˆ°æ²¡æœ‰æ–°è®°å½•äº§ç”Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
ç»“æŸé˜¶æ®µï¼š  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆå¹¶æ‰€æœ‰è½®æ¬¡ç»“æœ                â”‚
â”‚ è¿”å›æœ€ç»ˆç»“æœé›†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜ä½¿ç”¨æ¨¡å¼ï¼š
è½®æ¬¡1: [åŸºç¡€æ•°æ®]
è½®æ¬¡2: [åŸºç¡€æ•°æ®] + [ç¬¬1å±‚ç»“æœ]  
è½®æ¬¡3: [åŸºç¡€æ•°æ®] + [ç¬¬1å±‚ç»“æœ] + [ç¬¬2å±‚ç»“æœ]
...
```

> **âš ï¸ é‡è¦æé†’**ï¼šé€’å½’CTEå¿…é¡»è®¾ç½®é€’å½’æ·±åº¦é™åˆ¶ï¼Œé˜²æ­¢æ— é™é€’å½’å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ã€‚

---

## 6. ğŸ”§ æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æŠ€å·§


### 6.1 ç´¢å¼•å¯¹CTEæ‰§è¡Œçš„å½±å“


**ğŸ”¸ CTEä¸­çš„ç´¢å¼•åˆ©ç”¨**

CTEä¸­çš„ç´¢å¼•ä½¿ç”¨å°±åƒæ˜¯åœ¨å›¾ä¹¦é¦†æ‰¾ä¹¦ï¼Œæœ‰ç›®å½•ç´¢å¼•èƒ½å¿«é€Ÿå®šä½ï¼Œæ²¡æœ‰å°±åªèƒ½ä¸€æœ¬æœ¬ç¿»ã€‚

```sql
-- ç¤ºä¾‹ï¼šåˆ†æCTEä¸­çš„ç´¢å¼•ä½¿ç”¨
EXPLAIN (ANALYZE, BUFFERS)
WITH high_value_orders AS (
    SELECT 
        customer_id,
        order_date,
        SUM(amount) as total_amount
    FROM orders 
    WHERE order_date >= '2024-01-01'  -- è¿™é‡Œèƒ½ç”¨åˆ°æ—¥æœŸç´¢å¼•
      AND status = 'completed'        -- è¿™é‡Œèƒ½ç”¨åˆ°çŠ¶æ€ç´¢å¼•
    GROUP BY customer_id, order_date
    HAVING SUM(amount) > 1000
)
SELECT 
    c.name,
    hvo.order_date,
    hvo.total_amount
FROM customers c
JOIN high_value_orders hvo ON c.id = hvo.customer_id;

-- ä¼˜åŒ–å‰æ‰§è¡Œè®¡åˆ’åˆ†æ
Filter: ((orders.order_date >= '2024-01-01'::date) AND (orders.status = 'completed'::text))
->  Seq Scan on orders  -- å…¨è¡¨æ‰«æï¼æ€§èƒ½å·®
    (cost=0.00..50000.00 rows=100000 width=24)

-- ä¼˜åŒ–ï¼šåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_orders_date_status ON orders(order_date, status);

-- ä¼˜åŒ–åæ‰§è¡Œè®¡åˆ’
Index Scan using idx_orders_date_status on orders  -- ä½¿ç”¨ç´¢å¼•ï¼
    (cost=0.56..1234.78 rows=5000 width=24)
    Index Cond: ((order_date >= '2024-01-01'::date) AND (status = 'completed'::text))
```

### 6.2 CTEè¿æ¥é¡ºåºä¼˜åŒ–


**ğŸ”¸ å¤šè¡¨è¿æ¥çš„é¡ºåºå½±å“**

```sql
-- ä½æ•ˆçš„CTEè¿æ¥é¡ºåº
WITH order_details AS (
    SELECT 
        o.id,
        o.customer_id,
        oi.product_id,
        oi.quantity,
        p.price
    FROM orders o                    -- å¤§è¡¨ï¼š100ä¸‡è¡Œ
    JOIN order_items oi ON o.id = oi.order_id  -- å¤§è¡¨ï¼š500ä¸‡è¡Œ  
    JOIN products p ON oi.product_id = p.id    -- å°è¡¨ï¼š1ä¸‡è¡Œ
    WHERE o.order_date >= '2024-01-01'
)
SELECT * FROM order_details WHERE customer_id = 12345;

-- ä¼˜åŒ–ï¼šè°ƒæ•´è¿æ¥é¡ºåºå’Œç­–ç•¥
WITH order_details AS (
    SELECT 
        o.id,
        o.customer_id, 
        oi.product_id,
        oi.quantity,
        p.price
    FROM products p                  -- å°è¡¨å…ˆè¿‡æ»¤
    JOIN order_items oi ON p.id = oi.product_id
    JOIN orders o ON oi.order_id = o.id
    WHERE o.order_date >= '2024-01-01'
      AND o.customer_id = 12345      -- æ—©æœŸè¿‡æ»¤
)
SELECT * FROM order_details;
```

### 6.3 æ•°æ®ç±»å‹å’Œå‡½æ•°ä¼˜åŒ–


**ğŸ”¸ æ•°æ®ç±»å‹è½¬æ¢çš„å½±å“**

```sql
-- âŒ ä½æ•ˆï¼šéšå¼ç±»å‹è½¬æ¢
WITH monthly_sales AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') as month,  -- å­—ç¬¦ä¸²æ ¼å¼åŒ–
        SUM(amount) as total
    FROM orders
    WHERE YEAR(order_date) = 2024  -- å‡½æ•°åŒ…è£¹åˆ—ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
)
SELECT * FROM monthly_sales;

-- âœ… é«˜æ•ˆï¼šé¿å…ç±»å‹è½¬æ¢å’Œå‡½æ•°åŒ…è£¹
WITH monthly_sales AS (
    SELECT 
        DATE_TRUNC('month', order_date) as month,  -- ä¿æŒæ—¥æœŸç±»å‹
        SUM(amount) as total
    FROM orders  
    WHERE order_date >= '2024-01-01'              -- ç›´æ¥èŒƒå›´æ¯”è¾ƒ
      AND order_date < '2025-01-01'
    GROUP BY DATE_TRUNC('month', order_date)
)
SELECT * FROM monthly_sales;
```

**æ€§èƒ½å¯¹æ¯”ï¼š**

| å†™æ³• | **ç´¢å¼•ä½¿ç”¨** | **æ‰§è¡Œæ—¶é—´** | **æ‰«æè¡Œæ•°** |
|------|-------------|-------------|-------------|
| `YEAR(order_date) = 2024` | `âŒ æ— æ³•ä½¿ç”¨` | `2.5ç§’` | `å…¨è¡¨100ä¸‡è¡Œ` |
| `order_date >= '2024-01-01'` | `âœ… å¯ä»¥ä½¿ç”¨` | `0.1ç§’` | `ç´¢å¼•æ‰«æ30ä¸‡è¡Œ` |

---

## 7. ğŸ” æ€§èƒ½ç“¶é¢ˆè¯†åˆ«


### 7.1 å¸¸è§æ€§èƒ½ç“¶é¢ˆç±»å‹


**ğŸ”¸ CTEæ€§èƒ½ç“¶é¢ˆåˆ†ç±»**

```
ç“¶é¢ˆç±»å‹è¯†åˆ«æŒ‡å—ï¼š

ğŸ”¸ è®¡ç®—ç“¶é¢ˆ
ç—‡çŠ¶ï¼šCPUä½¿ç”¨ç‡é«˜ï¼ŒI/Oç­‰å¾…ä½
è¡¨ç°ï¼šå¤æ‚çš„èšåˆã€å­—ç¬¦ä¸²å¤„ç†ã€æ•°å­¦è¿ç®—
ä½ç½®ï¼šGROUP BYã€å¤æ‚è¡¨è¾¾å¼ã€å‡½æ•°è°ƒç”¨

ğŸ”¸ I/Oç“¶é¢ˆ  
ç—‡çŠ¶ï¼šI/Oç­‰å¾…æ—¶é—´é•¿ï¼ŒCPUä½¿ç”¨ç‡ä½
è¡¨ç°ï¼šå¤§é‡å…¨è¡¨æ‰«æï¼Œé¢‘ç¹ç£ç›˜è¯»å†™
ä½ç½®ï¼šWHEREæ¡ä»¶æ²¡æœ‰ç´¢å¼•ï¼Œå¤§è¡¨è¿æ¥

ğŸ”¸ å†…å­˜ç“¶é¢ˆ
ç—‡çŠ¶ï¼šä¸´æ—¶è¡¨æº¢å‡ºåˆ°ç£ç›˜ï¼Œswapä½¿ç”¨é«˜
è¡¨ç°ï¼šå¤§ç»“æœé›†æ’åºï¼Œå¤§è¡¨HASHè¿æ¥  
ä½ç½®ï¼šORDER BYã€GROUP BYã€JOINæ“ä½œ

ğŸ”¸ é”ç«äº‰ç“¶é¢ˆ
ç—‡çŠ¶ï¼šç­‰å¾…æ—¶é—´é•¿ï¼Œå¹¶å‘åº¦ä¸‹é™
è¡¨ç°ï¼šå¤šä¸ªä¼šè¯ç­‰å¾…ç›¸åŒèµ„æº
ä½ç½®ï¼šçƒ­ç‚¹æ•°æ®è®¿é—®ï¼Œé•¿äº‹åŠ¡
```

### 7.2 ç“¶é¢ˆå®šä½æ–¹æ³•


**ğŸ› ï¸ ç³»ç»Ÿå±‚é¢ç“¶é¢ˆåˆ†æ**

```bash
# 1. CPUç“¶é¢ˆæ£€æµ‹
top -p $(pgrep mysql)
# å…³æ³¨ï¼š%CPUæ˜¯å¦æŒç»­>80%

# 2. I/Oç“¶é¢ˆæ£€æµ‹  
iostat -x 1
# å…³æ³¨ï¼š%utilæ˜¯å¦>90%, awaitæ—¶é—´

# 3. å†…å­˜ç“¶é¢ˆæ£€æµ‹
free -h
vmstat 1
# å…³æ³¨ï¼šswapä½¿ç”¨æƒ…å†µï¼Œå†…å­˜å¯ç”¨é‡

# 4. æ•°æ®åº“å±‚é¢åˆ†æ
mysql> SHOW PROCESSLIST;
mysql> SHOW ENGINE INNODB STATUS;
```

**ğŸ” SQLçº§åˆ«ç“¶é¢ˆåˆ†æ**

```sql
-- MySQL: åˆ†ææ‰§è¡Œæ—¶é—´åˆ†å¸ƒ
SET profiling = 1;
WITH sales_analysis AS (...)
SELECT * FROM sales_analysis;
SHOW PROFILES;
SHOW PROFILE FOR QUERY 1;

-- PostgreSQL: è¯¦ç»†æ‰§è¡Œåˆ†æ
EXPLAIN (ANALYZE, BUFFERS, TIMING, SUMMARY)
WITH sales_analysis AS (...)
SELECT * FROM sales_analysis;

-- å…³æ³¨çš„å…³é”®æŒ‡æ ‡ï¼š
-- 1. æ‰§è¡Œæ—¶é—´åˆ†å¸ƒï¼šå“ªä¸ªæ­¥éª¤æœ€è€—æ—¶ï¼Ÿ
-- 2. ç¼“å†²åŒºå‘½ä¸­ç‡ï¼šæ•°æ®æ˜¯å¦åœ¨å†…å­˜ä¸­ï¼Ÿ
-- 3. ä¸´æ—¶è¡¨ä½¿ç”¨ï¼šæ˜¯å¦æœ‰ç£ç›˜ä¸´æ—¶è¡¨ï¼Ÿ
-- 4. é”ç­‰å¾…æ—¶é—´ï¼šæ˜¯å¦å­˜åœ¨é”ç«äº‰ï¼Ÿ
```

### 7.3 ç“¶é¢ˆè§£å†³ç­–ç•¥


**ğŸ¯ é’ˆå¯¹æ€§ä¼˜åŒ–æ–¹æ¡ˆ**

```
ç“¶é¢ˆç±»å‹ â†’ è§£å†³ç­–ç•¥ï¼š

ğŸ”¸ è®¡ç®—ç“¶é¢ˆè§£å†³ï¼š
â€¢ ç®€åŒ–è®¡ç®—é€»è¾‘ï¼šé¿å…å¤æ‚å‡½æ•°å’Œè¡¨è¾¾å¼
â€¢ é¢„å…ˆè®¡ç®—ï¼šå°†å¤æ‚è®¡ç®—ç§»åˆ°ETLé˜¶æ®µ  
â€¢ å¹¶è¡Œè®¡ç®—ï¼šåˆ©ç”¨å¤šæ ¸CPUå¹¶è¡Œå¤„ç†
â€¢ ç¡¬ä»¶å‡çº§ï¼šä½¿ç”¨æ›´å¿«çš„CPU

ğŸ”¸ I/Oç“¶é¢ˆè§£å†³ï¼š
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼šä¸ºCTEæ¶‰åŠçš„åˆ—åˆ›å»ºåˆé€‚ç´¢å¼•
â€¢ åˆ†åŒºè¡¨ï¼šå‡å°‘æ‰«ææ•°æ®é‡
â€¢ SSDå‡çº§ï¼šæå‡éšæœºI/Oæ€§èƒ½
â€¢ è¯»å†™åˆ†ç¦»ï¼šå¯¼å…¥å¯¼å‡ºæ“ä½œä½¿ç”¨åªè¯»å‰¯æœ¬

ğŸ”¸ å†…å­˜ç“¶é¢ˆè§£å†³ï¼š
â€¢ å¢åŠ å†…å­˜ï¼šæå‡work_memç­‰å‚æ•°
â€¢ åˆ†æ‰¹å¤„ç†ï¼šå°†å¤§CTEæ‹†åˆ†æˆå¤šä¸ªå°CTE  
â€¢ æµå¼å¤„ç†ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§ç»“æœé›†
â€¢ å‹ç¼©ç®—æ³•ï¼šå‡å°‘å†…å­˜ä¸­æ•°æ®å ç”¨

ğŸ”¸ é”ç«äº‰è§£å†³ï¼š
â€¢ å‡å°‘äº‹åŠ¡æ—¶é—´ï¼šå¿«é€Ÿæäº¤é‡Šæ”¾é”
â€¢ è°ƒæ•´éš”ç¦»çº§åˆ«ï¼šé™ä½é”èŒƒå›´
â€¢ é”™å³°æ‰§è¡Œï¼šé¿å¼€ä¸šåŠ¡é«˜å³°æœŸ
â€¢ åˆ†åº“åˆ†è¡¨ï¼šå‡å°‘çƒ­ç‚¹æ•°æ®ç«äº‰
```

---

## 8. ğŸ“ˆ CTEæ‰§è¡Œè®¡åˆ’å®æˆ˜åˆ†æ


### 8.1 å¤æ‚CTEæ‰§è¡Œè®¡åˆ’æ¡ˆä¾‹


**ğŸ”§ å®é™…ä¸šåŠ¡åœºæ™¯åˆ†æ**

```sql
-- å¤æ‚çš„é”€å”®åˆ†æCTE
WITH 
-- CTE1: å®¢æˆ·åˆ†çº§
customer_levels AS (
    SELECT 
        customer_id,
        CASE 
            WHEN total_spent > 10000 THEN 'VIP'
            WHEN total_spent > 5000 THEN 'Gold'  
            WHEN total_spent > 1000 THEN 'Silver'
            ELSE 'Bronze'
        END as level
    FROM (
        SELECT customer_id, SUM(amount) as total_spent
        FROM orders
        WHERE order_date >= '2023-01-01'
        GROUP BY customer_id
    ) customer_spending
),
-- CTE2: äº§å“é”€é‡ç»Ÿè®¡
product_performance AS (
    SELECT 
        p.id,
        p.name,
        p.category,
        COUNT(oi.id) as sales_count,
        SUM(oi.quantity * oi.price) as revenue
    FROM products p
    LEFT JOIN order_items oi ON p.id = oi.product_id
    LEFT JOIN orders o ON oi.order_id = o.id
    WHERE o.order_date >= '2024-01-01'
    GROUP BY p.id, p.name, p.category
),
-- CTE3: å®¢æˆ·äº§å“åå¥½
customer_preferences AS (
    SELECT 
        o.customer_id,
        p.category,
        COUNT(*) as purchase_count,
        ROW_NUMBER() OVER (PARTITION BY o.customer_id ORDER BY COUNT(*) DESC) as preference_rank
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    JOIN products p ON oi.product_id = p.id
    WHERE o.order_date >= '2024-01-01'
    GROUP BY o.customer_id, p.category
)
-- ä¸»æŸ¥è¯¢ï¼šç»¼åˆåˆ†æ
SELECT 
    cl.level as customer_level,
    pp.category,
    COUNT(DISTINCT cp.customer_id) as customer_count,
    AVG(pp.revenue) as avg_product_revenue,
    SUM(cp.purchase_count) as total_purchases
FROM customer_levels cl
JOIN customer_preferences cp ON cl.customer_id = cp.customer_id
JOIN product_performance pp ON cp.category = pp.category
WHERE cp.preference_rank <= 3  -- åªçœ‹å‰3ä¸ªåå¥½ç±»åˆ«
GROUP BY cl.level, pp.category
ORDER BY customer_count DESC;
```

### 8.2 æ‰§è¡Œè®¡åˆ’æ·±åº¦åˆ†æ


**ğŸ“Š å¤æ‚æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’è§£è¯»**

```
QUERY PLAN (ç®€åŒ–ç‰ˆæœ¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Sort  (cost=15678.90..15789.12 rows=441 width=64)
  Sort Key: (count(DISTINCT cp.customer_id)) DESC
  CTE customer_levels
    ->  Hash Aggregate  (cost=1234.56..1456.78 rows=2000 width=12)
          Group Key: customer_id
          Filter: ((CASE ... END) IS NOT NULL)  
          ->  Index Scan using idx_orders_date_customer on orders  
              (cost=0.56..1000.00 rows=50000 width=16)
              Index Cond: (order_date >= '2023-01-01'::date)
              
  CTE product_performance  
    ->  Hash Left Join  (cost=2345.67..4567.89 rows=3000 width=48)
          Hash Cond: (p.id = oi.product_id)
          ->  Seq Scan on products p  (cost=0.00..123.45 rows=3000 width=28)
          ->  Hash  (cost=3456.78..3456.78 rows=15000 width=20)
                ->  Hash Join  (cost=567.89..3456.78 rows=15000 width=20)
                      Hash Cond: (oi.order_id = o.id)
                      ->  Seq Scan on order_items oi  (cost=0.00..2000.00 rows=100000 width=16)
                      ->  Hash  (cost=456.78..456.78 rows=5000 width=4) 
                            ->  Index Scan using idx_orders_date on orders o
                                (cost=0.43..456.78 rows=5000 width=4)
                                Index Cond: (order_date >= '2024-01-01'::date)
                                
  CTE customer_preferences
    ->  Window Aggregate  (cost=5678.90..6789.01 rows=8000 width=20)
          ->  Sort  (cost=5678.90..5789.01 rows=8000 width=12)
                Sort Key: customer_id, (count(*)) DESC
                ->  Hash Join  (cost=2345.67..3456.78 rows=8000 width=12)
                      Hash Cond: (oi.product_id = p.id)
                      ->  Hash Join  (cost=1234.56..2345.67 rows=8000 width=8)
                            Hash Cond: (o.id = oi.order_id)
                            ->  Index Scan using idx_orders_date on orders o
                            ->  Hash  (...)
                      ->  Hash  (cost=123.45..123.45 rows=3000 width=8)
                            ->  Seq Scan on products p
```

### 8.3 æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–å®ä¾‹


**ğŸ”§ é’ˆå¯¹æ€§ä¼˜åŒ–æ”¹è¿›**

```sql
-- ä¼˜åŒ–å‰çš„é—®é¢˜åˆ†æï¼š
-- 1. product_performanceä¸­çš„LEFT JOINå¯èƒ½ä¸å¿…è¦
-- 2. customer_preferencesçš„æ’åºå¼€é”€å¾ˆå¤§
-- 3. å¤šä¸ªCTEä¹‹é—´å¯èƒ½æœ‰é‡å¤è®¡ç®—

-- ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šç®€åŒ–CTEé€»è¾‘
WITH 
customer_levels AS (
    SELECT 
        customer_id,
        CASE 
            WHEN SUM(amount) > 10000 THEN 'VIP'
            WHEN SUM(amount) > 5000 THEN 'Gold'
            WHEN SUM(amount) > 1000 THEN 'Silver'
            ELSE 'Bronze'
        END as level
    FROM orders
    WHERE order_date >= '2023-01-01'
    GROUP BY customer_id
),
-- ç®€åŒ–äº§å“ç»Ÿè®¡ï¼Œå»é™¤LEFT JOIN
product_stats AS (
    SELECT 
        p.id, p.name, p.category,
        COUNT(oi.id) as sales_count,
        SUM(oi.quantity * oi.price) as revenue
    FROM products p
    JOIN order_items oi ON p.id = oi.product_id
    JOIN orders o ON oi.order_id = o.id  
    WHERE o.order_date >= '2024-01-01'
    GROUP BY p.id, p.name, p.category
)
-- ä¸»æŸ¥è¯¢ç›´æ¥è¿æ¥ï¼Œé¿å…å¤æ‚çš„customer_preferences
SELECT 
    cl.level,
    ps.category,
    COUNT(DISTINCT o.customer_id) as customer_count,
    AVG(ps.revenue) as avg_revenue
FROM customer_levels cl
JOIN orders o ON cl.customer_id = o.customer_id
JOIN order_items oi ON o.id = oi.order_id  
JOIN product_stats ps ON oi.product_id = ps.id
WHERE o.order_date >= '2024-01-01'
GROUP BY cl.level, ps.category;
```

---

## 9. âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


### 9.1 CTEæ€§èƒ½é—®é¢˜è¯Šæ–­


**ğŸ”¸ é—®é¢˜è¯Šæ–­æµç¨‹å›¾**

```
CTEæ€§èƒ½é—®é¢˜è¯Šæ–­æµç¨‹ï¼š

æ€§èƒ½æ…¢ï¼Ÿ
    â”œâ”€â†’ æ£€æŸ¥æ‰§è¡Œè®¡åˆ’
    â”‚   â”œâ”€â†’ æ˜¯å¦å…¨è¡¨æ‰«æï¼Ÿ â”€â†’ æ·»åŠ ç´¢å¼•
    â”‚   â”œâ”€â†’ æ˜¯å¦ç‰©åŒ–åˆ°ç£ç›˜ï¼Ÿ â”€â†’ å¢åŠ å†…å­˜  
    â”‚   â””â”€â†’ æ˜¯å¦é‡å¤è®¡ç®—ï¼Ÿ â”€â†’ å¼ºåˆ¶ç‰©åŒ–
    â”‚
    â”œâ”€â†’ æ£€æŸ¥ç³»ç»Ÿèµ„æº
    â”‚   â”œâ”€â†’ CPUå ç”¨é«˜ï¼Ÿ â”€â†’ ç®€åŒ–è®¡ç®—é€»è¾‘
    â”‚   â”œâ”€â†’ å†…å­˜ä¸è¶³ï¼Ÿ â”€â†’ åˆ†æ‰¹å¤„ç†
    â”‚   â””â”€â†’ I/Oç­‰å¾…é«˜ï¼Ÿ â”€â†’ ç´¢å¼•ä¼˜åŒ–
    â”‚  
    â””â”€â†’ æ£€æŸ¥æ•°æ®åˆ†å¸ƒ
        â”œâ”€â†’ æ•°æ®å€¾æ–œï¼Ÿ â”€â†’ é‡æ–°åˆ†åŒº
        â””â”€â†’ ç»Ÿè®¡è¿‡æ—¶ï¼Ÿ â”€â†’ æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
```

### 9.2 å…¸å‹é—®é¢˜è§£å†³æ¡ˆä¾‹


**ğŸ”§ æ¡ˆä¾‹1ï¼šCTEé‡å¤è®¡ç®—é—®é¢˜**

```sql
-- é—®é¢˜SQLï¼šCTEè¢«å¤šæ¬¡å¼•ç”¨ä½†æœªç‰©åŒ–
WITH expensive_calculation AS (
    SELECT 
        customer_id,
        -- å¤æ‚è®¡ç®—ï¼šå®¢æˆ·ä»·å€¼è¯„åˆ†
        (
            SELECT SUM(amount * 0.1) 
            FROM orders o2 
            WHERE o2.customer_id = o1.customer_id
        ) as value_score
    FROM orders o1
    GROUP BY customer_id
)
SELECT 'high_value', COUNT(*) FROM expensive_calculation WHERE value_score > 1000
UNION ALL
SELECT 'medium_value', COUNT(*) FROM expensive_calculation WHERE value_score BETWEEN 500 AND 1000  
UNION ALL
SELECT 'low_value', COUNT(*) FROM expensive_calculation WHERE value_score < 500;

-- é—®é¢˜åˆ†æï¼šexpensive_calculationè¢«æ‰§è¡Œ3æ¬¡ï¼

-- è§£å†³æ–¹æ¡ˆï¼šå¼ºåˆ¶ç‰©åŒ–
CREATE TEMPORARY TABLE temp_customer_values AS
WITH expensive_calculation AS (...)
SELECT customer_id, value_score FROM expensive_calculation;

-- ç„¶åä½¿ç”¨ä¸´æ—¶è¡¨
SELECT 'high_value', COUNT(*) FROM temp_customer_values WHERE value_score > 1000
UNION ALL  
SELECT 'medium_value', COUNT(*) FROM temp_customer_values WHERE value_score BETWEEN 500 AND 1000
UNION ALL
SELECT 'low_value', COUNT(*) FROM temp_customer_values WHERE value_score < 500;

DROP TEMPORARY TABLE temp_customer_values;
```

**ğŸ”§ æ¡ˆä¾‹2ï¼šå¤§CTEå†…å­˜æº¢å‡ºé—®é¢˜**

```sql
-- é—®é¢˜ï¼šå¤§ç»“æœé›†CTEå¯¼è‡´å†…å­˜ä¸è¶³
WITH large_dataset AS (
    SELECT 
        o.*,
        c.name,
        c.address,
        p.name as product_name,
        p.description
    FROM orders o
    JOIN customers c ON o.customer_id = c.id
    JOIN order_items oi ON o.id = oi.order_id
    JOIN products p ON oi.product_id = p.id
    WHERE o.order_date >= '2020-01-01'  -- 5å¹´æ•°æ®ï¼
)
SELECT * FROM large_dataset WHERE customer_id IN (SELECT id FROM vip_customers);

-- æ‰§è¡Œè®¡åˆ’æ˜¾ç¤ºï¼š
-- Work_mem exceeded, using disk-based hash table

-- è§£å†³æ–¹æ¡ˆ1ï¼šå¢åŠ å†…å­˜
SET work_mem = '512MB';

-- è§£å†³æ–¹æ¡ˆ2ï¼šé‡å†™æŸ¥è¯¢ï¼Œé¿å…å¤§CTE
SELECT 
    o.*,
    c.name,
    c.address, 
    p.name as product_name
FROM orders o
JOIN customers c ON o.customer_id = c.id
JOIN order_items oi ON o.id = oi.order_id  
JOIN products p ON oi.product_id = p.id
WHERE o.order_date >= '2020-01-01'
  AND o.customer_id IN (SELECT id FROM vip_customers);
-- è®©ä¼˜åŒ–å™¨ç›´æ¥å¤„ç†è¿æ¥ï¼Œé¿å…ä¸­é—´å¤§ç»“æœé›†
```

### 9.3 é€’å½’CTEæ€§èƒ½é—®é¢˜


**ğŸ”¸ é€’å½’æ·±åº¦æ§åˆ¶**

```sql
-- é—®é¢˜ï¼šé€’å½’CTEå¯èƒ½æ— é™é€’å½’æˆ–å±‚æ¬¡è¿‡æ·±
WITH RECURSIVE org_tree AS (
    SELECT employee_id, name, manager_id, 0 as level
    FROM employees  
    WHERE manager_id IS NULL
    
    UNION ALL
    
    SELECT e.employee_id, e.name, e.manager_id, o.level + 1
    FROM employees e
    JOIN org_tree o ON e.manager_id = o.employee_id
    -- ç¼ºå°‘é€’å½’æ·±åº¦é™åˆ¶ï¼
)
SELECT * FROM org_tree;

-- è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ é€’å½’é™åˆ¶å’Œç›‘æ§
WITH RECURSIVE org_tree AS (
    SELECT 
        employee_id, 
        name, 
        manager_id, 
        0 as level,
        ARRAY[employee_id] as path  -- è®°å½•è·¯å¾„ï¼Œæ£€æµ‹å¾ªç¯
    FROM employees  
    WHERE manager_id IS NULL
    
    UNION ALL
    
    SELECT 
        e.employee_id,
        e.name, 
        e.manager_id,
        o.level + 1,
        o.path || e.employee_id
    FROM employees e
    JOIN org_tree o ON e.manager_id = o.employee_id
    WHERE o.level < 20  -- é™åˆ¶æœ€å¤§æ·±åº¦
      AND NOT (e.employee_id = ANY(o.path))  -- é˜²æ­¢å¾ªç¯å¼•ç”¨
)
SELECT level, COUNT(*) as employee_count
FROM org_tree  
GROUP BY level
ORDER BY level;
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰§è¡Œè®¡åˆ’æœ¬è´¨ï¼šæ•°æ®åº“ä¼˜åŒ–å™¨é€‰æ‹©çš„æœ€ä¼˜æ‰§è¡Œè·¯å¾„
ğŸ”¸ ç‰©åŒ–ç­–ç•¥ï¼šCTEç»“æœæ˜¯å­˜å‚¨ï¼ˆç‰©åŒ–ï¼‰è¿˜æ˜¯é‡å¤è®¡ç®—ï¼ˆå†…è”ï¼‰
ğŸ”¸ æˆæœ¬æ¨¡å‹ï¼šåŸºäºI/Oã€CPUã€å†…å­˜æˆæœ¬çš„ç»¼åˆè¯„ä¼°ä½“ç³»
ğŸ”¸ ä¼˜åŒ–å™¨å†³ç­–ï¼šåŸºäºç»Ÿè®¡ä¿¡æ¯å’Œæˆæœ¬æ¨¡å‹çš„è‡ªåŠ¨ä¼˜åŒ–é€‰æ‹©
ğŸ”¸ ç“¶é¢ˆè¯†åˆ«ï¼šé€šè¿‡æ‰§è¡Œè®¡åˆ’å®šä½æ€§èƒ½é—®é¢˜çš„æ ¹æœ¬åŸå› 
ğŸ”¸ ä¼˜åŒ–æŠ€å·§ï¼šç´¢å¼•ã€å†…å­˜ã€é‡å†™æŸ¥è¯¢ç­‰å¤šç»´åº¦ä¼˜åŒ–æ–¹æ³•
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦åˆ†æCTEæ‰§è¡Œè®¡åˆ’**
```
å®é™…ä»·å€¼ï¼š
â€¢ å‘ç°æ€§èƒ½ç“¶é¢ˆï¼šæ‰¾åˆ°æŸ¥è¯¢æ…¢çš„çœŸæ­£åŸå› 
â€¢ éªŒè¯ä¼˜åŒ–æ•ˆæœï¼šç¡®è®¤ä¼˜åŒ–æ˜¯å¦æœ‰æ•ˆ  
â€¢ é¢„é˜²æ€§èƒ½é—®é¢˜ï¼šåœ¨ä¸Šçº¿å‰å‘ç°æ½œåœ¨é—®é¢˜
â€¢ æŒ‡å¯¼ç´¢å¼•è®¾è®¡ï¼šçŸ¥é“éœ€è¦åœ¨å“ªäº›åˆ—ä¸Šå»ºç´¢å¼•

å…·ä½“è¡¨ç°ï¼š
æŸ¥è¯¢ä»30ç§’ä¼˜åŒ–åˆ°3ç§’ â”€â”€â†’ é€šè¿‡åˆ†æå‘ç°ç¼ºå°‘ç´¢å¼•
å†…å­˜ä½¿ç”¨ä»2GBé™åˆ°200MB â”€â”€â†’ é€šè¿‡åˆ†æå‘ç°å¯ä»¥é¿å…ç‰©åŒ–
CPUå ç”¨ä»90%é™åˆ°30% â”€â”€â†’ é€šè¿‡åˆ†æå‘ç°å¯ä»¥ç®€åŒ–è®¡ç®—
```

**ğŸ”¹ ç‰©åŒ–å†³ç­–çš„å½±å“å› ç´ **
```
å†³ç­–å› ç´ æƒé‡ï¼š
CTEå¼•ç”¨æ¬¡æ•°     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 90% ï¼ˆæœ€é‡è¦ï¼‰
CTEç»“æœé›†å¤§å°   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     70%
è®¡ç®—å¤æ‚åº¦      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       60%
å¯ç”¨å†…å­˜        â–ˆâ–ˆâ–ˆâ–ˆ         40%
å¹¶å‘æŸ¥è¯¢æ•°é‡    â–ˆâ–ˆ           20%

å†³ç­–é€»è¾‘ï¼š
å¼•ç”¨1æ¬¡ + ç®€å•è®¡ç®— = ä¸ç‰©åŒ–
å¼•ç”¨3æ¬¡ + å¤æ‚èšåˆ = ç‰©åŒ–åˆ°å†…å­˜  
å¼•ç”¨5æ¬¡ + å¤§ç»“æœé›† = ç‰©åŒ–åˆ°ç£ç›˜
```

**ğŸ”¹ æˆæœ¬é¢„ä¼°çš„å‡†ç¡®æ€§é—®é¢˜**
```
å½±å“é¢„ä¼°å‡†ç¡®æ€§çš„å› ç´ ï¼š
â€¢ ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶ï¼šANALYZEæ›´æ–°é¢‘ç‡
â€¢ æ•°æ®åˆ†å¸ƒä¸å‡ï¼šçƒ­ç‚¹æ•°æ®vså†·æ•°æ®  
â€¢ ç³»ç»Ÿè´Ÿè½½å˜åŒ–ï¼šé«˜å³°æœŸvsä½å³°æœŸ
â€¢ ç¡¬ä»¶æ€§èƒ½å·®å¼‚ï¼šSSD vs æœºæ¢°ç¡¬ç›˜

æé«˜é¢„ä¼°å‡†ç¡®æ€§çš„æ–¹æ³•ï¼š
â€¢ å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
â€¢ ä½¿ç”¨ç›´æ–¹å›¾ç»Ÿè®¡ï¼ˆå¦‚æœæ”¯æŒï¼‰
â€¢ è€ƒè™‘ç³»ç»Ÿè´Ÿè½½å› å­
â€¢ æµ‹è¯•ä¸åŒç¡¬ä»¶é…ç½®
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ CTEæ‰§è¡Œè®¡åˆ’ä¼˜åŒ–æ­¥éª¤**

```
ğŸš€ **æ ‡å‡†ä¼˜åŒ–æµç¨‹**

ç¬¬1æ­¥ï¼šè·å–åŸºå‡†æ•°æ®
â”œâ”€â”€ è®°å½•å½“å‰æ‰§è¡Œæ—¶é—´
â”œâ”€â”€ æŸ¥çœ‹å½“å‰æ‰§è¡Œè®¡åˆ’
â””â”€â”€ è®°å½•èµ„æºä½¿ç”¨æƒ…å†µ

ç¬¬2æ­¥ï¼šæ‰§è¡Œè®¡åˆ’åˆ†æ  
â”œâ”€â”€ è¯†åˆ«æœ€è€—æ—¶çš„æ“ä½œ
â”œâ”€â”€ æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
â”œâ”€â”€ åˆ†æCTEç‰©åŒ–ç­–ç•¥
â””â”€â”€ æ‰¾å‡ºèµ„æºç“¶é¢ˆ

ç¬¬3æ­¥ï¼šåˆ¶å®šä¼˜åŒ–ç­–ç•¥
â”œâ”€â”€ ç´¢å¼•ä¼˜åŒ–ï¼šåˆ›å»ºç¼ºå¤±çš„ç´¢å¼•
â”œâ”€â”€ æŸ¥è¯¢é‡å†™ï¼šç®€åŒ–å¤æ‚é€»è¾‘
â”œâ”€â”€ å‚æ•°è°ƒæ•´ï¼šå†…å­˜ã€å¹¶è¡Œåº¦ç­‰
â””â”€â”€ å¼ºåˆ¶æç¤ºï¼šæ§åˆ¶æ‰§è¡Œç­–ç•¥

ç¬¬4æ­¥ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ
â”œâ”€â”€ å¯¹æ¯”ä¼˜åŒ–å‰åæ‰§è¡Œæ—¶é—´
â”œâ”€â”€ æ£€æŸ¥èµ„æºä½¿ç”¨æ”¹å–„æƒ…å†µ  
â”œâ”€â”€ éªŒè¯ç»“æœæ­£ç¡®æ€§
â””â”€â”€ ç›‘æ§ç”Ÿäº§ç¯å¢ƒè¡¨ç°
```

**ğŸ“Š ä¼˜åŒ–æ•ˆæœè¯„ä¼°æ ‡å‡†**

```
ä¼˜åŒ–æˆåŠŸçš„åˆ¤æ–­æ ‡å‡†ï¼š

æ€§èƒ½æ”¹å–„æŒ‡æ ‡ï¼š
æ‰§è¡Œæ—¶é—´å‡å°‘ â‰¥ 30%     âœ… æ˜¾è‘—æ”¹å–„
CPUä½¿ç”¨é™ä½ â‰¥ 20%     âœ… èµ„æºä¼˜åŒ–æœ‰æ•ˆ
å†…å­˜ä½¿ç”¨ä¼˜åŒ– â‰¥ 25%     âœ… å†…å­˜åˆ©ç”¨æ›´åˆç†
I/Oæ¬¡æ•°å‡å°‘ â‰¥ 40%      âœ… ç´¢å¼•ä¼˜åŒ–æˆåŠŸ

ç¨³å®šæ€§æŒ‡æ ‡ï¼š
æ‰§è¡Œæ—¶é—´ç¨³å®šæ€§        âœ… æ³¢åŠ¨ < 20%
èµ„æºä½¿ç”¨å¯é¢„æµ‹æ€§      âœ… æ— å¼‚å¸¸å³°å€¼  
é”™è¯¯ç‡ä¿æŒä¸º0         âœ… ä¼˜åŒ–æœªå¼•å…¥Bug
```

**ğŸ› ï¸ å®ç”¨å·¥å…·æ¨è**

```
CTEæ‰§è¡Œè®¡åˆ’åˆ†æå·¥å…·ï¼š

ğŸ“Š å›¾å½¢åŒ–å·¥å…·ï¼š
â€¢ MySQL Workbenchï¼šå¯è§†åŒ–æ‰§è¡Œè®¡åˆ’
â€¢ pgAdminï¼šPostgreSQLæ‰§è¡Œè®¡åˆ’å›¾å½¢å±•ç¤º
â€¢ SQL Server Management Studioï¼šè¯¦ç»†æ‰§è¡Œè®¡åˆ’

ğŸ“ˆ ç›‘æ§å·¥å…·ï¼š
â€¢ MySQL: Performance Schema
â€¢ PostgreSQL: pg_stat_statements  
â€¢ SQL Server: Query Store

ğŸ”§ åˆ†æè„šæœ¬ï¼š
â€¢ è‡ªåŠ¨åŒ–æ‰§è¡Œè®¡åˆ’æ”¶é›†è„šæœ¬
â€¢ æ€§èƒ½å¯¹æ¯”åˆ†æè„šæœ¬
â€¢ èµ„æºä½¿ç”¨ç›‘æ§è„šæœ¬
```

**ğŸ§  è®°å¿†æŠ€å·§**

```
ğŸµ **CTEæ‰§è¡Œè®¡åˆ’åˆ†æå£è¯€**
"çœ‹è®¡åˆ’å…ˆçœ‹ç´¢å¼•ç”¨æ²¡ç”¨ï¼Œ
 æŸ¥æˆæœ¬å…³æ³¨I/Oå’ŒCPUï¼Œ
 å¤šå¼•ç”¨è€ƒè™‘è¦ä¸è¦ç‰©åŒ–ï¼Œ
 é€’å½’æ·±åº¦ä¸€å®šè¦æ§åˆ¶ã€‚"

ğŸ·ï¸ **å…³é”®è®°å¿†è¯**
`EXPLAIN` `ç‰©åŒ–` `æˆæœ¬` `ç´¢å¼•` `ç“¶é¢ˆ`

ğŸ“ **åˆ†æè¦ç‚¹è®°å¿†**
SCANï¼ˆæ‰«æï¼‰â†’ çœ‹ç´¢å¼•
COSTï¼ˆæˆæœ¬ï¼‰â†’ çœ‹åˆç†æ€§  
ROWSï¼ˆè¡Œæ•°ï¼‰â†’ çœ‹é¢„ä¼°å‡†ç¡®æ€§
TIMEï¼ˆæ—¶é—´ï¼‰â†’ çœ‹ç“¶é¢ˆä½ç½®
```

### 10.4 é«˜çº§ä¼˜åŒ–æŠ€å·§


**ğŸ¯ ä¼ä¸šçº§CTEæ€§èƒ½ä¼˜åŒ–**

```sql
-- é«˜çº§ä¼˜åŒ–æŠ€å·§ç¤ºä¾‹ï¼šåˆ†åŒºCTE
WITH RECURSIVE monthly_hierarchy AS (
    SELECT 
        month_partition,
        employee_id,
        manager_id,
        level
    FROM employees_partitioned
    WHERE month_partition = '2024-08'  -- åˆ©ç”¨åˆ†åŒºå‰ªæ
      AND manager_id IS NULL
    
    UNION ALL
    
    SELECT 
        ep.month_partition,
        ep.employee_id, 
        ep.manager_id,
        mh.level + 1
    FROM employees_partitioned ep
    JOIN monthly_hierarchy mh 
      ON ep.manager_id = mh.employee_id 
     AND ep.month_partition = mh.month_partition  -- åˆ†åŒºè¿æ¥
    WHERE mh.level < 10
)
SELECT * FROM monthly_hierarchy;

-- ä¼˜åŠ¿ï¼š
-- 1. åˆ†åŒºå‰ªæå‡å°‘æ‰«ææ•°æ®é‡
-- 2. åˆ†åŒºè¿æ¥æå‡JOINæ€§èƒ½
-- 3. é€’å½’æ·±åº¦æ§åˆ¶é¿å…æ— é™é€’å½’
```

**ğŸ“ˆ æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ**

```
ğŸ”¸ CTEè®¾è®¡æœ€ä½³å®è·µ
â€¢ é¿å…åœ¨CTEä¸­ä½¿ç”¨SELECT *
â€¢ å°½æ—©è¿‡æ»¤æ•°æ®ï¼ˆWHEREæ¡ä»¶å‰ç½®ï¼‰
â€¢ åˆç†ä½¿ç”¨GROUP BYå’Œèšåˆå‡½æ•°
â€¢ é¿å…åœ¨CTEä¸­è¿›è¡Œå¤æ‚è®¡ç®—

ğŸ”¸ æ‰§è¡Œè®¡åˆ’åˆ†ææœ€ä½³å®è·µ  
â€¢ ä½¿ç”¨ANALYZEè·å–çœŸå®æ‰§è¡Œç»Ÿè®¡
â€¢ å¯¹æ¯”ä¸åŒæ–¹æ¡ˆçš„æ‰§è¡Œè®¡åˆ’
â€¢ å…³æ³¨æˆæœ¬æœ€é«˜çš„æ“ä½œèŠ‚ç‚¹
â€¢ éªŒè¯ç»Ÿè®¡ä¿¡æ¯çš„å‡†ç¡®æ€§

ğŸ”¸ æ€§èƒ½ç›‘æ§æœ€ä½³å®è·µ
â€¢ å»ºç«‹æ‰§è¡Œæ—¶é—´åŸºå‡†
â€¢ ç›‘æ§èµ„æºä½¿ç”¨è¶‹åŠ¿  
â€¢ è®¾ç½®æ€§èƒ½å‘Šè­¦é˜ˆå€¼
â€¢ å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
```

### 10.5 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ’¼ ä¼ä¸šå®æˆ˜ç»éªŒ**

```
å¤§å‹ä¼ä¸šCTEæ€§èƒ½ä¼˜åŒ–å®æˆ˜æ€»ç»“ï¼š

ğŸ”¸ æ•°æ®é‡çº§åˆ«çš„ä¼˜åŒ–ç­–ç•¥
å°æ•°æ®é‡ï¼ˆ<10ä¸‡è¡Œï¼‰ï¼š
- é‡ç‚¹å…³æ³¨ç´¢å¼•ä½¿ç”¨
- ç®€åŒ–CTEé€»è¾‘
- é¢„æœŸæ”¹å–„ï¼š50-200%

ä¸­æ•°æ®é‡ï¼ˆ10ä¸‡-100ä¸‡è¡Œï¼‰ï¼š
- é‡ç‚¹å…³æ³¨ç‰©åŒ–ç­–ç•¥
- å†…å­˜å‚æ•°è°ƒä¼˜
- é¢„æœŸæ”¹å–„ï¼š100-500%

å¤§æ•°æ®é‡ï¼ˆ>100ä¸‡è¡Œï¼‰ï¼š
- é‡ç‚¹å…³æ³¨åˆ†åŒºå’Œåˆ†æ‰¹
- è€ƒè™‘é‡å†™ä¸ºå¤šæ­¥éª¤å¤„ç†
- é¢„æœŸæ”¹å–„ï¼š200-1000%

ğŸ”¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹
â€¢ åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
â€¢ ç›‘æ§ä¼˜åŒ–åçš„ç¨³å®šæ€§
â€¢ å‡†å¤‡å›æ»šæ–¹æ¡ˆ
â€¢ æ–‡æ¡£åŒ–ä¼˜åŒ–è¿‡ç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- CTEæ‰§è¡Œè®¡åˆ’åˆ†ææ˜¯SQLä¼˜åŒ–çš„æ ¸å¿ƒæŠ€èƒ½
- ç‰©åŒ–ç­–ç•¥ç›´æ¥å½±å“æŸ¥è¯¢æ€§èƒ½å’Œèµ„æºä½¿ç”¨
- æˆæœ¬è¯„ä¼°å¸®åŠ©ç†è§£ä¼˜åŒ–å™¨çš„é€‰æ‹©é€»è¾‘
- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«éœ€è¦ç»“åˆæ‰§è¡Œè®¡åˆ’å’Œç³»ç»Ÿç›‘æ§
- ä¼˜åŒ–æ˜¯ä¸ªæŒç»­è¿‡ç¨‹ï¼Œéœ€è¦ä¸æ–­ç›‘æ§å’Œè°ƒæ•´