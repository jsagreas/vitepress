---
title: 2ã€é€’å½’CTEå®ç°
---
## ğŸ“š ç›®å½•

1. [é€’å½’CTEåŸºæœ¬æ¦‚å¿µ](#1-é€’å½’CTEåŸºæœ¬æ¦‚å¿µ)
2. [é€’å½’CTEè¯­æ³•ç»“æ„](#2-é€’å½’CTEè¯­æ³•ç»“æ„)
3. [é”šç‚¹æŸ¥è¯¢ä¸é€’å½’æŸ¥è¯¢](#3-é”šç‚¹æŸ¥è¯¢ä¸é€’å½’æŸ¥è¯¢)
4. [é€’å½’ç»ˆæ­¢æ¡ä»¶æœºåˆ¶](#4-é€’å½’ç»ˆæ­¢æ¡ä»¶æœºåˆ¶)
5. [å±‚æ¬¡æ•°æ®éå†å®æˆ˜](#5-å±‚æ¬¡æ•°æ®éå†å®æˆ˜)
6. [é€’å½’æ·±åº¦æ§åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–](#6-é€’å½’æ·±åº¦æ§åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–)
7. [é€’å½’CTEè®¾è®¡åŸåˆ™](#7-é€’å½’CTEè®¾è®¡åŸåˆ™)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ é€’å½’CTEåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é€’å½’CTE


**ğŸ”¸ é€’å½’CTEçš„æœ¬è´¨**
```
é€’å½’CTEï¼ˆRecursive Common Table Expressionï¼‰ï¼š
ä¸€ç§èƒ½å¤Ÿå¼•ç”¨è‡ªèº«çš„ä¸´æ—¶è¡¨è¡¨è¾¾å¼

ç®€å•ç†è§£ï¼š
å°±åƒä¿„ç½—æ–¯å¥—å¨ƒï¼Œå¤§å¨ƒå¨ƒé‡Œé¢å¥—ç€å°å¨ƒå¨ƒï¼Œ
å°å¨ƒå¨ƒé‡Œé¢è¿˜å¥—ç€æ›´å°çš„å¨ƒå¨ƒ...
é€’å½’CTEå°±æ˜¯è¿™æ ·ä¸€å±‚å±‚"å¥—"ä¸‹å»å¤„ç†æ•°æ®
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦é€’å½’CTE**

ä¼ ç»ŸSQLé¢ä¸´çš„é—®é¢˜ï¼š
```
å±‚æ¬¡æ•°æ®æŸ¥è¯¢å›°éš¾ï¼š
å‘˜å·¥è¡¨                     æƒ³è¦çš„ç»“æœ
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€ CEO
â”‚ ID â”‚ å§“å  â”‚ ä¸Šçº§ID â”‚    â”œâ”€ éƒ¨é—¨ç»ç†A
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚  â”œâ”€ å‘˜å·¥1  
â”‚ 1  â”‚ CEO  â”‚ NULL   â”‚    â”‚  â””â”€ å‘˜å·¥2
â”‚ 2  â”‚ ç»ç†A â”‚ 1      â”‚    â””â”€ éƒ¨é—¨ç»ç†B
â”‚ 3  â”‚ å‘˜å·¥1 â”‚ 2      â”‚       â”œâ”€ å‘˜å·¥3
â”‚ 4  â”‚ å‘˜å·¥2 â”‚ 2      â”‚       â””â”€ å‘˜å·¥4
â”‚ 5  â”‚ ç»ç†B â”‚ 1      â”‚
â”‚ 6  â”‚ å‘˜å·¥3 â”‚ 5      â”‚
â”‚ 7  â”‚ å‘˜å·¥4 â”‚ 5      â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼ ç»ŸSQLçš„å›°å¢ƒï¼š
- ä¸çŸ¥é“å±‚çº§æœ‰å¤šæ·±
- éœ€è¦å†™å¾ˆå¤šæ¬¡JOIN
- ä»£ç å¤æ‚ä¸”ä¸çµæ´»
```

**ğŸ¯ é€’å½’CTEçš„è§£å†³æ–¹æ¡ˆ**
```
é€’å½’CTEçš„ä¼˜åŠ¿ï¼š
âœ… ä¸€æ¬¡æŸ¥è¯¢æå®šæ‰€æœ‰å±‚çº§
âœ… è‡ªåŠ¨å¤„ç†ä¸ç¡®å®šçš„æ·±åº¦
âœ… ä»£ç ç®€æ´æ¸…æ™°
âœ… æ€§èƒ½ç›¸å¯¹è¾ƒå¥½
```

### 1.2 é€’å½’çš„åŸºæœ¬æ€æƒ³


**ğŸ§  é€’å½’ç®—æ³•æ ¸å¿ƒæ€ç»´**

> ğŸ’¡ **é€’å½’ä¸‰è¦ç´ **ï¼š
> 1. **é€’å½’å‡ºå£**ï¼šä»€ä¹ˆæ—¶å€™åœæ­¢
> 2. **é€’å½’å…¬å¼**ï¼šå¦‚ä½•ä»å½“å‰çŠ¶æ€åˆ°ä¸‹ä¸€çŠ¶æ€  
> 3. **åˆå§‹çŠ¶æ€**ï¼šä»å“ªé‡Œå¼€å§‹

```
æ•°å­¦ä¸­çš„é€’å½’ä¾‹å­ï¼š
é˜¶ä¹˜å‡½æ•° n! = n Ã— (n-1)!
- åˆå§‹çŠ¶æ€ï¼š1! = 1
- é€’å½’å…¬å¼ï¼šn! = n Ã— (n-1)!  
- é€’å½’å‡ºå£ï¼šn = 1æ—¶åœæ­¢

SQLä¸­çš„é€’å½’æ€æƒ³ï¼š
ç»„ç»‡æ¶æ„æŸ¥è¯¢
- åˆå§‹çŠ¶æ€ï¼šæ‰¾åˆ°CEOï¼ˆé¡¶çº§é¢†å¯¼ï¼‰
- é€’å½’å…¬å¼ï¼šæ‰¾åˆ°å½“å‰äººå‘˜çš„æ‰€æœ‰ä¸‹å±
- é€’å½’å‡ºå£ï¼šæ²¡æœ‰ä¸‹å±æ—¶åœæ­¢
```

### 1.3 é€’å½’CTE vs å…¶ä»–æ–¹æ³•


**ğŸ“Š æ–¹æ³•å¯¹æ¯”**

| æ–¹æ³• | **ä»£ç å¤æ‚åº¦** | **æ€§èƒ½** | **çµæ´»æ€§** | **é€‚ç”¨åœºæ™¯** |
|------|---------------|---------|-----------|-------------|
| ğŸ”„ **é€’å½’CTE** | `ç®€æ´æ¸…æ™°` | `è¾ƒå¥½` | `æé«˜` | `å±‚çº§ä¸ç¡®å®šçš„æ ‘å½¢æ•°æ®` |
| ğŸ”— **å¤šæ¬¡JOIN** | `å¤æ‚å†—é•¿` | `ä¸€èˆ¬` | `ä½` | `å±‚çº§å›ºå®šä¸”è¾ƒå°‘` |
| ğŸ’» **ç¨‹åºå¾ªç¯** | `ä¸­ç­‰` | `è¾ƒå·®` | `é«˜` | `å¤æ‚ä¸šåŠ¡é€»è¾‘å¤„ç†` |
| ğŸ“Š **å­˜å‚¨è¿‡ç¨‹** | `å¤æ‚` | `å¥½` | `ä¸­` | `é¢‘ç¹è°ƒç”¨çš„å›ºå®šé€»è¾‘` |

---

## 2. ğŸ“ é€’å½’CTEè¯­æ³•ç»“æ„


### 2.1 æ ‡å‡†è¯­æ³•æ ¼å¼


**ğŸ”¸ é€’å½’CTEå®Œæ•´è¯­æ³•**
```sql
WITH RECURSIVE cte_name (column_list) AS (
    -- é”šç‚¹æŸ¥è¯¢ï¼ˆéé€’å½’éƒ¨åˆ†ï¼‰
    SELECT ...
    FROM ...
    WHERE ...
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼ˆé€’å½’éƒ¨åˆ†ï¼‰
    SELECT ...
    FROM ... 
    JOIN cte_name ON ...  -- è¿™é‡Œå¼•ç”¨è‡ªèº«ï¼
    WHERE ...             -- é€’å½’ç»ˆæ­¢æ¡ä»¶
)
SELECT * FROM cte_name;
```

**ğŸ’¡ è¯­æ³•è¦ç´ è§£é‡Š**

```
â”Œâ”€ WITH RECURSIVEï¼šå£°æ˜è¿™æ˜¯é€’å½’CTE
â”œâ”€ cte_nameï¼šç»™ä¸´æ—¶è¡¨èµ·ä¸ªåå­—
â”œâ”€ column_listï¼šå®šä¹‰åˆ—åï¼ˆå¯é€‰ï¼‰
â”œâ”€ é”šç‚¹æŸ¥è¯¢ï¼šé€’å½’çš„èµ·å§‹ç‚¹
â”œâ”€ UNION ALLï¼šè¿æ¥é”šç‚¹å’Œé€’å½’éƒ¨åˆ†
â”œâ”€ é€’å½’æŸ¥è¯¢ï¼šå¼•ç”¨è‡ªèº«çš„æŸ¥è¯¢
â””â”€ ä¸»æŸ¥è¯¢ï¼šä½¿ç”¨CTEçš„æœ€ç»ˆæŸ¥è¯¢
```

### 2.2 é€’å½’CTEçš„æ‰§è¡Œæµç¨‹


**ğŸ”„ æ‰§è¡Œè¿‡ç¨‹è¯¦è§£**

```
é€’å½’CTEæ‰§è¡Œè¿‡ç¨‹ï¼š

ç¬¬0è½®ï¼ˆé”šç‚¹æŸ¥è¯¢ï¼‰
â”œâ”€ æ‰§è¡Œé”šç‚¹æŸ¥è¯¢
â”œâ”€ ç»“æœå­˜å…¥ä¸´æ—¶è¡¨
â””â”€ è¿™äº›ç»“æœä½œä¸ºä¸‹è½®è¾“å…¥

ç¬¬1è½®ï¼ˆç¬¬ä¸€æ¬¡é€’å½’ï¼‰  
â”œâ”€ ç”¨ç¬¬0è½®ç»“æœæ‰§è¡Œé€’å½’æŸ¥è¯¢
â”œâ”€ æ–°ç»“æœè¿½åŠ åˆ°ä¸´æ—¶è¡¨
â””â”€ æ–°ç»“æœä½œä¸ºä¸‹è½®è¾“å…¥

ç¬¬2è½®ï¼ˆç¬¬äºŒæ¬¡é€’å½’ï¼‰
â”œâ”€ ç”¨ç¬¬1è½®ç»“æœæ‰§è¡Œé€’å½’æŸ¥è¯¢  
â”œâ”€ æ–°ç»“æœç»§ç»­è¿½åŠ 
â””â”€ ...

ç¬¬Nè½®
â”œâ”€ é€’å½’æŸ¥è¯¢è¿”å›ç©ºç»“æœ
â””â”€ é€’å½’ç»“æŸï¼Œè¿”å›å®Œæ•´ä¸´æ—¶è¡¨
```

**ğŸ“Š å¯è§†åŒ–æ‰§è¡Œæµç¨‹**
```
è½®æ¬¡    è¾“å…¥æ•°æ®    â†’    é€’å½’æŸ¥è¯¢    â†’    ç´¯ç§¯ç»“æœ
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0 â”‚ ç©º       â”‚ é”šç‚¹æŸ¥è¯¢     â”‚ [CEO]        â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1 â”‚ [CEO]    â”‚ æ‰¾CEOä¸‹å±    â”‚ [CEO,ç»ç†A,B] â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ 2 â”‚ [ç»ç†A,B] â”‚ æ‰¾ç»ç†ä¸‹å±   â”‚ [æ‰€æœ‰äººå‘˜]    â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3 â”‚ [å‘˜å·¥ä»¬]  â”‚ æ‰¾å‘˜å·¥ä¸‹å±   â”‚ ç©ºç»“æœ       â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†‘
                            é€’å½’ç»“æŸ
```

---

## 3. âš“ é”šç‚¹æŸ¥è¯¢ä¸é€’å½’æŸ¥è¯¢


### 3.1 é”šç‚¹æŸ¥è¯¢ï¼ˆAnchor Queryï¼‰


**ğŸ”¸ é”šç‚¹æŸ¥è¯¢çš„ä½œç”¨**
```
é”šç‚¹æŸ¥è¯¢ = é€’å½’çš„èµ·å§‹ç‚¹
ä½œç”¨ï¼šä¸ºé€’å½’æä¾›åˆå§‹æ•°æ®
ç‰¹ç‚¹ï¼šè¿™æ˜¯æ™®é€šçš„SELECTæŸ¥è¯¢ï¼Œä¸æ¶‰åŠé€’å½’
```

**ğŸ’¡ é”šç‚¹æŸ¥è¯¢è®¾è®¡åŸåˆ™**

> ğŸ“Œ **è®¾è®¡è¦ç‚¹**ï¼š
> - æ‰¾åˆ°é€’å½’çš„"æ ¹èŠ‚ç‚¹"
> - é€šå¸¸æ˜¯é¡¶çº§å…ƒç´ æˆ–èµ·å§‹æ¡ä»¶
> - æŸ¥è¯¢ç»“æœçš„åˆ—ç»“æ„è¦ä¸é€’å½’æŸ¥è¯¢ä¸€è‡´

**ğŸ¯ å¸¸è§é”šç‚¹æŸ¥è¯¢æ¨¡å¼**

```sql
-- æ¨¡å¼1ï¼šæ‰¾æ ¹èŠ‚ç‚¹ï¼ˆçˆ¶IDä¸ºç©ºï¼‰
SELECT id, name, parent_id, 0 as level
FROM employees 
WHERE parent_id IS NULL

-- æ¨¡å¼2ï¼šæŒ‡å®šèµ·å§‹èŠ‚ç‚¹
SELECT id, name, parent_id, 0 as level  
FROM employees
WHERE id = 1  -- ä»ç‰¹å®šå‘˜å·¥å¼€å§‹

-- æ¨¡å¼3ï¼šæ»¡è¶³æ¡ä»¶çš„èµ·å§‹ç‚¹
SELECT id, name, parent_id, 0 as level
FROM employees  
WHERE department = 'IT' AND level = 'Manager'
```

### 3.2 é€’å½’æŸ¥è¯¢ï¼ˆRecursive Queryï¼‰


**ğŸ”¸ é€’å½’æŸ¥è¯¢çš„æ ¸å¿ƒ**
```
é€’å½’æŸ¥è¯¢ = å¦‚ä½•ä»å½“å‰å±‚æ‰¾åˆ°ä¸‹ä¸€å±‚
å…³é”®ï¼šå¿…é¡»å¼•ç”¨CTEè‡ªèº«
ç›®çš„ï¼šåŸºäºå·²æœ‰ç»“æœç»§ç»­æŸ¥æ‰¾
```

**ğŸ”„ é€’å½’æŸ¥è¯¢æ„é€ æ–¹æ³•**

```sql
-- åŸºæœ¬é€’å½’æ¨¡å¼
SELECT 
    e.id,
    e.name, 
    e.parent_id,
    cte.level + 1  -- å±‚çº§åŠ 1
FROM employees e
JOIN cte_name cte ON e.parent_id = cte.id  -- å…³é”®ï¼šå¼•ç”¨è‡ªèº«
WHERE cte.level < 10  -- é€’å½’ç»ˆæ­¢æ¡ä»¶
```

**ğŸ’¡ JOINæ¡ä»¶çš„å«ä¹‰**
```
e.parent_id = cte.id çš„å«ä¹‰ï¼š
- cte.idï¼šå½“å‰è½®æ¬¡å·²æ‰¾åˆ°çš„å‘˜å·¥ID
- e.parent_idï¼šä¸‹ä¸€å±‚å‘˜å·¥çš„ä¸Šçº§ID  
- å…³ç³»ï¼šæ‰¾åˆ°å½“å‰å‘˜å·¥çš„æ‰€æœ‰ç›´æ¥ä¸‹å±

ç¤ºä¾‹ç†è§£ï¼š
å½“å‰è½®æ‰¾åˆ°äº†ï¼š[CEO(id=1)]
é€’å½’æŸ¥è¯¢æ‰§è¡Œï¼š
  SELECT ... FROM employees e 
  JOIN cte ON e.parent_id = cte.id
  -- ç­‰ä»·äºï¼še.parent_id = 1
  -- ç»“æœï¼šæ‰¾åˆ°CEOçš„ç›´æ¥ä¸‹å±[ç»ç†A, ç»ç†B]
```

### 3.3 UNION ALLçš„ä½œç”¨


**ğŸ”¸ ä¸ºä»€ä¹ˆå¿…é¡»ç”¨UNION ALL**

```
UNION ALLçš„ä½œç”¨ï¼š
- å°†é”šç‚¹æŸ¥è¯¢å’Œé€’å½’æŸ¥è¯¢çš„ç»“æœåˆå¹¶
- ä¿ç•™æ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬é‡å¤ï¼‰
- ç´¯ç§¯æ¯è½®é€’å½’çš„ç»“æœ

ä¸ºä»€ä¹ˆä¸ç”¨UNIONï¼š
- UNIONä¼šå»é‡ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®
- UNIONéœ€è¦æ’åºï¼Œå½±å“æ€§èƒ½
- é€’å½’ç»“æœé€šå¸¸ä¸ä¼šé‡å¤
```

**ğŸ“Š UNION ALLæ‰§è¡Œç¤ºæ„**
```
æ‰§è¡Œæµç¨‹ï¼š
é”šç‚¹æŸ¥è¯¢ç»“æœ    é€’å½’æŸ¥è¯¢ç»“æœ    UNION ALLç´¯ç§¯
    [CEO]     +      []       =    [CEO]
    [CEO]     +   [ç»ç†A,B]    =  [CEO,ç»ç†A,B]  
  [ç»ç†A,B]   +  [å‘˜å·¥1,2,3,4] = [CEO,ç»ç†A,B,å‘˜å·¥1,2,3,4]
 [å‘˜å·¥1,2,3,4] +      []       = [æœ€ç»ˆå®Œæ•´ç»“æœ]
```

---

## 4. ğŸ›‘ é€’å½’ç»ˆæ­¢æ¡ä»¶æœºåˆ¶


### 4.1 é€’å½’ç»ˆæ­¢çš„é‡è¦æ€§


**âš ï¸ æ— é™é€’å½’çš„å±é™©**
```
æ²¡æœ‰ç»ˆæ­¢æ¡ä»¶çš„åæœï¼š
- é€’å½’æ°¸è¿œä¸ä¼šåœæ­¢
- æ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æº
- å¯èƒ½å¯¼è‡´æ•°æ®åº“å´©æºƒ
- æŸ¥è¯¢æ°¸è¿œä¸è¿”å›ç»“æœ

æ¯”å–»ç†è§£ï¼š
å°±åƒä¸¤é¢é•œå­ç›¸å¯¹æ”¾ç½®ï¼Œä¼šäº§ç”Ÿæ— é™åå°„
é€’å½’CTEæ²¡æœ‰ç»ˆæ­¢æ¡ä»¶ï¼Œå°±ä¼šæ— é™æ‰§è¡Œä¸‹å»
```

### 4.2 å¸¸è§ç»ˆæ­¢æ¡ä»¶è®¾è®¡


**ğŸ¯ ç»ˆæ­¢æ¡ä»¶è®¾è®¡æ¨¡å¼**

**æ¨¡å¼1ï¼šåŸºäºå±‚çº§æ·±åº¦**
```sql
WITH RECURSIVE employee_tree AS (
    -- é”šç‚¹ï¼šæ‰¾æ ¹èŠ‚ç‚¹
    SELECT id, name, parent_id, 0 as level
    FROM employees WHERE parent_id IS NULL
    
    UNION ALL
    
    -- é€’å½’ï¼šæ‰¾ä¸‹çº§ï¼Œé™åˆ¶å±‚çº§
    SELECT e.id, e.name, e.parent_id, et.level + 1
    FROM employees e
    JOIN employee_tree et ON e.parent_id = et.id
    WHERE et.level < 5  -- ğŸ”¥ ç»ˆæ­¢æ¡ä»¶ï¼šæœ€å¤š5å±‚
)
SELECT * FROM employee_tree;
```

**æ¨¡å¼2ï¼šåŸºäºæ•°æ®æ¡ä»¶**
```sql
WITH RECURSIVE path_finder AS (
    -- é”šç‚¹ï¼šèµ·å§‹ç‚¹
    SELECT id, name, path, 0 as cost
    FROM locations WHERE name = 'èµ·ç‚¹'
    
    UNION ALL
    
    -- é€’å½’ï¼šæ‰¾ç›¸é‚»èŠ‚ç‚¹
    SELECT l.id, l.name, pf.path || '->' || l.name, pf.cost + l.distance
    FROM locations l
    JOIN path_finder pf ON l.from_id = pf.id
    WHERE pf.cost < 1000  -- ğŸ”¥ ç»ˆæ­¢æ¡ä»¶ï¼šæ€»è·ç¦»ä¸è¶…è¿‡1000
      AND l.name != 'èµ·ç‚¹'  -- é˜²æ­¢å›åˆ°èµ·ç‚¹å½¢æˆç¯
)
SELECT * FROM path_finder;
```

**æ¨¡å¼3ï¼šåŸºäºç»“æœåˆ¤æ–­**
```sql
WITH RECURSIVE number_sequence AS (
    -- é”šç‚¹ï¼šèµ·å§‹æ•°å­—
    SELECT 1 as num
    
    UNION ALL
    
    -- é€’å½’ï¼šç”Ÿæˆä¸‹ä¸€ä¸ªæ•°å­—
    SELECT num + 1
    FROM number_sequence
    WHERE num < 100  -- ğŸ”¥ ç»ˆæ­¢æ¡ä»¶ï¼šæ•°å­—ä¸è¶…è¿‡100
)
SELECT * FROM number_sequence;
```

### 4.3 é˜²æ­¢æ— é™é€’å½’çš„ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤æªæ–½**

```sql
-- ç­–ç•¥1ï¼šå¤šé‡ç»ˆæ­¢æ¡ä»¶
WITH RECURSIVE safe_recursion AS (
    SELECT id, parent_id, name, 0 as level, ARRAY[id] as path
    FROM table_name WHERE parent_id IS NULL
    
    UNION ALL
    
    SELECT t.id, t.parent_id, t.name, sr.level + 1, sr.path || t.id
    FROM table_name t
    JOIN safe_recursion sr ON t.parent_id = sr.id
    WHERE sr.level < 20                    -- æ¡ä»¶1ï¼šå±‚çº§é™åˆ¶
      AND NOT t.id = ANY(sr.path)         -- æ¡ä»¶2ï¼šé˜²æ­¢ç¯è·¯
      AND sr.level <= 100                 -- æ¡ä»¶3ï¼šç»å¯¹é™åˆ¶
)
SELECT * FROM safe_recursion;
```

> âš ï¸ **é‡è¦æé†’**ï¼š
> - æ°¸è¿œä¸è¦çœç•¥ç»ˆæ­¢æ¡ä»¶
> - å»ºè®®è®¾ç½®å¤šé‡å®‰å…¨æ£€æŸ¥
> - æµ‹è¯•æ—¶å…ˆç”¨å°æ•°æ®é›†
> - ç”Ÿäº§ç¯å¢ƒè¦è®¾ç½®æŸ¥è¯¢è¶…æ—¶

---

## 5. ğŸŒ³ å±‚æ¬¡æ•°æ®éå†å®æˆ˜


### 5.1 ç»„ç»‡æ¶æ„éå†


**ğŸ¢ å®é™…ä¸šåŠ¡åœºæ™¯**
```
å…¬å¸ç»„ç»‡æ¶æ„è¡¨ï¼š
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    parent_id INT,
    position VARCHAR(50),
    department VARCHAR(50)
);

æ•°æ®ç¤ºä¾‹ï¼š
INSERT INTO employees VALUES
(1, 'å¼ æ€»', NULL, 'CEO', 'æ€»è£åŠ'),
(2, 'æç»ç†', 1, 'éƒ¨é—¨ç»ç†', 'æŠ€æœ¯éƒ¨'),  
(3, 'ç‹ç»ç†', 1, 'éƒ¨é—¨ç»ç†', 'é”€å”®éƒ¨'),
(4, 'èµµå·¥ç¨‹å¸ˆ', 2, 'é«˜çº§å·¥ç¨‹å¸ˆ', 'æŠ€æœ¯éƒ¨'),
(5, 'é’±å·¥ç¨‹å¸ˆ', 2, 'å·¥ç¨‹å¸ˆ', 'æŠ€æœ¯éƒ¨'),
(6, 'å­™é”€å”®', 3, 'é”€å”®ä»£è¡¨', 'é”€å”®éƒ¨');
```

**ğŸ” å®Œæ•´ç»„ç»‡æ¶æ„æŸ¥è¯¢**
```sql
WITH RECURSIVE org_chart AS (
    -- ğŸ¯ é”šç‚¹æŸ¥è¯¢ï¼šæ‰¾åˆ°æœ€é«˜é¢†å¯¼
    SELECT 
        id,
        name,
        parent_id,
        position,
        department,
        0 as level,                           -- å±‚çº§ä»0å¼€å§‹
        CAST(name AS VARCHAR(200)) as path    -- è·¯å¾„è®°å½•
    FROM employees 
    WHERE parent_id IS NULL  -- CEOæ²¡æœ‰ä¸Šçº§
    
    UNION ALL
    
    -- ğŸ”„ é€’å½’æŸ¥è¯¢ï¼šé€å±‚æ‰¾ä¸‹å±
    SELECT 
        e.id,
        e.name,
        e.parent_id,
        e.position,
        e.department,
        oc.level + 1,                         -- å±‚çº§é€’å¢
        oc.path || ' -> ' || e.name           -- è·¯å¾„è¿½åŠ 
    FROM employees e
    JOIN org_chart oc ON e.parent_id = oc.id  -- å…³é”®JOIN
    WHERE oc.level < 10                       -- ğŸ›‘ é˜²æ­¢æ— é™é€’å½’
)
SELECT 
    REPEAT('  ', level) || name as hierarchy_display,  -- ç¼©è¿›æ˜¾ç¤ºå±‚çº§
    level,
    position,
    department,
    path
FROM org_chart
ORDER BY path;
```

**ğŸ“‹ æŸ¥è¯¢ç»“æœç¤ºä¾‹**
```
hierarchy_display    level  position      department  path
å¼ æ€»                 0      CEO          æ€»è£åŠ       å¼ æ€»
  æç»ç†             1      éƒ¨é—¨ç»ç†      æŠ€æœ¯éƒ¨       å¼ æ€» -> æç»ç†
    èµµå·¥ç¨‹å¸ˆ         2      é«˜çº§å·¥ç¨‹å¸ˆ    æŠ€æœ¯éƒ¨       å¼ æ€» -> æç»ç† -> èµµå·¥ç¨‹å¸ˆ
    é’±å·¥ç¨‹å¸ˆ         2      å·¥ç¨‹å¸ˆ        æŠ€æœ¯éƒ¨       å¼ æ€» -> æç»ç† -> é’±å·¥ç¨‹å¸ˆ
  ç‹ç»ç†             1      éƒ¨é—¨ç»ç†      é”€å”®éƒ¨       å¼ æ€» -> ç‹ç»ç†
    å­™é”€å”®           2      é”€å”®ä»£è¡¨      é”€å”®éƒ¨       å¼ æ€» -> ç‹ç»ç† -> å­™é”€å”®
```

### 5.2 æ–‡ä»¶ç³»ç»Ÿç›®å½•éå†


**ğŸ“ æ–‡ä»¶ç³»ç»Ÿåœºæ™¯**
```
ç›®å½•ç»“æ„è¡¨ï¼š
CREATE TABLE directories (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    parent_id INT,
    type ENUM('folder', 'file'),
    size BIGINT
);

ç›®æ ‡ï¼šéå†æ•´ä¸ªç›®å½•æ ‘ï¼Œè®¡ç®—æ¯ä¸ªæ–‡ä»¶å¤¹çš„æ€»å¤§å°
```

**ğŸ” ç›®å½•éå†æŸ¥è¯¢**
```sql
WITH RECURSIVE dir_tree AS (
    -- ğŸ¯ é”šç‚¹ï¼šæ ¹ç›®å½•
    SELECT 
        id,
        name,
        parent_id,
        type,
        size,
        0 as depth,
        CAST('/' || name AS VARCHAR(500)) as full_path
    FROM directories 
    WHERE parent_id IS NULL
    
    UNION ALL
    
    -- ğŸ”„ é€’å½’ï¼šå­ç›®å½•å’Œæ–‡ä»¶
    SELECT 
        d.id,
        d.name,
        d.parent_id,
        d.type,
        d.size,
        dt.depth + 1,
        dt.full_path || '/' || d.name
    FROM directories d
    JOIN dir_tree dt ON d.parent_id = dt.id
    WHERE dt.depth < 20  -- ğŸ›‘ é˜²æ­¢è¿‡æ·±é€’å½’
)
-- ğŸ“Š è®¡ç®—æ¯ä¸ªç›®å½•çš„æ€»å¤§å°
SELECT 
    dt1.id,
    dt1.name,
    dt1.full_path,
    dt1.type,
    CASE 
        WHEN dt1.type = 'file' THEN dt1.size
        ELSE (
            SELECT COALESCE(SUM(dt2.size), 0)
            FROM dir_tree dt2 
            WHERE dt2.full_path LIKE dt1.full_path || '%'
              AND dt2.type = 'file'
        )
    END as total_size
FROM dir_tree dt1
ORDER BY full_path;
```

### 5.3 åˆ†ç±»å±‚çº§éå†


**ğŸ·ï¸ å•†å“åˆ†ç±»åœºæ™¯**
```
å•†å“åˆ†ç±»è¡¨ï¼š
CREATE TABLE categories (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    parent_id INT,
    level_type ENUM('category', 'subcategory', 'item')
);

éœ€æ±‚ï¼š
1. æ˜¾ç¤ºå®Œæ•´çš„åˆ†ç±»å±‚çº§å…³ç³»
2. è®¡ç®—æ¯ä¸ªåˆ†ç±»ä¸‹çš„å•†å“æ•°é‡
3. æ”¯æŒä»ä»»æ„åˆ†ç±»å¼€å§‹éå†
```

**ğŸ” åˆ†ç±»éå†æŸ¥è¯¢**
```sql
WITH RECURSIVE category_tree AS (
    -- ğŸ¯ é”šç‚¹ï¼šæŒ‡å®šèµ·å§‹åˆ†ç±»ï¼ˆå¯ä»¥æ˜¯ä»»æ„å±‚çº§ï¼‰
    SELECT 
        id,
        name,
        parent_id,
        level_type,
        0 as tree_level,
        CAST(id AS VARCHAR(200)) as id_path,
        name as category_path
    FROM categories 
    WHERE id = @start_category_id  -- å‚æ•°ï¼šèµ·å§‹åˆ†ç±»
    
    UNION ALL
    
    -- ğŸ”„ é€’å½’ï¼šæ‰¾å­åˆ†ç±»
    SELECT 
        c.id,
        c.name,
        c.parent_id,
        c.level_type,
        ct.tree_level + 1,
        ct.id_path || ',' || CAST(c.id AS VARCHAR),
        ct.category_path || ' > ' || c.name
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.id
    WHERE ct.tree_level < 8  -- ğŸ›‘ æœ€å¤š8å±‚åˆ†ç±»
)
SELECT 
    id,
    REPEAT('  ', tree_level) || name as display_name,
    tree_level,
    level_type,
    category_path,
    (SELECT COUNT(*) FROM products p WHERE p.category_id = ct.id) as product_count
FROM category_tree ct
ORDER BY id_path;
```

---

## 6. ğŸ“ é€’å½’æ·±åº¦æ§åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–


### 6.1 é€’å½’æ·±åº¦æ§åˆ¶æ–¹æ³•


**ğŸ“Š æ·±åº¦æ§åˆ¶ç­–ç•¥å¯¹æ¯”**

| æ–¹æ³• | **å®ç°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|------|-------------|-------------|-----------|
| ğŸ”¢ **å±‚çº§è®¡æ•°** | `level < N` | `å±‚æ¬¡æ˜ç¡®çš„æ ‘å½¢ç»“æ„` | `ç®€å•ç›´è§‚ï¼Œä½†å¯èƒ½æˆªæ–­æœ‰ç”¨æ•°æ®` |
| ğŸ›¤ï¸ **è·¯å¾„æ£€æµ‹** | `NOT id = ANY(path)` | `å¯èƒ½å­˜åœ¨ç¯è·¯çš„å›¾ç»“æ„` | `å®‰å…¨å¯é ï¼Œä½†æ€§èƒ½å¼€é”€å¤§` |
| ğŸ“Š **æ¡ä»¶é™åˆ¶** | `cost < limit` | `åŸºäºä¸šåŠ¡é€»è¾‘çš„é™åˆ¶` | `çµæ´»å®ç”¨ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚` |
| â±ï¸ **æ—¶é—´é™åˆ¶** | `LIMIT + è¶…æ—¶è®¾ç½®` | `æ€§èƒ½è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯` | `ä¿è¯å“åº”æ—¶é—´ï¼Œä½†å¯èƒ½ç»“æœä¸å®Œæ•´` |

### 6.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**âš¡ å…³é”®ä¼˜åŒ–ç­–ç•¥**

**ä¼˜åŒ–1ï¼šåˆç†è®¾ç½®ç»ˆæ­¢æ¡ä»¶**
```sql
-- âŒ è¿‡äºå®½æ¾çš„æ¡ä»¶
WHERE level < 1000  -- å¯èƒ½æ‰§è¡Œè¿‡å¤šè½®æ¬¡

-- âœ… åˆç†çš„ä¸šåŠ¡é™åˆ¶  
WHERE level < 6     -- ä¸€èˆ¬ç»„ç»‡æ¶æ„ä¸è¶…è¿‡6å±‚
  AND total_cost < 10000  -- ä¸šåŠ¡ä¸Šçš„åˆç†é™åˆ¶
```

**ä¼˜åŒ–2ï¼šç´¢å¼•ä¼˜åŒ–**
```sql
-- ğŸ”¥ ä¸ºé€’å½’æŸ¥è¯¢çš„JOINå­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_parent_id ON employees(parent_id);
CREATE INDEX idx_id_parent ON employees(id, parent_id);

-- å¤åˆç´¢å¼•æ•ˆæœæ›´å¥½
CREATE INDEX idx_recursive ON employees(parent_id, id, name);
```

**ä¼˜åŒ–3ï¼šå‡å°‘è¿”å›åˆ—æ•°**
```sql
-- âŒ è¿”å›è¿‡å¤šä¸å¿…è¦çš„åˆ—
WITH RECURSIVE cte AS (
    SELECT * FROM large_table WHERE parent_id IS NULL  -- æ‰€æœ‰åˆ—
    UNION ALL
    SELECT t.* FROM large_table t JOIN cte ON t.parent_id = cte.id
)

-- âœ… åªè¿”å›å¿…è¦çš„åˆ—
WITH RECURSIVE cte AS (
    SELECT id, parent_id, name FROM large_table WHERE parent_id IS NULL
    UNION ALL  
    SELECT t.id, t.parent_id, t.name FROM large_table t JOIN cte ON t.parent_id = cte.id
)
```

### 6.3 ç›‘æ§é€’å½’æ‰§è¡Œ


**ğŸ“Š ç›‘æ§å’Œè°ƒè¯•æŠ€å·§**

```sql
-- ğŸ” è°ƒè¯•ç‰ˆæœ¬ï¼šæ·»åŠ è°ƒè¯•ä¿¡æ¯
WITH RECURSIVE debug_cte AS (
    SELECT 
        id, name, parent_id, 
        0 as level,
        1 as iteration_count  -- è®°å½•è¿­ä»£æ¬¡æ•°
    FROM employees WHERE parent_id IS NULL
    
    UNION ALL
    
    SELECT 
        e.id, e.name, e.parent_id,
        dc.level + 1,
        dc.iteration_count + 1
    FROM employees e
    JOIN debug_cte dc ON e.parent_id = dc.id
    WHERE dc.level < 10
)
SELECT 
    level,
    COUNT(*) as nodes_at_level,      -- æ¯å±‚èŠ‚ç‚¹æ•°
    MAX(iteration_count) as max_iterations  -- æœ€å¤§è¿­ä»£æ¬¡æ•°
FROM debug_cte
GROUP BY level
ORDER BY level;
```

> ğŸ’¡ **è°ƒè¯•å»ºè®®**ï¼š
> - å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•
> - è§‚å¯Ÿæ¯å±‚çš„èŠ‚ç‚¹æ•°é‡å˜åŒ–
> - æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¼‚å¸¸çš„æ·±å±‚èŠ‚ç‚¹
> - ç¡®è®¤é€’å½’æ˜¯å¦æŒ‰é¢„æœŸç»ˆæ­¢

---

## 7. ğŸ› ï¸ é€’å½’CTEè®¾è®¡åŸåˆ™


### 7.1 é€’å½’CTEè®¾è®¡çš„é»„é‡‘æ³•åˆ™


**ğŸ”‘ æ ¸å¿ƒè®¾è®¡åŸåˆ™**

**åŸåˆ™1ï¼šæ˜ç¡®é€’å½’é€»è¾‘**
```
è®¾è®¡å‰è¦æ˜ç¡®ï¼š
â”Œâ”€ èµ·å§‹æ¡ä»¶ï¼šä»å“ªé‡Œå¼€å§‹ï¼Ÿ
â”œâ”€ é€’å½’å…³ç³»ï¼šå¦‚ä½•ä»å½“å‰çŠ¶æ€åˆ°ä¸‹ä¸€çŠ¶æ€ï¼Ÿ
â”œâ”€ ç»ˆæ­¢æ¡ä»¶ï¼šä»€ä¹ˆæ—¶å€™åœæ­¢ï¼Ÿ
â””â”€ é¢„æœŸç»“æœï¼šæœ€ç»ˆè¦å¾—åˆ°ä»€ä¹ˆï¼Ÿ

ä¾‹å­ï¼šæŸ¥æ‰¾å‘˜å·¥çš„æ‰€æœ‰ä¸‹å±
â”Œâ”€ èµ·å§‹ï¼šæŒ‡å®šçš„ç®¡ç†è€…
â”œâ”€ é€’å½’ï¼šæ‰¾å½“å‰äººå‘˜çš„ç›´æ¥ä¸‹å±
â”œâ”€ ç»ˆæ­¢ï¼šæ²¡æœ‰ä¸‹å±æˆ–å±‚çº§è¿‡æ·±
â””â”€ ç»“æœï¼šå®Œæ•´çš„ä¸‹å±å±‚çº§å…³ç³»
```

**åŸåˆ™2ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§**
```sql
-- âœ… ç¡®ä¿åˆ—ç»“æ„ä¸€è‡´
WITH RECURSIVE consistent_cte AS (
    -- é”šç‚¹æŸ¥è¯¢çš„åˆ—
    SELECT id, name, parent_id, 0 as level     -- 4åˆ—
    FROM table1 WHERE condition
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢å¿…é¡»è¿”å›ç›¸åŒçš„åˆ—
    SELECT t.id, t.name, t.parent_id, c.level + 1  -- åŒæ ·4åˆ—ï¼Œé¡ºåºä¸€è‡´
    FROM table1 t JOIN consistent_cte c ON t.parent_id = c.id
)
```

**åŸåˆ™3ï¼šä¼˜åŒ–æ€§èƒ½è®¾è®¡**
```sql
-- ğŸš€ æ€§èƒ½ä¼˜åŒ–çš„è®¾è®¡æ¨¡å¼
WITH RECURSIVE optimized_cte AS (
    SELECT 
        id, parent_id,           -- åªé€‰æ‹©å¿…è¦çš„åˆ—
        0 as level
    FROM employees 
    WHERE parent_id IS NULL
    AND status = 'active'        -- é¢„è¿‡æ»¤å‡å°‘æ•°æ®é‡
    
    UNION ALL
    
    SELECT 
        e.id, e.parent_id, oc.level + 1
    FROM employees e
    JOIN optimized_cte oc ON e.parent_id = oc.id
    WHERE oc.level < 5           -- åˆç†çš„æ·±åº¦é™åˆ¶
    AND e.status = 'active'      -- æ¯å±‚éƒ½è¿›è¡Œè¿‡æ»¤
)
```

### 7.2 é€’å½’CTEé€‚ç”¨åœºæ™¯åˆ¤æ–­


**ğŸ¯ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨é€’å½’CTE**

```
âœ… é€‚ç”¨åœºæ™¯ï¼š
â”œâ”€ æ ‘å½¢æ•°æ®éå†ï¼šç»„ç»‡æ¶æ„ã€åˆ†ç±»ä½“ç³»ã€è¯„è®ºå›å¤
â”œâ”€ å›¾å½¢è·¯å¾„æŸ¥æ‰¾ï¼šç½‘ç»œè·¯ç”±ã€åœ°å›¾å¯¼èˆªã€ä¾èµ–å…³ç³»
â”œâ”€ æ•°åˆ—ç”Ÿæˆï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—ã€ç­‰å·®æ•°åˆ—  
â”œâ”€ å±‚çº§æ±‡æ€»ï¼šé”€å”®å±‚çº§ç»Ÿè®¡ã€æˆæœ¬åˆ†æ‘Š
â””â”€ é€’å½’è®¡ç®—ï¼šå¤åˆåˆ©æ¯ã€å¢é•¿é¢„æµ‹

âŒ ä¸é€‚ç”¨åœºæ™¯ï¼š
â”œâ”€ ç®€å•çš„è¡¨å…³è”ï¼šæ™®é€šçš„JOINå°±å¤Ÿäº†
â”œâ”€ å›ºå®šå±‚çº§æŸ¥è¯¢ï¼šå·²çŸ¥å±‚æ•°æ—¶ç”¨å¤šæ¬¡JOINæ›´é«˜æ•ˆ
â”œâ”€ å¤§æ•°æ®é‡å¤„ç†ï¼šé€’å½’å¯èƒ½æ€§èƒ½ä¸ä½³
â””â”€ å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼šå»ºè®®ç”¨ç¨‹åºä»£ç å®ç°
```

**ğŸ” åœºæ™¯é€‰æ‹©æŒ‡å—**

> ğŸ¤” **å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä½¿ç”¨é€’å½’CTEï¼Ÿ**
> 
> é—®è‡ªå·±ä¸‰ä¸ªé—®é¢˜ï¼š
> 1. æ•°æ®æ˜¯å¦æœ‰æ˜ç¡®çš„å±‚çº§å…³ç³»ï¼Ÿ
> 2. å±‚çº§æ·±åº¦æ˜¯å¦ä¸ç¡®å®šï¼Ÿ  
> 3. æ˜¯å¦éœ€è¦éå†æ•´ä¸ªå±‚çº§æ ‘ï¼Ÿ
> 
> å¦‚æœç­”æ¡ˆéƒ½æ˜¯"æ˜¯"ï¼Œé‚£é€’å½’CTEæ˜¯æœ€ä½³é€‰æ‹©

### 7.3 é”™è¯¯å¤„ç†ä¸è°ƒè¯•


**ğŸ› å¸¸è§é”™è¯¯æ¨¡å¼**

**é”™è¯¯1ï¼šå¿˜è®°ç»ˆæ­¢æ¡ä»¶**
```sql
-- âŒ å±é™©çš„æ— é™é€’å½’
WITH RECURSIVE bad_cte AS (
    SELECT id, parent_id FROM table1 WHERE id = 1
    UNION ALL
    SELECT t.id, t.parent_id FROM table1 t 
    JOIN bad_cte b ON t.parent_id = b.id
    -- æ²¡æœ‰WHEREæ¡ä»¶ï¼ä¼šæ— é™æ‰§è¡Œ
)

-- âœ… å®‰å…¨çš„é€’å½’
WITH RECURSIVE safe_cte AS (
    SELECT id, parent_id, 0 as level FROM table1 WHERE id = 1
    UNION ALL
    SELECT t.id, t.parent_id, s.level + 1 FROM table1 t 
    JOIN safe_cte s ON t.parent_id = s.id
    WHERE s.level < 10  -- ğŸ›‘ å¿…é¡»æœ‰ç»ˆæ­¢æ¡ä»¶
)
```

**é”™è¯¯2ï¼šåˆ—ç»“æ„ä¸åŒ¹é…**
```sql
-- âŒ åˆ—æ•°ä¸ä¸€è‡´
WITH RECURSIVE wrong_cte AS (
    SELECT id, name FROM table1          -- 2åˆ—
    UNION ALL
    SELECT id, name, level FROM table1   -- 3åˆ—ï¼Œé”™è¯¯ï¼
    JOIN wrong_cte ON ...
)

-- âœ… åˆ—ç»“æ„ä¸€è‡´
WITH RECURSIVE correct_cte AS (
    SELECT id, name, 0 as level FROM table1     -- 3åˆ—
    UNION ALL  
    SELECT t.id, t.name, c.level + 1 FROM table1 t  -- 3åˆ—
    JOIN correct_cte c ON ...
)
```

---

## 8. ğŸ¯ é€’å½’CTEå®æˆ˜åº”ç”¨


### 8.1 èœå•æƒé™æ ‘ç”Ÿæˆ


**ğŸ” æƒé™ç®¡ç†åœºæ™¯**
```sql
-- èœå•æƒé™è¡¨
CREATE TABLE menus (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    parent_id INT,
    url VARCHAR(100),
    permission VARCHAR(50)
);

-- ğŸ¯ ç”Ÿæˆç”¨æˆ·å¯è®¿é—®çš„èœå•æ ‘
WITH RECURSIVE user_menu_tree AS (
    -- é”šç‚¹ï¼šé¡¶çº§èœå•ï¼ˆç”¨æˆ·æœ‰æƒé™çš„ï¼‰
    SELECT 
        m.id, m.name, m.parent_id, m.url,
        0 as level,
        CAST(m.name AS VARCHAR(200)) as menu_path
    FROM menus m
    JOIN user_permissions up ON m.permission = up.permission
    WHERE m.parent_id IS NULL 
    AND up.user_id = @user_id
    
    UNION ALL
    
    -- é€’å½’ï¼šå­èœå•
    SELECT 
        m.id, m.name, m.parent_id, m.url,
        umt.level + 1,
        umt.menu_path || ' > ' || m.name
    FROM menus m
    JOIN user_menu_tree umt ON m.parent_id = umt.id
    JOIN user_permissions up ON m.permission = up.permission
    WHERE up.user_id = @user_id
    AND umt.level < 5  -- èœå•å±‚çº§é™åˆ¶
)
SELECT * FROM user_menu_tree ORDER BY menu_path;
```

### 8.2 æ•°å­—åºåˆ—ç”Ÿæˆ


**ğŸ”¢ æ•°åˆ—ç”Ÿæˆåº”ç”¨**

```sql
-- ğŸ“ˆ ç”Ÿæˆæ–æ³¢é‚£å¥‘æ•°åˆ—
WITH RECURSIVE fibonacci AS (
    -- é”šç‚¹ï¼šå‰ä¸¤ä¸ªæ•°
    SELECT 1 as position, 0 as current_num, 1 as next_num
    
    UNION ALL
    
    -- é€’å½’ï¼šè®¡ç®—ä¸‹ä¸€ä¸ªæ•°
    SELECT 
        position + 1,
        next_num,
        current_num + next_num
    FROM fibonacci
    WHERE position < 20  -- ç”Ÿæˆ20ä¸ªæ–æ³¢é‚£å¥‘æ•°
)
SELECT position, current_num as fibonacci_number
FROM fibonacci;

-- ğŸ“Š ç»“æœï¼š0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55...
```

### 8.3 è·¯å¾„æŸ¥æ‰¾ç®—æ³•


**ğŸ—ºï¸ å›¾è®ºè·¯å¾„æŸ¥æ‰¾**
```sql
-- ğŸ›£ï¸ åŸå¸‚è·¯å¾„è§„åˆ’
WITH RECURSIVE path_search AS (
    -- é”šç‚¹ï¼šèµ·å§‹åŸå¸‚
    SELECT 
        city_id, city_name,
        0 as total_distance,
        1 as hop_count,
        CAST(city_name AS VARCHAR(500)) as route_path,
        ARRAY[city_id] as visited_cities  -- é˜²æ­¢ç¯è·¯
    FROM cities 
    WHERE city_name = 'åŒ—äº¬'
    
    UNION ALL
    
    -- é€’å½’ï¼šç›¸é‚»åŸå¸‚
    SELECT 
        r.to_city_id,
        c.city_name,
        ps.total_distance + r.distance,
        ps.hop_count + 1,
        ps.route_path || ' -> ' || c.city_name,
        ps.visited_cities || r.to_city_id
    FROM routes r
    JOIN path_search ps ON r.from_city_id = ps.city_id
    JOIN cities c ON r.to_city_id = c.city_id
    WHERE ps.hop_count < 8                           -- æœ€å¤š8ä¸ªä¸­è½¬
    AND ps.total_distance < 3000                   -- è·ç¦»é™åˆ¶
    AND NOT r.to_city_id = ANY(ps.visited_cities)  -- é˜²æ­¢ç¯è·¯
)
-- ğŸ¯ æ‰¾åˆ°ç›®æ ‡åŸå¸‚çš„æ‰€æœ‰è·¯å¾„
SELECT route_path, total_distance, hop_count
FROM path_search 
WHERE city_name = 'ä¸Šæµ·'
ORDER BY total_distance
LIMIT 5;  -- æœ€çŸ­çš„5æ¡è·¯å¾„
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é€’å½’CTEæœ¬è´¨ï¼šèƒ½å¤Ÿå¼•ç”¨è‡ªèº«çš„ä¸´æ—¶è¡¨è¡¨è¾¾å¼
ğŸ”¸ ä¸¤éƒ¨åˆ†æ„æˆï¼šé”šç‚¹æŸ¥è¯¢ï¼ˆèµ·å§‹ï¼‰+ é€’å½’æŸ¥è¯¢ï¼ˆè¿­ä»£ï¼‰
ğŸ”¸ æ‰§è¡Œæœºåˆ¶ï¼šè½®æ¬¡æ‰§è¡Œï¼Œæ¯è½®ç»“æœç´¯ç§¯åˆ°ä¸´æ—¶è¡¨
ğŸ”¸ ç»ˆæ­¢æ¡ä»¶ï¼šé˜²æ­¢æ— é™é€’å½’çš„å®‰å…¨ä¿éšœ
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šå±‚çº§ä¸ç¡®å®šçš„æ ‘å½¢æ•°æ®å¤„ç†
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é€’å½’CTEçš„æ‰§è¡Œæ€è·¯**
```
ç†è§£è¦ç‚¹ï¼š
- ä¸æ˜¯çœŸæ­£çš„"é€’å½’è°ƒç”¨"ï¼Œè€Œæ˜¯"è¿­ä»£æ‰§è¡Œ"
- æ¯è½®éƒ½ç”¨ä¸Šè½®çš„ç»“æœä½œä¸ºè¾“å…¥
- ç´¯ç§¯æ‰€æœ‰è½®æ¬¡çš„ç»“æœå½¢æˆæœ€ç»ˆç»“æœ
- å½“æŸè½®è¿”å›ç©ºç»“æœæ—¶è‡ªåŠ¨åœæ­¢
```

**ğŸ”¹ é”šç‚¹æŸ¥è¯¢çš„å…³é”®ä½œç”¨**
```
è®°å¿†è¦ç‚¹ï¼š
- é”šç‚¹ = é€’å½’çš„èµ·è·‘çº¿
- æ²¡æœ‰é”šç‚¹å°±æ²¡æœ‰å¼€å§‹  
- é”šç‚¹è´¨é‡å†³å®šé€’å½’æ•ˆæœ
- é”šç‚¹æŸ¥è¯¢ä¸èƒ½å¼•ç”¨CTEè‡ªèº«
```

**ğŸ”¹ UNION ALLçš„å¿…è¦æ€§**
```
ä¸ºä»€ä¹ˆå¿…é¡»ç”¨UNION ALLï¼š
- UNIONä¼šå»é‡ï¼Œå¯èƒ½ä¸¢å¤±å±‚çº§ä¿¡æ¯
- UNIONéœ€è¦æ’åºï¼Œå¢åŠ æ€§èƒ½å¼€é”€
- é€’å½’ç»“æœé€šå¸¸ä¸ä¼šé‡å¤
- ALLä¿è¯æ‰€æœ‰è½®æ¬¡ç»“æœéƒ½è¢«ä¿ç•™
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“ˆ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… é€‰æ‹©é€’å½’CTEçš„æƒ…å†µï¼š
- æ•°æ®æœ‰æ˜ç¡®çš„çˆ¶å­å…³ç³»
- å±‚çº§æ·±åº¦ä¸ç¡®å®šæˆ–å˜åŒ–
- éœ€è¦å®Œæ•´éå†å±‚çº§æ ‘
- SQLå†…è§£å†³æ¯”ç¨‹åºå¾ªç¯æ›´é«˜æ•ˆ

âŒ ä¸å»ºè®®ä½¿ç”¨çš„æƒ…å†µï¼š  
- æ•°æ®é‡ç‰¹åˆ«å¤§ï¼ˆç™¾ä¸‡çº§åˆ«ä»¥ä¸Šï¼‰
- å±‚çº§å…³ç³»å¤æ‚ï¼ˆå¤šçˆ¶èŠ‚ç‚¹ã€ç¯è·¯ï¼‰
- é¢‘ç¹å˜æ›´çš„æ•°æ®
- å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†
```

**ğŸ› ï¸ ç¼–å†™æ­¥éª¤**
```
ç¬¬1æ­¥ï¼šåˆ†ææ•°æ®ç»“æ„
- ç¡®å®šçˆ¶å­å…³ç³»å­—æ®µ
- äº†è§£æ•°æ®çš„å±‚çº§ç‰¹ç‚¹
- è¯„ä¼°æ•°æ®é‡å¤§å°

ç¬¬2æ­¥ï¼šè®¾è®¡é”šç‚¹æŸ¥è¯¢
- æ˜ç¡®é€’å½’èµ·å§‹ç‚¹
- é€‰æ‹©å¿…è¦çš„è¿”å›åˆ—
- æ·»åŠ åˆå§‹å±‚çº§æ ‡è¯†

ç¬¬3æ­¥ï¼šæ„é€ é€’å½’æŸ¥è¯¢  
- è®¾è®¡JOINæ¡ä»¶è¿æ¥çˆ¶å­
- æ·»åŠ å±‚çº§é€’å¢é€»è¾‘
- è®¾ç½®å®‰å…¨ç»ˆæ­¢æ¡ä»¶

ç¬¬4æ­¥ï¼šæµ‹è¯•å’Œä¼˜åŒ–
- å°æ•°æ®é›†éªŒè¯é€»è¾‘
- æ£€æŸ¥æ€§èƒ½è¡¨ç°
- è°ƒæ•´ç»ˆæ­¢æ¡ä»¶å’Œç´¢å¼•
```

**ğŸ¯ æœ€ä½³å®è·µæ€»ç»“**
```
å®‰å…¨æ€§ï¼š
- å¿…é¡»è®¾ç½®ç»ˆæ­¢æ¡ä»¶
- å»ºè®®å¤šé‡å®‰å…¨æ£€æŸ¥
- æ·»åŠ è·¯å¾„è®°å½•é˜²ç¯è·¯

æ€§èƒ½ï¼š
- åˆç†æ§åˆ¶é€’å½’æ·±åº¦
- åˆ›å»ºé€‚å½“çš„ç´¢å¼•
- åªè¿”å›å¿…è¦çš„åˆ—

å¯ç»´æŠ¤æ€§ï¼š
- æ·»åŠ æ³¨é‡Šè¯´æ˜é€’å½’é€»è¾‘
- ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å
- åˆ†æ­¥éª¤æµ‹è¯•éªŒè¯
```

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
â­ åŸºç¡€é˜¶æ®µï¼š
- ç†è§£é€’å½’çš„åŸºæœ¬æ¦‚å¿µ
- æŒæ¡åŸºæœ¬çš„è¯­æ³•ç»“æ„
- ç»ƒä¹ ç®€å•çš„å±‚çº§æŸ¥è¯¢

â­â­ è¿›é˜¶é˜¶æ®µï¼š
- æŒæ¡å„ç§ç»ˆæ­¢æ¡ä»¶è®¾è®¡
- å­¦ä¼šæ€§èƒ½ä¼˜åŒ–æŠ€å·§
- å¤„ç†å¤æ‚çš„ä¸šåŠ¡åœºæ™¯

â­â­â­ é«˜çº§é˜¶æ®µï¼š
- è®¾è®¡å¤æ‚çš„é€’å½’ç®—æ³•
- å¤„ç†å¤§æ•°æ®é‡çš„é€’å½’
- ç»“åˆå…¶ä»–æŠ€æœ¯ç»¼åˆåº”ç”¨
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
é€’å½’CTEæœ‰å¦™ç”¨ï¼Œé”šç‚¹é€’å½’åŠ UNION
ç»ˆæ­¢æ¡ä»¶å¿…é¡»æœ‰ï¼Œå±‚çº§æ§åˆ¶ä¸èƒ½æ¼  
çˆ¶å­å…³ç³»è¦ç†æ¸…ï¼ŒJOINæ¡ä»¶æ˜¯å…³é”®
æ€§èƒ½ä¼˜åŒ–æœ‰æŠ€å·§ï¼Œç´¢å¼•æ·±åº¦è¦è€ƒè™‘
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- é€’å½’CTE = é”šç‚¹ + é€’å½’ + ç»ˆæ­¢æ¡ä»¶
- æ‰§è¡Œè¿‡ç¨‹æ˜¯è½®æ¬¡è¿­ä»£ï¼Œä¸æ˜¯çœŸæ­£é€’å½’è°ƒç”¨
- å®‰å…¨ç¬¬ä¸€ï¼Œæ€§èƒ½ç¬¬äºŒï¼ŒåŠŸèƒ½ç¬¬ä¸‰
- æ ‘å½¢æ•°æ®çš„æœ€ä½³SQLè§£å†³æ–¹æ¡ˆ