---
title: 5ã€CTEé«˜çº§åº”ç”¨åœºæ™¯
---
## ğŸ“š ç›®å½•

1. [CTEé«˜çº§åº”ç”¨æ¦‚è¿°](#1-CTEé«˜çº§åº”ç”¨æ¦‚è¿°)
2. [å¤æ‚æŠ¥è¡¨æŸ¥è¯¢åº”ç”¨](#2-å¤æ‚æŠ¥è¡¨æŸ¥è¯¢åº”ç”¨)
3. [æ•°æ®æ¸…æ´—å¤„ç†åœºæ™¯](#3-æ•°æ®æ¸…æ´—å¤„ç†åœºæ™¯)
4. [ä¸šåŠ¡é€»è¾‘å°è£…å®ç°](#4-ä¸šåŠ¡é€»è¾‘å°è£…å®ç°)
5. [å¤šæ­¥éª¤æ•°æ®å¤„ç†](#5-å¤šæ­¥éª¤æ•°æ®å¤„ç†)
6. [æ¡ä»¶é€’å½’æŸ¥è¯¢æŠ€æœ¯](#6-æ¡ä»¶é€’å½’æŸ¥è¯¢æŠ€æœ¯)
7. [åŠ¨æ€æ•°æ®ç”Ÿæˆåº”ç”¨](#7-åŠ¨æ€æ•°æ®ç”Ÿæˆåº”ç”¨)
8. [CTEé«˜çº§è®¾è®¡æ¨¡å¼](#8-CTEé«˜çº§è®¾è®¡æ¨¡å¼)
9. [å¤æ‚ä¸šåŠ¡åœºæ™¯å®ç°](#9-å¤æ‚ä¸šåŠ¡åœºæ™¯å®ç°)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CTEé«˜çº§åº”ç”¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯CTEé«˜çº§åº”ç”¨


**é€šä¿—ç†è§£**ï¼š
å¦‚æœè¯´åŸºç¡€CTEæ˜¯ä¸€ä¸ªä¸´æ—¶çš„"å·¥ä½œå°"ï¼Œé‚£ä¹ˆé«˜çº§CTEåº”ç”¨å°±æ˜¯æŠŠè¿™ä¸ªå·¥ä½œå°å˜æˆä¸€ä¸ª"æ™ºèƒ½å·¥å‚"ï¼Œèƒ½å¤Ÿå¤„ç†å¤æ‚çš„å¤šæ­¥éª¤ä¸šåŠ¡é€»è¾‘ã€‚

```
åŸºç¡€CTEï¼šç®€å•æŸ¥è¯¢ â†’ ä¸€æ¬¡æ€§ç»“æœ
é«˜çº§CTEï¼šå¤æ‚é€»è¾‘ â†’ å¤šæ­¥éª¤å¤„ç† â†’ æ™ºèƒ½åˆ†æ

å°±åƒåšèœï¼š
åŸºç¡€ï¼šåˆ‡èœ â†’ ç‚’èœ â†’ è£…ç›˜
é«˜çº§ï¼šå‡†å¤‡å¤šç§é£Ÿæ â†’ åˆ†æ­¥éª¤åŠ å·¥ â†’ ç»„åˆè°ƒå‘³ â†’ ç²¾ç¾æ‘†ç›˜
```

**ğŸ”¸ æ ¸å¿ƒç‰¹å¾**
```
é€’å½’å¤„ç†ï¼šCTEå¯ä»¥å¼•ç”¨è‡ªå·±ï¼Œå¤„ç†å±‚çº§æ•°æ®
å¤šæ­¥éª¤é“¾å¼ï¼šä¸€ä¸ªCTEçš„ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªCTEçš„è¾“å…¥
å¤æ‚é€»è¾‘å°è£…ï¼šæŠŠå¤æ‚çš„ä¸šåŠ¡è§„åˆ™å°è£…åœ¨CTEä¸­
åŠ¨æ€æ•°æ®ç”Ÿæˆï¼šæ ¹æ®æ¡ä»¶åŠ¨æ€åˆ›å»ºæ•°æ®é›†
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦CTEé«˜çº§åº”ç”¨


**å®é™…å·¥ä½œä¸­çš„ç—›ç‚¹**ï¼š
```
ä¼ ç»ŸSQLçš„å±€é™ï¼š
â€¢ å¤æ‚æŸ¥è¯¢åµŒå¥—å±‚çº§å¤ªæ·±ï¼Œéš¾ä»¥ç†è§£
â€¢ ä¸´æ—¶è¡¨éœ€è¦é¢å¤–çš„åˆ›å»ºå’Œæ¸…ç†å·¥ä½œ
â€¢ å­˜å‚¨è¿‡ç¨‹è¿‡äºé‡é‡çº§ï¼Œç»´æŠ¤æˆæœ¬é«˜
â€¢ è§†å›¾æ— æ³•å¤„ç†åŠ¨æ€é€»è¾‘

CTEé«˜çº§åº”ç”¨çš„ä¼˜åŠ¿ï¼š
âœ… ä»£ç å¯è¯»æ€§å¼ºï¼šé€»è¾‘æ¸…æ™°ï¼Œåˆ†æ­¥éª¤ç¼–å†™
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šMySQLä¼˜åŒ–å™¨èƒ½æ›´å¥½åœ°ä¼˜åŒ–CTE
âœ… ç»´æŠ¤æˆæœ¬ä½ï¼šä¸éœ€è¦é¢å¤–çš„å¯¹è±¡ç®¡ç†
âœ… çµæ´»æ€§å¼ºï¼šå¯ä»¥å¤„ç†å„ç§å¤æ‚åœºæ™¯
```

### 1.3 CTEé«˜çº§åº”ç”¨çš„é€‚ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä¸šåŠ¡åœºæ™¯**
```
æŠ¥è¡¨ç³»ç»Ÿï¼š
â€¢ å¤šç»´åº¦æ•°æ®ç»Ÿè®¡åˆ†æ
â€¢ è·¨æ—¶é—´æ®µçš„è¶‹åŠ¿åˆ†æ
â€¢ å¤æ‚çš„ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—

æ•°æ®å¤„ç†ï¼š
â€¢ æ‰¹é‡æ•°æ®æ¸…æ´—å’Œè½¬æ¢
â€¢ æ•°æ®è´¨é‡æ£€æŸ¥å’Œä¿®å¤
â€¢ å†å²æ•°æ®è¿ç§»å’Œæ•´ç†

ä¸šåŠ¡åˆ†æï¼š
â€¢ ç”¨æˆ·è¡Œä¸ºè·¯å¾„åˆ†æ
â€¢ é”€å”®æ¼æ–—åˆ†æ
â€¢ ç»„ç»‡æ¶æ„æŸ¥è¯¢
```

---

## 2. ğŸ“Š å¤æ‚æŠ¥è¡¨æŸ¥è¯¢åº”ç”¨


### 2.1 å¤šç»´åº¦é”€å”®æŠ¥è¡¨


**ä¸šåŠ¡åœºæ™¯**ï¼šç”ŸæˆåŒ…å«åŒæ¯”ã€ç¯æ¯”ã€ç´¯è®¡é”€å”®é¢çš„ç»¼åˆæŠ¥è¡¨

```sql
-- å¤æ‚é”€å”®æŠ¥è¡¨CTEåº”ç”¨
WITH 
-- åŸºç¡€é”€å”®æ•°æ®
base_sales AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') as month_key,
        YEAR(order_date) as year_num,
        MONTH(order_date) as month_num,
        SUM(amount) as monthly_sales
    FROM orders 
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 24 MONTH)
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
),

-- è®¡ç®—åŒæ¯”æ•°æ®
year_over_year AS (
    SELECT 
        b1.month_key,
        b1.monthly_sales as current_sales,
        b2.monthly_sales as last_year_sales,
        ROUND((b1.monthly_sales - b2.monthly_sales) / b2.monthly_sales * 100, 2) as yoy_growth
    FROM base_sales b1
    LEFT JOIN base_sales b2 ON 
        b1.month_num = b2.month_num AND b1.year_num = b2.year_num + 1
),

-- è®¡ç®—ç¯æ¯”å’Œç´¯è®¡
final_report AS (
    SELECT 
        month_key,
        current_sales,
        yoy_growth,
        LAG(current_sales) OVER (ORDER BY month_key) as last_month_sales,
        SUM(current_sales) OVER (ORDER BY month_key) as cumulative_sales
    FROM year_over_year
)

-- æœ€ç»ˆè¾“å‡ºå®Œæ•´æŠ¥è¡¨
SELECT 
    month_key as 'æœˆä»½',
    FORMAT(current_sales, 2) as 'å½“æœˆé”€å”®é¢',
    CONCAT(yoy_growth, '%') as 'åŒæ¯”å¢é•¿',
    CONCAT(ROUND((current_sales - last_month_sales) / last_month_sales * 100, 2), '%') as 'ç¯æ¯”å¢é•¿',
    FORMAT(cumulative_sales, 2) as 'ç´¯è®¡é”€å”®é¢'
FROM final_report
ORDER BY month_key;
```

**ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼š
- **åˆ†æ­¥å¤„ç†**ï¼šå¤æ‚è®¡ç®—åˆ†è§£ä¸ºå¤šä¸ªç®€å•æ­¥éª¤
- **é€»è¾‘æ¸…æ™°**ï¼šæ¯ä¸ªCTEè´Ÿè´£ä¸€ä¸ªå…·ä½“çš„è®¡ç®—ä»»åŠ¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæ•°æ®åªæ‰«æä¸€æ¬¡

### 2.2 ç”¨æˆ·è¡Œä¸ºæ¼æ–—åˆ†æ


**ä¸šåŠ¡åœºæ™¯**ï¼šåˆ†æç”¨æˆ·ä»è®¿é—®åˆ°è´­ä¹°çš„è½¬åŒ–æ¼æ–—

```sql
-- ç”¨æˆ·è½¬åŒ–æ¼æ–—åˆ†æ
WITH 
-- ç”¨æˆ·è¡Œä¸ºäº‹ä»¶ç»Ÿè®¡
user_events AS (
    SELECT 
        user_id,
        MAX(CASE WHEN event_type = 'page_view' THEN 1 ELSE 0 END) as has_view,
        MAX(CASE WHEN event_type = 'add_cart' THEN 1 ELSE 0 END) as has_cart,
        MAX(CASE WHEN event_type = 'payment' THEN 1 ELSE 0 END) as has_payment
    FROM user_behavior_log 
    WHERE event_date >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
    GROUP BY user_id
),

-- è®¡ç®—å„ç¯èŠ‚ç”¨æˆ·æ•°
funnel_stats AS (
    SELECT 
        SUM(has_view) as view_users,
        SUM(has_cart) as cart_users,
        SUM(has_payment) as payment_users
    FROM user_events
)

-- ç”Ÿæˆæ¼æ–—è½¬åŒ–æŠ¥è¡¨
SELECT 
    'æµè§ˆ' as stage, view_users as user_count, 100.0 as conversion_rate
FROM funnel_stats
UNION ALL
SELECT 
    'åŠ è´­ç‰©è½¦', cart_users, ROUND(cart_users * 100.0 / view_users, 2)
FROM funnel_stats
UNION ALL
SELECT 
    'æ”¯ä»˜', payment_users, ROUND(payment_users * 100.0 / view_users, 2)
FROM funnel_stats;
```

**ğŸ¯ ä¸šåŠ¡ä»·å€¼**ï¼š
è¿™ç§CTEåº”ç”¨å¯ä»¥å¸®åŠ©äº§å“ç»ç†å¿«é€Ÿäº†è§£ï¼š
- ç”¨æˆ·åœ¨å“ªä¸ªç¯èŠ‚æµå¤±æœ€å¤š
- æ•´ä½“è½¬åŒ–æ•ˆç‡å¦‚ä½•
- å“ªäº›ç¯èŠ‚éœ€è¦ä¼˜åŒ–

---

## 3. ğŸ§¹ æ•°æ®æ¸…æ´—å¤„ç†åœºæ™¯


### 3.1 ä»€ä¹ˆæ˜¯æ•°æ®æ¸…æ´—


**é€šä¿—è§£é‡Š**ï¼š
æ•°æ®æ¸…æ´—å°±åƒæ•´ç†æˆ¿é—´ï¼ŒæŠŠä¹±ä¸ƒå…«ç³Ÿçš„æ•°æ®æ•´ç†å¾—å¹²å‡€æ•´é½ï¼Œå»æ‰æ— ç”¨çš„ã€é”™è¯¯çš„ã€é‡å¤çš„ä¿¡æ¯ã€‚

```
è„æ•°æ®çš„å¸¸è§é—®é¢˜ï¼š
å§“åå­—æ®µï¼š  "å¼ ä¸‰  " ï¼ˆå¤šä½™ç©ºæ ¼ï¼‰
           "zhang san" ï¼ˆæ ¼å¼ä¸ç»Ÿä¸€ï¼‰
           
ç”µè¯å­—æ®µï¼š  "138-1234-5678" ï¼ˆæ ¼å¼ä¸ä¸€è‡´ï¼‰
           "13812345678"
           "1381234567" ï¼ˆä½æ•°é”™è¯¯ï¼‰
           
æ—¥æœŸå­—æ®µï¼š  "2023/12/32" ï¼ˆæ—¥æœŸæ— æ•ˆï¼‰
           "2023-13-01" ï¼ˆæœˆä»½é”™è¯¯ï¼‰
```

### 3.2 ä½¿ç”¨CTEè¿›è¡Œæ•°æ®æ¸…æ´—


**å®é™…æ¸…æ´—æ¡ˆä¾‹**ï¼šæ¸…ç†å®¢æˆ·ä¿¡æ¯è¡¨

```sql
-- å®¢æˆ·æ•°æ®æ¸…æ´—æµç¨‹
WITH 
-- æ¸…ç†å’Œæ ‡å‡†åŒ–åŸºç¡€æ•°æ®
cleaned_basic AS (
    SELECT 
        customer_id,
        TRIM(UPPER(customer_name)) as clean_name,
        REGEXP_REPLACE(phone, '[^0-9]', '') as clean_phone,
        LOWER(TRIM(email)) as clean_email
    FROM customers
    WHERE customer_name IS NOT NULL AND customer_name != ''
),

-- æ•°æ®éªŒè¯å’Œè¿‡æ»¤
validated_data AS (
    SELECT 
        customer_id,
        clean_name,
        CASE 
            WHEN LENGTH(clean_phone) = 11 AND clean_phone LIKE '1%' 
            THEN clean_phone ELSE NULL 
        END as valid_phone,
        CASE 
            WHEN clean_email LIKE '%@%.%' 
            THEN clean_email ELSE NULL 
        END as valid_email
    FROM cleaned_basic
),

-- å»é™¤é‡å¤æ•°æ®
deduplicated AS (
    SELECT 
        customer_id, clean_name, valid_phone, valid_email,
        ROW_NUMBER() OVER (
            PARTITION BY clean_name, valid_phone 
            ORDER BY customer_id
        ) as row_num
    FROM validated_data
)

-- æœ€ç»ˆè¾“å‡ºæ¸…æ´—åçš„æ•°æ®
SELECT 
    customer_id,
    clean_name as customer_name,
    valid_phone as phone,
    valid_email as email
FROM deduplicated 
WHERE row_num = 1 AND valid_phone IS NOT NULL;
```

**ğŸ”§ æ¸…æ´—æ­¥éª¤è§£æ**ï¼š
1. **åŸºç¡€æ¸…ç†**ï¼šå»ç©ºæ ¼ã€ç»Ÿä¸€æ ¼å¼ã€å¤§å°å†™æ ‡å‡†åŒ–
2. **æ•°æ®éªŒè¯**ï¼šæ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œæ— æ•ˆæ•°æ®ç½®NULL
3. **å»é‡å¤„ç†**ï¼šåŸºäºä¸šåŠ¡è§„åˆ™å»é™¤é‡å¤è®°å½•
4. **è´¨é‡æ£€æŸ¥**ï¼šç¡®ä¿è¾“å‡ºæ•°æ®ç¬¦åˆä¸šåŠ¡è¦æ±‚

### 3.3 æ‰¹é‡æ•°æ®è´¨é‡æ£€æŸ¥


**è´¨é‡æ£€æŸ¥CTEåº”ç”¨**ï¼š

```sql
-- æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š
WITH quality_check AS (
    SELECT 
        'customer_name' as field_name,
        COUNT(*) as total_records,
        COUNT(customer_name) as non_null_count,
        COUNT(CASE WHEN customer_name REGEXP '[0-9]' THEN 1 END) as invalid_count
    FROM customers
    
    UNION ALL
    
    SELECT 
        'phone',
        COUNT(*),
        COUNT(phone),
        COUNT(CASE WHEN phone NOT REGEXP '^1[0-9]{10}$' THEN 1 END)
    FROM customers
)

-- ç”Ÿæˆè´¨é‡æŠ¥å‘Š
SELECT 
    field_name as 'å­—æ®µå',
    total_records as 'æ€»è®°å½•æ•°',
    ROUND(non_null_count * 100.0 / total_records, 2) as 'å®Œæ•´ç‡%',
    ROUND((total_records - invalid_count) * 100.0 / total_records, 2) as 'æ•°æ®è´¨é‡%'
FROM quality_check;
```

**ğŸ“Š è´¨é‡æ£€æŸ¥ä»·å€¼**ï¼š
- å¿«é€Ÿå‘ç°æ•°æ®é—®é¢˜
- é‡åŒ–æ•°æ®è´¨é‡æŒ‡æ ‡
- ä¸ºæ•°æ®æ¸…æ´—æä¾›ä¾æ®

---

## 4. ğŸ”— ä¸šåŠ¡é€»è¾‘å°è£…å®ç°


### 4.1 å¤æ‚ä¸šåŠ¡è§„åˆ™å°è£…


**ä¸šåŠ¡åœºæ™¯**ï¼šç”µå•†å¹³å°çš„ä¼šå‘˜ç­‰çº§è®¡ç®—å’Œä¼˜æƒ ç­–ç•¥

**é€šä¿—ç†è§£**ï¼š
æŠŠå¤æ‚çš„ä¼šå‘˜ç­‰çº§åˆ¤æ–­è§„åˆ™ç”¨CTEå°è£…èµ·æ¥ï¼Œå°±åƒæŠŠä¸€å¥—å¤æ‚çš„è®¡ç®—å…¬å¼è£…è¿›ä¸€ä¸ª"é»‘ç›’å­"ï¼Œè¾“å…¥åŸºç¡€æ•°æ®ï¼Œè¾“å‡ºæœ€ç»ˆç»“æœã€‚

```sql
-- ä¼šå‘˜ç­‰çº§å’Œä¼˜æƒ è®¡ç®—
WITH 
-- è®¡ç®—ç”¨æˆ·åŸºç¡€æŒ‡æ ‡
user_metrics AS (
    SELECT 
        u.user_id,
        COUNT(o.order_id) as total_orders,
        COALESCE(SUM(o.amount), 0) as total_amount,
        COUNT(CASE WHEN o.order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY) THEN 1 END) as recent_orders
    FROM users u
    LEFT JOIN orders o ON u.user_id = o.user_id
    GROUP BY u.user_id
),

-- è®¡ç®—ä¼šå‘˜ç­‰çº§
member_level AS (
    SELECT 
        user_id,
        total_orders,
        total_amount,
        CASE 
            WHEN total_amount >= 50000 AND recent_orders >= 5 THEN 'VIP'
            WHEN total_amount >= 20000 AND total_orders >= 10 THEN 'é‡‘ç‰Œ'
            WHEN total_amount >= 5000 AND total_orders >= 5 THEN 'é“¶ç‰Œ'
            WHEN total_orders >= 1 THEN 'é“œç‰Œ'
            ELSE 'æ–°ç”¨æˆ·'
        END as member_grade
    FROM user_metrics
),

-- è®¡ç®—ä¼˜æƒ æŠ˜æ‰£
discount_calculation AS (
    SELECT 
        user_id,
        member_grade,
        CASE member_grade
            WHEN 'VIP' THEN 0.80
            WHEN 'é‡‘ç‰Œ' THEN 0.85
            WHEN 'é“¶ç‰Œ' THEN 0.90
            ELSE 1.00
        END as discount_rate
    FROM member_level
)

-- æœ€ç»ˆè¾“å‡ºå®Œæ•´çš„ä¼šå‘˜ä¿¡æ¯
SELECT 
    dc.user_id as 'ç”¨æˆ·ID',
    dc.member_grade as 'ä¼šå‘˜ç­‰çº§',
    CONCAT(ROUND((1 - dc.discount_rate) * 100, 1), 'æŠ˜') as 'ä¸“äº«æŠ˜æ‰£',
    FORMAT(ml.total_amount, 2) as 'ç´¯è®¡æ¶ˆè´¹é¢'
FROM discount_calculation dc
JOIN member_level ml ON dc.user_id = ml.user_id
ORDER BY ml.total_amount DESC;
```

**ğŸ¯ ä¸šåŠ¡ä»·å€¼**ï¼š
- **é€»è¾‘æ¸…æ™°**ï¼šæ¯ä¸ªCTEè´Ÿè´£ä¸€ä¸ªè®¡ç®—ç¯èŠ‚
- **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹ç­‰çº§è§„åˆ™åªéœ€è¦æ”¹å¯¹åº”çš„CTE
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä¸€æ¬¡æŸ¥è¯¢å®Œæˆæ‰€æœ‰è®¡ç®—ï¼Œé¿å…å¤šæ¬¡æ•°æ®åº“è®¿é—®

### 4.2 åŠ¨æ€å®šä»·ç­–ç•¥å®ç°


**ä¸šåŠ¡åœºæ™¯**ï¼šæ ¹æ®åº“å­˜ã€é”€é‡ç­‰å› ç´ åŠ¨æ€è°ƒæ•´å•†å“ä»·æ ¼

```sql
-- åŠ¨æ€å®šä»·ç­–ç•¥CTE
WITH 
-- å•†å“åŸºç¡€æ•°æ®
product_base AS (
    SELECT 
        p.product_id, p.product_name, p.base_price, i.stock_quantity
    FROM products p
    JOIN inventory i ON p.product_id = i.product_id
),

-- åº“å­˜å‹åŠ›è¯„ä¼°
inventory_pressure AS (
    SELECT 
        pb.product_id, pb.product_name, pb.base_price, pb.stock_quantity,
        CASE 
            WHEN pb.stock_quantity > 1000 THEN 'åº“å­˜ç§¯å‹'
            WHEN pb.stock_quantity < 50 THEN 'åº“å­˜ç´§å¼ '
            ELSE 'åº“å­˜æ­£å¸¸'
        END as inventory_status
    FROM product_base pb
),

-- åŠ¨æ€å®šä»·è®¡ç®—
dynamic_pricing AS (
    SELECT 
        product_name, base_price, inventory_status,
        CASE 
            WHEN inventory_status = 'åº“å­˜ç§¯å‹' THEN base_price * 0.8
            WHEN inventory_status = 'åº“å­˜ç´§å¼ ' THEN base_price * 1.2
            ELSE base_price
        END as suggested_price
    FROM inventory_pressure
)

-- è¾“å‡ºå®šä»·å»ºè®®
SELECT 
    product_name as 'å•†å“åç§°',
    FORMAT(base_price, 2) as 'åŸä»·',
    FORMAT(suggested_price, 2) as 'å»ºè®®ä»·æ ¼',
    CONCAT(ROUND((suggested_price - base_price) / base_price * 100, 1), '%') as 'è°ƒä»·å¹…åº¦',
    inventory_status as 'åº“å­˜çŠ¶æ€'
FROM dynamic_pricing
WHERE ABS(suggested_price - base_price) > 0.01
ORDER BY ABS(suggested_price - base_price) DESC;
```

---

## 5. ğŸ”„ å¤šæ­¥éª¤æ•°æ®å¤„ç†


### 5.1 å¤æ‚æ•°æ®è½¬æ¢æµæ°´çº¿


**ä¸šåŠ¡åœºæ™¯**ï¼šå°†åŸå§‹è®¢å•æ•°æ®è½¬æ¢ä¸ºè´¢åŠ¡æŠ¥è¡¨æ ¼å¼

**å¤„ç†æµç¨‹å›¾ç¤º**ï¼š
```
åŸå§‹è®¢å•æ•°æ® â†’ æ•°æ®æ¸…ç† â†’ é‡‘é¢è®¡ç®— â†’ æ±‡æ€»ç»Ÿè®¡ â†’ è´¢åŠ¡æŠ¥è¡¨
     â†“           â†“         â†“         â†“         â†“
  CTE_1      CTE_2     CTE_3     CTE_4   æœ€ç»ˆæŸ¥è¯¢
```

```sql
-- è´¢åŠ¡æŠ¥è¡¨æ•°æ®å¤„ç†æµæ°´çº¿
WITH 
-- åŸå§‹æ•°æ®æ¸…ç†
clean_orders AS (
    SELECT 
        order_id, customer_id, order_date, quantity, unit_price,
        CASE 
            WHEN discount_rate BETWEEN 0 AND 1 THEN discount_rate
            ELSE 0
        END as valid_discount_rate
    FROM raw_order_data
    WHERE order_date IS NOT NULL AND quantity > 0
),

-- åŸºç¡€é‡‘é¢è®¡ç®—
amount_calculation AS (
    SELECT 
        order_id, customer_id, order_date,
        quantity * unit_price * (1 - valid_discount_rate) as net_amount
    FROM clean_orders
),

-- æŒ‰æœˆæ±‡æ€»
monthly_summary AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') as month_key,
        COUNT(DISTINCT order_id) as order_count,
        SUM(net_amount) as net_sales
    FROM amount_calculation
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
),

-- è®¡ç®—åŒæ¯”å¢é•¿
growth_analysis AS (
    SELECT 
        m1.month_key,
        m1.net_sales as current_sales,
        m2.net_sales as last_year_sales,
        CASE 
            WHEN m2.net_sales > 0 
            THEN ROUND((m1.net_sales - m2.net_sales) / m2.net_sales * 100, 2)
            ELSE NULL
        END as growth_rate
    FROM monthly_summary m1
    LEFT JOIN monthly_summary m2 ON 
        m1.month_key = DATE_FORMAT(DATE_ADD(STR_TO_DATE(m2.month_key, '%Y-%m'), INTERVAL 12 MONTH), '%Y-%m')
)

-- ç”Ÿæˆæœ€ç»ˆè´¢åŠ¡æŠ¥è¡¨
SELECT 
    ms.month_key as 'æœˆä»½',
    ms.order_count as 'è®¢å•æ•°é‡',
    FORMAT(ms.net_sales, 2) as 'å‡€é”€å”®é¢',
    CONCAT(COALESCE(ga.growth_rate, 0), '%') as 'åŒæ¯”å¢é•¿'
FROM monthly_summary ms
LEFT JOIN growth_analysis ga ON ms.month_key = ga.month_key
ORDER BY ms.month_key DESC;
```

**ğŸ’¡ å¤šæ­¥éª¤å¤„ç†çš„ä¼˜åŠ¿**ï¼š
- **é€»è¾‘æ¸…æ™°**ï¼šæ¯ä¸ªæ­¥éª¤èŒè´£æ˜ç¡®
- **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªCTE
- **ä¾¿äºç»´æŠ¤**ï¼šä¿®æ”¹æŸä¸ªæ­¥éª¤ä¸å½±å“å…¶ä»–æ­¥éª¤

---

## 6. ğŸ” æ¡ä»¶é€’å½’æŸ¥è¯¢æŠ€æœ¯


### 6.1 ä»€ä¹ˆæ˜¯æ¡ä»¶é€’å½’


**é€šä¿—ç†è§£**ï¼š
æ¡ä»¶é€’å½’å°±åƒ"ä¿„ç½—æ–¯å¥—å¨ƒ"ï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œä½†æ¯ä¸€å±‚éƒ½æœ‰ç‰¹å®šçš„æ¡ä»¶æ‰ä¼šç»§ç»­å¾€ä¸‹æ‹†ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œå°±æ˜¯æ ¹æ®ä¸åŒæ¡ä»¶æ¥å†³å®šé€’å½’çš„æ·±åº¦å’Œæ–¹å‘ã€‚

```
ä¼ ç»Ÿé€’å½’ï¼šä¸€ç›´å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æ²¡æœ‰å­èŠ‚ç‚¹
æ¡ä»¶é€’å½’ï¼šæ»¡è¶³ç‰¹å®šæ¡ä»¶æ‰ç»§ç»­å¾€ä¸‹æ‰¾

ä¾‹å¦‚ï¼šæŸ¥æ‰¾ç»„ç»‡æ¶æ„
æ™®é€šé€’å½’ï¼šæ‰¾å‡ºæ‰€æœ‰ä¸‹çº§ï¼Œä¸ç®¡å±‚çº§
æ¡ä»¶é€’å½’ï¼šåªæ‰¾å‡ºçº§åˆ«>=ç»ç†çš„ä¸‹çº§ï¼Œæˆ–è€…åªæ‰¾3å±‚ä»¥å†…çš„ä¸‹çº§
```

### 6.2 æ¡ä»¶é€’å½’çš„å®é™…åº”ç”¨


**åœºæ™¯ï¼šå—é™å±‚çº§çš„ç»„ç»‡æ¶æ„æŸ¥è¯¢**

```sql
-- æŸ¥æ‰¾æŸç®¡ç†è€…çš„ä¸‹å±ï¼Œé™åˆ¶åœ¨3å±‚ä»¥å†…
WITH RECURSIVE management_tree AS (
    -- é€’å½’èµ·ç‚¹ï¼šæŒ‡å®šçš„ç®¡ç†è€…
    SELECT 
        emp_id, emp_name, manager_id, position_level, 0 as depth,
        CAST(emp_name as CHAR(1000)) as hierarchy_path
    FROM employees 
    WHERE emp_id = 1001
    
    UNION ALL
    
    -- é€’å½’æŸ¥æ‰¾ï¼šæœ‰æ¡ä»¶çš„ä¸‹çº§æŸ¥æ‰¾
    SELECT 
        e.emp_id, e.emp_name, e.manager_id, e.position_level, mt.depth + 1,
        CONCAT(mt.hierarchy_path, ' â†’ ', e.emp_name)
    FROM employees e
    JOIN management_tree mt ON e.manager_id = mt.emp_id
    WHERE mt.depth < 3  -- é™åˆ¶é€’å½’æ·±åº¦
    AND e.position_level >= 3  -- åªåŒ…å«çº§åˆ«>=3çš„å‘˜å·¥
    AND e.status = 'active'  -- åªåŒ…å«åœ¨èŒå‘˜å·¥
)

SELECT 
    CONCAT(REPEAT('ã€€', depth * 2), emp_name) as 'ç»„ç»‡æ¶æ„',
    position_level as 'èŒçº§',
    depth as 'å±‚çº§'
FROM management_tree
ORDER BY depth, emp_id;
```

### 6.3 å¸¦ä¸šåŠ¡é€»è¾‘çš„è·¯å¾„æŸ¥è¯¢


**åœºæ™¯ï¼šä¾›åº”é“¾è·¯å¾„ä¼˜åŒ–**

```sql
-- ä¾›åº”é“¾æœ€ä¼˜è·¯å¾„æŸ¥è¯¢
WITH RECURSIVE supply_chain AS (
    -- èµ·ç‚¹ï¼šä¾›åº”å•†
    SELECT 
        location_id, location_name, 0 as total_cost, 0 as total_days,
        CAST(location_name as CHAR(1000)) as route_path, 0 as hop_count
    FROM supply_locations 
    WHERE location_type = 'supplier' AND region = 'asia'
    
    UNION ALL
    
    -- é€’å½’è·¯å¾„ï¼šæœ‰æ¡ä»¶çš„è·¯å¾„æ‰©å±•
    SELECT 
        sr.destination_id, sl.location_name,
        sc.total_cost + sr.shipping_cost,
        sc.total_days + sr.shipping_days,
        CONCAT(sc.route_path, ' â†’ ', sl.location_name),
        sc.hop_count + 1
    FROM supply_chain sc
    JOIN shipping_routes sr ON sc.location_id = sr.source_id
    JOIN supply_locations sl ON sr.destination_id = sl.location_id
    WHERE sc.hop_count < 4  -- æœ€å¤š4ä¸ªä¸­è½¬ç«™
    AND sc.total_cost + sr.shipping_cost < 10000  -- æ€»æˆæœ¬é™åˆ¶
    AND sc.total_days + sr.shipping_days < 15  -- æ€»æ—¶é—´é™åˆ¶
)

-- æ‰¾å‡ºåˆ°è¾¾ç›®æ ‡åŸå¸‚çš„æœ€ä¼˜è·¯å¾„
SELECT 
    route_path as 'ä¾›åº”é“¾è·¯å¾„',
    total_cost as 'æ€»æˆæœ¬',
    total_days as 'æ€»å¤©æ•°'
FROM supply_chain
WHERE location_name = 'ä¸Šæµ·ä»“åº“'
ORDER BY (total_cost * 0.7 + total_days * 100 * 0.3)  -- ç»¼åˆè¯„åˆ†
LIMIT 5;
```

---

## 7. ğŸ² åŠ¨æ€æ•°æ®ç”Ÿæˆåº”ç”¨


### 7.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æ•°æ®ç”Ÿæˆ


**é€šä¿—è§£é‡Š**ï¼š
åŠ¨æ€æ•°æ®ç”Ÿæˆå°±åƒä¸€ä¸ª"æ•°æ®å·¥å‚"ï¼Œæ ¹æ®ä½ è®¾å®šçš„è§„åˆ™å’Œæ¡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿäº§å‡ºä½ éœ€è¦çš„æ•°æ®ã€‚ä¸æ˜¯ä»è¡¨é‡ŒæŸ¥ç°æœ‰çš„æ•°æ®ï¼Œè€Œæ˜¯æ ¹æ®é€»è¾‘"åˆ¶é€ "æ–°æ•°æ®ã€‚

```
é™æ€æŸ¥è¯¢ï¼šä»è¡¨ä¸­æ‰¾å‡ºå·²æœ‰çš„é”€å”®è®°å½•
åŠ¨æ€ç”Ÿæˆï¼šåˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æ—¥æœŸåºåˆ—ï¼ŒåŒ…æ‹¬æ²¡æœ‰é”€å”®çš„æ—¥æœŸ

ç”¨é€”ä¸¾ä¾‹ï¼š
â€¢ ç”Ÿæˆæ—¥æœŸåºåˆ—ï¼šç”¨äºå¡«è¡¥æ—¶é—´è½´ä¸Šçš„ç©ºç™½
â€¢ åˆ›å»ºæµ‹è¯•æ•°æ®ï¼šç”¨äºç³»ç»Ÿæµ‹è¯•
â€¢ æ¨¡æ‹Ÿæ•°æ®åˆ†æï¼šç”¨äºé¢„æµ‹åˆ†æ
```

### 7.2 æ—¶é—´åºåˆ—æ•°æ®ç”Ÿæˆ


**åœºæ™¯ï¼šç”Ÿæˆå®Œæ•´çš„æ—¥æœŸåºåˆ—ç”¨äºé”€å”®åˆ†æ**

```sql
-- ç”Ÿæˆè¿‡å»30å¤©çš„å®Œæ•´æ—¥æœŸåºåˆ—å’Œé”€å”®æ•°æ®
WITH RECURSIVE 
-- ç”Ÿæˆè¿ç»­æ—¥æœŸåºåˆ—
date_series AS (
    SELECT CURDATE() - INTERVAL 29 DAY as date_value
    UNION ALL
    SELECT date_value + INTERVAL 1 DAY
    FROM date_series
    WHERE date_value < CURDATE()
),

-- å…³è”å®é™…é”€å”®æ•°æ®
daily_sales AS (
    SELECT 
        ds.date_value,
        DAYNAME(ds.date_value) as week_day,
        COALESCE(SUM(o.amount), 0) as daily_amount,
        COUNT(o.order_id) as order_count
    FROM date_series ds
    LEFT JOIN orders o ON DATE(o.order_date) = ds.date_value
    GROUP BY ds.date_value
),

-- è®¡ç®—ç§»åŠ¨å¹³å‡
moving_average AS (
    SELECT 
        date_value, week_day, daily_amount, order_count,
        AVG(daily_amount) OVER (
            ORDER BY date_value 
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) as ma_7days
    FROM daily_sales
)

-- è¾“å‡ºå®Œæ•´çš„é”€å”®è¶‹åŠ¿åˆ†æ
SELECT 
    date_value as 'æ—¥æœŸ',
    week_day as 'æ˜ŸæœŸ',
    FORMAT(daily_amount, 2) as 'å½“æ—¥é”€å”®é¢',
    FORMAT(ma_7days, 2) as '7å¤©å‡å€¼',
    CASE 
        WHEN daily_amount > ma_7days * 1.2 THEN 'å¼‚å¸¸é«˜'
        WHEN daily_amount < ma_7days * 0.8 THEN 'å¼‚å¸¸ä½'
        ELSE 'æ­£å¸¸'
    END as 'è¶‹åŠ¿æ ‡è®°'
FROM moving_average
ORDER BY date_value DESC;
```

### 7.3 æ•°å€¼åºåˆ—ç”Ÿæˆåº”ç”¨


**åœºæ™¯ï¼šç”Ÿæˆæ•°å­—åºåˆ—ç”¨äºæ•°æ®åˆ†æ**

```sql
-- ç”Ÿæˆè®¢å•é‡‘é¢åˆ†å¸ƒåˆ†æ
WITH RECURSIVE number_series AS (
    SELECT 1 as num
    UNION ALL
    SELECT num + 1
    FROM number_series
    WHERE num < 50
),

-- åˆ†æè®¢å•é‡‘é¢åˆ†å¸ƒ
amount_distribution AS (
    SELECT 
        ns.num * 100 as amount_range_start,
        (ns.num + 1) * 100 as amount_range_end,
        COUNT(o.order_id) as order_count
    FROM number_series ns
    LEFT JOIN orders o ON o.amount >= ns.num * 100 
                      AND o.amount < (ns.num + 1) * 100
    GROUP BY ns.num
)

SELECT 
    CONCAT(amount_range_start, '-', amount_range_end) as 'é‡‘é¢åŒºé—´',
    order_count as 'è®¢å•æ•°',
    CONCAT(REPEAT('â–ˆ', LEAST(order_count / 10, 10)), 
           REPEAT('â–‘', 10 - LEAST(order_count / 10, 10))) as 'åˆ†å¸ƒå›¾ç¤º'
FROM amount_distribution
WHERE order_count > 0
ORDER BY amount_range_start;
```

---

## 8. ğŸ—ï¸ CTEé«˜çº§è®¾è®¡æ¨¡å¼


### 8.1 åˆ†å±‚æ•°æ®å¤„ç†æ¨¡å¼


**è®¾è®¡æ€è·¯**ï¼š
æŠŠå¤æ‚çš„æ•°æ®å¤„ç†åˆ†æˆå¤šä¸ªå±‚æ¬¡ï¼Œæ¯å±‚ä¸“é—¨è´Ÿè´£ä¸€ç±»å¤„ç†ï¼Œå±‚ä¸å±‚ä¹‹é—´æœ‰æ¸…æ™°çš„æ•°æ®æµå‘ã€‚

```
è®¾è®¡æ¨¡å¼ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸå§‹æ•°æ®å±‚     â”‚ â† æ•°æ®è·å–å’ŒåŸºç¡€è¿‡æ»¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¸…æ´—å¤„ç†å±‚     â”‚ â† æ•°æ®æ¸…ç†å’Œæ ‡å‡†åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è®¡ç®—é€»è¾‘å±‚     â”‚ â† ä¸šåŠ¡é€»è¾‘å’Œæ•°å­¦è®¡ç®—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   èšåˆç»Ÿè®¡å±‚     â”‚ â† æ•°æ®æ±‡æ€»å’Œåˆ†ç»„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è¾“å‡ºæ ¼å¼å±‚     â”‚ â† æ ¼å¼åŒ–å’Œå±•ç¤º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ¨¡æ¿**ï¼š
```sql
-- CTEåˆ†å±‚å¤„ç†è®¾è®¡æ¨¡å¼
WITH 
-- ç¬¬1å±‚ï¼šåŸå§‹æ•°æ®è·å–
raw_data AS (
    SELECT * FROM main_table WHERE basic_conditions
),

-- ç¬¬2å±‚ï¼šæ•°æ®æ¸…æ´—
cleaned_data AS (
    SELECT cleaned_fields FROM raw_data WHERE quality_filters
),

-- ç¬¬3å±‚ï¼šä¸šåŠ¡è®¡ç®—
calculated_data AS (
    SELECT *, business_calculations FROM cleaned_data
),

-- ç¬¬4å±‚ï¼šæ•°æ®èšåˆ
aggregated_data AS (
    SELECT group_fields, aggregations FROM calculated_data GROUP BY group_fields
),

-- ç¬¬5å±‚ï¼šæ ¼å¼åŒ–è¾“å‡º
formatted_output AS (
    SELECT final_formatted_fields FROM aggregated_data
)

SELECT * FROM formatted_output;
```

### 8.2 ç®¡é“å¼æ•°æ®æµæ¨¡å¼


**è®¾è®¡ç†å¿µ**ï¼š
åƒå·¥å‚æµæ°´çº¿ä¸€æ ·ï¼Œæ•°æ®åœ¨ä¸åŒçš„"å·¥ä½œç«™"ï¼ˆCTEï¼‰ä¹‹é—´æµåŠ¨ï¼Œæ¯ä¸ªå·¥ä½œç«™ä¸“é—¨è´Ÿè´£ä¸€ç§å¤„ç†ã€‚

**åº”ç”¨ç¤ºä¾‹ï¼šç”¨æˆ·æ ‡ç­¾ç”Ÿæˆæµæ°´çº¿**

```sql
-- ç”¨æˆ·ç”»åƒæ ‡ç­¾ç”Ÿæˆç®¡é“
WITH 
-- å·¥ä½œç«™1ï¼šç”¨æˆ·åŸºç¡€ä¿¡æ¯æ”¶é›†
user_basic_info AS (
    SELECT 
        user_id, age, gender, city,
        DATEDIFF(CURDATE(), registration_date) as member_days
    FROM users
),

-- å·¥ä½œç«™2ï¼šæ¶ˆè´¹è¡Œä¸ºåˆ†æ
consumption_behavior AS (
    SELECT 
        ubi.user_id, ubi.age, ubi.gender, ubi.city,
        COUNT(o.order_id) as total_orders,
        COALESCE(SUM(o.amount), 0) as total_consumption
    FROM user_basic_info ubi
    LEFT JOIN orders o ON ubi.user_id = o.user_id
    GROUP BY ubi.user_id, ubi.age, ubi.gender, ubi.city
),

-- å·¥ä½œç«™3ï¼šç”¨æˆ·æ ‡ç­¾ç”Ÿæˆ
user_tags AS (
    SELECT 
        user_id,
        CASE 
            WHEN age < 25 THEN 'å¹´è½»ç¾¤ä½“'
            WHEN age < 40 THEN 'ä¸­é’å¹´ç¾¤ä½“'
            ELSE 'æˆç†Ÿç¾¤ä½“'
        END as age_tag,
        CASE 
            WHEN total_consumption > 10000 THEN 'é«˜æ¶ˆè´¹'
            WHEN total_consumption > 2000 THEN 'ä¸­æ¶ˆè´¹'
            ELSE 'ä½æ¶ˆè´¹'
        END as consumption_level
    FROM consumption_behavior
)

-- è¾“å‡ºç”¨æˆ·ç”»åƒæ ‡ç­¾
SELECT 
    user_id as 'ç”¨æˆ·ID',
    age_tag as 'å¹´é¾„æ ‡ç­¾',
    gender as 'æ€§åˆ«',
    city as 'åœ°åŒº',
    consumption_level as 'æ¶ˆè´¹æ°´å¹³'
FROM user_tags
ORDER BY 
    CASE consumption_level
        WHEN 'é«˜æ¶ˆè´¹' THEN 1
        WHEN 'ä¸­æ¶ˆè´¹' THEN 2
        ELSE 3
    END;
```

### 8.3 æ¡ä»¶åˆ†æ”¯å¤„ç†æ¨¡å¼


**åº”ç”¨åœºæ™¯ï¼šæ ¹æ®ä¸åŒæ¡ä»¶æ‰§è¡Œä¸åŒçš„å¤„ç†é€»è¾‘**

```sql
-- å¤šæ¸ é“é”€å”®æ•°æ®ç»Ÿä¸€å¤„ç†
WITH 
-- åˆ†æ”¯1ï¼šçº¿ä¸Šæ¸ é“æ•°æ®å¤„ç†
online_sales AS (
    SELECT 
        'online' as channel, product_id, SUM(quantity) as total_quantity,
        SUM(amount) as total_amount, COUNT(DISTINCT customer_id) as customer_count
    FROM online_orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    GROUP BY product_id
),

-- åˆ†æ”¯2ï¼šçº¿ä¸‹æ¸ é“æ•°æ®å¤„ç†
offline_sales AS (
    SELECT 
        'offline' as channel, product_id, SUM(quantity) as total_quantity,
        SUM(amount) as total_amount, COUNT(DISTINCT store_id) as store_count
    FROM offline_orders
    WHERE sale_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    GROUP BY product_id
),

-- ç»Ÿä¸€æ•°æ®æ ¼å¼
unified_sales AS (
    SELECT channel, product_id, total_quantity, total_amount FROM online_sales
    UNION ALL
    SELECT channel, product_id, total_quantity, total_amount FROM offline_sales
)

-- ç”Ÿæˆæ¸ é“å¯¹æ¯”åˆ†æ
SELECT 
    p.product_name as 'å•†å“åç§°',
    us.channel as 'é”€å”®æ¸ é“',
    us.total_quantity as 'é”€å”®æ•°é‡',
    FORMAT(us.total_amount, 2) as 'é”€å”®é‡‘é¢'
FROM unified_sales us
JOIN products p ON us.product_id = p.product_id
ORDER BY p.product_name, us.total_amount DESC;
```

---

## 9. ğŸ¢ å¤æ‚ä¸šåŠ¡åœºæ™¯å®ç°


### 9.1 ç”µå•†å¹³å°ä¿ƒé”€æ•ˆæœåˆ†æ


**ä¸šåŠ¡éœ€æ±‚**ï¼šåˆ†æä¸åŒä¿ƒé”€æ´»åŠ¨çš„æ•ˆæœï¼ŒåŒ…æ‹¬é”€é‡æå‡ã€åˆ©æ¶¦å½±å“ã€ç”¨æˆ·å‚ä¸åº¦ç­‰å¤šä¸ªç»´åº¦

```sql
-- ä¿ƒé”€æ´»åŠ¨æ•ˆæœç»¼åˆåˆ†æ
WITH 
-- ä¿ƒé”€æœŸé—´åŸºç¡€æ•°æ®
promotion_base AS (
    SELECT 
        p.promotion_id, p.promotion_name, oi.product_id,
        SUM(oi.quantity) as promotion_quantity,
        SUM(oi.quantity * oi.sale_price) as actual_revenue,
        COUNT(DISTINCT o.customer_id) as participating_users
    FROM promotions p
    JOIN orders o ON o.order_date BETWEEN p.start_date AND p.end_date
    JOIN order_items oi ON o.order_id = oi.order_id
    WHERE p.end_date < CURDATE()
    GROUP BY p.promotion_id, p.promotion_name, oi.product_id
),

-- å¯¹æ¯”æœŸé—´æ•°æ®
comparison_period AS (
    SELECT 
        pb.promotion_id,
        AVG(oi.quantity) as baseline_avg_quantity
    FROM promotion_base pb
    JOIN order_items oi ON pb.product_id = oi.product_id
    JOIN orders o ON oi.order_id = o.order_id
    WHERE o.order_date < (SELECT MIN(start_date) FROM promotions WHERE promotion_id = pb.promotion_id)
    GROUP BY pb.promotion_id
),

-- ä¿ƒé”€æ•ˆæœè®¡ç®—
promotion_impact AS (
    SELECT 
        pb.promotion_id, pb.promotion_name,
        SUM(pb.participating_users) as total_users,
        SUM(pb.actual_revenue) as total_revenue,
        AVG(cp.baseline_avg_quantity) as baseline_quantity,
        ROUND((SUM(pb.promotion_quantity) / AVG(cp.baseline_avg_quantity) - 1) * 100, 2) as quantity_lift
    FROM promotion_base pb
    LEFT JOIN comparison_period cp ON pb.promotion_id = cp.promotion_id
    GROUP BY pb.promotion_id, pb.promotion_name
)

-- æœ€ç»ˆä¿ƒé”€æ•ˆæœæŠ¥è¡¨
SELECT 
    promotion_name as 'ä¿ƒé”€æ´»åŠ¨',
    total_users as 'å‚ä¸ç”¨æˆ·æ•°',
    FORMAT(total_revenue, 2) as 'å®é™…æ”¶å…¥',
    CONCAT(quantity_lift, '%') as 'é”€é‡æå‡',
    CASE 
        WHEN quantity_lift > 50 THEN 'ä¼˜ç§€'
        WHEN quantity_lift > 20 THEN 'è‰¯å¥½'
        WHEN quantity_lift > 0 THEN 'ä¸€èˆ¬'
        ELSE 'éœ€æ”¹è¿›'
    END as 'æ•ˆæœè¯„çº§'
FROM promotion_impact
ORDER BY total_revenue DESC;
```

### 9.2 ä¾›åº”é“¾åº“å­˜ä¼˜åŒ–åˆ†æ


**ä¸šåŠ¡éœ€æ±‚**ï¼šåˆ†æåº“å­˜å‘¨è½¬æƒ…å†µï¼Œè¯†åˆ«æ»é”€å•†å“ï¼Œåˆ¶å®šè¡¥è´§ç­–ç•¥

```sql
-- ä¾›åº”é“¾åº“å­˜ä¼˜åŒ–åˆ†æ
WITH 
-- å•†å“é”€å”®é€Ÿåº¦åˆ†æ
sales_velocity AS (
    SELECT 
        oi.product_id,
        SUM(oi.quantity) / 90.0 as daily_sales_rate  -- 90å¤©å¹³å‡æ—¥é”€é‡
    FROM order_items oi
    JOIN orders o ON oi.order_id = o.order_id
    WHERE o.order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
    GROUP BY oi.product_id
),

-- å½“å‰åº“å­˜çŠ¶æ€
current_inventory AS (
    SELECT 
        i.product_id, i.stock_quantity, i.safety_stock
    FROM inventory i
),

-- åº“å­˜å‘¨è½¬åˆ†æ
inventory_turnover AS (
    SELECT 
        ci.product_id, ci.stock_quantity,
        COALESCE(sv.daily_sales_rate, 0) as daily_sales_rate,
        CASE 
            WHEN sv.daily_sales_rate > 0 
            THEN ci.stock_quantity / sv.daily_sales_rate
            ELSE 999
        END as days_of_stock
    FROM current_inventory ci
    LEFT JOIN sales_velocity sv ON ci.product_id = sv.product_id
),

-- è¡¥è´§ç­–ç•¥å»ºè®®
restock_strategy AS (
    SELECT 
        it.*,
        CASE 
            WHEN it.days_of_stock < 7 THEN 'ç´§æ€¥è¡¥è´§'
            WHEN it.days_of_stock < 15 THEN 'éœ€è¦è¡¥è´§'
            WHEN it.days_of_stock > 90 THEN 'åº“å­˜ç§¯å‹'
            ELSE 'åº“å­˜æ­£å¸¸'
        END as stock_status,
        CASE 
            WHEN it.days_of_stock < 15 THEN 
                GREATEST(it.daily_sales_rate * 30 - it.stock_quantity, 0)
            ELSE 0
        END as suggested_restock_quantity
    FROM inventory_turnover it
)

-- ç”Ÿæˆåº“å­˜ç®¡ç†æŠ¥è¡¨
SELECT 
    p.product_name as 'å•†å“åç§°',
    rs.stock_quantity as 'å½“å‰åº“å­˜',
    ROUND(rs.daily_sales_rate, 2) as 'æ—¥å‡é”€é‡',
    ROUND(rs.days_of_stock, 1) as 'åº“å­˜å¤©æ•°',
    rs.stock_status as 'åº“å­˜çŠ¶æ€',
    rs.suggested_restock_quantity as 'å»ºè®®è¡¥è´§é‡'
FROM restock_strategy rs
JOIN products p ON rs.product_id = p.product_id
WHERE rs.stock_status != 'åº“å­˜æ­£å¸¸'
ORDER BY 
    CASE rs.stock_status
        WHEN 'ç´§æ€¥è¡¥è´§' THEN 1
        WHEN 'éœ€è¦è¡¥è´§' THEN 2
        ELSE 3
    END;
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ CTEé«˜çº§åº”ç”¨ï¼šå¤šæ­¥éª¤å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘çš„SQLæŠ€æœ¯
ğŸ”¸ é€’å½’CTEï¼šå¤„ç†å±‚çº§æ•°æ®å’Œè·¯å¾„æŸ¥è¯¢çš„å¼ºå¤§å·¥å…·
ğŸ”¸ åŠ¨æ€æ•°æ®ç”Ÿæˆï¼šæ ¹æ®è§„åˆ™åˆ›å»ºæ•°æ®åºåˆ—ï¼Œè¡¥å……ç¼ºå¤±æ•°æ®
ğŸ”¸ ä¸šåŠ¡é€»è¾‘å°è£…ï¼šå°†å¤æ‚è®¡ç®—è§„åˆ™å°è£…åœ¨CTEä¸­
ğŸ”¸ æ•°æ®æ¸…æ´—æµç¨‹ï¼šæ ‡å‡†åŒ–ã€éªŒè¯ã€å»é‡çš„ç³»ç»ŸåŒ–å¤„ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CTEé«˜çº§åº”ç”¨çš„æ ¸å¿ƒä»·å€¼**
```
ä»£ç å¯è¯»æ€§ï¼š
â€¢ é€»è¾‘åˆ†å±‚æ¸…æ™°ï¼Œæ¯ä¸ªCTEèŒè´£å•ä¸€
â€¢ å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªç®€å•æ­¥éª¤
â€¢ ä¾¿äºç†è§£ã€è°ƒè¯•å’Œç»´æŠ¤

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ é¿å…é‡å¤è®¡ç®—ï¼Œæ•°æ®åªæ‰«æä¸€æ¬¡
â€¢ MySQLä¼˜åŒ–å™¨èƒ½æ›´å¥½åœ°ä¼˜åŒ–CTE
â€¢ å‡å°‘ä¸´æ—¶è¡¨çš„åˆ›å»ºå’Œç®¡ç†å¼€é”€

ä¸šåŠ¡é€‚åº”æ€§ï¼š
â€¢ èƒ½å¤Ÿå¤„ç†å„ç§å¤æ‚çš„ä¸šåŠ¡åœºæ™¯
â€¢ æ”¯æŒåŠ¨æ€é€»è¾‘å’Œæ¡ä»¶å¤„ç†
â€¢ ä¾¿äºä¸šåŠ¡è§„åˆ™çš„è°ƒæ•´å’Œæ‰©å±•
```

**ğŸ”¹ è®¾è®¡æ¨¡å¼çš„é€‰æ‹©åŸåˆ™**
```
åˆ†å±‚å¤„ç†æ¨¡å¼ï¼š
â€¢ é€‚ç”¨äºæ•°æ®å¤„ç†æ­¥éª¤æ˜ç¡®çš„åœºæ™¯
â€¢ æ¯å±‚ä¸“é—¨è´Ÿè´£ä¸€ç±»å¤„ç†æ“ä½œ
â€¢ ä¾¿äºå•ç‹¬æµ‹è¯•å’Œç»´æŠ¤

ç®¡é“å¼æ•°æ®æµï¼š
â€¢ é€‚ç”¨äºæµæ°´çº¿å¼çš„æ•°æ®åŠ å·¥
â€¢ æ•°æ®åœ¨ä¸åŒå·¥ä½œç«™é—´æµåŠ¨
â€¢ æ”¯æŒå¹¶è¡Œå¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–

æ¡ä»¶åˆ†æ”¯å¤„ç†ï¼š
â€¢ é€‚ç”¨äºå¤šæ¸ é“ã€å¤šç±»å‹æ•°æ®ç»Ÿä¸€å¤„ç†
â€¢ æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒçš„å¤„ç†é€»è¾‘
â€¢ æé«˜ä»£ç å¤ç”¨æ€§å’Œä¸€è‡´æ€§
```

**ğŸ”¹ é€’å½’æŸ¥è¯¢çš„åº”ç”¨åœºæ™¯**
```
ç»„ç»‡æ¶æ„æŸ¥è¯¢ï¼š
â€¢ æŸ¥æ‰¾ä¸Šä¸‹çº§å…³ç³»
â€¢ è®¡ç®—å±‚çº§æ·±åº¦
â€¢ ç”Ÿæˆç»„ç»‡æ¶æ„è·¯å¾„

è·¯å¾„åˆ†æï¼š
â€¢ ä¾›åº”é“¾è·¯å¾„ä¼˜åŒ–
â€¢ ç½‘ç»œè·¯ç”±åˆ†æ
â€¢ æˆæœ¬åˆ†è§£è®¡ç®—

æ¡ä»¶é€’å½’ï¼š
â€¢ å¸¦é™åˆ¶æ¡ä»¶çš„é€’å½’æŸ¥è¯¢
â€¢ ä¸šåŠ¡è§„åˆ™é©±åŠ¨çš„å±‚çº§å¤„ç†
â€¢ æ€§èƒ½ä¼˜åŒ–çš„é€’å½’æ§åˆ¶
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ“Š æŠ¥è¡¨ç³»ç»Ÿåº”ç”¨**
- å¤šç»´åº¦æ•°æ®åˆ†æå’Œå¯¹æ¯”
- å¤æ‚ä¸šåŠ¡æŒ‡æ ‡çš„è®¡ç®—
- åŠ¨æ€æŠ¥è¡¨ç”Ÿæˆå’Œå±•ç¤º

**ğŸ§¹ æ•°æ®æ²»ç†åº”ç”¨**  
- æ‰¹é‡æ•°æ®æ¸…æ´—å’Œæ ‡å‡†åŒ–
- æ•°æ®è´¨é‡æ£€æŸ¥å’Œç›‘æ§
- å†å²æ•°æ®è¿ç§»å’Œæ•´ç†

**ğŸ’¼ ä¸šåŠ¡åˆ†æåº”ç”¨**
- ç”¨æˆ·è¡Œä¸ºåˆ†æå’Œç”»åƒ
- é”€å”®æ¼æ–—å’Œè½¬åŒ–åˆ†æ
- é£é™©æ§åˆ¶å’Œå¼‚å¸¸æ£€æµ‹

**âš™ï¸ ç³»ç»Ÿä¼˜åŒ–åº”ç”¨**
- åº“å­˜ç®¡ç†å’Œä¾›åº”é“¾ä¼˜åŒ–
- å®šä»·ç­–ç•¥å’Œä¿ƒé”€åˆ†æ
- è´¢åŠ¡åˆ†æå’Œæˆæœ¬æ§åˆ¶

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ è®¾è®¡åŸåˆ™**
```
å•ä¸€èŒè´£ï¼šæ¯ä¸ªCTEä¸“æ³¨äºä¸€ä¸ªå…·ä½“ä»»åŠ¡
é€æ­¥ç»†åŒ–ï¼šä»ç²—ç²’åº¦åˆ°ç»†ç²’åº¦é€æ­¥å¤„ç†
å‘½åè§„èŒƒï¼šCTEåç§°è¦ä½“ç°å…¶åŠŸèƒ½å’Œç”¨é€”
æ³¨é‡Šå®Œå–„ï¼šå¤æ‚é€»è¾‘è¦æœ‰è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
ç´¢å¼•ä¼˜åŒ–ï¼šç¡®ä¿å…³è”å­—æ®µæœ‰åˆé€‚çš„ç´¢å¼•
æ•°æ®è¿‡æ»¤ï¼šå°½æ—©è¿‡æ»¤ä¸éœ€è¦çš„æ•°æ®
é¿å…é‡å¤ï¼šåˆç†å¤ç”¨CTEç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
ç›‘æ§æ‰§è¡Œï¼šå®šæœŸæ£€æŸ¥æ‰§è¡Œè®¡åˆ’å’Œæ€§èƒ½æŒ‡æ ‡
```

**ğŸ”§ ç»´æŠ¤ç­–ç•¥**
```
æ¨¡å—åŒ–è®¾è®¡ï¼šå¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªå¯å¤ç”¨çš„CTE
ç‰ˆæœ¬æ§åˆ¶ï¼šé‡è¦çš„CTEæŸ¥è¯¢è¦è¿›è¡Œç‰ˆæœ¬ç®¡ç†
æµ‹è¯•éªŒè¯ï¼šæ¯ä¸ªCTEéƒ½è¦æœ‰å•ç‹¬çš„æµ‹è¯•ç”¨ä¾‹
æ–‡æ¡£è®°å½•ï¼šä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç°éƒ½è¦æœ‰æ–‡æ¡£
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- CTEé«˜çº§åº”ç”¨æ˜¯å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘çš„åˆ©å™¨
- åˆ†å±‚è®¾è®¡è®©å¤æ‚æŸ¥è¯¢å˜å¾—æ¸…æ™°æ˜“æ‡‚  
- é€’å½’CTEèƒ½å¤Ÿä¼˜é›…å¤„ç†å±‚çº§æ•°æ®
- åŠ¨æ€æ•°æ®ç”Ÿæˆå¡«è¡¥äº†é™æ€æŸ¥è¯¢çš„ç©ºç™½
- åˆç†çš„è®¾è®¡æ¨¡å¼æ˜¯æˆåŠŸåº”ç”¨çš„å…³é”®