---
title: 7ã€MySQLç‰¹æ®Šè¿æ¥åœºæ™¯å¤„ç†
---
## ğŸ“š ç›®å½•

1. [ç‰¹æ®Šè¿æ¥åœºæ™¯æ¦‚è¿°](#1-ç‰¹æ®Šè¿æ¥åœºæ™¯æ¦‚è¿°)
2. [å¤šå¯¹å¤šå…³è”å¤„ç†](#2-å¤šå¯¹å¤šå…³è”å¤„ç†)
3. [é€’å½’å…³è”æŸ¥è¯¢](#3-é€’å½’å…³è”æŸ¥è¯¢)
4. [æ—¶é—´å…³è”æŸ¥è¯¢](#4-æ—¶é—´å…³è”æŸ¥è¯¢)
5. [èŒƒå›´å…³è”æŸ¥è¯¢](#5-èŒƒå›´å…³è”æŸ¥è¯¢)
6. [æ¨¡ç³Šå…³è”å¤„ç†](#6-æ¨¡ç³Šå…³è”å¤„ç†)
7. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#7-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
8. [å®é™…åº”ç”¨æ¡ˆä¾‹](#8-å®é™…åº”ç”¨æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— ç‰¹æ®Šè¿æ¥åœºæ™¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç‰¹æ®Šè¿æ¥åœºæ™¯


> ğŸ’¡ **ä¸€å¥è¯ç†è§£**ï¼šç‰¹æ®Šè¿æ¥åœºæ™¯å°±åƒå¤æ‚çš„äººé™…å…³ç³»ç½‘ç»œï¼Œä¸æ˜¯ç®€å•çš„ä¸€å¯¹ä¸€å…³ç³»ï¼Œè€Œæ˜¯éœ€è¦å¤„ç†å¤šå¯¹å¤šã€é€’å½’ã€æ—¶é—´èŒƒå›´ç­‰å¤æ‚å…³è”æƒ…å†µã€‚

**ğŸ”¸ ç‰¹æ®Šè¿æ¥çš„æœ¬è´¨ç‰¹ç‚¹**
```
ä¸æ™®é€šè¿æ¥çš„åŒºåˆ«ï¼š
ğŸ“Š æ™®é€šè¿æ¥ï¼šç®€å•çš„ä¸»å¤–é”®å…³ç³»ï¼Œä¸€å¯¹ä¸€æˆ–ä¸€å¯¹å¤š
ğŸ”„ ç‰¹æ®Šè¿æ¥ï¼šå¤æ‚çš„ä¸šåŠ¡å…³ç³»ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†é€»è¾‘
â° åŠ¨æ€å…³è”ï¼šåŸºäºæ—¶é—´ã€èŒƒå›´ã€æ¡ä»¶çš„åŠ¨æ€å…³è”
ğŸ” æ¨¡ç³ŠåŒ¹é…ï¼šåŸºäºç›¸ä¼¼åº¦æˆ–éƒ¨åˆ†åŒ¹é…çš„å…³è”
```

### 1.2 å¸¸è§ç‰¹æ®Šè¿æ¥åœºæ™¯åˆ†ç±»


**ğŸ¯ åœºæ™¯åˆ†ç±»å¯¹æ¯”è¡¨**

| è¿æ¥ç±»å‹ | **åº”ç”¨åœºæ™¯** | **æŠ€æœ¯ç‰¹ç‚¹** | **éš¾ç‚¹** |
|---------|-------------|-------------|----------|
| å¤šå¯¹å¤šå…³è” | ç”¨æˆ·-è§’è‰²ï¼Œå•†å“-åˆ†ç±» | ä¸­é—´è¡¨å…³è” | æ•°æ®å»é‡ã€æ€§èƒ½ |
| é€’å½’å…³è” | ç»„ç»‡æ¶æ„ï¼Œè¯„è®ºå›å¤ | è‡ªè¿æ¥ã€å±‚çº§éå† | æ— é™å±‚çº§å¤„ç† |
| æ—¶é—´å…³è” | å†å²æ•°æ®ï¼Œç‰ˆæœ¬æ§åˆ¶ | æ—¶é—´èŒƒå›´åŒ¹é… | æ—¶é—´ç‚¹å‡†ç¡®æ€§ |
| èŒƒå›´å…³è” | åœ°ç†ä½ç½®ï¼Œæ•°å€¼åŒºé—´ | èŒƒå›´æ¡ä»¶åˆ¤æ–­ | è¾¹ç•Œå€¼å¤„ç† |
| æ¨¡ç³Šå…³è” | æœç´¢æ¨èï¼Œæ•°æ®æ¸…æ´— | ç›¸ä¼¼åº¦ç®—æ³• | åŒ¹é…ç²¾åº¦æ§åˆ¶ |

### 1.3 ç‰¹æ®Šè¿æ¥çš„ä¸šåŠ¡ä»·å€¼


**ğŸ’° è§£å†³çš„å®é™…é—®é¢˜**
```
ä¸šåŠ¡å¤æ‚æ€§å¤„ç†ï¼š
â€¢ å¤„ç†ç°å®ä¸­å¤æ‚çš„ä¸šåŠ¡å…³ç³»
â€¢ æ”¯æŒçµæ´»çš„æŸ¥è¯¢éœ€æ±‚
â€¢ æä¾›å‡†ç¡®çš„æ•°æ®åˆ†æç»“æœ

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ å‡å°‘å¤šæ¬¡æŸ¥è¯¢çš„å¼€é”€
â€¢ æé«˜å¤æ‚æŸ¥è¯¢çš„æ‰§è¡Œæ•ˆç‡
â€¢ ä¼˜åŒ–æ•°æ®è·å–ç­–ç•¥
```

---

## 2. ğŸ”„ å¤šå¯¹å¤šå…³è”å¤„ç†


### 2.1 å¤šå¯¹å¤šå…³ç³»çš„æœ¬è´¨


> **ğŸ¤” å¸¸è§ç–‘é—®**ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¸­é—´è¡¨ï¼Ÿ
> **ğŸ’¡ ç­”æ¡ˆ**ï¼šå°±åƒæœ‹å‹å…³ç³»ä¸€æ ·ï¼Œä¸€ä¸ªäººå¯ä»¥æœ‰å¤šä¸ªæœ‹å‹ï¼Œä¸€ä¸ªæœ‹å‹ä¹Ÿå¯ä»¥è¢«å¤šä¸ªäººè®¤è¯†ï¼Œéœ€è¦ä¸€ä¸ª"å…³ç³»è®°å½•æœ¬"æ¥è®°å½•æ‰€æœ‰çš„æœ‹å‹å…³ç³»ã€‚

**ğŸ”¸ å¤šå¯¹å¤šå…³ç³»ç»“æ„**
```
ç”¨æˆ·è¡¨ (users)          è§’è‰²è¡¨ (roles)
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ username â”‚      â”‚ id  â”‚ role_name  â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ å¼ ä¸‰     â”‚      â”‚ 1   â”‚ ç®¡ç†å‘˜     â”‚
â”‚ 2   â”‚ æå››     â”‚      â”‚ 2   â”‚ ç¼–è¾‘       â”‚
â”‚ 3   â”‚ ç‹äº”     â”‚      â”‚ 3   â”‚ å®¡æ ¸å‘˜     â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                       â†“
    ä¸­é—´è¡¨ (user_roles)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ user_id â”‚ role_id â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1       â”‚ 1       â”‚  -- å¼ ä¸‰æ˜¯ç®¡ç†å‘˜
    â”‚ 1       â”‚ 2       â”‚  -- å¼ ä¸‰ä¹Ÿæ˜¯ç¼–è¾‘
    â”‚ 2       â”‚ 2       â”‚  -- æå››æ˜¯ç¼–è¾‘
    â”‚ 3       â”‚ 3       â”‚  -- ç‹äº”æ˜¯å®¡æ ¸å‘˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å¤šå¯¹å¤šæŸ¥è¯¢çš„åŸºæœ¬æ–¹æ³•


**ğŸ“Š åŸºç¡€å¤šå¯¹å¤šæŸ¥è¯¢**

```sql
-- æŸ¥è¯¢æ¯ä¸ªç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
SELECT 
    u.username,
    GROUP_CONCAT(r.role_name) AS roles
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
GROUP BY u.id, u.username;

-- æŸ¥è¯¢æŒ‡å®šè§’è‰²çš„æ‰€æœ‰ç”¨æˆ·
SELECT 
    r.role_name,
    GROUP_CONCAT(u.username) AS users
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id
LEFT JOIN users u ON ur.user_id = u.id
WHERE r.role_name = 'ç®¡ç†å‘˜'
GROUP BY r.id, r.role_name;
```

### 2.3 å¤šå¯¹å¤šå…³è”çš„é«˜çº§æŸ¥è¯¢


**ğŸ”§ å¤æ‚å¤šå¯¹å¤šåœºæ™¯å¤„ç†**

```sql
-- æŸ¥è¯¢å…·æœ‰å¤šä¸ªè§’è‰²çš„ç”¨æˆ·
SELECT 
    u.username,
    COUNT(ur.role_id) AS role_count,
    GROUP_CONCAT(r.role_name) AS roles
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
GROUP BY u.id, u.username
HAVING COUNT(ur.role_id) > 1;

-- æŸ¥è¯¢åŒæ—¶å…·æœ‰æŒ‡å®šå¤šä¸ªè§’è‰²çš„ç”¨æˆ·
SELECT u.username
FROM users u
WHERE u.id IN (
    SELECT user_id
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE r.role_name IN ('ç®¡ç†å‘˜', 'ç¼–è¾‘')
    GROUP BY user_id
    HAVING COUNT(DISTINCT r.role_name) = 2
);

-- å•†å“åˆ†ç±»çš„å¤šå¯¹å¤šå…³è”ï¼ˆå•†å“å¯ä»¥å±äºå¤šä¸ªåˆ†ç±»ï¼‰
SELECT 
    p.product_name,
    GROUP_CONCAT(c.category_name ORDER BY c.category_name) AS categories,
    COUNT(pc.category_id) AS category_count
FROM products p
LEFT JOIN product_categories pc ON p.id = pc.product_id
LEFT JOIN categories c ON pc.category_id = c.id
GROUP BY p.id, p.product_name
ORDER BY category_count DESC;
```

---

## 3. ğŸŒ³ é€’å½’å…³è”æŸ¥è¯¢


### 3.1 é€’å½’å…³è”çš„æ¦‚å¿µ


> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šé€’å½’å…³è”å°±åƒå®¶è°±æˆ–å…¬å¸ç»„ç»‡æ¶æ„ï¼Œå­˜åœ¨çˆ¶å­å…³ç³»ï¼Œè€Œä¸”è¿™ç§å…³ç³»å¯ä»¥æœ‰å¾ˆå¤šå±‚çº§ã€‚

**ğŸ”¸ é€’å½’å…³è”ç»“æ„ç¤ºä¾‹**
```
ç»„ç»‡æ¶æ„è¡¨ (departments)
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id  â”‚ dept_name   â”‚ parent_id â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ æ€»ç»ç†åŠå…¬å®¤ â”‚ NULL      â”‚  -- æ ¹èŠ‚ç‚¹
â”‚ 2   â”‚ æŠ€æœ¯éƒ¨       â”‚ 1         â”‚  -- ä¸€çº§éƒ¨é—¨
â”‚ 3   â”‚ é”€å”®éƒ¨       â”‚ 1         â”‚  -- ä¸€çº§éƒ¨é—¨
â”‚ 4   â”‚ å¼€å‘ç»„       â”‚ 2         â”‚  -- äºŒçº§éƒ¨é—¨
â”‚ 5   â”‚ æµ‹è¯•ç»„       â”‚ 2         â”‚  -- äºŒçº§éƒ¨é—¨
â”‚ 6   â”‚ å‰ç«¯å°ç»„     â”‚ 4         â”‚  -- ä¸‰çº§éƒ¨é—¨
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å±‚çº§å…³ç³»ï¼š
æ€»ç»ç†åŠå…¬å®¤(1)
â”œâ”€â”€ æŠ€æœ¯éƒ¨(2)
â”‚   â”œâ”€â”€ å¼€å‘ç»„(4)
â”‚   â”‚   â””â”€â”€ å‰ç«¯å°ç»„(6)
â”‚   â””â”€â”€ æµ‹è¯•ç»„(5)
â””â”€â”€ é”€å”®éƒ¨(3)
```

### 3.2 ä½¿ç”¨WITH RECURSIVEè¿›è¡Œé€’å½’æŸ¥è¯¢


**ğŸ”„ MySQL 8.0é€’å½’æŸ¥è¯¢**

```sql
-- æŸ¥è¯¢æŸéƒ¨é—¨çš„æ‰€æœ‰å­éƒ¨é—¨ï¼ˆå‘ä¸‹é€’å½’ï¼‰
WITH RECURSIVE dept_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šé€‰æ‹©èµ·å§‹éƒ¨é—¨
    SELECT id, dept_name, parent_id, 1 AS level
    FROM departments
    WHERE id = 2  -- ä»æŠ€æœ¯éƒ¨å¼€å§‹
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šæŸ¥æ‰¾å­éƒ¨é—¨
    SELECT d.id, d.dept_name, d.parent_id, dt.level + 1
    FROM departments d
    JOIN dept_tree dt ON d.parent_id = dt.id
)
SELECT 
    id,
    CONCAT(REPEAT('  ', level-1), dept_name) AS dept_hierarchy,
    level
FROM dept_tree
ORDER BY level, id;

-- æŸ¥è¯¢æŸéƒ¨é—¨çš„æ‰€æœ‰ä¸Šçº§éƒ¨é—¨ï¼ˆå‘ä¸Šé€’å½’ï¼‰
WITH RECURSIVE parent_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼šé€‰æ‹©èµ·å§‹éƒ¨é—¨
    SELECT id, dept_name, parent_id, 1 AS level
    FROM departments
    WHERE id = 6  -- ä»å‰ç«¯å°ç»„å¼€å§‹
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šæŸ¥æ‰¾çˆ¶éƒ¨é—¨
    SELECT d.id, d.dept_name, d.parent_id, pt.level + 1
    FROM departments d
    JOIN parent_tree pt ON d.id = pt.parent_id
)
SELECT 
    id,
    dept_name,
    level
FROM parent_tree
ORDER BY level DESC;
```

### 3.3 éé€’å½’æ–¹æ³•å¤„ç†å±‚çº§æ•°æ®


**ğŸ”§ ä¼ ç»Ÿæ–¹æ³•å¤„ç†é€’å½’å…³è”**

```sql
-- ä½¿ç”¨è‡ªè¿æ¥æŸ¥è¯¢å¤šå±‚çº§å…³ç³»ï¼ˆé™åˆ¶å±‚æ•°ï¼‰
SELECT 
    d1.dept_name AS level1,
    d2.dept_name AS level2,
    d3.dept_name AS level3,
    d4.dept_name AS level4
FROM departments d1
LEFT JOIN departments d2 ON d1.id = d2.parent_id
LEFT JOIN departments d3 ON d2.id = d3.parent_id
LEFT JOIN departments d4 ON d3.id = d4.parent_id
WHERE d1.parent_id IS NULL  -- ä»æ ¹èŠ‚ç‚¹å¼€å§‹
ORDER BY d1.id, d2.id, d3.id, d4.id;

-- å‘˜å·¥ä¸å…¶ç›´å±é¢†å¯¼å…³ç³»
SELECT 
    e1.name AS employee,
    e2.name AS direct_manager,
    e3.name AS senior_manager
FROM employees e1
LEFT JOIN employees e2 ON e1.manager_id = e2.id
LEFT JOIN employees e3 ON e2.manager_id = e3.id
ORDER BY e1.name;
```

---

## 4. â° æ—¶é—´å…³è”æŸ¥è¯¢


### 4.1 æ—¶é—´å…³è”çš„åº”ç”¨åœºæ™¯


**ğŸ“… æ—¶é—´å…³è”çš„å…¸å‹åœºæ™¯**
```
å¸¸è§æ—¶é—´å…³è”éœ€æ±‚ï¼š
â€¢ å†å²ä»·æ ¼æŸ¥è¯¢ï¼šæŸ¥è¯¢æŸä¸ªæ—¶é—´ç‚¹çš„å•†å“ä»·æ ¼
â€¢ å‘˜å·¥èŒä½å†å²ï¼šæŸ¥è¯¢å‘˜å·¥åœ¨æŸä¸ªæ—¶æœŸçš„èŒä½
â€¢ åº“å­˜å˜åŒ–è®°å½•ï¼šæŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µçš„åº“å­˜å˜åŒ–
â€¢ ç‰ˆæœ¬æ§åˆ¶ï¼šæŸ¥è¯¢æ–‡æ¡£åœ¨æŸä¸ªæ—¶é—´çš„ç‰ˆæœ¬
```

### 4.2 æ—¶é—´ç‚¹å…³è”æŸ¥è¯¢


**â° åŸºäºæ—¶é—´ç‚¹çš„å…³è”**

```sql
-- å•†å“å†å²ä»·æ ¼è¡¨
CREATE TABLE price_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    product_id INT,
    price DECIMAL(10,2),
    effective_date DATE,
    INDEX(product_id, effective_date)
);

-- æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„å•†å“ä»·æ ¼
SELECT 
    p.product_name,
    ph.price,
    ph.effective_date
FROM products p
LEFT JOIN price_history ph ON p.id = ph.product_id
    AND ph.effective_date = (
        SELECT MAX(effective_date)
        FROM price_history ph2
        WHERE ph2.product_id = p.id
          AND ph2.effective_date <= '2024-06-15'  -- æŒ‡å®šæŸ¥è¯¢æ—¥æœŸ
    )
ORDER BY p.product_name;

-- å‘˜å·¥èŒä½å†å²æŸ¥è¯¢
SELECT 
    e.employee_name,
    jh.position_name,
    jh.start_date,
    jh.end_date
FROM employees e
LEFT JOIN job_history jh ON e.id = jh.employee_id
    AND '2024-01-01' BETWEEN jh.start_date AND IFNULL(jh.end_date, '9999-12-31')
ORDER BY e.employee_name;
```

### 4.3 æ—¶é—´æ®µå…³è”æŸ¥è¯¢


**ğŸ“Š æ—¶é—´æ®µé‡å æŸ¥è¯¢**

```sql
-- æŸ¥è¯¢é¡¹ç›®æ—¶é—´é‡å çš„å‘˜å·¥
SELECT 
    p1.project_name AS project1,
    p2.project_name AS project2,
    e.employee_name,
    GREATEST(p1.start_date, p2.start_date) AS overlap_start,
    LEAST(p1.end_date, p2.end_date) AS overlap_end
FROM project_assignments pa1
JOIN projects p1 ON pa1.project_id = p1.id
JOIN project_assignments pa2 ON pa1.employee_id = pa2.employee_id AND pa1.project_id < pa2.project_id
JOIN projects p2 ON pa2.project_id = p2.id
JOIN employees e ON pa1.employee_id = e.id
WHERE p1.start_date <= p2.end_date 
  AND p2.start_date <= p1.end_date  -- æ—¶é—´é‡å æ¡ä»¶
ORDER BY e.employee_name, overlap_start;

-- æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…æ´»è·ƒçš„è®¢å•
SELECT 
    o.order_id,
    o.order_date,
    o.status,
    DATEDIFF(o.completed_date, o.order_date) AS processing_days
FROM orders o
WHERE o.order_date <= '2024-06-30'
  AND (o.completed_date >= '2024-06-01' OR o.completed_date IS NULL)
ORDER BY o.order_date;
```

---

## 5. ğŸ“ èŒƒå›´å…³è”æŸ¥è¯¢


### 5.1 æ•°å€¼èŒƒå›´å…³è”


**ğŸ”¢ åŸºäºæ•°å€¼èŒƒå›´çš„å…³è”æŸ¥è¯¢**

```sql
-- ä»·æ ¼åŒºé—´æŸ¥è¯¢
SELECT 
    p.product_name,
    p.price,
    pr.range_name,
    pr.min_price,
    pr.max_price
FROM products p
JOIN price_ranges pr ON p.price BETWEEN pr.min_price AND pr.max_price
ORDER BY p.price;

-- å¹´é¾„æ®µç»Ÿè®¡
SELECT 
    ag.age_group_name,
    COUNT(u.id) AS user_count,
    AVG(u.age) AS avg_age
FROM users u
JOIN age_groups ag ON u.age BETWEEN ag.min_age AND ag.max_age
GROUP BY ag.id, ag.age_group_name
ORDER BY ag.min_age;

-- è¯„åˆ†ç­‰çº§æŸ¥è¯¢
SELECT 
    s.student_name,
    s.score,
    g.grade_name,
    g.description
FROM students s
LEFT JOIN grade_levels g ON s.score >= g.min_score 
    AND (s.score <= g.max_score OR g.max_score IS NULL)
ORDER BY s.score DESC;
```

### 5.2 åœ°ç†èŒƒå›´å…³è”


**ğŸ—ºï¸ åœ°ç†ä½ç½®èŒƒå›´æŸ¥è¯¢**

```sql
-- ç®€åŒ–çš„åœ°ç†ä½ç½®èŒƒå›´æŸ¥è¯¢
SELECT 
    s.store_name,
    s.latitude,
    s.longitude,
    c.customer_name,
    c.latitude AS customer_lat,
    c.longitude AS customer_lng,
    -- ç®€åŒ–è·ç¦»è®¡ç®—ï¼ˆå®é™…åº”ç”¨ä¸­ä½¿ç”¨æ›´ç²¾ç¡®çš„åœ°ç†å‡½æ•°ï¼‰
    SQRT(
        POW(s.latitude - c.latitude, 2) + 
        POW(s.longitude - c.longitude, 2)
    ) * 111 AS approximate_distance_km
FROM stores s
CROSS JOIN customers c
WHERE SQRT(
    POW(s.latitude - c.latitude, 2) + 
    POW(s.longitude - c.longitude, 2)
) * 111 <= 5  -- 5å…¬é‡ŒèŒƒå›´å†…
ORDER BY s.store_name, approximate_distance_km;

-- IPåœ°å€èŒƒå›´æŸ¥è¯¢
SELECT 
    v.visitor_ip,
    ir.country,
    ir.region,
    ir.start_ip,
    ir.end_ip
FROM visitors v
JOIN ip_ranges ir ON INET_ATON(v.visitor_ip) BETWEEN INET_ATON(ir.start_ip) AND INET_ATON(ir.end_ip)
WHERE v.visit_date >= '2024-06-01'
ORDER BY v.visit_date;
```

---

## 6. ğŸ” æ¨¡ç³Šå…³è”å¤„ç†


### 6.1 å­—ç¬¦ä¸²ç›¸ä¼¼åº¦å…³è”


**ğŸ“ åŸºäºå­—ç¬¦ä¸²ç›¸ä¼¼åº¦çš„å…³è”**

```sql
-- å…¬å¸åç§°æ¨¡ç³ŠåŒ¹é…ï¼ˆç”¨äºæ•°æ®æ¸…æ´—ï¼‰
SELECT 
    c1.company_name AS name1,
    c2.company_name AS name2,
    CASE 
        WHEN SOUNDEX(c1.company_name) = SOUNDEX(c2.company_name) THEN 'è¯­éŸ³ç›¸ä¼¼'
        WHEN c1.company_name LIKE CONCAT('%', SUBSTRING(c2.company_name, 1, 5), '%') THEN 'åŒ…å«åŒ¹é…'
        WHEN LEVENSHTEIN(c1.company_name, c2.company_name) <= 3 THEN 'ç¼–è¾‘è·ç¦»ç›¸è¿‘'
        ELSE 'å¯èƒ½é‡å¤'
    END AS match_type
FROM companies c1
JOIN companies c2 ON c1.id < c2.id
WHERE (
    SOUNDEX(c1.company_name) = SOUNDEX(c2.company_name)
    OR c1.company_name LIKE CONCAT('%', SUBSTRING(c2.company_name, 1, 5), '%')
    OR c2.company_name LIKE CONCAT('%', SUBSTRING(c1.company_name, 1, 5), '%')
)
ORDER BY c1.company_name;

-- äº§å“æ¨èåŸºäºå…³é”®è¯åŒ¹é…
SELECT 
    p1.product_name AS viewed_product,
    p2.product_name AS recommended_product,
    MATCH(p2.description) AGAINST(p1.keywords IN NATURAL LANGUAGE MODE) AS relevance_score
FROM products p1
JOIN products p2 ON p1.id != p2.id
WHERE MATCH(p2.description) AGAINST(p1.keywords IN NATURAL LANGUAGE MODE) > 0
ORDER BY p1.product_name, relevance_score DESC;
```

### 6.2 æ¨¡ç³Šæ—¶é—´åŒ¹é…


**â° å®¹é”™çš„æ—¶é—´å…³è”**

```sql
-- æ—¥å¿—å…³è”åˆ†æï¼ˆå…è®¸æ—¶é—´è¯¯å·®ï¼‰
SELECT 
    ul.user_id,
    ul.login_time,
    ua.action_type,
    ua.action_time,
    TIMESTAMPDIFF(SECOND, ul.login_time, ua.action_time) AS time_diff_seconds
FROM user_logins ul
JOIN user_actions ua ON ul.user_id = ua.user_id
    AND ua.action_time BETWEEN 
        ul.login_time AND 
        DATE_ADD(ul.login_time, INTERVAL 30 MINUTE)  -- 30åˆ†é’Ÿå®¹é”™èŒƒå›´
WHERE ul.login_time >= '2024-06-01'
ORDER BY ul.user_id, ul.login_time, ua.action_time;

-- è®¢å•ä¸æ”¯ä»˜åŒ¹é…ï¼ˆå¤„ç†æ—¶é—´å»¶è¿Ÿï¼‰
SELECT 
    o.order_id,
    o.order_time,
    o.total_amount,
    p.payment_time,
    p.amount AS payment_amount,
    TIMESTAMPDIFF(MINUTE, o.order_time, p.payment_time) AS payment_delay_minutes
FROM orders o
LEFT JOIN payments p ON o.order_id = p.order_id
    AND p.payment_time BETWEEN 
        o.order_time AND 
        DATE_ADD(o.order_time, INTERVAL 2 HOUR)  -- 2å°æ—¶æ”¯ä»˜çª—å£
    AND ABS(o.total_amount - p.amount) <= 0.01  -- é‡‘é¢å…è®¸å°è¯¯å·®
WHERE o.order_time >= '2024-06-01'
ORDER BY o.order_time;
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 7.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


**ğŸ”§ ç‰¹æ®Šè¿æ¥çš„ç´¢å¼•è®¾è®¡**

```sql
-- å¤šå¯¹å¤šå…³è”çš„ç´¢å¼•ä¼˜åŒ–
-- ä¸­é—´è¡¨çš„å¤åˆç´¢å¼•
CREATE INDEX idx_user_roles_user ON user_roles(user_id, role_id);
CREATE INDEX idx_user_roles_role ON user_roles(role_id, user_id);

-- æ—¶é—´å…³è”æŸ¥è¯¢çš„ç´¢å¼•
CREATE INDEX idx_price_history_product_date ON price_history(product_id, effective_date DESC);

-- èŒƒå›´æŸ¥è¯¢çš„ç´¢å¼•
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_users_age ON users(age);

-- åœ°ç†ä½ç½®æŸ¥è¯¢çš„ç©ºé—´ç´¢å¼•
-- ALTER TABLE stores ADD SPATIAL INDEX(location_point);
```

### 7.2 æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§


**ğŸ“Š æå‡æŸ¥è¯¢æ€§èƒ½çš„æ–¹æ³•**

```sql
-- ä½¿ç”¨EXISTSæ›¿ä»£INï¼ˆå¤§æ•°æ®é‡æ—¶æ›´é«˜æ•ˆï¼‰
-- ä½æ•ˆå†™æ³•
SELECT u.username
FROM users u
WHERE u.id IN (
    SELECT ur.user_id
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE r.role_name = 'ç®¡ç†å‘˜'
);

-- ä¼˜åŒ–å†™æ³•
SELECT u.username
FROM users u
WHERE EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = u.id AND r.role_name = 'ç®¡ç†å‘˜'
);

-- é€’å½’æŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–
-- é™åˆ¶é€’å½’æ·±åº¦ï¼Œé¿å…æ— é™é€’å½’
WITH RECURSIVE dept_tree AS (
    SELECT id, dept_name, parent_id, 1 AS level
    FROM departments
    WHERE id = 1
    
    UNION ALL
    
    SELECT d.id, d.dept_name, d.parent_id, dt.level + 1
    FROM departments d
    JOIN dept_tree dt ON d.parent_id = dt.id
    WHERE dt.level < 10  -- é™åˆ¶æœ€å¤§å±‚çº§
)
SELECT * FROM dept_tree;
```

---

## 8. ğŸ’¼ å®é™…åº”ç”¨æ¡ˆä¾‹


### 8.1 ç”µå•†ç³»ç»Ÿå¤åˆæŸ¥è¯¢æ¡ˆä¾‹


**ğŸ›’ å•†å“æ¨èç³»ç»Ÿ**

```sql
-- åŸºäºç”¨æˆ·è´­ä¹°å†å²çš„å•†å“æ¨è
SELECT 
    p.product_name,
    p.category_id,
    COUNT(DISTINCT o.user_id) AS bought_by_users,
    AVG(p.price) AS avg_price,
    GROUP_CONCAT(DISTINCT c.category_name) AS categories
FROM products p
JOIN order_items oi ON p.id = oi.product_id
JOIN orders o ON oi.order_id = o.id
LEFT JOIN product_categories pc ON p.id = pc.product_id
LEFT JOIN categories c ON pc.category_id = c.id
WHERE o.user_id IN (
    -- æŸ¥æ‰¾ä¸ç›®æ ‡ç”¨æˆ·è´­ä¹°è¡Œä¸ºç›¸ä¼¼çš„ç”¨æˆ·
    SELECT DISTINCT o2.user_id
    FROM orders o2
    JOIN order_items oi2 ON o2.id = oi2.order_id
    WHERE oi2.product_id IN (
        SELECT oi3.product_id
        FROM orders o3
        JOIN order_items oi3 ON o3.id = oi3.order_id
        WHERE o3.user_id = 123  -- ç›®æ ‡ç”¨æˆ·ID
    )
    AND o2.user_id != 123
)
AND p.id NOT IN (
    -- æ’é™¤ç”¨æˆ·å·²è´­ä¹°çš„å•†å“
    SELECT oi4.product_id
    FROM orders o4
    JOIN order_items oi4 ON o4.id = oi4.order_id
    WHERE o4.user_id = 123
)
GROUP BY p.id, p.product_name, p.category_id
HAVING bought_by_users >= 2
ORDER BY bought_by_users DESC, avg_price ASC
LIMIT 10;
```

### 8.2 ç»„ç»‡æ¶æ„åˆ†ææ¡ˆä¾‹


**ğŸ¢ ä¼ä¸šç»„ç»‡ç»“æ„åˆ†æ**

```sql
-- åˆ†æç»„ç»‡æ¶æ„çš„å®Œæ•´ä¿¡æ¯
WITH RECURSIVE org_hierarchy AS (
    -- è·å–æ‰€æœ‰æ ¹éƒ¨é—¨
    SELECT 
        id, 
        dept_name, 
        parent_id, 
        1 AS level,
        CAST(dept_name AS CHAR(500)) AS path
    FROM departments
    WHERE parent_id IS NULL
    
    UNION ALL
    
    -- é€’å½’è·å–å­éƒ¨é—¨
    SELECT 
        d.id, 
        d.dept_name, 
        d.parent_id, 
        oh.level + 1,
        CONCAT(oh.path, ' > ', d.dept_name)
    FROM departments d
    JOIN org_hierarchy oh ON d.parent_id = oh.id
    WHERE oh.level < 5  -- é˜²æ­¢è¿‡æ·±é€’å½’
)
SELECT 
    oh.path AS department_hierarchy,
    oh.level,
    COUNT(e.id) AS employee_count,
    AVG(e.salary) AS avg_salary,
    SUM(e.salary) AS total_salary_cost
FROM org_hierarchy oh
LEFT JOIN employees e ON oh.id = e.department_id
GROUP BY oh.id, oh.path, oh.level
ORDER BY oh.level, oh.path;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šå¯¹å¤šå…³è”ï¼šé€šè¿‡ä¸­é—´è¡¨å¤„ç†å¤æ‚çš„å¤šå¯¹å¤šå…³ç³»
ğŸ”¸ é€’å½’æŸ¥è¯¢ï¼šä½¿ç”¨WITH RECURSIVEå¤„ç†å±‚çº§æ•°æ®
ğŸ”¸ æ—¶é—´å…³è”ï¼šåŸºäºæ—¶é—´ç‚¹æˆ–æ—¶é—´æ®µçš„åŠ¨æ€å…³è”
ğŸ”¸ èŒƒå›´å…³è”ï¼šåŸºäºæ•°å€¼ã€åœ°ç†ã€æ¡ä»¶èŒƒå›´çš„å…³è”
ğŸ”¸ æ¨¡ç³Šå…³è”ï¼šåŸºäºç›¸ä¼¼åº¦å’Œå®¹é”™çš„çµæ´»å…³è”
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç‰¹æ®Šè¿æ¥çš„åº”ç”¨ä»·å€¼**
```
ä¸šåŠ¡çµæ´»æ€§ï¼š
â€¢ å¤„ç†å¤æ‚çš„ç°å®ä¸šåŠ¡å…³ç³»
â€¢ æ”¯æŒåŠ¨æ€çš„æŸ¥è¯¢éœ€æ±‚
â€¢ æä¾›ç²¾ç¡®çš„æ•°æ®åˆ†æ

æŠ€æœ¯æŒ‘æˆ˜ï¼š
â€¢ æ€§èƒ½ä¼˜åŒ–éœ€è¦ç‰¹æ®Šè€ƒè™‘
â€¢ ç´¢å¼•è®¾è®¡æ›´åŠ å¤æ‚
â€¢ éœ€è¦é˜²èŒƒæŸ¥è¯¢é™·é˜±
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹**
```
ç´¢å¼•ç­–ç•¥ï¼š
â€¢ å¤åˆç´¢å¼•è®¾è®¡è¦è€ƒè™‘æŸ¥è¯¢æ¨¡å¼
â€¢ æ—¶é—´å’ŒèŒƒå›´æŸ¥è¯¢éœ€è¦ç‰¹æ®Šç´¢å¼•
â€¢ æ¨¡ç³ŠæŸ¥è¯¢è€ƒè™‘å…¨æ–‡ç´¢å¼•

æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ é€‚å½“é™åˆ¶é€’å½’æ·±åº¦
â€¢ ä½¿ç”¨EXISTSæ›¿ä»£å¤§æ•°æ®é‡çš„IN
â€¢ åˆç†ä½¿ç”¨å­æŸ¥è¯¢å’Œä¸´æ—¶è¡¨
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“‹ åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—**
- **å¤šå¯¹å¤šå…³è”**ï¼šç”¨æˆ·æƒé™ã€å•†å“åˆ†ç±»ã€æ ‡ç­¾ç³»ç»Ÿ
- **é€’å½’æŸ¥è¯¢**ï¼šç»„ç»‡æ¶æ„ã€è¯„è®ºç³»ç»Ÿã€åˆ†ç±»æ ‘
- **æ—¶é—´å…³è”**ï¼šå†å²æ•°æ®ã€ç‰ˆæœ¬æ§åˆ¶ã€æ—¶é—´åºåˆ—åˆ†æ  
- **èŒƒå›´å…³è”**ï¼šä»·æ ¼ç­›é€‰ã€åœ°ç†æŸ¥è¯¢ã€åˆ†æ®µç»Ÿè®¡
- **æ¨¡ç³Šå…³è”**ï¼šæœç´¢æ¨èã€æ•°æ®æ¸…æ´—ã€ç›¸ä¼¼åº¦åŒ¹é…

**âš–ï¸ æŠ€æœ¯é€‰æ‹©å»ºè®®**
```
ç®€å•åœºæ™¯ï¼š
â†’ ä½¿ç”¨æ ‡å‡†çš„JOINè¯­æ³•
â†’ åˆç†è®¾è®¡ç´¢å¼•å³å¯

å¤æ‚åœºæ™¯ï¼š
â†’ è€ƒè™‘ä½¿ç”¨WITH RECURSIVE
â†’ å¿…è¦æ—¶è¿›è¡Œåˆ†æ­¥æŸ¥è¯¢

å¤§æ•°æ®é‡ï¼š
â†’ ä¼˜å…ˆè€ƒè™‘æ€§èƒ½ä¼˜åŒ–
â†’ å¯èƒ½éœ€è¦å†—ä½™è®¾è®¡
```

> **ğŸ’¡ ä¸€å¥è¯æ€»ç»“**ï¼šç‰¹æ®Šè¿æ¥åœºæ™¯å¤„ç†çš„æ ¸å¿ƒæ˜¯ç†è§£ä¸šåŠ¡å…³ç³»çš„å¤æ‚æ€§ï¼Œé€‰æ‹©åˆé€‚çš„SQLæŠ€æœ¯ï¼Œå¹¶åšå¥½æ€§èƒ½ä¼˜åŒ–ã€‚

### 9.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ å¼€å‘å»ºè®®**
```
è®¾è®¡é˜¶æ®µï¼š
â€¢ å……åˆ†åˆ†æä¸šåŠ¡å…³ç³»çš„å¤æ‚åº¦
â€¢ æå‰è®¾è®¡å¥½ç´¢å¼•ç­–ç•¥
â€¢ è€ƒè™‘æ•°æ®é‡å¢é•¿çš„å½±å“

å®ç°é˜¶æ®µï¼š
â€¢ å…ˆå†™å‡ºæ­£ç¡®çš„æŸ¥è¯¢é€»è¾‘
â€¢ å†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
â€¢ åšå¥½è¾¹ç•Œæ¡ä»¶å¤„ç†

è¿ç»´é˜¶æ®µï¼š
â€¢ ç›‘æ§å¤æ‚æŸ¥è¯¢çš„æ€§èƒ½
â€¢ å®šæœŸåˆ†ææ‰§è¡Œè®¡åˆ’
â€¢ åŠæ—¶è°ƒæ•´ç´¢å¼•ç­–ç•¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
â”Œâ”€ ç‰¹æ®Šè¿æ¥è¦è¯€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤šå¯¹å¤šç”¨ä¸­é—´è¡¨ï¼Œé€’å½’æŸ¥è¯¢åŠ é™åˆ¶ â”‚
â”‚ æ—¶é—´å…³è”çœ‹èŒƒå›´ï¼Œåœ°ç†ç©ºé—´å»ºç´¢å¼• â”‚
â”‚ æ¨¡ç³ŠåŒ¹é…å®¹è¯¯å·®ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯å…³é”® â”‚
â”‚ å¤æ‚å…³ç³»ç»†åˆ†æï¼Œåˆé€‚æ–¹æ³•è§£éš¾é¢˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```