---
title: 14ã€WHEREæŸ¥è¯¢è¿‡æ»¤ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [WHEREæ¡ä»¶ä¼˜åŒ–æ¦‚è¿°](#1-WHEREæ¡ä»¶ä¼˜åŒ–æ¦‚è¿°)
2. [æ¡ä»¶è¿‡æ»¤é¡ºåºä¼˜åŒ–](#2-æ¡ä»¶è¿‡æ»¤é¡ºåºä¼˜åŒ–)
3. [é€‰æ‹©æ€§é«˜æ¡ä»¶ä¼˜å…ˆç­–ç•¥](#3-é€‰æ‹©æ€§é«˜æ¡ä»¶ä¼˜å…ˆç­–ç•¥)
4. [å‡½æ•°è°ƒç”¨é¿å…æŠ€æœ¯](#4-å‡½æ•°è°ƒç”¨é¿å…æŠ€æœ¯)
5. [ç±»å‹è½¬æ¢æ¶ˆé™¤æ–¹æ³•](#5-ç±»å‹è½¬æ¢æ¶ˆé™¤æ–¹æ³•)
6. [èŒƒå›´æ¡ä»¶åˆå¹¶ä¼˜åŒ–](#6-èŒƒå›´æ¡ä»¶åˆå¹¶ä¼˜åŒ–)
7. [æ¡ä»¶é‡æ„æŠ€æœ¯](#7-æ¡ä»¶é‡æ„æŠ€æœ¯)
8. [æˆæœ¬æ¨¡å‹æ¡ä»¶è¯„ä¼°](#8-æˆæœ¬æ¨¡å‹æ¡ä»¶è¯„ä¼°)
9. [åŠ¨æ€æ¡ä»¶ä¼˜åŒ–](#9-åŠ¨æ€æ¡ä»¶ä¼˜åŒ–)
10. [å¤æ‚æ¡ä»¶æŸ¥è¯¢æ¡ˆä¾‹åˆ†æ](#10-å¤æ‚æ¡ä»¶æŸ¥è¯¢æ¡ˆä¾‹åˆ†æ)
11. [æ€§èƒ½é—®é¢˜è¯Šæ–­å®ä¾‹](#11-æ€§èƒ½é—®é¢˜è¯Šæ–­å®ä¾‹)
12. [ä¼˜åŒ–å‰åå¯¹æ¯”åˆ†æ](#12-ä¼˜åŒ–å‰åå¯¹æ¯”åˆ†æ)
13. [WHEREæ¡ä»¶ä¼˜åŒ–æ ¸å¿ƒæ–¹æ³•](#13-WHEREæ¡ä»¶ä¼˜åŒ–æ ¸å¿ƒæ–¹æ³•)
14. [æ¡ä»¶æŸ¥è¯¢æ€§èƒ½ç›‘æ§](#14-æ¡ä»¶æŸ¥è¯¢æ€§èƒ½ç›‘æ§)
15. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#15-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ WHEREæ¡ä»¶ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯WHEREæ¡ä»¶ä¼˜åŒ–


> ğŸ’¡ **ä¸€å¥è¯ç†è§£**ï¼šWHEREæ¡ä»¶ä¼˜åŒ–å°±åƒåœ¨å›¾ä¹¦é¦†æ‰¾ä¹¦æ—¶ï¼Œé€‰æ‹©æœ€é«˜æ•ˆçš„æŸ¥æ‰¾è·¯å¾„ï¼Œè®©è®¡ç®—æœºèƒ½å¤Ÿæœ€å¿«åœ°æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚

**ğŸ”¸ WHEREä¼˜åŒ–çš„æœ¬è´¨**
```
æ¡ä»¶ä¼˜åŒ–ä¸‰ä¸ªå±‚é¢ï¼š
ğŸ“Š ç‰©ç†å±‚é¢ï¼šåˆ©ç”¨ç´¢å¼•ï¼Œå‡å°‘ç£ç›˜IO
ğŸ§  é€»è¾‘å±‚é¢ï¼šä¼˜åŒ–æ¡ä»¶é¡ºåºï¼Œå‡å°‘è®¡ç®—é‡
âš¡ æ‰§è¡Œå±‚é¢ï¼šé¿å…ä¸å¿…è¦çš„æ•°æ®æ‰«æ
```

**ğŸ¤” ä¸ºä»€ä¹ˆWHEREæ¡ä»¶è¿™ä¹ˆé‡è¦ï¼Ÿ**
```
æ•°æ®åº“æŸ¥è¯¢çš„æ€§èƒ½ç“¶é¢ˆï¼š
â”Œâ”€ æ•°æ®è¯»å–ç“¶é¢ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  å…¨è¡¨æ‰«æ â†’ ç´¢å¼•æŸ¥æ‰¾ â†’ å†…å­˜è¿‡æ»¤    â”‚
â”‚    (æ…¢)      (å¿«)      (æœ€å¿«)     â”‚
â”‚                                    â”‚
â”‚  WHEREæ¡ä»¶å†³å®šäº†ä½¿ç”¨å“ªç§æ–¹å¼ï¼     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…å½±å“ï¼š
â€¢ ä¸€ä¸ªå¥½çš„WHEREæ¡ä»¶ï¼š1ç§’å†…è¿”å›ç»“æœ
â€¢ ä¸€ä¸ªå·®çš„WHEREæ¡ä»¶ï¼šå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿç”šè‡³è¶…æ—¶
```

### 1.2 å¸¸è§çš„WHEREæ€§èƒ½é—®é¢˜


**ğŸš¨ å…¸å‹æ€§èƒ½æ€æ‰‹**

| é—®é¢˜ç±»å‹ | **æ€§èƒ½å½±å“** | **å…¸å‹è¡¨ç°** | **å½±å“ç¨‹åº¦** |
|---------|-------------|-------------|-------------|
| ğŸ”´ **å…¨è¡¨æ‰«æ** | `æå·®` | æ²¡æœ‰åˆé€‚ç´¢å¼• | æ€§èƒ½é™ä½100-1000å€ |
| ğŸŸ  **å‡½æ•°è°ƒç”¨** | `å¾ˆå·®` | WHERE YEAR(date)=2023 | æ€§èƒ½é™ä½10-50å€ |
| ğŸŸ¡ **ç±»å‹è½¬æ¢** | `è¾ƒå·®` | WHERE id='123' | æ€§èƒ½é™ä½2-10å€ |
| ğŸŸ¢ **æ¡ä»¶é¡ºåº** | `ä¸€èˆ¬` | ä½é€‰æ‹©æ€§æ¡ä»¶åœ¨å‰ | æ€§èƒ½é™ä½1.5-3å€ |

**ğŸ’» é—®é¢˜ç¤ºä¾‹å¯¹æ¯”**
```sql
-- âŒ æ€§èƒ½æå·®çš„å†™æ³•
SELECT * FROM orders 
WHERE YEAR(order_date) = 2023          -- å‡½æ•°è°ƒç”¨ï¼Œæ— æ³•ç”¨ç´¢å¼•
  AND customer_id = 12345              -- é«˜é€‰æ‹©æ€§æ¡ä»¶æ”¾åœ¨åé¢
  AND status IN ('pending','shipped'); -- ç±»å‹å¯èƒ½ä¸åŒ¹é…

-- âœ… ä¼˜åŒ–åçš„å†™æ³•  
SELECT * FROM orders 
WHERE customer_id = 12345                              -- é«˜é€‰æ‹©æ€§æ¡ä»¶ä¼˜å…ˆ
  AND order_date >= '2023-01-01'                      -- é¿å…å‡½æ•°è°ƒç”¨
  AND order_date < '2024-01-01'                       -- èŒƒå›´æ¡ä»¶
  AND status IN ('pending','shipped');                -- ç¡®ä¿ç±»å‹åŒ¹é…
```

### 1.3 WHEREä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™


**ğŸ¯ æ ¸å¿ƒä¼˜åŒ–åŸåˆ™**
```
åŸåˆ™1ï¼šé€‰æ‹©æ€§ä¼˜å…ˆåŸåˆ™
â€¢ é€‰æ‹©æ€§é«˜çš„æ¡ä»¶ä¼˜å…ˆè¯„ä¼°
â€¢ èƒ½è¿‡æ»¤æ‰æ›´å¤šæ•°æ®çš„æ¡ä»¶å…ˆæ‰§è¡Œ

åŸåˆ™2ï¼šç´¢å¼•å‹å¥½åŸåˆ™  
â€¢ å°½é‡ä½¿ç”¨ç´¢å¼•è¦†ç›–çš„æ¡ä»¶
â€¢ é¿å…ç ´åç´¢å¼•ä½¿ç”¨çš„å†™æ³•

åŸåˆ™3ï¼šè®¡ç®—æœ€å°åŒ–åŸåˆ™
â€¢ é¿å…åœ¨WHEREä¸­è¿›è¡Œå¤æ‚è®¡ç®—
â€¢ é¢„å…ˆè®¡ç®—å¯ä»¥é¢„è®¡ç®—çš„å€¼

åŸåˆ™4ï¼šç±»å‹åŒ¹é…åŸåˆ™
â€¢ ç¡®ä¿æ¡ä»¶å’Œå­—æ®µç±»å‹å®Œå…¨åŒ¹é…
â€¢ é¿å…éšå¼ç±»å‹è½¬æ¢
```

---

## 2. âš¡ æ¡ä»¶è¿‡æ»¤é¡ºåºä¼˜åŒ–


### 2.1 è¿‡æ»¤é¡ºåºçš„é‡è¦æ€§


> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒç­›æ²™å­ï¼Œå…ˆç”¨å¤§å­”çš„ç­›å­è¿‡æ»¤å¤§çŸ³å¤´ï¼Œå†ç”¨å°å­”çš„ç­›å­è¿‡æ»¤å°çŸ³å­ï¼Œæœ€åå¾—åˆ°ç»†æ²™ã€‚æ•°æ®åº“ä¹Ÿæ˜¯å…ˆç”¨"ç²—ç­›"è¿‡æ»¤å¤§é‡æ•°æ®ï¼Œå†ç”¨"ç»†ç­›"ç²¾ç¡®ç­›é€‰ã€‚

**ğŸ”¸ è¿‡æ»¤é¡ºåºå¯¹æ€§èƒ½çš„å½±å“**
```
å‡è®¾æœ‰100ä¸‡æ¡è®¢å•æ•°æ®ï¼š

é”™è¯¯çš„è¿‡æ»¤é¡ºåºï¼š
ç¬¬1æ­¥ï¼šstatus = 'active' (è¿‡æ»¤æ‰10%ï¼Œå‰©ä½™90ä¸‡)
ç¬¬2æ­¥ï¼šcategory = 'electronics' (è¿‡æ»¤æ‰80%ï¼Œå‰©ä½™18ä¸‡)  
ç¬¬3æ­¥ï¼šcustomer_id = 12345 (è¿‡æ»¤æ‰99.99%ï¼Œå‰©ä½™1æ¡)
æ€»è®¡ç®—é‡ï¼š100ä¸‡ + 90ä¸‡ + 18ä¸‡ = 208ä¸‡æ¬¡æ¯”è¾ƒ

æ­£ç¡®çš„è¿‡æ»¤é¡ºåºï¼š
ç¬¬1æ­¥ï¼šcustomer_id = 12345 (è¿‡æ»¤æ‰99.99%ï¼Œå‰©ä½™10æ¡)
ç¬¬2æ­¥ï¼šcategory = 'electronics' (è¿‡æ»¤æ‰80%ï¼Œå‰©ä½™2æ¡)
ç¬¬3æ­¥ï¼šstatus = 'active' (è¿‡æ»¤æ‰10%ï¼Œå‰©ä½™1-2æ¡)
æ€»è®¡ç®—é‡ï¼š100ä¸‡ + 10 + 2 = 100ä¸‡é›¶12æ¬¡æ¯”è¾ƒ

æ€§èƒ½æå‡ï¼š208ä¸‡ â†’ 100ä¸‡ï¼Œæ•ˆç‡æå‡çº¦2å€ï¼
```

### 2.2 æ¡ä»¶é€‰æ‹©æ€§è®¡ç®—


**ğŸ“Š é€‰æ‹©æ€§è®¡ç®—å…¬å¼**
```sql
-- è®¡ç®—æ¡ä»¶é€‰æ‹©æ€§çš„SQL
SELECT 
    COUNT(DISTINCT customer_id) / COUNT(*) AS customer_selectivity,
    COUNT(DISTINCT status) / COUNT(*) AS status_selectivity,
    COUNT(DISTINCT category) / COUNT(*) AS category_selectivity
FROM orders;

-- ç»“æœç¤ºä¾‹ï¼š
-- customer_selectivity: 0.8 (é€‰æ‹©æ€§é«˜ï¼Œä¼˜å…ˆä½¿ç”¨)
-- status_selectivity: 0.003 (é€‰æ‹©æ€§ä½ï¼Œåä½¿ç”¨)  
-- category_selectivity: 0.02 (é€‰æ‹©æ€§ä¸­ç­‰)
```

**ğŸ¯ é€‰æ‹©æ€§è¯„ä¼°æ ‡å‡†**
```
é€‰æ‹©æ€§è¯„åˆ†æ ‡å‡†ï¼š
â”Œâ”€ é€‰æ‹©æ€§åˆ†ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æé«˜é€‰æ‹©æ€§ï¼š>0.5 (ä¸»é”®ã€å”¯ä¸€é”®)  â”‚
â”‚ é«˜é€‰æ‹©æ€§ï¼š0.1-0.5 (ç”¨æˆ·IDã€é‚®ç®±) â”‚
â”‚ ä¸­é€‰æ‹©æ€§ï¼š0.01-0.1 (åˆ†ç±»ã€åœ°åŒº) â”‚
â”‚ ä½é€‰æ‹©æ€§ï¼š<0.01 (çŠ¶æ€ã€æ€§åˆ«)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–å»ºè®®ï¼š
â€¢ æé«˜/é«˜é€‰æ‹©æ€§æ¡ä»¶ï¼šä¼˜å…ˆæ”¾åœ¨WHEREæœ€å‰é¢
â€¢ ä¸­é€‰æ‹©æ€§æ¡ä»¶ï¼šç»“åˆç´¢å¼•æƒ…å†µå†³å®šé¡ºåº
â€¢ ä½é€‰æ‹©æ€§æ¡ä»¶ï¼šæ”¾åœ¨æœ€åï¼Œæˆ–è€ƒè™‘ç»„åˆç´¢å¼•
```

### 2.3 æ•°æ®åº“ä¼˜åŒ–å™¨çš„æ¡ä»¶é‡æ’


**ğŸ¤– ä¼˜åŒ–å™¨è‡ªåŠ¨é‡æ’æœºåˆ¶**
```sql
-- æˆ‘ä»¬å†™çš„SQLï¼ˆé¡ºåºå¯èƒ½ä¸æ˜¯æœ€ä¼˜ï¼‰
SELECT * FROM products 
WHERE price BETWEEN 100 AND 500      -- ä¸­é€‰æ‹©æ€§
  AND category = 'laptop'             -- ä½é€‰æ‹©æ€§  
  AND brand_id = 123;                 -- é«˜é€‰æ‹©æ€§

-- ä¼˜åŒ–å™¨å¯èƒ½é‡æ–°æ’åˆ—ä¸ºï¼š
-- 1. brand_id = 123 (é«˜é€‰æ‹©æ€§ï¼Œå…ˆæ‰§è¡Œ)
-- 2. price BETWEEN 100 AND 500 (ä¸­é€‰æ‹©æ€§)  
-- 3. category = 'laptop' (ä½é€‰æ‹©æ€§ï¼Œæœ€åæ‰§è¡Œ)
```

> **ğŸ¤” æ–°æ‰‹ç–‘é—®**ï¼šæ—¢ç„¶æ•°æ®åº“ä¼šè‡ªåŠ¨ä¼˜åŒ–ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ‰‹åŠ¨è°ƒæ•´é¡ºåºï¼Ÿ
> **ğŸ’¡ ç­”æ¡ˆ**ï¼šæ•°æ®åº“ä¼˜åŒ–å™¨å¾ˆèªæ˜ï¼Œä½†ä¸æ˜¯ä¸‡èƒ½çš„ã€‚åœ¨å¤æ‚æŸ¥è¯¢ã€ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸã€æˆ–ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œæ‰‹åŠ¨ä¼˜åŒ–ä»ç„¶å¾ˆé‡è¦ã€‚

### 2.4 æ¡ä»¶é¡ºåºä¼˜åŒ–å®æˆ˜


**ğŸ’» å®é™…ä¼˜åŒ–æ¡ˆä¾‹**
```sql
-- åŸå§‹æ…¢æŸ¥è¯¢ï¼ˆè€—æ—¶5ç§’ï¼‰
SELECT order_id, customer_name, total_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2023-01-01'           -- ä¸­é€‰æ‹©æ€§ï¼Œ20%æ•°æ®
  AND c.city = 'Shanghai'                    -- ä½é€‰æ‹©æ€§ï¼Œ30%æ•°æ®
  AND o.total_amount > 1000                  -- ä¸­é€‰æ‹©æ€§ï¼Œ15%æ•°æ®
  AND c.vip_level = 'gold'                   -- é«˜é€‰æ‹©æ€§ï¼Œ2%æ•°æ®
  AND o.status = 'completed';                -- ä½é€‰æ‹©æ€§ï¼Œ40%æ•°æ®

-- ä¼˜åŒ–ç¬¬ä¸€æ­¥ï¼šè°ƒæ•´æ¡ä»¶é¡ºåºï¼ˆè€—æ—¶2ç§’ï¼‰
SELECT order_id, customer_name, total_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id  
WHERE c.vip_level = 'gold'                   -- æœ€é«˜é€‰æ‹©æ€§ï¼Œå…ˆæ‰§è¡Œ
  AND o.total_amount > 1000                  -- æ¬¡é«˜é€‰æ‹©æ€§
  AND o.order_date >= '2023-01-01'           -- ä¸­ç­‰é€‰æ‹©æ€§
  AND c.city = 'Shanghai'                    -- è¾ƒä½é€‰æ‹©æ€§
  AND o.status = 'completed';                -- æœ€ä½é€‰æ‹©æ€§ï¼Œæœ€åæ‰§è¡Œ

-- è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šæ·»åŠ å¤åˆç´¢å¼•ï¼ˆè€—æ—¶0.1ç§’ï¼‰
CREATE INDEX idx_vip_amount_date ON orders (customer_id, total_amount, order_date);
CREATE INDEX idx_customer_vip_city ON customers (vip_level, city);
```

---

## 3. ğŸ¯ é€‰æ‹©æ€§é«˜æ¡ä»¶ä¼˜å…ˆç­–ç•¥


### 3.1 ç†è§£æ¡ä»¶é€‰æ‹©æ€§


**ğŸ”¸ é€‰æ‹©æ€§çš„æ•°å­¦å®šä¹‰**
```
é€‰æ‹©æ€§ = ä¸é‡å¤å€¼çš„æ•°é‡ / æ€»è®°å½•æ•°é‡

å®é™…è®¡ç®—ç¤ºä¾‹ï¼š
ç”¨æˆ·è¡¨(1000ä¸‡æ¡è®°å½•)ï¼š
â€¢ user_idé€‰æ‹©æ€§ = 1000ä¸‡ / 1000ä¸‡ = 1.0 (å®Œç¾)
â€¢ emailé€‰æ‹©æ€§ = 950ä¸‡ / 1000ä¸‡ = 0.95 (æé«˜) 
â€¢ ageé€‰æ‹©æ€§ = 80 / 1000ä¸‡ â‰ˆ 0.000008 (æä½)
â€¢ genderé€‰æ‹©æ€§ = 2 / 1000ä¸‡ â‰ˆ 0.0000002 (æœ€ä½)
```

**ğŸ“ˆ é€‰æ‹©æ€§ä¸æŸ¥è¯¢æ€§èƒ½å…³ç³»å›¾**
```
æ€§èƒ½
  â†‘
  â”‚     â—â—â—â—â— (é€‰æ‹©æ€§>0.1ï¼Œæ€§èƒ½ä¼˜ç§€)
  â”‚   â—â—â— 
  â”‚  â—â—
  â”‚ â—â—
  â”‚â—â— (é€‰æ‹©æ€§<0.01ï¼Œæ€§èƒ½è¾ƒå·®)
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ é€‰æ‹©æ€§
   0    0.01   0.1    0.5    1.0

ç»“è®ºï¼šé€‰æ‹©æ€§è¶Šé«˜ï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå¥½
```

### 3.2 é«˜é€‰æ‹©æ€§æ¡ä»¶è¯†åˆ«æŠ€å·§


**ğŸ” å¿«é€Ÿè¯†åˆ«é«˜é€‰æ‹©æ€§å­—æ®µ**
```sql
-- æ‰¹é‡åˆ†æè¡¨ä¸­æ‰€æœ‰å­—æ®µçš„é€‰æ‹©æ€§
SELECT 
    'customer_id' AS column_name,
    COUNT(DISTINCT customer_id)::FLOAT / COUNT(*) AS selectivity,
    COUNT(DISTINCT customer_id) AS unique_values,
    COUNT(*) AS total_rows
FROM orders
UNION ALL
SELECT 
    'order_date',
    COUNT(DISTINCT order_date)::FLOAT / COUNT(*),
    COUNT(DISTINCT order_date),
    COUNT(*)
FROM orders
UNION ALL  
SELECT 
    'status',
    COUNT(DISTINCT status)::FLOAT / COUNT(*),
    COUNT(DISTINCT status), 
    COUNT(*)
FROM orders
ORDER BY selectivity DESC;
```

**ğŸ¯ é€‰æ‹©æ€§ä¼˜åŒ–å†³ç­–æ ‘**
```
åˆ¤æ–­æ¡ä»¶é€‰æ‹©æ€§ï¼š
              æ¡ä»¶é€‰æ‹©æ€§ï¼Ÿ
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚          â”‚
   é€‰æ‹©æ€§>0.1   0.01-0.1   é€‰æ‹©æ€§<0.01
        â”‚          â”‚          â”‚
   â”Œâ”€ ä¼˜å…ˆçº§1 â”€â” â”Œâ”€ ä¼˜å…ˆçº§2 â”€â” â”Œâ”€ ä¼˜å…ˆçº§3 â”€â”
   â”‚ â€¢ ä¸»é”®    â”‚ â”‚ â€¢ åˆ†ç±»å­—æ®µâ”‚ â”‚ â€¢ çŠ¶æ€å­—æ®µâ”‚
   â”‚ â€¢ å”¯ä¸€é”®  â”‚ â”‚ â€¢ æ—¶é—´èŒƒå›´â”‚ â”‚ â€¢ å¸ƒå°”å­—æ®µâ”‚
   â”‚ â€¢ å¤–é”®ID â”‚ â”‚ â€¢ æ•°å€¼èŒƒå›´â”‚ â”‚ â€¢ æšä¸¾å€¼  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å¤åˆæ¡ä»¶é€‰æ‹©æ€§åˆ†æ


**ğŸ”§ ç»„åˆæ¡ä»¶é€‰æ‹©æ€§è®¡ç®—**
```sql
-- åˆ†æç»„åˆæ¡ä»¶çš„é€‰æ‹©æ€§
-- å•ä¸ªæ¡ä»¶é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT city) / COUNT(*) AS city_selectivity,
    COUNT(DISTINCT age_group) / COUNT(*) AS age_selectivity,
    COUNT(DISTINCT gender) / COUNT(*) AS gender_selectivity
FROM users;

-- ç»„åˆæ¡ä»¶é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT CONCAT(city, age_group)) / COUNT(*) AS city_age_selectivity,
    COUNT(DISTINCT CONCAT(city, gender)) / COUNT(*) AS city_gender_selectivity,
    COUNT(DISTINCT CONCAT(age_group, gender)) / COUNT(*) AS age_gender_selectivity
FROM users;

-- ç»“æœåˆ†æï¼š
-- city_selectivity: 0.001 (ä½)
-- age_selectivity: 0.01 (ä½)  
-- city_age_selectivity: 0.08 (ä¸­ç­‰) â† ç»„åˆåé€‰æ‹©æ€§æé«˜ï¼
```

### 3.4 åŠ¨æ€é€‰æ‹©æ€§ä¼˜åŒ–


**âš¡ è¿è¡Œæ—¶é€‰æ‹©æ€§åˆ¤æ–­**
```sql
-- åŠ¨æ€æŸ¥è¯¢ä¸­çš„é€‰æ‹©æ€§ä¼˜åŒ–
-- æ ¹æ®å‚æ•°å€¼åŠ¨æ€è°ƒæ•´æ¡ä»¶é¡ºåº

-- åœºæ™¯ï¼šæ ¹æ®ä¸åŒçš„ç­›é€‰æ¡ä»¶ï¼ŒåŠ¨æ€ä¼˜åŒ–æŸ¥è¯¢
DELIMITER $$
CREATE PROCEDURE GetProductsByFilters(
    IN p_category VARCHAR(50),
    IN p_brand_id INT,
    IN p_price_min DECIMAL(10,2),
    IN p_price_max DECIMAL(10,2)
)
BEGIN
    -- å…ˆåˆ¤æ–­å“ªä¸ªæ¡ä»¶é€‰æ‹©æ€§æ›´é«˜
    IF p_brand_id IS NOT NULL THEN
        -- brand_idé€šå¸¸é€‰æ‹©æ€§è¾ƒé«˜ï¼Œä¼˜å…ˆä½¿ç”¨
        SELECT * FROM products 
        WHERE brand_id = p_brand_id
          AND (p_category IS NULL OR category = p_category)
          AND price BETWEEN p_price_min AND p_price_max;
    ELSEIF p_category IS NOT NULL THEN
        -- å…¶æ¬¡ä½¿ç”¨category
        SELECT * FROM products
        WHERE category = p_category  
          AND price BETWEEN p_price_min AND p_price_max;
    ELSE
        -- æœ€åä½¿ç”¨ä»·æ ¼èŒƒå›´
        SELECT * FROM products
        WHERE price BETWEEN p_price_min AND p_price_max;
    END IF;
END$$
DELIMITER ;
```

---

## 4. ğŸš« å‡½æ•°è°ƒç”¨é¿å…æŠ€æœ¯


### 4.1 å‡½æ•°è°ƒç”¨å¯¹æ€§èƒ½çš„å½±å“


> **ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼šåœ¨WHEREæ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°å°±åƒç»™æ¯æ¡æ•°æ®éƒ½åšä¸€æ¬¡"ä½“æ£€"ï¼Œè™½ç„¶èƒ½å¾—åˆ°å‡†ç¡®ç»“æœï¼Œä½†é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œè€Œä¸”æ— æ³•ä½¿ç”¨"å¿«é€Ÿé€šé“"ï¼ˆç´¢å¼•ï¼‰ã€‚

**ğŸ”¸ å‡½æ•°è°ƒç”¨çš„æ€§èƒ½é—®é¢˜**
```
å‡½æ•°è°ƒç”¨çš„æ€§èƒ½å½±å“ï¼š
â”Œâ”€ æ— å‡½æ•°è°ƒç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WHERE created_date = '2023-01-01' â”‚
â”‚ â€¢ ç›´æ¥ä½¿ç”¨ç´¢å¼•                  â”‚
â”‚ â€¢ æŸ¥è¯¢æ—¶é—´ï¼š1ms                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ä½¿ç”¨å‡½æ•°è°ƒç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WHERE DATE(created_date) = '2023-01-01' â”‚
â”‚ â€¢ æ¯è¡Œéƒ½è¦æ‰§è¡ŒDATE()å‡½æ•°        â”‚
â”‚ â€¢ æ— æ³•ä½¿ç”¨ç´¢å¼•                  â”‚
â”‚ â€¢ æŸ¥è¯¢æ—¶é—´ï¼š1000ms (æ…¢1000å€!)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å¸¸è§å‡½æ•°è°ƒç”¨é—®é¢˜åŠä¼˜åŒ–


**ğŸ“… æ—¥æœŸå‡½æ•°ä¼˜åŒ–**

```sql
-- âŒ é”™è¯¯å†™æ³•ï¼šä½¿ç”¨å‡½æ•°ç ´åç´¢å¼•
SELECT * FROM orders 
WHERE YEAR(order_date) = 2023;                -- æ— æ³•ä½¿ç”¨ç´¢å¼•
WHERE MONTH(order_date) = 12;                 -- æ¯è¡Œéƒ½è¦è®¡ç®—
WHERE DATE_FORMAT(order_date, '%Y-%m') = '2023-12'; -- æ ¼å¼åŒ–å¾ˆæ…¢

-- âœ… æ­£ç¡®å†™æ³•ï¼šä½¿ç”¨èŒƒå›´æ¡ä»¶
SELECT * FROM orders 
WHERE order_date >= '2023-01-01'              -- ä½¿ç”¨ç´¢å¼•èŒƒå›´æ‰«æ
  AND order_date < '2024-01-01';              -- é«˜æ•ˆä¸”å‡†ç¡®

WHERE order_date >= '2023-12-01'              -- åäºŒæœˆæ•°æ®  
  AND order_date < '2024-01-01';

-- ç²¾ç¡®åˆ°å¤©çš„èŒƒå›´æŸ¥è¯¢
WHERE order_date >= '2023-12-15'              -- æŸä¸€å¤©çš„æ•°æ®
  AND order_date < '2023-12-16';
```

**ğŸ”¤ å­—ç¬¦ä¸²å‡½æ•°ä¼˜åŒ–**
```sql
-- âŒ é”™è¯¯å†™æ³•ï¼šå­—ç¬¦ä¸²å‡½æ•°ç ´åç´¢å¼•
SELECT * FROM users 
WHERE UPPER(username) = 'ADMIN';              -- æ¯è¡Œéƒ½è¦è½¬å¤§å†™
WHERE LEFT(phone, 3) = '138';                 -- æ¯è¡Œéƒ½è¦æˆªå–
WHERE LENGTH(description) > 100;              -- æ¯è¡Œéƒ½è¦è®¡ç®—é•¿åº¦

-- âœ… æ­£ç¡®å†™æ³•ï¼šé¢„å¤„ç†æˆ–ä½¿ç”¨å…¶ä»–æ–¹å¼
-- æ–¹æ¡ˆ1ï¼šé¢„å…ˆå­˜å‚¨å¤§å†™ç‰ˆæœ¬
ALTER TABLE users ADD username_upper VARCHAR(50);
UPDATE users SET username_upper = UPPER(username);
CREATE INDEX idx_username_upper ON users(username_upper);
SELECT * FROM users WHERE username_upper = 'ADMIN';

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨LIKEæˆ–æ­£åˆ™
SELECT * FROM users WHERE phone LIKE '138%';   -- å¯ä»¥ä½¿ç”¨å‰ç¼€ç´¢å¼•

-- æ–¹æ¡ˆ3ï¼šæ·»åŠ è®¡ç®—åˆ—
ALTER TABLE users ADD description_length INT;
UPDATE users SET description_length = LENGTH(description);  
SELECT * FROM users WHERE description_length > 100;
```

### 4.3 æ•°å€¼è®¡ç®—å‡½æ•°ä¼˜åŒ–


**ğŸ”¢ æ•°å€¼å‡½æ•°ä¼˜åŒ–æŠ€å·§**
```sql
-- âŒ é¿å…åœ¨WHEREä¸­è¿›è¡Œå¤æ‚è®¡ç®—
SELECT * FROM orders 
WHERE price * quantity * (1 - discount_rate) > 1000;  -- æ¯è¡Œéƒ½è¦è®¡ç®—

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šé¢„è®¡ç®—
-- æ–¹æ¡ˆ1ï¼šæ·»åŠ è®¡ç®—å­—æ®µ
ALTER TABLE orders ADD total_amount DECIMAL(10,2);
UPDATE orders SET total_amount = price * quantity * (1 - discount_rate);
CREATE INDEX idx_total_amount ON orders(total_amount);
SELECT * FROM orders WHERE total_amount > 1000;

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤
DELIMITER $$
CREATE TRIGGER tr_orders_total_amount
BEFORE INSERT ON orders
FOR EACH ROW
BEGIN
    SET NEW.total_amount = NEW.price * NEW.quantity * (1 - NEW.discount_rate);
END$$
DELIMITER ;
```

### 4.4 å‡½æ•°è°ƒç”¨æ›¿ä»£ç­–ç•¥


**ğŸ”„ å‡½æ•°æ›¿ä»£æ–¹æ¡ˆæ±‡æ€»è¡¨**

| åŸå‡½æ•°è°ƒç”¨ | **æ›¿ä»£æ–¹æ¡ˆ** | **æ€§èƒ½æå‡** | **é€‚ç”¨åœºæ™¯** |
|-----------|-------------|-------------|-------------|
| `YEAR(date) = 2023` | `date >= '2023-01-01' AND date < '2024-01-01'` | 10-100å€ | å¹´ä»½è¿‡æ»¤ |
| `UPPER(str) = 'VALUE'` | é¢„å­˜å¤§å†™ç‰ˆæœ¬å­—æ®µ | 5-50å€ | ä¸åŒºåˆ†å¤§å°å†™æŸ¥è¯¢ |
| `LEFT(str, n) = 'prefix'` | `str LIKE 'prefix%'` | 2-10å€ | å‰ç¼€åŒ¹é… |
| `LENGTH(str) > 100` | æ·»åŠ é•¿åº¦å­—æ®µ | 10-50å€ | é•¿åº¦è¿‡æ»¤ |
| `ABS(num) > 100` | `num > 100 OR num < -100` | 2-5å€ | ç»å¯¹å€¼æ¯”è¾ƒ |

**ğŸ¯ æ›¿ä»£ç­–ç•¥é€‰æ‹©æŒ‡å—**
```
é€‰æ‹©æ›¿ä»£æ–¹æ¡ˆçš„å†³ç­–æµç¨‹ï¼š
1. æ˜¯å¦æ˜¯çƒ­ç‚¹æŸ¥è¯¢ï¼Ÿ(QPS > 100)
   Yes â†’ ä¼˜å…ˆè€ƒè™‘é¢„è®¡ç®—æ–¹æ¡ˆ
   No â†’ å¯ä»¥ä¿æŒç°çŠ¶æˆ–ç®€å•ä¼˜åŒ–

2. è®¡ç®—ç»“æœæ˜¯å¦ç›¸å¯¹ç¨³å®šï¼Ÿ
   Yes â†’ ä½¿ç”¨å†—ä½™å­—æ®µå­˜å‚¨è®¡ç®—ç»“æœ  
   No â†’ è€ƒè™‘å®æ—¶è®¡ç®—ä¼˜åŒ–

3. æ˜¯å¦å¯ä»¥ç”¨ç®€å•æ¡ä»¶æ›¿ä»£ï¼Ÿ
   Yes â†’ é‡å†™WHEREæ¡ä»¶
   No â†’ è€ƒè™‘å‡½æ•°ç´¢å¼•æˆ–å…¶ä»–æ–¹æ¡ˆ
```

---

## 5. ğŸ”„ ç±»å‹è½¬æ¢æ¶ˆé™¤æ–¹æ³•


### 5.1 éšå¼ç±»å‹è½¬æ¢çš„å±å®³


> **ğŸ’¡ é€šä¿—ç†è§£**ï¼šç±»å‹è½¬æ¢å°±åƒè¯­è¨€ç¿»è¯‘ï¼Œæ¯æ¬¡ç¿»è¯‘éƒ½éœ€è¦æ—¶é—´ã€‚å¦‚æœæ•°æ®åº“å‘ç°ä½ çš„æ¡ä»¶ç±»å‹å’Œå­—æ®µç±»å‹ä¸åŒ¹é…ï¼Œå°±è¦é€è¡Œ"ç¿»è¯‘"ï¼Œä¸ä»…æ…¢ï¼Œè¿˜å¯èƒ½æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚

**ğŸ”¸ éšå¼è½¬æ¢çš„æ€§èƒ½å½±å“**
```
éšå¼è½¬æ¢ç¤ºä¾‹ï¼š
è¡¨å­—æ®µï¼šuser_id INT
æŸ¥è¯¢æ¡ä»¶ï¼šWHERE user_id = '123'  (å­—ç¬¦ä¸²)

æ•°æ®åº“å†…éƒ¨å¤„ç†ï¼š
â”Œâ”€ é€è¡Œè½¬æ¢è¿‡ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1è¡Œï¼šCAST(user_id AS VARCHAR) = '123' â”‚
â”‚ ç¬¬2è¡Œï¼šCAST(user_id AS VARCHAR) = '123' â”‚
â”‚ ç¬¬3è¡Œï¼šCAST(user_id AS VARCHAR) = '123' â”‚
â”‚ ...                                     â”‚
â”‚ ç¬¬Nè¡Œï¼šCAST(user_id AS VARCHAR) = '123' â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœï¼š
â€¢ æ— æ³•ä½¿ç”¨user_idä¸Šçš„ç´¢å¼•
â€¢ æ¯è¡Œéƒ½è¦è¿›è¡Œç±»å‹è½¬æ¢è®¡ç®—
â€¢ æŸ¥è¯¢æ€§èƒ½ä¸‹é™10-100å€
```

### 5.2 å¸¸è§ç±»å‹è½¬æ¢é—®é¢˜


**ğŸ“Š å…¸å‹ç±»å‹ä¸åŒ¹é…åœºæ™¯**

```sql
-- âŒ æ•°å€¼ç±»å‹ä¸åŒ¹é…
-- å­—æ®µå®šä¹‰ï¼šuser_id BIGINT
SELECT * FROM users WHERE user_id = 123;        -- INTä¼ ç»™BIGINTï¼Œè¿˜å¯ä»¥
SELECT * FROM users WHERE user_id = '123';      -- å­—ç¬¦ä¸²è½¬æ•°å­—ï¼Œæ€§èƒ½å·®ï¼

-- âŒ å­—ç¬¦ä¸²ç±»å‹ä¸åŒ¹é…  
-- å­—æ®µå®šä¹‰ï¼šusername VARCHAR(50)
SELECT * FROM users WHERE username = 123;       -- æ•°å­—è½¬å­—ç¬¦ä¸²
SELECT * FROM users WHERE username LIKE 123;    -- é”™è¯¯ç”¨æ³•

-- âŒ æ—¥æœŸç±»å‹ä¸åŒ¹é…
-- å­—æ®µå®šä¹‰ï¼šcreated_date DATETIME  
SELECT * FROM orders WHERE created_date = 20230101;           -- æ•°å­—è½¬æ—¥æœŸ
SELECT * FROM orders WHERE created_date = '2023-01-01 00:00:00.000'; -- ç²¾åº¦ä¸åŒ¹é…

-- âŒ å¸ƒå°”ç±»å‹ä¸åŒ¹é…
-- å­—æ®µå®šä¹‰ï¼šis_active TINYINT(1)
SELECT * FROM users WHERE is_active = 'true';   -- å­—ç¬¦ä¸²è½¬æ•°å­—
SELECT * FROM users WHERE is_active = '1';      -- å­—ç¬¦ä¸²è½¬æ•°å­—
```

### 5.3 ç±»å‹è½¬æ¢æ£€æµ‹æ–¹æ³•


**ğŸ” MySQLä¸­æ£€æµ‹éšå¼è½¬æ¢**
```sql
-- ä½¿ç”¨EXPLAINæŸ¥çœ‹æ˜¯å¦å‘ç”Ÿç±»å‹è½¬æ¢
EXPLAIN SELECT * FROM users WHERE user_id = '123';

-- åœ¨Extraåˆ—ä¸­å¦‚æœçœ‹åˆ°ï¼š
-- "Using where; Using index condition"å¯èƒ½è¿˜å¥½
-- "Using where"ä¸”æ²¡æœ‰ä½¿ç”¨ç´¢å¼•å°±è¦æ³¨æ„äº†

-- å¼€å¯è­¦å‘ŠæŸ¥çœ‹è½¬æ¢ä¿¡æ¯
SHOW WARNINGS;

-- ä½¿ç”¨æŸ¥è¯¢æ—¥å¿—åˆ†æ
SET GLOBAL log_queries_not_using_indexes = ON;
SET GLOBAL slow_query_log = ON;
```

**ğŸ¯ æ€§èƒ½å¯¹æ¯”æµ‹è¯•**
```sql
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE test_users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    created_date DATETIME,
    INDEX idx_username (username)
);

-- æ’å…¥100ä¸‡æµ‹è¯•æ•°æ®
INSERT INTO test_users 
SELECT 
    id,
    CONCAT('user_', id),
    DATE_ADD('2020-01-01', INTERVAL id SECOND)
FROM (SELECT @row := @row + 1 AS id FROM 
      (SELECT 0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3) t1,
      (SELECT 0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3) t2,
      -- ... é‡å¤ç”Ÿæˆè¶³å¤Ÿè¡Œæ•°
) t;

-- æ€§èƒ½å¯¹æ¯”æµ‹è¯•
-- æ­£ç¡®ç±»å‹åŒ¹é…ï¼ˆå¿«ï¼‰
SELECT * FROM test_users WHERE user_id = 123456;              -- 0.001ç§’

-- ç±»å‹ä¸åŒ¹é…ï¼ˆæ…¢ï¼‰  
SELECT * FROM test_users WHERE user_id = '123456';            -- 0.5ç§’ï¼Œæ…¢500å€ï¼
```

### 5.4 ç±»å‹è½¬æ¢ä¼˜åŒ–æ–¹æ¡ˆ


**âœ… ç±»å‹åŒ¹é…æœ€ä½³å®è·µ**

```sql
-- æ•°å€¼ç±»å‹ä¼˜åŒ–
-- âŒ é¿å…
WHERE user_id = '123'
WHERE price = '99.99'  
WHERE quantity = '10'

-- âœ… æ¨è
WHERE user_id = 123
WHERE price = 99.99
WHERE quantity = 10

-- å­—ç¬¦ä¸²ç±»å‹ä¼˜åŒ–
-- âŒ é¿å…
WHERE username = 123
WHERE category_code = 100

-- âœ… æ¨è  
WHERE username = '123'
WHERE category_code = '100'

-- æ—¥æœŸç±»å‹ä¼˜åŒ–
-- âŒ é¿å…
WHERE created_date = 20230101
WHERE created_date = '2023-01-01'  -- å¦‚æœå­—æ®µæ˜¯DATETIME

-- âœ… æ¨è
WHERE created_date = '2023-01-01 00:00:00'  -- ç²¾ç¡®åŒ¹é…DATETIME
WHERE DATE(created_date) = '2023-01-01'     -- æˆ–è€…ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼š
WHERE created_date >= '2023-01-01 00:00:00'
  AND created_date < '2023-01-02 00:00:00'

-- å¸ƒå°”ç±»å‹ä¼˜åŒ–
-- âŒ é¿å…
WHERE is_active = 'true'
WHERE is_active = 'Y'

-- âœ… æ¨è
WHERE is_active = 1        -- å¯¹äºTINYINT(1)
WHERE is_active = TRUE     -- å¯¹äºBOOLEANç±»å‹
```

### 5.5 åº”ç”¨ç¨‹åºå±‚é¢çš„ç±»å‹æ§åˆ¶


**ğŸ’» ç¼–ç¨‹è¯­è¨€ä¸­çš„ç±»å‹æ§åˆ¶**
```java
// Javaä¸­çš„å‚æ•°ç±»å‹æ§åˆ¶
public List<User> getUsersByCondition(
    Long userId,           // æ˜ç¡®ä½¿ç”¨Longç±»å‹
    String username,       // æ˜ç¡®ä½¿ç”¨Stringç±»å‹  
    Date createdDate      // æ˜ç¡®ä½¿ç”¨Dateç±»å‹
) {
    String sql = "SELECT * FROM users WHERE user_id = ? AND username = ? AND created_date >= ?";
    
    // ä½¿ç”¨PreparedStatementè‡ªåŠ¨å¤„ç†ç±»å‹åŒ¹é…
    PreparedStatement ps = connection.prepareStatement(sql);
    ps.setLong(1, userId);        // è‡ªåŠ¨åŒ¹é…BIGINT
    ps.setString(2, username);    // è‡ªåŠ¨åŒ¹é…VARCHAR
    ps.setTimestamp(3, new Timestamp(createdDate.getTime())); // åŒ¹é…DATETIME
    
    return ps.executeQuery();
}
```

```python  
# Pythonä¸­çš„ç±»å‹æ§åˆ¶
def get_users_by_condition(user_id: int, username: str, created_date: datetime):
    """
    ä¸¥æ ¼æ§åˆ¶å‚æ•°ç±»å‹ï¼Œé¿å…ç±»å‹è½¬æ¢
    """
    # ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œè®©æ•°æ®åº“é©±åŠ¨å¤„ç†ç±»å‹åŒ¹é…
    sql = "SELECT * FROM users WHERE user_id = %s AND username = %s AND created_date >= %s"
    
    # ç¡®ä¿ä¼ å…¥çš„å‚æ•°ç±»å‹æ­£ç¡®
    cursor.execute(sql, (
        int(user_id),      # ç¡®ä¿æ˜¯æ•´æ•°
        str(username),     # ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
        created_date       # ç¡®ä¿æ˜¯datetimeå¯¹è±¡
    ))
```

---

## 6. ğŸ”— èŒƒå›´æ¡ä»¶åˆå¹¶ä¼˜åŒ–


### 6.1 èŒƒå›´æ¡ä»¶åˆå¹¶çš„åŸç†


> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**ï¼šèŒƒå›´æ¡ä»¶åˆå¹¶å°±åƒæ•´ç†ä¹¦æ¶ï¼ŒæŠŠ"æ•°å­¦ä¹¦ç¬¬1-50å†Œ"å’Œ"æ•°å­¦ä¹¦ç¬¬51-100å†Œ"åˆå¹¶æˆ"æ•°å­¦ä¹¦ç¬¬1-100å†Œ"ï¼Œè¿™æ ·æ‰¾ä¹¦æ—¶åªéœ€è¦ä¸€æ¬¡æ“ä½œï¼Œè€Œä¸æ˜¯ä¸¤æ¬¡ã€‚

**ğŸ”¸ èŒƒå›´æ¡ä»¶çš„ä¼˜åŒ–æœºåˆ¶**
```
åˆ†æ•£çš„èŒƒå›´æ¡ä»¶ï¼š
WHERE price >= 100 AND price <= 500 
  AND quantity >= 10 AND quantity <= 100

æ•°æ®åº“å¤„ç†è¿‡ç¨‹ï¼š
â”Œâ”€ ç¬¬1æ­¥ï¼špriceèŒƒå›´è¿‡æ»¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰«æpriceç´¢å¼•ï¼š100-500         â”‚
â”‚ è¿”å›ç¬¦åˆæ¡ä»¶çš„è¡Œ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€ ç¬¬2æ­¥ï¼šquantityèŒƒå›´è¿‡æ»¤ â”€â”€â”€â”€â”€â”€â”  
â”‚ å¯¹ç¬¬1æ­¥ç»“æœå†è¿‡æ»¤quantity      â”‚
â”‚ 10-100èŒƒå›´                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆå¹¶åçš„å¤åˆèŒƒå›´æ¡ä»¶ï¼š
INDEX(price, quantity) è¦†ç›–ä¸¤ä¸ªèŒƒå›´
ä¸€æ¬¡ç´¢å¼•æ‰«æå®Œæˆæ‰€æœ‰è¿‡æ»¤
```

### 6.2 ç®€å•èŒƒå›´æ¡ä»¶ä¼˜åŒ–


**ğŸ“Š åŸºæœ¬èŒƒå›´åˆå¹¶æŠ€å·§**
```sql
-- âŒ åˆ†æ•£çš„èŒƒå›´æ¡ä»¶
SELECT * FROM products 
WHERE price >= 100 
  AND price <= 500
  AND inventory_count > 0
  AND inventory_count <= 1000
  AND created_date >= '2023-01-01'
  AND created_date < '2024-01-01';

-- âœ… ä½¿ç”¨BETWEENç®€åŒ–è¯­æ³•
SELECT * FROM products 
WHERE price BETWEEN 100 AND 500           -- æ›´ç®€æ´ï¼Œè¯­ä¹‰æ›´æ¸…æ™°
  AND inventory_count BETWEEN 1 AND 1000  -- BETWEENåŒ…å«è¾¹ç•Œå€¼
  AND created_date >= '2023-01-01'        -- æ—¥æœŸèŒƒå›´é€šå¸¸ç”¨>=å’Œ<
  AND created_date < '2024-01-01';

-- ğŸ¯ è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šåˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_price_inventory_date ON products (price, inventory_count, created_date);
```

### 6.3 å¤æ‚èŒƒå›´æ¡ä»¶åˆå¹¶


**ğŸ”§ å¤šç»´åº¦èŒƒå›´ä¼˜åŒ–**
```sql
-- å¤æ‚çš„å¤šèŒƒå›´æ¡ä»¶æŸ¥è¯¢
SELECT order_id, total_amount, order_date
FROM orders 
WHERE 
    -- æ—¶é—´èŒƒå›´
    (order_date >= '2023-06-01' AND order_date < '2023-07-01')
    OR (order_date >= '2023-12-01' AND order_date < '2024-01-01')
    
    -- é‡‘é¢èŒƒå›´  
    AND (total_amount BETWEEN 1000 AND 5000)
    
    -- çŠ¶æ€èŒƒå›´
    AND status IN ('pending', 'processing', 'shipped');

-- ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šä½¿ç”¨UNIONåˆå¹¶ä¸è¿ç»­èŒƒå›´
SELECT order_id, total_amount, order_date
FROM orders 
WHERE order_date >= '2023-06-01' AND order_date < '2023-07-01'
  AND total_amount BETWEEN 1000 AND 5000
  AND status IN ('pending', 'processing', 'shipped')
UNION ALL
SELECT order_id, total_amount, order_date  
FROM orders
WHERE order_date >= '2023-12-01' AND order_date < '2024-01-01'
  AND total_amount BETWEEN 1000 AND 5000
  AND status IN ('pending', 'processing', 'shipped');

-- ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šé‡æ„ä¸ºå•ä¸€è¿ç»­èŒƒå›´ï¼ˆå¦‚æœä¸šåŠ¡å…è®¸ï¼‰
SELECT order_id, total_amount, order_date
FROM orders 
WHERE order_date >= '2023-06-01'      -- æ‰©å¤§èŒƒå›´ï¼Œåº”ç”¨å±‚è¿‡æ»¤
  AND order_date < '2024-01-01'
  AND total_amount BETWEEN 1000 AND 5000
  AND status IN ('pending', 'processing', 'shipped')
  AND (
      (order_date < '2023-07-01') OR    -- 6æœˆæ•°æ®
      (order_date >= '2023-12-01')     -- 12æœˆæ•°æ®
  );
```

### 6.4 èŒƒå›´æ¡ä»¶ç´¢å¼•ç­–ç•¥


**ğŸ“ˆ ç´¢å¼•è®¾è®¡ä¸èŒƒå›´æŸ¥è¯¢**
```sql
-- æ¡ˆä¾‹ï¼šç”µå•†è®¢å•æŸ¥è¯¢ä¼˜åŒ–
-- æŸ¥è¯¢éœ€æ±‚ï¼šæŒ‰æ—¶é—´èŒƒå›´ã€é‡‘é¢èŒƒå›´ã€çŠ¶æ€æŸ¥è¯¢è®¢å•

-- æ–¹æ¡ˆ1ï¼šå•åˆ—ç´¢å¼•ï¼ˆæ•ˆæœä¸€èˆ¬ï¼‰
CREATE INDEX idx_order_date ON orders (order_date);
CREATE INDEX idx_total_amount ON orders (total_amount);
CREATE INDEX idx_status ON orders (status);

-- æ–¹æ¡ˆ2ï¼šå¤åˆç´¢å¼•ä¼˜åŒ–ï¼ˆæ¨èï¼‰
-- ç´¢å¼•åˆ—é¡ºåºå¾ˆé‡è¦ï¼šç­‰å€¼æ¡ä»¶ â†’ èŒƒå›´æ¡ä»¶
CREATE INDEX idx_status_date_amount ON orders (status, order_date, total_amount);

-- æŸ¥è¯¢SQLï¼ˆèƒ½å……åˆ†åˆ©ç”¨å¤åˆç´¢å¼•ï¼‰
SELECT * FROM orders 
WHERE status IN ('pending', 'processing')    -- ç­‰å€¼æ¡ä»¶åœ¨å‰
  AND order_date >= '2023-01-01'             -- èŒƒå›´æ¡ä»¶åœ¨ä¸­
  AND order_date < '2024-01-01'
  AND total_amount >= 1000;                  -- èŒƒå›´æ¡ä»¶åœ¨å

-- æ–¹æ¡ˆ3ï¼šè¦†ç›–ç´¢å¼•ï¼ˆæœ€ä¼˜æ€§èƒ½ï¼‰
CREATE INDEX idx_covering ON orders (status, order_date, total_amount, order_id, customer_id);

-- è¿™ä¸ªç´¢å¼•èƒ½å®Œå…¨è¦†ç›–æŸ¥è¯¢ï¼Œæ— éœ€å›è¡¨
SELECT order_id, customer_id, total_amount 
FROM orders 
WHERE status = 'pending'
  AND order_date BETWEEN '2023-01-01' AND '2023-12-31'
  AND total_amount >= 1000;
```

### 6.5 èŒƒå›´æŸ¥è¯¢æ€§èƒ½ç›‘æ§


**ğŸ“Š æ€§èƒ½åˆ†æå·¥å…·**
```sql
-- åˆ†æèŒƒå›´æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM orders 
WHERE order_date BETWEEN '2023-01-01' AND '2023-12-31'
  AND total_amount BETWEEN 1000 AND 5000;

-- å…³é”®æŒ‡æ ‡è§£è¯»ï¼š
-- type: range (èŒƒå›´æ‰«æï¼Œæ¯”è¾ƒå¥½)
-- key: ä½¿ç”¨çš„ç´¢å¼•åç§°
-- key_len: ç´¢å¼•ä½¿ç”¨çš„é•¿åº¦
-- rows: ä¼°ç®—æ‰«æçš„è¡Œæ•°
-- Extra: é¢å¤–ä¿¡æ¯

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    table_name,
    index_name,
    seq_in_index,
    column_name,
    cardinality
FROM information_schema.statistics 
WHERE table_schema = 'your_database'
  AND table_name = 'orders'
ORDER BY table_name, index_name, seq_in_index;
```

---

## 7. ğŸ”„ æ¡ä»¶é‡æ„æŠ€æœ¯


### 7.1 ä»€ä¹ˆæ˜¯æ¡ä»¶é‡æ„


> **ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼šæ¡ä»¶é‡æ„å°±åƒé‡æ–°æ•´ç†æˆ¿é—´ï¼ŒæŠŠæ‚ä¹±æ— ç« çš„ç‰©å“æŒ‰ç…§ä½¿ç”¨é¢‘ç‡å’Œé‡è¦æ€§é‡æ–°æ‘†æ”¾ï¼Œè®©æ‰¾ä¸œè¥¿æ›´å¿«æ›´æ–¹ä¾¿ã€‚

**ğŸ”¸ æ¡ä»¶é‡æ„çš„ç›®æ ‡**
```
é‡æ„ç›®æ ‡ï¼š
â”Œâ”€ é€»è¾‘ç­‰ä»·æ€§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡æ„å‰åæŸ¥è¯¢ç»“æœå®Œå…¨ç›¸åŒ        â”‚
â”‚ ä¸èƒ½æ”¹å˜ä¸šåŠ¡é€»è¾‘å«ä¹‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€ æ€§èƒ½æå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´å¥½åœ°åˆ©ç”¨ç´¢å¼•                  â”‚
â”‚ å‡å°‘ä¸å¿…è¦çš„è®¡ç®—                â”‚  
â”‚ é™ä½æ•°æ®æ‰«æé‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 ORæ¡ä»¶é‡æ„ä¼˜åŒ–


**ğŸ”€ ORæ¡ä»¶çš„æ€§èƒ½é—®é¢˜ä¸è§£å†³**
```sql
-- âŒ ä½æ•ˆçš„ORæ¡ä»¶
SELECT * FROM users 
WHERE status = 'active' 
   OR status = 'premium' 
   OR status = 'vip';

-- âœ… é‡æ„ä¸ºINæ¡ä»¶ï¼ˆæ›´é«˜æ•ˆï¼‰
SELECT * FROM users 
WHERE status IN ('active', 'premium', 'vip');

-- æ›´å¤æ‚çš„ORæ¡ä»¶é‡æ„
-- âŒ åŸå§‹æŸ¥è¯¢ï¼ˆå¯èƒ½æ— æ³•æœ‰æ•ˆä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM orders 
WHERE (status = 'pending' AND priority = 'high')
   OR (status = 'processing' AND priority = 'urgent')
   OR (customer_type = 'vip' AND total_amount > 10000);

-- âœ… é‡æ„ä¸ºUNIONï¼ˆæ¯ä¸ªå­æŸ¥è¯¢éƒ½èƒ½ç”¨ç´¢å¼•ï¼‰
SELECT * FROM orders WHERE status = 'pending' AND priority = 'high'
UNION
SELECT * FROM orders WHERE status = 'processing' AND priority = 'urgent'  
UNION
SELECT * FROM orders WHERE customer_type = 'vip' AND total_amount > 10000;
```

### 7.3 INæ¡ä»¶ä¼˜åŒ–é‡æ„


**ğŸ“ INæ¡ä»¶çš„ä¼˜åŒ–ç­–ç•¥**
```sql
-- å¤§é‡INå€¼çš„ä¼˜åŒ–
-- âŒ å½“INä¸­çš„å€¼å¾ˆå¤šæ—¶ï¼ˆ>1000ä¸ªï¼‰
SELECT * FROM products 
WHERE category_id IN (1,2,3,4,5,...,2000);  -- 2000ä¸ªå€¼

-- âœ… é‡æ„æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_categories (category_id INT);
INSERT INTO temp_categories VALUES (1),(2),(3),...,(2000);

SELECT p.* FROM products p
INNER JOIN temp_categories t ON p.category_id = t.category_id;

-- âœ… é‡æ„æ–¹æ¡ˆ2ï¼šä½¿ç”¨EXISTSï¼ˆå¦‚æœæœ‰å…³è”è¡¨ï¼‰
SELECT * FROM products p
WHERE EXISTS (
    SELECT 1 FROM user_favorite_categories ufc 
    WHERE ufc.category_id = p.category_id 
      AND ufc.user_id = 12345
);

-- INæ¡ä»¶ä¸èŒƒå›´æ¡ä»¶çš„ç»„åˆä¼˜åŒ–
-- âŒ æ•ˆç‡è¾ƒä½
SELECT * FROM orders 
WHERE status IN ('pending', 'processing')
  AND customer_id IN (SELECT customer_id FROM vip_customers)
  AND order_date >= '2023-01-01';

-- âœ… é‡æ„ä¼˜åŒ–
SELECT o.* FROM orders o
INNER JOIN vip_customers v ON o.customer_id = v.customer_id
WHERE o.status IN ('pending', 'processing')
  AND o.order_date >= '2023-01-01';
```

### 7.4 å¤åˆæ¡ä»¶åˆ†è§£é‡æ„


**ğŸ§© å¤åˆæ¡ä»¶ä¼˜åŒ–æŠ€å·§**
```sql
-- å¤æ‚çš„åµŒå¥—æ¡ä»¶é‡æ„
-- âŒ åŸå§‹å¤æ‚æ¡ä»¶
SELECT * FROM orders o
WHERE (
    (o.status = 'pending' AND o.created_date >= DATE_SUB(NOW(), INTERVAL 7 DAY))
    OR  
    (o.status = 'processing' AND o.priority = 'high')
    OR
    (o.customer_type = 'vip' AND o.total_amount > 5000)
) AND o.deleted_at IS NULL;

-- âœ… é‡æ„ä¸ºå¤šä¸ªç®€å•çš„å­æŸ¥è¯¢
WITH qualified_orders AS (
    -- æœ€è¿‘7å¤©çš„å¾…å¤„ç†è®¢å•
    SELECT order_id, customer_id, total_amount FROM orders 
    WHERE status = 'pending' 
      AND created_date >= DATE_SUB(NOW(), INTERVAL 7 DAY)
      AND deleted_at IS NULL
      
    UNION ALL
    
    -- é«˜ä¼˜å…ˆçº§å¤„ç†ä¸­è®¢å•  
    SELECT order_id, customer_id, total_amount FROM orders
    WHERE status = 'processing' 
      AND priority = 'high'
      AND deleted_at IS NULL
      
    UNION ALL
    
    -- VIPå¤§é¢è®¢å•
    SELECT order_id, customer_id, total_amount FROM orders
    WHERE customer_type = 'vip' 
      AND total_amount > 5000
      AND deleted_at IS NULL
)
SELECT DISTINCT * FROM qualified_orders;
```

### 7.5 æ¡ä»¶ä¸‹æ¨é‡æ„


**â¬‡ï¸ æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–**
```sql
-- æ¡ä»¶ä¸‹æ¨åˆ°å­æŸ¥è¯¢ä¸­
-- âŒ æ¡ä»¶åœ¨å¤–å±‚ï¼Œæ•ˆç‡ä½
SELECT o.*, c.customer_name
FROM (
    SELECT * FROM orders 
    WHERE order_date >= '2023-01-01'    -- è¿™ä¸ªæ¡ä»¶åº”è¯¥ä¸‹æ¨
) o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.status = 'completed';           -- è¿™ä¸ªæ¡ä»¶ä¹Ÿåº”è¯¥ä¸‹æ¨

-- âœ… æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–
SELECT o.*, c.customer_name  
FROM (
    SELECT * FROM orders 
    WHERE order_date >= '2023-01-01'    -- æ¡ä»¶ä¸‹æ¨åˆ°å­æŸ¥è¯¢
      AND status = 'completed'           -- æ—©æœŸè¿‡æ»¤
) o
JOIN customers c ON o.customer_id = c.customer_id;

-- æ›´å¥½çš„å†™æ³•ï¼šç›´æ¥ç®€åŒ–
SELECT o.*, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id  
WHERE o.order_date >= '2023-01-01'
  AND o.status = 'completed';
```

---

## 8. ğŸ’° æˆæœ¬æ¨¡å‹æ¡ä»¶è¯„ä¼°


### 8.1 æ•°æ®åº“æˆæœ¬æ¨¡å‹åŸºç¡€


> **ğŸ’¡ é€šä¿—ç†è§£**ï¼šæ•°æ®åº“çš„æˆæœ¬æ¨¡å‹å°±åƒGPSå¯¼èˆªï¼Œä¼šè®¡ç®—åˆ°è¾¾ç›®çš„åœ°çš„å¤šæ¡è·¯çº¿ï¼Œç„¶åé€‰æ‹©æ—¶é—´æœ€çŸ­ã€æˆæœ¬æœ€ä½çš„è·¯çº¿ã€‚

**ğŸ”¸ æˆæœ¬æ¨¡å‹çš„ç»„æˆè¦ç´ **
```
æ•°æ®åº“æˆæœ¬è®¡ç®—å…¬å¼ï¼š
æ€»æˆæœ¬ = IOæˆæœ¬ + CPUæˆæœ¬ + ç½‘ç»œæˆæœ¬

IOæˆæœ¬ï¼ˆæœ€é‡è¦ï¼‰ï¼š
â”Œâ”€ ç£ç›˜è¯»å–æˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ éšæœºè¯»å–ï¼šæ¯é¡µæˆæœ¬é«˜          â”‚
â”‚ â€¢ é¡ºåºè¯»å–ï¼šæ¯é¡µæˆæœ¬ä½          â”‚
â”‚ â€¢ ç¼“å­˜å‘½ä¸­ï¼šæˆæœ¬å‡ ä¹ä¸º0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CPUæˆæœ¬ï¼š
â”Œâ”€ æ•°æ®å¤„ç†æˆæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ¡ä»¶æ¯”è¾ƒï¼šæ¯è¡Œæ¯”è¾ƒæˆæœ¬        â”‚
â”‚ â€¢ å‡½æ•°è®¡ç®—ï¼šæ¯æ¬¡è°ƒç”¨æˆæœ¬        â”‚
â”‚ â€¢ æ’åºæ“ä½œï¼šO(n log n)æˆæœ¬      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ¡ä»¶é€‰æ‹©æ€§ä¸æˆæœ¬å…³ç³»


**ğŸ“Š é€‰æ‹©æ€§æˆæœ¬åˆ†ææ¨¡å‹**
```sql
-- æˆæœ¬è¯„ä¼°æŸ¥è¯¢ç¤ºä¾‹
-- å‡è®¾è¡¨æœ‰100ä¸‡è¡Œæ•°æ®

-- æ¡ä»¶1ï¼šcustomer_id = 12345 (é€‰æ‹©æ€§æé«˜ï¼Œé¢„è®¡1è¡Œ)
-- æˆæœ¬è®¡ç®—ï¼š
-- IOæˆæœ¬ï¼šç´¢å¼•æŸ¥æ‰¾(3æ¬¡IO) + æ•°æ®é¡µè¯»å–(1æ¬¡IO) = 4æ¬¡IO
-- CPUæˆæœ¬ï¼š1è¡Œæ•°æ®å¤„ç†
-- æ€»æˆæœ¬ï¼šä½

-- æ¡ä»¶2ï¼šstatus = 'active' (é€‰æ‹©æ€§ä½ï¼Œé¢„è®¡50ä¸‡è¡Œ)  
-- æˆæœ¬è®¡ç®—ï¼š
-- IOæˆæœ¬ï¼šç´¢å¼•èŒƒå›´æ‰«æ(1000æ¬¡IO) + æ•°æ®é¡µè¯»å–(10000æ¬¡IO) 
-- CPUæˆæœ¬ï¼š50ä¸‡è¡Œæ•°æ®å¤„ç†
-- æ€»æˆæœ¬ï¼šé«˜

-- ç»„åˆæ¡ä»¶æˆæœ¬åˆ†æ
SELECT * FROM orders 
WHERE customer_id = 12345        -- æˆæœ¬ï¼š4ä¸ªIOå•ä½
  AND status = 'active'          -- æˆæœ¬ï¼šåœ¨customer_idç»“æœåŸºç¡€ä¸Šè¿‡æ»¤
  AND order_date >= '2023-01-01'; -- æˆæœ¬ï¼šåœ¨å‰é¢ç»“æœåŸºç¡€ä¸Šè¿‡æ»¤

-- ä¼˜åŒ–å™¨ä¼šè®¡ç®—ï¼š
-- æ–¹æ¡ˆ1ï¼šcustomer_id â†’ status â†’ order_date (æ€»æˆæœ¬æœ€ä½)
-- æ–¹æ¡ˆ2ï¼šstatus â†’ customer_id â†’ order_date (æ€»æˆæœ¬è¾ƒé«˜)
-- é€‰æ‹©æ–¹æ¡ˆ1æ‰§è¡Œ
```

### 8.3 ä½¿ç”¨EXPLAINåˆ†ææˆæœ¬


**ğŸ” æˆæœ¬åˆ†æå®æˆ˜**
```sql
-- å¼€å¯ä¼˜åŒ–å™¨è¿½è¸ªï¼ˆMySQL 5.6+ï¼‰
SET optimizer_trace = "enabled=on";

-- æ‰§è¡ŒæŸ¥è¯¢
SELECT * FROM orders 
WHERE customer_id = 12345 
  AND status = 'pending'
  AND order_date >= '2023-01-01';

-- æŸ¥çœ‹æˆæœ¬åˆ†æè¯¦æƒ…
SELECT trace FROM information_schema.optimizer_trace\G

-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ä¸­çš„æˆæœ¬ä¼°ç®—
EXPLAIN FORMAT=JSON 
SELECT * FROM orders 
WHERE customer_id = 12345 
  AND status = 'pending'  
  AND order_date >= '2023-01-01'\G
```

**ğŸ“ˆ æˆæœ¬åˆ†æç»“æœè§£è¯»**
```json
{
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "100.25",        // æ€»æŸ¥è¯¢æˆæœ¬
      "read_cost": "95.50",          // IOè¯»å–æˆæœ¬
      "eval_cost": "4.75",           // CPUè®¡ç®—æˆæœ¬  
      "prefix_cost": "100.25",       // ç´¯è®¡æˆæœ¬
      "data_read_per_join": "2K"     // æ¯æ¬¡è¿æ¥è¯»å–çš„æ•°æ®é‡
    },
    "table": {
      "table_name": "orders",
      "possible_keys": ["idx_customer", "idx_status", "idx_date"],
      "key": "idx_customer",         // é€‰æ‹©çš„ç´¢å¼•
      "key_length": "4",
      "ref": ["const"],
      "rows_examined_per_scan": 5,   // é¢„è®¡æ‰«æè¡Œæ•°
      "filtered": 25.00,             // è¿‡æ»¤ç™¾åˆ†æ¯”
      "cost_info": {
        "read_cost": "5.00",         // ç´¢å¼•è¯»å–æˆæœ¬
        "eval_cost": "1.00",         // æ¡ä»¶è¯„ä¼°æˆæœ¬
        "prefix_cost": "6.00",
        "data_read_per_join": "160"
      }
    }
  }
}
```

### 8.4 æˆæœ¬æ¨¡å‹ä¼˜åŒ–ç­–ç•¥


**âš¡ åŸºäºæˆæœ¬çš„ä¼˜åŒ–å†³ç­–**
```sql
-- åœºæ™¯ï¼šå¤šä¸ªå¯ç”¨ç´¢å¼•ï¼Œä¼˜åŒ–å™¨éœ€è¦é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ

-- å¯é€‰ç´¢å¼•ï¼š
-- idx_customer (customer_id)
-- idx_status (status)  
-- idx_date (order_date)
-- idx_composite (customer_id, status, order_date)

-- æˆæœ¬æ¯”è¾ƒåˆ†æ
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨idx_customer
SELECT * FROM orders WHERE customer_id = 12345 AND status = 'pending';
-- é¢„è®¡æˆæœ¬ï¼šidx_customeræŸ¥æ‰¾(æˆæœ¬4) + statusè¿‡æ»¤(æˆæœ¬2) = 6

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨idx_status  
-- é¢„è®¡æˆæœ¬ï¼šidx_statusæŸ¥æ‰¾(æˆæœ¬50) + customer_idè¿‡æ»¤(æˆæœ¬5) = 55

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨idx_composite
-- é¢„è®¡æˆæœ¬ï¼šå¤åˆç´¢å¼•ç›´æ¥æŸ¥æ‰¾(æˆæœ¬3) = 3 â† æœ€ä¼˜é€‰æ‹©

-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•è¿›è¡Œæµ‹è¯•
SELECT * FROM orders USE INDEX(idx_customer)
WHERE customer_id = 12345 AND status = 'pending';

SELECT * FROM orders USE INDEX(idx_composite)  
WHERE customer_id = 12345 AND status = 'pending';
```

### 8.5 è‡ªå®šä¹‰æˆæœ¬å‚æ•°è°ƒä¼˜


**ğŸ”§ æˆæœ¬å‚æ•°é…ç½®**
```sql
-- MySQL 8.0æˆæœ¬å¸¸é‡é…ç½®
SELECT * FROM mysql.server_cost;
SELECT * FROM mysql.engine_cost;

-- å…³é”®æˆæœ¬å‚æ•°ï¼š
-- disk_temptable_create_cost: åˆ›å»ºç£ç›˜ä¸´æ—¶è¡¨æˆæœ¬
-- disk_temptable_row_cost: ç£ç›˜ä¸´æ—¶è¡¨è¡Œå¤„ç†æˆæœ¬
-- key_compare_cost: é”®æ¯”è¾ƒæˆæœ¬  
-- memory_temptable_create_cost: å†…å­˜ä¸´æ—¶è¡¨åˆ›å»ºæˆæœ¬
-- memory_temptable_row_cost: å†…å­˜ä¸´æ—¶è¡¨è¡Œå¤„ç†æˆæœ¬
-- row_evaluate_cost: è¡Œè¯„ä¼°æˆæœ¬

-- è°ƒæ•´æˆæœ¬å‚æ•°ï¼ˆéœ€è¦è°¨æ…ï¼‰
-- å¦‚æœä½ çš„ç³»ç»ŸIOå¾ˆå¿«ï¼Œå¯ä»¥é™ä½IOç›¸å…³æˆæœ¬
UPDATE mysql.engine_cost 
SET cost_value = 0.5 
WHERE cost_name = 'io_block_read_cost';

FLUSH OPTIMIZER_COSTS;  -- é‡æ–°åŠ è½½æˆæœ¬å‚æ•°
```

---

## 9. ğŸ”„ åŠ¨æ€æ¡ä»¶ä¼˜åŒ–


### 9.1 åŠ¨æ€æ¡ä»¶çš„æŒ‘æˆ˜


> **ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼šåŠ¨æ€æ¡ä»¶å°±åƒå˜åŒ–çš„å¤©æ°”ï¼Œä»Šå¤©æ™´å¤©æ˜å¤©é›¨å¤©ï¼Œæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸åŒçš„"é›¨ä¼"ï¼ˆæŸ¥è¯¢ç­–ç•¥ï¼‰æ¥åº”å¯¹ä¸åŒçš„"å¤©æ°”"ï¼ˆæŸ¥è¯¢æ¡ä»¶ï¼‰ã€‚

**ğŸ”¸ åŠ¨æ€æ¡ä»¶çš„å¸¸è§åœºæ™¯**
```
Webåº”ç”¨ä¸­çš„åŠ¨æ€æŸ¥è¯¢ï¼š
â”Œâ”€ æœç´¢é¡µé¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å¯èƒ½è¾“å…¥çš„æ¡ä»¶ï¼š            â”‚
â”‚ â€¢ å•†å“åç§°ï¼šå¯æœ‰å¯æ—             â”‚
â”‚ â€¢ ä»·æ ¼èŒƒå›´ï¼šå¯èƒ½ä¸ºç©º            â”‚
â”‚ â€¢ åˆ†ç±»ç­›é€‰ï¼šå¯èƒ½å¤šé€‰            â”‚
â”‚ â€¢ å“ç‰Œç­›é€‰ï¼šå¯èƒ½ä¸é€‰            â”‚
â”‚ â€¢ æ’åºæ–¹å¼ï¼šåŠ¨æ€å˜åŒ–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‘æˆ˜ï¼š
â€¢ ä¸åŒæ¡ä»¶ç»„åˆæ€§èƒ½å·®å¼‚å·¨å¤§
â€¢ æ— æ³•ä¸ºæ‰€æœ‰ç»„åˆéƒ½åˆ›å»ºæœ€ä¼˜ç´¢å¼•
â€¢ æŸ¥è¯¢è®¡åˆ’ç¼“å­˜å¯èƒ½å¤±æ•ˆ
â€¢ å‚æ•°åŒ–æŸ¥è¯¢çš„é™åˆ¶
```

### 9.2 ä¼ ç»ŸåŠ¨æ€æŸ¥è¯¢é—®é¢˜


**âŒ å¸¸è§çš„é”™è¯¯åšæ³•**
```sql
-- é”™è¯¯åšæ³•1ï¼šå­—ç¬¦ä¸²æ‹¼æ¥SQLï¼ˆSQLæ³¨å…¥é£é™©ï¼‰
String sql = "SELECT * FROM products WHERE 1=1";
if (productName != null) {
    sql += " AND product_name LIKE '%" + productName + "%'";  // å±é™©ï¼
}
if (categoryId != null) {
    sql += " AND category_id = " + categoryId;
}

-- é”™è¯¯åšæ³•2ï¼šORæ¡ä»¶å¤„ç†ç©ºå€¼ï¼ˆæ€§èƒ½å·®ï¼‰
SELECT * FROM products 
WHERE (@product_name IS NULL OR product_name LIKE CONCAT('%', @product_name, '%'))
  AND (@category_id IS NULL OR category_id = @category_id)
  AND (@min_price IS NULL OR price >= @min_price);
-- é—®é¢˜ï¼šå³ä½¿@product_nameä¸ä¸ºç©ºï¼Œä»ç„¶ä¼šè¯„ä¼°IS NULLæ¡ä»¶

-- é”™è¯¯åšæ³•3ï¼šCASE WHENçš„å¤æ‚æ¡ä»¶ï¼ˆé€»è¾‘æ··ä¹±ï¼‰
SELECT * FROM products 
WHERE 
CASE 
    WHEN @search_type = 'name' THEN product_name LIKE CONCAT('%', @search_value, '%')
    WHEN @search_type = 'brand' THEN brand_name = @search_value
    WHEN @search_type = 'category' THEN category_id = @search_value
    ELSE 1=1
END;
```

### 9.3 åŠ¨æ€æ¡ä»¶ä¼˜åŒ–æ–¹æ¡ˆ


**âœ… æ–¹æ¡ˆ1ï¼šå¤šæŸ¥è¯¢æ¨¡æ¿ç­–ç•¥**
```sql
-- ä¸ºä¸åŒçš„æ¡ä»¶ç»„åˆå‡†å¤‡ä¸“é—¨çš„æŸ¥è¯¢æ¨¡æ¿
DELIMITER $$
CREATE PROCEDURE SearchProducts(
    IN p_product_name VARCHAR(100),
    IN p_category_id INT,
    IN p_min_price DECIMAL(10,2),
    IN p_max_price DECIMAL(10,2)
)
BEGIN
    -- æ ¹æ®å‚æ•°ç»„åˆé€‰æ‹©æœ€ä¼˜æŸ¥è¯¢ç­–ç•¥
    IF p_product_name IS NOT NULL AND p_category_id IS NOT NULL THEN
        -- æ¨¡æ¿1ï¼šåç§°+åˆ†ç±»æŸ¥è¯¢ï¼ˆä½¿ç”¨å¤åˆç´¢å¼•ï¼‰
        SELECT * FROM products 
        WHERE category_id = p_category_id
          AND product_name LIKE CONCAT('%', p_product_name, '%')
          AND price BETWEEN COALESCE(p_min_price, 0) AND COALESCE(p_max_price, 999999);
          
    ELSEIF p_product_name IS NOT NULL THEN
        -- æ¨¡æ¿2ï¼šä»…åç§°æŸ¥è¯¢ï¼ˆä½¿ç”¨å…¨æ–‡ç´¢å¼•ï¼‰
        SELECT * FROM products 
        WHERE MATCH(product_name) AGAINST(p_product_name IN NATURAL LANGUAGE MODE)
          AND price BETWEEN COALESCE(p_min_price, 0) AND COALESCE(p_max_price, 999999);
          
    ELSEIF p_category_id IS NOT NULL THEN
        -- æ¨¡æ¿3ï¼šä»…åˆ†ç±»æŸ¥è¯¢ï¼ˆä½¿ç”¨åˆ†ç±»ç´¢å¼•ï¼‰
        SELECT * FROM products 
        WHERE category_id = p_category_id
          AND price BETWEEN COALESCE(p_min_price, 0) AND COALESCE(p_max_price, 999999);
          
    ELSE
        -- æ¨¡æ¿4ï¼šä»…ä»·æ ¼èŒƒå›´æŸ¥è¯¢
        SELECT * FROM products 
        WHERE price BETWEEN COALESCE(p_min_price, 0) AND COALESCE(p_max_price, 999999)
        ORDER BY price;
    END IF;
END$$
DELIMITER ;
```

**âœ… æ–¹æ¡ˆ2ï¼šåŠ¨æ€SQLæ„å»ºï¼ˆå®‰å…¨ç‰ˆæœ¬ï¼‰**
```java
// Javaä¸­çš„åŠ¨æ€æŸ¥è¯¢æ„å»º
public List<Product> searchProducts(SearchCriteria criteria) {
    StringBuilder sql = new StringBuilder("SELECT * FROM products WHERE 1=1");
    List<Object> params = new ArrayList<>();
    
    // åªæ·»åŠ éç©ºæ¡ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„ORåˆ¤æ–­
    if (criteria.getProductName() != null) {
        sql.append(" AND product_name LIKE ?");
        params.add("%" + criteria.getProductName() + "%");
    }
    
    if (criteria.getCategoryId() != null) {
        sql.append(" AND category_id = ?");
        params.add(criteria.getCategoryId());
    }
    
    if (criteria.getMinPrice() != null) {
        sql.append(" AND price >= ?");
        params.add(criteria.getMinPrice());
    }
    
    if (criteria.getMaxPrice() != null) {
        sql.append(" AND price <= ?");  
        params.add(criteria.getMaxPrice());
    }
    
    // æ ¹æ®ä¸»è¦æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–æ’åº
    if (criteria.getCategoryId() != null) {
        sql.append(" ORDER BY price ASC");  // åˆ†ç±»å†…æŒ‰ä»·æ ¼æ’åº
    } else {
        sql.append(" ORDER BY popularity DESC");  // å…¨å±€æŒ‰çƒ­åº¦æ’åº
    }
    
    return jdbcTemplate.query(sql.toString(), params.toArray(), productMapper);
}
```

### 9.4 ç´¢å¼•ç­–ç•¥é…åˆåŠ¨æ€æŸ¥è¯¢


**ğŸ“ˆ å¤šç´¢å¼•ç­–ç•¥è®¾è®¡**
```sql
-- ä¸ºåŠ¨æ€æŸ¥è¯¢è®¾è®¡çš„ç´¢å¼•ä½“ç³»
-- åŸºç¡€å•åˆ—ç´¢å¼•
CREATE INDEX idx_category ON products (category_id);
CREATE INDEX idx_price ON products (price);
CREATE INDEX idx_brand ON products (brand_id);

-- å¸¸ç”¨ç»„åˆçš„å¤åˆç´¢å¼•
CREATE INDEX idx_category_price ON products (category_id, price);
CREATE INDEX idx_brand_category ON products (brand_id, category_id);
CREATE INDEX idx_price_category ON products (price, category_id);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE FULLTEXT INDEX idx_product_name ON products (product_name);

-- è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«å¸¸ç”¨æŸ¥è¯¢å­—æ®µï¼‰
CREATE INDEX idx_covering ON products (category_id, price, product_name, product_id);

-- ä½¿ç”¨EXPLAINåˆ†æä¸åŒæŸ¥è¯¢çš„ç´¢å¼•é€‰æ‹©
EXPLAIN SELECT * FROM products WHERE category_id = 1;
EXPLAIN SELECT * FROM products WHERE category_id = 1 AND price > 100;
EXPLAIN SELECT * FROM products WHERE product_name LIKE '%laptop%';
```

### 9.5 æŸ¥è¯¢è®¡åˆ’ç¼“å­˜ä¼˜åŒ–


**ğŸš€ æŸ¥è¯¢è®¡åˆ’å¤ç”¨ç­–ç•¥**
```sql
-- MySQL 8.0çš„æŸ¥è¯¢è®¡åˆ’ç¼“å­˜
-- æŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’ç¼“å­˜çŠ¶æ€
SELECT * FROM performance_schema.prepared_statements_instances;

-- ä½¿ç”¨é¢„å¤„ç†è¯­å¥æé«˜ç¼“å­˜å‘½ä¸­ç‡
-- âœ… æ¨èï¼šå‚æ•°åŒ–æŸ¥è¯¢
PREPARE search_stmt FROM 
'SELECT * FROM products 
 WHERE (@category_id IS NULL OR category_id = @category_id)
   AND (@min_price IS NULL OR price >= @min_price)';

SET @category_id = 1;
SET @min_price = 100;
EXECUTE search_stmt;

-- ç›‘æ§æŸ¥è¯¢è®¡åˆ’ç¼“å­˜æ•ˆæœ
SELECT 
    sql_text,
    count_execute,
    count_reprepare,
    first_seen,
    last_seen
FROM performance_schema.prepared_statements_instances
WHERE sql_text LIKE '%products%'
ORDER BY count_execute DESC;
```

### 9.6 åº”ç”¨å±‚åŠ¨æ€ä¼˜åŒ–


**ğŸ’» åº”ç”¨å±‚ä¼˜åŒ–ç­–ç•¥**
```python
class ProductSearchOptimizer:
    """
    äº§å“æœç´¢æŸ¥è¯¢ä¼˜åŒ–å™¨
    æ ¹æ®æŸ¥è¯¢æ¡ä»¶ç‰¹å¾é€‰æ‹©æœ€ä¼˜æŸ¥è¯¢ç­–ç•¥
    """
    
    def search_products(self, criteria):
        # åˆ†ææŸ¥è¯¢æ¡ä»¶çš„é€‰æ‹©æ€§
        selectivity_score = self._calculate_selectivity(criteria)
        
        if selectivity_score > 0.8:
            # é«˜é€‰æ‹©æ€§æŸ¥è¯¢ï¼šä½¿ç”¨ç²¾ç¡®æŸ¥è¯¢
            return self._exact_search(criteria)
        elif selectivity_score > 0.3:
            # ä¸­é€‰æ‹©æ€§æŸ¥è¯¢ï¼šä½¿ç”¨ä¼˜åŒ–æŸ¥è¯¢
            return self._optimized_search(criteria)
        else:
            # ä½é€‰æ‹©æ€§æŸ¥è¯¢ï¼šä½¿ç”¨ç¼“å­˜æˆ–åˆ†é¡µ
            return self._cached_search(criteria)
    
    def _calculate_selectivity(self, criteria):
        """è®¡ç®—æŸ¥è¯¢æ¡ä»¶çš„é€‰æ‹©æ€§"""
        selectivity = 0
        
        # é«˜é€‰æ‹©æ€§æ¡ä»¶åŠ åˆ†
        if criteria.get('product_id'):
            selectivity += 1.0  # ä¸»é”®æŸ¥è¯¢
        if criteria.get('sku_code'):
            selectivity += 0.9  # å”¯ä¸€ç¼–ç 
            
        # ä¸­é€‰æ‹©æ€§æ¡ä»¶
        if criteria.get('brand_id'):
            selectivity += 0.4
        if criteria.get('category_id'):
            selectivity += 0.3
            
        # ä½é€‰æ‹©æ€§æ¡ä»¶å‡åˆ†
        if criteria.get('status') == 'active':
            selectivity -= 0.1  # å¤§å¤šæ•°å•†å“éƒ½æ˜¯active
            
        return min(selectivity, 1.0)
    
    def _exact_search(self, criteria):
        """é«˜é€‰æ‹©æ€§ç²¾ç¡®æŸ¥è¯¢"""
        # ä½¿ç”¨æœ€ä¼˜ç´¢å¼•çš„ç²¾ç¡®æŸ¥è¯¢
        pass
    
    def _optimized_search(self, criteria):
        """ä¸­é€‰æ‹©æ€§ä¼˜åŒ–æŸ¥è¯¢"""
        # ä½¿ç”¨å¤åˆç´¢å¼•å’Œæ¡ä»¶é‡æ’
        pass
        
    def _cached_search(self, criteria):
        """ä½é€‰æ‹©æ€§ç¼“å­˜æŸ¥è¯¢"""
        # ä½¿ç”¨ç¼“å­˜æˆ–åˆ†é¡µç­–ç•¥
        pass
```

---

## 10. ğŸ¯ å¤æ‚æ¡ä»¶æŸ¥è¯¢æ¡ˆä¾‹åˆ†æ


### 10.1 ç”µå•†å¤šç»´åº¦æœç´¢ä¼˜åŒ–æ¡ˆä¾‹


**ğŸ“Š ä¸šåŠ¡èƒŒæ™¯**
```
ç”µå•†æœç´¢åœºæ™¯ï¼š
æ•°æ®é‡ï¼šå•†å“è¡¨500ä¸‡æ¡è®°å½•
ç”¨æˆ·éœ€æ±‚ï¼šæ”¯æŒä»¥ä¸‹ç»„åˆæœç´¢
â€¢ å•†å“åç§°ï¼šæ¨¡ç³ŠåŒ¹é…
â€¢ å•†å“åˆ†ç±»ï¼šç²¾ç¡®åŒ¹é…
â€¢ ä»·æ ¼èŒƒå›´ï¼šåŒºé—´æŸ¥è¯¢
â€¢ å“ç‰Œç­›é€‰ï¼šå¤šé€‰
â€¢ åº“å­˜çŠ¶æ€ï¼šæœ‰åº“å­˜/é¢„å”®/ç¼ºè´§
â€¢ ä¸Šæ¶æ—¶é—´ï¼šæœ€è¿‘ä¸Šæ¶ä¼˜å…ˆ
```

**âŒ åŸå§‹ä½æ•ˆæŸ¥è¯¢**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆå“åº”æ—¶é—´ï¼š8-15ç§’ï¼‰
SELECT 
    product_id,
    product_name,
    category_name,
    brand_name,
    price,
    stock_quantity
FROM products p
JOIN categories c ON p.category_id = c.category_id
JOIN brands b ON p.brand_id = b.brand_id
WHERE 
    (p.product_name LIKE '%æ‰‹æœº%' OR p.description LIKE '%æ‰‹æœº%')    -- å…¨æ–‡æœç´¢
    AND p.category_id IN (1, 2, 3, 4, 5)                         -- å¤šåˆ†ç±»
    AND p.price BETWEEN 1000 AND 5000                            -- ä»·æ ¼èŒƒå›´
    AND p.brand_id IN (10, 20, 30, 40, 50, 60)                   -- å¤šå“ç‰Œ
    AND p.stock_quantity > 0                                      -- æœ‰åº“å­˜
    AND p.status = 'active'                                       -- ä¸Šæ¶çŠ¶æ€
    AND p.created_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)       -- æ–°å“ä¼˜å…ˆ
ORDER BY p.created_date DESC, p.sales_count DESC
LIMIT 20 OFFSET 0;

-- æ€§èƒ½é—®é¢˜åˆ†æï¼š
-- 1. LIKE '%keyword%' æ— æ³•ä½¿ç”¨ç´¢å¼•
-- 2. å¤šä¸ªINæ¡ä»¶å¯¼è‡´ç¬›å¡å°”ç§¯
-- 3. JOINæ“ä½œå¢åŠ æŸ¥è¯¢å¤æ‚åº¦
-- 4. å¤æ‚ORDER BYæ’åºå¼€é”€å¤§
```

**âœ… ä¼˜åŒ–åçš„æŸ¥è¯¢æ–¹æ¡ˆ**
```sql
-- Step 1: å»ºç«‹ä¼˜åŒ–ç´¢å¼•
CREATE INDEX idx_search_main ON products (status, category_id, brand_id, price, stock_quantity);
CREATE INDEX idx_created_sales ON products (created_date DESC, sales_count DESC);
CREATE FULLTEXT INDEX idx_fulltext ON products (product_name, description);

-- Step 2: ä¼˜åŒ–æŸ¥è¯¢ï¼ˆå“åº”æ—¶é—´ï¼š0.1-0.5ç§’ï¼‰
SELECT 
    p.product_id,
    p.product_name,
    p.category_id,
    p.brand_id,
    p.price,
    p.stock_quantity,
    p.sales_count
FROM products p
WHERE 
    p.status = 'active'                                    -- æœ€é«˜é€‰æ‹©æ€§æ¡ä»¶ä¼˜å…ˆ
    AND p.category_id IN (1, 2, 3, 4, 5)                 -- åˆ©ç”¨å¤åˆç´¢å¼•
    AND p.brand_id IN (10, 20, 30, 40, 50, 60)          -- ç»§ç»­åˆ©ç”¨ç´¢å¼•
    AND p.price BETWEEN 1000 AND 5000                    -- èŒƒå›´æ¡ä»¶
    AND p.stock_quantity > 0                              -- åº“å­˜è¿‡æ»¤
    AND p.created_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    AND MATCH(p.product_name, p.description) AGAINST('æ‰‹æœº' IN NATURAL LANGUAGE MODE)
ORDER BY p.created_date DESC, p.sales_count DESC
LIMIT 20;

-- Step 3: ç»“æœå…³è”ä¼˜åŒ–ï¼ˆä½¿ç”¨åº”ç”¨å±‚JOINï¼‰
-- åœ¨åº”ç”¨å±‚è¿›è¡Œcategory_nameå’Œbrand_nameçš„å…³è”ï¼Œå‡å°‘æŸ¥è¯¢æ—¶çš„JOINå¼€é”€
```

### 10.2 è®¢å•æŠ¥è¡¨å¤æ‚ç»Ÿè®¡ä¼˜åŒ–


**ğŸ“ˆ ä¸šåŠ¡åœºæ™¯ï¼šè®¢å•ç»Ÿè®¡æŠ¥è¡¨**
```sql
-- éœ€æ±‚ï¼šç”Ÿæˆé”€å”®æŠ¥è¡¨
-- ç»Ÿè®¡ç»´åº¦ï¼šæŒ‰æœˆä»½ã€åœ°åŒºã€å•†å“åˆ†ç±»ã€é”€å”®å‘˜ç»Ÿè®¡è®¢å•
-- è¿‡æ»¤æ¡ä»¶ï¼šæ—¶é—´èŒƒå›´ã€è®¢å•çŠ¶æ€ã€å®¢æˆ·ç±»å‹

-- âŒ åŸå§‹å¤æ‚æŸ¥è¯¢ï¼ˆè¶…æ—¶ï¼‰
SELECT 
    DATE_FORMAT(o.order_date, '%Y-%m') as month,
    r.region_name,
    c.category_name,
    u.user_name as sales_person,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as total_sales,
    AVG(o.total_amount) as avg_order_value,
    COUNT(DISTINCT o.customer_id) as unique_customers
FROM orders o
JOIN customers cust ON o.customer_id = cust.customer_id
JOIN regions r ON cust.region_id = r.region_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
JOIN categories c ON p.category_id = c.category_id
JOIN users u ON o.sales_person_id = u.user_id
WHERE 
    o.order_date BETWEEN '2023-01-01' AND '2023-12-31'
    AND o.status IN ('completed', 'shipped', 'delivered')
    AND cust.customer_type IN ('enterprise', 'vip')
    AND o.total_amount > 0
GROUP BY 
    DATE_FORMAT(o.order_date, '%Y-%m'),
    r.region_name,
    c.category_name,
    u.user_name
HAVING 
    COUNT(o.order_id) >= 5
ORDER BY 
    month DESC, 
    total_sales DESC;

-- âœ… åˆ†æ­¥ä¼˜åŒ–æ–¹æ¡ˆ
-- Step 1: é¢„èšåˆåŸºç¡€æ•°æ®ï¼ˆåˆ›å»ºæ±‡æ€»è¡¨ï¼‰
CREATE TABLE order_summary_daily (
    summary_date DATE,
    region_id INT,
    category_id INT,
    sales_person_id INT,
    customer_type VARCHAR(20),
    order_count INT,
    total_amount DECIMAL(15,2),
    unique_customers INT,
    PRIMARY KEY (summary_date, region_id, category_id, sales_person_id, customer_type),
    INDEX idx_date_region (summary_date, region_id)
);

-- Step 2: å®šæ—¶æ±‡æ€»ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
INSERT INTO order_summary_daily 
SELECT 
    DATE(o.order_date) as summary_date,
    cust.region_id,
    p.category_id,
    o.sales_person_id,
    cust.customer_type,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as total_amount,
    COUNT(DISTINCT o.customer_id) as unique_customers
FROM orders o
JOIN customers cust ON o.customer_id = cust.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE DATE(o.order_date) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
  AND o.status IN ('completed', 'shipped', 'delivered')
GROUP BY 
    DATE(o.order_date),
    cust.region_id,
    p.category_id,
    o.sales_person_id,
    cust.customer_type;

-- Step 3: å¿«é€ŸæŠ¥è¡¨æŸ¥è¯¢ï¼ˆ0.1ç§’å“åº”ï¼‰
SELECT 
    DATE_FORMAT(os.summary_date, '%Y-%m') as month,
    r.region_name,
    c.category_name,
    u.user_name as sales_person,
    SUM(os.order_count) as order_count,
    SUM(os.total_amount) as total_sales,
    SUM(os.total_amount) / SUM(os.order_count) as avg_order_value,
    SUM(os.unique_customers) as unique_customers
FROM order_summary_daily os
JOIN regions r ON os.region_id = r.region_id
JOIN categories c ON os.category_id = c.category_id  
JOIN users u ON os.sales_person_id = u.user_id
WHERE 
    os.summary_date BETWEEN '2023-01-01' AND '2023-12-31'
    AND os.customer_type IN ('enterprise', 'vip')
GROUP BY 
    DATE_FORMAT(os.summary_date, '%Y-%m'),
    r.region_name,
    c.category_name,
    u.user_name
HAVING 
    SUM(os.order_count) >= 5
ORDER BY 
    month DESC, 
    total_sales DESC;
```

### 10.3 ç”¨æˆ·è¡Œä¸ºåˆ†æå¤æ‚æŸ¥è¯¢ä¼˜åŒ–


**ğŸ‘¤ ç”¨æˆ·æ´»è·ƒåº¦åˆ†æåœºæ™¯**
```sql
-- éœ€æ±‚ï¼šåˆ†æç”¨æˆ·æ´»è·ƒåº¦å’Œè´­ä¹°è¡Œä¸º
-- å¤æ‚æ¡ä»¶ï¼šå¤šæ—¶é—´æ®µå¯¹æ¯”ã€ç”¨æˆ·åˆ†å±‚ã€è¡Œä¸ºè·¯å¾„åˆ†æ

-- âŒ åŸå§‹å¤æ‚æŸ¥è¯¢
WITH user_activity AS (
    SELECT 
        user_id,
        COUNT(CASE WHEN action_date >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) as recent_actions,
        COUNT(CASE WHEN action_date >= DATE_SUB(NOW(), INTERVAL 90 DAY) THEN 1 END) as quarterly_actions,
        MAX(CASE WHEN action_type = 'purchase' THEN action_date END) as last_purchase_date,
        SUM(CASE WHEN action_type = 'purchase' AND action_date >= DATE_SUB(NOW(), INTERVAL 30 DAY) 
                THEN amount ELSE 0 END) as recent_purchase_amount
    FROM user_actions ua
    WHERE action_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)
    GROUP BY user_id
),
user_segments AS (
    SELECT 
        u.user_id,
        u.user_name,
        u.registration_date,
        ua.recent_actions,
        ua.quarterly_actions,
        ua.last_purchase_date,
        ua.recent_purchase_amount,
        CASE 
            WHEN ua.recent_actions >= 10 AND ua.recent_purchase_amount > 1000 THEN 'High Value Active'
            WHEN ua.recent_actions >= 5 AND ua.recent_purchase_amount > 500 THEN 'Active'  
            WHEN ua.recent_actions > 0 THEN 'Low Active'
            ELSE 'Inactive'
        END as user_segment
    FROM users u
    LEFT JOIN user_activity ua ON u.user_id = ua.user_id
    WHERE u.registration_date >= DATE_SUB(NOW(), INTERVAL 180 DAY)
)
SELECT 
    user_segment,
    COUNT(*) as user_count,
    AVG(recent_actions) as avg_recent_actions,
    AVG(recent_purchase_amount) as avg_purchase_amount,
    COUNT(CASE WHEN last_purchase_date >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 END) as recent_buyers
FROM user_segments
GROUP BY user_segment
ORDER BY 
    CASE user_segment
        WHEN 'High Value Active' THEN 1
        WHEN 'Active' THEN 2
        WHEN 'Low Active' THEN 3
        WHEN 'Inactive' THEN 4
    END;

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šé¢„è®¡ç®—ç”¨æˆ·æ ‡ç­¾
-- Step 1: åˆ›å»ºç”¨æˆ·æ ‡ç­¾è¡¨
CREATE TABLE user_segment_cache (
    user_id BIGINT PRIMARY KEY,
    segment_type VARCHAR(50),
    recent_actions_30d INT,
    recent_purchase_amount_30d DECIMAL(12,2),
    last_purchase_date DATE,
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_segment (segment_type),
    INDEX idx_last_purchase (last_purchase_date)
);

-- Step 2: å®šæœŸæ›´æ–°æ ‡ç­¾ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼‰
REPLACE INTO user_segment_cache 
SELECT 
    u.user_id,
    CASE 
        WHEN ua.recent_actions >= 10 AND ua.recent_purchase_amount > 1000 THEN 'High Value Active'
        WHEN ua.recent_actions >= 5 AND ua.recent_purchase_amount > 500 THEN 'Active'
        WHEN ua.recent_actions > 0 THEN 'Low Active'
        ELSE 'Inactive'
    END as segment_type,
    ua.recent_actions,
    ua.recent_purchase_amount,
    ua.last_purchase_date,
    NOW()
FROM users u
LEFT JOIN (
    SELECT 
        user_id,
        COUNT(CASE WHEN action_date >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) as recent_actions,
        SUM(CASE WHEN action_type = 'purchase' AND action_date >= DATE_SUB(NOW(), INTERVAL 30 DAY) 
                THEN amount ELSE 0 END) as recent_purchase_amount,
        MAX(CASE WHEN action_type = 'purchase' THEN action_date END) as last_purchase_date
    FROM user_actions 
    WHERE action_date >= DATE_SUB(NOW(), INTERVAL 90 DAY)
    GROUP BY user_id
) ua ON u.user_id = ua.user_id;

-- Step 3: å¿«é€ŸæŸ¥è¯¢
SELECT 
    segment_type,
    COUNT(*) as user_count,
    AVG(recent_actions_30d) as avg_recent_actions,
    AVG(recent_purchase_amount_30d) as avg_purchase_amount,
    COUNT(CASE WHEN last_purchase_date >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 END) as recent_buyers
FROM user_segment_cache
GROUP BY segment_type
ORDER BY 
    CASE segment_type
        WHEN 'High Value Active' THEN 1
        WHEN 'Active' THEN 2  
        WHEN 'Low Active' THEN 3
        WHEN 'Inactive' THEN 4
    END;
```

---

## 11. ğŸ” æ€§èƒ½é—®é¢˜è¯Šæ–­å®ä¾‹


### 11.1 æ…¢æŸ¥è¯¢è¯Šæ–­æ–¹æ³•


**ğŸš¨ æ…¢æŸ¥è¯¢è¯†åˆ«æµç¨‹**
```sql
-- Step 1: å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 1;  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢è®°å½•
SET GLOBAL log_queries_not_using_indexes = ON;

-- Step 2: æŸ¥çœ‹å½“å‰æ…¢æŸ¥è¯¢
SHOW PROCESSLIST;
-- æ‰¾å‡ºStateåˆ—æ˜¾ç¤º "Sending data"ã€"Sorting result" ç­‰çš„é•¿æ—¶é—´æŸ¥è¯¢

-- Step 3: åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ç»Ÿè®¡
SELECT 
    schema_name,
    digest_text,
    count_star,
    avg_timer_wait/1000000000 as avg_query_time_sec,
    sum_rows_examined,
    sum_rows_sent
FROM performance_schema.events_statements_summary_by_digest 
WHERE avg_timer_wait > 1000000000  -- è¶…è¿‡1ç§’
ORDER BY avg_timer_wait DESC
LIMIT 10;
```

### 11.2 å…¸å‹æ…¢æŸ¥è¯¢æ¡ˆä¾‹è¯Šæ–­


**æ¡ˆä¾‹1ï¼šå…¨è¡¨æ‰«æé—®é¢˜**
```sql
-- é—®é¢˜æŸ¥è¯¢
SELECT * FROM orders 
WHERE YEAR(order_date) = 2023 
  AND customer_name LIKE '%å¼ %';

-- è¯Šæ–­EXPLAINç»“æœï¼š
-- +----+-------------+--------+------+--------+------+---------+-------------+
-- | id | select_type | table  | type | key    | rows | filtered| Extra       |
-- +----+-------------+--------+------+--------+------+---------+-------------+
-- |  1 | SIMPLE      | orders | ALL  | NULL   |500000|   1.00  | Using where |
-- +----+-------------+--------+------+--------+------+---------+-------------+

-- é—®é¢˜åˆ†æï¼š
-- â€¢ type = ALLï¼šå…¨è¡¨æ‰«æ
-- â€¢ key = NULLï¼šæ²¡æœ‰ä½¿ç”¨ä»»ä½•ç´¢å¼•
-- â€¢ rows = 500000ï¼šæ‰«æäº†50ä¸‡è¡Œ
-- â€¢ Extra = Using whereï¼šåœ¨å­˜å‚¨å¼•æ“å±‚æ— æ³•è¿‡æ»¤ï¼Œéœ€è¦åœ¨Serverå±‚å¤„ç†

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ
-- 1. é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°
ALTER TABLE orders ADD year_month INT;
UPDATE orders SET year_month = YEAR(order_date) * 100 + MONTH(order_date);
CREATE INDEX idx_year_month ON orders (year_month);

-- 2. ä¼˜åŒ–åçš„æŸ¥è¯¢
SELECT * FROM orders 
WHERE year_month BETWEEN 202301 AND 202312
  AND customer_name LIKE 'å¼ %';  -- æ”¹ä¸ºå‰ç¼€åŒ¹é…

-- 3. æˆ–è€…ä½¿ç”¨èŒƒå›´æŸ¥è¯¢
SELECT * FROM orders 
WHERE order_date >= '2023-01-01' 
  AND order_date < '2024-01-01'
  AND customer_name LIKE 'å¼ %';
```

**æ¡ˆä¾‹2ï¼šç´¢å¼•é€‰æ‹©é”™è¯¯**
```sql
-- é—®é¢˜æŸ¥è¯¢
SELECT customer_id, order_date, total_amount
FROM orders 
WHERE status = 'pending' 
  AND order_date >= '2023-01-01'
  AND customer_id = 12345;

-- å½“å‰ç´¢å¼•ï¼š
-- idx_status (status)
-- idx_order_date (order_date)  
-- idx_customer (customer_id)

-- EXPLAINæ˜¾ç¤ºä½¿ç”¨äº† idx_statusï¼Œä½†è¿™ä¸æ˜¯æœ€ä¼˜çš„
-- +----+-------------+--------+-------+-----------+------+---------+-------+
-- | id | select_type | table  | type  | key       | rows | filtered| ref   |
-- +----+-------------+--------+-------+-----------+------+---------+-------+
-- |  1 | SIMPLE      | orders | range | idx_status| 5000 |   10.00 | const |
-- +----+-------------+--------+-------+-----------+------+---------+-------+

-- é—®é¢˜åˆ†æï¼š
-- MySQLé€‰æ‹©äº†é€‰æ‹©æ€§è¾ƒä½çš„statusç´¢å¼•
-- å¯¼è‡´éœ€è¦æ‰«æ5000è¡Œï¼Œç„¶åå†è¿‡æ»¤å…¶ä»–æ¡ä»¶

-- âœ… è§£å†³æ–¹æ¡ˆ
-- 1. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆé«˜é€‰æ‹©æ€§å­—æ®µåœ¨å‰ï¼‰
CREATE INDEX idx_customer_status_date ON orders (customer_id, status, order_date);

-- 2. æˆ–è€…ä½¿ç”¨ç´¢å¼•æç¤ºå¼ºåˆ¶ä½¿ç”¨æœ€ä¼˜ç´¢å¼•
SELECT customer_id, order_date, total_amount
FROM orders USE INDEX (idx_customer)
WHERE status = 'pending' 
  AND order_date >= '2023-01-01'
  AND customer_id = 12345;

-- ä¼˜åŒ–åçš„EXPLAINï¼š
-- +----+-------------+--------+-------+----------------------+------+---------+-------+
-- | id | select_type | table  | type  | key                  | rows | filtered| ref   |
-- +----+-------------+--------+-------+----------------------+------+---------+-------+
-- |  1 | SIMPLE      | orders | range |idx_customer_status...|    2 |  100.00 | const |
-- +----+-------------+--------+-------+----------------------+------+---------+-------+
```

### 11.3 å¤æ‚JOINæŸ¥è¯¢è¯Šæ–­


**æ¡ˆä¾‹3ï¼šå¤šè¡¨JOINæ€§èƒ½é—®é¢˜**
```sql
-- é—®é¢˜æŸ¥è¯¢ï¼šè®¢å•è¯¦æƒ…é¡µæŸ¥è¯¢ï¼ˆè€—æ—¶5ç§’ï¼‰
SELECT 
    o.order_id,
    o.order_date,
    c.customer_name,
    c.email,
    p.product_name,
    oi.quantity,
    oi.unit_price,
    cat.category_name,
    b.brand_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
JOIN categories cat ON p.category_id = cat.category_id
JOIN brands b ON p.brand_id = b.brand_id
WHERE o.order_id = 123456;

-- è¯Šæ–­EXPLAINç»“æœæ˜¾ç¤ºJOINé¡ºåºä¸ä¼˜
-- MySQLé€‰æ‹©äº†ä»orderså¼€å§‹ï¼Œç„¶åé€ä¸ªJOINå…¶ä»–è¡¨

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ
-- 1. åˆ†æå„è¡¨çš„JOINæ¡ä»¶å’Œæ•°æ®é‡
SELECT COUNT(*) FROM orders WHERE order_id = 123456;        -- 1è¡Œ
SELECT COUNT(*) FROM order_items WHERE order_id = 123456;   -- 3è¡Œ  
SELECT COUNT(*) FROM customers;                             -- 100ä¸‡è¡Œ
SELECT COUNT(*) FROM products;                              -- 50ä¸‡è¡Œ

-- 2. é‡å†™æŸ¥è¯¢ï¼Œä¼˜åŒ–JOINé¡ºåº
SELECT 
    o.order_id,
    o.order_date,
    c.customer_name,
    c.email,
    oi.quantity,
    oi.unit_price,
    p.product_name,
    cat.category_name,
    b.brand_name
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id  -- å…ˆJOINå°è¡¨
JOIN products p ON oi.product_id = p.product_id
JOIN categories cat ON p.category_id = cat.category_id
JOIN brands b ON p.brand_id = b.brand_id
JOIN customers c ON o.customer_id = c.customer_id  -- æœ€åJOINå¤§è¡¨
WHERE o.order_id = 123456;

-- 3. æ·»åŠ å¿…è¦çš„ç´¢å¼•
CREATE INDEX idx_order_items_order_id ON order_items (order_id);
CREATE INDEX idx_products_category_brand ON products (category_id, brand_id);

-- 4. è€ƒè™‘æ‹†åˆ†æŸ¥è¯¢ï¼ˆå¦‚æœJOINä»ç„¶æ…¢ï¼‰
-- ç¬¬ä¸€æ­¥ï¼šè·å–è®¢å•åŸºæœ¬ä¿¡æ¯
SELECT order_id, order_date, customer_id FROM orders WHERE order_id = 123456;

-- ç¬¬äºŒæ­¥ï¼šè·å–è®¢å•å•†å“ä¿¡æ¯
SELECT oi.*, p.product_name, cat.category_name, b.brand_name
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
JOIN categories cat ON p.category_id = cat.category_id  
JOIN brands b ON p.brand_id = b.brand_id
WHERE oi.order_id = 123456;

-- ç¬¬ä¸‰æ­¥ï¼šè·å–å®¢æˆ·ä¿¡æ¯
SELECT customer_name, email FROM customers WHERE customer_id = ?;
```

### 11.4 å­æŸ¥è¯¢æ€§èƒ½è¯Šæ–­


**æ¡ˆä¾‹4ï¼šç›¸å…³å­æŸ¥è¯¢æ€§èƒ½é—®é¢˜**
```sql
-- é—®é¢˜æŸ¥è¯¢ï¼šæŸ¥æ‰¾æ¯ä¸ªåˆ†ç±»ä¸­ä»·æ ¼æœ€é«˜çš„å•†å“
SELECT 
    p.product_id,
    p.product_name,
    p.category_id,
    p.price
FROM products p
WHERE p.price = (
    SELECT MAX(price) 
    FROM products p2 
    WHERE p2.category_id = p.category_id  -- ç›¸å…³å­æŸ¥è¯¢
);

-- é—®é¢˜åˆ†æï¼š
-- å¯¹äºæ¯ä¸ªproductè®°å½•ï¼Œéƒ½è¦æ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢
-- å¦‚æœproductsè¡¨æœ‰50ä¸‡è¡Œï¼Œå°±è¦æ‰§è¡Œ50ä¸‡æ¬¡å­æŸ¥è¯¢

-- EXPLAINæ˜¾ç¤ºï¼š
-- +----+--------------------+-------+------+---------------+------+
-- | id | select_type        | table | type | key           | rows |
-- +----+--------------------+-------+------+---------------+------+
-- |  1 | PRIMARY            | p     | ALL  | NULL          |500000|
-- |  2 | DEPENDENT SUBQUERY | p2    | ref  | idx_category  |  100 |
-- +----+--------------------+-------+------+---------------+------+

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šä½¿ç”¨çª—å£å‡½æ•°ï¼ˆMySQL 8.0+ï¼‰
SELECT 
    product_id,
    product_name,
    category_id,
    price
FROM (
    SELECT 
        product_id,
        product_name,
        category_id,
        price,
        ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY price DESC) as rn
    FROM products
) ranked
WHERE rn = 1;

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨JOINï¼ˆMySQL 5.7åŠä»¥ä¸‹ï¼‰
SELECT 
    p.product_id,
    p.product_name,
    p.category_id,
    p.price
FROM products p
INNER JOIN (
    SELECT category_id, MAX(price) as max_price
    FROM products
    GROUP BY category_id
) p_max ON p.category_id = p_max.category_id AND p.price = p_max.max_price;

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- åŸæŸ¥è¯¢ï¼š5-10ç§’
-- ä¼˜åŒ–åï¼š0.1-0.2ç§’
```

---

## 12. âš–ï¸ ä¼˜åŒ–å‰åå¯¹æ¯”åˆ†æ


### 12.1 æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**
```sql
-- å»ºç«‹æ€§èƒ½æµ‹è¯•è¡¨
CREATE TABLE performance_test (
    test_name VARCHAR(100),
    query_type VARCHAR(50),
    execution_time_ms DECIMAL(10,3),
    rows_examined BIGINT,
    rows_returned BIGINT,
    index_used VARCHAR(100),
    memory_used_mb DECIMAL(10,2),
    test_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ€§èƒ½æµ‹è¯•è„šæœ¬
-- æµ‹è¯•1ï¼šå‡½æ•°ä¼˜åŒ–å‰åå¯¹æ¯”
-- ä¼˜åŒ–å‰
SET @start_time = MICROSECOND(NOW(6));
SELECT COUNT(*) FROM orders WHERE YEAR(order_date) = 2023;
SET @end_time = MICROSECOND(NOW(6));
INSERT INTO performance_test VALUES 
('è®¢å•å¹´ä»½æŸ¥è¯¢', 'ä¼˜åŒ–å‰-å‡½æ•°è°ƒç”¨', (@end_time - @start_time)/1000, 500000, 1, 'NULL', 0, NOW());

-- ä¼˜åŒ–å  
SET @start_time = MICROSECOND(NOW(6));
SELECT COUNT(*) FROM orders WHERE order_date >= '2023-01-01' AND order_date < '2024-01-01';
SET @end_time = MICROSECOND(NOW(6));
INSERT INTO performance_test VALUES 
('è®¢å•å¹´ä»½æŸ¥è¯¢', 'ä¼˜åŒ–å-èŒƒå›´æŸ¥è¯¢', (@end_time - @start_time)/1000, 120000, 1, 'idx_order_date', 0, NOW());
```

### 12.2 çœŸå®æ¡ˆä¾‹å¯¹æ¯”åˆ†æ


**æ¡ˆä¾‹ï¼šç”¨æˆ·è®¢å•æŸ¥è¯¢ä¼˜åŒ–å¯¹æ¯”**
```sql
-- ===== ä¼˜åŒ–å‰çš„æŸ¥è¯¢ =====
-- æŸ¥è¯¢ï¼šè·å–ç”¨æˆ·æœ€è¿‘3ä¸ªæœˆçš„è®¢å•ç»Ÿè®¡
SELECT 
    u.user_id,
    u.username,
    COUNT(o.order_id) as order_count,
    SUM(o.total_amount) as total_spent,
    AVG(o.total_amount) as avg_order_value,
    MAX(o.order_date) as last_order_date
FROM users u
LEFT JOIN orders o ON u.user_id = o.customer_id
WHERE u.registration_date >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
  AND (o.order_date IS NULL OR o.order_date >= DATE_SUB(NOW(), INTERVAL 3 MONTH))
  AND u.status = 'active'
GROUP BY u.user_id, u.username
HAVING COUNT(o.order_id) >= 1
ORDER BY total_spent DESC
LIMIT 100;

-- ä¼˜åŒ–å‰æ€§èƒ½è¡¨ç°ï¼š
-- â€¢ æ‰§è¡Œæ—¶é—´ï¼š12-18ç§’
-- â€¢ æ‰«æè¡Œæ•°ï¼š300ä¸‡è¡Œï¼ˆusersè¡¨100ä¸‡ + ordersè¡¨200ä¸‡ï¼‰  
-- â€¢ å†…å­˜ä½¿ç”¨ï¼š500MBï¼ˆå¤§é‡ä¸´æ—¶è¡¨å’Œæ’åºï¼‰
-- â€¢ ç´¢å¼•ä½¿ç”¨ï¼šéƒ¨åˆ†ç´¢å¼•ï¼Œæ•ˆæœæœ‰é™

-- ===== ä¼˜åŒ–åçš„æ–¹æ¡ˆ =====
-- Step 1: æ·»åŠ å¿…è¦çš„ç´¢å¼•
CREATE INDEX idx_users_status_reg ON users (status, registration_date);
CREATE INDEX idx_orders_customer_date ON orders (customer_id, order_date);
CREATE INDEX idx_orders_date_amount ON orders (order_date, total_amount);

-- Step 2: æŸ¥è¯¢é‡æ„
-- åˆ†æ­¥æŸ¥è¯¢ï¼Œå‡å°‘JOINå¤æ‚åº¦
WITH active_users AS (
    SELECT user_id, username
    FROM users 
    WHERE status = 'active' 
      AND registration_date >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
),
user_orders AS (
    SELECT 
        o.customer_id,
        COUNT(*) as order_count,
        SUM(o.total_amount) as total_spent,
        AVG(o.total_amount) as avg_order_value,
        MAX(o.order_date) as last_order_date
    FROM orders o
    WHERE o.order_date >= DATE_SUB(NOW(), INTERVAL 3 MONTH)
    GROUP BY o.customer_id
    HAVING COUNT(*) >= 1
)
SELECT 
    au.user_id,
    au.username,
    COALESCE(uo.order_count, 0) as order_count,
    COALESCE(uo.total_spent, 0) as total_spent,
    COALESCE(uo.avg_order_value, 0) as avg_order_value,
    uo.last_order_date
FROM active_users au
LEFT JOIN user_orders uo ON au.user_id = uo.customer_id
ORDER BY COALESCE(uo.total_spent, 0) DESC
LIMIT 100;

-- ä¼˜åŒ–åæ€§èƒ½è¡¨ç°ï¼š
-- â€¢ æ‰§è¡Œæ—¶é—´ï¼š0.8-1.2ç§’ï¼ˆæå‡10-15å€ï¼‰
-- â€¢ æ‰«æè¡Œæ•°ï¼š15ä¸‡è¡Œï¼ˆé€šè¿‡ç´¢å¼•å¤§å¹…å‡å°‘ï¼‰
-- â€¢ å†…å­˜ä½¿ç”¨ï¼š50MBï¼ˆå‡å°‘90%ï¼‰  
-- â€¢ ç´¢å¼•ä½¿ç”¨ï¼šå……åˆ†åˆ©ç”¨å¤åˆç´¢å¼•
```

### 12.3 æ€§èƒ½æå‡é‡åŒ–åˆ†æ


**ğŸ“ˆ ä¼˜åŒ–æ•ˆæœç»Ÿè®¡è¡¨**

| æŸ¥è¯¢åœºæ™¯ | **ä¼˜åŒ–å‰è€—æ—¶** | **ä¼˜åŒ–åè€—æ—¶** | **æ€§èƒ½æå‡** | **ä¸»è¦ä¼˜åŒ–æ‰‹æ®µ** |
|---------|----------------|----------------|-------------|------------------|
| å‡½æ•°è°ƒç”¨æŸ¥è¯¢ | 8.5ç§’ | 0.1ç§’ | **85å€** | é¿å…WHEREä¸­å‡½æ•°è°ƒç”¨ |
| ç±»å‹è½¬æ¢æŸ¥è¯¢ | 3.2ç§’ | 0.05ç§’ | **64å€** | æ¶ˆé™¤éšå¼ç±»å‹è½¬æ¢ |
| å¤æ‚ORæ¡ä»¶ | 12.0ç§’ | 0.8ç§’ | **15å€** | ORé‡æ„ä¸ºUNION |
| å¤§é‡INæ¡ä»¶ | 15.0ç§’ | 1.2ç§’ | **12.5å€** | INæ¡ä»¶ä¼˜åŒ–ä¸ºJOIN |
| å­æŸ¥è¯¢ä¼˜åŒ– | 25.0ç§’ | 0.3ç§’ | **83å€** | ç›¸å…³å­æŸ¥è¯¢æ”¹ä¸ºçª—å£å‡½æ•° |
| å¤šè¡¨JOIN | 18.0ç§’ | 1.5ç§’ | **12å€** | JOINé¡ºåºå’Œç´¢å¼•ä¼˜åŒ– |

### 12.4 ä¸šåŠ¡å½±å“è¯„ä¼°


**ğŸ’¼ ä¼˜åŒ–å¸¦æ¥çš„ä¸šåŠ¡ä»·å€¼**
```
æ€§èƒ½æå‡çš„ä¸šåŠ¡å½±å“ï¼š
â”Œâ”€ ç”¨æˆ·ä½“éªŒæå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ é¡µé¢åŠ è½½æ—¶é—´ï¼š15ç§’ â†’ 1ç§’      â”‚
â”‚ â€¢ ç”¨æˆ·ç­‰å¾…ä½“éªŒå¤§å¹…æ”¹å–„          â”‚
â”‚ â€¢ é™ä½ç”¨æˆ·æµå¤±ç‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ç³»ç»Ÿèµ„æºèŠ‚çº¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ•°æ®åº“CPUä½¿ç”¨ç‡ï¼š90% â†’ 30%   â”‚
â”‚ â€¢ å†…å­˜å ç”¨å‡å°‘70%              â”‚
â”‚ â€¢ å¯æ”¯æŒæ›´é«˜å¹¶å‘é‡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ è¿ç»´æˆæœ¬é™ä½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ å‡å°‘æ•°æ®åº“æ‰©å®¹éœ€æ±‚            â”‚
â”‚ â€¢ é™ä½æ…¢æŸ¥è¯¢å‘Šè­¦é¢‘ç‡            â”‚
â”‚ â€¢ æå‡ç³»ç»Ÿç¨³å®šæ€§               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š æŠ•å…¥äº§å‡ºæ¯”åˆ†æ**
```sql
-- ä¼˜åŒ–æŠ•å…¥è¯„ä¼°
-- äººåŠ›æŠ•å…¥ï¼šé«˜çº§DBA 2å‘¨æ—¶é—´
-- æŠ€æœ¯æŠ•å…¥ï¼šç´¢å¼•ç©ºé—´å¢åŠ ã€æŸ¥è¯¢é‡æ„
-- é£é™©è¯„ä¼°ï¼šå……åˆ†æµ‹è¯•ï¼Œé£é™©å¯æ§

-- äº§å‡ºæ”¶ç›Šï¼š
-- 1. ç¡¬ä»¶æˆæœ¬èŠ‚çº¦ï¼šå»¶è¿Ÿæ‰©å®¹1å¹´ï¼ŒèŠ‚çœ50ä¸‡
-- 2. äººåŠ›æˆæœ¬èŠ‚çº¦ï¼šå‡å°‘å€¼ç­å¤„ç†æ…¢æŸ¥è¯¢ï¼ŒèŠ‚çœ20ä¸‡/å¹´
-- 3. ä¸šåŠ¡ä»·å€¼æå‡ï¼šç”¨æˆ·ä½“éªŒæ”¹å–„ï¼Œè½¬åŒ–ç‡æå‡2%

-- ROIè®¡ç®—ï¼š
-- æ€»æŠ•å…¥ï¼š10ä¸‡ï¼ˆäººåŠ›æˆæœ¬ï¼‰
-- å¹´æ”¶ç›Šï¼š70ä¸‡ï¼ˆæˆæœ¬èŠ‚çº¦ + ä¸šåŠ¡å¢é•¿ï¼‰
-- ROI = (70-10)/10 = 600%
```

---

## 13. ğŸ”‘ WHEREæ¡ä»¶ä¼˜åŒ–æ ¸å¿ƒæ–¹æ³•


### 13.1 ä¼˜åŒ–æ–¹æ³•ä½“ç³»åŒ–æ€»ç»“


**ğŸ¯ WHEREæ¡ä»¶ä¼˜åŒ–é‡‘å­—å¡”**
```
                    æ€§èƒ½ä¼˜åŒ–é‡‘å­—å¡”
                         /\
                        /  \
                       /    \
                      /      \
                     /        \
                    /   ä¸“å®¶çº§  \
                   / åŠ¨æ€ä¼˜åŒ–ç­–ç•¥ \
                  /________________\
                 /                  \
                /       è¿›é˜¶çº§       \
               / å¤åˆæ¡ä»¶é‡æ„ä¸æˆæœ¬åˆ†æ \
              /________________________\
             /                          \
            /          ä¸­çº§            \
           / ç´¢å¼•ä¼˜åŒ–ä¸èŒƒå›´æ¡ä»¶åˆå¹¶     \
          /______________________________\
         /                                \
        /             åŸºç¡€çº§               \
       / é€‰æ‹©æ€§åˆ†æã€å‡½æ•°é¿å…ã€ç±»å‹åŒ¹é…   \
      /____________________________________\
     /                                      \
    /                å…¥é—¨çº§                 \
   /        æ¡ä»¶é¡ºåºã€è¯­æ³•åŸºç¡€               \
  /________________________________________\
```

### 13.2 æ ¸å¿ƒä¼˜åŒ–æ£€æŸ¥æ¸…å•


**âœ… WHEREæ¡ä»¶ä¼˜åŒ–è‡ªæ£€è¡¨**
```
ğŸ”¸ åŸºç¡€ä¼˜åŒ–æ£€æŸ¥ï¼š
â–¡ æ¡ä»¶é¡ºåºï¼šé«˜é€‰æ‹©æ€§æ¡ä»¶æ˜¯å¦åœ¨å‰ï¼Ÿ
â–¡ ç´¢å¼•ä½¿ç”¨ï¼šæ˜¯å¦å……åˆ†åˆ©ç”¨äº†ç°æœ‰ç´¢å¼•ï¼Ÿ
â–¡ å‡½æ•°è°ƒç”¨ï¼šWHEREä¸­æ˜¯å¦é¿å…äº†å‡½æ•°è°ƒç”¨ï¼Ÿ
â–¡ ç±»å‹åŒ¹é…ï¼šæ¡ä»¶å€¼ç±»å‹æ˜¯å¦ä¸å­—æ®µç±»å‹åŒ¹é…ï¼Ÿ
â–¡ è¯­æ³•ä¼˜åŒ–ï¼šæ˜¯å¦ä½¿ç”¨äº†æœ€ä¼˜çš„SQLè¯­æ³•ï¼Ÿ

ğŸ”¸ è¿›é˜¶ä¼˜åŒ–æ£€æŸ¥ï¼š
â–¡ å¤åˆç´¢å¼•ï¼šæ˜¯å¦åˆ›å»ºäº†åˆé€‚çš„å¤åˆç´¢å¼•ï¼Ÿ
â–¡ æ¡ä»¶é‡æ„ï¼šå¤æ‚æ¡ä»¶æ˜¯å¦è¿›è¡Œäº†é‡æ„ä¼˜åŒ–ï¼Ÿ
â–¡ èŒƒå›´åˆå¹¶ï¼šèŒƒå›´æ¡ä»¶æ˜¯å¦è¿›è¡Œäº†æœ‰æ•ˆåˆå¹¶ï¼Ÿ
â–¡ ORä¼˜åŒ–ï¼šORæ¡ä»¶æ˜¯å¦é‡æ„ä¸ºUNIONæˆ–INï¼Ÿ
â–¡ å­æŸ¥è¯¢ï¼šç›¸å…³å­æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ–ä¸ºJOINï¼Ÿ

ğŸ”¸ ä¸“å®¶çº§æ£€æŸ¥ï¼š
â–¡ æˆæœ¬åˆ†æï¼šæ˜¯å¦åˆ†æäº†æŸ¥è¯¢æ‰§è¡Œæˆæœ¬ï¼Ÿ
â–¡ åŠ¨æ€ä¼˜åŒ–ï¼šåŠ¨æ€æŸ¥è¯¢æ˜¯å¦æœ‰å¯¹åº”çš„ä¼˜åŒ–ç­–ç•¥ï¼Ÿ
â–¡ ç¼“å­˜ç­–ç•¥ï¼šæ˜¯å¦åˆ©ç”¨äº†æŸ¥è¯¢ç»“æœç¼“å­˜ï¼Ÿ
â–¡ åˆ†åŒºç­–ç•¥ï¼šå¤§è¡¨æ˜¯å¦è€ƒè™‘äº†åˆ†åŒºä¼˜åŒ–ï¼Ÿ
â–¡ ç›‘æ§ä½“ç³»ï¼šæ˜¯å¦å»ºç«‹äº†æ€§èƒ½ç›‘æ§æœºåˆ¶ï¼Ÿ
```

### 13.3 ä¼˜åŒ–å†³ç­–æµç¨‹å›¾


**ğŸ”„ ä¼˜åŒ–å†³ç­–æ ‘**
```
å¼€å§‹ä¼˜åŒ–WHEREæ¡ä»¶
         |
         â–¼
    æŸ¥è¯¢æ˜¯å¦é¢‘ç¹æ‰§è¡Œï¼Ÿ
    (QPS > 10)
         |
    Yes  |  No
         â–¼     â–¼
    é«˜ä¼˜å…ˆçº§   ä½ä¼˜å…ˆçº§
         |     (å¯ç®€å•ä¼˜åŒ–)
         â–¼
    åˆ†æå½“å‰æ€§èƒ½é—®é¢˜
         |
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
    |         |         |
    â–¼         â–¼         â–¼
å…¨è¡¨æ‰«æ    ç´¢å¼•ä½æ•ˆ   è®¡ç®—å¯†é›†
    |         |         |
    â–¼         â–¼         â–¼
æ·»åŠ ç´¢å¼•   ä¼˜åŒ–ç´¢å¼•   é¿å…å‡½æ•°
    |         |         |
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â–¼
    æµ‹è¯•æ€§èƒ½æå‡
         |
         â–¼
    æå‡æ˜¯å¦æ˜¾è‘—ï¼Ÿ
    (>50%æ€§èƒ½æå‡)
         |
    Yes  |  No
         â–¼     â–¼
    åº”ç”¨ä¸Šçº¿   ç»§ç»­æ·±åº¦ä¼˜åŒ–
                  |
                  â–¼
              ä¸“å®¶çº§ä¼˜åŒ–
              (æˆæœ¬æ¨¡å‹åˆ†æ)
```

### 13.4 å¸¸ç”¨ä¼˜åŒ–æ¨¡å¼æ€»ç»“


**ğŸ”§ ç»å…¸ä¼˜åŒ–æ¨¡å¼**
```sql
-- æ¨¡å¼1ï¼šé«˜é€‰æ‹©æ€§æ¡ä»¶ä¼˜å…ˆæ¨¡å¼
-- âŒ ä½é€‰æ‹©æ€§åœ¨å‰
WHERE status = 'active' AND user_id = 123456
-- âœ… é«˜é€‰æ‹©æ€§åœ¨å‰  
WHERE user_id = 123456 AND status = 'active'

-- æ¨¡å¼2ï¼šèŒƒå›´æŸ¥è¯¢æ›¿ä»£å‡½æ•°æ¨¡å¼
-- âŒ å‡½æ•°è°ƒç”¨
WHERE YEAR(created_date) = 2023
-- âœ… èŒƒå›´æŸ¥è¯¢
WHERE created_date >= '2023-01-01' AND created_date < '2024-01-01'

-- æ¨¡å¼3ï¼šINæ¡ä»¶ä¼˜åŒ–æ¨¡å¼  
-- âŒ å¤§é‡ORæ¡ä»¶
WHERE status = 'A' OR status = 'B' OR status = 'C'
-- âœ… INæ¡ä»¶
WHERE status IN ('A', 'B', 'C')

-- æ¨¡å¼4ï¼šEXISTSæ›¿ä»£INæ¨¡å¼
-- âŒ å¤§ç»“æœé›†IN
WHERE customer_id IN (SELECT customer_id FROM vip_customers)
-- âœ… EXISTSæŸ¥è¯¢
WHERE EXISTS (SELECT 1 FROM vip_customers v WHERE v.customer_id = orders.customer_id)

-- æ¨¡å¼5ï¼šå¤åˆç´¢å¼•è¦†ç›–æ¨¡å¼
-- åˆ›å»ºè¦†ç›–ç´¢å¼•é¿å…å›è¡¨
CREATE INDEX idx_covering ON orders (customer_id, status, order_date, total_amount);
-- æŸ¥è¯¢å®Œå…¨ä½¿ç”¨ç´¢å¼•æ•°æ®
SELECT customer_id, status, order_date, total_amount FROM orders 
WHERE customer_id = 123 AND status = 'active';
```

---

## 14. ğŸ“Š æ¡ä»¶æŸ¥è¯¢æ€§èƒ½ç›‘æ§


### 14.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```sql
-- æŸ¥è¯¢æ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW v_query_performance AS
SELECT 
    DIGEST_TEXT as sql_pattern,
    SCHEMA_NAME as database_name,
    COUNT_STAR as execution_count,
    AVG_TIMER_WAIT/1000000000 as avg_execution_time_sec,
    MAX_TIMER_WAIT/1000000000 as max_execution_time_sec,
    SUM_ROWS_EXAMINED as total_rows_examined,
    SUM_ROWS_SENT as total_rows_returned,
    SUM_ROWS_EXAMINED/COUNT_STAR as avg_rows_examined,
    FIRST_SEEN,
    LAST_SEEN
FROM performance_schema.events_statements_summary_by_digest
WHERE SCHEMA_NAME IS NOT NULL
  AND AVG_TIMER_WAIT > 100000000  -- å¤§äº0.1ç§’çš„æŸ¥è¯¢
ORDER BY AVG_TIMER_WAIT DESC;

-- æŸ¥çœ‹TOPæ…¢æŸ¥è¯¢
SELECT * FROM v_query_performance LIMIT 20;
```

### 14.2 å®æ—¶ç›‘æ§å‘Šè­¦


**ğŸš¨ ç›‘æ§å‘Šè­¦è®¾ç½®**
```sql
-- åˆ›å»ºç›‘æ§è¡¨å­˜å‚¨å†å²æ•°æ®
CREATE TABLE query_performance_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    sql_digest VARCHAR(64),
    avg_execution_time DECIMAL(10,3),
    execution_count INT,
    rows_examined_avg INT,
    alert_level ENUM('INFO', 'WARN', 'ERROR'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_digest_time (sql_digest, created_at)
);

-- ç›‘æ§è„šæœ¬ï¼ˆå®šæœŸæ‰§è¡Œï¼‰
DELIMITER $
CREATE PROCEDURE MonitorSlowQueries()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE sql_digest VARCHAR(64);
    DECLARE avg_time DECIMAL(10,3);
    DECLARE exec_count INT;
    DECLARE rows_examined INT;
    DECLARE alert_level VARCHAR(10);
    
    DECLARE cur CURSOR FOR 
        SELECT 
            DIGEST,
            AVG_TIMER_WAIT/1000000000,
            COUNT_STAR,
            SUM_ROWS_EXAMINED/COUNT_STAR
        FROM performance_schema.events_statements_summary_by_digest
        WHERE AVG_TIMER_WAIT > 500000000;  -- è¶…è¿‡0.5ç§’
        
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur;
    
    query_loop: LOOP
        FETCH cur INTO sql_digest, avg_time, exec_count, rows_examined;
        IF done THEN
            LEAVE query_loop;
        END IF;
        
        -- è®¾ç½®å‘Šè­¦çº§åˆ«
        SET alert_level = CASE 
            WHEN avg_time > 10 THEN 'ERROR'
            WHEN avg_time > 5 THEN 'WARN'  
            ELSE 'INFO'
        END;
        
        -- è®°å½•ç›‘æ§æ•°æ®
        INSERT INTO query_performance_history 
        (sql_digest, avg_execution_time, execution_count, rows_examined_avg, alert_level)
        VALUES (sql_digest, avg_time, exec_count, rows_examined, alert_level);
        
        -- å‘é€å‘Šè­¦ï¼ˆERRORçº§åˆ«ï¼‰
        IF alert_level = 'ERROR' THEN
            -- è¿™é‡Œå¯ä»¥è°ƒç”¨å‘Šè­¦æ¥å£æˆ–å‘é€é‚®ä»¶
            SELECT CONCAT('ALERT: Slow query detected - Digest: ', sql_digest, 
                         ', Avg Time: ', avg_time, 's') AS alert_message;
        END IF;
        
    END LOOP;
    
    CLOSE cur;
END$
DELIMITER ;

-- è®¾ç½®å®šæ—¶ä»»åŠ¡æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
-- CREATE EVENT ev_monitor_queries
-- ON SCHEDULE EVERY 5 MINUTE
-- DO CALL MonitorSlowQueries();
```

### 14.3 æ€§èƒ½è¶‹åŠ¿åˆ†æ


**ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿ç›‘æ§**
```sql
-- æŸ¥è¯¢æ€§èƒ½è¶‹åŠ¿åˆ†æ
SELECT 
    DATE(created_at) as date,
    alert_level,
    COUNT(*) as alert_count,
    AVG(avg_execution_time) as avg_query_time,
    MAX(avg_execution_time) as max_query_time,
    AVG(rows_examined_avg) as avg_rows_examined
FROM query_performance_history
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at), alert_level
ORDER BY date DESC, alert_level;

-- æœ€é¢‘ç¹çš„æ…¢æŸ¥è¯¢æ¨¡å¼
SELECT 
    sql_digest,
    COUNT(*) as occurrence_count,
    AVG(avg_execution_time) as avg_time,
    MAX(avg_execution_time) as max_time,
    MIN(created_at) as first_occurrence,
    MAX(created_at) as last_occurrence
FROM query_performance_history
WHERE alert_level IN ('WARN', 'ERROR')
  AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY sql_digest
ORDER BY occurrence_count DESC
LIMIT 10;
```

### 14.4 è‡ªåŠ¨ä¼˜åŒ–å»ºè®®


**ğŸ¤– æ™ºèƒ½ä¼˜åŒ–å»ºè®®ç³»ç»Ÿ**
```sql
-- ä¼˜åŒ–å»ºè®®ç”Ÿæˆ
CREATE TABLE optimization_suggestions (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    sql_digest VARCHAR(64),
    suggestion_type ENUM('ADD_INDEX', 'REWRITE_QUERY', 'OPTIMIZE_CONDITION'),
    suggestion_text TEXT,
    priority ENUM('HIGH', 'MEDIUM', 'LOW'),
    estimated_improvement VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

DELIMITER $
CREATE PROCEDURE GenerateOptimizationSuggestions()
BEGIN
    -- å»ºè®®æ·»åŠ ç´¢å¼•
    INSERT INTO optimization_suggestions 
    (sql_digest, suggestion_type, suggestion_text, priority, estimated_improvement)
    SELECT 
        DIGEST,
        'ADD_INDEX',
        CONCAT('å»ºè®®ä¸ºæŸ¥è¯¢æ·»åŠ ç´¢å¼•ï¼Œå½“å‰å¹³å‡æ‰«æ ', 
               ROUND(SUM_ROWS_EXAMINED/COUNT_STAR), ' è¡Œ'),
        CASE 
            WHEN SUM_ROWS_EXAMINED/COUNT_STAR > 100000 THEN 'HIGH'
            WHEN SUM_ROWS_EXAMINED/COUNT_STAR > 10000 THEN 'MEDIUM'
            ELSE 'LOW'
        END,
        CONCAT('é¢„è®¡æå‡ ', 
               CASE 
                   WHEN SUM_ROWS_EXAMINED/COUNT_STAR > 100000 THEN '10-50å€'
                   WHEN SUM_ROWS_EXAMINED/COUNT_STAR > 10000 THEN '5-20å€'
                   ELSE '2-5å€'
               END)
    FROM performance_schema.events_statements_summary_by_digest
    WHERE SUM_ROWS_EXAMINED/COUNT_STAR > 1000
      AND AVG_TIMER_WAIT > 1000000000
      AND DIGEST NOT IN (SELECT sql_digest FROM optimization_suggestions);

    -- å»ºè®®æŸ¥è¯¢é‡å†™
    INSERT INTO optimization_suggestions
    (sql_digest, suggestion_type, suggestion_text, priority, estimated_improvement)  
    SELECT 
        DIGEST,
        'REWRITE_QUERY',
        'å»ºè®®æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦åŒ…å«å‡½æ•°è°ƒç”¨æˆ–ç±»å‹è½¬æ¢ï¼Œè€ƒè™‘é‡å†™ä¼˜åŒ–',
        'MEDIUM',
        'é¢„è®¡æå‡ 2-10å€'
    FROM performance_schema.events_statements_summary_by_digest
    WHERE DIGEST_TEXT LIKE '%YEAR(%' 
       OR DIGEST_TEXT LIKE '%MONTH(%'
       OR DIGEST_TEXT LIKE '%DATE_FORMAT(%'
       AND DIGEST NOT IN (SELECT sql_digest FROM optimization_suggestions);
       
END$
DELIMITER ;
```

---

## 15. ğŸ† æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 15.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ WHEREä¼˜åŒ–æœ¬è´¨ï¼šé€šè¿‡åˆç†çš„æ¡ä»¶ç»„ç»‡å’Œç´¢å¼•ä½¿ç”¨ï¼Œæœ€å¤§åŒ–å‡å°‘æ•°æ®æ‰«æé‡
ğŸ”¸ é€‰æ‹©æ€§åŸç†ï¼šé«˜é€‰æ‹©æ€§æ¡ä»¶èƒ½è¿‡æ»¤æ›´å¤šæ•°æ®ï¼Œåº”è¯¥ä¼˜å…ˆæ‰§è¡Œ
ğŸ”¸ ç´¢å¼•å‹å¥½ï¼šé¿å…å‡½æ•°è°ƒç”¨å’Œç±»å‹è½¬æ¢ï¼Œä¿æŒç´¢å¼•çš„é«˜æ•ˆä½¿ç”¨
ğŸ”¸ æˆæœ¬æ„è¯†ï¼šç†è§£æ•°æ®åº“ä¼˜åŒ–å™¨çš„æˆæœ¬æ¨¡å‹ï¼ŒååŠ©å…¶åšå‡ºæœ€ä¼˜å†³ç­–
ğŸ”¸ ç›‘æ§é©±åŠ¨ï¼šå»ºç«‹å®Œå–„çš„æ€§èƒ½ç›‘æ§ä½“ç³»ï¼ŒæŒç»­ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
```

### 15.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆWHEREæ¡ä»¶å¦‚æ­¤é‡è¦**
```
æ•°æ®è®¿é—®çš„æ¼æ–—æ•ˆåº”ï¼š
å­˜å‚¨å±‚ (ç™¾ä¸‡çº§æ•°æ®) 
    â†“ WHEREæ¡ä»¶è¿‡æ»¤
ç½‘ç»œå±‚ (ä¸‡çº§æ•°æ®)
    â†“ ä¸šåŠ¡é€»è¾‘å¤„ç†  
åº”ç”¨å±‚ (ç™¾çº§æ•°æ®)
    â†“ ç”¨æˆ·ç•Œé¢å±•ç¤º
ç”¨æˆ·å±‚ (åçº§æ•°æ®)

WHEREæ¡ä»¶å†³å®šäº†è¿™ä¸ªæ¼æ–—çš„æ•ˆç‡
ä¼˜ç§€çš„WHEREæ¡ä»¶ï¼šåœ¨å­˜å‚¨å±‚å°±è¿‡æ»¤æ‰99%çš„æ— å…³æ•°æ®
ç³Ÿç³•çš„WHEREæ¡ä»¶ï¼šå¤§é‡æ— å…³æ•°æ®ä¼ è¾“åˆ°åº”ç”¨å±‚æ‰è¿‡æ»¤
```

**ğŸ”¹ ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³**
```
ä¸‰ä¸ªä¼˜åŒ–ç»´åº¦ï¼š
ğŸ“Š æ•°æ®é‡ç»´åº¦ï¼šå‡å°‘éœ€è¦æ£€æŸ¥çš„æ•°æ®è¡Œæ•°
âš¡ è®¡ç®—é‡ç»´åº¦ï¼šå‡å°‘æ¯è¡Œæ•°æ®çš„å¤„ç†è®¡ç®—  
ğŸ”„ IOé‡ç»´åº¦ï¼šå‡å°‘ç£ç›˜è¯»å–å’Œç½‘ç»œä¼ è¾“

ä¼˜åŒ–ä¼˜å…ˆçº§ï¼š
1. åˆ©ç”¨ç´¢å¼• (æ•°æ®é‡ä¼˜åŒ–)
2. é¿å…å‡½æ•° (è®¡ç®—é‡ä¼˜åŒ–)  
3. æ¡ä»¶é‡æ„ (IOé‡ä¼˜åŒ–)
```

### 15.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“‹ ä¼˜åŒ–å·¥ä½œæµç¨‹**
```
ç¬¬1æ­¥ï¼šè¯†åˆ«é—®é¢˜
â€¢ ç›‘æ§æ…¢æŸ¥è¯¢æ—¥å¿—
â€¢ åˆ†æEXPLAINæ‰§è¡Œè®¡åˆ’
â€¢ è¯„ä¼°æŸ¥è¯¢é¢‘ç‡å’Œä¸šåŠ¡å½±å“

ç¬¬2æ­¥ï¼šè¯Šæ–­åŸå›   
â€¢ æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
â€¢ åˆ†ææ¡ä»¶é€‰æ‹©æ€§
â€¢ è¯†åˆ«æ€§èƒ½ç“¶é¢ˆç‚¹

ç¬¬3æ­¥ï¼šåˆ¶å®šæ–¹æ¡ˆ
â€¢ è®¾è®¡ä¼˜åŒ–ç­–ç•¥
â€¢ è¯„ä¼°æ”¹åŠ¨é£é™©
â€¢ åˆ¶å®šæµ‹è¯•è®¡åˆ’

ç¬¬4æ­¥ï¼šå®æ–½ä¼˜åŒ–
â€¢ åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
â€¢ ç›‘æ§æ€§èƒ½æŒ‡æ ‡å˜åŒ–
â€¢ ç”Ÿäº§ç¯å¢ƒç°åº¦å‘å¸ƒ

ç¬¬5æ­¥ï¼šæ•ˆæœè¯„ä¼°
â€¢ å¯¹æ¯”ä¼˜åŒ–å‰åæŒ‡æ ‡
â€¢ ç›‘æ§ä¸šåŠ¡å½±å“
â€¢ å»ºç«‹é•¿æœŸç›‘æ§
```

**âš–ï¸ ä¼˜åŒ–ç­–ç•¥é€‰æ‹©**
```
ç®€å•æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ è°ƒæ•´æ¡ä»¶é¡ºåº
â€¢ æ·»åŠ å•åˆ—ç´¢å¼•
â€¢ é¿å…æ˜æ˜¾çš„æ€§èƒ½é™·é˜±

å¤æ‚æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ åˆ›å»ºå¤åˆç´¢å¼•
â€¢ é‡æ„æŸ¥è¯¢é€»è¾‘
â€¢ è€ƒè™‘åˆ†è§£å­æŸ¥è¯¢

ä¼ä¸šçº§ä¼˜åŒ–ï¼š
â€¢ å»ºç«‹ç›‘æ§ä½“ç³»
â€¢ åˆ¶å®šä¼˜åŒ–è§„èŒƒ
â€¢ å®æ–½è‡ªåŠ¨åŒ–å·¥å…·
```

### 15.4 é¿å…å¸¸è§è¯¯åŒº


**âŒ å¸¸è§ä¼˜åŒ–è¯¯åŒº**
```
è¯¯åŒº1ï¼šè¿‡åº¦ç´¢å¼•
â€¢ é”™è¯¯è§‚å¿µï¼šç»™æ¯ä¸ªå­—æ®µéƒ½åŠ ç´¢å¼•
â€¢ æ­£ç¡®åšæ³•ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼åˆ›å»ºåˆé€‚ç´¢å¼•

è¯¯åŒº2ï¼šå¿½è§†ä¸šåŠ¡é€»è¾‘
â€¢ é”™è¯¯è§‚å¿µï¼šåªå…³æ³¨æŠ€æœ¯æ€§èƒ½ï¼Œå¿½è§†ä¸šåŠ¡éœ€æ±‚
â€¢ æ­£ç¡®åšæ³•ï¼šåœ¨æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„å‰æä¸‹ä¼˜åŒ–

è¯¯åŒº3ï¼šè¿‡æ—©ä¼˜åŒ–
â€¢ é”™è¯¯è§‚å¿µï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½éœ€è¦æè‡´ä¼˜åŒ–
â€¢ æ­£ç¡®åšæ³•ï¼šä¼˜å…ˆä¼˜åŒ–é«˜é¢‘å’Œå…³é”®æŸ¥è¯¢

è¯¯åŒº4ï¼šä¸€æ¬¡æ€§ä¼˜åŒ–
â€¢ é”™è¯¯è§‚å¿µï¼šä¼˜åŒ–ä¸€æ¬¡å°±ä¸€åŠ³æ°¸é€¸
â€¢ æ­£ç¡®åšæ³•ï¼šå»ºç«‹æŒç»­ç›‘æ§å’Œä¼˜åŒ–æœºåˆ¶
```

### 15.5 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š æŠ€èƒ½å‘å±•è·¯çº¿**
```
åˆçº§é˜¶æ®µï¼š
â€¢ æŒæ¡åŸºæœ¬SQLè¯­æ³•ä¼˜åŒ–
â€¢ ç†è§£ç´¢å¼•çš„åŸºæœ¬åŸç†
â€¢ å­¦ä¼šä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢

ä¸­çº§é˜¶æ®µï¼š
â€¢ æ·±å…¥ç†è§£æŸ¥è¯¢ä¼˜åŒ–å™¨
â€¢ æŒæ¡å¤æ‚æŸ¥è¯¢é‡æ„æŠ€å·§
â€¢ å»ºç«‹æ€§èƒ½ç›‘æ§æ„è¯†

é«˜çº§é˜¶æ®µï¼š
â€¢ ç²¾é€šæ•°æ®åº“å†…æ ¸æœºåˆ¶
â€¢ è®¾è®¡ä¼ä¸šçº§ä¼˜åŒ–æ–¹æ¡ˆ
â€¢ å…·å¤‡ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜èƒ½åŠ›

ä¸“å®¶é˜¶æ®µï¼š
â€¢ å‚ä¸æ•°æ®åº“äº§å“ä¼˜åŒ–
â€¢ åˆ¶å®šè¡Œä¸šæœ€ä½³å®è·µ
â€¢ åŸ¹å…»å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›
```

**ğŸ¯ æŒç»­å­¦ä¹ å»ºè®®**
```
ç†è®ºå­¦ä¹ ï¼š
â€¢ æ·±å…¥ç ”ç©¶æ•°æ®åº“åŸç†
â€¢ å…³æ³¨æœ€æ–°æŠ€æœ¯å‘å±•
â€¢ å­¦ä¹ å…¶ä»–æ•°æ®åº“äº§å“

å®è·µæå‡ï¼š
â€¢ å¤„ç†æ›´å¤šå¤æ‚åœºæ™¯
â€¢ ç§¯ç´¯ä¼˜åŒ–æ¡ˆä¾‹åº“
â€¢ åˆ†äº«ç»éªŒå’Œå¿ƒå¾—

å·¥å…·æŒæ¡ï¼š
â€¢ ç†Ÿç»ƒä½¿ç”¨ç›‘æ§å·¥å…·
â€¢ æŒæ¡è‡ªåŠ¨åŒ–è„šæœ¬
â€¢ äº†è§£äº‘æ•°æ®åº“ç‰¹æ€§
```

> **ğŸ’¡ ä¸€å¥è¯æ€»ç»“**ï¼šWHEREæ¡ä»¶ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯"è®©æ•°æ®åº“ä»¥æœ€å°‘çš„ä»£ä»·æ‰¾åˆ°æœ€å‡†ç¡®çš„ç»“æœ"ï¼Œè¿™éœ€è¦æˆ‘ä»¬åœ¨ç†è§£ä¸šåŠ¡éœ€æ±‚çš„åŸºç¡€ä¸Šï¼Œåˆç†è®¾è®¡æ¡ä»¶é€»è¾‘å’Œç´¢å¼•ç­–ç•¥ã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
â”Œâ”€ WHEREä¼˜åŒ–è¦è¯€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©æ€§é«˜æ¡ä»¶å…ˆæ‰§è¡Œï¼Œç´¢å¼•å‹å¥½æ˜¯å…³é”® â”‚
â”‚ å‡½æ•°è°ƒç”¨è¦é¿å…ï¼Œç±»å‹åŒ¹é…åˆ«å¿½è§†   â”‚
â”‚ å¤æ‚æ¡ä»¶å·§é‡æ„ï¼Œæˆæœ¬æ¨¡å‹åŠ©å†³ç­–   â”‚
â”‚ ç›‘æ§ä½“ç³»å¸¸ç›¸ä¼´ï¼ŒæŒç»­ä¼˜åŒ–è§çœŸç«    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```