---
title: 16ã€å¤æ‚æŸ¥è¯¢åˆ†ç‰‡ä¸è·¯ç”±
---
## ğŸ“š ç›®å½•

1. [åˆ†ç‰‡æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ](#1-åˆ†ç‰‡æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ)
2. [æŸ¥è¯¢åˆ†ç‰‡ç­–ç•¥è¯¦è§£](#2-æŸ¥è¯¢åˆ†ç‰‡ç­–ç•¥è¯¦è§£)
3. [è·¯ç”±è§„åˆ™è®¾è®¡](#3-è·¯ç”±è§„åˆ™è®¾è®¡)
4. [è·¨ç‰‡æŸ¥è¯¢å¤„ç†](#4-è·¨ç‰‡æŸ¥è¯¢å¤„ç†)
5. [åˆ†ç‰‡èšåˆä¼˜åŒ–](#5-åˆ†ç‰‡èšåˆä¼˜åŒ–)
6. [è·¯ç”±æ€§èƒ½ä¼˜åŒ–](#6-è·¯ç”±æ€§èƒ½ä¼˜åŒ–)
7. [åˆ†ç‰‡äº‹åŠ¡å¤„ç†](#7-åˆ†ç‰‡äº‹åŠ¡å¤„ç†)
8. [å®é™…åº”ç”¨åœºæ™¯](#8-å®é™…åº”ç”¨åœºæ™¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åˆ†ç‰‡æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†ç‰‡æŸ¥è¯¢


**åˆ†ç‰‡æŸ¥è¯¢**å°±åƒæŠŠä¸€æœ¬åšå­—å…¸åˆ†æˆå¥½å‡ æœ¬å°å†Œå­ï¼ŒæŸ¥è¯çš„æ—¶å€™å…ˆç¡®å®šåœ¨å“ªæœ¬å°å†Œå­é‡Œï¼Œå†ç¿»åˆ°å…·ä½“é¡µé¢ã€‚

```
å•åº“å•è¡¨æ—¶ä»£ï¼š
ç”¨æˆ·è¡¨ (1äº¿æ¡è®°å½•)
â””â”€â”€ æ‰€æœ‰æŸ¥è¯¢éƒ½åœ¨è¿™ä¸€å¼ è¡¨ä¸Šæ‰§è¡Œ
    â”œâ”€â”€ æŸ¥è¯¢æ…¢
    â”œâ”€â”€ å†™å…¥æ…¢
    â””â”€â”€ ç»´æŠ¤å›°éš¾

åˆ†ç‰‡æ—¶ä»£ï¼š
ç”¨æˆ·è¡¨åˆ†æˆ8ä¸ªç‰‡
â”œâ”€â”€ user_0 (1250ä¸‡æ¡)
â”œâ”€â”€ user_1 (1250ä¸‡æ¡)  
â”œâ”€â”€ user_2 (1250ä¸‡æ¡)
â”œâ”€â”€ ...
â””â”€â”€ user_7 (1250ä¸‡æ¡)
```

### 1.2 åˆ†ç‰‡æŸ¥è¯¢çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ”¸ åˆ†ç‰‡æŸ¥è¯¢é¢ä¸´çš„ä¸»è¦é—®é¢˜**

| é—®é¢˜ç±»å‹ | **å…·ä½“è¡¨ç°** | **è§£å†³éš¾åº¦** | **å½±å“ç¨‹åº¦** |
|---------|------------|-------------|-------------|
| ğŸ¯ **è·¯ç”±å¤æ‚** | `éœ€è¦è®¡ç®—æŸ¥è¯¢è½åœ¨å“ªä¸ªåˆ†ç‰‡` | `ğŸŸ¡ä¸­ç­‰` | `ğŸ”´é«˜` |
| ğŸ”— **è·¨ç‰‡æŸ¥è¯¢** | `æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªåˆ†ç‰‡ä¸Š` | `ğŸ”´å›°éš¾` | `ğŸ”´é«˜` |
| ğŸ“Š **èšåˆè®¡ç®—** | `SUM/COUNTç­‰éœ€è¦åˆå¹¶ç»“æœ` | `ğŸ”´å›°éš¾` | `ğŸŸ¡ä¸­ç­‰` |
| ğŸ”„ **äº‹åŠ¡å¤„ç†** | `è·¨ç‰‡äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯` | `ğŸ”´æéš¾` | `ğŸ”´æé«˜` |
| ğŸ“ˆ **æ‰©å®¹ç»´æŠ¤** | `åˆ†ç‰‡æ•°é‡å˜åŒ–æ—¶æ•°æ®è¿ç§»` | `ğŸ”´å›°éš¾` | `ğŸ”´é«˜` |

### 1.3 åˆ†ç‰‡æ¶æ„åŸºæœ¬ç»„æˆ


```
åº”ç”¨å±‚æŸ¥è¯¢è¯·æ±‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æŸ¥è¯¢è·¯ç”±å±‚     â”‚ â† è§£æSQLï¼Œç¡®å®šè·¯ç”±ç­–ç•¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åˆ†ç‰‡ä»£ç†å±‚     â”‚ â† æ‰§è¡Œå…·ä½“çš„åˆ†ç‰‡è·¯ç”±
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   MySQLåˆ†ç‰‡ç¾¤   â”‚ â† å®é™…å­˜å‚¨æ•°æ®çš„æ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¸å¿ƒç»„ä»¶è¯´æ˜ï¼š
ğŸ”¸ æŸ¥è¯¢è§£æå™¨ï¼šåˆ†æSQLè¯­å¥ç»“æ„
ğŸ”¸ è·¯ç”±è®¡ç®—å™¨ï¼šæ ¹æ®åˆ†ç‰‡é”®è®¡ç®—ç›®æ ‡åˆ†ç‰‡
ğŸ”¸ ç»“æœåˆå¹¶å™¨ï¼šæ±‡æ€»å„åˆ†ç‰‡çš„æŸ¥è¯¢ç»“æœ
ğŸ”¸ äº‹åŠ¡åè°ƒå™¨ï¼šå¤„ç†è·¨ç‰‡äº‹åŠ¡çš„ä¸€è‡´æ€§
```

---

## 2. ğŸ§­ æŸ¥è¯¢åˆ†ç‰‡ç­–ç•¥è¯¦è§£


### 2.1 åŸºäºåˆ†ç‰‡é”®çš„è·¯ç”±ç­–ç•¥


**åˆ†ç‰‡é”®**å°±åƒèº«ä»½è¯å·ç ï¼Œé€šè¿‡å®ƒèƒ½å¿«é€Ÿå®šä½æ•°æ®åœ¨å“ªä¸ªåˆ†ç‰‡é‡Œã€‚

**ğŸ”¸ å¸¸è§åˆ†ç‰‡é”®é€‰æ‹©ç­–ç•¥**

```
ç”¨æˆ·IDåˆ†ç‰‡ï¼š
â”œâ”€â”€ ä¼˜ç‚¹ï¼šæŸ¥è¯¢è·¯ç”±ç®€å•ï¼Œæ•°æ®åˆ†å¸ƒå‡åŒ€
â”œâ”€â”€ ç¼ºç‚¹ï¼šè·¨ç”¨æˆ·æŸ¥è¯¢éœ€è¦è®¿é—®å¤šä¸ªåˆ†ç‰‡
â””â”€â”€ é€‚ç”¨ï¼šç”¨æˆ·ç›¸å…³çš„æŸ¥è¯¢å ä¸»å¯¼

æ—¶é—´èŒƒå›´åˆ†ç‰‡ï¼š
â”œâ”€â”€ ä¼˜ç‚¹ï¼šå†å²æ•°æ®æŸ¥è¯¢æ•ˆç‡é«˜
â”œâ”€â”€ ç¼ºç‚¹ï¼šçƒ­ç‚¹æ•°æ®å¯èƒ½é›†ä¸­åœ¨æœ€æ–°åˆ†ç‰‡
â””â”€â”€ é€‚ç”¨ï¼šæ—¥å¿—ã€è®¢å•ç­‰æŒ‰æ—¶é—´æŸ¥è¯¢çš„åœºæ™¯

åœ°åŸŸåˆ†ç‰‡ï¼š
â”œâ”€â”€ ä¼˜ç‚¹ï¼šç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼Œä¾¿äºæ•°æ®éš”ç¦»
â”œâ”€â”€ ç¼ºç‚¹ï¼šå„åœ°åŒºæ•°æ®é‡å¯èƒ½ä¸å‡è¡¡
â””â”€â”€ é€‚ç”¨ï¼šå¤šåœ°åŒºä¸šåŠ¡ç³»ç»Ÿ
```

### 2.2 å“ˆå¸Œåˆ†ç‰‡ç®—æ³•


**å“ˆå¸Œåˆ†ç‰‡**æ˜¯æœ€å¸¸ç”¨çš„æ–¹å¼ï¼Œå°±åƒæ´—ç‰Œä¸€æ ·æŠŠæ•°æ®éšæœºä½†å‡åŒ€åœ°åˆ†å¸ƒã€‚

```sql
-- ç®€å•å“ˆå¸Œåˆ†ç‰‡ç¤ºä¾‹
-- ç”¨æˆ·IDä¸º12345çš„æ•°æ®è·¯ç”±è®¡ç®—

åˆ†ç‰‡æ•°é‡ï¼š8ä¸ª
å“ˆå¸Œè®¡ç®—ï¼šuser_id % 8
è·¯ç”±ç»“æœï¼š12345 % 8 = 1
ç›®æ ‡åˆ†ç‰‡ï¼šuser_1

-- å¯¹åº”çš„æŸ¥è¯¢è½¬æ¢
åŸå§‹æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE user_id = 12345;

è·¯ç”±åæŸ¥è¯¢ï¼š
SELECT * FROM user_1 WHERE user_id = 12345;
```

**ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡**

```
ä¸€è‡´æ€§å“ˆå¸Œç¯ç¤ºæ„ï¼š
        0
        â†‘
    7       1
        â†“
6   â—â—â—â—â—   2  â† â—ä»£è¡¨åˆ†ç‰‡èŠ‚ç‚¹
        â†‘
    5       3
        4

ä¼˜åŠ¿ï¼š
âœ… æ‰©ç¼©å®¹æ—¶æ•°æ®è¿ç§»é‡æœ€å°
âœ… è´Ÿè½½åˆ†å¸ƒç›¸å¯¹å‡åŒ€
âœ… èŠ‚ç‚¹æ•…éšœå½±å“èŒƒå›´å¯æ§
```

### 2.3 èŒƒå›´åˆ†ç‰‡ç­–ç•¥


**èŒƒå›´åˆ†ç‰‡**æŒ‰æ•°æ®å€¼çš„èŒƒå›´åˆ’åˆ†ï¼Œå°±åƒå›¾ä¹¦é¦†æŒ‰å­—æ¯é¡ºåºåˆ†åŒºã€‚

```
è®¢å•è¡¨æŒ‰æ—¶é—´èŒƒå›´åˆ†ç‰‡ï¼š
â”œâ”€â”€ order_2024_01 (2024å¹´1æœˆè®¢å•)
â”œâ”€â”€ order_2024_02 (2024å¹´2æœˆè®¢å•)
â”œâ”€â”€ order_2024_03 (2024å¹´3æœˆè®¢å•)
â””â”€â”€ ...

æŸ¥è¯¢è·¯ç”±é€»è¾‘ï¼š
WHERE create_time >= '2024-02-01' 
  AND create_time < '2024-03-01'
â†’ è·¯ç”±åˆ° order_2024_02

WHERE create_time >= '2024-01-15' 
  AND create_time < '2024-02-15'  
â†’ è·¯ç”±åˆ° order_2024_01 + order_2024_02 (è·¨ç‰‡æŸ¥è¯¢)
```

---

## 3. ğŸ—ºï¸ è·¯ç”±è§„åˆ™è®¾è®¡


### 3.1 è·¯ç”±è§„åˆ™åˆ†ç±»


è·¯ç”±è§„åˆ™å°±åƒäº¤é€šæŒ‡æŒ¥å‘˜ï¼Œå†³å®šæ¯ä¸ªæŸ¥è¯¢è¯·æ±‚åº”è¯¥å»å“ªä¸ªåˆ†ç‰‡ã€‚

**ğŸ”¸ è·¯ç”±è§„åˆ™ç±»å‹å¯¹æ¯”**

| è§„åˆ™ç±»å‹ | **å®ç°å¤æ‚åº¦** | **æŸ¥è¯¢æ€§èƒ½** | **æ‰©å±•æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|---------------|------------|-----------|-------------|
| ğŸ¯ **ç²¾ç¡®è·¯ç”±** | `ğŸŸ¢ç®€å•` | `ğŸŸ¢æœ€ä¼˜` | `ğŸŸ¡ä¸­ç­‰` | `å•åˆ†ç‰‡é”®æŸ¥è¯¢` |
| ğŸ” **èŒƒå›´è·¯ç”±** | `ğŸŸ¡ä¸­ç­‰` | `ğŸŸ¡ä¸­ç­‰` | `ğŸŸ¢è‰¯å¥½` | `èŒƒå›´æŸ¥è¯¢` |
| ğŸŒ **å¹¿æ’­è·¯ç”±** | `ğŸŸ¢ç®€å•` | `ğŸ”´æœ€å·®` | `ğŸŸ¢è‰¯å¥½` | `å…¨è¡¨æ‰«ææŸ¥è¯¢` |
| ğŸ§® **å¤åˆè·¯ç”±** | `ğŸ”´å¤æ‚` | `ğŸŸ¡ä¸­ç­‰` | `ğŸŸ¡ä¸­ç­‰` | `å¤šæ¡ä»¶å¤åˆæŸ¥è¯¢` |

### 3.2 è·¯ç”±è§„åˆ™å®ç°é€»è¾‘


**ç²¾ç¡®è·¯ç”±å®ç°**

```java
public class ShardingRouter {
    private int shardCount = 8;
    
    // ç®€å•å“ˆå¸Œè·¯ç”±
    public String routeByUserId(long userId) {
        int shardIndex = (int)(userId % shardCount);
        return "user_" + shardIndex;
    }
    
    // ç¤ºä¾‹æŸ¥è¯¢
    // SELECT * FROM users WHERE user_id = 12345
    // è·¯ç”±ç»“æœï¼šuser_1 åˆ†ç‰‡
}
```

**èŒƒå›´è·¯ç”±å®ç°**

```java
public class TimeBasedRouter {
    
    public List<String> routeByTimeRange(Date startTime, Date endTime) {
        List<String> targetShards = new ArrayList<>();
        
        // æŒ‰æœˆåˆ†ç‰‡çš„è·¯ç”±é€»è¾‘
        Calendar cal = Calendar.getInstance();
        cal.setTime(startTime);
        
        while (cal.getTime().before(endTime)) {
            String shardName = String.format("order_%04d_%02d", 
                cal.get(Calendar.YEAR), 
                cal.get(Calendar.MONTH) + 1);
            targetShards.add(shardName);
            cal.add(Calendar.MONTH, 1);
        }
        
        return targetShards;
    }
}
```

### 3.3 å¤åˆæ¡ä»¶è·¯ç”±


å½“æŸ¥è¯¢æ¡ä»¶æ¶‰åŠå¤šä¸ªå­—æ®µæ—¶ï¼Œè·¯ç”±å˜å¾—å¤æ‚ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘æ‰€æœ‰æ¡ä»¶ã€‚

```sql
-- å¤æ‚æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM orders 
WHERE user_id = 12345 
  AND create_time >= '2024-01-01' 
  AND status = 'completed'
  AND amount > 1000;

-- è·¯ç”±åˆ†æè¿‡ç¨‹
1ï¸âƒ£ æ£€æŸ¥user_idæ¡ä»¶ â†’ å¯ä»¥ç²¾ç¡®è·¯ç”±åˆ°ç‰¹å®šåˆ†ç‰‡
2ï¸âƒ£ æ£€æŸ¥æ—¶é—´æ¡ä»¶ â†’ å¯èƒ½è·¨è¶Šå¤šä¸ªæ—¶é—´åˆ†ç‰‡
3ï¸âƒ£ åˆå¹¶è·¯ç”±ç»“æœ â†’ å–äº¤é›†å¾—åˆ°æœ€ç»ˆç›®æ ‡åˆ†ç‰‡
```

**æ™ºèƒ½è·¯ç”±å†³ç­–æ ‘**

```
æŸ¥è¯¢æ¡ä»¶åˆ†æ
â”œâ”€â”€ åŒ…å«åˆ†ç‰‡é”®ï¼Ÿ
â”‚   â”œâ”€â”€ æ˜¯ â†’ ç²¾ç¡®è·¯ç”±
â”‚   â”‚   â””â”€â”€ è®¡ç®—ç›®æ ‡åˆ†ç‰‡
â”‚   â””â”€â”€ å¦ â†’ ç»§ç»­åˆ†æ
â”‚       â”œâ”€â”€ åŒ…å«èŒƒå›´æ¡ä»¶ï¼Ÿ
â”‚       â”‚   â”œâ”€â”€ æ˜¯ â†’ èŒƒå›´è·¯ç”±
â”‚       â”‚   â””â”€â”€ å¦ â†’ å¹¿æ’­è·¯ç”±
â”‚       â””â”€â”€ è¯„ä¼°æŸ¥è¯¢æˆæœ¬
```

---

## 4. ğŸ”— è·¨ç‰‡æŸ¥è¯¢å¤„ç†


### 4.1 è·¨ç‰‡æŸ¥è¯¢çš„æŒ‘æˆ˜


è·¨ç‰‡æŸ¥è¯¢å°±åƒåŒæ—¶åœ¨å¤šä¸ªå›¾ä¹¦é¦†æ‰¾èµ„æ–™ï¼Œéœ€è¦åè°ƒå„ä¸ªå›¾ä¹¦é¦†çš„æœç´¢ç»“æœã€‚

**è·¨ç‰‡æŸ¥è¯¢å…¸å‹åœºæ™¯**

```sql
-- åœºæ™¯1ï¼šç”¨æˆ·ç»´åº¦ç»Ÿè®¡
SELECT COUNT(*) FROM orders WHERE status = 'pending';
-- é—®é¢˜ï¼šstatusä¸æ˜¯åˆ†ç‰‡é”®ï¼Œéœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡

-- åœºæ™¯2ï¼šæ—¶é—´èŒƒå›´æŸ¥è¯¢
SELECT * FROM orders 
WHERE create_time BETWEEN '2024-01-15' AND '2024-02-15';
-- é—®é¢˜ï¼šè·¨è¶Šä¸¤ä¸ªæœˆä»½åˆ†ç‰‡

-- åœºæ™¯3ï¼šJOINå…³è”æŸ¥è¯¢
SELECT u.name, o.amount 
FROM users u JOIN orders o ON u.user_id = o.user_id
WHERE o.status = 'completed';
-- é—®é¢˜ï¼šä¸¤è¡¨å¯èƒ½ä½¿ç”¨ä¸åŒåˆ†ç‰‡ç­–ç•¥
```

### 4.2 è·¨ç‰‡æŸ¥è¯¢æ‰§è¡Œæµç¨‹


```
è·¨ç‰‡æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼š

å®¢æˆ·ç«¯æŸ¥è¯¢è¯·æ±‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è·¯ç”±è§£æå™¨     â”‚ â† åˆ†æSQLç¡®å®šæ¶‰åŠçš„åˆ†ç‰‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æŸ¥è¯¢åˆ†å‘å™¨     â”‚ â† å°†æŸ¥è¯¢å‘é€åˆ°å¤šä¸ªåˆ†ç‰‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç»“æœæ”¶é›†å™¨     â”‚ â† æ”¶é›†å„åˆ†ç‰‡çš„æ‰§è¡Œç»“æœ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åˆå¹¶å™¨     â”‚ â† åˆå¹¶ã€æ’åºã€åˆ†é¡µå¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    æœ€ç»ˆæŸ¥è¯¢ç»“æœ
```

### 4.3 è·¨ç‰‡æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ æŸ¥è¯¢ä¸‹æ¨ä¼˜åŒ–**

```sql
-- åŸå§‹æŸ¥è¯¢
SELECT user_id, COUNT(*) as order_count
FROM orders 
WHERE create_time >= '2024-01-01'
GROUP BY user_id
HAVING COUNT(*) > 10
ORDER BY order_count DESC
LIMIT 100;

-- ä¼˜åŒ–ï¼šå°†éƒ¨åˆ†è®¡ç®—ä¸‹æ¨åˆ°å„åˆ†ç‰‡
å„åˆ†ç‰‡æ‰§è¡Œï¼š
SELECT user_id, COUNT(*) as order_count
FROM orders_shard_x 
WHERE create_time >= '2024-01-01'
GROUP BY user_id
HAVING COUNT(*) > 5;  -- é¢„ç­›é€‰é™ä½ä¼ è¾“é‡

è·¯ç”±å±‚åˆå¹¶ï¼š
SELECT user_id, SUM(order_count) as total_count
FROM (å„åˆ†ç‰‡ç»“æœ)
GROUP BY user_id
HAVING SUM(order_count) > 10
ORDER BY total_count DESC
LIMIT 100;
```

---

## 5. ğŸ“Š åˆ†ç‰‡èšåˆä¼˜åŒ–


### 5.1 èšåˆæŸ¥è¯¢çš„åˆ†ç±»å¤„ç†


ä¸åŒç±»å‹çš„èšåˆå‡½æ•°éœ€è¦ä¸åŒçš„å¤„ç†ç­–ç•¥ï¼Œå°±åƒä¸åŒçš„æ•°å­¦è¿ç®—æœ‰ä¸åŒçš„è§„åˆ™ã€‚

**ğŸ”¸ èšåˆå‡½æ•°åˆ†ç±»å¤„ç†ç­–ç•¥**

| èšåˆç±»å‹ | **å¤„ç†æ–¹å¼** | **å¤æ‚åº¦** | **ç¤ºä¾‹** |
|---------|------------|-----------|---------|
| ğŸ“ˆ **å¯åˆ†è§£èšåˆ** | `å„ç‰‡è®¡ç®—ååˆå¹¶` | `ğŸŸ¢ç®€å•` | `SUM, COUNT, MAX, MIN` |
| ğŸ§® **éƒ¨åˆ†å¯åˆ†è§£** | `éœ€è¦é¢å¤–ä¿¡æ¯åˆå¹¶` | `ğŸŸ¡ä¸­ç­‰` | `AVGéœ€è¦SUMå’ŒCOUNT` |
| ğŸ”„ **ä¸å¯åˆ†è§£** | `éœ€è¦å…¨é‡æ•°æ®è®¡ç®—` | `ğŸ”´å›°éš¾` | `DISTINCT, MEDIAN` |

### 5.2 å¯åˆ†è§£èšåˆä¼˜åŒ–


**SUM/COUNTèšåˆä¼˜åŒ–**

```sql
-- åŸå§‹æŸ¥è¯¢ï¼šç»Ÿè®¡æ€»è®¢å•é‡‘é¢
SELECT SUM(amount) FROM orders WHERE status = 'completed';

-- åˆ†ç‰‡æ‰§è¡Œæ–¹æ¡ˆ
æ­¥éª¤ 1ï¸âƒ£ å„åˆ†ç‰‡å¹¶è¡Œæ‰§è¡Œï¼š
order_0: SELECT SUM(amount) as sum_0 FROM order_0 WHERE status = 'completed';
order_1: SELECT SUM(amount) as sum_1 FROM order_1 WHERE status = 'completed';
...
order_7: SELECT SUM(amount) as sum_7 FROM order_7 WHERE status = 'completed';

æ­¥éª¤ 2ï¸âƒ£ è·¯ç”±å±‚åˆå¹¶ï¼š
final_sum = sum_0 + sum_1 + ... + sum_7
```

**å¹³å‡å€¼èšåˆä¼˜åŒ–**

```sql
-- å¹³å‡å€¼éœ€è¦ç‰¹æ®Šå¤„ç†
SELECT AVG(amount) FROM orders WHERE status = 'completed';

-- ä¼˜åŒ–æ–¹æ¡ˆï¼šåˆ†åˆ«è·å–SUMå’ŒCOUNT
å„åˆ†ç‰‡æ‰§è¡Œï¼š
SELECT SUM(amount) as sum_val, COUNT(*) as count_val 
FROM order_x WHERE status = 'completed';

è·¯ç”±å±‚è®¡ç®—ï¼š
total_sum = sum_0 + sum_1 + ... + sum_7
total_count = count_0 + count_1 + ... + count_7
final_avg = total_sum / total_count
```

### 5.3 å¤æ‚èšåˆå¤„ç†


**DISTINCTå»é‡èšåˆ**

```sql
-- ç»Ÿè®¡ä¸åŒç”¨æˆ·æ•°é‡
SELECT COUNT(DISTINCT user_id) FROM orders;

-- å¤„ç†æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä½å›¾
å„åˆ†ç‰‡è¿”å›ï¼šç”¨æˆ·IDçš„ä½å›¾
è·¯ç”±å±‚åˆå¹¶ï¼šåˆå¹¶æ‰€æœ‰ä½å›¾ï¼Œç»Ÿè®¡ç½®1çš„ä½æ•°

-- å¤„ç†æ–¹æ¡ˆ2ï¼šä½¿ç”¨HyperLogLog
å„åˆ†ç‰‡è¿”å›ï¼šHyperLogLogæ‘˜è¦
è·¯ç”±å±‚åˆå¹¶ï¼šåˆå¹¶æ‘˜è¦ä¼°ç®—å»é‡æ•°é‡
```

---

## 6. âš¡ è·¯ç”±æ€§èƒ½ä¼˜åŒ–


### 6.1 è·¯ç”±ç¼“å­˜ç­–ç•¥


è·¯ç”±è®¡ç®—ç»“æœå¯ä»¥ç¼“å­˜ï¼Œå°±åƒGPSå¯¼èˆªä¼šè®°ä½ç»å¸¸èµ°çš„è·¯çº¿ã€‚

```java
public class RouterCache {
    private Map<String, String> routeCache = new ConcurrentHashMap<>();
    
    public String getRoute(String sql, Object[] params) {
        // ç”Ÿæˆç¼“å­˜key
        String cacheKey = generateCacheKey(sql, params);
        
        // å…ˆæŸ¥ç¼“å­˜
        String route = routeCache.get(cacheKey);
        if (route != null) {
            return route;  // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°è®¡ç®—
        route = calculateRoute(sql, params);
        routeCache.put(cacheKey, route);
        
        return route;
    }
    
    // å‚æ•°åŒ–æŸ¥è¯¢çš„ç¼“å­˜keyç”Ÿæˆ
    private String generateCacheKey(String sql, Object[] params) {
        StringBuilder key = new StringBuilder(sql);
        for (Object param : params) {
            key.append("|").append(param);
        }
        return key.toString();
    }
}
```

### 6.2 SQLè§£æä¼˜åŒ–


**ğŸ”¸ SQLè§£ææ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

```
é¢„ç¼–è¯‘SQLæ¨¡æ¿ï¼š
â”œâ”€â”€ è§£æSQLè¯­æ³•æ ‘
â”œâ”€â”€ æå–åˆ†ç‰‡é”®ä½ç½®
â”œâ”€â”€ ç”Ÿæˆè·¯ç”±è®¡ç®—æ¨¡æ¿
â””â”€â”€ ç¼“å­˜è§£æç»“æœ

å‚æ•°ç»‘å®šè·¯ç”±ï¼š
â”œâ”€â”€ ä½¿ç”¨é¢„ç¼–è¯‘æ¨¡æ¿
â”œâ”€â”€ å¿«é€Ÿæå–åˆ†ç‰‡é”®å€¼
â”œâ”€â”€ ç›´æ¥è®¡ç®—ç›®æ ‡åˆ†ç‰‡
â””â”€â”€ è·³è¿‡é‡å¤è§£æè¿‡ç¨‹

æ€§èƒ½æå‡ï¼š
è§£æè€—æ—¶ï¼š100ms â†’ 1ms (100å€æå‡)
å†…å­˜å ç”¨ï¼šå‡å°‘é‡å¤è§£æå¯¹è±¡
CPUä½¿ç”¨ï¼šé™ä½è§£æè®¡ç®—å¼€é”€
```

### 6.3 è¿æ¥æ± ä¼˜åŒ–


**åˆ†ç‰‡è¿æ¥æ± ç®¡ç†**

```java
public class ShardConnectionManager {
    // æ¯ä¸ªåˆ†ç‰‡ç»´æŠ¤ç‹¬ç«‹çš„è¿æ¥æ± 
    private Map<String, DataSource> shardDataSources;
    
    public void initShardPools() {
        for (int i = 0; i < shardCount; i++) {
            HikariConfig config = new HikariConfig();
            config.setJdbcUrl("jdbc:mysql://shard" + i + ":3306/db");
            config.setMaximumPoolSize(20);      // æ¯åˆ†ç‰‡20ä¸ªè¿æ¥
            config.setMinimumIdle(5);           // æœ€å°ç©ºé—²è¿æ¥
            config.setConnectionTimeout(30000); // è¿æ¥è¶…æ—¶30ç§’
            config.setIdleTimeout(600000);      // ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
            
            shardDataSources.put("shard_" + i, new HikariDataSource(config));
        }
    }
    
    // è·å–æŒ‡å®šåˆ†ç‰‡çš„è¿æ¥
    public Connection getConnection(String shardName) {
        return shardDataSources.get(shardName).getConnection();
    }
}
```

### 6.4 å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–


**ğŸ”¸ å¹¶è¡ŒæŸ¥è¯¢æ‰§è¡Œæ¨¡å‹**

```
ä¸²è¡Œæ‰§è¡Œæ¨¡å¼ï¼š
æŸ¥è¯¢åˆ†ç‰‡1 â†’ æŸ¥è¯¢åˆ†ç‰‡2 â†’ æŸ¥è¯¢åˆ†ç‰‡3 â†’ åˆå¹¶ç»“æœ
æ€»è€—æ—¶ = T1 + T2 + T3 + T_merge

å¹¶è¡Œæ‰§è¡Œæ¨¡å¼ï¼š
     â”Œâ†’ æŸ¥è¯¢åˆ†ç‰‡1 â”€â”€â”€â”€â”
æŸ¥è¯¢ â”œâ†’ æŸ¥è¯¢åˆ†ç‰‡2 â”€â”€â”€â”€â”¤ åˆå¹¶ç»“æœ
     â””â†’ æŸ¥è¯¢åˆ†ç‰‡3 â”€â”€â”€â”€â”˜
æ€»è€—æ—¶ = MAX(T1, T2, T3) + T_merge

æ€§èƒ½æå‡ï¼š3-8å€æŸ¥è¯¢é€Ÿåº¦æå‡
```

```java
public class ParallelQueryExecutor {
    private ExecutorService executor = Executors.newFixedThreadPool(16);
    
    public List<ResultSet> executeParallel(List<String> shards, String sql) {
        List<Future<ResultSet>> futures = new ArrayList<>();
        
        // å¹¶è¡Œæäº¤æŸ¥è¯¢ä»»åŠ¡
        for (String shard : shards) {
            futures.add(executor.submit(() -> {
                Connection conn = getConnection(shard);
                return conn.prepareStatement(sql).executeQuery();
            }));
        }
        
        // æ”¶é›†æ‰€æœ‰ç»“æœ
        List<ResultSet> results = new ArrayList<>();
        for (Future<ResultSet> future : futures) {
            results.add(future.get()); // ç­‰å¾…å¹¶è·å–ç»“æœ
        }
        
        return results;
    }
}
```

---

## 7. ğŸ”„ åˆ†ç‰‡äº‹åŠ¡å¤„ç†


### 7.1 äº‹åŠ¡ç±»å‹åˆ†ç±»


åˆ†ç‰‡äº‹åŠ¡æ¯”å•æœºäº‹åŠ¡å¤æ‚å¾—å¤šï¼Œå°±åƒåŒæ—¶åè°ƒå¤šä¸ªé“¶è¡Œå®Œæˆè½¬è´¦ã€‚

**ğŸ”¸ åˆ†ç‰‡äº‹åŠ¡åˆ†ç±»**

```
å•åˆ†ç‰‡äº‹åŠ¡ï¼š
â”œâ”€â”€ æ‰€æœ‰æ“ä½œéƒ½åœ¨åŒä¸€ä¸ªåˆ†ç‰‡å†…
â”œâ”€â”€ å¤„ç†æ–¹å¼ï¼šç›´æ¥ä½¿ç”¨æœ¬åœ°äº‹åŠ¡
â”œâ”€â”€ æ€§èƒ½ï¼šä¸å•æœºäº‹åŠ¡ç›¸åŒ
â””â”€â”€ ç¤ºä¾‹ï¼šæ›´æ–°å•ä¸ªç”¨æˆ·çš„ä¿¡æ¯

è·¨ç‰‡è¯»äº‹åŠ¡ï¼š
â”œâ”€â”€ è¯»å–å¤šä¸ªåˆ†ç‰‡çš„æ•°æ®
â”œâ”€â”€ å¤„ç†æ–¹å¼ï¼šå¿«ç…§è¯»ï¼Œä¸éœ€è¦é”
â”œâ”€â”€ æ€§èƒ½ï¼šè¾ƒå¥½ï¼Œä¸»è¦æ˜¯ç½‘ç»œå»¶è¿Ÿ
â””â”€â”€ ç¤ºä¾‹ï¼šç»Ÿè®¡å¤šä¸ªåˆ†ç‰‡çš„æ•°æ®

è·¨ç‰‡å†™äº‹åŠ¡ï¼š
â”œâ”€â”€ ä¿®æ”¹å¤šä¸ªåˆ†ç‰‡çš„æ•°æ®
â”œâ”€â”€ å¤„ç†æ–¹å¼ï¼šä¸¤é˜¶æ®µæäº¤(2PC)æˆ–è¡¥å¿äº‹åŠ¡
â”œâ”€â”€ æ€§èƒ½ï¼šå·®ï¼Œéœ€è¦åè°ƒå¤šä¸ªåˆ†ç‰‡
â””â”€â”€ ç¤ºä¾‹ï¼šç”¨æˆ·è½¬è´¦ç»™å…¶ä»–ç”¨æˆ·
```

### 7.2 ä¸¤é˜¶æ®µæäº¤(2PC)


**ä¸¤é˜¶æ®µæäº¤**å°±åƒç»„ç»‡å¤šäººèšé¤ï¼Œå…ˆé—®å¤§å®¶èƒ½ä¸èƒ½æ¥ï¼Œéƒ½ç¡®è®¤åå†å®šé¤å…ã€‚

```
2PCæ‰§è¡Œæµç¨‹ï¼š

å‡†å¤‡é˜¶æ®µ (Phase 1)ï¼š
åè°ƒè€…                    å‚ä¸è€…åˆ†ç‰‡
   |                          |
   |--[1]å‡†å¤‡äº‹åŠ¡è¯·æ±‚--------->|åˆ†ç‰‡1
   |<-[2]å‡†å¤‡å°±ç»ª(YES)--------|
   |                          |
   |--[3]å‡†å¤‡äº‹åŠ¡è¯·æ±‚--------->|åˆ†ç‰‡2
   |<-[4]å‡†å¤‡å°±ç»ª(YES)--------|

æäº¤é˜¶æ®µ (Phase 2)ï¼š
   |--[5]æäº¤äº‹åŠ¡è¯·æ±‚--------->|åˆ†ç‰‡1
   |<-[6]æäº¤å®Œæˆç¡®è®¤---------|
   |                          |
   |--[7]æäº¤äº‹åŠ¡è¯·æ±‚--------->|åˆ†ç‰‡2
   |<-[8]æäº¤å®Œæˆç¡®è®¤---------|
```

**2PCå®ç°ç¤ºä¾‹**

```java
public class TwoPhaseCommitManager {
    
    public boolean executeDistributedTransaction(
        List<String> shards, 
        List<String> sqls) {
        
        List<Connection> connections = new ArrayList<>();
        
        try {
            // é˜¶æ®µ1ï¼šå‡†å¤‡æ‰€æœ‰åˆ†ç‰‡
            for (int i = 0; i < shards.size(); i++) {
                Connection conn = getConnection(shards.get(i));
                conn.setAutoCommit(false);  // å¼€å¯äº‹åŠ¡
                conn.prepareStatement(sqls.get(i)).executeUpdate();
                connections.add(conn);
            }
            
            // é˜¶æ®µ2ï¼šæäº¤æ‰€æœ‰åˆ†ç‰‡
            for (Connection conn : connections) {
                conn.commit();  // æäº¤äº‹åŠ¡
            }
            
            return true;
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šæ‰€æœ‰åˆ†ç‰‡
            for (Connection conn : connections) {
                try {
                    conn.rollback();
                } catch (SQLException ex) {
                    // è®°å½•å›æ»šå¤±è´¥çš„åˆ†ç‰‡ï¼Œéœ€è¦äººå·¥å¤„ç†
                    logRollbackFailure(conn, ex);
                }
            }
            return false;
        }
    }
}
```

### 7.3 è¡¥å¿äº‹åŠ¡æ¨¡å¼


**è¡¥å¿äº‹åŠ¡**é‡‡ç”¨"å…ˆæ‰§è¡Œï¼Œå‡ºé”™å†è¡¥å¿"çš„ç­–ç•¥ï¼Œå°±åƒå…ˆè®°è´¦ï¼Œå‘ç°é”™è¯¯å†å†²æ­£ã€‚

```java
public class CompensationTransaction {
    
    public boolean executeWithCompensation(List<TransactionStep> steps) {
        List<TransactionStep> executedSteps = new ArrayList<>();
        
        try {
            // é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            for (TransactionStep step : steps) {
                step.execute();
                executedSteps.add(step);
            }
            return true;
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸ï¼Œé€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
            for (int i = executedSteps.size() - 1; i >= 0; i--) {
                try {
                    executedSteps.get(i).compensate();
                } catch (Exception ex) {
                    // è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ï¼Œå¯èƒ½éœ€è¦äººå·¥å¤„ç†
                    logCompensationFailure(executedSteps.get(i), ex);
                }
            }
            return false;
        }
    }
}

// äº‹åŠ¡æ­¥éª¤æ¥å£
interface TransactionStep {
    void execute() throws Exception;     // æ‰§è¡Œæ“ä½œ
    void compensate() throws Exception;  // è¡¥å¿æ“ä½œ
}
```

---

## 8. ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯


### 8.1 ç”µå•†è®¢å•ç³»ç»Ÿåˆ†ç‰‡


**ä¸šåŠ¡åœºæ™¯**ï¼šç”µå•†å¹³å°æ—¥è®¢å•é‡ç™¾ä¸‡çº§ï¼Œéœ€è¦åˆ†ç‰‡å­˜å‚¨ã€‚

```sql
-- è®¢å•è¡¨åˆ†ç‰‡ç­–ç•¥
åˆ†ç‰‡é”®ï¼šuser_id
åˆ†ç‰‡æ•°é‡ï¼š32ä¸ª
åˆ†ç‰‡ç®—æ³•ï¼šuser_id % 32

-- å¸¸è§æŸ¥è¯¢ä¼˜åŒ–
æŸ¥è¯¢ç±»å‹1ï¼šç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¢å•
SELECT * FROM orders WHERE user_id = ? ORDER BY create_time DESC;
è·¯ç”±ç­–ç•¥ï¼šç²¾ç¡®è·¯ç”±åˆ°å•ä¸ªåˆ†ç‰‡
æ€§èƒ½ï¼šğŸŸ¢ ä¼˜ç§€

æŸ¥è¯¢ç±»å‹2ï¼šå•†å®¶æŸ¥çœ‹è®¢å•ç»Ÿè®¡
SELECT DATE(create_time), COUNT(*), SUM(amount) 
FROM orders 
WHERE seller_id = ? AND create_time >= ?
GROUP BY DATE(create_time);
è·¯ç”±ç­–ç•¥ï¼šå¹¿æ’­åˆ°æ‰€æœ‰åˆ†ç‰‡ï¼Œèšåˆç»“æœ
æ€§èƒ½ï¼šğŸŸ¡ ä¸­ç­‰

æŸ¥è¯¢ç±»å‹3ï¼šå¹³å°è¿è¥ç»Ÿè®¡
SELECT status, COUNT(*) FROM orders 
WHERE create_time >= ? 
GROUP BY status;
è·¯ç”±ç­–ç•¥ï¼šå¹¿æ’­æŸ¥è¯¢ + åˆ†ç‰‡èšåˆ
æ€§èƒ½ï¼šğŸ”´ è¾ƒå·®ï¼Œä½†å¯æ¥å—
```

### 8.2 ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿ


**ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·è¡Œä¸ºæ—¥å¿—åˆ†æï¼ŒæŒ‰æ—¶é—´åˆ†ç‰‡å­˜å‚¨ã€‚

```
åˆ†ç‰‡ç­–ç•¥è®¾è®¡ï¼š

æ—¶é—´ç»´åº¦åˆ†ç‰‡ï¼š
â”œâ”€â”€ user_behavior_2024_01 (1æœˆæ•°æ®)
â”œâ”€â”€ user_behavior_2024_02 (2æœˆæ•°æ®)
â”œâ”€â”€ user_behavior_2024_03 (3æœˆæ•°æ®)
â””â”€â”€ ...

äºŒçº§åˆ†ç‰‡ç­–ç•¥ï¼š
æ¯æœˆæ•°æ®å†æŒ‰user_idå“ˆå¸Œåˆ†æˆ8ä¸ªå­åˆ†ç‰‡
â”œâ”€â”€ user_behavior_2024_01_0
â”œâ”€â”€ user_behavior_2024_01_1
â”œâ”€â”€ ...
â””â”€â”€ user_behavior_2024_01_7
```

**æŸ¥è¯¢è·¯ç”±ä¼˜åŒ–å®ç°**

```java
public class BehaviorAnalysisRouter {
    
    public List<String> routeQuery(String sql, Date startTime, Date endTime, Long userId) {
        List<String> targetShards = new ArrayList<>();
        
        // æ ¹æ®æ—¶é—´èŒƒå›´ç¡®å®šæœˆä»½åˆ†ç‰‡
        List<String> monthShards = getMonthShards(startTime, endTime);
        
        // å¦‚æœæŒ‡å®šäº†ç”¨æˆ·IDï¼Œè¿›ä¸€æ­¥ç¡®å®šå­åˆ†ç‰‡
        if (userId != null) {
            int subShard = (int)(userId % 8);
            for (String monthShard : monthShards) {
                targetShards.add(monthShard + "_" + subShard);
            }
        } else {
            // æ²¡æœ‰ç”¨æˆ·IDé™åˆ¶ï¼Œéœ€è¦æŸ¥è¯¢æ‰€æœ‰å­åˆ†ç‰‡
            for (String monthShard : monthShards) {
                for (int i = 0; i < 8; i++) {
                    targetShards.add(monthShard + "_" + i);
                }
            }
        }
        
        return targetShards;
    }
}
```

### 8.3 é‡‘èäº¤æ˜“ç³»ç»Ÿåˆ†ç‰‡


**ä¸šåŠ¡ç‰¹ç‚¹**ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜ï¼Œäº‹åŠ¡å¤„ç†å¤æ‚ã€‚

```sql
-- è½¬è´¦ä¸šåŠ¡çš„è·¨ç‰‡äº‹åŠ¡å¤„ç†

åŸå§‹ä¸šåŠ¡é€»è¾‘ï¼š
BEGIN;
UPDATE accounts SET balance = balance - 1000 WHERE user_id = 12345;
UPDATE accounts SET balance = balance + 1000 WHERE user_id = 67890;
COMMIT;

åˆ†ç‰‡åçš„æŒ‘æˆ˜ï¼š
ç”¨æˆ·12345 â†’ è·¯ç”±åˆ° account_1 åˆ†ç‰‡
ç”¨æˆ·67890 â†’ è·¯ç”±åˆ° account_6 åˆ†ç‰‡
éœ€è¦ä¿è¯ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§

è§£å†³æ–¹æ¡ˆï¼š
æ–¹æ¡ˆAï¼šä¸¤é˜¶æ®µæäº¤ç¡®ä¿å¼ºä¸€è‡´æ€§
æ–¹æ¡ˆBï¼šTCCäº‹åŠ¡æ¨¡å¼(Try-Confirm-Cancel)
æ–¹æ¡ˆCï¼šäº‹ä»¶é©±åŠ¨çš„æœ€ç»ˆä¸€è‡´æ€§
```

**TCCäº‹åŠ¡æ¨¡å¼å®ç°**

```java
public class TransferTCCTransaction {
    
    // Tryé˜¶æ®µï¼šé¢„ç•™èµ„æº
    public boolean tryTransfer(long fromUser, long toUser, BigDecimal amount) {
        try {
            // å†»ç»“è½¬å‡ºè´¦æˆ·èµ„é‡‘
            freezeBalance(fromUser, amount);
            // é¢„ç•™è½¬å…¥è´¦æˆ·é¢åº¦
            reserveBalance(toUser, amount);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    // Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œ
    public void confirmTransfer(long fromUser, long toUser, BigDecimal amount) {
        // æ‰£é™¤å†»ç»“èµ„é‡‘
        deductFrozenBalance(fromUser, amount);
        // å¢åŠ é¢„ç•™èµ„é‡‘
        addReservedBalance(toUser, amount);
    }
    
    // Cancelé˜¶æ®µï¼šå–æ¶ˆæ“ä½œ
    public void cancelTransfer(long fromUser, long toUser, BigDecimal amount) {
        // è§£å†»è½¬å‡ºè´¦æˆ·èµ„é‡‘
        unFreezeBalance(fromUser, amount);
        // å–æ¶ˆè½¬å…¥è´¦æˆ·é¢„ç•™
        cancelReservedBalance(toUser, amount);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†ç‰‡è·¯ç”±ï¼šæ ¹æ®åˆ†ç‰‡é”®å¿«é€Ÿå®šä½ç›®æ ‡åˆ†ç‰‡
ğŸ”¸ è·¨ç‰‡æŸ¥è¯¢ï¼šåè°ƒå¤šä¸ªåˆ†ç‰‡å…±åŒå®ŒæˆæŸ¥è¯¢
ğŸ”¸ èšåˆä¼˜åŒ–ï¼šåˆç†å¤„ç†å„ç±»èšåˆå‡½æ•°çš„åˆ†ç‰‡è®¡ç®—
ğŸ”¸ äº‹åŠ¡å¤„ç†ï¼šä¿è¯è·¨ç‰‡æ“ä½œçš„æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ã€å¹¶è¡Œã€è¿æ¥æ± ç­‰ä¼˜åŒ–ç­–ç•¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åˆ†ç‰‡æŸ¥è¯¢çš„æœ¬è´¨æŒ‘æˆ˜**
```
è·¯ç”±å‡†ç¡®æ€§ï¼š
â”œâ”€â”€ å¿…é¡»å‡†ç¡®è®¡ç®—æŸ¥è¯¢æ¶‰åŠçš„åˆ†ç‰‡
â”œâ”€â”€ é”™è¯¯è·¯ç”±å¯¼è‡´æŸ¥è¯¢ç»“æœä¸å®Œæ•´
â””â”€â”€ éœ€è¦è€ƒè™‘æŸ¥è¯¢æ¡ä»¶çš„å¤æ‚ç»„åˆ

æ€§èƒ½å¹³è¡¡ï¼š
â”œâ”€â”€ å•åˆ†ç‰‡æŸ¥è¯¢ï¼šæ€§èƒ½æœ€ä¼˜
â”œâ”€â”€ å°‘é‡åˆ†ç‰‡æŸ¥è¯¢ï¼šæ€§èƒ½è‰¯å¥½
â”œâ”€â”€ å¤§é‡åˆ†ç‰‡æŸ¥è¯¢ï¼šæ€§èƒ½ä¸‹é™æ˜æ˜¾
â””â”€â”€ å…¨åˆ†ç‰‡æŸ¥è¯¢ï¼šæ¥è¿‘å•æœºå…¨è¡¨æ‰«æ
```

**ğŸ”¹ äº‹åŠ¡ä¸€è‡´æ€§çš„æƒè¡¡**
```
å¼ºä¸€è‡´æ€§(2PC)ï¼š
âœ… æ•°æ®ç»å¯¹æ­£ç¡®
âŒ æ€§èƒ½å¼€é”€å¤§ï¼Œå¯ç”¨æ€§å·®

æœ€ç»ˆä¸€è‡´æ€§(è¡¥å¿äº‹åŠ¡)ï¼š
âœ… æ€§èƒ½å¥½ï¼Œå¯ç”¨æ€§é«˜
âŒ çŸ­æœŸæ•°æ®å¯èƒ½ä¸ä¸€è‡´

é€‰æ‹©åŸåˆ™ï¼š
é‡‘èæ”¯ä»˜ â†’ å¼ºä¸€è‡´æ€§
ç¤¾äº¤ç³»ç»Ÿ â†’ æœ€ç»ˆä¸€è‡´æ€§
æ—¥å¿—ç»Ÿè®¡ â†’ æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ åˆ†ç‰‡èšåˆçš„ä¼˜åŒ–æ€è·¯**
```
è®¡ç®—ä¸‹æ¨ï¼šå°½é‡åœ¨åˆ†ç‰‡å†…å®Œæˆè®¡ç®—
ç»“æœåˆå¹¶ï¼šæœ€å°åŒ–ç½‘ç»œä¼ è¾“é‡
å¹¶è¡Œæ‰§è¡Œï¼šå……åˆ†åˆ©ç”¨å¤šåˆ†ç‰‡å¹¶å‘èƒ½åŠ›
ç¼“å­˜ä¼˜åŒ–ï¼šç¼“å­˜ä¸­é—´è®¡ç®—ç»“æœ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ æŠ€æœ¯é€‰å‹æŒ‡å¯¼**
- **åˆ†ç‰‡ç­–ç•¥**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åˆ†ç‰‡ç®—æ³•
- **è·¯ç”±è®¾è®¡**ï¼šå¹³è¡¡æŸ¥è¯¢æ€§èƒ½å’Œå®ç°å¤æ‚åº¦
- **äº‹åŠ¡å¤„ç†**ï¼šæ ¹æ®ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©åˆé€‚çš„äº‹åŠ¡æ¨¡å¼

**âš¡ æ€§èƒ½ä¼˜åŒ–å®è·µ**
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé€šè¿‡è·¯ç”±ä¼˜åŒ–å‡å°‘è·¨ç‰‡æŸ¥è¯¢
- **å¹¶å‘ä¼˜åŒ–**ï¼šåˆç†è®¾è®¡è¿æ¥æ± å’Œçº¿ç¨‹æ± 
- **ç¼“å­˜ä¼˜åŒ–**ï¼šç¼“å­˜è·¯ç”±è®¡ç®—å’ŒæŸ¥è¯¢ç»“æœ

**ğŸ”§ è¿ç»´ç®¡ç†ç»éªŒ**
- **ç›‘æ§æŒ‡æ ‡**ï¼šå…³æ³¨è·¨ç‰‡æŸ¥è¯¢æ¯”ä¾‹å’Œäº‹åŠ¡æˆåŠŸç‡
- **æ•…éšœå¤„ç†**ï¼šå»ºç«‹åˆ†ç‰‡æ•…éšœçš„åº”æ€¥é¢„æ¡ˆ
- **æ‰©å®¹ç­–ç•¥**ï¼šæ•°æ®è¿ç§»å’Œè·¯ç”±è§„åˆ™æ›´æ–°

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åˆ†ç‰‡æŸ¥è¯¢æ ¸å¿ƒæ˜¯è·¯ç”±å‡†ç¡®å’Œæ€§èƒ½å¹³è¡¡
- è·¨ç‰‡èšåˆéœ€è¦åˆç†è®¾è®¡è®¡ç®—ä¸‹æ¨ç­–ç•¥
- åˆ†ç‰‡äº‹åŠ¡å¿…é¡»åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½é—´åšæƒè¡¡
- å®é™…åº”ç”¨ä¸­è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆ