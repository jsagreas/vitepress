---
title: 3、日期时间时区函数
---
## 📚 目录

1. [日期时间函数概述](#1-日期时间函数概述)
2. [当前时间获取函数](#2-当前时间获取函数)
3. [日期格式化函数](#3-日期格式化函数)
4. [日期计算函数](#4-日期计算函数)
5. [时间提取函数](#5-时间提取函数)
6. [时间戳转换函数](#6-时间戳转换函数)
7. [时区转换函数](#7-时区转换函数)
8. [日期时间优化技巧](#8-日期时间优化技巧)
9. [核心要点总结](#9-核心要点总结)

---

## 1. ⏰ 日期时间函数概述


### 1.1 什么是日期时间函数


**简单理解**：日期时间函数就是MySQL提供的"**时间管家**"，帮你处理各种与时间相关的操作。

```
现实中的时间需求：                     MySQL函数解决：
我要知道现在几点？                     → NOW()
今天是几月几号？                       → CURDATE() 
这个月有多少天？                       → DAY(LAST_DAY(NOW()))
距离生日还有多久？                     → DATEDIFF('2024-06-15', NOW())
把时间格式改成中文？                   → DATE_FORMAT(NOW(), '%Y年%m月%d日')
```

**为什么需要日期时间函数**：
- 📅 **时间记录**：记录用户注册时间、订单创建时间
- 🔄 **时间计算**：计算会员到期时间、计算年龄
- 📊 **时间统计**：按月统计销售额、按周统计访问量
- 🌍 **时区处理**：不同地区用户看到本地时间

### 1.2 MySQL时间数据类型基础


```
MySQL时间类型家族：

📅 DATE：只存日期
   格式：'YYYY-MM-DD'
   范围：'1000-01-01' 到 '9999-12-31'
   示例：'2024-01-20'

⏰ TIME：只存时间
   格式：'HH:MM:SS'
   范围：'-838:59:59' 到 '838:59:59'
   示例：'14:30:25'

📅⏰ DATETIME：存日期+时间
   格式：'YYYY-MM-DD HH:MM:SS'
   范围：'1000-01-01 00:00:00' 到 '9999-12-31 23:59:59'
   示例：'2024-01-20 14:30:25'

⏱️ TIMESTAMP：时间戳
   格式：'YYYY-MM-DD HH:MM:SS'
   范围：'1970-01-01 00:00:01' 到 '2038-01-19 03:14:07'
   特点：自动跟随时区变化

🗓️ YEAR：只存年份
   格式：YYYY
   范围：1901 到 2155
   示例：2024
```

### 1.3 日期时间函数分类


```
日期时间函数分类图：

日期时间函数
├── 🕐 获取当前时间
│   ├── NOW()          ← 当前日期时间
│   ├── CURDATE()      ← 当前日期
│   └── CURTIME()      ← 当前时间
│
├── 🎨 格式化显示
│   ├── DATE_FORMAT()  ← 自定义格式
│   └── STR_TO_DATE()  ← 字符串转日期
│
├── 🧮 时间计算
│   ├── DATE_ADD()     ← 时间加法
│   ├── DATE_SUB()     ← 时间减法
│   └── DATEDIFF()     ← 时间差计算
│
├── 🔍 提取部分
│   ├── YEAR()         ← 提取年份
│   ├── MONTH()        ← 提取月份
│   └── DAY()          ← 提取日期
│
├── 🔄 时间戳转换
│   ├── UNIX_TIMESTAMP() ← 转时间戳
│   └── FROM_UNIXTIME()  ← 时间戳转日期
│
└── 🌍 时区处理
    ├── CONVERT_TZ()   ← 时区转换
    └── UTC_TIMESTAMP() ← UTC时间
```

---

## 2. 🕐 当前时间获取函数


### 2.1 NOW()函数详解


**🔸 什么是NOW()函数**

NOW()是MySQL中最常用的时间函数，返回当前的**日期和时间**，就像手机上显示的完整时间。

```sql
-- 基本使用
SELECT NOW();
-- 结果：2024-01-20 14:30:25

-- 在INSERT中使用
INSERT INTO orders (order_id, create_time) 
VALUES (1001, NOW());

-- 在UPDATE中使用
UPDATE users SET last_login = NOW() WHERE user_id = 123;
```

**🔹 NOW()函数特点**

- ⏰ **精确度**：返回到秒级精度
- 🔄 **实时性**：每次调用都获取最新时间
- 💾 **常用场景**：记录创建时间、更新时间

**💡 小技巧**：NOW()可以加数字参数指定小数秒精度

```sql
SELECT NOW(3);    -- 精确到毫秒
-- 结果：2024-01-20 14:30:25.123

SELECT NOW(6);    -- 精确到微秒  
-- 结果：2024-01-20 14:30:25.123456
```

### 2.2 CURDATE()当前日期函数


**🔸 什么是CURDATE()函数**

CURDATE()只返回当前**日期部分**，不包含时间，相当于日历上的今天。

```sql
-- 基本使用
SELECT CURDATE();
-- 结果：2024-01-20

-- 实际应用：查询今天注册的用户
SELECT * FROM users 
WHERE DATE(register_time) = CURDATE();

-- 实际应用：查询今天的订单
SELECT * FROM orders 
WHERE order_date = CURDATE();
```

**🔹 CURDATE()使用场景**

- 📅 **日期比较**：查询某天的数据
- 📊 **统计分析**：按日期统计
- 🔍 **条件筛选**：筛选特定日期数据

### 2.3 CURTIME()当前时间函数


**🔸 什么是CURTIME()函数**

CURTIME()只返回当前**时间部分**，不包含日期，相当于手表上的时分秒。

```sql
-- 基本使用
SELECT CURTIME();
-- 结果：14:30:25

-- 实际应用：记录操作时间
INSERT INTO logs (action, action_time) 
VALUES ('login', CURTIME());

-- 应用：判断是否在营业时间
SELECT 
  CASE 
    WHEN CURTIME() BETWEEN '09:00:00' AND '18:00:00' 
    THEN '营业中' 
    ELSE '休息中' 
  END AS business_status;
```

### 2.4 当前时间函数对比


| 函数 | 返回内容 | 格式示例 | 主要用途 |
|------|----------|----------|----------|
| **NOW()** | 完整日期时间 | `2024-01-20 14:30:25` | 完整时间戳记录 |
| **CURDATE()** | 仅日期 | `2024-01-20` | 日期比较和统计 |
| **CURTIME()** | 仅时间 | `14:30:25` | 时间段判断 |

```sql
-- 一次性查看三个函数结果
SELECT 
  NOW() AS 完整时间,
  CURDATE() AS 当前日期,
  CURTIME() AS 当前时间;
```

---

## 3. 🎨 日期格式化函数


### 3.1 DATE_FORMAT()格式化函数


**🔸 什么是DATE_FORMAT()函数**

DATE_FORMAT()就像是时间的"**化妆师**"，可以把时间打扮成各种你想要的样子。

```sql
-- 基本语法
DATE_FORMAT(日期, '格式字符串')

-- 基础示例
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d');
-- 结果：2024-01-20

SELECT DATE_FORMAT(NOW(), '%Y年%m月%d日');  
-- 结果：2024年01月20日

SELECT DATE_FORMAT(NOW(), '%W, %M %e, %Y');
-- 结果：Saturday, January 20, 2024
```

**🔹 常用格式符号详解**

| 格式符 | 说明 | 示例 |
|--------|------|------|
| **%Y** | 4位年份 | 2024 |
| **%y** | 2位年份 | 24 |
| **%m** | 2位月份 | 01, 12 |
| **%c** | 月份数字 | 1, 12 |
| **%M** | 月份英文名 | January |
| **%b** | 月份英文缩写 | Jan |
| **%d** | 2位日期 | 01, 31 |
| **%e** | 日期数字 | 1, 31 |
| **%H** | 24小时制小时 | 00-23 |
| **%h** | 12小时制小时 | 01-12 |
| **%i** | 分钟 | 00-59 |
| **%s** | 秒 | 00-59 |
| **%W** | 星期几英文 | Sunday |
| **%w** | 星期几数字 | 0-6 |

**🔹 实用格式化示例**

```sql
-- 中文日期格式
SELECT DATE_FORMAT(NOW(), '%Y年%m月%d日 %H时%i分%s秒') AS 中文时间;
-- 结果：2024年01月20日 14时30分25秒

-- 美式日期格式
SELECT DATE_FORMAT(NOW(), '%M %d, %Y') AS 美式日期;
-- 结果：January 20, 2024

-- 欧式日期格式
SELECT DATE_FORMAT(NOW(), '%d/%m/%Y') AS 欧式日期;
-- 结果：20/01/2024

-- 带星期的格式
SELECT DATE_FORMAT(NOW(), '%W, %Y-%m-%d') AS 带星期;
-- 结果：Saturday, 2024-01-20

-- 只要时间部分
SELECT DATE_FORMAT(NOW(), '%H:%i:%s') AS 时间;
-- 结果：14:30:25
```

### 3.2 STR_TO_DATE()字符串转日期


**🔸 什么是STR_TO_DATE()函数**

STR_TO_DATE()是DATE_FORMAT()的"**逆向操作**"，把字符串按指定格式转换成日期。

```sql
-- 基本语法
STR_TO_DATE('字符串', '格式字符串')

-- 基础示例
SELECT STR_TO_DATE('2024-01-20', '%Y-%m-%d');
-- 结果：2024-01-20

SELECT STR_TO_DATE('2024年01月20日', '%Y年%m月%d日');
-- 结果：2024-01-20

SELECT STR_TO_DATE('20/01/2024 14:30:25', '%d/%m/%Y %H:%i:%s');
-- 结果：2024-01-20 14:30:25
```

**🔹 实际应用场景**

```sql
-- 场景1：导入Excel数据时格式转换
INSERT INTO orders (order_date, amount)
SELECT 
  STR_TO_DATE(excel_date, '%d/%m/%Y'),
  amount
FROM temp_excel_data;

-- 场景2：用户输入格式不标准
SELECT * FROM events 
WHERE event_date = STR_TO_DATE('2024年1月20日', '%Y年%c月%e日');

-- 场景3：处理不同国家的日期格式
UPDATE users 
SET birth_date = STR_TO_DATE(birth_input, '%d.%m.%Y')  -- 德式格式
WHERE country = 'Germany';
```

---

## 4. 🧮 日期计算函数


### 4.1 DATE_ADD()时间加法


**🔸 什么是DATE_ADD()函数**

DATE_ADD()就像时间的"**计算器**"，可以给日期加上一段时间，比如"3天后"、"2个月后"。

```sql
-- 基本语法
DATE_ADD(日期, INTERVAL 数值 单位)

-- 基础示例
SELECT DATE_ADD(NOW(), INTERVAL 7 DAY) AS 一周后;
-- 结果：2024-01-27 14:30:25

SELECT DATE_ADD(CURDATE(), INTERVAL 1 MONTH) AS 下个月;
-- 结果：2024-02-20

SELECT DATE_ADD(NOW(), INTERVAL -3 HOUR) AS 三小时前;
-- 结果：2024-01-20 11:30:25
```

**🔹 时间单位说明**

| 单位 | 说明 | 示例 |
|------|------|------|
| **YEAR** | 年 | `INTERVAL 1 YEAR` |
| **MONTH** | 月 | `INTERVAL 3 MONTH` |
| **DAY** | 天 | `INTERVAL 7 DAY` |
| **HOUR** | 小时 | `INTERVAL 2 HOUR` |
| **MINUTE** | 分钟 | `INTERVAL 30 MINUTE` |
| **SECOND** | 秒 | `INTERVAL 45 SECOND` |
| **WEEK** | 周 | `INTERVAL 2 WEEK` |

**🔹 实际应用示例**

```sql
-- 应用1：计算VIP会员到期时间
UPDATE users 
SET vip_expire = DATE_ADD(NOW(), INTERVAL 1 YEAR)
WHERE user_id = 123;

-- 应用2：查询未来7天的预约
SELECT * FROM appointments 
WHERE appointment_time BETWEEN NOW() 
AND DATE_ADD(NOW(), INTERVAL 7 DAY);

-- 应用3：设置优惠券有效期
INSERT INTO coupons (code, expire_date)
VALUES ('SAVE20', DATE_ADD(CURDATE(), INTERVAL 30 DAY));

-- 应用4：计算项目截止时间
SELECT 
  project_name,
  start_date,
  DATE_ADD(start_date, INTERVAL duration DAY) AS deadline
FROM projects;
```

### 4.2 DATE_SUB()时间减法


**🔸 什么是DATE_SUB()函数**

DATE_SUB()是DATE_ADD()的反向操作，用来减去时间，比如"3天前"、"上个月"。

```sql
-- 基本语法
DATE_SUB(日期, INTERVAL 数值 单位)

-- 基础示例
SELECT DATE_SUB(NOW(), INTERVAL 3 DAY) AS 三天前;
-- 结果：2024-01-17 14:30:25

SELECT DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AS 上个月;
-- 结果：2023-12-20
```

**🔹 实际应用示例**

```sql
-- 查询最近30天的销售记录
SELECT * FROM sales 
WHERE sale_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY);

-- 查询上个月注册的用户
SELECT * FROM users 
WHERE register_date BETWEEN 
  DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND CURDATE();

-- 清理7天前的临时数据
DELETE FROM temp_data 
WHERE create_time < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 4.3 DATEDIFF()日期差计算


**🔸 什么是DATEDIFF()函数**

DATEDIFF()专门用来计算两个日期之间**相差多少天**，就像计算"距离生日还有几天"。

```sql
-- 基本语法
DATEDIFF(结束日期, 开始日期)

-- 基础示例
SELECT DATEDIFF('2024-02-01', '2024-01-20') AS 相差天数;
-- 结果：12

SELECT DATEDIFF(CURDATE(), '2024-01-01') AS 今年已过天数;
-- 结果：19（假设今天是1月20日）
```

**🔹 实际应用示例**

```sql
-- 计算用户年龄（按天计算）
SELECT 
  user_name,
  birth_date,
  FLOOR(DATEDIFF(CURDATE(), birth_date) / 365) AS age
FROM users;

-- 计算订单处理时长
SELECT 
  order_id,
  order_date,
  ship_date,
  DATEDIFF(ship_date, order_date) AS 处理天数
FROM orders
WHERE ship_date IS NOT NULL;

-- 查找即将到期的会员
SELECT 
  user_name,
  vip_expire,
  DATEDIFF(vip_expire, CURDATE()) AS 剩余天数
FROM users
WHERE vip_expire > CURDATE()
AND DATEDIFF(vip_expire, CURDATE()) <= 30;

-- 统计项目延期情况  
SELECT 
  project_name,
  deadline,
  CASE 
    WHEN DATEDIFF(CURDATE(), deadline) > 0 
    THEN CONCAT('延期', DATEDIFF(CURDATE(), deadline), '天')
    ELSE CONCAT('还剩', ABS(DATEDIFF(CURDATE(), deadline)), '天')
  END AS 项目状态
FROM projects;
```

---

## 5. 🔍 时间提取函数


### 5.1 EXTRACT()日期部分提取


**🔸 什么是EXTRACT()函数**

EXTRACT()就像时间的"**解剖刀**"，可以从完整日期中提取你需要的任何部分。

```sql
-- 基本语法
EXTRACT(部分 FROM 日期)

-- 基础示例
SELECT EXTRACT(YEAR FROM NOW()) AS 年份;
-- 结果：2024

SELECT EXTRACT(MONTH FROM NOW()) AS 月份;
-- 结果：1

SELECT EXTRACT(DAY FROM NOW()) AS 日期;
-- 结果：20

SELECT EXTRACT(HOUR FROM NOW()) AS 小时;
-- 结果：14
```

**🔹 可提取的时间部分**

| 部分 | 说明 | 返回值示例 |
|------|------|------------|
| **YEAR** | 年份 | 2024 |
| **MONTH** | 月份 | 1-12 |
| **DAY** | 日期 | 1-31 |
| **HOUR** | 小时 | 0-23 |
| **MINUTE** | 分钟 | 0-59 |
| **SECOND** | 秒 | 0-59 |
| **WEEK** | 一年中第几周 | 1-53 |
| **QUARTER** | 季度 | 1-4 |

### 5.2 专用提取函数


**🔹 YEAR/MONTH/DAY函数**

这些函数是EXTRACT()的简化版本，使用更简单。

```sql
-- 年份提取
SELECT YEAR(NOW()) AS 年份;
-- 结果：2024

-- 月份提取
SELECT MONTH(NOW()) AS 月份;
-- 结果：1

-- 日期提取  
SELECT DAY(NOW()) AS 日期;
-- 结果：20

-- 小时提取
SELECT HOUR(NOW()) AS 小时;
-- 结果：14

-- 分钟提取
SELECT MINUTE(NOW()) AS 分钟;
-- 结果：30

-- 秒提取
SELECT SECOND(NOW()) AS 秒;
-- 结果：25
```

**🔹 实际应用示例**

```sql
-- 按年份统计销售额
SELECT 
  YEAR(order_date) AS 年份,
  SUM(amount) AS 销售额
FROM orders
GROUP BY YEAR(order_date)
ORDER BY 年份;

-- 按月份统计用户注册量
SELECT 
  YEAR(register_time) AS 年份,
  MONTH(register_time) AS 月份,
  COUNT(*) AS 注册人数
FROM users
GROUP BY YEAR(register_time), MONTH(register_time)
ORDER BY 年份, 月份;

-- 查询生日在本月的用户
SELECT * FROM users 
WHERE MONTH(birth_date) = MONTH(CURDATE());

-- 统计每小时的网站访问量
SELECT 
  HOUR(access_time) AS 小时,
  COUNT(*) AS 访问量
FROM access_logs 
WHERE DATE(access_time) = CURDATE()
GROUP BY HOUR(access_time)
ORDER BY 小时;
```

### 5.3 星期和季度函数


```sql
-- 星期几（1=周一，7=周日）
SELECT DAYOFWEEK(CURDATE()) AS 星期几数字;

-- 星期几名称
SELECT DAYNAME(CURDATE()) AS 星期几名称;
-- 结果：Saturday

-- 一年中第几天
SELECT DAYOFYEAR(CURDATE()) AS 今年第几天;
-- 结果：20

-- 季度
SELECT QUARTER(CURDATE()) AS 季度;
-- 结果：1

-- 实际应用：周末特价商品
SELECT * FROM products 
WHERE is_weekend_sale = 1 
AND DAYOFWEEK(CURDATE()) IN (1, 7);  -- 周日=1，周六=7
```

---

## 6. 🔄 时间戳转换函数


### 6.1 UNIX_TIMESTAMP()时间戳转换


**🔸 什么是时间戳**

时间戳就是从1970年1月1日开始到现在的**总秒数**，就像一个全球统一的"计数器"。

```
时间戳的理解：
1970-01-01 00:00:00  ←  时间戳 0 （起点）
...
2024-01-20 14:30:25  ←  时间戳 1705746625
...
```

**🔸 UNIX_TIMESTAMP()函数**

```sql
-- 获取当前时间戳
SELECT UNIX_TIMESTAMP() AS 当前时间戳;
-- 结果：1705746625

-- 将日期转换为时间戳
SELECT UNIX_TIMESTAMP('2024-01-20 14:30:25') AS 指定时间戳;
-- 结果：1705746625

-- 将当前日期转换为时间戳
SELECT UNIX_TIMESTAMP(NOW()) AS 现在时间戳;
```

**🔹 实际应用场景**

```sql
-- 应用1：记录操作时间戳（节省存储空间）
CREATE TABLE user_actions (
  id INT PRIMARY KEY,
  user_id INT,
  action_time INT,  -- 存储时间戳
  action_type VARCHAR(50)
);

INSERT INTO user_actions VALUES 
(1, 123, UNIX_TIMESTAMP(), 'login');

-- 应用2：计算程序执行时间
SET @start_time = UNIX_TIMESTAMP();
-- 执行某些操作...
SELECT UNIX_TIMESTAMP() - @start_time AS 执行秒数;

-- 应用3：缓存过期时间设置
UPDATE cache_data 
SET expire_timestamp = UNIX_TIMESTAMP() + 3600  -- 1小时后过期
WHERE cache_key = 'user_data_123';
```

### 6.2 FROM_UNIXTIME()时间戳解析


**🔸 什么是FROM_UNIXTIME()函数**

FROM_UNIXTIME()是UNIX_TIMESTAMP()的反向操作，把时间戳转换回可读的日期时间。

```sql
-- 基本使用
SELECT FROM_UNIXTIME(1705746625) AS 转换后时间;
-- 结果：2024-01-20 14:30:25

-- 带格式的转换
SELECT FROM_UNIXTIME(1705746625, '%Y年%m月%d日 %H:%i:%s') AS 中文时间;
-- 结果：2024年01月20日 14:30:25
```

**🔹 实际应用示例**

```sql
-- 查询时间戳记录的可读格式
SELECT 
  user_id,
  FROM_UNIXTIME(action_time) AS 操作时间,
  action_type
FROM user_actions
WHERE user_id = 123;

-- 查询最近1小时的操作记录
SELECT 
  user_id,
  FROM_UNIXTIME(action_time) AS 操作时间,
  action_type
FROM user_actions  
WHERE action_time >= UNIX_TIMESTAMP() - 3600;

-- 时间戳格式化显示
SELECT 
  cache_key,
  FROM_UNIXTIME(expire_timestamp, '%Y-%m-%d %H:%i') AS 过期时间
FROM cache_data
WHERE expire_timestamp > UNIX_TIMESTAMP();
```

### 6.3 时间戳使用最佳实践


**💡 何时使用时间戳**

```
使用时间戳的场景：
✅ 需要跨时区处理     ← 时间戳不受时区影响
✅ 需要高精度计算     ← 秒级精确计算
✅ 需要节省存储空间    ← INT类型比DATETIME小
✅ API接口数据交换     ← 标准格式，易于处理

使用DATETIME的场景：
✅ 需要直观显示       ← 直接可读
✅ 需要日期查询       ← 方便WHERE条件
✅ 需要复杂时间运算    ← 丰富的日期函数
✅ 业务逻辑简单       ← 学习成本低
```

---

## 7. 🌍 时区转换函数


### 7.1 时区概念基础


**🔸 什么是时区**

时区就是地球按经度划分的**时间区域**，不同地区的"现在"是不一样的。

```
全球时区示例：
UTC+0 (格林威治)：  2024-01-20 12:00:00
UTC+8 (北京时间)：  2024-01-20 20:00:00
UTC-5 (纽约时间)：  2024-01-20 07:00:00
UTC+9 (东京时间)：  2024-01-20 21:00:00

同一时刻，不同地区看到的时间不同！
```

**🔸 MySQL时区设置**

```sql
-- 查看当前时区设置
SELECT $$global.time_zone AS 全局时区, $$session.time_zone AS 会话时区;

-- 设置时区
SET time_zone = '+8:00';    -- 设置为东八区
SET time_zone = 'Asia/Shanghai';  -- 设置为上海时区
SET time_zone = 'UTC';      -- 设置为UTC时区
```

### 7.2 CONVERT_TZ()时区转换


**🔸 什么是CONVERT_TZ()函数**

CONVERT_TZ()就像时间的"**翻译官**"，把一个时区的时间转换成另一个时区的时间。

```sql
-- 基本语法
CONVERT_TZ(时间, '原时区', '目标时区')

-- 基础示例：北京时间转纽约时间
SELECT CONVERT_TZ(
  '2024-01-20 20:00:00',  -- 北京时间晚8点
  '+08:00',               -- 东八区
  '-05:00'                -- 西五区（纽约）
) AS 纽约时间;
-- 结果：2024-01-20 07:00:00

-- 使用命名时区
SELECT CONVERT_TZ(
  NOW(),
  'Asia/Shanghai',        -- 上海时区
  'America/New_York'      -- 纽约时区  
) AS 纽约当前时间;
```

**🔹 实际应用示例**

```sql
-- 应用1：全球用户统一显示本地时间
SELECT 
  user_name,
  login_time,
  CONVERT_TZ(login_time, 'UTC', user_timezone) AS 本地登录时间
FROM users 
WHERE user_id = 123;

-- 应用2：会议时间多时区显示
SELECT 
  meeting_title,
  meeting_time AS UTC时间,
  CONVERT_TZ(meeting_time, 'UTC', 'Asia/Shanghai') AS 北京时间,
  CONVERT_TZ(meeting_time, 'UTC', 'America/New_York') AS 纽约时间,
  CONVERT_TZ(meeting_time, 'UTC', 'Europe/London') AS 伦敦时间
FROM meetings;

-- 应用3：按用户时区统计活跃时间
SELECT 
  HOUR(CONVERT_TZ(action_time, 'UTC', user_timezone)) AS 用户本地小时,
  COUNT(*) AS 操作次数
FROM user_actions ua
JOIN users u ON ua.user_id = u.user_id
GROUP BY HOUR(CONVERT_TZ(action_time, 'UTC', user_timezone));
```

### 7.3 UTC时间处理


**🔸 UTC_TIMESTAMP()函数**

UTC_TIMESTAMP()返回当前的**UTC时间**，不受服务器时区设置影响。

```sql
-- 获取UTC时间
SELECT UTC_TIMESTAMP() AS UTC时间;
-- 结果：2024-01-20 06:30:25 (假设服务器在东八区)

-- 对比本地时间和UTC时间
SELECT 
  NOW() AS 本地时间,
  UTC_TIMESTAMP() AS UTC时间,
  TIMESTAMPDIFF(HOUR, UTC_TIMESTAMP(), NOW()) AS 时差小时;
```

**🔹 时区处理最佳实践**

```sql
-- 最佳实践：数据库存储UTC时间，显示时转换
CREATE TABLE user_posts (
  id INT PRIMARY KEY,
  user_id INT,
  content TEXT,
  create_time TIMESTAMP DEFAULT UTC_TIMESTAMP(),  -- 存储UTC时间
  INDEX idx_create_time (create_time)
);

-- 查询时转换为用户时区
SELECT 
  content,
  CONVERT_TZ(create_time, 'UTC', '用户时区') AS 发布时间
FROM user_posts 
WHERE user_id = 123
ORDER BY create_time DESC;
```

---

## 8. ⚡ 日期时间优化技巧


### 8.1 日期时间索引优化


**🔸 为什么需要日期索引优化**

日期字段经常用于范围查询和排序，合适的索引能大幅提升查询性能。

```sql
-- 创建时间字段索引
CREATE INDEX idx_create_time ON orders (create_time);
CREATE INDEX idx_order_date ON orders (order_date);

-- 复合索引优化
CREATE INDEX idx_user_time ON orders (user_id, create_time);
```

**🔹 日期查询优化技巧**

```sql
-- ❌ 错误写法：在日期字段上使用函数
SELECT * FROM orders 
WHERE YEAR(order_date) = 2024 
AND MONTH(order_date) = 1;

-- ✅ 正确写法：使用范围查询
SELECT * FROM orders 
WHERE order_date >= '2024-01-01' 
AND order_date < '2024-02-01';

-- ❌ 错误写法：提取日期部分比较
SELECT * FROM orders 
WHERE DATE(create_time) = CURDATE();

-- ✅ 正确写法：使用时间范围
SELECT * FROM orders 
WHERE create_time >= CURDATE()
AND create_time < DATE_ADD(CURDATE(), INTERVAL 1 DAY);
```

### 8.2 时间数据类型选择


**🔹 数据类型选择指南**

| 数据类型 | 存储空间 | 范围 | 适用场景 |
|----------|----------|------|----------|
| **DATE** | 3字节 | 1000-9999年 | 只需要日期 |
| **TIME** | 3字节 | -838到838小时 | 只需要时间 |
| **DATETIME** | 8字节 | 1000-9999年 | 不涉及时区 |
| **TIMESTAMP** | 4字节 | 1970-2038年 | 需要时区转换 |

```sql
-- 根据业务需求选择合适类型
CREATE TABLE user_events (
  id INT PRIMARY KEY,
  user_id INT,
  event_date DATE,                    -- 只记录日期
  event_time TIME,                    -- 只记录时间
  create_time DATETIME DEFAULT NOW(), -- 创建时间  
  update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
              ON UPDATE CURRENT_TIMESTAMP  -- 自动更新时间
);
```

### 8.3 时间计算性能优化


```sql
-- ❌ 避免在WHERE子句中使用复杂时间计算
SELECT * FROM orders 
WHERE DATEDIFF(NOW(), create_time) <= 30;

-- ✅ 预先计算时间范围
SELECT * FROM orders 
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY);

-- ✅ 使用变量缓存计算结果
SET @thirty_days_ago = DATE_SUB(NOW(), INTERVAL 30 DAY);
SELECT * FROM orders WHERE create_time >= @thirty_days_ago;
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心函数


```
🔸 当前时间函数：NOW()、CURDATE()、CURTIME() - 获取系统时间
🔸 格式化函数：DATE_FORMAT()、STR_TO_DATE() - 时间格式转换
🔸 时间计算函数：DATE_ADD()、DATE_SUB()、DATEDIFF() - 时间运算
🔸 提取函数：YEAR()、MONTH()、DAY()、HOUR() - 提取时间部分
🔸 时间戳函数：UNIX_TIMESTAMP()、FROM_UNIXTIME() - 时间戳处理
🔸 时区函数：CONVERT_TZ()、UTC_TIMESTAMP() - 时区转换
```

### 9.2 关键理解要点


**🔹 选择合适的时间函数**
```
获取当前时间：
- 需要完整时间 → NOW()
- 只需要日期 → CURDATE()  
- 只需要时间 → CURTIME()

时间运算：
- 简单加减 → DATE_ADD()/DATE_SUB()
- 计算天数差 → DATEDIFF()
- 复杂运算 → 结合多个函数

格式化显示：
- 标准格式 → 直接使用
- 自定义格式 → DATE_FORMAT()
- 字符串转时间 → STR_TO_DATE()
```

**🔹 时区处理要点**
```
时区处理原则：
- 数据库存储：统一使用UTC时间
- 应用显示：转换为用户本地时间
- API接口：使用时间戳或ISO格式
- 跨时区应用：必须考虑时区转换
```

**🔹 性能优化要点**  
```
索引优化：
- 时间字段建立索引
- 范围查询使用复合索引
- 避免在WHERE中使用函数

查询优化：
- 用范围查询代替函数提取
- 预先计算时间边界
- 选择合适的数据类型
```

### 9.3 实际应用价值


**🎯 业务场景应用**
- **用户管理**：注册时间、最后登录时间、VIP到期时间
- **订单系统**：下单时间、发货时间、配送时间统计
- **数据分析**：按时间维度统计销售、用户活跃度分析
- **系统日志**：操作时间记录、性能监控数据收集

**💼 开发实践**
- **数据录入**：使用NOW()记录操作时间
- **条件查询**：使用DATE_ADD/SUB设置时间范围
- **数据展示**：使用DATE_FORMAT格式化显示
- **跨时区应用**：使用CONVERT_TZ处理不同时区用户

**核心记忆要点**：
- 时间函数是数据库应用的基础工具
- 选择函数要根据具体需求和性能考虑
- 时区处理是全球化应用的关键技能
- 合理使用索引能大幅提升时间查询性能