---
title: 3ã€MySQLæŸ¥è¯¢è½¬æ¢ä¸é‡å†™å¼•æ“
---
## ğŸ“š ç›®å½•

1. [æŸ¥è¯¢è½¬æ¢å¼•æ“åŸºç¡€æ¦‚å¿µ](#1-æŸ¥è¯¢è½¬æ¢å¼•æ“åŸºç¡€æ¦‚å¿µ)
2. [ç­‰ä»·å˜æ¢ç®—æ³•åŸç†](#2-ç­‰ä»·å˜æ¢ç®—æ³•åŸç†)
3. [æŸ¥è¯¢æ­£è§„åŒ–å¤„ç†](#3-æŸ¥è¯¢æ­£è§„åŒ–å¤„ç†)
4. [è½¬æ¢è§„åˆ™åŒ¹é…æœºåˆ¶](#4-è½¬æ¢è§„åˆ™åŒ¹é…æœºåˆ¶)
5. [é‡å†™è§„åˆ™å†²çªå¤„ç†](#5-é‡å†™è§„åˆ™å†²çªå¤„ç†)
6. [è½¬æ¢æ­£ç¡®æ€§éªŒè¯](#6-è½¬æ¢æ­£ç¡®æ€§éªŒè¯)
7. [å®é™…åº”ç”¨ä¸è°ƒä¼˜](#7-å®é™…åº”ç”¨ä¸è°ƒä¼˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æŸ¥è¯¢è½¬æ¢å¼•æ“åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢è½¬æ¢ä¸é‡å†™


**ğŸ”¸ æŸ¥è¯¢è½¬æ¢çš„æœ¬è´¨**
```
ç®€å•ç†è§£ï¼š
ä½ å†™äº†ä¸€ä¸ªSQLæŸ¥è¯¢ï¼ŒMySQLä¼šåœ¨æ‰§è¡Œå‰"æ”¹å†™"è¿™ä¸ªæŸ¥è¯¢ï¼Œ
è®©å®ƒè·‘å¾—æ›´å¿«ï¼Œä½†ç»“æœå®Œå…¨ä¸€æ ·ã€‚

å°±åƒï¼š
ä½ è¯´ï¼š"æˆ‘è¦ä»åŒ—äº¬åç«è½¦åˆ°ä¸Šæµ·"
å¯¼èˆªç³»ç»Ÿè¯´ï¼š"æˆ‘ç»™ä½ è§„åˆ’ä¸€æ¡æœ€å¿«çš„è·¯çº¿"
æœ€ç»ˆç›®çš„åœ°ä¸€æ ·ï¼Œä½†è·¯å¾„æ›´ä¼˜
```

**ğŸ’¡ è½¬æ¢å¼•æ“çš„å·¥ä½œæµç¨‹**
```
åŸå§‹SQL â†’ è¯­æ³•è§£æ â†’ è½¬æ¢å¼•æ“ â†’ ä¼˜åŒ–åSQL â†’ æ‰§è¡Œè®¡åˆ’ â†’ æ‰§è¡Œç»“æœ

è½¬æ¢å¼•æ“åšä»€ä¹ˆï¼š
1. åˆ†æSQLç»“æ„å’Œè¯­ä¹‰
2. åº”ç”¨å„ç§è½¬æ¢è§„åˆ™
3. ç”Ÿæˆç­‰ä»·ä½†æ›´é«˜æ•ˆçš„SQL
4. éªŒè¯è½¬æ¢çš„æ­£ç¡®æ€§
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æŸ¥è¯¢è½¬æ¢


**ğŸ¯ è½¬æ¢çš„æ ¸å¿ƒç›®æ ‡**
```
æ€§èƒ½æå‡ï¼š
â€¢ å‡å°‘æ•°æ®æ‰«æé‡
â€¢ ä¼˜åŒ–è¿æ¥é¡ºåº
â€¢ åˆ©ç”¨ç´¢å¼•åŠ é€Ÿ
â€¢ æ¶ˆé™¤å†—ä½™è®¡ç®—

é€»è¾‘ç®€åŒ–ï¼š
â€¢ åˆå¹¶ç›¸åŒçš„å­æŸ¥è¯¢
â€¢ å±•å¼€è§†å›¾å®šä¹‰
â€¢ ç®€åŒ–å¤æ‚è¡¨è¾¾å¼
â€¢ æ ‡å‡†åŒ–SQLç»“æ„
```

**ğŸ“Š è½¬æ¢æ•ˆæœç¤ºä¾‹**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆæ•ˆç‡ä½ï¼‰
SELECT * FROM orders o
WHERE EXISTS (
    SELECT 1 FROM customers c 
    WHERE c.id = o.customer_id 
    AND c.city = 'Beijing'
);

-- è½¬æ¢åæŸ¥è¯¢ï¼ˆæ•ˆç‡é«˜ï¼‰
SELECT o.* FROM orders o
INNER JOIN customers c ON c.id = o.customer_id
WHERE c.city = 'Beijing';

-- ä¸ºä»€ä¹ˆè½¬æ¢åæ›´å¿«ï¼š
-- EXISTSéœ€è¦å¯¹æ¯è¡Œæ‰§è¡Œå­æŸ¥è¯¢
-- JOINå¯ä»¥åˆ©ç”¨ç´¢å¼•ä¸€æ¬¡æ€§å®Œæˆ
```

### 1.3 è½¬æ¢å¼•æ“çš„æ ¸å¿ƒç»„ä»¶


**ğŸ—ï¸ è½¬æ¢å¼•æ“æ¶æ„**
```
æŸ¥è¯¢è½¬æ¢å¼•æ“
â”œâ”€â”€ è§„åˆ™å¼•æ“ (Rule Engine)
â”‚   â”œâ”€â”€ åŸºç¡€è½¬æ¢è§„åˆ™
â”‚   â”œâ”€â”€ ç´¢å¼•åˆ©ç”¨è§„åˆ™  
â”‚   â””â”€â”€ è¿æ¥ä¼˜åŒ–è§„åˆ™
â”œâ”€â”€ æ¨¡å¼åŒ¹é…å™¨ (Pattern Matcher)
â”‚   â”œâ”€â”€ SQLç»“æ„è¯†åˆ«
â”‚   â””â”€â”€ è½¬æ¢æ¡ä»¶åˆ¤æ–­
â”œâ”€â”€ ä»£ä»·ä¼°ç®—å™¨ (Cost Estimator)
â”‚   â”œâ”€â”€ è½¬æ¢å‰åä»£ä»·å¯¹æ¯”
â”‚   â””â”€â”€ æœ€ä¼˜æ–¹æ¡ˆé€‰æ‹©
â””â”€â”€ æ­£ç¡®æ€§éªŒè¯å™¨ (Correctness Validator)
    â”œâ”€â”€ è¯­ä¹‰ç­‰ä»·æ€§æ£€æŸ¥
    â””â”€â”€ ç»“æœä¸€è‡´æ€§ä¿è¯
```

---

## 2. ğŸ”€ ç­‰ä»·å˜æ¢ç®—æ³•åŸç†


### 2.1 å…³ç³»ä»£æ•°ç­‰ä»·å˜æ¢


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç­‰ä»·å˜æ¢**
```
ç­‰ä»·å˜æ¢çš„å®šä¹‰ï¼š
ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•æ•°æ®é›†ä¸Šéƒ½äº§ç”Ÿç›¸åŒç»“æœï¼Œå°±å«ç­‰ä»·

æ•°å­¦åŸºç¡€ï¼š
åŸºäºå…³ç³»ä»£æ•°çš„ç­‰ä»·æ€§è§„å¾‹
â€¢ é€‰æ‹©æ“ä½œçš„äº¤æ¢å¾‹
â€¢ è¿æ¥æ“ä½œçš„ç»“åˆå¾‹  
â€¢ æŠ•å½±æ“ä½œçš„åˆå¹¶è§„å¾‹
```

**ğŸ“Š å¸¸è§ç­‰ä»·å˜æ¢è§„å¾‹**

| å˜æ¢ç±»å‹ | **åŸå§‹å½¢å¼** | **ç­‰ä»·å½¢å¼** | **é€‚ç”¨æ¡ä»¶** |
|---------|------------|-------------|-------------|
| **é€‰æ‹©ä¸‹æ¨** | `Ïƒ(R â‹ˆ S)` | `Ïƒ(R) â‹ˆ Ïƒ(S)` | `æ¡ä»¶å¯åˆ†è§£` |
| **æŠ•å½±ä¸‹æ¨** | `Ï€(R â‹ˆ S)` | `Ï€(Ï€(R) â‹ˆ Ï€(S))` | `æŠ•å½±å­—æ®µåŒ…å«è¿æ¥é”®` |
| **è¿æ¥äº¤æ¢** | `R â‹ˆ S` | `S â‹ˆ R` | `å†…è¿æ¥` |
| **è¿æ¥ç»“åˆ** | `(R â‹ˆ S) â‹ˆ T` | `R â‹ˆ (S â‹ˆ T)` | `è¿æ¥æ¡ä»¶å…¼å®¹` |

### 2.2 é€‰æ‹©æ¡ä»¶ä¸‹æ¨


**ğŸ”§ WHEREæ¡ä»¶ä¸‹æ¨åŸç†**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼šå…ˆè¿æ¥å†è¿‡æ»¤
SELECT o.order_id, c.name
FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE c.city = 'Shanghai'
  AND o.order_date >= '2024-01-01';

-- è½¬æ¢åï¼šå…ˆè¿‡æ»¤å†è¿æ¥
SELECT o.order_id, c.name  
FROM (
    SELECT * FROM orders 
    WHERE order_date >= '2024-01-01'
) o
JOIN (
    SELECT * FROM customers 
    WHERE city = 'Shanghai'
) c ON o.customer_id = c.id;

-- ä¸ºä»€ä¹ˆæ›´å¿«ï¼š
-- å‡å°‘äº†è¿æ¥æ—¶å¤„ç†çš„æ•°æ®é‡
-- å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ç´¢å¼•
```

**ğŸ¯ ä¸‹æ¨æ¡ä»¶çš„è¯†åˆ«**
```sql
-- MySQLè‡ªåŠ¨è¯†åˆ«å¯ä¸‹æ¨çš„æ¡ä»¶
EXPLAIN FORMAT=JSON
SELECT o.*, c.name
FROM orders o
JOIN customers c ON o.customer_id = c.id  
WHERE c.status = 'active'     -- å¯ä¸‹æ¨åˆ°customersè¡¨
  AND o.amount > 1000         -- å¯ä¸‹æ¨åˆ°ordersè¡¨
  AND o.order_date = c.reg_date; -- ä¸å¯ä¸‹æ¨ï¼Œæ¶‰åŠä¸¤è¡¨

-- æŸ¥çœ‹è½¬æ¢ç»“æœ
-- MySQLä¼šè‡ªåŠ¨å°†æ¡ä»¶ä¸‹æ¨åˆ°å¯¹åº”çš„è¡¨è®¿é—®é˜¶æ®µ
```

### 2.3 å­æŸ¥è¯¢è½¬æ¢


**ğŸ”§ EXISTSåˆ°JOINçš„è½¬æ¢**
```sql
-- åŸå§‹EXISTSæŸ¥è¯¢
SELECT c.customer_id, c.name
FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.customer_id = c.customer_id
    AND o.status = 'completed'
);

-- è‡ªåŠ¨è½¬æ¢ä¸ºSEMI JOIN
-- MySQLå†…éƒ¨è½¬æ¢ä¸ºç±»ä¼¼è¿™æ ·çš„é€»è¾‘ï¼š
SELECT DISTINCT c.customer_id, c.name
FROM customers c
WHERE c.customer_id IN (
    SELECT DISTINCT customer_id 
    FROM orders 
    WHERE status = 'completed'
);

-- å®é™…æ‰§è¡Œå¯èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºï¼š
SELECT DISTINCT c.customer_id, c.name
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
WHERE o.status = 'completed';
```

### 2.4 èšåˆå‡½æ•°æ¨å¯¼å˜æ¢


**ğŸ“Š èšåˆæŸ¥è¯¢çš„æ™ºèƒ½è½¬æ¢**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼šåµŒå¥—èšåˆ
SELECT customer_id,
       (SELECT COUNT(*) FROM orders o2 
        WHERE o2.customer_id = o1.customer_id) as order_count
FROM orders o1
GROUP BY customer_id;

-- è½¬æ¢åï¼šå•æ¬¡èšåˆ
SELECT customer_id,
       COUNT(*) as order_count
FROM orders
GROUP BY customer_id;

-- è½¬æ¢è§„åˆ™ï¼š
-- æ¶ˆé™¤äº†ä¸å¿…è¦çš„ç›¸å…³å­æŸ¥è¯¢
-- ç›´æ¥ä½¿ç”¨GROUP BYè¿›è¡Œèšåˆ
```

---

## 3. ğŸ“ æŸ¥è¯¢æ­£è§„åŒ–å¤„ç†


### 3.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢æ­£è§„åŒ–


**ğŸ”¸ æ­£è§„åŒ–çš„ç›®çš„**
```
æ­£è§„åŒ–å°±æ˜¯æŠŠSQL"æ•´ç†"æˆæ ‡å‡†æ ¼å¼ï¼Œæ–¹ä¾¿åç»­å¤„ç†

ç±»ä¼¼æ•´ç†æˆ¿é—´ï¼š
â€¢ æŠŠä¹±æ”¾çš„ä¸œè¥¿åˆ†ç±»æ‘†æ”¾
â€¢ ç»Ÿä¸€å‘½åè§„èŒƒ
â€¢ æ¶ˆé™¤é‡å¤çš„ç‰©å“
â€¢ å»ºç«‹æ¸…æ™°çš„ç»“æ„

SQLæ­£è§„åŒ–åŒ…æ‹¬ï¼š
â€¢ è¡¨è¾¾å¼æ ‡å‡†åŒ–
â€¢ è°“è¯è§„èŒƒåŒ–  
â€¢ å¸¸é‡æŠ˜å 
â€¢ ç±»å‹è½¬æ¢ç»Ÿä¸€
```

### 3.2 è¡¨è¾¾å¼æ ‡å‡†åŒ–


**ğŸ”§ å¸¸è§è¡¨è¾¾å¼è½¬æ¢**
```sql
-- 1. å¸¸é‡æŠ˜å 
-- åŸå§‹ï¼š
SELECT * FROM products WHERE price > 100 + 50;
-- æ­£è§„åŒ–ï¼š
SELECT * FROM products WHERE price > 150;

-- 2. ç±»å‹è½¬æ¢æ ‡å‡†åŒ–
-- åŸå§‹ï¼š
SELECT * FROM orders WHERE order_date = '2024-01-01';
-- æ­£è§„åŒ–ï¼š
SELECT * FROM orders WHERE order_date = DATE('2024-01-01');

-- 3. å‡½æ•°è°ƒç”¨ä¼˜åŒ–
-- åŸå§‹ï¼š
SELECT * FROM users WHERE YEAR(created_at) = 2024;
-- æ­£è§„åŒ–ï¼š
SELECT * FROM users WHERE created_at >= '2024-01-01' 
                      AND created_at < '2025-01-01';
```

### 3.3 è°“è¯æ­£è§„åŒ–


**ğŸ“Š WHEREæ¡ä»¶çš„æ ‡å‡†åŒ–å¤„ç†**
```sql
-- 1. èŒƒå›´æ¡ä»¶åˆå¹¶
-- åŸå§‹ï¼š
SELECT * FROM products 
WHERE price >= 100 AND price <= 500 AND price > 150;
-- æ­£è§„åŒ–ï¼š
SELECT * FROM products WHERE price > 150 AND price <= 500;

-- 2. INæ¡ä»¶ä¼˜åŒ–
-- åŸå§‹ï¼š
SELECT * FROM orders WHERE status IN ('pending', 'pending', 'processing');
-- æ­£è§„åŒ–ï¼š
SELECT * FROM orders WHERE status IN ('pending', 'processing');

-- 3. é€»è¾‘è¡¨è¾¾å¼ç®€åŒ–
-- åŸå§‹ï¼š
SELECT * FROM users WHERE (age > 18 AND age > 20) OR (age > 25);
-- æ­£è§„åŒ–ï¼š
SELECT * FROM users WHERE age > 20;
```

### 3.4 æŸ¥çœ‹æ­£è§„åŒ–ç»“æœ


**ğŸ” è§‚å¯ŸMySQLçš„æ­£è§„åŒ–è¿‡ç¨‹**
```sql
-- ä½¿ç”¨EXPLAINæŸ¥çœ‹è½¬æ¢åçš„æŸ¥è¯¢
EXPLAIN FORMAT=JSON
SELECT * FROM orders o
WHERE YEAR(o.order_date) = 2024
  AND o.amount > 100 + 50
  AND o.status IN ('completed', 'completed', 'shipped');

-- æŸ¥çœ‹ä¼˜åŒ–å™¨è·Ÿè¸ªä¿¡æ¯
SET optimizer_trace = 'enabled=on';

SELECT * FROM orders 
WHERE YEAR(order_date) = 2024 AND amount > 150;

SELECT trace FROM information_schema.OPTIMIZER_TRACE;

SET optimizer_trace = 'enabled=off';
```

---

## 4. ğŸ¯ è½¬æ¢è§„åˆ™åŒ¹é…æœºåˆ¶


### 4.1 è§„åˆ™åŒ¹é…çš„å·¥ä½œåŸç†


**ğŸ”¸ æ¨¡å¼åŒ¹é…è¿‡ç¨‹**
```
è§„åˆ™åŒ¹é…æ­¥éª¤ï¼š
1. æ¨¡å¼è¯†åˆ«ï¼šåˆ†æSQLçš„ç»“æ„æ¨¡å¼
2. æ¡ä»¶æ£€æŸ¥ï¼šéªŒè¯è½¬æ¢çš„å‰ææ¡ä»¶
3. è§„åˆ™åº”ç”¨ï¼šæ‰§è¡Œç›¸åº”çš„è½¬æ¢è§„åˆ™
4. æ•ˆæœè¯„ä¼°ï¼šè¯„ä¼°è½¬æ¢åçš„æ€§èƒ½æ”¹è¿›

åŒ¹é…ç¤ºä¾‹ï¼š
SQLæ¨¡å¼: SELECT ... WHERE EXISTS (SELECT ...)
åŒ¹é…è§„åˆ™: EXISTS â†’ SEMI JOINè½¬æ¢
å‰ææ¡ä»¶: å­æŸ¥è¯¢ä¸å«èšåˆï¼Œå¤–è¡¨æ— é‡å¤é”®
æ‰§è¡Œè½¬æ¢: ç”ŸæˆåŠè¿æ¥æŸ¥è¯¢
```

### 4.2 å¸¸è§è½¬æ¢è§„åˆ™ç±»å‹


**ğŸ“‹ æ ¸å¿ƒè½¬æ¢è§„åˆ™åˆ†ç±»**

**ğŸ”¸ å­æŸ¥è¯¢è½¬æ¢è§„åˆ™**
```sql
-- è§„åˆ™1ï¼šINå­æŸ¥è¯¢è½¬SEMI JOIN
-- è§¦å‘æ¡ä»¶ï¼šå­æŸ¥è¯¢æ— èšåˆï¼Œè¿”å›å•åˆ—
SELECT * FROM customers 
WHERE customer_id IN (
    SELECT customer_id FROM orders WHERE amount > 1000
);
-- è½¬æ¢ä¸ºåŠè¿æ¥æ‰§è¡Œ

-- è§„åˆ™2ï¼šEXISTSè½¬SEMI JOIN  
-- è§¦å‘æ¡ä»¶ï¼šå­æŸ¥è¯¢ä¸ºç®€å•è¿‡æ»¤æ¡ä»¶
SELECT * FROM products
WHERE EXISTS (
    SELECT 1 FROM order_items oi 
    WHERE oi.product_id = products.id
);
-- è½¬æ¢ä¸ºåŠè¿æ¥æ‰§è¡Œ

-- è§„åˆ™3ï¼šç›¸å…³å­æŸ¥è¯¢å»ç›¸å…³åŒ–
-- è§¦å‘æ¡ä»¶ï¼šå­æŸ¥è¯¢å¯ä»¥ç‹¬ç«‹è®¡ç®—
SELECT customer_id,
       (SELECT COUNT(*) FROM orders o 
        WHERE o.customer_id = c.customer_id) as order_count
FROM customers c;
-- è½¬æ¢ä¸ºJOIN + GROUP BY
```

**ğŸ”¸ è¿æ¥ä¼˜åŒ–è§„åˆ™**
```sql
-- è§„åˆ™4ï¼šå†…è¿æ¥é¡ºåºé‡æ’
-- è§¦å‘æ¡ä»¶ï¼šå¤šè¡¨å†…è¿æ¥ï¼Œæœ‰é€‰æ‹©æ€§å·®å¼‚
SELECT * 
FROM large_table lt
JOIN small_table st ON lt.id = st.ref_id
JOIN tiny_table tt ON st.id = tt.ref_id;
-- è‡ªåŠ¨è°ƒæ•´ä¸ºï¼štiny â†’ small â†’ large çš„è¿æ¥é¡ºåº

-- è§„åˆ™5ï¼šå¤–è¿æ¥è½¬å†…è¿æ¥
-- è§¦å‘æ¡ä»¶ï¼šWHEREæ¡ä»¶è¿‡æ»¤æ‰äº†NULLå€¼
SELECT * 
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
WHERE o.amount > 100;  -- è¿™ä¸ªæ¡ä»¶ä½¿LEFT JOINç­‰ä»·äºINNER JOIN
-- è½¬æ¢ä¸ºINNER JOINæ‰§è¡Œ
```

### 4.3 è§„åˆ™ä¼˜å…ˆçº§å’Œé€‰æ‹©


**âš–ï¸ è§„åˆ™åº”ç”¨çš„ä¼˜å…ˆçº§**
```
è½¬æ¢è§„åˆ™ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. ğŸ”¥ å¸¸é‡æŠ˜å å’Œè¡¨è¾¾å¼ç®€åŒ–
2. ğŸ”¥ è°“è¯ä¸‹æ¨ï¼ˆé€‰æ‹©æ¡ä»¶ä¸‹æ¨ï¼‰
3. ğŸ”¥ æŠ•å½±ä¸‹æ¨ï¼ˆå‡å°‘ä¼ è¾“æ•°æ®ï¼‰
4. âš¡ å­æŸ¥è¯¢è½¬æ¢ï¼ˆEXISTS/INè½¬JOINï¼‰
5. âš¡ è¿æ¥é‡æ’åºï¼ˆç»Ÿè®¡ä¿¡æ¯é©±åŠ¨ï¼‰
6. ğŸ“Š èšåˆä¼˜åŒ–ï¼ˆGROUP BYä¼˜åŒ–ï¼‰
7. ğŸ“Š æ’åºä¼˜åŒ–ï¼ˆORDER BYä¼˜åŒ–ï¼‰

ä¸ºä»€ä¹ˆè¿™æ ·æ’åºï¼š
â€¢ å¸¸é‡è®¡ç®—æˆæœ¬æœ€ä½ï¼Œä¼˜å…ˆå¤„ç†
â€¢ æ¡ä»¶ä¸‹æ¨èƒ½æœ€å¤§ç¨‹åº¦å‡å°‘æ•°æ®é‡
â€¢ è¿æ¥ä¼˜åŒ–ä¾èµ–ç»Ÿè®¡ä¿¡æ¯ï¼Œç›¸å¯¹å¤æ‚
```

---

## 5. ğŸ”§ é‡å†™è§„åˆ™å†²çªå¤„ç†


### 5.1 ä»€ä¹ˆæ˜¯è§„åˆ™å†²çª


**ğŸ”¸ è§„åˆ™å†²çªçš„äº§ç”Ÿ**
```
å†²çªåœºæ™¯ç¤ºä¾‹ï¼š
è§„åˆ™Aï¼šå°†å­æŸ¥è¯¢è½¬æ¢ä¸ºJOIN
è§„åˆ™Bï¼šä¿æŒå­æŸ¥è¯¢ä»¥åˆ©ç”¨ç´¢å¼•

å…·ä½“ä¾‹å­ï¼š
SELECT * FROM customers c
WHERE c.status = 'active'
  AND EXISTS (
      SELECT 1 FROM orders o 
      WHERE o.customer_id = c.id 
      AND o.order_date > '2024-01-01'
  );

å¯èƒ½çš„è½¬æ¢æ–¹æ¡ˆï¼š
æ–¹æ¡ˆ1ï¼šè½¬æ¢ä¸ºJOINï¼Œåˆ©ç”¨è¿æ¥ç®—æ³•
æ–¹æ¡ˆ2ï¼šä¿æŒEXISTSï¼Œåˆ©ç”¨customersè¡¨çš„ç´¢å¼•
æ–¹æ¡ˆ3ï¼šè½¬æ¢ä¸ºINå­æŸ¥è¯¢ï¼Œåˆ©ç”¨ordersè¡¨çš„ç´¢å¼•
```

### 5.2 å†²çªè§£å†³ç­–ç•¥


**âš–ï¸ MySQLçš„å†²çªå¤„ç†æœºåˆ¶**
```sql
-- ä»£ä»·é©±åŠ¨çš„å†²çªè§£å†³
-- MySQLä¼šè®¡ç®—æ¯ç§è½¬æ¢æ–¹æ¡ˆçš„æˆæœ¬

-- ç¤ºä¾‹ï¼šæ£€æŸ¥ä¼˜åŒ–å™¨çš„é€‰æ‹©è¿‡ç¨‹
SET optimizer_trace = 'enabled=on';

SELECT c.customer_id, c.name
FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.customer_id = c.customer_id
    AND o.amount > 1000
)
AND c.city = 'Beijing';

-- æŸ¥çœ‹ä¼˜åŒ–å™¨çš„å†³ç­–è¿‡ç¨‹
SELECT JSON_PRETTY(trace) FROM information_schema.OPTIMIZER_TRACE;

SET optimizer_trace = 'enabled=off';
```

### 5.3 æ‰‹åŠ¨æ§åˆ¶è½¬æ¢è¡Œä¸º


**ğŸ”§ ä¼˜åŒ–å™¨æç¤ºæ§åˆ¶è½¬æ¢**
```sql
-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šçš„è½¬æ¢ç­–ç•¥

-- 1. å¼ºåˆ¶å­æŸ¥è¯¢è½¬æ¢
SELECT /*+ SEMIJOIN(subq1) */ *
FROM customers c
WHERE c.customer_id IN (
    SELECT /*+ QB_NAME(subq1) */ customer_id 
    FROM orders WHERE amount > 1000
);

-- 2. ç¦æ­¢ç‰¹å®šè½¬æ¢
SELECT /*+ NO_SEMIJOIN() */ *
FROM customers c  
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.customer_id = c.customer_id
);

-- 3. æ§åˆ¶è¿æ¥é¡ºåº
SELECT /*+ STRAIGHT_JOIN */ *
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
JOIN order_items oi ON o.order_id = oi.order_id;
```

---

## 6. âœ… è½¬æ¢æ­£ç¡®æ€§éªŒè¯


### 6.1 è¯­ä¹‰ç­‰ä»·æ€§æ£€æŸ¥


**ğŸ”¸ å¦‚ä½•ä¿è¯è½¬æ¢çš„æ­£ç¡®æ€§**
```
éªŒè¯æ–¹æ³•ï¼š
1. å½¢å¼åŒ–éªŒè¯ï¼šåŸºäºå…³ç³»ä»£æ•°ç†è®º
2. ç»Ÿè®¡éªŒè¯ï¼šå¯¹æ¯”è½¬æ¢å‰åçš„ç»“æœç»Ÿè®¡
3. éšæœºæµ‹è¯•ï¼šç”¨éšæœºæ•°æ®éªŒè¯ç»“æœä¸€è‡´æ€§

MySQLçš„éªŒè¯æœºåˆ¶ï¼š
â€¢ ç¼–è¯‘æ—¶éªŒè¯ï¼šæ£€æŸ¥è½¬æ¢è§„åˆ™çš„ç†è®ºæ­£ç¡®æ€§
â€¢ è¿è¡Œæ—¶éªŒè¯ï¼šåœ¨ç‰¹å®šæ¡ä»¶ä¸‹å¯¹æ¯”ç»“æœ
â€¢ å›å½’æµ‹è¯•ï¼šå¤§é‡æµ‹è¯•ç”¨ä¾‹ä¿è¯ç¨³å®šæ€§
```

### 6.2 éªŒè¯è½¬æ¢æ•ˆæœ


**ğŸ” æ‰‹åŠ¨éªŒè¯è½¬æ¢æ­£ç¡®æ€§**
```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®
CREATE TABLE test_customers (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    city VARCHAR(50)
);

CREATE TABLE test_orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    amount DECIMAL(10,2),
    status VARCHAR(20)
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_customers VALUES 
(1, 'Alice', 'Beijing'), (2, 'Bob', 'Shanghai'), (3, 'Charlie', 'Beijing');

INSERT INTO test_orders VALUES 
(101, 1, 1500, 'completed'), (102, 1, 800, 'pending'),
(103, 2, 1200, 'completed'), (104, 3, 2000, 'completed');

-- éªŒè¯è½¬æ¢å‰åç»“æœä¸€è‡´æ€§
-- åŸå§‹EXISTSæŸ¥è¯¢
SELECT 'EXISTSç»“æœ' as query_type, customer_id, name
FROM test_customers c
WHERE EXISTS (
    SELECT 1 FROM test_orders o 
    WHERE o.customer_id = c.id 
    AND o.amount > 1000
)
UNION ALL
-- è½¬æ¢åçš„JOINæŸ¥è¯¢  
SELECT 'JOINç»“æœ', DISTINCT c.customer_id, c.name
FROM test_customers c
INNER JOIN test_orders o ON c.id = o.customer_id
WHERE o.amount > 1000;

-- ç»“æœåº”è¯¥å®Œå…¨ä¸€è‡´
```

### 6.3 æ€§èƒ½éªŒè¯å·¥å…·


**ğŸ“Š è½¬æ¢æ•ˆæœå¯¹æ¯”**
```sql
-- æ€§èƒ½å¯¹æ¯”æµ‹è¯•æ¡†æ¶
DELIMITER //
CREATE PROCEDURE CompareQueryPerformance(
    IN original_sql TEXT,
    IN optimized_sql TEXT
)
BEGIN
    DECLARE start_time BIGINT;
    DECLARE end_time BIGINT;
    DECLARE original_time BIGINT;
    DECLARE optimized_time BIGINT;

    -- æ¸…ç†ç¼“å­˜ï¼Œç¡®ä¿å…¬å¹³å¯¹æ¯”
    RESET QUERY CACHE;

    -- æµ‹è¯•åŸå§‹æŸ¥è¯¢
    SET start_time = UNIX_TIMESTAMP(NOW(3)) * 1000;
    SET @sql = original_sql;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    SET end_time = UNIX_TIMESTAMP(NOW(3)) * 1000;
    SET original_time = end_time - start_time;

    -- æ¸…ç†ç¼“å­˜
    RESET QUERY CACHE;

    -- æµ‹è¯•ä¼˜åŒ–æŸ¥è¯¢  
    SET start_time = UNIX_TIMESTAMP(NOW(3)) * 1000;
    SET @sql = optimized_sql;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    SET end_time = UNIX_TIMESTAMP(NOW(3)) * 1000;
    SET optimized_time = end_time - start_time;

    -- è¾“å‡ºå¯¹æ¯”ç»“æœ
    SELECT 
        original_time as 'åŸå§‹æŸ¥è¯¢è€—æ—¶ms',
        optimized_time as 'ä¼˜åŒ–æŸ¥è¯¢è€—æ—¶ms',
        ROUND((original_time - optimized_time) * 100.0 / original_time, 2) as 'æ€§èƒ½æå‡%';
END //
DELIMITER ;
```

---

## 7. ğŸ›ï¸ å®é™…åº”ç”¨ä¸è°ƒä¼˜


### 7.1 æŸ¥çœ‹è½¬æ¢è¿‡ç¨‹


**ğŸ” è§‚å¯ŸMySQLçš„è½¬æ¢å†³ç­–**
```sql
-- å¼€å¯ä¼˜åŒ–å™¨è·Ÿè¸ª
SET optimizer_trace = 'enabled=on';
SET optimizer_trace_max_mem_size = 1024*1024;  -- 1MBç¼“å†²åŒº

-- æ‰§è¡Œä¸€ä¸ªå¤æ‚æŸ¥è¯¢
SELECT c.name, COUNT(o.order_id) as order_count
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
WHERE c.city = 'Beijing'
  AND EXISTS (
      SELECT 1 FROM order_items oi
      WHERE oi.order_id = o.order_id
      AND oi.quantity > 5
  )
GROUP BY c.customer_id, c.name;

-- æŸ¥çœ‹è½¬æ¢è¿‡ç¨‹ï¼ˆç²¾ç®€ç‰ˆï¼‰
SELECT 
    JSON_EXTRACT(trace, '$.steps[*].transformation') as transformations,
    JSON_EXTRACT(trace, '$.steps[*].chosen') as chosen_plan
FROM information_schema.OPTIMIZER_TRACE;

-- å…³é—­è·Ÿè¸ª
SET optimizer_trace = 'enabled=off';
```

### 7.2 æ§åˆ¶è½¬æ¢è¡Œä¸º


**ğŸ›ï¸ è°ƒæ•´è½¬æ¢å‚æ•°**
```sql
-- æŸ¥çœ‹å½±å“è½¬æ¢çš„å…³é”®å‚æ•°
SELECT 
    variable_name as 'å‚æ•°å',
    variable_value as 'å½“å‰å€¼',
    CASE variable_name
        WHEN 'optimizer_switch' THEN 'æ§åˆ¶å„ç§ä¼˜åŒ–å¼€å…³'
        WHEN 'optimizer_search_depth' THEN 'è¿æ¥é¡ºåºæœç´¢æ·±åº¦'
        WHEN 'optimizer_prune_level' THEN 'æœç´¢ç©ºé—´è£å‰ªçº§åˆ«'
        ELSE 'å…¶ä»–å‚æ•°'
    END as 'ä½œç”¨è¯´æ˜'
FROM information_schema.GLOBAL_VARIABLES
WHERE variable_name IN (
    'optimizer_switch',
    'optimizer_search_depth', 
    'optimizer_prune_level'
);

-- æŸ¥çœ‹optimizer_switchè¯¦ç»†å¼€å…³
SELECT 
    SUBSTRING_INDEX(SUBSTRING_INDEX($$optimizer_switch, ',', numbers.n), ',', -1) as switch_setting
FROM (
    SELECT 1 n UNION SELECT 2 UNION SELECT 3 UNION SELECT 4 UNION SELECT 5
    UNION SELECT 6 UNION SELECT 7 UNION SELECT 8 UNION SELECT 9 UNION SELECT 10
) numbers
WHERE numbers.n <= 1 + CHAR_LENGTH($$optimizer_switch) - CHAR_LENGTH(REPLACE($$optimizer_switch, ',', ''))
ORDER BY n;
```

### 7.3 å¸¸è§è½¬æ¢å¼€å…³è°ƒæ•´


**ğŸ”§ å®ç”¨çš„ä¼˜åŒ–å¼€å…³è°ƒæ•´**
```sql
-- ä¸´æ—¶ç¦ç”¨æŸäº›è½¬æ¢ï¼ˆæ’æŸ¥é—®é¢˜æ—¶ä½¿ç”¨ï¼‰

-- ç¦ç”¨å­æŸ¥è¯¢è½¬æ¢ï¼ˆå¦‚æœè½¬æ¢åæ€§èƒ½å˜å·®ï¼‰
SET SESSION optimizer_switch = 'semijoin=off';

-- ç¦ç”¨EXISTSè½¬æ¢
SET SESSION optimizer_switch = 'exists_to_in=off';

-- ç¦ç”¨æ´¾ç”Ÿè¡¨åˆå¹¶
SET SESSION optimizer_switch = 'derived_merge=off';

-- æ‰§è¡ŒæŸ¥è¯¢æµ‹è¯•
SELECT * FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o 
    WHERE o.customer_id = c.customer_id
);

-- æ¢å¤é»˜è®¤è®¾ç½®
SET SESSION optimizer_switch = DEFAULT;
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æŸ¥è¯¢è½¬æ¢çš„æœ¬è´¨ç†è§£**
```
æ ¸å¿ƒç›®çš„ï¼šåœ¨ä¿è¯ç»“æœæ­£ç¡®çš„å‰æä¸‹ï¼Œç”Ÿæˆæ›´é«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’
å·¥ä½œåŸç†ï¼šåŸºäºå…³ç³»ä»£æ•°çš„ç­‰ä»·å˜æ¢è§„å¾‹
å…³é”®æœºåˆ¶ï¼šæ¨¡å¼åŒ¹é… + ä»£ä»·è¯„ä¼° + æ­£ç¡®æ€§éªŒè¯
å®é™…æ•ˆæœï¼šè‡ªåŠ¨ä¼˜åŒ–SQLï¼Œæ— éœ€æ‰‹åŠ¨æ”¹å†™
```

**ğŸ”¸ é‡è¦è½¬æ¢ç±»å‹**
```
å­æŸ¥è¯¢è½¬æ¢ï¼šEXISTS/IN â†’ JOINï¼Œæå‡è¿æ¥æ•ˆç‡
æ¡ä»¶ä¸‹æ¨ï¼šWHEREæ¡ä»¶å‰ç½®ï¼Œå‡å°‘å¤„ç†æ•°æ®é‡
è¡¨è¾¾å¼ç®€åŒ–ï¼šå¸¸é‡è®¡ç®—å’Œå‡½æ•°ä¼˜åŒ–
è¿æ¥é‡æ’ï¼šåŸºäºç»Ÿè®¡ä¿¡æ¯ä¼˜åŒ–è¿æ¥é¡ºåº
```

### 8.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™å…³æ³¨æŸ¥è¯¢è½¬æ¢**
```
éœ€è¦å…³æ³¨çš„åœºæ™¯ï¼š
â€¢ å¤æ‚æŸ¥è¯¢æ€§èƒ½ä¸ä½³
â€¢ åŒ…å«å¤šä¸ªå­æŸ¥è¯¢çš„SQL
â€¢ å¤§è¡¨è¿æ¥æŸ¥è¯¢
â€¢ èšåˆæŸ¥è¯¢ä¼˜åŒ–ä¸ç†æƒ³

è§‚å¯Ÿæ–¹æ³•ï¼š
â€¢ ä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’
â€¢ å¼€å¯optimizer_traceæŸ¥çœ‹è½¬æ¢è¿‡ç¨‹  
â€¢ å¯¹æ¯”ä¸åŒå†™æ³•çš„æ€§èƒ½å·®å¼‚
```

**ğŸ”¹ ä¼˜åŒ–ç­–ç•¥å»ºè®®**
```
é…åˆè½¬æ¢å¼•æ“ï¼š
â€¢ å†™æ ‡å‡†çš„SQLï¼Œè®©ä¼˜åŒ–å™¨æ›´å®¹æ˜“è¯†åˆ«æ¨¡å¼
â€¢ é¿å…è¿‡åº¦å¤æ‚çš„åµŒå¥—æŸ¥è¯¢
â€¢ åˆç†ä½¿ç”¨ä¼˜åŒ–å™¨æç¤ºæ§åˆ¶è½¬æ¢

æ€§èƒ½è°ƒä¼˜ï¼š
â€¢ ä¿æŒç»Ÿè®¡ä¿¡æ¯å‡†ç¡®ï¼ˆå½±å“è½¬æ¢å†³ç­–ï¼‰
â€¢ æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´ä¼˜åŒ–å¼€å…³
â€¢ å®šæœŸåˆ†ææ…¢æŸ¥è¯¢çš„è½¬æ¢æ•ˆæœ
```

### 8.3 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ” è½¬æ¢ç›¸å…³é—®é¢˜è¯Šæ–­**
```
å¸¸è§é—®é¢˜ï¼š
1. è½¬æ¢åæ€§èƒ½å˜å·®
   â†’ æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦å‡†ç¡®
   â†’ è€ƒè™‘ç¦ç”¨ç‰¹å®šè½¬æ¢è§„åˆ™

2. æŸ¥è¯¢ç»“æœä¸æ­£ç¡®
   â†’ æ£€æŸ¥æ˜¯å¦è§¦å‘äº†é”™è¯¯çš„è½¬æ¢è§„åˆ™
   â†’ ä½¿ç”¨ä¼˜åŒ–å™¨æç¤ºæ§åˆ¶è½¬æ¢

3. æ‰§è¡Œè®¡åˆ’ä¸ç¨³å®š
   â†’ æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯æ›´æ–°é¢‘ç‡
   â†’ è€ƒè™‘å›ºå®šæ‰§è¡Œè®¡åˆ’

è¯Šæ–­å·¥å…·ï¼š
â€¢ EXPLAINï¼šæŸ¥çœ‹æœ€ç»ˆæ‰§è¡Œè®¡åˆ’
â€¢ optimizer_traceï¼šæŸ¥çœ‹è½¬æ¢è¿‡ç¨‹
â€¢ æ…¢æŸ¥è¯¢æ—¥å¿—ï¼šåˆ†ææ€§èƒ½å˜åŒ–
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- **ç†è§£è€Œéè®°å¿†**ï¼šé‡ç‚¹ç†è§£è½¬æ¢çš„é€»è¾‘åŸç†
- **æµ‹è¯•éªŒè¯**ï¼šä»»ä½•è°ƒæ•´éƒ½è¦åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- **ç›‘æ§è§‚å¯Ÿ**ï¼šå…³æ³¨è½¬æ¢å¯¹æ€§èƒ½çš„å®é™…å½±å“
- **é€‚åº¦æ§åˆ¶**ï¼šä¸è¦è¿‡åº¦å¹²é¢„ä¼˜åŒ–å™¨çš„å†³ç­–
- **æŒç»­å­¦ä¹ **ï¼šMySQLç‰ˆæœ¬æ›´æ–°ä¼šå¸¦æ¥æ–°çš„è½¬æ¢è§„åˆ™

**æ ¸å¿ƒè®°å¿†**ï¼š
- æŸ¥è¯¢è½¬æ¢è®©SQLè‡ªåŠ¨å˜å¿«ï¼Œç»“æœä¸å˜
- ç†è§£å¸¸è§è½¬æ¢è§„å¾‹ï¼Œå†™å‡ºä¼˜åŒ–å™¨å‹å¥½çš„SQL
- é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶ï¼ŒæŸ¥çœ‹è½¬æ¢è¿‡ç¨‹æ‰¾åŸå› 
- åˆç†ä½¿ç”¨æç¤ºæ§åˆ¶ï¼Œä½†ä¸è¦è¿‡åº¦å¹²é¢„