---
title: 8ã€å­æŸ¥è¯¢ç¼“å­˜ä¸é‡ç”¨æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [å­æŸ¥è¯¢ç¼“å­˜åŸºç¡€æ¦‚å¿µ](#1-å­æŸ¥è¯¢ç¼“å­˜åŸºç¡€æ¦‚å¿µ)
2. [å­æŸ¥è¯¢ç»“æœç¼“å­˜æœºåˆ¶](#2-å­æŸ¥è¯¢ç»“æœç¼“å­˜æœºåˆ¶)
3. [å­æŸ¥è¯¢è®¡åˆ’ç¼“å­˜è¯¦è§£](#3-å­æŸ¥è¯¢è®¡åˆ’ç¼“å­˜è¯¦è§£)
4. [ç¼“å­˜ç”Ÿæ•ˆæ¡ä»¶ä¸ç­–ç•¥](#4-ç¼“å­˜ç”Ÿæ•ˆæ¡ä»¶ä¸ç­–ç•¥)
5. [ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°æœºåˆ¶](#5-ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°æœºåˆ¶)
6. [é‡å¤å­æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯](#6-é‡å¤å­æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯)
7. [ç¼“å­˜æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜](#7-ç¼“å­˜æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å­æŸ¥è¯¢ç¼“å­˜åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢ç¼“å­˜


**ğŸ”¸ å­æŸ¥è¯¢ç¼“å­˜çš„æœ¬è´¨**
```
ä¼ ç»Ÿå­æŸ¥è¯¢æ‰§è¡Œï¼š
æ¯æ¬¡æ‰§è¡Œéƒ½é‡æ–°è®¡ç®—å­æŸ¥è¯¢ç»“æœ

ç¼“å­˜æœºåˆ¶æ‰§è¡Œï¼š
ç¬¬ä¸€æ¬¡æ‰§è¡Œåå°†ç»“æœä¿å­˜åœ¨å†…å­˜
åç»­ç›¸åŒå­æŸ¥è¯¢ç›´æ¥ä½¿ç”¨ç¼“å­˜ç»“æœ

æ ¸å¿ƒç›®æ ‡ï¼š
â€¢ å‡å°‘é‡å¤è®¡ç®—å¼€é”€
â€¢ æå‡æŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦
â€¢ é™ä½ç³»ç»Ÿèµ„æºæ¶ˆè€—
â€¢ æ”¹å–„ç”¨æˆ·ä½“éªŒ
```

**ğŸ’¡ å­æŸ¥è¯¢ç¼“å­˜çš„ä½œç”¨æœºåˆ¶**
```
ç¼“å­˜å·¥ä½œæµç¨‹ï¼š

1. è§£æé˜¶æ®µï¼šè¯†åˆ«å­æŸ¥è¯¢å†…å®¹
   â†“
2. ç¼“å­˜æ£€æŸ¥ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰åŒ¹é…çš„ç¼“å­˜
   â†“
3. æ‰§è¡Œå†³ç­–ï¼š
   - æœ‰ç¼“å­˜ â†’ ç›´æ¥è¿”å›ç»“æœ
   - æ— ç¼“å­˜ â†’ æ‰§è¡ŒæŸ¥è¯¢å¹¶ç¼“å­˜ç»“æœ
   â†“
4. ç»“æœä½¿ç”¨ï¼šä¸»æŸ¥è¯¢ä½¿ç”¨å­æŸ¥è¯¢ç»“æœ
```

### 1.2 ç¼“å­˜ç±»å‹åˆ†ç±»


**ğŸ“‹ ä¸¤å¤§æ ¸å¿ƒç¼“å­˜ç±»å‹**

| ç¼“å­˜ç±»å‹ | **ç¼“å­˜å†…å®¹** | **ç”Ÿæ•ˆèŒƒå›´** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| **ç»“æœç¼“å­˜** | `æŸ¥è¯¢ç»“æœæ•°æ®` | `å•ä¸ªæŸ¥è¯¢æ‰§è¡Œå‘¨æœŸ` | `ç›¸åŒå­æŸ¥è¯¢å¤šæ¬¡ä½¿ç”¨` |
| **è®¡åˆ’ç¼“å­˜** | `æ‰§è¡Œè®¡åˆ’` | `è·¨æŸ¥è¯¢ä¼šè¯` | `ç»“æ„ç›¸ä¼¼çš„å­æŸ¥è¯¢` |

**ğŸ”§ ç¼“å­˜ç”Ÿæ•ˆç¤ºä¾‹**
```sql
-- ç¤ºä¾‹ï¼šç»“æœç¼“å­˜ç”Ÿæ•ˆ
SELECT o.order_id, o.customer_id,
       (SELECT COUNT(*) FROM order_items WHERE order_id = o.order_id) as item_count,
       (SELECT COUNT(*) FROM order_items WHERE order_id = o.order_id) as item_count_copy
FROM orders o;

-- ç¬¬äºŒä¸ªå­æŸ¥è¯¢ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ªå­æŸ¥è¯¢çš„ç¼“å­˜ç»“æœ
-- é¿å…é‡å¤æ‰§è¡Œç›¸åŒçš„å­æŸ¥è¯¢è®¡ç®—
```

### 1.3 ç¼“å­˜çš„æ€§èƒ½ä»·å€¼


**âš¡ æ€§èƒ½æå‡æ•ˆæœ**
```
æ²¡æœ‰ç¼“å­˜çš„æ‰§è¡Œï¼š
æŸ¥è¯¢1000ä¸ªè®¢å•ï¼Œæ¯ä¸ªè®¢å•æ‰§è¡Œ2æ¬¡ç›¸åŒå­æŸ¥è¯¢
æ€»æ‰§è¡Œæ¬¡æ•°ï¼š1000 Ã— 2 = 2000æ¬¡å­æŸ¥è¯¢

æœ‰ç¼“å­˜çš„æ‰§è¡Œï¼š
ç¬¬ä¸€æ¬¡æ‰§è¡Œå­æŸ¥è¯¢å¹¶ç¼“å­˜ç»“æœ
ç¬¬äºŒæ¬¡ç›´æ¥ä½¿ç”¨ç¼“å­˜
æ€»æ‰§è¡Œæ¬¡æ•°ï¼š1000æ¬¡å­æŸ¥è¯¢ï¼ˆå‡å°‘50%ï¼‰

å®é™…æ€§èƒ½æå‡ï¼š
â€¢ CPUä½¿ç”¨ç‡é™ä½30-60%
â€¢ å†…å­˜è®¿é—®æ¬¡æ•°å‡å°‘
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´æ”¹å–„40-80%
```

---

## 2. ğŸ—„ï¸ å­æŸ¥è¯¢ç»“æœç¼“å­˜æœºåˆ¶


### 2.1 ç»“æœç¼“å­˜çš„å·¥ä½œåŸç†


**ğŸ”¸ ç¼“å­˜å·¥ä½œæœºåˆ¶è¯¦è§£**
```
ç»“æœç¼“å­˜ç”Ÿå‘½å‘¨æœŸï¼š

1. ç¼“å­˜åˆ›å»º
   - å­æŸ¥è¯¢é¦–æ¬¡æ‰§è¡Œæ—¶åˆ›å»º
   - ç»“æœæ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­
   - ä¸ºç¼“å­˜é¡¹åˆ†é…å”¯ä¸€æ ‡è¯†

2. ç¼“å­˜ä½¿ç”¨
   - ç›¸åŒå­æŸ¥è¯¢æ£€æŸ¥ç¼“å­˜
   - ç›´æ¥è¿”å›å·²ç¼“å­˜çš„ç»“æœ
   - é¿å…é‡æ–°æ‰§è¡Œæ•°æ®åº“æ“ä½œ

3. ç¼“å­˜é”€æ¯
   - æŸ¥è¯¢æ‰§è¡Œå®Œæ¯•åé‡Šæ”¾
   - å†…å­˜ç©ºé—´é‡æ–°å›æ”¶
   - ä¸ºä¸‹æ¬¡æŸ¥è¯¢å‡†å¤‡ç©ºé—´
```

**ğŸ’¾ ç¼“å­˜å­˜å‚¨ç»“æ„**
```
ç¼“å­˜æ•°æ®ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¼“å­˜ç®¡ç†å™¨         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜é¡¹1              â”‚
â”‚ â”œâ”€ æŸ¥è¯¢Hash         â”‚
â”‚ â”œâ”€ ç»“æœæ•°æ®         â”‚
â”‚ â”œâ”€ åˆ›å»ºæ—¶é—´         â”‚
â”‚ â””â”€ è®¿é—®æ¬¡æ•°         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼“å­˜é¡¹2              â”‚
â”‚ â”œâ”€ æŸ¥è¯¢Hash         â”‚
â”‚ â”œâ”€ ç»“æœæ•°æ®         â”‚
â”‚ â”œâ”€ åˆ›å»ºæ—¶é—´         â”‚
â”‚ â””â”€ è®¿é—®æ¬¡æ•°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç¼“å­˜åŒ¹é…æœºåˆ¶


**ğŸ” å¦‚ä½•åˆ¤æ–­å­æŸ¥è¯¢æ˜¯å¦ç›¸åŒ**
```sql
-- ç¤ºä¾‹1ï¼šå®Œå…¨ç›¸åŒçš„å­æŸ¥è¯¢ï¼ˆå¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼‰
SELECT 
    customer_name,
    (SELECT AVG(amount) FROM orders WHERE customer_id = c.customer_id),
    (SELECT AVG(amount) FROM orders WHERE customer_id = c.customer_id)
FROM customers c;

-- ç¤ºä¾‹2ï¼šå‚æ•°ä¸åŒçš„å­æŸ¥è¯¢ï¼ˆä¸èƒ½ä½¿ç”¨ç¼“å­˜ï¼‰
SELECT 
    customer_name,
    (SELECT COUNT(*) FROM orders WHERE customer_id = 1),
    (SELECT COUNT(*) FROM orders WHERE customer_id = 2)
FROM customers c;
```

**ğŸ“‹ ç¼“å­˜åŒ¹é…æ¡ä»¶**
```
åŒ¹é…è¦æ±‚ï¼š
âœ… SQLè¯­å¥å®Œå…¨ç›¸åŒ
âœ… å‚æ•°å€¼å®Œå…¨ç›¸åŒ
âœ… æ‰§è¡Œç¯å¢ƒç›¸åŒ
âœ… æ•°æ®æ²¡æœ‰å‘ç”Ÿå˜åŒ–

ä¸åŒ¹é…æƒ…å†µï¼š
âŒ å­æŸ¥è¯¢æ–‡æœ¬ä¸åŒ
âŒ å‚æ•°å€¼ä¸åŒ
âŒ è¡¨ç»“æ„å‘ç”Ÿå˜åŒ–
âŒ ç›¸å…³æ•°æ®è¢«ä¿®æ”¹
```

### 2.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹åº”ç”¨ç¤ºä¾‹**
```sql
-- åœºæ™¯1ï¼šç»Ÿè®¡æŸ¥è¯¢ä¸­çš„é‡å¤è®¡ç®—
SELECT 
    department_name,
    total_employees,
    avg_salary,
    -- é‡å¤çš„å­æŸ¥è¯¢ä¼šè¢«ç¼“å­˜
    (SELECT COUNT(*) FROM employees WHERE dept_id = d.dept_id) as emp_count_1,
    (SELECT COUNT(*) FROM employees WHERE dept_id = d.dept_id) as emp_count_2,
    -- è®¡ç®—æ¯”ä¾‹æ—¶é‡å¤ä½¿ç”¨ç›¸åŒç»“æœ
    (SELECT COUNT(*) FROM employees WHERE dept_id = d.dept_id) / 100.0 as percentage
FROM departments d;

-- åœºæ™¯2ï¼šå¤æ‚æŠ¥è¡¨ä¸­çš„é‡å¤å­æŸ¥è¯¢
SELECT 
    product_name,
    category,
    -- é”€å”®æ€»é‡è®¡ç®—ï¼ˆå¤šå¤„ä½¿ç”¨ï¼‰
    (SELECT SUM(quantity) FROM sales WHERE product_id = p.product_id) as total_sales,
    -- æœˆåº¦é”€å”®ï¼ˆä½¿ç”¨ç›¸åŒçš„é”€å”®æ•°æ®ï¼‰
    (SELECT SUM(quantity) FROM sales WHERE product_id = p.product_id) / 12 as monthly_avg,
    -- å¸‚åœºä»½é¢è®¡ç®—ï¼ˆå†æ¬¡ä½¿ç”¨ç›¸åŒæ•°æ®ï¼‰
    (SELECT SUM(quantity) FROM sales WHERE product_id = p.product_id) * 100.0 / 
    (SELECT SUM(quantity) FROM sales) as market_share
FROM products p;
```

### 2.4 ç¼“å­˜æ€§èƒ½æ•ˆæœæµ‹è¯•


**ğŸ“Š æ€§èƒ½å¯¹æ¯”æµ‹è¯•**
```sql
-- æµ‹è¯•ç”¨ä¾‹ï¼šå¯¹æ¯”æœ‰æ— ç¼“å­˜çš„æ€§èƒ½å·®å¼‚
-- åˆ›å»ºæµ‹è¯•æ•°æ®
CREATE TABLE test_orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE,
    amount DECIMAL(10,2)
);

-- æ’å…¥10ä¸‡æ¡æµ‹è¯•æ•°æ®
INSERT INTO test_orders 
SELECT 
    seq,
    FLOOR(seq/100) + 1,
    DATE_ADD('2024-01-01', INTERVAL seq DAY),
    ROUND(RAND() * 1000, 2)
FROM (
    SELECT @row := @row + 1 as seq
    FROM (SELECT 0 UNION ALL SELECT 1 UNION ALL SELECT 2) t1,
         (SELECT 0 UNION ALL SELECT 1 UNION ALL SELECT 2) t2,
         (SELECT 0 UNION ALL SELECT 1 UNION ALL SELECT 2) t3,
         (SELECT @row := 0) r
    LIMIT 100000
) nums;

-- æ€§èƒ½æµ‹è¯•æŸ¥è¯¢ï¼ˆåŒ…å«é‡å¤å­æŸ¥è¯¢ï¼‰
SELECT 
    customer_id,
    -- é‡å¤çš„å­æŸ¥è¯¢ - ç¬¬1æ¬¡
    (SELECT COUNT(*) FROM test_orders t2 WHERE t2.customer_id = t1.customer_id) as order_count_1,
    -- é‡å¤çš„å­æŸ¥è¯¢ - ç¬¬2æ¬¡  
    (SELECT COUNT(*) FROM test_orders t2 WHERE t2.customer_id = t1.customer_id) as order_count_2,
    -- é‡å¤çš„å­æŸ¥è¯¢ - ç¬¬3æ¬¡
    (SELECT COUNT(*) FROM test_orders t2 WHERE t2.customer_id = t1.customer_id) as order_count_3
FROM test_orders t1
GROUP BY customer_id
LIMIT 1000;
```

---

## 3. ğŸ“‹ å­æŸ¥è¯¢è®¡åˆ’ç¼“å­˜è¯¦è§£


### 3.1 æ‰§è¡Œè®¡åˆ’ç¼“å­˜æœºåˆ¶


**ğŸ”¸ è®¡åˆ’ç¼“å­˜çš„ä½œç”¨**
```
æ‰§è¡Œè®¡åˆ’ç”Ÿæˆè¿‡ç¨‹ï¼š
SQLè§£æ â†’ è¯­æ³•åˆ†æ â†’ ä¼˜åŒ–å™¨åˆ†æ â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’

æ²¡æœ‰è®¡åˆ’ç¼“å­˜ï¼š
æ¯æ¬¡æ‰§è¡Œéƒ½è¦é‡å¤ä¸Šè¿°è¿‡ç¨‹
æ¶ˆè€—CPUèµ„æºè¿›è¡Œä¼˜åŒ–è®¡ç®—

æœ‰è®¡åˆ’ç¼“å­˜ï¼š
ç›¸ä¼¼æŸ¥è¯¢é‡å¤ä½¿ç”¨å·²æœ‰è®¡åˆ’
è·³è¿‡ä¼˜åŒ–è¿‡ç¨‹ï¼Œç›´æ¥æ‰§è¡Œ
æ˜¾è‘—å‡å°‘æŸ¥è¯¢å“åº”æ—¶é—´
```

**ğŸ”§ è®¡åˆ’ç¼“å­˜ç¤ºä¾‹**
```sql
-- ç¤ºä¾‹ï¼šå‚æ•°åŒ–æŸ¥è¯¢çš„è®¡åˆ’ç¼“å­˜
-- ç¬¬ä¸€æ¬¡æ‰§è¡Œ
SELECT * FROM products WHERE category_id = 1 AND price > 100;

-- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼ˆç»“æ„ç›¸åŒï¼Œå‚æ•°ä¸åŒï¼‰
SELECT * FROM products WHERE category_id = 2 AND price > 200;

-- ç¬¬äºŒæ¬¡æŸ¥è¯¢å¯ä»¥é‡ç”¨ç¬¬ä¸€æ¬¡çš„æ‰§è¡Œè®¡åˆ’
-- åªéœ€è¦æ›¿æ¢å‚æ•°å€¼å³å¯æ‰§è¡Œ
```

### 3.2 è®¡åˆ’ç¼“å­˜çš„ç”Ÿæ•ˆæ¡ä»¶


**ğŸ“‹ ç¼“å­˜ç”Ÿæ•ˆè¦æ±‚**
```
ç»“æ„åŒ¹é…æ¡ä»¶ï¼š
âœ… SQLç»“æ„ç›¸åŒ
âœ… è¡¨ç»“æ„ç›¸åŒ
âœ… ç´¢å¼•ç»“æ„ç›¸åŒ
âœ… æŸ¥è¯¢ç±»å‹ç›¸åŒ

å‚æ•°åŒ–æ¡ä»¶ï¼š
âœ… WHEREæ¡ä»¶ç»“æ„ç›¸åŒ
âœ… JOINæ¡ä»¶ç»“æ„ç›¸åŒ
âœ… ORDER BYç»“æ„ç›¸åŒ
âœ… GROUP BYç»“æ„ç›¸åŒ

ç¯å¢ƒæ¡ä»¶ï¼š
âœ… æ•°æ®åº“ç‰ˆæœ¬ç›¸åŒ
âœ… é…ç½®å‚æ•°ç›¸åŒ
âœ… ç»Ÿè®¡ä¿¡æ¯æœ‰æ•ˆ
âœ… æƒé™è®¾ç½®ç›¸åŒ
```

**ğŸ”§ è®¡åˆ’ç¼“å­˜é…ç½®**
```sql
-- MySQLä¸­æŸ¥çœ‹è®¡åˆ’ç¼“å­˜ç›¸å…³å‚æ•°
SHOW VARIABLES LIKE '%query_cache%';

-- å¯ç”¨è®¡åˆ’ç¼“å­˜ï¼ˆå¦‚æœæ”¯æŒï¼‰
SET GLOBAL query_cache_type = ON;
SET GLOBAL query_cache_size = 64*1024*1024; -- 64MB

-- æŸ¥çœ‹è®¡åˆ’ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
SHOW STATUS LIKE 'Qcache%';
```

### 3.3 è®¡åˆ’ç¼“å­˜çš„ç®¡ç†ç­–ç•¥


**ğŸ› ï¸ ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
ç¼“å­˜ç®¡ç†ç­–ç•¥ï¼š

1. LRUæ·˜æ±°ç­–ç•¥
   - æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„è®¡åˆ’è¢«æ·˜æ±°
   - ä¸ºæ–°è®¡åˆ’è…¾å‡ºç©ºé—´
   - ä¿æŒç¼“å­˜æ± æ•ˆç‡

2. å¤§å°é™åˆ¶ç­–ç•¥
   - è®¾ç½®ç¼“å­˜æ± æœ€å¤§å¤§å°
   - é˜²æ­¢å†…å­˜è¿‡åº¦å ç”¨
   - å¹³è¡¡æ€§èƒ½å’Œèµ„æºæ¶ˆè€—

3. å¤±æ•ˆæ£€æµ‹ç­–ç•¥
   - è¡¨ç»“æ„å˜åŒ–æ—¶å¤±æ•ˆ
   - ç´¢å¼•å˜åŒ–æ—¶å¤±æ•ˆ
   - ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æ—¶å¤±æ•ˆ
```

---

## 4. âš™ï¸ ç¼“å­˜ç”Ÿæ•ˆæ¡ä»¶ä¸ç­–ç•¥


### 4.1 ç¼“å­˜ç”Ÿæ•ˆçš„åŸºæœ¬æ¡ä»¶


**ğŸ”¸ ç»“æœç¼“å­˜ç”Ÿæ•ˆæ¡ä»¶**
```sql
-- æ¡ä»¶1ï¼šå­æŸ¥è¯¢å®Œå…¨ç›¸åŒ
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count_copy
FROM customers c;
-- âœ… ç¬¬äºŒä¸ªå­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ä¸ªçš„ç¼“å­˜

-- æ¡ä»¶2ï¼šåœ¨åŒä¸€ä¸ªæŸ¥è¯¢æ‰§è¡Œå‘¨æœŸå†…
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count
FROM customers c;
-- å•æ¬¡æŸ¥è¯¢ä¸­ï¼Œæ¯ä¸ªcustomer_idå¯¹åº”çš„å­æŸ¥è¯¢ä¼šç¼“å­˜

-- æ¡ä»¶3ï¼šæ•°æ®æœªå‘ç”Ÿå˜åŒ–
-- å¦‚æœåœ¨æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œordersè¡¨æ•°æ®è¢«ä¿®æ”¹
-- ç¼“å­˜ä¼šå¤±æ•ˆï¼Œé‡æ–°æ‰§è¡Œå­æŸ¥è¯¢
```

**âŒ ç¼“å­˜ä¸ç”Ÿæ•ˆçš„æƒ…å†µ**
```sql
-- æƒ…å†µ1ï¼šå­æŸ¥è¯¢æ–‡æœ¬ä¸åŒ
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id),
       (SELECT COUNT(order_id) FROM orders WHERE customer_id = c.customer_id)
FROM customers c;
-- è™½ç„¶é€»è¾‘ç›¸åŒï¼Œä½†SQLæ–‡æœ¬ä¸åŒï¼Œæ— æ³•ä½¿ç”¨ç¼“å­˜

-- æƒ…å†µ2ï¼šåŒ…å«ä¸ç¡®å®šå‡½æ•°
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id AND order_date = NOW()),
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id AND order_date = NOW())
FROM customers c;
-- NOW()å‡½æ•°æ¯æ¬¡è°ƒç”¨ç»“æœå¯èƒ½ä¸åŒï¼Œæ— æ³•ç¼“å­˜

-- æƒ…å†µ3ï¼šæ¶‰åŠç”¨æˆ·å˜é‡æˆ–ä¼šè¯ç›¸å…³å‡½æ•°
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id AND created_by = USER()),
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id AND created_by = USER())
FROM customers c;
-- USER()å‡½æ•°ç»“æœä¾èµ–ä¼šè¯ï¼Œæ— æ³•å®‰å…¨ç¼“å­˜
```

### 4.2 ç¼“å­˜ç­–ç•¥é…ç½®


**ğŸ”§ æ•°æ®åº“çº§åˆ«çš„ç¼“å­˜é…ç½®**
```sql
-- MySQL æŸ¥è¯¢ç¼“å­˜é…ç½®
-- æ£€æŸ¥å½“å‰ç¼“å­˜çŠ¶æ€
SHOW VARIABLES LIKE 'query_cache%';

-- é…ç½®ç¤ºä¾‹ç»“æœï¼š
-- query_cache_type: ON/OFF/DEMAND
-- query_cache_size: ç¼“å­˜æ± å¤§å°ï¼ˆå­—èŠ‚ï¼‰
-- query_cache_limit: å•ä¸ªæŸ¥è¯¢ç»“æœæœ€å¤§ç¼“å­˜å¤§å°
-- query_cache_min_res_unit: æœ€å°åˆ†é…å•å…ƒ

-- ä¼˜åŒ–é…ç½®å»ºè®®
SET GLOBAL query_cache_type = ON;
SET GLOBAL query_cache_size = 128*1024*1024;  -- 128MB
SET GLOBAL query_cache_limit = 4*1024*1024;    -- 4MBå•æŸ¥è¯¢é™åˆ¶
```

**ğŸ“Š ç¼“å­˜æ•ˆæœç›‘æ§**
```sql
-- æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
SHOW STATUS LIKE 'Qcache%';

-- å…³é”®æŒ‡æ ‡è§£è¯»ï¼š
-- Qcache_hits: ç¼“å­˜å‘½ä¸­æ¬¡æ•°
-- Qcache_inserts: ç¼“å­˜æ’å…¥æ¬¡æ•°  
-- Qcache_not_cached: æœªç¼“å­˜æŸ¥è¯¢æ•°
-- Qcache_queries_in_cache: å½“å‰ç¼“å­˜æŸ¥è¯¢æ•°

-- è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
SELECT 
    ROUND(
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') /
        ((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') +
         (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_inserts')) * 100,
        2
    ) as cache_hit_rate_percent;
```

### 4.3 åº”ç”¨çº§ç¼“å­˜ç­–ç•¥


**ğŸ¯ ä¸šåŠ¡å±‚é¢çš„ç¼“å­˜è®¾è®¡**
```sql
-- ç­–ç•¥1ï¼šåˆå¹¶ç›¸åŒå­æŸ¥è¯¢
-- åŸå§‹å†™æ³•ï¼ˆç¼“å­˜å‹å¥½ï¼‰
SELECT 
    product_name,
    (SELECT COUNT(*) FROM sales WHERE product_id = p.product_id) as total_sales,
    (SELECT COUNT(*) FROM sales WHERE product_id = p.product_id) / 12 as monthly_avg
FROM products p;

-- ç­–ç•¥2ï¼šä½¿ç”¨JOINæ›¿ä»£é‡å¤å­æŸ¥è¯¢ï¼ˆæ›´é«˜æ•ˆï¼‰
SELECT 
    p.product_name,
    COALESCE(s.total_sales, 0) as total_sales,
    COALESCE(s.total_sales, 0) / 12 as monthly_avg
FROM products p
LEFT JOIN (
    SELECT 
        product_id, 
        COUNT(*) as total_sales
    FROM sales 
    GROUP BY product_id
) s ON p.product_id = s.product_id;
```

---

## 5. ğŸ”„ ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°æœºåˆ¶


### 5.1 ç¼“å­˜å¤±æ•ˆçš„è§¦å‘æ¡ä»¶


**ğŸš¨ è‡ªåŠ¨å¤±æ•ˆåœºæ™¯**
```
æ•°æ®å˜æ›´è§¦å‘å¤±æ•ˆï¼š
â€¢ INSERTæ“ä½œ â†’ ç›¸å…³è¡¨ç¼“å­˜å¤±æ•ˆ
â€¢ UPDATEæ“ä½œ â†’ å½±å“è¡Œçš„ç¼“å­˜å¤±æ•ˆ
â€¢ DELETEæ“ä½œ â†’ ç›¸å…³è¡¨ç¼“å­˜å¤±æ•ˆ
â€¢ TRUNCATEæ“ä½œ â†’ æ•´è¡¨ç¼“å­˜æ¸…ç©º

ç»“æ„å˜æ›´è§¦å‘å¤±æ•ˆï¼š
â€¢ ALTER TABLE â†’ è¡¨ç›¸å…³ç¼“å­˜å…¨éƒ¨å¤±æ•ˆ
â€¢ CREATE INDEX â†’ å¯èƒ½å½±å“æ‰§è¡Œè®¡åˆ’ç¼“å­˜
â€¢ DROP INDEX â†’ æ‰§è¡Œè®¡åˆ’ç¼“å­˜å¤±æ•ˆ
â€¢ ç»Ÿè®¡ä¿¡æ¯æ›´æ–° â†’ è®¡åˆ’ç¼“å­˜é‡æ–°è¯„ä¼°
```

**ğŸ”§ å¤±æ•ˆæµ‹è¯•ç¤ºä¾‹**
```sql
-- åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
CREATE TABLE cache_test (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    category_id INT
);

INSERT INTO cache_test VALUES (1, 'Product A', 1), (2, 'Product B', 1);

-- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼ˆå»ºç«‹ç¼“å­˜ï¼‰
SELECT name,
       (SELECT COUNT(*) FROM cache_test ct WHERE ct.category_id = t.category_id) as count1,
       (SELECT COUNT(*) FROM cache_test ct WHERE ct.category_id = t.category_id) as count2
FROM cache_test t;

-- ä¿®æ”¹æ•°æ®ï¼ˆè§¦å‘ç¼“å­˜å¤±æ•ˆï¼‰
INSERT INTO cache_test VALUES (3, 'Product C', 1);

-- å†æ¬¡æ‰§è¡Œç›¸åŒæŸ¥è¯¢ï¼ˆç¼“å­˜å·²å¤±æ•ˆï¼Œé‡æ–°è®¡ç®—ï¼‰
SELECT name,
       (SELECT COUNT(*) FROM cache_test ct WHERE ct.category_id = t.category_id) as count1,
       (SELECT COUNT(*) FROM cache_test ct WHERE ct.category_id = t.category_id) as count2
FROM cache_test t;
```

### 5.2 æ‰‹åŠ¨ç¼“å­˜ç®¡ç†


**ğŸ› ï¸ æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜**
```sql
-- MySQLä¸­æ‰‹åŠ¨æ¸…ç©ºæŸ¥è¯¢ç¼“å­˜
FLUSH QUERY CACHE;  -- æ¸…ç†ç¼“å­˜ç¢ç‰‡
RESET QUERY CACHE;  -- å®Œå…¨æ¸…ç©ºç¼“å­˜

-- æ£€æŸ¥æ¸…ç©ºæ•ˆæœ
SHOW STATUS LIKE 'Qcache_queries_in_cache';  -- åº”è¯¥æ˜¾ç¤º0

-- ç¦ç”¨ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜
SELECT SQL_NO_CACHE customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id)
FROM customers c;
```

**âš™ï¸ ç¼“å­˜ç»´æŠ¤ç­–ç•¥**
```sql
-- å®šæœŸç»´æŠ¤è„šæœ¬
-- 1. ç›‘æ§ç¼“å­˜ä½¿ç”¨æƒ…å†µ
SELECT 
    ROUND(
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_free_memory') /
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES WHERE VARIABLE_NAME='query_cache_size') * 100,
        2
    ) as free_memory_percent;

-- 2. å½“ç¢ç‰‡è¿‡å¤šæ—¶æ¸…ç†ç¼“å­˜
-- å¦‚æœç¢ç‰‡ç‡ > 20%ï¼Œæ‰§è¡Œç¢ç‰‡æ¸…ç†
FLUSH QUERY CACHE;

-- 3. ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
-- å¦‚æœå‘½ä¸­ç‡ < 30%ï¼Œè€ƒè™‘è°ƒæ•´ç¼“å­˜ç­–ç•¥
```

### 5.3 ç¼“å­˜æ›´æ–°ç­–ç•¥ä¼˜åŒ–


**ğŸ”„ æ™ºèƒ½æ›´æ–°ç­–ç•¥**
```sql
-- ç­–ç•¥1ï¼šå¢é‡æ›´æ–°å‹å¥½çš„æŸ¥è¯¢è®¾è®¡
-- é¿å…ä½¿ç”¨å½±å“å…¨è¡¨çš„å­æŸ¥è¯¢
-- åŸå§‹å†™æ³•ï¼ˆæ›´æ–°å½±å“å¤§ï¼‰
SELECT customer_name,
       (SELECT COUNT(*) FROM orders) as total_orders,  -- ä»»ä½•è®¢å•å˜åŒ–éƒ½å½±å“æ­¤ç¼“å­˜
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as customer_orders
FROM customers c;

-- ä¼˜åŒ–å†™æ³•ï¼ˆæ›´æ–°å½±å“å°ï¼‰
SELECT customer_name,
       (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as customer_orders
FROM customers c;
-- æ€»è®¢å•æ•°é€šè¿‡å…¶ä»–æ–¹å¼è·å–ï¼Œå‡å°‘ç¼“å­˜å¤±æ•ˆå½±å“

-- ç­–ç•¥2ï¼šæ—¶é—´åˆ†åŒºæŸ¥è¯¢
SELECT customer_name,
       (SELECT COUNT(*) 
        FROM orders 
        WHERE customer_id = c.customer_id 
          AND DATE(order_date) = CURDATE()) as today_orders
FROM customers c;
-- æŒ‰æ—¥æœŸåˆ†åŒºçš„æŸ¥è¯¢ï¼Œå†å²æ•°æ®ç¼“å­˜ä¸ä¼šå› æ–°æ•°æ®è€Œå¤±æ•ˆ
```

---

## 6. ğŸ”§ é‡å¤å­æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯


### 6.1 è¯†åˆ«é‡å¤å­æŸ¥è¯¢


**ğŸ” é‡å¤æ¨¡å¼è¯†åˆ«**
```sql
-- æ¨¡å¼1ï¼šå®Œå…¨ç›¸åŒçš„å­æŸ¥è¯¢
SELECT 
    order_id,
    customer_id,
    (SELECT customer_name FROM customers WHERE customer_id = o.customer_id) as name1,
    (SELECT customer_name FROM customers WHERE customer_id = o.customer_id) as name2
FROM orders o;

-- æ¨¡å¼2ï¼šé€»è¾‘ç›¸åŒä½†è¡¨è¾¾ä¸åŒçš„å­æŸ¥è¯¢
SELECT 
    product_id,
    product_name,
    (SELECT COUNT(*) FROM sales WHERE product_id = p.product_id) as sales_count,
    (SELECT COUNT(sale_id) FROM sales WHERE product_id = p.product_id) as sales_count2
FROM products p;

-- æ¨¡å¼3ï¼šåµŒå¥—å­æŸ¥è¯¢ä¸­çš„é‡å¤
SELECT 
    customer_id,
    (SELECT COUNT(*) FROM orders 
     WHERE customer_id = c.customer_id 
       AND order_date > (SELECT MIN(order_date) FROM orders WHERE customer_id = c.customer_id)
    ) as recent_orders,
    (SELECT MIN(order_date) FROM orders WHERE customer_id = c.customer_id) as first_order_date
FROM customers c;
```

### 6.2 å­æŸ¥è¯¢æå‡æŠ€æœ¯


**ğŸš€ æŸ¥è¯¢é‡æ„ä¼˜åŒ–**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆå¤šä¸ªé‡å¤å­æŸ¥è¯¢ï¼‰
SELECT 
    o.order_id,
    o.customer_id,
    (SELECT customer_name FROM customers WHERE customer_id = o.customer_id) as customer_name,
    (SELECT customer_email FROM customers WHERE customer_id = o.customer_id) as customer_email,
    (SELECT customer_phone FROM customers WHERE customer_id = o.customer_id) as customer_phone
FROM orders o;

-- ä¼˜åŒ–åï¼ˆä½¿ç”¨JOINæ¶ˆé™¤é‡å¤ï¼‰
SELECT 
    o.order_id,
    o.customer_id,
    c.customer_name,
    c.customer_email,
    c.customer_phone
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.customer_id;

-- æ€§èƒ½æå‡æ•ˆæœï¼š
-- â€¢ æ¶ˆé™¤äº†3ä¸ªé‡å¤çš„å­æŸ¥è¯¢
-- â€¢ å‡å°‘äº†ä¸å¿…è¦çš„è¡¨è®¿é—®
-- â€¢ æé«˜äº†æŸ¥è¯¢æ‰§è¡Œæ•ˆç‡
```

### 6.3 å…¬ç”¨è¡¨è¡¨è¾¾å¼(CTE)ä¼˜åŒ–


**ğŸ“Š ä½¿ç”¨CTEæ¶ˆé™¤é‡å¤è®¡ç®—**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆé‡å¤çš„ç»Ÿè®¡å­æŸ¥è¯¢ï¼‰
SELECT 
    department_id,
    department_name,
    (SELECT COUNT(*) FROM employees WHERE dept_id = d.department_id) as emp_count,
    (SELECT AVG(salary) FROM employees WHERE dept_id = d.department_id) as avg_salary,
    (SELECT COUNT(*) FROM employees WHERE dept_id = d.department_id) * 1000 as budget_estimate
FROM departments d;

-- CTEä¼˜åŒ–ï¼ˆè®¡ç®—ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼‰
WITH dept_stats AS (
    SELECT 
        dept_id,
        COUNT(*) as emp_count,
        AVG(salary) as avg_salary
    FROM employees 
    GROUP BY dept_id
)
SELECT 
    d.department_id,
    d.department_name,
    COALESCE(ds.emp_count, 0) as emp_count,
    COALESCE(ds.avg_salary, 0) as avg_salary,
    COALESCE(ds.emp_count, 0) * 1000 as budget_estimate
FROM departments d
LEFT JOIN dept_stats ds ON d.department_id = ds.dept_id;
```

### 6.4 çª—å£å‡½æ•°æ›¿ä»£æ–¹æ¡ˆ


**ğŸªŸ ä½¿ç”¨çª—å£å‡½æ•°ä¼˜åŒ–é‡å¤è®¡ç®—**
```sql
-- åŸå§‹æŸ¥è¯¢ï¼ˆæ¯è¡Œéƒ½æ‰§è¡Œå­æŸ¥è¯¢ï¼‰
SELECT 
    employee_id,
    employee_name,
    salary,
    (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id) as dept_avg_salary,
    salary - (SELECT AVG(salary) FROM employees WHERE department_id = e.department_id) as salary_diff
FROM employees e;

-- çª—å£å‡½æ•°ä¼˜åŒ–ï¼ˆè®¡ç®—ä¸€æ¬¡åˆ†åŒºå†…æ‰€æœ‰è¡Œå…±äº«ï¼‰
SELECT 
    employee_id,
    employee_name,
    salary,
    AVG(salary) OVER (PARTITION BY department_id) as dept_avg_salary,
    salary - AVG(salary) OVER (PARTITION BY department_id) as salary_diff
FROM employees;

-- ä¼˜åŠ¿åˆ†æï¼š
-- â€¢ é¿å…äº†é‡å¤çš„å­æŸ¥è¯¢æ‰§è¡Œ
-- â€¢ çª—å£å‡½æ•°è®¡ç®—æ›´é«˜æ•ˆ
-- â€¢ ä»£ç æ›´ç®€æ´æ˜“æ‡‚
```

---

## 7. ğŸ“ˆ ç¼“å­˜æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


### 7.1 ç¼“å­˜æ€§èƒ½æŒ‡æ ‡ç›‘æ§


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- 1. ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
SELECT 
    'Cache Hit Rate' as metric,
    ROUND(
        Qcache_hits / (Qcache_hits + Qcache_inserts) * 100, 2
    ) as value_percent,
    CASE 
        WHEN Qcache_hits / (Qcache_hits + Qcache_inserts) * 100 > 80 THEN 'Excellent'
        WHEN Qcache_hits / (Qcache_hits + Qcache_inserts) * 100 > 60 THEN 'Good'
        WHEN Qcache_hits / (Qcache_hits + Qcache_inserts) * 100 > 40 THEN 'Fair'
        ELSE 'Poor'
    END as performance_level
FROM (
    SELECT 
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') as Qcache_hits,
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_inserts') as Qcache_inserts
) cache_stats;

-- 2. ç¼“å­˜å†…å­˜ä½¿ç”¨ç›‘æ§
SELECT 
    'Cache Memory Usage' as metric,
    ROUND(
        (query_cache_size - Qcache_free_memory) / query_cache_size * 100, 2
    ) as usage_percent,
    ROUND(Qcache_free_memory / 1024 / 1024, 2) as free_mb,
    ROUND(query_cache_size / 1024 / 1024, 2) as total_mb
FROM (
    SELECT 
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES WHERE VARIABLE_NAME='query_cache_size') as query_cache_size,
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_free_memory') as Qcache_free_memory
) cache_memory;

-- 3. ç¼“å­˜ç¢ç‰‡ç‡ç›‘æ§  
SELECT 
    'Cache Fragmentation' as metric,
    ROUND(Qcache_free_blocks / Qcache_queries_in_cache * 100, 2) as fragmentation_percent,
    Qcache_free_blocks as free_blocks,
    Qcache_queries_in_cache as cached_queries
FROM (
    SELECT 
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_free_blocks') as Qcache_free_blocks,
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_queries_in_cache') as Qcache_queries_in_cache
) cache_frag;
```

### 7.2 æ€§èƒ½åŸºå‡†æµ‹è¯•


**ğŸ§ª ç¼“å­˜æ•ˆæœæµ‹è¯•æ¡†æ¶**
```sql
-- åˆ›å»ºæ€§èƒ½æµ‹è¯•ç¨‹åº
DELIMITER //
CREATE PROCEDURE test_subquery_cache_performance()
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE start_time TIMESTAMP;
    DECLARE end_time TIMESTAMP;
    
    -- æ¸…ç©ºç¼“å­˜ï¼Œè·å¾—åŸºå‡†æµ‹è¯•
    RESET QUERY CACHE;
    
    SET start_time = NOW(6);
    
    -- æ‰§è¡ŒåŒ…å«é‡å¤å­æŸ¥è¯¢çš„æµ‹è¯•
    WHILE i <= 1000 DO
        SELECT 
            customer_id,
            (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count,
            (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count_dup,
            (SELECT SUM(amount) FROM orders WHERE customer_id = c.customer_id) as total_amount
        FROM customers c 
        WHERE customer_id = i;
        
        SET i = i + 1;
    END WHILE;
    
    SET end_time = NOW(6);
    
    SELECT 
        'With Cache' as test_type,
        TIMESTAMPDIFF(MICROSECOND, start_time, end_time) as execution_microseconds,
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') as cache_hits,
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_inserts') as cache_inserts;
        
END //
DELIMITER ;

-- æ‰§è¡Œæ€§èƒ½æµ‹è¯•
CALL test_subquery_cache_performance();
```

### 7.3 ç¼“å­˜è°ƒä¼˜ç­–ç•¥


**âš™ï¸ ç¼“å­˜é…ç½®ä¼˜åŒ–**
```sql
-- 1. æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´ç¼“å­˜å¤§å°
-- åˆ†ææŸ¥è¯¢ç»“æœå¤§å°åˆ†å¸ƒ
SELECT 
    'Average Query Result Size' as metric,
    ROUND(
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_total_blocks') * 
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES WHERE VARIABLE_NAME='query_cache_min_res_unit') / 
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_queries_in_cache') / 1024, 2
    ) as avg_size_kb;

-- 2. ä¼˜åŒ–ç¼“å­˜åˆ†é…å•å…ƒå¤§å°
-- å¦‚æœå¹³å‡æŸ¥è¯¢ç»“æœè¾ƒå°ï¼Œå‡å°‘min_res_unit
SET GLOBAL query_cache_min_res_unit = 2048;  -- é»˜è®¤4096ï¼Œå¯é€‚å½“è°ƒå°

-- 3. è®¾ç½®åˆç†çš„å•æŸ¥è¯¢ç¼“å­˜é™åˆ¶
-- é¿å…å¤§ç»“æœé›†å ç”¨è¿‡å¤šç¼“å­˜ç©ºé—´
SET GLOBAL query_cache_limit = 2*1024*1024;  -- 2MBé™åˆ¶

-- 4. ç›‘æ§å¹¶è°ƒæ•´æ€»ç¼“å­˜å¤§å°
-- æ ¹æ®å‘½ä¸­ç‡å’Œå†…å­˜ä½¿ç”¨ç‡åŠ¨æ€è°ƒæ•´
SET GLOBAL query_cache_size = 256*1024*1024;  -- 256MB
```

**ğŸ¯ åº”ç”¨å±‚ä¼˜åŒ–å»ºè®®**
```sql
-- 1. åˆç†è®¾è®¡æŸ¥è¯¢ç»“æ„
-- ä¼˜å…ˆä½¿ç”¨ç¼“å­˜å‹å¥½çš„æŸ¥è¯¢æ¨¡å¼
SELECT 
    customer_id,
    customer_name,
    -- ç›¸åŒçš„å­æŸ¥è¯¢æ”¾åœ¨ä¸€èµ·ï¼Œä¾¿äºç¼“å­˜
    (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as order_count,
    (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) / 12 as monthly_avg
FROM customers c;

-- 2. é¿å…ç¼“å­˜æ€æ‰‹æŸ¥è¯¢
-- ä¸è¦åœ¨å­æŸ¥è¯¢ä¸­ä½¿ç”¨ä¸ç¡®å®šå‡½æ•°
-- é”™è¯¯ç¤ºä¾‹ï¼š
-- SELECT (SELECT COUNT(*) FROM orders WHERE order_date = NOW()) FROM customers;
-- æ­£ç¡®ç¤ºä¾‹ï¼š
SELECT (SELECT COUNT(*) FROM orders WHERE DATE(order_date) = CURDATE()) FROM customers;

-- 3. åˆç†çš„æ•°æ®æ›´æ–°ç­–ç•¥
-- æ‰¹é‡æ›´æ–°å‡å°‘ç¼“å­˜å¤±æ•ˆé¢‘ç‡
-- å®šæ—¶æ›´æ–°è€Œéå®æ—¶æ›´æ–°ï¼Œå‡å°‘ç¼“å­˜æŠ–åŠ¨
```

### 7.4 ç›‘æ§å‘Šè­¦è®¾ç½®


**ğŸš¨ ç¼“å­˜ç›‘æ§å‘Šè­¦è§„åˆ™**
```sql
-- åˆ›å»ºç¼“å­˜ç›‘æ§è§†å›¾
CREATE VIEW cache_monitor AS
SELECT 
    -- ç¼“å­˜å‘½ä¸­ç‡
    ROUND(
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') /
        ((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_hits') +
         (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_inserts')) * 100,
        2
    ) as hit_rate_percent,
    
    -- å†…å­˜ä½¿ç”¨ç‡  
    ROUND(
        ((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES WHERE VARIABLE_NAME='query_cache_size') - 
         (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_free_memory')) /
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES WHERE VARIABLE_NAME='query_cache_size') * 100,
        2
    ) as memory_usage_percent,
    
    -- ç¢ç‰‡ç‡
    ROUND(
        (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_free_blocks') /
        GREATEST((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Qcache_queries_in_cache'), 1) * 100,
        2
    ) as fragmentation_percent;

-- å‘Šè­¦æ£€æŸ¥æŸ¥è¯¢
SELECT 
    CASE 
        WHEN hit_rate_percent < 30 THEN 'ALERT: Low cache hit rate'
        WHEN memory_usage_percent > 90 THEN 'ALERT: High memory usage'  
        WHEN fragmentation_percent > 20 THEN 'ALERT: High fragmentation'
        ELSE 'OK'
    END as alert_status,
    hit_rate_percent,
    memory_usage_percent,
    fragmentation_percent
FROM cache_monitor;
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ç¼“å­˜æœºåˆ¶çš„æœ¬è´¨ç†è§£**
```
å­æŸ¥è¯¢ç¼“å­˜ = é‡å¤è®¡ç®—ä¼˜åŒ–
â€¢ ç»“æœç¼“å­˜ï¼šå­˜å‚¨æŸ¥è¯¢ç»“æœï¼Œé¿å…é‡å¤æ‰§è¡Œ
â€¢ è®¡åˆ’ç¼“å­˜ï¼šå­˜å‚¨æ‰§è¡Œè®¡åˆ’ï¼Œé¿å…é‡å¤è§£æ
â€¢ ç”Ÿå‘½å‘¨æœŸï¼šå•æŸ¥è¯¢å†…æœ‰æ•ˆï¼ŒæŸ¥è¯¢ç»“æŸåé‡Šæ”¾
â€¢ é€‚ç”¨åœºæ™¯ï¼šç›¸åŒå­æŸ¥è¯¢åœ¨ä¸€ä¸ªæŸ¥è¯¢ä¸­å¤šæ¬¡å‡ºç°
```

**ğŸ”¸ ç¼“å­˜ç”Ÿæ•ˆçš„å…³é”®æ¡ä»¶**
```
åŒ¹é…è¦æ±‚ä¸¥æ ¼ï¼š
â€¢ SQLæ–‡æœ¬å¿…é¡»å®Œå…¨ç›¸åŒ
â€¢ å‚æ•°å€¼å¿…é¡»å®Œå…¨ç›¸åŒ  
â€¢ æ•°æ®çŠ¶æ€å¿…é¡»ä¸€è‡´
â€¢ æ‰§è¡Œç¯å¢ƒå¿…é¡»ç›¸åŒ

å¤±æ•ˆè§¦å‘åŠæ—¶ï¼š
â€¢ æ•°æ®å˜æ›´ç«‹å³å¤±æ•ˆ
â€¢ ç»“æ„å˜æ›´ç«‹å³å¤±æ•ˆ
â€¢ ä¼šè¯ç»“æŸè‡ªåŠ¨æ¸…ç†
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**
```
ä¼˜åŒ–ç­–ç•¥å±‚æ¬¡ï¼š
1. æ¶ˆé™¤é‡å¤å­æŸ¥è¯¢ â†’ JOIN/CTEæ›¿ä»£
2. åˆ©ç”¨ç¼“å­˜æœºåˆ¶ â†’ åˆå¹¶ç›¸åŒå­æŸ¥è¯¢
3. ç›‘æ§ç¼“å­˜æ•ˆæœ â†’ è°ƒä¼˜é…ç½®å‚æ•°
4. é¿å…ç¼“å­˜æ€æ‰‹ â†’ ä¸ç¡®å®šå‡½æ•°å¤„ç†
```

### 8.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ ç¼“å­˜å‹å¥½çš„æŸ¥è¯¢è®¾è®¡**
```sql
âœ… æ¨èåšæ³•ï¼š
-- ç›¸åŒå­æŸ¥è¯¢æ”¾åœ¨ä¸€èµ·
SELECT 
    customer_id,
    (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as count1,
    (SELECT COUNT(*) FROM orders WHERE customer_id = c.customer_id) as count2
FROM customers c;

âŒ é¿å…åšæ³•ï¼š
-- åŒ…å«ä¸ç¡®å®šå‡½æ•°çš„å­æŸ¥è¯¢
SELECT (SELECT COUNT(*) FROM orders WHERE created_at = NOW()) FROM customers;

-- é¢‘ç¹å˜åŒ–çš„æ•°æ®å­æŸ¥è¯¢
SELECT (SELECT MAX(last_update) FROM system_status) FROM customers;
```

**ğŸ”¹ ç›‘æ§æŒ‡æ ‡çš„é‡ç‚¹å…³æ³¨**
```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ ç¼“å­˜å‘½ä¸­ç‡ > 60%ï¼šè¡¨ç¤ºç¼“å­˜æ•ˆæœè‰¯å¥½
â€¢ å†…å­˜ä½¿ç”¨ç‡ < 80%ï¼šé¿å…å†…å­˜å‹åŠ›è¿‡å¤§
â€¢ ç¢ç‰‡ç‡ < 20%ï¼šä¿æŒç¼“å­˜æ•ˆç‡
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´ï¼šå¯¹æ¯”ç¼“å­˜å‰åçš„æ€§èƒ½æå‡
```

**ğŸ”¹ æ•…éšœæ’æŸ¥çš„æ€ç»´æ¨¡å¼**
```
é—®é¢˜è¯Šæ–­æµç¨‹ï¼š
1. ç¡®è®¤ç¼“å­˜æ˜¯å¦å¯ç”¨
2. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
3. åˆ†ææŸ¥è¯¢æ˜¯å¦ç¬¦åˆç¼“å­˜æ¡ä»¶
4. ç›‘æ§æ•°æ®å˜æ›´å¯¹ç¼“å­˜çš„å½±å“
5. è¯„ä¼°ç¼“å­˜é…ç½®æ˜¯å¦åˆç†
```

### 8.3 ç”Ÿäº§ç¯å¢ƒåº”ç”¨å»ºè®®


**ğŸ¯ éƒ¨ç½²ç­–ç•¥**
```
å¼€å‘é˜¶æ®µï¼š
â€¢ è®¾è®¡ç¼“å­˜å‹å¥½çš„æŸ¥è¯¢ç»“æ„
â€¢ è¯†åˆ«å’Œæ¶ˆé™¤é‡å¤å­æŸ¥è¯¢
â€¢ è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•

æµ‹è¯•é˜¶æ®µï¼š  
â€¢ éªŒè¯ç¼“å­˜æ•ˆæœ
â€¢ æµ‹è¯•æ•°æ®å˜æ›´çš„å½±å“
â€¢ å‹åŠ›æµ‹è¯•ç¼“å­˜æ€§èƒ½

ç”Ÿäº§é˜¶æ®µï¼š
â€¢ ç›‘æ§ç¼“å­˜æŒ‡æ ‡
â€¢ å®šæœŸä¼˜åŒ–é…ç½®
â€¢ å»ºç«‹å‘Šè­¦æœºåˆ¶
```

**âš™ï¸ é…ç½®è°ƒä¼˜åŸåˆ™**
```
å†…å­˜é…ç½®ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡æŸ¥è¯¢å¤æ‚åº¦è®¾ç½®ç¼“å­˜å¤§å°
â€¢ é¢„ç•™è¶³å¤Ÿå†…å­˜ç»™å…¶ä»–æ•°æ®åº“æ“ä½œ
â€¢ å®šæœŸç›‘æ§å’Œè°ƒæ•´é…ç½®å‚æ•°

ä¸šåŠ¡é€‚é…ï¼š
â€¢ è¯»å¤šå†™å°‘çš„ä¸šåŠ¡æ›´é€‚åˆä½¿ç”¨ç¼“å­˜
â€¢ å®æ—¶æ€§è¦æ±‚é«˜çš„ä¸šåŠ¡è°¨æ…ä½¿ç”¨ç¼“å­˜
â€¢ å¤§ç»“æœé›†æŸ¥è¯¢å¯èƒ½ä¸é€‚åˆç¼“å­˜
```

### 8.4 æŠ€æœ¯å‘å±•è¶‹åŠ¿


**ğŸš€ ç¼“å­˜æŠ€æœ¯æ¼”è¿›æ–¹å‘**
```
æ™ºèƒ½ç¼“å­˜ï¼š
â€¢ åŸºäºAIçš„æŸ¥è¯¢æ¨¡å¼è¯†åˆ«
â€¢ è‡ªé€‚åº”çš„ç¼“å­˜ç­–ç•¥è°ƒæ•´
â€¢ é¢„æµ‹æ€§çš„ç¼“å­˜é¢„åŠ è½½

åˆ†å¸ƒå¼ç¼“å­˜ï¼š
â€¢ è·¨å®ä¾‹çš„æŸ¥è¯¢ç»“æœå…±äº«
â€¢ åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§ä¿è¯
â€¢ äº‘åŸç”Ÿçš„ç¼“å­˜æœåŠ¡

åº”ç”¨å±‚ç¼“å­˜ï¼š
â€¢ ORMæ¡†æ¶çš„æŸ¥è¯¢ç¼“å­˜
â€¢ åº”ç”¨çº§åˆ«çš„ç»“æœç¼“å­˜
â€¢ Redisç­‰å¤–éƒ¨ç¼“å­˜é›†æˆ
```

**ğŸ’¡ å­¦ä¹ å»ºè®®**
- **ç†è®ºç»“åˆå®è·µ**ï¼šç†è§£ç¼“å­˜åŸç†ï¼Œé€šè¿‡å®é™…é¡¹ç›®éªŒè¯æ•ˆæœ
- **ç›‘æ§é©±åŠ¨ä¼˜åŒ–**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼Œæ•°æ®æŒ‡å¯¼ä¼˜åŒ–å†³ç­–  
- **æ¸è¿›å¼åº”ç”¨**ï¼šä»ç®€å•åœºæ™¯å¼€å§‹ï¼Œé€æ­¥åº”ç”¨åˆ°å¤æ‚ä¸šåŠ¡
- **æŒç»­å…³æ³¨å‘å±•**ï¼šè·Ÿè¿›æ•°æ®åº“æ–°ç‰ˆæœ¬çš„ç¼“å­˜åŠŸèƒ½æ”¹è¿›

**æ ¸å¿ƒè®°å¿†**ï¼š
- å­æŸ¥è¯¢ç¼“å­˜é€šè¿‡é¿å…é‡å¤è®¡ç®—æ˜¾è‘—æå‡æ€§èƒ½
- ç¼“å­˜ç”Ÿæ•ˆéœ€è¦ä¸¥æ ¼çš„æ¡ä»¶åŒ¹é…ï¼Œå¤±æ•ˆæœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- ç›‘æ§å’Œè°ƒä¼˜æ˜¯å‘æŒ¥ç¼“å­˜æ•ˆæœçš„å…³é”®ç¯èŠ‚
- åˆç†çš„æŸ¥è¯¢è®¾è®¡æ˜¯ç¼“å­˜ä¼˜åŒ–çš„åŸºç¡€