---
title: 2ã€MySQL_Routeré…ç½®ä¸è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [MySQL RouteråŸºç¡€æ¦‚å¿µ](#1-mysql-routeråŸºç¡€æ¦‚å¿µ)
2. [Routeré…ç½®æ–‡ä»¶ç»“æ„](#2-routeré…ç½®æ–‡ä»¶ç»“æ„)
3. [è·¯ç”±ç­–ç•¥ä¸è¯»å†™åˆ†ç¦»](#3-è·¯ç”±ç­–ç•¥ä¸è¯»å†™åˆ†ç¦»)
4. [è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£](#4-è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£)
5. [è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥](#5-è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥)
6. [é«˜å¯ç”¨éƒ¨ç½²ä¸æ•…éšœè½¬ç§»](#6-é«˜å¯ç”¨éƒ¨ç½²ä¸æ•…éšœè½¬ç§»)
7. [æ™ºèƒ½è·¯ç”±ä¸æ€§èƒ½ä¼˜åŒ–](#7-æ™ºèƒ½è·¯ç”±ä¸æ€§èƒ½ä¼˜åŒ–)
8. [å¾®æœåŠ¡æ¶æ„é›†æˆ](#8-å¾®æœåŠ¡æ¶æ„é›†æˆ)
9. [ç›‘æ§è°ƒä¼˜ä¸æ•…éšœé¢„é˜²](#9-ç›‘æ§è°ƒä¼˜ä¸æ•…éšœé¢„é˜²)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ MySQL RouteråŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯MySQL Router


**ç®€å•ç†è§£**ï¼šMySQL Routerå°±æ˜¯ä¸€ä¸ª**æ™ºèƒ½çš„æ•°æ®åº“ä¸­é—´äºº**ï¼Œå®ƒç«™åœ¨åº”ç”¨ç¨‹åºå’ŒMySQLæ•°æ®åº“ä¹‹é—´ï¼Œå¸®åŠ©åº”ç”¨ç¨‹åºæ‰¾åˆ°åˆé€‚çš„æ•°æ®åº“æœåŠ¡å™¨ã€‚

```
åº”ç”¨ç¨‹åº â†’ MySQL Router â†’ å¤šä¸ªMySQLæœåŠ¡å™¨

å°±åƒä¸€ä¸ªèªæ˜çš„æ¥çº¿å‘˜ï¼š
- æ¥åˆ°ç”µè¯ï¼ˆSQLè¯·æ±‚ï¼‰
- åˆ¤æ–­åº”è¯¥è½¬æ¥ç»™è°ï¼ˆå“ªä¸ªæ•°æ®åº“ï¼‰
- ç¡®ä¿é€šè¯è´¨é‡ï¼ˆè¿æ¥ç¨³å®šæ€§ï¼‰
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ **æ™ºèƒ½è·¯ç”±**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ•°æ®åº“æœåŠ¡å™¨
- âš–ï¸ **è´Ÿè½½å‡è¡¡**ï¼šæŠŠè¯·æ±‚åˆç†åˆ†é…ç»™å¤šä¸ªæœåŠ¡å™¨
- ğŸ”„ **æ•…éšœè½¬ç§»**ï¼šå½“æŸä¸ªæœåŠ¡å™¨å‡ºé—®é¢˜æ—¶è‡ªåŠ¨åˆ‡æ¢
- ğŸ“Š **è¯»å†™åˆ†ç¦»**ï¼šè¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«å¤„ç†

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦MySQL Router


**ä¼ ç»Ÿé—®é¢˜**ï¼š
```
åº”ç”¨ç›´è¿æ•°æ®åº“çš„é—®é¢˜ï¼š
åº”ç”¨ â†’ æ•°æ®åº“1ï¼ˆä¸»åº“ï¼‰
          |
      å¦‚æœä¸»åº“æŒ‚äº†ï¼Œåº”ç”¨å°±æ— æ³•å·¥ä½œï¼
```

**Routerè§£å†³æ–¹æ¡ˆ**ï¼š
```
åº”ç”¨ â†’ Router â†’ æ•°æ®åº“1ï¼ˆä¸»åº“ï¼‰
                 |
                 â†’ æ•°æ®åº“2ï¼ˆä»åº“ï¼‰
                 |
                 â†’ æ•°æ®åº“3ï¼ˆä»åº“ï¼‰

Routerä¼šè‡ªåŠ¨ï¼š
- æ£€æµ‹å“ªäº›æ•°æ®åº“å¥åº·
- æŠŠè¯»æ“ä½œåˆ†ç»™ä»åº“
- æŠŠå†™æ“ä½œå‘ç»™ä¸»åº“
- ä¸»åº“æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢
```

### 1.3 InnoDB Clusterä¸­çš„ä½œç”¨


**åœ¨é›†ç¾¤ä¸­çš„ä½ç½®**ï¼š
```
                åº”ç”¨å±‚
                  |
            MySQL Routerï¼ˆè·¯ç”±å±‚ï¼‰
                  |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |         |         |
    MySQL 1   MySQL 2   MySQL 3
   ï¼ˆä¸»åº“ï¼‰   ï¼ˆä»åº“ï¼‰   ï¼ˆä»åº“ï¼‰
      |         |         |
    InnoDB    InnoDB    InnoDB
    Cluster   Cluster   Cluster
```

---

## 2. ğŸ“‹ Routeré…ç½®æ–‡ä»¶ç»“æ„


### 2.1 é…ç½®æ–‡ä»¶åŸºæœ¬ç»“æ„


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼šé€šå¸¸åœ¨ `/etc/mysqlrouter/mysqlrouter.conf`

```ini
# MySQL Routeré…ç½®æ–‡ä»¶ç»“æ„

[DEFAULT]
# å…¨å±€é»˜è®¤é…ç½®
logging_folder = /var/log/mysqlrouter
runtime_folder = /var/run/mysqlrouter
config_folder = /etc/mysqlrouter

[logger]
# æ—¥å¿—é…ç½®
level = INFO
filename = mysqlrouter.log

[metadata_cache:myCluster]
# å…ƒæ•°æ®ç¼“å­˜é…ç½®
router_id = 1
bootstrap_server_addresses = mysql1:3306,mysql2:3306,mysql3:3306
user = mysql_router_user
metadata_cluster = myCluster
ttl = 60

[routing:myCluster_rw]
# è¯»å†™è·¯ç”±é…ç½®
bind_address = 0.0.0.0
bind_port = 6446
destinations = metadata-cache://myCluster/default?role=PRIMARY
routing_strategy = first-available

[routing:myCluster_ro]
# åªè¯»è·¯ç”±é…ç½®
bind_address = 0.0.0.0
bind_port = 6447
destinations = metadata-cache://myCluster/default?role=SECONDARY
routing_strategy = round-robin
```

### 2.2 æ ¸å¿ƒé…ç½®æ®µè§£é‡Š


**ğŸ”¸ DEFAULTæ®µ - å…¨å±€é…ç½®**
```ini
[DEFAULT]
# è¿™é‡Œè®¾ç½®Routerçš„åŸºæœ¬å·¥ä½œç¯å¢ƒ
logging_folder = /var/log/mysqlrouter    # æ—¥å¿—å­˜æ”¾ä½ç½®
runtime_folder = /var/run/mysqlrouter    # è¿è¡Œæ—¶æ–‡ä»¶ä½ç½®
config_folder = /etc/mysqlrouter         # é…ç½®æ–‡ä»¶ä½ç½®
```

**ğŸ”¸ metadata_cacheæ®µ - é›†ç¾¤ä¿¡æ¯ç¼“å­˜**
```ini
[metadata_cache:myCluster]
# è¿™æ®µå‘Šè¯‰Routerå¦‚ä½•è·å–é›†ç¾¤ä¿¡æ¯
bootstrap_server_addresses = mysql1:3306,mysql2:3306
# é›†ç¾¤ä¸­çš„æœåŠ¡å™¨åœ°å€åˆ—è¡¨
user = mysql_router_user
# è¿æ¥æ•°æ®åº“çš„ç”¨æˆ·å
ttl = 60
# ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰
```

**ğŸ”¸ routingæ®µ - è·¯ç”±è§„åˆ™**
```ini
[routing:myCluster_rw]
# è¯»å†™è·¯ç”±ï¼ˆå†™æ“ä½œä¸“ç”¨ï¼‰
bind_port = 6446           # Routerç›‘å¬çš„ç«¯å£
role=PRIMARY              # åªè·¯ç”±åˆ°ä¸»åº“
routing_strategy = first-available  # è·¯ç”±ç­–ç•¥

[routing:myCluster_ro]
# åªè¯»è·¯ç”±ï¼ˆè¯»æ“ä½œä¸“ç”¨ï¼‰  
bind_port = 6447          # ä¸åŒçš„ç«¯å£
role=SECONDARY           # åªè·¯ç”±åˆ°ä»åº“
routing_strategy = round-robin  # è½®è¯¢ç­–ç•¥
```

### 2.3 é…ç½®æ–‡ä»¶æ¨¡æ¿


```ini
# å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿

[DEFAULT]
logging_folder = /var/log/mysqlrouter
runtime_folder = /var/run/mysqlrouter
config_folder = /etc/mysqlrouter

[logger]
level = INFO
filename = mysqlrouter.log
timestamp_precision = second

[metadata_cache:production_cluster]
router_id = 1
bootstrap_server_addresses = db1.company.com:3306,db2.company.com:3306,db3.company.com:3306
user = router_user
metadata_cluster = production_cluster
ttl = 60
auth_cache_ttl = 60
auth_cache_refresh_interval = 30

# å†™æ“ä½œè·¯ç”±
[routing:production_cluster_rw]
bind_address = 0.0.0.0
bind_port = 6446
destinations = metadata-cache://production_cluster/default?role=PRIMARY
routing_strategy = first-available
max_connections = 1000
max_connect_errors = 100

# è¯»æ“ä½œè·¯ç”±
[routing:production_cluster_ro] 
bind_address = 0.0.0.0
bind_port = 6447
destinations = metadata-cache://production_cluster/default?role=SECONDARY
routing_strategy = round-robin-with-fallback
max_connections = 2000
max_connect_errors = 100
```

---

## 3. ğŸ”„ è·¯ç”±ç­–ç•¥ä¸è¯»å†™åˆ†ç¦»


### 3.1 è¯»å†™åˆ†ç¦»åŸç†


**ä¸ºä»€ä¹ˆè¦è¯»å†™åˆ†ç¦»**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰€æœ‰æ“ä½œéƒ½æ‰“åˆ°ä¸»åº“
ä¸»åº“ â† è¯»è¯·æ±‚ï¼ˆå¤§é‡ï¼‰
     â† å†™è¯·æ±‚ï¼ˆå°‘é‡ï¼‰
ç»“æœï¼šä¸»åº“å‹åŠ›å¤ªå¤§ï¼Œæ€§èƒ½ä¸‹é™

è¯»å†™åˆ†ç¦»ï¼šæŒ‰æ“ä½œç±»å‹åˆ†å‘
ä¸»åº“ â† å†™è¯·æ±‚ï¼ˆINSERT/UPDATE/DELETEï¼‰
ä»åº“ â† è¯»è¯·æ±‚ï¼ˆSELECTï¼‰
ç»“æœï¼šå‹åŠ›åˆ†æ•£ï¼Œæ€§èƒ½æå‡
```

**Routerå®ç°è¯»å†™åˆ†ç¦»**ï¼š
```
åº”ç”¨ç¨‹åº
    |
MySQL Routerï¼ˆæ™ºèƒ½åˆ¤æ–­ï¼‰
    |
    â”œâ”€ ç«¯å£6446 â†’ ä¸»åº“ï¼ˆå†™æ“ä½œï¼‰
    â””â”€ ç«¯å£6447 â†’ ä»åº“ï¼ˆè¯»æ“ä½œï¼‰
```

### 3.2 è·¯ç”±ç­–ç•¥è¯¦è§£


**ğŸ”¸ first-availableï¼ˆé¦–é€‰å¯ç”¨ï¼‰**
```ini
routing_strategy = first-available

å·¥ä½œåŸç†ï¼š
1. æ€»æ˜¯é€‰æ‹©åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å™¨
2. åªæœ‰å½“ç¬¬ä¸€ä¸ªæœåŠ¡å™¨ä¸å¯ç”¨æ—¶ï¼Œæ‰é€‰æ‹©ç¬¬äºŒä¸ª
3. é€‚åˆä¸»ä»æ¶æ„ï¼Œç¡®ä¿å†™æ“ä½œæ€»æ˜¯å‘åˆ°ä¸»åº“

ä½¿ç”¨åœºæ™¯ï¼š
âœ… å†™æ“ä½œè·¯ç”±ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
âœ… éœ€è¦ä¸¥æ ¼é¡ºåºçš„åœºæ™¯
```

**ğŸ”¸ round-robinï¼ˆè½®è¯¢ï¼‰**
```ini
routing_strategy = round-robin

å·¥ä½œåŸç†ï¼š
è¯·æ±‚1 â†’ æœåŠ¡å™¨A
è¯·æ±‚2 â†’ æœåŠ¡å™¨B  
è¯·æ±‚3 â†’ æœåŠ¡å™¨C
è¯·æ±‚4 â†’ æœåŠ¡å™¨Aï¼ˆå¾ªç¯ï¼‰

ä½¿ç”¨åœºæ™¯ï¼š
âœ… è¯»æ“ä½œè´Ÿè½½å‡è¡¡
âœ… å¤šä¸ªä»åº“æ€§èƒ½ç›¸è¿‘
```

**ğŸ”¸ round-robin-with-fallbackï¼ˆè½®è¯¢+å®¹é”™ï¼‰**
```ini
routing_strategy = round-robin-with-fallback

å·¥ä½œåŸç†ï¼š
1. æ­£å¸¸æƒ…å†µä¸‹ä½¿ç”¨è½®è¯¢
2. å½“æŸä¸ªæœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œè‡ªåŠ¨è·³è¿‡
3. æœåŠ¡å™¨æ¢å¤åé‡æ–°åŠ å…¥è½®è¯¢

ä¼˜åŠ¿ï¼š
âœ… æ—¢æœ‰è´Ÿè½½å‡è¡¡ï¼Œåˆæœ‰å®¹é”™èƒ½åŠ›
âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ
```

### 3.3 åº”ç”¨ç¨‹åºå¦‚ä½•ä½¿ç”¨è¯»å†™åˆ†ç¦»


**æ–¹å¼ä¸€ï¼šä¸åŒç«¯å£è¿æ¥**
```python
# Pythonç¤ºä¾‹
import mysql.connector

# å†™æ“ä½œè¿æ¥
write_conn = mysql.connector.connect(
    host='router_host',
    port=6446,  # å†™ç«¯å£
    user='app_user',
    password='password',
    database='mydb'
)

# è¯»æ“ä½œè¿æ¥
read_conn = mysql.connector.connect(
    host='router_host', 
    port=6447,  # è¯»ç«¯å£
    user='app_user',
    password='password',
    database='mydb'
)

# å†™æ“ä½œ
cursor = write_conn.cursor()
cursor.execute("INSERT INTO users (name) VALUES ('å¼ ä¸‰')")
write_conn.commit()

# è¯»æ“ä½œ
cursor = read_conn.cursor()
cursor.execute("SELECT * FROM users")
results = cursor.fetchall()
```

**æ–¹å¼äºŒï¼šè¿æ¥æ± ç®¡ç†**
```python
class DatabaseManager:
    def __init__(self):
        # å†™è¿æ¥æ± 
        self.write_pool = mysql.connector.pooling.MySQLConnectionPool(
            pool_name="write_pool",
            pool_size=10,
            host='router_host',
            port=6446
        )
        
        # è¯»è¿æ¥æ±   
        self.read_pool = mysql.connector.pooling.MySQLConnectionPool(
            pool_name="read_pool",
            pool_size=20,
            host='router_host',
            port=6447
        )
    
    def execute_write(self, sql):
        conn = self.write_pool.get_connection()
        # æ‰§è¡Œå†™æ“ä½œ
        
    def execute_read(self, sql):
        conn = self.read_pool.get_connection()
        # æ‰§è¡Œè¯»æ“ä½œ
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£


### 4.1 è´Ÿè½½å‡è¡¡çš„å¿…è¦æ€§


**é—®é¢˜åœºæ™¯**ï¼š
```
3ä¸ªä»åº“çš„æƒ…å†µï¼š
ä»åº“Aï¼šæ€§èƒ½å¼ºï¼Œ8æ ¸16G
ä»åº“Bï¼šæ€§èƒ½ä¸­ï¼Œ4æ ¸8G  
ä»åº“Cï¼šæ€§èƒ½å¼±ï¼Œ2æ ¸4G

å¦‚æœå¹³å‡åˆ†é…è¯·æ±‚ï¼š
ä»åº“Aï¼šå¤„ç†è½»æ¾ï¼Œèµ„æºæµªè´¹
ä»åº“Bï¼šå¤„ç†æ­£å¸¸
ä»åº“Cï¼šå‹åŠ›è¿‡å¤§ï¼Œå“åº”æ…¢

ç»“æœï¼šæ•´ä½“æ€§èƒ½è¢«æœ€æ…¢çš„æœåŠ¡å™¨æ‹–ç´¯
```

### 4.2 åŸºæœ¬è´Ÿè½½å‡è¡¡ç®—æ³•


**ğŸ”¸ Round Robinï¼ˆè½®è¯¢ç®—æ³•ï¼‰**
```
ç®—æ³•é€»è¾‘ï¼š
è¯·æ±‚æŒ‰é¡ºåºä¾æ¬¡åˆ†é…ç»™æ¯ä¸ªæœåŠ¡å™¨

ä¼˜ç‚¹ï¼š
âœ… ç®€å•æ˜“å®ç°
âœ… åˆ†é…å‡åŒ€

ç¼ºç‚¹ï¼š
âŒ ä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½å·®å¼‚
âŒ ä¸è€ƒè™‘æœåŠ¡å™¨å½“å‰è´Ÿè½½

é€‚ç”¨åœºæ™¯ï¼š
- æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘
- è¯·æ±‚å¤„ç†æ—¶é—´ç›¸è¿‘
```

**ğŸ”¸ Weighted Round Robinï¼ˆåŠ æƒè½®è¯¢ï¼‰**
```ini
# Routeré…ç½®ç¤ºä¾‹
[routing:cluster_ro]
destinations = server1:3306,server2:3306,server3:3306
routing_strategy = round-robin
# æƒé‡é€šè¿‡metadataè®¾ç½®

æœåŠ¡å™¨æƒé‡åˆ†é…ï¼š
server1: æƒé‡4ï¼ˆæ€§èƒ½å¼ºï¼‰
server2: æƒé‡2ï¼ˆæ€§èƒ½ä¸­ï¼‰
server3: æƒé‡1ï¼ˆæ€§èƒ½å¼±ï¼‰

åˆ†é…ç»“æœï¼š
7ä¸ªè¯·æ±‚ä¸­ï¼šserver1å¤„ç†4ä¸ªï¼Œserver2å¤„ç†2ä¸ªï¼Œserver3å¤„ç†1ä¸ª
```

**ğŸ”¸ Least Connectionsï¼ˆæœ€å°‘è¿æ¥ï¼‰**
```
ç®—æ³•é€»è¾‘ï¼š
æŠŠæ–°è¯·æ±‚åˆ†é…ç»™å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨

å·¥ä½œåŸç†ï¼š
Routerç»´æŠ¤æ¯ä¸ªæœåŠ¡å™¨çš„è¿æ¥è®¡æ•°
è¿æ¥å»ºç«‹æ—¶ï¼šè®¡æ•°+1
è¿æ¥å…³é—­æ—¶ï¼šè®¡æ•°-1
æ–°è¯·æ±‚åˆ°è¾¾ï¼šé€‰æ‹©è®¡æ•°æœ€å°çš„æœåŠ¡å™¨

é€‚ç”¨åœºæ™¯ï¼š
âœ… è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¾ˆå¤§
âœ… é•¿è¿æ¥è¾ƒå¤šçš„åº”ç”¨
```

### 4.3 Routeræ™ºèƒ½è·¯ç”±ç®—æ³•


**ğŸ”¸ è‡ªé€‚åº”è´Ÿè½½å‡è¡¡**
```
Routerä¼šæ”¶é›†çš„æŒ‡æ ‡ï¼š
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
- å½“å‰è¿æ¥æ•°
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡

å†³ç­–è¿‡ç¨‹ï¼š
1. è®¡ç®—æ¯ä¸ªæœåŠ¡å™¨çš„å¥åº·åº¦å¾—åˆ†
2. æ ¹æ®å¾—åˆ†åŠ¨æ€è°ƒæ•´æƒé‡
3. ä¼˜å…ˆé€‰æ‹©å¾—åˆ†é«˜çš„æœåŠ¡å™¨
4. å®šæœŸé‡æ–°è¯„ä¼°å’Œè°ƒæ•´
```

**ğŸ”¸ æ™ºèƒ½è·¯ç”±å†³ç­–æ ‘**
```
æ–°è¯·æ±‚åˆ°è¾¾
    |
æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
    |
    â”œâ”€ æœ‰å¥åº·æœåŠ¡å™¨ â”€â”
    |                |
    â””â”€ æ— å¥åº·æœåŠ¡å™¨ â”€â”¤
                     |
             è¿”å›é”™è¯¯  |
                     |
                 åº”ç”¨è·¯ç”±ç­–ç•¥
                     |
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            |        |        |
        è½®è¯¢ç­–ç•¥  æœ€å°‘è¿æ¥  åŠ æƒç­–ç•¥
            |        |        |
        é€‰æ‹©ä¸‹ä¸€ä¸ª  é€‰æ‹©è¿æ¥   æ ¹æ®æƒé‡
        å¯ç”¨æœåŠ¡å™¨  æœ€å°‘æœåŠ¡å™¨  é€‰æ‹©æœåŠ¡å™¨
```

### 4.4 æ€§èƒ½ä¼˜åŒ–çš„è·¯ç”±ç­–ç•¥


**ğŸ”¸ å°±è¿‘è·¯ç”±**
```ini
# é…ç½®æ–‡ä»¶ç¤ºä¾‹
[routing:cluster_ro_region1]
bind_port = 6447
destinations = metadata-cache://cluster/region1?role=SECONDARY
routing_strategy = round-robin

[routing:cluster_ro_region2]  
bind_port = 6448
destinations = metadata-cache://cluster/region2?role=SECONDARY
routing_strategy = round-robin

åº”ç”¨åœºæ™¯ï¼š
- å¤šæœºæˆ¿éƒ¨ç½²
- å‡å°‘ç½‘ç»œå»¶è¿Ÿ
- æé«˜å“åº”é€Ÿåº¦
```

**ğŸ”¸ è¿æ¥å¤ç”¨ä¼˜åŒ–**
```
è¿æ¥å¤ç”¨æœºåˆ¶ï¼š
1. Routerç»´æŠ¤åˆ°åç«¯æœåŠ¡å™¨çš„è¿æ¥æ± 
2. å®¢æˆ·ç«¯æ–­å¼€æ—¶ï¼ŒRouterä¿æŒåç«¯è¿æ¥
3. æ–°å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå¤ç”¨ç°æœ‰åç«¯è¿æ¥
4. å‡å°‘è¿æ¥å»ºç«‹/æ–­å¼€çš„å¼€é”€

é…ç½®ç¤ºä¾‹ï¼š
[routing:cluster_ro]
max_connections = 1000        # æœ€å¤§è¿æ¥æ•°
max_connect_errors = 100      # æœ€å¤§è¿æ¥é”™è¯¯æ•°
connect_timeout = 10          # è¿æ¥è¶…æ—¶
client_connect_timeout = 30   # å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶
```

---

## 5. ğŸ”— è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥


### 5.1 è¿æ¥æ± å·¥ä½œåŸç†


**ä»€ä¹ˆæ˜¯è¿æ¥æ± **ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ¯æ¬¡å»ºç«‹è¿æ¥ï¼‰ï¼š
åº”ç”¨è¯·æ±‚ â†’ å»ºç«‹è¿æ¥ â†’ æ‰§è¡ŒSQL â†’ å…³é—­è¿æ¥
é—®é¢˜ï¼šå»ºç«‹/å…³é—­è¿æ¥å¼€é”€å¤§ï¼Œæ•ˆç‡ä½

è¿æ¥æ± æ–¹å¼ï¼š
åº”ç”¨è¯·æ±‚ â†’ ä»æ± ä¸­è·å–è¿æ¥ â†’ æ‰§è¡ŒSQL â†’ å½’è¿˜è¿æ¥
ä¼˜åŠ¿ï¼šå¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€ï¼Œæé«˜æ•ˆç‡
```

**Routerä¸­çš„è¿æ¥æ± æ¶æ„**ï¼š
```
å®¢æˆ·ç«¯è¿æ¥æ±           Routerè¿æ¥æ±          æ•°æ®åº“æœåŠ¡å™¨
                                          
å®¢æˆ·ç«¯1 â”€â”€â”              â”Œâ”€â”€ è¿æ¥1 â”€â”€ æ•°æ®åº“1
å®¢æˆ·ç«¯2 â”€â”€â”¤â”€â”€ Router â”€â”€â”¤â”€â”€ è¿æ¥2 â”€â”€ æ•°æ®åº“2  
å®¢æˆ·ç«¯3 â”€â”€â”˜              â””â”€â”€ è¿æ¥3 â”€â”€ æ•°æ®åº“3

RouteråŒæ—¶ç®¡ç†ï¼š
- å‰ç«¯è¿æ¥ï¼ˆå®¢æˆ·ç«¯åˆ°Routerï¼‰
- åç«¯è¿æ¥ï¼ˆRouteråˆ°æ•°æ®åº“ï¼‰
```

### 5.2 è¿æ¥æ± é…ç½®è¯¦è§£


**ğŸ”¸ åŸºæœ¬è¿æ¥æ± é…ç½®**
```ini
[routing:cluster_rw]
# è¿æ¥æ•°é™åˆ¶
max_connections = 1000           # æœ€å¤§å¹¶å‘è¿æ¥æ•°
max_connect_errors = 100         # æœ€å¤§è¿æ¥é”™è¯¯æ•°

# è¶…æ—¶è®¾ç½®
connect_timeout = 10             # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
client_connect_timeout = 30      # å®¢æˆ·ç«¯è¿æ¥è¶…æ—¶
read_timeout = 30               # è¯»å–è¶…æ—¶
write_timeout = 30              # å†™å…¥è¶…æ—¶

# è¿æ¥ä¿æŒ
client_ssl_mode = PREFERRED      # SSLæ¨¡å¼
server_ssl_mode = PREFERRED      # æœåŠ¡å™¨SSLæ¨¡å¼
```

**ğŸ”¸ é«˜çº§è¿æ¥æ± é…ç½®**
```ini
[routing:cluster_ro]
# è¿æ¥å¤ç”¨ç­–ç•¥
connection_sharing = 1           # å¯ç”¨è¿æ¥å…±äº«
connection_sharing_delay = 1000  # å…±äº«å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰

# è¿æ¥ç”Ÿå‘½å‘¨æœŸ
max_idle_time = 28800           # æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆ8å°æ—¶ï¼‰
net_buffer_length = 16384       # ç½‘ç»œç¼“å†²åŒºå¤§å°

# æ€§èƒ½ä¼˜åŒ–
socket_timeout = 30             # å¥—æ¥å­—è¶…æ—¶
wait_timeout = 28800           # ç­‰å¾…è¶…æ—¶
interactive_timeout = 28800     # äº¤äº’è¶…æ—¶
```

### 5.3 å¥åº·æ£€æŸ¥æœºåˆ¶


**ğŸ”¸ å¥åº·æ£€æŸ¥çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼š
1. åŠæ—¶å‘ç°æœåŠ¡å™¨æ•…éšœ
2. é¿å…æŠŠè¯·æ±‚å‘ç»™æ•…éšœæœåŠ¡å™¨
3. å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
4. æé«˜ç³»ç»Ÿå¯ç”¨æ€§
```

**ğŸ”¸ å¥åº·æ£€æŸ¥æ–¹å¼**

**æ–¹å¼ä¸€ï¼šè¿æ¥çº§æ£€æŸ¥**
```
æ£€æŸ¥å†…å®¹ï¼š
- èƒ½å¦å»ºç«‹TCPè¿æ¥
- MySQLæœåŠ¡æ˜¯å¦å“åº”
- è®¤è¯æ˜¯å¦æˆåŠŸ

ä¼˜ç‚¹ï¼šå¿«é€Ÿï¼Œå¼€é”€å°
ç¼ºç‚¹ï¼šåªèƒ½æ£€æŸ¥åŸºæœ¬è¿é€šæ€§
```

**æ–¹å¼äºŒï¼šæŸ¥è¯¢çº§æ£€æŸ¥**
```sql
-- Routerä¼šå®šæœŸæ‰§è¡Œæ£€æŸ¥æŸ¥è¯¢
SELECT 1;

-- æˆ–è€…æ›´å¤æ‚çš„æ£€æŸ¥
SELECT $$read_only, $$super_read_only;

æ£€æŸ¥å†…å®¹ï¼š
- æœåŠ¡å™¨æ˜¯å¦èƒ½æ‰§è¡ŒæŸ¥è¯¢
- æœåŠ¡å™¨è§’è‰²æ˜¯å¦æ­£ç¡®ï¼ˆä¸»/ä»ï¼‰
- å“åº”æ—¶é—´æ˜¯å¦æ­£å¸¸
```

**æ–¹å¼ä¸‰ï¼šé›†ç¾¤çŠ¶æ€æ£€æŸ¥**
```sql
-- æ£€æŸ¥é›†ç¾¤çŠ¶æ€
SELECT MEMBER_STATE, MEMBER_ROLE 
FROM performance_schema.replication_group_members 
WHERE MEMBER_ID = $$server_uuid;

æ£€æŸ¥å†…å®¹ï¼š
- æœåŠ¡å™¨åœ¨é›†ç¾¤ä¸­çš„çŠ¶æ€
- æœåŠ¡å™¨çš„è§’è‰²ï¼ˆPRIMARY/SECONDARYï¼‰
- æ˜¯å¦ä¸é›†ç¾¤æ­£å¸¸åŒæ­¥
```

### 5.4 æ•…éšœæ£€æµ‹ä¸æ¢å¤


**ğŸ”¸ æ•…éšœæ£€æµ‹æµç¨‹**
```
æ•…éšœæ£€æµ‹å†³ç­–æ ‘ï¼š

è¿æ¥å¤±è´¥
    |
é‡è¯•è¿æ¥ï¼ˆ3æ¬¡ï¼‰
    |
    â”œâ”€ æˆåŠŸ â”€â”€ æ ‡è®°ä¸ºå¥åº·
    |
    â””â”€ å¤±è´¥ â”€â”€ æ ‡è®°ä¸ºä¸å¯ç”¨
              |
          ä»è·¯ç”±åˆ—è¡¨ç§»é™¤
              |
          è®°å½•æ•…éšœæ—¶é—´
              |
          å¯åŠ¨æ¢å¤æ£€æŸ¥
```

**ğŸ”¸ è‡ªåŠ¨æ¢å¤æœºåˆ¶**
```ini
# é…ç½®æ¢å¤å‚æ•°
[routing:cluster_ro]
max_connect_errors = 100        # æœ€å¤§é”™è¯¯æ¬¡æ•°
unreachable_destination_refresh_interval = 60  # æ¢å¤æ£€æŸ¥é—´éš”

æ¢å¤æµç¨‹ï¼š
1. æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æ•…éšœæœåŠ¡å™¨
2. å°è¯•å»ºç«‹è¿æ¥
3. è¿æ¥æˆåŠŸåˆ™é‡æ–°åŠ å…¥è·¯ç”±
4. è¿æ¥å¤±è´¥åˆ™ç»§ç»­ç­‰å¾…
```

**ğŸ”¸ æ•…éšœè½¬ç§»é…ç½®**
```ini
[metadata_cache:cluster]
# æ•…éšœè½¬ç§»é…ç½®
ttl = 60                        # å…ƒæ•°æ®ç¼“å­˜æ—¶é—´
auth_cache_ttl = 60            # è®¤è¯ç¼“å­˜æ—¶é—´
auth_cache_refresh_interval = 30 # åˆ·æ–°é—´éš”

[routing:cluster_rw]
# ä¸»åº“æ•…éšœè½¬ç§»
routing_strategy = first-available
destinations = metadata-cache://cluster/default?role=PRIMARY

å·¥ä½œåŸç†ï¼š
1. Routerå®šæœŸæ£€æŸ¥ä¸»åº“çŠ¶æ€
2. ä¸»åº“æ•…éšœæ—¶ï¼ŒInnoDB Clusterè‡ªåŠ¨é€‰ä¸¾æ–°ä¸»åº“
3. Routeræ£€æµ‹åˆ°å˜åŒ–ï¼Œæ›´æ–°è·¯ç”±ç›®æ ‡
4. æ–°è¯·æ±‚è‡ªåŠ¨å‘åˆ°æ–°ä¸»åº“
```

---

## 6. ğŸ›¡ï¸ é«˜å¯ç”¨éƒ¨ç½²ä¸æ•…éšœè½¬ç§»


### 6.1 Routeré«˜å¯ç”¨æ¶æ„


**å•ç‚¹æ•…éšœé—®é¢˜**ï¼š
```
åº”ç”¨ â†’ å•ä¸ªRouter â†’ æ•°æ®åº“é›†ç¾¤

é—®é¢˜ï¼šå¦‚æœRouteræ•…éšœï¼Œæ•´ä¸ªåº”ç”¨æ— æ³•è®¿é—®æ•°æ®åº“
```

**é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ**ï¼š
```
        åº”ç”¨ç¨‹åº
           |
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    |      |      |
Router1  Router2  Router3
    |      |      |
    â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
           |
    MySQL InnoDB Cluster
```

### 6.2 å¤šRouterå®ä¾‹éƒ¨ç½²


**ğŸ”¸ ä¸»å¤‡æ¨¡å¼**
```ini
# Router1é…ç½®ï¼ˆä¸»ï¼‰
[DEFAULT]
router_id = 1
bind_address = 0.0.0.0

[routing:cluster_rw]
bind_port = 6446

# Router2é…ç½®ï¼ˆå¤‡ï¼‰  
[DEFAULT]
router_id = 2
bind_address = 0.0.0.0

[routing:cluster_rw]
bind_port = 6446
```

**åº”ç”¨ç¨‹åºè¿æ¥é…ç½®**ï¼š
```python
# åº”ç”¨ç«¯é…ç½®å¤šä¸ªRouteråœ°å€
ROUTER_HOSTS = [
    'router1.company.com:6446',
    'router2.company.com:6446', 
    'router3.company.com:6446'
]

def get_connection():
    for host in ROUTER_HOSTS:
        try:
            conn = mysql.connector.connect(
                host=host.split(':')[0],
                port=int(host.split(':')[1]),
                user='app_user',
                password='password'
            )
            return conn
        except Exception as e:
            print(f"è¿æ¥{host}å¤±è´¥: {e}")
            continue
    raise Exception("æ‰€æœ‰Routeréƒ½æ— æ³•è¿æ¥")
```

**ğŸ”¸ è´Ÿè½½å‡è¡¡æ¨¡å¼**
```
åº”ç”¨ç¨‹åº â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ Routeré›†ç¾¤

è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼ˆNginxç¤ºä¾‹ï¼‰ï¼š
upstream mysql_routers {
    server router1:6446 weight=1 max_fails=3 fail_timeout=30s;
    server router2:6446 weight=1 max_fails=3 fail_timeout=30s;
    server router3:6446 weight=1 max_fails=3 fail_timeout=30s;
}

stream {
    server {
        listen 3306;
        proxy_pass mysql_routers;
        proxy_timeout 1s;
        proxy_responses 1;
    }
}
```

### 6.3 é…ç½®åŒæ­¥ç­–ç•¥


**ğŸ”¸ é™æ€é…ç½®åŒæ­¥**
```bash
# ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·åŒæ­¥
# Ansibleç¤ºä¾‹
---
- name: åŒæ­¥Routeré…ç½®
  hosts: router_servers
  tasks:
    - name: å¤åˆ¶é…ç½®æ–‡ä»¶
      copy:
        src: /etc/mysqlrouter/mysqlrouter.conf
        dest: /etc/mysqlrouter/mysqlrouter.conf
        backup: yes
      notify: restart router

    - name: é‡å¯RouteræœåŠ¡
      service:
        name: mysqlrouter
        state: restarted
```

**ğŸ”¸ åŠ¨æ€é…ç½®çƒ­åŠ è½½**
```bash
# Routeræ”¯æŒé…ç½®çƒ­åŠ è½½
# ä¿®æ”¹é…ç½®åå‘é€ä¿¡å·
kill -HUP `cat /var/run/mysqlrouter/mysqlrouter.pid`

# æˆ–ä½¿ç”¨ç®¡ç†å‘½ä»¤
mysqlrouter --reload

# éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
tail -f /var/log/mysqlrouter/mysqlrouter.log
```

### 6.4 SSLè¿æ¥é…ç½®


**ğŸ”¸ åŸºæœ¬SSLé…ç½®**
```ini
[routing:cluster_rw_ssl]
bind_address = 0.0.0.0
bind_port = 6446
destinations = metadata-cache://cluster/default?role=PRIMARY

# SSLé…ç½®
client_ssl_mode = REQUIRED      # å®¢æˆ·ç«¯å¿…é¡»ä½¿ç”¨SSL
server_ssl_mode = REQUIRED      # è¿æ¥æ•°æ®åº“å¿…é¡»ä½¿ç”¨SSL
client_ssl_cert = /etc/ssl/client-cert.pem
client_ssl_key = /etc/ssl/client-key.pem
client_ssl_ca = /etc/ssl/ca-cert.pem
```

**ğŸ”¸ SSLè¯ä¹¦ç®¡ç†**
```bash
# ç”ŸæˆRouter SSLè¯ä¹¦
openssl genrsa -out router-key.pem 2048
openssl req -new -key router-key.pem -out router-csr.pem
openssl x509 -req -in router-csr.pem -CA ca-cert.pem -CAkey ca-key.pem -out router-cert.pem

# é…ç½®æ–‡ä»¶æƒé™
chmod 600 /etc/ssl/router-key.pem
chown mysqlrouter:mysqlrouter /etc/ssl/router-*
```

---

## 7. ğŸ§  æ™ºèƒ½è·¯ç”±ä¸æ€§èƒ½ä¼˜åŒ–


### 7.1 AIé©±åŠ¨è·¯ç”±ä¼˜åŒ–


**ğŸ”¸ æœºå™¨å­¦ä¹ è·¯ç”±å†³ç­–**
```
ä¼ ç»Ÿè·¯ç”±ï¼šåŸºäºç®€å•è§„åˆ™
SELECTæŸ¥è¯¢ â†’ ä»åº“
INSERT/UPDATE â†’ ä¸»åº“

AIé©±åŠ¨è·¯ç”±ï¼šåŸºäºå†å²æ•°æ®å­¦ä¹ 
åˆ†æå› ç´ ï¼š
- æŸ¥è¯¢ç±»å‹å’Œå¤æ‚åº¦
- å†å²å“åº”æ—¶é—´
- æœåŠ¡å™¨å½“å‰è´Ÿè½½
- ç½‘ç»œå»¶è¿Ÿæ¨¡å¼
- æ—¶é—´æ®µè®¿é—®ç‰¹å¾

å†³ç­–è¿‡ç¨‹ï¼š
1. æ”¶é›†æŸ¥è¯¢ç‰¹å¾
2. é¢„æµ‹æ‰§è¡Œæ—¶é—´
3. é€‰æ‹©æœ€ä¼˜æœåŠ¡å™¨
4. è®°å½•ç»“æœåé¦ˆ
5. æŒç»­å­¦ä¹ ä¼˜åŒ–
```

**ğŸ”¸ æ™ºèƒ½ç¼“å­˜æœºåˆ¶**
```
SQLè·¯ç”±ç¼“å­˜ï¼š
1. ç¼“å­˜ç›¸åŒSQLçš„è·¯ç”±å†³ç­–
2. é¿å…é‡å¤è®¡ç®—å¼€é”€
3. è®¾ç½®åˆç†çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥

ç¼“å­˜å¤±æ•ˆæ¡ä»¶ï¼š
- æœåŠ¡å™¨çŠ¶æ€å˜åŒ–
- è´Ÿè½½æƒ…å†µå˜åŒ–  
- ç¼“å­˜æ—¶é—´è¶…æ—¶
- é›†ç¾¤æ‹“æ‰‘å˜åŒ–
```

### 7.2 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ å…³é”®æ€§èƒ½æŒ‡æ ‡**
```
è¿æ¥æŒ‡æ ‡ï¼š
- å½“å‰è¿æ¥æ•°
- è¿æ¥æˆåŠŸç‡
- è¿æ¥å»ºç«‹æ—¶é—´
- è¿æ¥é”™è¯¯æ¬¡æ•°

æŸ¥è¯¢æŒ‡æ ‡ï¼š
- æŸ¥è¯¢å“åº”æ—¶é—´
- æŸ¥è¯¢æˆåŠŸç‡
- æŸ¥è¯¢ååé‡
- æ…¢æŸ¥è¯¢ç»Ÿè®¡

è·¯ç”±æŒ‡æ ‡ï¼š
- è·¯ç”±å†³ç­–æ—¶é—´
- è´Ÿè½½å‡è¡¡æ•ˆæœ
- æ•…éšœè½¬ç§»æ¬¡æ•°
- æœåŠ¡å™¨åˆ©ç”¨ç‡
```

**ğŸ”¸ ç›‘æ§é…ç½®ç¤ºä¾‹**
```ini
[logger]
level = INFO
filename = mysqlrouter.log

# å¯ç”¨æ€§èƒ½æ—¥å¿—
[logger_performance]
level = DEBUG
filename = performance.log
timestamp_precision = microsecond

# ç›‘æ§é…ç½®
[metadata_cache:cluster]
router_id = 1
ttl = 60
# å¯ç”¨è¯¦ç»†ç›‘æ§
use_gr_notifications = 1
```

### 7.3 è‡ªé€‚åº”è°ƒä¼˜æœºåˆ¶


**ğŸ”¸ åŠ¨æ€å‚æ•°è°ƒæ•´**
```
Routerä¼šç›‘æ§çš„æŒ‡æ ‡ï¼š
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡è¶‹åŠ¿
- è¿æ¥æ± ä½¿ç”¨ç‡
- CPUå’Œå†…å­˜ä½¿ç”¨

è‡ªåŠ¨è°ƒæ•´çš„å‚æ•°ï¼š
- è¿æ¥æ± å¤§å°
- è¶…æ—¶æ—¶é—´è®¾ç½®
- å¥åº·æ£€æŸ¥é—´éš”
- è·¯ç”±æƒé‡åˆ†é…

è°ƒæ•´è§¦å‘æ¡ä»¶ï¼š
1. å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼
2. é”™è¯¯ç‡æŒç»­ä¸Šå‡
3. èµ„æºä½¿ç”¨ç‡å¼‚å¸¸
4. ç”¨æˆ·é…ç½®çš„è§„åˆ™
```

**ğŸ”¸ é¢„æµ‹æ€§ä¼˜åŒ–**
```
åŸºäºå†å²æ•°æ®é¢„æµ‹ï¼š
- è®¿é—®é«˜å³°æ—¶é—´
- èµ„æºéœ€æ±‚å˜åŒ–
- å¯èƒ½çš„æ•…éšœç‚¹

æå‰ä¼˜åŒ–æªæ–½ï¼š
1. é¢„çƒ­è¿æ¥æ± 
2. è°ƒæ•´è·¯ç”±æƒé‡
3. é¢„åŠ è½½é…ç½®
4. å‡†å¤‡æ•…éšœè½¬ç§»
```

### 7.4 æ•…éšœé¢„æµ‹ä¸é¢„é˜²


**ğŸ”¸ æ•…éšœé¢„æµ‹ç®—æ³•**
```
æ•°æ®æ”¶é›†ï¼š
- æœåŠ¡å™¨å“åº”æ—¶é—´è¶‹åŠ¿
- é”™è¯¯ç‡å˜åŒ–æ¨¡å¼
- èµ„æºä½¿ç”¨ç‡æ›²çº¿
- ç½‘ç»œå»¶è¿Ÿæ•°æ®

é¢„æµ‹æ¨¡å‹ï¼š
1. æ—¶é—´åºåˆ—åˆ†æ
2. å¼‚å¸¸æ£€æµ‹ç®—æ³•
3. æœºå™¨å­¦ä¹ æ¨¡å‹
4. é˜ˆå€¼ç›‘æ§

é¢„è­¦æœºåˆ¶ï¼š
- å“åº”æ—¶é—´å¼‚å¸¸å¢é•¿
- é”™è¯¯ç‡çªç„¶ä¸Šå‡
- è¿æ¥æ•°å¼‚å¸¸æ³¢åŠ¨
- èµ„æºä½¿ç”¨æ¥è¿‘ä¸Šé™
```

**ğŸ”¸ é¢„é˜²æ€§æªæ–½**
```ini
# é…ç½®é¢„é˜²æ€§å‚æ•°
[routing:cluster_ro]
max_connections = 1000
max_connect_errors = 50          # é™ä½é”™è¯¯é˜ˆå€¼
connect_timeout = 5              # ç¼©çŸ­è¶…æ—¶æ—¶é—´
unreachable_destination_refresh_interval = 30  # æ›´é¢‘ç¹æ£€æŸ¥

# å¯ç”¨é¢„è­¦
[logger_alerts]
level = WARN
filename = alerts.log

é¢„é˜²æªæ–½ï¼š
1. æå‰æ‰©å®¹è¿æ¥æ± 
2. è°ƒæ•´è·¯ç”±ç­–ç•¥
3. å‡†å¤‡å¤‡ç”¨æœåŠ¡å™¨
4. é€šçŸ¥è¿ç»´äººå‘˜
```

---

## 8. ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„é›†æˆ


### 8.1 æœåŠ¡å‘ç°é›†æˆ


**ğŸ”¸ ä¸Kubernetesé›†æˆ**
```yaml
# Kuberneteséƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-router
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mysql-router
  template:
    metadata:
      labels:
        app: mysql-router
    spec:
      containers:
      - name: mysql-router
        image: mysql/mysql-router:8.0
        ports:
        - containerPort: 6446
        - containerPort: 6447
        env:
        - name: MYSQL_HOST
          value: "mysql-cluster-service"
        - name: MYSQL_PORT
          value: "3306"
        volumeMounts:
        - name: router-config
          mountPath: /etc/mysqlrouter
```

**ğŸ”¸ æœåŠ¡æ³¨å†Œé…ç½®**
```yaml
# Serviceé…ç½®
apiVersion: v1
kind: Service
metadata:
  name: mysql-router-service
spec:
  selector:
    app: mysql-router
  ports:
  - name: mysql-rw
    port: 6446
    targetPort: 6446
  - name: mysql-ro  
    port: 6447
    targetPort: 6447
  type: ClusterIP
```

### 8.2 å¾®æœåŠ¡è¿æ¥æ¨¡å¼


**ğŸ”¸ å®¹å™¨åŒ–éƒ¨ç½²æ¨¡å¼**
```dockerfile
# Routerå®¹å™¨é•œåƒ
FROM mysql/mysql-router:8.0

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY mysqlrouter.conf /etc/mysqlrouter/

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV MYSQL_ROUTER_BOOTSTRAP_EXTRA_OPTIONS="--force"

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=30s --retries=3 \
    CMD mysqladmin ping -h localhost -P 6446 --silent

EXPOSE 6446 6447
```

**ğŸ”¸ sidecaræ¨¡å¼éƒ¨ç½²**
```yaml
# åº”ç”¨Podä¸­åŒ…å«Router sidecar
apiVersion: v1
kind: Pod
spec:
  containers:
  # åº”ç”¨å®¹å™¨
  - name: app
    image: my-app:latest
    env:
    - name: DB_HOST
      value: "localhost"  # è¿æ¥åŒPodä¸­çš„Router
    - name: DB_PORT_RW
      value: "6446"
    - name: DB_PORT_RO  
      value: "6447"
  
  # Router sidecarå®¹å™¨
  - name: mysql-router
    image: mysql/mysql-router:8.0
    ports:
    - containerPort: 6446
    - containerPort: 6447
```

### 8.3 é…ç½®ç®¡ç†æœ€ä½³å®è·µ


**ğŸ”¸ ConfigMapé…ç½®ç®¡ç†**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-router-config
data:
  mysqlrouter.conf: |
    [DEFAULT]
    logging_folder = /var/log/mysqlrouter
    
    [metadata_cache:cluster]
    bootstrap_server_addresses = mysql-0.mysql:3306,mysql-1.mysql:3306
    user = router_user
    ttl = 60
    
    [routing:cluster_rw]
    bind_address = 0.0.0.0
    bind_port = 6446
    destinations = metadata-cache://cluster/default?role=PRIMARY
    
    [routing:cluster_ro]
    bind_address = 0.0.0.0  
    bind_port = 6447
    destinations = metadata-cache://cluster/default?role=SECONDARY
```

**ğŸ”¸ Secretç®¡ç†**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysql-router-secret
type: Opaque
data:
  username: <base64ç¼–ç çš„ç”¨æˆ·å>
  password: <base64ç¼–ç çš„å¯†ç >
```

### 8.4 å¾®æœåŠ¡æ²»ç†é›†æˆ


**ğŸ”¸ é“¾è·¯è¿½è¸ªé›†æˆ**
```python
# åº”ç”¨ä»£ç ç¤ºä¾‹
import opentracing
from jaeger_client import Config

def get_database_connection():
    # åˆ›å»ºé“¾è·¯è¿½è¸ªspan
    tracer = opentracing.global_tracer()
    with tracer.start_span('database_connection') as span:
        span.set_tag('db.type', 'mysql')
        span.set_tag('db.instance', 'production_cluster')
        
        try:
            conn = mysql.connector.connect(
                host='mysql-router-service',
                port=6446,
                user='app_user',
                password='password'
            )
            span.set_tag('db.connection', 'success')
            return conn
        except Exception as e:
            span.set_tag('error', True)
            span.set_tag('error.message', str(e))
            raise
```

**ğŸ”¸ ç›‘æ§é›†æˆ**
```yaml
# Prometheusç›‘æ§é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    scrape_configs:
    - job_name: 'mysql-router'
      static_configs:
      - targets: ['mysql-router-service:8080']
      metrics_path: /metrics
      scrape_interval: 30s
```

---

## 9. ğŸ“Š ç›‘æ§è°ƒä¼˜ä¸æ•…éšœé¢„é˜²


### 9.1 æ€§èƒ½ç›‘æ§ä½“ç³»


**ğŸ”¸ ç›‘æ§æŒ‡æ ‡åˆ†å±‚**
```
åŸºç¡€è®¾æ–½å±‚ç›‘æ§ï¼š
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡  
- ç½‘ç»œI/O
- ç£ç›˜I/O

Routerå±‚ç›‘æ§ï¼š
- è¿æ¥æ•°ç»Ÿè®¡
- è·¯ç”±å»¶è¿Ÿ
- é”™è¯¯ç‡
- ååé‡

åº”ç”¨å±‚ç›‘æ§ï¼š
- æŸ¥è¯¢å“åº”æ—¶é—´
- äº‹åŠ¡æˆåŠŸç‡
- ä¸šåŠ¡æŒ‡æ ‡
- ç”¨æˆ·ä½“éªŒ
```

**ğŸ”¸ å…³é”®ç›‘æ§é…ç½®**
```ini
# Routerç›‘æ§é…ç½®
[logger_performance]
level = INFO
filename = performance.log

# è®°å½•çš„æ€§èƒ½æŒ‡æ ‡
æ€§èƒ½æ—¥å¿—å†…å®¹ï¼š
- è¿æ¥å»ºç«‹æ—¶é—´
- æŸ¥è¯¢æ‰§è¡Œæ—¶é—´
- è·¯ç”±å†³ç­–æ—¶é—´
- é”™è¯¯ç»Ÿè®¡ä¿¡æ¯
```

### 9.2 å‘Šè­¦ç³»ç»Ÿè®¾è®¡


**ğŸ”¸ å‘Šè­¦è§„åˆ™é…ç½®**
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
- name: mysql-router
  rules:
  - alert: RouterHighConnectionCount
    expr: mysql_router_connections > 800
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Routerè¿æ¥æ•°è¿‡é«˜"
      
  - alert: RouterHighErrorRate  
    expr: mysql_router_error_rate > 0.05
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "Routeré”™è¯¯ç‡è¿‡é«˜"
      
  - alert: RouterSlowResponse
    expr: mysql_router_response_time > 1000
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "Routerå“åº”æ—¶é—´è¿‡é•¿"
```

**ğŸ”¸ å‘Šè­¦é€šçŸ¥é…ç½®**
```yaml
# AlertManageré…ç½®
route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'mysql-team'

receivers:
- name: 'mysql-team'
  email_configs:
  - to: 'dba-team@company.com'
    subject: 'MySQL Routerå‘Šè­¦: {{ .GroupLabels.alertname }}'
    body: |
      å‘Šè­¦æ—¶é—´: {{ .CommonAnnotations.summary }}
      å‘Šè­¦è¯¦æƒ…: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
```

### 9.3 æ€§èƒ½è°ƒä¼˜ç­–ç•¥


**ğŸ”¸ è¿æ¥æ± è°ƒä¼˜**
```ini
# è°ƒä¼˜å‰çš„åˆ†æ
ç›‘æ§æŒ‡æ ‡åˆ†æï¼š
- è¿æ¥æ± ä½¿ç”¨ç‡ï¼š85%ï¼ˆåé«˜ï¼‰
- å¹³å‡ç­‰å¾…æ—¶é—´ï¼š200msï¼ˆè¾ƒé•¿ï¼‰
- è¿æ¥å»ºç«‹å¤±è´¥ç‡ï¼š2%ï¼ˆéœ€ä¼˜åŒ–ï¼‰

è°ƒä¼˜é…ç½®ï¼š
[routing:cluster_rw]
max_connections = 1500          # å¢åŠ è¿æ¥æ± å¤§å°
connect_timeout = 15            # å¢åŠ è¿æ¥è¶…æ—¶
client_connect_timeout = 45     # å¢åŠ å®¢æˆ·ç«¯è¶…æ—¶

è°ƒä¼˜åæ•ˆæœï¼š
- è¿æ¥æ± ä½¿ç”¨ç‡ï¼š65%
- å¹³å‡ç­‰å¾…æ—¶é—´ï¼š50ms  
- è¿æ¥å»ºç«‹å¤±è´¥ç‡ï¼š0.1%
```

**ğŸ”¸ è·¯ç”±ç­–ç•¥è°ƒä¼˜**
```ini
# æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒä¼˜
ä¸šåŠ¡åˆ†æï¼š
- è¯»å†™æ¯”ä¾‹ï¼š80%è¯»ï¼Œ20%å†™
- æŸ¥è¯¢ç±»å‹ï¼š60%ç®€å•æŸ¥è¯¢ï¼Œ40%å¤æ‚æŸ¥è¯¢
- å³°å€¼æ—¶é—´ï¼š9:00-11:00ï¼Œ14:00-16:00

è°ƒä¼˜ç­–ç•¥ï¼š
[routing:cluster_ro]
routing_strategy = round-robin-with-fallback
max_connections = 2000          # è¯»æ“ä½œè¿æ¥æ± æ›´å¤§

[routing:cluster_rw]  
routing_strategy = first-available
max_connections = 800           # å†™æ“ä½œè¿æ¥æ± ç›¸å¯¹è¾ƒå°
```

### 9.4 å®¹é‡è§„åˆ’ä¸æ‰©å®¹


**ğŸ”¸ å®¹é‡è¯„ä¼°æ–¹æ³•**
```
è¯„ä¼°ç»´åº¦ï¼š
1. å¹¶å‘è¿æ¥æ•°éœ€æ±‚
2. æŸ¥è¯¢ååé‡è¦æ±‚
3. å“åº”æ—¶é—´SLA
4. ä¸šåŠ¡å¢é•¿é¢„æœŸ

è®¡ç®—å…¬å¼ï¼š
æ‰€éœ€è¿æ¥æ•° = å³°å€¼QPS Ã— å¹³å‡æŸ¥è¯¢æ—¶é—´ Ã— å®‰å…¨ç³»æ•°

ç¤ºä¾‹è®¡ç®—ï¼š
å³°å€¼QPSï¼š1000
å¹³å‡æŸ¥è¯¢æ—¶é—´ï¼š50ms = 0.05s
å®‰å…¨ç³»æ•°ï¼š1.5
æ‰€éœ€è¿æ¥æ•° = 1000 Ã— 0.05 Ã— 1.5 = 75

è€ƒè™‘è¯»å†™åˆ†ç¦»ï¼š
è¯»è¿æ¥æ•°ï¼š75 Ã— 0.8 = 60
å†™è¿æ¥æ•°ï¼š75 Ã— 0.2 = 15
```

**ğŸ”¸ è‡ªåŠ¨æ‰©å®¹ç­–ç•¥**
```yaml
# Kubernetes HPAé…ç½®
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: mysql-router-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: mysql-router
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Pods
    pods:
      metric:
        name: mysql_router_connections
      target:
        type: AverageValue
        averageValue: "500"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ MySQL Routeræœ¬è´¨ï¼šæ™ºèƒ½æ•°æ®åº“ä»£ç†ï¼Œæä¾›è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šé€šè¿‡ä¸åŒç«¯å£å®ç°è¯»å†™æ“ä½œçš„åˆ†ç¦»å¤„ç†
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå¤šç§ç®—æ³•ç¡®ä¿è¯·æ±‚åˆç†åˆ†é…åˆ°å„ä¸ªæ•°æ®åº“æœåŠ¡å™¨
ğŸ”¸ è¿æ¥æ± ï¼šå¤ç”¨è¿æ¥å‡å°‘å¼€é”€ï¼Œæé«˜æ€§èƒ½å’Œèµ„æºåˆ©ç”¨ç‡
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šå®æ—¶ç›‘æ§æœåŠ¡å™¨çŠ¶æ€ï¼Œå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»
ğŸ”¸ é«˜å¯ç”¨éƒ¨ç½²ï¼šå¤šRouterå®ä¾‹é¿å…å•ç‚¹æ•…éšœ
```

### 10.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ åŸºç¡€é…ç½®ç»“æ„**
```
é…ç½®æ–‡ä»¶ç»„æˆï¼š
- DEFAULTæ®µï¼šå…¨å±€é…ç½®
- metadata_cacheæ®µï¼šé›†ç¾¤ä¿¡æ¯ç¼“å­˜
- routingæ®µï¼šè·¯ç”±è§„åˆ™å®šä¹‰
- loggeræ®µï¼šæ—¥å¿—é…ç½®

æ ¸å¿ƒé…ç½®é¡¹ï¼š
- bootstrap_server_addressesï¼šé›†ç¾¤æœåŠ¡å™¨åˆ—è¡¨
- routing_strategyï¼šè·¯ç”±ç­–ç•¥é€‰æ‹©
- max_connectionsï¼šè¿æ¥æ•°é™åˆ¶
- ttlï¼šç¼“å­˜ç”Ÿå­˜æ—¶é—´
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
```
é«˜å¯ç”¨é…ç½®ï¼š
âœ… éƒ¨ç½²å¤šä¸ªRouterå®ä¾‹
âœ… é…ç½®åˆé€‚çš„è¶…æ—¶å‚æ•°
âœ… å¯ç”¨SSLåŠ å¯†è¿æ¥
âœ… è®¾ç½®å®Œå–„çš„ç›‘æ§å‘Šè­¦

æ€§èƒ½ä¼˜åŒ–ï¼š
âœ… æ ¹æ®ä¸šåŠ¡è°ƒæ•´è¿æ¥æ± å¤§å°
âœ… é€‰æ‹©åˆé€‚çš„è·¯ç”±ç­–ç•¥
âœ… é…ç½®è¿æ¥å¤ç”¨æœºåˆ¶
âœ… å¯ç”¨æ™ºèƒ½è·¯ç”±å†³ç­–
```

### 10.3 æ•…éšœå¤„ç†ä¸ä¼˜åŒ–


**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**
```
è¿æ¥é—®é¢˜ï¼š
- æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
- éªŒè¯è®¤è¯ä¿¡æ¯
- ç¡®è®¤ç«¯å£é…ç½®
- æŸ¥çœ‹é˜²ç«å¢™è®¾ç½®

æ€§èƒ½é—®é¢˜ï¼š
- åˆ†æè¿æ¥æ± ä½¿ç”¨ç‡
- æ£€æŸ¥è·¯ç”±ç­–ç•¥æ•ˆæœ
- ç›‘æ§å“åº”æ—¶é—´æŒ‡æ ‡
- ä¼˜åŒ–æŸ¥è¯¢åˆ†å‘ç­–ç•¥

æ•…éšœè½¬ç§»é—®é¢˜ï¼š
- éªŒè¯å¥åº·æ£€æŸ¥é…ç½®
- æ£€æŸ¥é›†ç¾¤çŠ¶æ€åŒæ­¥
- ç¡®è®¤æ•…éšœæ£€æµ‹æ—¶é—´
- æµ‹è¯•è‡ªåŠ¨æ¢å¤æœºåˆ¶
```

**ğŸ”¹ ç›‘æ§ä¸è°ƒä¼˜é‡ç‚¹**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- è¿æ¥æ•°å’Œä½¿ç”¨ç‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- è·¯ç”±åˆ†å‘æ•ˆæœ

è°ƒä¼˜ç­–ç•¥ï¼š
- åŸºäºç›‘æ§æ•°æ®è°ƒæ•´å‚æ•°
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹ä¼˜åŒ–é…ç½®
- å®šæœŸè¯„ä¼°å®¹é‡éœ€æ±‚
- æŒç»­ä¼˜åŒ–è·¯ç”±ç®—æ³•
```

### 10.4 å®é™…åº”ç”¨ä»·å€¼


- **é«˜å¯ç”¨ä¿éšœ**ï¼šé€šè¿‡Routerå®ç°æ•°æ®åº“é›†ç¾¤çš„é«˜å¯ç”¨è®¿é—®
- **æ€§èƒ½æå‡**ï¼šè¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½
- **è¿ç»´ç®€åŒ–**ï¼šè‡ªåŠ¨æ•…éšœè½¬ç§»å‡å°‘äººå·¥å¹²é¢„éœ€æ±‚
- **æ‰©å±•æ€§å¢å¼º**ï¼šæ”¯æŒåŠ¨æ€æ‰©å®¹å’Œå¾®æœåŠ¡æ¶æ„é›†æˆ
- **æˆæœ¬ä¼˜åŒ–**ï¼šè¿æ¥å¤ç”¨å’Œæ™ºèƒ½è·¯ç”±æé«˜èµ„æºåˆ©ç”¨ç‡

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Routeræ˜¯åº”ç”¨å’Œæ•°æ®åº“é—´çš„æ™ºèƒ½ä»£ç†
- è¯»å†™åˆ†ç¦»é€šè¿‡ä¸åŒç«¯å£å®ç°ä¸šåŠ¡éš”ç¦»
- è´Ÿè½½å‡è¡¡ç¡®ä¿è¯·æ±‚åˆç†åˆ†é…æå‡æ€§èƒ½
- è¿æ¥æ± å’Œå¥åº·æ£€æŸ¥æ˜¯é«˜æ€§èƒ½çš„åŸºç¡€
- å¤šå®ä¾‹éƒ¨ç½²å’Œç›‘æ§å‘Šè­¦ä¿è¯é«˜å¯ç”¨