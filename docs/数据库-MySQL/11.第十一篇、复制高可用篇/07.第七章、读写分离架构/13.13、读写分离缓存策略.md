---
title: 13ã€è¯»å†™åˆ†ç¦»ç¼“å­˜ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»ç¼“å­˜æ¦‚è¿°](#1-è¯»å†™åˆ†ç¦»ç¼“å­˜æ¦‚è¿°)
2. [æŸ¥è¯¢ç¼“å­˜ä¸è¯»å†™åˆ†ç¦»](#2-æŸ¥è¯¢ç¼“å­˜ä¸è¯»å†™åˆ†ç¦»)
3. [åˆ†å¸ƒå¼ç¼“å­˜é›†æˆ](#3-åˆ†å¸ƒå¼ç¼“å­˜é›†æˆ)
4. [ç¼“å­˜ä¸€è‡´æ€§ä¿è¯](#4-ç¼“å­˜ä¸€è‡´æ€§ä¿è¯)
5. [ç¼“å­˜æ›´æ–°ç­–ç•¥](#5-ç¼“å­˜æ›´æ–°ç­–ç•¥)
6. [ç¼“å­˜é¢„çƒ­æœºåˆ¶](#6-ç¼“å­˜é¢„çƒ­æœºåˆ¶)
7. [ç¼“å­˜æ•…éšœå¤„ç†](#7-ç¼“å­˜æ•…éšœå¤„ç†)
8. [ç¼“å­˜æ€§èƒ½ä¼˜åŒ–](#8-ç¼“å­˜æ€§èƒ½ä¼˜åŒ–)
9. [ç¼“å­˜ç›‘æ§æŒ‡æ ‡](#9-ç¼“å­˜ç›‘æ§æŒ‡æ ‡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¯»å†™åˆ†ç¦»ç¼“å­˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»ç¼“å­˜ç­–ç•¥


è¯»å†™åˆ†ç¦»ç¼“å­˜ç­–ç•¥ï¼Œå°±æ˜¯åœ¨MySQLè¯»å†™åˆ†ç¦»æ¶æ„çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ç¼“å­˜å±‚æ¥è¿›ä¸€æ­¥æå‡ç³»ç»Ÿæ€§èƒ½çš„æŠ€æœ¯æ–¹æ¡ˆã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠç»å¸¸æŸ¥è¯¢çš„æ•°æ®æ”¾åˆ°å†…å­˜é‡Œï¼Œé¿å…æ¯æ¬¡éƒ½å»æ•°æ®åº“æŸ¥è¯¢ã€‚

```
ä¼ ç»Ÿè¯»å†™åˆ†ç¦»ï¼š
åº”ç”¨ â†’ ä¸»åº“(å†™) + ä»åº“(è¯»)

åŠ å…¥ç¼“å­˜åï¼š
åº”ç”¨ â†’ ç¼“å­˜ â†’ ä¸»åº“(å†™) + ä»åº“(è¯»)
```

**ğŸ”¥ ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼Ÿ**
- **é€Ÿåº¦æå‡**ï¼šå†…å­˜è®¿é—®æ¯”ç£ç›˜å¿«1000å€ä»¥ä¸Š
- **å‡å°‘å‹åŠ›**ï¼šå‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œé™ä½æ•°æ®åº“è´Ÿè½½
- **æˆæœ¬èŠ‚çº¦**ï¼šå‡å°‘æ•°æ®åº“æœåŠ¡å™¨æ•°é‡ï¼ŒèŠ‚çœç¡¬ä»¶æˆæœ¬

### 1.2 ç¼“å­˜åœ¨è¯»å†™åˆ†ç¦»ä¸­çš„ä½œç”¨


```
å®Œæ•´çš„æ•°æ®è®¿é—®æµç¨‹ï¼š

å†™æ“ä½œæµç¨‹ï¼š
ç”¨æˆ·å†™è¯·æ±‚ â†’ åº”ç”¨ â†’ ä¸»åº“ â†’ æ›´æ–°ç¼“å­˜

è¯»æ“ä½œæµç¨‹ï¼š
ç”¨æˆ·è¯»è¯·æ±‚ â†’ åº”ç”¨ â†’ ç¼“å­˜å‘½ä¸­ï¼Ÿ
              â†“æ˜¯         â†“å¦
            è¿”å›æ•°æ®    â†’ ä»åº“æŸ¥è¯¢ â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›æ•°æ®
```

**â­ æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- å¤§å¹…å‡å°‘æ•°æ®åº“è®¿é—®
- æå‡æŸ¥è¯¢å“åº”é€Ÿåº¦
- å¢å¼ºç³»ç»Ÿå¹¶å‘èƒ½åŠ›
- é™ä½æ•°æ®åº“æœåŠ¡å™¨å‹åŠ›

---

## 2. ğŸ—„ï¸ æŸ¥è¯¢ç¼“å­˜ä¸è¯»å†™åˆ†ç¦»


### 2.1 MySQLåŸç”ŸæŸ¥è¯¢ç¼“å­˜


MySQLè‡ªå¸¦æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½ï¼Œä½†åœ¨è¯»å†™åˆ†ç¦»ç¯å¢ƒä¸‹æœ‰ç‰¹æ®Šè€ƒè™‘ã€‚

**ğŸ”§ æŸ¥è¯¢ç¼“å­˜å·¥ä½œåŸç†ï¼š**
```sql
-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢
SELECT * FROM users WHERE id = 1;
-- MySQLå°†SQLè¯­å¥å’Œç»“æœå­˜å…¥ç¼“å­˜

-- ç¬¬äºŒæ¬¡ç›¸åŒæŸ¥è¯¢
SELECT * FROM users WHERE id = 1;
-- ç›´æ¥ä»ç¼“å­˜è¿”å›ï¼Œä¸è®¿é—®ç£ç›˜
```

**âš ï¸ è¯»å†™åˆ†ç¦»ç¯å¢ƒä¸‹çš„é—®é¢˜ï¼š**

```
é—®é¢˜åœºæ™¯ï¼š
1. ä¸»åº“å†™å…¥æ–°æ•°æ®
2. ä»åº“è¿˜æœªåŒæ­¥ï¼ˆæœ‰å»¶è¿Ÿï¼‰
3. æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯æ—§æ•°æ®
4. ç”¨æˆ·å¯èƒ½è¯»åˆ°è¿‡æœŸæ•°æ®
```

### 2.2 æŸ¥è¯¢ç¼“å­˜é…ç½®ç­–ç•¥


**ğŸ”¸ ä¸»åº“é…ç½®ï¼ˆå…³é—­æŸ¥è¯¢ç¼“å­˜ï¼‰ï¼š**
```sql
-- ä¸»åº“ä¸“é—¨å¤„ç†å†™æ“ä½œï¼Œå…³é—­æŸ¥è¯¢ç¼“å­˜
SET GLOBAL query_cache_type = OFF;
SET GLOBAL query_cache_size = 0;
```

**ğŸ”¸ ä»åº“é…ç½®ï¼ˆå¼€å¯æŸ¥è¯¢ç¼“å­˜ï¼‰ï¼š**
```sql
-- ä»åº“ä¸»è¦å¤„ç†è¯»æ“ä½œï¼Œå¼€å¯æŸ¥è¯¢ç¼“å­˜
SET GLOBAL query_cache_type = ON;
SET GLOBAL query_cache_size = 128M;
SET GLOBAL query_cache_limit = 2M;
```

**ğŸ’¡ é…ç½®è¯´æ˜ï¼š**
- `query_cache_type`ï¼šæŸ¥è¯¢ç¼“å­˜ç±»å‹ï¼ˆOFF/ON/DEMANDï¼‰
- `query_cache_size`ï¼šç¼“å­˜å¤§å°ï¼Œå»ºè®®128M-512M
- `query_cache_limit`ï¼šå•ä¸ªæŸ¥è¯¢ç»“æœçš„æœ€å¤§ç¼“å­˜å¤§å°

---

## 3. ğŸŒ åˆ†å¸ƒå¼ç¼“å­˜é›†æˆ


### 3.1 å¸¸ç”¨åˆ†å¸ƒå¼ç¼“å­˜æ–¹æ¡ˆ


åœ¨è¯»å†™åˆ†ç¦»æ¶æ„ä¸­ï¼Œé€šå¸¸ä½¿ç”¨å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿï¼Œå¦‚Redisã€Memcachedç­‰ã€‚

**ğŸ”¸ æ¶æ„å¯¹æ¯”ï¼š**

| ç¼“å­˜æ–¹æ¡ˆ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **Redis** | `æ”¯æŒæ•°æ®ç»“æ„`ã€`æŒä¹…åŒ–`ã€`é«˜å¯ç”¨` | `å†…å­˜æ¶ˆè€—å¤§` | `å¤æ‚ä¸šåŠ¡åœºæ™¯` |
| **Memcached** | `ç®€å•é«˜æ•ˆ`ã€`å†…å­˜åˆ©ç”¨ç‡é«˜` | `åŠŸèƒ½å•ä¸€`ã€`æ— æŒä¹…åŒ–` | `ç®€å•ç¼“å­˜åœºæ™¯` |
| **MySQLæŸ¥è¯¢ç¼“å­˜** | `é€æ˜ä½¿ç”¨`ã€`é…ç½®ç®€å•` | `å‘½ä¸­ç‡ä½`ã€`æ‰©å±•æ€§å·®` | `å°å‹åº”ç”¨` |

### 3.2 Redisé›†æˆå®è·µ


**ğŸ”§ Redisé›†æˆæ¶æ„ï¼š**
```
åº”ç”¨å±‚
   â†“
Redisé›†ç¾¤ (ä¸»ç¼“å­˜)
   â†“ (ç¼“å­˜æœªå‘½ä¸­)
MySQLè¯»å†™åˆ†ç¦»
   â”œâ”€ ä¸»åº“ (å†™)
   â””â”€ ä»åº“ (è¯»)
```

**ğŸ’» ä»£ç ç¤ºä¾‹ï¼š**
```java
@Service
public class UserService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private UserMapper userMapper;
    
    // è¯»æ“ä½œï¼šç¼“å­˜ä¼˜å…ˆ
    public User getUserById(Long id) {
        String key = "user:" + id;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        User user = (User) redisTemplate.opsForValue().get(key);
        if (user != null) {
            return user; // ç¼“å­˜å‘½ä¸­
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ï¼ˆä»åº“ï¼‰
        user = userMapper.selectById(id);
        if (user != null) {
            // 3. å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
        }
        
        return user;
    }
    
    // å†™æ“ä½œï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜
    public void updateUser(User user) {
        // 1. æ›´æ–°æ•°æ®åº“ï¼ˆä¸»åº“ï¼‰
        userMapper.updateById(user);
        
        // 2. æ›´æ–°ç¼“å­˜
        String key = "user:" + user.getId();
        redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
    }
}
```

---

## 4. ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ä¿è¯


### 4.1 ä¸€è‡´æ€§é—®é¢˜åˆ†æ


åœ¨è¯»å†™åˆ†ç¦»+ç¼“å­˜çš„æ¶æ„ä¸­ï¼Œæ•°æ®ä¸€è‡´æ€§æ˜¯æœ€å¤§çš„æŒ‘æˆ˜ã€‚

**âš ï¸ ä¸€è‡´æ€§é—®é¢˜åœºæ™¯ï¼š**
```
æ—¶é—´çº¿é—®é¢˜ï¼š
T1: ç”¨æˆ·Aæ›´æ–°æ•°æ® â†’ ä¸»åº“
T2: ç¼“å­˜æ›´æ–°ä¸ºæ–°å€¼
T3: ä¸»ä»å¤åˆ¶å»¶è¿Ÿï¼Œä»åº“è¿˜æ˜¯æ—§å€¼
T4: ç”¨æˆ·BæŸ¥è¯¢ â†’ ç¼“å­˜å¤±æ•ˆ â†’ ä»åº“æŸ¥è¯¢ â†’ è¿”å›æ—§å€¼
```

### 4.2 ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ æ–¹æ¡ˆ1ï¼šå»¶è¿ŸåŒåˆ ç­–ç•¥**
```java
public void updateUser(User user) {
    String key = "user:" + user.getId();
    
    // 1. åˆ é™¤ç¼“å­˜
    redisTemplate.delete(key);
    
    // 2. æ›´æ–°æ•°æ®åº“
    userMapper.updateById(user);
    
    // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ˆè€ƒè™‘ä¸»ä»å»¶è¿Ÿï¼‰
    new Thread(() -> {
        try {
            Thread.sleep(1000); // ç­‰å¾…ä¸»ä»åŒæ­¥
            redisTemplate.delete(key);
        } catch (InterruptedException e) {
            log.error("å»¶è¿Ÿåˆ é™¤ç¼“å­˜å¤±è´¥", e);
        }
    }).start();
}
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥æ›´æ–°**
```java
// å†™æ“ä½œæ—¶å‘é€æ¶ˆæ¯
public void updateUser(User user) {
    // 1. æ›´æ–°æ•°æ®åº“
    userMapper.updateById(user);
    
    // 2. å‘é€ç¼“å­˜æ›´æ–°æ¶ˆæ¯
    CacheUpdateMessage message = new CacheUpdateMessage();
    message.setKey("user:" + user.getId());
    message.setDelay(1000); // å»¶è¿Ÿ1ç§’å¤„ç†
    
    messageQueue.send(message);
}

// æ¶ˆæ¯å¤„ç†å™¨
@RabbitListener(queues = "cache.update")
public void handleCacheUpdate(CacheUpdateMessage message) {
    redisTemplate.delete(message.getKey());
}
```

### 4.3 æœ€ç»ˆä¸€è‡´æ€§ç­–ç•¥


**ğŸ¯ æ ¸å¿ƒæ€æƒ³ï¼š**
- æ¥å—çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´
- é€šè¿‡æ—¶é—´æ¢å–ç³»ç»Ÿå¯ç”¨æ€§
- è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´

**ğŸ’¡ å®è·µå»ºè®®ï¼š**
```
ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®ï¼š
- çƒ­ç‚¹æ•°æ®ï¼š5-15åˆ†é’Ÿ
- æ™®é€šæ•°æ®ï¼š30-60åˆ†é’Ÿ
- å†·æ•°æ®ï¼š2-4å°æ—¶

è¿‡æœŸæ—¶é—´ > ä¸»ä»å»¶è¿Ÿæ—¶é—´ Ã— 2
```

---

## 5. ğŸ”„ ç¼“å­˜æ›´æ–°ç­–ç•¥


### 5.1 å¸¸è§æ›´æ–°ç­–ç•¥å¯¹æ¯”


| ç­–ç•¥ | **æè¿°** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|---------|-------------|
| **Cache Aside** | `åº”ç”¨è´Ÿè´£ç¼“å­˜ç®¡ç†` | `ç®€å•å¯æ§` | `ä»£ç å¤æ‚` | `é€šç”¨åœºæ™¯` |
| **Write Through** | `å†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜` | `ä¸€è‡´æ€§å¥½` | `å†™æ€§èƒ½å·®` | `å¼ºä¸€è‡´æ€§è¦æ±‚` |
| **Write Behind** | `å¼‚æ­¥æ‰¹é‡æ›´æ–°` | `å†™æ€§èƒ½å¥½` | `å¯èƒ½ä¸¢æ•°æ®` | `é«˜å¹¶å‘å†™å…¥` |

### 5.2 Cache Asideæ¨¡å¼å®ç°


è¿™æ˜¯æœ€å¸¸ç”¨çš„ç¼“å­˜æ¨¡å¼ï¼Œç”±åº”ç”¨ç¨‹åºè´Ÿè´£ç®¡ç†ç¼“å­˜ã€‚

**ğŸ”§ è¯»æ“ä½œæµç¨‹ï¼š**
```java
public User getUser(Long id) {
    // 1. è¯»ç¼“å­˜
    User user = cache.get("user:" + id);
    if (user != null) {
        return user;
    }
    
    // 2. è¯»æ•°æ®åº“ï¼ˆä»åº“ï¼‰
    user = database.select(id);
    if (user != null) {
        // 3. å†™ç¼“å­˜
        cache.set("user:" + id, user, 30 * 60); // 30åˆ†é’Ÿ
    }
    
    return user;
}
```

**ğŸ”§ å†™æ“ä½œæµç¨‹ï¼š**
```java
public void updateUser(User user) {
    // 1. å†™æ•°æ®åº“ï¼ˆä¸»åº“ï¼‰
    database.update(user);
    
    // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½ï¼‰
    cache.delete("user:" + user.getId());
}
```

### 5.3 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


**ğŸš€ æ‰¹é‡åˆ é™¤ç¼“å­˜ï¼š**
```java
@Service
public class CacheService {
    
    // æ‰¹é‡åˆ é™¤ç›¸å…³ç¼“å­˜
    public void batchDeleteUserCache(List<Long> userIds) {
        List<String> keys = userIds.stream()
            .map(id -> "user:" + id)
            .collect(Collectors.toList());
            
        // Redisç®¡é“æ“ä½œï¼Œæå‡æ€§èƒ½
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (String key : keys) {
                connection.del(key.getBytes());
            }
            return null;
        });
    }
}
```

---

## 6. ğŸš€ ç¼“å­˜é¢„çƒ­æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯ç¼“å­˜é¢„çƒ­


ç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæå‰æŠŠçƒ­ç‚¹æ•°æ®åŠ è½½åˆ°ç¼“å­˜ä¸­ï¼Œé¿å…ç”¨æˆ·è¯·æ±‚æ—¶ä¸´æ—¶æŸ¥è¯¢æ•°æ®åº“ã€‚

**ğŸ”¥ ä¸ºä»€ä¹ˆéœ€è¦é¢„çƒ­ï¼Ÿ**
- é¿å…ç¼“å­˜é›ªå´©ï¼ˆå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼‰
- æå‡ç”¨æˆ·ä½“éªŒï¼ˆé¦–æ¬¡è®¿é—®ä¹Ÿå¾ˆå¿«ï¼‰
- å‡å°‘æ•°æ®åº“å‹åŠ›ï¼ˆå¯åŠ¨é˜¶æ®µè´Ÿè½½å‡åŒ€ï¼‰

### 6.2 é¢„çƒ­ç­–ç•¥å®ç°


**ğŸ”¸ å¯åŠ¨æ—¶é¢„çƒ­ï¼š**
```java
@Component
public class CacheWarmUpService {
    
    @PostConstruct
    public void warmUpCache() {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        
        // 1. é¢„çƒ­ç”¨æˆ·æ•°æ®ï¼ˆæœ€æ´»è·ƒçš„1000ä¸ªç”¨æˆ·ï¼‰
        List<User> activeUsers = userService.getActiveUsers(1000);
        activeUsers.forEach(user -> {
            String key = "user:" + user.getId();
            redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
        });
        
        // 2. é¢„çƒ­å•†å“æ•°æ®ï¼ˆçƒ­é—¨å•†å“ï¼‰
        List<Product> hotProducts = productService.getHotProducts(500);
        hotProducts.forEach(product -> {
            String key = "product:" + product.getId();
            redisTemplate.opsForValue().set(key, product, 60, TimeUnit.MINUTES);
        });
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
}
```

**ğŸ”¸ å®šæ—¶é¢„çƒ­ï¼š**
```java
@Component
public class ScheduledWarmUp {
    
    // æ¯å¤©å‡Œæ™¨2ç‚¹é¢„çƒ­
    @Scheduled(cron = "0 0 2 * * ?")
    public void dailyWarmUp() {
        log.info("å¼€å§‹å®šæ—¶ç¼“å­˜é¢„çƒ­...");
        
        // å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…é˜»å¡
        CompletableFuture.runAsync(() -> {
            warmUpHotData();
        });
    }
    
    private void warmUpHotData() {
        // æ ¹æ®å‰ä¸€å¤©çš„è®¿é—®ç»Ÿè®¡ï¼Œé¢„çƒ­çƒ­ç‚¹æ•°æ®
        List<String> hotKeys = statisticsService.getYesterdayHotKeys();
        for (String key : hotKeys) {
            if (!redisTemplate.hasKey(key)) {
                // ä»æ•°æ®åº“é‡æ–°åŠ è½½
                loadAndCache(key);
            }
        }
    }
}
```

### 6.3 æ™ºèƒ½é¢„çƒ­ç­–ç•¥


**ğŸ“Š åŸºäºè®¿é—®ç»Ÿè®¡çš„é¢„çƒ­ï¼š**
```java
@Service
public class SmartWarmUpService {
    
    // è®°å½•è®¿é—®ç»Ÿè®¡
    public void recordAccess(String key) {
        String statsKey = "access_stats:" + key;
        redisTemplate.opsForZSet().incrementScore("hot_keys", key, 1);
        
        // è®¾ç½®ç»Ÿè®¡è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
        redisTemplate.expire(statsKey, 24, TimeUnit.HOURS);
    }
    
    // è·å–çƒ­ç‚¹æ•°æ®è¿›è¡Œé¢„çƒ­
    public void smartWarmUp() {
        // è·å–è®¿é—®æ¬¡æ•°Top 100çš„key
        Set<String> hotKeys = redisTemplate.opsForZSet()
            .reverseRange("hot_keys", 0, 99);
            
        for (String key : hotKeys) {
            if (!redisTemplate.hasKey(key)) {
                // å¼‚æ­¥é¢„çƒ­
                CompletableFuture.runAsync(() -> preloadData(key));
            }
        }
    }
}
```

---

## 7. ğŸ› ï¸ ç¼“å­˜æ•…éšœå¤„ç†


### 7.1 å¸¸è§ç¼“å­˜æ•…éšœåœºæ™¯


**âš ï¸ ç¼“å­˜é›ªå´©ï¼š**
å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ã€‚

```
æ•…éšœåœºæ™¯ï¼š
1. å¤§é‡ç¼“å­˜è®¾ç½®ç›¸åŒè¿‡æœŸæ—¶é—´
2. åŒä¸€æ—¶åˆ»å¤§æ‰¹é‡å¤±æ•ˆ
3. è¯·æ±‚ç¬é—´æ¶Œå‘æ•°æ®åº“
4. æ•°æ®åº“å‹åŠ›æ¿€å¢ï¼Œå¯èƒ½å®•æœº
```

**âš ï¸ ç¼“å­˜ç©¿é€ï¼š**
æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ— æ³•èµ·åˆ°ä¿æŠ¤ä½œç”¨ã€‚

```
æ•…éšœåœºæ™¯ï¼š
1. ç”¨æˆ·æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
2. ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“
3. æ•°æ®åº“ä¹Ÿæ²¡æœ‰ï¼Œè¿”å›ç©º
4. ä¸‹æ¬¡è¯·æ±‚é‡å¤è¿™ä¸ªè¿‡ç¨‹
```

**âš ï¸ ç¼“å­˜å‡»ç©¿ï¼š**
çƒ­ç‚¹æ•°æ®è¿‡æœŸæ—¶ï¼Œå¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ã€‚

### 7.2 æ•…éšœå¤„ç†æ–¹æ¡ˆ


**ğŸ”¸ é›ªå´©é˜²æŠ¤ï¼š**
```java
@Service
public class AntiAvalancheService {
    
    // éšæœºè¿‡æœŸæ—¶é—´ï¼Œé¿å…åŒæ—¶å¤±æ•ˆ
    public void setWithRandomExpire(String key, Object value, int baseExpire) {
        Random random = new Random();
        // åŸºç¡€è¿‡æœŸæ—¶é—´ + éšæœºæ—¶é—´ï¼ˆ0-300ç§’ï¼‰
        int expireTime = baseExpire + random.nextInt(300);
        
        redisTemplate.opsForValue().set(key, value, expireTime, TimeUnit.SECONDS);
    }
    
    // å¤šçº§ç¼“å­˜é˜²æŠ¤
    public Object getWithFallback(String key) {
        // 1. å°è¯•Redis
        Object value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            return value;
        }
        
        // 2. å°è¯•æœ¬åœ°ç¼“å­˜
        value = localCache.get(key);
        if (value != null) {
            return value;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        return queryDatabase(key);
    }
}
```

**ğŸ”¸ ç©¿é€é˜²æŠ¤ï¼š**
```java
// ç©ºå€¼ç¼“å­˜ç­–ç•¥
public User getUserById(Long id) {
    String key = "user:" + id;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºå€¼ç¼“å­˜
    if (redisTemplate.hasKey(key + ":null")) {
        return null; // ç›´æ¥è¿”å›ï¼Œä¸æŸ¥æ•°æ®åº“
    }
    
    User user = (User) redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    user = userMapper.selectById(id);
    if (user != null) {
        redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
    } else {
        // ç¼“å­˜ç©ºå€¼ï¼Œè¾ƒçŸ­è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(key + ":null", "1", 5, TimeUnit.MINUTES);
    }
    
    return user;
}
```

**ğŸ”¸ å‡»ç©¿é˜²æŠ¤ï¼ˆåˆ†å¸ƒå¼é”ï¼‰ï¼š**
```java
public User getUserWithLock(Long id) {
    String key = "user:" + id;
    String lockKey = "lock:user:" + id;
    
    User user = (User) redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    // å°è¯•è·å–åˆ†å¸ƒå¼é”
    String lockValue = UUID.randomUUID().toString();
    Boolean lockSuccess = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS);
    
    if (lockSuccess) {
        try {
            // åŒé‡æ£€æŸ¥
            user = (User) redisTemplate.opsForValue().get(key);
            if (user != null) {
                return user;
            }
            
            // æŸ¥è¯¢æ•°æ®åº“
            user = userMapper.selectById(id);
            if (user != null) {
                redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
            }
            
            return user;
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    } else {
        // ç­‰å¾…ä¸€ä¸‹å†é‡è¯•
        try {
            Thread.sleep(50);
            return getUserWithLock(id);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return null;
        }
    }
}
```

---

## 8. âš¡ ç¼“å­˜æ€§èƒ½ä¼˜åŒ–


### 8.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸš€ è¿æ¥æ± ä¼˜åŒ–ï¼š**
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
        poolConfig.setMaxTotal(200);        // æœ€å¤§è¿æ¥æ•°
        poolConfig.setMaxIdle(50);          // æœ€å¤§ç©ºé—²è¿æ¥
        poolConfig.setMinIdle(10);          // æœ€å°ç©ºé—²è¿æ¥
        poolConfig.setMaxWaitMillis(3000);  // æœ€å¤§ç­‰å¾…æ—¶é—´
        
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(poolConfig)
                .commandTimeout(Duration.ofSeconds(2))
                .build();
        
        RedisStandaloneConfiguration serverConfig = 
            new RedisStandaloneConfiguration("localhost", 6379);
            
        return new LettuceConnectionFactory(serverConfig, clientConfig);
    }
}
```

**ğŸš€ åºåˆ—åŒ–ä¼˜åŒ–ï¼š**
```java
@Configuration
public class RedisTemplateConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory());
        
        // ä½¿ç”¨é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼
        Jackson2JsonRedisSerializer<Object> serializer = 
            new Jackson2JsonRedisSerializer<>(Object.class);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(serializer);
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(serializer);
        
        return template;
    }
}
```

### 8.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ“¦ ç®¡é“æ‰¹é‡æ“ä½œï¼š**
```java
// æ‰¹é‡è®¾ç½®ç¼“å­˜
public void batchSet(Map<String, Object> keyValues) {
    redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
        keyValues.forEach((key, value) -> {
            try {
                byte[] keyBytes = key.getBytes();
                byte[] valueBytes = serialize(value);
                connection.setEx(keyBytes, 1800, valueBytes); // 30åˆ†é’Ÿ
            } catch (Exception e) {
                log.error("æ‰¹é‡è®¾ç½®ç¼“å­˜å¤±è´¥: " + key, e);
            }
        });
        return null;
    });
}

// æ‰¹é‡è·å–ç¼“å­˜
public List<Object> batchGet(List<String> keys) {
    List<Object> result = redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
        for (String key : keys) {
            connection.get(key.getBytes());
        }
        return null;
    });
    
    return result;
}
```

### 8.3 å†…å­˜ä¼˜åŒ–


**ğŸ’¾ å†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼š**
```java
// å‹ç¼©å¤§å¯¹è±¡
public void setLargeObject(String key, Object obj) {
    try {
        // åºåˆ—åŒ–
        byte[] data = serialize(obj);
        
        // å¦‚æœè¶…è¿‡1KBï¼Œå¯ç”¨å‹ç¼©
        if (data.length > 1024) {
            data = compress(data);
            key = key + ":compressed";
        }
        
        redisTemplate.opsForValue().set(key, data, 30, TimeUnit.MINUTES);
    } catch (Exception e) {
        log.error("è®¾ç½®å¤§å¯¹è±¡ç¼“å­˜å¤±è´¥", e);
    }
}

// è®¾ç½®å†…å­˜æ¸…ç†ç­–ç•¥
public void configureMemoryPolicy() {
    // Redisé…ç½®
    // maxmemory 2gb
    // maxmemory-policy allkeys-lru  # LRUæ·˜æ±°ç­–ç•¥
}
```

---

## 9. ğŸ“Š ç¼“å­˜ç›‘æ§æŒ‡æ ‡


### 9.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


**ğŸ¯ æ€§èƒ½æŒ‡æ ‡ï¼š**

| æŒ‡æ ‡ç±»å‹ | **æŒ‡æ ‡åç§°** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** | **è¯´æ˜** |
|---------|-------------|-------------|-------------|---------|
| **å‘½ä¸­ç‡** | `ç¼“å­˜å‘½ä¸­ç‡` | `>80%` | `<70%` | `ç¼“å­˜æ•ˆæœçš„æ ¸å¿ƒæŒ‡æ ‡` |
| **å“åº”æ—¶é—´** | `å¹³å‡å“åº”æ—¶é—´` | `<5ms` | `>10ms` | `æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡` |
| **å¹¶å‘é‡** | `QPS` | `è§†ä¸šåŠ¡è€Œå®š` | `è¶…è¿‡è®¾è®¡å€¼` | `å¹¶å‘å¤„ç†èƒ½åŠ›` |
| **å†…å­˜** | `å†…å­˜ä½¿ç”¨ç‡` | `<80%` | `>90%` | `èµ„æºä½¿ç”¨æƒ…å†µ` |

### 9.2 ç›‘æ§å®ç°


**ğŸ“ˆ ç›‘æ§ä»£ç å®ç°ï¼š**
```java
@Component
public class CacheMonitor {
    
    private final MeterRegistry meterRegistry;
    private final AtomicLong hitCount = new AtomicLong(0);
    private final AtomicLong missCount = new AtomicLong(0);
    
    public CacheMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // æ³¨å†Œç›‘æ§æŒ‡æ ‡
        Gauge.builder("cache.hit.rate")
            .register(meterRegistry, this, CacheMonitor::getHitRate);
    }
    
    // è®°å½•ç¼“å­˜å‘½ä¸­
    public void recordHit() {
        hitCount.incrementAndGet();
        meterRegistry.counter("cache.hit").increment();
    }
    
    // è®°å½•ç¼“å­˜æœªå‘½ä¸­
    public void recordMiss() {
        missCount.incrementAndGet();
        meterRegistry.counter("cache.miss").increment();
    }
    
    // è®¡ç®—å‘½ä¸­ç‡
    public double getHitRate() {
        long total = hitCount.get() + missCount.get();
        return total == 0 ? 0 : (double) hitCount.get() / total;
    }
    
    // å®šæ—¶æŠ¥å‘Šç»Ÿè®¡ä¿¡æ¯
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿ
    public void reportStats() {
        double hitRate = getHitRate();
        log.info("ç¼“å­˜ç»Ÿè®¡ - å‘½ä¸­ç‡: {:.2f}%, å‘½ä¸­æ¬¡æ•°: {}, æœªå‘½ä¸­æ¬¡æ•°: {}", 
            hitRate * 100, hitCount.get(), missCount.get());
            
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        meterRegistry.gauge("cache.hit.count", hitCount.get());
        meterRegistry.gauge("cache.miss.count", missCount.get());
    }
}
```

### 9.3 å‘Šè­¦é…ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™ç¤ºä¾‹ï¼š**
```yaml
# Prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: cache_alerts
    rules:
      # ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½
      - alert: CacheHitRateLow
        expr: cache_hit_rate < 0.7
        for: 5m
        annotations:
          summary: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
          description: "ç¼“å­˜å‘½ä¸­ç‡ä½äº70%ï¼Œå½“å‰å€¼: {{ $value }}"
      
      # ç¼“å­˜å“åº”æ—¶é—´è¿‡é•¿
      - alert: CacheResponseSlow
        expr: cache_response_time_avg > 0.01
        for: 2m
        annotations:
          summary: "ç¼“å­˜å“åº”æ—¶é—´è¿‡é•¿"
          description: "ç¼“å­˜å¹³å‡å“åº”æ—¶é—´è¶…è¿‡10ms"
      
      # Rediså†…å­˜ä½¿ç”¨è¿‡é«˜
      - alert: RedisMemoryHigh
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 3m
        annotations:
          summary: "Rediså†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "Rediså†…å­˜ä½¿ç”¨ç‡è¶…è¿‡90%"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¥ ç¼“å­˜ç­–ç•¥æ ¸å¿ƒï¼š
â€¢ Cache Asideæ¨¡å¼ï¼šåº”ç”¨ç®¡ç†ç¼“å­˜ï¼Œæœ€å¸¸ç”¨
â€¢ ä¸€è‡´æ€§ä¿è¯ï¼šå»¶è¿ŸåŒåˆ ã€æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°  
â€¢ æ•…éšœé˜²æŠ¤ï¼šé›ªå´©ã€ç©¿é€ã€å‡»ç©¿çš„é˜²æŠ¤æ–¹æ¡ˆ
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šè¿æ¥æ± ã€åºåˆ—åŒ–ã€æ‰¹é‡æ“ä½œ

ğŸ¯ å…³é”®ç†è§£è¦ç‚¹ï¼š
â€¢ ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œè¦åˆç†ä½¿ç”¨
â€¢ ä¸€è‡´æ€§å’Œæ€§èƒ½éœ€è¦å¹³è¡¡
â€¢ ç›‘æ§å’Œå‘Šè­¦å¿…ä¸å¯å°‘
â€¢ é¢„çƒ­å’Œé™çº§ç­–ç•¥è¦å‡†å¤‡
```

### 10.2 å®è·µåº”ç”¨æŒ‡å¯¼


**ğŸ’¡ ç¼“å­˜ä½¿ç”¨æœ€ä½³å®è·µï¼š**

> âœ¨ **æ¨èåšæ³•**ï¼š
> - è¯»å¤šå†™å°‘çš„æ•°æ®é€‚åˆç¼“å­˜
> - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
> - ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å‡»ç©¿
> - å®æ–½å¤šçº§ç¼“å­˜ç­–ç•¥

> ğŸš« **é¿å…åšæ³•**ï¼š
> - ä¸è¦ç¼“å­˜é¢‘ç¹å˜æ›´çš„æ•°æ®
> - ä¸è¦è®¾ç½®è¿‡é•¿çš„è¿‡æœŸæ—¶é—´
> - ä¸è¦å¿½ç•¥ç¼“å­˜é¢„çƒ­
> - ä¸è¦å¿½è§†ä¸€è‡´æ€§é—®é¢˜

**ğŸ§  è®°å¿†å£è¯€ï¼š**
```
ç¼“å­˜ç­–ç•¥è¦è®°ç‰¢ï¼Œä¸€è‡´æ€§èƒ½ä¸¤æ‰‹æŠ“
é¢„çƒ­ç›‘æ§ä¸èƒ½å°‘ï¼Œæ•…éšœå¤„ç†è¦æå‰
è¯»å†™åˆ†ç¦»é…ç¼“å­˜ï¼Œæ€§èƒ½æå‡æ›´æ˜æ˜¾
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼ï¼š**
- **æ€§èƒ½æå‡**ï¼šæŸ¥è¯¢é€Ÿåº¦æå‡10-100å€
- **å‹åŠ›å‡è½»**ï¼šæ•°æ®åº“è´Ÿè½½é™ä½70-90%  
- **ç”¨æˆ·ä½“éªŒ**ï¼šå“åº”æ—¶é—´æ˜æ˜¾æ”¹å–„
- **æˆæœ¬èŠ‚çº¦**ï¼šå‡å°‘æ•°æ®åº“æœåŠ¡å™¨æŠ•å…¥
