---
title: 3ã€æ•°æ®ä¸€è‡´æ€§å¤„ç†
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»æ¶æ„æ¦‚è¿°](#1-è¯»å†™åˆ†ç¦»æ¶æ„æ¦‚è¿°)
2. [æ•°æ®ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ](#2-æ•°æ®ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ)
3. [ä¸€è‡´æ€§çº§åˆ«ä¸é€‰æ‹©ç­–ç•¥](#3-ä¸€è‡´æ€§çº§åˆ«ä¸é€‰æ‹©ç­–ç•¥)
4. [ä¸»ä»å»¶è¿Ÿå¤„ç†æœºåˆ¶](#4-ä¸»ä»å»¶è¿Ÿå¤„ç†æœºåˆ¶)
5. [è¯»å†™ä¸€è‡´æ€§å®ç°ç­–ç•¥](#5-è¯»å†™ä¸€è‡´æ€§å®ç°ç­–ç•¥)
6. [ä¸šåŠ¡åœºæ™¯é€‚é…æ–¹æ¡ˆ](#6-ä¸šåŠ¡åœºæ™¯é€‚é…æ–¹æ¡ˆ)
7. [ä¸€è‡´æ€§ç›‘æ§ä¸è¿ç»´](#7-ä¸€è‡´æ€§ç›‘æ§ä¸è¿ç»´)
8. [é«˜çº§ä¸€è‡´æ€§ä¿éšœæŠ€æœ¯](#8-é«˜çº§ä¸€è‡´æ€§ä¿éšœæŠ€æœ¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---


## 1. ğŸ—ï¸ è¯»å†™åˆ†ç¦»æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»


**ç®€å•ç†è§£**ï¼šè¯»å†™åˆ†ç¦»å°±åƒä¸€ä¸ªé¤å…çš„åˆ†å·¥
- **ä¸»åº“ï¼ˆMasterï¼‰**ï¼šåƒä¸»å¨ï¼Œä¸“é—¨è´Ÿè´£"å†™èœå•"ï¼ˆå¤„ç†å†™æ“ä½œï¼‰
- **ä»åº“ï¼ˆSlaveï¼‰**ï¼šåƒæœåŠ¡å‘˜ï¼Œä¸“é—¨è´Ÿè´£"çœ‹èœå•"ï¼ˆå¤„ç†è¯»æ“ä½œï¼‰
- **åŒæ­¥è¿‡ç¨‹**ï¼šä¸»å¨æ›´æ–°èœå•åï¼Œè¦é€šçŸ¥æ‰€æœ‰æœåŠ¡å‘˜ï¼ˆæ•°æ®åŒæ­¥ï¼‰

```
å…¸å‹è¯»å†™åˆ†ç¦»æ¶æ„ï¼š

åº”ç”¨å±‚
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶  â”‚ â† ProxySQLã€MyCatç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è·¯ç”±ç­–ç•¥åˆ¤æ–­    â”‚ â† å†™æ“ä½œâ†’ä¸»åº“ï¼Œè¯»æ“ä½œâ†’ä»åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“          â†“
 å†™æ“ä½œ      è¯»æ“ä½œ
   â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”
â”‚ä¸»åº“  â”‚â”€â”€â”€â†’â”‚ä»åº“  â”‚ â† ä¸»ä»å¤åˆ¶
â”‚Masterâ”‚    â”‚Slaveâ”‚
â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜
```

### 1.2 è¯»å†™åˆ†ç¦»çš„æ ¸å¿ƒä¼˜åŠ¿


**æ€§èƒ½æå‡**ï¼š
- **å¹¶å‘å¤„ç†**ï¼šè¯»å†™æ“ä½œåˆ†åˆ«åœ¨ä¸åŒæœåŠ¡å™¨æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°
- **è´Ÿè½½åˆ†æ‹…**ï¼šå¤šä¸ªä»åº“å¯ä»¥åˆ†æ‹…è¯»å‹åŠ›
- **èµ„æºä¼˜åŒ–**ï¼šè¯»åº“å¯ä»¥é’ˆå¯¹æŸ¥è¯¢ä¼˜åŒ–ï¼Œå†™åº“é’ˆå¯¹äº‹åŠ¡ä¼˜åŒ–

**å¯ç”¨æ€§å¢å¼º**ï¼š
- **æ•…éšœéš”ç¦»**ï¼šè¯»åº“æ•…éšœä¸å½±å“å†™æ“ä½œ
- **å¤‡ä»½å®‰å…¨**ï¼šä»åº“å¯ä»¥ç”¨äºå¤‡ä»½ï¼Œä¸å½±å“ä¸»åº“æ€§èƒ½

---

## 2. ğŸ¯ æ•°æ®ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ


### 2.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸€è‡´æ€§


**ç”Ÿæ´»åŒ–ç†è§£**ï¼šæ•°æ®ä¸€è‡´æ€§å°±åƒé“¶è¡Œè´¦æˆ·ä½™é¢
- ä½ åœ¨ATMæœºAå­˜é’±åï¼Œåœ¨ATMæœºBæŸ¥è¯¢åº”è¯¥èƒ½çœ‹åˆ°æœ€æ–°ä½™é¢
- å¦‚æœçœ‹ä¸åˆ°ï¼Œå°±æ˜¯"ä¸ä¸€è‡´"ï¼›å¦‚æœèƒ½çœ‹åˆ°ï¼Œå°±æ˜¯"ä¸€è‡´"

### 2.2 ä¸€è‡´æ€§çš„åˆ†ç±»


#### ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰


**æ¦‚å¿µè§£é‡Š**ï¼š
```
å°±åƒå¾®ä¿¡æœ‹å‹åœˆå‘åŠ¨æ€ï¼š
- ä½ å‘å¸ƒåï¼Œæœ‹å‹ä»¬ä¸ä¼šç«‹åˆ»å…¨éƒ¨çœ‹åˆ°
- ä½†è¿‡ä¸€æ®µæ—¶é—´ï¼ˆå‡ ç§’åˆ°å‡ åˆ†é’Ÿï¼‰ï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°
- è¿™å°±æ˜¯"æœ€ç»ˆä¸€è‡´æ€§"
```

**ç‰¹ç‚¹**ï¼š
- âœ… **æ€§èƒ½å¥½**ï¼šä¸éœ€è¦ç­‰å¾…åŒæ­¥å®Œæˆ
- âœ… **å¯ç”¨æ€§é«˜**ï¼šç½‘ç»œæŠ–åŠ¨ä¸å½±å“æ“ä½œ
- âŒ **çŸ­æœŸä¸ä¸€è‡´**ï¼šå¯èƒ½è¯»åˆ°æ—§æ•°æ®

#### ğŸ”¸ å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰


**æ¦‚å¿µè§£é‡Š**ï¼š
```
å°±åƒé“¶è¡Œè½¬è´¦ï¼š
- ä»Aè´¦æˆ·è½¬å‡º100å…ƒ
- ç«‹åˆ»Bè´¦æˆ·å°±å¿…é¡»å¢åŠ 100å…ƒ
- ä»»ä½•æ—¶åˆ»æŸ¥è¯¢éƒ½æ˜¯ä¸€è‡´çš„
```

**ç‰¹ç‚¹**ï¼š
- âœ… **æ•°æ®å‡†ç¡®**ï¼šä»»ä½•æ—¶å€™è¯»åˆ°çš„éƒ½æ˜¯æœ€æ–°æ•°æ®
- âŒ **æ€§èƒ½è¾ƒå·®**ï¼šéœ€è¦ç­‰å¾…åŒæ­¥å®Œæˆ
- âŒ **å¯ç”¨æ€§é£é™©**ï¼šç½‘ç»œé—®é¢˜å¯èƒ½å¯¼è‡´æ“ä½œå¤±è´¥

#### ğŸ”¸ å•è°ƒè¯»ä¸€è‡´æ€§ï¼ˆMonotonic Read Consistencyï¼‰


**é€šä¿—ç†è§£**ï¼š
```
å°±åƒçœ‹å°è¯´è¿è½½ï¼š
- ä½ çœ‹åˆ°ç¬¬10ç« åï¼Œå†æ¬¡æ‰“å¼€ä¸ä¼šé€€å›åˆ°ç¬¬9ç« 
- å¯èƒ½è¿˜æ˜¯ç¬¬10ç« ï¼Œä½†ç»ä¸ä¼š"å€’é€€"
- ä¿è¯"åªèƒ½å¾€å‰ï¼Œä¸ä¼šå€’é€€"
```

### 2.3 ä¸€è‡´æ€§é—®é¢˜çš„æ ¹æœ¬åŸå› 


**æ ¸å¿ƒé—®é¢˜**ï¼šä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿ

```
æ—¶é—´è½´ç¤ºä¾‹ï¼š
T1: ç”¨æˆ·åœ¨ä¸»åº“å†™å…¥æ•°æ® "ç”¨æˆ·ä½™é¢=1000"
T2: æ•°æ®å¼€å§‹ä»ä¸»åº“å‘ä»åº“å¤åˆ¶
T3: ç”¨æˆ·ç«‹åˆ»ä»ä»åº“æŸ¥è¯¢ä½™é¢ 
T4: ä»åº“è¿”å›æ—§æ•°æ® "ç”¨æˆ·ä½™é¢=800" â† é—®é¢˜å‡ºç°
T5: æ•°æ®å¤åˆ¶å®Œæˆï¼Œä»åº“æ•°æ®æ›´æ–°ä¸º1000
```

---

## 3. âš–ï¸ ä¸€è‡´æ€§çº§åˆ«ä¸é€‰æ‹©ç­–ç•¥


### 3.1 ä¸€è‡´æ€§çº§åˆ«åˆ†ç±»


| ä¸€è‡´æ€§çº§åˆ« | **å»¶è¿Ÿå®¹å¿** | **æ€§èƒ½å½±å“** | **é€‚ç”¨åœºæ™¯** | **å®ç°å¤æ‚åº¦** |
|-----------|------------|------------|------------|-------------|
| ğŸŸ¢ **æœ€ç»ˆä¸€è‡´æ€§** | `ç§’çº§` | `æœ€å°` | `å†…å®¹å±•ç¤ºã€ç»Ÿè®¡æŠ¥è¡¨` | `ç®€å•` |
| ğŸŸ¡ **å•è°ƒè¯»ä¸€è‡´æ€§** | `æ¯«ç§’çº§` | `è¾ƒå°` | `ç”¨æˆ·ä¸ªäººä¿¡æ¯` | `ä¸­ç­‰` |
| ğŸŸ  **å› æœä¸€è‡´æ€§** | `æ¯«ç§’çº§` | `ä¸­ç­‰` | `è¯„è®ºå›å¤ã€ç‚¹èµ` | `å¤æ‚` |
| ğŸ”´ **å¼ºä¸€è‡´æ€§** | `é›¶å®¹å¿` | `æœ€å¤§` | `æ”¯ä»˜ã€åº“å­˜æ‰£å‡` | `ç®€å•` |

### 3.2 ä¸šåŠ¡åœºæ™¯åŒ¹é…ç­–ç•¥


#### ğŸ“Š å†…å®¹å±•ç¤ºç±»åœºæ™¯


```
é€‚ç”¨ï¼šæœ€ç»ˆä¸€è‡´æ€§
ç¤ºä¾‹ï¼š
- å•†å“è¯¦æƒ…é¡µæµè§ˆ
- æ–°é—»æ–‡ç« é˜…è¯»  
- ç”¨æˆ·è¯„è®ºå±•ç¤º

ç­–ç•¥ï¼šç›´æ¥ä»ä»åº“è¯»å–ï¼Œæ€§èƒ½æœ€ä½³
```

#### ğŸ’° é‡‘èäº¤æ˜“ç±»åœºæ™¯


```
é€‚ç”¨ï¼šå¼ºä¸€è‡´æ€§
ç¤ºä¾‹ï¼š
- è´¦æˆ·ä½™é¢æŸ¥è¯¢
- æ”¯ä»˜æ“ä½œ
- åº“å­˜æ‰£å‡

ç­–ç•¥ï¼šå†™åè¯»ä¸»åº“ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®
```

#### ğŸ‘¤ ç”¨æˆ·ä¸ªäººä¿¡æ¯


```
é€‚ç”¨ï¼šå•è°ƒè¯»ä¸€è‡´æ€§
ç¤ºä¾‹ï¼š
- ä¸ªäººèµ„æ–™æ›´æ–°
- è´­ä¹°å†å²æŸ¥è¯¢
- æ”¶è—å¤¹ç®¡ç†

ç­–ç•¥ï¼šåŒä¸€ä¼šè¯å†…ä¿æŒä¸€è‡´æ€§
```

### 3.3 ä¸€è‡´æ€§çº§åˆ«SLAå®šä¹‰


**é‡åŒ–ç®¡ç†ç¤ºä¾‹**ï¼š

```
SLAç­‰çº§å®šä¹‰ï¼š

é‡‘ç‰ŒæœåŠ¡ï¼ˆé‡‘èä¸šåŠ¡ï¼‰ï¼š
- ä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´æ€§
- å»¶è¿Ÿå®¹å¿ï¼š0ms
- å¯ç”¨æ€§è¦æ±‚ï¼š99.99%

é“¶ç‰ŒæœåŠ¡ï¼ˆç”¨æˆ·æ“ä½œï¼‰ï¼š
- ä¸€è‡´æ€§è¦æ±‚ï¼šå•è°ƒè¯»ä¸€è‡´æ€§  
- å»¶è¿Ÿå®¹å¿ï¼š100ms
- å¯ç”¨æ€§è¦æ±‚ï¼š99.9%

é“œç‰ŒæœåŠ¡ï¼ˆå†…å®¹å±•ç¤ºï¼‰ï¼š
- ä¸€è‡´æ€§è¦æ±‚ï¼šæœ€ç»ˆä¸€è‡´æ€§
- å»¶è¿Ÿå®¹å¿ï¼š3ç§’
- å¯ç”¨æ€§è¦æ±‚ï¼š99.5%
```

---

## 4. â±ï¸ ä¸»ä»å»¶è¿Ÿå¤„ç†æœºåˆ¶


### 4.1 ä¸»ä»å»¶è¿Ÿçš„äº§ç”ŸåŸå› 


**æŠ€æœ¯å±‚é¢åŸå› **ï¼š

```
ç½‘ç»œä¼ è¾“å»¶è¿Ÿï¼š
ä¸»åº“ â”€â”€ç½‘ç»œâ”€â”€â†’ ä»åº“
     â†‘
   å‡ æ¯«ç§’åˆ°å‡ ç™¾æ¯«ç§’

SQLæ‰§è¡Œå»¶è¿Ÿï¼š
ä»åº“éœ€è¦é‡æ”¾ä¸»åº“çš„SQLè¯­å¥
å¤æ‚SQL â†’ æ‰§è¡Œæ—¶é—´é•¿ â†’ å»¶è¿Ÿå¢åŠ 

ç¡¬ä»¶æ€§èƒ½å·®å¼‚ï¼š
ä¸»åº“ï¼šé«˜é…ç½®æœåŠ¡å™¨
ä»åº“ï¼šä¸€èˆ¬é…ç½®æœåŠ¡å™¨ â†’ å¤„ç†æ…¢
```

### 4.2 å»¶è¿Ÿç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- æŸ¥çœ‹ä¸»ä»å»¶è¿Ÿ
SHOW SLAVE STATUS\G

é‡è¦å­—æ®µï¼š
- Seconds_Behind_Master: å»¶è¿Ÿç§’æ•°
- Master_Log_File: ä¸»åº“å½“å‰binlogæ–‡ä»¶
- Read_Master_Log_Pos: è¯»å–ä¸»åº“ä½ç½®
- Relay_Master_Log_File: ä¸­ç»§æ—¥å¿—å¯¹åº”çš„ä¸»åº“æ–‡ä»¶
```

### 4.3 å»¶è¿Ÿå¤„ç†ç­–ç•¥


#### ğŸ”¸ é¢„è®¾å»¶è¿Ÿé˜ˆå€¼


```python
# ä¼ªä»£ç ç¤ºä¾‹
def read_with_consistency_check():
    slave_delay = get_slave_delay()
    
    if slave_delay > MAX_ACCEPTABLE_DELAY:
        # å»¶è¿Ÿè¿‡å¤§ï¼Œä»ä¸»åº“è¯»
        return read_from_master()
    else:
        # å»¶è¿Ÿå¯æ¥å—ï¼Œä»ä»åº“è¯»
        return read_from_slave()
```

#### ğŸ”¸ æ™ºèƒ½è·¯ç”±ç­–ç•¥


```
è·¯ç”±å†³ç­–æµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚
    â†“
åˆ¤æ–­ä¸šåŠ¡ç±»å‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼ºä¸€è‡´æ€§éœ€æ±‚?    â”‚ â”€â”€Yesâ”€â”€â†’ è·¯ç”±åˆ°ä¸»åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ No
æ£€æŸ¥å»¶è¿ŸçŠ¶å†µ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ å»¶è¿Ÿ < é˜ˆå€¼?     â”‚ â”€â”€Yesâ”€â”€â†’ è·¯ç”±åˆ°ä»åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ No
è·¯ç”±åˆ°ä¸»åº“
```

---

## 5. ğŸ”„ è¯»å†™ä¸€è‡´æ€§å®ç°ç­–ç•¥


### 5.1 ä¼šè¯ä¸€è‡´æ€§æœºåˆ¶


**åŸºæœ¬æ€æƒ³**ï¼šåŒä¸€ä¸ªç”¨æˆ·ä¼šè¯å†…ä¿æŒæ•°æ®ä¸€è‡´æ€§

```python
# ä¼šè¯ç²˜æ€§å®ç°
class SessionConsistency:
    def __init__(self):
        self.user_write_timestamps = {}
    
    def handle_request(self, user_id, request_type):
        if request_type == 'WRITE':
            # è®°å½•ç”¨æˆ·çš„å†™æ“ä½œæ—¶é—´
            self.user_write_timestamps[user_id] = time.now()
            return execute_on_master(request)
        
        elif request_type == 'READ':
            last_write_time = self.user_write_timestamps.get(user_id, 0)
            current_time = time.now()
            
            # å¦‚æœè·ç¦»ä¸Šæ¬¡å†™æ“ä½œå¾ˆè¿‘ï¼Œä»ä¸»åº“è¯»
            if current_time - last_write_time < CONSISTENCY_WINDOW:
                return execute_on_master(request)
            else:
                return execute_on_slave(request)
```

### 5.2 å› æœä¸€è‡´æ€§å®ç°


**åº”ç”¨åœºæ™¯**ï¼šç”¨æˆ·å‘è¡¨è¯„è®ºåç«‹åˆ»èƒ½çœ‹åˆ°è‡ªå·±çš„è¯„è®º

```
å®ç°æ€è·¯ï¼š

ç”¨æˆ·Aå‘è¡¨è¯„è®º
    â†“
ç³»ç»Ÿç”Ÿæˆç‰ˆæœ¬å·/æ—¶é—´æˆ³
    â†“
å†™å…¥ä¸»åº“ï¼Œå¹¶è®°å½•ç‰ˆæœ¬å·
    â†“
ç”¨æˆ·AæŸ¥è¯¢è¯„è®ºåˆ—è¡¨
    â†“
æ£€æŸ¥ä»åº“æ˜¯å¦å·²åŒæ­¥åˆ°è¯¥ç‰ˆæœ¬å·
    â†“
æ˜¯ï¼šä»åº“è¯»å–  å¦ï¼šä¸»åº“è¯»å–
```

### 5.3 è¯»å†™åˆ†ç¦»çš„äº‹åŠ¡è¾¹ç•Œæ§åˆ¶


**äº‹åŠ¡ä¸€è‡´æ€§ä¿éšœ**ï¼š

```java
@Transactional
public class OrderService {
    
    @WriteOnMaster  // å¼ºåˆ¶ä¸»åº“æ‰§è¡Œ
    public void createOrder(Order order) {
        // åˆ›å»ºè®¢å•ï¼ˆå†™æ“ä½œï¼‰
        orderDao.insert(order);
        
        // å‡å°‘åº“å­˜ï¼ˆå†™æ“ä½œï¼‰
        inventoryDao.decrease(order.getProductId(), order.getQuantity());
    }
    
    @ReadFromMaster  // è®¢å•åˆ›å»ºåç«‹å³æŸ¥è¯¢ï¼Œéœ€è¦ä»ä¸»åº“è¯»
    public Order getOrderImmediately(Long orderId) {
        return orderDao.findById(orderId);
    }
    
    @ReadFromSlave   // ä¸€èˆ¬æŸ¥è¯¢å¯ä»¥ä»ä»åº“è¯»
    public List<Order> getOrderHistory(Long userId) {
        return orderDao.findByUserId(userId);
    }
}
```

---

## 6. ğŸ¯ ä¸šåŠ¡åœºæ™¯é€‚é…æ–¹æ¡ˆ


### 6.1 ç”µå•†ä¸šåŠ¡åœºæ™¯


#### å•†å“æµè§ˆï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰


```
åœºæ™¯ï¼šç”¨æˆ·æµè§ˆå•†å“åˆ—è¡¨
ä¸€è‡´æ€§è¦æ±‚ï¼šä½
å¤„ç†ç­–ç•¥ï¼š
- å•†å“ä¿¡æ¯ä»ä»åº“è¯»å–
- å…è®¸çŸ­æ—¶é—´å†…çœ‹åˆ°æ—§çš„ä»·æ ¼/åº“å­˜
- é€šè¿‡ç¼“å­˜è¿›ä¸€æ­¥æå‡æ€§èƒ½
```

#### ä¸‹å•æ”¯ä»˜ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰


```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•å¹¶æ”¯ä»˜
ä¸€è‡´æ€§è¦æ±‚ï¼šé«˜
å¤„ç†ç­–ç•¥ï¼š
- åº“å­˜æ£€æŸ¥å¿…é¡»ä»ä¸»åº“è¯»å–
- è®¢å•åˆ›å»ºå¿…é¡»åœ¨ä¸»åº“æ‰§è¡Œ
- æ”¯ä»˜å®Œæˆåçš„è®¢å•çŠ¶æ€æŸ¥è¯¢ä»ä¸»åº“è¯»å–
```

### 6.2 ç¤¾äº¤åª’ä½“åœºæ™¯


#### å†…å®¹å‘å¸ƒä¸å±•ç¤º


```python
# ç¤¾äº¤åª’ä½“ä¸€è‡´æ€§ç­–ç•¥
class SocialMediaService:
    
    def publish_post(self, user_id, content):
        # å‘å¸ƒå†…å®¹åˆ°ä¸»åº“
        post_id = master_db.insert_post(user_id, content)
        
        # è®°å½•ç”¨æˆ·çš„å†™æ“ä½œ
        cache.set(f"user_last_write:{user_id}", time.now(), 300)  # 5åˆ†é’Ÿ
        
        return post_id
    
    def get_user_timeline(self, user_id, viewer_id):
        # å¦‚æœæ˜¯æŸ¥çœ‹è‡ªå·±çš„æ—¶é—´çº¿ï¼Œä¸”åˆšå‘è¿‡å†…å®¹
        if user_id == viewer_id:
            last_write = cache.get(f"user_last_write:{user_id}")
            if last_write and (time.now() - last_write < 60):  # 1åˆ†é’Ÿå†…
                return master_db.get_timeline(user_id)
        
        # å…¶ä»–æƒ…å†µä»ä»åº“è¯»å–
        return slave_db.get_timeline(user_id)
```

### 6.3 åœ¨çº¿æ•™è‚²åœºæ™¯


#### å­¦ä¹ è¿›åº¦è·Ÿè¸ª


```
åœºæ™¯åˆ†æï¼š
- å­¦ä¹ è¿›åº¦æ›´æ–°ï¼šéœ€è¦ç«‹å³åæ˜ ï¼Œé¿å…é‡å¤å­¦ä¹ 
- æˆç»©æŸ¥è¯¢ï¼šå…è®¸çŸ­æš‚å»¶è¿Ÿ
- è¯ä¹¦ç”Ÿæˆï¼šå¿…é¡»åŸºäºæœ€æ–°æ•°æ®

ç­–ç•¥ï¼š
1. è¿›åº¦æ›´æ–°åï¼ŒçŸ­æ—¶é—´å†…ä»ä¸»åº“è¯»å–è¿›åº¦
2. å†å²æˆç»©æŸ¥è¯¢å¯ä»¥ä»ä»åº“è¯»å–  
3. è¯ä¹¦ç”Ÿæˆå‰å¼ºåˆ¶ä»ä¸»åº“ç¡®è®¤æ‰€æœ‰æ•°æ®
```

---

## 7. ğŸ“Š ä¸€è‡´æ€§ç›‘æ§ä¸è¿ç»´


### 7.1 ä¸€è‡´æ€§ç›‘æ§æŒ‡æ ‡


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

```
å»¶è¿Ÿç›‘æ§ï¼š
- ä¸»ä»å»¶è¿Ÿæ—¶é—´ï¼ˆSeconds_Behind_Masterï¼‰
- ç½‘ç»œå»¶è¿Ÿç›‘æ§
- SQLæ‰§è¡Œæ—¶é—´ç›‘æ§

ä¸€è‡´æ€§ç›‘æ§ï¼š
- æ•°æ®æ ¡éªŒå·®å¼‚ç‡
- ä¸€è‡´æ€§è¿åæ¬¡æ•°
- ç”¨æˆ·æŠ•è¯‰ç‡ï¼ˆå› æ•°æ®ä¸ä¸€è‡´ï¼‰

æ€§èƒ½ç›‘æ§ï¼š
- ä¸»åº“QPS/TPS
- ä»åº“QPSåˆ†å¸ƒ
- å“åº”æ—¶é—´åˆ†å¸ƒ
```

### 7.2 è‡ªåŠ¨åŒ–å·¡æ£€ç­–ç•¥


```python
# ä¸€è‡´æ€§è‡ªåŠ¨å·¡æ£€
class ConsistencyChecker:
    
    def daily_consistency_check(self):
        """æ¯æ—¥ä¸€è‡´æ€§å·¡æ£€"""
        
        # 1. æ£€æŸ¥å…³é”®ä¸šåŠ¡è¡¨çš„æ•°æ®ä¸€è‡´æ€§
        critical_tables = ['orders', 'users', 'payments']
        for table in critical_tables:
            self.verify_table_consistency(table)
        
        # 2. æ£€æŸ¥ä¸»ä»å»¶è¿Ÿè¶‹åŠ¿
        delay_trend = self.get_delay_trend(hours=24)
        if delay_trend.avg > DELAY_THRESHOLD:
            self.send_alert(f"å¹³å‡å»¶è¿Ÿè¶…æ ‡: {delay_trend.avg}s")
        
        # 3. æ£€æŸ¥ä¸€è‡´æ€§ç­–ç•¥æ•ˆæœ
        consistency_violations = self.count_consistency_violations()
        if consistency_violations > VIOLATION_THRESHOLD:
            self.send_alert(f"ä¸€è‡´æ€§è¿åæ¬¡æ•°: {consistency_violations}")
    
    def verify_table_consistency(self, table_name):
        """éªŒè¯è¡¨æ•°æ®ä¸€è‡´æ€§"""
        master_checksum = self.calculate_checksum(master_db, table_name)
        slave_checksum = self.calculate_checksum(slave_db, table_name)
        
        if master_checksum != slave_checksum:
            self.log_inconsistency(table_name, master_checksum, slave_checksum)
            return False
        return True
```

### 7.3 ä¸€è‡´æ€§å†²çªè§£å†³ç­–ç•¥


**æ™ºèƒ½å†²çªè§£å†³**ï¼š

```
å†²çªæ£€æµ‹ï¼š
1. å®šæœŸå¯¹æ¯”ä¸»ä»åº“å…³é”®æ•°æ®
2. å‘ç°ä¸ä¸€è‡´æ—¶è®°å½•è¯¦ç»†ä¿¡æ¯
3. åˆ†æä¸ä¸€è‡´çš„åŸå› å’Œå½±å“èŒƒå›´

è§£å†³ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ•°æ®å†²çª      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å½±å“è¯„ä¼°
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½±å“èŒƒå›´å¤§ï¼Ÿ     â”‚ â”€â”€Yesâ”€â”€â†’ ç«‹å³ä¿®å¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ No
    è®¡åˆ’ä¿®å¤æ—¶é—´
         â†“
    è‡ªåŠ¨ä¿®å¤æ‰§è¡Œ
```

---

## 8. ğŸš€ é«˜çº§ä¸€è‡´æ€§ä¿éšœæŠ€æœ¯


### 8.1 åˆ†å¸ƒå¼é”æœºåˆ¶


**åº”ç”¨åœºæ™¯**ï¼šé˜²æ­¢å¹¶å‘æ›´æ–°å¯¼è‡´çš„ä¸ä¸€è‡´

```java
// åŸºäºRedisçš„åˆ†å¸ƒå¼é”
public class DistributedLockService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public boolean acquireLock(String lockKey, int expireTime) {
        String result = redisTemplate.execute((RedisCallback<String>) connection -> {
            byte[] key = lockKey.getBytes();
            byte[] value = UUID.randomUUID().toString().getBytes();
            
            // SET key value NX EX expireTime
            return connection.set(key, value, 
                Expiration.seconds(expireTime), 
                RedisStringCommands.SetOption.SET_IF_ABSENT);
        });
        
        return "OK".equals(result);
    }
    
    // åœ¨éœ€è¦å¼ºä¸€è‡´æ€§çš„æ“ä½œä¸­ä½¿ç”¨
    @Transactional
    public void updateInventory(Long productId, Integer quantity) {
        String lockKey = "inventory_lock:" + productId;
        
        if (acquireLock(lockKey, 30)) {  // 30ç§’é”å®šæ—¶é—´
            try {
                // å¼ºåˆ¶ä»ä¸»åº“è¯»å–å½“å‰åº“å­˜
                Integer currentStock = masterDao.getStock(productId);
                
                if (currentStock >= quantity) {
                    // æ›´æ–°åº“å­˜
                    masterDao.updateStock(productId, currentStock - quantity);
                } else {
                    throw new InsufficientStockException();
                }
            } finally {
                releaseLock(lockKey);
            }
        } else {
            throw new SystemBusyException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

### 8.2 ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨


**è¯»å†™åˆ†ç¦»ä¸­çš„ä¸€è‡´æ€§å“ˆå¸Œ**ï¼š

```python
class ConsistentHashRouter:
    """åŸºäºä¸€è‡´æ€§å“ˆå¸Œçš„è¯»å†™è·¯ç”±"""
    
    def __init__(self):
        self.hash_ring = {}
        self.sorted_keys = []
        
    def add_slave(self, slave_id, slave_info):
        """æ·»åŠ ä»åº“èŠ‚ç‚¹"""
        for i in range(3):  # æ¯ä¸ªèŠ‚ç‚¹åˆ›å»º3ä¸ªè™šæ‹ŸèŠ‚ç‚¹
            key = self.hash_function(f"{slave_id}_{i}")
            self.hash_ring[key] = slave_info
        
        self.sorted_keys = sorted(self.hash_ring.keys())
    
    def route_read_request(self, user_id):
        """æ ¹æ®ç”¨æˆ·IDè·¯ç”±è¯»è¯·æ±‚"""
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºä¸€è‡´æ€§
        if self.need_strong_consistency(user_id):
            return self.master_db
        
        # ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©ä»åº“
        user_hash = self.hash_function(str(user_id))
        for key in self.sorted_keys:
            if user_hash <= key:
                return self.hash_ring[key]
        
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        return self.hash_ring[self.sorted_keys[0]]
```

### 8.3 å¹‚ç­‰æ€§è®¾è®¡


**æ¥å£å¹‚ç­‰æ€§ä¿éšœ**ï¼š

```java
@Service
public class IdempotentService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * å¹‚ç­‰æ€§æ”¯ä»˜æ¥å£
     */
    public PaymentResult processPayment(PaymentRequest request) {
        String idempotentKey = "payment:" + request.getOrderId() + ":" + request.getAmount();
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        String existingResult = redisTemplate.opsForValue().get(idempotentKey);
        if (existingResult != null) {
            return JSON.parseObject(existingResult, PaymentResult.class);
        }
        
        // åŠ é”é˜²æ­¢å¹¶å‘å¤„ç†
        String lockKey = "payment_lock:" + request.getOrderId();
        if (acquireDistributedLock(lockKey, 60)) {
            try {
                // å†æ¬¡æ£€æŸ¥ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
                existingResult = redisTemplate.opsForValue().get(idempotentKey);
                if (existingResult != null) {
                    return JSON.parseObject(existingResult, PaymentResult.class);
                }
                
                // æ‰§è¡Œå®é™…çš„æ”¯ä»˜é€»è¾‘
                PaymentResult result = doPayment(request);
                
                // ä¿å­˜ç»“æœï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
                redisTemplate.opsForValue().set(idempotentKey, 
                    JSON.toJSONString(result), 24, TimeUnit.HOURS);
                
                return result;
                
            } finally {
                releaseDistributedLock(lockKey);
            }
        } else {
            throw new SystemBusyException("ç³»ç»Ÿç¹å¿™");
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šé€šè¿‡åˆ†ç¦»è¯»å†™æ“ä½œæå‡æ€§èƒ½ï¼Œä½†å¼•å…¥ä¸€è‡´æ€§æŒ‘æˆ˜
ğŸ”¸ ä¸€è‡´æ€§çº§åˆ«ï¼šæœ€ç»ˆä¸€è‡´æ€§ã€å¼ºä¸€è‡´æ€§ã€å•è°ƒè¯»ä¸€è‡´æ€§ç­‰
ğŸ”¸ ä¸»ä»å»¶è¿Ÿï¼šä¸€è‡´æ€§é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œéœ€è¦ç›‘æ§å’Œå¤„ç†
ğŸ”¸ ä¼šè¯ä¸€è‡´æ€§ï¼šåŒä¸€ç”¨æˆ·ä¼šè¯å†…ä¿æŒæ•°æ®ä¸€è‡´æ€§
ğŸ”¸ ä¸šåŠ¡é€‚é…ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§ç­–ç•¥
```

### 9.2 å…³é”®å®ç°ç­–ç•¥


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> ä¸€è‡´æ€§ä¸æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯ä¸šåŠ¡é—®é¢˜ã€‚éœ€è¦åœ¨æ€§èƒ½ã€ä¸€è‡´æ€§ã€å¯ç”¨æ€§ä¹‹é—´æ‰¾åˆ°æœ€é€‚åˆä¸šåŠ¡çš„å¹³è¡¡ç‚¹ã€‚

**ğŸ”¹ ç­–ç•¥é€‰æ‹©åŸåˆ™**ï¼š
```
é‡‘èæ”¯ä»˜ â†’ å¼ºä¸€è‡´æ€§ â†’ æ€§èƒ½ç‰ºç‰²å¯æ¥å—
å†…å®¹å±•ç¤º â†’ æœ€ç»ˆä¸€è‡´æ€§ â†’ æ€§èƒ½ä¼˜å…ˆ
ç”¨æˆ·æ“ä½œ â†’ ä¼šè¯ä¸€è‡´æ€§ â†’ ä½“éªŒå’Œæ€§èƒ½å¹³è¡¡
```

**ğŸ”¹ æŠ€æœ¯å®ç°è¦ç‚¹**ï¼š
```
1. æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®ä¸šåŠ¡ç±»å‹å’Œå»¶è¿Ÿæƒ…å†µåŠ¨æ€è·¯ç”±
2. ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§å»¶è¿Ÿå’Œä¸€è‡´æ€§è¿åæƒ…å†µ
3. é™çº§ç­–ç•¥ï¼šå»¶è¿Ÿè¿‡å¤§æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»åº“
4. å¹‚ç­‰è®¾è®¡ï¼šç¡®ä¿é‡è¯•ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
```

### 9.3 å®è·µå»ºè®®


**ğŸ“Š ç›‘æ§æŒ‡æ ‡**ï¼š
- ä¸»ä»å»¶è¿Ÿæ—¶é—´ï¼ˆç›®æ ‡<100msï¼‰
- ä¸€è‡´æ€§è¿åç‡ï¼ˆç›®æ ‡<0.1%ï¼‰
- ç”¨æˆ·æŠ•è¯‰ç‡ï¼ˆç›®æ ‡<0.01%ï¼‰

**ğŸ”§ è¿ç»´è¦ç‚¹**ï¼š
- å®šæœŸå·¡æ£€æ•°æ®ä¸€è‡´æ€§
- å»ºç«‹è‡ªåŠ¨åŒ–ç›‘æ§å‘Šè­¦
- åˆ¶å®šåº”æ€¥å¤„ç†é¢„æ¡ˆ
- ä¸šåŠ¡æ–¹ä¸€è‡´æ€§SLAçº¦å®š

**ğŸ¯ ä¸šåŠ¡æŒ‡å¯¼**ï¼š
- æ˜ç¡®æ¯ä¸ªæ¥å£çš„ä¸€è‡´æ€§éœ€æ±‚
- è®¾è®¡æ—¶è€ƒè™‘æœ€åæƒ…å†µä¸‹çš„ç”¨æˆ·ä½“éªŒ
- å»ºç«‹é™çº§å’Œè¡¥å¿æœºåˆ¶
- å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–ä¸€è‡´æ€§ç­–ç•¥

> **âš ï¸ é‡è¦æé†’**  
> è¯»å†™åˆ†ç¦»çš„ä¸€è‡´æ€§å¤„ç†æ˜¯ä¸€ä¸ªæŒç»­ä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œéœ€è¦ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯ã€ç”¨æˆ·ä½“éªŒè¦æ±‚å’Œç³»ç»Ÿæ€§èƒ½ç›®æ ‡æ¥ç»¼åˆè€ƒè™‘ã€‚åˆ‡å¿Œä¸ºäº†æŠ€æœ¯è€ŒæŠ€æœ¯ï¼Œè¦å§‹ç»ˆä»¥ä¸šåŠ¡ä»·å€¼ä¸ºå¯¼å‘ã€‚

**ğŸ”‘ æ ¸å¿ƒè®°å¿†**ï¼š
- è¯»å†™åˆ†ç¦»ææ€§èƒ½ï¼Œä¸€è‡´æ€§æ˜¯æ–°æŒ‘æˆ˜
- ä¸šåŠ¡é©±åŠ¨é€‰ç­–ç•¥ï¼Œç›‘æ§è¿ç»´ä¿ç¨³å®š  
- å»¶è¿Ÿè·¯ç”±è¦æ™ºèƒ½ï¼Œé™çº§è¡¥å¿åšä¿éšœ