---
title: 8ã€å¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [å¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°](#1-å¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°)
2. [é…ç½®ç‰ˆæœ¬æ§åˆ¶ä½“ç³»](#2-é…ç½®ç‰ˆæœ¬æ§åˆ¶ä½“ç³»)
3. [é…ç½®å˜æ›´è¿½è¸ªæœºåˆ¶](#3-é…ç½®å˜æ›´è¿½è¸ªæœºåˆ¶)
4. [é…ç½®å›æ»šä¸æ¢å¤](#4-é…ç½®å›æ»šä¸æ¢å¤)
5. [é…ç½®æ¨¡æ¿åŒ–ç®¡ç†](#5-é…ç½®æ¨¡æ¿åŒ–ç®¡ç†)
6. [ç¯å¢ƒé…ç½®éš”ç¦»ç­–ç•¥](#6-ç¯å¢ƒé…ç½®éš”ç¦»ç­–ç•¥)
7. [é…ç½®å®¡è®¡ä¸åˆè§„](#7-é…ç½®å®¡è®¡ä¸åˆè§„)
8. [é…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²](#8-é…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†


**é€šä¿—ç†è§£**ï¼šå°±åƒç»™ä½ çš„ä»£ç ç”¨Gitåšç‰ˆæœ¬æ§åˆ¶ä¸€æ ·ï¼ŒMySQLå¤åˆ¶çš„é…ç½®æ–‡ä»¶ä¹Ÿéœ€è¦åšç‰ˆæœ¬ç®¡ç†ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ä½ çš„æ‰‹æœºç³»ç»Ÿæ›´æ–° = é…ç½®ç‰ˆæœ¬å‡çº§
- æ›´æ–°å‰å¤‡ä»½ = é…ç½®ç‰ˆæœ¬è®°å½•
- æ›´æ–°å¤±è´¥å›æ»š = é…ç½®å›æ»š
- ä¸åŒæœºå‹é…ç½® = ç¯å¢ƒéš”ç¦»
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ”„ **å¯è¿½æº¯**ï¼šçŸ¥é“é…ç½®ä»€ä¹ˆæ—¶å€™æ”¹çš„ã€è°æ”¹çš„
- ğŸ”™ **å¯å›æ»š**ï¼šå‡ºé—®é¢˜èƒ½å¿«é€Ÿæ¢å¤åˆ°ä¸Šä¸€ä¸ªå¥½ç”¨çš„ç‰ˆæœ¬
- ğŸ¯ **æ ‡å‡†åŒ–**ï¼šä¸åŒç¯å¢ƒç”¨ç»Ÿä¸€çš„é…ç½®è§„èŒƒ
- ğŸ›¡ï¸ **é£é™©æ§åˆ¶**ï¼šé…ç½®å˜æ›´ä¸å†æ˜¯"ç¢°è¿æ°”"

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç‰ˆæœ¬ç®¡ç†


**ç—›ç‚¹åœºæ™¯**ï¼š
```
âŒ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
â€¢ é…ç½®æ”¹é”™äº†ï¼Œä¸çŸ¥é“åŸæ¥æ˜¯ä»€ä¹ˆæ ·
â€¢ å¤šä¸ªç¯å¢ƒé…ç½®ä¸ä¸€è‡´ï¼Œé—®é¢˜éš¾å®šä½
â€¢ é…ç½®å˜æ›´æ²¡è®°å½•ï¼Œå‡ºé—®é¢˜æ‰¾ä¸åˆ°æ ¹å› 
â€¢ æ‰‹å·¥é…ç½®å®¹æ˜“å‡ºé”™ï¼Œæ²¡æœ‰æ ‡å‡†æµç¨‹
```

**ç‰ˆæœ¬ç®¡ç†çš„å¥½å¤„**ï¼š
```
âœ… è§£å†³æ–¹æ¡ˆï¼š
â€¢ æ¯æ¬¡é…ç½®å˜æ›´éƒ½æœ‰è®°å½•å’Œç‰ˆæœ¬å·
â€¢ æ ‡å‡†åŒ–çš„é…ç½®æ¨¡æ¿ï¼Œå‡å°‘äººä¸ºé”™è¯¯
â€¢ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œä¿è¯é…ç½®çš„ä¸€è‡´æ€§
â€¢ å®Œæ•´çš„å®¡è®¡è¿½è¸ªï¼Œæ»¡è¶³åˆè§„è¦æ±‚
```

---

## 2. ğŸ—‚ï¸ é…ç½®ç‰ˆæœ¬æ§åˆ¶ä½“ç³»


### 2.1 ç‰ˆæœ¬æ§åˆ¶æ¶æ„è®¾è®¡


**æ•´ä½“æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                é…ç½®ç‰ˆæœ¬æ§åˆ¶ä½“ç³»              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ é…ç½®ä»“åº“å±‚                             â”‚
â”‚  â”œâ”€â”€ Gitä»“åº“ (é…ç½®æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶)              â”‚
â”‚  â”œâ”€â”€ é…ç½®æ¨¡æ¿åº“ (æ ‡å‡†åŒ–æ¨¡æ¿)                â”‚
â”‚  â””â”€â”€ å†å²ç‰ˆæœ¬åº“ (ç‰ˆæœ¬å›æ»šæ”¯æŒ)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ ç®¡ç†å·¥å…·å±‚                             â”‚
â”‚  â”œâ”€â”€ é…ç½®ç”Ÿæˆå™¨ (æ¨¡æ¿+å‚æ•°â†’å…·ä½“é…ç½®)        â”‚
â”‚  â”œâ”€â”€ å˜æ›´è¿½è¸ªå™¨ (è®°å½•æ‰€æœ‰å˜æ›´)              â”‚
â”‚  â””â”€â”€ éƒ¨ç½²å·¥å…· (è‡ªåŠ¨åŒ–é…ç½®åº”ç”¨)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ åº”ç”¨ç¯å¢ƒå±‚                             â”‚
â”‚  â”œâ”€â”€ å¼€å‘ç¯å¢ƒ (dev)                        â”‚
â”‚  â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒ (test)                       â”‚
â”‚  â”œâ”€â”€ é¢„ç”Ÿäº§ç¯å¢ƒ (staging)                  â”‚
â”‚  â””â”€â”€ ç”Ÿäº§ç¯å¢ƒ (prod)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é…ç½®æ–‡ä»¶ç»„ç»‡ç»“æ„


**ç›®å½•ç»“æ„è®¾è®¡**ï¼š
```
mysql-config-repo/
â”œâ”€â”€ templates/                    # é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ master/                  # ä¸»åº“é…ç½®æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ my.cnf.j2           # ä¸»é…ç½®æ–‡ä»¶æ¨¡æ¿
â”‚   â”‚   â””â”€â”€ replica.cnf.j2      # å¤åˆ¶ç›¸å…³é…ç½®
â”‚   â””â”€â”€ slave/                   # ä»åº“é…ç½®æ¨¡æ¿
â”‚       â”œâ”€â”€ my.cnf.j2
â”‚       â””â”€â”€ readonly.cnf.j2
â”œâ”€â”€ environments/                # ç¯å¢ƒç‰¹å®šé…ç½®
â”‚   â”œâ”€â”€ dev/                    # å¼€å‘ç¯å¢ƒ
â”‚   â”‚   â”œâ”€â”€ vars.yml            # ç¯å¢ƒå˜é‡
â”‚   â”‚   â””â”€â”€ hosts.yml           # ä¸»æœºåˆ—è¡¨
â”‚   â”œâ”€â”€ test/                   # æµ‹è¯•ç¯å¢ƒ
â”‚   â”œâ”€â”€ staging/                # é¢„ç”Ÿäº§ç¯å¢ƒ
â”‚   â””â”€â”€ prod/                   # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ generated/                   # ç”Ÿæˆçš„å…·ä½“é…ç½®
â”‚   â”œâ”€â”€ dev/
â”‚   â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ staging/
â”‚   â””â”€â”€ prod/
â”œâ”€â”€ scripts/                    # è‡ªåŠ¨åŒ–è„šæœ¬
â”‚   â”œâ”€â”€ generate-config.py      # é…ç½®ç”Ÿæˆè„šæœ¬
â”‚   â”œâ”€â”€ deploy-config.sh        # é…ç½®éƒ¨ç½²è„šæœ¬
â”‚   â””â”€â”€ rollback-config.sh      # é…ç½®å›æ»šè„šæœ¬
â””â”€â”€ docs/                       # æ–‡æ¡£
    â”œâ”€â”€ README.md
    â””â”€â”€ changelog.md            # å˜æ›´æ—¥å¿—
```

### 2.3 ç‰ˆæœ¬å·è§„èŒƒ


**ç‰ˆæœ¬å·æ ¼å¼**ï¼š`ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬-ç¯å¢ƒæ ‡è¯†`

```
ç‰ˆæœ¬å·ç¤ºä¾‹ï¼š
â€¢ v2.1.3-prod    # ç”Ÿäº§ç¯å¢ƒç¬¬2ä¸ªå¤§ç‰ˆæœ¬ï¼Œç¬¬1ä¸ªåŠŸèƒ½ç‰ˆæœ¬ï¼Œç¬¬3ä¸ªä¿®å¤ç‰ˆæœ¬
â€¢ v2.1.3-dev     # å¯¹åº”çš„å¼€å‘ç¯å¢ƒç‰ˆæœ¬
â€¢ v2.2.0-test    # æµ‹è¯•ç¯å¢ƒçš„æ–°åŠŸèƒ½ç‰ˆæœ¬

ç‰ˆæœ¬å˜æ›´è§„åˆ™ï¼š
ğŸ”´ ä¸»ç‰ˆæœ¬(X.0.0)ï¼šæ¶æ„é‡å¤§å˜æ›´ï¼Œä¸å…¼å®¹çš„é…ç½®è°ƒæ•´
ğŸŸ¡ æ¬¡ç‰ˆæœ¬(X.Y.0)ï¼šæ–°å¢åŠŸèƒ½é…ç½®ï¼Œå‘ä¸‹å…¼å®¹
ğŸŸ¢ ä¿®è®¢ç‰ˆæœ¬(X.Y.Z)ï¼šBugä¿®å¤ï¼Œå‚æ•°è°ƒä¼˜
```

---

## 3. ğŸ“ é…ç½®å˜æ›´è¿½è¸ªæœºåˆ¶


### 3.1 å˜æ›´è®°å½•æ ‡å‡†


**å˜æ›´ä¿¡æ¯æ¨¡æ¿**ï¼š
```yaml
# é…ç½®å˜æ›´è®°å½•
change_id: "CHG-2025-001"
timestamp: "2025-09-07T15:30:00Z"
author: "db_admin"
approver: "db_manager"
environment: "prod"
version: "v2.1.3-prod"

# å˜æ›´è¯¦æƒ…
change_type: "parameter_tuning"    # å˜æ›´ç±»å‹
description: "ä¼˜åŒ–innodb_buffer_pool_sizeå‚æ•°"
business_reason: "æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œæ”¯æŒåŒåä¸€æµé‡"

# å—å½±å“çš„é…ç½®é¡¹
changed_configs:
  - parameter: "innodb_buffer_pool_size"
    old_value: "16G"
    new_value: "24G"
    reason: "å†…å­˜å‡çº§åçš„ä¼˜åŒ–è°ƒæ•´"
  
# é£é™©è¯„ä¼°
risk_level: "medium"              # é£é™©ç­‰çº§ï¼šlow/medium/high
rollback_plan: "æ¢å¤åˆ°v2.1.2-prodç‰ˆæœ¬"
validation_plan: "ç›‘æ§30åˆ†é’Ÿå†…å­˜ä½¿ç”¨ç‡å’ŒæŸ¥è¯¢æ€§èƒ½"
```

### 3.2 è‡ªåŠ¨åŒ–å˜æ›´è¿½è¸ª


**Git Hooké›†æˆ**ï¼š
```bash
#!/bin/bash
# pre-commit hookï¼šæäº¤å‰æ£€æŸ¥

# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•..."
for file in $(git diff --cached --name-only | grep "\.cnf$\|\.yml$"); do
    if [[ $file == *.cnf ]]; then
        # æ£€æŸ¥MySQLé…ç½®è¯­æ³•
        mysqld --help --verbose --defaults-file=$file > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "âŒ é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯: $file"
            exit 1
        fi
    fi
done

# è‡ªåŠ¨ç”Ÿæˆå˜æ›´è®°å½•
echo "ğŸ“ ç”Ÿæˆå˜æ›´è®°å½•..."
python scripts/generate_changelog.py

echo "âœ… é…ç½®æ£€æŸ¥é€šè¿‡"
```

**å˜æ›´è‡ªåŠ¨è®°å½•è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
import os
import git
import yaml
from datetime import datetime

def generate_changelog():
    """è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿—"""
    repo = git.Repo('.')
    
    # è·å–æœ€æ–°æäº¤ä¿¡æ¯
    latest_commit = repo.head.commit
    
    # åˆ†æé…ç½®æ–‡ä»¶å˜æ›´
    changed_files = []
    for item in latest_commit.diff('HEAD~1'):
        if item.a_path and (item.a_path.endswith('.cnf') or item.a_path.endswith('.yml')):
            changed_files.append(item.a_path)
    
    # ç”Ÿæˆå˜æ›´è®°å½•
    change_record = {
        'timestamp': datetime.now().isoformat(),
        'commit_hash': str(latest_commit),
        'author': str(latest_commit.author),
        'message': latest_commit.message.strip(),
        'changed_files': changed_files,
        'file_count': len(changed_files)
    }
    
    # ä¿å­˜åˆ°å˜æ›´æ—¥å¿—
    with open('changelog.yml', 'a') as f:
        yaml.dump([change_record], f, default_flow_style=False)
    
    print(f"âœ… å˜æ›´è®°å½•å·²ç”Ÿæˆï¼Œå½±å“æ–‡ä»¶æ•°ï¼š{len(changed_files)}")

if __name__ == "__main__":
    generate_changelog()
```

---

## 4. ğŸ”„ é…ç½®å›æ»šä¸æ¢å¤


### 4.1 å›æ»šç­–ç•¥è®¾è®¡


**åˆ†å±‚å›æ»šæœºåˆ¶**ï¼š
```
å›æ»šçº§åˆ«ï¼š
ğŸ”´ ç´§æ€¥å›æ»š (Emergency)ï¼šç«‹å³æ¢å¤åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
ğŸŸ¡ è®¡åˆ’å›æ»š (Planned)ï¼šæŒ‰æ­¥éª¤å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬  
ğŸŸ¢ éƒ¨åˆ†å›æ»š (Partial)ï¼šåªå›æ»šç‰¹å®šé…ç½®é¡¹

å›æ»šæ—¶é—´çª—å£ï¼š
â€¢ 5åˆ†é’Ÿå†…ï¼šè‡ªåŠ¨å›æ»šï¼ˆæ£€æµ‹åˆ°ä¸¥é‡é—®é¢˜ï¼‰
â€¢ 30åˆ†é’Ÿå†…ï¼šå¿«é€Ÿäººå·¥å›æ»š
â€¢ 1å°æ—¶å†…ï¼šæ ‡å‡†å›æ»šæµç¨‹
â€¢ è¶…è¿‡1å°æ—¶ï¼šéœ€è¦å®¡æ‰¹çš„å›æ»š
```

### 4.2 å›æ»šå®ç°è„šæœ¬


**ä¸€é”®å›æ»šè„šæœ¬**ï¼š
```bash
#!/bin/bash
# é…ç½®å›æ»šè„šæœ¬

SCRIPT_DIR=$(dirname "$0")
source $SCRIPT_DIR/common.sh

# å‡½æ•°ï¼šæ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬
show_versions() {
    echo "ğŸ“‹ å¯ç”¨çš„é…ç½®ç‰ˆæœ¬ï¼š"
    git tag --sort=-version:refname | head -10 | while read tag; do
        commit_date=$(git log -1 --format="%ai" $tag)
        commit_msg=$(git log -1 --format="%s" $tag)
        echo "  $tag - $commit_date - $commit_msg"
    done
}

# å‡½æ•°ï¼šå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
rollback_to_version() {
    local target_version=$1
    local environment=$2
    
    echo "ğŸ”„ å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬: $target_version"
    
    # 1. å¤‡ä»½å½“å‰é…ç½®
    backup_current_config $environment
    
    # 2. åˆ‡æ¢åˆ°ç›®æ ‡ç‰ˆæœ¬
    git checkout $target_version
    
    # 3. é‡æ–°ç”Ÿæˆé…ç½®
    python scripts/generate-config.py --env $environment
    
    # 4. éªŒè¯é…ç½®
    if validate_config $environment; then
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
    else
        echo "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œåœæ­¢å›æ»š"
        return 1
    fi
    
    # 5. éƒ¨ç½²é…ç½®
    deploy_config $environment
    
    # 6. éªŒè¯MySQLæœåŠ¡
    if verify_mysql_service $environment; then
        echo "âœ… MySQLæœåŠ¡æ­£å¸¸ï¼Œå›æ»šæˆåŠŸ"
        log_rollback_success $target_version $environment
    else
        echo "âŒ MySQLæœåŠ¡å¼‚å¸¸ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
        return 1
    fi
}

# ä¸»é€»è¾‘
main() {
    case $1 in
        "list")
            show_versions
            ;;
        "rollback")
            if [ -z "$2" ] || [ -z "$3" ]; then
                echo "ç”¨æ³•: $0 rollback <ç‰ˆæœ¬å·> <ç¯å¢ƒ>"
                echo "ä¾‹å¦‚: $0 rollback v2.1.2-prod prod"
                exit 1
            fi
            rollback_to_version $2 $3
            ;;
        *)
            echo "ç”¨æ³•:"
            echo "  $0 list                    # æ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬"
            echo "  $0 rollback <ç‰ˆæœ¬> <ç¯å¢ƒ>   # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬"
            ;;
    esac
}

main "$@"
```

### 4.3 å›æ»šéªŒè¯æœºåˆ¶


**è‡ªåŠ¨éªŒè¯æµç¨‹**ï¼š
```python
def verify_rollback_success(environment, target_version):
    """éªŒè¯å›æ»šæ˜¯å¦æˆåŠŸ"""
    
    checks = []
    
    # 1. é…ç½®æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥
    config_check = verify_config_consistency(environment, target_version)
    checks.append(("é…ç½®ä¸€è‡´æ€§", config_check))
    
    # 2. MySQLæœåŠ¡çŠ¶æ€æ£€æŸ¥
    service_check = verify_mysql_service_status(environment)
    checks.append(("MySQLæœåŠ¡", service_check))
    
    # 3. å¤åˆ¶çŠ¶æ€æ£€æŸ¥
    replication_check = verify_replication_status(environment)
    checks.append(("å¤åˆ¶çŠ¶æ€", replication_check))
    
    # 4. åŸºç¡€åŠŸèƒ½æ£€æŸ¥
    basic_check = verify_basic_operations(environment)
    checks.append(("åŸºç¡€åŠŸèƒ½", basic_check))
    
    # æ±‡æ€»æ£€æŸ¥ç»“æœ
    all_passed = all(check[1] for check in checks)
    
    # ç”ŸæˆéªŒè¯æŠ¥å‘Š
    report = generate_verification_report(checks, target_version)
    
    return all_passed, report

def verify_config_consistency(environment, target_version):
    """æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦ä¸ç›®æ ‡ç‰ˆæœ¬ä¸€è‡´"""
    try:
        # è¯»å–ç›®æ ‡ç‰ˆæœ¬çš„é…ç½®æ–‡ä»¶Hash
        target_config_hash = get_config_hash(target_version, environment)
        
        # è¯»å–å½“å‰è¿è¡Œçš„é…ç½®Hash
        current_config_hash = get_current_config_hash(environment)
        
        return target_config_hash == current_config_hash
    except Exception as e:
        logger.error(f"é…ç½®ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥: {e}")
        return False
```

---

## 5. ğŸ“‹ é…ç½®æ¨¡æ¿åŒ–ç®¡ç†


### 5.1 é…ç½®æ¨¡æ¿è®¾è®¡åŸåˆ™


**æ¨¡æ¿åŒ–çš„å¥½å¤„**ï¼š
```
ğŸ¯ æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„é…ç½®ç»“æ„å’Œå‚æ•°è§„èŒƒ
ğŸ”§ å‚æ•°åŒ–ï¼šé€šè¿‡å˜é‡æ§åˆ¶ä¸åŒç¯å¢ƒçš„å·®å¼‚
ğŸ”„ å¤ç”¨æ€§ï¼šä¸€å¥—æ¨¡æ¿é€‚ç”¨äºå¤šä¸ªç¯å¢ƒ
ğŸ›¡ï¸ å‡å°‘é”™è¯¯ï¼šæ¨¡æ¿ç»è¿‡éªŒè¯ï¼Œé™ä½é…ç½®é”™è¯¯
```

### 5.2 Jinja2æ¨¡æ¿ç¤ºä¾‹


**ä¸»åº“é…ç½®æ¨¡æ¿** (`templates/master/my.cnf.j2`)ï¼š
```ini
[mysqld]
# åŸºç¡€é…ç½®
server-id = {{ server_id }}
port = {{ mysql_port | default(3306) }}
datadir = {{ data_dir | default('/var/lib/mysql') }}
socket = {{ socket_path | default('/var/lib/mysql/mysql.sock') }}

# å†…å­˜é…ç½® - æ ¹æ®ç¯å¢ƒåŠ¨æ€è°ƒæ•´
innodb_buffer_pool_size = {{ innodb_buffer_pool_size }}
innodb_buffer_pool_instances = {{ buffer_pool_instances | default(8) }}
key_buffer_size = {{ key_buffer_size | default('256M') }}

# æ—¥å¿—é…ç½®
log-bin = {{ log_bin_basename | default('mysql-bin') }}
binlog_format = {{ binlog_format | default('ROW') }}
sync_binlog = {{ sync_binlog | default(1) }}
innodb_flush_log_at_trx_commit = {{ flush_log_at_commit | default(1) }}

# å¤åˆ¶é…ç½®
{% if replication_role == 'master' %}
# ä¸»åº“ç‰¹å®šé…ç½®
gtid-mode = ON
enforce-gtid-consistency = true
log-slave-updates = true
binlog_expire_logs_seconds = {{ binlog_retention_seconds | default(604800) }}
{% endif %}

# æ€§èƒ½é…ç½® - æ ¹æ®ç¯å¢ƒè´Ÿè½½è°ƒæ•´
max_connections = {{ max_connections }}
innodb_thread_concurrency = {{ thread_concurrency | default(0) }}
table_open_cache = {{ table_open_cache | default(4000) }}

# ç¯å¢ƒç‰¹å®šé…ç½®
{% if environment == 'prod' %}
# ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼çš„æŒä¹…åŒ–é…ç½®
innodb_doublewrite = ON
innodb_checksums = ON
{% elif environment == 'dev' %}
# å¼€å‘ç¯å¢ƒï¼šæ€§èƒ½ä¼˜å…ˆé…ç½®
innodb_doublewrite = OFF
innodb_flush_log_at_trx_commit = 2
{% endif %}

# è‡ªå®šä¹‰é…ç½®æ®µ
{% if custom_configs %}
# ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
{% for config in custom_configs %}
{{ config.parameter }} = {{ config.value }}
{% endfor %}
{% endif %}
```

### 5.3 ç¯å¢ƒå˜é‡é…ç½®


**ç”Ÿäº§ç¯å¢ƒå˜é‡** (`environments/prod/vars.yml`)ï¼š
```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®å˜é‡
environment: "prod"
replication_role: "master"

# æœåŠ¡å™¨åŸºç¡€é…ç½®
server_id: 1001
mysql_port: 3306
data_dir: "/data/mysql"
socket_path: "/data/mysql/mysql.sock"

# å†…å­˜é…ç½® (æ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´)
innodb_buffer_pool_size: "32G"        # æœåŠ¡å™¨å†…å­˜çš„70-80%
buffer_pool_instances: 16
key_buffer_size: "512M"

# è¿æ¥é…ç½®
max_connections: 2000                  # ç”Ÿäº§ç¯å¢ƒé«˜å¹¶å‘

# æ—¥å¿—é…ç½®
log_bin_basename: "mysql-bin"
binlog_format: "ROW"
sync_binlog: 1
flush_log_at_commit: 1
binlog_retention_seconds: 604800       # 7å¤©

# æ€§èƒ½è°ƒä¼˜
thread_concurrency: 32
table_open_cache: 8000
innodb_io_capacity: 2000
innodb_io_capacity_max: 4000

# è‡ªå®šä¹‰é…ç½®
custom_configs:
  - parameter: "slow_query_log"
    value: "ON"
  - parameter: "long_query_time"
    value: "1"
  - parameter: "log_queries_not_using_indexes"
    value: "ON"
```

**å¼€å‘ç¯å¢ƒå˜é‡** (`environments/dev/vars.yml`)ï¼š
```yaml
# å¼€å‘ç¯å¢ƒé…ç½®å˜é‡
environment: "dev"
replication_role: "master"

# æœåŠ¡å™¨åŸºç¡€é…ç½® (å¼€å‘ç¯å¢ƒèµ„æºæœ‰é™)
server_id: 2001
mysql_port: 3306
data_dir: "/var/lib/mysql"

# å†…å­˜é…ç½® (å¼€å‘ç¯å¢ƒè¾ƒå°)
innodb_buffer_pool_size: "2G"
buffer_pool_instances: 4
key_buffer_size: "128M"

# è¿æ¥é…ç½® (å¼€å‘ç¯å¢ƒå¹¶å‘è¾ƒä½)
max_connections: 200

# æ—¥å¿—é…ç½® (å¼€å‘ç¯å¢ƒå¯ä»¥æ”¾æ¾æŒä¹…åŒ–è¦æ±‚)
binlog_format: "ROW"
sync_binlog: 0                         # æ€§èƒ½ä¼˜å…ˆ
flush_log_at_commit: 2                 # æ€§èƒ½ä¼˜å…ˆ
binlog_retention_seconds: 259200       # 3å¤©

# æ€§èƒ½è°ƒä¼˜ (é€‚åˆå¼€å‘æµ‹è¯•)
thread_concurrency: 8
table_open_cache: 2000

# å¼€å‘ç¯å¢ƒç‰¹å®šé…ç½®
custom_configs:
  - parameter: "general_log"
    value: "ON"                        # å¼€å‘ç¯å¢ƒå¼€å¯æŸ¥è¯¢æ—¥å¿—
  - parameter: "general_log_file"
    value: "/var/log/mysql/general.log"
```

---

## 6. ğŸ—ï¸ ç¯å¢ƒé…ç½®éš”ç¦»ç­–ç•¥


### 6.1 ç¯å¢ƒéš”ç¦»æ¶æ„


**å¤šç¯å¢ƒéš”ç¦»æ¨¡å‹**ï¼š
```
ğŸ“Š ç¯å¢ƒéš”ç¦»å±‚æ¬¡ï¼š

ç‰©ç†éš”ç¦»å±‚ï¼š
â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒ (prod)     # ç‹¬ç«‹ç‰©ç†æœåŠ¡å™¨/äº‘å®ä¾‹
â”œâ”€â”€ é¢„ç”Ÿäº§ç¯å¢ƒ (staging) # æ¨¡æ‹Ÿç”Ÿäº§çš„ç‹¬ç«‹ç¯å¢ƒ  
â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒ (test)     # åŠŸèƒ½æµ‹è¯•ä¸“ç”¨ç¯å¢ƒ
â””â”€â”€ å¼€å‘ç¯å¢ƒ (dev)      # å¼€å‘è°ƒè¯•ç¯å¢ƒ

é…ç½®éš”ç¦»å±‚ï¼š
â”œâ”€â”€ ç½‘ç»œé…ç½®éš”ç¦»       # ä¸åŒç½‘æ®µã€é˜²ç«å¢™è§„åˆ™
â”œâ”€â”€ å­˜å‚¨é…ç½®éš”ç¦»       # ç‹¬ç«‹çš„æ•°æ®ç›®å½•å’Œå¤‡ä»½
â”œâ”€â”€ å‚æ•°é…ç½®éš”ç¦»       # é’ˆå¯¹ç¯å¢ƒä¼˜åŒ–çš„å‚æ•°
â””â”€â”€ å®‰å…¨é…ç½®éš”ç¦»       # ä¸åŒçš„ç”¨æˆ·æƒé™å’Œå¯†ç 

æ•°æ®éš”ç¦»å±‚ï¼š
â”œâ”€â”€ æ•°æ®åº“å®ä¾‹éš”ç¦»     # å®Œå…¨ç‹¬ç«‹çš„MySQLå®ä¾‹
â”œâ”€â”€ æ•°æ®å†…å®¹éš”ç¦»       # è„±æ•çš„æµ‹è¯•æ•°æ®
â”œâ”€â”€ å¤‡ä»½ç­–ç•¥éš”ç¦»       # ä¸åŒçš„å¤‡ä»½é¢‘ç‡å’Œä¿ç•™æœŸ
â””â”€â”€ ç›‘æ§æŒ‡æ ‡éš”ç¦»       # ç‹¬ç«‹çš„ç›‘æ§å’ŒæŠ¥è­¦
```

### 6.2 ç¯å¢ƒé…ç½®å·®å¼‚ç®¡ç†


**é…ç½®å·®å¼‚å¯¹æ¯”è¡¨**ï¼š

| é…ç½®é¡¹ | å¼€å‘ç¯å¢ƒ | æµ‹è¯•ç¯å¢ƒ | é¢„ç”Ÿäº§ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|--------|----------|----------|------------|----------|
| ğŸ–¥ï¸ **ç¡¬ä»¶è§„æ ¼** | 2C4G | 4C8G | 8C16G | 16C64G |
| ğŸ’¾ **Buffer Pool** | 2G | 4G | 8G | 32G |
| ğŸ”— **æœ€å¤§è¿æ¥æ•°** | 200 | 500 | 1000 | 2000 |
| ğŸ“ **æ—¥å¿—çº§åˆ«** | DEBUG | INFO | WARN | ERROR |
| ğŸ’¾ **Binlogä¿ç•™** | 3å¤© | 5å¤© | 7å¤© | 7å¤© |
| ğŸ”„ **Sync Binlog** | 0 | 1 | 1 | 1 |
| ğŸ›¡ï¸ **SSL** | å…³é—­ | å¼€å¯ | å¼€å¯ | å¼€å¯ |
| ğŸ“Š **ç›‘æ§é¢‘ç‡** | 5åˆ†é’Ÿ | 2åˆ†é’Ÿ | 1åˆ†é’Ÿ | 30ç§’ |

### 6.3 ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥


**é…ç½®ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
import yaml
import sys
from deepdiff import DeepDiff

def check_environment_consistency():
    """æ£€æŸ¥ç¯å¢ƒé—´é…ç½®çš„ä¸€è‡´æ€§"""
    
    environments = ['dev', 'test', 'staging', 'prod']
    
    # éœ€è¦ä¿æŒä¸€è‡´çš„é…ç½®é¡¹
    consistent_items = [
        'replication_role',
        'binlog_format', 
        'gtid_mode',
        'enforce_gtid_consistency'
    ]
    
    # å…è®¸ä¸åŒçš„é…ç½®é¡¹
    allowed_differences = [
        'server_id',
        'innodb_buffer_pool_size',
        'max_connections',
        'sync_binlog',
        'binlog_retention_seconds'
    ]
    
    configs = {}
    
    # åŠ è½½æ‰€æœ‰ç¯å¢ƒé…ç½®
    for env in environments:
        with open(f'environments/{env}/vars.yml', 'r') as f:
            configs[env] = yaml.safe_load(f)
    
    print("ğŸ” ç¯å¢ƒé…ç½®ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š")
    print("=" * 50)
    
    # æ£€æŸ¥å¿…é¡»ä¸€è‡´çš„é…ç½®é¡¹
    print("\nâœ… å¿…é¡»ä¿æŒä¸€è‡´çš„é…ç½®é¡¹æ£€æŸ¥ï¼š")
    for item in consistent_items:
        values = {env: configs[env].get(item) for env in environments}
        unique_values = set(values.values())
        
        if len(unique_values) == 1:
            print(f"  {item}: âœ… ä¸€è‡´ (å€¼: {list(unique_values)[0]})")
        else:
            print(f"  {item}: âŒ ä¸ä¸€è‡´")
            for env, value in values.items():
                print(f"    {env}: {value}")
    
    # æ£€æŸ¥å…è®¸ä¸åŒçš„é…ç½®é¡¹
    print(f"\nğŸ“Š å…è®¸å·®å¼‚çš„é…ç½®é¡¹å¯¹æ¯”ï¼š")
    for item in allowed_differences:
        values = {env: configs[env].get(item) for env in environments}
        print(f"  {item}:")
        for env, value in values.items():
            print(f"    {env}: {value}")
    
    # æ£€æŸ¥æœªé¢„æœŸçš„å·®å¼‚
    print(f"\nâš ï¸  å…¶ä»–é…ç½®å·®å¼‚æ£€æŸ¥ï¼š")
    base_config = configs['prod']
    for env in ['dev', 'test', 'staging']:
        diff = DeepDiff(base_config, configs[env], ignore_order=True)
        if diff:
            print(f"  {env} vs prod:")
            for change_type, changes in diff.items():
                print(f"    {change_type}: {len(changes)} é¡¹")

if __name__ == "__main__":
    check_environment_consistency()
```

---

## 7. ğŸ” é…ç½®å®¡è®¡ä¸åˆè§„


### 7.1 å®¡è®¡éœ€æ±‚åˆ†æ


**å®¡è®¡ç»´åº¦**ï¼š
```
ğŸ• æ—¶é—´ç»´åº¦ï¼š
â€¢ é…ç½®å˜æ›´æ—¶é—´è®°å½•
â€¢ å˜æ›´ç”Ÿæ•ˆæ—¶é—´è·Ÿè¸ª  
â€¢ å®¡æ‰¹æµç¨‹æ—¶é—´ç»Ÿè®¡
â€¢ å®šæœŸåˆè§„æ£€æŸ¥å‘¨æœŸ

ğŸ‘¤ äººå‘˜ç»´åº¦ï¼š
â€¢ é…ç½®å˜æ›´æ“ä½œäººå‘˜
â€¢ å˜æ›´å®¡æ‰¹è´£ä»»äºº
â€¢ é…ç½®å®¡è®¡æ£€æŸ¥äººå‘˜
â€¢ å¼‚å¸¸å¤„ç†è´Ÿè´£äºº

ğŸ“ å†…å®¹ç»´åº¦ï¼š  
â€¢ é…ç½®é¡¹å˜æ›´å†…å®¹å¯¹æ¯”
â€¢ å˜æ›´åŸå› å’Œä¸šåŠ¡å½±å“
â€¢ é£é™©è¯„ä¼°å’Œé¢„æ¡ˆå‡†å¤‡
â€¢ å˜æ›´ç»“æœéªŒè¯è®°å½•

ğŸ¯ åˆè§„ç»´åº¦ï¼š
â€¢ å®‰å…¨é…ç½®è§„èŒƒæ£€æŸ¥
â€¢ æ€§èƒ½é…ç½®æœ€ä½³å®è·µ
â€¢ è¡Œä¸šæ ‡å‡†åˆè§„éªŒè¯
â€¢ ä¼ä¸šå†…éƒ¨è§„èŒƒå®¡è®¡
```

### 7.2 è‡ªåŠ¨åŒ–å®¡è®¡å®ç°


**é…ç½®åˆè§„æ£€æŸ¥è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
import yaml
import re
from typing import Dict, List, Tuple

class MySQLConfigAuditor:
    """MySQLé…ç½®å®¡è®¡å™¨"""
    
    def __init__(self):
        self.compliance_rules = self.load_compliance_rules()
        self.audit_results = []
    
    def load_compliance_rules(self) -> Dict:
        """åŠ è½½åˆè§„è§„åˆ™"""
        return {
            'security': {
                'ssl_required': True,
                'root_remote_login': False,
                'password_validation': True,
                'audit_log_enabled': True
            },
            'performance': {
                'innodb_buffer_pool_min_ratio': 0.7,  # è‡³å°‘70%å†…å­˜
                'max_connections_max': 5000,         # è¿æ¥æ•°ä¸Šé™
                'slow_query_log_required': True,     # å¿…é¡»å¼€å¯æ…¢æ—¥å¿—
                'binlog_sync_required': True         # ç”Ÿäº§ç¯å¢ƒå¿…é¡»åŒæ­¥
            },
            'replication': {
                'gtid_required': True,               # å¿…é¡»å¯ç”¨GTID
                'binlog_format': 'ROW',             # å¿…é¡»ä½¿ç”¨ROWæ ¼å¼
                'log_slave_updates': True,          # å¿…é¡»å¼€å¯slave updates
                'binlog_retention_min_days': 3      # è‡³å°‘ä¿ç•™3å¤©
            }
        }
    
    def audit_security_compliance(self, config: Dict, environment: str) -> List[Tuple[str, str, str]]:
        """å®‰å…¨åˆè§„æ£€æŸ¥"""
        issues = []
        
        # æ£€æŸ¥SSLé…ç½®
        if environment in ['prod', 'staging']:
            ssl_configs = ['ssl_cert', 'ssl_key', 'ssl_ca']
            for ssl_config in ssl_configs:
                if ssl_config not in config:
                    issues.append((
                        'SECURITY', 
                        'CRITICAL', 
                        f'{environment}ç¯å¢ƒç¼ºå°‘SSLé…ç½®: {ssl_config}'
                    ))
        
        # æ£€æŸ¥rootç”¨æˆ·é…ç½®
        if config.get('bind_address') == '0.0.0.0':
            issues.append((
                'SECURITY',
                'HIGH',
                'MySQLç»‘å®šåˆ°æ‰€æœ‰IPåœ°å€ï¼Œå­˜åœ¨å®‰å…¨é£é™©'
            ))
        
        # æ£€æŸ¥å®¡è®¡æ—¥å¿—
        if not config.get('audit_log', False):
            issues.append((
                'SECURITY',
                'MEDIUM', 
                'æœªå¯ç”¨å®¡è®¡æ—¥å¿—ï¼Œæ— æ³•è¿½è¸ªæ•°æ®åº“æ“ä½œ'
            ))
        
        return issues
    
    def audit_performance_compliance(self, config: Dict, environment: str) -> List[Tuple[str, str, str]]:
        """æ€§èƒ½åˆè§„æ£€æŸ¥"""
        issues = []
        
        # æ£€æŸ¥buffer poolé…ç½®
        buffer_pool_size = config.get('innodb_buffer_pool_size', '0')
        if isinstance(buffer_pool_size, str) and buffer_pool_size.endswith('G'):
            buffer_gb = int(buffer_pool_size[:-1])
            # å‡è®¾æœåŠ¡å™¨å†…å­˜é…ç½®åœ¨environmenté…ç½®ä¸­
            server_memory_gb = config.get('server_memory_gb', 32)
            ratio = buffer_gb / server_memory_gb
            
            if ratio < self.compliance_rules['performance']['innodb_buffer_pool_min_ratio']:
                issues.append((
                    'PERFORMANCE',
                    'MEDIUM',
                    f'Buffer Poolé…ç½®è¿‡å° ({buffer_gb}G/{server_memory_gb}G = {ratio:.1%})ï¼Œå»ºè®®è‡³å°‘70%'
                ))
        
        # æ£€æŸ¥è¿æ¥æ•°é…ç½®
        max_connections = config.get('max_connections', 0)
        if max_connections > self.compliance_rules['performance']['max_connections_max']:
            issues.append((
                'PERFORMANCE',
                'HIGH',
                f'æœ€å¤§è¿æ¥æ•°é…ç½®è¿‡é«˜ ({max_connections})ï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§'
            ))
        
        # æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
        if not config.get('slow_query_log', False):
            issues.append((
                'PERFORMANCE',
                'MEDIUM',
                'æœªå¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ— æ³•ç›‘æ§æ€§èƒ½é—®é¢˜'
            ))
        
        return issues
    
    def audit_replication_compliance(self, config: Dict, environment: str) -> List[Tuple[str, str, str]]:
        """å¤åˆ¶åˆè§„æ£€æŸ¥"""
        issues = []
        
        # æ£€æŸ¥GTIDé…ç½®
        if not config.get('gtid_mode') == 'ON':
            issues.append((
                'REPLICATION',
                'HIGH',
                'æœªå¯ç”¨GTIDæ¨¡å¼ï¼Œå½±å“å¤åˆ¶çš„ä¸€è‡´æ€§å’Œæ•…éšœæ¢å¤'
            ))
        
        # æ£€æŸ¥binlogæ ¼å¼
        if config.get('binlog_format') != 'ROW':
            issues.append((
                'REPLICATION',
                'HIGH',
                f'Binlogæ ¼å¼ä¸æ˜¯ROW ({config.get("binlog_format")})ï¼Œå¯èƒ½å¯¼è‡´å¤åˆ¶ä¸ä¸€è‡´'
            ))
        
        # æ£€æŸ¥binlogä¿ç•™æœŸ
        retention_seconds = config.get('binlog_retention_seconds', 0)
        min_retention = self.compliance_rules['replication']['binlog_retention_min_days'] * 24 * 3600
        
        if retention_seconds < min_retention:
            issues.append((
                'REPLICATION',
                'MEDIUM',
                f'Binlogä¿ç•™æœŸè¿‡çŸ­ ({retention_seconds/86400:.1f}å¤©)ï¼Œå»ºè®®è‡³å°‘{min_retention/86400}å¤©'
            ))
        
        return issues
    
    def generate_audit_report(self, environment: str) -> str:
        """ç”Ÿæˆå®¡è®¡æŠ¥å‘Š"""
        try:
            # åŠ è½½ç¯å¢ƒé…ç½®
            with open(f'environments/{environment}/vars.yml', 'r') as f:
                config = yaml.safe_load(f)
            
            # æ‰§è¡Œå„ç±»åˆè§„æ£€æŸ¥
            all_issues = []
            all_issues.extend(self.audit_security_compliance(config, environment))
            all_issues.extend(self.audit_performance_compliance(config, environment))
            all_issues.extend(self.audit_replication_compliance(config, environment))
            
            # ç”ŸæˆæŠ¥å‘Š
            report = f"""
ğŸ” MySQLé…ç½®å®¡è®¡æŠ¥å‘Š - {environment.upper()}ç¯å¢ƒ
{'='*60}
å®¡è®¡æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
é…ç½®ç‰ˆæœ¬: {config.get('config_version', 'æœªçŸ¥')}
å®¡è®¡è§„åˆ™: v2.1.0

ğŸ“Š å®¡è®¡ç»Ÿè®¡:
æ€»æ£€æŸ¥é¡¹: {len(all_issues) + 20}  # å‡è®¾æ€»å…±æ£€æŸ¥äº†20å¤šé¡¹
å‘ç°é—®é¢˜: {len(all_issues)}
é€šè¿‡é¡¹ç›®: {20 - len(all_issues)}

"""
            
            if not all_issues:
                report += "âœ… æ­å–œï¼æ‰€æœ‰é…ç½®é¡¹å‡ç¬¦åˆåˆè§„è¦æ±‚ã€‚\n"
            else:
                # æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„
                critical_issues = [issue for issue in all_issues if issue[1] == 'CRITICAL']
                high_issues = [issue for issue in all_issues if issue[1] == 'HIGH']
                medium_issues = [issue for issue in all_issues if issue[1] == 'MEDIUM']
                
                if critical_issues:
                    report += "ğŸ”´ ä¸¥é‡é—®é¢˜ (CRITICAL):\n"
                    for i, (category, level, description) in enumerate(critical_issues, 1):
                        report += f"  {i}. [{category}] {description}\n"
                    report += "\n"
                
                if high_issues:
                    report += "ğŸŸ¡ é«˜ä¼˜å…ˆçº§é—®é¢˜ (HIGH):\n"
                    for i, (category, level, description) in enumerate(high_issues, 1):
                        report += f"  {i}. [{category}] {description}\n"
                    report += "\n"
                
                if medium_issues:
                    report += "ğŸŸ  ä¸­ä¼˜å…ˆçº§é—®é¢˜ (MEDIUM):\n"
                    for i, (category, level, description) in enumerate(medium_issues, 1):
                        report += f"  {i}. [{category}] {description}\n"
                    report += "\n"
                
                report += "ğŸ“‹ å¤„ç†å»ºè®®:\n"
                report += "â€¢ ä¼˜å…ˆå¤„ç†ä¸¥é‡å’Œé«˜ä¼˜å…ˆçº§é—®é¢˜\n"
                report += "â€¢ ä¸­ä¼˜å…ˆçº§é—®é¢˜å¯åœ¨ä¸‹æ¬¡ç»´æŠ¤çª—å£å¤„ç†\n"
                report += "â€¢ å»ºè®®å®šæœŸæ‰§è¡Œé…ç½®å®¡è®¡æ£€æŸ¥\n"
            
            return report
            
        except Exception as e:
            return f"âŒ å®¡è®¡æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {str(e)}"

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import sys
    from datetime import datetime
    
    if len(sys.argv) != 2:
        print("ç”¨æ³•: python audit.py <ç¯å¢ƒåç§°>")
        print("ä¾‹å¦‚: python audit.py prod")
        sys.exit(1)
    
    environment = sys.argv[1]
    auditor = MySQLConfigAuditor()
    report = auditor.generate_audit_report(environment)
    
    # è¾“å‡ºåˆ°æ§åˆ¶å°
    print(report)
    
    # ä¿å­˜åˆ°æ–‡ä»¶
    report_file = f"audit_report_{environment}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    with open(report_file, 'w', encoding='utf-8') as f:
        f.write(report)
    
    print(f"\nğŸ“„ å®¡è®¡æŠ¥å‘Šå·²ä¿å­˜åˆ°: {report_file}")
```

---

## 8. ğŸ¤– é…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²


### 8.1 éƒ¨ç½²æµæ°´çº¿è®¾è®¡


**CI/CDæµæ°´çº¿å›¾**ï¼š
```
ğŸ”„ é…ç½®éƒ¨ç½²æµæ°´çº¿:

å¼€å‘é˜¶æ®µ:
â”œâ”€â”€ 1. ä»£ç æäº¤ (Git Push)
â”œâ”€â”€ 2. è§¦å‘CIæµæ°´çº¿ (GitLab CI/Jenkins)
â”œâ”€â”€ 3. é…ç½®è¯­æ³•æ£€æŸ¥ (MySQL Config Validation)
â”œâ”€â”€ 4. å®‰å…¨æ‰«æ (Security Check)
â””â”€â”€ 5. å•å…ƒæµ‹è¯• (Configuration Test)
    â†“
æµ‹è¯•é˜¶æ®µ:
â”œâ”€â”€ 6. è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ (Auto Deploy to Test)
â”œâ”€â”€ 7. é›†æˆæµ‹è¯• (Integration Test)
â”œâ”€â”€ 8. æ€§èƒ½åŸºå‡†æµ‹è¯• (Performance Baseline)
â””â”€â”€ 9. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š (Test Report)
    â†“
é¢„ç”Ÿäº§é˜¶æ®µ:
â”œâ”€â”€ 10. äººå·¥å®¡æ‰¹ (Manual Approval)
â”œâ”€â”€ 11. éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ (Deploy to Staging)
â”œâ”€â”€ 12. ç”Ÿäº§æ¨¡æ‹Ÿæµ‹è¯• (Production Simulation)
â””â”€â”€ 13. å›æ»šæµ‹è¯• (Rollback Test)
    â†“
ç”Ÿäº§éƒ¨ç½²:
â”œâ”€â”€ 14. ç”Ÿäº§ç¯å¢ƒå®¡æ‰¹ (Production Approval)
â”œâ”€â”€ 15. è“ç»¿éƒ¨ç½² (Blue-Green Deployment)
â”œâ”€â”€ 16. å¥åº·æ£€æŸ¥ (Health Check)
â”œâ”€â”€ 17. æµé‡åˆ‡æ¢ (Traffic Switch)
â””â”€â”€ 18. éƒ¨ç½²å®Œæˆé€šçŸ¥ (Deployment Notification)
```

### 8.2 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬


**ä¸»éƒ¨ç½²è„šæœ¬** (`scripts/deploy-config.sh`)ï¼š
```bash
#!/bin/bash
# MySQLé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -euo pipefail  # ä¸¥æ ¼æ¨¡å¼

# è„šæœ¬é…ç½®
SCRIPT_DIR=$(dirname "$0")
PROJECT_ROOT=$(dirname "$SCRIPT_DIR")
LOG_FILE="/tmp/mysql-config-deploy-$(date +%Y%m%d_%H%M%S).log"

# é¢œè‰²è¾“å‡ºå‡½æ•°
red() { echo -e "\033[31m$1\033[0m"; }
green() { echo -e "\033[32m$1\033[0m"; }
yellow() { echo -e "\033[33m$1\033[0m"; }
blue() { echo -e "\033[34m$1\033[0m"; }

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    red "âŒ é”™è¯¯: $1" >&2
    log "ERROR: $1"
    exit 1
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    log "ğŸ” æ£€æŸ¥éƒ¨ç½²ä¾èµ–..."
    
    local deps=("python3" "git" "rsync" "mysql")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &> /dev/null; then
            error_exit "ç¼ºå°‘ä¾èµ–: $dep"
        fi
    done
    
    # æ£€æŸ¥Pythonä¾èµ–
    python3 -c "import jinja2, yaml" || error_exit "ç¼ºå°‘Pythonä¾èµ–åŒ…"
    
    green "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# éªŒè¯è¾“å…¥å‚æ•°
validate_inputs() {
    local environment=$1
    local version=$2
    
    log "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
    
    # æ£€æŸ¥ç¯å¢ƒé…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [[ ! -f "$PROJECT_ROOT/environments/$environment/vars.yml" ]]; then
        error_exit "ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $environment"
    fi
    
    # æ£€æŸ¥ç‰ˆæœ¬æ ‡ç­¾æ˜¯å¦å­˜åœ¨
    if ! git tag -l | grep -q "^$version$"; then
        error_exit "Gitç‰ˆæœ¬æ ‡ç­¾ä¸å­˜åœ¨: $version"
    fi
    
    green "âœ… å‚æ•°éªŒè¯é€šè¿‡"
}

# å¤‡ä»½å½“å‰é…ç½®
backup_current_config() {
    local environment=$1
    local backup_dir="/backup/mysql-config/$environment/$(date +%Y%m%d_%H%M%S)"
    
    log "ğŸ’¾ å¤‡ä»½å½“å‰é…ç½®åˆ°: $backup_dir"
    
    mkdir -p "$backup_dir"
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶
    rsync -av "/etc/mysql/" "$backup_dir/etc-mysql/" || error_exit "é…ç½®æ–‡ä»¶å¤‡ä»½å¤±è´¥"
    
    # å¤‡ä»½æ•°æ®åº“é…ç½®å¿«ç…§
    mysql -e "SHOW VARIABLES" > "$backup_dir/mysql-variables.txt" || true
    mysql -e "SHOW MASTER STATUS" > "$backup_dir/master-status.txt" || true
    mysql -e "SHOW SLAVE STATUS\G" > "$backup_dir/slave-status.txt" || true
    
    echo "$backup_dir" > "/tmp/mysql-config-backup-path"
    green "âœ… é…ç½®å¤‡ä»½å®Œæˆ"
}

# ç”Ÿæˆæ–°é…ç½®
generate_config() {
    local environment=$1
    local version=$2
    
    log "ğŸ”§ ç”Ÿæˆæ–°é…ç½® (ç¯å¢ƒ: $environment, ç‰ˆæœ¬: $version)"
    
    # åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬
    git checkout "$version" || error_exit "åˆ‡æ¢ç‰ˆæœ¬å¤±è´¥: $version"
    
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    python3 "$PROJECT_ROOT/scripts/generate-config.py" \
        --environment "$environment" \
        --output-dir "$PROJECT_ROOT/generated/$environment" \
        || error_exit "é…ç½®ç”Ÿæˆå¤±è´¥"
    
    green "âœ… é…ç½®ç”Ÿæˆå®Œæˆ"
}

# éªŒè¯é…ç½®è¯­æ³•
validate_config() {
    local environment=$1
    
    log "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•..."
    
    local config_file="$PROJECT_ROOT/generated/$environment/my.cnf"
    
    # MySQLé…ç½®è¯­æ³•æ£€æŸ¥
    mysqld --help --verbose --defaults-file="$config_file" > /dev/null 2>&1 || {
        error_exit "MySQLé…ç½®è¯­æ³•æ£€æŸ¥å¤±è´¥"
    }
    
    # è‡ªå®šä¹‰é…ç½®æ£€æŸ¥
    python3 "$PROJECT_ROOT/scripts/validate-config.py" \
        --config-file "$config_file" \
        --environment "$environment" \
        || error_exit "é…ç½®éªŒè¯å¤±è´¥"
    
    green "âœ… é…ç½®éªŒè¯é€šè¿‡"
}

# æ‰§è¡Œé…ç½®éƒ¨ç½²
deploy_config() {
    local environment=$1
    
    log "ğŸš€ éƒ¨ç½²é…ç½®åˆ°ç¯å¢ƒ: $environment"
    
    local source_dir="$PROJECT_ROOT/generated/$environment"
    local target_dir="/etc/mysql"
    
    # åœæ­¢MySQLæœåŠ¡ (å¦‚æœéœ€è¦)
    if [[ "$RESTART_MYSQL" == "true" ]]; then
        log "ğŸ›‘ åœæ­¢MySQLæœåŠ¡..."
        systemctl stop mysql || error_exit "åœæ­¢MySQLæœåŠ¡å¤±è´¥"
    fi
    
    # éƒ¨ç½²é…ç½®æ–‡ä»¶
    rsync -av "$source_dir/" "$target_dir/" || error_exit "é…ç½®æ–‡ä»¶éƒ¨ç½²å¤±è´¥"
    
    # è®¾ç½®æ–‡ä»¶æƒé™
    chown -R mysql:mysql "$target_dir"
    chmod 644 "$target_dir"/*.cnf
    
    green "âœ… é…ç½®æ–‡ä»¶éƒ¨ç½²å®Œæˆ"
}

# å¯åŠ¨å¹¶éªŒè¯MySQLæœåŠ¡
verify_mysql_service() {
    local environment=$1
    
    log "ğŸ” éªŒè¯MySQLæœåŠ¡..."
    
    if [[ "$RESTART_MYSQL" == "true" ]]; then
        # å¯åŠ¨MySQLæœåŠ¡
        log "ğŸš€ å¯åŠ¨MySQLæœåŠ¡..."
        systemctl start mysql || error_exit "å¯åŠ¨MySQLæœåŠ¡å¤±è´¥"
        
        # ç­‰å¾…æœåŠ¡å°±ç»ª
        local retry_count=0
        while ! mysqladmin ping >/dev/null 2>&1 && [[ $retry_count -lt 30 ]]; do
            sleep 2
            ((retry_count++))
            log "ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨... ($retry_count/30)"
        done
        
        if [[ $retry_count -eq 30 ]]; then
            error_exit "MySQLæœåŠ¡å¯åŠ¨è¶…æ—¶"
        fi
    fi
    
    # éªŒè¯æœåŠ¡çŠ¶æ€
    if ! systemctl is-active --quiet mysql; then
        error_exit "MySQLæœåŠ¡æœªè¿è¡Œ"
    fi
    
    # éªŒè¯è¿æ¥
    mysql -e "SELECT 1" >/dev/null || error_exit "MySQLè¿æ¥æµ‹è¯•å¤±è´¥"
    
    # éªŒè¯å¤åˆ¶çŠ¶æ€ (å¦‚æœé€‚ç”¨)
    if [[ "$environment" != "dev" ]]; then
        python3 "$PROJECT_ROOT/scripts/verify-replication.py" \
            --environment "$environment" \
            || error_exit "å¤åˆ¶çŠ¶æ€éªŒè¯å¤±è´¥"
    fi
    
    green "âœ… MySQLæœåŠ¡éªŒè¯é€šè¿‡"
}

# å‘é€éƒ¨ç½²é€šçŸ¥
send_notification() {
    local environment=$1
    local version=$2
    local status=$3
    
    log "ğŸ“¬ å‘é€éƒ¨ç½²é€šçŸ¥..."
    
    local message="MySQLé…ç½®éƒ¨ç½²é€šçŸ¥
ç¯å¢ƒ: $environment
ç‰ˆæœ¬: $version
çŠ¶æ€: $status
æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
æ“ä½œå‘˜: $(whoami)
æ—¥å¿—: $LOG_FILE"
    
    # å‘é€åˆ°Slack/é’‰é’‰/é‚®ä»¶ç­‰ (æ ¹æ®å®é™…æƒ…å†µé…ç½®)
    # curl -X POST -H 'Content-type: application/json' \
    #      --data "{\"text\":\"$message\"}" \
    #      "$SLACK_WEBHOOK_URL"
    
    echo "é€šçŸ¥å†…å®¹: $message"
    green "âœ… éƒ¨ç½²é€šçŸ¥å·²å‘é€"
}

# ä¸»å‡½æ•°
main() {
    # å‚æ•°è§£æ
    while [[ $# -gt 0 ]]; do
        case $1 in
            -e|--environment)
                ENVIRONMENT="$2"
                shift 2
                ;;
            -v|--version)
                VERSION="$2"
                shift 2
                ;;
            -r|--restart)
                RESTART_MYSQL="true"
                shift
                ;;
            -h|--help)
                cat << EOF
MySQLé…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

ç”¨æ³•: $0 [é€‰é¡¹]

é€‰é¡¹:
  -e, --environment ENV    ç›®æ ‡ç¯å¢ƒ (dev/test/staging/prod)
  -v, --version VERSION    é…ç½®ç‰ˆæœ¬æ ‡ç­¾
  -r, --restart           æ˜¯å¦é‡å¯MySQLæœåŠ¡
  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  $0 -e prod -v v2.1.3-prod -r
  $0 --environment test --version v2.1.3-test

EOF
                exit 0
                ;;
            *)
                error_exit "æœªçŸ¥å‚æ•°: $1"
                ;;
        esac
    done
    
    # æ£€æŸ¥å¿…éœ€å‚æ•°
    if [[ -z "${ENVIRONMENT:-}" ]] || [[ -z "${VERSION:-}" ]]; then
        error_exit "ç¼ºå°‘å¿…éœ€å‚æ•°ï¼Œä½¿ç”¨ -h æŸ¥çœ‹å¸®åŠ©"
    fi
    
    # è®¾ç½®é»˜è®¤å€¼
    RESTART_MYSQL="${RESTART_MYSQL:-false}"
    
    # æ‰§è¡Œéƒ¨ç½²æµç¨‹
    blue "ğŸš€ å¼€å§‹MySQLé…ç½®éƒ¨ç½²..."
    blue "ç¯å¢ƒ: $ENVIRONMENT"
    blue "ç‰ˆæœ¬: $VERSION"
    blue "é‡å¯MySQL: $RESTART_MYSQL"
    blue "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    
    check_dependencies
    validate_inputs "$ENVIRONMENT" "$VERSION"
    backup_current_config "$ENVIRONMENT"
    generate_config "$ENVIRONMENT" "$VERSION"
    validate_config "$ENVIRONMENT"
    deploy_config "$ENVIRONMENT"
    verify_mysql_service "$ENVIRONMENT"
    send_notification "$ENVIRONMENT" "$VERSION" "SUCCESS"
    
    green "ğŸ‰ MySQLé…ç½®éƒ¨ç½²å®Œæˆ!"
    green "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
}

# é”™è¯¯å¤„ç†
trap 'error_exit "è„šæœ¬æ‰§è¡Œä¸­æ–­"' ERR INT TERM

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

### 8.3 è“ç»¿éƒ¨ç½²ç­–ç•¥


**è“ç»¿éƒ¨ç½²å®ç°**ï¼š
```python
#!/usr/bin/env python3
"""
MySQLé…ç½®è“ç»¿éƒ¨ç½²å®ç°
é€‚ç”¨äºä¸»ä»å¤åˆ¶ç¯å¢ƒçš„é…ç½®å®‰å…¨æ›´æ–°
"""

import time
import logging
import subprocess
from typing import Dict, List, Optional

class BlueGreenDeployment:
    """è“ç»¿éƒ¨ç½²ç®¡ç†å™¨"""
    
    def __init__(self, config: Dict):
        self.config = config
        self.logger = self._setup_logger()
        
    def _setup_logger(self):
        """è®¾ç½®æ—¥å¿—"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s'
        )
        return logging.getLogger(__name__)
    
    def deploy_to_slaves_first(self, new_config_version: str) -> bool:
        """
        æ­¥éª¤1: å…ˆéƒ¨ç½²ä»åº“ï¼ˆè“ç»¿éƒ¨ç½²çš„"ç»¿"ç¯å¢ƒï¼‰
        ä»åº“å¯ä»¥å®‰å…¨åœ°æ›´æ–°é…ç½®ï¼Œä¸å½±å“è¯»å†™æœåŠ¡
        """
        self.logger.info("ğŸ”µ å¼€å§‹éƒ¨ç½²ä»åº“é…ç½®...")
        
        slave_hosts = self.config['slave_hosts']
        failed_slaves = []
        
        for slave in slave_hosts:
            try:
                self.logger.info(f"éƒ¨ç½²ä»åº“: {slave['host']}")
                
                # 1. åœæ­¢ä»åº“å¤åˆ¶
                self._stop_slave_replication(slave)
                
                # 2. éƒ¨ç½²æ–°é…ç½®
                self._deploy_config_to_host(slave, new_config_version)
                
                # 3. é‡å¯MySQLæœåŠ¡
                self._restart_mysql_service(slave)
                
                # 4. éªŒè¯æœåŠ¡çŠ¶æ€
                if not self._verify_mysql_health(slave):
                    raise Exception("MySQLå¥åº·æ£€æŸ¥å¤±è´¥")
                
                # 5. é‡æ–°å¯åŠ¨å¤åˆ¶
                self._start_slave_replication(slave)
                
                # 6. éªŒè¯å¤åˆ¶çŠ¶æ€
                if not self._verify_replication_health(slave):
                    raise Exception("å¤åˆ¶çŠ¶æ€å¼‚å¸¸")
                
                self.logger.info(f"âœ… ä»åº“ {slave['host']} éƒ¨ç½²æˆåŠŸ")
                
            except Exception as e:
                self.logger.error(f"âŒ ä»åº“ {slave['host']} éƒ¨ç½²å¤±è´¥: {e}")
                failed_slaves.append(slave)
                
                # å°è¯•å›æ»šè¯¥ä»åº“
                self._rollback_slave_config(slave)
        
        if failed_slaves:
            self.logger.error(f"éƒ¨åˆ†ä»åº“éƒ¨ç½²å¤±è´¥: {[s['host'] for s in failed_slaves]}")
            return False
        
        self.logger.info("ğŸ‰ æ‰€æœ‰ä»åº“é…ç½®éƒ¨ç½²æˆåŠŸ")
        return True
    
    def deploy_to_master(self, new_config_version: str) -> bool:
        """
        æ­¥éª¤2: éƒ¨ç½²ä¸»åº“é…ç½®ï¼ˆè“ç»¿éƒ¨ç½²çš„"è“"ç¯å¢ƒåˆ‡æ¢ï¼‰
        ä¸»åº“éƒ¨ç½²éœ€è¦æ›´è°¨æ…ï¼Œå¯èƒ½éœ€è¦çŸ­æš‚åœæœ
        """
        self.logger.info("ğŸ”´ å¼€å§‹éƒ¨ç½²ä¸»åº“é…ç½®...")
        
        master = self.config['master_host']
        
        try:
            # 1. æ£€æŸ¥ä¸»åº“å½“å‰çŠ¶æ€
            if not self._verify_master_ready_for_deployment(master):
                raise Exception("ä¸»åº“å½“å‰çŠ¶æ€ä¸é€‚åˆéƒ¨ç½²")
            
            # 2. åˆ›å»ºé…ç½®å¿«ç…§ç‚¹
            snapshot_info = self._create_master_snapshot(master)
            
            # 3. åˆ‡æ¢ä¸»åº“åˆ°ç»´æŠ¤æ¨¡å¼ (å¯é€‰ï¼Œå–å†³äºé…ç½®æ›´æ–°æ˜¯å¦éœ€è¦é‡å¯)
            if self.config.get('requires_restart', False):
                self._enable_maintenance_mode(master)
            
            # 4. éƒ¨ç½²æ–°é…ç½®
            self._deploy_config_to_host(master, new_config_version)
            
            # 5. é‡å¯MySQLæœåŠ¡ (å¦‚æœéœ€è¦)
            if self.config.get('requires_restart', False):
                self._restart_mysql_service(master)
            else:
                # åŠ¨æ€é‡è½½é…ç½® (å¦‚æœæ”¯æŒ)
                self._reload_mysql_config(master)
            
            # 6. éªŒè¯ä¸»åº“æœåŠ¡çŠ¶æ€
            if not self._verify_mysql_health(master):
                raise Exception("ä¸»åº“å¥åº·æ£€æŸ¥å¤±è´¥")
            
            # 7. éªŒè¯ä¸»ä»å¤åˆ¶çŠ¶æ€
            if not self._verify_master_slave_sync():
                raise Exception("ä¸»ä»åŒæ­¥å¼‚å¸¸")
            
            # 8. é€€å‡ºç»´æŠ¤æ¨¡å¼
            if self.config.get('requires_restart', False):
                self._disable_maintenance_mode(master)
            
            # 9. æ‰§è¡Œä¸šåŠ¡åŠŸèƒ½éªŒè¯
            if not self._verify_business_functions():
                raise Exception("ä¸šåŠ¡åŠŸèƒ½éªŒè¯å¤±è´¥")
            
            self.logger.info("âœ… ä¸»åº“é…ç½®éƒ¨ç½²æˆåŠŸ")
            return True
            
        except Exception as e:
            self.logger.error(f"âŒ ä¸»åº“éƒ¨ç½²å¤±è´¥: {e}")
            
            # ä¸»åº“éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œç´§æ€¥å›æ»š
            self._emergency_rollback_master(master, snapshot_info)
            return False
    
    def _stop_slave_replication(self, slave: Dict):
        """åœæ­¢ä»åº“å¤åˆ¶"""
        cmd = f"mysql -h {slave['host']} -e 'STOP SLAVE;'"
        subprocess.run(cmd, shell=True, check=True)
        self.logger.info(f"å·²åœæ­¢ {slave['host']} çš„å¤åˆ¶")
    
    def _start_slave_replication(self, slave: Dict):
        """å¯åŠ¨ä»åº“å¤åˆ¶"""
        cmd = f"mysql -h {slave['host']} -e 'START SLAVE;'"
        subprocess.run(cmd, shell=True, check=True)
        self.logger.info(f"å·²å¯åŠ¨ {slave['host']} çš„å¤åˆ¶")
    
    def _deploy_config_to_host(self, host: Dict, version: str):
        """éƒ¨ç½²é…ç½®åˆ°æŒ‡å®šä¸»æœº"""
        deploy_cmd = f"""
        ssh {host['host']} "
            cd /opt/mysql-config-repo &&
            git checkout {version} &&
            python3 scripts/generate-config.py --environment {host['env']} &&
            rsync -av generated/{host['env']}/ /etc/mysql/
        "
        """
        subprocess.run(deploy_cmd, shell=True, check=True)
    
    def _restart_mysql_service(self, host: Dict):
        """é‡å¯MySQLæœåŠ¡"""
        restart_cmd = f"ssh {host['host']} 'systemctl restart mysql'"
        subprocess.run(restart_cmd, shell=True, check=True)
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        self._wait_for_mysql_ready(host)
    
    def _wait_for_mysql_ready(self, host: Dict, timeout: int = 60):
        """ç­‰å¾…MySQLæœåŠ¡å°±ç»ª"""
        start_time = time.time()
        while time.time() - start_time < timeout:
            try:
                ping_cmd = f"mysqladmin -h {host['host']} ping"
                subprocess.run(ping_cmd, shell=True, check=True, 
                             stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                return True
            except subprocess.CalledProcessError:
                time.sleep(2)
        
        raise Exception(f"MySQLæœåŠ¡å¯åŠ¨è¶…æ—¶: {host['host']}")
    
    def _verify_mysql_health(self, host: Dict) -> bool:
        """éªŒè¯MySQLå¥åº·çŠ¶æ€"""
        try:
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            status_cmd = f"ssh {host['host']} 'systemctl is-active mysql'"
            subprocess.run(status_cmd, shell=True, check=True, 
                          stdout=subprocess.DEVNULL)
            
            # æ£€æŸ¥è¿æ¥
            connect_cmd = f"mysql -h {host['host']} -e 'SELECT 1'"
            subprocess.run(connect_cmd, shell=True, check=True, 
                          stdout=subprocess.DEVNULL)
            
            return True
        except subprocess.CalledProcessError:
            return False
    
    def _verify_replication_health(self, slave: Dict) -> bool:
        """éªŒè¯å¤åˆ¶å¥åº·çŠ¶æ€"""
        try:
            # æ£€æŸ¥å¤åˆ¶çŠ¶æ€
            repl_cmd = f"""
            mysql -h {slave['host']} -e "
                SHOW SLAVE STATUS\\G
            " | grep -E "(Slave_IO_Running|Slave_SQL_Running)" | grep -q "Yes"
            """
            subprocess.run(repl_cmd, shell=True, check=True)
            return True
        except subprocess.CalledProcessError:
            return False

# ä½¿ç”¨ç¤ºä¾‹
def main():
    """ä¸»å‡½æ•°ç¤ºä¾‹"""
    # é…ç½®ä¿¡æ¯
    deployment_config = {
        'master_host': {
            'host': '192.168.1.10',
            'env': 'prod'
        },
        'slave_hosts': [
            {'host': '192.168.1.11', 'env': 'prod'},
            {'host': '192.168.1.12', 'env': 'prod'}
        ],
        'requires_restart': False,  # æ˜¯å¦éœ€è¦é‡å¯MySQL
        'maintenance_mode': True    # æ˜¯å¦å¯ç”¨ç»´æŠ¤æ¨¡å¼
    }
    
    # åˆ›å»ºéƒ¨ç½²å™¨
    deployer = BlueGreenDeployment(deployment_config)
    
    # æ‰§è¡Œè“ç»¿éƒ¨ç½²
    new_version = "v2.1.4-prod"
    
    # æ­¥éª¤1: éƒ¨ç½²ä»åº“
    if deployer.deploy_to_slaves_first(new_version):
        print("âœ… ä»åº“éƒ¨ç½²å®Œæˆ")
        
        # æ­¥éª¤2: éƒ¨ç½²ä¸»åº“
        if deployer.deploy_to_master(new_version):
            print("ğŸ‰ è“ç»¿éƒ¨ç½²æˆåŠŸå®Œæˆ!")
        else:
            print("âŒ ä¸»åº“éƒ¨ç½²å¤±è´¥ï¼Œä»åº“å·²å›æ»š")
    else:
        print("âŒ ä»åº“éƒ¨ç½²å¤±è´¥ï¼Œåœæ­¢éƒ¨ç½²æµç¨‹")

if __name__ == "__main__":
    main()
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ é…ç½®ç‰ˆæœ¬ç®¡ç†çš„æœ¬è´¨ï¼š
â€¢ è®©é…ç½®å˜æ›´å¯è¿½æº¯ã€å¯å›æ»šã€å¯å®¡è®¡
â€¢ é€šè¿‡æ ‡å‡†åŒ–æ¨¡æ¿å‡å°‘äººä¸ºé”™è¯¯
â€¢ å®ç°ä¸åŒç¯å¢ƒçš„é…ç½®ä¸€è‡´æ€§ç®¡ç†
â€¢ æ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²å’ŒæŒç»­é›†æˆ

ğŸ”§ æ ¸å¿ƒç»„ä»¶ï¼š
â€¢ Gitä»“åº“ï¼šç‰ˆæœ¬æ§åˆ¶å’Œå†å²è¿½è¸ª
â€¢ é…ç½®æ¨¡æ¿ï¼šæ ‡å‡†åŒ–å’Œå‚æ•°åŒ–é…ç½®
â€¢ ç¯å¢ƒéš”ç¦»ï¼šä¸åŒç¯å¢ƒç‹¬ç«‹ç®¡ç†
â€¢ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼šå‡å°‘äººå·¥æ“ä½œé”™è¯¯
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç‰ˆæœ¬ç®¡ç†**
```
ä¼ ç»Ÿç—›ç‚¹ï¼š
âŒ é…ç½®æ”¹é”™æ‰¾ä¸å›åŸçŠ¶æ€
âŒ å¤šç¯å¢ƒé…ç½®ä¸ä¸€è‡´
âŒ å˜æ›´è¿‡ç¨‹æ²¡æœ‰è®°å½•
âŒ å‡ºé—®é¢˜æ—¶éš¾ä»¥å¿«é€Ÿæ¢å¤

ç‰ˆæœ¬ç®¡ç†è§£å†³ï¼š
âœ… æ¯æ¬¡å˜æ›´éƒ½æœ‰å®Œæ•´è®°å½•
âœ… æ ‡å‡†åŒ–æ¨¡æ¿ä¿è¯ä¸€è‡´æ€§  
âœ… è‡ªåŠ¨åŒ–æµç¨‹å‡å°‘é”™è¯¯
âœ… å¿«é€Ÿå›æ»šæœºåˆ¶ä¿è¯ç¨³å®šæ€§
```

**ğŸ”¹ é…ç½®æ¨¡æ¿åŒ–çš„ä»·å€¼**
```
æ ¸å¿ƒä¼˜åŠ¿ï¼š
â€¢ å‚æ•°åŒ–ï¼šä¸€å¥—æ¨¡æ¿é€‚é…å¤šç¯å¢ƒ
â€¢ æ ‡å‡†åŒ–ï¼šç»Ÿä¸€é…ç½®è§„èŒƒå’Œæœ€ä½³å®è·µ
â€¢ å¯ç»´æŠ¤ï¼šä¿®æ”¹æ¨¡æ¿å³å¯æ‰¹é‡æ›´æ–°
â€¢ å¯éªŒè¯ï¼šæ¨¡æ¿ç»è¿‡æµ‹è¯•ï¼Œå‡å°‘é”™è¯¯

å®é™…åº”ç”¨ï¼š
â€¢ å¼€å‘ç¯å¢ƒï¼šæ³¨é‡è°ƒè¯•ï¼Œæ”¾æ¾æŒä¹…åŒ–è¦æ±‚
â€¢ æµ‹è¯•ç¯å¢ƒï¼šæ¥è¿‘ç”Ÿäº§ï¼Œä½†èµ„æºç›¸å¯¹æœ‰é™  
â€¢ ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼æŒä¹…åŒ–ï¼Œé«˜æ€§èƒ½é…ç½®
```

**ğŸ”¹ è“ç»¿éƒ¨ç½²çš„æ ¸å¿ƒæ€æƒ³**
```
åŸºæœ¬ç†å¿µï¼š
â€¢ å…ˆæ›´æ–°"ç»¿"ç¯å¢ƒï¼ˆä»åº“ï¼‰éªŒè¯é…ç½®
â€¢ å†æ›´æ–°"è“"ç¯å¢ƒï¼ˆä¸»åº“ï¼‰å®Œæˆåˆ‡æ¢
â€¢ ä»»ä½•ç¯èŠ‚å‡ºé—®é¢˜éƒ½èƒ½å¿«é€Ÿå›æ»š

é€‚ç”¨åœºæ™¯ï¼š
â€¢ ä¸»ä»å¤åˆ¶æ¶æ„çš„é…ç½®æ›´æ–°
â€¢ éœ€è¦ä¿è¯æœåŠ¡è¿ç»­æ€§çš„åœºæ™¯
â€¢ å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„ç¯å¢ƒ
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç¯å¢ƒè§„åˆ’å»ºè®®**
```
ç¯å¢ƒæ•°é‡ï¼šå»ºè®®4ä¸ªç¯å¢ƒ
â€¢ devï¼šå¼€å‘è°ƒè¯•ï¼Œé…ç½®çµæ´»
â€¢ testï¼šåŠŸèƒ½æµ‹è¯•ï¼Œæ¥è¿‘ç”Ÿäº§é…ç½®
â€¢ stagingï¼šé¢„ç”Ÿäº§éªŒè¯ï¼Œå®Œå…¨æ¨¡æ‹Ÿç”Ÿäº§
â€¢ prodï¼šç”Ÿäº§ç¯å¢ƒï¼Œæœ€ä¸¥æ ¼é…ç½®

é…ç½®å·®å¼‚ç­–ç•¥ï¼š
â€¢ ç¡¬ä»¶èµ„æºï¼šæŒ‰ç¯å¢ƒé‡è¦æ€§é€’å¢
â€¢ å®‰å…¨çº§åˆ«ï¼šå¼€å‘ç¯å¢ƒå¯ä»¥æ”¾æ¾ï¼Œç”Ÿäº§ç¯å¢ƒæœ€ä¸¥æ ¼
â€¢ ç›‘æ§åŠ›åº¦ï¼šç”Ÿäº§ç¯å¢ƒç›‘æ§æœ€å¯†é›†
â€¢ å¤‡ä»½ç­–ç•¥ï¼šç”Ÿäº§ç¯å¢ƒå¤‡ä»½æœ€é¢‘ç¹
```

**ğŸ”§ å·¥å…·é“¾é€‰æ‹©**
```
ç‰ˆæœ¬æ§åˆ¶ï¼šGitï¼ˆæ ‡å‡†é€‰æ‹©ï¼‰
é…ç½®æ¨¡æ¿ï¼šJinja2ï¼ˆPythonç”Ÿæ€ï¼‰
è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š
â€¢ è½»é‡çº§ï¼šShellè„šæœ¬ + Python
â€¢ ä¼ä¸šçº§ï¼šJenkins + Ansible
â€¢ äº‘åŸç”Ÿï¼šGitLab CI + Kubernetes

ç›‘æ§é›†æˆï¼š
â€¢ é…ç½®å˜æ›´é€šçŸ¥ï¼šSlack/é’‰é’‰
â€¢ å¥åº·æ£€æŸ¥ï¼šZabbix/Prometheus  
â€¢ æ—¥å¿—èšåˆï¼šELK Stack
```

**âš ï¸ å¸¸è§é™·é˜±æé†’**
```
é…ç½®ç®¡ç†é™·é˜±ï¼š
â— è¿‡åº¦å¤æ‚åŒ–ï¼šä¸è¦ä¸ºäº†ç‰ˆæœ¬æ§åˆ¶è€Œç‰ˆæœ¬æ§åˆ¶
â— ç¯å¢ƒä¸ä¸€è‡´ï¼šæµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒå·®å¼‚å¤ªå¤§
â— æƒé™ç®¡ç†æ¾æ•£ï¼šæ²¡æœ‰ä¸¥æ ¼çš„å®¡æ‰¹æµç¨‹
â— å›æ»šæµ‹è¯•ä¸è¶³ï¼šåªæµ‹è¯•éƒ¨ç½²ï¼Œä¸æµ‹è¯•å›æ»š

æœ€ä½³å®è·µï¼š
âœ… æ¸è¿›å¼æ¨è¿›ï¼šä»ç®€å•ç¯å¢ƒå¼€å§‹é€æ­¥å®Œå–„
âœ… å……åˆ†æµ‹è¯•ï¼šæ¯ä¸ªç¯å¢ƒéƒ½è¦éªŒè¯é…ç½®æ­£ç¡®æ€§
âœ… æ–‡æ¡£é½å…¨ï¼šå˜æ›´åŸå› å’Œå½±å“è¦è®°å½•æ¸…æ¥š
âœ… å®šæœŸæ¼”ç»ƒï¼šå®šæœŸè¿›è¡Œå›æ»šæ¼”ç»ƒ
```

### 9.4 è¿›é˜¶æ‰©å±•æ–¹å‘


**ğŸš€ é«˜çº§ç‰¹æ€§**
```
é…ç½®åŠ å¯†ï¼šæ•æ„Ÿé…ç½®ï¼ˆå¯†ç ç­‰ï¼‰åŠ å¯†å­˜å‚¨
é…ç½®åˆè§„ï¼šè‡ªåŠ¨æ£€æŸ¥é…ç½®æ˜¯å¦ç¬¦åˆä¼ä¸šè§„èŒƒ
ç°åº¦å‘å¸ƒï¼šé…ç½®å˜æ›´çš„æ¸è¿›å¼å‘å¸ƒ
A/Bæµ‹è¯•ï¼šä¸åŒé…ç½®æ–¹æ¡ˆçš„æ•ˆæœå¯¹æ¯”
```

**ğŸ“ˆ ç›‘æ§å’Œè¿ç»´**
```
é…ç½®æ¼‚ç§»æ£€æµ‹ï¼šå®šæœŸæ£€æŸ¥å®é™…é…ç½®ä¸æ ‡å‡†é…ç½®çš„å·®å¼‚
æ€§èƒ½å½±å“è¯„ä¼°ï¼šé…ç½®å˜æ›´å¯¹æ€§èƒ½çš„å½±å“åˆ†æ
å®¹é‡è§„åˆ’ï¼šåŸºäºé…ç½®å˜æ›´çš„å®¹é‡éœ€æ±‚é¢„æµ‹
æ•…éšœå…³è”åˆ†æï¼šé…ç½®å˜æ›´ä¸æ•…éšœçš„å…³è”æ€§åˆ†æ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ§  é…ç½®ç‰ˆæœ¬ç®¡ç†å››å­—è¯€ï¼š
"è¿½ã€æ ‡ã€éš”ã€è‡ª"

è¿½ï¼šè¿½è¸ªå˜æ›´å†å²ï¼ŒçŸ¥é“è°æ”¹äº†ä»€ä¹ˆ
æ ‡ï¼šæ ‡å‡†åŒ–æ¨¡æ¿ï¼Œä¿è¯é…ç½®ä¸€è‡´æ€§
éš”ï¼šç¯å¢ƒéš”ç¦»ç®¡ç†ï¼Œå¼€å‘ç”Ÿäº§è¦åˆ†ç¦»  
è‡ªï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå‡å°‘äººå·¥å‡ºé”™ç‡
```

**ğŸ¯ å­¦ä¹ æ£€æŸ¥æ¸…å•**
- [ ] ç†è§£é…ç½®ç‰ˆæœ¬ç®¡ç†çš„å¿…è¦æ€§å’Œä»·å€¼
- [ ] æŒæ¡Gitåœ¨é…ç½®ç®¡ç†ä¸­çš„åº”ç”¨
- [ ] ä¼šè®¾è®¡å’Œä½¿ç”¨é…ç½®æ¨¡æ¿
- [ ] äº†è§£ç¯å¢ƒéš”ç¦»çš„ç­–ç•¥å’Œå®ç°
- [ ] èƒ½å¤Ÿè®¾è®¡é…ç½®å˜æ›´çš„å®¡è®¡æµç¨‹
- [ ] æŒæ¡è‡ªåŠ¨åŒ–éƒ¨ç½²çš„åŸºæœ¬åŸç†
- [ ] ç†è§£è“ç»¿éƒ¨ç½²åœ¨æ•°æ®åº“åœºæ™¯çš„åº”ç”¨
- [ ] èƒ½å¤Ÿå¤„ç†é…ç½®å›æ»šå’Œæ•…éšœæ¢å¤

**æ€»ç»“**ï¼šMySQLå¤åˆ¶é…ç½®ç‰ˆæœ¬ç®¡ç†ä¸æ˜¯å•çº¯çš„æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯ä¸€å¥—å®Œæ•´çš„é…ç½®æ²»ç†ä½“ç³»ã€‚å®ƒæ¶‰åŠç‰ˆæœ¬æ§åˆ¶ã€æ¨¡æ¿åŒ–ã€ç¯å¢ƒç®¡ç†ã€è‡ªåŠ¨åŒ–éƒ¨ç½²ç­‰å¤šä¸ªæ–¹é¢ï¼Œç›®æ ‡æ˜¯è®©é…ç½®å˜æ›´å˜å¾—å®‰å…¨ã€å¯æ§ã€å¯è¿½æº¯ã€‚æŒæ¡è¿™å¥—æ–¹æ³•è®ºï¼Œä¸ä»…é€‚ç”¨äºMySQLï¼Œå¯¹å…¶ä»–æ•°æ®åº“å’Œç³»ç»Ÿé…ç½®ç®¡ç†åŒæ ·æœ‰ä»·å€¼ã€‚