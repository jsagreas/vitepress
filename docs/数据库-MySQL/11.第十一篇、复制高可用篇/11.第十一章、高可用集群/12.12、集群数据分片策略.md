---
title: 12ã€é›†ç¾¤æ•°æ®åˆ†ç‰‡ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [æ•°æ®åˆ†ç‰‡åŸºç¡€æ¦‚å¿µ](#1-æ•°æ®åˆ†ç‰‡åŸºç¡€æ¦‚å¿µ)
2. [åˆ†ç‰‡ç®—æ³•è¯¦è§£](#2-åˆ†ç‰‡ç®—æ³•è¯¦è§£)
3. [åˆ†ç‰‡é”®è®¾è®¡ç­–ç•¥](#3-åˆ†ç‰‡é”®è®¾è®¡ç­–ç•¥)
4. [æ•°æ®é‡æ–°åˆ†å¸ƒæœºåˆ¶](#4-æ•°æ®é‡æ–°åˆ†å¸ƒæœºåˆ¶)
5. [è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†](#5-è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†)
6. [åˆ†ç‰‡ç›‘æ§ä¸ç®¡ç†](#6-åˆ†ç‰‡ç›‘æ§ä¸ç®¡ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ•°æ®åˆ†ç‰‡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åˆ†ç‰‡


ğŸ’­ **ç®€å•ç†è§£**ï¼šæ•°æ®åˆ†ç‰‡å°±åƒæŠŠä¸€æœ¬å¾ˆåšçš„ä¹¦åˆ†æˆå¥½å‡ æœ¬å°å†Œå­ï¼Œæ¯æœ¬å°å†Œå­æ”¾åœ¨ä¸åŒçš„ä¹¦æ¶ä¸Šã€‚

**ğŸ·ï¸ ä¸“ä¸šæœ¯è¯­**ï¼š`æ•°æ®åˆ†ç‰‡(Sharding)` = å°†å¤§å‹æ•°æ®åº“æŒ‰ç…§ä¸€å®šè§„åˆ™æ‹†åˆ†æˆå¤šä¸ªè¾ƒå°çš„æ•°æ®åº“ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Š

```
ä¼ ç»Ÿå•åº“æ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç”¨æˆ·è¡¨(1000ä¸‡)    â”‚  â† æ‰€æœ‰æ•°æ®åœ¨ä¸€ä¸ªåº“
â”‚   è®¢å•è¡¨(5000ä¸‡)    â”‚
â”‚   å•†å“è¡¨(100ä¸‡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†ç‰‡åçš„æ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¡¨1     â”‚ â”‚ ç”¨æˆ·è¡¨2     â”‚ â”‚ ç”¨æˆ·è¡¨3     â”‚
â”‚ (333ä¸‡)     â”‚ â”‚ (333ä¸‡)     â”‚ â”‚ (334ä¸‡)     â”‚
â”‚ è®¢å•è¡¨1     â”‚ â”‚ è®¢å•è¡¨2     â”‚ â”‚ è®¢å•è¡¨3     â”‚
â”‚ (1666ä¸‡)    â”‚ â”‚ (1667ä¸‡)    â”‚ â”‚ (1667ä¸‡)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    åˆ†ç‰‡1          åˆ†ç‰‡2          åˆ†ç‰‡3
```

### 1.2 ä¸ºä»€ä¹ˆè¦åˆ†ç‰‡


ğŸ¤” **ä¸ºä»€ä¹ˆè¿™æ ·**ï¼šå°±åƒä¸€ä¸ªäººæ¬ä¸åŠ¨é‡ç®±å­ï¼Œä½†æ˜¯ä¸‰ä¸ªäººåˆ†æ‹…å°±å¾ˆè½»æ¾

**ğŸ“Š åˆ†ç‰‡è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š

| é—®é¢˜ç±»å‹ | **ä¼ ç»Ÿå•åº“ç—›ç‚¹** | **åˆ†ç‰‡åçš„æ”¹å–„** |
|---------|----------------|-----------------|
| ğŸš€ **æ€§èƒ½** | `å•åº“æ‰¿è½½æ‰€æœ‰è¯»å†™ï¼Œæˆä¸ºç“¶é¢ˆ` | `è´Ÿè½½åˆ†æ•£åˆ°å¤šä¸ªåº“ï¼Œæå‡å¹¶å‘` |
| ğŸ’¾ **å­˜å‚¨** | `å•åº“æ•°æ®é‡è¿‡å¤§ï¼ŒæŸ¥è¯¢å˜æ…¢` | `æ¯ä¸ªåˆ†ç‰‡æ•°æ®é‡å‡å°‘ï¼ŒæŸ¥è¯¢æ›´å¿«` |
| ğŸ”§ **ç»´æŠ¤** | `å¤‡ä»½ã€æ¢å¤æ—¶é—´è¿‡é•¿` | `åˆ†ç‰‡ç‹¬ç«‹ç»´æŠ¤ï¼Œå½±å“èŒƒå›´å°` |
| ğŸ“ˆ **æ‰©å±•** | `å‚ç›´æ‰©å±•æˆæœ¬é«˜æ˜‚` | `æ°´å¹³æ‰©å±•ï¼Œæˆæœ¬çº¿æ€§å¢é•¿` |

### 1.3 åˆ†ç‰‡çš„åŸºæœ¬ç±»å‹


**ğŸ—ï¸ åˆ†ç‰‡æ¶æ„åˆ†ç±»**ï¼š

```
æ°´å¹³åˆ†ç‰‡ï¼ˆæ¨èï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users       â”‚    â”‚ users       â”‚
â”‚ id: 1-1000  â”‚    â”‚ id: 1001-2000â”‚
â”‚ name: ...   â”‚    â”‚ name: ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ç›¸åŒç»“æ„           ç›¸åŒç»“æ„
   ä¸åŒæ•°æ®           ä¸åŒæ•°æ®

å‚ç›´åˆ†ç‰‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users       â”‚    â”‚ orders      â”‚
â”‚ id          â”‚    â”‚ id          â”‚
â”‚ name        â”‚    â”‚ user_id     â”‚
â”‚ email       â”‚    â”‚ amount      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ä¸åŒè¡¨             ä¸åŒè¡¨
```

**âœ… æ­£ç¡®ç†è§£**ï¼š
- **æ°´å¹³åˆ†ç‰‡**ï¼šåŒä¸€å¼ è¡¨çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªåº“ï¼ˆæŒ‰è¡Œæ‹†åˆ†ï¼‰
- **å‚ç›´åˆ†ç‰‡**ï¼šä¸åŒçš„è¡¨åˆ†æ•£åˆ°å¤šä¸ªåº“ï¼ˆæŒ‰è¡¨æ‹†åˆ†ï¼‰
- **æ··åˆåˆ†ç‰‡**ï¼šåŒæ—¶ä½¿ç”¨æ°´å¹³å’Œå‚ç›´åˆ†ç‰‡

---

## 2. âš™ï¸ åˆ†ç‰‡ç®—æ³•è¯¦è§£


### 2.1 å“ˆå¸Œåˆ†ç‰‡ç®—æ³•


ğŸŒ° **ä¸¾ä¸ªä¾‹å­**ï¼šå°±åƒå‘æ‰‘å…‹ç‰Œï¼ŒæŒ‰ç…§ç‰Œçš„èŠ±è‰²ï¼ˆâ™ ï¸â™¥ï¸â™£ï¸â™¦ï¸ï¼‰æ¥åˆ†ç»™å››ä¸ªäºº

**ğŸ“‹ åŸºæœ¬å“ˆå¸Œåˆ†ç‰‡**ï¼š

```sql
-- ç®€å•å–æ¨¡åˆ†ç‰‡
åˆ†ç‰‡ç¼–å· = hash(åˆ†ç‰‡é”®) % åˆ†ç‰‡æ•°é‡

-- å®é™…ä¾‹å­
ç”¨æˆ·ID = 12345
åˆ†ç‰‡ç¼–å· = hash(12345) % 4 = 1
è¯¥ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨ç¬¬1å·åˆ†ç‰‡
```

**ğŸ’¡ å“ˆå¸Œåˆ†ç‰‡çš„ç‰¹ç‚¹**ï¼š

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| âœ… **åˆ†å¸ƒå‡åŒ€**ï¼šæ•°æ®æ•£åˆ—ç›¸å¯¹å¹³å‡ | âŒ **æ‰©å®¹å›°éš¾**ï¼šå¢åŠ åˆ†ç‰‡éœ€è¦å¤§é‡æ•°æ®è¿ç§» |
| âœ… **æŸ¥è¯¢ç®€å•**ï¼šæ ¹æ®åˆ†ç‰‡é”®ç›´æ¥å®šä½ | âŒ **èŒƒå›´æŸ¥è¯¢å·®**ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢å¤æ‚ |
| âœ… **è´Ÿè½½å‡è¡¡**ï¼šå„åˆ†ç‰‡å‹åŠ›ç›¸è¿‘ | âŒ **ä¸æ”¯æŒåŒºé—´**ï¼šæ— æ³•æŒ‰èŒƒå›´åˆ†ç‰‡ |

### 2.2 ä¸€è‡´æ€§å“ˆå¸Œåˆ†ç‰‡


ğŸ’­ **æ€è€ƒä¸€ä¸‹**ï¼šæ™®é€šå“ˆå¸Œåˆ†ç‰‡åŠ å‡èŠ‚ç‚¹æ—¶ï¼Œå‡ ä¹æ‰€æœ‰æ•°æ®éƒ½è¦é‡æ–°åˆ†å¸ƒï¼Œèƒ½ä¸èƒ½åªè¿ç§»ä¸€å°éƒ¨åˆ†ï¼Ÿ

**ğŸ” æ·±å…¥ç†è§£**ï¼šä¸€è‡´æ€§å“ˆå¸Œå°±åƒä¸€ä¸ªåœ†å½¢è·‘é“ï¼ŒæœåŠ¡å™¨å’Œæ•°æ®éƒ½åœ¨è·‘é“ä¸Šæœ‰è‡ªå·±çš„ä½ç½®

```
ä¸€è‡´æ€§å“ˆå¸Œç¯ç¤ºæ„ï¼š
                0
                â”‚
    Server C â—„â”€â”€â”¼â”€â”€â–º hash(key1)
             \  â”‚  /
              \ â”‚ /
         270 â”€â”€â”¼â”€â”€â”€â”€ 90
              / â”‚ \
             /  â”‚  \
    hash(key2) â—„â”€â”€â”¼â”€â”€â–º Server A
                â”‚
               180
             Server B

æ•°æ®åˆ†å¸ƒè§„åˆ™ï¼šé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹
```

**ğŸ”‘ å…³é”®è¯æå–**ï¼š
- **å“ˆå¸Œç¯**ï¼š0åˆ°2^32-1çš„åœ†å½¢ç©ºé—´
- **è™šæ‹ŸèŠ‚ç‚¹**ï¼šæ¯ä¸ªç‰©ç†æœåŠ¡å™¨å¯¹åº”å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹
- **é¡ºæ—¶é’ˆæŸ¥æ‰¾**ï¼šæ•°æ®å­˜å‚¨åˆ°é¡ºæ—¶é’ˆæ–¹å‘ç¬¬ä¸€ä¸ªæœåŠ¡å™¨

```python
# ä¸€è‡´æ€§å“ˆå¸Œç®€åŒ–å®ç°
class ConsistentHash:
    def __init__(self):
        self.ring = {}  # å“ˆå¸Œç¯
        self.sorted_keys = []  # æ’åºçš„å“ˆå¸Œå€¼
    
    def add_server(self, server):
        """æ·»åŠ æœåŠ¡å™¨èŠ‚ç‚¹"""
        for i in range(3):  # åˆ›å»º3ä¸ªè™šæ‹ŸèŠ‚ç‚¹
            virtual_key = hash(f"{server}:{i}")
            self.ring[virtual_key] = server
            self.sorted_keys.append(virtual_key)
        self.sorted_keys.sort()
    
    def get_server(self, key):
        """è·å–æ•°æ®åº”è¯¥å­˜å‚¨çš„æœåŠ¡å™¨"""
        if not self.ring:
            return None
        
        hash_key = hash(key)
        # æ‰¾åˆ°é¡ºæ—¶é’ˆæ–¹å‘ç¬¬ä¸€ä¸ªæœåŠ¡å™¨
        for ring_key in self.sorted_keys:
            if hash_key <= ring_key:
                return self.ring[ring_key]
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¯ä¸Šç¬¬ä¸€ä¸ªæœåŠ¡å™¨
        return self.ring[self.sorted_keys[0]]
```

### 2.3 èŒƒå›´åˆ†ç‰‡ç­–ç•¥


ğŸŒ° **ä¸¾ä¸ªä¾‹å­**ï¼šå°±åƒå›¾ä¹¦é¦†æŒ‰ç…§ä¹¦çš„ç¼–å·èŒƒå›´æ¥åˆ†é…ä¹¦æ¶ï¼ŒA-Fç±»åœ¨1å·ä¹¦æ¶ï¼ŒG-Mç±»åœ¨2å·ä¹¦æ¶

**ğŸ“Š èŒƒå›´åˆ†ç‰‡ç¤ºä¾‹**ï¼š

```
æŒ‰ç”¨æˆ·IDèŒƒå›´åˆ†ç‰‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ†ç‰‡1         â”‚ â”‚   åˆ†ç‰‡2         â”‚ â”‚   åˆ†ç‰‡3         â”‚
â”‚ ID: 1-100000    â”‚ â”‚ ID: 100001-     â”‚ â”‚ ID: 200001-     â”‚
â”‚               â”‚ â”‚     200000      â”‚ â”‚     300000      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‰æ—¶é—´èŒƒå›´åˆ†ç‰‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   2024å¹´æ•°æ®    â”‚ â”‚   2025å¹´æ•°æ®    â”‚ â”‚   2026å¹´æ•°æ®    â”‚
â”‚               â”‚ â”‚               â”‚ â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**â­ é‡ç‚¹æ ‡è®°**ï¼šèŒƒå›´åˆ†ç‰‡çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯**èŒƒå›´æŸ¥è¯¢å‹å¥½**

| åœºæ™¯ | **é€‚ç”¨æ€§** | **æ€§èƒ½è¡¨ç°** |
|------|-----------|------------|
| ğŸ” **èŒƒå›´æŸ¥è¯¢** | â˜…â˜…â˜…â˜…â˜… | `SELECT * WHERE id BETWEEN 1000 AND 2000` |
| ğŸ“Š **æ’åºæŸ¥è¯¢** | â˜…â˜…â˜…â˜…â˜† | `ORDER BY create_time` æ€§èƒ½å¥½ |
| ğŸ¯ **ç²¾ç¡®æŸ¥è¯¢** | â˜…â˜…â˜…â˜†â˜† | éœ€è¦ç¡®å®šåˆ†ç‰‡ä½ç½® |
| âš–ï¸ **è´Ÿè½½å‡è¡¡** | â˜…â˜…â˜†â˜†â˜† | å®¹æ˜“å‡ºç°çƒ­ç‚¹åˆ†ç‰‡ |

---

## 3. ğŸ¯ åˆ†ç‰‡é”®è®¾è®¡ç­–ç•¥


### 3.1 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™


ğŸ“ **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡å¦‚ä½•é€‰æ‹©æœ€é€‚åˆçš„åˆ†ç‰‡é”®ï¼Œè¿™æ˜¯åˆ†ç‰‡æˆåŠŸçš„å…³é”®

**ğŸ·ï¸ ä¸“ä¸šæœ¯è¯­**ï¼š`åˆ†ç‰‡é”®(Shard Key)` = ç”¨æ¥å†³å®šæ•°æ®åˆ†å¸ƒåˆ°å“ªä¸ªåˆ†ç‰‡çš„å­—æ®µ

**ğŸ“‹ é€‰æ‹©åˆ†ç‰‡é”®çš„é»„é‡‘æ³•åˆ™**ï¼š

```
ç†æƒ³çš„åˆ†ç‰‡é”®åº”è¯¥æ»¡è¶³ï¼š
âœ… åˆ†å¸ƒå‡åŒ€ï¼šé¿å…æ•°æ®å€¾æ–œ
âœ… æŸ¥è¯¢å‹å¥½ï¼šå¤§éƒ¨åˆ†æŸ¥è¯¢éƒ½åŒ…å«åˆ†ç‰‡é”®
âœ… é¿å…çƒ­ç‚¹ï¼šä¸ä¼šå¯¼è‡´æŸä¸ªåˆ†ç‰‡è¿‡äºç¹å¿™
âœ… ä¸šåŠ¡ç›¸å…³ï¼šç¬¦åˆä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼
âœ… ä¸å¯å˜æ€§ï¼šåˆ†ç‰‡é”®å€¼ä¸åº”è¯¥ç»å¸¸å˜åŒ–
```

### 3.2 å¸¸è§åˆ†ç‰‡é”®é€‰æ‹©


**ğŸ”¢ ç”¨æˆ·IDåˆ†ç‰‡**ï¼š

```sql
-- ç”¨æˆ·ç›¸å…³è¡¨æŒ‰user_idåˆ†ç‰‡
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100)
    -- åˆ†ç‰‡é”®ï¼šuser_id
);

CREATE TABLE orders (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,  -- åˆ†ç‰‡é”®ï¼šuser_id
    amount DECIMAL(10,2)
);
```

**ğŸŒ° ä¸¾ä¸ªä¾‹å­**ï¼šç”µå•†ç³»ç»Ÿç”¨user_idåˆ†ç‰‡
```
ä¼˜åŠ¿ï¼š
âœ… ç”¨æˆ·ç›¸å…³æ•°æ®èšé›†åœ¨åŒä¸€åˆ†ç‰‡
âœ… æŸ¥è¯¢ç”¨æˆ·è®¢å•ã€ç”¨æˆ·ä¿¡æ¯æ— éœ€è·¨åˆ†ç‰‡
âœ… ç”¨æˆ·ç»´åº¦çš„äº‹åŠ¡å¯ä»¥ä¿è¯

åŠ£åŠ¿ï¼š
âŒ æŒ‰å•†å“ç»Ÿè®¡éœ€è¦è·¨åˆ†ç‰‡æŸ¥è¯¢
âŒ å¯èƒ½å‡ºç°å¤§Vç”¨æˆ·çš„çƒ­ç‚¹é—®é¢˜
```

**ğŸ“… æ—¶é—´åˆ†ç‰‡**ï¼š

```sql
-- æ—¥å¿—è¡¨æŒ‰æ—¶é—´åˆ†ç‰‡
CREATE TABLE access_logs (
    id BIGINT AUTO_INCREMENT,
    user_id BIGINT,
    access_time DATETIME,  -- åˆ†ç‰‡é”®ï¼šæŒ‰æœˆåˆ†ç‰‡
    url VARCHAR(500)
);

-- åˆ†ç‰‡è§„åˆ™ï¼šæŒ‰æœˆåˆ›å»ºåˆ†ç‰‡
access_logs_202401  -- 2024å¹´1æœˆ
access_logs_202402  -- 2024å¹´2æœˆ
access_logs_202403  -- 2024å¹´3æœˆ
```

### 3.3 å¤åˆåˆ†ç‰‡é”®ç­–ç•¥


ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šæœ‰æ—¶å€™å•ä¸€å­—æ®µæ— æ³•æ»¡è¶³åˆ†ç‰‡éœ€æ±‚ï¼Œéœ€è¦ç»„åˆå¤šä¸ªå­—æ®µ

```sql
-- åœ°åŒº+æ—¶é—´å¤åˆåˆ†ç‰‡é”®
CREATE TABLE sales_data (
    id BIGINT PRIMARY KEY,
    region_id INT,        -- åœ°åŒºID
    sale_date DATE,       -- é”€å”®æ—¥æœŸ
    amount DECIMAL(10,2),
    -- å¤åˆåˆ†ç‰‡é”®ï¼šregion_id + sale_date
    SHARD_KEY(region_id, YEAR(sale_date))
);
```

**ğŸ—ï¸ å¤åˆåˆ†ç‰‡é”®çš„è·¯ç”±é€»è¾‘**ï¼š

```python
def get_shard_id(region_id, sale_date):
    """å¤åˆåˆ†ç‰‡é”®è·¯ç”±ç®—æ³•"""
    year = sale_date.year
    month = sale_date.month
    
    # å…ˆæŒ‰åœ°åŒºç²—åˆ†ï¼Œå†æŒ‰æ—¶é—´ç»†åˆ†
    region_shard = region_id % 4  # 4ä¸ªåœ°åŒºåˆ†ç‰‡ç»„
    time_shard = month % 3        # æ¯ç»„å†…æŒ‰å­£åº¦åˆ†3ä¸ªåˆ†ç‰‡
    
    final_shard = region_shard * 3 + time_shard
    return final_shard

# ç¤ºä¾‹ï¼šåå—åœ°åŒº(region_id=1) 2024å¹´3æœˆçš„æ•°æ®
# region_shard = 1 % 4 = 1
# time_shard = 3 % 3 = 0  
# final_shard = 1 * 3 + 0 = 3
# æ•°æ®å­˜å‚¨åœ¨ç¬¬3å·åˆ†ç‰‡
```

### 3.4 åˆ†ç‰‡é”®è®¾è®¡åæ¨¡å¼


ğŸš¨ **é‡è¦æé†’**ï¼šé¿å…è¿™äº›å¸¸è§çš„åˆ†ç‰‡é”®é€‰æ‹©é”™è¯¯

**âŒ å¸¸è§è¯¯è§£**ï¼š

| é”™è¯¯åšæ³• | **é—®é¢˜æ‰€åœ¨** | **æ­£ç¡®åšæ³•** |
|---------|------------|------------|
| ğŸ² **éšæœºUUID** | `æ— æ³•æ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œå®Œå…¨éšæœº` | `æœ‰åºIDæˆ–æ—¶é—´æˆ³` |
| ğŸ“ˆ **è‡ªå¢ID** | `å†™å…¥çƒ­ç‚¹ï¼Œæœ€åä¸€ä¸ªåˆ†ç‰‡å‹åŠ›å¤§` | `å“ˆå¸Œåçš„IDæˆ–å¤åˆé”®` |
| ğŸŒ¡ï¸ **ä½åŸºæ•°å­—æ®µ** | `åˆ†å¸ƒä¸å‡ï¼Œå¦‚æ€§åˆ«ã€çŠ¶æ€ç­‰` | `é«˜åŸºæ•°å­—æ®µå¦‚ç”¨æˆ·ID` |
| ğŸ”„ **é¢‘ç¹å˜åŒ–** | `åˆ†ç‰‡é”®å˜åŒ–å¯¼è‡´æ•°æ®è¿ç§»` | `ç›¸å¯¹ç¨³å®šçš„ä¸šåŠ¡é”®` |

```sql
-- åä¾‹ï¼šç”¨æ€§åˆ«ä½œä¸ºåˆ†ç‰‡é”®
CREATE TABLE users (
    user_id BIGINT,
    gender ENUM('M', 'F'),  -- âŒ é”™è¯¯ï¼šåªæœ‰2ä¸ªå€¼ï¼Œåˆ†å¸ƒæä¸å‡åŒ€
    name VARCHAR(50)
);

-- æ­£ä¾‹ï¼šç”¨ç”¨æˆ·IDå“ˆå¸Œå€¼ä½œä¸ºåˆ†ç‰‡é”®
CREATE TABLE users (
    user_id BIGINT,         -- âœ… æ­£ç¡®ï¼šé«˜åŸºæ•°ï¼Œåˆ†å¸ƒå‡åŒ€
    gender ENUM('M', 'F'),
    name VARCHAR(50)
);
```

---

## 4. ğŸ”„ æ•°æ®é‡æ–°åˆ†å¸ƒæœºåˆ¶


### 4.1 åˆ†ç‰‡æ‰©å®¹åœºæ™¯


ğŸ’­ **æ€è€ƒä¸€ä¸‹**ï¼šå½“æ•°æ®é‡å¢é•¿ï¼ŒåŸæœ‰åˆ†ç‰‡ä¸å¤Ÿç”¨æ—¶ï¼Œå¦‚ä½•å®‰å…¨åœ°å¢åŠ æ–°åˆ†ç‰‡ï¼Ÿ

**ğŸ¯ å…¸å‹æ‰©å®¹åœºæ™¯**ï¼š

```
åŸå§‹æ¶æ„ï¼ˆ3ä¸ªåˆ†ç‰‡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†ç‰‡0   â”‚ â”‚ åˆ†ç‰‡1   â”‚ â”‚ åˆ†ç‰‡2   â”‚
â”‚ æ•°æ®é‡  â”‚ â”‚ æ•°æ®é‡  â”‚ â”‚ æ•°æ®é‡  â”‚
â”‚ 80%æ»¡   â”‚ â”‚ 85%æ»¡   â”‚ â”‚ 90%æ»¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰©å®¹åæ¶æ„ï¼ˆ6ä¸ªåˆ†ç‰‡ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”
â”‚åˆ†ç‰‡0â”‚â”‚åˆ†ç‰‡1â”‚â”‚åˆ†ç‰‡2â”‚â”‚åˆ†ç‰‡3â”‚â”‚åˆ†ç‰‡4â”‚â”‚åˆ†ç‰‡5â”‚
â”‚45% â”‚â”‚40% â”‚â”‚50% â”‚â”‚æ–°å»ºâ”‚â”‚æ–°å»ºâ”‚â”‚æ–°å»ºâ”‚
â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®è¿ç§»ç­–ç•¥


**ğŸ”§ æ¸è¿›å¼è¿ç§»æ–¹æ¡ˆ**ï¼š

```python
class DataMigration:
    def __init__(self, old_shards, new_shards):
        self.old_shards = old_shards
        self.new_shards = new_shards
        self.migration_status = {}
    
    def migrate_shard_data(self, table_name):
        """åˆ†ç‰‡æ•°æ®è¿ç§»ä¸»æµç¨‹"""
        print("ğŸš€ å¼€å§‹æ•°æ®è¿ç§»...")
        
        # ç¬¬1æ­¥ï¼šåœæ­¢å†™å…¥ï¼ˆå¯é€‰ï¼Œæˆ–é‡‡ç”¨åŒå†™æ¨¡å¼ï¼‰
        self.stop_writes(table_name)
        
        # ç¬¬2æ­¥ï¼šæ•°æ®å¤åˆ¶
        self.copy_data(table_name)
        
        # ç¬¬3æ­¥ï¼šæ•°æ®æ ¡éªŒ
        if self.validate_data(table_name):
            # ç¬¬4æ­¥ï¼šåˆ‡æ¢è·¯ç”±
            self.switch_routing(table_name)
            print("âœ… è¿ç§»å®Œæˆ")
        else:
            print("âŒ æ•°æ®æ ¡éªŒå¤±è´¥ï¼Œå›æ»šè¿ç§»")
            self.rollback_migration(table_name)
    
    def copy_data(self, table_name):
        """æ•°æ®å¤åˆ¶è¿‡ç¨‹"""
        batch_size = 10000  # æ¯æ‰¹å¤„ç†1ä¸‡æ¡
        
        for old_shard_id in range(len(self.old_shards)):
            print(f"ğŸ“¦ è¿ç§»åˆ†ç‰‡ {old_shard_id} çš„æ•°æ®...")
            
            offset = 0
            while True:
                # åˆ†æ‰¹è¯»å–æ•°æ®
                batch_data = self.read_batch_data(
                    old_shard_id, table_name, offset, batch_size
                )
                
                if not batch_data:
                    break  # æ²¡æœ‰æ›´å¤šæ•°æ®
                
                # é‡æ–°è®¡ç®—æ¯æ¡æ•°æ®çš„æ–°åˆ†ç‰‡ä½ç½®
                for row in batch_data:
                    new_shard_id = self.calculate_new_shard(row)
                    self.write_to_new_shard(new_shard_id, row)
                
                offset += batch_size
                print(f"ğŸ“Š å·²è¿ç§» {offset} æ¡è®°å½•...")
```

**âš¡ å¿«é€Ÿå›é¡¾**ï¼šæ•°æ®è¿ç§»çš„å…³é”®æ­¥éª¤
1. **åœå†™ä¿æŠ¤**ï¼šç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®ä¸€è‡´æ€§
2. **åˆ†æ‰¹å¤åˆ¶**ï¼šé¿å…å¤§äº‹åŠ¡ï¼Œå‡å°‘é”å®šæ—¶é—´
3. **æ•°æ®æ ¡éªŒ**ï¼šç¡®ä¿è¿ç§»æ•°æ®å®Œæ•´æ€§
4. **è·¯ç”±åˆ‡æ¢**ï¼šåŸå­æ€§åœ°åˆ‡æ¢åˆ°æ–°åˆ†ç‰‡æ¶æ„
5. **å›æ»šæœºåˆ¶**ï¼šå‡ºç°é—®é¢˜æ—¶èƒ½å¿«é€Ÿæ¢å¤

### 4.3 åœ¨çº¿æ‰©å®¹æŠ€æœ¯


ğŸ› ï¸ **å·¥å…·æ¨è**ï¼šä¸šç•Œå¸¸ç”¨çš„åœ¨çº¿æ‰©å®¹æ–¹æ¡ˆ

**ğŸ“Š åŒå†™æ¨¡å¼æ‰©å®¹**ï¼š

```
åŒå†™é˜¶æ®µï¼š
åº”ç”¨ â”€â”€â”¬â”€â”€â–º è€åˆ†ç‰‡ (è¯»å†™)
       â””â”€â”€â–º æ–°åˆ†ç‰‡ (ä»…å†™)
       
æ•°æ®åŒæ­¥é˜¶æ®µï¼š
è€åˆ†ç‰‡ â”€â”€â”€â”€ æ•°æ®å¤åˆ¶ â”€â”€â”€â–º æ–°åˆ†ç‰‡

åˆ‡æ¢é˜¶æ®µï¼š
åº”ç”¨ â”€â”€â”€â”€â”€â”€â–º æ–°åˆ†ç‰‡ (è¯»å†™)
è€åˆ†ç‰‡ (åœç”¨)
```

```java
// åŒå†™æ¨¡å¼ç¤ºä¾‹ä»£ç 
public class DualWriteShardingService {
    private ShardingService oldSharding;
    private ShardingService newSharding;
    private boolean migrationMode = true;
    
    public void insertUser(User user) {
        // åŒå†™æ¨¡å¼ï¼šåŒæ—¶å†™å…¥æ–°è€åˆ†ç‰‡
        if (migrationMode) {
            oldSharding.insert(user);  // å†™å…¥è€åˆ†ç‰‡
            newSharding.insert(user);  // å†™å…¥æ–°åˆ†ç‰‡
        } else {
            newSharding.insert(user);  // åªå†™æ–°åˆ†ç‰‡
        }
    }
    
    public User findUser(long userId) {
        // è¯»å–æ—¶ä¼˜å…ˆä»è€åˆ†ç‰‡è¯»ï¼Œç¡®ä¿æ•°æ®å®Œæ•´
        if (migrationMode) {
            return oldSharding.findUser(userId);
        } else {
            return newSharding.findUser(userId);
        }
    }
}
```

### 4.4 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


ğŸ¯ **æœ€ä½³å®è·µ**ï¼šç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸€è‡´æ€§

```sql
-- è¿ç§»å‰æ•°æ®æ ¡éªŒSQL
SELECT 
    shard_id,
    COUNT(*) as record_count,
    MAX(updated_at) as last_update_time,
    CHECKSUM TABLE users_shard_{shard_id}
FROM migration_status 
GROUP BY shard_id;

-- è¿ç§»åä¸€è‡´æ€§æ£€æŸ¥
SELECT 
    old_shard.shard_id,
    old_shard.record_count - new_shard.record_count as diff_count
FROM old_shard_stats old_shard
JOIN new_shard_stats new_shard ON old_shard.shard_id = new_shard.shard_id
WHERE old_shard.record_count != new_shard.record_count;
```

---

## 5. ğŸ”— è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†


### 5.1 è·¨åˆ†ç‰‡æŸ¥è¯¢æŒ‘æˆ˜


ğŸ¤” **ä¸ºä»€ä¹ˆè¿™æ ·**ï¼šåˆ†ç‰‡åæœ€å¤§çš„æŒ‘æˆ˜å°±æ˜¯åŸæœ¬ç®€å•çš„æŸ¥è¯¢å˜å¾—å¤æ‚

**ğŸ’¥ å®¹æ˜“å‡ºé”™**ï¼šæ–°æ‰‹å¸¸çŠ¯çš„è·¨åˆ†ç‰‡æŸ¥è¯¢é”™è¯¯

```sql
-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šè·¨åˆ†ç‰‡JOINæŸ¥è¯¢
SELECT u.username, o.amount 
FROM users u 
JOIN orders o ON u.user_id = o.user_id 
WHERE o.amount > 1000;

-- é—®é¢˜ï¼šuserså’Œorderså¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒåˆ†ç‰‡ä¸Š
-- ä¼ ç»Ÿå•åº“å¯ä»¥ç›´æ¥JOINï¼Œåˆ†ç‰‡åéœ€è¦ç‰¹æ®Šå¤„ç†
```

**ğŸ“‹ è·¨åˆ†ç‰‡æŸ¥è¯¢çš„å¸¸è§ç±»å‹**ï¼š

| æŸ¥è¯¢ç±»å‹ | **å¤æ‚åº¦** | **å¤„ç†æ–¹å¼** | **æ€§èƒ½å½±å“** |
|---------|-----------|------------|------------|
| ğŸ¯ **å•åˆ†ç‰‡æŸ¥è¯¢** | â˜…â˜†â˜†â˜†â˜† | `ç›´æ¥è·¯ç”±åˆ°ç›®æ ‡åˆ†ç‰‡` | `æ— å½±å“` |
| ğŸ” **å¤šåˆ†ç‰‡èšåˆ** | â˜…â˜…â˜…â˜†â˜† | `åˆ†ç‰‡èšåˆ+ç»“æœåˆå¹¶` | `ä¸­ç­‰` |
| ğŸ”— **è·¨åˆ†ç‰‡JOIN** | â˜…â˜…â˜…â˜…â˜† | `æ•°æ®æ”¶é›†+å†…å­˜JOIN` | `è¾ƒå¤§` |
| ğŸ“Š **å…¨å±€æ’åº** | â˜…â˜…â˜…â˜…â˜… | `åˆ†ç‰‡æ’åº+å½’å¹¶æ’åº` | `å¾ˆå¤§` |

### 5.2 åˆ†ç‰‡è·¯ç”±è§„åˆ™


**ğŸ”‘ å…³é”®è¯æå–**ï¼šSQLè·¯ç”±ã€åˆ†ç‰‡å®šä½ã€æŸ¥è¯¢è®¡åˆ’

```python
class ShardingRouter:
    def __init__(self, shard_config):
        self.shard_config = shard_config
    
    def route_query(self, sql, params):
        """SQLæŸ¥è¯¢è·¯ç”±å†³ç­–"""
        query_type = self.parse_query_type(sql)
        
        if query_type == 'SINGLE_SHARD':
            # å•åˆ†ç‰‡æŸ¥è¯¢ï¼šç›´æ¥è·¯ç”±
            shard_id = self.calculate_shard_id(params['shard_key'])
            return [shard_id]
            
        elif query_type == 'MULTI_SHARD':
            # å¤šåˆ†ç‰‡æŸ¥è¯¢ï¼šå¹¿æ’­åˆ°æ‰€æœ‰åˆ†ç‰‡
            return list(range(self.shard_config.total_shards))
            
        elif query_type == 'RANGE_SHARD':
            # èŒƒå›´æŸ¥è¯¢ï¼šè®¡ç®—æ¶‰åŠçš„åˆ†ç‰‡
            return self.calculate_range_shards(params['start'], params['end'])
    
    def calculate_shard_id(self, shard_key):
        """è®¡ç®—åˆ†ç‰‡ID"""
        if isinstance(shard_key, int):
            return shard_key % self.shard_config.total_shards
        else:
            return hash(shard_key) % self.shard_config.total_shards
```

### 5.3 èšåˆæŸ¥è¯¢å¤„ç†


ğŸŒ° **ä¸¾ä¸ªä¾‹å­**ï¼šç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·çš„è®¢å•æ€»é‡‘é¢

```sql
-- åŸå§‹å•åº“æŸ¥è¯¢
SELECT SUM(amount) as total_amount FROM orders;

-- åˆ†ç‰‡åçš„å¤„ç†æµç¨‹
-- æ­¥éª¤1ï¼šå„åˆ†ç‰‡åˆ†åˆ«æ‰§è¡Œ
-- åˆ†ç‰‡0ï¼šSELECT SUM(amount) as shard_sum FROM orders; -- ç»“æœï¼š50000
-- åˆ†ç‰‡1ï¼šSELECT SUM(amount) as shard_sum FROM orders; -- ç»“æœï¼š60000  
-- åˆ†ç‰‡2ï¼šSELECT SUM(amount) as shard_sum FROM orders; -- ç»“æœï¼š55000

-- æ­¥éª¤2ï¼šåº”ç”¨å±‚åˆå¹¶ç»“æœ
-- total_amount = 50000 + 60000 + 55000 = 165000
```

**ğŸ”§ èšåˆæŸ¥è¯¢å¤„ç†ä»£ç **ï¼š

```java
public class CrossShardAggregator {
    
    public BigDecimal sumAcrossShards(String sql) {
        List<CompletableFuture<BigDecimal>> futures = new ArrayList<>();
        
        // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡
        for (int shardId = 0; shardId < totalShards; shardId++) {
            CompletableFuture<BigDecimal> future = CompletableFuture.supplyAsync(() -> {
                DataSource shardDs = getShardDataSource(shardId);
                return queryShardSum(shardDs, sql);
            });
            futures.add(future);
        }
        
        // æ”¶é›†å¹¶åˆå¹¶ç»“æœ
        BigDecimal totalSum = BigDecimal.ZERO;
        for (CompletableFuture<BigDecimal> future : futures) {
            totalSum = totalSum.add(future.get());
        }
        
        return totalSum;
    }
    
    public List<OrderSummary> groupByAcrossShards(String sql) {
        // è·¨åˆ†ç‰‡GROUP BYå¤„ç†
        Map<String, BigDecimal> globalGroups = new HashMap<>();
        
        for (int shardId = 0; shardId < totalShards; shardId++) {
            List<OrderSummary> shardResults = queryShardGroupBy(shardId, sql);
            
            // åˆå¹¶åˆ†ç»„ç»“æœ
            for (OrderSummary summary : shardResults) {
                globalGroups.merge(summary.getGroupKey(), 
                    summary.getAmount(), BigDecimal::add);
            }
        }
        
        return convertToSummaryList(globalGroups);
    }
}
```

### 5.4 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šåˆ†ç‰‡åçš„åˆ†é¡µæŸ¥è¯¢æ¯”å•åº“å¤æ‚å¾—å¤š

```sql
-- éš¾é¢˜ï¼šè·¨åˆ†ç‰‡çš„ORDER BY + LIMIT
SELECT * FROM orders 
ORDER BY create_time DESC 
LIMIT 10 OFFSET 20;
```

**ğŸ—ï¸ åˆ†é¡µæŸ¥è¯¢çš„å¤„ç†æ¶æ„**ï¼š

```
æŸ¥è¯¢æµç¨‹ï¼š
1. å„åˆ†ç‰‡æ‰§è¡Œï¼šSELECT * FROM orders ORDER BY create_time DESC LIMIT 30
   â”œâ”€ åˆ†ç‰‡0ï¼šè¿”å›30æ¡è®°å½•
   â”œâ”€ åˆ†ç‰‡1ï¼šè¿”å›30æ¡è®°å½•  
   â””â”€ åˆ†ç‰‡2ï¼šè¿”å›30æ¡è®°å½•

2. åº”ç”¨å±‚å½’å¹¶ï¼šå°†90æ¡è®°å½•æŒ‰create_timeé‡æ–°æ’åº

3. åº”ç”¨OFFSETå’ŒLIMITï¼šè·³è¿‡å‰20æ¡ï¼Œå–10æ¡ç»“æœ
```

```java
public class CrossShardPagination {
    
    public PageResult<Order> queryWithPagination(
            String sql, int offset, int limit) {
        
        // å…³é”®ï¼šæ¯ä¸ªåˆ†ç‰‡éœ€è¦æŸ¥è¯¢ offset + limit æ¡è®°å½•
        int shardLimit = offset + limit;
        
        List<Order> allResults = new ArrayList<>();
        
        // ä»æ‰€æœ‰åˆ†ç‰‡æ”¶é›†æ•°æ®
        for (int shardId = 0; shardId < totalShards; shardId++) {
            String shardSql = sql + " LIMIT " + shardLimit;
            List<Order> shardResults = queryFromShard(shardId, shardSql);
            allResults.addAll(shardResults);
        }
        
        // å…¨å±€æ’åº
        allResults.sort(Comparator.comparing(Order::getCreateTime).reversed());
        
        // åº”ç”¨åˆ†é¡µ
        int endIndex = Math.min(offset + limit, allResults.size());
        List<Order> pageData = allResults.subList(offset, endIndex);
        
        return new PageResult<>(pageData, allResults.size());
    }
}
```

**ğŸš¨ é‡è¦æé†’**ï¼šæ·±åº¦åˆ†é¡µé—®é¢˜
- **é—®é¢˜**ï¼š`LIMIT 100000, 20` éœ€è¦æ¯ä¸ªåˆ†ç‰‡è¿”å›100020æ¡è®°å½•
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿åç§»åˆ†é¡µ

```sql
-- æ¨èï¼šæ¸¸æ ‡åˆ†é¡µ
SELECT * FROM orders 
WHERE create_time < '2024-01-01 10:00:00'  -- ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åæ—¶é—´
ORDER BY create_time DESC 
LIMIT 20;
```

---

## 6. ğŸ“Š åˆ†ç‰‡ç›‘æ§ä¸ç®¡ç†


### 6.1 åˆ†ç‰‡ç›‘æ§æŒ‡æ ‡


ğŸ“š **å‰ç½®çŸ¥è¯†**ï¼šæœ‰æ•ˆçš„ç›‘æ§æ˜¯åˆ†ç‰‡é›†ç¾¤ç¨³å®šè¿è¡Œçš„åŸºç¡€

**ğŸ” æ ¸å¿ƒç›‘æ§ç»´åº¦**ï¼š

```
æ€§èƒ½ç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†ç‰‡æ€§èƒ½æŒ‡æ ‡                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ QPS (æ¯ç§’æŸ¥è¯¢æ•°)                  â”‚
â”‚ â€¢ å“åº”æ—¶é—´ (P50, P90, P99)          â”‚ 
â”‚ â€¢ é”™è¯¯ç‡                           â”‚
â”‚ â€¢ è¿æ¥æ•°ä½¿ç”¨ç‡                      â”‚
â”‚ â€¢ CPU/å†…å­˜/ç£ç›˜ä½¿ç”¨ç‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®åˆ†å¸ƒç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®å‡è¡¡æ€§æŒ‡æ ‡                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å„åˆ†ç‰‡æ•°æ®é‡                      â”‚
â”‚ â€¢ æ•°æ®å¢é•¿è¶‹åŠ¿                      â”‚
â”‚ â€¢ çƒ­ç‚¹åˆ†ç‰‡è¯†åˆ«                      â”‚
â”‚ â€¢ æ•°æ®å€¾æ–œç¨‹åº¦                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·


ğŸ› ï¸ **å·¥å…·æ¨è**ï¼šåˆ†ç‰‡é›†ç¾¤çš„è‡ªåŠ¨åŒ–ç®¡ç†

```python
class ShardMonitor:
    def __init__(self):
        self.alert_rules = {}
        self.metrics_collector = MetricsCollector()
    
    def collect_shard_metrics(self):
        """æ”¶é›†åˆ†ç‰‡ç›‘æ§æŒ‡æ ‡"""
        metrics = {}
        
        for shard_id in range(self.total_shards):
            shard_metrics = {
                'qps': self.get_shard_qps(shard_id),
                'response_time': self.get_response_time(shard_id),
                'data_size': self.get_data_size(shard_id),
                'connection_count': self.get_connection_count(shard_id)
            }
            metrics[f'shard_{shard_id}'] = shard_metrics
        
        return metrics
    
    def detect_hotspot_shards(self, metrics):
        """çƒ­ç‚¹åˆ†ç‰‡æ£€æµ‹"""
        avg_qps = sum(m['qps'] for m in metrics.values()) / len(metrics)
        
        hotspot_shards = []
        for shard_id, metric in metrics.items():
            if metric['qps'] > avg_qps * 2:  # QPSè¶…è¿‡å¹³å‡å€¼2å€
                hotspot_shards.append({
                    'shard_id': shard_id,
                    'qps': metric['qps'],
                    'avg_qps': avg_qps
                })
        
        return hotspot_shards
    
    def check_data_balance(self, metrics):
        """æ•°æ®å¹³è¡¡æ€§æ£€æŸ¥"""
        data_sizes = [m['data_size'] for m in metrics.values()]
        avg_size = sum(data_sizes) / len(data_sizes)
        max_size = max(data_sizes)
        min_size = min(data_sizes)
        
        # æ•°æ®å€¾æ–œåº¦ï¼šæœ€å¤§åˆ†ç‰‡ä¸æœ€å°åˆ†ç‰‡çš„æ¯”å€¼
        skew_ratio = max_size / min_size if min_size > 0 else float('inf')
        
        return {
            'average_size': avg_size,
            'skew_ratio': skew_ratio,
            'needs_rebalance': skew_ratio > 2.0  # å€¾æ–œåº¦è¶…è¿‡2éœ€è¦é‡å¹³è¡¡
        }
```

### 6.3 æ•…éšœå¤„ç†æœºåˆ¶


ğŸš¨ **é‡è¦æé†’**ï¼šåˆ†ç‰‡æ•…éšœçš„å¤„ç†ç­–ç•¥

**ğŸ“‹ æ•…éšœå¤„ç†æµç¨‹**ï¼š

```
æ•…éšœæ£€æµ‹ â†’ æ•…éšœéš”ç¦» â†’ æœåŠ¡é™çº§ â†’ æ•…éšœæ¢å¤

â”Œâ”€ æ•…éšœæ£€æµ‹ â”€â”   â”Œâ”€ æ•…éšœéš”ç¦» â”€â”   â”Œâ”€ æœåŠ¡é™çº§ â”€â”   â”Œâ”€ æ•…éšœæ¢å¤ â”€â”
â”‚ â€¢ å¥åº·æ£€æŸ¥  â”‚â†’ â”‚ â€¢ åœæ­¢è·¯ç”±  â”‚â†’ â”‚ â€¢ åªè¯»æ¨¡å¼  â”‚â†’ â”‚ â€¢ æ•°æ®åŒæ­¥  â”‚
â”‚ â€¢ è¶…æ—¶ç›‘æ§  â”‚   â”‚ â€¢ æ ‡è®°ä¸‹çº¿  â”‚   â”‚ â€¢ ç¼“å­˜å…œåº•  â”‚   â”‚ â€¢ é‡æ–°ä¸Šçº¿  â”‚
â”‚ â€¢ é”™è¯¯ç»Ÿè®¡  â”‚   â”‚ â€¢ å‘Šè­¦é€šçŸ¥  â”‚   â”‚ â€¢ éƒ¨åˆ†åŠŸèƒ½  â”‚   â”‚ â€¢ ç›‘æ§æ¢å¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
@Component
public class ShardFailoverManager {
    
    @Autowired
    private ShardHealthChecker healthChecker;
    
    @Autowired  
    private AlertManager alertManager;
    
    public void handleShardFailure(int failedShardId) {
        logger.error("æ£€æµ‹åˆ°åˆ†ç‰‡ {} æ•…éšœ", failedShardId);
        
        // 1. ç«‹å³éš”ç¦»æ•…éšœåˆ†ç‰‡
        isolateFailedShard(failedShardId);
        
        // 2. å‘é€å‘Šè­¦é€šçŸ¥
        alertManager.sendAlert("åˆ†ç‰‡æ•…éšœ", 
            "åˆ†ç‰‡ " + failedShardId + " å‘ç”Ÿæ•…éšœï¼Œå·²è‡ªåŠ¨éš”ç¦»");
        
        // 3. æ¿€æ´»å¤‡ç”¨åˆ†ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
        if (hasBackupShard(failedShardId)) {
            activateBackupShard(failedShardId);
        }
        
        // 4. å¯åŠ¨åªè¯»æ¨¡å¼
        enableReadOnlyMode(failedShardId);
        
        // 5. ç›‘æ§æ¢å¤çŠ¶æ€
        scheduleRecoveryCheck(failedShardId);
    }
    
    private void isolateFailedShard(int shardId) {
        // ä»è·¯ç”±è¡¨ä¸­ç§»é™¤æ•…éšœåˆ†ç‰‡
        shardRoutingTable.markShardDown(shardId);
        
        // åœæ­¢å‘è¯¥åˆ†ç‰‡å‘é€æ–°è¯·æ±‚
        connectionPool.closeConnectionsToShard(shardId);
    }
    
    private void enableReadOnlyMode(int affectedShardId) {
        // å—å½±å“çš„æŸ¥è¯¢åˆ‡æ¢åˆ°åªè¯»å‰¯æœ¬
        for (String tableName : getAffectedTables(affectedShardId)) {
            readOnlyService.enableForTable(tableName);
        }
    }
}
```

### 6.4 å®¹é‡è§„åˆ’


ğŸ“ˆ **è¿›é˜¶è·¯å¾„**ï¼šå¦‚ä½•è§„åˆ’åˆ†ç‰‡é›†ç¾¤çš„å®¹é‡

**ğŸ”¢ å®¹é‡è®¡ç®—å…¬å¼**ï¼š

```
å•åˆ†ç‰‡å®¹é‡ = æ€»æ•°æ®é‡ / åˆ†ç‰‡æ•°é‡
åˆ†ç‰‡æ•°é‡ = æ€»æ•°æ®é‡ / å•åˆ†ç‰‡ç†æƒ³å®¹é‡

è€ƒè™‘å› ç´ ï¼š
â€¢ å•åº“å®¹é‡ä¸Šé™ (å»ºè®®500GB-1TB)
â€¢ æŸ¥è¯¢æ€§èƒ½è¦æ±‚ (QPSç›®æ ‡)  
â€¢ ç¡¬ä»¶èµ„æºé™åˆ¶ (CPU/å†…å­˜/ç£ç›˜)
â€¢ ä¸šåŠ¡å¢é•¿é¢„æœŸ (æœªæ¥1-2å¹´)
```

**ğŸ“Š å®¹é‡è§„åˆ’ç¤ºä¾‹**ï¼š

```python
def calculate_shard_capacity():
    """åˆ†ç‰‡å®¹é‡è§„åˆ’è®¡ç®—"""
    
    # ä¸šåŠ¡æ•°æ®
    current_data_size = 2000  # GB
    daily_growth_rate = 0.02  # 2%æ—¥å¢é•¿
    query_qps_target = 10000  # ç›®æ ‡QPS
    
    # ç¡¬ä»¶é™åˆ¶
    single_shard_max_size = 500  # GB
    single_shard_max_qps = 3000
    
    # æŒ‰å­˜å‚¨å®¹é‡è®¡ç®—
    shards_by_storage = math.ceil(current_data_size / single_shard_max_size)
    
    # æŒ‰æ€§èƒ½è¦æ±‚è®¡ç®—
    shards_by_performance = math.ceil(query_qps_target / single_shard_max_qps)
    
    # è€ƒè™‘å¢é•¿çš„åˆ†ç‰‡æ•° (é¢„ç•™50%å¢é•¿ç©ºé—´)
    growth_factor = 1.5
    recommended_shards = max(shards_by_storage, shards_by_performance) * growth_factor
    
    return {
        'current_shards_needed': max(shards_by_storage, shards_by_performance),
        'recommended_shards': int(recommended_shards),
        'single_shard_data_size': current_data_size / recommended_shards,
        'single_shard_qps': query_qps_target / recommended_shards
    }
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—


**ğŸ¯ åˆ†ç‰‡ç®—æ³•é€‰æ‹©å†³ç­–æ ‘**ï¼š

```
æ•°æ®åˆ†ç‰‡ç­–ç•¥é€‰æ‹©ï¼š

ä¸šåŠ¡ç‰¹ç‚¹åˆ†æ
â”œâ”€ æŸ¥è¯¢æ¨¡å¼æ˜¯å¦å›ºå®šï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ èŒƒå›´åˆ†ç‰‡
â”‚  â””â”€ å¦ â†’ å“ˆå¸Œåˆ†ç‰‡
â”‚
â”œâ”€ æ˜¯å¦éœ€è¦é¢‘ç¹æ‰©å®¹ï¼Ÿ  
â”‚  â”œâ”€ æ˜¯ â†’ ä¸€è‡´æ€§å“ˆå¸Œ
â”‚  â””â”€ å¦ â†’ ç®€å•å“ˆå¸Œ
â”‚
â””â”€ æ•°æ®è®¿é—®æ˜¯å¦å‡åŒ€ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ç”¨æˆ·IDåˆ†ç‰‡
   â””â”€ å¦ â†’ å¤åˆåˆ†ç‰‡é”®
```

### 7.2 åˆ†ç‰‡å®æ–½æœ€ä½³å®è·µ


**âœ… åˆ†ç‰‡æˆåŠŸçš„å…³é”®è¦ç´ **ï¼š

| é˜¶æ®µ | **æ ¸å¿ƒè¦ç‚¹** | **å¸¸è§é™·é˜±** |
|------|------------|------------|
| ğŸ¯ **è®¾è®¡é˜¶æ®µ** | `é€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®ï¼Œè€ƒè™‘ä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼` | `ç›²ç›®é€‰æ‹©åˆ†ç‰‡é”®ï¼Œå¿½ç•¥ä¸šåŠ¡ç‰¹ç‚¹` |
| ğŸš€ **å®æ–½é˜¶æ®µ** | `åˆ†æ­¥éª¤è¿ç§»ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§` | `ä¸€æ¬¡æ€§è¿ç§»ï¼Œé£é™©è¿‡å¤§` |
| ğŸ“Š **è¿ç»´é˜¶æ®µ** | `æŒç»­ç›‘æ§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜` | `ç¼ºä¹ç›‘æ§ï¼Œæ•…éšœè¢«åŠ¨å‘ç°` |
| ğŸ“ˆ **ä¼˜åŒ–é˜¶æ®µ** | `åŸºäºç›‘æ§æ•°æ®è°ƒä¼˜ï¼Œå®šæœŸå®¹é‡è§„åˆ’` | `ç»éªŒä¸»ä¹‰è°ƒä¼˜ï¼Œç¼ºä¹æ•°æ®æ”¯æ’‘` |

### 7.3 æŠ€æœ¯é€‰å‹å»ºè®®


**ğŸ› ï¸ åˆ†ç‰‡æŠ€æœ¯æ ˆæ¨è**ï¼š

```
ä¸­é—´ä»¶æ–¹æ¡ˆï¼š
â”œâ”€ Sharding-JDBC  (å®¢æˆ·ç«¯åˆ†ç‰‡ï¼Œæ€§èƒ½å¥½)
â”œâ”€ MyCat         (ä»£ç†åˆ†ç‰‡ï¼Œé€æ˜åº¦é«˜)  
â”œâ”€ Vitess        (äº‘åŸç”Ÿåˆ†ç‰‡ï¼ŒåŠŸèƒ½å…¨)
â””â”€ Atlas         (360å¼€æºï¼Œç¨³å®šæ€§å¥½)

è‡ªç ”æ–¹æ¡ˆè€ƒè™‘ï¼š
âœ… ä¸šåŠ¡æ·±åº¦å®šåˆ¶éœ€æ±‚
âœ… å›¢é˜ŸæŠ€æœ¯å®åŠ›å……è¶³
âœ… é•¿æœŸç»´æŠ¤èƒ½åŠ›
âŒ å¼€å‘å‘¨æœŸç´§å¼ 
âŒ å›¢é˜Ÿç»éªŒä¸è¶³
```

### 7.4 åˆ†ç‰‡æ¶æ„æ¼”è¿›è·¯å¾„


**ğŸ“ˆ åˆ†ç‰‡æ¶æ„çš„æ¸è¿›å¼æ¼”è¿›**ï¼š

```
æ¼”è¿›é˜¶æ®µï¼š

ç¬¬ä¸€é˜¶æ®µï¼šè¯»å†™åˆ†ç¦»
å•ä¸»åº“ + å¤šè¯»åº“
è§£å†³è¯»æ€§èƒ½é—®é¢˜

ç¬¬äºŒé˜¶æ®µï¼šå‚ç›´åˆ†ç‰‡  
æŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†åº“
è§£å†³ä¸šåŠ¡è€¦åˆé—®é¢˜

ç¬¬ä¸‰é˜¶æ®µï¼šæ°´å¹³åˆ†ç‰‡
æŒ‰æ•°æ®é‡æ‹†åˆ†è¡¨
è§£å†³å­˜å‚¨å®¹é‡é—®é¢˜

ç¬¬å››é˜¶æ®µï¼šåˆ†å¸ƒå¼æ¶æ„
å¤šæœºæˆ¿ã€å¤šåŒºåŸŸéƒ¨ç½²
è§£å†³é«˜å¯ç”¨é—®é¢˜
```

### 7.5 é¿å…çš„å¸¸è§è¯¯åŒº


ğŸ’¥ **å®¹æ˜“å‡ºé”™**ï¼šåˆ†ç‰‡å®æ–½ä¸­çš„å…¸å‹é”™è¯¯

**âŒ æŠ€æœ¯è¯¯åŒº**ï¼š
- **è¿‡æ—©åˆ†ç‰‡**ï¼šæ•°æ®é‡ä¸å¤§å°±åˆ†ç‰‡ï¼Œå¢åŠ å¤æ‚åº¦
- **åˆ†ç‰‡é”®é”™è¯¯**ï¼šé€‰æ‹©ä½åŸºæ•°æˆ–é¢‘ç¹å˜åŒ–çš„å­—æ®µ
- **å¿½ç•¥è·¨åˆ†ç‰‡æŸ¥è¯¢**ï¼šæ²¡æœ‰è€ƒè™‘ä¸šåŠ¡æŸ¥è¯¢å¤æ‚åº¦
- **ç¼ºä¹ç›‘æ§**ï¼šåˆ†ç‰‡åç¼ºä¹æœ‰æ•ˆçš„ç›‘æ§ä½“ç³»

**âŒ ä¸šåŠ¡è¯¯åŒº**ï¼š
- **ä¸€æ­¥åˆ°ä½**ï¼šè¯•å›¾ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜
- **å¿½ç•¥ç»´æŠ¤æˆæœ¬**ï¼šåªè€ƒè™‘æ€§èƒ½æ”¶ç›Šï¼Œå¿½ç•¥ç»´æŠ¤å¤æ‚åº¦
- **ç¼ºä¹è§„åˆ’**ï¼šæ²¡æœ‰é•¿æœŸçš„å®¹é‡å’Œæ¶æ„è§„åˆ’
- **å›¢é˜Ÿå‡†å¤‡ä¸è¶³**ï¼šæŠ€æœ¯å›¢é˜Ÿç¼ºä¹åˆ†ç‰‡ç»éªŒ

### 7.6 æ ¸å¿ƒè®°å¿†è¦ç‚¹


**ğŸ”‘ ä¸€å¥è¯æ€»ç»“**ï¼š
```
æ•°æ®åˆ†ç‰‡æ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œç”¨å¤æ‚åº¦æ¢æ€§èƒ½çš„æŠ€æœ¯æ–¹æ¡ˆ
åˆç†çš„åˆ†ç‰‡é”®é€‰æ‹©æ˜¯æˆåŠŸçš„å…³é”®
ç›‘æ§å’Œè¿ç»´èƒ½åŠ›å†³å®šåˆ†ç‰‡çš„é•¿æœŸç¨³å®šæ€§
```

**ğŸ“ å¿…èƒŒè¦ç‚¹**ï¼š
- **åˆ†ç‰‡é”®é€‰æ‹©**ï¼šé«˜åŸºæ•°ã€æŸ¥è¯¢å‹å¥½ã€ç›¸å¯¹ç¨³å®š
- **è·¯ç”±ç­–ç•¥**ï¼šå“ˆå¸Œåˆ†ç‰‡å‡åŒ€ï¼ŒèŒƒå›´åˆ†ç‰‡æŸ¥è¯¢å‹å¥½  
- **è·¨åˆ†ç‰‡æŸ¥è¯¢**ï¼šèƒ½é¿å…å°±é¿å…ï¼Œæ— æ³•é¿å…å°±ä¼˜åŒ–
- **ç›‘æ§ä½“ç³»**ï¼šæ€§èƒ½ç›‘æ§+æ•°æ®åˆ†å¸ƒç›‘æ§+æ•…éšœé¢„è­¦
- **æ‰©å®¹ç­–ç•¥**ï¼šæ¸è¿›å¼è¿ç§»ï¼ŒåŒå†™æ¨¡å¼ä¿éšœä¸€è‡´æ€§

**ğŸ­ è®°å¿†æŠ€å·§**ï¼š
```
åˆ†ç‰‡ä¸‰è¦ç´ ï¼šåˆ†å¾—å¼€ã€æŸ¥å¾—å¿«ã€ç®¡å¾—å¥½
åˆ†å¾—å¼€ â†’ åˆç†çš„åˆ†ç‰‡ç­–ç•¥
æŸ¥å¾—å¿« â†’ é«˜æ•ˆçš„è·¯ç”±ç®—æ³•  
ç®¡å¾—å¥½ â†’ å®Œå–„çš„ç›‘æ§è¿ç»´
```