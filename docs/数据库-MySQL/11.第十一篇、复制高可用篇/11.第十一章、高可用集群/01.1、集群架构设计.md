---
title: 1ã€é›†ç¾¤æ¶æ„è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤æ‹“æ‰‘ç»“æ„è®¾è®¡](#1-é›†ç¾¤æ‹“æ‰‘ç»“æ„è®¾è®¡)
2. [èŠ‚ç‚¹è§’è‰²è®¾è®¡è¯¦è§£](#2-èŠ‚ç‚¹è§’è‰²è®¾è®¡è¯¦è§£)
3. [æ¶æ„å¯æ‰©å±•æ€§æ–¹æ¡ˆ](#3-æ¶æ„å¯æ‰©å±•æ€§æ–¹æ¡ˆ)
4. [å®¹é”™æ¶æ„æ¨¡å¼](#4-å®¹é”™æ¶æ„æ¨¡å¼)
5. [å¤šå±‚æ¶æ„è®¾è®¡](#5-å¤šå±‚æ¶æ„è®¾è®¡)
6. [æ— å•ç‚¹æ•…éšœè®¾è®¡](#6-æ— å•ç‚¹æ•…éšœè®¾è®¡)
7. [æ¶æ„æ¼”è¿›ç­–ç•¥](#7-æ¶æ„æ¼”è¿›ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ é›†ç¾¤æ‹“æ‰‘ç»“æ„è®¾è®¡


### 1.1 ä»€ä¹ˆæ˜¯é›†ç¾¤æ‹“æ‰‘ç»“æ„


**ğŸ”¸ é€šä¿—ç†è§£**
é›†ç¾¤æ‹“æ‰‘ç»“æ„å°±æ˜¯å¤šå°MySQLæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥æ–¹å¼å’Œç»„ç»‡å…³ç³»ï¼Œå°±åƒå…¬å¸çš„ç»„ç»‡æ¶æ„å›¾ä¸€æ ·ï¼Œå®šä¹‰äº†è°æ˜¯è€å¤§ã€è°å¬è°çš„æŒ‡æŒ¥ã€æ•°æ®æ€ä¹ˆæµåŠ¨ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**
```
é›†ç¾¤æ‹“æ‰‘ = æœåŠ¡å™¨èŠ‚ç‚¹ + è¿æ¥å…³ç³» + æ•°æ®æµå‘
ç›®çš„ï¼šæé«˜å¯ç”¨æ€§ã€æ€§èƒ½å’Œæ‰©å±•æ€§
æœ¬è´¨ï¼šé€šè¿‡å¤šå°æœåŠ¡å™¨ååŒå·¥ä½œï¼Œé¿å…å•ç‚¹æ•…éšœ
```

### 1.2 ä¸»è¦æ‹“æ‰‘ç»“æ„ç±»å‹


##### ğŸ”¹ ä¸»ä»å¤åˆ¶æ‹“æ‰‘ï¼ˆMaster-Slaveï¼‰


**åŸºæœ¬åŸç†**
```
ç®€å•ç†è§£ï¼šä¸€å°è€å¸ˆï¼ˆä¸»åº“ï¼‰æ•™å¤šä¸ªå­¦ç”Ÿï¼ˆä»åº“ï¼‰

ä¸»åº“ï¼ˆMasterï¼‰               ä»åº“ï¼ˆSlave1ï¼‰    ä»åº“ï¼ˆSlave2ï¼‰
     |                           â†‘                â†‘
     |-------- å†™æ“ä½œ ------------|                |
     |-------- binlog ----------->|                |
     |-------- binlog --------------------------->|
     
å·¥ä½œæµç¨‹ï¼š
1. æ‰€æœ‰å†™æ“ä½œéƒ½åœ¨ä¸»åº“æ‰§è¡Œ
2. ä¸»åº“æŠŠå˜æ›´è®°å½•åˆ°binlog
3. ä»åº“è¯»å–binlogå¹¶æ‰§è¡Œï¼Œå®ç°æ•°æ®åŒæ­¥
```

**ä¼˜åŠ¿ä¸å±€é™**
```
âœ… ä¼˜åŠ¿ï¼š
â€¢ è¯»å†™åˆ†ç¦»ï¼šä¸»åº“å†™ï¼Œä»åº“è¯»ï¼Œæå‡æ€§èƒ½
â€¢ æ•°æ®å¤‡ä»½ï¼šä»åº“ä½œä¸ºä¸»åº“çš„å®æ—¶å¤‡ä»½
â€¢ ç®€å•æ˜“æ‡‚ï¼šæ¶æ„æ¸…æ™°ï¼Œç»´æŠ¤ç›¸å¯¹ç®€å•

âŒ å±€é™ï¼š
â€¢ ä¸»åº“å•ç‚¹ï¼šä¸»åº“æŒ‚äº†æ•´ä¸ªå†™æœåŠ¡åœæ­¢
â€¢ å¤åˆ¶å»¶è¿Ÿï¼šä»åº“æ•°æ®å¯èƒ½æ¯”ä¸»åº“è½å
â€¢ æ‰©å±•é™åˆ¶ï¼šå†™æ“ä½œæ— æ³•æ°´å¹³æ‰©å±•
```

##### ğŸ”¹ ä¸»ä¸»å¤åˆ¶æ‹“æ‰‘ï¼ˆMaster-Masterï¼‰


**åŸºæœ¬åŸç†**
```
ç®€å•ç†è§£ï¼šä¸¤ä¸ªè€å¸ˆäº’ç›¸å­¦ä¹ ï¼Œéƒ½èƒ½æ•™å­¦ç”Ÿ

ä¸»åº“A â†----------â†’ ä¸»åº“B
  |                  |
  â†“                  â†“  
ä»åº“A1             ä»åº“B1
ä»åº“A2             ä»åº“B2

ç‰¹ç‚¹ï¼š
â€¢ ä¸¤å°ä¸»åº“äº’ä¸ºä¸»ä»
â€¢ æ¯å°ä¸»åº“éƒ½å¯ä»¥å¤„ç†å†™æ“ä½œ
â€¢ éœ€è¦é¿å…æ•°æ®å†²çª
```

**ä½¿ç”¨åœºæ™¯ä¸æ³¨æ„äº‹é¡¹**
```
ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ åœ°ç†åˆ†å¸ƒçš„åº”ç”¨
â€¢ éœ€è¦å†™æ“ä½œè´Ÿè½½å‡è¡¡
â€¢ å®¹ç¾å¤‡ä»½éœ€æ±‚

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
â€¢ è‡ªå¢IDå†²çªï¼šéœ€è¦è®¾ç½®ä¸åŒçš„æ­¥é•¿
â€¢ æ•°æ®ä¸€è‡´æ€§ï¼šå¯èƒ½å‡ºç°å†™å†²çª
â€¢ è„‘è£‚é—®é¢˜ï¼šç½‘ç»œåˆ†åŒºæ—¶çš„å¤„ç†
```

##### ğŸ”¹ ç¯å½¢å¤åˆ¶æ‹“æ‰‘


**åŸºæœ¬åŸç†**
```
ç®€å•ç†è§£ï¼šå‡ ä¸ªäººå›´æˆåœ†æ¡Œï¼Œæ¯äººéƒ½æŠŠæ¶ˆæ¯ä¼ ç»™ä¸‹ä¸€ä¸ªäºº

èŠ‚ç‚¹A â”€â”€â†’ èŠ‚ç‚¹B
  â†‘           â†“
èŠ‚ç‚¹D â†â”€â”€ èŠ‚ç‚¹C

æ•°æ®æµå‘ï¼šA â†’ B â†’ C â†’ D â†’ A

ä¼˜åŠ¿ï¼š
â€¢ æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å†™å…¥
â€¢ æ•°æ®æœ€ç»ˆä¼šåŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹

é£é™©ï¼š
â€¢ é“¾è·¯æ–­è£‚ï¼šä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹æ•…éšœéƒ½å½±å“æ•´ä½“
â€¢ å»¶è¿Ÿç´¯ç§¯ï¼šæ•°æ®è¦è½¬ä¸€åœˆæ‰èƒ½å›åˆ°èµ·ç‚¹
```

### 1.3 ç°ä»£é›†ç¾¤æ‹“æ‰‘æ¶æ„


##### ğŸ”¹ MySQL Group Replication


**æ ¸å¿ƒæ¦‚å¿µ**
```
ç®€å•ç†è§£ï¼šä¸€ç¾¤äººå¼€ä¼šåšå†³å®šï¼Œå¤§å®¶æŠ•ç¥¨å†³å®šæ˜¯å¦æ¥å—æŸä¸ªææ¡ˆ

å·¥ä½œåŸç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹A   â”‚    â”‚ èŠ‚ç‚¹B   â”‚    â”‚ èŠ‚ç‚¹C   â”‚
â”‚ Primary â”‚    â”‚ Secondaryâ”‚   â”‚ Secondaryâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€ åè°ƒæœºåˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ åŸºäºPaxosåè®®çš„ä¸€è‡´æ€§ä¿è¯
â€¢ è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢
â€¢ å¤šä¸»æˆ–å•ä¸»æ¨¡å¼å¯é€‰
```

**å•ä¸»æ¨¡å¼ vs å¤šä¸»æ¨¡å¼**
```
å•ä¸»æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼š
âœ… ä¸€ä¸ªä¸»èŠ‚ç‚¹å¤„ç†å†™å…¥
âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
âœ… æ•°æ®ä¸€è‡´æ€§å¼º

å¤šä¸»æ¨¡å¼ï¼š
âš ï¸ å¤šä¸ªèŠ‚ç‚¹éƒ½èƒ½å†™å…¥
âš ï¸ å¯èƒ½å‡ºç°å†™å†²çª
âš ï¸ éœ€è¦å†²çªæ£€æµ‹æœºåˆ¶
```

##### ğŸ”¹ MySQL InnoDB Cluster


**æ¶æ„ç»„æˆ**
```
å®Œæ•´çš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼š

MySQL Shellï¼ˆç®¡ç†å·¥å…·ï¼‰
        â”‚
        â†“
MySQL Routerï¼ˆä»£ç†å±‚ï¼‰
        â”‚
        â†“
Group Replicationï¼ˆæ•°æ®å±‚ï¼‰
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ èŠ‚ç‚¹1   â”‚ èŠ‚ç‚¹2   â”‚ èŠ‚ç‚¹3   â”‚
  â”‚ Primary â”‚Secondaryâ”‚Secondaryâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å„ç»„ä»¶ä½œç”¨ï¼š
â€¢ MySQL Shellï¼šé›†ç¾¤ç®¡ç†å’Œé…ç½®
â€¢ MySQL Routerï¼šè¿æ¥è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
â€¢ Group Replicationï¼šæ•°æ®åŒæ­¥å’Œä¸€è‡´æ€§
```

### 1.4 æ‹“æ‰‘ç»“æ„é€‰æ‹©æŒ‡å—


##### ğŸ“Š ä¸åŒåœºæ™¯çš„æ‹“æ‰‘é€‰æ‹©


| ä¸šåŠ¡åœºæ™¯ | **æ¨èæ‹“æ‰‘** | **ç†ç”±** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|---------|-------------|
| ğŸŒ **å°å‹ç½‘ç«™** | `ä¸»ä»å¤åˆ¶` | `ç®€å•æ˜“ç»´æŠ¤ï¼Œæˆæœ¬ä½` | `ä¸»åº“å•ç‚¹é£é™©` |
| ğŸ“± **ç§»åŠ¨åº”ç”¨** | `ä¸€ä¸»å¤šä»` | `è¯»å¤šå†™å°‘ï¼Œæ€§èƒ½å¥½` | `ç›‘æ§ä¸»åº“çŠ¶æ€` |
| ğŸ’¼ **ä¼ä¸šåº”ç”¨** | `InnoDB Cluster` | `è‡ªåŠ¨æ•…éšœè½¬ç§»` | `éœ€è¦å­¦ä¹ æˆæœ¬` |
| ğŸŒ **å…¨çƒåˆ†å¸ƒ** | `ä¸»ä¸»å¤åˆ¶` | `å°±è¿‘å†™å…¥ï¼Œå»¶è¿Ÿä½` | `å†²çªå¤„ç†å¤æ‚` |
| ğŸ“ˆ **é«˜å¹¶å‘ç³»ç»Ÿ** | `åˆ†ç‰‡+å¤åˆ¶` | `æ°´å¹³æ‰©å±•èƒ½åŠ›å¼º` | `æ•°æ®åˆ†ç‰‡ç­–ç•¥` |

---

## 2. ğŸ­ èŠ‚ç‚¹è§’è‰²è®¾è®¡è¯¦è§£


### 2.1 èŠ‚ç‚¹è§’è‰²çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯èŠ‚ç‚¹è§’è‰²**

```
ç®€å•ç†è§£ï¼šå°±åƒå…¬å¸é‡Œçš„èŒä½åˆ†å·¥
â€¢ CEOï¼ˆä¸»èŠ‚ç‚¹ï¼‰ï¼šè´Ÿè´£é‡è¦å†³ç­–
â€¢ ç»ç†ï¼ˆä»èŠ‚ç‚¹ï¼‰ï¼šæ‰§è¡Œå’Œæ±‡æŠ¥
â€¢ ä»²è£è€…ï¼ˆArbiterï¼‰ï¼šæŠ•ç¥¨å†³ç­–ä½†ä¸å¹²æ´»
â€¢ å€™é€‰è€…ï¼ˆCandidateï¼‰ï¼šå‡†å¤‡æ¥ä»»çš„äºº
```

### 2.2 ä¸»èŠ‚ç‚¹ï¼ˆPrimary/Masterï¼‰è®¾è®¡


##### ğŸ”¹ ä¸»èŠ‚ç‚¹çš„èŒè´£


**æ ¸å¿ƒåŠŸèƒ½**
```
ğŸ“ å†™æ“ä½œå¤„ç†ï¼š
â€¢ æ¥æ”¶æ‰€æœ‰çš„INSERTã€UPDATEã€DELETEæ“ä½œ
â€¢ ç»´æŠ¤æ•°æ®çš„æƒå¨ç‰ˆæœ¬
â€¢ ç”Ÿæˆbinlogè®°å½•æ‰€æœ‰å˜æ›´

ğŸ¯ åŒæ­¥åè°ƒï¼š
â€¢ å‘ä»èŠ‚ç‚¹å‘é€binlog
â€¢ ç›‘æ§ä»èŠ‚ç‚¹çš„åŒæ­¥çŠ¶æ€
â€¢ å¤„ç†ä»èŠ‚ç‚¹çš„è¿æ¥è¯·æ±‚

ğŸ”’ é”ç®¡ç†ï¼š
â€¢ å¤„ç†è¡¨é”ã€è¡Œé”ç­‰å¹¶å‘æ§åˆ¶
â€¢ ç®¡ç†äº‹åŠ¡çš„æäº¤å’Œå›æ»š
â€¢ ç»´æŠ¤MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰
```

##### ğŸ”¹ ä¸»èŠ‚ç‚¹çš„é…ç½®è¦ç‚¹


**ç¡¬ä»¶é…ç½®å»ºè®®**
```
ğŸ’» CPUï¼šä¼˜å…ˆé€‰æ‹©é«˜é¢‘ç‡
â€¢ ä¸»åº“ä¸»è¦æ˜¯å•çº¿ç¨‹å†™å…¥
â€¢ é«˜é¢‘ç‡æ¯”å¤šæ ¸å¿ƒæ›´é‡è¦
â€¢ æ¨èï¼š4-8æ ¸ï¼Œ3.0GHzä»¥ä¸Š

ğŸ’¾ å†…å­˜ï¼šå……è¶³çš„ç¼“å­˜ç©ºé—´
â€¢ InnoDB Buffer Poolå°½å¯èƒ½å¤§
â€¢ ä¸€èˆ¬è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„70-80%
â€¢ æ¨èï¼š32GBä»¥ä¸Š

ğŸ’¿ å­˜å‚¨ï¼šé«˜IOPSçš„SSD
â€¢ å†™å¯†é›†å‹æ“ä½œå¯¹IOPSè¦æ±‚é«˜
â€¢ æ¨èï¼šNVMe SSDï¼ŒIOPS > 10000
â€¢ RAIDé…ç½®ï¼šRAID10ï¼ˆæ€§èƒ½+å¯é æ€§ï¼‰
```

**å…³é”®å‚æ•°é…ç½®**
```sql
-- ä¸»åº“æ ¸å¿ƒé…ç½®
[mysqld]
# æœåŠ¡å™¨IDï¼ˆæ¯ä¸ªèŠ‚ç‚¹å”¯ä¸€ï¼‰
server-id = 1

# å¼€å¯binlog
log-bin = mysql-bin
binlog-format = ROW        # æ¨èè¡Œçº§å¤åˆ¶
expire-logs-days = 7       # binlogä¿ç•™å¤©æ•°

# InnoDBé…ç½®
innodb_buffer_pool_size = 24G    # æ ¹æ®å†…å­˜è°ƒæ•´
innodb_log_file_size = 1G        # äº‹åŠ¡æ—¥å¿—å¤§å°
innodb_flush_log_at_trx_commit = 1  # å¼ºä¸€è‡´æ€§

# åŠåŒæ­¥å¤åˆ¶ï¼ˆå¯é€‰ï¼‰
plugin-load = "rpl_semi_sync_master=semisync_master.so"
rpl_semi_sync_master_enabled = 1
rpl_semi_sync_master_timeout = 1000  # 1ç§’è¶…æ—¶
```

### 2.3 ä»èŠ‚ç‚¹ï¼ˆSecondary/Slaveï¼‰è®¾è®¡


##### ğŸ”¹ ä»èŠ‚ç‚¹çš„èŒè´£åˆ†å·¥


**ğŸ“š åªè¯»èŠ‚ç‚¹ï¼ˆRead Replicaï¼‰**
```
ğŸ¯ ä¸»è¦ç”¨é€”ï¼š
â€¢ åˆ†æ‹…ä¸»åº“çš„æŸ¥è¯¢å‹åŠ›
â€¢ æä¾›æ•°æ®åˆ†æå’ŒæŠ¥è¡¨æœåŠ¡
â€¢ ä½œä¸ºæ•°æ®å¤‡ä»½

âš™ï¸ å·¥ä½œåŸç†ï¼š
1. é€šè¿‡IOçº¿ç¨‹ä»ä¸»åº“è·å–binlog
2. é€šè¿‡SQLçº¿ç¨‹æ‰§è¡Œbinlogä¸­çš„SQL
3. ä¿æŒä¸ä¸»åº“çš„æ•°æ®åŒæ­¥

ğŸ”§ ä¼˜åŒ–è¦ç‚¹ï¼š
â€¢ å¯ä»¥åˆ›å»ºé¢å¤–çš„ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
â€¢ è®¾ç½®read_onlyå‚æ•°é˜²æ­¢è¯¯å†™
â€¢ å¯ä»¥ä½¿ç”¨ä¸åŒçš„å­˜å‚¨å¼•æ“
```

**ğŸ”„ çƒ­å¤‡èŠ‚ç‚¹ï¼ˆHot Standbyï¼‰**
```
ğŸ¯ ä¸»è¦ç”¨é€”ï¼š
â€¢ ä¸»åº“æ•…éšœæ—¶å¿«é€Ÿæ¥ç®¡
â€¢ ä¿æŒä¸ä¸»åº“å®Œå…¨ä¸€è‡´çš„é…ç½®
â€¢ æœ€å°åŒ–æ•…éšœåˆ‡æ¢æ—¶é—´

âš™ï¸ é…ç½®è¦æ±‚ï¼š
â€¢ ç¡¬ä»¶é…ç½®ä¸ä¸»åº“ç›¸åŒ
â€¢ è½¯ä»¶ç‰ˆæœ¬ä¸å‚æ•°é…ç½®ä¸€è‡´
â€¢ å®æ—¶ç›‘æ§åŒæ­¥çŠ¶æ€

ğŸš¨ åˆ‡æ¢æ¡ä»¶ï¼š
â€¢ ä¸»åº“ç¡¬ä»¶æ•…éšœ
â€¢ ç½‘ç»œè¿æ¥ä¸­æ–­
â€¢ ä¸»åº“å“åº”è¶…æ—¶
```

##### ğŸ”¹ ä»èŠ‚ç‚¹é…ç½®å®ä¾‹


```sql
-- ä»åº“é…ç½®ç¤ºä¾‹
[mysqld]
server-id = 2              # å”¯ä¸€ID
read-only = 1              # åªè¯»æ¨¡å¼

# å¤åˆ¶ç›¸å…³é…ç½®
relay-log = relay-bin      # ä¸­ç»§æ—¥å¿—
relay-log-index = relay-bin.index

# åŠåŒæ­¥å¤åˆ¶
plugin-load = "rpl_semi_sync_slave=semisync_slave.so"
rpl_semi_sync_slave_enabled = 1

# å¹¶è¡Œå¤åˆ¶ï¼ˆMySQL 5.7+ï¼‰
slave-parallel-type = LOGICAL_CLOCK
slave-parallel-workers = 4

# å¤åˆ¶è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
replicate-ignore-db = test    # å¿½ç•¥testæ•°æ®åº“
replicate-do-table = myapp.users  # åªå¤åˆ¶ç‰¹å®šè¡¨
```

### 2.4 ä»²è£èŠ‚ç‚¹ï¼ˆArbiterï¼‰è®¾è®¡


##### ğŸ”¹ ä»²è£èŠ‚ç‚¹çš„ä½œç”¨


**ğŸ›ï¸ ä»€ä¹ˆæ˜¯ä»²è£èŠ‚ç‚¹**
```
ç®€å•ç±»æ¯”ï¼šæ³•é™¢çš„æ³•å®˜
â€¢ ä¸å­˜å‚¨æ•°æ®ï¼Œåªå‚ä¸æŠ•ç¥¨
â€¢ åœ¨ç½‘ç»œåˆ†åŒºæ—¶å¸®åŠ©å†³ç­–
â€¢ é˜²æ­¢è„‘è£‚é—®é¢˜

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ä¸¤èŠ‚ç‚¹é›†ç¾¤éœ€è¦ç¬¬ä¸‰æ–¹ä»²è£
â€¢ å¼‚åœ°ç¾å¤‡ä¸­çš„è§è¯èŠ‚ç‚¹
â€¢ èµ„æºå—é™ä½†éœ€è¦é«˜å¯ç”¨çš„ç¯å¢ƒ
```

**é…ç½®ç¤ºä¾‹**
```sql
-- ä»²è£èŠ‚ç‚¹æœ€å°åŒ–é…ç½®
[mysqld]
server-id = 999
datadir = /var/lib/mysql-arbiter

# æœ€å°åŒ–èµ„æºä½¿ç”¨
innodb_buffer_pool_size = 128M
max_connections = 10

# ä¸å­˜å‚¨ç”¨æˆ·æ•°æ®
skip-slave-start
slave_sql_verify_checksum = 0
```

### 2.5 èŠ‚ç‚¹è§’è‰²åŠ¨æ€ç®¡ç†


##### ğŸ”¹ è§’è‰²åˆ‡æ¢æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»æµç¨‹**
```
æ•…éšœæ£€æµ‹ï¼š
æ£€æµ‹å™¨ â”€â”€ç›‘æ§â”€â”€â†’ ä¸»èŠ‚ç‚¹
   â”‚               â”‚
   â†“             æ•…éšœ
å†³ç­–é˜¶æ®µ          â”‚
   â”‚               â†“
   â†“           è§¦å‘åˆ‡æ¢
é€‰ä¸¾æ–°ä¸»
   â”‚
   â†“
é…ç½®æ›´æ–° â”€â”€â†’ æ–°ä¸»èŠ‚ç‚¹ â†â”€â”€ å…¶ä»–ä»èŠ‚ç‚¹
   â”‚           â”‚
   â†“           â†“
é€šçŸ¥åº”ç”¨    æ•°æ®åŒæ­¥

åˆ‡æ¢æ—¶é—´ç›®æ ‡ï¼š
â€¢ æ£€æµ‹å»¶è¿Ÿï¼š< 30ç§’
â€¢ åˆ‡æ¢æ—¶é—´ï¼š< 2åˆ†é’Ÿ
â€¢ æ•°æ®ä¸¢å¤±ï¼š0ï¼ˆåŒæ­¥å¤åˆ¶ï¼‰
```

##### ğŸ”¹ æ‰‹åŠ¨è§’è‰²ç®¡ç†


**å¸¸ç”¨ç®¡ç†å‘½ä»¤**
```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€
SHOW SLAVE STATUS\G
SHOW MASTER STATUS\G

-- æ‰‹åŠ¨åˆ‡æ¢ä¸»ä»
-- åœ¨ä»åº“æ‰§è¡Œ
STOP SLAVE;
RESET SLAVE;

-- åœ¨æ–°ä¸»åº“æ‰§è¡Œ
RESET MASTER;

-- é‡æ–°é…ç½®å¤åˆ¶å…³ç³»
CHANGE MASTER TO
  MASTER_HOST='new_master_ip',
  MASTER_USER='repl_user',
  MASTER_PASSWORD='repl_password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154;

START SLAVE;
```

---

## 3. ğŸ“ˆ æ¶æ„å¯æ‰©å±•æ€§æ–¹æ¡ˆ


### 3.1 å¯æ‰©å±•æ€§çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ¶æ„å¯æ‰©å±•æ€§**

```
ç®€å•ç†è§£ï¼šç³»ç»Ÿèƒ½å¤Ÿåº”å¯¹ä¸šåŠ¡å¢é•¿çš„èƒ½åŠ›
â€¢ å‚ç›´æ‰©å±•ï¼ˆScale Upï¼‰ï¼šç»™ç°æœ‰æœåŠ¡å™¨åŠ é…ç½®
â€¢ æ°´å¹³æ‰©å±•ï¼ˆScale Outï¼‰ï¼šå¢åŠ æ›´å¤šæœåŠ¡å™¨

å°±åƒé¤å…åº”å¯¹å®¢æµå¢é•¿ï¼š
â€¢ å‚ç›´æ‰©å±•ï¼šé›‡ä½£æ›´å‰å®³çš„å¨å¸ˆï¼ˆæå‡å•æœºæ€§èƒ½ï¼‰
â€¢ æ°´å¹³æ‰©å±•ï¼šå¼€æ›´å¤šåˆ†åº—ï¼ˆå¢åŠ æœåŠ¡å™¨æ•°é‡ï¼‰
```

### 3.2 è¯»æ‰©å±•æ–¹æ¡ˆ


##### ğŸ”¹ è¯»å†™åˆ†ç¦»æ¶æ„


**åŸºæœ¬åŸç†**
```
åº”ç”¨å±‚é¢çš„è¯»å†™åˆ†ç¦»ï¼š

åº”ç”¨ç¨‹åº
    â”‚
    â”œâ”€â”€ å†™æ“ä½œ â”€â”€â†’ ä¸»åº“ï¼ˆMasterï¼‰
    â”‚                 â”‚
    â”‚                 â†“ï¼ˆbinlogå¤åˆ¶ï¼‰
    â””â”€â”€ è¯»æ“ä½œ â”€â”€â†’ ä»åº“ç¾¤ï¼ˆSlavesï¼‰
                    â”œâ”€â”€ ä»åº“1
                    â”œâ”€â”€ ä»åº“2
                    â””â”€â”€ ä»åº“3

ä¼˜åŠ¿ï¼š
â€¢ è¯»æ“ä½œå¯ä»¥æ— é™æ°´å¹³æ‰©å±•
â€¢ åˆ†æ‹…ä¸»åº“å‹åŠ›
â€¢ æé«˜æ•´ä½“ååé‡
```

##### ğŸ”¹ è¯»è´Ÿè½½å‡è¡¡ç­–ç•¥


**ğŸ“Š å¸¸è§è´Ÿè½½å‡è¡¡ç®—æ³•**

| ç®—æ³•ç±»å‹ | **å·¥ä½œåŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-----------|
| ğŸ”„ **è½®è¯¢** | `ä¾æ¬¡åˆ†é…ç»™æ¯ä¸ªä»åº“` | `ä»åº“æ€§èƒ½ç›¸è¿‘` | `ç®€å•ä½†ä¸è€ƒè™‘è´Ÿè½½` |
| âš–ï¸ **åŠ æƒè½®è¯¢** | `æ ¹æ®æƒé‡åˆ†é…è¯·æ±‚` | `ä»åº“æ€§èƒ½ä¸åŒ` | `çµæ´»ä½†éœ€è¦è°ƒä¼˜` |
| ğŸ“Š **æœ€å°‘è¿æ¥** | `åˆ†é…ç»™è¿æ¥æ•°æœ€å°‘çš„ä»åº“` | `é•¿è¿æ¥åº”ç”¨` | `å‡è¡¡ä½†å¼€é”€å¤§` |
| ğŸ¯ **ä¸€è‡´æ€§å“ˆå¸Œ** | `æ ¹æ®ç”¨æˆ·IDç­‰åˆ†é…` | `éœ€è¦ä¼šè¯ä¿æŒ` | `ç¨³å®šä½†å®ç°å¤æ‚` |

**å®ç°ç¤ºä¾‹ï¼ˆåº”ç”¨å±‚ï¼‰**
```java
public class ReadWriteSplitter {
    private DataSource masterDS;     // ä¸»åº“æ•°æ®æº
    private List<DataSource> slaveDS;  // ä»åº“æ•°æ®æºåˆ—è¡¨
    private AtomicInteger counter = new AtomicInteger(0);
    
    public DataSource getDataSource(boolean isWrite) {
        if (isWrite) {
            return masterDS;  // å†™æ“ä½œä½¿ç”¨ä¸»åº“
        } else {
            // è¯»æ“ä½œä½¿ç”¨è½®è¯¢æ–¹å¼é€‰æ‹©ä»åº“
            int index = counter.getAndIncrement() % slaveDS.size();
            return slaveDS.get(index);
        }
    }
    
    // è‡ªåŠ¨è¯†åˆ«SQLç±»å‹
    public DataSource getDataSource(String sql) {
        String upperSQL = sql.trim().toUpperCase();
        boolean isWrite = upperSQL.startsWith("INSERT") ||
                         upperSQL.startsWith("UPDATE") ||
                         upperSQL.startsWith("DELETE");
        return getDataSource(isWrite);
    }
}
```

### 3.3 å†™æ‰©å±•æ–¹æ¡ˆ


##### ğŸ”¹ æ•°æ®åº“åˆ†ç‰‡ï¼ˆShardingï¼‰


**ğŸ—‚ï¸ æ°´å¹³åˆ†ç‰‡ç­–ç•¥**

```
æŒ‰ç”¨æˆ·IDåˆ†ç‰‡ç¤ºä¾‹ï¼š

ç”¨æˆ·æ•°æ®åˆ†å¸ƒï¼š
ç”¨æˆ·1-1000    â”€â”€â†’ åˆ†ç‰‡1ï¼ˆshard_1ï¼‰
ç”¨æˆ·1001-2000 â”€â”€â†’ åˆ†ç‰‡2ï¼ˆshard_2ï¼‰  
ç”¨æˆ·2001-3000 â”€â”€â†’ åˆ†ç‰‡3ï¼ˆshard_3ï¼‰

æ¯ä¸ªåˆ†ç‰‡éƒ½æ˜¯ç‹¬ç«‹çš„ä¸»ä»é›†ç¾¤ï¼š
åˆ†ç‰‡1ï¼šä¸»åº“1 + ä»åº“1A + ä»åº“1B
åˆ†ç‰‡2ï¼šä¸»åº“2 + ä»åº“2A + ä»åº“2B
åˆ†ç‰‡3ï¼šä¸»åº“3 + ä»åº“3A + ä»åº“3B
```

**å¸¸è§åˆ†ç‰‡ç®—æ³•**
```java
// 1. èŒƒå›´åˆ†ç‰‡
public int getRangeShardId(int userId) {
    if (userId <= 1000) return 1;
    else if (userId <= 2000) return 2;
    else return 3;
}

// 2. å“ˆå¸Œåˆ†ç‰‡
public int getHashShardId(int userId) {
    return userId % 4;  // 4ä¸ªåˆ†ç‰‡
}

// 3. ä¸€è‡´æ€§å“ˆå¸Œï¼ˆé€‚åˆåŠ¨æ€æ‰©ç¼©å®¹ï¼‰
public int getConsistentHashShardId(String userKey) {
    return consistentHash.getShard(userKey);
}
```

##### ğŸ”¹ å‚ç›´åˆ†ç‰‡ç­–ç•¥


**ğŸ“‹ æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç‰‡**
```
å•ä½“æ•°æ®åº“æ‹†åˆ†ï¼š

åŸå§‹å•åº“ï¼š
â”œâ”€â”€ ç”¨æˆ·è¡¨ï¼ˆusersï¼‰
â”œâ”€â”€ è®¢å•è¡¨ï¼ˆordersï¼‰  
â”œâ”€â”€ å•†å“è¡¨ï¼ˆproductsï¼‰
â”œâ”€â”€ æ”¯ä»˜è¡¨ï¼ˆpaymentsï¼‰
â””â”€â”€ æ—¥å¿—è¡¨ï¼ˆlogsï¼‰

æ‹†åˆ†åçš„å¤šåº“ï¼š
ç”¨æˆ·åº“ï¼šusers, user_profiles
è®¢å•åº“ï¼šorders, order_items
å•†å“åº“ï¼šproducts, categories  
æ”¯ä»˜åº“ï¼špayments, transactions
æ—¥å¿—åº“ï¼šaccess_logs, error_logs
```

### 3.4 æ··åˆæ‰©å±•æ–¹æ¡ˆ


##### ğŸ”¹ åˆ†ç‰‡+è¯»å†™åˆ†ç¦»


**ğŸ—ï¸ å¤åˆæ¶æ„è®¾è®¡**
```
å®Œæ•´çš„å¯æ‰©å±•æ¶æ„ï¼š

                    åº”ç”¨ç¨‹åº
                        â”‚
                   åˆ†ç‰‡è·¯ç”±å±‚
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
     åˆ†ç‰‡1            åˆ†ç‰‡2            åˆ†ç‰‡3
        â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â”‚ ä¸»åº“1 â”‚       â”‚ ä¸»åº“2 â”‚       â”‚ ä¸»åº“3 â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”¬â”€â”€â”€â”˜       â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â”‚ä»åº“1A â”‚       â”‚ä»åº“2A â”‚       â”‚ä»åº“3A â”‚
    â”‚ä»åº“1B â”‚       â”‚ä»åº“2B â”‚       â”‚ä»åº“3B â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ å†™æ“ä½œï¼šæŒ‰åˆ†ç‰‡é”®è·¯ç”±åˆ°å¯¹åº”ä¸»åº“
â€¢ è¯»æ“ä½œï¼šåœ¨åˆ†ç‰‡å†…è¿›è¡Œè´Ÿè½½å‡è¡¡
â€¢ æ‰©å±•æ€§ï¼šåˆ†ç‰‡æ•°é‡å’Œæ¯åˆ†ç‰‡çš„ä»åº“æ•°é‡éƒ½å¯æ‰©å±•
```

### 3.5 æ‰©å±•æ€§ç›‘æ§ä¸è°ƒä¼˜


##### ğŸ”¹ å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ“Š æ€§èƒ½ç›‘æ§**
```
ååé‡æŒ‡æ ‡ï¼š
â€¢ QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰
â€¢ TPSï¼ˆæ¯ç§’äº‹åŠ¡æ•°ï¼‰
â€¢ è¯»å†™æ¯”ä¾‹

å»¶è¿ŸæŒ‡æ ‡ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´
â€¢ 95%å“åº”æ—¶é—´
â€¢ 99%å“åº”æ—¶é—´

èµ„æºä½¿ç”¨ï¼š
â€¢ CPUä½¿ç”¨ç‡
â€¢ å†…å­˜ä½¿ç”¨ç‡
â€¢ ç£ç›˜IOä½¿ç”¨ç‡
â€¢ ç½‘ç»œå¸¦å®½ä½¿ç”¨ç‡
```

**ğŸ¯ æ‰©å±•å†³ç­–æŒ‡æ ‡**
```
æ‰©å±•è§¦å‘æ¡ä»¶ï¼š

è¯»æ‰©å±•ä¿¡å·ï¼š
âœ… ä»åº“CPUä½¿ç”¨ç‡ > 70%
âœ… æŸ¥è¯¢å“åº”æ—¶é—´ > 100ms
âœ… è¯»QPSå¢é•¿è¶‹åŠ¿æ˜æ˜¾

å†™æ‰©å±•ä¿¡å·ï¼š
âš ï¸ ä¸»åº“CPUä½¿ç”¨ç‡ > 80%
âš ï¸ å†™æ“ä½œå“åº”æ—¶é—´ > 50ms
âš ï¸ é”ç­‰å¾…æ—¶é—´å¢åŠ 
âš ï¸ binlogäº§ç”Ÿé€Ÿåº¦è¿‡å¿«

åˆ†ç‰‡ä¿¡å·ï¼š
ğŸš¨ å•è¡¨æ•°æ®é‡ > 1000ä¸‡è¡Œ
ğŸš¨ å•åº“å¤§å° > 100GB
ğŸš¨ è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹è¾ƒä½
```

---

## 4. ğŸ›¡ï¸ å®¹é”™æ¶æ„æ¨¡å¼


### 4.1 å®¹é”™çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å®¹é”™æ¶æ„**

```
ç®€å•ç†è§£ï¼šç³»ç»Ÿåœ¨éƒ¨åˆ†ç»„ä»¶æ•…éšœæ—¶ä»èƒ½æ­£å¸¸å·¥ä½œçš„èƒ½åŠ›
å°±åƒäººä½“ï¼šä¸€ä¸ªè‚¾è„åäº†ï¼Œå¦ä¸€ä¸ªè‚¾è„å¯ä»¥ç»´æŒç”Ÿå‘½

å®¹é”™ä¸‰è¦ç´ ï¼š
â€¢ æ•…éšœæ£€æµ‹ï¼šå¿«é€Ÿå‘ç°é—®é¢˜
â€¢ æ•…éšœéš”ç¦»ï¼šé˜²æ­¢æ•…éšœæ‰©æ•£  
â€¢ æ•…éšœæ¢å¤ï¼šè‡ªåŠ¨æˆ–æ‰‹åŠ¨ä¿®å¤
```

### 4.2 æ•…éšœç±»å‹ä¸åº”å¯¹ç­–ç•¥


##### ğŸ”¹ ç¡¬ä»¶æ•…éšœå¤„ç†


**ğŸ’» æœåŠ¡å™¨ç¡¬ä»¶æ•…éšœ**
```
å¸¸è§æ•…éšœç±»å‹ï¼š
â€¢ CPUè¿‡çƒ­æˆ–æ•…éšœ
â€¢ å†…å­˜æ¡æŸå
â€¢ ç¡¬ç›˜æ•…éšœ
â€¢ ç½‘å¡æ•…éšœ
â€¢ ç”µæºæ•…éšœ

åº”å¯¹ç­–ç•¥ï¼š
1. ç¡¬ä»¶å†—ä½™ï¼š
   - åŒç”µæºä¾›åº”
   - RAIDç£ç›˜é˜µåˆ—
   - ECCå†…å­˜
   
2. å¿«é€Ÿæ›¿æ¢ï¼š
   - çƒ­æ’æ‹”ç¡¬ä»¶
   - å¤‡ç”¨æœåŠ¡å™¨
   - äº‘æœåŠ¡å™¨å¿«é€Ÿåˆ›å»º

3. æ•…éšœè½¬ç§»ï¼š
   - è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹
   - è´Ÿè½½å‡è¡¡å™¨å‰”é™¤æ•…éšœèŠ‚ç‚¹
   - DNSåˆ‡æ¢åˆ°å¤‡ç”¨IP
```

##### ğŸ”¹ ç½‘ç»œæ•…éšœå¤„ç†


**ğŸŒ ç½‘ç»œè¿æ¥é—®é¢˜**
```
ç½‘ç»œæ•…éšœåœºæ™¯å›¾ï¼š

æ•°æ®ä¸­å¿ƒA                  æ•°æ®ä¸­å¿ƒB
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“        â”‚    Ã—      â”‚ ä»åº“        â”‚
â”‚ 192.168.1.1 â”‚  â”€â”€â”€â”€â”€â”€   â”‚ 192.168.2.1 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   ç½‘ç»œ     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  ä¸­æ–­

æ•…éšœè¡¨ç°ï¼š
â€¢ å¤åˆ¶å»¶è¿Ÿæ€¥å‰§å¢åŠ 
â€¢ ä»åº“æŠ¥é”™ï¼šLost connection
â€¢ åº”ç”¨è¿æ¥è¶…æ—¶

å¤„ç†æ–¹æ¡ˆï¼š
1. ç½‘ç»œå†—ä½™ï¼š
   - åŒç½‘å¡ç»‘å®š
   - å¤šæ¡ç½‘ç»œçº¿è·¯
   - è·¨æœºæˆ¿ä¸“çº¿å¤‡ä»½

2. è¿æ¥ä¿æŒï¼š
   - TCP keepalive
   - åº”ç”¨å±‚å¿ƒè·³
   - è¿æ¥æ± é‡è¿æœºåˆ¶

3. é™çº§ç­–ç•¥ï¼š
   - è¯»æ“ä½œåˆ‡æ¢åˆ°æœ¬åœ°ä»åº“
   - å†™æ“ä½œæš‚å­˜é˜Ÿåˆ—
   - ç½‘ç»œæ¢å¤åæ•°æ®åŒæ­¥
```

##### ğŸ”¹ è½¯ä»¶æ•…éšœå¤„ç†


**âš™ï¸ MySQLè¿›ç¨‹æ•…éšœ**
```
æ•…éšœæ£€æµ‹è„šæœ¬ç¤ºä¾‹ï¼š

#!/bin/bash
# MySQLå¥åº·æ£€æŸ¥è„šæœ¬

check_mysql_health() {
    # 1. æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
    if ! pgrep mysqld > /dev/null; then
        echo "ERROR: MySQLè¿›ç¨‹æœªè¿è¡Œ"
        return 1
    fi
    
    # 2. æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
    if ! netstat -ln | grep :3306 > /dev/null; then
        echo "ERROR: MySQLç«¯å£æœªç›‘å¬"
        return 1
    fi
    
    # 3. æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if ! mysql -u monitor -p"$MONITOR_PASSWORD" \
               -e "SELECT 1" > /dev/null 2>&1; then
        echo "ERROR: æ— æ³•è¿æ¥æ•°æ®åº“"
        return 1
    fi
    
    # 4. æ£€æŸ¥å¤åˆ¶çŠ¶æ€ï¼ˆä»åº“ï¼‰
    if [ "$SERVER_ROLE" = "slave" ]; then
        slave_status=$(mysql -u monitor -p"$MONITOR_PASSWORD" \
                      -e "SHOW SLAVE STATUS\G" | grep "Slave_SQL_Running")
        if [[ $slave_status != *"Yes"* ]]; then
            echo "ERROR: ä»åº“å¤åˆ¶ä¸­æ–­"
            return 1
        fi
    fi
    
    echo "INFO: MySQLè¿è¡Œæ­£å¸¸"
    return 0
}

# è‡ªåŠ¨é‡å¯æœºåˆ¶
if ! check_mysql_health; then
    echo "INFO: å°è¯•é‡å¯MySQLæœåŠ¡"
    systemctl restart mysqld
    sleep 10
    
    if check_mysql_health; then
        echo "INFO: MySQLé‡å¯æˆåŠŸ"
    else
        echo "ERROR: MySQLé‡å¯å¤±è´¥ï¼Œå‘é€å‘Šè­¦"
        # å‘é€å‘Šè­¦é€šçŸ¥
        send_alert "MySQLé‡å¯å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
    fi
fi
```

### 4.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


##### ğŸ”¹ åŒæ­¥å¤åˆ¶æœºåˆ¶


**ğŸ”„ åŠåŒæ­¥å¤åˆ¶é…ç½®**
```sql
-- ä¸»åº“é…ç½®åŠåŒæ­¥å¤åˆ¶
-- å®‰è£…åŠåŒæ­¥æ’ä»¶
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';

-- å¯ç”¨åŠåŒæ­¥å¤åˆ¶
SET GLOBAL rpl_semi_sync_master_enabled = 1;
SET GLOBAL rpl_semi_sync_master_timeout = 1000;  -- 1ç§’è¶…æ—¶

-- æŸ¥çœ‹åŠåŒæ­¥çŠ¶æ€
SHOW STATUS LIKE 'Rpl_semi_sync_master%';

-- ä»åº“é…ç½®
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- é‡å¯å¤åˆ¶ä½¿é…ç½®ç”Ÿæ•ˆ
STOP SLAVE IO_THREAD;
START SLAVE IO_THREAD;
```

**åŠåŒæ­¥å¤åˆ¶å·¥ä½œæµç¨‹**
```
ä¸»åº“äº‹åŠ¡æäº¤æµç¨‹ï¼š

1. äº‹åŠ¡å¼€å§‹
   â†“
2. æ‰§è¡ŒSQLè¯­å¥
   â†“  
3. å†™å…¥binlog
   â†“
4. ç­‰å¾…ä»åº“ç¡®è®¤ â†â”€â”€ ä»åº“æ¥æ”¶binlog
   â†“                     â†“
5. æ”¶åˆ°ç¡®è®¤          å‘é€ACKç¡®è®¤
   â†“
6. æäº¤äº‹åŠ¡
   â†“
7. è¿”å›å®¢æˆ·ç«¯

å¦‚æœè¶…æ—¶æœªæ”¶åˆ°ç¡®è®¤ï¼š
â€¢ è‡ªåŠ¨é™çº§ä¸ºå¼‚æ­¥å¤åˆ¶
â€¢ è®°å½•å‘Šè­¦æ—¥å¿—
â€¢ ç»§ç»­å¤„ç†åç»­äº‹åŠ¡
```

##### ğŸ”¹ æ•°æ®æ ¡éªŒæœºåˆ¶


**ğŸ” ä¸»ä»æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**
```sql
-- ä½¿ç”¨pt-table-checksumå·¥å…·æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
pt-table-checksum \
  --host=ä¸»åº“IP \
  --user=checksum_user \
  --password=password \
  --databases=éœ€è¦æ£€æŸ¥çš„æ•°æ®åº“ \
  --replicate=percona.checksums

-- æ£€æŸ¥ç»“æœ
SELECT 
    db, tbl, chunk, 
    master_crc, master_cnt,
    slave_crc, slave_cnt,
    CASE WHEN master_crc = slave_crc THEN 'OK' ELSE 'DIFF' END as status
FROM percona.checksums 
WHERE slave_crc IS NOT NULL;
```

### 4.4 æ•…éšœè½¬ç§»æœºåˆ¶


##### ğŸ”¹ è‡ªåŠ¨æ•…éšœè½¬ç§»


**ğŸ¤– MHAï¼ˆMaster High Availabilityï¼‰æ¶æ„**
```
MHAç»„ä»¶æ¶æ„ï¼š

MHA Managerï¼ˆç®¡ç†èŠ‚ç‚¹ï¼‰
        â”‚
        â”œâ”€â”€ ç›‘æ§ä¸»åº“çŠ¶æ€
        â”œâ”€â”€ æ‰§è¡Œæ•…éšœè½¬ç§»
        â””â”€â”€ ç®¡ç†é…ç½®æ–‡ä»¶
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQLé›†ç¾¤                   â”‚
â”œâ”€â”€ ä¸»åº“ï¼ˆPrimaryï¼‰           â”‚
â”œâ”€â”€ ä»åº“1ï¼ˆå€™é€‰ä¸»åº“ï¼‰         â”‚  
â”œâ”€â”€ ä»åº“2ï¼ˆåªè¯»ï¼‰             â”‚
â””â”€â”€ ä»åº“3ï¼ˆåªè¯»ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•…éšœè½¬ç§»æµç¨‹ï¼š
1. æ£€æµ‹ä¸»åº“æ•…éšœï¼ˆpingã€è¿æ¥æ£€æŸ¥ï¼‰
2. é€‰æ‹©æœ€ä½³å€™é€‰ä¸»åº“ï¼ˆæ•°æ®æœ€æ–°ã€å»¶è¿Ÿæœ€å°ï¼‰
3. æå‡å€™é€‰ä¸»åº“ä¸ºæ–°ä¸»åº“
4. é‡æ–°é…ç½®å…¶ä»–ä»åº“æŒ‡å‘æ–°ä¸»åº“
5. æ›´æ–°åº”ç”¨ç¨‹åºè¿æ¥é…ç½®
```

**MHAé…ç½®ç¤ºä¾‹**
```bash
# MHAé…ç½®æ–‡ä»¶ /etc/mha/mysql_cluster.conf
[server default]
user=mha_user
password=mha_password
ssh_user=root
repl_user=repl_user
repl_password=repl_password

# ç®¡ç†é…ç½®
manager_workdir=/var/log/mha
manager_log=/var/log/mha/manager.log
remote_workdir=/tmp

# æ•…éšœè½¬ç§»è„šæœ¬
master_ip_failover_script=/usr/local/bin/master_ip_failover
shutdown_script=/usr/local/bin/power_manager

[server1]
hostname=192.168.1.100
candidate_master=1

[server2]
hostname=192.168.1.101  
candidate_master=1

[server3]
hostname=192.168.1.102
no_master=1  # ä¸èƒ½æˆä¸ºä¸»åº“
```

##### ğŸ”¹ æ‰‹åŠ¨æ•…éšœè½¬ç§»


**ğŸ”§ ç´§æ€¥åˆ‡æ¢æ­¥éª¤**
```bash
# 1. åœæ­¢åº”ç”¨ç¨‹åºå†™å…¥
echo "åœæ­¢åº”ç”¨å†™å…¥æ“ä½œ"

# 2. ç¡®è®¤ä»åº“æ•°æ®åŒæ­¥å®Œæˆ
mysql -h ä»åº“IP -e "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master"

# 3. åœæ­¢ä»åº“å¤åˆ¶
mysql -h ä»åº“IP -e "STOP SLAVE;"

# 4. æå‡ä»åº“ä¸ºä¸»åº“
mysql -h ä»åº“IP -e "RESET SLAVE ALL;"
mysql -h ä»åº“IP -e "RESET MASTER;"

# 5. é…ç½®å…¶ä»–ä»åº“æŒ‡å‘æ–°ä¸»åº“
mysql -h å…¶ä»–ä»åº“IP -e "
STOP SLAVE;
CHANGE MASTER TO
  MASTER_HOST='æ–°ä¸»åº“IP',
  MASTER_USER='repl_user',
  MASTER_PASSWORD='repl_password',
  MASTER_AUTO_POSITION=1;
START SLAVE;
"

# 6. æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®
echo "æ›´æ–°åº”ç”¨ç¨‹åºæ•°æ®åº“è¿æ¥é…ç½®"

# 7. æ¢å¤åº”ç”¨ç¨‹åºæœåŠ¡
echo "æ¢å¤åº”ç”¨ç¨‹åºå†™å…¥æ“ä½œ"
```

---

## 5. ğŸ¢ å¤šå±‚æ¶æ„è®¾è®¡


### 5.1 å¤šå±‚æ¶æ„çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤šå±‚æ¶æ„**

```
ç®€å•ç†è§£ï¼šå°±åƒå…¬å¸çš„å±‚çº§ç®¡ç†
â€¢ æ¥å…¥å±‚ï¼šå‰å°æ¥å¾…ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
â€¢ åº”ç”¨å±‚ï¼šä¸šåŠ¡éƒ¨é—¨ï¼ˆåº”ç”¨æœåŠ¡å™¨ï¼‰
â€¢ æ•°æ®å±‚ï¼šæ¡£æ¡ˆå®¤ï¼ˆæ•°æ®åº“æœåŠ¡å™¨ï¼‰
â€¢ å­˜å‚¨å±‚ï¼šä»“åº“ï¼ˆå­˜å‚¨ç³»ç»Ÿï¼‰

æ¯ä¸€å±‚éƒ½æœ‰ä¸“é—¨çš„èŒè´£ï¼Œå±‚ä¸å±‚ä¹‹é—´é€šè¿‡æ ‡å‡†æ¥å£é€šä¿¡
```

### 5.2 æ¥å…¥å±‚è®¾è®¡


##### ğŸ”¹ è´Ÿè½½å‡è¡¡å™¨é…ç½®


**ğŸŒ Layer 4 vs Layer 7 è´Ÿè½½å‡è¡¡**
```
Layer 4ï¼ˆä¼ è¾“å±‚ï¼‰è´Ÿè½½å‡è¡¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚    â”‚  è´Ÿè½½å‡è¡¡å™¨   â”‚
â”‚              â”‚â”€â”€â”€â”€â”‚   (LVS)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ TCPè½¬å‘
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MySQLé›†ç¾¤    â”‚
                    â”œâ”€â”€ ä¸»åº“:3306  â”‚
                    â”œâ”€â”€ ä»åº“1:3306 â”‚
                    â””â”€â”€ ä»åº“2:3306 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ åŸºäºIPå’Œç«¯å£è½¬å‘
â€¢ æ€§èƒ½é«˜ï¼Œå»¶è¿Ÿä½
â€¢ ä¸è§£æSQLå†…å®¹
â€¢ é€‚åˆæ•°æ®åº“è¿æ¥è´Ÿè½½å‡è¡¡

Layer 7ï¼ˆåº”ç”¨å±‚ï¼‰è´Ÿè½½å‡è¡¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨ç¨‹åº   â”‚    â”‚  ä»£ç†å±‚      â”‚
â”‚              â”‚â”€â”€â”€â”€â”‚ (ProxySQL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ SQLè·¯ç”±
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ MySQLé›†ç¾¤    â”‚
                    â”œâ”€â”€ å†™æ“ä½œâ†’ä¸»åº“â”‚
                    â”œâ”€â”€ è¯»æ“ä½œâ†’ä»åº“â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ å¯ä»¥è§£æSQLè¯­å¥
â€¢ æ™ºèƒ½è·¯ç”±ï¼ˆè¯»å†™åˆ†ç¦»ï¼‰
â€¢ è¿æ¥æ± ç®¡ç†
â€¢ æŸ¥è¯¢ç¼“å­˜å’Œé‡å†™
```

##### ğŸ”¹ ProxySQLé…ç½®ç¤ºä¾‹


**ğŸ“‹ ProxySQLåŸºç¡€é…ç½®**
```sql
-- ProxySQLç®¡ç†æ¥å£é…ç½®

-- 1. é…ç½®åç«¯MySQLæœåŠ¡å™¨
INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight) VALUES
(0, '192.168.1.100', 3306, 1000),  -- ä¸»åº“ï¼ˆå†™ç»„ï¼‰
(1, '192.168.1.101', 3306, 900),   -- ä»åº“1ï¼ˆè¯»ç»„ï¼‰
(1, '192.168.1.102', 3306, 900);   -- ä»åº“2ï¼ˆè¯»ç»„ï¼‰

-- 2. é…ç½®ç”¨æˆ·è´¦å·
INSERT INTO mysql_users(username, password, default_hostgroup) VALUES
('app_user', 'app_password', 0);

-- 3. é…ç½®è¯»å†™åˆ†ç¦»è§„åˆ™
INSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply) VALUES
(1, '^SELECT.*', 1, 1),           -- è¯»æŸ¥è¯¢è·¯ç”±åˆ°ä»åº“ç»„
(2, '^INSERT|UPDATE|DELETE.*', 0, 1);  -- å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“ç»„

-- 4. ç”Ÿæ•ˆé…ç½®
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL USERS TO RUNTIME;
LOAD MYSQL QUERY_RULES TO RUNTIME;

-- 5. æŒä¹…åŒ–é…ç½®
SAVE MYSQL SERVERS TO DISK;
SAVE MYSQL USERS TO DISK;
SAVE MYSQL QUERY_RULES TO DISK;
```

### 5.3 åº”ç”¨å±‚è®¾è®¡


##### ğŸ”¹ è¿æ¥æ± é…ç½®


**ğŸŠâ€â™‚ï¸ æ•°æ®åº“è¿æ¥æ± è®¾è®¡**
```java
// HikariCPè¿æ¥æ± é…ç½®ç¤ºä¾‹
@Configuration
public class DatabaseConfig {
    
    // ä¸»åº“è¿æ¥æ± ï¼ˆå†™æ“ä½œï¼‰
    @Bean
    @Primary
    public DataSource masterDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://master-db:3306/myapp");
        config.setUsername("app_user");
        config.setPassword("app_password");
        
        // è¿æ¥æ± å¤§å°
        config.setMaximumPoolSize(20);        // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);             // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);   // è¿æ¥è¶…æ—¶30ç§’
        config.setIdleTimeout(600000);        // ç©ºé—²è¿æ¥å­˜æ´»10åˆ†é’Ÿ
        config.setMaxLifetime(1800000);       // è¿æ¥æœ€å¤§å­˜æ´»30åˆ†é’Ÿ
        
        // è¿æ¥æ£€æµ‹
        config.setConnectionTestQuery("SELECT 1");
        config.setValidationTimeout(5000);
        
        return new HikariDataSource(config);
    }
    
    // ä»åº“è¿æ¥æ± ï¼ˆè¯»æ“ä½œï¼‰
    @Bean
    public DataSource slaveDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://slave-db:3306/myapp");
        config.setUsername("readonly_user");
        config.setPassword("readonly_password");
        
        // è¯»åº“å¯ä»¥è®¾ç½®æ›´å¤§çš„è¿æ¥æ± 
        config.setMaximumPoolSize(50);
        config.setMinimumIdle(10);
        config.setReadOnly(true);  // æ ‡è®°ä¸ºåªè¯»
        
        return new HikariDataSource(config);
    }
}
```

##### ğŸ”¹ æ™ºèƒ½è·¯ç”±ç­–ç•¥


**ğŸ§  è¯»å†™åˆ†ç¦»è·¯ç”±å®ç°**
```java
@Component
public class DatabaseRouter {
    
    @Autowired
    @Qualifier("masterDataSource")
    private DataSource masterDS;
    
    @Autowired  
    @Qualifier("slaveDataSource")
    private DataSource slaveDS;
    
    // åŸºäºæ³¨è§£çš„è·¯ç”±
    @Around("@annotation(readOnly)")
    public Object routeToSlave(ProceedingJoinPoint joinPoint, ReadOnly readOnly) {
        try {
            // è®¾ç½®å½“å‰çº¿ç¨‹ä½¿ç”¨ä»åº“
            DatabaseContextHolder.setDataSourceType(DataSourceType.SLAVE);
            return joinPoint.proceed();
        } finally {
            // æ¸…ç†çº¿ç¨‹ä¸Šä¸‹æ–‡
            DatabaseContextHolder.clearDataSourceType();
        }
    }
    
    // åŸºäºSQLåˆ†æçš„è·¯ç”±
    public DataSource getDataSource(String sql) {
        String trimmedSQL = sql.trim().toUpperCase();
        
        // äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½è·¯ç”±åˆ°ä¸»åº“
        if (TransactionSynchronizationManager.isActualTransactionActive()) {
            return masterDS;
        }
        
        // åˆ†æSQLç±»å‹
        if (isReadOperation(trimmedSQL)) {
            return slaveDS;
        } else {
            return masterDS;
        }
    }
    
    private boolean isReadOperation(String sql) {
        return sql.startsWith("SELECT") && 
               !sql.contains("FOR UPDATE") && 
               !sql.contains("LOCK IN SHARE MODE");
    }
}
```

### 5.4 æ•°æ®å±‚è®¾è®¡


##### ğŸ”¹ æ•°æ®åˆ†å±‚ç­–ç•¥


**ğŸ“š æ•°æ®åº“åˆ†å±‚æ¶æ„**
```
åˆ†å±‚æ¶æ„ç¤ºä¾‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜å±‚ï¼ˆCache Layerï¼‰            â”‚
â”œâ”€â”€ Redisé›†ç¾¤                    â”‚
â”œâ”€â”€ Memcached                   â”‚  
â””â”€â”€ åº”ç”¨æœ¬åœ°ç¼“å­˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ç¼“å­˜æœªå‘½ä¸­
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®è®¿é—®å±‚ï¼ˆData Access Layerï¼‰  â”‚
â”œâ”€â”€ è¯»å†™åˆ†ç¦»                     â”‚
â”œâ”€â”€ åˆ†åº“åˆ†è¡¨                     â”‚
â””â”€â”€ è¿æ¥æ± ç®¡ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®å­˜å‚¨å±‚ï¼ˆStorage Layerï¼‰      â”‚
â”œâ”€â”€ MySQLä¸»ä»é›†ç¾¤                â”‚
â”œâ”€â”€ åˆ†ç‰‡é›†ç¾¤                     â”‚
â””â”€â”€ å¤‡ä»½å’Œå½’æ¡£                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ”¹ ç¼“å­˜é›†æˆç­–ç•¥


**âš¡ å¤šçº§ç¼“å­˜è®¾è®¡**
```java
@Service
public class UserService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserRepository userRepository;
    
    // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜
    private final Cache<String, User> localCache = 
        Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    
    public User getUserById(Long userId) {
        String cacheKey = "user:" + userId;
        
        // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
        User user = localCache.getIfPresent(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 2. æ£€æŸ¥Redisç¼“å­˜
        user = (User) redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            localCache.put(cacheKey, user);  // å›å¡«æœ¬åœ°ç¼“å­˜
            return user;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“ï¼ˆä½¿ç”¨ä»åº“ï¼‰
        user = userRepository.findById(userId);
        if (user != null) {
            // å›å¡«ä¸¤çº§ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, user, 
                Duration.ofMinutes(30));
            localCache.put(cacheKey, user);
        }
        
        return user;
    }
    
    @Transactional  // å†™æ“ä½œä½¿ç”¨ä¸»åº“
    public void updateUser(User user) {
        userRepository.save(user);
        
        // æ¸…ç†ç¼“å­˜
        String cacheKey = "user:" + user.getId();
        localCache.invalidate(cacheKey);
        redisTemplate.delete(cacheKey);
    }
}
```

### 5.5 ç›‘æ§å±‚è®¾è®¡


##### ğŸ”¹ å…¨é“¾è·¯ç›‘æ§


**ğŸ“Š ç›‘æ§æŒ‡æ ‡ä½“ç³»**
```
ç›‘æ§å±‚çº§æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡ç›‘æ§ï¼ˆBusiness Metricsï¼‰     â”‚
â”œâ”€â”€ ç”¨æˆ·æ´»è·ƒåº¦                   â”‚
â”œâ”€â”€ è®¢å•è½¬åŒ–ç‡                   â”‚
â””â”€â”€ ä¸šåŠ¡å¼‚å¸¸ç‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ç›‘æ§ï¼ˆApplication Metricsï¼‰  â”‚
â”œâ”€â”€ APIå“åº”æ—¶é—´                  â”‚
â”œâ”€â”€ é”™è¯¯ç‡                       â”‚
â”œâ”€â”€ ååé‡                       â”‚
â””â”€â”€ JVMæŒ‡æ ‡                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­é—´ä»¶ç›‘æ§ï¼ˆMiddleware Metricsï¼‰ â”‚
â”œâ”€â”€ æ•°æ®åº“è¿æ¥æ±                   â”‚
â”œâ”€â”€ ç¼“å­˜å‘½ä¸­ç‡                   â”‚
â”œâ”€â”€ æ¶ˆæ¯é˜Ÿåˆ—ç§¯å‹                  â”‚
â””â”€â”€ è´Ÿè½½å‡è¡¡çŠ¶æ€                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸºç¡€è®¾æ–½ç›‘æ§ï¼ˆInfrastructureï¼‰   â”‚
â”œâ”€â”€ CPUã€å†…å­˜ã€ç£ç›˜               â”‚
â”œâ”€â”€ ç½‘ç»œæµé‡                     â”‚
â”œâ”€â”€ MySQLæ€§èƒ½æŒ‡æ ‡                â”‚
â””â”€â”€ æœåŠ¡å™¨çŠ¶æ€                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®æ—¶ç›‘æ§é…ç½®**
```yaml
# Prometheusé…ç½®ç¤ºä¾‹
global:
  scrape_interval: 15s

scrape_configs:
  # MySQLç›‘æ§
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-master:9104', 'mysql-slave1:9104']
    scrape_interval: 10s
    metrics_path: /metrics

  # åº”ç”¨ç›‘æ§
  - job_name: 'spring-boot-app'
    static_configs:
      - targets: ['app1:8080', 'app2:8080']
    metrics_path: /actuator/prometheus

# å‘Šè­¦è§„åˆ™
rule_files:
  - "mysql_alerts.yml"
  - "application_alerts.yml"
```

---

## 6. ğŸš« æ— å•ç‚¹æ•…éšœè®¾è®¡


### 6.1 å•ç‚¹æ•…éšœçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰**

```
ç®€å•ç†è§£ï¼šç³»ç»Ÿä¸­çš„å…³é”®ç¯èŠ‚åªæœ‰ä¸€ä¸ªï¼Œä¸€æ—¦å‡ºé—®é¢˜æ•´ä¸ªç³»ç»Ÿå°±å®äº†
å°±åƒä¸€åº§æ¡¥åªæœ‰ä¸€ä¸ªæ¡¥å¢©ï¼Œæ¡¥å¢©å€’äº†æ•´åº§æ¡¥å°±å¡Œäº†

å¸¸è§å•ç‚¹æ•…éšœï¼š
â€¢ å•å°æ•°æ®åº“æœåŠ¡å™¨
â€¢ å•ä¸ªç½‘ç»œè®¾å¤‡
â€¢ å•ä¸ªå­˜å‚¨ç³»ç»Ÿ
â€¢ å•ä¸ªè´Ÿè½½å‡è¡¡å™¨
â€¢ å•ä¸ªåº”ç”¨å®ä¾‹
```

### 6.2 æ•°æ®åº“å±‚æ— å•ç‚¹è®¾è®¡


##### ğŸ”¹ ä¸»åº“é«˜å¯ç”¨æ–¹æ¡ˆ


**ğŸ”„ åŒä¸»çƒ­å¤‡æ¶æ„**
```
åŒä¸»äº’å¤‡é…ç½®ï¼š

ä¸»åº“Aï¼ˆActiveï¼‰          ä¸»åº“Bï¼ˆStandbyï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQL-A     â”‚ â†â”€â”€â”€â”€â”€â”€â†’ â”‚ MySQL-B     â”‚
â”‚ VIP: 1.1.1.100        â”‚ 1.1.1.102   â”‚
â”‚ Real: 1.1.1.101       â”‚ å®æ—¶åŒæ­¥     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚
       â†“                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»åº“A1      â”‚          â”‚ ä»åº“B1      â”‚
â”‚ 1.1.1.111   â”‚          â”‚ 1.1.1.112   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VIPåˆ‡æ¢æœºåˆ¶ï¼š
â€¢ æ­£å¸¸æƒ…å†µï¼šVIPåœ¨ä¸»åº“Aä¸Š
â€¢ ä¸»åº“Aæ•…éšœï¼šVIPè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸»åº“B
â€¢ åº”ç”¨ç¨‹åºåªè¿æ¥VIPï¼Œæ— æ„ŸçŸ¥åˆ‡æ¢
```

**Keepalived + MySQLé…ç½®**
```bash
# /etc/keepalived/keepalived.conf (ä¸»åº“A)
vrrp_script chk_mysql {
    script "/usr/local/bin/check_mysql.sh"
    interval 2     # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
    weight -2      # æ£€æŸ¥å¤±è´¥æƒé‡-2
    fall 3         # è¿ç»­3æ¬¡å¤±è´¥æ‰åˆ¤å®šæ•…éšœ
    rise 2         # è¿ç»­2æ¬¡æˆåŠŸæ‰åˆ¤å®šæ¢å¤
}

vrrp_instance VI_1 {
    state MASTER           # ä¸»åº“Aä¸ºMASTER
    interface eth0         # ç½‘å¡æ¥å£
    virtual_router_id 51   # è™šæ‹Ÿè·¯ç”±ID
    priority 100           # ä¼˜å…ˆçº§ï¼ˆä¸»åº“é«˜äºå¤‡åº“ï¼‰
    advert_int 1           # é€šå‘Šé—´éš”
    
    authentication {
        auth_type PASS
        auth_pass mypassword
    }
    
    virtual_ipaddress {
        192.168.1.100      # VIPåœ°å€
    }
    
    track_script {
        chk_mysql          # è·Ÿè¸ªMySQLçŠ¶æ€
    }
    
    notify_master "/usr/local/bin/mysql_master.sh"
    notify_backup "/usr/local/bin/mysql_backup.sh"
    notify_fault "/usr/local/bin/mysql_fault.sh"
}
```

##### ğŸ”¹ ä»åº“é«˜å¯ç”¨æ–¹æ¡ˆ


**ğŸ“š å¤šä»åº“è´Ÿè½½å‡è¡¡**
```
ä»åº“é›†ç¾¤æ¶æ„ï¼š

                ä¸»åº“ï¼ˆVIPï¼‰
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
            â”‚       â”‚       â”‚
        ä»åº“1    ä»åº“2    ä»åº“3
        â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”
        â”‚è¯»å–â”‚   â”‚è¯»å–â”‚   â”‚åˆ†æâ”‚
        â”‚æœåŠ¡â”‚   â”‚æœåŠ¡â”‚   â”‚ä¸“ç”¨â”‚
        â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜
            â”‚       â”‚       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                è´Ÿè½½å‡è¡¡
              ï¼ˆHAProxyï¼‰

ä»åº“æ•…éšœå¤„ç†ï¼š
â€¢ è‡ªåŠ¨æ£€æµ‹ä»åº“çŠ¶æ€
â€¢ æ•…éšœä»åº“è‡ªåŠ¨ä»è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤
â€¢ æ•…éšœæ¢å¤åè‡ªåŠ¨åŠ å…¥è´Ÿè½½å‡è¡¡
â€¢ è‡³å°‘ä¿æŒ2ä¸ªä»åº“æ­£å¸¸è¿è¡Œ
```

### 6.3 ç½‘ç»œå±‚æ— å•ç‚¹è®¾è®¡


##### ğŸ”¹ è´Ÿè½½å‡è¡¡å™¨é«˜å¯ç”¨


**ğŸ”— HAProxyåŒæœºçƒ­å¤‡**
```
è´Ÿè½½å‡è¡¡å™¨åŒæ´»æ¶æ„ï¼š

         å®¢æˆ·ç«¯è¯·æ±‚
              â”‚
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   VIPè·¯ç”±       â”‚ â† DNSè½®è¯¢æˆ–BGPè·¯ç”±
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
HAProxy-1        HAProxy-2
(Master)         (Backup)
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
         MySQLé›†ç¾¤

é…ç½®è¦ç‚¹ï¼š
â€¢ ä¸¤å°HAProxyå…±äº«é…ç½®
â€¢ é€šè¿‡Keepalivedç®¡ç†VIP
â€¢ å¿ƒè·³æ£€æµ‹å’Œè‡ªåŠ¨åˆ‡æ¢
â€¢ é…ç½®åŒæ­¥æœºåˆ¶
```

**HAProxyé…ç½®ç¤ºä¾‹**
```bash
# /etc/haproxy/haproxy.cfg
global
    daemon
    maxconn 4096
    log 127.0.0.1:514 local0

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

# MySQLè¯»å†™åˆ†ç¦»é…ç½®
frontend mysql_frontend
    bind *:3306
    mode tcp
    default_backend mysql_backend

backend mysql_backend
    mode tcp
    balance roundrobin
    option mysql-check user haproxy_check
    
    # ä¸»åº“ï¼ˆæƒé‡é«˜ï¼Œå¤„ç†å†™æ“ä½œï¼‰
    server mysql-master 192.168.1.101:3306 check weight 100
    
    # ä»åº“ï¼ˆå¤„ç†è¯»æ“ä½œï¼‰
    server mysql-slave1 192.168.1.102:3306 check weight 50
    server mysql-slave2 192.168.1.103:3306 check weight 50

# ç›‘æ§é¡µé¢
frontend stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 30s
```

##### ğŸ”¹ ç½‘ç»œè¿æ¥å†—ä½™


**ğŸŒ å¤šè·¯ç½‘ç»œè®¾è®¡**
```
ç½‘ç»œå†—ä½™æ¶æ„ï¼š

æœºæˆ¿A                           æœºæˆ¿B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“           â”‚           â”‚ ä»åº“           â”‚
â”‚ åŒç½‘å¡ç»‘å®š      â”‚           â”‚ åŒç½‘å¡ç»‘å®š      â”‚  
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”   â”‚           â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚eth0 â”‚eth1 â”‚   â”‚<â”€â”€ä¸“çº¿1â”€â”€>â”‚ â”‚eth0 â”‚eth1 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜   â”‚           â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      bond0      â”‚<â”€â”€ä¸“çº¿2â”€â”€>â”‚      bond0      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚äº¤æ¢æœºA1 â”‚                   â”‚äº¤æ¢æœºB1 â”‚
    â”‚äº¤æ¢æœºA2 â”‚                   â”‚äº¤æ¢æœºB2 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†—ä½™ç‰¹ç‚¹ï¼š
â€¢ åŒç½‘å¡ç»‘å®šï¼ˆbond0ï¼‰
â€¢ åŒäº¤æ¢æœºè¿æ¥
â€¢ åŒä¸“çº¿è¿æ¥
â€¢ è‡ªåŠ¨æ•…éšœåˆ‡æ¢
```

### 6.4 åº”ç”¨å±‚æ— å•ç‚¹è®¾è®¡


##### ğŸ”¹ åº”ç”¨æœåŠ¡å™¨é›†ç¾¤


**ğŸ–¥ï¸ æ— çŠ¶æ€åº”ç”¨è®¾è®¡**
```java
// æ— çŠ¶æ€åº”ç”¨è®¾è®¡åŸåˆ™
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // âŒ é”™è¯¯ï¼šåœ¨åº”ç”¨ä¸­ä¿å­˜çŠ¶æ€
    // private Map<String, User> userCache = new HashMap<>();
    
    // âœ… æ­£ç¡®ï¼šçŠ¶æ€ä¿å­˜åœ¨å¤–éƒ¨å­˜å‚¨
    @GetMapping("/user/{id}")
    public User getUser(@PathVariable Long id, HttpServletRequest request) {
        // ä»Redisè·å–ä¼šè¯ä¿¡æ¯
        String sessionId = request.getHeader("X-Session-Id");
        Object sessionData = redisTemplate.opsForValue().get("session:" + sessionId);
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        return userService.getUserById(id);
    }
    
    // çŠ¶æ€ä¿¡æ¯éƒ½ä¿å­˜åœ¨Redisä¸­ï¼Œåº”ç”¨æœåŠ¡å™¨å¯ä»¥éšæ„é‡å¯
    @PostMapping("/user/{id}/update")
    public void updateUser(@PathVariable Long id, @RequestBody User user) {
        userService.updateUser(user);
        
        // æ¸…ç†ç›¸å…³ç¼“å­˜
        redisTemplate.delete("user:" + id);
    }
}
```

##### ğŸ”¹ ä¼šè¯ç®¡ç†é«˜å¯ç”¨


**ğŸ” Redisä¼šè¯é›†ç¾¤**
```
ä¼šè¯é«˜å¯ç”¨æ¶æ„ï¼š

    åº”ç”¨æœåŠ¡å™¨é›†ç¾¤
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚App1 â”‚App2 â”‚App3 â”‚App4 â”‚
â””â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”€â”˜
   â”‚     â”‚     â”‚     â”‚
   â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
         â”‚     â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Redis Cluster â”‚
    â”œâ”€ Master-1     â”‚
    â”œâ”€ Master-2     â”‚  
    â”œâ”€ Master-3     â”‚
    â”œâ”€ Slave-1      â”‚
    â”œâ”€ Slave-2      â”‚
    â””â”€ Slave-3      â””

ç‰¹ç‚¹ï¼š
â€¢ ä»»ä½•åº”ç”¨æœåŠ¡å™¨éƒ½å¯ä»¥å¤„ç†ä»»ä½•ç”¨æˆ·è¯·æ±‚
â€¢ ä¼šè¯æ•°æ®åœ¨Redisé›†ç¾¤ä¸­é«˜å¯ç”¨å­˜å‚¨
â€¢ åº”ç”¨æœåŠ¡å™¨æ•…éšœä¸å½±å“ç”¨æˆ·ä¼šè¯
â€¢ æ”¯æŒæ°´å¹³æ‰©å±•
```

### 6.5 å­˜å‚¨å±‚æ— å•ç‚¹è®¾è®¡


##### ğŸ”¹ åˆ†å¸ƒå¼å­˜å‚¨æ–¹æ¡ˆ


**ğŸ’¾ MySQL + åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ**
```
å­˜å‚¨æ¶æ„è®¾è®¡ï¼š

                  åº”ç”¨å±‚
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
ç»“æ„åŒ–æ•°æ®          åŠç»“æ„åŒ–æ•°æ®      éç»“æ„åŒ–æ•°æ®
    â”‚                â”‚                â”‚
    â†“                â†“                â†“
MySQLé›†ç¾¤         MongoDBé›†ç¾¤        åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»ä»å¤åˆ¶ â”‚      â”‚ å‰¯æœ¬é›†  â”‚        â”‚  HDFS   â”‚
â”‚ è¯»å†™åˆ†ç¦» â”‚      â”‚ åˆ†ç‰‡    â”‚        â”‚  GlusterFS â”‚
â”‚ åˆ†åº“åˆ†è¡¨ â”‚      â”‚ è‡ªåŠ¨æ•…éšœâ”‚        â”‚  Ceph   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®åˆ†ç±»å­˜å‚¨ï¼š
â€¢ äº‹åŠ¡æ€§æ•°æ® â†’ MySQLé›†ç¾¤
â€¢ æ–‡æ¡£æ•°æ® â†’ MongoDB
â€¢ æ–‡ä»¶å’Œå›¾ç‰‡ â†’ åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ
â€¢ æ—¥å¿—æ•°æ® â†’ Elasticsearch
```

##### ğŸ”¹ å¤‡ä»½å’Œæ¢å¤ç­–ç•¥


**ğŸ“‹ å¤šé‡å¤‡ä»½æœºåˆ¶**
```
å¤‡ä»½ç­–ç•¥æ¶æ„ï¼š

ç”Ÿäº§ç¯å¢ƒ                    å¤‡ä»½ç¯å¢ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“        â”‚           â”‚ çƒ­å¤‡        â”‚
â”‚ 1.1.1.101   â”‚â”€â”€å®æ—¶åŒæ­¥â”€â†’â”‚ 2.2.2.101   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â”‚                         â”‚
   å®šæ—¶å¤‡ä»½                   å®šæ—¶å¤‡ä»½
       â”‚                         â”‚
       â†“                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ¬åœ°å­˜å‚¨    â”‚           â”‚ å¼‚åœ°å­˜å‚¨    â”‚
â”‚ å…¨é‡+å¢é‡   â”‚           â”‚ å…¨é‡+å¢é‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº‘ç«¯å­˜å‚¨ â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ å¯¹è±¡å­˜å‚¨    â”‚
              â”‚ (S3/OSS)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤‡ä»½å±‚æ¬¡ï¼š
â€¢ å®æ—¶ï¼šä¸»ä»åŒæ­¥
â€¢ å°æ—¶ï¼šbinlogå¤‡ä»½
â€¢ å¤©ï¼šå…¨é‡å¤‡ä»½
â€¢ å‘¨ï¼šå¼‚åœ°å¤‡ä»½
â€¢ æœˆï¼šé•¿æœŸå½’æ¡£
```

---

## 7. ğŸ”„ æ¶æ„æ¼”è¿›ç­–ç•¥


### 7.1 æ¶æ„æ¼”è¿›çš„åŸºæœ¬åŸåˆ™


**ğŸ”¸ æ¶æ„æ¼”è¿›çš„å¿…è¦æ€§**

```
ä¸ºä»€ä¹ˆæ¶æ„éœ€è¦æ¼”è¿›ï¼Ÿ
â€¢ ä¸šåŠ¡éœ€æ±‚å˜åŒ–ï¼šç”¨æˆ·é‡å¢é•¿ã€åŠŸèƒ½å¤æ‚åŒ–
â€¢ æŠ€æœ¯æ ˆæ›´æ–°ï¼šæ–°æŠ€æœ¯çš„å‡ºç°å’Œæˆç†Ÿ
â€¢ æ€§èƒ½ç“¶é¢ˆï¼šç°æœ‰æ¶æ„æ— æ³•æ”¯æ’‘æ›´å¤§è§„æ¨¡
â€¢ æˆæœ¬ä¼˜åŒ–ï¼šé€šè¿‡æ¶æ„è°ƒæ•´é™ä½è¿ç»´æˆæœ¬

æ¼”è¿›åŸåˆ™ï¼š
ğŸ¯ æ¸è¿›å¼æ¼”è¿›ï¼šå°æ­¥å¿«è·‘ï¼Œé¿å…å¤§çˆ†ç‚¸å¼æ”¹é€ 
ğŸ¯ å‘åå…¼å®¹ï¼šæ–°æ¶æ„å…¼å®¹æ—§ç³»ç»Ÿ
ğŸ¯ é£é™©å¯æ§ï¼šæ¯æ¬¡å˜æ›´éƒ½æœ‰å›æ»šæ–¹æ¡ˆ
ğŸ¯ æ•°æ®ä¸ºå…ˆï¼šä¼˜å…ˆä¿è¯æ•°æ®å®‰å…¨å’Œä¸€è‡´æ€§
```

### 7.2 å…¸å‹æ¶æ„æ¼”è¿›è·¯å¾„


##### ğŸ”¹ ç¬¬ä¸€é˜¶æ®µï¼šå•æœºæ¶æ„


**ğŸ’» åˆåˆ›æœŸæ¶æ„ç‰¹ç‚¹**
```
å•æœºéƒ¨ç½²ç¤ºä¾‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å•å°æœåŠ¡å™¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Web    â”‚ â”‚   MySQL     â”‚    â”‚
â”‚  â”‚ åº”ç”¨    â”‚ â”‚   æ•°æ®åº“    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ æ‰€æœ‰ç»„ä»¶åœ¨ä¸€å°æœåŠ¡å™¨ä¸Š
â€¢ å¼€å‘å’Œéƒ¨ç½²ç®€å•
â€¢ æˆæœ¬ä½ï¼Œç»´æŠ¤ç®€å•
â€¢ æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾

é€‚ç”¨åœºæ™¯ï¼š
â€¢ ç”¨æˆ·é‡ < 1000
â€¢ æ—¥è®¿é—®é‡ < 10ä¸‡
â€¢ æ•°æ®é‡ < 1GB
â€¢ å›¢é˜Ÿè§„æ¨¡ < 5äºº
```

##### ğŸ”¹ ç¬¬äºŒé˜¶æ®µï¼šè¯»å†™åˆ†ç¦»


**ğŸ“š æ•°æ®åº“å‹åŠ›åˆ†ç¦»**
```
è¯»å†™åˆ†ç¦»æ¶æ„ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Webåº”ç”¨    â”‚
    â”‚  æœåŠ¡å™¨     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
    â†“ å†™æ“ä½œ      â†“ è¯»æ“ä½œ  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“    â”‚â”€â”€â”‚ ä»åº“    â”‚
â”‚ Master  â”‚  â”‚ Slave   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¼”è¿›è§¦å‘æ¡ä»¶ï¼š
â€¢ æ•°æ®åº“CPUä½¿ç”¨ç‡ > 70%
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´å¢é•¿
â€¢ å¹¶å‘è¿æ¥æ•°æ¥è¿‘ä¸Šé™
â€¢ è¯»æ“ä½œå æ¯” > 80%

æ¼”è¿›æ”¶ç›Šï¼š
â€¢ è¯»æ€§èƒ½æå‡ 50-80%
â€¢ ä¸»åº“å†™å‹åŠ›å‡å°‘
â€¢ å¯æ”¯æ’‘æ›´å¤šå¹¶å‘ç”¨æˆ·
â€¢ æä¾›æ•°æ®å¤‡ä»½èƒ½åŠ›
```

##### ğŸ”¹ ç¬¬ä¸‰é˜¶æ®µï¼šæœåŠ¡æ‹†åˆ†


**ğŸ—ï¸ å¾®æœåŠ¡åŒ–æ¶æ„**
```
æœåŠ¡æ‹†åˆ†æ¶æ„ï¼š

          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        â”‚        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚ç”¨æˆ·æœåŠ¡â”‚â”‚è®¢å•æœåŠ¡â”‚â”‚å•†å“æœåŠ¡â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚        â”‚        â”‚
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”â”Œâ”€â”€â”€â”´â”€â”€â”€â”
   â”‚ç”¨æˆ·åº“  â”‚â”‚è®¢å•åº“  â”‚â”‚å•†å“åº“  â”‚
   â”‚ä¸»ä»    â”‚â”‚ä¸»ä»    â”‚â”‚ä¸»ä»    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜

æ‹†åˆ†ç­–ç•¥ï¼š
ğŸ¯ æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼šç”¨æˆ·ã€è®¢å•ã€å•†å“
ğŸ¯ æŒ‰æ•°æ®ç‰¹å¾æ‹†åˆ†ï¼šè¯»å¤šå†™å°‘ã€å†™å¤šè¯»å°‘
ğŸ¯ æŒ‰å›¢é˜ŸèŒè´£æ‹†åˆ†ï¼šä¸åŒå›¢é˜Ÿè´Ÿè´£ä¸åŒæœåŠ¡
ğŸ¯ æŒ‰æ‰©å±•éœ€æ±‚æ‹†åˆ†ï¼šé«˜å¹¶å‘æœåŠ¡ç‹¬ç«‹éƒ¨ç½²

æ¼”è¿›æ”¶ç›Šï¼š
â€¢ æœåŠ¡ç‹¬ç«‹æ‰©å±•
â€¢ å›¢é˜Ÿå¹¶è¡Œå¼€å‘
â€¢ æ•…éšœéš”ç¦»
â€¢ æŠ€æœ¯æ ˆå¤šæ ·åŒ–
```

##### ğŸ”¹ ç¬¬å››é˜¶æ®µï¼šæ•°æ®åˆ†ç‰‡


**ğŸ—‚ï¸ æ°´å¹³åˆ†ç‰‡æ¶æ„**
```
åˆ†ç‰‡é›†ç¾¤æ¶æ„ï¼š

           åº”ç”¨ç¨‹åº
               â”‚
          åˆ†ç‰‡è·¯ç”±ä¸­é—´ä»¶
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚          â”‚
 åˆ†ç‰‡1       åˆ†ç‰‡2       åˆ†ç‰‡3
â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»åº“ â”‚   â”‚ ä¸»åº“ â”‚   â”‚ ä¸»åº“ â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚          â”‚          â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”   â”Œâ”€â”€â”´â”€â”€â”€â”   â”Œâ”€â”€â”´â”€â”€â”€â”
â”‚ ä»åº“ â”‚   â”‚ ä»åº“ â”‚   â”‚ ä»åº“ â”‚
â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”˜

åˆ†ç‰‡è§¦å‘æ¡ä»¶ï¼š
â€¢ å•è¡¨æ•°æ®é‡ > 1000ä¸‡è¡Œ
â€¢ å•åº“å¤§å° > 100GB
â€¢ å†™æ“ä½œTPSæ¥è¿‘ä¸Šé™
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´æŒç»­å¢é•¿

å®æ–½ç­–ç•¥ï¼š
1. é€‰æ‹©åˆ†ç‰‡é”®ï¼ˆç”¨æˆ·IDã€åœ°åŒºç­‰ï¼‰
2. è®¾è®¡åˆ†ç‰‡ç®—æ³•ï¼ˆå“ˆå¸Œã€èŒƒå›´ï¼‰
3. æ•°æ®è¿ç§»æ–¹æ¡ˆ
4. åº”ç”¨ç¨‹åºæ”¹é€ 
```

### 7.3 æ¼”è¿›è¿‡ç¨‹ç®¡æ§


##### ğŸ”¹ ç°åº¦æ¼”è¿›ç­–ç•¥


**ğŸš¥ åˆ†é˜¶æ®µåˆ‡æ¢æ–¹æ¡ˆ**
```
ç°åº¦æ¼”è¿›æµç¨‹ï¼š

é˜¶æ®µ1ï¼šåŒå†™éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å†™å…¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ç¨‹åº â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ—§æ¶æ„  â”‚
â”‚         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚    å†™å…¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ–°æ¶æ„  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                      æ•°æ®å¯¹æ¯”éªŒè¯

é˜¶æ®µ2ï¼šè¯»å–åˆ‡æ¢  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¯»å–    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ç¨‹åº â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ æ–°æ¶æ„  â”‚
â”‚         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚    å†™å…¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ—§æ¶æ„  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é˜¶æ®µ3ï¼šå®Œå…¨åˆ‡æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨ç¨‹åº â”‚ â†â”€â”€â”€â”€â”€â”€â†’ â”‚ æ–°æ¶æ„  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ æ—§æ¶æ„  â”‚ï¼ˆå¤‡ç”¨ï¼‰
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### ğŸ”¹ å›æ»šæ–¹æ¡ˆè®¾è®¡


**âª å¿«é€Ÿå›æ»šæœºåˆ¶**
```java
// æ¼”è¿›è¿‡ç¨‹ä¸­çš„å¼€å…³æ§åˆ¶
@Component
public class ArchitectureSwitch {
    
    @Value("${feature.new-architecture.enabled:false}")
    private boolean newArchitectureEnabled;
    
    @Value("${feature.new-architecture.traffic-percentage:0}")
    private int trafficPercentage;
    
    @Autowired
    private OldArchitectureService oldService;
    
    @Autowired  
    private NewArchitectureService newService;
    
    public User getUserById(Long userId) {
        // å…¨å±€å¼€å…³æ§åˆ¶
        if (!newArchitectureEnabled) {
            return oldService.getUserById(userId);
        }
        
        // æŒ‰æ¯”ä¾‹åˆ†æµ
        if (shouldUseNewArchitecture(userId)) {
            try {
                return newService.getUserById(userId);
            } catch (Exception e) {
                // æ–°æ¶æ„å¼‚å¸¸æ—¶è‡ªåŠ¨é™çº§åˆ°æ—§æ¶æ„
                log.warn("æ–°æ¶æ„å¼‚å¸¸ï¼Œé™çº§åˆ°æ—§æ¶æ„: {}", e.getMessage());
                return oldService.getUserById(userId);
            }
        } else {
            return oldService.getUserById(userId);
        }
    }
    
    private boolean shouldUseNewArchitecture(Long userId) {
        // åŸºäºç”¨æˆ·IDçš„ä¸€è‡´æ€§åˆ†æµ
        return (userId % 100) < trafficPercentage;
    }
}
```

### 7.4 æ€§èƒ½è¯„ä¼°ä¸ä¼˜åŒ–


##### ğŸ”¹ æ¼”è¿›æ•ˆæœè¯„ä¼°


**ğŸ“Š å…³é”®æŒ‡æ ‡å¯¹æ¯”**

| æ¼”è¿›é˜¶æ®µ | **QPS** | **å“åº”æ—¶é—´** | **å¯ç”¨æ€§** | **æ‰©å±•æ€§** | **å¤æ‚åº¦** |
|---------|---------|-------------|-----------|-----------|-----------|
| ğŸ”¸ **å•æœº** | `1000` | `50ms` | `99%` | `ä½` | `ä½` |
| ğŸ”¸ **è¯»å†™åˆ†ç¦»** | `5000` | `30ms` | `99.5%` | `ä¸­` | `ä¸­` |
| ğŸ”¸ **æœåŠ¡æ‹†åˆ†** | `10000` | `25ms` | `99.8%` | `é«˜` | `é«˜` |
| ğŸ”¸ **æ•°æ®åˆ†ç‰‡** | `50000` | `20ms` | `99.9%` | `æé«˜` | `æé«˜` |

##### ğŸ”¹ æŒç»­ä¼˜åŒ–ç­–ç•¥


**ğŸ”§ æ€§èƒ½è°ƒä¼˜å¾ªç¯**
```
æ€§èƒ½ä¼˜åŒ–é—­ç¯ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€§èƒ½ç›‘æ§    â”‚
â”‚ â€¢ QPS/TPS   â”‚
â”‚ â€¢ å“åº”æ—¶é—´  â”‚
â”‚ â€¢ é”™è¯¯ç‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    
â”‚ ç“¶é¢ˆåˆ†æ    â”‚
â”‚ â€¢ æ…¢æŸ¥è¯¢    â”‚
â”‚ â€¢ èµ„æºä½¿ç”¨  â”‚
â”‚ â€¢ é”ç­‰å¾…    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜åŒ–å®æ–½    â”‚
â”‚ â€¢ ç´¢å¼•ä¼˜åŒ–  â”‚
â”‚ â€¢ æ¶æ„è°ƒæ•´  â”‚  
â”‚ â€¢ å‚æ•°è°ƒä¼˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•ˆæœéªŒè¯    â”‚
â”‚ â€¢ A/Bæµ‹è¯•   â”‚
â”‚ â€¢ å‹åŠ›æµ‹è¯•  â”‚
â”‚ â€¢ ç›‘æ§å¯¹æ¯”  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 é£é™©æ§åˆ¶æªæ–½


##### ğŸ”¹ æ•°æ®å®‰å…¨ä¿éšœ


**ğŸ”’ æ¼”è¿›è¿‡ç¨‹æ•°æ®ä¿æŠ¤**
```bash
# æ¼”è¿›å‰æ•°æ®å¤‡ä»½è„šæœ¬
#!/bin/bash

# 1. å…¨é‡å¤‡ä»½
echo "å¼€å§‹å…¨é‡å¤‡ä»½..."
mysqldump --single-transaction --routines --triggers \
  --all-databases > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. binlogå¤‡ä»½
echo "å¤‡ä»½binlogæ–‡ä»¶..."
cp /var/lib/mysql/mysql-bin.* /backup/binlog/

# 3. é…ç½®æ–‡ä»¶å¤‡ä»½
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
cp /etc/my.cnf /backup/config/my.cnf.bak

# 4. æ•°æ®æ ¡éªŒ
echo "æ•°æ®æ ¡éªŒ..."
mysql -e "CHECKSUM TABLE é‡è¦è¡¨å;"

# 5. åˆ›å»ºæ¢å¤ç‚¹
echo "åˆ›å»ºæ¢å¤ç‚¹æ ‡è®°..."
mysql -e "FLUSH LOGS;"
echo "å¤‡ä»½å®Œæˆ: $(date)"
```

##### ğŸ”¹ ç›‘æ§å‘Šè­¦æœºåˆ¶


**ğŸš¨ æ¼”è¿›ç›‘æ§é…ç½®**
```yaml
# æ¼”è¿›æœŸé—´ç‰¹æ®Šç›‘æ§è§„åˆ™
groups:
  - name: architecture_migration
    rules:
      # æ•°æ®ä¸€è‡´æ€§ç›‘æ§
      - alert: DataInconsistency
        expr: abs(old_system_count - new_system_count) > 10
        for: 1m
        annotations:
          summary: "æ–°æ—§ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´"
          
      # æ€§èƒ½å›é€€ç›‘æ§  
      - alert: PerformanceRegression
        expr: avg_response_time > 1.5 * baseline_response_time
        for: 2m
        annotations:
          summary: "æ€§èƒ½å‡ºç°å›é€€"
          
      # é”™è¯¯ç‡ç›‘æ§
      - alert: ErrorRateIncrease
        expr: error_rate > 0.01
        for: 30s
        annotations:
          summary: "é”™è¯¯ç‡å¼‚å¸¸å¢åŠ "
          
      # èµ„æºä½¿ç”¨ç›‘æ§
      - alert: ResourceExhaustion
        expr: cpu_usage > 80 or memory_usage > 85
        for: 1m
        annotations:
          summary: "ç³»ç»Ÿèµ„æºä¸è¶³"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤æ¶æ„æœ¬è´¨ï¼šé€šè¿‡å¤šå°æœåŠ¡å™¨ååŒå·¥ä½œï¼Œæä¾›é«˜å¯ç”¨ã€é«˜æ€§èƒ½çš„æ•°æ®åº“æœåŠ¡
ğŸ”¸ èŠ‚ç‚¹è§’è‰²åˆ†å·¥ï¼šä¸»èŠ‚ç‚¹è´Ÿè´£å†™å…¥å’Œåè°ƒï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»å–å’Œå¤‡ä»½ï¼Œä»²è£èŠ‚ç‚¹å‚ä¸å†³ç­–
ğŸ”¸ æ‰©å±•æ€§è®¾è®¡ï¼šè¯»æ‰©å±•é€šè¿‡å¢åŠ ä»åº“ï¼Œå†™æ‰©å±•é€šè¿‡æ•°æ®åˆ†ç‰‡ï¼Œæ··åˆæ¶æ„æœ€ä¸ºå¸¸è§
ğŸ”¸ å®¹é”™èƒ½åŠ›ï¼šé€šè¿‡å†—ä½™ã€ç›‘æ§ã€è‡ªåŠ¨åˆ‡æ¢ç­‰æœºåˆ¶ï¼Œç¡®ä¿å•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
ğŸ”¸ æ— å•ç‚¹æ•…éšœï¼šæ¯ä¸ªå…³é”®ç¯èŠ‚éƒ½è¦æœ‰å¤‡ç”¨æ–¹æ¡ˆï¼Œé¿å…ç³»ç»Ÿå­˜åœ¨è‡´å‘½å¼±ç‚¹
ğŸ”¸ æ¶æ„æ¼”è¿›ï¼šæ ¹æ®ä¸šåŠ¡å‘å±•é˜¶æ®µæ€§æ¼”è¿›ï¼Œå¹³è¡¡å¤æ‚åº¦å’Œæ”¶ç›Š
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¶æ„è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³**
```
é«˜å¯ç”¨ä¸‰è¦ç´ ï¼š
â€¢ å†—ä½™è®¾è®¡ï¼šå…³é”®ç»„ä»¶å¤šå‰¯æœ¬
â€¢ æ•…éšœæ£€æµ‹ï¼šå¿«é€Ÿå‘ç°é—®é¢˜
â€¢ è‡ªåŠ¨æ¢å¤ï¼šæ— äººå·¥å¹²é¢„åˆ‡æ¢

æ‰©å±•æ€§åŸåˆ™ï¼š
â€¢ æ°´å¹³æ‰©å±•ä¼˜äºå‚ç›´æ‰©å±•
â€¢ è¯»æ‰©å±•ç›¸å¯¹ç®€å•ï¼Œå†™æ‰©å±•è¾ƒå¤æ‚
â€¢ åˆ†ç‰‡æ˜¯å†™æ‰©å±•çš„ç»ˆææ–¹æ¡ˆ

ä¸€è‡´æ€§æƒè¡¡ï¼š
â€¢ å¼ºä¸€è‡´æ€§ï¼šåŒæ­¥å¤åˆ¶ï¼Œæ€§èƒ½å·®
â€¢ æœ€ç»ˆä¸€è‡´æ€§ï¼šå¼‚æ­¥å¤åˆ¶ï¼Œæ€§èƒ½å¥½
â€¢ æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«
```

**ğŸ”¹ å®é™…åº”ç”¨ä¸­çš„æƒè¡¡**
```
æˆæœ¬ vs å¯ç”¨æ€§ï¼š
â€¢ æ›´é«˜çš„å¯ç”¨æ€§éœ€è¦æ›´å¤šç¡¬ä»¶æŠ•å…¥
â€¢ éœ€è¦æ ¹æ®ä¸šåŠ¡é‡è¦æ€§å†³å®šæŠ•å…¥ç¨‹åº¦

å¤æ‚åº¦ vs æ”¶ç›Šï¼š
â€¢ æ¶æ„è¶Šå¤æ‚ï¼Œç»´æŠ¤æˆæœ¬è¶Šé«˜
â€¢ é¿å…è¿‡åº¦è®¾è®¡ï¼Œå¤Ÿç”¨å³å¯

æ€§èƒ½ vs ä¸€è‡´æ€§ï¼š
â€¢ å¼ºä¸€è‡´æ€§ä¼šç‰ºç‰²æ€§èƒ½
â€¢ ä¸šåŠ¡å…è®¸çš„æƒ…å†µä¸‹é€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§
```

### 8.3 æœ€ä½³å®è·µæŒ‡å¯¼


**ğŸ¯ æ¶æ„é€‰æ‹©å†³ç­–æ ‘**
```
ä¸šåŠ¡åœºæ™¯åˆ¤æ–­ï¼š

å°å‹åº”ç”¨ï¼ˆç”¨æˆ· < 1ä¸‡ï¼‰ï¼š
â””â”€â”€ ä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»

ä¸­å‹åº”ç”¨ï¼ˆç”¨æˆ· 1-10ä¸‡ï¼‰ï¼š
â”œâ”€â”€ æœåŠ¡æ‹†åˆ†
â”œâ”€â”€ å¤šä»åº“è´Ÿè½½å‡è¡¡
â””â”€â”€ ç¼“å­˜å±‚å¼•å…¥

å¤§å‹åº”ç”¨ï¼ˆç”¨æˆ· > 10ä¸‡ï¼‰ï¼š
â”œâ”€â”€ æ•°æ®åˆ†ç‰‡
â”œâ”€â”€ å¾®æœåŠ¡æ¶æ„
â”œâ”€â”€ åˆ†å¸ƒå¼ç¼“å­˜
â””â”€â”€ å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²

å…³é”®ä¸šåŠ¡ç³»ç»Ÿï¼š
â”œâ”€â”€ æ— å•ç‚¹æ•…éšœè®¾è®¡
â”œâ”€â”€ è‡ªåŠ¨æ•…éšœè½¬ç§»
â”œâ”€â”€ å®æ—¶ç›‘æ§å‘Šè­¦
â””â”€â”€ ç¾å¤‡æ–¹æ¡ˆ
```

**ğŸ”§ å®æ–½å»ºè®®**
```
æ¸è¿›å¼æ¼”è¿›ï¼š
1. ä»ç®€å•çš„ä¸»ä»å¤åˆ¶å¼€å§‹
2. æ ¹æ®ç“¶é¢ˆé€æ­¥ä¼˜åŒ–
3. æ¯æ¬¡å˜æ›´éƒ½è¦æœ‰å›æ»šæ–¹æ¡ˆ
4. å……åˆ†æµ‹è¯•åå†ä¸Šçº¿

ç›‘æ§ä¸ºå…ˆï¼š
â€¢ å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
â€¢ å®šä¹‰æ˜ç¡®çš„å‘Šè­¦é˜ˆå€¼
â€¢ å…³æ³¨ä¸šåŠ¡æŒ‡æ ‡å’ŒæŠ€æœ¯æŒ‡æ ‡
â€¢ å®šæœŸè¿›è¡Œå®¹ç¾æ¼”ç»ƒ

å›¢é˜Ÿèƒ½åŠ›ï¼š
â€¢ æ¶æ„å¤æ‚åº¦è¦åŒ¹é…å›¢é˜Ÿèƒ½åŠ›
â€¢ æ³¨é‡æ–‡æ¡£å’ŒçŸ¥è¯†ä¼ æ‰¿
â€¢ å»ºç«‹æ ‡å‡†åŒ–çš„è¿ç»´æµç¨‹
â€¢ å®šæœŸè¿›è¡ŒæŠ€æœ¯åŸ¹è®­
```

### 8.4 å¸¸è§è¯¯åŒºé¿å…


**âŒ æ¶æ„è®¾è®¡å¸¸è§é”™è¯¯**
```
è¿‡åº¦è®¾è®¡ï¼š
â€¢ ä¸€å¼€å§‹å°±ä½¿ç”¨å¤æ‚æ¶æ„
â€¢ ä¸è€ƒè™‘å®é™…ä¸šåŠ¡éœ€æ±‚
â€¢ è¿½æ±‚æŠ€æœ¯å…ˆè¿›æ€§è€Œå¿½ç•¥å®ç”¨æ€§

å¿½è§†ç›‘æ§ï¼š
â€¢ ç¼ºä¹å®Œå–„çš„ç›‘æ§ä½“ç³»
â€¢ ä¾èµ–äººå·¥å‘ç°é—®é¢˜
â€¢ ç¼ºå°‘æ€§èƒ½åŸºçº¿æ•°æ®

å•ç‚¹æ•…éšœï¼š
â€¢ å…³é”®ç¯èŠ‚æ²¡æœ‰å¤‡ç”¨æ–¹æ¡ˆ
â€¢ è¿‡åˆ†ä¿¡ä»»ç¡¬ä»¶å¯é æ€§
â€¢ ç¼ºå°‘è‡ªåŠ¨æ•…éšœè½¬ç§»æœºåˆ¶

æ•°æ®ä¸ä¸€è‡´ï¼š
â€¢ å¿½è§†ä¸»ä»å»¶è¿Ÿé—®é¢˜
â€¢ ç¼ºå°‘æ•°æ®æ ¡éªŒæœºåˆ¶
â€¢ æ²¡æœ‰ä¸€è‡´æ€§ä¿éšœç­–ç•¥
```

### 8.5 æŠ€æœ¯å‘å±•è¶‹åŠ¿


**ğŸš€ æœªæ¥æ¶æ„å‘å±•æ–¹å‘**
```
äº‘åŸç”Ÿæ¶æ„ï¼š
â€¢ å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker + Kubernetesï¼‰
â€¢ å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›
â€¢ å¤šäº‘å’Œæ··åˆäº‘æ”¯æŒ

æ™ºèƒ½è¿ç»´ï¼š
â€¢ åŸºäºAIçš„æ•…éšœé¢„æµ‹
â€¢ è‡ªåŠ¨åŒ–æ€§èƒ½è°ƒä¼˜
â€¢ æ™ºèƒ½å®¹é‡è§„åˆ’

æ–°å…´æŠ€æœ¯ï¼š
â€¢ NewSQLæ•°æ®åº“ï¼ˆTiDBã€CockroachDBï¼‰
â€¢ å†…å­˜æ•°æ®åº“é›†æˆ
â€¢ è¾¹ç¼˜è®¡ç®—æ•°æ®åº“
```

**ğŸ’¡ æ ¸å¿ƒè®°å¿†å£è¯€**
```
æ¶æ„è®¾è®¡ä¸ƒå­—è¯€ï¼š
é«˜å¯ç”¨ï¼Œèƒ½æ‰©å±•ï¼Œ
æ— å•ç‚¹ï¼Œæ˜“æ¼”è¿›ï¼Œ
ç›‘æ§å…¨ï¼Œæµ‹è¯•å…ˆï¼Œ
æ–‡æ¡£æ¸…ï¼Œå›¢é˜Ÿå‡†ã€‚

å®æ–½ä¸‰æ­¥èµ°ï¼š
ç¬¬ä¸€æ­¥ï¼šè§£å†³å½“å‰é—®é¢˜
ç¬¬äºŒæ­¥ï¼šæ”¯æ’‘ä¸šåŠ¡å‘å±•  
ç¬¬ä¸‰æ­¥ï¼šé¢„ç•™æ‰©å±•ç©ºé—´

è®°ä½ï¼šæ¶æ„æœåŠ¡ä¸šåŠ¡ï¼Œå¤æ‚åº¦è¦å¯æ§ï¼Œ
     æ¼”è¿›è¦æ¸è¿›ï¼Œç›‘æ§è¦å®Œå–„ï¼
```

**ğŸ¯ æœ€ç»ˆå»ºè®®**
- ä»ä¸šåŠ¡éœ€æ±‚å‡ºå‘ï¼Œä¸è¦ä¸ºäº†æŠ€æœ¯è€ŒæŠ€æœ¯
- ä¼˜å…ˆè§£å†³ä¸»è¦çŸ›ç›¾ï¼Œé¿å…å®Œç¾ä¸»ä¹‰
- é‡è§†ç›‘æ§å’Œæ–‡æ¡£ï¼Œè¿™æ˜¯æ¶æ„æˆåŠŸçš„åŸºç¡€
- å›¢é˜Ÿèƒ½åŠ›æ˜¯æ¶æ„å¤æ‚åº¦çš„å¤©èŠ±æ¿
- æŒç»­å­¦ä¹ æ–°æŠ€æœ¯ï¼Œä½†è¦è°¨æ…å¼•å…¥ç”Ÿäº§ç¯å¢ƒ