---
title: 14ã€å¤åˆ¶ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [å¤åˆ¶ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ](#1-å¤åˆ¶ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ)
2. [æ•°æ®ä¸€è‡´æ€§çº§åˆ«è¯¦è§£](#2-æ•°æ®ä¸€è‡´æ€§çº§åˆ«è¯¦è§£)
3. [äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯æœºåˆ¶](#3-äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯æœºåˆ¶)
4. [å¤åˆ¶ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯](#4-å¤åˆ¶ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯)
5. [ä¸€è‡´æ€§æ•…éšœå¤„ç†ç­–ç•¥](#5-ä¸€è‡´æ€§æ•…éšœå¤„ç†ç­–ç•¥)
6. [è¯»å†™ä¸€è‡´æ€§å®ç°](#6-è¯»å†™ä¸€è‡´æ€§å®ç°)
7. [ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ä¿éšœ](#7-ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ä¿éšœ)
8. [ä¸šåŠ¡ä¸€è‡´æ€§SLAé‡åŒ–è¯„ä¼°](#8-ä¸šåŠ¡ä¸€è‡´æ€§SLAé‡åŒ–è¯„ä¼°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¤åˆ¶ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤åˆ¶ä¸€è‡´æ€§


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ æœ‰ä¸€æœ¬è´¦æœ¬ï¼Œä½ åœ¨ä¸Šé¢è®°å½•æ”¶æ”¯æƒ…å†µã€‚ç°åœ¨ä½ éœ€è¦ç»™è€æ¿ä¹Ÿå‡†å¤‡ä¸€ä»½ä¸€æ¨¡ä¸€æ ·çš„è´¦æœ¬å‰¯æœ¬ã€‚å¤åˆ¶ä¸€è‡´æ€§å°±æ˜¯ç¡®ä¿ä½ å’Œè€æ¿çš„è´¦æœ¬å§‹ç»ˆä¿æŒåŒæ­¥ï¼Œå†…å®¹å®Œå…¨ä¸€è‡´ã€‚

```
ä¸»åº“ï¼ˆåŸè´¦æœ¬ï¼‰             ä»åº“ï¼ˆå‰¯æœ¬è´¦æœ¬ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•A: 100å…ƒ â”‚    å¤åˆ¶   â”‚ è®¢å•A: 100å…ƒ â”‚
â”‚ è®¢å•B: 200å…ƒ â”‚  ======>  â”‚ è®¢å•B: 200å…ƒ â”‚
â”‚ è®¢å•C: 150å…ƒ â”‚           â”‚ è®¢å•C: 150å…ƒ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœŸæœ›ç»“æœï¼šä¸¤ä¸ªè´¦æœ¬å†…å®¹å®Œå…¨ä¸€è‡´
```

> ğŸ’¡ **æ ¸å¿ƒå®šä¹‰**
> 
> MySQLå¤åˆ¶ä¸€è‡´æ€§æ˜¯æŒ‡ä¸»åº“å’Œä»åº“ä¹‹é—´çš„æ•°æ®åœ¨ä»»ä½•æ—¶åˆ»éƒ½ä¿æŒ**é€»è¾‘ä¸€è‡´**çš„çŠ¶æ€ï¼Œç¡®ä¿ä»åº“èƒ½å¤Ÿ**å‡†ç¡®åæ˜ **ä¸»åº“çš„æ•°æ®å˜åŒ–ã€‚

### 1.2 ä¸ºä»€ä¹ˆä¸€è‡´æ€§å¦‚æ­¤é‡è¦


**ä¸šåŠ¡åœºæ™¯ä¸¾ä¾‹**ï¼š
- **ç”µå•†ç³»ç»Ÿ**ï¼šç”¨æˆ·åœ¨ä¸»åº“ä¸‹å•åï¼Œç«‹å³åœ¨ä»åº“æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œå¿…é¡»èƒ½çœ‹åˆ°åˆšä¸‹çš„è®¢å•
- **é‡‘èç³»ç»Ÿ**ï¼šè½¬è´¦æ“ä½œåœ¨ä¸»åº“å®Œæˆåï¼Œè´¦æˆ·ä½™é¢æŸ¥è¯¢å¿…é¡»åæ˜ æœ€æ–°çŠ¶æ€
- **å†…å®¹ç®¡ç†**ï¼šæ–‡ç« å‘å¸ƒåï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½åº”è¯¥èƒ½ç«‹å³çœ‹åˆ°æœ€æ–°å†…å®¹

**ä¸€è‡´æ€§é—®é¢˜çš„å±å®³**ï¼š
```
âŒ æ•°æ®ä¸ä¸€è‡´çš„åæœï¼š
â€¢ ç”¨æˆ·ä½“éªŒå·®ï¼šåˆšä¸‹çš„è®¢å•æŸ¥ä¸åˆ°
â€¢ ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼šé‡å¤æ‰£æ¬¾ã€åº“å­˜å¼‚å¸¸
â€¢ æ•°æ®åˆ†æé”™è¯¯ï¼šæŠ¥è¡¨æ•°æ®ä¸å‡†ç¡®
â€¢ ç³»ç»Ÿå¯ä¿¡åº¦ä¸‹é™ï¼šç”¨æˆ·å¤±å»ä¿¡ä»»
```

### 1.3 ä¸€è‡´æ€§æŒ‘æˆ˜


**ç½‘ç»œå»¶è¿Ÿé—®é¢˜**ï¼š
```
ä¸»åº“ ----[ç½‘ç»œå»¶è¿Ÿ 100ms]----> ä»åº“
     å†™å…¥æ•°æ®                 å»¶è¿Ÿæ¥æ”¶

æ—¶é—´çº¿ï¼š
T1: ä¸»åº“å†™å…¥è®¢å•A
T2: ç”¨æˆ·æŸ¥è¯¢ä»åº“ âŒ æŸ¥ä¸åˆ°è®¢å•A
T3: ä»åº“æ¥æ”¶åˆ°è®¢å•A âœ… ç°åœ¨èƒ½æŸ¥åˆ°äº†
```

**å¤åˆ¶å¼‚æ­¥ç‰¹æ€§**ï¼š
- MySQLé»˜è®¤é‡‡ç”¨**å¼‚æ­¥å¤åˆ¶**
- ä¸»åº“ä¸ç­‰å¾…ä»åº“ç¡®è®¤å°±è¿”å›æˆåŠŸ
- å­˜åœ¨æ•°æ®**æš‚æ—¶ä¸ä¸€è‡´**çš„æ—¶é—´çª—å£

---

## 2. ğŸ“Š æ•°æ®ä¸€è‡´æ€§çº§åˆ«è¯¦è§£


### 2.1 æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰


**å«ä¹‰è§£é‡Š**ï¼šå°±åƒå¯„ä¿¡ä¸€æ ·ï¼Œä½ å¯„å‡ºä¿¡ä»¶åï¼Œæ”¶ä»¶äººä¸ä¼šç«‹å³æ”¶åˆ°ï¼Œä½†æœ€ç»ˆä¸€å®šä¼šæ”¶åˆ°ï¼ˆå‡è®¾é‚®ä»¶ç³»ç»Ÿæ­£å¸¸ï¼‰ã€‚

```
æœ€ç»ˆä¸€è‡´æ€§ç¤ºä¾‹ï¼š
ä¸»åº“: [å†™å…¥] ----æ—¶é—´----> [ä»åº“æœ€ç»ˆæ¥æ”¶]
T1    T2      T3    T4    T5
â”‚     â”‚       â”‚     â”‚     â”‚
å†™å…¥  ç”¨æˆ·æŸ¥è¯¢ âŒ    âŒ    âœ… æŸ¥åˆ°äº†

ç‰¹ç‚¹ï¼š
â€¢ ä¸»åº“å†™å…¥ç«‹å³è¿”å›æˆåŠŸ
â€¢ ä»åº“å¯èƒ½æš‚æ—¶æŸ¥ä¸åˆ°æ•°æ®
â€¢ ç»è¿‡ä¸€æ®µæ—¶é—´åä¿è¯ä¸€è‡´
```

> ğŸ¯ **é€‚ç”¨åœºæ™¯**
> 
> - **å†…å®¹å±•ç¤º**ï¼šåšå®¢æ–‡ç« ã€æ–°é—»èµ„è®¯
> - **ç”¨æˆ·èµ„æ–™**ï¼šä¸ªäººä¿¡æ¯æ›´æ–°
> - **å•†å“ä¿¡æ¯**ï¼šä»·æ ¼ã€åº“å­˜ï¼ˆéå…³é”®ï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```sql
-- é»˜è®¤å¼‚æ­¥å¤åˆ¶ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
CHANGE MASTER TO
  MASTER_HOST='192.168.1.100',
  MASTER_USER='repl_user',
  MASTER_PASSWORD='password',
  MASTER_AUTO_POSITION=1;
```

### 2.2 è¯»å†™ä¸€è‡´æ€§ï¼ˆRead-Write Consistencyï¼‰


**å«ä¹‰è§£é‡Š**ï¼šå°±åƒé“¶è¡ŒATMæœºï¼Œä½ å­˜é’±åç«‹å³æŸ¥è¯¢ä½™é¢ï¼Œå¿…é¡»èƒ½çœ‹åˆ°æœ€æ–°çš„é‡‘é¢ã€‚

```
è¯»å†™ä¸€è‡´æ€§ä¿è¯ï¼š
ç”¨æˆ·A: å†™å…¥è®¢å• â”€â”€â”
                  â”œâ”€â”€> ä¸»åº“å¤„ç†
ç”¨æˆ·A: æŸ¥è¯¢è®¢å• â”€â”€â”˜    â”‚
                      â†“
              è·¯ç”±åˆ°ä¸»åº“æŸ¥è¯¢ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
```

**å®ç°ç­–ç•¥**ï¼š
- **è¯»å†™åˆ†ç¦»æ™ºèƒ½è·¯ç”±**ï¼šåŒä¸€ç”¨æˆ·çš„è¯»æ“ä½œè·¯ç”±åˆ°ä¸»åº“
- **ä¼šè¯ç²˜æ€§**ï¼šç”¨æˆ·åœ¨ä¸€æ®µæ—¶é—´å†…ç»‘å®šåˆ°ä¸»åº“
- **æ—¶é—´æˆ³æ£€æŸ¥**ï¼šæ¯”è¾ƒæ“ä½œæ—¶é—´å’Œå¤åˆ¶å»¶è¿Ÿ

```python
# ä¼ªä»£ç ç¤ºä¾‹ï¼šè¯»å†™ä¸€è‡´æ€§å®ç°
class DatabaseRouter:
    def route_query(self, user_id, operation_type):
        if operation_type == 'WRITE':
            return self.master_db
        
        # æ£€æŸ¥ç”¨æˆ·æœ€è¿‘æ˜¯å¦æœ‰å†™æ“ä½œ
        last_write_time = self.get_last_write_time(user_id)
        if time.now() - last_write_time < 5:  # 5ç§’å†…
            return self.master_db  # è·¯ç”±åˆ°ä¸»åº“
        else:
            return self.slave_db   # è·¯ç”±åˆ°ä»åº“
```

### 2.3 å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰


**å«ä¹‰è§£é‡Š**ï¼šå°±åƒé“¶è¡Œè½¬è´¦ï¼Œå¿…é¡»ç¡®ä¿è½¬å‡ºæ–¹æ‰£æ¬¾å’Œè½¬å…¥æ–¹åˆ°è´¦åŒæ—¶å®Œæˆï¼Œä¸èƒ½å‡ºç°ä¸­é—´çŠ¶æ€ã€‚

```
å¼ºä¸€è‡´æ€§ä¿è¯ï¼š
ä¸»åº“ â”€â”€â”€â”€â”€[åŒæ­¥å¤åˆ¶]â”€â”€â”€â”€â”€> ä»åº“
  â”‚                        â”‚
  â”œâ”€â”€ å†™å…¥æ•°æ®              â”œâ”€â”€ ç«‹å³åŒæ­¥
  â”œâ”€â”€ ç­‰å¾…ä»åº“ç¡®è®¤ â†â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€ å‘é€ç¡®è®¤
  â””â”€â”€ è¿”å›æˆåŠŸ              â””â”€â”€ æ•°æ®ä¸€è‡´

åªæœ‰æ‰€æœ‰èŠ‚ç‚¹éƒ½æˆåŠŸï¼Œäº‹åŠ¡æ‰ç®—å®Œæˆ
```

**åŠåŒæ­¥å¤åˆ¶é…ç½®**ï¼š
```sql
-- å¯ç”¨åŠåŒæ­¥å¤åˆ¶
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';

-- ä¸»åº“é…ç½®
SET GLOBAL rpl_semi_sync_master_enabled = 1;
SET GLOBAL rpl_semi_sync_master_timeout = 1000; -- 1ç§’è¶…æ—¶

-- ä»åº“é…ç½®
SET GLOBAL rpl_semi_sync_slave_enabled = 1;
```

> âš ï¸ **æ€§èƒ½ä»£ä»·**
> 
> å¼ºä¸€è‡´æ€§ä»¥**æ€§èƒ½æ¢å®‰å…¨**ï¼š
> - å†™å…¥å»¶è¿Ÿå¢åŠ ï¼ˆç­‰å¾…ä»åº“ç¡®è®¤ï¼‰
> - ååé‡ä¸‹é™
> - é€‚åˆé‡‘èã€è®¢å•ç­‰å…³é”®ä¸šåŠ¡

### 2.4 ä¸€è‡´æ€§çº§åˆ«å¯¹æ¯”


| ä¸€è‡´æ€§çº§åˆ« | **æ•°æ®å®‰å…¨** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|-----------|-------------|---------|-----------|-------------|
| ğŸ”µ **æœ€ç»ˆä¸€è‡´æ€§** | `ä¸­ç­‰` | `æœ€é«˜` | `æœ€ä½` | `å†…å®¹å±•ç¤ºã€ç”¨æˆ·èµ„æ–™` |
| ğŸŸ¡ **è¯»å†™ä¸€è‡´æ€§** | `è¾ƒé«˜` | `ä¸­ç­‰` | `ä¸­ç­‰` | `ä¸€èˆ¬ä¸šåŠ¡æ“ä½œ` |
| ğŸ”´ **å¼ºä¸€è‡´æ€§** | `æœ€é«˜` | `æœ€ä½` | `æœ€é«˜` | `é‡‘èäº¤æ˜“ã€é‡è¦è®¢å•` |

---

## 3. ğŸ”„ äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯æœºåˆ¶


### 3.1 äº‹åŠ¡å®Œæ•´æ€§éªŒè¯


**ä»€ä¹ˆæ˜¯äº‹åŠ¡å®Œæ•´æ€§**ï¼šç¡®ä¿ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡ï¼ˆæ¯”å¦‚è½¬è´¦ï¼‰è¦ä¹ˆå…¨éƒ¨å¤åˆ¶åˆ°ä»åº“ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸å¤åˆ¶ï¼Œä¸èƒ½å‡ºç°éƒ¨åˆ†å¤åˆ¶çš„æƒ…å†µã€‚

```
è½¬è´¦äº‹åŠ¡ç¤ºä¾‹ï¼š
BEGIN;
  UPDATE accounts SET balance = balance - 100 WHERE id = 1; -- æ‰£æ¬¾
  UPDATE accounts SET balance = balance + 100 WHERE id = 2; -- åˆ°è´¦
COMMIT;

äº‹åŠ¡å®Œæ•´æ€§è¦æ±‚ï¼š
âœ… ä»åº“åŒæ—¶çœ‹åˆ°ä¸¤æ¡UPDATE
âŒ ä»åº“åªçœ‹åˆ°å…¶ä¸­ä¸€æ¡UPDATE
```

**GTIDäº‹åŠ¡æ ‡è¯†**ï¼š
```sql
-- æŸ¥çœ‹GTIDçŠ¶æ€
SHOW GLOBAL VARIABLES LIKE 'gtid_mode';
SHOW GLOBAL VARIABLES LIKE 'enforce_gtid_consistency';

-- å¯ç”¨GTID
SET GLOBAL gtid_mode = 'ON';
SET GLOBAL enforce_gtid_consistency = 'ON';
```

> ğŸ’¡ **GTIDç®€å•ç†è§£**
> 
> GTIDå°±åƒç»™æ¯ä¸ªäº‹åŠ¡å‘ä¸€ä¸ª**èº«ä»½è¯å·**ï¼Œé€šè¿‡è¿™ä¸ªå·ç å¯ä»¥ï¼š
> - è·Ÿè¸ªäº‹åŠ¡æ˜¯å¦å·²å¤åˆ¶
> - ç¡®ä¿äº‹åŠ¡ä¸é‡å¤æ‰§è¡Œ
> - å¿«é€Ÿå®šä½å¤åˆ¶ä½ç½®

### 3.2 äº‹åŠ¡åŸå­æ€§ä¿è¯


**binlogäº‹åŠ¡è¾¹ç•Œ**ï¼š
```
äº‹åŠ¡åœ¨binlogä¸­çš„è®°å½•æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BEGIN (äº‹åŠ¡å¼€å§‹æ ‡è®°)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UPDATE table1 SET ...           â”‚
â”‚ INSERT INTO table2 ...          â”‚
â”‚ DELETE FROM table3 ...          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ COMMIT (äº‹åŠ¡ç»“æŸæ ‡è®°)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»åº“è¯»å–è§„åˆ™ï¼šåªæœ‰çœ‹åˆ°COMMITæ‰æ‰§è¡Œæ•´ä¸ªäº‹åŠ¡
```

**äº‹åŠ¡éš”ç¦»å®ç°**ï¼š
```sql
-- äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®
SET GLOBAL transaction_isolation = 'REPEATABLE-READ';

-- æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
SELECT * FROM information_schema.INNODB_TRX;

-- é•¿äº‹åŠ¡ç›‘æ§
SELECT 
  trx_id,
  trx_started,
  trx_state,
  TIMESTAMPDIFF(SECOND, trx_started, NOW()) as duration
FROM information_schema.INNODB_TRX 
WHERE TIMESTAMPDIFF(SECOND, trx_started, NOW()) > 10;
```

### 3.3 å¤åˆ¶äº‹åŠ¡å†²çªå¤„ç†


**ä»€ä¹ˆæ˜¯å¤åˆ¶å†²çª**ï¼šå½“ä¸»åº“å’Œä»åº“å¯¹åŒä¸€æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¯èƒ½äº§ç”Ÿå†²çªã€‚

```
å†²çªåœºæ™¯ç¤ºä¾‹ï¼š
ä¸»åº“: UPDATE users SET status='active' WHERE id=1;
ä»åº“: (äººå·¥è¯¯æ“ä½œ) UPDATE users SET status='inactive' WHERE id=1;

å¤åˆ¶æ—¶ä¼šå‘ç”Ÿï¼š
âŒ æ•°æ®ä¸ä¸€è‡´
âŒ å¤åˆ¶ä¸­æ–­
âŒ é”™è¯¯æ—¥å¿—æŠ¥warning
```

**å†²çªè§£å†³ç­–ç•¥**ï¼š
```sql
-- æŸ¥çœ‹å¤åˆ¶é”™è¯¯
SHOW SLAVE STATUS\G

-- è·³è¿‡å¤åˆ¶é”™è¯¯ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- æˆ–è€…é‡æ–°åŒæ­¥æ•°æ®
STOP SLAVE;
RESET SLAVE;
-- é‡æ–°å»ºç«‹å¤åˆ¶å…³ç³»
```

---

## 4. ğŸ” å¤åˆ¶ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯


### 4.1 å®æ—¶ä¸€è‡´æ€§ç›‘æ§


**ç›‘æ§æŒ‡æ ‡è§£é‡Š**ï¼š
- **å¤åˆ¶å»¶è¿Ÿ**ï¼šä¸»åº“å’Œä»åº“ä¹‹é—´çš„æ—¶é—´å·®
- **ä½ç½®å·®å¼‚**ï¼šbinlogä½ç½®çš„å·®è·  
- **GTIDå·®å¼‚**ï¼šå·²æ‰§è¡Œäº‹åŠ¡çš„å·®å¼‚

```sql
-- æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
SHOW SLAVE STATUS\G
-- å…³æ³¨ï¼šSeconds_Behind_Masterï¼ˆå»¶è¿Ÿç§’æ•°ï¼‰

-- æ£€æŸ¥å¤åˆ¶ä½ç½®
-- ä¸»åº“ä½ç½®
SHOW MASTER STATUS;
-- ä»åº“ä½ç½®  
SHOW SLAVE STATUS\G
-- å…³æ³¨ï¼šMaster_Log_File, Read_Master_Log_Pos

-- æ£€æŸ¥GTIDçŠ¶æ€
SELECT $$GLOBAL.gtid_executed;  -- å·²æ‰§è¡Œçš„GTID
SELECT $$GLOBAL.gtid_purged;    -- å·²æ¸…ç†çš„GTID
```

**è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# å¤åˆ¶çŠ¶æ€æ£€æŸ¥è„šæœ¬

check_replication() {
    local delay=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master" | awk '{print $2}')
    
    if [ "$delay" = "NULL" ]; then
        echo "âŒ å¤åˆ¶å¼‚å¸¸ï¼šå¤åˆ¶ä¸­æ–­"
        return 1
    elif [ "$delay" -gt 10 ]; then
        echo "âš ï¸  å¤åˆ¶å»¶è¿Ÿï¼š${delay}ç§’"
        return 2
    else
        echo "âœ… å¤åˆ¶æ­£å¸¸ï¼šå»¶è¿Ÿ${delay}ç§’"
        return 0
    fi
}

# æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
while true; do
    check_replication
    sleep 60
done
```

### 4.2 æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ


**checksumæ ¡éªŒæ–¹æ³•**ï¼š
```sql
-- ä½¿ç”¨pt-table-checksumå·¥å…·
-- åœ¨ä¸»åº“æ‰§è¡Œï¼Œè‡ªåŠ¨å¯¹æ¯”ä¸»ä»æ•°æ®
pt-table-checksum --host=ä¸»åº“IP \
                  --user=root \
                  --password=å¯†ç  \
                  --databases=ä¸šåŠ¡åº“å \
                  --replicate=percona.checksums

-- æŸ¥çœ‹æ ¡éªŒç»“æœ
SELECT db, tbl, chunk, this_cnt, this_crc 
FROM percona.checksums 
WHERE master_cnt <> this_cnt OR master_crc <> this_crc;
```

**è‡ªå®šä¹‰æ ¡éªŒæŸ¥è¯¢**ï¼š
```sql
-- æ£€æŸ¥è¡¨è®°å½•æ•°
SELECT 
  'master' as server,
  COUNT(*) as total_rows,
  MAX(id) as max_id,
  MIN(id) as min_id
FROM orders 
UNION ALL
SELECT 
  'slave' as server,
  COUNT(*) as total_rows, 
  MAX(id) as max_id,
  MIN(id) as min_id
FROM orders;

-- æ£€æŸ¥å…³é”®å­—æ®µæ€»å’Œ
SELECT 
  'master' as server,
  SUM(amount) as total_amount,
  COUNT(DISTINCT user_id) as unique_users
FROM orders
UNION ALL  
SELECT 
  'slave' as server,
  SUM(amount) as total_amount,
  COUNT(DISTINCT user_id) as unique_users
FROM orders;
```

### 4.3 ä¸šåŠ¡çº§ä¸€è‡´æ€§éªŒè¯


**å…³é”®ä¸šåŠ¡æŒ‡æ ‡æ£€æŸ¥**ï¼š
```sql
-- æ¯æ—¥è®¢å•é‡‘é¢å¯¹æ¯”
SELECT 
  DATE(created_at) as order_date,
  COUNT(*) as order_count,
  SUM(amount) as total_amount
FROM orders 
WHERE DATE(created_at) = CURDATE()
GROUP BY DATE(created_at);

-- ç”¨æˆ·ä½™é¢ä¸€è‡´æ€§æ£€æŸ¥
SELECT 
  user_id,
  balance,
  CONCAT('ç”¨æˆ·', user_id, 'ä½™é¢:', balance) as info
FROM user_accounts 
WHERE user_id IN (SELECT DISTINCT user_id FROM recent_transactions);
```

---

## 5. âš ï¸ ä¸€è‡´æ€§æ•…éšœå¤„ç†ç­–ç•¥


### 5.1 å¸¸è§ä¸€è‡´æ€§æ•…éšœç±»å‹


**å¤åˆ¶ä¸­æ–­æ•…éšœ**ï¼š
```
æ•…éšœç°è±¡ï¼š
â€¢ SHOW SLAVE STATUSæ˜¾ç¤ºå¤åˆ¶åœæ­¢
â€¢ Seconds_Behind_Masteræ˜¾ç¤ºNULL
â€¢ Last_Errorå­—æ®µæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

å¸¸è§åŸå› ï¼š
âŒ ç½‘ç»œä¸­æ–­
âŒ ç£ç›˜ç©ºé—´æ»¡
âŒ æƒé™é—®é¢˜
âŒ æ•°æ®å†²çª
```

**å»¶è¿Ÿè¿‡å¤§æ•…éšœ**ï¼š
```
æ•…éšœè¡¨ç°ï¼š
â€¢ Seconds_Behind_Master > é˜ˆå€¼ï¼ˆå¦‚10ç§’ï¼‰
â€¢ ç”¨æˆ·æŸ¥è¯¢ä¸åˆ°åˆšå†™å…¥çš„æ•°æ®
â€¢ ä¸šåŠ¡é€»è¾‘å‡ºç°å¼‚å¸¸

åŸå› åˆ†æï¼š
âŒ ä»åº“ç¡¬ä»¶æ€§èƒ½ä¸è¶³
âŒ ä¸»åº“å†™å…¥å‹åŠ›è¿‡å¤§  
âŒ ç½‘ç»œå¸¦å®½ä¸å¤Ÿ
âŒ å¤§äº‹åŠ¡é˜»å¡å¤åˆ¶
```

### 5.2 æ•…éšœè¯Šæ–­æ­¥éª¤


**Step 1: æ£€æŸ¥å¤åˆ¶çŠ¶æ€**
```sql
-- å…¨é¢æ£€æŸ¥å¤åˆ¶çŠ¶æ€
SHOW SLAVE STATUS\G

-- é‡ç‚¹å…³æ³¨å­—æ®µï¼š
-- Slave_IO_Running: Yes/No (IOçº¿ç¨‹çŠ¶æ€)
-- Slave_SQL_Running: Yes/No (SQLçº¿ç¨‹çŠ¶æ€)  
-- Seconds_Behind_Master: æ•°å­—/NULL (å»¶è¿Ÿæ—¶é—´)
-- Last_Error: é”™è¯¯ä¿¡æ¯
```

**Step 2: åˆ†æé”™è¯¯æ—¥å¿—**
```bash
# æŸ¥çœ‹MySQLé”™è¯¯æ—¥å¿—
tail -f /var/log/mysql/error.log

# æŸ¥çœ‹å¤åˆ¶ç›¸å…³é”™è¯¯
grep -i "replication\|slave" /var/log/mysql/error.log
```

**Step 3: æ£€æŸ¥ç³»ç»Ÿèµ„æº**
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h

# æ£€æŸ¥ç½‘ç»œè¿æ¥
netstat -an | grep 3306

# æ£€æŸ¥MySQLè¿›ç¨‹
ps aux | grep mysql
```

### 5.3 å¿«é€Ÿæ¢å¤æ–¹æ¡ˆ


**æ–¹æ¡ˆ1: è·³è¿‡é”™è¯¯ç»§ç»­å¤åˆ¶**
```sql
-- ğŸš¨ ä»…åœ¨ç¡®è®¤é”™è¯¯æ— å…³ç´§è¦æ—¶ä½¿ç”¨
STOP SLAVE;
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- éªŒè¯å¤åˆ¶æ¢å¤
SHOW SLAVE STATUS\G
```

**æ–¹æ¡ˆ2: é‡ç½®å¤åˆ¶ä½ç½®**
```sql
-- è·å–ä¸»åº“å½“å‰ä½ç½®
-- åœ¨ä¸»åº“æ‰§è¡Œï¼š
SHOW MASTER STATUS;

-- åœ¨ä»åº“é‡æ–°æŒ‡å®šä½ç½®
STOP SLAVE;
CHANGE MASTER TO 
  MASTER_LOG_FILE='binlog.000123',
  MASTER_LOG_POS=456789;
START SLAVE;
```

**æ–¹æ¡ˆ3: å®Œå…¨é‡å»ºå¤åˆ¶**
```bash
# 1. ä¸»åº“å¤‡ä»½
mysqldump --master-data=2 --single-transaction \
          --routines --triggers --all-databases > backup.sql

# 2. ä»åº“æ¢å¤
mysql < backup.sql

# 3. é‡æ–°å»ºç«‹å¤åˆ¶å…³ç³»
mysql -e "
CHANGE MASTER TO 
  MASTER_HOST='ä¸»åº“IP',
  MASTER_USER='repl_user',
  MASTER_PASSWORD='password',
  MASTER_AUTO_POSITION=1;
START SLAVE;
"
```

---

## 6. ğŸ“– è¯»å†™ä¸€è‡´æ€§å®ç°


### 6.1 è¯»å†™åˆ†ç¦»æ¶æ„


**æ¶æ„å›¾ç¤º**ï¼š
```
                  åº”ç”¨ç¨‹åº
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æ•°æ®åº“ä»£ç†   â”‚
              â”‚ (ProxySQL)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼         â–¼         â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ä¸»åº“   â”‚ â”‚ ä»åº“1  â”‚ â”‚ ä»åº“2  â”‚
      â”‚(å†™æ“ä½œ)â”‚ â”‚(è¯»æ“ä½œ)â”‚ â”‚(è¯»æ“ä½œ)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚         â–²         â–²
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                å¤åˆ¶å…³ç³»
```

### 6.2 ä¼šè¯ä¸€è‡´æ€§ä¿è¯


**ç²˜æ€§ä¼šè¯å®ç°**ï¼š
```python
# åº”ç”¨å±‚ä¼šè¯ä¸€è‡´æ€§å®ç°
class SessionConsistency:
    def __init__(self):
        self.user_write_time = {}  # è®°å½•ç”¨æˆ·å†™æ“ä½œæ—¶é—´
        self.consistency_window = 5  # ä¸€è‡´æ€§çª—å£5ç§’
    
    def route_database(self, user_id, operation_type):
        current_time = time.time()
        
        if operation_type == 'WRITE':
            # å†™æ“ä½œè·¯ç”±åˆ°ä¸»åº“
            self.user_write_time[user_id] = current_time
            return 'master'
        
        elif operation_type == 'READ':
            # æ£€æŸ¥ç”¨æˆ·æœ€è¿‘æ˜¯å¦æœ‰å†™æ“ä½œ
            last_write = self.user_write_time.get(user_id, 0)
            
            if current_time - last_write < self.consistency_window:
                return 'master'  # è·¯ç”±åˆ°ä¸»åº“ä¿è¯ä¸€è‡´æ€§
            else:
                return 'slave'   # è·¯ç”±åˆ°ä»åº“
```

**åŸºäºæ—¶é—´æˆ³çš„ä¸€è‡´æ€§**ï¼š
```sql
-- åœ¨åº”ç”¨ä¸­å®ç°æ—¶é—´æˆ³æ£€æŸ¥
-- å†™æ“ä½œæ—¶è®°å½•æ—¶é—´æˆ³
UPDATE user_sessions 
SET last_write_time = NOW() 
WHERE user_id = ?;

-- è¯»æ“ä½œæ—¶æ£€æŸ¥
SELECT 
  CASE 
    WHEN TIMESTAMPDIFF(SECOND, last_write_time, NOW()) < 5 
    THEN 'use_master'
    ELSE 'use_slave'
  END as db_choice
FROM user_sessions 
WHERE user_id = ?;
```

### 6.3 ProxySQLé…ç½®ç¤ºä¾‹


**è¯»å†™åˆ†ç¦»è§„åˆ™**ï¼š
```sql
-- ProxySQLé…ç½®
-- 1. é…ç½®æœåŠ¡å™¨ç»„
INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight) VALUES
(0, '192.168.1.100', 3306, 1000),  -- ä¸»åº“ï¼ˆå†™ç»„ï¼‰
(1, '192.168.1.101', 3306, 900),   -- ä»åº“1ï¼ˆè¯»ç»„ï¼‰
(1, '192.168.1.102', 3306, 900);   -- ä»åº“2ï¼ˆè¯»ç»„ï¼‰

-- 2. é…ç½®è·¯ç”±è§„åˆ™
INSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply) VALUES
(1, '^SELECT.*', 1, 1),           -- SELECTè·¯ç”±åˆ°è¯»ç»„
(2, '^INSERT|UPDATE|DELETE.*', 0, 1); -- å†™æ“ä½œè·¯ç”±åˆ°å†™ç»„

-- 3. é…ç½®ç”¨æˆ·
INSERT INTO mysql_users(username, password, default_hostgroup) VALUES
('app_user', 'password', 1);  -- é»˜è®¤è·¯ç”±åˆ°è¯»ç»„

-- 4. åº”ç”¨é…ç½®
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL QUERY RULES TO RUNTIME;
LOAD MYSQL USERS TO RUNTIME;
SAVE MYSQL SERVERS TO DISK;
SAVE MYSQL QUERY RULES TO DISK;
SAVE MYSQL USERS TO DISK;
```

---

## 7. ğŸ›¡ï¸ ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ä¿éšœ


### 7.1 æ–­ç”µåœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ä¿è¯


**æ–­ç”µå½±å“åˆ†æ**ï¼š
```
æ–­ç”µåœºæ™¯ï¼š
ä¸»åº“æ–­ç”µ â”€â”€â”
          â”œâ”€â”€> å¯èƒ½é€ æˆï¼š
ä»åº“æ­£å¸¸ â”€â”€â”˜     â€¢ binlogæœªå®Œå…¨å†™å…¥
                â€¢ äº‹åŠ¡çŠ¶æ€ä¸æ˜ç¡®
                â€¢ ä¸»ä»æ•°æ®å·®å¼‚

ä¿æŠ¤æœºåˆ¶ï¼š
âœ… sync_binlog=1     # æ¯æ¬¡äº‹åŠ¡åŒæ­¥å†™binlog
âœ… innodb_flush_log_at_trx_commit=1  # äº‹åŠ¡æ—¥å¿—å®æ—¶åˆ·ç›˜
âœ… åŠåŒæ­¥å¤åˆ¶        # ç¡®ä¿ä»åº“æ”¶åˆ°æ•°æ®
```

**crash-safeé…ç½®**ï¼š
```sql
-- ä¸»åº“å®‰å…¨é…ç½®
SET GLOBAL sync_binlog = 1;
SET GLOBAL innodb_flush_log_at_trx_commit = 1;
SET GLOBAL innodb_doublewrite = 1;

-- ä»åº“å®‰å…¨é…ç½®  
SET GLOBAL relay_log_info_repository = 'TABLE';
SET GLOBAL master_info_repository = 'TABLE';
SET GLOBAL relay_log_recovery = 1;
```

### 7.2 è·¨æ—¶åŒºå¤åˆ¶ä¸€è‡´æ€§é—®é¢˜


**æ—¶åŒºé—®é¢˜è¯´æ˜**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
ä¸»åº“ï¼ˆåŒ—äº¬æ—¶é—´ GMT+8ï¼‰: 2024-01-21 14:00:00
ä»åº“ï¼ˆçº½çº¦æ—¶é—´ GMT-5ï¼‰: 2024-01-21 01:00:00

å¯èƒ½å¯¼è‡´ï¼š
âŒ æ—¶é—´å­—æ®µæ˜¾ç¤ºä¸ä¸€è‡´
âŒ å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
âŒ æ—¥å¿—æ—¶é—´æ··ä¹±
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```sql
-- ç»Ÿä¸€æ—¶åŒºè®¾ç½®
-- ä¸»åº“å’Œæ‰€æœ‰ä»åº“ä½¿ç”¨UTCæ—¶é—´
SET GLOBAL time_zone = '+00:00';

-- åº”ç”¨å±‚å¤„ç†æ—¶åŒºè½¬æ¢
-- å­˜å‚¨æ—¶è½¬æ¢ä¸ºUTC
INSERT INTO orders (created_at) VALUES (CONVERT_TZ(NOW(), $$session.time_zone, '+00:00'));

-- æ˜¾ç¤ºæ—¶è½¬æ¢ä¸ºæœ¬åœ°æ—¶åŒº
SELECT 
  order_id,
  CONVERT_TZ(created_at, '+00:00', '+08:00') as local_time
FROM orders;
```

### 7.3 åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•åº”ç”¨


**Raftç®—æ³•åœ¨MySQLä¸­çš„åº”ç”¨**ï¼š
```
MySQL Group ReplicationåŸç†ï¼š
èŠ‚ç‚¹1 â”€â”€â”€â”
         â”œâ”€â”€> å…±è¯†åè®®
èŠ‚ç‚¹2 â”€â”€â”€â”¤    (ç±»ä¼¼Raft)
         â”‚
èŠ‚ç‚¹3 â”€â”€â”€â”˜

å·¥ä½œæµç¨‹ï¼š
1. äº‹åŠ¡æè®®
2. å¤šæ•°èŠ‚ç‚¹ç¡®è®¤  
3. åº”ç”¨åˆ°æ‰€æœ‰èŠ‚ç‚¹
4. è¿”å›å®¢æˆ·ç«¯æˆåŠŸ
```

**MGRé…ç½®ç¤ºä¾‹**ï¼š
```sql
-- å¯ç”¨Group Replication
INSTALL PLUGIN group_replication SONAME 'group_replication.so';

-- é…ç½®ç»„å¤åˆ¶
SET GLOBAL group_replication_group_name = 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa';
SET GLOBAL group_replication_start_on_boot = OFF;
SET GLOBAL group_replication_local_address = '192.168.1.100:33061';
SET GLOBAL group_replication_group_seeds = '192.168.1.100:33061,192.168.1.101:33061';

-- å¯åŠ¨ç»„å¤åˆ¶
START GROUP_REPLICATION;

-- æ£€æŸ¥ç»„çŠ¶æ€
SELECT * FROM performance_schema.replication_group_members;
```

---

## 8. ğŸ“ˆ ä¸šåŠ¡ä¸€è‡´æ€§SLAé‡åŒ–è¯„ä¼°


### 8.1 ä¸€è‡´æ€§SLAæŒ‡æ ‡å®šä¹‰


**å…³é”®æŒ‡æ ‡**ï¼š
- **RPO** (Recovery Point Objective)ï¼šæ•°æ®ä¸¢å¤±å®¹å¿åº¦
- **RTO** (Recovery Time Objective)ï¼šæ¢å¤æ—¶é—´ç›®æ ‡
- **ä¸€è‡´æ€§å»¶è¿Ÿ**ï¼šä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿæ—¶é—´
- **å¯ç”¨æ€§**ï¼šç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´æ¯”ä¾‹

```
SLAç­‰çº§å®šä¹‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç­‰çº§    â”‚ ä¸€è‡´æ€§å»¶è¿Ÿâ”‚ å¯ç”¨æ€§   â”‚ é€‚ç”¨åœºæ™¯  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é»„é‡‘çº§  â”‚ < 1ç§’    â”‚ 99.99%   â”‚ æ ¸å¿ƒäº¤æ˜“  â”‚
â”‚ ç™½é“¶çº§  â”‚ < 5ç§’    â”‚ 99.9%    â”‚ é‡è¦ä¸šåŠ¡  â”‚  
â”‚ é’é“œçº§  â”‚ < 30ç§’   â”‚ 99%      â”‚ ä¸€èˆ¬ä¸šåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ä¸€è‡´æ€§ç›‘æ§æŒ‡æ ‡


**æŠ€æœ¯æŒ‡æ ‡ç›‘æ§**ï¼š
```sql
-- åˆ›å»ºç›‘æ§è¡¨
CREATE TABLE replication_metrics (
  check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  master_file VARCHAR(50),
  master_position BIGINT,
  slave_file VARCHAR(50), 
  slave_position BIGINT,
  seconds_behind_master INT,
  io_running ENUM('Yes','No'),
  sql_running ENUM('Yes','No')
);

-- å®šæœŸé‡‡é›†æŒ‡æ ‡
INSERT INTO replication_metrics 
SELECT 
  NOW(),
  Master_Log_File,
  Read_Master_Log_Pos,
  Relay_Master_Log_File,
  Exec_Master_Log_Pos,
  Seconds_Behind_Master,
  Slave_IO_Running,
  Slave_SQL_Running
FROM INFORMATION_SCHEMA.SLAVE_HOSTS;
```

**ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§**ï¼š
```sql
-- ä¸šåŠ¡ä¸€è‡´æ€§æ£€æŸ¥
CREATE TABLE business_consistency_check (
  check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  table_name VARCHAR(50),
  master_count BIGINT,
  slave_count BIGINT,
  diff_count BIGINT,
  consistency_rate DECIMAL(5,2)
);

-- å®šæœŸä¸šåŠ¡æ•°æ®å¯¹æ¯”
INSERT INTO business_consistency_check
SELECT 
  NOW(),
  'orders',
  (SELECT COUNT(*) FROM master_db.orders),
  (SELECT COUNT(*) FROM slave_db.orders),
  ABS((SELECT COUNT(*) FROM master_db.orders) - (SELECT COUNT(*) FROM slave_db.orders)),
  CASE 
    WHEN (SELECT COUNT(*) FROM master_db.orders) = 0 THEN 100.00
    ELSE (1 - ABS((SELECT COUNT(*) FROM master_db.orders) - (SELECT COUNT(*) FROM slave_db.orders)) / (SELECT COUNT(*) FROM master_db.orders)) * 100
  END;
```

### 8.3 åŠ¨æ€ä¸€è‡´æ€§çº§åˆ«è°ƒæ•´


**è‡ªé€‚åº”ä¸€è‡´æ€§ç­–ç•¥**ï¼š
```python
class AdaptiveConsistency:
    def __init__(self):
        self.current_level = 'EVENTUAL'  # å½“å‰ä¸€è‡´æ€§çº§åˆ«
        self.thresholds = {
            'delay': 5,      # å»¶è¿Ÿé˜ˆå€¼ï¼ˆç§’ï¼‰
            'error_rate': 0.01,  # é”™è¯¯ç‡é˜ˆå€¼
            'load': 0.8      # è´Ÿè½½é˜ˆå€¼
        }
    
    def adjust_consistency_level(self, metrics):
        delay = metrics['replication_delay']
        error_rate = metrics['error_rate'] 
        load = metrics['system_load']
        
        # æ ¹æ®ç³»ç»ŸçŠ¶æ€è°ƒæ•´ä¸€è‡´æ€§çº§åˆ«
        if delay > self.thresholds['delay'] or error_rate > self.thresholds['error_rate']:
            if self.current_level != 'STRONG':
                self.current_level = 'STRONG'
                self.enable_semi_sync_replication()
                
        elif load < self.thresholds['load'] and delay < 1:
            if self.current_level != 'EVENTUAL':
                self.current_level = 'EVENTUAL' 
                self.disable_semi_sync_replication()
        
        return self.current_level
    
    def enable_semi_sync_replication(self):
        # å¯ç”¨åŠåŒæ­¥å¤åˆ¶
        execute_sql("SET GLOBAL rpl_semi_sync_master_enabled = 1")
        
    def disable_semi_sync_replication(self):
        # ç¦ç”¨åŠåŒæ­¥å¤åˆ¶  
        execute_sql("SET GLOBAL rpl_semi_sync_master_enabled = 0")
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤åˆ¶ä¸€è‡´æ€§æœ¬è´¨ï¼šç¡®ä¿ä¸»ä»åº“æ•°æ®é€»è¾‘ä¸€è‡´
ğŸ”¸ ä¸€è‡´æ€§çº§åˆ«ï¼šæœ€ç»ˆä¸€è‡´æ€§ã€è¯»å†™ä¸€è‡´æ€§ã€å¼ºä¸€è‡´æ€§
ğŸ”¸ å®ç°æœºåˆ¶ï¼šå¼‚æ­¥å¤åˆ¶ã€åŠåŒæ­¥å¤åˆ¶ã€ç»„å¤åˆ¶
ğŸ”¸ ç›‘æ§æ£€æŸ¥ï¼šå»¶è¿Ÿç›‘æ§ã€æ•°æ®æ ¡éªŒã€ä¸šåŠ¡éªŒè¯
ğŸ”¸ æ•…éšœå¤„ç†ï¼šè¯Šæ–­æ­¥éª¤ã€æ¢å¤æ–¹æ¡ˆã€é¢„é˜²æªæ–½
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸€è‡´æ€§ä¸æ€§èƒ½çš„å¹³è¡¡**
```
ä¸€è‡´æ€§çº§åˆ« â†‘ = æ€§èƒ½ â†“
â€¢ æœ€ç»ˆä¸€è‡´æ€§ï¼šé«˜æ€§èƒ½ï¼Œä½å®‰å…¨
â€¢ å¼ºä¸€è‡´æ€§ï¼šä½æ€§èƒ½ï¼Œé«˜å®‰å…¨
â€¢ è¯»å†™ä¸€è‡´æ€§ï¼šå¹³è¡¡é€‰æ‹©

é€‰æ‹©åŸåˆ™ï¼š
âœ… æ ¹æ®ä¸šåŠ¡é‡è¦æ€§é€‰æ‹©
âœ… æ ¸å¿ƒä¸šåŠ¡ç”¨å¼ºä¸€è‡´æ€§
âœ… ä¸€èˆ¬ä¸šåŠ¡ç”¨æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ å¤åˆ¶å»¶è¿Ÿçš„æ ¹æœ¬åŸå› **
```
æŠ€æœ¯å±‚é¢ï¼š
â€¢ ç½‘ç»œå»¶è¿Ÿå’Œå¸¦å®½é™åˆ¶
â€¢ ä»åº“ç¡¬ä»¶æ€§èƒ½ç“¶é¢ˆ
â€¢ å¤§äº‹åŠ¡é˜»å¡å¤åˆ¶è¿›ç¨‹

ä¸šåŠ¡å±‚é¢ï¼š
â€¢ å†™å…¥å‹åŠ›è¿‡å¤§
â€¢ å¤æ‚æŸ¥è¯¢å ç”¨èµ„æº
â€¢ ä¸åˆç†çš„äº‹åŠ¡è®¾è®¡
```

**ğŸ”¹ ä¸€è‡´æ€§æ£€æŸ¥çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆè¦æ£€æŸ¥ï¼š
â€¢ åŠæ—©å‘ç°æ•°æ®ä¸ä¸€è‡´
â€¢ é¿å…ä¸šåŠ¡é€»è¾‘é”™è¯¯
â€¢ ä¿è¯æ•°æ®è´¨é‡

æ£€æŸ¥æ–¹æ³•ï¼š
â€¢ æŠ€æœ¯æŒ‡æ ‡ï¼šå»¶è¿Ÿã€ä½ç½®ã€GTID
â€¢ ä¸šåŠ¡æŒ‡æ ‡ï¼šè®°å½•æ•°ã€é‡‘é¢ã€çŠ¶æ€
â€¢ å®šæœŸæ ¡éªŒï¼šè‡ªåŠ¨åŒ–å·¥å…·éªŒè¯
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


- **ç”µå•†å¹³å°**ï¼šè®¢å•ä¸€è‡´æ€§ä¿è¯ç”¨æˆ·ä½“éªŒ
- **é‡‘èç³»ç»Ÿ**ï¼šèµ„é‡‘å®‰å…¨è¦æ±‚å¼ºä¸€è‡´æ€§
- **å†…å®¹å¹³å°**ï¼šæ–‡ç« å‘å¸ƒå¯ç”¨æœ€ç»ˆä¸€è‡´æ€§
- **ç›‘æ§è¿ç»´**ï¼šå®æ—¶æ£€æµ‹ä¿è¯ç³»ç»Ÿç¨³å®š
- **å®¹ç¾æ¢å¤**ï¼šä¸€è‡´æ€§æ£€æŸ¥ç¡®ä¿æ•°æ®å®Œæ•´

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¸€è‡´æ€§æ˜¯æ•°æ®å®‰å…¨çš„åŸºçŸ³
- ä¸åŒä¸šåŠ¡éœ€è¦ä¸åŒä¸€è‡´æ€§çº§åˆ«  
- ç›‘æ§æ£€æŸ¥æ˜¯ä¸€è‡´æ€§ä¿è¯çš„å…³é”®
- æ•…éšœå¤„ç†éœ€è¦å¿«é€Ÿå‡†ç¡®çš„è¯Šæ–­
- æ€§èƒ½å’Œä¸€è‡´æ€§éœ€è¦åˆç†å¹³è¡¡