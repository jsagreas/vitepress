---
title: 3ã€MHAæ•…éšœæ£€æµ‹ä¸åˆ‡æ¢
---
## ğŸ“š ç›®å½•

1. [MHAæ•…éšœæ£€æµ‹æœºåˆ¶æ¦‚è¿°](#1-MHAæ•…éšœæ£€æµ‹æœºåˆ¶æ¦‚è¿°)
2. [å¿ƒè·³æ£€æµ‹ç®—æ³•è¯¦è§£](#2-å¿ƒè·³æ£€æµ‹ç®—æ³•è¯¦è§£)
3. [æ•…éšœåˆ¤å®šæ¡ä»¶ä¸å¤šé‡éªŒè¯](#3-æ•…éšœåˆ¤å®šæ¡ä»¶ä¸å¤šé‡éªŒè¯)
4. [è‡ªåŠ¨åˆ‡æ¢æµç¨‹æœºåˆ¶](#4-è‡ªåŠ¨åˆ‡æ¢æµç¨‹æœºåˆ¶)
5. [æ•°æ®ä¸€è‡´æ€§ä¿è¯ç­–ç•¥](#5-æ•°æ®ä¸€è‡´æ€§ä¿è¯ç­–ç•¥)
6. [åˆ‡æ¢æ—¶é—´æ§åˆ¶ä¸ä¼˜åŒ–](#6-åˆ‡æ¢æ—¶é—´æ§åˆ¶ä¸ä¼˜åŒ–)
7. [æ•…éšœæ¢å¤æµç¨‹è¯¦è§£](#7-æ•…éšœæ¢å¤æµç¨‹è¯¦è§£)
8. [æ™ºèƒ½åŒ–æ”¹è¿›ä¸é£é™©è¯„ä¼°](#8-æ™ºèƒ½åŒ–æ”¹è¿›ä¸é£é™©è¯„ä¼°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” MHAæ•…éšœæ£€æµ‹æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHAæ•…éšœæ£€æµ‹


**é€šä¿—ç†è§£**ï¼šMHAæ•…éšœæ£€æµ‹å°±åƒæ˜¯ç»™MySQLä¸»ä»æ¶æ„é…äº†ä¸€ä¸ª"æ™ºèƒ½ä¿é•–"ï¼Œæ—¶åˆ»ç›‘æ§ä¸»åº“çš„å¥åº·çŠ¶æ€ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼š                    MHAæ–¹å¼ï¼š
ä¸»åº“å®•æœº â†’ æ‰‹åŠ¨å‘ç° â†’ æ‰‹åŠ¨åˆ‡æ¢    ä¸»åº“å®•æœº â†’ è‡ªåŠ¨æ£€æµ‹ â†’ è‡ªåŠ¨åˆ‡æ¢
  â†“                           â†“
åœæœºå‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶              åœæœº10-30ç§’
```

**MHAæ£€æµ‹åŸç†**ï¼š
- **å®æ—¶ç›‘æ§**ï¼šæŒç»­æ£€æŸ¥ä¸»åº“æ˜¯å¦æ­£å¸¸å·¥ä½œ
- **å¤šç»´åº¦æ£€æµ‹**ï¼šä¸åªçœ‹è¿æ¥ï¼Œè¿˜çœ‹æ•°æ®åº“å†…éƒ¨çŠ¶æ€  
- **æ™ºèƒ½åˆ¤æ–­**ï¼šé¿å…è¯¯åˆ¤ï¼Œç¡®ä¿çœŸæ­£æ•…éšœæ‰åˆ‡æ¢
- **å¿«é€Ÿå“åº”**ï¼šå‘ç°æ•…éšœåç«‹å³å¯åŠ¨åˆ‡æ¢æµç¨‹

### 1.2 æ£€æµ‹æ¶æ„ç»„æˆ


```
MHAæ£€æµ‹ä½“ç³»æ¶æ„ï¼š

       ğŸ“± MHA Manager
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â”‚      â”‚      â”‚
   ğŸ“Š ç›‘æ§  ğŸ“¡ æ£€æµ‹  ğŸ”„ åˆ‡æ¢
   æ¨¡å—    æ¨¡å—    æ¨¡å—
    â”‚      â”‚      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
ğŸ—„ï¸ Master    ğŸ—„ï¸ Slave1    ğŸ—„ï¸ Slave2
  (ä¸»åº“)      (ä»åº“1)     (ä»åº“2)
```

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **MHA Manager**ï¼šç›‘æ§ä¸­å¿ƒï¼Œè´Ÿè´£æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢å†³ç­–
- **MHA Node**ï¼šéƒ¨ç½²åœ¨æ¯å°MySQLæœåŠ¡å™¨ä¸Šçš„ä»£ç†
- **æ£€æµ‹æ¢é’ˆ**ï¼šå¤šç§æ£€æµ‹æ–¹å¼çš„ç»„åˆä½¿ç”¨

### 1.3 æ£€æµ‹æœºåˆ¶çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦ç²¾ç¡®çš„æ•…éšœæ£€æµ‹**ï¼š

```
âŒ æ£€æµ‹ä¸å‡†ç¡®çš„åæœï¼š
- è¯¯åˆ¤ï¼šæ­£å¸¸ä¸»åº“è¢«é”™è¯¯åˆ‡æ¢ â†’ ä¸šåŠ¡ä¸­æ–­
- æ¼åˆ¤ï¼šçœŸæ­£æ•…éšœæœªåŠæ—¶å‘ç° â†’ æ•°æ®ä¸¢å¤±
- å»¶è¿Ÿï¼šæ£€æµ‹æ—¶é—´è¿‡é•¿ â†’ å½±å“ä¸šåŠ¡è¿ç»­æ€§
```

```
âœ… ç²¾ç¡®æ£€æµ‹çš„ä»·å€¼ï¼š
- å‡å°‘è¯¯åˆ‡æ¢ï¼šé¿å…ä¸å¿…è¦çš„ä¸šåŠ¡ä¸­æ–­
- å¿«é€Ÿå“åº”ï¼šç¼©çŸ­æ•…éšœæ¢å¤æ—¶é—´
- æ•°æ®ä¿æŠ¤ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
```

---

## 2. ğŸ’“ å¿ƒè·³æ£€æµ‹ç®—æ³•è¯¦è§£


### 2.1 å¿ƒè·³æ£€æµ‹åŸºæœ¬åŸç†


**ä»€ä¹ˆæ˜¯å¿ƒè·³æ£€æµ‹**ï¼š
å¿ƒè·³æ£€æµ‹å°±åƒåŒ»ç”Ÿç»™ç—…äººé‡è„‰æä¸€æ ·ï¼ŒMHAå®šæœŸå‘ä¸»åº“å‘é€"ä½ è¿˜å¥½å—ï¼Ÿ"çš„ä¿¡å·ï¼Œæ ¹æ®ä¸»åº“çš„å›åº”åˆ¤æ–­å¥åº·çŠ¶æ€ã€‚

```
å¿ƒè·³æ£€æµ‹æµç¨‹ï¼š

MHA Manager                    MySQL Master
     â”‚                            â”‚
     â”‚â”€â”€â”€â”€â”€â”€ â¤ï¸ å¿ƒè·³è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                            â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€ âœ… æ­£å¸¸å›åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                            â”‚
     â”‚â”€â”€â”€â”€â”€â”€ â¤ï¸ å¿ƒè·³è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                            â”‚ (ä¸»åº“æ•…éšœ)
     â”‚         âŒ æ— å›åº”           â”‚ 
     â”‚                            â”‚
     â”‚ ğŸš¨ è§¦å‘æ•…éšœæ£€æµ‹æµç¨‹
```

### 2.2 å¤šå±‚æ¬¡å¿ƒè·³ç®—æ³•


**MHAé‡‡ç”¨ä¸‰å±‚å¿ƒè·³æ£€æµ‹**ï¼š

```
ç¬¬ä¸€å±‚ï¼šç½‘ç»œè¿æ¥æ£€æµ‹
ping 192.168.1.100  # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿

ç¬¬äºŒå±‚ï¼šMySQLç«¯å£æ£€æµ‹  
telnet 192.168.1.100 3306  # æ£€æŸ¥MySQLæœåŠ¡æ˜¯å¦å¯åŠ¨

ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“çŠ¶æ€æ£€æµ‹
SELECT 1  # æ£€æŸ¥æ•°æ®åº“æ˜¯å¦èƒ½æ­£å¸¸å“åº”SQL
```

**è¯¦ç»†ç®—æ³•å®ç°**ï¼š

```python
# ç®€åŒ–çš„å¿ƒè·³æ£€æµ‹ç®—æ³•ç¤ºä¾‹
def heartbeat_check():
    # é…ç½®å‚æ•°
    check_interval = 3        # æ£€æµ‹é—´éš”3ç§’
    max_failures = 3          # è¿ç»­å¤±è´¥3æ¬¡åˆ¤å®šæ•…éšœ
    failure_count = 0
    
    while True:
        # ç¬¬ä¸€å±‚ï¼šç½‘ç»œæ£€æµ‹
        if not ping_check(master_ip):
            failure_count += 1
        # ç¬¬äºŒå±‚ï¼šç«¯å£æ£€æµ‹  
        elif not port_check(master_ip, 3306):
            failure_count += 1
        # ç¬¬ä¸‰å±‚ï¼šSQLæ£€æµ‹
        elif not sql_check("SELECT 1"):
            failure_count += 1
        else:
            failure_count = 0     # æ£€æµ‹æˆåŠŸï¼Œé‡ç½®è®¡æ•°å™¨
            
        # åˆ¤æ–­æ˜¯å¦è§¦å‘æ•…éšœåˆ‡æ¢
        if failure_count >= max_failures:
            trigger_failover()    # å¯åŠ¨æ•…éšœåˆ‡æ¢
            
        time.sleep(check_interval)
```

### 2.3 å¿ƒè·³å‚æ•°è°ƒä¼˜


**å…³é”®å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | é»˜è®¤å€¼ | ä½œç”¨ | è°ƒä¼˜å»ºè®® |
|------|--------|------|----------|
| `check_repl_delay` | 3ç§’ | å¿ƒè·³æ£€æµ‹é—´éš” | ç½‘ç»œå¥½ï¼š1-2ç§’<br>ç½‘ç»œå·®ï¼š5-10ç§’ |
| `master_ip_failover_script` | æ—  | æ•…éšœåˆ‡æ¢è„šæœ¬ | è‡ªå®šä¹‰VIPåˆ‡æ¢é€»è¾‘ |
| `secondary_check_script` | æ—  | äºŒæ¬¡ç¡®è®¤è„šæœ¬ | é˜²æ­¢ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤ |

**å¿ƒè·³æ£€æµ‹ä¼˜åŒ–ç­–ç•¥**ï¼š

```bash
# MHAé…ç½®æ–‡ä»¶ç¤ºä¾‹
[server default]
# å¿ƒè·³æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰
ping_interval=3

# è¿ç»­å¤±è´¥æ¬¡æ•°é˜ˆå€¼
master_ping_attempts=3

# äºŒæ¬¡ç¡®è®¤æ£€æµ‹
secondary_check_script=/usr/local/bin/masterha_secondary_check

# ç½‘ç»œæ£€æµ‹è¶…æ—¶
ping_timeout=1
```

---

## 3. âš–ï¸ æ•…éšœåˆ¤å®šæ¡ä»¶ä¸å¤šé‡éªŒè¯


### 3.1 æ•…éšœåˆ¤å®šçš„æŒ‘æˆ˜


**ä¸ºä»€ä¹ˆéœ€è¦è°¨æ…åˆ¤å®š**ï¼š

```
âŒ å¸¸è§è¯¯åˆ¤åœºæ™¯ï¼š
1. ç½‘ç»œæŠ–åŠ¨ï¼šç¬é—´ç½‘ç»œä¸é€šï¼Œä½†ä¸»åº“æ­£å¸¸
2. é«˜è´Ÿè½½ï¼šä¸»åº“å‹åŠ›å¤§å“åº”æ…¢ï¼Œä½†ä»å¯æœåŠ¡  
3. é”ç­‰å¾…ï¼šé•¿äº‹åŠ¡å¯¼è‡´ä¸´æ—¶æ— å“åº”
4. ç»´æŠ¤æ“ä½œï¼šDBAæ­£åœ¨è¿›è¡Œç»´æŠ¤ï¼Œæš‚æ—¶åœæ­¢æœåŠ¡
```

**MHAçš„æ™ºèƒ½åˆ¤å®šæœºåˆ¶**ï¼š

```
å¤šé‡éªŒè¯æµç¨‹ï¼š

Step 1: åˆæ­¥æ£€æµ‹
  â†“ (å¿ƒè·³å¤±è´¥)
Step 2: å¤šè·¯å¾„éªŒè¯  
  â†“ (ç¡®è®¤ç½‘ç»œé—®é¢˜)
Step 3: ä»åº“çŠ¶æ€ç¡®è®¤
  â†“ (ä»åº“ä¹Ÿæ–­å¼€è¿æ¥)  
Step 4: äºŒæ¬¡ç¡®è®¤è„šæœ¬
  â†“ (æœ€ç»ˆç¡®è®¤æ•…éšœ)
Step 5: æ‰§è¡Œæ•…éšœåˆ‡æ¢
```

### 3.2 å¤šé‡éªŒè¯æœºåˆ¶è¯¦è§£


**éªŒè¯æœºåˆ¶ä¸€ï¼šå¤šè·¯å¾„ç½‘ç»œæ£€æµ‹**

```bash
# äºŒæ¬¡ç¡®è®¤è„šæœ¬ç¤ºä¾‹
#!/bin/bash
# masterha_secondary_check

master_host=$1
master_ip=$2

# ä»å¤šä¸ªç½‘ç»œè·¯å¾„æ£€æµ‹ä¸»åº“
ping_result1=$(ping -c 3 $master_ip)
ping_result2=$(ping -c 3 $master_host)

# ä»ä¸åŒç½‘æ®µæ£€æµ‹
ssh backup_server "ping -c 3 $master_ip"

# æ£€æµ‹MySQLç«¯å£
nc -z $master_ip 3306

# å¦‚æœæ‰€æœ‰è·¯å¾„éƒ½å¤±è´¥ï¼Œç¡®è®¤æ•…éšœ
exit 0  # ç¡®è®¤æ•…éšœ
exit 1  # æ£€æµ‹é€šè¿‡ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨
```

**éªŒè¯æœºåˆ¶äºŒï¼šä»åº“è¿æ¥çŠ¶æ€ç¡®è®¤**

```sql
-- åœ¨ä»åº“ä¸Šæ£€æŸ¥ä¸»ä»å¤åˆ¶çŠ¶æ€
SHOW SLAVE STATUS\G

-- å…³é”®æŒ‡æ ‡ï¼š
-- Slave_IO_Running: No      â† ä»åº“ä¹Ÿæ— æ³•è¿æ¥ä¸»åº“
-- Slave_SQL_Running: Yes    â† SQLçº¿ç¨‹æ­£å¸¸ï¼Œè¯´æ˜æ˜¯ä¸»åº“é—®é¢˜
-- Last_IO_Error: è¿æ¥é”™è¯¯ä¿¡æ¯
```

**éªŒè¯æœºåˆ¶ä¸‰ï¼šåº”ç”¨å±‚å¥åº·æ£€æŸ¥**

```python
# åº”ç”¨å±‚æ£€æµ‹è„šæœ¬
def app_health_check():
    try:
        # å°è¯•æ‰§è¡Œç®€å•æŸ¥è¯¢
        conn = mysql.connect(host=master_ip)
        cursor = conn.cursor()
        cursor.execute("SELECT NOW()")
        result = cursor.fetchone()
        return True
    except Exception as e:
        logger.error(f"åº”ç”¨å±‚æ£€æµ‹å¤±è´¥: {e}")
        return False
```

### 3.3 æ™ºèƒ½æ•…éšœåˆ¤å®šç®—æ³•


**MHAçš„åˆ¤å®šé€»è¾‘**ï¼š

```
æ•…éšœåˆ¤å®šå†³ç­–æ ‘ï¼š

ç½‘ç»œæ£€æµ‹å¤±è´¥ï¼Ÿ
â”œâ”€ No â†’ ç»§ç»­ç›‘æ§
â””â”€ Yes â†’ å¤šè·¯å¾„ç¡®è®¤ï¼Ÿ
           â”œâ”€ éƒ¨åˆ†é€šè¿‡ â†’ ç½‘ç»œæŠ–åŠ¨ï¼Œç»§ç»­ç›‘æ§  
           â””â”€ å…¨éƒ¨å¤±è´¥ â†’ ä»åº“çŠ¶æ€æ£€æŸ¥ï¼Ÿ
                         â”œâ”€ ä»åº“æ­£å¸¸è¿æ¥ â†’ å¯èƒ½æ˜¯MHAç½‘ç»œé—®é¢˜
                         â””â”€ ä»åº“ä¹Ÿæ–­å¼€ â†’ åº”ç”¨æ£€æµ‹ï¼Ÿ
                                       â”œâ”€ åº”ç”¨æ­£å¸¸ â†’ è°¨æ…å¤„ç†
                                       â””â”€ åº”ç”¨å¼‚å¸¸ â†’ ç¡®è®¤æ•…éšœï¼Œæ‰§è¡Œåˆ‡æ¢
```

**é˜²è¯¯åˆ¤é…ç½®**ï¼š

```bash
# MHAé«˜çº§é…ç½®
[server default]
# æ•…éšœç¡®è®¤ç­‰å¾…æ—¶é—´
master_ip_failover_timeout=60

# éœ€è¦å¤šä¸ªä»åº“ç¡®è®¤æ•…éšœ  
min_slaves_for_failover=2

# å¯ç”¨äºŒæ¬¡ç¡®è®¤è„šæœ¬
secondary_check_script=/usr/local/bin/masterha_secondary_check

# æ•…éšœåˆ¤å®šä¸¥æ ¼æ¨¡å¼
strict_mode=1
```

---

## 4. ğŸ”„ è‡ªåŠ¨åˆ‡æ¢æµç¨‹æœºåˆ¶


### 4.1 è‡ªåŠ¨åˆ‡æ¢æ€»ä½“æµç¨‹


**MHAè‡ªåŠ¨åˆ‡æ¢çš„å®Œæ•´æµç¨‹**ï¼š

```
æ•…éšœåˆ‡æ¢æ—¶åºå›¾ï¼š

æ—¶é—´è½´ â”‚ MHA Manager â”‚ åŸä¸»åº“ â”‚ æœ€ä¼˜ä»åº“ â”‚ å…¶ä»–ä»åº“ â”‚ åº”ç”¨
â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€
T0   â”‚ æ£€æµ‹åˆ°æ•…éšœ   â”‚  ğŸ’€   â”‚   è¿è¡Œ   â”‚   è¿è¡Œ   â”‚ æ­£å¸¸
T1   â”‚ åœæ­¢ç›‘æ§     â”‚  ğŸ’€   â”‚   è¿è¡Œ   â”‚   è¿è¡Œ   â”‚ å¼‚å¸¸
T2   â”‚ é€‰æ‹©æ–°ä¸»åº“   â”‚  ğŸ’€   â”‚ ğŸ“Œè¢«é€‰ä¸­  â”‚   ç­‰å¾…   â”‚ å¼‚å¸¸  
T3   â”‚ æ•°æ®è¡¥é½     â”‚  ğŸ’€   â”‚ ğŸ“¥æ¢å¤æ•°æ®â”‚ ğŸ“¥æ¢å¤æ•°æ®â”‚ å¼‚å¸¸
T4   â”‚ æå‡ä¸ºä¸»åº“   â”‚  ğŸ’€   â”‚ ğŸ‘‘æ–°ä¸»åº“  â”‚   ç­‰å¾…   â”‚ å¼‚å¸¸
T5   â”‚ é‡é…ç½®ä»åº“   â”‚  ğŸ’€   â”‚ ğŸ‘‘æ–°ä¸»åº“  â”‚ ğŸ”„é‡é…ç½® â”‚ å¼‚å¸¸
T6   â”‚ åˆ‡æ¢VIP     â”‚  ğŸ’€   â”‚ ğŸ‘‘æ–°ä¸»åº“  â”‚ ğŸ“¡è¿æ¥ä¸­ â”‚ æ¢å¤
T7   â”‚ é€šçŸ¥åº”ç”¨     â”‚  ğŸ’€   â”‚ ğŸ‘‘æ–°ä¸»åº“  â”‚ ğŸ“¡å·²è¿æ¥ â”‚ æ­£å¸¸
```

### 4.2 åˆ‡æ¢æµç¨‹è¯¦ç»†æ­¥éª¤


**Step 1: æ•…éšœç¡®è®¤ä¸èµ„æºé”å®š**

```bash
# MHA Manageræ‰§è¡Œçš„æ“ä½œ
1. ç¡®è®¤ä¸»åº“æ•…éšœ
2. è·å–å…¨å±€é”ï¼Œé˜²æ­¢å¹¶å‘åˆ‡æ¢
3. åœæ­¢å¯¹æ•…éšœä¸»åº“çš„ç›‘æ§
4. é€šçŸ¥ç®¡ç†å‘˜æ•…éšœå‘ç”Ÿ

# æ—¥å¿—ç¤ºä¾‹
[INFO] Master 192.168.1.100:3306 is down!
[INFO] Starting automatic failover process
[INFO] Acquiring global lock for failover
```

**Step 2: é€‰æ‹©æœ€ä¼˜ä»åº“**

```python
# æ–°ä¸»åº“é€‰æ‹©ç®—æ³•
def select_new_master(slaves):
    candidates = []
    
    for slave in slaves:
        # æ£€æŸ¥ä»åº“åŸºæœ¬æ¡ä»¶
        if not slave.is_healthy():
            continue
            
        # è®¡ç®—æ•°æ®å»¶è¿Ÿ
        relay_log_pos = slave.get_relay_log_position()
        
        # è®¡ç®—ä¼˜å…ˆçº§è¯„åˆ†
        score = calculate_priority_score(slave)
        
        candidates.append({
            'slave': slave,
            'relay_pos': relay_log_pos,
            'score': score
        })
    
    # é€‰æ‹©æ•°æ®æœ€æ–°ä¸”ä¼˜å…ˆçº§æœ€é«˜çš„ä»åº“
    best_candidate = max(candidates, key=lambda x: (x['relay_pos'], x['score']))
    return best_candidate['slave']
```

**Step 3: æ•°æ®å®Œæ•´æ€§ä¿è¯**

```sql
-- åœ¨è¢«é€‰ä¸­çš„æ–°ä¸»åº“ä¸Šæ‰§è¡Œ
-- 1. åœæ­¢ä»åº“å¤åˆ¶
STOP SLAVE;

-- 2. åº”ç”¨æ‰€æœ‰relay log
START SLAVE UNTIL MASTER_LOG_FILE='binlog.000123', 
                  MASTER_LOG_POS=456789;

-- 3. ç¡®ä¿æ•°æ®å®Œå…¨åº”ç”¨
SELECT MASTER_POS_WAIT('binlog.000123', 456789);

-- 4. é‡ç½®ä»åº“çŠ¶æ€
RESET SLAVE ALL;
```

**Step 4: æå‡æ–°ä¸»åº“**

```sql
-- æ–°ä¸»åº“é…ç½®
-- 1. å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆå¦‚æœæœªå¼€å¯ï¼‰
SET GLOBAL log_bin = ON;

-- 2. è®¾ç½®ä¸ºå¯å†™
SET GLOBAL read_only = OFF;
SET GLOBAL super_read_only = OFF;

-- 3. é‡æ–°ç”Ÿæˆserver_uuidï¼ˆé¿å…å†²çªï¼‰
SET GLOBAL server_uuid = UUID();
```

**Step 5: é‡é…ç½®å…¶ä»–ä»åº“**

```sql
-- åœ¨å…¶ä»–ä»åº“ä¸Šæ‰§è¡Œ
-- 1. åœæ­¢ä»åº“å¤åˆ¶
STOP SLAVE;

-- 2. æŒ‡å‘æ–°ä¸»åº“
CHANGE MASTER TO 
  MASTER_HOST='192.168.1.101',    -- æ–°ä¸»åº“IP
  MASTER_PORT=3306,
  MASTER_USER='repl_user',
  MASTER_PASSWORD='repl_password',
  MASTER_AUTO_POSITION=1;         -- ä½¿ç”¨GTID

-- 3. å¯åŠ¨å¤åˆ¶
START SLAVE;
```

### 4.3 VIPåˆ‡æ¢æœºåˆ¶


**è™šæ‹ŸIPåˆ‡æ¢åŸç†**ï¼š

```bash
# æ•…éšœåˆ‡æ¢æ—¶çš„VIPæ“ä½œ
#!/bin/bash
# master_ip_failoverè„šæœ¬

case "$1" in
    --start)
        # åœ¨æ–°ä¸»åº“ä¸Šç»‘å®šVIP
        ip addr add 192.168.1.200/24 dev eth0
        arping -c 3 -I eth0 192.168.1.200
        ;;
    --stop)  
        # ä»æ•…éšœä¸»åº“ç§»é™¤VIP
        ip addr del 192.168.1.200/24 dev eth0
        ;;
    --status)
        # æ£€æŸ¥VIPçŠ¶æ€
        ip addr show eth0 | grep 192.168.1.200
        ;;
esac
```

**åº”ç”¨è¿æ¥åˆ‡æ¢**ï¼š

```
VIPåˆ‡æ¢å‰ï¼š
åº”ç”¨ â†’ VIP(192.168.1.200) â†’ åŸä¸»åº“(192.168.1.100)

VIPåˆ‡æ¢åï¼š  
åº”ç”¨ â†’ VIP(192.168.1.200) â†’ æ–°ä¸»åº“(192.168.1.101)

ä¼˜åŠ¿ï¼šåº”ç”¨æ— éœ€ä¿®æ”¹è¿æ¥é…ç½®
```

---

## 5. ğŸ”’ æ•°æ®ä¸€è‡´æ€§ä¿è¯ç­–ç•¥


### 5.1 æ•°æ®ä¸€è‡´æ€§é¢ä¸´çš„æŒ‘æˆ˜


**åˆ‡æ¢è¿‡ç¨‹ä¸­çš„æ•°æ®é£é™©**ï¼š

```
âŒ å¯èƒ½çš„æ•°æ®é—®é¢˜ï¼š
1. æ•°æ®ä¸¢å¤±ï¼šåŸä¸»åº“æœªåŒæ­¥çš„æ•°æ®ä¸¢å¤±
2. æ•°æ®ä¸ä¸€è‡´ï¼šä¸åŒä»åº“çš„æ•°æ®çŠ¶æ€ä¸åŒ
3. é‡å¤æ•°æ®ï¼šåº”ç”¨é‡å¤æäº¤äº‹åŠ¡
4. è„è¯»ï¼šè¯»åˆ°æœªæäº¤çš„äº‹åŠ¡æ•°æ®
```

### 5.2 äº‹åŠ¡å®Œæ•´æ€§ä¿è¯æœºåˆ¶


**åŠåŒæ­¥å¤åˆ¶é…ç½®**ï¼š

```sql
-- åœ¨ä¸»åº“ä¸Šé…ç½®åŠåŒæ­¥å¤åˆ¶
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
SET GLOBAL rpl_semi_sync_master_enabled = ON;
SET GLOBAL rpl_semi_sync_master_timeout = 3000;  -- 3ç§’è¶…æ—¶

-- åœ¨ä»åº“ä¸Šé…ç½®
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';  
SET GLOBAL rpl_semi_sync_slave_enabled = ON;
```

**GTIDä¸€è‡´æ€§ä¿è¯**ï¼š

```sql
-- å¼€å¯GTIDæ¨¡å¼ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
-- ä¸»åº“é…ç½®
gtid_mode = ON
enforce_gtid_consistency = ON
log_slave_updates = ON

-- æ£€æŸ¥GTIDä¸€è‡´æ€§
SELECT $$GLOBAL.GTID_EXECUTED;  -- æŸ¥çœ‹å·²æ‰§è¡Œçš„GTIDé›†åˆ

-- ç­‰å¾…GTIDåŒæ­¥
SELECT WAIT_FOR_EXECUTED_GTID_SET('uuid:1-100', 10);
```

### 5.3 åˆ‡æ¢è¿‡ç¨‹çš„æ•°æ®ä¿æŠ¤


**æ•°æ®æ¢å¤ç­–ç•¥**ï¼š

```python
# MHAæ•°æ®æ¢å¤ç®—æ³•
def data_recovery_process():
    # 1. åˆ†æå„ä»åº“çš„æ•°æ®ä½ç½®
    slaves_status = analyze_slaves_relay_log()
    
    # 2. æ‰¾åˆ°æ•°æ®æœ€å®Œæ•´çš„ä»åº“
    most_updated_slave = find_most_updated_slave(slaves_status)
    
    # 3. ä»æ•…éšœä¸»åº“æ¢å¤æœªåŒæ­¥æ•°æ®ï¼ˆå¦‚æœå¯èƒ½ï¼‰
    if can_access_failed_master():
        recover_differential_data()
    
    # 4. åº”ç”¨å·®å¼‚æ•°æ®åˆ°æ–°ä¸»åº“
    apply_differential_data_to_new_master()
    
    # 5. ç¡®ä¿æ‰€æœ‰ä»åº“æ•°æ®ä¸€è‡´
    sync_all_slaves()
```

**äº‹åŠ¡è¾¹ç•Œæ§åˆ¶**ï¼š

```sql
-- åœ¨åˆ‡æ¢å‰ç¡®ä¿äº‹åŠ¡å®Œæ•´æ€§
-- 1. ç­‰å¾…æ‰€æœ‰äº‹åŠ¡æäº¤
SELECT COUNT(*) FROM information_schema.innodb_trx;

-- 2. è®¾ç½®åªè¯»æ¨¡å¼
SET GLOBAL read_only = ON;

-- 3. ç­‰å¾…binlogåŒæ­¥å®Œæˆ  
SHOW MASTER STATUS;  -- è®°å½•æœ€åä½ç½®
-- åœ¨ä»åº“æ£€æŸ¥åŒæ­¥è¿›åº¦
SHOW SLAVE STATUS;   -- ç¡®è®¤å·²åŒæ­¥åˆ°æœ€åä½ç½®
```

---

## 6. â±ï¸ åˆ‡æ¢æ—¶é—´æ§åˆ¶ä¸ä¼˜åŒ–


### 6.1 åˆ‡æ¢æ—¶é—´ç»„æˆåˆ†æ


**MHAåˆ‡æ¢æ—¶é—´æ„æˆ**ï¼š

```
æ€»åˆ‡æ¢æ—¶é—´ = æ•…éšœæ£€æµ‹æ—¶é—´ + åˆ‡æ¢æ‰§è¡Œæ—¶é—´ + åº”ç”¨æ¢å¤æ—¶é—´

è¯¦ç»†åˆ†è§£ï¼š
â”Œâ”€ æ•…éšœæ£€æµ‹ â”€â”¬â”€ åˆ‡æ¢æ‰§è¡Œ â”€â”¬â”€ åº”ç”¨æ¢å¤ â”€â”
â”‚  3-10ç§’   â”‚  10-30ç§’  â”‚   1-5ç§’   â”‚ = 14-45ç§’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–ç›®æ ‡ï¼šå°†æ€»æ—¶é—´æ§åˆ¶åœ¨30ç§’ä»¥å†…
```

### 6.2 æ£€æµ‹æ—¶é—´ä¼˜åŒ–


**å¿«é€Ÿæ•…éšœæ£€æµ‹é…ç½®**ï¼š

```bash
# æ¿€è¿›æ£€æµ‹é…ç½®ï¼ˆé€‚ç”¨äºå¯¹å¯ç”¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼‰
[server default]
ping_interval=1               # 1ç§’æ£€æµ‹é—´éš”
master_ping_attempts=2        # è¿ç»­å¤±è´¥2æ¬¡å³åˆ¤å®šæ•…éšœ  
ping_timeout=1                # 1ç§’è¶…æ—¶
master_ip_failover_timeout=10 # 10ç§’å†…å®Œæˆåˆ‡æ¢

# ä¿å®ˆæ£€æµ‹é…ç½®ï¼ˆé€‚ç”¨äºç½‘ç»œä¸ç¨³å®šçš„åœºæ™¯ï¼‰  
ping_interval=5               # 5ç§’æ£€æµ‹é—´éš”
master_ping_attempts=3        # è¿ç»­å¤±è´¥3æ¬¡åˆ¤å®šæ•…éšœ
ping_timeout=3                # 3ç§’è¶…æ—¶
```

**æ£€æµ‹ä¼˜åŒ–ç­–ç•¥**ï¼š

```python
# å¹¶è¡Œæ£€æµ‹ä¼˜åŒ–
import threading

def parallel_health_check():
    results = {}
    threads = []
    
    # å¹¶è¡Œæ‰§è¡Œå¤šç§æ£€æµ‹
    checks = [
        ('network', network_check),
        ('mysql', mysql_port_check), 
        ('sql', sql_response_check),
        ('app', application_check)
    ]
    
    for check_name, check_func in checks:
        t = threading.Thread(target=lambda: results.update({check_name: check_func()}))
        t.start()
        threads.append(t)
    
    # ç­‰å¾…æ‰€æœ‰æ£€æµ‹å®Œæˆ
    for t in threads:
        t.join(timeout=2)  # 2ç§’è¶…æ—¶
        
    # å¿«é€Ÿåˆ¤å®šï¼šä»»æ„æ£€æµ‹å¤±è´¥å³å¯åˆ¤å®šæ•…éšœ
    return any(results.values())
```

### 6.3 åˆ‡æ¢æ‰§è¡Œæ—¶é—´ä¼˜åŒ–


**å¹¶è¡Œåˆ‡æ¢æ“ä½œ**ï¼š

```bash
# ä¼˜åŒ–çš„åˆ‡æ¢è„šæœ¬
#!/bin/bash
# å¹¶è¡Œæ‰§è¡Œåˆ‡æ¢æ“ä½œ

# å¹¶è¡Œä»»åŠ¡1ï¼šé…ç½®æ–°ä¸»åº“
configure_new_master() {
    mysql -h $new_master -e "
        SET GLOBAL read_only=OFF;
        SET GLOBAL super_read_only=OFF;
        RESET SLAVE ALL;
    "
} &

# å¹¶è¡Œä»»åŠ¡2ï¼šé‡é…ç½®ä»åº“
reconfigure_slaves() {
    for slave in $slave_list; do
        mysql -h $slave -e "
            STOP SLAVE;
            CHANGE MASTER TO MASTER_HOST='$new_master';
            START SLAVE;
        " &
    done
    wait  # ç­‰å¾…æ‰€æœ‰ä»åº“é…ç½®å®Œæˆ
} &

# å¹¶è¡Œä»»åŠ¡3ï¼šVIPåˆ‡æ¢
switch_vip() {
    # ç§»é™¤æ•…éšœä¸»åº“VIP
    ssh $failed_master "ip addr del $vip dev eth0" &
    # æ·»åŠ æ–°ä¸»åº“VIP  
    ssh $new_master "ip addr add $vip dev eth0" &
    wait
} &

# ç­‰å¾…æ‰€æœ‰å¹¶è¡Œä»»åŠ¡å®Œæˆ
wait
```

### 6.4 åˆ‡æ¢æ—¶é—´ç›‘æ§ä¸è°ƒä¼˜


**åˆ‡æ¢æ€§èƒ½ç›‘æ§**ï¼š

```sql
-- åˆ›å»ºåˆ‡æ¢æ€§èƒ½ç›‘æ§è¡¨
CREATE TABLE mha_failover_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    failover_time TIMESTAMP,
    detection_duration INT,      -- æ£€æµ‹è€—æ—¶ï¼ˆç§’ï¼‰
    failover_duration INT,       -- åˆ‡æ¢è€—æ—¶ï¼ˆç§’ï¼‰  
    recovery_duration INT,       -- æ¢å¤è€—æ—¶ï¼ˆç§’ï¼‰
    total_duration INT,          -- æ€»è€—æ—¶ï¼ˆç§’ï¼‰
    failed_master VARCHAR(50),
    new_master VARCHAR(50),
    reason TEXT
);
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

| ä¼˜åŒ–æ–¹å‘ | å…·ä½“æªæ–½ | æ•ˆæœ |
|----------|----------|------|
| **ç½‘ç»œä¼˜åŒ–** | ä½¿ç”¨ä¸‡å…†ç½‘ç»œï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ | å‡å°‘2-5ç§’ |
| **ç¡¬ä»¶ä¼˜åŒ–** | SSDå­˜å‚¨ï¼Œæå‡IOæ€§èƒ½ | å‡å°‘3-8ç§’ |
| **é…ç½®ä¼˜åŒ–** | è°ƒæ•´æ£€æµ‹å‚æ•°ï¼Œå¹¶è¡Œæ‰§è¡Œ | å‡å°‘5-10ç§’ |
| **è„šæœ¬ä¼˜åŒ–** | ä¼˜åŒ–åˆ‡æ¢è„šæœ¬ï¼Œå‡å°‘æ‰§è¡Œæ­¥éª¤ | å‡å°‘2-5ç§’ |

---

## 7. ğŸ”„ æ•…éšœæ¢å¤æµç¨‹è¯¦è§£


### 7.1 æ•…éšœæ¢å¤ç­–ç•¥æ¦‚è¿°


**æ•…éšœæ¢å¤çš„ä¸¤ç§åœºæ™¯**ï¼š

```
åœºæ™¯ä¸€ï¼šåŸä¸»åº“å¯ä»¥ä¿®å¤
åŸä¸»åº“ â†’ ä¿®å¤ â†’ é‡æ–°åŠ å…¥é›†ç¾¤ â†’ ä½œä¸ºä»åº“

åœºæ™¯äºŒï¼šåŸä¸»åº“æ— æ³•ä¿®å¤  
åŸä¸»åº“ â†’ åºŸå¼ƒ â†’ éƒ¨ç½²æ–°æœåŠ¡å™¨ â†’ ä½œä¸ºä»åº“åŠ å…¥
```

### 7.2 åŸä¸»åº“ä¿®å¤ä¸é‡æ–°åŠ å…¥


**ä¿®å¤æµç¨‹**ï¼š

```bash
# Step 1: åˆ†ææ•…éšœåŸå› 
# æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—
tail -f /var/log/messages
tail -f /var/log/mysql/error.log

# æ£€æŸ¥ç¡¬ä»¶çŠ¶æ€
dmesg | grep -i error
smartctl -a /dev/sda  # æ£€æŸ¥ç£ç›˜å¥åº·

# Step 2: ä¿®å¤æ•…éšœ
# å¸¸è§ä¿®å¤æ“ä½œï¼š
- ä¿®å¤æ–‡ä»¶ç³»ç»Ÿé”™è¯¯ï¼šfsck /dev/sda1
- ä¿®å¤MySQLæ•°æ®æ–‡ä»¶ï¼šmysqld --innodb-force-recovery=1
- æ¸…ç†ç£ç›˜ç©ºé—´ï¼šæ¸…ç†æ—¥å¿—æ–‡ä»¶
- æ›´æ¢ç¡¬ä»¶ï¼šæ›´æ¢æ•…éšœç¡¬ç›˜
```

**æ•°æ®åŒæ­¥æ¢å¤**ï¼š

```sql
-- Step 3: æ•°æ®åŒæ­¥æ¢å¤
-- åœ¨ä¿®å¤çš„åŸä¸»åº“ä¸Šæ‰§è¡Œ

-- 1. é‡ç½®å¤åˆ¶ä¿¡æ¯
RESET MASTER;
RESET SLAVE ALL;

-- 2. é…ç½®ä¸ºä»åº“ï¼ŒæŒ‡å‘æ–°ä¸»åº“
CHANGE MASTER TO
  MASTER_HOST='192.168.1.101',    -- å½“å‰æ–°ä¸»åº“
  MASTER_USER='repl_user',
  MASTER_PASSWORD='repl_password',
  MASTER_AUTO_POSITION=1;         -- ä½¿ç”¨GTIDè‡ªåŠ¨å®šä½

-- 3. å¯åŠ¨å¤åˆ¶
START SLAVE;

-- 4. æ£€æŸ¥åŒæ­¥çŠ¶æ€
SHOW SLAVE STATUS\G
```

### 7.3 æ•°æ®ä¸€è‡´æ€§éªŒè¯


**æ•°æ®æ ¡éªŒæµç¨‹**ï¼š

```bash
# ä½¿ç”¨pt-table-checksumè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
pt-table-checksum \
  --host=192.168.1.101 \        # ä¸»åº“
  --databases=test_db \
  --replicate=percona.checksums \
  --create-replicate-table \
  --chunk-size=1000

# æŸ¥çœ‹æ ¡éªŒç»“æœ
mysql -e "SELECT * FROM percona.checksums WHERE master_cnt <> slave_cnt;"
```

**ä¿®å¤æ•°æ®ä¸ä¸€è‡´**ï¼š

```bash
# å¦‚æœå‘ç°æ•°æ®ä¸ä¸€è‡´ï¼Œä½¿ç”¨pt-table-syncä¿®å¤
pt-table-sync \
  --host=192.168.1.101 \        # ä¸»åº“  
  --replicate=percona.checksums \
  --sync-to-master \
  h=192.168.1.100               # ä¿®å¤çš„ä»åº“
```

### 7.4 æ™ºèƒ½åŒ–æ¢å¤ç¼–æ’


**è‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬**ï¼š

```python
#!/usr/bin/env python3
# æ™ºèƒ½æ•…éšœæ¢å¤ç¼–æ’è„šæœ¬

class MHARecoveryOrchestrator:
    def __init__(self):
        self.failed_master = None
        self.current_master = None
        self.recovery_plan = []
    
    def create_recovery_plan(self, failed_host):
        """åˆ›å»ºæ¢å¤è®¡åˆ’"""
        plan = []
        
        # åˆ†ææ•…éšœç±»å‹
        failure_type = self.analyze_failure_type(failed_host)
        
        if failure_type == 'hardware':
            plan.extend([
                'hardware_diagnosis',
                'hardware_repair_or_replace', 
                'system_reinstall',
                'mysql_reinstall',
                'data_sync'
            ])
        elif failure_type == 'software':
            plan.extend([
                'software_diagnosis',
                'mysql_repair',
                'data_consistency_check',
                'rejoin_cluster'
            ])
        
        return plan
    
    def execute_recovery(self):
        """æ‰§è¡Œæ¢å¤æµç¨‹"""
        for step in self.recovery_plan:
            try:
                self.execute_step(step)
                logger.info(f"æ¢å¤æ­¥éª¤å®Œæˆ: {step}")
            except Exception as e:
                logger.error(f"æ¢å¤æ­¥éª¤å¤±è´¥: {step}, é”™è¯¯: {e}")
                self.handle_recovery_failure(step, e)
    
    def execute_step(self, step):
        """æ‰§è¡Œå…·ä½“æ¢å¤æ­¥éª¤"""
        if step == 'data_sync':
            self.perform_data_sync()
        elif step == 'rejoin_cluster':
            self.rejoin_cluster()
        # ... å…¶ä»–æ­¥éª¤çš„å®ç°
```

---

## 8. ğŸ¤– æ™ºèƒ½åŒ–æ”¹è¿›ä¸é£é™©è¯„ä¼°


### 8.1 æœºå™¨å­¦ä¹ ä¼˜åŒ–æ£€æµ‹


**æ™ºèƒ½æ£€æµ‹æ¨¡å‹**ï¼š

```python
# åŸºäºæœºå™¨å­¦ä¹ çš„æ•…éšœé¢„æµ‹æ¨¡å‹
import pandas as pd
from sklearn.ensemble import RandomForestClassifier

class MHAIntelligentDetection:
    def __init__(self):
        self.model = RandomForestClassifier()
        self.features = [
            'cpu_usage',           # CPUä½¿ç”¨ç‡
            'memory_usage',        # å†…å­˜ä½¿ç”¨ç‡  
            'disk_io_wait',        # ç£ç›˜IOç­‰å¾…
            'network_latency',     # ç½‘ç»œå»¶è¿Ÿ
            'mysql_connections',   # MySQLè¿æ¥æ•°
            'slow_queries',        # æ…¢æŸ¥è¯¢æ•°é‡
            'replication_lag',     # å¤åˆ¶å»¶è¿Ÿ
        ]
    
    def collect_metrics(self):
        """æ”¶é›†ç³»ç»ŸæŒ‡æ ‡"""
        metrics = {}
        # æ”¶é›†ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
        metrics['cpu_usage'] = psutil.cpu_percent()
        metrics['memory_usage'] = psutil.virtual_memory().percent
        # ... æ”¶é›†å…¶ä»–æŒ‡æ ‡
        return metrics
    
    def predict_failure_probability(self, metrics):
        """é¢„æµ‹æ•…éšœæ¦‚ç‡"""
        # å°†æŒ‡æ ‡è½¬æ¢ä¸ºç‰¹å¾å‘é‡
        features = [metrics[f] for f in self.features]
        
        # ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹é¢„æµ‹
        probability = self.model.predict_proba([features])[0][1]
        
        return probability
    
    def adaptive_threshold(self, history_data):
        """è‡ªé€‚åº”è°ƒæ•´æ£€æµ‹é˜ˆå€¼"""
        # åŸºäºå†å²æ•°æ®åŠ¨æ€è°ƒæ•´æ£€æµ‹å‚æ•°
        avg_response_time = np.mean(history_data['response_times'])
        std_response_time = np.std(history_data['response_times'])
        
        # åŠ¨æ€é˜ˆå€¼ = å¹³å‡å€¼ + 2å€æ ‡å‡†å·®
        dynamic_threshold = avg_response_time + 2 * std_response_time
        
        return dynamic_threshold
```

### 8.2 é£é™©è¯„ä¼°æ¨¡å‹


**åˆ‡æ¢é£é™©è¯„ä¼°**ï¼š

```python
class FailoverRiskAssessment:
    def __init__(self):
        self.risk_factors = {
            'data_consistency': 0.0,    # æ•°æ®ä¸€è‡´æ€§é£é™©
            'network_stability': 0.0,   # ç½‘ç»œç¨³å®šæ€§é£é™©  
            'slave_health': 0.0,        # ä»åº“å¥åº·åº¦é£é™©
            'business_impact': 0.0,     # ä¸šåŠ¡å½±å“é£é™©
        }
    
    def calculate_risk_score(self):
        """è®¡ç®—åˆ‡æ¢é£é™©è¯„åˆ†"""
        # è¯„ä¼°æ•°æ®ä¸€è‡´æ€§é£é™©
        lag_risk = self.assess_replication_lag()
        
        # è¯„ä¼°ç½‘ç»œç¨³å®šæ€§é£é™©
        network_risk = self.assess_network_stability()
        
        # è¯„ä¼°ä»åº“å¥åº·é£é™©
        slave_risk = self.assess_slave_health()
        
        # è¯„ä¼°ä¸šåŠ¡å½±å“é£é™©
        business_risk = self.assess_business_impact()
        
        # ç»¼åˆé£é™©è¯„åˆ†
        total_risk = (lag_risk * 0.3 + 
                     network_risk * 0.2 + 
                     slave_risk * 0.3 + 
                     business_risk * 0.2)
        
        return total_risk
    
    def make_failover_decision(self, risk_score):
        """åŸºäºé£é™©è¯„åˆ†åšåˆ‡æ¢å†³ç­–"""
        if risk_score < 0.3:
            return "SAFE_TO_FAILOVER"
        elif risk_score < 0.7:
            return "RISKY_BUT_ACCEPTABLE"  
        else:
            return "TOO_RISKY_MANUAL_INTERVENTION"
```

### 8.3 æ™ºèƒ½åˆ‡æ¢å†³ç­–


**å¤šå› ç´ å†³ç­–æ¨¡å‹**ï¼š

```
åˆ‡æ¢å†³ç­–çŸ©é˜µï¼š

                â”‚ ä½é£é™© â”‚ ä¸­é£é™© â”‚ é«˜é£é™© â”‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
    æ•…éšœç¡®å®š     â”‚ ç«‹å³åˆ‡æ¢â”‚ è°¨æ…åˆ‡æ¢â”‚ æ‰‹åŠ¨ä»‹å…¥â”‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤  
    æ•…éšœç–‘ä¼¼     â”‚ å»¶è¿Ÿåˆ‡æ¢â”‚ æ·±åº¦æ£€æµ‹â”‚ æš‚åœåˆ‡æ¢â”‚
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
    å‡é˜³æ€§é«˜     â”‚ æ·±åº¦æ£€æµ‹â”‚ æ‰‹åŠ¨ç¡®è®¤â”‚ ç¦ç”¨è‡ªåŠ¨â”‚
```

**æ™ºèƒ½å†³ç­–å®ç°**ï¼š

```python
def intelligent_failover_decision(failure_confidence, risk_score, business_context):
    """æ™ºèƒ½åˆ‡æ¢å†³ç­–ç®—æ³•"""
    
    # å†³ç­–æƒé‡é…ç½®
    weights = {
        'failure_confidence': 0.4,   # æ•…éšœç¡®ä¿¡åº¦æƒé‡
        'risk_score': 0.3,          # é£é™©è¯„åˆ†æƒé‡  
        'business_priority': 0.3,    # ä¸šåŠ¡ä¼˜å…ˆçº§æƒé‡
    }
    
    # è®¡ç®—å†³ç­–åˆ†æ•°
    decision_score = (
        failure_confidence * weights['failure_confidence'] +
        (1 - risk_score) * weights['risk_score'] +
        business_context['priority'] * weights['business_priority']
    )
    
    # å†³ç­–é€»è¾‘
    if decision_score > 0.8:
        return {
            'action': 'IMMEDIATE_FAILOVER',
            'reason': 'é«˜ç¡®ä¿¡åº¦æ•…éšœï¼Œä½é£é™©ï¼Œå»ºè®®ç«‹å³åˆ‡æ¢'
        }
    elif decision_score > 0.6:
        return {
            'action': 'DELAYED_FAILOVER', 
            'delay': 30,  # å»¶è¿Ÿ30ç§’
            'reason': 'ä¸­ç­‰ç¡®ä¿¡åº¦ï¼Œéœ€è¦é¢å¤–ç¡®è®¤'
        }
    else:
        return {
            'action': 'MANUAL_INTERVENTION',
            'reason': 'é£é™©è¿‡é«˜æˆ–æ•…éšœä¸ç¡®å®šï¼Œéœ€è¦äººå·¥å¹²é¢„'
        }
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•…éšœæ£€æµ‹æœºåˆ¶ï¼šå¤šå±‚æ¬¡å¿ƒè·³æ£€æµ‹ï¼Œé˜²æ­¢è¯¯åˆ¤
ğŸ”¸ åˆ‡æ¢æµç¨‹ï¼šè‡ªåŠ¨åŒ–çš„æ•…éšœåˆ‡æ¢ï¼Œæœ€å°åŒ–åœæœºæ—¶é—´  
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼šç¡®ä¿åˆ‡æ¢è¿‡ç¨‹ä¸­æ•°æ®å®Œæ•´æ€§
ğŸ”¸ æ—¶é—´æ§åˆ¶ï¼šä¼˜åŒ–æ£€æµ‹å’Œåˆ‡æ¢æ—¶é—´ï¼Œæå‡å¯ç”¨æ€§
ğŸ”¸ æ•…éšœæ¢å¤ï¼šæ™ºèƒ½åŒ–çš„æ•…éšœåæ¢å¤æµç¨‹
ğŸ”¸ é£é™©è¯„ä¼°ï¼šåŸºäºå¤šå› ç´ çš„åˆ‡æ¢å†³ç­–æ¨¡å‹
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤šé‡éªŒè¯**ï¼š
```
å•ä¸€æ£€æµ‹çš„é—®é¢˜ï¼š
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´è¯¯åˆ¤
- é«˜è´Ÿè½½å¯¼è‡´å“åº”æ…¢  
- ç»´æŠ¤æ“ä½œå¯¼è‡´å‡æ•…éšœ

å¤šé‡éªŒè¯çš„ä»·å€¼ï¼š
- é™ä½è¯¯åˆ¤ç‡
- æé«˜æ£€æµ‹å‡†ç¡®æ€§
- å‡å°‘ä¸å¿…è¦çš„åˆ‡æ¢
```

**ğŸ”¹ åˆ‡æ¢æ—¶é—´çš„ä¼˜åŒ–å¹³è¡¡**ï¼š
```
å¿«é€Ÿåˆ‡æ¢ vs å‡†ç¡®æ£€æµ‹ï¼š
- è¿‡å¿«ï¼šå®¹æ˜“è¯¯åˆ¤ï¼Œé€ æˆä¸å¿…è¦ä¸­æ–­
- è¿‡æ…¢ï¼šå½±å“ä¸šåŠ¡è¿ç»­æ€§

æœ€ä½³å®è·µï¼š
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´å‚æ•°
- ç›‘æ§åˆ‡æ¢æ€§èƒ½æŒ‡æ ‡
- æŒç»­ä¼˜åŒ–æ£€æµ‹ç®—æ³•
```

**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æ€§**ï¼š
```
ä¸€è‡´æ€§ä¿è¯æªæ–½ï¼š
- åŠåŒæ­¥å¤åˆ¶ï¼šç¡®ä¿æ•°æ®åŒæ­¥
- GTIDæ¨¡å¼ï¼šç²¾ç¡®å®šä½æ•°æ®ä½ç½®
- äº‹åŠ¡è¾¹ç•Œæ§åˆ¶ï¼šä¿è¯äº‹åŠ¡å®Œæ•´æ€§
- å·®å¼‚æ•°æ®æ¢å¤ï¼šè¡¥é½ä¸¢å¤±æ•°æ®
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**éƒ¨ç½²å»ºè®®**ï¼š
- **ç½‘ç»œç¯å¢ƒ**ï¼šç¡®ä¿ç½‘ç»œç¨³å®šï¼Œé…ç½®å¤šè·¯å¾„æ£€æµ‹
- **ç¡¬ä»¶é…ç½®**ï¼šä½¿ç”¨é«˜æ€§èƒ½ç¡¬ä»¶ï¼Œå‡å°‘åˆ‡æ¢æ—¶é—´
- **å‚æ•°è°ƒä¼˜**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´æ£€æµ‹å‚æ•°
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**è¿ç»´è¦ç‚¹**ï¼š
- **å®šæœŸæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œæ•…éšœåˆ‡æ¢æ¼”ç»ƒ
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§åˆ‡æ¢æ—¶é—´å’ŒæˆåŠŸç‡
- **æ–‡æ¡£æ›´æ–°**ï¼šç»´æŠ¤è¯¦ç»†çš„æ“ä½œæ–‡æ¡£
- **å›¢é˜ŸåŸ¹è®­**ï¼šç¡®ä¿å›¢é˜Ÿç†Ÿæ‚‰MHAæ“ä½œ

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**Q1: å¦‚ä½•å‡å°‘è¯¯åˆ‡æ¢ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
âœ… å¯ç”¨äºŒæ¬¡ç¡®è®¤è„šæœ¬
âœ… é…ç½®å¤šé‡éªŒè¯æœºåˆ¶  
âœ… è°ƒæ•´æ£€æµ‹å‚æ•°ï¼Œé¿å…è¿‡äºæ•æ„Ÿ
âœ… ç›‘æ§ç½‘ç»œç¨³å®šæ€§
```

**Q2: åˆ‡æ¢æ—¶é—´è¿‡é•¿æ€ä¹ˆåŠï¼Ÿ**
```
ä¼˜åŒ–æªæ–½ï¼š
âœ… å¹¶è¡Œæ‰§è¡Œåˆ‡æ¢æ“ä½œ
âœ… ä¼˜åŒ–ç½‘ç»œå’Œç¡¬ä»¶é…ç½®
âœ… ç®€åŒ–åˆ‡æ¢è„šæœ¬é€»è¾‘
âœ… ä½¿ç”¨SSDæå‡IOæ€§èƒ½
```

**Q3: å¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ**
```
ä¿æŠ¤æªæ–½ï¼š
âœ… å¯ç”¨åŠåŒæ­¥å¤åˆ¶
âœ… ä½¿ç”¨GTIDæ¨¡å¼
âœ… é…ç½®åˆé€‚çš„è¶…æ—¶å‚æ•°
âœ… å®šæœŸå¤‡ä»½æ•°æ®
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**
> 
> MHAæ•…éšœæ£€æµ‹ä¸åˆ‡æ¢æ˜¯é«˜å¯ç”¨æ¶æ„çš„æ ¸å¿ƒï¼Œé€šè¿‡å¤šé‡éªŒè¯é¿å…è¯¯åˆ¤ï¼Œæ™ºèƒ½ç®—æ³•ä¼˜åŒ–åˆ‡æ¢æµç¨‹ï¼Œæ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶ç¡®ä¿æ•°æ®å®‰å…¨ï¼Œæœ€ç»ˆå®ç°ç§’çº§çš„è‡ªåŠ¨æ•…éšœåˆ‡æ¢ï¼Œå¤§å¤§æå‡MySQLé›†ç¾¤çš„å¯ç”¨æ€§ã€‚

**æœ€ä½³å®è·µå£è¯€**ï¼š
- æ£€æµ‹è¦å‡†ç¡®ï¼Œå¤šé‡éªŒè¯ä¸å¯å°‘
- åˆ‡æ¢è¦å¿«é€Ÿï¼Œå¹¶è¡Œä¼˜åŒ–æ˜¯å…³é”®  
- æ•°æ®è¦ä¸€è‡´ï¼ŒGTIDåŠåŒæ­¥ä¿å®‰å…¨
- æ¢å¤è¦æ™ºèƒ½ï¼Œè‡ªåŠ¨ç¼–æ’å‡äººå·¥