---
title: 6ã€MHAè„šæœ¬å¼€å‘ä¸å®šåˆ¶
---
## ğŸ“š ç›®å½•

1. [MHAè„šæœ¬ä½“ç³»æ¦‚è¿°](#1-MHAè„šæœ¬ä½“ç³»æ¦‚è¿°)
2. [master_ip_failoverè„šæœ¬å®šåˆ¶](#2-master_ip_failoverè„šæœ¬å®šåˆ¶)
3. [send_reportè„šæœ¬å¼€å‘](#3-send_reportè„šæœ¬å¼€å‘)
4. [power_managerè„šæœ¬é…ç½®](#4-power_managerè„šæœ¬é…ç½®)
5. [è‡ªå®šä¹‰åˆ‡æ¢é€»è¾‘å®ç°](#5-è‡ªå®šä¹‰åˆ‡æ¢é€»è¾‘å®ç°)
6. [è„šæœ¬è°ƒè¯•ä¸é”™è¯¯å¤„ç†](#6-è„šæœ¬è°ƒè¯•ä¸é”™è¯¯å¤„ç†)
7. [è„šæœ¬å®‰å…¨æ§åˆ¶æœºåˆ¶](#7-è„šæœ¬å®‰å…¨æ§åˆ¶æœºåˆ¶)
8. [è„šæœ¬è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µ](#8-è„šæœ¬è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ MHAè„šæœ¬ä½“ç³»æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHAè„šæœ¬ä½“ç³»


MHAï¼ˆMaster High Availabilityï¼‰æœ¬èº«åªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘éƒ½éœ€è¦é€šè¿‡**è‡ªå®šä¹‰è„šæœ¬**æ¥å®ç°ã€‚å°±åƒæ­ç§¯æœ¨ä¸€æ ·ï¼ŒMHAæä¾›äº†åŸºç¡€æ¡†æ¶ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™è„šæœ¬æ¥å‘Šè¯‰å®ƒå…·ä½“æ€ä¹ˆåšã€‚

**ğŸ”¸ æ ¸å¿ƒè„šæœ¬ç±»å‹**
```
æ•…éšœåˆ‡æ¢ç›¸å…³ï¼š
â”œâ”€â”€ master_ip_failover    â† å¤„ç†IPåˆ‡æ¢çš„æ ¸å¿ƒè„šæœ¬
â”œâ”€â”€ master_ip_online      â† ä¸»åº“ä¸Šçº¿æ—¶çš„IPå¤„ç†
â””â”€â”€ shutdown_script       â† ä¸»åº“å…³é—­å‰çš„æ¸…ç†å·¥ä½œ

é€šçŸ¥æŠ¥å‘Šç›¸å…³ï¼š
â”œâ”€â”€ send_report          â† å‘é€æ•…éšœæŠ¥å‘Šå’Œé€šçŸ¥
â””â”€â”€ secondary_check      â† è¾…åŠ©æ£€æŸ¥ä¸»åº“çŠ¶æ€

ç”µæºç®¡ç†ç›¸å…³ï¼š
â””â”€â”€ power_manager        â† æ§åˆ¶æœåŠ¡å™¨ç”µæºçŠ¶æ€
```

### 1.2 è„šæœ¬åœ¨MHAä¸­çš„ä½œç”¨


**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**ï¼šMHAè„šæœ¬å°±åƒç«ç¾æ—¶çš„åº”æ€¥é¢„æ¡ˆ
- MHAæ¡†æ¶ = ç«è­¦ç³»ç»Ÿï¼ˆæ£€æµ‹ç«ç¾ï¼‰
- è„šæœ¬ = åº”æ€¥é¢„æ¡ˆï¼ˆå‘Šè¯‰å¤§å®¶å…·ä½“æ€ä¹ˆé€ƒç”Ÿã€æ€ä¹ˆç­ç«ï¼‰

```
æ•…éšœå‘ç”Ÿæµç¨‹ï¼š
æ£€æµ‹æ•…éšœ â†’ æ‰§è¡Œsecondary_check â†’ ç¡®è®¤æ•…éšœ â†’ æ‰§è¡Œmaster_ip_failover â†’ 
æ•°æ®æ¢å¤ â†’ åˆ‡æ¢å®Œæˆ â†’ æ‰§è¡Œsend_report â†’ å‘é€é€šçŸ¥
```

### 1.3 è„šæœ¬å¼€å‘çš„é‡è¦æ€§


> **ğŸ’¡ ä¸ºä»€ä¹ˆå¿…é¡»è‡ªå®šä¹‰è„šæœ¬ï¼Ÿ**  
> MHAåªè´Ÿè´£æ•°æ®æ¢å¤å’Œåˆ‡æ¢é€»è¾‘ï¼Œä½†ä¸çŸ¥é“ä½ çš„å…·ä½“ç¯å¢ƒï¼š
> - ä½ ç”¨çš„æ˜¯VIPè¿˜æ˜¯åŸŸåï¼Ÿ
> - å‡ºæ•…éšœåè¦é€šçŸ¥è°ï¼Ÿ
> - è¦ä¸è¦å¼ºåˆ¶å…³é—­æ•…éšœæœåŠ¡å™¨ï¼Ÿ
> 
> è¿™äº›éƒ½éœ€è¦é€šè¿‡è„šæœ¬æ¥å‘Šè¯‰MHA

---

## 2. ğŸ”§ master_ip_failoverè„šæœ¬å®šåˆ¶


### 2.1 è„šæœ¬çš„æ ¸å¿ƒä½œç”¨


`master_ip_failover`æ˜¯MHAä¸­**æœ€é‡è¦çš„è„šæœ¬**ï¼Œè´Ÿè´£åœ¨æ•…éšœåˆ‡æ¢æ—¶å¤„ç†IPåœ°å€çš„è¿ç§»ã€‚

**ğŸ”¸ ä¸»è¦åŠŸèƒ½**
- **IPæ‘˜é™¤**ï¼šä»æ•…éšœçš„ä¸»åº“ä¸Šæ‘˜æ‰VIP
- **IPè¿ç§»**ï¼šå°†VIPç»‘å®šåˆ°æ–°çš„ä¸»åº“ä¸Š
- **çŠ¶æ€æ£€æŸ¥**ï¼šç¡®è®¤IPåˆ‡æ¢æ˜¯å¦æˆåŠŸ

### 2.2 è„šæœ¬æ‰§è¡Œæ—¶æœº


```
MHAåˆ‡æ¢æµç¨‹ä¸­çš„ä½ç½®ï¼š
æ•°æ®æ¢å¤å®Œæˆ â†’ æ‰§è¡Œmaster_ip_failoverè„šæœ¬ â†’ IPåˆ‡æ¢å®Œæˆ â†’ åº”ç”¨å¯æ­£å¸¸è®¿é—®
```

### 2.3 åŸºç¡€è„šæœ¬æ¡†æ¶


```bash
#!/usr/bin/env perl
use strict;
use warnings FATAL => 'all';
use Getopt::Long;

# ğŸ”¸ é…ç½®å‚æ•°
my $vip = '192.168.1.100';           # è™šæ‹ŸIPåœ°å€
my $interface = 'eth0';              # ç½‘å¡æ¥å£
my $ssh_user = 'root';               # SSHç”¨æˆ·

# ğŸ”¸ å‘½ä»¤è¡Œå‚æ•°è§£æ
my ($command, $orig_master_host, $new_master_host);
GetOptions(
    'command=s'          => \$command,
    'orig_master_host=s' => \$orig_master_host,
    'new_master_host=s'  => \$new_master_host,
);

# ğŸ”¸ ä¸»è¦é€»è¾‘
if ($command eq "stop") {
    # ä»åŸä¸»åº“æ‘˜é™¤VIP
    remove_vip($orig_master_host);
} elsif ($command eq "start") {
    # åœ¨æ–°ä¸»åº“æ·»åŠ VIP
    add_vip($new_master_host);
}

exit 0;
```

### 2.4 VIPæ“ä½œå‡½æ•°å®ç°


**ğŸ”¸ æ·»åŠ VIPå‡½æ•°**
```bash
sub add_vip {
    my $host = shift;
    
    # ğŸ”¹ æ„å»ºæ·»åŠ VIPçš„å‘½ä»¤
    my $cmd = "ssh $ssh_user\@$host " .
              "'/sbin/ifconfig $interface:1 $vip/24'";
    
    print "æ­£åœ¨æ–°ä¸»åº“ $host ä¸Šæ·»åŠ VIP $vip...\n";
    
    # ğŸ”¹ æ‰§è¡Œå‘½ä»¤å¹¶æ£€æŸ¥ç»“æœ
    my $result = system($cmd);
    if ($result != 0) {
        print "é”™è¯¯ï¼šVIPæ·»åŠ å¤±è´¥ï¼\n";
        exit 1;
    }
    
    print "VIPæ·»åŠ æˆåŠŸï¼\n";
}
```

**ğŸ”¸ ç§»é™¤VIPå‡½æ•°**
```bash
sub remove_vip {
    my $host = shift;
    
    # ğŸ”¹ æ„å»ºç§»é™¤VIPçš„å‘½ä»¤
    my $cmd = "ssh $ssh_user\@$host " .
              "'/sbin/ifconfig $interface:1 down'";
    
    print "æ­£åœ¨åŸä¸»åº“ $host ä¸Šç§»é™¤VIP $vip...\n";
    
    my $result = system($cmd);
    if ($result != 0) {
        print "è­¦å‘Šï¼šVIPç§»é™¤å¤±è´¥ï¼Œå¯èƒ½åŸä¸»åº“å·²ç»å®•æœº\n";
        # æ³¨æ„ï¼šè¿™é‡Œä¸exitï¼Œå› ä¸ºåŸä¸»åº“å¯èƒ½å·²ç»å®•æœº
    } else {
        print "VIPç§»é™¤æˆåŠŸï¼\n";
    }
}
```

### 2.5 è„šæœ¬é…ç½®ä¸æµ‹è¯•


**ğŸ”¸ é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®**
```ini
# /etc/mha/app1.cnf
[server default]
master_ip_failover_script=/usr/local/bin/master_ip_failover
```

**ğŸ”¸ æµ‹è¯•è„šæœ¬**
```bash
# ğŸŸ¢ æµ‹è¯•ç§»é™¤VIP
./master_ip_failover --command=stop --orig_master_host=192.168.1.10

# ğŸŸ¢ æµ‹è¯•æ·»åŠ VIP  
./master_ip_failover --command=start --new_master_host=192.168.1.11
```

---

## 3. ğŸ“§ send_reportè„šæœ¬å¼€å‘


### 3.1 è„šæœ¬åŠŸèƒ½è¯´æ˜


`send_report`è„šæœ¬è´Ÿè´£åœ¨MHAåˆ‡æ¢å®Œæˆå**å‘é€é€šçŸ¥æŠ¥å‘Š**ï¼Œè®©ç›¸å…³äººå‘˜åŠæ—¶äº†è§£æ•…éšœæƒ…å†µã€‚

**ğŸ”¸ ä¸»è¦ç”¨é€”**
- å‘é€æ•…éšœåˆ‡æ¢å®Œæˆé€šçŸ¥
- è®°å½•åˆ‡æ¢è¿‡ç¨‹å’Œç»“æœ
- é€šçŸ¥ç›¸å…³äººå‘˜è¿›è¡Œåç»­å¤„ç†

### 3.2 é€šçŸ¥æ–¹å¼é€‰æ‹©


```
å¸¸ç”¨é€šçŸ¥æ–¹å¼ï¼š
ğŸ“§ é‚®ä»¶é€šçŸ¥     â† è¯¦ç»†ä¿¡æ¯ï¼Œé€‚åˆæŠ€æœ¯äººå‘˜
ğŸ“± çŸ­ä¿¡é€šçŸ¥     â† ç´§æ€¥å‘Šè­¦ï¼Œé€‚åˆç®¡ç†äººå‘˜  
ğŸ”” ä¼ä¸šå¾®ä¿¡     â† ç¾¤ç»„é€šçŸ¥ï¼Œé€‚åˆå›¢é˜Ÿåä½œ
ğŸ“ ç”µè¯å‘Šè­¦     â† ä¸¥é‡æ•…éšœï¼Œé€‚åˆ7x24å€¼ç­
```

### 3.3 é‚®ä»¶é€šçŸ¥è„šæœ¬ç¤ºä¾‹


```bash
#!/usr/bin/env perl
use strict;
use warnings;
use MIME::Lite;

# ğŸ”¸ é‚®ä»¶é…ç½®
my $smtp_server = 'smtp.company.com';
my $from_email = 'mha-alert@company.com';
my @to_emails = ('dba@company.com', 'ops@company.com');

# ğŸ”¸ è·å–åˆ‡æ¢ä¿¡æ¯
my $subject = "MHAåˆ‡æ¢å®Œæˆé€šçŸ¥ - " . localtime();
my $body = build_report_body();

# ğŸ”¸ å‘é€é‚®ä»¶
sub send_email {
    my $msg = MIME::Lite->new(
        From     => $from_email,
        To       => join(',', @to_emails),
        Subject  => $subject,
        Data     => $body,
    );
    
    $msg->send('smtp', $smtp_server);
    print "é€šçŸ¥é‚®ä»¶å‘é€æˆåŠŸ\n";
}

# ğŸ”¸ æ„å»ºæŠ¥å‘Šå†…å®¹
sub build_report_body {
    my $report = <<EOF;
å°Šæ•¬çš„è¿ç»´å›¢é˜Ÿï¼š

MySQLä¸»ä»åˆ‡æ¢å·²å®Œæˆï¼Œè¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼š

åˆ‡æ¢æ—¶é—´ï¼š@{[localtime()]}
åŸä¸»åº“ï¼š$ARGV[2] (æ•…éšœ)
æ–°ä¸»åº“ï¼š$ARGV[4] (å·²æ¿€æ´»)
åˆ‡æ¢åŸå› ï¼šä¸»åº“æ•…éšœæ£€æµ‹

è¯·åŠæ—¶ï¼š
1. æ£€æŸ¥æ–°ä¸»åº“è¿è¡ŒçŠ¶æ€
2. ä¿®å¤æ•…éšœä¸»åº“
3. æ›´æ–°åº”ç”¨é…ç½®ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

æ­¤é‚®ä»¶ç”±MHAè‡ªåŠ¨å‘é€ã€‚
EOF
    return $report;
}

send_email();
```

### 3.4 ä¼ä¸šå¾®ä¿¡é€šçŸ¥å®ç°


```bash
#!/bin/bash

# ğŸ”¸ ä¼ä¸šå¾®ä¿¡æœºå™¨äººé…ç½®
WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"

# ğŸ”¸ æ„å»ºæ¶ˆæ¯å†…å®¹
build_wechat_message() {
    cat <<EOF
{
    "msgtype": "markdown",
    "markdown": {
        "content": "### ğŸš¨ MySQLåˆ‡æ¢å®Œæˆé€šçŸ¥
        
**åˆ‡æ¢æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**åŸä¸»åº“**: $2 âŒ
**æ–°ä¸»åº“**: $4 âœ…
**çŠ¶æ€**: åˆ‡æ¢æˆåŠŸ

è¯·ç›¸å…³äººå‘˜åŠæ—¶è·Ÿè¿›å¤„ç†ã€‚"
    }
}
EOF
}

# ğŸ”¸ å‘é€é€šçŸ¥
send_wechat_notification() {
    curl -X POST \
         -H 'Content-Type: application/json' \
         -d "$(build_wechat_message)" \
         "$WEBHOOK_URL"
}

send_wechat_notification
echo "ä¼ä¸šå¾®ä¿¡é€šçŸ¥å‘é€å®Œæˆ"
```

---

## 4. âš¡ power_managerè„šæœ¬é…ç½®


### 4.1 ç”µæºç®¡ç†çš„å¿…è¦æ€§


**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦ç”µæºç®¡ç†ï¼Ÿ**

å½“MySQLä¸»åº“å‘ç”Ÿæ•…éšœæ—¶ï¼Œæœ‰æ—¶éœ€è¦**å¼ºåˆ¶å…³é—­æ•…éšœæœåŠ¡å™¨**ï¼Œé¿å…"è„‘è£‚"é—®é¢˜ã€‚

**ğŸŒ° åœºæ™¯ä¸¾ä¾‹**ï¼š
```
ç½‘ç»œæ•…éšœå¯¼è‡´ä¸»åº“"å‡æ­»"ï¼š
- MHAè®¤ä¸ºä¸»åº“å®•æœºï¼Œåˆ‡æ¢åˆ°å¤‡åº“
- ä½†ä¸»åº“å®é™…è¿˜åœ¨è¿è¡Œï¼Œåªæ˜¯ç½‘ç»œä¸é€š
- å¦‚æœä¸»åº“æ¢å¤ç½‘ç»œï¼Œå°±ä¼šå‡ºç°ä¸¤ä¸ªä¸»åº“
- è¿™å°±æ˜¯"è„‘è£‚"ï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
```

### 4.2 STONITHæœºåˆ¶


**ğŸ”¸ STONITHå«ä¹‰**
STONITH = **S**hoot **T**he **O**ther **N**ode **I**n **T**he **H**ead
ç¿»è¯‘è¿‡æ¥å°±æ˜¯"çˆ†å¤´"ï¼Œæ„æ€æ˜¯å¼ºåˆ¶å…³é—­æ•…éšœèŠ‚ç‚¹ã€‚

### 4.3 IPMIç”µæºç®¡ç†è„šæœ¬


```bash
#!/bin/bash

# ğŸ”¸ IPMIé…ç½®ä¿¡æ¯
IPMI_USER="admin"
IPMI_PASS="password"

# ğŸ”¸ è·å–ç›®æ ‡ä¸»æœºIP
TARGET_HOST=$1
COMMAND=$2

# ğŸ”¸ ç”µæºæ§åˆ¶å‡½æ•°
power_control() {
    local host=$1
    local action=$2
    
    echo "æ­£åœ¨å¯¹æœåŠ¡å™¨ $host æ‰§è¡Œ $action æ“ä½œ..."
    
    # ğŸ”¹ ä½¿ç”¨IPMIå·¥å…·æ§åˆ¶ç”µæº
    ipmitool -I lanplus \
             -H "${host}-ipmi" \
             -U "$IPMI_USER" \
             -P "$IPMI_PASS" \
             chassis power $action
    
    if [ $? -eq 0 ]; then
        echo "ç”µæºæ“ä½œæˆåŠŸï¼š$host $action"
        return 0
    else
        echo "ç”µæºæ“ä½œå¤±è´¥ï¼š$host $action"
        return 1
    fi
}

# ğŸ”¸ ä¸»é€»è¾‘
case "$COMMAND" in
    "off")
        power_control "$TARGET_HOST" "off"
        ;;
    "on")
        power_control "$TARGET_HOST" "on"
        ;;
    "status")
        power_control "$TARGET_HOST" "status"
        ;;
    *)
        echo "ç”¨æ³•: $0 <ä¸»æœºIP> <off|on|status>"
        exit 1
        ;;
esac
```

### 4.4 å®‰å…¨è€ƒè™‘


> **âš ï¸ é‡è¦è­¦å‘Š**  
> ç”µæºç®¡ç†è„šæœ¬éå¸¸å±é™©ï¼Œä½¿ç”¨ä¸å½“å¯èƒ½å¯¼è‡´ï¼š
> - è¯¯å…³é—­æ­£å¸¸æœåŠ¡å™¨
> - æ•°æ®ä¸¢å¤±
> - æœåŠ¡é•¿æ—¶é—´ä¸­æ–­

**ğŸ”¸ å®‰å…¨æªæ–½**
```bash
# ğŸ”¹ æ·»åŠ ç¡®è®¤æœºåˆ¶
confirm_shutdown() {
    echo "è­¦å‘Šï¼šå³å°†å¼ºåˆ¶å…³é—­æœåŠ¡å™¨ $1"
    echo "è¯·åœ¨10ç§’å†…æŒ‰Ctrl+Cå–æ¶ˆ..."
    sleep 10
}

# ğŸ”¹ è®°å½•æ“ä½œæ—¥å¿—
log_operation() {
    echo "$(date): æ‰§è¡Œç”µæºæ“ä½œ $1 on $2" >> /var/log/mha/power.log
}
```

---

## 5. ğŸ”€ è‡ªå®šä¹‰åˆ‡æ¢é€»è¾‘å®ç°


### 5.1 æ ‡å‡†åˆ‡æ¢ vs è‡ªå®šä¹‰åˆ‡æ¢


**ğŸ”¸ æ ‡å‡†MHAåˆ‡æ¢æµç¨‹**
```
æ£€æµ‹æ•…éšœ â†’ é€‰æ‹©æ–°ä¸»åº“ â†’ æ•°æ®æ¢å¤ â†’ åˆ‡æ¢å®Œæˆ
```

**ğŸ”¸ è‡ªå®šä¹‰åˆ‡æ¢éœ€æ±‚**
```
å®é™…ä¸šåŠ¡å¯èƒ½éœ€è¦ï¼š
- ç‰¹æ®Šçš„ä¸»åº“é€‰æ‹©é€»è¾‘
- åº”ç”¨è¿æ¥æ± çš„æ›´æ–°
- è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®ä¿®æ”¹
- ç¼“å­˜æ•°æ®çš„æ¸…ç†
- ä¸šåŠ¡æµé‡çš„åˆ‡æ¢
```

### 5.2 ä¸»åº“é€‰æ‹©é€»è¾‘å®šåˆ¶


```bash
#!/bin/bash

# ğŸ”¸ è‡ªå®šä¹‰ä¸»åº“é€‰æ‹©å‡½æ•°
select_new_master() {
    local candidates="$1"
    
    echo "å¼€å§‹è‡ªå®šä¹‰ä¸»åº“é€‰æ‹©é€»è¾‘..."
    
    # ğŸ”¹ ä¼˜å…ˆçº§è§„åˆ™
    for candidate in $candidates; do
        # è§„åˆ™1ï¼šæ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½ç­‰çº§
        local server_class=$(get_server_class $candidate)
        
        # è§„åˆ™2ï¼šæ£€æŸ¥æ•°æ®ä¸­å¿ƒä½ç½®
        local datacenter=$(get_datacenter $candidate)
        
        # è§„åˆ™3ï¼šæ£€æŸ¥å½“å‰è´Ÿè½½
        local load=$(get_server_load $candidate)
        
        # ğŸ”¹ è¯„åˆ†æœºåˆ¶
        local score=0
        [ "$server_class" = "high" ] && score=$((score + 10))
        [ "$datacenter" = "primary" ] && score=$((score + 5))
        [ "$load" -lt 50 ] && score=$((score + 3))
        
        echo "å€™é€‰æœåŠ¡å™¨ $candidate è¯„åˆ†: $score"
        
        # ğŸ”¹ é€‰æ‹©æœ€é«˜åˆ†çš„æœåŠ¡å™¨
        if [ $score -gt $best_score ]; then
            best_candidate=$candidate
            best_score=$score
        fi
    done
    
    echo "é€‰æ‹©æ–°ä¸»åº“: $best_candidate (è¯„åˆ†: $best_score)"
    return $best_candidate
}
```

### 5.3 åº”ç”¨å±‚åˆ‡æ¢é…ç½®


```bash
# ğŸ”¸ æ›´æ–°åº”ç”¨é…ç½®æ–‡ä»¶
update_app_config() {
    local new_master=$1
    
    echo "æ›´æ–°åº”ç”¨é…ç½®æ–‡ä»¶..."
    
    # ğŸ”¹ æ›´æ–°æ•°æ®åº“è¿æ¥é…ç½®
    sed -i "s/db.host=.*/db.host=$new_master/" /app/config/database.properties
    
    # ğŸ”¹ é‡å¯åº”ç”¨æœåŠ¡
    systemctl restart app-service
    
    # ğŸ”¹ éªŒè¯è¿æ¥
    if check_app_connection; then
        echo "åº”ç”¨é…ç½®æ›´æ–°æˆåŠŸ"
    else
        echo "åº”ç”¨é…ç½®æ›´æ–°å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
        exit 1
    fi
}
```

### 5.4 è´Ÿè½½å‡è¡¡å™¨æ›´æ–°


```bash
# ğŸ”¸ æ›´æ–°Nginxé…ç½®
update_nginx_config() {
    local new_master=$1
    
    # ğŸ”¹ ç”Ÿæˆæ–°çš„upstreamé…ç½®
    cat > /etc/nginx/upstream.conf <<EOF
upstream mysql_master {
    server $new_master:3306 weight=1 max_fails=2 fail_timeout=30s;
}
EOF
    
    # ğŸ”¹ æµ‹è¯•é…ç½®å¹¶é‡æ–°åŠ è½½
    nginx -t && nginx -s reload
    
    echo "Nginxé…ç½®æ›´æ–°å®Œæˆ"
}
```

---

## 6. ğŸ” è„šæœ¬è°ƒè¯•ä¸é”™è¯¯å¤„ç†


### 6.1 è°ƒè¯•æŠ€æœ¯


**ğŸ”¸ æ—¥å¿—è®°å½•æœºåˆ¶**
```bash
# ğŸ”¹ è®¾ç½®æ—¥å¿—å‡½æ•°
log_message() {
    local level=$1
    local message=$2
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$level] $message" | tee -a $LOG_FILE
}

# ğŸ”¹ ä½¿ç”¨ç¤ºä¾‹
log_message "INFO" "å¼€å§‹æ‰§è¡ŒIPåˆ‡æ¢"
log_message "ERROR" "VIPæ·»åŠ å¤±è´¥: $error_msg"
log_message "SUCCESS" "åˆ‡æ¢å®Œæˆ"
```

**ğŸ”¸ è°ƒè¯•æ¨¡å¼**
```bash
# ğŸ”¹ æ·»åŠ è°ƒè¯•å¼€å…³
DEBUG=${DEBUG:-0}

debug_print() {
    [ "$DEBUG" = "1" ] && echo "DEBUG: $*"
}

# ğŸ”¹ ä½¿ç”¨æ–¹å¼
DEBUG=1 ./master_ip_failover --command=start --new_master_host=192.168.1.11
```

### 6.2 é”™è¯¯å¤„ç†æœºåˆ¶


**ğŸ”¸ å¼‚å¸¸æ•è·**
```bash
# ğŸ”¹ å‡½æ•°æ‰§è¡Œç»“æœæ£€æŸ¥
execute_with_check() {
    local cmd="$1"
    local description="$2"
    
    echo "æ‰§è¡Œ: $description"
    
    if eval "$cmd"; then
        log_message "SUCCESS" "$description æˆåŠŸ"
        return 0
    else
        log_message "ERROR" "$description å¤±è´¥"
        return 1
    fi
}

# ğŸ”¹ ä½¿ç”¨ç¤ºä¾‹
execute_with_check "ssh root@$host 'ifconfig eth0:1 192.168.1.100/24'" "æ·»åŠ VIP"
```

**ğŸ”¸ å›æ»šæœºåˆ¶**
```bash
# ğŸ”¹ æ“ä½œå›æ»šå‡½æ•°
rollback_operations() {
    echo "æ£€æµ‹åˆ°é”™è¯¯ï¼Œå¼€å§‹å›æ»šæ“ä½œ..."
    
    # ç§»é™¤å·²æ·»åŠ çš„VIP
    [ -n "$vip_added" ] && remove_vip "$new_master_host"
    
    # æ¢å¤åŸé…ç½®
    [ -f "$config_backup" ] && cp "$config_backup" "$config_file"
    
    echo "å›æ»šæ“ä½œå®Œæˆ"
}

# ğŸ”¹ é”™è¯¯æ—¶è‡ªåŠ¨å›æ»š
trap rollback_operations ERR
```

### 6.3 è„šæœ¬æµ‹è¯•ç­–ç•¥


**ğŸ”¸ å•å…ƒæµ‹è¯•**
```bash
# ğŸ”¹ æµ‹è¯•VIPåŠŸèƒ½
test_vip_operations() {
    echo "æµ‹è¯•VIPæ“ä½œ..."
    
    # æµ‹è¯•æ·»åŠ VIP
    if add_vip "192.168.1.11"; then
        echo "âœ… VIPæ·»åŠ æµ‹è¯•é€šè¿‡"
    else
        echo "âŒ VIPæ·»åŠ æµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    # æµ‹è¯•ç§»é™¤VIP
    if remove_vip "192.168.1.11"; then
        echo "âœ… VIPç§»é™¤æµ‹è¯•é€šè¿‡"
    else
        echo "âŒ VIPç§»é™¤æµ‹è¯•å¤±è´¥"
        return 1
    fi
}
```

**ğŸ”¸ é›†æˆæµ‹è¯•**
```bash
# ğŸ”¹ æ¨¡æ‹Ÿå®Œæ•´åˆ‡æ¢æµç¨‹
test_full_failover() {
    echo "å¼€å§‹å®Œæ•´åˆ‡æ¢æµ‹è¯•..."
    
    # 1. æ¨¡æ‹ŸåŸä¸»åº“æ•…éšœ
    simulate_master_failure "192.168.1.10"
    
    # 2. æ‰§è¡Œåˆ‡æ¢è„šæœ¬
    ./master_ip_failover --command=stop --orig_master_host=192.168.1.10
    ./master_ip_failover --command=start --new_master_host=192.168.1.11
    
    # 3. éªŒè¯ç»“æœ
    verify_failover_result "192.168.1.11"
}
```

---

## 7. ğŸ›¡ï¸ è„šæœ¬å®‰å…¨æ§åˆ¶æœºåˆ¶


### 7.1 æƒé™æ§åˆ¶


**ğŸ”¸ è„šæœ¬æ–‡ä»¶æƒé™**
```bash
# ğŸ”¹ è®¾ç½®å®‰å…¨æƒé™
chmod 750 /usr/local/bin/master_ip_failover    # åªæœ‰ownerå’Œç»„å¯ä»¥æ‰§è¡Œ
chown mha:mha /usr/local/bin/master_ip_failover # è®¾ç½®åˆé€‚çš„æ‰€æœ‰è€…
```

**ğŸ”¸ SSHå¯†é’¥ç®¡ç†**
```bash
# ğŸ”¹ ä¸ºMHAç”¨æˆ·ç”Ÿæˆä¸“ç”¨å¯†é’¥
ssh-keygen -t rsa -b 2048 -f /home/mha/.ssh/mha_key -N ""

# ğŸ”¹ é…ç½®authorized_keysé™åˆ¶
# åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šè®¾ç½®ï¼š
echo 'command="/usr/local/bin/vip_control.sh",no-port-forwarding,no-X11-forwarding ssh-rsa AAAAB3...' >> ~/.ssh/authorized_keys
```

### 7.2 è¾“å…¥éªŒè¯


**ğŸ”¸ å‚æ•°éªŒè¯**
```bash
# ğŸ”¹ IPåœ°å€æ ¼å¼éªŒè¯
validate_ip() {
    local ip=$1
    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        return 0
    else
        echo "é”™è¯¯ï¼šæ— æ•ˆçš„IPåœ°å€æ ¼å¼: $ip"
        return 1
    fi
}

# ğŸ”¹ ä¸»æœºåéªŒè¯
validate_hostname() {
    local host=$1
    if [[ $host =~ ^[a-zA-Z0-9.-]+$ ]] && [ ${#host} -le 253 ]; then
        return 0
    else
        echo "é”™è¯¯ï¼šæ— æ•ˆçš„ä¸»æœºåæ ¼å¼: $host"
        return 1
    fi
}
```

**ğŸ”¸ å‘½ä»¤æ³¨å…¥é˜²æŠ¤**
```bash
# ğŸ”¹ å®‰å…¨çš„å‘½ä»¤æ‰§è¡Œ
safe_execute() {
    local host=$1
    local cmd=$2
    
    # éªŒè¯ä¸»æœºå
    validate_hostname "$host" || return 1
    
    # ä½¿ç”¨å‚æ•°åŒ–å‘½ä»¤ï¼Œé¿å…æ³¨å…¥
    ssh -o "StrictHostKeyChecking=no" \
        -o "ConnectTimeout=10" \
        "mha@$host" \
        "$cmd"
}
```

### 7.3 å®¡è®¡æ—¥å¿—


**ğŸ”¸ æ“ä½œå®¡è®¡**
```bash
# ğŸ”¹ è®°å½•æ‰€æœ‰æ“ä½œ
audit_log() {
    local operation=$1
    local target=$2
    local result=$3
    local user=$(whoami)
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "$timestamp $user $operation $target $result" >> /var/log/mha/audit.log
}

# ğŸ”¹ ä½¿ç”¨ç¤ºä¾‹
audit_log "VIP_ADD" "192.168.1.11" "SUCCESS"
audit_log "VIP_REMOVE" "192.168.1.10" "FAILED"
```

---

## 8. ğŸ“ è„šæœ¬è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µ


### 8.1 å¹‚ç­‰æ€§è®¾è®¡åŸåˆ™


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ**

å¹‚ç­‰æ€§æ„æ€æ˜¯**é‡å¤æ‰§è¡Œç›¸åŒæ“ä½œï¼Œç»“æœåº”è¯¥ä¸€æ ·**ã€‚

**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**ï¼š
- å¼€ç¯å¼€å…³ï¼šæ— è®ºæŒ‰å¤šå°‘æ¬¡"å¼€"ï¼Œç¯éƒ½æ˜¯äº®çš„çŠ¶æ€
- é“¶è¡Œè½¬è´¦ï¼šåŒä¸€ç¬”è½¬è´¦æ“ä½œï¼Œæ— è®ºé‡è¯•å¤šå°‘æ¬¡ï¼Œåªè½¬ä¸€æ¬¡é’±

**ğŸ”¸ VIPæ“ä½œçš„å¹‚ç­‰æ€§å®ç°**
```bash
# ğŸ”¹ å¹‚ç­‰çš„VIPæ·»åŠ 
add_vip_idempotent() {
    local host=$1
    local vip=$2
    
    # æ£€æŸ¥VIPæ˜¯å¦å·²å­˜åœ¨
    if check_vip_exists "$host" "$vip"; then
        echo "VIP $vip å·²å­˜åœ¨äº $hostï¼Œæ— éœ€é‡å¤æ·»åŠ "
        return 0
    fi
    
    # æ·»åŠ VIP
    echo "åœ¨ $host ä¸Šæ·»åŠ VIP $vip"
    ssh "root@$host" "/sbin/ifconfig eth0:1 $vip/24"
    
    # éªŒè¯ç»“æœ
    if check_vip_exists "$host" "$vip"; then
        echo "VIPæ·»åŠ æˆåŠŸ"
        return 0
    else
        echo "VIPæ·»åŠ å¤±è´¥"
        return 1
    fi
}

# ğŸ”¹ æ£€æŸ¥VIPæ˜¯å¦å­˜åœ¨
check_vip_exists() {
    local host=$1
    local vip=$2
    
    ssh "root@$host" "/sbin/ifconfig" | grep -q "$vip"
}
```

### 8.2 è¶…æ—¶æ§åˆ¶æœºåˆ¶


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶ï¼Ÿ**

ç½‘ç»œæ•…éšœæ—¶ï¼ŒSSHè¿æ¥å¯èƒ½é•¿æ—¶é—´hangä½ï¼Œå½±å“MHAåˆ‡æ¢é€Ÿåº¦ã€‚

```bash
# ğŸ”¹ è®¾ç½®è¶…æ—¶çš„SSHæ“ä½œ
execute_with_timeout() {
    local host=$1
    local cmd=$2
    local timeout=${3:-30}  # é»˜è®¤30ç§’è¶…æ—¶
    
    echo "æ‰§è¡Œå‘½ä»¤ï¼ˆ$timeoutç§’è¶…æ—¶ï¼‰: $cmd"
    
    # ä½¿ç”¨timeoutå‘½ä»¤é™åˆ¶æ‰§è¡Œæ—¶é—´
    timeout "$timeout" ssh -o "ConnectTimeout=10" \
                           -o "StrictHostKeyChecking=no" \
                           "root@$host" \
                           "$cmd"
    
    local exit_code=$?
    
    case $exit_code in
        0)
            echo "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            return 0
            ;;
        124)
            echo "å‘½ä»¤æ‰§è¡Œè¶…æ—¶ï¼ˆ${timeout}ç§’ï¼‰"
            return 1
            ;;
        *)
            echo "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç ï¼š$exit_codeï¼‰"
            return 1
            ;;
    esac
}
```

### 8.3 ç‰ˆæœ¬ç®¡ç†ä¸æµ‹è¯•


**ğŸ”¸ è„šæœ¬ç‰ˆæœ¬æ§åˆ¶**
```bash
#!/bin/bash

# ğŸ”¹ è„šæœ¬ç‰ˆæœ¬ä¿¡æ¯
SCRIPT_VERSION="1.2.3"
SCRIPT_NAME="master_ip_failover"
LAST_MODIFIED="2025-01-20"

# ğŸ”¹ ç‰ˆæœ¬ä¿¡æ¯å‡½æ•°
show_version() {
    cat <<EOF
$SCRIPT_NAME ç‰ˆæœ¬ $SCRIPT_VERSION
æœ€åä¿®æ”¹: $LAST_MODIFIED
ä½œè€…: DBAå›¢é˜Ÿ
ç”¨é€”: MHAä¸»åº“IPåˆ‡æ¢è„šæœ¬
EOF
}

# ğŸ”¹ å‘½ä»¤è¡Œç‰ˆæœ¬æŸ¥è¯¢
if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    show_version
    exit 0
fi
```

**ğŸ”¸ æµ‹è¯•ç¯å¢ƒé…ç½®**
```bash
# ğŸ”¹ ç¯å¢ƒæ£€æµ‹
detect_environment() {
    if [ -f "/etc/mha/test.flag" ]; then
        echo "æ£€æµ‹åˆ°æµ‹è¯•ç¯å¢ƒ"
        export MHA_ENV="test"
        export VIP="192.168.100.100"  # æµ‹è¯•ç¯å¢ƒVIP
    else
        echo "æ£€æµ‹åˆ°ç”Ÿäº§ç¯å¢ƒ"
        export MHA_ENV="production"
        export VIP="192.168.1.100"    # ç”Ÿäº§ç¯å¢ƒVIP
    fi
}

# ğŸ”¹ æ ¹æ®ç¯å¢ƒè°ƒæ•´è¡Œä¸º
if [ "$MHA_ENV" = "test" ]; then
    echo "æµ‹è¯•æ¨¡å¼ï¼šä»…æ‰“å°å‘½ä»¤ï¼Œä¸å®é™…æ‰§è¡Œ"
    DRY_RUN=1
fi
```

### 8.4 MHAè„šæœ¬å¼€å‘ä¸å®šåˆ¶æ‰©å±•


**ğŸ”¸ æ’ä»¶åŒ–è®¾è®¡**
```bash
# ğŸ”¹ æ’ä»¶åŠ è½½æœºåˆ¶
load_plugins() {
    local plugin_dir="/etc/mha/plugins"
    
    if [ -d "$plugin_dir" ]; then
        echo "åŠ è½½è‡ªå®šä¹‰æ’ä»¶..."
        for plugin in "$plugin_dir"/*.sh; do
            if [ -f "$plugin" ]; then
                echo "åŠ è½½æ’ä»¶: $(basename $plugin)"
                source "$plugin"
            fi
        done
    fi
}

# ğŸ”¹ é’©å­å‡½æ•°æ”¯æŒ
run_hook() {
    local hook_name=$1
    local hook_func="hook_$hook_name"
    
    if type "$hook_func" >/dev/null 2>&1; then
        echo "æ‰§è¡Œé’©å­: $hook_name"
        "$hook_func"
    fi
}

# ğŸ”¹ ä½¿ç”¨ç¤ºä¾‹
load_plugins
run_hook "before_vip_add"
add_vip "$new_master"
run_hook "after_vip_add"
```

**ğŸ”¸ é…ç½®æ–‡ä»¶é©±åŠ¨**
```bash
# ğŸ”¹ é…ç½®æ–‡ä»¶è§£æ
load_config() {
    local config_file="/etc/mha/scripts.conf"
    
    if [ -f "$config_file" ]; then
        echo "åŠ è½½é…ç½®æ–‡ä»¶: $config_file"
        source "$config_file"
    else
        echo "è­¦å‘Šï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        set_default_config
    fi
}

# ğŸ”¹ é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆ/etc/mha/scripts.confï¼‰
cat > /etc/mha/scripts.conf <<EOF
# MHAè„šæœ¬é…ç½®æ–‡ä»¶
VIP="192.168.1.100"
INTERFACE="eth0"
SSH_USER="mha"
TIMEOUT=30
NOTIFICATION_ENABLED=true
EMAIL_RECIPIENTS="dba@company.com,ops@company.com"
WECHAT_WEBHOOK_URL="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
EOF
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ MHAè„šæœ¬ä½“ç³»**
- `master_ip_failover`ï¼š**æœ€é‡è¦**ï¼Œå¤„ç†IPåˆ‡æ¢
- `send_report`ï¼šå‘é€æ•…éšœé€šçŸ¥
- `power_manager`ï¼šç”µæºç®¡ç†å’ŒSTONITH
- `secondary_check`ï¼šè¾…åŠ©æ•…éšœæ£€æŸ¥

**ğŸ”¸ è„šæœ¬å¼€å‘è¦ç‚¹**
- **å¹‚ç­‰æ€§è®¾è®¡**ï¼šé‡å¤æ‰§è¡Œç»“æœä¸€è‡´
- **è¶…æ—¶æ§åˆ¶**ï¼šé¿å…ç½‘ç»œhangå¯¼è‡´åˆ‡æ¢å»¶è¿Ÿ
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œå›æ»šæœºåˆ¶
- **å®‰å…¨æ§åˆ¶**ï¼šæƒé™ç®¡ç†ã€è¾“å…¥éªŒè¯ã€å®¡è®¡æ—¥å¿—

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è„šæœ¬ï¼Ÿ**
```
MHAæ¡†æ¶ = æ±½è½¦å¼•æ“ï¼ˆæä¾›åŠ¨åŠ›ï¼‰
è‡ªå®šä¹‰è„šæœ¬ = æ–¹å‘ç›˜ï¼ˆæ§åˆ¶å…·ä½“æ–¹å‘ï¼‰

æ²¡æœ‰è„šæœ¬çš„MHAå°±åƒæ²¡æœ‰æ–¹å‘ç›˜çš„æ±½è½¦ï¼Œæœ‰åŠ¨åŠ›ä½†ä¸çŸ¥é“å¾€å“ªå¼€
```

**ğŸ”¹ è„šæœ¬æ‰§è¡Œæ—¶æœº**
```
æ•…éšœæ£€æµ‹ â†’ secondary_check â†’ æ•°æ®æ¢å¤ â†’ master_ip_failover â†’ send_report
     â†‘              â†‘                           â†‘                    â†‘
   æ£€æŸ¥é˜¶æ®µ      ç¡®è®¤é˜¶æ®µ                    åˆ‡æ¢é˜¶æ®µ            é€šçŸ¥é˜¶æ®µ
```

**ğŸ”¹ å®‰å…¨æ€§è€ƒè™‘**
```
æ“ä½œæƒé™ï¼šæœ€å°æƒé™åŸåˆ™
è¾“å…¥éªŒè¯ï¼šé˜²æ­¢æ³¨å…¥æ”»å‡»  
å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰æ“ä½œ
æµ‹è¯•éªŒè¯ï¼šå……åˆ†æµ‹è¯•å†ä¸Šçº¿
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š è„šæœ¬å¼€å‘ä¼˜å…ˆçº§**

| è„šæœ¬ç±»å‹ | **é‡è¦ç¨‹åº¦** | **å¼€å‘éš¾åº¦** | **å»ºè®®** |
|---------|------------|-------------|---------|
| `master_ip_failover` | `â˜…â˜…â˜…â˜…â˜…` | `ä¸­ç­‰` | `å¿…é¡»å¼€å‘ï¼Œæ ¸å¿ƒåŠŸèƒ½` |
| `send_report` | `â˜…â˜…â˜…â˜…â˜†` | `ç®€å•` | `å¼ºçƒˆå»ºè®®ï¼Œä¾¿äºè¿ç»´` |
| `secondary_check` | `â˜…â˜…â˜…â˜†â˜†` | `ç®€å•` | `å¯é€‰ï¼Œå‡å°‘è¯¯åˆ‡æ¢` |
| `power_manager` | `â˜…â˜…â˜†â˜†â˜†` | `å¤æ‚` | `ç‰¹æ®Šåœºæ™¯éœ€è¦` |

**ğŸ¯ å¼€å‘å»ºè®®**
1. **å…ˆç®€å•åå¤æ‚**ï¼šä»åŸºç¡€VIPåˆ‡æ¢å¼€å§‹
2. **å…ˆæµ‹è¯•åä¸Šçº¿**ï¼šå……åˆ†æµ‹è¯•å„ç§åœºæ™¯
3. **å…ˆå•æœºåé›†ç¾¤**ï¼šé€æ­¥æ‰©å±•åŠŸèƒ½
4. **å…ˆæ‰‹åŠ¨åè‡ªåŠ¨**ï¼šç¡®ä¿å¯æ§æ€§

**âš ï¸ å¸¸è§é”™è¯¯é¿å…**
- è„šæœ¬æƒé™è®¾ç½®é”™è¯¯
- SSHå¯†é’¥é…ç½®é—®é¢˜
- è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­
- ç¼ºå°‘é”™è¯¯å¤„ç†æœºåˆ¶
- å¿½ç•¥å¹‚ç­‰æ€§è®¾è®¡

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
å­¦ä¹ é˜¶æ®µè§„åˆ’ï¼š
åŸºç¡€è„šæœ¬å¼€å‘ â†’ é”™è¯¯å¤„ç†æœºåˆ¶ â†’ å®‰å…¨æ§åˆ¶ â†’ é«˜çº§å®šåˆ¶
      â†“              â†“             â†“           â†“
  2-3å¤©å­¦ä¹      1-2å¤©å®è·µ    1å¤©å®Œå–„    æ ¹æ®éœ€æ±‚
```

**ğŸ§  è®°å¿†è¦ç‚¹**
- MHAè„šæœ¬æ˜¯**ä¸šåŠ¡é€»è¾‘çš„è½½ä½“**ï¼Œä¸æ˜¯å¯é€‰çš„é™„åŠ åŠŸèƒ½
- `master_ip_failover`æ˜¯**åˆ‡æ¢çš„æ ¸å¿ƒ**ï¼Œå¿…é¡»ç¡®ä¿å¯é æ€§
- **å¹‚ç­‰æ€§**å’Œ**è¶…æ—¶æ§åˆ¶**æ˜¯è„šæœ¬è®¾è®¡çš„åŸºæœ¬è¦æ±‚
- **å®‰å…¨æ€§**ä¸æ˜¯äº‹åè¡¥å……ï¼Œè€Œæ˜¯è®¾è®¡é˜¶æ®µå°±è¦è€ƒè™‘
- **æµ‹è¯•éªŒè¯**æ˜¯è„šæœ¬ä¸Šçº¿çš„å¿…è¦æ¡ä»¶ï¼Œä¸æ˜¯å¯é€‰æ­¥éª¤

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- MHAæ¡†æ¶å®šæ–¹å‘ï¼Œè‡ªå®šä¹‰è„šæœ¬æ˜¯å…³é”®
- IPåˆ‡æ¢æœ€é‡è¦ï¼Œé€šçŸ¥æŠ¥å‘Šä¸èƒ½å°‘  
- å¹‚ç­‰è®¾è®¡é˜²é‡å¤ï¼Œè¶…æ—¶æ§åˆ¶é¿hangæ­»
- å®‰å…¨æƒé™è¦ä¸¥æ ¼ï¼Œæµ‹è¯•éªŒè¯ä¿ä¸Šçº¿