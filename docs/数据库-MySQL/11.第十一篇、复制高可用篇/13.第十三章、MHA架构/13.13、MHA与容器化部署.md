---
title: 13、MHA与容器化部署
---
## 📚 目录

1. [容器化MHA架构概述](#1-容器化MHA架构概述)
2. [Docker容器配置](#2-Docker容器配置)
3. [Kubernetes集成部署](#3-Kubernetes集成部署)
4. [容器网络配置](#4-容器网络配置)
5. [容器存储管理](#5-容器存储管理)
6. [容器监控集成](#6-容器监控集成)
7. [容器扩缩容策略](#7-容器扩缩容策略)
8. [容器安全配置](#8-容器安全配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🚀 容器化MHA架构概述


### 1.1 什么是容器化MHA


**简单理解**：就是把MHA（MySQL高可用）架构放到Docker容器里运行，让整套高可用系统变得更灵活、更好管理。

```
传统MHA部署：                    容器化MHA部署：
┌─────────────┐                 ┌─────────────┐
│ 物理服务器1  │                 │ Docker容器1  │
│ MySQL主库   │    变成      →  │ MySQL主库   │
└─────────────┘                 └─────────────┘
┌─────────────┐                 ┌─────────────┐
│ 物理服务器2  │                 │ Docker容器2  │
│ MySQL从库1  │                 │ MySQL从库1  │
└─────────────┘                 └─────────────┘
┌─────────────┐                 ┌─────────────┐
│ 物理服务器3  │                 │ Docker容器3  │
│ MHA Manager │                 │ MHA Manager │
└─────────────┘                 └─────────────┘
```

### 1.2 容器化的核心优势


**🎯 主要好处**：
- **📦 环境一致性** - 开发、测试、生产环境完全一样
- **⚡ 快速部署** - 几分钟就能搭建整套MHA环境
- **🔄 弹性扩容** - 需要更多从库时可以快速增加
- **💰 资源节约** - 一台物理机可以运行多套MHA环境
- **🛠️ 易于管理** - 统一的容器管理平台

### 1.3 容器化架构设计


**整体架构图**：
```
                    Kubernetes集群
    ┌─────────────────────────────────────────────────┐
    │                                                 │
    │  ┌─────────────┐  ┌─────────────┐              │
    │  │ MHA Manager │  │   监控组件   │              │
    │  │   Pod       │  │    Pod      │              │
    │  └─────────────┘  └─────────────┘              │
    │                                                 │
    │  ┌─────────────┐  ┌─────────────┐  ┌─────────── │
    │  │ MySQL主库   │  │ MySQL从库1  │  │ MySQL从库2 │
    │  │   Pod       │  │    Pod      │  │    Pod     │
    │  └─────────────┘  └─────────────┘  └─────────── │
    │                                                 │
    │  ┌─────────────────────────────────────────────│
    │  │          共享存储（NFS/Ceph）             │
    │  └─────────────────────────────────────────────│
    └─────────────────────────────────────────────────┘
```

---

## 2. 🐳 Docker容器配置


### 2.1 MySQL容器镜像准备


**基础镜像构建**：
```dockerfile
# MySQL容器的Dockerfile
FROM mysql:8.0

# 安装MHA相关组件
RUN apt-get update && apt-get install -y \
    openssh-server \
    perl \
    libdbd-mysql-perl \
    libconfig-tiny-perl \
    liblog-dispatch-perl \
    libparallel-forkmanager-perl

# 复制MHA配置文件
COPY mha_node_install.tar.gz /tmp/
RUN cd /tmp && tar -zxf mha_node_install.tar.gz && \
    cd mha4mysql-node* && \
    perl Makefile.PL && \
    make && make install

# 配置SSH无密码登录
RUN mkdir -p /root/.ssh && \
    chmod 700 /root/.ssh
COPY ssh_keys/id_rsa /root/.ssh/
COPY ssh_keys/id_rsa.pub /root/.ssh/
COPY ssh_keys/authorized_keys /root/.ssh/
RUN chmod 600 /root/.ssh/*

# 暴露端口
EXPOSE 3306 22

# 启动脚本
COPY start.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/start.sh
CMD ["/usr/local/bin/start.sh"]
```

### 2.2 MHA Manager容器配置


**Manager容器构建**：
```dockerfile
# MHA Manager容器
FROM ubuntu:20.04

# 安装必要组件
RUN apt-get update && apt-get install -y \
    perl \
    libdbd-mysql-perl \
    libconfig-tiny-perl \
    liblog-dispatch-perl \
    openssh-client \
    mysql-client

# 安装MHA Manager
COPY mha_manager_install.tar.gz /tmp/
RUN cd /tmp && tar -zxf mha_manager_install.tar.gz && \
    cd mha4mysql-manager* && \
    perl Makefile.PL && \
    make && make install

# 配置目录
RUN mkdir -p /etc/mha /var/log/mha

# 配置文件
COPY mha_config/app1.cnf /etc/mha/
COPY scripts/ /usr/local/bin/mha-scripts/

# SSH配置
COPY ssh_keys/ /root/.ssh/
RUN chmod 600 /root/.ssh/*

CMD ["tail", "-f", "/dev/null"]
```

### 2.3 Docker Compose配置


**完整的docker-compose.yml**：
```yaml
version: '3.8'

services:
  # MySQL主库
  mysql-master:
    build: ./mysql-container
    container_name: mysql-master
    hostname: mysql-master
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_REPLICATION_USER=repl
      - MYSQL_REPLICATION_PASSWORD=repl123
      - SERVER_ID=1
      - MYSQL_ROLE=master
    volumes:
      - mysql-master-data:/var/lib/mysql
      - ./mysql-config/master.cnf:/etc/mysql/conf.d/master.cnf
    networks:
      - mha-network
    ports:
      - "3306:3306"

  # MySQL从库1
  mysql-slave1:
    build: ./mysql-container
    container_name: mysql-slave1
    hostname: mysql-slave1
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - SERVER_ID=2
      - MYSQL_ROLE=slave
      - MASTER_HOST=mysql-master
    volumes:
      - mysql-slave1-data:/var/lib/mysql
      - ./mysql-config/slave.cnf:/etc/mysql/conf.d/slave.cnf
    networks:
      - mha-network
    ports:
      - "3307:3306"
    depends_on:
      - mysql-master

  # MySQL从库2
  mysql-slave2:
    build: ./mysql-container
    container_name: mysql-slave2
    hostname: mysql-slave2
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - SERVER_ID=3
      - MYSQL_ROLE=slave
      - MASTER_HOST=mysql-master
    volumes:
      - mysql-slave2-data:/var/lib/mysql
      - ./mysql-config/slave.cnf:/etc/mysql/conf.d/slave.cnf
    networks:
      - mha-network
    ports:
      - "3308:3306"
    depends_on:
      - mysql-master

  # MHA Manager
  mha-manager:
    build: ./mha-manager-container
    container_name: mha-manager
    hostname: mha-manager
    volumes:
      - ./mha-config:/etc/mha
      - ./mha-logs:/var/log/mha
      - ./mha-scripts:/usr/local/bin/mha-scripts
    networks:
      - mha-network
    depends_on:
      - mysql-master
      - mysql-slave1
      - mysql-slave2

volumes:
  mysql-master-data:
  mysql-slave1-data:
  mysql-slave2-data:

networks:
  mha-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

---

## 3. ☸️ Kubernetes集成部署


### 3.1 Kubernetes部署概述


**为什么用Kubernetes**：
- **🔄 自动恢复** - 容器崩溃时自动重启
- **📈 弹性扩展** - 根据负载自动调整从库数量
- **🎯 服务发现** - 自动管理服务间的网络连接
- **💾 存储管理** - 统一管理数据持久化

### 3.2 MySQL主库部署配置


**MySQL Master StatefulSet**：
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
  namespace: mha-system
spec:
  serviceName: mysql-master-svc
  replicas: 1
  selector:
    matchLabels:
      app: mysql-master
  template:
    metadata:
      labels:
        app: mysql-master
        role: master
    spec:
      containers:
      - name: mysql
        image: mysql-mha:latest
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: SERVER_ID
          value: "1"
        - name: MYSQL_ROLE
          value: "master"
        ports:
        - containerPort: 3306
          name: mysql
        - containerPort: 22
          name: ssh
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-master-config
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 100Gi
```

### 3.3 MySQL从库部署配置


**MySQL Slave StatefulSet**：
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-slave
  namespace: mha-system
spec:
  serviceName: mysql-slave-svc
  replicas: 2  # 可以动态调整从库数量
  selector:
    matchLabels:
      app: mysql-slave
  template:
    metadata:
      labels:
        app: mysql-slave
        role: slave
    spec:
      containers:
      - name: mysql
        image: mysql-mha:latest
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: SERVER_ID
          value: "$(POD_NAME | sed 's/.*-//' | awk '{print $1+10}')"
        - name: MYSQL_ROLE
          value: "slave"
        - name: MASTER_HOST
          value: "mysql-master-svc"
        ports:
        - containerPort: 3306
        - containerPort: 22
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 100Gi
```

### 3.4 MHA Manager部署


**MHA Manager Deployment**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mha-manager
  namespace: mha-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mha-manager
  template:
    metadata:
      labels:
        app: mha-manager
    spec:
      containers:
      - name: mha-manager
        image: mha-manager:latest
        volumeMounts:
        - name: mha-config
          mountPath: /etc/mha
        - name: mha-logs
          mountPath: /var/log/mha
        - name: ssh-keys
          mountPath: /root/.ssh
          readOnly: true
        command: ["/bin/bash"]
        args: ["-c", "while true; do sleep 30; done"]
      volumes:
      - name: mha-config
        configMap:
          name: mha-config
      - name: mha-logs
        persistentVolumeClaim:
          claimName: mha-logs-pvc
      - name: ssh-keys
        secret:
          name: ssh-keys-secret
          defaultMode: 0600
```

---

## 4. 🌐 容器网络配置


### 4.1 网络架构设计


**容器网络拓扑**：
```
                     外部访问
                        │
                        ▼
            ┌─────────────────────────┐
            │    Kubernetes Service    │
            │      (LoadBalancer)     │
            └─────────────────────────┘
                        │
            ┌─────────────────────────┐
            │    Ingress Controller   │
            └─────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
   ┌─────────┐   ┌─────────┐   ┌─────────┐
   │MySQL主库│   │MySQL从库│   │MHA管理  │
   │   Pod   │   │   Pod   │   │   Pod   │
   └─────────┘   └─────────┘   └─────────┘
        │               │               │
        └───────────────┼───────────────┘
                        │
              ┌─────────────────┐
              │ 内部网络通信     │
              │ (ClusterIP)     │
              └─────────────────┘
```

### 4.2 Service配置


**MySQL主库Service**：
```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-master-svc
  namespace: mha-system
  labels:
    app: mysql-master
spec:
  ports:
  - port: 3306
    targetPort: 3306
    name: mysql
  - port: 22
    targetPort: 22
    name: ssh
  selector:
    app: mysql-master
  clusterIP: None  # Headless service for StatefulSet
```

**MySQL从库Service**：
```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-slave-svc
  namespace: mha-system
spec:
  ports:
  - port: 3306
    targetPort: 3306
  selector:
    app: mysql-slave
  clusterIP: None
```

### 4.3 网络策略配置


**网络安全策略**：
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mha-network-policy
  namespace: mha-system
spec:
  podSelector:
    matchLabels:
      app: mysql-master
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: mysql-slave
    - podSelector:
        matchLabels:
          app: mha-manager
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 22
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: mysql-slave
    ports:
    - protocol: TCP
      port: 3306
```

---

## 5. 💾 容器存储管理


### 5.1 存储架构设计


**存储层次结构**：
```
应用层        ┌─────────────────┐
             │   MySQL容器     │
             └─────────────────┘
                      │
Kubernetes层  ┌─────────────────┐
             │ PersistentVolume │
             │   (PV/PVC)      │
             └─────────────────┘
                      │
存储层        ┌─────────────────┐
             │   共享存储       │
             │ NFS/Ceph/云存储  │
             └─────────────────┘
```

### 5.2 PV和PVC配置


**PersistentVolume定义**：
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-master-pv
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: fast-ssd
  nfs:
    path: /nfs/mysql-data/master
    server: nfs-server.example.com
```

**PersistentVolumeClaim配置**：
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-master-pvc
  namespace: mha-system
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: fast-ssd
```

### 5.3 存储备份策略


**自动备份配置**：
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: mha-system
spec:
  schedule: "0 2 * * *"  # 每天凌晨2点
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mysql-backup
            image: mysql:8.0
            command:
            - /bin/bash
            - -c
            - |
              mysqldump -h mysql-master-svc \
                       -u backup_user \
                       -p$MYSQL_BACKUP_PASSWORD \
                       --all-databases \
                       --single-transaction \
                       --routines \
                       --triggers > /backup/mysql-backup-$(date +%Y%m%d).sql
            env:
            - name: MYSQL_BACKUP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: backup-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

---

## 6. 📊 容器监控集成


### 6.1 监控架构


**监控系统架构**：
```
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Grafana   │    │ Prometheus  │    │  AlertManager│
    │  (展示层)    │◄───│  (收集层)    │◄───│  (告警层)    │
    └─────────────┘    └─────────────┘    └─────────────┘
           ▲                    ▲                    │
           │                    │                    ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   用户界面   │    │   指标抓取   │    │   告警通知   │
    └─────────────┘    └─────────────┘    └─────────────┘
                              ▲
                    ┌─────────┼─────────┐
                    │         │         │
               ┌─────────┐┌─────────┐┌─────────┐
               │MySQL主库││MySQL从库││MHA管理器│
               │ Exporter││ Exporter││监控Agent│
               └─────────┘└─────────┘└─────────┘
```

### 6.2 Prometheus配置


**MySQL监控配置**：
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    
    scrape_configs:
    - job_name: 'mysql-master'
      static_configs:
      - targets: ['mysql-master-svc.mha-system:9104']
      metrics_path: /metrics
      scrape_interval: 10s
    
    - job_name: 'mysql-slaves'
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
          - mha-system
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: mysql-slave
      - source_labels: [__meta_kubernetes_pod_ip]
        target_label: __address__
        replacement: ${1}:9104

    rule_files:
    - "mysql_rules.yml"
    
    alerting:
      alertmanagers:
      - static_configs:
        - targets:
          - alertmanager:9093
```

### 6.3 监控指标定义


**关键监控指标**：
```yaml
# MySQL监控规则
groups:
- name: mysql_alerts
  rules:
  - alert: MySQLDown
    expr: mysql_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MySQL实例宕机"
      description: "MySQL实例 {{ $labels.instance }} 已宕机超过1分钟"

  - alert: MySQLReplicationLag
    expr: mysql_slave_lag_seconds > 30
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "MySQL主从延迟过高"
      description: "从库 {{ $labels.instance }} 延迟 {{ $value }} 秒"

  - alert: MySQLConnectionsHigh
    expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "MySQL连接数过高"
      description: "实例 {{ $labels.instance }} 连接使用率达到 {{ $value }}%"
```

---

## 7. 📈 容器扩缩容策略


### 7.1 水平扩缩容


**从库自动扩缩容**：
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: mysql-slave-hpa
  namespace: mha-system
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: mysql-slave
  minReplicas: 2
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 2
        periodSeconds: 60
```

### 7.2 垂直扩缩容


**资源自动调整**：
```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: mysql-master-vpa
  namespace: mha-system
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: mysql-master
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: mysql
      minAllowed:
        cpu: 500m
        memory: 1Gi
      maxAllowed:
        cpu: 4000m
        memory: 8Gi
      controlledResources: ["cpu", "memory"]
```

### 7.3 扩缩容脚本


**自动扩容脚本**：
```bash
#!/bin/bash
# 从库扩容脚本

NAMESPACE="mha-system"
CURRENT_REPLICAS=$(kubectl get statefulset mysql-slave -n $NAMESPACE -o jsonpath='{.spec.replicas}')
NEW_REPLICAS=$((CURRENT_REPLICAS + 1))

echo "当前从库数量: $CURRENT_REPLICAS"
echo "扩容到: $NEW_REPLICAS 个从库"

# 扩容StatefulSet
kubectl scale statefulset mysql-slave --replicas=$NEW_REPLICAS -n $NAMESPACE

# 等待新Pod启动
kubectl wait --for=condition=Ready pod/mysql-slave-$((NEW_REPLICAS-1)) -n $NAMESPACE --timeout=300s

# 配置新从库的复制
NEW_SLAVE_POD="mysql-slave-$((NEW_REPLICAS-1))"
kubectl exec -n $NAMESPACE $NEW_SLAVE_POD -- mysql -u root -proot123 -e "
CHANGE MASTER TO 
  MASTER_HOST='mysql-master-svc',
  MASTER_USER='repl',
  MASTER_PASSWORD='repl123',
  MASTER_AUTO_POSITION=1;
START SLAVE;
"

echo "从库扩容完成"
```

---

## 8. 🔒 容器安全配置


### 8.1 安全架构


**安全防护体系**：
```
┌─────────────────────────────────────────────────┐
│                 安全边界                         │
│  ┌─────────────────────────────────────────────┐ │
│  │             网络安全层                       │ │
│  │  ┌─────────────────────────────────────────┐ │ │
│  │  │           容器安全层                     │ │ │
│  │  │  ┌─────────────────────────────────────┐ │ │ │
│  │  │  │         应用安全层                   │ │ │ │
│  │  │  │  ┌─────────────────────────────────┐ │ │ │ │
│  │  │  │  │       数据安全层                 │ │ │ │ │
│  │  │  │  └─────────────────────────────────┘ │ │ │ │
│  │  │  └─────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 8.2 RBAC权限配置


**角色权限设置**：
```yaml
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mha-service-account
  namespace: mha-system

---
# ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mha-cluster-role
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["statefulsets", "deployments"]
  verbs: ["get", "list", "watch", "update", "patch"]

---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mha-cluster-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mha-cluster-role
subjects:
- kind: ServiceAccount
  name: mha-service-account
  namespace: mha-system
```

### 8.3 Pod安全配置


**SecurityContext设置**：
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        runAsGroup: 999
        fsGroup: 999
      containers:
      - name: mysql
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
            - DAC_OVERRIDE
            - FOWNER
            - FSETID
            - KILL
            - SETGID
            - SETUID
            - NET_BIND_SERVICE
```

### 8.4 网络安全策略


**Pod安全策略**：
```yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: mha-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  allowedCapabilities:
    - CHOWN
    - DAC_OVERRIDE
    - FOWNER
    - SETGID
    - SETUID
    - NET_BIND_SERVICE
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

### 8.5 密钥管理


**Secret配置**：
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: mha-system
type: Opaque
data:
  root-password: cm9vdDEyMw==  # base64编码的root123
  repl-password: cmVwbDEyMw==  # base64编码的repl123
  backup-password: YmFja3VwMTIz  # base64编码的backup123

---
apiVersion: v1
kind: Secret
metadata:
  name: ssh-keys-secret
  namespace: mha-system
type: Opaque
data:
  id_rsa: LS0tLS1CRUdJTi...  # SSH私钥base64编码
  id_rsa.pub: c3NoLXJzYS...  # SSH公钥base64编码
  authorized_keys: c3NoLXJzYS...  # 授权密钥base64编码
```

---

## 9. 📋 核心要点总结


### 9.1 容器化部署要点


**🔸 核心理解**：
```
传统部署 → 容器化部署的转变：
- 环境一致性：开发测试生产完全相同
- 快速部署：几分钟搭建整套环境
- 弹性扩展：按需增减从库数量
- 统一管理：容器编排平台统一控制
```

**🔸 技术栈选择**：
- **容器运行时**：Docker - 标准化容器技术
- **编排平台**：Kubernetes - 生产级容器编排
- **存储方案**：PV/PVC - 数据持久化保证
- **网络方案**：Service/Ingress - 服务发现和负载均衡
- **监控方案**：Prometheus+Grafana - 完整监控体系

### 9.2 关键配置要点


**🔹 镜像构建要点**：
```
MySQL镜像：基础镜像 + MHA组件 + SSH配置
Manager镜像：MHA Manager + 配置文件 + 脚本
重点：SSH免密、权限配置、启动脚本
```

**🔹 网络配置要点**：
```
Service类型：Headless Service for StatefulSet
网络策略：限制Pod间通信，提高安全性
端口暴露：3306(MySQL) + 22(SSH)
```

**🔹 存储配置要点**：
```
存储类：选择高性能SSD存储类
备份策略：CronJob定时备份
数据恢复：PV快照和备份文件结合
```

### 9.3 运维管理要点


**🔹 扩缩容策略**：
```
水平扩缩容：HPA基于CPU/内存自动调整从库数量
垂直扩缩容：VPA自动调整Pod资源限制
手动扩缩容：kubectl scale快速调整
```

**🔹 监控告警**：
```
核心指标：MySQL可用性、主从延迟、连接数
告警级别：critical(严重) > warning(警告) > info(信息)
通知方式：邮件、短信、钉钉、企业微信
```

**🔹 安全配置**：
```
RBAC权限：最小权限原则
Pod安全：SecurityContext限制容器权限
网络安全：NetworkPolicy限制网络访问
密钥管理：Secret管理敏感信息
```

### 9.4 最佳实践建议


**✅ 推荐做法**：
- 使用StatefulSet部署MySQL，保证有序启停
- 配置资源限制，避免资源争抢
- 设置健康检查，及时发现问题
- 定期备份数据，制定恢复流程
- 监控关键指标，建立告警机制

**❌ 避免问题**：
- 不要在容器内存储重要数据，使用持久卷
- 不要使用默认密码，配置强密码
- 不要忽略网络安全，配置网络策略
- 不要过度分配资源，合理规划容量

**🎯 核心价值**：
容器化MHA架构让MySQL高可用变得更加灵活、可靠和易管理，是现代数据库运维的重要发展方向。通过合理的配置和管理，可以显著提升系统的可用性和运维效率。