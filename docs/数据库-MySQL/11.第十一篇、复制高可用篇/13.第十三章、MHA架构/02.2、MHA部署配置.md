---
title: 2、MHA部署配置
---
## 📚 目录

1. [MHA架构基础概念](#1-MHA架构基础概念)
2. [部署环境规划与准备](#2-部署环境规划与准备)
3. [MHA Manager节点部署](#3-MHA-Manager节点部署)
4. [MHA Node节点配置](#4-MHA-Node节点配置)
5. [核心配置文件详解](#5-核心配置文件详解)
6. [安全配置与权限设置](#6-安全配置与权限设置)
7. [部署验证与测试](#7-部署验证与测试)
8. [生产环境最佳实践](#8-生产环境最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🏗️ MHA架构基础概念


### 1.1 什么是MHA


**MHA** (Master High Availability) 是MySQL数据库的高可用性解决方案。简单来说，**MHA就是一个专门保护MySQL主库的"保镖"系统**。

> **通俗理解**：想象MySQL主库是公司的CEO，如果CEO突然生病了，MHA就像是一个训练有素的助理，能够立即让副总（从库）接替CEO的工作，确保公司业务不中断。

```
传统MySQL主从架构问题：
主库 ──→ 从库1
  │      从库2
  │      从库3
  ↓
主库宕机 = 业务中断 😰

MHA解决方案：
     MHA Manager (监控大脑)
         │
    ┌────┼────┐
主库 ──→ 从库1 ──→ 从库2
         ↑
    自动切换为新主库 ✅
```

**MHA的核心作用**：
- **自动故障检测**：像心电监护仪一样实时监控主库健康状态
- **智能故障切换**：主库出问题时，自动选择最合适的从库提升为新主库
- **数据一致性保障**：确保切换过程中数据不丢失
- **最小停机时间**：通常只需要10-30秒就能完成切换

### 1.2 MHA架构组件


**MHA由两大核心组件构成**：

```
MHA架构全景图：

┌─────────────────────────────────────────────────────────┐
│                   MHA Manager                           │
│  ┌─────────────────────────────────────────────────┐   │
│  │  • masterha_manager (主监控进程)               │   │
│  │  • masterha_check_ssh (SSH连通性检查)         │   │
│  │  • masterha_check_repl (复制状态检查)         │   │
│  │  • masterha_master_switch (手动切换)          │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           │ 监控指令
                           ▼
┌──────────────┬──────────────┬──────────────┬──────────────┐
│  MySQL主库   │  MySQL从库1  │  MySQL从库2  │  MySQL从库3  │
│ + MHA Node   │ + MHA Node   │ + MHA Node   │ + MHA Node   │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

| **组件类型** | **部署位置** | **主要功能** | **核心工具** |
|-------------|-------------|-------------|-------------|
| **MHA Manager** | `独立服务器` | `监控、决策、切换` | `masterha_manager` |
| **MHA Node** | `每台MySQL服务器` | `数据恢复、应用日志` | `save_binary_logs` |

---

## 2. 📋 部署环境规划与准备


### 2.1 硬件资源要求


**💻 服务器配置建议**

| **服务器角色** | **CPU** | **内存** | **磁盘** | **网络** | **数量** |
|---------------|---------|---------|---------|---------|---------|
| **MHA Manager** | `2核` | `4GB` | `50GB SSD` | `千兆网卡` | `1台` |
| **MySQL主库** | `8核` | `32GB` | `500GB SSD` | `千兆网卡` | `1台` |
| **MySQL从库** | `8核` | `32GB` | `500GB SSD` | `千兆网卡` | `2-3台` |

> **💡 资源规划说明**：
> - **MHA Manager**：不处理数据，资源要求较低，主要跑监控程序
> - **MySQL服务器**：按照业务负载配置，确保从库性能不低于主库
> - **网络要求**：所有服务器之间网络延迟应低于1ms

### 2.2 网络环境配置


**🌐 网络拓扑规划**

```
生产环境网络部署拓扑：

          管理网络 (192.168.1.0/24)
    ┌─────────────────────────────────────┐
    │                                     │
┌───▼───┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│Manager│  │MySQL主库│  │MySQL从库1│ │MySQL从库2│
│.100   │  │  .101   │  │  .102   │  │  .103   │
└───────┘  └─────────┘  └─────────┘  └─────────┘
    │           │           │           │
    └───────────┼───────────┼───────────┘
          业务网络 (10.0.1.0/24)
```

**关键网络配置**：
```bash
# 1. 配置主机名解析 (所有服务器)
echo "192.168.1.100 mha-manager" >> /etc/hosts
echo "192.168.1.101 mysql-master" >> /etc/hosts
echo "192.168.1.102 mysql-slave1" >> /etc/hosts
echo "192.168.1.103 mysql-slave2" >> /etc/hosts

# 2. 防火墙配置
# MySQL端口
firewall-cmd --permanent --add-port=3306/tcp
# SSH端口  
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --reload
```

### 2.3 部署前检查清单


**✅ 必须完成的准备工作**

```bash
# 系统环境检查脚本
#!/bin/bash
echo "=== MHA部署前环境检查 ==="

# 1. 检查操作系统版本
echo "1. 操作系统信息："
cat /etc/redhat-release

# 2. 检查网络连通性
echo "2. 网络连通性检查："
ping -c 2 mysql-master && echo "✅ 主库连通" || echo "❌ 主库不通"
ping -c 2 mysql-slave1 && echo "✅ 从库1连通" || echo "❌ 从库1不通"
ping -c 2 mysql-slave2 && echo "✅ 从库2连通" || echo "❌ 从库2不通"

# 3. 检查MySQL服务状态
echo "3. MySQL服务状态："
systemctl status mysqld | grep Active

# 4. 检查磁盘空间
echo "4. 磁盘空间检查："
df -h | grep -E "(/$|/var)"
```

**⚠️ 部署前必备条件**：
- [ ] 所有MySQL服务器主从复制已配置并正常运行
- [ ] 服务器之间SSH免密登录已配置
- [ ] MySQL复制用户和MHA管理用户已创建
- [ ] 防火墙和SELinux已正确配置
- [ ] 所有服务器时间已同步

---

## 3. 🔧 MHA Manager节点部署


### 3.1 安装MHA Manager


**📦 软件安装步骤**

```bash
# 1. 安装依赖包
yum install -y perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch \
               perl-Parallel-ForkManager perl-ExtUtils-CBuilder \
               perl-ExtUtils-MakeMaker perl-CPAN

# 2. 下载MHA软件包
cd /tmp
wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58-0.el7.centos.noarch.rpm
wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm

# 3. 安装MHA Node (Manager节点也需要)
rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm

# 4. 安装MHA Manager
rpm -ivh mha4mysql-manager-0.58-0.el7.centos.noarch.rpm

# 5. 验证安装
ls /usr/bin/masterha_*
```

**安装后的核心工具说明**：

| **工具名称** | **功能说明** | **使用场景** |
|-------------|-------------|-------------|
| `masterha_manager` | **主监控进程** | `持续监控，自动故障切换` |
| `masterha_check_ssh` | **SSH连通性检查** | `部署验证` |
| `masterha_check_repl` | **复制状态检查** | `部署验证` |
| `masterha_master_switch` | **手动故障切换** | `计划性维护` |
| `masterha_stop` | **停止MHA监控** | `维护操作` |

### 3.2 创建MHA工作目录


```bash
# 创建MHA工作目录结构
mkdir -p /etc/mha/app1          # 配置文件目录
mkdir -p /var/log/mha/app1      # 日志目录
mkdir -p /var/lib/mha/app1      # 工作数据目录

# 设置目录权限
chown -R mysql:mysql /etc/mha /var/log/mha /var/lib/mha
chmod 755 /etc/mha /var/log/mha /var/lib/mha
```

---

## 4. ⚙️ MHA Node节点配置


### 4.1 所有MySQL服务器安装Node


**在每台MySQL服务器上执行**：

```bash
# 1. 安装MHA Node包
cd /tmp
wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.centos.noarch.rpm
rpm -ivh mha4mysql-node-0.58-0.el7.centos.noarch.rpm

# 2. 验证Node工具安装
ls /usr/bin/save_binary_logs    # 二进制日志保存工具
ls /usr/bin/apply_diff_relay_logs   # 中继日志差异应用工具
ls /usr/bin/filter_mysqlbinlog      # 二进制日志过滤工具
ls /usr/bin/purge_relay_logs        # 中继日志清理工具
```

**MHA Node核心工具说明**：

| **Node工具** | **作用解释** | **工作时机** |
|-------------|-------------|-------------|
| `save_binary_logs` | **保存主库的二进制日志** | `主库故障时，抢救未同步的事务` |
| `apply_diff_relay_logs` | **应用差异的中继日志** | `数据恢复阶段，确保数据一致性` |
| `filter_mysqlbinlog` | **过滤二进制日志** | `去除不需要的日志事件` |
| `purge_relay_logs` | **安全清理中继日志** | `定期维护，防止磁盘空间不足` |

### 4.2 配置MySQL数据目录权限


```bash
# 确保MHA可以访问MySQL数据目录和日志文件
chown -R mysql:mysql /var/lib/mysql
chmod 755 /var/lib/mysql

# 确保二进制日志目录可访问
chown mysql:mysql /var/log/mysql
chmod 755 /var/log/mysql
```

---

## 5. 📝 核心配置文件详解


### 5.1 MHA主配置文件


**创建 `/etc/mha/app1/app1.cnf`**：

```ini
# MHA Manager配置文件 - app1.cnf
# 这是MHA的"大脑"，告诉它如何监控和管理MySQL集群

[server default]
# === 基础连接配置 ===
# MHA连接MySQL使用的管理用户
user=mha
# 管理用户密码
password=mha123
# SSH连接用户（通常是root或mysql）
ssh_user=root
# MySQL复制用户
repl_user=repl
# 复制用户密码  
repl_password=repl123
# MySQL服务端口
port=3306

# === 工作目录配置 ===
# MHA工作目录（存放临时文件）
manager_workdir=/var/lib/mha/app1
# 日志文件位置
manager_log=/var/log/mha/app1/manager.log
# 远程工作目录（在MySQL服务器上）
remote_workdir=/tmp

# === 故障切换配置 ===
# 故障切换脚本（可选，用于切换VIP）
master_ip_failover_script=/usr/local/bin/master_ip_failover
# 在线切换脚本（计划性维护时使用）
master_ip_online_change_script=/usr/local/bin/master_ip_online_change
# 关闭故障服务器脚本（可选）
shutdown_script=""

# === 监控配置 ===
# 连接检查间隔（秒）
ping_interval=1
# 故障切换后是否自动启动新从库
secondary_check_script=masterha_secondary_check -s mysql-slave1 -s mysql-slave2

# 服务器列表配置
# === 主库配置 ===
[server1]
hostname=mysql-master
# 这台服务器是主库的候选（但目前是主库，所以设为no）
candidate_master=1
# 检查复制延迟（主库不需要，设为0）
check_repl_delay=0

# === 从库1配置 ===  
[server2]
hostname=mysql-slave1
# 这台服务器可以成为主库
candidate_master=1
# 检查复制延迟时间（秒）
check_repl_delay=0

# === 从库2配置 ===
[server3]
hostname=mysql-slave2
# 这台服务器也可以成为主库
candidate_master=1
# 检查复制延迟
check_repl_delay=0
```

**配置文件关键参数详解**：

| **参数分类** | **参数名** | **含义解释** | **推荐值** |
|-------------|-----------|-------------|-----------|
| **连接认证** | `user/password` | `MHA连接MySQL的管理账号` | `mha/强密码` |
| **SSH配置** | `ssh_user` | `SSH连接使用的系统用户` | `root` |
| **复制配置** | `repl_user/repl_password` | `MySQL主从复制专用账号` | `repl/强密码` |
| **监控配置** | `ping_interval` | `多久检查一次主库健康状态` | `1秒` |
| **切换配置** | `candidate_master` | `这台服务器是否可以成为新主库` | `1(是)/0(否)` |

### 5.2 故障切换脚本配置


**创建VIP切换脚本 `/usr/local/bin/master_ip_failover`**：

```bash
#!/usr/bin/env perl
# MHA故障切换时的VIP管理脚本
# 作用：确保应用程序总是连接到当前的主库

use strict;
use warnings FATAL => 'all';
use Getopt::Long;

# VIP配置 - 这个IP地址会跟随主库移动
my $vip = '192.168.1.200/24';
my $key = "1";
my $ssh_start_vip = "/sbin/ifconfig eth0:$key $vip";
my $ssh_stop_vip = "/sbin/ifconfig eth0:$key down";

my (
    $command,          # MHA传递的命令类型
    $ssh_user,         # SSH用户
    $orig_master_host, # 原主库主机
    $orig_master_ip,   # 原主库IP
    $new_master_host,  # 新主库主机  
    $new_master_ip,    # 新主库IP
);

GetOptions(
    'command=s'          => \$command,
    'ssh_user=s'         => \$ssh_user,
    'orig_master_host=s' => \$orig_master_host,
    'orig_master_ip=s'   => \$orig_master_ip,
    'new_master_host=s'  => \$new_master_host,
    'new_master_ip=s'    => \$new_master_ip,
);

if ( $command eq "stop" || $command eq "stopssh" ) {
    # 从原主库移除VIP
    my $exit_code = 1;
    eval {
        print "从 $orig_master_host($orig_master_ip) 移除VIP $vip\n";
        &stop_vip();
        $exit_code = 0;
    };
    if ($@) {
        warn "移除VIP失败: $@\n";
        exit $exit_code;
    }
    exit $exit_code;
}
elsif ( $command eq "start" ) {
    # 在新主库添加VIP
    my $exit_code = 10;
    eval {
        print "在 $new_master_host($new_master_ip) 添加VIP $vip\n";
        &start_vip();
        $exit_code = 0;
    };
    if ($@) {
        warn "添加VIP失败: $@\n";
        exit $exit_code;
    }
    exit $exit_code;
}

# 启动VIP的函数
sub start_vip() {
    `ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;
}

# 停止VIP的函数  
sub stop_vip() {
    `ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;
}
```

```bash
# 设置脚本权限
chmod +x /usr/local/bin/master_ip_failover
chown mysql:mysql /usr/local/bin/master_ip_failover
```

---

## 6. 🔐 安全配置与权限设置


### 6.1 SSH密钥配置


**配置MHA Manager到所有MySQL服务器的免密登录**：

```bash
# 1. 在MHA Manager服务器上生成SSH密钥
ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ""

# 2. 将公钥复制到所有MySQL服务器
ssh-copy-id root@mysql-master
ssh-copy-id root@mysql-slave1  
ssh-copy-id root@mysql-slave2

# 3. 测试SSH连接
ssh root@mysql-master "echo 'SSH连接成功'"
ssh root@mysql-slave1 "echo 'SSH连接成功'" 
ssh root@mysql-slave2 "echo 'SSH连接成功'"

# 4. 配置MySQL服务器之间的相互免密访问
# 在每台MySQL服务器上执行
for host in mysql-master mysql-slave1 mysql-slave2; do
    ssh-copy-id root@$host
done
```

### 6.2 MySQL用户权限设置


**在主库上创建MHA必需的用户**：

```sql
-- 1. 创建MHA管理用户（用于监控和管理）
CREATE USER 'mha'@'%' IDENTIFIED BY 'mha123';
GRANT ALL PRIVILEGES ON *.* TO 'mha'@'%';

-- 2. 创建复制用户（用于主从复制）
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl123';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 3. 刷新权限
FLUSH PRIVILEGES;

-- 4. 验证用户创建成功
SELECT User, Host FROM mysql.user WHERE User IN ('mha', 'repl');
```

**权限说明**：

| **用户类型** | **用户名** | **权限范围** | **作用说明** |
|-------------|-----------|-------------|-------------|
| **MHA管理用户** | `mha` | `ALL PRIVILEGES` | `监控复制状态，执行故障切换` |
| **复制用户** | `repl` | `REPLICATION SLAVE` | `从库连接主库进行数据同步` |

### 6.3 安全加固措施


```bash
# 1. 限制MHA配置文件权限
chmod 600 /etc/mha/app1/app1.cnf
chown mysql:mysql /etc/mha/app1/app1.cnf

# 2. 配置防火墙规则（仅允许必要端口）
# 允许MHA Manager访问MySQL端口
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.1.100' port protocol='tcp' port='3306' accept"

# 允许SSH访问
firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='192.168.1.0/24' port protocol='tcp' port='22' accept"

firewall-cmd --reload

# 3. 设置MySQL连接超时（防止连接泄露）
echo "wait_timeout=300" >> /etc/my.cnf
echo "interactive_timeout=300" >> /etc/my.cnf
```

---

## 7. ✅ 部署验证与测试


### 7.1 连通性检查


```bash
# 1. 检查SSH连通性
masterha_check_ssh --conf=/etc/mha/app1/app1.cnf

# 期望输出：
# SSH连接检查通过
# All SSH connection tests passed successfully.

# 2. 检查MySQL复制状态  
masterha_check_repl --conf=/etc/mha/app1/app1.cnf

# 期望输出：
# 复制检查通过
# Replication Health is OK.
```

### 7.2 启动MHA监控


```bash
# 1. 启动MHA Manager监控进程
nohup masterha_manager --conf=/etc/mha/app1/app1.cnf > /var/log/mha/app1/manager.log 2>&1 &

# 2. 检查MHA状态
masterha_check_status --conf=/etc/mha/app1/app1.cnf

# 3. 查看监控日志
tail -f /var/log/mha/app1/manager.log
```

### 7.3 故障切换测试


**⚠️ 测试环境下的故障切换验证**：

```bash
# 1. 模拟主库故障（测试环境）
# 在主库服务器上执行
systemctl stop mysqld

# 2. 观察MHA日志，确认自动切换
tail -f /var/log/mha/app1/manager.log

# 3. 检查新的主库状态
# 在原从库上检查
mysql -u root -p -e "SHOW MASTER STATUS;"

# 4. 验证VIP是否切换成功
ip addr show eth0
```

**故障切换成功的标志**：
- ✅ MHA日志显示切换完成
- ✅ 新主库显示为可写状态  
- ✅ VIP已迁移到新主库
- ✅ 其他从库指向新主库

---

## 8. 🏆 生产环境最佳实践


### 8.1 多套MHA环境管理


**大型企业通常需要管理多套MHA环境**：

```bash
# 目录结构规划
/etc/mha/
├── prod_app1/          # 生产环境应用1
│   └── app1.cnf
├── prod_app2/          # 生产环境应用2  
│   └── app2.cnf
├── test_app1/          # 测试环境应用1
│   └── test1.cnf
└── dev_app1/           # 开发环境应用1
    └── dev1.cnf

# 日志目录对应规划
/var/log/mha/
├── prod_app1/
├── prod_app2/  
├── test_app1/
└── dev_app1/
```

### 8.2 自动化部署工具


**使用Ansible自动化MHA部署**：

```yaml
# mha-deploy.yml
---
- name: MHA自动化部署
  hosts: mha_managers
  tasks:
    - name: 安装MHA Manager
      yum:
        name: 
          - mha4mysql-manager
          - mha4mysql-node
        state: present
    
    - name: 创建MHA目录
      file:
        path: "{{ item }}"
        state: directory
        owner: mysql
        group: mysql
        mode: '0755'
      loop:
        - /etc/mha/app1
        - /var/log/mha/app1
        - /var/lib/mha/app1
    
    - name: 部署MHA配置文件
      template:
        src: app1.cnf.j2
        dest: /etc/mha/app1/app1.cnf
        owner: mysql
        group: mysql
        mode: '0600'
```

### 8.3 监控告警集成


**集成到企业监控系统**：

```bash
# MHA状态监控脚本
#!/bin/bash
# /usr/local/bin/check_mha_status.sh

MHA_CONF="/etc/mha/app1/app1.cnf"
STATUS=$(masterha_check_status --conf=$MHA_CONF 2>/dev/null)

if echo "$STATUS" | grep -q "is running"; then
    echo "MHA_STATUS:RUNNING"
    exit 0
elif echo "$STATUS" | grep -q "is stopped"; then
    echo "MHA_STATUS:STOPPED"  
    exit 1
else
    echo "MHA_STATUS:UNKNOWN"
    exit 2
fi
```

### 8.4 备份恢复策略


```bash
# 定期备份MHA配置
#!/bin/bash
# 每日备份MHA配置文件
DATE=$(date +%Y%m%d)
BACKUP_DIR="/backup/mha/$DATE"

mkdir -p $BACKUP_DIR
cp -r /etc/mha/* $BACKUP_DIR/
cp -r /usr/local/bin/master_ip_* $BACKUP_DIR/

# 保留30天的备份
find /backup/mha/ -type d -mtime +30 -exec rm -rf {} \;
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 MHA架构：Manager监控 + Node执行的分工协作模式
🔸 部署规划：硬件资源、网络环境、安全权限的系统性规划  
🔸 配置文件：app1.cnf是MHA的"大脑"，配置所有行为规则
🔸 SSH免密：MHA能够快速执行远程操作的基础
🔸 MySQL权限：mha管理用户 + repl复制用户的权限配置
🔸 故障切换：自动检测、智能选主、VIP漂移的完整流程
🔸 监控验证：SSH检查、复制检查、状态监控的验证体系
```

### 9.2 关键理解要点


**🔹 MHA的工作原理**
```
监控阶段：Manager持续ping主库，检查复制状态
故障检测：ping失败超过阈值，触发故障切换流程  
数据恢复：收集未同步的binlog，应用到新主库
主库切换：提升最优从库为新主库，重建复制关系
服务恢复：VIP漂移，应用无感知切换完成
```

**🔹 配置文件的核心逻辑**
```
[server default]：通用配置，适用于所有服务器
[serverN]：单独配置，每台服务器的特殊设置
candidate_master：决定哪些服务器可以成为主库
check_repl_delay：复制延迟检查，确保数据一致性
```

**🔹 安全配置的重要性**
```
SSH免密：避免故障切换时的认证延迟
MySQL权限：最小权限原则，只授予必要权限
网络安全：防火墙限制，只开放必要端口
配置文件权限：防止敏感信息泄露
```

### 9.3 实际应用价值


**💼 企业生产环境应用**
- **高可用保障**：RTO < 30秒，RPO接近0的故障恢复能力
- **自动化运维**：减少人工干预，降低故障恢复时间
- **业务连续性**：应用层无感知的故障切换
- **成本控制**：相比硬件HA方案，软件成本更低

**🎯 运维管理优势**  
- **故障可视化**：详细的日志记录，便于故障分析
- **操作标准化**：配置文件化，部署可重复
- **监控集成**：易于集成到现有监控体系
- **扩展灵活**：支持多套环境，适应业务增长

### 9.4 常见问题与解决方案


**⚠️ 部署常见问题**
```
SSH连接失败 → 检查密钥配置和网络连通性
MySQL连接被拒绝 → 检查用户权限和防火墙设置
复制状态异常 → 检查主从配置和复制用户权限
MHA启动失败 → 检查配置文件语法和目录权限
```

**💡 运维最佳实践**
```
定期演练：每月进行故障切换演练
监控告警：集成到企业监控系统
文档维护：保持配置文档同步更新
权限管理：定期审查和更新数据库用户权限
```

**核心记忆口诀**：
```
MHA部署三要素：Manager监控，Node执行，配置连接
SSH免密是基础，MySQL权限要配齐
配置文件是大脑，监控日志看状态
故障切换三步走：检测，恢复，切换
生产环境重规划，安全监控不能少
```