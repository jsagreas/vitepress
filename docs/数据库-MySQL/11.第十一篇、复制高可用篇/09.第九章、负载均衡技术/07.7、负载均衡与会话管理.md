---
title: 7ã€è´Ÿè½½å‡è¡¡ä¸ä¼šè¯ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [ä¼šè¯ç²˜æ€§ç­–ç•¥è¯¦è§£](#2-ä¼šè¯ç²˜æ€§ç­–ç•¥è¯¦è§£)
3. [åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨æ–¹æ¡ˆ](#3-åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨æ–¹æ¡ˆ)
4. [ä¼šè¯å¤åˆ¶æœºåˆ¶](#4-ä¼šè¯å¤åˆ¶æœºåˆ¶)
5. [ä¼šè¯æ•…éšœè½¬ç§»å¤„ç†](#5-ä¼šè¯æ•…éšœè½¬ç§»å¤„ç†)
6. [æ— çŠ¶æ€è®¾è®¡åŸåˆ™](#6-æ— çŠ¶æ€è®¾è®¡åŸåˆ™)
7. [ä¼šè¯ç›‘æ§ä¸å®‰å…¨](#7-ä¼šè¯ç›‘æ§ä¸å®‰å…¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”‘ ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ä¼šè¯ç®¡ç†


**ä¼šè¯ï¼ˆSessionï¼‰** æ˜¯æŒ‡ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’è¿‡ç¨‹ä¸­ä¿æŒçš„çŠ¶æ€ä¿¡æ¯ã€‚ç®€å•ç†è§£å°±æ˜¯ï¼š**ç³»ç»Ÿè®°ä½ç”¨æˆ·èº«ä»½å’Œæ“ä½œçŠ¶æ€çš„æœºåˆ¶**ã€‚

```
ç”¨æˆ·ç™»å½•æµç¨‹ç¤ºä¾‹ï¼š
ç”¨æˆ·å¼ ä¸‰ â†’ ç™»å½•ç³»ç»Ÿ â†’ ç”Ÿæˆä¼šè¯ID â†’ åç»­è¯·æ±‚æºå¸¦ä¼šè¯ID â†’ ç³»ç»Ÿè¯†åˆ«ç”¨æˆ·èº«ä»½

æ²¡æœ‰ä¼šè¯ï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦é‡æ–°ç™»å½• âŒ
æœ‰äº†ä¼šè¯ï¼šç™»å½•ä¸€æ¬¡ï¼Œåç»­è‡ªåŠ¨è¯†åˆ« âœ…
```

### 1.2 ä¼šè¯åœ¨è´Ÿè½½å‡è¡¡ä¸­çš„æŒ‘æˆ˜


å½“å¼•å…¥è´Ÿè½½å‡è¡¡åï¼Œç”¨æˆ·è¯·æ±‚å¯èƒ½è¢«åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡å™¨ï¼Œè¿™å°±äº§ç”Ÿäº†**ä¼šè¯ä¸€è‡´æ€§é—®é¢˜**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
å®¢æˆ·ç«¯          è´Ÿè½½å‡è¡¡å™¨         åç«¯æœåŠ¡å™¨
   |               |              Server1 (å­˜å‚¨å¼ ä¸‰çš„ä¼šè¯)
   |--ç™»å½•è¯·æ±‚----->|---åˆ†å‘åˆ°------>|
   |<--è¿”å›ä¼šè¯ID----|<-------------|
   |               |              
   |--åç»­è¯·æ±‚----->|---åˆ†å‘åˆ°----->Server2 (æ²¡æœ‰å¼ ä¸‰çš„ä¼šè¯) âŒ
   |<--è¦æ±‚é‡æ–°ç™»å½•--|<-------------|
```

> ğŸ’¡ **æ ¸å¿ƒé—®é¢˜**ï¼šç”¨æˆ·åœ¨Server1ç™»å½•åï¼Œä¸‹æ¬¡è¯·æ±‚è¢«åˆ†å‘åˆ°Server2ï¼ŒServer2ä¸è®¤è¯†è¿™ä¸ªç”¨æˆ·ï¼Œè¦æ±‚é‡æ–°ç™»å½•

### 1.3 ä¼šè¯ç®¡ç†çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆä¼šè¯ç®¡ç†è¿™ä¹ˆé‡è¦ï¼Ÿ**

- **ç”¨æˆ·ä½“éªŒ** ğŸ¯ï¼šé¿å…é‡å¤ç™»å½•ï¼Œä¿æŒæ“ä½œè¿ç»­æ€§
- **å®‰å…¨æ€§** ğŸ”’ï¼šæ­£ç¡®è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œé˜²æ­¢è¶Šæƒè®¿é—®  
- **ä¸šåŠ¡é€»è¾‘** ğŸ’¼ï¼šä¿å­˜è´­ç‰©è½¦ã€è¡¨å•çŠ¶æ€ç­‰ä¸´æ—¶æ•°æ®
- **ç³»ç»Ÿæ€§èƒ½** âš¡ï¼šå‡å°‘é‡å¤è®¤è¯ï¼Œæå‡å“åº”é€Ÿåº¦

---

## 2. ğŸ“ ä¼šè¯ç²˜æ€§ç­–ç•¥è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯ä¼šè¯ç²˜æ€§


**ä¼šè¯ç²˜æ€§ï¼ˆSession Affinityï¼‰** åˆå« **ç²˜æ»ä¼šè¯ï¼ˆSticky Sessionï¼‰**ï¼Œæ˜¯æŒ‡**è®©åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚éƒ½è·¯ç”±åˆ°åŒä¸€å°æœåŠ¡å™¨**çš„ç­–ç•¥ã€‚

```
ç²˜æ€§ç­–ç•¥å·¥ä½œåŸç†ï¼š
å®¢æˆ·ç«¯A          è´Ÿè½½å‡è¡¡å™¨         åç«¯æœåŠ¡å™¨
   |               |              Server1 â† å¼ ä¸‰ä¸“å±
   |--ç¬¬1æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>|
   |--ç¬¬2æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>| â† åŒä¸€æœåŠ¡å™¨
   |--ç¬¬3æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>| â† åŒä¸€æœåŠ¡å™¨

å®¢æˆ·ç«¯B                            Server2 â† æå››ä¸“å±
   |--ç¬¬1æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>|
   |--ç¬¬2æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>| â† åŒä¸€æœåŠ¡å™¨
```

### 2.2 ç²˜æ€§ç­–ç•¥å®ç°æ–¹æ³•


#### ğŸ”¸ åŸºäºIPåœ°å€çš„ç²˜æ€§

```nginx
# Nginxé…ç½®ç¤ºä¾‹
upstream backend {
    ip_hash;  # æ ¹æ®å®¢æˆ·ç«¯IPå“ˆå¸Œåˆ†é…
    server 192.168.1.10:3306;
    server 192.168.1.11:3306;
    server 192.168.1.12:3306;
}
```

**å·¥ä½œåŸç†**ï¼š
- å¯¹å®¢æˆ·ç«¯IPè¿›è¡Œå“ˆå¸Œè®¡ç®—
- ç›¸åŒIPæ€»æ˜¯å¾—åˆ°ç›¸åŒçš„å“ˆå¸Œå€¼
- ç¡®ä¿åŒä¸€ç”¨æˆ·å§‹ç»ˆè¿æ¥åˆ°åŒä¸€æœåŠ¡å™¨

#### ğŸ”¸ åŸºäºCookieçš„ç²˜æ€§

```nginx
# Nginxé…ç½®ç¤ºä¾‹
upstream backend {
    sticky cookie srv_id expires=1h domain=.example.com path=/;
    server 192.168.1.10:3306;
    server 192.168.1.11:3306;
}
```

**å·¥ä½œåŸç†**ï¼š
- ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶è®¾ç½®Cookieæ ‡è¯†æœåŠ¡å™¨
- åç»­è¯·æ±‚æ ¹æ®Cookieè·¯ç”±åˆ°æŒ‡å®šæœåŠ¡å™¨

### 2.3 ä¼šè¯ç²˜æ€§çš„ä¼˜ç¼ºç‚¹


| æ–¹é¢ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|----------|----------|
| **å®ç°** | `ç®€å•æ˜“æ‡‚ï¼Œé…ç½®æ–¹ä¾¿` | `æœåŠ¡å™¨æ•…éšœæ—¶ä¼šè¯ä¸¢å¤±` |
| **æ€§èƒ½** | `æ— é¢å¤–å­˜å‚¨å¼€é”€` | `è´Ÿè½½å¯èƒ½ä¸å‡è¡¡` |
| **æ‰©å±•** | `æ— éœ€æ”¹é€ åº”ç”¨` | `æ°´å¹³æ‰©å±•å—é™` |
| **ç»´æŠ¤** | `è¿ç»´ç®€å•` | `æœåŠ¡å™¨é‡å¯å½±å“ç”¨æˆ·` |

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šä¼šè¯ç²˜æ€§è™½ç„¶ç®€å•ï¼Œä½†åœ¨é«˜å¯ç”¨ç¯å¢ƒä¸‹å­˜åœ¨å•ç‚¹æ•…éšœé£é™©

---

## 3. ğŸ’¾ åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨æ–¹æ¡ˆ


### 3.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨


**åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨** æ˜¯æŒ‡**å°†ä¼šè¯æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨å¤–éƒ¨å­˜å‚¨ç³»ç»Ÿä¸­**ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨å„ä¸ªåº”ç”¨æœåŠ¡å™¨çš„å†…å­˜é‡Œã€‚

```
åˆ†å¸ƒå¼ä¼šè¯æ¶æ„ï¼š
å®¢æˆ·ç«¯          è´Ÿè½½å‡è¡¡å™¨         åº”ç”¨æœåŠ¡å™¨          ä¼šè¯å­˜å‚¨
   |               |              Server1             |
   |--è¯·æ±‚-------->|---åˆ†å‘åˆ°------>|                  |
   |               |              |--è¯»å–ä¼šè¯æ•°æ®----->|Redis/MySQL
   |               |              |<--è¿”å›ä¼šè¯æ•°æ®-----|
   |               |              Server2             |
   |--ä¸‹æ¬¡è¯·æ±‚---->|---åˆ†å‘åˆ°------>|                  |
   |               |              |--è¯»å–ä¼šè¯æ•°æ®----->|Redis/MySQL
   |               |              |<--è¿”å›ä¼šè¯æ•°æ®-----|â† åŒæ ·çš„æ•°æ®
```

### 3.2 å¸¸ç”¨å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”


#### ğŸ”¸ Rediså­˜å‚¨æ–¹æ¡ˆ


**Redis** æ˜¯æœ€å¸¸ç”¨çš„ä¼šè¯å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒå…·æœ‰**é«˜æ€§èƒ½**å’Œ**è¿‡æœŸè‡ªåŠ¨æ¸…ç†**çš„ç‰¹æ€§ã€‚

```python
# Python Flask + Redis ç¤ºä¾‹
import redis
from flask import Flask, session

app = Flask(__name__)
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://localhost:6379')

@app.route('/login')
def login():
    session['user_id'] = 12345
    session['username'] = 'zhangsan'
    return "ç™»å½•æˆåŠŸ"

@app.route('/profile')  
def profile():
    user_id = session.get('user_id')  # ä»Redisè¯»å–
    return f"ç”¨æˆ·ID: {user_id}"
```

**Redisæ–¹æ¡ˆç‰¹ç‚¹**ï¼š
- âœ… **é«˜æ€§èƒ½**ï¼šå†…å­˜å­˜å‚¨ï¼Œè®¿é—®é€Ÿåº¦å¿«
- âœ… **è‡ªåŠ¨è¿‡æœŸ**ï¼šè®¾ç½®TTLè‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- âœ… **æ•°æ®ç»“æ„ä¸°å¯Œ**ï¼šæ”¯æŒå­—ç¬¦ä¸²ã€å“ˆå¸Œã€åˆ—è¡¨ç­‰
- âŒ **æ•°æ®æŒä¹…æ€§**ï¼šé‡å¯å¯èƒ½ä¸¢å¤±æ•°æ®ï¼ˆå¯é…ç½®æŒä¹…åŒ–ï¼‰

#### ğŸ”¸ MySQLå­˜å‚¨æ–¹æ¡ˆ


**MySQLæ•°æ®åº“** å¯ä»¥ä½œä¸ºå¯é çš„ä¼šè¯å­˜å‚¨ï¼Œé€‚åˆå¯¹æ•°æ®æŒä¹…æ€§è¦æ±‚é«˜çš„åœºæ™¯ã€‚

```sql
-- åˆ›å»ºä¼šè¯è¡¨
CREATE TABLE sessions (
    session_id VARCHAR(128) PRIMARY KEY,
    user_id INT,
    session_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    INDEX idx_expires (expires_at),
    INDEX idx_user (user_id)
);

-- å­˜å‚¨ä¼šè¯
INSERT INTO sessions (session_id, user_id, session_data, expires_at) 
VALUES ('sess_abc123', 12345, '{"username":"zhangsan"}', DATE_ADD(NOW(), INTERVAL 2 HOUR));

-- è¯»å–ä¼šè¯
SELECT session_data FROM sessions 
WHERE session_id = 'sess_abc123' AND expires_at > NOW();
```

**MySQLæ–¹æ¡ˆç‰¹ç‚¹**ï¼š
- âœ… **æ•°æ®å¯é **ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼Œä¸æ€•é‡å¯
- âœ… **äº‹åŠ¡æ”¯æŒ**ï¼šACIDç‰¹æ€§ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… **æŸ¥è¯¢çµæ´»**ï¼šæ”¯æŒå¤æ‚æŸ¥è¯¢å’Œç»Ÿè®¡
- âŒ **æ€§èƒ½ç›¸å¯¹è¾ƒä½**ï¼šç£ç›˜IOæ¯”å†…å­˜æ…¢

### 3.3 åˆ†å¸ƒå¼å­˜å‚¨æ¶æ„è®¾è®¡


```
é«˜å¯ç”¨ä¼šè¯å­˜å‚¨æ¶æ„ï¼š

åº”ç”¨æœåŠ¡å™¨é›†ç¾¤          ä¼šè¯å­˜å‚¨é›†ç¾¤           æ•°æ®å¤‡ä»½
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server1    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚Redis Master â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚Redis Backup â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Server2    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚Redis Slave1 â”‚       â”‚MySQL Backup â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Server3    â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚Redis Slave2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **è®¾è®¡è¦ç‚¹**ï¼šä¸»ä»å¤åˆ¶ä¿è¯å¯ç”¨æ€§ï¼Œå®šæœŸå¤‡ä»½ä¿è¯æ•°æ®å®‰å…¨

---

## 4. ğŸ”„ ä¼šè¯å¤åˆ¶æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯ä¼šè¯å¤åˆ¶


**ä¼šè¯å¤åˆ¶ï¼ˆSession Replicationï¼‰** æ˜¯æŒ‡**åœ¨å¤šå°æœåŠ¡å™¨ä¹‹é—´åŒæ­¥ä¼šè¯æ•°æ®**ï¼Œç¡®ä¿æ¯å°æœåŠ¡å™¨éƒ½æœ‰å®Œæ•´çš„ä¼šè¯ä¿¡æ¯ã€‚

### 4.2 å¤åˆ¶æœºåˆ¶ç±»å‹


#### ğŸ”¸ åŒæ­¥å¤åˆ¶


**åŒæ­¥å¤åˆ¶** è¦æ±‚ä¼šè¯æ•°æ®**å®æ—¶åŒæ­¥**åˆ°æ‰€æœ‰æœåŠ¡å™¨æ‰è¿”å›å“åº”ã€‚

```
åŒæ­¥å¤åˆ¶æµç¨‹ï¼š
å®¢æˆ·ç«¯     Server1     Server2     Server3
   |         |          |          |
   |--ç™»å½•--->|          |          |
   |         |--å¤åˆ¶---->|          |
   |         |--å¤åˆ¶--------------->|
   |         |<--ç¡®è®¤----|          |
   |         |<--ç¡®è®¤-------------|
   |<--æˆåŠŸ---|          |          |
```

**ç‰¹ç‚¹**ï¼š
- âœ… **æ•°æ®ä¸€è‡´æ€§å¼º**ï¼šæ‰€æœ‰æœåŠ¡å™¨æ•°æ®å®Œå…¨åŒæ­¥
- âŒ **æ€§èƒ½å¼€é”€å¤§**ï¼šéœ€è¦ç­‰å¾…æ‰€æœ‰å¤åˆ¶å®Œæˆ
- âŒ **å¯ç”¨æ€§é£é™©**ï¼šä»»ä¸€æœåŠ¡å™¨æ•…éšœå½±å“æ•´ä½“

#### ğŸ”¸ å¼‚æ­¥å¤åˆ¶


**å¼‚æ­¥å¤åˆ¶** å…ˆè¿”å›å“åº”ï¼Œ**åå°å¼‚æ­¥åŒæ­¥**ä¼šè¯æ•°æ®ã€‚

```
å¼‚æ­¥å¤åˆ¶æµç¨‹ï¼š
å®¢æˆ·ç«¯     Server1     Server2     Server3
   |         |          |          |
   |--ç™»å½•--->|          |          |
   |<--æˆåŠŸ---|          |          |
   |         |--å¤åˆ¶---->|          |
   |         |--å¤åˆ¶--------------->|
```

**ç‰¹ç‚¹**ï¼š
- âœ… **å“åº”é€Ÿåº¦å¿«**ï¼šä¸ç­‰å¾…å¤åˆ¶å®Œæˆ
- âœ… **å¯ç”¨æ€§å¥½**ï¼šå•ç‚¹æ•…éšœä¸å½±å“å“åº”
- âŒ **æ•°æ®å¯èƒ½ä¸ä¸€è‡´**ï¼šå¤åˆ¶å­˜åœ¨å»¶è¿Ÿ

### 4.3 MySQL Clusterä¼šè¯å¤åˆ¶ç¤ºä¾‹


```sql
-- åœ¨MySQL Clusterä¸­é…ç½®ä¼šè¯è¡¨
CREATE TABLE sessions (
    session_id VARCHAR(128) PRIMARY KEY,
    user_id INT,
    session_data TEXT,
    last_access TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=NDB;  -- ä½¿ç”¨NDBå¼•æ“è‡ªåŠ¨å¤åˆ¶

-- åº”ç”¨å±‚ä¼šè¯æ“ä½œ
-- åˆ›å»ºä¼šè¯
INSERT INTO sessions (session_id, user_id, session_data) 
VALUES (?, ?, ?) 
ON DUPLICATE KEY UPDATE 
session_data = VALUES(session_data), 
last_access = CURRENT_TIMESTAMP;

-- è¯»å–ä¼šè¯  
SELECT session_data FROM sessions WHERE session_id = ?;
```

---

## 5. ğŸš¨ ä¼šè¯æ•…éšœè½¬ç§»å¤„ç†


### 5.1 ä»€ä¹ˆæ˜¯ä¼šè¯æ•…éšœè½¬ç§»


**ä¼šè¯æ•…éšœè½¬ç§»ï¼ˆSession Failoverï¼‰** æ˜¯æŒ‡å½“æŸå°æœåŠ¡å™¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œ**è‡ªåŠ¨å°†ç”¨æˆ·ä¼šè¯åˆ‡æ¢åˆ°å…¶ä»–æ­£å¸¸æœåŠ¡å™¨**çš„æœºåˆ¶ã€‚

### 5.2 æ•…éšœæ£€æµ‹æœºåˆ¶


#### ğŸ”¸ å¥åº·æ£€æŸ¥


```python
# Pythonå®ç°ç®€å•å¥åº·æ£€æŸ¥
import requests
import time

def health_check(server_url):
    try:
        response = requests.get(f"{server_url}/health", timeout=5)
        return response.status_code == 200
    except:
        return False

def monitor_servers():
    servers = ['http://server1:3306', 'http://server2:3306']
    while True:
        for server in servers:
            if not health_check(server):
                print(f"æœåŠ¡å™¨ {server} å¼‚å¸¸ï¼Œè§¦å‘æ•…éšœè½¬ç§»")
                # æ‰§è¡Œæ•…éšœè½¬ç§»é€»è¾‘
                failover_server(server)
        time.sleep(30)  # 30ç§’æ£€æŸ¥ä¸€æ¬¡
```

#### ğŸ”¸ è´Ÿè½½å‡è¡¡å™¨æ£€æµ‹


```nginx
# Nginxå¥åº·æ£€æŸ¥é…ç½®
upstream backend {
    server 192.168.1.10:3306 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:3306 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:3306 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}

# HAProxyé…ç½®ç¤ºä¾‹
backend mysql_servers
    option httpchk GET /health
    server mysql1 192.168.1.10:3306 check inter 5s
    server mysql2 192.168.1.11:3306 check inter 5s
    server mysql3 192.168.1.12:3306 check inter 5s backup
```

### 5.3 æ•…éšœè½¬ç§»ç­–ç•¥


#### ğŸ”¸ ä¼šè¯é‡å»ºç­–ç•¥


å½“æœåŠ¡å™¨æ•…éšœæ—¶ï¼Œåœ¨æ–°æœåŠ¡å™¨ä¸Š**é‡æ–°æ„å»ºç”¨æˆ·ä¼šè¯**ï¼š

```python
def session_failover(session_id, failed_server, target_server):
    """ä¼šè¯æ•…éšœè½¬ç§»å¤„ç†"""
    try:
        # 1. ä»åˆ†å¸ƒå¼å­˜å‚¨è¯»å–ä¼šè¯æ•°æ®
        session_data = redis_client.get(f"session:{session_id}")
        
        if session_data:
            # 2. åœ¨ç›®æ ‡æœåŠ¡å™¨é‡å»ºä¼šè¯
            rebuild_session(target_server, session_id, session_data)
            print(f"ä¼šè¯ {session_id} æˆåŠŸè½¬ç§»åˆ° {target_server}")
        else:
            # 3. ä¼šè¯æ•°æ®ä¸å­˜åœ¨ï¼Œè¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•
            print(f"ä¼šè¯ {session_id} æ•°æ®ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ç™»å½•")
            
    except Exception as e:
        print(f"ä¼šè¯è½¬ç§»å¤±è´¥: {e}")
```

#### ğŸ”¸ ä¼˜é›…é™çº§ç­–ç•¥


```python
def graceful_degradation(user_request):
    """ä¼˜é›…é™çº§å¤„ç†"""
    try:
        # 1. å°è¯•ä»ä¸»å­˜å‚¨è¯»å–ä¼šè¯
        session = primary_session_store.get(user_request.session_id)
        if session:
            return session
            
    except Exception:
        try:
            # 2. ä¸»å­˜å‚¨å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨å­˜å‚¨
            session = backup_session_store.get(user_request.session_id)
            if session:
                return session
        except Exception:
            pass
    
    # 3. æ‰€æœ‰å­˜å‚¨éƒ½å¤±è´¥ï¼Œè¿”å›æ¸¸å®¢èº«ä»½
    return create_guest_session()
```

---

## 6. ğŸ¯ æ— çŠ¶æ€è®¾è®¡åŸåˆ™


### 6.1 ä»€ä¹ˆæ˜¯æ— çŠ¶æ€è®¾è®¡


**æ— çŠ¶æ€è®¾è®¡ï¼ˆStateless Designï¼‰** æ˜¯æŒ‡**åº”ç”¨æœåŠ¡å™¨ä¸ä¿å­˜ä»»ä½•ç”¨æˆ·çŠ¶æ€ä¿¡æ¯**ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½åŒ…å«å¤„ç†æ‰€éœ€çš„å®Œæ•´ä¿¡æ¯ã€‚

```
æœ‰çŠ¶æ€ vs æ— çŠ¶æ€è®¾è®¡å¯¹æ¯”ï¼š

æœ‰çŠ¶æ€è®¾è®¡ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨A(ä¿å­˜ç”¨æˆ·çŠ¶æ€) â†’ æ•°æ®åº“
é—®é¢˜ï¼šæœåŠ¡å™¨Aæ•…éšœï¼Œç”¨æˆ·çŠ¶æ€ä¸¢å¤±

æ— çŠ¶æ€è®¾è®¡ï¼š  
å®¢æˆ·ç«¯(æºå¸¦çŠ¶æ€ä¿¡æ¯) â†’ ä»»æ„æœåŠ¡å™¨ â†’ æ•°æ®åº“
ä¼˜åŠ¿ï¼šä»»ä½•æœåŠ¡å™¨éƒ½èƒ½å¤„ç†è¯·æ±‚
```

### 6.2 æ— çŠ¶æ€è®¾è®¡å®ç°æ–¹æ³•


#### ğŸ”¸ JWT Tokenæ–¹æ¡ˆ


**JWTï¼ˆJSON Web Tokenï¼‰** å°†ç”¨æˆ·ä¿¡æ¯ç¼–ç åœ¨Tokenä¸­ï¼Œ**å®¢æˆ·ç«¯è‡ªå·±æºå¸¦çŠ¶æ€**ï¼š

```python
import jwt
import datetime

# ç”ŸæˆJWT Token
def generate_jwt_token(user_id, username):
    payload = {
        'user_id': user_id,
        'username': username,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)
    }
    token = jwt.encode(payload, 'secret_key', algorithm='HS256')
    return token

# éªŒè¯JWT Token
def verify_jwt_token(token):
    try:
        payload = jwt.decode(token, 'secret_key', algorithms=['HS256'])
        return payload
    except jwt.ExpiredSignatureError:
        return None  # Tokenè¿‡æœŸ
    except jwt.InvalidTokenError:
        return None  # Tokenæ— æ•ˆ
```

**JWTå·¥ä½œæµç¨‹**ï¼š
```
1. ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨éªŒè¯ â†’ ç”ŸæˆJWT Token â†’ è¿”å›ç»™å®¢æˆ·ç«¯
2. å®¢æˆ·ç«¯å­˜å‚¨Tokenï¼ˆé€šå¸¸åœ¨localStorageæˆ–Cookieä¸­ï¼‰
3. åç»­è¯·æ±‚éƒ½æºå¸¦Token â†’ æœåŠ¡å™¨éªŒè¯Token â†’ æå–ç”¨æˆ·ä¿¡æ¯
```

#### ğŸ”¸ è¯·æ±‚çº§çŠ¶æ€ä¼ é€’


```python
# æ¯æ¬¡è¯·æ±‚éƒ½ä¼ é€’å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
def process_order(request):
    # ä»è¯·æ±‚ä¸­è·å–æ‰€æœ‰å¿…è¦ä¿¡æ¯
    user_info = extract_user_from_token(request.headers['Authorization'])
    cart_items = request.json['cart_items']
    payment_info = request.json['payment_info']
    
    # å¤„ç†è®¢å•ï¼ˆä¸ä¾èµ–æœåŠ¡å™¨çŠ¶æ€ï¼‰
    order = create_order(user_info, cart_items, payment_info)
    return order
```

### 6.3 æ— çŠ¶æ€è®¾è®¡çš„ä¼˜åŠ¿


| æ–¹é¢ | **ä¼˜åŠ¿è¯´æ˜** |
|------|-------------|
| **æ°´å¹³æ‰©å±•** | `å¯ä»¥éšæ„å¢å‡æœåŠ¡å™¨ï¼Œæ— çŠ¶æ€è¿ç§»æˆæœ¬` |
| **æ•…éšœæ¢å¤** | `å•å°æœåŠ¡å™¨æ•…éšœä¸å½±å“ç”¨æˆ·ä½“éªŒ` |
| **è´Ÿè½½å‡è¡¡** | `è¯·æ±‚å¯ä»¥è·¯ç”±åˆ°ä»»æ„æœåŠ¡å™¨` |
| **ç®€åŒ–è¿ç»´** | `æœåŠ¡å™¨é‡å¯ã€å‡çº§å¯¹ç”¨æˆ·é€æ˜` |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šåœ¨è®¾è®¡æ–°ç³»ç»Ÿæ—¶ï¼Œä¼˜å…ˆè€ƒè™‘æ— çŠ¶æ€æ¶æ„

---

## 7. ğŸ“Š ä¼šè¯ç›‘æ§ä¸å®‰å…¨


### 7.1 ä¼šè¯ç›‘æ§æŒ‡æ ‡


#### ğŸ”¸ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


```python
# ä¼šè¯ç›‘æ§æŒ‡æ ‡æ”¶é›†
class SessionMonitor:
    def collect_metrics(self):
        metrics = {
            # ä¼šè¯æ•°é‡æŒ‡æ ‡
            'active_sessions': self.count_active_sessions(),
            'total_sessions_created': self.count_total_sessions(),
            'sessions_per_minute': self.get_session_creation_rate(),
            
            # ä¼šè¯æ€§èƒ½æŒ‡æ ‡  
            'avg_session_duration': self.get_avg_session_duration(),
            'session_storage_latency': self.measure_storage_latency(),
            'session_hit_rate': self.calculate_hit_rate(),
            
            # ä¼šè¯å¼‚å¸¸æŒ‡æ ‡
            'expired_sessions': self.count_expired_sessions(),
            'failed_session_reads': self.count_read_failures(),
            'session_timeouts': self.count_timeouts()
        }
        return metrics
```

#### ğŸ”¸ ç›‘æ§å‘Šè­¦è®¾ç½®


| æŒ‡æ ‡ç±»å‹ | **å‘Šè­¦é˜ˆå€¼** | **å¤„ç†å»ºè®®** |
|----------|-------------|-------------|
| **æ´»è·ƒä¼šè¯æ•°** | `è¶…è¿‡é¢„è®¾å®¹é‡çš„80%` | `è€ƒè™‘æ‰©å®¹æˆ–æ¸…ç†è¿‡æœŸä¼šè¯` |
| **å­˜å‚¨å»¶è¿Ÿ** | `è¶…è¿‡100ms` | `æ£€æŸ¥å­˜å‚¨ç³»ç»Ÿæ€§èƒ½` |
| **å‘½ä¸­ç‡** | `ä½äº95%` | `ä¼˜åŒ–ç¼“å­˜ç­–ç•¥` |
| **å¤±è´¥ç‡** | `è¶…è¿‡1%` | `æ£€æŸ¥ç½‘ç»œå’Œå­˜å‚¨ç¨³å®šæ€§` |

### 7.2 ä¼šè¯å®‰å…¨ä¿æŠ¤


#### ğŸ”¸ ä¼šè¯åŠ«æŒé˜²æŠ¤


```python
# ä¼šè¯å®‰å…¨å¢å¼º
class SecureSession:
    def create_session(self, user_id, client_ip, user_agent):
        session_id = self.generate_secure_id()
        
        # ç»‘å®šå®¢æˆ·ç«¯ç‰¹å¾ï¼Œé˜²æ­¢ä¼šè¯åŠ«æŒ
        session_data = {
            'user_id': user_id,
            'client_ip': client_ip,
            'user_agent_hash': hashlib.md5(user_agent.encode()).hexdigest(),
            'created_at': time.time(),
            'last_activity': time.time()
        }
        
        # å­˜å‚¨ä¼šè¯
        redis_client.setex(f"session:{session_id}", 7200, json.dumps(session_data))
        return session_id
    
    def validate_session(self, session_id, client_ip, user_agent):
        session_data = redis_client.get(f"session:{session_id}")
        if not session_data:
            return False
            
        data = json.loads(session_data)
        
        # éªŒè¯å®¢æˆ·ç«¯IP
        if data['client_ip'] != client_ip:
            self.log_security_event("IPä¸åŒ¹é…", session_id, client_ip)
            return False
            
        # éªŒè¯User-Agent
        current_ua_hash = hashlib.md5(user_agent.encode()).hexdigest()
        if data['user_agent_hash'] != current_ua_hash:
            self.log_security_event("User-Agentä¸åŒ¹é…", session_id)
            return False
            
        return True
```

#### ğŸ”¸ ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†


```python
class SessionLifecycleManager:
    def manage_session_lifecycle(self):
        """ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
        
        # 1. å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
        self.cleanup_expired_sessions()
        
        # 2. æ£€æµ‹å¼‚å¸¸ä¼šè¯
        self.detect_suspicious_sessions()
        
        # 3. æ›´æ–°æ´»è·ƒä¼šè¯
        self.refresh_active_sessions()
    
    def cleanup_expired_sessions(self):
        """æ¸…ç†è¿‡æœŸä¼šè¯"""
        expired_keys = redis_client.keys("session:*")
        for key in expired_keys:
            ttl = redis_client.ttl(key)
            if ttl < 0:  # å·²è¿‡æœŸä½†æœªè‡ªåŠ¨åˆ é™¤
                redis_client.delete(key)
                
    def detect_suspicious_sessions(self):
        """æ£€æµ‹å¯ç–‘ä¼šè¯"""
        sessions = redis_client.keys("session:*")
        for session_key in sessions:
            session_data = json.loads(redis_client.get(session_key))
            
            # æ£€æµ‹é•¿æœŸæœªæ´»åŠ¨çš„ä¼šè¯
            if time.time() - session_data['last_activity'] > 3600:
                self.force_logout(session_key)
                
            # æ£€æµ‹å¼‚å¸¸ç™»å½•ä½ç½®
            if self.is_suspicious_location(session_data['client_ip']):
                self.require_reauth(session_key)
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¼šè¯ç®¡ç†ï¼šåœ¨è´Ÿè½½å‡è¡¡ç¯å¢ƒä¸‹ä¿æŒç”¨æˆ·çŠ¶æ€çš„æŠ€æœ¯
ğŸ”¸ ä¼šè¯ç²˜æ€§ï¼šè®©ç”¨æˆ·è¯·æ±‚å›ºå®šè·¯ç”±åˆ°åŒä¸€æœåŠ¡å™¨
ğŸ”¸ åˆ†å¸ƒå¼å­˜å‚¨ï¼šå°†ä¼šè¯æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨å¤–éƒ¨ç³»ç»Ÿä¸­
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šæœåŠ¡å™¨æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢ç”¨æˆ·ä¼šè¯
ğŸ”¸ æ— çŠ¶æ€è®¾è®¡ï¼šæœåŠ¡å™¨ä¸ä¿å­˜çŠ¶æ€ï¼Œå®¢æˆ·ç«¯æºå¸¦å®Œæ•´ä¿¡æ¯
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å„ç§æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯**
```
ä¼šè¯ç²˜æ€§ï¼š
âœ… é€‚åˆï¼šå°è§„æ¨¡åº”ç”¨ï¼Œå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜
âŒ ä¸é€‚åˆï¼šé«˜å¯ç”¨è¦æ±‚ï¼Œé¢‘ç¹æ‰©ç¼©å®¹

åˆ†å¸ƒå¼å­˜å‚¨ï¼š
âœ… é€‚åˆï¼šå¤§è§„æ¨¡åº”ç”¨ï¼Œé«˜å¯ç”¨è¦æ±‚
âŒ ä¸é€‚åˆï¼šå¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿçš„åœºæ™¯

æ— çŠ¶æ€è®¾è®¡ï¼š
âœ… é€‚åˆï¼šå¾®æœåŠ¡æ¶æ„ï¼Œäº‘åŸç”Ÿåº”ç”¨
âŒ ä¸é€‚åˆï¼šå¤æ‚çŠ¶æ€ç®¡ç†çš„ä¼ ç»Ÿåº”ç”¨
```

**ğŸ”¹ å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©åŸåˆ™**
```
Redisï¼šé«˜æ€§èƒ½ï¼Œé€‚åˆç¼“å­˜å‹ä¼šè¯
MySQLï¼šé«˜å¯é ï¼Œé€‚åˆæŒä¹…å‹ä¼šè¯
å†…å­˜å¤åˆ¶ï¼šä½å»¶è¿Ÿï¼Œé€‚åˆå°é›†ç¾¤
æ–‡ä»¶å­˜å‚¨ï¼šç®€å•ï¼Œé€‚åˆå•æœºæ‰©å±•
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè´­ç‰©è½¦çŠ¶æ€ã€ç”¨æˆ·åå¥½è®¾ç½®
- **åœ¨çº¿æ•™è‚²**ï¼šå­¦ä¹ è¿›åº¦ã€ç­”é¢˜çŠ¶æ€
- **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“çŠ¶æ€ã€é£æ§ä¿¡æ¯
- **æ¸¸æˆå¹³å°**ï¼šæ¸¸æˆçŠ¶æ€ã€æ’è¡Œæ¦œæ•°æ®

**ğŸ”§ æŠ€æœ¯å®è·µå»ºè®®**
- **æ–°é¡¹ç›®**ï¼šä¼˜å…ˆé€‰æ‹©æ— çŠ¶æ€è®¾è®¡+JWT
- **æ”¹é€ é¡¹ç›®**ï¼šé€æ­¥å¼•å…¥åˆ†å¸ƒå¼ä¼šè¯å­˜å‚¨  
- **é«˜å¹¶å‘åœºæ™¯**ï¼šRedisé›†ç¾¤+ä¸»ä»å¤åˆ¶
- **å¼ºä¸€è‡´æ€§è¦æ±‚**ï¼šMySQL+äº‹åŠ¡ä¿è¯

**ğŸš¨ å¸¸è§é—®é¢˜é˜²èŒƒ**
- **ä¼šè¯ä¸¢å¤±**ï¼šåšå¥½å¤‡ä»½å’Œæ•…éšœè½¬ç§»
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šåˆç†è®¾ç½®è¿‡æœŸæ—¶é—´å’Œæ¸…ç†ç­–ç•¥
- **å®‰å…¨é£é™©**ï¼šåŠ å¼ºä¼šè¯éªŒè¯å’Œå¼‚å¸¸æ£€æµ‹
- **æ•°æ®ä¸ä¸€è‡´**ï¼šé€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«

**æ ¸å¿ƒè®°å¿†**ï¼š
- è´Ÿè½½å‡è¡¡å¿…é¡»è€ƒè™‘ä¼šè¯ä¸€è‡´æ€§é—®é¢˜
- åˆ†å¸ƒå¼å­˜å‚¨æ˜¯è§£å†³ä¼šè¯é—®é¢˜çš„ä¸»æµæ–¹æ¡ˆ
- æ— çŠ¶æ€è®¾è®¡æ˜¯äº‘åŸç”Ÿæ—¶ä»£çš„æœ€ä½³å®è·µ
- ç›‘æ§å’Œå®‰å…¨æ˜¯ä¼šè¯ç®¡ç†çš„é‡è¦ç»„æˆéƒ¨åˆ†