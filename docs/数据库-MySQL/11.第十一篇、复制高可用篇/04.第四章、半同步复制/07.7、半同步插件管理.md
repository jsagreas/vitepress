---
title: 7、半同步插件管理
---
## 📚 目录

1. [半同步插件概述](#1-半同步插件概述)
2. [插件安装与配置](#2-插件安装与配置)
3. [插件状态检查与监控](#3-插件状态检查与监控)
4. [插件版本管理](#4-插件版本管理)
5. [插件卸载与维护](#5-插件卸载与维护)
6. [多从库环境的ACK聚合策略](#6-多从库环境的ACK聚合策略)
7. [故障排查与最佳实践](#7-故障排查与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔌 半同步插件概述


### 1.1 什么是MySQL半同步复制插件


**半同步复制插件**是MySQL提供的一个可选组件，用来增强普通异步复制的数据安全性。

> 💡 **通俗理解**：就像快递配送，普通复制是"扔了就走"，半同步复制是"必须等收件人签收确认"才算完成

**核心工作原理**：
```
异步复制：
主库写入 → 立即返回成功 → 从库稍后同步
风险：主库宕机可能丢失数据

半同步复制：
主库写入 → 等待从库确认 → 返回成功
优势：确保至少一个从库收到数据
```

### 1.2 插件架构组成


**主库插件**：`semisync_master.so`
- 负责等待从库的ACK确认
- 管理超时和降级策略
- 监控复制延迟

**从库插件**：`semisync_slave.so`  
- 负责发送ACK确认给主库
- 接收并应用binlog事件
- 参与ACK聚合策略

```
插件关系图：
┌─────────────┐    ACK确认    ┌─────────────┐
│   主库插件   │ ←─────────── │   从库插件   │
│semisync_    │              │semisync_    │
│master.so    │   binlog     │slave.so     │
│             │ ─────────→   │             │
└─────────────┘              └─────────────┘
```

### 1.3 插件类型说明


**原生半同步插件**（MySQL 5.5+）：
- `rpl_semi_sync_master`
- `rpl_semi_sync_slave`

**增强半同步插件**（MySQL 5.7+）：
- `semisync_master`  
- `semisync_slave`
- 提供更好的性能和稳定性

> ⚠️ **注意**：两种插件不能混用，必须主从库使用相同类型

---

## 2. ⚙️ 插件安装与配置


### 2.1 插件安装步骤


**Step 1：检查插件文件**
```sql
-- 检查插件目录
SHOW VARIABLES LIKE 'plugin_dir';

-- 查看可用插件文件
SHOW PLUGINS;
```

**Step 2：安装主库插件**
```sql
-- 安装增强版半同步主库插件
INSTALL PLUGIN semisync_master SONAME 'semisync_master.so';

-- 或者安装原生版本
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
```

**Step 3：安装从库插件**
```sql
-- 在每个从库上安装
INSTALL PLUGIN semisync_slave SONAME 'semisync_slave.so';

-- 或者原生版本
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
```

### 2.2 插件激活配置


**主库配置**：
```sql
-- 启用半同步复制
SET GLOBAL rpl_semi_sync_master_enabled = 1;

-- 设置超时时间（毫秒）
SET GLOBAL rpl_semi_sync_master_timeout = 1000;

-- 设置等待从库数量
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 1;
```

**从库配置**：
```sql
-- 启用半同步复制
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- 重启IO线程使配置生效
STOP SLAVE IO_THREAD;
START SLAVE IO_THREAD;
```

> 📝 **配置说明**：
> - `timeout`：等待ACK的最大时间，超时会降级为异步
> - `wait_for_slave_count`：需要多少个从库确认才算成功

### 2.3 持久化配置


**添加到配置文件**：
```ini
# my.cnf 主库配置
[mysqld]
plugin-load = "semisync_master=semisync_master.so"
rpl_semi_sync_master_enabled = 1
rpl_semi_sync_master_timeout = 1000
rpl_semi_sync_master_wait_for_slave_count = 1

# my.cnf 从库配置  
[mysqld]
plugin-load = "semisync_slave=semisync_slave.so"
rpl_semi_sync_slave_enabled = 1
```

---

## 3. 📊 插件状态检查与监控


### 3.1 插件状态查询


**查看已安装插件**：
```sql
-- 查看所有插件状态
SELECT 
    PLUGIN_NAME,
    PLUGIN_STATUS,
    PLUGIN_TYPE,
    PLUGIN_VERSION
FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME LIKE '%semi%';
```

**输出示例**：
```
+------------------+---------------+-------------+----------------+
| PLUGIN_NAME      | PLUGIN_STATUS | PLUGIN_TYPE | PLUGIN_VERSION |
+------------------+---------------+-------------+----------------+
| semisync_master  | ACTIVE        | REPLICATION | 1.0            |
+------------------+---------------+-------------+----------------+
```

### 3.2 半同步状态监控


**主库监控指标**：
```sql
-- 查看半同步状态
SHOW STATUS LIKE 'Rpl_semi_sync_master%';
```

**关键状态解释**：
| 状态变量 | 含义 | 正常值 |
|---------|------|--------|
| `Rpl_semi_sync_master_status` | 半同步是否激活 | `ON` |
| `Rpl_semi_sync_master_clients` | 半同步从库数量 | `≥1` |
| `Rpl_semi_sync_master_yes_tx` | 半同步提交事务数 | 递增 |
| `Rpl_semi_sync_master_no_tx` | 异步提交事务数 | 较少 |
| `Rpl_semi_sync_master_wait_sessions` | 等待ACK的会话数 | 视业务而定 |

**从库监控指标**：
```sql
-- 查看从库半同步状态
SHOW STATUS LIKE 'Rpl_semi_sync_slave%';
```

### 3.3 性能监控脚本


<details>
<summary>点击展开：半同步监控脚本</summary>

```bash
#!/bin/bash
# semisync_monitor.sh - 半同步复制监控脚本

echo "=== MySQL半同步复制状态监控 ==="
echo "时间: $(date)"
echo

# 检查主库状态
mysql -e "
SELECT 
    VARIABLE_NAME as '状态项',
    VARIABLE_VALUE as '当前值'
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN (
    'Rpl_semi_sync_master_status',
    'Rpl_semi_sync_master_clients', 
    'Rpl_semi_sync_master_yes_tx',
    'Rpl_semi_sync_master_no_tx',
    'Rpl_semi_sync_master_wait_sessions'
);"

echo
echo "=== 半同步效率分析 ==="

# 计算半同步成功率
mysql -e "
SELECT 
    ROUND(
        (SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME='Rpl_semi_sync_master_yes_tx') /
        (SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME='Rpl_semi_sync_master_yes_tx' +
         SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME='Rpl_semi_sync_master_no_tx') * 100, 2
    ) as '半同步成功率(%)';"
```

</details>

---

## 4. 🔄 插件版本管理


### 4.1 版本兼容性检查


**检查MySQL版本与插件兼容性**：
```sql
-- 查看MySQL版本
SELECT VERSION();

-- 查看插件版本
SELECT 
    PLUGIN_NAME,
    PLUGIN_VERSION,
    PLUGIN_DESCRIPTION
FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME LIKE '%semi%';
```

**版本对应关系**：
| MySQL版本 | 推荐插件 | 特性 |
|-----------|----------|------|
| 5.5 - 5.6 | `rpl_semi_sync_*` | 基础功能 |
| 5.7+ | `semisync_*` | 增强性能，支持ACK聚合 |
| 8.0+ | `semisync_*` | 完整支持，性能最优 |

### 4.2 插件升级策略


**升级前准备**：
```sql
-- 1. 备份当前配置
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM performance_schema.global_variables
WHERE VARIABLE_NAME LIKE '%semi_sync%';

-- 2. 记录当前状态
SHOW STATUS LIKE '%semi_sync%';
```

**升级步骤**：
```sql
-- 1. 停用旧插件（逐个从库操作）
SET GLOBAL rpl_semi_sync_slave_enabled = 0;
STOP SLAVE IO_THREAD;
UNINSTALL PLUGIN rpl_semi_sync_slave;

-- 2. 安装新插件
INSTALL PLUGIN semisync_slave SONAME 'semisync_slave.so';
SET GLOBAL rpl_semi_sync_slave_enabled = 1;
START SLAVE IO_THREAD;

-- 3. 最后升级主库
SET GLOBAL rpl_semi_sync_master_enabled = 0;
UNINSTALL PLUGIN rpl_semi_sync_master;
INSTALL PLUGIN semisync_master SONAME 'semisync_master.so';
SET GLOBAL rpl_semi_sync_master_enabled = 1;
```

> ⚠️ **升级注意事项**：
> - 必须先升级所有从库，最后升级主库
> - 升级过程中会短暂降级为异步复制
> - 建议在业务低峰期进行

---

## 5. 🗑️ 插件卸载与维护


### 5.1 安全卸载步骤


**Step 1：停用功能**
```sql
-- 主库停用
SET GLOBAL rpl_semi_sync_master_enabled = 0;

-- 从库停用
SET GLOBAL rpl_semi_sync_slave_enabled = 0;
STOP SLAVE IO_THREAD;
START SLAVE IO_THREAD;
```

**Step 2：卸载插件**
```sql
-- 卸载主库插件
UNINSTALL PLUGIN semisync_master;

-- 卸载从库插件  
UNINSTALL PLUGIN semisync_slave;
```

**Step 3：清理配置**
```sql
-- 移除配置文件中的相关配置
-- 注释或删除plugin-load行
-- 注释或删除rpl_semi_sync_*配置
```

### 5.2 插件故障恢复


**常见故障场景**：

**场景1：插件加载失败**
```sql
-- 错误：Can't open shared library
-- 解决：检查插件文件权限和路径
SHOW VARIABLES LIKE 'plugin_dir';
-- 确保文件存在且有执行权限
```

**场景2：版本不兼容**
```sql
-- 错误：Plugin version mismatch  
-- 解决：使用匹配的插件版本
SELECT VERSION(); -- 检查MySQL版本
-- 下载对应版本的插件文件
```

**场景3：依赖缺失**
```sql
-- 错误：undefined symbol
-- 解决：检查系统依赖库
ldd /usr/lib64/mysql/plugin/semisync_master.so
-- 安装缺失的依赖包
```

---

## 6. 🔄 多从库环境的ACK聚合策略


### 6.1 ACK聚合机制原理


在多从库环境中，主库需要决定**等待多少个从库确认**才算事务提交成功。

> 💡 **通俗类比**：就像群发消息，可以设置"至少3个人回复收到"才算发送成功

```
ACK聚合策略示意图：
        主库
        / | \
       /  |  \
   从库1 从库2 从库3
     ✓    ✓    ×     ← 需要等待几个ACK？
```

### 6.2 核心配置参数


**`rpl_semi_sync_master_wait_for_slave_count`**：
- **含义**：需要等待多少个从库的ACK确认
- **默认值**：1（至少1个从库确认）
- **取值范围**：1 到 从库数量

```sql
-- 设置等待2个从库确认
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 2;

-- 查看当前设置
SHOW VARIABLES LIKE 'rpl_semi_sync_master_wait_for_slave_count';
```

### 6.3 不同策略的特点对比


| 策略 | 配置值 | 数据安全性 | 性能影响 | 适用场景 |
|------|--------|-----------|----------|----------|
| **最小确认** | `1` | 🔸 一般 | ⚡ 影响小 | 一般业务 |
| **多数确认** | `>总数/2` | 🔶 较高 | ⚡⚡ 影响中等 | 重要业务 |
| **全部确认** | `=总数` | 🔴 最高 | ⚡⚡⚡ 影响最大 | 核心业务 |

### 6.4 ACK聚合策略配置示例


**3从库环境配置**：
```sql
-- 场景1：要求至少2个从库确认（推荐）
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 2;
SET GLOBAL rpl_semi_sync_master_timeout = 1000;

-- 场景2：要求所有从库确认（高安全性）
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 3;
SET GLOBAL rpl_semi_sync_master_timeout = 2000; -- 适当延长超时

-- 场景3：只要1个从库确认（高性能）
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 1;
SET GLOBAL rpl_semi_sync_master_timeout = 500;
```

### 6.5 动态调整策略


**根据从库状态动态调整**：
```sql
-- 检查当前活跃的半同步从库数量
SELECT 
    COUNT(*) as active_semisync_slaves
FROM performance_schema.replication_connection_status 
WHERE SERVICE_STATE = 'ON';

-- 根据活跃从库数量调整策略
-- 如果有3个活跃从库，设置等待2个
-- 如果只有2个活跃从库，设置等待1个
```

**自动化调整脚本示例**：
<details>
<summary>点击展开：动态调整脚本</summary>

```bash
#!/bin/bash
# auto_adjust_semisync.sh - 自动调整半同步策略

# 获取活跃从库数量
ACTIVE_SLAVES=$(mysql -N -e "
SELECT COUNT(*) 
FROM performance_schema.replication_connection_status 
WHERE SERVICE_STATE = 'ON'")

echo "当前活跃从库数量: $ACTIVE_SLAVES"

# 根据从库数量设置策略
if [ $ACTIVE_SLAVES -ge 3 ]; then
    # 3个或以上从库：要求2个确认
    TARGET_COUNT=2
elif [ $ACTIVE_SLAVES -eq 2 ]; then
    # 2个从库：要求1个确认  
    TARGET_COUNT=1
else
    # 1个或0个从库：降级为异步
    TARGET_COUNT=1
fi

echo "调整ACK等待数量为: $TARGET_COUNT"

mysql -e "SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = $TARGET_COUNT;"
```

</details>

---

## 7. 🔧 故障排查与最佳实践


### 7.1 常见问题诊断


**问题1：插件状态异常**
```sql
-- 症状：Rpl_semi_sync_master_status = OFF
-- 原因分析：
SHOW STATUS LIKE 'Rpl_semi_sync_master_clients';
-- 如果clients=0，说明没有半同步从库连接

-- 解决方案：
-- 1. 检查从库插件状态
-- 2. 重启从库IO线程
-- 3. 检查网络连接
```

**问题2：半同步频繁降级**
```sql
-- 症状：Rpl_semi_sync_master_no_tx持续增长
-- 原因：超时导致降级为异步复制

-- 诊断：检查延迟情况
SHOW STATUS LIKE 'Seconds_Behind_Master';

-- 解决：调整超时参数
SET GLOBAL rpl_semi_sync_master_timeout = 2000; -- 增加超时时间
```

### 7.2 性能优化建议


**网络优化**：
```sql
-- 调整网络相关参数
SET GLOBAL slave_net_timeout = 60;
SET GLOBAL sync_binlog = 1;

-- 启用binlog压缩（MySQL 8.0+）
SET GLOBAL binlog_transaction_compression = ON;
```

**超时策略**：
```sql
-- 根据网络环境调整超时
-- 局域网环境：500-1000ms
SET GLOBAL rpl_semi_sync_master_timeout = 1000;

-- 跨机房环境：2000-5000ms  
SET GLOBAL rpl_semi_sync_master_timeout = 3000;
```

### 7.3 监控告警设置


**关键监控指标**：
- **半同步状态**：`Rpl_semi_sync_master_status`
- **活跃从库数**：`Rpl_semi_sync_master_clients` 
- **超时降级率**：`Rpl_semi_sync_master_no_tx` / 总事务数
- **等待时间**：`Rpl_semi_sync_master_wait_time`

> 🚨 **告警阈值建议**：
> - 半同步状态为OFF时立即告警
> - 活跃从库数少于预期时告警
> - 超时降级率超过5%时告警

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 插件本质：半同步复制通过插件实现，需要主从库分别安装
🔸 ACK机制：主库等待从库确认，确保数据安全性
🔸 超时降级：网络延迟时自动降级为异步复制，保证可用性
🔸 版本兼容：不同MySQL版本对应不同插件，需要匹配使用
🔸 聚合策略：多从库环境可配置等待多少个确认
```

### 8.2 关键配置参数


**主库关键参数**：
- `rpl_semi_sync_master_enabled`：启用/禁用半同步
- `rpl_semi_sync_master_timeout`：ACK等待超时时间  
- `rpl_semi_sync_master_wait_for_slave_count`：需要确认的从库数量

**从库关键参数**：
- `rpl_semi_sync_slave_enabled`：启用/禁用半同步

### 8.3 最佳实践总结


**安装顺序**：
1. 先安装从库插件并启用
2. 最后安装主库插件并启用
3. 验证半同步状态正常

**监控要点**：
- 定期检查插件状态和版本
- 监控半同步成功率和降级情况
- 关注ACK等待时间和网络延迟

**故障预防**：
- 合理设置超时时间（平衡安全性和性能）
- 根据从库数量调整ACK聚合策略
- 建立完善的监控告警机制

### 8.4 实际应用指导


**适用场景**：
- ✅ 对数据一致性要求较高的业务
- ✅ 可以容忍轻微性能影响的环境
- ✅ 网络环境相对稳定的情况

**不适用场景**：
- ❌ 对性能要求极高的OLTP业务
- ❌ 网络环境不稳定的跨地域复制
- ❌ 从库数量过多的扇出复制

**核心记忆**：
- 半同步插件保数据，主从安装要匹配
- ACK确认等超时，降级异步保可用
- 多从聚合可配置，监控告警不可少
- 版本兼容要注意，升级顺序别搞错