---
title: 2、半同步复制配置
---
## 📚 目录

1. [半同步复制配置概述](#1-半同步复制配置概述)
2. [插件安装与启用](#2-插件安装与启用)
3. [主库配置详解](#3-主库配置详解)
4. [从库配置详解](#4-从库配置详解)
5. [配置验证与监控](#5-配置验证与监控)
6. [参数调优策略](#6-参数调优策略)
7. [最佳实践指南](#7-最佳实践指南)
8. [故障排除与维护](#8-故障排除与维护)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔧 半同步复制配置概述


### 1.1 配置前的准备工作


半同步复制的配置是在已有的主从复制基础上进行的**增强配置**。简单来说，就是给你的MySQL数据库**"加装一个保险装置"**，让数据传输更加可靠。

**配置的本质含义**：
```
普通复制：主库写完数据就算完事，不管从库有没有收到
半同步复制：主库写完数据后，必须等到至少一个从库确认收到，才算真正完成

就像寄快递：
- 普通复制 = 把包裹扔给快递员就走了
- 半同步复制 = 要等快递员签收确认单才离开
```

### 1.2 配置架构流程图


```
配置步骤总览：

主库(Master)                     从库(Slave)
     │                              │
     ├─ 1. 安装半同步插件            ├─ 1. 安装半同步插件
     ├─ 2. 启用master端插件         ├─ 2. 启用slave端插件
     ├─ 3. 设置master参数           ├─ 3. 设置slave参数
     ├─ 4. 配置超时时间             ├─ 4. 确认从库状态
     └─ 5. 验证配置状态             └─ 5. 验证配置状态
                │                              │
                └──────── 数据同步验证 ─────────┘
```

**配置的核心目标**：
- **可靠性提升**：确保关键数据不丢失
- **性能平衡**：在可靠性和性能间找到平衡点
- **自动切换**：异常时能自动降级到异步复制

---

## 2. 📦 插件安装与启用


### 2.1 半同步复制插件介绍


MySQL的半同步复制功能**不是默认开启的**，需要通过**插件的形式**来实现。这就像给你的汽车安装一个**行车记录仪**，需要单独购买和安装。

**插件的作用机制**：
```
MySQL默认能力：异步复制
插件增强能力：半同步复制

主库插件：rpl_semi_sync_master.so
- 负责等待从库的确认信号
- 控制超时时间和降级机制

从库插件：rpl_semi_sync_slave.so  
- 负责发送确认信号给主库
- 保证数据真正写入relay log
```

### 2.2 插件安装步骤


**第一步：检查插件是否可用**
```sql
-- 查看可用的半同步插件
SHOW PLUGINS;

-- 或者查看插件目录
SELECT * FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME LIKE '%semi_sync%';
```

**第二步：主库安装插件**
```sql
-- 在主库上安装master端插件
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';

-- 验证插件安装成功
SHOW PLUGINS LIKE '%semi_sync%';
```

**第三步：从库安装插件**
```sql
-- 在从库上安装slave端插件  
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';

-- 验证插件安装成功
SHOW PLUGINS LIKE '%semi_sync%';
```

### 2.3 插件兼容性检查


**版本兼容性要求**：
```
MySQL版本要求：
✅ MySQL 5.5及以上版本支持
✅ MySQL 5.7推荐版本
✅ MySQL 8.0完全支持

操作系统要求：
✅ Linux (推荐)
✅ Windows (支持)
✅ macOS (支持)
```

**插件状态检查**：
```sql
-- 检查插件加载状态
SELECT 
    PLUGIN_NAME,
    PLUGIN_STATUS,
    PLUGIN_TYPE
FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME LIKE '%semi_sync%';

-- 正常结果应该显示：
-- rpl_semi_sync_master | ACTIVE | REPLICATION
-- rpl_semi_sync_slave  | ACTIVE | REPLICATION
```

---

## 3. ⚙️ 主库配置详解


### 3.1 核心参数：rpl_semi_sync_master_enabled


这个参数是**半同步复制的总开关**，就像家里的总电闸一样重要。

**参数含义解释**：
```
rpl_semi_sync_master_enabled = ON/OFF

ON：启用半同步复制，主库会等待从库确认
OFF：关闭半同步复制，回到普通异步复制

默认值：OFF（为了向后兼容）
```

**启用方式**：
```sql
-- 动态启用（立即生效，重启后失效）
SET GLOBAL rpl_semi_sync_master_enabled = 1;

-- 查看当前状态
SHOW VARIABLES LIKE 'rpl_semi_sync_master_enabled';
```

### 3.2 超时参数：rpl_semi_sync_master_timeout


这个参数控制主库**最多等待多长时间**，就像设置闹钟一样。

**参数含义详解**：
```
rpl_semi_sync_master_timeout = 毫秒数

作用：主库等待从库确认的最长时间
超时后：自动降级为异步复制
默认值：10000毫秒（10秒）

实际意义：
- 设置太短：频繁降级，失去半同步意义
- 设置太长：主库等待时间过长，影响性能
```

**配置示例**：
```sql
-- 设置超时时间为5秒
SET GLOBAL rpl_semi_sync_master_timeout = 5000;

-- 设置超时时间为15秒（高延迟网络环境）
SET GLOBAL rpl_semi_sync_master_timeout = 15000;
```

### 3.3 等待策略参数详解


**rpl_semi_sync_master_wait_for_slave_count**：
```sql
-- 设置需要等待确认的从库数量
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 1;

参数含义：
- 1：至少1个从库确认（常用设置）
- 2：至少2个从库确认（高可用环境）
- 0：不等待任何从库（等于关闭半同步）
```

**rpl_semi_sync_master_wait_point**：
```sql
-- 设置等待时机
SET GLOBAL rpl_semi_sync_master_wait_point = 'AFTER_SYNC';

参数选项：
AFTER_SYNC：事务提交后等待（MySQL 5.7推荐）
AFTER_COMMIT：事务提交前等待（兼容老版本）
```

### 3.4 主库配置文件设置


**my.cnf配置示例**：
```ini
[mysqld]
# 半同步复制主库配置
plugin-load = "rpl_semi_sync_master=semisync_master.so"
rpl_semi_sync_master_enabled = 1
rpl_semi_sync_master_timeout = 10000
rpl_semi_sync_master_wait_for_slave_count = 1
rpl_semi_sync_master_wait_point = AFTER_SYNC

# 复制相关基础配置
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
```

---

## 4. 🔄 从库配置详解


### 4.1 核心参数：rpl_semi_sync_slave_enabled


这个参数是从库端的**半同步开关**，决定从库是否参与半同步复制。

**参数含义解释**：
```
rpl_semi_sync_slave_enabled = ON/OFF

ON：从库启用半同步，会发送确认信号给主库
OFF：从库不参与半同步，主库等不到确认会超时

实际意义：
就像收快递时是否签收回执
- ON = 收到包裹后签收确认单
- OFF = 收到包裹但不签收，快递员不知道你收到没有
```

**配置方式**：
```sql
-- 在从库上启用半同步
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- 查看当前状态
SHOW VARIABLES LIKE 'rpl_semi_sync_slave_enabled';
```

### 4.2 从库配置验证


**检查从库复制状态**：
```sql
-- 查看从库复制状态
SHOW SLAVE STATUS\G

-- 关注以下关键信息：
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes  
-- Seconds_Behind_Master: 0或很小的数字
```

**检查半同步状态**：
```sql
-- 查看半同步相关状态
SHOW STATUS LIKE 'Rpl_semi_sync_slave_status';

-- 结果应该显示：
-- Rpl_semi_sync_slave_status | ON
```

### 4.3 从库配置文件设置


**my.cnf配置示例**：
```ini
[mysqld]
# 半同步复制从库配置
plugin-load = "rpl_semi_sync_slave=semisync_slave.so"
rpl_semi_sync_slave_enabled = 1

# 复制相关基础配置
server-id = 2
relay-log = mysql-relay-bin
read-only = 1

# 从库优化参数
slave-parallel-type = LOGICAL_CLOCK
slave-parallel-workers = 4
```

### 4.4 多从库环境配置


当有多个从库时，配置策略：

```
架构示例：
       主库(Master)
      /      |      \
   从库1   从库2   从库3
   
配置原则：
- 所有从库都启用半同步
- 主库只需要等待1个从库确认
- 提供冗余保障，避免单点故障
```

**每个从库的配置**：
```sql
-- 从库1配置
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- 从库2配置  
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- 从库3配置
SET GLOBAL rpl_semi_sync_slave_enabled = 1;
```

---

## 5. ✅ 配置验证与监控


### 5.1 半同步状态验证


配置完成后，需要验证半同步复制是否正常工作。

**主库状态检查**：
```sql
-- 检查主库半同步状态
SHOW STATUS LIKE 'Rpl_semi_sync_master_status';
-- 结果：Rpl_semi_sync_master_status | ON

-- 检查等待的从库数量
SHOW STATUS LIKE 'Rpl_semi_sync_master_clients';
-- 结果：Rpl_semi_sync_master_clients | 1 (或实际从库数量)

-- 检查是否有超时
SHOW STATUS LIKE 'Rpl_semi_sync_master_timeouts';
-- 结果：应该是0或很小的数字
```

**从库状态检查**：
```sql
-- 检查从库半同步状态
SHOW STATUS LIKE 'Rpl_semi_sync_slave_status';
-- 结果：Rpl_semi_sync_slave_status | ON
```

### 5.2 功能测试验证


**实际数据测试**：
```sql
-- 在主库创建测试表
CREATE TABLE test_semi_sync (
    id INT PRIMARY KEY,
    data VARCHAR(100),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入测试数据
INSERT INTO test_semi_sync (id, data) VALUES (1, 'test data');

-- 在从库检查数据是否同步
SELECT * FROM test_semi_sync;
```

**性能测试**：
```sql
-- 插入大量数据测试性能影响
INSERT INTO test_semi_sync (id, data) 
SELECT n, CONCAT('test_data_', n) 
FROM (
    SELECT @row := @row + 1 as n 
    FROM information_schema.columns, (SELECT @row := 1) r 
    LIMIT 1000
) t;
```

### 5.3 监控关键指标


**建立监控体系**：

| 监控指标 | 含义 | 正常值 | 异常处理 |
|---------|------|--------|----------|
| `Rpl_semi_sync_master_status` | 主库半同步状态 | ON | 检查从库连接 |
| `Rpl_semi_sync_master_clients` | 参与半同步的从库数 | ≥1 | 检查从库配置 |
| `Rpl_semi_sync_master_timeouts` | 超时次数 | 0或很少 | 检查网络延迟 |
| `Rpl_semi_sync_master_wait_time` | 平均等待时间 | <1000ms | 优化网络或参数 |

**监控SQL脚本**：
```sql
-- 创建监控视图
CREATE VIEW semi_sync_monitor AS
SELECT 
    'Master Status' as metric,
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_status') as value
UNION ALL
SELECT 
    'Connected Slaves',
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_clients')
UNION ALL  
SELECT 
    'Timeout Count',
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_timeouts');
```

---

## 6. 🚀 参数调优策略


### 6.1 超时时间调优


**rpl_semi_sync_master_timeout** 是最关键的调优参数。

**调优原则**：
```
网络环境好（局域网）：
- 设置较短超时：3000-5000ms
- 优点：快速发现问题，及时降级
- 缺点：可能因为短暂网络抖动降级

网络环境一般（跨机房）：
- 设置中等超时：10000-15000ms  
- 平衡可靠性和性能

网络环境差（跨地域）：
- 设置较长超时：15000-30000ms
- 优点：避免频繁降级
- 缺点：主库等待时间长
```

**动态调优方法**：
```sql
-- 监控当前平均等待时间
SHOW STATUS LIKE 'Rpl_semi_sync_master_avg_net_wait_time';

-- 如果平均等待时间经常接近超时值，说明超时设置过短
-- 如果平均等待时间远小于超时值，可以适当缩短超时

-- 动态调整超时时间
SET GLOBAL rpl_semi_sync_master_timeout = 8000;
```

### 6.2 等待从库数量调优


**rpl_semi_sync_master_wait_for_slave_count** 决定可靠性级别。

**调优策略**：
```
高可用要求不高的环境：
wait_for_slave_count = 1
- 只要有1个从库确认即可
- 性能影响最小
- 适合大多数场景

高可用要求很高的环境：
wait_for_slave_count = 2  
- 需要2个从库确认
- 可靠性更高
- 性能影响较大
- 需要至少3个从库
```

**配置建议**：
```sql
-- 查看当前连接的从库数量
SHOW STATUS LIKE 'Rpl_semi_sync_master_clients';

-- 根据从库数量设置等待数量
-- 如果有3个从库，可以设置等待2个
SET GLOBAL rpl_semi_sync_master_wait_for_slave_count = 2;
```

### 6.3 自动化调优策略


**监控驱动的调优**：
```sql
-- 创建调优脚本存储过程
DELIMITER //
CREATE PROCEDURE AutoTuneSemiSync()
BEGIN
    DECLARE timeout_count INT DEFAULT 0;
    DECLARE avg_wait_time INT DEFAULT 0;
    
    -- 获取超时次数
    SELECT VARIABLE_VALUE INTO timeout_count 
    FROM performance_schema.global_status 
    WHERE VARIABLE_NAME='Rpl_semi_sync_master_timeouts';
    
    -- 获取平均等待时间  
    SELECT VARIABLE_VALUE INTO avg_wait_time
    FROM performance_schema.global_status 
    WHERE VARIABLE_NAME='Rpl_semi_sync_master_avg_net_wait_time';
    
    -- 根据监控数据调整参数
    IF timeout_count > 100 AND avg_wait_time > 5000 THEN
        -- 超时过多且等待时间长，增加超时时间
        SET @new_timeout = (SELECT $$rpl_semi_sync_master_timeout) + 2000;
        SET GLOBAL rpl_semi_sync_master_timeout = @new_timeout;
        
    ELSEIF timeout_count = 0 AND avg_wait_time < 1000 THEN
        -- 没有超时且等待时间短，可以减少超时时间
        SET @new_timeout = (SELECT $$rpl_semi_sync_master_timeout) - 1000;
        IF @new_timeout >= 3000 THEN
            SET GLOBAL rpl_semi_sync_master_timeout = @new_timeout;
        END IF;
    END IF;
END //
DELIMITER ;
```

---

## 7. 📋 最佳实践指南


### 7.1 配置最佳实践


**生产环境推荐配置**：
```ini
# 主库配置 (my.cnf)
[mysqld]
# 半同步复制插件
plugin-load = "rpl_semi_sync_master=semisync_master.so"
rpl_semi_sync_master_enabled = 1
rpl_semi_sync_master_timeout = 10000
rpl_semi_sync_master_wait_for_slave_count = 1
rpl_semi_sync_master_wait_point = AFTER_SYNC

# 基础复制配置
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1
```

```ini
# 从库配置 (my.cnf)  
[mysqld]
# 半同步复制插件
plugin-load = "rpl_semi_sync_slave=semisync_slave.so"
rpl_semi_sync_slave_enabled = 1

# 基础复制配置
server-id = 2
relay-log = mysql-relay-bin
read-only = 1
super-read-only = 1
```

### 7.2 运维最佳实践


**配置管理规范**：
```bash
# 1. 配置变更前备份
mysqldump --single-transaction --routines --triggers \
    --all-databases > backup_before_semi_sync.sql

# 2. 配置变更记录
echo "$(date): Enable semi-sync replication" >> /var/log/mysql_config_changes.log

# 3. 配置验证脚本
#!/bin/bash
check_semi_sync() {
    master_status=$(mysql -e "SHOW STATUS LIKE 'Rpl_semi_sync_master_status';" | grep ON)
    slave_status=$(mysql -e "SHOW STATUS LIKE 'Rpl_semi_sync_slave_status';" | grep ON)
    
    if [[ -n "$master_status" && -n "$slave_status" ]]; then
        echo "Semi-sync replication is working correctly"
    else
        echo "Semi-sync replication has issues"
    fi
}
```

### 7.3 监控告警实践


**关键指标监控**：
```sql
-- 创建监控表
CREATE TABLE semi_sync_monitor_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    master_status VARCHAR(10),
    slave_count INT,
    timeout_count INT,
    avg_wait_time INT
);

-- 定期记录监控数据
INSERT INTO semi_sync_monitor_log 
(master_status, slave_count, timeout_count, avg_wait_time)
SELECT 
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_status'),
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_clients'),
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_timeouts'),
    (SELECT VARIABLE_VALUE FROM performance_schema.global_status 
     WHERE VARIABLE_NAME='Rpl_semi_sync_master_avg_net_wait_time');
```

---

## 8. 🔍 故障排除与维护


### 8.1 常见问题诊断


**问题1：半同步状态显示OFF**
```sql
-- 诊断步骤
SHOW STATUS LIKE 'Rpl_semi_sync_master_status';

-- 可能原因：
-- 1. 插件未安装或加载失败
SHOW PLUGINS LIKE '%semi_sync%';

-- 2. 参数未启用
SHOW VARIABLES LIKE 'rpl_semi_sync_master_enabled';

-- 3. 从库未连接或未启用半同步
SHOW STATUS LIKE 'Rpl_semi_sync_master_clients';
```

**问题2：频繁超时降级**
```sql
-- 检查超时次数
SHOW STATUS LIKE 'Rpl_semi_sync_master_timeouts';

-- 检查网络延迟
SHOW STATUS LIKE 'Rpl_semi_sync_master_avg_net_wait_time';

-- 解决方案：
-- 1. 增加超时时间
SET GLOBAL rpl_semi_sync_master_timeout = 15000;

-- 2. 检查网络状况
-- 3. 优化从库性能
```

### 8.2 热更新机制


**安全的参数调整流程**：
```sql
-- 1. 记录当前配置
SELECT 
    $$rpl_semi_sync_master_enabled as master_enabled,
    $$rpl_semi_sync_master_timeout as timeout_ms,
    $$rpl_semi_sync_master_wait_for_slave_count as wait_count;

-- 2. 逐步调整参数
SET GLOBAL rpl_semi_sync_master_timeout = 12000;

-- 3. 观察效果
SHOW STATUS LIKE 'Rpl_semi_sync_master_timeouts';

-- 4. 确认无问题后更新配置文件
```

### 8.3 故障恢复流程


**半同步复制失效恢复**：
```
故障处理流程图：

发现半同步失效
       │
       ├─ 检查插件状态
       ├─ 检查网络连接
       ├─ 检查从库状态
       │
       ├─ 临时关闭半同步（紧急情况）
       │   SET GLOBAL rpl_semi_sync_master_enabled = 0;
       │
       ├─ 修复根本问题
       │   ├─ 重启从库复制
       │   ├─ 修复网络问题  
       │   └─ 调整参数配置
       │
       └─ 重新启用半同步
           SET GLOBAL rpl_semi_sync_master_enabled = 1;
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 半同步复制配置本质：在异步复制基础上增加确认机制
🔸 插件安装：主库和从库分别安装对应的半同步插件
🔸 核心参数：rpl_semi_sync_master_enabled 和 rpl_semi_sync_slave_enabled
🔸 超时机制：通过 rpl_semi_sync_master_timeout 控制等待时间
🔸 降级保护：超时后自动降级为异步复制，保证可用性
```

### 9.2 关键配置要点


**🔹 配置顺序很重要**
```
正确顺序：
1. 安装插件
2. 启用插件  
3. 配置参数
4. 验证状态
5. 监控运行

错误做法：直接修改参数而不安装插件
```

**🔹 参数调优原则**
```
超时时间设置：
- 局域网环境：3-5秒
- 跨机房环境：10-15秒  
- 跨地域环境：15-30秒

从库数量设置：
- 一般情况：等待1个从库确认
- 高可用要求：等待2个从库确认
```

**🔹 配置持久化**
```
动态配置：立即生效，重启失效
配置文件：重启后仍然有效
最佳实践：动态测试 + 配置文件保存
```

### 9.3 实际应用价值


- **数据安全保障**：确保关键数据不丢失
- **故障快速发现**：通过监控及时发现复制问题  
- **性能影响可控**：通过参数调优平衡性能和可靠性
- **运维自动化**：支持脚本化配置和监控

**核心记忆口诀**：
- 插件安装是前提，主从分别要配齐
- 启用参数是关键，超时设置要合理
- 监控验证不可少，故障处理要及时
- 配置文件要同步，重启生效保稳定