---
title: 7ã€å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’æ¦‚è¿°](#1-å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’æ¦‚è¿°)
2. [é¡µé¢è¯»å–æµç¨‹æœºåˆ¶](#2-é¡µé¢è¯»å–æµç¨‹æœºåˆ¶)
3. [é¡µé¢å†™å…¥æœºåˆ¶è¯¦è§£](#3-é¡µé¢å†™å…¥æœºåˆ¶è¯¦è§£)
4. [ç¼“å­˜ä¸å­˜å‚¨åŒæ­¥ç­–ç•¥](#4-ç¼“å­˜ä¸å­˜å‚¨åŒæ­¥ç­–ç•¥)
5. [æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶](#5-æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶)
6. [å´©æºƒæ¢å¤åè°ƒå¤„ç†](#6-å´©æºƒæ¢å¤åè°ƒå¤„ç†)
7. [IOä¼˜åŒ–ç­–ç•¥å®ç°](#7-ioä¼˜åŒ–ç­–ç•¥å®ç°)
8. [ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–æŠ€æœ¯](#8-ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–æŠ€æœ¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä¸€ä¸‹å›¾ä¹¦é¦†çš„è¿ä½œæ–¹å¼ï¼šBuffer Poolå°±åƒæ˜¯é˜…è§ˆå®¤çš„æ¡Œå­ï¼Œå­˜å‚¨å±‚å°±åƒæ˜¯ä¹¦åº“ã€‚è¯»è€…éœ€è¦çœ‹ä¹¦æ—¶ï¼Œç®¡ç†å‘˜ä¼šä»ä¹¦åº“å–ä¹¦æ”¾åˆ°æ¡Œå­ä¸Šï¼›è¯»è€…çœ‹å®Œåï¼Œç®¡ç†å‘˜ä¼šæŠŠä¹¦æ”¶å›ä¹¦åº“ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯å­˜å‚¨å±‚ä¸ç¼“å†²æ± çš„äº¤äº’ã€‚

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
å­˜å‚¨å±‚ä¸ç¼“å†²æ± äº¤äº’ï¼š
â€¢ Buffer Poolï¼šå†…å­˜ä¸­çš„æ•°æ®é¡µç¼“å­˜åŒºåŸŸ
â€¢ å­˜å‚¨å±‚ï¼šç£ç›˜ä¸Šçš„æ•°æ®æ–‡ä»¶ç³»ç»Ÿ
â€¢ äº¤äº’è¿‡ç¨‹ï¼šå†…å­˜ä¸ç£ç›˜ä¹‹é—´çš„æ•°æ®ä¼ è¾“åè°ƒ

ç›®æ ‡ï¼š
â€¢ æœ€å¤§åŒ–å†…å­˜å‘½ä¸­ç‡
â€¢ æœ€å°åŒ–ç£ç›˜IOå¼€é”€
â€¢ ä¿è¯æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
```

### 1.2 äº¤äº’æ¶æ„æ•´ä½“è§†å›¾


```
åº”ç”¨å±‚æŸ¥è¯¢è¯·æ±‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SQLæ‰§è¡Œå¼•æ“    â”‚ â† è§£ææŸ¥è¯¢ï¼Œç¡®å®šéœ€è¦çš„é¡µé¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Buffer Pool    â”‚ â† å†…å­˜ç¼“å­˜æ± ï¼ˆæ ¸å¿ƒäº¤äº’å±‚ï¼‰
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ•°æ®é¡µç¼“å­˜  â”‚ â”‚ â† ç¼“å­˜æ•°æ®é¡µ
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ç´¢å¼•é¡µç¼“å­˜  â”‚ â”‚ â† ç¼“å­˜ç´¢å¼•é¡µ
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ æ—¥å¿—ç¼“å­˜    â”‚ â”‚ â† ç¼“å­˜redo log
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ â†‘ (IOæ“ä½œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å­˜å‚¨å±‚       â”‚ â† ç£ç›˜æ–‡ä»¶ç³»ç»Ÿ
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  .ibdæ–‡ä»¶   â”‚ â”‚ â† è¡¨æ•°æ®æ–‡ä»¶
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ redo log    â”‚ â”‚ â† é‡åšæ—¥å¿—æ–‡ä»¶
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ undo log    â”‚ â”‚ â† å›æ»šæ—¥å¿—æ–‡ä»¶
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 äº¤äº’çš„æ ¸å¿ƒä»·å€¼


**âš¡ æ€§èƒ½ä¼˜åŒ–ä»·å€¼**
```
å†…å­˜è®¿é—® vs ç£ç›˜è®¿é—®ï¼š
â€¢ å†…å­˜è®¿é—®ï¼šçº³ç§’çº§åˆ«ï¼ˆ~10nsï¼‰
â€¢ ç£ç›˜è®¿é—®ï¼šæ¯«ç§’çº§åˆ«ï¼ˆ~10msï¼‰
â€¢ æ€§èƒ½å·®è·ï¼šçº¦100ä¸‡å€ï¼

ç¼“å†²æ± çš„ä½œç”¨ï¼š
â€¢ å‡å°‘ç£ç›˜IOæ¬¡æ•°
â€¢ æé«˜æ•°æ®è®¿é—®é€Ÿåº¦
â€¢ æ”¯æŒæ•°æ®é¢„è¯»å’Œæ‰¹é‡å†™
```

**ğŸ”’ æ•°æ®å®‰å…¨ä»·å€¼**
```
åŒé‡ä¿éšœæœºåˆ¶ï¼š
â€¢ WALæœºåˆ¶ï¼šå…ˆå†™æ—¥å¿—å†å†™æ•°æ®
â€¢ ç¼“å†²æ± ç®¡ç†ï¼šæ§åˆ¶è„é¡µåˆ·æ–°æ—¶æœº
â€¢ å´©æºƒæ¢å¤ï¼šé€šè¿‡æ—¥å¿—æ¢å¤æœªæäº¤æ•°æ®
```

---

## 2. ğŸ“– é¡µé¢è¯»å–æµç¨‹æœºåˆ¶


### 2.1 é¡µé¢è¯»å–çš„åŸºæœ¬æµç¨‹


**ğŸ” å®Œæ•´è¯»å–æµç¨‹å›¾**
```
æŸ¥è¯¢è¯·æ±‚
    â†“
æ£€æŸ¥Buffer Pool
    â†“
â”Œâ”€ ç¼“å­˜å‘½ä¸­ï¼Ÿ â”€â”
â”‚              â”‚
YES             NO
â†“               â†“
ç›´æ¥è¿”å›æ•°æ®    ä»ç£ç›˜è¯»å–
                â†“
              åˆ†é…ç¼“å­˜é¡µ
                â†“
              åŠ è½½åˆ°å†…å­˜
                â†“
              æ›´æ–°LRUé“¾è¡¨
                â†“
              è¿”å›æ•°æ®
```

### 2.2 ç¼“å­˜å‘½ä¸­å¤„ç†æœºåˆ¶


**âœ… ç¼“å­˜å‘½ä¸­çš„å¤„ç†æ­¥éª¤**

```sql
-- æ¨¡æ‹ŸæŸ¥è¯¢è¿‡ç¨‹
SELECT * FROM users WHERE id = 12345;
```

```
Step 1: é¡µé¢å®šä½
â€¢ æ ¹æ®è¡¨ç©ºé—´ID + é¡µå·è®¡ç®—hashå€¼
â€¢ åœ¨Buffer Poolçš„hashè¡¨ä¸­æŸ¥æ‰¾
â€¢ hash(space_id, page_no) â†’ buffer_pageä½ç½®

Step 2: é¡µé¢çŠ¶æ€æ£€æŸ¥
â€¢ æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹ä½¿ç”¨
â€¢ æ£€æŸ¥é¡µé¢çš„latchçŠ¶æ€ï¼ˆè¯»é”/å†™é”ï¼‰
â€¢ ç¡®è®¤é¡µé¢æ•°æ®çš„æœ‰æ•ˆæ€§

Step 3: LRUé“¾è¡¨æ›´æ–°
â€¢ å°†è®¿é—®çš„é¡µé¢ç§»åŠ¨åˆ°LRUé“¾è¡¨å¤´éƒ¨
â€¢ æ›´æ–°é¡µé¢çš„è®¿é—®æ—¶é—´æˆ³
â€¢ è°ƒæ•´hotåŒºåŸŸå’ŒcoldåŒºåŸŸçš„æ¯”ä¾‹
```

**ğŸ¯ å…³é”®æ€§èƒ½æŒ‡æ ‡**
```
ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—ï¼š
å‘½ä¸­ç‡ = ç¼“å­˜å‘½ä¸­æ¬¡æ•° / æ€»è®¿é—®æ¬¡æ•° Ã— 100%

ç†æƒ³çŠ¶æ€ï¼š
â€¢ åœ¨çº¿äº‹åŠ¡å¤„ç†(OLTP)ï¼š>95%
â€¢ æ•°æ®ä»“åº“(OLAP)ï¼š>85%
â€¢ æ–°ç³»ç»Ÿå¯åŠ¨ï¼šé€æ­¥æå‡åˆ°ç›®æ ‡å€¼
```

### 2.3 ç¼“å­˜æœªå‘½ä¸­å¤„ç†æœºåˆ¶


**âŒ ç¼“å­˜æœªå‘½ä¸­çš„è¯¦ç»†æµç¨‹**

**Step 1: ç©ºé—²é¡µé¢è·å–**
```
ç©ºé—²é¡µé¢æ¥æºä¼˜å…ˆçº§ï¼š
1. Free Listï¼ˆç©ºé—²é¡µé“¾è¡¨ï¼‰
2. LRU Listå°¾éƒ¨çš„cleané¡µé¢
3. å¼ºåˆ¶åˆ·æ–°è„é¡µè·å¾—ç©ºé—´

è·å–ç­–ç•¥ï¼š
â”Œâ”€ æœ‰ç©ºé—²é¡µï¼Ÿ â”€â”
â”‚              â”‚
YES             NO
â†“               â†“
ç›´æ¥åˆ†é…        LRUæ·˜æ±°ç®—æ³•
                â†“
              æ£€æŸ¥è„é¡µ
                â†“
              â”Œâ”€ æ˜¯è„é¡µï¼Ÿ â”€â”
              â”‚            â”‚
              YES          NO
              â†“            â†“
            åˆ·æ–°åˆ°ç£ç›˜    ç›´æ¥æ›¿æ¢
```

**Step 2: ç£ç›˜IOè¯»å–**
```cpp
// ç®€åŒ–çš„é¡µé¢è¯»å–é€»è¾‘
bool read_page_from_disk(space_id, page_no, buffer_page) {
    // 1. å®šä½æ–‡ä»¶ä½ç½®
    offset = page_no * INNODB_PAGE_SIZE;
    
    // 2. æ‰§è¡ŒIOè¯»å–
    bytes_read = pread(file_fd, buffer_page->data, 
                      INNODB_PAGE_SIZE, offset);
    
    // 3. æ ¡éªŒé¡µé¢å®Œæ•´æ€§
    if (!validate_page_checksum(buffer_page)) {
        return false; // é¡µé¢æŸå
    }
    
    return true;
}
```

**Step 3: ç¼“å­˜é¡µé¢åˆå§‹åŒ–**
```
é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ï¼š
â€¢ è®¾ç½®é¡µé¢çŠ¶æ€ä¸ºBUF_IO_READ
â€¢ åˆ†é…æ§åˆ¶å—å¹¶å»ºç«‹æ˜ å°„å…³ç³»
â€¢ åˆå§‹åŒ–é¡µé¢çš„latchæœºåˆ¶
â€¢ å°†é¡µé¢æ’å…¥åˆ°hashè¡¨å’ŒLRUé“¾è¡¨
â€¢ æ›´æ–°Buffer Poolç»Ÿè®¡ä¿¡æ¯
```

### 2.4 é¢„è¯»æœºåˆ¶ä¼˜åŒ–


**ğŸ“ˆ çº¿æ€§é¢„è¯»(Linear Read-ahead)**
```
è§¦å‘æ¡ä»¶ï¼š
â€¢ è¿ç»­è®¿é—®åŒä¸€ä¸ªextentä¸­çš„å¤šä¸ªé¡µé¢
â€¢ é»˜è®¤é˜ˆå€¼ï¼šè¿ç»­è®¿é—®56ä¸ªé¡µé¢

é¢„è¯»é€»è¾‘ï¼š
if (è¿ç»­è®¿é—®çš„é¡µé¢æ•° >= innodb_read_ahead_threshold) {
    é¢„è¯»ä¸‹ä¸€ä¸ªextentçš„æ‰€æœ‰é¡µé¢;
}

ä¼˜åŠ¿ï¼š
â€¢ å‡å°‘éšæœºIOï¼Œæå‡é¡ºåºè¯»æ€§èƒ½
â€¢ å¯¹èŒƒå›´æŸ¥è¯¢ç‰¹åˆ«æœ‰æ•ˆ
```

**ğŸ¯ éšæœºé¢„è¯»(Random Read-ahead)**
```
è§¦å‘æ¡ä»¶ï¼š
â€¢ åœ¨ä¸€ä¸ªextentä¸­éšæœºè®¿é—®äº†13ä¸ªé¡µé¢
â€¢ ä¸”è¿™äº›é¡µé¢éƒ½åœ¨Buffer Poolçš„youngåŒºåŸŸ

é€‚ç”¨åœºæ™¯ï¼š
â€¢ å¤§è¡¨çš„éšæœºæŸ¥è¯¢
â€¢ ç´¢å¼•æ‰«ææ“ä½œ
â€¢ JOINæ“ä½œä¸­çš„è¡¨è¿æ¥
```

**ğŸ’¡ é¢„è¯»æ•ˆæœç›‘æ§**
```sql
-- æŸ¥çœ‹é¢„è¯»ç»Ÿè®¡ä¿¡æ¯
SHOW STATUS LIKE 'Innodb_buffer_pool_read_ahead%';

-- å…³é”®æŒ‡æ ‡ï¼š
-- Innodb_buffer_pool_read_ahead: é¢„è¯»é¡µé¢æ•°
-- Innodb_buffer_pool_read_ahead_evicted: é¢„è¯»åè¢«æ·˜æ±°çš„é¡µé¢æ•°
-- é¢„è¯»æ•ˆç‡ = (é¢„è¯»é¡µé¢æ•° - è¢«æ·˜æ±°é¡µé¢æ•°) / é¢„è¯»é¡µé¢æ•°
```

---

## 3. ğŸ’¾ é¡µé¢å†™å…¥æœºåˆ¶è¯¦è§£


### 3.1 è„é¡µçš„äº§ç”Ÿä¸ç®¡ç†


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> è„é¡µå°±åƒæ˜¯ä½ åœ¨è‰ç¨¿çº¸ä¸Šä¿®æ”¹çš„æ–‡æ¡£ï¼Œè™½ç„¶å†…å®¹å·²ç»æ”¹äº†ï¼Œä½†è¿˜æ²¡æœ‰ä¿å­˜åˆ°æ­£å¼æ–‡ä»¶ä¸­ã€‚MySQLéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºæŠŠè¿™äº›"è‰ç¨¿"å†™å›ç£ç›˜çš„"æ­£å¼æ–‡ä»¶"ã€‚

**ğŸ”¸ è„é¡µäº§ç”Ÿè¿‡ç¨‹**
```
æ•°æ®ä¿®æ”¹æ“ä½œï¼š
UPDATE users SET name = 'newname' WHERE id = 123;

äº§ç”Ÿè„é¡µçš„æ­¥éª¤ï¼š
1. å®šä½ç›®æ ‡é¡µé¢ï¼ˆè¯»å–åˆ°Buffer Poolï¼‰
2. åœ¨å†…å­˜ä¸­ä¿®æ”¹é¡µé¢å†…å®¹
3. æ ‡è®°é¡µé¢ä¸º"dirty"çŠ¶æ€
4. è®°å½•ä¿®æ”¹åˆ°redo log buffer
5. é¡µé¢åŠ å…¥åˆ°flush listé“¾è¡¨
```

**ğŸ“Š è„é¡µçŠ¶æ€ç®¡ç†**
```
è„é¡µçš„ä¸‰ç§çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Clean     â”‚ â† ä¸ç£ç›˜æ•°æ®ä¸€è‡´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Dirty     â”‚ â† å·²ä¿®æ”¹ï¼Œç­‰å¾…åˆ·æ–°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Flushing   â”‚ â† æ­£åœ¨å†™å…¥ç£ç›˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€è½¬æ¢ï¼š
Clean â”€â”€ä¿®æ”¹â”€â”€> Dirty â”€â”€åˆ·æ–°â”€â”€> Flushing â”€â”€å®Œæˆâ”€â”€> Clean
```

### 3.2 è„é¡µåˆ·æ–°ç­–ç•¥


**â° åˆ·æ–°è§¦å‘æ—¶æœº**

**1. Checkpointæœºåˆ¶è§¦å‘**
```
Sharp Checkpointï¼ˆå°–é”æ£€æŸ¥ç‚¹ï¼‰ï¼š
â€¢ æ•°æ®åº“å…³é—­æ—¶
â€¢ åˆ·æ–°æ‰€æœ‰è„é¡µåˆ°ç£ç›˜
â€¢ ç¡®ä¿æ•°æ®å®Œæ•´æ€§

Fuzzy Checkpointï¼ˆæ¨¡ç³Šæ£€æŸ¥ç‚¹ï¼‰ï¼š
â€¢ è¿è¡Œè¿‡ç¨‹ä¸­çš„åå°åˆ·æ–°
â€¢ é¿å…é›†ä¸­IOé€ æˆæ€§èƒ½å†²å‡»
â€¢ æŒç»­ä¿æŒæ•°æ®ä¸€è‡´æ€§
```

**2. Buffer Poolç©ºé—´å‹åŠ›**
```
åˆ·æ–°è§¦å‘é˜ˆå€¼ï¼š
â€¢ innodb_max_dirty_pages_pct: é»˜è®¤75%
â€¢ è„é¡µæ¯”ä¾‹è¶…è¿‡é˜ˆå€¼æ—¶å¼ºåˆ¶åˆ·æ–°
â€¢ ä¿è¯è¶³å¤Ÿçš„cleané¡µé¢ä¾›åˆ†é…ä½¿ç”¨

åˆ·æ–°å¼ºåº¦æ§åˆ¶ï¼š
if (è„é¡µæ¯”ä¾‹ > 90%) {
    åˆ·æ–°å¼ºåº¦ = æœ€å¤§å€¼;
} else if (è„é¡µæ¯”ä¾‹ > 75%) {
    åˆ·æ–°å¼ºåº¦ = çº¿æ€§è°ƒæ•´;
} else {
    åˆ·æ–°å¼ºåº¦ = æœ€å°å€¼;
}
```

**3. Redo Logç©ºé—´å‹åŠ›**
```
LSNæ¨è¿›æœºåˆ¶ï¼š
â€¢ Redo logæ˜¯å¾ªç¯ä½¿ç”¨çš„
â€¢ å½“redo logç©ºé—´ä¸è¶³æ—¶
â€¢ å¿…é¡»åˆ·æ–°å¯¹åº”çš„è„é¡µé‡Šæ”¾redo logç©ºé—´

å…¬å¼ï¼š
éœ€è¦åˆ·æ–°çš„æœ€å°LSN = å½“å‰LSN - redo_log_capacity
```

### 3.3 æ‰¹é‡å†™å…¥ä¼˜åŒ–


**ğŸ“¦ é¡µé¢æ’åºä¸åˆå¹¶**
```cpp
// ç®€åŒ–çš„æ‰¹é‡å†™å…¥é€»è¾‘
void flush_pages_batch(page_list) {
    // 1. æŒ‰ç…§ (space_id, page_no) æ’åº
    sort(page_list, [](page_a, page_b) {
        if (page_a.space_id != page_b.space_id) 
            return page_a.space_id < page_b.space_id;
        return page_a.page_no < page_b.page_no;
    });
    
    // 2. åˆå¹¶è¿ç»­é¡µé¢ä¸ºé¡ºåºIO
    for (auto& segment : merge_continuous_pages(page_list)) {
        writev(segment.fd, segment.pages, segment.count);
    }
}
```

**âš¡ åŒå†™ç¼“å†²åŒº(Doublewrite Buffer)**
```
åŒå†™æœºåˆ¶åŸç†ï¼š
1. å…ˆå°†è„é¡µå†™å…¥doublewrite buffer
2. å†å°†è„é¡µå†™å…¥å®é™…çš„æ•°æ®æ–‡ä»¶ä½ç½®
3. å¦‚æœç¬¬äºŒæ­¥å¤±è´¥ï¼Œå¯ä»¥ä»doublewrite bufferæ¢å¤

é˜²æ­¢çš„é—®é¢˜ï¼š
â€¢ Partial page writeï¼ˆé¡µé¢éƒ¨åˆ†å†™å…¥ï¼‰
â€¢ æ“ä½œç³»ç»Ÿå´©æºƒå¯¼è‡´çš„æ•°æ®æŸå
â€¢ ç¡¬ä»¶æ•…éšœå¼•èµ·çš„å†™å…¥å¼‚å¸¸

å†™å…¥æµç¨‹ï¼š
è„é¡µ â”€â”€â‘  å†™å…¥â”€â”€> Doublewrite Buffer â”€â”€â‘¡ å†™å…¥â”€â”€> æ•°æ®æ–‡ä»¶
     â†â”€â‘¢ ç¡®è®¤â”€â”€â”€ â†â”€â”€â”€â”€â”€â”€â‘£ ç¡®è®¤â”€â”€â”€â”€â”€â”€
```

**ğŸ¯ IOåˆå¹¶ç­–ç•¥**
```
é‚»è¿‘é¡µé¢åˆå¹¶ï¼š
â€¢ æ£€æŸ¥ç›¸é‚»é¡µé¢æ˜¯å¦ä¹Ÿéœ€è¦åˆ·æ–°
â€¢ å°†è¿ç»­çš„è„é¡µåˆå¹¶ä¸ºä¸€æ¬¡IOæ“ä½œ
â€¢ å‡å°‘ç£ç›˜å¯»é“æ—¶é—´

æ‰‡åŒºå¯¹é½ä¼˜åŒ–ï¼š
â€¢ ç¡®ä¿å†™å…¥æ“ä½œæŒ‰æ‰‡åŒºè¾¹ç•Œå¯¹é½
â€¢ é¿å…è¯»-ä¿®æ”¹-å†™çš„é¢å¤–å¼€é”€
â€¢ æé«˜SSDçš„å†™å…¥æ€§èƒ½
```

---

## 4. ğŸ”„ ç¼“å­˜ä¸å­˜å‚¨åŒæ­¥ç­–ç•¥


### 4.1 WALæœºåˆ¶ä¿è¯ä¸€è‡´æ€§


**ğŸ”’ Write-Ahead LoggingåŸç†**

**æ ¸å¿ƒæœºåˆ¶è¯´æ˜**
```
WALè§„åˆ™ï¼š
â€¢ æ•°æ®é¡µå†™å…¥ç£ç›˜å‰ï¼Œç›¸å…³çš„redo logå¿…é¡»å…ˆå†™å…¥ç£ç›˜
â€¢ ä¿è¯å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œä¹Ÿèƒ½é€šè¿‡redo logæ¢å¤æœªæŒä¹…åŒ–çš„ä¿®æ”¹

æ—¶åºä¿è¯ï¼š
äº‹åŠ¡ä¿®æ”¹ â†’ Redo Logå†™å…¥ â†’ æ•°æ®é¡µæ ‡è®°ä¸ºè„ â†’ åå°åˆ·æ–°æ•°æ®é¡µ
    â†‘           â†‘              â†‘              â†‘
  å†…å­˜æ“ä½œ    æŒä¹…åŒ–ä¿è¯      å»¶è¿Ÿå†™å…¥        å¼‚æ­¥ä¼˜åŒ–
```

**ğŸ¯ LSNæœºåˆ¶è¯¦è§£**
```
LSN (Log Sequence Number) ç”¨é€”ï¼š
â€¢ å”¯ä¸€æ ‡è¯†æ¯ä¸ªredo logè®°å½•
â€¢ è·Ÿè¸ªæ•°æ®é¡µçš„æœ€æ–°ä¿®æ”¹ç‰ˆæœ¬
â€¢ åˆ¤æ–­æ•°æ®é¡µæ˜¯å¦éœ€è¦åº”ç”¨redo log

LSNæ¯”è¾ƒé€»è¾‘ï¼š
if (page_lsn < redo_lsn) {
    // é¡µé¢ç‰ˆæœ¬è½åï¼Œéœ€è¦åº”ç”¨redo log
    apply_redo_log(page, redo_records);
} else {
    // é¡µé¢å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬
    skip_redo_log();
}
```

### 4.2 äº‹åŠ¡çº§åˆ«çš„åŒæ­¥æ§åˆ¶


**ğŸ“‹ äº‹åŠ¡æäº¤çš„åŒæ­¥è¿‡ç¨‹**

**Step 1: å‡†å¤‡é˜¶æ®µ**
```sql
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
-- æ­¤æ—¶æ•°æ®åªåœ¨Buffer Poolä¸­ä¿®æ”¹ï¼Œredo logåœ¨å†…å­˜ä¸­
```

**Step 2: æäº¤é˜¶æ®µ**
```
äº‹åŠ¡æäº¤çš„è¯¦ç»†æ­¥éª¤ï¼š
1. å°†redo log bufferåˆ·æ–°åˆ°redo logæ–‡ä»¶
2. æ ¹æ®innodb_flush_log_at_trx_commitå‚æ•°æ‰§è¡Œfsync
3. æ›´æ–°äº‹åŠ¡çš„æäº¤LSN
4. é‡Šæ”¾äº‹åŠ¡æŒæœ‰çš„é”èµ„æº
5. å°†è„é¡µæ ‡è®°ä¸ºå¯åˆ·æ–°çŠ¶æ€

å‚æ•°å½±å“ï¼š
innodb_flush_log_at_trx_commit = 0: æ¯ç§’åˆ·æ–°ä¸€æ¬¡
innodb_flush_log_at_trx_commit = 1: æ¯æ¬¡æäº¤éƒ½åˆ·æ–°ï¼ˆæœ€å®‰å…¨ï¼‰
innodb_flush_log_at_trx_commit = 2: æ¯æ¬¡æäº¤å†™OSç¼“å­˜ï¼Œæ¯ç§’fsync
```

**ğŸ”„ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)åè°ƒ**
```
MVCCä¸Buffer Pooläº¤äº’ï¼š
â€¢ ä¸åŒäº‹åŠ¡çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®é¡µ
â€¢ é€šè¿‡undo logæ„é€ å†å²ç‰ˆæœ¬
â€¢ Buffer Poolä¸­å¯èƒ½åŒæ—¶å­˜åœ¨å¤šä¸ªé€»è¾‘ç‰ˆæœ¬

ç‰ˆæœ¬åˆ¤æ–­é€»è¾‘ï¼š
if (äº‹åŠ¡å¼€å§‹æ—¶é—´ < é¡µé¢æœ€åä¿®æ”¹æ—¶é—´) {
    ä»undo logæ„é€ å†å²ç‰ˆæœ¬;
} else {
    ç›´æ¥ä½¿ç”¨Buffer Poolä¸­çš„å½“å‰ç‰ˆæœ¬;
}
```

### 4.3 åå°åŒæ­¥ä»»åŠ¡åè°ƒ


**ğŸ”„ Page Cleanerçº¿ç¨‹å·¥ä½œæœºåˆ¶**
```cpp
// Page Cleanerçº¿ç¨‹çš„æ ¸å¿ƒé€»è¾‘
void page_cleaner_thread() {
    while (true) {
        // 1. è¯„ä¼°åˆ·æ–°éœ€æ±‚
        int dirty_ratio = calculate_dirty_page_ratio();
        int flush_intensity = calculate_flush_intensity(dirty_ratio);
        
        // 2. é€‰æ‹©è¦åˆ·æ–°çš„é¡µé¢
        std::vector<Page*> pages = select_pages_to_flush(flush_intensity);
        
        // 3. æ‰§è¡Œæ‰¹é‡åˆ·æ–°
        flush_pages_batch(pages);
        
        // 4. æ›´æ–°checkpointä½ç½®
        update_checkpoint_lsn();
        
        // 5. ç¡çœ ç­‰å¾…ä¸‹æ¬¡å‘¨æœŸ
        sleep(innodb_io_capacity_sleep_interval);
    }
}
```

**âš–ï¸ è‡ªé€‚åº”åˆ·æ–°ç®—æ³•**
```
åˆ·æ–°å¼ºåº¦åŠ¨æ€è°ƒæ•´ï¼š
â€¢ ç›‘æ§IOé˜Ÿåˆ—é•¿åº¦
â€¢ æ ¹æ®ç£ç›˜å“åº”æ—¶é—´è°ƒæ•´åˆ·æ–°é€Ÿåº¦
â€¢ é¿å…IOçªå‘å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“

ç®—æ³•æ ¸å¿ƒï¼š
å½“å‰IOå‹åŠ› = IOé˜Ÿåˆ—é•¿åº¦ / æœ€å¤§é˜Ÿåˆ—å®¹é‡
ç›®æ ‡åˆ·æ–°ç‡ = åŸºç¡€åˆ·æ–°ç‡ Ã— (1 - å½“å‰IOå‹åŠ›)

è‡ªé€‚åº”å‚æ•°ï¼š
â€¢ innodb_io_capacity: åŸºç¡€IOèƒ½åŠ›
â€¢ innodb_io_capacity_max: æœ€å¤§IOèƒ½åŠ›
â€¢ innodb_adaptive_flushing: æ˜¯å¦å¯ç”¨è‡ªé€‚åº”åˆ·æ–°
```

---

## 5. ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶


### 5.1 åŸå­æ€§ä¿è¯æœºåˆ¶


**ğŸ” é¡µé¢çº§åŸå­æ“ä½œ**

**Mini-Transaction (MTR) æœºåˆ¶**
```
MTRçš„ä½œç”¨ï¼š
â€¢ ä¿è¯å•ä¸ªé¡µé¢ä¿®æ”¹çš„åŸå­æ€§
â€¢ å°†ç›¸å…³çš„redo logè®°å½•ç»„ç»‡åœ¨ä¸€èµ·
â€¢ ç¡®ä¿éƒ¨åˆ†ä¿®æ”¹ä¸ä¼šç•™ä¸‹ä¸ä¸€è‡´çŠ¶æ€

MTRç¤ºä¾‹ï¼š
mtr_start(&mtr);                    // å¼€å§‹å°äº‹åŠ¡
page = buf_page_get(&mtr, page_id); // è·å–é¡µé¢å¹¶åŠ é”
modify_page_content(page);          // ä¿®æ”¹é¡µé¢å†…å®¹
mlog_write_log(&mtr, redo_record);  // è®°å½•redo log
mtr_commit(&mtr);                   // æäº¤å¹¶é‡Šæ”¾é”
```

**ğŸ¯ é¡µé¢é”æœºåˆ¶**
```
é¡µé¢é”çš„ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S-Latch    â”‚ â† å…±äº«é”ï¼ˆè¯»æ“ä½œï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  X-Latch    â”‚ â† æ’ä»–é”ï¼ˆå†™æ“ä½œï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SX-Latch   â”‚ â† å…±äº«æ’ä»–é”ï¼ˆç»“æ„ä¿®æ”¹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é”å…¼å®¹æ€§çŸ©é˜µï¼š
       S    X    SX
S      âœ“    âœ—    âœ“
X      âœ—    âœ—    âœ—
SX     âœ“    âœ—    âœ—
```

### 5.2 éš”ç¦»æ€§ä¿è¯æœºåˆ¶


**ğŸ“Š ä¸åŒéš”ç¦»çº§åˆ«çš„å®ç°**

**READ COMMITTEDçº§åˆ«**
```
å®ç°æœºåˆ¶ï¼š
â€¢ æ¯æ¬¡æŸ¥è¯¢æ—¶è·å–æœ€æ–°çš„æäº¤ç‰ˆæœ¬
â€¢ é€šè¿‡ReadViewåˆ¤æ–­è®°å½•å¯è§æ€§
â€¢ ä¸é˜»æ­¢å…¶ä»–äº‹åŠ¡çš„æäº¤

Buffer Pooläº¤äº’ï¼š
â€¢ å¯èƒ½éœ€è¦ä»undo logæ„é€ å†å²ç‰ˆæœ¬
â€¢ ä¸åŒäº‹åŠ¡çœ‹åˆ°çš„é¡µé¢å†…å®¹å¯èƒ½ä¸åŒ
â€¢ éœ€è¦æ£€æŸ¥è®°å½•çš„trx_idå’Œæäº¤çŠ¶æ€
```

**REPEATABLE READçº§åˆ«**
```
å®ç°æœºåˆ¶ï¼š
â€¢ äº‹åŠ¡å¼€å§‹æ—¶åˆ›å»ºReadViewå¿«ç…§
â€¢ æ•´ä¸ªäº‹åŠ¡æœŸé—´ä½¿ç”¨ç›¸åŒçš„ReadView
â€¢ ä¿è¯é‡å¤è¯»å–ç»“æœä¸€è‡´

ReadViewå†…å®¹ï¼š
struct ReadView {
    trx_id_t low_limit_id;    // æœ€å¤§çš„æ´»è·ƒäº‹åŠ¡ID
    trx_id_t up_limit_id;     // æœ€å°çš„æ´»è·ƒäº‹åŠ¡ID
    std::vector<trx_id_t> active_trx_ids; // æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
};

å¯è§æ€§åˆ¤æ–­ï¼š
if (è®°å½•çš„trx_id < up_limit_id) {
    return å¯è§;  // åˆ›å»ºReadViewå‰å°±æäº¤çš„äº‹åŠ¡
} else if (è®°å½•çš„trx_id >= low_limit_id) {
    return ä¸å¯è§; // ReadViewåˆ›å»ºåå¼€å§‹çš„äº‹åŠ¡
} else {
    return æ£€æŸ¥active_trx_ids; // éœ€è¦è¯¦ç»†æ£€æŸ¥
}
```

### 5.3 æŒä¹…æ€§ä¿è¯æœºåˆ¶


**ğŸ’¾ æ•…éšœæ¢å¤çš„æ•°æ®ä¸€è‡´æ€§**

**æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£**
```cpp
// æ£€æŸ¥ç‚¹å†™å…¥é€»è¾‘
void write_checkpoint() {
    // 1. ç¡®å®šæ£€æŸ¥ç‚¹LSN
    lsn_t checkpoint_lsn = determine_checkpoint_lsn();
    
    // 2. åˆ·æ–°checkpoint_lsnä¹‹å‰çš„æ‰€æœ‰è„é¡µ
    flush_pages_up_to_lsn(checkpoint_lsn);
    
    // 3. å†™å…¥æ£€æŸ¥ç‚¹è®°å½•
    write_checkpoint_record(checkpoint_lsn);
    
    // 4. æ›´æ–°redo logå¤´éƒ¨ä¿¡æ¯
    update_redo_log_header(checkpoint_lsn);
}
```

**ğŸ”„ å´©æºƒæ¢å¤è¿‡ç¨‹**
```
æ¢å¤çš„ä¸‰ä¸ªé˜¶æ®µï¼š
1. åˆ†æé˜¶æ®µ(Analysis Phase)
   â€¢ æ‰«æredo logç¡®å®šæ¢å¤èµ·ç‚¹
   â€¢ æ„å»ºè„é¡µåˆ—è¡¨å’Œæ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   
2. é‡åšé˜¶æ®µ(Redo Phase)  
   â€¢ é‡æ–°åº”ç”¨æ‰€æœ‰å·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹
   â€¢ æ¢å¤Buffer Poolåˆ°å´©æºƒå‰çŠ¶æ€
   
3. å›æ»šé˜¶æ®µ(Undo Phase)
   â€¢ å›æ»šæ‰€æœ‰æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹
   â€¢ é‡Šæ”¾ç›¸å…³èµ„æº

æ¢å¤æµç¨‹å›¾ï¼š
å¯åŠ¨ â†’ è¯»å–æ£€æŸ¥ç‚¹ â†’ æ‰«æredo log â†’ é‡åšå·²æäº¤äº‹åŠ¡ â†’ å›æ»šæœªæäº¤äº‹åŠ¡ â†’ æ­£å¸¸æœåŠ¡
```

**âš ï¸ å¸¸è§æ•°æ®ä¸ä¸€è‡´é—®é¢˜**
```
é—®é¢˜ç±»å‹åŠè§£å†³æ–¹æ¡ˆï¼š

1. è„è¯»(Dirty Read)
   é—®é¢˜ï¼šè¯»å–æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹
   è§£å†³ï¼šé€šè¿‡ReadViewå’ŒMVCCæœºåˆ¶é¿å…

2. ä¸å¯é‡å¤è¯»(Non-repeatable Read)  
   é—®é¢˜ï¼šåŒä¸€äº‹åŠ¡å†…é‡å¤è¯»å–ç»“æœä¸åŒ
   è§£å†³ï¼šREPEATABLE READéš”ç¦»çº§åˆ«

3. å¹»è¯»(Phantom Read)
   é—®é¢˜ï¼šåŒä¸€äº‹åŠ¡å†…èŒƒå›´æŸ¥è¯¢ç»“æœä¸åŒ
   è§£å†³ï¼šNext-Key Lockæœºåˆ¶

4. ä¸¢å¤±æ›´æ–°(Lost Update)
   é—®é¢˜ï¼šå¹¶å‘ä¿®æ”¹å¯¼è‡´æ›´æ–°ä¸¢å¤±
   è§£å†³ï¼šè¡Œçº§é”å’Œç‰ˆæœ¬æ£€æŸ¥
```

---

## 6. ğŸš¨ å´©æºƒæ¢å¤åè°ƒå¤„ç†


### 6.1 æ¢å¤è¿‡ç¨‹çš„æ•´ä½“åè°ƒ


**ğŸ”„ å¯åŠ¨æ—¶çš„æ¢å¤æ£€æŸ¥**

```cpp
// MySQLå¯åŠ¨æ—¶çš„æ¢å¤é€»è¾‘
bool mysql_recovery_process() {
    // 1. æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å¸¸å…³é—­
    if (check_clean_shutdown()) {
        return true; // æ— éœ€æ¢å¤
    }
    
    // 2. åˆå§‹åŒ–Buffer Pool
    buffer_pool_init();
    
    // 3. æ‰§è¡Œå´©æºƒæ¢å¤
    return crash_recovery();
}

bool crash_recovery() {
    // Step 1: è¯»å–æœ€åçš„æ£€æŸ¥ç‚¹
    lsn_t checkpoint_lsn = read_last_checkpoint();
    
    // Step 2: ä»æ£€æŸ¥ç‚¹å¼€å§‹æ‰«æredo log
    recovery_analysis_phase(checkpoint_lsn);
    
    // Step 3: é‡åšæ‰€æœ‰å·²è®°å½•çš„ä¿®æ”¹
    recovery_redo_phase();
    
    // Step 4: å›æ»šæœªæäº¤çš„äº‹åŠ¡
    recovery_undo_phase();
    
    return true;
}
```

### 6.2 Buffer PoolçŠ¶æ€æ¢å¤


**ğŸ“¦ é¡µé¢çŠ¶æ€é‡å»º**

**åˆ†æé˜¶æ®µçš„Buffer Poolå‡†å¤‡**
```
åˆ†æé˜¶æ®µä»»åŠ¡ï¼š
â€¢ æ‰«æredo logæ„å»ºè„é¡µåˆ—è¡¨
â€¢ ç¡®å®šå“ªäº›é¡µé¢åœ¨å´©æºƒæ—¶æ˜¯è„é¡µ
â€¢ æ„å»ºæ´»è·ƒäº‹åŠ¡åˆ—è¡¨
â€¢ é¢„åˆ†é…Buffer Poolç©ºé—´

è„é¡µåˆ—è¡¨æ„å»ºï¼š
while (æ‰«æredo logè®°å½•) {
    if (è®°å½•ç±»å‹ == é¡µé¢ä¿®æ”¹) {
        æ·»åŠ åˆ°è„é¡µåˆ—è¡¨(space_id, page_no, start_lsn, end_lsn);
    }
    if (è®°å½•ç±»å‹ == äº‹åŠ¡æäº¤) {
        æ ‡è®°äº‹åŠ¡ä¸ºå·²æäº¤;
    }
}
```

**ğŸ’¾ é¡µé¢é‡åšè¿‡ç¨‹**
```cpp
// é¡µé¢æ¢å¤çš„æ ¸å¿ƒé€»è¾‘
void recover_page(space_id_t space_id, page_no_t page_no, lsn_t start_lsn) {
    // 1. ä»ç£ç›˜è¯»å–é¡µé¢åˆ°Buffer Pool
    buf_page_t* page = buf_page_read_from_disk(space_id, page_no);
    
    // 2. æ£€æŸ¥é¡µé¢LSN
    lsn_t page_lsn = page->get_lsn();
    
    // 3. åº”ç”¨å¿…è¦çš„redo logè®°å½•
    for (auto& redo_record : get_redo_records(space_id, page_no)) {
        if (redo_record.lsn > page_lsn) {
            apply_redo_to_page(page, redo_record);
        }
    }
    
    // 4. æ›´æ–°é¡µé¢çŠ¶æ€
    page->set_dirty();
    page->add_to_flush_list();
}
```

### 6.3 äº‹åŠ¡çŠ¶æ€åè°ƒ


**ğŸ”„ æ´»è·ƒäº‹åŠ¡å¤„ç†**

**æœªæäº¤äº‹åŠ¡çš„å›æ»š**
```
å›æ»šåè°ƒè¿‡ç¨‹ï¼š
1. è¯†åˆ«æ‰€æœ‰æ´»è·ƒäº‹åŠ¡
   â€¢ ä»redo logåˆ†æé˜¶æ®µè·å¾—æ´»è·ƒäº‹åŠ¡åˆ—è¡¨
   â€¢ è¿™äº›äº‹åŠ¡åœ¨å´©æºƒæ—¶å°šæœªæäº¤

2. æ„å»ºundoè®°å½•é“¾
   â€¢ è¯»å–æ¯ä¸ªäº‹åŠ¡çš„undo log
   â€¢ æŒ‰ç…§ç›¸åé¡ºåºæ„å»ºå›æ»šæ“ä½œåºåˆ—

3. æ‰§è¡Œå›æ»šæ“ä½œ
   â€¢ é€ä¸ªåº”ç”¨undoè®°å½•
   â€¢ æ¢å¤é¡µé¢åˆ°äº‹åŠ¡å¼€å§‹å‰çŠ¶æ€
   â€¢ é‡Šæ”¾äº‹åŠ¡æŒæœ‰çš„é”èµ„æº

4. æ¸…ç†äº‹åŠ¡çŠ¶æ€
   â€¢ æ ‡è®°äº‹åŠ¡ä¸ºå·²å›æ»š
   â€¢ é‡Šæ”¾äº‹åŠ¡ç›¸å…³çš„å†…å­˜èµ„æº
```

**ğŸ¯ åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ**
```
XAäº‹åŠ¡æ¢å¤ï¼š
â€¢ æ£€æŸ¥prepareé˜¶æ®µå®Œæˆçš„äº‹åŠ¡
â€¢ ç­‰å¾…äº‹åŠ¡ç®¡ç†å™¨çš„commit/rollbackå†³å®š
â€¢ åè°ƒå¤šä¸ªèµ„æºç®¡ç†å™¨çš„çŠ¶æ€

ä¸¤é˜¶æ®µæäº¤æ¢å¤ï¼š
Phase 1: å‡†å¤‡é˜¶æ®µæ¢å¤
â€¢ æ¢å¤æ‰€æœ‰prepareçš„äº‹åŠ¡çŠ¶æ€
â€¢ ç­‰å¾…å¤–éƒ¨å†³å®š

Phase 2: å†³å®šé˜¶æ®µæ‰§è¡Œ
â€¢ æ ¹æ®å¤–éƒ¨å†³å®šæ‰§è¡Œcommitæˆ–rollback
â€¢ æ›´æ–°äº‹åŠ¡æœ€ç»ˆçŠ¶æ€
```

### 6.4 æ¢å¤æ€§èƒ½ä¼˜åŒ–


**âš¡ å¹¶è¡Œæ¢å¤æœºåˆ¶**
```cpp
// å¹¶è¡Œæ¢å¤çš„å®ç°
void parallel_recovery() {
    // 1. æŒ‰é¡µé¢åˆ†ç»„
    auto page_groups = group_pages_by_tablespace(dirty_page_list);
    
    // 2. åˆ›å»ºæ¢å¤çº¿ç¨‹æ± 
    ThreadPool recovery_pool(innodb_recovery_threads);
    
    // 3. å¹¶è¡Œæ¢å¤ä¸åŒè¡¨ç©ºé—´
    for (auto& group : page_groups) {
        recovery_pool.submit([group]() {
            recover_tablespace_pages(group);
        });
    }
    
    // 4. ç­‰å¾…æ‰€æœ‰æ¢å¤å®Œæˆ
    recovery_pool.wait_all();
}
```

**ğŸ“Š æ¢å¤è¿›åº¦ç›‘æ§**
```sql
-- æ¢å¤è¿‡ç¨‹ç›‘æ§
SELECT 
    STAGE,
    WORK_COMPLETED,
    WORK_ESTIMATED,
    ROUND(WORK_COMPLETED/WORK_ESTIMATED*100, 2) AS PROGRESS_PCT
FROM performance_schema.events_stages_current
WHERE EVENT_NAME LIKE '%recovery%';

-- å…³é”®æŒ‡æ ‡ï¼š
-- â€¢ å·²å¤„ç†çš„redo logå­—èŠ‚æ•°
-- â€¢ å·²æ¢å¤çš„é¡µé¢æ•°é‡
-- â€¢ å‰©ä½™çš„æ´»è·ƒäº‹åŠ¡æ•°é‡
-- â€¢ é¢„è®¡å®Œæˆæ—¶é—´
```

---

## 7. âš¡ IOä¼˜åŒ–ç­–ç•¥å®ç°


### 7.1 ç£ç›˜IOæ¨¡å¼ä¼˜åŒ–


**ğŸ¯ é¡ºåºIO vs éšæœºIOä¼˜åŒ–**

**é¡ºåºIOä¼˜åŒ–ç­–ç•¥**
```
é¡ºåºIOçš„ä¼˜åŠ¿ï¼š
â€¢ ç£ç›˜å¯»é“æ—¶é—´æœ€å°
â€¢ èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ç£ç›˜é¢„è¯»
â€¢ SSDä¹Ÿèƒ½è·å¾—æ›´å¥½çš„æ€§èƒ½

å®ç°æŠ€æœ¯ï¼š
1. é¡µé¢æ’åºå†™å…¥
   â€¢ æŒ‰ç…§(space_id, page_no)æ’åº
   â€¢ å°†éšæœºå†™è½¬æ¢ä¸ºé¡ºåºå†™

2. æ‰¹é‡IOåˆå¹¶
   â€¢ ç›¸é‚»é¡µé¢åˆå¹¶ä¸ºå•æ¬¡IO
   â€¢ å‡å°‘ç³»ç»Ÿè°ƒç”¨å¼€é”€

ä»£ç ç¤ºä¾‹ï¼š
void optimize_sequential_write(std::vector<Page*>& pages) {
    // æ’åºé¡µé¢
    std::sort(pages.begin(), pages.end(), 
        [](const Page* a, const Page* b) {
            if (a->space_id != b->space_id) 
                return a->space_id < b->space_id;
            return a->page_no < b->page_no;
        });
    
    // åˆå¹¶è¿ç»­é¡µé¢
    merge_and_write_continuous_pages(pages);
}
```

**ğŸ”€ éšæœºIOä¼˜åŒ–ç­–ç•¥**
```
éšæœºIOçš„ä¼˜åŒ–æ–¹æ³•ï¼š
â€¢ ä½¿ç”¨å¼‚æ­¥IOå‡å°‘ç­‰å¾…æ—¶é—´
â€¢ å¢åŠ IOé˜Ÿåˆ—æ·±åº¦
â€¢ åˆ©ç”¨å¤šçº¿ç¨‹å¹¶å‘å¤„ç†

å¼‚æ­¥IOå®ç°ï¼š
struct AIORequest {
    int fd;
    void* buffer;
    size_t size;
    off_t offset;
    std::function<void(int)> callback;
};

void submit_async_read(const AIORequest& req) {
    // æäº¤å¼‚æ­¥è¯»è¯·æ±‚
    aio_read(&req.aiocb);
    // æ³¨å†Œå®Œæˆå›è°ƒ
    register_completion_callback(req.callback);
}
```

### 7.2 é¢„è¯»ç­–ç•¥ä¼˜åŒ–


**ğŸ“– æ™ºèƒ½é¢„è¯»ç®—æ³•**

**è‡ªé€‚åº”é¢„è¯»**
```cpp
class AdaptiveReadAhead {
private:
    std::unordered_map<page_id_t, AccessPattern> access_history;
    
public:
    void record_access(page_id_t page_id) {
        auto& pattern = access_history[page_id];
        pattern.access_count++;
        pattern.last_access = std::chrono::now();
        
        // åˆ†æè®¿é—®æ¨¡å¼
        if (is_sequential_pattern(pattern)) {
            trigger_sequential_readahead(page_id);
        } else if (is_random_hotspot(pattern)) {
            trigger_random_readahead(page_id);
        }
    }
    
private:
    bool is_sequential_pattern(const AccessPattern& pattern) {
        return pattern.sequential_count >= 3;
    }
    
    void trigger_sequential_readahead(page_id_t page_id) {
        // é¢„è¯»åç»­é¡µé¢
        int pages_to_read = calculate_readahead_size(page_id);
        for (int i = 1; i <= pages_to_read; i++) {
            async_read_page(page_id + i);
        }
    }
};
```

**ğŸ¯ é¢„è¯»æ•ˆæœä¼˜åŒ–**
```
é¢„è¯»å‘½ä¸­ç‡ç›‘æ§ï¼š
â€¢ é¢„è¯»é¡µé¢çš„ä½¿ç”¨ç‡
â€¢ é¢„è¯»é¡µé¢åœ¨ç¼“å­˜ä¸­çš„åœç•™æ—¶é—´
â€¢ é¢„è¯»å¯¹æŸ¥è¯¢å“åº”æ—¶é—´çš„å½±å“

ä¼˜åŒ–ç­–ç•¥ï¼š
if (é¢„è¯»å‘½ä¸­ç‡ < 50%) {
    å‡å°‘é¢„è¯»çš„é¡µé¢æ•°é‡;
} else if (é¢„è¯»å‘½ä¸­ç‡ > 90%) {
    å¢åŠ é¢„è¯»çš„é¡µé¢æ•°é‡;
}

é¢„è¯»å–æ¶ˆæœºåˆ¶ï¼š
â€¢ å½“Buffer Poolç©ºé—´ç´§å¼ æ—¶
â€¢ ä¼˜å…ˆæ·˜æ±°æœªè¢«è®¿é—®çš„é¢„è¯»é¡µé¢
â€¢ é¿å…é¢„è¯»å½±å“æ­£å¸¸çš„ç¼“å­˜æ•ˆç‡
```

### 7.3 å†™å…¥IOä¼˜åŒ–


**ğŸ“¦ æ‰¹é‡å†™å…¥ä¼˜åŒ–**

**å†™å…¥æ‰¹æ¬¡ç®¡ç†**
```cpp
class BatchWriter {
private:
    std::vector<Page*> write_batch;
    size_t batch_size_limit;
    std::chrono::milliseconds batch_timeout;
    
public:
    void add_page_to_batch(Page* page) {
        write_batch.push_back(page);
        
        if (write_batch.size() >= batch_size_limit || 
            is_batch_timeout()) {
            flush_batch();
        }
    }
    
private:
    void flush_batch() {
        // 1. æ’åºä¼˜åŒ–
        sort_pages_for_sequential_write();
        
        // 2. åˆå¹¶è¿ç»­é¡µé¢
        auto segments = merge_continuous_pages();
        
        // 3. å¹¶è¡Œå†™å…¥
        parallel_write_segments(segments);
        
        // 4. æ¸…ç©ºæ‰¹æ¬¡
        write_batch.clear();
    }
};
```

**âš¡ å†™å…¥æ€§èƒ½è°ƒä¼˜**
```
å…³é”®å‚æ•°è°ƒä¼˜ï¼š
â€¢ innodb_io_capacity: æ§åˆ¶åå°IOé€Ÿåº¦
â€¢ innodb_io_capacity_max: ç´§æ€¥æƒ…å†µä¸‹çš„æœ€å¤§IO
â€¢ innodb_flush_neighbors: æ˜¯å¦åˆ·æ–°é‚»è¿‘é¡µé¢
â€¢ innodb_use_native_aio: æ˜¯å¦ä½¿ç”¨å¼‚æ­¥IO

å‚æ•°é…ç½®å»ºè®®ï¼š
SSDå­˜å‚¨ï¼š
  innodb_io_capacity = 2000
  innodb_io_capacity_max = 4000
  innodb_flush_neighbors = 0

æœºæ¢°ç¡¬ç›˜ï¼š
  innodb_io_capacity = 200
  innodb_io_capacity_max = 400
  innodb_flush_neighbors = 1
```

### 7.4 IOç›‘æ§ä¸è°ƒä¼˜


**ğŸ“Š IOæ€§èƒ½ç›‘æ§**
```sql
-- ç›‘æ§Buffer Pool IOç»Ÿè®¡
SELECT 
    pool_id,
    pool_size,
    free_buffers,
    database_pages,
    old_database_pages,
    pages_made_young,
    pages_not_made_young,
    pages_made_young_rate,
    pages_made_not_young_rate,
    number_pages_read,
    number_pages_created,
    number_pages_written,
    pages_read_rate,
    pages_create_rate,
    pages_written_rate
FROM information_schema.INNODB_BUFFER_POOL_STATS;
```

**ğŸ¯ æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**
```
å¸¸è§IOç“¶é¢ˆï¼š
1. ç£ç›˜å¸¦å®½é¥±å’Œ
   â€¢ ç—‡çŠ¶ï¼šIO waitæ—¶é—´é«˜
   â€¢ è§£å†³ï¼šå¢åŠ å¹¶å‘åº¦ï¼Œä½¿ç”¨æ›´å¿«çš„å­˜å‚¨

2. éšæœºIOè¿‡å¤š
   â€¢ ç—‡çŠ¶ï¼šIOPSè¾¾åˆ°ä¸Šé™ï¼Œä½†å¸¦å®½æœªæ»¡
   â€¢ è§£å†³ï¼šä¼˜åŒ–æŸ¥è¯¢ï¼Œå¢åŠ å†…å­˜

3. å†™å…¥å»¶è¿Ÿé«˜
   â€¢ ç—‡çŠ¶ï¼šäº‹åŠ¡æäº¤æ…¢
   â€¢ è§£å†³ï¼šè°ƒæ•´åˆ·æ–°ç­–ç•¥ï¼Œä¼˜åŒ–redo log

ç›‘æ§è„šæœ¬ï¼š
#!/bin/bash
while true; do
    echo "=== $(date) ==="
    iostat -x 1 1 | grep -E "(Device|mysql)"
    mysql -e "SHOW STATUS LIKE 'Innodb_buffer_pool%';"
    sleep 5
done
```

---

## 8. ğŸ”§ ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–æŠ€æœ¯


### 8.1 æ–‡ä»¶IOç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–


**âš¡ ç³»ç»Ÿè°ƒç”¨æ€§èƒ½ä¼˜åŒ–**

**å‡å°‘ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°**
```cpp
// æ‰¹é‡è¯»å†™ä¼˜åŒ–
class BatchIOManager {
public:
    // æ‰¹é‡è¯»å–å¤šä¸ªé¡µé¢
    int batch_read_pages(const std::vector<PageRequest>& requests) {
        // 1. æŒ‰æ–‡ä»¶æè¿°ç¬¦åˆ†ç»„
        auto fd_groups = group_by_fd(requests);
        
        // 2. ä½¿ç”¨readvè¿›è¡Œå‘é‡åŒ–è¯»å–
        for (auto& [fd, pages] : fd_groups) {
            struct iovec iov[pages.size()];
            for (size_t i = 0; i < pages.size(); i++) {
                iov[i].iov_base = pages[i].buffer;
                iov[i].iov_len = INNODB_PAGE_SIZE;
            }
            
            // å•æ¬¡ç³»ç»Ÿè°ƒç”¨è¯»å–å¤šä¸ªé¡µé¢
            ssize_t bytes_read = preadv(fd, iov, pages.size(), 
                                       pages[0].offset);
            
            handle_read_result(bytes_read, pages);
        }
    }
    
    // æ‰¹é‡å†™å…¥å¤šä¸ªé¡µé¢  
    int batch_write_pages(const std::vector<PageWrite>& writes) {
        // ä½¿ç”¨writevè¿›è¡Œå‘é‡åŒ–å†™å…¥
        // ç±»ä¼¼äºbatch_read_pagesçš„å®ç°
    }
};
```

**ğŸ¯ å¼‚æ­¥IOä¼˜åŒ–**
```cpp
// Linux AIOä¼˜åŒ–
class AsyncIOManager {
private:
    io_context_t aio_context;
    std::queue<struct iocb*> pending_ios;
    
public:
    bool init(int max_events) {
        // åˆå§‹åŒ–AIOä¸Šä¸‹æ–‡
        return io_setup(max_events, &aio_context) == 0;
    }
    
    void submit_read(int fd, void* buffer, size_t size, 
                    off_t offset, std::function<void(int)> callback) {
        struct iocb* cb = new iocb();
        io_prep_pread(cb, fd, buffer, size, offset);
        cb->data = new CallbackData{callback, buffer};
        
        // æäº¤å¼‚æ­¥è¯»å–
        io_submit(aio_context, 1, &cb);
        pending_ios.push(cb);
    }
    
    void process_completions() {
        struct io_event events[64];
        int num_events = io_getevents(aio_context, 0, 64, events, nullptr);
        
        for (int i = 0; i < num_events; i++) {
            struct iocb* cb = (struct iocb*)events[i].obj;
            CallbackData* data = (CallbackData*)cb->data;
            
            // è°ƒç”¨å®Œæˆå›è°ƒ
            data->callback(events[i].res);
            
            // æ¸…ç†èµ„æº
            delete data;
            delete cb;
        }
    }
};
```

### 8.2 å†…å­˜ç®¡ç†ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–


**ğŸ’¾ å†…å­˜åˆ†é…ä¼˜åŒ–**

**å¤§é¡µå†…å­˜(Huge Pages)ä½¿ç”¨**
```cpp
// å¤§é¡µå†…å­˜åˆ†é…
void* allocate_huge_pages(size_t size) {
    // 1. æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æ”¯æŒå¤§é¡µ
    if (!check_huge_pages_support()) {
        return nullptr;
    }
    
    // 2. è®¡ç®—éœ€è¦çš„å¤§é¡µæ•°é‡
    size_t huge_page_size = get_huge_page_size(); // é€šå¸¸æ˜¯2MB
    size_t pages_needed = (size + huge_page_size - 1) / huge_page_size;
    size_t alloc_size = pages_needed * huge_page_size;
    
    // 3. ä½¿ç”¨mmapåˆ†é…å¤§é¡µå†…å­˜
    void* ptr = mmap(nullptr, alloc_size,
                     PROT_READ | PROT_WRITE,
                     MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB,
                     -1, 0);
    
    if (ptr == MAP_FAILED) {
        return nullptr;
    }
    
    return ptr;
}

// Buffer Poolä½¿ç”¨å¤§é¡µçš„ä¼˜åŠ¿ï¼š
// â€¢ å‡å°‘TLB miss
// â€¢ é™ä½å†…å­˜ç®¡ç†å¼€é”€
// â€¢ æé«˜å†…å­˜è®¿é—®æ•ˆç‡
```

**ğŸ”„ å†…å­˜é¢„åˆ†é…ç­–ç•¥**
```cpp
class MemoryPool {
private:
    void* pool_start;
    size_t pool_size;
    std::vector<void*> free_blocks;
    
public:
    bool initialize(size_t total_size) {
        // 1. ä¸€æ¬¡æ€§åˆ†é…å¤§å—å†…å­˜
        pool_start = allocate_huge_pages(total_size);
        if (!pool_start) {
            // å›é€€åˆ°æ™®é€šå†…å­˜åˆ†é…
            pool_start = mmap(nullptr, total_size,
                             PROT_READ | PROT_WRITE,
                             MAP_PRIVATE | MAP_ANONYMOUS,
                             -1, 0);
        }
        
        // 2. é¢„åˆ†é…é¡µé¢å—
        size_t page_size = INNODB_PAGE_SIZE;
        size_t num_pages = total_size / page_size;
        
        for (size_t i = 0; i < num_pages; i++) {
            void* page_ptr = (char*)pool_start + i * page_size;
            free_blocks.push_back(page_ptr);
        }
        
        return pool_start != MAP_FAILED;
    }
    
    void* allocate_page() {
        if (free_blocks.empty()) {
            return nullptr;
        }
        
        void* page = free_blocks.back();
        free_blocks.pop_back();
        return page;
    }
};
```

### 8.3 æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–


**ğŸ“ æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–**

**Direct IOä½¿ç”¨**
```cpp
// ç»•è¿‡æ“ä½œç³»ç»Ÿç¼“å­˜çš„Direct IO
class DirectIOManager {
public:
    int open_with_direct_io(const char* filename) {
        // O_DIRECTæ ‡å¿—ç»•è¿‡ç³»ç»Ÿç¼“å­˜
        int fd = open(filename, O_RDWR | O_DIRECT);
        
        if (fd == -1) {
            // æŸäº›æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒO_DIRECT
            fd = open(filename, O_RDWR);
            // ä½¿ç”¨fcntlè®¾ç½®
            fcntl(fd, F_SETFL, fcntl(fd, F_GETFL) | O_DIRECT);
        }
        
        return fd;
    }
    
    ssize_t aligned_read(int fd, void* buffer, size_t size, off_t offset) {
        // Direct IOè¦æ±‚å†…å­˜å¯¹é½
        if (!is_aligned(buffer, 512) || !is_aligned(size, 512)) {
            return -1;
        }
        
        return pread(fd, buffer, size, offset);
    }
    
private:
    bool is_aligned(void* ptr, size_t alignment) {
        return ((uintptr_t)ptr % alignment) == 0;
    }
};
```

**âš¡ æ–‡ä»¶é¢„åˆ†é…**
```cpp
// é¢„åˆ†é…æ–‡ä»¶ç©ºé—´é¿å…ç¢ç‰‡
bool preallocate_file(int fd, off_t size) {
    // æ–¹æ³•1: ä½¿ç”¨fallocate (Linux)
    if (fallocate(fd, 0, 0, size) == 0) {
        return true;
    }
    
    // æ–¹æ³•2: ä½¿ç”¨posix_fallocate
    if (posix_fallocate(fd, 0, size) == 0) {
        return true;
    }
    
    // æ–¹æ³•3: æ‰‹åŠ¨å†™é›¶ (å…¼å®¹æ€§æœ€å¥½ä½†æ€§èƒ½å·®)
    char zero_buffer[4096] = {0};
    off_t written = 0;
    while (written < size) {
        ssize_t to_write = std::min((off_t)sizeof(zero_buffer), 
                                   size - written);
        if (write(fd, zero_buffer, to_write) != to_write) {
            return false;
        }
        written += to_write;
    }
    
    return true;
}
```

### 8.4 ç½‘ç»œIOä¼˜åŒ–ï¼ˆé€‚ç”¨äºé›†ç¾¤ï¼‰


**ğŸŒ ç½‘ç»œç³»ç»Ÿè°ƒç”¨ä¼˜åŒ–**

**é›¶æ‹·è´æŠ€æœ¯**
```cpp
// ä½¿ç”¨sendfileè¿›è¡Œé›¶æ‹·è´ä¼ è¾“
ssize_t send_page_zero_copy(int socket_fd, int file_fd, 
                           off_t offset, size_t count) {
    // ç›´æ¥ä»æ–‡ä»¶æè¿°ç¬¦å‘é€åˆ°socketï¼Œæ— éœ€ç”¨æˆ·ç©ºé—´æ‹·è´
    return sendfile(socket_fd, file_fd, &offset, count);
}

// ä½¿ç”¨spliceåœ¨æ–‡ä»¶æè¿°ç¬¦é—´ä¼ è¾“æ•°æ®
ssize_t transfer_between_fds(int in_fd, int out_fd, size_t count) {
    int pipe_fds[2];
    pipe(pipe_fds);
    
    // ä»è¾“å…¥æ–‡ä»¶åˆ°ç®¡é“
    ssize_t bytes_to_pipe = splice(in_fd, nullptr, pipe_fds[1], nullptr,
                                  count, SPLICE_F_MOVE);
    
    // ä»ç®¡é“åˆ°è¾“å‡ºæ–‡ä»¶
    ssize_t bytes_from_pipe = splice(pipe_fds[0], nullptr, out_fd, nullptr,
                                    bytes_to_pipe, SPLICE_F_MOVE);
    
    close(pipe_fds[0]);
    close(pipe_fds[1]);
    
    return bytes_from_pipe;
}
```

**âš¡ ç³»ç»Ÿè°ƒç”¨ç›‘æ§**
```bash
# ä½¿ç”¨straceç›‘æ§ç³»ç»Ÿè°ƒç”¨
strace -c -p <mysql_pid>

# é‡ç‚¹å…³æ³¨çš„ç³»ç»Ÿè°ƒç”¨ï¼š
# â€¢ pread/pwrite: æ–‡ä»¶IOæ“ä½œ
# â€¢ fsync/fdatasync: æ•°æ®åŒæ­¥æ“ä½œ  
# â€¢ mmap/munmap: å†…å­˜æ˜ å°„æ“ä½œ
# â€¢ futex: é”ç­‰å¾…æ“ä½œ

# æ€§èƒ½åˆ†æè„šæœ¬
#!/bin/bash
echo "MySQLè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡ï¼š"
strace -c -p $(pidof mysqld) 2>&1 | grep -E "(pread|pwrite|fsync)"

echo "IOç­‰å¾…æ—¶é—´ç»Ÿè®¡ï¼š"
iostat -x 1 1 | grep mysql
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº¤äº’æœºåˆ¶ï¼šBuffer Poolä½œä¸ºå†…å­˜ä¸ç£ç›˜çš„åè°ƒå±‚
ğŸ”¸ è¯»å–æµç¨‹ï¼šç¼“å­˜å‘½ä¸­â†’ç›´æ¥è¿”å›ï¼Œæœªå‘½ä¸­â†’ç£ç›˜è¯»å–â†’ç¼“å­˜æ›´æ–°
ğŸ”¸ å†™å…¥æœºåˆ¶ï¼šè„é¡µç®¡ç†â†’æ‰¹é‡åˆ·æ–°â†’åŒå†™ä¿æŠ¤â†’æŒä¹…åŒ–å®Œæˆ
ğŸ”¸ åŒæ­¥ç­–ç•¥ï¼šWALæœºåˆ¶â†’LSNè·Ÿè¸ªâ†’äº‹åŠ¡åè°ƒâ†’ä¸€è‡´æ€§ä¿è¯
ğŸ”¸ æ¢å¤æœºåˆ¶ï¼šæ£€æŸ¥ç‚¹â†’redoé‡åšâ†’undoå›æ»šâ†’çŠ¶æ€æ¢å¤
ğŸ”¸ IOä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œâ†’å¼‚æ­¥å¤„ç†â†’ç³»ç»Ÿè°ƒç”¨å‡å°‘â†’æ€§èƒ½æå‡
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦Buffer Poolï¼Ÿ**
```
æ€§èƒ½å·®è·ï¼š
â€¢ å†…å­˜è®¿é—®ï¼šçº³ç§’çº§
â€¢ ç£ç›˜è®¿é—®ï¼šæ¯«ç§’çº§
â€¢ å·®è·ï¼š100ä¸‡å€ï¼

ç¼“å†²æ± ä»·å€¼ï¼š
â€¢ å‡å°‘ç£ç›˜IOæ¬¡æ•°
â€¢ æä¾›æ•°æ®ä¿®æ”¹ç¼“å†²
â€¢ æ”¯æŒäº‹åŠ¡ACIDç‰¹æ€§
â€¢ å®ç°æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
```

**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ**
```
å¤šå±‚ä¿éšœæœºåˆ¶ï¼š
1. WALæœºåˆ¶ï¼šå…ˆå†™æ—¥å¿—å†å†™æ•°æ®
2. LSNè·Ÿè¸ªï¼šç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§  
3. æ£€æŸ¥ç‚¹ï¼šå®šæœŸæŒä¹…åŒ–çŠ¶æ€
4. å´©æºƒæ¢å¤ï¼šä¸‰é˜¶æ®µæ¢å¤è¿‡ç¨‹
5. é”æœºåˆ¶ï¼šé˜²æ­¢å¹¶å‘å†²çª
```

**ğŸ”¹ IOæ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ é¡ºåºIOï¼šé¡µé¢æ’åºï¼Œæ‰¹é‡å†™å…¥
â€¢ å¼‚æ­¥IOï¼šå‡å°‘ç­‰å¾…æ—¶é—´
â€¢ é¢„è¯»æœºåˆ¶ï¼šæ™ºèƒ½é¢„æµ‹è®¿é—®æ¨¡å¼
â€¢ ç³»ç»Ÿè°ƒç”¨ï¼šå‡å°‘è°ƒç”¨æ¬¡æ•°ï¼Œä½¿ç”¨é«˜æ•ˆæ¥å£
â€¢ ç¡¬ä»¶åˆ©ç”¨ï¼šå¤§é¡µå†…å­˜ï¼ŒDirect IO
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ æ•°æ®åº“ç®¡ç†å‘˜åº”ç”¨**
- **æ€§èƒ½è°ƒä¼˜**ï¼šç†è§£ç¼“å†²æ± å‚æ•°å¯¹æ€§èƒ½çš„å½±å“
- **æ•…éšœè¯Šæ–­**ï¼šé€šè¿‡IOæ¨¡å¼åˆ†æå®šä½é—®é¢˜
- **å®¹é‡è§„åˆ’**ï¼šåˆç†é…ç½®Buffer Poolå¤§å°
- **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®å…³é”®æŒ‡æ ‡çš„ç›‘æ§é˜ˆå€¼

**ğŸ‘¨â€ğŸ’» å¼€å‘å·¥ç¨‹å¸ˆåº”ç”¨**  
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šç†è§£ç´¢å¼•ä¸ç¼“å­˜çš„å…³ç³»
- **äº‹åŠ¡è®¾è®¡**ï¼šé¿å…é•¿äº‹åŠ¡å½±å“ç¼“å­˜æ•ˆç‡
- **æ¶æ„è®¾è®¡**ï¼šè€ƒè™‘æ•°æ®è®¿é—®æ¨¡å¼å¯¹ç¼“å­˜çš„å½±å“
- **æ€§èƒ½æµ‹è¯•**ï¼šè¯„ä¼°ä¸åŒè´Ÿè½½ä¸‹çš„ç¼“å­˜è¡¨ç°

### 9.4 å…³é”®é…ç½®å‚æ•°


**ğŸ”§ é‡è¦å‚æ•°è®¾ç½®**
```sql
-- Buffer Poolæ ¸å¿ƒå‚æ•°
SET GLOBAL innodb_buffer_pool_size = '8G';              -- Buffer Poolæ€»å¤§å°
SET GLOBAL innodb_buffer_pool_instances = 8;            -- å®ä¾‹æ•°é‡
SET GLOBAL innodb_old_blocks_pct = 37;                  -- å†·çƒ­æ•°æ®æ¯”ä¾‹

-- IOç›¸å…³å‚æ•°  
SET GLOBAL innodb_io_capacity = 2000;                   -- åå°IOèƒ½åŠ›
SET GLOBAL innodb_io_capacity_max = 4000;               -- æœ€å¤§IOèƒ½åŠ›
SET GLOBAL innodb_flush_log_at_trx_commit = 1;          -- äº‹åŠ¡æäº¤åˆ·æ–°ç­–ç•¥

-- é¢„è¯»å‚æ•°
SET GLOBAL innodb_read_ahead_threshold = 56;            -- çº¿æ€§é¢„è¯»é˜ˆå€¼
SET GLOBAL innodb_random_read_ahead = OFF;              -- éšæœºé¢„è¯»å¼€å…³

-- åˆ·æ–°æ§åˆ¶å‚æ•°
SET GLOBAL innodb_max_dirty_pages_pct = 75;             -- æœ€å¤§è„é¡µæ¯”ä¾‹
SET GLOBAL innodb_adaptive_flushing = ON;               -- è‡ªé€‚åº”åˆ·æ–°
```

### 9.5 ç›‘æ§ä¸è¯Šæ–­


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- Buffer Poolæ•ˆç‡ç›‘æ§
SELECT 
    pool_size,
    free_buffers,
    database_pages,
    pages_read_rate,
    pages_written_rate,
    buffer_pool_hit_rate
FROM information_schema.INNODB_BUFFER_POOL_STATS;

-- IOæ€§èƒ½ç›‘æ§
SHOW STATUS LIKE 'Innodb_buffer_pool%';
SHOW STATUS LIKE 'Innodb_data%';
SHOW STATUS LIKE 'Innodb_pages%';
```

**ğŸš¨ å¸¸è§é—®é¢˜è¯Šæ–­**
```
é—®é¢˜ç±»å‹åŠè§£å†³æ–¹æ¡ˆï¼š

1. ç¼“å­˜å‘½ä¸­ç‡ä½
   â€¢ ç°è±¡ï¼špages_read_rateæŒç»­å¾ˆé«˜
   â€¢ åŸå› ï¼šBuffer Poolå¤ªå°æˆ–è®¿é—®æ¨¡å¼éšæœºæ€§å¼º
   â€¢ è§£å†³ï¼šå¢å¤§Buffer Poolï¼Œä¼˜åŒ–æŸ¥è¯¢

2. è„é¡µç§¯ç´¯è¿‡å¤š
   â€¢ ç°è±¡ï¼šinnodb_buffer_pool_pages_dirtyæŒç»­å¢é•¿
   â€¢ åŸå› ï¼šå†™å…¥å‹åŠ›å¤§ï¼Œåˆ·æ–°è·Ÿä¸ä¸Š
   â€¢ è§£å†³ï¼šè°ƒæ•´IOèƒ½åŠ›å‚æ•°ï¼Œä¼˜åŒ–å†™å…¥æ¨¡å¼

3. IOç­‰å¾…æ—¶é—´é•¿  
   â€¢ ç°è±¡ï¼šiostatæ˜¾ç¤ºutil%å¾ˆé«˜
   â€¢ åŸå› ï¼šç£ç›˜æ€§èƒ½ç“¶é¢ˆæˆ–IOæ¨¡å¼ä¸ä½³
   â€¢ è§£å†³ï¼šå‡çº§å­˜å‚¨ï¼Œä¼˜åŒ–IOç­–ç•¥

4. æ¢å¤æ—¶é—´è¿‡é•¿
   â€¢ ç°è±¡ï¼šé‡å¯åé•¿æ—¶é—´å¤„äºæ¢å¤çŠ¶æ€
   â€¢ åŸå› ï¼šredo logå¤ªå¤§æˆ–è„é¡µå¤ªå¤š
   â€¢ è§£å†³ï¼šè°ƒæ•´æ£€æŸ¥ç‚¹é¢‘ç‡ï¼Œæ§åˆ¶è„é¡µæ¯”ä¾‹
```

### 9.6 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ**
```
1. Buffer Poolé…ç½®
   â€¢ å¤§å°ï¼šç‰©ç†å†…å­˜çš„70-80%
   â€¢ å®ä¾‹æ•°ï¼šCPUæ ¸å¿ƒæ•°æˆ–8ä¸ªï¼ˆå–è¾ƒå°å€¼ï¼‰
   â€¢ é¢„çƒ­ï¼šä½¿ç”¨innodb_buffer_pool_dump_at_shutdown

2. IOä¼˜åŒ–ç­–ç•¥
   â€¢ SSDï¼šå…³é—­é‚»è¿‘é¡µåˆ·æ–°ï¼Œå¢å¤§IOèƒ½åŠ›
   â€¢ æœºæ¢°ç›˜ï¼šå¼€å¯é‚»è¿‘é¡µåˆ·æ–°ï¼Œé€‚åº¦IOèƒ½åŠ›
   â€¢ æ•°æ®æ–‡ä»¶ï¼šä½¿ç”¨ç‹¬ç«‹è¡¨ç©ºé—´

3. ç›‘æ§å‘Šè­¦
   â€¢ ç¼“å­˜å‘½ä¸­ç‡ï¼š< 95%å‘Šè­¦
   â€¢ è„é¡µæ¯”ä¾‹ï¼š> 80%å‘Šè­¦  
   â€¢ IOç­‰å¾…ï¼š> 20%å‘Šè­¦
   â€¢ æ¢å¤æ—¶é—´ï¼š> 5åˆ†é’Ÿå‘Šè­¦

4. å®¹é‡è§„åˆ’
   â€¢ å®šæœŸè¯„ä¼°ç¼“å­˜æ•ˆç‡
   â€¢ æ ¹æ®ä¸šåŠ¡å¢é•¿è°ƒæ•´Buffer Pool
   â€¢ è€ƒè™‘è¯»å†™æ¯”ä¾‹ä¼˜åŒ–å‚æ•°
```

**ğŸ’¡ æ•…éšœé¢„é˜²å»ºè®®**
```
æ—¥å¸¸ç»´æŠ¤ï¼š
â€¢ å®šæœŸæ£€æŸ¥é”™è¯¯æ—¥å¿—ä¸­çš„IOç›¸å…³å‘Šè­¦
â€¢ ç›‘æ§Buffer Poolç»Ÿè®¡ä¿¡æ¯å˜åŒ–è¶‹åŠ¿
â€¢ æµ‹è¯•æ¢å¤æ—¶é—´å¹¶ä¼˜åŒ–æ¢å¤æµç¨‹
â€¢ å»ºç«‹IOæ€§èƒ½åŸºçº¿å¹¶æŒç»­å¯¹æ¯”

åº”æ€¥é¢„æ¡ˆï¼š
â€¢ å‡†å¤‡å¿«é€Ÿå¢å¤§Buffer Poolçš„æ–¹æ¡ˆ
â€¢ å»ºç«‹IOç“¶é¢ˆæ—¶çš„é™çº§ç­–ç•¥
â€¢ åˆ¶å®šé•¿æ—¶é—´æ¢å¤æ—¶çš„åº”å¯¹æªæ–½
â€¢ å‡†å¤‡å­˜å‚¨æ•…éšœæ—¶çš„æ•°æ®æ¢å¤æµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> Buffer Poolæ˜¯æ¡¥æ¢ï¼Œè¿æ¥å†…å­˜ä¸ç£ç›˜ï¼›
> è¯»å–å…ˆæŸ¥ç¼“å­˜ï¼Œæœªä¸­å†è®¿å­˜å‚¨ï¼›
> å†™å…¥å…ˆæ ‡è„é¡µï¼Œåå°æ‰¹é‡åˆ·æ–°ï¼›
> WALä¿ä¸€è‡´æ€§ï¼ŒLSNæ§ç‰ˆæœ¬å·ï¼›
> å´©æºƒä¸‰é˜¶æ®µæ¢å¤ï¼ŒIOä¼˜åŒ–ææ€§èƒ½ã€‚

**ğŸ¯ å­¦ä¹ æ£€æŸ¥ç‚¹**
- [ ] ç†è§£Buffer Poolçš„åŸºæœ¬ä½œç”¨å’Œæ¶æ„
- [ ] æŒæ¡é¡µé¢è¯»å–å’Œå†™å…¥çš„å®Œæ•´æµç¨‹
- [ ] æ˜ç™½WALæœºåˆ¶å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§
- [ ] äº†è§£å´©æºƒæ¢å¤çš„ä¸‰ä¸ªé˜¶æ®µ
- [ ] èƒ½å¤Ÿè¿›è¡ŒåŸºæœ¬çš„IOæ€§èƒ½ä¼˜åŒ–
- [ ] ä¼šç›‘æ§å’Œè¯Šæ–­å¸¸è§çš„Buffer Poolé—®é¢˜