---
title: 9、角色权限查询
---
## 📚 目录

1. [角色权限查询概述](#1-角色权限查询概述)
2. [SHOW GRANTS查询详解](#2-show-grants查询详解)
3. [系统表查询方法](#3-系统表查询方法)
4. [当前角色状态查询](#4-当前角色状态查询)
5. [权限有效性检查](#5-权限有效性检查)
6. [角色权限审计](#6-角色权限审计)
7. [安全控制与保护](#7-安全控制与保护)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 角色权限查询概述


### 1.1 什么是角色权限查询


**简单理解**：就是查看某个角色具体有哪些权限，或者查看某个用户通过角色获得了什么权限。

```
想象一个公司：
老板想知道：财务经理这个职位能做什么？
员工想知道：我现在有什么权限？
审计想知道：谁有访问敏感数据的权限？

MySQL角色权限查询就是回答这些问题的工具
```

### 1.2 查询的核心目的


**主要用途**：
- **权限审计** - 检查谁有什么权限
- **安全评估** - 发现权限风险点  
- **故障排查** - 找出权限不足的原因
- **合规检查** - 满足安全规范要求

### 1.3 查询方式概览


```
MySQL提供的查询途径：

┌─ SHOW GRANTS ──────────┐    ┌─ 系统表查询 ────────┐
│ • 查看用户/角色权限     │    │ • mysql.role_edges  │
│ • 显示继承关系         │    │ • INFORMATION_SCHEMA │
│ • 格式化输出           │    │ • 详细权限信息       │
└───────────────────────┘    └─────────────────────┘
           │                              │
           └────────── 结合使用 ──────────┘
```

---

## 2. 📋 SHOW GRANTS查询详解


### 2.1 基本SHOW GRANTS语法


**最简单的用法**：查看当前用户权限

```sql
-- 查看当前登录用户的权限
SHOW GRANTS;

-- 输出示例：
-- GRANT USAGE ON *.* TO `user1`@`localhost`
-- GRANT `role_app`@`%` TO `user1`@`localhost`
```

**查看指定用户权限**：

```sql
-- 查看特定用户权限
SHOW GRANTS FOR 'user1'@'localhost';

-- 查看角色权限
SHOW GRANTS FOR 'role_app'@'%';
```

### 2.2 查看角色的完整权限


**包含继承权限的查询**：

```sql
-- 查看用户的所有有效权限（包括角色继承的）
SHOW GRANTS FOR 'user1'@'localhost' USING 'role_app'@'%';
```

> 💡 **理解要点**：`USING`关键字让我们看到用户通过角色获得的权限，就像展开了角色这个"权限包"。

### 2.3 实际应用示例


**场景：检查用户的完整权限情况**

```sql
-- 1. 先查看用户直接权限
SHOW GRANTS FOR 'employee1'@'localhost';
-- 结果：GRANT `sales_role`@`%` TO `employee1`@`localhost`

-- 2. 再查看角色权限
SHOW GRANTS FOR 'sales_role'@'%';
-- 结果：GRANT SELECT, INSERT ON sales.* TO `sales_role`@`%`

-- 3. 查看用户的有效权限（展开角色）
SHOW GRANTS FOR 'employee1'@'localhost' USING 'sales_role'@'%';
-- 结果：显示用户通过角色获得的实际权限
```

### 2.4 输出格式解读


**权限显示格式**：

```sql
-- 标准格式：
GRANT privilege_type ON database.table TO 'role'@'host'

-- 实际例子：
GRANT SELECT, INSERT, UPDATE ON company.employees TO 'hr_role'@'%'
--    ↑权限类型        ↑作用范围           ↑角色名称
```

**角色分配显示格式**：

```sql
-- 格式：
GRANT 'role_name'@'host' TO 'user'@'host'

-- 例子：
GRANT 'manager_role'@'%' TO 'john'@'localhost'
--     ↑被分配的角色        ↑接收角色的用户
```

---

## 3. 🗃️ 系统表查询方法


### 3.1 mysql.role_edges表详解


**作用说明**：这个表记录了"谁给谁分配了什么角色"的关系。

```sql
-- 查看角色分配关系
SELECT 
    FROM_USER as '角色名',
    FROM_HOST as '角色主机',
    TO_USER as '用户名', 
    TO_HOST as '用户主机',
    WITH_ADMIN_OPTION as '是否有管理权限'
FROM mysql.role_edges;
```

**实际应用示例**：

```sql
-- 查找某个角色被分配给了哪些用户
SELECT 
    CONCAT(TO_USER, '@', TO_HOST) as '用户账号'
FROM mysql.role_edges 
WHERE FROM_USER = 'sales_role';

-- 查找某个用户被分配了哪些角色
SELECT 
    CONCAT(FROM_USER, '@', FROM_HOST) as '拥有角色'
FROM mysql.role_edges 
WHERE TO_USER = 'employee1';
```

### 3.2 INFORMATION_SCHEMA权限视图


**用户权限查询**：

```sql
-- 查看用户权限详情
SELECT 
    GRANTEE as '被授权者',
    TABLE_SCHEMA as '数据库',
    TABLE_NAME as '表名',
    PRIVILEGE_TYPE as '权限类型',
    IS_GRANTABLE as '可转授'
FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES 
WHERE GRANTEE LIKE '%sales_role%';
```

**列级权限查询**：

```sql
-- 查看列级权限
SELECT 
    GRANTEE,
    TABLE_SCHEMA,
    TABLE_NAME,
    COLUMN_NAME as '列名',
    PRIVILEGE_TYPE
FROM INFORMATION_SCHEMA.COLUMN_PRIVILEGES 
WHERE GRANTEE = "'hr_role'@'%'";
```

### 3.3 角色层次关系查询


**查询角色继承链**：

```sql
-- 递归查询角色继承关系（MySQL 8.0.1+）
WITH RECURSIVE role_hierarchy AS (
    -- 起始点：直接角色分配
    SELECT 
        FROM_USER as role_name,
        TO_USER as user_name,
        1 as level
    FROM mysql.role_edges
    WHERE TO_USER = 'target_user'
    
    UNION ALL
    
    -- 递归：查找角色的上级角色
    SELECT 
        re.FROM_USER,
        rh.user_name,
        rh.level + 1
    FROM mysql.role_edges re
    JOIN role_hierarchy rh ON re.TO_USER = rh.role_name
    WHERE rh.level < 5  -- 防止无限递归
)
SELECT * FROM role_hierarchy;
```

---

## 4. 👤 当前角色状态查询


### 4.1 CURRENT_ROLE函数


**查看当前激活的角色**：

```sql
-- 查看当前会话激活的角色
SELECT CURRENT_ROLE();

-- 可能的输出：
-- `sales_role`@`%`,`report_reader`@`%`
-- 表示当前激活了两个角色
```

### 4.2 查看角色激活状态


**检查角色是否生效**：

```sql
-- 查看所有可用角色和激活状态
SELECT 
    USER() as '当前用户',
    CURRENT_ROLE() as '激活角色';

-- 查看默认角色设置
SHOW VARIABLES LIKE 'activate_all_roles_on_login';
```

### 4.3 角色切换与激活


**动态激活角色**：

```sql
-- 激活特定角色
SET ROLE 'sales_role'@'%';

-- 激活所有分配的角色
SET ROLE ALL;

-- 取消激活的角色
SET ROLE NONE;

-- 检查激活结果
SELECT CURRENT_ROLE();
```

> ⚠️ **重要提醒**：角色需要先激活才能生效。就像穿衣服一样，衣服在衣柜里不穿是没用的。

---

## 5. ✅ 权限有效性检查


### 5.1 检查用户有效权限


**完整权限检查查询**：

```sql
-- 创建权限检查视图
CREATE VIEW user_effective_privileges AS
SELECT 
    u.User as '用户名',
    u.Host as '主机',
    CASE 
        WHEN tp.PRIVILEGE_TYPE IS NOT NULL THEN 
            CONCAT(tp.TABLE_SCHEMA, '.', tp.TABLE_NAME, ':', tp.PRIVILEGE_TYPE)
        ELSE '无表权限'
    END as '有效权限'
FROM mysql.user u
LEFT JOIN INFORMATION_SCHEMA.TABLE_PRIVILEGES tp 
    ON CONCAT("'", u.User, "'@'", u.Host, "'") = tp.GRANTEE
WHERE u.User = 'target_user';
```

### 5.2 权限冲突检查


**检查权限是否冲突**：

```sql
-- 检查同一用户是否有冲突的权限设置
SELECT 
    grantee,
    table_schema,
    table_name,
    GROUP_CONCAT(privilege_type) as '权限列表',
    COUNT(*) as '权限数量'
FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES 
WHERE grantee = "'sales_user'@'localhost'"
GROUP BY grantee, table_schema, table_name
HAVING COUNT(*) > 3;  -- 权限过多可能有问题
```

### 5.3 权限缺失诊断


**快速诊断权限问题**：

```sql
-- 检查用户是否能访问特定表
SELECT 
    CASE 
        WHEN COUNT(*) > 0 THEN '有权限'
        ELSE '无权限'
    END as '访问状态'
FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES 
WHERE grantee = "'user1'@'localhost'"
    AND table_schema = 'sales'
    AND table_name = 'orders'
    AND privilege_type IN ('SELECT', 'INSERT', 'UPDATE');
```

---

## 6. 📊 角色权限审计


### 6.1 权限审计报告生成


**生成角色权限总览报告**：

```sql
-- 创建审计报告
SELECT 
    re.FROM_USER as '角色名称',
    COUNT(DISTINCT re.TO_USER) as '分配用户数',
    GROUP_CONCAT(DISTINCT tp.PRIVILEGE_TYPE) as '拥有权限',
    COUNT(DISTINCT CONCAT(tp.TABLE_SCHEMA, '.', tp.TABLE_NAME)) as '涉及表数'
FROM mysql.role_edges re
LEFT JOIN INFORMATION_SCHEMA.TABLE_PRIVILEGES tp 
    ON CONCAT("'", re.FROM_USER, "'@'", re.FROM_HOST, "'") = tp.GRANTEE
GROUP BY re.FROM_USER
ORDER BY COUNT(DISTINCT re.TO_USER) DESC;
```

### 6.2 高风险权限检查


**识别敏感权限分配**：

```sql
-- 查找拥有危险权限的角色和用户
SELECT 
    grantee as '账号',
    privilege_type as '权限类型',
    table_schema as '数据库',
    CASE 
        WHEN privilege_type IN ('DELETE', 'DROP', 'ALTER') THEN '高风险'
        WHEN privilege_type = 'SUPER' THEN '超级权限'
        ELSE '普通权限'
    END as '风险等级'
FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES 
WHERE privilege_type IN ('DELETE', 'DROP', 'ALTER', 'CREATE', 'INDEX')
ORDER BY 风险等级 DESC, grantee;
```

### 6.3 权限使用情况分析


**分析权限使用频率**：

```sql
-- 结合性能模式查看权限使用情况
SELECT 
    user as '用户',
    host as '主机',
    db as '数据库',
    COUNT(*) as '访问次数'
FROM performance_schema.events_statements_history_long 
WHERE sql_text LIKE 'SELECT%' 
    AND user != 'root'
GROUP BY user, host, db
ORDER BY COUNT(*) DESC
LIMIT 10;
```

---

## 7. 🔒 安全控制与保护


### 7.1 查询权限的访问控制


**控制谁能查看权限信息**：

```sql
-- 创建权限查询专用角色
CREATE ROLE 'security_auditor'@'%';

-- 只给必要的查询权限
GRANT SELECT ON mysql.role_edges TO 'security_auditor'@'%';
GRANT SELECT ON INFORMATION_SCHEMA.TABLE_PRIVILEGES TO 'security_auditor'@'%';
GRANT SELECT ON INFORMATION_SCHEMA.COLUMN_PRIVILEGES TO 'security_auditor'@'%';

-- 不给修改权限
-- REVOKE INSERT, UPDATE, DELETE ON mysql.* FROM 'security_auditor'@'%';
```

### 7.2 敏感信息保护


**脱敏查询示例**：

```sql
-- 隐藏敏感用户信息的查询
SELECT 
    CASE 
        WHEN grantee LIKE '%root%' THEN '***管理员***'
        ELSE LEFT(grantee, 5)
    END as '用户(部分)',
    privilege_type as '权限',
    table_schema as '数据库'
FROM INFORMATION_SCHEMA.TABLE_PRIVILEGES 
WHERE table_schema NOT IN ('mysql', 'sys', 'information_schema');
```

### 7.3 查询日志审计


**记录权限查询操作**：

```sql
-- 启用查询日志记录
SET GLOBAL general_log = 'ON';
SET GLOBAL log_output = 'TABLE';

-- 查看权限相关的查询日志
SELECT 
    event_time as '查询时间',
    user_host as '用户',
    LEFT(argument, 100) as '查询内容'
FROM mysql.general_log 
WHERE argument LIKE '%GRANT%' 
    OR argument LIKE '%role_edges%'
    OR argument LIKE '%TABLE_PRIVILEGES%'
ORDER BY event_time DESC
LIMIT 20;
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的查询方法


```
🔸 SHOW GRANTS：最常用的权限查询命令
🔸 CURRENT_ROLE()：查看当前激活角色
🔸 mysql.role_edges：角色分配关系表
🔸 INFORMATION_SCHEMA权限视图：详细权限信息
🔸 权限有效性检查：确保权限正确生效
```

### 8.2 关键理解要点


**🔹 权限查询的层次性**
```
用户直接权限 → 用户分配的角色 → 角色的权限 → 最终有效权限

查询时要理解这个链条：
1. 用户有哪些角色？
2. 角色有哪些权限？  
3. 哪些角色被激活了？
4. 最终用户能做什么？
```

**🔹 角色激活的重要性**
```
关键概念：角色分配 ≠ 角色激活

分配了角色但没激活 = 有衣服但没穿
只有激活的角色权限才真正生效
```

**🔹 查询安全的重要性**
```
权限信息本身就是敏感信息：
- 谁能查看权限？
- 如何保护敏感账号信息？
- 怎样审计权限查询行为？
```

### 8.3 实际应用指南


**日常权限检查流程**
```
1. 先用 SHOW GRANTS 快速查看
2. 用 CURRENT_ROLE() 确认激活状态
3. 通过系统表查看详细信息
4. 结合业务需求验证权限正确性
```

**故障排查思路**
```
用户反映权限不够时：
1. 检查用户是否有相关角色
2. 检查角色是否已激活
3. 检查角色权限是否正确
4. 检查权限作用范围是否匹配
```

**安全审计要点**
```
定期检查项目：
- 高权限角色的分配情况
- 长期未使用的角色
- 权限过度分配的账号
- 敏感数据的访问权限
```

### 8.4 最佳实践建议


- **最小权限原则**：只给必要的查询权限
- **定期审计**：建立权限检查机制
- **文档记录**：保持权限分配的清晰记录
- **监控日志**：跟踪权限查询和使用情况

**核心记忆**：
- 权限查询不是简单的SHOW GRANTS，要理解角色激活和继承关系
- 系统表查询能提供更详细的权限分析能力  
- 权限信息本身需要保护，查询权限也要受控制
- 定期审计权限状态是数据库安全的重要环节