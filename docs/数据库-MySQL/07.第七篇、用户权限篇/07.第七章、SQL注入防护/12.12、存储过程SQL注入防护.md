---
title: 12ã€å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨è¿‡ç¨‹æ³¨å…¥é£é™©æ¦‚è¿°](#1-å­˜å‚¨è¿‡ç¨‹æ³¨å…¥é£é™©æ¦‚è¿°)
2. [åŠ¨æ€SQLæ„é€ å®‰å…¨](#2-åŠ¨æ€SQLæ„é€ å®‰å…¨)
3. [å‚æ•°ä¼ é€’éªŒè¯æœºåˆ¶](#3-å‚æ•°ä¼ é€’éªŒè¯æœºåˆ¶)
4. [æƒé™æœ€å°åŒ–åŸåˆ™](#4-æƒé™æœ€å°åŒ–åŸåˆ™)
5. [å­˜å‚¨è¿‡ç¨‹å®‰å…¨ç¼–ç è§„èŒƒ](#5-å­˜å‚¨è¿‡ç¨‹å®‰å…¨ç¼–ç è§„èŒƒ)
6. [æ³¨å…¥æ£€æµ‹ä¸å®¡è®¡](#6-æ³¨å…¥æ£€æµ‹ä¸å®¡è®¡)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ å­˜å‚¨è¿‡ç¨‹æ³¨å…¥é£é™©æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥


å­˜å‚¨è¿‡ç¨‹SQLæ³¨å…¥æ˜¯æŒ‡æ”»å‡»è€…é€šè¿‡å‘å­˜å‚¨è¿‡ç¨‹ä¼ å…¥æ¶æ„å‚æ•°ï¼Œåˆ©ç”¨åŠ¨æ€SQLæ„é€ æ¼æ´æ‰§è¡Œéé¢„æœŸSQLè¯­å¥çš„æ”»å‡»æ–¹å¼ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> å­˜å‚¨è¿‡ç¨‹è™½ç„¶é¢„ç¼–è¯‘ï¼Œä½†å¦‚æœå†…éƒ¨ä½¿ç”¨åŠ¨æ€SQLæ‹¼æ¥ï¼Œä»ç„¶å­˜åœ¨æ³¨å…¥é£é™©

**é£é™©äº§ç”ŸåŸç†ï¼š**
```
æ­£å¸¸è°ƒç”¨ï¼šCALL GetUser('admin')
æ¶æ„è°ƒç”¨ï¼šCALL GetUser("admin'; DROP TABLE users; --")

å¦‚æœå­˜å‚¨è¿‡ç¨‹å†…éƒ¨ç›´æ¥æ‹¼æ¥SQLï¼š
SET @sql = CONCAT('SELECT * FROM users WHERE name=', username);
ç»“æœï¼šSELECT * FROM users WHERE name=admin'; DROP TABLE users; --
```

### 1.2 å­˜å‚¨è¿‡ç¨‹æ³¨å…¥çš„å±å®³ç¨‹åº¦


**å±å®³ç­‰çº§åˆ†æï¼š**

| å±å®³çº§åˆ« | **å½±å“èŒƒå›´** | **å…·ä½“å±å®³** | **å‘ç”Ÿæ¦‚ç‡** |
|---------|-------------|-------------|-------------|
| ğŸ”´ **æé«˜** | `æ•°æ®åº“å®Œæ•´æ€§` | `åˆ é™¤/ä¿®æ”¹å…³é”®æ•°æ®` | `åŠ¨æ€SQLæ‹¼æ¥æ—¶` |
| ğŸŸ  **é«˜** | `æ•æ„Ÿä¿¡æ¯æ³„éœ²` | `ç»•è¿‡æƒé™è¯»å–æ•°æ®` | `å‚æ•°éªŒè¯ä¸è¶³` |
| ğŸŸ¡ **ä¸­** | `ä¸šåŠ¡é€»è¾‘ç»•è¿‡` | `æ‰§è¡Œæœªæˆæƒæ“ä½œ` | `æƒé™è®¾ç½®ä¸å½“` |

### 1.3 å¸¸è§æ³¨å…¥åœºæ™¯


**å…¸å‹æ¼æ´åœºæ™¯ï¼š**
```sql
-- å±é™©åœºæ™¯1ï¼šå­—ç¬¦ä¸²ç›´æ¥æ‹¼æ¥
DELIMITER //
CREATE PROCEDURE SearchUser(IN keyword VARCHAR(100))
BEGIN
    SET @sql = CONCAT('SELECT * FROM users WHERE name LIKE "%', keyword, '%"');
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //

-- å±é™©åœºæ™¯2ï¼šæ¡ä»¶åŠ¨æ€æ„é€ 
CREATE PROCEDURE GetUserData(IN conditions TEXT)
BEGIN
    SET @sql = CONCAT('SELECT * FROM users WHERE ', conditions);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
END //
```

---

## 2. ğŸ”§ åŠ¨æ€SQLæ„é€ å®‰å…¨


### 2.1 å®‰å…¨çš„åŠ¨æ€SQLç¼–å†™åŸåˆ™


åŠ¨æ€SQLæ˜¯å­˜å‚¨è¿‡ç¨‹æ³¨å…¥çš„ä¸»è¦é£é™©ç‚¹ï¼Œå¿…é¡»é‡‡ç”¨å‚æ•°åŒ–æ–¹å¼æ„é€ ã€‚

**å®‰å…¨æ„é€ æ–¹æ³•ï¼š**

```sql
-- âœ… å®‰å…¨æ–¹å¼ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
DELIMITER //
CREATE PROCEDURE SafeSearchUser(IN keyword VARCHAR(100))
BEGIN
    -- å‚æ•°éªŒè¯
    IF keyword IS NULL OR LENGTH(TRIM(keyword)) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'æœç´¢å…³é”®è¯ä¸èƒ½ä¸ºç©º';
    END IF;
    
    -- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    SELECT * FROM users 
    WHERE name LIKE CONCAT('%', keyword, '%')
    AND status = 'active';
END //

-- âœ… å¤æ‚æ¡ä»¶çš„å®‰å…¨å¤„ç†
CREATE PROCEDURE SafeGetUserWithConditions(
    IN search_name VARCHAR(100),
    IN min_age INT,
    IN department_id INT
)
BEGIN
    SELECT * FROM users u
    WHERE (search_name IS NULL OR u.name LIKE CONCAT('%', search_name, '%'))
    AND (min_age IS NULL OR u.age >= min_age)
    AND (department_id IS NULL OR u.department_id = department_id)
    AND u.status = 'active';
END //
```

### 2.2 åŠ¨æ€SQLçš„æ›¿ä»£æ–¹æ¡ˆ


**é¿å…åŠ¨æ€SQLçš„è®¾è®¡æ¨¡å¼ï¼š**

```sql
-- æ–¹æ¡ˆ1ï¼šå¤šä¸ªç‰¹å®šå­˜å‚¨è¿‡ç¨‹æ›¿ä»£é€šç”¨åŠ¨æ€SQL
CREATE PROCEDURE GetUserByName(IN user_name VARCHAR(100))
BEGIN
    SELECT * FROM users WHERE name = user_name AND status = 'active';
END //

CREATE PROCEDURE GetUserByEmail(IN user_email VARCHAR(150))
BEGIN
    SELECT * FROM users WHERE email = user_email AND status = 'active';
END //

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ¡ä»¶å‚æ•°æ§åˆ¶æŸ¥è¯¢é€»è¾‘
CREATE PROCEDURE FlexibleUserSearch(
    IN search_type ENUM('name', 'email', 'phone'),
    IN search_value VARCHAR(150)
)
BEGIN
    CASE search_type
        WHEN 'name' THEN
            SELECT * FROM users WHERE name = search_value;
        WHEN 'email' THEN
            SELECT * FROM users WHERE email = search_value;
        WHEN 'phone' THEN
            SELECT * FROM users WHERE phone = search_value;
        ELSE
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä¸æ”¯æŒçš„æœç´¢ç±»å‹';
    END CASE;
END //
```

### 2.3 å¿…è¦æ—¶çš„å®‰å…¨åŠ¨æ€SQLæ„é€ 


å½“ç¡®å®éœ€è¦åŠ¨æ€SQLæ—¶çš„å®‰å…¨å®ç°ï¼š

```sql
DELIMITER //
CREATE PROCEDURE SecureDynamicQuery(
    IN table_name VARCHAR(64),
    IN column_name VARCHAR(64), 
    IN search_value VARCHAR(255)
)
BEGIN
    DECLARE allowed_tables TEXT DEFAULT 'users,products,orders';
    DECLARE allowed_columns TEXT DEFAULT 'id,name,email,title,status';
    
    -- ç™½åå•éªŒè¯è¡¨å
    IF FIND_IN_SET(table_name, allowed_tables) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä¸å…è®¸çš„è¡¨å';
    END IF;
    
    -- ç™½åå•éªŒè¯åˆ—å
    IF FIND_IN_SET(column_name, allowed_columns) = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ä¸å…è®¸çš„åˆ—å';
    END IF;
    
    -- ä½¿ç”¨CASEè¯­å¥è€Œéå­—ç¬¦ä¸²æ‹¼æ¥
    CASE table_name
        WHEN 'users' THEN
            CASE column_name
                WHEN 'name' THEN SELECT * FROM users WHERE name = search_value;
                WHEN 'email' THEN SELECT * FROM users WHERE email = search_value;
            END CASE;
        WHEN 'products' THEN
            CASE column_name  
                WHEN 'name' THEN SELECT * FROM products WHERE name = search_value;
                WHEN 'title' THEN SELECT * FROM products WHERE title = search_value;
            END CASE;
    END CASE;
END //
```

---

## 3. ğŸ”’ å‚æ•°ä¼ é€’éªŒè¯æœºåˆ¶


### 3.1 è¾“å…¥å‚æ•°éªŒè¯ç­–ç•¥


å‚æ•°éªŒè¯æ˜¯é˜²æ­¢å­˜å‚¨è¿‡ç¨‹æ³¨å…¥çš„ç¬¬ä¸€é“é˜²çº¿ã€‚

**å®Œæ•´çš„å‚æ•°éªŒè¯æ¡†æ¶ï¼š**

```sql
DELIMITER //
CREATE PROCEDURE ValidatedUserOperation(
    IN user_id INT,
    IN user_name VARCHAR(50),
    IN user_email VARCHAR(100),
    IN operation_type ENUM('create', 'update', 'delete')
)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- å‚æ•°ç©ºå€¼æ£€æŸ¥
    IF operation_type IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'æ“ä½œç±»å‹ä¸èƒ½ä¸ºç©º';
    END IF;
    
    -- IDèŒƒå›´éªŒè¯
    IF operation_type IN ('update', 'delete') AND (user_id IS NULL OR user_id <= 0) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ç”¨æˆ·IDå¿…é¡»ä¸ºæ­£æ•´æ•°';
    END IF;
    
    -- å­—ç¬¦ä¸²é•¿åº¦å’Œæ ¼å¼éªŒè¯
    IF operation_type IN ('create', 'update') THEN
        IF user_name IS NULL OR LENGTH(TRIM(user_name)) < 2 THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦';
        END IF;
        
        IF user_email IS NULL OR user_email NOT REGEXP '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN
            SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
        END IF;
    END IF;
    
    -- æ‰§è¡Œç›¸åº”æ“ä½œ
    CASE operation_type
        WHEN 'create' THEN
            INSERT INTO users (name, email, created_at) VALUES (user_name, user_email, NOW());
        WHEN 'update' THEN
            UPDATE users SET name = user_name, email = user_email WHERE id = user_id;
        WHEN 'delete' THEN
            UPDATE users SET status = 'deleted', deleted_at = NOW() WHERE id = user_id;
    END CASE;
    
    COMMIT;
END //
```

### 3.2 ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤ä¸è½¬ä¹‰


**å­—ç¬¦ä¸²å®‰å…¨å¤„ç†ï¼š**

```sql
DELIMITER //
CREATE FUNCTION SafeStringFilter(input_str TEXT) 
RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE cleaned_str TEXT;
    
    -- ç§»é™¤NULLå­—ç¬¦å’Œæ§åˆ¶å­—ç¬¦
    SET cleaned_str = REPLACE(input_str, CHAR(0), '');
    SET cleaned_str = REPLACE(cleaned_str, CHAR(26), '');
    
    -- é™åˆ¶é•¿åº¦
    IF LENGTH(cleaned_str) > 1000 THEN
        SET cleaned_str = LEFT(cleaned_str, 1000);
    END IF;
    
    -- ç§»é™¤æ½œåœ¨å±é™©çš„SQLå…³é”®å­—
    IF UPPER(cleaned_str) REGEXP '.*(DROP|DELETE|TRUNCATE|ALTER|CREATE|EXEC|UNION|SELECT|INSERT|UPDATE).*' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'è¾“å…¥åŒ…å«å±é™©å­—ç¬¦';
    END IF;
    
    RETURN TRIM(cleaned_str);
END //

-- ä½¿ç”¨ç¤ºä¾‹
CREATE PROCEDURE SecureCommentAdd(IN comment_text TEXT)
BEGIN
    DECLARE safe_comment TEXT;
    SET safe_comment = SafeStringFilter(comment_text);
    
    INSERT INTO comments (content, created_at) VALUES (safe_comment, NOW());
END //
```

---

## 4. ğŸ›¡ï¸ æƒé™æœ€å°åŒ–åŸåˆ™


### 4.1 å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæƒé™æ§åˆ¶


å­˜å‚¨è¿‡ç¨‹åº”è¯¥ä»¥æœ€å°å¿…è¦æƒé™è¿è¡Œï¼Œé™åˆ¶å¯èƒ½çš„æ”»å‡»å½±å“ã€‚

**æƒé™åˆ†å±‚ç®¡ç†ï¼š**

```sql
-- åˆ›å»ºä¸“ç”¨çš„å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œç”¨æˆ·
CREATE USER 'sp_executor'@'localhost' IDENTIFIED BY 'SecurePassword123!';

-- åªæˆäºˆå¿…è¦çš„è¡¨çº§æƒé™
GRANT SELECT ON myapp.users TO 'sp_executor'@'localhost';
GRANT INSERT ON myapp.user_logs TO 'sp_executor'@'localhost';
GRANT UPDATE (last_login, login_count) ON myapp.users TO 'sp_executor'@'localhost';

-- æˆäºˆå­˜å‚¨è¿‡ç¨‹æ‰§è¡Œæƒé™
GRANT EXECUTE ON PROCEDURE myapp.UserLogin TO 'sp_executor'@'localhost';
GRANT EXECUTE ON PROCEDURE myapp.LogUserActivity TO 'sp_executor'@'localhost';

-- åˆ›å»ºæƒé™å—é™çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE DEFINER='sp_executor'@'localhost' 
PROCEDURE SecureUserLogin(
    IN login_email VARCHAR(100),
    IN client_ip VARCHAR(45)
)
SQL SECURITY DEFINER
BEGIN
    DECLARE user_count INT DEFAULT 0;
    DECLARE user_id INT;
    
    -- åªèƒ½æŸ¥è¯¢ç”¨æˆ·è¡¨
    SELECT COUNT(*), id INTO user_count, user_id
    FROM users 
    WHERE email = login_email AND status = 'active';
    
    IF user_count = 1 THEN
        -- åªèƒ½æ›´æ–°ç‰¹å®šå­—æ®µ
        UPDATE users 
        SET last_login = NOW(), login_count = login_count + 1
        WHERE id = user_id;
        
        -- åªèƒ½æ’å…¥æ—¥å¿—
        INSERT INTO user_logs (user_id, action, ip_address, created_at)
        VALUES (user_id, 'login', client_ip, NOW());
        
        SELECT 'success' as result, user_id;
    ELSE
        SELECT 'failed' as result, 0 as user_id;
    END IF;
END //
```

### 4.2 æ•°æ®åº“è¿æ¥æƒé™ç®¡ç†


**åº”ç”¨å±‚è¿æ¥æƒé™é…ç½®ï¼š**

```sql
-- ä¸ºä¸åŒåº”ç”¨åŠŸèƒ½åˆ›å»ºä¸åŒæƒé™çš„ç”¨æˆ·
-- åªè¯»ç”¨æˆ·ï¼ˆæŠ¥è¡¨ã€æŸ¥è¯¢ï¼‰
CREATE USER 'app_readonly'@'%' IDENTIFIED BY 'ReadOnlyPass123!';
GRANT SELECT ON myapp.users TO 'app_readonly'@'%';
GRANT SELECT ON myapp.orders TO 'app_readonly'@'%';
GRANT EXECUTE ON PROCEDURE myapp.GetUserReport TO 'app_readonly'@'%';

-- ä¸šåŠ¡ç”¨æˆ·ï¼ˆæ­£å¸¸ä¸šåŠ¡æ“ä½œï¼‰
CREATE USER 'app_business'@'%' IDENTIFIED BY 'BusinessPass123!';
GRANT SELECT, INSERT, UPDATE ON myapp.users TO 'app_business'@'%';
GRANT SELECT, INSERT, UPDATE ON myapp.orders TO 'app_business'@'%';
GRANT EXECUTE ON PROCEDURE myapp.CreateOrder TO 'app_business'@'%';
GRANT EXECUTE ON PROCEDURE myapp.UpdateUserInfo TO 'app_business'@'%';

-- ç®¡ç†ç”¨æˆ·ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
CREATE USER 'app_admin'@'%' IDENTIFIED BY 'AdminPass123!';
GRANT SELECT, INSERT, UPDATE, DELETE ON myapp.* TO 'app_admin'@'%';
GRANT EXECUTE ON PROCEDURE myapp.AdminUserManagement TO 'app_admin'@'%';
```

---

## 5. ğŸ“ å­˜å‚¨è¿‡ç¨‹å®‰å…¨ç¼–ç è§„èŒƒ


### 5.1 å®‰å…¨ç¼–ç æœ€ä½³å®è·µ


**æ ‡å‡†å®‰å…¨å­˜å‚¨è¿‡ç¨‹æ¨¡æ¿ï¼š**

```sql
DELIMITER //
CREATE PROCEDURE StandardSecureProcedure(
    IN param1 VARCHAR(100),
    IN param2 INT,
    OUT result_status INT,
    OUT result_message VARCHAR(255)
)
COMMENT 'æ ‡å‡†å®‰å…¨å­˜å‚¨è¿‡ç¨‹æ¨¡æ¿'
SQL SECURITY DEFINER
BEGIN
    -- å£°æ˜å˜é‡å’Œå¼‚å¸¸å¤„ç†
    DECLARE done INT DEFAULT 0;
    DECLARE error_count INT DEFAULT 0;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            result_status = MYSQL_ERRNO, result_message = MESSAGE_TEXT;
        ROLLBACK;
        SET result_status = -1;
    END;
    
    -- è®¾ç½®é»˜è®¤è¿”å›å€¼
    SET result_status = 0;
    SET result_message = 'success';
    
    START TRANSACTION;
    
    -- è¾“å…¥éªŒè¯å—
    IF param1 IS NULL OR LENGTH(TRIM(param1)) = 0 THEN
        SET result_status = 1001;
        SET result_message = 'å‚æ•°1ä¸èƒ½ä¸ºç©º';
        ROLLBACK;
        LEAVE proc_label;
    END IF;
    
    IF param2 IS NULL OR param2 <= 0 THEN
        SET result_status = 1002;
        SET result_message = 'å‚æ•°2å¿…é¡»ä¸ºæ­£æ•´æ•°';
        ROLLBACK;
        LEAVE proc_label;
    END IF;
    
    -- ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
    proc_label: BEGIN
        -- æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        INSERT INTO example_table (column1, column2, created_at)
        VALUES (param1, param2, NOW());
        
        -- è®°å½•æ“ä½œæ—¥å¿—
        INSERT INTO operation_logs (operation, parameters, executed_at)
        VALUES ('StandardSecureProcedure', CONCAT(param1, ',', param2), NOW());
        
    END proc_label;
    
    COMMIT;
END //
```

### 5.2 é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•


**å®‰å…¨çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š**

```sql
DELIMITER //
CREATE PROCEDURE SecureErrorHandling()
BEGIN
    DECLARE custom_error_code INT DEFAULT 0;
    DECLARE custom_error_msg VARCHAR(255) DEFAULT '';
    
    -- é€šç”¨å¼‚å¸¸å¤„ç†å™¨
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        GET DIAGNOSTICS CONDITION 1
            custom_error_code = MYSQL_ERRNO,
            custom_error_msg = MESSAGE_TEXT;
            
        -- è®°å½•é”™è¯¯æ—¥å¿—ï¼ˆä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼‰
        INSERT INTO error_logs (error_code, error_type, logged_at)
        VALUES (custom_error_code, 'STORED_PROCEDURE_ERROR', NOW());
        
        -- å›æ»šäº‹åŠ¡
        ROLLBACK;
        
        -- è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
        SELECT 'error' as status, 'Internal database error' as message;
    END;
    
    START TRANSACTION;
    
    -- ä¸šåŠ¡é€»è¾‘
    -- ...
    
    COMMIT;
    SELECT 'success' as status, 'Operation completed' as message;
END //
```

---

## 6. ğŸ” æ³¨å…¥æ£€æµ‹ä¸å®¡è®¡


### 6.1 å­˜å‚¨è¿‡ç¨‹å®¡è®¡æœºåˆ¶


**å®¡è®¡æ—¥å¿—è®°å½•ç³»ç»Ÿï¼š**

```sql
-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE stored_procedure_audit (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    procedure_name VARCHAR(100) NOT NULL,
    parameters TEXT,
    user_account VARCHAR(100),
    client_ip VARCHAR(45),
    execution_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    execution_duration INT,
    result_status VARCHAR(20),
    INDEX idx_procedure_time (procedure_name, execution_time),
    INDEX idx_user_time (user_account, execution_time)
);

-- å®¡è®¡å­˜å‚¨è¿‡ç¨‹æ¨¡æ¿
DELIMITER //
CREATE PROCEDURE AuditedSecureProcedure(
    IN input_param VARCHAR(100)
)
BEGIN
    DECLARE start_time TIMESTAMP DEFAULT NOW(3);
    DECLARE proc_duration INT;
    DECLARE result_status VARCHAR(20) DEFAULT 'success';
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SET result_status = 'error';
        SET proc_duration = TIMESTAMPDIFF(MICROSECOND, start_time, NOW(3));
        
        -- è®°å½•å®¡è®¡æ—¥å¿—
        INSERT INTO stored_procedure_audit 
        (procedure_name, parameters, user_account, execution_duration, result_status)
        VALUES 
        ('AuditedSecureProcedure', input_param, USER(), proc_duration, result_status);
        
        ROLLBACK;
        RESIGNAL;
    END;
    
    START TRANSACTION;
    
    -- æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    SELECT * FROM users WHERE name = input_param;
    
    COMMIT;
    
    -- è®°å½•æˆåŠŸæ‰§è¡Œçš„å®¡è®¡æ—¥å¿—
    SET proc_duration = TIMESTAMPDIFF(MICROSECOND, start_time, NOW(3));
    INSERT INTO stored_procedure_audit 
    (procedure_name, parameters, user_account, execution_duration, result_status)
    VALUES 
    ('AuditedSecureProcedure', input_param, USER(), proc_duration, result_status);
END //
```

### 6.2 æ³¨å…¥æ£€æµ‹æŸ¥è¯¢


**æ£€æµ‹å¯ç–‘å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ï¼š**

```sql
-- æ£€æµ‹å¼‚å¸¸å‚æ•°æ¨¡å¼
SELECT 
    procedure_name,
    parameters,
    user_account,
    execution_time,
    COUNT(*) as call_count
FROM stored_procedure_audit 
WHERE 
    execution_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
    AND (
        parameters LIKE '%DROP%'
        OR parameters LIKE '%DELETE%' 
        OR parameters LIKE '%UNION%'
        OR parameters LIKE '%SELECT%'
        OR parameters LIKE '%INSERT%'
        OR parameters LIKE '%UPDATE%'
        OR parameters LIKE '%--;%'
        OR parameters LIKE '%/*%'
    )
GROUP BY procedure_name, parameters, user_account
ORDER BY call_count DESC;

-- æ£€æµ‹å¼‚å¸¸è°ƒç”¨é¢‘ç‡
SELECT 
    user_account,
    procedure_name,
    DATE(execution_time) as call_date,
    COUNT(*) as daily_calls,
    AVG(execution_duration) as avg_duration
FROM stored_procedure_audit
WHERE execution_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY user_account, procedure_name, DATE(execution_time)
HAVING daily_calls > 1000 OR avg_duration > 5000000
ORDER BY daily_calls DESC;
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸåˆ™


```
ğŸ”¸ å‚æ•°åŒ–æŸ¥è¯¢ï¼šå­˜å‚¨è¿‡ç¨‹å†…éƒ¨ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥SQL
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šæ‰€æœ‰å‚æ•°å¿…é¡»éªŒè¯ç±»å‹ã€é•¿åº¦ã€æ ¼å¼
ğŸ”¸ æƒé™æœ€å°åŒ–ï¼šå­˜å‚¨è¿‡ç¨‹åªè·å¾—å¿…è¦çš„æœ€å°æƒé™
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰å­˜å‚¨è¿‡ç¨‹è°ƒç”¨å’Œå‚æ•°
```

### 7.2 å…³é”®é˜²æŠ¤æªæ–½


**ğŸ”¹ ä»£ç å±‚é¢é˜²æŠ¤ï¼š**
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ›¿ä»£åŠ¨æ€SQLæ‹¼æ¥
- ä¸¥æ ¼çš„è¾“å…¥éªŒè¯å’Œç±»å‹æ£€æŸ¥
- ç™½åå•éªŒè¯è¡¨åå’Œåˆ—å
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶

**ğŸ”¹ æƒé™å±‚é¢é˜²æŠ¤ï¼š**
- åˆ›å»ºä¸“ç”¨çš„å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œç”¨æˆ·
- æŒ‰åŠŸèƒ½åˆ†é…ä¸åŒæƒé™çº§åˆ«
- é™åˆ¶å­˜å‚¨è¿‡ç¨‹çš„è¡¨è®¿é—®æƒé™
- å®šæœŸå®¡æŸ¥æƒé™é…ç½®

**ğŸ”¹ ç›‘æ§å±‚é¢é˜²æŠ¤ï¼š**
- å®¡è®¡æ‰€æœ‰å­˜å‚¨è¿‡ç¨‹è°ƒç”¨
- ç›‘æ§å¼‚å¸¸å‚æ•°æ¨¡å¼
- æ£€æµ‹é«˜é¢‘æˆ–å¼‚å¸¸è°ƒç”¨
- å»ºç«‹å®‰å…¨å‘Šè­¦æœºåˆ¶

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**å®‰å…¨æ£€æŸ¥æ¸…å•ï¼š**
- [ ] å­˜å‚¨è¿‡ç¨‹æ˜¯å¦ä½¿ç”¨äº†åŠ¨æ€SQLæ‹¼æ¥
- [ ] æ‰€æœ‰è¾“å…¥å‚æ•°æ˜¯å¦è¿›è¡Œäº†éªŒè¯
- [ ] æ˜¯å¦è®¾ç½®äº†é€‚å½“çš„æƒé™æ§åˆ¶
- [ ] é”™è¯¯å¤„ç†æ˜¯å¦å®‰å…¨
- [ ] æ˜¯å¦è®°å½•äº†å®¡è®¡æ—¥å¿—
- [ ] æ˜¯å¦å®šæœŸè¿›è¡Œå®‰å…¨å®¡æŸ¥

> **ğŸ’¡ æ ¸å¿ƒè®°å¿†**  
> å­˜å‚¨è¿‡ç¨‹å®‰å…¨ä¸‰è¦ç´ ï¼šå‚æ•°åŒ–ï¼ˆé˜²æ³¨å…¥ï¼‰+ æƒé™æ§åˆ¶ï¼ˆé™å½±å“ï¼‰+ å®¡è®¡ç›‘æ§ï¼ˆæ—©å‘ç°ï¼‰

**å®‰å…¨ç¼–ç å£è¯€ï¼š**
```
å‚æ•°éªŒè¯è¦ä¸¥æ ¼ï¼ŒåŠ¨æ€æ‹¼æ¥è¦æœç»
æƒé™æœ€å°ä¿å®‰å…¨ï¼Œå®¡è®¡æ—¥å¿—è¦è¯¦ç»†
é”™è¯¯å¤„ç†è¦ç»Ÿä¸€ï¼Œæ•æ„Ÿä¿¡æ¯ä¸æš´éœ²
```

### 7.4 å¸¸è§è¯¯åŒºä¸æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§å®‰å…¨è¯¯åŒºï¼š**
- è®¤ä¸ºå­˜å‚¨è¿‡ç¨‹å¤©ç„¶å®‰å…¨ï¼Œå¿½ç•¥å†…éƒ¨SQLæ³¨å…¥é£é™©
- åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„é€ SQL
- æƒé™è®¾ç½®è¿‡äºå®½æ³›ï¼Œè¿èƒŒæœ€å°æƒé™åŸåˆ™
- é”™è¯¯ä¿¡æ¯æš´éœ²è¿‡å¤šå†…éƒ¨å®ç°ç»†èŠ‚
- ç¼ºä¹å¯¹å­˜å‚¨è¿‡ç¨‹è°ƒç”¨çš„å®¡è®¡å’Œç›‘æ§

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®ï¼š**
- å»ºç«‹å­˜å‚¨è¿‡ç¨‹å®‰å…¨å¼€å‘è§„èŒƒ
- å®æ–½ä»£ç å®¡æŸ¥æœºåˆ¶
- å®šæœŸè¿›è¡Œå®‰å…¨æµ‹è¯•
- ä¿æŒå®‰å…¨æ„è¯†åŸ¹è®­
- å»ºç«‹åº”æ€¥å“åº”é¢„æ¡ˆ