---
title: 6ã€å‚æ•°åŒ–æŸ¥è¯¢æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [SQLæ³¨å…¥æ”»å‡»åŸç†](#1-SQLæ³¨å…¥æ”»å‡»åŸç†)
2. [å‚æ•°åŒ–æŸ¥è¯¢åŸºç¡€](#2-å‚æ•°åŒ–æŸ¥è¯¢åŸºç¡€)
3. [é¢„ç¼–è¯‘è¯­å¥å®ç°](#3-é¢„ç¼–è¯‘è¯­å¥å®ç°)
4. [PreparedStatementæœ€ä½³å®è·µ](#4-PreparedStatementæœ€ä½³å®è·µ)
5. [å­˜å‚¨è¿‡ç¨‹å®‰å…¨è°ƒç”¨](#5-å­˜å‚¨è¿‡ç¨‹å®‰å…¨è°ƒç”¨)
6. [ORMæ¡†æ¶å®‰å…¨é…ç½®](#6-ORMæ¡†æ¶å®‰å…¨é…ç½®)
7. [åŠ¨æ€SQLå®‰å…¨æ›¿ä»£æ–¹æ¡ˆ](#7-åŠ¨æ€SQLå®‰å…¨æ›¿ä»£æ–¹æ¡ˆ)
8. [æ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨å¹³è¡¡](#8-æ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨å¹³è¡¡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ SQLæ³¨å…¥æ”»å‡»åŸç†


### 1.1 ä»€ä¹ˆæ˜¯SQLæ³¨å…¥


**SQLæ³¨å…¥**ï¼šæ”»å‡»è€…é€šè¿‡åœ¨è¾“å…¥æ•°æ®ä¸­æ’å…¥æ¶æ„SQLä»£ç ï¼Œæ”¹å˜åŸæœ‰æŸ¥è¯¢é€»è¾‘çš„å®‰å…¨æ¼æ´ã€‚

```
å±é™©çš„æ‹¼æ¥æŸ¥è¯¢ç¤ºä¾‹ï¼š
String sql = "SELECT * FROM users WHERE username='" + username + "' AND password='" + password + "'";

æ­£å¸¸è¾“å…¥ï¼š
username = "john"
password = "123456"
ç”ŸæˆSQLï¼šSELECT * FROM users WHERE username='john' AND password='123456'

æ¶æ„è¾“å…¥ï¼š
username = "admin' --"
password = "ä»»æ„å€¼"
ç”ŸæˆSQLï¼šSELECT * FROM users WHERE username='admin' --' AND password='ä»»æ„å€¼'
ç»“æœï¼š-- æ³¨é‡Šæ‰äº†å¯†ç éªŒè¯ï¼Œç›´æ¥ä»¥adminèº«ä»½ç™»å½•ï¼
```

### 1.2 SQLæ³¨å…¥çš„å±å®³


**æ”»å‡»åæœåˆ†æ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš¨ SQLæ³¨å…¥å¯èƒ½é€ æˆçš„å±å®³            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š æ•°æ®æ³„éœ²ï¼šè·å–æ•æ„Ÿç”¨æˆ·ä¿¡æ¯        â”‚
â”‚ ğŸ’€ æ•°æ®åˆ é™¤ï¼šDROP TABLEç­‰ç ´åæ“ä½œ   â”‚
â”‚ ğŸ”“ æƒé™æå‡ï¼šç»•è¿‡èº«ä»½éªŒè¯           â”‚
â”‚ ğŸ­ èº«ä»½ä¼ªé€ ï¼šä»¥å…¶ä»–ç”¨æˆ·èº«ä»½æ“ä½œ      â”‚
â”‚ ğŸ’° ä¸šåŠ¡æŸå¤±ï¼šç¯¡æ”¹è®¢å•ã€é‡‘é¢ç­‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å¸¸è§æ³¨å…¥ç±»å‹


**æ³¨å…¥æ”»å‡»åˆ†ç±»**ï¼š
```
è”åˆæŸ¥è¯¢æ³¨å…¥ï¼š
' UNION SELECT password FROM admin_users --

å¸ƒå°”ç›²æ³¨ï¼š
' AND (SELECT COUNT(*) FROM users) > 10 --

æ—¶é—´ç›²æ³¨ï¼š
'; IF(1=1, SLEEP(5), 0) --

æŠ¥é”™æ³¨å…¥ï¼š
' AND extractvalue(1, concat(0x7e, (SELECT version()), 0x7e)) --
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šSQLæ³¨å…¥çš„æ ¹æœ¬åŸå› æ˜¯å°†ç”¨æˆ·è¾“å…¥å½“ä½œSQLä»£ç æ‰§è¡Œï¼Œè€Œä¸æ˜¯å½“ä½œçº¯æ•°æ®å¤„ç†ã€‚

---

## 2. ğŸ›¡ï¸ å‚æ•°åŒ–æŸ¥è¯¢åŸºç¡€


### 2.1 ä»€ä¹ˆæ˜¯å‚æ•°åŒ–æŸ¥è¯¢


**å‚æ•°åŒ–æŸ¥è¯¢**ï¼šå°†SQLè¯­å¥å’Œå‚æ•°åˆ†ç¦»ï¼Œè®©æ•°æ®åº“å¼•æ“åŒºåˆ†ä»£ç å’Œæ•°æ®çš„æŸ¥è¯¢æ–¹å¼ã€‚

```
ä¼ ç»Ÿæ‹¼æ¥æ–¹å¼ï¼ˆå±é™©ï¼‰ï¼š
SQL = "SELECT * FROM users WHERE id=" + userId

å‚æ•°åŒ–æ–¹å¼ï¼ˆå®‰å…¨ï¼‰ï¼š
SQL = "SELECT * FROM users WHERE id=?"
å‚æ•° = [userId]

å…³é”®åŒºåˆ«ï¼š
- æ‹¼æ¥ï¼šç”¨æˆ·è¾“å…¥ç›´æ¥æˆä¸ºSQLä»£ç çš„ä¸€éƒ¨åˆ†
- å‚æ•°åŒ–ï¼šç”¨æˆ·è¾“å…¥ä»…ä½œä¸ºæ•°æ®å€¼ä¼ é€’
```

### 2.2 å‚æ•°åŒ–æŸ¥è¯¢å·¥ä½œåŸç†


**æ‰§è¡Œæœºåˆ¶è¯¦è§£**ï¼š
```
æ­¥éª¤1ï¼šSQLè§£æ
æ•°æ®åº“è§£æSQLç»“æ„ï¼šSELECT * FROM users WHERE id=?
ç¡®å®šæŸ¥è¯¢è®¡åˆ’ï¼Œ? è¢«è¯†åˆ«ä¸ºå‚æ•°å ä½ç¬¦

æ­¥éª¤2ï¼šå‚æ•°ç»‘å®š  
å°†ç”¨æˆ·è¾“å…¥ç»‘å®šåˆ°å ä½ç¬¦ï¼š? â†’ 123
æ­¤æ—¶è¾“å…¥è¢«å½“ä½œæ•°æ®å€¼ï¼Œä¸ä¼šè¢«è§£æä¸ºSQLä»£ç 

æ­¥éª¤3ï¼šæ‰§è¡ŒæŸ¥è¯¢
æŒ‰ç…§é¢„å®šè®¡åˆ’æ‰§è¡Œï¼Œå‚æ•°å€¼ä¸å½±å“SQLç»“æ„
```

**å®‰å…¨åŸç†å›¾è§£**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SQLæ¨¡æ¿       â”‚    â”‚   å‚æ•°æ•°æ®      â”‚
â”‚ SELECT * FROM   â”‚    â”‚   userId=123    â”‚
â”‚ users WHERE     â”‚ +  â”‚   name="john"   â”‚ = å®‰å…¨æ‰§è¡Œ
â”‚ id=? AND        â”‚    â”‚   status=1      â”‚
â”‚ name=?          â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å‚æ•°å ä½ç¬¦ç±»å‹


**MySQLæ”¯æŒçš„å ä½ç¬¦**ï¼š
```
? å ä½ç¬¦ï¼ˆæ¨èï¼‰ï¼š
SELECT * FROM users WHERE id=? AND status=?

å‘½åå ä½ç¬¦ï¼ˆæŸäº›é©±åŠ¨æ”¯æŒï¼‰ï¼š
SELECT * FROM users WHERE id=:id AND status=:status

ä½ç½®å ä½ç¬¦ï¼š
SELECT * FROM users WHERE id=$1 AND status=$2
```

---

## 3. âš™ï¸ é¢„ç¼–è¯‘è¯­å¥å®ç°


### 3.1 MySQLé¢„ç¼–è¯‘è¯­å¥åŸç†


**PREPAREè¯­å¥æœºåˆ¶**ï¼šé¢„ç¼–è¯‘è¯­å¥å°†SQLçš„ç¼–è¯‘å’Œæ‰§è¡Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚

```sql
-- ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡è¯­å¥ï¼ˆç¼–è¯‘ï¼‰
PREPARE stmt FROM 'SELECT * FROM users WHERE id=? AND status=?';

-- ç¬¬äºŒé˜¶æ®µï¼šæ‰§è¡Œè¯­å¥ï¼ˆè¿è¡Œï¼‰
SET @user_id = 123;
SET @user_status = 1;
EXECUTE stmt USING @user_id, @user_status;

-- æ¸…ç†èµ„æº
DEALLOCATE PREPARE stmt;
```

### 3.2 é¢„ç¼–è¯‘å®‰å…¨æœºåˆ¶


**å®‰å…¨ä¿éšœåŸç†**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” é¢„ç¼–è¯‘å®‰å…¨æœºåˆ¶                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… SQLç»“æ„å›ºå®šï¼šç¼–è¯‘æ—¶ç¡®å®šæŸ¥è¯¢ç»“æ„   â”‚
â”‚ âœ… å‚æ•°éš”ç¦»ï¼šæ•°æ®å’Œä»£ç å®Œå…¨åˆ†ç¦»      â”‚
â”‚ âœ… ç±»å‹æ£€æŸ¥ï¼šå‚æ•°ç±»å‹é¢„å…ˆéªŒè¯        â”‚
â”‚ âœ… è¯­æ³•ä¿æŠ¤ï¼šæ¶æ„ä»£ç æ— æ³•æ”¹å˜è¯­æ³•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é¢„ç¼–è¯‘æ€§èƒ½ä¼˜åŠ¿


**æ€§èƒ½æå‡åˆ†æ**ï¼š
```sql
-- ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡éƒ½è¦ç¼–è¯‘
SELECT * FROM users WHERE id=123;  -- ç¼–è¯‘+æ‰§è¡Œ
SELECT * FROM users WHERE id=456;  -- é‡æ–°ç¼–è¯‘+æ‰§è¡Œ
SELECT * FROM users WHERE id=789;  -- é‡æ–°ç¼–è¯‘+æ‰§è¡Œ

-- é¢„ç¼–è¯‘æ–¹å¼ï¼šç¼–è¯‘ä¸€æ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ
PREPARE stmt FROM 'SELECT * FROM users WHERE id=?';  -- ç¼–è¯‘ä¸€æ¬¡
EXECUTE stmt USING @id1;  -- ä»…æ‰§è¡Œ
EXECUTE stmt USING @id2;  -- ä»…æ‰§è¡Œ
EXECUTE stmt USING @id3;  -- ä»…æ‰§è¡Œ
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```
ä¼ ç»ŸæŸ¥è¯¢ï¼šè§£æâ†’ç¼–è¯‘â†’ä¼˜åŒ–â†’æ‰§è¡Œ (æ¯æ¬¡é‡å¤)
é¢„ç¼–è¯‘æŸ¥è¯¢ï¼šè§£æâ†’ç¼–è¯‘â†’ä¼˜åŒ– (ä¸€æ¬¡) + æ‰§è¡Œ (å¤šæ¬¡)

æ€§èƒ½æå‡ï¼š
- å‡å°‘SQLè§£æå¼€é”€
- æŸ¥è¯¢è®¡åˆ’ç¼“å­˜å¤ç”¨
- ç½‘ç»œä¼ è¾“ä¼˜åŒ–
```

---

## 4. ğŸ’» PreparedStatementæœ€ä½³å®è·µ


### 4.1 Javaä¸­çš„PreparedStatement


**åŸºç¡€ä½¿ç”¨æ–¹å¼**ï¼š
```java
// æ­£ç¡®çš„å‚æ•°åŒ–æŸ¥è¯¢
public User getUserById(int userId) {
    String sql = "SELECT id, username, email FROM users WHERE id = ?";
    
    try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
        pstmt.setInt(1, userId);
        ResultSet rs = pstmt.executeQuery();
        
        if (rs.next()) {
            return new User(
                rs.getInt("id"),
                rs.getString("username"), 
                rs.getString("email")
            );
        }
    } catch (SQLException e) {
        log.error("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
    }
    return null;
}
```

### 4.2 å‚æ•°ç±»å‹ç»‘å®š


**å¸¸ç”¨å‚æ•°è®¾ç½®æ–¹æ³•**ï¼š
```java
PreparedStatement pstmt = connection.prepareStatement(
    "INSERT INTO users (username, email, age, created_time) VALUES (?, ?, ?, ?)"
);

// å­—ç¬¦ä¸²å‚æ•°
pstmt.setString(1, "john_doe");

// æ•´æ•°å‚æ•°  
pstmt.setInt(3, 25);

// æ—¥æœŸå‚æ•°
pstmt.setTimestamp(4, new Timestamp(System.currentTimeMillis()));

// NULLå€¼å¤„ç†
pstmt.setNull(2, Types.VARCHAR);

// æ‰§è¡Œæ’å…¥
int rows = pstmt.executeUpdate();
```

### 4.3 æ‰¹é‡æ“ä½œå®‰å…¨å®ç°


**å®‰å…¨çš„æ‰¹é‡æ’å…¥**ï¼š
```java
public void batchInsertUsers(List<User> users) {
    String sql = "INSERT INTO users (username, email) VALUES (?, ?)";
    
    try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
        for (User user : users) {
            pstmt.setString(1, user.getUsername());
            pstmt.setString(2, user.getEmail());
            pstmt.addBatch();  // æ·»åŠ åˆ°æ‰¹æ¬¡
        }
        
        int[] results = pstmt.executeBatch();  // æ‰§è¡Œæ‰¹é‡æ“ä½œ
        log.info("æ‰¹é‡æ’å…¥å®Œæˆï¼Œå½±å“è¡Œæ•°ï¼š{}", results.length);
        
    } catch (SQLException e) {
        log.error("æ‰¹é‡æ’å…¥å¤±è´¥", e);
    }
}
```

### 4.4 åŠ¨æ€æ¡ä»¶æŸ¥è¯¢å®ç°


**å®‰å…¨çš„åŠ¨æ€æŸ¥è¯¢æ„å»º**ï¼š
```java
public List<User> searchUsers(String username, String email, Integer minAge) {
    StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE 1=1");
    List<Object> params = new ArrayList<>();
    
    if (username != null) {
        sql.append(" AND username LIKE ?");
        params.add("%" + username + "%");
    }
    
    if (email != null) {
        sql.append(" AND email = ?");
        params.add(email);
    }
    
    if (minAge != null) {
        sql.append(" AND age >= ?");
        params.add(minAge);
    }
    
    try (PreparedStatement pstmt = connection.prepareStatement(sql.toString())) {
        // è®¾ç½®å‚æ•°
        for (int i = 0; i < params.size(); i++) {
            pstmt.setObject(i + 1, params.get(i));
        }
        
        return executeAndMapResults(pstmt);
    }
}
```

---

## 5. ğŸ—„ï¸ å­˜å‚¨è¿‡ç¨‹å®‰å…¨è°ƒç”¨


### 5.1 å­˜å‚¨è¿‡ç¨‹çš„å®‰å…¨ä¼˜åŠ¿


**å­˜å‚¨è¿‡ç¨‹é˜²æŠ¤æœºåˆ¶**ï¼šå­˜å‚¨è¿‡ç¨‹å°†ä¸šåŠ¡é€»è¾‘å°è£…åœ¨æ•°æ®åº“å†…éƒ¨ï¼Œå‡å°‘SQLæ³¨å…¥é£é™©ã€‚

```sql
-- åˆ›å»ºå®‰å…¨çš„ç”¨æˆ·éªŒè¯å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE ValidateUser(
    IN p_username VARCHAR(50),
    IN p_password VARCHAR(255),
    OUT p_user_id INT,
    OUT p_is_valid BOOLEAN
)
BEGIN
    DECLARE user_count INT DEFAULT 0;
    
    SELECT COUNT(*), id INTO user_count, p_user_id
    FROM users 
    WHERE username = p_username 
    AND password = SHA2(p_password, 256);
    
    SET p_is_valid = (user_count > 0);
END //
DELIMITER ;
```

### 5.2 Javaè°ƒç”¨å­˜å‚¨è¿‡ç¨‹


**CallableStatementä½¿ç”¨**ï¼š
```java
public boolean validateUser(String username, String password) {
    String sql = "{CALL ValidateUser(?, ?, ?, ?)}";
    
    try (CallableStatement cstmt = connection.prepareCall(sql)) {
        // è®¾ç½®è¾“å…¥å‚æ•°
        cstmt.setString(1, username);
        cstmt.setString(2, password);
        
        // æ³¨å†Œè¾“å‡ºå‚æ•°
        cstmt.registerOutParameter(3, Types.INTEGER);  // user_id
        cstmt.registerOutParameter(4, Types.BOOLEAN);  // is_valid
        
        cstmt.execute();
        
        // è·å–è¾“å‡ºç»“æœ
        boolean isValid = cstmt.getBoolean(4);
        if (isValid) {
            int userId = cstmt.getInt(3);
            log.info("ç”¨æˆ·éªŒè¯æˆåŠŸï¼ŒIDï¼š{}", userId);
        }
        
        return isValid;
    } catch (SQLException e) {
        log.error("å­˜å‚¨è¿‡ç¨‹è°ƒç”¨å¤±è´¥", e);
        return false;
    }
}
```

### 5.3 å­˜å‚¨è¿‡ç¨‹æœ€ä½³å®è·µ


**è®¾è®¡åŸåˆ™**ï¼š
```sql
-- âœ… å¥½çš„åšæ³•ï¼šå‚æ•°åŒ–è¾“å…¥
CREATE PROCEDURE GetUserOrders(IN user_id INT)
BEGIN
    SELECT * FROM orders WHERE customer_id = user_id;
END;

-- âŒ é”™è¯¯åšæ³•ï¼šåŠ¨æ€SQLæ‹¼æ¥
CREATE PROCEDURE GetUserOrdersBad(IN condition_str TEXT)
BEGIN
    SET @sql = CONCAT('SELECT * FROM orders WHERE ', condition_str);
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END;
```

---

## 6. ğŸ”§ ORMæ¡†æ¶å®‰å…¨é…ç½®


### 6.1 MyBatiså®‰å…¨é…ç½®


**å‚æ•°ä¼ é€’æ–¹å¼å¯¹æ¯”**ï¼š
```xml
<!-- âœ… å®‰å…¨ï¼šä½¿ç”¨ #{} å‚æ•°åŒ–æŸ¥è¯¢ -->
<select id="getUserById" parameterType="int" resultType="User">
    SELECT * FROM users WHERE id = #{id}
</select>

<!-- âŒ å±é™©ï¼šä½¿ç”¨ ${} å­—ç¬¦ä¸²æ›¿æ¢ -->
<select id="getUserByIdDangerous" parameterType="int" resultType="User">
    SELECT * FROM users WHERE id = ${id}
</select>

<!-- âœ… å®‰å…¨ï¼šåŠ¨æ€æ¡ä»¶æ„å»º -->
<select id="searchUsers" parameterType="map" resultType="User">
    SELECT * FROM users 
    <where>
        <if test="username != null">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="email != null">
            AND email = #{email}
        </if>
    </where>
</select>
```

### 6.2 JPA/Hibernateå®‰å…¨å®è·µ


**JPQLå‚æ•°åŒ–æŸ¥è¯¢**ï¼š
```java
@Repository
public class UserRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    // âœ… å®‰å…¨ï¼šä½ç½®å‚æ•°
    public List<User> findUsersByStatus(String status) {
        String jpql = "SELECT u FROM User u WHERE u.status = ?1";
        return entityManager.createQuery(jpql, User.class)
                .setParameter(1, status)
                .getResultList();
    }
    
    // âœ… å®‰å…¨ï¼šå‘½åå‚æ•°
    public User findUserByEmail(String email) {
        String jpql = "SELECT u FROM User u WHERE u.email = :email";
        return entityManager.createQuery(jpql, User.class)
                .setParameter("email", email)
                .getSingleResult();
    }
    
    // âœ… å®‰å…¨ï¼šæ¡ä»¶æ„å»º
    public List<User> searchUsers(String username, Integer minAge) {
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();
        CriteriaQuery<User> query = cb.createQuery(User.class);
        Root<User> root = query.from(User.class);
        
        List<Predicate> predicates = new ArrayList<>();
        
        if (username != null) {
            predicates.add(cb.like(root.get("username"), "%" + username + "%"));
        }
        
        if (minAge != null) {
            predicates.add(cb.greaterThanOrEqualTo(root.get("age"), minAge));
        }
        
        query.where(predicates.toArray(new Predicate[0]));
        return entityManager.createQuery(query).getResultList();
    }
}
```

### 6.3 Spring Data JPAå®‰å…¨é…ç½®


**RepositoryæŸ¥è¯¢æ–¹æ³•**ï¼š
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // âœ… è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•å¤©ç„¶å®‰å…¨
    List<User> findByUsernameAndStatus(String username, String status);
    
    // âœ… @Queryæ³¨è§£å‚æ•°åŒ–æŸ¥è¯¢
    @Query("SELECT u FROM User u WHERE u.email = ?1 AND u.active = true")
    Optional<User> findActiveUserByEmail(String email);
    
    // âœ… å‘½åå‚æ•°æŸ¥è¯¢
    @Query("SELECT u FROM User u WHERE u.createdDate BETWEEN :startDate AND :endDate")
    List<User> findUsersByDateRange(@Param("startDate") LocalDateTime start, 
                                   @Param("endDate") LocalDateTime end);
    
    // âŒ é¿å…ä½¿ç”¨nativeQueryæ‹¼æ¥
    // @Query(value = "SELECT * FROM users WHERE name = '" + name + "'", nativeQuery = true)
    
    // âœ… nativeQueryæ­£ç¡®ç”¨æ³•
    @Query(value = "SELECT * FROM users WHERE name = ?1", nativeQuery = true)
    List<User> findByNameNative(String name);
}
```

---

## 7. ğŸ› ï¸ åŠ¨æ€SQLå®‰å…¨æ›¿ä»£æ–¹æ¡ˆ


### 7.1 æŸ¥è¯¢æ„å»ºå™¨æ¨¡å¼


**å®‰å…¨çš„æŸ¥è¯¢æ„å»º**ï¼š
```java
public class SafeQueryBuilder {
    private StringBuilder sql = new StringBuilder();
    private List<Object> parameters = new ArrayList<>();
    
    public SafeQueryBuilder select(String... columns) {
        sql.append("SELECT ").append(String.join(", ", columns));
        return this;
    }
    
    public SafeQueryBuilder from(String table) {
        sql.append(" FROM ").append(table);  // è¡¨åä¸å‚æ•°åŒ–ï¼ˆç™½åå•éªŒè¯ï¼‰
        return this;
    }
    
    public SafeQueryBuilder where(String column, Object value) {
        if (parameters.isEmpty()) {
            sql.append(" WHERE ");
        } else {
            sql.append(" AND ");
        }
        sql.append(column).append(" = ?");
        parameters.add(value);
        return this;
    }
    
    public SafeQueryBuilder whereLike(String column, String value) {
        if (parameters.isEmpty()) {
            sql.append(" WHERE ");
        } else {
            sql.append(" AND ");
        }
        sql.append(column).append(" LIKE ?");
        parameters.add("%" + value + "%");
        return this;
    }
    
    public PreparedStatement build(Connection conn) throws SQLException {
        PreparedStatement pstmt = conn.prepareStatement(sql.toString());
        for (int i = 0; i < parameters.size(); i++) {
            pstmt.setObject(i + 1, parameters.get(i));
        }
        return pstmt;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
SafeQueryBuilder query = new SafeQueryBuilder()
    .select("id", "username", "email")
    .from("users")
    .where("status", "active")
    .whereLike("username", searchTerm);

PreparedStatement pstmt = query.build(connection);
```

### 7.2 ç™½åå•éªŒè¯æœºåˆ¶


**å®‰å…¨çš„åŠ¨æ€å­—æ®µæŸ¥è¯¢**ï¼š
```java
public class SafeDynamicQuery {
    // é¢„å®šä¹‰çš„å®‰å…¨å­—æ®µç™½åå•
    private static final Set<String> ALLOWED_COLUMNS = Set.of(
        "id", "username", "email", "status", "created_date"
    );
    
    private static final Set<String> ALLOWED_TABLES = Set.of(
        "users", "orders", "products"
    );
    
    public List<User> searchWithDynamicFields(String tableName, 
                                            Map<String, Object> conditions) {
        // éªŒè¯è¡¨å
        if (!ALLOWED_TABLES.contains(tableName)) {
            throw new IllegalArgumentException("éæ³•è¡¨å: " + tableName);
        }
        
        StringBuilder sql = new StringBuilder("SELECT * FROM ").append(tableName);
        List<Object> params = new ArrayList<>();
        
        if (!conditions.isEmpty()) {
            sql.append(" WHERE ");
            boolean first = true;
            
            for (Map.Entry<String, Object> entry : conditions.entrySet()) {
                String column = entry.getKey();
                
                // éªŒè¯å­—æ®µå
                if (!ALLOWED_COLUMNS.contains(column)) {
                    throw new IllegalArgumentException("éæ³•å­—æ®µå: " + column);
                }
                
                if (!first) {
                    sql.append(" AND ");
                }
                sql.append(column).append(" = ?");
                params.add(entry.getValue());
                first = false;
            }
        }
        
        // æ‰§è¡Œå‚æ•°åŒ–æŸ¥è¯¢
        try (PreparedStatement pstmt = connection.prepareStatement(sql.toString())) {
            for (int i = 0; i < params.size(); i++) {
                pstmt.setObject(i + 1, params.get(i));
            }
            
            return executeAndMapResults(pstmt);
        } catch (SQLException e) {
            log.error("åŠ¨æ€æŸ¥è¯¢æ‰§è¡Œå¤±è´¥", e);
            throw new RuntimeException(e);
        }
    }
}
```

### 7.3 æ’åºå’Œåˆ†é¡µå®‰å…¨å¤„ç†


**å®‰å…¨çš„æ’åºå®ç°**ï¼š
```java
public class SafePagination {
    private static final Set<String> ALLOWED_SORT_COLUMNS = Set.of(
        "id", "username", "email", "created_date", "updated_date"
    );
    
    public List<User> getUsers(int page, int size, String sortColumn, String sortDirection) {
        // éªŒè¯æ’åºå­—æ®µ
        if (!ALLOWED_SORT_COLUMNS.contains(sortColumn)) {
            sortColumn = "id";  // é»˜è®¤æ’åºå­—æ®µ
        }
        
        // éªŒè¯æ’åºæ–¹å‘
        if (!"ASC".equalsIgnoreCase(sortDirection) && !"DESC".equalsIgnoreCase(sortDirection)) {
            sortDirection = "ASC";
        }
        
        // æ„å»ºå®‰å…¨çš„SQLï¼ˆè¡¨åå’Œå­—æ®µåä¸èƒ½å‚æ•°åŒ–ï¼Œéœ€è¦ç™½åå•éªŒè¯ï¼‰
        String sql = String.format(
            "SELECT * FROM users ORDER BY %s %s LIMIT ? OFFSET ?",
            sortColumn, sortDirection
        );
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setInt(1, size);
            pstmt.setInt(2, page * size);
            
            return executeAndMapResults(pstmt);
        } catch (SQLException e) {
            log.error("åˆ†é¡µæŸ¥è¯¢å¤±è´¥", e);
            throw new RuntimeException(e);
        }
    }
}
```

---

## 8. ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨å¹³è¡¡


### 8.1 é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜


**è¿æ¥æ± çº§åˆ«çš„è¯­å¥ç¼“å­˜**ï¼š
```java
// HikariCPé…ç½®ç¤ºä¾‹
@Configuration
public class DatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://localhost:3306/mydb");
        config.setUsername("user");
        config.setPassword("password");
        
        // å¯ç”¨é¢„ç¼–è¯‘è¯­å¥ç¼“å­˜
        config.addDataSourceProperty("cachePrepStmts", "true");
        config.addDataSourceProperty("prepStmtCacheSize", "250");
        config.addDataSourceProperty("prepStmtCacheSqlLimit", "2048");
        config.addDataSourceProperty("useServerPrepStmts", "true");
        
        return new HikariDataSource(config);
    }
}
```

### 8.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**å¤§æ‰¹é‡å®‰å…¨æ’å…¥ç­–ç•¥**ï¼š
```java
public void batchInsertOptimized(List<User> users) {
    String sql = "INSERT INTO users (username, email, status) VALUES (?, ?, ?)";
    final int batchSize = 1000;  // æ¯æ‰¹æ¬¡å¤„ç†æ•°é‡
    
    try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
        connection.setAutoCommit(false);  // å…³é—­è‡ªåŠ¨æäº¤
        
        for (int i = 0; i < users.size(); i++) {
            User user = users.get(i);
            pstmt.setString(1, user.getUsername());
            pstmt.setString(2, user.getEmail());
            pstmt.setString(3, user.getStatus());
            pstmt.addBatch();
            
            // æ¯1000æ¡æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æ“ä½œ
            if ((i + 1) % batchSize == 0) {
                pstmt.executeBatch();
                pstmt.clearBatch();
                connection.commit();
            }
        }
        
        // å¤„ç†å‰©ä½™çš„æ•°æ®
        pstmt.executeBatch();
        connection.commit();
        
    } catch (SQLException e) {
        try {
            connection.rollback();  // å‘ç”Ÿé”™è¯¯æ—¶å›æ»š
        } catch (SQLException ex) {
            log.error("å›æ»šå¤±è´¥", ex);
        }
        log.error("æ‰¹é‡æ’å…¥å¤±è´¥", e);
    } finally {
        try {
            connection.setAutoCommit(true);  // æ¢å¤è‡ªåŠ¨æäº¤
        } catch (SQLException e) {
            log.error("æ¢å¤è‡ªåŠ¨æäº¤å¤±è´¥", e);
        }
    }
}
```

### 8.3 æŸ¥è¯¢æ€§èƒ½ç›‘æ§


**å®‰å…¨æŸ¥è¯¢çš„æ€§èƒ½ç›‘æ§**ï¼š
```java
@Component
public class QueryPerformanceMonitor {
    
    private static final Logger logger = LoggerFactory.getLogger(QueryPerformanceMonitor.class);
    
    public <T> T executeWithMonitoring(String queryName, 
                                      Supplier<T> queryExecutor) {
        long startTime = System.currentTimeMillis();
        
        try {
            T result = queryExecutor.get();
            long executionTime = System.currentTimeMillis() - startTime;
            
            if (executionTime > 1000) {  // æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼š1ç§’
                logger.warn("æ…¢æŸ¥è¯¢æ£€æµ‹ - æŸ¥è¯¢åç§°: {}, æ‰§è¡Œæ—¶é—´: {}ms", 
                           queryName, executionTime);
            }
            
            return result;
        } catch (Exception e) {
            long executionTime = System.currentTimeMillis() - startTime;
            logger.error("æŸ¥è¯¢æ‰§è¡Œå¤±è´¥ - æŸ¥è¯¢åç§°: {}, æ‰§è¡Œæ—¶é—´: {}ms", 
                        queryName, executionTime, e);
            throw e;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class UserService {
    
    @Autowired
    private QueryPerformanceMonitor monitor;
    
    public List<User> getActiveUsers() {
        return monitor.executeWithMonitoring("getActiveUsers", () -> {
            String sql = "SELECT * FROM users WHERE status = ?";
            try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
                pstmt.setString(1, "ACTIVE");
                return executeAndMapResults(pstmt);
            }
        });
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸåˆ™


```
ğŸ”¸ å‚æ•°åŒ–æŸ¥è¯¢ï¼šæ°¸è¿œä½¿ç”¨?å ä½ç¬¦ï¼Œä¸è¦æ‹¼æ¥SQLå­—ç¬¦ä¸²
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œç™½åå•éªŒè¯å’Œç±»å‹æ£€æŸ¥
ğŸ”¸ æœ€å°æƒé™ï¼šæ•°æ®åº“è´¦æˆ·åªåˆ†é…å¿…éœ€çš„æƒé™
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šä¸è¦å‘ç”¨æˆ·æš´éœ²è¯¦ç»†çš„æ•°æ®åº“é”™è¯¯ä¿¡æ¯
ğŸ”¸ å®šæœŸå®¡è®¡ï¼šç›‘æ§å’Œè®°å½•æ‰€æœ‰æ•°æ®åº“æ“ä½œ
```

### 9.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ é¢„ç¼–è¯‘è¯­å¥çš„æ ¸å¿ƒä»·å€¼**ï¼š
```
å®‰å…¨æ€§ï¼šSQLç»“æ„å’Œæ•°æ®å®Œå…¨åˆ†ç¦»ï¼Œé˜²æ­¢æ³¨å…¥æ”»å‡»
æ€§èƒ½ï¼šæŸ¥è¯¢è®¡åˆ’ç¼“å­˜ï¼Œå‡å°‘ç¼–è¯‘å¼€é”€
å¯ç»´æŠ¤æ€§ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œå‚æ•°ç±»å‹æ˜ç¡®
å¯ç§»æ¤æ€§ï¼šæ ‡å‡†SQLç‰¹æ€§ï¼Œè·¨æ•°æ®åº“å…¼å®¹
```

**ğŸ”¹ ORMæ¡†æ¶å®‰å…¨ä½¿ç”¨**ï¼š
```
MyBatisï¼šä½¿ç”¨#{}è€Œä¸æ˜¯${}
JPA/Hibernateï¼šä½¿ç”¨JPQLå‚æ•°åŒ–æŸ¥è¯¢
Spring Dataï¼šåˆ©ç”¨æ–¹æ³•åæŸ¥è¯¢å’Œ@Queryæ³¨è§£
é¿å…ï¼šåŸç”ŸSQLå­—ç¬¦ä¸²æ‹¼æ¥
```

**ğŸ”¹ åŠ¨æ€SQLå®‰å…¨ç­–ç•¥**ï¼š
```
æŸ¥è¯¢æ„å»ºå™¨ï¼šå°è£…å‚æ•°åŒ–æŸ¥è¯¢é€»è¾‘
ç™½åå•éªŒè¯ï¼šé™åˆ¶å¯ç”¨çš„è¡¨åå’Œå­—æ®µå
æ¡ä»¶æ„å»ºï¼šä½¿ç”¨ç¨‹åºé€»è¾‘è€Œä¸æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥
ç±»å‹æ£€æŸ¥ï¼šä¸¥æ ¼éªŒè¯å‚æ•°ç±»å‹å’Œæ ¼å¼
```

### 9.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ“Š ä¼˜åŒ–ç­–ç•¥**ï¼š
- **è¯­å¥ç¼“å­˜**ï¼šå¯ç”¨PreparedStatementç¼“å­˜
- **æ‰¹é‡æ“ä½œ**ï¼šåˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°ï¼Œä½¿ç”¨äº‹åŠ¡
- **è¿æ¥æ± **ï¼šé…ç½®åˆé€‚çš„è¿æ¥æ± å‚æ•°
- **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå‚æ•°åŒ–æŸ¥è¯¢çš„æ¡ä»¶å­—æ®µåˆ›å»ºç´¢å¼•

### 9.4 å®æˆ˜åº”ç”¨æŒ‡å—


**ğŸ¯ å¼€å‘å®è·µ**ï¼š
- **ä»£ç å®¡æŸ¥**ï¼šé‡ç‚¹æ£€æŸ¥æ‰€æœ‰SQLç›¸å…³ä»£ç 
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šç¼–å†™SQLæ³¨å…¥æµ‹è¯•ç”¨ä¾‹
- **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®æ…¢æŸ¥è¯¢å’Œå¼‚å¸¸æŸ¥è¯¢ç›‘æ§
- **å®‰å…¨åŸ¹è®­**ï¼šå›¢é˜Ÿå®šæœŸè¿›è¡Œå®‰å…¨ç¼–ç åŸ¹è®­

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼šSQLæ³¨å…¥é˜²æŠ¤çš„é‡‘ç§‘ç‰å¾‹æ˜¯"å‚æ•°åŒ–ä¸€åˆ‡"ï¼Œæ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥ï¼Œæ°¸è¿œå°†æ•°æ®å’Œä»£ç åˆ†ç¦»å¤„ç†ã€‚

**ğŸ”’ å®‰å…¨å£è¯€**ï¼š
- å‚æ•°åŒ–æŸ¥è¯¢æ˜¯åŸºç¡€ï¼Œé¢„ç¼–è¯‘è¯­å¥ä¿å®‰å…¨
- ç”¨æˆ·è¾“å…¥éœ€éªŒè¯ï¼Œç™½åå•è¿‡æ»¤æœ€å¯é 
- ORMæ¡†æ¶è¦æ­£ç”¨ï¼ŒåŸç”ŸSQLè¦è°¨æ…
- æ€§èƒ½å®‰å…¨éœ€å¹³è¡¡ï¼Œç›‘æ§æ—¥å¿—ä¸èƒ½å°‘