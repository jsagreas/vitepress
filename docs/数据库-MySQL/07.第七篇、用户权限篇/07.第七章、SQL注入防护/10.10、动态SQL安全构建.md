---
title: 10ã€åŠ¨æ€SQLå®‰å…¨æ„å»º
---
## ğŸ“š ç›®å½•

1. [åŠ¨æ€SQLé£é™©è¯†åˆ«](#1-åŠ¨æ€SQLé£é™©è¯†åˆ«)
2. [å®‰å…¨æ‹¼æ¥æ–¹æ³•](#2-å®‰å…¨æ‹¼æ¥æ–¹æ³•)
3. [æŸ¥è¯¢æ¡ä»¶æ„é€ ](#3-æŸ¥è¯¢æ¡ä»¶æ„é€ )
4. [SQLæ³¨å…¥è¿‡æ»¤å™¨](#4-SQLæ³¨å…¥è¿‡æ»¤å™¨)
5. [åŠ¨æ€æŸ¥è¯¢ä¼˜åŒ–](#5-åŠ¨æ€æŸ¥è¯¢ä¼˜åŒ–)
6. [æ›¿ä»£å®ç°æ–¹æ¡ˆ](#6-æ›¿ä»£å®ç°æ–¹æ¡ˆ)
7. [åŠ¨æ€SQLå®‰å…¨ç­–ç•¥](#7-åŠ¨æ€SQLå®‰å…¨ç­–ç•¥)
8. [å®‰å…¨æ‹¼æ¥éªŒè¯æœºåˆ¶](#8-å®‰å…¨æ‹¼æ¥éªŒè¯æœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ åŠ¨æ€SQLé£é™©è¯†åˆ«


### 1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€SQLé£é™©


**ğŸ” åŸºæœ¬æ¦‚å¿µ**
åŠ¨æ€SQLæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®æ¡ä»¶åŠ¨æ€æ‹¼æ¥ç”Ÿæˆçš„SQLè¯­å¥ã€‚è¿™ç§çµæ´»æ€§å¸¦æ¥ä¾¿åˆ©çš„åŒæ—¶ï¼Œä¹ŸåŸ‹ä¸‹äº†å®‰å…¨éšæ‚£ã€‚

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒç»„è£…å®¶å…·ï¼Œå¦‚æœä½ ç›´æ¥æŠŠç”¨æˆ·æä¾›çš„"é›¶ä»¶"ï¼ˆè¾“å…¥ï¼‰ä¸ç»æ£€æŸ¥å°±è£…ä¸Šå»ï¼Œå¯èƒ½ä¼šè£…å‡ºä¸€ä¸ªå±é™©çš„å®¶å…·ã€‚SQLæ³¨å…¥å°±æ˜¯æ¶æ„ç”¨æˆ·æä¾›äº†"æœ‰æ¯’é›¶ä»¶"ã€‚

```sql
-- å±é™©ç¤ºä¾‹ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
String sql = "SELECT * FROM users WHERE name = '" + userName + "'";

-- ç”¨æˆ·è¾“å…¥æ¶æ„å†…å®¹ï¼šadmin'; DROP TABLE users; --
-- æœ€ç»ˆæ‰§è¡Œçš„SQLï¼š
SELECT * FROM users WHERE name = 'admin'; DROP TABLE users; --'
```

### 1.2 å¸¸è§é£é™©åœºæ™¯è¯†åˆ«


**ğŸš¨ é«˜å±åœºæ™¯æ¸…å•**

| é£é™©ç­‰çº§ | åœºæ™¯æè¿° | å±é™©åŸå›  | å‡ºç°é¢‘ç‡ |
|---------|----------|----------|----------|
| ğŸ”´ **æé«˜** | `ç›´æ¥å­—ç¬¦ä¸²æ‹¼æ¥` | å®Œå…¨æ— é˜²æŠ¤ | â­â­â­â­â­ |
| ğŸŸ  **é«˜** | `åŠ¨æ€WHEREæ¡ä»¶` | æ¡ä»¶å¤æ‚æ˜“æ¼ | â­â­â­â­ |
| ğŸŸ¡ **ä¸­** | `åŠ¨æ€ORDER BY` | å­—æ®µåéš¾éªŒè¯ | â­â­â­ |
| ğŸŸ¢ **ä½** | `ä½¿ç”¨é¢„ç¼–è¯‘` | å·²æœ‰åŸºç¡€é˜²æŠ¤ | â­â­ |

```java
// ğŸ”´ æé«˜é£é™©ï¼šç›´æ¥æ‹¼æ¥
String sql = "SELECT * FROM products WHERE category = '" + category + "'";

// ğŸŸ  é«˜é£é™©ï¼šå¤æ‚æ¡ä»¶æ‹¼æ¥
StringBuilder sql = new StringBuilder("SELECT * FROM orders WHERE 1=1");
if (status != null) {
    sql.append(" AND status = '").append(status).append("'");
}

// ğŸŸ¡ ä¸­é£é™©ï¼šåŠ¨æ€å­—æ®µå
String sql = "SELECT * FROM users ORDER BY " + sortField + " " + sortOrder;
```

### 1.3 é£é™©è¯†åˆ«æ£€æŸ¥æ¸…å•


**ğŸ“ è‡ªæˆ‘æ£€æµ‹**
- [ ] ä»£ç ä¸­æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºSQLï¼Ÿ
- [ ] ç”¨æˆ·è¾“å…¥æ˜¯å¦ç›´æ¥å‚ä¸SQLæ„å»ºï¼Ÿ
- [ ] æ˜¯å¦å¯¹æ‰€æœ‰è¾“å…¥è¿›è¡Œäº†éªŒè¯ï¼Ÿ
- [ ] åŠ¨æ€å­—æ®µåæ˜¯å¦è¿›è¡Œäº†ç™½åå•æ£€æŸ¥ï¼Ÿ

**ğŸ” ä»£ç å®¡è®¡è¦ç‚¹**
```java
// âŒ å±é™©æ¨¡å¼è¯†åˆ«
String sql = "SELECT * FROM table WHERE field = '" + userInput + "'";
String query = String.format("SELECT * FROM %s WHERE id = %s", table, id);
StringBuilder sqlBuilder = new StringBuilder().append("WHERE name = '").append(name);

// âœ… å®‰å…¨æ¨¡å¼è¯†åˆ«
PreparedStatement ps = conn.prepareStatement("SELECT * FROM users WHERE name = ?");
```

---

## 2. ğŸ”’ å®‰å…¨æ‹¼æ¥æ–¹æ³•


### 2.1 é¢„ç¼–è¯‘è¯­å¥ - æœ€ä½³å®è·µ


**ğŸ’ æ ¸å¿ƒæ¦‚å¿µ**
é¢„ç¼–è¯‘è¯­å¥ï¼ˆPreparedStatementï¼‰æ˜¯é˜²æ­¢SQLæ³¨å…¥çš„æœ€æœ‰æ•ˆæ–¹æ³•ã€‚å®ƒå°†SQLç»“æ„å’Œæ•°æ®åˆ†ç¦»ï¼Œè®©æ•°æ®åº“å…ˆç¼–è¯‘SQLæ¨¡æ¿ï¼Œå†å¡«å…¥å‚æ•°ã€‚

```java
// âœ… å®‰å…¨çš„é¢„ç¼–è¯‘è¯­å¥
public List<User> findUsersByRole(String role, int minAge) {
    String sql = "SELECT id, name, email FROM users WHERE role = ? AND age >= ?";
    
    try (PreparedStatement ps = connection.prepareStatement(sql)) {
        ps.setString(1, role);    // ç¬¬1ä¸ªå‚æ•°
        ps.setInt(2, minAge);     // ç¬¬2ä¸ªå‚æ•°
        
        ResultSet rs = ps.executeQuery();
        return mapToUserList(rs);
    }
}
```

**ğŸ”§ é¢„ç¼–è¯‘å·¥ä½œåŸç†**
```
æ•°æ®åº“æ‰§è¡Œæ­¥éª¤ï¼š
1. è§£æSQLæ¨¡æ¿ï¼šSELECT * FROM users WHERE name = ?
2. ç¼–è¯‘æ‰§è¡Œè®¡åˆ’ï¼šç¡®å®šæŸ¥è¯¢ç­–ç•¥
3. å¡«å…¥å‚æ•°å€¼ï¼šå°† 'admin' ä½œä¸ºå­—ç¬¦ä¸²å€¼å¡«å…¥
4. æ‰§è¡ŒæŸ¥è¯¢ï¼šå‚æ•°è¢«å½“ä½œçº¯æ•°æ®ï¼Œä¸ä¼šè¢«è§£é‡Šä¸ºSQLä»£ç 
```

### 2.2 åŠ¨æ€æ¡ä»¶å®‰å…¨æ„å»º


**ğŸ¯ æ ¸å¿ƒæŠ€å·§**
å½“éœ€è¦æ ¹æ®æ¡ä»¶åŠ¨æ€æ·»åŠ WHEREå­å¥æ—¶ï¼Œè¦ä½¿ç”¨å‚æ•°åŒ–çš„æ–¹å¼æ„å»ºã€‚

```java
public List<Product> searchProducts(String name, String category, 
                                  BigDecimal minPrice, BigDecimal maxPrice) {
    StringBuilder sql = new StringBuilder("SELECT * FROM products WHERE 1=1");
    List<Object> params = new ArrayList<>();
    
    // åŠ¨æ€æ·»åŠ æ¡ä»¶
    if (name != null && !name.trim().isEmpty()) {
        sql.append(" AND name LIKE ?");
        params.add("%" + name + "%");
    }
    
    if (category != null && !category.trim().isEmpty()) {
        sql.append(" AND category = ?");
        params.add(category);
    }
    
    if (minPrice != null) {
        sql.append(" AND price >= ?");
        params.add(minPrice);
    }
    
    if (maxPrice != null) {
        sql.append(" AND price <= ?");
        params.add(maxPrice);
    }
    
    return executeQuery(sql.toString(), params);
}
```

### 2.3 æ‰¹é‡æ“ä½œå®‰å…¨å¤„ç†


**âš¡ æ‰¹é‡æ’å…¥ç¤ºä¾‹**
```java
public void batchInsertUsers(List<User> users) {
    String sql = "INSERT INTO users (name, email, role) VALUES (?, ?, ?)";
    
    try (PreparedStatement ps = connection.prepareStatement(sql)) {
        for (User user : users) {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
            ps.setString(3, user.getRole());
            ps.addBatch();  // æ·»åŠ åˆ°æ‰¹æ¬¡
        }
        ps.executeBatch();  // æ‰§è¡Œæ‰¹æ¬¡
    }
}
```

---

## 3. ğŸ” æŸ¥è¯¢æ¡ä»¶æ„é€ 


### 3.1 å¤æ‚æ¡ä»¶å®‰å…¨æ„å»º


**ğŸ“Š å¤šæ¡ä»¶æŸ¥è¯¢æ„å»ºå™¨**
å½“æŸ¥è¯¢æ¡ä»¶éå¸¸å¤æ‚æ—¶ï¼Œéœ€è¦ç”¨æ›´ç»“æ„åŒ–çš„æ–¹å¼æ¥æ„å»ºã€‚

```java
public class SafeQueryBuilder {
    private StringBuilder sql;
    private List<Object> parameters;
    
    public SafeQueryBuilder(String baseQuery) {
        this.sql = new StringBuilder(baseQuery);
        this.parameters = new ArrayList<>();
    }
    
    public SafeQueryBuilder addCondition(String field, String operator, Object value) {
        if (value != null) {
            sql.append(" AND ").append(field).append(" ").append(operator).append(" ?");
            parameters.add(value);
        }
        return this;
    }
    
    public SafeQueryBuilder addInCondition(String field, List<?> values) {
        if (values != null && !values.isEmpty()) {
            String placeholders = String.join(",", Collections.nCopies(values.size(), "?"));
            sql.append(" AND ").append(field).append(" IN (").append(placeholders).append(")");
            parameters.addAll(values);
        }
        return this;
    }
    
    public QueryResult build() {
        return new QueryResult(sql.toString(), parameters);
    }
}
```

**ğŸ¯ ä½¿ç”¨ç¤ºä¾‹**
```java
// æ„å»ºå¤æ‚æŸ¥è¯¢
SafeQueryBuilder builder = new SafeQueryBuilder("SELECT * FROM orders WHERE 1=1")
    .addCondition("status", "=", orderStatus)
    .addCondition("created_date", ">=", startDate)
    .addCondition("created_date", "<=", endDate)
    .addInCondition("customer_id", customerIds);

QueryResult result = builder.build();
PreparedStatement ps = connection.prepareStatement(result.getSql());
// è®¾ç½®å‚æ•°...
```

### 3.2 å­—æ®µååŠ¨æ€å¤„ç†


**âš ï¸ ç‰¹æ®Šæƒ…å†µï¼šåŠ¨æ€å­—æ®µå**
å­—æ®µåæ— æ³•ä½¿ç”¨å‚æ•°åŒ–å¤„ç†ï¼Œéœ€è¦ç”¨ç™½åå•éªŒè¯ã€‚

```java
public class FieldValidator {
    private static final Set<String> ALLOWED_SORT_FIELDS = Set.of(
        "id", "name", "email", "created_date", "updated_date", "status"
    );
    
    private static final Set<String> ALLOWED_SORT_ORDERS = Set.of("ASC", "DESC");
    
    public static String validateSortField(String field) {
        if (field == null || !ALLOWED_SORT_FIELDS.contains(field.toLowerCase())) {
            return "id";  // é»˜è®¤å­—æ®µ
        }
        return field;
    }
    
    public static String validateSortOrder(String order) {
        if (order == null || !ALLOWED_SORT_ORDERS.contains(order.toUpperCase())) {
            return "ASC";  // é»˜è®¤æ’åº
        }
        return order.toUpperCase();
    }
}

// å®‰å…¨çš„åŠ¨æ€æ’åº
public List<User> getUsersWithSort(String sortField, String sortOrder) {
    String validField = FieldValidator.validateSortField(sortField);
    String validOrder = FieldValidator.validateSortOrder(sortOrder);
    
    String sql = "SELECT * FROM users ORDER BY " + validField + " " + validOrder;
    return executeQuery(sql);
}
```

---

## 4. ğŸ›¡ï¸ SQLæ³¨å…¥è¿‡æ»¤å™¨


### 4.1 è¾“å…¥éªŒè¯è¿‡æ»¤å™¨


**ğŸ”§ åŸºç¡€è¾“å…¥è¿‡æ»¤å™¨**
åœ¨æ•°æ®è¿›å…¥æ•°æ®åº“ä¹‹å‰ï¼Œå…ˆè¿›è¡ŒåŸºç¡€çš„å®‰å…¨æ£€æŸ¥ã€‚

```java
public class SqlInjectionFilter {
    
    // å±é™©å…³é”®è¯æ£€æµ‹
    private static final String[] DANGEROUS_KEYWORDS = {
        "DROP", "DELETE", "TRUNCATE", "ALTER", "CREATE", "INSERT", "UPDATE",
        "EXEC", "EXECUTE", "SP_", "XP_", "UNION", "SELECT", "--", "/*", "*/"
    };
    
    // å±é™©å­—ç¬¦æ£€æµ‹
    private static final String[] DANGEROUS_CHARS = {
        "'", "\"", ";", "\\", "<", ">", "&", "|"
    };
    
    public static boolean containsDangerousContent(String input) {
        if (input == null) return false;
        
        String upperInput = input.toUpperCase();
        
        // æ£€æŸ¥å±é™©å…³é”®è¯
        for (String keyword : DANGEROUS_KEYWORDS) {
            if (upperInput.contains(keyword)) {
                return true;
            }
        }
        
        // æ£€æŸ¥å±é™©å­—ç¬¦
        for (String dangerChar : DANGEROUS_CHARS) {
            if (input.contains(dangerChar)) {
                return true;
            }
        }
        
        return false;
    }
    
    public static String sanitizeInput(String input) {
        if (input == null) return null;
        
        // ç§»é™¤å±é™©å­—ç¬¦
        return input.replaceAll("[';\"\\\\<>&|]", "");
    }
}
```

### 4.2 Webå±‚é¢æ³¨å…¥é˜²æŠ¤


**ğŸŒ Spring Bootå®‰å…¨è¿‡æ»¤å™¨**
```java
@Component
public class SqlInjectionProtectionFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        
        // æ£€æŸ¥æ‰€æœ‰å‚æ•°
        Map<String, String[]> parameterMap = httpRequest.getParameterMap();
        for (Map.Entry<String, String[]> entry : parameterMap.entrySet()) {
            for (String value : entry.getValue()) {
                if (SqlInjectionFilter.containsDangerousContent(value)) {
                    throw new SecurityException("æ£€æµ‹åˆ°æ½œåœ¨çš„SQLæ³¨å…¥æ”»å‡»");
                }
            }
        }
        
        chain.doFilter(request, response);
    }
}
```

### 4.3 æ­£åˆ™è¡¨è¾¾å¼éªŒè¯


**ğŸ¯ ç²¾ç¡®æ¨¡å¼åŒ¹é…**
```java
public class InputValidator {
    
    // ç”¨æˆ·åï¼šåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9_]{3,20}$");
    
    // é‚®ç®±æ ¼å¼éªŒè¯
    private static final Pattern EMAIL_PATTERN = Pattern.compile(
        "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$"
    );
    
    // æ•°å­—IDéªŒè¯
    private static final Pattern ID_PATTERN = Pattern.compile("^\\d+$");
    
    public static boolean isValidUsername(String username) {
        return username != null && USERNAME_PATTERN.matcher(username).matches();
    }
    
    public static boolean isValidEmail(String email) {
        return email != null && EMAIL_PATTERN.matcher(email).matches();
    }
    
    public static boolean isValidId(String id) {
        return id != null && ID_PATTERN.matcher(id).matches();
    }
}
```

---

## 5. âš¡ åŠ¨æ€æŸ¥è¯¢ä¼˜åŒ–


### 5.1 æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ“ˆ ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥**
é¢‘ç¹ä½¿ç”¨çš„åŠ¨æ€æŸ¥è¯¢å¯ä»¥é€šè¿‡ç¼“å­˜é¢„ç¼–è¯‘è¯­å¥æ¥æå‡æ€§èƒ½ã€‚

```java
public class PreparedStatementCache {
    private final Map<String, PreparedStatement> cache = new ConcurrentHashMap<>();
    private final Connection connection;
    
    public PreparedStatementCache(Connection connection) {
        this.connection = connection;
    }
    
    public PreparedStatement getOrCreateStatement(String sql) throws SQLException {
        return cache.computeIfAbsent(sql, key -> {
            try {
                return connection.prepareStatement(key);
            } catch (SQLException e) {
                throw new RuntimeException("Failed to create PreparedStatement", e);
            }
        });
    }
    
    public void clearCache() {
        cache.values().forEach(ps -> {
            try {
                ps.close();
            } catch (SQLException e) {
                // è®°å½•æ—¥å¿—
            }
        });
        cache.clear();
    }
}
```

### 5.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**âš¡ æ™ºèƒ½æ‰¹é‡å¤„ç†**
```java
public class BatchProcessor {
    private static final int DEFAULT_BATCH_SIZE = 1000;
    
    public void batchInsert(List<Map<String, Object>> data, String tableName) {
        if (data.isEmpty()) return;
        
        // åŠ¨æ€æ„å»ºæ’å…¥è¯­å¥
        Map<String, Object> firstRow = data.get(0);
        String sql = buildInsertSql(tableName, firstRow.keySet());
        
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            int count = 0;
            
            for (Map<String, Object> row : data) {
                setParameters(ps, row, firstRow.keySet());
                ps.addBatch();
                count++;
                
                // è¾¾åˆ°æ‰¹æ¬¡å¤§å°æ—¶æ‰§è¡Œ
                if (count % DEFAULT_BATCH_SIZE == 0) {
                    ps.executeBatch();
                    ps.clearBatch();
                }
            }
            
            // æ‰§è¡Œå‰©ä½™çš„æ‰¹æ¬¡
            if (count % DEFAULT_BATCH_SIZE != 0) {
                ps.executeBatch();
            }
        }
    }
    
    private String buildInsertSql(String tableName, Set<String> columns) {
        String columnList = String.join(", ", columns);
        String placeholders = String.join(", ", Collections.nCopies(columns.size(), "?"));
        return String.format("INSERT INTO %s (%s) VALUES (%s)", 
                           tableName, columnList, placeholders);
    }
}
```

---

## 6. ğŸ”„ æ›¿ä»£å®ç°æ–¹æ¡ˆ


### 6.1 ORMæ¡†æ¶å®‰å…¨å®è·µ


**ğŸ—ï¸ MyBatiså®‰å…¨é…ç½®**
```xml
<!-- MyBatiså®‰å…¨æ˜ å°„ç¤ºä¾‹ -->
<select id="findUsersByConditions" resultType="User">
    SELECT * FROM users 
    WHERE 1=1
    <if test="name != null and name != ''">
        AND name LIKE CONCAT('%', #{name}, '%')
    </if>
    <if test="role != null and role != ''">
        AND role = #{role}
    </if>
    <if test="minAge != null">
        AND age >= #{minAge}
    </if>
</select>
```

```java
// å¯¹åº”çš„Javaæ¥å£
public interface UserMapper {
    List<User> findUsersByConditions(@Param("name") String name,
                                   @Param("role") String role,
                                   @Param("minAge") Integer minAge);
}
```

**ğŸŒ± JPAå®‰å…¨æŸ¥è¯¢**
```java
@Repository
public class UserRepository {
    
    @PersistenceContext
    private EntityManager entityManager;
    
    public List<User> findUsersByConditions(String name, String role, Integer minAge) {
        StringBuilder jpql = new StringBuilder("SELECT u FROM User u WHERE 1=1");
        Map<String, Object> params = new HashMap<>();
        
        if (name != null && !name.trim().isEmpty()) {
            jpql.append(" AND u.name LIKE :name");
            params.put("name", "%" + name + "%");
        }
        
        if (role != null && !role.trim().isEmpty()) {
            jpql.append(" AND u.role = :role");
            params.put("role", role);
        }
        
        if (minAge != null) {
            jpql.append(" AND u.age >= :minAge");
            params.put("minAge", minAge);
        }
        
        TypedQuery<User> query = entityManager.createQuery(jpql.toString(), User.class);
        params.forEach(query::setParameter);
        
        return query.getResultList();
    }
}
```

### 6.2 å­˜å‚¨è¿‡ç¨‹å®‰å…¨è°ƒç”¨


**ğŸ“¦ å­˜å‚¨è¿‡ç¨‹å‚æ•°åŒ–è°ƒç”¨**
```java
public List<Order> getOrdersByDateRange(Date startDate, Date endDate, String status) {
    String sql = "{CALL sp_get_orders_by_date_range(?, ?, ?)}";
    
    try (CallableStatement cs = connection.prepareCall(sql)) {
        cs.setDate(1, new java.sql.Date(startDate.getTime()));
        cs.setDate(2, new java.sql.Date(endDate.getTime()));
        cs.setString(3, status);
        
        ResultSet rs = cs.executeQuery();
        return mapToOrderList(rs);
    }
}
```

---

## 7. ğŸ›¡ï¸ åŠ¨æ€SQLå®‰å…¨ç­–ç•¥


### 7.1 åˆ†å±‚é˜²æŠ¤ç­–ç•¥


**ğŸ° å¤šå±‚å®‰å…¨é˜²æŠ¤æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å‰ç«¯å±‚                    â”‚ â† è¾“å…¥éªŒè¯ã€æ ¼å¼æ£€æŸ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               æ§åˆ¶å™¨å±‚                   â”‚ â† ä¸šåŠ¡éªŒè¯ã€æƒé™æ£€æŸ¥  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               æœåŠ¡å±‚                     â”‚ â† æ•°æ®éªŒè¯ã€é€»è¾‘æ£€æŸ¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               æ•°æ®è®¿é—®å±‚                 â”‚ â† SQLæ³¨å…¥é˜²æŠ¤ã€å‚æ•°åŒ–æŸ¥è¯¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               æ•°æ®åº“å±‚                   â”‚ â† æƒé™æ§åˆ¶ã€å®¡è®¡æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ åˆ†å±‚å®ç°ç¤ºä¾‹**
```java
// æ§åˆ¶å™¨å±‚ï¼šåŸºç¡€éªŒè¯
@PostMapping("/users/search")
public ResponseEntity<List<User>> searchUsers(@RequestBody SearchRequest request) {
    // 1. è¾“å…¥éªŒè¯
    if (!InputValidator.isValid(request)) {
        return ResponseEntity.badRequest().build();
    }
    
    // 2. è°ƒç”¨æœåŠ¡å±‚
    List<User> users = userService.searchUsers(request);
    return ResponseEntity.ok(users);
}

// æœåŠ¡å±‚ï¼šä¸šåŠ¡é€»è¾‘éªŒè¯
@Service
public class UserService {
    public List<User> searchUsers(SearchRequest request) {
        // 1. ä¸šåŠ¡è§„åˆ™éªŒè¯
        validateSearchRequest(request);
        
        // 2. è°ƒç”¨æ•°æ®è®¿é—®å±‚
        return userRepository.findByConditions(request);
    }
}

// æ•°æ®è®¿é—®å±‚ï¼šSQLå®‰å…¨å¤„ç†
@Repository
public class UserRepository {
    public List<User> findByConditions(SearchRequest request) {
        // ä½¿ç”¨å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
        return executeSecureQuery(request);
    }
}
```

### 7.2 æƒé™æ§åˆ¶é›†æˆ


**ğŸ” æ•°æ®åº“æƒé™æœ€å°åŒ–**
```sql
-- åº”ç”¨ä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'secure_password';

-- åªæˆäºˆå¿…è¦çš„æƒé™
GRANT SELECT, INSERT, UPDATE ON myapp.users TO 'app_user'@'localhost';
GRANT SELECT, INSERT, UPDATE ON myapp.orders TO 'app_user'@'localhost';

-- ç¦æ­¢å±é™©æ“ä½œ
-- ä¸æˆäºˆ DROP, ALTER, CREATE ç­‰æƒé™
```

---

## 8. âœ… å®‰å…¨æ‹¼æ¥éªŒè¯æœºåˆ¶


### 8.1 è‡ªåŠ¨åŒ–å®‰å…¨æ£€æµ‹


**ğŸ” ä»£ç é™æ€åˆ†æå·¥å…·**
```java
// å¯ä»¥é›†æˆåˆ°CI/CDæµç¨‹ä¸­çš„å®‰å…¨æ£€æŸ¥
public class SqlSecurityChecker {
    
    private static final Pattern UNSAFE_CONCAT_PATTERN = Pattern.compile(
        "\\+\\s*['\"].*['\"]\\s*\\+|String\\.format\\s*\\(.*%s.*\\)"
    );
    
    public static List<SecurityIssue> checkFile(String javaCode) {
        List<SecurityIssue> issues = new ArrayList<>();
        
        String[] lines = javaCode.split("\n");
        for (int i = 0; i < lines.length; i++) {
            String line = lines[i];
            
            // æ£€æµ‹ä¸å®‰å…¨çš„å­—ç¬¦ä¸²æ‹¼æ¥
            if (UNSAFE_CONCAT_PATTERN.matcher(line).find()) {
                issues.add(new SecurityIssue(
                    i + 1, 
                    "æ½œåœ¨çš„SQLæ³¨å…¥é£é™©ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºSQL", 
                    SecurityLevel.HIGH
                ));
            }
        }
        
        return issues;
    }
}
```

### 8.2 è¿è¡Œæ—¶å®‰å…¨ç›‘æ§


**ğŸ“Š SQLæ‰§è¡Œç›‘æ§**
```java
@Component
public class SqlExecutionMonitor {
    
    private static final Logger logger = LoggerFactory.getLogger(SqlExecutionMonitor.class);
    
    @EventListener
    public void onSqlExecution(SqlExecutionEvent event) {
        String sql = event.getSql();
        
        // è®°å½•æ‰€æœ‰SQLæ‰§è¡Œ
        logger.info("SQLæ‰§è¡Œ: {}", sql);
        
        // æ£€æµ‹å¯ç–‘çš„SQLæ¨¡å¼
        if (containsSuspiciousPattern(sql)) {
            logger.warn("æ£€æµ‹åˆ°å¯ç–‘SQLæ‰§è¡Œ: {}", sql);
            // å¯ä»¥å‘é€å‘Šè­¦ã€æš‚åœæ‰§è¡Œç­‰
        }
    }
    
    private boolean containsSuspiciousPattern(String sql) {
        String upperSql = sql.toUpperCase();
        return upperSql.contains("DROP ") || 
               upperSql.contains("DELETE FROM") ||
               upperSql.contains("TRUNCATE ") ||
               upperSql.contains("UNION SELECT");
    }
}
```

### 8.3 å®‰å…¨å®¡è®¡æ—¥å¿—


**ğŸ“ å®Œæ•´çš„å®¡è®¡è¿½è¸ª**
```java
@Component
public class SecurityAuditLogger {
    
    public void logSecurityEvent(String userId, String operation, 
                                String sql, String result) {
        SecurityEvent event = SecurityEvent.builder()
            .timestamp(Instant.now())
            .userId(userId)
            .operation(operation)
            .sqlStatement(sql)
            .result(result)
            .ipAddress(getCurrentUserIp())
            .build();
            
        // å†™å…¥å®¡è®¡æ—¥å¿—
        auditRepository.save(event);
        
        // å®æ—¶ç›‘æ§å¼‚å¸¸
        if (isAnomalousActivity(event)) {
            alertService.sendSecurityAlert(event);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸåˆ™


```
ğŸ”¸ å‚æ•°åŒ–æŸ¥è¯¢ï¼šé¢„ç¼–è¯‘è¯­å¥æ˜¯é˜²æ­¢SQLæ³¨å…¥çš„æœ€ä½³æ–¹æ³•
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šæ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½è¦è¿›è¡Œä¸¥æ ¼éªŒè¯
ğŸ”¸ ç™½åå•æ§åˆ¶ï¼šå­—æ®µåç­‰æ— æ³•å‚æ•°åŒ–çš„å†…å®¹ç”¨ç™½åå•éªŒè¯  
ğŸ”¸ æƒé™æœ€å°åŒ–ï¼šæ•°æ®åº“ç”¨æˆ·åªæˆäºˆå¿…è¦æƒé™
ğŸ”¸ åˆ†å±‚é˜²æŠ¤ï¼šä»å‰ç«¯åˆ°æ•°æ®åº“çš„å¤šå±‚å®‰å…¨é˜²æŠ¤
```

### 9.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ å¼€å‘é˜¶æ®µå®‰å…¨å®è·µ**
```
ä»£ç è§„èŒƒï¼š
âœ… å§‹ç»ˆä½¿ç”¨PreparedStatement
âœ… æ°¸è¿œä¸è¦ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
âœ… å¯¹æ‰€æœ‰è¾“å…¥è¿›è¡ŒéªŒè¯
âœ… ä½¿ç”¨ç™½åå•éªŒè¯å­—æ®µå

æ¶æ„è®¾è®¡ï¼š
âœ… å®æ–½åˆ†å±‚å®‰å…¨é˜²æŠ¤
âœ… é›†æˆå®‰å…¨æ¡†æ¶ï¼ˆå¦‚Spring Securityï¼‰
âœ… è®¾è®¡å®‰å…¨çš„APIæ¥å£
âœ… å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶
```

**ğŸ”¹ è¿ç»´é˜¶æ®µå®‰å…¨ç›‘æ§**
```
ç›‘æ§é‡ç‚¹ï¼š
ğŸ“Š SQLæ‰§è¡Œæ¨¡å¼ç›‘æ§
ğŸ“Š å¼‚å¸¸è®¿é—®æ£€æµ‹  
ğŸ“Š æ€§èƒ½å¼‚å¸¸å‘Šè­¦
ğŸ“Š å®‰å…¨äº‹ä»¶å®¡è®¡

åº”æ€¥å“åº”ï¼š
ğŸš¨ å¯ç–‘SQLè‡ªåŠ¨é˜»æ–­
ğŸš¨ å¼‚å¸¸è®¿é—®å®æ—¶å‘Šè­¦
ğŸš¨ å®‰å…¨äº‹ä»¶å¿«é€Ÿå“åº”
ğŸš¨ æ•°æ®å¤‡ä»½å’Œæ¢å¤
```

### 9.3 å¸¸è§è¯¯åŒºé¿å…


**âŒ å±é™©åšæ³•**
```
é”™è¯¯è®¤çŸ¥ï¼š
"åªè¦ç”¨äº†æ¡†æ¶å°±å®‰å…¨" - æ¡†æ¶é…ç½®é”™è¯¯ä»æœ‰é£é™©
"å†…ç½‘ç¯å¢ƒä¸éœ€è¦é˜²æŠ¤" - å†…éƒ¨å¨èƒåŒæ ·å­˜åœ¨
"ç®€å•éªŒè¯å°±å¤Ÿäº†" - éœ€è¦å…¨é¢çš„å®‰å…¨ç­–ç•¥

æŠ€æœ¯è¯¯åŒºï¼š
è½¬ä¹‰å­—ç¬¦ä¸èƒ½å®Œå…¨é˜²æ­¢æ³¨å…¥
å®¢æˆ·ç«¯éªŒè¯ä¸èƒ½æ›¿ä»£æœåŠ¡ç«¯éªŒè¯
å•ä¸€é˜²æŠ¤å±‚å­˜åœ¨è¢«ç»•è¿‡çš„é£é™©
```

**âœ… æ­£ç¡®åšæ³•**
```
å®‰å…¨æ€ç»´ï¼š
å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½æ˜¯æ¶æ„çš„
å®æ–½çºµæ·±é˜²å¾¡ç­–ç•¥
æŒç»­ç›‘æ§å’Œæ”¹è¿›å®‰å…¨æªæ–½
å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œæµ‹è¯•

æŠ€æœ¯å®è·µï¼š
å‚æ•°åŒ–æŸ¥è¯¢ + è¾“å…¥éªŒè¯ + æƒé™æ§åˆ¶
å¤šå±‚å®‰å…¨é˜²æŠ¤
å®æ—¶ç›‘æ§å’Œå‘Šè­¦
å®Œæ•´çš„å®¡è®¡æ—¥å¿—
```

### 9.4 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼**
- **æ•°æ®å®‰å…¨**ï¼šä¿æŠ¤æ ¸å¿ƒä¸šåŠ¡æ•°æ®ä¸è¢«æ³„éœ²æˆ–ç ´å
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³è¡Œä¸šå®‰å…¨æ ‡å‡†å’Œæ³•è§„è¦æ±‚
- **ç”¨æˆ·ä¿¡ä»»**ï¼šå»ºç«‹ç”¨æˆ·å¯¹ç³»ç»Ÿå®‰å…¨æ€§çš„ä¿¡å¿ƒ
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šé¿å…å› å®‰å…¨äº‹ä»¶å¯¼è‡´çš„ä¸šåŠ¡ä¸­æ–­

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- **ä»£ç è´¨é‡**ï¼šç¼–å†™æ›´å®‰å…¨ã€æ›´å¥å£®çš„ä»£ç 
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå‡å°‘å› æ³¨å…¥æ”»å‡»å¯¼è‡´çš„ç³»ç»Ÿå¼‚å¸¸
- **ç»´æŠ¤æ•ˆç‡**ï¼šæ ‡å‡†åŒ–çš„å®‰å…¨å®è·µé™ä½ç»´æŠ¤æˆæœ¬
- **å›¢é˜Ÿèƒ½åŠ›**ï¼šæå‡å›¢é˜Ÿçš„å®‰å…¨æ„è¯†å’ŒæŠ€èƒ½

**ğŸ’¡ å…³é”®æ´å¯Ÿ**
> SQLæ³¨å…¥é˜²æŠ¤ä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œï¼Œè€Œæ˜¯éœ€è¦åœ¨æ•´ä¸ªè½¯ä»¶ç”Ÿå‘½å‘¨æœŸä¸­æŒç»­å…³æ³¨çš„å®‰å…¨å®è·µã€‚ä»è®¾è®¡é˜¶æ®µçš„å®‰å…¨è€ƒè™‘ï¼Œåˆ°å¼€å‘é˜¶æ®µçš„ç¼–ç è§„èŒƒï¼Œå†åˆ°è¿ç»´é˜¶æ®µçš„ç›‘æ§å‘Šè­¦ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½ä¸èƒ½æ‰ä»¥è½»å¿ƒã€‚

**ğŸš€ æœ€ä½³å®è·µå»ºè®®**
1. **å»ºç«‹å®‰å…¨ç¼–ç è§„èŒƒ**ï¼šå›¢é˜Ÿç»Ÿä¸€çš„å®‰å…¨ç¼–ç æ ‡å‡†
2. **å®æ–½ä»£ç å®¡æŸ¥**ï¼šé‡ç‚¹å…³æ³¨æ•°æ®åº“æ“ä½œç›¸å…³ä»£ç 
3. **é›†æˆå®‰å…¨æµ‹è¯•**ï¼šåœ¨CI/CDæµç¨‹ä¸­åŠ å…¥å®‰å…¨æ£€æµ‹
4. **å®šæœŸå®‰å…¨åŸ¹è®­**ï¼šæå‡å›¢é˜Ÿæ•´ä½“å®‰å…¨æ„è¯†
5. **æŒç»­ç›‘æ§æ”¹è¿›**ï¼šåŸºäºå®é™…è¿è¡Œæƒ…å†µä¼˜åŒ–å®‰å…¨ç­–ç•¥

**æ ¸å¿ƒè®°å¿†**ï¼š
- å‚æ•°åŒ–æŸ¥è¯¢æ˜¯é˜²æ³¨å…¥çš„é‡‘é’¥åŒ™
- è¾“å…¥éªŒè¯è¦ä¸¥æ ¼ï¼Œç™½åå•æ¯”é»‘åå•å¥½
- åˆ†å±‚é˜²æŠ¤å¤šä¿é™©ï¼Œæƒé™æ§åˆ¶è¦æœ€å°
- ç›‘æ§å®¡è®¡ä¸èƒ½å°‘ï¼Œå®‰å…¨æ„è¯†æœ€é‡è¦