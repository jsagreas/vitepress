---
title: 9ã€åº”ç”¨å±‚åŠ å¯†å®ç°
---
## ğŸ“š ç›®å½•

1. [åº”ç”¨å±‚åŠ å¯†åŸºç¡€æ¦‚å¿µ](#1-åº”ç”¨å±‚åŠ å¯†åŸºç¡€æ¦‚å¿µ)
2. [åº”ç”¨é€æ˜åŠ å¯†](#2-åº”ç”¨é€æ˜åŠ å¯†)
3. [ä¸­é—´ä»¶åŠ å¯†æ”¯æŒ](#3-ä¸­é—´ä»¶åŠ å¯†æ”¯æŒ)
4. [ORMæ¡†æ¶é›†æˆ](#4-ormæ¡†æ¶é›†æˆ)
5. [åŠ å¯†é…ç½®ç®¡ç†](#5-åŠ å¯†é…ç½®ç®¡ç†)
6. [åŠ å¯†SDKé€‰æ‹©ä¸åº”ç”¨](#6-åŠ å¯†sdké€‰æ‹©ä¸åº”ç”¨)
7. [åº”ç”¨å±‚å¯†é’¥ç®¡ç†](#7-åº”ç”¨å±‚å¯†é’¥ç®¡ç†)
8. [åŠ å¯†å¼‚å¸¸å¤„ç†æœºåˆ¶](#8-åŠ å¯†å¼‚å¸¸å¤„ç†æœºåˆ¶)
9. [ç«¯åˆ°ç«¯åŠ å¯†E2E](#9-ç«¯åˆ°ç«¯åŠ å¯†e2e)
10. [åŠ å¯†ä»£ç†ç½‘å…³](#10-åŠ å¯†ä»£ç†ç½‘å…³)
11. [åº”ç”¨å±‚åŠ å¯†å®‰å…¨ç­–ç•¥](#11-åº”ç”¨å±‚åŠ å¯†å®‰å…¨ç­–ç•¥)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åº”ç”¨å±‚åŠ å¯†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åº”ç”¨å±‚åŠ å¯†


åº”ç”¨å±‚åŠ å¯†å°±æ˜¯åœ¨åº”ç”¨ç¨‹åºè¿™ä¸€å±‚å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†å¤„ç†ï¼Œè€Œä¸æ˜¯ä¾èµ–æ•°æ®åº“å±‚é¢çš„åŠ å¯†ã€‚ç®€å•è¯´ï¼Œå°±æ˜¯åœ¨æ•°æ®å†™å…¥æ•°æ®åº“ä¹‹å‰å…ˆåŠ å¯†ï¼Œä»æ•°æ®åº“è¯»å‡ºæ¥ä¹‹åå†è§£å¯†ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæŠŠåº”ç”¨å±‚åŠ å¯†æƒ³è±¡æˆé‚®å¯„é‡è¦æ–‡ä»¶ï¼Œä½ å…ˆæŠŠæ–‡ä»¶è£…è¿›ä¿é™©ç®±ï¼Œç„¶åå†äº¤ç»™å¿«é€’å…¬å¸ï¼Œæ”¶åˆ°åå†ç”¨é’¥åŒ™æ‰“å¼€ä¿é™©ç®±å–å‡ºæ–‡ä»¶ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… **ä¸šåŠ¡æ§åˆ¶** - åŠ å¯†é€»è¾‘å®Œå…¨ç”±åº”ç”¨ç¨‹åºæ§åˆ¶
- âœ… **çµæ´»æ€§å¼º** - å¯ä»¥é’ˆå¯¹ä¸åŒå­—æ®µä½¿ç”¨ä¸åŒåŠ å¯†ç­–ç•¥
- âœ… **å®‰å…¨çº§åˆ«é«˜** - å³ä½¿æ•°æ®åº“è¢«å…¥ä¾µï¼Œæ•°æ®ä»ç„¶æ˜¯åŠ å¯†çš„
- âœ… **è·¨æ•°æ®åº“** - ä¸ä¾èµ–ç‰¹å®šæ•°æ®åº“çš„åŠ å¯†åŠŸèƒ½

### 1.2 åº”ç”¨å±‚åŠ å¯† vs æ•°æ®åº“å±‚åŠ å¯†


```
æ•°æ®æµå‘å¯¹æ¯”ï¼š

åº”ç”¨å±‚åŠ å¯†ï¼š
ç”¨æˆ·è¾“å…¥ â†’ åº”ç”¨åŠ å¯† â†’ å¯†æ–‡å­˜å‚¨ â†’ åº”ç”¨è§£å¯† â†’ ç”¨æˆ·æ˜¾ç¤º
    â†“
ä¼˜åŠ¿ï¼šå®Œå…¨å¯æ§ï¼Œå®‰å…¨æ€§é«˜
åŠ£åŠ¿ï¼šå¼€å‘å¤æ‚åº¦å¢åŠ 

æ•°æ®åº“å±‚åŠ å¯†ï¼š
ç”¨æˆ·è¾“å…¥ â†’ æ˜æ–‡ä¼ è¾“ â†’ æ•°æ®åº“åŠ å¯† â†’ å¯†æ–‡å­˜å‚¨
    â†“
ä¼˜åŠ¿ï¼šå¯¹åº”ç”¨é€æ˜ï¼Œå®ç°ç®€å•
åŠ£åŠ¿ï¼šä¾èµ–æ•°æ®åº“åŠŸèƒ½ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨éšæ‚£
```

### 1.3 åº”ç”¨åœºæ™¯åˆ†æ


**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ¯ **æ•æ„Ÿæ•°æ®ä¿æŠ¤** - èº«ä»½è¯ã€é“¶è¡Œå¡å·ã€æ‰‹æœºå·ç­‰
- ğŸ¯ **åˆè§„è¦æ±‚** - æ»¡è¶³GDPRã€ç­‰ä¿ç­‰æ³•è§„è¦æ±‚
- ğŸ¯ **å¤šç§Ÿæˆ·ç³»ç»Ÿ** - ä¸åŒç§Ÿæˆ·æ•°æ®éœ€è¦éš”ç¦»åŠ å¯†
- ğŸ¯ **äº‘ç¯å¢ƒéƒ¨ç½²** - å¯¹äº‘æœåŠ¡å•†ä¸å®Œå…¨ä¿¡ä»»çš„åœºæ™¯

---

## 2. ğŸ” åº”ç”¨é€æ˜åŠ å¯†


### 2.1 é€æ˜åŠ å¯†çš„å«ä¹‰


é€æ˜åŠ å¯†æ˜¯æŒ‡å¯¹ä¸šåŠ¡ä»£ç æ¥è¯´ï¼ŒåŠ å¯†è¿‡ç¨‹æ˜¯"çœ‹ä¸è§"çš„ï¼Œä¸šåŠ¡å¼€å‘äººå‘˜æ“ä½œæ•°æ®æ—¶æ„Ÿè§‰ä¸åˆ°åŠ å¯†çš„å­˜åœ¨ï¼Œå°±åƒæ“ä½œæ™®é€šæ•°æ®ä¸€æ ·ã€‚

> ğŸ“– **æ¦‚å¿µè¯´æ˜**ï¼šå°±åƒæˆ´ç€éšå½¢çœ¼é•œçœ‹ä¸œè¥¿ï¼Œä½ èƒ½æ¸…æ¥šçœ‹åˆ°ï¼Œä½†æ„Ÿè§‰ä¸åˆ°çœ¼é•œçš„å­˜åœ¨ã€‚é€æ˜åŠ å¯†è®©å¼€å‘è€…æ­£å¸¸ç¼–å†™ä¸šåŠ¡ä»£ç ï¼Œåº•å±‚è‡ªåŠ¨å¤„ç†åŠ å¯†è§£å¯†ã€‚

### 2.2 é€æ˜åŠ å¯†å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šæ³¨è§£é©±åŠ¨**
```java
@Entity
@Table(name = "user_info")
public class UserInfo {
    @Id
    private Long id;
    
    @Encrypted  // åŠ å¯†æ³¨è§£
    @Column(name = "phone")
    private String phone;
    
    @Encrypted(algorithm = "AES-256")  // æŒ‡å®šåŠ å¯†ç®—æ³•
    @Column(name = "id_card")
    private String idCard;
    
    // æ™®é€šå­—æ®µä¸åŠ å¯†
    @Column(name = "username")
    private String username;
}
```

**æ–¹å¼äºŒï¼šé…ç½®æ–‡ä»¶é©±åŠ¨**
```yaml
# application.yml
encryption:
  fields:
    - table: user_info
      column: phone
      algorithm: AES-128
      key-alias: phone-key
    - table: user_info  
      column: id_card
      algorithm: AES-256
      key-alias: sensitive-key
```

### 2.3 é€æ˜åŠ å¯†çš„æ ¸å¿ƒæœºåˆ¶


```
é€æ˜åŠ å¯†å·¥ä½œæµç¨‹ï¼š

ä¸šåŠ¡ä»£ç å†™å…¥ï¼š
userInfo.setPhone("13800138000") 
    â†“
æ‹¦æˆªå™¨æ•è·ï¼š
æ£€æµ‹åˆ°@Encryptedæ³¨è§£
    â†“
è‡ªåŠ¨åŠ å¯†ï¼š
AESåŠ å¯† â†’ "xY9kP2mN..."
    â†“
æ•°æ®åº“å­˜å‚¨ï¼š
INSERT INTO user_info (phone) VALUES ('xY9kP2mN...')

è¯»å–æµç¨‹ç›¸åï¼š
æ•°æ®åº“æŸ¥è¯¢ â†’ è‡ªåŠ¨è§£å¯† â†’ è¿”å›æ˜æ–‡ç»™ä¸šåŠ¡ä»£ç 
```

---

## 3. ğŸ”§ ä¸­é—´ä»¶åŠ å¯†æ”¯æŒ


### 3.1 ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶åŠ å¯†


ä¸­é—´ä»¶åŠ å¯†æ˜¯åœ¨åº”ç”¨å’Œæ•°æ®åº“ä¹‹é—´åŠ ä¸€å±‚ä¸­é—´ä»¶ï¼Œè¿™ä¸ªä¸­é—´ä»¶ä¸“é—¨è´Ÿè´£æ•°æ®çš„åŠ å¯†è§£å¯†å·¥ä½œï¼Œåº”ç”¨ç¨‹åºåªéœ€è¦æ­£å¸¸æ“ä½œæ•°æ®å³å¯ã€‚

> ğŸ”§ **å®è·µç±»æ¯”**ï¼šå°±åƒé“¶è¡Œçš„ATMæœºï¼Œä½ åªéœ€è¦æ’å¡è¾“å¯†ç ï¼Œæœºå™¨è‡ªåŠ¨å¤„ç†æ‰€æœ‰çš„åŠ å¯†é€šä¿¡ï¼Œä½ ä¸éœ€è¦æ‡‚åŠ å¯†æŠ€æœ¯ã€‚

### 3.2 ä¸»æµä¸­é—´ä»¶åŠ å¯†æ–¹æ¡ˆ


**Apache ShardingSphereåŠ å¯†**
```yaml
# ShardingSphereåŠ å¯†é…ç½®
rules:
  encrypt:
    tables:
      user_info:
        columns:
          phone:
            cipherColumn: phone_cipher    # å¯†æ–‡åˆ—
            assistedQueryColumn: phone_assisted  # è¾…åŠ©æŸ¥è¯¢åˆ—
            encryptorName: phone_encryptor
          id_card:
            cipherColumn: id_card_cipher
            encryptorName: card_encryptor
    encryptors:
      phone_encryptor:
        type: AES
        props:
          aes-key-value: your-secret-key
      card_encryptor:
        type: SM4
        props:
          sm4-key: another-secret-key
```

**æ•°æ®åº“ä»£ç†æ–¹æ¡ˆ**
```
åº”ç”¨æ¶æ„ï¼š

åº”ç”¨ç¨‹åº â†” åŠ å¯†ä»£ç† â†” MySQLæ•°æ®åº“
    â†“           â†“         â†“
  æ˜æ–‡æ“ä½œ    åŠ å¯†/è§£å¯†   å¯†æ–‡å­˜å‚¨

ç‰¹ç‚¹ï¼š
- åº”ç”¨æ— æ„ŸçŸ¥
- ç»Ÿä¸€åŠ å¯†ç­–ç•¥
- æ”¯æŒå¤šç§æ•°æ®åº“
```

### 3.3 ä¸­é—´ä»¶åŠ å¯†ä¼˜åŠ£åˆ†æ


| æ–¹é¢ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|------|---------|---------|
| **å¼€å‘éš¾åº¦** | `å¯¹åº”ç”¨é€æ˜ï¼Œå¼€å‘ç®€å•` | `éœ€è¦é¢å¤–éƒ¨ç½²ä¸­é—´ä»¶` |
| **æ€§èƒ½å½±å“** | `ä¸“é—¨ä¼˜åŒ–ï¼Œæ€§èƒ½è¾ƒå¥½` | `å¢åŠ ç½‘ç»œè·³æ•°` |
| **è¿ç»´å¤æ‚åº¦** | `ç»Ÿä¸€ç®¡ç†ï¼Œè¿ç»´å‹å¥½` | `å¤šäº†ä¸€ä¸ªæ•…éšœç‚¹` |
| **æ‰©å±•æ€§** | `æ”¯æŒå¤šåº”ç”¨å…±äº«` | `ä¸­é—´ä»¶æˆä¸ºç“¶é¢ˆ` |

---

## 4. ğŸ’¾ ORMæ¡†æ¶é›†æˆ


### 4.1 ä»€ä¹ˆæ˜¯ORMåŠ å¯†é›†æˆ


ORMåŠ å¯†é›†æˆæ˜¯æŒ‡åœ¨ORMæ¡†æ¶ï¼ˆå¦‚MyBatisã€Hibernateï¼‰ä¸­å†…ç½®åŠ å¯†åŠŸèƒ½ï¼Œè®©åŠ å¯†æ“ä½œä¸æ•°æ®æ˜ å°„æ— ç¼ç»“åˆã€‚

> ğŸ’¾ **é€šä¿—è§£é‡Š**ï¼šå°±åƒç»™ä½ çš„æ±½è½¦åŠ è£…äº†è‡ªåŠ¨æ¡£ï¼ŒåŸæ¥éœ€è¦æ‰‹åŠ¨æ¢æ¡£çš„æ“ä½œç°åœ¨è‡ªåŠ¨å®Œæˆï¼Œå¼€è½¦å˜å¾—æ›´ç®€å•ã€‚

### 4.2 MyBatisåŠ å¯†é›†æˆ


**è‡ªå®šä¹‰TypeHandlerå®ç°**
```java
@Component
public class EncryptedStringTypeHandler implements TypeHandler<String> {
    
    @Autowired
    private EncryptionService encryptionService;
    
    // å†™å…¥æ•°æ®åº“æ—¶åŠ å¯†
    @Override
    public void setParameter(PreparedStatement ps, int i, String parameter, 
                           JdbcType jdbcType) throws SQLException {
        if (parameter != null) {
            String encrypted = encryptionService.encrypt(parameter);
            ps.setString(i, encrypted);
        } else {
            ps.setString(i, null);
        }
    }
    
    // ä»æ•°æ®åº“è¯»å–æ—¶è§£å¯†
    @Override
    public String getResult(ResultSet rs, String columnName) throws SQLException {
        String encrypted = rs.getString(columnName);
        return encrypted != null ? encryptionService.decrypt(encrypted) : null;
    }
}
```

**Mapperé…ç½®ä½¿ç”¨**
```xml
<!-- MyBatisæ˜ å°„æ–‡ä»¶ -->
<resultMap id="UserInfoResultMap" type="UserInfo">
    <id column="id" property="id"/>
    <result column="username" property="username"/>
    <!-- ä½¿ç”¨åŠ å¯†TypeHandler -->
    <result column="phone" property="phone" 
            typeHandler="com.example.EncryptedStringTypeHandler"/>
    <result column="id_card" property="idCard" 
            typeHandler="com.example.EncryptedStringTypeHandler"/>
</resultMap>
```

### 4.3 JPAåŠ å¯†é›†æˆ


**å±æ€§è½¬æ¢å™¨å®ç°**
```java
@Converter
public class EncryptedStringConverter implements AttributeConverter<String, String> {
    
    @Autowired
    private EncryptionService encryptionService;
    
    // è½¬æ¢åˆ°æ•°æ®åº“åˆ—ï¼ˆåŠ å¯†ï¼‰
    @Override
    public String convertToDatabaseColumn(String attribute) {
        return attribute != null ? encryptionService.encrypt(attribute) : null;
    }
    
    // ä»æ•°æ®åº“åˆ—è½¬æ¢ï¼ˆè§£å¯†ï¼‰
    @Override
    public String convertToEntityAttribute(String dbData) {
        return dbData != null ? encryptionService.decrypt(dbData) : null;
    }
}
```

**å®ä½“ç±»ä½¿ç”¨**
```java
@Entity
@Table(name = "user_info")
public class UserInfo {
    @Id
    private Long id;
    
    @Convert(converter = EncryptedStringConverter.class)
    @Column(name = "phone")
    private String phone;
    
    @Convert(converter = EncryptedStringConverter.class)
    @Column(name = "id_card") 
    private String idCard;
}
```

---

## 5. âš™ï¸ åŠ å¯†é…ç½®ç®¡ç†


### 5.1 é…ç½®ç®¡ç†çš„é‡è¦æ€§


åŠ å¯†é…ç½®ç®¡ç†å°±æ˜¯ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¸åŠ å¯†ç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŠ å¯†ç®—æ³•ã€å¯†é’¥ä¿¡æ¯ã€åŠ å¯†ç­–ç•¥ç­‰ã€‚å¥½çš„é…ç½®ç®¡ç†èƒ½è®©åŠ å¯†åŠŸèƒ½æ›´çµæ´»ã€æ›´å®‰å…¨ã€‚

> âš™ï¸ **ç®¡ç†ç†å¿µ**ï¼šå°±åƒç®¡ç†å®¶é‡Œçš„é’¥åŒ™ï¼Œä½ éœ€è¦çŸ¥é“å“ªæŠŠé’¥åŒ™å¼€å“ªæ‰‡é—¨ï¼Œé’¥åŒ™æ”¾åœ¨å“ªé‡Œï¼Œä»€ä¹ˆæ—¶å€™æ¢é”ç­‰ç­‰ã€‚

### 5.2 é…ç½®ç»“æ„è®¾è®¡


**åˆ†å±‚é…ç½®ç»“æ„**
```yaml
# åŠ å¯†é…ç½®ç¤ºä¾‹
encryption:
  # å…¨å±€é…ç½®
  global:
    enabled: true
    default-algorithm: AES-256-GCM
    key-rotation-days: 90
    
  # ç®—æ³•é…ç½®
  algorithms:
    AES-256-GCM:
      key-length: 256
      iv-length: 12
      tag-length: 16
    SM4:
      key-length: 128
      mode: CBC
      
  # å¯†é’¥é…ç½®
  keys:
    default-key:
      alias: "app-default-key"
      store: "file"
      path: "/etc/keys/default.key"
    sensitive-key:
      alias: "sensitive-data-key"  
      store: "hsm"
      slot: "0"
      
  # å­—æ®µé…ç½®
  fields:
    user_info.phone:
      algorithm: AES-256-GCM
      key-alias: default-key
      searchable: true
    user_info.id_card:
      algorithm: SM4
      key-alias: sensitive-key
      searchable: false
```

### 5.3 åŠ¨æ€é…ç½®æ›´æ–°


**é…ç½®çƒ­æ›´æ–°æœºåˆ¶**
```java
@Component
@ConfigurationProperties(prefix = "encryption")
@RefreshScope  // æ”¯æŒé…ç½®åˆ·æ–°
public class EncryptionConfig {
    
    private Map<String, FieldConfig> fields = new HashMap<>();
    private Map<String, AlgorithmConfig> algorithms = new HashMap<>();
    
    // é…ç½®å˜æ›´ç›‘å¬
    @EventListener
    public void handleConfigChange(ConfigChangeEvent event) {
        if (event.getKey().startsWith("encryption.")) {
            // é‡æ–°åŠ è½½é…ç½®
            reloadConfiguration();
            // æ¸…ç†ç¼“å­˜
            clearEncryptionCache();
        }
    }
    
    public FieldConfig getFieldConfig(String tableName, String columnName) {
        String key = tableName + "." + columnName;
        return fields.get(key);
    }
}
```

### 5.4 é…ç½®å®‰å…¨ç­–ç•¥


**é…ç½®åŠ å¯†ä¿æŠ¤**
```properties
# æ•æ„Ÿé…ç½®åŠ å¯†å­˜å‚¨
encryption.keys.sensitive-key.encrypted-value=ENC(xY9kP2mN...)
encryption.algorithms.AES-256-GCM.encrypted-key=ENC(9mN2kPxY...)

# ç¯å¢ƒå˜é‡å¼•ç”¨
encryption.keys.default-key.value=${ENCRYPTION_KEY:default-fallback}
```

---

## 6. ğŸ“¦ åŠ å¯†SDKé€‰æ‹©ä¸åº”ç”¨


### 6.1 SDKé€‰æ‹©æ ‡å‡†


é€‰æ‹©åŠ å¯†SDKå°±åƒé€‰æ‹©å·¥å…·ç®±ï¼Œä½ éœ€è¦è€ƒè™‘å·¥å…·æ˜¯å¦å¥½ç”¨ã€æ˜¯å¦å®‰å…¨ã€æ˜¯å¦ç¬¦åˆä½ çš„éœ€æ±‚ã€‚

> ğŸ“¦ **é€‰æ‹©è¦ç‚¹**ï¼š
> - **å®‰å…¨æ€§** - ç®—æ³•æ˜¯å¦ç»è¿‡éªŒè¯ï¼Œæœ‰æ²¡æœ‰å®‰å…¨æ¼æ´
> - **æ€§èƒ½** - åŠ è§£å¯†é€Ÿåº¦æ˜¯å¦æ»¡è¶³ä¸šåŠ¡éœ€æ±‚  
> - **æ˜“ç”¨æ€§** - APIæ˜¯å¦ç®€å•æ˜“æ‡‚ï¼Œæ–‡æ¡£æ˜¯å¦å®Œå–„
> - **å…¼å®¹æ€§** - æ˜¯å¦æ”¯æŒä½ çš„å¼€å‘è¯­è¨€å’Œæ¡†æ¶

### 6.2 ä¸»æµåŠ å¯†SDKå¯¹æ¯”


| SDK | **ä¼˜åŠ¿** | **é€‚ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|-----|---------|-------------|---------|
| **Java Cryptography** | `JDKå†…ç½®ï¼Œç¨³å®šå¯é ` | `Javaåº”ç”¨ï¼Œæ ‡å‡†åŠ å¯†éœ€æ±‚` | `AESã€RSAç­‰æ ‡å‡†ç®—æ³•` |
| **Bouncy Castle** | `ç®—æ³•å…¨é¢ï¼ŒåŠŸèƒ½å¼ºå¤§` | `éœ€è¦ç‰¹æ®Šç®—æ³•ï¼ŒåŠ å¯†è¦æ±‚é«˜` | `SM2ã€SM3ã€SM4ç­‰å›½å¯†ç®—æ³•` |
| **Google Tink** | `å®‰å…¨æ€§å¥½ï¼Œæ˜“äºä½¿ç”¨` | `ç°ä»£åº”ç”¨ï¼Œé«˜å®‰å…¨è¦æ±‚` | `AEADåŠ å¯†ï¼Œå¯†é’¥ç®¡ç†` |
| **AWS Encryption SDK** | `äº‘åŸç”Ÿï¼Œé›†æˆå¯†é’¥ç®¡ç†` | `AWSç¯å¢ƒï¼Œä¼ä¸šçº§åº”ç”¨` | `å¤šåŒºåŸŸåŠ å¯†ï¼Œå¯†é’¥è½®æ¢` |

### 6.3 SDKé›†æˆå®è·µ


**Google Tinké›†æˆç¤ºä¾‹**
```java
@Component
public class TinkEncryptionService {
    
    private Aead aead;
    
    @PostConstruct
    public void init() throws GeneralSecurityException {
        // æ³¨å†ŒåŠ å¯†å¥—ä»¶
        AeadConfig.register();
        
        // ç”Ÿæˆå¯†é’¥
        KeysetHandle keysetHandle = KeysetHandle.generateNew(
            AeadKeyTemplates.AES256_GCM);
        
        // è·å–åŠ å¯†åŸè¯­
        aead = keysetHandle.getPrimitive(Aead.class);
    }
    
    public String encrypt(String plaintext) {
        try {
            byte[] ciphertext = aead.encrypt(
                plaintext.getBytes(StandardCharsets.UTF_8), 
                null);  // ç©ºçš„å…³è”æ•°æ®
            return Base64.getEncoder().encodeToString(ciphertext);
        } catch (GeneralSecurityException e) {
            throw new EncryptionException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    public String decrypt(String ciphertext) {
        try {
            byte[] encrypted = Base64.getDecoder().decode(ciphertext);
            byte[] decrypted = aead.decrypt(encrypted, null);
            return new String(decrypted, StandardCharsets.UTF_8);
        } catch (GeneralSecurityException e) {
            throw new EncryptionException("è§£å¯†å¤±è´¥", e);
        }
    }
}
```

### 6.4 SDKæ€§èƒ½ä¼˜åŒ–


**ç¼“å­˜å’Œæ± åŒ–ä¼˜åŒ–**
```java
@Component
public class OptimizedEncryptionService {
    
    // åŠ å¯†å®ä¾‹æ± 
    private final ObjectPool<Cipher> encryptorPool;
    private final ObjectPool<Cipher> decryptorPool;
    
    // ç»“æœç¼“å­˜ï¼ˆé€‚ç”¨äºç›¸åŒæ•°æ®é‡å¤åŠ å¯†çš„åœºæ™¯ï¼‰
    @Cacheable(value = "encryption", key = "#plaintext")
    public String encrypt(String plaintext) {
        Cipher cipher = null;
        try {
            cipher = encryptorPool.borrowObject();
            // æ‰§è¡ŒåŠ å¯†
            return doEncrypt(cipher, plaintext);
        } finally {
            if (cipher != null) {
                encryptorPool.returnObject(cipher);
            }
        }
    }
}
```

---

## 7. ğŸ”‘ åº”ç”¨å±‚å¯†é’¥ç®¡ç†


### 7.1 å¯†é’¥ç®¡ç†çš„é‡è¦æ€§


å¯†é’¥ç®¡ç†å°±æ˜¯ç®¡ç†åŠ å¯†ç”¨çš„"é’¥åŒ™"ï¼ŒåŒ…æ‹¬é’¥åŒ™çš„ç”Ÿæˆã€å­˜å‚¨ã€ä½¿ç”¨ã€æ›´æ¢å’Œé”€æ¯ã€‚è¿™æ˜¯æ•´ä¸ªåŠ å¯†ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œé’¥åŒ™ç®¡ä¸å¥½ï¼Œå†å¼ºçš„åŠ å¯†ä¹Ÿæ²¡ç”¨ã€‚

> ğŸ”‘ **å®‰å…¨è¦ç‚¹**ï¼š
> - å¯†é’¥è¦å®‰å…¨å­˜å‚¨ï¼Œä¸èƒ½æ˜æ–‡ä¿å­˜
> - å¯†é’¥è¦å®šæœŸæ›´æ¢ï¼Œä¸èƒ½ä¸€ç›´ç”¨åŒä¸€æŠŠé’¥åŒ™
> - å¯†é’¥è¦åˆ†çº§ç®¡ç†ï¼Œä¸åŒæ•°æ®ç”¨ä¸åŒé’¥åŒ™
> - å¯†é’¥è¦æœ‰å¤‡ä»½ï¼Œä½†å¤‡ä»½ä¹Ÿè¦åŠ å¯†

### 7.2 å¯†é’¥å­˜å‚¨æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šé…ç½®æ–‡ä»¶å­˜å‚¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰**
```yaml
# ä»…é€‚ç”¨äºå¼€å‘ç¯å¢ƒ
encryption:
  keys:
    default:
      value: "mySecretKey123456"  # æ˜æ–‡å­˜å‚¨ï¼Œä»…å¼€å‘ç”¨
      algorithm: AES-256
```

**æ–¹æ¡ˆäºŒï¼šç¯å¢ƒå˜é‡å­˜å‚¨**
```bash
# ç³»ç»Ÿç¯å¢ƒå˜é‡
export ENCRYPTION_KEY="xY9kP2mNvB8cF5gH"
export MASTER_KEY="9mN2kPxY7wQ3eR6t"
```

```java
@Component
public class EnvironmentKeyProvider {
    
    public String getEncryptionKey() {
        String key = System.getenv("ENCRYPTION_KEY");
        if (key == null) {
            throw new SecurityException("æœªæ‰¾åˆ°åŠ å¯†å¯†é’¥");
        }
        return key;
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šå¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰**
```java
@Component
public class KeyManagementService {
    
    @Autowired
    private VaultTemplate vaultTemplate;  // HashiCorp Vault
    
    public String getDataEncryptionKey(String keyId) {
        // ä»Vaultè·å–å¯†é’¥
        VaultResponse response = vaultTemplate.read("secret/encryption/" + keyId);
        if (response == null) {
            throw new KeyNotFoundException("å¯†é’¥ä¸å­˜åœ¨: " + keyId);
        }
        return (String) response.getData().get("key");
    }
    
    // å¯†é’¥è½®æ¢
    public void rotateKey(String keyId) {
        String newKey = generateNewKey();
        vaultTemplate.write("secret/encryption/" + keyId + "-new", 
                          Map.of("key", newKey));
    }
}
```

### 7.3 å¯†é’¥åˆ†å±‚æ¶æ„


```
å¯†é’¥åˆ†å±‚ç®¡ç†æ¶æ„ï¼š

ä¸»å¯†é’¥ (Master Key)
    â†“
æ•°æ®åŠ å¯†å¯†é’¥ (DEK - Data Encryption Key)  
    â†“
å­—æ®µç‰¹å®šå¯†é’¥ (Field Specific Key)

ç‰¹ç‚¹ï¼š
- ä¸»å¯†é’¥åŠ å¯†æ•°æ®åŠ å¯†å¯†é’¥
- æ•°æ®åŠ å¯†å¯†é’¥åŠ å¯†å®é™…æ•°æ®
- ä¸»å¯†é’¥å¯ä»¥å­˜å‚¨åœ¨HSMä¸­
- æ”¯æŒå¯†é’¥è½®æ¢ï¼Œä¸éœ€è¦é‡æ–°åŠ å¯†æ‰€æœ‰æ•°æ®
```

**å¯†é’¥åˆ†å±‚å®ç°**
```java
@Component
public class HierarchicalKeyManager {
    
    // ä¸»å¯†é’¥ï¼ˆå­˜å‚¨åœ¨HSMæˆ–KMSä¸­ï¼‰
    private final MasterKeyProvider masterKeyProvider;
    
    // DEKç¼“å­˜
    private final Cache<String, String> dekCache;
    
    public String getDataEncryptionKey(String keyId) {
        // å…ˆä»ç¼“å­˜è·å–
        String dek = dekCache.getIfPresent(keyId);
        if (dek != null) {
            return dek;
        }
        
        // ä»å­˜å‚¨è·å–åŠ å¯†çš„DEK
        String encryptedDek = loadEncryptedDek(keyId);
        
        // ç”¨ä¸»å¯†é’¥è§£å¯†DEK
        String masterKey = masterKeyProvider.getMasterKey();
        dek = decryptDek(encryptedDek, masterKey);
        
        // ç¼“å­˜DEK
        dekCache.put(keyId, dek);
        
        return dek;
    }
}
```

### 7.4 å¯†é’¥è½®æ¢ç­–ç•¥


**è‡ªåŠ¨å¯†é’¥è½®æ¢**
```java
@Component
@Scheduled
public class KeyRotationService {
    
    // æ¯30å¤©æ‰§è¡Œä¸€æ¬¡å¯†é’¥è½®æ¢
    @Scheduled(cron = "0 0 2 */30 * ?")
    public void rotateKeys() {
        List<String> keyIds = getActiveKeyIds();
        
        for (String keyId : keyIds) {
            try {
                // ç”Ÿæˆæ–°å¯†é’¥
                String newKey = generateNewKey();
                
                // ä¿å­˜æ–°å¯†é’¥ï¼ˆæ ‡è®°ä¸ºå¾…æ¿€æ´»ï¼‰
                saveNewKey(keyId, newKey, KeyStatus.PENDING);
                
                // é‡æ–°åŠ å¯†æ•°æ®ï¼ˆå¯å¼‚æ­¥æ‰§è¡Œï¼‰
                scheduleDataReEncryption(keyId, newKey);
                
            } catch (Exception e) {
                log.error("å¯†é’¥è½®æ¢å¤±è´¥: {}", keyId, e);
            }
        }
    }
}
```

---

## 8. âš ï¸ åŠ å¯†å¼‚å¸¸å¤„ç†æœºåˆ¶


### 8.1 å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§


åŠ å¯†è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å„ç§é—®é¢˜ï¼Œæ¯”å¦‚å¯†é’¥æ‰¾ä¸åˆ°ã€æ•°æ®æ ¼å¼é”™è¯¯ã€è§£å¯†å¤±è´¥ç­‰ã€‚å¥½çš„å¼‚å¸¸å¤„ç†èƒ½è®©ç³»ç»Ÿæ›´ç¨³å®šï¼Œä¹Ÿèƒ½å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜ã€‚

> âš ï¸ **å¤„ç†åŸåˆ™**ï¼š
> - ä¸èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†é’¥ã€æ˜æ–‡æ•°æ®ï¼‰
> - è¦è®°å½•è¶³å¤Ÿçš„æ—¥å¿—ä¿¡æ¯ä¾¿äºæ’æŸ¥
> - è¦æœ‰é™çº§ç­–ç•¥ï¼Œä¸èƒ½å› ä¸ºåŠ å¯†é—®é¢˜å½±å“ä¸»ä¸šåŠ¡
> - è¦åŠæ—¶å‘Šè­¦ï¼Œè®©è¿ç»´äººå‘˜çŸ¥é“é—®é¢˜

### 8.2 å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†


**åŠ å¯†å¼‚å¸¸åˆ†ç±»**
```java
// è‡ªå®šä¹‰å¼‚å¸¸ä½“ç³»
public class EncryptionException extends RuntimeException {
    private final ErrorCode errorCode;
    
    public EncryptionException(ErrorCode errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }
}

public enum ErrorCode {
    KEY_NOT_FOUND("E001", "å¯†é’¥æœªæ‰¾åˆ°"),
    ENCRYPTION_FAILED("E002", "åŠ å¯†å¤±è´¥"), 
    DECRYPTION_FAILED("E003", "è§£å¯†å¤±è´¥"),
    INVALID_DATA_FORMAT("E004", "æ•°æ®æ ¼å¼æ— æ•ˆ"),
    KEY_EXPIRED("E005", "å¯†é’¥å·²è¿‡æœŸ");
    
    private final String code;
    private final String message;
}
```

**å¼‚å¸¸å¤„ç†å™¨å®ç°**
```java
@Component
public class EncryptionExceptionHandler {
    
    private static final Logger log = LoggerFactory.getLogger(EncryptionExceptionHandler.class);
    
    public String handleEncryption(String data, String keyId, 
                                 Supplier<String> encryptionFunction) {
        try {
            return encryptionFunction.get();
            
        } catch (KeyNotFoundException e) {
            // å¯†é’¥é—®é¢˜ - è®°å½•å‘Šè­¦æ—¥å¿—
            log.error("åŠ å¯†å¤±è´¥ï¼Œå¯†é’¥æœªæ‰¾åˆ°: keyId={}", keyId);
            throw new EncryptionException(ErrorCode.KEY_NOT_FOUND, 
                "å¯†é’¥é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
                
        } catch (IllegalArgumentException e) {
            // æ•°æ®æ ¼å¼é—®é¢˜ - è®°å½•è¯¦ç»†ä¿¡æ¯
            log.warn("åŠ å¯†å¤±è´¥ï¼Œæ•°æ®æ ¼å¼æ— æ•ˆ: dataLength={}, error={}", 
                    data.length(), e.getMessage());
            throw new EncryptionException(ErrorCode.INVALID_DATA_FORMAT, 
                "æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
                
        } catch (Exception e) {
            // å…¶ä»–æœªçŸ¥é—®é¢˜ - è®°å½•å®Œæ•´å †æ ˆ
            log.error("åŠ å¯†è¿‡ç¨‹å‘ç”ŸæœªçŸ¥é”™è¯¯: keyId={}", keyId, e);
            throw new EncryptionException(ErrorCode.ENCRYPTION_FAILED, 
                "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

### 8.3 é™çº§ç­–ç•¥è®¾è®¡


**åŠ å¯†é™çº§æœºåˆ¶**
```java
@Component
public class EncryptionService {
    
    @Value("${encryption.fallback.enabled:true}")
    private boolean fallbackEnabled;
    
    @Value("${encryption.fallback.strategy:LOG_ONLY}")
    private FallbackStrategy fallbackStrategy;
    
    public String encryptWithFallback(String data, String keyId) {
        try {
            return encrypt(data, keyId);
            
        } catch (EncryptionException e) {
            if (!fallbackEnabled) {
                throw e;  // ä¸å…è®¸é™çº§ï¼Œç›´æ¥æŠ›å¼‚å¸¸
            }
            
            return handleFallback(data, e);
        }
    }
    
    private String handleFallback(String data, EncryptionException e) {
        switch (fallbackStrategy) {
            case STORE_PLAINTEXT:
                // é™çº§ç­–ç•¥1ï¼šå­˜å‚¨æ˜æ–‡ï¼ˆä»…é™éæ•æ„Ÿæ•°æ®ï¼‰
                log.warn("åŠ å¯†å¤±è´¥ï¼Œé™çº§ä¸ºæ˜æ–‡å­˜å‚¨: {}", e.getMessage());
                return data;
                
            case LOG_ONLY:
                // é™çº§ç­–ç•¥2ï¼šä»…è®°å½•æ—¥å¿—ï¼ŒæŠ›å‡ºå¼‚å¸¸
                log.error("åŠ å¯†å¤±è´¥ï¼Œæ— æ³•é™çº§: {}", e.getMessage());
                throw e;
                
            case USE_DEFAULT_KEY:
                // é™çº§ç­–ç•¥3ï¼šä½¿ç”¨é»˜è®¤å¯†é’¥
                log.warn("ä½¿ç”¨é»˜è®¤å¯†é’¥è¿›è¡ŒåŠ å¯†: {}", e.getMessage());
                return encrypt(data, "default-key");
                
            default:
                throw e;
        }
    }
}
```

### 8.4 ç›‘æ§å’Œå‘Šè­¦


**å¼‚å¸¸ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class EncryptionMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter encryptionErrors;
    private final Timer encryptionTimer;
    
    public EncryptionMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.encryptionErrors = Counter.builder("encryption.errors")
            .description("åŠ å¯†é”™è¯¯æ¬¡æ•°")
            .tag("type", "total")
            .register(meterRegistry);
        this.encryptionTimer = Timer.builder("encryption.duration")
            .description("åŠ å¯†è€—æ—¶")
            .register(meterRegistry);
    }
    
    public void recordEncryptionError(ErrorCode errorCode) {
        encryptionErrors.increment(
            Tags.of("error_code", errorCode.getCode()));
    }
    
    public void recordEncryptionTime(Duration duration) {
        encryptionTimer.record(duration);
    }
}
```

---

## 9. ğŸ”’ ç«¯åˆ°ç«¯åŠ å¯†E2E


### 9.1 ç«¯åˆ°ç«¯åŠ å¯†æ¦‚å¿µ


ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆEnd-to-End Encryptionï¼‰æ˜¯æŒ‡æ•°æ®ä»ç”¨æˆ·è¾“å…¥å¼€å§‹å°±è¢«åŠ å¯†ï¼Œä¸€ç›´åˆ°æœ€ç»ˆç”¨æˆ·æ¥æ”¶æ—¶æ‰è§£å¯†ï¼Œæ•´ä¸ªä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­æ•°æ®éƒ½æ˜¯å¯†æ–‡çŠ¶æ€ã€‚

> ğŸ”’ **é€šä¿—ç†è§£**ï¼šå°±åƒå¯„é€å¯†ä¿¡ï¼Œä½ åœ¨å®¶é‡Œå†™å¥½ä¿¡è£…è¿›ä¿é™©ç®±é”å¥½ï¼Œå¿«é€’å‘˜ã€é‚®å±€å·¥ä½œäººå‘˜éƒ½çœ‹ä¸åˆ°ä¿¡çš„å†…å®¹ï¼Œåªæœ‰æ”¶ä¿¡äººæœ‰é’¥åŒ™èƒ½æ‰“å¼€ä¿é™©ç®±è¯»ä¿¡ã€‚

### 9.2 E2EåŠ å¯†æ¶æ„è®¾è®¡


```
ç«¯åˆ°ç«¯åŠ å¯†æ•°æ®æµï¼š

ç”¨æˆ·Aæµè§ˆå™¨ â†’ åŠ å¯† â†’ ç½‘ç»œä¼ è¾“ â†’ åº”ç”¨æœåŠ¡å™¨ â†’ æ•°æ®åº“å­˜å‚¨
    â†“                                      â†“           â†“
  æ˜æ–‡è¾“å…¥                               å¯†æ–‡å¤„ç†    å¯†æ–‡å­˜å‚¨
    â†‘                                      â†‘           â†‘  
æ•°æ®åº“è¯»å– â† åº”ç”¨æœåŠ¡å™¨ â† ç½‘ç»œä¼ è¾“ â† è§£å¯† â† ç”¨æˆ·Bæµè§ˆå™¨
    â†“           â†“           â†“           â†“
  å¯†æ–‡è¯»å–    å¯†æ–‡ä¼ è¾“    å¯†æ–‡ä¼ è¾“    æ˜æ–‡æ˜¾ç¤º

å…³é”®ç‚¹ï¼š
- åªæœ‰å®¢æˆ·ç«¯æœ‰è§£å¯†å¯†é’¥
- æœåŠ¡å™¨ç«¯æ— æ³•çœ‹åˆ°æ˜æ–‡æ•°æ®
- å³ä½¿æœåŠ¡å™¨è¢«å…¥ä¾µï¼Œæ•°æ®ä»ç„¶å®‰å…¨
```

### 9.3 å‰ç«¯åŠ å¯†å®ç°


**JavaScriptç«¯åŠ å¯†**
```javascript
// å‰ç«¯åŠ å¯†æœåŠ¡
class ClientEncryptionService {
    constructor() {
        this.publicKey = null;
        this.privateKey = null;
    }
    
    // åˆå§‹åŒ–å¯†é’¥å¯¹
    async initializeKeys() {
        const keyPair = await window.crypto.subtle.generateKey(
            {
                name: "RSA-OAEP",
                modulusLength: 2048,
                publicExponent: new Uint8Array([1, 0, 1]),
                hash: "SHA-256"
            },
            true,  // å¯å¯¼å‡º
            ["encrypt", "decrypt"]
        );
        
        this.publicKey = keyPair.publicKey;
        this.privateKey = keyPair.privateKey;
    }
    
    // åŠ å¯†æ•°æ®
    async encryptData(plaintext) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plaintext);
        
        const encrypted = await window.crypto.subtle.encrypt(
            { name: "RSA-OAEP" },
            this.publicKey,
            data
        );
        
        return btoa(String.fromCharCode(...new Uint8Array(encrypted)));
    }
    
    // è§£å¯†æ•°æ®
    async decryptData(ciphertext) {
        const data = Uint8Array.from(atob(ciphertext), c => c.charCodeAt(0));
        
        const decrypted = await window.crypto.subtle.decrypt(
            { name: "RSA-OAEP" },
            this.privateKey,
            data
        );
        
        const decoder = new TextDecoder();
        return decoder.decode(decrypted);
    }
}
```

**Vueç»„ä»¶é›†æˆ**
```vue
<template>
  <div>
    <input v-model="sensitiveData" 
           @input="handleDataInput" 
           type="password" 
           placeholder="è¾“å…¥æ•æ„Ÿä¿¡æ¯">
    <button @click="submitData">æäº¤</button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      sensitiveData: '',
      encryptionService: null
    };
  },
  
  async mounted() {
    this.encryptionService = new ClientEncryptionService();
    await this.encryptionService.initializeKeys();
  },
  
  methods: {
    async submitData() {
      try {
        // å‰ç«¯åŠ å¯†
        const encryptedData = await this.encryptionService
          .encryptData(this.sensitiveData);
        
        // å‘é€å¯†æ–‡åˆ°æœåŠ¡å™¨
        await this.$http.post('/api/secure-data', {
          encryptedValue: encryptedData
        });
        
        this.sensitiveData = '';  // æ¸…ç©ºæ˜æ–‡
      } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
      }
    }
  }
};
</script>
```

### 9.4 å¯†é’¥äº¤æ¢æœºåˆ¶


**æœåŠ¡å™¨ç«¯å¯†é’¥ç®¡ç†**
```java
@RestController
public class KeyExchangeController {
    
    @Autowired
    private KeyExchangeService keyExchangeService;
    
    // è·å–æœåŠ¡å™¨å…¬é’¥
    @GetMapping("/api/public-key")
    public ResponseEntity<String> getPublicKey() {
        String publicKey = keyExchangeService.getServerPublicKey();
        return ResponseEntity.ok(publicKey);
    }
    
    // å®¢æˆ·ç«¯æ³¨å†Œå…¬é’¥
    @PostMapping("/api/register-client-key")
    public ResponseEntity<Void> registerClientKey(
            @RequestBody ClientKeyRequest request) {
        keyExchangeService.registerClientPublicKey(
            request.getClientId(), 
            request.getPublicKey());
        return ResponseEntity.ok().build();
    }
}
```

---

## 10. ğŸŒ åŠ å¯†ä»£ç†ç½‘å…³


### 10.1 åŠ å¯†ä»£ç†ç½‘å…³ä½œç”¨


åŠ å¯†ä»£ç†ç½‘å…³æ˜¯éƒ¨ç½²åœ¨åº”ç”¨å’Œæ•°æ®åº“ä¹‹é—´çš„ä¸€ä¸ªä¸“é—¨å¤„ç†åŠ å¯†çš„ä¸­é—´å±‚ï¼Œå®ƒå¯ä»¥é€æ˜åœ°å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†è§£å¯†ï¼Œåº”ç”¨ç¨‹åºæ„Ÿè§‰ä¸åˆ°åŠ å¯†çš„å­˜åœ¨ã€‚

> ğŸŒ **ç½‘å…³ä½œç”¨**ï¼š
> - ç»Ÿä¸€åŠ å¯†ç­–ç•¥ï¼Œé¿å…æ¯ä¸ªåº”ç”¨é‡å¤å¼€å‘
> - é›†ä¸­å¯†é’¥ç®¡ç†ï¼Œæé«˜å®‰å…¨æ€§
> - æ”¯æŒå¤šç§æ•°æ®åº“ï¼Œæä¾›ç»Ÿä¸€æ¥å£
> - å¯ä»¥åŠ¨æ€è°ƒæ•´åŠ å¯†ç­–ç•¥ï¼Œä¸å½±å“åº”ç”¨

### 10.2 ç½‘å…³æ¶æ„è®¾è®¡


```
åŠ å¯†ä»£ç†ç½‘å…³æ¶æ„ï¼š

åº”ç”¨ç¨‹åºç¾¤
    â†“
è´Ÿè½½å‡è¡¡å™¨
    â†“
åŠ å¯†ä»£ç†ç½‘å…³é›†ç¾¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ç½‘å…³1â”‚ â”‚ç½‘å…³2â”‚   â”‚  â† é«˜å¯ç”¨éƒ¨ç½²
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åŠ å¯†å¼•æ“    â”‚   â”‚  â† ç»Ÿä¸€åŠ å¯†é€»è¾‘  
â”‚  â”‚ å¯†é’¥ç®¡ç†    â”‚   â”‚  â† é›†ä¸­å¯†é’¥æœåŠ¡
â”‚  â”‚ ç­–ç•¥ç®¡ç†    â”‚   â”‚  â† åŠ¨æ€ç­–ç•¥é…ç½®
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ•°æ®åº“é›†ç¾¤
```

### 10.3 ç½‘å…³å®ç°ç¤ºä¾‹


**SQLè§£æå’Œé‡å†™**
```java
@Component
public class EncryptionProxy {
    
    @Autowired
    private SqlParser sqlParser;
    
    @Autowired
    private EncryptionEngine encryptionEngine;
    
    public ResultSet executeQuery(String sql, Connection connection) {
        try {
            // 1. è§£æSQLè¯­å¥
            ParsedSql parsedSql = sqlParser.parse(sql);
            
            // 2. è¯†åˆ«éœ€è¦åŠ å¯†çš„å­—æ®µ
            List<EncryptionField> encryptionFields = 
                identifyEncryptionFields(parsedSql);
            
            // 3. é‡å†™SQLè¯­å¥
            String rewrittenSql = rewriteSqlForEncryption(parsedSql, encryptionFields);
            
            // 4. æ‰§è¡Œé‡å†™åçš„SQL
            PreparedStatement stmt = connection.prepareStatement(rewrittenSql);
            ResultSet rs = stmt.executeQuery();
            
            // 5. è§£å¯†ç»“æœé›†
            return decryptResultSet(rs, encryptionFields);
            
        } catch (SQLException e) {
            throw new ProxyException("æŸ¥è¯¢æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    private String rewriteSqlForEncryption(ParsedSql parsedSql, 
                                         List<EncryptionField> fields) {
        // å°†æŸ¥è¯¢æ¡ä»¶ä¸­çš„æ˜æ–‡å€¼æ›¿æ¢ä¸ºå¯†æ–‡
        for (EncryptionField field : fields) {
            if (parsedSql.hasWhereCondition(field.getColumnName())) {
                String plainValue = parsedSql.getWhereValue(field.getColumnName());
                String encryptedValue = encryptionEngine.encrypt(plainValue, field.getKeyId());
                parsedSql.replaceWhereValue(field.getColumnName(), encryptedValue);
            }
        }
        return parsedSql.toSql();
    }
}
```

### 10.4 åŠ¨æ€ç­–ç•¥é…ç½®


**ç­–ç•¥é…ç½®ç®¡ç†**
```yaml
# åŠ å¯†ç­–ç•¥é…ç½®
encryption-policies:
  - table: user_info
    columns:
      - name: phone
        algorithm: AES-256-GCM
        key-id: phone-key
        searchable: true      # æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢
      - name: id_card
        algorithm: SM4
        key-id: sensitive-key
        searchable: false     # ä¸æ”¯æŒæŸ¥è¯¢
        
  - table: order_info  
    columns:
      - name: amount
        algorithm: FORMAT_PRESERVING  # æ ¼å¼ä¿æŒåŠ å¯†
        key-id: financial-key
        format: "###.##"             # ä¿æŒé‡‘é¢æ ¼å¼
```

**ç­–ç•¥çƒ­æ›´æ–°**
```java
@Component
public class PolicyManager {
    
    private final Map<String, TablePolicy> policies = new ConcurrentHashMap<>();
    
    @EventListener
    public void onPolicyChange(PolicyChangeEvent event) {
        // ç­–ç•¥å˜æ›´æ—¶é‡æ–°åŠ è½½
        reloadPolicies();
        
        // æ¸…ç†ç›¸å…³ç¼“å­˜
        clearEncryptionCache(event.getTableName());
        
        // è®°å½•å˜æ›´æ—¥å¿—
        auditPolicyChange(event);
    }
    
    public TablePolicy getTablePolicy(String tableName) {
        return policies.get(tableName);
    }
    
    // æ”¯æŒA/Bæµ‹è¯•çš„ç­–ç•¥
    public TablePolicy getTablePolicyWithExperiment(String tableName, String userId) {
        TablePolicy basePolicy = policies.get(tableName);
        if (isInExperimentGroup(userId)) {
            return applyExperimentalPolicy(basePolicy);
        }
        return basePolicy;
    }
}
```

---

## 11. ğŸ›¡ï¸ åº”ç”¨å±‚åŠ å¯†å®‰å…¨ç­–ç•¥


### 11.1 å®‰å…¨ç­–ç•¥ç»¼è¿°


åº”ç”¨å±‚åŠ å¯†çš„å®‰å…¨ç­–ç•¥æ˜¯ç¡®ä¿æ•´ä¸ªåŠ å¯†ç³»ç»Ÿå®‰å…¨å¯é çš„é‡è¦ä¿éšœï¼Œæ¶µç›–äº†ä»å¯†é’¥ç®¡ç†åˆ°æ•°æ®å¤„ç†çš„å„ä¸ªç¯èŠ‚ã€‚

> ğŸ›¡ï¸ **å®‰å…¨åŸåˆ™**ï¼š
> - **æœ€å°æƒé™åŸåˆ™** - åªç»™å¿…è¦çš„è®¿é—®æƒé™
> - **æ·±åº¦é˜²å¾¡** - å¤šå±‚å®‰å…¨æªæ–½ï¼Œä¸ä¾èµ–å•ç‚¹
> - **æŒç»­ç›‘æ§** - å®æ—¶ç›‘æ§å¼‚å¸¸è¡Œä¸º
> - **å®šæœŸå®¡è®¡** - å®šæœŸæ£€æŸ¥å®‰å…¨é…ç½®å’Œæ—¥å¿—

### 11.2 è®¿é—®æ§åˆ¶ç­–ç•¥


**åŸºäºè§’è‰²çš„å¯†é’¥è®¿é—®æ§åˆ¶**
```java
@Component
public class KeyAccessControl {
    
    @Autowired
    private UserService userService;
    
    public boolean checkKeyAccess(String userId, String keyId) {
        User user = userService.getUser(userId);
        KeyPermission permission = getKeyPermission(keyId);
        
        // æ£€æŸ¥è§’è‰²æƒé™
        if (!hasRequiredRole(user, permission.getRequiredRoles())) {
            auditAccessDenied(userId, keyId, "è§’è‰²æƒé™ä¸è¶³");
            return false;
        }
        
        // æ£€æŸ¥IPç™½åå•
        if (!isAllowedIP(user.getCurrentIP(), permission.getAllowedIPs())) {
            auditAccessDenied(userId, keyId, "IPåœ°å€ä¸åœ¨ç™½åå•");
            return false;
        }
        
        // æ£€æŸ¥æ—¶é—´çª—å£
        if (!isInAllowedTimeWindow(permission.getTimeWindow())) {
            auditAccessDenied(userId, keyId, "ä¸åœ¨å…è®¸çš„æ—¶é—´çª—å£");
            return false;
        }
        
        auditAccessGranted(userId, keyId);
        return true;
    }
}
```

### 11.3 æ•°æ®è„±æ•ç­–ç•¥


**æ•æ„Ÿæ•°æ®åˆ†çº§è„±æ•**
```java
@Component
public class DataMaskingService {
    
    public String maskSensitiveData(String data, DataType dataType, 
                                  SecurityLevel userLevel) {
        switch (dataType) {
            case PHONE:
                return maskPhone(data, userLevel);
            case ID_CARD:
                return maskIdCard(data, userLevel);
            case EMAIL:
                return maskEmail(data, userLevel);
            default:
                return data;
        }
    }
    
    private String maskPhone(String phone, SecurityLevel userLevel) {
        if (userLevel == SecurityLevel.HIGH) {
            return phone;  // é«˜æƒé™ç”¨æˆ·çœ‹åˆ°å®Œæ•´ä¿¡æ¯
        } else if (userLevel == SecurityLevel.MEDIUM) {
            return phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
        } else {
            return "***********";  // ä½æƒé™ç”¨æˆ·çœ‹åˆ°å®Œå…¨è„±æ•
        }
    }
}
```

### 11.4 å®‰å…¨å®¡è®¡å’Œç›‘æ§


**åŠ å¯†æ“ä½œå®¡è®¡**
```java
@Component
@Aspect
public class EncryptionAuditAspect {
    
    private static final Logger auditLogger = 
        LoggerFactory.getLogger("ENCRYPTION_AUDIT");
    
    @Around("@annotation(Encrypted)")
    public Object auditEncryptionOperation(ProceedingJoinPoint joinPoint) 
            throws Throwable {
        
        String userId = getCurrentUserId();
        String operation = joinPoint.getSignature().getName();
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            
            // è®°å½•æˆåŠŸæ“ä½œ
            auditLogger.info("åŠ å¯†æ“ä½œæˆåŠŸ: userId={}, operation={}, duration={}ms",
                           userId, operation, System.currentTimeMillis() - startTime);
            
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æ“ä½œ
            auditLogger.error("åŠ å¯†æ“ä½œå¤±è´¥: userId={}, operation={}, error={}",
                            userId, operation, e.getMessage());
            throw e;
        }
    }
}
```

**å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**
```java
@Component
public class SecurityMonitor {
    
    private final Map<String, AtomicInteger> userFailureCount = new ConcurrentHashMap<>();
    private final Map<String, LocalDateTime> lastFailureTime = new ConcurrentHashMap<>();
    
    @EventListener
    public void onEncryptionFailure(EncryptionFailureEvent event) {
        String userId = event.getUserId();
        
        // ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
        int failureCount = userFailureCount.computeIfAbsent(userId, 
            k -> new AtomicInteger(0)).incrementAndGet();
        lastFailureTime.put(userId, LocalDateTime.now());
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
        if (failureCount > 5) {
            // å¯èƒ½çš„æš´åŠ›ç ´è§£æ”»å‡»
            sendSecurityAlert("ç”¨æˆ·å¼‚å¸¸åŠ å¯†å¤±è´¥", userId, failureCount);
            
            // ä¸´æ—¶é”å®šç”¨æˆ·
            temporaryLockUser(userId, Duration.ofMinutes(30));
        }
    }
    
    // å®šæœŸæ¸…ç†ç»Ÿè®¡æ•°æ®
    @Scheduled(fixedRate = 3600000)  // æ¯å°æ—¶æ‰§è¡Œ
    public void cleanupStatistics() {
        LocalDateTime oneHourAgo = LocalDateTime.now().minusHours(1);
        
        lastFailureTime.entrySet().removeIf(entry -> 
            entry.getValue().isBefore(oneHourAgo));
        
        userFailureCount.entrySet().removeIf(entry ->
            !lastFailureTime.containsKey(entry.getKey()));
    }
}
```

### 11.5 å®‰å…¨é…ç½®æ£€æŸ¥


**å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**
```java
@Component
public class SecurityConfigChecker {
    
    @PostConstruct
    public void checkSecurityConfiguration() {
        List<String> securityIssues = new ArrayList<>();
        
        // æ£€æŸ¥å¯†é’¥å¼ºåº¦
        if (!checkKeyStrength()) {
            securityIssues.add("å¯†é’¥å¼ºåº¦ä¸è¶³ï¼Œå»ºè®®ä½¿ç”¨256ä½å¯†é’¥");
        }
        
        // æ£€æŸ¥åŠ å¯†ç®—æ³•
        if (!checkEncryptionAlgorithm()) {
            securityIssues.add("ä½¿ç”¨äº†ä¸å®‰å…¨çš„åŠ å¯†ç®—æ³•");
        }
        
        // æ£€æŸ¥å¯†é’¥è½®æ¢
        if (!checkKeyRotation()) {
            securityIssues.add("å¯†é’¥è½®æ¢ç­–ç•¥æœªé…ç½®æˆ–é—´éš”è¿‡é•¿");
        }
        
        // æ£€æŸ¥è®¿é—®æ§åˆ¶
        if (!checkAccessControl()) {
            securityIssues.add("è®¿é—®æ§åˆ¶é…ç½®è¿‡äºå®½æ¾");
        }
        
        if (!securityIssues.isEmpty()) {
            log.warn("å‘ç°å®‰å…¨é…ç½®é—®é¢˜: {}", securityIssues);
            // å‘é€å‘Šè­¦é€šçŸ¥
            sendSecurityConfigAlert(securityIssues);
        }
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åº”ç”¨å±‚åŠ å¯†ï¼šåœ¨åº”ç”¨ç¨‹åºå±‚å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œæä¾›æœ€é«˜çº§åˆ«çš„æ•°æ®å®‰å…¨
ğŸ”¸ é€æ˜åŠ å¯†ï¼šå¯¹ä¸šåŠ¡ä»£ç é€æ˜ï¼Œé€šè¿‡æ¡†æ¶æˆ–ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†åŠ å¯†è§£å¯†
ğŸ”¸ å¯†é’¥ç®¡ç†ï¼šæ•´ä¸ªåŠ å¯†ç³»ç»Ÿçš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬ç”Ÿæˆã€å­˜å‚¨ã€è½®æ¢ã€é”€æ¯
ğŸ”¸ ç«¯åˆ°ç«¯åŠ å¯†ï¼šæ•°æ®ä»æºå¤´åˆ°ç»ˆç‚¹å…¨ç¨‹åŠ å¯†ï¼ŒæœåŠ¡ç«¯æ— æ³•çœ‹åˆ°æ˜æ–‡
ğŸ”¸ å®‰å…¨ç­–ç•¥ï¼šç¡®ä¿åŠ å¯†ç³»ç»Ÿå®‰å…¨å¯é çš„å„ç§æªæ–½å’Œè§„èŒƒ
```

### 12.2 å…³é”®æŠ€æœ¯é€‰æ‹©


**ğŸ”¹ å¼€å‘å¤æ‚åº¦å¯¹æ¯”**
```
ç®€å• â†’ å¤æ‚ï¼š
æ•°æ®åº“å±‚åŠ å¯† < ä¸­é—´ä»¶åŠ å¯† < ORMé›†æˆ < åº”ç”¨å±‚è‡ªå®ç° < ç«¯åˆ°ç«¯åŠ å¯†

å®‰å…¨æ€§å¯¹æ¯”ï¼š
æ•°æ®åº“å±‚åŠ å¯† < ä¸­é—´ä»¶åŠ å¯† < åº”ç”¨å±‚åŠ å¯† < ç«¯åˆ°ç«¯åŠ å¯†

ç»´æŠ¤éš¾åº¦ï¼š
æ•°æ®åº“å±‚åŠ å¯† < ä¸­é—´ä»¶åŠ å¯† < ORMé›†æˆ < åº”ç”¨å±‚åŠ å¯† < ç«¯åˆ°ç«¯åŠ å¯†
```

**ğŸ”¹ åœºæ™¯é€‰æ‹©å»ºè®®**
```
æ•æ„Ÿæ•°æ®è¾ƒå°‘ï¼Œå®‰å…¨è¦æ±‚ä¸€èˆ¬ï¼š
â†’ é€‰æ‹©æ•°æ®åº“å±‚TDEåŠ å¯†

å¤šåº”ç”¨å…±äº«ï¼Œå¸Œæœ›ç»Ÿä¸€ç®¡ç†ï¼š
â†’ é€‰æ‹©ä¸­é—´ä»¶åŠ å¯†æ–¹æ¡ˆ

å•åº”ç”¨ï¼Œéœ€è¦çµæ´»æ§åˆ¶ï¼š
â†’ é€‰æ‹©ORMæ¡†æ¶é›†æˆ

å®‰å…¨è¦æ±‚æé«˜ï¼Œä¸ä¿¡ä»»æœåŠ¡ç«¯ï¼š
â†’ é€‰æ‹©ç«¯åˆ°ç«¯åŠ å¯†

å·²æœ‰ç³»ç»Ÿæ”¹é€ ï¼Œå¸Œæœ›å½±å“æœ€å°ï¼š
â†’ é€‰æ‹©åº”ç”¨é€æ˜åŠ å¯†
```

### 12.3 å®æ–½æœ€ä½³å®è·µ


**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
- **åˆ†å±‚è®¾è®¡**ï¼šå¯†é’¥ç®¡ç†ã€åŠ å¯†å¼•æ“ã€ä¸šåŠ¡æ¥å£åˆ†ç¦»
- **å¼‚å¸¸å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§ç­–ç•¥
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜å’Œè¿æ¥æ± 
- **å®‰å…¨å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰åŠ å¯†ç›¸å…³æ“ä½œ
- **é…ç½®ç®¡ç†**ï¼šæ”¯æŒåŠ¨æ€é…ç½®å’Œçƒ­æ›´æ–°

**ğŸ“Š è¿ç»´ç›‘æ§è¦ç‚¹**
- **å¯†é’¥è½®æ¢**ï¼šå®šæœŸè‡ªåŠ¨è½®æ¢ï¼Œé¿å…å¯†é’¥è€åŒ–
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§åŠ å¯†è§£å¯†è€—æ—¶å’ŒæˆåŠŸç‡
- **å®‰å…¨å‘Šè­¦**ï¼šå¼‚å¸¸è®¿é—®å’Œå¤±è´¥æ“ä½œåŠæ—¶å‘Šè­¦
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®åŠ å¯†è´Ÿè½½åšå¥½å®¹é‡é¢„ä¼°
- **ç¾å¤‡ç­–ç•¥**ï¼šå¯†é’¥å’Œé…ç½®çš„å¤‡ä»½æ¢å¤æ–¹æ¡ˆ

### 12.4 å®‰å…¨æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§å®‰å…¨é™·é˜±**
```
å¯†é’¥ç¡¬ç¼–ç ï¼š
âŒ åœ¨ä»£ç ä¸­ç›´æ¥å†™æ­»å¯†é’¥
âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡

æ—¥å¿—æ³„éœ²ï¼š
âŒ åœ¨æ—¥å¿—ä¸­è®°å½•æ˜æ–‡æ•°æ®æˆ–å¯†é’¥
âœ… å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†

å¼‚å¸¸ä¿¡æ¯æš´éœ²ï¼š
âŒ å¼‚å¸¸ä¿¡æ¯ä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯
âœ… ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œè¿‡æ»¤æ•æ„Ÿä¿¡æ¯

æƒé™è¿‡å¤§ï¼š
âŒ æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½è®¿é—®æ‰€æœ‰å¯†é’¥
âœ… åŸºäºè§’è‰²çš„æœ€å°æƒé™æ§åˆ¶
```

**ğŸ›¡ï¸ å®‰å…¨åŠ å›ºå»ºè®®**
- **å¤šé‡éªŒè¯**ï¼šå…³é”®æ“ä½œéœ€è¦å¤šé‡èº«ä»½éªŒè¯
- **ç½‘ç»œéš”ç¦»**ï¼šå¯†é’¥ç®¡ç†æœåŠ¡ä¸ä¸šåŠ¡ç½‘ç»œéš”ç¦»
- **å®šæœŸå®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥é…ç½®å’Œè®¿é—®æ—¥å¿—
- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šå¯†é’¥æ³„éœ²ç­‰å®‰å…¨äº‹ä»¶åº”æ€¥é¢„æ¡ˆ

**æ ¸å¿ƒè®°å¿†**ï¼š
- åº”ç”¨å±‚åŠ å¯†æä¾›æœ€å¼ºæ•°æ®ä¿æŠ¤ï¼Œä½†å¢åŠ å¼€å‘å¤æ‚åº¦
- å¯†é’¥ç®¡ç†æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨åŸºçŸ³ï¼Œå¿…é¡»é‡ç‚¹å…³æ³¨
- é€‰æ‹©åˆé€‚çš„åŠ å¯†æ–¹æ¡ˆï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œå®ç”¨æ€§
- å®Œå–„çš„ç›‘æ§å’Œå®¡è®¡æ˜¯å®‰å…¨è¿è¡Œçš„é‡è¦ä¿éšœ