---
title: 15、代理用户权限
---
## 📚 目录

1. [PROXY权限机制](#1-PROXY权限机制)
2. [代理用户映射](#2-代理用户映射)
3. [权限代理规则](#3-权限代理规则)
4. [代理身份验证](#4-代理身份验证)
5. [代理用户管理](#5-代理用户管理)
6. [权限继承关系](#6-权限继承关系)
7. [安全代理配置](#7-安全代理配置)
8. [代理认证流程](#8-代理认证流程)
9. [代理权限审计](#9-代理权限审计)
10. [安全风险防护](#10-安全风险防护)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🔐 PROXY权限机制


### 1.1 什么是PROXY权限


**PROXY权限**是MySQL中一种特殊的权限机制，允许一个用户**代理**另一个用户进行数据库操作。

```
简单理解：
用户A通过PROXY权限 → 可以"变身"成用户B → 使用用户B的所有权限

就像：秘书代理老板签字，秘书用的是老板的权限
```

**核心概念**：
```sql
-- 授予代理权限的基本语法
GRANT PROXY ON 被代理用户 TO 代理用户;

-- 实际例子
GRANT PROXY ON 'boss'@'%' TO 'secretary'@'%';
```

### 1.2 PROXY权限的工作原理


**代理关系图**：
```
代理用户（Proxy User）     被代理用户（Proxied User）
     ↓                         ↑
  登录连接              实际执行权限
     ↓                         ↑
  身份验证              权限来源
     ↓─────────────────────────↑
        代理映射关系
```

**关键理解**：
- **代理用户**：实际登录的账户（谁来操作）
- **被代理用户**：权限来源账户（用谁的权限）
- **权限继承**：代理用户获得被代理用户的所有权限

---

## 2. 🔄 代理用户映射


### 2.1 映射关系建立


**映射就是建立"谁可以代理谁"的关系**。

```sql
-- 基础映射示例
-- 创建被代理用户（权限拥有者）
CREATE USER 'data_admin'@'%' IDENTIFIED BY 'admin123';
GRANT SELECT, INSERT, UPDATE ON company.* TO 'data_admin'@'%';

-- 创建代理用户（实际登录者）
CREATE USER 'app_user'@'%' IDENTIFIED BY 'app123';

-- 建立代理映射
GRANT PROXY ON 'data_admin'@'%' TO 'app_user'@'%';
```

### 2.2 多层代理映射


**代理链**：A代理B，B代理C，形成代理链条。

```
代理链示例：
员工 → 组长 → 部门经理 → 总监

app_user → team_lead → dept_manager → director
```

```sql
-- 建立代理链
CREATE USER 'director'@'%' IDENTIFIED BY 'dir123';
CREATE USER 'dept_manager'@'%' IDENTIFIED BY 'mgr123';
CREATE USER 'team_lead'@'%' IDENTIFIED BY 'lead123';
CREATE USER 'app_user'@'%' IDENTIFIED BY 'app123';

-- 权限设置
GRANT ALL ON company.* TO 'director'@'%';

-- 代理链设置
GRANT PROXY ON 'director'@'%' TO 'dept_manager'@'%';
GRANT PROXY ON 'dept_manager'@'%' TO 'team_lead'@'%';
GRANT PROXY ON 'team_lead'@'%' TO 'app_user'@'%';
```

### 2.3 查看代理映射


```sql
-- 查看所有代理关系
SELECT * FROM mysql.proxies_priv;

-- 查看特定用户的代理权限
SHOW GRANTS FOR 'app_user'@'%';
```

---

## 3. ⚖️ 权限代理规则


### 3.1 权限继承规则


**基本规则**：代理用户获得被代理用户的**所有权限**，但有例外。

```
权限继承表：
┌─────────────────┬──────────────┬─────────────┐
│     权限类型     │   是否继承   │   说明      │
├─────────────────┼──────────────┼─────────────┤
│ 数据库操作权限   │      ✅      │ 完全继承    │
│ 表级权限        │      ✅      │ 完全继承    │
│ 列级权限        │      ✅      │ 完全继承    │
│ PROXY权限       │      ❌      │ 不能继承    │
│ GRANT权限       │      ❌      │ 不能继承    │
└─────────────────┴──────────────┴─────────────┘
```

### 3.2 权限限制规则


**重要限制**：
- **不能代理PROXY**：代理用户不能再把PROXY权限给别人
- **不能代理GRANT**：代理用户不能给其他用户授权
- **不能修改被代理用户**：代理用户不能修改被代理用户的密码或权限

```sql
-- 这些操作会失败
-- 代理用户尝试授予PROXY权限
GRANT PROXY ON 'other_user'@'%' TO 'another_user'@'%'; -- 失败

-- 代理用户尝试授予其他权限  
GRANT SELECT ON test.* TO 'other_user'@'%'; -- 失败

-- 代理用户尝试修改被代理用户密码
ALTER USER 'data_admin'@'%' IDENTIFIED BY 'new_password'; -- 失败
```

---

## 4. 🔑 代理身份验证


### 4.1 认证过程


**代理认证流程**：
```
1. 客户端连接 → 使用代理用户凭据
2. MySQL验证 → 验证代理用户身份
3. 检查代理权限 → 确认是否有PROXY权限
4. 切换身份 → 切换到被代理用户权限
5. 执行操作 → 使用被代理用户权限执行
```

```sql
-- 登录示例
mysql -u app_user -p'app123' -h localhost

-- 查看当前用户身份
SELECT USER(), CURRENT_USER();
-- 结果：app_user@localhost, data_admin@%
-- USER()显示登录用户，CURRENT_USER()显示权限来源用户
```

### 4.2 身份识别


**双重身份概念**：
- **连接用户**：实际登录的用户（app_user）
- **权限用户**：提供权限的用户（data_admin）

```sql
-- 查看身份信息
SELECT 
    USER() as '登录用户',
    CURRENT_USER() as '权限用户',
    $$proxy_user as '代理用户';
```

---

## 5. 👥 代理用户管理


### 5.1 创建代理用户体系


**实际场景**：为应用系统创建代理用户体系。

```sql
-- 1. 创建角色用户（被代理用户）
CREATE USER 'role_readonly'@'%' IDENTIFIED BY 'readonly123';
CREATE USER 'role_readwrite'@'%' IDENTIFIED BY 'readwrite123';
CREATE USER 'role_admin'@'%' IDENTIFIED BY 'admin123';

-- 2. 分配角色权限
GRANT SELECT ON app_db.* TO 'role_readonly'@'%';
GRANT SELECT, INSERT, UPDATE ON app_db.* TO 'role_readwrite'@'%';
GRANT ALL PRIVILEGES ON app_db.* TO 'role_admin'@'%';

-- 3. 创建应用用户（代理用户）
CREATE USER 'app_read'@'%' IDENTIFIED BY 'read123';
CREATE USER 'app_write'@'%' IDENTIFIED BY 'write123';
CREATE USER 'app_admin'@'%' IDENTIFIED BY 'admin123';

-- 4. 建立代理关系
GRANT PROXY ON 'role_readonly'@'%' TO 'app_read'@'%';
GRANT PROXY ON 'role_readwrite'@'%' TO 'app_write'@'%';
GRANT PROXY ON 'role_admin'@'%' TO 'app_admin'@'%';
```

### 5.2 批量管理代理用户


```sql
-- 批量撤销代理权限
REVOKE PROXY ON 'role_admin'@'%' FROM 'app_admin'@'%';

-- 批量查看代理关系
SELECT 
    Host, User, Proxied_host, Proxied_user, With_grant
FROM mysql.proxies_priv 
WHERE User LIKE 'app_%';
```

---

## 6. 🔗 权限继承关系


### 6.1 继承层次结构


**权限继承图**：
```
被代理用户权限
    ↓
代理用户获得权限
    ↓
实际执行权限

例如：
role_admin (ALL PRIVILEGES)
    ↓
app_admin (继承 ALL PRIVILEGES)
    ↓
执行操作时使用 ALL PRIVILEGES
```

### 6.2 权限生效验证


```sql
-- 验证权限继承
-- 使用代理用户登录后执行
SHOW GRANTS;
-- 会显示被代理用户的权限

-- 测试具体权限
USE app_db;
SELECT * FROM users LIMIT 1;  -- 测试SELECT权限
INSERT INTO test_table VALUES (1, 'test');  -- 测试INSERT权限
```

---

## 7. 🛡️ 安全代理配置


### 7.1 安全配置原则


**最小权限原则**：
- 代理用户只分配必要的PROXY权限
- 被代理用户只分配必要的数据库权限
- 避免过度授权

```sql
-- 安全配置示例
-- 创建专用的被代理用户，只有特定权限
CREATE USER 'proxy_target'@'localhost' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT ON specific_db.specific_table TO 'proxy_target'@'localhost';

-- 创建代理用户，只能从特定主机连接
CREATE USER 'proxy_user'@'192.168.1.%' IDENTIFIED BY 'strong_password';
GRANT PROXY ON 'proxy_target'@'localhost' TO 'proxy_user'@'192.168.1.%';
```

### 7.2 代理权限隔离


```sql
-- 环境隔离：开发、测试、生产分别设置
-- 开发环境代理用户
CREATE USER 'dev_proxy'@'dev_network' IDENTIFIED BY 'dev_pass';
GRANT PROXY ON 'dev_role'@'%' TO 'dev_proxy'@'dev_network';

-- 生产环境代理用户  
CREATE USER 'prod_proxy'@'prod_network' IDENTIFIED BY 'prod_pass';
GRANT PROXY ON 'prod_role'@'%' TO 'prod_proxy'@'prod_network';
```

---

## 8. 🔄 代理认证流程


### 8.1 完整认证流程图


```
客户端                     MySQL服务器
   |                           |
   |--[1]连接请求-------------->|
   |   用户名：app_user        |
   |   密码：app123            |
   |                           |
   |<--[2]认证挑战-------------|
   |                           |
   |--[3]提供凭据-------------->|
   |                           |--[4]验证app_user凭据
   |                           |
   |                           |--[5]检查PROXY权限
   |                           |
   |                           |--[6]切换到被代理用户权限
   |                           |
   |<--[7]认证成功-------------|
   |                           |
   |--[8]执行SQL语句---------->|
   |                           |--[9]使用被代理用户权限执行
   |                           |
   |<--[10]返回结果------------|
```

### 8.2 认证失败场景


```sql
-- 常见认证失败原因

-- 1. 代理用户密码错误
ERROR 1045: Access denied for user 'app_user'@'host'

-- 2. 没有PROXY权限
ERROR 1141: There is no such grant defined for user 'app_user' on host 'host'

-- 3. 被代理用户不存在
ERROR 1133: Can't find any matching row in the user table
```

---

## 9. 📊 代理权限审计


### 9.1 审计查询


```sql
-- 查看所有代理关系
SELECT 
    CONCAT(User, '@', Host) AS '代理用户',
    CONCAT(Proxied_user, '@', Proxied_host) AS '被代理用户',
    With_grant AS '可否再授权'
FROM mysql.proxies_priv
ORDER BY User;

-- 查看特定用户的代理权限
SELECT * FROM mysql.proxies_priv 
WHERE User = 'app_user' AND Host = '%';

-- 查看谁在代理特定用户
SELECT * FROM mysql.proxies_priv 
WHERE Proxied_user = 'role_admin';
```

### 9.2 权限使用监控


```sql
-- 启用审计日志（需要配置）
-- 在my.cnf中添加：
-- audit_log_policy=ALL
-- audit_log_format=JSON

-- 查看当前连接的代理状态
SELECT 
    processlist_id,
    processlist_user,
    processlist_host,
    current_user,
    proxy_user
FROM performance_schema.accounts;
```

---

## 10. ⚠️ 安全风险防护


### 10.1 常见安全风险


**🔴 高风险**：
- **代理权限过度授权**：给了不需要的PROXY权限
- **被代理用户权限过大**：被代理用户有过多权限
- **代理链过长**：多级代理增加复杂性和风险

**🟡 中等风险**：
- **缺乏审计**：不知道谁在使用代理权限
- **密码策略松散**：代理用户密码不够强

### 10.2 防护措施


```sql
-- 1. 定期检查代理关系
SELECT COUNT(*) as '代理关系数量' FROM mysql.proxies_priv;

-- 2. 检查高权限代理
SELECT p.User, p.Proxied_user, u.Super_priv
FROM mysql.proxies_priv p
JOIN mysql.user u ON p.Proxied_user = u.User 
WHERE u.Super_priv = 'Y';

-- 3. 设置代理用户过期时间
ALTER USER 'temp_proxy'@'%' PASSWORD EXPIRE INTERVAL 30 DAY;
```

### 10.3 安全最佳实践


**✅ 推荐做法**：
```sql
-- 1. 使用强密码
CREATE USER 'secure_proxy'@'%' IDENTIFIED BY 'Complex_P@ssw0rd!';

-- 2. 限制连接来源
CREATE USER 'app_proxy'@'192.168.1.0/255.255.255.0' IDENTIFIED BY 'strong_pass';

-- 3. 定期轮换密码
ALTER USER 'app_proxy'@'%' IDENTIFIED BY 'new_strong_password';

-- 4. 最小权限原则
GRANT PROXY ON 'limited_role'@'%' TO 'app_proxy'@'%';
-- 而不是授权给高权限用户
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


```
🔸 PROXY权限：让一个用户可以"变身"成另一个用户
🔸 代理映射：建立"谁可以代理谁"的关系  
🔸 权限继承：代理用户获得被代理用户的数据库权限
🔸 双重身份：登录用户 vs 权限用户
🔸 安全限制：不能代理PROXY和GRANT权限
```

### 11.2 关键理解要点


**🔹 代理权限的本质**
```
代理权限 = 身份切换机制
目的：分离身份认证和权限管理
好处：灵活的权限分配，统一的角色管理
```

**🔹 使用场景**
```
适用场景：
• 应用程序用户管理
• 角色权限体系
• 临时权限授予
• 权限集中管理

不适用场景：
• 简单的权限需求
• 高度安全敏感的操作
• 需要精确权限控制的场景
```

**🔹 安全考虑**
```
关键原则：
• 最小权限原则
• 定期审计代理关系
• 强密码策略
• 限制连接来源
• 避免过度复杂的代理链
```

### 11.3 实际应用价值


- **权限管理简化**：通过角色用户统一管理权限
- **应用程序集成**：为不同功能模块分配不同权限级别
- **安全性提升**：分离认证和授权，便于管理
- **灵活性增强**：可以动态调整权限而不影响应用连接

**核心记忆**：
- PROXY权限让用户可以"借用"其他用户的权限
- 代理用户负责登录，被代理用户提供权限
- 权限继承有限制，不能代理管理类权限
- 安全使用需要遵循最小权限原则和定期审计