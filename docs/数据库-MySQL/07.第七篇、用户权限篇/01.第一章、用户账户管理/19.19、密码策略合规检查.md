---
title: 19、密码策略合规检查
---
## 📚 目录

1. [密码合规性验证基础](#1-密码合规性验证基础)
2. [企业密码标准制定](#2-企业密码标准制定)
3. [密码审计报告生成](#3-密码审计报告生成)
4. [弱密码检测机制](#4-弱密码检测机制)
5. [密码安全评分系统](#5-密码安全评分系统)
6. [批量密码检查](#6-批量密码检查)
7. [密码合规监控](#7-密码合规监控)
8. [密码安全态势感知](#8-密码安全态势感知)
9. [密码合规安全框架](#9-密码合规安全框架)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔐 密码合规性验证基础


### 1.1 什么是密码合规性验证


密码合规性验证是指根据企业或行业的安全标准，检查数据库用户密码是否符合预定的安全规范。简单来说，就是确保每个用户的密码都足够安全，不会成为系统的安全漏洞。

**核心作用**：
- **安全防护**：防止弱密码导致的安全漏洞
- **标准统一**：确保所有账户遵循相同的密码标准
- **合规要求**：满足行业监管和企业内控要求

### 1.2 MySQL密码验证组件


MySQL提供了内置的密码验证插件来实现密码合规检查：

```sql
-- 查看当前密码验证插件状态
SHOW VARIABLES LIKE 'validate_password%';

-- 安装密码验证插件
INSTALL PLUGIN validate_password SONAME 'validate_password.so';

-- 配置密码策略级别
SET GLOBAL validate_password.policy = STRONG;
SET GLOBAL validate_password.length = 12;
SET GLOBAL validate_password.mixed_case_count = 2;
SET GLOBAL validate_password.number_count = 2;
SET GLOBAL validate_password.special_char_count = 2;
```

### 1.3 密码策略级别详解


```
密码策略等级说明：

LOW (0)：
└── 只检查密码长度（默认8位）

MEDIUM (1)：
├── 检查长度
├── 数字、大小写字母、特殊字符
└── 不能是字典词汇

STRONG (2)：
├── 包含MEDIUM所有检查
├── 不能包含用户名
└── 不能是常见弱密码模式
```

---

## 2. 📋 企业密码标准制定


### 2.1 制定密码规范标准


企业密码标准是根据业务需求和安全要求制定的统一规范，确保所有数据库账户都有足够强度的密码。

**标准制定原则**：
- **复杂度要求**：长度、字符类型、组合规则
- **时效性要求**：密码有效期、更换频率
- **唯一性要求**：历史密码重用限制

```sql
-- 创建企业密码策略配置表
CREATE TABLE password_policy_config (
    policy_id INT PRIMARY KEY AUTO_INCREMENT,
    policy_name VARCHAR(50) NOT NULL,
    min_length INT DEFAULT 12,
    require_uppercase BOOLEAN DEFAULT TRUE,
    require_lowercase BOOLEAN DEFAULT TRUE, 
    require_numbers BOOLEAN DEFAULT TRUE,
    require_special_chars BOOLEAN DEFAULT TRUE,
    min_special_chars INT DEFAULT 2,
    password_expiry_days INT DEFAULT 90,
    password_history_count INT DEFAULT 5,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入不同级别的密码策略
INSERT INTO password_policy_config 
(policy_name, min_length, min_special_chars, password_expiry_days) 
VALUES 
('BASIC', 8, 1, 180),
('STANDARD', 12, 2, 90),
('HIGH_SECURITY', 16, 3, 60);
```

### 2.2 角色相关密码策略


不同角色的用户需要不同强度的密码策略：

| 用户角色 | **最小长度** | **复杂度要求** | **更换周期** | **说明** |
|---------|------------|-------------|------------|---------|
| 🔑 **超级管理员** | `16位` | `大小写+数字+特殊字符` | `30天` | `最高安全级别` |
| 👥 **普通管理员** | `12位` | `大小写+数字+特殊字符` | `60天` | `标准安全级别` |
| 📊 **业务用户** | `10位` | `大小写+数字` | `90天` | `基础安全级别` |
| 🤖 **应用账户** | `16位` | `随机生成强密码` | `180天` | `系统自动管理` |

---

## 3. 📊 密码审计报告生成


### 3.1 密码安全状态审计


密码审计是定期检查所有用户账户密码状态的过程，生成详细的安全报告供管理员分析。

```sql
-- 创建密码审计日志表
CREATE TABLE password_audit_log (
    audit_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    password_strength ENUM('WEAK', 'MEDIUM', 'STRONG'),
    last_password_change DATETIME,
    days_since_change INT,
    compliance_status ENUM('COMPLIANT', 'WARNING', 'VIOLATION'),
    audit_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT
);

-- 生成密码审计报告的存储过程
DELIMITER //
CREATE PROCEDURE GeneratePasswordAuditReport()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_user VARCHAR(100);
    DECLARE v_last_change DATETIME;
    DECLARE v_days_diff INT;
    DECLARE v_status VARCHAR(20);
    
    -- 游标声明
    DECLARE user_cursor CURSOR FOR 
        SELECT user, password_last_changed 
        FROM mysql.user 
        WHERE user != '';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- 清空当前审计数据
    DELETE FROM password_audit_log WHERE DATE(audit_date) = CURDATE();
    
    OPEN user_cursor;
    
    audit_loop: LOOP
        FETCH user_cursor INTO v_user, v_last_change;
        IF done THEN
            LEAVE audit_loop;
        END IF;
        
        -- 计算密码更改天数
        SET v_days_diff = DATEDIFF(NOW(), v_last_change);
        
        -- 判断合规状态
        IF v_days_diff > 90 THEN
            SET v_status = 'VIOLATION';
        ELSEIF v_days_diff > 60 THEN
            SET v_status = 'WARNING';  
        ELSE
            SET v_status = 'COMPLIANT';
        END IF;
        
        -- 插入审计记录
        INSERT INTO password_audit_log 
        (username, last_password_change, days_since_change, compliance_status)
        VALUES (v_user, v_last_change, v_days_diff, v_status);
        
    END LOOP;
    
    CLOSE user_cursor;
END //
DELIMITER ;
```

### 3.2 审计报告分析查询


```sql
-- 密码合规性统计报告
SELECT 
    compliance_status AS '合规状态',
    COUNT(*) AS '用户数量',
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM password_audit_log), 2) AS '占比%'
FROM password_audit_log 
WHERE DATE(audit_date) = CURDATE()
GROUP BY compliance_status;

-- 密码老化用户列表
SELECT 
    username AS '用户名',
    days_since_change AS '密码使用天数',
    CASE 
        WHEN days_since_change > 90 THEN '⚠️ 急需更换'
        WHEN days_since_change > 60 THEN '📅 即将到期' 
        ELSE '✅ 正常'
    END AS '状态提醒'
FROM password_audit_log 
WHERE compliance_status IN ('WARNING', 'VIOLATION')
ORDER BY days_since_change DESC;
```

---

## 4. 🚨 弱密码检测机制


### 4.1 常见弱密码模式识别


弱密码检测是识别和发现不安全密码的自动化过程，防止攻击者利用常见密码进行暴力破解。

**常见弱密码特征**：
- **字典词汇**：password、admin、123456
- **键盘模式**：qwerty、asdf、12345
- **个人信息**：生日、姓名、电话
- **简单替换**：p@ssw0rd（字母数字替换）

```sql
-- 创建弱密码黑名单表
CREATE TABLE weak_password_blacklist (
    id INT PRIMARY KEY AUTO_INCREMENT,
    password_pattern VARCHAR(100) NOT NULL,
    pattern_type ENUM('DICTIONARY', 'KEYBOARD', 'COMMON', 'PERSONAL') DEFAULT 'COMMON',
    risk_level ENUM('HIGH', 'MEDIUM', 'LOW') DEFAULT 'HIGH',
    description TEXT,
    added_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加常见弱密码模式
INSERT INTO weak_password_blacklist (password_pattern, pattern_type, risk_level, description) VALUES
('password', 'DICTIONARY', 'HIGH', '常见英文单词'),
('123456', 'COMMON', 'HIGH', '连续数字'),
('qwerty', 'KEYBOARD', 'HIGH', '键盘顺序'),
('admin', 'DICTIONARY', 'HIGH', '管理员默认'),
('welcome', 'DICTIONARY', 'MEDIUM', '欢迎词汇'),
('company', 'DICTIONARY', 'MEDIUM', '公司相关'),
('12345678', 'COMMON', 'HIGH', '简单数字序列');
```

### 4.2 密码强度检测函数


```sql
-- 创建密码强度检测函数
DELIMITER //
CREATE FUNCTION CheckPasswordStrength(input_password VARCHAR(255))
RETURNS VARCHAR(20)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE strength_score INT DEFAULT 0;
    DECLARE result VARCHAR(20);
    
    -- 长度检查
    IF LENGTH(input_password) >= 12 THEN
        SET strength_score = strength_score + 2;
    ELSEIF LENGTH(input_password) >= 8 THEN
        SET strength_score = strength_score + 1;
    END IF;
    
    -- 大写字母检查
    IF input_password REGEXP '[A-Z]' THEN
        SET strength_score = strength_score + 1;
    END IF;
    
    -- 小写字母检查  
    IF input_password REGEXP '[a-z]' THEN
        SET strength_score = strength_score + 1;
    END IF;
    
    -- 数字检查
    IF input_password REGEXP '[0-9]' THEN
        SET strength_score = strength_score + 1;
    END IF;
    
    -- 特殊字符检查
    IF input_password REGEXP '[^A-Za-z0-9]' THEN
        SET strength_score = strength_score + 2;
    END IF;
    
    -- 评分结果
    IF strength_score >= 6 THEN
        SET result = 'STRONG';
    ELSEIF strength_score >= 4 THEN
        SET result = 'MEDIUM';
    ELSE
        SET result = 'WEAK';
    END IF;
    
    RETURN result;
END //
DELIMITER ;
```

---

## 5. 📈 密码安全评分系统


### 5.1 综合安全评分机制


密码安全评分是量化密码安全强度的方法，通过多个维度的检查给出具体的安全分数。

**评分维度**：
```
基础分数 (40分)：
├── 长度评分 (20分)
│   ├── 8-11位：10分  
│   ├── 12-15位：15分
│   └── 16位以上：20分
└── 复杂度评分 (20分)
    ├── 包含大写：5分
    ├── 包含小写：5分  
    ├── 包含数字：5分
    └── 包含特殊字符：5分

高级分数 (60分)：
├── 模式检查 (20分)
│   ├── 无字典词汇：10分
│   ├── 无键盘模式：5分
│   └── 无重复字符：5分
├── 熵值计算 (20分)
└── 历史重用检查 (20分)
```

```sql
-- 创建密码评分详情表
CREATE TABLE password_score_details (
    score_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL,
    base_score INT DEFAULT 0,
    length_score INT DEFAULT 0,
    complexity_score INT DEFAULT 0,
    pattern_score INT DEFAULT 0,
    entropy_score INT DEFAULT 0,
    history_score INT DEFAULT 0,
    total_score INT DEFAULT 0,
    grade CHAR(1),
    evaluated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 密码评分存储过程
DELIMITER //
CREATE PROCEDURE EvaluatePasswordScore(IN target_user VARCHAR(100), IN user_password VARCHAR(255))
BEGIN
    DECLARE v_length_score, v_complexity_score, v_pattern_score INT DEFAULT 0;
    DECLARE v_total_score INT DEFAULT 0;
    DECLARE v_grade CHAR(1);
    
    -- 长度评分
    IF LENGTH(user_password) >= 16 THEN
        SET v_length_score = 20;
    ELSEIF LENGTH(user_password) >= 12 THEN
        SET v_length_score = 15;
    ELSEIF LENGTH(user_password) >= 8 THEN
        SET v_length_score = 10;
    ELSE
        SET v_length_score = 0;
    END IF;
    
    -- 复杂度评分
    IF user_password REGEXP '[A-Z]' THEN
        SET v_complexity_score = v_complexity_score + 5;
    END IF;
    IF user_password REGEXP '[a-z]' THEN
        SET v_complexity_score = v_complexity_score + 5;
    END IF;
    IF user_password REGEXP '[0-9]' THEN
        SET v_complexity_score = v_complexity_score + 5;
    END IF;
    IF user_password REGEXP '[^A-Za-z0-9]' THEN
        SET v_complexity_score = v_complexity_score + 5;
    END IF;
    
    -- 模式检查评分
    SET v_pattern_score = 20; -- 默认满分
    IF EXISTS(SELECT 1 FROM weak_password_blacklist WHERE user_password LIKE CONCAT('%', password_pattern, '%')) THEN
        SET v_pattern_score = v_pattern_score - 10;
    END IF;
    
    -- 计算总分
    SET v_total_score = v_length_score + v_complexity_score + v_pattern_score;
    
    -- 等级评定
    IF v_total_score >= 80 THEN SET v_grade = 'A';
    ELSEIF v_total_score >= 70 THEN SET v_grade = 'B';
    ELSEIF v_total_score >= 60 THEN SET v_grade = 'C';
    ELSEIF v_total_score >= 50 THEN SET v_grade = 'D';
    ELSE SET v_grade = 'F';
    END IF;
    
    -- 保存评分结果
    INSERT INTO password_score_details 
    (username, length_score, complexity_score, pattern_score, total_score, grade)
    VALUES (target_user, v_length_score, v_complexity_score, v_pattern_score, v_total_score, v_grade);
    
END //
DELIMITER ;
```

### 5.2 安全评级可视化报告


```sql
-- 用户密码安全等级分布
SELECT 
    grade AS '安全等级',
    COUNT(*) AS '用户数量',
    CASE grade
        WHEN 'A' THEN '🟢 优秀 (80-100分)'
        WHEN 'B' THEN '🟡 良好 (70-79分)'  
        WHEN 'C' THEN '🟠 一般 (60-69分)'
        WHEN 'D' THEN '🔴 较差 (50-59分)'
        WHEN 'F' THEN '⚫ 不合格 (<50分)'
    END AS '等级描述'
FROM password_score_details 
WHERE DATE(evaluated_at) = CURDATE()
GROUP BY grade 
ORDER BY grade;

-- Top 10 最需要改进的用户
SELECT 
    username AS '用户名',
    total_score AS '当前得分',
    grade AS '等级',
    CASE 
        WHEN total_score < 50 THEN '立即更换密码'
        WHEN total_score < 70 THEN '建议增强密码'
        ELSE '密码安全'
    END AS '建议操作'
FROM password_score_details 
WHERE DATE(evaluated_at) = CURDATE()
ORDER BY total_score ASC 
LIMIT 10;
```

---

## 6. ⚡ 批量密码检查


### 6.1 批量检查机制


批量密码检查是对系统中所有用户账户进行统一的密码安全性检验，快速发现安全风险。

```sql
-- 创建批量检查任务表
CREATE TABLE batch_password_check (
    check_id INT PRIMARY KEY AUTO_INCREMENT,
    check_name VARCHAR(100) NOT NULL,
    check_type ENUM('FULL_SCAN', 'INCREMENTAL', 'TARGETED') DEFAULT 'FULL_SCAN',
    target_users TEXT,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    total_users INT DEFAULT 0,
    compliant_users INT DEFAULT 0,
    violation_users INT DEFAULT 0,
    status ENUM('PENDING', 'RUNNING', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 批量检查执行过程
DELIMITER //
CREATE PROCEDURE ExecuteBatchPasswordCheck(IN check_name VARCHAR(100), IN check_type VARCHAR(20))
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_user VARCHAR(100);
    DECLARE v_host VARCHAR(100);
    DECLARE v_check_id INT;
    DECLARE v_total, v_compliant, v_violation INT DEFAULT 0;
    
    -- 游标声明
    DECLARE user_cursor CURSOR FOR 
        SELECT user, host FROM mysql.user WHERE user != '';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- 创建检查任务记录
    INSERT INTO batch_password_check (check_name, check_type, status, start_time)
    VALUES (check_name, check_type, 'RUNNING', NOW());
    SET v_check_id = LAST_INSERT_ID();
    
    OPEN user_cursor;
    
    check_loop: LOOP
        FETCH user_cursor INTO v_user, v_host;
        IF done THEN
            LEAVE check_loop;
        END IF;
        
        SET v_total = v_total + 1;
        
        -- 执行单个用户的密码检查
        CALL CheckSingleUserPassword(v_user, @result);
        
        IF @result = 'COMPLIANT' THEN
            SET v_compliant = v_compliant + 1;
        ELSE
            SET v_violation = v_violation + 1;
        END IF;
        
    END LOOP;
    
    CLOSE user_cursor;
    
    -- 更新检查结果
    UPDATE batch_password_check 
    SET 
        end_time = NOW(),
        total_users = v_total,
        compliant_users = v_compliant,
        violation_users = v_violation,
        status = 'COMPLETED'
    WHERE check_id = v_check_id;
    
END //
DELIMITER ;
```

### 6.2 批量检查结果分析


```sql
-- 批量检查历史记录
SELECT 
    check_name AS '检查名称',
    check_type AS '检查类型',
    total_users AS '总用户数',
    compliant_users AS '合规用户',
    violation_users AS '违规用户',
    ROUND(compliant_users * 100.0 / total_users, 2) AS '合规率%',
    TIMESTAMPDIFF(MINUTE, start_time, end_time) AS '耗时(分钟)',
    DATE(created_at) AS '检查日期'
FROM batch_password_check 
WHERE status = 'COMPLETED'
ORDER BY created_at DESC;

-- 合规率趋势分析
SELECT 
    DATE(created_at) AS '日期',
    AVG(compliant_users * 100.0 / total_users) AS '平均合规率',
    COUNT(*) AS '检查次数'
FROM batch_password_check 
WHERE status = 'COMPLETED' 
    AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY DATE(created_at);
```

---

## 7. 📡 密码合规监控


### 7.1 实时监控机制


密码合规监控是持续跟踪密码安全状态的自动化系统，及时发现和报告安全风险。

```sql
-- 创建监控告警配置表
CREATE TABLE monitoring_alert_config (
    alert_id INT PRIMARY KEY AUTO_INCREMENT,
    alert_name VARCHAR(100) NOT NULL,
    alert_type ENUM('PASSWORD_EXPIRY', 'WEAK_PASSWORD', 'COMPLIANCE_VIOLATION', 'BATCH_CHECK') NOT NULL,
    threshold_value INT,
    threshold_unit ENUM('DAYS', 'PERCENTAGE', 'COUNT') DEFAULT 'DAYS',
    alert_level ENUM('INFO', 'WARNING', 'CRITICAL') DEFAULT 'WARNING',
    notification_emails TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加监控规则
INSERT INTO monitoring_alert_config 
(alert_name, alert_type, threshold_value, threshold_unit, alert_level, notification_emails) 
VALUES
('密码即将过期提醒', 'PASSWORD_EXPIRY', 7, 'DAYS', 'WARNING', 'admin@company.com'),
('密码已过期告警', 'PASSWORD_EXPIRY', 0, 'DAYS', 'CRITICAL', 'admin@company.com,security@company.com'),
('弱密码检测告警', 'WEAK_PASSWORD', 5, 'PERCENTAGE', 'WARNING', 'security@company.com'),
('合规率下降告警', 'COMPLIANCE_VIOLATION', 80, 'PERCENTAGE', 'CRITICAL', 'admin@company.com');
```

### 7.2 监控触发器设置


```sql
-- 创建密码监控日志表
CREATE TABLE password_monitoring_log (
    log_id INT PRIMARY KEY AUTO_INCREMENT,
    event_type ENUM('PASSWORD_CHANGE', 'LOGIN_ATTEMPT', 'POLICY_VIOLATION', 'AUDIT_CHECK'),
    username VARCHAR(100),
    event_details JSON,
    risk_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved BOOLEAN DEFAULT FALSE
);

-- 监控检查存储过程
DELIMITER //
CREATE PROCEDURE MonitorPasswordCompliance()
BEGIN
    DECLARE v_expiry_count, v_weak_count, v_total_count INT DEFAULT 0;
    DECLARE v_compliance_rate DECIMAL(5,2);
    
    -- 统计即将过期的密码数量
    SELECT COUNT(*) INTO v_expiry_count
    FROM password_audit_log 
    WHERE days_since_change > 83 AND days_since_change <= 90;
    
    -- 统计弱密码数量
    SELECT COUNT(*) INTO v_weak_count
    FROM password_score_details 
    WHERE grade IN ('D', 'F') AND DATE(evaluated_at) = CURDATE();
    
    -- 计算合规率
    SELECT COUNT(*) INTO v_total_count FROM mysql.user WHERE user != '';
    
    SELECT (COUNT(*) * 100.0 / v_total_count) INTO v_compliance_rate
    FROM password_audit_log 
    WHERE compliance_status = 'COMPLIANT';
    
    -- 记录监控日志
    INSERT INTO password_monitoring_log (event_type, event_details, risk_level)
    VALUES 
    ('AUDIT_CHECK', 
     JSON_OBJECT(
         'expiry_count', v_expiry_count,
         'weak_count', v_weak_count,
         'compliance_rate', v_compliance_rate,
         'total_users', v_total_count
     ),
     CASE 
         WHEN v_compliance_rate < 70 THEN 'CRITICAL'
         WHEN v_compliance_rate < 85 THEN 'HIGH'
         WHEN v_expiry_count > 10 THEN 'MEDIUM'
         ELSE 'LOW'
     END
    );
    
END //
DELIMITER ;

-- 创建定时监控事件
CREATE EVENT daily_password_monitoring
ON SCHEDULE EVERY 1 DAY
STARTS TIMESTAMP(CURDATE() + INTERVAL 1 DAY, '02:00:00')
DO
    CALL MonitorPasswordCompliance();
```

---

## 8. 🎯 密码安全态势感知


### 8.1 安全态势数据收集


密码安全态势感知是通过收集和分析密码相关的安全数据，全面了解系统的密码安全状况。

```sql
-- 创建安全态势数据表
CREATE TABLE security_posture_data (
    data_id INT PRIMARY KEY AUTO_INCREMENT,
    collection_date DATE NOT NULL,
    total_accounts INT,
    active_accounts INT,
    inactive_accounts INT,
    strong_passwords INT,
    medium_passwords INT,
    weak_passwords INT,
    expired_passwords INT,
    never_changed_passwords INT,
    recent_violations INT,
    compliance_score DECIMAL(5,2),
    risk_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 态势数据收集存储过程
DELIMITER //
CREATE PROCEDURE CollectSecurityPostureData()
BEGIN
    DECLARE v_total, v_active, v_inactive INT DEFAULT 0;
    DECLARE v_strong, v_medium, v_weak INT DEFAULT 0;
    DECLARE v_expired, v_never_changed, v_violations INT DEFAULT 0;
    DECLARE v_compliance_score DECIMAL(5,2);
    DECLARE v_risk_level VARCHAR(20);
    
    -- 账户统计
    SELECT COUNT(*) INTO v_total FROM mysql.user WHERE user != '';
    
    SELECT COUNT(*) INTO v_active 
    FROM mysql.user u
    WHERE u.user != '' 
        AND u.account_locked = 'N'
        AND u.password_expired = 'N';
    
    SET v_inactive = v_total - v_active;
    
    -- 密码强度统计
    SELECT 
        SUM(CASE WHEN grade IN ('A', 'B') THEN 1 ELSE 0 END),
        SUM(CASE WHEN grade = 'C' THEN 1 ELSE 0 END),
        SUM(CASE WHEN grade IN ('D', 'F') THEN 1 ELSE 0 END)
    INTO v_strong, v_medium, v_weak
    FROM password_score_details 
    WHERE DATE(evaluated_at) = CURDATE();
    
    -- 过期密码统计
    SELECT COUNT(*) INTO v_expired
    FROM password_audit_log 
    WHERE compliance_status = 'VIOLATION';
    
    -- 从未更改密码统计
    SELECT COUNT(*) INTO v_never_changed
    FROM mysql.user 
    WHERE password_last_changed IS NULL OR password_last_changed < DATE_SUB(NOW(), INTERVAL 1 YEAR);
    
    -- 近期违规统计
    SELECT COUNT(*) INTO v_violations
    FROM password_monitoring_log 
    WHERE event_type = 'POLICY_VIOLATION' 
        AND timestamp >= DATE_SUB(NOW(), INTERVAL 7 DAY);
    
    -- 计算合规分数
    SET v_compliance_score = (v_strong + v_medium * 0.7) * 100.0 / v_total;
    
    -- 确定风险级别
    IF v_compliance_score >= 90 AND v_violations < 5 THEN
        SET v_risk_level = 'LOW';
    ELSEIF v_compliance_score >= 75 AND v_violations < 15 THEN
        SET v_risk_level = 'MEDIUM';
    ELSEIF v_compliance_score >= 60 THEN
        SET v_risk_level = 'HIGH';
    ELSE
        SET v_risk_level = 'CRITICAL';
    END IF;
    
    -- 插入态势数据
    INSERT INTO security_posture_data 
    (collection_date, total_accounts, active_accounts, inactive_accounts,
     strong_passwords, medium_passwords, weak_passwords, expired_passwords,
     never_changed_passwords, recent_violations, compliance_score, risk_level)
    VALUES 
    (CURDATE(), v_total, v_active, v_inactive, v_strong, v_medium, v_weak,
     v_expired, v_never_changed, v_violations, v_compliance_score, v_risk_level);
     
END //
DELIMITER ;
```

### 8.2 态势感知可视化报告


```sql
-- 安全态势趋势分析
SELECT 
    collection_date AS '日期',
    compliance_score AS '合规分数',
    risk_level AS '风险级别',
    CONCAT(
        '✅ ', strong_passwords, ' 强密码 | ',
        '⚠️ ', medium_passwords, ' 中等密码 | ', 
        '❌ ', weak_passwords, ' 弱密码'
    ) AS '密码分布',
    recent_violations AS '近期违规'
FROM security_posture_data 
WHERE collection_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
ORDER BY collection_date DESC;

-- 风险热力图数据
SELECT 
    WEEK(collection_date) AS '周次',
    AVG(compliance_score) AS '平均合规分数',
    MAX(recent_violations) AS '最大违规数',
    CASE 
        WHEN AVG(compliance_score) >= 90 THEN '🟢'
        WHEN AVG(compliance_score) >= 75 THEN '🟡'
        WHEN AVG(compliance_score) >= 60 THEN '🟠'
        ELSE '🔴'
    END AS '风险色彩'
FROM security_posture_data 
WHERE collection_date >= DATE_SUB(CURDATE(), INTERVAL 12 WEEK)
GROUP BY WEEK(collection_date)
ORDER BY WEEK(collection_date);
```

---

## 9. 🛡️ 密码合规安全框架


### 9.1 完整安全框架架构


密码合规安全框架是一套完整的密码安全管理体系，包含策略制定、实施、监控、改进的全流程管理。

```
密码合规安全框架架构：

┌─────────────────────────────────────────────────────────┐
│                    管理层 (Management Layer)              │
├─────────────────────────────────────────────────────────┤
│  策略制定  │  合规监督  │  风险评估  │  决策支持  │  报告生成  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    控制层 (Control Layer)                 │  
├─────────────────────────────────────────────────────────┤
│  访问控制  │  密码策略  │  身份验证  │  权限管理  │  审计跟踪  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    执行层 (Implementation Layer)          │
├─────────────────────────────────────────────────────────┤
│  密码验证  │  强度检测  │  合规检查  │  自动化监控 │  报警通知  │
└─────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                   │
├─────────────────────────────────────────────────────────┤
│  用户账户  │  密码信息  │  审计日志  │  监控数据  │  配置参数  │
└─────────────────────────────────────────────────────────┘
```

### 9.2 框架实施配置


```sql
-- 创建安全框架配置主表
CREATE TABLE security_framework_config (
    config_id INT PRIMARY KEY AUTO_INCREMENT,
    framework_name VARCHAR(100) NOT NULL,
    version VARCHAR(20) DEFAULT '1.0',
    implementation_date DATE,
    policy_enforcement_level ENUM('ADVISORY', 'ENFORCED', 'STRICT') DEFAULT 'ENFORCED',
    auto_remediation BOOLEAN DEFAULT FALSE,
    compliance_threshold DECIMAL(5,2) DEFAULT 85.00,
    review_cycle_days INT DEFAULT 90,
    emergency_override BOOLEAN DEFAULT FALSE,
    framework_status ENUM('PLANNING', 'IMPLEMENTING', 'ACTIVE', 'MAINTENANCE') DEFAULT 'PLANNING',
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 框架组件配置表
CREATE TABLE framework_components (
    component_id INT PRIMARY KEY AUTO_INCREMENT,
    framework_config_id INT,
    component_name VARCHAR(100) NOT NULL,
    component_type ENUM('POLICY', 'CONTROL', 'MONITOR', 'AUDIT', 'REPORT') NOT NULL,
    priority_level ENUM('HIGH', 'MEDIUM', 'LOW') DEFAULT 'MEDIUM',
    implementation_status ENUM('PENDING', 'IN_PROGRESS', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
    configuration_params JSON,
    dependency_components TEXT,
    FOREIGN KEY (framework_config_id) REFERENCES security_framework_config(config_id)
);

-- 初始化标准安全框架
INSERT INTO security_framework_config 
(framework_name, implementation_date, policy_enforcement_level, compliance_threshold, created_by)
VALUES 
('企业级密码安全框架', CURDATE(), 'ENFORCED', 90.00, 'system_admin');

-- 添加框架核心组件
INSERT INTO framework_components 
(framework_config_id, component_name, component_type, priority_level, configuration_params)
VALUES 
(1, '密码策略引擎', 'POLICY', 'HIGH', 
 '{"min_length": 12, "complexity_required": true, "expiry_days": 90}'),
(1, '实时合规监控', 'MONITOR', 'HIGH',
 '{"check_interval": "daily", "alert_threshold": 85, "auto_report": true}'),
(1, '弱密码检测器', 'CONTROL', 'HIGH',
 '{"blacklist_enabled": true, "pattern_detection": true, "strength_scoring": true}'),
(1, '审计报告生成器', 'AUDIT', 'MEDIUM',
 '{"report_frequency": "weekly", "include_trends": true, "stakeholder_list": ["admin", "security"]}'),
(1, '自动化修复工具', 'CONTROL', 'MEDIUM',
 '{"auto_disable_weak": false, "force_password_reset": true, "notification_enabled": true}');
```

### 9.3 框架效果评估


```sql
-- 框架实施效果评估视图
CREATE VIEW framework_effectiveness_report AS
SELECT 
    f.framework_name,
    f.implementation_date,
    DATEDIFF(CURDATE(), f.implementation_date) AS '实施天数',
    AVG(spd.compliance_score) AS '平均合规分数',
    MIN(spd.compliance_score) AS '最低合规分数',
    MAX(spd.compliance_score) AS '最高合规分数',
    COUNT(CASE WHEN spd.risk_level = 'CRITICAL' THEN 1 END) AS '严重风险天数',
    COUNT(CASE WHEN spd.risk_level = 'LOW' THEN 1 END) AS '低风险天数',
    (COUNT(CASE WHEN spd.risk_level = 'LOW' THEN 1 END) * 100.0 / COUNT(*)) AS '低风险率%'
FROM security_framework_config f
LEFT JOIN security_posture_data spd ON spd.collection_date >= f.implementation_date
WHERE f.framework_status = 'ACTIVE'
GROUP BY f.config_id, f.framework_name, f.implementation_date;

-- 组件实施进度报告
SELECT 
    fc.component_name AS '组件名称',
    fc.component_type AS '组件类型', 
    fc.priority_level AS '优先级',
    fc.implementation_status AS '实施状态',
    CASE fc.implementation_status
        WHEN 'COMPLETED' THEN '✅'
        WHEN 'IN_PROGRESS' THEN '🔄'
        WHEN 'PENDING' THEN '⏳'
        WHEN 'FAILED' THEN '❌'
    END AS '状态标识'
FROM framework_components fc
JOIN security_framework_config sfc ON fc.framework_config_id = sfc.config_id
WHERE sfc.framework_status = 'ACTIVE'
ORDER BY 
    FIELD(fc.priority_level, 'HIGH', 'MEDIUM', 'LOW'),
    fc.component_type;
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 密码合规性验证：确保所有用户密码符合企业安全标准的检查过程
🔸 企业密码标准：根据业务需求制定的统一密码安全规范
🔸 密码审计报告：定期生成的密码安全状态分析文档
🔸 弱密码检测：识别和发现不安全密码的自动化检查机制
🔸 密码安全评分：量化密码安全强度的综合评估方法
🔸 批量密码检查：对系统所有用户进行统一的安全检验
🔸 合规监控：持续跟踪密码安全状态的自动化系统
🔸 安全态势感知：通过数据分析全面了解密码安全现状
🔸 安全框架：完整的密码安全管理体系和实施方案
```

### 10.2 关键理解要点


**🔹 密码合规的重要性**
```
安全防护：
- 防止弱密码导致的数据泄露
- 降低暴力破解攻击成功率
- 保护企业核心数据资产

合规要求：
- 满足行业监管标准
- 符合企业内控制度
- 通过安全审计检查
```

**🔹 检查机制的层次性**
```
基础检查：密码长度、复杂度、字符类型
高级检查：模式识别、熵值计算、历史重用
智能检查：机器学习、行为分析、风险评估
```

**🔹 监控的实时性和持续性**
```
实时监控：密码更改、登录异常、策略违规
定期检查：批量扫描、合规审计、风险评估
趋势分析：历史对比、安全态势、改进建议
```

### 10.3 实际应用价值


**🎯 业务场景应用**
- **金融机构**：严格的密码合规要求，定期审计检查
- **医疗系统**：患者隐私保护，密码安全监管
- **电商平台**：用户账户安全，防止批量撞库
- **政府机关**：信息安全等级保护，合规性要求

**🔧 运维实践指导**
- **策略制定**：根据业务特点制定适合的密码策略
- **工具部署**：选择合适的密码管理和检查工具
- **流程建立**：建立密码生命周期管理流程
- **持续改进**：基于监控数据不断优化安全策略

### 10.4 最佳实践建议


**🛠️ 实施建议**
```
分阶段实施：
1️⃣ 基础策略配置
2️⃣ 检查工具部署  
3️⃣ 监控系统建立
4️⃣ 报告分析优化

关键成功因素：
✅ 管理层支持和推动
✅ 用户培训和意识提升
✅ 技术工具的有效整合
✅ 持续的监控和改进
```

**⚠️ 常见问题和解决方案**
```
问题1：用户抱怨密码策略过于严格
解决：分级管理，核心系统严格，一般系统适中

问题2：监控告警过多造成疲劳
解决：优化告警阈值，分级处理不同风险级别

问题3：批量检查影响系统性能
解决：在业务低峰期执行，限制并发检查数量

问题4：历史密码验证困难
解决：建立密码历史库，使用哈希存储比对
```

**核心记忆要点**：
- 密码合规是数据安全的第一道防线，预防胜于补救
- 标准化、自动化、可视化是密码管理的三大支柱
- 持续监控和改进是保持密码安全的关键环节
- 技术手段和管理制度必须相结合才能发挥最大效果