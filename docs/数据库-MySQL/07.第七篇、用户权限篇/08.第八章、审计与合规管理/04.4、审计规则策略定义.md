---
title: 4、审计规则策略定义
---
## 📚 目录

1. [审计规则基础概念](#1-审计规则基础概念)
2. [审计规则语法详解](#2-审计规则语法详解)
3. [过滤条件设置](#3-过滤条件设置)
4. [用户级别审计策略](#4-用户级别审计策略)
5. [表级别审计策略](#5-表级别审计策略)
6. [操作类型过滤](#6-操作类型过滤)
7. [时间窗口限制](#7-时间窗口限制)
8. [规则优先级管理](#8-规则优先级管理)
9. [审计规则模板化](#9-审计规则模板化)
10. [规则冲突检测与安全管理](#10-规则冲突检测与安全管理)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🎯 审计规则基础概念


### 1.1 什么是审计规则


**审计规则**就像是数据库的"监控摄像头设置"，决定了要监控哪些操作、谁的操作、以及如何记录这些操作。

```
简单理解：
审计规则 = 告诉数据库"什么情况下要记录日志"

比如：
- 当管理员删除用户表时 → 记录
- 当普通用户查询工资表时 → 记录  
- 当系统用户做备份时 → 不记录
```

**🔸 核心作用**
- **安全防护**：发现异常操作和潜在威胁
- **合规要求**：满足法规对数据操作的审计要求
- **操作追踪**：记录重要数据的变更历史
- **性能分析**：了解数据库使用模式

### 1.2 审计规则的组成要素


```
┌─────────────────────────────────────┐
│            审计规则结构              │
├─────────────────────────────────────┤
│ 规则名称：标识规则用途               │
│ 触发条件：什么情况下记录             │
│ 过滤条件：排除不需要的操作           │
│ 记录内容：保存哪些信息               │
│ 优先级：多个规则的执行顺序           │
└─────────────────────────────────────┘
```

---

## 2. 📋 审计规则语法详解


### 2.1 基本语法结构


审计规则语法就像写一个"如果...那么..."的条件语句，告诉数据库在什么情况下要记录日志。

```sql
-- 基本语法模板
CREATE AUDIT RULE rule_name
ON audit_target
WHERE filter_conditions
LOG log_options
PRIORITY priority_value;
```

**🔸 语法要素说明**
- `rule_name`：规则名称，要有意义（如：sensitive_table_access）
- `audit_target`：审计目标，可以是用户、表、操作等
- `filter_conditions`：过滤条件，决定什么时候触发
- `log_options`：记录选项，决定记录哪些信息
- `priority_value`：优先级，数字越小优先级越高

### 2.2 实际语法示例


```sql
-- 示例1：监控敏感表的所有操作
CREATE AUDIT RULE sensitive_data_access
ON TABLE employee_salary, customer_info
WHERE operation_type IN ('SELECT', 'UPDATE', 'DELETE')
LOG (timestamp, user, operation, affected_rows)
PRIORITY 1;

-- 示例2：监控特定用户的写操作
CREATE AUDIT RULE admin_write_operations  
ON USER admin_user
WHERE operation_type IN ('INSERT', 'UPDATE', 'DELETE')
  AND table_name NOT LIKE 'log_%'
LOG (timestamp, user, sql_text, affected_rows)
PRIORITY 2;
```

---

## 3. 🔍 过滤条件设置


### 3.1 过滤条件的作用


**过滤条件**就像筛子，决定哪些操作需要记录，哪些可以忽略。设置好过滤条件能避免产生太多无用的审计日志。

```
为什么需要过滤？
📊 没有过滤：每天可能产生几GB的审计日志
🎯 合理过滤：只记录重要操作，日志量减少90%
```

### 3.2 常用过滤条件


| 过滤类型 | **条件示例** | **说明** | **适用场景** |
|---------|------------|---------|-------------|
| **用户过滤** | `user = 'admin'` | 只审计特定用户 | 监控管理员操作 |
| **操作过滤** | `operation IN ('DELETE', 'DROP')` | 只审计危险操作 | 防止数据误删 |
| **表过滤** | `table_name LIKE 'finance_%'` | 只审计敏感表 | 财务数据保护 |
| **时间过滤** | `time BETWEEN '09:00' AND '18:00'` | 只审计工作时间 | 发现异常访问 |
| **IP过滤** | `client_ip NOT LIKE '192.168.%'` | 排除内网访问 | 监控外部访问 |

### 3.3 过滤条件配置示例


```sql
-- 复合过滤条件：监控下班时间的敏感操作
CREATE AUDIT RULE after_hours_sensitive_access
ON TABLE customer_data, financial_records
WHERE (HOUR(NOW()) < 8 OR HOUR(NOW()) > 18)
  AND operation_type IN ('SELECT', 'UPDATE', 'DELETE')
  AND user NOT IN ('backup_user', 'monitor_user')
LOG (timestamp, user, client_ip, sql_text, table_name)
PRIORITY 1;

-- 排除系统操作的过滤
CREATE AUDIT RULE user_data_changes
ON ALL_TABLES
WHERE operation_type IN ('INSERT', 'UPDATE', 'DELETE')
  AND user NOT LIKE 'system_%'
  AND table_name NOT LIKE 'temp_%'
  AND table_name NOT LIKE 'log_%'
LOG (timestamp, user, operation, table_name, affected_rows)
PRIORITY 3;
```

---

## 4. 👤 用户级别审计策略


### 4.1 用户级别审计概念


**用户级别审计**就是根据不同用户的权限和角色，制定不同的监控策略。就像对不同级别的员工有不同的监管要求。

```
用户分级监控策略：
🔴 超级管理员：记录所有操作
🟡 普通管理员：记录写操作和敏感查询
🟢 普通用户：只记录异常操作
🔵 系统用户：基本不记录
```

### 4.2 用户分类审计配置


```sql
-- 超级管理员：全面审计
CREATE AUDIT RULE superadmin_full_audit
ON USER root, dba_admin  
WHERE 1=1  -- 记录所有操作
LOG (timestamp, user, client_ip, sql_text, execution_time)
PRIORITY 1;

-- 应用用户：只审计数据修改
CREATE AUDIT RULE app_user_data_changes
ON USER app_user_read, app_user_write
WHERE operation_type IN ('INSERT', 'UPDATE', 'DELETE')
LOG (timestamp, user, table_name, affected_rows)
PRIORITY 2;

-- 普通用户：只审计敏感表访问
CREATE AUDIT RULE regular_user_sensitive_access
ON USER guest%, temp%
WHERE table_name IN ('employee', 'salary', 'customer')
LOG (timestamp, user, table_name, operation_type)
PRIORITY 3;
```

### 4.3 基于角色的审计策略


```sql
-- 财务角色：监控非财务表访问
CREATE AUDIT RULE finance_role_cross_access
ON ROLE finance_role
WHERE table_name NOT LIKE 'finance_%' 
  AND table_name NOT LIKE 'accounting_%'
LOG (timestamp, user, role, table_name, operation_type)
PRIORITY 2;

-- 开发角色：监控生产数据访问  
CREATE AUDIT RULE dev_role_production_access
ON ROLE developer_role
WHERE database_name = 'production'
  OR table_name LIKE 'prod_%'
LOG (timestamp, user, role, sql_text, warning_level='HIGH')
PRIORITY 1;
```

---

## 5. 📊 表级别审计策略


### 5.1 表级别审计概念


**表级别审计**是根据表的重要性和敏感程度，设置不同的监控级别。就像对不同价值的物品采用不同的安保措施。

```
表重要性分级：
🔴 核心业务表：用户表、订单表、支付表
🟡 敏感数据表：员工信息、工资表、客户资料  
🟢 普通业务表：商品信息、分类表、配置表
🔵 系统表：日志表、临时表、缓存表
```

### 5.2 敏感表全面审计


```sql
-- 核心业务表：记录所有操作
CREATE AUDIT RULE core_business_tables_full
ON TABLE users, orders, payments, transactions
WHERE 1=1
LOG (timestamp, user, client_ip, operation_type, sql_text, 
     old_values, new_values, affected_rows)
PRIORITY 1;

-- 员工敏感信息：详细审计
CREATE AUDIT RULE employee_sensitive_data
ON TABLE employees, employee_salary, employee_personal
WHERE operation_type IN ('SELECT', 'UPDATE', 'DELETE')
LOG (timestamp, user, client_ip, operation_type, 
     table_name, where_clause, affected_rows)
PRIORITY 1;
```

### 5.3 表操作类型审计


```sql
-- 结构变更审计：监控DDL操作
CREATE AUDIT RULE table_structure_changes
ON ALL_TABLES
WHERE operation_type IN ('CREATE', 'ALTER', 'DROP', 'TRUNCATE')
LOG (timestamp, user, operation_type, table_name, 
     sql_text, warning_level='CRITICAL')
PRIORITY 1;

-- 批量数据操作审计
CREATE AUDIT RULE bulk_data_operations
ON TABLE customer_data, order_history
WHERE affected_rows > 1000
  OR operation_type = 'TRUNCATE'
LOG (timestamp, user, operation_type, table_name, 
     affected_rows, execution_time)
PRIORITY 2;
```

---

## 6. ⚙️ 操作类型过滤


### 6.1 操作类型分类


**操作类型过滤**就是根据SQL操作的危险程度，决定是否需要审计。

```
操作危险级别分类：
🔴 高危操作：DELETE, DROP, TRUNCATE, ALTER
🟡 中危操作：UPDATE, INSERT, CREATE
🟢 低危操作：SELECT（敏感表除外）
🔵 无需审计：SHOW, DESCRIBE等查询操作
```

### 6.2 危险操作专项审计


```sql
-- 数据删除操作：重点监控
CREATE AUDIT RULE dangerous_delete_operations
ON ALL_TABLES
WHERE operation_type IN ('DELETE', 'TRUNCATE')
  AND table_name NOT LIKE 'temp_%'
  AND table_name NOT LIKE 'log_%'
LOG (timestamp, user, client_ip, sql_text, 
     table_name, affected_rows, warning_level='HIGH')
PRIORITY 1;

-- 结构修改操作：全部记录
CREATE AUDIT RULE schema_modification_operations  
ON ALL_TABLES
WHERE operation_type IN ('DROP', 'ALTER', 'CREATE INDEX', 'DROP INDEX')
LOG (timestamp, user, client_ip, operation_type, 
     sql_text, object_name, warning_level='CRITICAL')
PRIORITY 1;
```

### 6.3 写操作审计配置


```sql
-- 数据修改操作：记录变更详情
CREATE AUDIT RULE data_modification_tracking
ON TABLE customer_info, product_info, order_details
WHERE operation_type IN ('INSERT', 'UPDATE') 
LOG (timestamp, user, operation_type, table_name,
     primary_key_values, old_values, new_values)
PRIORITY 2;

-- 批量写入操作：监控性能影响
CREATE AUDIT RULE bulk_write_operations
ON ALL_TABLES  
WHERE operation_type IN ('INSERT', 'UPDATE')
  AND (affected_rows > 100 OR execution_time > 5)
LOG (timestamp, user, operation_type, table_name,
     affected_rows, execution_time, performance_impact='HIGH')
PRIORITY 2;
```

---

## 7. ⏰ 时间窗口限制


### 7.1 时间窗口概念


**时间窗口限制**就是设定特定时间段的审计规则，比如只在上班时间审计，或者重点监控下班后的操作。

```
时间窗口应用场景：
🌅 上班时间：重点监控异常操作
🌙 下班时间：监控所有访问（可能是入侵）
📅 周末假期：高度敏感，记录一切
🚨 维护窗口：排除正常维护操作
```

### 7.2 工作时间外审计


```sql
-- 非工作时间访问：高度可疑
CREATE AUDIT RULE after_hours_access
ON ALL_TABLES
WHERE (HOUR(NOW()) < 8 OR HOUR(NOW()) > 18)
  OR DAYOFWEEK(NOW()) IN (1, 7)  -- 周末
LOG (timestamp, user, client_ip, operation_type,
     table_name, sql_text, warning_level='SUSPICIOUS')
PRIORITY 1;

-- 深夜操作：特别关注
CREATE AUDIT RULE midnight_operations
ON ALL_TABLES  
WHERE HOUR(NOW()) BETWEEN 23 AND 5
  AND user NOT IN ('backup_user', 'maintenance_user')
LOG (timestamp, user, client_ip, operation_type,
     sql_text, alert_level='IMMEDIATE')
PRIORITY 1;
```

### 7.3 特殊时间段配置


```sql
-- 月末年末：财务数据敏感期
CREATE AUDIT RULE month_end_sensitive_period
ON TABLE financial_data, accounting_records
WHERE (DAY(NOW()) >= 28 OR DAY(NOW()) <= 3)  -- 月末月初
  OR (MONTH(NOW()) = 12 AND DAY(NOW()) >= 20) -- 年末
LOG (timestamp, user, operation_type, table_name,
     old_values, new_values, business_period='SENSITIVE')
PRIORITY 1;

-- 维护窗口：排除正常维护
CREATE AUDIT RULE exclude_maintenance_window
ON ALL_TABLES
WHERE NOT (
  DAYOFWEEK(NOW()) = 1 AND  -- 周日
  HOUR(NOW()) BETWEEN 2 AND 4 AND  -- 凌晨2-4点
  user IN ('dba_maintenance', 'backup_system')
)
LOG (timestamp, user, operation_type, table_name)
PRIORITY 3;
```

---

## 8. 🏆 规则优先级管理


### 8.1 优先级概念


**规则优先级**决定了当多个审计规则都匹配同一个操作时，按什么顺序执行。数字越小，优先级越高。

```
优先级设计原则：
优先级 1：安全威胁检测（立即处理）
优先级 2：合规要求审计（重要但不紧急）
优先级 3：一般操作记录（常规监控）
优先级 4：性能分析日志（可选记录）
```

### 8.2 优先级配置示例


```sql
-- 优先级1：安全威胁（最高优先级）
CREATE AUDIT RULE security_threat_detection
ON ALL_TABLES
WHERE (
  operation_type IN ('DROP', 'TRUNCATE') OR
  sql_text LIKE '%DELETE%WHERE%1=1%' OR
  affected_rows > 10000
)
LOG (timestamp, user, client_ip, sql_text, threat_level='HIGH')
PRIORITY 1;

-- 优先级2：合规审计（重要）
CREATE AUDIT RULE compliance_audit
ON TABLE customer_personal_data, financial_records
WHERE operation_type IN ('SELECT', 'UPDATE', 'DELETE')
LOG (timestamp, user, operation_type, table_name, compliance_type='GDPR')
PRIORITY 2;

-- 优先级3：常规监控（一般）
CREATE AUDIT RULE general_monitoring
ON ALL_TABLES
WHERE operation_type IN ('INSERT', 'UPDATE', 'DELETE')
LOG (timestamp, user, operation_type, table_name, affected_rows)
PRIORITY 3;
```

### 8.3 规则冲突处理


```sql
-- 当多个规则匹配时的处理策略
CREATE AUDIT RULE conflict_resolution_example
ON TABLE sensitive_table
WHERE 1=1
LOG (timestamp, user, operation_type,
     rule_priority, matched_rules_count)
PRIORITY 2
WITH CONFLICT_STRATEGY = 'MERGE_LOGS';  -- 合并日志

-- 规则互斥配置
CREATE AUDIT RULE exclusive_admin_audit
ON USER admin%
WHERE operation_type = 'SELECT'
LOG (timestamp, user, table_name)
PRIORITY 1
WITH EXCLUSIVE = TRUE;  -- 排斥其他SELECT规则
```

---

## 9. 📝 审计规则模板化


### 9.1 模板化的好处


**规则模板化**就是把常用的审计规则做成模板，需要时直接套用，避免重复编写相似的规则。

```
模板化优势：
✅ 提高效率：不用重复写相似规则
✅ 减少错误：模板经过验证，更可靠
✅ 标准统一：确保审计规则的一致性
✅ 便于维护：修改模板影响所有使用者
```

### 9.2 常用审计模板


```sql
-- 模板1：敏感表访问模板
CREATE AUDIT TEMPLATE sensitive_table_access_template
PARAMETERS (
  @table_list VARCHAR(500),
  @user_exclude_pattern VARCHAR(100) DEFAULT 'system_%',
  @priority_level INT DEFAULT 2
)
AS
CREATE AUDIT RULE {template_name}_{random_suffix}
ON TABLE {@table_list}
WHERE operation_type IN ('SELECT', 'UPDATE', 'DELETE')
  AND user NOT LIKE '{@user_exclude_pattern}'
LOG (timestamp, user, client_ip, operation_type, table_name, affected_rows)
PRIORITY {@priority_level};

-- 使用模板创建规则
APPLY AUDIT TEMPLATE sensitive_table_access_template (
  template_name = 'finance_tables_audit',
  table_list = 'salary, bonus, financial_data',
  user_exclude_pattern = 'finance_system_%',
  priority_level = 1
);
```

### 9.3 模板管理功能


```sql
-- 查看可用模板
SHOW AUDIT TEMPLATES;

-- 查看模板详情
DESCRIBE AUDIT TEMPLATE sensitive_table_access_template;

-- 修改模板
ALTER AUDIT TEMPLATE sensitive_table_access_template
SET LOG_OPTIONS = (timestamp, user, client_ip, operation_type, 
                   table_name, affected_rows, data_classification);

-- 删除不再使用的模板
DROP AUDIT TEMPLATE outdated_template_name;
```

---

## 10. 🛡️ 规则冲突检测与安全管理


### 10.1 规则冲突检测


**规则冲突**是指多个审计规则对同一操作有不同的处理要求，可能导致审计日志混乱或性能问题。

```
常见冲突类型：
🔴 记录冲突：同一操作被多个规则重复记录
🟡 优先级冲突：不同规则有相同优先级
🟢 排除冲突：一个规则包含，另一个规则排除
🔵 性能冲突：规则过多导致性能下降
```

### 10.2 冲突检测机制


```sql
-- 检测规则冲突
SELECT 
    r1.rule_name AS rule1,
    r2.rule_name AS rule2,
    'Priority Conflict' AS conflict_type
FROM audit_rules r1
JOIN audit_rules r2 ON r1.priority = r2.priority 
WHERE r1.rule_name != r2.rule_name
  AND r1.target_overlap = r2.target_overlap;

-- 检测重复记录风险
SELECT 
    table_name,
    COUNT(*) AS rule_count,
    GROUP_CONCAT(rule_name) AS conflicting_rules
FROM audit_rules 
WHERE status = 'ACTIVE'
GROUP BY table_name
HAVING COUNT(*) > 2;
```

### 10.3 安全设计原则


```sql
-- 安全规则设计：防止规则被滥用
CREATE AUDIT RULE rule_security_check
ON AUDIT_RULES_TABLE
WHERE operation_type IN ('CREATE', 'ALTER', 'DROP')
  AND rule_content LIKE '%password%'
LOG (timestamp, user, sql_text, security_alert='RULE_MANIPULATION')
PRIORITY 1;

-- 规则权限控制
GRANT AUDIT_RULE_CREATE ON database.* TO 'audit_admin'@'%';
GRANT AUDIT_RULE_VIEW ON database.* TO 'security_officer'@'%';
REVOKE AUDIT_RULE_DELETE ON database.* FROM 'regular_dba'@'%';
```

### 10.4 规则安全验证


```sql
-- 规则安全性检查清单
CREATE VIEW audit_rule_security_check AS
SELECT 
    rule_name,
    CASE 
        WHEN sql_text LIKE '%password%' THEN 'SENSITIVE_CONTENT'
        WHEN priority = 0 THEN 'INVALID_PRIORITY'  
        WHEN log_options LIKE '%*%' THEN 'OVERLY_BROAD_LOGGING'
        ELSE 'SAFE'
    END AS security_status,
    created_by,
    created_date
FROM audit_rules
WHERE status = 'ACTIVE';

-- 定期安全检查
SELECT * FROM audit_rule_security_check 
WHERE security_status != 'SAFE';
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


```
🔸 审计规则语法：CREATE AUDIT RULE的基本结构和参数
🔸 过滤条件设置：WHERE子句的灵活运用，避免过度审计
🔸 用户级别审计：根据用户权限制定不同监控策略
🔸 表级别审计：根据表重要性设置不同审计级别
🔸 操作类型过滤：重点监控危险操作，适度记录常规操作
🔸 时间窗口限制：结合业务时间特点设置审计策略
🔸 规则优先级：合理设置优先级避免冲突和性能问题
🔸 模板化管理：提高规则编写效率和标准化程度
```

### 11.2 关键理解要点


**🔹 审计规则设计原则**
```
精准性：只记录需要的操作，避免日志爆炸
安全性：防止审计规则被恶意利用
性能性：平衡安全需求和系统性能
合规性：满足法规要求的同时保持实用性
```

**🔹 过滤条件的艺术**
```
过松：重要操作可能漏记录
过严：产生大量无用日志
恰当：既能发现问题又不影响性能
```

**🔹 优先级设计思路**
```
1级：安全威胁（立即处理）
2级：合规要求（重要记录）  
3级：常规监控（一般记录）
4级：性能分析（可选记录）
```

### 11.3 实际应用价值


- **安全防护**：通过规则策略及时发现异常操作和潜在威胁
- **合规管理**：满足GDPR、SOX等法规的审计要求
- **运维监控**：了解数据库使用模式，优化性能配置
- **事故追踪**：提供详细的操作历史，便于问题定位

**🎯 最佳实践建议**
- 从核心业务表开始，逐步扩展审计范围
- 定期回顾审计日志，调整规则策略
- 建立规则变更流程，避免随意修改
- 监控审计系统本身的性能影响

**核心记忆口诀**：
- 审计规则定策略，过滤条件要精准
- 用户表级分重点，操作时间设窗口  
- 优先级别避冲突，模板安全保管理
- 核心业务严监控，合规安全两不误