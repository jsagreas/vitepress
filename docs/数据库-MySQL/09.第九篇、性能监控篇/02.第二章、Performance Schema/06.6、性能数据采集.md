---
title: 6ã€æ€§èƒ½æ•°æ®é‡‡é›†
---
## ğŸ“š ç›®å½•

1. [Performance SchemaåŸºç¡€æ¦‚å¿µ](#1-performance-schemaåŸºç¡€æ¦‚å¿µ)
2. [äº‹ä»¶é‡‡é›†æœºåˆ¶è¯¦è§£](#2-äº‹ä»¶é‡‡é›†æœºåˆ¶è¯¦è§£)
3. [æ•°æ®é‡‡é›†ç­–ç•¥é…ç½®](#3-æ•°æ®é‡‡é›†ç­–ç•¥é…ç½®)
4. [é‡‡é›†é¢‘ç‡ä¸æ€§èƒ½æ§åˆ¶](#4-é‡‡é›†é¢‘ç‡ä¸æ€§èƒ½æ§åˆ¶)
5. [æ•°æ®èšåˆä¸åˆ†æè§„åˆ™](#5-æ•°æ®èšåˆä¸åˆ†æè§„åˆ™)
6. [é‡‡é›†æ€§èƒ½ä¼˜åŒ–å®è·µ](#6-é‡‡é›†æ€§èƒ½ä¼˜åŒ–å®è·µ)
7. [æ•°æ®è´¨é‡æ§åˆ¶](#7-æ•°æ®è´¨é‡æ§åˆ¶)
8. [ç›‘æ§å‘Šè­¦ä¸æ•°æ®æ ¡éªŒ](#8-ç›‘æ§å‘Šè­¦ä¸æ•°æ®æ ¡éªŒ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Performance SchemaåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Performance Schema


**Performance Schema**æ˜¯MySQLå†…ç½®çš„æ€§èƒ½ç›‘æ§å’Œè¯Šæ–­å·¥å…·ï¼Œä¸“é—¨ç”¨æ¥æ”¶é›†å’Œåˆ†ææ•°æ®åº“è¿è¡Œæ—¶çš„å„ç§æ€§èƒ½æ•°æ®ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒç»™MySQLè£…äº†ä¸€ä¸ª"ä½“æ£€ä»ªå™¨"ï¼Œå®æ—¶ç›‘æµ‹æ•°æ®åº“çš„å¥åº·çŠ¶å†µå’Œæ€§èƒ½è¡¨ç°

```
Performance Schemaå·¥ä½œç¤ºæ„å›¾ï¼š

MySQLæœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åºSQLè¯·æ±‚                    â”‚
â”‚  â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ç›‘æ§æ•°æ®          â”‚
â”‚  â”‚   SQLæ‰§è¡Œ   â”‚ --------â†’ PSè¡¨      â”‚
â”‚  â”‚   å¼•æ“æ“ä½œ  â”‚ --------â†’ å†…å­˜å­˜å‚¨   â”‚
â”‚  â”‚   IOæ“ä½œ    â”‚ --------â†’ å®æ—¶æ›´æ–°   â”‚
â”‚  â”‚   é”ç­‰å¾…    â”‚ --------â†’ æ€§èƒ½åˆ†æ   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Performance Schemaçš„æ ¸å¿ƒç‰¹ç‚¹


**ğŸ”¸ å†…å­˜å­˜å‚¨å¼•æ“**
```sql
-- æŸ¥çœ‹Performance Schemaä½¿ç”¨çš„å­˜å‚¨å¼•æ“
SHOW CREATE TABLE performance_schema.events_statements_current;
-- ç»“æœæ˜¾ç¤ºï¼šENGINE=PERFORMANCE_SCHEMA
```

**ç‰¹ç‚¹è¯´æ˜**ï¼š
- **çº¯å†…å­˜å­˜å‚¨**ï¼šæ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åæ•°æ®æ¸…ç©º
- **å®æ—¶é‡‡é›†**ï¼šMySQLè¿è¡Œæ—¶æŒç»­æ”¶é›†æ€§èƒ½æ•°æ®
- **é›¶é…ç½®å¯åŠ¨**ï¼šMySQL 5.6+é»˜è®¤å¼€å¯ï¼Œæ— éœ€é¢å¤–é…ç½®

**ğŸ”¸ äº‹ä»¶é©±åŠ¨æœºåˆ¶**
```
äº‹ä»¶ç±»å‹åˆ†ç±»ï¼š
â”œâ”€ è¯­å¥äº‹ä»¶ï¼šSQLè¯­å¥æ‰§è¡Œæƒ…å†µ
â”œâ”€ ç­‰å¾…äº‹ä»¶ï¼šé”ç­‰å¾…ã€IOç­‰å¾…ç­‰
â”œâ”€ é˜¶æ®µäº‹ä»¶ï¼šSQLæ‰§è¡Œçš„å„ä¸ªé˜¶æ®µ
â”œâ”€ äº‹åŠ¡äº‹ä»¶ï¼šäº‹åŠ¡çš„å¼€å§‹ã€æäº¤ã€å›æ»š
â””â”€ è¿æ¥äº‹ä»¶ï¼šå®¢æˆ·ç«¯è¿æ¥å’Œæ–­å¼€
```

### 1.3 Performance Schema vs å…¶ä»–ç›‘æ§å·¥å…·


| ç›‘æ§å·¥å…· | **æ•°æ®æ¥æº** | **æ€§èƒ½å¼€é”€** | **å®æ—¶æ€§** | **è¯¦ç»†ç¨‹åº¦** |
|---------|-------------|-------------|-----------|-------------|
| **Performance Schema** | `MySQLå†…æ ¸` | `2-5%` | `å®æ—¶` | `æè¯¦ç»†` |
| **æ…¢æŸ¥è¯¢æ—¥å¿—** | `æ–‡ä»¶è®°å½•` | `1-3%` | `å»¶è¿Ÿ` | `ä¸­ç­‰` |
| **General Log** | `æ–‡ä»¶è®°å½•` | `5-15%` | `å»¶è¿Ÿ` | `åŸºç¡€` |
| **å¤–éƒ¨ç›‘æ§å·¥å…·** | `æŸ¥è¯¢è·å–` | `å˜åŒ–å¤§` | `å®šæ—¶` | `å®šåˆ¶åŒ–` |

---

## 2. âš™ï¸ äº‹ä»¶é‡‡é›†æœºåˆ¶è¯¦è§£


### 2.1 äº‹ä»¶é‡‡é›†çš„åŸºæœ¬åŸç†


Performance Schemaé‡‡ç”¨**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**æ¥é‡‡é›†å’Œå­˜å‚¨æ€§èƒ½æ•°æ®ï¼š

```
äº‹ä»¶é‡‡é›†æµç¨‹ï¼š
ç”Ÿäº§è€…(MySQLå†…æ ¸) â†’ äº‹ä»¶ç¼“å†²åŒº â†’ æ¶ˆè´¹è€…(PSè¡¨) â†’ ç”¨æˆ·æŸ¥è¯¢

è¯¦ç»†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLæ‰§è¡Œ    â”‚â”€â”€â”€â†’â”‚  äº‹ä»¶ç”Ÿæˆ    â”‚â”€â”€â”€â†’â”‚  æ•°æ®å­˜å‚¨   â”‚
â”‚  IOæ“ä½œ     â”‚    â”‚  (å†…æ ¸å±‚é¢)  â”‚    â”‚  (PSè¡¨)    â”‚
â”‚  é”æ“ä½œ     â”‚    â”‚              â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ”— **å…³è”çŸ¥è¯†**ï¼šè¿™ç§è®¾è®¡ç±»ä¼¼äºæ“ä½œç³»ç»Ÿçš„ä¸­æ–­æœºåˆ¶ï¼Œç¡®ä¿å¯¹æ­£å¸¸ä¸šåŠ¡å½±å“æœ€å°

### 2.2 äº‹ä»¶é‡‡é›†çš„é…ç½®ç®¡ç†


**ğŸ”¸ æŸ¥çœ‹é‡‡é›†å™¨çŠ¶æ€**
```sql
-- æŸ¥çœ‹æ‰€æœ‰é‡‡é›†å™¨çŠ¶æ€
SELECT name, enabled, timed 
FROM performance_schema.setup_instruments 
WHERE name LIKE 'statement/%' 
LIMIT 5;

-- æŸ¥çœ‹æ¶ˆè´¹è€…çŠ¶æ€  
SELECT name, enabled 
FROM performance_schema.setup_consumers;
```

**ğŸ”¸ åŠ¨æ€è°ƒæ•´é‡‡é›†é…ç½®**
```sql
-- å¯ç”¨SQLè¯­å¥é‡‡é›†
UPDATE performance_schema.setup_consumers 
SET enabled = 'YES' 
WHERE name = 'events_statements_current';

-- å¯ç”¨ç­‰å¾…äº‹ä»¶é‡‡é›†
UPDATE performance_schema.setup_instruments 
SET enabled = 'YES', timed = 'YES' 
WHERE name LIKE 'wait/io/file/%';
```

> âš ï¸ **æ³¨æ„**ï¼šåŠ¨æ€ä¿®æ”¹é…ç½®ç«‹å³ç”Ÿæ•ˆï¼Œä½†é‡å¯MySQLåä¼šæ¢å¤ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®

### 2.3 äº‹ä»¶é‡‡é›†çš„å±‚æ¬¡ç»“æ„


```
é‡‡é›†å±‚æ¬¡å›¾ï¼š
åº”ç”¨å±‚SQL
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯­å¥äº‹ä»¶ (events_statements_*)  â”‚ â† å®Œæ•´SQLè¯­å¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜¶æ®µäº‹ä»¶ (events_stages_*)      â”‚ â† SQLæ‰§è¡Œé˜¶æ®µ  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç­‰å¾…äº‹ä»¶ (events_waits_*)       â”‚ â† åº•å±‚ç­‰å¾…æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…ç¤ºä¾‹**ï¼š
```sql
-- ä¸€æ¡SELECTè¯­å¥ä¼šäº§ç”Ÿï¼š
-- 1ä¸ªè¯­å¥äº‹ä»¶ï¼šè®°å½•æ•´ä¸ªSQLæ‰§è¡Œæƒ…å†µ
-- å¤šä¸ªé˜¶æ®µäº‹ä»¶ï¼šè§£æã€ä¼˜åŒ–ã€æ‰§è¡Œç­‰é˜¶æ®µ
-- è‹¥å¹²ç­‰å¾…äº‹ä»¶ï¼šæ–‡ä»¶IOã€é”ç­‰å¾…ç­‰æ“ä½œ
```

---

## 3. ğŸ“Š æ•°æ®é‡‡é›†ç­–ç•¥é…ç½®


### 3.1 é‡‡é›†ç­–ç•¥çš„åŸºæœ¬æ¦‚å¿µ


**é‡‡é›†ç­–ç•¥**å†³å®šäº†Performance Schemaæ”¶é›†å“ªäº›æ•°æ®ã€å¦‚ä½•å­˜å‚¨ã€ä½•æ—¶æ¸…ç†ç­‰å…³é”®é—®é¢˜ã€‚

> ğŸ’¡ **ç­–ç•¥æ ¸å¿ƒ**ï¼šåœ¨æ€§èƒ½ç›‘æ§çš„å®Œæ•´æ€§å’Œç³»ç»Ÿæ€§èƒ½å¼€é”€ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹

### 3.2 é‡‡é›†èŒƒå›´é…ç½®


**ğŸ”¸ æŒ‰å¯¹è±¡ç±»å‹é…ç½®**
```sql
-- é’ˆå¯¹ç‰¹å®šæ•°æ®åº“å¯ç”¨ç›‘æ§
UPDATE performance_schema.setup_objects 
SET enabled = 'YES' 
WHERE object_schema = 'business_db';

-- æ’é™¤ç³»ç»Ÿåº“çš„ç›‘æ§
UPDATE performance_schema.setup_objects 
SET enabled = 'NO' 
WHERE object_schema IN ('mysql', 'information_schema');
```

**ğŸ”¸ æŒ‰ç”¨æˆ·é…ç½®ç›‘æ§**
```sql
-- æŸ¥çœ‹ç”¨æˆ·ç›‘æ§é…ç½®
SELECT user, host, enabled 
FROM performance_schema.setup_actors;

-- åªç›‘æ§ç‰¹å®šç”¨æˆ·
DELETE FROM performance_schema.setup_actors;
INSERT INTO performance_schema.setup_actors 
VALUES ('app_user', '%', 'YES', 'YES');
```

### 3.3 å­˜å‚¨ç­–ç•¥é…ç½®


**ğŸ”¸ å†å²æ•°æ®ä¿ç•™ç­–ç•¥**
```sql
-- æŸ¥çœ‹å†å²äº‹ä»¶è¡¨å¤§å°é…ç½®
SELECT variable_name, variable_value 
FROM performance_schema.global_variables 
WHERE variable_name LIKE '%history_size%';

-- å¸¸è§é…ç½®é¡¹ï¼š
-- events_statements_history_size: å•çº¿ç¨‹è¯­å¥å†å²æ•°é‡
-- events_statements_history_long_size: å…¨å±€è¯­å¥å†å²æ•°é‡
```

**å­˜å‚¨å±‚æ¬¡è¯´æ˜**ï¼š
```
PSæ•°æ®å­˜å‚¨å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ currentè¡¨       â”‚ â† å½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹ä»¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ historyè¡¨       â”‚ â† æ¯ä¸ªçº¿ç¨‹æœ€è¿‘Nä¸ªäº‹ä»¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ history_longè¡¨  â”‚ â† å…¨å±€æœ€è¿‘Nä¸ªäº‹ä»¶  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ summaryè¡¨       â”‚ â† èšåˆç»Ÿè®¡æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 é‡‡é›†ç²¾åº¦æ§åˆ¶


**ğŸ”¸ æ—¶é—´ç²¾åº¦é…ç½®**
```sql
-- æ£€æŸ¥å®šæ—¶å™¨ç²¾åº¦
SELECT timer_name, timer_frequency, timer_resolution 
FROM performance_schema.performance_timers;

-- è®¾ç½®è¯­å¥å®šæ—¶å™¨
UPDATE performance_schema.setup_instruments 
SET timed = 'YES' 
WHERE name = 'statement/sql/select';
```

**å®šæ—¶å™¨é€‰æ‹©åŸåˆ™**ï¼š
- **CYCLE**ï¼šæœ€é«˜ç²¾åº¦ï¼Œé€‚åˆè¯¦ç»†åˆ†æ
- **NANOSECOND**ï¼šçº³ç§’çº§ï¼Œå¸¸ç”¨é€‰æ‹©
- **MICROSECOND**ï¼šå¾®ç§’çº§ï¼Œæ€§èƒ½å‡è¡¡

---

## 4. â±ï¸ é‡‡é›†é¢‘ç‡ä¸æ€§èƒ½æ§åˆ¶


### 4.1 é‡‡é›†é¢‘ç‡çš„å½±å“å› ç´ 


é‡‡é›†é¢‘ç‡ç›´æ¥å½±å“ç³»ç»Ÿæ€§èƒ½å¼€é”€å’Œç›‘æ§æ•°æ®çš„ç²¾åº¦ï¼š

```
é¢‘ç‡-æ€§èƒ½å…³ç³»å›¾ï¼š
é«˜é¢‘é‡‡é›† â”€â”€â”€â”€â†’ è¯¦ç»†æ•°æ® + é«˜æ€§èƒ½å¼€é”€
    â†•               â†•
ä½é¢‘é‡‡é›† â”€â”€â”€â”€â†’ ç²—ç•¥æ•°æ® + ä½æ€§èƒ½å¼€é”€
```

### 4.2 æ€§èƒ½å¼€é”€æ§åˆ¶ç­–ç•¥


**ğŸ”¸ åˆ†çº§ç›‘æ§ç­–ç•¥**
```sql
-- ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼šåªå¯ç”¨å…³é”®ç›‘æ§
UPDATE performance_schema.setup_consumers SET enabled = 'NO';
UPDATE performance_schema.setup_consumers SET enabled = 'YES' 
WHERE name IN (
    'events_statements_current',
    'events_statements_history',
    'statements_digest'
);

-- å¼€å‘ç¯å¢ƒï¼šå¯ç”¨è¯¦ç»†ç›‘æ§
UPDATE performance_schema.setup_consumers SET enabled = 'YES';
```

**ğŸ”¸ åŠ¨æ€é‡‡é›†æ§åˆ¶**
```sql
-- åœ¨é«˜å³°æœŸä¸´æ—¶å…³é—­è¯¦ç»†ç›‘æ§
SET @peak_time = (HOUR(NOW()) BETWEEN 9 AND 18);
UPDATE performance_schema.setup_instruments 
SET enabled = IF(@peak_time, 'NO', 'YES') 
WHERE name LIKE 'wait/io%';
```

### 4.3 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**ğŸ”¸ ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ**
```sql
-- æŸ¥çœ‹PSå†…å­˜ä½¿ç”¨
SELECT event_name, current_alloc, high_alloc 
FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE 'memory/performance_schema/%' 
ORDER BY current_alloc DESC 
LIMIT 10;
```

**ğŸ”¸ å†…å­˜é…ç½®ä¼˜åŒ–**
```ini
# my.cnfä¸­çš„PSå†…å­˜é…ç½®
[mysqld]
performance_schema_max_table_instances = 500
performance_schema_max_sql_text_length = 1024
performance_schema_events_statements_history_size = 10
performance_schema_events_statements_history_long_size = 1000
```

> ğŸ“Š **æ€§èƒ½å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒPSå¼€é”€é€šå¸¸æ§åˆ¶åœ¨2-5%ä»¥å†…æ¯”è¾ƒåˆç†

---

## 5. ğŸ“ˆ æ•°æ®èšåˆä¸åˆ†æè§„åˆ™


### 5.1 èšåˆè§„åˆ™çš„åŸºæœ¬æ¦‚å¿µ


Performance Schemaä¼šè‡ªåŠ¨å¯¹æ”¶é›†çš„åŸå§‹äº‹ä»¶æ•°æ®è¿›è¡Œ**å¤šç»´åº¦èšåˆ**ï¼Œç”Ÿæˆä¾¿äºåˆ†æçš„ç»Ÿè®¡ä¿¡æ¯ã€‚

> ğŸ’¡ **èšåˆç›®çš„**ï¼šå°†æµ·é‡çš„åŸå§‹äº‹ä»¶æ•°æ®è½¬æ¢ä¸ºæœ‰æ„ä¹‰çš„ç»Ÿè®¡æŒ‡æ ‡ï¼Œä¾¿äºæ€§èƒ½åˆ†æ

### 5.2 èšåˆç»´åº¦åˆ†ç±»


**ğŸ”¸ æŒ‰SQLè¯­å¥èšåˆ**
```sql
-- æŸ¥çœ‹SQLè¯­å¥ç»Ÿè®¡ï¼ˆæŒ‰SQLæ¨¡å¼èšåˆï¼‰
SELECT schema_name, digest_text, count_star, avg_timer_wait/1000000 as avg_ms
FROM performance_schema.events_statements_summary_by_digest 
ORDER BY count_star DESC 
LIMIT 5;
```

**ğŸ”¸ æŒ‰ç”¨æˆ·ç»´åº¦èšåˆ**
```sql
-- æŸ¥çœ‹ç”¨æˆ·çº§åˆ«ç»Ÿè®¡
SELECT user, count_star, sum_timer_wait/1000000 as total_ms
FROM performance_schema.events_statements_summary_by_user_by_event_name 
WHERE event_name = 'statement/sql/select'
ORDER BY sum_timer_wait DESC;
```

**ğŸ”¸ æŒ‰å¯¹è±¡ç»´åº¦èšåˆ**
```sql
-- æŸ¥çœ‹è¡¨çº§åˆ«è®¿é—®ç»Ÿè®¡
SELECT object_schema, object_name, count_read, count_write
FROM performance_schema.table_io_waits_summary_by_table 
WHERE object_schema = 'business_db'
ORDER BY count_read + count_write DESC;
```

### 5.3 èšåˆæŒ‡æ ‡è¯´æ˜


```
æ ¸å¿ƒèšåˆæŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COUNT_STAR      â”‚ â† æ€»æ‰§è¡Œæ¬¡æ•°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SUM_TIMER_WAIT  â”‚ â† æ€»æ‰§è¡Œæ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ MIN_TIMER_WAIT  â”‚ â† æœ€å°æ‰§è¡Œæ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AVG_TIMER_WAIT  â”‚ â† å¹³å‡æ‰§è¡Œæ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MAX_TIMER_WAIT  â”‚ â† æœ€å¤§æ‰§è¡Œæ—¶é—´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ—¶é—´å•ä½è½¬æ¢**ï¼š
- Performance Schemaå†…éƒ¨ä½¿ç”¨**çš®ç§’**å­˜å‚¨
- è½¬æ¢ä¸ºæ¯«ç§’ï¼š`timer_wait / 1000000000000`
- è½¬æ¢ä¸ºå¾®ç§’ï¼š`timer_wait / 1000000000`

---

## 6. ğŸš€ é‡‡é›†æ€§èƒ½ä¼˜åŒ–å®è·µ


### 6.1 ä¼˜åŒ–ç­–ç•¥æ¦‚è¿°


æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯**ç²¾å‡†é‡‡é›†**ï¼šåªæ”¶é›†çœŸæ­£éœ€è¦çš„æ•°æ®ï¼Œé¿å…ä¸å¿…è¦çš„å¼€é”€ã€‚

### 6.2 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®


**ğŸ”¸ æœ€å°åŒ–ç›‘æ§é…ç½®**
```sql
-- 1. å…³é—­ä¸å¿…è¦çš„æ¶ˆè´¹è€…
UPDATE performance_schema.setup_consumers SET enabled = 'NO' 
WHERE name IN (
    'events_waits_current',
    'events_waits_history', 
    'events_waits_history_long'
);

-- 2. åªä¿ç•™æ ¸å¿ƒè¯­å¥ç›‘æ§
UPDATE performance_schema.setup_consumers SET enabled = 'YES' 
WHERE name IN (
    'events_statements_current',
    'statements_digest'
);

-- 3. å…³é—­ä½ä»·å€¼çš„é‡‡é›†å™¨
UPDATE performance_schema.setup_instruments SET enabled = 'NO' 
WHERE name LIKE 'wait/synch/%';
```

**ğŸ”¸ è‡ªåŠ¨æ¸…ç†æœºåˆ¶**
```sql
-- åˆ›å»ºå®šæœŸæ¸…ç†å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE ps_cleanup()
BEGIN
    -- æ¸…ç†digestç»Ÿè®¡ï¼ˆä¿ç•™æœ€è¿‘1000æ¡ï¼‰
    DELETE FROM performance_schema.events_statements_summary_by_digest 
    WHERE count_star < 10 
    AND last_seen < DATE_SUB(NOW(), INTERVAL 1 DAY)
    ORDER BY last_seen 
    LIMIT 1000;
END //
DELIMITER ;

-- è®¾ç½®å®šæ—¶æ¸…ç†ï¼ˆéœ€è¦äº‹ä»¶è°ƒåº¦å™¨ï¼‰
CREATE EVENT ps_daily_cleanup
ON SCHEDULE EVERY 1 DAY
DO CALL ps_cleanup();
```

### 6.3 ç›‘æ§é‡‡é›†æ€§èƒ½


**ğŸ”¸ ç›‘æ§PSè‡ªèº«å¼€é”€**
```sql
-- æŸ¥çœ‹PSç›¸å…³çš„æ€§èƒ½æŒ‡æ ‡
SELECT event_name, count_alloc, sum_number_of_bytes_alloc 
FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE 'memory/performance_schema/%';

-- æŸ¥çœ‹PSè¡¨çš„è®¿é—®é¢‘ç‡
SELECT object_name, count_read, count_write
FROM performance_schema.table_io_waits_summary_by_table 
WHERE object_schema = 'performance_schema'
ORDER BY count_read + count_write DESC;
```

---

## 7. ğŸ” æ•°æ®è´¨é‡æ§åˆ¶


### 7.1 æ•°æ®è´¨é‡çš„é‡è¦æ€§


ç¡®ä¿é‡‡é›†æ•°æ®çš„**å‡†ç¡®æ€§**å’Œ**å®Œæ•´æ€§**æ˜¯æ€§èƒ½åˆ†æçš„åŸºç¡€ã€‚

> âš ï¸ **è´¨é‡é£é™©**ï¼šä¸å‡†ç¡®çš„ç›‘æ§æ•°æ®å¯èƒ½å¯¼è‡´é”™è¯¯çš„æ€§èƒ½ä¼˜åŒ–å†³ç­–

### 7.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ”¸ æ£€æŸ¥é‡‡é›†é…ç½®ä¸€è‡´æ€§**
```sql
-- æ£€æŸ¥é‡‡é›†å™¨å’Œæ¶ˆè´¹è€…çš„åŒ¹é…åº¦
SELECT 
    i.name as instrument_name,
    i.enabled as instrument_enabled,
    c.name as consumer_name,
    c.enabled as consumer_enabled
FROM performance_schema.setup_instruments i
CROSS JOIN performance_schema.setup_consumers c
WHERE i.name LIKE 'statement/%' 
AND c.name LIKE 'events_statements_%'
AND (i.enabled != c.enabled);
```

**ğŸ”¸ æ•°æ®å®Œæ•´æ€§éªŒè¯**
```sql
-- éªŒè¯äº‹ä»¶æ•°æ®çš„æ—¶é—´æˆ³ä¸€è‡´æ€§
SELECT COUNT(*) as invalid_timestamps
FROM performance_schema.events_statements_history
WHERE timer_start > timer_end 
OR timer_start = 0 
OR timer_end = 0;
```

### 7.3 é‡‡é›†ç²¾åº¦éªŒè¯


**ğŸ”¸ æ—¶é—´ç²¾åº¦æµ‹è¯•**
```sql
-- æµ‹è¯•æ—¶é—´æµ‹é‡ç²¾åº¦
SELECT 
    timer_name,
    timer_frequency,
    timer_resolution,
    timer_overhead
FROM performance_schema.performance_timers;

-- å»ºè®®ï¼štimer_resolution < 1000 (çº³ç§’)
```

**ğŸ”¸ æ•°æ®æŠ½æ ·éªŒè¯**
```sql
-- æŠ½æ ·æ£€æŸ¥è¯­å¥ç»Ÿè®¡çš„å‡†ç¡®æ€§
SELECT 
    digest_text,
    count_star,
    sum_timer_wait/count_star as avg_time,
    min_timer_wait,
    max_timer_wait
FROM performance_schema.events_statements_summary_by_digest 
WHERE count_star > 100
AND (min_timer_wait > sum_timer_wait/count_star * 1.5 
     OR max_timer_wait < sum_timer_wait/count_star * 0.5);
```

---

## 8. ğŸš¨ ç›‘æ§å‘Šè­¦ä¸æ•°æ®æ ¡éªŒ


### 8.1 å…³é”®æŒ‡æ ‡ç›‘æ§


å»ºç«‹Performance Schemaè‡ªèº«çš„ç›‘æ§ä½“ç³»ï¼Œç¡®ä¿é‡‡é›†ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

**ğŸ”¸ é‡‡é›†çŠ¶æ€ç›‘æ§**
```sql
-- æ£€æŸ¥é‡‡é›†å™¨çŠ¶æ€
SELECT 
    CASE 
        WHEN COUNT(*) = SUM(CASE WHEN enabled='YES' THEN 1 ELSE 0 END) 
        THEN 'ALL_ENABLED'
        WHEN SUM(CASE WHEN enabled='YES' THEN 1 ELSE 0 END) = 0 
        THEN 'ALL_DISABLED'
        ELSE 'PARTIAL_ENABLED'
    END as status,
    COUNT(*) as total_instruments,
    SUM(CASE WHEN enabled='YES' THEN 1 ELSE 0 END) as enabled_count
FROM performance_schema.setup_instruments 
WHERE name LIKE 'statement/%';
```

**ğŸ”¸ æ€§èƒ½å¼€é”€ç›‘æ§**
```sql
-- ç›‘æ§PSå†…å­˜ä½¿ç”¨è¶‹åŠ¿
SELECT 
    event_name,
    current_alloc / 1024 / 1024 as current_mb,
    high_alloc / 1024 / 1024 as high_mb,
    (current_alloc / high_alloc * 100) as usage_percent
FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE 'memory/performance_schema/%'
AND high_alloc > 0;
```

### 8.2 å¼‚å¸¸å‘Šè­¦æœºåˆ¶


**ğŸ”¸ æ•°æ®å¼‚å¸¸æ£€æµ‹**
```sql
-- æ£€æµ‹å¼‚å¸¸çš„SQLæ‰§è¡Œæ—¶é—´
SELECT 
    digest_text,
    count_star,
    max_timer_wait / 1000000000 as max_seconds,
    avg_timer_wait / 1000000000 as avg_seconds
FROM performance_schema.events_statements_summary_by_digest 
WHERE max_timer_wait > avg_timer_wait * 10  -- æœ€å¤§æ—¶é—´è¶…è¿‡å¹³å‡æ—¶é—´10å€
AND count_star > 10
ORDER BY max_timer_wait DESC;
```

**ğŸ”¸ è‡ªåŠ¨å‘Šè­¦è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# PSå¥åº·æ£€æŸ¥è„šæœ¬

MYSQL_CMD="mysql -u monitor -p'password' -N -s"

# æ£€æŸ¥PSæ˜¯å¦å¯ç”¨
ps_enabled=$($MYSQL_CMD -e "SELECT $$performance_schema;")
if [ "$ps_enabled" != "1" ]; then
    echo "ALERT: Performance Schema is disabled!"
    exit 1
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
mem_usage=$($MYSQL_CMD -e "
SELECT ROUND(SUM(current_alloc)/1024/1024, 2) 
FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE 'memory/performance_schema/%';")

if (( $(echo "$mem_usage > 100" | bc -l) )); then
    echo "ALERT: PS memory usage too high: ${mem_usage}MB"
fi
```

### 8.3 æ•°æ®æ ¡éªŒæœ€ä½³å®è·µ


> ğŸ“Œ **æ ¡éªŒåŸåˆ™**ï¼š
> - **å®šæœŸæ£€æŸ¥**ï¼šæ¯æ—¥è‡ªåŠ¨æ ¡éªŒæ•°æ®å®Œæ•´æ€§
> - **é˜ˆå€¼å‘Šè­¦**ï¼šè®¾ç½®åˆç†çš„æ€§èƒ½å¼€é”€é˜ˆå€¼
> - **è¶‹åŠ¿åˆ†æ**ï¼šå…³æ³¨ç›‘æ§æ•°æ®çš„å˜åŒ–è¶‹åŠ¿
> - **æ•…éšœé¢„æ¡ˆ**ï¼šå‡†å¤‡PSå¼‚å¸¸æ—¶çš„åº”æ€¥æ–¹æ¡ˆ

**ğŸ”¸ ç»¼åˆå¥åº·æ£€æŸ¥**
```sql
-- PSç»¼åˆå¥åº·è¯„åˆ†
SELECT 
    'Performance Schema Health Check' as check_item,
    CASE 
        WHEN ps_status = 1 AND enabled_consumers > 0 AND memory_mb < 50 
        THEN 'HEALTHY'
        WHEN ps_status = 1 AND enabled_consumers > 0 
        THEN 'WARNING' 
        ELSE 'CRITICAL'
    END as health_status,
    CONCAT(
        'PS:', IF(ps_status=1, 'ON', 'OFF'), 
        ' Consumers:', enabled_consumers,
        ' Memory:', memory_mb, 'MB'
    ) as details
FROM (
    SELECT 
        $$performance_schema as ps_status,
        (SELECT COUNT(*) FROM performance_schema.setup_consumers WHERE enabled='YES') as enabled_consumers,
        (SELECT ROUND(SUM(current_alloc)/1024/1024, 1) 
         FROM performance_schema.memory_summary_global_by_event_name 
         WHERE event_name LIKE 'memory/performance_schema/%') as memory_mb
) as health_data;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Performance Schemaæœ¬è´¨ï¼šMySQLå†…ç½®çš„å®æ—¶æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
ğŸ”¸ äº‹ä»¶é‡‡é›†æœºåˆ¶ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œå†…æ ¸çº§æ•°æ®é‡‡é›†
ğŸ”¸ é‡‡é›†ç­–ç•¥é…ç½®ï¼šé€šè¿‡setup_*è¡¨çµæ´»æ§åˆ¶é‡‡é›†èŒƒå›´å’Œç²¾åº¦
ğŸ”¸ æ•°æ®èšåˆè§„åˆ™ï¼šå¤šç»´åº¦è‡ªåŠ¨èšåˆï¼Œç”Ÿæˆåˆ†æå‹å¥½çš„ç»Ÿè®¡æ•°æ®
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–åŸåˆ™ï¼šç²¾å‡†é‡‡é›†ï¼Œå¹³è¡¡ç›‘æ§å®Œæ•´æ€§å’Œç³»ç»Ÿå¼€é”€
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é‡‡é›†ç²¾åº¦vsæ€§èƒ½å¼€é”€çš„å¹³è¡¡**
```
ç”Ÿäº§ç¯å¢ƒæ¨èï¼š
- å¯ç”¨è¯­å¥çº§ç›‘æ§ï¼Œå…³é—­ç­‰å¾…äº‹ä»¶è¯¦ç»†ç›‘æ§
- æ§åˆ¶å†å²æ•°æ®ä¿ç•™é‡ï¼Œé¿å…å†…å­˜è¿‡åº¦æ¶ˆè€—
- å®šæœŸæ¸…ç†ç»Ÿè®¡æ•°æ®ï¼Œä¿æŒç³»ç»Ÿæ€§èƒ½

å¼€å‘ç¯å¢ƒå¯ä»¥ï¼š
- å¯ç”¨è¯¦ç»†çš„ç­‰å¾…äº‹ä»¶ç›‘æ§
- å¢å¤§å†å²æ•°æ®ä¿ç•™é‡
- å¼€å¯æ‰€æœ‰é‡‡é›†å™¨è¿›è¡Œæ·±åº¦åˆ†æ
```

**ğŸ”¹ æ•°æ®è´¨é‡ä¿è¯çš„é‡è¦æ€§**
```
è´¨é‡æ§åˆ¶è¦ç‚¹ï¼š
- ç¡®ä¿é‡‡é›†å™¨å’Œæ¶ˆè´¹è€…é…ç½®çš„ä¸€è‡´æ€§
- å®šæœŸéªŒè¯æ—¶é—´æˆ³å’Œç»Ÿè®¡æ•°æ®çš„å‡†ç¡®æ€§
- ç›‘æ§PSè‡ªèº«çš„æ€§èƒ½å¼€é”€å’Œå†…å­˜ä½¿ç”¨
- å»ºç«‹å¼‚å¸¸æ£€æµ‹å’Œè‡ªåŠ¨å‘Šè­¦æœºåˆ¶
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **æ€§èƒ½è¯Šæ–­**ï¼šé€šè¿‡äº‹ä»¶é‡‡é›†å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå†å²ç»Ÿè®¡æ•°æ®è¿›è¡Œèµ„æºè§„åˆ’
- **ä¼˜åŒ–éªŒè¯**ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½æ•°æ®å˜åŒ–
- **æ•…éšœæ’æŸ¥**ï¼šåˆ©ç”¨è¯¦ç»†çš„æ‰§è¡Œæ•°æ®è¿½è¸ªé—®é¢˜æ ¹å› 

**ğŸ”§ è¿ç»´å®è·µ**
- **ç›‘æ§ä½“ç³»**ï¼šä½œä¸ºæ•°æ®åº“ç›‘æ§ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®æº
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šç»“åˆè„šæœ¬å®ç°è‡ªåŠ¨åŒ–çš„æ€§èƒ½åˆ†æ
- **æŠ¥å‘Šç”Ÿæˆ**ï¼šå®šæœŸç”Ÿæˆæ€§èƒ½åˆ†ææŠ¥å‘Š
- **é¢„è­¦ç³»ç»Ÿ**ï¼šå»ºç«‹åŸºäºPSæ•°æ®çš„æ€§èƒ½é¢„è­¦æœºåˆ¶

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å†…å­˜é‡‡é›†å®æ—¶å‡†ï¼Œäº‹ä»¶é©±åŠ¨æ€§èƒ½è§‚
- ç­–ç•¥é…ç½®è¦ç²¾å‡†ï¼Œå¹³è¡¡å¼€é”€ä¸ç›‘æ§
- æ•°æ®èšåˆå¤šç»´åº¦ï¼Œè´¨é‡ä¿è¯æ˜¯å…³é”®
- ç”Ÿäº§ä¼˜åŒ–è¦è°¨æ…ï¼Œå¼€å‘ç¯å¢ƒå¯è¯¦ç»†

> ğŸ’¡ **æœ€ä½³å®è·µå»ºè®®**ï¼šPerformance Schemaæ˜¯MySQLæ€§èƒ½ä¼˜åŒ–çš„å¼ºå¤§å·¥å…·ï¼Œä½†éœ€è¦æ ¹æ®å®é™…ç¯å¢ƒåˆç†é…ç½®ï¼Œé¿å…è¿‡åº¦ç›‘æ§å½±å“ä¸šåŠ¡æ€§èƒ½ã€‚å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒç†Ÿæ‚‰å„ç§é…ç½®çš„å½±å“ï¼Œå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒã€‚