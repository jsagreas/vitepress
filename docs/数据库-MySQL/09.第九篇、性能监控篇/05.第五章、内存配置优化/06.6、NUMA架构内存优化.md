---
title: 6、NUMA架构内存优化
---
## 📚 目录

1. [NUMA架构基础概念](#1-NUMA架构基础概念)
2. [NUMA对MySQL的影响](#2-NUMA对MySQL的影响)
3. [MySQL NUMA优化配置](#3-MySQL-NUMA优化配置)
4. [内存节点绑定策略](#4-内存节点绑定策略)
5. [CPU亲和性设置](#5-CPU亲和性设置)
6. [NUMA性能监控](#6-NUMA性能监控)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🏗️ NUMA架构基础概念


### 1.1 什么是NUMA架构


**NUMA（Non-Uniform Memory Access）** 是现代多核服务器的主流架构，理解它就像理解一个大公司的组织结构。

```
传统UMA架构：                    NUMA架构：
所有CPU共享内存                  每个CPU节点有专属内存

    CPU1  CPU2                    CPU1 ←→ 内存1
      ↓     ↓                      ↓
    共享内存                       总线
                                   ↓  
                                  CPU2 ←→ 内存2
```

**🔸 核心概念解释**：
- **本地内存**：CPU直接连接的内存，访问速度最快
- **远程内存**：其他CPU节点的内存，需要通过总线访问，速度较慢
- **内存节点**：每个CPU及其关联内存组成一个节点
- **NUMA距离**：不同节点间的访问延迟差异

### 1.2 NUMA架构的特点


**优势与挑战**：
```
✅ 优势：
• 提高内存带宽：多个内存控制器并行工作
• 减少内存竞争：每个节点独立访问本地内存
• 支持大内存：可以扩展到TB级别内存

❌ 挑战：
• 跨节点访问慢：远程内存访问延迟高50-100%
• 内存分布不均：可能导致某些节点内存不足
• 缓存一致性：跨节点数据同步开销大
```

### 1.3 查看系统NUMA信息


**检查系统是否支持NUMA**：
```bash
# 查看NUMA节点信息
numactl --hardware

# 查看当前进程的NUMA策略
numactl --show

# 查看内存使用分布
numastat
```

**输出示例解读**：
```
available: 2 nodes (0-1)          # 2个NUMA节点
node 0 cpus: 0 1 2 3              # 节点0包含CPU 0-3
node 0 size: 32GB                 # 节点0内存大小
node 1 cpus: 4 5 6 7              # 节点1包含CPU 4-7
node 1 size: 32GB                 # 节点1内存大小
```

---

## 2. ⚡ NUMA对MySQL的影响


### 2.1 MySQL在NUMA环境下的挑战


MySQL作为内存密集型应用，在NUMA环境下会遇到特殊问题，就像一个工厂的工人需要频繁跨车间取工具。

**主要影响**：

```
性能问题：
┌─ MySQL进程 ─────────────────┐
│ 启动在节点0                 │
│ ↓                          │
│ 申请大量内存                │
│ ↓                          │
│ 节点0内存不足               │
│ ↓                          │
│ 系统分配节点1内存           │
│ ↓                          │
│ 跨节点访问，性能下降50%     │
└───────────────────────────┘
```

### 2.2 常见NUMA相关问题


**🔴 问题1：内存交换（Swap）频繁**
```
现象：系统有大量可用内存，但MySQL仍然使用swap
原因：MySQL在节点0运行，但节点0内存不足，系统选择swap而非跨节点分配
影响：性能急剧下降，查询响应时间增加10倍以上
```

**🔴 问题2：负载不均衡**
```
现象：某些CPU核心使用率很高，其他核心空闲
原因：MySQL线程集中在某个NUMA节点，未能充分利用所有资源
影响：硬件资源浪费，吞吐量受限
```

### 2.3 NUMA问题诊断


**快速诊断命令**：
```bash
# 查看MySQL进程的NUMA分布
ps -eo pid,psr,comm | grep mysqld

# 查看内存分配情况
cat /proc/$(pidof mysqld)/numa_maps | head -10

# 监控NUMA内存使用
watch -n 1 'numastat | grep -E "(Node|mysqld)"'
```

---

## 3. 🔧 MySQL NUMA优化配置


### 3.1 禁用NUMA自动平衡


Linux的NUMA自动平衡对数据库负面影响很大，就像让外行指挥专家工作。

**关闭自动平衡**：
```bash
# 临时关闭（重启后失效）
echo 0 > /proc/sys/kernel/numa_balancing

# 永久关闭（推荐）
echo 'kernel.numa_balancing = 0' >> /etc/sysctl.conf
sysctl -p
```

**验证配置**：
```bash
# 检查是否已关闭
cat /proc/sys/kernel/numa_balancing
# 输出0表示已关闭
```

### 3.2 MySQL启动时的NUMA配置


**方法1：使用numactl启动MySQL**
```bash
# 绑定到指定节点
numactl --cpunodebind=0 --membind=0 mysqld_safe &

# 交错分配内存（推荐）
numactl --interleave=all mysqld_safe &
```

**方法2：修改MySQL服务文件**
```bash
# 编辑systemd服务文件
vim /usr/lib/systemd/system/mysqld.service

# 在[Service]段添加
ExecStart=/usr/bin/numactl --interleave=all /usr/sbin/mysqld
```

### 3.3 MySQL配置文件优化


**my.cnf关键配置**：
```ini
[mysqld]
# 启用NUMA优化
innodb_numa_interleave = ON

# 合理设置缓冲池大小（不超过单节点内存的75%）
innodb_buffer_pool_size = 24G

# 设置缓冲池实例数（建议每8GB一个实例）
innodb_buffer_pool_instances = 3

# 绑定到特定CPU
# processor-bind = 0,1,2,3
```

---

## 4. 🎯 内存节点绑定策略


### 4.1 三种主要绑定策略


理解不同策略就像选择不同的工作分配方式：

```
策略对比：

1. 本地绑定 (localloc)
   CPU节点0 ←→ 内存节点0  ✓ 最快访问
   CPU节点1 ←→ 内存节点1  ✓ 最快访问
   优点：最佳性能
   缺点：内存利用率可能不均

2. 交错分配 (interleave)  ⭐推荐
   内存请求在所有节点间轮询分配
   优点：负载均衡，避免单节点内存不足
   缺点：部分访问是跨节点的

3. 优选策略 (preferred)
   优先使用指定节点，不足时使用其他节点
   优点：兼顾性能和可用性
   缺点：配置复杂
```

### 4.2 实际配置示例


**针对不同场景的配置**：

```bash
# 场景1：小型MySQL实例（内存<32GB）
# 绑定到单个节点，追求最佳性能
numactl --cpunodebind=0 --membind=0 mysqld_safe

# 场景2：大型MySQL实例（内存>64GB）
# 使用交错分配，避免单节点内存不足
numactl --interleave=all mysqld_safe

# 场景3：混合负载
# 优先使用节点0，不足时扩展到其他节点
numactl --preferred=0 mysqld_safe
```

### 4.3 动态调整策略


**运行时调整NUMA策略**：
```bash
# 获取MySQL进程PID
MYSQL_PID=$(pidof mysqld)

# 查看当前策略
cat /proc/$MYSQL_PID/numa_maps | head -5

# 动态修改策略（需要migratepages工具）
migratepages $MYSQL_PID from-nodes to-nodes
```

---

## 5. 🔄 CPU亲和性设置


### 5.1 CPU亲和性基本概念


CPU亲和性就像给每个员工分配固定的工位，避免频繁换位置的开销。

**基本原理**：
```
无亲和性设置：              有亲和性设置：
MySQL线程                   MySQL线程
    ↓                          ↓
在所有CPU间跳跃             绑定到特定CPU核心
    ↓                          ↓
缓存失效频繁                缓存利用率高
    ↓                          ↓
性能不稳定                  性能稳定提升
```

### 5.2 设置CPU亲和性


**使用taskset命令**：
```bash
# 查看MySQL进程当前CPU亲和性
taskset -cp $(pidof mysqld)

# 绑定到CPU 0-7
taskset -cp 0-7 $(pidof mysqld)

# 绑定到特定CPU核心（0,2,4,6）
taskset -cp 0,2,4,6 $(pidof mysqld)
```

**启动时设置**：
```bash
# 方法1：使用taskset启动
taskset -c 0-7 mysqld_safe &

# 方法2：结合numactl和taskset
numactl --interleave=all taskset -c 0-7 mysqld_safe &
```

### 5.3 MySQL线程级别的CPU绑定


**针对不同类型线程的优化**：
```bash
# 获取MySQL所有线程
ps -T -p $(pidof mysqld) | grep mysqld

# 为不同线程设置不同CPU亲和性
# 主线程：CPU 0-1
taskset -cp 0-1 <main_thread_pid>

# IO线程：CPU 2-3  
taskset -cp 2-3 <io_thread_pid>

# 工作线程：CPU 4-7
taskset -cp 4-7 <worker_thread_pid>
```

---

## 6. 📊 NUMA性能监控


### 6.1 关键监控指标


监控NUMA性能就像医生检查病人的各项生命体征：

**核心指标**：
```
内存相关：
• 本地内存命中率：>95%为良好
• 跨节点内存访问：<5%为理想
• 内存分布均匀度：各节点使用率相近

CPU相关：
• CPU利用率分布：各节点负载均衡
• 上下文切换频率：<1000/sec为正常
• 缓存命中率：L3缓存命中率>90%
```

### 6.2 监控工具和命令


**实时监控脚本**：
```bash
#!/bin/bash
# numa_monitor.sh - NUMA性能监控脚本

echo "=== NUMA节点内存使用情况 ==="
numastat -m

echo "=== MySQL进程NUMA分布 ==="
ps -eo pid,psr,pcpu,pmem,comm | grep mysql

echo "=== 跨节点内存访问统计 ==="
numastat -p $(pidof mysqld) | grep -E "(Local|Remote)"

echo "=== CPU使用率（按节点） ==="
mpstat -P ALL 1 1 | tail -n +4
```

### 6.3 性能分析和调优


**性能问题定位流程**：
```
步骤1：收集基础信息
├─ 硬件拓扑：lstopo
├─ 内存分布：numastat
└─ CPU分布：lscpu

步骤2：分析瓶颈点
├─ 内存访问模式：perf mem
├─ CPU缓存命中：perf stat
└─ 跨节点通信：sar -B

步骤3：制定优化策略
├─ 调整绑定策略
├─ 修改MySQL配置
└─ 验证效果
```

**常用性能分析命令**：
```bash
# 分析内存访问模式
perf mem record -p $(pidof mysqld)
perf mem report

# 监控缓存性能
perf stat -e cache-misses,cache-references -p $(pidof mysqld)

# 查看NUMA距离矩阵
numactl --hardware | grep distance
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 NUMA本质：现代服务器的内存架构，本地快远程慢
🔸 MySQL影响：内存密集型应用，NUMA配置不当严重影响性能
🔸 关键策略：禁用自动平衡，合理选择绑定策略
🔸 监控重点：内存命中率、跨节点访问、负载均衡
🔸 优化目标：提高本地内存访问比例，减少跨节点通信
```

### 7.2 实践配置检查清单


**✅ NUMA优化检查清单**：
- [ ] 禁用内核NUMA自动平衡
- [ ] 选择合适的内存绑定策略（推荐interleave）
- [ ] 设置合理的CPU亲和性
- [ ] 配置MySQL相关参数（innodb_numa_interleave等）
- [ ] 建立性能监控机制
- [ ] 定期检查内存分布情况

### 7.3 不同场景的最佳实践


**场景化配置建议**：

```
🔹 小型实例（<32GB内存）：
策略：单节点绑定
配置：numactl --cpunodebind=0 --membind=0
优点：最佳性能，配置简单

🔹 中型实例（32-128GB内存）：
策略：交错分配
配置：numactl --interleave=all
优点：负载均衡，避免内存不足

🔹 大型实例（>128GB内存）：
策略：混合策略，根据负载动态调整
配置：结合preferred和interleave
优点：最大化硬件利用率
```

### 7.4 常见问题和解决方案


**🔧 问题排查指南**：

```
问题：MySQL性能突然下降
排查：检查是否启用了NUMA自动平衡
解决：echo 0 > /proc/sys/kernel/numa_balancing

问题：内存充足但出现swap
排查：查看NUMA内存分布是否不均
解决：调整为interleave策略

问题：CPU使用率不均衡
排查：检查线程绑定情况
解决：重新设置CPU亲和性
```

### 7.5 性能提升预期


**优化效果参考**：
```
正确配置NUMA后的性能提升：
• 查询响应时间：提升20-50%
• 吞吐量：提升15-30%  
• 内存访问延迟：降低30-60%
• 系统稳定性：显著提升

注意：具体提升幅度取决于硬件配置和负载特征
```

**核心记忆要点**：
- NUMA优化是现代MySQL性能调优的必修课
- 禁用自动平衡是第一步，选对绑定策略是关键
- 监控内存命中率，追求本地访问最大化
- 不同规模实例需要不同的优化策略