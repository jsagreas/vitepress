---
title: 2ã€sysbenchå·¥å…·
---
## ğŸ“š ç›®å½•

1. [sysbenchåŸºç¡€æ¦‚å¿µ](#1-sysbenchåŸºç¡€æ¦‚å¿µ)
2. [sysbenchå®‰è£…é…ç½®](#2-sysbenchå®‰è£…é…ç½®)  
3. [OLTPæµ‹è¯•æ¨¡å¼è¯¦è§£](#3-OLTPæµ‹è¯•æ¨¡å¼è¯¦è§£)
4. [è¯»å†™æ··åˆæµ‹è¯•å®æˆ˜](#4-è¯»å†™æ··åˆæµ‹è¯•å®æˆ˜)
5. [CPUæ€§èƒ½æµ‹è¯•](#5-CPUæ€§èƒ½æµ‹è¯•)
6. [å†…å­˜æ€§èƒ½æµ‹è¯•](#6-å†…å­˜æ€§èƒ½æµ‹è¯•)
7. [ç£ç›˜IOæµ‹è¯•](#7-ç£ç›˜IOæµ‹è¯•)
8. [è‡ªå®šä¹‰Luaè„šæœ¬](#8-è‡ªå®šä¹‰Luaè„šæœ¬)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ sysbenchåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯sysbench


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> sysbenchæ˜¯ä¸€ä¸ªå¼€æºçš„å¤šçº¿ç¨‹æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œä¸“é—¨ç”¨æ¥æµ‹è¯•æ•°æ®åº“ã€CPUã€å†…å­˜ã€ç£ç›˜IOç­‰ç³»ç»Ÿæ€§èƒ½ã€‚

**é€šä¿—è§£é‡Š**ï¼š
```
å°±åƒç»™æ±½è½¦åšæ€§èƒ½æµ‹è¯•ä¸€æ ·ï¼š
ğŸš— æµ‹è¯•å¼•æ“æ€§èƒ½ â†’ sysbenchæµ‹è¯•CPU
ğŸš— æµ‹è¯•æ²¹è€—æ•ˆç‡ â†’ sysbenchæµ‹è¯•å†…å­˜
ğŸš— æµ‹è¯•åˆ¹è½¦è·ç¦» â†’ sysbenchæµ‹è¯•ç£ç›˜IO  
ğŸš— æµ‹è¯•ç»¼åˆè·¯å†µ â†’ sysbenchæµ‹è¯•æ•°æ®åº“OLTP
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **å¤šç»´åº¦æµ‹è¯•**ï¼šå¯ä»¥æµ‹è¯•ç³»ç»Ÿå„ä¸ªç»„ä»¶æ€§èƒ½
- **æ ‡å‡†åŒ–åŸºå‡†**ï¼šæä¾›ä¸šç•Œè®¤å¯çš„æµ‹è¯•æ ‡å‡†
- **é«˜å¹¶å‘æ¨¡æ‹Ÿ**ï¼šæ”¯æŒå¤šçº¿ç¨‹å‹åŠ›æµ‹è¯•
- **ç»“æœå¯å¯¹æ¯”**ï¼šç”Ÿæˆæ ‡å‡†åŒ–çš„æ€§èƒ½æŠ¥å‘Š

### 1.2 sysbenchçš„åº”ç”¨ä»·å€¼


**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼šæ–°æœåŠ¡å™¨ä¸Šçº¿å‰çš„æ€§èƒ½è¯„ä¼°
ğŸ”§ ç¡¬ä»¶é€‰å‹å¯¹æ¯”ï¼šä¸åŒé…ç½®æœåŠ¡å™¨çš„æ€§èƒ½å¯¹æ¯”  
ğŸ“ˆ ä¼˜åŒ–æ•ˆæœéªŒè¯ï¼šæ•°æ®åº“è°ƒä¼˜å‰åæ€§èƒ½å¯¹æ¯”
âš ï¸ å®¹é‡è§„åˆ’ï¼šé¢„ä¼°ç³»ç»Ÿèƒ½æ‰¿å—çš„æœ€å¤§è´Ÿè½½
ğŸ› æ€§èƒ½ç“¶é¢ˆå®šä½ï¼šæ‰¾å‡ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œ
```

---

## 2. âš™ï¸ sysbenchå®‰è£…é…ç½®


### 2.1 ç³»ç»Ÿç¯å¢ƒå‡†å¤‡


**æ”¯æŒçš„æ“ä½œç³»ç»Ÿ**ï¼š
- Linuxï¼ˆæ¨èCentOS/Ubuntuï¼‰
- macOS
- Windowsï¼ˆé€šè¿‡WSLï¼‰

**åŸºç¡€ä¾èµ–åŒ…**ï¼š
```bash
# CentOS/RHELç³»ç»Ÿ
sudo yum install -y gcc gcc-c++ make mysql-devel

# Ubuntu/Debianç³»ç»Ÿ  
sudo apt-get install -y gcc make libmysqlclient-dev
```

### 2.2 å®‰è£…æ–¹æ³•è¯¦è§£


**æ–¹æ³•ä¸€ï¼šåŒ…ç®¡ç†å™¨å®‰è£…ï¼ˆæ¨èæ–°æ‰‹ï¼‰**
```bash
# CentOS 8+
sudo dnf install sysbench

# Ubuntu 18.04+
sudo apt-get install sysbench

# éªŒè¯å®‰è£…
sysbench --version
```

**æ–¹æ³•äºŒï¼šæºç ç¼–è¯‘å®‰è£…**
```bash
# ä¸‹è½½æºç 
wget https://github.com/akopytov/sysbench/archive/1.0.20.tar.gz
tar -xzf 1.0.20.tar.gz
cd sysbench-1.0.20

# ç¼–è¯‘å®‰è£…
./autogen.sh
./configure --with-mysql
make && sudo make install
```

> **âš ï¸ å¸¸è§é—®é¢˜**  
> å¦‚æœç¼–è¯‘æ—¶æç¤ºæ‰¾ä¸åˆ°mysqlåº“ï¼Œéœ€è¦å…ˆå®‰è£…mysqlå¼€å‘åŒ…ï¼š`sudo yum install mysql-devel`

### 2.3 åŸºæœ¬é…ç½®éªŒè¯


**æµ‹è¯•å®‰è£…æ˜¯å¦æˆåŠŸ**ï¼š
```bash
# æŸ¥çœ‹å¯ç”¨æµ‹è¯•ç±»å‹
sysbench --help

# æŸ¥çœ‹MySQLæµ‹è¯•é€‰é¡¹
sysbench oltp_read_write --help
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
Available built-in tests:
  fileio - File I/O test
  cpu - CPU performance test  
  memory - Memory functions speed test
  threads - Threads subsystem performance test
  mutex - Mutex performance test
  oltp_* - Database OLTP tests
```

---

## 3. ğŸ—„ï¸ OLTPæµ‹è¯•æ¨¡å¼è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯OLTPæµ‹è¯•


**OLTPï¼ˆOnline Transaction Processingï¼‰** = åœ¨çº¿äº‹åŠ¡å¤„ç†æµ‹è¯•

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> OLTPæµ‹è¯•æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯ä¸‹çš„æ•°æ®åº“æ“ä½œï¼ŒåŒ…æ‹¬å¢åˆ æ”¹æŸ¥ç­‰æ··åˆæ“ä½œï¼Œæ˜¯æœ€æ¥è¿‘ç”Ÿäº§ç¯å¢ƒçš„æµ‹è¯•æ–¹å¼ã€‚

**æµ‹è¯•åœºæ™¯ç±»æ¯”**ï¼š
```
ç”µå•†ç½‘ç«™çš„ä¸€å¤©ï¼š
ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ â†’ INSERTæ“ä½œ
ğŸ›’ æµè§ˆå•†å“ â†’ SELECTæ“ä½œ  
ğŸ“ ä¿®æ”¹ä¿¡æ¯ â†’ UPDATEæ“ä½œ
ğŸ—‘ï¸ åˆ é™¤è®¢å• â†’ DELETEæ“ä½œ

OLTPæµ‹è¯•å°±æ˜¯æ¨¡æ‹Ÿè¿™ç§æ··åˆæ“ä½œåœºæ™¯ï¼
```

### 3.2 OLTPæµ‹è¯•ç±»å‹


**å†…ç½®æµ‹è¯•è„šæœ¬**ï¼š
```
oltp_read_write     â†’ è¯»å†™æ··åˆæµ‹è¯•ï¼ˆæœ€å¸¸ç”¨ï¼‰
oltp_read_only      â†’ åªè¯»æµ‹è¯•
oltp_write_only     â†’ åªå†™æµ‹è¯•  
oltp_point_select   â†’ ç‚¹æŸ¥è¯¢æµ‹è¯•
oltp_update_index   â†’ ç´¢å¼•æ›´æ–°æµ‹è¯•
oltp_update_non_index â†’ éç´¢å¼•æ›´æ–°æµ‹è¯•
oltp_insert         â†’ æ’å…¥æµ‹è¯•
oltp_delete         â†’ åˆ é™¤æµ‹è¯•
```

### 3.3 OLTPæµ‹è¯•æµç¨‹


**æ ‡å‡†æµ‹è¯•ä¸‰æ­¥éª¤**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æµ‹è¯•æ•°æ®
sysbench oltp_read_write prepare

ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæ€§èƒ½æµ‹è¯•  
sysbench oltp_read_write run

ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†æµ‹è¯•æ•°æ®
sysbench oltp_read_write cleanup
```

**å®Œæ•´æµ‹è¯•ç¤ºä¾‹**ï¼š
```bash
# ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ•°æ®ï¼ˆåˆ›å»º10å¼ è¡¨ï¼Œæ¯å¼ è¡¨10ä¸‡æ¡æ•°æ®ï¼‰
sysbench oltp_read_write \
  --mysql-host=localhost \
  --mysql-port=3306 \
  --mysql-user=root \
  --mysql-password=123456 \
  --mysql-db=testdb \
  --tables=10 \
  --table-size=100000 \
  prepare

# ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæµ‹è¯•ï¼ˆ16çº¿ç¨‹ï¼Œæµ‹è¯•60ç§’ï¼‰
sysbench oltp_read_write \
  --mysql-host=localhost \
  --mysql-port=3306 \
  --mysql-user=root \
  --mysql-password=123456 \
  --mysql-db=testdb \
  --tables=10 \
  --table-size=100000 \
  --threads=16 \
  --time=60 \
  run

# ç¬¬ä¸‰æ­¥ï¼šæ¸…ç†æ•°æ®
sysbench oltp_read_write \
  --mysql-host=localhost \
  --mysql-port=3306 \
  --mysql-user=root \
  --mysql-password=123456 \
  --mysql-db=testdb \
  --tables=10 \
  cleanup
```

---

## 4. ğŸ”„ è¯»å†™æ··åˆæµ‹è¯•å®æˆ˜


### 4.1 è¯»å†™æ··åˆæµ‹è¯•åŸç†


**ä»€ä¹ˆæ˜¯è¯»å†™æ··åˆ**ï¼š
çœŸå®ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ•°æ®åº“æ“ä½œé€šå¸¸æ˜¯è¯»æ“ä½œå’Œå†™æ“ä½œæ··åˆè¿›è¡Œçš„ï¼Œæ¯”å¦‚ï¼š
- 70%çš„SELECTæŸ¥è¯¢æ“ä½œ
- 20%çš„UPDATEæ›´æ–°æ“ä½œ  
- 10%çš„INSERT/DELETEæ“ä½œ

### 4.2 æµ‹è¯•å‚æ•°è¯¦è§£


**æ ¸å¿ƒå‚æ•°è¯´æ˜**ï¼š
```
è¿æ¥å‚æ•°ï¼š
--mysql-host=IPåœ°å€        # æ•°æ®åº“æœåŠ¡å™¨åœ°å€
--mysql-port=ç«¯å£å·        # æ•°æ®åº“ç«¯å£ï¼ˆé»˜è®¤3306ï¼‰
--mysql-user=ç”¨æˆ·å        # æ•°æ®åº“ç”¨æˆ·å
--mysql-password=å¯†ç       # æ•°æ®åº“å¯†ç   
--mysql-db=æ•°æ®åº“å        # æµ‹è¯•æ•°æ®åº“å

æµ‹è¯•æ•°æ®å‚æ•°ï¼š
--tables=è¡¨æ•°é‡           # åˆ›å»ºå¤šå°‘å¼ æµ‹è¯•è¡¨
--table-size=è¡¨å¤§å°       # æ¯å¼ è¡¨çš„è®°å½•æ•°

æµ‹è¯•è´Ÿè½½å‚æ•°ï¼š
--threads=çº¿ç¨‹æ•°          # å¹¶å‘çº¿ç¨‹æ•°
--time=æµ‹è¯•æ—¶é—´          # æµ‹è¯•æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
--events=äº‹ä»¶æ•°          # æ‰§è¡Œå¤šå°‘æ¬¡äº‹åŠ¡
--rate=é€Ÿç‡é™åˆ¶          # é™åˆ¶æ¯ç§’äº‹åŠ¡æ•°

ä¸šåŠ¡é€»è¾‘å‚æ•°ï¼š
--range_size=èŒƒå›´å¤§å°     # èŒƒå›´æŸ¥è¯¢çš„è®°å½•æ•°
--point_selects=ç‚¹æŸ¥æ•°    # æ¯äº‹åŠ¡çš„ç‚¹æŸ¥è¯¢æ¬¡æ•°
--simple_ranges=èŒƒå›´æŸ¥æ•°  # æ¯äº‹åŠ¡çš„èŒƒå›´æŸ¥è¯¢æ¬¡æ•°
--sum_ranges=èšåˆæŸ¥æ•°     # æ¯äº‹åŠ¡çš„èšåˆæŸ¥è¯¢æ¬¡æ•°
--order_ranges=æ’åºæŸ¥æ•°   # æ¯äº‹åŠ¡çš„æ’åºæŸ¥è¯¢æ¬¡æ•°
--distinct_ranges=å»é‡æŸ¥æ•° # æ¯äº‹åŠ¡çš„å»é‡æŸ¥è¯¢æ¬¡æ•°
--index_updates=ç´¢å¼•æ›´æ–°æ•° # æ¯äº‹åŠ¡çš„ç´¢å¼•æ›´æ–°æ¬¡æ•°
--non_index_updates=éç´¢å¼•æ›´æ–°æ•° # æ¯äº‹åŠ¡çš„éç´¢å¼•æ›´æ–°æ¬¡æ•°
```

### 4.3 å®é™…æµ‹è¯•æ¡ˆä¾‹


**åœºæ™¯ä¸€ï¼šåŸºç¡€æ€§èƒ½æµ‹è¯•**
```bash
# è½»é‡çº§æµ‹è¯•ï¼ˆé€‚åˆå¼€å‘ç¯å¢ƒï¼‰
sysbench oltp_read_write \
  --mysql-host=localhost \
  --mysql-user=test \
  --mysql-password=test123 \
  --mysql-db=sysbench_test \
  --tables=4 \
  --table-size=50000 \
  --threads=8 \
  --time=30 \
  --report-interval=5 \
  run
```

**åœºæ™¯äºŒï¼šç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿ**
```bash
# é«˜è´Ÿè½½æµ‹è¯•ï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒè¯„ä¼°ï¼‰  
sysbench oltp_read_write \
  --mysql-host=192.168.1.100 \
  --mysql-user=benchmark \
  --mysql-password=bench123 \
  --mysql-db=performance_test \
  --tables=20 \
  --table-size=1000000 \
  --threads=64 \
  --time=300 \
  --report-interval=10 \
  --rand-type=uniform \
  run
```

### 4.4 ç»“æœè§£è¯»


**æµ‹è¯•æŠ¥å‘Šç¤ºä¾‹**ï¼š
```
SQL statistics:
    queries performed:
        read:                    280000     # è¯»æ“ä½œæ€»æ•°
        write:                   80000      # å†™æ“ä½œæ€»æ•°  
        other:                   40000      # å…¶ä»–æ“ä½œæ•°
        total:                   400000     # æ€»æ“ä½œæ•°
    transactions:                20000  (333.33 per sec.)  # æ¯ç§’äº‹åŠ¡æ•°(TPS)
    queries:                     400000 (6666.67 per sec.) # æ¯ç§’æŸ¥è¯¢æ•°(QPS)
    ignored errors:              0      (0.00 per sec.)    # é”™è¯¯æ•°
    reconnects:                  0      (0.00 per sec.)    # é‡è¿æ¬¡æ•°

General statistics:
    total time:                  60.0000s   # æ€»æµ‹è¯•æ—¶é—´
    total number of events:      20000      # æ€»äº‹åŠ¡æ•°

Latency (ms):                              # å»¶è¿Ÿç»Ÿè®¡
         min:                    5.23       # æœ€å°å»¶è¿Ÿ  
         avg:                    48.12      # å¹³å‡å»¶è¿Ÿ
         max:                    156.28     # æœ€å¤§å»¶è¿Ÿ
         95th percentile:        89.16      # 95%è¯·æ±‚çš„å»¶è¿Ÿ
         sum:                    962400.00  # å»¶è¿Ÿæ€»å’Œ

Threads fairness:                          # çº¿ç¨‹å…¬å¹³æ€§
    events (avg/stddev):        1250.0000/23.45   # æ¯çº¿ç¨‹å¹³å‡äº‹åŠ¡æ•°
    execution time (avg/stddev): 60.1500/0.05     # æ¯çº¿ç¨‹å¹³å‡æ‰§è¡Œæ—¶é—´
```

**å…³é”®æŒ‡æ ‡è§£è¯»**ï¼š
```
ğŸ¯ TPS (Transactions Per Second)ï¼šæ¯ç§’äº‹åŠ¡æ•°
   â†’ è¡¡é‡æ•°æ®åº“æ•´ä½“å¤„ç†èƒ½åŠ›çš„æ ¸å¿ƒæŒ‡æ ‡

ğŸ“Š QPS (Queries Per Second)ï¼šæ¯ç§’æŸ¥è¯¢æ•°  
   â†’ è¡¡é‡æ•°æ®åº“æŸ¥è¯¢å¤„ç†èƒ½åŠ›

â±ï¸ 95th Percentile Latencyï¼š95%è¯·æ±‚å»¶è¿Ÿ
   â†’ è¡¡é‡ç”¨æˆ·ä½“éªŒçš„é‡è¦æŒ‡æ ‡

ğŸ”„ Read/Write Ratioï¼šè¯»å†™æ¯”ä¾‹
   â†’ äº†è§£ä¸šåŠ¡è´Ÿè½½ç‰¹å¾
```

---

## 5. ğŸ–¥ï¸ CPUæ€§èƒ½æµ‹è¯•


### 5.1 CPUæµ‹è¯•åŸç†


**æµ‹è¯•ç›®çš„**ï¼šéªŒè¯CPUçš„è®¡ç®—èƒ½åŠ›ï¼Œé€šè¿‡ç´ æ•°è®¡ç®—æ¥è¯„ä¼°CPUæ€§èƒ½ã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> CPUæµ‹è¯•é€šè¿‡è®©CPUæ‰§è¡Œå¯†é›†çš„æ•°å­¦è¿ç®—ï¼ˆç´ æ•°è®¡ç®—ï¼‰ï¼Œæ¥æµ‹è¯•CPUåœ¨é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½è¡¨ç°ã€‚

### 5.2 CPUæµ‹è¯•å®è·µ


**åŸºæœ¬CPUæµ‹è¯•**ï¼š
```bash
# å•çº¿ç¨‹CPUæµ‹è¯•
sysbench cpu --threads=1 --time=30 run

# å¤šçº¿ç¨‹CPUæµ‹è¯•ï¼ˆçº¿ç¨‹æ•°=CPUæ ¸å¿ƒæ•°ï¼‰
sysbench cpu --threads=8 --time=60 run

# æŒ‡å®šè®¡ç®—èŒƒå›´çš„CPUæµ‹è¯•
sysbench cpu --cpu-max-prime=50000 --threads=4 --time=30 run
```

**æµ‹è¯•å‚æ•°è¯´æ˜**ï¼š
```
--cpu-max-prime=æ•°å€¼    # è®¡ç®—ç´ æ•°çš„æœ€å¤§å€¼ï¼ˆé»˜è®¤10000ï¼‰
--threads=çº¿ç¨‹æ•°        # å¹¶å‘çº¿ç¨‹æ•°ï¼ˆå»ºè®®=CPUæ ¸å¿ƒæ•°ï¼‰
--time=æµ‹è¯•æ—¶é—´         # æµ‹è¯•æŒç»­æ—¶é—´
```

**ç»“æœç¤ºä¾‹**ï¼š
```
CPU speed:
    events per second:     2847.32    # æ¯ç§’å®Œæˆçš„è®¡ç®—äº‹ä»¶æ•°

General statistics:
    total time:                          30.0013s
    total number of events:              85430

Latency (ms):
         min:                                    0.35
         avg:                                    0.35  
         max:                                    2.81
         95th percentile:                        0.37
```

**æ€§èƒ½è¯„ä¼°æ ‡å‡†**ï¼š
```
ä¼˜ç§€ï¼š> 5000 events/sec
è‰¯å¥½ï¼š3000-5000 events/sec  
ä¸€èˆ¬ï¼š1000-3000 events/sec
è¾ƒå·®ï¼š< 1000 events/sec
```

---

## 6. ğŸ’¾ å†…å­˜æ€§èƒ½æµ‹è¯•


### 6.1 å†…å­˜æµ‹è¯•åŸç†


**æµ‹è¯•å†…å®¹**ï¼šæµ‹è¯•å†…å­˜çš„è¯»å†™é€Ÿåº¦å’Œå¸¦å®½æ€§èƒ½ã€‚

### 6.2 å†…å­˜æµ‹è¯•å®è·µ


**åŸºæœ¬å†…å­˜æµ‹è¯•**ï¼š
```bash
# å†…å­˜é¡ºåºè¯»å†™æµ‹è¯•
sysbench memory --memory-oper=read --threads=4 --time=30 run

# å†…å­˜éšæœºè¯»å†™æµ‹è¯•  
sysbench memory --memory-oper=write --memory-access-mode=rnd --threads=4 --time=30 run

# ç»¼åˆå†…å­˜æµ‹è¯•
sysbench memory \
  --memory-block-size=1M \
  --memory-total-size=10G \
  --memory-oper=read \
  --threads=8 \
  --time=60 \
  run
```

**æµ‹è¯•å‚æ•°è¯¦è§£**ï¼š
```
--memory-block-size=å¤§å°     # æ¯æ¬¡æ“ä½œçš„å†…å­˜å—å¤§å°ï¼ˆå¦‚1K,1Mï¼‰
--memory-total-size=å¤§å°     # æ€»æµ‹è¯•å†…å­˜å¤§å°ï¼ˆå¦‚1G,10Gï¼‰  
--memory-oper=æ“ä½œç±»å‹       # read/write/none
--memory-access-mode=æ¨¡å¼    # seq(é¡ºåº)/rnd(éšæœº)
--memory-scope=èŒƒå›´          # global/local
```

**ç»“æœè§£è¯»**ï¼š
```
Operations performed: 1048576 (34951.54 per sec.)   # æ¯ç§’æ“ä½œæ•°

1024.00 MiB transferred (34.13 MiB/sec)            # ä¼ è¾“å¸¦å®½

General statistics:
    total time:                          30.0001s
    total number of events:              1048576

Latency (ms):
         min:                                    0.10
         avg:                                    0.11
         max:                                    1.05
```

---

## 7. ğŸ’¿ ç£ç›˜IOæµ‹è¯•


### 7.1 ç£ç›˜IOæµ‹è¯•åŸç†


**æµ‹è¯•ç›®çš„**ï¼šè¯„ä¼°ç£ç›˜çš„è¯»å†™æ€§èƒ½ï¼ŒåŒ…æ‹¬é¡ºåºIOå’ŒéšæœºIOã€‚

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> ç£ç›˜IOæ€§èƒ½ç›´æ¥å½±å“æ•°æ®åº“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯æ•°æ®å†™å…¥å’Œå¤§è¡¨æ‰«æçš„é€Ÿåº¦ã€‚

### 7.2 ç£ç›˜IOæµ‹è¯•å®è·µ


**å‡†å¤‡æµ‹è¯•æ–‡ä»¶**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼ˆæ€»å¤§å°10Gï¼Œ128ä¸ªæ–‡ä»¶ï¼‰
sysbench fileio \
  --file-total-size=10G \
  --file-num=128 \
  --file-test-mode=rndrw \
  prepare
```

**æ‰§è¡ŒIOæµ‹è¯•**ï¼š
```bash
# éšæœºè¯»å†™æµ‹è¯•
sysbench fileio \
  --file-total-size=10G \
  --file-num=128 \
  --file-test-mode=rndrw \
  --file-io-mode=async \
  --file-async-backlog=128 \
  --threads=16 \
  --time=60 \
  run

# é¡ºåºå†™æµ‹è¯•
sysbench fileio \
  --file-total-size=5G \
  --file-num=64 \
  --file-test-mode=seqwr \
  --threads=8 \
  --time=30 \
  run

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
sysbench fileio \
  --file-total-size=10G \
  --file-num=128 \
  cleanup
```

**æµ‹è¯•æ¨¡å¼è¯´æ˜**ï¼š
```
seqwr    # é¡ºåºå†™
seqrd    # é¡ºåºè¯»  
seqrewr  # é¡ºåºè¯»å†™
rndrd    # éšæœºè¯»
rndwr    # éšæœºå†™
rndrw    # éšæœºè¯»å†™ï¼ˆæœ€å¸¸ç”¨ï¼‰
```

**å…³é”®å‚æ•°**ï¼š
```
--file-total-size=å¤§å°        # æµ‹è¯•æ–‡ä»¶æ€»å¤§å°
--file-num=æ–‡ä»¶æ•°            # æµ‹è¯•æ–‡ä»¶æ•°é‡
--file-block-size=å—å¤§å°     # IOå—å¤§å°ï¼ˆé»˜è®¤16Kï¼‰
--file-io-mode=æ¨¡å¼          # sync/async/mmap
--file-async-backlog=é˜Ÿåˆ—æ·±åº¦ # å¼‚æ­¥IOé˜Ÿåˆ—æ·±åº¦
```

**ç»“æœåˆ†æ**ï¼š
```
File operations:
    reads/s:                      1234.56    # æ¯ç§’è¯»æ“ä½œæ•°
    writes/s:                     823.45     # æ¯ç§’å†™æ“ä½œæ•°
    fsyncs/s:                     156.78     # æ¯ç§’åŒæ­¥æ“ä½œæ•°

Throughput:
    read, MiB/s:                  19.29      # è¯»ååé‡
    written, MiB/s:               12.87      # å†™ååé‡

General statistics:
    total time:                          60.0001s
    total number of events:              132086

Latency (ms):
         min:                                    0.00
         avg:                                    7.28
         max:                                   88.76
         95th percentile:                       21.89
```

---

## 8. ğŸ“œ è‡ªå®šä¹‰Luaè„šæœ¬


### 8.1 Luaè„šæœ¬åŸºç¡€


**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è„šæœ¬**ï¼š
- å†…ç½®æµ‹è¯•æ— æ³•æ»¡è¶³ç‰¹å®šä¸šåŠ¡åœºæ™¯
- éœ€è¦æ¨¡æ‹Ÿå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
- è‡ªå®šä¹‰ç‰¹æ®Šçš„æµ‹è¯•è´Ÿè½½

### 8.2 Luaè„šæœ¬ç»“æ„


**åŸºæœ¬è„šæœ¬æ¨¡æ¿**ï¼š
```lua
#!/usr/bin/env sysbench

-- è„šæœ¬åˆå§‹åŒ–å‡½æ•°
function thread_init()
    -- è¿æ¥æ•°æ®åº“ç­‰åˆå§‹åŒ–æ“ä½œ
end

-- å‡†å¤‡æµ‹è¯•æ•°æ®å‡½æ•°  
function prepare()
    -- åˆ›å»ºè¡¨ç»“æ„ï¼Œæ’å…¥æµ‹è¯•æ•°æ®
end

-- æµ‹è¯•äº‹ä»¶å‡½æ•°ï¼ˆæ ¸å¿ƒæµ‹è¯•é€»è¾‘ï¼‰
function event()
    -- æ‰§è¡Œå…·ä½“çš„æµ‹è¯•æ“ä½œ
    -- è¿™ä¸ªå‡½æ•°ä¼šè¢«åå¤è°ƒç”¨
end

-- æ¸…ç†å‡½æ•°
function cleanup()
    -- æ¸…ç†æµ‹è¯•æ•°æ®
end
```

### 8.3 å®ç”¨è„šæœ¬ç¤ºä¾‹


**ç¤ºä¾‹1ï¼šè‡ªå®šä¹‰æŸ¥è¯¢æµ‹è¯•**
```lua
#!/usr/bin/env sysbench

-- è‡ªå®šä¹‰æŸ¥è¯¢æµ‹è¯•è„šæœ¬
function prepare()
    -- åˆ›å»ºæµ‹è¯•è¡¨
    local query = [[
        CREATE TABLE IF NOT EXISTS user_orders (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            order_date DATE NOT NULL,
            amount DECIMAL(10,2),
            status TINYINT DEFAULT 1,
            INDEX idx_user_id (user_id),
            INDEX idx_date (order_date)
        )
    ]]
    db_query(query)
    
    -- æ’å…¥æµ‹è¯•æ•°æ®
    for i = 1, 100000 do
        local insert_query = string.format(
            "INSERT INTO user_orders (user_id, order_date, amount, status) VALUES (%d, '2024-01-01', %.2f, %d)",
            math.random(1, 10000),
            math.random(100, 50000) / 100,
            math.random(1, 3)
        )
        db_query(insert_query)
    end
end

function event()
    -- æ¨¡æ‹Ÿä¸šåŠ¡æŸ¥è¯¢ï¼šæŒ‰ç”¨æˆ·IDæŸ¥è¯¢è®¢å•
    local user_id = math.random(1, 10000)
    local query = string.format(
        "SELECT * FROM user_orders WHERE user_id = %d ORDER BY order_date DESC LIMIT 10",
        user_id
    )
    db_query(query)
    
    -- æ¨¡æ‹ŸèšåˆæŸ¥è¯¢ï¼šç»Ÿè®¡ç”¨æˆ·è®¢å•é‡‘é¢
    local agg_query = string.format(
        "SELECT COUNT(*), SUM(amount) FROM user_orders WHERE user_id = %d AND status = 1",
        user_id
    )
    db_query(agg_query)
end

function cleanup()
    db_query("DROP TABLE IF EXISTS user_orders")
end
```

**ç¤ºä¾‹2ï¼šè¯»å†™åˆ†ç¦»æµ‹è¯•**
```lua
#!/usr/bin/env sysbench

-- æ¨¡æ‹Ÿè¯»å†™åˆ†ç¦»åœºæ™¯
function event()
    local operation = math.random(1, 100)
    
    if operation <= 80 then
        -- 80%æ¦‚ç‡æ‰§è¡Œè¯»æ“ä½œ
        local user_id = math.random(1, 10000)
        local query = string.format(
            "SELECT id, user_id, amount FROM user_orders WHERE user_id = %d LIMIT 5",
            user_id
        )
        db_query(query)
    else
        -- 20%æ¦‚ç‡æ‰§è¡Œå†™æ“ä½œ
        local insert_query = string.format(
            "INSERT INTO user_orders (user_id, order_date, amount) VALUES (%d, CURDATE(), %.2f)",
            math.random(1, 10000),
            math.random(100, 5000) / 100
        )
        db_query(insert_query)
    end
end
```

### 8.4 ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬


**æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬**ï¼š
```bash
# æ‰§è¡Œè‡ªå®šä¹‰Luaè„šæœ¬
sysbench /path/to/custom_script.lua \
  --mysql-host=localhost \
  --mysql-user=test \
  --mysql-password=test123 \
  --mysql-db=testdb \
  --threads=16 \
  --time=60 \
  run
```

**è„šæœ¬è°ƒè¯•æŠ€å·§**ï¼š
```bash
# åªæ‰§è¡Œprepareé˜¶æ®µï¼ˆè°ƒè¯•æ•°æ®å‡†å¤‡ï¼‰
sysbench custom_script.lua prepare

# å•çº¿ç¨‹æ‰§è¡Œï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰
sysbench custom_script.lua --threads=1 --time=10 run
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ sysbenchæœ¬è´¨ï¼šå¤šç»´åº¦æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œèƒ½æµ‹è¯•CPUã€å†…å­˜ã€ç£ç›˜ã€æ•°æ®åº“
ğŸ”¸ OLTPæµ‹è¯•ï¼šæ¨¡æ‹ŸçœŸå®ä¸šåŠ¡çš„æ•°æ®åº“æ··åˆæ“ä½œæµ‹è¯•  
ğŸ”¸ æµ‹è¯•æµç¨‹ï¼šprepare â†’ run â†’ cleanup ä¸‰æ­¥èµ°
ğŸ”¸ å…³é”®æŒ‡æ ‡ï¼šTPS(äº‹åŠ¡æ•°)ã€QPS(æŸ¥è¯¢æ•°)ã€å»¶è¿Ÿã€ååé‡
ğŸ”¸ è‡ªå®šä¹‰èƒ½åŠ›ï¼šé€šè¿‡Luaè„šæœ¬å®ç°ç‰¹å®šä¸šåŠ¡åœºæ™¯æµ‹è¯•
```

### 9.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¹ æµ‹è¯•åœºæ™¯é€‰æ‹©**
```
æ–°æœåŠ¡å™¨è¯„ä¼° â†’ ä½¿ç”¨CPUã€å†…å­˜ã€ç£ç›˜IOå…¨å¥—æµ‹è¯•
æ•°æ®åº“è°ƒä¼˜ â†’ é‡ç‚¹ä½¿ç”¨OLTPè¯»å†™æ··åˆæµ‹è¯•  
å®¹é‡è§„åˆ’ â†’ é€æ­¥å¢åŠ å¹¶å‘æ•°ï¼Œæ‰¾åˆ°æ€§èƒ½æ‹ç‚¹
æ€§èƒ½å¯¹æ¯” â†’ ç›¸åŒå‚æ•°æµ‹è¯•ä¸åŒé…ç½®çš„æœåŠ¡å™¨
```

**ğŸ”¹ å‚æ•°è°ƒä¼˜å»ºè®®**
```
çº¿ç¨‹æ•°è®¾ç½®ï¼š
- CPUæµ‹è¯•ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
- æ•°æ®åº“æµ‹è¯•ï¼šä»CPUæ ¸å¿ƒæ•°å¼€å§‹ï¼Œé€æ­¥å¢åŠ 

æµ‹è¯•æ—¶é—´ï¼š
- å¿«é€ŸéªŒè¯ï¼š30-60ç§’
- æ­£å¼æµ‹è¯•ï¼š5-10åˆ†é’Ÿ  
- ç¨³å®šæ€§æµ‹è¯•ï¼š30åˆ†é’Ÿä»¥ä¸Š

æ•°æ®é‡è®¾ç½®ï¼š
- å¼€å‘ç¯å¢ƒï¼šä¸‡çº§åˆ«æ•°æ®  
- æµ‹è¯•ç¯å¢ƒï¼šåä¸‡çº§åˆ«æ•°æ®
- ç”Ÿäº§æ¨¡æ‹Ÿï¼šç™¾ä¸‡çº§åˆ«æ•°æ®
```

**ğŸ”¹ ç»“æœåˆ†æè¦ç‚¹**
```
å…³æ³¨æ ¸å¿ƒæŒ‡æ ‡ï¼š
âœ… TPSï¼šæ•°æ®åº“æ•´ä½“å¤„ç†èƒ½åŠ›  
âœ… 95%å»¶è¿Ÿï¼šç”¨æˆ·ä½“éªŒæŒ‡æ ‡
âœ… CPUä½¿ç”¨ç‡ï¼šç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
âœ… é”™è¯¯ç‡ï¼šç³»ç»Ÿç¨³å®šæ€§æŒ‡æ ‡

å¯¹æ¯”åˆ†æï¼š
ğŸ”„ ä¼˜åŒ–å‰åå¯¹æ¯”ï¼šéªŒè¯è°ƒä¼˜æ•ˆæœ
ğŸ”„ ä¸åŒé…ç½®å¯¹æ¯”ï¼šç¡¬ä»¶é€‰å‹å‚è€ƒ  
ğŸ”„ è´Ÿè½½å¢é•¿å¯¹æ¯”ï¼šå®¹é‡è§„åˆ’ä¾æ®
```

### 9.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ“Œ æµ‹è¯•ç¯å¢ƒå‡†å¤‡**
- ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼Œé¿å…å½±å“ç”Ÿäº§æ•°æ®
- ç¡®ä¿æµ‹è¯•æœŸé—´ç³»ç»Ÿè´Ÿè½½ç¨³å®šï¼Œé¿å…å…¶ä»–ç¨‹åºå¹²æ‰°
- å¤šæ¬¡æµ‹è¯•å–å¹³å‡å€¼ï¼Œå‡å°‘å¶ç„¶å› ç´ å½±å“

**ğŸ“Œ æµ‹è¯•æ‰§è¡ŒæŠ€å·§**  
- å…ˆç”¨å°è§„æ¨¡å‚æ•°éªŒè¯è„šæœ¬æ­£ç¡®æ€§
- é€æ­¥å¢åŠ è´Ÿè½½ï¼Œè§‚å¯Ÿæ€§èƒ½å˜åŒ–è¶‹åŠ¿
- è®°å½•æµ‹è¯•å‚æ•°å’Œç¯å¢ƒä¿¡æ¯ï¼Œä¾¿äºç»“æœå¯¹æ¯”

**ğŸ“Œ å¸¸è§é—®é¢˜é¿å…**
```
âŒ æµ‹è¯•æ•°æ®é‡è¿‡å°ï¼šæ— æ³•åæ˜ çœŸå®æ€§èƒ½
âŒ çº¿ç¨‹æ•°è®¾ç½®ä¸å½“ï¼šè¿‡å°‘æ— æ³•å……åˆ†åˆ©ç”¨èµ„æºï¼Œè¿‡å¤šé€ æˆç«äº‰
âŒ å¿½ç•¥é¢„çƒ­é˜¶æ®µï¼šå†·å¯åŠ¨å½±å“æµ‹è¯•ç»“æœå‡†ç¡®æ€§
âŒ å•æ¬¡æµ‹è¯•ä¸‹ç»“è®ºï¼šéœ€è¦å¤šæ¬¡æµ‹è¯•éªŒè¯ç»“æœç¨³å®šæ€§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- sysbenchæµ‹æ€§èƒ½ï¼ŒCPUå†…å­˜ç£ç›˜å…¨
- OLTPæ¨¡æ‹ŸçœŸä¸šåŠ¡ï¼Œprepare-run-cleanupèµ°
- TPS QPSçœ‹ååï¼Œå»¶è¿Ÿå…³ä¹ç”¨æˆ·æ„Ÿå—  
- è‡ªå®šä¹‰è„šæœ¬å¾ˆçµæ´»ï¼ŒLuaè¯­è¨€æ¥ç¼–å†™