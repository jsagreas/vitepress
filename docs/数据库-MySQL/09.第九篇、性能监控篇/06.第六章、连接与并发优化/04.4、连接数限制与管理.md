---
title: 4ã€è¿æ¥æ•°é™åˆ¶ä¸ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [è¿æ¥æ•°é™åˆ¶åŸºç¡€æ¦‚å¿µ](#1-è¿æ¥æ•°é™åˆ¶åŸºç¡€æ¦‚å¿µ)
2. [è¿æ¥æ•°ä¸Šé™è®¾ç½®](#2-è¿æ¥æ•°ä¸Šé™è®¾ç½®)
3. [ç”¨æˆ·ä¸ä¸»æœºè¿æ¥é™åˆ¶](#3-ç”¨æˆ·ä¸ä¸»æœºè¿æ¥é™åˆ¶)
4. [è¿æ¥æ’é˜Ÿä¸æ‹’ç»æœºåˆ¶](#4-è¿æ¥æ’é˜Ÿä¸æ‹’ç»æœºåˆ¶)
5. [è¿æ¥æ•°ç›‘æ§ä¸å‘Šè­¦](#5-è¿æ¥æ•°ç›‘æ§ä¸å‘Šè­¦)
6. [è¿æ¥æ³„æ¼æ£€æµ‹ä¸å¤„ç†](#6-è¿æ¥æ³„æ¼æ£€æµ‹ä¸å¤„ç†)
7. [è¿æ¥æ•°è§„åˆ’ä¸ä¼˜åŒ–](#7-è¿æ¥æ•°è§„åˆ’ä¸ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— è¿æ¥æ•°é™åˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¿æ¥æ•°é™åˆ¶

MySQLçš„è¿æ¥æ•°é™åˆ¶å°±åƒé¤å…çš„åº§ä½æ•°é‡ï¼Œå†³å®šäº†åŒæ—¶èƒ½æœåŠ¡å¤šå°‘ä¸ªå®¢æˆ·ã€‚å½“è¿æ¥æ•°è¾¾åˆ°ä¸Šé™æ—¶ï¼Œæ–°çš„è¿æ¥è¯·æ±‚å°±ä¼šè¢«æ‹’ç»æˆ–æ’é˜Ÿç­‰å¾…ã€‚

```
ç°å®ç±»æ¯”ï¼š
é¤å…åº§ä½ = MySQLè¿æ¥æ± 
å®¢äººæ•°é‡ = æ´»è·ƒè¿æ¥æ•°
åº§ä½ä¸Šé™ = max_connectionså‚æ•°
æ’é˜Ÿç­‰å¾… = è¿æ¥é˜Ÿåˆ—
æ‹’ç»æœåŠ¡ = Too many connectionsé”™è¯¯
```

### 1.2 è¿æ¥æ•°é™åˆ¶çš„ä½œç”¨æœºåˆ¶


**ğŸ”¸ ä¿æŠ¤æœåŠ¡å™¨èµ„æº**
```
æ¯ä¸ªè¿æ¥æ¶ˆè€—ï¼š
- å†…å­˜ï¼šçº¦256KB-2MBï¼ˆå–å†³äºé…ç½®ï¼‰
- æ–‡ä»¶æè¿°ç¬¦ï¼šæ¯è¿æ¥è‡³å°‘1ä¸ª
- CPUèµ„æºï¼šå¤„ç†æŸ¥è¯¢å’Œç»´æŠ¤è¿æ¥çŠ¶æ€
- ç½‘ç»œèµ„æºï¼šç»´æŒç½‘ç»œè¿æ¥
```

**ğŸ”¸ é˜²æ­¢èµ„æºè€—å°½**
```
æ— é™åˆ¶è¿æ¥çš„é£é™©ï¼š
1. å†…å­˜æº¢å‡ºï¼š1000ä¸ªè¿æ¥ Ã— 2MB = 2GBå†…å­˜
2. æ–‡ä»¶æè¿°ç¬¦è€—å°½ï¼šç³»ç»Ÿé»˜è®¤é™åˆ¶1024ä¸ª
3. CPUè¿‡è½½ï¼šè¿‡å¤šè¿æ¥å¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹
4. ç½‘ç»œæ‹¥å¡ï¼šç½‘ç»œå¸¦å®½å’Œç¼“å†²åŒºä¸è¶³
```

### 1.3 è¿æ¥ç±»å‹ä¸è®¡æ•°æ–¹å¼


**è¿æ¥ç±»å‹åˆ†ç±»**ï¼š
```
ç®¡ç†è¿æ¥ï¼š
- å…·æœ‰SUPERæˆ–SERVICE_CONNECTION_ADMINæƒé™
- ä¸å—max_connectionsé™åˆ¶
- ç”¨äºç´§æ€¥ç®¡ç†å’Œæ•…éšœæ¢å¤

æ™®é€šè¿æ¥ï¼š
- åº”ç”¨ç¨‹åºçš„å¸¸è§„æ•°æ®åº“è¿æ¥
- å—max_connectionsé™åˆ¶
- å ç”¨è¿æ¥æ± çš„ä¸»è¦éƒ¨åˆ†

å†…éƒ¨è¿æ¥ï¼š
- MySQLå†…éƒ¨è¿›ç¨‹ä½¿ç”¨çš„è¿æ¥
- å¦‚å¤åˆ¶è¿æ¥ã€äº‹ä»¶è°ƒåº¦å™¨è¿æ¥
- éƒ¨åˆ†å—é™åˆ¶å½±å“
```

---

## 2. âš™ï¸ è¿æ¥æ•°ä¸Šé™è®¾ç½®


### 2.1 max_connectionså‚æ•°è¯¦è§£


**ğŸ”¸ åŸºæœ¬è®¾ç½®æ–¹æ³•**
```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥æ•°ä¸Šé™
SHOW VARIABLES LIKE 'max_connections';

-- ä¸´æ—¶ä¿®æ”¹ï¼ˆé‡å¯åå¤±æ•ˆï¼‰
SET GLOBAL max_connections = 1000;

-- æ°¸ä¹…ä¿®æ”¹ï¼ˆé…ç½®æ–‡ä»¶ï¼‰
[mysqld]
max_connections = 1000
```

**ğŸ”¸ åˆç†å€¼çš„ç¡®å®š**
```
è®¡ç®—å…¬å¼ï¼š
max_connections = (ç³»ç»Ÿå†…å­˜ - å…¶ä»–ç¨‹åºå†…å­˜) / å•è¿æ¥å†…å­˜æ¶ˆè€—

ç¤ºä¾‹è®¡ç®—ï¼š
- æœåŠ¡å™¨å†…å­˜ï¼š16GB
- æ“ä½œç³»ç»Ÿ+å…¶ä»–ï¼š4GB  
- MySQLå¯ç”¨ï¼š12GB
- å•è¿æ¥æ¶ˆè€—ï¼š2MB
- å»ºè®®ä¸Šé™ï¼š12GB / 2MB = 6000ï¼ˆå®é™…è®¾ç½®3000-4000è¾ƒå®‰å…¨ï¼‰
```

### 2.2 extra_max_connectionsç®¡ç†è¿æ¥


**ğŸ”¸ ç®¡ç†è¿æ¥é¢„ç•™**
```sql
-- è®¾ç½®é¢å¤–ç®¡ç†è¿æ¥æ•°
SET GLOBAL extra_max_connections = 10;

-- é…ç½®æ–‡ä»¶è®¾ç½®
[mysqld]
extra_max_connections = 10
max_connections = 1000

-- å®é™…æ€»è¿æ¥æ•° = max_connections + extra_max_connections = 1010
```

**ğŸ”¸ ç®¡ç†è¿æ¥çš„ä½¿ç”¨åœºæ™¯**
```
ç´§æ€¥æƒ…å†µå¤„ç†ï¼š
1. æ™®é€šè¿æ¥æ± æ»¡æ—¶ï¼ŒDBAä»å¯ç™»å½•
2. æ‰§è¡ŒKILLå‘½ä»¤ç»ˆæ­¢å¼‚å¸¸è¿æ¥
3. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
4. æ‰§è¡Œç´§æ€¥ç»´æŠ¤æ“ä½œ

æƒé™è¦æ±‚ï¼š
- SUPERæƒé™ï¼ˆMySQL 5.7åŠä»¥å‰ï¼‰
- SERVICE_CONNECTION_ADMINæƒé™ï¼ˆMySQL 8.0+ï¼‰
```

### 2.3 æ“ä½œç³»ç»Ÿå±‚é¢çš„é™åˆ¶


**ğŸ”¸ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**
```bash
# æŸ¥çœ‹å½“å‰é™åˆ¶
ulimit -n

# æŸ¥çœ‹MySQLè¿›ç¨‹çš„é™åˆ¶
cat /proc/$(pidof mysqld)/limits | grep "Max open files"

# æ°¸ä¹…ä¿®æ”¹ï¼ˆ/etc/security/limits.confï¼‰
mysql soft nofile 65535
mysql hard nofile 65535

# ç³»ç»Ÿçº§åˆ«ä¿®æ”¹ï¼ˆ/etc/sysctl.confï¼‰
fs.file-max = 2097152
```

**ğŸ”¸ å†…å­˜é™åˆ¶è€ƒè™‘**
```
å†…å­˜è§„åˆ’ï¼š
- ç¼“å†²æ± ï¼šé€šå¸¸å æ€»å†…å­˜çš„70-80%
- è¿æ¥å†…å­˜ï¼šæ¯è¿æ¥256KB-2MB
- å…¶ä»–ç¼“å­˜ï¼šæŸ¥è¯¢ç¼“å­˜ã€ä¸´æ—¶è¡¨ç­‰
- æ“ä½œç³»ç»Ÿï¼šé¢„ç•™è‡³å°‘2-4GB

ç¤ºä¾‹é…ç½®ï¼ˆ16GBæœåŠ¡å™¨ï¼‰ï¼š
- innodb_buffer_pool_size = 10GB
- è¿æ¥å†…å­˜é¢„ç®—ï¼š2GBï¼ˆ1000è¿æ¥Ã—2MBï¼‰
- å…¶ä»–MySQLå†…å­˜ï¼š2GB
- æ“ä½œç³»ç»Ÿï¼š2GB
```

---

## 3. ğŸ‘¥ ç”¨æˆ·ä¸ä¸»æœºè¿æ¥é™åˆ¶


### 3.1 ç”¨æˆ·çº§åˆ«è¿æ¥é™åˆ¶


**ğŸ”¸ MAX_USER_CONNECTIONSé™åˆ¶**
```sql
-- åˆ›å»ºç”¨æˆ·æ—¶è®¾ç½®è¿æ¥é™åˆ¶
CREATE USER 'app_user'@'%' 
WITH MAX_USER_CONNECTIONS 50;

-- ä¿®æ”¹ç°æœ‰ç”¨æˆ·çš„è¿æ¥é™åˆ¶
ALTER USER 'app_user'@'%' 
WITH MAX_USER_CONNECTIONS 100;

-- æŸ¥çœ‹ç”¨æˆ·è¿æ¥é™åˆ¶
SELECT User, Host, max_user_connections 
FROM mysql.user 
WHERE User = 'app_user';
```

**ğŸ”¸ è¿æ¥é™åˆ¶ç±»å‹è¯¦è§£**
```sql
-- å®Œæ•´çš„ç”¨æˆ·èµ„æºé™åˆ¶
CREATE USER 'limited_user'@'%' WITH
    MAX_QUERIES_PER_HOUR 10000,        -- æ¯å°æ—¶æŸ¥è¯¢æ•°é™åˆ¶
    MAX_UPDATES_PER_HOUR 5000,         -- æ¯å°æ—¶æ›´æ–°æ•°é™åˆ¶  
    MAX_CONNECTIONS_PER_HOUR 1000,     -- æ¯å°æ—¶è¿æ¥æ•°é™åˆ¶
    MAX_USER_CONNECTIONS 50;           -- åŒæ—¶è¿æ¥æ•°é™åˆ¶
```

### 3.2 åŸºäºIPçš„è¿æ¥æ§åˆ¶


**ğŸ”¸ ä¸»æœºçº§åˆ«é™åˆ¶**
```sql
-- é™åˆ¶ç‰¹å®šIPçš„è¿æ¥
CREATE USER 'web_app'@'192.168.1.100' 
WITH MAX_USER_CONNECTIONS 20;

-- é™åˆ¶IPæ®µçš„è¿æ¥
CREATE USER 'api_user'@'192.168.1.%' 
WITH MAX_USER_CONNECTIONS 10;

-- æŸ¥çœ‹å½“å‰è¿æ¥åˆ†å¸ƒ
SELECT USER, HOST, COUNT(*) as connection_count
FROM information_schema.PROCESSLIST 
GROUP BY USER, HOST;
```

### 3.3 è¿æ¥é…é¢ç®¡ç†ç­–ç•¥


**ğŸ”¸ åˆ†å±‚é…é¢è®¾è®¡**
```
é…é¢åˆ†é…ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€»è¿æ¥æ•°ï¼š1000                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Webåº”ç”¨ï¼š600 (60%)               â”‚
â”‚ â”œâ”€ ç”¨æˆ·ç«¯ï¼š400                    â”‚
â”‚ â””â”€ ç®¡ç†ç«¯ï¼š200                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ APIæœåŠ¡ï¼š300 (30%)               â”‚
â”‚ â”œâ”€ æ ¸å¿ƒAPIï¼š200                  â”‚
â”‚ â””â”€ è¾…åŠ©APIï¼š100                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®åˆ†æï¼š80 (8%)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿ç»´ç®¡ç†ï¼š20 (2%)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ åŠ¨æ€é…é¢è°ƒæ•´**
```sql
-- ç›‘æ§è„šæœ¬ï¼šæ£€æŸ¥è¿æ¥ä½¿ç”¨æƒ…å†µ
SELECT 
    USER,
    COUNT(*) as current_connections,
    MAX_USER_CONNECTIONS as max_allowed,
    ROUND(COUNT(*)/MAX_USER_CONNECTIONS*100, 2) as usage_percent
FROM information_schema.PROCESSLIST p
JOIN mysql.user u ON p.USER = u.User
WHERE MAX_USER_CONNECTIONS > 0
GROUP BY USER, MAX_USER_CONNECTIONS
ORDER BY usage_percent DESC;
```

---

## 4. ğŸš¦ è¿æ¥æ’é˜Ÿä¸æ‹’ç»æœºåˆ¶


### 4.1 è¿æ¥æ‹’ç»çš„è§¦å‘æ¡ä»¶


**ğŸ”¸ Too many connectionsé”™è¯¯**
```
è§¦å‘æ¡ä»¶ï¼š
æ´»è·ƒè¿æ¥æ•° >= max_connections + extra_max_connections

é”™è¯¯ä¿¡æ¯ï¼š
"ERROR 1040 (HY000): Too many connections"

å¤„ç†æµç¨‹ï¼š
1. MySQLç«‹å³æ‹’ç»æ–°è¿æ¥è¯·æ±‚
2. å®¢æˆ·ç«¯æ”¶åˆ°é”™è¯¯å¹¶æ–­å¼€è¿æ¥
3. åº”ç”¨ç¨‹åºéœ€è¦é‡è¯•æˆ–é™çº§å¤„ç†
```

### 4.2 è¿æ¥ç­‰å¾…ä¸è¶…æ—¶æœºåˆ¶


**ğŸ”¸ è¿æ¥è¶…æ—¶å‚æ•°**
```sql
-- è¿æ¥å»ºç«‹è¶…æ—¶
SHOW VARIABLES LIKE 'connect_timeout';
SET GLOBAL connect_timeout = 30;

-- äº¤äº’å¼è¿æ¥è¶…æ—¶
SHOW VARIABLES LIKE 'interactive_timeout';
SET GLOBAL interactive_timeout = 3600;

-- éäº¤äº’å¼è¿æ¥è¶…æ—¶
SHOW VARIABLES LIKE 'wait_timeout';
SET GLOBAL wait_timeout = 600;
```

**ğŸ”¸ è¶…æ—¶å¤„ç†æœºåˆ¶**
```
è¶…æ—¶ç±»å‹è¯´æ˜ï¼š

connect_timeoutï¼ˆè¿æ¥å»ºç«‹è¶…æ—¶ï¼‰ï¼š
- é»˜è®¤ï¼š10ç§’
- ä½œç”¨ï¼šTCPè¿æ¥å»ºç«‹çš„æœ€é•¿ç­‰å¾…æ—¶é—´
- è¿‡çŸ­ï¼šç½‘ç»œè¾ƒæ…¢æ—¶è¿æ¥å¤±è´¥
- è¿‡é•¿ï¼šèµ„æºè¢«é•¿æ—¶é—´å ç”¨

wait_timeoutï¼ˆç©ºé—²è¿æ¥è¶…æ—¶ï¼‰ï¼š
- é»˜è®¤ï¼š28800ç§’ï¼ˆ8å°æ—¶ï¼‰
- ä½œç”¨ï¼šç©ºé—²è¿æ¥çš„å­˜æ´»æ—¶é—´
- å»ºè®®ï¼š300-3600ç§’ï¼ˆ5åˆ†é’Ÿ-1å°æ—¶ï¼‰
```

### 4.3 è¿æ¥æ‹’ç»ç­–ç•¥é…ç½®


**ğŸ”¸ åº”ç”¨å±‚é‡è¯•æœºåˆ¶**
```python
import mysql.connector
import time
from mysql.connector import Error

def get_connection_with_retry(max_retries=3, retry_delay=1):
    """å¸¦é‡è¯•çš„æ•°æ®åº“è¿æ¥"""
    for attempt in range(max_retries):
        try:
            connection = mysql.connector.connect(
                host='localhost',
                database='test_db',
                user='app_user',
                password='password',
                connection_timeout=5
            )
            return connection
            
        except Error as e:
            if e.errno == 1040:  # Too many connections
                if attempt < max_retries - 1:
                    time.sleep(retry_delay * (2 ** attempt))  # æŒ‡æ•°é€€é¿
                    continue
                else:
                    raise Exception("è¿æ¥æ± å·²æ»¡ï¼Œè¯·ç¨åé‡è¯•")
            else:
                raise e
```

---

## 5. ğŸ“Š è¿æ¥æ•°ç›‘æ§ä¸å‘Šè­¦


### 5.1 å®æ—¶è¿æ¥æ•°ç›‘æ§


**ğŸ”¸ åŸºç¡€ç›‘æ§æŸ¥è¯¢**
```sql
-- å½“å‰è¿æ¥æ•°ç»Ÿè®¡
SELECT 
    COUNT(*) as current_connections,
    $$max_connections as max_connections,
    ROUND(COUNT(*)/$$max_connections*100, 2) as usage_percent
FROM information_schema.PROCESSLIST;

-- æŒ‰ç”¨æˆ·åˆ†ç»„çš„è¿æ¥ç»Ÿè®¡
SELECT 
    USER,
    HOST,
    COUNT(*) as connections,
    AVG(TIME) as avg_time
FROM information_schema.PROCESSLIST 
GROUP BY USER, HOST
ORDER BY connections DESC;

-- æŒ‰çŠ¶æ€åˆ†ç»„çš„è¿æ¥ç»Ÿè®¡
SELECT 
    COMMAND,
    STATE,
    COUNT(*) as count
FROM information_schema.PROCESSLIST 
GROUP BY COMMAND, STATE
ORDER BY count DESC;
```

### 5.2 è¿æ¥æ•°è¶‹åŠ¿åˆ†æ


**ğŸ”¸ å†å²è¿æ¥æ•°æ®æ”¶é›†**
```sql
-- åˆ›å»ºç›‘æ§æ•°æ®è¡¨
CREATE TABLE connection_monitor (
    id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    current_connections INT,
    max_connections INT,
    usage_percent DECIMAL(5,2),
    active_connections INT,
    sleeping_connections INT
);

-- ç›‘æ§æ•°æ®æ’å…¥è„šæœ¬
INSERT INTO connection_monitor (
    current_connections, 
    max_connections, 
    usage_percent,
    active_connections,
    sleeping_connections
)
SELECT 
    COUNT(*),
    $$max_connections,
    ROUND(COUNT(*)/$$max_connections*100, 2),
    SUM(CASE WHEN COMMAND != 'Sleep' THEN 1 ELSE 0 END),
    SUM(CASE WHEN COMMAND = 'Sleep' THEN 1 ELSE 0 END)
FROM information_schema.PROCESSLIST;
```

### 5.3 å‘Šè­¦æœºåˆ¶è®¾ç½®


**ğŸ”¸ è¿æ¥æ•°å‘Šè­¦è„šæœ¬**
```bash
#!/bin/bash
# è¿æ¥æ•°ç›‘æ§å‘Šè­¦è„šæœ¬

MYSQL_USER="monitor_user"
MYSQL_PASS="monitor_pass"
MYSQL_HOST="localhost"

# è·å–å½“å‰è¿æ¥æ•°å’Œæœ€å¤§è¿æ¥æ•°
CURRENT=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e \
    "SELECT COUNT(*) FROM information_schema.PROCESSLIST;" -s)
MAX=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e \
    "SELECT $$max_connections;" -s)

# è®¡ç®—ä½¿ç”¨ç‡
USAGE=$(echo "scale=2; $CURRENT * 100 / $MAX" | bc)

# å‘Šè­¦é˜ˆå€¼
WARNING_THRESHOLD=80
CRITICAL_THRESHOLD=95

if (( $(echo "$USAGE >= $CRITICAL_THRESHOLD" | bc -l) )); then
    echo "CRITICAL: è¿æ¥æ•°ä½¿ç”¨ç‡ ${USAGE}% (${CURRENT}/${MAX})"
    # å‘é€ç´§æ€¥å‘Šè­¦
elif (( $(echo "$USAGE >= $WARNING_THRESHOLD" | bc -l) )); then
    echo "WARNING: è¿æ¥æ•°ä½¿ç”¨ç‡ ${USAGE}% (${CURRENT}/${MAX})"
    # å‘é€è­¦å‘Šé€šçŸ¥
else
    echo "OK: è¿æ¥æ•°ä½¿ç”¨ç‡ ${USAGE}% (${CURRENT}/${MAX})"
fi
```

---

## 6. ğŸ” è¿æ¥æ³„æ¼æ£€æµ‹ä¸å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯è¿æ¥æ³„æ¼


è¿æ¥æ³„æ¼å°±åƒæ°´é¾™å¤´æ²¡å…³ç´§ï¼Œåº”ç”¨ç¨‹åºè·å–äº†æ•°æ®åº“è¿æ¥ä½†æ²¡æœ‰æ­£ç¡®é‡Šæ”¾ï¼Œå¯¼è‡´è¿æ¥æ•°é€æ¸å¢åŠ ç›´åˆ°è€—å°½è¿æ¥æ± ã€‚

**ğŸ”¸ è¿æ¥æ³„æ¼çš„å¸¸è§åŸå› **
```
ä»£ç å±‚é¢ï¼š
1. å¿˜è®°å…³é—­è¿æ¥ï¼štry-catchå—ä¸­é—æ¼close()
2. å¼‚å¸¸å¤„ç†ä¸å½“ï¼šå¼‚å¸¸å‘ç”Ÿæ—¶è¿æ¥æœªé‡Šæ”¾
3. äº‹åŠ¡æœªæäº¤ï¼šé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡å ç”¨è¿æ¥
4. è¿æ¥æ± é…ç½®é”™è¯¯ï¼šè¶…æ—¶æ—¶é—´è®¾ç½®ä¸å½“

åº”ç”¨å±‚é¢ï¼š
1. è¿æ¥æ± ç®¡ç†ä¸å½“ï¼šè·å–è¿æ¥åæœªå½’è¿˜
2. é•¿æ—¶é—´çš„æ‰¹å¤„ç†ï¼šå¤§é‡æ•°æ®å¤„ç†å ç”¨è¿æ¥
3. æ­»é”ç­‰å¾…ï¼šè¿æ¥åœ¨ç­‰å¾…é”é‡Šæ”¾
```

### 6.2 è¿æ¥æ³„æ¼æ£€æµ‹æ–¹æ³•


**ğŸ”¸ é•¿æ—¶é—´è¿è¡Œè¿æ¥æ£€æµ‹**
```sql
-- æŸ¥æ‰¾è¿è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„è¿æ¥
SELECT 
    ID,
    USER,
    HOST,
    DB,
    COMMAND,
    TIME as runtime_seconds,
    STATE,
    LEFT(INFO, 100) as query_preview
FROM information_schema.PROCESSLIST 
WHERE TIME > 300  -- è¶…è¿‡5åˆ†é’Ÿçš„è¿æ¥
    AND COMMAND != 'Sleep'  -- æ’é™¤ç©ºé—²è¿æ¥
ORDER BY TIME DESC;

-- æŸ¥æ‰¾é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
SELECT 
    ID,
    USER,
    HOST,
    DB,
    TIME as idle_seconds,
    STATE
FROM information_schema.PROCESSLIST 
WHERE COMMAND = 'Sleep' 
    AND TIME > 3600  -- ç©ºé—²è¶…è¿‡1å°æ—¶
ORDER BY TIME DESC;
```

**ğŸ”¸ è¿æ¥å¢é•¿è¶‹åŠ¿ç›‘æ§**
```sql
-- è¿æ¥æ•°å˜åŒ–è¶‹åŠ¿åˆ†æ
SELECT 
    DATE(timestamp) as date,
    HOUR(timestamp) as hour,
    AVG(current_connections) as avg_connections,
    MAX(current_connections) as peak_connections,
    MIN(current_connections) as min_connections
FROM connection_monitor
WHERE timestamp >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY DATE(timestamp), HOUR(timestamp)
ORDER BY date, hour;
```

### 6.3 è¿æ¥æ³„æ¼å¤„ç†ç­–ç•¥


**ğŸ”¸ è‡ªåŠ¨æ¸…ç†è„šæœ¬**
```sql
-- åˆ›å»ºæ¸…ç†å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE CleanupIdleConnections()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE conn_id INT;
    DECLARE conn_time INT;
    DECLARE cur CURSOR FOR 
        SELECT ID, TIME 
        FROM information_schema.PROCESSLIST 
        WHERE COMMAND = 'Sleep' 
            AND TIME > 3600 
            AND USER != 'root';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur;
    cleanup_loop: LOOP
        FETCH cur INTO conn_id, conn_time;
        IF done THEN
            LEAVE cleanup_loop;
        END IF;
        
        -- è®°å½•æ—¥å¿—
        INSERT INTO connection_cleanup_log 
        VALUES (NOW(), conn_id, conn_time, 'Auto cleanup');
        
        -- ç»ˆæ­¢è¿æ¥
        SET @sql = CONCAT('KILL ', conn_id);
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END LOOP;
    
    CLOSE cur;
END$$
DELIMITER ;
```

**ğŸ”¸ åº”ç”¨å±‚è¿æ¥æ± ä¼˜åŒ–**
```python
# è¿æ¥æ± é…ç½®ä¼˜åŒ–ç¤ºä¾‹
from mysql.connector.pooling import MySQLConnectionPool

config = {
    'user': 'app_user',
    'password': 'password',
    'host': 'localhost',
    'database': 'app_db',
    'pool_name': 'mypool',
    'pool_size': 20,              # è¿æ¥æ± å¤§å°
    'pool_reset_session': True,   # è¿æ¥å½’è¿˜æ—¶é‡ç½®çŠ¶æ€
    'autocommit': True,           # è‡ªåŠ¨æäº¤é¿å…äº‹åŠ¡æ³„æ¼
}

# åˆ›å»ºè¿æ¥æ± 
cnxpool = MySQLConnectionPool(**config)

# æ­£ç¡®çš„è¿æ¥ä½¿ç”¨æ–¹å¼
def execute_query_safely(query, params=None):
    connection = None
    try:
        connection = cnxpool.get_connection()
        cursor = connection.cursor()
        cursor.execute(query, params)
        result = cursor.fetchall()
        return result
    except Exception as e:
        if connection:
            connection.rollback()
        raise e
    finally:
        if connection:
            connection.close()  # å½’è¿˜åˆ°è¿æ¥æ± 
```

---

## 7. ğŸ“ˆ è¿æ¥æ•°è§„åˆ’ä¸ä¼˜åŒ–


### 7.1 è¿æ¥æ•°å®¹é‡è§„åˆ’


**ğŸ”¸ ä¸šåŠ¡éœ€æ±‚åˆ†æ**
```
å®¹é‡è§„åˆ’æ­¥éª¤ï¼š

1. ä¸šåŠ¡é‡è¯„ä¼°ï¼š
   - å¹¶å‘ç”¨æˆ·æ•°ï¼š1000äºº
   - å¹³å‡æ¯ç”¨æˆ·è¿æ¥æ•°ï¼š2ä¸ªï¼ˆWeb+APIï¼‰
   - åŸºç¡€è¿æ¥éœ€æ±‚ï¼š2000ä¸ª

2. å³°å€¼ç³»æ•°è®¡ç®—ï¼š
   - æ—¥å¸¸å³°å€¼ç³»æ•°ï¼š1.5å€
   - èŠ‚å‡æ—¥å³°å€¼ç³»æ•°ï¼š3å€
   - å³°å€¼è¿æ¥éœ€æ±‚ï¼š2000 Ã— 3 = 6000ä¸ª

3. å®‰å…¨ä½™é‡é¢„ç•™ï¼š
   - é¢„ç•™ç³»æ•°ï¼š1.2å€
   - æœ€ç»ˆè§„åˆ’ï¼š6000 Ã— 1.2 = 7200ä¸ª
```

### 7.2 è¿æ¥æ± ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ åˆ†å±‚è¿æ¥æ± è®¾è®¡**
```
æ¶æ„è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨å±‚è¿æ¥æ± ï¼ˆæ¯ä¸ªåº”ç”¨å®ä¾‹ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸­é—´ä»¶è¿æ¥æ± ï¼ˆProxySQL/MyCATï¼‰   â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MySQLè¿æ¥æ± ï¼ˆæœåŠ¡å™¨å±‚é¢ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
- å¤šå±‚ç¼“å†²ï¼Œå‡å°‘ç›´æ¥è¿æ¥
- è¿æ¥å¤ç”¨ç‡æå‡
- æ•…éšœéš”ç¦»å’Œæ¢å¤èƒ½åŠ›å¼º
```

**ğŸ”¸ è¿æ¥æ± å‚æ•°ä¼˜åŒ–**
```sql
-- MySQLæœåŠ¡å™¨ç«¯ä¼˜åŒ–
[mysqld]
max_connections = 2000
extra_max_connections = 100
thread_cache_size = 100          # çº¿ç¨‹ç¼“å­˜
wait_timeout = 600               # 10åˆ†é’Ÿè¶…æ—¶
interactive_timeout = 600
connect_timeout = 10

# å†…å­˜ç›¸å…³
thread_stack = 256K
max_allowed_packet = 64M
```

### 7.3 åŠ¨æ€è°ƒæ•´æœºåˆ¶


**ğŸ”¸ è‡ªé€‚åº”è¿æ¥æ•°è°ƒæ•´**
```python
import time
import mysql.connector
from datetime import datetime

class DynamicConnectionManager:
    def __init__(self):
        self.current_max = 1000
        self.min_connections = 500
        self.max_connections = 2000
        
    def monitor_and_adjust(self):
        """ç›‘æ§å¹¶åŠ¨æ€è°ƒæ•´è¿æ¥æ•°"""
        try:
            # è·å–å½“å‰è¿æ¥ä½¿ç”¨æƒ…å†µ
            conn = mysql.connector.connect(host='localhost', user='admin')
            cursor = conn.cursor()
            
            cursor.execute("""
                SELECT COUNT(*) as current,
                       $$max_connections as max_conn
                FROM information_schema.PROCESSLIST
            """)
            
            current, max_conn = cursor.fetchone()
            usage_rate = current / max_conn
            
            # è°ƒæ•´ç­–ç•¥
            if usage_rate > 0.9:  # ä½¿ç”¨ç‡è¶…è¿‡90%
                new_max = min(max_conn * 1.2, self.max_connections)
                self.adjust_connections(new_max)
                
            elif usage_rate < 0.3:  # ä½¿ç”¨ç‡ä½äº30%
                new_max = max(max_conn * 0.8, self.min_connections)
                self.adjust_connections(new_max)
                
        except Exception as e:
            print(f"ç›‘æ§è°ƒæ•´å¤±è´¥: {e}")
            
    def adjust_connections(self, new_max):
        """è°ƒæ•´è¿æ¥æ•°ä¸Šé™"""
        try:
            conn = mysql.connector.connect(host='localhost', user='admin')
            cursor = conn.cursor()
            cursor.execute(f"SET GLOBAL max_connections = {new_max}")
            print(f"{datetime.now()}: è¿æ¥æ•°è°ƒæ•´ä¸º {new_max}")
        except Exception as e:
            print(f"è¿æ¥æ•°è°ƒæ•´å¤±è´¥: {e}")
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿æ¥æ•°é™åˆ¶ï¼šä¿æŠ¤æœåŠ¡å™¨èµ„æºï¼Œé˜²æ­¢è¿‡è½½çš„é‡è¦æœºåˆ¶
ğŸ”¸ max_connectionsï¼šæ§åˆ¶æ™®é€šè¿æ¥æ•°ä¸Šé™çš„æ ¸å¿ƒå‚æ•°
ğŸ”¸ extra_max_connectionsï¼šç®¡ç†è¿æ¥é¢„ç•™ï¼Œç¡®ä¿ç´§æ€¥æƒ…å†µå¯ç™»å½•
ğŸ”¸ ç”¨æˆ·è¿æ¥é™åˆ¶ï¼šé€šè¿‡MAX_USER_CONNECTIONSæ§åˆ¶å•ç”¨æˆ·è¿æ¥æ•°
ğŸ”¸ è¿æ¥è¶…æ—¶ï¼šwait_timeoutå’Œinteractive_timeoutæ§åˆ¶è¿æ¥ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ è¿æ¥æ³„æ¼ï¼šåº”ç”¨ç¨‹åºæœªæ­£ç¡®é‡Šæ”¾è¿æ¥å¯¼è‡´çš„èµ„æºæµªè´¹
```

### 8.2 å…³é”®é…ç½®å»ºè®®


**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**
```sql
-- åŸºç¡€è¿æ¥é…ç½®
max_connections = 1000-2000     -- æ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´
extra_max_connections = 50      -- ç®¡ç†è¿æ¥é¢„ç•™
wait_timeout = 600              -- 10åˆ†é’Ÿç©ºé—²è¶…æ—¶
interactive_timeout = 3600      -- 1å°æ—¶äº¤äº’è¶…æ—¶
connect_timeout = 10            -- 10ç§’è¿æ¥å»ºç«‹è¶…æ—¶

-- ç”¨æˆ·è¿æ¥é™åˆ¶
CREATE USER 'app_user'@'%' WITH MAX_USER_CONNECTIONS 100;
```

**ğŸ”¹ ç›‘æ§å‘Šè­¦é˜ˆå€¼**
```
è¿æ¥æ•°ä½¿ç”¨ç‡å‘Šè­¦ï¼š
- è­¦å‘Šé˜ˆå€¼ï¼š80%
- ä¸¥é‡é˜ˆå€¼ï¼š95%
- ç´§æ€¥é˜ˆå€¼ï¼š98%

è¿æ¥æ—¶é—´å‘Šè­¦ï¼š
- æ´»è·ƒè¿æ¥ï¼š> 5åˆ†é’Ÿ
- ç©ºé—²è¿æ¥ï¼š> 1å°æ—¶
- äº‹åŠ¡è¿æ¥ï¼š> 2åˆ†é’Ÿ
```

### 8.3 æ•…éšœå¤„ç†æµç¨‹


**ğŸ”¹ è¿æ¥æ•°è€—å°½å¤„ç†æ­¥éª¤**
```
1. ç«‹å³å“åº”ï¼š
   - ä½¿ç”¨ç®¡ç†è¿æ¥ç™»å½•
   - æŸ¥çœ‹å½“å‰è¿æ¥åˆ†å¸ƒ
   - è¯†åˆ«å¼‚å¸¸è¿æ¥

2. å¿«é€Ÿæ¢å¤ï¼š
   - ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
   - æ¸…ç†ç©ºé—²è¿æ¥
   - é‡å¯å¼‚å¸¸åº”ç”¨

3. æ ¹å› åˆ†æï¼š
   - åˆ†æè¿æ¥å¢é•¿è¶‹åŠ¿
   - æ£€æŸ¥åº”ç”¨ç¨‹åºè¿æ¥ç®¡ç†
   - è¯„ä¼°å®¹é‡è§„åˆ’æ˜¯å¦åˆç†
```

**ğŸ”¹ é¢„é˜²æªæ–½**
```
ä»£ç å±‚é¢ï¼š
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
- ç¡®ä¿try-finallyæ­£ç¡®é‡Šæ”¾è¿æ¥
- è®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´

è¿ç»´å±‚é¢ï¼š
- å»ºç«‹è¿æ¥æ•°ç›‘æ§å‘Šè­¦
- å®šæœŸæ¸…ç†é•¿æ—¶é—´ç©ºé—²è¿æ¥
- åˆ¶å®šå®¹é‡è§„åˆ’å’Œæ‰©å®¹ç­–ç•¥
```

### 8.4 æœ€ä½³å®è·µæ€»ç»“


> ğŸ“Œ **æ ¸å¿ƒåŸåˆ™**  
> è¿æ¥æ•°ç®¡ç†çš„ç›®æ ‡æ˜¯åœ¨ä¿éšœæœåŠ¡å¯ç”¨æ€§çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–èµ„æºåˆ©ç”¨æ•ˆç‡

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> è¿æ¥æ•°è®¾ç½®è¿‡é«˜ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ï¼Œè®¾ç½®è¿‡ä½ä¼šå½±å“å¹¶å‘æ€§èƒ½

> ğŸ’¡ **å®ç”¨æŠ€å·§**  
> ä½¿ç”¨è¿æ¥æ± å¯ä»¥æ˜¾è‘—æé«˜è¿æ¥å¤ç”¨ç‡ï¼Œå‡å°‘è¿æ¥å»ºç«‹å¼€é”€

> ğŸ”¥ **ç›‘æ§é‡ç‚¹**  
> é‡ç‚¹å…³æ³¨è¿æ¥æ•°ä½¿ç”¨ç‡ã€è¿æ¥æ—¶é—´åˆ†å¸ƒã€ç”¨æˆ·è¿æ¥åˆ†å¸ƒä¸‰ä¸ªç»´åº¦

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è¿æ¥æœ‰é™éœ€ç®¡æ§ï¼Œä¸Šé™è®¾ç½®è¦åˆç†
- ç”¨æˆ·ä¸»æœºåˆ†é…é¢ï¼Œè¶…æ—¶æ¸…ç†é˜²æ³„æ¼  
- ç›‘æ§å‘Šè­¦æ—©å‘ç°ï¼ŒåŠ¨æ€è°ƒæ•´ä¿ç¨³å®š
- è¿æ¥æ± åŒ–ææ•ˆç‡ï¼Œæ•…éšœå¤„ç†æœ‰é¢„æ¡ˆ