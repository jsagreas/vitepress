---
title: 9ã€Redisé›†æˆç¼“å­˜
---
## ğŸ“š ç›®å½•

1. [Redisé›†æˆç¼“å­˜æ¦‚è¿°](#1-Redisé›†æˆç¼“å­˜æ¦‚è¿°)
2. [ç¼“å­˜é”®è®¾è®¡ç­–ç•¥](#2-ç¼“å­˜é”®è®¾è®¡ç­–ç•¥)
3. [æ•°æ®åºåˆ—åŒ–æ–¹æ¡ˆ](#3-æ•°æ®åºåˆ—åŒ–æ–¹æ¡ˆ)
4. [TTLè¿‡æœŸè®¾ç½®](#4-TTLè¿‡æœŸè®¾ç½®)
5. [ç¼“å­˜æ›´æ–°æ¨¡å¼](#5-ç¼“å­˜æ›´æ–°æ¨¡å¼)
6. [ä¸»ä»ç¼“å­˜æ¶æ„](#6-ä¸»ä»ç¼“å­˜æ¶æ„)
7. [ç¼“å­˜é›†ç¾¤éƒ¨ç½²](#7-ç¼“å­˜é›†ç¾¤éƒ¨ç½²)
8. [Redisç¼“å­˜ä¼˜åŒ–ç­–ç•¥](#8-Redisç¼“å­˜ä¼˜åŒ–ç­–ç•¥)
9. [ç¼“å­˜æ•°æ®åˆ†ç‰‡ç­–ç•¥](#9-ç¼“å­˜æ•°æ®åˆ†ç‰‡ç­–ç•¥)
10. [ç¼“å­˜é«˜å¯ç”¨æ¶æ„](#10-ç¼“å­˜é«˜å¯ç”¨æ¶æ„)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Redisé›†æˆç¼“å­˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Redisé›†æˆç¼“å­˜

Redisé›†æˆç¼“å­˜æ˜¯åœ¨MySQLæ•°æ®åº“å‰ç«¯éƒ¨ç½²Rediså†…å­˜ç¼“å­˜å±‚ï¼Œå°†çƒ­ç‚¹æŸ¥è¯¢ç»“æœå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¤§å¹…å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›ï¼Œæå‡åº”ç”¨å“åº”é€Ÿåº¦ã€‚

```
ä¼ ç»ŸæŸ¥è¯¢æµç¨‹ï¼š
åº”ç”¨ â†’ MySQL â†’ ç£ç›˜IO â†’ è¿”å›ç»“æœ

Redisç¼“å­˜æµç¨‹ï¼š
åº”ç”¨ â†’ Redis(å‘½ä¸­) â†’ ç›´æ¥è¿”å›
åº”ç”¨ â†’ Redis(æœªå‘½ä¸­) â†’ MySQL â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›ç»“æœ
```

**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **å“åº”é€Ÿåº¦å¿«**ï¼šå†…å­˜è¯»å–é€Ÿåº¦æ˜¯ç£ç›˜çš„1000å€ä»¥ä¸Š
- **å‡å°‘DBå‹åŠ›**ï¼š80%ä»¥ä¸ŠæŸ¥è¯¢å¯è¢«ç¼“å­˜æ‹¦æˆª
- **æå‡å¹¶å‘èƒ½åŠ›**ï¼šRediså•å®ä¾‹å¯å¤„ç†10ä¸‡+QPS
- **é™ä½æˆæœ¬**ï¼šå‡å°‘æ•°æ®åº“æœåŠ¡å™¨è´Ÿè½½

### 1.2 é€‚ç”¨åœºæ™¯åˆ†æ


```
ğŸŸ¢ **é€‚åˆç¼“å­˜çš„åœºæ™¯**
â”œâ”€ ğŸ“Š è¯»å¤šå†™å°‘ï¼šæŸ¥è¯¢é¢‘ç‡ > æ›´æ–°é¢‘ç‡
â”œâ”€ ğŸ”„ é‡å¤æŸ¥è¯¢ï¼šç›¸åŒSQLè¢«é¢‘ç¹æ‰§è¡Œ
â”œâ”€ ğŸ“ˆ çƒ­ç‚¹æ•°æ®ï¼š20%æ•°æ®äº§ç”Ÿ80%è®¿é—®
â””â”€ â±ï¸ å®æ—¶æ€§è¦æ±‚ä¸ä¸¥æ ¼ï¼šå…è®¸çŸ­æ—¶é—´æ•°æ®ä¸ä¸€è‡´

ğŸ”´ **ä¸é€‚åˆç¼“å­˜çš„åœºæ™¯**  
â”œâ”€ âœï¸ é¢‘ç¹æ›´æ–°ï¼šæ•°æ®å˜åŒ–å¾ˆå¿«
â”œâ”€ ğŸ¯ å¼ºä¸€è‡´æ€§è¦æ±‚ï¼šé‡‘èäº¤æ˜“ç­‰
â”œâ”€ ğŸ’¾ æ•°æ®é‡å·¨å¤§ï¼šå•æ¡è®°å½•è¶…è¿‡1MB
â””â”€ ğŸ”’ æ•æ„Ÿæ•°æ®ï¼šå®‰å…¨è¦æ±‚æé«˜
```

---

## 2. ğŸ”‘ ç¼“å­˜é”®è®¾è®¡ç­–ç•¥


### 2.1 é”®å‘½åè§„èŒƒ


åˆç†çš„ç¼“å­˜é”®è®¾è®¡æ˜¯Redisç¼“å­˜ç³»ç»Ÿçš„åŸºç¡€ï¼Œç›´æ¥å½±å“ç¼“å­˜çš„å‘½ä¸­ç‡å’Œç»´æŠ¤æ•ˆç‡ã€‚

```java
// æ ‡å‡†é”®å‘½åæ ¼å¼
String cacheKey = String.format("%s:%s:%s", 
    é¡¹ç›®å‰ç¼€, ä¸šåŠ¡æ¨¡å—, å…·ä½“æ ‡è¯†);

// å®é™…ç¤ºä¾‹
"myapp:user:profile:1001"     // ç”¨æˆ·èµ„æ–™
"myapp:product:detail:5001"   // å•†å“è¯¦æƒ…  
"myapp:order:list:user:1001"  // ç”¨æˆ·è®¢å•åˆ—è¡¨
```

**ğŸ“‹ é”®è®¾è®¡åŸåˆ™**ï¼š

| åŸåˆ™ | **è¯´æ˜** | **ç¤ºä¾‹** |
|------|----------|----------|
| ğŸ¯ **å±‚æ¬¡æ¸…æ™°** | `ä½¿ç”¨å†’å·åˆ†éš”ä¸åŒå±‚æ¬¡` | `shop:user:1001` |
| ğŸ“ **é•¿åº¦é€‚ä¸­** | `é¿å…è¿‡é•¿ï¼Œæ§åˆ¶åœ¨100å­—ç¬¦å†…` | `user:1001` ä¼˜äº `user_profile_data_1001` |
| ğŸ”¤ **å‘½åç»Ÿä¸€** | `ä½¿ç”¨ä¸€è‡´çš„å‘½åé£æ ¼` | å…¨éƒ¨å°å†™+ä¸‹åˆ’çº¿ |
| ğŸš« **é¿å…ç‰¹æ®Šå­—ç¬¦** | `ä¸ä½¿ç”¨ç©ºæ ¼ã€ä¸­æ–‡ç­‰` | ä½¿ç”¨è‹±æ–‡å’Œæ•°å­— |

### 2.2 é”®ç”Ÿæˆç­–ç•¥


```java
@Component
public class CacheKeyGenerator {
    
    private static final String SEPARATOR = ":";
    private static final String APP_PREFIX = "myapp";
    
    // ç”¨æˆ·ç›¸å…³ç¼“å­˜é”®
    public String userProfileKey(Long userId) {
        return String.join(SEPARATOR, APP_PREFIX, "user", "profile", String.valueOf(userId));
    }
    
    // SQLæŸ¥è¯¢ç»“æœç¼“å­˜é”®ï¼ˆåŸºäºSQLå’Œå‚æ•°ç”ŸæˆMD5ï¼‰
    public String queryResultKey(String sql, Object... params) {
        String combined = sql + Arrays.toString(params);
        String hash = DigestUtils.md5Hex(combined);
        return String.join(SEPARATOR, APP_PREFIX, "query", hash);
    }
    
    // åˆ†é¡µæŸ¥è¯¢ç¼“å­˜é”®
    public String pageQueryKey(String table, int page, int size, String conditions) {
        return String.join(SEPARATOR, APP_PREFIX, "page", table, 
                          String.valueOf(page), String.valueOf(size), 
                          DigestUtils.md5Hex(conditions));
    }
}
```

### 2.3 é”®è¿‡æœŸæ—¶é—´ç­–ç•¥


```java
public enum CacheExpiration {
    VERY_SHORT(60),        // 1åˆ†é’Ÿ - å®æ—¶æ€§è¦æ±‚é«˜
    SHORT(300),            // 5åˆ†é’Ÿ - ä¸€èˆ¬æŸ¥è¯¢
    MEDIUM(1800),          // 30åˆ†é’Ÿ - ç¨³å®šæ•°æ®
    LONG(3600),            // 1å°æ—¶ - åŸºç¡€æ•°æ®
    VERY_LONG(86400);      // 24å°æ—¶ - é…ç½®æ•°æ®
    
    private final int seconds;
    
    CacheExpiration(int seconds) {
        this.seconds = seconds;
    }
}
```

---

## 3. ğŸ’¾ æ•°æ®åºåˆ—åŒ–æ–¹æ¡ˆ


### 3.1 åºåˆ—åŒ–æ–¹å¼å¯¹æ¯”


é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼ç›´æ¥å½±å“ç¼“å­˜çš„æ€§èƒ½å’Œå­˜å‚¨æ•ˆç‡ã€‚

| åºåˆ—åŒ–æ–¹å¼ | **æ€§èƒ½** | **å­˜å‚¨å¤§å°** | **å¯è¯»æ€§** | **é€‚ç”¨åœºæ™¯** |
|------------|----------|--------------|------------|--------------|
| ğŸ”¤ **JSON** | `ä¸­ç­‰` | `å¤§` | `é«˜` | `è°ƒè¯•å‹å¥½ï¼Œè·¨è¯­è¨€` |
| ğŸ—œï¸ **Protobuf** | `é«˜` | `å°` | `ä½` | `é«˜æ€§èƒ½åœºæ™¯` |
| â˜• **JavaåŸç”Ÿ** | `ä½` | `å¤§` | `ä½` | `Javaå†…éƒ¨ä½¿ç”¨` |
| ğŸ“¦ **Kryo** | `é«˜` | `ä¸­` | `ä½` | `Javaé«˜æ€§èƒ½åºåˆ—åŒ–` |

### 3.2 JSONåºåˆ—åŒ–å®ç°


```java
@Component
public class JsonCacheSerializer {
    
    private final ObjectMapper objectMapper;
    
    public JsonCacheSerializer() {
        this.objectMapper = new ObjectMapper();
        // é…ç½®åºåˆ—åŒ–é€‰é¡¹
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.setDateFormat(new SimpleDateFormat("yyyy-MM-dd HH:mm:ss"));
    }
    
    // åºåˆ—åŒ–å¯¹è±¡ä¸ºJSONå­—ç¬¦ä¸²
    public String serialize(Object obj) {
        try {
            return objectMapper.writeValueAsString(obj);
        } catch (Exception e) {
            throw new CacheException("åºåˆ—åŒ–å¤±è´¥", e);
        }
    }
    
    // ååºåˆ—åŒ–JSONå­—ç¬¦ä¸²ä¸ºå¯¹è±¡
    public <T> T deserialize(String json, Class<T> clazz) {
        try {
            return objectMapper.readValue(json, clazz);
        } catch (Exception e) {
            throw new CacheException("ååºåˆ—åŒ–å¤±è´¥", e);
        }
    }
}
```

### 3.3 ç¼“å­˜æ•°æ®ç»“æ„è®¾è®¡


```java
// ç¼“å­˜å€¼åŒ…è£…ç±»
@Data
public class CacheValue<T> {
    private T data;                    // å®é™…æ•°æ®
    private long createTime;           // åˆ›å»ºæ—¶é—´
    private long accessTime;           // æœ€åè®¿é—®æ—¶é—´
    private int accessCount;           // è®¿é—®æ¬¡æ•°
    private String version;            // æ•°æ®ç‰ˆæœ¬å·
    
    public static <T> CacheValue<T> of(T data) {
        CacheValue<T> cacheValue = new CacheValue<>();
        cacheValue.data = data;
        cacheValue.createTime = System.currentTimeMillis();
        cacheValue.accessTime = System.currentTimeMillis();
        cacheValue.accessCount = 0;
        cacheValue.version = UUID.randomUUID().toString();
        return cacheValue;
    }
}

// ç”¨æˆ·ç¼“å­˜æ•°æ®ç¤ºä¾‹
@Data
public class UserCacheData {
    private Long userId;
    private String username;
    private String email;
    private Integer status;
    private Date lastLoginTime;
    
    // ä»æ•°æ®åº“å®ä½“è½¬æ¢
    public static UserCacheData fromEntity(User user) {
        UserCacheData cacheData = new UserCacheData();
        BeanUtils.copyProperties(user, cacheData);
        return cacheData;
    }
}
```

---

## 4. â° TTLè¿‡æœŸè®¾ç½®


### 4.1 TTLè®¾ç½®ç­–ç•¥


TTL(Time To Live)è®¾ç½®éœ€è¦å¹³è¡¡æ•°æ®å®æ—¶æ€§å’Œç¼“å­˜å‘½ä¸­ç‡ã€‚

```
TTLè®¾ç½®åŸåˆ™ï¼š
â”Œâ”€ æ•°æ®æ›´æ–°é¢‘ç‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ›´æ–°é¢‘ç¹ â†’ çŸ­TTL          â”‚
â”‚ æ›´æ–°è¾ƒå°‘ â†’ ä¸­ç­‰TTL        â”‚  
â”‚ åŸºæœ¬ä¸å˜ â†’ é•¿TTL          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ä¸šåŠ¡é‡è¦ç¨‹åº¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ ¸å¿ƒä¸šåŠ¡ â†’ çŸ­TTLä¿è¯å®æ—¶æ€§  â”‚
â”‚ è¾…åŠ©åŠŸèƒ½ â†’ é•¿TTLæå‡æ€§èƒ½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 åŠ¨æ€TTLè®¡ç®—


```java
@Service
public class TTLCalculator {
    
    // æ ¹æ®æ•°æ®ç±»å‹è®¡ç®—TTL
    public int calculateTTL(String dataType, Object data) {
        switch (dataType) {
            case "user_session":
                return 1800; // 30åˆ†é’Ÿ
            case "user_profile":
                return calculateProfileTTL(data);
            case "product_info":
                return 3600; // 1å°æ—¶
            case "config_data":
                return 86400; // 24å°æ—¶
            default:
                return 300; // é»˜è®¤5åˆ†é’Ÿ
        }
    }
    
    // ç”¨æˆ·èµ„æ–™TTLè®¡ç®—ï¼ˆåŸºäºæ´»è·ƒåº¦ï¼‰
    private int calculateProfileTTL(Object data) {
        if (data instanceof UserCacheData) {
            UserCacheData user = (UserCacheData) data;
            Date lastLogin = user.getLastLoginTime();
            
            // æ´»è·ƒç”¨æˆ·çŸ­TTLï¼Œä¸æ´»è·ƒç”¨æˆ·é•¿TTL
            long daysSinceLogin = Duration.between(
                lastLogin.toInstant(), Instant.now()).toDays();
            
            if (daysSinceLogin <= 1) return 600;    // 10åˆ†é’Ÿ
            if (daysSinceLogin <= 7) return 1800;   // 30åˆ†é’Ÿ  
            return 3600; // 1å°æ—¶
        }
        return 1800; // é»˜è®¤30åˆ†é’Ÿ
    }
}
```

### 4.3 TTLç›‘æ§ä¸è°ƒä¼˜


```java
@Component
public class TTLMonitor {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    // ç›‘æ§keyçš„å‰©ä½™TTL
    public void monitorKeyTTL(String keyPattern) {
        Set<String> keys = redisTemplate.keys(keyPattern);
        
        Map<String, Long> ttlStats = new HashMap<>();
        for (String key : keys) {
            Long ttl = redisTemplate.getExpire(key);
            ttlStats.put(key, ttl);
        }
        
        // åˆ†æTTLåˆ†å¸ƒ
        analyzeTTLDistribution(ttlStats);
    }
    
    // TTLåˆ†å¸ƒåˆ†æ
    private void analyzeTTLDistribution(Map<String, Long> ttlStats) {
        long expiredCount = ttlStats.values().stream()
            .mapToLong(ttl -> ttl <= 0 ? 1 : 0).sum();
        
        double expiredRate = (double) expiredCount / ttlStats.size();
        
        if (expiredRate > 0.3) {
            // è¿‡æœŸç‡è¿‡é«˜ï¼Œè€ƒè™‘å»¶é•¿TTL
            log.warn("TTLè¿‡æœŸç‡è¿‡é«˜: {}%, å»ºè®®è°ƒæ•´TTLè®¾ç½®", expiredRate * 100);
        }
    }
}
```

---

## 5. ğŸ”„ ç¼“å­˜æ›´æ–°æ¨¡å¼


### 5.1 ç¼“å­˜æ›´æ–°ç­–ç•¥å¯¹æ¯”


```
ç¼“å­˜æ›´æ–°æ¨¡å¼é€‰æ‹©ï¼š

ğŸ”„ **Cache-Aside (æ—è·¯ç¼“å­˜)**
åº”ç”¨ â†’ æŸ¥ç¼“å­˜ â†’ æœªå‘½ä¸­ â†’ æŸ¥DB â†’ å†™ç¼“å­˜ â†’ è¿”å›
ä¼˜ç‚¹ï¼šç®€å•å¯æ§ï¼Œåº”ç”¨å®Œå…¨æ§åˆ¶ç¼“å­˜é€»è¾‘
ç¼ºç‚¹ï¼šä»£ç å¤æ‚åº¦é«˜ï¼Œå®¹æ˜“å‡ºç°ä¸ä¸€è‡´

ğŸ“ **Write-Through (å†™é€šç¼“å­˜)**  
åº”ç”¨ â†’ å†™ç¼“å­˜ â†’ ç¼“å­˜åŒæ­¥å†™DB â†’ è¿”å›
ä¼˜ç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¥½
ç¼ºç‚¹ï¼šå†™å»¶è¿Ÿé«˜ï¼Œæ¯æ¬¡éƒ½è¦å†™DB

âš¡ **Write-Behind (å†™å›ç¼“å­˜)**
åº”ç”¨ â†’ å†™ç¼“å­˜ â†’ è¿”å›ï¼Œå¼‚æ­¥å†™DB
ä¼˜ç‚¹ï¼šå†™æ€§èƒ½å¥½
ç¼ºç‚¹ï¼šæ•°æ®å¯èƒ½ä¸¢å¤±ï¼Œå¤æ‚åº¦é«˜
```

### 5.2 Cache-Asideæ¨¡å¼å®ç°


```java
@Service
public class CacheAsideService {
    
    private final RedisTemplate<String, String> redisTemplate;
    private final UserMapper userMapper;
    private final CacheKeyGenerator keyGenerator;
    private final JsonCacheSerializer serializer;
    
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆCache-Asideæ¨¡å¼ï¼‰
    public UserCacheData getUserById(Long userId) {
        String cacheKey = keyGenerator.userProfileKey(userId);
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        String cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return serializer.deserialize(cached, UserCacheData.class);
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        User user = userMapper.selectById(userId);
        if (user == null) {
            return null;
        }
        
        // 3. å†™å…¥ç¼“å­˜
        UserCacheData cacheData = UserCacheData.fromEntity(user);
        String jsonData = serializer.serialize(cacheData);
        redisTemplate.opsForValue().set(cacheKey, jsonData, 
            Duration.ofSeconds(1800)); // 30åˆ†é’Ÿè¿‡æœŸ
        
        return cacheData;
    }
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    public void updateUser(Long userId, User user) {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        userMapper.updateById(user);
        
        // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°åŠ è½½ï¼‰
        String cacheKey = keyGenerator.userProfileKey(userId);
        redisTemplate.delete(cacheKey);
    }
}
```

### 5.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


```java
@Service
public class CacheConsistencyService {
    
    // åŒåˆ é™¤ç­–ç•¥ï¼ˆè§£å†³æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼‰
    @Transactional
    public void updateUserWithDoubleDelete(Long userId, User user) {
        String cacheKey = keyGenerator.userProfileKey(userId);
        
        // ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
        redisTemplate.delete(cacheKey);
        
        try {
            // æ›´æ–°æ•°æ®åº“
            userMapper.updateById(user);
            
            // å»¶æ—¶ç¬¬äºŒæ¬¡åˆ é™¤ï¼ˆå¤„ç†å¹¶å‘æƒ…å†µï¼‰
            CompletableFuture.delayedExecutor(500, TimeUnit.MILLISECONDS)
                .execute(() -> redisTemplate.delete(cacheKey));
                
        } catch (Exception e) {
            // å›æ»šæ—¶æ¢å¤ç¼“å­˜
            log.error("æ›´æ–°ç”¨æˆ·å¤±è´¥ï¼ŒuserId: " + userId, e);
            throw e;
        }
    }
}
```

---

## 6. ğŸ—ï¸ ä¸»ä»ç¼“å­˜æ¶æ„


### 6.1 Redisä¸»ä»æ¶æ„è®¾è®¡


Redisä¸»ä»æ¶æ„é€šè¿‡æ•°æ®å¤åˆ¶å®ç°è¯»å†™åˆ†ç¦»ï¼Œæå‡ç¼“å­˜æœåŠ¡çš„æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚

```
Redisä¸»ä»æ¶æ„ï¼š
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åº”ç”¨æœåŠ¡å™¨   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”
â”‚Master â”‚ â”‚Slave1â”‚ â”‚Slave2â”‚
â”‚(å†™)   â”‚ â”‚(è¯»)  â”‚ â”‚(è¯»)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â–²        â–²
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      æ•°æ®åŒæ­¥å¤åˆ¶
```

### 6.2 è¯»å†™åˆ†ç¦»å®ç°


```java
@Configuration
public class RedisConfig {
    
    // ä¸»åº“é…ç½®ï¼ˆå†™æ“ä½œï¼‰
    @Bean("masterRedisTemplate")
    public RedisTemplate<String, String> masterRedisTemplate() {
        RedisTemplate<String, String> template = new RedisTemplate<>();
        
        LettuceConnectionFactory factory = new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("master-redis", 6379));
        template.setConnectionFactory(factory);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        return template;
    }
    
    // ä»åº“é…ç½®ï¼ˆè¯»æ“ä½œï¼‰
    @Bean("slaveRedisTemplate")  
    public RedisTemplate<String, String> slaveRedisTemplate() {
        RedisTemplate<String, String> template = new RedisTemplate<>();
        
        LettuceConnectionFactory factory = new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("slave-redis", 6379));
        template.setConnectionFactory(factory);
        
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        return template;
    }
}

@Service
public class MasterSlaveRedisService {
    
    @Resource(name = "masterRedisTemplate")
    private RedisTemplate<String, String> masterRedis;
    
    @Resource(name = "slaveRedisTemplate")
    private RedisTemplate<String, String> slaveRedis;
    
    // å†™æ“ä½œä½¿ç”¨ä¸»åº“
    public void set(String key, String value, Duration expiration) {
        masterRedis.opsForValue().set(key, value, expiration);
    }
    
    // è¯»æ“ä½œä½¿ç”¨ä»åº“
    public String get(String key) {
        return slaveRedis.opsForValue().get(key);
    }
}
```

### 6.3 ä¸»ä»åˆ‡æ¢æœºåˆ¶


```java
@Component
public class RedisFailoverHandler {
    
    private volatile boolean masterAvailable = true;
    private final List<RedisTemplate<String, String>> slaveTemplates;
    
    // å¥åº·æ£€æŸ¥
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkMasterHealth() {
        try {
            masterRedis.opsForValue().get("health_check");
            if (!masterAvailable) {
                masterAvailable = true;
                log.info("Redisä¸»åº“æ¢å¤æ­£å¸¸");
            }
        } catch (Exception e) {
            if (masterAvailable) {
                masterAvailable = false;
                log.error("Redisä¸»åº“ä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°åªè¯»æ¨¡å¼");
            }
        }
    }
    
    // æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®ä¸»åº“çŠ¶æ€é€‰æ‹©æ“ä½œæ–¹å¼
    public String smartGet(String key) {
        // è¯»æ“ä½œä¼˜å…ˆä½¿ç”¨ä»åº“
        return getFromSlave(key);
    }
    
    public void smartSet(String key, String value, Duration expiration) {
        if (masterAvailable) {
            masterRedis.opsForValue().set(key, value, expiration);
        } else {
            log.warn("ä¸»åº“ä¸å¯ç”¨ï¼Œå†™æ“ä½œå¤±è´¥: " + key);
            throw new CacheException("ç¼“å­˜å†™å…¥å¤±è´¥ï¼Œä¸»åº“ä¸å¯ç”¨");
        }
    }
}
```

---

## 7. ğŸŒ ç¼“å­˜é›†ç¾¤éƒ¨ç½²


### 7.1 Redis Clusteræ¶æ„


```
Redis Clusteråˆ†ç‰‡æ¶æ„ï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         åº”ç”¨å±‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        Rediså®¢æˆ·ç«¯              â”‚
    â”‚    (é›†ç¾¤è·¯ç”±å’Œæ•…éšœè½¬ç§»)         â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚           â”‚             â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
   â”‚Node1  â”‚   â”‚Node2  â”‚     â”‚Node3  â”‚
   â”‚Master â”‚   â”‚Master â”‚     â”‚Master â”‚
   â”‚0-5460 â”‚   â”‚5461   â”‚     â”‚10923  â”‚
   â”‚       â”‚   â”‚-10922 â”‚     â”‚-16383 â”‚
   â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚           â”‚             â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
   â”‚Slave1 â”‚   â”‚Slave2 â”‚     â”‚Slave3 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 é›†ç¾¤é…ç½®å®ç°


```java
@Configuration
public class RedisClusterConfig {
    
    @Value("${redis.cluster.nodes}")
    private String clusterNodes;
    
    @Value("${redis.cluster.max-redirects:3}")
    private int maxRedirects;
    
    @Bean
    public RedisConnectionFactory redisConnectionFactory() {
        // è§£æé›†ç¾¤èŠ‚ç‚¹
        String[] nodes = clusterNodes.split(",");
        Set<RedisNode> redisNodes = Arrays.stream(nodes)
            .map(node -> {
                String[] parts = node.split(":");
                return new RedisNode(parts[0], Integer.parseInt(parts[1]));
            })
            .collect(Collectors.toSet());
        
        // é›†ç¾¤é…ç½®
        RedisClusterConfiguration clusterConfig = 
            new RedisClusterConfiguration();
        clusterConfig.setClusterNodes(redisNodes);
        clusterConfig.setMaxRedirects(maxRedirects);
        
        // è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig<Connection> poolConfig = 
            new GenericObjectPoolConfig<>();
        poolConfig.setMaxTotal(20);
        poolConfig.setMaxIdle(10);
        poolConfig.setMinIdle(5);
        
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(poolConfig)
                .build();
        
        return new LettuceConnectionFactory(clusterConfig, clientConfig);
    }
    
    @Bean
    public RedisTemplate<String, String> clusterRedisTemplate() {
        RedisTemplate<String, String> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory());
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        return template;
    }
}
```

### 7.3 é›†ç¾¤ç›‘æ§ä¸ç®¡ç†


```java
@Service
public class RedisClusterMonitor {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    // è·å–é›†ç¾¤ä¿¡æ¯
    public ClusterInfo getClusterInfo() {
        return redisTemplate.execute((RedisCallback<ClusterInfo>) connection -> {
            RedisClusterConnection clusterConnection = 
                (RedisClusterConnection) connection;
            
            Properties info = clusterConnection.info("cluster");
            
            return ClusterInfo.builder()
                .state(info.getProperty("cluster_state"))
                .slotsAssigned(Integer.parseInt(info.getProperty("cluster_slots_assigned")))
                .slotsOk(Integer.parseInt(info.getProperty("cluster_slots_ok")))
                .slotsFail(Integer.parseInt(info.getProperty("cluster_slots_fail")))
                .knownNodes(Integer.parseInt(info.getProperty("cluster_known_nodes")))
                .build();
        });
    }
    
    // ç›‘æ§èŠ‚ç‚¹çŠ¶æ€
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥
    public void monitorClusterHealth() {
        try {
            ClusterInfo info = getClusterInfo();
            
            if (!"ok".equals(info.getState())) {
                log.error("Redisé›†ç¾¤çŠ¶æ€å¼‚å¸¸: {}", info.getState());
                // å‘é€å‘Šè­¦
                sendAlert("Redisé›†ç¾¤çŠ¶æ€å¼‚å¸¸", info);
            }
            
            if (info.getSlotsFail() > 0) {
                log.warn("Redisé›†ç¾¤æœ‰{}ä¸ªæ’æ§½å¤±è´¥", info.getSlotsFail());
            }
            
        } catch (Exception e) {
            log.error("Redisé›†ç¾¤ç›‘æ§å¤±è´¥", e);
        }
    }
}
```

---

## 8. âš¡ Redisç¼“å­˜ä¼˜åŒ–ç­–ç•¥


### 8.1 å†…å­˜ä¼˜åŒ–ç­–ç•¥


```
å†…å­˜ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™ï¼š
â”Œâ”€ æ•°æ®ç»“æ„é€‰æ‹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Stringï¼šç®€å•å€¼å­˜å‚¨       â”‚
â”‚ â€¢ Hashï¼šå¯¹è±¡å­—æ®µå­˜å‚¨       â”‚  
â”‚ â€¢ Listï¼šæœ‰åºé˜Ÿåˆ—           â”‚
â”‚ â€¢ Setï¼šå»é‡é›†åˆ            â”‚
â”‚ â€¢ ZSetï¼šæ’åºé›†åˆ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ å‹ç¼©ç®—æ³• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ å¯ç”¨å‹ç¼©ï¼šèŠ‚çœç©ºé—´50%+   â”‚
â”‚ â€¢ åˆç†é…ç½®å‹ç¼©é˜ˆå€¼         â”‚
â”‚ â€¢ å¹³è¡¡CPUä¸å†…å­˜å¼€é”€        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ•°æ®ç»“æ„ä¼˜åŒ–


```java
@Service
public class RedisOptimizationService {
    
    // ä½¿ç”¨Hashå­˜å‚¨å¯¹è±¡ï¼ˆæ¯”Stringå­˜å‚¨JSONæ›´çœå†…å­˜ï¼‰
    public void saveUserOptimized(Long userId, User user) {
        String key = "user:" + userId;
        
        Map<String, String> userFields = new HashMap<>();
        userFields.put("id", String.valueOf(user.getId()));
        userFields.put("username", user.getUsername());
        userFields.put("email", user.getEmail());
        userFields.put("status", String.valueOf(user.getStatus()));
        
        redisTemplate.opsForHash().putAll(key, userFields);
        redisTemplate.expire(key, Duration.ofMinutes(30));
    }
    
    // æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼ˆä½¿ç”¨Pipelineï¼‰
    public void batchSaveUsers(List<User> users) {
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            users.forEach(user -> {
                String key = "user:" + user.getId();
                Map<String, String> fields = convertUserToMap(user);
                
                connection.hMSet(key.getBytes(), 
                    fields.entrySet().stream().collect(
                        Collectors.toMap(
                            e -> e.getKey().getBytes(),
                            e -> e.getValue().getBytes()
                        )
                    )
                );
                connection.expire(key.getBytes(), 1800);
            });
            return null;
        });
    }
}
```

### 8.3 æ€§èƒ½è°ƒä¼˜é…ç½®


```bash
# redis.conf ä¼˜åŒ–é…ç½®

# å†…å­˜ç­–ç•¥
maxmemory 2gb
maxmemory-policy allkeys-lru

# æŒä¹…åŒ–ä¼˜åŒ–
save 900 1      # 900ç§’å†…1ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
save 300 10     # 300ç§’å†…10ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜  
save 60 10000   # 60ç§’å†…10000ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜

# ç½‘ç»œä¼˜åŒ–
tcp-keepalive 60
timeout 300

# å‹ç¼©é…ç½®
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
```

---

## 9. ğŸ“Š ç¼“å­˜æ•°æ®åˆ†ç‰‡ç­–ç•¥


### 9.1 åˆ†ç‰‡ç®—æ³•é€‰æ‹©


```
åˆ†ç‰‡ç­–ç•¥å¯¹æ¯”ï¼š
â”Œâ”€ å“ˆå¸Œåˆ†ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®—æ³•ï¼šhash(key) % èŠ‚ç‚¹æ•°   â”‚
â”‚ ä¼˜ç‚¹ï¼šåˆ†å¸ƒå‡åŒ€            â”‚
â”‚ ç¼ºç‚¹ï¼šæ‰©å®¹éœ€è¦é‡æ–°åˆ†ç‰‡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ä¸€è‡´æ€§å“ˆå¸Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚ ç®—æ³•ï¼šå“ˆå¸Œç¯ + è™šæ‹ŸèŠ‚ç‚¹    â”‚
â”‚ ä¼˜ç‚¹ï¼šæ‰©å®¹å½±å“å°          â”‚
â”‚ ç¼ºç‚¹ï¼šå¯èƒ½åˆ†å¸ƒä¸å‡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ èŒƒå›´åˆ†ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®—æ³•ï¼šæŒ‰keyèŒƒå›´åˆ†é…       â”‚
â”‚ ä¼˜ç‚¹ï¼šèŒƒå›´æŸ¥è¯¢å‹å¥½        â”‚
â”‚ ç¼ºç‚¹ï¼šçƒ­ç‚¹æ•°æ®é›†ä¸­        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ä¸€è‡´æ€§å“ˆå¸Œå®ç°


```java
@Component
public class ConsistentHashSharding {
    
    private final TreeMap<Long, RedisTemplate<String, String>> ring = new TreeMap<>();
    private final int virtualNodes = 150; // è™šæ‹ŸèŠ‚ç‚¹æ•°
    
    public void addNode(String nodeId, RedisTemplate<String, String> redisTemplate) {
        for (int i = 0; i < virtualNodes; i++) {
            String virtualNodeId = nodeId + ":" + i;
            long hash = hash(virtualNodeId);
            ring.put(hash, redisTemplate);
        }
    }
    
    public RedisTemplate<String, String> getNode(String key) {
        if (ring.isEmpty()) {
            throw new IllegalStateException("æ²¡æœ‰å¯ç”¨çš„RedisèŠ‚ç‚¹");
        }
        
        long hash = hash(key);
        Map.Entry<Long, RedisTemplate<String, String>> entry = ring.ceilingEntry(hash);
        
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç¯å½¢ï¼‰
        if (entry == null) {
            entry = ring.firstEntry();
        }
        
        return entry.getValue();
    }
    
    private long hash(String key) {
        // ä½¿ç”¨MD5ç”Ÿæˆå“ˆå¸Œå€¼
        try {
            MessageDigest md = MessageDigest.getInstance("MD5");
            byte[] digest = md.digest(key.getBytes());
            
            long hash = 0;
            for (int i = 0; i < 4; i++) {
                hash <<= 8;
                hash |= ((int) digest[i]) & 0xFF;
            }
            return hash;
        } catch (Exception e) {
            throw new RuntimeException("å“ˆå¸Œè®¡ç®—å¤±è´¥", e);
        }
    }
}

@Service
public class ShardedCacheService {
    
    private final ConsistentHashSharding sharding;
    
    public void set(String key, String value, Duration expiration) {
        RedisTemplate<String, String> redis = sharding.getNode(key);
        redis.opsForValue().set(key, value, expiration);
    }
    
    public String get(String key) {
        RedisTemplate<String, String> redis = sharding.getNode(key);
        return redis.opsForValue().get(key);
    }
}
```

### 9.3 åˆ†ç‰‡ç›‘æ§


```java
@Service
public class ShardingMonitorService {
    
    // ç›‘æ§å„åˆ†ç‰‡è´Ÿè½½å‡è¡¡æƒ…å†µ
    public ShardingStats getShardingStats() {
        Map<String, Long> shardKeyCount = new HashMap<>();
        Map<String, Long> shardMemoryUsage = new HashMap<>();
        
        // ç»Ÿè®¡æ¯ä¸ªåˆ†ç‰‡çš„keyæ•°é‡å’Œå†…å­˜ä½¿ç”¨
        sharding.getAllNodes().forEach((nodeId, redisTemplate) -> {
            try {
                // è·å–keyæ•°é‡
                Long keyCount = redisTemplate.execute((RedisCallback<Long>) connection -> 
                    connection.dbSize());
                shardKeyCount.put(nodeId, keyCount);
                
                // è·å–å†…å­˜ä½¿ç”¨
                Properties info = redisTemplate.execute((RedisCallback<Properties>) connection ->
                    connection.info("memory"));
                String memoryStr = info.getProperty("used_memory");
                Long memory = Long.parseLong(memoryStr);
                shardMemoryUsage.put(nodeId, memory);
                
            } catch (Exception e) {
                log.error("è·å–åˆ†ç‰‡{}ç»Ÿè®¡ä¿¡æ¯å¤±è´¥", nodeId, e);
            }
        });
        
        return ShardingStats.builder()
            .shardKeyCount(shardKeyCount)
            .shardMemoryUsage(shardMemoryUsage)
            .build();
    }
}
```

---

## 10. ğŸ” ç¼“å­˜é«˜å¯ç”¨æ¶æ„


### 10.1 å¤šçº§ç¼“å­˜æ¶æ„


```
å¤šçº§ç¼“å­˜æ¶æ„è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨å±‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æœ¬åœ°ç¼“å­˜                â”‚
â”‚        (Caffeine/Guava)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Redisåˆ†å¸ƒå¼ç¼“å­˜          â”‚
â”‚       (ä¸»ä» + å“¨å…µ/é›†ç¾¤)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQLæ•°æ®åº“            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 æœ¬åœ°ç¼“å­˜+RedisäºŒçº§ç¼“å­˜


```java
@Configuration
public class MultiLevelCacheConfig {
    
    @Bean
    public Cache<String, Object> localCache() {
        return Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .recordStats()
            .build();
    }
}

@Service
public class MultiLevelCacheService {
    
    private final Cache<String, Object> localCache;
    private final RedisTemplate<String, String> redisTemplate;
    private final JsonCacheSerializer serializer;
    
    public <T> T get(String key, Class<T> clazz) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        Object localValue = localCache.getIfPresent(key);
        if (localValue != null) {
            return (T) localValue;
        }
        
        // 2. æŸ¥Redisç¼“å­˜
        String redisValue = redisTemplate.opsForValue().get(key);
        if (redisValue != null) {
            T value = serializer.deserialize(redisValue, clazz);
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
            return value;
        }
        
        return null;
    }
    
    public void put(String key, Object value, Duration redisTTL) {
        // åŒæ—¶å†™å…¥æœ¬åœ°ç¼“å­˜å’ŒRedis
        localCache.put(key, value);
        
        String jsonValue = serializer.serialize(value);
        redisTemplate.opsForValue().set(key, jsonValue, redisTTL);
    }
    
    public void evict(String key) {
        // åŒæ—¶æ¸…é™¤æœ¬åœ°ç¼“å­˜å’ŒRedis
        localCache.invalidate(key);
        redisTemplate.delete(key);
    }
}
```

### 10.3 ç¼“å­˜é›ªå´©é˜²æŠ¤


```java
@Service
public class CacheAvalancheProtection {
    
    private final Semaphore semaphore = new Semaphore(100); // é™åˆ¶å¹¶å‘
    private final Map<String, CompletableFuture<Object>> loadingCache = new ConcurrentHashMap<>();
    
    // é˜²ç¼“å­˜é›ªå´©çš„æŸ¥è¯¢æ–¹æ³•
    public <T> T getWithProtection(String key, Class<T> clazz, Supplier<T> dbLoader) {
        // 1. æ­£å¸¸æŸ¥è¯¢ç¼“å­˜
        T cached = multiLevelCacheService.get(key, clazz);
        if (cached != null) {
            return cached;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨ä¿æŠ¤æœºåˆ¶
        try {
            // è·å–è®¸å¯è¯ï¼Œé™åˆ¶å¹¶å‘æ•°æ®åº“æŸ¥è¯¢
            if (!semaphore.tryAcquire(100, TimeUnit.MILLISECONDS)) {
                // é™çº§ç­–ç•¥ï¼šè¿”å›é»˜è®¤å€¼æˆ–æŠ›å‡ºå¼‚å¸¸
                return getDefaultValue(clazz);
            }
            
            // 3. é¿å…ç¼“å­˜å‡»ç©¿ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æŸ¥è¯¢åŒä¸€ä¸ªkey
            CompletableFuture<Object> future = loadingCache.computeIfAbsent(key, k -> 
                CompletableFuture.supplyAsync(() -> {
                    try {
                        T value = dbLoader.get();
                        if (value != null) {
                            // æ·»åŠ éšæœºTTLï¼Œé¿å…é›†ä½“è¿‡æœŸ
                            Duration ttl = Duration.ofMinutes(30 + new Random().nextInt(10));
                            multiLevelCacheService.put(key, value, ttl);
                        }
                        return value;
                    } finally {
                        loadingCache.remove(k);
                        semaphore.release();
                    }
                })
            );
            
            return (T) future.get(1, TimeUnit.SECONDS);
            
        } catch (Exception e) {
            log.error("ç¼“å­˜ä¿æŠ¤æŸ¥è¯¢å¤±è´¥, key: " + key, e);
            return getDefaultValue(clazz);
        }
    }
    
    private <T> T getDefaultValue(Class<T> clazz) {
        // è¿”å›ç±»å‹çš„é»˜è®¤å€¼æˆ–ç©ºå¯¹è±¡
        if (clazz == String.class) return (T) "";
        if (clazz == List.class) return (T) Collections.emptyList();
        // å…¶ä»–ç±»å‹è¿”å›nullæˆ–åˆ›å»ºç©ºå¯¹è±¡
        return null;
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Redisé›†æˆç¼“å­˜ï¼šåœ¨MySQLå‰ç«¯éƒ¨ç½²å†…å­˜ç¼“å­˜å±‚ï¼Œæ˜¾è‘—æå‡æŸ¥è¯¢æ€§èƒ½
ğŸ”¸ ç¼“å­˜é”®è®¾è®¡ï¼šè§„èŒƒå‘½åã€å±‚æ¬¡æ¸…æ™°ã€é¿å…å†²çªçš„é”®å€¼è®¾è®¡ç­–ç•¥  
ğŸ”¸ æ•°æ®åºåˆ—åŒ–ï¼šé€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼å¹³è¡¡æ€§èƒ½å’Œå­˜å‚¨æ•ˆç‡
ğŸ”¸ TTLç­–ç•¥ï¼šæ ¹æ®æ•°æ®ç‰¹ç‚¹è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
ğŸ”¸ æ›´æ–°æ¨¡å¼ï¼šCache-Asideã€Write-Throughã€Write-Behindä¸‰ç§æ¨¡å¼é€‰æ‹©
ğŸ”¸ é«˜å¯ç”¨æ¶æ„ï¼šä¸»ä»å¤åˆ¶ã€é›†ç¾¤åˆ†ç‰‡ã€å¤šçº§ç¼“å­˜ä¿éšœæœåŠ¡ç¨³å®šæ€§
```

### 11.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ ç¼“å­˜é”®è®¾è®¡åŸåˆ™**
```
âœ… å‘½åè§„èŒƒï¼šé¡¹ç›®:æ¨¡å—:æ ‡è¯†çš„å±‚æ¬¡ç»“æ„
âœ… é•¿åº¦æ§åˆ¶ï¼šæ§åˆ¶åœ¨100å­—ç¬¦ä»¥å†…
âœ… ç‰¹æ®Šå­—ç¬¦ï¼šé¿å…ç©ºæ ¼ã€ä¸­æ–‡ç­‰ç‰¹æ®Šå­—ç¬¦
âœ… å†²çªé¢„é˜²ï¼šä½¿ç”¨MD5å“ˆå¸Œå¤„ç†å¤æ‚å‚æ•°
```

**ğŸ”¹ TTLè®¾ç½®ç­–ç•¥**
```
â° çŸ­TTL(1-5åˆ†é’Ÿ)ï¼šå®æ—¶æ€§è¦æ±‚é«˜çš„æ•°æ®
â° ä¸­TTL(30åˆ†é’Ÿ-1å°æ—¶)ï¼šä¸€èˆ¬ä¸šåŠ¡æ•°æ®  
â° é•¿TTL(1-24å°æ—¶)ï¼šé…ç½®ç±»ç¨³å®šæ•°æ®
â° åŠ¨æ€TTLï¼šæ ¹æ®æ•°æ®è®¿é—®é¢‘ç‡è‡ªåŠ¨è°ƒæ•´
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
ğŸš€ æ•°æ®ç»“æ„ï¼šHashå­˜å‚¨å¯¹è±¡æ¯”Stringå­˜å‚¨JSONçœå†…å­˜30%+
ğŸš€ æ‰¹é‡æ“ä½œï¼šä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
ğŸš€ è¿æ¥æ± ï¼šåˆç†é…ç½®è¿æ¥æ± å‚æ•°é¿å…è¿æ¥ç“¶é¢ˆ
ğŸš€ å‹ç¼©ç®—æ³•ï¼šå¯ç”¨å‹ç¼©å¯èŠ‚çœ50%ä»¥ä¸Šå­˜å‚¨ç©ºé—´
```

### 11.3 æ¶æ„é€‰æ‹©æŒ‡å¯¼


```
ğŸ—ï¸ **æ¶æ„é€‰æ‹©çŸ©é˜µ**

å•æœºRedisï¼š
é€‚ç”¨ï¼šQPS < 5ä¸‡ï¼Œæ•°æ®é‡ < 10GB
ä¼˜ç‚¹ï¼šç®€å•æ˜“ç»´æŠ¤ï¼Œæˆæœ¬ä½
ç¼ºç‚¹ï¼šå•ç‚¹æ•…éšœé£é™©

ä¸»ä»æ¶æ„ï¼š  
é€‚ç”¨ï¼šQPS 5-20ä¸‡ï¼Œè¯»å¤šå†™å°‘
ä¼˜ç‚¹ï¼šè¯»å†™åˆ†ç¦»ï¼Œæ•…éšœè½¬ç§»
ç¼ºç‚¹ï¼šä¸»åº“ä»æ˜¯å•ç‚¹

é›†ç¾¤æ¶æ„ï¼š
é€‚ç”¨ï¼šQPS > 20ä¸‡ï¼Œæ•°æ®é‡ > 50GB  
ä¼˜ç‚¹ï¼šæ°´å¹³æ‰©å±•ï¼Œé«˜å¯ç”¨
ç¼ºç‚¹ï¼šè¿ç»´å¤æ‚åº¦é«˜

å¤šçº§ç¼“å­˜ï¼š
é€‚ç”¨ï¼šè¶…é«˜å¹¶å‘ï¼Œæä½å»¶è¿Ÿè¦æ±‚
ä¼˜ç‚¹ï¼šæœ€ä½³æ€§èƒ½ï¼Œå¤šé‡ä¿éšœ
ç¼ºç‚¹ï¼šä¸€è‡´æ€§ç»´æŠ¤å¤æ‚
```

### 11.4 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šå•†å“è¯¦æƒ…ã€åº“å­˜çŠ¶æ€ã€ç”¨æˆ·ä¼šè¯ç¼“å­˜
- **ç¤¾äº¤åº”ç”¨**ï¼šç”¨æˆ·èµ„æ–™ã€å¥½å‹å…³ç³»ã€æ¶ˆæ¯å†å²ç¼“å­˜  
- **å†…å®¹å¹³å°**ï¼šæ–‡ç« å†…å®¹ã€è¯„è®ºæ•°æ®ã€æ¨èåˆ—è¡¨ç¼“å­˜
- **é‡‘èç³»ç»Ÿ**ï¼šè´¦æˆ·ä½™é¢ã€äº¤æ˜“è®°å½•ã€é£æ§è§„åˆ™ç¼“å­˜

**ğŸ”§ è¿ç»´æœ€ä½³å®è·µ**
- **ç›‘æ§å‘Šè­¦**ï¼šç¼“å­˜å‘½ä¸­ç‡ã€å“åº”æ—¶é—´ã€å†…å­˜ä½¿ç”¨ç‡ç›‘æ§
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºä¸šåŠ¡å¢é•¿é¢„æµ‹ç¼“å­˜å®¹é‡éœ€æ±‚
- **æ•…éšœå¤„ç†**ï¼šå»ºç«‹å®Œå–„çš„é™çº§ç­–ç•¥å’Œæ¢å¤æœºåˆ¶
- **æ•°æ®æ²»ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®ï¼Œä¼˜åŒ–å­˜å‚¨ç»“æ„

**ğŸ“ˆ æ€§èƒ½æå‡æ•ˆæœ**
- **å“åº”æ—¶é—´**ï¼šä»100-500msé™ä½åˆ°1-5ms
- **å¹¶å‘èƒ½åŠ›**ï¼šå•æœºQPSä»5000æå‡åˆ°50000+  
- **æ•°æ®åº“å‹åŠ›**ï¼šå‡å°‘70-90%çš„æ•°æ®åº“æŸ¥è¯¢
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢åŠ è½½é€Ÿåº¦æå‡5-10å€

**æ ¸å¿ƒè®°å¿†**ï¼š
- Redisç¼“å­˜æ˜¯MySQLæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ‰‹æ®µ
- åˆç†çš„æ¶æ„è®¾è®¡å’Œé…ç½®è°ƒä¼˜æ˜¯æˆåŠŸçš„å…³é”®
- ç›‘æ§å’Œè¿ç»´ä¿éšœæ˜¯ç¼“å­˜ç³»ç»Ÿç¨³å®šè¿è¡Œçš„åŸºç¡€
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æœ€é€‚åˆçš„ç¼“å­˜ç­–ç•¥å’Œæ¶æ„