---
title: 14ã€ä¹è§‚é”ä¸ç‰ˆæœ¬æ§åˆ¶UPDATEå®ç°
---
## ğŸ“š ç›®å½•

1. [ä¹è§‚é”ä¸æ‚²è§‚é”æ¦‚è¿°](#1-ä¹è§‚é”ä¸æ‚²è§‚é”æ¦‚è¿°)
2. [ç‰ˆæœ¬æ§åˆ¶æ›´æ–°ç­–ç•¥](#2-ç‰ˆæœ¬æ§åˆ¶æ›´æ–°ç­–ç•¥)
3. [ç‰ˆæœ¬å·å­—æ®µè®¾è®¡](#3-ç‰ˆæœ¬å·å­—æ®µè®¾è®¡)
4. [CASæ›´æ–°å®ç°](#4-casæ›´æ–°å®ç°)
5. [æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥](#5-æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥)
6. [å®é™…åº”ç”¨åœºæ™¯](#6-å®é™…åº”ç”¨åœºæ™¯)
7. [æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹](#7-æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¹è§‚é”ä¸æ‚²è§‚é”æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ä¹è§‚é”å’Œæ‚²è§‚é”


**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä½ è¦å»é“¶è¡Œå–é’±ï¼Œæœ‰ä¸¤ç§ä¸åŒçš„æ€è·¯ï¼š

```
æ‚²è§‚é”æ€è·¯ï¼ˆæ‚²è§‚ï¼‰ï¼š
"è¿™ä¸ªä¸–ç•Œå¾ˆå±é™©ï¼Œåˆ«äººå¯èƒ½ä¼šåŠ¨æˆ‘çš„é’±"
â†’ ä¸€è¿›é“¶è¡Œå°±æŠŠä¿é™©åº“é”æ­»
â†’ åªæœ‰æˆ‘èƒ½æ“ä½œï¼Œå…¶ä»–äººéƒ½å¾—ç­‰
â†’ å®‰å…¨ä½†æ•ˆç‡ä½

ä¹è§‚é”æ€è·¯ï¼ˆä¹è§‚ï¼‰ï¼š  
"è¿™ä¸ªä¸–ç•Œè¿˜ä¸é”™ï¼Œå†²çªåº”è¯¥ä¸å¤š"
â†’ å…ˆçœ‹çœ‹è´¦æˆ·ä½™é¢ï¼ˆè®°ä½ç‰ˆæœ¬ï¼‰
â†’ å–é’±æ—¶å†æ£€æŸ¥ä½™é¢æ˜¯å¦è¢«åˆ«äººæ”¹è¿‡
â†’ å¦‚æœè¢«æ”¹è¿‡å°±é‡æ–°æ¥ï¼Œæ²¡æ”¹è¿‡å°±æˆåŠŸ
â†’ æ•ˆç‡é«˜ä½†å¯èƒ½éœ€è¦é‡è¯•
```

### 1.2 æ‚²è§‚é”çš„ç‰¹ç‚¹


**ğŸ”’ æ‚²è§‚é”æœºåˆ¶**
```sql
-- æ‚²è§‚é”ç¤ºä¾‹ï¼šæŸ¥è¯¢æ—¶å°±é”å®šè®°å½•
BEGIN;
SELECT * FROM account WHERE id = 1 FOR UPDATE;  -- ç«‹å³åŠ é”
UPDATE account SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- ç‰¹ç‚¹è¯´æ˜ï¼š
-- âœ“ æŸ¥è¯¢æ—¶å°±è·å–é”ï¼Œç¡®ä¿æ•°æ®ä¸è¢«ä¿®æ”¹
-- âœ“ å…¶ä»–äº‹åŠ¡å¿…é¡»ç­‰å¾…é”é‡Šæ”¾
-- âœ“ é€‚åˆå†²çªé¢‘ç¹çš„åœºæ™¯
-- âœ— å¹¶å‘æ€§èƒ½è¾ƒä½ï¼Œå®¹æ˜“é€ æˆé˜»å¡
```

**ğŸ”„ æ‚²è§‚é”çš„å·¥ä½œæµç¨‹**
```
ç”¨æˆ·A                    æ•°æ®åº“                    ç”¨æˆ·B
  |                        |                        |
  |--å¼€å§‹äº‹åŠ¡------------->|                        |
  |--æŸ¥è¯¢å¹¶åŠ é”----------->|                        |
  |<-è¿”å›æ•°æ®+è·å¾—é”--------|                        |
  |                        |<--æŸ¥è¯¢ç›¸åŒè®°å½•---------|
  |                        |--é˜»å¡ç­‰å¾…----------->|
  |--æ‰§è¡Œæ›´æ–°------------->|                        |
  |--æäº¤äº‹åŠ¡------------->|                        |
  |<-é‡Šæ”¾é”----------------|                        |
  |                        |--è¿”å›æ•°æ®------------>|
```

### 1.3 ä¹è§‚é”çš„ç‰¹ç‚¹


**âœ¨ ä¹è§‚é”æœºåˆ¶**
```sql
-- ä¹è§‚é”ç¤ºä¾‹ï¼šé€šè¿‡ç‰ˆæœ¬æ§åˆ¶å®ç°
-- 1. è¯»å–æ•°æ®æ—¶è®°ä½ç‰ˆæœ¬å·
SELECT id, balance, version FROM account WHERE id = 1;
-- å‡è®¾å¾—åˆ°ï¼šid=1, balance=1000, version=5

-- 2. æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å˜åŒ–
UPDATE account 
SET balance = balance - 100, version = version + 1
WHERE id = 1 AND version = 5;  -- å…³é”®ï¼šæ£€æŸ¥ç‰ˆæœ¬å·

-- 3. æ£€æŸ¥å½±å“çš„è¡Œæ•°
-- å¦‚æœå½±å“0è¡Œï¼Œè¯´æ˜ç‰ˆæœ¬å·²å˜åŒ–ï¼Œéœ€è¦é‡è¯•
-- å¦‚æœå½±å“1è¡Œï¼Œè¯´æ˜æ›´æ–°æˆåŠŸ
```

**ğŸš€ ä¹è§‚é”çš„ä¼˜åŠ¿**
```
é«˜å¹¶å‘æ€§èƒ½ï¼š
- ä¸éœ€è¦æå‰åŠ é”ï¼Œå¤šä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶è¯»å–
- åªåœ¨æ›´æ–°æ—¶è¿›è¡Œå†²çªæ£€æµ‹
- å¤§å¤§æé«˜ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›

èµ„æºåˆ©ç”¨ç‡é«˜ï¼š
- æ²¡æœ‰é”ç­‰å¾…æ—¶é—´
- å‡å°‘æ•°æ®åº“è¿æ¥å ç”¨æ—¶é—´
- é¿å…æ­»é”é—®é¢˜
```

### 1.4 ä¸¤ç§é”çš„åº”ç”¨åœºæ™¯å¯¹æ¯”


| åœºæ™¯ç‰¹ç‚¹ | **æ‚²è§‚é”** | **ä¹è§‚é”** | **æ¨èé€‰æ‹©** |
|---------|-----------|-----------|-------------|
| **è¯»å¤šå†™å°‘** | æ€§èƒ½å·®ï¼Œä¸å¿…è¦çš„é”å¼€é”€ | æ€§èƒ½å¥½ï¼Œå†²çªå°‘ | âœ… ä¹è§‚é” |
| **å†™æ“ä½œé¢‘ç¹** | èƒ½ä¿è¯ä¸€è‡´æ€§ | å†²çªå¤šï¼Œé‡è¯•é¢‘ç¹ | âœ… æ‚²è§‚é” |
| **çŸ­äº‹åŠ¡** | é”æ—¶é—´çŸ­ï¼Œå½±å“å° | å†²çªæ£€æµ‹ç®€å• | âœ… ä¹è§‚é” |
| **é•¿äº‹åŠ¡** | é•¿æ—¶é—´å é” | å†²çªæ¦‚ç‡é«˜ | âš–ï¸ æ ¹æ®ä¸šåŠ¡å†³å®š |
| **é«˜å¹¶å‘** | æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾ | å¹¶å‘æ€§èƒ½å¥½ | âœ… ä¹è§‚é” |

---

## 2. ğŸ“‹ ç‰ˆæœ¬æ§åˆ¶æ›´æ–°ç­–ç•¥


### 2.1 ç‰ˆæœ¬æ§åˆ¶çš„åŸºæœ¬åŸç†


**ğŸ”„ ç‰ˆæœ¬æ§åˆ¶å·¥ä½œåŸç†**
ç‰ˆæœ¬æ§åˆ¶å°±åƒæ˜¯ç»™æ¯æ¡æ•°æ®è®°å½•åŠ ä¸Šä¸€ä¸ª"ä¿®æ”¹è®¡æ•°å™¨"ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½è®©è®¡æ•°å™¨åŠ 1ã€‚

```
æ•°æ®è®°å½•çš„å˜åŒ–è¿‡ç¨‹ï¼š
åˆå§‹çŠ¶æ€: {id: 1, name: "å¼ ä¸‰", age: 25, version: 1}
ç¬¬1æ¬¡ä¿®æ”¹: {id: 1, name: "å¼ ä¸‰", age: 26, version: 2}  
ç¬¬2æ¬¡ä¿®æ”¹: {id: 1, name: "æå››", age: 26, version: 3}
ç¬¬3æ¬¡ä¿®æ”¹: {id: 1, name: "æå››", age: 27, version: 4}

ç‰ˆæœ¬å·é€’å¢è§„å¾‹ï¼š
- æ¯æ¬¡æˆåŠŸæ›´æ–°ï¼Œversionå­—æ®µè‡ªåŠ¨+1
- æ›´æ–°å‰å¿…é¡»æ£€æŸ¥versionæ˜¯å¦è¿˜æ˜¯æœŸæœ›å€¼
- å¦‚æœversionå·²å˜åŒ–ï¼Œè¯´æ˜è¢«åˆ«äººä¿®æ”¹è¿‡
```

### 2.2 ç‰ˆæœ¬æ§åˆ¶çš„å®ç°ç­–ç•¥


**ğŸ¯ ç­–ç•¥ä¸€ï¼šæ•´æ•°ç‰ˆæœ¬å·**
```sql
-- è¡¨ç»“æ„è®¾è®¡
CREATE TABLE user_account (
    id INT PRIMARY KEY,
    username VARCHAR(50),
    balance DECIMAL(10,2),
    version INT NOT NULL DEFAULT 1,  -- ç‰ˆæœ¬å·å­—æ®µ
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO user_account (id, username, balance) 
VALUES (1, 'zhangsan', 1000.00);
```

**ğŸ“ åŸºæœ¬æ›´æ–°æµç¨‹**
```sql
-- æ­¥éª¤1ï¼šè¯»å–å½“å‰æ•°æ®å’Œç‰ˆæœ¬
SELECT id, username, balance, version 
FROM user_account WHERE id = 1;
-- ç»“æœï¼šid=1, username='zhangsan', balance=1000.00, version=1

-- æ­¥éª¤2ï¼šæ‰§è¡Œå¸¦ç‰ˆæœ¬æ£€æŸ¥çš„æ›´æ–°
UPDATE user_account 
SET balance = balance - 100, 
    version = version + 1
WHERE id = 1 AND version = 1;  -- æ£€æŸ¥ç‰ˆæœ¬å·

-- æ­¥éª¤3ï¼šæ£€æŸ¥æ›´æ–°ç»“æœ
-- ROW_COUNT() = 1ï¼šæ›´æ–°æˆåŠŸ
-- ROW_COUNT() = 0ï¼šç‰ˆæœ¬å†²çªï¼Œéœ€è¦é‡è¯•
```

### 2.3 å†²çªå¤„ç†ç­–ç•¥


**âš ï¸ å†²çªæ£€æµ‹ä¸å¤„ç†**
```sql
DELIMITER //
CREATE PROCEDURE UpdateBalanceWithVersion(
    IN user_id INT,
    IN amount DECIMAL(10,2),
    IN expected_version INT,
    OUT result_code INT,
    OUT new_version INT
)
BEGIN
    DECLARE affected_rows INT DEFAULT 0;
    DECLARE current_balance DECIMAL(10,2);
    
    -- æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
    SELECT balance INTO current_balance 
    FROM user_account WHERE id = user_id;
    
    IF current_balance < amount THEN
        SET result_code = -1;  -- ä½™é¢ä¸è¶³
        SET new_version = -1;
        LEAVE proc_label;
    END IF;
    
    -- æ‰§è¡Œç‰ˆæœ¬æ§åˆ¶æ›´æ–°
    UPDATE user_account 
    SET balance = balance - amount,
        version = version + 1
    WHERE id = user_id AND version = expected_version;
    
    SET affected_rows = ROW_COUNT();
    
    IF affected_rows = 1 THEN
        -- æ›´æ–°æˆåŠŸ
        SELECT version INTO new_version 
        FROM user_account WHERE id = user_id;
        SET result_code = 1;
    ELSE
        -- ç‰ˆæœ¬å†²çª
        SET result_code = 0;
        SET new_version = -1;
    END IF;
    
END //
DELIMITER ;
```

**ğŸ”„ åº”ç”¨å±‚é‡è¯•æœºåˆ¶**
```java
public boolean updateBalance(int userId, double amount, int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        // 1. è¯»å–å½“å‰æ•°æ®
        UserAccount account = getUserAccount(userId);
        if (account.getBalance() < amount) {
            throw new InsufficientBalanceException();
        }
        
        // 2. å°è¯•æ›´æ–°
        int affectedRows = updateBalanceWithVersion(
            userId, amount, account.getVersion()
        );
        
        if (affectedRows > 0) {
            return true;  // æ›´æ–°æˆåŠŸ
        }
        
        // 3. ç‰ˆæœ¬å†²çªï¼ŒçŸ­æš‚ç­‰å¾…åé‡è¯•
        try {
            Thread.sleep(10 + (int)(Math.random() * 20));  // éšæœºç­‰å¾…10-30ms
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        }
    }
    
    throw new OptimisticLockException("Update failed after " + maxRetries + " retries");
}
```

### 2.4 ç‰ˆæœ¬æ§åˆ¶çš„é«˜çº§ç­–ç•¥


**ğŸ¯ åˆ†å­—æ®µç‰ˆæœ¬æ§åˆ¶**
```sql
-- ä¸åŒå­—æ®µä½¿ç”¨ä¸åŒç‰ˆæœ¬å·
CREATE TABLE user_profile (
    id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    basic_info_version INT DEFAULT 1,     -- åŸºæœ¬ä¿¡æ¯ç‰ˆæœ¬
    contact_version INT DEFAULT 1,        -- è”ç³»æ–¹å¼ç‰ˆæœ¬
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- åªæ›´æ–°åŸºæœ¬ä¿¡æ¯æ—¶
UPDATE user_profile 
SET username = 'newname',
    basic_info_version = basic_info_version + 1
WHERE id = 1 AND basic_info_version = 2;

-- åªæ›´æ–°è”ç³»æ–¹å¼æ—¶
UPDATE user_profile 
SET email = 'new@email.com',
    contact_version = contact_version + 1  
WHERE id = 1 AND contact_version = 1;
```

---

## 3. ğŸ—ï¸ ç‰ˆæœ¬å·å­—æ®µè®¾è®¡


### 3.1 ç‰ˆæœ¬å·å­—æ®µçš„è®¾è®¡åŸåˆ™


**ğŸ“ è®¾è®¡åŸºæœ¬è¦æ±‚**
```sql
ç‰ˆæœ¬å·å­—æ®µå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼š
âœ“ å•è°ƒé€’å¢ï¼šæ¯æ¬¡æ›´æ–°éƒ½å¿…é¡»å¢åŠ 
âœ“ ä¸å¯é‡å¤ï¼šä¸åŒçš„ä¿®æ”¹å¯¹åº”ä¸åŒçš„ç‰ˆæœ¬å·  
âœ“ åŸå­æ“ä½œï¼šç‰ˆæœ¬å·æ›´æ–°ä¸æ•°æ®æ›´æ–°å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­
âœ“ é«˜æ€§èƒ½ï¼šç‰ˆæœ¬æ¯”è¾ƒå’Œæ›´æ–°æ“ä½œè¦è¶³å¤Ÿå¿«
```

### 3.2 æ•´æ•°ç‰ˆæœ¬å·è®¾è®¡


**ğŸ”¢ åŸºæœ¬æ•´æ•°ç‰ˆæœ¬å·**
```sql
-- æœ€ç®€å•çš„ç‰ˆæœ¬å·è®¾è®¡
CREATE TABLE product (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    price DECIMAL(10,2),
    stock INT,
    version INT UNSIGNED NOT NULL DEFAULT 1,  -- ç‰ˆæœ¬å·
    INDEX idx_id_version (id, version)        -- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
);

-- æ›´æ–°æ¨¡æ¿
UPDATE product 
SET stock = stock - 1,
    version = version + 1
WHERE id = ? AND version = ?;
```

**ğŸ“ˆ ç‰ˆæœ¬å·å­—æ®µç±»å‹é€‰æ‹©**

| æ•°æ®ç±»å‹ | **å­˜å‚¨å¤§å°** | **å–å€¼èŒƒå›´** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-------------|-----------|
| `INT` | 4å­—èŠ‚ | 0 ~ 42äº¿ | ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ | æ€§èƒ½å¥½ï¼ŒèŒƒå›´å¤Ÿç”¨ |
| `BIGINT` | 8å­—èŠ‚ | 0 ~ 184äº¿äº¿ | é«˜é¢‘æ›´æ–°ä¸šåŠ¡ | æ°¸ä¸æº¢å‡ºï¼Œå ç”¨ç©ºé—´å¤§ |
| `SMALLINT` | 2å­—èŠ‚ | 0 ~ 65535 | ä½é¢‘æ›´æ–°åœºæ™¯ | çœç©ºé—´ï¼Œå®¹æ˜“æº¢å‡º |

### 3.3 å¤åˆç‰ˆæœ¬å·è®¾è®¡


**ğŸ”€ ä¸šåŠ¡åˆ†ç»„ç‰ˆæœ¬å·**
```sql
-- æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç»„çš„ç‰ˆæœ¬æ§åˆ¶
CREATE TABLE user_data (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    phone VARCHAR(20),
    avatar_url VARCHAR(200),
    
    -- åˆ†ç»„ç‰ˆæœ¬å·
    profile_version INT DEFAULT 1,    -- ä¸ªäººä¿¡æ¯ç‰ˆæœ¬
    contact_version INT DEFAULT 1,    -- è”ç³»æ–¹å¼ç‰ˆæœ¬  
    media_version INT DEFAULT 1,      -- åª’ä½“èµ„æºç‰ˆæœ¬
    
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- åªæ›´æ–°è”ç³»æ–¹å¼
UPDATE user_data 
SET email = 'new@example.com',
    phone = '13800138000',
    contact_version = contact_version + 1
WHERE user_id = 123 AND contact_version = 5;
```

**ğŸŒ åˆ†å¸ƒå¼ç‰ˆæœ¬å·è®¾è®¡**
```sql
-- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç‰ˆæœ¬å·è®¾è®¡
CREATE TABLE distributed_data (
    id BIGINT PRIMARY KEY,
    data_content TEXT,
    
    -- åˆ†å¸ƒå¼ç‰ˆæœ¬å· = èŠ‚ç‚¹ID + æœ¬åœ°ç‰ˆæœ¬å·
    node_id SMALLINT,                 -- èŠ‚ç‚¹æ ‡è¯†
    local_version BIGINT,             -- èŠ‚ç‚¹å†…ç‰ˆæœ¬å·  
    global_timestamp BIGINT,          -- å…¨å±€æ—¶é—´æˆ³
    
    -- å¤åˆç‰ˆæœ¬å·ï¼šnode_id + local_version + global_timestamp
    UNIQUE KEY uk_node_version (node_id, local_version),
    INDEX idx_global_timestamp (global_timestamp)
);

-- åˆ†å¸ƒå¼æ›´æ–°æ£€æŸ¥
UPDATE distributed_data 
SET data_content = 'new content',
    local_version = local_version + 1,
    global_timestamp = UNIX_TIMESTAMP(NOW(3)) * 1000
WHERE id = 1 
  AND node_id = 1 
  AND local_version = 100;
```

### 3.4 ç‰ˆæœ¬å·å­—æ®µçš„å­˜å‚¨ä¼˜åŒ–


**âš¡ ç´¢å¼•è®¾è®¡ä¼˜åŒ–**
```sql
-- é’ˆå¯¹ç‰ˆæœ¬æ§åˆ¶æŸ¥è¯¢çš„ç´¢å¼•è®¾è®¡
CREATE TABLE order_info (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,
    status VARCHAR(20),
    amount DECIMAL(10,2),
    version INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- æ ¸å¿ƒç´¢å¼•ï¼šæ”¯æŒç‰ˆæœ¬æ§åˆ¶æ›´æ–°
    INDEX idx_orderid_version (order_id, version),
    
    -- è¾…åŠ©ç´¢å¼•ï¼šæ”¯æŒæŒ‰ç”¨æˆ·æŸ¥è¯¢
    INDEX idx_userid_status (user_id, status),
    
    -- æ—¶é—´èŒƒå›´ç´¢å¼•ï¼šæ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢
    INDEX idx_created_at (created_at)
);
```

**ğŸ’¾ å­˜å‚¨ç©ºé—´ä¼˜åŒ–æŠ€å·§**
```sql
-- æŠ€å·§1ï¼šç‰ˆæœ¬å·å®šæœŸé‡ç½®ï¼ˆé€‚ç”¨äºå†å²æ•°æ®ä¸é‡è¦çš„åœºæ™¯ï¼‰
-- æ¯æœˆ1å·é‡ç½®ç‰ˆæœ¬å·ï¼Œé…åˆå†å²æ•°æ®æ¸…ç†
UPDATE user_activity 
SET version = 1, reset_date = CURRENT_DATE()
WHERE reset_date < DATE_SUB(CURRENT_DATE(), INTERVAL 1 MONTH);

-- æŠ€å·§2ï¼šä½¿ç”¨å‹ç¼©ç®—æ³•ï¼ˆMySQL 5.7+ï¼‰
CREATE TABLE compressed_data (
    id BIGINT PRIMARY KEY,
    data LONGTEXT,
    version INT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8;
```

### 3.5 ç‰ˆæœ¬å·å­—æ®µçš„ç»´æŠ¤ç­–ç•¥


**ğŸ”§ è‡ªåŠ¨ç»´æŠ¤æœºåˆ¶**
```sql
-- ä½¿ç”¨è§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤ç‰ˆæœ¬å·
DELIMITER //
CREATE TRIGGER tr_auto_version_update 
BEFORE UPDATE ON user_account
FOR EACH ROW
BEGIN
    -- è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
    SET NEW.version = OLD.version + 1;
    
    -- è®°å½•ä¿®æ”¹æ—¶é—´
    SET NEW.updated_at = CURRENT_TIMESTAMP();
    
    -- è®°å½•æ“ä½œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
    INSERT INTO version_log (table_name, record_id, old_version, new_version, operation_time)
    VALUES ('user_account', NEW.id, OLD.version, NEW.version, NOW());
END //
DELIMITER ;
```

**ğŸ“Š ç‰ˆæœ¬å·ç›‘æ§**
```sql
-- ç›‘æ§ç‰ˆæœ¬å·å¢é•¿æƒ…å†µ
SELECT 
    table_name,
    AVG(version) as avg_version,
    MAX(version) as max_version,
    MIN(version) as min_version,
    COUNT(*) as record_count
FROM (
    SELECT 'user_account' as table_name, version FROM user_account
    UNION ALL
    SELECT 'product' as table_name, version FROM product
    UNION ALL  
    SELECT 'order_info' as table_name, version FROM order_info
) t
GROUP BY table_name;
```

---

## 4. ğŸ”„ CASæ›´æ–°å®ç°


### 4.1 ä»€ä¹ˆæ˜¯CASæ“ä½œ


**ğŸ’¡ CASåŸºæœ¬æ¦‚å¿µ**
CASï¼ˆCompare-And-Swapï¼‰æ˜¯ä¸€ç§åŸå­æ“ä½œï¼Œæ„æ€æ˜¯"æ¯”è¾ƒå¹¶äº¤æ¢"ã€‚

```
CASæ“ä½œçš„ä¸‰ä¸ªæ­¥éª¤ï¼š
1. Compareï¼ˆæ¯”è¾ƒï¼‰ï¼šæ£€æŸ¥å†…å­˜ä¸­çš„å€¼æ˜¯å¦ç­‰äºæœŸæœ›å€¼
2. Andï¼ˆå¹¶ä¸”ï¼‰ï¼šåªæœ‰æ¯”è¾ƒæˆåŠŸæ‰æ‰§è¡Œä¸‹ä¸€æ­¥  
3. Swapï¼ˆäº¤æ¢ï¼‰ï¼šå°†å†…å­˜ä¸­çš„å€¼æ›´æ–°ä¸ºæ–°å€¼

ç®€å•ç†è§£ï¼š
å°±åƒæ˜¯ä¸€ä¸ª"æ¡ä»¶æ›´æ–°"æ“ä½œ
- å¦‚æœå½“å‰å€¼ == æˆ‘æœŸæœ›çš„å€¼ï¼Œé‚£ä¹ˆæ›´æ–°ä¸ºæ–°å€¼
- å¦‚æœå½“å‰å€¼ != æˆ‘æœŸæœ›çš„å€¼ï¼Œé‚£ä¹ˆä¸æ›´æ–°
```

### 4.2 MySQLä¸­çš„CASå®ç°


**ğŸ—ƒï¸ åŸºæœ¬CASæ›´æ–°è¯­æ³•**
```sql
-- CASæ›´æ–°çš„é€šç”¨æ¨¡å¼
UPDATE table_name 
SET column1 = new_value1,
    column2 = new_value2,
    version = version + 1     -- ç‰ˆæœ¬å·é€’å¢
WHERE id = target_id 
  AND version = expected_version;  -- CASæ¡ä»¶æ£€æŸ¥

-- æ£€æŸ¥æ›´æ–°ç»“æœ
-- ROW_COUNT() = 1ï¼šCASæˆåŠŸï¼Œæ•°æ®å·²æ›´æ–°
-- ROW_COUNT() = 0ï¼šCASå¤±è´¥ï¼Œæ•°æ®æœªæ›´æ–°ï¼ˆç‰ˆæœ¬å†²çªï¼‰
```

### 4.3 CASæ“ä½œçš„å®é™…åº”ç”¨


**ğŸ’° é“¶è¡Œè½¬è´¦CASå®ç°**
```sql
-- åœºæ™¯ï¼šç”¨æˆ·Aå‘ç”¨æˆ·Bè½¬è´¦100å…ƒ
-- éœ€è¦åŒæ—¶æ›´æ–°ä¸¤ä¸ªè´¦æˆ·ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

-- 1. è¯»å–å½“å‰çŠ¶æ€
SELECT id, balance, version FROM account WHERE id IN (1, 2);
-- å‡è®¾ç»“æœï¼š
-- ç”¨æˆ·A: id=1, balance=1000, version=10
-- ç”¨æˆ·B: id=2, balance=500,  version=8

-- 2. æ‰§è¡ŒCASè½¬è´¦æ“ä½œ
START TRANSACTION;

-- æ‰£å‡ç”¨æˆ·Açš„ä½™é¢
UPDATE account 
SET balance = balance - 100,
    version = version + 1
WHERE id = 1 AND version = 10;

-- æ£€æŸ¥Aè´¦æˆ·æ›´æ–°æ˜¯å¦æˆåŠŸ
IF ROW_COUNT() = 0 THEN
    ROLLBACK;
    -- å¤„ç†å†²çª...
END IF;

-- å¢åŠ ç”¨æˆ·Bçš„ä½™é¢
UPDATE account 
SET balance = balance + 100,
    version = version + 1
WHERE id = 2 AND version = 8;

-- æ£€æŸ¥Bè´¦æˆ·æ›´æ–°æ˜¯å¦æˆåŠŸ
IF ROW_COUNT() = 0 THEN
    ROLLBACK;
    -- å¤„ç†å†²çª...
END IF;

COMMIT;
```

**ğŸ“¦ åº“å­˜æ‰£å‡CASå®ç°**
```sql
-- åœºæ™¯ï¼šå•†å“åº“å­˜æ‰£å‡ï¼Œé˜²æ­¢è¶…å–
CREATE TABLE product_inventory (
    product_id BIGINT PRIMARY KEY,
    stock_quantity INT NOT NULL,
    reserved_quantity INT DEFAULT 0,  -- é¢„ç•™åº“å­˜
    version BIGINT NOT NULL DEFAULT 1,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- CASåº“å­˜æ‰£å‡å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE DeductInventory(
    IN p_product_id BIGINT,
    IN p_quantity INT,
    IN p_expected_version BIGINT,
    OUT p_result_code INT,
    OUT p_new_version BIGINT
)
BEGIN
    DECLARE v_current_stock INT;
    DECLARE v_affected_rows INT;
    
    -- æ£€æŸ¥å½“å‰åº“å­˜
    SELECT stock_quantity INTO v_current_stock
    FROM product_inventory 
    WHERE product_id = p_product_id;
    
    -- åº“å­˜ä¸è¶³
    IF v_current_stock < p_quantity THEN
        SET p_result_code = -1;  -- åº“å­˜ä¸è¶³
        SET p_new_version = -1;
        LEAVE procedure_end;
    END IF;
    
    -- æ‰§è¡ŒCASåº“å­˜æ‰£å‡
    UPDATE product_inventory
    SET stock_quantity = stock_quantity - p_quantity,
        version = version + 1
    WHERE product_id = p_product_id 
      AND version = p_expected_version
      AND stock_quantity >= p_quantity;  -- åŒé‡ä¿é™©
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        -- CASæˆåŠŸ
        SELECT version INTO p_new_version
        FROM product_inventory 
        WHERE product_id = p_product_id;
        SET p_result_code = 1;
    ELSE
        -- CASå¤±è´¥ï¼ˆç‰ˆæœ¬å†²çªï¼‰
        SET p_result_code = 0;
        SET p_new_version = -1;
    END IF;
    
procedure_end:
END //
DELIMITER ;
```

### 4.4 CASæ“ä½œçš„æ‰¹é‡å¤„ç†


**ğŸ”¢ æ‰¹é‡CASæ›´æ–°**
```sql
-- æ‰¹é‡å•†å“ä»·æ ¼è°ƒæ•´ï¼Œä½¿ç”¨CASä¿è¯ä¸€è‡´æ€§
-- ä¸´æ—¶è¡¨å­˜å‚¨è°ƒä»·ä¿¡æ¯
CREATE TEMPORARY TABLE price_update_batch (
    product_id BIGINT,
    new_price DECIMAL(10,2),
    expected_version BIGINT
);

-- æ‰¹é‡CASæ›´æ–°å®ç°
UPDATE product p
INNER JOIN price_update_batch pub ON p.id = pub.product_id
SET p.price = pub.new_price,
    p.version = p.version + 1
WHERE p.version = pub.expected_version;

-- æ£€æŸ¥æ‰¹é‡æ›´æ–°ç»“æœ
SELECT 
    COUNT(*) as total_attempted,
    ROW_COUNT() as successful_updates,
    (COUNT(*) - ROW_COUNT()) as failed_updates
FROM price_update_batch;
```

### 4.5 CASæ€§èƒ½ä¼˜åŒ–


**âš¡ CASæ“ä½œæ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```sql
-- ä¼˜åŒ–1ï¼šä½¿ç”¨å¤åˆç´¢å¼•
CREATE INDEX idx_product_version ON product_inventory (product_id, version);

-- ä¼˜åŒ–2ï¼šå‡å°‘CASå†²çªçš„éšæœºé€€é¿
-- åœ¨åº”ç”¨å±‚å®ç°
public boolean casUpdateWithBackoff(long productId, int quantity, int maxRetries) {
    Random random = new Random();
    
    for (int retry = 0; retry < maxRetries; retry++) {
        ProductInventory current = getProductInventory(productId);
        
        boolean success = deductInventoryWithCAS(
            productId, quantity, current.getVersion()
        );
        
        if (success) {
            return true;
        }
        
        // æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
        int backoffMs = (int) Math.pow(2, retry) * 10 + random.nextInt(10);
        try {
            Thread.sleep(Math.min(backoffMs, 1000));  // æœ€å¤§ç­‰å¾…1ç§’
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        }
    }
    
    return false;
}
```

**ğŸ“Š CASå†²çªç›‘æ§**
```sql
-- åˆ›å»ºCASæ“ä½œæ—¥å¿—è¡¨
CREATE TABLE cas_operation_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50),
    record_id BIGINT,
    operation_type VARCHAR(20),
    expected_version BIGINT,
    actual_version BIGINT,
    result_status ENUM('SUCCESS', 'VERSION_CONFLICT', 'BUSINESS_ERROR'),
    retry_count INT DEFAULT 0,
    execution_time_ms INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ†æCASå†²çªç‡
SELECT 
    table_name,
    operation_type,
    COUNT(*) as total_operations,
    SUM(CASE WHEN result_status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN result_status = 'VERSION_CONFLICT' THEN 1 ELSE 0 END) as conflict_count,
    ROUND(
        SUM(CASE WHEN result_status = 'VERSION_CONFLICT' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2
    ) as conflict_rate_percent,
    AVG(retry_count) as avg_retry_count,
    AVG(execution_time_ms) as avg_execution_time_ms
FROM cas_operation_log
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 DAY)
GROUP BY table_name, operation_type
ORDER BY conflict_rate_percent DESC;
```

---

## 5. â° æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥


### 5.1 æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶åŸç†


**ğŸ•’ æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶æ¦‚å¿µ**
ä¸æ•´æ•°ç‰ˆæœ¬å·ä¸åŒï¼Œæ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶ä½¿ç”¨æ—¶é—´ä½œä¸ºç‰ˆæœ¬æ ‡è¯†ã€‚

```
æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶çš„ä¼˜åŠ¿ï¼š
âœ“ å¤©ç„¶å•è°ƒé€’å¢ï¼šæ—¶é—´æ°¸è¿œå‘å‰
âœ“ ä¸šåŠ¡å«ä¹‰æ˜ç¡®ï¼šç›´æ¥çœ‹å‡ºæœ€åä¿®æ”¹æ—¶é—´  
âœ“ ä¾¿äºè°ƒè¯•ï¼šå¯ä»¥è¿½è¸ªä¿®æ”¹çš„æ—¶é—´é¡ºåº
âœ“ åˆ†å¸ƒå¼å‹å¥½ï¼šä¸åŒç³»ç»Ÿçš„æ—¶é—´æˆ³ä¹Ÿèƒ½æ¯”è¾ƒ

æ—¶é—´æˆ³çš„ç²¾åº¦é€‰æ‹©ï¼š
- ç§’çº§æ—¶é—´æˆ³ï¼šé€‚ç”¨äºä½é¢‘æ›´æ–°åœºæ™¯
- æ¯«ç§’æ—¶é—´æˆ³ï¼šé€‚ç”¨äºé«˜é¢‘æ›´æ–°åœºæ™¯  
- å¾®ç§’æ—¶é—´æˆ³ï¼šé€‚ç”¨äºæé«˜é¢‘æ›´æ–°åœºæ™¯
```

### 5.2 æ—¶é—´æˆ³å­—æ®µè®¾è®¡


**ğŸ“… åŸºæœ¬æ—¶é—´æˆ³è®¾è®¡**
```sql
-- ä½¿ç”¨TIMESTAMPä½œä¸ºç‰ˆæœ¬æ§åˆ¶
CREATE TABLE document (
    id BIGINT PRIMARY KEY,
    title VARCHAR(200),
    content TEXT,
    author_id BIGINT,
    
    -- æ—¶é—´æˆ³ç‰ˆæœ¬å­—æ®µ
    version_timestamp TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_id_version (id, version_timestamp)
);

-- æ’å…¥ç¤ºä¾‹æ•°æ®
INSERT INTO document (id, title, content, author_id) 
VALUES (1, 'æŠ€æœ¯æ–‡æ¡£', 'è¿™æ˜¯å†…å®¹', 100);
```

**ğŸ”¢ æ¯«ç§’æ—¶é—´æˆ³è®¾è®¡**
```sql
-- ä½¿ç”¨BIGINTå­˜å‚¨æ¯«ç§’æ—¶é—´æˆ³
CREATE TABLE realtime_data (
    id BIGINT PRIMARY KEY,
    sensor_data JSON,
    device_id VARCHAR(50),
    
    -- æ¯«ç§’çº§æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶
    version_ms BIGINT NOT NULL DEFAULT (UNIX_TIMESTAMP(NOW(3)) * 1000),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_device_version (device_id, version_ms),
    INDEX idx_version_ms (version_ms)
);

-- è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³ç‰ˆæœ¬
DELIMITER //
CREATE TRIGGER tr_update_version_ms
BEFORE UPDATE ON realtime_data
FOR EACH ROW
BEGIN
    SET NEW.version_ms = UNIX_TIMESTAMP(NOW(3)) * 1000;
END //
DELIMITER ;
```

### 5.3 æ—¶é—´æˆ³CASæ›´æ–°å®ç°


**ğŸ”„ åŸºäºæ—¶é—´æˆ³çš„CASæ›´æ–°**
```sql
-- è¯»å–å½“å‰æ•°æ®å’Œæ—¶é—´æˆ³ç‰ˆæœ¬
SELECT id, title, content, version_timestamp 
FROM document 
WHERE id = 1;
-- å‡è®¾å¾—åˆ°ï¼šversion_timestamp = '2024-01-15 10:30:45.123'

-- æ‰§è¡Œæ—¶é—´æˆ³CASæ›´æ–°
UPDATE document 
SET content = 'æ›´æ–°åçš„å†…å®¹',
    version_timestamp = CURRENT_TIMESTAMP(3)
WHERE id = 1 
  AND version_timestamp = '2024-01-15 10:30:45.123';

-- æ£€æŸ¥æ›´æ–°ç»“æœ
SELECT ROW_COUNT() as affected_rows;
-- 1: æ›´æ–°æˆåŠŸ
-- 0: æ—¶é—´æˆ³å·²å˜åŒ–ï¼Œæ›´æ–°å¤±è´¥
```

**âš¡ é«˜ç²¾åº¦æ—¶é—´æˆ³æ›´æ–°**
```sql
-- ä½¿ç”¨å¾®ç§’çº§ç²¾åº¦é¿å…æ—¶é—´æˆ³å†²çª
CREATE TABLE high_frequency_data (
    id BIGINT PRIMARY KEY,
    data_value DECIMAL(15,6),
    
    -- å¾®ç§’æ—¶é—´æˆ³ï¼ˆä½¿ç”¨BIGINTå­˜å‚¨ï¼‰
    version_microseconds BIGINT NOT NULL,
    
    INDEX idx_id_version (id, version_microseconds)
);

-- æ’å…¥æ—¶è®¾ç½®å¾®ç§’æ—¶é—´æˆ³
INSERT INTO high_frequency_data (id, data_value, version_microseconds)
VALUES (1, 99.123456, UNIX_TIMESTAMP(NOW(6)) * 1000000);

-- åŸºäºå¾®ç§’æ—¶é—´æˆ³çš„CASæ›´æ–°
SET @expected_version = (SELECT version_microseconds FROM high_frequency_data WHERE id = 1);
SET @new_version = UNIX_TIMESTAMP(NOW(6)) * 1000000;

UPDATE high_frequency_data
SET data_value = 100.654321,
    version_microseconds = @new_version
WHERE id = 1 AND version_microseconds = @expected_version;
```

### 5.4 æ—¶é—´æˆ³å†²çªå¤„ç†


**âš ï¸ æ—¶é—´æˆ³å†²çªçš„åŸå› å’Œè§£å†³**
```sql
-- é—®é¢˜ï¼šæé«˜é¢‘ç‡æ›´æ–°å¯èƒ½äº§ç”Ÿç›¸åŒæ—¶é—´æˆ³
-- è§£å†³æ–¹æ¡ˆ1ï¼šå¢åŠ åºåˆ—å·

CREATE TABLE conflict_safe_data (
    id BIGINT PRIMARY KEY,
    data_content TEXT,
    
    -- æ—¶é—´æˆ³ + åºåˆ—å·ç»„åˆç‰ˆæœ¬
    version_timestamp TIMESTAMP(6),
    version_sequence INT DEFAULT 0,
    
    UNIQUE KEY uk_timestamp_seq (version_timestamp, version_sequence)
);

-- å®‰å…¨çš„æ—¶é—´æˆ³æ›´æ–°å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE SafeTimestampUpdate(
    IN p_id BIGINT,
    IN p_content TEXT,
    IN p_expected_timestamp TIMESTAMP(6),
    IN p_expected_sequence INT,
    OUT p_result_code INT,
    OUT p_new_timestamp TIMESTAMP(6),
    OUT p_new_sequence INT
)
BEGIN
    DECLARE v_now TIMESTAMP(6) DEFAULT NOW(6);
    DECLARE v_new_seq INT DEFAULT 0;
    DECLARE v_affected_rows INT;
    
    -- å¦‚æœæ–°æ—¶é—´æˆ³ç­‰äºæœŸæœ›æ—¶é—´æˆ³ï¼Œåºåˆ—å·+1
    IF v_now = p_expected_timestamp THEN
        SET v_new_seq = p_expected_sequence + 1;
    ELSE
        SET v_new_seq = 0;
    END IF;
    
    -- æ‰§è¡ŒCASæ›´æ–°
    UPDATE conflict_safe_data
    SET data_content = p_content,
        version_timestamp = v_now,
        version_sequence = v_new_seq
    WHERE id = p_id 
      AND version_timestamp = p_expected_timestamp 
      AND version_sequence = p_expected_sequence;
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        SET p_result_code = 1;
        SET p_new_timestamp = v_now;
        SET p_new_sequence = v_new_seq;
    ELSE
        SET p_result_code = 0;
        SET p_new_timestamp = NULL;
        SET p_new_sequence = -1;
    END IF;
END //
DELIMITER ;
```

### 5.5 æ—¶é—´æˆ³ç‰ˆæœ¬çš„æ€§èƒ½ä¼˜åŒ–


**ğŸ“ˆ æ—¶é—´æˆ³ç´¢å¼•ä¼˜åŒ–**
```sql
-- é’ˆå¯¹æ—¶é—´æˆ³ç‰ˆæœ¬æ§åˆ¶çš„ç´¢å¼•è®¾è®¡
CREATE TABLE log_data (
    id BIGINT PRIMARY KEY,
    log_content TEXT,
    user_id BIGINT,
    version_timestamp TIMESTAMP(3),
    
    -- ä¸»è¦ç´¢å¼•ï¼šæ”¯æŒCASæ›´æ–°
    INDEX idx_id_timestamp (id, version_timestamp),
    
    -- æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•
    INDEX idx_timestamp_range (version_timestamp),
    
    -- ç”¨æˆ·æ—¶é—´çº¿ç´¢å¼•
    INDEX idx_user_timestamp (user_id, version_timestamp DESC)
);

-- æ—¶é—´æˆ³èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
SELECT id, log_content, version_timestamp
FROM log_data
WHERE version_timestamp BETWEEN '2024-01-01' AND '2024-01-31'
ORDER BY version_timestamp DESC
LIMIT 100;
```

**ğŸš€ æ—¶é—´æˆ³æ¯”è¾ƒæ€§èƒ½ä¼˜åŒ–**
```sql
-- ä½¿ç”¨æ•°å€¼æ—¶é—´æˆ³æ›¿ä»£å­—ç¬¦ä¸²æ¯”è¾ƒ
-- æ€§èƒ½å¯¹æ¯”æµ‹è¯•

-- æ–¹æ¡ˆ1ï¼šTIMESTAMPå­—æ®µæ¯”è¾ƒï¼ˆè¾ƒæ…¢ï¼‰
UPDATE document 
SET content = 'new content'
WHERE id = 1 AND version_timestamp = '2024-01-15 10:30:45.123';

-- æ–¹æ¡ˆ2ï¼šBIGINTæ—¶é—´æˆ³æ¯”è¾ƒï¼ˆæ›´å¿«ï¼‰  
UPDATE document_optimized
SET content = 'new content',
    version_ms = UNIX_TIMESTAMP(NOW(3)) * 1000
WHERE id = 1 AND version_ms = 1705317045123;

-- æ€§èƒ½æµ‹è¯•æŸ¥è¯¢
SELECT 
    COUNT(*) as total_records,
    AVG(UNIX_TIMESTAMP(version_timestamp)) as avg_timestamp
FROM document
WHERE version_timestamp > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

---

## 6. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 6.1 ç”µå•†ç³»ç»Ÿä¸­çš„åº“å­˜ç®¡ç†


**ğŸ“¦ å•†å“åº“å­˜ä¹è§‚é”æ§åˆ¶**
```sql
-- ç”µå•†åº“å­˜è¡¨è®¾è®¡
CREATE TABLE e_commerce_inventory (
    sku_id VARCHAR(50) PRIMARY KEY,
    product_name VARCHAR(200),
    available_stock INT NOT NULL DEFAULT 0,
    reserved_stock INT NOT NULL DEFAULT 0,    -- é¢„ç•™åº“å­˜ï¼ˆè´­ç‰©è½¦ç­‰ï¼‰
    total_stock INT NOT NULL DEFAULT 0,       -- æ€»åº“å­˜
    version BIGINT NOT NULL DEFAULT 1,
    last_restock_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_sku_version (sku_id, version),
    INDEX idx_updated_at (updated_at)
);

-- åº“å­˜æ‰£å‡ä¸šåŠ¡é€»è¾‘
DELIMITER //
CREATE PROCEDURE ProcessOrder(
    IN p_sku_id VARCHAR(50),
    IN p_order_quantity INT,
    IN p_expected_version BIGINT,
    OUT p_result_code INT,
    OUT p_message VARCHAR(200)
)
BEGIN
    DECLARE v_available_stock INT;
    DECLARE v_affected_rows INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result_code = -99;
        SET p_message = 'Database error occurred';
    END;
    
    START TRANSACTION;
    
    -- è¯»å–å½“å‰åº“å­˜
    SELECT available_stock INTO v_available_stock
    FROM e_commerce_inventory 
    WHERE sku_id = p_sku_id
    FOR UPDATE;  -- åŠ é”é˜²æ­¢è¯»å–è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹
    
    -- æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
    IF v_available_stock < p_order_quantity THEN
        ROLLBACK;
        SET p_result_code = -1;
        SET p_message = CONCAT('Insufficient stock. Available: ', v_available_stock);
        LEAVE sp_end;
    END IF;
    
    -- æ‰§è¡Œä¹è§‚é”åº“å­˜æ‰£å‡
    UPDATE e_commerce_inventory
    SET available_stock = available_stock - p_order_quantity,
        version = version + 1
    WHERE sku_id = p_sku_id 
      AND version = p_expected_version;
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        COMMIT;
        SET p_result_code = 1;
        SET p_message = 'Stock deducted successfully';
    ELSE
        ROLLBACK;
        SET p_result_code = 0;
        SET p_message = 'Version conflict, please retry';
    END IF;
    
    sp_end:
END //
DELIMITER ;
```

### 6.2 é‡‘èç³»ç»Ÿä¸­çš„è´¦æˆ·æ“ä½œ


**ğŸ’° é“¶è¡Œè´¦æˆ·ä½™é¢ç®¡ç†**
```sql
-- é‡‘èè´¦æˆ·è¡¨è®¾è®¡
CREATE TABLE financial_account (
    account_id VARCHAR(32) PRIMARY KEY,
    account_type ENUM('CHECKING', 'SAVING', 'CREDIT') NOT NULL,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    frozen_amount DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    available_balance DECIMAL(15,2) GENERATED ALWAYS AS (balance - frozen_amount) STORED,
    
    -- ç‰ˆæœ¬æ§åˆ¶
    version BIGINT NOT NULL DEFAULT 1,
    last_transaction_time TIMESTAMP(3),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_account_version (account_id, version),
    INDEX idx_balance_range (balance),
    
    -- çº¦æŸï¼šä½™é¢ä¸èƒ½ä¸ºè´Ÿï¼ˆé™¤ä¿¡ç”¨è´¦æˆ·å¤–ï¼‰
    CONSTRAINT chk_balance CHECK (
        (account_type = 'CREDIT') OR (balance >= 0)
    )
);

-- å®‰å…¨çš„è½¬è´¦æ“ä½œ
DELIMITER //
CREATE PROCEDURE SafeTransfer(
    IN p_from_account VARCHAR(32),
    IN p_to_account VARCHAR(32),
    IN p_amount DECIMAL(15,2),
    IN p_from_version BIGINT,
    IN p_to_version BIGINT,
    OUT p_result_code INT,
    OUT p_transaction_id VARCHAR(64)
)
BEGIN
    DECLARE v_from_balance DECIMAL(15,2);
    DECLARE v_affected_rows INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET p_result_code = -99;
        SET p_transaction_id = NULL;
        GET DIAGNOSTICS CONDITION 1
            @error_message = MESSAGE_TEXT;
    END;
    
    SET p_transaction_id = UUID();
    START TRANSACTION;
    
    -- æ£€æŸ¥è½¬å‡ºè´¦æˆ·ä½™é¢
    SELECT available_balance INTO v_from_balance
    FROM financial_account 
    WHERE account_id = p_from_account;
    
    IF v_from_balance < p_amount THEN
        ROLLBACK;
        SET p_result_code = -1;  -- ä½™é¢ä¸è¶³
        SET p_transaction_id = NULL;
        LEAVE sp_end;
    END IF;
    
    -- æ‰£å‡è½¬å‡ºè´¦æˆ·ï¼ˆä¹è§‚é”ï¼‰
    UPDATE financial_account
    SET balance = balance - p_amount,
        version = version + 1,
        last_transaction_time = NOW(3)
    WHERE account_id = p_from_account 
      AND version = p_from_version;
    
    IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        SET p_result_code = -2;  -- è½¬å‡ºè´¦æˆ·ç‰ˆæœ¬å†²çª
        SET p_transaction_id = NULL;
        LEAVE sp_end;
    END IF;
    
    -- å¢åŠ è½¬å…¥è´¦æˆ·ï¼ˆä¹è§‚é”ï¼‰
    UPDATE financial_account
    SET balance = balance + p_amount,
        version = version + 1,
        last_transaction_time = NOW(3)
    WHERE account_id = p_to_account 
      AND version = p_to_version;
    
    IF ROW_COUNT() = 0 THEN
        ROLLBACK;
        SET p_result_code = -3;  -- è½¬å…¥è´¦æˆ·ç‰ˆæœ¬å†²çª
        SET p_transaction_id = NULL;
        LEAVE sp_end;
    END IF;
    
    -- è®°å½•äº¤æ˜“æ—¥å¿—
    INSERT INTO transaction_log (
        transaction_id, from_account, to_account, amount, 
        transaction_type, status, created_at
    ) VALUES (
        p_transaction_id, p_from_account, p_to_account, p_amount,
        'TRANSFER', 'COMPLETED', NOW(3)
    );
    
    COMMIT;
    SET p_result_code = 1;  -- æˆåŠŸ
    
    sp_end:
END //
DELIMITER ;
```

### 6.3 å†…å®¹ç®¡ç†ç³»ç»Ÿä¸­çš„æ–‡æ¡£åä½œ


**ğŸ“ å¤šäººåä½œæ–‡æ¡£ç¼–è¾‘**
```sql
-- åä½œæ–‡æ¡£è¡¨è®¾è®¡
CREATE TABLE collaborative_document (
    doc_id VARCHAR(36) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content LONGTEXT,
    doc_type ENUM('MARKDOWN', 'RICH_TEXT', 'CODE') DEFAULT 'MARKDOWN',
    
    -- ç‰ˆæœ¬æ§åˆ¶
    content_version BIGINT NOT NULL DEFAULT 1,
    title_version BIGINT NOT NULL DEFAULT 1,
    
    -- ç¼–è¾‘ä¿¡æ¯
    last_editor_id BIGINT,
    last_edit_time TIMESTAMP(3),
    
    -- åä½œçŠ¶æ€
    is_locked BOOLEAN DEFAULT FALSE,
    locked_by_user BIGINT NULL,
    lock_acquired_at TIMESTAMP NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_doc_content_version (doc_id, content_version),
    INDEX idx_last_edit_time (last_edit_time),
    INDEX idx_locked_docs (is_locked, locked_by_user)
);

-- å®‰å…¨çš„æ–‡æ¡£æ›´æ–°
DELIMITER //
CREATE PROCEDURE UpdateDocumentContent(
    IN p_doc_id VARCHAR(36),
    IN p_new_content LONGTEXT,
    IN p_editor_id BIGINT,
    IN p_expected_content_version BIGINT,
    OUT p_result_code INT,
    OUT p_new_version BIGINT,
    OUT p_conflict_info JSON
)
BEGIN
    DECLARE v_current_editor BIGINT;
    DECLARE v_lock_time TIMESTAMP;
    DECLARE v_affected_rows INT;
    
    -- æ£€æŸ¥æ–‡æ¡£é”å®šçŠ¶æ€
    SELECT locked_by_user, lock_acquired_at
    INTO v_current_editor, v_lock_time
    FROM collaborative_document
    WHERE doc_id = p_doc_id AND is_locked = TRUE;
    
    -- å¦‚æœæ–‡æ¡£è¢«é”å®šä¸”ä¸æ˜¯å½“å‰ç”¨æˆ·é”å®šçš„
    IF v_current_editor IS NOT NULL AND v_current_editor != p_editor_id THEN
        SET p_result_code = -2;  -- æ–‡æ¡£è¢«å…¶ä»–ç”¨æˆ·é”å®š
        SET p_conflict_info = JSON_OBJECT(
            'error', 'document_locked',
            'locked_by', v_current_editor,
            'lock_time', v_lock_time
        );
        LEAVE sp_end;
    END IF;
    
    -- æ‰§è¡Œä¹è§‚é”æ›´æ–°
    UPDATE collaborative_document
    SET content = p_new_content,
        content_version = content_version + 1,
        last_editor_id = p_editor_id,
        last_edit_time = NOW(3)
    WHERE doc_id = p_doc_id 
      AND content_version = p_expected_content_version;
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        -- æ›´æ–°æˆåŠŸ
        SELECT content_version INTO p_new_version
        FROM collaborative_document
        WHERE doc_id = p_doc_id;
        
        SET p_result_code = 1;
        SET p_conflict_info = JSON_OBJECT('status', 'success');
    ELSE
        -- ç‰ˆæœ¬å†²çª
        SELECT 
            content_version,
            last_editor_id,
            last_edit_time
        INTO @current_version, @last_editor, @last_time
        FROM collaborative_document
        WHERE doc_id = p_doc_id;
        
        SET p_result_code = 0;
        SET p_conflict_info = JSON_OBJECT(
            'error', 'version_conflict',
            'expected_version', p_expected_content_version,
            'current_version', @current_version,
            'last_editor', @last_editor,
            'last_edit_time', @last_time
        );
    END IF;
    
    sp_end:
END //
DELIMITER ;
```

### 6.4 åˆ†å¸ƒå¼ç¼“å­˜æ›´æ–°


**ğŸ”„ åˆ†å¸ƒå¼ç¼“å­˜ä¸€è‡´æ€§æ§åˆ¶**
```sql
-- ç¼“å­˜é¡¹ç‰ˆæœ¬æ§åˆ¶è¡¨
CREATE TABLE cache_version_control (
    cache_key VARCHAR(255) PRIMARY KEY,
    cache_value LONGTEXT,
    value_type ENUM('STRING', 'JSON', 'BINARY', 'NUMBER') DEFAULT 'STRING',
    
    -- ç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯
    version BIGINT NOT NULL DEFAULT 1,
    checksum VARCHAR(64),  -- ç”¨äºéªŒè¯æ•°æ®å®Œæ•´æ€§
    
    -- åˆ†å¸ƒå¼ç›¸å…³
    node_id VARCHAR(50),   -- æœ€åæ›´æ–°çš„èŠ‚ç‚¹
    cluster_version BIGINT DEFAULT 1,  -- é›†ç¾¤çº§ç‰ˆæœ¬å·
    
    -- è¿‡æœŸæ§åˆ¶
    expires_at TIMESTAMP NULL,
    ttl_seconds INT DEFAULT 3600,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_key_version (cache_key, version),
    INDEX idx_expires_at (expires_at),
    INDEX idx_node_cluster_version (node_id, cluster_version)
);

-- åˆ†å¸ƒå¼å®‰å…¨æ›´æ–°
DELIMITER //
CREATE PROCEDURE DistributedCacheUpdate(
    IN p_cache_key VARCHAR(255),
    IN p_cache_value LONGTEXT,
    IN p_node_id VARCHAR(50),
    IN p_expected_version BIGINT,
    IN p_ttl_seconds INT,
    OUT p_result_code INT,
    OUT p_new_version BIGINT
)
BEGIN
    DECLARE v_current_checksum VARCHAR(64);
    DECLARE v_new_checksum VARCHAR(64);
    DECLARE v_affected_rows INT;
    
    -- è®¡ç®—æ–°å€¼çš„æ ¡éªŒå’Œ
    SET v_new_checksum = SHA2(p_cache_value, 256);
    
    -- å¦‚æœæ˜¯æ–°keyï¼Œç›´æ¥æ’å…¥
    IF p_expected_version = 0 THEN
        INSERT INTO cache_version_control (
            cache_key, cache_value, checksum, node_id,
            expires_at, ttl_seconds
        ) VALUES (
            p_cache_key, p_cache_value, v_new_checksum, p_node_id,
            DATE_ADD(NOW(), INTERVAL p_ttl_seconds SECOND), p_ttl_seconds
        )
        ON DUPLICATE KEY UPDATE
            cache_value = VALUES(cache_value),
            version = version + 1,
            checksum = VALUES(checksum),
            node_id = VALUES(node_id),
            expires_at = VALUES(expires_at),
            ttl_seconds = VALUES(ttl_seconds),
            cluster_version = cluster_version + 1;
        
        SELECT version INTO p_new_version
        FROM cache_version_control
        WHERE cache_key = p_cache_key;
        
        SET p_result_code = 1;
        LEAVE sp_end;
    END IF;
    
    -- æ‰§è¡Œç‰ˆæœ¬æ§åˆ¶æ›´æ–°
    UPDATE cache_version_control
    SET cache_value = p_cache_value,
        version = version + 1,
        checksum = v_new_checksum,
        node_id = p_node_id,
        expires_at = DATE_ADD(NOW(), INTERVAL p_ttl_seconds SECOND),
        ttl_seconds = p_ttl_seconds,
        cluster_version = cluster_version + 1
    WHERE cache_key = p_cache_key 
      AND version = p_expected_version
      AND (expires_at IS NULL OR expires_at > NOW());  -- ç¡®ä¿æœªè¿‡æœŸ
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        SELECT version INTO p_new_version
        FROM cache_version_control
        WHERE cache_key = p_cache_key;
        SET p_result_code = 1;
    ELSE
        SET p_result_code = 0;  -- ç‰ˆæœ¬å†²çªæˆ–keyå·²è¿‡æœŸ
        SET p_new_version = -1;
    END IF;
    
    sp_end:
END //
DELIMITER ;
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹


### 7.1 ä¹è§‚é”æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸš€ ç´¢å¼•ä¼˜åŒ–**
```sql
-- 1. å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE TABLE optimized_account (
    account_id BIGINT PRIMARY KEY,
    balance DECIMAL(15,2),
    version BIGINT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- æ ¸å¿ƒç´¢å¼•ï¼šæ”¯æŒç‰ˆæœ¬æ§åˆ¶æŸ¥è¯¢
    INDEX idx_account_version (account_id, version),
    
    -- è¦†ç›–ç´¢å¼•ï¼šé¿å…å›è¡¨æŸ¥è¯¢
    INDEX idx_balance_version_covering (account_id, balance, version)
);

-- 2. åˆ†åŒºè¡¨ä¼˜åŒ–å¤§æ•°æ®é‡åœºæ™¯
CREATE TABLE partitioned_transactions (
    id BIGINT AUTO_INCREMENT,
    account_id BIGINT,
    amount DECIMAL(15,2),
    transaction_type ENUM('DEBIT', 'CREDIT'),
    version BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id, created_at),  -- åŒ…å«åˆ†åŒºå­—æ®µ
    INDEX idx_account_version (account_id, version)
)
PARTITION BY RANGE (UNIX_TIMESTAMP(created_at)) (
    PARTITION p2024_01 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01')),
    PARTITION p2024_02 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01')),
    PARTITION p2024_03 VALUES LESS THAN (UNIX_TIMESTAMP('2024-04-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

**ğŸ’¾ ç¼“å­˜ä¼˜åŒ–ç­–ç•¥**
```sql
-- 1. ç‰ˆæœ¬ä¿¡æ¯ç¼“å­˜è¡¨
CREATE TABLE version_cache (
    record_id VARCHAR(100) PRIMARY KEY,
    table_name VARCHAR(50),
    current_version BIGINT,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_table_updated (table_name, last_updated)
);

-- 2. æ‰¹é‡ç‰ˆæœ¬æ£€æŸ¥
SELECT 
    vc.record_id,
    vc.current_version,
    CASE 
        WHEN vc.current_version = expected.version THEN 'VALID'
        ELSE 'OUTDATED'
    END as version_status
FROM version_cache vc
INNER JOIN (
    SELECT '1' as record_id, 10 as version
    UNION ALL SELECT '2' as record_id, 15 as version
    UNION ALL SELECT '3' as record_id, 8 as version
) expected ON vc.record_id = expected.record_id;
```

### 7.2 å†²çªå¤„ç†ä¼˜åŒ–


**ğŸ”„ æ™ºèƒ½é‡è¯•ç­–ç•¥**
```java
public class OptimisticLockRetryManager {
    private final Random random = new Random();
    
    // æŒ‡æ•°é€€é¿ + æŠ–åŠ¨
    public <T> T executeWithRetry(String operation, Supplier<T> action, int maxRetries) {
        Exception lastException = null;
        
        for (int attempt = 0; attempt < maxRetries; attempt++) {
            try {
                return action.get();
            } catch (OptimisticLockException e) {
                lastException = e;
                
                if (attempt == maxRetries - 1) {
                    break;  // æœ€åä¸€æ¬¡é‡è¯•å¤±è´¥
                }
                
                // è®¡ç®—é€€é¿æ—¶é—´ï¼šåŸºç¡€æ—¶é—´ + æŒ‡æ•°å¢é•¿ + éšæœºæŠ–åŠ¨
                int baseDelay = 10;  // åŸºç¡€å»¶è¿Ÿ10ms
                int exponentialDelay = (int) Math.pow(2, attempt) * baseDelay;
                int jitter = random.nextInt(baseDelay * 2);  // æŠ–åŠ¨èŒƒå›´
                int totalDelay = Math.min(exponentialDelay + jitter, 1000);  // æœ€å¤§1ç§’
                
                try {
                    Thread.sleep(totalDelay);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException("Interrupted during retry", ie);
                }
            }
        }
        
        throw new RuntimeException("Operation " + operation + " failed after " + maxRetries + " retries", lastException);
    }
}
```

**ğŸ“Š å†²çªç›‘æ§å’Œåˆ†æ**
```sql
-- åˆ›å»ºå†²çªç›‘æ§è¡¨
CREATE TABLE optimistic_lock_metrics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50),
    operation_type VARCHAR(20),
    conflict_count INT DEFAULT 0,
    success_count INT DEFAULT 0,
    total_retry_count INT DEFAULT 0,
    avg_retry_count DECIMAL(5,2) DEFAULT 0,
    max_retry_count INT DEFAULT 0,
    hour_bucket TIMESTAMP,
    
    UNIQUE KEY uk_table_op_hour (table_name, operation_type, hour_bucket)
);

-- å®šæœŸæ±‡æ€»å†²çªç»Ÿè®¡
INSERT INTO optimistic_lock_metrics (
    table_name, operation_type, conflict_count, success_count,
    total_retry_count, avg_retry_count, max_retry_count, hour_bucket
)
SELECT 
    'user_account' as table_name,
    'UPDATE' as operation_type,
    SUM(CASE WHEN result_status = 'CONFLICT' THEN 1 ELSE 0 END) as conflict_count,
    SUM(CASE WHEN result_status = 'SUCCESS' THEN 1 ELSE 0 END) as success_count,
    SUM(retry_count) as total_retry_count,
    AVG(retry_count) as avg_retry_count,
    MAX(retry_count) as max_retry_count,
    DATE_FORMAT(created_at, '%Y-%m-%d %H:00:00') as hour_bucket
FROM cas_operation_log
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY hour_bucket
ON DUPLICATE KEY UPDATE
    conflict_count = VALUES(conflict_count),
    success_count = VALUES(success_count),
    total_retry_count = VALUES(total_retry_count),
    avg_retry_count = VALUES(avg_retry_count),
    max_retry_count = VALUES(max_retry_count);
```

### 7.3 æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ


**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹**

**1. ABAé—®é¢˜çš„é¢„é˜²**
```sql
-- é—®é¢˜åœºæ™¯ï¼šç‰ˆæœ¬å·ä»Aå˜ä¸ºBå†å˜å›Aï¼Œä½†æ•°æ®å®é™…å·²å˜åŒ–
-- è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´æˆ³æˆ–å¤åˆç‰ˆæœ¬å·

-- æ–¹æ¡ˆ1ï¼šæ—¶é—´æˆ³ç‰ˆæœ¬é¿å…ABA
CREATE TABLE aba_safe_data (
    id BIGINT PRIMARY KEY,
    data_value INT,
    version_timestamp TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
    sequence_number INT DEFAULT 0
);

-- æ–¹æ¡ˆ2ï¼šç‰ˆæœ¬å·+æ ¡éªŒå’Œ
CREATE TABLE checksum_protected_data (
    id BIGINT PRIMARY KEY,
    data_content TEXT,
    version BIGINT DEFAULT 1,
    content_checksum VARCHAR(64),  -- å†…å®¹æ ¡éªŒå’Œ
    
    INDEX idx_id_version_checksum (id, version, content_checksum)
);

-- æ›´æ–°æ—¶åŒæ—¶æ£€æŸ¥ç‰ˆæœ¬å’Œæ ¡éªŒå’Œ
UPDATE checksum_protected_data
SET data_content = ?,
    version = version + 1,
    content_checksum = SHA2(?, 256)
WHERE id = ? 
  AND version = ? 
  AND content_checksum = SHA2(?, 256);  -- åŒé‡æ£€æŸ¥
```

**2. é•¿äº‹åŠ¡çš„ç‰ˆæœ¬å†²çªå¤„ç†**
```sql
-- é¿å…åœ¨é•¿äº‹åŠ¡ä¸­ä½¿ç”¨ä¹è§‚é”
-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šé•¿äº‹åŠ¡+ä¹è§‚é”
START TRANSACTION;
SELECT * FROM account WHERE id = 1;  -- è¯»å–ç‰ˆæœ¬å·
-- ... æ‰§è¡Œå¤§é‡å…¶ä»–æ“ä½œï¼Œè€—æ—¶å¾ˆé•¿ ...
UPDATE account SET balance = balance - 100, version = version + 1 
WHERE id = 1 AND version = ?;  -- ç‰ˆæœ¬å†²çªæ¦‚ç‡å¾ˆé«˜
COMMIT;

-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šçŸ­äº‹åŠ¡+ä¹è§‚é”
-- å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
START TRANSACTION;
SELECT * FROM account WHERE id = 1;
UPDATE account SET balance = balance - 100, version = version + 1 
WHERE id = 1 AND version = ?;
COMMIT;
```

**3. çƒ­ç‚¹æ•°æ®çš„ç‰¹æ®Šå¤„ç†**
```sql
-- å¯¹äºé«˜å¹¶å‘çƒ­ç‚¹æ•°æ®ï¼Œè€ƒè™‘åˆ†ç‰‡æˆ–é˜Ÿåˆ—åŒ–å¤„ç†
-- ç¤ºä¾‹ï¼šå•†å“ç§’æ€åœºæ™¯

-- æ–¹æ¡ˆ1ï¼šåº“å­˜åˆ†ç‰‡
CREATE TABLE inventory_shards (
    shard_id INT,
    product_id BIGINT,
    shard_stock INT,
    version BIGINT DEFAULT 1,
    
    PRIMARY KEY (shard_id, product_id),
    INDEX idx_product_version (product_id, shard_id, version)
);

-- éšæœºé€‰æ‹©åˆ†ç‰‡è¿›è¡Œåº“å­˜æ‰£å‡
SET @shard = FLOOR(RAND() * 10);  -- å‡è®¾10ä¸ªåˆ†ç‰‡
UPDATE inventory_shards
SET shard_stock = shard_stock - 1,
    version = version + 1
WHERE shard_id = @shard 
  AND product_id = ? 
  AND version = ?
  AND shard_stock > 0;
```

**4. ç›‘æ§å‘Šè­¦è®¾ç½®**
```sql
-- è®¾ç½®ä¹è§‚é”å†²çªç‡ç›‘æ§
SELECT 
    table_name,
    operation_type,
    hour_bucket,
    (conflict_count * 100.0 / (conflict_count + success_count)) as conflict_rate_percent
FROM optimistic_lock_metrics
WHERE hour_bucket >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
  AND (conflict_count + success_count) > 100  -- è¶³å¤Ÿçš„æ ·æœ¬é‡
  AND (conflict_count * 100.0 / (conflict_count + success_count)) > 10;  -- å†²çªç‡è¶…è¿‡10%å‘Šè­¦

-- å‘Šè­¦æŸ¥è¯¢ï¼šæ£€æµ‹å¼‚å¸¸é«˜çš„å†²çªç‡
SELECT 
    table_name,
    operation_type,
    COUNT(*) as high_conflict_hours,
    AVG(conflict_rate_percent) as avg_conflict_rate,
    MAX(conflict_rate_percent) as max_conflict_rate
FROM (
    SELECT 
        table_name,
        operation_type,
        hour_bucket,
        (conflict_count * 100.0 / (conflict_count + success_count)) as conflict_rate_percent
    FROM optimistic_lock_metrics
    WHERE hour_bucket >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
      AND (conflict_count + success_count) > 50
) t
WHERE conflict_rate_percent > 15  -- å†²çªç‡è¶…è¿‡15%è®¤ä¸ºæ˜¯å¼‚å¸¸
GROUP BY table_name, operation_type
HAVING high_conflict_hours > 2;  -- è¿ç»­2å°æ—¶ä»¥ä¸Šé«˜å†²çª
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä¹è§‚é”vsæ‚²è§‚é”ç†è§£**
```
æ‚²è§‚é”ï¼š
âœ“ å…ˆåŠ é”å†æ“ä½œï¼Œç¡®ä¿æ•°æ®ä¸è¢«ä¿®æ”¹
âœ“ é€‚ç”¨äºå†²çªé¢‘ç¹ã€æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯
âœ— å¹¶å‘æ€§èƒ½å·®ï¼Œå®¹æ˜“é€ æˆé˜»å¡

ä¹è§‚é”ï¼š
âœ“ å…ˆæ“ä½œå†æ£€æŸ¥ï¼Œé€šè¿‡ç‰ˆæœ¬æ§åˆ¶æ£€æµ‹å†²çª
âœ“ é€‚ç”¨äºè¯»å¤šå†™å°‘ã€é«˜å¹¶å‘çš„åœºæ™¯
âœ— å†²çªæ—¶éœ€è¦é‡è¯•ï¼Œå¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ
```

**ğŸ”¸ ç‰ˆæœ¬æ§åˆ¶æ ¸å¿ƒæœºåˆ¶**
```
æ•´æ•°ç‰ˆæœ¬å·ï¼š
- ç®€å•é«˜æ•ˆï¼Œé€‚ç”¨äºå¤§éƒ¨åˆ†åœºæ™¯
- æ¯æ¬¡æ›´æ–°version = version + 1
- æ›´æ–°æ—¶æ£€æŸ¥AND version = expected_version

æ—¶é—´æˆ³ç‰ˆæœ¬å·ï¼š
- ä¸šåŠ¡å«ä¹‰æ˜ç¡®ï¼Œä¾¿äºè°ƒè¯•è¿½è¸ª
- å¤©ç„¶å•è°ƒé€’å¢ï¼Œåˆ†å¸ƒå¼å‹å¥½
- éœ€è¦è€ƒè™‘æ—¶é—´ç²¾åº¦å’Œæ—¶é’ŸåŒæ­¥é—®é¢˜
```

**ğŸ”¸ CASæ“ä½œæœ¬è´¨**
```
Compare-And-Swapä¸‰æ­¥éª¤ï¼š
1. Compareï¼šæ¯”è¾ƒå½“å‰å€¼æ˜¯å¦ç­‰äºæœŸæœ›å€¼
2. Andï¼šåªæœ‰æ¯”è¾ƒæˆåŠŸæ‰æ‰§è¡Œä¸‹ä¸€æ­¥
3. Swapï¼šå°†å½“å‰å€¼æ›´æ–°ä¸ºæ–°å€¼

æ ¸å¿ƒSQLæ¨¡å¼ï¼š
UPDATE table SET data = new_value, version = version + 1
WHERE id = ? AND version = expected_version;
```

### 8.2 å®ç”¨æ“ä½œæŠ€èƒ½


**ğŸ› ï¸ ç‰ˆæœ¬æ§åˆ¶è¡¨è®¾è®¡æ ‡å‡†**
```sql
-- æ ‡å‡†ç‰ˆæœ¬æ§åˆ¶è¡¨è®¾è®¡æ¨¡æ¿
CREATE TABLE standard_versioned_table (
    id BIGINT PRIMARY KEY,
    business_data TEXT,           -- ä¸šåŠ¡æ•°æ®
    
    -- ç‰ˆæœ¬æ§åˆ¶å­—æ®µ
    version BIGINT NOT NULL DEFAULT 1,
    
    -- å®¡è®¡å­—æ®µ  
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
    INDEX idx_id_version (id, version),
    INDEX idx_updated_at (updated_at)
);
```

**ğŸ“ CASæ›´æ–°æ“ä½œæ¨¡æ¿**
```sql
-- é€šç”¨CASæ›´æ–°å­˜å‚¨è¿‡ç¨‹æ¨¡æ¿
DELIMITER //
CREATE PROCEDURE GenericCASUpdate(
    IN p_table_name VARCHAR(50),
    IN p_id BIGINT,
    IN p_expected_version BIGINT,
    OUT p_result_code INT,
    OUT p_new_version BIGINT
)
BEGIN
    DECLARE v_affected_rows INT;
    
    -- æ‰§è¡ŒCASæ›´æ–°ï¼ˆéœ€è¦åŠ¨æ€SQLï¼Œè¿™é‡Œä»…ä¸ºç¤ºæ„ï¼‰
    -- UPDATE p_table_name SET ..., version = version + 1 
    -- WHERE id = p_id AND version = p_expected_version;
    
    SET v_affected_rows = ROW_COUNT();
    
    IF v_affected_rows = 1 THEN
        SET p_result_code = 1;   -- æˆåŠŸ
        -- SELECT version INTO p_new_version FROM p_table_name WHERE id = p_id;
    ELSE
        SET p_result_code = 0;   -- ç‰ˆæœ¬å†²çª
        SET p_new_version = -1;
    END IF;
END //
DELIMITER ;
```

### 8.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**âš¡ é«˜å¹¶å‘ä¼˜åŒ–ç­–ç•¥**
```
ç´¢å¼•ä¼˜åŒ–ï¼š
- åˆ›å»ºå¤åˆç´¢å¼• (id, version)
- ä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨æŸ¥è¯¢
- åˆ†åŒºè¡¨å¤„ç†å¤§æ•°æ®é‡

å†²çªå‡å°‘ï¼š
- ç¼©çŸ­äº‹åŠ¡æ—¶é—´ï¼Œå‡å°‘ç‰ˆæœ¬å†²çªçª—å£
- çƒ­ç‚¹æ•°æ®åˆ†ç‰‡å¤„ç†
- ä½¿ç”¨é˜Ÿåˆ—å‰Šå³°å¡«è°·

é‡è¯•ç­–ç•¥ï¼š
- æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
- è®¾ç½®åˆç†çš„æœ€å¤§é‡è¯•æ¬¡æ•°
- è®°å½•é‡è¯•ç»Ÿè®¡ï¼Œç›‘æ§ç³»ç»Ÿå¥åº·åº¦
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡å»ºè®®**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
âœ“ å†²çªç‡ï¼šconflict_count / total_operations
âœ“ å¹³å‡é‡è¯•æ¬¡æ•°ï¼šavg_retry_count  
âœ“ æœ€å¤§é‡è¯•æ¬¡æ•°ï¼šmax_retry_count
âœ“ æ“ä½œæˆåŠŸç‡ï¼šsuccess_count / total_operations
âœ“ å“åº”æ—¶é—´ï¼šåŒ…å«é‡è¯•æ—¶é—´çš„æ€»å“åº”æ—¶é—´

å‘Šè­¦é˜ˆå€¼å»ºè®®ï¼š
- å†²çªç‡ > 15%ï¼šéœ€è¦å…³æ³¨
- å†²çªç‡ > 30%ï¼šéœ€è¦ä¼˜åŒ–
- å¹³å‡é‡è¯•æ¬¡æ•° > 2ï¼šç³»ç»Ÿå‹åŠ›å¤§
- æœ€å¤§é‡è¯•æ¬¡æ•° > 5ï¼šå¯èƒ½æœ‰çƒ­ç‚¹é—®é¢˜
```

### 8.4 åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—


**ğŸ¯ ä¹è§‚é”é€‚ç”¨åœºæ™¯**
```
âœ… æ¨èä½¿ç”¨ä¹è§‚é”ï¼š
- è¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œï¼ˆè¯»å†™æ¯” > 5:1ï¼‰
- æ•°æ®å†²çªæ¦‚ç‡è¾ƒä½ï¼ˆ< 10%ï¼‰
- å¯¹å“åº”æ—¶é—´è¦æ±‚é«˜
- é«˜å¹¶å‘è®¿é—®åœºæ™¯
- åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒ

âŒ ä¸æ¨èä¹è§‚é”ï¼š
- å†™æ“ä½œé¢‘ç¹ï¼Œå†²çªç‡é«˜ï¼ˆ> 30%ï¼‰
- é•¿äº‹åŠ¡å¤„ç†
- å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æå…¶ä¸¥æ ¼
- é‡è¯•æˆæœ¬å¾ˆé«˜çš„ä¸šåŠ¡åœºæ™¯
```

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**
```
ç‰ˆæœ¬æ§åˆ¶ç±»å‹é€‰æ‹©ï¼š
- ç®€å•ä¸šåŠ¡ â†’ æ•´æ•°ç‰ˆæœ¬å·
- éœ€è¦å®¡è®¡è¿½è¸ª â†’ æ—¶é—´æˆ³ç‰ˆæœ¬å·
- åˆ†å¸ƒå¼ç¯å¢ƒ â†’ å¤åˆç‰ˆæœ¬å·
- é«˜é¢‘æ›´æ–° â†’ å¾®ç§’æ—¶é—´æˆ³

å®ç°æ–¹å¼é€‰æ‹©ï¼š
- å•è¡¨æ“ä½œ â†’ åº”ç”¨å±‚CAS
- å¤šè¡¨äº‹åŠ¡ â†’ æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹
- è·¨æœåŠ¡æ“ä½œ â†’ åˆ†å¸ƒå¼é” + ç‰ˆæœ¬æ§åˆ¶
- ç¼“å­˜åœºæ™¯ â†’ æ—¶é—´æˆ³ + TTLæ§åˆ¶
```

### 8.5 æ•…éšœå¤„ç†æŒ‡å—


**ğŸš¨ å¸¸è§é—®é¢˜è¯Šæ–­**
```
é—®é¢˜1ï¼šå†²çªç‡çªç„¶å‡é«˜
è¯Šæ–­æ­¥éª¤ï¼š
1. æ£€æŸ¥æ˜¯å¦æœ‰å¤§æ‰¹é‡æ“ä½œ
2. æŸ¥çœ‹çƒ­ç‚¹æ•°æ®è®¿é—®æ¨¡å¼  
3. åˆ†æé‡è¯•é—´éš”æ˜¯å¦åˆç†
4. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

é—®é¢˜2ï¼šABAé—®é¢˜å¯¼è‡´æ•°æ®å¼‚å¸¸
è§£å†³æ–¹æ¡ˆï¼š
1. ä½¿ç”¨æ—¶é—´æˆ³ç‰ˆæœ¬å·
2. å¢åŠ æ•°æ®æ ¡éªŒå’Œæ£€æŸ¥
3. è®°å½•è¯¦ç»†çš„æ“ä½œæ—¥å¿—
4. å®æ–½æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ

é—®é¢˜3ï¼šé•¿äº‹åŠ¡ç‰ˆæœ¬å†²çª
ä¼˜åŒ–æ–¹æ¡ˆï¼š
1. æ‹†åˆ†é•¿äº‹åŠ¡ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡
2. å»¶è¿Ÿç‰ˆæœ¬æ£€æŸ¥åˆ°äº‹åŠ¡æœ«å°¾
3. ä½¿ç”¨æ‚²è§‚é”æ›¿ä»£ä¹è§‚é”
4. å®æ–½äº‹åŠ¡ä¼˜å…ˆçº§ç®¡ç†
```

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
```
è®¾è®¡åŸåˆ™ï¼š
âœ“ ç‰ˆæœ¬å­—æ®µè®¾è®¡åˆç†ï¼ˆç±»å‹ã€ç´¢å¼•ã€é»˜è®¤å€¼ï¼‰
âœ“ æ›´æ–°æ“ä½œåŸå­åŒ–ï¼ˆæ•°æ®+ç‰ˆæœ¬åŒæ—¶æ›´æ–°ï¼‰
âœ“ å†²çªå¤„ç†ç­–ç•¥å®Œæ•´ï¼ˆé‡è¯•ã€é™çº§ã€å‘Šè­¦ï¼‰
âœ“ æ€§èƒ½ç›‘æ§å…¨é¢ï¼ˆå†²çªç‡ã€é‡è¯•æ¬¡æ•°ã€å“åº”æ—¶é—´ï¼‰

å¼€å‘è§„èŒƒï¼š
âœ“ ç»Ÿä¸€ç‰ˆæœ¬æ§åˆ¶æ›´æ–°æ¨¡å¼
âœ“ å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶  
âœ“ è¯¦ç»†çš„æ“ä½œæ—¥å¿—è®°å½•
âœ“ å®šæœŸçš„æ€§èƒ½æŒ‡æ ‡åˆ†æ

è¿ç»´è¦æ±‚ï¼š
âœ“ ç›‘æ§ç³»ç»Ÿå†²çªç‡å’Œé‡è¯•æƒ…å†µ
âœ“ å®šæœŸåˆ†æçƒ­ç‚¹æ•°æ®å’Œè®¿é—®æ¨¡å¼
âœ“ å»ºç«‹å†²çªç‡å‘Šè­¦å’Œå¤„ç†æµç¨‹
âœ“ åˆ¶å®šå®¹é‡è§„åˆ’å’Œæ‰©å±•ç­–ç•¥
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¹è§‚é”é€šè¿‡ç‰ˆæœ¬æ§åˆ¶å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºè¯»å¤šå†™å°‘åœºæ™¯
- CASæ“ä½œæ˜¯ä¹è§‚é”çš„æ ¸å¿ƒï¼ŒCompare-And-Swapç¡®ä¿åŸå­æ€§æ›´æ–°  
- ç‰ˆæœ¬å·è®¾è®¡è¦è€ƒè™‘ä¸šåŠ¡ç‰¹ç‚¹ï¼Œæ•´æ•°ç®€å•é«˜æ•ˆï¼Œæ—¶é—´æˆ³ä¾¿äºè°ƒè¯•
- å†²çªå¤„ç†éœ€è¦æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼Œç›‘æ§å‘Šè­¦ä¿éšœç³»ç»Ÿç¨³å®šæ€§