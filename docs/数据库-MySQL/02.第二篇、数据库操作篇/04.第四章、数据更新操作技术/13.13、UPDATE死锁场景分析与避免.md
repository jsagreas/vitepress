---
title: 13ã€UPDATEæ­»é”åœºæ™¯åˆ†æä¸é¿å…
---
## ğŸ“š ç›®å½•

1. [UPDATEæ­»é”åŸºæœ¬æ¦‚å¿µ](#1-UPDATEæ­»é”åŸºæœ¬æ¦‚å¿µ)
2. [æ­»é”äº§ç”Ÿæœºåˆ¶åˆ†æ](#2-æ­»é”äº§ç”Ÿæœºåˆ¶åˆ†æ)
3. [å…¸å‹æ­»é”åœºæ™¯å‰–æ](#3-å…¸å‹æ­»é”åœºæ™¯å‰–æ)
4. [æ­»é”æ£€æµ‹ç®—æ³•åŸç†](#4-æ­»é”æ£€æµ‹ç®—æ³•åŸç†)
5. [å¹¶å‘æ›´æ–°å†²çªå¤„ç†](#5-å¹¶å‘æ›´æ–°å†²çªå¤„ç†)
6. [æ­»é”é¢„é˜²ç­–ç•¥](#6-æ­»é”é¢„é˜²ç­–ç•¥)
7. [æ­»é”æ—¥å¿—åˆ†ææŠ€æœ¯](#7-æ­»é”æ—¥å¿—åˆ†ææŠ€æœ¯)
8. [åº”ç”¨å±‚æ­»é”é¿å…å®è·µ](#8-åº”ç”¨å±‚æ­»é”é¿å…å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ UPDATEæ­»é”åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯UPDATEæ­»é”


**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡ä¸¤ä¸ªäººåŒæ—¶æƒ³è¦äº¤æ¢æ‰‹ä¸­çš„é’¥åŒ™ï¼šAæ‹¿ç€1å·é’¥åŒ™æƒ³è¦2å·é’¥åŒ™ï¼ŒBæ‹¿ç€2å·é’¥åŒ™æƒ³è¦1å·é’¥åŒ™ã€‚ç»“æœå°±æ˜¯ä¸¤äººéƒ½åœ¨ç­‰å¯¹æ–¹å…ˆç»™é’¥åŒ™ï¼Œè°ä¹Ÿæ— æ³•å®Œæˆäº¤æ¢ï¼Œè¿™å°±æ˜¯**æ­»é”**ã€‚

åœ¨æ•°æ®åº“ä¸­ï¼ŒUPDATEæ­»é”å°±æ˜¯å¤šä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰äº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„æƒ…å†µã€‚

**ğŸ”¸ æ­»é”çš„æœ¬è´¨ç‰¹å¾**
- **å¾ªç¯ç­‰å¾…**ï¼šäº‹åŠ¡Aç­‰å¾…äº‹åŠ¡Bï¼Œäº‹åŠ¡Bç­‰å¾…äº‹åŠ¡A
- **èµ„æºç«äº‰**ï¼šå¤šä¸ªäº‹åŠ¡äº‰å¤ºç›¸åŒçš„æ•°æ®è¡Œæˆ–è¡¨
- **æ— æ³•è‡ªè§£**ï¼šæ²¡æœ‰å¤–éƒ¨å¹²é¢„ï¼Œæ­»é”æ°¸è¿œæ— æ³•è§£å†³
- **ç³»ç»Ÿæ£€æµ‹**ï¼šæ•°æ®åº“ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶è§£å†³æ­»é”

### 1.2 UPDATEæ­»é”ä¸å…¶ä»–é”çš„åŒºåˆ«


**é”ç±»å‹å¯¹æ¯”**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é”ç±»å‹        â”‚   é”å®šèŒƒå›´       â”‚   æ­»é”æ¦‚ç‡       â”‚   å½±å“ç¨‹åº¦       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELECTé”       â”‚   å…±äº«é”(S)      â”‚   æä½           â”‚   è¯»å–é˜»å¡       â”‚
â”‚ UPDATEé”       â”‚   æ’ä»–é”(X)      â”‚   é«˜             â”‚   è¯»å†™å…¨é˜»å¡     â”‚
â”‚ INSERTé”       â”‚   æ’ä»–é”(X)      â”‚   ä¸­ç­‰           â”‚   å†™å…¥é˜»å¡       â”‚
â”‚ DELETEé”       â”‚   æ’ä»–é”(X)      â”‚   ä¸­ç­‰           â”‚   è¯»å†™å…¨é˜»å¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆUPDATEæœ€å®¹æ˜“æ­»é”**ï¼š
- **é•¿æ—¶é—´æŒé”**ï¼šUPDATEéœ€è¦å…ˆè¯»å–å†ä¿®æ”¹ï¼ŒæŒé”æ—¶é—´é•¿
- **èŒƒå›´é”å®š**ï¼šå¯èƒ½é”å®šå¤šè¡Œæ•°æ®
- **é¢‘ç¹æ“ä½œ**ï¼šä¸šåŠ¡ä¸­UPDATEæ“ä½œæœ€é¢‘ç¹
- **å¤æ‚é€»è¾‘**ï¼šUPDATEè¯­å¥å¾€å¾€åŒ…å«å¤æ‚çš„WHEREæ¡ä»¶

### 1.3 æ­»é”å¯¹ä¸šåŠ¡çš„å½±å“


**ç›´æ¥å½±å“**ï¼š
```
äº‹åŠ¡å›æ»š â†’ æ•°æ®ä¸ä¸€è‡´ â†’ ç”¨æˆ·æ“ä½œå¤±è´¥ â†’ ä¸šåŠ¡æµç¨‹ä¸­æ–­
```

**é—´æ¥å½±å“**ï¼š
- **æ€§èƒ½ä¸‹é™**ï¼šé¢‘ç¹çš„æ­»é”æ£€æµ‹æ¶ˆè€—ç³»ç»Ÿèµ„æº
- **ç”¨æˆ·ä½“éªŒå·®**ï¼šæ“ä½œå¤±è´¥éœ€è¦é‡è¯•
- **æ•°æ®å®Œæ•´æ€§é£é™©**ï¼šéƒ¨åˆ†äº‹åŠ¡å›æ»šå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **ç³»ç»Ÿç¨³å®šæ€§å½±å“**ï¼šå¤§é‡æ­»é”å¯èƒ½å¯¼è‡´ç³»ç»Ÿå“åº”ç¼“æ…¢

---

## 2. âš™ï¸ æ­»é”äº§ç”Ÿæœºåˆ¶åˆ†æ


### 2.1 æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶


**ğŸ”¸ äº’æ–¥æ¡ä»¶**
```
å«ä¹‰ï¼šèµ„æºåœ¨åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡ä½¿ç”¨
æ•°æ®åº“è¡¨ç°ï¼šæ’ä»–é”(Xé”)åŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰

ç¤ºä¾‹ï¼š
äº‹åŠ¡Aï¼šUPDATE users SET balance = 100 WHERE id = 1;  (æŒæœ‰id=1çš„Xé”)
äº‹åŠ¡Bï¼šUPDATE users SET balance = 200 WHERE id = 1;  (ç­‰å¾…id=1çš„Xé”)
```

**ğŸ”¸ è¯·æ±‚å’Œä¿æŒæ¡ä»¶**
```
å«ä¹‰ï¼šäº‹åŠ¡å·²ç»æŒæœ‰é”ï¼ŒåŒæ—¶è¿˜åœ¨è¯·æ±‚æ–°çš„é”
æ•°æ®åº“è¡¨ç°ï¼šäº‹åŠ¡æŒæœ‰éƒ¨åˆ†é”çš„åŒæ—¶è¿˜åœ¨ç”³è¯·å…¶ä»–é”

ç¤ºä¾‹ï¼š
äº‹åŠ¡Aå·²æŒæœ‰ï¼šid=1çš„é”
äº‹åŠ¡Aè¯·æ±‚ï¼š  id=2çš„é”
```

**ğŸ”¸ ä¸å¯æŠ¢å æ¡ä»¶**
```
å«ä¹‰ï¼šå·²è·å¾—çš„é”ä¸èƒ½è¢«å¼ºåˆ¶é‡Šæ”¾
æ•°æ®åº“è¡¨ç°ï¼šé™¤äº†æ­»é”æ£€æµ‹å™¨ï¼Œå…¶ä»–äº‹åŠ¡æ— æ³•å¼ºåˆ¶é‡Šæ”¾é”

ç¤ºä¾‹ï¼š
äº‹åŠ¡AæŒæœ‰é”åï¼Œäº‹åŠ¡Bæ— æ³•å¼ºåˆ¶Aé‡Šæ”¾é”
åªèƒ½ç­‰å¾…Aä¸»åŠ¨é‡Šæ”¾æˆ–æ­»é”æ£€æµ‹å™¨å¹²é¢„
```

**ğŸ”¸ å¾ªç¯ç­‰å¾…æ¡ä»¶**
```
å«ä¹‰ï¼šå­˜åœ¨äº‹åŠ¡ç­‰å¾…ç¯è·¯
æ•°æ®åº“è¡¨ç°ï¼šAç­‰Bï¼ŒBç­‰Cï¼ŒCç­‰Aå½¢æˆç¯è·¯

ç¤ºä¾‹ï¼š
äº‹åŠ¡Aç­‰å¾…äº‹åŠ¡Bé‡Šæ”¾é”
äº‹åŠ¡Bç­‰å¾…äº‹åŠ¡Cé‡Šæ”¾é”  
äº‹åŠ¡Cç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾é”
```

### 2.2 UPDATEæ­»é”å½¢æˆè¿‡ç¨‹


**ğŸ”§ å…¸å‹æ­»é”æ—¶åºå›¾**ï¼š
```
æ—¶é—´çº¿    äº‹åŠ¡A                    äº‹åŠ¡B
  |
  1    BEGIN;                    BEGIN;
  |
  2    UPDATE users SET          
  |    balance = 100             
  |    WHERE id = 1;            
  |    (è·å¾—id=1çš„Xé”)          
  |
  3                              UPDATE users SET
  |                              balance = 200
  |                              WHERE id = 2;  
  |                              (è·å¾—id=2çš„Xé”)
  |
  4    UPDATE users SET          
  |    balance = 150             
  |    WHERE id = 2;            
  |    (ç­‰å¾…id=2çš„Xé”) â†â”€â”€â”€â”€â”€â”   
  |                          â”‚   
  5                          â””â”€â†’ UPDATE users SET
  |                              balance = 250
  |                              WHERE id = 1;
  |                              (ç­‰å¾…id=1çš„Xé”)
  |
  6    â† æ­»é”æ£€æµ‹å™¨å‘ç°å¾ªç¯ç­‰å¾… â†’
  |
  7    ERROR: Deadlock          äº‹åŠ¡å›æ»š
  |    detected                  
```

### 2.3 æ­»é”æ£€æµ‹çš„è§¦å‘æœºåˆ¶


**æ£€æµ‹è§¦å‘æ—¶æœº**ï¼š
- **é”ç­‰å¾…è¶…æ—¶**ï¼šå½“é”ç­‰å¾…æ—¶é—´è¶…è¿‡è®¾ç½®é˜ˆå€¼
- **å‘¨æœŸæ€§æ£€æµ‹**ï¼šç³»ç»Ÿå®šæœŸæ‰«æç­‰å¾…å›¾
- **è¯·æ±‚é˜»å¡æ—¶**ï¼šæ–°çš„é”è¯·æ±‚è¢«é˜»å¡æ—¶è§¦å‘æ£€æµ‹

**MySQLæ­»é”æ£€æµ‹å‚æ•°**ï¼š
```sql
-- æŸ¥çœ‹æ­»é”æ£€æµ‹ç›¸å…³å‚æ•°
SHOW VARIABLES LIKE '%deadlock%';
SHOW VARIABLES LIKE '%lock_wait_timeout%';

-- å¸¸è§å‚æ•°è®¾ç½®
SET innodb_deadlock_detect = ON;        -- å¼€å¯æ­»é”æ£€æµ‹
SET innodb_lock_wait_timeout = 50;      -- é”ç­‰å¾…è¶…æ—¶æ—¶é—´(ç§’)
SET innodb_print_all_deadlocks = ON;    -- è®°å½•æ‰€æœ‰æ­»é”ä¿¡æ¯
```

---

## 3. ğŸ¯ å…¸å‹æ­»é”åœºæ™¯å‰–æ


### 3.1 ç»å…¸åœºæ™¯ä¸€ï¼šäº¤å‰æ›´æ–°æ­»é”


**ğŸ”¥ åœºæ™¯æè¿°**
ä¸¤ä¸ªäº‹åŠ¡ä»¥ä¸åŒé¡ºåºæ›´æ–°ç›¸åŒçš„æ•°æ®è¡Œï¼Œæ˜¯æœ€å¸¸è§çš„æ­»é”åœºæ™¯ã€‚

**ä»£ç æ¼”ç¤º**ï¼š
```sql
-- åˆå§‹æ•°æ®
CREATE TABLE accounts (
    id INT PRIMARY KEY,
    balance DECIMAL(10,2),
    name VARCHAR(50)
);

INSERT INTO accounts VALUES 
(1, 1000.00, 'Alice'),
(2, 2000.00, 'Bob');
```

**æ­»é”å‘ç”Ÿè¿‡ç¨‹**ï¼š
```sql
-- äº‹åŠ¡A (è½¬è´¦ï¼šAlice â†’ Bob)
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- é”å®šid=1
-- æ­¤æ—¶è¢«äº‹åŠ¡Bé˜»å¡
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- ç­‰å¾…id=2çš„é”

-- äº‹åŠ¡B (è½¬è´¦ï¼šBob â†’ Alice) 
BEGIN;
UPDATE accounts SET balance = balance - 50 WHERE id = 2;   -- é”å®šid=2  
-- æ­¤æ—¶è¢«äº‹åŠ¡Aé˜»å¡ï¼Œå½¢æˆæ­»é”
UPDATE accounts SET balance = balance + 50 WHERE id = 1;   -- ç­‰å¾…id=1çš„é”
```

**æ­»é”åˆ†æå›¾**ï¼š
```
äº‹åŠ¡AæŒæœ‰é”    äº‹åŠ¡BæŒæœ‰é”
     â†“              â†“
  id=1çš„é”       id=2çš„é”
     â†‘              â†‘
äº‹åŠ¡Aç­‰å¾…      äº‹åŠ¡Bç­‰å¾…
     â†“              â†“
  id=2çš„é”       id=1çš„é”
     â†‘              â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       å½¢æˆå¾ªç¯ç­‰å¾…
```

### 3.2 ç»å…¸åœºæ™¯äºŒï¼šèŒƒå›´é”æ­»é”


**ğŸ”¥ åœºæ™¯æè¿°**  
å¤šä¸ªäº‹åŠ¡å¯¹é‡å èŒƒå›´è¿›è¡ŒUPDATEæ“ä½œæ—¶å‘ç”Ÿçš„æ­»é”ã€‚

**ä»£ç æ¼”ç¤º**ï¼š
```sql
-- æµ‹è¯•è¡¨
CREATE TABLE orders (
    id INT PRIMARY KEY,
    status VARCHAR(20),
    amount DECIMAL(10,2),
    created_time TIMESTAMP
);

-- äº‹åŠ¡Aï¼šæ›´æ–°ä»Šæ—¥è®¢å•çŠ¶æ€
BEGIN;
UPDATE orders 
SET status = 'processed' 
WHERE created_time >= '2025-01-20' AND amount > 100;

-- äº‹åŠ¡Bï¼šæ›´æ–°å¤§é¢è®¢å•çŠ¶æ€  
BEGIN;
UPDATE orders 
SET status = 'reviewed'
WHERE amount > 500 AND created_time >= '2025-01-19';
```

**æ­»é”åŸå› åˆ†æ**ï¼š
- **é”èŒƒå›´é‡å **ï¼šä¸¤ä¸ªUPDATEè¯­å¥çš„WHEREæ¡ä»¶æœ‰äº¤é›†
- **åŠ é”é¡ºåºä¸åŒ**ï¼šInnoDBæŒ‰ä¸åŒé¡ºåºç»™ç¬¦åˆæ¡ä»¶çš„è¡ŒåŠ é”
- **é—´éš™é”å†²çª**ï¼šèŒƒå›´æŸ¥è¯¢ä¼šäº§ç”Ÿé—´éš™é”ï¼Œå¢åŠ æ­»é”æ¦‚ç‡

### 3.3 ç»å…¸åœºæ™¯ä¸‰ï¼šå¤–é”®çº¦æŸæ­»é”


**ğŸ”¥ åœºæ™¯æè¿°**
æ¶‰åŠå¤–é”®å…³ç³»çš„è¡¨åœ¨UPDATEæ—¶å®¹æ˜“å‘ç”Ÿæ­»é”ã€‚

**è¡¨ç»“æ„è®¾è®¡**ï¼š
```sql
-- ä¸»è¡¨ï¼šç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    email VARCHAR(100)
);

-- ä»è¡¨ï¼šè®¢å•è¡¨
CREATE TABLE orders (
    id INT PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10,2),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**æ­»é”åœºæ™¯**ï¼š
```sql
-- äº‹åŠ¡Aï¼šæ›´æ–°ç”¨æˆ·åŒæ—¶æ’å…¥è®¢å•
BEGIN;
UPDATE users SET email = 'new@email.com' WHERE id = 1;
INSERT INTO orders (user_id, amount) VALUES (1, 100.00);

-- äº‹åŠ¡Bï¼šæ›´æ–°è®¢å•åŒæ—¶æ›´æ–°ç”¨æˆ·  
BEGIN;
UPDATE orders SET amount = 200.00 WHERE user_id = 1;
UPDATE users SET name = 'NewName' WHERE id = 1;
```

**æ­»é”æœºåˆ¶**ï¼š
- **å¤–é”®æ£€æŸ¥é”**ï¼šINSERTæ—¶éœ€è¦æ£€æŸ¥å¤–é”®ï¼Œä¼šåœ¨çˆ¶è¡¨åŠ å…±äº«é”
- **æ›´æ–°é”å†²çª**ï¼šåŒæ—¶UPDATEçˆ¶è¡¨æ—¶æ’ä»–é”ä¸å…±äº«é”å†²çª
- **é”å‡çº§æ­»é”**ï¼šå…±äº«é”å‡çº§ä¸ºæ’ä»–é”æ—¶å‘ç”Ÿå†²çª

### 3.4 ç»å…¸åœºæ™¯å››ï¼šç´¢å¼•é”æ­»é”


**ğŸ”¥ åœºæ™¯æè¿°**
ç”±äºç´¢å¼•ç»“æ„å¯¼è‡´çš„é”é¡ºåºä¸ä¸€è‡´å¼•å‘æ­»é”ã€‚

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
CREATE TABLE products (
    id INT PRIMARY KEY,
    category_id INT,
    price DECIMAL(10,2),
    status VARCHAR(20),
    INDEX idx_category (category_id),
    INDEX idx_price (price),
    INDEX idx_status (status)
);
```

**å¤åˆæ¡ä»¶UPDATEæ­»é”**ï¼š
```sql
-- äº‹åŠ¡Aï¼šæŒ‰åˆ†ç±»å’Œä»·æ ¼æ›´æ–°
BEGIN;
UPDATE products 
SET status = 'active' 
WHERE category_id = 1 AND price > 100;

-- äº‹åŠ¡Bï¼šæŒ‰ä»·æ ¼å’ŒçŠ¶æ€æ›´æ–°
BEGIN;  
UPDATE products
SET category_id = 2
WHERE price > 50 AND status = 'inactive';
```

**æ­»é”åˆ†æ**ï¼š
- **ç´¢å¼•é€‰æ‹©å·®å¼‚**ï¼šä¼˜åŒ–å™¨é€‰æ‹©ä¸åŒç´¢å¼•æ‰«æ
- **é”è·å–é¡ºåº**ï¼šä¸åŒç´¢å¼•å¯¼è‡´ä¸åŒçš„è¡Œé”è·å–é¡ºåº
- **é”ç²’åº¦å†²çª**ï¼šç´¢å¼•é”ã€è¡Œé”ã€é—´éš™é”å¤šé‡å†²çª

---

## 4. ğŸ” æ­»é”æ£€æµ‹ç®—æ³•åŸç†


### 4.1 ç­‰å¾…å›¾ç®—æ³•åŸºç¡€


**ğŸ”¸ ç­‰å¾…å›¾æ¦‚å¿µ**
ç­‰å¾…å›¾æ˜¯ä¸€ä¸ªæœ‰å‘å›¾ï¼Œç”¨æ¥è¡¨ç¤ºäº‹åŠ¡é—´çš„ç­‰å¾…å…³ç³»ã€‚

**å›¾çš„æ„æˆ**ï¼š
- **èŠ‚ç‚¹**ï¼šä»£è¡¨äº‹åŠ¡
- **è¾¹**ï¼šä»£è¡¨ç­‰å¾…å…³ç³»ï¼ˆA â†’ Bè¡¨ç¤ºäº‹åŠ¡Aç­‰å¾…äº‹åŠ¡Bï¼‰
- **ç¯è·¯**ï¼šè¡¨ç¤ºæ­»é”çš„å­˜åœ¨

**ç­‰å¾…å›¾ç¤ºä¾‹**ï¼š
```
ç®€å•æ­»é”æƒ…å†µï¼š
    äº‹åŠ¡A â†â”€â”€â”€â”€â”€â”€â”
      â”‚          â”‚
      â”‚          â”‚
      â†“          â”‚
    äº‹åŠ¡B â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤æ‚æ­»é”æƒ…å†µï¼š
    äº‹åŠ¡A â”€â”€â”€â”€â†’ äº‹åŠ¡B
      â†‘           â”‚
      â”‚           â†“
    äº‹åŠ¡D â†â”€â”€â”€â”€ äº‹åŠ¡C
```

### 4.2 æ­»é”æ£€æµ‹ç®—æ³•æµç¨‹


**ğŸ”§ æ£€æµ‹ç®—æ³•æ­¥éª¤**ï¼š

```
1. æ„å»ºç­‰å¾…å›¾
   â”œâ”€ æ‰«æé”è¡¨ï¼Œæ‰¾å‡ºç­‰å¾…å…³ç³»
   â”œâ”€ å°†äº‹åŠ¡ä½œä¸ºèŠ‚ç‚¹
   â””â”€ å°†ç­‰å¾…å…³ç³»ä½œä¸ºè¾¹

2. ç¯è·¯æ£€æµ‹
   â”œâ”€ ä½¿ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢(DFS)
   â”œâ”€ ä»æ¯ä¸ªèŠ‚ç‚¹å¼€å§‹éå†
   â””â”€ æ£€æŸ¥æ˜¯å¦å›åˆ°èµ·å§‹èŠ‚ç‚¹

3. æ­»é”å¤„ç†
   â”œâ”€ é€‰æ‹©ç‰ºç‰²äº‹åŠ¡ï¼ˆä»£ä»·æœ€å°çš„ï¼‰
   â”œâ”€ å›æ»šç‰ºç‰²äº‹åŠ¡
   â””â”€ é‡Šæ”¾è¯¥äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰é”

4. é‡æ–°æ£€æµ‹
   â”œâ”€ ç­‰å¾…å…¶ä»–äº‹åŠ¡é‡æ–°å°è¯•
   â””â”€ ç»§ç»­ç›‘æ§æ–°çš„æ­»é”
```

**æ£€æµ‹ç®—æ³•ä¼ªä»£ç **ï¼š
```python
def detect_deadlock():
    wait_graph = build_wait_graph()  # æ„å»ºç­‰å¾…å›¾
    
    for transaction in all_transactions:
        if has_cycle(wait_graph, transaction):  # æ£€æµ‹ç¯è·¯
            victim = choose_victim(cycle_transactions)  # é€‰æ‹©ç‰ºç‰²è€…
            rollback_transaction(victim)  # å›æ»šäº‹åŠ¡
            return True
    
    return False  # æ— æ­»é”

def has_cycle(graph, start_node):
    visited = set()
    path = []
    
    def dfs(node):
        if node in path:  # å‘ç°ç¯è·¯
            return True
        if node in visited:
            return False
            
        visited.add(node)
        path.append(node)
        
        for neighbor in graph[node]:
            if dfs(neighbor):
                return True
                
        path.pop()
        return False
    
    return dfs(start_node)
```

### 4.3 ç‰ºç‰²äº‹åŠ¡é€‰æ‹©ç­–ç•¥


**é€‰æ‹©æ ‡å‡†**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é€‰æ‹©å› ç´       â”‚   æƒé‡          â”‚   è¯´æ˜                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äº‹åŠ¡æŒæœ‰é”æ•°é‡   â”‚   é«˜            â”‚   é”å°‘çš„äº‹åŠ¡å›æ»šä»£ä»·å°            â”‚
â”‚ äº‹åŠ¡å·²æ‰§è¡Œæ—¶é—´   â”‚   ä¸­            â”‚   åˆšå¼€å§‹çš„äº‹åŠ¡å›æ»šæŸå¤±å°          â”‚
â”‚ äº‹åŠ¡ä¿®æ”¹è®°å½•æ•°   â”‚   é«˜            â”‚   ä¿®æ”¹å°‘çš„äº‹åŠ¡å›æ»šå¿«              â”‚
â”‚ äº‹åŠ¡ä¼˜å…ˆçº§      â”‚   ä¸­            â”‚   ä½ä¼˜å…ˆçº§äº‹åŠ¡ä¼˜å…ˆè¢«ç‰ºç‰²          â”‚
â”‚ äº‹åŠ¡å¤§å°        â”‚   é«˜            â”‚   å°äº‹åŠ¡å›æ»šä»£ä»·ä½               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**MySQLçš„é€‰æ‹©ç­–ç•¥**ï¼š
```sql
-- MySQLé€‰æ‹©ç‰ºç‰²äº‹åŠ¡çš„ä¾æ®
SELECT 
    trx_id,
    trx_weight,  -- äº‹åŠ¡æƒé‡ï¼ˆæŒé”æ•°é‡ + ä¿®æ”¹è¡Œæ•°ï¼‰
    trx_started,
    trx_isolation_level
FROM information_schema.innodb_trx 
ORDER BY trx_weight ASC;  -- æƒé‡å°çš„ä¼˜å…ˆè¢«ç‰ºç‰²
```

---

## 5. ğŸ”„ å¹¶å‘æ›´æ–°å†²çªå¤„ç†


### 5.1 å¹¶å‘æ›´æ–°å†²çªç±»å‹


**ğŸ”¸ å†²çªåˆ†ç±»**

**æ•°æ®å†²çª**ï¼š
```
ä¸¢å¤±æ›´æ–°é—®é¢˜ï¼š
æ—¶é—´  äº‹åŠ¡A              äº‹åŠ¡B
1    è¯»å– balance=100    
2                       è¯»å– balance=100
3    balance = 100-50   
4                       balance = 100-30
5    å†™å…¥ balance=50    
6                       å†™å…¥ balance=70  â† ä¸¢å¤±äº†Açš„æ›´æ–°
```

**é”å†²çª**ï¼š
- **é”ç­‰å¾…**ï¼šäº‹åŠ¡Bç­‰å¾…äº‹åŠ¡Aé‡Šæ”¾é”
- **é”è¶…æ—¶**ï¼šç­‰å¾…æ—¶é—´è¶…è¿‡`innodb_lock_wait_timeout`
- **æ­»é”**ï¼šå¾ªç¯ç­‰å¾…å¯¼è‡´çš„æ­»é”

### 5.2 éš”ç¦»çº§åˆ«ä¸å†²çªå¤„ç†


**ğŸ”§ ä¸åŒéš”ç¦»çº§åˆ«çš„å¤„ç†æ–¹å¼**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   éš”ç¦»çº§åˆ«      â”‚   è¯»å–è¡Œä¸º       â”‚   æ›´æ–°è¡Œä¸º       â”‚   æ­»é”æ¦‚ç‡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ READ UNCOMMITTEDâ”‚   æ— é”è¯»å–       â”‚   ç«‹å³è·å–å†™é”    â”‚   ä½            â”‚
â”‚ READ COMMITTED  â”‚   å¿«ç…§è¯»å–       â”‚   å½“å‰è¯»+å†™é”    â”‚   ä¸­ç­‰           â”‚
â”‚ REPEATABLE READ â”‚   å¿«ç…§è¯»å–       â”‚   å½“å‰è¯»+å†™é”    â”‚   é«˜            â”‚
â”‚ SERIALIZABLE    â”‚   åŠ é”è¯»å–       â”‚   åŠ é”+å†™é”      â”‚   æœ€é«˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éš”ç¦»çº§åˆ«å¯¹UPDATEçš„å½±å“**ï¼š
```sql
-- REPEATABLE READ (é»˜è®¤çº§åˆ«)
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- ä¼šå¯¹WHEREæ¡ä»¶æ¶‰åŠçš„è¡Œå’Œé—´éš™åŠ é”ï¼Œæ­»é”æ¦‚ç‡è¾ƒé«˜

-- READ COMMITTED  
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- åªå¯¹ä¿®æ”¹çš„è¡ŒåŠ é”ï¼Œå‡å°‘é”å†²çª
```

### 5.3 ä¹è§‚é”vsæ‚²è§‚é”ç­–ç•¥


**ğŸ”¥ æ‚²è§‚é”å®ç°**

```sql
-- æ‚²è§‚é”ï¼šå‡è®¾ä¸€å®šä¼šå‘ç”Ÿå†²çªï¼Œæå‰åŠ é”
BEGIN;

-- æ˜¾å¼åŠ é”
SELECT balance FROM accounts WHERE id = 1 FOR UPDATE;

-- åŸºäºé”å®šçš„å€¼è¿›è¡Œæ›´æ–°
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

COMMIT;
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
```
æ‚²è§‚é”ï¼š
âœ… æ•°æ®ä¸€è‡´æ€§å¼º
âœ… é¿å…ä¸¢å¤±æ›´æ–°
âŒ å¹¶å‘æ€§èƒ½å·®  
âŒ å®¹æ˜“äº§ç”Ÿæ­»é”

ä¹è§‚é”ï¼š
âœ… å¹¶å‘æ€§èƒ½å¥½
âœ… ä¸ä¼šäº§ç”Ÿæ­»é”
âŒ å¯èƒ½ä¸¢å¤±æ›´æ–°
âŒ éœ€è¦é‡è¯•æœºåˆ¶
```

**ğŸ”¥ ä¹è§‚é”å®ç°**

```sql
-- 1. æ·»åŠ ç‰ˆæœ¬å·å­—æ®µ
ALTER TABLE accounts ADD COLUMN version INT DEFAULT 1;

-- 2. ä¹è§‚é”æ›´æ–°é€»è¾‘
-- å…ˆè¯»å–å½“å‰å€¼å’Œç‰ˆæœ¬å·
SELECT id, balance, version FROM accounts WHERE id = 1;
-- å‡è®¾è¯»å–åˆ°: balance=1000, version=5

-- æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
UPDATE accounts 
SET balance = balance - 100, version = version + 1
WHERE id = 1 AND version = 5;

-- æ£€æŸ¥å½±å“è¡Œæ•°
-- å¦‚æœaffected_rows = 0ï¼Œè¯´æ˜ç‰ˆæœ¬å·å·²å˜ï¼Œéœ€è¦é‡è¯•
-- å¦‚æœaffected_rows = 1ï¼Œè¯´æ˜æ›´æ–°æˆåŠŸ
```

**ä¹è§‚é”åº”ç”¨å±‚å®ç°**ï¼š
```java
public class OptimisticUpdateService {
    private static final int MAX_RETRY = 3;
    
    public boolean updateBalance(Long accountId, BigDecimal amount) {
        for (int retry = 0; retry < MAX_RETRY; retry++) {
            // 1. è¯»å–å½“å‰æ•°æ®
            Account account = getAccountWithVersion(accountId);
            
            // 2. ä¸šåŠ¡é€»è¾‘å¤„ç†
            BigDecimal newBalance = account.getBalance().subtract(amount);
            
            // 3. ä¹è§‚é”æ›´æ–°
            int affected = updateAccountWithVersion(
                accountId, newBalance, account.getVersion()
            );
            
            if (affected > 0) {
                return true;  // æ›´æ–°æˆåŠŸ
            }
            
            // æ›´æ–°å¤±è´¥ï¼ŒçŸ­æš‚ç­‰å¾…åé‡è¯•
            Thread.sleep(10 + random.nextInt(20));
        }
        
        return false;  // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ›´æ–°å¤±è´¥
    }
}
```

---

## 6. ğŸ›¡ï¸ æ­»é”é¢„é˜²ç­–ç•¥


### 6.1 ç ´åæ­»é”æ¡ä»¶çš„ç­–ç•¥


**ğŸ”¸ ç ´åäº’æ–¥æ¡ä»¶**
```
ç­–ç•¥ï¼šå°½é‡ä½¿ç”¨å…±äº«é”æ›¿ä»£æ’ä»–é”
é€‚ç”¨åœºæ™¯ï¼šè¯»å¤šå†™å°‘çš„ä¸šåŠ¡åœºæ™¯

å®ç°æ–¹å¼ï¼š
- è¯»æ“ä½œä½¿ç”¨ SELECT ... LOCK IN SHARE MODE
- å»¶è¿Ÿå†™æ“ä½œï¼Œæ‰¹é‡å¤„ç†
- ä½¿ç”¨è¯»å†™åˆ†ç¦»æ¶æ„
```

**ğŸ”¸ ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶**
```
ç­–ç•¥ï¼šä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„é”
å®ç°ï¼šèµ„æºé¢„ç”³è¯·æ¨¡å¼

ç¤ºä¾‹ï¼š
-- ä¸å¥½çš„åšæ³•ï¼šåˆ†æ¬¡è·å–é”
UPDATE table1 SET ... WHERE id = 1;  -- è·å–é”1
UPDATE table2 SET ... WHERE id = 2;  -- è·å–é”2

-- æ”¹è¿›åšæ³•ï¼šæ‰¹é‡è·å–é”
SELECT * FROM table1 WHERE id = 1 FOR UPDATE;
SELECT * FROM table2 WHERE id = 2 FOR UPDATE;
-- ç„¶åæ‰¹é‡æ‰§è¡Œæ›´æ–°
```

**ğŸ”¸ ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶**
```
ç­–ç•¥ï¼šè§„å®šç»Ÿä¸€çš„é”è·å–é¡ºåº
å®ç°ï¼šæŒ‰ç…§å›ºå®šé¡ºåºè®¿é—®èµ„æº

é”é¡ºåºç­–ç•¥ï¼š
- æŒ‰ä¸»é”®å¤§å°é¡ºåºåŠ é”
- æŒ‰è¡¨åå­—æ¯é¡ºåºåŠ é”  
- æŒ‰ä¸šåŠ¡é€»è¾‘ä¼˜å…ˆçº§åŠ é”
```

### 6.2 ç»Ÿä¸€é”é¡ºåºç­–ç•¥


**ğŸ”§ ä¸»é”®é¡ºåºé”å®š**

```java
// è½¬è´¦ä¸šåŠ¡ï¼šé¿å…æ­»é”çš„å®ç°
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // ç¡®ä¿æŒ‰IDå¤§å°é¡ºåºè·å–é”ï¼Œé¿å…æ­»é”
    Long firstId = Math.min(fromId, toId);
    Long secondId = Math.max(fromId, toId);
    
    // æŒ‰é¡ºåºé”å®šè´¦æˆ·
    lockAccount(firstId);
    lockAccount(secondId);
    
    try {
        if (fromId.equals(firstId)) {
            // fromIdè¾ƒå°çš„æƒ…å†µ
            updateBalance(fromId, amount.negate());
            updateBalance(toId, amount);
        } else {
            // toIdè¾ƒå°çš„æƒ…å†µ  
            updateBalance(toId, amount);
            updateBalance(fromId, amount.negate());
        }
    } finally {
        unlockAccount(secondId);
        unlockAccount(firstId);
    }
}
```

**ğŸ”§ æ‰¹é‡æ“ä½œé”é¡ºåº**

```sql
-- æ‰¹é‡æ›´æ–°ï¼šæŒ‰ä¸»é”®æ’åºé¿å…æ­»é”
UPDATE accounts 
SET balance = CASE 
    WHEN id = 1 THEN balance - 100
    WHEN id = 2 THEN balance + 100
    WHEN id = 5 THEN balance - 50
END
WHERE id IN (1, 2, 5)
ORDER BY id;  -- å…³é”®ï¼šæŒ‰ä¸»é”®æ’åº
```

### 6.3 ä¸šåŠ¡å±‚æ­»é”é¢„é˜²


**ğŸ”¥ äº‹åŠ¡ç²’åº¦æ§åˆ¶**

```sql
-- ä¸å¥½çš„åšæ³•ï¼šäº‹åŠ¡è¿‡å¤§
BEGIN;
UPDATE table1 SET ... WHERE ...;     -- æŒé”æ—¶é—´é•¿
-- å¤§é‡ä¸šåŠ¡é€»è¾‘å¤„ç†
UPDATE table2 SET ... WHERE ...;     
-- æ›´å¤šä¸šåŠ¡é€»è¾‘
UPDATE table3 SET ... WHERE ...;
COMMIT;

-- æ”¹è¿›åšæ³•ï¼šæ‹†åˆ†äº‹åŠ¡
-- äº‹åŠ¡1ï¼šå¤„ç†table1
BEGIN;
UPDATE table1 SET ... WHERE ...;
COMMIT;

-- äº‹åŠ¡2ï¼šå¤„ç†table2  
BEGIN;
UPDATE table2 SET ... WHERE ...;
COMMIT;
```

**ğŸ”¥ èµ„æºè®¿é—®æ¨¡å¼ä¼˜åŒ–**

```java
// å‡å°‘é”ç«äº‰çš„ä¸šåŠ¡è®¾è®¡
public class OrderService {
    
    // ä¸å¥½çš„è®¾è®¡ï¼šé«˜å¹¶å‘æ—¶å®¹æ˜“æ­»é”
    public void badCreateOrder(Order order) {
        // 1. æ›´æ–°åº“å­˜ï¼ˆé”å®šå•†å“è¡¨ï¼‰
        updateInventory(order.getProductId(), -order.getQuantity());
        
        // 2. æ›´æ–°ç”¨æˆ·ç§¯åˆ†ï¼ˆé”å®šç”¨æˆ·è¡¨ï¼‰
        updateUserPoints(order.getUserId(), order.getPoints());
        
        // 3. åˆ›å»ºè®¢å•ï¼ˆé”å®šè®¢å•è¡¨ï¼‰
        insertOrder(order);
    }
    
    // æ”¹è¿›è®¾è®¡ï¼šå‡å°‘é”å†²çª
    public void goodCreateOrder(Order order) {
        // 1. å…ˆåˆ›å»ºè®¢å•ï¼ˆé¿å…é”å®šçƒ­ç‚¹æ•°æ®ï¼‰
        Long orderId = insertOrder(order);
        
        // 2. å¼‚æ­¥å¤„ç†åº“å­˜å’Œç§¯åˆ†
        asyncUpdateInventory(order.getProductId(), -order.getQuantity());
        asyncUpdateUserPoints(order.getUserId(), order.getPoints());
        
        // 3. æœ€ç»ˆä¸€è‡´æ€§ä¿è¯
        scheduleConsistencyCheck(orderId);
    }
}
```

---

## 7. ğŸ“Š æ­»é”æ—¥å¿—åˆ†ææŠ€æœ¯


### 7.1 MySQLæ­»é”æ—¥å¿—ç»“æ„


**ğŸ”¸ å¼€å¯æ­»é”æ—¥å¿—è®°å½•**

```sql
-- å¼€å¯æ­»é”ä¿¡æ¯è®°å½•
SET GLOBAL innodb_print_all_deadlocks = ON;

-- æŸ¥çœ‹æ­»é”æ£€æµ‹çŠ¶æ€
SHOW VARIABLES LIKE '%deadlock%';
SHOW VARIABLES LIKE '%lock_wait%';

-- æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS;
```

**ğŸ”¸ æ­»é”æ—¥å¿—è§£è¯»**

```
å…¸å‹æ­»é”æ—¥å¿—æ ¼å¼ï¼š

------------------------
LATEST DETECTED DEADLOCK
------------------------
2025-01-20 10:30:15 0x7f8b8c000700
*** (1) TRANSACTION:
TRANSACTION 421394291, ACTIVE 10 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 1234, OS thread handle 140239896327936, query id 5678
localhost root updating
UPDATE accounts SET balance = balance - 100 WHERE id = 2

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25 page no 3 n bits 72 index PRIMARY 
of table `testdb`.`accounts` trx id 421394291 lock_mode X 
locks rec but not gap waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; 1-byte offs 1;
 0: len 4; hex 80000002; asc     ;;  â† id = 2
 1: len 6; hex 000000000000; asc       ;;
 2: len 7; hex 00000000000000; asc       ;;
 3: len 8; hex 3ff0000000000000; asc ?       ;;

*** (2) TRANSACTION:
TRANSACTION 421394290, ACTIVE 15 sec starting index read
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1136, 3 row lock(s)
MySQL thread id 1235, OS thread handle 140239896327936, query id 5679
localhost root updating
UPDATE accounts SET balance = balance + 50 WHERE id = 1

*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 25 page no 3 n bits 72 index PRIMARY 
of table `testdb`.`accounts` trx id 421394290 lock_mode X 
locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; 1-byte offs 1;
 0: len 4; hex 80000002; asc     ;;  â† æŒæœ‰ id = 2 çš„é”

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25 page no 3 n bits 72 index PRIMARY 
of table `testdb`.`accounts` trx id 421394290 lock_mode X 
locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; 1-byte offs 1;
 0: len 4; hex 80000001; asc     ;;  â† ç­‰å¾… id = 1 çš„é”

*** WE ROLL BACK TRANSACTION (1)
```

### 7.2 æ­»é”æ—¥å¿—å…³é”®ä¿¡æ¯è§£æ


**ğŸ” å…³é”®ä¿¡æ¯æå–**

```
æ—¥å¿—åˆ†æè¦ç‚¹ï¼š

1. äº‹åŠ¡ä¿¡æ¯ï¼š
   - TRANSACTION ID: äº‹åŠ¡å”¯ä¸€æ ‡è¯†
   - ACTIVEæ—¶é—´: äº‹åŠ¡æŒç»­æ—¶é—´
   - çº¿ç¨‹ID: å¯¹åº”çš„æ•°æ®åº“è¿æ¥

2. é”ä¿¡æ¯ï¼š
   - HOLDS THE LOCK: å½“å‰æŒæœ‰çš„é”
   - WAITING FOR LOCK: ç­‰å¾…çš„é”
   - é”ç±»å‹: X(æ’ä»–é”), S(å…±äº«é”)

3. æ•°æ®ä¿¡æ¯ï¼š
   - space id: è¡¨ç©ºé—´ID
   - page no: æ•°æ®é¡µå·
   - å…·ä½“è®°å½•: æ¶‰åŠçš„æ•°æ®è¡Œ

4. å¤„ç†ç»“æœï¼š
   - ROLL BACK TRANSACTION: è¢«å›æ»šçš„äº‹åŠ¡
```

**ğŸ”§ æ—¥å¿—åˆ†æå·¥å…·**

```python
def parse_deadlock_log(log_content):
    """è§£æMySQLæ­»é”æ—¥å¿—"""
    deadlock_info = {
        'timestamp': '',
        'transactions': [],
        'victim_transaction': ''
    }
    
    lines = log_content.split('\n')
    current_transaction = None
    
    for line in lines:
        if 'LATEST DETECTED DEADLOCK' in line:
            # æå–æ—¶é—´æˆ³
            deadlock_info['timestamp'] = extract_timestamp(line)
            
        elif '*** (1) TRANSACTION:' in line:
            current_transaction = 1
            deadlock_info['transactions'].append({
                'id': 1,
                'details': {},
                'holds_locks': [],
                'waits_for': []
            })
            
        elif '*** (2) TRANSACTION:' in line:
            current_transaction = 2
            deadlock_info['transactions'].append({
                'id': 2, 
                'details': {},
                'holds_locks': [],
                'waits_for': []
            })
            
        elif 'WE ROLL BACK TRANSACTION' in line:
            victim = extract_victim_transaction(line)
            deadlock_info['victim_transaction'] = victim
    
    return deadlock_info

# ä½¿ç”¨ç¤ºä¾‹
log_data = parse_deadlock_log(deadlock_log_text)
print(f"æ­»é”æ—¶é—´: {log_data['timestamp']}")
print(f"æ¶‰åŠäº‹åŠ¡æ•°: {len(log_data['transactions'])}")
print(f"å›æ»šäº‹åŠ¡: {log_data['victim_transaction']}")
```

### 7.3 æ­»é”ç»Ÿè®¡åˆ†æ


**ğŸ”§ æ­»é”é¢‘ç‡ç»Ÿè®¡**

```sql
-- åˆ›å»ºæ­»é”ç»Ÿè®¡è¡¨
CREATE TABLE deadlock_stats (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    occurred_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    table_name VARCHAR(100),
    transaction_1_query TEXT,
    transaction_2_query TEXT,
    victim_transaction INT,
    resolution_time_ms INT
);

-- æ­»é”è¶‹åŠ¿åˆ†æ
SELECT 
    DATE(occurred_at) as date,
    COUNT(*) as deadlock_count,
    AVG(resolution_time_ms) as avg_resolution_time
FROM deadlock_stats 
WHERE occurred_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(occurred_at)
ORDER BY date;
```

**æ­»é”çƒ­ç‚¹åˆ†æ**ï¼š
```sql
-- æ­»é”çƒ­ç‚¹è¡¨åˆ†æ
SELECT 
    table_name,
    COUNT(*) as deadlock_count,
    COUNT(*) * 100.0 / SUM(COUNT(*)) OVER() as percentage
FROM deadlock_stats
WHERE occurred_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY table_name
ORDER BY deadlock_count DESC;

-- æ­»é”é«˜å³°æ—¶æ®µåˆ†æ
SELECT 
    HOUR(occurred_at) as hour,
    COUNT(*) as deadlock_count
FROM deadlock_stats
WHERE occurred_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)  
GROUP BY HOUR(occurred_at)
ORDER BY deadlock_count DESC;
```

---

## 8. ğŸ”§ åº”ç”¨å±‚æ­»é”é¿å…å®è·µ


### 8.1 é‡è¯•æœºåˆ¶è®¾è®¡


**ğŸ”¥ æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥**

```java
@Component
public class DeadlockRetryHandler {
    
    private static final int MAX_RETRY_ATTEMPTS = 3;
    private static final long INITIAL_RETRY_DELAY = 10; // ms
    
    @Retryable(
        value = {DeadlockLoserDataAccessException.class},
        maxAttempts = MAX_RETRY_ATTEMPTS,
        backoff = @Backoff(
            delay = INITIAL_RETRY_DELAY,
            multiplier = 2.0,
            random = true
        )
    )
    public void executeWithDeadlockRetry(Runnable operation) {
        try {
            operation.run();
        } catch (DeadlockLoserDataAccessException e) {
            log.warn("æ£€æµ‹åˆ°æ­»é”ï¼Œå‡†å¤‡é‡è¯•: {}", e.getMessage());
            throw e; // è§¦å‘é‡è¯•æœºåˆ¶
        }
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void transferMoney(Long fromId, Long toId, BigDecimal amount) {
        executeWithDeadlockRetry(() -> {
            doTransfer(fromId, toId, amount);
        });
    }
}
```

**ğŸ”§ è‡ªå®šä¹‰é‡è¯•é€»è¾‘**

```java
public class CustomDeadlockHandler {
    
    public <T> T executeWithRetry(Supplier<T> operation, int maxRetries) {
        int attempt = 0;
        Random random = new Random();
        
        while (attempt < maxRetries) {
            try {
                return operation.get();
                
            } catch (Exception e) {
                attempt++;
                
                if (isDeadlockException(e)) {
                    if (attempt >= maxRetries) {
                        throw new BusinessException("æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", e);
                    }
                    
                    // éšæœºå»¶è¿Ÿï¼Œé¿å…é‡è¯•é£æš´
                    long delay = (long) (Math.pow(2, attempt) * 50 + random.nextInt(100));
                    
                    try {
                        Thread.sleep(delay);
                    } catch (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        throw new RuntimeException("é‡è¯•è¢«ä¸­æ–­", ie);
                    }
                    
                    log.info("ç¬¬{}æ¬¡é‡è¯•ï¼Œå»¶è¿Ÿ{}ms", attempt, delay);
                    
                } else {
                    // éæ­»é”å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
                    throw e;
                }
            }
        }
        
        throw new BusinessException("è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ“ä½œå¤±è´¥");
    }
    
    private boolean isDeadlockException(Exception e) {
        return e instanceof DeadlockLoserDataAccessException ||
               (e.getMessage() != null && e.getMessage().contains("Deadlock"));
    }
}
```

### 8.2 äº‹åŠ¡è®¾è®¡æœ€ä½³å®è·µ


**ğŸ”¥ äº‹åŠ¡è¾¹ç•Œä¼˜åŒ–**

```java
@Service
public class OptimizedOrderService {
    
    // ä¸å¥½çš„åšæ³•ï¼šäº‹åŠ¡è¾¹ç•Œè¿‡å¤§
    @Transactional
    public void badProcessOrder(OrderRequest request) {
        // é•¿æ—¶é—´ä¸šåŠ¡é€»è¾‘å¤„ç†
        Order order = buildOrderFromRequest(request);
        validateOrderItems(order);  // å¯èƒ½éœ€è¦å¤–éƒ¨æœåŠ¡è°ƒç”¨
        
        // æ•°æ®åº“æ“ä½œä¸ä¸šåŠ¡é€»è¾‘æ··åˆ
        updateInventory(order.getItems());
        updateUserAccount(order.getUserId(), order.getAmount());
        insertOrder(order);
        
        // å‘é€é€šçŸ¥ï¼ˆå¯èƒ½å¤±è´¥å¯¼è‡´å›æ»šï¼‰
        sendOrderNotification(order);
    }
    
    // æ”¹è¿›åšæ³•ï¼šç²¾ç®€äº‹åŠ¡è¾¹ç•Œ
    public void goodProcessOrder(OrderRequest request) {
        // 1. é¢„å¤„ç†ï¼ˆæ— äº‹åŠ¡ï¼‰
        Order order = buildOrderFromRequest(request);
        validateOrderItems(order);
        
        // 2. æ ¸å¿ƒæ•°æ®åº“æ“ä½œï¼ˆæœ€å°äº‹åŠ¡ï¼‰
        Order savedOrder = processOrderTransaction(order);
        
        // 3. åç»­å¤„ç†ï¼ˆæ— äº‹åŠ¡ï¼‰
        asyncProcessAfterOrder(savedOrder);
    }
    
    @Transactional
    private Order processOrderTransaction(Order order) {
        // åªåŒ…å«æ ¸å¿ƒçš„æ•°æ®åº“æ“ä½œ
        updateInventory(order.getItems());
        updateUserAccount(order.getUserId(), order.getAmount());
        return insertOrder(order);
    }
    
    private void asyncProcessAfterOrder(Order order) {
        // å¼‚æ­¥å¤„ç†ï¼Œä¸å½±å“äº‹åŠ¡
        CompletableFuture.runAsync(() -> {
            sendOrderNotification(order);
            updateStatistics(order);
        });
    }
}
```

**ğŸ”§ è¯»å†™åˆ†ç¦»ç­–ç•¥**

```java
@Service
public class ReadWriteSeparationService {
    
    @Autowired
    private MasterDataSource masterDS;  // ä¸»åº“ï¼šå†™æ“ä½œ
    
    @Autowired  
    private SlaveDataSource slaveDS;    // ä»åº“ï¼šè¯»æ“ä½œ
    
    // å†™æ“ä½œï¼šä½¿ç”¨ä¸»åº“
    @Transactional("masterTransactionManager")
    public void updateUserBalance(Long userId, BigDecimal amount) {
        // å†™æ“ä½œå¿…é¡»åœ¨ä¸»åº“æ‰§è¡Œ
        masterDS.updateBalance(userId, amount);
    }
    
    // è¯»æ“ä½œï¼šä½¿ç”¨ä»åº“
    @Transactional(value = "slaveTransactionManager", readOnly = true)
    public User getUserInfo(Long userId) {
        // è¯»æ“ä½œåœ¨ä»åº“æ‰§è¡Œï¼Œå‡å°‘ä¸»åº“å‹åŠ›
        return slaveDS.findUserById(userId);
    }
    
    // å¤åˆæ“ä½œï¼šè¯»å†™åˆ†ç¦»
    public void transferWithReadSeparation(Long fromId, Long toId, BigDecimal amount) {
        // 1. ä»åº“è¯»å–è´¦æˆ·ä¿¡æ¯ï¼ˆéå¼ºä¸€è‡´æ€§è¦æ±‚ï¼‰
        User fromUser = getUserInfo(fromId);
        User toUser = getUserInfo(toId);
        
        // 2. ä¸šåŠ¡é€»è¾‘éªŒè¯
        validateTransfer(fromUser, toUser, amount);
        
        // 3. ä¸»åº“æ‰§è¡Œå†™æ“ä½œ
        executeTransfer(fromId, toId, amount);
    }
}
```

### 8.3 åˆ†å¸ƒå¼é”æ›¿ä»£æ–¹æ¡ˆ


**ğŸ”¥ Redisåˆ†å¸ƒå¼é”**

```java
@Component
public class RedisDistributedLock {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    public boolean tryLock(String key, String value, long expireTime) {
        String script = 
            "if redis.call('set', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) then " +
            "return 1 else return 0 end";
        
        Long result = redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Arrays.asList(key),
            value,
            String.valueOf(expireTime)
        );
        
        return result != null && result == 1L;
    }
    
    public void releaseLock(String key, String value) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('del', KEYS[1]) else return 0 end";
        
        redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Arrays.asList(key),
            value
        );
    }
}

// ä½¿ç”¨åˆ†å¸ƒå¼é”é¿å…æ•°æ®åº“æ­»é”
@Service
public class TransferService {
    
    @Autowired
    private RedisDistributedLock distributedLock;
    
    public void safeTransfer(Long fromId, Long toId, BigDecimal amount) {
        // ç”Ÿæˆæœ‰åºçš„é”keyï¼Œé¿å…æ­»é”
        String lockKey = generateOrderedLockKey(fromId, toId);
        String lockValue = UUID.randomUUID().toString();
        
        if (distributedLock.tryLock(lockKey, lockValue, 30000)) {
            try {
                // åœ¨åˆ†å¸ƒå¼é”ä¿æŠ¤ä¸‹æ‰§è¡Œè½¬è´¦
                executeTransfer(fromId, toId, amount);
                
            } finally {
                distributedLock.releaseLock(lockKey, lockValue);
            }
        } else {
            throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    private String generateOrderedLockKey(Long id1, Long id2) {
        // ç¡®ä¿é”keyçš„æœ‰åºæ€§ï¼Œé¿å…åˆ†å¸ƒå¼æ­»é”
        Long first = Math.min(id1, id2);
        Long second = Math.max(id1, id2);
        return "transfer_lock:" + first + "_" + second;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ­»é”æœ¬è´¨ï¼šå¤šä¸ªäº‹åŠ¡å¾ªç¯ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºçš„çŠ¶æ€
ğŸ”¸ äº§ç”Ÿæ¡ä»¶ï¼šäº’æ–¥ã€è¯·æ±‚ä¿æŒã€ä¸å¯æŠ¢å ã€å¾ªç¯ç­‰å¾…å››ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³
ğŸ”¸ æ£€æµ‹æœºåˆ¶ï¼šç­‰å¾…å›¾ç®—æ³•ï¼Œå‘ç°ç¯è·¯å³ä¸ºæ­»é”
ğŸ”¸ å…¸å‹åœºæ™¯ï¼šäº¤å‰æ›´æ–°ã€èŒƒå›´é”å†²çªã€å¤–é”®çº¦æŸã€ç´¢å¼•é”å†²çª
ğŸ”¸ å¤„ç†ç­–ç•¥ï¼šæ£€æµ‹åå›æ»šä»£ä»·æœ€å°çš„äº‹åŠ¡
ğŸ”¸ é¢„é˜²åŸåˆ™ï¼šç»Ÿä¸€é”é¡ºåºã€å‡å°‘é”ç²’åº¦ã€ç¼©çŸ­äº‹åŠ¡æ—¶é—´
ğŸ”¸ åº”ç”¨å±‚é¿å…ï¼šé‡è¯•æœºåˆ¶ã€äº‹åŠ¡ä¼˜åŒ–ã€åˆ†å¸ƒå¼é”æ›¿ä»£
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ­»é”é¢„é˜²vsæ£€æµ‹**
```
é¢„é˜²ç­–ç•¥ï¼š
- ç ´åæ­»é”äº§ç”Ÿæ¡ä»¶
- ç»Ÿä¸€èµ„æºè®¿é—®é¡ºåº  
- å‡å°‘é”æŒæœ‰æ—¶é—´
- ä¼˜ç‚¹ï¼šé¿å…æ­»é”å‘ç”Ÿ
- ç¼ºç‚¹ï¼šå¯èƒ½å½±å“å¹¶å‘æ€§èƒ½

æ£€æµ‹å¤„ç†ï¼š
- å…è®¸æ­»é”å‘ç”Ÿ
- æ£€æµ‹åˆ°åå¿«é€Ÿå¤„ç†
- å›æ»šç‰ºç‰²äº‹åŠ¡
- ä¼˜ç‚¹ï¼šå¹¶å‘æ€§èƒ½å¥½
- ç¼ºç‚¹ï¼šæœ‰äº‹åŠ¡å›æ»šå¼€é”€
```

**ğŸ”¹ ä¸åŒåœºæ™¯çš„åº”å¯¹ç­–ç•¥**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
- ä¼˜å…ˆä½¿ç”¨ä¹è§‚é”
- å®æ–½è¯»å†™åˆ†ç¦»
- é‡‡ç”¨åˆ†å¸ƒå¼é”

æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ï¼š
- ä½¿ç”¨æ‚²è§‚é”
- ä¸¥æ ¼çš„äº‹åŠ¡è¾¹ç•Œ
- å®Œå–„çš„é‡è¯•æœºåˆ¶

æ··åˆåœºæ™¯ï¼š
- åˆ†å±‚é”ç­–ç•¥
- ä¸šåŠ¡åœºæ™¯åŒºåˆ†
- æ€§èƒ½ç›‘æ§æŒ‡å¯¼
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼ä½“ç°**
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šå‡å°‘å› æ­»é”å¯¼è‡´çš„ä¸šåŠ¡ä¸­æ–­
- **ç”¨æˆ·ä½“éªŒ**ï¼šé™ä½æ“ä½œå¤±è´¥ç‡ï¼Œæé«˜å“åº”é€Ÿåº¦  
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯å¹¶å‘ç¯å¢ƒä¸‹çš„æ•°æ®å‡†ç¡®æ€§
- **ç³»ç»Ÿæ€§èƒ½**ï¼šä¼˜åŒ–é”ç­–ç•¥ï¼Œæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›

**ğŸ”§ æŠ€æœ¯ä»·å€¼ä½“ç°**
- **æ¶æ„è®¾è®¡**ï¼šæŒ‡å¯¼æ•°æ®åº“æ¶æ„å’Œäº‹åŠ¡è®¾è®¡
- **æ€§èƒ½è°ƒä¼˜**ï¼šæä¾›æ­»é”åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½å’Œè§£å†³æ­»é”é—®é¢˜
- **ä»£ç è´¨é‡**ï¼šç¼–å†™æ›´å¥å£®çš„å¹¶å‘ä»£ç 

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ­»é”å››æ¡ä»¶ç¼ºä¸€ä¸å¯ï¼Œé¢„é˜²å°±æ˜¯ç ´åæ¡ä»¶
- ç»Ÿä¸€é”é¡ºåºæ˜¯æœ€æœ‰æ•ˆçš„é¢„é˜²ç­–ç•¥
- äº‹åŠ¡è¦çŸ­å°ç²¾æ‚ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´
- æ—¥å¿—åˆ†ææ˜¯å®šä½é—®é¢˜çš„å…³é”®å·¥å…·
- åº”ç”¨å±‚é‡è¯•å’Œåˆ†å¸ƒå¼é”æ˜¯é‡è¦è¡¥å……æ‰‹æ®µ