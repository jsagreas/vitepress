---
title: 10ã€å¤§è¡¨UPDATEåˆ†æ‰¹å¤„ç†æŠ€æœ¯
---
## ğŸ“š ç›®å½•

1. [å¤§è¡¨æ›´æ–°é—®é¢˜æ¦‚è¿°](#1-å¤§è¡¨æ›´æ–°é—®é¢˜æ¦‚è¿°)
2. [åˆ†æ‰¹å¤„ç†æ ¸å¿ƒåŸç†](#2-åˆ†æ‰¹å¤„ç†æ ¸å¿ƒåŸç†)
3. [æ‰¹æ¬¡å¤§å°æ§åˆ¶ç­–ç•¥](#3-æ‰¹æ¬¡å¤§å°æ§åˆ¶ç­–ç•¥)
4. [åˆ†æ‰¹å¤„ç†å®ç°æ–¹æ¡ˆ](#4-åˆ†æ‰¹å¤„ç†å®ç°æ–¹æ¡ˆ)
5. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#5-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
6. [ç›‘æ§ä¸æ•…éšœå¤„ç†](#6-ç›‘æ§ä¸æ•…éšœå¤„ç†)
7. [æœ€ä½³å®è·µæŒ‡å—](#7-æœ€ä½³å®è·µæŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ å¤§è¡¨æ›´æ–°é—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¤§è¡¨æ›´æ–°é—®é¢˜


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ è¦ç»™ä¸€ä¸‡ä¸ªå­¦ç”Ÿæ”¹æˆç»©ï¼Œå¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨æ”¹å®Œï¼Œä¼šæŠŠè€å¸ˆç´¯æ­»ï¼Œè¿˜å¯èƒ½å‡ºé”™ã€‚æœ€å¥½çš„åŠæ³•æ˜¯åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ¬¡æ”¹100ä¸ªå­¦ç”Ÿçš„æˆç»©ã€‚

```sql
-- é—®é¢˜åœºæ™¯ï¼šç»™åƒä¸‡çº§ç”¨æˆ·è¡¨æ›´æ–°çŠ¶æ€
UPDATE users SET status = 'active' 
WHERE last_login > '2024-01-01';  -- å¯èƒ½å½±å“500ä¸‡æ¡è®°å½•
```

### 1.2 å¤§è¡¨æ›´æ–°çš„å¸¸è§é—®é¢˜


**ğŸ”¸ å¤§è¡¨æ›´æ–°é¢ä¸´çš„æ ¸å¿ƒé—®é¢˜**ï¼š

```
æ€§èƒ½é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•æ¬¡æ›´æ–°500ä¸‡æ¡è®°å½•             â”‚
â”‚ â†“                              â”‚ 
â”‚ é•¿æ—¶é—´å ç”¨æ•°æ®åº“èµ„æº           â”‚
â”‚ â†“                              â”‚
â”‚ å…¶ä»–ä¸šåŠ¡æŸ¥è¯¢è¢«é˜»å¡             â”‚
â”‚ â†“                              â”‚
â”‚ ç”¨æˆ·ä½“éªŒä¸¥é‡ä¸‹é™               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŠ€æœ¯é—®é¢˜ï¼š
â€¢ é”ç­‰å¾…è¶…æ—¶
â€¢ äº‹åŠ¡æ—¥å¿—æš´å¢  
â€¢ å†…å­˜ä¸è¶³
â€¢ ä¸»ä»å»¶è¿Ÿ
```

**å®é™…å½±å“ç¤ºä¾‹**ï¼š
- **å“åº”æ—¶é—´**ï¼šåŸæœ¬1ç§’çš„æŸ¥è¯¢å˜æˆ30ç§’
- **ç³»ç»Ÿè´Ÿè½½**ï¼šCPUä½¿ç”¨ç‡ä»30%é£™å‡åˆ°95%
- **ç”¨æˆ·æŠ•è¯‰**ï¼šç½‘ç«™å¡é¡¿ï¼Œæ— æ³•æ­£å¸¸ä½¿ç”¨
- **ä¸šåŠ¡é£é™©**ï¼šè®¢å•å¤„ç†å»¶è¿Ÿï¼Œé€ æˆç»æµæŸå¤±

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦åˆ†æ‰¹å¤„ç†


**æ ¸å¿ƒåŸå› åˆ†æ**ï¼š

```
ä¸€æ¬¡æ€§æ›´æ–° vs åˆ†æ‰¹æ›´æ–°ï¼š

ä¸€æ¬¡æ€§æ›´æ–°ï¼š
ç”¨æˆ·è¡¨(1000ä¸‡æ¡) â†’ ä¸€æ¬¡UPDATE â†’ ç³»ç»Ÿå´©æºƒ âŒ

åˆ†æ‰¹æ›´æ–°ï¼š  
ç”¨æˆ·è¡¨(1000ä¸‡æ¡) â†’ åˆ†1000æ‰¹ â†’ æ¯æ‰¹1ä¸‡æ¡ â†’ ç³»ç»Ÿç¨³å®š âœ…
```

**ğŸ”¸ åˆ†æ‰¹å¤„ç†çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **èµ„æºæ§åˆ¶** - æ¯æ¬¡åªä½¿ç”¨å°‘é‡ç³»ç»Ÿèµ„æº
- **é”æ—¶é—´çŸ­** - å‡å°‘è¡¨é”å®šæ—¶é—´ï¼Œå…¶ä»–æ“ä½œèƒ½æ­£å¸¸è¿›è¡Œ
- **å¯æ¢å¤æ€§** - æŸæ‰¹å¤±è´¥ä¸å½±å“å…¶ä»–æ‰¹æ¬¡
- **å¯ç›‘æ§** - èƒ½å®æ—¶çœ‹åˆ°æ›´æ–°è¿›åº¦

---

## 2. âš™ï¸ åˆ†æ‰¹å¤„ç†æ ¸å¿ƒåŸç†


### 2.1 åˆ†æ‰¹å¤„ç†åŸºæœ¬æ€è·¯


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œé€ä¸ªå®Œæˆã€‚

```
åŸå§‹æ€è·¯ï¼š
UPDATE large_table SET column = value WHERE condition;
                â†“
            å¤„ç†100ä¸‡æ¡è®°å½•
                â†“
            ç³»ç»Ÿå‹åŠ›å·¨å¤§

åˆ†æ‰¹æ€è·¯ï¼š
FOR i = 1 TO 1000:
    UPDATE large_table SET column = value 
    WHERE condition AND id BETWEEN start_id AND end_id
    LIMIT 1000;
                â†“
            æ¯æ¬¡å¤„ç†1000æ¡
                â†“
            ç³»ç»Ÿå‹åŠ›å¯æ§
```

### 2.2 åˆ†æ‰¹å¤„ç†çš„åŸºæœ¬æµç¨‹


```
â‘  ç¡®å®šæ›´æ–°èŒƒå›´å’Œæ€»æ•°é‡
        â†“
â‘¡ è®¡ç®—åˆé€‚çš„æ‰¹æ¬¡å¤§å°
        â†“  
â‘¢ æŒ‰ä¸»é”®IDåˆ†æ®µå¤„ç†
        â†“
â‘£ é€æ‰¹æ‰§è¡ŒUPDATEæ“ä½œ
        â†“
â‘¤ ç›‘æ§è¿›åº¦å’Œæ€§èƒ½æŒ‡æ ‡
        â†“
â‘¥ å¤„ç†å¼‚å¸¸å’Œå¤±è´¥é‡è¯•
        â†“
â‘¦ å®Œæˆå…¨éƒ¨æ›´æ–°ä»»åŠ¡
```

### 2.3 æŠ€æœ¯å®ç°å…³é”®ç‚¹


**ğŸ”¸ ä¸»é”®èŒƒå›´åˆ†å‰²æ³•**ï¼š
```sql
-- ç¬¬1æ‰¹ï¼šå¤„ç†ID 1-1000
UPDATE users SET status = 'active' 
WHERE id BETWEEN 1 AND 1000 
  AND last_login > '2024-01-01';

-- ç¬¬2æ‰¹ï¼šå¤„ç†ID 1001-2000  
UPDATE users SET status = 'active'
WHERE id BETWEEN 1001 AND 2000
  AND last_login > '2024-01-01';

-- ä¾æ­¤ç±»æ¨...
```

**åˆ†é¡µåç§»æ³•**ï¼š
```sql
-- ä½¿ç”¨LIMITå’ŒOFFSETæ§åˆ¶æ‰¹æ¬¡
UPDATE users SET status = 'active'
WHERE last_login > '2024-01-01'
LIMIT 1000;  -- æ¯æ¬¡åªæ›´æ–°1000æ¡

-- æ³¨æ„ï¼šè¿™ç§æ–¹æ³•åœ¨å¤§è¡¨ä¸Šæ•ˆç‡è¾ƒä½
```

---

## 3. ğŸ“Š æ‰¹æ¬¡å¤§å°æ§åˆ¶ç­–ç•¥


### 3.1 ğŸ”¸ æ‰¹æ¬¡å¤§å°é€‰æ‹©åŸåˆ™


**é€šä¿—ç†è§£**ï¼šæ‰¹æ¬¡å¤§å°å°±åƒæ¯æ¬¡æ¬å®¶æ¬å¤šå°‘ç®±å­ï¼Œæ¬å¤ªå°‘æ•ˆç‡ä½ï¼Œæ¬å¤ªå¤šç´¯æ­»äººã€‚

**å½±å“å› ç´ åˆ†æ**ï¼š

| å› ç´  | å°æ‰¹æ¬¡(100-1000) | ä¸­æ‰¹æ¬¡(1000-10000) | å¤§æ‰¹æ¬¡(10000+) |
|------|----------------|------------------|---------------|
| **æ‰§è¡Œæ—¶é—´** | å¾ˆçŸ­(< 1ç§’) | é€‚ä¸­(1-10ç§’) | è¾ƒé•¿(> 10ç§’) |
| **ç³»ç»Ÿå½±å“** | å¾ˆå° | ä¸­ç­‰ | è¾ƒå¤§ |
| **æ€»ä½“è€—æ—¶** | è¾ƒé•¿ | é€‚ä¸­ | è¾ƒçŸ­ |
| **æ•…éšœæ¢å¤** | å®¹æ˜“ | ä¸­ç­‰ | å›°éš¾ |
| **å¹¶å‘å½±å“** | å¾ˆå° | å° | æ˜æ˜¾ |

### 3.2 ğŸ”¸ æ‰¹æ¬¡å¤§å°è®¡ç®—æ–¹æ³•


**åŸºäºæ€§èƒ½æµ‹è¯•çš„åŠ¨æ€è°ƒæ•´**ï¼š
```sql
-- æµ‹è¯•ä¸åŒæ‰¹æ¬¡å¤§å°çš„æ€§èƒ½
-- æ‰¹æ¬¡100ï¼šå¹³å‡è€—æ—¶0.1ç§’
-- æ‰¹æ¬¡1000ï¼šå¹³å‡è€—æ—¶0.8ç§’  
-- æ‰¹æ¬¡5000ï¼šå¹³å‡è€—æ—¶3.2ç§’
-- æ‰¹æ¬¡10000ï¼šå¹³å‡è€—æ—¶8.5ç§’

-- é€‰æ‹©åŸåˆ™ï¼šå•æ‰¹æ¬¡æ‰§è¡Œæ—¶é—´æ§åˆ¶åœ¨1-5ç§’å†…
```

**ğŸ”¸ åŠ¨æ€æ‰¹æ¬¡å¤§å°è°ƒæ•´ç®—æ³•**ï¼š
```python
def calculate_batch_size(table_size, system_load, time_limit):
    """
    æ ¹æ®ç³»ç»Ÿæƒ…å†µåŠ¨æ€è®¡ç®—æ‰¹æ¬¡å¤§å°
    """
    base_size = 1000  # åŸºç¡€æ‰¹æ¬¡å¤§å°
    
    # æ ¹æ®è¡¨å¤§å°è°ƒæ•´
    if table_size > 10000000:  # åƒä¸‡çº§
        size_factor = 0.8
    elif table_size > 1000000:  # ç™¾ä¸‡çº§  
        size_factor = 1.0
    else:  # åä¸‡çº§ä»¥ä¸‹
        size_factor = 1.5
    
    # æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´
    if system_load > 80:  # é«˜è´Ÿè½½
        load_factor = 0.5
    elif system_load > 60:  # ä¸­è´Ÿè½½
        load_factor = 0.8  
    else:  # ä½è´Ÿè½½
        load_factor = 1.2
        
    # è®¡ç®—æœ€ç»ˆæ‰¹æ¬¡å¤§å°
    batch_size = int(base_size * size_factor * load_factor)
    
    # ç¡®ä¿åœ¨åˆç†èŒƒå›´å†…
    return min(max(batch_size, 100), 10000)
```

### 3.3 æ‰¹æ¬¡å¤§å°çš„å®æ—¶è°ƒæ•´


**è‡ªé€‚åº”è°ƒæ•´ç­–ç•¥**ï¼š
```
æ‰§è¡Œæ—¶é—´ç›‘æ§ï¼š
â€¢ å¦‚æœå•æ‰¹æ¬¡ < 1ç§’ â†’ å¢å¤§æ‰¹æ¬¡ï¼ˆæé«˜æ•ˆç‡ï¼‰
â€¢ å¦‚æœå•æ‰¹æ¬¡ > 5ç§’ â†’ å‡å°æ‰¹æ¬¡ï¼ˆé™ä½å½±å“ï¼‰  
â€¢ å¦‚æœå•æ‰¹æ¬¡ 1-5ç§’ â†’ ä¿æŒå½“å‰å¤§å°

ç³»ç»Ÿè´Ÿè½½ç›‘æ§ï¼š
â€¢ CPU > 90% â†’ æš‚åœæ‰§è¡Œï¼Œç­‰å¾…è´Ÿè½½ä¸‹é™
â€¢ CPU 70-90% â†’ å‡å°æ‰¹æ¬¡å¤§å°
â€¢ CPU < 70% â†’ å¯é€‚å½“å¢å¤§æ‰¹æ¬¡
```

---

## 4. ğŸ”§ åˆ†æ‰¹å¤„ç†å®ç°æ–¹æ¡ˆ


### 4.1 åŸºç¡€åˆ†æ‰¹UPDATEå®ç°


**Pythonå®ç°ç¤ºä¾‹**ï¼š
```python
import mysql.connector
import time
import logging

class BatchUpdateProcessor:
    def __init__(self, connection_config):
        self.conn = mysql.connector.connect(**connection_config)
        self.cursor = self.conn.cursor()
        
    def batch_update_by_id_range(self, table_name, set_clause, 
                                where_clause, batch_size=1000):
        """
        åŸºäºIDèŒƒå›´çš„åˆ†æ‰¹æ›´æ–°
        """
        # è·å–IDèŒƒå›´
        min_id, max_id = self._get_id_range(table_name, where_clause)
        
        current_id = min_id
        total_updated = 0
        
        while current_id <= max_id:
            end_id = min(current_id + batch_size - 1, max_id)
            
            # æ„å»ºSQL
            sql = f"""
                UPDATE {table_name} 
                SET {set_clause}
                WHERE {where_clause} 
                AND id BETWEEN {current_id} AND {end_id}
            """
            
            # æ‰§è¡Œæ›´æ–°
            start_time = time.time()
            self.cursor.execute(sql)
            affected_rows = self.cursor.rowcount
            self.conn.commit()
            
            execution_time = time.time() - start_time
            total_updated += affected_rows
            
            # è®°å½•è¿›åº¦
            progress = (current_id - min_id) / (max_id - min_id) * 100
            logging.info(f"æ‰¹æ¬¡å®Œæˆ: ID {current_id}-{end_id}, "
                        f"å½±å“è¡Œæ•°: {affected_rows}, "
                        f"è€—æ—¶: {execution_time:.2f}s, "
                        f"è¿›åº¦: {progress:.1f}%")
            
            # ç§»åŠ¨åˆ°ä¸‹ä¸€æ‰¹
            current_id = end_id + 1
            
            # çŸ­æš‚æš‚åœï¼Œå‡è½»ç³»ç»Ÿå‹åŠ›
            time.sleep(0.1)
            
        return total_updated

    def _get_id_range(self, table_name, where_clause):
        """è·å–éœ€è¦æ›´æ–°çš„IDèŒƒå›´"""
        sql = f"""
            SELECT MIN(id), MAX(id) 
            FROM {table_name} 
            WHERE {where_clause}
        """
        self.cursor.execute(sql)
        return self.cursor.fetchone()
```

### 4.2 ğŸ”¸ å¤§æ‰¹é‡æ›´æ–°åˆ†é¡µå¤„ç†


**é«˜çº§åˆ†é¡µå¤„ç†å®ç°**ï¼š
```python
class AdvancedBatchProcessor:
    def __init__(self, connection_config):
        self.conn = mysql.connector.connect(**connection_config)
        self.cursor = self.conn.cursor()
        self.batch_size = 1000
        self.max_execution_time = 5.0  # æœ€å¤§å•æ‰¹æ¬¡æ‰§è¡Œæ—¶é—´
        
    def adaptive_batch_update(self, table_name, set_clause, where_clause):
        """
        è‡ªé€‚åº”æ‰¹æ¬¡å¤§å°çš„åˆ†é¡µæ›´æ–°
        """
        processed_ids = set()
        total_updated = 0
        
        while True:
            # è·å–ä¸‹ä¸€æ‰¹éœ€è¦æ›´æ–°çš„è®°å½•ID
            batch_ids = self._get_next_batch_ids(
                table_name, where_clause, processed_ids
            )
            
            if not batch_ids:
                break  # æ²¡æœ‰æ›´å¤šè®°å½•éœ€è¦æ›´æ–°
                
            # æ‰§è¡Œæ‰¹æ¬¡æ›´æ–°
            start_time = time.time()
            sql = f"""
                UPDATE {table_name} 
                SET {set_clause}
                WHERE id IN ({','.join(map(str, batch_ids))})
                AND {where_clause}
            """
            
            self.cursor.execute(sql)
            affected_rows = self.cursor.rowcount
            self.conn.commit()
            
            execution_time = time.time() - start_time
            total_updated += affected_rows
            
            # è®°å½•å·²å¤„ç†çš„ID
            processed_ids.update(batch_ids)
            
            # æ ¹æ®æ‰§è¡Œæ—¶é—´è°ƒæ•´æ‰¹æ¬¡å¤§å°
            self._adjust_batch_size(execution_time)
            
            # è®°å½•è¿›åº¦
            logging.info(f"æ‰¹æ¬¡å®Œæˆ: {len(batch_ids)}æ¡è®°å½•, "
                        f"å½±å“è¡Œæ•°: {affected_rows}, "
                        f"è€—æ—¶: {execution_time:.2f}s, "
                        f"æ–°æ‰¹æ¬¡å¤§å°: {self.batch_size}")
            
            # ç³»ç»Ÿè´Ÿè½½æ£€æŸ¥
            if self._check_system_load():
                time.sleep(1)  # é«˜è´Ÿè½½æ—¶æš‚åœ
                
        return total_updated
        
    def _get_next_batch_ids(self, table_name, where_clause, processed_ids):
        """è·å–ä¸‹ä¸€æ‰¹éœ€è¦å¤„ç†çš„ID"""
        exclude_condition = ""
        if processed_ids:
            exclude_ids = ','.join(map(str, processed_ids))
            exclude_condition = f"AND id NOT IN ({exclude_ids})"
            
        sql = f"""
            SELECT id FROM {table_name}
            WHERE {where_clause} {exclude_condition}
            ORDER BY id
            LIMIT {self.batch_size}
        """
        
        self.cursor.execute(sql)
        return [row[0] for row in self.cursor.fetchall()]
        
    def _adjust_batch_size(self, execution_time):
        """æ ¹æ®æ‰§è¡Œæ—¶é—´è°ƒæ•´æ‰¹æ¬¡å¤§å°"""
        if execution_time < 1.0:
            # æ‰§è¡Œå¤ªå¿«ï¼Œå¢åŠ æ‰¹æ¬¡å¤§å°
            self.batch_size = min(self.batch_size * 1.5, 10000)
        elif execution_time > self.max_execution_time:
            # æ‰§è¡Œå¤ªæ…¢ï¼Œå‡å°‘æ‰¹æ¬¡å¤§å°
            self.batch_size = max(self.batch_size * 0.7, 100)
```

### 4.3 å­˜å‚¨è¿‡ç¨‹å®ç°æ–¹æ¡ˆ


**MySQLå­˜å‚¨è¿‡ç¨‹å®ç°**ï¼š
```sql
DELIMITER $$

CREATE PROCEDURE BatchUpdateUsers(
    IN p_batch_size INT DEFAULT 1000,
    IN p_max_batches INT DEFAULT 1000,
    OUT p_total_updated INT
)
BEGIN
    DECLARE v_min_id INT DEFAULT 0;
    DECLARE v_max_id INT;
    DECLARE v_current_id INT;
    DECLARE v_end_id INT;
    DECLARE v_batch_count INT DEFAULT 0;
    DECLARE v_affected_rows INT;
    DECLARE v_total_updated INT DEFAULT 0;
    
    -- å£°æ˜å¼‚å¸¸å¤„ç†
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        GET DIAGNOSTICS CONDITION 1
            @error_code = MYSQL_ERRNO,
            @error_message = MESSAGE_TEXT;
        SELECT CONCAT('Error: ', @error_code, ' - ', @error_message) as error_info;
    END;
    
    -- è·å–IDèŒƒå›´
    SELECT COALESCE(MIN(id), 0), COALESCE(MAX(id), 0)
    INTO v_min_id, v_max_id
    FROM users 
    WHERE last_login < '2024-01-01' AND status = 'inactive';
    
    -- å¦‚æœæ²¡æœ‰æ•°æ®éœ€è¦æ›´æ–°
    IF v_max_id = 0 THEN
        SET p_total_updated = 0;
        SELECT 'No records to update' as message;
        LEAVE;
    END IF;
    
    SET v_current_id = v_min_id;
    
    -- åˆ†æ‰¹å¤„ç†
    batch_loop: WHILE v_current_id <= v_max_id AND v_batch_count < p_max_batches DO
        SET v_end_id = LEAST(v_current_id + p_batch_size - 1, v_max_id);
        
        -- å¼€å§‹äº‹åŠ¡
        START TRANSACTION;
        
        -- æ‰§è¡Œæ›´æ–°
        UPDATE users 
        SET status = 'active', updated_at = NOW()
        WHERE id BETWEEN v_current_id AND v_end_id
          AND last_login < '2024-01-01' 
          AND status = 'inactive';
          
        -- è·å–å½±å“è¡Œæ•°
        SET v_affected_rows = ROW_COUNT();
        SET v_total_updated = v_total_updated + v_affected_rows;
        
        -- æäº¤äº‹åŠ¡
        COMMIT;
        
        -- è®°å½•è¿›åº¦ï¼ˆæ’å…¥åˆ°æ—¥å¿—è¡¨ï¼‰
        INSERT INTO batch_update_log 
        (batch_no, start_id, end_id, affected_rows, created_at)
        VALUES 
        (v_batch_count + 1, v_current_id, v_end_id, v_affected_rows, NOW());
        
        SET v_batch_count = v_batch_count + 1;
        SET v_current_id = v_end_id + 1;
        
        -- çŸ­æš‚æš‚åœ
        DO SLEEP(0.1);
        
    END WHILE batch_loop;
    
    SET p_total_updated = v_total_updated;
    
    SELECT CONCAT('Batch update completed. Total updated: ', v_total_updated, 
                  ', Batches processed: ', v_batch_count) as summary;
END$$

DELIMITER ;
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 5.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ä¸ºåˆ†æ‰¹æ¡ä»¶åˆ›å»ºåˆé€‚ç´¢å¼•**ï¼š
```sql
-- åŸå§‹æŸ¥è¯¢
UPDATE users SET status = 'active' 
WHERE last_login > '2024-01-01' AND status = 'inactive';

-- éœ€è¦çš„ç´¢å¼•
CREATE INDEX idx_users_batch_update 
ON users (status, last_login, id);

-- ç´¢å¼•è¯´æ˜ï¼š
-- 1. status: å¿«é€Ÿè¿‡æ»¤çŠ¶æ€
-- 2. last_login: è¿‡æ»¤ç™»å½•æ—¶é—´  
-- 3. id: æ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ’åº
```

**å¤åˆç´¢å¼•çš„åˆ—é¡ºåºåŸåˆ™**ï¼š
```
åŸåˆ™ï¼šå°†é€‰æ‹©æ€§é«˜çš„åˆ—æ”¾åœ¨å‰é¢

ä¾‹å¦‚ï¼š
status = 'inactive' (é€‰æ‹©æ€§ä½ï¼Œåªæœ‰ä¸¤ä¸ªå€¼)
last_login > '2024-01-01' (é€‰æ‹©æ€§ä¸­ç­‰)  
id (é€‰æ‹©æ€§æœ€é«˜ï¼Œå”¯ä¸€å€¼)

æ­£ç¡®é¡ºåºï¼š(last_login, status, id)
```

### 5.2 äº‹åŠ¡å¤„ç†ä¼˜åŒ–


**å°äº‹åŠ¡ç­–ç•¥**ï¼š
```python
def optimized_batch_update(self):
    """ä¼˜åŒ–çš„æ‰¹æ¬¡æ›´æ–°ï¼Œæ¯æ‰¹ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡"""
    for batch_ids in self.get_batches():
        try:
            # æ¯æ‰¹å¼€å¯æ–°äº‹åŠ¡
            self.conn.autocommit = False
            
            sql = f"""
                UPDATE users SET status = 'active'
                WHERE id IN ({','.join(map(str, batch_ids))})
            """
            
            self.cursor.execute(sql)
            
            # ç«‹å³æäº¤ï¼Œé‡Šæ”¾é”
            self.conn.commit()
            
        except Exception as e:
            # å›æ»šå½“å‰æ‰¹æ¬¡
            self.conn.rollback()
            logging.error(f"æ‰¹æ¬¡å¤±è´¥: {batch_ids}, é”™è¯¯: {e}")
            
            # å¯ä»¥é€‰æ‹©é‡è¯•æˆ–è·³è¿‡
            continue
        finally:
            self.conn.autocommit = True
```

### 5.3 å¹¶å‘æ§åˆ¶ä¼˜åŒ–


**é¿å…é”ç«äº‰çš„æŠ€å·§**ï¼š
```sql
-- ä½¿ç”¨SELECT ... FOR UPDATEé¢„å…ˆé”å®š
SELECT id FROM users 
WHERE status = 'inactive' AND last_login < '2024-01-01'
ORDER BY id 
LIMIT 1000
FOR UPDATE SKIP LOCKED;  -- è·³è¿‡å·²é”å®šçš„è¡Œ

-- ç„¶åæ›´æ–°è¿™äº›è®°å½•
UPDATE users SET status = 'active' 
WHERE id IN (é”å®šçš„IDåˆ—è¡¨);
```

### 5.4 ç³»ç»Ÿèµ„æºç›‘æ§


**å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š
```python
import psutil
import time

class SystemMonitor:
    def __init__(self):
        self.cpu_threshold = 80
        self.memory_threshold = 85
        
    def should_pause_processing(self):
        """æ£€æŸ¥æ˜¯å¦éœ€è¦æš‚åœå¤„ç†"""
        cpu_percent = psutil.cpu_percent(interval=1)
        memory_percent = psutil.virtual_memory().percent
        
        if cpu_percent > self.cpu_threshold:
            logging.warning(f"CPUä½¿ç”¨ç‡è¿‡é«˜: {cpu_percent}%")
            return True
            
        if memory_percent > self.memory_threshold:
            logging.warning(f"å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {memory_percent}%")  
            return True
            
        return False
        
    def wait_for_resources(self):
        """ç­‰å¾…ç³»ç»Ÿèµ„æºé‡Šæ”¾"""
        while self.should_pause_processing():
            logging.info("ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œæš‚åœ30ç§’...")
            time.sleep(30)
```

---

## 6. ğŸ“Š ç›‘æ§ä¸æ•…éšœå¤„ç†


### 6.1 è¿›åº¦ç›‘æ§å®ç°


**è¯¦ç»†è¿›åº¦è·Ÿè¸ª**ï¼š
```python
class ProgressTracker:
    def __init__(self, total_records):
        self.total_records = total_records
        self.processed_records = 0
        self.start_time = time.time()
        self.last_report_time = time.time()
        
    def update_progress(self, batch_processed):
        """æ›´æ–°è¿›åº¦ä¿¡æ¯"""
        self.processed_records += batch_processed
        current_time = time.time()
        
        # æ¯30ç§’æŠ¥å‘Šä¸€æ¬¡è¿›åº¦
        if current_time - self.last_report_time >= 30:
            self._report_progress(current_time)
            self.last_report_time = current_time
            
    def _report_progress(self, current_time):
        """æŠ¥å‘Šè¯¦ç»†è¿›åº¦"""
        elapsed_time = current_time - self.start_time
        progress_percent = (self.processed_records / self.total_records) * 100
        
        # ä¼°ç®—å‰©ä½™æ—¶é—´
        if self.processed_records > 0:
            rate = self.processed_records / elapsed_time
            remaining_records = self.total_records - self.processed_records
            eta_seconds = remaining_records / rate
        else:
            eta_seconds = 0
            
        logging.info(f"""
        ===== æ›´æ–°è¿›åº¦æŠ¥å‘Š =====
        å·²å¤„ç†è®°å½•: {self.processed_records:,} / {self.total_records:,}
        å®Œæˆç™¾åˆ†æ¯”: {progress_percent:.1f}%
        å·²ç”¨æ—¶é—´: {self._format_time(elapsed_time)}
        é¢„è®¡å‰©ä½™: {self._format_time(eta_seconds)}
        å¤„ç†é€Ÿç‡: {rate:.0f} è®°å½•/ç§’
        ========================
        """)
        
    def _format_time(self, seconds):
        """æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º"""
        hours = int(seconds // 3600)
        minutes = int((seconds % 3600) // 60)
        seconds = int(seconds % 60)
        return f"{hours:02d}:{minutes:02d}:{seconds:02d}"
```

### 6.2 é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶


**æ™ºèƒ½é‡è¯•ç­–ç•¥**ï¼š
```python
class BatchUpdateWithRetry:
    def __init__(self, max_retries=3):
        self.max_retries = max_retries
        self.failed_batches = []
        
    def execute_batch_with_retry(self, batch_ids):
        """å¸¦é‡è¯•æœºåˆ¶çš„æ‰¹æ¬¡æ‰§è¡Œ"""
        for attempt in range(self.max_retries + 1):
            try:
                return self._execute_single_batch(batch_ids)
                
            except mysql.connector.Error as e:
                error_code = e.errno
                
                # åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
                if self._is_retryable_error(error_code):
                    if attempt < self.max_retries:
                        wait_time = (2 ** attempt) * 5  # æŒ‡æ•°é€€é¿
                        logging.warning(f"æ‰¹æ¬¡å¤±è´¥ï¼Œ{wait_time}ç§’åé‡è¯• "
                                      f"(å°è¯• {attempt + 1}/{self.max_retries + 1})")
                        time.sleep(wait_time)
                        continue
                    else:
                        # æœ€å¤§é‡è¯•æ¬¡æ•°åï¼Œè®°å½•å¤±è´¥æ‰¹æ¬¡
                        self.failed_batches.append({
                            'batch_ids': batch_ids,
                            'error': str(e),
                            'timestamp': time.time()
                        })
                        logging.error(f"æ‰¹æ¬¡å½»åº•å¤±è´¥: {batch_ids}")
                        return 0
                else:
                    # ä¸å¯é‡è¯•é”™è¯¯ï¼Œç›´æ¥å¤±è´¥
                    logging.error(f"ä¸å¯é‡è¯•é”™è¯¯: {e}")
                    return 0
                    
    def _is_retryable_error(self, error_code):
        """åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•"""
        retryable_errors = {
            1205,  # Lock wait timeout
            1213,  # Deadlock found  
            2013,  # Lost connection
            2006,  # MySQL server has gone away
        }
        return error_code in retryable_errors
```

### 6.3 å¼‚å¸¸æƒ…å†µå¤„ç†


**å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ**ï¼š
```python
class ExceptionHandler:
    def handle_connection_loss(self):
        """å¤„ç†æ•°æ®åº“è¿æ¥ä¸¢å¤±"""
        max_reconnect_attempts = 5
        
        for attempt in range(max_reconnect_attempts):
            try:
                logging.info(f"å°è¯•é‡è¿æ•°æ®åº“ (ç¬¬{attempt + 1}æ¬¡)")
                self.conn = self._create_connection()
                self.cursor = self.conn.cursor()
                logging.info("æ•°æ®åº“é‡è¿æˆåŠŸ")
                return True
                
            except Exception as e:
                logging.error(f"é‡è¿å¤±è´¥: {e}")
                time.sleep(min(30, 5 * (attempt + 1)))  # é€’å¢ç­‰å¾…æ—¶é—´
                
        logging.error("æ•°æ®åº“é‡è¿å¤±è´¥ï¼Œç¨‹åºç»ˆæ­¢")
        return False
        
    def handle_disk_full(self):
        """å¤„ç†ç£ç›˜ç©ºé—´ä¸è¶³"""
        logging.error("æ£€æµ‹åˆ°ç£ç›˜ç©ºé—´ä¸è¶³")
        
        # æš‚åœå¤„ç†
        while True:
            disk_usage = psutil.disk_usage('/').percent
            if disk_usage < 90:  # ç£ç›˜ä½¿ç”¨ç‡ä½äº90%
                logging.info("ç£ç›˜ç©ºé—´æ¢å¤ï¼Œç»§ç»­å¤„ç†")
                break
            else:
                logging.warning(f"ç£ç›˜ä½¿ç”¨ç‡: {disk_usage}%ï¼Œç­‰å¾…é‡Šæ”¾...")
                time.sleep(300)  # ç­‰å¾…5åˆ†é’Ÿ
                
    def handle_memory_pressure(self):
        """å¤„ç†å†…å­˜å‹åŠ›"""
        memory_percent = psutil.virtual_memory().percent
        
        if memory_percent > 90:
            logging.warning(f"å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {memory_percent}%")
            
            # å‡å°æ‰¹æ¬¡å¤§å°
            self.batch_size = max(self.batch_size // 2, 100)
            logging.info(f"æ‰¹æ¬¡å¤§å°è°ƒæ•´ä¸º: {self.batch_size}")
            
            # å¼ºåˆ¶åƒåœ¾å›æ”¶
            import gc
            gc.collect()
```

---

## 7. ğŸ¯ æœ€ä½³å®è·µæŒ‡å—


### 7.1 åˆ†æ‰¹æ›´æ–°æœ€ä½³å®è·µ


**ğŸ“‹ æ ¸å¿ƒå®è·µåŸåˆ™**ï¼š

```
ğŸ”¸ æ‰¹æ¬¡å¤§å°é€‰æ‹©ï¼š
â€¢ å°è¡¨(<10ä¸‡): 1000-5000æ¡/æ‰¹
â€¢ ä¸­è¡¨(10ä¸‡-100ä¸‡): 1000-2000æ¡/æ‰¹  
â€¢ å¤§è¡¨(>100ä¸‡): 500-1000æ¡/æ‰¹

ğŸ”¸ æ‰§è¡Œæ—¶æœºé€‰æ‹©ï¼š
â€¢ ä¼˜é€‰ä¸šåŠ¡ä½å³°æœŸï¼ˆå‡Œæ™¨2-6ç‚¹ï¼‰
â€¢ é¿å¼€å¤‡ä»½æ—¶é—´çª—å£
â€¢ è€ƒè™‘ä¸»ä»åŒæ­¥å½±å“

ğŸ”¸ ç›‘æ§æŒ‡æ ‡è®¾ç½®ï¼š
â€¢ CPUä½¿ç”¨ç‡ < 80%
â€¢ å†…å­˜ä½¿ç”¨ç‡ < 85%  
â€¢ ç£ç›˜I/Oç­‰å¾… < 30%
â€¢ ä¸»ä»å»¶è¿Ÿ < 5ç§’
```

### 7.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•


**éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•**ï¼š
```
â˜ æ•°æ®å¤‡ä»½å®Œæˆ
â˜ ç´¢å¼•ä¼˜åŒ–åˆ°ä½  
â˜ ç›‘æ§è„šæœ¬å°±ç»ª
â˜ å›æ»šæ–¹æ¡ˆå‡†å¤‡
â˜ å½±å“è¯„ä¼°å®Œæˆ
â˜ æ‰§è¡Œçª—å£ç¡®è®¤
â˜ ç›¸å…³å›¢é˜Ÿé€šçŸ¥
â˜ ç´§æ€¥è”ç³»äººç¡®å®š
```

**æ‰§è¡Œä¸­ç›‘æ§æ¸…å•**ï¼š
```
â˜ ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡æ­£å¸¸
â˜ é”™è¯¯æ—¥å¿—æ— å¼‚å¸¸
â˜ è¿›åº¦æŒ‰é¢„æœŸæ¨è¿›
â˜ ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸
â˜ ç”¨æˆ·æŠ•è¯‰æ— å¼‚å¸¸å¢é•¿
â˜ ä¸»ä»åŒæ­¥æ­£å¸¸
```

### 7.3 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ


**é—®é¢˜åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜åœºæ™¯ | ç—‡çŠ¶è¡¨ç° | è§£å†³æ–¹æ¡ˆ | é¢„é˜²æªæ–½ |
|---------|---------|---------|---------|
| **æ‰¹æ¬¡è¶…æ—¶** | Lock wait timeout | å‡å°æ‰¹æ¬¡å¤§å° | æå‰æµ‹è¯•ç¡®å®šæœ€ä¼˜æ‰¹æ¬¡ |
| **ä¸»ä»å»¶è¿Ÿ** | ä»åº“å»¶è¿Ÿå¢åŠ  | å¢åŠ æ‰¹æ¬¡é—´éš” | ç›‘æ§ä»åº“çŠ¶æ€ |
| **å†…å­˜ä¸è¶³** | OOMé”™è¯¯ | å‡å°‘å¹¶å‘æ‰¹æ¬¡ | é¢„ä¼°å†…å­˜ä½¿ç”¨é‡ |
| **ç£ç›˜æ»¡** | ç£ç›˜ç©ºé—´ä¸è¶³ | æ¸…ç†ä¸´æ—¶æ–‡ä»¶ | ç›‘æ§ç£ç›˜ä½¿ç”¨ç‡ |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 ğŸ”¸ åˆ†æ‰¹å¤„ç†æ ¸å¿ƒè¦ç‚¹


**åŸºæœ¬åŸç†**ï¼š
```
ğŸ”¸ å¤§è¡¨æ›´æ–°çš„æœ¬è´¨é—®é¢˜ï¼š
â€¢ ä¸€æ¬¡æ€§å¤„ç†æ•°æ®é‡è¿‡å¤§
â€¢ ç³»ç»Ÿèµ„æºæ¶ˆè€—è¿‡å¤š  
â€¢ é•¿æ—¶é—´é”å®šå½±å“ä¸šåŠ¡

ğŸ”¸ åˆ†æ‰¹å¤„ç†çš„æ ¸å¿ƒæ€æƒ³ï¼š
â€¢ åŒ–æ•´ä¸ºé›¶ï¼šå¤§ä»»åŠ¡åˆ†è§£ä¸ºå°ä»»åŠ¡
â€¢ èµ„æºæ§åˆ¶ï¼šæ¯æ¬¡åªä½¿ç”¨å°‘é‡èµ„æº
â€¢ æ¸è¿›æ‰§è¡Œï¼šé€æ­¥å®Œæˆå…¨éƒ¨æ›´æ–°
```

**ğŸ”¸ æ‰¹æ¬¡å¤§å°æ§åˆ¶ç­–ç•¥**ï¼š
```
å…³é”®åŸåˆ™ï¼š
â€¢ å•æ‰¹æ¬¡æ‰§è¡Œæ—¶é—´ï¼š1-5ç§’
â€¢ ç³»ç»Ÿèµ„æºå ç”¨ï¼šä¸è¶…è¿‡80%
â€¢ åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®æ€§èƒ½å®æ—¶ä¼˜åŒ–
â€¢ ä¸šåŠ¡å½±å“ï¼šæœ€å°åŒ–å¯¹å…¶ä»–æ“ä½œçš„å½±å“
```

### 8.2 å®æ–½å…³é”®æ­¥éª¤


**ğŸ”¸ å®æ–½æµç¨‹æ€»ç»“**ï¼š
```
â‘ å‡†å¤‡é˜¶æ®µï¼š
â€¢ è¯„ä¼°æ›´æ–°è§„æ¨¡å’Œå½±å“
â€¢ è®¾è®¡åˆ†æ‰¹ç­–ç•¥  
â€¢ å‡†å¤‡ç›‘æ§å’Œå›æ»šæ–¹æ¡ˆ

â‘¡æ‰§è¡Œé˜¶æ®µï¼š  
â€¢ æŒ‰IDèŒƒå›´æˆ–æ¡ä»¶åˆ†æ‰¹
â€¢ å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½
â€¢ è®°å½•è¿›åº¦å’Œå¼‚å¸¸

â‘¢æ”¶å°¾é˜¶æ®µï¼š
â€¢ éªŒè¯æ›´æ–°ç»“æœ
â€¢ æ¸…ç†ä¸´æ—¶èµ„æº
â€¢ æ€»ç»“ç»éªŒæ•™è®­
```

### 8.3 **ğŸ”¸ å¤§æ‰¹é‡æ›´æ–°åˆ†é¡µå¤„ç†**å…³é”®æŠ€æœ¯


**åˆ†é¡µå¤„ç†æ ¸å¿ƒæŠ€å·§**ï¼š
- **IDèŒƒå›´åˆ†å‰²** - æœ€é«˜æ•ˆçš„åˆ†é¡µæ–¹å¼
- **è‡ªé€‚åº”æ‰¹æ¬¡å¤§å°** - æ ¹æ®æ€§èƒ½åŠ¨æ€è°ƒæ•´
- **æ™ºèƒ½é‡è¯•æœºåˆ¶** - å¤„ç†ä¸´æ—¶å¤±è´¥
- **è¿›åº¦ç›‘æ§** - å®æ—¶è·Ÿè¸ªå¤„ç†çŠ¶æ€
- **èµ„æºä¿æŠ¤** - é˜²æ­¢ç³»ç»Ÿè¿‡è½½

**æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
- **åˆé€‚çš„ç´¢å¼•** - æ”¯æŒå¿«é€Ÿæ¡ä»¶æŸ¥è¯¢
- **å°äº‹åŠ¡** - å‡å°‘é”å®šæ—¶é—´
- **æ‰¹æ¬¡é—´éš”** - ç»™ç³»ç»Ÿæ¢å¤æ—¶é—´
- **å¹¶å‘æ§åˆ¶** - é¿å…èµ„æºç«äº‰

### 8.4 ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹


**å®‰å…¨ä¿éšœæªæ–½**ï¼š
```
â€¢ å……åˆ†æµ‹è¯•ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ–¹æ¡ˆ
â€¢ æ•°æ®å¤‡ä»½ï¼šæ‰§è¡Œå‰å®Œæ•´å¤‡ä»½
â€¢ ç›‘æ§å‘Šè­¦ï¼šè®¾ç½®å…³é”®æŒ‡æ ‡é˜ˆå€¼  
â€¢ å›æ»šå‡†å¤‡ï¼šå‡†å¤‡å¿«é€Ÿå›æ»šæ–¹æ¡ˆ
â€¢ åˆ†é˜¶æ®µæ‰§è¡Œï¼šå¯è€ƒè™‘åˆ†å¤šæ¬¡å®Œæˆ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å¤§è¡¨æ›´æ–°å¿…é¡»åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ç³»ç»Ÿç˜«ç—ª
- æ‰¹æ¬¡å¤§å°éœ€è¦æ ¹æ®ç³»ç»Ÿæ€§èƒ½åŠ¨æ€è°ƒæ•´
- å®Œå–„çš„ç›‘æ§å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶è‡³å…³é‡è¦  
- ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œéœ€è¦å……åˆ†çš„é¢„æ¡ˆå‡†å¤‡
- åˆ†æ‰¹å¤„ç†æ˜¯å¹³è¡¡æ€§èƒ½ä¸ç¨³å®šæ€§çš„æœ€ä½³é€‰æ‹©