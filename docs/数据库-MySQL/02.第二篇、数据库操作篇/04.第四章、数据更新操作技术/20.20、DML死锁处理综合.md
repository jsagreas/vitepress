---
title: 20ã€DMLæ­»é”å¤„ç†ç»¼åˆ
---
## ğŸ“š ç›®å½•

1. [æ­»é”åŸºç¡€æ¦‚å¿µ](#1-æ­»é”åŸºç¡€æ¦‚å¿µ)
2. [INSERTæ­»é”åœºæ™¯åˆ†æ](#2-INSERTæ­»é”åœºæ™¯åˆ†æ)
3. [UPDATEæ­»é”åœºæ™¯åˆ†æ](#3-UPDATEæ­»é”åœºæ™¯åˆ†æ)
4. [DELETEæ­»é”åœºæ™¯åˆ†æ](#4-DELETEæ­»é”åœºæ™¯åˆ†æ)
5. [æ­»é”æ£€æµ‹ä¸ç®—æ³•æœºåˆ¶](#5-æ­»é”æ£€æµ‹ä¸ç®—æ³•æœºåˆ¶)
6. [æ­»é”é¢„é˜²ä¸å¤„ç†ç­–ç•¥](#6-æ­»é”é¢„é˜²ä¸å¤„ç†ç­–ç•¥)
7. [æ­»é”ç›‘æ§ä¸åˆ†æå®è·µ](#7-æ­»é”ç›‘æ§ä¸åˆ†æå®è·µ)
8. [åº”ç”¨å±‚æ­»é”å¤„ç†æ–¹æ¡ˆ](#8-åº”ç”¨å±‚æ­»é”å¤„ç†æ–¹æ¡ˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’€ æ­»é”åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“æ­»é”


**ğŸ”¸ æ­»é”çš„æœ¬è´¨ç†è§£**
```
ç®€å•æ¯”å–»ï¼š
ä¸¤ä¸ªäººåŒæ—¶æƒ³è¦å¯¹æ–¹æ‰‹ä¸­çš„é’¥åŒ™ï¼Œéƒ½ä¸æ„¿æ„å…ˆæ”¾æ‰‹
ç»“æœï¼šä¸¤äººéƒ½æ‹¿ä¸åˆ°å¯¹æ–¹çš„é’¥åŒ™ï¼Œé™·å…¥æ— é™ç­‰å¾…

æ•°æ®åº“æ­»é”ï¼š
äº‹åŠ¡AæŒæœ‰èµ„æº1ï¼Œç­‰å¾…èµ„æº2
äº‹åŠ¡BæŒæœ‰èµ„æº2ï¼Œç­‰å¾…èµ„æº1
ç»“æœï¼šä¸¤ä¸ªäº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œ
```

**ğŸ”„ æ­»é”çš„ç»å…¸å››è¦ç´ **
```
1. äº’æ–¥æ¡ä»¶ï¼šèµ„æºä¸èƒ½è¢«å¤šä¸ªäº‹åŠ¡åŒæ—¶å ç”¨
2. æŒæœ‰å¹¶ç­‰å¾…ï¼šäº‹åŠ¡æŒæœ‰èµ„æºçš„åŒæ—¶ç­‰å¾…å…¶ä»–èµ„æº  
3. ä¸å¯å‰¥å¤ºï¼šèµ„æºä¸èƒ½è¢«å¼ºåˆ¶é‡Šæ”¾
4. å¾ªç¯ç­‰å¾…ï¼šå½¢æˆäº‹åŠ¡é—´çš„å¾ªç¯ç­‰å¾…é“¾

åªæœ‰å››ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³ï¼Œæ‰ä¼šå‘ç”Ÿæ­»é”
ç ´åä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œéƒ½å¯ä»¥é¿å…æ­»é”
```

### 1.2 MySQLä¸­çš„é”ç±»å‹ä¸æ­»é”å…³ç³»


**ğŸ” MySQLé”çš„åˆ†ç±»**
```
æŒ‰é”å®šèŒƒå›´åˆ†ç±»ï¼š
â€¢ è¡¨çº§é”ï¼šé”å®šæ•´å¼ è¡¨ï¼Œç²’åº¦å¤§ï¼Œå¹¶å‘æ€§å·®
â€¢ è¡Œçº§é”ï¼šé”å®šå…·ä½“è¡Œï¼Œç²’åº¦å°ï¼Œå¹¶å‘æ€§å¥½
â€¢ é¡µçº§é”ï¼šé”å®šæ•°æ®é¡µï¼Œä»‹äºä¸¤è€…ä¹‹é—´

æŒ‰é”å®šæ¨¡å¼åˆ†ç±»ï¼š
â€¢ å…±äº«é”ï¼ˆSé”ï¼‰ï¼šè¯»é”ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰
â€¢ æ’ä»–é”ï¼ˆXé”ï¼‰ï¼šå†™é”ï¼Œåªèƒ½è¢«ä¸€ä¸ªäº‹åŠ¡æŒæœ‰
â€¢ æ„å‘é”ï¼šè¡¨ç¤ºäº‹åŠ¡å‡†å¤‡åœ¨æ›´ç»†ç²’åº¦ä¸ŠåŠ é”
```

**ğŸ“Š é”å…¼å®¹æ€§çŸ©é˜µ**
```
        | IS  | IX  |  S  |  X  |
--------|-----|-----|-----|-----|
   IS   |  âœ“  |  âœ“  |  âœ“  |  âœ—  |
   IX   |  âœ“  |  âœ“  |  âœ—  |  âœ—  |
   S    |  âœ“  |  âœ—  |  âœ“  |  âœ—  |
   X    |  âœ—  |  âœ—  |  âœ—  |  âœ—  |

âœ“ è¡¨ç¤ºå…¼å®¹ï¼Œâœ— è¡¨ç¤ºå†²çª
å†²çªæ—¶éœ€è¦ç­‰å¾…ï¼Œå®¹æ˜“äº§ç”Ÿæ­»é”
```

### 1.3 InnoDBå­˜å‚¨å¼•æ“çš„é”æœºåˆ¶


**ğŸ”§ InnoDBé”çš„ç‰¹ç‚¹**
```
è¡Œçº§é”æœºåˆ¶ï¼š
â€¢ åŸºäºç´¢å¼•å®ç°è¡Œçº§é”
â€¢ æ— ç´¢å¼•æ—¶ä¼šé”å®šæ•´å¼ è¡¨
â€¢ æ”¯æŒå¤šç²’åº¦é”å®š

é”å®šç®—æ³•ï¼š
â€¢ Record Lockï¼šè®°å½•é”ï¼Œé”å®šå…·ä½“è¡Œ
â€¢ Gap Lockï¼šé—´éš™é”ï¼Œé”å®šè®°å½•é—´çš„ç©ºéš™
â€¢ Next-Key Lockï¼šè®°å½•é”+é—´éš™é”çš„ç»„åˆ

é”å®šæ—¶æœºï¼š
â€¢ SELECTï¼šé€šå¸¸ä¸åŠ é”ï¼ˆMVCCæœºåˆ¶ï¼‰
â€¢ INSERTï¼šå¯¹æ’å…¥è¡ŒåŠ æ’ä»–é”
â€¢ UPDATEï¼šå¯¹ä¿®æ”¹è¡ŒåŠ æ’ä»–é”
â€¢ DELETEï¼šå¯¹åˆ é™¤è¡ŒåŠ æ’ä»–é”
```

---

## 2. ğŸ“ INSERTæ­»é”åœºæ™¯åˆ†æ


### 2.1 å”¯ä¸€ç´¢å¼•æ’å…¥å†²çªæ­»é”


**ğŸ”¸ ç»å…¸åœºæ™¯æè¿°**
```
è¡¨ç»“æ„ï¼š
CREATE TABLE users (
    id INT PRIMARY KEY,
    email VARCHAR(100) UNIQUE,
    name VARCHAR(50)
);

æ­»é”åœºæ™¯ï¼š
æ—¶åˆ»T1ï¼šäº‹åŠ¡Aæ‰§è¡Œ INSERT INTO users VALUES (1, 'a@test.com', 'Alice');
æ—¶åˆ»T2ï¼šäº‹åŠ¡Bæ‰§è¡Œ INSERT INTO users VALUES (2, 'a@test.com', 'Bob');
æ—¶åˆ»T3ï¼šäº‹åŠ¡Aæ‰§è¡Œ INSERT INTO users VALUES (3, 'b@test.com', 'Carol');
æ—¶åˆ»T4ï¼šäº‹åŠ¡Bæ‰§è¡Œ INSERT INTO users VALUES (4, 'c@test.com', 'David');
```

**ğŸ•’ æ­»é”äº§ç”Ÿè¿‡ç¨‹è¯¦è§£**
```
æ­¥éª¤1ï¼šäº‹åŠ¡Aæ’å…¥ id=1, email='a@test.com'
       - è·å¾—ä¸»é”®id=1çš„æ’ä»–é”
       - è·å¾—å”¯ä¸€ç´¢å¼•email='a@test.com'çš„æ’ä»–é”

æ­¥éª¤2ï¼šäº‹åŠ¡Bæ’å…¥ id=2, email='a@test.com'ï¼ˆé‡å¤ï¼‰
       - è·å¾—ä¸»é”®id=2çš„æ’ä»–é”  
       - å°è¯•è·å–email='a@test.com'çš„æ’ä»–é”
       - è¢«äº‹åŠ¡Aé˜»å¡ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€

æ­¥éª¤3ï¼šäº‹åŠ¡Aæ’å…¥ id=3, email='b@test.com'
       - å°è¯•è·å¾—ä¸»é”®id=3çš„æ’ä»–é”
       - æ­¤æ—¶éœ€è¦æ£€æŸ¥å”¯ä¸€çº¦æŸï¼Œæ‰«ææ•´ä¸ªè¡¨
       - å°è¯•è·å–id=2çš„å…±äº«é”è¿›è¡Œé‡å¤å€¼æ£€æŸ¥
       - è¢«äº‹åŠ¡Bé˜»å¡ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…

ç»“æœï¼šæ­»é”å‘ç”Ÿï¼ŒMySQLè‡ªåŠ¨å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡
```

**ğŸ’¡ å®é™…æµ‹è¯•ä»£ç **
```sql
-- ä¼šè¯1ï¼ˆäº‹åŠ¡Aï¼‰
START TRANSACTION;
INSERT INTO users VALUES (1, 'a@test.com', 'Alice');
-- ç­‰å¾…ä¼šè¯2æ‰§è¡Œåå†ç»§ç»­
INSERT INTO users VALUES (3, 'b@test.com', 'Carol');

-- ä¼šè¯2ï¼ˆäº‹åŠ¡Bï¼‰  
START TRANSACTION;
INSERT INTO users VALUES (2, 'a@test.com', 'Bob');  -- ä¼šé˜»å¡
-- ç­‰å¾…ä¼šè¯1æ‰§è¡Œç¬¬äºŒæ¡INSERTå
INSERT INTO users VALUES (4, 'c@test.com', 'David');

-- ç»“æœï¼šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ä¼šè¢«å›æ»šï¼ŒæŠ¥å‘Šæ­»é”é”™è¯¯
```

### 2.2 è‡ªå¢ä¸»é”®æ’å…¥æ­»é”


**ğŸ”¸ è‡ªå¢é”å¯¼è‡´çš„æ­»é”**
```
è¡¨ç»“æ„ï¼š
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10,2),
    KEY idx_user (user_id)
);

æ­»é”åœºæ™¯ï¼š
å¤§é‡å¹¶å‘æ’å…¥æ—¶ï¼Œè‡ªå¢é”ä¸è¡Œçº§é”ç›¸äº’ç­‰å¾…
```

**ğŸ“Š è‡ªå¢é”æœºåˆ¶è¯´æ˜**
```
è‡ªå¢é”ç±»å‹ï¼ˆinnodb_autoinc_lock_modeï¼‰ï¼š

æ¨¡å¼0ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰ï¼š
â€¢ æ‰€æœ‰INSERTéƒ½è¦è·å–è¡¨çº§è‡ªå¢é”
â€¢ æŒç»­åˆ°è¯­å¥ç»“æŸ
â€¢ å¹¶å‘æ€§æœ€å·®ï¼Œä½†æ•°æ®ä¸€è‡´æ€§æœ€å¥½

æ¨¡å¼1ï¼ˆè¿ç»­æ¨¡å¼ï¼‰ï¼š
â€¢ ç®€å•INSERTä½¿ç”¨è½»é‡çº§é”
â€¢ æ‰¹é‡INSERTä½¿ç”¨è¡¨çº§é”
â€¢ å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§

æ¨¡å¼2ï¼ˆäº¤å‰æ¨¡å¼ï¼‰ï¼š
â€¢ æ‰€æœ‰INSERTéƒ½ä½¿ç”¨è½»é‡çº§é”
â€¢ æ€§èƒ½æœ€å¥½ï¼Œä½†ä¸»ä»å¤åˆ¶æ—¶å¯èƒ½ä¸ä¸€è‡´
```

**ğŸ”§ é¿å…è‡ªå¢æ­»é”çš„æ–¹æ³•**
```sql
-- æ–¹æ³•1ï¼šè°ƒæ•´è‡ªå¢é”æ¨¡å¼
SET GLOBAL innodb_autoinc_lock_mode = 2;

-- æ–¹æ³•2ï¼šæ‰¹é‡æ’å…¥æ›¿ä»£é€æ¡æ’å…¥
INSERT INTO orders (user_id, amount) VALUES 
(1, 100.00), (2, 200.00), (3, 150.00);

-- æ–¹æ³•3ï¼šä½¿ç”¨åºåˆ—è¡¨æ›¿ä»£è‡ªå¢
CREATE TABLE sequence_table (
    name VARCHAR(50) PRIMARY KEY,
    value BIGINT NOT NULL
);
```

### 2.3 å¤–é”®çº¦æŸæ’å…¥æ­»é”


**ğŸ”— å¤–é”®æ­»é”åœºæ™¯**
```
è¡¨ç»“æ„ï¼š
CREATE TABLE departments (
    id INT PRIMARY KEY,
    name VARCHAR(100)
);

CREATE TABLE employees (
    id INT PRIMARY KEY,
    dept_id INT,
    name VARCHAR(100),
    FOREIGN KEY (dept_id) REFERENCES departments(id)
);

æ­»é”åœºæ™¯ï¼š
äº‹åŠ¡Aï¼šINSERT INTO departments VALUES (1, 'IT');
äº‹åŠ¡Bï¼šINSERT INTO employees VALUES (1, 1, 'John');
äº‹åŠ¡Aï¼šINSERT INTO employees VALUES (2, 1, 'Jane');
äº‹åŠ¡Bï¼šINSERT INTO departments VALUES (2, 'HR');
```

**ğŸ’­ å¤–é”®æ­»é”åŸç†åˆ†æ**
```
å¤–é”®çº¦æŸæ£€æŸ¥éœ€è¦ï¼š
1. å¯¹çˆ¶è¡¨è¿›è¡Œå…±äº«é”å®šï¼ˆæ£€æŸ¥å¤–é”®å­˜åœ¨æ€§ï¼‰
2. å¯¹å­è¡¨è¿›è¡Œæ’ä»–é”å®šï¼ˆæ’å…¥æ–°è®°å½•ï¼‰

å¹¶å‘åœºæ™¯ä¸‹å®¹æ˜“å½¢æˆï¼š
äº‹åŠ¡AæŒæœ‰çˆ¶è¡¨é”ï¼Œç­‰å¾…å­è¡¨é”
äº‹åŠ¡BæŒæœ‰å­è¡¨é”ï¼Œç­‰å¾…çˆ¶è¡¨é”
```

---

## 3. ğŸ”„ UPDATEæ­»é”åœºæ™¯åˆ†æ


### 3.1 ç´¢å¼•æ¡ä»¶UPDATEæ­»é”


**ğŸ”¸ ç»å…¸UPDATEæ­»é”åœºæ™¯**
```
è¡¨ç»“æ„ï¼š
CREATE TABLE accounts (
    id INT PRIMARY KEY,
    balance DECIMAL(10,2),
    status INT,
    KEY idx_status (status)
);

æ•°æ®ï¼š
INSERT INTO accounts VALUES 
(1, 1000.00, 1),
(2, 2000.00, 1), 
(3, 1500.00, 2);

æ­»é”åœºæ™¯ï¼š
äº‹åŠ¡Aï¼šUPDATE accounts SET balance = balance - 100 WHERE id = 1;
äº‹åŠ¡Bï¼šUPDATE accounts SET balance = balance - 200 WHERE id = 2;
äº‹åŠ¡Aï¼šUPDATE accounts SET status = 2 WHERE id = 2;
äº‹åŠ¡Bï¼šUPDATE accounts SET status = 2 WHERE id = 1;
```

**ğŸ“ˆ æ­»é”äº§ç”Ÿæ—¶åºå›¾**
```
æ—¶é—´è½´    äº‹åŠ¡A                        äº‹åŠ¡B
  |                                      
T1    UPDATE accounts                    |
      SET balance = balance - 100        |
      WHERE id = 1;                      |
      [è·å¾—id=1çš„è¡Œé”]                    |
  |                                      |
T2       |                         UPDATE accounts
         |                         SET balance = balance - 200  
         |                         WHERE id = 2;
         |                         [è·å¾—id=2çš„è¡Œé”]
  |                                      |
T3    UPDATE accounts                    |
      SET status = 2                     |
      WHERE id = 2;                      |
      [ç­‰å¾…id=2çš„è¡Œé”]                    |
  |                                      |
T4       |                         UPDATE accounts
         |                         SET status = 2
         |                         WHERE id = 1;
         |                         [ç­‰å¾…id=1çš„è¡Œé”]
  |                                      |
T5    [æ­»é”æ£€æµ‹å™¨å‘ç°å¾ªç¯ç­‰å¾…]            |
      [é€‰æ‹©äº‹åŠ¡Bä½œä¸ºæ­»é”å—å®³è€…]            |
      [äº‹åŠ¡Bè¢«å›æ»š]                      |
```

### 3.2 èŒƒå›´UPDATEæ­»é”


**ğŸ”¸ èŒƒå›´é”å®šå¯¼è‡´çš„æ­»é”**
```sql
-- åœºæ™¯ï¼šä¸¤ä¸ªäº‹åŠ¡åŒæ—¶è¿›è¡ŒèŒƒå›´æ›´æ–°
-- äº‹åŠ¡A
START TRANSACTION;
UPDATE accounts SET balance = balance * 1.1 
WHERE status = 1 ORDER BY id;

-- äº‹åŠ¡B  
START TRANSACTION;
UPDATE accounts SET balance = balance * 0.9 
WHERE status = 1 ORDER BY id DESC;
```

**ğŸ” èŒƒå›´æ­»é”åˆ†æ**
```
é—®é¢˜æ ¹æºï¼š
1. ä¸¤ä¸ªäº‹åŠ¡ä»¥ä¸åŒé¡ºåºé”å®šç›¸åŒçš„è¡Œ
2. äº‹åŠ¡AæŒ‰idæ­£åºé”å®šï¼š1â†’2â†’3
3. äº‹åŠ¡BæŒ‰idå€’åºé”å®šï¼š3â†’2â†’1
4. åœ¨ä¸­é—´æŸè¡Œå½¢æˆäº¤å‰ç­‰å¾…

è§£å†³æ–¹æ¡ˆï¼š
1. ç»Ÿä¸€é”å®šé¡ºåºï¼ˆéƒ½æŒ‰idæ­£åºï¼‰
2. ç¼©å°é”å®šèŒƒå›´ï¼ˆåˆ†æ‰¹å¤„ç†ï¼‰
3. é™ä½éš”ç¦»çº§åˆ«ï¼ˆå¦‚æœä¸šåŠ¡å…è®¸ï¼‰
```

### 3.3 å¹¶å‘æ›´æ–°ç›¸åŒè®°å½•æ­»é”


**âš¡ é«˜å¹¶å‘åœºæ™¯æ­»é”**
```sql
-- å…¸å‹åœºæ™¯ï¼šåº“å­˜æ‰£å‡
CREATE TABLE products (
    id INT PRIMARY KEY,
    stock INT,
    version INT DEFAULT 0
);

-- å¤šä¸ªäº‹åŠ¡åŒæ—¶æ‰£å‡åº“å­˜
-- äº‹åŠ¡A
UPDATE products SET stock = stock - 1 WHERE id = 1 AND stock > 0;

-- äº‹åŠ¡B
UPDATE products SET stock = stock - 2 WHERE id = 1 AND stock > 0;

-- äº‹åŠ¡C  
UPDATE products SET stock = stock - 1 WHERE id = 1 AND stock > 0;
```

**ğŸ›¡ï¸ ä¹è§‚é”è§£å†³æ–¹æ¡ˆ**
```sql
-- ä½¿ç”¨ç‰ˆæœ¬å·é¿å…æ­»é”
SELECT id, stock, version FROM products WHERE id = 1;
-- å‡è®¾å¾—åˆ°ï¼šid=1, stock=10, version=5

UPDATE products 
SET stock = stock - 1, version = version + 1 
WHERE id = 1 AND version = 5;

-- æ£€æŸ¥å½±å“è¡Œæ•°ï¼Œå¦‚æœä¸º0è¯´æ˜ç‰ˆæœ¬å·²å˜åŒ–ï¼Œéœ€è¦é‡è¯•
```

---

## 4. ğŸ—‘ï¸ DELETEæ­»é”åœºæ™¯åˆ†æ


### 4.1 æ‰¹é‡DELETEæ­»é”


**ğŸ”¸ å¤§èŒƒå›´åˆ é™¤æ­»é”**
```sql
-- è¡¨ç»“æ„
CREATE TABLE logs (
    id BIGINT PRIMARY KEY,
    user_id INT,
    create_time DATETIME,
    KEY idx_user_time (user_id, create_time),
    KEY idx_time (create_time)
);

-- æ­»é”åœºæ™¯ï¼šåŒæ—¶æŒ‰ä¸åŒæ¡ä»¶åˆ é™¤
-- äº‹åŠ¡Aï¼šæŒ‰æ—¶é—´åˆ é™¤
DELETE FROM logs WHERE create_time < '2025-01-01' LIMIT 1000;

-- äº‹åŠ¡Bï¼šæŒ‰ç”¨æˆ·åˆ é™¤  
DELETE FROM logs WHERE user_id = 12345 LIMIT 500;
```

**ğŸ“Š DELETEé”å®šæœºåˆ¶**
```
DELETEè¯­å¥çš„é”å®šè¡Œä¸ºï¼š
1. é¦–å…ˆé”å®šè¦åˆ é™¤çš„è¡Œ
2. å¯¹ç›¸å…³ç´¢å¼•åŠ é”
3. æŒ‰ä¸»é”®é¡ºåºè¿›è¡Œé”å®š

æ­»é”äº§ç”ŸåŸå› ï¼š
â€¢ ä¸åŒçš„åˆ é™¤æ¡ä»¶å¯èƒ½å¯¼è‡´ä¸åŒçš„é”å®šé¡ºåº
â€¢ å¤§æ‰¹é‡åˆ é™¤æ—¶é”å®šè¡Œæ•°è¿‡å¤š
â€¢ ç´¢å¼•æ‰«æä¸è¡¨æ‰«æçš„é”å®šé¡ºåºä¸ä¸€è‡´
```

### 4.2 çº§è”åˆ é™¤æ­»é”


**ğŸ”— å¤–é”®çº§è”åˆ é™¤æ­»é”**
```sql
-- è¡¨ç»“æ„
CREATE TABLE orders (
    id INT PRIMARY KEY,
    customer_id INT,
    order_date DATE
);

CREATE TABLE order_items (
    id INT PRIMARY KEY, 
    order_id INT,
    product_id INT,
    quantity INT,
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
);

-- æ­»é”åœºæ™¯
-- äº‹åŠ¡Aï¼šåˆ é™¤è®¢å•ï¼ˆä¼šçº§è”åˆ é™¤è®¢å•é¡¹ï¼‰
DELETE FROM orders WHERE id = 1;

-- äº‹åŠ¡Bï¼šç›´æ¥åˆ é™¤è®¢å•é¡¹
DELETE FROM order_items WHERE order_id = 1;
```

**âš ï¸ çº§è”åˆ é™¤æ­»é”é˜²èŒƒ**
```sql
-- æ–¹æ³•1ï¼šæ˜¾å¼æ§åˆ¶åˆ é™¤é¡ºåº
START TRANSACTION;
DELETE FROM order_items WHERE order_id = 1;
DELETE FROM orders WHERE id = 1;
COMMIT;

-- æ–¹æ³•2ï¼šä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ§åˆ¶
DELIMITER $$
CREATE PROCEDURE safe_delete_order(IN p_order_id INT)
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;
    
    START TRANSACTION;
    DELETE FROM order_items WHERE order_id = p_order_id;
    DELETE FROM orders WHERE id = p_order_id;
    COMMIT;
END$$
DELIMITER ;
```

### 4.3 æ¡ä»¶åˆ é™¤æ­»é”


**ğŸ¯ å¤æ‚æ¡ä»¶åˆ é™¤æ­»é”**
```sql
-- åœºæ™¯ï¼šæ ¹æ®å¤æ‚æ¡ä»¶åˆ é™¤æ•°æ®
-- äº‹åŠ¡A
DELETE FROM users 
WHERE status = 0 
  AND last_login_time < DATE_SUB(NOW(), INTERVAL 30 DAY)
  AND id BETWEEN 1000 AND 2000;

-- äº‹åŠ¡B
DELETE FROM users
WHERE status IN (0, 1)
  AND created_time < '2024-01-01'  
  AND id BETWEEN 1500 AND 3000;
```

**ğŸ” å¤æ‚åˆ é™¤æ­»é”åˆ†æ**
```
æ­»é”åŸå› åˆ†æï¼š
1. æ¡ä»¶é‡å ï¼šä¸¤ä¸ªåˆ é™¤æ¡ä»¶å­˜åœ¨äº¤é›†
2. æ‰«æé¡ºåºï¼šä¸åŒçš„WHEREæ¡ä»¶å¯¼è‡´ä¸åŒæ‰«æé¡ºåº
3. ç´¢å¼•é€‰æ‹©ï¼šä¼˜åŒ–å™¨å¯èƒ½é€‰æ‹©ä¸åŒç´¢å¼•

é¢„é˜²ç­–ç•¥ï¼š
1. ç»Ÿä¸€åˆ é™¤é¡ºåºï¼ˆæŒ‰ä¸»é”®æ’åºï¼‰
2. åˆ†æ‰¹åˆ é™¤ï¼Œå‡å°‘é”å®šèŒƒå›´
3. ä½¿ç”¨ç›¸åŒçš„WHEREæ¡ä»¶ç»“æ„
```

---

## 5. ğŸ” æ­»é”æ£€æµ‹ä¸ç®—æ³•æœºåˆ¶


### 5.1 æ­»é”æ£€æµ‹wait-forå›¾


**ğŸ”¸ wait-forå›¾çš„åŸºæœ¬æ¦‚å¿µ**
```
wait-forå›¾æ˜¯ä»€ä¹ˆï¼š
ä¸€ç§æœ‰å‘å›¾ï¼Œç”¨æ¥è¡¨ç¤ºäº‹åŠ¡é—´çš„ç­‰å¾…å…³ç³»
â€¢ èŠ‚ç‚¹ï¼šä»£è¡¨äº‹åŠ¡
â€¢ æœ‰å‘è¾¹ï¼šä»£è¡¨ç­‰å¾…å…³ç³»
â€¢ ç¯è·¯ï¼šè¡¨ç¤ºæ­»é”çš„å­˜åœ¨

å›¾çš„æ„å»ºï¼š
å¦‚æœäº‹åŠ¡Aç­‰å¾…äº‹åŠ¡BæŒæœ‰çš„èµ„æº
åˆ™ä»AæŒ‡å‘Bç”»ä¸€æ¡æœ‰å‘è¾¹
```

**ğŸ“Š wait-forå›¾ç¤ºä¾‹**
```
ç®€å•æ­»é”åœºæ™¯ï¼š
äº‹åŠ¡T1æŒæœ‰èµ„æºR1ï¼Œç­‰å¾…èµ„æºR2
äº‹åŠ¡T2æŒæœ‰èµ„æºR2ï¼Œç­‰å¾…èµ„æºR1

wait-forå›¾ï¼š
    T1 -----> T2
     ^         |
     |         |
     +---------+

å½¢æˆç¯è·¯ï¼šT1 â†’ T2 â†’ T1ï¼Œæ£€æµ‹åˆ°æ­»é”
```

**ğŸ”§ å¤æ‚æ­»é”æ£€æµ‹ç¤ºä¾‹**
```
å¤šäº‹åŠ¡æ­»é”åœºæ™¯ï¼š
T1 â†’ T2 ï¼ˆT1ç­‰å¾…T2ï¼‰
T2 â†’ T3 ï¼ˆT2ç­‰å¾…T3ï¼‰  
T3 â†’ T4 ï¼ˆT3ç­‰å¾…T4ï¼‰
T4 â†’ T1 ï¼ˆT4ç­‰å¾…T1ï¼‰

wait-forå›¾ï¼š
    T1 -----> T2
     ^         |
     |         v  
    T4 <----- T3

ç¯è·¯æ£€æµ‹ï¼šT1 â†’ T2 â†’ T3 â†’ T4 â†’ T1
```

### 5.2 æ­»é”å—å®³è€…é€‰æ‹©ç®—æ³•


**ğŸ¯ InnoDBçš„å—å®³è€…é€‰æ‹©ç­–ç•¥**
```
é€‰æ‹©æ ‡å‡†ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ï¼š

1. äº‹åŠ¡æƒé‡ï¼ˆWeightï¼‰ï¼š
   æƒé‡ = äº‹åŠ¡ä¿®æ”¹çš„è¡Œæ•° + äº‹åŠ¡æŒæœ‰çš„é”æ•°
   é€‰æ‹©æƒé‡æœ€å°çš„äº‹åŠ¡ä½œä¸ºå—å®³è€…

2. äº‹åŠ¡å¹´é¾„ï¼š
   ä¼˜å…ˆé€‰æ‹©è¾ƒæ–°çš„äº‹åŠ¡ï¼ˆå¼€å§‹æ—¶é—´è¾ƒæ™šï¼‰
   ä¿æŠ¤é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡

3. äº‹åŠ¡å¤§å°ï¼š
   ä¼˜å…ˆé€‰æ‹©ä¿®æ”¹æ•°æ®è¾ƒå°‘çš„äº‹åŠ¡
   å‡å°‘å›æ»šæˆæœ¬

4. éšæœºé€‰æ‹©ï¼š
   å½“å…¶ä»–æ¡ä»¶ç›¸åŒæ—¶ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ª
```

**ğŸ’¡ å—å®³è€…é€‰æ‹©ç®—æ³•å®ç°é€»è¾‘**
```c
// InnoDBæ­»é”å—å®³è€…é€‰æ‹©ä¼ªä»£ç 
Transaction* select_deadlock_victim(vector<Transaction*> deadlock_cycle) {
    Transaction* victim = nullptr;
    int min_weight = INT_MAX;
    
    for (auto& trx : deadlock_cycle) {
        // è®¡ç®—äº‹åŠ¡æƒé‡
        int weight = trx->modified_rows + trx->lock_count;
        
        // é€‰æ‹©æƒé‡æœ€å°çš„äº‹åŠ¡
        if (weight < min_weight) {
            min_weight = weight;
            victim = trx;
        } 
        // æƒé‡ç›¸åŒæ—¶ï¼Œé€‰æ‹©è¾ƒæ–°çš„äº‹åŠ¡
        else if (weight == min_weight && 
                 trx->start_time > victim->start_time) {
            victim = trx;
        }
    }
    
    return victim;
}
```

### 5.3 innodb_deadlock_detecté…ç½®


**âšš æ­»é”æ£€æµ‹é…ç½®å‚æ•°**
```sql
-- æŸ¥çœ‹å½“å‰æ­»é”æ£€æµ‹é…ç½®
SHOW VARIABLES LIKE '%deadlock%';

-- ä¸»è¦å‚æ•°è¯´æ˜
innodb_deadlock_detect = ON/OFF   -- æ˜¯å¦å¯ç”¨æ­»é”æ£€æµ‹
innodb_lock_wait_timeout = 50     -- é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
innodb_print_all_deadlocks = OFF  -- æ˜¯å¦æ‰“å°æ‰€æœ‰æ­»é”ä¿¡æ¯
```

**ğŸ”§ æ­»é”æ£€æµ‹é…ç½®è¯¦è§£**
```sql
-- 1. å¯ç”¨æ­»é”æ£€æµ‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰
SET GLOBAL innodb_deadlock_detect = ON;

-- ä¼˜ç‚¹ï¼šå¿«é€Ÿæ£€æµ‹å’Œè§£å†³æ­»é”
-- ç¼ºç‚¹ï¼šé«˜å¹¶å‘æ—¶æ£€æµ‹å¼€é”€å¤§

-- 2. å…³é—­æ­»é”æ£€æµ‹
SET GLOBAL innodb_deadlock_detect = OFF;

-- ä¼˜ç‚¹ï¼šå‡å°‘æ£€æµ‹å¼€é”€ï¼Œæé«˜å¹¶å‘æ€§èƒ½
-- ç¼ºç‚¹ï¼šä¾èµ–è¶…æ—¶æœºåˆ¶ï¼Œå“åº”è¾ƒæ…¢

-- 3. é…ç½®é”ç­‰å¾…è¶…æ—¶
SET GLOBAL innodb_lock_wait_timeout = 30;

-- å»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´
-- åœ¨çº¿äº‹åŠ¡ï¼šè¾ƒçŸ­è¶…æ—¶ï¼ˆ10-30ç§’ï¼‰
-- æ‰¹å¤„ç†ï¼šè¾ƒé•¿è¶…æ—¶ï¼ˆ300-600ç§’ï¼‰
```

**ğŸ“Š æ­»é”æ£€æµ‹æ€§èƒ½å½±å“**
```
æ­»é”æ£€æµ‹å¼€é”€åˆ†æï¼š

é«˜å¹¶å‘åœºæ™¯ï¼ˆ1000+ TPSï¼‰ï¼š
â€¢ æ­»é”æ£€æµ‹å¼€å¯ï¼šé¢å¤–5-15%CPUå¼€é”€
â€¢ æ­»é”æ£€æµ‹å…³é—­ï¼šå‡å°‘æ£€æµ‹å¼€é”€ï¼Œä½†ä¾èµ–è¶…æ—¶

ä½å¹¶å‘åœºæ™¯ï¼ˆ<100 TPSï¼‰ï¼š
â€¢ æ­»é”æ£€æµ‹å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥
â€¢ å»ºè®®ä¿æŒå¼€å¯çŠ¶æ€

é…ç½®å»ºè®®ï¼š
if (å¹¶å‘TPS > 1000 && æ­»é”é¢‘ç‡ä½) {
    è€ƒè™‘å…³é—­æ­»é”æ£€æµ‹ï¼Œä¾èµ–è¶…æ—¶æœºåˆ¶
} else {
    ä¿æŒæ­»é”æ£€æµ‹å¼€å¯
}
```

### 5.4 æ­»é”è¶…æ—¶å¤„ç†æœºåˆ¶


**â° è¶…æ—¶å¤„ç†æµç¨‹**
```
é”ç­‰å¾…è¶…æ—¶æœºåˆ¶ï¼š
1. äº‹åŠ¡è¯·æ±‚é”æ—¶å¼€å§‹è®¡æ—¶
2. è¶…è¿‡innodb_lock_wait_timeoutæ—¶é—´å
3. è¿”å›é”ç­‰å¾…è¶…æ—¶é”™è¯¯
4. äº‹åŠ¡è¢«å¼ºåˆ¶å›æ»š

è¶…æ—¶vsæ­»é”æ£€æµ‹ï¼š
â€¢ æ­»é”æ£€æµ‹ï¼šä¸»åŠ¨å‘ç°ï¼Œå¿«é€Ÿå“åº”ï¼ˆæ¯«ç§’çº§ï¼‰
â€¢ è¶…æ—¶æœºåˆ¶ï¼šè¢«åŠ¨ç­‰å¾…ï¼Œå“åº”è¾ƒæ…¢ï¼ˆç§’çº§ï¼‰
```

**ğŸ”§ è¶…æ—¶é…ç½®æœ€ä½³å®è·µ**
```sql
-- ä¸åŒä¸šåŠ¡åœºæ™¯çš„è¶…æ—¶é…ç½®

-- Webåº”ç”¨ï¼ˆè¦æ±‚å¿«é€Ÿå“åº”ï¼‰
SET SESSION innodb_lock_wait_timeout = 5;

-- åå°ä»»åŠ¡ï¼ˆå¯ä»¥ç­‰å¾…è¾ƒé•¿æ—¶é—´ï¼‰
SET SESSION innodb_lock_wait_timeout = 300;

-- æ•°æ®è¿ç§»ï¼ˆé•¿æ—¶é—´è¿è¡Œï¼‰
SET SESSION innodb_lock_wait_timeout = 3600;

-- åŠ¨æ€è°ƒæ•´ç­–ç•¥
IF ä¸šåŠ¡é«˜å³°æœŸ THEN
    SET innodb_lock_wait_timeout = 10;
ELSE 
    SET innodb_lock_wait_timeout = 30;
END IF;
```

---

## 6. ğŸ›¡ï¸ æ­»é”é¢„é˜²ä¸å¤„ç†ç­–ç•¥


### 6.1 æ­»é”é¢„é˜²çš„åŸºæœ¬åŸåˆ™


**ğŸ”¸ ç ´åæ­»é”äº§ç”Ÿæ¡ä»¶**
```
æ­»é”é¢„é˜²ç­–ç•¥å¯¹åº”å››ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. ç ´åäº’æ–¥æ¡ä»¶ï¼š
   â€¢ ä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”
   â€¢ é™ä½éš”ç¦»çº§åˆ«ï¼ˆREAD COMMITTEDï¼‰
   â€¢ ä½¿ç”¨æ— é”æ•°æ®ç»“æ„

2. ç ´åæŒæœ‰å¹¶ç­‰å¾…ï¼š
   â€¢ ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„èµ„æº
   â€¢ åŸå­åŒ–æ“ä½œï¼Œå‡å°‘ä¸­é—´çŠ¶æ€

3. ç ´åä¸å¯å‰¥å¤ºï¼š  
   â€¢ è®¾ç½®é”ç­‰å¾…è¶…æ—¶
   â€¢ ä¸»åŠ¨é‡Šæ”¾éƒ¨åˆ†èµ„æº

4. ç ´åå¾ªç¯ç­‰å¾…ï¼š
   â€¢ ç»Ÿä¸€èµ„æºè·å–é¡ºåº
   â€¢ æŒ‰ä¸»é”®é¡ºåºè®¿é—®æ•°æ®
```

### 6.2 ç¼–ç¨‹å±‚é¢çš„æ­»é”é¢„é˜²


**ğŸ“ ç»Ÿä¸€è®¿é—®é¡ºåºç­–ç•¥**
```sql
-- é”™è¯¯ç¤ºä¾‹ï¼šä¸åŒé¡ºåºè®¿é—®å¯¼è‡´æ­»é”
-- äº‹åŠ¡A
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- äº‹åŠ¡B  
UPDATE accounts SET balance = balance - 50 WHERE id = 2;
UPDATE accounts SET balance = balance + 50 WHERE id = 1;

-- æ­£ç¡®ç¤ºä¾‹ï¼šæŒ‰ä¸»é”®é¡ºåºè®¿é—®
-- äº‹åŠ¡Aå’ŒBéƒ½æŒ‰ç›¸åŒé¡ºåº
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- å…ˆè®¿é—®id=1
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- å†è®¿é—®id=2
```

**ğŸ”§ æ‰¹é‡æ“ä½œé˜²æ­»é”æ¨¡å¼**
```sql
-- é“¶è¡Œè½¬è´¦çš„é˜²æ­»é”æ¨¡å¼
DELIMITER $$
CREATE PROCEDURE safe_transfer(
    IN from_id INT,
    IN to_id INT, 
    IN amount DECIMAL(10,2)
)
BEGIN
    DECLARE min_id INT;
    DECLARE max_id INT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION ROLLBACK;
    
    -- ç¡®å®šè®¿é—®é¡ºåº
    IF from_id < to_id THEN
        SET min_id = from_id, max_id = to_id;
    ELSE
        SET min_id = to_id, max_id = from_id;
    END IF;
    
    START TRANSACTION;
    
    -- æŒ‰IDé¡ºåºé”å®šè´¦æˆ·
    SELECT balance FROM accounts WHERE id = min_id FOR UPDATE;
    SELECT balance FROM accounts WHERE id = max_id FOR UPDATE;
    
    -- æ‰§è¡Œè½¬è´¦æ“ä½œ
    UPDATE accounts SET balance = balance - amount WHERE id = from_id;
    UPDATE accounts SET balance = balance + amount WHERE id = to_id;
    
    COMMIT;
END$$
DELIMITER ;
```

### 6.3 åº”ç”¨æ¶æ„å±‚é¢çš„é¢„é˜²


**ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„æ­»é”é¢„é˜²**
```
æœåŠ¡æ‹†åˆ†ç­–ç•¥ï¼š
1. æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼Œå‡å°‘è·¨æœåŠ¡äº‹åŠ¡
2. ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå¼‚æ­¥å¤„ç†
3. å®ç°æœ€ç»ˆä¸€è‡´æ€§ï¼Œé¿å…åˆ†å¸ƒå¼é”

æ•°æ®åº“è®¾è®¡ç­–ç•¥ï¼š
1. å‚ç›´åˆ†åº“ï¼Œä¸šåŠ¡éš”ç¦»
2. æ°´å¹³åˆ†è¡¨ï¼Œå‡å°‘é”å†²çª
3. è¯»å†™åˆ†ç¦»ï¼Œé™ä½é”ç«äº‰
```

**ğŸ’¡ åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ**
```java
// ä½¿ç”¨Sagaæ¨¡å¼é¿å…åˆ†å¸ƒå¼æ­»é”
@Service
public class OrderService {
    
    // è®¢å•å¤„ç†çš„Sagaæµç¨‹
    public void processOrder(Order order) {
        try {
            // æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜
            inventoryService.reduceStock(order.getItems());
            
            // æ­¥éª¤2ï¼šæ‰£å‡ä½™é¢  
            paymentService.deductBalance(order.getUserId(), order.getAmount());
            
            // æ­¥éª¤3ï¼šåˆ›å»ºè®¢å•
            orderRepository.save(order);
            
        } catch (Exception e) {
            // è¡¥å¿æ“ä½œ
            compensateOrder(order);
            throw e;
        }
    }
    
    // è¡¥å¿æ“ä½œ
    private void compensateOrder(Order order) {
        inventoryService.restoreStock(order.getItems());
        paymentService.refundBalance(order.getUserId(), order.getAmount());
    }
}
```

### 6.4 æ•°æ®åº“é…ç½®ä¼˜åŒ–


**âš™ï¸ æ­»é”ç›¸å…³å‚æ•°ä¼˜åŒ–**
```sql
-- 1. è°ƒæ•´äº‹åŠ¡éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- ä¼˜ç‚¹ï¼šå‡å°‘é”å†²çªï¼Œé™ä½æ­»é”æ¦‚ç‡
-- ç¼ºç‚¹ï¼šå¯èƒ½å‡ºç°ä¸å¯é‡å¤è¯»

-- 2. ä¼˜åŒ–é”ç­‰å¾…è¶…æ—¶
SET GLOBAL innodb_lock_wait_timeout = 10;
-- å¿«é€Ÿå¤±è´¥ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…

-- 3. å¯ç”¨æ­»é”æ—¥å¿—
SET GLOBAL innodb_print_all_deadlocks = ON;
-- è®°å½•æ‰€æœ‰æ­»é”ä¿¡æ¯ï¼Œä¾¿äºåˆ†æ

-- 4. è°ƒæ•´æ­»é”æ£€æµ‹
-- é«˜å¹¶å‘åœºæ™¯å¯è€ƒè™‘å…³é—­
SET GLOBAL innodb_deadlock_detect = OFF;

-- 5. ä¼˜åŒ–ç¼“å†²æ± å¤§å°
SET GLOBAL innodb_buffer_pool_size = 1024M;
-- å‡å°‘IOï¼Œé™ä½é”æŒæœ‰æ—¶é—´
```

---

## 7. ğŸ“Š æ­»é”ç›‘æ§ä¸åˆ†æå®è·µ


### 7.1 æ­»é”ç»Ÿè®¡ä¿¡æ¯æ”¶é›†


**ğŸ“ˆ æ­»é”ç›‘æ§æŒ‡æ ‡ä½“ç³»**
```sql
-- 1. æŸ¥çœ‹æ­»é”ç»Ÿè®¡ä¿¡æ¯
SHOW ENGINE INNODB STATUS\G

-- å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
-- Number of deadlocks: æ­»é”æ€»æ•°
-- Number of lock waits: é”ç­‰å¾…æ¬¡æ•°  
-- Number of timeouts: é”ç­‰å¾…è¶…æ—¶æ¬¡æ•°
-- Average time waited: å¹³å‡ç­‰å¾…æ—¶é—´

-- 2. æŸ¥çœ‹æœ€è¿‘æ­»é”è¯¦æƒ…
SELECT * FROM information_schema.INNODB_METRICS 
WHERE NAME LIKE '%lock%' OR NAME LIKE '%deadlock%';

-- 3. å®æ—¶ç›‘æ§æ­»é”
SHOW STATUS LIKE 'Innodb_deadlocks';
SHOW STATUS LIKE 'Innodb_lock_waits';
```

**ğŸ“Š æ­»é”ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# deadlock_monitor.sh - æ­»é”ç›‘æ§è„šæœ¬

MYSQL_USER="monitor"
MYSQL_PASS="password"
MYSQL_HOST="localhost"
LOG_FILE="/var/log/mysql/deadlock_monitor.log"

while true; do
    # è·å–å½“å‰æ­»é”ç»Ÿè®¡
    DEADLOCKS=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e "SHOW STATUS LIKE 'Innodb_deadlocks';" | awk 'NR==2{print $2}')
    
    # è·å–å½“å‰æ—¶é—´
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è®°å½•åˆ°æ—¥å¿—
    echo "[$TIMESTAMP] Deadlocks: $DEADLOCKS" >> $LOG_FILE
    
    # å¦‚æœæ­»é”æ•°é‡å¼‚å¸¸ï¼Œå‘é€å‘Šè­¦
    if [ $DEADLOCKS -gt 100 ]; then
        echo "[$TIMESTAMP] WARNING: High deadlock count detected: $DEADLOCKS" >> $LOG_FILE
        # å‘é€å‘Šè­¦é‚®ä»¶æˆ–è°ƒç”¨å‘Šè­¦æ¥å£
        # send_alert "High deadlock count: $DEADLOCKS"
    fi
    
    sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
```

### 7.2 æ­»é”æ—¥å¿—åˆ†æ


**ğŸ” æ­»é”æ—¥å¿—çš„ç»„æˆç»“æ„**
```
å…¸å‹çš„æ­»é”æ—¥å¿—åŒ…å«ï¼š
1. æ­»é”æ£€æµ‹æ—¶é—´
2. å‚ä¸æ­»é”çš„äº‹åŠ¡ä¿¡æ¯
3. æ¯ä¸ªäº‹åŠ¡æŒæœ‰çš„é”
4. æ¯ä¸ªäº‹åŠ¡ç­‰å¾…çš„é”
5. æ­»é”å—å®³è€…ä¿¡æ¯

æ—¥å¿—ç¤ºä¾‹ç»“æ„ï¼š
=====================================
LATEST DETECTED DEADLOCK
=====================================
2025-09-02 14:30:15 0x7f8b8c000700
*** (1) TRANSACTION:
*** (2) TRANSACTION:
*** WE ROLL BACK TRANSACTION (2)
```

**ğŸ“‹ æ­»é”æ—¥å¿—è¯¦ç»†åˆ†æå®ä¾‹**
```
-- å®é™…æ­»é”æ—¥å¿—æ¡ˆä¾‹
=====================================
LATEST DETECTED DEADLOCK  
=====================================
2025-09-02 14:30:15 0x7f8b8c000700

*** (1) TRANSACTION:
TRANSACTION 421757, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 2, OS thread handle 140251209676544, query id 17 localhost root updating

UPDATE accounts SET balance = balance - 100 WHERE id = 1

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 58 page no 3 n bits 72 index PRIMARY of table `test`.`accounts` 
trx id 421757 lock_mode X locks rec but not gap waiting

*** (2) TRANSACTION: 
TRANSACTION 421758, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1  
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 3, OS thread handle 140251209412352, query id 18 localhost root updating

UPDATE accounts SET balance = balance + 100 WHERE id = 2  

*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 58 page no 3 n bits 72 index PRIMARY of table `test`.`accounts`
trx id 421758 lock_mode X locks rec but not gap

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 58 page no 3 n bits 72 index PRIMARY of table `test`.`accounts`
trx id 421758 lock_mode X locks rec but not gap waiting

*** WE ROLL BACK TRANSACTION (2)

åˆ†æç»“æœï¼š
1. äº‹åŠ¡421757æŒæœ‰id=1çš„é”ï¼Œç­‰å¾…id=2çš„é”
2. äº‹åŠ¡421758æŒæœ‰id=2çš„é”ï¼Œç­‰å¾…id=1çš„é”  
3. å½¢æˆå¾ªç¯ç­‰å¾…ï¼ŒMySQLé€‰æ‹©å›æ»šäº‹åŠ¡421758
```

### 7.3 æ­»é”åˆ†æå·¥å…·ä¸æ–¹æ³•


**ğŸ”§ æ­»é”åˆ†æå·¥å…·é›†**
```sql
-- 1. ç³»ç»Ÿè‡ªå¸¦çš„æ­»é”æŸ¥è¯¢
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread,
    b.trx_query blocking_query
FROM information_schema.innodb_lock_waits w
INNER JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;

-- 2. æŸ¥çœ‹å½“å‰æ‰€æœ‰é”ä¿¡æ¯
SELECT 
    lock_id,
    lock_trx_id,
    lock_mode,
    lock_type,
    lock_table,
    lock_index,
    lock_rec
FROM information_schema.innodb_locks;
```

**ğŸ“Š æ­»é”åˆ†ææŠ¥å‘Šç”Ÿæˆè„šæœ¬**
```python
#!/usr/bin/env python3
# deadlock_analyzer.py - æ­»é”æ—¥å¿—åˆ†æå·¥å…·

import re
import sys
from datetime import datetime
from collections import defaultdict

class DeadlockAnalyzer:
    def __init__(self):
        self.deadlock_count = 0
        self.deadlock_tables = defaultdict(int)
        self.deadlock_patterns = defaultdict(int)
        
    def parse_deadlock_log(self, log_content):
        """è§£ææ­»é”æ—¥å¿—"""
        deadlocks = re.findall(
            r'LATEST DETECTED DEADLOCK.*?(?=LATEST DETECTED DEADLOCK|\Z)', 
            log_content, 
            re.DOTALL
        )
        
        for deadlock in deadlocks:
            self.analyze_single_deadlock(deadlock)
            
    def analyze_single_deadlock(self, deadlock_text):
        """åˆ†æå•ä¸ªæ­»é”"""
        self.deadlock_count += 1
        
        # æå–è¡¨å
        tables = re.findall(r'table `(\w+)`.`(\w+)`', deadlock_text)
        for db, table in tables:
            self.deadlock_tables[f"{db}.{table}"] += 1
            
        # æå–SQLæ¨¡å¼
        sqls = re.findall(r'(UPDATE|INSERT|DELETE).*', deadlock_text)
        for sql in sqls:
            sql_type = sql.split()[0]
            self.deadlock_patterns[sql_type] += 1
            
    def generate_report(self):
        """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
        print("="*50)
        print("æ­»é”åˆ†ææŠ¥å‘Š")
        print("="*50)
        print(f"æ€»æ­»é”æ•°é‡: {self.deadlock_count}")
        print()
        
        print("æ¶‰åŠè¡¨ç»Ÿè®¡:")
        for table, count in sorted(self.deadlock_tables.items(), 
                                 key=lambda x: x[1], reverse=True):
            print(f"  {table}: {count}æ¬¡")
        print()
        
        print("SQLç±»å‹ç»Ÿè®¡:")
        for pattern, count in sorted(self.deadlock_patterns.items(),
                                   key=lambda x: x[1], reverse=True):
            print(f"  {pattern}: {count}æ¬¡")
        print()

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 deadlock_analyzer.py <log_file>")
        sys.exit(1)
        
    analyzer = DeadlockAnalyzer()
    
    with open(sys.argv[1], 'r') as f:
        log_content = f.read()
        
    analyzer.parse_deadlock_log(log_content)
    analyzer.generate_report()
```

---

## 8. ğŸ”„ åº”ç”¨å±‚æ­»é”å¤„ç†æ–¹æ¡ˆ


### 8.1 åº”ç”¨å±‚é‡è¯•æœºåˆ¶


**ğŸ”„ æ™ºèƒ½é‡è¯•ç­–ç•¥è®¾è®¡**
```java
@Service
public class DeadlockRetryService {
    
    private static final int MAX_RETRY_ATTEMPTS = 3;
    private static final long BASE_RETRY_DELAY = 100; // æ¯«ç§’
    
    /**
     * å¸¦æ­»é”é‡è¯•çš„æ•°æ®åº“æ“ä½œ
     */
    public <T> T executeWithDeadlockRetry(Supplier<T> operation) {
        int attempts = 0;
        
        while (attempts < MAX_RETRY_ATTEMPTS) {
            try {
                return operation.get();
                
            } catch (DeadlockLoserDataAccessException e) {
                attempts++;
                
                if (attempts >= MAX_RETRY_ATTEMPTS) {
                    throw new ServiceException("æ“ä½œå¤±è´¥ï¼Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°", e);
                }
                
                // æŒ‡æ•°é€€é¿é‡è¯•
                long delay = BASE_RETRY_DELAY * (1L << (attempts - 1));
                
                // æ·»åŠ éšæœºå› å­ï¼Œé¿å…é‡è¯•é£æš´
                delay += (long)(Math.random() * delay * 0.1);
                
                try {
                    Thread.sleep(delay);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new ServiceException("é‡è¯•è¢«ä¸­æ–­", ie);
                }
                
                log.warn("æ£€æµ‹åˆ°æ­»é”ï¼Œç¬¬{}æ¬¡é‡è¯•ï¼Œå»¶è¿Ÿ{}ms", attempts, delay);
            }
        }
        
        throw new ServiceException("ä¸åº”è¯¥æ‰§è¡Œåˆ°è¿™é‡Œ");
    }
}
```

**ğŸ’¡ é‡è¯•ç­–ç•¥çš„åº”ç”¨ç¤ºä¾‹**
```java
@Service
@Transactional
public class TransferService {
    
    @Autowired
    private DeadlockRetryService retryService;
    
    @Autowired
    private AccountRepository accountRepository;
    
    /**
     * é“¶è¡Œè½¬è´¦ä¸šåŠ¡ï¼ˆå¸¦æ­»é”é‡è¯•ï¼‰
     */
    public void transfer(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        retryService.executeWithDeadlockRetry(() -> {
            return doTransfer(fromAccountId, toAccountId, amount);
        });
    }
    
    private Boolean doTransfer(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        // æŒ‰IDé¡ºåºè·å–è´¦æˆ·ï¼Œé¿å…æ­»é”
        Long firstId = Math.min(fromAccountId, toAccountId);
        Long secondId = Math.max(fromAccountId, toAccountId);
        
        Account firstAccount = accountRepository.findByIdForUpdate(firstId);
        Account secondAccount = accountRepository.findByIdForUpdate(secondId);
        
        Account fromAccount = fromAccountId.equals(firstId) ? firstAccount : secondAccount;
        Account toAccount = toAccountId.equals(firstId) ? firstAccount : secondAccount;
        
        // æ£€æŸ¥ä½™é¢
        if (fromAccount.getBalance().compareTo(amount) < 0) {
            throw new InsufficientBalanceException("ä½™é¢ä¸è¶³");
        }
        
        // æ‰§è¡Œè½¬è´¦
        fromAccount.setBalance(fromAccount.getBalance().subtract(amount));
        toAccount.setBalance(toAccount.getBalance().add(amount));
        
        accountRepository.save(fromAccount);
        accountRepository.save(toAccount);
        
        return true;
    }
}
```

### 8.2 åˆ†å¸ƒå¼é”æ›¿ä»£æ–¹æ¡ˆ


**ğŸ” Redisåˆ†å¸ƒå¼é”é¿å…æ•°æ®åº“æ­»é”**
```java
@Service
public class RedisLockService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * ä½¿ç”¨Redisåˆ†å¸ƒå¼é”é¿å…æ•°æ®åº“æ­»é”
     */
    public boolean executeWithDistributedLock(String lockKey, long lockTime, 
                                            TimeUnit timeUnit, Runnable task) {
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean success = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, lockTime, timeUnit);
                
            if (Boolean.TRUE.equals(success)) {
                // è·å–é”æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘
                task.run();
                return true;
            } else {
                log.warn("è·å–åˆ†å¸ƒå¼é”å¤±è´¥: {}", lockKey);
                return false;
            }
            
        } finally {
            // é‡Šæ”¾é”ï¼ˆç¡®ä¿æ˜¯è‡ªå·±æŒæœ‰çš„é”ï¼‰
            releaseLock(lockKey, lockValue);
        }
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "  return redis.call('del', KEYS[1]) " +
            "else " +
            "  return 0 " +
            "end";
            
        redisTemplate.execute(new DefaultRedisScript<>(script, Long.class),
                            Collections.singletonList(lockKey), lockValue);
    }
}
```

### 8.3 å¼‚æ­¥å¤„ç†é¿å…æ­»é”


**ğŸš€ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆ**
```java
@Component
public class AsyncOrderProcessor {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * å¼‚æ­¥å¤„ç†è®¢å•ï¼Œé¿å…å¤šè¡¨é”å†²çª
     */
    public void processOrderAsync(OrderRequest orderRequest) {
        // å°†è®¢å•å¤„ç†æ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œå¼‚æ­¥æ‰§è¡Œ
        
        // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•è®°å½•
        Order order = createOrderRecord(orderRequest);
        
        // æ­¥éª¤2ï¼šå¼‚æ­¥æ‰£å‡åº“å­˜
        InventoryDeductionMessage inventoryMsg = new InventoryDeductionMessage();
        inventoryMsg.setOrderId(order.getId());
        inventoryMsg.setProductItems(orderRequest.getItems());
        
        rabbitTemplate.convertAndSend("inventory.deduction", inventoryMsg);
        
        // æ­¥éª¤3ï¼šå¼‚æ­¥æ‰£å‡ä½™é¢
        PaymentDeductionMessage paymentMsg = new PaymentDeductionMessage();
        paymentMsg.setOrderId(order.getId());
        paymentMsg.setUserId(orderRequest.getUserId());
        paymentMsg.setAmount(orderRequest.getTotalAmount());
        
        rabbitTemplate.convertAndSend("payment.deduction", paymentMsg);
    }
    
    /**
     * åº“å­˜æ‰£å‡æ¶ˆæ¯å¤„ç†
     */
    @RabbitListener(queues = "inventory.deduction")
    public void handleInventoryDeduction(InventoryDeductionMessage message) {
        try {
            // å•ç‹¬çš„äº‹åŠ¡å¤„ç†åº“å­˜æ‰£å‡
            inventoryService.deductStock(message.getProductItems());
            
            // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            orderEventPublisher.publishInventoryDeducted(message.getOrderId());
            
        } catch (InsufficientStockException e) {
            // åº“å­˜ä¸è¶³ï¼Œå‘å¸ƒè®¢å•å¤±è´¥äº‹ä»¶
            orderEventPublisher.publishOrderFailed(message.getOrderId(), "åº“å­˜ä¸è¶³");
        }
    }
    
    /**
     * æ”¯ä»˜æ‰£å‡æ¶ˆæ¯å¤„ç†
     */
    @RabbitListener(queues = "payment.deduction")  
    public void handlePaymentDeduction(PaymentDeductionMessage message) {
        try {
            // å•ç‹¬çš„äº‹åŠ¡å¤„ç†æ”¯ä»˜æ‰£å‡
            paymentService.deductBalance(message.getUserId(), message.getAmount());
            
            // å‘å¸ƒæ”¯ä»˜æ‰£å‡æˆåŠŸäº‹ä»¶
            orderEventPublisher.publishPaymentDeducted(message.getOrderId());
            
        } catch (InsufficientBalanceException e) {
            // ä½™é¢ä¸è¶³ï¼Œå‘å¸ƒè®¢å•å¤±è´¥äº‹ä»¶
            orderEventPublisher.publishOrderFailed(message.getOrderId(), "ä½™é¢ä¸è¶³");
        }
    }
}
```

### 8.4 ä¸šåŠ¡å±‚é¢çš„æ­»é”é¿å…


**ğŸ“‹ ä¸šåŠ¡è§„åˆ™è®¾è®¡é¿å…æ­»é”**
```java
/**
 * é€šè¿‡ä¸šåŠ¡è§„åˆ™è®¾è®¡é¿å…æ­»é”çš„æœ€ä½³å®è·µ
 */
@Service
public class BusinessRuleBasedService {
    
    /**
     * è§„åˆ™1ï¼šç»Ÿä¸€æ“ä½œé¡ºåº
     * æ‰€æœ‰æ¶‰åŠå¤šè´¦æˆ·çš„æ“ä½œéƒ½æŒ‰è´¦æˆ·IDæ’åº
     */
    public void batchTransfer(List<TransferRequest> requests) {
        // æŒ‰è´¦æˆ·IDæ’åºï¼Œç¡®ä¿é”å®šé¡ºåºä¸€è‡´
        requests.sort((r1, r2) -> {
            int compare1 = r1.getFromAccountId().compareTo(r2.getFromAccountId());
            if (compare1 != 0) return compare1;
            return r1.getToAccountId().compareTo(r2.getToAccountId());
        });
        
        for (TransferRequest request : requests) {
            doTransfer(request.getFromAccountId(), 
                      request.getToAccountId(), 
                      request.getAmount());
        }
    }
    
    /**
     * è§„åˆ™2ï¼šå‡å°‘é”çš„æŒæœ‰æ—¶é—´
     * é¢„å…ˆè®¡ç®—ï¼Œå¿«é€Ÿæ‰§è¡Œ
     */
    @Transactional
    public void optimizedBatchUpdate(List<AccountUpdate> updates) {
        // é¢„å…ˆéªŒè¯æ‰€æœ‰æ•°æ®
        validateAllUpdates(updates);
        
        // é¢„å…ˆè®¡ç®—æ‰€æœ‰ç»“æœ
        Map<Long, BigDecimal> balanceChanges = calculateBalanceChanges(updates);
        
        // å¿«é€Ÿæ‰§è¡Œæ•°æ®åº“æ›´æ–°
        for (Map.Entry<Long, BigDecimal> entry : balanceChanges.entrySet()) {
            accountRepository.updateBalance(entry.getKey(), entry.getValue());
        }
    }
    
    /**
     * è§„åˆ™3ï¼šä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”
     */
    @Retryable(value = OptimisticLockException.class, maxAttempts = 3)
    public void updateWithOptimisticLock(Long accountId, BigDecimal amount) {
        Account account = accountRepository.findById(accountId);
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        account.setBalance(account.getBalance().add(amount));
        
        // ä¹è§‚é”æ›´æ–°ï¼ˆç‰ˆæœ¬å·æœºåˆ¶ï¼‰
        int updateCount = accountRepository.updateWithVersion(account);
        
        if (updateCount == 0) {
            throw new OptimisticLockException("æ•°æ®å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹ï¼Œè¯·é‡è¯•");
        }
    }
    
    /**
     * è§„åˆ™4ï¼šç¼©å°äº‹åŠ¡èŒƒå›´
     */
    public void processLargeDataset(List<DataItem> items) {
        // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡
        int batchSize = 100;
        
        for (int i = 0; i < items.size(); i += batchSize) {
            List<DataItem> batch = items.subList(i, 
                Math.min(i + batchSize, items.size()));
            
            processBatchInTransaction(batch);
        }
    }
    
    @Transactional
    public void processBatchInTransaction(List<DataItem> batch) {
        // å°æ‰¹é‡äº‹åŠ¡å¤„ç†
        for (DataItem item : batch) {
            processItem(item);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ­»é”æœ¬è´¨çš„æ·±å…¥ç†è§£**
```
æ­»é” = å¾ªç¯ç­‰å¾… + èµ„æºç«äº‰
â€¢ ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡ç›¸äº’ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æº
â€¢ å½¢æˆå¾ªç¯ä¾èµ–ï¼Œæ— æ³•è‡ªåŠ¨è§£é™¤
â€¢ MySQLé€šè¿‡æ­»é”æ£€æµ‹ç®—æ³•ä¸»åŠ¨å‘ç°å’Œå¤„ç†
â€¢ æ­»é”æ˜¯å¹¶å‘ç³»ç»Ÿä¸­ä¸å¯å®Œå…¨é¿å…çš„é—®é¢˜
```

**ğŸ”¸ æ­»é”æ£€æµ‹æœºåˆ¶çš„å·¥ä½œåŸç†**
```
wait-forå›¾ç®—æ³•ï¼š
â€¢ æ„å»ºäº‹åŠ¡ç­‰å¾…å…³ç³»çš„æœ‰å‘å›¾
â€¢ æ£€æµ‹å›¾ä¸­æ˜¯å¦å­˜åœ¨ç¯è·¯
â€¢ ç¯è·¯çš„å­˜åœ¨è¡¨æ˜å‘ç”Ÿäº†æ­»é”
â€¢ é€‰æ‹©"ä»£ä»·æœ€å°"çš„äº‹åŠ¡ä½œä¸ºå—å®³è€…å›æ»š

æ£€æµ‹é¢‘ç‡å’Œå¼€é”€ï¼š
â€¢ é«˜å¹¶å‘æ—¶æ£€æµ‹å¼€é”€æ˜¾è‘—
â€¢ å¯é€šè¿‡é…ç½®å‚æ•°è¿›è¡Œè°ƒä¼˜
â€¢ å…³é—­æ£€æµ‹åˆ™ä¾èµ–è¶…æ—¶æœºåˆ¶
```

### 9.2 å„ç±»DMLæ­»é”çš„å…³é”®ç†è§£


**ğŸ”¹ INSERTæ­»é”çš„ç‰¹æ®Šæ€§**
```
INSERTæ­»é”çš„ä¸»è¦åŸå› ï¼š
â€¢ å”¯ä¸€ç´¢å¼•å†²çªå¯¼è‡´çš„é”ç­‰å¾…
â€¢ è‡ªå¢ä¸»é”®çš„é”ç«äº‰
â€¢ å¤–é”®çº¦æŸæ£€æŸ¥çš„é”å†²çª

é¢„é˜²ç­–ç•¥ï¼š
â€¢ æ‰¹é‡æ’å…¥æ›¿ä»£é€æ¡æ’å…¥
â€¢ åˆç†è®¾è®¡å”¯ä¸€ç´¢å¼•
â€¢ é¿å…å¤æ‚çš„å¤–é”®å…³ç³»
```

**ğŸ”¹ UPDATEæ­»é”çš„å¤æ‚æ€§**
```
UPDATEæ­»é”çš„å¸¸è§åœºæ™¯ï¼š
â€¢ ä¸åŒé¡ºåºæ›´æ–°ç›¸åŒè®°å½•é›†åˆ
â€¢ èŒƒå›´æ›´æ–°æ—¶çš„é”èŒƒå›´é‡å 
â€¢ ç´¢å¼•æ¡ä»¶å¯¼è‡´çš„é”å‡çº§

å…³é”®é¢„é˜²ç‚¹ï¼š
â€¢ ç»Ÿä¸€è®°å½•è®¿é—®é¡ºåºï¼ˆæŒ‰ä¸»é”®ï¼‰
â€¢ ç¼©å°æ›´æ–°èŒƒå›´å’Œé”æŒæœ‰æ—¶é—´
â€¢ ä½¿ç”¨ä¹è§‚é”æœºåˆ¶
```

**ğŸ”¹ DELETEæ­»é”çš„å±é™©æ€§**
```
DELETEæ“ä½œçš„é”å®šç‰¹ç‚¹ï¼š
â€¢ å¯èƒ½æ¶‰åŠå¤šä¸ªç´¢å¼•çš„é”å®š
â€¢ å¤§æ‰¹é‡åˆ é™¤æ—¶é”å®šèŒƒå›´å¹¿
â€¢ çº§è”åˆ é™¤å¢åŠ å¤æ‚æ€§

å®‰å…¨åˆ é™¤ç­–ç•¥ï¼š
â€¢ åˆ†æ‰¹åˆ é™¤ï¼Œæ§åˆ¶é”å®šèŒƒå›´
â€¢ æ˜ç¡®åˆ é™¤é¡ºåºï¼Œé¿å…çº§è”å†²çª
â€¢ åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œå¤§æ‰¹é‡åˆ é™¤
```

### 9.3 æ­»é”å¤„ç†çš„æœ€ä½³å®è·µ


**ğŸ›¡ï¸ é¢„é˜²ä¼˜äºæ²»ç–—çš„åŸåˆ™**
```
è®¾è®¡å±‚é¢é¢„é˜²ï¼š
â€¢ ç»Ÿä¸€èµ„æºè®¿é—®é¡ºåº
â€¢ ç¼©çŸ­äº‹åŠ¡æ‰§è¡Œæ—¶é—´
â€¢ é™ä½é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´
â€¢ åˆç†é€‰æ‹©éš”ç¦»çº§åˆ«

ä»£ç å±‚é¢å®ç°ï¼š
â€¢ æŒ‰ä¸»é”®æ’åºè¿›è¡Œæ‰¹é‡æ“ä½œ
â€¢ ä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”
â€¢ å®ç°é‡è¯•æœºåˆ¶å¤„ç†æ­»é”å¼‚å¸¸
â€¢ å¼‚æ­¥åŒ–å¤„ç†å‡å°‘é”ç«äº‰
```

**ğŸ“Š ç›‘æ§å’Œåˆ†æçš„é‡è¦æ€§**
```
ç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼š
â€¢ æ­»é”å‘ç”Ÿé¢‘ç‡å’Œè¶‹åŠ¿
â€¢ æ¶‰åŠçš„è¡¨å’ŒSQLæ¨¡å¼
â€¢ æ­»é”æŒç»­æ—¶é—´å’Œå½±å“èŒƒå›´

æ—¥å¿—åˆ†æä»·å€¼ï¼š
â€¢ è¯†åˆ«æ­»é”çƒ­ç‚¹è¡¨å’Œæ“ä½œ
â€¢ å‘ç°åº”ç”¨å±‚é¢çš„è®¾è®¡é—®é¢˜
â€¢ æŒ‡å¯¼æ•°æ®åº“å’Œåº”ç”¨ä¼˜åŒ–æ–¹å‘
```

### 9.4 åº”ç”¨å±‚é¢çš„ç»¼åˆå¤„ç†ç­–ç•¥


**ğŸ”„ å¤šå±‚æ¬¡çš„æ­»é”å¤„ç†æ–¹æ¡ˆ**
```
ç¬¬ä¸€å±‚ï¼šé¢„é˜²æœºåˆ¶
â€¢ è®¾è®¡è§„èŒƒï¼šç»Ÿä¸€è®¿é—®é¡ºåº
â€¢ ä»£ç è§„èŒƒï¼šäº‹åŠ¡èŒƒå›´æ§åˆ¶
â€¢ æ¶æ„è®¾è®¡ï¼šæœåŠ¡æ‹†åˆ†å’Œå¼‚æ­¥åŒ–

ç¬¬äºŒå±‚ï¼šæ£€æµ‹å’Œå¿«é€Ÿæ¢å¤
â€¢ æ­»é”æ£€æµ‹ï¼šå¿«é€Ÿå‘ç°é—®é¢˜
â€¢ è‡ªåŠ¨é‡è¯•ï¼šæ™ºèƒ½é‡è¯•ç­–ç•¥
â€¢ é™çº§å¤„ç†ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½

ç¬¬ä¸‰å±‚ï¼šç›‘æ§å’ŒæŒç»­ä¼˜åŒ–
â€¢ å®æ—¶ç›‘æ§ï¼šæ­»é”è¶‹åŠ¿åˆ†æ
â€¢ å®šæœŸåˆ†æï¼šæ€§èƒ½ç“¶é¢ˆè¯†åˆ«
â€¢ æŒç»­æ”¹è¿›ï¼šåŸºäºæ•°æ®çš„ä¼˜åŒ–
```

### 9.5 å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®


**ğŸ¯ é…ç½®ä¼˜åŒ–å»ºè®®**
```
æ­»é”æ£€æµ‹é…ç½®ï¼š
â€¢ é«˜å¹¶å‘ç³»ç»Ÿï¼šè€ƒè™‘å…³é—­æ£€æµ‹ï¼Œä¾èµ–è¶…æ—¶
â€¢ æ™®é€šç³»ç»Ÿï¼šä¿æŒæ£€æµ‹å¼€å¯ï¼Œå¿«é€Ÿå¤„ç†
â€¢ è¶…æ—¶æ—¶é—´ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹æ€§åˆç†è®¾ç½®

éš”ç¦»çº§åˆ«é€‰æ‹©ï¼š
â€¢ READ COMMITTEDï¼šå‡å°‘é”å†²çª
â€¢ REPEATABLE READï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
â€¢ æ ¹æ®ä¸šåŠ¡éœ€æ±‚æƒè¡¡é€‰æ‹©
```

**ğŸ“ˆ æ€§èƒ½ä¸ç¨³å®šæ€§å¹³è¡¡**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ æ­»é”æ£€æµ‹å…³é—­å¯æå‡5-15%æ€§èƒ½
â€¢ ä½†éœ€è¦ä¾èµ–è¶…æ—¶æœºåˆ¶ï¼Œå“åº”å˜æ…¢
â€¢ é«˜å¹¶å‘åœºæ™¯ä¸‹è€ƒè™‘æ€§èƒ½æ”¶ç›Š

ç¨³å®šæ€§ä¿éšœï¼š
â€¢ å®Œå–„çš„é‡è¯•æœºåˆ¶
â€¢ ç›‘æ§å‘Šè­¦ä½“ç³»
â€¢ åº”æ€¥å¤„ç†é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ­»é”æ˜¯å¹¶å‘çš„å¿…ç„¶ä»£ä»·ï¼Œé¢„é˜²èƒœäºå¤„ç†
- ç»Ÿä¸€è®¿é—®é¡ºåºæ˜¯é¢„é˜²æ­»é”çš„é»„é‡‘æ³•åˆ™
- wait-forå›¾æ˜¯ç†è§£æ­»é”æ£€æµ‹çš„æ ¸å¿ƒç®—æ³•
- åº”ç”¨å±‚é‡è¯•æœºåˆ¶æ˜¯æ­»é”å¤„ç†çš„æœ€åä¸€é“é˜²çº¿
- ç›‘æ§åˆ†ææ˜¯æŒç»­ä¼˜åŒ–çš„æ•°æ®åŸºç¡€