---
title: 7ã€CASE WHENæ¡ä»¶æ›´æ–°è¡¨è¾¾å¼
---
## ğŸ“š ç›®å½•

1. [CASE WHENåŸºç¡€æ¦‚å¿µ](#1-CASE-WHENåŸºç¡€æ¦‚å¿µ)
2. [ç®€å•CASEè¡¨è¾¾å¼](#2-ç®€å•CASEè¡¨è¾¾å¼)
3. [æœç´¢CASEè¡¨è¾¾å¼](#3-æœç´¢CASEè¡¨è¾¾å¼)
4. [å¤æ‚æ¡ä»¶æ›´æ–°åœºæ™¯](#4-å¤æ‚æ¡ä»¶æ›´æ–°åœºæ™¯)
5. [å¤šæ¡ä»¶åˆ†æ”¯å¤„ç†](#5-å¤šæ¡ä»¶åˆ†æ”¯å¤„ç†)
6. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#6-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
7. [æœ€ä½³å®è·µæŒ‡å—](#7-æœ€ä½³å®è·µæŒ‡å—)
8. [å¸¸è§é—®é¢˜è§£å†³](#8-å¸¸è§é—®é¢˜è§£å†³)
9. [å®é™…åº”ç”¨æ¡ˆä¾‹](#9-å®é™…åº”ç”¨æ¡ˆä¾‹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”¸ CASE WHENåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯CASE WHENè¡¨è¾¾å¼


**ç®€å•ç†è§£**ï¼šCASE WHENå°±åƒç¼–ç¨‹è¯­è¨€ä¸­çš„`if-else`è¯­å¥ï¼Œè®©ä½ èƒ½å¤Ÿåœ¨SQLä¸­å®ç°æ¡ä»¶åˆ¤æ–­é€»è¾‘ã€‚

```
ä¼ ç»Ÿæ€ç»´ï¼šéœ€è¦å¤šæ¡UPDATEè¯­å¥
UPDATE users SET status = 'VIP' WHERE points > 1000;
UPDATE users SET status = 'Premium' WHERE points BETWEEN 500 AND 1000;
UPDATE users SET status = 'Normal' WHERE points < 500;

CASE WHENæ€ç»´ï¼šä¸€æ¡è¯­å¥æå®š
UPDATE users SET status = CASE 
    WHEN points > 1000 THEN 'VIP'
    WHEN points >= 500 THEN 'Premium' 
    ELSE 'Normal'
END;
```

### 1.2 CASEè¡¨è¾¾å¼çš„ä¸¤ç§å½¢å¼


**å½¢å¼å¯¹æ¯”**ï¼š
```
ç®€å•CASEè¡¨è¾¾å¼ï¼š
CASE å­—æ®µå
    WHEN å€¼1 THEN ç»“æœ1
    WHEN å€¼2 THEN ç»“æœ2
    ELSE é»˜è®¤ç»“æœ
END

æœç´¢CASEè¡¨è¾¾å¼ï¼š
CASE 
    WHEN æ¡ä»¶1 THEN ç»“æœ1
    WHEN æ¡ä»¶2 THEN ç»“æœ2
    ELSE é»˜è®¤ç»“æœ
END
```

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šæœç´¢CASEè¡¨è¾¾å¼æ›´çµæ´»ï¼Œå¯ä»¥ä½¿ç”¨å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ï¼Œå®é™…ä½¿ç”¨ä¸­æ›´å¸¸è§ã€‚

### 1.3 CASE WHENåœ¨UPDATEä¸­çš„ä½œç”¨


**æ ¸å¿ƒä»·å€¼**ï¼š
- **å‡å°‘SQLè¯­å¥æ•°é‡**ï¼šä¸€æ¡è¯­å¥ä»£æ›¿å¤šæ¡UPDATE
- **ä¿è¯æ•°æ®ä¸€è‡´æ€§**ï¼šé¿å…å¤šæ¬¡æ›´æ–°çš„äº‹åŠ¡é£é™©
- **æé«˜æ‰§è¡Œæ•ˆç‡**ï¼šå‡å°‘è¡¨æ‰«ææ¬¡æ•°
- **ç®€åŒ–ä¸šåŠ¡é€»è¾‘**ï¼šæ¡ä»¶é€»è¾‘æ›´æ¸…æ™°æ˜“æ‡‚

**æ‰§è¡Œæµç¨‹ç¤ºæ„**ï¼š
```
UPDATEæ‰§è¡Œæµç¨‹ï¼š
è¡¨æ‰«æ â†’ é€è¡Œå¤„ç† â†’ CASEæ¡ä»¶åˆ¤æ–­ â†’ è®¡ç®—æ–°å€¼ â†’ æ›´æ–°è®°å½•

ä¼ ç»Ÿæ–¹å¼ï¼š
è¡¨æ‰«æ1 â†’ æ›´æ–°éƒ¨åˆ†è®°å½• â†’ è¡¨æ‰«æ2 â†’ æ›´æ–°éƒ¨åˆ†è®°å½• â†’ è¡¨æ‰«æ3 â†’ æ›´æ–°éƒ¨åˆ†è®°å½•

CASE WHENæ–¹å¼ï¼š
è¡¨æ‰«æ1 â†’ ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è®°å½•çš„æ¡ä»¶åˆ¤æ–­å’Œæ›´æ–°
```

---

## 2. ğŸ”¤ ç®€å•CASEè¡¨è¾¾å¼


### 2.1 ç®€å•CASEè¯­æ³•ç»“æ„


**åŸºæœ¬è¯­æ³•**ï¼š
```sql
UPDATE è¡¨å 
SET å­—æ®µå = CASE åˆ¤æ–­å­—æ®µ
    WHEN å€¼1 THEN ç»“æœ1
    WHEN å€¼2 THEN ç»“æœ2
    [WHEN å€¼N THEN ç»“æœN]
    [ELSE é»˜è®¤ç»“æœ]
END
[WHERE æ¡ä»¶];
```

### 2.2 åŸºç¡€åº”ç”¨ç¤ºä¾‹


**ç¤ºä¾‹1ï¼šçŠ¶æ€ç è½¬æ¢**
```sql
-- å°†æ•°å­—çŠ¶æ€ç è½¬æ¢ä¸ºæ–‡å­—æè¿°
UPDATE orders 
SET status_desc = CASE status
    WHEN 1 THEN 'å¾…ä»˜æ¬¾'
    WHEN 2 THEN 'å·²ä»˜æ¬¾'
    WHEN 3 THEN 'å·²å‘è´§'
    WHEN 4 THEN 'å·²å®Œæˆ'
    WHEN 5 THEN 'å·²å–æ¶ˆ'
    ELSE 'æœªçŸ¥çŠ¶æ€'
END;
```

**ç¤ºä¾‹2ï¼šç­‰çº§è°ƒæ•´**
```sql
-- æ ¹æ®ç”¨æˆ·ç±»å‹è°ƒæ•´æŠ˜æ‰£
UPDATE customers 
SET discount_rate = CASE user_type
    WHEN 'VIP' THEN 0.8      -- VIPç”¨æˆ·8æŠ˜
    WHEN 'Gold' THEN 0.85    -- é‡‘ç‰Œç”¨æˆ·85æŠ˜
    WHEN 'Silver' THEN 0.9   -- é“¶ç‰Œç”¨æˆ·9æŠ˜
    WHEN 'Bronze' THEN 0.95  -- é“œç‰Œç”¨æˆ·95æŠ˜
    ELSE 1.0                 -- æ™®é€šç”¨æˆ·åŸä»·
END
WHERE user_type IS NOT NULL;
```

### 2.3 ç®€å•CASEçš„é€‚ç”¨åœºæ™¯


```
âœ… é€‚ç”¨åœºæ™¯ï¼š
â”œâ”€ çŠ¶æ€ç æ˜ å°„ï¼šæ•°å­—ç  â†’ æ–‡å­—æè¿°
â”œâ”€ ç±»åˆ«è½¬æ¢ï¼šåˆ†ç±»ä»£ç  â†’ åˆ†ç±»åç§°
â”œâ”€ ç­‰çº§è°ƒæ•´ï¼šç”¨æˆ·çº§åˆ« â†’ å¯¹åº”æƒç›Š
â””â”€ å›ºå®šæ˜ å°„ï¼šæœ‰é™çš„å€¼æ˜ å°„å…³ç³»

âŒ ä¸é€‚ç”¨åœºæ™¯ï¼š
â”œâ”€ èŒƒå›´åˆ¤æ–­ï¼šéœ€è¦ä½¿ç”¨ > < BETWEEN ç­‰
â”œâ”€ å¤æ‚æ¡ä»¶ï¼šå¤šå­—æ®µç»„åˆåˆ¤æ–­
â”œâ”€ NULLå€¼å¤„ç†ï¼šNULL = NULL ç»“æœä¸ºNULL
â””â”€ æ¨¡ç³ŠåŒ¹é…ï¼šLIKE æ¨¡å¼åŒ¹é…
```

---

## 3. ğŸ” æœç´¢CASEè¡¨è¾¾å¼


### 3.1 æœç´¢CASEè¯­æ³•ç»“æ„


**åŸºæœ¬è¯­æ³•**ï¼š
```sql
UPDATE è¡¨å
SET å­—æ®µå = CASE
    WHEN æ¡ä»¶1 THEN ç»“æœ1
    WHEN æ¡ä»¶2 THEN ç»“æœ2
    [WHEN æ¡ä»¶N THEN ç»“æœN]
    [ELSE é»˜è®¤ç»“æœ]
END
[WHERE æ¡ä»¶];
```

### 3.2 èŒƒå›´æ¡ä»¶æ›´æ–°


**ç¤ºä¾‹1ï¼šæ ¹æ®åˆ†æ•°åˆ’åˆ†ç­‰çº§**
```sql
-- æ ¹æ®è€ƒè¯•åˆ†æ•°æ›´æ–°ç­‰çº§
UPDATE students 
SET grade = CASE
    WHEN score >= 90 THEN 'A'
    WHEN score >= 80 THEN 'B'  
    WHEN score >= 70 THEN 'C'
    WHEN score >= 60 THEN 'D'
    ELSE 'F'
END
WHERE score IS NOT NULL;
```

**ç¤ºä¾‹2ï¼šè–ªèµ„è°ƒæ•´ç­–ç•¥**
```sql
-- æ ¹æ®å·¥ä½œå¹´é™å’Œç»©æ•ˆè°ƒæ•´è–ªèµ„
UPDATE employees 
SET salary = salary * CASE
    WHEN years_of_service >= 10 AND performance = 'Excellent' THEN 1.15  -- èµ„æ·±ä¼˜ç§€å‘˜å·¥æ¶¨15%
    WHEN years_of_service >= 5 AND performance = 'Good' THEN 1.10        -- ç»éªŒä¸°å¯Œå‘˜å·¥æ¶¨10%
    WHEN years_of_service >= 2 AND performance = 'Average' THEN 1.05     -- æ™®é€šå‘˜å·¥æ¶¨5%
    WHEN performance = 'Poor' THEN 0.95                                  -- è¡¨ç°å·®çš„é™5%
    ELSE 1.0                                                             -- å…¶ä»–æƒ…å†µä¸å˜
END
WHERE department = 'Engineering';
```

### 3.3 å¤šå­—æ®µæ¡ä»¶åˆ¤æ–­


**å¤æ‚æ¡ä»¶ç»„åˆç¤ºä¾‹**ï¼š
```sql
-- æ ¹æ®åº“å­˜å’Œé”€é‡è°ƒæ•´å•†å“ä»·æ ¼ç­–ç•¥
UPDATE products 
SET price_strategy = CASE
    -- é«˜åº“å­˜ä½é”€é‡ï¼šé™ä»·ä¿ƒé”€
    WHEN stock_quantity > 1000 AND monthly_sales < 50 THEN 'discount'
    
    -- ä½åº“å­˜é«˜é”€é‡ï¼šæ¶¨ä»·æ§é‡
    WHEN stock_quantity < 100 AND monthly_sales > 500 THEN 'premium'
    
    -- åº“å­˜é€‚ä¸­é”€é‡å¥½ï¼šç»´æŒç°ä»·
    WHEN stock_quantity BETWEEN 100 AND 500 AND monthly_sales > 100 THEN 'maintain'
    
    -- æ–°å“ï¼ˆä¸Šæ¶å°‘äº30å¤©ï¼‰ï¼šæ–°å“ä»·æ ¼
    WHEN DATEDIFF(NOW(), created_date) < 30 THEN 'new_product'
    
    -- æ»é”€å“ï¼ˆ90å¤©æ— é”€é‡ï¼‰ï¼šæ¸…ä»“ä»·æ ¼
    WHEN last_sale_date < DATE_SUB(NOW(), INTERVAL 90 DAY) THEN 'clearance'
    
    ELSE 'normal'
END;
```

### 3.4 æ¡ä»¶è¡¨è¾¾å¼ä¸­çš„å‡½æ•°ä½¿ç”¨


**æ—¥æœŸå‡½æ•°æ¡ä»¶**ï¼š
```sql
-- æ ¹æ®è®¢å•æ—¶é—´è°ƒæ•´å¤„ç†ä¼˜å…ˆçº§
UPDATE orders 
SET priority = CASE
    -- ä»Šæ—¥è®¢å•ï¼šé«˜ä¼˜å…ˆçº§
    WHEN DATE(order_date) = CURDATE() THEN 'high'
    
    -- æ˜¨æ—¥è®¢å•ï¼šä¸­ç­‰ä¼˜å…ˆçº§  
    WHEN DATE(order_date) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN 'medium'
    
    -- æœ¬å‘¨è®¢å•ï¼šæ­£å¸¸ä¼˜å…ˆçº§
    WHEN order_date >= DATE_SUB(CURDATE(), INTERVAL 1 WEEK) THEN 'normal'
    
    -- è¶…è¿‡ä¸€å‘¨ï¼šä½ä¼˜å…ˆçº§
    ELSE 'low'
END
WHERE status = 'pending';
```

**å­—ç¬¦ä¸²å‡½æ•°æ¡ä»¶**ï¼š
```sql
-- æ ¹æ®é‚®ç®±åŸŸåè®¾ç½®ç”¨æˆ·ç±»å‹
UPDATE users 
SET user_category = CASE
    WHEN email LIKE '%@company.com' THEN 'internal'     -- å†…éƒ¨å‘˜å·¥
    WHEN email LIKE '%@gmail.com' OR email LIKE '%@qq.com' THEN 'personal'  -- ä¸ªäººç”¨æˆ·
    WHEN email LIKE '%@edu.cn' OR email LIKE '%@university.edu' THEN 'student'  -- å­¦ç”Ÿç”¨æˆ·
    WHEN LENGTH(email) - LENGTH(REPLACE(email, '@', '')) > 1 THEN 'invalid'  -- å¤šä¸ª@ç¬¦å·
    ELSE 'business'  -- ä¼ä¸šç”¨æˆ·
END
WHERE email IS NOT NULL;
```

---

## 4. ğŸ¯ å¤æ‚æ¡ä»¶æ›´æ–°åœºæ™¯


### 4.1 åµŒå¥—CASEè¡¨è¾¾å¼


**å¤šå±‚æ¡ä»¶åˆ¤æ–­**ï¼š
```sql
-- æ ¹æ®ç”¨æˆ·ç­‰çº§å’Œè®¢å•é‡‘é¢è®¡ç®—ç§¯åˆ†
UPDATE orders 
SET reward_points = CASE customer_level
    WHEN 'VIP' THEN 
        CASE 
            WHEN order_amount >= 1000 THEN order_amount * 0.05  -- VIPå¤§é¢è®¢å•5%ç§¯åˆ†
            WHEN order_amount >= 500 THEN order_amount * 0.03   -- VIPä¸­é¢è®¢å•3%ç§¯åˆ†
            ELSE order_amount * 0.02                            -- VIPå°é¢è®¢å•2%ç§¯åˆ†
        END
    WHEN 'Gold' THEN
        CASE
            WHEN order_amount >= 500 THEN order_amount * 0.03   -- Goldå¤§é¢è®¢å•3%ç§¯åˆ†
            ELSE order_amount * 0.015                           -- Goldæ™®é€šè®¢å•1.5%ç§¯åˆ†
        END
    ELSE 
        CASE
            WHEN order_amount >= 200 THEN order_amount * 0.01   -- æ™®é€šç”¨æˆ·å¤§é¢è®¢å•1%ç§¯åˆ†
            ELSE order_amount * 0.005                           -- æ™®é€šç”¨æˆ·å°é¢è®¢å•0.5%ç§¯åˆ†
        END
END;
```

> âš ï¸ **æ³¨æ„**ï¼šåµŒå¥—CASEè™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†ä¼šé™ä½å¯è¯»æ€§ã€‚å»ºè®®åµŒå¥—å±‚æ¬¡ä¸è¶…è¿‡2å±‚ï¼Œå¤æ‚é€»è¾‘å¯è€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤ã€‚

### 4.2 CASEä¸èšåˆå‡½æ•°ç»“åˆ


**æ¡ä»¶èšåˆæ›´æ–°**ï¼š
```sql
-- æ›´æ–°éƒ¨é—¨ç»Ÿè®¡ä¿¡æ¯
UPDATE departments d
SET 
    total_employees = (
        SELECT COUNT(*) FROM employees e WHERE e.dept_id = d.id
    ),
    avg_salary = (
        SELECT AVG(salary) FROM employees e WHERE e.dept_id = d.id
    ),
    performance_bonus = CASE
        WHEN (SELECT AVG(performance_score) FROM employees e WHERE e.dept_id = d.id) >= 90 THEN 50000
        WHEN (SELECT AVG(performance_score) FROM employees e WHERE e.dept_id = d.id) >= 80 THEN 30000
        WHEN (SELECT AVG(performance_score) FROM employees e WHERE e.dept_id = d.id) >= 70 THEN 10000
        ELSE 0
    END;
```

### 4.3 CASEä¸å­æŸ¥è¯¢ç»“åˆ


**åŠ¨æ€æ¡ä»¶æŸ¥è¯¢**ï¼š
```sql
-- æ ¹æ®å†å²è´­ä¹°è®°å½•æ›´æ–°å®¢æˆ·æ¨èç±»åˆ«
UPDATE customers c
SET recommended_category = CASE
    WHEN (
        SELECT COUNT(*) FROM orders o 
        JOIN order_items oi ON o.id = oi.order_id 
        JOIN products p ON oi.product_id = p.id 
        WHERE o.customer_id = c.id AND p.category = 'Electronics'
    ) >= 5 THEN 'Electronics'
    
    WHEN (
        SELECT SUM(oi.quantity * oi.price) FROM orders o 
        JOIN order_items oi ON o.id = oi.order_id 
        JOIN products p ON oi.product_id = p.id 
        WHERE o.customer_id = c.id AND p.category = 'Books'
    ) >= 1000 THEN 'Books'
    
    WHEN (
        SELECT COUNT(DISTINCT p.category) FROM orders o 
        JOIN order_items oi ON o.id = oi.order_id 
        JOIN products p ON oi.product_id = p.id 
        WHERE o.customer_id = c.id
    ) >= 5 THEN 'Mixed'
    
    ELSE 'General'
END;
```

---

## 5. ğŸ”€ å¤šæ¡ä»¶åˆ†æ”¯å¤„ç†


### 5.1 å¤šå­—æ®µåŒæ—¶æ›´æ–°


**åŒæ—¶æ›´æ–°å¤šä¸ªå­—æ®µ**ï¼š
```sql
-- æ ¹æ®å‘˜å·¥ç»©æ•ˆåŒæ—¶æ›´æ–°å¤šä¸ªå­—æ®µ
UPDATE employees 
SET 
    salary = CASE
        WHEN performance_score >= 95 THEN salary * 1.2   -- ä¼˜ç§€å‘˜å·¥æ¶¨20%
        WHEN performance_score >= 85 THEN salary * 1.1   -- è‰¯å¥½å‘˜å·¥æ¶¨10%
        WHEN performance_score >= 70 THEN salary * 1.05  -- åˆæ ¼å‘˜å·¥æ¶¨5%
        ELSE salary                                       -- å…¶ä»–ä¸å˜
    END,
    
    bonus = CASE
        WHEN performance_score >= 95 THEN salary * 2     -- ä¼˜ç§€å‘˜å·¥2ä¸ªæœˆå¥–é‡‘
        WHEN performance_score >= 85 THEN salary * 1     -- è‰¯å¥½å‘˜å·¥1ä¸ªæœˆå¥–é‡‘
        WHEN performance_score >= 70 THEN salary * 0.5   -- åˆæ ¼å‘˜å·¥åŠä¸ªæœˆå¥–é‡‘
        ELSE 0                                            -- å…¶ä»–æ— å¥–é‡‘
    END,
    
    promotion_eligible = CASE
        WHEN performance_score >= 90 AND years_of_service >= 2 THEN 'Yes'
        WHEN performance_score >= 85 AND years_of_service >= 3 THEN 'Yes' 
        ELSE 'No'
    END,
    
    next_review_date = CASE
        WHEN performance_score >= 85 THEN DATE_ADD(CURDATE(), INTERVAL 12 MONTH)  -- ä¼˜ç§€å‘˜å·¥ä¸€å¹´åè¯„ä¼°
        WHEN performance_score >= 70 THEN DATE_ADD(CURDATE(), INTERVAL 6 MONTH)   -- æ™®é€šå‘˜å·¥åŠå¹´åè¯„ä¼°
        ELSE DATE_ADD(CURDATE(), INTERVAL 3 MONTH)                                -- è¡¨ç°å·®çš„3ä¸ªæœˆåè¯„ä¼°
    END;
```

### 5.2 æ¡ä»¶äº’æ–¥å¤„ç†


**ç¡®ä¿æ¡ä»¶äº’æ–¥æ€§**ï¼š
```sql
-- å¤„ç†è®¢å•çŠ¶æ€æµè½¬ï¼ˆç¡®ä¿çŠ¶æ€å˜æ›´çš„é€»è¾‘æ€§ï¼‰
UPDATE orders 
SET 
    status = CASE 
        -- å·²å–æ¶ˆçš„è®¢å•ä¸èƒ½å†å˜æ›´çŠ¶æ€
        WHEN current_status = 'cancelled' THEN 'cancelled'
        
        -- å·²å®Œæˆçš„è®¢å•ä¸èƒ½å†å˜æ›´çŠ¶æ€  
        WHEN current_status = 'completed' THEN 'completed'
        
        -- å·²å‘è´§çš„è®¢å•ï¼Œå¦‚æœè¶…è¿‡7å¤©è‡ªåŠ¨å®Œæˆ
        WHEN current_status = 'shipped' AND 
             DATEDIFF(NOW(), shipped_date) >= 7 THEN 'completed'
             
        -- å·²ä»˜æ¬¾è¶…è¿‡24å°æ—¶è‡ªåŠ¨å‘è´§
        WHEN current_status = 'paid' AND 
             DATEDIFF(NOW(), paid_date) >= 1 THEN 'shipped'
             
        -- å¾…ä»˜æ¬¾è¶…è¿‡72å°æ—¶è‡ªåŠ¨å–æ¶ˆ
        WHEN current_status = 'pending' AND 
             DATEDIFF(NOW(), created_date) >= 3 THEN 'cancelled'
             
        ELSE current_status  -- å…¶ä»–æƒ…å†µä¿æŒåŸçŠ¶æ€
    END,
    
    updated_date = NOW();
```

### 5.3 æ¡ä»¶ä¼˜å…ˆçº§å¤„ç†


**æŒ‰ä¼˜å…ˆçº§é¡ºåºå¤„ç†æ¡ä»¶**ï¼š
```sql
-- å•†å“å®šä»·ç­–ç•¥ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºåº”ç”¨è§„åˆ™ï¼‰
UPDATE products 
SET 
    final_price = CASE
        -- ä¼˜å…ˆçº§1ï¼šæ¸…ä»“å•†å“ï¼ˆåº“å­˜ç§¯å‹è¶…è¿‡6ä¸ªæœˆï¼‰
        WHEN last_sale_date < DATE_SUB(NOW(), INTERVAL 6 MONTH) 
             AND stock_quantity > 100 THEN original_price * 0.3
        
        -- ä¼˜å…ˆçº§2ï¼šä¿ƒé”€å•†å“ï¼ˆæŒ‡å®šä¿ƒé”€æœŸé—´ï¼‰  
        WHEN promotion_start_date <= NOW() 
             AND promotion_end_date >= NOW() 
             AND promotion_price IS NOT NULL THEN promotion_price
        
        -- ä¼˜å…ˆçº§3ï¼šæ‰¹é‡æŠ˜æ‰£ï¼ˆåº“å­˜å……è¶³çš„çƒ­é”€å•†å“ï¼‰
        WHEN stock_quantity > 500 
             AND monthly_sales > 100 THEN original_price * 0.9
        
        -- ä¼˜å…ˆçº§4ï¼šç¨€ç¼ºå•†å“æº¢ä»·ï¼ˆåº“å­˜ç´§å¼ çš„çƒ­é”€å•†å“ï¼‰
        WHEN stock_quantity < 20 
             AND monthly_sales > 50 THEN original_price * 1.2
             
        -- ä¼˜å…ˆçº§5ï¼šæ–°å“å®šä»·ï¼ˆä¸Šæ¶30å¤©å†…ï¼‰
        WHEN DATEDIFF(NOW(), created_date) <= 30 THEN original_price * 1.1
        
        -- é»˜è®¤ï¼šç»´æŒåŸä»·
        ELSE original_price
    END,
    
    price_strategy = CASE
        WHEN last_sale_date < DATE_SUB(NOW(), INTERVAL 6 MONTH) 
             AND stock_quantity > 100 THEN 'clearance'
        WHEN promotion_start_date <= NOW() 
             AND promotion_end_date >= NOW() 
             AND promotion_price IS NOT NULL THEN 'promotion'
        WHEN stock_quantity > 500 
             AND monthly_sales > 100 THEN 'bulk_discount'
        WHEN stock_quantity < 20 
             AND monthly_sales > 50 THEN 'premium'
        WHEN DATEDIFF(NOW(), created_date) <= 30 THEN 'new_product'
        ELSE 'normal'
    END;
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 6.1 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


**CASEæ¡ä»¶ä¸­çš„ç´¢å¼•ä½¿ç”¨**ï¼š
```sql
-- âŒ ä½æ•ˆï¼šæ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°ï¼Œæ— æ³•ä½¿ç”¨ç´¢å¼•
UPDATE orders 
SET priority = CASE
    WHEN YEAR(order_date) = 2025 THEN 'current'
    ELSE 'old'
END;

-- âœ… é«˜æ•ˆï¼šé¿å…åœ¨æ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°
UPDATE orders 
SET priority = CASE
    WHEN order_date >= '2025-01-01' AND order_date < '2026-01-01' THEN 'current'
    ELSE 'old'
END;
```

**å¤åˆç´¢å¼•åˆ©ç”¨**ï¼š
```sql
-- å‡è®¾å­˜åœ¨ç´¢å¼•ï¼šINDEX(status, order_date, customer_type)

-- âœ… èƒ½å……åˆ†åˆ©ç”¨ç´¢å¼•
UPDATE orders 
SET discount_rate = CASE
    WHEN status = 'pending' AND order_date >= '2025-01-01' AND customer_type = 'VIP' THEN 0.2
    WHEN status = 'pending' AND order_date >= '2025-01-01' AND customer_type = 'Gold' THEN 0.15
    WHEN status = 'pending' AND order_date >= '2025-01-01' THEN 0.1
    ELSE discount_rate
END
WHERE status = 'pending' AND order_date >= '2025-01-01';  -- å……åˆ†åˆ©ç”¨ç´¢å¼•
```

### 6.2 å‡å°‘è¡¨æ‰«æä¼˜åŒ–


**ä½¿ç”¨WHEREå­å¥é™åˆ¶æ›´æ–°èŒƒå›´**ï¼š
```sql
-- âŒ ä½æ•ˆï¼šå…¨è¡¨æ‰«æ
UPDATE employees 
SET salary_grade = CASE
    WHEN salary >= 100000 THEN 'A'
    WHEN salary >= 80000 THEN 'B'  
    WHEN salary >= 60000 THEN 'C'
    ELSE 'D'
END;

-- âœ… é«˜æ•ˆï¼šé™åˆ¶æ›´æ–°èŒƒå›´
UPDATE employees 
SET salary_grade = CASE
    WHEN salary >= 100000 THEN 'A'
    WHEN salary >= 80000 THEN 'B'
    WHEN salary >= 60000 THEN 'C'
    ELSE 'D'
END
WHERE salary_grade IS NULL OR salary_grade != 
    CASE
        WHEN salary >= 100000 THEN 'A'
        WHEN salary >= 80000 THEN 'B'
        WHEN salary >= 60000 THEN 'C'
        ELSE 'D'
    END;
```

**åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®**ï¼š
```sql
-- åˆ†æ‰¹æ›´æ–°å¤§è¡¨ï¼Œé¿å…é•¿æ—¶é—´é”è¡¨
-- ç¬¬ä¸€æ‰¹ï¼šå¤„ç†VIPå®¢æˆ·
UPDATE customers 
SET loyalty_points = CASE
    WHEN total_spent >= 50000 THEN loyalty_points * 1.5
    WHEN total_spent >= 20000 THEN loyalty_points * 1.3
    ELSE loyalty_points * 1.1
END
WHERE customer_type = 'VIP'
LIMIT 1000;

-- ç¬¬äºŒæ‰¹ï¼šå¤„ç†Goldå®¢æˆ·  
UPDATE customers 
SET loyalty_points = CASE
    WHEN total_spent >= 50000 THEN loyalty_points * 1.5
    WHEN total_spent >= 20000 THEN loyalty_points * 1.3
    ELSE loyalty_points * 1.1
END
WHERE customer_type = 'Gold' 
LIMIT 1000;
```

### 6.3 é¿å…é‡å¤è®¡ç®—


**æå–å…¬å…±è¡¨è¾¾å¼**ï¼š
```sql
-- âŒ ä½æ•ˆï¼šé‡å¤è®¡ç®—å­æŸ¥è¯¢
UPDATE products p
SET 
    category_rank = CASE
        WHEN (SELECT AVG(rating) FROM reviews r WHERE r.product_id = p.id) >= 4.5 THEN 'Top'
        WHEN (SELECT AVG(rating) FROM reviews r WHERE r.product_id = p.id) >= 3.5 THEN 'Good'  
        ELSE 'Average'
    END;

-- âœ… é«˜æ•ˆï¼šä½¿ç”¨JOINé¿å…é‡å¤å­æŸ¥è¯¢
UPDATE products p
JOIN (
    SELECT product_id, AVG(rating) as avg_rating
    FROM reviews 
    GROUP BY product_id
) r ON p.id = r.product_id
SET 
    category_rank = CASE
        WHEN r.avg_rating >= 4.5 THEN 'Top'
        WHEN r.avg_rating >= 3.5 THEN 'Good'
        ELSE 'Average'
    END;
```

---

## 7. ğŸ“‹ æœ€ä½³å®è·µæŒ‡å—


### 7.1 ä»£ç å¯è¯»æ€§æœ€ä½³å®è·µ


**æ¸…æ™°çš„æ¡ä»¶åˆ†å±‚**ï¼š
```sql
-- âœ… æ¨èï¼šæ¸…æ™°çš„åˆ†å±‚å’Œæ³¨é‡Š
UPDATE employees 
SET 
    -- è–ªèµ„è°ƒæ•´é€»è¾‘
    new_salary = CASE
        -- é«˜ç»©æ•ˆå‘˜å·¥
        WHEN performance_score >= 90 THEN 
            salary * 1.15  -- 15%æ¶¨å¹…
        
        -- ä¸­ç­‰ç»©æ•ˆå‘˜å·¥  
        WHEN performance_score >= 75 THEN 
            salary * 1.08  -- 8%æ¶¨å¹…
            
        -- åŠæ ¼ç»©æ•ˆå‘˜å·¥
        WHEN performance_score >= 60 THEN 
            salary * 1.03  -- 3%æ¶¨å¹…
            
        -- ä¸åŠæ ¼å‘˜å·¥
        ELSE 
            salary * 0.95  -- 5%å‡è–ª
    END,
    
    -- å¥–é‡‘è®¡ç®—é€»è¾‘
    bonus_amount = CASE
        WHEN performance_score >= 90 AND department IN ('Sales', 'Engineering') THEN 
            salary * 2.0   -- æ ¸å¿ƒéƒ¨é—¨é«˜ç»©æ•ˆå‘˜å·¥åŒè–ªå¥–é‡‘
            
        WHEN performance_score >= 90 THEN 
            salary * 1.5   -- å…¶ä»–éƒ¨é—¨é«˜ç»©æ•ˆå‘˜å·¥1.5å€è–ªå¥–é‡‘
            
        WHEN performance_score >= 75 THEN 
            salary * 0.8   -- ä¸­ç­‰ç»©æ•ˆå‘˜å·¥0.8å€è–ªå¥–é‡‘
            
        ELSE 
            0              -- å…¶ä»–æƒ…å†µæ— å¥–é‡‘
    END
WHERE 
    -- åªæ›´æ–°éœ€è¦è°ƒè–ªçš„å‘˜å·¥
    last_salary_review < DATE_SUB(NOW(), INTERVAL 12 MONTH);
```

### 7.2 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


**ä½¿ç”¨äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§**ï¼š
```sql
START TRANSACTION;

-- æ›´æ–°è®¢å•çŠ¶æ€
UPDATE orders 
SET 
    status = CASE
        WHEN payment_status = 'completed' AND stock_check = 'available' THEN 'confirmed'
        WHEN payment_status = 'failed' THEN 'cancelled'
        WHEN stock_check = 'insufficient' THEN 'pending_stock'
        ELSE status
    END,
    
    confirmed_date = CASE
        WHEN payment_status = 'completed' AND stock_check = 'available' THEN NOW()
        ELSE confirmed_date
    END

WHERE status = 'processing';

-- åŒæ­¥æ›´æ–°åº“å­˜
UPDATE inventory i
JOIN order_items oi ON i.product_id = oi.product_id  
JOIN orders o ON oi.order_id = o.id
SET 
    i.available_quantity = CASE
        WHEN o.status = 'confirmed' THEN i.available_quantity - oi.quantity
        ELSE i.available_quantity
    END,
    
    i.reserved_quantity = CASE  
        WHEN o.status = 'confirmed' THEN i.reserved_quantity - oi.quantity
        WHEN o.status = 'cancelled' THEN i.reserved_quantity - oi.quantity
        ELSE i.reserved_quantity
    END

WHERE o.status IN ('confirmed', 'cancelled');

COMMIT;
```

### 7.3 é”™è¯¯å¤„ç†å’ŒéªŒè¯


**æ•°æ®æœ‰æ•ˆæ€§éªŒè¯**ï¼š
```sql
-- æ›´æ–°å‰éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
UPDATE products 
SET 
    price = CASE
        -- éªŒè¯ä»·æ ¼èŒƒå›´åˆç†æ€§
        WHEN new_price > 0 AND new_price <= original_price * 10 THEN new_price
        ELSE original_price  -- æ— æ•ˆä»·æ ¼ä¿æŒåŸä»·
    END,
    
    discount_rate = CASE
        -- éªŒè¯æŠ˜æ‰£ç‡åˆç†æ€§
        WHEN calculated_discount BETWEEN 0 AND 0.8 THEN calculated_discount
        ELSE 0  -- æ— æ•ˆæŠ˜æ‰£ç‡è®¾ä¸º0
    END,
    
    -- è®°å½•æ›´æ–°çŠ¶æ€
    update_status = CASE
        WHEN new_price > 0 AND new_price <= original_price * 10 
             AND calculated_discount BETWEEN 0 AND 0.8 THEN 'success'
        ELSE 'validation_failed'
    END,
    
    last_updated = NOW()

WHERE 
    -- åªæ›´æ–°éœ€è¦æ›´æ–°ä¸”æ•°æ®å®Œæ•´çš„è®°å½•
    new_price IS NOT NULL 
    AND calculated_discount IS NOT NULL
    AND status = 'active';
```

### 7.4 æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–


**æ‰§è¡Œè®¡åˆ’åˆ†æ**ï¼š
```sql
-- ä½¿ç”¨EXPLAINåˆ†æCASE WHENæ›´æ–°çš„æ‰§è¡Œè®¡åˆ’
EXPLAIN UPDATE users 
SET membership_level = CASE
    WHEN total_spent >= 10000 THEN 'Platinum'
    WHEN total_spent >= 5000 THEN 'Gold'  
    WHEN total_spent >= 1000 THEN 'Silver'
    ELSE 'Bronze'
END
WHERE last_level_update < DATE_SUB(NOW(), INTERVAL 1 MONTH);

-- å…³æ³¨ç‚¹ï¼š
-- 1. typeå­—æ®µï¼šæ˜¯å¦ä½¿ç”¨äº†ç´¢å¼•
-- 2. rowså­—æ®µï¼šé¢„è®¡æ‰«æè¡Œæ•°  
-- 3. Extraå­—æ®µï¼šæ˜¯å¦æœ‰Using temporary, Using filesortç­‰
```

---

## 8. â“ å¸¸è§é—®é¢˜è§£å†³


### 8.1 NULLå€¼å¤„ç†é—®é¢˜


**é—®é¢˜**ï¼šCASE WHENæ¡ä»¶ä¸­çš„NULLå€¼æ¯”è¾ƒ

```sql
-- âŒ é”™è¯¯ï¼šNULLå€¼æ¯”è¾ƒæ€»æ˜¯è¿”å›NULL
UPDATE users 
SET status = CASE age
    WHEN NULL THEN 'unknown'  -- è¿™ä¸ªæ¡ä»¶æ°¸è¿œä¸ä¼šåŒ¹é…
    WHEN 18 THEN 'adult'
    ELSE 'minor'
END;

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨IS NULLåˆ¤æ–­
UPDATE users 
SET status = CASE
    WHEN age IS NULL THEN 'unknown'
    WHEN age >= 18 THEN 'adult'
    ELSE 'minor'
END;
```

**NULLå€¼åœ¨è¿ç®—ä¸­çš„å¤„ç†**ï¼š
```sql
-- âœ… å¤„ç†NULLå€¼çš„è¿ç®—
UPDATE orders 
SET total_amount = CASE
    WHEN discount_rate IS NULL THEN original_amount
    WHEN discount_rate BETWEEN 0 AND 1 THEN original_amount * (1 - discount_rate)
    ELSE original_amount  -- æ— æ•ˆæŠ˜æ‰£ç‡ä¿æŒåŸä»·
END;
```

### 8.2 æ•°æ®ç±»å‹ä¸åŒ¹é…


**é—®é¢˜**ï¼šTHENå­å¥ä¸­çš„æ•°æ®ç±»å‹å¿…é¡»å…¼å®¹

```sql
-- âŒ é”™è¯¯ï¼šæ•°æ®ç±»å‹ä¸åŒ¹é…
UPDATE products 
SET description = CASE
    WHEN stock_quantity > 100 THEN 'å……è¶³'
    WHEN stock_quantity > 0 THEN stock_quantity  -- æ•°å­—ç±»å‹ä¸å­—ç¬¦ä¸²ç±»å‹ä¸åŒ¹é…
    ELSE 'ç¼ºè´§'
END;

-- âœ… æ­£ç¡®ï¼šç»Ÿä¸€æ•°æ®ç±»å‹
UPDATE products 
SET description = CASE
    WHEN stock_quantity > 100 THEN 'å……è¶³'
    WHEN stock_quantity > 0 THEN CONCAT('å‰©ä½™', stock_quantity, 'ä»¶')  -- è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    ELSE 'ç¼ºè´§'
END;
```

### 8.3 æ¡ä»¶é‡å é—®é¢˜


**é—®é¢˜**ï¼šæ¡ä»¶ä¹‹é—´æœ‰é‡å ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ¡ä»¶ä¼šè¢«æ‰§è¡Œ

```sql
-- âŒ æœ‰é—®é¢˜ï¼šæ¡ä»¶é‡å 
UPDATE students 
SET grade_description = CASE
    WHEN score >= 80 THEN 'è‰¯å¥½åŠä»¥ä¸Š'  -- è¿™ä¸ªæ¡ä»¶ä¼šåŒ¹é…90-100åˆ†çš„å­¦ç”Ÿ
    WHEN score >= 90 THEN 'ä¼˜ç§€'       -- è¿™ä¸ªæ¡ä»¶æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ
    WHEN score >= 60 THEN 'åŠæ ¼'
    ELSE 'ä¸åŠæ ¼'
END;

-- âœ… æ­£ç¡®ï¼šæ¡ä»¶ä»é«˜åˆ°ä½æ’åº
UPDATE students 
SET grade_description = CASE
    WHEN score >= 90 THEN 'ä¼˜ç§€'       -- 90-100åˆ†
    WHEN score >= 80 THEN 'è‰¯å¥½'       -- 80-89åˆ†  
    WHEN score >= 60 THEN 'åŠæ ¼'       -- 60-79åˆ†
    ELSE 'ä¸åŠæ ¼'                      -- 0-59åˆ†
END;
```

### 8.4 æ€§èƒ½é—®é¢˜è¯Šæ–­


**å¤§è¡¨æ›´æ–°ç¼“æ…¢**ï¼š
```sql
-- é—®é¢˜è¯Šæ–­ï¼šæŸ¥çœ‹æ­£åœ¨æ‰§è¡Œçš„æ›´æ–°æ“ä½œ
SHOW PROCESSLIST;

-- æŸ¥çœ‹é”ç­‰å¾…æƒ…å†µ
SELECT * FROM information_schema.INNODB_LOCKS;
SELECT * FROM information_schema.INNODB_LOCK_WAITS;

-- ä¼˜åŒ–æ–¹æ¡ˆï¼šåˆ†æ‰¹æ›´æ–°
SET autocommit = 0;

-- åˆ†æ‰¹æ›´æ–°ï¼Œæ¯æ¬¡1000æ¡è®°å½•
UPDATE users 
SET level = CASE
    WHEN points >= 10000 THEN 'VIP'
    WHEN points >= 5000 THEN 'Gold'
    ELSE 'Normal'
END
WHERE id BETWEEN 1 AND 1000;
COMMIT;

UPDATE users 
SET level = CASE  
    WHEN points >= 10000 THEN 'VIP'
    WHEN points >= 5000 THEN 'Gold'
    ELSE 'Normal'
END
WHERE id BETWEEN 1001 AND 2000;
COMMIT;
```

---

## 9. ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹


### 9.1 ç”µå•†è®¢å•çŠ¶æ€ç®¡ç†


**å¤æ‚çš„è®¢å•çŠ¶æ€æµè½¬é€»è¾‘**ï¼š
```sql
-- ç”µå•†å¹³å°è®¢å•çŠ¶æ€è‡ªåŠ¨åŒ–ç®¡ç†
UPDATE orders o
JOIN order_payments op ON o.id = op.order_id
JOIN order_shipments os ON o.id = os.order_id  
SET 
    o.status = CASE
        -- è¶…æ—¶æœªä»˜æ¬¾è®¢å•è‡ªåŠ¨å–æ¶ˆ
        WHEN o.status = 'pending_payment' 
             AND TIMESTAMPDIFF(HOUR, o.created_at, NOW()) > 24 THEN 'cancelled'
        
        -- å·²ä»˜æ¬¾ä½†åº“å­˜ä¸è¶³çš„è®¢å•æ ‡è®°ä¸ºå¾…è¡¥è´§
        WHEN o.status = 'paid' 
             AND EXISTS (
                 SELECT 1 FROM order_items oi 
                 JOIN products p ON oi.product_id = p.id 
                 WHERE oi.order_id = o.id AND p.stock_quantity < oi.quantity
             ) THEN 'pending_stock'
        
        -- å·²ä»˜æ¬¾ä¸”æœ‰åº“å­˜çš„è®¢å•è‡ªåŠ¨ç¡®è®¤
        WHEN o.status = 'paid' 
             AND NOT EXISTS (
                 SELECT 1 FROM order_items oi 
                 JOIN products p ON oi.product_id = p.id 
                 WHERE oi.order_id = o.id AND p.stock_quantity < oi.quantity
             ) THEN 'confirmed'
        
        -- å·²ç¡®è®¤è®¢å•è¶…è¿‡2å¤©è‡ªåŠ¨å‘è´§
        WHEN o.status = 'confirmed' 
             AND TIMESTAMPDIFF(DAY, o.confirmed_at, NOW()) >= 2 THEN 'shipped'
        
        -- å·²å‘è´§è®¢å•è¶…è¿‡7å¤©è‡ªåŠ¨ç¡®è®¤æ”¶è´§
        WHEN o.status = 'shipped' 
             AND TIMESTAMPDIFF(DAY, os.shipped_at, NOW()) >= 7 THEN 'delivered'
        
        -- å·²æ”¶è´§è®¢å•è¶…è¿‡15å¤©è‡ªåŠ¨å®Œæˆ
        WHEN o.status = 'delivered' 
             AND TIMESTAMPDIFF(DAY, o.delivered_at, NOW()) >= 15 THEN 'completed'
        
        ELSE o.status
    END,
    
    -- åŒæ—¶æ›´æ–°ç›¸å…³æ—¶é—´æˆ³
    cancelled_at = CASE
        WHEN o.status = 'pending_payment' 
             AND TIMESTAMPDIFF(HOUR, o.created_at, NOW()) > 24 THEN NOW()
        ELSE o.cancelled_at
    END,
    
    confirmed_at = CASE
        WHEN o.status = 'paid' 
             AND NOT EXISTS (
                 SELECT 1 FROM order_items oi 
                 JOIN products p ON oi.product_id = p.id 
                 WHERE oi.order_id = o.id AND p.stock_quantity < oi.quantity
             ) THEN NOW()
        ELSE o.confirmed_at
    END;
```

### 9.2 ç”¨æˆ·ç§¯åˆ†ç­‰çº§ç³»ç»Ÿ


**åŸºäºå¤šç»´åº¦çš„ç”¨æˆ·ç­‰çº§è®¡ç®—**ï¼š
```sql
-- ç”¨æˆ·ä¼šå‘˜ç­‰çº§ç»¼åˆè¯„å®šç³»ç»Ÿ
UPDATE customers c
SET 
    membership_level = CASE
        -- é’»çŸ³ä¼šå‘˜ï¼šå¹´æ¶ˆè´¹é¢>=50000ä¸”è®¢å•æ•°>=100ä¸”æ´»è·ƒå¤©æ•°>=200
        WHEN c.annual_spending >= 50000 
             AND c.annual_orders >= 100 
             AND c.active_days >= 200 THEN 'Diamond'
        
        -- é“‚é‡‘ä¼šå‘˜ï¼šå¹´æ¶ˆè´¹é¢>=20000ä¸”è®¢å•æ•°>=50ä¸”æ´»è·ƒå¤©æ•°>=120
        WHEN c.annual_spending >= 20000 
             AND c.annual_orders >= 50 
             AND c.active_days >= 120 THEN 'Platinum'
        
        -- é»„é‡‘ä¼šå‘˜ï¼šå¹´æ¶ˆè´¹é¢>=10000ä¸”è®¢å•æ•°>=20ä¸”æ´»è·ƒå¤©æ•°>=60
        WHEN c.annual_spending >= 10000 
             AND c.annual_orders >= 20 
             AND c.active_days >= 60 THEN 'Gold'
        
        -- é“¶ç‰Œä¼šå‘˜ï¼šå¹´æ¶ˆè´¹é¢>=3000ä¸”è®¢å•æ•°>=10
        WHEN c.annual_spending >= 3000 
             AND c.annual_orders >= 10 THEN 'Silver'
        
        -- é“œç‰Œä¼šå‘˜ï¼šæœ‰è¿‡æ¶ˆè´¹è®°å½•
        WHEN c.annual_spending > 0 THEN 'Bronze'
        
        -- æ™®é€šç”¨æˆ·ï¼šä»…æ³¨å†Œæœªæ¶ˆè´¹
        ELSE 'Regular'
    END,
    
    -- è®¡ç®—ç§¯åˆ†å€ç‡
    points_multiplier = CASE
        WHEN c.annual_spending >= 50000 THEN 5.0    -- é’»çŸ³ä¼šå‘˜5å€ç§¯åˆ†
        WHEN c.annual_spending >= 20000 THEN 3.0    -- é“‚é‡‘ä¼šå‘˜3å€ç§¯åˆ†
        WHEN c.annual_spending >= 10000 THEN 2.0    -- é»„é‡‘ä¼šå‘˜2å€ç§¯åˆ†
        WHEN c.annual_spending >= 3000 THEN 1.5     -- é“¶ç‰Œä¼šå‘˜1.5å€ç§¯åˆ†
        WHEN c.annual_spending > 0 THEN 1.2         -- é“œç‰Œä¼šå‘˜1.2å€ç§¯åˆ†
        ELSE 1.0                                    -- æ™®é€šç”¨æˆ·1å€ç§¯åˆ†
    END,
    
    -- è®¾ç½®ä¸“å±ä¼˜æƒ æŠ˜æ‰£
    vip_discount = CASE
        WHEN c.annual_spending >= 50000 THEN 0.75   -- é’»çŸ³ä¼šå‘˜25%æŠ˜æ‰£
        WHEN c.annual_spending >= 20000 THEN 0.8    -- é“‚é‡‘ä¼šå‘˜20%æŠ˜æ‰£  
        WHEN c.annual_spending >= 10000 THEN 0.85   -- é»„é‡‘ä¼šå‘˜15%æŠ˜æ‰£
        WHEN c.annual_spending >= 3000 THEN 0.9     -- é“¶ç‰Œä¼šå‘˜10%æŠ˜æ‰£
        WHEN c.annual_spending > 0 THEN 0.95        -- é“œç‰Œä¼šå‘˜5%æŠ˜æ‰£
        ELSE 1.0                                    -- æ™®é€šç”¨æˆ·æ— æŠ˜æ‰£
    END,
    
    level_updated_at = NOW()

WHERE 
    -- åªæ›´æ–°éœ€è¦é‡æ–°è¯„å®šç­‰çº§çš„å®¢æˆ·
    last_level_update < DATE_SUB(NOW(), INTERVAL 1 MONTH)
    OR membership_level IS NULL;
```

### 9.3 åº“å­˜é¢„è­¦ä¸è¡¥è´§ç­–ç•¥


**æ™ºèƒ½åº“å­˜ç®¡ç†ç³»ç»Ÿ**ï¼š
```sql
-- åº“å­˜é¢„è­¦å’Œè¡¥è´§ç­–ç•¥è‡ªåŠ¨åŒ–
UPDATE products p
LEFT JOIN (
    -- è®¡ç®—è¿‡å»30å¤©çš„å¹³å‡é”€é‡
    SELECT 
        product_id,
        AVG(daily_sales) as avg_daily_sales,
        MAX(daily_sales) as max_daily_sales
    FROM (
        SELECT 
            oi.product_id,
            DATE(o.created_at) as sale_date,
            SUM(oi.quantity) as daily_sales
        FROM orders o
        JOIN order_items oi ON o.id = oi.order_id
        WHERE o.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        AND o.status NOT IN ('cancelled', 'refunded')
        GROUP BY oi.product_id, DATE(o.created_at)
    ) daily_stats
    GROUP BY product_id
) sales_stats ON p.id = sales_stats.product_id
SET 
    -- è®¾ç½®åº“å­˜é¢„è­¦çŠ¶æ€
    stock_status = CASE
        -- ç´§æ€¥ç¼ºè´§ï¼šå½“å‰åº“å­˜ä¸è¶³1å¤©é”€é‡
        WHEN p.stock_quantity <= COALESCE(sales_stats.avg_daily_sales, 0) THEN 'critical'
        
        -- ä½åº“å­˜é¢„è­¦ï¼šå½“å‰åº“å­˜ä¸è¶³3å¤©é”€é‡
        WHEN p.stock_quantity <= COALESCE(sales_stats.avg_daily_sales * 3, 10) THEN 'low'
        
        -- åº“å­˜å……è¶³ï¼šå½“å‰åº“å­˜è¶…è¿‡30å¤©é”€é‡
        WHEN p.stock_quantity >= COALESCE(sales_stats.avg_daily_sales * 30, 100) THEN 'abundant'
        
        -- æ­£å¸¸åº“å­˜
        ELSE 'normal'
    END,
    
    -- è®¡ç®—å»ºè®®è¡¥è´§æ•°é‡
    suggested_restock_quantity = CASE
        -- çƒ­é”€äº§å“ï¼šè¡¥è´§åˆ°èƒ½æ”¯æ’‘60å¤©é”€é‡
        WHEN COALESCE(sales_stats.avg_daily_sales, 0) >= 10 THEN 
            GREATEST(
                COALESCE(sales_stats.avg_daily_sales * 60, 600) - p.stock_quantity,
                0
            )
        
        -- æ™®é€šäº§å“ï¼šè¡¥è´§åˆ°èƒ½æ”¯æ’‘30å¤©é”€é‡
        WHEN COALESCE(sales_stats.avg_daily_sales, 0) >= 1 THEN 
            GREATEST(
                COALESCE(sales_stats.avg_daily_sales * 30, 300) - p.stock_quantity,
                0
            )
        
        -- æ»é”€äº§å“ï¼šè¡¥è´§åˆ°æœ€ä½åº“å­˜å³å¯
        ELSE 
            GREATEST(50 - p.stock_quantity, 0)
    END,
    
    -- è®¾ç½®é‡‡è´­ä¼˜å…ˆçº§
    purchase_priority = CASE
        -- é«˜ä¼˜å…ˆçº§ï¼šç¼ºè´§ä¸”çƒ­é”€
        WHEN p.stock_quantity <= COALESCE(sales_stats.avg_daily_sales, 0) 
             AND COALESCE(sales_stats.avg_daily_sales, 0) >= 5 THEN 'high'
        
        -- ä¸­ä¼˜å…ˆçº§ï¼šåº“å­˜ä½ä½†ä¸ç´§æ€¥
        WHEN p.stock_quantity <= COALESCE(sales_stats.avg_daily_sales * 7, 50) THEN 'medium'
        
        -- ä½ä¼˜å…ˆçº§ï¼šåº“å­˜å……è¶³
        ELSE 'low'
    END,
    
    last_stock_analysis = NOW()

WHERE 
    p.status = 'active'
    AND (p.last_stock_analysis IS NULL 
         OR p.last_stock_analysis < DATE_SUB(NOW(), INTERVAL 1 DAY));
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CASE WHENè¡¨è¾¾å¼ï¼šSQLä¸­çš„æ¡ä»¶åˆ¤æ–­è¯­å¥ï¼Œç±»ä¼¼ç¼–ç¨‹ä¸­çš„if-else
ğŸ”¸ ç®€å•CASE vs æœç´¢CASEï¼šå€¼åŒ¹é… vs æ¡ä»¶åˆ¤æ–­çš„åŒºåˆ«
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šWHENæ¡ä»¶æŒ‰é¡ºåºæ£€æŸ¥ï¼ŒåŒ¹é…ç¬¬ä¸€ä¸ªæ»¡è¶³çš„æ¡ä»¶
ğŸ”¸ æ•°æ®ç±»å‹ä¸€è‡´æ€§ï¼šæ‰€æœ‰THENå­å¥çš„è¿”å›ç±»å‹å¿…é¡»å…¼å®¹
ğŸ”¸ NULLå€¼å¤„ç†ï¼šä½¿ç”¨IS NULLè€Œä¸æ˜¯= NULLè¿›è¡Œç©ºå€¼åˆ¤æ–­
ğŸ”¸ æ€§èƒ½è€ƒè™‘ï¼šåˆç†ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æ
ğŸ”¸ äº‹åŠ¡ä¸€è‡´æ€§ï¼šå¤æ‚æ›´æ–°åº”è¯¥åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CASE WHENçš„æ‰§è¡Œé€»è¾‘**
```
ç†è§£è¦ç‚¹ï¼š
- æŒ‰ç…§WHENçš„é¡ºåºé€ä¸ªæ£€æŸ¥æ¡ä»¶
- æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ¡ä»¶åç«‹å³è¿”å›THENçš„å€¼
- å¦‚æœæ‰€æœ‰WHENéƒ½ä¸åŒ¹é…ï¼Œè¿”å›ELSEçš„å€¼ï¼ˆå¦‚æœæ²¡æœ‰ELSEåˆ™è¿”å›NULLï¼‰
- æ¡ä»¶æ’åºå¾ˆé‡è¦ï¼Œé¿å…æ¡ä»¶é‡å å¯¼è‡´é€»è¾‘é”™è¯¯
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®**
```
æ ¸å¿ƒæ€æƒ³ï¼š
- åœ¨WHEREå­å¥ä¸­é™åˆ¶æ›´æ–°èŒƒå›´ï¼Œé¿å…ä¸å¿…è¦çš„å…¨è¡¨æ‰«æ
- åˆç†åˆ©ç”¨ç´¢å¼•ï¼Œé¿å…åœ¨WHENæ¡ä»¶ä¸­ä½¿ç”¨å‡½æ•°
- å¯¹äºå¤§è¡¨åˆ†æ‰¹æ›´æ–°ï¼Œé¿å…é•¿æ—¶é—´é”è¡¨
- æå–é‡å¤çš„å­æŸ¥è¯¢ï¼Œå‡å°‘æ•°æ®åº“è®¡ç®—å¼€é”€
```

**ğŸ”¹ ä»£ç å¯ç»´æŠ¤æ€§**
```
æœ€ä½³å®è·µï¼š
- æ¡ä»¶æŒ‰é€»è¾‘ä¼˜å…ˆçº§æ’åºï¼Œé«˜ä¼˜å…ˆçº§åœ¨å‰
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šè¯´æ˜ä¸šåŠ¡é€»è¾‘
- é¿å…è¿‡æ·±çš„åµŒå¥—ï¼Œä¿æŒä»£ç å¯è¯»æ€§
- ç»Ÿä¸€THENå­å¥çš„æ•°æ®ç±»å‹
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **çŠ¶æ€ç®¡ç†**ï¼šè®¢å•çŠ¶æ€ã€ç”¨æˆ·ç­‰çº§ã€å•†å“çŠ¶æ€çš„è‡ªåŠ¨åŒ–æ›´æ–°
- **æ•°æ®æ¸…æ´—**ï¼šæ‰¹é‡æ•°æ®è½¬æ¢ã€åˆ†ç±»ã€æ ‡å‡†åŒ–å¤„ç†
- **ä¸šåŠ¡è§„åˆ™**ï¼šå¤æ‚çš„ä¸šåŠ¡é€»è¾‘åœ¨æ•°æ®åº“å±‚é¢å®ç°
- **æ•°æ®ç»Ÿè®¡**ï¼šåŸºäºä¸åŒæ¡ä»¶çš„æ•°æ®æ±‡æ€»å’Œåˆ†æ

**ğŸ” æŠ€æœ¯ä¼˜åŠ¿**ï¼š
- **åŸå­æ“ä½œ**ï¼šä¸€æ¡SQLå®Œæˆå¤æ‚çš„æ¡ä»¶æ›´æ–°é€»è¾‘
- **å‡å°‘ç½‘ç»œäº¤äº’**ï¼šé¿å…å¤šæ¬¡æ•°æ®åº“å¾€è¿”
- **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **æ€§èƒ½æå‡**ï¼šç›¸æ¯”å¤šæ¡UPDATEè¯­å¥æ›´é«˜æ•ˆ

### 10.4 å­¦ä¹ è¿›é˜¶å»ºè®®


**ğŸ”¸ æ·±å…¥å­¦ä¹ æ–¹å‘**ï¼š
- **é«˜çº§SQLæŠ€å·§**ï¼šç»“åˆçª—å£å‡½æ•°ã€CTEç­‰é«˜çº§ç‰¹æ€§
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ·±å…¥ç†è§£æ‰§è¡Œè®¡åˆ’å’Œç´¢å¼•ä¼˜åŒ–
- **å¹¶å‘æ§åˆ¶**ï¼šå­¦ä¹ é”æœºåˆ¶å’Œäº‹åŠ¡éš”ç¦»çº§åˆ«

**ğŸ”¸ å®è·µç»ƒä¹ å»ºè®®**ï¼š
- **åœºæ™¯æ¨¡æ‹Ÿ**ï¼šè®¾è®¡ä¸åŒä¸šåŠ¡åœºæ™¯çš„æ¡ä»¶æ›´æ–°é€»è¾‘
- **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒå†™æ³•çš„æ‰§è¡Œæ•ˆç‡
- **é”™è¯¯æ’æŸ¥**ï¼šç»ƒä¹ å¸¸è§é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
CASE WHENæ¡ä»¶åˆ¤æ–­å¼ºï¼Œä¸€æ¡SQLèƒœåƒè¡Œ
ç®€å•æœç´¢ä¸¤æ¨¡å¼ï¼Œæ¡ä»¶é¡ºåºè¦å¦¥å½“
NULLå€¼å¤„ç†ç”¨ISåˆ¤ï¼Œç±»å‹ç»Ÿä¸€è«å¿˜è®°
ç´¢å¼•ä¼˜åŒ–æ€§èƒ½å¥½ï¼Œäº‹åŠ¡ä¿è¯æ•°æ®å¼º
```