---
title: 26ã€DELETEæ“ä½œä¸è§¦å‘å™¨äº¤äº’æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [DELETEè§¦å‘å™¨åŸºç¡€æ¦‚å¿µ](#1-deleteè§¦å‘å™¨åŸºç¡€æ¦‚å¿µ)
2. [BEFORE DELETEè§¦å‘å™¨æ‰§è¡Œ](#2-before-deleteè§¦å‘å™¨æ‰§è¡Œ)
3. [AFTER DELETEè§¦å‘å™¨åº”ç”¨](#3-after-deleteè§¦å‘å™¨åº”ç”¨)
4. [è§¦å‘å™¨ä¸­DELETEé™åˆ¶](#4-è§¦å‘å™¨ä¸­deleteé™åˆ¶)
5. [çº§è”è§¦å‘å™¨æ‰§è¡Œé¡ºåº](#5-çº§è”è§¦å‘å™¨æ‰§è¡Œé¡ºåº)
6. [è§¦å‘å™¨å¼‚å¸¸å¤„ç†](#6-è§¦å‘å™¨å¼‚å¸¸å¤„ç†)
7. [DELETEè§¦å‘å™¨æ€§èƒ½å½±å“](#7-deleteè§¦å‘å™¨æ€§èƒ½å½±å“)
8. [è§¦å‘å™¨è°ƒè¯•ä¸ç›‘æ§](#8-è§¦å‘å™¨è°ƒè¯•ä¸ç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ DELETEè§¦å‘å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯DELETEè§¦å‘å™¨


**ğŸ’¡ è§¦å‘å™¨çš„æœ¬è´¨**
DELETEè§¦å‘å™¨å°±åƒæ˜¯æ•°æ®åº“ä¸­çš„"è‡ªåŠ¨åŒ–åŠ©æ‰‹"ï¼Œå½“æœ‰æ•°æ®è¢«åˆ é™¤æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡Œé¢„å…ˆå®šä¹‰å¥½çš„æ“ä½œã€‚

```
ç®€å•ç†è§£ï¼š
å°±åƒä½ å®¶é‡Œçš„æ™ºèƒ½é—¨é”ç³»ç»Ÿï¼š
- å½“æœ‰äººç¦»å¼€æˆ¿é—´æ—¶ï¼ˆDELETEæ“ä½œï¼‰
- è‡ªåŠ¨å…³é—­ç¯å…‰å’Œç©ºè°ƒï¼ˆè§¦å‘å™¨åŠ¨ä½œï¼‰
- è®°å½•ç¦»å¼€æ—¶é—´åˆ°æ—¥å¿—ï¼ˆå®¡è®¡åŠŸèƒ½ï¼‰

DELETEè§¦å‘å™¨åœ¨æ•°æ®åˆ é™¤å‰åè‡ªåŠ¨æ‰§è¡Œç‰¹å®šé€»è¾‘
```

### 1.2 DELETEè§¦å‘å™¨çš„ç±»å‹


**ğŸ”¸ è§¦å‘å™¨åˆ†ç±»**
```sql
-- BEFORE DELETE è§¦å‘å™¨
-- åœ¨åˆ é™¤æ“ä½œæ‰§è¡Œå‰è§¦å‘
-- å¯ä»¥é˜»æ­¢åˆ é™¤æ“ä½œçš„æ‰§è¡Œ

-- AFTER DELETE è§¦å‘å™¨  
-- åœ¨åˆ é™¤æ“ä½œæˆåŠŸæ‰§è¡Œåè§¦å‘
-- ç”¨äºåç»­çš„æ¸…ç†å’Œè®°å½•å·¥ä½œ
```

### 1.3 è§¦å‘å™¨çš„åŸºæœ¬è¯­æ³•


**ğŸ“ CREATE TRIGGERè¯­æ³•**
```sql
-- BEFORE DELETEè§¦å‘å™¨
CREATE TRIGGER trigger_name
    BEFORE DELETE ON table_name
    FOR EACH ROW
BEGIN
    -- è§¦å‘å™¨é€»è¾‘
END;

-- AFTER DELETEè§¦å‘å™¨
CREATE TRIGGER trigger_name
    AFTER DELETE ON table_name
    FOR EACH ROW
BEGIN
    -- è§¦å‘å™¨é€»è¾‘
END;
```

### 1.4 è§¦å‘å™¨ä¸­çš„OLDå…³é”®å­—


**ğŸ” è®¿é—®è¢«åˆ é™¤çš„æ•°æ®**
```sql
-- åœ¨DELETEè§¦å‘å™¨ä¸­ï¼Œåªèƒ½ä½¿ç”¨OLDæ¥è®¿é—®è¢«åˆ é™¤çš„è¡Œæ•°æ®
-- OLD.column_name è¡¨ç¤ºè¢«åˆ é™¤è¡Œä¸­è¯¥å­—æ®µçš„å€¼

CREATE TRIGGER example_delete_trigger
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    -- è®°å½•è¢«åˆ é™¤ç”¨æˆ·çš„ä¿¡æ¯
    INSERT INTO user_audit_log (
        user_id, 
        username, 
        delete_time
    ) VALUES (
        OLD.id, 
        OLD.username, 
        NOW()
    );
END;
```

---

## 2. â° BEFORE DELETEè§¦å‘å™¨æ‰§è¡Œ


### 2.1 BEFORE DELETEè§¦å‘å™¨çš„ä½œç”¨


**ğŸ›¡ï¸ åˆ é™¤å‰çš„å®ˆæŠ¤ç¥**
BEFORE DELETEè§¦å‘å™¨åœ¨å®é™…åˆ é™¤æ•°æ®ä¹‹å‰æ‰§è¡Œï¼Œä¸»è¦ç”¨äºï¼š

```
æ•°æ®éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦å…è®¸åˆ é™¤
ä¾èµ–æ£€æŸ¥ï¼šç¡®è®¤æ²¡æœ‰å…¶ä»–æ•°æ®ä¾èµ–è¿™æ¡è®°å½•
å¤‡ä»½æ“ä½œï¼šåœ¨åˆ é™¤å‰å¤‡ä»½é‡è¦æ•°æ®
æƒé™éªŒè¯ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰åˆ é™¤æƒé™
å®¡è®¡è®°å½•ï¼šè®°å½•åˆ é™¤æ“ä½œçš„è¯¦ç»†ä¿¡æ¯
```

### 2.2 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ”¸ åˆ é™¤å‰æ•°æ®éªŒè¯**
```sql
-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    status ENUM('pending', 'processing', 'shipped', 'completed', 'cancelled'),
    total_amount DECIMAL(10,2),
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºBEFORE DELETEè§¦å‘å™¨ï¼Œé˜²æ­¢åˆ é™¤å·²å‘è´§çš„è®¢å•
DELIMITER $$
CREATE TRIGGER prevent_shipped_order_delete
    BEFORE DELETE ON orders
    FOR EACH ROW
BEGIN
    -- æ£€æŸ¥è®¢å•çŠ¶æ€
    IF OLD.status IN ('shipped', 'completed') THEN
        -- æŠ›å‡ºé”™è¯¯ï¼Œé˜»æ­¢åˆ é™¤
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'å·²å‘è´§æˆ–å·²å®Œæˆçš„è®¢å•ä¸èƒ½åˆ é™¤';
    END IF;
    
    -- è®°å½•åˆ é™¤å°è¯•
    INSERT INTO order_delete_log (
        order_id,
        user_id, 
        status,
        attempt_time,
        result
    ) VALUES (
        OLD.id,
        OLD.user_id,
        OLD.status,
        NOW(),
        CASE 
            WHEN OLD.status IN ('shipped', 'completed') THEN 'BLOCKED'
            ELSE 'ALLOWED'
        END
    );
END$$
DELIMITER ;
```

**ğŸ”¸ çº§è”åˆ é™¤å‰æ£€æŸ¥**
```sql
-- åˆ é™¤ç”¨æˆ·å‰æ£€æŸ¥å…¶æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„è®¢å•
DELIMITER $$
CREATE TRIGGER check_user_orders_before_delete
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    DECLARE order_count INT;
    
    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æœªå®Œæˆçš„è®¢å•
    SELECT COUNT(*) INTO order_count
    FROM orders 
    WHERE user_id = OLD.id 
      AND status IN ('pending', 'processing', 'shipped');
    
    -- å¦‚æœæœ‰æœªå®Œæˆè®¢å•ï¼Œé˜»æ­¢åˆ é™¤ç”¨æˆ·
    IF order_count > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = CONCAT('ç”¨æˆ·è¿˜æœ‰ ', order_count, ' ä¸ªæœªå®Œæˆè®¢å•ï¼Œæ— æ³•åˆ é™¤');
    END IF;
    
    -- è®°å½•ç”¨æˆ·åˆ é™¤æ“ä½œ
    INSERT INTO user_deletion_audit (
        user_id,
        username,
        email,
        deletion_time,
        deleted_by
    ) VALUES (
        OLD.id,
        OLD.username,
        OLD.email,
        NOW(),
        USER()  -- å½“å‰MySQLç”¨æˆ·
    );
END$$
DELIMITER ;
```

### 2.3 BEFORE DELETEçš„æ‰§è¡Œæ—¶æœº


**â±ï¸ æ‰§è¡Œæµç¨‹å›¾**
```
ç”¨æˆ·æ‰§è¡ŒDELETEè¯­å¥
        â†“
æ£€æŸ¥DELETEè¯­å¥è¯­æ³•
        â†“
å¼€å§‹äº‹åŠ¡ï¼ˆå¦‚æœä¸åœ¨äº‹åŠ¡ä¸­ï¼‰
        â†“
ğŸ”¥ BEFORE DELETEè§¦å‘å™¨æ‰§è¡Œ
        â†“
è§¦å‘å™¨æ‰§è¡ŒæˆåŠŸï¼Ÿ
    â†“ æ˜¯           â†“ å¦
æ‰§è¡Œå®é™…DELETE  å›æ»šäº‹åŠ¡ï¼Œè¿”å›é”™è¯¯
    â†“
DELETEæ‰§è¡ŒæˆåŠŸï¼Ÿ
    â†“ æ˜¯           â†“ å¦  
AFTER DELETEè§¦å‘å™¨  å›æ»šäº‹åŠ¡ï¼Œè¿”å›é”™è¯¯
    â†“
æäº¤äº‹åŠ¡
```

### 2.4 é˜»æ­¢åˆ é™¤æ“ä½œ


**ğŸš« ä½¿ç”¨SIGNALé˜»æ­¢åˆ é™¤**
```sql
DELIMITER $$
CREATE TRIGGER protect_admin_users
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    -- ä¿æŠ¤ç®¡ç†å‘˜ç”¨æˆ·ä¸è¢«åˆ é™¤
    IF OLD.role = 'admin' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'ç®¡ç†å‘˜ç”¨æˆ·ä¸èƒ½è¢«åˆ é™¤',
            MYSQL_ERRNO = 1644;
    END IF;
    
    -- ä¿æŠ¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
    IF OLD.role = 'admin' THEN
        DECLARE admin_count INT;
        SELECT COUNT(*) INTO admin_count 
        FROM users 
        WHERE role = 'admin' AND id != OLD.id;
        
        IF admin_count = 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·';
        END IF;
    END IF;
END$$
DELIMITER ;
```

---

## 3. âœ… AFTER DELETEè§¦å‘å™¨åº”ç”¨


### 3.1 AFTER DELETEè§¦å‘å™¨çš„ç‰¹ç‚¹


**ğŸ¯ åˆ é™¤åçš„æ”¶å°¾å·¥ä½œ**
AFTER DELETEè§¦å‘å™¨åœ¨æ•°æ®æˆåŠŸåˆ é™¤åæ‰§è¡Œï¼Œä¸»è¦ç”¨äºï¼š

```
æ¸…ç†ç›¸å…³æ•°æ®ï¼šåˆ é™¤å…³è”çš„æ–‡ä»¶ã€ç¼“å­˜ç­‰
æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼šæ›´æ–°è®¡æ•°å™¨ã€æ±‡æ€»æ•°æ®ç­‰
å‘é€é€šçŸ¥ï¼šå‘é€é‚®ä»¶ã€æ¶ˆæ¯ç­‰é€šçŸ¥
åŒæ­¥æ“ä½œï¼šåŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿæˆ–æ•°æ®åº“
å®¡è®¡è®°å½•ï¼šè®°å½•åˆ é™¤æˆåŠŸçš„ä¿¡æ¯
```

### 3.2 å…¸å‹åº”ç”¨åœºæ™¯


**ğŸ”¸ æ¸…ç†å…³è”æ•°æ®**
```sql
-- ç”¨æˆ·åˆ é™¤åï¼Œæ¸…ç†ç›¸å…³çš„ä¸ªäººæ–‡ä»¶å’Œç¼“å­˜
DELIMITER $$
CREATE TRIGGER cleanup_user_data_after_delete
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- åˆ é™¤ç”¨æˆ·çš„ä¸ªäººæ–‡ä»¶è®°å½•
    DELETE FROM user_files WHERE user_id = OLD.id;
    
    -- åˆ é™¤ç”¨æˆ·çš„ç¼“å­˜æ•°æ®
    DELETE FROM user_cache WHERE user_id = OLD.id;
    
    -- åˆ é™¤ç”¨æˆ·çš„ä¼šè¯è®°å½•
    DELETE FROM user_sessions WHERE user_id = OLD.id;
    
    -- æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
    UPDATE site_statistics 
    SET total_users = total_users - 1,
        last_update = NOW()
    WHERE stat_type = 'user_count';
    
    -- è®°å½•æ¸…ç†æ—¥å¿—
    INSERT INTO cleanup_log (
        operation_type,
        reference_id,
        cleanup_time,
        details
    ) VALUES (
        'USER_DELETE_CLEANUP',
        OLD.id,
        NOW(),
        CONCAT('æ¸…ç†ç”¨æˆ· ', OLD.username, ' çš„ç›¸å…³æ•°æ®')
    );
END$$
DELIMITER ;
```

**ğŸ”¸ æ›´æ–°æ±‡æ€»ç»Ÿè®¡**
```sql
-- è®¢å•åˆ é™¤åæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
DELIMITER $$
CREATE TRIGGER update_stats_after_order_delete
    AFTER DELETE ON orders
    FOR EACH ROW
BEGIN
    -- æ›´æ–°ç”¨æˆ·è®¢å•ç»Ÿè®¡
    UPDATE user_statistics 
    SET order_count = order_count - 1,
        total_amount = total_amount - OLD.total_amount,
        last_update = NOW()
    WHERE user_id = OLD.user_id;
    
    -- æ›´æ–°æ¯æ—¥è®¢å•ç»Ÿè®¡
    UPDATE daily_order_stats 
    SET order_count = order_count - 1,
        total_amount = total_amount - OLD.total_amount
    WHERE stat_date = DATE(OLD.created_time);
    
    -- å¦‚æœç»Ÿè®¡è®°å½•ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯å†å²æ•°æ®åˆ é™¤ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
    IF ROW_COUNT() = 0 THEN
        INSERT INTO data_inconsistency_log (
            table_name,
            reference_id,
            issue_type,
            issue_time,
            description
        ) VALUES (
            'orders',
            OLD.id,
            'MISSING_STATS',
            NOW(),
            CONCAT('åˆ é™¤è®¢å•æ—¶æœªæ‰¾åˆ°å¯¹åº”çš„ç»Ÿè®¡è®°å½•ï¼š', DATE(OLD.created_time))
        );
    END IF;
END$$
DELIMITER ;
```

### 3.3 å‘é€é€šçŸ¥å’ŒåŒæ­¥


**ğŸ“§ å‘é€åˆ é™¤é€šçŸ¥**
```sql
-- é‡è¦æ•°æ®åˆ é™¤åå‘é€é€šçŸ¥
DELIMITER $$
CREATE TRIGGER notify_important_data_delete
    AFTER DELETE ON critical_business_data
    FOR EACH ROW
BEGIN
    -- è®°å½•åˆ°é€šçŸ¥é˜Ÿåˆ—ï¼ˆç”±å¤–éƒ¨ç¨‹åºå¤„ç†å®é™…å‘é€ï¼‰
    INSERT INTO notification_queue (
        type,
        recipient,
        subject,
        content,
        priority,
        created_time
    ) VALUES (
        'EMAIL',
        'admin@company.com',
        'é‡è¦æ•°æ®åˆ é™¤é€šçŸ¥',
        CONCAT(
            'é‡è¦ä¸šåŠ¡æ•°æ®å·²è¢«åˆ é™¤ï¼š\n',
            'æ•°æ®IDï¼š', OLD.id, '\n',
            'æ•°æ®ç±»å‹ï¼š', OLD.data_type, '\n',
            'åˆ é™¤æ—¶é—´ï¼š', NOW(), '\n',
            'æ“ä½œç”¨æˆ·ï¼š', USER(), '\n',
            'è¯·åŠæ—¶æ ¸æŸ¥æ­¤æ“ä½œçš„åˆç†æ€§ã€‚'
        ),
        'HIGH',
        NOW()
    );
    
    -- åŒæ­¥åˆ é™¤æ“ä½œåˆ°å®¡è®¡ç³»ç»Ÿ
    INSERT INTO external_audit_sync (
        operation_type,
        table_name,
        record_id,
        old_data,
        operation_time,
        mysql_user,
        sync_status
    ) VALUES (
        'DELETE',
        'critical_business_data',
        OLD.id,
        JSON_OBJECT(
            'id', OLD.id,
            'data_type', OLD.data_type,
            'content', OLD.content,
            'created_time', OLD.created_time
        ),
        NOW(),
        USER(),
        'PENDING'
    );
END$$
DELIMITER ;
```

### 3.4 AFTER DELETEçš„å®‰å…¨æ€§


**âš ï¸ é‡è¦æé†’**
```sql
-- AFTER DELETEä¸­çš„æ“ä½œä¸èƒ½å›æ»šDELETEæœ¬èº«
-- ä½†å¦‚æœAFTER DELETEå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡ä¼šå›æ»š

DELIMITER $$
CREATE TRIGGER safe_after_delete_example
    AFTER DELETE ON orders
    FOR EACH ROW
BEGIN
    -- å¦‚æœè¿™é‡Œå‘ç”Ÿé”™è¯¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªDELETEäº‹åŠ¡å›æ»š
    -- åŸæœ¬çš„DELETEæ“ä½œä¹Ÿä¼šè¢«æ’¤é”€
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- è®°å½•è§¦å‘å™¨æ‰§è¡Œé”™è¯¯
        INSERT INTO trigger_error_log (
            trigger_name,
            table_name,
            operation_type,
            error_time,
            error_message
        ) VALUES (
            'safe_after_delete_example',
            'orders',
            'AFTER DELETE',
            NOW(),
            'AFTER DELETEè§¦å‘å™¨æ‰§è¡Œå¤±è´¥'
        );
        
        -- é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œç¡®ä¿äº‹åŠ¡å›æ»š
        RESIGNAL;
    END;
    
    -- æ­£å¸¸çš„è§¦å‘å™¨é€»è¾‘
    UPDATE order_statistics 
    SET total_orders = total_orders - 1;
END$$
DELIMITER ;
```

---

## 4. ğŸš« è§¦å‘å™¨ä¸­DELETEé™åˆ¶


### 4.1 è§¦å‘å™¨ä¸­çš„DELETEé™åˆ¶æ¦‚è¿°


**ğŸ’¡ ä¸ºä»€ä¹ˆè¦æœ‰é™åˆ¶**
MySQLå¯¹è§¦å‘å™¨ä¸­çš„DELETEæ“ä½œæœ‰ä¸€äº›é™åˆ¶ï¼Œè¿™äº›é™åˆ¶æ˜¯ä¸ºäº†é˜²æ­¢ï¼š

```
æ— é™å¾ªç¯ï¼šè§¦å‘å™¨åˆ é™¤æ•°æ®å†è§¦å‘è‡ªå·±
æ­»é”é—®é¢˜ï¼šå¤šä¸ªè§¦å‘å™¨ç›¸äº’å½±å“é€ æˆæ­»é”
æ€§èƒ½é—®é¢˜ï¼šè¿‡æ·±çš„è§¦å‘å™¨åµŒå¥—å½±å“æ€§èƒ½
æ•°æ®ä¸€è‡´æ€§ï¼šé¿å…å¤æ‚çš„çº§è”æ“ä½œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
```

### 4.2 åŒè¡¨DELETEé™åˆ¶


**ğŸ”¸ ä¸èƒ½åˆ é™¤å½“å‰è¡¨çš„æ•°æ®**
```sql
-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šåœ¨DELETEè§¦å‘å™¨ä¸­åˆ é™¤åŒä¸€å¼ è¡¨
DELIMITER $$
CREATE TRIGGER invalid_self_delete
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- è¿™æ˜¯ä¸è¢«å…è®¸çš„ï¼
    -- DELETE FROM users WHERE status = 'inactive';
    -- é”™è¯¯ï¼šCan't update table 'users' in stored function/trigger 
    -- because it is already used by statement which invoked this function/trigger
END$$
DELIMITER ;
```

**âœ… æ­£ç¡®çš„æ›¿ä»£æ–¹æ¡ˆ**
```sql
-- ä½¿ç”¨æ ‡è®°ä½ä»£æ›¿å®é™…åˆ é™¤
DELIMITER $$
CREATE TRIGGER mark_related_users_deleted
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- ä¸èƒ½ç›´æ¥åˆ é™¤åŒè¡¨æ•°æ®ï¼Œä½†å¯ä»¥æ ‡è®°ä¸ºå·²åˆ é™¤
    UPDATE users 
    SET is_deleted = 1, 
        deleted_time = NOW()
    WHERE manager_id = OLD.id;
    
    -- æˆ–è€…è®°å½•åˆ°å¾…å¤„ç†é˜Ÿåˆ—ï¼Œç”±å¤–éƒ¨ç¨‹åºå¤„ç†
    INSERT INTO deletion_queue (
        table_name,
        target_condition,
        created_time
    ) VALUES (
        'users',
        CONCAT('manager_id = ', OLD.id),
        NOW()
    );
END$$
DELIMITER ;
```

### 4.3 è§¦å‘å™¨åµŒå¥—æ·±åº¦é™åˆ¶


**ğŸ”¢ åµŒå¥—æ·±åº¦æ§åˆ¶**
```sql
-- MySQLé»˜è®¤å…è®¸è§¦å‘å™¨åµŒå¥—æ·±åº¦ä¸º64å±‚
SHOW VARIABLES LIKE 'max_trigger_depth';

-- æ·±åº¦åµŒå¥—ç¤ºä¾‹ï¼ˆä¸æ¨èï¼‰
-- è¡¨Aåˆ é™¤ â†’ è§¦å‘å™¨åˆ é™¤è¡¨B â†’ è¡¨Bè§¦å‘å™¨åˆ é™¤è¡¨C â†’ ...
-- è¿™ç§æ·±å±‚åµŒå¥—å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜å’Œç»´æŠ¤å›°éš¾
```

### 4.4 äº‹åŠ¡æ€§é™åˆ¶


**ğŸ”„ äº‹åŠ¡ä¸­çš„DELETEé™åˆ¶**
```sql
DELIMITER $$
CREATE TRIGGER transaction_aware_delete
    AFTER DELETE ON orders
    FOR EACH ROW
BEGIN
    -- åœ¨è§¦å‘å™¨ä¸­ï¼Œæ‰€æœ‰æ“ä½œéƒ½åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
    -- å¦‚æœè¿™é‡Œçš„DELETEå¤±è´¥ï¼Œä¼šå¯¼è‡´åŸå§‹DELETEä¹Ÿå›æ»š
    
    -- åˆ é™¤è®¢å•æ˜ç»†ï¼ˆè¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºæ˜¯ä¸åŒçš„è¡¨ï¼‰
    DELETE FROM order_items WHERE order_id = OLD.id;
    
    -- åˆ é™¤ç›¸å…³çš„ä¼˜æƒ åˆ¸ä½¿ç”¨è®°å½•
    DELETE FROM coupon_usage WHERE order_id = OLD.id;
    
    -- å¦‚æœä¸Šé¢ä»»ä½•æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡ï¼ˆåŒ…æ‹¬åŸå§‹DELETEï¼‰éƒ½ä¼šå›æ»š
END$$
DELIMITER ;
```

### 4.5 æ€§èƒ½ç›¸å…³é™åˆ¶


**âš¡ é¿å…å¤æ‚æ“ä½œ**
```sql
-- âŒ é¿å…åœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå¤æ‚çš„DELETEæ“ä½œ
DELIMITER $$
CREATE TRIGGER slow_delete_trigger
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- é¿å…åœ¨è§¦å‘å™¨ä¸­æ‰§è¡Œå¤æ‚çš„å­æŸ¥è¯¢åˆ é™¤
    -- è¿™ä¼šä¸¥é‡å½±å“DELETEæ“ä½œçš„æ€§èƒ½
    /*
    DELETE FROM user_activities 
    WHERE user_id = OLD.id 
      AND activity_date < DATE_SUB(NOW(), INTERVAL 1 YEAR)
      AND activity_type IN (
          SELECT type FROM activity_types 
          WHERE category = 'temporary'
      );
    */
    
    -- âœ… æ›´å¥½çš„åšæ³•ï¼šè®°å½•åˆ°é˜Ÿåˆ—ï¼Œå¼‚æ­¥å¤„ç†
    INSERT INTO cleanup_queue (
        cleanup_type,
        target_table,
        target_id,
        cleanup_condition,
        priority,
        created_time
    ) VALUES (
        'USER_ACTIVITY_CLEANUP',
        'user_activities',
        OLD.id,
        CONCAT('user_id = ', OLD.id, ' AND activity_date < DATE_SUB(NOW(), INTERVAL 1 YEAR)'),
        'LOW',
        NOW()
    );
END$$
DELIMITER ;
```

### 4.6 æƒé™å’Œå®‰å…¨é™åˆ¶


**ğŸ” è§¦å‘å™¨æ‰§è¡Œæƒé™**
```sql
-- è§¦å‘å™¨ä»¥å®šä¹‰è€…ï¼ˆDEFINERï¼‰çš„æƒé™æ‰§è¡Œ
-- éœ€è¦ç¡®ä¿å®šä¹‰è€…æœ‰è¶³å¤Ÿçš„æƒé™æ‰§è¡ŒDELETEæ“ä½œ

-- æŸ¥çœ‹è§¦å‘å™¨çš„å®šä¹‰è€…
SELECT 
    TRIGGER_NAME,
    DEFINER,
    TRIGGER_SCHEMA,
    EVENT_OBJECT_TABLE
FROM information_schema.TRIGGERS 
WHERE TRIGGER_SCHEMA = DATABASE();

-- åˆ›å»ºæ—¶æŒ‡å®šå®šä¹‰è€…
DELIMITER $$
CREATE DEFINER = 'admin'@'localhost' TRIGGER secure_delete_trigger
    AFTER DELETE ON sensitive_data
    FOR EACH ROW
    SQL SECURITY DEFINER  -- ä½¿ç”¨å®šä¹‰è€…æƒé™
BEGIN
    -- è®°å½•æ•æ„Ÿæ•°æ®åˆ é™¤
    INSERT INTO security_audit_log (
        operation_type,
        table_name,
        record_id,
        operation_time,
        operator_user
    ) VALUES (
        'DELETE',
        'sensitive_data',
        OLD.id,
        NOW(),
        USER()
    );
    
    -- åˆ é™¤ç›¸å…³çš„æ•æ„Ÿæ–‡ä»¶è®°å½•ï¼ˆéœ€è¦adminæƒé™ï¼‰
    DELETE FROM sensitive_files WHERE data_id = OLD.id;
END$$
DELIMITER ;
```

---

## 5. ğŸ”„ çº§è”è§¦å‘å™¨æ‰§è¡Œé¡ºåº


### 5.1 è§¦å‘å™¨æ‰§è¡Œé¡ºåºè§„åˆ™


**ğŸ“‹ åŸºæœ¬æ‰§è¡Œé¡ºåº**
å½“ä¸€ä¸ªDELETEæ“ä½œæ¶‰åŠå¤šä¸ªè¡¨å’Œè§¦å‘å™¨æ—¶ï¼Œæ‰§è¡Œé¡ºåºéµå¾ªç‰¹å®šè§„åˆ™ï¼š

```
å•è¡¨å¤šè§¦å‘å™¨é¡ºåºï¼š
1. æ‰€æœ‰BEFORE DELETEè§¦å‘å™¨ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´é¡ºåºï¼‰
2. æ‰§è¡Œå®é™…çš„DELETEæ“ä½œ
3. æ‰€æœ‰AFTER DELETEè§¦å‘å™¨ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´é¡ºåºï¼‰

å¤šè¡¨çº§è”åˆ é™¤é¡ºåºï¼š
1. ä¸»è¡¨çš„BEFORE DELETEè§¦å‘å™¨
2. å­è¡¨çš„BEFORE DELETEè§¦å‘å™¨ï¼ˆå¦‚æœè§¦å‘å™¨ä¸­æœ‰DELETEï¼‰
3. å®é™…åˆ é™¤æ“ä½œï¼ˆä»å­è¡¨åˆ°ä¸»è¡¨ï¼‰
4. å­è¡¨çš„AFTER DELETEè§¦å‘å™¨
5. ä¸»è¡¨çš„AFTER DELETEè§¦å‘å™¨
```

### 5.2 åŒè¡¨å¤šè§¦å‘å™¨æ‰§è¡Œ


**ğŸ”¸ åˆ›å»ºå¤šä¸ªè§¦å‘å™¨ç¤ºä¾‹**
```sql
-- ç¬¬ä¸€ä¸ªBEFORE DELETEè§¦å‘å™¨ï¼ˆæƒé™æ£€æŸ¥ï¼‰
DELIMITER $$
CREATE TRIGGER user_delete_permission_check
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    -- æ£€æŸ¥åˆ é™¤æƒé™
    IF OLD.role = 'admin' AND USER() NOT LIKE '%admin%' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ç®¡ç†å‘˜ç”¨æˆ·';
    END IF;
END$$
DELIMITER ;

-- ç¬¬äºŒä¸ªBEFORE DELETEè§¦å‘å™¨ï¼ˆæ•°æ®å¤‡ä»½ï¼‰
DELIMITER $$
CREATE TRIGGER user_delete_backup
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    -- å¤‡ä»½ç”¨æˆ·æ•°æ®åˆ°å†å²è¡¨
    INSERT INTO users_history (
        original_id,
        username,
        email,
        role,
        deleted_time,
        deleted_by
    ) VALUES (
        OLD.id,
        OLD.username,
        OLD.email,
        OLD.role,
        NOW(),
        USER()
    );
END$$
DELIMITER ;

-- AFTER DELETEè§¦å‘å™¨ï¼ˆæ¸…ç†å·¥ä½œï¼‰
DELIMITER $$
CREATE TRIGGER user_delete_cleanup
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- æ¸…ç†ç›¸å…³æ•°æ®
    DELETE FROM user_sessions WHERE user_id = OLD.id;
    DELETE FROM user_preferences WHERE user_id = OLD.id;
    
    -- æ›´æ–°ç»Ÿè®¡
    UPDATE system_stats SET user_count = user_count - 1;
END$$
DELIMITER ;
```

**â±ï¸ æ‰§è¡Œé¡ºåºæ¼”ç¤º**
```
å½“æ‰§è¡Œ DELETE FROM users WHERE id = 1 æ—¶ï¼š

1. user_delete_permission_check æ‰§è¡Œï¼ˆæ£€æŸ¥æƒé™ï¼‰
2. user_delete_backup æ‰§è¡Œï¼ˆå¤‡ä»½æ•°æ®ï¼‰
3. å®é™…åˆ é™¤ users è¡¨ä¸­ id=1 çš„è®°å½•
4. user_delete_cleanup æ‰§è¡Œï¼ˆæ¸…ç†ç›¸å…³æ•°æ®ï¼‰

å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå›æ»š
```

### 5.3 è·¨è¡¨çº§è”è§¦å‘å™¨


**ğŸ”— çº§è”åˆ é™¤è§¦å‘å™¨é“¾**
```sql
-- ç”¨æˆ·è¡¨çš„DELETEè§¦å‘å™¨ï¼Œä¼šè§¦å‘è®¢å•çš„åˆ é™¤
DELIMITER $$
CREATE TRIGGER user_delete_cascade_orders
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    -- åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ï¼ˆè¿™ä¼šè§¦å‘è®¢å•è¡¨çš„DELETEè§¦å‘å™¨ï¼‰
    DELETE FROM orders WHERE user_id = OLD.id;
    
    -- è®°å½•çº§è”åˆ é™¤æ—¥å¿—
    INSERT INTO cascade_delete_log (
        parent_table,
        parent_id,
        child_table,
        operation_time
    ) VALUES (
        'users',
        OLD.id,
        'orders',
        NOW()
    );
END$$
DELIMITER ;

-- è®¢å•è¡¨çš„DELETEè§¦å‘å™¨ï¼Œä¼šè§¦å‘è®¢å•æ˜ç»†çš„åˆ é™¤
DELIMITER $$
CREATE TRIGGER order_delete_cascade_items
    BEFORE DELETE ON orders
    FOR EACH ROW
BEGIN
    -- åˆ é™¤è®¢å•çš„æ‰€æœ‰æ˜ç»†é¡¹
    DELETE FROM order_items WHERE order_id = OLD.id;
    
    -- åˆ é™¤è®¢å•ç›¸å…³çš„ä¼˜æƒ åˆ¸è®°å½•
    DELETE FROM order_coupons WHERE order_id = OLD.id;
    
    -- è®°å½•çº§è”åˆ é™¤
    INSERT INTO cascade_delete_log (
        parent_table,
        parent_id,
        child_table,
        operation_time
    ) VALUES (
        'orders',
        OLD.id,
        'order_items',
        NOW()
    );
END$$
DELIMITER ;

-- è®¢å•æ˜ç»†è¡¨çš„DELETEè§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER order_item_delete_update_inventory
    AFTER DELETE ON order_items
    FOR EACH ROW
BEGIN
    -- å¦‚æœè®¢å•æ˜ç»†è¢«åˆ é™¤ï¼Œæ¢å¤åº“å­˜
    UPDATE products 
    SET stock_quantity = stock_quantity + OLD.quantity
    WHERE id = OLD.product_id;
    
    -- è®°å½•åº“å­˜å˜åŠ¨
    INSERT INTO inventory_log (
        product_id,
        change_type,
        change_quantity,
        reference_type,
        reference_id,
        change_time
    ) VALUES (
        OLD.product_id,
        'RESTORE',
        OLD.quantity,
        'ORDER_ITEM_DELETE',
        OLD.id,
        NOW()
    );
END$$
DELIMITER ;
```

### 5.4 æ‰§è¡Œé¡ºåºå›¾ç¤º


**ğŸ”€ çº§è”è§¦å‘å™¨æ‰§è¡Œæµç¨‹**
```
æ‰§è¡Œ: DELETE FROM users WHERE id = 1

æ­¥éª¤1: usersè¡¨BEFORE DELETEè§¦å‘å™¨
   â”œâ”€ user_delete_cascade_orders å¼€å§‹æ‰§è¡Œ
   â”‚   â”œâ”€ DELETE FROM orders WHERE user_id = 1
   â”‚   â”‚   â”œâ”€ ordersè¡¨BEFORE DELETEè§¦å‘å™¨
   â”‚   â”‚   â”‚   â”œâ”€ order_delete_cascade_items å¼€å§‹æ‰§è¡Œ
   â”‚   â”‚   â”‚   â”‚   â”œâ”€ DELETE FROM order_items WHERE order_id IN (...)
   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€ order_itemsè¡¨AFTER DELETEè§¦å‘å™¨
   â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€ order_item_delete_update_inventory
   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€ å®é™…åˆ é™¤order_itemsè®°å½•
   â”‚   â”‚   â”‚   â”‚   â””â”€ DELETE FROM order_coupons WHERE order_id IN (...)
   â”‚   â”‚   â”‚   â””â”€ è®°å½•çº§è”åˆ é™¤æ—¥å¿—
   â”‚   â”‚   â””â”€ å®é™…åˆ é™¤ordersè®°å½•
   â”‚   â””â”€ è®°å½•çº§è”åˆ é™¤æ—¥å¿—

æ­¥éª¤2: å®é™…åˆ é™¤usersè¡¨è®°å½•

æ­¥éª¤3: usersè¡¨AFTER DELETEè§¦å‘å™¨ï¼ˆå¦‚æœæœ‰ï¼‰

æ•´ä¸ªè¿‡ç¨‹åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä»»ä½•æ­¥éª¤å¤±è´¥éƒ½ä¼šå¯¼è‡´å…¨éƒ¨å›æ»š
```

### 5.5 æ§åˆ¶æ‰§è¡Œé¡ºåº


**âš™ï¸ è§¦å‘å™¨é¡ºåºç®¡ç†**
```sql
-- MySQL 5.7.2+ æ”¯æŒæŒ‡å®šè§¦å‘å™¨æ‰§è¡Œé¡ºåº
DELIMITER $$
CREATE TRIGGER user_delete_priority_1
    BEFORE DELETE ON users
    FOR EACH ROW
    FOLLOWS user_delete_permission_check  -- åœ¨æŒ‡å®šè§¦å‘å™¨ä¹‹åæ‰§è¡Œ
BEGIN
    -- è¿™ä¸ªè§¦å‘å™¨ä¼šåœ¨ user_delete_permission_check ä¹‹åæ‰§è¡Œ
END$$
DELIMITER ;

-- æˆ–è€…ä½¿ç”¨ PRECEDES æŒ‡å®šåœ¨æŸä¸ªè§¦å‘å™¨ä¹‹å‰æ‰§è¡Œ
DELIMITER $$
CREATE TRIGGER user_delete_priority_first
    BEFORE DELETE ON users
    FOR EACH ROW
    PRECEDES user_delete_permission_check  -- åœ¨æŒ‡å®šè§¦å‘å™¨ä¹‹å‰æ‰§è¡Œ
BEGIN
    -- è¿™ä¸ªè§¦å‘å™¨ä¼šåœ¨ user_delete_permission_check ä¹‹å‰æ‰§è¡Œ
END$$
DELIMITER ;
```

**ğŸ“‹ æŸ¥çœ‹è§¦å‘å™¨æ‰§è¡Œé¡ºåº**
```sql
-- æŸ¥çœ‹è¡¨ä¸Šæ‰€æœ‰è§¦å‘å™¨çš„æ‰§è¡Œé¡ºåº
SELECT 
    TRIGGER_NAME,
    EVENT_MANIPULATION,
    ACTION_ORDER,
    ACTION_TIMING,
    CREATED
FROM information_schema.TRIGGERS 
WHERE EVENT_OBJECT_TABLE = 'users'
ORDER BY EVENT_MANIPULATION, ACTION_TIMING, ACTION_ORDER;
```

---

## 6. âš ï¸ è§¦å‘å™¨å¼‚å¸¸å¤„ç†


### 6.1 è§¦å‘å™¨å¼‚å¸¸å¤„ç†åŸºç¡€


**ğŸ’¡ å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§**
è§¦å‘å™¨ä¸­çš„å¼‚å¸¸å¤„ç†å†³å®šäº†DELETEæ“ä½œçš„æˆåŠŸä¸å¤±è´¥ï¼Œåˆç†çš„å¼‚å¸¸å¤„ç†å¯ä»¥ï¼š

```
ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼šå¼‚å¸¸æ—¶æ­£ç¡®å›æ»šæ“ä½œ
æä¾›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼šå‘ŠçŸ¥ç”¨æˆ·å…·ä½“çš„é”™è¯¯åŸå› 
è®°å½•é”™è¯¯æ—¥å¿—ï¼šä¾¿äºåç»­çš„é—®é¢˜æ’æŸ¥å’Œåˆ†æ
å®ç°ä¼˜é›…é™çº§ï¼šåœ¨éå…³é”®æ“ä½œå¤±è´¥æ—¶å…è®¸ä¸»æ“ä½œç»§ç»­
```

### 6.2 å¼‚å¸¸å¤„ç†è¯­æ³•


**ğŸ”§ DECLARE HANDLERè¯­æ³•**
```sql
-- å¼‚å¸¸å¤„ç†è¯­æ³•ç»“æ„
DECLARE handler_type HANDLER
    FOR condition_value [, condition_value] ...
    statement;

-- handler_type:
--   CONTINUE: å¤„ç†å¼‚å¸¸åç»§ç»­æ‰§è¡Œ
--   EXIT: å¤„ç†å¼‚å¸¸åé€€å‡ºå½“å‰ç¨‹åºå—
--   UNDO: æ’¤é”€æ“ä½œï¼ˆMySQLæš‚ä¸æ”¯æŒï¼‰

-- condition_value:
--   SQLSTATE [VALUE] sqlstate_value
--   condition_name
--   SQLWARNING | NOT FOUND | SQLEXCEPTION
--   mysql_error_code
```

### 6.3 å®Œæ•´çš„å¼‚å¸¸å¤„ç†ç¤ºä¾‹


**ğŸ›¡ï¸ ç»¼åˆå¼‚å¸¸å¤„ç†è§¦å‘å™¨**
```sql
DELIMITER $$
CREATE TRIGGER safe_user_delete_with_exception_handling
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_warning_message TEXT DEFAULT '';
    DECLARE v_continue BOOLEAN DEFAULT TRUE;
    
    -- å£°æ˜å¼‚å¸¸å¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR SQLWARNING
    BEGIN
        SET v_error_count = v_error_count + 1;
        SET v_warning_message = 'SQLè­¦å‘Šå‘ç”Ÿ';
        -- ç»§ç»­æ‰§è¡Œï¼Œä¸ä¸­æ–­è§¦å‘å™¨
    END;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND
    BEGIN
        SET v_error_count = v_error_count + 1;
        SET v_warning_message = 'æœªæ‰¾åˆ°ç›¸å…³è®°å½•';
        -- ç»§ç»­æ‰§è¡Œ
    END;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
        GET DIAGNOSTICS CONDITION 1
            @sqlstate = RETURNED_SQLSTATE,
            @errno = MYSQL_ERRNO,
            @text = MESSAGE_TEXT;
            
        INSERT INTO trigger_error_log (
            trigger_name,
            table_name,
            operation_type,
            error_sqlstate,
            error_code,
            error_message,
            record_id,
            error_time,
            user_context
        ) VALUES (
            'safe_user_delete_with_exception_handling',
            'users',
            'BEFORE DELETE',
            @sqlstate,
            @errno,
            @text,
            OLD.id,
            NOW(),
            USER()
        );
        
        -- é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢DELETEæ“ä½œ
        RESIGNAL SET MESSAGE_TEXT = CONCAT('åˆ é™¤ç”¨æˆ·å¤±è´¥: ', @text);
    END;
    
    -- ä¸»è¦ä¸šåŠ¡é€»è¾‘
    BEGIN
        -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ é™¤
        CALL check_user_can_be_deleted(OLD.id, v_continue);
        
        IF NOT v_continue THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'ç”¨æˆ·ä¸ç¬¦åˆåˆ é™¤æ¡ä»¶';
        END IF;
        
        -- å¤‡ä»½ç”¨æˆ·æ•°æ®ï¼ˆå¯èƒ½äº§ç”Ÿè­¦å‘Šï¼‰
        INSERT INTO users_backup (
            original_id,
            username,
            email,
            backup_time
        ) VALUES (
            OLD.id,
            OLD.username,
            OLD.email,
            NOW()
        );
        
        -- æ¸…ç†ç”¨æˆ·ä¼šè¯ï¼ˆå¯èƒ½è®°å½•ä¸å­˜åœ¨ï¼‰
        DELETE FROM user_sessions WHERE user_id = OLD.id;
        
        -- è®°å½•æˆåŠŸçš„åˆ é™¤å®¡è®¡
        INSERT INTO user_delete_audit (
            user_id,
            username,
            delete_time,
            delete_by,
            warning_count
        ) VALUES (
            OLD.id,
            OLD.username,
            NOW(),
            USER(),
            v_error_count
        );
        
    END;
    
    -- å¦‚æœæœ‰è­¦å‘Šï¼Œè®°å½•ä½†ä¸é˜»æ­¢åˆ é™¤
    IF v_error_count > 0 THEN
        INSERT INTO trigger_warning_log (
            trigger_name,
            table_name,
            record_id,
            warning_count,
            warning_message,
            warning_time
        ) VALUES (
            'safe_user_delete_with_exception_handling',
            'users',
            OLD.id,
            v_error_count,
            v_warning_message,
            NOW()
        );
    END IF;
    
END$$
DELIMITER ;
```

### 6.4 ç‰¹å®šå¼‚å¸¸å¤„ç†ç­–ç•¥


**ğŸ”¸ å¤„ç†çº¦æŸè¿åå¼‚å¸¸**
```sql
DELIMITER $$
CREATE TRIGGER handle_constraint_violations
    BEFORE DELETE ON orders
    FOR EACH ROW
BEGIN
    -- å£°æ˜çº¦æŸè¿åå¤„ç†å™¨
    DECLARE EXIT HANDLER FOR 1451  -- å¤–é”®çº¦æŸé”™è¯¯
    BEGIN
        INSERT INTO deletion_conflict_log (
            table_name,
            record_id,
            conflict_type,
            conflict_message,
            conflict_time
        ) VALUES (
            'orders',
            OLD.id,
            'FOREIGN_KEY_CONSTRAINT',
            'è®¢å•å­˜åœ¨å¤–é”®ä¾èµ–ï¼Œæ— æ³•ç›´æ¥åˆ é™¤',
            NOW()
        );
        
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'è®¢å•å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè¯·å…ˆå¤„ç†ç›¸å…³æ•°æ®',
            MYSQL_ERRNO = 1451;
    END;
    
    -- å°è¯•åˆ é™¤ç›¸å…³çš„è®¢å•æ˜ç»†
    DELETE FROM order_items WHERE order_id = OLD.id;
    
    -- åˆ é™¤ç›¸å…³çš„æ”¯ä»˜è®°å½•
    DELETE FROM order_payments WHERE order_id = OLD.id;
    
END$$
DELIMITER ;
```

**ğŸ”¸ å¤„ç†æ­»é”å¼‚å¸¸**
```sql
DELIMITER $$
CREATE TRIGGER handle_deadlock_retry
    AFTER DELETE ON inventory_transactions
    FOR EACH ROW
BEGIN
    DECLARE v_retry_count INT DEFAULT 0;
    DECLARE v_max_retries INT DEFAULT 3;
    DECLARE v_success BOOLEAN DEFAULT FALSE;
    
    -- æ­»é”å¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR 1213  -- æ­»é”é”™è¯¯
    BEGIN
        SET v_retry_count = v_retry_count + 1;
        
        IF v_retry_count <= v_max_retries THEN
            -- ç­‰å¾…éšæœºæ—¶é—´åé‡è¯•ï¼ˆæ¨¡æ‹Ÿï¼‰
            SELECT SLEEP(RAND() * 0.1);  -- 0-100mséšæœºç­‰å¾…
        ELSE
            -- è®°å½•æ­»é”æ—¥å¿—
            INSERT INTO deadlock_log (
                table_name,
                operation_type,
                record_id,
                retry_count,
                final_status,
                error_time
            ) VALUES (
                'inventory_transactions',
                'AFTER DELETE',
                OLD.id,
                v_retry_count,
                'FAILED',
                NOW()
            );
            
            -- é‡æ–°æŠ›å‡ºé”™è¯¯
            SIGNAL SQLSTATE '40001'
            SET MESSAGE_TEXT = 'åˆ é™¤æ“ä½œå‘ç”Ÿæ­»é”ï¼Œé‡è¯•å¤±è´¥';
        END IF;
    END;
    
    -- é‡è¯•å¾ªç¯
    retry_loop: WHILE v_retry_count <= v_max_retries AND NOT v_success DO
        BEGIN
            -- å°è¯•æ›´æ–°åº“å­˜
            UPDATE products 
            SET stock_quantity = stock_quantity + OLD.quantity_change
            WHERE id = OLD.product_id;
            
            SET v_success = TRUE;
        END;
    END WHILE;
    
    -- è®°å½•æˆåŠŸæ—¥å¿—
    IF v_success THEN
        INSERT INTO deadlock_log (
            table_name,
            operation_type,
            record_id,
            retry_count,
            final_status,
            error_time
        ) VALUES (
            'inventory_transactions',
            'AFTER DELETE',
            OLD.id,
            v_retry_count,
            'SUCCESS',
            NOW()
        );
    END IF;
    
END$$
DELIMITER ;
```

### 6.5 å¼‚å¸¸ä¿¡æ¯è·å–


**ğŸ” è·å–è¯¦ç»†å¼‚å¸¸ä¿¡æ¯**
```sql
DELIMITER $$
CREATE TRIGGER detailed_exception_info
    AFTER DELETE ON critical_data
    FOR EACH ROW
BEGIN
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        DECLARE v_sqlstate CHAR(5);
        DECLARE v_errno INT;
        DECLARE v_message TEXT;
        
        -- è·å–å¼‚å¸¸çš„è¯¦ç»†ä¿¡æ¯
        GET DIAGNOSTICS CONDITION 1
            v_sqlstate = RETURNED_SQLSTATE,
            v_errno = MYSQL_ERRNO,
            v_message = MESSAGE_TEXT;
        
        -- è®°å½•å®Œæ•´çš„å¼‚å¸¸ä¿¡æ¯
        INSERT INTO detailed_error_log (
            trigger_name,
            table_name,
            record_id,
            sql_state,
            error_number,
            error_message,
            mysql_user,
            connection_id,
            error_timestamp,
            old_data_json
        ) VALUES (
            'detailed_exception_info',
            'critical_data',
            OLD.id,
            v_sqlstate,
            v_errno,
            v_message,
            USER(),
            CONNECTION_ID(),
            NOW(),
            JSON_OBJECT(
                'id', OLD.id,
                'data_type', OLD.data_type,
                'content', OLD.content,
                'created_time', OLD.created_time
            )
        );
        
        -- å‘é€ç´§æ€¥é€šçŸ¥
        INSERT INTO urgent_notification_queue (
            notification_type,
            priority,
            subject,
            content,
            created_time
        ) VALUES (
            'CRITICAL_DATA_DELETE_ERROR',
            'URGENT',
            'å…³é”®æ•°æ®åˆ é™¤å¤±è´¥',
            CONCAT(
                'å…³é”®æ•°æ®åˆ é™¤è§¦å‘å™¨æ‰§è¡Œå¤±è´¥\n',
                'SQL State: ', v_sqlstate, '\n',
                'Error Code: ', v_errno, '\n',
                'Error Message: ', v_message, '\n',
                'Record ID: ', OLD.id, '\n',
                'User: ', USER()
            ),
            NOW()
        );
        
        -- é‡æ–°æŠ›å‡ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = CONCAT('å…³é”®æ•°æ®åˆ é™¤å¤±è´¥ï¼Œé”™è¯¯ä»£ç ï¼š', v_errno, 'ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    END;
    
    -- æ­£å¸¸çš„åˆ é™¤åå¤„ç†é€»è¾‘
    INSERT INTO critical_data_deletion_audit (
        deleted_id,
        deleted_content,
        deletion_time,
        deleted_by
    ) VALUES (
        OLD.id,
        OLD.content,
        NOW(),
        USER()
    );
    
END$$
DELIMITER ;
```

---

## 7. âš¡ DELETEè§¦å‘å™¨æ€§èƒ½å½±å“


### 7.1 è§¦å‘å™¨å¯¹DELETEæ€§èƒ½çš„å½±å“


**ğŸ’¡ æ€§èƒ½å½±å“åˆ†æ**
DELETEè§¦å‘å™¨ä¼šæ˜¾è‘—å½±å“åˆ é™¤æ“ä½œçš„æ€§èƒ½ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š

```
æ‰§è¡Œæ—¶é—´å¢åŠ ï¼š
- åŸæœ¬ç®€å•çš„DELETEå˜æˆå¤æ‚çš„äº‹åŠ¡æ“ä½œ
- è§¦å‘å™¨ä¸­çš„é€»è¾‘è¶Šå¤æ‚ï¼Œè€—æ—¶è¶Šé•¿

èµ„æºæ¶ˆè€—å¢åŠ ï¼š
- å†…å­˜ä½¿ç”¨ï¼šè§¦å‘å™¨éœ€è¦é¢å¤–å†…å­˜æ¥å­˜å‚¨OLDæ•°æ®
- CPUä½¿ç”¨ï¼šæ‰§è¡Œè§¦å‘å™¨é€»è¾‘éœ€è¦é¢å¤–CPUèµ„æº
- I/Oå¢åŠ ï¼šè§¦å‘å™¨ä¸­çš„INSERT/UPDATE/DELETEæ“ä½œ

é”çš„å½±å“ï¼š
- è§¦å‘å™¨å»¶é•¿äº†äº‹åŠ¡æ—¶é—´ï¼Œå¢åŠ äº†é”çš„æŒæœ‰æ—¶é—´
- å¯èƒ½å¯¼è‡´æ›´å¤šçš„é”ç­‰å¾…å’Œæ­»é”
```

### 7.2 æ€§èƒ½æµ‹è¯•å¯¹æ¯”


**ğŸ“Š æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**
```sql
-- æµ‹è¯•è¡¨ç»“æ„
CREATE TABLE performance_test_users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50),
    email VARCHAR(100),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO performance_test_users (username, email)
SELECT 
    CONCAT('user_', n),
    CONCAT('user_', n, '@example.com')
FROM (
    SELECT a.N + b.N * 10 + c.N * 100 + 1 n
    FROM 
    (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) a,
    (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) b,
    (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) c
) numbers
WHERE n <= 100000;
```

**â±ï¸ æ€§èƒ½æµ‹è¯•è„šæœ¬**
```sql
-- æ— è§¦å‘å™¨çš„DELETEæ€§èƒ½æµ‹è¯•
SET @start_time = NOW(6);
DELETE FROM performance_test_users WHERE id BETWEEN 1 AND 1000;
SET @end_time = NOW(6);
SELECT TIMESTAMPDIFF(MICROSECOND, @start_time, @end_time) AS microseconds_no_trigger;

-- åˆ›å»ºç®€å•è§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER simple_delete_trigger
    AFTER DELETE ON performance_test_users
    FOR EACH ROW
BEGIN
    INSERT INTO user_delete_log (user_id, delete_time)
    VALUES (OLD.id, NOW());
END$$
DELIMITER ;

-- æœ‰ç®€å•è§¦å‘å™¨çš„DELETEæ€§èƒ½æµ‹è¯•
SET @start_time = NOW(6);
DELETE FROM performance_test_users WHERE id BETWEEN 1001 AND 2000;
SET @end_time = NOW(6);
SELECT TIMESTAMPDIFF(MICROSECOND, @start_time, @end_time) AS microseconds_simple_trigger;

-- åˆ›å»ºå¤æ‚è§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER complex_delete_trigger
    AFTER DELETE ON performance_test_users
    FOR EACH ROW
BEGIN
    -- å¤æ‚çš„ä¸šåŠ¡é€»è¾‘æ¨¡æ‹Ÿ
    INSERT INTO user_audit_log (user_id, username, operation, operation_time)
    VALUES (OLD.id, OLD.username, 'DELETE', NOW());
    
    UPDATE user_statistics 
    SET total_users = total_users - 1,
        last_update = NOW()
    WHERE stat_date = CURDATE();
    
    DELETE FROM user_cache WHERE user_id = OLD.id;
    
    INSERT INTO notification_queue (type, message, created_time)
    VALUES ('USER_DELETED', CONCAT('User ', OLD.username, ' was deleted'), NOW());
END$$
DELIMITER ;

-- æœ‰å¤æ‚è§¦å‘å™¨çš„DELETEæ€§èƒ½æµ‹è¯•
SET @start_time = NOW(6);
DELETE FROM performance_test_users WHERE id BETWEEN 2001 AND 3000;
SET @end_time = NOW(6);
SELECT TIMESTAMPDIFF(MICROSECOND, @start_time, @end_time) AS microseconds_complex_trigger;
```

### 7.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸš€ è§¦å‘å™¨æ€§èƒ½ä¼˜åŒ–æ–¹æ³•**

**ğŸ”¸ å‡å°‘è§¦å‘å™¨å¤æ‚åº¦**
```sql
-- âŒ ä½æ•ˆçš„è§¦å‘å™¨ï¼šå¤æ‚æŸ¥è¯¢å’Œå¤šæ¬¡æ•°æ®åº“æ“ä½œ
DELIMITER $$
CREATE TRIGGER inefficient_delete_trigger
    AFTER DELETE ON orders
    FOR EACH ROW
BEGIN
    -- å¤æ‚çš„å­æŸ¥è¯¢ï¼Œæ€§èƒ½å·®
    UPDATE customer_statistics 
    SET total_orders = (
        SELECT COUNT(*) FROM orders WHERE customer_id = OLD.customer_id
    ),
    total_amount = (
        SELECT COALESCE(SUM(total_amount), 0) 
        FROM orders 
        WHERE customer_id = OLD.customer_id
    )
    WHERE customer_id = OLD.customer_id;
    
    -- å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢
    IF (SELECT COUNT(*) FROM orders WHERE customer_id = OLD.customer_id) = 0 THEN
        UPDATE customers SET has_orders = 0 WHERE id = OLD.customer_id;
    END IF;
END$$
DELIMITER ;

-- âœ… é«˜æ•ˆçš„è§¦å‘å™¨ï¼šç®€å•çš„å¢é‡æ›´æ–°
DELIMITER $$
CREATE TRIGGER efficient_delete_trigger
    AFTER DELETE ON orders
    FOR EACH ROW
BEGIN
    -- ç®€å•çš„å¢é‡æ›´æ–°ï¼Œæ€§èƒ½å¥½
    UPDATE customer_statistics 
    SET total_orders = total_orders - 1,
        total_amount = total_amount - OLD.total_amount,
        last_update = NOW()
    WHERE customer_id = OLD.customer_id;
    
    -- åªåœ¨å¿…è¦æ—¶æ£€æŸ¥
    IF OLD.customer_id IS NOT NULL THEN
        UPDATE customers 
        SET has_orders = CASE 
            WHEN (SELECT COUNT(*) FROM orders WHERE customer_id = OLD.customer_id LIMIT 1) > 0 
            THEN 1 ELSE 0 
        END
        WHERE id = OLD.customer_id;
    END IF;
END$$
DELIMITER ;
```

**ğŸ”¸ ä½¿ç”¨å¼‚æ­¥å¤„ç†**
```sql
-- å°†è€—æ—¶æ“ä½œæ”¾åˆ°é˜Ÿåˆ—ä¸­å¼‚æ­¥å¤„ç†
DELIMITER $$
CREATE TRIGGER async_delete_trigger
    AFTER DELETE ON users
    FOR EACH ROW
BEGIN
    -- åªè®°å½•éœ€è¦å¤„ç†çš„ä»»åŠ¡ï¼Œä¸ç›´æ¥æ‰§è¡Œè€—æ—¶æ“ä½œ
    INSERT INTO async_task_queue (
        task_type,
        task_data,
        priority,
        created_time,
        status
    ) VALUES (
        'USER_DELETE_CLEANUP',
        JSON_OBJECT(
            'user_id', OLD.id,
            'username', OLD.username,
            'email', OLD.email
        ),
        'NORMAL',
        NOW(),
        'PENDING'
    );
    
    -- åªåšå¿…è¦çš„åŒæ­¥æ“ä½œ
    INSERT INTO user_delete_audit (
        user_id,
        delete_time,
        deleted_by
    ) VALUES (
        OLD.id,
        NOW(),
        USER()
    );
END$$
DELIMITER ;
```

**ğŸ”¸ æ‰¹é‡æ“ä½œä¼˜åŒ–**
```sql
-- å¯¹äºæ‰¹é‡DELETEï¼Œä¼˜åŒ–è§¦å‘å™¨é€»è¾‘
DELIMITER $$
CREATE TRIGGER batch_optimized_delete_trigger
    AFTER DELETE ON order_items
    FOR EACH ROW
BEGIN
    DECLARE v_batch_size INT DEFAULT 100;
    DECLARE v_current_batch INT;
    
    -- è·å–å½“å‰æ‰¹æ¬¡ç¼–å·ï¼ˆåŸºäºè¿æ¥IDå’Œæ—¶é—´æˆ³ï¼‰
    SET v_current_batch = CONNECTION_ID() * 1000 + UNIX_TIMESTAMP() % 1000;
    
    -- å°†æ›´æ–°æ“ä½œæ‰¹é‡åŒ–
    INSERT INTO batch_update_queue (
        batch_id,
        operation_type,
        table_name,
        update_data,
        created_time
    ) VALUES (
        v_current_batch,
        'INVENTORY_UPDATE',
        'products',
        JSON_OBJECT(
            'product_id', OLD.product_id,
            'quantity_change', OLD.quantity
        ),
        NOW()
    ) ON DUPLICATE KEY UPDATE
        update_data = JSON_MERGE_PATCH(
            update_data,
            JSON_OBJECT(
                'total_quantity', 
                JSON_EXTRACT(update_data, '$.total_quantity') + OLD.quantity
            )
        );
END$$
DELIMITER ;
```

### 7.4 æ€§èƒ½ç›‘æ§


**ğŸ“Š è§¦å‘å™¨æ€§èƒ½ç›‘æ§æŸ¥è¯¢**
```sql
-- æŸ¥çœ‹è§¦å‘å™¨æ‰§è¡Œç»Ÿè®¡ï¼ˆMySQL 5.7+ï¼‰
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    COUNT_EXECUTE,
    SUM_TIMER_EXECUTE / 1000000000000 AS total_exec_time_sec,
    AVG_TIMER_EXECUTE / 1000000000000 AS avg_exec_time_sec,
    MAX_TIMER_EXECUTE / 1000000000000 AS max_exec_time_sec
FROM performance_schema.events_statements_summary_by_digest
WHERE OBJECT_TYPE = 'TRIGGER'
ORDER BY SUM_TIMER_EXECUTE DESC;

-- æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„è§¦å‘å™¨
SELECT 
    THREAD_ID,
    EVENT_ID,
    OBJECT_SCHEMA,
    OBJECT_NAME,
    TIMER_WAIT / 1000000000000 AS exec_time_sec,
    SQL_TEXT
FROM performance_schema.events_statements_current
WHERE OBJECT_TYPE = 'TRIGGER';

-- ç›‘æ§è§¦å‘å™¨å¯¼è‡´çš„é”ç­‰å¾…
SELECT 
    waiting_thread.PROCESSLIST_ID AS waiting_connection,
    waiting_lock.LOCK_TYPE,
    waiting_lock.LOCK_MODE,
    waiting_lock.LOCK_STATUS,
    blocking_thread.PROCESSLIST_ID AS blocking_connection,
    blocking_lock.LOCK_TYPE,
    blocking_lock.LOCK_MODE,
    blocking_lock.LOCK_STATUS
FROM performance_schema.data_lock_waits dlw
JOIN performance_schema.data_locks waiting_lock ON dlw.REQUESTING_ENGINE_LOCK_ID = waiting_lock.ENGINE_LOCK_ID
JOIN performance_schema.data_locks blocking_lock ON dlw.BLOCKING_ENGINE_LOCK_ID = blocking_lock.ENGINE_LOCK_ID
JOIN performance_schema.threads waiting_thread ON waiting_lock.ENGINE_TRANSACTION_ID = waiting_thread.PROCESSLIST_ID
JOIN performance_schema.threads blocking_thread ON blocking_lock.ENGINE_TRANSACTION_ID = blocking_thread.PROCESSLIST_ID;
```

### 7.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


**ğŸ¯ ä¼˜åŒ–å»ºè®®æ€»ç»“**
```
è®¾è®¡åŸåˆ™ï¼š
âœ“ è§¦å‘å™¨é€»è¾‘å°½é‡ç®€å•
âœ“ é¿å…å¤æ‚çš„å­æŸ¥è¯¢å’Œè¿æ¥
âœ“ ä½¿ç”¨å¢é‡æ›´æ–°è€Œä¸æ˜¯é‡æ–°è®¡ç®—
âœ“ è€ƒè™‘ä½¿ç”¨å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ

ä»£ç ä¼˜åŒ–ï¼š
âœ“ å‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°
âœ“ ä½¿ç”¨é€‚å½“çš„ç´¢å¼•
âœ“ é¿å…ä¸å¿…è¦çš„æ•°æ®ç±»å‹è½¬æ¢
âœ“ åˆç†ä½¿ç”¨æ‰¹é‡æ“ä½œ

ç›‘æ§å’Œç»´æŠ¤ï¼š
âœ“ å®šæœŸç›‘æ§è§¦å‘å™¨æ€§èƒ½
âœ“ è¯†åˆ«å’Œä¼˜åŒ–æ…¢é€Ÿè§¦å‘å™¨
âœ“ åœ¨é«˜å³°æœŸå…³æ³¨è§¦å‘å™¨å¯¹ç³»ç»Ÿçš„å½±å“
âœ“ å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ä¸å¿…è¦çš„è§¦å‘å™¨
```

---

## 8. ğŸ”§ è§¦å‘å™¨è°ƒè¯•ä¸ç›‘æ§


### 8.1 è§¦å‘å™¨è°ƒè¯•åŸºç¡€


**ğŸ’¡ è°ƒè¯•çš„æŒ‘æˆ˜**
è§¦å‘å™¨è°ƒè¯•æ¯”æ™®é€šå­˜å‚¨è¿‡ç¨‹æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºï¼š

```
è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œï¼šæ— æ³•åƒå­˜å‚¨è¿‡ç¨‹é‚£æ ·æ‰‹åŠ¨è°ƒç”¨
æ‰§è¡Œç¯å¢ƒå¤æ‚ï¼šåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¯èƒ½æ¶‰åŠå¤šä¸ªè¡¨
é”™è¯¯ä¿¡æ¯æœ‰é™ï¼šé”™è¯¯ä¿¡æ¯å¯èƒ½ä¸å¤Ÿè¯¦ç»†
è°ƒè¯•å·¥å…·é™åˆ¶ï¼šå¤§éƒ¨åˆ†IDEå¯¹è§¦å‘å™¨è°ƒè¯•æ”¯æŒæœ‰é™
```

### 8.2 è°ƒè¯•æ–¹æ³•å’ŒæŠ€å·§


**ğŸ” ä½¿ç”¨æ—¥å¿—è¡¨è°ƒè¯•**
```sql
-- åˆ›å»ºä¸“é—¨çš„è°ƒè¯•æ—¥å¿—è¡¨
CREATE TABLE trigger_debug_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trigger_name VARCHAR(64),
    table_name VARCHAR(64),
    operation_type VARCHAR(20),
    step_name VARCHAR(100),
    step_data TEXT,
    debug_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    connection_id INT,
    user_name VARCHAR(100)
);

-- å¸¦è°ƒè¯•åŠŸèƒ½çš„è§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER debuggable_user_delete_trigger
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    DECLARE v_debug_enabled BOOLEAN DEFAULT TRUE;
    DECLARE v_step_counter INT DEFAULT 0;
    
    -- è°ƒè¯•æ—¥å¿—å‡½æ•°
    -- è®°å½•è°ƒè¯•æ­¥éª¤
    IF v_debug_enabled THEN
        SET v_step_counter = v_step_counter + 1;
        INSERT INTO trigger_debug_log (
            trigger_name,
            table_name,
            operation_type,
            step_name,
            step_data,
            connection_id,
            user_name
        ) VALUES (
            'debuggable_user_delete_trigger',
            'users',
            'BEFORE DELETE',
            CONCAT('STEP_', v_step_counter, '_START'),
            JSON_OBJECT(
                'user_id', OLD.id,
                'username', OLD.username,
                'role', OLD.role
            ),
            CONNECTION_ID(),
            USER()
        );
    END IF;
    
    -- æ­¥éª¤1ï¼šæƒé™æ£€æŸ¥
    BEGIN
        DECLARE v_can_delete BOOLEAN DEFAULT FALSE;
        
        IF OLD.role != 'admin' OR USER() LIKE '%admin%' THEN
            SET v_can_delete = TRUE;
        END IF;
        
        IF v_debug_enabled THEN
            SET v_step_counter = v_step_counter + 1;
            INSERT INTO trigger_debug_log (
                trigger_name, table_name, operation_type,
                step_name, step_data, connection_id, user_name
            ) VALUES (
                'debuggable_user_delete_trigger', 'users', 'BEFORE DELETE',
                CONCAT('STEP_', v_step_counter, '_PERMISSION_CHECK'),
                JSON_OBJECT('can_delete', v_can_delete, 'user_role', OLD.role),
                CONNECTION_ID(), USER()
            );
        END IF;
        
        IF NOT v_can_delete THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = 'æƒé™ä¸è¶³ï¼šæ— æ³•åˆ é™¤ç®¡ç†å‘˜ç”¨æˆ·';
        END IF;
    END;
    
    -- æ­¥éª¤2ï¼šä¾èµ–æ£€æŸ¥
    BEGIN
        DECLARE v_order_count INT DEFAULT 0;
        
        SELECT COUNT(*) INTO v_order_count
        FROM orders 
        WHERE user_id = OLD.id AND status IN ('pending', 'processing');
        
        IF v_debug_enabled THEN
            SET v_step_counter = v_step_counter + 1;
            INSERT INTO trigger_debug_log (
                trigger_name, table_name, operation_type,
                step_name, step_data, connection_id, user_name
            ) VALUES (
                'debuggable_user_delete_trigger', 'users', 'BEFORE DELETE',
                CONCAT('STEP_', v_step_counter, '_DEPENDENCY_CHECK'),
                JSON_OBJECT('pending_orders', v_order_count),
                CONNECTION_ID(), USER()
            );
        END IF;
        
        IF v_order_count > 0 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = CONCAT('ç”¨æˆ·æœ‰ ', v_order_count, ' ä¸ªæœªå®Œæˆè®¢å•');
        END IF;
    END;
    
    -- æ­¥éª¤3ï¼šæ•°æ®å¤‡ä»½
    BEGIN
        INSERT INTO users_backup (
            original_id, username, email, role, backup_time
        ) VALUES (
            OLD.id, OLD.username, OLD.email, OLD.role, NOW()
        );
        
        IF v_debug_enabled THEN
            SET v_step_counter = v_step_counter + 1;
            INSERT INTO trigger_debug_log (
                trigger_name, table_name, operation_type,
                step_name, step_data, connection_id, user_name
            ) VALUES (
                'debuggable_user_delete_trigger', 'users', 'BEFORE DELETE',
                CONCAT('STEP_', v_step_counter, '_BACKUP_COMPLETE'),
                JSON_OBJECT('backup_id', LAST_INSERT_ID()),
                CONNECTION_ID(), USER()
            );
        END IF;
    END;
    
    -- è®°å½•è§¦å‘å™¨å®Œæˆ
    IF v_debug_enabled THEN
        INSERT INTO trigger_debug_log (
            trigger_name, table_name, operation_type,
            step_name, step_data, connection_id, user_name
        ) VALUES (
            'debuggable_user_delete_trigger', 'users', 'BEFORE DELETE',
            'TRIGGER_COMPLETED',
            JSON_OBJECT('total_steps', v_step_counter),
            CONNECTION_ID(), USER()
        );
    END IF;
    
END$$
DELIMITER ;
```

### 8.3 è§¦å‘å™¨ç›‘æ§ç³»ç»Ÿ


**ğŸ“Š åˆ›å»ºç›‘æ§è§†å›¾**
```sql
-- è§¦å‘å™¨æ‰§è¡Œç»Ÿè®¡è§†å›¾
CREATE VIEW trigger_execution_stats AS
SELECT 
    trigger_name,
    table_name,
    operation_type,
    COUNT(*) as execution_count,
    DATE(debug_time) as execution_date,
    MIN(debug_time) as first_execution,
    MAX(debug_time) as last_execution,
    COUNT(DISTINCT connection_id) as unique_connections
FROM trigger_debug_log
WHERE step_name = 'TRIGGER_COMPLETED'
GROUP BY trigger_name, table_name, operation_type, DATE(debug_time);

-- è§¦å‘å™¨é”™è¯¯ç»Ÿè®¡è§†å›¾
CREATE VIEW trigger_error_stats AS
SELECT 
    DATE(error_time) as error_date,
    trigger_name,
    table_name,
    operation_type,
    COUNT(*) as error_count,
    COUNT(DISTINCT error_code) as unique_error_types,
    GROUP_CONCAT(DISTINCT error_message SEPARATOR '; ') as error_messages
FROM trigger_error_log
GROUP BY DATE(error_time), trigger_name, table_name, operation_type;

-- è§¦å‘å™¨æ€§èƒ½åˆ†æè§†å›¾  
CREATE VIEW trigger_performance_analysis AS
SELECT 
    tl1.trigger_name,
    tl1.table_name,
    COUNT(*) as execution_count,
    AVG(TIMESTAMPDIFF(MICROSECOND, tl1.debug_time, tl2.debug_time)) as avg_execution_time_microseconds,
    MAX(TIMESTAMPDIFF(MICROSECOND, tl1.debug_time, tl2.debug_time)) as max_execution_time_microseconds,
    MIN(TIMESTAMPDIFF(MICROSECOND, tl1.debug_time, tl2.debug_time)) as min_execution_time_microseconds
FROM trigger_debug_log tl1
JOIN trigger_debug_log tl2 ON tl1.connection_id = tl2.connection_id 
                            AND tl1.trigger_name = tl2.trigger_name
                            AND tl1.step_name LIKE '%_START'
                            AND tl2.step_name = 'TRIGGER_COMPLETED'
                            AND tl1.debug_time < tl2.debug_time
GROUP BY tl1.trigger_name, tl1.table_name;
```

### 8.4 å®æ—¶ç›‘æ§æŸ¥è¯¢


**ğŸ” è§¦å‘å™¨çŠ¶æ€ç›‘æ§**
```sql
-- æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„è§¦å‘å™¨
SELECT 
    tdl.trigger_name,
    tdl.table_name,
    tdl.operation_type,
    tdl.step_name,
    TIMESTAMPDIFF(SECOND, tdl.debug_time, NOW()) as seconds_running,
    tdl.connection_id,
    p.USER as mysql_user,
    p.HOST,
    p.DB as database_name,
    p.COMMAND,
    p.STATE
FROM trigger_debug_log tdl
JOIN information_schema.PROCESSLIST p ON tdl.connection_id = p.ID
WHERE tdl.step_name LIKE '%_START'
  AND NOT EXISTS (
      SELECT 1 FROM trigger_debug_log tdl2 
      WHERE tdl2.connection_id = tdl.connection_id
        AND tdl2.trigger_name = tdl.trigger_name
        AND tdl2.step_name = 'TRIGGER_COMPLETED'
        AND tdl2.debug_time > tdl.debug_time
  )
ORDER BY tdl.debug_time;

-- æŸ¥çœ‹è§¦å‘å™¨æ‰§è¡Œé¢‘ç‡ï¼ˆæœ€è¿‘1å°æ—¶ï¼‰
SELECT 
    trigger_name,
    table_name,
    operation_type,
    COUNT(*) as executions_last_hour,
    AVG(TIMESTAMPDIFF(MICROSECOND, debug_time, NOW())) / 1000000 as avg_response_time_sec
FROM trigger_debug_log
WHERE debug_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
  AND step_name = 'TRIGGER_COMPLETED'
GROUP BY trigger_name, table_name, operation_type
ORDER BY executions_last_hour DESC;

-- æŸ¥çœ‹è§¦å‘å™¨æ‰§è¡Œå¼‚å¸¸æƒ…å†µ
SELECT 
    DATE(error_time) as error_date,
    HOUR(error_time) as error_hour,
    trigger_name,
    table_name,
    COUNT(*) as error_count,
    GROUP_CONCAT(DISTINCT SUBSTRING(error_message, 1, 100) SEPARATOR '; ') as error_summary
FROM trigger_error_log
WHERE error_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY DATE(error_time), HOUR(error_time), trigger_name, table_name
ORDER BY error_date DESC, error_hour DESC, error_count DESC;
```

### 8.5 è°ƒè¯•å·¥å…·å’Œæ–¹æ³•


**ğŸ› ï¸ å®ç”¨è°ƒè¯•æŠ€å·§**
```sql
-- æŠ€å·§1ï¼šæ¡ä»¶è°ƒè¯•å¼€å…³
DELIMITER $
CREATE TRIGGER conditional_debug_trigger
    AFTER DELETE ON products
    FOR EACH ROW
BEGIN
    DECLARE v_debug_mode BOOLEAN DEFAULT FALSE;
    
    -- åªæœ‰åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ‰è®°å½•è¯¦ç»†æ—¥å¿—
    SELECT enable_debug INTO v_debug_mode 
    FROM system_settings 
    WHERE setting_name = 'trigger_debug_mode';
    
    IF v_debug_mode THEN
        INSERT INTO trigger_debug_log (
            trigger_name, table_name, operation_type,
            step_name, step_data, connection_id, user_name
        ) VALUES (
            'conditional_debug_trigger', 'products', 'AFTER DELETE',
            'PRODUCT_DELETE_DEBUG',
            JSON_OBJECT(
                'product_id', OLD.id,
                'product_name', OLD.name,
                'stock_before_delete', OLD.stock_quantity
            ),
            CONNECTION_ID(), USER()
        );
    END IF;
    
    -- æ­£å¸¸çš„è§¦å‘å™¨é€»è¾‘
    UPDATE inventory_summary 
    SET total_products = total_products - 1
    WHERE category_id = OLD.category_id;
    
END$
DELIMITER ;

-- æŠ€å·§2ï¼šåˆ†æ­¥éª¤éªŒè¯
-- å¯ä»¥ä¸´æ—¶åˆ›å»ºç®€åŒ–ç‰ˆæœ¬çš„è§¦å‘å™¨æ¥æµ‹è¯•ç‰¹å®šé€»è¾‘
DELIMITER $
CREATE TRIGGER test_step_by_step
    BEFORE DELETE ON test_table
    FOR EACH ROW
BEGIN
    -- åªæµ‹è¯•ç¬¬ä¸€æ­¥é€»è¾‘
    INSERT INTO test_results (step_name, result_data, test_time)
    VALUES ('STEP_1_VALIDATION', 
            JSON_OBJECT('old_id', OLD.id, 'validation_result', 'OK'),
            NOW());
    
    -- å…¶ä»–æ­¥éª¤æ³¨é‡Šæ‰ï¼Œé€æ­¥å–æ¶ˆæ³¨é‡Šæµ‹è¯•
    -- CALL complex_business_logic(OLD.id);
    -- UPDATE related_table SET status = 'updated';
END$
DELIMITER ;
```

### 8.6 ç›‘æ§ç³»ç»Ÿè®¾è®¡


**ğŸ“Š å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿ**
```sql
-- è§¦å‘å™¨æ€§èƒ½ç›‘æ§å­˜å‚¨è¿‡ç¨‹
DELIMITER $
CREATE PROCEDURE MonitorTriggerPerformance()
BEGIN
    -- åˆ›å»ºä¸´æ—¶è¡¨å­˜å‚¨ç›‘æ§ç»“æœ
    CREATE TEMPORARY TABLE temp_trigger_monitor (
        trigger_name VARCHAR(64),
        table_name VARCHAR(64),
        operation_type VARCHAR(20),
        avg_execution_time_ms DECIMAL(10,3),
        max_execution_time_ms DECIMAL(10,3),
        execution_count INT,
        error_count INT,
        error_rate DECIMAL(5,2),
        last_execution TIMESTAMP,
        status VARCHAR(20)
    );
    
    -- æ’å…¥æ€§èƒ½æ•°æ®
    INSERT INTO temp_trigger_monitor
    SELECT 
        tpa.trigger_name,
        tpa.table_name,
        'DELETE' as operation_type,
        tpa.avg_execution_time_microseconds / 1000 as avg_execution_time_ms,
        tpa.max_execution_time_microseconds / 1000 as max_execution_time_ms,
        tpa.execution_count,
        COALESCE(tes.error_count, 0) as error_count,
        CASE 
            WHEN tpa.execution_count > 0 THEN 
                (COALESCE(tes.error_count, 0) * 100.0 / tpa.execution_count)
            ELSE 0 
        END as error_rate,
        tpa.last_execution,
        CASE 
            WHEN tpa.avg_execution_time_microseconds > 1000000 THEN 'SLOW'
            WHEN COALESCE(tes.error_count, 0) * 100.0 / NULLIF(tpa.execution_count, 0) > 5 THEN 'HIGH_ERROR'
            WHEN tpa.execution_count = 0 THEN 'INACTIVE'
            ELSE 'NORMAL'
        END as status
    FROM (
        SELECT 
            trigger_name, table_name,
            AVG(TIMESTAMPDIFF(MICROSECOND, start_time.debug_time, end_time.debug_time)) as avg_execution_time_microseconds,
            MAX(TIMESTAMPDIFF(MICROSECOND, start_time.debug_time, end_time.debug_time)) as max_execution_time_microseconds,
            COUNT(*) as execution_count,
            MAX(end_time.debug_time) as last_execution
        FROM trigger_debug_log start_time
        JOIN trigger_debug_log end_time ON start_time.connection_id = end_time.connection_id
                                       AND start_time.trigger_name = end_time.trigger_name
                                       AND start_time.step_name LIKE '%_START'
                                       AND end_time.step_name = 'TRIGGER_COMPLETED'
                                       AND start_time.debug_time < end_time.debug_time
        WHERE start_time.debug_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
        GROUP BY start_time.trigger_name, start_time.table_name
    ) tpa
    LEFT JOIN (
        SELECT 
            trigger_name, table_name, operation_type,
            COUNT(*) as error_count
        FROM trigger_error_log
        WHERE error_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
        GROUP BY trigger_name, table_name, operation_type
    ) tes ON tpa.trigger_name = tes.trigger_name AND tpa.table_name = tes.table_name;
    
    -- æ˜¾ç¤ºç›‘æ§ç»“æœ
    SELECT * FROM temp_trigger_monitor ORDER BY avg_execution_time_ms DESC;
    
    -- æ¸…ç†ä¸´æ—¶è¡¨
    DROP TEMPORARY TABLE temp_trigger_monitor;
    
END$
DELIMITER ;

-- è§¦å‘å™¨å¥åº·æ£€æŸ¥å­˜å‚¨è¿‡ç¨‹
DELIMITER $
CREATE PROCEDURE TriggerHealthCheck()
BEGIN
    DECLARE done BOOLEAN DEFAULT FALSE;
    DECLARE v_trigger_name VARCHAR(64);
    DECLARE v_table_name VARCHAR(64);
    DECLARE v_last_execution TIMESTAMP;
    DECLARE v_error_count INT;
    
    -- æ¸¸æ ‡å£°æ˜
    DECLARE trigger_cursor CURSOR FOR
        SELECT TRIGGER_NAME, EVENT_OBJECT_TABLE
        FROM information_schema.TRIGGERS 
        WHERE TRIGGER_SCHEMA = DATABASE()
          AND EVENT_MANIPULATION = 'DELETE';
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- åˆ›å»ºå¥åº·æ£€æŸ¥ç»“æœè¡¨
    CREATE TEMPORARY TABLE temp_health_check (
        trigger_name VARCHAR(64),
        table_name VARCHAR(64),
        last_execution TIMESTAMP,
        recent_errors INT,
        health_status VARCHAR(20),
        recommendations TEXT
    );
    
    OPEN trigger_cursor;
    
    trigger_loop: LOOP
        FETCH trigger_cursor INTO v_trigger_name, v_table_name;
        IF done THEN LEAVE trigger_loop; END IF;
        
        -- è·å–æœ€è¿‘æ‰§è¡Œæ—¶é—´
        SELECT MAX(debug_time) INTO v_last_execution
        FROM trigger_debug_log 
        WHERE trigger_name = v_trigger_name;
        
        -- è·å–æœ€è¿‘é”™è¯¯æ•°é‡
        SELECT COUNT(*) INTO v_error_count
        FROM trigger_error_log 
        WHERE trigger_name = v_trigger_name
          AND error_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR);
        
        -- æ’å…¥å¥åº·æ£€æŸ¥ç»“æœ
        INSERT INTO temp_health_check VALUES (
            v_trigger_name,
            v_table_name,
            v_last_execution,
            v_error_count,
            CASE 
                WHEN v_error_count > 10 THEN 'CRITICAL'
                WHEN v_error_count > 3 THEN 'WARNING'  
                WHEN v_last_execution IS NULL THEN 'INACTIVE'
                WHEN v_last_execution < DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 'STALE'
                ELSE 'HEALTHY'
            END,
            CASE 
                WHEN v_error_count > 10 THEN 'è§¦å‘å™¨é”™è¯¯é¢‘ç¹ï¼Œéœ€è¦ç«‹å³æ£€æŸ¥'
                WHEN v_error_count > 3 THEN 'è§¦å‘å™¨æœ‰å¤šæ¬¡é”™è¯¯ï¼Œå»ºè®®å®¡æŸ¥é€»è¾‘'
                WHEN v_last_execution IS NULL THEN 'è§¦å‘å™¨ä»æœªæ‰§è¡Œï¼Œå¯èƒ½é…ç½®æœ‰é—®é¢˜'
                WHEN v_last_execution < DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 'è§¦å‘å™¨é•¿æ—¶é—´æœªæ‰§è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æ­£å¸¸'
                ELSE 'è§¦å‘å™¨è¿è¡Œæ­£å¸¸'
            END
        );
        
    END LOOP;
    
    CLOSE trigger_cursor;
    
    -- æ˜¾ç¤ºå¥åº·æ£€æŸ¥ç»“æœ
    SELECT * FROM temp_health_check ORDER BY 
        CASE health_status 
            WHEN 'CRITICAL' THEN 1
            WHEN 'WARNING' THEN 2  
            WHEN 'STALE' THEN 3
            WHEN 'INACTIVE' THEN 4
            ELSE 5
        END;
    
    DROP TEMPORARY TABLE temp_health_check;
    
END$
DELIMITER ;
```

### 8.7 è°ƒè¯•æœ€ä½³å®è·µ


**ğŸ¯ è°ƒè¯•å®è·µæŒ‡å—**
```
å¼€å‘é˜¶æ®µï¼š
âœ“ ä½¿ç”¨è°ƒè¯•æ—¥å¿—è¡¨è®°å½•å…³é”®æ­¥éª¤
âœ“ ä¸ºæ¯ä¸ªé€»è¾‘åˆ†æ”¯æ·»åŠ æ—¥å¿—è®°å½•
âœ“ åˆ›å»ºç®€åŒ–ç‰ˆæœ¬é€æ­¥æµ‹è¯•å¤æ‚é€»è¾‘
âœ“ ä½¿ç”¨äº‹åŠ¡å›æ»šæµ‹è¯•é”™è¯¯å¤„ç†è·¯å¾„

æµ‹è¯•é˜¶æ®µï¼š
âœ“ åˆ›å»ºä¸“é—¨çš„æµ‹è¯•æ•°æ®è¿›è¡Œè§¦å‘å™¨æµ‹è¯•
âœ“ æ¨¡æ‹Ÿå„ç§å¼‚å¸¸æƒ…å†µéªŒè¯é”™è¯¯å¤„ç†
âœ“ æµ‹è¯•å¹¶å‘DELETEæ“ä½œçš„è§¦å‘å™¨è¡¨ç°
âœ“ éªŒè¯è§¦å‘å™¨å¯¹æ€§èƒ½çš„å®é™…å½±å“

ç”Ÿäº§é˜¶æ®µï¼š
âœ“ å»ºç«‹è§¦å‘å™¨æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
âœ“ è®¾ç½®è§¦å‘å™¨å¼‚å¸¸å‘Šè­¦æœºåˆ¶
âœ“ å®šæœŸåˆ†æè§¦å‘å™¨æ‰§è¡Œç»Ÿè®¡
âœ“ ä¿æŒè§¦å‘å™¨ä»£ç çš„æ–‡æ¡£æ›´æ–°
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ DELETEè§¦å‘å™¨åŸºç¡€ç†è§£**
```
âœ“ BEFORE DELETEï¼šåˆ é™¤å‰æ‰§è¡Œï¼Œå¯ä»¥é˜»æ­¢åˆ é™¤æ“ä½œ
âœ“ AFTER DELETEï¼šåˆ é™¤åæ‰§è¡Œï¼Œç”¨äºåç»­æ¸…ç†å’Œè®°å½•
âœ“ OLDå…³é”®å­—ï¼šè®¿é—®è¢«åˆ é™¤è¡Œçš„åŸå§‹æ•°æ®
âœ“ è§¦å‘å™¨é™åˆ¶ï¼šä¸èƒ½åˆ é™¤åŒè¡¨æ•°æ®ï¼Œæœ‰åµŒå¥—æ·±åº¦é™åˆ¶
âœ“ å¼‚å¸¸å¤„ç†ï¼šä½¿ç”¨SIGNAL/RESIGNALæ§åˆ¶é”™è¯¯ä¼ æ’­
```

**ğŸ”¸ æ‰§è¡Œé¡ºåºå’Œæœºåˆ¶**
```
å•è¡¨è§¦å‘å™¨é¡ºåºï¼š
BEFORE DELETEè§¦å‘å™¨(æŒ‰åˆ›å»ºé¡ºåº) â†’ å®é™…DELETE â†’ AFTER DELETEè§¦å‘å™¨

çº§è”è§¦å‘å™¨é¡ºåºï¼š
ä¸»è¡¨BEFORE â†’ å­è¡¨è§¦å‘å™¨æ‰§è¡Œ â†’ å­è¡¨DELETE â†’ ä¸»è¡¨DELETE â†’ ä¸»è¡¨AFTER

å¼‚å¸¸å›æ»šæœºåˆ¶ï¼š
ä»»ä½•è§¦å‘å™¨å¤±è´¥ â†’ æ•´ä¸ªäº‹åŠ¡å›æ»š â†’ åŸå§‹DELETEä¹Ÿè¢«æ’¤é”€
```

### 9.2 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
```
æ•°æ®å®¡è®¡ï¼šè®°å½•æ•æ„Ÿæ•°æ®çš„åˆ é™¤æ“ä½œ
ä¸šåŠ¡çº¦æŸï¼šé˜²æ­¢ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™çš„åˆ é™¤
çº§è”æ¸…ç†ï¼šè‡ªåŠ¨æ¸…ç†ç›¸å…³çš„ä¾èµ–æ•°æ®
ç»Ÿè®¡ç»´æŠ¤ï¼šè‡ªåŠ¨æ›´æ–°æ±‡æ€»ç»Ÿè®¡ä¿¡æ¯
é€šçŸ¥æœºåˆ¶ï¼šé‡è¦æ•°æ®åˆ é™¤æ—¶å‘é€é€šçŸ¥
```

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
è®¾è®¡åŸåˆ™ï¼š
âœ“ è§¦å‘å™¨é€»è¾‘ä¿æŒç®€å•é«˜æ•ˆ
âœ“ é¿å…å¤æ‚æŸ¥è¯¢å’Œæ·±å±‚åµŒå¥—
âœ“ ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—å¤„ç†è€—æ—¶æ“ä½œ
âœ“ åˆç†è®¾è®¡å¼‚å¸¸å¤„ç†ç­–ç•¥

ç›‘æ§ç»´æŠ¤ï¼š
âœ“ å»ºç«‹è§¦å‘å™¨æ€§èƒ½ç›‘æ§ä½“ç³»
âœ“ å®šæœŸæ£€æŸ¥è§¦å‘å™¨å¥åº·çŠ¶æ€
âœ“ åˆ†æå’Œä¼˜åŒ–æ…¢é€Ÿè§¦å‘å™¨
âœ“ è®°å½•å’Œåˆ†æè§¦å‘å™¨æ‰§è¡Œç»Ÿè®¡
```

### 9.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**ğŸ”§ æ•…éšœæ’é™¤æŒ‡å—**
```
è§¦å‘å™¨ä¸æ‰§è¡Œï¼š
- æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦å­˜åœ¨ï¼šSHOW TRIGGERS
- ç¡®è®¤ç”¨æˆ·æœ‰TRIGGERæƒé™
- éªŒè¯è§¦å‘å™¨è¯­æ³•æ˜¯å¦æ­£ç¡®

è§¦å‘å™¨æ‰§è¡Œæ…¢ï¼š
- æŸ¥çœ‹è§¦å‘å™¨ä¸­æ˜¯å¦æœ‰å¤æ‚æŸ¥è¯¢
- æ£€æŸ¥ç›¸å…³è¡¨æ˜¯å¦ç¼ºå°‘ç´¢å¼•
- åˆ†æè§¦å‘å™¨æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯

è§¦å‘å™¨å¯¼è‡´æ­»é”ï¼š
- æ£€æŸ¥è§¦å‘å™¨ä¸­çš„è¡¨è®¿é—®é¡ºåº
- å‡å°‘è§¦å‘å™¨ä¸­çš„é”æŒæœ‰æ—¶é—´
- è€ƒè™‘ä½¿ç”¨å¼‚æ­¥å¤„ç†å‡å°‘é”ç«äº‰

DELETEæ“ä½œå¤±è´¥ï¼š
- æŸ¥çœ‹è§¦å‘å™¨é”™è¯¯æ—¥å¿—
- æ£€æŸ¥è§¦å‘å™¨ä¸­çš„ä¸šåŠ¡é€»è¾‘çº¦æŸ
- éªŒè¯è§¦å‘å™¨æ‰§è¡Œæƒé™
```

**âš ï¸ é‡è¦æé†’**
```
ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹ï¼š
âœ“ è§¦å‘å™¨ä¼šå¢åŠ DELETEæ“ä½œçš„å¤æ‚æ€§å’Œè€—æ—¶
âœ“ å¿…é¡»å……åˆ†æµ‹è¯•è§¦å‘å™¨çš„å„ç§æ‰§è¡Œè·¯å¾„
âœ“ å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
âœ“ å‡†å¤‡è§¦å‘å™¨çš„å›æ»šå’Œåº”æ€¥å¤„ç†æ–¹æ¡ˆ
âœ“ å®šæœŸå®¡æŸ¥å’Œä¼˜åŒ–è§¦å‘å™¨æ€§èƒ½
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- DELETEè§¦å‘å™¨æ˜¯è‡ªåŠ¨æ‰§è¡Œçš„æ•°æ®åº“ç¨‹åºï¼Œåœ¨åˆ é™¤å‰åè‡ªåŠ¨å¤„ç†ç›¸å…³é€»è¾‘
- BEFORE DELETEå¯ä»¥é˜»æ­¢åˆ é™¤ï¼ŒAFTER DELETEç”¨äºåç»­æ¸…ç†
- è§¦å‘å™¨æœ‰æ‰§è¡Œé™åˆ¶å’Œé¡ºåºè§„åˆ™ï¼Œéœ€è¦åˆç†è®¾è®¡é¿å…é—®é¢˜
- å¼‚å¸¸å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–æ˜¯è§¦å‘å™¨å®ç”¨çš„å…³é”®
- ç›‘æ§å’Œè°ƒè¯•å·¥å…·å¯¹ç»´æŠ¤è§¦å‘å™¨ç³»ç»Ÿè‡³å…³é‡è¦