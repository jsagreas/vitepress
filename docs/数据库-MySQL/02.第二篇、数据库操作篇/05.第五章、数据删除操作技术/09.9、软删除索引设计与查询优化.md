---
title: 9ã€è½¯åˆ é™¤ç´¢å¼•è®¾è®¡ä¸æŸ¥è¯¢ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [è½¯åˆ é™¤åŸºç¡€æ¦‚å¿µ](#1-è½¯åˆ é™¤åŸºç¡€æ¦‚å¿µ)
2. [è½¯åˆ é™¤ç´¢å¼•è®¾è®¡åŸç†](#2-è½¯åˆ é™¤ç´¢å¼•è®¾è®¡åŸç†)
3. [å¤åˆç´¢å¼•è®¾è®¡ç­–ç•¥](#3-å¤åˆç´¢å¼•è®¾è®¡ç­–ç•¥)
4. [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](#4-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯)
5. [è½¯åˆ é™¤å­—æ®µé€‰æ‹©æ€§åˆ†æ](#5-è½¯åˆ é™¤å­—æ®µé€‰æ‹©æ€§åˆ†æ)
6. [æœ€ä½³å®è·µä¸æ¡ˆä¾‹](#6-æœ€ä½³å®è·µä¸æ¡ˆä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—‚ï¸ è½¯åˆ é™¤åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è½¯åˆ é™¤


> ğŸ’¡ **ä¸€å¥è¯ç†è§£**ï¼šè½¯åˆ é™¤å°±æ˜¯ç»™æ•°æ®æ‰“ä¸ª"åˆ é™¤æ ‡è®°"ï¼Œæ•°æ®è¿˜åœ¨é‚£é‡Œï¼Œåªæ˜¯æ ‡è®°ä¸º"å·²åˆ é™¤"çŠ¶æ€

**ğŸ”¸ è½¯åˆ é™¤å®šä¹‰**
```
è½¯åˆ é™¤ï¼ˆSoft Deleteï¼‰ï¼š
ä¸çœŸæ­£åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡æ ‡è®°å­—æ®µè¡¨ç¤ºæ•°æ®çš„åˆ é™¤çŠ¶æ€
æ•°æ®ä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œåªæ˜¯åœ¨é€»è¾‘ä¸Šè¢«è§†ä¸ºå·²åˆ é™¤

å¯¹æ¯”ï¼š
ç¡¬åˆ é™¤ï¼šDELETE FROM users WHERE id = 1;  (æ•°æ®çœŸçš„æ²¡äº†)
è½¯åˆ é™¤ï¼šUPDATE users SET deleted = 1 WHERE id = 1;  (æ•°æ®è¿˜åœ¨ï¼Œåªæ˜¯æ ‡è®°)
```

### 1.2 è½¯åˆ é™¤çš„åº”ç”¨åœºæ™¯


**ğŸ¯ ä¸ºä»€ä¹ˆè¦ç”¨è½¯åˆ é™¤ï¼Ÿ**

```
å®é™…ä¸šåŠ¡éœ€æ±‚ï¼š
ğŸ“Š æ•°æ®åˆ†æéœ€æ±‚    â†’ éœ€è¦ç»Ÿè®¡å†å²åˆ é™¤çš„æ•°æ®
ğŸ”„ è¯¯åˆ æ¢å¤éœ€æ±‚    â†’ ç”¨æˆ·å¯èƒ½éœ€è¦æ¢å¤åˆ é™¤çš„å†…å®¹  
ğŸ“‹ å®¡è®¡åˆè§„éœ€æ±‚    â†’ æ³•å¾‹è¦æ±‚ä¿ç•™æ“ä½œè®°å½•
ğŸ” ä¸šåŠ¡é€»è¾‘éœ€æ±‚    â†’ åˆ é™¤å¯èƒ½å½±å“å…¶ä»–å…³è”æ•°æ®

ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒå›æ”¶ç«™æœºåˆ¶ - æ–‡ä»¶åˆ é™¤åå…ˆæ”¾å›æ”¶ç«™ï¼Œéœ€è¦æ—¶å¯ä»¥æ¢å¤
è€Œä¸æ˜¯ç›´æ¥ç‰©ç†é”€æ¯ç¡¬ç›˜æ•°æ®
```

### 1.3 è½¯åˆ é™¤å®ç°æ–¹å¼


**ğŸ“‹ å¸¸è§çš„è½¯åˆ é™¤å­—æ®µè®¾è®¡**

| å­—æ®µç±»å‹ | **å­—æ®µå** | **æ•°æ®ç±»å‹** | **å€¼å«ä¹‰** | **ä¼˜ç¼ºç‚¹** |
|---------|------------|-------------|-----------|-----------|
| ğŸ”¸ **å¸ƒå°”å‹** | `is_deleted` | `BOOLEAN` | `0=æ­£å¸¸, 1=åˆ é™¤` | `ç®€å•ç›´è§‚ï¼Œä½†æ— åˆ é™¤æ—¶é—´` |
| ğŸ• **æ—¶é—´æˆ³** | `deleted_at` | `DATETIME` | `NULL=æ­£å¸¸, æ—¶é—´=åˆ é™¤` | `åŒ…å«åˆ é™¤æ—¶é—´ï¼Œæ¨èæ–¹æ¡ˆ` |
| ğŸ“Š **çŠ¶æ€æšä¸¾** | `status` | `TINYINT` | `1=æ­£å¸¸, 2=åˆ é™¤, 3=ç¦ç”¨` | `æ‰©å±•æ€§å¥½ï¼Œä½†å¤æ‚åº¦é«˜` |

> âš ï¸ **æ¨èä½¿ç”¨ `deleted_at` æ—¶é—´æˆ³æ–¹æ¡ˆ**ï¼šæ—¢èƒ½æ ‡è®°åˆ é™¤çŠ¶æ€ï¼Œåˆèƒ½è®°å½•åˆ é™¤æ—¶é—´

```sql
-- æ¨èçš„è¡¨ç»“æ„è®¾è®¡
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL DEFAULT NULL  -- è½¯åˆ é™¤å­—æ®µ
);
```

---

## 2. ğŸ” è½¯åˆ é™¤ç´¢å¼•è®¾è®¡åŸç†


### 2.1 ä¸ºä»€ä¹ˆè½¯åˆ é™¤éœ€è¦ç‰¹æ®Šçš„ç´¢å¼•è®¾è®¡


**ğŸ¤” é—®é¢˜åˆ†æ**
```
ä¼ ç»ŸæŸ¥è¯¢ï¼ˆæ— è½¯åˆ é™¤ï¼‰ï¼š
SELECT * FROM users WHERE username = 'john';

è½¯åˆ é™¤åçš„æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE username = 'john' AND deleted_at IS NULL;

é—®é¢˜ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è¦é¢å¤–æ£€æŸ¥ deleted_at å­—æ®µ
å¦‚æœç´¢å¼•è®¾è®¡ä¸å½“ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼šå¤§å¹…ä¸‹é™
```

**ğŸ“Š æ€§èƒ½å½±å“å¯¹æ¯”**
```
åœºæ™¯ï¼š100ä¸‡ç”¨æˆ·æ•°æ®ï¼Œå…¶ä¸­10ä¸‡å·²è½¯åˆ é™¤

æ²¡æœ‰åˆé€‚ç´¢å¼•ï¼š
æŸ¥è¯¢æ—¶é—´ï¼š500ms â†’ 2000ms (æ€§èƒ½ä¸‹é™4å€)
åŸå› ï¼šéœ€è¦å…¨è¡¨æ‰«ææ£€æŸ¥ deleted_at å­—æ®µ

æœ‰åˆé€‚ç´¢å¼•ï¼š
æŸ¥è¯¢æ—¶é—´ï¼š500ms â†’ 520ms (å‡ ä¹æ— å½±å“)
åŸå› ï¼šç´¢å¼•ç›´æ¥è¿‡æ»¤æ‰å·²åˆ é™¤æ•°æ®
```

### 2.2 è½¯åˆ é™¤å¯¹ç´¢å¼•çš„å½±å“


**ğŸ”¸ ç´¢å¼•å¤±æ•ˆé—®é¢˜**

```sql
-- åŸæœ‰ç´¢å¼•
CREATE INDEX idx_username ON users(username);

-- è½¯åˆ é™¤åçš„æŸ¥è¯¢
SELECT * FROM users 
WHERE username = 'john' 
AND deleted_at IS NULL;

-- é—®é¢˜ï¼šå¯èƒ½æ— æ³•å……åˆ†åˆ©ç”¨ idx_username ç´¢å¼•
-- å› ä¸ºè¿˜éœ€è¦æ£€æŸ¥ deleted_at æ¡ä»¶
```

**ğŸ“ˆ æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æ**
```
ä¸ä¼˜åŒ–çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ä½¿ç”¨ idx_username æ‰¾åˆ°æ‰€æœ‰ username='john' çš„è®°å½•
2. é€ä¸€æ£€æŸ¥æ¯æ¡è®°å½•çš„ deleted_at å­—æ®µ
3. è¿‡æ»¤æ‰ deleted_at ä¸ä¸º NULL çš„è®°å½•

ä¼˜åŒ–åçš„æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ä½¿ç”¨å¤åˆç´¢å¼•ç›´æ¥æ‰¾åˆ° username='john' ä¸” deleted_at IS NULL çš„è®°å½•
2. æ— éœ€é¢å¤–è¿‡æ»¤æ­¥éª¤
```

### 2.3 ç´¢å¼•è®¾è®¡åŸºæœ¬åŸåˆ™


**ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™**

> ğŸ“Œ **æœ€é‡è¦åŸåˆ™**ï¼šå°†è½¯åˆ é™¤å­—æ®µåŒ…å«åœ¨æ‰€æœ‰æŸ¥è¯¢ç›¸å…³çš„ç´¢å¼•ä¸­

```
åŸåˆ™1ï¼šå¤åˆç´¢å¼•ä¼˜å…ˆ
â€¢ å°† deleted_at å­—æ®µåŒ…å«åœ¨å¤åˆç´¢å¼•ä¸­
â€¢ é€šå¸¸æ”¾åœ¨ç´¢å¼•çš„ç¬¬ä¸€ä½æˆ–æœ€åä¸€ä½

åŸåˆ™2ï¼šé€‰æ‹©æ€§åˆ†æ
â€¢ åˆ†æ deleted_at å­—æ®µçš„é€‰æ‹©æ€§
â€¢ æ ¹æ®åˆ é™¤æ•°æ®æ¯”ä¾‹å†³å®šç´¢å¼•ç­–ç•¥

åŸåˆ™3ï¼šæŸ¥è¯¢æ¨¡å¼é€‚é…
â€¢ æ ¹æ®å®é™…æŸ¥è¯¢SQLè®¾è®¡ç´¢å¼•
â€¢ è€ƒè™‘WHEREã€ORDER BYã€JOINç­‰å­å¥
```

---

## 3. ğŸ”§ å¤åˆç´¢å¼•è®¾è®¡ç­–ç•¥


### 3.1 è½¯åˆ é™¤å­—æ®µåœ¨ç´¢å¼•ä¸­çš„ä½ç½®é€‰æ‹©


**ğŸ¤” æ”¾åœ¨ç´¢å¼•çš„å“ªä¸ªä½ç½®ï¼Ÿ**

```
ä¸¤ç§ä¸»è¦ç­–ç•¥ï¼š

ç­–ç•¥Aï¼šdeleted_at æ”¾åœ¨ç´¢å¼•é¦–ä½
CREATE INDEX idx_deleted_username ON users(deleted_at, username);

ç­–ç•¥Bï¼šdeleted_at æ”¾åœ¨ç´¢å¼•æœ«ä½  
CREATE INDEX idx_username_deleted ON users(username, deleted_at);

å¦‚ä½•é€‰æ‹©ï¼Ÿçœ‹æ•°æ®åˆ†å¸ƒï¼
```

### 3.2 åŸºäºåˆ é™¤æ¯”ä¾‹çš„ç´¢å¼•ç­–ç•¥


**ğŸ“Š åˆ é™¤æ¯”ä¾‹å½±å“ç´¢å¼•è®¾è®¡**

#### ğŸŸ¢ ä½åˆ é™¤æ¯”ä¾‹åœºæ™¯ï¼ˆåˆ é™¤æ•°æ® < 10%ï¼‰


```sql
-- é€‚åˆï¼šdeleted_at æ”¾åœ¨ç´¢å¼•æœ«ä½
CREATE INDEX idx_username_deleted ON users(username, deleted_at);

åŸç†ï¼š
â€¢ å¤§éƒ¨åˆ†æ•°æ®æ˜¯æ­£å¸¸çŠ¶æ€ï¼ˆdeleted_at IS NULLï¼‰
â€¢ å…ˆé€šè¿‡ username è¿‡æ»¤ï¼Œå†æ£€æŸ¥ deleted_at
â€¢ å‡å°‘éœ€è¦æ£€æŸ¥åˆ é™¤çŠ¶æ€çš„æ•°æ®é‡

æŸ¥è¯¢ç¤ºä¾‹ï¼š
SELECT * FROM users 
WHERE username = 'john' 
AND deleted_at IS NULL;

æ‰§è¡Œè¿‡ç¨‹ï¼š
username='john' â†’ æ‰¾åˆ°10æ¡è®°å½• â†’ æ£€æŸ¥åˆ é™¤çŠ¶æ€ â†’ è¿”å›9æ¡æ­£å¸¸è®°å½•
```

#### ğŸŸ¡ ä¸­ç­‰åˆ é™¤æ¯”ä¾‹åœºæ™¯ï¼ˆåˆ é™¤æ•°æ® 10%-30%ï¼‰


```sql
-- å»ºè®®ï¼šåˆ›å»ºå¤šä¸ªç´¢å¼•ç­–ç•¥
-- ä¸»æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_username_deleted ON users(username, deleted_at);
-- ç®¡ç†æŸ¥è¯¢ç´¢å¼•  
CREATE INDEX idx_deleted_created ON users(deleted_at, created_at);

åŸç†ï¼š
â€¢ æ­£å¸¸ä¸šåŠ¡æŸ¥è¯¢ï¼šä¼˜å…ˆä½¿ç”¨ username è¿‡æ»¤
â€¢ ç®¡ç†æŸ¥è¯¢ï¼šéœ€è¦æŒ‰åˆ é™¤çŠ¶æ€å’Œæ—¶é—´æŸ¥è¯¢
â€¢ åˆ†åœºæ™¯ä¼˜åŒ–ï¼Œé¿å…ä¸€ä¸ªç´¢å¼•åŒ…æ‰“å¤©ä¸‹
```

#### ğŸ”´ é«˜åˆ é™¤æ¯”ä¾‹åœºæ™¯ï¼ˆåˆ é™¤æ•°æ® > 30%ï¼‰


```sql
-- é€‚åˆï¼šdeleted_at æ”¾åœ¨ç´¢å¼•é¦–ä½
CREATE INDEX idx_deleted_username ON users(deleted_at, username);

åŸç†ï¼š
â€¢ å¤§é‡æ•°æ®æ˜¯åˆ é™¤çŠ¶æ€
â€¢ å…ˆè¿‡æ»¤æ‰åˆ é™¤æ•°æ®ï¼Œå¤§å¹…å‡å°‘æ£€ç´¢èŒƒå›´
â€¢ ç‰¹åˆ«é€‚åˆå†å²æ•°æ®å½’æ¡£åœºæ™¯

æ‰§è¡Œè¿‡ç¨‹ï¼š
deleted_at IS NULL â†’ è¿‡æ»¤åˆ°70ä¸‡æ­£å¸¸è®°å½• â†’ åœ¨å…¶ä¸­æŸ¥æ‰¾ username
æ¯”ç›´æ¥åœ¨100ä¸‡è®°å½•ä¸­æŸ¥æ‰¾æ•ˆç‡é«˜
```

### 3.3 å¤åˆç´¢å¼•å­—æ®µé¡ºåºè®¾è®¡


**ğŸ¯ å­—æ®µé¡ºåºå†³ç­–æ¨¡å‹**

```
é¡ºåºå†³ç­–å› ç´ ï¼š
1. å­—æ®µé€‰æ‹©æ€§ï¼ˆåŒºåˆ†åº¦ï¼‰
2. æŸ¥è¯¢é¢‘ç‡
3. æ•°æ®åˆ†å¸ƒ
4. æ’åºéœ€æ±‚

ä¸¾ä¾‹åˆ†æï¼š
è¡¨ï¼šorders (è®¢å•è¡¨)
å­—æ®µï¼šuser_id, status, created_at, deleted_at

å¸¸è§æŸ¥è¯¢ï¼š
SELECT * FROM orders 
WHERE user_id = ? 
AND status = 'completed' 
AND deleted_at IS NULL 
ORDER BY created_at DESC;
```

**ğŸ“‹ å­—æ®µé€‰æ‹©æ€§åˆ†æ**
```sql
-- åˆ†æå„å­—æ®µçš„é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT user_id) / COUNT(*) as user_id_selectivity,
    COUNT(DISTINCT status) / COUNT(*) as status_selectivity,
    COUNT(DISTINCT deleted_at) / COUNT(*) as deleted_selectivity
FROM orders;

ç»“æœç¤ºä¾‹ï¼š
user_id_selectivity: 0.001 (1000ä¸ªç”¨æˆ·ï¼Œ100ä¸‡è®¢å•)
status_selectivity: 0.1 (10ç§çŠ¶æ€)  
deleted_selectivity: 0.1 (åˆ é™¤/æ­£å¸¸ä¸¤ç§çŠ¶æ€)

ç´¢å¼•è®¾è®¡å»ºè®®ï¼š
CREATE INDEX idx_orders_query ON orders(user_id, status, deleted_at, created_at);
          â†‘é«˜é€‰æ‹©æ€§    â†‘ä¸­é€‰æ‹©æ€§  â†‘ä½é€‰æ‹©æ€§    â†‘æ’åºå­—æ®µ
```

### 3.4 è¦†ç›–ç´¢å¼•è®¾è®¡


**ğŸ¯ ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ**

> ğŸ’¡ **è¦†ç›–ç´¢å¼•**ï¼šç´¢å¼•åŒ…å«äº†æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰å­—æ®µï¼Œæ— éœ€å›è¡¨æŸ¥è¯¢

```sql
-- æ™®é€šç´¢å¼•ï¼ˆéœ€è¦å›è¡¨ï¼‰
CREATE INDEX idx_username_deleted ON users(username, deleted_at);

SELECT id, username, email, created_at 
FROM users 
WHERE username = 'john' AND deleted_at IS NULL;

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ä½¿ç”¨ç´¢å¼•æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•
2. æ ¹æ®ä¸»é”®å›è¡¨æŸ¥è¯¢ email, created_at å­—æ®µ  â† é¢å¤–å¼€é”€

-- è¦†ç›–ç´¢å¼•ï¼ˆæ— éœ€å›è¡¨ï¼‰
CREATE INDEX idx_username_deleted_covering 
ON users(username, deleted_at, id, email, created_at);

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. ç›´æ¥ä»ç´¢å¼•è·å–æ‰€æœ‰éœ€è¦çš„å­—æ®µ  â† æ€§èƒ½æ›´ä¼˜
```

**âš–ï¸ è¦†ç›–ç´¢å¼•æƒè¡¡è€ƒè™‘**
```
ä¼˜ç‚¹ï¼š
âœ… æŸ¥è¯¢æ€§èƒ½æœ€ä¼˜ï¼Œæ— å›è¡¨å¼€é”€
âœ… å‡å°‘ç£ç›˜IOï¼Œæå‡å“åº”é€Ÿåº¦
âœ… å‡å°‘é”ç«äº‰ï¼Œæé«˜å¹¶å‘èƒ½åŠ›

ç¼ºç‚¹ï¼š
âŒ ç´¢å¼•ä½“ç§¯å¤§ï¼Œå ç”¨æ›´å¤šå­˜å‚¨ç©ºé—´
âŒ æ’å…¥/æ›´æ–°æ€§èƒ½ä¸‹é™ï¼ˆéœ€è¦ç»´æŠ¤æ›´å¤šç´¢å¼•ï¼‰
âŒ ç»´æŠ¤æˆæœ¬é«˜

é€‰æ‹©å»ºè®®ï¼š
ğŸ¯ é«˜é¢‘æŸ¥è¯¢ â†’ å€¼å¾—åˆ›å»ºè¦†ç›–ç´¢å¼•
ğŸ¯ ä½é¢‘æŸ¥è¯¢ â†’ æ™®é€šç´¢å¼•å³å¯
ğŸ¯ å†™å…¥å¯†é›† â†’ è°¨æ…ä½¿ç”¨è¦†ç›–ç´¢å¼•
```

---

## 4. âš¡ æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯


### 4.1 æŸ¥è¯¢é‡å†™æŠ€æœ¯


**ğŸ”„ SQLæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**

#### åŸºç¡€æŸ¥è¯¢é‡å†™

```sql
-- âŒ ä½æ•ˆæŸ¥è¯¢ï¼šæ¯æ¬¡éƒ½æ£€æŸ¥åˆ é™¤çŠ¶æ€
SELECT * FROM users WHERE email = 'user@example.com' AND deleted_at IS NULL;

-- âœ… ä¼˜åŒ–æŸ¥è¯¢ï¼šåˆ©ç”¨å¤åˆç´¢å¼•
-- å‰æï¼šåˆ›å»ºç´¢å¼• CREATE INDEX idx_email_deleted ON users(email, deleted_at);
SELECT * FROM users WHERE email = 'user@example.com' AND deleted_at IS NULL;
-- è¿™ä¸ªæŸ¥è¯¢èƒ½å®Œå…¨åˆ©ç”¨å¤åˆç´¢å¼•
```

#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ ä¼ ç»Ÿåˆ†é¡µï¼ˆæ€§èƒ½é—®é¢˜ï¼‰
SELECT * FROM posts 
WHERE deleted_at IS NULL 
ORDER BY created_at DESC 
LIMIT 20 OFFSET 10000;
-- é—®é¢˜ï¼šOFFSET 10000 éœ€è¦è·³è¿‡1ä¸‡æ¡è®°å½•ï¼Œæ•ˆç‡ä½

-- âœ… æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èæ–¹æ¡ˆï¼‰
SELECT * FROM posts 
WHERE deleted_at IS NULL 
AND created_at < '2025-01-01 10:00:00'  -- ä½¿ç”¨ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åæ—¶é—´
ORDER BY created_at DESC 
LIMIT 20;
-- ç´¢å¼•ï¼šCREATE INDEX idx_deleted_created ON posts(deleted_at, created_at);
```

### 4.2 æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–


**ğŸ¯ WHEREæ¡ä»¶ä¼˜åŒ–æŠ€å·§**

```sql
-- åœºæ™¯ï¼šæŸ¥è¯¢ç‰¹å®šçŠ¶æ€çš„æœªåˆ é™¤è®¢å•

-- âŒ ä½æ•ˆå†™æ³•
SELECT * FROM orders 
WHERE status IN ('pending', 'processing') 
AND deleted_at IS NULL;

-- âœ… é«˜æ•ˆå†™æ³•ï¼ˆåˆ†è§£æŸ¥è¯¢ï¼‰
-- å¦‚æœ status é€‰æ‹©æ€§é«˜ï¼Œdeleted_at é€‰æ‹©æ€§ä½
SELECT * FROM orders 
WHERE status = 'pending' AND deleted_at IS NULL
UNION ALL
SELECT * FROM orders 
WHERE status = 'processing' AND deleted_at IS NULL;

-- ç´¢å¼•æ”¯æŒ
CREATE INDEX idx_status_deleted ON orders(status, deleted_at);
```

**ğŸ” å¤æ‚æŸ¥è¯¢çš„ç´¢å¼•è®¾è®¡**

```sql
-- å¤æ‚ä¸šåŠ¡æŸ¥è¯¢
SELECT COUNT(*) FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.created_at >= '2025-01-01'
AND o.status = 'completed'
AND o.deleted_at IS NULL
AND u.deleted_at IS NULL;

-- ç´¢å¼•è®¾è®¡æ€è·¯
CREATE INDEX idx_orders_complex ON orders(created_at, status, deleted_at, user_id);
CREATE INDEX idx_users_deleted_id ON users(deleted_at, id);

-- æŸ¥è¯¢é‡å†™ä¼˜åŒ–
SELECT COUNT(*) FROM orders o
STRAIGHT_JOIN users u ON o.user_id = u.id AND u.deleted_at IS NULL
WHERE o.created_at >= '2025-01-01'
AND o.status = 'completed'
AND o.deleted_at IS NULL;
```

### 4.3 åˆ†åŒºè¡¨ä¸è½¯åˆ é™¤


**ğŸ“¦ åˆ†åŒºç­–ç•¥ä¼˜åŒ–**

```sql
-- æŒ‰åˆ é™¤çŠ¶æ€åˆ†åŒº
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT,
    username VARCHAR(50),
    email VARCHAR(100),
    created_at TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    PRIMARY KEY (id, deleted_at)
) PARTITION BY RANGE (ISNULL(deleted_at)) (
    PARTITION p_active VALUES LESS THAN (1),      -- deleted_at IS NULL
    PARTITION p_deleted VALUES LESS THAN MAXVALUE -- deleted_at IS NOT NULL
);

ä¼˜åŠ¿ï¼š
âœ… æ­£å¸¸æŸ¥è¯¢åªæ‰«æ p_active åˆ†åŒº
âœ… åˆ é™¤æ•°æ®æŸ¥è¯¢åªæ‰«æ p_deleted åˆ†åŒº  
âœ… ç»´æŠ¤æ“ä½œå¯ä»¥æŒ‰åˆ†åŒºè¿›è¡Œ
```

**ğŸ—“ï¸ æŒ‰æ—¶é—´åˆ†åŒºçš„è½¯åˆ é™¤è¡¨**
```sql
-- é€‚åˆå†å²æ•°æ®è¾ƒå¤šçš„åœºæ™¯
CREATE TABLE user_activities (
    id BIGINT AUTO_INCREMENT,
    user_id BIGINT,
    activity_type VARCHAR(50),
    created_at TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026)
);

-- æ¯ä¸ªåˆ†åŒºå†…çš„ç´¢å¼•
CREATE INDEX idx_user_deleted ON user_activities(user_id, deleted_at) LOCAL;
```

---

## 5. ğŸ“Š è½¯åˆ é™¤å­—æ®µé€‰æ‹©æ€§åˆ†æ


### 5.1 ä»€ä¹ˆæ˜¯å­—æ®µé€‰æ‹©æ€§


> ğŸ’¡ **å­—æ®µé€‰æ‹©æ€§**ï¼šå­—æ®µä¸åŒå€¼çš„æ¯”ä¾‹ï¼Œåæ˜ å­—æ®µçš„åŒºåˆ†èƒ½åŠ›

**ğŸ”¢ é€‰æ‹©æ€§è®¡ç®—å…¬å¼**
```sql
å­—æ®µé€‰æ‹©æ€§ = COUNT(DISTINCT å­—æ®µå€¼) / COUNT(æ€»è®°å½•æ•°)

-- å®é™…è®¡ç®—ç¤ºä¾‹
SELECT 
    COUNT(DISTINCT deleted_at) / COUNT(*) as deleted_selectivity,
    COUNT(*) as total_records,
    COUNT(DISTINCT deleted_at) as distinct_values
FROM users;

ç»“æœè§£è¯»ï¼š
é€‰æ‹©æ€§ = 0.1   â†’ åŒºåˆ†åº¦ä½ï¼ˆå¦‚è½¯åˆ é™¤å­—æ®µï¼Œåªæœ‰NULLå’Œæ—¶é—´æˆ³ï¼‰
é€‰æ‹©æ€§ = 0.5   â†’ åŒºåˆ†åº¦ä¸­ç­‰
é€‰æ‹©æ€§ = 0.9   â†’ åŒºåˆ†åº¦é«˜ï¼ˆå¦‚ä¸»é”®ã€é‚®ç®±ç­‰ï¼‰
```

### 5.2 è½¯åˆ é™¤å­—æ®µçš„é€‰æ‹©æ€§ç‰¹ç‚¹


**ğŸ“ˆ é€‰æ‹©æ€§åˆ†æå®ä¾‹**

```sql
-- åˆ†æè½¯åˆ é™¤å­—æ®µçš„æ•°æ®åˆ†å¸ƒ
SELECT 
    CASE 
        WHEN deleted_at IS NULL THEN 'active'
        ELSE 'deleted'
    END as status,
    COUNT(*) as count,
    COUNT(*) * 100.0 / (SELECT COUNT(*) FROM users) as percentage
FROM users
GROUP BY (deleted_at IS NULL);

-- å…¸å‹ç»“æœ
+----------+--------+------------+
| status   | count  | percentage |
+----------+--------+------------+
| active   | 900000 |      90.0% |
| deleted  | 100000 |      10.0% |
+----------+--------+------------+

é€‰æ‹©æ€§åˆ†æï¼š
deleted_at é€‰æ‹©æ€§ â‰ˆ 0.1 (ç›¸å¯¹è¾ƒä½)
```

### 5.3 åŸºäºé€‰æ‹©æ€§çš„ç´¢å¼•ç­–ç•¥


**ğŸ¯ é€‰æ‹©æ€§å†³å®šç´¢å¼•é¡ºåº**

```
é«˜é€‰æ‹©æ€§å­—æ®µä¼˜å…ˆç­–ç•¥ï¼š
user_id (é€‰æ‹©æ€§: 0.001) â†’ æ”¾åœ¨ç´¢å¼•å‰é¢
status (é€‰æ‹©æ€§: 0.1)   â†’ æ”¾åœ¨ä¸­é—´
deleted_at (é€‰æ‹©æ€§: 0.1) â†’ æ”¾åœ¨åé¢

ç´¢å¼•è®¾è®¡ï¼š
CREATE INDEX idx_user_status_deleted ON orders(user_id, status, deleted_at);
```

**ğŸ“Š ä¸åŒé€‰æ‹©æ€§ç»„åˆçš„ç´¢å¼•æ•ˆæœ**

| åˆ é™¤æ¯”ä¾‹ | **ç´¢å¼•ç­–ç•¥** | **é€‚ç”¨æŸ¥è¯¢** | **æ€§èƒ½è¡¨ç°** |
|---------|-------------|-------------|-------------|
| **< 5%** | `(ä¸šåŠ¡å­—æ®µ, deleted_at)` | `æ­£å¸¸ä¸šåŠ¡æŸ¥è¯¢` | `ä¼˜ç§€` |
| **5%-20%** | `(ä¸šåŠ¡å­—æ®µ, deleted_at)` | `æ··åˆæŸ¥è¯¢` | `è‰¯å¥½` |
| **20%-50%** | `(deleted_at, ä¸šåŠ¡å­—æ®µ)` | `éœ€è¦åˆ†çŠ¶æ€æŸ¥è¯¢` | `è‰¯å¥½` |
| **> 50%** | `åˆ†åŒºè¡¨ + çŠ¶æ€ç´¢å¼•` | `å¤§é‡å†å²æ•°æ®` | `ä¼˜ç§€` |

### 5.4 åŠ¨æ€é€‰æ‹©æ€§ç›‘æ§


**ğŸ“Š ç›‘æ§é€‰æ‹©æ€§å˜åŒ–**

```sql
-- å®šæœŸåˆ†æç´¢å¼•æ•ˆæœçš„æŸ¥è¯¢
CREATE VIEW v_index_selectivity AS
SELECT 
    table_name,
    index_name,
    cardinality,
    cardinality / table_rows as selectivity,
    table_rows
FROM information_schema.statistics s
JOIN information_schema.tables t USING(table_schema, table_name)
WHERE table_schema = 'your_database'
AND index_name LIKE '%deleted%';

-- ç›‘æ§åˆ é™¤æ¯”ä¾‹å˜åŒ–
CREATE EVENT check_delete_ratio
ON SCHEDULE EVERY 1 DAY
DO
BEGIN
    INSERT INTO delete_ratio_log
    SELECT 
        'users' as table_name,
        COUNT(CASE WHEN deleted_at IS NULL THEN 1 END) as active_count,
        COUNT(CASE WHEN deleted_at IS NOT NULL THEN 1 END) as deleted_count,
        NOW() as check_time
    FROM users;
END;
```

---

## 6. ğŸ” æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯


### 6.1 ç´¢å¼•æç¤ºä¸å¼ºåˆ¶ä½¿ç”¨


**ğŸ”§ MySQLç´¢å¼•æç¤ºæŠ€æœ¯**

```sql
-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•
SELECT * FROM users 
USE INDEX (idx_username_deleted)
WHERE username = 'john' AND deleted_at IS NULL;

-- å¿½ç•¥æŸä¸ªç´¢å¼•
SELECT * FROM users 
IGNORE INDEX (idx_email)
WHERE username = 'john' AND deleted_at IS NULL;

-- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆå¦‚æœæ²¡æœ‰åˆé€‚ç´¢å¼•ä¼šæŠ¥é”™ï¼‰
SELECT * FROM users 
FORCE INDEX (idx_username_deleted)
WHERE username = 'john' AND deleted_at IS NULL;
```

### 6.2 æŸ¥è¯¢ç¼“å­˜ç­–ç•¥


**ğŸ’¾ è½¯åˆ é™¤æŸ¥è¯¢çš„ç¼“å­˜è®¾è®¡**

```python
# åº”ç”¨å±‚ç¼“å­˜ç­–ç•¥
class UserService:
    def get_active_user(self, username):
        cache_key = f"active_user:{username}"
        
        # æ£€æŸ¥ç¼“å­˜
        user = redis_client.get(cache_key)
        if user:
            return json.loads(user)
        
        # æ•°æ®åº“æŸ¥è¯¢
        user = db.query("""
            SELECT id, username, email, created_at 
            FROM users 
            WHERE username = %s AND deleted_at IS NULL
        """, (username,))
        
        if user:
            # ç¼“å­˜5åˆ†é’Ÿ
            redis_client.setex(cache_key, 300, json.dumps(user))
            
        return user
    
    def soft_delete_user(self, user_id):
        # æ‰§è¡Œè½¯åˆ é™¤
        db.execute("""
            UPDATE users 
            SET deleted_at = NOW() 
            WHERE id = %s
        """, (user_id,))
        
        # æ¸…é™¤ç›¸å…³ç¼“å­˜
        user = self.get_user_by_id(user_id)
        if user:
            redis_client.delete(f"active_user:{user['username']}")
```

### 6.3 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸš€ æ‰¹é‡è½¯åˆ é™¤ä¼˜åŒ–**

```sql
-- âŒ ä½æ•ˆçš„é€æ¡åˆ é™¤
UPDATE users SET deleted_at = NOW() WHERE id = 1;
UPDATE users SET deleted_at = NOW() WHERE id = 2;
-- ... é‡å¤Næ¬¡

-- âœ… æ‰¹é‡åˆ é™¤ä¼˜åŒ–
UPDATE users 
SET deleted_at = NOW() 
WHERE id IN (1, 2, 3, ..., N);

-- ğŸš€ æ›´ä¼˜æ–¹æ¡ˆï¼šåˆ†æ‰¹å¤„ç†
-- é¿å…é•¿æ—¶é—´é”è¡¨
DELIMITER //
CREATE PROCEDURE batch_soft_delete(IN batch_size INT)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE batch_count INT DEFAULT 0;
    
    REPEAT
        UPDATE users 
        SET deleted_at = NOW() 
        WHERE deleted_at IS NULL 
        AND need_delete = 1  -- æ ‡è®°éœ€è¦åˆ é™¤çš„è®°å½•
        LIMIT batch_size;
        
        SET batch_count = ROW_COUNT();
        
        -- é¿å…é˜»å¡å…¶ä»–æ“ä½œ
        SELECT SLEEP(0.1);
        
    UNTIL batch_count = 0 END REPEAT;
END //
DELIMITER ;

-- ä½¿ç”¨ï¼šæ¯æ¬¡å¤„ç†1000æ¡
CALL batch_soft_delete(1000);
```

### 6.4 è¯»å†™åˆ†ç¦»ä¸‹çš„è½¯åˆ é™¤


**ğŸ”„ ä¸»ä»å¤åˆ¶ç¯å¢ƒä¼˜åŒ–**

```python
class UserServiceWithReadReplica:
    def __init__(self):
        self.master_db = get_master_connection()
        self.slave_db = get_slave_connection()
    
    def get_active_users(self, filters):
        # è¯»æ“ä½œä½¿ç”¨ä»åº“
        query = """
            SELECT * FROM users 
            WHERE deleted_at IS NULL
        """
        
        # æ·»åŠ ä¸šåŠ¡è¿‡æ»¤æ¡ä»¶
        if filters.get('department'):
            query += " AND department = %s"
            
        return self.slave_db.query(query, filters.values())
    
    def soft_delete_user(self, user_id):
        # å†™æ“ä½œä½¿ç”¨ä¸»åº“
        self.master_db.execute("""
            UPDATE users 
            SET deleted_at = NOW() 
            WHERE id = %s AND deleted_at IS NULL
        """, (user_id,))
        
        # æ¸…é™¤ç¼“å­˜ï¼Œé¿å…è¯»å–åˆ°è¿‡æœŸæ•°æ®
        self.clear_user_cache(user_id)
        
    def get_user_immediately_after_delete(self, user_id):
        # åˆ é™¤åç«‹å³æŸ¥è¯¢ï¼Œå¿…é¡»ä½¿ç”¨ä¸»åº“
        # é¿å…ä¸»ä»å»¶è¿Ÿå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
        return self.master_db.query("""
            SELECT * FROM users WHERE id = %s
        """, (user_id,))
```

---

## 7. ğŸ¯ æœ€ä½³å®è·µä¸æ¡ˆä¾‹


### 7.1 ç”µå•†ç³»ç»Ÿè½¯åˆ é™¤è®¾è®¡


**ğŸ›’ è®¢å•ç³»ç»Ÿæ¡ˆä¾‹**

```sql
-- è®¢å•è¡¨è®¾è®¡
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    order_no VARCHAR(32) NOT NULL UNIQUE,
    status ENUM('pending','paid','shipped','completed','cancelled'),
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    -- æ ¸å¿ƒç´¢å¼•è®¾è®¡
    INDEX idx_user_status_deleted (user_id, status, deleted_at),
    INDEX idx_orderno_deleted (order_no, deleted_at),
    INDEX idx_created_deleted (created_at, deleted_at),
    INDEX idx_deleted_created (deleted_at, created_at)  -- ç®¡ç†æŸ¥è¯¢ç”¨
);
```

**ğŸ“Š æŸ¥è¯¢æ¨¡å¼åˆ†æ**
```sql
-- ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
SELECT * FROM orders 
WHERE user_id = ? AND deleted_at IS NULL 
ORDER BY created_at DESC;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_user_status_deleted

-- æ ¹æ®è®¢å•å·æŸ¥è¯¢ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
SELECT * FROM orders 
WHERE order_no = ? AND deleted_at IS NULL;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_orderno_deleted

-- ç®¡ç†å‘˜æŸ¥çœ‹åˆ é™¤çš„è®¢å•ï¼ˆä½é¢‘æŸ¥è¯¢ï¼‰
SELECT * FROM orders 
WHERE deleted_at IS NOT NULL 
ORDER BY deleted_at DESC;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_deleted_created
```

### 7.2 ç”¨æˆ·ç³»ç»Ÿè½¯åˆ é™¤è®¾è®¡


**ğŸ‘¥ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ**

```sql
-- ç”¨æˆ·è¡¨è®¾è®¡
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    department_id INT,
    role_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    deleted_by BIGINT NULL,  -- è®°å½•åˆ é™¤æ“ä½œè€…
    
    -- ç´¢å¼•è®¾è®¡
    UNIQUE KEY uk_username_deleted (username, deleted_at),
    UNIQUE KEY uk_email_deleted (email, deleted_at),
    INDEX idx_department_deleted (department_id, deleted_at),
    INDEX idx_deleted_by_time (deleted_at, deleted_by)
);
```

> ğŸ’¡ **å”¯ä¸€æ€§çº¦æŸå¤„ç†**ï¼šè½¯åˆ é™¤åï¼Œusernameå’Œemailå¯èƒ½é‡å¤ï¼Œéœ€è¦å°†deleted_atåŒ…å«åœ¨å”¯ä¸€é”®ä¸­

**ğŸ”„ ä¸šåŠ¡é€»è¾‘å¤„ç†**
```python
class UserManager:
    def create_user(self, username, email):
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²åˆ é™¤çš„åŒåç”¨æˆ·
        existing = self.db.query("""
            SELECT id, deleted_at FROM users 
            WHERE username = %s OR email = %s
        """, (username, email))
        
        if existing and existing['deleted_at'] is None:
            raise ValueError("ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨")
            
        # å¦‚æœæ˜¯æ¢å¤åˆ é™¤çš„ç”¨æˆ·
        if existing and existing['deleted_at'] is not None:
            return self.restore_user(existing['id'])
        
        # åˆ›å»ºæ–°ç”¨æˆ·
        return self.db.execute("""
            INSERT INTO users (username, email) 
            VALUES (%s, %s)
        """, (username, email))
    
    def soft_delete_user(self, user_id, deleted_by):
        # æ‰§è¡Œè½¯åˆ é™¤
        result = self.db.execute("""
            UPDATE users 
            SET deleted_at = NOW(), deleted_by = %s 
            WHERE id = %s AND deleted_at IS NULL
        """, (deleted_by, user_id))
        
        if result.rowcount == 0:
            raise ValueError("ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²åˆ é™¤")
            
        # çº§è”å¤„ç†ç›¸å…³æ•°æ®ï¼ˆå¯é€‰ï¼‰
        self.handle_user_deletion(user_id)
```

### 7.3 æ€§èƒ½åŸºå‡†æµ‹è¯•


**ğŸ“Š å®é™…æ€§èƒ½å¯¹æ¯”æ•°æ®**

```
æµ‹è¯•ç¯å¢ƒï¼š
â€¢ æ•°æ®é‡ï¼š500ä¸‡ç”¨æˆ·è®°å½•
â€¢ åˆ é™¤æ¯”ä¾‹ï¼š15% (75ä¸‡åˆ é™¤è®°å½•)
â€¢ ç¡¬ä»¶ï¼š4æ ¸8Gï¼ŒSSDå­˜å‚¨

æµ‹è¯•æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE username = ? AND deleted_at IS NULL;

æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç´¢å¼•ç­–ç•¥        â”‚ å¹³å‡å“åº”  â”‚ QPSèƒ½åŠ›  â”‚ ç´¢å¼•å¤§å°   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— è½¯åˆ é™¤ç´¢å¼•         â”‚   800ms  â”‚    12    â”‚     -      â”‚
â”‚ (username)          â”‚          â”‚          â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (username,deleted_at)â”‚    15ms  â”‚   650    â”‚   180MB    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ (deleted_at,username)â”‚    18ms  â”‚   580    â”‚   165MB    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¦†ç›–ç´¢å¼•             â”‚     8ms  â”‚  1200    â”‚   350MB    â”‚
â”‚ (username,deleted_at,â”‚          â”‚          â”‚            â”‚
â”‚  id,email,created_at)â”‚          â”‚          â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼šåˆé€‚çš„è½¯åˆ é™¤ç´¢å¼•èƒ½æå‡æ€§èƒ½40-100å€ï¼
```

### 7.4 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ å¸¸è§æ€§èƒ½é™·é˜±**

```sql
-- é™·é˜±1ï¼šå¿˜è®°åœ¨JOINæŸ¥è¯¢ä¸­å¤„ç†è½¯åˆ é™¤
-- âŒ é”™è¯¯å†™æ³•
SELECT u.username, p.title 
FROM users u
JOIN posts p ON u.id = p.user_id
WHERE u.username = 'john';
-- é—®é¢˜ï¼šå¯èƒ½è¿”å›å·²åˆ é™¤ç”¨æˆ·çš„æ–‡ç« 

-- âœ… æ­£ç¡®å†™æ³•
SELECT u.username, p.title 
FROM users u
JOIN posts p ON u.id = p.user_id
WHERE u.username = 'john'
AND u.deleted_at IS NULL
AND p.deleted_at IS NULL;
-- ç´¢å¼•ï¼šusers(username, deleted_at), posts(user_id, deleted_at)
```

```sql
-- é™·é˜±2ï¼šCOUNTæŸ¥è¯¢æœªè€ƒè™‘è½¯åˆ é™¤
-- âŒ é”™è¯¯ç»Ÿè®¡
SELECT COUNT(*) FROM users;  -- åŒ…å«å·²åˆ é™¤ç”¨æˆ·

-- âœ… æ­£ç¡®ç»Ÿè®¡
SELECT COUNT(*) FROM users WHERE deleted_at IS NULL;
-- æˆ–è€…ä½¿ç”¨è§†å›¾ç®€åŒ–
CREATE VIEW active_users AS
SELECT * FROM users WHERE deleted_at IS NULL;

SELECT COUNT(*) FROM active_users;
```

**ğŸ”§ è§£å†³æ–¹æ¡ˆæ¨¡å¼**

```python
# æ•°æ®è®¿é—®å±‚ç»Ÿä¸€å¤„ç†è½¯åˆ é™¤
class BaseModel:
    def __init__(self):
        self.include_deleted = False
    
    def where_not_deleted(self):
        if not self.include_deleted:
            return "deleted_at IS NULL"
        return "1=1"
    
    def find_by_id(self, id):
        return self.db.query(f"""
            SELECT * FROM {self.table_name} 
            WHERE id = %s AND {self.where_not_deleted()}
        """, (id,))
    
    def find_all(self, conditions=None):
        base_query = f"SELECT * FROM {self.table_name} WHERE {self.where_not_deleted()}"
        
        if conditions:
            base_query += f" AND {conditions}"
            
        return self.db.query(base_query)

# ä½¿ç”¨ç¤ºä¾‹
class UserModel(BaseModel):
    table_name = 'users'
    
    def get_by_username(self, username):
        return self.db.query(f"""
            SELECT * FROM users 
            WHERE username = %s AND {self.where_not_deleted()}
        """, (username,))
```

---

## 8. ğŸ› ï¸ ç»´æŠ¤ä¸ç›‘æ§ç­–ç•¥


### 8.1 è½¯åˆ é™¤æ•°æ®æ¸…ç†


**ğŸ—‘ï¸ å®šæœŸæ¸…ç†ç­–ç•¥**

```sql
-- ç‰©ç†åˆ é™¤è¿‡æœŸçš„è½¯åˆ é™¤æ•°æ®
-- åœºæ™¯ï¼šåˆ é™¤è¶…è¿‡1å¹´çš„è½¯åˆ é™¤è®°å½•

-- åˆ†æ‰¹åˆ é™¤é¿å…é”è¡¨
DELIMITER //
CREATE PROCEDURE cleanup_soft_deleted()
BEGIN
    DECLARE batch_size INT DEFAULT 1000;
    DECLARE deleted_count INT;
    
    REPEAT
        DELETE FROM users 
        WHERE deleted_at IS NOT NULL 
        AND deleted_at < DATE_SUB(NOW(), INTERVAL 1 YEAR)
        LIMIT batch_size;
        
        SET deleted_count = ROW_COUNT();
        
        -- è®°å½•æ¸…ç†æ—¥å¿—
        INSERT INTO cleanup_log (table_name, deleted_count, cleanup_time)
        VALUES ('users', deleted_count, NOW());
        
        -- çŸ­æš‚ä¼‘æ¯é¿å…å½±å“ä¸šåŠ¡
        SELECT SLEEP(0.5);
        
    UNTIL deleted_count = 0 END REPEAT;
END //
DELIMITER ;

-- å®šæœŸæ‰§è¡Œæ¸…ç†
CREATE EVENT monthly_cleanup
ON SCHEDULE EVERY 1 MONTH
DO CALL cleanup_soft_deleted();
```

### 8.2 ç´¢å¼•ç»´æŠ¤ç›‘æ§


**ğŸ“Š ç´¢å¼•æ•ˆæœç›‘æ§æŸ¥è¯¢**

```sql
-- ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    s.table_name,
    s.index_name,
    s.cardinality,
    s.cardinality / t.table_rows as selectivity,
    us.handler_read as index_reads
FROM information_schema.statistics s
JOIN information_schema.tables t USING(table_schema, table_name)
LEFT JOIN information_schema.index_statistics us 
    ON s.table_schema = us.table_schema 
    AND s.table_name = us.table_name 
    AND s.index_name = us.index_name
WHERE s.table_schema = 'your_db'
AND s.index_name LIKE '%deleted%'
ORDER BY selectivity DESC;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„è½¯åˆ é™¤ç›¸å…³ç´¢å¼•
SELECT 
    table_schema,
    table_name,
    index_name
FROM information_schema.statistics
WHERE table_schema = 'your_db'
AND index_name LIKE '%deleted%'
AND index_name NOT IN (
    SELECT DISTINCT index_name 
    FROM information_schema.index_statistics
    WHERE handler_read > 0
);
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è½¯åˆ é™¤æœ¬è´¨ï¼šæ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤ï¼Œæ•°æ®ä»åœ¨è¡¨ä¸­
ğŸ”¸ ç´¢å¼•è®¾è®¡æ ¸å¿ƒï¼šå°†è½¯åˆ é™¤å­—æ®µçº³å…¥æ‰€æœ‰ç›¸å…³ç´¢å¼•
ğŸ”¸ å­—æ®µä½ç½®ç­–ç•¥ï¼šæ ¹æ®åˆ é™¤æ¯”ä¾‹å†³å®šdeleted_atåœ¨ç´¢å¼•ä¸­çš„ä½ç½®
ğŸ”¸ é€‰æ‹©æ€§åˆ†æï¼šä½é€‰æ‹©æ€§å­—æ®µå½±å“ç´¢å¼•è®¾è®¡å’ŒæŸ¥è¯¢æ€§èƒ½
ğŸ”¸ æŸ¥è¯¢ä¼˜åŒ–ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½è¦åŒ…å«è½¯åˆ é™¤æ¡ä»¶æ£€æŸ¥
```

### 9.2 å…³é”®è®¾è®¡åŸåˆ™


**ğŸ”¹ ç´¢å¼•è®¾è®¡åŸåˆ™**
```
ä½ç½®é€‰æ‹©ï¼š
â€¢ åˆ é™¤æ¯”ä¾‹ < 10% â†’ deleted_at æ”¾ç´¢å¼•æœ«ä½
â€¢ åˆ é™¤æ¯”ä¾‹ > 30% â†’ deleted_at æ”¾ç´¢å¼•é¦–ä½
â€¢ ä¸­é—´æ¯”ä¾‹ â†’ æ ¹æ®å…·ä½“æŸ¥è¯¢æ¨¡å¼å†³å®š

å­—æ®µé¡ºåºï¼š
â€¢ é«˜é€‰æ‹©æ€§å­—æ®µä¼˜å…ˆï¼ˆå¦‚user_id, emailï¼‰
â€¢ æŸ¥è¯¢é¢‘ç‡é«˜çš„å­—æ®µä¼˜å…ˆ
â€¢ æ’åºå­—æ®µæ”¾åœ¨æœ€å
```

**ğŸ”¹ æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™**
```
å¿…åšäº‹é¡¹ï¼š
âœ… æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« deleted_at IS NULL
âœ… JOINæŸ¥è¯¢ä¸¤è¾¹éƒ½è¦æ£€æŸ¥è½¯åˆ é™¤çŠ¶æ€  
âœ… COUNTç»Ÿè®¡è¦æ’é™¤è½¯åˆ é™¤æ•°æ®
âœ… å”¯ä¸€æ€§çº¦æŸè¦åŒ…å«deleted_atå­—æ®µ

æ€§èƒ½ä¼˜åŒ–ï¼š
ğŸš€ ä½¿ç”¨å¤åˆç´¢å¼•é¿å…å›è¡¨
ğŸš€ åˆ†æ‰¹æ“ä½œé¿å…é•¿æ—¶é—´é”è¡¨
ğŸš€ é€‚å½“ä½¿ç”¨è¦†ç›–ç´¢å¼•
ğŸš€ åˆç†ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚åˆè½¯åˆ é™¤ï¼š
âœ… éœ€è¦æ•°æ®æ¢å¤åŠŸèƒ½
âœ… éœ€è¦åˆ é™¤æ•°æ®ç»Ÿè®¡åˆ†æ
âœ… æœ‰å®¡è®¡åˆè§„è¦æ±‚
âœ… å…³è”æ•°æ®è¾ƒå¤šï¼Œç¡¬åˆ é™¤å½±å“å¤§

ä¸é€‚åˆè½¯åˆ é™¤ï¼š
âŒ æ•°æ®éšç§è¦æ±‚ç‰©ç†åˆ é™¤
âŒ å­˜å‚¨ç©ºé—´æåº¦æ•æ„Ÿ
âŒ åˆ é™¤æ•°æ®æ— ä»»ä½•ä»·å€¼
âŒ ç³»ç»Ÿæ€§èƒ½è¦æ±‚æé«˜
```

**ğŸ”§ å®æ–½æ­¥éª¤**
```
ç¬¬1æ­¥ï¼šè®¾è®¡è½¯åˆ é™¤å­—æ®µ
â€¢ æ¨èä½¿ç”¨ deleted_at TIMESTAMP NULL
â€¢ è€ƒè™‘æ˜¯å¦éœ€è¦ deleted_by å­—æ®µ

ç¬¬2æ­¥ï¼šåˆ†ææŸ¥è¯¢æ¨¡å¼
â€¢ ç»Ÿè®¡å„ç§æŸ¥è¯¢çš„é¢‘ç‡
â€¢ åˆ†æå­—æ®µçš„é€‰æ‹©æ€§
â€¢ ç¡®å®šç´¢å¼•è®¾è®¡ç­–ç•¥

ç¬¬3æ­¥ï¼šåˆ›å»ºå¤åˆç´¢å¼•
â€¢ æ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡å¤åˆç´¢å¼•
â€¢ è€ƒè™‘æ˜¯å¦éœ€è¦è¦†ç›–ç´¢å¼•
â€¢ ç›‘æ§ç´¢å¼•ä½¿ç”¨æ•ˆæœ

ç¬¬4æ­¥ï¼šä¼˜åŒ–åº”ç”¨ä»£ç 
â€¢ æ‰€æœ‰æŸ¥è¯¢æ·»åŠ è½¯åˆ é™¤æ£€æŸ¥
â€¢ å®ç°ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚
â€¢ æ·»åŠ ç¼“å­˜å’Œæ‰¹é‡æ“ä½œä¼˜åŒ–

ç¬¬5æ­¥ï¼šç›‘æ§å’Œç»´æŠ¤
â€¢ å®šæœŸåˆ†æåˆ é™¤æ•°æ®æ¯”ä¾‹
â€¢ ç›‘æ§æŸ¥è¯¢æ€§èƒ½å˜åŒ–
â€¢ æ¸…ç†è¿‡æœŸçš„è½¯åˆ é™¤æ•°æ®
```

### 9.4 æ€§èƒ½ä¼˜åŒ–è®°å¿†è¦ç‚¹


> ğŸ”‘ **æ ¸å¿ƒè®°å¿†**ï¼šè½¯åˆ é™¤ç´¢å¼•è®¾è®¡çš„æœ¬è´¨æ˜¯åœ¨æŸ¥è¯¢æ€§èƒ½å’Œå­˜å‚¨æˆæœ¬é—´æ‰¾å¹³è¡¡

```
â”Œâ”€ è®°å¿†å£è¯€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¯åˆ é™¤ç´¢å¼•æœ‰æŠ€å·§                   â”‚
â”‚ å­—æ®µä½ç½®çœ‹æ¯”ä¾‹                     â”‚
â”‚ åˆ é™¤å°‘æ—¶æ”¾æœ«å°¾                     â”‚
â”‚ åˆ é™¤å¤šæ—¶æ”¾å¼€å¤´                     â”‚
â”‚ æŸ¥è¯¢å¿…å¸¦åˆ é™¤æ¡ä»¶                   â”‚
â”‚ æ€§èƒ½æå‡æ•ˆæœå¦™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Œ é¢è¯•é‡ç‚¹**
- è½¯åˆ é™¤çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯
- å¤åˆç´¢å¼•ä¸­å­—æ®µé¡ºåºçš„è®¾è®¡åŸåˆ™
- å¦‚ä½•å¤„ç†è½¯åˆ é™¤çš„å”¯ä¸€æ€§çº¦æŸé—®é¢˜
- è½¯åˆ é™¤å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“å’Œä¼˜åŒ–æ–¹æ³•

**ğŸš€ å®æˆ˜æŠ€å·§**
- å§‹ç»ˆä½¿ç”¨ `deleted_at IS NULL` è€Œä¸æ˜¯ `deleted_at = 0`
- åœ¨åº”ç”¨å±‚å°è£…è½¯åˆ é™¤é€»è¾‘ï¼Œé¿å…é—æ¼
- å®šæœŸç›‘æ§è½¯åˆ é™¤æ•°æ®æ¯”ä¾‹ï¼ŒåŠæ—¶è°ƒæ•´ç´¢å¼•ç­–ç•¥
- è€ƒè™‘è¯»å†™åˆ†ç¦»ç¯å¢ƒä¸‹çš„ä¸»ä»åŒæ­¥é—®é¢˜

**æ ¸å¿ƒç†è§£**ï¼šè½¯åˆ é™¤ç´¢å¼•è®¾è®¡æ˜¯åœ¨æ•°æ®å®Œæ•´æ€§ã€æŸ¥è¯¢æ€§èƒ½ã€å­˜å‚¨æˆæœ¬ä¸‰è€…é—´çš„æƒè¡¡è‰ºæœ¯ï¼Œå…³é”®æ˜¯ç†è§£ä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼å¹¶æ®æ­¤è®¾è®¡æœ€ä¼˜çš„ç´¢å¼•ç­–ç•¥ã€‚