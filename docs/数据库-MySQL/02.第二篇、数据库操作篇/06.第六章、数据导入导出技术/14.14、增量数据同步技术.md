---
title: 14ã€å¢é‡æ•°æ®åŒæ­¥æŠ€æœ¯
---
## ğŸ“š ç›®å½•

1. [å¢é‡æ•°æ®åŒæ­¥æ¦‚è¿°](#1-å¢é‡æ•°æ®åŒæ­¥æ¦‚è¿°)
2. [CDCå˜æ›´æ•°æ®æ•è·æŠ€æœ¯](#2-CDCå˜æ›´æ•°æ®æ•è·æŠ€æœ¯)
3. [binlogå¢é‡åŒæ­¥å®æˆ˜](#3-binlogå¢é‡åŒæ­¥å®æˆ˜)
4. [è§¦å‘å™¨å¢é‡æ•è·æ–¹æ¡ˆ](#4-è§¦å‘å™¨å¢é‡æ•è·æ–¹æ¡ˆ)
5. [æ—¶é—´æˆ³å­—æ®µè®¾è®¡ç­–ç•¥](#5-æ—¶é—´æˆ³å­—æ®µè®¾è®¡ç­–ç•¥)
6. [å¢é‡æ•°æ®å»é‡å¤„ç†](#6-å¢é‡æ•°æ®å»é‡å¤„ç†)
7. [åŒæ­¥å†²çªå¤„ç†æœºåˆ¶](#7-åŒæ­¥å†²çªå¤„ç†æœºåˆ¶)
8. [æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥](#8-æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥)
9. [åŒæ­¥æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#9-åŒæ­¥æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
10. [åŒæ­¥ç›‘æ§å‘Šè­¦ä½“ç³»](#10-åŒæ­¥ç›‘æ§å‘Šè­¦ä½“ç³»)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š å¢é‡æ•°æ®åŒæ­¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¢é‡æ•°æ®åŒæ­¥


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ æœ‰ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼š
- æºæ–‡ä»¶å¤¹ï¼šä¸»è¦å·¥ä½œç›®å½•ï¼Œæ–‡ä»¶ç»å¸¸å˜åŒ–
- å¤‡ä»½æ–‡ä»¶å¤¹ï¼šå¤‡ä»½ç›®å½•ï¼Œéœ€è¦ä¿æŒåŒæ­¥

å…¨é‡åŒæ­¥ï¼šæ¯æ¬¡éƒ½æŠŠæ•´ä¸ªæºæ–‡ä»¶å¤¹å®Œå…¨å¤åˆ¶ä¸€é
å¢é‡åŒæ­¥ï¼šåªå¤åˆ¶è‡ªä¸Šæ¬¡åŒæ­¥åå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶

æ•°æ®åº“çš„å¢é‡åŒæ­¥å°±æ˜¯è¿™ä¸ªé“ç†ï¼
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
å¢é‡æ•°æ®åŒæ­¥ï¼šåªä¼ è¾“å’Œå¤„ç†è‡ªä¸Šæ¬¡åŒæ­¥åå‘ç”Ÿå˜åŒ–çš„æ•°æ®
ç›®æ ‡ï¼šæé«˜åŒæ­¥æ•ˆç‡ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼Œå®ç°å‡†å®æ—¶æ•°æ®åŒæ­¥
æ ¸å¿ƒæ€æƒ³ï¼šå˜åŒ–é©±åŠ¨ï¼ŒæŒ‰éœ€ä¼ è¾“
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¢é‡åŒæ­¥


**âŒ å…¨é‡åŒæ­¥çš„é—®é¢˜**
```
åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿæœ‰1000ä¸‡å•†å“æ•°æ®
å…¨é‡åŒæ­¥é—®é¢˜ï¼š
â€¢ æ—¶é—´æˆæœ¬ï¼šæ¯æ¬¡åŒæ­¥éœ€è¦å‡ å°æ—¶
â€¢ ç½‘ç»œæˆæœ¬ï¼šä¼ è¾“å‡ GBæ•°æ®
â€¢ èµ„æºæˆæœ¬ï¼šå ç”¨å¤§é‡CPUã€å†…å­˜ã€ç£ç›˜IO
â€¢ ä¸šåŠ¡å½±å“ï¼šåŒæ­¥æœŸé—´å¯èƒ½å½±å“æ­£å¸¸ä¸šåŠ¡

å®é™…å˜åŒ–ï¼šå¯èƒ½åªæœ‰100ä¸ªå•†å“å‘ç”Ÿäº†å˜åŒ–
æµªè´¹æ¯”ä¾‹ï¼š99.999%çš„ä¼ è¾“éƒ½æ˜¯æ— æ•ˆçš„
```

**âœ… å¢é‡åŒæ­¥çš„ä¼˜åŠ¿**
```
æ•ˆç‡æå‡ï¼š
â€¢ åªå¤„ç†å˜åŒ–æ•°æ®ï¼Œé€Ÿåº¦å¿«100-1000å€
â€¢ ç½‘ç»œä¼ è¾“é‡å‡å°‘90%ä»¥ä¸Š
â€¢ ç³»ç»Ÿèµ„æºæ¶ˆè€—å¤§å¹…é™ä½

ä¸šåŠ¡å‹å¥½ï¼š
â€¢ å‡†å®æ—¶åŒæ­¥ï¼Œæ•°æ®å»¶è¿Ÿé™ä½åˆ°åˆ†é’Ÿçº§ç”šè‡³ç§’çº§
â€¢ å¯¹æºç³»ç»Ÿå½±å“æœ€å°
â€¢ æ”¯æŒ7Ã—24å°æ—¶è¿ç»­åŒæ­¥
```

### 1.3 å¢é‡åŒæ­¥çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ¤” éœ€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
è¯†åˆ«é—®é¢˜ï¼šå¦‚ä½•å‡†ç¡®è¯†åˆ«å“ªäº›æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Ÿ
æ—¶åºé—®é¢˜ï¼šå¦‚ä½•ä¿è¯å˜åŒ–çš„é¡ºåºæ­£ç¡®ï¼Ÿ
ä¸¢å¤±é—®é¢˜ï¼šå¦‚ä½•ç¡®ä¿æ²¡æœ‰é—æ¼ä»»ä½•å˜åŒ–ï¼Ÿ
å†²çªé—®é¢˜ï¼šå¤šä¸ªç³»ç»ŸåŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®æ€ä¹ˆåŠï¼Ÿ
ä¸€è‡´æ€§ï¼šå¦‚ä½•ä¿è¯æœ€ç»ˆæ•°æ®çš„ä¸€è‡´æ€§ï¼Ÿ
```

### 1.4 å¢é‡åŒæ­¥æŠ€æœ¯åˆ†ç±»


**ğŸ“Š æŒ‰æ•è·æ–¹å¼åˆ†ç±»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å¢é‡åŒæ­¥æŠ€æœ¯               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¥å¿—æ•è·   â”‚  è§¦å‘å™¨æ•è·  â”‚  æ—¶é—´æˆ³æ•è·  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   binlog    â”‚   INSERT    â”‚ created_at  â”‚
â”‚   redo log  â”‚   UPDATE    â”‚ updated_at  â”‚
â”‚   wal log   â”‚   DELETE    â”‚ version     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“ˆ æŒ‰åŒæ­¥æ¨¡å¼åˆ†ç±»**
```
å®æ—¶åŒæ­¥ï¼šå˜åŒ–ç«‹å³ä¼ è¾“ï¼ˆå»¶è¿Ÿç§’çº§ï¼‰
å‡†å®æ—¶åŒæ­¥ï¼šå®šæ—¶æ£€æŸ¥å˜åŒ–ï¼ˆå»¶è¿Ÿåˆ†é’Ÿçº§ï¼‰
æ‰¹é‡åŒæ­¥ï¼šå®šæœŸæ‰¹é‡å¤„ç†ï¼ˆå»¶è¿Ÿå°æ—¶çº§ï¼‰
```

---

## 2. ğŸ”„ CDCå˜æ›´æ•°æ®æ•è·æŠ€æœ¯


### 2.1 CDCåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ CDCæ˜¯ä»€ä¹ˆ**
```
CDCï¼ˆChange Data Captureï¼‰ï¼šå˜æ›´æ•°æ®æ•è·
é€šä¿—ç†è§£ï¼šåƒç›‘æ§æ‘„åƒå¤´ä¸€æ ·ï¼Œå®æ—¶è®°å½•æ•°æ®åº“çš„æ‰€æœ‰å˜åŒ–

å·¥ä½œåŸç†ï¼š
æ•°æ®åº“ â†’ å‘ç”Ÿå˜åŒ– â†’ CDCç³»ç»Ÿæ•è· â†’ è®°å½•å˜æ›´ â†’ ä¼ è¾“ç»™ç›®æ ‡ç³»ç»Ÿ

å°±åƒé“¶è¡Œçš„äº¤æ˜“è®°å½•ä¸€æ ·ï¼Œæ¯ç¬”æ“ä½œéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—ï¼
```

**ğŸ’¡ CDCçš„æ ¸å¿ƒä»·å€¼**
```
å®æ—¶æ€§ï¼šå˜åŒ–å‘ç”Ÿæ—¶ç«‹å³æ•è·
å®Œæ•´æ€§ï¼šä¸é—æ¼ä»»ä½•æ•°æ®å˜åŒ–
ä½ä¾µå…¥ï¼šå¯¹æºç³»ç»Ÿå½±å“æå°
æ ¼å¼ç»Ÿä¸€ï¼šæä¾›æ ‡å‡†åŒ–çš„å˜æ›´æ ¼å¼
```

### 2.2 CDCå®ç°åŸç†


**ğŸ” åŸºäºäº‹åŠ¡æ—¥å¿—çš„CDC**
```
æ•°æ®åº“äº‹åŠ¡æ—¥å¿—å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·æ“ä½œ â†’ æ•°æ®åº“å¼•æ“ â†’ å†™å…¥äº‹åŠ¡æ—¥å¿— â†’ æ›´æ–°æ•°æ®æ–‡ä»¶
                                â†“
                          CDCç³»ç»Ÿè¯»å–æ—¥å¿—
                                â†“
                          è§£æå˜æ›´å†…å®¹
                                â†“
                          å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ

ä¼˜åŠ¿ï¼š
â€¢ æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç 
â€¢ æ•è·æ‰€æœ‰æ•°æ®å˜åŒ–
â€¢ å¯¹æ•°æ®åº“æ€§èƒ½å½±å“æœ€å°
```

### 2.3 CDCæŠ€æœ¯å¯¹æ¯”


**ğŸ“Š ä¸»æµCDCæŠ€æœ¯å¯¹æ¯”**

| æŠ€æœ¯æ–¹æ¡ˆ | **å®ç°æ–¹å¼** | **å®æ—¶æ€§** | **å¤æ‚åº¦** | **æ€§èƒ½å½±å“** | **é€‚ç”¨åœºæ™¯** |
|----------|-------------|-----------|-----------|-------------|-------------|
| **MySQL binlog** | `è¯»å–äºŒè¿›åˆ¶æ—¥å¿—` | â­â­â­â­â­ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ æä½ | `MySQLä¸»ä»åŒæ­¥` |
| **PostgreSQL WAL** | `é¢„å†™å¼æ—¥å¿—` | â­â­â­â­â­ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ æä½ | `PostgreSQLå¤åˆ¶` |
| **Oracle LogMiner** | `æŒ–æ˜é‡åšæ—¥å¿—` | â­â­â­â­ | ğŸ”´ å¤æ‚ | ğŸŸ¡ ä¸­ç­‰ | `Oracleæ•°æ®ä»“åº“` |
| **SQL Server CT** | `å˜æ›´è·Ÿè¸ªè¡¨` | â­â­â­ | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸­ç­‰ | `SQL ServeråŒæ­¥` |
| **Debezium** | `ç»Ÿä¸€CDCå¹³å°` | â­â­â­â­â­ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ä½ | `å¤šæ•°æ®åº“CDC` |

### 2.4 CDCå®ç°æ¡ˆä¾‹


**ğŸ› ï¸ Debezium CDCé…ç½®ç¤ºä¾‹**
```json
{
  "name": "mysql-connector",
  "config": {
    "connector.class": "io.debezium.connector.mysql.MySqlConnector",
    "database.hostname": "mysql-server",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "password",
    "database.server.id": "1001",
    "database.server.name": "mysql",
    "database.include.list": "inventory",
    "table.include.list": "inventory.customers,inventory.orders"
  }
}
```

**ğŸ“ CDCæ¶ˆæ¯æ ¼å¼ç¤ºä¾‹**
```json
{
  "before": {
    "id": 1001,
    "name": "å¼ ä¸‰",
    "email": "zhangsan@example.com"
  },
  "after": {
    "id": 1001,
    "name": "å¼ ä¸‰",
    "email": "zhangsan@newmail.com"
  },
  "source": {
    "version": "1.9.0",
    "connector": "mysql",
    "name": "mysql",
    "ts_ms": 1693834567890,
    "snapshot": "false",
    "db": "customer_db",
    "table": "users"
  },
  "op": "u",  // u=update, c=create, d=delete
  "ts_ms": 1693834567892
}
```

> **ğŸ’¡ ç†è§£è¦ç‚¹ï¼š** CDCè®°å½•äº†æ•°æ®å˜åŒ–çš„å®Œæ•´ä¿¡æ¯ï¼ŒåŒ…æ‹¬å˜åŒ–å‰åçš„å€¼ã€å˜åŒ–ç±»å‹ã€æ—¶é—´æˆ³ç­‰ï¼Œå°±åƒé“¶è¡Œçš„äº¤æ˜“æ˜ç»†ä¸€æ ·è¯¦ç»†ã€‚

---

## 3. ğŸ“Š binlogå¢é‡åŒæ­¥å®æˆ˜


### 3.1 MySQL binlogåŸºç¡€


**ğŸ”¸ binlogæ˜¯ä»€ä¹ˆ**
```
binlogï¼ˆBinary Logï¼‰ï¼šMySQLçš„äºŒè¿›åˆ¶æ—¥å¿—
é€šä¿—ç†è§£ï¼šMySQLçš„"é»‘åŒ£å­"ï¼Œè®°å½•æ‰€æœ‰æ•°æ®å˜åŒ–æ“ä½œ

ä½œç”¨ï¼š
â€¢ ä¸»ä»å¤åˆ¶ï¼šä¸»åº“binlog â†’ ä»åº“é‡æ”¾
â€¢ æ•°æ®æ¢å¤ï¼šé€šè¿‡binlogå›æ»šåˆ°ä»»æ„æ—¶é—´ç‚¹
â€¢ å¢é‡åŒæ­¥ï¼šè¯»å–binlogè·å–æ•°æ®å˜åŒ–
```

**ğŸ’­ binlogå·¥ä½œåŸç†**
```
ç”¨æˆ·æ‰§è¡ŒSQL â†’ MySQLå¼•æ“å¤„ç† â†’ å†™å…¥binlog â†’ æ›´æ–°æ•°æ®æ–‡ä»¶
                                    â†“
                              ç¬¬ä¸‰æ–¹å·¥å…·è¯»å–
                                    â†“
                              è§£æå˜æ›´å†…å®¹
                                    â†“
                              åŒæ­¥åˆ°ç›®æ ‡ç³»ç»Ÿ

æ ¸å¿ƒä¼˜åŠ¿ï¼šå®æ—¶ã€å®Œæ•´ã€ä½ä¾µå…¥
```

### 3.2 binlogæ ¼å¼è¯¦è§£


**ğŸ“‹ binlogä¸‰ç§æ ¼å¼å¯¹æ¯”**

| æ ¼å¼ç±»å‹ | **è®°å½•å†…å®¹** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|----------|-------------|---------|---------|-------------|
| **STATEMENT** | `SQLè¯­å¥åŸæ–‡` | æ–‡ä»¶å°ï¼Œå¯è¯»æ€§å¼º | ä¸»ä»ä¸ä¸€è‡´é£é™© | ç®€å•æŸ¥è¯¢ |
| **ROW** | `æ•°æ®è¡Œå˜åŒ–` | æ•°æ®ä¸€è‡´æ€§å¥½ | æ–‡ä»¶å¤§ï¼Œä¸å¯è¯» | æ•°æ®åŒæ­¥ |
| **MIXED** | `æ··åˆæ¨¡å¼` | å¹³è¡¡å„ç§éœ€æ±‚ | å¤æ‚åº¦é«˜ | ç”Ÿäº§ç¯å¢ƒ |

**ğŸ”§ binlogé…ç½®å¯ç”¨**
```sql
-- æ£€æŸ¥binlogçŠ¶æ€
SHOW VARIABLES LIKE 'log_bin';

-- å¯ç”¨binlogï¼ˆéœ€è¦é‡å¯MySQLï¼‰
-- åœ¨my.cnfä¸­æ·»åŠ ï¼š
-- log-bin=mysql-bin
-- binlog-format=ROW
-- server-id=1

-- æŸ¥çœ‹binlogæ–‡ä»¶
SHOW BINARY LOGS;

-- æŸ¥çœ‹binlogå†…å®¹
SHOW BINLOG EVENTS IN 'mysql-bin.000001';
```

### 3.3 binlogå¢é‡åŒæ­¥å®ç°


**ğŸ› ï¸ åŸºäºCanalçš„binlogåŒæ­¥**
```java
// Canalå®¢æˆ·ç«¯ç¤ºä¾‹
public class CanalSyncClient {
    
    public void startSync() {
        // 1. è¿æ¥CanalæœåŠ¡å™¨
        CanalConnector connector = CanalConnectors.newSingleConnector(
            new InetSocketAddress("127.0.0.1", 11111),
            "example", "root", "password"
        );
        
        try {
            connector.connect();
            connector.subscribe("test\\..*");  // è®¢é˜…æ•°æ®åº“è¡¨
            
            while (true) {
                // 2. è·å–å˜æ›´æ•°æ®
                Message message = connector.getWithoutAck(100);
                
                if (message.getId() != -1) {
                    processChanges(message.getEntries());
                    connector.ack(message.getId());  // ç¡®è®¤å¤„ç†
                }
                
                Thread.sleep(1000);  // è½®è¯¢é—´éš”
            }
        } finally {
            connector.disconnect();
        }
    }
    
    private void processChanges(List<Entry> entries) {
        for (Entry entry : entries) {
            if (entry.getEntryType() == EntryType.ROWDATA) {
                RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                String tableName = entry.getHeader().getTableName();
                
                for (RowData rowData : rowChange.getRowDatasList()) {
                    switch (rowChange.getEventType()) {
                        case INSERT:
                            handleInsert(tableName, rowData.getAfterColumnsList());
                            break;
                        case UPDATE:
                            handleUpdate(tableName, rowData.getBeforeColumnsList(), 
                                       rowData.getAfterColumnsList());
                            break;
                        case DELETE:
                            handleDelete(tableName, rowData.getBeforeColumnsList());
                            break;
                    }
                }
            }
        }
    }
}
```

**ğŸ“Š binlogåŒæ­¥æ¶æ„å›¾**
```
        MySQLä¸»åº“
            â†“ binlog
     CanalæœåŠ¡å™¨ â† è§£æbinlog
            â†“ å˜æ›´äº‹ä»¶
     ä¸šåŠ¡åº”ç”¨ â† å¤„ç†å˜æ›´
            â†“
        ç›®æ ‡ç³»ç»Ÿ
     (ES/Redis/å…¶ä»–æ•°æ®åº“)
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£ï¼š** binlogåŒæ­¥çš„æœ¬è´¨æ˜¯"å·å¬"MySQLçš„å†…éƒ¨å¯¹è¯ï¼Œç„¶åæŠŠå¬åˆ°çš„å˜åŒ–å‘Šè¯‰å…¶ä»–ç³»ç»Ÿã€‚

### 3.4 binlogåŒæ­¥æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦é…ç½®è¦ç‚¹**
```
binlogæ ¼å¼é€‰æ‹©ï¼š
â€¢ ROWæ ¼å¼ï¼šæ¨èç”¨äºæ•°æ®åŒæ­¥ï¼Œè®°å½•å…·ä½“æ•°æ®å˜åŒ–
â€¢ server-idï¼šä¸»ä»ç¯å¢ƒå¿…é¡»å”¯ä¸€
â€¢ binlogä¿ç•™ï¼šæ ¹æ®åŒæ­¥å»¶è¿Ÿè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ binlogå†™å…¥ä¼šç•¥å¾®å½±å“MySQLæ€§èƒ½
â€¢ å»ºè®®ä½¿ç”¨SSDå­˜å‚¨binlogæ–‡ä»¶
â€¢ ç›‘æ§binlogæ–‡ä»¶å¤§å°å’Œç£ç›˜ç©ºé—´
```

---

## 4. âš¡ è§¦å‘å™¨å¢é‡æ•è·æ–¹æ¡ˆ


### 4.1 è§¦å‘å™¨æ•è·åŸç†


**ğŸ”¸ è§¦å‘å™¨æ˜¯ä»€ä¹ˆ**
```
è§¦å‘å™¨ï¼ˆTriggerï¼‰ï¼šæ•°æ®åº“çš„"è‡ªåŠ¨æœºå™¨äºº"
ä½œç”¨ï¼šå½“è¡¨å‘ç”ŸINSERTã€UPDATEã€DELETEæ“ä½œæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œé¢„è®¾çš„ä»£ç 

å°±åƒé—¨ç¦ç³»ç»Ÿä¸€æ ·ï¼š
â€¢ æœ‰äººè¿›å‡ºæ—¶ï¼ˆæ•°æ®å˜åŒ–ï¼‰
â€¢ è‡ªåŠ¨è®°å½•æ—¥å¿—ï¼ˆè§¦å‘å™¨æ‰§è¡Œï¼‰
â€¢ è®°å½•è°ã€ä»€ä¹ˆæ—¶é—´ã€åšäº†ä»€ä¹ˆï¼ˆå˜æ›´è®°å½•ï¼‰
```

**ğŸ’» è§¦å‘å™¨å¢é‡æ•è·æ¶æ„**
```
åŸå§‹è¡¨ â†’ æ•°æ®å˜åŒ– â†’ è§¦å‘å™¨æ‰§è¡Œ â†’ å†™å…¥å˜æ›´è¡¨ â†’ åŒæ­¥ç¨‹åºè¯»å–
```

### 4.2 è§¦å‘å™¨å®ç°ç¤ºä¾‹


**ğŸ› ï¸ åˆ›å»ºå˜æ›´è®°å½•è¡¨**
```sql
-- åˆ›å»ºç”¨æˆ·å˜æ›´è®°å½•è¡¨
CREATE TABLE user_changes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,           -- è¡¨å
    operation_type ENUM('INSERT','UPDATE','DELETE'), -- æ“ä½œç±»å‹
    primary_key_value VARCHAR(100),            -- ä¸»é”®å€¼
    changed_data JSON,                         -- å˜æ›´æ•°æ®
    change_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- å˜æ›´æ—¶é—´
    sync_status ENUM('PENDING','SYNCED') DEFAULT 'PENDING', -- åŒæ­¥çŠ¶æ€
    
    INDEX idx_sync_status (sync_status),
    INDEX idx_change_time (change_time)
);
```

**ğŸ”§ åˆ›å»ºè§¦å‘å™¨**
```sql
-- ç”¨æˆ·è¡¨INSERTè§¦å‘å™¨
DELIMITER $$
CREATE TRIGGER user_insert_trigger
    AFTER INSERT ON users
    FOR EACH ROW
BEGIN
    INSERT INTO user_changes (
        table_name, 
        operation_type, 
        primary_key_value, 
        changed_data
    ) VALUES (
        'users',
        'INSERT',
        NEW.id,
        JSON_OBJECT(
            'id', NEW.id,
            'name', NEW.name,
            'email', NEW.email,
            'created_at', NEW.created_at
        )
    );
END$$

-- ç”¨æˆ·è¡¨UPDATEè§¦å‘å™¨
CREATE TRIGGER user_update_trigger
    AFTER UPDATE ON users
    FOR EACH ROW
BEGIN
    -- åªæœ‰çœŸæ­£å‘ç”Ÿå˜åŒ–æ—¶æ‰è®°å½•
    IF (NEW.name != OLD.name OR NEW.email != OLD.email) THEN
        INSERT INTO user_changes (
            table_name, 
            operation_type, 
            primary_key_value, 
            changed_data
        ) VALUES (
            'users',
            'UPDATE',
            NEW.id,
            JSON_OBJECT(
                'id', NEW.id,
                'before', JSON_OBJECT('name', OLD.name, 'email', OLD.email),
                'after', JSON_OBJECT('name', NEW.name, 'email', NEW.email),
                'updated_at', NEW.updated_at
            )
        );
    END IF;
END$$

-- ç”¨æˆ·è¡¨DELETEè§¦å‘å™¨
CREATE TRIGGER user_delete_trigger
    BEFORE DELETE ON users
    FOR EACH ROW
BEGIN
    INSERT INTO user_changes (
        table_name, 
        operation_type, 
        primary_key_value, 
        changed_data
    ) VALUES (
        'users',
        'DELETE',
        OLD.id,
        JSON_OBJECT(
            'id', OLD.id,
            'name', OLD.name,
            'email', OLD.email,
            'deleted_at', NOW()
        )
    );
END$$
DELIMITER ;
```

### 4.3 è§¦å‘å™¨åŒæ­¥ç¨‹åº


**ğŸ“± JavaåŒæ­¥ç¨‹åºç¤ºä¾‹**
```java
public class TriggerBasedSyncService {
    
    public void syncChanges() {
        // æŸ¥è¯¢å¾…åŒæ­¥çš„å˜æ›´
        String sql = """
            SELECT id, table_name, operation_type, 
                   primary_key_value, changed_data, change_time
            FROM user_changes 
            WHERE sync_status = 'PENDING'
            ORDER BY change_time ASC
            LIMIT 1000
            """;
        
        List<ChangeRecord> changes = jdbcTemplate.query(sql, this::mapChangeRecord);
        
        for (ChangeRecord change : changes) {
            try {
                // æ ¹æ®æ“ä½œç±»å‹å¤„ç†å˜æ›´
                switch (change.getOperationType()) {
                    case "INSERT":
                        handleInsert(change);
                        break;
                    case "UPDATE":
                        handleUpdate(change);
                        break;
                    case "DELETE":
                        handleDelete(change);
                        break;
                }
                
                // æ ‡è®°ä¸ºå·²åŒæ­¥
                markAsSynced(change.getId());
                
            } catch (Exception e) {
                log.error("åŒæ­¥å¤±è´¥: " + change, e);
                // å¯ä»¥å®ç°é‡è¯•æœºåˆ¶
            }
        }
    }
    
    private void handleUpdate(ChangeRecord change) {
        // è§£æJSONæ•°æ®
        JsonNode data = objectMapper.readTree(change.getChangedData());
        JsonNode before = data.get("before");
        JsonNode after = data.get("after");
        
        // å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ
        targetSystemService.updateUser(
            data.get("id").asLong(),
            after.get("name").asText(),
            after.get("email").asText()
        );
    }
}
```

### 4.4 è§¦å‘å™¨æ–¹æ¡ˆä¼˜ç¼ºç‚¹


**âœ… è§¦å‘å™¨æ–¹æ¡ˆä¼˜åŠ¿**
```
å®ç°ç®€å•ï¼šç›´æ¥åœ¨æ•°æ®åº“å±‚é¢å®ç°
æ•°æ®å®Œæ•´ï¼šä¸ä¼šé—æ¼ä»»ä½•å˜æ›´
è‡ªå®šä¹‰å¼ºï¼šå¯ä»¥è®°å½•ç‰¹å®šçš„å˜æ›´ä¿¡æ¯
å…¼å®¹æ€§å¥½ï¼šé€‚ç”¨äºå„ç§æ•°æ®åº“
```

**âŒ è§¦å‘å™¨æ–¹æ¡ˆåŠ£åŠ¿**
```
æ€§èƒ½å½±å“ï¼šæ¯æ¬¡æ•°æ®å˜åŒ–éƒ½è¦æ‰§è¡Œé¢å¤–ä»£ç 
ç»´æŠ¤å¤æ‚ï¼šè§¦å‘å™¨ä»£ç éœ€è¦ä¸è¡¨ç»“æ„åŒæ­¥ç»´æŠ¤
äº‹åŠ¡è€¦åˆï¼šè§¦å‘å™¨å¤±è´¥å¯èƒ½å½±å“ä¸»ä¸šåŠ¡äº‹åŠ¡
è°ƒè¯•å›°éš¾ï¼šè§¦å‘å™¨æ‰§è¡Œè¿‡ç¨‹ä¸æ˜“è°ƒè¯•
```

> **âš ï¸ ä½¿ç”¨å»ºè®®ï¼š** è§¦å‘å™¨æ–¹æ¡ˆé€‚åˆä¸­å°è§„æ¨¡ç³»ç»Ÿï¼Œå¯¹äºé«˜å¹¶å‘ç³»ç»Ÿå»ºè®®ä½¿ç”¨binlogæ–¹æ¡ˆã€‚

---

## 5. ğŸ• æ—¶é—´æˆ³å­—æ®µè®¾è®¡ç­–ç•¥


### 5.1 æ—¶é—´æˆ³åŒæ­¥åŸç†


**ğŸ”¸ æ—¶é—´æˆ³åŒæ­¥æ˜¯ä»€ä¹ˆ**
```
åŸºæœ¬æ€æƒ³ï¼šä¸ºæ¯æ¡æ•°æ®è®°å½•æœ€åä¿®æ”¹æ—¶é—´
åŒæ­¥é€»è¾‘ï¼šåªåŒæ­¥æ—¶é—´æˆ³å¤§äºä¸Šæ¬¡åŒæ­¥æ—¶é—´çš„æ•°æ®

å°±åƒå¿«é€’è·Ÿè¸ªä¸€æ ·ï¼š
â€¢ æ¯ä¸ªåŒ…è£¹éƒ½æœ‰æ—¶é—´æˆ³ï¼ˆæ•°æ®è®°å½•çš„ä¿®æ”¹æ—¶é—´ï¼‰
â€¢ åªå…³å¿ƒæœ€æ–°çš„çŠ¶æ€æ›´æ–°ï¼ˆå¢é‡æ•°æ®ï¼‰
â€¢ æŒ‰æ—¶é—´é¡ºåºå¤„ç†ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
```

**ğŸ“Š æ—¶é—´æˆ³åŒæ­¥æµç¨‹**
```
æ•°æ®è¡¨è®¾è®¡ â†’ è®°å½•å˜æ›´æ—¶é—´ â†’ å®šæœŸæ‰«æ â†’ åŒæ­¥æ–°æ•°æ® â†’ æ›´æ–°åŒæ­¥ç‚¹
```

### 5.2 æ—¶é—´æˆ³å­—æ®µè®¾è®¡


**ğŸ—“ï¸ æ ‡å‡†æ—¶é—´æˆ³è¡¨è®¾è®¡**
```sql
-- ç”¨æˆ·è¡¨è®¾è®¡ï¼ˆåŒ…å«å®Œæ•´æ—¶é—´æˆ³å­—æ®µï¼‰
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(200) UNIQUE,
    
    -- æ ¸å¿ƒæ—¶é—´æˆ³å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,              -- åˆ›å»ºæ—¶é—´
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
               ON UPDATE CURRENT_TIMESTAMP,                      -- æ›´æ–°æ—¶é—´
    deleted_at TIMESTAMP NULL,                                   -- è½¯åˆ é™¤æ—¶é—´
    
    -- åŒæ­¥è¾…åŠ©å­—æ®µ
    sync_version BIGINT DEFAULT 1,                               -- ç‰ˆæœ¬å·
    last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
                  ON UPDATE CURRENT_TIMESTAMP,                   -- æœ€åä¿®æ”¹æ—¶é—´
    
    -- ç´¢å¼•ä¼˜åŒ–
    INDEX idx_updated_at (updated_at),
    INDEX idx_last_modified (last_modified),
    INDEX idx_sync_version (sync_version)
);
```

**âš™ï¸ è‡ªåŠ¨æ—¶é—´æˆ³æ›´æ–°è§¦å‘å™¨**
```sql
-- ç¡®ä¿åˆ é™¤æ“ä½œä¹Ÿæ›´æ–°æ—¶é—´æˆ³
DELIMITER $$
CREATE TRIGGER users_soft_delete_trigger
    BEFORE UPDATE ON users
    FOR EACH ROW
BEGIN
    -- è½¯åˆ é™¤æ—¶æ›´æ–°deleted_at
    IF NEW.deleted_at IS NOT NULL AND OLD.deleted_at IS NULL THEN
        SET NEW.last_modified = CURRENT_TIMESTAMP;
        SET NEW.sync_version = OLD.sync_version + 1;
    END IF;
    
    -- ä»»ä½•æ›´æ–°éƒ½å¢åŠ ç‰ˆæœ¬å·
    IF NEW.updated_at > OLD.updated_at THEN
        SET NEW.sync_version = OLD.sync_version + 1;
    END IF;
END$$
DELIMITER ;
```

### 5.3 æ—¶é—´æˆ³åŒæ­¥å®ç°


**ğŸ”„ å¢é‡åŒæ­¥æŸ¥è¯¢é€»è¾‘**
```java
public class TimestampBasedSyncService {
    
    // åŒæ­¥çŠ¶æ€è®°å½•è¡¨
    // CREATE TABLE sync_checkpoint (
    //     table_name VARCHAR(50) PRIMARY KEY,
    //     last_sync_time TIMESTAMP,
    //     last_sync_version BIGINT
    // );
    
    public void syncTable(String tableName) {
        // 1. è·å–ä¸Šæ¬¡åŒæ­¥æ—¶é—´ç‚¹
        SyncCheckpoint checkpoint = getSyncCheckpoint(tableName);
        Timestamp lastSyncTime = checkpoint.getLastSyncTime();
        Long lastSyncVersion = checkpoint.getLastSyncVersion();
        
        // 2. æŸ¥è¯¢å¢é‡æ•°æ®
        String sql = """
            SELECT * FROM %s 
            WHERE (updated_at > ? OR sync_version > ?)
              AND deleted_at IS NULL
            ORDER BY updated_at ASC, sync_version ASC
            LIMIT 1000
            """.formatted(tableName);
        
        List<Map<String, Object>> changes = jdbcTemplate.queryForList(
            sql, lastSyncTime, lastSyncVersion
        );
        
        if (!changes.isEmpty()) {
            // 3. æ‰¹é‡å¤„ç†å˜æ›´
            processBatch(tableName, changes);
            
            // 4. æ›´æ–°åŒæ­¥æ£€æŸ¥ç‚¹
            updateSyncCheckpoint(tableName, changes);
        }
    }
    
    private void processBatch(String tableName, List<Map<String, Object>> changes) {
        for (Map<String, Object> row : changes) {
            try {
                // åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯æ›´æ–°
                if (isNewRecord(row)) {
                    targetSystemService.insert(tableName, row);
                } else {
                    targetSystemService.update(tableName, row);
                }
            } catch (Exception e) {
                log.error("å¤„ç†è®°å½•å¤±è´¥: {}", row, e);
                // è®°å½•å¤±è´¥ä¿¡æ¯ï¼Œåç»­é‡è¯•
            }
        }
    }
    
    private void updateSyncCheckpoint(String tableName, List<Map<String, Object>> changes) {
        // ä½¿ç”¨æœ€åä¸€æ¡è®°å½•çš„æ—¶é—´æˆ³ä½œä¸ºæ–°çš„æ£€æŸ¥ç‚¹
        Map<String, Object> lastRecord = changes.get(changes.size() - 1);
        Timestamp newSyncTime = (Timestamp) lastRecord.get("updated_at");
        Long newSyncVersion = (Long) lastRecord.get("sync_version");
        
        jdbcTemplate.update(
            "INSERT INTO sync_checkpoint (table_name, last_sync_time, last_sync_version) " +
            "VALUES (?, ?, ?) ON DUPLICATE KEY UPDATE " +
            "last_sync_time = VALUES(last_sync_time), " +
            "last_sync_version = VALUES(last_sync_version)",
            tableName, newSyncTime, newSyncVersion
        );
    }
}
```

### 5.4 æ—¶é—´æˆ³åŒæ­¥çš„è¾¹ç•Œæƒ…å†µå¤„ç†


**ğŸ•°ï¸ æ—¶é—´æˆ³ç²¾åº¦é—®é¢˜**
```sql
-- é—®é¢˜ï¼šå¤šæ¡è®°å½•å¯èƒ½æœ‰ç›¸åŒçš„æ—¶é—´æˆ³
-- è§£å†³ï¼šç»“åˆç‰ˆæœ¬å·ç¡®ä¿ä¸é—æ¼

-- æŸ¥è¯¢é€»è¾‘ä¼˜åŒ–
SELECT * FROM users 
WHERE (
    updated_at > ? 
    OR (updated_at = ? AND sync_version > ?)
)
ORDER BY updated_at, sync_version
LIMIT 1000;
```

**ğŸ”„ å¹¶å‘æ›´æ–°å¤„ç†**
```java
// å¤„ç†å¹¶å‘æ›´æ–°å¯¼è‡´çš„æ—¶é—´æˆ³ç›¸åŒé—®é¢˜
public class ConcurrentSafeSync {
    
    public void syncWithConcurrentSafety(String tableName) {
        // ä½¿ç”¨æ—¶é—´æˆ³+ç‰ˆæœ¬å·åŒé‡æ£€æŸ¥
        String sql = """
            SELECT *, 
                   ROW_NUMBER() OVER (
                       PARTITION BY id 
                       ORDER BY updated_at DESC, sync_version DESC
                   ) as rn
            FROM %s 
            WHERE updated_at >= ?
            HAVING rn = 1  -- åªå–æ¯ä¸ªIDçš„æœ€æ–°ç‰ˆæœ¬
            ORDER BY updated_at, sync_version
            """.formatted(tableName);
            
        // æ‰§è¡ŒåŒæ­¥é€»è¾‘...
    }
}
```

> **ğŸ’¡ æœ€ä½³å®è·µï¼š** æ—¶é—´æˆ³åŒæ­¥ç®€å•æ˜“æ‡‚ï¼Œä½†è¦æ³¨æ„å¤„ç†æ—¶é—´ç²¾åº¦å’Œå¹¶å‘é—®é¢˜ï¼Œå»ºè®®ç»“åˆç‰ˆæœ¬å·ä½¿ç”¨ã€‚

---

## 6. ğŸ”„ å¢é‡æ•°æ®å»é‡å¤„ç†


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦å»é‡


**ğŸ¤” é‡å¤æ•°æ®äº§ç”Ÿçš„åŸå› **
```
ç½‘ç»œé‡ä¼ ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´æ¶ˆæ¯é‡å¤å‘é€
ç¨‹åºé‡å¯ï¼šåŒæ­¥ç¨‹åºå¼‚å¸¸é‡å¯ï¼Œé‡æ–°å¤„ç†éƒ¨åˆ†æ•°æ®
æ—¶é—´é‡å ï¼šå¤šä¸ªåŒæ­¥ä»»åŠ¡çš„æ—¶é—´çª—å£é‡å 
äººå·¥é‡è·‘ï¼šè¿ç»´äººå‘˜æ‰‹åŠ¨é‡æ–°æ‰§è¡ŒåŒæ­¥ä»»åŠ¡

ç»“æœï¼šç›®æ ‡ç³»ç»Ÿå¯èƒ½æ”¶åˆ°é‡å¤çš„å˜æ›´ä¿¡æ¯
```

**ğŸ“Š é‡å¤æ•°æ®çš„å½±å“**
```
æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼š
â€¢ è®¡æ•°ç±»å­—æ®µè¢«é‡å¤ç´¯åŠ 
â€¢ çŠ¶æ€è¢«é”™è¯¯åœ°å¤šæ¬¡å˜æ›´
â€¢ å…³è”æ•°æ®å‡ºç°ä¸ä¸€è‡´

æ€§èƒ½é—®é¢˜ï¼š
â€¢ æ— æ•ˆçš„é‡å¤å¤„ç†æ¶ˆè€—èµ„æº
â€¢ ç›®æ ‡ç³»ç»Ÿè´Ÿè½½å¢åŠ 
â€¢ å½±å“åŒæ­¥æ•ˆç‡
```

### 6.2 å»é‡ç­–ç•¥è®¾è®¡


**ğŸ”‘ åŸºäºä¸šåŠ¡ä¸»é”®å»é‡**
```java
public class BusinessKeyDeduplication {
    
    // ä½¿ç”¨Redisè®°å½•å·²å¤„ç†çš„ä¸šåŠ¡æ“ä½œ
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean isDuplicate(String tableName, String operation, 
                              String primaryKey, String timestamp) {
        // æ„é€ å»é‡é”®
        String dedupeKey = String.format("sync:%s:%s:%s:%s", 
            tableName, operation, primaryKey, timestamp);
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
        Boolean exists = redisTemplate.hasKey(dedupeKey);
        if (exists) {
            return true;  // é‡å¤æ•°æ®ï¼Œè·³è¿‡å¤„ç†
        }
        
        // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´é¿å…å†…å­˜æ³„æ¼ï¼‰
        redisTemplate.opsForValue().set(dedupeKey, "processed", Duration.ofHours(24));
        return false;
    }
}
```

**ğŸ“Š åŸºäºæ•°æ®æŒ‡çº¹å»é‡**
```java
public class DataFingerprintDeduplication {
    
    public String calculateDataFingerprint(Map<String, Object> data) {
        // è®¡ç®—æ•°æ®å†…å®¹çš„å“ˆå¸Œå€¼
        String dataString = data.entrySet().stream()
            .sorted(Map.Entry.comparingByKey())  // ç¡®ä¿é¡ºåºä¸€è‡´
            .map(entry -> entry.getKey() + "=" + entry.getValue())
            .collect(Collectors.joining(","));
        
        return DigestUtils.md5Hex(dataString);
    }
    
    public boolean processWithDeduplication(ChangeRecord record) {
        String fingerprint = calculateDataFingerprint(record.getData());
        String dedupeKey = "fingerprint:" + fingerprint;
        
        // æ£€æŸ¥æ•°æ®æŒ‡çº¹æ˜¯å¦å·²å­˜åœ¨
        if (redisTemplate.hasKey(dedupeKey)) {
            log.info("è·³è¿‡é‡å¤æ•°æ®: {}", record);
            return false;
        }
        
        // å¤„ç†æ•°æ®
        processChange(record);
        
        // è®°å½•æ•°æ®æŒ‡çº¹
        redisTemplate.opsForValue().set(dedupeKey, "processed", Duration.ofMinutes(30));
        return true;
    }
}
```

### 6.3 å¹‚ç­‰æ€§è®¾è®¡


**ğŸ” ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**
```
å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œçš„ç»“æœä¸æ‰§è¡Œä¸€æ¬¡çš„ç»“æœç›¸åŒ

æ•°å­¦ä¾‹å­ï¼š
éå¹‚ç­‰ï¼šx = x + 1  (æ‰§è¡Œå¤šæ¬¡ç»“æœä¸åŒ)
å¹‚ç­‰æ€§ï¼šx = 5      (æ‰§è¡Œå¤šæ¬¡ç»“æœç›¸åŒ)

æ•°æ®åº“ä¾‹å­ï¼š
éå¹‚ç­‰ï¼šUPDATE users SET score = score + 10 WHERE id = 1
å¹‚ç­‰æ€§ï¼šUPDATE users SET score = 100 WHERE id = 1
```

**ğŸ› ï¸ å¹‚ç­‰æ€§åŒæ­¥è®¾è®¡**
```java
public class IdempotentSyncProcessor {
    
    public void processChange(ChangeRecord record) {
        String tableName = record.getTableName();
        String primaryKey = record.getPrimaryKey();
        
        switch (record.getOperationType()) {
            case "INSERT":
                // ä½¿ç”¨UPSERTç¡®ä¿å¹‚ç­‰æ€§
                upsertRecord(tableName, record.getData());
                break;
                
            case "UPDATE":
                // åŸºäºç‰ˆæœ¬å·çš„æ¡ä»¶æ›´æ–°
                updateWithVersion(tableName, primaryKey, record.getData());
                break;
                
            case "DELETE":
                // è½¯åˆ é™¤ï¼Œå¯é‡å¤æ‰§è¡Œ
                softDelete(tableName, primaryKey);
                break;
        }
    }
    
    private void updateWithVersion(String tableName, String primaryKey, Map<String, Object> data) {
        // åªæœ‰å½“ç›®æ ‡ç‰ˆæœ¬è¾ƒæ–°æ—¶æ‰æ›´æ–°
        String sql = """
            UPDATE %s SET 
                name = ?, email = ?, updated_at = ?
            WHERE id = ? AND (
                updated_at < ? OR 
                sync_version < ?
            )
            """.formatted(tableName);
            
        int affected = jdbcTemplate.update(sql,
            data.get("name"), data.get("email"), data.get("updated_at"),
            primaryKey, data.get("updated_at"), data.get("sync_version")
        );
        
        if (affected == 0) {
            log.info("æ•°æ®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡æ›´æ–°: {}", primaryKey);
        }
    }
}
```

### 6.4 å»é‡æ€§èƒ½ä¼˜åŒ–


**âš¡ å»é‡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

| ç­–ç•¥ | **å®ç°æ–¹å¼** | **å†…å­˜å ç”¨** | **æŸ¥è¯¢æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** |
|------|-------------|-------------|-------------|-------------|
| **å†…å­˜å»é‡** | `HashMapç¼“å­˜` | ğŸ”´ é«˜ | â­â­â­â­â­ | å°æ•°æ®é‡ |
| **Rediså»é‡** | `åˆ†å¸ƒå¼ç¼“å­˜` | ğŸŸ¡ ä¸­ç­‰ | â­â­â­â­ | ä¸­ç­‰æ•°æ®é‡ |
| **æ•°æ®åº“å»é‡** | `å”¯ä¸€çº¦æŸ` | ğŸŸ¢ ä½ | â­â­â­ | å¤§æ•°æ®é‡ |
| **å¸ƒéš†è¿‡æ»¤å™¨** | `æ¦‚ç‡åˆ¤æ–­` | ğŸŸ¢ æä½ | â­â­â­â­â­ | è¶…å¤§æ•°æ®é‡ |

**ğŸ”§ å¸ƒéš†è¿‡æ»¤å™¨å»é‡å®ç°**
```java
public class BloomFilterDeduplication {
    
    private BloomFilter<String> processedRecords;
    
    public BloomFilterDeduplication(int expectedRecords) {
        // åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¯¯åˆ¤ç‡1%
        this.processedRecords = BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            expectedRecords,
            0.01
        );
    }
    
    public boolean shouldProcess(ChangeRecord record) {
        String recordKey = buildRecordKey(record);
        
        if (processedRecords.mightContain(recordKey)) {
            // å¯èƒ½é‡å¤ï¼Œéœ€è¦ç²¾ç¡®æ£€æŸ¥
            return !isPreciseDuplicate(record);
        }
        
        // è‚¯å®šä¸é‡å¤ï¼Œå¯ä»¥å¤„ç†
        processedRecords.put(recordKey);
        return true;
    }
    
    private String buildRecordKey(ChangeRecord record) {
        return String.format("%s:%s:%s:%s",
            record.getTableName(),
            record.getPrimaryKey(),
            record.getOperationType(),
            record.getDataFingerprint()
        );
    }
}
```

> **ğŸ’¡ é€‰æ‹©å»ºè®®ï¼š** å°è§„æ¨¡ç”¨å†…å­˜å»é‡ï¼Œä¸­ç­‰è§„æ¨¡ç”¨Redisï¼Œå¤§è§„æ¨¡ç”¨å¸ƒéš†è¿‡æ»¤å™¨+ç²¾ç¡®æ£€æŸ¥ã€‚

---

## 7. ğŸ¤ åŒæ­¥å†²çªå¤„ç†æœºåˆ¶


### 7.1 ä»€ä¹ˆæ˜¯åŒæ­¥å†²çª


**ğŸ”¸ å†²çªäº§ç”Ÿçš„åœºæ™¯**
```
åœºæ™¯1ï¼šå¤šæºå†™å…¥å†²çª
æ—¶é—´çº¿ï¼š
10:00 - ç³»ç»ŸAä¿®æ”¹ç”¨æˆ·é‚®ç®±ä¸º user@a.com
10:01 - ç³»ç»ŸBä¿®æ”¹ç”¨æˆ·é‚®ç®±ä¸º user@b.com
10:02 - ä¸¤ä¸ªå˜æ›´éƒ½è¦åŒæ­¥åˆ°ç›®æ ‡ç³»ç»Ÿ

é—®é¢˜ï¼šæœ€ç»ˆåº”è¯¥ä¿ç•™å“ªä¸ªé‚®ç®±ï¼Ÿ

åœºæ™¯2ï¼šæ—¶åºé”™ä¹±å†²çª
æ—¶é—´çº¿ï¼š
10:00 - åˆ›å»ºè®¢å•ï¼ˆçŠ¶æ€ï¼šå¾…æ”¯ä»˜ï¼‰
10:01 - æ”¯ä»˜å®Œæˆï¼ˆçŠ¶æ€ï¼šå·²æ”¯ä»˜ï¼‰
10:02 - ç½‘ç»œå»¶è¿Ÿï¼Œ"åˆ›å»ºè®¢å•"æ¶ˆæ¯ååˆ°è¾¾

é—®é¢˜ï¼šå¯èƒ½å¯¼è‡´å·²æ”¯ä»˜çš„è®¢å•è¢«å›æ»šåˆ°å¾…æ”¯ä»˜çŠ¶æ€
```

### 7.2 å†²çªæ£€æµ‹æœºåˆ¶


**ğŸ” åŸºäºæ—¶é—´æˆ³çš„å†²çªæ£€æµ‹**
```java
public class ConflictDetector {
    
    public enum ConflictType {
        NO_CONFLICT,           // æ— å†²çª
        TIMESTAMP_CONFLICT,    // æ—¶é—´æˆ³å†²çª
        VERSION_CONFLICT,      // ç‰ˆæœ¬å·å†²çª
        BUSINESS_CONFLICT      // ä¸šåŠ¡é€»è¾‘å†²çª
    }
    
    public ConflictType detectConflict(ChangeRecord incoming, ExistingRecord existing) {
        // 1. æ£€æŸ¥æ—¶é—´æˆ³å†²çª
        if (incoming.getTimestamp().before(existing.getLastModified())) {
            return ConflictType.TIMESTAMP_CONFLICT;
        }
        
        // 2. æ£€æŸ¥ç‰ˆæœ¬å·å†²çª
        if (incoming.getVersion() <= existing.getVersion()) {
            return ConflictType.VERSION_CONFLICT;
        }
        
        // 3. æ£€æŸ¥ä¸šåŠ¡é€»è¾‘å†²çª
        if (hasBusinessConflict(incoming, existing)) {
            return ConflictType.BUSINESS_CONFLICT;
        }
        
        return ConflictType.NO_CONFLICT;
    }
    
    private boolean hasBusinessConflict(ChangeRecord incoming, ExistingRecord existing) {
        // ä¸šåŠ¡è§„åˆ™ï¼šè®¢å•çŠ¶æ€åªèƒ½å‘å‰æµè½¬
        if ("orders".equals(incoming.getTableName())) {
            String currentStatus = existing.getStatus();
            String newStatus = incoming.getData().get("status").toString();
            
            return !isValidStatusTransition(currentStatus, newStatus);
        }
        
        return false;
    }
}
```

### 7.3 å†²çªè§£å†³ç­–ç•¥


**ğŸ“‹ å¸¸è§å†²çªè§£å†³ç­–ç•¥**

| ç­–ç•¥ç±»å‹ | **å¤„ç†æ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|----------|-------------|-------------|-----------|
| **æœ€åå†™å…¥è·èƒœ** | `æ—¶é—´æˆ³æœ€æ–°çš„è¦†ç›–æ—§æ•°æ®` | å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯ | ç®€å•ï¼Œä½†å¯èƒ½ä¸¢å¤±æ•°æ® |
| **ç‰ˆæœ¬å·æ§åˆ¶** | `ç‰ˆæœ¬å·å¤§çš„è¦†ç›–å°çš„` | éœ€è¦ä¸¥æ ¼ç‰ˆæœ¬æ§åˆ¶ | å‡†ç¡®ï¼Œä½†éœ€è¦ç‰ˆæœ¬è®¾è®¡ |
| **ä¸šåŠ¡è§„åˆ™ä¼˜å…ˆ** | `æŒ‰ä¸šåŠ¡é€»è¾‘åˆ¤æ–­` | å¤æ‚ä¸šåŠ¡åœºæ™¯ | æœ€å‡†ç¡®ï¼Œä½†å®ç°å¤æ‚ |
| **åˆå¹¶ç­–ç•¥** | `æ™ºèƒ½åˆå¹¶ä¸å†²çªå­—æ®µ` | å­—æ®µçº§åˆ«å†²çª | ç²¾ç»†åŒ–ï¼Œä½†é€»è¾‘å¤æ‚ |
| **äººå·¥ä»‹å…¥** | `æ ‡è®°å†²çªç­‰å¾…å¤„ç†` | å…³é”®ä¸šåŠ¡æ•°æ® | æœ€å®‰å…¨ï¼Œä½†æ•ˆç‡ä½ |

**ğŸ› ï¸ å†²çªè§£å†³å®ç°**
```java
public class ConflictResolver {
    
    public void resolveConflict(ChangeRecord incoming, ExistingRecord existing, 
                               ConflictType conflictType) {
        switch (conflictType) {
            case TIMESTAMP_CONFLICT:
                resolveTimestampConflict(incoming, existing);
                break;
            case VERSION_CONFLICT:
                resolveVersionConflict(incoming, existing);
                break;
            case BUSINESS_CONFLICT:
                resolveBusinessConflict(incoming, existing);
                break;
        }
    }
    
    private void resolveTimestampConflict(ChangeRecord incoming, ExistingRecord existing) {
        // æœ€åå†™å…¥è·èƒœç­–ç•¥
        if (incoming.getTimestamp().after(existing.getLastModified())) {
            applyChange(incoming);
            log.info("åº”ç”¨è¾ƒæ–°çš„å˜æ›´: {}", incoming);
        } else {
            log.info("å¿½ç•¥è¾ƒæ—§çš„å˜æ›´: {}", incoming);
        }
    }
    
    private void resolveBusinessConflict(ChangeRecord incoming, ExistingRecord existing) {
        // æ ¹æ®ä¸šåŠ¡è§„åˆ™å¤„ç†
        if ("orders".equals(incoming.getTableName())) {
            String currentStatus = existing.getStatus();
            String newStatus = incoming.getData().get("status").toString();
            
            // è®¢å•çŠ¶æ€æµè½¬è§„åˆ™
            if (isValidStatusTransition(currentStatus, newStatus)) {
                applyChange(incoming);
            } else {
                // è®°å½•å†²çªï¼Œç­‰å¾…äººå·¥å¤„ç†
                recordConflictForManualReview(incoming, existing);
            }
        }
    }
    
    private boolean isValidStatusTransition(String currentStatus, String newStatus) {
        // å®šä¹‰åˆæ³•çš„çŠ¶æ€è½¬æ¢
        Map<String, Set<String>> validTransitions = Map.of(
            "PENDING", Set.of("PAID", "CANCELLED"),
            "PAID", Set.of("SHIPPED", "REFUNDED"),
            "SHIPPED", Set.of("COMPLETED"),
            "CANCELLED", Set.of(),  // å–æ¶ˆçŠ¶æ€ä¸èƒ½è½¬æ¢
            "COMPLETED", Set.of()   // å®ŒæˆçŠ¶æ€ä¸èƒ½è½¬æ¢
        );
        
        return validTransitions.get(currentStatus).contains(newStatus);
    }
}
```

### 7.4 å†²çªè§£å†³çš„é«˜çº§ç­–ç•¥


**ğŸ§  æ™ºèƒ½å­—æ®µåˆå¹¶**
```java
public class FieldLevelMergeStrategy {
    
    public Map<String, Object> mergeFields(ChangeRecord incoming, ExistingRecord existing) {
        Map<String, Object> merged = new HashMap<>(existing.getData());
        Map<String, Object> incomingData = incoming.getData();
        
        for (Map.Entry<String, Object> entry : incomingData.entrySet()) {
            String field = entry.getKey();
            Object newValue = entry.getValue();
            Object existingValue = merged.get(field);
            
            // å­—æ®µçº§åˆ«çš„å†²çªè§£å†³
            Object resolvedValue = resolveFieldConflict(field, existingValue, newValue, 
                                                       incoming.getTimestamp());
            merged.put(field, resolvedValue);
        }
        
        return merged;
    }
    
    private Object resolveFieldConflict(String field, Object existing, Object incoming, 
                                       Timestamp incomingTime) {
        // æ ¹æ®å­—æ®µç±»å‹å†³å®šåˆå¹¶ç­–ç•¥
        switch (field) {
            case "email":
            case "phone":
                // è”ç³»æ–¹å¼ï¼šè¾ƒæ–°çš„è·èƒœ
                return incoming;
                
            case "balance":
                // ä½™é¢ï¼šéœ€è¦ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
                return resolveBalanceConflict(existing, incoming);
                
            case "tags":
                // æ ‡ç­¾ï¼šåˆå¹¶ä¸é‡å¤çš„æ ‡ç­¾
                return mergeTags((String) existing, (String) incoming);
                
            default:
                // é»˜è®¤ï¼šè¾ƒæ–°çš„è·èƒœ
                return incoming;
        }
    }
}
```

---

## 8. âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


### 8.1 ä¸€è‡´æ€§æ£€æŸ¥çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ä¸€è‡´æ€§æ£€æŸ¥**
```
å¢é‡åŒæ­¥çš„é£é™©ï¼š
â€¢ ç½‘ç»œå¼‚å¸¸å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±
â€¢ ç¨‹åºé”™è¯¯å¯èƒ½å¯¼è‡´æ•°æ®é”™ä¹±
â€¢ ç³»ç»Ÿæ•…éšœå¯èƒ½å¯¼è‡´æ•°æ®ä¸åŒæ­¥

ä¸€è‡´æ€§æ£€æŸ¥çš„ä½œç”¨ï¼š
â€¢ éªŒè¯åŒæ­¥æ˜¯å¦æ­£ç¡®å®Œæˆ
â€¢ åŠæ—¶å‘ç°æ•°æ®ä¸ä¸€è‡´é—®é¢˜
â€¢ ä¸ºæ•°æ®ä¿®å¤æä¾›ä¾æ®
```

### 8.2 ä¸€è‡´æ€§æ£€æŸ¥ç­–ç•¥


**ğŸ“Š æ£€æŸ¥ç»´åº¦å¯¹æ¯”**

| æ£€æŸ¥ç»´åº¦ | **æ£€æŸ¥å†…å®¹** | **æ£€æŸ¥é¢‘ç‡** | **æ€§èƒ½å½±å“** | **å‡†ç¡®æ€§** |
|----------|-------------|-------------|-------------|-----------|
| **æ•°é‡æ£€æŸ¥** | `è®°å½•æ€»æ•°å¯¹æ¯”` | æ¯å°æ—¶ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ç­‰ |
| **æ ¡éªŒå’Œæ£€æŸ¥** | `æ•°æ®å†…å®¹å“ˆå¸Œå¯¹æ¯”` | æ¯å¤© | ğŸŸ¡ ä¸­ç­‰ | â­â­â­â­ |
| **æŠ½æ ·æ£€æŸ¥** | `éšæœºæŠ½å–è¯¦ç»†å¯¹æ¯”` | æ¯å°æ—¶ | ğŸŸ¢ ä½ | â­â­â­ |
| **å…¨é‡å¯¹æ¯”** | `é€æ¡è®°å½•å¯¹æ¯”` | æ¯å‘¨ | ğŸ”´ é«˜ | â­â­â­â­â­ |

**ğŸ”§ æ•°é‡ä¸€è‡´æ€§æ£€æŸ¥**
```java
public class DataConsistencyChecker {
    
    public void checkRecordCount(String tableName) {
        // æŸ¥è¯¢æºè¡¨è®°å½•æ•°
        String sourceCountSql = "SELECT COUNT(*) FROM " + tableName + " WHERE deleted_at IS NULL";
        long sourceCount = sourceJdbcTemplate.queryForObject(sourceCountSql, Long.class);
        
        // æŸ¥è¯¢ç›®æ ‡è¡¨è®°å½•æ•°
        String targetCountSql = "SELECT COUNT(*) FROM " + tableName + " WHERE is_deleted = 0";
        long targetCount = targetJdbcTemplate.queryForObject(targetCountSql, Long.class);
        
        // æ¯”è¾ƒå¹¶æŠ¥å‘Šå·®å¼‚
        if (sourceCount != targetCount) {
            long difference = Math.abs(sourceCount - targetCount);
            double differenceRate = (double) difference / sourceCount * 100;
            
            log.warn("è¡¨{}æ•°æ®é‡ä¸ä¸€è‡´: æºè¡¨{}, ç›®æ ‡è¡¨{}, å·®å¼‚{}æ¡({}%)",
                tableName, sourceCount, targetCount, difference, differenceRate);
            
            // å¦‚æœå·®å¼‚è¶…è¿‡é˜ˆå€¼ï¼Œè§¦å‘å‘Šè­¦
            if (differenceRate > 5.0) {  // 5%å·®å¼‚é˜ˆå€¼
                alertService.sendAlert("æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸", 
                    String.format("è¡¨%sæ•°æ®å·®å¼‚è¶…è¿‡5%%", tableName));
            }
        }
    }
}
```

**ğŸ” æ•°æ®æ ¡éªŒå’Œæ£€æŸ¥**
```java
public class DataChecksumValidator {
    
    public void validateDataIntegrity(String tableName, String primaryKey) {
        // æŸ¥è¯¢æºæ•°æ®
        String sourceSql = "SELECT * FROM " + tableName + " WHERE id = ?";
        Map<String, Object> sourceData = sourceJdbcTemplate.queryForMap(sourceSql, primaryKey);
        
        // æŸ¥è¯¢ç›®æ ‡æ•°æ®
        String targetSql = "SELECT * FROM " + tableName + " WHERE id = ?";
        Map<String, Object> targetData = targetJdbcTemplate.queryForMap(targetSql, primaryKey);
        
        // è®¡ç®—æ•°æ®æ ¡éªŒå’Œ
        String sourceChecksum = calculateChecksum(sourceData);
        String targetChecksum = calculateChecksum(targetData);
        
        if (!sourceChecksum.equals(targetChecksum)) {
            log.error("æ•°æ®æ ¡éªŒå¤±è´¥: è¡¨={}, ä¸»é”®={}", tableName, primaryKey);
            recordInconsistency(tableName, primaryKey, sourceData, targetData);
        }
    }
    
    private String calculateChecksum(Map<String, Object> data) {
        // æ’åºåè®¡ç®—MD5ï¼Œç¡®ä¿ä¸€è‡´æ€§
        String dataString = data.entrySet().stream()
            .filter(entry -> !isMetadataField(entry.getKey()))  // æ’é™¤å…ƒæ•°æ®å­—æ®µ
            .sorted(Map.Entry.comparingByKey())
            .map(entry -> entry.getKey() + "=" + entry.getValue())
            .collect(Collectors.joining(","));
        
        return DigestUtils.md5Hex(dataString);
    }
}
```

### 8.3 ä¸ä¸€è‡´æ•°æ®ä¿®å¤


**ğŸ”§ è‡ªåŠ¨ä¿®å¤æœºåˆ¶**
```java
public class DataRepairService {
    
    public void repairInconsistentData(String tableName, String primaryKey) {
        try {
            // 1. è·å–æºæ•°æ®ä½œä¸ºæƒå¨æ•°æ®
            Map<String, Object> authorizedData = getSourceData(tableName, primaryKey);
            
            if (authorizedData == null) {
                // æºæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ é™¤ç›®æ ‡æ•°æ®
                deleteTargetData(tableName, primaryKey);
                log.info("ä¿®å¤å®Œæˆï¼šåˆ é™¤ç›®æ ‡ç³»ç»Ÿä¸­çš„å¤šä½™æ•°æ® {}:{}", tableName, primaryKey);
                return;
            }
            
            // 2. è·å–ç›®æ ‡æ•°æ®
            Map<String, Object> targetData = getTargetData(tableName, primaryKey);
            
            if (targetData == null) {
                // ç›®æ ‡æ•°æ®ä¸å­˜åœ¨ï¼Œæ’å…¥æ•°æ®
                insertTargetData(tableName, authorizedData);
                log.info("ä¿®å¤å®Œæˆï¼šæ’å…¥ç¼ºå¤±æ•°æ® {}:{}", tableName, primaryKey);
            } else {
                // 3. æ•°æ®å­˜åœ¨ä½†ä¸ä¸€è‡´ï¼Œæ›´æ–°ä¸ºæºæ•°æ®
                updateTargetData(tableName, primaryKey, authorizedData);
                log.info("ä¿®å¤å®Œæˆï¼šæ›´æ–°ä¸ä¸€è‡´æ•°æ® {}:{}", tableName, primaryKey);
            }
            
        } catch (Exception e) {
            log.error("æ•°æ®ä¿®å¤å¤±è´¥ {}:{}", tableName, primaryKey, e);
            // äººå·¥ä»‹å…¥å¤„ç†
            createManualRepairTask(tableName, primaryKey, e.getMessage());
        }
    }
}
```

**ğŸ“Š ä¿®å¤ç­–ç•¥å†³ç­–æ ‘**
```
å‘ç°æ•°æ®ä¸ä¸€è‡´
        â†“
   æºæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Ÿ
    â†™        â†˜
   æ˜¯          å¦
   â†“          â†“
ç›®æ ‡æ•°æ®å­˜åœ¨ï¼Ÿ   åˆ é™¤ç›®æ ‡æ•°æ®
â†™        â†˜      â†“
æ˜¯         å¦     ä¿®å¤å®Œæˆ
â†“         â†“
æ›´æ–°ç›®æ ‡   æ’å…¥ç›®æ ‡
â†“         â†“
ä¿®å¤å®Œæˆ   ä¿®å¤å®Œæˆ
```

---

## 9. âš¡ åŒæ­¥æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 9.1 æ‰¹é‡å¤„ç†ä¼˜åŒ–


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦æ‰¹é‡å¤„ç†**
```
å•æ¡å¤„ç†çš„é—®é¢˜ï¼š
â€¢ æ¯æ¡è®°å½•éƒ½è¦å»ºç«‹æ•°æ®åº“è¿æ¥
â€¢ ç½‘ç»œå¾€è¿”æ¬¡æ•°å¤šï¼Œå»¶è¿Ÿç´¯ç§¯å¤§
â€¢ äº‹åŠ¡å¼€é”€å¤§ï¼Œæ— æ³•åˆ©ç”¨æ‰¹é‡ä¼˜åŒ–

æ‰¹é‡å¤„ç†çš„ä¼˜åŠ¿ï¼š
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
â€¢ åˆ©ç”¨æ•°æ®åº“æ‰¹é‡æ“ä½œä¼˜åŒ–
â€¢ æé«˜äº‹åŠ¡å¤„ç†æ•ˆç‡
```

**ğŸ”§ æ‰¹é‡å¤„ç†å®ç°**
```java
public class BatchSyncProcessor {
    
    private static final int BATCH_SIZE = 1000;
    
    public void processBatch(List<ChangeRecord> changes) {
        // æŒ‰æ“ä½œç±»å‹åˆ†ç»„
        Map<String, List<ChangeRecord>> groupedChanges = changes.stream()
            .collect(Collectors.groupingBy(ChangeRecord::getOperationType));
        
        // æ‰¹é‡å¤„ç†INSERT
        if (groupedChanges.containsKey("INSERT")) {
            batchInsert(groupedChanges.get("INSERT"));
        }
        
        // æ‰¹é‡å¤„ç†UPDATE
        if (groupedChanges.containsKey("UPDATE")) {
            batchUpdate(groupedChanges.get("UPDATE"));
        }
        
        // æ‰¹é‡å¤„ç†DELETE
        if (groupedChanges.containsKey("DELETE")) {
            batchDelete(groupedChanges.get("DELETE"));
        }
    }
    
    private void batchInsert(List<ChangeRecord> insertRecords) {
        String sql = "INSERT INTO users (id, name, email, created_at) VALUES (?, ?, ?, ?)";
        
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                ChangeRecord record = insertRecords.get(i);
                Map<String, Object> data = record.getData();
                
                ps.setLong(1, (Long) data.get("id"));
                ps.setString(2, (String) data.get("name"));
                ps.setString(3, (String) data.get("email"));
                ps.setTimestamp(4, (Timestamp) data.get("created_at"));
            }
            
            @Override
            public int getBatchSize() {
                return insertRecords.size();
            }
        });
        
        log.info("æ‰¹é‡æ’å…¥å®Œæˆ: {} æ¡è®°å½•", insertRecords.size());
    }
}
```

### 9.2 å¹¶è¡Œå¤„ç†ä¼˜åŒ–


**ğŸš€ å¤šçº¿ç¨‹å¹¶è¡ŒåŒæ­¥**
```java
public class ParallelSyncProcessor {
    
    private final ExecutorService executorService = 
        Executors.newFixedThreadPool(8);  // 8ä¸ªå·¥ä½œçº¿ç¨‹
    
    public void processInParallel(List<ChangeRecord> changes) {
        // æŒ‰è¡¨ååˆ†ç»„ï¼Œä¿è¯å•è¡¨å†…æ•°æ®é¡ºåº
        Map<String, List<ChangeRecord>> tableGroups = changes.stream()
            .collect(Collectors.groupingBy(ChangeRecord::getTableName));
        
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        for (Map.Entry<String, List<ChangeRecord>> entry : tableGroups.entrySet()) {
            String tableName = entry.getKey();
            List<ChangeRecord> tableChanges = entry.getValue();
            
            // ä¸ºæ¯ä¸ªè¡¨åˆ›å»ºä¸€ä¸ªå¤„ç†ä»»åŠ¡
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                processTableChanges(tableName, tableChanges);
            }, executorService);
            
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
    }
    
    private void processTableChanges(String tableName, List<ChangeRecord> changes) {
        log.info("å¼€å§‹å¤„ç†è¡¨ {} çš„ {} æ¡å˜æ›´", tableName, changes.size());
        
        // æŒ‰ä¸»é”®åˆ†ç»„ï¼Œä¿è¯å•æ¡è®°å½•çš„æ“ä½œé¡ºåº
        Map<String, List<ChangeRecord>> recordGroups = changes.stream()
            .collect(Collectors.groupingBy(ChangeRecord::getPrimaryKey));
        
        for (List<ChangeRecord> recordChanges : recordGroups.values()) {
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿è¯æ“ä½œé¡ºåº
            recordChanges.sort(Comparator.comparing(ChangeRecord::getTimestamp));
            processRecordChanges(recordChanges);
        }
    }
}
```

### 9.3 å†…å­˜ç®¡ç†ä¼˜åŒ–


**ğŸ’¾ å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥**
```java
public class MemoryOptimizedProcessor {
    
    // ä½¿ç”¨æµå¼å¤„ç†ï¼Œé¿å…åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
    public void streamProcessChanges() {
        String sql = """
            SELECT * FROM user_changes 
            WHERE sync_status = 'PENDING'
            ORDER BY change_time ASC
            """;
        
        // ä½¿ç”¨æµå¼æŸ¥è¯¢ï¼Œé€æ‰¹å¤„ç†
        jdbcTemplate.query(sql, resultSet -> {
            List<ChangeRecord> batch = new ArrayList<>();
            
            while (resultSet.next()) {
                batch.add(mapChangeRecord(resultSet));
                
                // è¾¾åˆ°æ‰¹æ¬¡å¤§å°ï¼Œå¤„ç†ä¸€æ‰¹
                if (batch.size() >= BATCH_SIZE) {
                    processBatch(batch);
                    batch.clear();  // æ¸…ç©ºå†…å­˜
                }
            }
            
            // å¤„ç†æœ€åä¸€æ‰¹
            if (!batch.isEmpty()) {
                processBatch(batch);
            }
        });
    }
    
    // ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GCå‹åŠ›
    private final ObjectPool<ChangeRecord> recordPool = 
        new GenericObjectPool<>(new ChangeRecordFactory());
    
    private ChangeRecord borrowRecord() {
        try {
            return recordPool.borrowObject();
        } catch (Exception e) {
            return new ChangeRecord();  // é™çº§å¤„ç†
        }
    }
    
    private void returnRecord(ChangeRecord record) {
        record.reset();  // é‡ç½®å¯¹è±¡çŠ¶æ€
        try {
            recordPool.returnObject(record);
        } catch (Exception e) {
            // å¿½ç•¥å½’è¿˜å¼‚å¸¸
        }
    }
}
```

### 9.4 ç½‘ç»œä¼ è¾“ä¼˜åŒ–


**ğŸ“¡ æ•°æ®ä¼ è¾“ä¼˜åŒ–**
```java
public class NetworkOptimizedTransmitter {
    
    // æ•°æ®å‹ç¼©ä¼ è¾“
    public void sendCompressedBatch(List<ChangeRecord> batch) {
        try {
            // åºåˆ—åŒ–æ•°æ®
            byte[] data = serializeChanges(batch);
            
            // GZIPå‹ç¼©
            byte[] compressedData = compress(data);
            
            log.info("å‹ç¼©æ•ˆæœ: åŸå§‹{}KB, å‹ç¼©å{}KB, å‹ç¼©æ¯”{}%",
                data.length / 1024,
                compressedData.length / 1024,
                (1.0 - (double) compressedData.length / data.length) * 100
            );
            
            // å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ
            httpClient.post(targetUrl, compressedData);
            
        } catch (Exception e) {
            log.error("ä¼ è¾“å¤±è´¥", e);
        }
    }
    
    private byte[] compress(byte[] data) throws IOException {
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        try (GZIPOutputStream gzos = new GZIPOutputStream(baos)) {
            gzos.write(data);
        }
        return baos.toByteArray();
    }
    
    // è¿æ¥æ± ä¼˜åŒ–
    private final HttpClient httpClient = HttpClient.newBuilder()
        .connectTimeout(Duration.ofSeconds(10))
        .followRedirects(HttpClient.Redirect.NORMAL)
        .build();
}
```

---

## 10. ğŸ“Š åŒæ­¥ç›‘æ§å‘Šè­¦ä½“ç³»


### 10.1 ç›‘æ§æŒ‡æ ‡è®¾è®¡


**ğŸ”¸ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
åŒæ­¥å»¶è¿Ÿï¼ˆSync Lagï¼‰ï¼š
â€¢ å®šä¹‰ï¼šæ•°æ®å˜åŒ–åˆ°åŒæ­¥å®Œæˆçš„æ—¶é—´å·®
â€¢ è®¡ç®—ï¼šå½“å‰æ—¶é—´ - æœ€åä¸€æ¡åŒæ­¥è®°å½•çš„æ—¶é—´æˆ³
â€¢ é˜ˆå€¼ï¼šæ­£å¸¸<1åˆ†é’Ÿï¼Œè­¦å‘Š<5åˆ†é’Ÿï¼Œå‘Šè­¦>5åˆ†é’Ÿ

åŒæ­¥ååé‡ï¼ˆThroughputï¼‰ï¼š
â€¢ å®šä¹‰ï¼šå•ä½æ—¶é—´å†…åŒæ­¥çš„è®°å½•æ•°
â€¢ è®¡ç®—ï¼šåŒæ­¥è®°å½•æ•° / æ—¶é—´çª—å£
â€¢ ç›‘æ§ï¼šå®æ—¶ç›‘æ§ï¼Œå‘ç°æ€§èƒ½ä¸‹é™

é”™è¯¯ç‡ï¼ˆError Rateï¼‰ï¼š
â€¢ å®šä¹‰ï¼šåŒæ­¥å¤±è´¥çš„è®°å½•å æ¯”
â€¢ è®¡ç®—ï¼šå¤±è´¥è®°å½•æ•° / æ€»è®°å½•æ•° Ã— 100%
â€¢ é˜ˆå€¼ï¼šæ­£å¸¸<1%ï¼Œè­¦å‘Š<5%ï¼Œå‘Šè­¦>5%
```

**ğŸ“ˆ ç›‘æ§æ•°æ®è¡¨è®¾è®¡**
```sql
-- åŒæ­¥ç»Ÿè®¡è¡¨
CREATE TABLE sync_metrics (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,
    metric_type ENUM('LAG','THROUGHPUT','ERROR_RATE') NOT NULL,
    metric_value DECIMAL(10,2) NOT NULL,
    measurement_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_table_metric (table_name, metric_type),
    INDEX idx_measurement_time (measurement_time)
);

-- åŒæ­¥é”™è¯¯è®°å½•è¡¨
CREATE TABLE sync_errors (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,
    primary_key_value VARCHAR(100),
    error_type VARCHAR(50),
    error_message TEXT,
    change_data JSON,
    error_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    retry_count INT DEFAULT 0,
    resolved BOOLEAN DEFAULT FALSE,
    
    INDEX idx_table_name (table_name),
    INDEX idx_error_time (error_time),
    INDEX idx_resolved (resolved)
);
```

### 10.2 å®æ—¶ç›‘æ§å®ç°


**ğŸ“Š ç›‘æ§æ•°æ®æ”¶é›†å™¨**
```java
public class SyncMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    public SyncMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordSyncLag(String tableName, long lagMs) {
        // è®°å½•åŒæ­¥å»¶è¿Ÿ
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("sync.lag")
            .tag("table", tableName)
            .register(meterRegistry));
        
        // åŒæ—¶è®°å½•åˆ°æ•°æ®åº“
        recordMetricToDatabase(tableName, "LAG", lagMs / 1000.0);
    }
    
    public void recordSyncThroughput(String tableName, int recordCount, long durationMs) {
        // è®¡ç®—ååé‡ï¼ˆè®°å½•/ç§’ï¼‰
        double throughput = recordCount * 1000.0 / durationMs;
        
        Gauge.builder("sync.throughput")
            .tag("table", tableName)
            .register(meterRegistry, () -> throughput);
        
        recordMetricToDatabase(tableName, "THROUGHPUT", throughput);
    }
    
    public void recordSyncError(String tableName, String primaryKey, 
                               String errorType, String errorMessage, 
                               Map<String, Object> changeData) {
        // é”™è¯¯è®¡æ•°å™¨
        Counter.builder("sync.errors")
            .tag("table", tableName)
            .tag("error_type", errorType)
            .register(meterRegistry)
            .increment();
        
        // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
        jdbcTemplate.update("""
            INSERT INTO sync_errors 
            (table_name, primary_key_value, error_type, error_message, change_data)
            VALUES (?, ?, ?, ?, ?)
            """,
            tableName, primaryKey, errorType, errorMessage, 
            objectMapper.writeValueAsString(changeData)
        );
    }
}
```

### 10.3 å‘Šè­¦è§„åˆ™é…ç½®


**ğŸš¨ å¤šçº§å‘Šè­¦ä½“ç³»**
```java
public class SyncAlertManager {
    
    public enum AlertLevel {
        INFO,     // ä¿¡æ¯çº§åˆ«ï¼šè®°å½•æ—¥å¿—
        WARNING,  // è­¦å‘Šçº§åˆ«ï¼šå‘é€é‚®ä»¶
        ERROR,    // é”™è¯¯çº§åˆ«ï¼šå‘é€çŸ­ä¿¡+é‚®ä»¶
        CRITICAL  // ä¸¥é‡çº§åˆ«ï¼šç”µè¯å‘Šè­¦+é‚®ä»¶+çŸ­ä¿¡
    }
    
    public void checkSyncHealth() {
        for (String tableName : getMonitoredTables()) {
            checkSyncLag(tableName);
            checkErrorRate(tableName);
            checkThroughput(tableName);
        }
    }
    
    private void checkSyncLag(String tableName) {
        long lagMs = calculateSyncLag(tableName);
        
        if (lagMs > 300000) {  // 5åˆ†é’Ÿ
            sendAlert(AlertLevel.CRITICAL, tableName, 
                String.format("åŒæ­¥ä¸¥é‡å»¶è¿Ÿ: %dåˆ†é’Ÿ", lagMs / 60000));
        } else if (lagMs > 60000) {  // 1åˆ†é’Ÿ
            sendAlert(AlertLevel.WARNING, tableName, 
                String.format("åŒæ­¥å»¶è¿Ÿ: %dç§’", lagMs / 1000));
        }
    }
    
    private void checkErrorRate(String tableName) {
        double errorRate = calculateErrorRate(tableName, Duration.ofMinutes(10));
        
        if (errorRate > 10.0) {  // 10%
            sendAlert(AlertLevel.ERROR, tableName, 
                String.format("é”™è¯¯ç‡è¿‡é«˜: %.2f%%", errorRate));
        } else if (errorRate > 5.0) {  // 5%
            sendAlert(AlertLevel.WARNING, tableName, 
                String.format("é”™è¯¯ç‡åé«˜: %.2f%%", errorRate));
        }
    }
    
    private void sendAlert(AlertLevel level, String tableName, String message) {
        AlertMessage alert = AlertMessage.builder()
            .level(level)
            .title("æ•°æ®åŒæ­¥å‘Šè­¦")
            .content(String.format("è¡¨: %s, é—®é¢˜: %s", tableName, message))
            .timestamp(Instant.now())
            .build();
        
        switch (level) {
            case WARNING:
                emailService.sendAlert(alert);
                break;
            case ERROR:
                emailService.sendAlert(alert);
                smsService.sendAlert(alert);
                break;
            case CRITICAL:
                emailService.sendAlert(alert);
                smsService.sendAlert(alert);
                phoneService.callAlert(alert);
                break;
        }
    }
}
```

### 10.4 ç›‘æ§å¤§å±å±•ç¤º


**ğŸ“Š ç›‘æ§æŒ‡æ ‡å¯è§†åŒ–**
```
å®æ—¶ç›‘æ§å¤§å±å¸ƒå±€ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŒæ­¥å»¶è¿Ÿ      â”‚    ååé‡       â”‚    é”™è¯¯ç‡       â”‚
â”‚                 â”‚                 â”‚                 â”‚
â”‚ ç”¨æˆ·è¡¨: 30ç§’    â”‚ ç”¨æˆ·è¡¨: 500/ç§’  â”‚ ç”¨æˆ·è¡¨: 1.2%    â”‚
â”‚ è®¢å•è¡¨: 1åˆ†é’Ÿ   â”‚ è®¢å•è¡¨: 200/ç§’  â”‚ è®¢å•è¡¨: 0.5%    â”‚
â”‚ å•†å“è¡¨: 15ç§’    â”‚ å•†å“è¡¨: 100/ç§’  â”‚ å•†å“è¡¨: 0.1%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åŒæ­¥è¶‹åŠ¿å›¾è¡¨                           â”‚
â”‚                                                     â”‚
â”‚  è®°å½•æ•°                                             â”‚
â”‚    â†‘                                                â”‚
â”‚ 1000â”œâ”€â•­â”€â•®                                          â”‚
â”‚     â”‚  â”‚ â”‚    â•­â”€â•®                                   â”‚
â”‚  500â”œâ”€â”€â•¯ â•°â”€â”€â”€â”€â•¯ â•°â”€â•®                                â”‚
â”‚     â”‚             â•°â”€â•®                              â”‚
â”‚    0â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´                â”‚
â”‚     12:00  13:00  14:00  15:00                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¢é‡åŒæ­¥ï¼šåªä¼ è¾“å˜åŒ–æ•°æ®ï¼Œæé«˜åŒæ­¥æ•ˆç‡
ğŸ”¸ CDCæŠ€æœ¯ï¼šå˜æ›´æ•°æ®æ•è·ï¼Œå®æ—¶ç›‘æ§æ•°æ®å˜åŒ–
ğŸ”¸ binlogåŒæ­¥ï¼šåŸºäºMySQLäº‹åŠ¡æ—¥å¿—çš„å¢é‡åŒæ­¥
ğŸ”¸ è§¦å‘å™¨æ•è·ï¼šé€šè¿‡æ•°æ®åº“è§¦å‘å™¨è®°å½•æ•°æ®å˜åŒ–
ğŸ”¸ æ—¶é—´æˆ³è®¾è®¡ï¼šä½¿ç”¨æ—¶é—´æˆ³å­—æ®µæ ‡è¯†æ•°æ®ä¿®æ”¹æ—¶é—´
ğŸ”¸ æ•°æ®å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†ç›¸åŒçš„å˜æ›´æ•°æ®
ğŸ”¸ å†²çªå¤„ç†ï¼šè§£å†³å¤šæºæ•°æ®åŒæ­¥æ—¶çš„å†²çªé—®é¢˜
ğŸ”¸ ä¸€è‡´æ€§æ£€æŸ¥ï¼šéªŒè¯åŒæ­¥ç»“æœçš„æ­£ç¡®æ€§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæé«˜åŒæ­¥æ•ˆç‡å’Œç³»ç»Ÿæ€§èƒ½
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§åŒæ­¥çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
```

### 11.2 å…³é”®æŠ€æœ¯å¯¹æ¯”


**ğŸ“Š å¢é‡åŒæ­¥æŠ€æœ¯é€‰æ‹©æŒ‡å—**

| åœºæ™¯éœ€æ±‚ | **æ¨èæŠ€æœ¯** | **ç†ç”±** | **æ³¨æ„äº‹é¡¹** |
|----------|-------------|---------|-------------|
| **MySQLä¸»ä»åŒæ­¥** | `binlog + Canal` | æ€§èƒ½æœ€å¥½ï¼Œä¾µå…¥æ€§æœ€å° | éœ€è¦å¼€å¯binlog |
| **è·¨æ•°æ®åº“åŒæ­¥** | `CDC + Debezium` | ç»Ÿä¸€å¹³å°ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ | å­¦ä¹ æˆæœ¬è¾ƒé«˜ |
| **ç®€å•ä¸šåŠ¡åœºæ™¯** | `æ—¶é—´æˆ³ + å®šæ—¶ä»»åŠ¡` | å®ç°ç®€å•ï¼Œæ˜“äºç†è§£ | ç²¾åº¦å—é™äºæ—¶é—´æˆ³ |
| **å°è§„æ¨¡åŒæ­¥** | `è§¦å‘å™¨ + é˜Ÿåˆ—` | å®æ—¶æ€§å¥½ï¼Œé€»è¾‘æ¸…æ™° | æ€§èƒ½æœ‰ä¸€å®šå½±å“ |
| **å¤§æ•°æ®é‡åŒæ­¥** | `åˆ†ç‰‡ + å¹¶è¡Œå¤„ç†` | å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº | å¤æ‚åº¦è¾ƒé«˜ |

### 11.3 æœ€ä½³å®è·µæ€»ç»“


**ğŸ¯ è®¾è®¡åŸåˆ™**
```
1. æœ€å°ä¾µå…¥ï¼šå¯¹æºç³»ç»Ÿçš„å½±å“é™åˆ°æœ€ä½
2. å¯é æ€§ä¼˜å…ˆï¼šç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ã€ä¸å‡ºé”™
3. æ€§èƒ½å¹³è¡¡ï¼šåœ¨å¯é æ€§å’Œæ€§èƒ½é—´æ‰¾åˆ°å¹³è¡¡ç‚¹
4. å¯ç›‘æ§æ€§ï¼šæä¾›å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
5. å¯æ¢å¤æ€§ï¼šæ”¯æŒæ•…éšœæ¢å¤å’Œæ•°æ®ä¿®å¤
```

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
æ‰¹é‡å¤„ç†ï¼š
â€¢ åˆç†è®¾ç½®æ‰¹æ¬¡å¤§å°ï¼ˆé€šå¸¸1000-5000æ¡ï¼‰
â€¢ æŒ‰æ“ä½œç±»å‹åˆ†ç»„å¤„ç†
â€¢ åˆ©ç”¨æ•°æ®åº“æ‰¹é‡API

å¹¶è¡Œä¼˜åŒ–ï¼š
â€¢ æŒ‰è¡¨å¹¶è¡Œï¼Œä¿è¯è¡¨å†…é¡ºåº
â€¢ æŒ‰ä¸»é”®åˆ†ç‰‡ï¼Œé¿å…é”ç«äº‰
â€¢ æ§åˆ¶å¹¶å‘åº¦ï¼Œé¿å…èµ„æºäº‰æŠ¢

å†…å­˜ç®¡ç†ï¼š
â€¢ æµå¼å¤„ç†å¤§æ•°æ®é›†
â€¢ åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„å¯¹è±¡
â€¢ ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GCå‹åŠ›

ç½‘ç»œä¼˜åŒ–ï¼š
â€¢ æ•°æ®å‹ç¼©ä¼ è¾“
â€¢ è¿æ¥æ± å¤ç”¨
â€¢ åˆç†çš„è¶…æ—¶è®¾ç½®
```

**ğŸ”§ è¿ç»´å®è·µ**
```
ç›‘æ§ä½“ç³»ï¼š
â€¢ å…³é”®æŒ‡æ ‡ï¼šå»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡
â€¢ å¤šçº§å‘Šè­¦ï¼šä¿¡æ¯ã€è­¦å‘Šã€é”™è¯¯ã€ä¸¥é‡
â€¢ è‡ªåŠ¨æ¢å¤ï¼šé‡è¯•æœºåˆ¶ã€æ•…éšœè½¬ç§»

æ•…éšœå¤„ç†ï¼š
â€¢ æ•°æ®æ ¡éªŒï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
â€¢ é”™è¯¯è¿½è¸ªï¼šè¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯
â€¢ æ‰‹åŠ¨ä¿®å¤ï¼šæä¾›æ•°æ®ä¿®å¤å·¥å…·

å®¹é‡è§„åˆ’ï¼š
â€¢ è¯„ä¼°æ•°æ®å¢é•¿è¶‹åŠ¿
â€¢ é¢„ç•™è¶³å¤Ÿçš„å¤„ç†èƒ½åŠ›
â€¢ å®šæœŸä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
```

### 11.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é—®é¢˜é€ŸæŸ¥è¡¨**

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** | **é¢„é˜²æªæ–½** |
|----------|-------------|-------------|-------------|
| **åŒæ­¥å»¶è¿Ÿå¤§** | ç½‘ç»œæ…¢ã€å¤„ç†æ…¢ã€æ•°æ®é‡å¤§ | å¢åŠ å¹¶è¡Œåº¦ã€ä¼˜åŒ–æŸ¥è¯¢ã€åˆ†æ‰¹å¤„ç† | ç›‘æ§ç½‘ç»œã€é¢„æµ‹å®¹é‡ |
| **æ•°æ®ä¸ä¸€è‡´** | å†²çªå¤„ç†é”™è¯¯ã€ç½‘ç»œä¸¢åŒ… | æ•°æ®æ ¡éªŒã€é‡æ–°åŒæ­¥ | å®Œå–„å†²çªç­–ç•¥ |
| **å†…å­˜å ç”¨é«˜** | æ‰¹æ¬¡è¿‡å¤§ã€å¯¹è±¡æœªé‡Šæ”¾ | è°ƒæ•´æ‰¹æ¬¡ã€ä¼˜åŒ–ä»£ç  | å†…å­˜ç›‘æ§ã€å‹åŠ›æµ‹è¯• |
| **é”™è¯¯ç‡é«˜** | ç›®æ ‡ç³»ç»Ÿå¼‚å¸¸ã€æ•°æ®æ ¼å¼é”™è¯¯ | é”™è¯¯é‡è¯•ã€æ•°æ®éªŒè¯ | æ ¼å¼æ£€æŸ¥ã€å¼‚å¸¸å¤„ç† |

**ğŸ” è°ƒè¯•æŠ€å·§**
```java
// å¼€å¯è¯¦ç»†æ—¥å¿—
@Component
public class SyncDebugger {
    
    public void debugSyncProcess(ChangeRecord record) {
        log.debug("=== åŒæ­¥è°ƒè¯•ä¿¡æ¯ ===");
        log.debug("è¡¨å: {}", record.getTableName());
        log.debug("ä¸»é”®: {}", record.getPrimaryKey());
        log.debug("æ“ä½œ: {}", record.getOperationType());
        log.debug("æ—¶é—´æˆ³: {}", record.getTimestamp());
        log.debug("æ•°æ®: {}", record.getData());
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        validateDataIntegrity(record);
        
        // æ£€æŸ¥ç›®æ ‡ç³»ç»ŸçŠ¶æ€
        checkTargetSystemHealth();
        
        log.debug("=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===");
    }
    
    private void validateDataIntegrity(ChangeRecord record) {
        Map<String, Object> data = record.getData();
        
        // æ£€æŸ¥å¿…è¦å­—æ®µ
        String[] requiredFields = {"id", "updated_at"};
        for (String field : requiredFields) {
            if (!data.containsKey(field) || data.get(field) == null) {
                log.warn("ç¼ºå°‘å¿…è¦å­—æ®µ: {}", field);
            }
        }
        
        // æ£€æŸ¥æ•°æ®ç±»å‹
        if (data.get("id") instanceof String) {
            try {
                Long.parseLong((String) data.get("id"));
            } catch (NumberFormatException e) {
                log.warn("IDå­—æ®µæ ¼å¼é”™è¯¯: {}", data.get("id"));
            }
        }
    }
}
```

### 11.5 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
```
ç”µå•†ç³»ç»Ÿï¼š
â€¢ å•†å“ä¿¡æ¯å®æ—¶åŒæ­¥åˆ°æœç´¢å¼•æ“
â€¢ è®¢å•çŠ¶æ€åŒæ­¥åˆ°æ•°æ®ä»“åº“
â€¢ ç”¨æˆ·è¡Œä¸ºæ•°æ®åŒæ­¥åˆ°æ¨èç³»ç»Ÿ

é‡‘èç³»ç»Ÿï¼š
â€¢ äº¤æ˜“è®°å½•å®æ—¶åŒæ­¥åˆ°é£æ§ç³»ç»Ÿ
â€¢ è´¦æˆ·å˜åŒ–åŒæ­¥åˆ°æŠ¥è¡¨ç³»ç»Ÿ
â€¢ å®¢æˆ·ä¿¡æ¯åŒæ­¥åˆ°CRMç³»ç»Ÿ

å†…å®¹å¹³å°ï¼š
â€¢ æ–‡ç« å†…å®¹åŒæ­¥åˆ°CDNç¼“å­˜
â€¢ ç”¨æˆ·è¯„è®ºåŒæ­¥åˆ°å®¡æ ¸ç³»ç»Ÿ
â€¢ çƒ­é—¨å†…å®¹åŒæ­¥åˆ°æ¨èå¼•æ“
```

**ğŸ’¼ è¿ç»´ä»·å€¼ä½“ç°**
```
æˆæœ¬èŠ‚çº¦ï¼š
â€¢ å‡å°‘90%ä»¥ä¸Šçš„æ•°æ®ä¼ è¾“é‡
â€¢ é™ä½æœåŠ¡å™¨èµ„æºæ¶ˆè€—
â€¢ å‡å°‘äººå·¥è¿ç»´å·¥ä½œé‡

ä¸šåŠ¡æå‡ï¼š
â€¢ æ•°æ®å»¶è¿Ÿä»å°æ—¶çº§é™åˆ°åˆ†é’Ÿçº§
â€¢ æé«˜æ•°æ®é©±åŠ¨å†³ç­–çš„æ—¶æ•ˆæ€§
â€¢ æ”¹å–„ç”¨æˆ·ä½“éªŒ

é£é™©æ§åˆ¶ï¼š
â€¢ å®Œå–„çš„ç›‘æ§å‘Šè­¦ä½“ç³»
â€¢ è‡ªåŠ¨æ•…éšœæ¢å¤æœºåˆ¶
â€¢ è¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—
```

### 11.6 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š çŸ¥è¯†ä½“ç³»å›¾**
```
åŸºç¡€æ¦‚å¿µ â†’ æŠ€æœ¯åŸç† â†’ å®ç°æ–¹æ¡ˆ â†’ æ€§èƒ½ä¼˜åŒ– â†’ è¿ç»´ç›‘æ§
    â†“         â†“         â†“         â†“         â†“
å¢é‡åŒæ­¥   CDC/binlog  ä»£ç å®ç°   æ‰¹é‡å¹¶è¡Œ   å‘Šè­¦ä½“ç³»
    â†“         â†“         â†“         â†“         â†“
å»é‡å†²çª   è§¦å‘å™¨     ä¸€è‡´æ€§æ£€æŸ¥  å†…å­˜ä¼˜åŒ–   æ•…éšœæ¢å¤
```

**ğŸ“ è¿›é˜¶å­¦ä¹ å»ºè®®**
```
åˆçº§é˜¶æ®µ(1-2å‘¨)ï¼š
â€¢ ç†è§£å¢é‡åŒæ­¥åŸºæœ¬æ¦‚å¿µ
â€¢ æŒæ¡æ—¶é—´æˆ³åŒæ­¥æ–¹æ³•
â€¢ å®ç°ç®€å•çš„åŒæ­¥ç¨‹åº

ä¸­çº§é˜¶æ®µ(2-4å‘¨)ï¼š
â€¢ æŒæ¡CDCå’ŒbinlogæŠ€æœ¯
â€¢ å®ç°å†²çªæ£€æµ‹å’Œå¤„ç†
â€¢ è®¾è®¡ä¸€è‡´æ€§æ£€æŸ¥æœºåˆ¶

é«˜çº§é˜¶æ®µ(1-2æœˆ)ï¼š
â€¢ æ„å»ºå®Œæ•´çš„ç›‘æ§ä½“ç³»
â€¢ ä¼˜åŒ–åŒæ­¥æ€§èƒ½
â€¢ å¤„ç†å¤æ‚çš„ä¸šåŠ¡åœºæ™¯

å®æˆ˜é¡¹ç›®ï¼š
â€¢ æ­å»ºMySQLåˆ°Elasticsearchçš„å®æ—¶åŒæ­¥
â€¢ å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„æ•°æ®åŒæ­¥
â€¢ æ„å»ºæ•°æ®æ¹–çš„å¢é‡ETLæµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ’¡ "å¢é‡åŒæ­¥ä¸ƒå­—è¯€"
å˜åŒ–æ•è·è¦å‡†ç¡®ï¼Œå»é‡å†²çªå·§å¤„ç†
ä¸€è‡´æ£€æŸ¥ä¿è´¨é‡ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸èƒ½å°‘
ç›‘æ§å‘Šè­¦å…¨è¦†ç›–ï¼Œæ•…éšœæ¢å¤è¦è¿…é€Ÿ
```

**ğŸ¯ æ ¸å¿ƒç†è§£**ï¼š
- å¢é‡åŒæ­¥æ˜¯ç°ä»£æ•°æ®æ¶æ„çš„æ ¸å¿ƒæŠ€æœ¯
- é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆæ¯”ç›²ç›®è¿½æ±‚å…ˆè¿›æ›´é‡è¦
- å¯é æ€§å’Œæ€§èƒ½éœ€è¦åœ¨å…·ä½“åœºæ™¯ä¸­å¹³è¡¡
- å®Œå–„çš„ç›‘æ§å‘Šè­¦æ˜¯ç”Ÿäº§ç¯å¢ƒå¿…éœ€å“
- æ•°æ®ä¸€è‡´æ€§æ˜¯åŒæ­¥ç³»ç»Ÿçš„ç”Ÿå‘½çº¿