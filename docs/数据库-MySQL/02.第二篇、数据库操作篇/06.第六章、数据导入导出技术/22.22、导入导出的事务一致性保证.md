---
title: 22ã€å¯¼å…¥å¯¼å‡ºçš„äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ](#1-äº‹åŠ¡ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ)
2. [å¯¼å‡ºæ—¶ä¸€è‡´æ€§å¿«ç…§æœºåˆ¶](#2-å¯¼å‡ºæ—¶ä¸€è‡´æ€§å¿«ç…§æœºåˆ¶)
3. [å¯¼å…¥äº‹åŠ¡è¾¹ç•Œæ§åˆ¶](#3-å¯¼å…¥äº‹åŠ¡è¾¹ç•Œæ§åˆ¶)
4. [å¤§æ‰¹é‡å¯¼å…¥äº‹åŠ¡ç­–ç•¥](#4-å¤§æ‰¹é‡å¯¼å…¥äº‹åŠ¡ç­–ç•¥)
5. [å¯¼å…¥å¤±è´¥å›æ»šæœºåˆ¶](#5-å¯¼å…¥å¤±è´¥å›æ»šæœºåˆ¶)
6. [ä¸€è‡´æ€§æ£€æŸ¥ç‚¹è®¾ç½®](#6-ä¸€è‡´æ€§æ£€æŸ¥ç‚¹è®¾ç½®)
7. [å¯¼å…¥æ•°æ®éªŒè¯æœºåˆ¶](#7-å¯¼å…¥æ•°æ®éªŒè¯æœºåˆ¶)
8. [ä¸€è‡´æ€§æ¢å¤ç­–ç•¥](#8-ä¸€è‡´æ€§æ¢å¤ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ äº‹åŠ¡ä¸€è‡´æ€§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡ä¸€è‡´æ€§


**ğŸ“– é€šä¿—ç†è§£**
```
ç”Ÿæ´»ç±»æ¯”ï¼šé“¶è¡Œè½¬è´¦
å¼ ä¸‰è´¦æˆ· -100å…ƒ  â†’  æå››è´¦æˆ· +100å…ƒ

ä¸€è‡´æ€§è¦æ±‚ï¼š
â€¢ è¦ä¹ˆä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸï¼ˆæ€»é‡‘é¢ä¸å˜ï¼‰
â€¢ è¦ä¹ˆä¸¤ä¸ªæ“ä½œéƒ½å¤±è´¥ï¼ˆæ¢å¤åŸçŠ¶ï¼‰
â€¢ ç»ä¸èƒ½å‡ºç°åªæˆåŠŸä¸€ä¸ªçš„æƒ…å†µ
```

**ğŸ”¸ æ•°æ®åº“äº‹åŠ¡ä¸€è‡´æ€§**
```
å®šä¹‰ï¼šåœ¨æ•°æ®å¯¼å…¥å¯¼å‡ºè¿‡ç¨‹ä¸­ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
ç›®æ ‡ï¼šä¿è¯æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¸¢å¤±ã€ä¸æŸåã€ä¸å‡ºç°ä¸ä¸€è‡´çŠ¶æ€

å››ä¸ªç‰¹æ€§ï¼ˆACIDï¼‰ï¼š
A - åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
C - ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šæ•°æ®å§‹ç»ˆæ»¡è¶³ä¸šåŠ¡è§„åˆ™
I - éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šå¹¶å‘æ“ä½œä¸äº’ç›¸å¹²æ‰°
D - æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šæˆåŠŸçš„æ“ä½œæ°¸ä¹…ä¿å­˜
```

### 1.2 å¯¼å…¥å¯¼å‡ºä¸­çš„ä¸€è‡´æ€§æŒ‘æˆ˜


**âš ï¸ å¸¸è§ä¸€è‡´æ€§é—®é¢˜**
```
å¯¼å‡ºé˜¶æ®µé—®é¢˜ï¼š
ğŸ“Š æ•°æ®å¿«ç…§ä¸ä¸€è‡´
â€¢ å¯¼å‡ºè¿‡ç¨‹ä¸­æ•°æ®è¢«ä¿®æ”¹
â€¢ ä¸åŒè¡¨çš„å¯¼å‡ºæ—¶é—´ç‚¹ä¸åŒ
â€¢ å…³è”æ•°æ®çš„æ—¶é—´å·®å¯¼è‡´é€»è¾‘é”™è¯¯

ğŸ”„ å¹¶å‘è®¿é—®å†²çª
â€¢ å¯¼å‡ºæ—¶å…¶ä»–ç”¨æˆ·ä¿®æ”¹æ•°æ®
â€¢ é•¿æ—¶é—´å¯¼å‡ºé”å®šèµ„æº
â€¢ è¯»å†™å†²çªå½±å“ä¸šåŠ¡è¿è¡Œ

å¯¼å…¥é˜¶æ®µé—®é¢˜ï¼š
ğŸ’¥ éƒ¨åˆ†å¯¼å…¥å¤±è´¥
â€¢ ä¸­é€”å‡ºé”™å¯¼è‡´æ•°æ®ä¸å®Œæ•´
â€¢ å¤–é”®çº¦æŸå†²çª
â€¢ æ•°æ®æ ¼å¼é”™è¯¯

ğŸ”— å…³è”æ•°æ®ä¸ä¸€è‡´
â€¢ ä¸»è¡¨å¯¼å…¥æˆåŠŸï¼Œä»è¡¨å¯¼å…¥å¤±è´¥
â€¢ IDå…³è”å…³ç³»è¢«ç ´å
â€¢ ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§å—æŸ
```

**ğŸ“ˆ å®é™…åœºæ™¯ä¸¾ä¾‹**
```
ç”µå•†ç³»ç»Ÿæ•°æ®è¿ç§»ï¼š

è®¢å•è¡¨ï¼ˆordersï¼‰     â†â†’     è®¢å•é¡¹è¡¨ï¼ˆorder_itemsï¼‰
è®¢å•ID: 1001              è®¢å•ID: 1001, å•†å“A
è®¢å•ID: 1002              è®¢å•ID: 1001, å•†å“B
è®¢å•ID: 1003              è®¢å•ID: 1002, å•†å“C

å¦‚æœè®¢å•è¡¨å¯¼å…¥æˆåŠŸï¼Œè®¢å•é¡¹è¡¨å¯¼å…¥å¤±è´¥ï¼š
ç»“æœï¼šæœ‰è®¢å•è®°å½•ä½†æ²¡æœ‰å…·ä½“å•†å“ä¿¡æ¯
é—®é¢˜ï¼šä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§è¢«ç ´åï¼Œç”¨æˆ·çœ‹åˆ°ç©ºè®¢å•
```

---

## 2. ğŸ“¸ å¯¼å‡ºæ—¶ä¸€è‡´æ€§å¿«ç…§æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å¿«ç…§


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
ä¸€è‡´æ€§å¿«ç…§ï¼šåœ¨æŸä¸ªæ—¶é—´ç‚¹å¯¹æ•´ä¸ªæ•°æ®åº“çš„å®Œæ•´"ç…§ç‰‡"
ç›®æ ‡ï¼šç¡®ä¿å¯¼å‡ºçš„æ•°æ®åæ˜ åŒä¸€æ—¶åˆ»çš„æ•°æ®åº“çŠ¶æ€
åŸç†ï¼šé€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«å’Œé”æœºåˆ¶å®ç°
```

**ğŸ“· å¿«ç…§ç±»æ¯”ç†è§£**
```
æ‹å…¨å®¶ç¦çš„ä¾‹å­ï¼š
âŒ é”™è¯¯æ–¹å¼ï¼šä¸€ä¸ªä¸€ä¸ªæ‹ï¼Œå¼ ä¸‰9ç‚¹æ‹ï¼Œæå››10ç‚¹æ‹
   ç»“æœï¼šæ—¶é—´ä¸åŒæ­¥ï¼Œå¯èƒ½å¼ ä¸‰å·²ç»æ¢è¡£æœäº†

âœ… æ­£ç¡®æ–¹å¼ï¼šå¤§å®¶åŒæ—¶ç«™å¥½ï¼ŒæŒ‰ä¸‹å¿«é—¨çš„ç¬é—´ä¸€èµ·æ‹
   ç»“æœï¼šæ‰€æœ‰äººéƒ½æ˜¯åŒä¸€æ—¶åˆ»çš„çŠ¶æ€

æ•°æ®åº“å¿«ç…§åŒç†ï¼š
âŒ åˆ†åˆ«å¯¼å‡ºï¼šå…ˆå¯¼ordersè¡¨ï¼Œå†å¯¼order_itemsè¡¨
âœ… å¿«ç…§å¯¼å‡ºï¼šåŒä¸€æ—¶åˆ»å¯¼å‡ºæ‰€æœ‰ç›¸å…³è¡¨
```

### 2.2 å¿«ç…§å®ç°æœºåˆ¶


**ğŸ”’ åŸºäºäº‹åŠ¡éš”ç¦»çº§åˆ«**
```sql
-- MySQL å¯é‡å¤è¯»éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;

-- åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¯¼å‡ºæ‰€æœ‰è¡¨
SELECT * FROM orders WHERE create_date >= '2025-01-01';
SELECT * FROM order_items WHERE order_id IN (...);
SELECT * FROM customers WHERE id IN (...);

COMMIT;
```

**ğŸ“Š ä¸åŒæ•°æ®åº“çš„å¿«ç…§æ”¯æŒ**

| æ•°æ®åº“ | **å¿«ç…§æœºåˆ¶** | **å®ç°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** |
|--------|------------|-------------|-------------|
| ğŸ”µ **MySQL** | `MVCC + å¯é‡å¤è¯»` | `å•äº‹åŠ¡å†…å¯¼å‡º` | `ä¸­å°å‹æ•°æ®` |
| ğŸŸ  **Oracle** | `é—ªå›æŸ¥è¯¢` | `AS OF TIMESTAMP` | `å¤§å‹ä¼ä¸šåº”ç”¨` |
| ğŸŸ£ **PostgreSQL** | `MVCC + åºåˆ—åŒ–` | `SERIALIZABLEéš”ç¦»çº§åˆ«` | `é«˜å¹¶å‘åœºæ™¯` |
| ğŸ”´ **SQL Server** | `å¿«ç…§éš”ç¦»` | `SNAPSHOT ISOLATION` | `æ··åˆå·¥ä½œè´Ÿè½½` |

### 2.3 å¿«ç…§å¯¼å‡ºå®è·µç­–ç•¥


**ğŸ¯ MySQLå¿«ç…§å¯¼å‡º**
```sql
-- å¼€å§‹å¿«ç…§äº‹åŠ¡
START TRANSACTION WITH CONSISTENT SNAPSHOT;

-- è®°å½•å¿«ç…§æ—¶é—´ç‚¹
SELECT NOW() AS snapshot_time;

-- å¯¼å‡ºä¸»è¡¨æ•°æ®
SELECT * INTO OUTFILE '/tmp/orders.csv'
FROM orders 
WHERE status IN ('pending', 'processing');

-- å¯¼å‡ºå…³è”è¡¨æ•°æ®ï¼ˆåœ¨åŒä¸€å¿«ç…§ä¸­ï¼‰
SELECT oi.* INTO OUTFILE '/tmp/order_items.csv'
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
WHERE o.status IN ('pending', 'processing');

-- ç»“æŸäº‹åŠ¡
COMMIT;
```

**âš¡ Oracleé—ªå›æŸ¥è¯¢**
```sql
-- è®¾ç½®å¿«ç…§æ—¶é—´ç‚¹
DECLARE
    snapshot_time TIMESTAMP := SYSTIMESTAMP;
BEGIN
    -- å¯¼å‡ºæŒ‡å®šæ—¶é—´ç‚¹çš„æ•°æ®
    SELECT * FROM orders 
    AS OF TIMESTAMP snapshot_time
    WHERE create_date >= DATE '2025-01-01';
    
    SELECT * FROM order_items 
    AS OF TIMESTAMP snapshot_time
    WHERE order_id IN (
        SELECT id FROM orders 
        AS OF TIMESTAMP snapshot_time
        WHERE create_date >= DATE '2025-01-01'
    );
END;
```

### 2.4 å¿«ç…§å¯¼å‡ºçš„æ€§èƒ½è€ƒè™‘


**ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ğŸ”¸ å¿«ç…§å¤§å°æ§åˆ¶
â€¢ æŒ‰æ—¶é—´èŒƒå›´åˆ†å‰²ï¼šæ¯æ¬¡å¯¼å‡ºä¸€ä¸ªæœˆçš„æ•°æ®
â€¢ æŒ‰ä¸šåŠ¡é€»è¾‘åˆ†å‰²ï¼šæŒ‰ç”¨æˆ·ã€æŒ‰åœ°åŒºåˆ†æ‰¹å¯¼å‡º
â€¢ å¢é‡å¯¼å‡ºï¼šåªå¯¼å‡ºå˜æ›´çš„æ•°æ®

ğŸ”¸ é”å†²çªæœ€å°åŒ–
â€¢ é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸï¼šå‡Œæ™¨æˆ–å‘¨æœ«æ‰§è¡Œ
â€¢ ä½¿ç”¨è¯»å–é”ï¼šé¿å…é•¿æ—¶é—´å†™é”
â€¢ åˆ†æ‰¹æ¬¡å¤„ç†ï¼šå‡å°‘å•æ¬¡äº‹åŠ¡æ—¶é—´

ğŸ”¸ èµ„æºä½¿ç”¨ä¼˜åŒ–
â€¢ å†…å­˜ç¼“å†²æ§åˆ¶ï¼šé¿å…å¤§ç»“æœé›†å ç”¨è¿‡å¤šå†…å­˜
â€¢ å¹¶è¡Œå¯¼å‡ºï¼šä¸ç›¸å…³çš„è¡¨å¯ä»¥å¹¶è¡Œå¤„ç†
â€¢ å‹ç¼©ä¼ è¾“ï¼šå‡å°‘ç½‘ç»œå’Œå­˜å‚¨å¼€é”€
```

---

## 3. ğŸ›ï¸ å¯¼å…¥äº‹åŠ¡è¾¹ç•Œæ§åˆ¶


### 3.1 äº‹åŠ¡è¾¹ç•Œçš„é‡è¦æ€§


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº‹åŠ¡è¾¹ç•Œ**
```
é€šä¿—ç†è§£ï¼šäº‹åŠ¡è¾¹ç•Œå°±æ˜¯"ä¸€å£æ°”è¦åšå®Œçš„äº‹æƒ…"çš„èŒƒå›´

ä¾‹å­ï¼šç½‘è´­ä¸‹å•æµç¨‹
è¾¹ç•Œ1ï¼šæ£€æŸ¥åº“å­˜ â†’ æ‰£å‡åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ ç”Ÿæˆæ”¯ä»˜å•
è¦æ±‚ï¼šè¿™4æ­¥å¿…é¡»åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

æ•°æ®å¯¼å…¥ä¸­çš„äº‹åŠ¡è¾¹ç•Œï¼š
è¾¹ç•Œ2ï¼šéªŒè¯æ•°æ® â†’ æ’å…¥ä¸»è¡¨ â†’ æ’å…¥å…³è”è¡¨ â†’ æ›´æ–°ç»Ÿè®¡
è¦æ±‚ï¼šä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé¿å…éƒ¨åˆ†å¯¼å…¥æˆåŠŸçš„æƒ…å†µ
```

### 3.2 ä¸åŒç²’åº¦çš„äº‹åŠ¡ç­–ç•¥


**ğŸ“Š äº‹åŠ¡ç²’åº¦å¯¹æ¯”**

| ç²’åº¦ç±»å‹ | **äº‹åŠ¡èŒƒå›´** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|---------|-------------|
| ğŸ¯ **è®°å½•çº§** | `æ¯æ¡è®°å½•ä¸€ä¸ªäº‹åŠ¡` | `å¤±è´¥å½±å“å°` | `æ€§èƒ½å·®ï¼Œå¼€é”€å¤§` | `å°‘é‡å…³é”®æ•°æ®` |
| ğŸ“¦ **æ‰¹æ¬¡çº§** | `æ¯æ‰¹æ¬¡ä¸€ä¸ªäº‹åŠ¡` | `æ€§èƒ½å¥½ï¼Œå¯æ§` | `éƒ¨åˆ†å¤±è´¥å¤æ‚` | `å¸¸è§„æ‰¹é‡å¯¼å…¥` |
| ğŸŒ **æ–‡ä»¶çº§** | `æ•´ä¸ªæ–‡ä»¶ä¸€ä¸ªäº‹åŠ¡` | `ä¸€è‡´æ€§æœ€å¥½` | `å¤±è´¥å…¨éƒ¨é‡æ¥` | `å°æ–‡ä»¶ï¼Œå¼ºä¸€è‡´æ€§` |

### 3.3 æ‰¹æ¬¡äº‹åŠ¡å®ç°


**ğŸ”„ æ‰¹æ¬¡æ§åˆ¶ç¤ºä¾‹**
```python
import pymysql

def import_with_batch_transaction(data_file, batch_size=1000):
    """
    æ‰¹æ¬¡äº‹åŠ¡å¯¼å…¥ï¼šæ¯1000æ¡è®°å½•ä¸ºä¸€ä¸ªäº‹åŠ¡
    """
    connection = pymysql.connect(host='localhost', user='user', password='pwd', database='test')
    
    try:
        with open(data_file, 'r') as file:
            batch = []
            line_count = 0
            
            for line in file:
                batch.append(parse_line(line))
                line_count += 1
                
                # è¾¾åˆ°æ‰¹æ¬¡å¤§å°ï¼Œå¼€å§‹äº‹åŠ¡å¤„ç†
                if len(batch) >= batch_size:
                    process_batch_transaction(connection, batch)
                    batch = []  # æ¸…ç©ºæ‰¹æ¬¡
                    print(f"å·²å¤„ç† {line_count} æ¡è®°å½•")
            
            # å¤„ç†æœ€åä¸€æ‰¹ä¸æ»¡æ‰¹æ¬¡å¤§å°çš„æ•°æ®
            if batch:
                process_batch_transaction(connection, batch)
                
    except Exception as e:
        print(f"å¯¼å…¥è¿‡ç¨‹å‘ç”Ÿé”™è¯¯: {e}")
        raise
    finally:
        connection.close()

def process_batch_transaction(connection, batch):
    """
    å¤„ç†å•ä¸ªæ‰¹æ¬¡çš„äº‹åŠ¡
    """
    cursor = connection.cursor()
    
    try:
        # å¼€å§‹äº‹åŠ¡
        connection.begin()
        
        # æ‰¹é‡æ’å…¥æ•°æ®
        for record in batch:
            # æ’å…¥ä¸»è¡¨
            cursor.execute("""
                INSERT INTO orders (id, customer_id, amount, status) 
                VALUES (%s, %s, %s, %s)
            """, (record.id, record.customer_id, record.amount, record.status))
            
            # æ’å…¥å…³è”è¡¨
            for item in record.items:
                cursor.execute("""
                    INSERT INTO order_items (order_id, product_id, quantity, price)
                    VALUES (%s, %s, %s, %s)
                """, (record.id, item.product_id, item.quantity, item.price))
        
        # æäº¤äº‹åŠ¡
        connection.commit()
        print(f"æ‰¹æ¬¡äº‹åŠ¡æäº¤æˆåŠŸï¼Œå¤„ç†äº† {len(batch)} æ¡è®°å½•")
        
    except Exception as e:
        # å›æ»šäº‹åŠ¡
        connection.rollback()
        print(f"æ‰¹æ¬¡äº‹åŠ¡å›æ»šï¼š{e}")
        raise
    finally:
        cursor.close()
```

### 3.4 äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡åŸåˆ™**
```
ğŸ”¸ ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§
â€¢ ç›¸å…³çš„æ•°æ®å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­
â€¢ ä¾‹ï¼šè®¢å•+è®¢å•é¡¹+åº“å­˜æ‰£å‡

ğŸ”¸ æ€§èƒ½ä¸ä¸€è‡´æ€§å¹³è¡¡
â€¢ äº‹åŠ¡å¤ªå°ï¼šæ€§èƒ½å·®ï¼Œå¼€é”€å¤§
â€¢ äº‹åŠ¡å¤ªå¤§ï¼šå¤±è´¥å½±å“å¤§ï¼Œé”æ—¶é—´é•¿
â€¢ æœ€ä½³å®è·µï¼š1000-5000æ¡è®°å½•ä¸€ä¸ªæ‰¹æ¬¡

ğŸ”¸ é”™è¯¯æ¢å¤ä¾¿åˆ©æ€§
â€¢ å¤±è´¥åå®¹æ˜“å®šä½é—®é¢˜ä½ç½®
â€¢ æ”¯æŒä»ä¸­æ–­ç‚¹ç»§ç»­å¯¼å…¥
â€¢ é¿å…å¤§äº‹åŠ¡çš„å…¨éƒ¨é‡æ¥
```

---

## 4. ğŸ“¦ å¤§æ‰¹é‡å¯¼å…¥äº‹åŠ¡ç­–ç•¥


### 4.1 å¤§æ‰¹é‡å¯¼å…¥é¢ä¸´çš„æŒ‘æˆ˜


**âš ï¸ ä¸»è¦æŒ‘æˆ˜**
```
ğŸ”¸ èµ„æºæ¶ˆè€—é—®é¢˜
â€¢ å†…å­˜å ç”¨ï¼šå¤§äº‹åŠ¡å ç”¨å¤§é‡å†…å­˜ç¼“å†²åŒº
â€¢ æ—¥å¿—ç©ºé—´ï¼šäº‹åŠ¡æ—¥å¿—æ–‡ä»¶å¿«é€Ÿå¢é•¿
â€¢ é”ç«äº‰ï¼šé•¿æ—¶é—´æŒé”å½±å“å…¶ä»–æ“ä½œ

ğŸ”¸ å¤±è´¥æ¢å¤æˆæœ¬
â€¢ å…¨éƒ¨é‡æ¥ï¼šå‡ å°æ—¶çš„å¯¼å…¥å› æœ€åä¸€æ¡è®°å½•å¤±è´¥è€Œé‡æ¥
â€¢ çŠ¶æ€æ··ä¹±ï¼šéƒ¨åˆ†æˆåŠŸçš„æ•°æ®éš¾ä»¥æ¸…ç†
â€¢ æ—¶é—´çª—å£ï¼šä¸šåŠ¡ç³»ç»Ÿç­‰å¾…æ—¶é—´è¿‡é•¿
```

**ğŸ“Š æ‰¹é‡å¤§å°é€‰æ‹©å‚è€ƒ**

| æ•°æ®é‡çº§ | **æ¨èæ‰¹æ¬¡å¤§å°** | **äº‹åŠ¡æ—¶é•¿** | **å†…å­˜å ç”¨** | **é£é™©è¯„ä¼°** |
|---------|----------------|-------------|-------------|-------------|
| ğŸŸ¢ **< 1ä¸‡** | `å…¨éƒ¨ä¸€æ¬¡æ€§` | `< 1ç§’` | `< 10MB` | `ä½é£é™©` |
| ğŸŸ¡ **1-10ä¸‡** | `5000æ¡/æ‰¹æ¬¡` | `10-30ç§’` | `50-100MB` | `ä¸­ç­‰é£é™©` |
| ğŸŸ  **10-100ä¸‡** | `2000æ¡/æ‰¹æ¬¡` | `30-60ç§’` | `100-200MB` | `è¾ƒé«˜é£é™©` |
| ğŸ”´ **> 100ä¸‡** | `1000æ¡/æ‰¹æ¬¡` | `60-120ç§’` | `200MB+` | `é«˜é£é™©` |

### 4.2 åˆ†æ‰¹å¤„ç†ç­–ç•¥


**ğŸ”„ æ™ºèƒ½åˆ†æ‰¹ç®—æ³•**
```python
class SmartBatchProcessor:
    def __init__(self, connection, initial_batch_size=2000):
        self.connection = connection
        self.batch_size = initial_batch_size
        self.success_count = 0
        self.error_count = 0
        
    def adaptive_import(self, data_stream):
        """
        è‡ªé€‚åº”æ‰¹æ¬¡å¤§å°çš„å¯¼å…¥ç­–ç•¥
        """
        batch = []
        
        for record in data_stream:
            batch.append(record)
            
            # è¾¾åˆ°æ‰¹æ¬¡å¤§å°æˆ–æ•°æ®æµç»“æŸ
            if len(batch) >= self.batch_size:
                success = self.process_batch(batch)
                
                # æ ¹æ®æˆåŠŸç‡è°ƒæ•´æ‰¹æ¬¡å¤§å°
                if success:
                    self.success_count += 1
                    # è¿ç»­æˆåŠŸå¯ä»¥é€‚å½“å¢å¤§æ‰¹æ¬¡
                    if self.success_count > 5:
                        self.batch_size = min(self.batch_size * 1.2, 5000)
                else:
                    self.error_count += 1
                    # å‡ºç°é”™è¯¯å‡å°æ‰¹æ¬¡å¤§å°
                    self.batch_size = max(self.batch_size * 0.7, 500)
                
                batch = []  # æ¸…ç©ºæ‰¹æ¬¡
        
        # å¤„ç†æœ€åä¸€æ‰¹
        if batch:
            self.process_batch(batch)
    
    def process_batch(self, batch):
        """
        å¤„ç†å•ä¸ªæ‰¹æ¬¡ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
        """
        cursor = self.connection.cursor()
        
        try:
            # è®°å½•æ‰¹æ¬¡å¼€å§‹æ—¶é—´
            start_time = time.time()
            
            self.connection.begin()
            
            # æ‰¹é‡æ’å…¥
            for record in batch:
                self.insert_record(cursor, record)
            
            self.connection.commit()
            
            # è®°å½•æ€§èƒ½æŒ‡æ ‡
            duration = time.time() - start_time
            print(f"æ‰¹æ¬¡æˆåŠŸï¼š{len(batch)}æ¡è®°å½•ï¼Œè€—æ—¶{duration:.2f}ç§’")
            
            return True
            
        except Exception as e:
            self.connection.rollback()
            print(f"æ‰¹æ¬¡å¤±è´¥ï¼š{e}")
            return False
        finally:
            cursor.close()
```

### 4.3 å†…å­˜ä¼˜åŒ–ç­–ç•¥


**ğŸ’¾ å†…å­˜ç®¡ç†**
```python
def memory_efficient_import(file_path, batch_size=1000):
    """
    å†…å­˜é«˜æ•ˆçš„å¯¼å…¥ç­–ç•¥ï¼šæµå¼å¤„ç†
    """
    def record_generator(file_path):
        """
        ç”Ÿæˆå™¨æ¨¡å¼ï¼šé€è¡Œè¯»å–ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
        """
        with open(file_path, 'r') as file:
            for line in file:
                yield parse_record(line)  # é€ä¸ªäº§ç”Ÿè®°å½•
    
    connection = get_connection()
    batch = []
    
    # ä½¿ç”¨ç”Ÿæˆå™¨ï¼Œå†…å­˜å ç”¨å§‹ç»ˆå¾ˆå°
    for record in record_generator(file_path):
        batch.append(record)
        
        if len(batch) >= batch_size:
            # å¤„ç†æ‰¹æ¬¡
            process_batch_with_validation(connection, batch)
            batch = []  # ç«‹å³é‡Šæ”¾å†…å­˜
            
            # å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¯é€‰ï¼‰
            import gc
            gc.collect()
```

---

## 5. ğŸ”„ å¯¼å…¥å¤±è´¥å›æ»šæœºåˆ¶


### 5.1 å›æ»šæœºåˆ¶è®¾è®¡æ€è·¯


**ğŸ”¸ å›æ»šçš„å¿…è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦å›æ»šï¼š
â€¢ æ•°æ®å®Œæ•´æ€§ï¼šé¿å…éƒ¨åˆ†æˆåŠŸå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
â€¢ ä¸šåŠ¡è¿ç»­æ€§ï¼šå¤±è´¥åèƒ½å¿«é€Ÿæ¢å¤åˆ°ç¨³å®šçŠ¶æ€
â€¢ é‡æ–°æ‰§è¡Œï¼šæ¸…ç†å¤±è´¥çŠ¶æ€ï¼Œæ”¯æŒé‡æ–°å¯¼å…¥

å›æ»šçš„æŒ‘æˆ˜ï¼š
â€¢ å…³è”å…³ç³»ï¼šéœ€è¦æŒ‰ä¾èµ–é¡ºåºå€’åºåˆ é™¤
â€¢ æ€§èƒ½å½±å“ï¼šå¤§é‡åˆ é™¤æ“ä½œçš„æ€§èƒ½é—®é¢˜
â€¢ çŠ¶æ€è·Ÿè¸ªï¼šè®°å½•å“ªäº›æ•°æ®å·²ç»æ’å…¥
```

### 5.2 æ¸è¿›å¼å›æ»šç­–ç•¥


**ğŸ“‹ å›æ»šå®ç°æµç¨‹**
```
å¯¼å…¥æµç¨‹ä¸å›æ»šè®¾è®¡ï¼š

Step 1: æ•°æ®é¢„å¤„ç†     â† å¤±è´¥ç‚¹1ï¼šæ ¼å¼é”™è¯¯
  â†“
Step 2: æ’å…¥ä¸»è¡¨æ•°æ®   â† å¤±è´¥ç‚¹2ï¼šä¸»é”®å†²çª  
  â†“
Step 3: æ’å…¥å…³è”è¡¨     â† å¤±è´¥ç‚¹3ï¼šå¤–é”®çº¦æŸ
  â†“
Step 4: æ›´æ–°ç»Ÿè®¡ä¿¡æ¯   â† å¤±è´¥ç‚¹4ï¼šè®¡ç®—é”™è¯¯

å›æ»šç­–ç•¥ï¼š
å¤±è´¥ç‚¹4 â†’ åªéœ€å›æ»šç»Ÿè®¡ä¿¡æ¯
å¤±è´¥ç‚¹3 â†’ å›æ»šå…³è”è¡¨ + ç»Ÿè®¡ä¿¡æ¯
å¤±è´¥ç‚¹2 â†’ å›æ»šä¸»è¡¨ + å…³è”è¡¨ + ç»Ÿè®¡ä¿¡æ¯
å¤±è´¥ç‚¹1 â†’ æ— éœ€å›æ»šï¼Œç›´æ¥ä¿®å¤é‡è¯•
```

**ğŸ”§ åˆ†æ®µå›æ»šå®ç°**
```python
class TransactionManager:
    def __init__(self, connection):
        self.connection = connection
        self.savepoints = []  # ä¿å­˜ç‚¹åˆ—è¡¨
        
    def import_with_savepoints(self, data_batches):
        """
        ä½¿ç”¨ä¿å­˜ç‚¹çš„åˆ†æ®µå›æ»šå¯¼å…¥
        """
        cursor = self.connection.cursor()
        
        try:
            self.connection.begin()
            
            for i, batch in enumerate(data_batches):
                # åˆ›å»ºä¿å­˜ç‚¹
                savepoint_name = f"batch_{i}"
                cursor.execute(f"SAVEPOINT {savepoint_name}")
                self.savepoints.append(savepoint_name)
                
                try:
                    # å¤„ç†å½“å‰æ‰¹æ¬¡
                    self.process_batch(cursor, batch)
                    print(f"æ‰¹æ¬¡ {i+1} å¯¼å…¥æˆåŠŸ")
                    
                except Exception as batch_error:
                    # å›æ»šåˆ°ä¿å­˜ç‚¹
                    cursor.execute(f"ROLLBACK TO SAVEPOINT {savepoint_name}")
                    print(f"æ‰¹æ¬¡ {i+1} å¤±è´¥ï¼Œå›æ»šåˆ°ä¿å­˜ç‚¹ï¼š{batch_error}")
                    
                    # è®°å½•å¤±è´¥æ‰¹æ¬¡ï¼Œç¨åé‡è¯•
                    self.record_failed_batch(i, batch, batch_error)
            
            # æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæˆï¼Œæäº¤äº‹åŠ¡
            self.connection.commit()
            print("æ•´ä½“å¯¼å…¥å®Œæˆ")
            
        except Exception as e:
            # æ•´ä½“å¤±è´¥ï¼Œå®Œå…¨å›æ»š
            self.connection.rollback()
            print(f"å¯¼å…¥å®Œå…¨å¤±è´¥ï¼Œå…¨éƒ¨å›æ»šï¼š{e}")
            raise
        finally:
            cursor.close()
```

### 5.3 å›æ»šçŠ¶æ€è¿½è¸ª


**ğŸ“ çŠ¶æ€è®°å½•æœºåˆ¶**
```sql
-- åˆ›å»ºå¯¼å…¥çŠ¶æ€è·Ÿè¸ªè¡¨
CREATE TABLE import_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    import_session VARCHAR(50),      -- å¯¼å…¥ä¼šè¯ID
    table_name VARCHAR(50),          -- è¡¨å
    batch_number INT,                -- æ‰¹æ¬¡å·
    start_time TIMESTAMP,            -- å¼€å§‹æ—¶é—´
    end_time TIMESTAMP,              -- ç»“æŸæ—¶é—´
    record_count INT,                -- è®°å½•æ•°é‡
    status ENUM('processing', 'success', 'failed', 'rollback'),
    error_message TEXT,              -- é”™è¯¯ä¿¡æ¯
    rollback_time TIMESTAMP          -- å›æ»šæ—¶é—´
);
```

**ğŸ¯ å›æ»šè¿½è¸ªç¤ºä¾‹**
```python
def import_with_logging(data_file, session_id):
    """
    å¸¦çŠ¶æ€æ—¥å¿—çš„å¯¼å…¥å›æ»š
    """
    connection = get_connection()
    
    try:
        # è®°å½•å¯¼å…¥å¼€å§‹
        log_import_start(session_id, data_file)
        
        batches = split_into_batches(data_file)
        
        for batch_num, batch in enumerate(batches):
            # è®°å½•æ‰¹æ¬¡å¼€å§‹
            log_batch_start(session_id, batch_num, len(batch))
            
            try:
                process_batch(connection, batch)
                # è®°å½•æ‰¹æ¬¡æˆåŠŸ
                log_batch_success(session_id, batch_num)
                
            except Exception as e:
                # è®°å½•æ‰¹æ¬¡å¤±è´¥
                log_batch_failed(session_id, batch_num, str(e))
                
                # æ‰§è¡Œå›æ»š
                rollback_batch(connection, session_id, batch_num)
                
                # è®°å½•å›æ»šå®Œæˆ
                log_batch_rollback(session_id, batch_num)
                
                raise
    
    except Exception as e:
        # æ•´ä½“å›æ»š
        rollback_entire_import(connection, session_id)
        raise

def rollback_batch(connection, session_id, failed_batch_num):
    """
    å›æ»šæŒ‡å®šæ‰¹æ¬¡åŠä¹‹åçš„æ‰€æœ‰æ•°æ®
    """
    cursor = connection.cursor()
    
    # æŸ¥è¯¢éœ€è¦å›æ»šçš„æ‰¹æ¬¡
    cursor.execute("""
        SELECT table_name, batch_number FROM import_log 
        WHERE import_session = %s AND batch_number >= %s
        AND status = 'success'
        ORDER BY batch_number DESC  -- å€’åºåˆ é™¤
    """, (session_id, failed_batch_num))
    
    rollback_batches = cursor.fetchall()
    
    for table_name, batch_num in rollback_batches:
        # åˆ é™¤è¯¥æ‰¹æ¬¡çš„æ•°æ®
        cursor.execute(f"""
            DELETE FROM {table_name} 
            WHERE import_session = %s AND import_batch = %s
        """, (session_id, batch_num))
        
        # æ›´æ–°æ—¥å¿—çŠ¶æ€
        update_log_status(session_id, batch_num, 'rollback')
```

---

## 6. âœ… ä¸€è‡´æ€§æ£€æŸ¥ç‚¹è®¾ç½®


### 6.1 æ£€æŸ¥ç‚¹çš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ£€æŸ¥ç‚¹**
```
é€šä¿—ç†è§£ï¼šæ£€æŸ¥ç‚¹å°±åƒæ¸¸æˆä¸­çš„"å­˜æ¡£ç‚¹"

æ¸¸æˆå­˜æ¡£ï¼š
é—¯å…³æ¸¸æˆ â†’ ç¬¬3å…³å­˜æ¡£ â†’ ç¬¬6å…³å­˜æ¡£ â†’ ç¬¬10å…³Boss
å¦‚æœBosså¤±è´¥ï¼Œå¯ä»¥ä»ç¬¬6å…³å­˜æ¡£é‡æ–°å¼€å§‹ï¼Œä¸ç”¨ä»å¤´æ¥

æ•°æ®å¯¼å…¥æ£€æŸ¥ç‚¹ï¼š
éªŒè¯é˜¶æ®µ â†’ æ£€æŸ¥ç‚¹1 â†’ ä¸»è¡¨å¯¼å…¥ â†’ æ£€æŸ¥ç‚¹2 â†’ å…³è”è¡¨å¯¼å…¥ â†’ æ£€æŸ¥ç‚¹3
å¦‚æœå…³è”è¡¨å¤±è´¥ï¼Œå¯ä»¥ä»æ£€æŸ¥ç‚¹2æ¢å¤ï¼Œä¸ç”¨é‡æ–°éªŒè¯å’Œå¯¼å…¥ä¸»è¡¨
```

### 6.2 æ£€æŸ¥ç‚¹è®¾ç½®ç­–ç•¥


**ğŸ“ æ£€æŸ¥ç‚¹ä½ç½®é€‰æ‹©**
```
ğŸ”¸ é€»è¾‘è¾¹ç•Œè®¾ç½®
é˜¶æ®µ1ï¼šæ•°æ®æ ¼å¼éªŒè¯å®Œæˆ     â† æ£€æŸ¥ç‚¹A
é˜¶æ®µ2ï¼šä¸»è¡¨æ•°æ®å¯¼å…¥å®Œæˆ     â† æ£€æŸ¥ç‚¹B  
é˜¶æ®µ3ï¼šå…³è”è¡¨æ•°æ®å¯¼å…¥å®Œæˆ   â† æ£€æŸ¥ç‚¹C
é˜¶æ®µ4ï¼šç´¢å¼•é‡å»ºå®Œæˆ        â† æ£€æŸ¥ç‚¹D
é˜¶æ®µ5ï¼šç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ     â† æ£€æŸ¥ç‚¹E

ğŸ”¸ æ—¶é—´è¾¹ç•Œè®¾ç½®
æ¯5åˆ†é’Ÿè®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹
æ¯å¤„ç†10ä¸‡æ¡è®°å½•è®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹
æ¯å®Œæˆä¸€å¼ è¡¨çš„å¯¼å…¥è®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹
```

### 6.3 æ£€æŸ¥ç‚¹å®ç°æœºåˆ¶


**ğŸ’¾ çŠ¶æ€ä¿å­˜å®ç°**
```python
import json
import pickle
from datetime import datetime

class CheckpointManager:
    def __init__(self, session_id):
        self.session_id = session_id
        self.checkpoint_file = f"checkpoint_{session_id}.json"
        
    def save_checkpoint(self, stage, progress_data):
        """
        ä¿å­˜æ£€æŸ¥ç‚¹çŠ¶æ€
        """
        checkpoint = {
            'session_id': self.session_id,
            'stage': stage,
            'timestamp': datetime.now().isoformat(),
            'progress': progress_data,
            'next_action': self.determine_next_action(stage)
        }
        
        with open(self.checkpoint_file, 'w') as f:
            json.dump(checkpoint, f, indent=2)
        
        print(f"æ£€æŸ¥ç‚¹å·²ä¿å­˜ï¼šé˜¶æ®µ {stage}")
    
    def load_checkpoint(self):
        """
        åŠ è½½æœ€è¿‘çš„æ£€æŸ¥ç‚¹
        """
        try:
            with open(self.checkpoint_file, 'r') as f:
                checkpoint = json.load(f)
            print(f"æ£€æŸ¥ç‚¹å·²åŠ è½½ï¼šé˜¶æ®µ {checkpoint['stage']}")
            return checkpoint
        except FileNotFoundError:
            print("æœªæ‰¾åˆ°æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼Œä»å¤´å¼€å§‹")
            return None
    
    def resume_from_checkpoint(self, data_file):
        """
        ä»æ£€æŸ¥ç‚¹æ¢å¤å¯¼å…¥
        """
        checkpoint = self.load_checkpoint()
        
        if checkpoint is None:
            # ä»å¤´å¼€å§‹
            return self.start_fresh_import(data_file)
        
        stage = checkpoint['stage']
        progress = checkpoint['progress']
        
        print(f"ä»é˜¶æ®µ {stage} æ¢å¤å¯¼å…¥")
        
        if stage == 'validation_complete':
            # è·³è¿‡éªŒè¯é˜¶æ®µï¼Œç›´æ¥å¼€å§‹å¯¼å…¥
            return self.start_main_import(data_file, progress['validated_count'])
            
        elif stage == 'main_table_complete':
            # è·³è¿‡ä¸»è¡¨ï¼Œå¼€å§‹å…³è”è¡¨å¯¼å…¥
            return self.start_related_import(data_file, progress['main_table_count'])
            
        elif stage == 'import_complete':
            # åªéœ€è¦é‡å»ºç´¢å¼•å’Œç»Ÿè®¡
            return self.rebuild_indexes_only(progress['total_count'])

def example_checkpoint_usage():
    """
    ä½¿ç”¨æ£€æŸ¥ç‚¹çš„å¯¼å…¥ç¤ºä¾‹
    """
    session_id = f"import_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    checkpoint_mgr = CheckpointManager(session_id)
    
    try:
        # é˜¶æ®µ1ï¼šæ•°æ®éªŒè¯
        validated_data = validate_import_data('data.csv')
        checkpoint_mgr.save_checkpoint('validation_complete', {
            'validated_count': len(validated_data),
            'file_path': 'data.csv'
        })
        
        # é˜¶æ®µ2ï¼šä¸»è¡¨å¯¼å…¥
        main_count = import_main_tables(validated_data)
        checkpoint_mgr.save_checkpoint('main_table_complete', {
            'main_table_count': main_count,
            'total_validated': len(validated_data)
        })
        
        # é˜¶æ®µ3ï¼šå…³è”è¡¨å¯¼å…¥
        related_count = import_related_tables(validated_data)
        checkpoint_mgr.save_checkpoint('related_table_complete', {
            'related_count': related_count,
            'main_count': main_count
        })
        
        # é˜¶æ®µ4ï¼šé‡å»ºç´¢å¼•
        rebuild_indexes()
        checkpoint_mgr.save_checkpoint('import_complete', {
            'total_count': main_count + related_count
        })
        
    except Exception as e:
        print(f"å¯¼å…¥å¤±è´¥ï¼Œå¯ä»æœ€è¿‘æ£€æŸ¥ç‚¹æ¢å¤ï¼š{e}")
        # ä¿ç•™æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼Œæ”¯æŒæ¢å¤
        raise
```

### 6.4 æ£€æŸ¥ç‚¹æ¢å¤æœºåˆ¶


**ğŸ”„ æ¢å¤æµç¨‹å›¾**
```
å¯¼å…¥å¼€å§‹
    â†“
æ£€æŸ¥æ˜¯å¦æœ‰æ£€æŸ¥ç‚¹æ–‡ä»¶ï¼Ÿ
    â†“              â†“
   æ˜¯             å¦
    â†“              â†“
è¯»å–æœ€è¿‘æ£€æŸ¥ç‚¹    ä»å¤´å¼€å§‹å¯¼å…¥
    â†“              â†“
ç¡®å®šæ¢å¤é˜¶æ®µ      æ•°æ®éªŒè¯
    â†“              â†“
è·³è¿‡å·²å®Œæˆæ­¥éª¤    ä¸»è¡¨å¯¼å…¥
    â†“              â†“
ç»§ç»­æœªå®Œæˆéƒ¨åˆ†    å…³è”è¡¨å¯¼å…¥
    â†“              â†“
    â””â”€â”€å¯¼å…¥å®Œæˆâ”€â”€â”€â”˜
```

---

## 7. ğŸ” å¯¼å…¥æ•°æ®éªŒè¯æœºåˆ¶


### 7.1 å¤šå±‚æ¬¡éªŒè¯ç­–ç•¥


**ğŸ”¸ éªŒè¯å±‚æ¬¡ç»“æ„**
```
ğŸ“Š æ•°æ®éªŒè¯é‡‘å­—å¡”ï¼š

ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘éªŒè¯ â†â”€ è®¢å•çŠ¶æ€ä¸æ”¯ä»˜çŠ¶æ€åŒ¹é…
         â†‘
ç¬¬3å±‚ï¼šå…³è”å…³ç³»éªŒè¯ â†â”€ å¤–é”®å¼•ç”¨å®Œæ•´æ€§
         â†‘  
ç¬¬2å±‚ï¼šæ•°æ®æ ¼å¼éªŒè¯ â†â”€ æ—¥æœŸæ ¼å¼ã€æ•°å­—èŒƒå›´
         â†‘
ç¬¬1å±‚ï¼šæ•°æ®ç±»å‹éªŒè¯ â†â”€ å­—ç¬¦ä¸²ã€æ•´æ•°ã€å¸ƒå°”å€¼

éªŒè¯åŸåˆ™ï¼šä»åº•å±‚åˆ°é«˜å±‚ï¼Œé€æ­¥ä¸¥æ ¼
```

### 7.2 æ ¼å¼éªŒè¯å®ç°


**âœ… åŸºç¡€æ ¼å¼éªŒè¯**
```python
import re
from datetime import datetime
from decimal import Decimal

class DataValidator:
    def __init__(self):
        self.errors = []
        self.warnings = []
    
    def validate_record(self, record, row_number):
        """
        å•æ¡è®°å½•çš„å®Œæ•´éªŒè¯
        """
        is_valid = True
        
        # 1. å¿…å¡«å­—æ®µæ£€æŸ¥
        required_fields = ['order_id', 'customer_id', 'amount']
        for field in required_fields:
            if not record.get(field):
                self.add_error(row_number, f"å¿…å¡«å­—æ®µ {field} ä¸ºç©º")
                is_valid = False
        
        # 2. æ•°æ®ç±»å‹éªŒè¯
        if not self.validate_integer(record.get('order_id')):
            self.add_error(row_number, "è®¢å•IDå¿…é¡»æ˜¯æ­£æ•´æ•°")
            is_valid = False
            
        if not self.validate_decimal(record.get('amount')):
            self.add_error(row_number, "é‡‘é¢æ ¼å¼ä¸æ­£ç¡®")
            is_valid = False
        
        # 3. ä¸šåŠ¡è§„åˆ™éªŒè¯
        if record.get('amount') and float(record['amount']) < 0:
            self.add_error(row_number, "è®¢å•é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°")
            is_valid = False
            
        if record.get('amount') and float(record['amount']) > 100000:
            self.add_warning(row_number, "è®¢å•é‡‘é¢è¶…è¿‡10ä¸‡ï¼Œè¯·ç¡®è®¤")
        
        return is_valid
    
    def validate_integer(self, value):
        """éªŒè¯æ•´æ•°æ ¼å¼"""
        try:
            int_val = int(value)
            return int_val > 0  # ä¸šåŠ¡è¦æ±‚ï¼šå¿…é¡»æ˜¯æ­£æ•´æ•°
        except (ValueError, TypeError):
            return False
    
    def validate_decimal(self, value):
        """éªŒè¯é‡‘é¢æ ¼å¼"""
        try:
            decimal_val = Decimal(str(value))
            # æ£€æŸ¥å°æ•°ä½æ•°ï¼ˆæœ€å¤š2ä½ï¼‰
            return decimal_val.as_tuple().exponent >= -2
        except:
            return False
    
    def add_error(self, row_number, message):
        """è®°å½•é”™è¯¯"""
        self.errors.append(f"ç¬¬{row_number}è¡Œï¼š{message}")
    
    def add_warning(self, row_number, message):
        """è®°å½•è­¦å‘Š"""
        self.warnings.append(f"ç¬¬{row_number}è¡Œï¼š{message}")
```

### 7.3 å…³è”å®Œæ•´æ€§éªŒè¯


**ğŸ”— å¤–é”®å…³ç³»æ£€æŸ¥**
```python
def validate_referential_integrity(connection, import_data):
    """
    éªŒè¯å…³è”å…³ç³»å®Œæ•´æ€§
    """
    cursor = connection.cursor()
    validation_errors = []
    
    # æ£€æŸ¥å®¢æˆ·IDæ˜¯å¦å­˜åœ¨
    customer_ids = set(record['customer_id'] for record in import_data)
    
    # æ‰¹é‡æ£€æŸ¥å®¢æˆ·æ˜¯å¦å­˜åœ¨
    placeholders = ','.join(['%s'] * len(customer_ids))
    cursor.execute(f"""
        SELECT id FROM customers WHERE id IN ({placeholders})
    """, list(customer_ids))
    
    existing_customers = set(row[0] for row in cursor.fetchall())
    missing_customers = customer_ids - existing_customers
    
    if missing_customers:
        validation_errors.append(f"ä»¥ä¸‹å®¢æˆ·IDä¸å­˜åœ¨ï¼š{missing_customers}")
    
    # æ£€æŸ¥äº§å“IDæ˜¯å¦å­˜åœ¨
    product_ids = set()
    for record in import_data:
        if 'items' in record:
            for item in record['items']:
                product_ids.add(item['product_id'])
    
    cursor.execute(f"""
        SELECT id FROM products WHERE id IN ({','.join(['%s'] * len(product_ids))})
    """, list(product_ids))
    
    existing_products = set(row[0] for row in cursor.fetchall())
    missing_products = product_ids - existing_products
    
    if missing_products:
        validation_errors.append(f"ä»¥ä¸‹äº§å“IDä¸å­˜åœ¨ï¼š{missing_products}")
    
    return validation_errors
```

### 7.4 ä¸šåŠ¡é€»è¾‘éªŒè¯


**ğŸ¯ ä¸šåŠ¡è§„åˆ™æ£€æŸ¥**
```python
def validate_business_rules(record):
    """
    ä¸šåŠ¡é€»è¾‘éªŒè¯ç¤ºä¾‹
    """
    errors = []
    
    # è§„åˆ™1ï¼šè®¢å•çŠ¶æ€ä¸æ”¯ä»˜çŠ¶æ€çš„åŒ¹é…
    if record['order_status'] == 'paid' and record['payment_status'] != 'completed':
        errors.append("è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜ï¼Œä½†æ”¯ä»˜çŠ¶æ€ä¸æ˜¯å·²å®Œæˆ")
    
    # è§„åˆ™2ï¼šå•†å“æ•°é‡ä¸æ€»é‡‘é¢çš„åˆç†æ€§
    expected_amount = sum(item['quantity'] * item['price'] for item in record['items'])
    actual_amount = float(record['total_amount'])
    
    if abs(expected_amount - actual_amount) > 0.01:  # å…è®¸1åˆ†é’±çš„è¯¯å·®
        errors.append(f"è®¡ç®—æ€»é¢{expected_amount}ä¸å®é™…æ€»é¢{actual_amount}ä¸åŒ¹é…")
    
    # è§„åˆ™3ï¼šæ—¶é—´é€»è¾‘åˆç†æ€§
    create_time = datetime.fromisoformat(record['create_time'])
    update_time = datetime.fromisoformat(record['update_time'])
    
    if update_time < create_time:
        errors.append("æ›´æ–°æ—¶é—´ä¸èƒ½æ—©äºåˆ›å»ºæ—¶é—´")
    
    return errors
```

---

## 8. ğŸ”§ ä¸€è‡´æ€§æ¢å¤ç­–ç•¥


### 8.1 æ¢å¤ç­–ç•¥åˆ†ç±»


**ğŸ”„ æ¢å¤ç­–ç•¥é€‰æ‹©**
```
ğŸŸ¢ è½»é‡çº§æ¢å¤ï¼šæ•°æ®éªŒè¯å¤±è´¥
ç­–ç•¥ï¼šä¿®å¤æ•°æ®æ ¼å¼ï¼Œé‡æ–°å¯¼å…¥
å½±å“ï¼šæ— æ•°æ®åº“å˜æ›´ï¼Œå¿«é€Ÿä¿®å¤

ğŸŸ¡ ä¸­ç­‰æ¢å¤ï¼šéƒ¨åˆ†è¡¨å¯¼å…¥æˆåŠŸ
ç­–ç•¥ï¼šä»æ£€æŸ¥ç‚¹ç»§ç»­ï¼Œè¡¥å……ç¼ºå¤±æ•°æ®
å½±å“ï¼šéœ€è¦çŠ¶æ€åˆ†æï¼Œå¢é‡å¤„ç†

ğŸ”´ é‡é‡çº§æ¢å¤ï¼šä¸¥é‡æ•°æ®ä¸ä¸€è‡´
ç­–ç•¥ï¼šå®Œå…¨å›æ»šï¼Œé‡æ–°è®¾è®¡å¯¼å…¥æ–¹æ¡ˆ
å½±å“ï¼šå¯èƒ½éœ€è¦åœæœºç»´æŠ¤
```

### 8.2 å¢é‡æ¢å¤æœºåˆ¶


**ğŸ“ˆ å¢é‡ä¿®å¤å®ç°**
```python
class IncrementalRecovery:
    def __init__(self, connection, session_id):
        self.connection = connection
        self.session_id = session_id
    
    def analyze_current_state(self):
        """
        åˆ†æå½“å‰å¯¼å…¥çŠ¶æ€ï¼Œç¡®å®šæ¢å¤ç­–ç•¥
        """
        cursor = self.connection.cursor()
        
        # æŸ¥è¯¢å¯¼å…¥è¿›åº¦
        cursor.execute("""
            SELECT table_name, 
                   SUM(CASE WHEN status = 'success' THEN record_count ELSE 0 END) as success_count,
                   SUM(CASE WHEN status = 'failed' THEN record_count ELSE 0 END) as failed_count
            FROM import_log 
            WHERE import_session = %s
            GROUP BY table_name
        """, (self.session_id,))
        
        progress = cursor.fetchall()
        
        recovery_plan = {}
        for table_name, success_count, failed_count in progress:
            if failed_count > 0:
                recovery_plan[table_name] = {
                    'action': 'retry_failed',
                    'success_count': success_count,
                    'failed_count': failed_count
                }
            elif success_count > 0:
                recovery_plan[table_name] = {
                    'action': 'complete',
                    'total_count': success_count
                }
        
        return recovery_plan
    
    def execute_recovery(self, original_data_file):
        """
        æ‰§è¡Œæ¢å¤æ“ä½œ
        """
        plan = self.analyze_current_state()
        
        for table_name, action_info in plan.items():
            if action_info['action'] == 'retry_failed':
                print(f"æ­£åœ¨æ¢å¤è¡¨ {table_name} çš„å¤±è´¥æ•°æ®...")
                self.retry_failed_data(table_name, original_data_file)
            elif action_info['action'] == 'complete':
                print(f"è¡¨ {table_name} å·²å®Œæˆï¼Œè·³è¿‡")
    
    def retry_failed_data(self, table_name, data_file):
        """
        é‡è¯•å¤±è´¥çš„æ•°æ®
        """
        # è·å–å¤±è´¥çš„æ‰¹æ¬¡å·
        cursor = self.connection.cursor()
        cursor.execute("""
            SELECT batch_number FROM import_log 
            WHERE import_session = %s AND table_name = %s AND status = 'failed'
        """, (self.session_id, table_name))
        
        failed_batches = [row[0] for row in cursor.fetchall()]
        
        # é‡æ–°å¤„ç†å¤±è´¥çš„æ‰¹æ¬¡
        for batch_num in failed_batches:
            batch_data = self.extract_batch_data(data_file, batch_num)
            
            try:
                self.process_batch_safely(table_name, batch_data, batch_num)
                # æ›´æ–°æ—¥å¿—çŠ¶æ€ä¸ºæˆåŠŸ
                self.update_log_status(batch_num, 'success')
                
            except Exception as e:
                print(f"æ‰¹æ¬¡ {batch_num} é‡è¯•ä»ç„¶å¤±è´¥ï¼š{e}")
                # è®°å½•ä¸ºæ°¸ä¹…å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†
                self.update_log_status(batch_num, 'permanent_failure')
```

### 8.3 æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ


**ğŸ” å…¨é¢ä¸€è‡´æ€§æ£€æŸ¥**
```sql
-- åˆ›å»ºä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬
-- æ£€æŸ¥1ï¼šè®°å½•æ•°é‡ä¸€è‡´æ€§
SELECT 
    'è®¢å•è¡¨è®°å½•æ•°' as check_item,
    COUNT(*) as actual_count,
    (SELECT expected_count FROM import_summary WHERE table_name = 'orders') as expected_count,
    CASE WHEN COUNT(*) = (SELECT expected_count FROM import_summary WHERE table_name = 'orders') 
         THEN 'PASS' ELSE 'FAIL' END as result
FROM orders WHERE import_session = 'session_123';

-- æ£€æŸ¥2ï¼šå…³è”å…³ç³»å®Œæ•´æ€§
SELECT 
    'å­¤ç«‹è®¢å•é¡¹' as check_item,
    COUNT(*) as error_count,
    CASE WHEN COUNT(*) = 0 THEN 'PASS' ELSE 'FAIL' END as result
FROM order_items oi 
LEFT JOIN orders o ON oi.order_id = o.id 
WHERE o.id IS NULL AND oi.import_session = 'session_123';

-- æ£€æŸ¥3ï¼šä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§
SELECT 
    'é‡‘é¢è®¡ç®—ä¸€è‡´æ€§' as check_item,
    COUNT(*) as error_count,
    CASE WHEN COUNT(*) = 0 THEN 'PASS' ELSE 'FAIL' END as result
FROM orders o
WHERE ABS(o.total_amount - (
    SELECT SUM(oi.quantity * oi.price) 
    FROM order_items oi 
    WHERE oi.order_id = o.id
)) > 0.01
AND o.import_session = 'session_123';
```

**ğŸ¯ è‡ªåŠ¨åŒ–æ ¡éªŒå·¥å…·**
```python
class ConsistencyChecker:
    def __init__(self, connection, session_id):
        self.connection = connection
        self.session_id = session_id
        
    def run_full_check(self):
        """
        è¿è¡Œå®Œæ•´çš„ä¸€è‡´æ€§æ£€æŸ¥
        """
        check_results = {}
        
        # æ£€æŸ¥1ï¼šæ•°é‡ä¸€è‡´æ€§
        check_results['count_consistency'] = self.check_record_counts()
        
        # æ£€æŸ¥2ï¼šå…³è”å®Œæ•´æ€§
        check_results['referential_integrity'] = self.check_foreign_keys()
        
        # æ£€æŸ¥3ï¼šä¸šåŠ¡é€»è¾‘ä¸€è‡´æ€§
        check_results['business_logic'] = self.check_business_rules()
        
        # æ£€æŸ¥4ï¼šæ•°æ®å®Œæ•´æ€§
        check_results['data_integrity'] = self.check_data_integrity()
        
        # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
        return self.generate_report(check_results)
    
    def check_record_counts(self):
        """
        æ£€æŸ¥è®°å½•æ•°é‡æ˜¯å¦ä¸é¢„æœŸä¸€è‡´
        """
        cursor = self.connection.cursor()
        
        # è·å–é¢„æœŸæ•°é‡
        cursor.execute("""
            SELECT table_name, SUM(record_count) as expected
            FROM import_log 
            WHERE import_session = %s AND status = 'success'
            GROUP BY table_name
        """, (self.session_id,))
        
        expected_counts = dict(cursor.fetchall())
        
        # æ£€æŸ¥å®é™…æ•°é‡
        actual_counts = {}
        for table_name in expected_counts.keys():
            cursor.execute(f"""
                SELECT COUNT(*) FROM {table_name} 
                WHERE import_session = %s
            """, (self.session_id,))
            
            actual_counts[table_name] = cursor.fetchone()[0]
        
        # æ¯”è¾ƒç»“æœ
        mismatches = []
        for table_name in expected_counts:
            if expected_counts[table_name] != actual_counts[table_name]:
                mismatches.append({
                    'table': table_name,
                    'expected': expected_counts[table_name],
                    'actual': actual_counts[table_name]
                })
        
        return {
            'status': 'PASS' if not mismatches else 'FAIL',
            'details': mismatches
        }
```

### 7.3 å®æ—¶éªŒè¯ä¸å»¶è¿ŸéªŒè¯


**âš¡ éªŒè¯æ—¶æœºé€‰æ‹©**
```
ğŸ”¸ å®æ—¶éªŒè¯ï¼ˆå¯¼å…¥æ—¶éªŒè¯ï¼‰
ä¼˜ç‚¹ï¼š
â€¢ ç«‹å³å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿåé¦ˆ
â€¢ é¿å…å¯¼å…¥è„æ•°æ®
â€¢ èŠ‚çœå­˜å‚¨ç©ºé—´

ç¼ºç‚¹ï¼š
â€¢ å½±å“å¯¼å…¥æ€§èƒ½
â€¢ å¤æ‚éªŒè¯å¯èƒ½å¾ˆæ…¢
â€¢ å¢åŠ å¯¼å…¥å¤±è´¥æ¦‚ç‡

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®è´¨é‡è¦æ±‚æé«˜
â€¢ åç»­ä¿®å¤æˆæœ¬å¾ˆå¤§
â€¢ å®æ—¶ä¸šåŠ¡ç³»ç»Ÿ

ğŸ”¸ å»¶è¿ŸéªŒè¯ï¼ˆå¯¼å…¥åéªŒè¯ï¼‰
ä¼˜ç‚¹ï¼š
â€¢ å¯¼å…¥é€Ÿåº¦å¿«
â€¢ å¯ä»¥æ‰¹é‡ä¼˜åŒ–éªŒè¯
â€¢ ä¸å½±å“å¯¼å…¥æˆåŠŸç‡

ç¼ºç‚¹ï¼š
â€¢ å¯èƒ½å¯¼å…¥è„æ•°æ®
â€¢ äº‹åæ¸…ç†å¤æ‚
â€¢ å‘ç°é—®é¢˜è¾ƒæ™š

é€‚ç”¨åœºæ™¯ï¼š
â€¢ ç¦»çº¿æ•°æ®å¤„ç†
â€¢ å¤§æ‰¹é‡æ•°æ®è¿ç§»
â€¢ å¯å®¹å¿ä¸´æ—¶ä¸ä¸€è‡´
```

---

## 8. ğŸ›¡ï¸ ä¸€è‡´æ€§æ¢å¤ç­–ç•¥


### 8.1 æ¢å¤ç­–ç•¥æ¡†æ¶


**ğŸ”¸ æ¢å¤ç­–ç•¥å†³ç­–æ ‘**
```
æ•°æ®å¯¼å…¥å¤±è´¥
    â†“
è¯„ä¼°å¤±è´¥åŸå› 
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ ¼å¼é”™è¯¯      â”‚   çº¦æŸå†²çª      â”‚   ç³»ç»Ÿæ•…éšœ      â”‚
â”‚     â†“          â”‚     â†“          â”‚     â†“          â”‚
â”‚ ä¿®å¤é‡æ–°å¯¼å…¥    â”‚ æ¸…ç†å†²çªæ•°æ®    â”‚ ä»æ£€æŸ¥ç‚¹æ¢å¤    â”‚
â”‚ ï¼ˆå¿«é€Ÿæ¢å¤ï¼‰    â”‚ ï¼ˆéƒ¨åˆ†é‡æ¥ï¼‰    â”‚ ï¼ˆç»§ç»­æ‰§è¡Œï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ æ¢å¤ç­–ç•¥é€‰æ‹©æŒ‡å—**

| å¤±è´¥ç±»å‹ | **ç—‡çŠ¶è¡¨ç°** | **æ¢å¤ç­–ç•¥** | **æ‰§è¡Œæ­¥éª¤** |
|---------|------------|-------------|-------------|
| ğŸŸ¢ **æ ¼å¼é”™è¯¯** | `æ•°æ®è§£æå¤±è´¥` | `ä¿®å¤æ ¼å¼é‡å¯¼` | `ä¿®å¤æ–‡ä»¶â†’é‡æ–°éªŒè¯â†’é‡æ–°å¯¼å…¥` |
| ğŸŸ¡ **çº¦æŸå†²çª** | `ä¸»é”®/å¤–é”®å†²çª` | `æ¸…ç†å†²çªæ•°æ®` | `åˆ é™¤å†²çªè®°å½•â†’ä¿®å¤å…³ç³»â†’ç»§ç»­å¯¼å…¥` |
| ğŸŸ  **éƒ¨åˆ†æˆåŠŸ** | `æŸäº›è¡¨æˆåŠŸæŸäº›å¤±è´¥` | `å¢é‡è¡¥å……` | `åˆ†æå·®å¼‚â†’è¡¥å……ç¼ºå¤±â†’éªŒè¯å®Œæ•´æ€§` |
| ğŸ”´ **ç³»ç»Ÿæ•…éšœ** | `æ•°æ®åº“è¿æ¥æ–­å¼€` | `ä»æ£€æŸ¥ç‚¹æ¢å¤` | `æ£€æŸ¥çŠ¶æ€â†’æ¢å¤è¿æ¥â†’ç»§ç»­æ‰§è¡Œ` |

### 8.2 å†²çªè§£å†³ç­–ç•¥


**ğŸ”§ æ•°æ®å†²çªå¤„ç†**
```python
class ConflictResolver:
    def __init__(self, connection):
        self.connection = connection
        
    def resolve_primary_key_conflicts(self, table_name, conflict_records):
        """
        è§£å†³ä¸»é”®å†²çª
        """
        resolution_strategies = {
            'skip': self.skip_conflicted_records,      # è·³è¿‡å†²çªè®°å½•
            'update': self.update_existing_records,    # æ›´æ–°ç°æœ‰è®°å½•  
            'merge': self.merge_record_data,          # åˆå¹¶æ•°æ®
            'regenerate': self.regenerate_primary_key  # é‡æ–°ç”Ÿæˆä¸»é”®
        }
        
        # æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç­–ç•¥
        strategy = self.determine_strategy(table_name)
        return resolution_strategies[strategy](conflict_records)
    
    def skip_conflicted_records(self, conflicts):
        """
        ç­–ç•¥1ï¼šè·³è¿‡å†²çªè®°å½•
        é€‚ç”¨ï¼šæ•°æ®å¯ä»¥æ¥å—ä¸¢å¤±çš„æƒ…å†µ
        """
        skipped_count = 0
        for record in conflicts:
            # è®°å½•è·³è¿‡çš„åŸå› 
            self.log_skipped_record(record, "ä¸»é”®å†²çª")
            skipped_count += 1
        
        return f"è·³è¿‡äº† {skipped_count} æ¡å†²çªè®°å½•"
    
    def update_existing_records(self, conflicts):
        """
        ç­–ç•¥2ï¼šæ›´æ–°ç°æœ‰è®°å½•
        é€‚ç”¨ï¼šæ–°æ•°æ®æ¯”ç°æœ‰æ•°æ®æ›´å‡†ç¡®çš„æƒ…å†µ
        """
        cursor = self.connection.cursor()
        updated_count = 0
        
        for record in conflicts:
            try:
                # å¤‡ä»½åŸå§‹æ•°æ®
                cursor.execute(f"SELECT * FROM {record.table_name} WHERE id = %s", (record.id,))
                original_data = cursor.fetchone()
                self.backup_original_data(record.id, original_data)
                
                # æ›´æ–°è®°å½•
                cursor.execute(f"""
                    UPDATE {record.table_name} 
                    SET column1 = %s, column2 = %s, update_time = NOW()
                    WHERE id = %s
                """, (record.column1, record.column2, record.id))
                
                updated_count += 1
                
            except Exception as e:
                self.log_update_failure(record.id, str(e))
        
        return f"æ›´æ–°äº† {updated_count} æ¡å†²çªè®°å½•"
```

### 8.3 æ•°æ®ä¿®å¤å·¥å…·


**ğŸ› ï¸ è‡ªåŠ¨ä¿®å¤æœºåˆ¶**
```python
class DataRepairTool:
    def __init__(self, connection):
        self.connection = connection
        
    def repair_referential_integrity(self, session_id):
        """
        ä¿®å¤å…³è”å…³ç³»å®Œæ•´æ€§
        """
        repair_actions = []
        
        # 1. æ‰¾å‡ºå­¤ç«‹çš„è®¢å•é¡¹ï¼ˆæ²¡æœ‰å¯¹åº”è®¢å•ï¼‰
        orphaned_items = self.find_orphaned_order_items(session_id)
        
        if orphaned_items:
            # å°è¯•åˆ›å»ºç¼ºå¤±çš„è®¢å•è®°å½•
            created_orders = self.create_missing_orders(orphaned_items)
            repair_actions.append(f"åˆ›å»ºäº† {created_orders} ä¸ªç¼ºå¤±çš„è®¢å•")
        
        # 2. æ‰¾å‡ºé‡‘é¢ä¸åŒ¹é…çš„è®¢å•
        amount_mismatches = self.find_amount_mismatches(session_id)
        
        if amount_mismatches:
            # é‡æ–°è®¡ç®—è®¢å•æ€»é¢
            fixed_amounts = self.recalculate_order_amounts(amount_mismatches)
            repair_actions.append(f"ä¿®å¤äº† {fixed_amounts} ä¸ªè®¢å•çš„é‡‘é¢")
        
        # 3. ä¿®å¤æ—¶é—´æˆ³ä¸åˆç†çš„è®°å½•
        timestamp_issues = self.find_timestamp_issues(session_id)
        
        if timestamp_issues:
            fixed_timestamps = self.fix_timestamps(timestamp_issues)
            repair_actions.append(f"ä¿®å¤äº† {fixed_timestamps} ä¸ªæ—¶é—´æˆ³é—®é¢˜")
        
        return repair_actions
    
    def create_missing_orders(self, orphaned_items):
        """
        ä¸ºå­¤ç«‹çš„è®¢å•é¡¹åˆ›å»ºå¯¹åº”çš„è®¢å•è®°å½•
        """
        cursor = self.connection.cursor()
        created_count = 0
        
        # æŒ‰è®¢å•IDåˆ†ç»„
        items_by_order = {}
        for item in orphaned_items:
            order_id = item['order_id']
            if order_id not in items_by_order:
                items_by_order[order_id] = []
            items_by_order[order_id].append(item)
        
        for order_id, items in items_by_order.items():
            try:
                # è®¡ç®—è®¢å•æ€»é¢
                total_amount = sum(item['quantity'] * item['price'] for item in items)
                
                # åˆ›å»ºè®¢å•è®°å½•
                cursor.execute("""
                    INSERT INTO orders (id, customer_id, total_amount, status, create_time)
                    VALUES (%s, %s, %s, 'imported', NOW())
                """, (order_id, items[0]['customer_id'], total_amount))
                
                created_count += 1
                
            except Exception as e:
                print(f"åˆ›å»ºè®¢å• {order_id} å¤±è´¥ï¼š{e}")
        
        return created_count
```

### 8.4 æ¢å¤éªŒè¯æœºåˆ¶


**âœ… æ¢å¤åéªŒè¯**
```python
def post_recovery_validation(connection, session_id):
    """
    æ¢å¤æ“ä½œåçš„å…¨é¢éªŒè¯
    """
    validation_results = {}
    
    # éªŒè¯1ï¼šæ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    print("ğŸ” æ‰§è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥...")
    integrity_check = validate_data_integrity(connection, session_id)
    validation_results['integrity'] = integrity_check
    
    # éªŒè¯2ï¼šä¸šåŠ¡é€»è¾‘æ£€æŸ¥  
    print("ğŸ¯ æ‰§è¡Œä¸šåŠ¡é€»è¾‘æ£€æŸ¥...")
    business_check = validate_business_logic(connection, session_id)
    validation_results['business_logic'] = business_check
    
    # éªŒè¯3ï¼šæ€§èƒ½å½±å“è¯„ä¼°
    print("ğŸ“ˆ è¯„ä¼°æ€§èƒ½å½±å“...")
    performance_check = assess_performance_impact(connection, session_id)
    validation_results['performance'] = performance_check
    
    # ç”ŸæˆéªŒè¯æŠ¥å‘Š
    generate_validation_report(validation_results)
    
    return all(result['status'] == 'PASS' for result in validation_results.values())

def generate_validation_report(results):
    """
    ç”ŸæˆéªŒè¯æŠ¥å‘Š
    """
    print("\nğŸ“‹ æ¢å¤éªŒè¯æŠ¥å‘Š")
    print("=" * 50)
    
    for check_name, result in results.items():
        status_icon = "âœ…" if result['status'] == 'PASS' else "âŒ"
        print(f"{status_icon} {check_name}: {result['status']}")
        
        if result['status'] == 'FAIL':
            print(f"   é—®é¢˜è¯¦æƒ…: {result['details']}")
            print(f"   å»ºè®®æ“ä½œ: {result['recommendations']}")
    
    print("=" * 50)
```

---

## 9. ğŸ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡ä¸€è‡´æ€§ï¼šä¿è¯æ•°æ®å¯¼å…¥å¯¼å‡ºè¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
ğŸ”¸ ä¸€è‡´æ€§å¿«ç…§ï¼šåŒä¸€æ—¶é—´ç‚¹çš„å®Œæ•´æ•°æ®çŠ¶æ€ï¼Œé¿å…å¯¼å‡ºæ—¶çš„æ•°æ®å˜åŒ–
ğŸ”¸ äº‹åŠ¡è¾¹ç•Œï¼šå®šä¹‰ä¸€æ¬¡æ€§å¿…é¡»å®Œæˆçš„æ“ä½œèŒƒå›´ï¼Œæ”¯æŒåŸå­æ€§
ğŸ”¸ æ£€æŸ¥ç‚¹æœºåˆ¶ï¼šè®¾ç½®æ¢å¤ç‚¹ï¼Œæ”¯æŒä»ä¸­æ–­å¤„ç»§ç»­æ‰§è¡Œ
ğŸ”¸ éªŒè¯æœºåˆ¶ï¼šå¤šå±‚æ¬¡æ•°æ®éªŒè¯ï¼Œç¡®ä¿å¯¼å…¥æ•°æ®çš„æ­£ç¡®æ€§
ğŸ”¸ æ¢å¤ç­–ç•¥ï¼šé’ˆå¯¹ä¸åŒå¤±è´¥æƒ…å†µçš„ä¿®å¤å’Œæ¢å¤æ–¹æ¡ˆ
```

### 9.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ ä¸€è‡´æ€§ä¿è¯çš„æ ¸å¿ƒæœºåˆ¶**
```
å¯¼å‡ºé˜¶æ®µï¼š
â€¢ ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡éš”ç¦»çº§åˆ«åˆ›å»ºä¸€è‡´æ€§å¿«ç…§
â€¢ åœ¨åŒä¸€äº‹åŠ¡ä¸­å¯¼å‡ºæ‰€æœ‰ç›¸å…³è¡¨
â€¢ è®°å½•å¿«ç…§æ—¶é—´ç‚¹ï¼Œä¾¿äºåç»­éªŒè¯

å¯¼å…¥é˜¶æ®µï¼š
â€¢ è®¾è®¡åˆé€‚çš„äº‹åŠ¡è¾¹ç•Œï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
â€¢ ä½¿ç”¨æ‰¹æ¬¡å¤„ç†ï¼Œæ§åˆ¶äº‹åŠ¡å¤§å°
â€¢ è®¾ç½®æ£€æŸ¥ç‚¹ï¼Œæ”¯æŒä¸­æ–­æ¢å¤

éªŒè¯é˜¶æ®µï¼š
â€¢ å¤šå±‚æ¬¡éªŒè¯ï¼šæ ¼å¼â†’å…³è”â†’ä¸šåŠ¡é€»è¾‘
â€¢ å®æ—¶éªŒè¯vså»¶è¿ŸéªŒè¯çš„é€‰æ‹©
â€¢ è‡ªåŠ¨åŒ–éªŒè¯å·¥å…·ï¼Œæé«˜æ•ˆç‡
```

**ğŸ”¹ å®è·µä¸­çš„å…³é”®å†³ç­–**
```
æ‰¹æ¬¡å¤§å°é€‰æ‹©ï¼š
â€¢ å°æ‰¹æ¬¡ï¼šå¤±è´¥å½±å“å°ï¼Œä½†æ€§èƒ½è¾ƒå·®
â€¢ å¤§æ‰¹æ¬¡ï¼šæ€§èƒ½å¥½ï¼Œä½†å¤±è´¥åæ¢å¤å¤æ‚
â€¢ æ¨èï¼š1000-5000æ¡è®°å½•ä¸€ä¸ªæ‰¹æ¬¡

æ£€æŸ¥ç‚¹è®¾ç½®ï¼š
â€¢ é€»è¾‘è¾¹ç•Œï¼šæ¯å®Œæˆä¸€ä¸ªé‡è¦é˜¶æ®µè®¾ç½®æ£€æŸ¥ç‚¹
â€¢ æ—¶é—´è¾¹ç•Œï¼šæ¯5-10åˆ†é’Ÿè®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹
â€¢ æ•°é‡è¾¹ç•Œï¼šæ¯å¤„ç†10ä¸‡æ¡è®°å½•è®¾ç½®æ£€æŸ¥ç‚¹

æ¢å¤ç­–ç•¥ï¼š
â€¢ è½»å¾®é”™è¯¯ï¼šä¿®å¤é‡è¯•ï¼Œä¿æŒå¢é‡æ¢å¤
â€¢ ä¸¥é‡é”™è¯¯ï¼šå®Œå…¨å›æ»šï¼Œé‡æ–°è®¾è®¡æ–¹æ¡ˆ
â€¢ ç³»ç»Ÿæ•…éšœï¼šä»æœ€è¿‘æ£€æŸ¥ç‚¹ç»§ç»­æ‰§è¡Œ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åº”ç”¨åœºæ™¯**
- **æ•°æ®è¿ç§»**ï¼šç³»ç»Ÿå‡çº§æ—¶çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **æ•°æ®åŒæ­¥**ï¼šå¤šç³»ç»Ÿé—´çš„æ•°æ®åŒæ­¥ä¸€è‡´æ€§
- **å¤‡ä»½æ¢å¤**ï¼šç¡®ä¿å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§å’Œå¯ç”¨æ€§
- **ETLæµç¨‹**ï¼šæ•°æ®ä»“åº“ETLè¿‡ç¨‹çš„äº‹åŠ¡ç®¡ç†

**ğŸ¯ å…³é”®æˆåŠŸå› ç´ **
- **æå‰è§„åˆ’**ï¼šè®¾è®¡å®Œæ•´çš„äº‹åŠ¡ç­–ç•¥å’Œæ¢å¤æœºåˆ¶
- **å……åˆ†æµ‹è¯•**ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒå‰éªŒè¯å„ç§å¤±è´¥åœºæ™¯
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§å¯¼å…¥çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•æ“ä½œæ­¥éª¤ï¼Œä¾¿äºæ•…éšœæ¢å¤

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ§  ä¸€è‡´æ€§ä¿è¯è¦ç‚¹ï¼š
"å¿«ç…§å¯¼å‡ºä¿ä¸€è‡´ï¼Œåˆ†æ‰¹å¯¼å…¥æ§è¾¹ç•Œ
æ£€æŸ¥ç‚¹è®¾ä¾¿æ¢å¤ï¼ŒéªŒè¯æœºåˆ¶è¦åˆ°ä½
å¤±è´¥å›æ»šæœ‰ç­–ç•¥ï¼Œä¿®å¤éªŒè¯ä¸å¯å°‘"
```

### 9.4 é¿å…å¸¸è§é™·é˜±


**âš ï¸ å¸¸è§è¯¯åŒºä¸è§£å†³**
```
âŒ è¯¯åŒº1ï¼šè®¤ä¸ºæ•°æ®åº“ä¼šè‡ªåŠ¨ä¿è¯ä¸€è‡´æ€§
âœ… æ­£ç¡®ï¼šéœ€è¦åœ¨åº”ç”¨å±‚è®¾è®¡å®Œæ•´çš„äº‹åŠ¡ç­–ç•¥

âŒ è¯¯åŒº2ï¼šæ‰€æœ‰æ•°æ®ç”¨ä¸€ä¸ªå¤§äº‹åŠ¡å¯¼å…¥
âœ… æ­£ç¡®ï¼šåˆç†è®¾è®¡æ‰¹æ¬¡å¤§å°ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§

âŒ è¯¯åŒº3ï¼šå¯¼å…¥å¤±è´¥å°±ç›´æ¥é‡æ¥
âœ… æ­£ç¡®ï¼šåˆ†æå¤±è´¥åŸå› ï¼Œé‡‡ç”¨å¢é‡æ¢å¤ç­–ç•¥

âŒ è¯¯åŒº4ï¼šåªéªŒè¯æ•°æ®æ ¼å¼ï¼Œå¿½ç•¥ä¸šåŠ¡é€»è¾‘
âœ… æ­£ç¡®ï¼šå¤šå±‚æ¬¡éªŒè¯ï¼Œç¡®ä¿æ•°æ®çš„ä¸šåŠ¡åˆç†æ€§
```

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®**
- **è®¾è®¡é˜¶æ®µ**ï¼šæå‰è§„åˆ’äº‹åŠ¡è¾¹ç•Œå’Œæ¢å¤ç­–ç•¥
- **å®ç°é˜¶æ®µ**ï¼šå……åˆ†çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€è®°å½•
- **æµ‹è¯•é˜¶æ®µ**ï¼šæ¨¡æ‹Ÿå„ç§å¤±è´¥åœºæ™¯ï¼ŒéªŒè¯æ¢å¤æœºåˆ¶
- **ç”Ÿäº§é˜¶æ®µ**ï¼šå¯†åˆ‡ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜