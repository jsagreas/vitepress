---
title: 16ã€DMLè¯­å¥å®‰å…¨é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [DMLå®‰å…¨å¨èƒæ¦‚è¿°](#1-DMLå®‰å…¨å¨èƒæ¦‚è¿°)
2. [SQLæ³¨å…¥æ”»å‡»ä¸é˜²æŠ¤](#2-SQLæ³¨å…¥æ”»å‡»ä¸é˜²æŠ¤)
3. [é¢„å¤„ç†è¯­å¥é˜²æŠ¤æœºåˆ¶](#3-é¢„å¤„ç†è¯­å¥é˜²æŠ¤æœºåˆ¶)
4. [è¾“å…¥éªŒè¯ä¸è¿‡æ»¤](#4-è¾“å…¥éªŒè¯ä¸è¿‡æ»¤)
5. [MySQLå®‰å…¨é…ç½®](#5-MySQLå®‰å…¨é…ç½®)
6. [æƒé™ç®¡ç†ä¸å®¡è®¡](#6-æƒé™ç®¡ç†ä¸å®¡è®¡)
7. [æ•°æ®è„±æ•å¤„ç†](#7-æ•°æ®è„±æ•å¤„ç†)
8. [å®‰å…¨ç¼–ç è§„èŒƒ](#8-å®‰å…¨ç¼–ç è§„èŒƒ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” DMLå®‰å…¨å¨èƒæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯DMLå®‰å…¨å¨èƒ


**DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰**åŒ…å«INSERTã€UPDATEã€DELETEã€SELECTç­‰æ“ä½œï¼Œè¿™äº›æ“ä½œç›´æ¥æ¥è§¦æ•°æ®ï¼Œå°±åƒé“¶è¡Œçš„å–æ¬¾æœºä¸€æ ·ï¼Œå¦‚æœä¸åŠ é˜²æŠ¤ï¼Œå°±å¯èƒ½è¢«æ¶æ„åˆ©ç”¨ã€‚

**å¸¸è§å®‰å…¨å¨èƒç±»å‹**

```
ğŸ”¸ SQLæ³¨å…¥æ”»å‡»
â”œâ”€â”€ é€šè¿‡æ¶æ„è¾“å…¥æ‰§è¡Œéé¢„æœŸçš„SQLå‘½ä»¤
â”œâ”€â”€ å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€ç¯¡æ”¹æˆ–åˆ é™¤
â””â”€â”€ æ˜¯æœ€å¸¸è§ä¹Ÿæœ€å±é™©çš„æ”»å‡»æ–¹å¼

ğŸ”¸ æƒé™æ»¥ç”¨
â”œâ”€â”€ ç”¨æˆ·æ‰§è¡Œè¶…å‡ºæƒé™èŒƒå›´çš„æ“ä½œ
â”œâ”€â”€ å†…éƒ¨äººå‘˜æ¶æ„æ“ä½œé£é™©
â””â”€â”€ æƒé™é…ç½®ä¸å½“å¯¼è‡´çš„å®‰å…¨æ¼æ´

ğŸ”¸ æ•°æ®æ³„éœ²
â”œâ”€â”€ æ•æ„Ÿæ•°æ®è¢«éæˆæƒè®¿é—®
â”œâ”€â”€ ä¸ªäººéšç§ä¿¡æ¯æš´éœ²
â””â”€â”€ å•†ä¸šæœºå¯†æ•°æ®å¤–æµ

ğŸ”¸ è¯¯æ“ä½œé£é™©
â”œâ”€â”€ æ„å¤–åˆ é™¤æˆ–ä¿®æ”¹é‡è¦æ•°æ®
â”œâ”€â”€ æ‰¹é‡æ“ä½œå½±å“èŒƒå›´è¿‡å¤§
â””â”€â”€ ç¼ºä¹æœ‰æ•ˆçš„æ“ä½œå®¡è®¡
```

### 1.2 DMLå®‰å…¨é˜²æŠ¤ä½“ç³»æ¶æ„


```
åº”ç”¨å±‚é˜²æŠ¤                æ•°æ®åº“å±‚é˜²æŠ¤               ç³»ç»Ÿå±‚é˜²æŠ¤
     |                        |                        |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥éªŒè¯    â”‚         â”‚ SQLæ¨¡å¼é…ç½®  â”‚         â”‚ ç½‘ç»œéš”ç¦»    â”‚
â”‚ å‚æ•°åŒ–æŸ¥è¯¢  â”‚    â†’    â”‚ ç”¨æˆ·æƒé™ç®¡ç†  â”‚    â†’    â”‚ è®¿é—®æ§åˆ¶    â”‚
â”‚ é”™è¯¯å¤„ç†    â”‚         â”‚ æ“ä½œå®¡è®¡    â”‚         â”‚ ç›‘æ§å‘Šè­¦    â”‚
â”‚ ä»£ç å®¡è®¡    â”‚         â”‚ è¿æ¥é™åˆ¶    â”‚         â”‚ æ—¥å¿—åˆ†æ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ’‰ SQLæ³¨å…¥æ”»å‡»ä¸é˜²æŠ¤


### 2.1 SQLæ³¨å…¥æ”»å‡»åŸç†


SQLæ³¨å…¥å°±åƒåœ¨æ­£å¸¸å¯¹è¯ä¸­å¤¹å¸¦"æš—å·"ï¼Œè®©ç³»ç»Ÿæ‰§è¡Œæ¶æ„æ“ä½œã€‚æ”»å‡»è€…é€šè¿‡åœ¨è¾“å…¥ä¸­æ’å…¥SQLä»£ç ï¼Œæ¬ºéª—æ•°æ®åº“æ‰§è¡Œéé¢„æœŸçš„å‘½ä»¤ã€‚

**å…¸å‹SQLæ³¨å…¥åœºæ™¯**

```sql
-- æ­£å¸¸çš„ç™»å½•æŸ¥è¯¢
SELECT * FROM users WHERE username = 'admin' AND password = 'password123';

-- æ¶æ„æ³¨å…¥æ”»å‡»
-- ç”¨æˆ·è¾“å…¥ï¼šadmin' OR '1'='1' --
SELECT * FROM users WHERE username = 'admin' OR '1'='1' --' AND password = '';
-- ç»“æœï¼šç»•è¿‡å¯†ç éªŒè¯ï¼Œè¿”å›æ‰€æœ‰ç”¨æˆ·æ•°æ®
```

### 2.2 SQLæ³¨å…¥æ”»å‡»ç±»å‹è¯¦è§£


**ğŸ”¸ è”åˆæ³¨å…¥ï¼ˆUnion-basedï¼‰**

```sql
-- æ”»å‡»è€…è¾“å…¥ï¼š' UNION SELECT username,password FROM admin_users --
SELECT * FROM products WHERE id = '' UNION SELECT username,password FROM admin_users --';
-- ç»“æœï¼šæ³„éœ²ç®¡ç†å‘˜è´¦æˆ·ä¿¡æ¯
```

**ğŸ”¸ å¸ƒå°”ç›²æ³¨ï¼ˆBoolean-based Blindï¼‰**

```sql
-- æ”»å‡»è€…é€šè¿‡çœŸå‡åˆ¤æ–­é€æ­¥è·å–ä¿¡æ¯
SELECT * FROM users WHERE id = '1' AND (SELECT SUBSTRING(password,1,1) FROM admin WHERE id=1)='a';
-- é€šè¿‡é¡µé¢å“åº”å·®å¼‚åˆ¤æ–­å¯†ç ç¬¬ä¸€ä½æ˜¯å¦ä¸º'a'
```

**ğŸ”¸ æ—¶é—´ç›²æ³¨ï¼ˆTime-based Blindï¼‰**

```sql
-- åˆ©ç”¨å»¶æ—¶å‡½æ•°è·å–ä¿¡æ¯
SELECT * FROM users WHERE id = '1' AND IF(
    (SELECT SUBSTRING(password,1,1) FROM admin WHERE id=1)='a',
    SLEEP(5), 
    0
);
-- å¦‚æœå¯†ç ç¬¬ä¸€ä½æ˜¯'a'ï¼Œé¡µé¢ä¼šå»¶è¿Ÿ5ç§’å“åº”
```

### 2.3 SQLæ³¨å…¥é˜²æŠ¤æ ¸å¿ƒç­–ç•¥


**é˜²æŠ¤ç­–ç•¥ä¼˜å…ˆçº§**

| ä¼˜å…ˆçº§ | **é˜²æŠ¤æ–¹æ³•** | **é˜²æŠ¤æ•ˆæœ** | **å®ç°éš¾åº¦** | **æ¨èç¨‹åº¦** |
|-------|-------------|-------------|-------------|-------------|
| ğŸ”´ **P0** | `é¢„å¤„ç†è¯­å¥` | `ğŸŸ¢å®Œå…¨é˜²æŠ¤` | `ğŸŸ¢ç®€å•` | `âœ…å¼ºçƒˆæ¨è` |
| ğŸŸ¡ **P1** | `è¾“å…¥éªŒè¯è¿‡æ»¤` | `ğŸŸ¡éƒ¨åˆ†é˜²æŠ¤` | `ğŸŸ¡ä¸­ç­‰` | `âœ…é…åˆä½¿ç”¨` |
| ğŸŸ¢ **P2** | `æƒé™æœ€å°åŒ–` | `ğŸŸ¢é™ä½å½±å“` | `ğŸŸ¡ä¸­ç­‰` | `âœ…å¿…é¡»é…ç½®` |
| ğŸ”µ **P3** | `WAFé˜²ç«å¢™` | `ğŸŸ¡æ£€æµ‹æ‹¦æˆª` | `ğŸŸ¢ç®€å•` | `âœ…è¾…åŠ©æ‰‹æ®µ` |

---

## 3. ğŸ”’ é¢„å¤„ç†è¯­å¥é˜²æŠ¤æœºåˆ¶


### 3.1 ğŸ”¥ PREPAREé¢„å¤„ç†è¯­å¥


**PREPAREè¯­å¥**æ˜¯é˜²æ­¢SQLæ³¨å…¥æœ€æœ‰æ•ˆçš„æ–¹æ³•ï¼Œå®ƒå°†SQLç»“æ„å’Œæ•°æ®å®Œå…¨åˆ†ç¦»ï¼Œå°±åƒç»™æ¯ä¸ªæ•°æ®éƒ½æˆ´ä¸Š"èº«ä»½è¯"ï¼Œç³»ç»Ÿèƒ½æ¸…æ¥šè¯†åˆ«å“ªäº›æ˜¯å‘½ä»¤ï¼Œå“ªäº›æ˜¯æ•°æ®ã€‚

**é¢„å¤„ç†è¯­å¥å·¥ä½œåŸç†**

```
ä¼ ç»ŸSQLæ‰§è¡Œæµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥ â†’ æ‹¼æ¥SQL â†’ è§£ææ‰§è¡Œ â†’ è¿”å›ç»“æœ
         â†‘ æ³¨å…¥ç‚¹åœ¨è¿™é‡Œï¼

é¢„å¤„ç†è¯­å¥æµç¨‹ï¼š  
SQLæ¨¡æ¿ â†’ é¢„ç¼–è¯‘ â†’ ç»‘å®šå‚æ•° â†’ æ‰§è¡Œ â†’ è¿”å›ç»“æœ
                    â†‘ å‚æ•°ä¸ä¼šè¢«è§£æä¸ºSQLä»£ç 
```

**PREPAREè¯­å¥åŸºç¡€è¯­æ³•**

```sql
-- ğŸ”¸ å‡†å¤‡é¢„å¤„ç†è¯­å¥
PREPARE stmt_name FROM 'SQLæ¨¡æ¿';

-- ğŸ”¸ è®¾ç½®å‚æ•°å˜é‡
SET @param1 = 'value1';
SET @param2 = 'value2';

-- ğŸ”¸ æ‰§è¡Œé¢„å¤„ç†è¯­å¥
EXECUTE stmt_name USING @param1, @param2;

-- ğŸ”¸ é‡Šæ”¾é¢„å¤„ç†è¯­å¥
DEALLOCATE PREPARE stmt_name;
```

**å®æˆ˜åº”ç”¨ç¤ºä¾‹**

```sql
-- âœ… å®‰å…¨çš„ç”¨æˆ·æŸ¥è¯¢
PREPARE user_query FROM 'SELECT * FROM users WHERE username = ? AND status = ?';
SET @username = 'admin';
SET @status = 1;
EXECUTE user_query USING @username, @status;
DEALLOCATE PREPARE user_query;

-- âœ… å®‰å…¨çš„æ•°æ®æ’å…¥
PREPARE insert_user FROM 'INSERT INTO users (username, email, created_time) VALUES (?, ?, NOW())';
SET @new_username = 'newuser';
SET @new_email = 'user@example.com';
EXECUTE insert_user USING @new_username, @new_email;
DEALLOCATE PREPARE insert_user;

-- âœ… å®‰å…¨çš„æ•°æ®æ›´æ–°
PREPARE update_user FROM 'UPDATE users SET email = ?, last_login = NOW() WHERE user_id = ?';
SET @email = 'newemail@example.com';
SET @user_id = 123;
EXECUTE update_user USING @email, @user_id;
DEALLOCATE PREPARE update_user;
```

### 3.2 ç¼–ç¨‹è¯­è¨€ä¸­çš„é¢„å¤„ç†å®ç°


**Java JDBCé¢„å¤„ç†ç¤ºä¾‹**

```java
// âœ… å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
public User getUserByCredentials(String username, String password) {
    String sql = "SELECT * FROM users WHERE username = ? AND password = SHA2(?, 256)";
    
    try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
        pstmt.setString(1, username);  // å‚æ•°1ï¼šç”¨æˆ·å
        pstmt.setString(2, password);  // å‚æ•°2ï¼šå¯†ç 
        
        ResultSet rs = pstmt.executeQuery();
        if (rs.next()) {
            return new User(rs.getString("username"), rs.getString("email"));
        }
    }
    return null;
}

// âŒ å±é™©çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆæ°¸è¿œä¸è¦è¿™æ ·åšï¼‰
public User dangerousLogin(String username, String password) {
    String sql = "SELECT * FROM users WHERE username = '" + username + 
                "' AND password = '" + password + "'";
    // è¿™ç§æ–¹å¼å®¹æ˜“å—åˆ°SQLæ³¨å…¥æ”»å‡»ï¼
}
```

**Python MySQLé¢„å¤„ç†ç¤ºä¾‹**

```python
import mysql.connector

# âœ… å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢
def get_user_orders(user_id, status):
    cursor = connection.cursor(prepared=True)  # å¯ç”¨é¢„å¤„ç†
    
    query = """
        SELECT order_id, product_name, quantity, order_date 
        FROM orders 
        WHERE user_id = ? AND status = ?
        ORDER BY order_date DESC
    """
    
    cursor.execute(query, (user_id, status))
    results = cursor.fetchall()
    cursor.close()
    
    return results

# âœ… å®‰å…¨çš„æ‰¹é‡æ’å…¥
def batch_insert_products(products):
    cursor = connection.cursor(prepared=True)
    
    insert_query = """
        INSERT INTO products (name, price, category_id) 
        VALUES (?, ?, ?)
    """
    
    cursor.executemany(insert_query, products)
    connection.commit()
    cursor.close()
```

### 3.3 é¢„å¤„ç†è¯­å¥é«˜çº§æŠ€å·§


**åŠ¨æ€SQLæ¨¡æ¿æ„å»º**

```sql
-- ğŸ”§ åŠ¨æ€WHEREæ¡ä»¶æ„å»º
-- åº”ç”¨åœºæ™¯ï¼šæ ¹æ®ç”¨æˆ·é€‰æ‹©çš„ç­›é€‰æ¡ä»¶åŠ¨æ€æ„å»ºæŸ¥è¯¢

-- åŸºç¡€æ¨¡æ¿
SET @base_sql = 'SELECT * FROM products WHERE 1=1';
SET @conditions = '';
SET @params = '';

-- æ ¹æ®æ¡ä»¶åŠ¨æ€æ·»åŠ 
-- å¦‚æœæœ‰åˆ†ç±»ç­›é€‰
SET @conditions = CONCAT(@conditions, ' AND category_id = ?');

-- å¦‚æœæœ‰ä»·æ ¼èŒƒå›´ç­›é€‰  
SET @conditions = CONCAT(@conditions, ' AND price BETWEEN ? AND ?');

-- å¦‚æœæœ‰åº“å­˜ç­›é€‰
SET @conditions = CONCAT(@conditions, ' AND stock > ?');

-- æ„å»ºæœ€ç»ˆSQL
SET @final_sql = CONCAT(@base_sql, @conditions, ' ORDER BY created_time DESC LIMIT ?');

-- å‡†å¤‡å¹¶æ‰§è¡Œ
SET @p1 = 1;    -- category_id
SET @p2 = 100;  -- min_price  
SET @p3 = 1000; -- max_price
SET @p4 = 0;    -- min_stock
SET @p5 = 20;   -- limit

PREPARE dynamic_query FROM @final_sql;
EXECUTE dynamic_query USING @p1, @p2, @p3, @p4, @p5;
DEALLOCATE PREPARE dynamic_query;
```

---

## 4. ğŸ›¡ï¸ è¾“å…¥éªŒè¯ä¸è¿‡æ»¤


### 4.1 è¾“å…¥éªŒè¯é˜²æŠ¤ç­–ç•¥


è¾“å…¥éªŒè¯å°±åƒå®‰æ£€ä¸€æ ·ï¼Œåœ¨æ•°æ®è¿›å…¥ç³»ç»Ÿå‰è¿›è¡Œä¸¥æ ¼æ£€æŸ¥ã€‚æœ‰æ•ˆçš„è¾“å…¥éªŒè¯èƒ½åœ¨SQLåˆ°è¾¾æ•°æ®åº“å‰å°±æ‹¦æˆªå¤§éƒ¨åˆ†æ”»å‡»ã€‚

**ğŸ”¸ è¾“å…¥éªŒè¯å±‚æ¬¡ç»“æ„**

```
å‰ç«¯éªŒè¯ (å®¢æˆ·ç«¯)
â”œâ”€â”€ JavaScriptè¡¨å•éªŒè¯
â”œâ”€â”€ HTML5è¾“å…¥çº¦æŸ
â””â”€â”€ âš ï¸ æ³¨æ„ï¼šä»…ç”¨äºç”¨æˆ·ä½“éªŒï¼Œä¸èƒ½ä½œä¸ºå®‰å…¨ä¾èµ–

åç«¯éªŒè¯ (æœåŠ¡ç«¯) âœ… æ ¸å¿ƒå®‰å…¨é˜²çº¿
â”œâ”€â”€ æ•°æ®ç±»å‹éªŒè¯
â”œâ”€â”€ é•¿åº¦èŒƒå›´æ£€æŸ¥  
â”œâ”€â”€ æ ¼å¼æ¨¡å¼åŒ¹é…
â”œâ”€â”€ ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤
â””â”€â”€ ä¸šåŠ¡é€»è¾‘éªŒè¯

æ•°æ®åº“éªŒè¯ (æœ€åé˜²çº¿)
â”œâ”€â”€ å­—æ®µçº¦æŸæ£€æŸ¥
â”œâ”€â”€ è§¦å‘å™¨éªŒè¯
â””â”€â”€ å­˜å‚¨è¿‡ç¨‹éªŒè¯
```

### 4.2 è¾“å…¥éªŒè¯å®ç°æ–¹æ³•


**æ•°æ®ç±»å‹ä¸¥æ ¼éªŒè¯**

```java
// âœ… ä¸¥æ ¼çš„æ•°æ®ç±»å‹éªŒè¯
public class InputValidator {
    
    // æ•´æ•°éªŒè¯
    public static boolean isValidInteger(String input, int min, int max) {
        try {
            int value = Integer.parseInt(input.trim());
            return value >= min && value <= max;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    // é‚®ç®±æ ¼å¼éªŒè¯
    private static final Pattern EMAIL_PATTERN = 
        Pattern.compile("^[A-Za-z0-9+_.-]+@([A-Za-z0-9.-]+\\.[A-Za-z]{2,})$");
    
    public static boolean isValidEmail(String email) {
        return email != null && EMAIL_PATTERN.matcher(email).matches();
    }
    
    // ç”¨æˆ·åéªŒè¯ï¼ˆåªå…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰
    private static final Pattern USERNAME_PATTERN = 
        Pattern.compile("^[a-zA-Z0-9_]{3,20}$");
    
    public static boolean isValidUsername(String username) {
        return username != null && USERNAME_PATTERN.matcher(username).matches();
    }
    
    // SQLå…³é”®å­—é»‘åå•æ£€æŸ¥
    private static final Set<String> SQL_KEYWORDS = Set.of(
        "SELECT", "INSERT", "UPDATE", "DELETE", "DROP", "CREATE", 
        "ALTER", "UNION", "SCRIPT", "EXEC", "EXECUTE"
    );
    
    public static boolean containsSQLKeywords(String input) {
        String upperInput = input.toUpperCase();
        return SQL_KEYWORDS.stream().anyMatch(upperInput::contains);
    }
}
```

**ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤ä¸è½¬ä¹‰**

```java
// âœ… å±é™©å­—ç¬¦è¿‡æ»¤
public class SecurityFilter {
    
    // HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
    public static String escapeHtml(String input) {
        if (input == null) return null;
        
        return input.replace("&", "&amp;")
                   .replace("<", "&lt;")
                   .replace(">", "&gt;")
                   .replace("\"", "&quot;")
                   .replace("'", "&#x27;")
                   .replace("/", "&#x2F;");
    }
    
    // SQLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
    public static String escapeSql(String input) {
        if (input == null) return null;
        
        // æ³¨æ„ï¼šè¿™åªæ˜¯è¾…åŠ©æ‰‹æ®µï¼Œä¸»è¦è¿˜æ˜¯ä¾é é¢„å¤„ç†è¯­å¥
        return input.replace("'", "''")
                   .replace("\\", "\\\\")
                   .replace("\0", "\\0")
                   .replace("\n", "\\n")
                   .replace("\r", "\\r")
                   .replace("\"", "\\\"")
                   .replace("\032", "\\Z");
    }
    
    // ç§»é™¤å±é™©å­—ç¬¦
    public static String removeDangerousChars(String input) {
        if (input == null) return null;
        
        // ç§»é™¤å¯èƒ½ç”¨äºæ³¨å…¥çš„å­—ç¬¦
        return input.replaceAll("[';\"\\-\\-/\\*\\*/]", "");
    }
}
```

### 4.3 ä¸šåŠ¡é€»è¾‘éªŒè¯


```java
// âœ… ä¸šåŠ¡è§„åˆ™éªŒè¯ç¤ºä¾‹
public class BusinessValidator {
    
    // è®¢å•é‡‘é¢åˆç†æ€§éªŒè¯
    public static ValidationResult validateOrderAmount(BigDecimal amount) {
        if (amount == null) {
            return ValidationResult.error("è®¢å•é‡‘é¢ä¸èƒ½ä¸ºç©º");
        }
        
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            return ValidationResult.error("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        if (amount.compareTo(new BigDecimal("100000")) > 0) {
            return ValidationResult.error("å•ç¬”è®¢å•é‡‘é¢ä¸èƒ½è¶…è¿‡10ä¸‡å…ƒ");
        }
        
        return ValidationResult.success();
    }
    
    // ç”¨æˆ·æƒé™éªŒè¯
    public static boolean canUserAccessResource(User user, String resourceId) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®ç‰¹å®šèµ„æº
        if (user == null || !user.isActive()) {
            return false;
        }
        
        // ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰èµ„æº
        if (user.hasRole("ADMIN")) {
            return true;
        }
        
        // æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº
        return user.getOwnedResources().contains(resourceId);
    }
}
```

---

## 5. ğŸ”§ MySQLå®‰å…¨é…ç½®


### 5.1 ğŸ”¥ sql_modeå®‰å…¨æ¨¡å¼


**sql_mode**æ§åˆ¶MySQLçš„SQLè¯­æ³•ä¸¥æ ¼ç¨‹åº¦å’Œè¡Œä¸ºæ¨¡å¼ï¼Œåˆé€‚çš„é…ç½®èƒ½é˜²æ­¢å¾ˆå¤šæ½œåœ¨çš„å®‰å…¨é—®é¢˜ã€‚

**sql_modeå®‰å…¨é…ç½®è¯¦è§£**

```sql
-- æŸ¥çœ‹å½“å‰sql_modeè®¾ç½®
SELECT $$sql_mode;

-- ğŸ”¥ æ¨èçš„å®‰å…¨sql_modeé…ç½®
SET sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE';

-- æ°¸ä¹…é…ç½®ï¼ˆåœ¨my.cnfä¸­æ·»åŠ ï¼‰
[mysqld]
sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,NO_ZERO_DATE,NO_ZERO_IN_DATE'
```

**å„ä¸ªsql_modeå‚æ•°å®‰å…¨æ„ä¹‰**

| æ¨¡å¼å‚æ•° | **å®‰å…¨ä½œç”¨** | **é˜²æŠ¤æ•ˆæœ** |
|---------|-------------|-------------|
| `STRICT_TRANS_TABLES` | `ä¸¥æ ¼æ¨¡å¼ï¼Œæ•°æ®éªŒè¯å¤±è´¥æ—¶æŠ¥é”™` | `ğŸŸ¢é˜²æ­¢é”™è¯¯æ•°æ®æ’å…¥` |
| `ERROR_FOR_DIVISION_BY_ZERO` | `é™¤é›¶æ“ä½œæŠ¥é”™è€Œä¸æ˜¯è¿”å›NULL` | `ğŸŸ¢é¿å…é€»è¾‘é”™è¯¯` |
| `NO_AUTO_CREATE_USER` | `ç¦æ­¢GRANTè‡ªåŠ¨åˆ›å»ºç”¨æˆ·` | `ğŸŸ¢é˜²æ­¢æ„å¤–ç”¨æˆ·åˆ›å»º` |
| `NO_ENGINE_SUBSTITUTION` | `ä¸å¯ç”¨å¼•æ“æ—¶æŠ¥é”™` | `ğŸŸ¢ç¡®ä¿è¡¨å¼•æ“ä¸€è‡´æ€§` |
| `NO_ZERO_DATE` | `ç¦æ­¢'0000-00-00'æ—¥æœŸ` | `ğŸŸ¢æ•°æ®å®Œæ•´æ€§ä¿è¯` |
| `NO_ZERO_IN_DATE` | `ç¦æ­¢æ—¥æœŸä¸­åŒ…å«0` | `ğŸŸ¢æ—¥æœŸæ•°æ®æœ‰æ•ˆæ€§` |

### 5.2 ğŸ”¥ sql_safe_updatesé…ç½®


**sql_safe_updates**æ˜¯ä¸€ä¸ªé‡è¦çš„å®‰å…¨å¼€å…³ï¼Œèƒ½é˜²æ­¢å±é™©çš„UPDATEå’ŒDELETEæ“ä½œã€‚

```sql
-- ğŸ”¥ å¯ç”¨å®‰å…¨æ›´æ–°æ¨¡å¼
SET sql_safe_updates = 1;

-- æ°¸ä¹…é…ç½®
[mysqld]
sql_safe_updates = 1

-- æˆ–è€…ä¸ºç‰¹å®šç”¨æˆ·å¯ç”¨
[mysql]
safe-updates = 1
```

**å®‰å…¨æ›´æ–°æ¨¡å¼é™åˆ¶è§„åˆ™**

```sql
-- âŒ è¢«ç¦æ­¢çš„å±é™©æ“ä½œ
UPDATE users SET status = 0;                    -- æ²¡æœ‰WHEREå­å¥
DELETE FROM logs;                               -- æ²¡æœ‰WHEREå­å¥
UPDATE users SET status = 0 WHERE name LIKE '%admin%';  -- WHEREä¸­æ²¡æœ‰ç´¢å¼•åˆ—

-- âœ… å…è®¸çš„å®‰å…¨æ“ä½œ  
UPDATE users SET status = 0 WHERE user_id = 123;        -- ä½¿ç”¨ä¸»é”®
UPDATE users SET status = 0 WHERE user_id IN (1,2,3);   -- ä½¿ç”¨ä¸»é”®åˆ—è¡¨
DELETE FROM logs WHERE created_time < '2024-01-01';     -- ä½¿ç”¨ç´¢å¼•åˆ—
UPDATE users SET status = 0 WHERE user_id = 123 LIMIT 1; -- ä½¿ç”¨LIMIT
```

### 5.3 ğŸ”¥ è¿æ¥æ•°é™åˆ¶max_user_connections


**è¿æ¥æ•°é™åˆ¶**èƒ½é˜²æ­¢å•ä¸ªç”¨æˆ·å ç”¨è¿‡å¤šè¿æ¥èµ„æºï¼Œä¹Ÿèƒ½ç¼“è§£æŸäº›ç±»å‹çš„æ”»å‡»ã€‚

```sql
-- ğŸ”¥ å…¨å±€è¿æ¥æ•°é…ç½®
SET GLOBAL max_connections = 1000;              -- æœ€å¤§æ€»è¿æ¥æ•°
SET GLOBAL max_user_connections = 50;           -- å•ç”¨æˆ·æœ€å¤§è¿æ¥æ•°
SET GLOBAL max_connect_errors = 100;            -- æœ€å¤§è¿æ¥é”™è¯¯æ•°

-- ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®è¿æ¥é™åˆ¶
CREATE USER 'webapp'@'%' IDENTIFIED BY 'password';
ALTER USER 'webapp'@'%' WITH MAX_USER_CONNECTIONS 20;
ALTER USER 'webapp'@'%' WITH MAX_CONNECTIONS_PER_HOUR 1000;
ALTER USER 'webapp'@'%' WITH MAX_QUERIES_PER_HOUR 50000;
```

**è¿æ¥é™åˆ¶é…ç½®ç­–ç•¥**

| ç”¨æˆ·ç±»å‹ | **æœ€å¤§è¿æ¥æ•°** | **æ¯å°æ—¶è¿æ¥æ•°** | **æ¯å°æ—¶æŸ¥è¯¢æ•°** | **åº”ç”¨åœºæ™¯** |
|---------|---------------|----------------|----------------|-------------|
| ğŸ”´ **ç®¡ç†å‘˜** | `ä¸é™åˆ¶` | `ä¸é™åˆ¶` | `ä¸é™åˆ¶` | `è¿ç»´ç®¡ç†` |
| ğŸŸ¡ **åº”ç”¨ç¨‹åº** | `50-100` | `1000-2000` | `10000-50000` | `Webåº”ç”¨` |
| ğŸŸ¢ **åªè¯»ç”¨æˆ·** | `10-20` | `200-500` | `5000-10000` | `æŠ¥è¡¨æŸ¥è¯¢` |
| ğŸ”µ **ä¸´æ—¶ç”¨æˆ·** | `1-5` | `10-50` | `100-500` | `æµ‹è¯•è®¿é—®` |

---

## 6. ğŸ” æƒé™ç®¡ç†ä¸å®¡è®¡


### 6.1 æƒé™æœ€å°åŒ–åŸåˆ™


æƒé™æœ€å°åŒ–å°±åƒ"æŒ‰éœ€åˆ†é…é’¥åŒ™"ï¼Œæ¯ä¸ªç”¨æˆ·åªèƒ½æ‹¿åˆ°å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°‘æƒé™ã€‚

**æƒé™åˆ†çº§ç®¡ç†ç­–ç•¥**

```
ç®¡ç†å±‚æƒé™ (DBA)
â”œâ”€â”€ æ‰€æœ‰æ•°æ®åº“æ“ä½œæƒé™
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†æƒé™  
â”œâ”€â”€ ç³»ç»Ÿé…ç½®æƒé™
â””â”€â”€ é€‚ç”¨ï¼šæ•°æ®åº“ç®¡ç†å‘˜

åº”ç”¨å±‚æƒé™ (APP)
â”œâ”€â”€ ç‰¹å®šæ•°æ®åº“CRUDæƒé™
â”œâ”€â”€ å­˜å‚¨è¿‡ç¨‹è°ƒç”¨æƒé™
â”œâ”€â”€ ä¸åŒ…å«DDLæƒé™
â””â”€â”€ é€‚ç”¨ï¼šåº”ç”¨ç¨‹åºè¿æ¥

ä¸šåŠ¡å±‚æƒé™ (USER)  
â”œâ”€â”€ ç‰¹å®šè¡¨SELECTæƒé™
â”œâ”€â”€ éƒ¨åˆ†å­—æ®µUPDATEæƒé™
â”œâ”€â”€ æ¡ä»¶æ€§DELETEæƒé™
â””â”€â”€ é€‚ç”¨ï¼šä¸šåŠ¡ç”¨æˆ·

åªè¯»æƒé™ (READONLY)
â”œâ”€â”€ ä»…SELECTæƒé™
â”œâ”€â”€ ç‰¹å®šåº“è¡¨é™åˆ¶
â”œâ”€â”€ æ—¶é—´çª—å£é™åˆ¶
â””â”€â”€ é€‚ç”¨ï¼šæŠ¥è¡¨åˆ†æ
```

**ç²¾ç¡®æƒé™é…ç½®ç¤ºä¾‹**

```sql
-- âœ… åº”ç”¨ç¨‹åºç”¨æˆ·æƒé™é…ç½®
CREATE USER 'webapp'@'192.168.1.%' IDENTIFIED BY 'StrongP@ssw0rd';

-- åªæˆäºˆå¿…è¦çš„æ•°æ®åº“æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON ecommerce.users TO 'webapp'@'192.168.1.%';
GRANT SELECT, INSERT, UPDATE, DELETE ON ecommerce.orders TO 'webapp'@'192.168.1.%';
GRANT SELECT, INSERT, UPDATE, DELETE ON ecommerce.products TO 'webapp'@'192.168.1.%';

-- åªè¯»ç”¨æˆ·æƒé™é…ç½®
CREATE USER 'reporter'@'%' IDENTIFIED BY 'Rep0rt3rP@ss';
GRANT SELECT ON ecommerce.orders TO 'reporter'@'%';
GRANT SELECT ON ecommerce.products TO 'reporter'@'%';

-- æ•æ„Ÿè¡¨é™åˆ¶è®¿é—®ï¼ˆç”¨æˆ·è¡¨åªèƒ½æŸ¥çœ‹éæ•æ„Ÿå­—æ®µï¼‰
GRANT SELECT (user_id, username, email, created_time) ON ecommerce.users TO 'reporter'@'%';

-- å®¡è®¡ç”¨æˆ·ï¼ˆä¸“é—¨ç”¨äºæ—¥å¿—è®°å½•ï¼‰  
CREATE USER 'auditor'@'localhost' IDENTIFIED BY 'Aud1t0rP@ss';
GRANT SELECT ON mysql.general_log TO 'auditor'@'localhost';
GRANT SELECT ON mysql.slow_log TO 'auditor'@'localhost';
```

### 6.2 ğŸ”¥ å®¡è®¡æ’ä»¶é…ç½®


**MySQLå®¡è®¡æ’ä»¶**èƒ½è®°å½•æ‰€æœ‰æ•°æ®åº“æ“ä½œï¼Œä¸ºå®‰å…¨äº‹ä»¶è°ƒæŸ¥æä¾›é‡è¦è¯æ®ã€‚

**audit_logæ’ä»¶é…ç½®**

```sql
-- å®‰è£…å®¡è®¡æ’ä»¶
INSTALL PLUGIN audit_log SONAME 'audit_log.so';

-- æŸ¥çœ‹æ’ä»¶çŠ¶æ€
SELECT PLUGIN_NAME, PLUGIN_STATUS FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME = 'audit_log';

-- é…ç½®å®¡è®¡å‚æ•°
SET GLOBAL audit_log_file = '/var/log/mysql/audit.log';
SET GLOBAL audit_log_format = 'JSON';                    -- ä½¿ç”¨JSONæ ¼å¼ä¾¿äºåˆ†æ
SET GLOBAL audit_log_rotate_on_size = 104857600;         -- 100MBè½®è½¬
SET GLOBAL audit_log_rotations = 10;                     -- ä¿ç•™10ä¸ªæ–‡ä»¶
```

**å®¡è®¡ç­–ç•¥é…ç½®**

```sql
-- my.cnfä¸­çš„å®¡è®¡é…ç½®
[mysqld]
# å¯ç”¨å®¡è®¡æ’ä»¶
plugin-load-add = audit_log.so

# å®¡è®¡æ—¥å¿—é…ç½®
audit_log_file = /var/log/mysql/audit.log
audit_log_format = JSON
audit_log_strategy = SEMISYNCHRONOUS
audit_log_rotate_on_size = 104857600
audit_log_rotations = 10

# å®¡è®¡è¿‡æ»¤é…ç½®
audit_log_include_accounts = 'webapp@%,admin@localhost'
audit_log_exclude_accounts = 'mysql.session@localhost'

# å®¡è®¡äº‹ä»¶ç±»å‹
audit_log_policy = ALL                    # è®°å½•æ‰€æœ‰äº‹ä»¶
# å¯é€‰: LOGINS, QUERIES, ALL
```

**å®¡è®¡æ—¥å¿—åˆ†æç¤ºä¾‹**

```bash
# æŸ¥çœ‹å®¡è®¡æ—¥å¿—
tail -f /var/log/mysql/audit.log

# åˆ†æç‰¹å®šç”¨æˆ·çš„æ“ä½œ
grep '"account":"webapp"' /var/log/mysql/audit.log | jq '.'

# æŸ¥æ‰¾æ•æ„Ÿæ“ä½œ
grep -E "(DROP|DELETE|UPDATE)" /var/log/mysql/audit.log | jq '.sql_text'

# ç»Ÿè®¡ç”¨æˆ·æ“ä½œé¢‘ç‡
grep -o '"account":"[^"]*"' /var/log/mysql/audit.log | sort | uniq -c
```

### 6.3 æ•æ„Ÿæ“ä½œç›‘æ§


**å®æ—¶ç›‘æ§é…ç½®**

```sql
-- åˆ›å»ºæ•æ„Ÿæ“ä½œç›‘æ§è¡¨
CREATE TABLE security_events (
    event_id INT AUTO_INCREMENT PRIMARY KEY,
    event_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_account VARCHAR(100),
    client_host VARCHAR(100),
    command_type VARCHAR(50),
    sql_text TEXT,
    affected_rows INT,
    risk_level ENUM('LOW', 'MEDIUM', 'HIGH', 'CRITICAL')
);

-- åˆ›å»ºç›‘æ§è§¦å‘å™¨ï¼ˆç¤ºä¾‹ï¼šç”¨æˆ·è¡¨æ“ä½œç›‘æ§ï¼‰
DELIMITER $$

CREATE TRIGGER users_update_audit 
AFTER UPDATE ON users FOR EACH ROW
BEGIN
    INSERT INTO security_events (user_account, client_host, command_type, sql_text, affected_rows, risk_level)
    VALUES (USER(), $$hostname, 'UPDATE', 'UPDATE users SET ...', ROW_COUNT(), 
            CASE 
                WHEN OLD.status != NEW.status THEN 'HIGH'
                WHEN OLD.role != NEW.role THEN 'CRITICAL'
                ELSE 'MEDIUM'
            END);
END$$

CREATE TRIGGER users_delete_audit 
AFTER DELETE ON users FOR EACH ROW  
BEGIN
    INSERT INTO security_events (user_account, client_host, command_type, affected_rows, risk_level)
    VALUES (USER(), $$hostname, 'DELETE', 'DELETE FROM users', ROW_COUNT(), 'CRITICAL');
END$$

DELIMITER ;
```

---

## 7. ğŸ­ æ•°æ®è„±æ•å¤„ç†


### 7.1 æ•°æ®è„±æ•æ¦‚å¿µä¸å¿…è¦æ€§


**æ•°æ®è„±æ•**å°±åƒç»™æ•æ„Ÿä¿¡æ¯æ‰“"é©¬èµ›å…‹"ï¼Œä¿ç•™æ•°æ®çš„å¯ç”¨æ€§ä½†éšè—çœŸå®å†…å®¹ï¼Œç¡®ä¿æµ‹è¯•ã€å¼€å‘ã€åˆ†æåœºæ™¯ä¸‹çš„æ•°æ®å®‰å…¨ã€‚

**è„±æ•å¤„ç†é€‚ç”¨åœºæ™¯**

```
ç”Ÿäº§ç¯å¢ƒ â†’ æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ çœŸå®å®¢æˆ·ä¿¡æ¯è„±æ•
â”œâ”€â”€ é“¶è¡Œå¡å·éƒ¨åˆ†éšè—  
â”œâ”€â”€ èº«ä»½è¯å·æ¨¡ç³Šå¤„ç†
â””â”€â”€ æ‰‹æœºå·ç æ ¼å¼åŒ–

æ•°æ®åˆ†æåœºæ™¯
â”œâ”€â”€ ç”¨æˆ·è¡Œä¸ºåˆ†æï¼ˆéšè—èº«ä»½ï¼‰
â”œâ”€â”€ ä¸šåŠ¡æŠ¥è¡¨å±•ç¤ºï¼ˆèšåˆæ•°æ®ï¼‰
â”œâ”€â”€ ç¬¬ä¸‰æ–¹æ•°æ®å…±äº«
â””â”€â”€ åˆè§„æ€§è¦æ±‚æ»¡è¶³

å¼€å‘è°ƒè¯•ç¯å¢ƒ
â”œâ”€â”€ ä¿æŒæ•°æ®æ ¼å¼ä¸€è‡´
â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘éªŒè¯  
â”œâ”€â”€ æ€§èƒ½æµ‹è¯•æ•°æ®
â””â”€â”€ åŠŸèƒ½å›å½’æµ‹è¯•
```

### 7.2 æ•°æ®è„±æ•å®ç°æ–¹æ³•


**é™æ€æ•°æ®è„±æ•**

```sql
-- âœ… æ‰‹æœºå·è„±æ•ï¼ˆä¿ç•™å‰3ä½å’Œå4ä½ï¼‰
UPDATE users SET phone = CONCAT(
    LEFT(phone, 3), 
    '****', 
    RIGHT(phone, 4)
) WHERE phone IS NOT NULL;
-- 13812345678 â†’ 138****5678

-- âœ… é‚®ç®±è„±æ•ï¼ˆä¿ç•™åŸŸåï¼‰
UPDATE users SET email = CONCAT(
    LEFT(SUBSTRING_INDEX(email, '@', 1), 2),
    '***',
    '@',
    SUBSTRING_INDEX(email, '@', -1)
) WHERE email IS NOT NULL;
-- john.doe@example.com â†’ jo***@example.com

-- âœ… å§“åè„±æ•ï¼ˆå§“æ°+æ˜Ÿå·ï¼‰
UPDATE users SET real_name = CONCAT(
    LEFT(real_name, 1),
    REPEAT('*', CHAR_LENGTH(real_name) - 1)
) WHERE real_name IS NOT NULL;
-- å¼ ä¸‰ â†’ å¼ *

-- âœ… é“¶è¡Œå¡å·è„±æ•ï¼ˆåªæ˜¾ç¤ºå4ä½ï¼‰
UPDATE user_bank_cards SET card_number = CONCAT(
    REPEAT('*', CHAR_LENGTH(card_number) - 4),
    RIGHT(card_number, 4)
) WHERE card_number IS NOT NULL;
-- 6222021234567890 â†’ ************7890
```

**åŠ¨æ€æ•°æ®è„±æ•ï¼ˆæŸ¥è¯¢æ—¶è„±æ•ï¼‰**

```sql
-- åˆ›å»ºè„±æ•è§†å›¾
CREATE VIEW users_masked AS
SELECT 
    user_id,
    username,
    CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4)) AS phone_masked,
    CONCAT(LEFT(SUBSTRING_INDEX(email, '@', 1), 2), '***@', SUBSTRING_INDEX(email, '@', -1)) AS email_masked,
    CONCAT(LEFT(real_name, 1), REPEAT('*', CHAR_LENGTH(real_name) - 1)) AS name_masked,
    created_time,
    status
FROM users;

-- æˆäºˆæ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è„±æ•è§†å›¾
GRANT SELECT ON mydb.users_masked TO 'report_user'@'%';
REVOKE SELECT ON mydb.users FROM 'report_user'@'%';
```

**å‡½æ•°åŒ–è„±æ•å¤„ç†**

```sql
-- åˆ›å»ºè„±æ•å‡½æ•°
DELIMITER $$

-- æ‰‹æœºå·è„±æ•å‡½æ•°
CREATE FUNCTION mask_phone(phone VARCHAR(20)) 
RETURNS VARCHAR(20)
READS SQL DATA
DETERMINISTIC
BEGIN
    IF phone IS NULL OR LENGTH(phone) < 7 THEN
        RETURN phone;
    END IF;
    
    RETURN CONCAT(LEFT(phone, 3), REPEAT('*', LENGTH(phone) - 7), RIGHT(phone, 4));
END$$

-- èº«ä»½è¯å·è„±æ•å‡½æ•°
CREATE FUNCTION mask_id_card(id_card VARCHAR(18))
RETURNS VARCHAR(18) 
READS SQL DATA
DETERMINISTIC
BEGIN
    IF id_card IS NULL OR LENGTH(id_card) != 18 THEN
        RETURN id_card;
    END IF;
    
    RETURN CONCAT(LEFT(id_card, 6), REPEAT('*', 8), RIGHT(id_card, 4));
END$$

DELIMITER ;

-- ä½¿ç”¨è„±æ•å‡½æ•°
SELECT 
    user_id,
    mask_phone(phone) AS phone,
    mask_id_card(id_card) AS id_card
FROM users;
```

### 7.3 æ•°æ®è„±æ•æœ€ä½³å®è·µ


**åˆ†çº§è„±æ•ç­–ç•¥**

| æ•æ„Ÿçº§åˆ« | **æ•°æ®ç±»å‹** | **è„±æ•æ–¹å¼** | **ä¿ç•™ä¿¡æ¯** |
|---------|-------------|-------------|-------------|
| ğŸ”´ **ææ•æ„Ÿ** | `èº«ä»½è¯å·ã€é“¶è¡Œå¡` | `é«˜å¼ºåº¦è„±æ•` | `ä»…ä¿ç•™æ ¼å¼` |
| ğŸŸ¡ **æ•æ„Ÿ** | `æ‰‹æœºå·ã€é‚®ç®±` | `ä¸­ç­‰è„±æ•` | `ä¿ç•™éƒ¨åˆ†ç‰¹å¾` |
| ğŸŸ¢ **ä¸€èˆ¬æ•æ„Ÿ** | `å§“åã€åœ°å€` | `è½»åº¦è„±æ•` | `ä¿ç•™ä¸šåŠ¡å¯ç”¨æ€§` |
| ğŸ”µ **éæ•æ„Ÿ** | `è®¢å•å·ã€å•†å“å` | `ä¸è„±æ•` | `å®Œæ•´ä¿ç•™` |

---

## 8. ğŸ“‹ å®‰å…¨ç¼–ç è§„èŒƒ


### 8.1 SQLå®‰å…¨ç¼–ç æ ‡å‡†


**ä»£ç ç¼–å†™å®‰å…¨è¦æ±‚**

```java
// âœ… å®‰å…¨ç¼–ç è§„èŒƒç¤ºä¾‹
public class SecureDatabaseOperations {
    
    // è§„èŒƒ1ï¼šæ°¸è¿œä½¿ç”¨é¢„å¤„ç†è¯­å¥
    public List<Order> getOrdersByUser(int userId, String status) {
        String sql = "SELECT * FROM orders WHERE user_id = ? AND status = ? ORDER BY created_time DESC";
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setInt(1, userId);
            pstmt.setString(2, status);
            
            return extractOrders(pstmt.executeQuery());
        } catch (SQLException e) {
            // è§„èŒƒ2ï¼šä¸è¦åœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²SQLç»†èŠ‚
            logger.error("Failed to fetch orders for user: {}", userId);
            throw new DataAccessException("Unable to retrieve orders");
        }
    }
    
    // è§„èŒƒ3ï¼šè¾“å…¥éªŒè¯å‰ç½®
    public boolean updateUserStatus(int userId, String newStatus) {
        // è¾“å…¥éªŒè¯
        if (userId <= 0) {
            throw new IllegalArgumentException("Invalid user ID");
        }
        
        if (!isValidStatus(newStatus)) {
            throw new IllegalArgumentException("Invalid status value");
        }
        
        String sql = "UPDATE users SET status = ?, updated_time = NOW() WHERE user_id = ?";
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setString(1, newStatus);
            pstmt.setInt(2, userId);
            
            return pstmt.executeUpdate() > 0;
        } catch (SQLException e) {
            logger.error("Failed to update user status: userId={}", userId);
            return false;
        }
    }
    
    // è§„èŒƒ4ï¼šæ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–éªŒè¯
    public boolean deleteUser(int userId, String operatorId, String reason) {
        // æƒé™éªŒè¯
        if (!hasDeletePermission(operatorId)) {
            throw new SecurityException("Insufficient permissions for delete operation");
        }
        
        // è®°å½•å®¡è®¡æ—¥å¿—
        auditLogger.info("User deletion requested: userId={}, operator={}, reason={}", 
                        userId, operatorId, reason);
        
        String sql = "UPDATE users SET status = 'DELETED', deleted_by = ?, delete_reason = ?, deleted_time = NOW() WHERE user_id = ?";
        
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setString(1, operatorId);
            pstmt.setString(2, reason);
            pstmt.setInt(3, userId);
            
            boolean success = pstmt.executeUpdate() > 0;
            if (success) {
                auditLogger.info("User deleted successfully: userId={}", userId);
            }
            return success;
        } catch (SQLException e) {
            auditLogger.error("Failed to delete user: userId={}", userId);
            throw new DataAccessException("Delete operation failed");
        }
    }
}
```

### 8.2 é”™è¯¯å¤„ç†å®‰å…¨è§„èŒƒ


```java
// âœ… å®‰å…¨çš„é”™è¯¯å¤„ç†
public class SecureErrorHandling {
    
    // è§„èŒƒï¼šä¸è¦æ³„éœ²æ•æ„Ÿä¿¡æ¯
    public ApiResponse<User> getUserById(int userId) {
        try {
            User user = userService.findById(userId);
            if (user == null) {
                return ApiResponse.error("User not found");  // é€šç”¨é”™è¯¯ä¿¡æ¯
            }
            
            return ApiResponse.success(user);
            
        } catch (SQLException e) {
            // è®°å½•è¯¦ç»†é”™è¯¯ä¾›å†…éƒ¨è°ƒè¯•
            logger.error("Database error when fetching user {}: {}", userId, e.getMessage());
            
            // è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯
            return ApiResponse.error("Service temporarily unavailable");
            
        } catch (Exception e) {
            logger.error("Unexpected error: ", e);
            return ApiResponse.error("Internal server error");
        }
    }
    
    // è§„èŒƒï¼šåˆ†çº§é”™è¯¯å¤„ç†
    private void handleSecurityEvent(String eventType, String details) {
        // é«˜å±äº‹ä»¶ç«‹å³å‘Šè­¦
        if (isHighRiskEvent(eventType)) {
            securityAlertService.sendAlert(eventType, details);
        }
        
        // è®°å½•å®‰å…¨äº‹ä»¶åˆ°ä¸“ç”¨æ—¥å¿—
        securityLogger.warn("Security event: type={}, details={}", eventType, details);
        
        // å¯èƒ½éœ€è¦è‡ªåŠ¨å°ç¦
        if (shouldAutoBlock(eventType)) {
            userSecurityService.temporaryBlock(getCurrentUserId());
        }
    }
}
```

### 8.3 æ•°æ®åº“è¿æ¥å®‰å…¨ç®¡ç†


```java
// âœ… å®‰å…¨çš„è¿æ¥æ± é…ç½®
@Configuration
public class DatabaseConfig {
    
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€è¿æ¥é…ç½®
        config.setDriverClassName("com.mysql.cj.jdbc.Driver");
        config.setJdbcUrl("jdbc:mysql://localhost:3306/mydb?useSSL=true&requireSSL=true");
        config.setUsername(getEncryptedUsername());
        config.setPassword(getEncryptedPassword());
        
        // è¿æ¥æ± å®‰å…¨é…ç½®
        config.setMaximumPoolSize(20);                    // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);                         // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);               // è¿æ¥è¶…æ—¶30ç§’
        config.setIdleTimeout(300000);                    // ç©ºé—²è¶…æ—¶5åˆ†é’Ÿ
        config.setMaxLifetime(600000);                    // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ10åˆ†é’Ÿ
        config.setLeakDetectionThreshold(60000);          // è¿æ¥æ³„æ¼æ£€æµ‹1åˆ†é’Ÿ
        
        // å®‰å…¨ç›¸å…³é…ç½®
        config.addDataSourceProperty("useSSL", "true");
        config.addDataSourceProperty("requireSSL", "true");
        config.addDataSourceProperty("verifyServerCertificate", "true");
        config.addDataSourceProperty("allowPublicKeyRetrieval", "false");
        config.addDataSourceProperty("autoReconnect", "false");  // ç¦ç”¨è‡ªåŠ¨é‡è¿
        
        return new HikariDataSource(config);
    }
    
    // åŠ å¯†å‡­æ®è·å–
    private String getEncryptedUsername() {
        return configEncryptionService.decrypt(environment.getProperty("db.username"));
    }
    
    private String getEncryptedPassword() {
        return configEncryptionService.decrypt(environment.getProperty("db.password"));
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SQLæ³¨å…¥é˜²æŠ¤ï¼šé¢„å¤„ç†è¯­å¥æ˜¯æœ€æœ‰æ•ˆçš„é˜²æŠ¤æ–¹æ³•
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šå¤šå±‚éªŒè¯ï¼Œå‰ç«¯ä½“éªŒ+åç«¯å®‰å…¨+æ•°æ®åº“çº¦æŸ  
ğŸ”¸ æƒé™æœ€å°åŒ–ï¼šæ¯ä¸ªç”¨æˆ·åªè·å¾—å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°‘æƒé™
ğŸ”¸ å®‰å…¨é…ç½®ï¼šsql_modeã€sql_safe_updatesã€è¿æ¥é™åˆ¶ç­‰å…³é”®é…ç½®
ğŸ”¸ å®¡è®¡ç›‘æ§ï¼šæ“ä½œè®°å½•ã€å¼‚å¸¸å‘Šè­¦ã€äº‹ä»¶åˆ†æ
ğŸ”¸ æ•°æ®è„±æ•ï¼šä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šå±‚é˜²æŠ¤ä½“ç³»**
```
åº”ç”¨å±‚é˜²æŠ¤ï¼šè¾“å…¥éªŒè¯ã€é¢„å¤„ç†è¯­å¥ã€é”™è¯¯å¤„ç†
æ•°æ®åº“å±‚é˜²æŠ¤ï¼šæƒé™æ§åˆ¶ã€å®‰å…¨é…ç½®ã€å®¡è®¡ç›‘æ§  
ç³»ç»Ÿå±‚é˜²æŠ¤ï¼šç½‘ç»œéš”ç¦»ã€è®¿é—®æ§åˆ¶ã€æ—¥å¿—åˆ†æ
è¿ç»´å±‚é˜²æŠ¤ï¼šå®šæœŸæ£€æŸ¥ã€æ¼æ´ä¿®å¤ã€åº”æ€¥å“åº”
```

**ğŸ”¹ å®‰å…¨é…ç½®ä¼˜å…ˆçº§**
```
P0çº§é…ç½®ï¼šsql_safe_updatesã€é¢„å¤„ç†è¯­å¥
P1çº§é…ç½®ï¼šæƒé™æœ€å°åŒ–ã€è¿æ¥é™åˆ¶
P2çº§é…ç½®ï¼šå®¡è®¡æ’ä»¶ã€æ•°æ®è„±æ•
P3çº§é…ç½®ï¼šç›‘æ§å‘Šè­¦ã€æ—¥å¿—åˆ†æ
```

**ğŸ”¹ å¸¸è§è¯¯åŒºé¿å…**
```
âŒ ä»…ä¾èµ–å‰ç«¯éªŒè¯
âŒ å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºSQL  
âŒ è¿‡åº¦æˆæƒå›¾æ–¹ä¾¿
âŒ å¿½è§†å®¡è®¡æ—¥å¿—ä»·å€¼
âŒ é”™è¯¯ä¿¡æ¯æ³„éœ²æ•æ„Ÿä¿¡æ¯
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


- **ğŸ›¡ï¸ æ”»å‡»é˜²æŠ¤**ï¼šæœ‰æ•ˆé˜²æ­¢SQLæ³¨å…¥ã€æƒé™æ»¥ç”¨ç­‰å¸¸è§æ”»å‡»
- **ğŸ“Š åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„å’Œè¡Œä¸šæ ‡å‡†è¦æ±‚
- **ğŸ” äº‹ä»¶è¿½è¸ª**ï¼šé€šè¿‡å®¡è®¡æ—¥å¿—å¿«é€Ÿå®šä½å®‰å…¨äº‹ä»¶
- **âš¡ æ€§èƒ½ä¿éšœ**ï¼šå®‰å…¨é…ç½®åŒæ—¶ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
- **ğŸ¢ ä¼ä¸šçº§åº”ç”¨**ï¼šå»ºç«‹å®Œæ•´çš„æ•°æ®åº“å®‰å…¨ç®¡ç†ä½“ç³»

### 9.4 æœ€ä½³å®è·µæ¸…å•


**âœ… å¼€å‘é˜¶æ®µ**
```
â–¡ ä½¿ç”¨é¢„å¤„ç†è¯­å¥ä»£æ›¿å­—ç¬¦ä¸²æ‹¼æ¥
â–¡ å®æ–½ä¸¥æ ¼çš„è¾“å…¥éªŒè¯
â–¡ é…ç½®é€‚å½“çš„sql_mode
â–¡ è®¾è®¡æœ€å°æƒé™ç”¨æˆ·ä½“ç³»
â–¡ é›†æˆå®‰å…¨æµ‹è¯•æµç¨‹
```

**âœ… éƒ¨ç½²é˜¶æ®µ**  
```
â–¡ å¯ç”¨sql_safe_updates
â–¡ é…ç½®è¿æ¥æ•°é™åˆ¶  
â–¡ å®‰è£…é…ç½®å®¡è®¡æ’ä»¶
â–¡ å»ºç«‹ç›‘æ§å‘Šè­¦æœºåˆ¶
â–¡ å®æ–½æ•°æ®è„±æ•ç­–ç•¥
```

**âœ… è¿ç»´é˜¶æ®µ**
```
â–¡ å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™
â–¡ åˆ†æå®¡è®¡æ—¥å¿—å¼‚å¸¸
â–¡ æ›´æ–°å®‰å…¨è¡¥ä¸
â–¡ æ‰§è¡Œå®‰å…¨æ¸—é€æµ‹è¯•
â–¡ ç»´æŠ¤åº”æ€¥å“åº”é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é¢„å¤„ç†è¯­å¥é˜²æ³¨å…¥ï¼Œè¾“å…¥éªŒè¯è¦ä¸¥æ ¼
- æƒé™æœ€å°åŒ–åŸåˆ™ï¼Œå®‰å…¨é…ç½®ä¸èƒ½å°‘  
- å®¡è®¡ç›‘æ§å…¨è¦†ç›–ï¼Œæ•°æ®è„±æ•ä¿éšç§
- å¤šå±‚é˜²æŠ¤ä½“ç³»å…¨ï¼Œå®‰å…¨ç¼–ç æˆä¹ æƒ¯