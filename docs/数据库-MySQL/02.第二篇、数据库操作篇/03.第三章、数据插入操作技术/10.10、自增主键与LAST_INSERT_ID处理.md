---
title: 10ã€è‡ªå¢ä¸»é”®ä¸LAST_INSERT_IDå¤„ç†
---
## ğŸ“š ç›®å½•

1. [è‡ªå¢ä¸»é”®åŸºç¡€æ¦‚å¿µ](#1-è‡ªå¢ä¸»é”®åŸºç¡€æ¦‚å¿µ)
2. [LAST_INSERT_IDå‡½æ•°è¯¦è§£](#2-LAST_INSERT_IDå‡½æ•°è¯¦è§£)
3. [è‡ªå¢é”æ¨¡å¼æœºåˆ¶](#3-è‡ªå¢é”æ¨¡å¼æœºåˆ¶)
4. [è‡ªå¢IDåˆ†é…åŸç†](#4-è‡ªå¢IDåˆ†é…åŸç†)
5. [å¤šçº¿ç¨‹ç¯å¢ƒå¤„ç†](#5-å¤šçº¿ç¨‹ç¯å¢ƒå¤„ç†)
6. [è‡ªå¢IDç®¡ç†ä¸é‡ç½®](#6-è‡ªå¢IDç®¡ç†ä¸é‡ç½®)
7. [å®è·µåº”ç”¨ä¸ä¼˜åŒ–](#7-å®è·µåº”ç”¨ä¸ä¼˜åŒ–)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”¢ è‡ªå¢ä¸»é”®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è‡ªå¢ä¸»é”®


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šè‡ªå¢ä¸»é”®ï¼ˆ`AUTO_INCREMENT`ï¼‰æ˜¯MySQLæä¾›çš„ä¸€ç§**è‡ªåŠ¨é€’å¢**çš„ä¸»é”®ç”Ÿæˆæœºåˆ¶ï¼Œå°±åƒé“¶è¡Œæ’é˜Ÿå–å·æœºä¸€æ ·ï¼Œæ¯æ¬¡æ’å…¥æ–°è®°å½•æ—¶è‡ªåŠ¨åˆ†é…ä¸‹ä¸€ä¸ªæ›´å¤§çš„æ•°å­—ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
é“¶è¡Œæ’é˜Ÿå–å·æœº    â†’    MySQLè‡ªå¢ä¸»é”®
æŒ‰ä¸€æ¬¡å–ä¸€ä¸ªå·    â†’    æ’å…¥ä¸€æ¡è®°å½•åˆ†é…ä¸€ä¸ªID
å·ç ä¾æ¬¡é€’å¢      â†’    IDå€¼è‡ªåŠ¨é€’å¢
ä¸ä¼šé‡å¤å·ç       â†’    ä¿è¯IDå”¯ä¸€æ€§
```

**åŸºæœ¬è¯­æ³•**ï¼š
```sql
-- åˆ›å»ºå¸¦è‡ªå¢ä¸»é”®çš„è¡¨
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,  -- è‡ªå¢ä¸»é”®
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE
);
```

### 1.2 è‡ªå¢ä¸»é”®çš„å·¥ä½œåŸç†


**å†…éƒ¨æœºåˆ¶**ï¼š
```
æ’å…¥æ•°æ®æµç¨‹ï¼š
ç”¨æˆ·æ’å…¥ â†’ MySQLæ£€æŸ¥è‡ªå¢å­—æ®µ â†’ åˆ†é…æ–°ID â†’ å­˜å‚¨è®°å½•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æ’å…¥   â”‚â”€â”€â”€â”€â–¶â”‚  åˆ†é…è‡ªå¢ID  â”‚â”€â”€â”€â”€â–¶â”‚   å­˜å‚¨è®°å½•   â”‚
â”‚ INSERTæ•°æ®  â”‚    â”‚ æŸ¥æ‰¾ä¸‹ä¸€ä¸ªID â”‚    â”‚  å†™å…¥ç£ç›˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªå¢è®¡æ•°å™¨**ï¼šMySQLä¸ºæ¯ä¸ªè¡¨çš„è‡ªå¢å­—æ®µç»´æŠ¤ä¸€ä¸ª**è®¡æ•°å™¨**ï¼Œè®°å½•ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„IDå€¼ã€‚

```sql
-- æŸ¥çœ‹å½“å‰è‡ªå¢å€¼
SHOW CREATE TABLE users;
-- ç»“æœå¯èƒ½æ˜¾ç¤ºï¼šAUTO_INCREMENT=1001

-- æ‰‹åŠ¨è®¾ç½®è‡ªå¢èµ·å§‹å€¼
ALTER TABLE users AUTO_INCREMENT = 1000;
```

### 1.3 è‡ªå¢ä¸»é”®çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆè¦ç”¨è‡ªå¢ä¸»é”®**ï¼š

ğŸ”¸ **å”¯ä¸€æ€§ä¿è¯**ï¼šMySQLç¡®ä¿æ¯ä¸ªIDéƒ½æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¼šé‡å¤
```sql
-- æ— è®ºå¤šå°‘ç”¨æˆ·åŒæ—¶æ’å…¥ï¼ŒIDéƒ½ä¸ä¼šå†²çª
INSERT INTO users (name, email) VALUES ('å¼ ä¸‰', 'zhang@email.com');  -- åˆ†é…ID: 1
INSERT INTO users (name, email) VALUES ('æå››', 'li@email.com');     -- åˆ†é…ID: 2
```

ğŸ”¸ **æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **æ’å…¥é«˜æ•ˆ**ï¼šä¸éœ€è¦å…ˆæŸ¥è¯¢æœ€å¤§IDï¼Œç›´æ¥åˆ†é…
- **ç´¢å¼•å‹å¥½**ï¼šé€’å¢çš„IDå¯¹B+æ ‘ç´¢å¼•éå¸¸å‹å¥½
- **æ— éœ€åº”ç”¨å±‚å¤„ç†**ï¼šæ•°æ®åº“è‡ªåŠ¨å¤„ç†ï¼Œå‡å°‘åº”ç”¨å¤æ‚åº¦

ğŸ”¸ **å¹¶å‘å®‰å…¨**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶æ’å…¥æ•°æ®æ—¶ï¼ŒMySQLå†…éƒ¨ä¼šå¤„ç†å¹¶å‘å†²çª

### 1.4 è‡ªå¢ä¸»é”®çš„æ³¨æ„äº‹é¡¹


> âš ï¸ **é‡è¦æé†’**ï¼šè‡ªå¢IDä¸€æ—¦åˆ†é…å°±ä¸ä¼šå›æ”¶ï¼Œå³ä½¿åˆ é™¤è®°å½•ï¼ŒIDä¹Ÿä¸ä¼šé‡å¤ä½¿ç”¨

```sql
-- ç¤ºä¾‹ï¼šIDä¸ä¼šé‡å¤ä½¿ç”¨
INSERT INTO users (name) VALUES ('ç”¨æˆ·1');  -- ID: 1
INSERT INTO users (name) VALUES ('ç”¨æˆ·2');  -- ID: 2
DELETE FROM users WHERE id = 2;            -- åˆ é™¤IDä¸º2çš„è®°å½•
INSERT INTO users (name) VALUES ('ç”¨æˆ·3');  -- ID: 3ï¼ˆä¸æ˜¯2ï¼ï¼‰
```

**å¸¸è§è¯¯åŒº**ï¼š
- âŒ è®¤ä¸ºåˆ é™¤è®°å½•åIDä¼šè¢«é‡æ–°ä½¿ç”¨
- âŒ æœŸæœ›IDå€¼æ˜¯è¿ç»­æ— é—´éš”çš„
- âœ… æ­£ç¡®ç†è§£ï¼šIDåªä¿è¯å”¯ä¸€é€’å¢ï¼Œå¯èƒ½æœ‰é—´éš”

---

## 2. ğŸ¯ LAST_INSERT_IDå‡½æ•°è¯¦è§£


### 2.1 LAST_INSERT_IDåŸºæœ¬æ¦‚å¿µ


**æ ¸å¿ƒä½œç”¨**ï¼š`LAST_INSERT_ID()`å‡½æ•°ç”¨äº**è·å–å½“å‰è¿æ¥ä¸­æœ€åä¸€æ¬¡æ’å…¥æ“ä½œäº§ç”Ÿçš„è‡ªå¢IDå€¼**ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒä½ åœ¨é“¶è¡ŒåŠä¸šåŠ¡åï¼ŒæŸœå‘˜ç»™ä½ ä¸€å¼ å›æ‰§å•
å›æ‰§å•ä¸Šçš„å·ç å°±æ˜¯ä½ è¿™æ¬¡åŠç†ä¸šåŠ¡çš„ç¼–å·
LAST_INSERT_ID()å°±æ˜¯è·å–è¿™ä¸ª"å›æ‰§å•å·ç "çš„æ–¹æ³•
```

### 2.2 åŸºæœ¬ä½¿ç”¨æ–¹æ³•


**ç®€å•ç¤ºä¾‹**ï¼š
```sql
-- æ’å…¥ä¸€æ¡è®°å½•
INSERT INTO users (name, email) VALUES ('å¼ ä¸‰', 'zhang@email.com');

-- ç«‹å³è·å–åˆšæ’å…¥è®°å½•çš„ID
SELECT LAST_INSERT_ID();  -- è¿”å›ï¼š1001ï¼ˆå‡è®¾åˆ†é…çš„IDæ˜¯1001ï¼‰

-- ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªè¯­å¥ä¸­ä½¿ç”¨
INSERT INTO users (name, email) VALUES ('æå››', 'li@email.com');
SELECT LAST_INSERT_ID() AS new_user_id;  -- è¿”å›ï¼š1002
```

### 2.3 LAST_INSERT_IDçš„é‡è¦ç‰¹æ€§


#### ğŸ”— è¿æ¥éš”ç¦»æ€§


**å…³é”®ç†è§£**ï¼š`LAST_INSERT_ID()`æ˜¯**è¿æ¥çº§åˆ«**çš„ï¼Œä¸åŒçš„æ•°æ®åº“è¿æ¥ä¹‹é—´**äº’ä¸å½±å“**ã€‚

```
è¿æ¥éš”ç¦»ç¤ºä¾‹ï¼š

è¿æ¥Aï¼š                     è¿æ¥Bï¼š
INSERT users...            INSERT users...
LAST_INSERT_ID() â†’ 100     LAST_INSERT_ID() â†’ 101

// ä¸¤ä¸ªè¿æ¥å„è‡ªç»´æŠ¤è‡ªå·±çš„LAST_INSERT_IDå€¼
// è¿æ¥Açœ‹ä¸åˆ°è¿æ¥Bçš„æ’å…¥ç»“æœ
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```sql
-- Webåº”ç”¨ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·è¯·æ±‚ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥
-- ç”¨æˆ·Aæ’å…¥æ•°æ®ï¼š
INSERT INTO orders (user_id, product) VALUES (123, 'å•†å“A');
SELECT LAST_INSERT_ID();  -- è¿”å›è®¢å•IDï¼š5001

-- åŒæ—¶ç”¨æˆ·Bä¹Ÿåœ¨æ’å…¥æ•°æ®ï¼š
INSERT INTO orders (user_id, product) VALUES (456, 'å•†å“B');  
SELECT LAST_INSERT_ID();  -- è¿”å›è®¢å•IDï¼š5002

-- ä¸¤ä¸ªç”¨æˆ·å„è‡ªè·å¾—æ­£ç¡®çš„è®¢å•IDï¼Œä¸ä¼šæ··ä¹±
```

#### ğŸ“Š æ‰¹é‡æ’å…¥å¤„ç†


**æ‰¹é‡æ’å…¥æ—¶çš„è¡Œä¸º**ï¼šæ’å…¥å¤šæ¡è®°å½•æ—¶ï¼Œ`LAST_INSERT_ID()`è¿”å›**ç¬¬ä¸€æ¡è®°å½•**çš„IDã€‚

```sql
-- æ‰¹é‡æ’å…¥ç¤ºä¾‹
INSERT INTO users (name) VALUES 
('ç”¨æˆ·1'),    -- å‡è®¾åˆ†é…IDï¼š100
('ç”¨æˆ·2'),    -- å‡è®¾åˆ†é…IDï¼š101  
('ç”¨æˆ·3');    -- å‡è®¾åˆ†é…IDï¼š102

SELECT LAST_INSERT_ID();  -- è¿”å›ï¼š100ï¼ˆç¬¬ä¸€æ¡è®°å½•çš„IDï¼‰

-- è·å–æ’å…¥çš„è®°å½•æ•°é‡
SELECT ROW_COUNT();       -- è¿”å›ï¼š3ï¼ˆæ’å…¥äº†3æ¡è®°å½•ï¼‰

-- æ¨ç®—æ‰€æœ‰æ’å…¥çš„IDèŒƒå›´ï¼š100åˆ°102
```

### 2.4 LAST_INSERT_IDä¸äº‹åŠ¡


**äº‹åŠ¡ç¯å¢ƒä¸‹çš„è¡Œä¸º**ï¼š
```sql
-- äº‹åŠ¡ä¸­çš„LAST_INSERT_ID
START TRANSACTION;

INSERT INTO users (name) VALUES ('äº‹åŠ¡ç”¨æˆ·1');
SELECT LAST_INSERT_ID();  -- è¿”å›æ–°IDï¼Œæ¯”å¦‚ï¼š200

INSERT INTO users (name) VALUES ('äº‹åŠ¡ç”¨æˆ·2');
SELECT LAST_INSERT_ID();  -- è¿”å›æ›´æ–°çš„IDï¼Œæ¯”å¦‚ï¼š201

ROLLBACK;  -- å›æ»šäº‹åŠ¡

-- å›æ»šåï¼š
-- 1. æ’å…¥çš„è®°å½•è¢«åˆ é™¤
-- 2. ä½†æ˜¯è‡ªå¢è®¡æ•°å™¨ä¸ä¼šå›æ»šï¼
-- 3. ä¸‹æ¬¡æ’å…¥IDä¼šä»202å¼€å§‹ï¼ˆè·³è¿‡äº†200ã€201ï¼‰

SELECT LAST_INSERT_ID();  -- ä»ç„¶è¿”å›ï¼š201ï¼ˆè¿æ¥çº§åˆ«çš„å€¼ä¸å˜ï¼‰
```

> ğŸ’¡ **é‡è¦ç†è§£**ï¼šäº‹åŠ¡å›æ»šæ—¶ï¼Œæ’å…¥çš„æ•°æ®ä¼šæ’¤é”€ï¼Œä½†è‡ªå¢è®¡æ•°å™¨**ä¸ä¼šå›æ»š**ï¼Œè¿™æ˜¯MySQLçš„è®¾è®¡ç‰¹æ€§ï¼Œé¿å…IDé‡å¤ä½¿ç”¨ã€‚

### 2.5 ç¼–ç¨‹è¯­è¨€ä¸­çš„åº”ç”¨


**Javaç¤ºä¾‹**ï¼š
```java
public class UserService {
    
    // æ’å…¥ç”¨æˆ·å¹¶è·å–ç”Ÿæˆçš„ID
    public Long insertUser(String name, String email) {
        String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
        
        try (PreparedStatement stmt = connection.prepareStatement(sql, 
                Statement.RETURN_GENERATED_KEYS)) {
            
            stmt.setString(1, name);
            stmt.setString(2, email);
            stmt.executeUpdate();
            
            // è·å–ç”Ÿæˆçš„ä¸»é”®
            try (ResultSet rs = stmt.getGeneratedKeys()) {
                if (rs.next()) {
                    return rs.getLong(1);  // è¿”å›è‡ªå¢ID
                }
            }
        }
        return null;
    }
}
```

**Pythonç¤ºä¾‹**ï¼š
```python
import mysql.connector

def insert_user(name, email):
    cursor = connection.cursor()
    
    # æ’å…¥æ•°æ®
    sql = "INSERT INTO users (name, email) VALUES (%s, %s)"
    cursor.execute(sql, (name, email))
    
    # è·å–è‡ªå¢ID
    user_id = cursor.lastrowid  # ç­‰åŒäºLAST_INSERT_ID()
    
    connection.commit()
    return user_id

# ä½¿ç”¨ç¤ºä¾‹
new_user_id = insert_user("å¼ ä¸‰", "zhang@email.com")
print(f"æ–°ç”¨æˆ·ID: {new_user_id}")
```

---

## 3. ğŸ”’ è‡ªå¢é”æ¨¡å¼æœºåˆ¶


### 3.1 innodb_autoinc_lock_modeæ¦‚è¿°


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š`innodb_autoinc_lock_mode`æ˜¯MySQL InnoDBå­˜å‚¨å¼•æ“çš„ä¸€ä¸ªé‡è¦å‚æ•°ï¼Œæ§åˆ¶è‡ªå¢IDåˆ†é…æ—¶çš„**é”å®šç­–ç•¥**ã€‚

```
ç”Ÿæ´»æ¯”å–»ï¼š
æƒ³è±¡ä¸€ä¸ªå‘å·æœºæœ‰ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š

æ¨¡å¼0 - ä¼ ç»Ÿæ¨¡å¼ï¼šæ¯æ¬¡æœ‰äººæ¥å–å·ï¼Œæ•´ä¸ªå‘å·æœºéƒ½é”ä½
æ¨¡å¼1 - è¿ç»­æ¨¡å¼ï¼šæ™®é€šå–å·å¿«é€Ÿå¤„ç†ï¼Œæ‰¹é‡å–å·æ‰é”ä½æ•´ä¸ªæœºå™¨  
æ¨¡å¼2 - äº¤é”™æ¨¡å¼ï¼šå®Œå…¨ä¸é”æœºå™¨ï¼Œå¯èƒ½å·ç ä¸è¿ç»­ä½†é€Ÿåº¦æœ€å¿«
```

### 3.2 ä¸‰ç§é”æ¨¡å¼è¯¦è§£


#### ğŸ”’ ä¼ ç»Ÿæ¨¡å¼ï¼ˆmode = 0ï¼‰


**ç‰¹ç‚¹**ï¼š`innodb_autoinc_lock_mode = 0`

```
å·¥ä½œæœºåˆ¶ï¼š
æ‰€æœ‰INSERTè¯­å¥éƒ½ä½¿ç”¨è¡¨çº§è‡ªå¢é”ï¼ˆAUTO-INCé”ï¼‰
é”çš„èŒƒå›´ï¼šæ•´ä¸ªINSERTè¯­å¥æ‰§è¡ŒæœŸé—´
é”çš„ç²’åº¦ï¼šè¡¨çº§é”ï¼Œå½±å“æ•´å¼ è¡¨

ä¼˜åŠ¿ï¼š
â€¢ IDåˆ†é…ä¸¥æ ¼è¿ç»­ï¼Œæ— é—´éš”
â€¢ ä¸»ä»å¤åˆ¶ç»å¯¹å®‰å…¨
â€¢ è¡Œä¸ºå¯é¢„æµ‹

åŠ£åŠ¿ï¼š  
â€¢ å¹¶å‘æ€§èƒ½æœ€å·®
â€¢ å¤§æ‰¹é‡æ’å…¥æ—¶å…¶ä»–INSERTè¢«å®Œå…¨é˜»å¡
```

**é€‚ç”¨åœºæ™¯**ï¼š
- è¦æ±‚IDä¸¥æ ¼è¿ç»­çš„ä¸šåŠ¡åœºæ™¯
- ä¼ ç»Ÿçš„ä¸»ä»å¤åˆ¶ç¯å¢ƒ
- å¯¹å¹¶å‘æ€§èƒ½è¦æ±‚ä¸é«˜çš„ç³»ç»Ÿ

#### âš¡ è¿ç»­æ¨¡å¼ï¼ˆmode = 1ï¼Œé»˜è®¤å€¼ï¼‰


**ç‰¹ç‚¹**ï¼š`innodb_autoinc_lock_mode = 1`

```
å·¥ä½œæœºåˆ¶ï¼š
ç®€å•æ’å…¥ï¼šä½¿ç”¨è½»é‡çº§äº’æ–¥é”ï¼Œå¿«é€Ÿåˆ†é…ID
æ‰¹é‡æ’å…¥ï¼šä½¿ç”¨ä¼ ç»Ÿçš„AUTO-INCè¡¨çº§é”

æ’å…¥ç±»å‹åˆ†ç±»ï¼š
1. ç®€å•æ’å…¥ï¼ˆSimple INSERTï¼‰ï¼š
   - INSERT INTO table VALUES (...)
   - INSERT INTO table VALUES (...), (...), (...)  -- å›ºå®šè¡Œæ•°
   
2. æ‰¹é‡æ’å…¥ï¼ˆBulk INSERTï¼‰ï¼š  
   - INSERT INTO table SELECT ... FROM other_table
   - REPLACE INTO table SELECT ...
   - LOAD DATA INFILE
```

**æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**ï¼š
```sql
-- ç®€å•æ’å…¥ï¼ˆå¿«é€Ÿå¤„ç†ï¼‰
INSERT INTO users (name) VALUES ('ç”¨æˆ·1');           -- ä½¿ç”¨è½»é‡çº§é”
INSERT INTO users (name) VALUES ('ç”¨æˆ·2'), ('ç”¨æˆ·3'); -- ä½¿ç”¨è½»é‡çº§é”

-- æ‰¹é‡æ’å…¥ï¼ˆä¼ ç»Ÿé”ï¼‰
INSERT INTO users (name) SELECT name FROM temp_users; -- ä½¿ç”¨AUTO-INCé”
```

#### ğŸš€ äº¤é”™æ¨¡å¼ï¼ˆmode = 2ï¼‰


**ç‰¹ç‚¹**ï¼š`innodb_autoinc_lock_mode = 2`

```
å·¥ä½œæœºåˆ¶ï¼š
æ‰€æœ‰INSERTéƒ½ä¸ä½¿ç”¨AUTO-INCé”
ä»…ä½¿ç”¨è½»é‡çº§äº’æ–¥é”å¿«é€Ÿåˆ†é…ID
å¯èƒ½äº§ç”ŸIDé—´éš”ï¼Œä½†æ€§èƒ½æœ€é«˜

æ€§èƒ½æå‡ï¼š
å¹¶å‘æ’å…¥æ€§èƒ½æœ€ä½³
ç‰¹åˆ«é€‚åˆé«˜å¹¶å‘OLTPç³»ç»Ÿ
å¤§æ‰¹é‡æ’å…¥ä¹Ÿä¸ä¼šé˜»å¡å…¶ä»–æ“ä½œ
```

**IDåˆ†é…ç¤ºä¾‹**ï¼š
```
å¹¶å‘æ’å…¥æ—¶å¯èƒ½çš„IDåˆ†é…ï¼š

è¿æ¥Aæ’å…¥ï¼šINSERT INTO users (name) VALUES ('A1'), ('A2'), ('A3');
è¿æ¥Bæ’å…¥ï¼šINSERT INTO users (name) VALUES ('B1'), ('B2');

å¯èƒ½çš„IDåˆ†é…ç»“æœï¼š
A1 â†’ ID: 100
B1 â†’ ID: 101  
A2 â†’ ID: 102
B2 â†’ ID: 103
A3 â†’ ID: 104

// IDä»ç„¶å”¯ä¸€ï¼Œä½†åœ¨è¡¨ä¸­çš„åˆ†é…é¡ºåºå¯èƒ½äº¤é”™
```

### 3.3 é”æ¨¡å¼å¯¹æ¯”åˆ†æ


| é”æ¨¡å¼ | **å¹¶å‘æ€§èƒ½** | **IDè¿ç»­æ€§** | **å¤åˆ¶å®‰å…¨** | **é€‚ç”¨åœºæ™¯** |
|--------|------------|-------------|-------------|-------------|
| **æ¨¡å¼0 ä¼ ç»Ÿ** | `âŒ å·®` | `âœ… ä¸¥æ ¼è¿ç»­` | `âœ… å®Œå…¨å®‰å…¨` | `ä¼ ç»Ÿç³»ç»Ÿã€è¦æ±‚è¿ç»­ID` |
| **æ¨¡å¼1 è¿ç»­** | `ğŸ”¶ ä¸­ç­‰` | `âœ… åŸºæœ¬è¿ç»­` | `âœ… å®‰å…¨` | `ä¸€èˆ¬Webåº”ç”¨ï¼ˆé»˜è®¤ï¼‰` |
| **æ¨¡å¼2 äº¤é”™** | `âœ… æœ€é«˜` | `âŒ å¯èƒ½é—´éš”` | `âš ï¸ æ³¨æ„è®¾ç½®` | `é«˜å¹¶å‘OLTPç³»ç»Ÿ` |

### 3.4 å¦‚ä½•é€‰æ‹©åˆé€‚çš„é”æ¨¡å¼


**é€‰æ‹©æŒ‡å¯¼**ï¼š

```
ğŸ“Š ä¸šåŠ¡åœºæ™¯åˆ†æï¼š

é«˜å¹¶å‘Webåº”ç”¨ï¼š
æ¨èï¼šmode = 2
åŸå› ï¼šæ€§èƒ½æœ€é‡è¦ï¼ŒIDé—´éš”é€šå¸¸ä¸å½±å“ä¸šåŠ¡

è®¢å•ç³»ç»Ÿï¼š
æ¨èï¼šmode = 1  
åŸå› ï¼šå¹³è¡¡æ€§èƒ½å’Œè¿ç»­æ€§ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯

æŠ¥è¡¨ç³»ç»Ÿï¼š
æ¨èï¼šmode = 0
åŸå› ï¼šéœ€è¦IDä¸¥æ ¼è¿ç»­ï¼Œä¾¿äºæ•°æ®åˆ†æ

é‡‘èç³»ç»Ÿï¼š
æ¨èï¼šmode = 0 æˆ– mode = 1
åŸå› ï¼šæ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œè°¨æ…é€‰æ‹©
```

**é…ç½®æ–¹æ³•**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW VARIABLES LIKE 'innodb_autoinc_lock_mode';

-- ä¿®æ”¹é…ç½®ï¼ˆéœ€è¦é‡å¯MySQLï¼‰
-- åœ¨my.cnfä¸­æ·»åŠ ï¼š
-- innodb_autoinc_lock_mode = 2

-- æˆ–è€…å¯åŠ¨æ—¶æŒ‡å®šï¼š
-- mysqld --innodb_autoinc_lock_mode=2
```

---

## 4. ğŸ”„ è‡ªå¢IDåˆ†é…åŸç†


### 4.1 è‡ªå¢è®¡æ•°å™¨å·¥ä½œæœºåˆ¶


**å†…éƒ¨ç»“æ„**ï¼šæ¯ä¸ªåŒ…å«è‡ªå¢å­—æ®µçš„è¡¨éƒ½æœ‰ä¸€ä¸ª**è‡ªå¢è®¡æ•°å™¨**ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚

```
è‡ªå¢è®¡æ•°å™¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¨åï¼šusers          â”‚
â”‚ å½“å‰è‡ªå¢å€¼ï¼š1005     â”‚ â† ä¸‹ä¸€ä¸ªè¦åˆ†é…çš„ID
â”‚ è‡ªå¢æ­¥é•¿ï¼š1          â”‚ â† æ¯æ¬¡é€’å¢çš„å€¼
â”‚ æœ€å¤§å€¼ï¼š2147483647   â”‚ â† INTç±»å‹çš„æœ€å¤§å€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ†é…è¿‡ç¨‹**ï¼š
```
IDåˆ†é…çš„è¯¦ç»†æ­¥éª¤ï¼š

1. ç”¨æˆ·æ‰§è¡ŒINSERTè¯­å¥
2. MySQLæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†é…è‡ªå¢ID
3. è·å–è‡ªå¢é”ï¼ˆæ ¹æ®lock_modeå†³å®šé”ç±»å‹ï¼‰
4. è¯»å–å½“å‰è‡ªå¢è®¡æ•°å™¨å€¼
5. åˆ†é…IDç»™æ–°è®°å½•
6. æ›´æ–°è‡ªå¢è®¡æ•°å™¨ï¼ˆ+1æˆ–+æ­¥é•¿ï¼‰
7. é‡Šæ”¾è‡ªå¢é”
8. ç»§ç»­æ‰§è¡ŒINSERTæ“ä½œ
```

### 4.2 è‡ªå¢æ­¥é•¿è®¾ç½®


**ç›¸å…³å‚æ•°**ï¼š
- `auto_increment_increment`ï¼šè‡ªå¢æ­¥é•¿ï¼Œé»˜è®¤ä¸º1
- `auto_increment_offset`ï¼šè‡ªå¢èµ·å§‹åç§»ï¼Œé»˜è®¤ä¸º1

```sql
-- æŸ¥çœ‹å½“å‰è®¾ç½®
SHOW VARIABLES LIKE 'auto_increment%';

-- è®¾ç½®æ­¥é•¿ä¸º10ï¼Œåç§»ä¸º1
SET auto_increment_increment = 10;
SET auto_increment_offset = 1;

-- æ’å…¥æ•°æ®è§‚å¯ŸIDåˆ†é…
INSERT INTO test_table (name) VALUES ('A');  -- ID: 1
INSERT INTO test_table (name) VALUES ('B');  -- ID: 11  
INSERT INTO test_table (name) VALUES ('C');  -- ID: 21
```

**ä¸»ä»å¤åˆ¶ä¸­çš„æ­¥é•¿è®¾ç½®**ï¼š
```
ä¸»ä»å¤åˆ¶ç¯å¢ƒçš„IDåˆ†é…ç­–ç•¥ï¼š

ä¸»åº“é…ç½®ï¼š
auto_increment_increment = 2    -- æ­¥é•¿ä¸º2
auto_increment_offset = 1       -- ä»1å¼€å§‹

ä»åº“é…ç½®ï¼š  
auto_increment_increment = 2    -- æ­¥é•¿ä¸º2
auto_increment_offset = 2       -- ä»2å¼€å§‹

ç»“æœï¼š
ä¸»åº“åˆ†é…IDï¼š1, 3, 5, 7, 9...   (å¥‡æ•°)
ä»åº“åˆ†é…IDï¼š2, 4, 6, 8, 10...  (å¶æ•°)

ä¼˜åŠ¿ï¼šé¿å…ä¸»ä»åˆ‡æ¢æ—¶çš„IDå†²çª
```

### 4.3 è‡ªå¢IDçš„æŒä¹…åŒ–


**å­˜å‚¨ä½ç½®**ï¼š
- **MySQL 5.7åŠä¹‹å‰**ï¼šè‡ªå¢è®¡æ•°å™¨åªå­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯åéœ€è¦é‡æ–°è®¡ç®—
- **MySQL 8.0åŠä¹‹å**ï¼šè‡ªå¢è®¡æ•°å™¨æŒä¹…åŒ–åˆ°é‡åšæ—¥å¿—ä¸­

```sql
-- MySQL 5.7é‡å¯åçš„è¡Œä¸º
-- é‡å¯å‰ï¼šå½“å‰è‡ªå¢å€¼ = 1005ï¼Œè¡¨ä¸­æœ€å¤§ID = 1000ï¼ˆåˆ é™¤äº†1001-1004ï¼‰
-- é‡å¯åï¼šæ‰«æè¡¨ï¼Œå‘ç°æœ€å¤§ID = 1000ï¼Œè®¾ç½®è‡ªå¢å€¼ = 1001

-- MySQL 8.0é‡å¯åçš„è¡Œä¸º  
-- é‡å¯å‰ï¼šå½“å‰è‡ªå¢å€¼ = 1005
-- é‡å¯åï¼šä»é‡åšæ—¥å¿—æ¢å¤ï¼Œè‡ªå¢å€¼ä»ä¸º = 1005
```

### 4.4 è‡ªå¢IDçš„é™åˆ¶ä¸è¾¹ç•Œ


**æ•°æ®ç±»å‹é™åˆ¶**ï¼š
```sql
-- ä¸åŒæ•°æ®ç±»å‹çš„è‡ªå¢èŒƒå›´
TINYINT:   1 åˆ° 127 (æœ‰ç¬¦å·) æˆ– 1 åˆ° 255 (æ— ç¬¦å·)
SMALLINT:  1 åˆ° 32767 æˆ– 1 åˆ° 65535  
INT:       1 åˆ° 2147483647 æˆ– 1 åˆ° 4294967295
BIGINT:    1 åˆ° 9223372036854775807 æˆ–æ›´å¤§
```

**è¾¾åˆ°ä¸Šé™æ—¶çš„å¤„ç†**ï¼š
```sql
-- å½“è‡ªå¢å€¼è¾¾åˆ°æ•°æ®ç±»å‹ä¸Šé™æ—¶
INSERT INTO users (name) VALUES ('æœ€åä¸€ä¸ªç”¨æˆ·');
-- å¦‚æœå½“å‰IDå·²ç»æ˜¯INTæœ€å¤§å€¼2147483647

-- å†æ¬¡æ’å…¥ä¼šæŠ¥é”™ï¼š
-- ERROR 1062 (23000): Duplicate entry '2147483647' for key 'PRIMARY'
```

> âš ï¸ **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼šå¯¹äºå¯èƒ½æœ‰å¤§é‡æ•°æ®çš„è¡¨ï¼Œå»ºè®®ä½¿ç”¨`BIGINT`ç±»å‹çš„è‡ªå¢ä¸»é”®ã€‚

---

## 5. ğŸ”€ å¤šçº¿ç¨‹ç¯å¢ƒå¤„ç†


### 5.1 å¹¶å‘æ’å…¥çš„æŒ‘æˆ˜


**é—®é¢˜åœºæ™¯**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å‘æ•°æ®åº“æ’å…¥æ•°æ®æ—¶ï¼Œå¦‚ä½•ä¿è¯æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½æ­£ç¡®è·å–è‡ªå·±æ’å…¥è®°å½•çš„IDï¼Ÿ

```
å¹¶å‘é—®é¢˜ç¤ºä¾‹ï¼š

æ—¶é—´è½´ï¼š
T1: çº¿ç¨‹Aæ‰§è¡ŒINSERT  
T2: çº¿ç¨‹Bæ‰§è¡ŒINSERT
T3: çº¿ç¨‹Aæ‰§è¡ŒLAST_INSERT_ID()  -- å¯èƒ½è·å–åˆ°çº¿ç¨‹Bçš„IDï¼Ÿ
T4: çº¿ç¨‹Bæ‰§è¡ŒLAST_INSERT_ID()

æ‹…å¿ƒï¼šçº¿ç¨‹Aä¼šä¸ä¼šæ‹¿åˆ°çº¿ç¨‹Bæ’å…¥çš„IDï¼Ÿ
```

### 5.2 MySQLçš„å¹¶å‘å®‰å…¨æœºåˆ¶


**è¿æ¥éš”ç¦»ä¿æŠ¤**ï¼šMySQLé€šè¿‡**è¿æ¥éš”ç¦»**ç¡®ä¿å¹¶å‘å®‰å…¨ã€‚

```
MySQLå†…éƒ¨å¤„ç†ï¼š

è¿æ¥æ± ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿æ¥A      â”‚    â”‚   è¿æ¥B      â”‚    â”‚   è¿æ¥C      â”‚
â”‚ çº¿ç¨‹1ä½¿ç”¨    â”‚    â”‚ çº¿ç¨‹2ä½¿ç”¨    â”‚    â”‚ çº¿ç¨‹3ä½¿ç”¨    â”‚
â”‚ LAST_ID=100 â”‚    â”‚ LAST_ID=101 â”‚    â”‚ LAST_ID=102 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªè¿æ¥ç»´æŠ¤ç‹¬ç«‹çš„LAST_INSERT_IDå€¼
çº¿ç¨‹é—´ä¸ä¼šç›¸äº’å¹²æ‰°
```

**ä»£ç å®ç°ç¤ºä¾‹**ï¼š
```java
// çº¿ç¨‹å®‰å…¨çš„ç”¨æˆ·æ’å…¥æœåŠ¡
public class ThreadSafeUserService {
    
    private DataSource dataSource;  // è¿æ¥æ± 
    
    public Long insertUser(String name, String email) {
        // æ¯ä¸ªçº¿ç¨‹è·å–ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥
        try (Connection conn = dataSource.getConnection()) {
            
            String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
            try (PreparedStatement stmt = conn.prepareStatement(sql)) {
                stmt.setString(1, name);
                stmt.setString(2, email);
                stmt.executeUpdate();
                
                // åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­è·å–IDï¼Œçº¿ç¨‹å®‰å…¨
                try (Statement lastIdStmt = conn.createStatement();
                     ResultSet rs = lastIdStmt.executeQuery("SELECT LAST_INSERT_ID()")) {
                    
                    if (rs.next()) {
                        return rs.getLong(1);
                    }
                }
            }
        } catch (SQLException e) {
            throw new RuntimeException("æ’å…¥ç”¨æˆ·å¤±è´¥", e);
        }
        return null;
    }
}
```

### 5.3 è¿æ¥æ± ç¯å¢ƒä¸‹çš„æ³¨æ„äº‹é¡¹


**è¿æ¥å¤ç”¨é—®é¢˜**ï¼šåœ¨ä½¿ç”¨è¿æ¥æ± æ—¶ï¼Œéœ€è¦æ³¨æ„è¿æ¥å¤ç”¨å¯¹`LAST_INSERT_ID()`çš„å½±å“ã€‚

```java
// é”™è¯¯çš„åšæ³• âŒ
public Long insertUserWrong(String name) {
    Connection conn = pool.getConnection();  // å¯èƒ½æ˜¯å¤ç”¨çš„è¿æ¥
    
    // è¿™ä¸ªè¿æ¥å¯èƒ½ä¹‹å‰è¢«å…¶ä»–æ“ä½œä½¿ç”¨è¿‡
    // LAST_INSERT_ID()å¯èƒ½æ˜¯ä¹‹å‰æ“ä½œçš„ç»“æœ
    
    executeInsert(conn, name);
    Long id = getLastInsertId(conn);  // å¯èƒ½ä¸å‡†ç¡®ï¼
    
    pool.returnConnection(conn);
    return id;
}

// æ­£ç¡®çš„åšæ³• âœ…
public Long insertUserCorrect(String name) {
    try (Connection conn = pool.getConnection()) {
        // åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆæ’å…¥å’ŒIDè·å–
        conn.setAutoCommit(false);
        
        executeInsert(conn, name);
        Long id = getLastInsertId(conn);  // å®‰å…¨å¯é 
        
        conn.commit();
        return id;
    } catch (SQLException e) {
        conn.rollback();
        throw e;
    }
}
```

### 5.4 é«˜å¹¶å‘åœºæ™¯çš„æœ€ä½³å®è·µ


**æ¨èæ–¹æ¡ˆ1ï¼šä½¿ç”¨PreparedStatementçš„getGeneratedKeys()**
```java
// æœ€æ¨èçš„æ–¹æ³•
public Long insertWithGeneratedKeys(String name, String email) {
    String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
    
    try (PreparedStatement stmt = connection.prepareStatement(sql, 
            Statement.RETURN_GENERATED_KEYS)) {
        
        stmt.setString(1, name);
        stmt.setString(2, email);
        stmt.executeUpdate();
        
        // ç›´æ¥è·å–ç”Ÿæˆçš„é”®ï¼Œä¸ä¾èµ–LAST_INSERT_ID()
        try (ResultSet keys = stmt.getGeneratedKeys()) {
            return keys.next() ? keys.getLong(1) : null;
        }
    }
}
```

**æ¨èæ–¹æ¡ˆ2ï¼šäº‹åŠ¡å†…è·å–ID**
```java
// äº‹åŠ¡ä¿æŠ¤çš„æ–¹æ³•
@Transactional
public Long insertUserInTransaction(String name, String email) {
    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç¡®ä¿åŸå­æ€§
    userMapper.insert(name, email);
    
    // åœ¨åŒä¸€äº‹åŠ¡ä¸­è·å–ID
    return userMapper.getLastInsertId();
}
```

---

## 6. ğŸ›  è‡ªå¢IDç®¡ç†ä¸é‡ç½®


### 6.1 æŸ¥çœ‹è‡ªå¢çŠ¶æ€


**æŸ¥çœ‹è¡¨çš„è‡ªå¢ä¿¡æ¯**ï¼š
```sql
-- æ–¹æ³•1ï¼šæŸ¥çœ‹è¡¨ç»“æ„
SHOW CREATE TABLE users;
-- è¾“å‡ºåŒ…å«ï¼šAUTO_INCREMENT=1001

-- æ–¹æ³•2ï¼šæŸ¥çœ‹è¡¨çŠ¶æ€  
SHOW TABLE STATUS LIKE 'users';
-- Auto_incrementåˆ—æ˜¾ç¤ºä¸‹ä¸€ä¸ªåˆ†é…çš„ID

-- æ–¹æ³•3ï¼šæŸ¥è¯¢information_schema
SELECT TABLE_NAME, AUTO_INCREMENT 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'your_database' 
  AND TABLE_NAME = 'users';
```

### 6.2 é‡ç½®è‡ªå¢ID


**é‡ç½®æ–¹æ³•**ï¼š
```sql
-- æ–¹æ³•1ï¼šALTER TABLEé‡ç½®
ALTER TABLE users AUTO_INCREMENT = 1;

-- æ–¹æ³•2ï¼šTRUNCATE TABLEï¼ˆæ¸…ç©ºæ•°æ®+é‡ç½®ï¼‰
TRUNCATE TABLE users;  -- è‡ªå¢IDé‡ç½®ä¸º1

-- æ–¹æ³•3ï¼šè®¾ç½®ä¸ºç‰¹å®šå€¼
ALTER TABLE users AUTO_INCREMENT = 10000;  -- ä»10000å¼€å§‹
```

**é‡ç½®çš„å®é™…æ•ˆæœ**ï¼š
```sql
-- é‡ç½®å‰çŠ¶æ€
SELECT MAX(id) FROM users;           -- å‡è®¾è¿”å›ï¼š9999
SHOW CREATE TABLE users;             -- AUTO_INCREMENT=10000

-- é‡ç½®æ“ä½œ
ALTER TABLE users AUTO_INCREMENT = 1;

-- é‡ç½®åçŠ¶æ€  
SHOW CREATE TABLE users;             -- AUTO_INCREMENT=10000ï¼ˆä¸å˜ï¼ï¼‰

-- ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºMySQLä¼šè‡ªåŠ¨è°ƒæ•´ï¼š
-- æ–°çš„è‡ªå¢å€¼ = MAX(ç°æœ‰æœ€å¤§ID + 1, è®¾ç½®å€¼)
-- å®é™…å€¼ = MAX(9999 + 1, 1) = 10000
```

> ğŸ’¡ **é‡è¦ç†è§£**ï¼šé‡ç½®è‡ªå¢IDæ—¶ï¼ŒMySQLä¸ä¼šè®¾ç½®æ¯”ç°æœ‰æœ€å¤§IDæ›´å°çš„å€¼ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯IDå”¯ä¸€æ€§ã€‚

### 6.3 è‡ªå¢IDçš„ç»´æŠ¤ç­–ç•¥


**å®šæœŸç»´æŠ¤**ï¼š
```sql
-- æ£€æŸ¥è‡ªå¢IDä½¿ç”¨æƒ…å†µ
SELECT 
    TABLE_NAME,
    AUTO_INCREMENT as current_value,
    (AUTO_INCREMENT / 4294967295 * 100) as usage_percent  -- INTæœ€å¤§å€¼
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'your_database' 
  AND AUTO_INCREMENT IS NOT NULL
ORDER BY usage_percent DESC;
```

**æ•°æ®è¿ç§»æ—¶çš„IDå¤„ç†**ï¼š
```sql
-- è¿ç§»è¡¨æ•°æ®æ—¶ä¿æŒID
-- 1. ä¸´æ—¶ç¦ç”¨è‡ªå¢
ALTER TABLE target_table MODIFY id INT NOT NULL;

-- 2. æ’å…¥æ•°æ®ï¼ˆåŒ…å«åŸIDï¼‰
INSERT INTO target_table (id, name, email) 
SELECT id, name, email FROM source_table;

-- 3. é‡æ–°å¯ç”¨è‡ªå¢ï¼Œè®¾ç½®æ­£ç¡®çš„èµ·å§‹å€¼
ALTER TABLE target_table MODIFY id INT AUTO_INCREMENT PRIMARY KEY;
ALTER TABLE target_table AUTO_INCREMENT = (
    SELECT MAX(id) + 1 FROM target_table
);
```

### 6.4 è‡ªå¢IDè€—å°½çš„å¤„ç†


**é¢„é˜²æªæ–½**ï¼š
```sql
-- ç›‘æ§è‡ªå¢IDä½¿ç”¨ç‡
CREATE PROCEDURE CheckAutoIncrementUsage()
BEGIN
    SELECT 
        TABLE_NAME,
        DATA_TYPE,
        CASE DATA_TYPE
            WHEN 'tinyint' THEN 255
            WHEN 'smallint' THEN 65535
            WHEN 'mediumint' THEN 16777215
            WHEN 'int' THEN 4294967295
            WHEN 'bigint' THEN 18446744073709551615
        END as max_value,
        AUTO_INCREMENT,
        ROUND(AUTO_INCREMENT / 
            CASE DATA_TYPE
                WHEN 'tinyint' THEN 255
                WHEN 'smallint' THEN 65535  
                WHEN 'mediumint' THEN 16777215
                WHEN 'int' THEN 4294967295
                WHEN 'bigint' THEN 18446744073709551615
            END * 100, 2) as usage_percent
    FROM information_schema.TABLES t
    JOIN information_schema.COLUMNS c ON t.TABLE_NAME = c.TABLE_NAME
    WHERE t.TABLE_SCHEMA = DATABASE()
      AND c.EXTRA = 'auto_increment'
      AND t.AUTO_INCREMENT IS NOT NULL;
END;
```

**æ‰©å®¹æ–¹æ¡ˆ**ï¼š
```sql
-- å½“INTç±»å‹çš„è‡ªå¢IDæ¥è¿‘ä¸Šé™æ—¶ï¼Œå‡çº§ä¸ºBIGINT
ALTER TABLE users MODIFY id BIGINT AUTO_INCREMENT;

-- æ³¨æ„ï¼šè¿™ä¸ªæ“ä½œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå»ºè®®åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
```

---

## 7. ğŸ’¼ å®è·µåº”ç”¨ä¸ä¼˜åŒ–


### 7.1 å¸¸è§åº”ç”¨æ¨¡å¼


**ç”¨æˆ·æ³¨å†Œåœºæ™¯**ï¼š
```java
@Service
public class UserRegistrationService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Transactional
    public UserRegistrationResult registerUser(UserDto userDto) {
        
        // 1. æ’å…¥ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        User user = new User();
        user.setName(userDto.getName());
        user.setEmail(userDto.getEmail());
        
        User savedUser = userRepository.save(user);  // è‡ªåŠ¨è·å–ç”Ÿæˆçš„ID
        Long userId = savedUser.getId();
        
        // 2. ä½¿ç”¨ç”Ÿæˆçš„ç”¨æˆ·IDåˆ›å»ºç›¸å…³è®°å½•
        createUserProfile(userId, userDto.getProfile());
        createUserSettings(userId, defaultSettings());
        
        // 3. è¿”å›æ³¨å†Œç»“æœ
        return new UserRegistrationResult(userId, "æ³¨å†ŒæˆåŠŸ");
    }
    
    private void createUserProfile(Long userId, ProfileDto profile) {
        // ä½¿ç”¨è·å–åˆ°çš„ç”¨æˆ·IDåˆ›å»ºç”¨æˆ·èµ„æ–™
        UserProfile userProfile = new UserProfile();
        userProfile.setUserId(userId);  // å…³è”ç”¨æˆ·ID
        userProfile.setNickname(profile.getNickname());
        profileRepository.save(userProfile);
    }
}
```

**è®¢å•å¤„ç†åœºæ™¯**ï¼š
```java
@Service  
public class OrderService {
    
    @Transactional
    public OrderResult createOrder(OrderRequest request) {
        
        // 1. åˆ›å»ºä¸»è®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setTotalAmount(request.getTotalAmount());
        
        Order savedOrder = orderRepository.save(order);
        Long orderId = savedOrder.getId();  // è·å–è‡ªå¢çš„è®¢å•ID
        
        // 2. åˆ›å»ºè®¢å•è¯¦æƒ…ï¼ˆä½¿ç”¨è®¢å•IDï¼‰
        for (OrderItemDto item : request.getItems()) {
            OrderDetail detail = new OrderDetail();
            detail.setOrderId(orderId);      // å…³è”è®¢å•ID
            detail.setProductId(item.getProductId());
            detail.setQuantity(item.getQuantity());
            detail.setPrice(item.getPrice());
            
            orderDetailRepository.save(detail);
        }
        
        // 3. ç”Ÿæˆè®¢å•å·ï¼ˆåŸºäºè‡ªå¢IDï¼‰
        String orderNumber = "ORD" + String.format("%08d", orderId);
        
        return new OrderResult(orderId, orderNumber);
    }
}
```

### 7.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**æ‰¹é‡æ’å…¥ä¼˜åŒ–**ï¼š
```sql
-- ä¼˜åŒ–å‰ï¼šé€æ¡æ’å…¥ï¼ˆæ•ˆç‡ä½ï¼‰
INSERT INTO products (name, price) VALUES ('å•†å“1', 99.9);
INSERT INTO products (name, price) VALUES ('å•†å“2', 199.9);
INSERT INTO products (name, price) VALUES ('å•†å“3', 299.9);

-- ä¼˜åŒ–åï¼šæ‰¹é‡æ’å…¥ï¼ˆæ•ˆç‡é«˜ï¼‰
INSERT INTO products (name, price) VALUES 
('å•†å“1', 99.9),
('å•†å“2', 199.9),  
('å•†å“3', 299.9);

-- è·å–æ‰¹é‡æ’å…¥çš„IDèŒƒå›´
SELECT LAST_INSERT_ID() as first_id, 
       LAST_INSERT_ID() + ROW_COUNT() - 1 as last_id;
```

**è‡ªå¢é”ä¼˜åŒ–**ï¼š
```sql
-- é«˜å¹¶å‘åœºæ™¯ä¸‹çš„é…ç½®ä¼˜åŒ–
-- åœ¨my.cnfä¸­è®¾ç½®ï¼š

[mysqld]
# ä½¿ç”¨äº¤é”™æ¨¡å¼ï¼Œæœ€å¤§åŒ–å¹¶å‘æ€§èƒ½
innodb_autoinc_lock_mode = 2

# ä¼˜åŒ–å…¶ä»–ç›¸å…³å‚æ•°
innodb_lock_wait_timeout = 50
innodb_flush_log_at_trx_commit = 2
sync_binlog = 0  # éé‡‘èåœºæ™¯å¯ä»¥è®¾ç½®ä¸º0
```

### 7.3 åˆ†è¡¨åˆ†åº“ä¸­çš„è‡ªå¢ID


**åˆ†è¡¨åœºæ™¯çš„IDåˆ†é…**ï¼š
```
é—®é¢˜ï¼šåˆ†è¡¨åå¦‚ä½•ä¿è¯å…¨å±€IDå”¯ä¸€ï¼Ÿ

è§£å†³æ–¹æ¡ˆ1ï¼šä¸åŒè¡¨ä½¿ç”¨ä¸åŒçš„IDèŒƒå›´
è¡¨1ï¼šusers_001  è‡ªå¢èŒƒå›´ï¼š1-1000000
è¡¨2ï¼šusers_002  è‡ªå¢èŒƒå›´ï¼š1000001-2000000  
è¡¨3ï¼šusers_003  è‡ªå¢èŒƒå›´ï¼š2000001-3000000

è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ­¥é•¿åˆ†é…
è¡¨1ï¼šusers_001  æ­¥é•¿=3ï¼Œåç§»=1  â†’ 1,4,7,10...
è¡¨2ï¼šusers_002  æ­¥é•¿=3ï¼Œåç§»=2  â†’ 2,5,8,11...
è¡¨3ï¼šusers_003  æ­¥é•¿=3ï¼Œåç§»=3  â†’ 3,6,9,12...
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Component
public class ShardingIdGenerator {
    
    // åˆ†è¡¨IDç”Ÿæˆç­–ç•¥
    public Long generateShardedId(int shardIndex, int totalShards) {
        
        // æ–¹æ¡ˆï¼šä½¿ç”¨UUIDç”Ÿæˆå…¨å±€å”¯ä¸€ID
        // ä¼˜ç‚¹ï¼šç»å¯¹å”¯ä¸€ï¼Œç¼ºç‚¹ï¼šéé€’å¢ã€å ç”¨ç©ºé—´å¤§
        return Math.abs(UUID.randomUUID().getMostSignificantBits());
        
        // æˆ–è€…ä½¿ç”¨é›ªèŠ±ç®—æ³•
        // return snowflakeIdGenerator.generateId(shardIndex);
    }
    
    // åŸºäºæ—¶é—´æˆ³çš„IDç”Ÿæˆ
    public Long generateTimeBasedId() {
        // æ—¶é—´æˆ³(42ä½) + æœºå™¨ID(10ä½) + åºåˆ—å·(12ä½) = 64ä½
        long timestamp = System.currentTimeMillis() - 1609459200000L; // ä»2021å¹´å¼€å§‹
        long machineId = getMachineId();  // 0-1023
        long sequence = getNextSequence(); // 0-4095
        
        return (timestamp << 22) | (machineId << 12) | sequence;
    }
}
```

### 7.4 å¼‚å¸¸æƒ…å†µå¤„ç†


**æ’å…¥å¤±è´¥åçš„IDå¤„ç†**ï¼š
```java
@Service
public class RobustUserService {
    
    public UserResult insertUserWithRetry(UserDto userDto) {
        int maxRetries = 3;
        int currentTry = 0;
        
        while (currentTry < maxRetries) {
            try {
                // å°è¯•æ’å…¥ç”¨æˆ·
                Long userId = doInsertUser(userDto);
                return new UserResult(userId, "success");
                
            } catch (DuplicateKeyException e) {
                // å¤„ç†é‚®ç®±é‡å¤ç­‰ä¸šåŠ¡å¼‚å¸¸
                throw new BusinessException("é‚®ç®±å·²å­˜åœ¨");
                
            } catch (SQLException e) {
                currentTry++;
                if (currentTry >= maxRetries) {
                    throw new SystemException("æ’å…¥ç”¨æˆ·å¤±è´¥ï¼Œå·²é‡è¯•" + maxRetries + "æ¬¡");
                }
                
                // ç­‰å¾…åé‡è¯•
                try {
                    Thread.sleep(100 * currentTry);  // é€’å¢ç­‰å¾…æ—¶é—´
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new SystemException("æ’å…¥æ“ä½œè¢«ä¸­æ–­");
                }
            }
        }
        
        return null;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è‡ªå¢ä¸»é”®ï¼šMySQLè‡ªåŠ¨åˆ†é…é€’å¢çš„å”¯ä¸€IDï¼Œåƒé“¶è¡Œå–å·æœº
ğŸ”¸ LAST_INSERT_ID()ï¼šè·å–å½“å‰è¿æ¥æœ€åæ’å…¥çš„è‡ªå¢IDå€¼
ğŸ”¸ è¿æ¥éš”ç¦»ï¼šä¸åŒæ•°æ®åº“è¿æ¥çš„LAST_INSERT_ID()äº’ä¸å½±å“
ğŸ”¸ è‡ªå¢é”æ¨¡å¼ï¼šæ§åˆ¶å¹¶å‘æ’å…¥æ—¶çš„é”å®šç­–ç•¥ï¼Œå½±å“æ€§èƒ½
ğŸ”¸ IDåˆ†é…æœºåˆ¶ï¼šåŸºäºå†…å­˜è®¡æ•°å™¨ï¼Œä¿è¯å”¯ä¸€æ€§ä½†å¯èƒ½æœ‰é—´éš”
ğŸ”¸ æ‰¹é‡æ’å…¥ï¼šè¿”å›ç¬¬ä¸€æ¡è®°å½•çš„IDï¼Œéœ€è¦è®¡ç®—å…¶ä»–è®°å½•ID
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è‡ªå¢IDçš„ç‰¹æ€§**
```
å”¯ä¸€æ€§ï¼šç»å¯¹ä¸ä¼šé‡å¤ï¼Œå³ä½¿åˆ é™¤è®°å½•
é€’å¢æ€§ï¼šæ–°åˆ†é…çš„IDæ€»æ˜¯æ¯”ä¹‹å‰çš„å¤§
éè¿ç»­æ€§ï¼šå¯èƒ½æœ‰é—´éš”ï¼Œç‰¹åˆ«æ˜¯äº‹åŠ¡å›æ»šå
æŒä¹…æ€§ï¼šä¸€æ—¦åˆ†é…å°±ä¸ä¼šå›æ”¶æˆ–é‡å¤ä½¿ç”¨
```

**ğŸ”¹ å¹¶å‘å®‰å…¨çš„æœ¬è´¨**
```
è¿æ¥éš”ç¦»ï¼šæ¯ä¸ªæ•°æ®åº“è¿æ¥ç»´æŠ¤ç‹¬ç«‹çš„LAST_INSERT_IDå€¼
é”æœºåˆ¶ï¼šé€šè¿‡ä¸åŒçš„é”ç­–ç•¥ä¿è¯IDåˆ†é…çš„åŸå­æ€§
äº‹åŠ¡ä¿æŠ¤ï¼šåœ¨åŒä¸€äº‹åŠ¡ä¸­æ’å…¥å’Œè·å–IDæœ€å®‰å…¨
```

**ğŸ”¹ æ€§èƒ½ä¸ä¸€è‡´æ€§çš„å¹³è¡¡**
```
ä¼ ç»Ÿæ¨¡å¼(0)ï¼šä¸€è‡´æ€§æœ€é«˜ï¼Œæ€§èƒ½æœ€ä½
è¿ç»­æ¨¡å¼(1)ï¼šå¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½ï¼ˆæ¨èï¼‰
äº¤é”™æ¨¡å¼(2)ï¼šæ€§èƒ½æœ€é«˜ï¼Œä¸€è‡´æ€§è¦æ±‚è¾ƒä½
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‰æ‹©å»ºè®®**
- **Webåº”ç”¨**ï¼šä½¿ç”¨æ¨¡å¼1ï¼ˆé»˜è®¤ï¼‰ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨æ€§
- **é«˜å¹¶å‘ç³»ç»Ÿ**ï¼šè€ƒè™‘æ¨¡å¼2ï¼Œæ¥å—IDå¯èƒ½ä¸è¿ç»­
- **é‡‘èç³»ç»Ÿ**ï¼šä½¿ç”¨æ¨¡å¼0ï¼Œç¡®ä¿æ•°æ®ä¸¥æ ¼ä¸€è‡´æ€§
- **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šè€ƒè™‘ä½¿ç”¨UUIDæˆ–é›ªèŠ±ç®—æ³•æ›¿ä»£è‡ªå¢ID

**ğŸ¯ æœ€ä½³å®è·µ**
- ä½¿ç”¨`PreparedStatement.getGeneratedKeys()`è·å–IDï¼Œæ¯”`LAST_INSERT_ID()`æ›´å®‰å…¨
- åœ¨äº‹åŠ¡ä¸­å®Œæˆæ’å…¥å’ŒIDè·å–ï¼Œä¿è¯åŸå­æ€§
- ä¸ºå¯èƒ½æœ‰å¤§é‡æ•°æ®çš„è¡¨ä½¿ç”¨`BIGINT`ç±»å‹
- å®šæœŸç›‘æ§è‡ªå¢IDä½¿ç”¨ç‡ï¼Œæå‰è§„åˆ’æ‰©å®¹

**ğŸ¯ å¸¸è§é—®é¢˜å¤„ç†**
- IDä¸è¿ç»­ â†’ æ­£å¸¸ç°è±¡ï¼Œä¸å½±å“ä¸šåŠ¡
- è·å–é”™è¯¯ID â†’ æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€è¿æ¥ä¸­æ“ä½œ
- IDè€—å°½ â†’ æå‰ç›‘æ§ï¼ŒåŠæ—¶æ‰©å¤§æ•°æ®ç±»å‹
- å¹¶å‘å†²çª â†’ ä½¿ç”¨åˆé€‚çš„é”æ¨¡å¼å’Œäº‹åŠ¡ä¿æŠ¤

### 8.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


> ğŸ“– **è®°å¿†å£è¯€**ï¼š
> è‡ªå¢ä¸»é”®åƒå–å·ï¼Œåˆ†é…é€’å¢ä¸é‡å¤
> LAST_INSERT_IDè¿æ¥ç»‘ï¼Œå¹¶å‘å®‰å…¨æœ‰ä¿éšœ  
> é”æ¨¡å¼ä¸‰ç§è¦è®°æ¸…ï¼Œæ€§èƒ½ä¸€è‡´æ€§å¹³è¡¡
> ç”Ÿäº§ç¯å¢ƒç”¨BIGINTï¼Œç›‘æ§ä½¿ç”¨é˜²è€—å°½

**ğŸ”‘ æ ¸å¿ƒå…¬å¼**
```
æ‰¹é‡æ’å…¥IDèŒƒå›´è®¡ç®—ï¼š
èµ·å§‹ID = LAST_INSERT_ID()
ç»“æŸID = LAST_INSERT_ID() + ROW_COUNT() - 1

è‡ªå¢å€¼é‡ç½®è§„åˆ™ï¼š
æ–°è‡ªå¢å€¼ = MAX(å½“å‰è¡¨æœ€å¤§ID + 1, è®¾ç½®å€¼)

IDä½¿ç”¨ç‡è®¡ç®—ï¼š  
ä½¿ç”¨ç‡ = (å½“å‰è‡ªå¢å€¼ / æ•°æ®ç±»å‹æœ€å¤§å€¼) Ã— 100%
```

**å®é™…å·¥ä½œä¸­çš„åº”ç”¨ä»·å€¼**ï¼š
- **ä¸šåŠ¡å¼€å‘**ï¼šæ­£ç¡®è·å–æ’å…¥è®°å½•çš„IDï¼Œç”¨äºå…³è”æ“ä½œ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé€‰æ‹©åˆé€‚çš„è‡ªå¢é”æ¨¡å¼æå‡å¹¶å‘æ€§èƒ½
- **ç³»ç»Ÿè®¾è®¡**ï¼šç†è§£è‡ªå¢IDç‰¹æ€§ï¼Œåˆç†è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„
- **æ•…éšœæ’æŸ¥**ï¼šç†è§£è‡ªå¢æœºåˆ¶ï¼Œå¿«é€Ÿå®šä½IDç›¸å…³é—®é¢˜
- **å®¹é‡è§„åˆ’**ï¼šç›‘æ§IDä½¿ç”¨æƒ…å†µï¼Œæå‰è§„åˆ’ç³»ç»Ÿæ‰©å®¹