---
title: 12ã€æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [æ‰¹é‡æ’å…¥åŸºç¡€æ¦‚å¿µ](#1-æ‰¹é‡æ’å…¥åŸºç¡€æ¦‚å¿µ)
2. [æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥](#2-æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥)
3. [äº‹åŠ¡æ‰¹å¤§å°è°ƒä¼˜æŠ€æœ¯](#3-äº‹åŠ¡æ‰¹å¤§å°è°ƒä¼˜æŠ€æœ¯)
4. [å¤§æ‰¹é‡æ•°æ®å¯¼å…¥æŠ€æœ¯](#4-å¤§æ‰¹é‡æ•°æ®å¯¼å…¥æŠ€æœ¯)
5. [å¹¶è¡Œæ’å…¥ç­–ç•¥](#5-å¹¶è¡Œæ’å…¥ç­–ç•¥)
6. [æ’å…¥æ€§èƒ½åŸºå‡†æµ‹è¯•](#6-æ’å…¥æ€§èƒ½åŸºå‡†æµ‹è¯•)
7. [InnoDBå‚æ•°è°ƒä¼˜æ·±åº¦è§£æ](#7-innodbå‚æ•°è°ƒä¼˜æ·±åº¦è§£æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¾ æ‰¹é‡æ’å…¥åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‰¹é‡æ’å…¥


**ğŸ”¸ åŸºæœ¬å®šä¹‰**
```
æ‰¹é‡æ’å…¥ï¼šä¸€æ¬¡æ€§å‘æ•°æ®åº“æ’å…¥å¤§é‡æ•°æ®è®°å½•çš„æ“ä½œ
ç›®æ ‡ï¼šæé«˜æ•°æ®æ’å…¥æ•ˆç‡ï¼Œå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
åº”ç”¨åœºæ™¯ï¼šæ•°æ®è¿ç§»ã€ETLå¤„ç†ã€æ—¥å¿—å¯¼å…¥ã€åˆå§‹åŒ–æ•°æ®
```

**ğŸ”¸ å•æ¡æ’å…¥ vs æ‰¹é‡æ’å…¥å¯¹æ¯”**
```
å•æ¡æ’å…¥æ–¹å¼ï¼š
INSERT INTO users (name, email) VALUES ('å¼ ä¸‰', 'zhang@example.com');
INSERT INTO users (name, email) VALUES ('æå››', 'li@example.com');
INSERT INTO users (name, email) VALUES ('ç‹äº”', 'wang@example.com');
...

æ‰¹é‡æ’å…¥æ–¹å¼ï¼š
INSERT INTO users (name, email) VALUES 
('å¼ ä¸‰', 'zhang@example.com'),
('æå››', 'li@example.com'),
('ç‹äº”', 'wang@example.com'),
...
(100æ¡è®°å½•ä¸€æ¬¡æ€§æ’å…¥)

æ€§èƒ½å·®å¼‚ï¼š
å•æ¡æ’å…¥ï¼š1ä¸‡æ¡æ•°æ®éœ€è¦1ä¸‡æ¬¡ç½‘ç»œäº¤äº’
æ‰¹é‡æ’å…¥ï¼š1ä¸‡æ¡æ•°æ®åªéœ€è¦100æ¬¡äº¤äº’ï¼ˆæ¯æ‰¹100æ¡ï¼‰
æ•ˆç‡æå‡ï¼š10-100å€æ€§èƒ½æå‡
```

### 1.2 æ‰¹é‡æ’å…¥çš„ä¼˜åŠ¿


**âš¡ æ€§èƒ½ä¼˜åŠ¿åˆ†æ**
```
ç½‘ç»œäº¤äº’å‡å°‘ï¼š
â€¢ å•æ¬¡ï¼š1æ¡æ•°æ® = 1æ¬¡ç½‘ç»œå¾€è¿”
â€¢ æ‰¹é‡ï¼š100æ¡æ•°æ® = 1æ¬¡ç½‘ç»œå¾€è¿”
â€¢ ç½‘ç»œå»¶è¿Ÿå½±å“å¤§å¹…é™ä½

æ•°æ®åº“å¼€é”€å‡å°‘ï¼š
â€¢ SQLè§£ææ¬¡æ•°å‡å°‘
â€¢ æŸ¥è¯¢ä¼˜åŒ–å™¨è°ƒç”¨å‡å°‘
â€¢ é”è·å–å’Œé‡Šæ”¾æ¬¡æ•°å‡å°‘
â€¢ æ—¥å¿—å†™å…¥æ¬¡æ•°å‡å°‘

ç¼“å­˜åˆ©ç”¨ç‡æå‡ï¼š
â€¢ ç›¸åŒè¡¨çš„è¿ç»­æ“ä½œæé«˜ç¼“å­˜å‘½ä¸­
â€¢ å‡å°‘ç¼“å­˜é¡µé¢çš„é¢‘ç¹æ›¿æ¢
â€¢ æé«˜å†…å­˜åˆ©ç”¨æ•ˆç‡
```

### 1.3 æ‰¹é‡æ’å…¥é¢ä¸´çš„æŒ‘æˆ˜


**âš ï¸ å¸¸è§é—®é¢˜**
```
å†…å­˜å‹åŠ›ï¼š
â€¢ å¤§æ‰¹é‡æ•°æ®å ç”¨å¤§é‡å†…å­˜
â€¢ å¯èƒ½å¯¼è‡´ç³»ç»Ÿå†…å­˜ä¸è¶³
â€¢ å½±å“å…¶ä»–ä¸šåŠ¡æ­£å¸¸è¿è¡Œ

é”ç«äº‰åŠ å‰§ï¼š
â€¢ é•¿æ—¶é—´å ç”¨è¡¨é”æˆ–è¡Œé”
â€¢ é˜»å¡å…¶ä»–å¹¶å‘æ“ä½œ
â€¢ å¯èƒ½å¯¼è‡´æ­»é”

äº‹åŠ¡æ—¥å¿—å‹åŠ›ï¼š
â€¢ å¤§é‡æ•°æ®äº§ç”Ÿå¤§é‡äº‹åŠ¡æ—¥å¿—
â€¢ ç£ç›˜IOå‹åŠ›å¢å¤§
â€¢ å½±å“æ•°æ®åº“æ•´ä½“æ€§èƒ½

é”™è¯¯å¤„ç†å¤æ‚ï¼š
â€¢ æ‰¹é‡æ“ä½œä¸­éƒ¨åˆ†æ•°æ®å¤±è´¥å¤„ç†
â€¢ å›æ»šæ“ä½œä»£ä»·é«˜æ˜‚
â€¢ æ•°æ®ä¸€è‡´æ€§ä¿è¯å›°éš¾
```

---

## 2. ğŸš€ æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


### 2.1 æ‰¹é‡æ’å…¥è¯­å¥ä¼˜åŒ–


**ğŸ”¸ INSERTå¤šå€¼è¯­æ³•**
```sql
-- âœ… æ¨èï¼šå¤šå€¼æ’å…¥è¯­æ³•
INSERT INTO products (name, price, category_id) VALUES
('iPhone 15', 7999.00, 1),
('MacBook Pro', 15999.00, 2),
('iPad Air', 4599.00, 3),
('Apple Watch', 2999.00, 4);

-- âŒ é¿å…ï¼šå•æ¡æ’å…¥
INSERT INTO products (name, price, category_id) VALUES ('iPhone 15', 7999.00, 1);
INSERT INTO products (name, price, category_id) VALUES ('MacBook Pro', 15999.00, 2);
-- ... é‡å¤å¤šæ¬¡

æ€§èƒ½å¯¹æ¯”ï¼š
â€¢ å¤šå€¼æ’å…¥ï¼š1æ¬¡SQLè§£æï¼Œ1æ¬¡ç½‘ç»œäº¤äº’
â€¢ å•æ¡æ’å…¥ï¼šNæ¬¡SQLè§£æï¼ŒNæ¬¡ç½‘ç»œäº¤äº’
â€¢ æ€§èƒ½æå‡ï¼š10-50å€
```

**ğŸ”¸ æ‰¹é‡æ’å…¥æœ€ä½³å®è·µ**
```sql
-- æ–¹å¼1ï¼šINSERT INTO ... VALUESè¯­æ³•
INSERT INTO orders (user_id, product_id, quantity, price) VALUES
(1001, 2001, 2, 199.99),
(1002, 2002, 1, 299.99),
(1003, 2001, 3, 199.99);

-- æ–¹å¼2ï¼šINSERT INTO ... SELECTè¯­æ³•
INSERT INTO orders_backup (user_id, product_id, quantity, price)
SELECT user_id, product_id, quantity, price 
FROM orders 
WHERE created_at >= '2024-01-01';

-- æ–¹å¼3ï¼šLOAD DATA INFILEï¼ˆMySQLç‰¹æœ‰ï¼‰
LOAD DATA INFILE '/tmp/orders.csv'
INTO TABLE orders
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
(user_id, product_id, quantity, price);
```

### 2.2 è¡¨ç»“æ„ä¼˜åŒ–ç­–ç•¥


**ğŸ”§ ç´¢å¼•ä¼˜åŒ–**
```sql
-- æ’å…¥å‰çš„ç´¢å¼•ç­–ç•¥
-- âŒ é—®é¢˜ï¼šè¿‡å¤šç´¢å¼•å½±å“æ’å…¥æ€§èƒ½
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    price DECIMAL(10,2),
    category_id INT,
    description TEXT,
    created_at TIMESTAMP,
    
    -- è¿‡å¤šçš„ç´¢å¼•
    INDEX idx_name (name),
    INDEX idx_price (price), 
    INDEX idx_category (category_id),
    INDEX idx_created (created_at),
    INDEX idx_name_category (name, category_id)
);

-- âœ… ä¼˜åŒ–ï¼šæ’å…¥æ—¶æœ€å°ç´¢å¼•é›†
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    price DECIMAL(10,2),
    category_id INT,
    description TEXT,
    created_at TIMESTAMP
);
-- æ‰¹é‡æ’å…¥å®Œæˆåå†æ·»åŠ å¿…è¦ç´¢å¼•

-- æ’å…¥å®Œæˆåæ·»åŠ ç´¢å¼•
ALTER TABLE products ADD INDEX idx_category (category_id);
ALTER TABLE products ADD INDEX idx_name_price (name, price);
```

**âš¡ å­˜å‚¨å¼•æ“é€‰æ‹©**
```
InnoDB vs MyISAM æ’å…¥æ€§èƒ½å¯¹æ¯”ï¼š

InnoDBç‰¹ç‚¹ï¼š
â€¢ æ”¯æŒäº‹åŠ¡ï¼šæ•°æ®å®‰å…¨æ€§é«˜
â€¢ è¡Œçº§é”ï¼šå¹¶å‘æ€§èƒ½å¥½
â€¢ å¤–é”®çº¦æŸï¼šæ•°æ®å®Œæ•´æ€§å¼º
â€¢ æ’å…¥æ€§èƒ½ï¼šä¸­ç­‰ï¼Œä½†åŠŸèƒ½å®Œå–„

MyISAMç‰¹ç‚¹ï¼š
â€¢ è¡¨çº§é”ï¼šæ’å…¥æ—¶é”æ•´å¼ è¡¨
â€¢ æ— äº‹åŠ¡ï¼šæ’å…¥é€Ÿåº¦å¿«ï¼Œä½†é£é™©é«˜
â€¢ æ’å…¥æ€§èƒ½ï¼šæé«˜ï¼Œä½†åŠŸèƒ½å—é™

é€‰æ‹©å»ºè®®ï¼š
â€¢ ç”Ÿäº§ç¯å¢ƒï¼šä¼˜å…ˆé€‰æ‹©InnoDB
â€¢ ä¸´æ—¶å¯¼å…¥ï¼šå¯è€ƒè™‘MyISAMï¼Œå®Œæˆåè½¬æ¢
```

### 2.3 ç³»ç»Ÿå‚æ•°è°ƒä¼˜


**ğŸ”§ å…³é”®å‚æ•°ä¼˜åŒ–**
```sql
-- æ’å…¥æ€§èƒ½ç›¸å…³å‚æ•°è°ƒä¼˜
SET SESSION sql_log_bin = 0;                    -- å…³é—­äºŒè¿›åˆ¶æ—¥å¿—
SET SESSION unique_checks = 0;                  -- å…³é—­å”¯ä¸€æ€§æ£€æŸ¥
SET SESSION foreign_key_checks = 0;             -- å…³é—­å¤–é”®æ£€æŸ¥
SET SESSION autocommit = 0;                     -- å…³é—­è‡ªåŠ¨æäº¤

-- æ‰¹é‡æ’å…¥æ“ä½œ
START TRANSACTION;
INSERT INTO products VALUES (...), (...), (...);
-- ... å¤šæ‰¹æ¬¡æ’å…¥
COMMIT;

-- æ¢å¤è®¾ç½®
SET SESSION sql_log_bin = 1;
SET SESSION unique_checks = 1;
SET SESSION foreign_key_checks = 1;
SET SESSION autocommit = 1;
```

**ğŸ“Š å‚æ•°è°ƒä¼˜æ•ˆæœ**
| å‚æ•°è®¾ç½® | **æ€§èƒ½å½±å“** | **ä½¿ç”¨åœºæ™¯** | **é£é™©è¯„ä¼°** |
|---------|-------------|-------------|-------------|
| `sql_log_bin=0` | `æå‡20-30%` | `æ•°æ®è¿ç§»` | `æ— ä¸»ä»åŒæ­¥` |
| `unique_checks=0` | `æå‡10-20%` | `å¯ä¿¡æ•°æ®æº` | `å¯èƒ½äº§ç”Ÿé‡å¤æ•°æ®` |
| `foreign_key_checks=0` | `æå‡15-25%` | `æ•°æ®å¯¼å…¥` | `æ•°æ®å®Œæ•´æ€§é£é™©` |
| `autocommit=0` | `æå‡30-50%` | `å¤§æ‰¹é‡æ“ä½œ` | `éœ€æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†` |

---

## 3. ğŸ“¦ äº‹åŠ¡æ‰¹å¤§å°è°ƒä¼˜æŠ€æœ¯


### 3.1 äº‹åŠ¡æ‰¹å¤§å°çš„é‡è¦æ€§


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº‹åŠ¡æ‰¹å¤§å°**
```
äº‹åŠ¡æ‰¹å¤§å°ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­åŒ…å«çš„æ•°æ®è®°å½•æ•°é‡
å½±å“å› ç´ ï¼šå†…å­˜ä½¿ç”¨ã€é”æŒæœ‰æ—¶é—´ã€å›æ»šä»£ä»·ã€æ€§èƒ½è¡¨ç°

ç¤ºä¾‹å¯¹æ¯”ï¼š
å°æ‰¹é‡ï¼ˆ100æ¡/äº‹åŠ¡ï¼‰ï¼š
START TRANSACTION;
INSERT INTO table VALUES (...100æ¡æ•°æ®...);
COMMIT;

å¤§æ‰¹é‡ï¼ˆ10000æ¡/äº‹åŠ¡ï¼‰ï¼š
START TRANSACTION;  
INSERT INTO table VALUES (...10000æ¡æ•°æ®...);
COMMIT;
```

**âš–ï¸ æ‰¹å¤§å°æƒè¡¡åˆ†æ**
```
å°æ‰¹é‡äº‹åŠ¡ï¼ˆ100-1000æ¡ï¼‰ï¼š
âœ… ä¼˜åŠ¿ï¼š
â€¢ å†…å­˜å ç”¨å°‘
â€¢ é”æŒæœ‰æ—¶é—´çŸ­
â€¢ å›æ»šä»£ä»·å°
â€¢ å¯¹å…¶ä»–äº‹åŠ¡å½±å“å°

âŒ åŠ£åŠ¿ï¼š
â€¢ äº‹åŠ¡å¼€é”€ç›¸å¯¹è¾ƒé«˜
â€¢ æ€»ä½“æ€§èƒ½å¯èƒ½ä¸æ˜¯æœ€ä¼˜

å¤§æ‰¹é‡äº‹åŠ¡ï¼ˆ5000-10000æ¡ï¼‰ï¼š
âœ… ä¼˜åŠ¿ï¼š
â€¢ äº‹åŠ¡å¼€é”€åˆ†æ‘Šï¼Œæ€»ä½“æ€§èƒ½é«˜
â€¢ å‡å°‘äº‹åŠ¡æäº¤æ¬¡æ•°

âŒ åŠ£åŠ¿ï¼š
â€¢ å†…å­˜å ç”¨å¤§
â€¢ é”æŒæœ‰æ—¶é—´é•¿
â€¢ å›æ»šä»£ä»·é«˜
â€¢ å¯èƒ½é˜»å¡å…¶ä»–æ“ä½œ
```

### 3.2 æœ€ä¼˜æ‰¹å¤§å°æµ‹ç®—æ–¹æ³•


**ğŸ§® æ‰¹å¤§å°è®¡ç®—å…¬å¼**
```
åŸºç¡€è€ƒè™‘å› ç´ ï¼š
â€¢ å¯ç”¨å†…å­˜å¤§å°
â€¢ å•æ¡è®°å½•å¤§å°
â€¢ å¹¶å‘äº‹åŠ¡æ•°é‡
â€¢ ä¸šåŠ¡å®¹é”™è¦æ±‚

æ¨èè®¡ç®—æ–¹æ³•ï¼š
æ‰¹å¤§å° = min(
    å¯ç”¨å†…å­˜ / (å•æ¡è®°å½•å¤§å° Ã— å®‰å…¨ç³»æ•°),
    æœ€å¤§å¯æ¥å—é”æ—¶é—´ / å•æ¡æ’å…¥æ—¶é—´,
    æœ€å¤§å¯æ¥å—å›æ»šé‡
)

å®é™…ç¤ºä¾‹ï¼š
å¯ç”¨å†…å­˜ï¼š1GB = 1,073,741,824å­—èŠ‚
å•æ¡è®°å½•ï¼š1KB = 1,024å­—èŠ‚
å®‰å…¨ç³»æ•°ï¼š0.1ï¼ˆé¢„ç•™90%å†…å­˜ç»™å…¶ä»–æ“ä½œï¼‰
ç†è®ºæ‰¹å¤§å°ï¼š1,073,741,824 Ã— 0.1 Ã· 1,024 â‰ˆ 104,857æ¡

å®é™…æ¨èï¼š5,000-10,000æ¡ï¼ˆè€ƒè™‘é”ç«äº‰ï¼‰
```

### 3.3 åŠ¨æ€æ‰¹å¤§å°è°ƒæ•´


**ğŸ“ˆ è‡ªé€‚åº”æ‰¹å¤§å°ç®—æ³•**
```java
public class DynamicBatchInserter {
    private int currentBatchSize = 1000;  // åˆå§‹æ‰¹å¤§å°
    private final int MIN_BATCH_SIZE = 100;
    private final int MAX_BATCH_SIZE = 10000;
    private long lastInsertTime = 0;
    private double targetThroughput = 1000; // ç›®æ ‡ï¼šæ¯ç§’1000æ¡
    
    public void insertBatch(List<Record> records) {
        int batchCount = (records.size() + currentBatchSize - 1) / currentBatchSize;
        
        for (int i = 0; i < batchCount; i++) {
            long startTime = System.currentTimeMillis();
            
            int startIdx = i * currentBatchSize;
            int endIdx = Math.min(startIdx + currentBatchSize, records.size());
            List<Record> batch = records.subList(startIdx, endIdx);
            
            // æ‰§è¡Œæ‰¹é‡æ’å…¥
            executeBatchInsert(batch);
            
            long endTime = System.currentTimeMillis();
            long insertTime = endTime - startTime;
            
            // åŠ¨æ€è°ƒæ•´æ‰¹å¤§å°
            adjustBatchSize(batch.size(), insertTime);
        }
    }
    
    private void adjustBatchSize(int actualBatchSize, long insertTime) {
        double actualThroughput = actualBatchSize * 1000.0 / insertTime;
        
        if (actualThroughput < targetThroughput * 0.8) {
            // æ€§èƒ½ä¸è¾¾æ ‡ï¼Œå°è¯•å‡å°æ‰¹å¤§å°
            currentBatchSize = Math.max(MIN_BATCH_SIZE, 
                (int)(currentBatchSize * 0.8));
        } else if (actualThroughput > targetThroughput * 1.2) {
            // æ€§èƒ½è¶…é¢„æœŸï¼Œå°è¯•å¢å¤§æ‰¹å¤§å°
            currentBatchSize = Math.min(MAX_BATCH_SIZE, 
                (int)(currentBatchSize * 1.2));
        }
        
        System.out.println("è°ƒæ•´æ‰¹å¤§å°: " + currentBatchSize + 
                          ", ååé‡: " + actualThroughput + " æ¡/ç§’");
    }
}
```

### 3.4 ä¸åŒåœºæ™¯çš„æ‰¹å¤§å°å»ºè®®


**ğŸ“‹ åœºæ™¯åŒ–é…ç½®æŒ‡å—**
```
ğŸ”¸ OLTPç³»ç»Ÿï¼ˆåœ¨çº¿äº‹åŠ¡å¤„ç†ï¼‰
æ¨èæ‰¹å¤§å°ï¼š100-500æ¡
åŸå› ï¼š
â€¢ éœ€è¦å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚
â€¢ é”æŒæœ‰æ—¶é—´è¦çŸ­
â€¢ å†…å­˜ä½¿ç”¨è¦æ§åˆ¶
â€¢ å¹¶å‘å†²çªè¦æœ€å°åŒ–

ğŸ”¸ OLAPç³»ç»Ÿï¼ˆæ•°æ®ä»“åº“ï¼‰
æ¨èæ‰¹å¤§å°ï¼š5,000-50,000æ¡
åŸå› ï¼š
â€¢ æŸ¥è¯¢æ€§èƒ½ä¼˜å…ˆ
â€¢ å¯ä»¥æ¥å—è¾ƒé•¿çš„æ’å…¥æ—¶é—´
â€¢ é€šå¸¸åœ¨éä¸šåŠ¡é«˜å³°æœŸæ“ä½œ
â€¢ å†…å­˜èµ„æºç›¸å¯¹å……è¶³

ğŸ”¸ ETLæ•°æ®å¤„ç†
æ¨èæ‰¹å¤§å°ï¼š1,000-10,000æ¡
åŸå› ï¼š
â€¢ å¹³è¡¡æ€§èƒ½å’Œèµ„æºä½¿ç”¨
â€¢ éœ€è¦è€ƒè™‘æ•°æ®è´¨é‡æ£€æŸ¥
â€¢ é”™è¯¯å›æ»šä»£ä»·è¦å¯æ§
â€¢ å¤„ç†æ—¶é—´çª—å£æœ‰é™åˆ¶

ğŸ”¸ æ—¥å¿—æ•°æ®å¯¼å…¥
æ¨èæ‰¹å¤§å°ï¼š10,000-100,000æ¡
åŸå› ï¼š
â€¢ æ•°æ®ç»“æ„ç®€å•
â€¢ å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜
â€¢ å¯ä»¥å……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æº
â€¢ é”™è¯¯å¤„ç†ç›¸å¯¹ç®€å•
```

---

## 4. ğŸ—ï¸ å¤§æ‰¹é‡æ•°æ®å¯¼å…¥æŠ€æœ¯


### 4.1 LOAD DATA INFILEæŠ€æœ¯


**ğŸ”¸ LOAD DATAåŸºç¡€è¯­æ³•**
```sql
-- åŸºæœ¬è¯­æ³•
LOAD DATA INFILE '/path/to/data.csv'
INTO TABLE target_table
FIELDS TERMINATED BY ','          -- å­—æ®µåˆ†éš”ç¬¦
OPTIONALLY ENCLOSED BY '"'        -- å­—æ®µåŒ…å›´ç¬¦
LINES TERMINATED BY '\n'          -- è¡Œåˆ†éš”ç¬¦
IGNORE 1 ROWS                     -- å¿½ç•¥æ ‡é¢˜è¡Œ
(column1, column2, column3);       -- æŒ‡å®šåˆ—æ˜ å°„

-- é«˜çº§é…ç½®
LOAD DATA INFILE '/tmp/products.csv'
INTO TABLE products
CHARACTER SET utf8mb4
FIELDS 
    TERMINATED BY ',' 
    OPTIONALLY ENCLOSED BY '"'
    ESCAPED BY '\\'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS
(name, price, @category_name, description)
SET 
    category_id = (SELECT id FROM categories WHERE name = @category_name),
    created_at = NOW();
```

**âš¡ LOAD DATAæ€§èƒ½ä¼˜åŒ–**
```sql
-- æ€§èƒ½ä¼˜åŒ–è®¾ç½®
SET SESSION foreign_key_checks = 0;
SET SESSION unique_checks = 0;
SET SESSION sql_log_bin = 0;

-- è°ƒæ•´ç¼“å†²åŒºå¤§å°
SET SESSION bulk_insert_buffer_size = 256 * 1024 * 1024;  -- 256MB

-- æ‰§è¡Œå¯¼å…¥
LOAD DATA INFILE '/tmp/large_data.csv'
INTO TABLE large_table
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';

-- æ¢å¤è®¾ç½®
SET SESSION foreign_key_checks = 1;
SET SESSION unique_checks = 1;
SET SESSION sql_log_bin = 1;

æ€§èƒ½è¡¨ç°ï¼š
â€¢ æ™®é€šINSERTï¼š10ä¸‡æ¡æ•°æ®çº¦éœ€è¦5-10åˆ†é’Ÿ
â€¢ LOAD DATAï¼š10ä¸‡æ¡æ•°æ®çº¦éœ€è¦10-30ç§’
â€¢ æ€§èƒ½æå‡ï¼š10-20å€
```

### 4.2 åˆ†åŒºè¡¨æ‰¹é‡å¯¼å…¥


**ğŸ”¸ æ—¶é—´åˆ†åŒºæ‰¹é‡å¯¼å…¥**
```sql
-- åˆ›å»ºæŒ‰æœˆåˆ†åŒºçš„è®¢å•è¡¨
CREATE TABLE orders (
    id BIGINT AUTO_INCREMENT,
    user_id INT,
    order_date DATE,
    amount DECIMAL(10,2),
    PRIMARY KEY (id, order_date)
)
PARTITION BY RANGE (YEAR(order_date) * 100 + MONTH(order_date)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    PARTITION p202404 VALUES LESS THAN (202405)
);

-- åˆ†åŒºå¹¶è¡Œå¯¼å…¥ç­–ç•¥
-- ä¸åŒåˆ†åŒºå¯ä»¥å¹¶è¡Œæ’å…¥ï¼Œæé«˜æ•ˆç‡
INSERT INTO orders (user_id, order_date, amount) VALUES
-- 2024å¹´1æœˆæ•°æ® â†’ è‡ªåŠ¨è·¯ç”±åˆ°p202401åˆ†åŒº
(1001, '2024-01-15', 299.99),
(1002, '2024-01-20', 199.99);

-- 2024å¹´2æœˆæ•°æ® â†’ è‡ªåŠ¨è·¯ç”±åˆ°p202402åˆ†åŒº  
INSERT INTO orders (user_id, order_date, amount) VALUES
(1003, '2024-02-10', 399.99),
(1004, '2024-02-25', 599.99);
```

### 4.3 ä¸´æ—¶è¡¨å¯¼å…¥ç­–ç•¥


**ğŸ”¸ ä¸¤é˜¶æ®µå¯¼å…¥æ–¹æ³•**
```sql
-- ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿå¯¼å…¥åˆ°ä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_products (
    name VARCHAR(100),
    price DECIMAL(10,2),
    category_name VARCHAR(50),
    description TEXT
) ENGINE=MyISAM;  -- ä½¿ç”¨MyISAMæé«˜å¯¼å…¥é€Ÿåº¦

-- å¿«é€Ÿå¯¼å…¥åŸå§‹æ•°æ®ï¼ˆæ— çº¦æŸæ£€æŸ¥ï¼‰
LOAD DATA INFILE '/tmp/products.csv'
INTO TABLE temp_products
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';

-- ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®æ¸…æ´—å¹¶è½¬ç§»åˆ°æ­£å¼è¡¨
INSERT INTO products (name, price, category_id, description)
SELECT 
    t.name,
    t.price,
    c.id as category_id,
    t.description
FROM temp_products t
LEFT JOIN categories c ON c.name = t.category_name
WHERE t.name IS NOT NULL 
  AND t.price > 0
  AND c.id IS NOT NULL;

-- æ¸…ç†ä¸´æ—¶è¡¨
DROP TEMPORARY TABLE temp_products;

ä¼˜åŠ¿åˆ†æï¼š
â€¢ ç¬¬ä¸€é˜¶æ®µï¼šæœ€é«˜é€Ÿåº¦å¯¼å…¥åŸå§‹æ•°æ®
â€¢ ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®è´¨é‡ä¿è¯å’Œä¸šåŠ¡é€»è¾‘å¤„ç†
â€¢ æ€»ä½“æ•ˆç‡ï¼šæ¯”ç›´æ¥å¯¼å…¥æ­£å¼è¡¨å¿«2-3å€
```

---

## 5. ğŸ”€ å¹¶è¡Œæ’å…¥ç­–ç•¥


### 5.1 å¤šçº¿ç¨‹å¹¶è¡Œæ’å…¥æ¶æ„


**ğŸ”¸ å¹¶è¡Œæ’å…¥è®¾è®¡åŸç†**
```
å•çº¿ç¨‹æ’å…¥æ¨¡å¼ï¼š
çº¿ç¨‹1 â†’ [æ•°æ®1-1000] â†’ æ•°æ®åº“
       [æ•°æ®1001-2000] â†’ æ•°æ®åº“  
       [æ•°æ®2001-3000] â†’ æ•°æ®åº“

å¤šçº¿ç¨‹å¹¶è¡Œæ¨¡å¼ï¼š
çº¿ç¨‹1 â†’ [æ•°æ®1-1000]    â†˜
çº¿ç¨‹2 â†’ [æ•°æ®1001-2000]  â†’ æ•°æ®åº“
çº¿ç¨‹3 â†’ [æ•°æ®2001-3000]  â†—

ç†è®ºæ€§èƒ½æå‡ï¼š
â€¢ 4æ ¸CPUï¼šæœ€å¤š4å€æ€§èƒ½æå‡
â€¢ å®é™…æå‡ï¼š2-3å€ï¼ˆè€ƒè™‘é”ç«äº‰ï¼‰
```

**ğŸ”§ Javaå¹¶è¡Œæ’å…¥å®ç°**
```java
public class ParallelBatchInserter {
    private final DataSource dataSource;
    private final int threadCount;
    private final int batchSize;
    private final ExecutorService executor;
    
    public ParallelBatchInserter(DataSource dataSource, int threadCount, int batchSize) {
        this.dataSource = dataSource;
        this.threadCount = threadCount;
        this.batchSize = batchSize;
        this.executor = Executors.newFixedThreadPool(threadCount);
    }
    
    public void insertInParallel(List<Product> products) throws Exception {
        // æ•°æ®åˆ†ç‰‡
        List<List<Product>> batches = partitionData(products, batchSize);
        List<Future<Integer>> futures = new ArrayList<>();
        
        // æäº¤å¹¶è¡Œä»»åŠ¡
        for (List<Product> batch : batches) {
            Future<Integer> future = executor.submit(() -> {
                return insertBatch(batch);
            });
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        int totalInserted = 0;
        for (Future<Integer> future : futures) {
            totalInserted += future.get();
        }
        
        System.out.println("å¹¶è¡Œæ’å…¥å®Œæˆï¼Œæ€»è®¡: " + totalInserted + " æ¡è®°å½•");
    }
    
    private int insertBatch(List<Product> batch) {
        String sql = "INSERT INTO products (name, price, category_id) VALUES (?, ?, ?)";
        
        try (Connection conn = dataSource.getConnection()) {
            conn.setAutoCommit(false);  // æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†
            
            try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                for (Product product : batch) {
                    pstmt.setString(1, product.getName());
                    pstmt.setBigDecimal(2, product.getPrice());
                    pstmt.setInt(3, product.getCategoryId());
                    pstmt.addBatch();
                }
                
                int[] results = pstmt.executeBatch();
                conn.commit();
                
                return Arrays.stream(results).sum();
            } catch (Exception e) {
                conn.rollback();
                throw e;
            }
        } catch (SQLException e) {
            throw new RuntimeException("æ‰¹é‡æ’å…¥å¤±è´¥", e);
        }
    }
    
    // æ•°æ®åˆ†ç‰‡æ–¹æ³•
    private <T> List<List<T>> partitionData(List<T> data, int partitionSize) {
        List<List<T>> partitions = new ArrayList<>();
        for (int i = 0; i < data.size(); i += partitionSize) {
            int endIndex = Math.min(i + partitionSize, data.size());
            partitions.add(data.subList(i, endIndex));
        }
        return partitions;
    }
}
```

### 5.2 åˆ†è¡¨å¹¶è¡Œæ’å…¥


**ğŸ”¸ åˆ†è¡¨ç­–ç•¥è®¾è®¡**
```sql
-- æŒ‰æ—¶é—´åˆ†è¡¨
CREATE TABLE orders_202401 (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    order_date DATE,
    amount DECIMAL(10,2),
    INDEX idx_user_date (user_id, order_date)
);

CREATE TABLE orders_202402 (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id INT, 
    order_date DATE,
    amount DECIMAL(10,2),
    INDEX idx_user_date (user_id, order_date)
);

-- å¹¶è¡Œæ’å…¥ä¸åŒåˆ†è¡¨
-- çº¿ç¨‹1å¤„ç†1æœˆæ•°æ®
INSERT INTO orders_202401 (user_id, order_date, amount) VALUES ...;

-- çº¿ç¨‹2å¤„ç†2æœˆæ•°æ®  
INSERT INTO orders_202402 (user_id, order_date, amount) VALUES ...;

ä¼˜åŠ¿ï¼š
â€¢ ä¸åŒè¡¨ä¹‹é—´æ— é”ç«äº‰
â€¢ å¯ä»¥å®ç°çœŸæ­£çš„å¹¶è¡Œæ’å…¥
â€¢ æ¯ä¸ªè¡¨å¯ä»¥ç‹¬ç«‹ä¼˜åŒ–
```

### 5.3 å¹¶è¡Œæ’å…¥æœ€ä½³å®è·µ


**âœ… å¹¶è¡Œæ’å…¥ä¼˜åŒ–è¦ç‚¹**
```
çº¿ç¨‹æ•°é‡æ§åˆ¶ï¼š
â€¢ CPUå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸æ•°
â€¢ IOå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— 2
â€¢ æ•°æ®åº“è¿æ¥æ± é™åˆ¶ï¼šä¸è¶…è¿‡æœ€å¤§è¿æ¥æ•°

é¿å…çƒ­ç‚¹ç«äº‰ï¼š
â€¢ é¿å…æ’å…¥ç›¸åŒçš„ç´¢å¼•çƒ­ç‚¹
â€¢ ä½¿ç”¨UUIDä»£æ›¿è‡ªå¢IDï¼ˆåˆ†æ•£æ’å…¥ç‚¹ï¼‰
â€¢ åˆ†è¡¨åˆ†åŒºå‡å°‘é”ç«äº‰

é”™è¯¯å¤„ç†ç­–ç•¥ï¼š
â€¢ æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹äº‹åŠ¡ç®¡ç†
â€¢ å¤±è´¥é‡è¯•æœºåˆ¶
â€¢ éƒ¨åˆ†å¤±è´¥ä¸å½±å“æ•´ä½“è¿›åº¦
â€¢ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
```

**âš ï¸ å¹¶è¡Œæ’å…¥æ³¨æ„äº‹é¡¹**
```
èµ„æºç«äº‰é—®é¢˜ï¼š
â€¢ æ•°æ®åº“è¿æ¥æ± è€—å°½
â€¢ ç£ç›˜IOç“¶é¢ˆ
â€¢ å†…å­˜ä½¿ç”¨è¿‡é‡
â€¢ CPUè¿‡è½½

è§£å†³æ–¹æ¡ˆï¼š
â€¢ é™åˆ¶å¹¶å‘çº¿ç¨‹æ•°
â€¢ ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
â€¢ å®ç°å›å‹æœºåˆ¶
â€¢ åŠ¨æ€è°ƒæ•´å¹¶å‘åº¦
```

---

## 6. ğŸ“Š æ’å…¥æ€§èƒ½åŸºå‡†æµ‹è¯•


### 6.1 æ€§èƒ½æµ‹è¯•æŒ‡æ ‡ä½“ç³»


**ğŸ”¸ æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡**
```
ååé‡æŒ‡æ ‡ï¼š
â€¢ TPS (Transactions Per Second)ï¼šæ¯ç§’äº‹åŠ¡æ•°
â€¢ RPS (Records Per Second)ï¼šæ¯ç§’æ’å…¥è®°å½•æ•°
â€¢ æ‰¹é‡å¤§å°æ•ˆç‡ï¼šä¸åŒæ‰¹å¤§å°çš„æ€§èƒ½è¡¨ç°

å»¶è¿ŸæŒ‡æ ‡ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´ï¼šæ‰¹é‡æ“ä½œçš„å¹³å‡è€—æ—¶
â€¢ 95åˆ†ä½å“åº”æ—¶é—´ï¼š95%æ“ä½œçš„å“åº”æ—¶é—´
â€¢ æœ€å¤§å“åº”æ—¶é—´ï¼šæœ€æ…¢æ“ä½œçš„è€—æ—¶

èµ„æºä½¿ç”¨æŒ‡æ ‡ï¼š
â€¢ CPUä½¿ç”¨ç‡ï¼šå¤„ç†å™¨è´Ÿè½½æƒ…å†µ
â€¢ å†…å­˜ä½¿ç”¨ç‡ï¼šå†…å­˜å ç”¨æƒ…å†µ  
â€¢ ç£ç›˜IOï¼šè¯»å†™æ“ä½œé¢‘ç‡å’Œååé‡
â€¢ ç½‘ç»œIOï¼šæ•°æ®ä¼ è¾“é‡
```

### 6.2 åŸºå‡†æµ‹è¯•å®ç°


**ğŸ§ª æ€§èƒ½æµ‹è¯•æ¡†æ¶**
```java
public class InsertPerformanceBenchmark {
    private final DataSource dataSource;
    private final int[] batchSizes = {100, 500, 1000, 5000, 10000};
    private final int totalRecords = 100000;
    
    public void runBenchmark() {
        System.out.println("æ‰¹é‡æ’å…¥æ€§èƒ½åŸºå‡†æµ‹è¯•");
        System.out.println("æ€»è®°å½•æ•°: " + totalRecords);
        System.out.println("=" + "=".repeat(80));
        
        for (int batchSize : batchSizes) {
            BenchmarkResult result = testBatchSize(batchSize);
            printResult(batchSize, result);
        }
    }
    
    private BenchmarkResult testBatchSize(int batchSize) {
        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        List<TestRecord> testData = generateTestData(totalRecords);
        
        long startTime = System.currentTimeMillis();
        long startMemory = getUsedMemory();
        
        // æ‰§è¡Œæ‰¹é‡æ’å…¥
        int insertedCount = 0;
        try {
            insertedCount = batchInsert(testData, batchSize);
        } catch (Exception e) {
            System.err.println("æ‰¹å¤§å° " + batchSize + " æµ‹è¯•å¤±è´¥: " + e.getMessage());
            return null;
        }
        
        long endTime = System.currentTimeMillis();
        long endMemory = getUsedMemory();
        
        return new BenchmarkResult(
            insertedCount,
            endTime - startTime,
            endMemory - startMemory,
            (double) insertedCount / ((endTime - startTime) / 1000.0)
        );
    }
    
    private void printResult(int batchSize, BenchmarkResult result) {
        if (result == null) return;
        
        System.out.printf("æ‰¹å¤§å°: %5d | è€—æ—¶: %6dms | å†…å­˜: %4dMB | TPS: %8.1f\n",
            batchSize, 
            result.getElapsedTime(),
            result.getMemoryUsed() / 1024 / 1024,
            result.getThroughput()
        );
    }
    
    // æµ‹è¯•ç»“æœç±»
    public static class BenchmarkResult {
        private final int recordCount;
        private final long elapsedTime;
        private final long memoryUsed;
        private final double throughput;
        
        // æ„é€ å‡½æ•°å’Œgetteræ–¹æ³•...
    }
}
```

### 6.3 æ€§èƒ½æµ‹è¯•ç»“æœåˆ†æ


**ğŸ“ˆ å…¸å‹æµ‹è¯•ç»“æœ**
```
æµ‹è¯•ç¯å¢ƒï¼š
â€¢ CPU: 8æ ¸å¿ƒ Intel i7
â€¢ å†…å­˜: 16GB DDR4
â€¢ ç£ç›˜: SSD
â€¢ æ•°æ®åº“: MySQL 8.0

æµ‹è¯•ç»“æœï¼š
æ‰¹å¤§å°: 100   | è€—æ—¶: 45000ms | å†…å­˜:   50MB | TPS:   2222.2
æ‰¹å¤§å°: 500   | è€—æ—¶: 12000ms | å†…å­˜:  120MB | TPS:   8333.3  
æ‰¹å¤§å°: 1000  | è€—æ—¶:  8000ms | å†…å­˜:  200MB | TPS:  12500.0
æ‰¹å¤§å°: 5000  | è€—æ—¶:  4000ms | å†…å­˜:  800MB | TPS:  25000.0  â† æœ€ä¼˜
æ‰¹å¤§å°: 10000 | è€—æ—¶:  5000ms | å†…å­˜: 1500MB | TPS:  20000.0

åˆ†æç»“è®ºï¼š
â€¢ æœ€ä¼˜æ‰¹å¤§å°ï¼š5000æ¡ï¼ˆæœ¬ç¯å¢ƒä¸‹ï¼‰
â€¢ æ‰¹å¤§å°è¿‡å°ï¼šç½‘ç»œäº¤äº’å¼€é”€å¤§
â€¢ æ‰¹å¤§å°è¿‡å¤§ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œæ€§èƒ½åè€Œä¸‹é™
â€¢ æœ€ä¼˜ç‚¹ï¼šæ€§èƒ½å’Œèµ„æºä½¿ç”¨çš„å¹³è¡¡ç‚¹
```

### 6.4 æ€§èƒ½ç“¶é¢ˆè¯†åˆ«


**ğŸ” ç“¶é¢ˆåˆ†ææ–¹æ³•**
```sql
-- ç›‘æ§æ’å…¥æ“ä½œçš„æ€§èƒ½
SHOW GLOBAL STATUS LIKE 'Com_insert%';
SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool%';
SHOW GLOBAL STATUS LIKE 'Innodb_log%';

-- åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
SELECT 
    query_time,
    lock_time, 
    rows_affected,
    sql_text
FROM mysql.slow_log 
WHERE sql_text LIKE '%INSERT%'
ORDER BY query_time DESC;

-- å®æ—¶ç›‘æ§æ’å…¥æ€§èƒ½
SHOW PROCESSLIST;
SHOW ENGINE INNODB STATUS;
```

**ğŸ“Š ç“¶é¢ˆç±»å‹ä¸è§£å†³æ–¹æ¡ˆ**
| ç“¶é¢ˆç±»å‹ | **ç—‡çŠ¶è¡¨ç°** | **è§£å†³æ–¹æ¡ˆ** | **é¢„æœŸæå‡** |
|---------|-------------|-------------|-------------|
| **CPUç“¶é¢ˆ** | `CPUä½¿ç”¨ç‡>90%` | `å‡å°‘æ‰¹å¤§å°ï¼Œå¢åŠ çº¿ç¨‹æ•°` | `20-30%` |
| **å†…å­˜ç“¶é¢ˆ** | `å¤§é‡swapä½¿ç”¨` | `å‡å°‘æ‰¹å¤§å°ï¼Œå¢åŠ å†…å­˜` | `50-100%` |
| **ç£ç›˜IOç“¶é¢ˆ** | `iowaitæ—¶é—´é«˜` | `SSDç¡¬ç›˜ï¼Œè°ƒæ•´åˆ·ç›˜ç­–ç•¥` | `100-300%` |
| **é”ç«äº‰ç“¶é¢ˆ** | `å¤§é‡é”ç­‰å¾…` | `åˆ†è¡¨åˆ†åŒºï¼Œå‡å°‘çƒ­ç‚¹` | `100-500%` |
| **ç½‘ç»œç“¶é¢ˆ** | `ç½‘ç»œå»¶è¿Ÿé«˜` | `å¢å¤§æ‰¹å¤§å°ï¼Œæœ¬åœ°æ“ä½œ` | `200-1000%` |

---

## 7. âš™ï¸ InnoDBå‚æ•°è°ƒä¼˜æ·±åº¦è§£æ


### 7.1 innodb_flush_log_at_trx_commitå‚æ•°è¯¦è§£


**ğŸ”¸ å‚æ•°å«ä¹‰æ·±åº¦è§£æ**
```
innodb_flush_log_at_trx_commitï¼šæ§åˆ¶äº‹åŠ¡æ—¥å¿—åˆ·ç›˜ç­–ç•¥
ä½œç”¨ï¼šå¹³è¡¡æ•°æ®å®‰å…¨æ€§å’Œæ’å…¥æ€§èƒ½
å–å€¼ï¼š0, 1, 2

å€¼çš„å«ä¹‰ï¼š
0 = æ¯ç§’åˆ·ç›˜ä¸€æ¬¡ï¼ˆæ€§èƒ½æœ€é«˜ï¼Œå®‰å…¨æ€§æœ€ä½ï¼‰
1 = æ¯æ¬¡äº‹åŠ¡æäº¤éƒ½åˆ·ç›˜ï¼ˆæ€§èƒ½æœ€ä½ï¼Œå®‰å…¨æ€§æœ€é«˜ï¼‰  
2 = æ¯æ¬¡äº‹åŠ¡æäº¤å†™å…¥OSç¼“å­˜ï¼Œæ¯ç§’åˆ·ç›˜ï¼ˆæŠ˜ä¸­æ–¹æ¡ˆï¼‰
```

**ğŸ’¡ ä¸‰ç§æ¨¡å¼è¯¦ç»†å·¥ä½œæœºåˆ¶**
```
æ¨¡å¼0ï¼šæ¯ç§’åˆ·ç›˜
äº‹åŠ¡æäº¤ â†’ redo log buffer â†’ [ç­‰å¾…1ç§’] â†’ OS cache â†’ ç£ç›˜
é£é™©ï¼šMySQLå´©æºƒå¯èƒ½ä¸¢å¤±1ç§’æ•°æ®
é€‚ç”¨ï¼šå¯¹æ•°æ®ä¸¢å¤±å®¹å¿åº¦é«˜çš„åœºæ™¯

æ¨¡å¼1ï¼šäº‹åŠ¡åŒæ­¥åˆ·ç›˜ï¼ˆé»˜è®¤ï¼‰
äº‹åŠ¡æäº¤ â†’ redo log buffer â†’ OS cache â†’ ç«‹å³åˆ·ç›˜ â†’ å®Œæˆ
é£é™©ï¼šåªæœ‰ç¡¬ä»¶æ•…éšœæ‰ä¼šä¸¢å¤±æ•°æ®
é€‚ç”¨ï¼šé‡‘èã€æ”¯ä»˜ç­‰å¯¹æ•°æ®å®‰å…¨è¦æ±‚æé«˜çš„åœºæ™¯

æ¨¡å¼2ï¼šäº‹åŠ¡å¼‚æ­¥åˆ·ç›˜
äº‹åŠ¡æäº¤ â†’ redo log buffer â†’ OS cache â†’ [æ¯ç§’åˆ·ç›˜] â†’ ç£ç›˜
é£é™©ï¼šæ“ä½œç³»ç»Ÿå´©æºƒå¯èƒ½ä¸¢å¤±1ç§’æ•°æ®
é€‚ç”¨ï¼šå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯çš„å¹³è¡¡é€‰æ‹©
```

### 7.2 æ‰¹é‡æ’å…¥ä¸“ç”¨å‚æ•°è°ƒä¼˜


**ğŸ”§ æ ¸å¿ƒå‚æ•°ç»„åˆä¼˜åŒ–**
```sql
-- æ‰¹é‡æ’å…¥æ€§èƒ½è°ƒä¼˜å‚æ•°ç»„åˆ
SET GLOBAL innodb_flush_log_at_trx_commit = 0;   -- æœ€å¤§åŒ–æ’å…¥æ€§èƒ½
SET GLOBAL innodb_buffer_pool_size = 8589934592; -- 8GBï¼Œè°ƒæ•´ç¼“å†²æ± 
SET GLOBAL innodb_log_buffer_size = 268435456;   -- 256MBï¼Œæ—¥å¿—ç¼“å†²
SET GLOBAL innodb_log_file_size = 2147483648;    -- 2GBï¼Œæ—¥å¿—æ–‡ä»¶
SET GLOBAL bulk_insert_buffer_size = 268435456;  -- 256MBï¼Œæ‰¹é‡æ’å…¥ç¼“å†²

-- ä¸´æ—¶å…³é—­ä¸€äº›æ£€æŸ¥ï¼ˆæ’å…¥å®Œæˆåæ¢å¤ï¼‰
SET SESSION foreign_key_checks = 0;
SET SESSION unique_checks = 0;
SET SESSION sql_log_bin = 0;

-- è°ƒæ•´äº‹åŠ¡éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
```

**ğŸ“Š å‚æ•°è°ƒä¼˜æ•ˆæœå¯¹æ¯”**
```
é»˜è®¤é…ç½®æ€§èƒ½ï¼š
â€¢ innodb_flush_log_at_trx_commit = 1
â€¢ 10ä¸‡æ¡æ•°æ®æ’å…¥æ—¶é—´ï¼š~300ç§’
â€¢ TPSï¼š~333

ä¼˜åŒ–é…ç½®æ€§èƒ½ï¼š
â€¢ innodb_flush_log_at_trx_commit = 0
â€¢ å…¶ä»–å‚æ•°ä¼˜åŒ–
â€¢ 10ä¸‡æ¡æ•°æ®æ’å…¥æ—¶é—´ï¼š~30ç§’
â€¢ TPSï¼š~3333

æ€§èƒ½æå‡ï¼š10å€ï¼
```

### 7.3 å‚æ•°è°ƒä¼˜å®‰å…¨ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨æ€§ä¿éšœæªæ–½**
```sql
-- ç”Ÿäº§ç¯å¢ƒå®‰å…¨çš„å‚æ•°è°ƒä¼˜ç­–ç•¥
-- 1. ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ
-- 2. è®¾ç½®æ¢å¤è„šæœ¬
-- 3. æ•°æ®å¤‡ä»½ç¡®è®¤

-- æ‰§è¡Œå‰å¤‡ä»½å…³é”®å‚æ•°
SELECT 
    $$innodb_flush_log_at_trx_commit,
    $$foreign_key_checks,
    $$unique_checks,
    $$sql_log_bin;

-- æ‰¹é‡æ’å…¥æ“ä½œ
START TRANSACTION;
-- æ‰§è¡Œæ‰¹é‡æ’å…¥...
COMMIT;

-- æ“ä½œå®Œæˆåç«‹å³æ¢å¤å®‰å…¨è®¾ç½®
SET GLOBAL innodb_flush_log_at_trx_commit = 1;
SET SESSION foreign_key_checks = 1;
SET SESSION unique_checks = 1;
SET SESSION sql_log_bin = 1;

-- å¼ºåˆ¶åˆ·ç›˜ç¡®ä¿æ•°æ®å®‰å…¨
FLUSH LOGS;
```

### 7.4 å…¶ä»–é‡è¦InnoDBå‚æ•°


**âš¡ æ’å…¥æ€§èƒ½ç›¸å…³å‚æ•°**
```sql
-- ç¼“å†²æ± ç›¸å…³
innodb_buffer_pool_size = æ€»å†…å­˜ Ã— 0.7-0.8  -- ç¼“å†²æ± å¤§å°
innodb_buffer_pool_instances = 8             -- ç¼“å†²æ± å®ä¾‹æ•°

-- æ—¥å¿—ç›¸å…³
innodb_log_buffer_size = 256MB               -- æ—¥å¿—ç¼“å†²åŒº
innodb_log_file_size = 2GB                   -- å•ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_files_in_group = 2                -- æ—¥å¿—æ–‡ä»¶ç»„æ•°é‡

-- åˆ·ç›˜ç­–ç•¥
innodb_flush_method = O_DIRECT               -- ç»•è¿‡OSç¼“å­˜
innodb_io_capacity = 2000                    -- IOèƒ½åŠ›è®¾ç½®ï¼ˆSSDï¼‰
innodb_io_capacity_max = 4000                -- æœ€å¤§IOèƒ½åŠ›

-- å¹¶å‘æ§åˆ¶
innodb_thread_concurrency = 0               -- ä¸é™åˆ¶çº¿ç¨‹å¹¶å‘
innodb_write_io_threads = 8                 -- å†™å…¥çº¿ç¨‹æ•°
innodb_read_io_threads = 8                  -- è¯»å–çº¿ç¨‹æ•°
```

---

## 8. ğŸ”„ æ‰¹é‡æ’å…¥äº‹åŠ¡æäº¤ç­–ç•¥


### 8.1 äº‹åŠ¡æäº¤æ¨¡å¼é€‰æ‹©


**ğŸ”¸ è‡ªåŠ¨æäº¤ vs æ‰‹åŠ¨æäº¤**
```sql
-- è‡ªåŠ¨æäº¤æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
SET autocommit = 1;
INSERT INTO table VALUES (...);  -- æ¯æ¡è¯­å¥è‡ªåŠ¨æäº¤
INSERT INTO table VALUES (...);  -- æ¯æ¡è¯­å¥è‡ªåŠ¨æäº¤

-- æ‰‹åŠ¨æäº¤æ¨¡å¼ï¼ˆæ‰¹é‡æ’å…¥æ¨èï¼‰
SET autocommit = 0;
START TRANSACTION;
INSERT INTO table VALUES (...), (...), (...);  -- æ‰¹é‡æ’å…¥
INSERT INTO table VALUES (...), (...), (...);  -- ç»§ç»­æ’å…¥
COMMIT;  -- æ‰‹åŠ¨æäº¤
```

**âš–ï¸ æäº¤ç­–ç•¥æƒè¡¡**
```
é¢‘ç¹æäº¤ï¼š
âœ… ä¼˜åŠ¿ï¼š
â€¢ é”æŒæœ‰æ—¶é—´çŸ­
â€¢ å†…å­˜å ç”¨å°‘
â€¢ å›æ»šä»£ä»·å°
â€¢ å¯¹å…¶ä»–äº‹åŠ¡å½±å“å°

âŒ åŠ£åŠ¿ï¼š
â€¢ äº‹åŠ¡å¼€é”€å¤§
â€¢ ç£ç›˜åˆ·ç›˜æ¬¡æ•°å¤š
â€¢ æ€»ä½“æ€§èƒ½å¯èƒ½ä¸æ˜¯æœ€ä¼˜

æ‰¹é‡æäº¤ï¼š
âœ… ä¼˜åŠ¿ï¼š
â€¢ äº‹åŠ¡å¼€é”€åˆ†æ‘Š
â€¢ å‡å°‘ç£ç›˜åˆ·ç›˜æ¬¡æ•°
â€¢ æ€»ä½“æ€§èƒ½æ›´é«˜

âŒ åŠ£åŠ¿ï¼š
â€¢ é”æŒæœ‰æ—¶é—´é•¿
â€¢ å†…å­˜å ç”¨å¤§
â€¢ å›æ»šä»£ä»·é«˜
```

### 8.2 æ™ºèƒ½æäº¤ç­–ç•¥


**ğŸ§  è‡ªé€‚åº”æäº¤ç®—æ³•**
```java
public class SmartCommitStrategy {
    private int recordsInCurrentTx = 0;
    private long txStartTime = 0;
    private final int maxRecordsPerTx = 5000;       // æœ€å¤§è®°å½•æ•°
    private final long maxTxDurationMs = 30000;     // æœ€å¤§äº‹åŠ¡æ—¶é—´30ç§’
    private final long maxMemoryUsageMB = 500;      // æœ€å¤§å†…å­˜ä½¿ç”¨500MB
    
    public boolean shouldCommit() {
        // æ¡ä»¶1ï¼šè®°å½•æ•°è¾¾åˆ°ä¸Šé™
        if (recordsInCurrentTx >= maxRecordsPerTx) {
            return true;
        }
        
        // æ¡ä»¶2ï¼šäº‹åŠ¡æ—¶é—´è¿‡é•¿
        if (System.currentTimeMillis() - txStartTime > maxTxDurationMs) {
            return true;
        }
        
        // æ¡ä»¶3ï¼šå†…å­˜ä½¿ç”¨è¿‡é«˜
        if (getCurrentMemoryUsageMB() > maxMemoryUsageMB) {
            return true;
        }
        
        // æ¡ä»¶4ï¼šæ£€æµ‹åˆ°ç³»ç»Ÿè´Ÿè½½è¿‡é«˜
        if (isSystemUnderPressure()) {
            return true;
        }
        
        return false;
    }
    
    public void recordInserted() {
        recordsInCurrentTx++;
        
        if (shouldCommit()) {
            commitTransaction();
            resetTransaction();
        }
    }
    
    private void commitTransaction() {
        try {
            connection.commit();
            System.out.println("æäº¤äº‹åŠ¡ï¼š" + recordsInCurrentTx + " æ¡è®°å½•");
        } catch (SQLException e) {
            try {
                connection.rollback();
                System.err.println("äº‹åŠ¡å›æ»šï¼š" + e.getMessage());
            } catch (SQLException rollbackEx) {
                System.err.println("å›æ»šå¤±è´¥ï¼š" + rollbackEx.getMessage());
            }
        }
    }
    
    private void resetTransaction() {
        recordsInCurrentTx = 0;
        txStartTime = System.currentTimeMillis();
    }
}
```

### 8.3 é”™è¯¯æ¢å¤ä¸é‡è¯•æœºåˆ¶


**ğŸ”„ é”™è¯¯å¤„ç†ç­–ç•¥**
```java
public class RobustBatchInserter {
    private final int maxRetryCount = 3;
    private final long retryDelayMs = 1000;
    
    public void insertWithRetry(List<Record> batch) {
        int retryCount = 0;
        
        while (retryCount < maxRetryCount) {
            try {
                connection.setAutoCommit(false);
                
                // æ‰§è¡Œæ‰¹é‡æ’å…¥
                PreparedStatement pstmt = prepareInsertStatement();
                for (Record record : batch) {
                    setStatementParameters(pstmt, record);
                    pstmt.addBatch();
                }
                
                int[] results = pstmt.executeBatch();
                connection.commit();
                
                // æˆåŠŸï¼Œè®°å½•ç»Ÿè®¡ä¿¡æ¯
                logSuccessfulInsert(batch.size(), results);
                return;
                
            } catch (SQLException e) {
                retryCount++;
                
                try {
                    connection.rollback();
                } catch (SQLException rollbackEx) {
                    System.err.println("å›æ»šå¤±è´¥: " + rollbackEx.getMessage());
                }
                
                if (retryCount >= maxRetryCount) {
                    // æœ€ç»ˆå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
                    logFailedInsert(batch, e);
                    throw new RuntimeException("æ‰¹é‡æ’å…¥æœ€ç»ˆå¤±è´¥", e);
                }
                
                // ç­‰å¾…åé‡è¯•
                waitBeforeRetry(retryCount);
                
                // å¯èƒ½éœ€è¦é‡æ–°å»ºç«‹è¿æ¥
                if (isConnectionBroken(e)) {
                    reconnectDatabase();
                }
            }
        }
    }
    
    private void waitBeforeRetry(int retryCount) {
        try {
            Thread.sleep(retryDelayMs * retryCount);  // æŒ‡æ•°é€€é¿
        } catch (InterruptedException ie) {
            Thread.currentThread().interrupt();
        }
    }
}
```

---

## 9. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯ä¸æ¡ˆä¾‹


### 9.1 ç”µå•†ç³»ç»Ÿè®¢å•å¯¼å…¥


**ğŸ›’ ä¸šåŠ¡åœºæ™¯**
```
ä¸šåŠ¡éœ€æ±‚ï¼š
â€¢ æ¯æ—¥å¯¼å…¥50ä¸‡è®¢å•æ•°æ®
â€¢ è¦æ±‚åœ¨2å°æ—¶å†…å®Œæˆ
â€¢ ä¸èƒ½å½±å“ç™½å¤©æ­£å¸¸ä¸šåŠ¡
â€¢ æ•°æ®å®Œæ•´æ€§è¦æ±‚é«˜

æŠ€æœ¯æŒ‘æˆ˜ï¼š
â€¢ æ•°æ®é‡å¤§ï¼Œä¼ ç»Ÿæ’å…¥å¤ªæ…¢
â€¢ æœ‰å¤–é”®çº¦æŸï¼Œéœ€è¦ç»´æŠ¤æ•°æ®å®Œæ•´æ€§
â€¢ å¹¶å‘ç”¨æˆ·æŸ¥è¯¢ï¼Œä¸èƒ½é•¿æ—¶é—´é”è¡¨
â€¢ éœ€è¦é”™è¯¯å¤„ç†å’Œè¿›åº¦ç›‘æ§
```

**ğŸ’» ä¼˜åŒ–æ–¹æ¡ˆå®ç°**
```java
public class OrderBatchImporter {
    private final int OPTIMAL_BATCH_SIZE = 2000;
    private final int THREAD_COUNT = 4;
    
    public void importOrders(String csvFilePath) {
        // ç¬¬ä¸€æ­¥ï¼šæ•°æ®é¢„å¤„ç†
        List<OrderData> orderData = loadAndValidateData(csvFilePath);
        System.out.println("åŠ è½½æ•°æ®: " + orderData.size() + " æ¡è®¢å•");
        
        // ç¬¬äºŒæ­¥ï¼šä¼˜åŒ–æ•°æ®åº“é…ç½®
        optimizeDatabaseSettings();
        
        try {
            // ç¬¬ä¸‰æ­¥ï¼šå¹¶è¡Œæ‰¹é‡æ’å…¥
            long startTime = System.currentTimeMillis();
            
            List<List<OrderData>> batches = partitionData(orderData, OPTIMAL_BATCH_SIZE);
            ExecutorService executor = Executors.newFixedThreadPool(THREAD_COUNT);
            
            List<Future<Integer>> futures = new ArrayList<>();
            for (List<OrderData> batch : batches) {
                futures.add(executor.submit(() -> insertOrderBatch(batch)));
            }
            
            // ç­‰å¾…å®Œæˆå¹¶ç»Ÿè®¡ç»“æœ
            int totalInserted = 0;
            for (Future<Integer> future : futures) {
                totalInserted += future.get();
            }
            
            long duration = System.currentTimeMillis() - startTime;
            System.out.println("å¯¼å…¥å®Œæˆ: " + totalInserted + " æ¡ï¼Œè€—æ—¶: " + duration + "ms");
            System.out.println("TPS: " + (totalInserted * 1000.0 / duration));
            
        } finally {
            // ç¬¬å››æ­¥ï¼šæ¢å¤æ•°æ®åº“é…ç½®
            restoreDatabaseSettings();
        }
    }
    
    private void optimizeDatabaseSettings() {
        try (Connection conn = dataSource.getConnection()) {
            Statement stmt = conn.createStatement();
            
            // ä¸´æ—¶æ€§èƒ½ä¼˜åŒ–è®¾ç½®
            stmt.execute("SET SESSION innodb_flush_log_at_trx_commit = 0");
            stmt.execute("SET SESSION foreign_key_checks = 0");
            stmt.execute("SET SESSION unique_checks = 0");
            stmt.execute("SET SESSION autocommit = 0");
            
            System.out.println("æ•°æ®åº“æ€§èƒ½å‚æ•°å·²ä¼˜åŒ–");
        } catch (SQLException e) {
            throw new RuntimeException("å‚æ•°ä¼˜åŒ–å¤±è´¥", e);
        }
    }
}
```

### 9.2 æ—¥å¿—æ•°æ®æ‰¹é‡å…¥åº“


**ğŸ“ æ—¥å¿—å¤„ç†åœºæ™¯**
```
ä¸šåŠ¡èƒŒæ™¯ï¼š
â€¢ åº”ç”¨ç³»ç»Ÿäº§ç”Ÿå¤§é‡è®¿é—®æ—¥å¿—
â€¢ æ¯å¤©çº¦1000ä¸‡æ¡æ—¥å¿—è®°å½•
â€¢ éœ€è¦å®æ—¶æˆ–å‡†å®æ—¶å…¥åº“åˆ†æ
â€¢ å¯¹éƒ¨åˆ†æ•°æ®ä¸¢å¤±å®¹å¿åº¦è¾ƒé«˜

ä¼˜åŒ–ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æ—¥å¿—    â”‚ â†’  â”‚   ç¼“å†²é˜Ÿåˆ—    â”‚ â†’  â”‚  æ‰¹é‡å…¥åº“   â”‚
â”‚  å®æ—¶äº§ç”Ÿ    â”‚    â”‚  å¼‚æ­¥æ”¶é›†     â”‚    â”‚  å®šæ—¶å¤„ç†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ—¥å¿—æ‰¹é‡å…¥åº“å®ç°**
```java
public class LogBatchProcessor {
    private final BlockingQueue<LogRecord> logQueue = 
        new LinkedBlockingQueue<>(100000);
    private final int BATCH_SIZE = 5000;
    private final int BATCH_TIMEOUT_MS = 5000;  // 5ç§’è¶…æ—¶
    
    @Scheduled(fixedDelay = 1000)  // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
    public void processBatchLogs() {
        List<LogRecord> batch = new ArrayList<>();
        
        // æ‰¹é‡è·å–æ—¥å¿—è®°å½•
        logQueue.drainTo(batch, BATCH_SIZE);
        
        if (!batch.isEmpty()) {
            insertLogBatch(batch);
        }
    }
    
    private void insertLogBatch(List<LogRecord> logs) {
        String sql = """
            INSERT INTO access_logs 
            (ip_address, user_agent, request_url, response_time, created_at) 
            VALUES (?, ?, ?, ?, ?)
            """;
        
        try (Connection conn = dataSource.getConnection()) {
            // æ—¥å¿—æ•°æ®å…è®¸æ›´æ¿€è¿›çš„æ€§èƒ½ä¼˜åŒ–
            conn.setAutoCommit(false);
            conn.createStatement().execute("SET innodb_flush_log_at_trx_commit = 0");
            
            try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                for (LogRecord log : logs) {
                    pstmt.setString(1, log.getIpAddress());
                    pstmt.setString(2, log.getUserAgent());
                    pstmt.setString(3, log.getRequestUrl());
                    pstmt.setInt(4, log.getResponseTime());
                    pstmt.setTimestamp(5, log.getCreatedAt());
                    pstmt.addBatch();
                }
                
                pstmt.executeBatch();
                conn.commit();
                
                System.out.println("æ—¥å¿—å…¥åº“æˆåŠŸ: " + logs.size() + " æ¡");
            }
        } catch (SQLException e) {
            System.err.println("æ—¥å¿—å…¥åº“å¤±è´¥: " + e.getMessage());
            // æ—¥å¿—æ•°æ®ä¸¢å¤±å¯ä»¥æ¥å—ï¼Œä¸æŠ›å‡ºå¼‚å¸¸
        }
    }
}
```

---

## 10. ğŸ“ˆ é«˜çº§ä¼˜åŒ–æŠ€æœ¯


### 10.1 åˆ†åŒºè¡¨æ‰¹é‡æ’å…¥ä¼˜åŒ–


**ğŸ”¸ æ—¶é—´åˆ†åŒºæ‰¹é‡æ’å…¥**
```sql
-- åˆ›å»ºæŒ‰æœˆåˆ†åŒºçš„è¡¨
CREATE TABLE user_actions (
    id BIGINT AUTO_INCREMENT,
    user_id INT,
    action_type VARCHAR(50),
    action_time DATETIME,
    data JSON,
    PRIMARY KEY (id, action_time)
)
PARTITION BY RANGE (YEAR(action_time) * 100 + MONTH(action_time)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    PARTITION p202404 VALUES LESS THAN (MAXVALUE)
);

-- å¹¶è¡Œæ’å…¥ä¸åŒåˆ†åŒºï¼ˆæ— é”ç«äº‰ï¼‰
-- çº¿ç¨‹1ï¼šæ’å…¥1æœˆæ•°æ®
INSERT INTO user_actions (user_id, action_type, action_time, data) VALUES
(1001, 'login', '2024-01-15 10:30:00', '{"device": "mobile"}'),
(1002, 'purchase', '2024-01-16 14:20:00', '{"amount": 299.99}');

-- çº¿ç¨‹2ï¼šæ’å…¥2æœˆæ•°æ®
INSERT INTO user_actions (user_id, action_type, action_time, data) VALUES  
(1003, 'login', '2024-02-10 09:15:00', '{"device": "web"}'),
(1004, 'view', '2024-02-12 16:45:00', '{"product_id": 12345}');

æ€§èƒ½ä¼˜åŠ¿ï¼š
â€¢ ä¸åŒåˆ†åŒºé—´æ— é”ç«äº‰
â€¢ å¯ä»¥çœŸæ­£å¹¶è¡Œæ’å…¥
â€¢ æ¯ä¸ªåˆ†åŒºç‹¬ç«‹ä¼˜åŒ–
```

### 10.2 å†…å­˜è¡¨ç¼“å­˜ç­–ç•¥


**ğŸ”¸ å†…å­˜è¡¨ä¸­è½¬ä¼˜åŒ–**
```sql
-- åˆ›å»ºå†…å­˜ä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_import (
    name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(20),
    address TEXT
) ENGINE=MEMORY;

-- å¿«é€Ÿå¯¼å…¥åˆ°å†…å­˜è¡¨
INSERT INTO temp_import VALUES
('å¼ ä¸‰', 'zhang@example.com', '13800138000', 'åŒ—äº¬å¸‚æœé˜³åŒº'),
('æå››', 'li@example.com', '13900139000', 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº'),
-- ... å¤§é‡æ•°æ®

-- æ•°æ®æ¸…æ´—å’Œè½¬æ¢
INSERT INTO users (name, email, phone, address, created_at)
SELECT 
    name,
    email,
    phone,
    address,
    NOW() as created_at
FROM temp_import
WHERE email IS NOT NULL 
  AND phone REGEXP '^1[3-9][0-9]{9}$'  -- æ‰‹æœºå·éªŒè¯
  AND length(name) > 0;

-- æ¸…ç†ä¸´æ—¶è¡¨
DROP TEMPORARY TABLE temp_import;

ä¼˜åŠ¿ï¼š
â€¢ å†…å­˜è¡¨æ’å…¥é€Ÿåº¦æå¿«
â€¢ å¯ä»¥åœ¨å†…å­˜ä¸­è¿›è¡Œæ•°æ®æ¸…æ´—
â€¢ å‡å°‘å¯¹æ­£å¼è¡¨çš„é”ç«äº‰æ—¶é—´
```

### 10.3 é¢„å¤„ç†ä¼˜åŒ–æŠ€æœ¯


**ğŸ”¸ æ•°æ®é¢„æ’åºä¼˜åŒ–**
```java
public class PreprocessedBatchInserter {
    
    // æŒ‰ä¸»é”®æ’åºï¼Œä¼˜åŒ–B+æ ‘æ’å…¥
    public void insertWithPreSort(List<Product> products) {
        // æŒ‰ç…§ä¸»é”®æˆ–èšç°‡ç´¢å¼•æ’åº
        products.sort(Comparator.comparing(Product::getId));
        
        // æˆ–è€…æŒ‰ç…§ç»å¸¸æŸ¥è¯¢çš„å­—æ®µæ’åº
        products.sort(Comparator
            .comparing(Product::getCategoryId)
            .thenComparing(Product::getPrice));
        
        // æ‰§è¡Œæ‰¹é‡æ’å…¥
        batchInsert(products);
    }
    
    // æ•°æ®å»é‡é¢„å¤„ç†
    public void insertWithDeduplication(List<Product> products) {
        // ä½¿ç”¨Setå»é‡ï¼Œé¿å…æ’å…¥æ—¶çš„å”¯ä¸€é”®å†²çª
        Set<String> seen = new HashSet<>();
        List<Product> uniqueProducts = products.stream()
            .filter(p -> seen.add(p.getUniqueKey()))
            .collect(Collectors.toList());
        
        System.out.println("å»é‡å‰: " + products.size() + ", å»é‡å: " + uniqueProducts.size());
        
        batchInsert(uniqueProducts);
    }
}
```

---

## 11. ğŸ”¬ æ·±åº¦æ€§èƒ½åˆ†æä¸ç›‘æ§


### 11.1 å®æ—¶æ€§èƒ½ç›‘æ§


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- ç›‘æ§InnoDBçŠ¶æ€
SHOW ENGINE INNODB STATUS;

-- å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š
-- 1. Log sequence numberï¼šæ—¥å¿—åºåˆ—å·å¢é•¿é€Ÿåº¦
-- 2. Log flushed up toï¼šå·²åˆ·ç›˜çš„æ—¥å¿—ä½ç½®  
-- 3. Buffer pool hit rateï¼šç¼“å†²æ± å‘½ä¸­ç‡
-- 4. Pending normal aio reads/writesï¼šå¾…å¤„ç†çš„å¼‚æ­¥IO

-- ç›‘æ§æ‰¹é‡æ’å…¥æ€§èƒ½
SELECT 
    THREAD_ID,
    EVENT_NAME,
    COUNT_STAR as event_count,
    SUM_TIMER_WAIT/1000000000 as total_time_sec,
    AVG_TIMER_WAIT/1000000000 as avg_time_sec
FROM performance_schema.events_statements_summary_by_thread_by_event_name 
WHERE EVENT_NAME LIKE '%insert%'
ORDER BY SUM_TIMER_WAIT DESC;
```

**ğŸ“ˆ å®æ—¶ç›‘æ§å®ç°**
```java
public class InsertPerformanceMonitor {
    private final ScheduledExecutorService monitor = 
        Executors.newScheduledThreadPool(1);
    
    private volatile long totalInserted = 0;
    private volatile long lastCheckTime = System.currentTimeMillis();
    private volatile long lastInsertedCount = 0;
    
    public void startMonitoring() {
        monitor.scheduleAtFixedRate(() -> {
            long currentTime = System.currentTimeMillis();
            long currentInserted = totalInserted;
            
            long timeDiff = currentTime - lastCheckTime;
            long countDiff = currentInserted - lastInsertedCount;
            
            double tps = countDiff * 1000.0 / timeDiff;
            
            System.out.printf("[Monitor] TPS: %.1f, æ€»è®¡: %d, æ—¶é—´: %s%n",
                tps, currentInserted, new Date());
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´ç­–ç•¥
            if (tps < 1000) {
                System.out.println("âš ï¸ æ€§èƒ½å‘Šè­¦ï¼šTPSä½äºé¢„æœŸï¼Œå»ºè®®æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½");
            }
            
            lastCheckTime = currentTime;
            lastInsertedCount = currentInserted;
            
        }, 10, 10, TimeUnit.SECONDS);  // æ¯10ç§’ç›‘æ§ä¸€æ¬¡
    }
    
    public void recordInsert(int count) {
        totalInserted += count;
    }
}
```

### 11.2 èµ„æºä½¿ç”¨ç›‘æ§


**ğŸ’¾ ç³»ç»Ÿèµ„æºç›‘æ§**
```java
public class ResourceMonitor {
    private final MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
    private final OperatingSystemMXBean osBean = ManagementFactory.getOperatingSystemMXBean();
    
    public SystemMetrics getCurrentMetrics() {
        // å†…å­˜ä½¿ç”¨æƒ…å†µ
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        long usedMemory = heapUsage.getUsed();
        long maxMemory = heapUsage.getMax();
        double memoryUtilization = (double) usedMemory / maxMemory;
        
        // CPUä½¿ç”¨æƒ…å†µ
        double cpuUsage = osBean.getProcessCpuLoad();
        
        // æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
        HikariDataSource dataSource = (HikariDataSource) this.dataSource;
        int activeConnections = dataSource.getHikariPoolMXBean().getActiveConnections();
        int totalConnections = dataSource.getHikariPoolMXBean().getTotalConnections();
        
        return new SystemMetrics(
            memoryUtilization,
            cpuUsage, 
            activeConnections,
            totalConnections
        );
    }
    
    public boolean isSystemUnderPressure() {
        SystemMetrics metrics = getCurrentMetrics();
        
        return metrics.getMemoryUtilization() > 0.8 ||      // å†…å­˜ä½¿ç”¨>80%
               metrics.getCpuUsage() > 0.8 ||               // CPUä½¿ç”¨>80%
               metrics.getConnectionUtilization() > 0.9;    // è¿æ¥æ± ä½¿ç”¨>90%
    }
}
```

---

## 12. ğŸ› ï¸ å®ç”¨å·¥å…·ä¸ä»£ç æ¨¡æ¿


### 12.1 é€šç”¨æ‰¹é‡æ’å…¥å·¥å…·ç±»


**ğŸ”§ ç”Ÿäº§çº§æ‰¹é‡æ’å…¥å·¥å…·**
```java
public class UniversalBatchInserter<T> {
    private final DataSource dataSource;
    private final String tableName;
    private final List<String> columnNames;
    private final Function<T, Object[]> valueExtractor;
    
    // é…ç½®å‚æ•°
    private int batchSize = 1000;
    private int maxRetryCount = 3;
    private boolean enableOptimization = true;
    
    public UniversalBatchInserter(DataSource dataSource, 
                                  String tableName,
                                  List<String> columnNames,
                                  Function<T, Object[]> valueExtractor) {
        this.dataSource = dataSource;
        this.tableName = tableName;
        this.columnNames = columnNames;
        this.valueExtractor = valueExtractor;
    }
    
    public BatchInsertResult insert(List<T> data) {
        if (data.isEmpty()) {
            return new BatchInsertResult(0, 0, Collections.emptyList());
        }
        
        long startTime = System.currentTimeMillis();
        int successCount = 0;
        List<String> errors = new ArrayList<>();
        
        try (Connection conn = dataSource.getConnection()) {
            if (enableOptimization) {
                optimizeConnection(conn);
            }
            
            String sql = buildInsertSQL();
            
            for (int i = 0; i < data.size(); i += batchSize) {
                int endIdx = Math.min(i + batchSize, data.size());
                List<T> batch = data.subList(i, endIdx);
                
                try {
                    int inserted = insertBatch(conn, sql, batch);
                    successCount += inserted;
                    
                    // è¿›åº¦æŠ¥å‘Š
                    if ((i + batchSize) % (batchSize * 10) == 0) {
                        double progress = (double) (i + batchSize) / data.size() * 100;
                        System.out.printf("æ’å…¥è¿›åº¦: %.1f%% (%d/%d)%n", 
                            progress, i + batchSize, data.size());
                    }
                    
                } catch (SQLException e) {
                    errors.add("æ‰¹æ¬¡ " + (i/batchSize + 1) + " å¤±è´¥: " + e.getMessage());
                    System.err.println("æ‰¹é‡æ’å…¥å¤±è´¥ï¼Œè·³è¿‡æ‰¹æ¬¡: " + e.getMessage());
                }
            }
            
        } catch (SQLException e) {
            errors.add("æ•°æ®åº“è¿æ¥å¤±è´¥: " + e.getMessage());
        }
        
        long duration = System.currentTimeMillis() - startTime;
        return new BatchInsertResult(successCount, duration, errors);
    }
    
    private String buildInsertSQL() {
        String columns = String.join(", ", columnNames);
        String placeholders = "?, ".repeat(columnNames.size());
        placeholders = placeholders.substring(0, placeholders.length() - 2);
        
        return String.format("INSERT INTO %s (%s) VALUES (%s)", 
            tableName, columns, placeholders);
    }
    
    private void optimizeConnection(Connection conn) throws SQLException {
        Statement stmt = conn.createStatement();
        stmt.execute("SET SESSION innodb_flush_log_at_trx_commit = 0");
        stmt.execute("SET SESSION foreign_key_checks = 0"); 
        stmt.execute("SET SESSION unique_checks = 0");
        stmt.execute("SET SESSION autocommit = 0");
    }
    
    private int insertBatch(Connection conn, String sql, List<T> batch) throws SQLException {
        conn.setAutoCommit(false);
        
        try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
            for (T item : batch) {
                Object[] values = valueExtractor.apply(item);
                for (int i = 0; i < values.length; i++) {
                    pstmt.setObject(i + 1, values[i]);
                }
                pstmt.addBatch();
            }
            
            int[] results = pstmt.executeBatch();
            conn.commit();
            
            return Arrays.stream(results).sum();
        } catch (SQLException e) {
            conn.rollback();
            throw e;
        }
    }
    
    // ç»“æœç»Ÿè®¡ç±»
    public static class BatchInsertResult {
        private final int successCount;
        private final long durationMs;
        private final List<String> errors;
        
        public BatchInsertResult(int successCount, long durationMs, List<String> errors) {
            this.successCount = successCount;
            this.durationMs = durationMs;
            this.errors = errors;
        }
        
        public void printSummary() {
            System.out.println("æ‰¹é‡æ’å…¥å®Œæˆç»Ÿè®¡:");
            System.out.println("æˆåŠŸæ’å…¥: " + successCount + " æ¡");
            System.out.println("æ€»è€—æ—¶: " + durationMs + "ms");
            System.out.println("TPS: " + (successCount * 1000.0 / durationMs));
            
            if (!errors.isEmpty()) {
                System.out.println("é”™è¯¯ä¿¡æ¯:");
                errors.forEach(System.out::println);
            }
        }
    }
}
```

### 12.2 æ‰¹é‡æ’å…¥é…ç½®ç®¡ç†å™¨


**âš™ï¸ åŠ¨æ€é…ç½®ç®¡ç†**
```java
public class BatchInsertConfigManager {
    
    // é…ç½®æ–‡ä»¶æ ¼å¼
    public static class BatchConfig {
        private String scenario;           // ä½¿ç”¨åœºæ™¯
        private int batchSize;            // æ‰¹å¤§å°
        private int threadCount;          // çº¿ç¨‹æ•°
        private boolean enableOptimization; // æ˜¯å¦å¯ç”¨ä¼˜åŒ–
        private Map<String, String> dbParams; // æ•°æ®åº“å‚æ•°
        
        // é¢„å®šä¹‰é…ç½®
        public static BatchConfig oltp() {
            BatchConfig config = new BatchConfig();
            config.scenario = "OLTP";
            config.batchSize = 500;
            config.threadCount = 2;
            config.enableOptimization = false;  // ä¿æŒæ•°æ®å®‰å…¨
            config.dbParams = Map.of(
                "innodb_flush_log_at_trx_commit", "1",
                "foreign_key_checks", "1"
            );
            return config;
        }
        
        public static BatchConfig etl() {
            BatchConfig config = new BatchConfig();
            config.scenario = "ETL";
            config.batchSize = 5000;
            config.threadCount = 4;
            config.enableOptimization = true;
            config.dbParams = Map.of(
                "innodb_flush_log_at_trx_commit", "0",
                "foreign_key_checks", "0",
                "unique_checks", "0"
            );
            return config;
        }
        
        public static BatchConfig dataWarehouse() {
            BatchConfig config = new BatchConfig();
            config.scenario = "æ•°æ®ä»“åº“";
            config.batchSize = 10000;
            config.threadCount = 8;
            config.enableOptimization = true;
            config.dbParams = Map.of(
                "innodb_flush_log_at_trx_commit", "0",
                "foreign_key_checks", "0",
                "unique_checks", "0",
                "sql_log_bin", "0"
            );
            return config;
        }
    }
    
    // åº”ç”¨é…ç½®åˆ°æ•°æ®åº“
    public void applyConfiguration(Connection conn, BatchConfig config) throws SQLException {
        System.out.println("åº”ç”¨é…ç½®: " + config.scenario);
        
        Statement stmt = conn.createStatement();
        for (Map.Entry<String, String> entry : config.dbParams.entrySet()) {
            String sql = "SET SESSION " + entry.getKey() + " = " + entry.getValue();
            stmt.execute(sql);
            System.out.println("è®¾ç½®å‚æ•°: " + entry.getKey() + " = " + entry.getValue());
        }
    }
}
```

---

## 13. ğŸš¨ æ•…éšœå¤„ç†ä¸æ¢å¤ç­–ç•¥


### 13.1 å¸¸è§æ•…éšœç±»å‹ä¸å¤„ç†


**âš ï¸ æ’å…¥å¤±è´¥çš„å¸¸è§åŸå› **
```
æ•°æ®ç›¸å…³é”™è¯¯ï¼š
â€¢ ä¸»é”®å†²çªï¼šDuplicate entry for key 'PRIMARY'
â€¢ å¤–é”®çº¦æŸï¼šCannot add or update a child row
â€¢ æ•°æ®ç±»å‹é”™è¯¯ï¼šData truncation or type mismatch
â€¢ å”¯ä¸€é”®å†²çªï¼šDuplicate entry for key 'unique_index'

ç³»ç»Ÿèµ„æºé”™è¯¯ï¼š
â€¢ å†…å­˜ä¸è¶³ï¼šOut of memory
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³ï¼šNo space left on device  
â€¢ è¿æ¥æ•°è¶…é™ï¼šToo many connections
â€¢ é”ç­‰å¾…è¶…æ—¶ï¼šLock wait timeout exceeded

ç½‘ç»œç›¸å…³é”™è¯¯ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼šConnection timeout
â€¢ è¿æ¥ä¸­æ–­ï¼šConnection reset by peer
â€¢ ç½‘ç»œä¸ç¨³å®šï¼šCommunication link failure
```

**ğŸ”§ é”™è¯¯åˆ†ç±»å¤„ç†ç­–ç•¥**
```java
public class ErrorClassificationHandler {
    
    public enum ErrorType {
        RETRYABLE,      // å¯é‡è¯•é”™è¯¯
        SKIP_RECORD,    // è·³è¿‡å•æ¡è®°å½•
        FATAL          // è‡´å‘½é”™è¯¯ï¼Œåœæ­¢å¤„ç†
    }
    
    public ErrorType classifyError(SQLException e) {
        String sqlState = e.getSQLState();
        int errorCode = e.getErrorCode();
        String message = e.getMessage().toLowerCase();
        
        // å¯é‡è¯•çš„é”™è¯¯
        if (sqlState != null && sqlState.startsWith("08")) {  // è¿æ¥å¼‚å¸¸
            return ErrorType.RETRYABLE;
        }
        if (errorCode == 1205) {  // é”ç­‰å¾…è¶…æ—¶
            return ErrorType.RETRYABLE;
        }
        if (message.contains("timeout") || message.contains("connection")) {
            return ErrorType.RETRYABLE;
        }
        
        // å¯è·³è¿‡çš„æ•°æ®é”™è¯¯
        if (errorCode == 1062) {  // ä¸»é”®å†²çª
            return ErrorType.SKIP_RECORD;
        }
        if (errorCode == 1452) {  // å¤–é”®çº¦æŸ
            return ErrorType.SKIP_RECORD;
        }
        if (sqlState != null && sqlState.startsWith("22")) {  // æ•°æ®å¼‚å¸¸
            return ErrorType.SKIP_RECORD;
        }
        
        // å…¶ä»–æƒ…å†µè§†ä¸ºè‡´å‘½é”™è¯¯
        return ErrorType.FATAL;
    }
    
    public void handleError(SQLException e, List<T> failedBatch, ErrorType errorType) {
        switch (errorType) {
            case RETRYABLE:
                System.out.println("æ£€æµ‹åˆ°å¯é‡è¯•é”™è¯¯ï¼Œç­‰å¾…åé‡è¯•: " + e.getMessage());
                // å®ç°é‡è¯•é€»è¾‘
                break;
                
            case SKIP_RECORD:
                System.out.println("æ£€æµ‹åˆ°æ•°æ®é”™è¯¯ï¼Œè·³è¿‡è¯¥æ‰¹æ¬¡: " + e.getMessage());
                // è®°å½•å¤±è´¥çš„æ•°æ®ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ‰¹
                logFailedRecords(failedBatch, e);
                break;
                
            case FATAL:
                System.err.println("æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯ï¼Œåœæ­¢å¤„ç†: " + e.getMessage());
                throw new RuntimeException("æ‰¹é‡æ’å…¥ç»ˆæ­¢", e);
        }
    }
}
```

### 13.2 æ•°æ®ä¸€è‡´æ€§ä¿éšœ


**ğŸ”’ äº‹åŠ¡ä¸€è‡´æ€§ç­–ç•¥**
```java
public class ConsistentBatchInserter {
    
    // æ”¯æŒéƒ¨åˆ†å¤±è´¥çš„æ‰¹é‡æ’å…¥
    public DetailedResult insertWithPartialFailure(List<Record> records) {
        List<Record> successful = new ArrayList<>();
        List<RecordError> failed = new ArrayList<>();
        
        try (Connection conn = dataSource.getConnection()) {
            conn.setAutoCommit(false);
            
            String sql = "INSERT INTO target_table (col1, col2, col3) VALUES (?, ?, ?)";
            
            try (PreparedStatement pstmt = conn.prepareStatement(sql)) {
                
                for (int i = 0; i < records.size(); i++) {
                    Record record = records.get(i);
                    
                    try {
                        // é€æ¡æ’å…¥ï¼Œä½†åœ¨åŒä¸€äº‹åŠ¡ä¸­
                        pstmt.setString(1, record.getCol1());
                        pstmt.setString(2, record.getCol2());
                        pstmt.setString(3, record.getCol3());
                        
                        pstmt.executeUpdate();
                        successful.add(record);
                        
                        // è¾¾åˆ°æ‰¹é‡å¤§å°æ—¶æäº¤
                        if (successful.size() % 1000 == 0) {
                            conn.commit();
                            System.out.println("æäº¤æ‰¹æ¬¡: " + successful.size() + " æ¡è®°å½•");
                        }
                        
                    } catch (SQLException e) {
                        // è®°å½•å¤±è´¥ä¿¡æ¯ï¼Œä½†ä¸å½±å“å…¶ä»–è®°å½•
                        failed.add(new RecordError(record, e.getMessage()));
                        System.err.println("è®°å½•æ’å…¥å¤±è´¥: " + record + ", åŸå› : " + e.getMessage());
                    }
                }
                
                // æäº¤å‰©ä½™çš„æˆåŠŸè®°å½•
                if (successful.size() % 1000 != 0) {
                    conn.commit();
                }
                
            }
        } catch (SQLException e) {
            throw new RuntimeException("æ•°æ®åº“æ“ä½œå¤±è´¥", e);
        }
        
        return new DetailedResult(successful, failed);
    }
    
    // è¯¦ç»†ç»“æœç±»
    public static class DetailedResult {
        private final List<Record> successful;
        private final List<RecordError> failed;
        
        public DetailedResult(List<Record> successful, List<RecordError> failed) {
            this.successful = successful;
            this.failed = failed;
        }
        
        public void printSummary() {
            System.out.println("æ’å…¥ç»“æœç»Ÿè®¡:");
            System.out.println("æˆåŠŸ: " + successful.size() + " æ¡");
            System.out.println("å¤±è´¥: " + failed.size() + " æ¡");
            System.out.println("æˆåŠŸç‡: " + 
                String.format("%.2f%%", successful.size() * 100.0 / (successful.size() + failed.size())));
        }
        
        // å¯¼å‡ºå¤±è´¥è®°å½•åˆ°CSVä¾›äººå·¥å¤„ç†
        public void exportFailedRecords(String fileName) throws IOException {
            try (PrintWriter writer = new PrintWriter(fileName)) {
                writer.println("record,error_message");
                for (RecordError error : failed) {
                    writer.println(error.getRecord() + "," + error.getErrorMessage());
                }
            }
            System.out.println("å¤±è´¥è®°å½•å·²å¯¼å‡ºåˆ°: " + fileName);
        }
    }
}
```

---

## 14. ğŸ“‹ ç»¼åˆä¼˜åŒ–ç­–ç•¥æ€»ç»“


### 14.1 ä¼˜åŒ–ç­–ç•¥å†³ç­–æ ‘


**ğŸ”¸ æ ¹æ®åœºæ™¯é€‰æ‹©ä¼˜åŒ–ç­–ç•¥**
```
æ•°æ®æ’å…¥åœºæ™¯åˆ†æï¼š

æ•°æ®é‡çº§åˆ¤æ–­ï¼š
â”œâ”€â”€ < 1ä¸‡æ¡
â”‚   â””â”€â”€ ä½¿ç”¨ç®€å•æ‰¹é‡æ’å…¥ï¼Œæ‰¹å¤§å°500-1000
â”œâ”€â”€ 1ä¸‡-100ä¸‡æ¡  
â”‚   â””â”€â”€ ä½¿ç”¨æ‰¹é‡+äº‹åŠ¡ä¼˜åŒ–ï¼Œæ‰¹å¤§å°1000-5000
â””â”€â”€ > 100ä¸‡æ¡
    â”œâ”€â”€ å®æ—¶æ€§è¦æ±‚é«˜
    â”‚   â””â”€â”€ å¹¶è¡Œæ’å…¥+å†…å­˜è¡¨ä¸­è½¬
    â””â”€â”€ å®æ—¶æ€§è¦æ±‚ä½
        â””â”€â”€ LOAD DATA INFILE + å‚æ•°è°ƒä¼˜

å®‰å…¨æ€§è¦æ±‚åˆ¤æ–­ï¼š
â”œâ”€â”€ é‡‘è/æ”¯ä»˜ç³»ç»Ÿ
â”‚   â””â”€â”€ ä¿æŒinnodb_flush_log_at_trx_commit=1
â”œâ”€â”€ ä¸€èˆ¬ä¸šåŠ¡ç³»ç»Ÿ
â”‚   â””â”€â”€ å¯ä¸´æ—¶è®¾ç½®ä¸º2ï¼Œæ“ä½œå®Œæˆåæ¢å¤
â””â”€â”€ æ—¥å¿—/åˆ†æç³»ç»Ÿ
    â””â”€â”€ å¯è®¾ç½®ä¸º0ï¼Œè¿½æ±‚æœ€å¤§æ€§èƒ½
```

### 14.2 æœ€ä½³å®è·µæ¸…å•


**âœ… æ‰¹é‡æ’å…¥æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•**
```
ğŸ“‹ æ“ä½œå‰å‡†å¤‡ï¼š
- [ ] ç¡®è®¤æ‰¹é‡å¤§å°ï¼ˆåŸºäºæµ‹è¯•ç»“æœï¼‰
- [ ] å¤‡ä»½é‡è¦æ•°æ®
- [ ] æ£€æŸ¥ç£ç›˜ç©ºé—´å……è¶³
- [ ] ç¡®è®¤ç³»ç»Ÿèµ„æºå……è¶³
- [ ] é€‰æ‹©ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œ

ğŸ”§ å‚æ•°ä¼˜åŒ–ï¼š
- [ ] è®¾ç½®innodb_flush_log_at_trx_commit
- [ ] è°ƒæ•´innodb_buffer_pool_size
- [ ] å¢å¤§innodb_log_buffer_size
- [ ] è®¾ç½®bulk_insert_buffer_size
- [ ] ä¸´æ—¶å…³é—­çº¦æŸæ£€æŸ¥

ğŸ’» ä»£ç å®ç°ï¼š
- [ ] ä½¿ç”¨PreparedStatementæ‰¹é‡æ“ä½œ
- [ ] å®ç°äº‹åŠ¡ç®¡ç†
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] å®ç°è¿›åº¦ç›‘æ§
- [ ] èµ„æºæ¸…ç†æœºåˆ¶

ğŸ“Š ç›‘æ§éªŒè¯ï¼š
- [ ] ç›‘æ§TPSå’Œå“åº”æ—¶é—´
- [ ] æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨
- [ ] éªŒè¯æ•°æ®å®Œæ•´æ€§
- [ ] è®°å½•æ€§èƒ½åŸºå‡†
- [ ] æ¢å¤åŸå§‹é…ç½®
```

### 14.3 æ€§èƒ½è°ƒä¼˜å†³ç­–çŸ©é˜µ


| æ•°æ®é‡çº§ | **å®‰å…¨è¦æ±‚** | **æ¨èç­–ç•¥** | **é¢„æœŸTPS** | **å…³é”®å‚æ•°** |
|---------|-------------|-------------|-------------|-------------|
| **< 1ä¸‡** | `é«˜` | `ç®€å•æ‰¹é‡ï¼Œæ‰¹å¤§å°500` | `1000-2000` | `flush_log=1` |
| **< 1ä¸‡** | `ä¸­` | `æ‰¹é‡+å°‘é‡ä¼˜åŒ–` | `2000-3000` | `flush_log=2` |
| **1-10ä¸‡** | `é«˜` | `æ‰¹é‡+å¹¶è¡Œï¼Œä¿æŒçº¦æŸ` | `3000-5000` | `flush_log=1ï¼Œæ‰¹å¤§å°2000` |
| **1-10ä¸‡** | `ä¸­` | `æ‰¹é‡+å¹¶è¡Œ+å‚æ•°ä¼˜åŒ–` | `8000-15000` | `flush_log=2ï¼Œæ‰¹å¤§å°5000` |
| **10-100ä¸‡** | `é«˜` | `åˆ†æ‰¹+ç›‘æ§+å¿«é€Ÿæ¢å¤` | `10000-20000` | `åˆ†æ‰¹æ“ä½œï¼ŒåŠæ—¶æ¢å¤` |
| **10-100ä¸‡** | `ä¸­` | `å…¨é¢ä¼˜åŒ–+å¹¶è¡Œå¤„ç†` | `20000-50000` | `flush_log=0ï¼Œå¤§æ‰¹é‡` |
| **> 100ä¸‡** | `ä»»æ„` | `LOAD DATA+åˆ†åŒº+å¹¶è¡Œ` | `50000+` | `ä¸“ç”¨å¯¼å…¥å·¥å…·` |

---

## 15. ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 15.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ‰¹é‡æ’å…¥çš„æœ¬è´¨ç†è§£**
```
æ€§èƒ½æå‡åŸç†ï¼š
â€¢ å‡å°‘ç½‘ç»œäº¤äº’æ¬¡æ•°ï¼šä»Næ¬¡å‡å°‘åˆ°N/æ‰¹å¤§å°æ¬¡
â€¢ é™ä½SQLè§£æå¼€é”€ï¼šä»Næ¬¡è§£æå‡å°‘åˆ°N/æ‰¹å¤§å°æ¬¡  
â€¢ æé«˜ç¼“å­˜åˆ©ç”¨ç‡ï¼šè¿ç»­æ“ä½œåŒä¸€è¡¨æé«˜ç¼“å­˜å‘½ä¸­
â€¢ å‡å°‘äº‹åŠ¡å¼€é”€ï¼šäº‹åŠ¡å¼€é”€åˆ†æ‘Šåˆ°å¤šæ¡è®°å½•

å…³é”®æƒè¡¡ï¼š
â€¢ æ€§èƒ½ vs å®‰å…¨æ€§ï¼šå‚æ•°è°ƒä¼˜å¸¦æ¥çš„é£é™©
â€¢ æ‰¹å¤§å° vs èµ„æºä½¿ç”¨ï¼šå¤§æ‰¹é‡å ç”¨æ›´å¤šå†…å­˜å’Œé”æ—¶é—´
â€¢ å¹¶è¡Œåº¦ vs èµ„æºç«äº‰ï¼šçº¿ç¨‹æ•°å¢åŠ å¸¦æ¥çš„ç«äº‰åŠ å‰§
â€¢ ç®€å•æ€§ vs æ•ˆç‡ï¼šä¼˜åŒ–å¤æ‚åº¦ä¸æ€§èƒ½æå‡çš„å¹³è¡¡
```

**ğŸ”¸ äº‹åŠ¡æ‰¹å¤§å°è°ƒä¼˜æ ¸å¿ƒ**
```
è°ƒä¼˜æ€è·¯ï¼š
æ‰¾åˆ°æ€§èƒ½ã€èµ„æºä½¿ç”¨ã€é”ç«äº‰çš„æœ€ä½³å¹³è¡¡ç‚¹

è®¡ç®—æ–¹æ³•ï¼š
â€¢ åŸºäºå†…å­˜é™åˆ¶ï¼šå¯ç”¨å†…å­˜ / å•æ¡è®°å½•å¤§å°
â€¢ åŸºäºæ—¶é—´é™åˆ¶ï¼šæœ€å¤§äº‹åŠ¡æ—¶é—´ / å•æ¡å¤„ç†æ—¶é—´  
â€¢ åŸºäºå¹¶å‘é™åˆ¶ï¼šé¿å…é•¿æ—¶é—´é”ç«äº‰

å®é™…å»ºè®®ï¼š
â€¢ OLTPç³»ç»Ÿï¼š500-1000æ¡
â€¢ ETLå¤„ç†ï¼š2000-5000æ¡
â€¢ æ•°æ®ä»“åº“ï¼š5000-10000æ¡
â€¢ æ—¥å¿—å¯¼å…¥ï¼š10000æ¡ä»¥ä¸Š
```

### 15.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ innodb_flush_log_at_trx_commitæ·±åº¦ç†è§£**
```
å‚æ•°çš„æœ¬è´¨ï¼š
æ§åˆ¶redo logä»å†…å­˜åˆ·åˆ°ç£ç›˜çš„æ—¶æœº
ç›´æ¥å½±å“æ•°æ®æŒä¹…æ€§å’Œæ’å…¥æ€§èƒ½

ä¸‰ç§æ¨¡å¼çš„åº”ç”¨åœºæ™¯ï¼š
â€¢ å€¼=1ï¼šé‡‘èç³»ç»Ÿï¼Œæ•°æ®ç»å¯¹ä¸èƒ½ä¸¢å¤±
â€¢ å€¼=2ï¼šä¸€èˆ¬ä¸šåŠ¡ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨  
â€¢ å€¼=0ï¼šæ•°æ®åˆ†æï¼Œæ€§èƒ½ä¼˜å…ˆ

æ€§èƒ½å·®å¼‚ï¼š
â€¢ æ¨¡å¼0æ¯”æ¨¡å¼1å¿«5-10å€
â€¢ ä½†MySQLå´©æºƒå¯èƒ½ä¸¢å¤±1ç§’æ•°æ®
â€¢ éœ€è¦æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹æƒè¡¡é€‰æ‹©
```

**ğŸ”¹ å¹¶è¡Œæ’å…¥ç­–ç•¥ç²¾è¦**
```
å¹¶è¡ŒåŒ–çš„å…³é”®ï¼š
â€¢ é¿å…çƒ­ç‚¹ç«äº‰ï¼šä¸åŒçº¿ç¨‹æ“ä½œä¸åŒæ•°æ®èŒƒå›´
â€¢ åˆç†æ§åˆ¶å¹¶å‘åº¦ï¼šCPUæ ¸æ•°çš„1-2å€
â€¢ èµ„æºç›‘æ§ï¼šé˜²æ­¢ç³»ç»Ÿè¿‡è½½
â€¢ é”™è¯¯éš”ç¦»ï¼šå•ä¸ªçº¿ç¨‹å¤±è´¥ä¸å½±å“æ•´ä½“

åˆ†åŒºè¡¨çš„å¨åŠ›ï¼š
â€¢ ä¸åŒåˆ†åŒºæ— é”ç«äº‰
â€¢ å¯ä»¥çœŸæ­£å®ç°å¹¶è¡Œæ’å…¥
â€¢ æ¯ä¸ªåˆ†åŒºç‹¬ç«‹ä¼˜åŒ–
â€¢ æ•…éšœå½±å“èŒƒå›´æœ‰é™
```

### 15.3 ç”Ÿäº§ç¯å¢ƒå®æ–½æŒ‡å—


**ğŸ¯ åˆ†é˜¶æ®µå®æ–½ç­–ç•¥**
```
ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨è¯•éªŒ
â€¢ åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ•ˆæœ
â€¢ å°æ‰¹é‡æ•°æ®æµ‹è¯•
â€¢ ç›‘æ§ç³»ç»Ÿè¡¨ç°
â€¢ å»ºç«‹å›æ»šæ–¹æ¡ˆ

ç¬¬äºŒé˜¶æ®µï¼šæ¸è¿›ä¼˜åŒ–  
â€¢ ä»ä¿å®ˆå‚æ•°å¼€å§‹
â€¢ é€æ­¥å¢å¤§æ‰¹é‡å¤§å°
â€¢ ç›‘æ§å…³é”®æŒ‡æ ‡
â€¢ è®°å½•æœ€ä¼˜é…ç½®

ç¬¬ä¸‰é˜¶æ®µï¼šå…¨é¢åº”ç”¨
â€¢ åº”ç”¨æœ€ä¼˜é…ç½®
â€¢ å»ºç«‹ç›‘æ§å‘Šè­¦
â€¢ å®šæœŸæ€§èƒ½å›é¡¾
â€¢ æŒç»­ä¼˜åŒ–è°ƒæ•´

ç¬¬å››é˜¶æ®µï¼šè‡ªåŠ¨åŒ–è¿ç»´
â€¢ è„šæœ¬åŒ–æ“ä½œæµç¨‹
â€¢ è‡ªåŠ¨å‚æ•°è°ƒä¼˜
â€¢ æ™ºèƒ½é”™è¯¯å¤„ç†
â€¢ æ€§èƒ½è¶‹åŠ¿åˆ†æ
```

**ğŸ“Š æ•ˆæœè¯„ä¼°æŒ‡æ ‡**
```
æ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ TPSæå‡ï¼šç›®æ ‡æå‡5-20å€
â€¢ å“åº”æ—¶é—´ï¼šæ‰¹é‡æ“ä½œè€—æ—¶å‡å°‘
â€¢ èµ„æºåˆ©ç”¨ç‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ä¼˜åŒ–

ä¸šåŠ¡æŒ‡æ ‡ï¼š
â€¢ æ•°æ®å¯¼å…¥æ—¶é—´çª—å£ï¼šä»å°æ—¶çº§åˆ«ä¼˜åŒ–åˆ°åˆ†é’Ÿçº§åˆ«
â€¢ ä¸šåŠ¡å½±å“æ—¶é—´ï¼šå‡å°‘å¯¹æ­£å¸¸ä¸šåŠ¡çš„å½±å“
â€¢ é”™è¯¯ç‡ï¼šä¿æŒåœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ<1%ï¼‰

è¿ç»´æŒ‡æ ‡ï¼š
â€¢ æ“ä½œå¤æ‚åº¦ï¼šè‡ªåŠ¨åŒ–ç¨‹åº¦æå‡
â€¢ æ•…éšœæ¢å¤æ—¶é—´ï¼šå‡å°‘äººå·¥å¹²é¢„æ—¶é—´
â€¢ ç›‘æ§è¦†ç›–åº¦ï¼šå…³é”®æŒ‡æ ‡å…¨é¢ç›‘æ§
```

### 15.4 æŠ€æœ¯å‘å±•è¶‹åŠ¿


**ğŸš€ æœªæ¥å‘å±•æ–¹å‘**
```
ç¡¬ä»¶ä¼˜åŒ–è¶‹åŠ¿ï¼š
â€¢ NVMe SSDï¼šæ›´å¿«çš„ç£ç›˜IOæ€§èƒ½
â€¢ å¤§å†…å­˜æœåŠ¡å™¨ï¼šå‡å°‘ç£ç›˜äº¤äº’
â€¢ å¤šæ ¸CPUï¼šæ›´å¥½çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›

æ•°æ®åº“æŠ€æœ¯å‘å±•ï¼š
â€¢ å†…å­˜æ•°æ®åº“ï¼šRedisã€MemSQLç­‰
â€¢ åˆ—å¼å­˜å‚¨ï¼šClickHouseã€Apache Parquet
â€¢ åˆ†å¸ƒå¼æ•°æ®åº“ï¼šTiDBã€MySQL Cluster

äº‘åŸç”Ÿä¼˜åŒ–ï¼š
â€¢ å®¹å™¨åŒ–éƒ¨ç½²ï¼šå¿«é€Ÿæ‰©å®¹ç¼©å®¹
â€¢ æ— æœåŠ¡å™¨æ•°æ®åº“ï¼šæŒ‰éœ€è®¡è´¹
â€¢ æ‰˜ç®¡æœåŠ¡ï¼šäº‘å‚å•†ä¼˜åŒ–çš„æ‰¹é‡å¯¼å…¥æœåŠ¡
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **æ‰¹é‡æ’å…¥æ ¸å¿ƒ**ï¼šå‡å°‘äº¤äº’æ¬¡æ•°ï¼Œæé«˜ç¼“å­˜åˆ©ç”¨ç‡
- **äº‹åŠ¡æ‰¹å¤§å°**ï¼šå¹³è¡¡æ€§èƒ½ã€èµ„æºã€é”ç«äº‰çš„å…³é”®å‚æ•°
- **å‚æ•°è°ƒä¼˜**ï¼šinnodb_flush_log_at_trx_commitæ˜¯æ€§èƒ½å…³é”®
- **å¹¶è¡Œç­–ç•¥**ï¼šé¿å…çƒ­ç‚¹ç«äº‰ï¼Œåˆç†æ§åˆ¶å¹¶å‘åº¦
- **å®‰å…¨ç¬¬ä¸€**ï¼šæ€§èƒ½ä¼˜åŒ–ä¸èƒ½ä»¥æ•°æ®å®‰å…¨ä¸ºä»£ä»·
- **ç›‘æ§é‡è¦**ï¼šå®æ—¶ç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜