---
title: 2、mysqlpump使用
---
## 📚 目录

1. [mysqlpump基础概念](#1-mysqlpump基础概念)
2. [并行备份技术](#2-并行备份技术)
3. [压缩与性能优化](#3-压缩与性能优化)
4. [对象过滤与排除](#4-对象过滤与排除)
5. [进度监控与故障恢复](#5-进度监控与故障恢复)
6. [与其他备份工具对比](#6-与其他备份工具对比)
7. [实际应用场景](#7-实际应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🚀 mysqlpump基础概念


### 1.1 什么是mysqlpump


**简单理解**：mysqlpump是MySQL 5.7版本引入的新一代逻辑备份工具，可以看作是mysqldump的"加强版"。

```
传统备份方式：           mysqlpump方式：
mysqldump               mysqlpump
    |                       |
单线程备份          →    多线程并行备份
顺序导出           →    对象级并行导出
无压缩选项          →    内置压缩算法
基础进度显示        →    详细进度监控
```

**核心特点**：
- **并行处理**：支持多线程同时备份不同的数据库对象
- **压缩支持**：内置多种压缩算法，减少备份文件大小
- **精细控制**：可以按数据库、表、用户等维度进行过滤
- **进度监控**：实时显示备份进度和性能指标

### 1.2 基本使用语法


**命令格式**：
```bash
mysqlpump [选项] [数据库名...]
```

**最简单的备份示例**：
```bash
# 备份整个MySQL实例
mysqlpump -u root -p > full_backup.sql

# 备份指定数据库
mysqlpump -u root -p mydb > mydb_backup.sql

# 备份多个数据库
mysqlpump -u root -p db1 db2 db3 > multi_db_backup.sql
```

### 1.3 与mysqldump的直观对比


| 特性对比 | **mysqldump** | **mysqlpump** | **说明** |
|---------|--------------|---------------|----------|
| 🔄 **并行能力** | `单线程` | `多线程并行` | `mysqlpump可同时处理多个对象` |
| 📦 **压缩功能** | `需外部工具` | `内置压缩` | `mysqlpump直接支持gzip/lz4压缩` |
| 📊 **进度显示** | `基础信息` | `详细监控` | `实时显示备份进度和速度` |
| 🎯 **过滤功能** | `有限支持` | `精细控制` | `支持复杂的包含/排除规则` |
| 👥 **用户备份** | `不支持` | `完整支持` | `可备份用户账户和权限` |

---

## 2. ⚡ 并行备份技术


### 2.1 并行备份的工作原理


**传统单线程vs并行多线程**：

```
单线程备份流程：
时间轴  →→→→→→→→→→→→→→→→→→→
线程1   [表A][表B][表C][表D][表E]

多线程并行流程：
时间轴  →→→→→→→→→→
线程1   [表A] [表D]
线程2   [表B] [表E]  
线程3   [表C]
```

**对象级并行**：mysqlpump可以同时处理不同类型的数据库对象：
- **表数据**：多个线程同时导出不同表的数据
- **存储过程**：单独线程处理存储过程
- **触发器**：独立线程处理触发器
- **用户权限**：专门线程处理用户和权限信息

### 2.2 并行度配置详解


#### `--default-parallelism` 参数配置


**语法**：`--default-parallelism=N`

```bash
# 使用2个并行线程
mysqlpump --default-parallelism=2 -u root -p mydb > backup.sql

# 使用4个并行线程（推荐配置）
mysqlpump --default-parallelism=4 -u root -p mydb > backup.sql

# 使用8个并行线程（高性能服务器）
mysqlpump --default-parallelism=8 -u root -p mydb > backup.sql
```

**并行度选择建议**：

| 服务器配置 | **推荐并行度** | **原因说明** |
|-----------|---------------|-------------|
| 🖥️ **2核CPU** | `2-3线程` | `避免CPU过载，保持系统响应` |
| 🖥️ **4核CPU** | `4-6线程` | `充分利用CPU资源` |
| 🖥️ **8核+CPU** | `6-8线程` | `高并行但避免资源竞争` |
| 💾 **SSD存储** | `可适当提高` | `IO瓶颈较小，可提高并行度` |
| 💾 **机械硬盘** | `保守配置` | `IO限制明显，过高并行度无益` |

### 2.3 并行度优化算法


**mysqlpump的智能调度**：

```
调度策略示意：
                mysqlpump调度器
                      |
        ┌─────────────┼─────────────┐
        |             |             |
    线程池1         线程池2       线程池3
    [表数据]       [存储过程]     [触发器]
        |             |             |
   ┌────┼────┐        |             |
表A   表B   表C      SP1           T1
```

**内存使用优化策略**：
- **缓冲区管理**：每个线程独立的输出缓冲区
- **内存复用**：避免重复分配内存空间
- **动态调整**：根据数据量自动调整缓冲区大小

```bash
# 控制内存使用的参数组合
mysqlpump \
  --default-parallelism=4 \
  --single-transaction \
  --routines \
  --triggers \
  -u root -p mydb > backup.sql
```

---

## 3. 📦 压缩与性能优化


### 3.1 压缩算法选择


**`--compress-output` 压缩选项**：

mysqlpump支持多种压缩算法，可以显著减少备份文件大小。

```bash
# 使用gzip压缩（默认压缩算法）
mysqlpump --compress-output=gzip -u root -p mydb > backup.sql.gz

# 使用lz4压缩（速度更快）
mysqlpump --compress-output=lz4 -u root -p mydb > backup.sql.lz4

# 使用zlib压缩（兼容性好）
mysqlpump --compress-output=zlib -u root -p mydb > backup.sql.zlib
```

**压缩算法对比**：

| 压缩算法 | **压缩率** | **压缩速度** | **CPU占用** | **适用场景** |
|---------|-----------|-------------|-------------|-------------|
| 🗜️ **gzip** | `高（70-80%）` | `中等` | `中等` | `存储空间优先` |
| ⚡ **lz4** | `中等（60-70%）` | `很快` | `较低` | `备份速度优先` |
| 🔧 **zlib** | `高（75-85%）` | `较慢` | `较高` | `兼容性要求高` |

### 3.2 压缩效果实测


**压缩前后对比示例**：

```
测试数据库：100万条记录，500MB数据

压缩方式        备份文件大小    压缩时间    压缩率
无压缩          500MB          30秒       0%
gzip压缩        125MB          45秒       75%
lz4压缩         150MB          35秒       70%
zlib压缩        120MB          50秒       76%
```

**选择建议**：
- **日常备份**：推荐使用 `gzip`，平衡压缩率和速度
- **快速备份**：使用 `lz4`，适合频繁备份场景
- **长期存储**：使用 `zlib`，最大化节省存储空间

### 3.3 性能监控指标


**关键性能指标**：

```bash
# 备份过程中监控系统资源
mysqlpump \
  --default-parallelism=4 \
  --compress-output=gzip \
  --watch-progress \
  -u root -p mydb > backup.sql.gz
```

**性能监控要点**：
- **CPU使用率**：多线程+压缩会增加CPU负载
- **内存占用**：并行线程需要更多内存缓冲区
- **磁盘IO**：读取数据库文件和写入备份文件的IO负载
- **网络带宽**：远程备份时的网络传输速度

---

## 4. 🎯 对象过滤与排除


### 4.1 包含和排除规则设计


**基本过滤语法**：

```bash
# 包含特定数据库
mysqlpump --include-databases=db1,db2 -u root -p > partial_backup.sql

# 排除特定数据库
mysqlpump --exclude-databases=test,temp -u root -p > backup_without_test.sql

# 包含特定表
mysqlpump --include-tables=users,orders -u root -p mydb > tables_backup.sql

# 排除特定表
mysqlpump --exclude-tables=temp_*,log_* -u root -p mydb > backup_no_temp.sql
```

### 4.2 复杂过滤规则示例


**通配符使用**：

```bash
# 排除所有临时表（以temp_开头）
mysqlpump --exclude-tables=temp_* -u root -p

# 排除所有日志表（以log_结尾）  
mysqlpump --exclude-tables=*_log -u root -p

# 只备份用户相关的表
mysqlpump --include-tables=user*,account* -u root -p mydb
```

**组合过滤规则**：

```bash
# 复杂过滤示例：备份生产数据但排除临时和日志数据
mysqlpump \
  --include-databases=production,user_center \
  --exclude-tables=temp_*,*_log,*_cache \
  --exclude-triggers \
  --default-parallelism=4 \
  -u root -p > production_backup.sql
```

### 4.3 用户权限备份


**用户和权限的完整备份**：

```bash
# 备份所有用户和权限
mysqlpump --include-users=% -u root -p > users_backup.sql

# 备份特定用户
mysqlpump --include-users=app_user,readonly_user -u root -p > specific_users.sql

# 排除系统用户
mysqlpump --exclude-users=mysql.%,sys.% -u root -p > custom_users.sql
```

**用户备份的特殊性**：
- **密码信息**：包含用户的加密密码
- **权限详情**：全局权限、数据库权限、表权限
- **角色信息**：MySQL 8.0的角色和权限继承关系

---

## 5. 📊 进度监控与故障恢复


### 5.1 进度监控功能


**`--watch-progress` 进度监控**：

```bash
# 启用详细进度监控
mysqlpump --watch-progress --default-parallelism=4 -u root -p mydb > backup.sql
```

**进度显示内容**：

```
进度监控输出示例：
Dump progress: 1/4 tables, 250000/1000000 rows
Completed: 25% | Speed: 50MB/s | ETA: 00:03:45
Current: Dumping table 'orders' (thread 2)
Memory: 128MB used | Threads: 4 active

实时信息说明：
- 已完成表数和总表数
- 已处理行数和预计总行数  
- 完成百分比和预计剩余时间
- 当前处理的具体对象
- 内存使用和活跃线程数
```

### 5.2 故障恢复机制


**备份中断的处理**：

mysqlpump本身不支持断点续传，但可以通过一些策略来减少故障影响：

```bash
# 使用事务一致性备份（避免数据不一致）
mysqlpump --single-transaction --default-parallelism=4 -u root -p mydb > backup.sql

# 分库备份策略（降低单次备份风险）
for db in db1 db2 db3; do
    mysqlpump --default-parallelism=2 -u root -p $db > ${db}_backup.sql
done
```

**故障预防措施**：
- **磁盘空间检查**：备份前确保有足够磁盘空间
- **网络稳定性**：远程备份时确保网络连接稳定
- **资源监控**：避免在系统负载过高时进行备份
- **备份验证**：备份完成后验证文件完整性

### 5.3 性能调优建议


**系统资源优化配置**：

```bash
# 针对不同场景的优化配置

# 高性能服务器配置
mysqlpump \
  --default-parallelism=8 \
  --compress-output=lz4 \
  --single-transaction \
  --watch-progress \
  -u root -p mydb > backup.sql.lz4

# 资源受限环境配置  
mysqlpump \
  --default-parallelism=2 \
  --compress-output=gzip \
  --single-transaction \
  -u root -p mydb > backup.sql.gz

# 快速备份配置（优先速度）
mysqlpump \
  --default-parallelism=6 \
  --compress-output=lz4 \
  --skip-triggers \
  --skip-routines \
  -u root -p mydb > quick_backup.sql.lz4
```

---

## 6. 🔄 与其他备份工具对比


### 6.1 mysqlpump vs mysqldump


**详细功能对比**：

| 功能特性 | **mysqldump** | **mysqlpump** | **优势说明** |
|---------|--------------|---------------|-------------|
| 🚀 **备份速度** | `单线程限制` | `多线程加速` | `mysqlpump可提升2-5倍速度` |
| 💾 **文件大小** | `无内置压缩` | `多种压缩算法` | `mysqlpump可减少70%+文件大小` |
| 🎯 **精确控制** | `基础过滤` | `精细过滤规则` | `mysqlpump支持复杂过滤条件` |
| 👥 **用户备份** | `需额外工具` | `原生支持` | `mysqlpump一站式备份用户权限` |
| 📊 **进度监控** | `基础信息` | `详细实时监控` | `mysqlpump提供丰富的进度信息` |
| 🔧 **兼容性** | `所有版本` | `MySQL 5.7+` | `mysqldump兼容性更好` |

### 6.2 mysqlpump vs mydumper


**与第三方工具对比**：

```
性能对比测试（100GB数据库）：

工具          备份时间    文件大小    并行能力    使用难度
mysqldump     4小时      100GB      单线程      简单
mysqlpump     1.5小时    30GB       4线程       简单  
mydumper      1小时      25GB       8线程       复杂
```

**选择建议**：
- **简单场景**：优先选择 `mysqlpump`，官方工具更可靠
- **极致性能**：考虑 `mydumper`，但需要额外安装和配置
- **兼容性要求**：使用 `mysqldump`，支持所有MySQL版本

### 6.3 适用场景分析


**mysqlpump最佳适用场景**：

```
✅ 推荐使用场景：
- 中到大型数据库备份（10GB-1TB）
- 需要压缩的备份任务
- 有精细过滤需求的备份
- MySQL 5.7+环境
- 需要用户权限备份

❌ 不推荐场景：
- 超大型数据库（1TB+）
- MySQL 5.6及以下版本
- 对兼容性要求极高的环境
- 需要增量备份的场景
```

---

## 7. 🎯 实际应用场景


### 7.1 日常备份策略


**生产环境备份脚本示例**：

```bash
#!/bin/bash
# MySQL日常备份脚本

# 配置参数
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="backup_user"
MYSQL_PASS="backup_password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 全量备份
mysqlpump \
  --default-parallelism=4 \
  --compress-output=gzip \
  --single-transaction \
  --routines \
  --triggers \
  --exclude-databases=information_schema,performance_schema,sys \
  -u $MYSQL_USER -p$MYSQL_PASS \
  > $BACKUP_DIR/full_backup_$DATE.sql.gz

# 验证备份文件
if [ $? -eq 0 ]; then
    echo "备份成功：full_backup_$DATE.sql.gz"
    # 清理7天前的备份
    find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
else
    echo "备份失败！"
    exit 1
fi
```

### 7.2 分库分表备份策略


**大型数据库的分库备份**：

```bash
#!/bin/bash
# 分库并行备份策略

databases=("user_db" "order_db" "product_db" "log_db")

# 并行备份多个数据库
for db in "${databases[@]}"; do
    (
        echo "开始备份数据库: $db"
        mysqlpump \
          --default-parallelism=2 \
          --compress-output=lz4 \
          --single-transaction \
          -u root -p$MYSQL_PASS \
          $db > /backup/${db}_$(date +%Y%m%d).sql.lz4
        echo "完成备份数据库: $db"
    ) &
done

# 等待所有备份完成
wait
echo "所有数据库备份完成"
```

### 7.3 开发环境数据同步


**从生产环境备份到开发环境**：

```bash
# 备份生产环境数据（排除敏感信息）
mysqlpump \
  --default-parallelism=4 \
  --compress-output=gzip \
  --exclude-tables=user_password,payment_info,sensitive_* \
  --where="created_date >= '2024-01-01'" \
  -h prod-mysql-server \
  -u backup_user -p \
  production_db > dev_data.sql.gz

# 恢复到开发环境
gunzip < dev_data.sql.gz | mysql -h dev-mysql-server -u dev_user -p dev_db
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 mysqlpump本质：MySQL 5.7+的多线程逻辑备份工具
🔸 核心优势：并行处理、内置压缩、精细过滤、进度监控
🔸 并行机制：对象级并行，多线程同时处理不同数据库对象
🔸 压缩选择：gzip平衡性最好，lz4速度最快，zlib压缩率最高
🔸 过滤规则：支持数据库、表、用户等多维度包含/排除规则
```

### 8.2 关键理解要点


**🔹 何时选择mysqlpump**：
```
适用场景判断：
✅ 数据库大小：10GB-1TB范围
✅ MySQL版本：5.7及以上
✅ 性能要求：需要快速备份
✅ 存储限制：需要压缩功能
✅ 复杂需求：需要精细过滤
```

**🔹 并行度配置原则**：
```
配置考虑因素：
- CPU核心数：一般设置为核心数的1-1.5倍
- 内存大小：每线程约需要32-64MB内存
- 磁盘类型：SSD可适当提高，HDD需保守
- 网络环境：远程备份需考虑网络带宽
```

**🔹 压缩算法选择策略**：
```
选择原则：
- 日常备份：gzip（平衡压缩率和速度）
- 快速备份：lz4（优先备份速度）
- 长期存储：zlib（最大化节省空间）
- 网络传输：优先选择高压缩率算法
```

### 8.3 实际应用指导


**🔧 最佳实践配置**：
```bash
# 通用生产环境配置
mysqlpump \
  --default-parallelism=4 \
  --compress-output=gzip \
  --single-transaction \
  --routines \
  --triggers \
  --watch-progress \
  --exclude-databases=information_schema,performance_schema,sys
```

**📊 性能监控要点**：
- **备份速度**：监控MB/s传输速度
- **资源使用**：CPU、内存、磁盘IO使用率  
- **压缩效果**：压缩前后文件大小对比
- **并行效率**：线程使用情况和负载均衡

**⚠️ 常见问题避免**：
- **并行度过高**：导致系统资源竞争，反而降低性能
- **压缩选择不当**：高压缩率但CPU负载过重
- **过滤规则复杂**：影响备份性能，增加出错概率
- **缺少进度监控**：无法及时发现备份异常

### 8.4 与其他工具的选择逻辑


```
工具选择决策树：

MySQL版本？
├─ 5.6及以下 → 使用mysqldump
└─ 5.7及以上 → 继续判断

数据库大小？
├─ <10GB → mysqldump足够
├─ 10GB-1TB → mysqlpump最佳
└─ >1TB → 考虑mydumper或物理备份

特殊需求？
├─ 需要增量备份 → 使用binlog或Xtrabackup
├─ 需要实时备份 → 使用主从复制
└─ 普通逻辑备份 → mysqlpump
```

**核心记忆口诀**：
- mysqlpump并行快，压缩过滤功能全
- 并行度配置要适中，压缩算法看场景
- 进度监控很重要，故障恢复有预案
- 生产环境要测试，备份验证不能忘