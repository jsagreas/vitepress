---
title: 9ã€MySQLä¼˜åŒ–å™¨è·Ÿè¸ªæŠ€æœ¯
---
## ğŸ“š ç›®å½•

1. [ä¼˜åŒ–å™¨è·Ÿè¸ªæŠ€æœ¯æ¦‚è¿°](#1-ä¼˜åŒ–å™¨è·Ÿè¸ªæŠ€æœ¯æ¦‚è¿°)
2. [optimizer_traceåŠŸèƒ½è¯¦è§£](#2-optimizer_traceåŠŸèƒ½è¯¦è§£)
3. [è·Ÿè¸ªä¿¡æ¯JSONè§£æ](#3-è·Ÿè¸ªä¿¡æ¯jsonè§£æ)
4. [ä¼˜åŒ–é˜¶æ®µè¯¦ç»†åˆ†æ](#4-ä¼˜åŒ–é˜¶æ®µè¯¦ç»†åˆ†æ)
5. [æˆæœ¬è®¡ç®—è¿‡ç¨‹æ·±åº¦å‰–æ](#5-æˆæœ¬è®¡ç®—è¿‡ç¨‹æ·±åº¦å‰–æ)
6. [å€™é€‰æ‰§è¡Œè®¡åˆ’å¯¹æ¯”åˆ†æ](#6-å€™é€‰æ‰§è¡Œè®¡åˆ’å¯¹æ¯”åˆ†æ)
7. [è·Ÿè¸ªæ•°æ®æŒ–æ˜ä¸å¯è§†åŒ–](#7-è·Ÿè¸ªæ•°æ®æŒ–æ˜ä¸å¯è§†åŒ–)
8. [è‡ªåŠ¨åŒ–è¯Šæ–­å·¥å…·å¼€å‘](#8-è‡ªåŠ¨åŒ–è¯Šæ–­å·¥å…·å¼€å‘)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¼˜åŒ–å™¨è·Ÿè¸ªæŠ€æœ¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨è·Ÿè¸ª


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šä¼˜åŒ–å™¨è·Ÿè¸ªå°±åƒæ˜¯ç»™MySQLçš„"å¤§è„‘"è£…äº†ä¸€ä¸ªå½•åƒè®¾å¤‡ï¼Œè®°å½•å®ƒæ˜¯å¦‚ä½•æ€è€ƒå’Œå†³ç­–çš„

**ä¼˜åŒ–å™¨è·Ÿè¸ªçš„æ ¸å¿ƒä½œç”¨**ï¼š
```
SQLæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼š
è¾“å…¥SQL â”€â”€â–º ä¼˜åŒ–å™¨åˆ†æ â”€â”€â–º æ‰§è¡Œè®¡åˆ’ â”€â”€â–º æ‰§è¡Œç»“æœ
             â”‚              â”‚
             â”‚              â–¼
             â”‚        æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™é‡Œ
             â”‚        (é€šè¿‡EXPLAIN)
             â–¼
        è¿™é‡Œæ˜¯é»‘ç›’ï¼ â† ä¼˜åŒ–å™¨è·Ÿè¸ªè§£å†³è¿™ä¸ªé—®é¢˜
        (ä¼˜åŒ–è¿‡ç¨‹)
```

**è·Ÿè¸ªè§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- **å†³ç­–é€æ˜åŒ–**ï¼šäº†è§£ä¼˜åŒ–å™¨ä¸ºä»€ä¹ˆé€‰æ‹©æŸä¸ªæ‰§è¡Œè®¡åˆ’
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ‰¾åˆ°æŸ¥è¯¢æ…¢çš„çœŸæ­£åŸå› 
- **ç´¢å¼•ä¼˜åŒ–**ï¼šç†è§£ç´¢å¼•çš„å®é™…ä½¿ç”¨æ•ˆæœ
- **å‚æ•°è°ƒæ•´**ï¼šåŸºäºæ•°æ®åšå‡ºåˆç†çš„é…ç½®è°ƒæ•´

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–å™¨è·Ÿè¸ª


**ä¼ ç»Ÿåˆ†ææ–¹æ³•çš„å±€é™æ€§**ï¼š
```
ä¼ ç»Ÿæ–¹æ³•åªèƒ½çœ‹åˆ°ç»“æœï¼š
â”Œâ”€ EXPLAINè¾“å‡º â”€â”
â”‚ id | type | key â”‚
â”‚ 1  | ref  | idx â”‚ â† åªçŸ¥é“ç”¨äº†ä»€ä¹ˆç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½†ä¸çŸ¥é“è¿‡ç¨‹ï¼š
â“ ä¸ºä»€ä¹ˆæ²¡é€‰æ‹©å…¶ä»–ç´¢å¼•ï¼Ÿ
â“ æˆæœ¬è®¡ç®—æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ
â“ æœ‰å“ªäº›å€™é€‰æ–¹æ¡ˆè¢«æ’é™¤äº†ï¼Ÿ
â“ ä¼˜åŒ–å™¨åœ¨å“ªä¸ªé˜¶æ®µåšçš„å†³å®šï¼Ÿ
```

**è·Ÿè¸ªæŠ€æœ¯çš„ä»·å€¼**ï¼š
- **è¿‡ç¨‹å¯è§**ï¼šçœ‹åˆ°ä¼˜åŒ–å™¨çš„å®Œæ•´æ€è€ƒè¿‡ç¨‹
- **å†³ç­–ä¾æ®**ï¼šäº†è§£æ¯ä¸ªé€‰æ‹©çš„å…·ä½“åŸå› 
- **æˆæœ¬é€æ˜**ï¼šæŸ¥çœ‹è¯¦ç»†çš„æˆæœ¬è®¡ç®—å…¬å¼
- **è°ƒä¼˜æŒ‡å¯¼**ï¼šåŸºäºçœŸå®æ•°æ®è¿›è¡Œç²¾å‡†ä¼˜åŒ–

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


**æœ€é€‚åˆä½¿ç”¨è·Ÿè¸ªçš„åœºæ™¯**ï¼š
- âœ… **æŸ¥è¯¢æ€§èƒ½å¼‚å¸¸**ï¼šåŒæ ·çš„SQLåœ¨ä¸åŒç¯å¢ƒä¸‹æ€§èƒ½å·®å¼‚å¾ˆå¤§
- âœ… **ç´¢å¼•é€‰æ‹©å›°æƒ‘**ï¼šä¼˜åŒ–å™¨é€‰æ‹©äº†æ„å¤–çš„ç´¢å¼•
- âœ… **æˆæœ¬ä¼°ç®—åå·®**ï¼šå®é™…æ‰§è¡Œæ—¶é—´ä¸é¢„æœŸä¸ç¬¦
- âœ… **ä¼˜åŒ–æ–¹æ¡ˆå¯¹æ¯”**ï¼šéœ€è¦éªŒè¯ä¸åŒä¼˜åŒ–ç­–ç•¥çš„æ•ˆæœ

---

## 2. âš™ï¸ optimizer_traceåŠŸèƒ½è¯¦è§£


### 2.1 optimizer_traceå¼€å¯æ–¹æ³•


> ğŸ”§ **æ“ä½œè¯´æ˜**ï¼šoptimizer_traceæ˜¯MySQL 5.6+ç‰ˆæœ¬æä¾›çš„å†…ç½®è·Ÿè¸ªåŠŸèƒ½

**åŸºç¡€å¼€å¯æ­¥éª¤**ï¼š
```sql
-- ç¬¬1æ­¥ï¼šå¯ç”¨ä¼˜åŒ–å™¨è·Ÿè¸ª
SET optimizer_trace='enabled=on';

-- ç¬¬2æ­¥ï¼šè®¾ç½®è·Ÿè¸ªèŒƒå›´(å¯é€‰)
SET optimizer_trace_max_mem_size = 1048576;  -- 1MB
SET optimizer_trace_offset = 0;              -- ä»ç¬¬å‡ ä¸ªå¼€å§‹
SET optimizer_trace_limit = 1;               -- è·Ÿè¸ªå‡ ä¸ªæŸ¥è¯¢

-- ç¬¬3æ­¥ï¼šæ‰§è¡Œè¦åˆ†æçš„SQL
SELECT * FROM users WHERE age > 25 AND city = 'Beijing';

-- ç¬¬4æ­¥ï¼šæŸ¥çœ‹è·Ÿè¸ªç»“æœ
SELECT * FROM information_schema.OPTIMIZER_TRACE;

-- ç¬¬5æ­¥ï¼šå…³é—­è·Ÿè¸ª(é‡è¦!)
SET optimizer_trace='enabled=off';
```

**å…³é”®å‚æ•°è¯¦è§£**ï¼š

| å‚æ•°åç§° | **ä½œç”¨è¯´æ˜** | **æ¨èè®¾ç½®** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-------------|-------------|
| `enabled` | `æ˜¯å¦å¯ç”¨è·Ÿè¸ª` | `ä¸´æ—¶å¼€å¯` | `ç”¨å®Œç«‹å³å…³é—­` |
| `max_mem_size` | `è·Ÿè¸ªä¿¡æ¯æœ€å¤§å†…å­˜` | `1MB-10MB` | `å¤ªå°ä¼šæˆªæ–­ä¿¡æ¯` |
| `offset` | `è·³è¿‡å‰Nä¸ªæŸ¥è¯¢` | `0` | `ç”¨äºè¿‡æ»¤æ— å…³æŸ¥è¯¢` |
| `limit` | `è·Ÿè¸ªæŸ¥è¯¢æ•°é‡` | `1-5` | `é¿å…ä¿¡æ¯è¿‡å¤š` |

### 2.2 è·Ÿè¸ªä¿¡æ¯è·å–æ–¹å¼


**è·å–è·Ÿè¸ªæ•°æ®çš„å®Œæ•´æµç¨‹**ï¼š
```sql
-- æ–¹å¼1ï¼šç›´æ¥æŸ¥è¯¢è·Ÿè¸ªè¡¨
SELECT 
    QUERY,                    -- è¢«è·Ÿè¸ªçš„SQLè¯­å¥
    TRACE,                    -- è¯¦ç»†çš„è·Ÿè¸ªä¿¡æ¯(JSONæ ¼å¼)
    MISSING_BYTES_BEYOND_MAX_MEM_SIZE  -- è¶…å‡ºå†…å­˜é™åˆ¶çš„å­—èŠ‚æ•°
FROM information_schema.OPTIMIZER_TRACE;

-- æ–¹å¼2ï¼šæ ¼å¼åŒ–æŸ¥çœ‹(æ¨è)
SELECT 
    QUERY,
    JSON_PRETTY(TRACE) AS formatted_trace
FROM information_schema.OPTIMIZER_TRACE\G
```

**è·Ÿè¸ªä¿¡æ¯çš„å­˜å‚¨ç‰¹ç‚¹**ï¼š
- **ä¼šè¯çº§åˆ«**ï¼šæ¯ä¸ªä¼šè¯ç‹¬ç«‹å­˜å‚¨
- **å¾ªç¯è¦†ç›–**ï¼šè¶…è¿‡limité™åˆ¶æ—¶è¦†ç›–æœ€æ—©çš„è®°å½•
- **å†…å­˜å­˜å‚¨**ï¼šä¸æŒä¹…åŒ–ï¼Œä¼šè¯ç»“æŸå³æ¸…ç©º

### 2.3 è·Ÿè¸ªæ€§èƒ½å¼€é”€æ§åˆ¶


> âš ï¸ **é‡è¦æé†’**ï¼šä¼˜åŒ–å™¨è·Ÿè¸ªä¼šæ˜¾è‘—å¢åŠ CPUå’Œå†…å­˜å¼€é”€ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…ä½¿ç”¨

**æ€§èƒ½å¼€é”€åˆ†æ**ï¼š
```
è·Ÿè¸ªå¼€é”€æ„æˆï¼š
â”Œâ”€ CPUå¼€é”€ â”€â”
â”‚ â”œâ”€ æ•°æ®æ”¶é›†ï¼š+15-25% â”‚
â”‚ â”œâ”€ JSONæ„å»ºï¼š+10-15% â”‚
â”‚ â””â”€ å†…å­˜åˆ†é…ï¼š+5-10%  â”‚
â”œâ”€ å†…å­˜å¼€é”€ â”€â”¤
â”‚ â”œâ”€ è·Ÿè¸ªç¼“å†²åŒº        â”‚
â”‚ â”œâ”€ JSONå­˜å‚¨ç©ºé—´      â”‚
â”‚ â””â”€ ä¸´æ—¶æ•°æ®ç»“æ„      â”‚
â””â”€ I/Oå¼€é”€ â”€â”˜
  â””â”€ æŸ¥è¯¢è·Ÿè¸ªè¡¨æ—¶çš„è¯»å–
```

**å®‰å…¨ä½¿ç”¨ç­–ç•¥**ï¼š
```sql
-- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ¨¡æ¿
-- 1. åªåœ¨å¿…è¦æ—¶å¼€å¯
SET @old_trace = $$optimizer_trace;
SET optimizer_trace='enabled=on,one_line=off';

-- 2. æ‰§è¡Œç›®æ ‡SQL
SELECT your_query_here;

-- 3. å¿«é€Ÿè·å–ç»“æœ
SELECT TRACE FROM information_schema.OPTIMIZER_TRACE INTO @trace_result;

-- 4. ç«‹å³å…³é—­
SET optimizer_trace = @old_trace;

-- 5. ç¦»çº¿åˆ†æ
-- å°†@trace_resultå¯¼å‡ºåˆ°æ–‡ä»¶è¿›è¡Œè¯¦ç»†åˆ†æ
```

---

## 3. ğŸ“Š è·Ÿè¸ªä¿¡æ¯JSONè§£æ


### 3.1 è·Ÿè¸ªä¿¡æ¯ç»“æ„åŒ–åˆ†æ


> ğŸ“– **ç»“æ„è¯´æ˜**ï¼šè·Ÿè¸ªä¿¡æ¯æ˜¯ä¸€ä¸ªå¤æ‚çš„JSONç»“æ„ï¼ŒåŒ…å«ä¼˜åŒ–å™¨çš„å®Œæ•´å†³ç­–è¿‡ç¨‹

**JSONç»“æ„æ€»è§ˆ**ï¼š
```json
{
  "steps": [
    {
      "join_preparation": { ... },           // è¿æ¥å‡†å¤‡é˜¶æ®µ
      "join_optimization": { ... },          // è¿æ¥ä¼˜åŒ–é˜¶æ®µ  
      "join_execution": { ... }              // æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
    }
  ]
}
```

**ä¸»è¦ç»“æ„å±‚æ¬¡è§£æ**ï¼š
```
è·Ÿè¸ªä¿¡æ¯å±‚æ¬¡ç»“æ„ï¼š
optimizer_trace
â”œâ”€ steps[]                    â† ä¼˜åŒ–æ­¥éª¤æ•°ç»„
â”‚  â”œâ”€ join_preparation        â† å‡†å¤‡é˜¶æ®µ
â”‚  â”‚  â”œâ”€ select_id           â† SELECTè¯­å¥ID
â”‚  â”‚  â”œâ”€ steps[]             â† å‡†å¤‡å­æ­¥éª¤
â”‚  â”‚  â””â”€ expanded_query      â† æ‰©å±•åçš„æŸ¥è¯¢
â”‚  â”œâ”€ join_optimization      â† ä¼˜åŒ–é˜¶æ®µ(æ ¸å¿ƒ)
â”‚  â”‚  â”œâ”€ select_id          
â”‚  â”‚  â”œâ”€ steps[]            â† ä¼˜åŒ–å­æ­¥éª¤
â”‚  â”‚  â”‚  â”œâ”€ condition_processing    â† æ¡ä»¶å¤„ç†
â”‚  â”‚  â”‚  â”œâ”€ table_dependencies      â† è¡¨ä¾èµ–åˆ†æ
â”‚  â”‚  â”‚  â”œâ”€ ref_optimizer_key_uses  â† å¼•ç”¨é”®ä½¿ç”¨
â”‚  â”‚  â”‚  â”œâ”€ rows_estimation        â† è¡Œæ•°ä¼°ç®—
â”‚  â”‚  â”‚  â””â”€ considered_execution_plans â† å€™é€‰æ‰§è¡Œè®¡åˆ’
â”‚  â”‚  â””â”€ best_access_path    â† æœ€ä½³è®¿é—®è·¯å¾„
â”‚  â””â”€ join_execution         â† æ‰§è¡Œé˜¶æ®µ
â”‚     â””â”€ select_id
â””â”€ ...
```

### 3.2 å…³é”®å­—æ®µå«ä¹‰è§£æ


**join_preparationé˜¶æ®µå­—æ®µ**ï¼š
```json
{
  "join_preparation": {
    "select_id": 1,
    "steps": [
      {
        "expanded_query": "SELECT * FROM users WHERE age > 25"
      },
      {
        "transformations_to_nested_joins": {
          "transformations": ["JOIN_condition_to_WHERE"],
          "expanded_query": "/* ä¼˜åŒ–åçš„æŸ¥è¯¢ */"
        }
      }
    ]
  }
}
```

> ğŸ’¡ **å­—æ®µè§£é‡Š**ï¼š
> - `expanded_query`ï¼šæŸ¥è¯¢è¢«ä¼˜åŒ–å™¨å†…éƒ¨è½¬æ¢åçš„å½¢å¼
> - `transformations`ï¼šåº”ç”¨çš„æŸ¥è¯¢è½¬æ¢è§„åˆ™

**join_optimizationé˜¶æ®µæ ¸å¿ƒå­—æ®µ**ï¼š

<details>
<summary>ğŸ” å±•å¼€æŸ¥çœ‹è¯¦ç»†å­—æ®µè§£æ</summary>

```json
{
  "join_optimization": {
    "steps": [
      {
        "condition_processing": {
          "condition": "WHERE",
          "original_condition": "(age > 25) AND (city = 'Beijing')",
          "steps": [
            {
              "transformation": "equality_propagation",
              "resulting_condition": "/* ç­‰å€¼ä¼ æ’­åçš„æ¡ä»¶ */"
            }
          ]
        }
      },
      {
        "table_dependencies": [
          {
            "table": "users",
            "row_may_be_null": false,
            "map_bit": 0,
            "depends_on_map_bits": []
          }
        ]
      },
      {
        "rows_estimation": [
          {
            "table": "users",
            "range_analysis": {
              "table_scan": {
                "rows": 100000,
                "cost": 20450.25
              },
              "potential_range_indexes": [
                {
                  "index": "idx_age",
                  "usable": true,
                  "key_parts": ["age"]
                }
              ]
            }
          }
        ]
      }
    ]
  }
}
```

</details>

### 3.3 è·Ÿè¸ªä¿¡æ¯è§£æå·¥å…·


**æ‰‹åŠ¨è§£æJSONçš„å›°éš¾**ï¼š
- **ç»“æ„å¤æ‚**ï¼šå¤šå±‚åµŒå¥—ï¼Œå­—æ®µç¹å¤š
- **å†…å®¹å†—é•¿**ï¼šå•ä¸ªè·Ÿè¸ªå¯èƒ½æœ‰æ•°åƒè¡Œ
- **ä¸“ä¸šæ€§å¼º**ï¼šéœ€è¦æ·±åº¦ç†è§£ä¼˜åŒ–å™¨åŸç†

**è§£æè¾…åŠ©SQLå‡½æ•°**ï¼š
```sql
-- æå–ç‰¹å®šè·¯å¾„çš„JSONå€¼
SELECT 
    JSON_EXTRACT(TRACE, '$.steps[0].join_optimization.steps[*].condition_processing') 
    AS condition_info
FROM information_schema.OPTIMIZER_TRACE;

-- æŸ¥æ‰¾æ‰€æœ‰å€™é€‰ç´¢å¼•
SELECT 
    JSON_EXTRACT(TRACE, 
        '$.steps[0].join_optimization.steps[*].rows_estimation[*].table_scan.cost'
    ) AS table_scan_cost
FROM information_schema.OPTIMIZER_TRACE;

-- æå–æœ€ç»ˆé€‰æ‹©çš„æ‰§è¡Œè®¡åˆ’
SELECT 
    JSON_EXTRACT(TRACE,
        '$.steps[0].join_optimization.steps[*].considered_execution_plans[0].access_type'
    ) AS chosen_access_type
FROM information_schema.OPTIMIZER_TRACE;
```

---

## 4. ğŸ”„ ä¼˜åŒ–é˜¶æ®µè¯¦ç»†åˆ†æ


### 4.1 ä¼˜åŒ–å™¨å†³ç­–æ ‘åˆ†æ


> ğŸŒ³ **å†³ç­–è¿‡ç¨‹**ï¼šä¼˜åŒ–å™¨åƒä¸€æ£µå†³ç­–æ ‘ä¸€æ ·ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦åšå‡ºé€‰æ‹©

**ä¼˜åŒ–å™¨å†³ç­–æµç¨‹å›¾**ï¼š
```
SQLè¾“å…¥ 
    â”‚
    â–¼
â”Œâ”€ è¯­æ³•è§£æ â”€â”
â”‚   è§£ææ ‘    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€ è¯­ä¹‰åˆ†æ â”€â”
â”‚ æƒé™æ£€æŸ¥ç­‰  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€ æŸ¥è¯¢é‡å†™ â”€â” â† join_preparationé˜¶æ®µ
â”‚ è§†å›¾å±•å¼€ç­‰  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€ é€»è¾‘ä¼˜åŒ– â”€â” â† join_optimizationé˜¶æ®µ
â”‚æ¡ä»¶ä¸‹æ¨ç­‰  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼  
â”Œâ”€ ç‰©ç†ä¼˜åŒ– â”€â” â† é€‰æ‹©è®¿é—®è·¯å¾„
â”‚ç´¢å¼•é€‰æ‹©ç­‰  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€ ä»£ç ç”Ÿæˆ â”€â” â† join_executioné˜¶æ®µ
â”‚ æ‰§è¡Œè®¡åˆ’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ¡ä»¶å¤„ç†é˜¶æ®µåˆ†æ


**condition_processingæ­¥éª¤è¯¦è§£**ï¼š
```json
{
  "condition_processing": {
    "condition": "WHERE",
    "original_condition": "(users.age > 25) AND (users.city = 'Beijing')",
    "steps": [
      {
        "transformation": "equality_propagation",
        "subselect_evaluation": [],
        "resulting_condition": "(users.age > 25) AND (users.city = 'Beijing')"
      },
      {
        "transformation": "constant_propagation", 
        "subselect_evaluation": [],
        "resulting_condition": "(users.age > 25) AND (users.city = 'Beijing')"
      },
      {
        "transformation": "trivial_condition_removal",
        "resulting_condition": "(users.age > 25) AND (users.city = 'Beijing')"
      }
    ]
  }
}
```

**æ¡ä»¶ä¼˜åŒ–è½¬æ¢ç±»å‹**ï¼š
- **equality_propagation**ï¼šç­‰å€¼æ¡ä»¶ä¼ æ’­
- **constant_propagation**ï¼šå¸¸é‡ä¼ æ’­ä¼˜åŒ–
- **trivial_condition_removal**ï¼šæ— ç”¨æ¡ä»¶ç§»é™¤
- **condition_fanout_filter**ï¼šæ¡ä»¶é€‰æ‹©æ€§åˆ†æ

### 4.3 è¡¨ä¾èµ–æ€§åˆ†æ


**table_dependenciesè§£æ**ï¼š
```json
{
  "table_dependencies": [
    {
      "table": "users u1",
      "row_may_be_null": false,
      "map_bit": 0,
      "depends_on_map_bits": []
    },
    {
      "table": "orders o1", 
      "row_may_be_null": true,
      "map_bit": 1,
      "depends_on_map_bits": [0]  // ä¾èµ–usersè¡¨
    }
  ]
}
```

> ğŸ’¡ **ä¾èµ–åˆ†æä½œç”¨**ï¼š
> - **è¿æ¥é¡ºåºç¡®å®š**ï¼šç¡®ä¿è¢«ä¾èµ–çš„è¡¨å…ˆè®¿é—®
> - **NULLå€¼å¤„ç†**ï¼šæ ‡è¯†å¤–è¿æ¥ä¸­å¯èƒ½ä¸ºNULLçš„è¡¨
> - **ä½å›¾ä¼˜åŒ–**ï¼šä½¿ç”¨ä½æ“ä½œå¿«é€Ÿåˆ¤æ–­ä¾èµ–å…³ç³»

---

## 5. ğŸ’° æˆæœ¬è®¡ç®—è¿‡ç¨‹æ·±åº¦å‰–æ


### 5.1 æˆæœ¬è®¡ç®—å…¬å¼è§£è¯»


> ğŸ“Š **æ ¸å¿ƒæ¦‚å¿µ**ï¼šMySQLä½¿ç”¨æˆæœ¬æ¨¡å‹æ¥æ¯”è¾ƒä¸åŒæ‰§è¡Œè®¡åˆ’çš„ä¼˜åŠ£

**æˆæœ¬è®¡ç®—çš„åŸºæœ¬å…¬å¼**ï¼š
```
æ€»æˆæœ¬ = I/Oæˆæœ¬ + CPUæˆæœ¬ + å†…å­˜æˆæœ¬

å…¶ä¸­ï¼š
I/Oæˆæœ¬ = é¡µé¢è¯»å–æ¬¡æ•° Ã— å•é¡µI/Oæˆæœ¬
CPUæˆæœ¬ = è®°å½•å¤„ç†æ•°é‡ Ã— å•è®°å½•CPUæˆæœ¬  
å†…å­˜æˆæœ¬ = å†…å­˜æ“ä½œæ¬¡æ•° Ã— å†…å­˜æ“ä½œæˆæœ¬
```

**è·Ÿè¸ªä¿¡æ¯ä¸­çš„æˆæœ¬è®¡ç®—å®ä¾‹**ï¼š
```json
{
  "rows_estimation": [
    {
      "table": "users",
      "table_scan": {
        "rows": 100000,                    // é¢„ä¼°æ‰«æè¡Œæ•°
        "cost": 20450.25                   // æ€»æˆæœ¬
      },
      "potential_range_indexes": [
        {
          "index": "idx_age_city",
          "usable": true,
          "key_parts": ["age", "city"],
          "index_only": false,
          "rows": 2500,                    // ç´¢å¼•é¢„ä¼°è¡Œæ•°
          "cost": 3001.5,                  // ç´¢å¼•ä½¿ç”¨æˆæœ¬
          "chosen": true                   // æ˜¯å¦è¢«é€‰ä¸­
        }
      ]
    }
  ]
}
```

### 5.2 ä¸åŒè®¿é—®æ–¹æ³•çš„æˆæœ¬å¯¹æ¯”


**è®¿é—®æ–¹æ³•æˆæœ¬å¯¹æ¯”åˆ†æ**ï¼š
```json
{
  "considered_execution_plans": [
    {
      "plan_prefix": [],
      "table": "users", 
      "best_access_path": {
        "considered_access_paths": [
          {
            "access_type": "scan",           // å…¨è¡¨æ‰«æ
            "rows": 100000,
            "cost": 20450.25,
            "chosen": false,
            "cause": "cost"                  // æœªé€‰æ‹©çš„åŸå› 
          },
          {
            "access_type": "range",          // èŒƒå›´æ‰«æ
            "range_details": {
              "used_index": "idx_age_city"
            },
            "rows": 2500, 
            "cost": 3001.5,
            "chosen": true                   // è¢«é€‰æ‹©
          }
        ]
      }
    }
  ]
}
```

**æˆæœ¬è®¡ç®—å½±å“å› ç´ åˆ†æ**ï¼š

| å› ç´ ç±»åˆ« | **å…·ä½“å› ç´ ** | **å½±å“æ–¹å¼** | **ä¼˜åŒ–å»ºè®®** |
|---------|-------------|-------------|-------------|
| **æ•°æ®é‡** | `è¡¨è¡Œæ•°ã€ç´¢å¼•å¤§å°` | `çº¿æ€§å½±å“æˆæœ¬` | `åˆç†åˆ†åŒºã€å½’æ¡£å†å²æ•°æ®` |
| **é€‰æ‹©æ€§** | `WHEREæ¡ä»¶è¿‡æ»¤æ¯”ä¾‹` | `å½±å“ä¼°ç®—è¡Œæ•°` | `åˆ›å»ºé«˜é€‰æ‹©æ€§ç´¢å¼•` |
| **æ•°æ®åˆ†å¸ƒ** | `ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§` | `å½±å“æˆæœ¬ä¼°ç®—` | `å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯` |
| **ç¡¬ä»¶é…ç½®** | `I/Oæ€§èƒ½ã€å†…å­˜å¤§å°` | `å½±å“æˆæœ¬å‚æ•°` | `è°ƒæ•´æˆæœ¬å¸¸æ•°` |

### 5.3 æˆæœ¬ä¼°ç®—åå·®åˆ†æ


> âš ï¸ **å¸¸è§é—®é¢˜**ï¼šæˆæœ¬ä¼°ç®—ä¸å®é™…æ‰§è¡Œæ—¶é—´ä¸ç¬¦çš„åŸå› åˆ†æ

**æˆæœ¬ä¼°ç®—åå·®çš„å¸¸è§åŸå› **ï¼š
```
ä¼°ç®—åå·®åŸå› åˆ†æï¼š
â”Œâ”€ ç»Ÿè®¡ä¿¡æ¯è¿‡æ—¶ â”€â”
â”‚ â”œâ”€ è¡¨ç»Ÿè®¡ä¿¡æ¯    â”‚ â† ANALYZE TABLEæ›´æ–°
â”‚ â”œâ”€ ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯  â”‚ â† ç´¢å¼•ä½¿ç”¨é¢‘ç‡å˜åŒ–
â”‚ â””â”€ ç›´æ–¹å›¾ä¿¡æ¯    â”‚ â† æ•°æ®åˆ†å¸ƒå˜åŒ–
â”œâ”€ æˆæœ¬æ¨¡å‹å‚æ•° â”€â”¤
â”‚ â”œâ”€ I/Oæˆæœ¬å¸¸æ•°  â”‚ â† ç¡¬ä»¶æ€§èƒ½å˜åŒ– 
â”‚ â”œâ”€ CPUæˆæœ¬å¸¸æ•°  â”‚ â† å¤„ç†å™¨æ€§èƒ½
â”‚ â””â”€ å†…å­˜æˆæœ¬å¸¸æ•°  â”‚ â† å†…å­˜å¸¦å®½
â””â”€ æŸ¥è¯¢å¤æ‚åº¦ â”€â”˜
  â”œâ”€ å­æŸ¥è¯¢æˆæœ¬    â”‚ â† åµŒå¥—æŸ¥è¯¢ä¼°ç®—å›°éš¾
  â”œâ”€ è¿æ¥æˆæœ¬      â”‚ â† å¤šè¡¨è¿æ¥å¤æ‚æ€§
  â””â”€ å‡½æ•°è®¡ç®—æˆæœ¬  â”‚ â† ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°
```

**ä¿®æ­£æˆæœ¬ä¼°ç®—çš„æ–¹æ³•**ï¼š
```sql
-- 1. æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE users;

-- 2. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯è´¨é‡
SELECT 
    table_name,
    table_rows,
    avg_row_length,
    update_time
FROM information_schema.tables
WHERE table_name = 'users';

-- 3. æ£€æŸ¥æˆæœ¬å¸¸æ•°è®¾ç½®
SELECT * FROM mysql.server_cost;
SELECT * FROM mysql.engine_cost;

-- 4. åˆ›å»ºç›´æ–¹å›¾(MySQL 8.0+)
ANALYZE TABLE users UPDATE HISTOGRAM ON age, city WITH 100 BUCKETS;
```

---

## 6. ğŸ“‹ å€™é€‰æ‰§è¡Œè®¡åˆ’å¯¹æ¯”åˆ†æ


### 6.1 å¤šç§æ‰§è¡Œæ–¹æ¡ˆçš„è¯„ä¼°


> ğŸ¯ **ä¼˜åŒ–å™¨ç­–ç•¥**ï¼šä¼˜åŒ–å™¨ä¼šè€ƒè™‘å¤šç§å¯èƒ½çš„æ‰§è¡Œæ–¹æ¡ˆï¼Œå¹¶é€‰æ‹©æˆæœ¬æœ€ä½çš„

**å€™é€‰æ–¹æ¡ˆç”Ÿæˆè¿‡ç¨‹**ï¼š
```
å€™é€‰æ‰§è¡Œè®¡åˆ’ç”Ÿæˆï¼š
è¾“å…¥SQL â†’ å¯ç”¨ç´¢å¼•æšä¸¾ â†’ è®¿é—®æ–¹æ³•ç»„åˆ â†’ è¿æ¥é¡ºåºæ’åˆ— â†’ æˆæœ¬è¯„ä¼°æ’åº
    â”‚           â”‚            â”‚            â”‚            â”‚
    â”‚           â”‚            â”‚            â”‚            â–¼
    â”‚           â”‚            â”‚            â”‚        é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
    â”‚           â”‚            â”‚            â”‚
    â”‚           â”‚            â”‚        â”Œâ”€ åµŒå¥—å¾ªç¯è¿æ¥
    â”‚           â”‚            â”‚        â”œâ”€ å“ˆå¸Œè¿æ¥  
    â”‚           â”‚            â”‚        â””â”€ æ’åºåˆå¹¶è¿æ¥
    â”‚           â”‚            â”‚
    â”‚           â”‚        â”Œâ”€ å…¨è¡¨æ‰«æ
    â”‚           â”‚        â”œâ”€ ç´¢å¼•èŒƒå›´æ‰«æ
    â”‚           â”‚        â”œâ”€ ç´¢å¼•å”¯ä¸€æ‰«æ
    â”‚           â”‚        â””â”€ ç´¢å¼•å…¨æ‰«æ
    â”‚           â”‚
    â”‚       â”Œâ”€ ä¸»é”®ç´¢å¼•
    â”‚       â”œâ”€ å”¯ä¸€ç´¢å¼•  
    â”‚       â”œâ”€ æ™®é€šç´¢å¼•
    â”‚       â””â”€ ç»„åˆç´¢å¼•
    â”‚
â”Œâ”€ å•è¡¨æŸ¥è¯¢ â”€â”
â”œâ”€ å¤šè¡¨è¿æ¥ â”€â”¤
â””â”€ å­æŸ¥è¯¢ â”€â”€â”€â”˜
```

### 6.2 æ‰§è¡Œè®¡åˆ’å¯¹æ¯”ä¿¡æ¯è§£è¯»


**considered_execution_plansè¯¦ç»†è§£æ**ï¼š
```json
{
  "considered_execution_plans": [
    {
      "plan_prefix": [],
      "table": "users",
      "best_access_path": {
        "considered_access_paths": [
          {
            "access_type": "scan",
            "records": 100000,
            "cost": 20450.25,
            "uses_join_buffering": false,
            "chosen": false,
            "cause": "cost too high"
          },
          {
            "access_type": "range", 
            "range_details": {
              "used_index": "idx_age_city",
              "ranges": ["(25) <= (age)"]
            },
            "records": 2500,
            "cost": 3001.5, 
            "uses_join_buffering": false,
            "chosen": true
          },
          {
            "access_type": "index",
            "index": "idx_city",
            "records": 5000,
            "cost": 5200.8,
            "uses_join_buffering": false, 
            "chosen": false,
            "cause": "cost higher than range"
          }
        ]
      },
      "rows_for_plan": 2500,
      "cost_for_plan": 3001.5,
      "chosen": true
    }
  ]
}
```

**è®¿é—®æ–¹æ³•å¯¹æ¯”è¦ç‚¹**ï¼š

| è®¿é—®ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **æˆæœ¬ç‰¹ç‚¹** | **é€‰æ‹©ä¾æ®** |
|---------|-------------|-------------|-------------|
| `scan` | `å¤§èŒƒå›´æŸ¥è¯¢æˆ–æ— ç´¢å¼•` | `æˆæœ¬ä¸è¡¨å¤§å°çº¿æ€§ç›¸å…³` | `å…¶ä»–æ–¹æ³•æˆæœ¬æ›´é«˜æ—¶` |
| `range` | `èŒƒå›´æŸ¥è¯¢æœ‰é€‚åˆç´¢å¼•` | `æˆæœ¬ä¸é¢„ä¼°è¿”å›è¡Œæ•°ç›¸å…³` | `é«˜é€‰æ‹©æ€§èŒƒå›´æ¡ä»¶` |
| `ref` | `ç­‰å€¼æŸ¥è¯¢æœ‰ç´¢å¼•` | `æˆæœ¬ç›¸å¯¹è¾ƒä½ä¸”ç¨³å®š` | `ç­‰å€¼æ¡ä»¶ä¸”ç´¢å¼•é€‰æ‹©æ€§å¥½` |
| `eq_ref` | `ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ç­‰å€¼` | `æˆæœ¬æœ€ä½ï¼Œæ¯æ¬¡è®¿é—®1è¡Œ` | `è¿æ¥æ¡ä»¶ä½¿ç”¨ä¸»é”®/å”¯ä¸€é”®` |

### 6.3 è¿æ¥é¡ºåºä¼˜åŒ–åˆ†æ


**å¤šè¡¨è¿æ¥çš„ä¼˜åŒ–å†³ç­–**ï¼š
```json
{
  "join_optimization": {
    "select_id": 1,
    "steps": [
      {
        "join_order": [
          {
            "table_order": ["users", "orders", "order_items"],
            "join_type": "inner_join",
            "cost_analysis": {
              "users_first": {
                "cost": 15000.5,
                "rows": 1000
              },
              "orders_first": { 
                "cost": 25000.8,
                "rows": 5000
              }
            },
            "chosen_order": "users_first",
            "reason": "lower_cost"
          }
        ]
      }
    ]
  }
}
```

**è¿æ¥é¡ºåºé€‰æ‹©åŸåˆ™**ï¼š
- **é©±åŠ¨è¡¨é€‰æ‹©**ï¼šé€‰æ‹©ç»“æœé›†è¾ƒå°çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨
- **ç´¢å¼•åˆ©ç”¨**ï¼šç¡®ä¿è¢«é©±åŠ¨è¡¨æœ‰åˆé€‚çš„ç´¢å¼•
- **è¿‡æ»¤æ¡ä»¶**ï¼šä¼˜å…ˆåº”ç”¨é€‰æ‹©æ€§é«˜çš„è¿‡æ»¤æ¡ä»¶
- **æˆæœ¬å¹³è¡¡**ï¼šç»¼åˆè€ƒè™‘I/Oæˆæœ¬å’ŒCPUæˆæœ¬

---

## 7. ğŸ“ˆ è·Ÿè¸ªæ•°æ®æŒ–æ˜ä¸å¯è§†åŒ–


### 7.1 è·Ÿè¸ªä¿¡æ¯å†å²å¯¹æ¯”åˆ†æ


> ğŸ“Š **åˆ†æä»·å€¼**ï¼šé€šè¿‡å¯¹æ¯”ä¸åŒæ—¶æœŸçš„è·Ÿè¸ªä¿¡æ¯ï¼Œå‘ç°æ€§èƒ½å˜åŒ–è¶‹åŠ¿

**å†å²å¯¹æ¯”åˆ†ææ–¹æ³•**ï¼š
```sql
-- åˆ›å»ºè·Ÿè¸ªä¿¡æ¯å†å²è¡¨
CREATE TABLE optimizer_trace_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    query_hash VARCHAR(64),           -- SQLçš„å“ˆå¸Œå€¼
    query_text TEXT,                  -- åŸå§‹SQL
    trace_info JSON,                  -- è·Ÿè¸ªä¿¡æ¯
    execution_time DECIMAL(10,3),     -- å®é™…æ‰§è¡Œæ—¶é—´
    rows_examined BIGINT,             -- æ‰«æè¡Œæ•°
    rows_sent BIGINT,                 -- è¿”å›è¡Œæ•°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_query_hash (query_hash),
    INDEX idx_created_at (created_at)
);

-- æ’å…¥è·Ÿè¸ªæ•°æ®çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE save_trace_history(
    IN p_query TEXT,
    IN p_trace JSON,
    IN p_exec_time DECIMAL(10,3),
    IN p_rows_examined BIGINT,
    IN p_rows_sent BIGINT
)
BEGIN
    INSERT INTO optimizer_trace_history 
    (query_hash, query_text, trace_info, execution_time, rows_examined, rows_sent)
    VALUES 
    (MD5(p_query), p_query, p_trace, p_exec_time, p_rows_examined, p_rows_sent);
END //
DELIMITER ;
```

### 7.2 è·Ÿè¸ªæ•°æ®å¯è§†åŒ–å±•ç¤ºæŠ€æœ¯


**å¯è§†åŒ–ç»´åº¦è®¾è®¡**ï¼š
```
è·Ÿè¸ªä¿¡æ¯å¯è§†åŒ–å±‚æ¬¡ï¼š
â”Œâ”€ æŸ¥è¯¢æ¦‚è§ˆå±‚ â”€â”
â”‚ â”œâ”€ æ‰§è¡Œæ—¶é—´è¶‹åŠ¿  â”‚ â† æ—¶é—´åºåˆ—å›¾è¡¨
â”‚ â”œâ”€ æˆæœ¬åˆ†å¸ƒåˆ†æ  â”‚ â† é¥¼å›¾/æŸ±çŠ¶å›¾  
â”‚ â””â”€ ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡  â”‚ â† çƒ­åŠ›å›¾
â”œâ”€ ä¼˜åŒ–è¿‡ç¨‹å±‚ â”€â”¤
â”‚ â”œâ”€ å†³ç­–æ ‘å¯è§†åŒ–  â”‚ â† æµç¨‹å›¾
â”‚ â”œâ”€ æˆæœ¬å¯¹æ¯”å›¾è¡¨  â”‚ â† å¯¹æ¯”æ¡å½¢å›¾
â”‚ â””â”€ å€™é€‰æ–¹æ¡ˆæ’åº  â”‚ â† æ’ååˆ—è¡¨
â””â”€ ç»†èŠ‚åˆ†æå±‚ â”€â”˜
  â”œâ”€ JSONç»“æ„å±•ç¤º  â”‚ â† æ ‘çŠ¶ç»“æ„å›¾
  â”œâ”€ æˆæœ¬è®¡ç®—å…¬å¼  â”‚ â† æ•°å­¦å…¬å¼æ¸²æŸ“
  â””â”€ æ‰§è¡Œè·¯å¾„è¿½è¸ª  â”‚ â† æ—¶åºå›¾
```

**å¯è§†åŒ–å®ç°ç¤ºä¾‹**ï¼š

<details>
<summary>ğŸ’» å±•å¼€æŸ¥çœ‹å¯è§†åŒ–å·¥å…·ä»£ç ç¤ºä¾‹</summary>

```python
# Pythonå¯è§†åŒ–å·¥å…·ç¤ºä¾‹
import json
import matplotlib.pyplot as plt
import pandas as pd
from datetime import datetime

class OptimizerTraceVisualizer:
    def __init__(self):
        self.traces = []
    
    def load_trace_data(self, mysql_connection):
        """ä»MySQLåŠ è½½è·Ÿè¸ªæ•°æ®"""
        query = """
        SELECT query_text, trace_info, execution_time, created_at
        FROM optimizer_trace_history 
        ORDER BY created_at DESC 
        LIMIT 100
        """
        return pd.read_sql(query, mysql_connection)
    
    def extract_cost_info(self, trace_json):
        """æå–æˆæœ¬ä¿¡æ¯"""
        try:
            trace = json.loads(trace_json)
            steps = trace['steps'][0]['join_optimization']['steps']
            
            costs = []
            for step in steps:
                if 'considered_execution_plans' in step:
                    plans = step['considered_execution_plans'][0]
                    if 'best_access_path' in plans:
                        paths = plans['best_access_path']['considered_access_paths']
                        for path in paths:
                            costs.append({
                                'access_type': path['access_type'],
                                'cost': path['cost'],
                                'rows': path['records'],
                                'chosen': path['chosen']
                            })
            return costs
        except:
            return []
    
    def plot_cost_comparison(self, traces_df):
        """ç»˜åˆ¶æˆæœ¬å¯¹æ¯”å›¾"""
        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(15, 6))
        
        # æˆæœ¬è¶‹åŠ¿å›¾
        ax1.plot(traces_df['created_at'], traces_df['execution_time'])
        ax1.set_title('Query Execution Time Trend')
        ax1.set_xlabel('Time')
        ax1.set_ylabel('Execution Time (ms)')
        
        # è®¿é—®æ–¹æ³•åˆ†å¸ƒ
        access_types = []
        for trace in traces_df['trace_info']:
            costs = self.extract_cost_info(trace)
            for cost in costs:
                if cost['chosen']:
                    access_types.append(cost['access_type'])
        
        access_counts = pd.Series(access_types).value_counts()
        ax2.pie(access_counts.values, labels=access_counts.index, autopct='%1.1f%%')
        ax2.set_title('Access Method Distribution')
        
        plt.tight_layout()
        plt.show()
```

</details>

### 7.3 è‡ªåŠ¨åŒ–æ€§èƒ½è¶‹åŠ¿åˆ†æ


**è¶‹åŠ¿åˆ†ææŒ‡æ ‡å®šä¹‰**ï¼š
```sql
-- æ€§èƒ½è¶‹åŠ¿åˆ†ææŸ¥è¯¢
WITH daily_performance AS (
    SELECT 
        DATE(created_at) as analysis_date,
        AVG(execution_time) as avg_exec_time,
        MAX(execution_time) as max_exec_time,
        AVG(rows_examined) as avg_rows_examined,
        COUNT(*) as query_count
    FROM optimizer_trace_history
    WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    GROUP BY DATE(created_at)
),
performance_trend AS (
    SELECT *,
        LAG(avg_exec_time) OVER (ORDER BY analysis_date) as prev_avg_exec_time,
        (avg_exec_time - LAG(avg_exec_time) OVER (ORDER BY analysis_date)) / 
         LAG(avg_exec_time) OVER (ORDER BY analysis_date) * 100 as exec_time_change_pct
    FROM daily_performance
)
SELECT 
    analysis_date,
    ROUND(avg_exec_time, 2) as avg_execution_time_ms,
    ROUND(exec_time_change_pct, 2) as performance_change_pct,
    CASE 
        WHEN exec_time_change_pct > 20 THEN 'âš ï¸ æ€§èƒ½æ˜¾è‘—ä¸‹é™'
        WHEN exec_time_change_pct > 10 THEN 'ğŸ” æ€§èƒ½è½»å¾®ä¸‹é™'  
        WHEN exec_time_change_pct < -10 THEN 'ğŸš€ æ€§èƒ½æ˜¾è‘—æå‡'
        ELSE 'âœ… æ€§èƒ½ç¨³å®š'
    END as performance_status
FROM performance_trend
ORDER BY analysis_date DESC;
```

---

## 8. ğŸ¤– è‡ªåŠ¨åŒ–è¯Šæ–­å·¥å…·å¼€å‘


### 8.1 è·Ÿè¸ªä¿¡æ¯è‡ªåŠ¨åŒ–åˆ†æå·¥å…·


> ğŸ”§ **å·¥å…·ç›®æ ‡**ï¼šè‡ªåŠ¨åˆ†æè·Ÿè¸ªä¿¡æ¯ï¼Œè¯†åˆ«æ€§èƒ½é—®é¢˜å’Œä¼˜åŒ–å»ºè®®

**è‡ªåŠ¨åŒ–åˆ†ææ¡†æ¶è®¾è®¡**ï¼š
```
è‡ªåŠ¨åŒ–åˆ†æå·¥å…·æ¶æ„ï¼š
â”Œâ”€ æ•°æ®é‡‡é›†å±‚ â”€â”
â”‚ â”œâ”€ è·Ÿè¸ªä¿¡æ¯è·å–  â”‚ â† optimizer_traceè¡¨
â”‚ â”œâ”€ æ€§èƒ½æŒ‡æ ‡æ”¶é›†  â”‚ â† performance_schema
â”‚ â””â”€ ç³»ç»ŸçŠ¶æ€ç›‘æ§  â”‚ â† SHOW STATUSå‘½ä»¤
â”œâ”€ æ•°æ®å¤„ç†å±‚ â”€â”¤
â”‚ â”œâ”€ JSONè§£æå¤„ç† â”‚ â† ç»“æ„åŒ–æå–
â”‚ â”œâ”€ æˆæœ¬è®¡ç®—åˆ†æ â”‚ â† ç®—æ³•å®ç°  
â”‚ â””â”€ æ¨¡å¼è¯†åˆ«å¼•æ“ â”‚ â† è§„åˆ™åŒ¹é…
â”œâ”€ æ™ºèƒ½åˆ†æå±‚ â”€â”¤
â”‚ â”œâ”€ é—®é¢˜è‡ªåŠ¨è¯†åˆ« â”‚ â† å¼‚å¸¸æ£€æµ‹
â”‚ â”œâ”€ ä¼˜åŒ–å»ºè®®ç”Ÿæˆ â”‚ â† çŸ¥è¯†åº“åŒ¹é…
â”‚ â””â”€ è¶‹åŠ¿é¢„æµ‹åˆ†æ â”‚ â† æœºå™¨å­¦ä¹ 
â””â”€ ç»“æœè¾“å‡ºå±‚ â”€â”˜
  â”œâ”€ æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆ â”‚ â† HTML/PDFæ ¼å¼
  â”œâ”€ å‘Šè­¦é€šçŸ¥å‘é€ â”‚ â† é‚®ä»¶/æ¶ˆæ¯æ¨é€
  â””â”€ å¯è§†åŒ–å±•ç¤º   â”‚ â† Webç•Œé¢
```

### 8.2 æ™ºèƒ½ä¼˜åŒ–å»ºè®®ç³»ç»Ÿ


**ä¼˜åŒ–å»ºè®®è§„åˆ™å¼•æ“**ï¼š
```sql
-- åˆ›å»ºä¼˜åŒ–å»ºè®®è§„åˆ™è¡¨
CREATE TABLE optimization_rules (
    rule_id INT AUTO_INCREMENT PRIMARY KEY,
    rule_name VARCHAR(100),
    rule_description TEXT,
    condition_pattern JSON,          -- åŒ¹é…æ¡ä»¶(JSONæ ¼å¼)
    suggestion_template TEXT,        -- å»ºè®®æ¨¡æ¿
    priority_level INT,              -- ä¼˜å…ˆçº§(1-5)
    rule_category ENUM('index','query','config','schema'),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥ç¤ºä¾‹è§„åˆ™
INSERT INTO optimization_rules 
(rule_name, rule_description, condition_pattern, suggestion_template, priority_level, rule_category)
VALUES 
('é«˜æˆæœ¬å…¨è¡¨æ‰«æ', 
 'æ£€æµ‹åˆ°é«˜æˆæœ¬çš„å…¨è¡¨æ‰«ææ“ä½œ',
 '{"access_type": "scan", "cost_threshold": 10000}',
 'å»ºè®®åœ¨å­—æ®µ {fields} ä¸Šåˆ›å»ºç´¢å¼•ä»¥é¿å…å…¨è¡¨æ‰«æï¼Œé¢„è®¡å¯é™ä½æˆæœ¬ {cost_reduction}%',
 1, 
 'index'),

('ç´¢å¼•é€‰æ‹©æ€§ä½', 
 'ä½¿ç”¨äº†é€‰æ‹©æ€§è¾ƒä½çš„ç´¢å¼•',
 '{"selectivity": {"<": 0.1}, "access_type": "range"}',
 'ç´¢å¼• {index_name} é€‰æ‹©æ€§è¾ƒä½({selectivity}%)ï¼Œå»ºè®®è€ƒè™‘ç»„åˆç´¢å¼•æˆ–è°ƒæ•´æŸ¥è¯¢æ¡ä»¶',
 2,
 'index');
```

### 8.3 ä¼˜åŒ–å™¨æ€§èƒ½ç“¶é¢ˆå®šä½æ–¹æ³•


**ç“¶é¢ˆå®šä½ç®—æ³•å®ç°**ï¼š

<details>
<summary>ğŸ’» ç“¶é¢ˆå®šä½åˆ†æç®—æ³•</summary>

```python
class PerformanceBottleneckAnalyzer:
    def __init__(self):
        self.bottleneck_patterns = {
            'table_scan_bottleneck': {
                'pattern': lambda trace: self._check_table_scan_cost(trace),
                'description': 'å…¨è¡¨æ‰«ææˆä¸ºæ€§èƒ½ç“¶é¢ˆ',
                'severity': 'HIGH'
            },
            'join_order_bottleneck': {
                'pattern': lambda trace: self._check_join_order(trace),
                'description': 'è¿æ¥é¡ºåºé€‰æ‹©ä¸å½“',
                'severity': 'MEDIUM'
            },
            'index_selectivity_bottleneck': {
                'pattern': lambda trace: self._check_index_selectivity(trace),
                'description': 'ç´¢å¼•é€‰æ‹©æ€§è¿‡ä½',
                'severity': 'MEDIUM'
            }
        }
    
    def _check_table_scan_cost(self, trace):
        """æ£€æŸ¥å…¨è¡¨æ‰«ææˆæœ¬"""
        try:
            plans = trace['steps'][0]['join_optimization']['steps']
            for plan in plans:
                if 'considered_execution_plans' in plan:
                    access_paths = plan['considered_execution_plans'][0]['best_access_path']['considered_access_paths']
                    for path in access_paths:
                        if path['access_type'] == 'scan' and path['cost'] > 10000:
                            return {
                                'detected': True,
                                'cost': path['cost'],
                                'rows': path['records'],
                                'recommendation': f'è€ƒè™‘åˆ›å»ºç´¢å¼•ï¼Œå½“å‰æ‰«æ{path["records"]}è¡Œï¼Œæˆæœ¬{path["cost"]}'
                            }
        except:
            pass
        return {'detected': False}
    
    def _check_join_order(self, trace):
        """æ£€æŸ¥è¿æ¥é¡ºåº"""
        try:
            # å®ç°è¿æ¥é¡ºåºåˆ†æé€»è¾‘
            # æ£€æŸ¥é©±åŠ¨è¡¨é€‰æ‹©æ˜¯å¦åˆç†
            return {'detected': False}
        except:
            return {'detected': False}
    
    def _check_index_selectivity(self, trace):
        """æ£€æŸ¥ç´¢å¼•é€‰æ‹©æ€§"""
        try:
            # å®ç°ç´¢å¼•é€‰æ‹©æ€§æ£€æŸ¥é€»è¾‘
            return {'detected': False}
        except:
            return {'detected': False}
    
    def analyze_bottlenecks(self, trace):
        """ç»¼åˆåˆ†ææ€§èƒ½ç“¶é¢ˆ"""
        bottlenecks = []
        
        for pattern_name, pattern_config in self.bottleneck_patterns.items():
            result = pattern_config['pattern'](trace)
            if result['detected']:
                bottlenecks.append({
                    'type': pattern_name,
                    'description': pattern_config['description'],
                    'severity': pattern_config['severity'],
                    'details': result,
                    'recommendations': self._generate_recommendations(pattern_name, result)
                })
        
        return bottlenecks
    
    def _generate_recommendations(self, bottleneck_type, details):
        """ç”Ÿæˆä¼˜åŒ–å»ºè®®"""
        recommendations = {
            'table_scan_bottleneck': [
                'åˆ›å»ºè¦†ç›–æŸ¥è¯¢æ¡ä»¶çš„ç´¢å¼•',
                'è€ƒè™‘åˆ†åŒºè¡¨ä»¥å‡å°‘æ‰«æèŒƒå›´',
                'ä¼˜åŒ–WHEREæ¡ä»¶çš„é€‰æ‹©æ€§'
            ],
            'join_order_bottleneck': [
                'è°ƒæ•´è¿æ¥é¡ºåºï¼Œå°è¡¨åšé©±åŠ¨è¡¨',
                'ç¡®ä¿è¢«é©±åŠ¨è¡¨æœ‰åˆé€‚çš„ç´¢å¼•',
                'è€ƒè™‘ä½¿ç”¨STRAIGHT_JOINå›ºå®šè¿æ¥é¡ºåº'
            ],
            'index_selectivity_bottleneck': [
                'åˆ›å»ºç»„åˆç´¢å¼•æé«˜é€‰æ‹©æ€§',
                'è°ƒæ•´æŸ¥è¯¢æ¡ä»¶æˆ–æ·»åŠ æ›´å¤šè¿‡æ»¤æ¡ä»¶',
                'è€ƒè™‘ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•'
            ]
        }
        return recommendations.get(bottleneck_type, ['éœ€è¦è¿›ä¸€æ­¥åˆ†æ'])
```

</details>

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è·Ÿè¸ªç›®çš„ï¼šé€è§†ä¼˜åŒ–å™¨é»‘ç›’ï¼Œç†è§£å†³ç­–è¿‡ç¨‹å’Œæˆæœ¬è®¡ç®—
ğŸ”¸ å¼€å¯æ–¹æ³•ï¼šSET optimizer_trace='enabled=on'ï¼Œç”¨å®Œå³å…³
ğŸ”¸ ä¿¡æ¯ç»“æ„ï¼šJSONæ ¼å¼ï¼ŒåŒ…å«å‡†å¤‡ã€ä¼˜åŒ–ã€æ‰§è¡Œä¸‰ä¸ªé˜¶æ®µ
ğŸ”¸ æˆæœ¬åˆ†æï¼šI/Oæˆæœ¬+CPUæˆæœ¬+å†…å­˜æˆæœ¬çš„ç»¼åˆè¯„ä¼°
ğŸ”¸ è®¡åˆ’å¯¹æ¯”ï¼šå¤šç§å€™é€‰æ–¹æ¡ˆçš„æˆæœ¬æ¯”è¾ƒå’Œé€‰æ‹©ä¾æ®
ğŸ”¸ è‡ªåŠ¨åŒ–å·¥å…·ï¼šé€šè¿‡è§„åˆ™å¼•æ“å®ç°æ™ºèƒ½åˆ†æå’Œå»ºè®®ç”Ÿæˆ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¼˜åŒ–å™¨è·Ÿè¸ªçš„çœŸæ­£ä»·å€¼**
```
ä»·å€¼ä½“ç°ï¼š
- é—®é¢˜è¯Šæ–­ï¼šå¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜æ ¹å› 
- ä¼˜åŒ–éªŒè¯ï¼šéªŒè¯ç´¢å¼•å’Œå‚æ•°è°ƒæ•´æ•ˆæœ  
- å­¦ä¹ å·¥å…·ï¼šæ·±å…¥ç†è§£MySQLä¼˜åŒ–å™¨åŸç†
- é¢„é˜²æ€§ç»´æŠ¤ï¼šåŠæ—¶å‘ç°æ½œåœ¨æ€§èƒ½é£é™©
```

**ğŸ”¹ è·Ÿè¸ªä¿¡æ¯çš„æ­£ç¡®è§£è¯»**
```
è§£è¯»è¦ç‚¹ï¼š
- å…³æ³¨å†³ç­–è¿‡ç¨‹è€Œéæœ€ç»ˆç»“æœ
- é‡è§†æˆæœ¬è®¡ç®—çš„é€»è¾‘è€Œéå…·ä½“æ•°å€¼
- åˆ†æå€™é€‰æ–¹æ¡ˆçš„å¯¹æ¯”è€Œéå•ä¸€é€‰æ‹©
- ç†è§£ä¼˜åŒ–é˜¶æ®µçš„é¡ºåºå’Œä¾èµ–å…³ç³»
```

**ğŸ”¹ æˆæœ¬æ¨¡å‹çš„å±€é™æ€§**
```
å±€é™æ€§è®¤çŸ¥ï¼š
- åŸºäºç»Ÿè®¡ä¿¡æ¯ï¼Œå¯èƒ½ä¸å®é™…æƒ…å†µåå·®
- éš¾ä»¥å‡†ç¡®ä¼°ç®—å¤æ‚æ“ä½œçš„æˆæœ¬
- ç¡¬ä»¶å·®å¼‚å½±å“æˆæœ¬å‚æ•°å‡†ç¡®æ€§
- ç¼“å­˜çŠ¶æ€ç­‰åŠ¨æ€å› ç´ éš¾ä»¥é‡åŒ–
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å»ºè®®**ï¼š
- **è°¨æ…å¼€å¯**ï¼šä»…åœ¨å¿…è¦æ—¶å¼€å¯è·Ÿè¸ªï¼Œé¿å…æ€§èƒ½å½±å“
- **åŠæ—¶å…³é—­**ï¼šè·å–ä¿¡æ¯åç«‹å³å…³é—­è·Ÿè¸ªåŠŸèƒ½
- **ç¦»çº¿åˆ†æ**ï¼šå°†è·Ÿè¸ªæ•°æ®å¯¼å‡ºåè¿›è¡Œè¯¦ç»†åˆ†æ
- **å®šæœŸæ¸…ç†**ï¼šæ¸…ç†å†å²è·Ÿè¸ªæ•°æ®ï¼Œé¿å…å ç”¨è¿‡å¤šå­˜å‚¨

**è·Ÿè¸ªåˆ†ææŠ€å·§**ï¼š
- **èšç„¦é—®é¢˜**ï¼šé’ˆå¯¹å…·ä½“æ€§èƒ½é—®é¢˜è¿›è¡Œè·Ÿè¸ª
- **å¯¹æ¯”åˆ†æ**ï¼šé€šè¿‡å‰åå¯¹æ¯”éªŒè¯ä¼˜åŒ–æ•ˆæœ
- **æ¨¡å¼è¯†åˆ«**ï¼šæ€»ç»“å¸¸è§é—®é¢˜çš„è·Ÿè¸ªç‰¹å¾
- **å·¥å…·è¾…åŠ©**ï¼šå¼€å‘è‡ªåŠ¨åŒ–å·¥å…·æé«˜åˆ†ææ•ˆç‡

**ä¼˜åŒ–å»ºè®®ç”ŸæˆåŸåˆ™**ï¼š
- **åŸºäºæ•°æ®**ï¼šæ‰€æœ‰å»ºè®®éƒ½è¦æœ‰è·Ÿè¸ªæ•°æ®æ”¯æ’‘
- **å¯æ“ä½œæ€§**ï¼šæä¾›å…·ä½“çš„ä¼˜åŒ–æ­¥éª¤å’Œé¢„æœŸæ•ˆæœ
- **é£é™©è¯„ä¼°**ï¼šè€ƒè™‘ä¼˜åŒ–å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨
- **æŒç»­éªŒè¯**ï¼šä¼˜åŒ–åé€šè¿‡è·Ÿè¸ªéªŒè¯å®é™…æ•ˆæœ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¼˜åŒ–å™¨è·Ÿè¸ªæ˜¯æ€§èƒ½è°ƒä¼˜çš„Xå°„çº¿ï¼Œèƒ½é€è§†å†…éƒ¨å†³ç­–è¿‡ç¨‹
- JSONç»“æ„å¤æ‚ä½†æœ‰è§„å¾‹ï¼ŒæŒæ¡å…³é”®å­—æ®µå«ä¹‰æ˜¯å…³é”®
- æˆæœ¬è®¡ç®—æ˜¯ä¼˜åŒ–å™¨çš„æ ¸å¿ƒï¼Œç†è§£æˆæœ¬æ¨¡å‹æœ‰åŠ©äºä¼˜åŒ–
- è‡ªåŠ¨åŒ–å·¥å…·èƒ½æé«˜åˆ†ææ•ˆç‡ï¼Œä½†äººå·¥è§£è¯»ä»ç„¶é‡è¦