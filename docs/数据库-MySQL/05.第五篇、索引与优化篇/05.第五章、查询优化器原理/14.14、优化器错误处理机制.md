---
title: 14ã€ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æ¦‚è¿°](#1-ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æ¦‚è¿°)
2. [ä¼˜åŒ–å™¨å¼‚å¸¸å¤„ç†](#2-ä¼˜åŒ–å™¨å¼‚å¸¸å¤„ç†)
3. [é™çº§æ‰§è¡Œç­–ç•¥](#3-é™çº§æ‰§è¡Œç­–ç•¥)
4. [é”™è¯¯æ¢å¤æœºåˆ¶](#4-é”™è¯¯æ¢å¤æœºåˆ¶)
5. [ä¼˜åŒ–å™¨å´©æºƒå¤„ç†](#5-ä¼˜åŒ–å™¨å´©æºƒå¤„ç†)
6. [å¼‚å¸¸æ—¥å¿—è®°å½•](#6-å¼‚å¸¸æ—¥å¿—è®°å½•)
7. [æ•…éšœè½¬ç§»æœºåˆ¶](#7-æ•…éšœè½¬ç§»æœºåˆ¶)
8. [ä¼˜åŒ–å™¨å®¹é”™è®¾è®¡](#8-ä¼˜åŒ–å™¨å®¹é”™è®¾è®¡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸­ç¡®ä¿æŸ¥è¯¢ä¼˜åŒ–è¿‡ç¨‹ç¨³å®šå¯é çš„å®‰å…¨æœºåˆ¶ã€‚å½“ä¼˜åŒ–å™¨åœ¨å¤„ç†å¤æ‚æŸ¥è¯¢æ—¶é‡åˆ°å¼‚å¸¸æƒ…å†µï¼Œéœ€è¦æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶æ¥ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚

```
ç®€å•ç†è§£ï¼š
ä¼˜åŒ–å™¨å°±åƒä¸€ä¸ªæ™ºèƒ½è·¯çº¿è§„åˆ’ç³»ç»Ÿï¼š
- æ­£å¸¸æƒ…å†µï¼šæ‰¾åˆ°æœ€ä¼˜è·¯çº¿æ‰§è¡ŒæŸ¥è¯¢
- å¼‚å¸¸æƒ…å†µï¼šé‡åˆ°é“è·¯å°é—­ã€ç³»ç»Ÿæ•…éšœç­‰é—®é¢˜
- é”™è¯¯å¤„ç†ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡é€‰è·¯çº¿ï¼Œç¡®ä¿èƒ½åˆ°è¾¾ç›®çš„åœ°

æ ¸å¿ƒç›®æ ‡ï¼šå³ä½¿é‡åˆ°é—®é¢˜ï¼ŒæŸ¥è¯¢ä¹Ÿè¦èƒ½æ­£ç¡®æ‰§è¡Œ
```

### 1.2 é”™è¯¯å¤„ç†çš„é‡è¦æ€§


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†**
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šé˜²æ­¢ä¼˜åŒ–å™¨é”™è¯¯å¯¼è‡´æ•´ä¸ªæ•°æ®åº“å´©æºƒ
- **æŸ¥è¯¢å¯æ‰§è¡Œæ€§**ï¼šç¡®ä¿å³ä½¿ä¼˜åŒ–å¤±è´¥ï¼ŒæŸ¥è¯¢ä»èƒ½å¾—åˆ°æ­£ç¡®ç»“æœ
- **æ€§èƒ½ä¿è¯**ï¼šåœ¨å¼‚å¸¸æƒ…å†µä¸‹æä¾›å¯æ¥å—çš„æ€§èƒ½è¡¨ç°
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…å› ä¼˜åŒ–å™¨é—®é¢˜å½±å“ä¸šåŠ¡æ­£å¸¸è¿è¡Œ

### 1.3 å¸¸è§çš„ä¼˜åŒ–å™¨é”™è¯¯åœºæ™¯


**âŒ å…¸å‹é”™è¯¯åœºæ™¯**
```sql
-- åœºæ™¯1ï¼šå¤æ‚æŸ¥è¯¢å¯¼è‡´ä¼˜åŒ–å™¨è¶…æ—¶
SELECT * FROM 
  (SELECT t1.*, t2.* FROM table1 t1, table2 t2, table3 t3, table4 t4
   WHERE t1.id = t2.id AND t2.id = t3.id AND t3.id = t4.id
   AND t1.status IN (SELECT status FROM table5 WHERE condition...)
   AND EXISTS (SELECT 1 FROM table6 WHERE...)) sub
WHERE sub.amount > (SELECT AVG(amount) FROM table7);

-- åœºæ™¯2ï¼šç»Ÿè®¡ä¿¡æ¯ç¼ºå¤±å¯¼è‡´ä¼°ç®—é”™è¯¯
SELECT * FROM large_table WHERE new_column = 'value';
-- å¦‚æœ new_column æ²¡æœ‰ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’

-- åœºæ™¯3ï¼šå†…å­˜ä¸è¶³å¯¼è‡´ä¼˜åŒ–å™¨å¼‚å¸¸
-- åœ¨å†…å­˜å—é™ç¯å¢ƒä¸‹å¤„ç†å¤§å‹JOINæŸ¥è¯¢

-- åœºæ™¯4ï¼šå¹¶å‘å†²çªå¯¼è‡´çš„å…ƒæ•°æ®è®¿é—®å¼‚å¸¸
-- å¤šä¸ªä¼šè¯åŒæ—¶è®¿é—®å’Œä¿®æ”¹è¡¨ç»“æ„æ—¶
```

---

## 2. ğŸš¨ ä¼˜åŒ–å™¨å¼‚å¸¸å¤„ç†


### 2.1 å¼‚å¸¸ç±»å‹åˆ†ç±»


**ğŸ“‹ ä¼˜åŒ–å™¨å¼‚å¸¸åˆ†ç±»**
```
å†…å­˜å¼‚å¸¸ï¼š
- ä¼˜åŒ–å™¨å†…å­˜ä¸è¶³
- æ‰§è¡Œè®¡åˆ’ç¼“å­˜æ»¡è½½
- ä¸´æ—¶å¯¹è±¡åˆ›å»ºå¤±è´¥

æ—¶é—´å¼‚å¸¸ï¼š
- ä¼˜åŒ–è¶…æ—¶
- æˆæœ¬è®¡ç®—è€—æ—¶è¿‡é•¿  
- ç»Ÿè®¡ä¿¡æ¯æ”¶é›†è¶…æ—¶

æ•°æ®å¼‚å¸¸ï¼š
- ç»Ÿè®¡ä¿¡æ¯æŸå
- å…ƒæ•°æ®ä¸ä¸€è‡´
- çº¦æŸæ£€æŸ¥å¤±è´¥

ç³»ç»Ÿå¼‚å¸¸ï¼š
- æ–‡ä»¶ç³»ç»Ÿé”™è¯¯
- ç½‘ç»œè¿æ¥ä¸­æ–­
- ç¡¬ä»¶æ•…éšœ
```

### 2.2 å¼‚å¸¸æ£€æµ‹æœºåˆ¶


**ğŸ” å¼‚å¸¸æ£€æµ‹å®ç°**
```sql
-- MySQLä¸­ä¼˜åŒ–å™¨ç›¸å…³çš„é”™è¯¯æ£€æµ‹
-- æŸ¥çœ‹ä¼˜åŒ–å™¨é”™è¯¯ç»Ÿè®¡
SELECT 
    EVENT_NAME,
    COUNT_STAR as error_count,
    SUM_ERRORS as total_errors,
    FIRST_SEEN,
    LAST_SEEN
FROM performance_schema.events_errors_summary_global_by_error
WHERE EVENT_NAME LIKE '%optimizer%' 
   OR EVENT_NAME LIKE '%parse%'
   OR EVENT_NAME LIKE '%plan%'
ORDER BY COUNT_STAR DESC;

-- ç›‘æ§ä¼˜åŒ–å™¨è¶…æ—¶æƒ…å†µ
SELECT 
    sql_text,
    timer_wait/1000000000 as seconds,
    errors,
    warnings
FROM performance_schema.events_statements_history_long
WHERE timer_wait > 10*1000000000  -- è¶…è¿‡10ç§’
  AND sql_text IS NOT NULL
ORDER BY timer_wait DESC LIMIT 10;
```

### 2.3 å¼‚å¸¸å¤„ç†ç­–ç•¥


**âš¡ åˆ†å±‚å¼‚å¸¸å¤„ç†**
```
ç¬¬1å±‚ï¼šé¢„é˜²æ€§æ£€æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŸ¥è¯¢å¤æ‚åº¦è¯„ä¼°               â”‚
â”‚ - JOINè¡¨æ•°é‡æ£€æŸ¥             â”‚
â”‚ - å­æŸ¥è¯¢æ·±åº¦é™åˆ¶             â”‚
â”‚ - WHEREæ¡ä»¶å¤æ‚åº¦è¯„ä¼°        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬2å±‚ï¼šè¿è¡Œæ—¶ç›‘æ§  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜åŒ–æ—¶é—´ç›‘æ§                â”‚
â”‚ - è®¾ç½®ä¼˜åŒ–è¶…æ—¶æ—¶é—´           â”‚
â”‚ - ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ           â”‚
â”‚ - æ£€æµ‹èµ„æºç«äº‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬3å±‚ï¼šå¼‚å¸¸æ¢å¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é™çº§æ‰§è¡Œç­–ç•¥                â”‚
â”‚ - ä½¿ç”¨ç®€åŒ–çš„æ‰§è¡Œè®¡åˆ’         â”‚
â”‚ - ç¦ç”¨å¤æ‚ä¼˜åŒ–è§„åˆ™           â”‚
â”‚ - å›é€€åˆ°åŸºç¡€æ‰§è¡Œè·¯å¾„         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 å¼‚å¸¸å¤„ç†é…ç½®


**âš™ï¸ å…³é”®é…ç½®å‚æ•°**
```sql
-- MySQLä¼˜åŒ–å™¨å¼‚å¸¸å¤„ç†ç›¸å…³å‚æ•°
-- è®¾ç½®ä¼˜åŒ–å™¨è¶…æ—¶æ—¶é—´
SET SESSION optimizer_search_depth = 32;  -- é™åˆ¶æœç´¢æ·±åº¦

-- è®¾ç½®ä¼˜åŒ–å™¨å¼€å…³ï¼Œæ§åˆ¶å¤æ‚ä¼˜åŒ–
SET SESSION optimizer_switch = 
'index_merge=on,
 index_merge_union=on,
 index_merge_sort_union=on,
 index_merge_intersection=on,
 engine_condition_pushdown=on,
 index_condition_pushdown=on,
 mrr=on,
 mrr_cost_based=on,
 block_nested_loop=off,  -- å…³é—­å¤æ‚çš„å—åµŒå¥—å¾ªç¯
 batched_key_access=off'; -- å…³é—­æ‰¹é‡é”®è®¿é—®

-- é™åˆ¶JOINç¼“å†²åŒºå¤§å°ï¼Œé˜²æ­¢å†…å­˜å¼‚å¸¸
SET SESSION join_buffer_size = 1048576;  -- 1MB

-- è®¾ç½®ä¸´æ—¶è¡¨å¤§å°é™åˆ¶
SET SESSION tmp_table_size = 67108864;   -- 64MB
SET SESSION max_heap_table_size = 67108864; -- 64MB
```

---

## 3. ğŸ“‰ é™çº§æ‰§è¡Œç­–ç•¥


### 3.1 é™çº§ç­–ç•¥æ¦‚è¿°


**ğŸ”„ é™çº§æ‰§è¡ŒåŸç†**
å½“ä¼˜åŒ–å™¨é‡åˆ°å¼‚å¸¸æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯ç”¨é™çº§ç­–ç•¥ï¼Œä½¿ç”¨æ›´ç®€å•ä½†æ›´å¯é çš„æ‰§è¡Œè®¡åˆ’æ¥ç¡®ä¿æŸ¥è¯¢èƒ½å¤Ÿæ­£å¸¸å®Œæˆã€‚

```
é™çº§æ‰§è¡Œæµç¨‹ï¼š

æ­£å¸¸ä¼˜åŒ–å¤±è´¥ â†’ å¯ç”¨é™çº§ç­–ç•¥ â†’ ç”Ÿæˆç®€åŒ–æ‰§è¡Œè®¡åˆ’ â†’ æ‰§è¡ŒæŸ¥è¯¢

é™çº§çº§åˆ«ï¼š
Level 1: å…³é—­é«˜çº§ä¼˜åŒ–ç‰¹æ€§
Level 2: ä½¿ç”¨åŸºç¡€æ‰§è¡Œè®¡åˆ’  
Level 3: å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šæ‰§è¡Œè·¯å¾„
Level 4: æ‹†åˆ†å¤æ‚æŸ¥è¯¢
```

### 3.2 è‡ªåŠ¨é™çº§è§¦å‘æ¡ä»¶


**âš ï¸ é™çº§è§¦å‘åœºæ™¯**
```sql
-- è§¦å‘æ¡ä»¶1ï¼šä¼˜åŒ–æ—¶é—´è¶…é™
-- å½“å•ä¸ªæŸ¥è¯¢ä¼˜åŒ–æ—¶é—´è¶…è¿‡è®¾å®šé˜ˆå€¼æ—¶è‡ªåŠ¨é™çº§

-- è§¦å‘æ¡ä»¶2ï¼šå†…å­˜ä½¿ç”¨è¶…é™  
-- å½“ä¼˜åŒ–å™¨å†…å­˜ä½¿ç”¨è¶…è¿‡é™åˆ¶æ—¶é™çº§

-- è§¦å‘æ¡ä»¶3ï¼šå¤æ‚åº¦è¿‡é«˜
-- æ£€æµ‹æŸ¥è¯¢å¤æ‚åº¦çš„ç¤ºä¾‹
SELECT 
    COUNT(DISTINCT table_name) as table_count,
    COUNT(*) as condition_count,
    LENGTH(sql_text) as query_length
FROM performance_schema.events_statements_current
WHERE sql_text LIKE '%JOIN%'
  AND sql_text LIKE '%WHERE%'
HAVING table_count > 5 OR condition_count > 20 OR query_length > 2000;

-- è§¦å‘æ¡ä»¶4ï¼šç»Ÿè®¡ä¿¡æ¯å¼‚å¸¸
-- å½“å‘ç°ç»Ÿè®¡ä¿¡æ¯ç¼ºå¤±æˆ–ä¸å‡†ç¡®æ—¶
SHOW TABLE STATUS LIKE 'table_name' \G
-- æ£€æŸ¥ Update_time, Rows, Data_length ç­‰ä¿¡æ¯
```

### 3.3 é™çº§ç­–ç•¥å®ç°


**ğŸ› ï¸ å…·ä½“é™çº§æªæ–½**
```sql
-- ç­–ç•¥1ï¼šç¦ç”¨å¤æ‚JOINç®—æ³•
SET SESSION optimizer_switch = 'block_nested_loop=off,batched_key_access=off';

-- ç­–ç•¥2ï¼šå¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•
SELECT /*+ USE_INDEX(t1, idx_primary) */ * 
FROM table1 t1 
WHERE t1.id > 1000;

-- ç­–ç•¥3ï¼šç®€åŒ–å­æŸ¥è¯¢
-- åŸæŸ¥è¯¢ï¼ˆå¤æ‚ï¼‰
SELECT * FROM table1 
WHERE id IN (
    SELECT t2.id FROM table2 t2 
    WHERE EXISTS (
        SELECT 1 FROM table3 t3 WHERE t3.ref_id = t2.id
    )
);

-- é™çº§åï¼ˆç®€åŒ–ï¼‰
SELECT DISTINCT t1.* 
FROM table1 t1, table2 t2, table3 t3
WHERE t1.id = t2.id AND t2.id = t3.ref_id;

-- ç­–ç•¥4ï¼šåˆ†æ®µæ‰§è¡Œ
-- å°†å¤æ‚æŸ¥è¯¢åˆ†è§£ä¸ºå¤šä¸ªç®€å•æŸ¥è¯¢
-- Step 1: è·å–ä¸­é—´ç»“æœ
CREATE TEMPORARY TABLE temp_ids AS
SELECT id FROM table2 WHERE condition = 'value';

-- Step 2: ä½¿ç”¨ä¸­é—´ç»“æœ
SELECT * FROM table1 
WHERE id IN (SELECT id FROM temp_ids);

-- Step 3: æ¸…ç†ä¸´æ—¶è¡¨
DROP TEMPORARY TABLE temp_ids;
```

### 3.4 é™çº§æ•ˆæœç›‘æ§


**ğŸ“Š é™çº§æ‰§è¡Œç›‘æ§**
```sql
-- ç›‘æ§é™çº§æ‰§è¡Œæƒ…å†µ
SELECT 
    sql_text,
    rows_examined,
    rows_sent,
    timer_wait/1000000000 as execution_time,
    no_index_used,
    no_good_index_used,
    CASE 
        WHEN sql_text LIKE '%USE_INDEX%' THEN 'HINT_USED'
        WHEN no_good_index_used = 1 THEN 'DEGRADED'
        ELSE 'NORMAL'
    END as execution_mode
FROM performance_schema.events_statements_history_long
WHERE timer_end > UNIX_TIMESTAMP() - 3600  -- æœ€è¿‘1å°æ—¶
  AND (no_index_used = 1 OR no_good_index_used = 1 OR sql_text LIKE '%USE_INDEX%')
ORDER BY timer_wait DESC;
```

---

## 4. ğŸ”§ é”™è¯¯æ¢å¤æœºåˆ¶


### 4.1 æ¢å¤ç­–ç•¥åˆ†ç±»


**ğŸ¯ å¤šå±‚æ¢å¤æœºåˆ¶**
```
å³æ—¶æ¢å¤ï¼š
- é‡è¯•ä¼˜åŒ–è¿‡ç¨‹
- æ¸…ç†ç¼“å­˜é‡æ–°å¼€å§‹
- ä½¿ç”¨å¤‡ç”¨æ‰§è¡Œè®¡åˆ’

å»¶è¿Ÿæ¢å¤ï¼š
- åå°é‡å»ºç»Ÿè®¡ä¿¡æ¯
- å¼‚æ­¥ä¿®å¤æŸåçš„å…ƒæ•°æ®
- å®šæœŸæ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€

ä¸»åŠ¨æ¢å¤ï¼š
- é¢„é˜²æ€§ç»´æŠ¤
- å®šæœŸä¼˜åŒ–å™¨æ ¡å‡†
- ç³»ç»Ÿèµ„æºç›‘æ§
```

### 4.2 è‡ªåŠ¨æ¢å¤å®ç°


**âš¡ æ¢å¤æœºåˆ¶å®ç°**
```sql
-- è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ¢å¤
-- æ£€æµ‹è¿‡æœŸæˆ–ç¼ºå¤±çš„ç»Ÿè®¡ä¿¡æ¯
SELECT 
    table_schema,
    table_name,
    update_time,
    DATEDIFF(NOW(), update_time) as days_old
FROM information_schema.tables
WHERE table_type = 'BASE TABLE'
  AND (update_time IS NULL OR DATEDIFF(NOW(), update_time) > 7)
ORDER BY days_old DESC;

-- è‡ªåŠ¨é‡å»ºç»Ÿè®¡ä¿¡æ¯çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE auto_rebuild_statistics()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE tbl_name VARCHAR(255);
    DECLARE tbl_schema VARCHAR(255);
    
    -- æ¸¸æ ‡å®šä¹‰
    DECLARE table_cursor CURSOR FOR
        SELECT table_schema, table_name 
        FROM information_schema.tables
        WHERE table_type = 'BASE TABLE'
          AND DATEDIFF(NOW(), update_time) > 7;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN table_cursor;
    
    rebuild_loop: LOOP
        FETCH table_cursor INTO tbl_schema, tbl_name;
        IF done THEN
            LEAVE rebuild_loop;
        END IF;
        
        -- é‡å»ºç»Ÿè®¡ä¿¡æ¯
        SET @sql = CONCAT('ANALYZE TABLE ', tbl_schema, '.', tbl_name);
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
    END LOOP;
    
    CLOSE table_cursor;
END //
DELIMITER ;
```

### 4.3 æ‰‹åŠ¨æ¢å¤å·¥å…·


**ğŸ› ï¸ æ¢å¤å·¥å…·å’Œå‘½ä»¤**
```sql
-- æ¸…ç†ä¼˜åŒ–å™¨ç¼“å­˜
RESET QUERY CACHE;
FLUSH TABLES;

-- é‡æ–°æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE table_name;

-- æ£€æŸ¥è¡¨å®Œæ•´æ€§
CHECK TABLE table_name;

-- ä¿®å¤è¡¨ç»“æ„
REPAIR TABLE table_name;

-- é‡å»ºç´¢å¼•
ALTER TABLE table_name DROP INDEX idx_name;
ALTER TABLE table_name ADD INDEX idx_name (column_name);

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE table_name;
```

### 4.4 æ¢å¤æ•ˆæœéªŒè¯


**âœ… éªŒè¯æ¢å¤æ•ˆæœ**
```sql
-- éªŒè¯ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦æ›´æ–°
SELECT 
    table_name,
    rows as estimated_rows,
    avg_row_length,
    data_length,
    index_length,
    update_time
FROM information_schema.tables 
WHERE table_schema = 'your_database'
  AND table_name = 'target_table';

-- éªŒè¯æ‰§è¡Œè®¡åˆ’æ˜¯å¦æ”¹å–„
EXPLAIN FORMAT=JSON
SELECT * FROM target_table WHERE condition = 'value';

-- å¯¹æ¯”æ¢å¤å‰åçš„æ€§èƒ½
SELECT 
    ROUND(AVG(timer_wait)/1000000000, 3) as avg_seconds,
    COUNT(*) as query_count,
    DATE(FROM_UNIXTIME(timer_start/1000000000000)) as query_date
FROM performance_schema.events_statements_history_long
WHERE sql_text LIKE '%target_table%'
GROUP BY DATE(FROM_UNIXTIME(timer_start/1000000000000))
ORDER BY query_date DESC;
```

---

## 5. ğŸ’¥ ä¼˜åŒ–å™¨å´©æºƒå¤„ç†


### 5.1 å´©æºƒåœºæ™¯è¯†åˆ«


**ğŸš¨ å¸¸è§å´©æºƒåœºæ™¯**
```
å†…å­˜æº¢å‡ºå´©æºƒï¼š
- ä¼˜åŒ–å™¨åˆ†é…å†…å­˜è¿‡å¤š
- å¤æ‚æŸ¥è¯¢å¯¼è‡´å†…å­˜è€—å°½
- ç»Ÿè®¡ä¿¡æ¯æŸåå¯¼è‡´å¼‚å¸¸è®¡ç®—

ç®—æ³•å´©æºƒï¼š
- JOINç®—æ³•é€‰æ‹©é”™è¯¯
- æˆæœ¬è®¡ç®—å‡ºç°é™¤é›¶é”™è¯¯
- é€’å½’æ·±åº¦è¶…é™

ç³»ç»Ÿèµ„æºå´©æºƒï¼š
- ç£ç›˜ç©ºé—´ä¸è¶³
- ä¸´æ—¶æ–‡ä»¶åˆ›å»ºå¤±è´¥
- é”ç­‰å¾…è¶…æ—¶
```

### 5.2 å´©æºƒé¢„é˜²æœºåˆ¶


**ğŸ›¡ï¸ é¢„é˜²æªæ–½**
```sql
-- è®¾ç½®èµ„æºé™åˆ¶é˜²æ­¢å´©æºƒ
SET SESSION max_execution_time = 30000;  -- 30ç§’æŸ¥è¯¢è¶…æ—¶
SET SESSION max_join_size = 1000000;     -- é™åˆ¶JOINç»“æœé›†å¤§å°
SET SESSION sql_select_limit = 100000;   -- é™åˆ¶SELECTè¿”å›è¡Œæ•°

-- ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
SELECT 
    $$max_connections,
    $$thread_cache_size,
    $$table_open_cache,
    $$innodb_buffer_pool_size;

-- æ£€æŸ¥ç£ç›˜ç©ºé—´
SELECT 
    TABLE_SCHEMA,
    SUM(DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024 AS total_mb
FROM information_schema.TABLES 
GROUP BY TABLE_SCHEMA
ORDER BY total_mb DESC;
```

### 5.3 å´©æºƒæ¢å¤æµç¨‹


**ğŸ”„ å´©æºƒåæ¢å¤æ­¥éª¤**
```sql
-- Step 1: æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
-- systemctl status mysql

-- Step 2: æ£€æŸ¥é”™è¯¯æ—¥å¿—
-- tail -f /var/log/mysql/error.log

-- Step 3: å¯åŠ¨MySQLæœåŠ¡å¹¶æ£€æŸ¥
-- systemctl start mysql

-- Step 4: éªŒè¯æ•°æ®å®Œæ•´æ€§
CHECK TABLE table_name;

-- Step 5: é‡å»ºæŸåçš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE table_name;

-- Step 6: æ¸…ç†å¼‚å¸¸ä¼šè¯
SHOW PROCESSLIST;
-- KILL query_id; -- å¦‚æœæœ‰å¼‚å¸¸æŸ¥è¯¢

-- Step 7: éªŒè¯ç³»ç»ŸåŠŸèƒ½
SELECT 1; -- ç®€å•è¿æ¥æµ‹è¯•
SELECT COUNT(*) FROM important_table; -- æ•°æ®è®¿é—®æµ‹è¯•
```

### 5.4 å´©æºƒæ—¥å¿—åˆ†æ


**ğŸ“ æ—¥å¿—åˆ†ææ–¹æ³•**
```bash
# æŸ¥çœ‹MySQLé”™è¯¯æ—¥å¿—ä¸­çš„ä¼˜åŒ–å™¨ç›¸å…³é”™è¯¯
grep -i "optimizer\|crash\|assertion\|segfault" /var/log/mysql/error.log

# æŸ¥çœ‹æœ€è¿‘çš„æ…¢æŸ¥è¯¢æ—¥å¿—
tail -100 /var/log/mysql/slow.log | grep -A5 -B5 "Query_time"

# åˆ†æç³»ç»Ÿæ—¥å¿—ä¸­çš„ç›¸å…³ä¿¡æ¯
journalctl -u mysql -n 100 --no-pager
```

---

## 6. ğŸ“‹ å¼‚å¸¸æ—¥å¿—è®°å½•


### 6.1 æ—¥å¿—è®°å½•ç­–ç•¥


**ğŸ“Š åˆ†çº§æ—¥å¿—è®°å½•**
```
ERRORçº§åˆ«ï¼š
- ä¼˜åŒ–å™¨å´©æºƒ
- æŸ¥è¯¢æ‰§è¡Œå¤±è´¥
- ç³»ç»Ÿèµ„æºè€—å°½

WARNINGçº§åˆ«ï¼š
- ä¼˜åŒ–æ—¶é—´è¶…é•¿
- ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ
- é™çº§æ‰§è¡Œè§¦å‘

INFOçº§åˆ«ï¼š
- ä¼˜åŒ–å™¨é€‰æ‹©å˜æ›´
- ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
- é…ç½®å‚æ•°è°ƒæ•´

DEBUGçº§åˆ«ï¼š
- è¯¦ç»†çš„ä¼˜åŒ–è¿‡ç¨‹
- æˆæœ¬è®¡ç®—ç»†èŠ‚
- æ‰§è¡Œè®¡åˆ’é€‰æ‹©é€»è¾‘
```

### 6.2 æ—¥å¿—é…ç½®è®¾ç½®


**âš™ï¸ æ—¥å¿—é…ç½®**
```sql
-- MySQLæ—¥å¿—é…ç½®
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = ON;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
SET GLOBAL long_query_time = 2;

-- å¯ç”¨é€šç”¨æŸ¥è¯¢æ—¥å¿—ï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰
SET GLOBAL general_log = ON;
SET GLOBAL general_log_file = '/var/log/mysql/general.log';

-- è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = ON;

-- è®°å½•æ…¢æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯
SET GLOBAL log_slow_extra = ON;
```

### 6.3 è‡ªå®šä¹‰æ—¥å¿—è®°å½•


**ğŸ“ åº”ç”¨å±‚æ—¥å¿—è®°å½•**
```python
import logging
import time
import mysql.connector

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('optimizer_monitor.log'),
        logging.StreamHandler()
    ]
)

class QueryOptimizationMonitor:
    def __init__(self, db_config):
        self.db_config = db_config
        self.logger = logging.getLogger(__name__)
    
    def execute_with_monitoring(self, query, params=None):
        """æ‰§è¡ŒæŸ¥è¯¢å¹¶ç›‘æ§ä¼˜åŒ–å™¨è¡Œä¸º"""
        start_time = time.time()
        
        try:
            conn = mysql.connector.connect(**self.db_config)
            cursor = conn.cursor()
            
            # è®°å½•æŸ¥è¯¢å¼€å§‹
            self.logger.info(f"å¼€å§‹æ‰§è¡ŒæŸ¥è¯¢: {query[:100]}...")
            
            # è·å–æ‰§è¡Œè®¡åˆ’
            cursor.execute(f"EXPLAIN FORMAT=JSON {query}")
            plan = cursor.fetchone()[0]
            
            # æ‰§è¡ŒæŸ¥è¯¢
            cursor.execute(query, params)
            results = cursor.fetchall()
            
            execution_time = time.time() - start_time
            
            # è®°å½•æˆåŠŸæ‰§è¡Œ
            self.logger.info(
                f"æŸ¥è¯¢æ‰§è¡ŒæˆåŠŸ - è€—æ—¶: {execution_time:.3f}s, "
                f"è¿”å›è¡Œæ•°: {len(results)}"
            )
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¼˜åŒ–è­¦å‘Š
            if execution_time > 5:
                self.logger.warning(
                    f"æŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¾ƒé•¿: {execution_time:.3f}s, "
                    f"å»ºè®®æ£€æŸ¥æ‰§è¡Œè®¡åˆ’: {plan}"
                )
            
            return results
            
        except Exception as e:
            execution_time = time.time() - start_time
            self.logger.error(
                f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥ - è€—æ—¶: {execution_time:.3f}s, "
                f"é”™è¯¯: {str(e)}, æŸ¥è¯¢: {query}"
            )
            raise
        finally:
            if 'conn' in locals():
                conn.close()
```

### 6.4 æ—¥å¿—åˆ†æå·¥å…·


**ğŸ” æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash
# ä¼˜åŒ–å™¨å¼‚å¸¸æ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE="/var/log/mysql/error.log"
SLOW_LOG="/var/log/mysql/slow.log"

echo "=== ä¼˜åŒ–å™¨å¼‚å¸¸åˆ†ææŠ¥å‘Š ==="
echo "ç”Ÿæˆæ—¶é—´: $(date)"
echo

# 1. ç»Ÿè®¡é”™è¯¯ç±»å‹
echo "1. é”™è¯¯ç±»å‹ç»Ÿè®¡:"
grep -i "error\|crash\|fail" $LOG_FILE | \
    grep -i "optimizer\|plan\|execute" | \
    awk '{print $NF}' | sort | uniq -c | sort -nr

echo

# 2. åˆ†ææ…¢æŸ¥è¯¢
echo "2. æ…¢æŸ¥è¯¢ç»Ÿè®¡:"
if [ -f "$SLOW_LOG" ]; then
    grep "Query_time:" $SLOW_LOG | \
        awk '{print $2}' | \
        awk '{
            if($1 > 10) print "è¶…è¿‡10ç§’: " $1
            else if($1 > 5) print "5-10ç§’: " $1  
            else if($1 > 2) print "2-5ç§’: " $1
        }' | sort | uniq -c
fi

echo

# 3. æ£€æŸ¥èµ„æºä½¿ç”¨
echo "3. ç³»ç»Ÿèµ„æºæ£€æŸ¥:"
df -h | grep -E "(/$|/var)"
free -h
```

---

## 7. ğŸ”„ æ•…éšœè½¬ç§»æœºåˆ¶


### 7.1 æ•…éšœè½¬ç§»ç­–ç•¥


**ğŸ¯ è½¬ç§»ç­–ç•¥è®¾è®¡**
```
ä¸»ä»åˆ‡æ¢ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ•…éšœæ£€æµ‹    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»åº“å¼‚å¸¸      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚   ä»åº“æ¥ç®¡      â”‚
â”‚ (ä¼˜åŒ–å™¨å´©æºƒ)    â”‚               â”‚ (ç»§ç»­æœåŠ¡)      â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è´Ÿè½½åˆ†æ•£    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤æ‚æŸ¥è¯¢      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚   æŸ¥è¯¢åˆ†ç¦»      â”‚
â”‚ (ä¼˜åŒ–å›°éš¾)      â”‚               â”‚ (ç®€åŒ–å¤„ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœåŠ¡é™çº§ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æœåŠ¡è°ƒæ•´    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…¨åŠŸèƒ½æ¨¡å¼    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚   åŸºç¡€åŠŸèƒ½æ¨¡å¼  â”‚  
â”‚ (ä¼˜åŒ–å™¨å®Œæ•´)    â”‚               â”‚ (æ ¸å¿ƒåŠŸèƒ½)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è‡ªåŠ¨æ•…éšœè½¬ç§»


**âš¡ è½¬ç§»è§¦å‘æ¡ä»¶**
```sql
-- ç›‘æ§ä¼˜åŒ–å™¨å¥åº·çŠ¶æ€
CREATE VIEW optimizer_health_status AS
SELECT 
    -- æ…¢æŸ¥è¯¢æ¯”ä¾‹
    (SELECT COUNT(*) FROM performance_schema.events_statements_summary_global_by_event_name 
     WHERE SUM_TIMER_WAIT/SUM_COUNT_STAR > 5000000000) / 
    (SELECT COUNT(*) FROM performance_schema.events_statements_summary_global_by_event_name) * 100 
    as slow_query_percentage,
    
    -- é”™è¯¯æŸ¥è¯¢æ¯”ä¾‹  
    (SELECT SUM(SUM_ERRORS) FROM performance_schema.events_statements_summary_global_by_event_name) /
    (SELECT SUM(COUNT_STAR) FROM performance_schema.events_statements_summary_global_by_event_name) * 100
    as error_percentage,
    
    -- å½“å‰è¿è¡Œçº¿ç¨‹æ•°
    (SELECT COUNT(*) FROM performance_schema.threads WHERE TYPE = 'FOREGROUND') as active_connections;

-- è‡ªåŠ¨æ•…éšœè½¬ç§»æ£€æŸ¥
SELECT 
    CASE 
        WHEN slow_query_percentage > 30 THEN 'HIGH_RISK'
        WHEN slow_query_percentage > 15 THEN 'MEDIUM_RISK'  
        WHEN slow_query_percentage > 5 THEN 'LOW_RISK'
        ELSE 'NORMAL'
    END as risk_level,
    CASE
        WHEN error_percentage > 5 THEN 'CRITICAL'
        WHEN error_percentage > 1 THEN 'WARNING'
        ELSE 'OK'
    END as error_status
FROM optimizer_health_status;
```

### 7.3 æ‰‹åŠ¨æ•…éšœè½¬ç§»


**ğŸ”§ æ‰‹åŠ¨è½¬ç§»æ“ä½œ**
```sql
-- ç´§æ€¥æƒ…å†µä¸‹çš„æ‰‹åŠ¨è½¬ç§»

-- 1. å¯ç”¨åªè¯»æ¨¡å¼
SET GLOBAL read_only = ON;
SET GLOBAL super_read_only = ON;

-- 2. ç­‰å¾…å½“å‰æŸ¥è¯¢å®Œæˆ
SELECT 
    id, user, host, db, command, time, state, info
FROM information_schema.processlist 
WHERE command != 'Sleep' AND time > 30;

-- 3. å¼ºåˆ¶ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
-- KILL query_id;

-- 4. åˆ‡æ¢åˆ°å¤‡ç”¨å®ä¾‹
-- (éœ€è¦åº”ç”¨å±‚é…åˆä¿®æ”¹æ•°æ®åº“è¿æ¥é…ç½®)

-- 5. åœ¨å¤‡ç”¨å®ä¾‹ä¸ŠéªŒè¯åŠŸèƒ½
SELECT $$server_id, $$read_only;
SELECT COUNT(*) FROM critical_table;
```

### 7.4 æ•…éšœè½¬ç§»éªŒè¯


**âœ… è½¬ç§»åéªŒè¯**
```sql
-- éªŒè¯æ•°æ®ä¸€è‡´æ€§
CHECKSUM TABLE important_table;

-- éªŒè¯æœåŠ¡å¯ç”¨æ€§
SELECT 
    COUNT(*) as total_connections,
    SUM(CASE WHEN command != 'Sleep' THEN 1 ELSE 0 END) as active_queries
FROM information_schema.processlist;

-- éªŒè¯æ€§èƒ½è¡¨ç°
SELECT 
    EVENT_NAME,
    COUNT_STAR,
    AVG_TIMER_WAIT/1000000000 as avg_seconds,
    MAX_TIMER_WAIT/1000000000 as max_seconds
FROM performance_schema.events_statements_summary_global_by_event_name
WHERE EVENT_NAME LIKE 'statement/sql/select'
ORDER BY COUNT_STAR DESC LIMIT 5;
```

---

## 8. ğŸ›¡ï¸ ä¼˜åŒ–å™¨å®¹é”™è®¾è®¡


### 8.1 å®¹é”™è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡åŸåˆ™**
```
å¥å£®æ€§ä¼˜å…ˆï¼š
- ç¡®ä¿æŸ¥è¯¢æ€»èƒ½å¾—åˆ°æ­£ç¡®ç»“æœ
- æ€§èƒ½å¯ä»¥å¦¥åï¼Œæ­£ç¡®æ€§ä¸èƒ½å¦¥å
- æä¾›å¤šç§å¤‡é€‰æ‰§è¡Œè·¯å¾„

æ¸è¿›é™çº§ï¼š
- ä¼˜å…ˆå°è¯•æœ€ä¼˜æ–¹æ¡ˆ
- é‡åˆ°é—®é¢˜é€æ­¥ç®€åŒ–ç­–ç•¥
- ä¿æŒæœåŠ¡è¿ç»­æ€§

å¿«é€Ÿæ¢å¤ï¼š
- å¼‚å¸¸æ£€æµ‹è¦å¿«é€Ÿ
- æ¢å¤æ“ä½œè¦ç®€å•
- æœ€å°åŒ–åœæœºæ—¶é—´

ç”¨æˆ·é€æ˜ï¼š
- é”™è¯¯å¤„ç†å¯¹ç”¨æˆ·é€æ˜
- æä¾›ä¸€è‡´çš„æ¥å£ä½“éªŒ
- å¼‚å¸¸æƒ…å†µä¸‹çš„åˆç†å“åº”æ—¶é—´
```

### 8.2 å¤šé‡ä¿é™©æœºåˆ¶


**ğŸ”’ ä¿é™©æœºåˆ¶å®ç°**
```sql
-- ä¿é™©æœºåˆ¶1ï¼šæŸ¥è¯¢å¤æ‚åº¦æ£€æŸ¥
DELIMITER //
CREATE FUNCTION check_query_complexity(query_text TEXT) 
RETURNS VARCHAR(20)
DETERMINISTIC
READS SQL DATA
BEGIN
    DECLARE join_count INT DEFAULT 0;
    DECLARE subquery_count INT DEFAULT 0;
    DECLARE where_conditions INT DEFAULT 0;
    DECLARE complexity_score INT DEFAULT 0;
    
    -- è®¡ç®—JOINæ•°é‡
    SET join_count = (LENGTH(query_text) - LENGTH(REPLACE(UPPER(query_text), 'JOIN', ''))) / 4;
    
    -- è®¡ç®—å­æŸ¥è¯¢æ•°é‡  
    SET subquery_count = (LENGTH(query_text) - LENGTH(REPLACE(query_text, '(SELECT', ''))) / 7;
    
    -- è®¡ç®—WHEREæ¡ä»¶æ•°é‡
    SET where_conditions = (LENGTH(query_text) - LENGTH(REPLACE(UPPER(query_text), 'WHERE', ''))) / 5;
    
    -- è®¡ç®—å¤æ‚åº¦è¯„åˆ†
    SET complexity_score = join_count * 2 + subquery_count * 3 + where_conditions;
    
    RETURN CASE 
        WHEN complexity_score > 20 THEN 'VERY_HIGH'
        WHEN complexity_score > 10 THEN 'HIGH'
        WHEN complexity_score > 5 THEN 'MEDIUM'
        ELSE 'LOW'
    END;
END //
DELIMITER ;

-- ä¿é™©æœºåˆ¶2ï¼šæ‰§è¡Œæ—¶é—´ç›‘æ§
CREATE EVENT monitor_long_queries
ON SCHEDULE EVERY 30 SECOND
DO
BEGIN
    -- è®°å½•é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
    INSERT INTO long_query_log (query_id, user, host, query_time, query_text, created_at)
    SELECT 
        id, user, host, time, info, NOW()
    FROM information_schema.processlist 
    WHERE command = 'Query' 
      AND time > 60 
      AND info IS NOT NULL;
      
    -- å¯é€‰ï¼šè‡ªåŠ¨ç»ˆæ­¢è¶…é•¿æŸ¥è¯¢
    -- UPDATE performance_schema.processlist SET command = 'Kill' WHERE time > 300;
END;
```

### 8.3 æ™ºèƒ½å¤‡é€‰æ–¹æ¡ˆ


**ğŸ§  æ™ºèƒ½æ–¹æ¡ˆé€‰æ‹©**
```sql
-- æ™ºèƒ½æ‰§è¡Œè®¡åˆ’é€‰æ‹©
DELIMITER //
CREATE PROCEDURE smart_query_execution(IN query_sql TEXT, IN max_time INT)
BEGIN
    DECLARE start_time TIMESTAMP;
    DECLARE execution_time INT;
    DECLARE plan_cost FLOAT;
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- å¼‚å¸¸å¤„ç†ï¼šä½¿ç”¨æœ€ç®€å•çš„æ‰§è¡Œæ–¹å¼
        SET @fallback_sql = CONCAT(
            'SELECT /*+ NO_INDEX() */ ', 
            SUBSTRING(query_sql FROM LOCATE('SELECT', query_sql) + 6)
        );
        SET @sql = @fallback_sql;
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END;
    
    SET start_time = NOW();
    
    -- æ–¹æ¡ˆ1ï¼šå°è¯•åŸå§‹æŸ¥è¯¢
    SET @sql = query_sql;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    SET execution_time = TIMESTAMPDIFF(SECOND, start_time, NOW());
    
    -- å¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œè®°å½•å¹¶è€ƒè™‘ä¼˜åŒ–
    IF execution_time > max_time THEN
        INSERT INTO slow_query_analysis (query_text, execution_time, suggestion)
        VALUES (query_sql, execution_time, 'Consider query optimization');
    END IF;
    
END //
DELIMITER ;
```

### 8.4 è‡ªé€‚åº”ä¼˜åŒ–ç­–ç•¥


**âš¡ è‡ªé€‚åº”æœºåˆ¶**
```sql
-- è‡ªé€‚åº”ä¼˜åŒ–å™¨é…ç½®è°ƒæ•´
CREATE TABLE optimizer_performance_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    query_pattern VARCHAR(500),
    optimizer_settings JSON,
    avg_execution_time DECIMAL(10,3),
    success_rate DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åŸºäºå†å²æ€§èƒ½è‡ªåŠ¨è°ƒæ•´ä¼˜åŒ–å™¨å‚æ•°
DELIMITER //
CREATE PROCEDURE adaptive_optimizer_tuning()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE query_pattern VARCHAR(500);
    DECLARE best_settings JSON;
    DECLARE current_success_rate DECIMAL(5,2);
    
    DECLARE pattern_cursor CURSOR FOR
        SELECT 
            query_pattern,
            optimizer_settings,
            success_rate
        FROM optimizer_performance_history
        WHERE created_at > DATE_SUB(NOW(), INTERVAL 24 HOUR)
        ORDER BY success_rate DESC;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN pattern_cursor;
    
    tuning_loop: LOOP
        FETCH pattern_cursor INTO query_pattern, best_settings, current_success_rate;
        IF done THEN
            LEAVE tuning_loop;
        END IF;
        
        -- å¦‚æœæˆåŠŸç‡ä½äºé˜ˆå€¼ï¼Œåº”ç”¨æœ€ä½³é…ç½®
        IF current_success_rate < 95.0 THEN
            -- è¿™é‡Œå¯ä»¥æ ¹æ®best_settingsè°ƒæ•´ä¼˜åŒ–å™¨å‚æ•°
            -- å®é™…å®ç°éœ€è¦è§£æJSONå¹¶è®¾ç½®ç›¸åº”å‚æ•°
            SELECT CONCAT('å»ºè®®è°ƒæ•´å‚æ•°ï¼š', best_settings) as suggestion;
        END IF;
        
    END LOOP;
    
    CLOSE pattern_cursor;
END //
DELIMITER ;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ é”™è¯¯å¤„ç†ä½“ç³»**
```
âœ“ å¼‚å¸¸å¤„ç† - åŠæ—¶å‘ç°å’Œå¤„ç†ä¼˜åŒ–å™¨å¼‚å¸¸
âœ“ é™çº§ç­–ç•¥ - å¼‚å¸¸æ—¶è‡ªåŠ¨ä½¿ç”¨ç®€åŒ–æ‰§è¡Œæ–¹æ¡ˆ
âœ“ é”™è¯¯æ¢å¤ - å¿«é€Ÿæ¢å¤æ­£å¸¸çš„ä¼˜åŒ–å™¨åŠŸèƒ½
âœ“ å´©æºƒå¤„ç† - åº”å¯¹ä¸¥é‡çš„ç³»ç»Ÿæ•…éšœæƒ…å†µ
âœ“ æ—¥å¿—è®°å½• - å®Œæ•´è®°å½•å¼‚å¸¸ä¿¡æ¯ä¾¿äºåˆ†æ
âœ“ æ•…éšœè½¬ç§» - ä¿è¯æœåŠ¡è¿ç»­æ€§çš„å¤‡é€‰æ–¹æ¡ˆ
âœ“ å®¹é”™è®¾è®¡ - ä»è®¾è®¡å±‚é¢æé«˜ç³»ç»Ÿå¥å£®æ€§
```

### 9.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ› ï¸ å®æ–½å»ºè®®**
```
é¢„é˜²ä¸ºä¸»ï¼š
- è®¾ç½®åˆç†çš„èµ„æºé™åˆ¶
- å®šæœŸç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯
- ç›‘æ§ç³»ç»Ÿå¥åº·çŠ¶æ€
- åŠæ—¶æ›´æ–°æ•°æ®åº“ç‰ˆæœ¬

å¿«é€Ÿå“åº”ï¼š
- å»ºç«‹å¼‚å¸¸ç›‘æ§æœºåˆ¶
- å‡†å¤‡åº”æ€¥å¤„ç†é¢„æ¡ˆ
- åŸ¹è®­è¿ç»´å¤„ç†æŠ€èƒ½
- æµ‹è¯•æ•…éšœæ¢å¤æµç¨‹

æŒç»­æ”¹è¿›ï¼š
- åˆ†æå†å²å¼‚å¸¸æ¨¡å¼
- ä¼˜åŒ–é”™è¯¯å¤„ç†ç­–ç•¥
- æ›´æ–°å®¹é”™æœºåˆ¶è®¾è®¡
- ç§¯ç´¯æœ€ä½³å®è·µç»éªŒ
```

### 9.3 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**
```sql
-- 1. è®¾ç½®åˆç†çš„è¶…æ—¶å’Œé™åˆ¶
SET SESSION max_execution_time = 30000;
SET SESSION optimizer_search_depth = 32;
SET SESSION max_join_size = 1000000;

-- 2. å¯ç”¨å¿…è¦çš„ç›‘æ§
SET GLOBAL slow_query_log = ON;
SET GLOBAL log_queries_not_using_indexes = ON;

-- 3. å®šæœŸç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯
-- å»ºç«‹å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼šANALYZE TABLE
-- ç›‘æ§ç»Ÿè®¡ä¿¡æ¯çš„æ—¶æ•ˆæ€§

-- 4. å»ºç«‹å¥åº·æ£€æŸ¥æœºåˆ¶
-- å®šæœŸæ£€æŸ¥ä¼˜åŒ–å™¨æ€§èƒ½æŒ‡æ ‡
-- ç›‘æ§å¼‚å¸¸æŸ¥è¯¢æ¨¡å¼

-- 5. å‡†å¤‡åº”æ€¥å¤„ç†æ–¹æ¡ˆ
-- æ–‡æ¡£åŒ–çš„æ•…éšœå¤„ç†æµç¨‹
-- é¢„è®¾çš„é™çº§æ‰§è¡Œç­–ç•¥
-- å¿«é€Ÿçš„æ•°æ®æ¢å¤æ–¹æ³•
```

### 9.4 å¼‚å¸¸åœºæ™¯åº”å¯¹ç­–ç•¥


**ğŸš¨ åº”å¯¹ç­–ç•¥æ€»ç»“**

| å¼‚å¸¸åœºæ™¯ | **æ£€æµ‹æ–¹æ³•** | **å¤„ç†ç­–ç•¥** | **æ¢å¤æªæ–½** |
|----------|-------------|-------------|-------------|
| **ä¼˜åŒ–å™¨è¶…æ—¶** | ç›‘æ§æ‰§è¡Œæ—¶é—´ | å¯ç”¨é™çº§æ‰§è¡Œ | ç®€åŒ–æŸ¥è¯¢é€»è¾‘ |
| **å†…å­˜ä¸è¶³** | ç›‘æ§å†…å­˜ä½¿ç”¨ | é™åˆ¶å¤æ‚åº¦ | å¢åŠ ç³»ç»Ÿå†…å­˜ |
| **ç»Ÿè®¡ä¿¡æ¯å¼‚å¸¸** | æ£€æŸ¥æ›´æ–°æ—¶é—´ | é‡å»ºç»Ÿè®¡ä¿¡æ¯ | å®šæœŸç»´æŠ¤ä»»åŠ¡ |
| **ç³»ç»Ÿå´©æºƒ** | æœåŠ¡çŠ¶æ€ç›‘æ§ | é‡å¯æ•°æ®åº“æœåŠ¡ | æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ |
| **å¹¶å‘å†²çª** | é”ç­‰å¾…ç›‘æ§ | æŸ¥è¯¢é˜Ÿåˆ—ç®¡ç† | ä¼˜åŒ–å¹¶å‘æ§åˆ¶ |

### 9.5 å®¹é”™èƒ½åŠ›æå‡å»ºè®®


**ğŸ›¡ï¸ å¥å£®æ€§å¢å¼º**
```
æ¶æ„å±‚é¢ï¼š
- ä¸»ä»å¤åˆ¶ä¿è¯å¯ç”¨æ€§
- è¯»å†™åˆ†ç¦»é™ä½å‹åŠ›
- è¿æ¥æ± ç®¡ç†èµ„æºä½¿ç”¨
- è´Ÿè½½å‡è¡¡åˆ†æ•£é£é™©

é…ç½®å±‚é¢ï¼š
- åˆç†è®¾ç½®èµ„æºé™åˆ¶
- å¯ç”¨é€‚å½“çš„å®‰å…¨æœºåˆ¶
- é…ç½®å®Œå–„çš„ç›‘æ§å‘Šè­¦
- å»ºç«‹è‡ªåŠ¨åŒ–è¿ç»´æµç¨‹

ä»£ç å±‚é¢ï¼š
- åº”ç”¨å±‚æŸ¥è¯¢è¶…æ—¶æ§åˆ¶
- æ•°æ®åº“è¿æ¥å¼‚å¸¸å¤„ç†
- æŸ¥è¯¢é‡è¯•æœºåˆ¶è®¾è®¡
- é™çº§æ–¹æ¡ˆè‡ªåŠ¨è§¦å‘

è¿ç»´å±‚é¢ï¼š
- å®šæœŸå¤‡ä»½é‡è¦æ•°æ®
- å»ºç«‹æ•…éšœå¤„ç†æ‰‹å†Œ
- è¿›è¡Œæ•…éšœæ¼”ç»ƒè®­ç»ƒ
- æŒç»­ä¼˜åŒ–å¤„ç†æµç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¼˜åŒ–å™¨é”™è¯¯å¤„ç†æ˜¯ä¿è¯æ•°æ®åº“ç¨³å®šæ€§çš„å…³é”®æœºåˆ¶
- å¤šå±‚é˜²æŠ¤ç­–ç•¥ç¡®ä¿å³ä½¿å‡ºç°å¼‚å¸¸ä¹Ÿèƒ½æ­£å¸¸æä¾›æœåŠ¡
- é¢„é˜²èƒœäºæ²»ç–—ï¼Œä¸»åŠ¨ç›‘æ§å’Œç»´æŠ¤æ¯”è¢«åŠ¨å¤„ç†æ›´æœ‰æ•ˆ
- å®Œå–„çš„æ—¥å¿—è®°å½•æ˜¯å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜çš„é‡è¦å·¥å…·
- å®¹é”™è®¾è®¡åº”è¯¥è´¯ç©¿æ•´ä¸ªç³»ç»Ÿæ¶æ„å’Œè¿ç»´æµç¨‹