---
title: 7ã€æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§è§£æ
---
## ğŸ“š ç›®å½•

1. [æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§æ¦‚è¿°](#1-æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§æ¦‚è¿°)
2. [æ‰§è¡Œè®¡åˆ’æ³¢åŠ¨çš„æ ¹æº](#2-æ‰§è¡Œè®¡åˆ’æ³¢åŠ¨çš„æ ¹æº)
3. [ç»Ÿè®¡ä¿¡æ¯å˜åŒ–å½±å“åˆ†æ](#3-ç»Ÿè®¡ä¿¡æ¯å˜åŒ–å½±å“åˆ†æ)
4. [è®¡åˆ’å›å½’é—®é¢˜æ·±åº¦å‰–æ](#4-è®¡åˆ’å›å½’é—®é¢˜æ·±åº¦å‰–æ)
5. [è®¡åˆ’å›ºå®šæŠ€æœ¯å®è·µ](#5-è®¡åˆ’å›ºå®šæŠ€æœ¯å®è·µ)
6. [SPMè®¡åˆ’ç®¡ç†æœºåˆ¶](#6-SPMè®¡åˆ’ç®¡ç†æœºåˆ¶)
7. [è®¡åˆ’åŸºçº¿å»ºç«‹ç­–ç•¥](#7-è®¡åˆ’åŸºçº¿å»ºç«‹ç­–ç•¥)
8. [è®¡åˆ’æ¼”è¿›æ§åˆ¶æ–¹æ³•](#8-è®¡åˆ’æ¼”è¿›æ§åˆ¶æ–¹æ³•)
9. [ç¨³å®šæ€§ç›‘æ§å‘Šè­¦ä½“ç³»](#9-ç¨³å®šæ€§ç›‘æ§å‘Šè­¦ä½“ç³»)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§


**æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§**ï¼šåŒä¸€ä¸ªSQLè¯­å¥åœ¨ç›¸ä¼¼çš„ç¯å¢ƒæ¡ä»¶ä¸‹ï¼Œåº”è¯¥æŒç»­ä½¿ç”¨ç›¸åŒæˆ–ç›¸ä¼¼æ€§èƒ½çš„æ‰§è¡Œè®¡åˆ’ï¼Œé¿å…æ— è°“çš„æ€§èƒ½æ³¢åŠ¨ã€‚

```
ç†æƒ³æƒ…å†µï¼š
SQLæ‰§è¡Œ â†’ ä¼˜åŒ–å™¨ â†’ ç¨³å®šçš„é«˜æ•ˆæ‰§è¡Œè®¡åˆ’ â†’ ç¨³å®šçš„æ€§èƒ½è¡¨ç°

ç°å®æƒ…å†µï¼š
SQLæ‰§è¡Œ â†’ ä¼˜åŒ–å™¨ â†’ æ‰§è¡Œè®¡åˆ’A (1ç§’)
                â†“
ä¸‹æ¬¡æ‰§è¡Œ â†’ ä¼˜åŒ–å™¨ â†’ æ‰§è¡Œè®¡åˆ’B (10ç§’) â† è¿™å°±æ˜¯è®¡åˆ’ä¸ç¨³å®š
```

### 1.2 æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å…³æ³¨æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§**ï¼š

- **æ€§èƒ½å¯é¢„æµ‹æ€§**ï¼šåº”ç”¨å“åº”æ—¶é—´ä¸åº”è¯¥å‡ºç°çªç„¶çš„å¤§å¹…æ³¢åŠ¨
- **è¿ç»´ç¨³å®šæ€§**ï¼šé¿å…å› è®¡åˆ’å˜åŒ–å¯¼è‡´çš„ç”Ÿäº§é—®é¢˜
- **ç”¨æˆ·ä½“éªŒ**ï¼šä¿è¯ç”¨æˆ·æ“ä½œçš„ä¸€è‡´æ€§ä½“éªŒ
- **èµ„æºè§„åˆ’**ï¼šä¾¿äºè¿›è¡Œå®¹é‡è§„åˆ’å’Œèµ„æºé…ç½®

```
ä¸šåŠ¡å½±å“ç¤ºä¾‹ï¼š
ç”µå•†ç½‘ç«™å•†å“æŸ¥è¯¢ï¼š
æ­£å¸¸æƒ…å†µï¼š200mså“åº”æ—¶é—´
è®¡åˆ’å˜åŒ–åï¼š5ç§’å“åº”æ—¶é—´ â† ç”¨æˆ·æµå¤±ã€ä¸šåŠ¡å—æŸ
```

### 1.3 æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§çš„æŒ‘æˆ˜


**å¯¼è‡´è®¡åˆ’ä¸ç¨³å®šçš„å¸¸è§å› ç´ **ï¼š

```
å¤–éƒ¨å› ç´ ï¼š
â”œâ”€ æ•°æ®é‡å˜åŒ–ï¼šè¡¨æ•°æ®å¢é•¿å¯¼è‡´ç»Ÿè®¡ä¿¡æ¯å˜åŒ–
â”œâ”€ æ•°æ®åˆ†å¸ƒå˜åŒ–ï¼šçƒ­ç‚¹æ•°æ®åˆ†å¸ƒå‘ç”Ÿå˜åŒ–
â”œâ”€ ç³»ç»Ÿè´Ÿè½½å˜åŒ–ï¼šå¹¶å‘é‡ã€å†…å­˜ä½¿ç”¨æƒ…å†µå˜åŒ–
â””â”€ é…ç½®å‚æ•°å˜åŒ–ï¼šæ•°æ®åº“å‚æ•°è°ƒæ•´

å†…éƒ¨å› ç´ ï¼š
â”œâ”€ ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ï¼šè‡ªåŠ¨æˆ–æ‰‹åŠ¨ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
â”œâ”€ ç´¢å¼•å˜åŒ–ï¼šæ–°å¢ã€åˆ é™¤ã€é‡å»ºç´¢å¼•
â”œâ”€ è¡¨ç»“æ„å˜åŒ–ï¼šå­—æ®µä¿®æ”¹ã€åˆ†åŒºè°ƒæ•´
â””â”€ ä¼˜åŒ–å™¨ç‰ˆæœ¬ï¼šæ•°æ®åº“ç‰ˆæœ¬å‡çº§å¸¦æ¥çš„ä¼˜åŒ–å™¨æ”¹è¿›
```

---

## 2. ğŸŒŠ æ‰§è¡Œè®¡åˆ’æ³¢åŠ¨çš„æ ¹æº


### 2.1 ä¼˜åŒ–å™¨æˆæœ¬ä¼°ç®—çš„ä¸ç¡®å®šæ€§


**æˆæœ¬ä¼°ç®—æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé¢„æµ‹è¿‡ç¨‹**ï¼Œå­˜åœ¨å›ºæœ‰çš„ä¸å‡†ç¡®æ€§ã€‚

```
æˆæœ¬ä¼°ç®—çš„æŒ‘æˆ˜ï¼š
å®é™…æ•°æ®åˆ†å¸ƒ vs ç»Ÿè®¡ä¿¡æ¯å‡è®¾
   â†“
çœŸå®IOä»£ä»· vs ä¼°ç®—IOä»£ä»·  
   â†“
åŠ¨æ€ç³»ç»ŸçŠ¶æ€ vs é™æ€æˆæœ¬æ¨¡å‹
   â†“
ç»“æœï¼šæˆæœ¬ä¼°ç®—åå·®å¯¼è‡´è®¡åˆ’é€‰æ‹©æ‘‡æ‘†
```

**æˆæœ¬ä¼°ç®—ä¸å‡†ç¡®çš„æ¡ˆä¾‹**ï¼š
```sql
-- ç¤ºä¾‹æŸ¥è¯¢
SELECT * FROM orders WHERE order_date BETWEEN '2025-01-01' AND '2025-01-31';

-- åœºæ™¯1ï¼šæœˆåˆæ•°æ®å°‘
ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼šè¯¥æœˆæœ‰1000æ¡è®°å½•
ä¼˜åŒ–å™¨é€‰æ‹©ï¼šç´¢å¼•æ‰«æ (æˆæœ¬ä¼°ç®—: 100)

-- åœºæ™¯2ï¼šæœˆæœ«æ•°æ®å¤š  
ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼šè¯¥æœˆæœ‰50000æ¡è®°å½•
ä¼˜åŒ–å™¨é€‰æ‹©ï¼šå…¨è¡¨æ‰«æ (æˆæœ¬ä¼°ç®—: 80)

-- ç»“æœï¼šåŒä¸€ä¸ªæŸ¥è¯¢åœ¨ä¸åŒæ—¶æœŸä½¿ç”¨ä¸åŒçš„æ‰§è¡Œè®¡åˆ’
```

### 2.2 ç»Ÿè®¡ä¿¡æ¯çš„æ—¶æ•ˆæ€§é—®é¢˜


**ç»Ÿè®¡ä¿¡æ¯æ»åå¯¼è‡´çš„è®¡åˆ’æ‘‡æ‘†**ï¼š

```
ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å‘¨æœŸï¼š
æ•°æ®å˜åŒ– â”€â”€â”€â”€â†’ ç»Ÿè®¡ä¿¡æ¯è¿‡æœŸ â”€â”€â”€â”€â†’ è®¡åˆ’é€‰æ‹©é”™è¯¯
    â†“               â†“                â†“
æŒç»­æ—¶é—´1å°æ—¶      ä¼˜åŒ–å™¨åŸºäº        æ€§èƒ½ä¸‹é™100å€
               è¿‡æœŸä¿¡æ¯å†³ç­–
    â†“               â†“                â†“
ç»Ÿè®¡ä¿¡æ¯æ›´æ–° â”€â”€â”€â”€â†’ è®¡åˆ’é‡æ–°é€‰æ‹© â”€â”€â”€â”€â†’ æ€§èƒ½æ¢å¤æ­£å¸¸
```

**å®é™…æ¡ˆä¾‹**ï¼š
```sql
-- å¤§è¡¨æ‰¹é‡å¯¼å…¥åœºæ™¯
INSERT INTO user_behavior SELECT * FROM temp_import; -- å¯¼å…¥1000ä¸‡æ¡è®°å½•

-- å¯¼å…¥å‰ï¼šuser_behaviorè¡¨100ä¸‡æ¡è®°å½•
-- æŸ¥è¯¢è®¡åˆ’ï¼šä½¿ç”¨ç´¢å¼•æ‰«æ
EXPLAIN SELECT * FROM user_behavior WHERE user_id = 12345;

-- å¯¼å…¥åï¼šuser_behaviorè¡¨1100ä¸‡æ¡è®°å½•ï¼Œä½†ç»Ÿè®¡ä¿¡æ¯æœªæ›´æ–°
-- æŸ¥è¯¢è®¡åˆ’ï¼šä»ç„¶ä½¿ç”¨ç´¢å¼•æ‰«æï¼Œä½†æ€§èƒ½æ€¥å‰§ä¸‹é™

-- ç»Ÿè®¡ä¿¡æ¯æ›´æ–°åï¼š
ANALYZE TABLE user_behavior;
-- æŸ¥è¯¢è®¡åˆ’ï¼šå¯èƒ½æ”¹ä¸ºå…¨è¡¨æ‰«æï¼ˆå¦‚æœé€‰æ‹©æ€§å˜å·®ï¼‰
```

### 2.3 ç»‘å®šå˜é‡å¯¼è‡´çš„è®¡åˆ’æ‘‡æ‘†


**ç»‘å®šå˜é‡çª¥æ¢ï¼ˆBind Variable Peekingï¼‰é—®é¢˜**ï¼š

```
ç»‘å®šå˜é‡çª¥æ¢æœºåˆ¶ï¼š
ç¬¬ä¸€æ¬¡æ‰§è¡Œ â†’ ä¼˜åŒ–å™¨æŸ¥çœ‹ç»‘å®šå˜é‡å€¼ â†’ åŸºäºå…·ä½“å€¼ä¼˜åŒ– â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
     â†“
åç»­æ‰§è¡Œ â†’ å¤ç”¨ç›¸åŒæ‰§è¡Œè®¡åˆ’ â†’ å¯èƒ½ä¸é€‚åˆæ–°çš„ç»‘å®šå˜é‡å€¼
```

**é—®é¢˜åœºæ™¯ç¤ºä¾‹**ï¼š
```sql
-- å‡†å¤‡çš„è¯­å¥
SELECT * FROM employees WHERE department_id = ? AND salary > ?;

-- ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼šdepartment_id=1 (ç ”å‘éƒ¨ï¼Œ10000äºº), salary>50000
-- ä¼˜åŒ–å™¨é€‰æ‹©ï¼šå…¨è¡¨æ‰«æï¼ˆå› ä¸ºç ”å‘éƒ¨äººå¤šï¼Œé«˜è–ªäººå‘˜ä¹Ÿå¤šï¼‰

-- ç¬¬äºŒæ¬¡æ‰§è¡Œï¼šdepartment_id=99 (å°éƒ¨é—¨ï¼Œ10äºº), salary>200000  
-- ä»ä½¿ç”¨å…¨è¡¨æ‰«æï¼Œä½†å®é™…ä¸Šç´¢å¼•æ‰«ææ›´é«˜æ•ˆ
-- ç»“æœï¼šè®¡åˆ’ä¸åŒ¹é…ï¼Œæ€§èƒ½ä¸‹é™
```

### 2.4 ç³»ç»Ÿèµ„æºçŠ¶æ€çš„å½±å“


**åŠ¨æ€ç³»ç»ŸçŠ¶æ€å¯¹è®¡åˆ’é€‰æ‹©çš„å½±å“**ï¼š

```
ç³»ç»ŸçŠ¶æ€å˜åŒ–ï¼š
å†…å­˜å……è¶³æ—¶æœŸï¼š
â”œâ”€ Buffer Poolå‘½ä¸­ç‡é«˜
â”œâ”€ æ’åºæ“ä½œåå‘å†…å­˜æ’åº  
â””â”€ ä¼˜åŒ–å™¨å€¾å‘äºé€‰æ‹©å†…å­˜å¯†é›†å‹æ“ä½œ

å†…å­˜ç´§å¼ æ—¶æœŸï¼š
â”œâ”€ Buffer Poolå‘½ä¸­ç‡ä¸‹é™
â”œâ”€ ç£ç›˜IOæˆæœ¬ä¸Šå‡
â””â”€ ä¼˜åŒ–å™¨å¯èƒ½æ”¹å˜æ‰§è¡Œè®¡åˆ’é€‰æ‹©
```

---

## 3. ğŸ“Š ç»Ÿè®¡ä¿¡æ¯å˜åŒ–å½±å“åˆ†æ


### 3.1 ç»Ÿè®¡ä¿¡æ¯çš„æ„æˆè¦ç´ 


**ç»Ÿè®¡ä¿¡æ¯åŒ…å«çš„å…³é”®æ•°æ®**ï¼š

```
è¡¨çº§ç»Ÿè®¡ä¿¡æ¯ï¼š
â”œâ”€ è¡¨è¡Œæ•° (TABLE_ROWS)
â”œâ”€ å¹³å‡è¡Œé•¿åº¦ (AVG_ROW_LENGTH)
â”œâ”€ æ•°æ®å¤§å° (DATA_LENGTH)
â””â”€ æœ€åæ›´æ–°æ—¶é—´ (UPDATE_TIME)

ç´¢å¼•çº§ç»Ÿè®¡ä¿¡æ¯ï¼š
â”œâ”€ ç´¢å¼•åŸºæ•° (CARDINALITY) â† æœ€å…³é”®
â”œâ”€ ç´¢å¼•é€‰æ‹©æ€§ (SELECTIVITY)
â”œâ”€ ç´¢å¼•æ·±åº¦ (INDEX_DEPTH)
â””â”€ ç´¢å¼•å¤§å° (INDEX_LENGTH)

åˆ—çº§ç»Ÿè®¡ä¿¡æ¯ï¼š
â”œâ”€ å”¯ä¸€å€¼æ•°é‡ (NDV - Number of Distinct Values)
â”œâ”€ NULLå€¼æ¯”ä¾‹ (NULL_RATIO)
â”œâ”€ æœ€å¤§æœ€å°å€¼ (MIN_VALUE, MAX_VALUE)
â””â”€ ç›´æ–¹å›¾ä¿¡æ¯ (HISTOGRAM)
```

### 3.2 ç»Ÿè®¡ä¿¡æ¯å˜åŒ–çš„è§¦å‘æ¡ä»¶


**è‡ªåŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°çš„è§¦å‘æœºåˆ¶**ï¼š

```sql
-- MySQLçš„è‡ªåŠ¨ç»Ÿè®¡æ›´æ–°æ¡ä»¶ï¼ˆInnoDBï¼‰
-- å½“è¡¨çš„å˜æ›´è¡Œæ•°è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘

UPDATEé˜ˆå€¼è®¡ç®—ï¼š
changed_rows > table_rows / 16 + 2000

ç¤ºä¾‹ï¼š
è¡¨è¡Œæ•°100ä¸‡ â†’ é˜ˆå€¼ï¼š100ä¸‡/16 + 2000 = 64500è¡Œ
è¡¨è¡Œæ•°10ä¸‡  â†’ é˜ˆå€¼ï¼š10ä¸‡/16 + 2000 = 8250è¡Œ
è¡¨è¡Œæ•°1ä¸‡   â†’ é˜ˆå€¼ï¼š1ä¸‡/16 + 2000 = 2625è¡Œ
```

**æ‰‹åŠ¨ç»Ÿè®¡ä¿¡æ¯æ›´æ–°**ï¼š
```sql
-- ç«‹å³æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE employees;

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å†å²
SELECT * FROM information_schema.STATISTICS 
WHERE TABLE_NAME = 'employees';

-- æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯è¯¦ç»†å†…å®¹
SHOW TABLE STATUS LIKE 'employees';
```

### 3.3 ç»Ÿè®¡ä¿¡æ¯å˜åŒ–å¯¹æ‰§è¡Œè®¡åˆ’çš„å½±å“


**åŸºæ•°å˜åŒ–å¯¼è‡´çš„è®¡åˆ’æ”¹å˜**ï¼š

```sql
-- åœºæ™¯ï¼šç”¨æˆ·è¡¨çš„çŠ¶æ€å­—æ®µç»Ÿè®¡ä¿¡æ¯å˜åŒ–
SELECT * FROM users WHERE status = 'active';

-- å˜åŒ–å‰ï¼š
-- activeç”¨æˆ·ï¼š1000äºº (å æ€»ç”¨æˆ·10ä¸‡çš„1%)
-- ç´¢å¼•åŸºæ•°æ˜¾ç¤ºï¼šé€‰æ‹©æ€§å¾ˆå¥½
-- æ‰§è¡Œè®¡åˆ’ï¼šç´¢å¼•æ‰«æ

-- å˜åŒ–åï¼š
-- activeç”¨æˆ·ï¼š8ä¸‡äºº (å æ€»ç”¨æˆ·10ä¸‡çš„80%)  
-- ç´¢å¼•åŸºæ•°æ›´æ–°ï¼šé€‰æ‹©æ€§å˜å·®
-- æ‰§è¡Œè®¡åˆ’ï¼šå…¨è¡¨æ‰«æ

-- å½±å“ï¼šåŒä¸€æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’å‘ç”Ÿæ ¹æœ¬æ€§å˜åŒ–
```

**ç›´æ–¹å›¾ä¿¡æ¯å¯¹å¤æ‚æ¡ä»¶çš„å½±å“**ï¼š
```sql
-- å¤æ‚èŒƒå›´æŸ¥è¯¢
SELECT * FROM sales WHERE sale_date BETWEEN '2025-01-01' AND '2025-01-15';

-- MySQL 8.0çš„ç›´æ–¹å›¾ç»Ÿè®¡ï¼š
-- å¯ä»¥æ›´å‡†ç¡®ä¼°ç®—èŒƒå›´æŸ¥è¯¢çš„é€‰æ‹©æ€§
-- é¿å…ä¼ ç»Ÿç»Ÿè®¡ä¿¡æ¯çš„çº¿æ€§åˆ†å¸ƒå‡è®¾é”™è¯¯
```

### 3.4 ç»Ÿè®¡ä¿¡æ¯ç®¡ç†ç­–ç•¥


**ç»Ÿè®¡ä¿¡æ¯æ›´æ–°ç­–ç•¥çš„å¹³è¡¡**ï¼š

```
æ›´æ–°é¢‘ç‡çš„æƒè¡¡ï¼š
è¿‡äºé¢‘ç¹ï¼š
â”œâ”€ ä¼˜ç‚¹ï¼šç»Ÿè®¡ä¿¡æ¯å§‹ç»ˆå‡†ç¡®
â”œâ”€ ç¼ºç‚¹ï¼šè®¡åˆ’é¢‘ç¹å˜åŒ–ï¼Œç³»ç»Ÿå¼€é”€å¤§
â””â”€ é€‚ç”¨ï¼šå¿«é€Ÿå˜åŒ–çš„å°è¡¨

æ›´æ–°ä¸è¶³ï¼š
â”œâ”€ ä¼˜ç‚¹ï¼šè®¡åˆ’ç¨³å®š
â”œâ”€ ç¼ºç‚¹ï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æœŸï¼Œè®¡åˆ’é€‰æ‹©é”™è¯¯  
â””â”€ é€‚ç”¨ï¼šç›¸å¯¹ç¨³å®šçš„å¤§è¡¨

åˆç†ç­–ç•¥ï¼š
â”œâ”€ å®šæœŸæ›´æ–°ï¼šæ¯æ—¥å‡Œæ™¨æ‰¹é‡æ›´æ–°
â”œâ”€ é˜ˆå€¼è§¦å‘ï¼šé‡å¤§æ•°æ®å˜åŒ–æ—¶æ›´æ–°
â”œâ”€ æ‰‹åŠ¨å¹²é¢„ï¼šå…³é”®SQLçš„ç»Ÿè®¡ä¿¡æ¯é”å®š
â””â”€ ç›‘æ§å‘Šè­¦ï¼šç»Ÿè®¡ä¿¡æ¯è¿‡æœŸå‘Šè­¦
```

---

## 4. ğŸ”„ è®¡åˆ’å›å½’é—®é¢˜æ·±åº¦å‰–æ


### 4.1 ä»€ä¹ˆæ˜¯è®¡åˆ’å›å½’


**è®¡åˆ’å›å½’ï¼ˆPlan Regressionï¼‰**ï¼šæŒ‡æ‰§è¡Œè®¡åˆ’ä»ä¸€ä¸ªè¾ƒå¥½çš„æ–¹æ¡ˆå˜æ›´ä¸ºè¾ƒå·®çš„æ–¹æ¡ˆï¼Œå¯¼è‡´æŸ¥è¯¢æ€§èƒ½æ˜¾è‘—ä¸‹é™çš„ç°è±¡ã€‚

```
è®¡åˆ’å›å½’çš„å…¸å‹è¡¨ç°ï¼š
æ—¶é—´è½´ï¼š
T1: SQLæ‰§è¡Œæ—¶é—´ 100ms (ä½¿ç”¨è®¡åˆ’A - ç´¢å¼•æ‰«æ)
T2: SQLæ‰§è¡Œæ—¶é—´ 100ms (ä½¿ç”¨è®¡åˆ’A - ç´¢å¼•æ‰«æ)  
T3: SQLæ‰§è¡Œæ—¶é—´ 5000ms (ä½¿ç”¨è®¡åˆ’B - å…¨è¡¨æ‰«æ) â† è®¡åˆ’å›å½’
T4: SQLæ‰§è¡Œæ—¶é—´ 5000ms (ä½¿ç”¨è®¡åˆ’B - å…¨è¡¨æ‰«æ)
```

### 4.2 è®¡åˆ’å›å½’çš„å¸¸è§åœºæ™¯


**æ•°æ®å¢é•¿å¯¼è‡´çš„å›å½’**ï¼š
```sql
-- ç¤ºä¾‹ï¼šè®¢å•æŸ¥è¯¢åœ¨æ•°æ®å¢é•¿åçš„å›å½’
SELECT * FROM orders WHERE customer_id = 12345 AND order_date > '2025-01-01';

-- åœºæ™¯1ï¼šè®¢å•è¡¨100ä¸‡æ¡è®°å½•æ—¶æœŸ
-- customer_idé€‰æ‹©æ€§ï¼š1/10000 (å¹³å‡æ¯å®¢æˆ·100ä¸ªè®¢å•)
-- æ‰§è¡Œè®¡åˆ’ï¼šcustomer_idç´¢å¼•æ‰«æ + æ—¶é—´è¿‡æ»¤
-- æ‰§è¡Œæ—¶é—´ï¼š10ms

-- åœºæ™¯2ï¼šè®¢å•è¡¨1000ä¸‡æ¡è®°å½•æ—¶æœŸ  
-- customer_idé€‰æ‹©æ€§ï¼š1/10000 (å¹³å‡æ¯å®¢æˆ·1000ä¸ªè®¢å•)
-- ç»Ÿè®¡ä¿¡æ¯æ›´æ–°åï¼Œä¼˜åŒ–å™¨é‡æ–°è¯„ä¼°
-- æ‰§è¡Œè®¡åˆ’ï¼šorder_dateç´¢å¼•æ‰«æ + customer_idè¿‡æ»¤
-- æ‰§è¡Œæ—¶é—´ï¼š2000ms â† è®¡åˆ’å›å½’
```

**ç´¢å¼•å˜åŒ–å¯¼è‡´çš„å›å½’**ï¼š
```sql
-- åŸæœ‰å¤åˆç´¢å¼•
CREATE INDEX idx_order_customer_date ON orders(customer_id, order_date);

-- æŸå¤©DBAé‡å»ºäº†ç´¢å¼•ï¼Œä½†é¡ºåºæ”¹å˜äº†
DROP INDEX idx_order_customer_date ON orders;
CREATE INDEX idx_order_date_customer ON orders(order_date, customer_id);

-- ç»“æœï¼šç›¸åŒæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’å‘ç”Ÿå˜åŒ–
-- åŸè®¡åˆ’ï¼šä½¿ç”¨idx_order_customer_dateï¼Œé«˜æ•ˆ
-- æ–°è®¡åˆ’ï¼šä½¿ç”¨idx_order_date_customerï¼Œå¯èƒ½ä½æ•ˆ
```

### 4.3 å›å½’æ£€æµ‹æ–¹æ³•


**åŸºäºæ€§èƒ½ç›‘æ§çš„å›å½’æ£€æµ‹**ï¼š
```sql
-- æŸ¥çœ‹SQLæ‰§è¡Œæ—¶é—´è¶‹åŠ¿
SELECT 
    sql_id,
    DATE(start_time) as exec_date,
    AVG(duration) as avg_duration,
    MAX(duration) as max_duration,
    COUNT(*) as exec_count
FROM performance_schema.events_statements_history_long 
WHERE sql_text LIKE 'SELECT * FROM orders WHERE customer_id%'
GROUP BY sql_id, DATE(start_time)
ORDER BY exec_date;

-- ç»“æœåˆ†æï¼š
-- 2025-09-01: avg_duration=10ms   â† æ­£å¸¸
-- 2025-09-02: avg_duration=12ms   â† æ­£å¸¸
-- 2025-09-03: avg_duration=2000ms â† æ£€æµ‹åˆ°å›å½’
```

**åŸºäºæ‰§è¡Œè®¡åˆ’çš„å›å½’æ£€æµ‹**ï¼š
```sql
-- ç›‘æ§æ‰§è¡Œè®¡åˆ’å˜åŒ–
-- å¯ä»¥é€šè¿‡å®šæœŸæ‰§è¡ŒEXPLAINå¹¶æ¯”è¾ƒç»“æœ

-- å»ºç«‹è®¡åˆ’åŸºçº¿è¡¨
CREATE TABLE plan_baseline (
    sql_hash VARCHAR(64),
    plan_hash VARCHAR(64), 
    execution_plan TEXT,
    avg_cost DECIMAL(10,2),
    create_time TIMESTAMP
);

-- æ£€æµ‹è®¡åˆ’å˜åŒ–
SELECT 
    sql_hash,
    COUNT(DISTINCT plan_hash) as plan_count,
    GROUP_CONCAT(DISTINCT plan_hash) as all_plans
FROM plan_baseline 
GROUP BY sql_hash
HAVING plan_count > 1;
```

### 4.4 å›å½’å½±å“è¯„ä¼°


**å›å½’ä¸¥é‡ç¨‹åº¦åˆ†çº§**ï¼š

```
å›å½’ç­‰çº§åˆ†ç±»ï¼š
ğŸ”´ ä¸¥é‡å›å½’ (Critical)ï¼š
â”œâ”€ æ€§èƒ½ä¸‹é™ > 10å€
â”œâ”€ æ‰§è¡Œæ—¶é—´ > 10ç§’
â”œâ”€ å½±å“æ ¸å¿ƒä¸šåŠ¡æµç¨‹
â””â”€ éœ€è¦ç«‹å³å¤„ç†

ğŸŸ¡ ä¸­ç­‰å›å½’ (Major)ï¼š
â”œâ”€ æ€§èƒ½ä¸‹é™ 3-10å€
â”œâ”€ æ‰§è¡Œæ—¶é—´ 1-10ç§’  
â”œâ”€ å½±å“ç”¨æˆ·ä½“éªŒ
â””â”€ éœ€è¦å°½å¿«å¤„ç†

ğŸŸ¢ è½»å¾®å›å½’ (Minor)ï¼š
â”œâ”€ æ€§èƒ½ä¸‹é™ 1-3å€
â”œâ”€ æ‰§è¡Œæ—¶é—´ < 1ç§’
â”œâ”€ å½±å“æœ‰é™
â””â”€ å¯ä»¥è®¡åˆ’å¤„ç†
```

---

## 5. ğŸ”’ è®¡åˆ’å›ºå®šæŠ€æœ¯å®è·µ


### 5.1 è®¡åˆ’å›ºå®šçš„åŸºæœ¬æ¦‚å¿µ


**è®¡åˆ’å›ºå®šï¼ˆPlan Stabilizationï¼‰**ï¼šé€šè¿‡æŠ€æœ¯æ‰‹æ®µå¼ºåˆ¶MySQLä½¿ç”¨æŒ‡å®šçš„æ‰§è¡Œè®¡åˆ’ï¼Œé¿å…ä¼˜åŒ–å™¨è‡ªåŠ¨é€‰æ‹©å¯¼è‡´çš„è®¡åˆ’æ³¢åŠ¨ã€‚

```
è®¡åˆ’å›ºå®šçš„æ ¸å¿ƒæ€æƒ³ï¼š
äººå·¥ç»éªŒ + æµ‹è¯•éªŒè¯ > ä¼˜åŒ–å™¨è‡ªåŠ¨é€‰æ‹©
     â†“
å›ºå®šä½¿ç”¨å·²éªŒè¯çš„é«˜æ•ˆæ‰§è¡Œè®¡åˆ’
     â†“  
é¿å…å› ç¯å¢ƒå˜åŒ–å¯¼è‡´çš„è®¡åˆ’å›å½’
```

### 5.2 åŸºäºHintçš„è®¡åˆ’å›ºå®š


**ä½¿ç”¨ç´¢å¼•æç¤ºå¼ºåˆ¶æ‰§è¡Œè®¡åˆ’**ï¼š
```sql
-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•
SELECT /*+ USE_INDEX(orders, idx_customer_date) */ 
       order_id, amount 
FROM orders 
WHERE customer_id = 12345 AND order_date > '2025-01-01';

-- å¼ºåˆ¶å¿½ç•¥æŸä¸ªç´¢å¼•
SELECT /*+ IGNORE_INDEX(orders, idx_status) */
       order_id, amount
FROM orders  
WHERE customer_id = 12345 AND status = 'completed';

-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šè¿æ¥æ–¹å¼
SELECT /*+ USE_NL(o, c) */ 
       o.order_id, c.customer_name
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id;
```

**è¿æ¥é¡ºåºæ§åˆ¶**ï¼š
```sql
-- æ§åˆ¶è¡¨è¿æ¥é¡ºåº
SELECT /*+ STRAIGHT_JOIN */
       o.order_id, c.customer_name, p.product_name
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id  
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE c.region = 'North';

-- è§£é‡Šï¼šå¼ºåˆ¶æŒ‰ç…§FROMå­å¥ä¸­çš„è¡¨é¡ºåºè¿›è¡Œè¿æ¥
-- customers â†’ orders â†’ order_items â†’ products
```

### 5.3 åŸºäºå­˜å‚¨è¿‡ç¨‹çš„è®¡åˆ’å›ºå®š


**é€šè¿‡å­˜å‚¨è¿‡ç¨‹å°è£…ä¼˜åŒ–çš„æ‰§è¡Œé€»è¾‘**ï¼š
```sql
-- åˆ›å»ºä¼˜åŒ–çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE GetCustomerOrders(
    IN p_customer_id INT,
    IN p_start_date DATE
)
BEGIN
    -- ä½¿ç”¨ç»è¿‡ä¼˜åŒ–æµ‹è¯•çš„æŸ¥è¯¢é€»è¾‘
    SELECT /*+ USE_INDEX(orders, idx_customer_date) */
           order_id, 
           order_date,
           total_amount
    FROM orders 
    WHERE customer_id = p_customer_id 
      AND order_date >= p_start_date
    ORDER BY order_date DESC;
END //
DELIMITER ;

-- åº”ç”¨ç¨‹åºè°ƒç”¨å­˜å‚¨è¿‡ç¨‹è€Œä¸æ˜¯ç›´æ¥SQL
CALL GetCustomerOrders(12345, '2025-01-01');
```

### 5.4 åº”ç”¨å±‚è®¡åˆ’å›ºå®šç­–ç•¥


**åº”ç”¨ä»£ç ä¸­çš„æ‰§è¡Œè®¡åˆ’æ§åˆ¶**ï¼š
```java
// Javaåº”ç”¨ç¤ºä¾‹ï¼šæ ¹æ®æ•°æ®ç‰¹å¾é€‰æ‹©ä¸åŒçš„SQL
public class OrderQueryService {
    
    public List<Order> getCustomerOrders(int customerId, Date startDate) {
        // æ ¹æ®å®¢æˆ·ç±»å‹é€‰æ‹©ä¸åŒçš„æŸ¥è¯¢ç­–ç•¥
        CustomerType type = getCustomerType(customerId);
        
        String sql;
        if (type == CustomerType.VIP) {
            // VIPå®¢æˆ·è®¢å•å°‘ï¼Œä½¿ç”¨å®¢æˆ·IDç´¢å¼•
            sql = "SELECT /*+ USE_INDEX(orders, idx_customer_date) */ " +
                  "order_id, order_date, amount FROM orders " +
                  "WHERE customer_id = ? AND order_date >= ?";
        } else {
            // æ™®é€šå®¢æˆ·è®¢å•å¤šï¼Œä½¿ç”¨æ—¥æœŸç´¢å¼•  
            sql = "SELECT /*+ USE_INDEX(orders, idx_date_customer) */ " +
                  "order_id, order_date, amount FROM orders " +
                  "WHERE order_date >= ? AND customer_id = ?";
        }
        
        return executeQuery(sql, customerId, startDate);
    }
}
```

---

## 6. ğŸ›¡ï¸ SPMè®¡åˆ’ç®¡ç†æœºåˆ¶


### 6.1 SPMæ¦‚å¿µä»‹ç»


**SPMï¼ˆSQL Plan Managementï¼‰**ï¼šä¸€å¥—ç³»ç»ŸåŒ–çš„æ‰§è¡Œè®¡åˆ’ç®¡ç†æœºåˆ¶ï¼Œç”¨äºç¡®ä¿SQLè¯­å¥ä½¿ç”¨ç»è¿‡éªŒè¯çš„ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ã€‚

> ğŸ“ **æ³¨æ„**ï¼šMySQLæœ¬èº«ä¸æä¾›å®Œæ•´çš„SPMåŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å¯ä»¥å€Ÿé‰´å…¶ä»–æ•°æ®åº“ï¼ˆå¦‚Oracleï¼‰çš„SPMæ¦‚å¿µï¼Œæ„å»ºç±»ä¼¼çš„ç®¡ç†æœºåˆ¶ã€‚

```
SPMçš„æ ¸å¿ƒç»„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¡åˆ’æ•è· (Plan Capture)                  â”‚
â”‚ â”œâ”€ è‡ªåŠ¨æ•è·æ‰§è¡Œè®¡åˆ’                      â”‚
â”‚ â””â”€ æ‰‹åŠ¨æ·»åŠ åŸºçº¿è®¡åˆ’                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¡åˆ’åŸºçº¿ (Plan Baseline)                â”‚  
â”‚ â”œâ”€ å­˜å‚¨å·²éªŒè¯çš„æ‰§è¡Œè®¡åˆ’                  â”‚
â”‚ â””â”€ è®°å½•è®¡åˆ’æ€§èƒ½æŒ‡æ ‡                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è®¡åˆ’æ¼”è¿› (Plan Evolution)               â”‚
â”‚ â”œâ”€ è¯„ä¼°æ–°è®¡åˆ’çš„æ€§èƒ½                      â”‚
â”‚ â””â”€ å®‰å…¨åœ°é‡‡ç”¨æ›´å¥½çš„è®¡åˆ’                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è®¡åˆ’æ•è·æœºåˆ¶è®¾è®¡


**è‡ªåŠ¨è®¡åˆ’æ•è·çš„å®ç°æ€è·¯**ï¼š
```sql
-- åˆ›å»ºè®¡åˆ’æ•è·è¡¨
CREATE TABLE sql_plan_capture (
    sql_id VARCHAR(64) NOT NULL,
    sql_text TEXT NOT NULL,
    plan_hash VARCHAR(64) NOT NULL,
    execution_plan JSON NOT NULL,
    first_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    execution_count INT DEFAULT 1,
    avg_execution_time DECIMAL(10,3),
    min_execution_time DECIMAL(10,3),
    max_execution_time DECIMAL(10,3),
    INDEX idx_sql_id (sql_id),
    INDEX idx_plan_hash (plan_hash)
);

-- è‡ªåŠ¨æ•è·è§¦å‘å™¨ï¼ˆæ¦‚å¿µæ€§å®ç°ï¼‰
-- å®é™…éœ€è¦é€šè¿‡åº”ç”¨ç¨‹åºæˆ–ç›‘æ§å·¥å…·å®ç°
INSERT INTO sql_plan_capture (sql_id, sql_text, plan_hash, execution_plan)
SELECT 
    SHA2(sql_text, 256) as sql_id,
    sql_text,
    SHA2(explain_output, 256) as plan_hash,
    JSON_OBJECT('plan', explain_output) as execution_plan
FROM performance_schema.events_statements_current
WHERE execution_count > 10; -- åªæ•è·æ‰§è¡Œé¢‘ç¹çš„SQL
```

### 6.3 è®¡åˆ’åŸºçº¿ç®¡ç†


**å»ºç«‹å’Œç»´æŠ¤è®¡åˆ’åŸºçº¿**ï¼š
```sql
-- è®¡åˆ’åŸºçº¿è¡¨è®¾è®¡
CREATE TABLE sql_plan_baseline (
    baseline_id VARCHAR(64) PRIMARY KEY,
    sql_id VARCHAR(64) NOT NULL,
    plan_hash VARCHAR(64) NOT NULL,
    plan_name VARCHAR(100),
    execution_plan JSON NOT NULL,
    is_enabled BOOLEAN DEFAULT TRUE,
    is_accepted BOOLEAN DEFAULT FALSE,
    is_reproducible BOOLEAN DEFAULT TRUE,
    performance_baseline JSON,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_verified TIMESTAMP,
    notes TEXT,
    INDEX idx_sql_id (sql_id),
    INDEX idx_enabled (is_enabled, is_accepted)
);

-- æ·»åŠ åŸºçº¿è®¡åˆ’
INSERT INTO sql_plan_baseline (
    baseline_id, sql_id, plan_hash, plan_name, 
    execution_plan, is_accepted, performance_baseline
) VALUES (
    'baseline_001',
    'sql_12345',
    'plan_abc123', 
    'customer_orders_index_scan',
    JSON_OBJECT('steps', [
        {'step': 1, 'operation': 'INDEX_SCAN', 'object': 'idx_customer_date'},
        {'step': 2, 'operation': 'TABLE_ACCESS', 'object': 'orders'}
    ]),
    TRUE,
    JSON_OBJECT('avg_time', 15.5, 'max_time', 89.2, 'cpu_cost', 120)
);
```

### 6.4 è®¡åˆ’ä½¿ç”¨æ§åˆ¶


**åŸºäºåŸºçº¿çš„è®¡åˆ’é€‰æ‹©é€»è¾‘**ï¼š
```java
// è®¡åˆ’ç®¡ç†æœåŠ¡ç¤ºä¾‹
public class SQLPlanManager {
    
    public String getOptimalSQL(String originalSQL) {
        // 1. è®¡ç®—SQLæ ‡è¯†
        String sqlId = calculateSQLId(originalSQL);
        
        // 2. æŸ¥æ‰¾å·²æ¥å—çš„åŸºçº¿è®¡åˆ’
        PlanBaseline baseline = findAcceptedBaseline(sqlId);
        
        if (baseline != null && baseline.isEnabled()) {
            // 3. ä½¿ç”¨åŸºçº¿è®¡åˆ’çš„æç¤º
            return addPlanHints(originalSQL, baseline.getExecutionPlan());
        } else {
            // 4. è®°å½•æ–°è®¡åˆ’ç”¨äºåç»­åˆ†æ
            captureNewPlan(sqlId, originalSQL);
            return originalSQL;
        }
    }
    
    private String addPlanHints(String sql, ExecutionPlan plan) {
        // æ ¹æ®æ‰§è¡Œè®¡åˆ’æ·»åŠ ç›¸åº”çš„hints
        StringBuilder hintedSQL = new StringBuilder();
        hintedSQL.append("SELECT /*+ ");
        
        for (PlanStep step : plan.getSteps()) {
            if (step.getOperation().equals("INDEX_SCAN")) {
                hintedSQL.append("USE_INDEX(").append(step.getObject()).append(") ");
            }
        }
        
        hintedSQL.append("*/ ");
        hintedSQL.append(sql.substring(sql.indexOf("SELECT") + 6));
        
        return hintedSQL.toString();
    }
}
```

---

## 7. ğŸ“ è®¡åˆ’åŸºçº¿å»ºç«‹ç­–ç•¥


### 7.1 åŸºçº¿å»ºç«‹çš„æ—¶æœºé€‰æ‹©


**åˆé€‚çš„åŸºçº¿å»ºç«‹æ—¶æœº**ï¼š

```
åŸºçº¿å»ºç«‹æ—¶æœºåˆ¤æ–­ï¼š
â”œâ”€ ç³»ç»Ÿç¨³å®šæœŸï¼šæ•°æ®åˆ†å¸ƒç›¸å¯¹ç¨³å®šï¼Œè´Ÿè½½æ­£å¸¸
â”œâ”€ æ€§èƒ½æµ‹è¯•æœŸï¼šç»è¿‡å……åˆ†çš„æ€§èƒ½æµ‹è¯•éªŒè¯
â”œâ”€ ä¸šåŠ¡ä½å³°æœŸï¼šé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡è¿è¡Œ
â””â”€ ç‰ˆæœ¬å‘å¸ƒå‰ï¼šæ–°åŠŸèƒ½ä¸Šçº¿å‰å»ºç«‹åŸºçº¿

é¿å…çš„æ—¶æœºï¼š
â”œâ”€ æ•°æ®è¿ç§»æœŸï¼šæ•°æ®åˆ†å¸ƒå¼‚å¸¸
â”œâ”€ é«˜å¹¶å‘æœŸï¼šç³»ç»Ÿè´Ÿè½½è¿‡é«˜ï¼Œæµ‹è¯•ç»“æœä¸å‡†ç¡®
â”œâ”€ ç»Ÿè®¡ä¿¡æ¯æ›´æ–°æœŸï¼šç»Ÿè®¡ä¿¡æ¯ä¸ç¨³å®š
â””â”€ ç³»ç»Ÿæ•…éšœæœŸï¼šç¡¬ä»¶æˆ–ç½‘ç»œå¼‚å¸¸
```

### 7.2 åŸºçº¿è®¡åˆ’çš„è¯„ä¼°æ ‡å‡†


**è®¡åˆ’è´¨é‡è¯„ä¼°ç»´åº¦**ï¼š

```sql
-- è®¡åˆ’è¯„ä¼°æŒ‡æ ‡è¡¨
CREATE TABLE plan_evaluation_metrics (
    plan_id VARCHAR(64),
    metric_name VARCHAR(50),
    metric_value DECIMAL(15,6),
    measurement_time TIMESTAMP,
    INDEX idx_plan_metrics (plan_id, metric_name)
);

-- æ€§èƒ½æŒ‡æ ‡æ”¶é›†
INSERT INTO plan_evaluation_metrics VALUES
('plan_001', 'avg_execution_time', 45.230, NOW()),
('plan_001', 'max_execution_time', 156.800, NOW()),  
('plan_001', 'cpu_usage_percent', 12.5, NOW()),
('plan_001', 'io_read_count', 245, NOW()),
('plan_001', 'buffer_gets', 1205, NOW()),
('plan_001', 'rows_examined', 2847, NOW()),
('plan_001', 'rows_returned', 156, NOW());
```

**ç»¼åˆè¯„åˆ†ç®—æ³•**ï¼š
```java
public class PlanEvaluator {
    
    public double calculatePlanScore(PlanMetrics metrics) {
        // åŠ æƒè¯„åˆ†ç®—æ³•
        double timeScore = calculateTimeScore(metrics.getAvgExecutionTime());
        double resourceScore = calculateResourceScore(metrics.getCpuUsage(), metrics.getIoReads());
        double efficiencyScore = calculateEfficiencyScore(
            metrics.getRowsExamined(), metrics.getRowsReturned()
        );
        
        // æƒé‡åˆ†é…ï¼šæ—¶é—´50%ï¼Œèµ„æº30%ï¼Œæ•ˆç‡20%
        return timeScore * 0.5 + resourceScore * 0.3 + efficiencyScore * 0.2;
    }
    
    private double calculateTimeScore(double avgTime) {
        // æ—¶é—´è¯„åˆ†ï¼šè¶Šå¿«åˆ†æ•°è¶Šé«˜
        if (avgTime <= 10) return 100.0;        // 10msä»¥å†…æ»¡åˆ†
        if (avgTime <= 100) return 90.0;        // 100msä»¥å†…90åˆ†
        if (avgTime <= 1000) return 70.0;       // 1sä»¥å†…70åˆ†
        return Math.max(0, 70 - (avgTime - 1000) / 100); // è¶…è¿‡1sé€’å‡
    }
}
```

### 7.3 åŸºçº¿ç‰ˆæœ¬ç®¡ç†


**åŸºçº¿çš„ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥**ï¼š
```sql
-- åŸºçº¿ç‰ˆæœ¬ç®¡ç†è¡¨
CREATE TABLE plan_baseline_versions (
    baseline_id VARCHAR(64),
    version_number INT,
    plan_hash VARCHAR(64),
    execution_plan JSON,
    performance_metrics JSON,
    is_active BOOLEAN DEFAULT FALSE,
    created_by VARCHAR(50),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    activation_time TIMESTAMP NULL,
    deactivation_time TIMESTAMP NULL,
    change_reason TEXT,
    PRIMARY KEY (baseline_id, version_number),
    INDEX idx_active (baseline_id, is_active)
);

-- ç‰ˆæœ¬å‡çº§æµç¨‹
-- 1. åˆ›å»ºæ–°ç‰ˆæœ¬
INSERT INTO plan_baseline_versions (
    baseline_id, version_number, plan_hash, execution_plan,
    performance_metrics, created_by, change_reason
) VALUES (
    'baseline_001', 2, 'new_plan_hash', 
    JSON_OBJECT('new_plan', 'details'),
    JSON_OBJECT('improved_metrics', 'values'),
    'dba_user', 'æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘ç´¢å¼•æ‰«æèŒƒå›´'
);

-- 2. æ¿€æ´»æ–°ç‰ˆæœ¬
UPDATE plan_baseline_versions 
SET is_active = FALSE, deactivation_time = NOW() 
WHERE baseline_id = 'baseline_001' AND is_active = TRUE;

UPDATE plan_baseline_versions 
SET is_active = TRUE, activation_time = NOW()
WHERE baseline_id = 'baseline_001' AND version_number = 2;
```

### 7.4 åŸºçº¿è‡ªåŠ¨åŒ–ç®¡ç†


**è‡ªåŠ¨åŒ–åŸºçº¿ç®¡ç†æµç¨‹**ï¼š
```python
# Pythonç¤ºä¾‹ï¼šè‡ªåŠ¨åŒ–åŸºçº¿ç®¡ç†è„šæœ¬
class BaselineManager:
    
    def __init__(self, db_connection):
        self.db = db_connection
        
    def daily_baseline_maintenance(self):
        """æ¯æ—¥åŸºçº¿ç»´æŠ¤ä»»åŠ¡"""
        
        # 1. æ£€æŸ¥åŸºçº¿æ€§èƒ½é€€åŒ–
        degraded_baselines = self.check_performance_degradation()
        
        # 2. å‘ç°æ€§èƒ½æ›´å¥½çš„æ–°è®¡åˆ’
        better_plans = self.discover_better_plans()
        
        # 3. è‡ªåŠ¨éªŒè¯å’Œé‡‡ç”¨
        for plan in better_plans:
            if self.validate_new_plan(plan):
                self.create_baseline_version(plan)
                
        # 4. æ¸…ç†è¿‡æœŸåŸºçº¿
        self.cleanup_expired_baselines()
        
    def check_performance_degradation(self):
        """æ£€æŸ¥åŸºçº¿æ€§èƒ½æ˜¯å¦é€€åŒ–"""
        query = """
        SELECT b.baseline_id, b.performance_baseline,
               AVG(current_metrics.avg_time) as current_avg_time
        FROM plan_baseline_versions b
        JOIN recent_execution_metrics current_metrics 
          ON b.plan_hash = current_metrics.plan_hash
        WHERE b.is_active = TRUE
          AND current_metrics.execution_date >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        GROUP BY b.baseline_id
        HAVING current_avg_time > JSON_EXTRACT(b.performance_baseline, '$.avg_time') * 1.5
        """
        return self.db.execute(query)
```

---

## 8. âš¡ è®¡åˆ’æ¼”è¿›æ§åˆ¶æ–¹æ³•


### 8.1 å®‰å…¨çš„è®¡åˆ’æ¼”è¿›ç­–ç•¥


**è®¡åˆ’æ¼”è¿›çš„åŸºæœ¬åŸåˆ™**ï¼š

```
è®¡åˆ’æ¼”è¿›å®‰å…¨ç­–ç•¥ï¼š
â”œâ”€ æ¸è¿›å¼æ¼”è¿›ï¼šå°æ­¥å¿«è·‘ï¼Œé€æ­¥éªŒè¯
â”œâ”€ å¯å›æ»šæœºåˆ¶ï¼šéšæ—¶èƒ½å›åˆ°ä¹‹å‰çš„ç¨³å®šçŠ¶æ€  
â”œâ”€ å½±å“èŒƒå›´æ§åˆ¶ï¼šé™åˆ¶åœ¨ç‰¹å®šç¯å¢ƒæˆ–ç”¨æˆ·èŒƒå›´
â””â”€ æ€§èƒ½ç›‘æ§ï¼šå®æ—¶ç›‘æ§æ¼”è¿›è¿‡ç¨‹ä¸­çš„æ€§èƒ½è¡¨ç°
```

### 8.2 A/Bæµ‹è¯•åœ¨è®¡åˆ’æ¼”è¿›ä¸­çš„åº”ç”¨


**åŸºäºæµé‡åˆ†å‰²çš„è®¡åˆ’æµ‹è¯•**ï¼š
```java
// è®¡åˆ’A/Bæµ‹è¯•å®ç°
public class PlanABTester {
    
    private Random random = new Random();
    
    public String selectExecutionPlan(String sqlId, String originalSQL) {
        // è·å–å½“å‰åŸºçº¿è®¡åˆ’å’Œå€™é€‰è®¡åˆ’
        PlanBaseline currentBaseline = getCurrentBaseline(sqlId);
        PlanCandidate newCandidate = getNewCandidate(sqlId);
        
        if (newCandidate != null && newCandidate.isInTesting()) {
            // A/Bæµ‹è¯•ï¼š90%ä½¿ç”¨åŸºçº¿è®¡åˆ’ï¼Œ10%ä½¿ç”¨æ–°è®¡åˆ’
            double testRatio = newCandidate.getTestTrafficRatio(); // 0.1
            
            if (random.nextDouble() < testRatio) {
                // ä½¿ç”¨æ–°è®¡åˆ’å¹¶è®°å½•æ€§èƒ½
                recordPlanUsage(sqlId, newCandidate.getPlanHash(), "test_group");
                return addPlanHints(originalSQL, newCandidate.getExecutionPlan());
            }
        }
        
        // ä½¿ç”¨åŸºçº¿è®¡åˆ’
        recordPlanUsage(sqlId, currentBaseline.getPlanHash(), "control_group");
        return addPlanHints(originalSQL, currentBaseline.getExecutionPlan());
    }
}
```

**A/Bæµ‹è¯•ç»“æœåˆ†æ**ï¼š
```sql
-- A/Bæµ‹è¯•æ€§èƒ½å¯¹æ¯”åˆ†æ
SELECT 
    plan_group,
    COUNT(*) as execution_count,
    AVG(execution_time) as avg_time,
    STDDEV(execution_time) as time_stddev,
    MIN(execution_time) as min_time,
    MAX(execution_time) as max_time,
    PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time) as p95_time
FROM plan_execution_log 
WHERE sql_id = 'target_sql_123' 
  AND test_start_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY plan_group;

-- ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒï¼ˆæ¦‚å¿µæ€§ï¼‰
-- ç»“æœç¤ºä¾‹ï¼š
-- control_group: avg_time=25ms, stddev=5ms, count=9000
-- test_group:    avg_time=18ms, stddev=4ms, count=1000
-- ç»“è®ºï¼šæ–°è®¡åˆ’æ€§èƒ½æ˜¾è‘—æ›´å¥½ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨
```

### 8.3 è®¡åˆ’æ¼”è¿›çš„é£é™©æ§åˆ¶


**è‡ªåŠ¨å›æ»šæœºåˆ¶**ï¼š
```python
class PlanEvolutionController:
    
    def __init__(self):
        self.risk_thresholds = {
            'max_execution_time': 5000,  # 5ç§’
            'error_rate': 0.01,          # 1%é”™è¯¯ç‡
            'performance_degradation': 2.0  # æ€§èƒ½ä¸‹é™2å€
        }
    
    def monitor_plan_evolution(self, sql_id, new_plan_hash):
        """ç›‘æ§è®¡åˆ’æ¼”è¿›è¿‡ç¨‹"""
        
        # æ”¶é›†æœ€è¿‘çš„æ‰§è¡ŒæŒ‡æ ‡
        recent_metrics = self.collect_recent_metrics(sql_id, new_plan_hash)
        
        # é£é™©è¯„ä¼°
        risk_level = self.assess_risk(recent_metrics)
        
        if risk_level == 'HIGH':
            # ç«‹å³å›æ»šåˆ°åŸºçº¿è®¡åˆ’
            self.rollback_to_baseline(sql_id)
            self.send_alert(f"è®¡åˆ’æ¼”è¿›é£é™©è¿‡é«˜ï¼Œå·²è‡ªåŠ¨å›æ»š: {sql_id}")
            
        elif risk_level == 'MEDIUM':
            # å‡å°‘æ–°è®¡åˆ’çš„æµé‡æ¯”ä¾‹
            self.reduce_test_traffic(sql_id, new_plan_hash)
            
    def assess_risk(self, metrics):
        """è¯„ä¼°æ¼”è¿›é£é™©"""
        
        # æ£€æŸ¥æ‰§è¡Œæ—¶é—´å¼‚å¸¸
        if metrics.max_execution_time > self.risk_thresholds['max_execution_time']:
            return 'HIGH'
            
        # æ£€æŸ¥é”™è¯¯ç‡
        if metrics.error_rate > self.risk_thresholds['error_rate']:
            return 'HIGH'
            
        # æ£€æŸ¥æ€§èƒ½é€€åŒ–
        baseline_avg = metrics.baseline_avg_time
        current_avg = metrics.current_avg_time
        if current_avg > baseline_avg * self.risk_thresholds['performance_degradation']:
            return 'MEDIUM'
            
        return 'LOW'
```

### 8.4 è®¡åˆ’æ¼”è¿›çš„è‡ªåŠ¨åŒ–å†³ç­–


**åŸºäºæœºå™¨å­¦ä¹ çš„æ¼”è¿›å†³ç­–**ï¼š
```python
# æ¦‚å¿µæ€§çš„MLæ¨¡å‹ç”¨äºè®¡åˆ’æ¼”è¿›å†³ç­–
class PlanEvolutionMLModel:
    
    def __init__(self):
        self.model = self.load_trained_model()
        
    def should_evolve_plan(self, sql_features, current_performance, candidate_performance):
        """åŸºäºMLæ¨¡å‹å†³å®šæ˜¯å¦æ¼”è¿›è®¡åˆ’"""
        
        # ç‰¹å¾å·¥ç¨‹
        features = self.extract_features(
            sql_features,           # SQLç‰¹å¾ï¼šå¤æ‚åº¦ã€è¡¨æ•°é‡ç­‰
            current_performance,    # å½“å‰æ€§èƒ½æŒ‡æ ‡
            candidate_performance,  # å€™é€‰è®¡åˆ’æ€§èƒ½
            self.get_system_state() # ç³»ç»ŸçŠ¶æ€ï¼šè´Ÿè½½ã€æ—¶é—´ç­‰
        )
        
        # æ¨¡å‹é¢„æµ‹
        evolution_probability = self.model.predict_proba(features)[0][1]
        confidence_score = self.model.predict_confidence(features)
        
        # å†³ç­–é€»è¾‘
        if evolution_probability > 0.8 and confidence_score > 0.9:
            return {'decision': 'EVOLVE', 'confidence': confidence_score}
        elif evolution_probability > 0.6 and confidence_score > 0.7:
            return {'decision': 'TEST', 'test_ratio': 0.05}  # å°æµé‡æµ‹è¯•
        else:
            return {'decision': 'KEEP_CURRENT', 'reason': 'Low confidence'}
            
    def extract_features(self, sql_features, current_perf, candidate_perf, system_state):
        """ç‰¹å¾æå–"""
        return {
            'sql_complexity': sql_features.get('join_count', 0),
            'table_count': sql_features.get('table_count', 0),
            'performance_improvement': candidate_perf.avg_time / current_perf.avg_time,
            'stability_score': 1.0 / (current_perf.stddev + 0.1),
            'system_load': system_state.get('cpu_usage', 0),
            'time_of_day': system_state.get('hour', 0)
        }
```

---

## 9. ğŸ“Š ç¨³å®šæ€§ç›‘æ§å‘Šè­¦ä½“ç³»


### 9.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»è®¾è®¡


**æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§ç›‘æ§çš„å…³é”®æŒ‡æ ‡**ï¼š

```
ç›‘æ§æŒ‡æ ‡åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€§èƒ½æŒ‡æ ‡ (Performance Metrics)           â”‚
â”‚ â”œâ”€ å¹³å‡æ‰§è¡Œæ—¶é—´ (Average Execution Time) â”‚
â”‚ â”œâ”€ 95åˆ†ä½æ‰§è¡Œæ—¶é—´ (P95 Execution Time)   â”‚
â”‚ â”œâ”€ æœ€å¤§æ‰§è¡Œæ—¶é—´ (Max Execution Time)     â”‚
â”‚ â””â”€ æ‰§è¡Œæ—¶é—´æ ‡å‡†å·® (Time Standard Deviation) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¨³å®šæ€§æŒ‡æ ‡ (Stability Metrics)          â”‚
â”‚ â”œâ”€ è®¡åˆ’å˜æ›´é¢‘ç‡ (Plan Change Rate)       â”‚
â”‚ â”œâ”€ è®¡åˆ’å“ˆå¸Œå¤šæ ·æ€§ (Plan Hash Diversity)  â”‚  
â”‚ â”œâ”€ æ€§èƒ½æ³¢åŠ¨ç³»æ•° (Performance CV)         â”‚
â”‚ â””â”€ è®¡åˆ’å›å½’æ¬¡æ•° (Regression Count)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸šåŠ¡æŒ‡æ ‡ (Business Metrics)             â”‚
â”‚ â”œâ”€ æŸ¥è¯¢æˆåŠŸç‡ (Query Success Rate)       â”‚
â”‚ â”œâ”€ è¶…æ—¶æŸ¥è¯¢æ¯”ä¾‹ (Timeout Rate)           â”‚
â”‚ â”œâ”€ ç”¨æˆ·æŠ•è¯‰æ•°é‡ (User Complaints)        â”‚
â”‚ â””â”€ ä¸šåŠ¡å½±å“èŒƒå›´ (Business Impact Scope)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 å®æ—¶ç›‘æ§ç³»ç»Ÿæ¶æ„


**ç›‘æ§ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„**ï¼š
```
æ•°æ®é‡‡é›†å±‚ï¼š
MySQL Performance Schema â”€â”€â”€â”€â”
                            â”œâ”€â†’ æ•°æ®å¤„ç†å±‚ â”€â”€â†’ å‘Šè­¦å¼•æ“ â”€â”€â†’ é€šçŸ¥ç³»ç»Ÿ
åº”ç”¨ç¨‹åºæ—¥å¿— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â†“                â†“
                            â””â”€â†’ å­˜å‚¨å±‚ â”€â”€â”€â”€â”€â†’ å¯è§†åŒ–å±‚ â”€â”€â†’ è¿ç»´å¹³å°
```

**ç›‘æ§æ•°æ®é‡‡é›†å®ç°**ï¼š
```sql
-- åˆ›å»ºç›‘æ§æ•°æ®è¡¨
CREATE TABLE query_execution_monitor (
    monitor_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    sql_id VARCHAR(64) NOT NULL,
    sql_text_hash VARCHAR(64),
    plan_hash VARCHAR(64),
    execution_time DECIMAL(10,3),
    rows_examined BIGINT,
    rows_returned BIGINT,
    cpu_time DECIMAL(10,3),
    io_wait_time DECIMAL(10,3),
    lock_wait_time DECIMAL(10,3),
    execution_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(64),
    user_name VARCHAR(64),
    client_ip VARCHAR(45),
    INDEX idx_sql_timestamp (sql_id, execution_timestamp),
    INDEX idx_execution_time (execution_timestamp)
);

-- å®æ—¶ç›‘æ§è§†å›¾
CREATE VIEW real_time_performance AS
SELECT 
    sql_id,
    COUNT(*) as execution_count,
    AVG(execution_time) as avg_execution_time,
    MAX(execution_time) as max_execution_time,
    STDDEV(execution_time) as time_stddev,
    COUNT(DISTINCT plan_hash) as plan_diversity,
    DATE_FORMAT(execution_timestamp, '%Y-%m-%d %H:%i') as time_window
FROM query_execution_monitor 
WHERE execution_timestamp >= DATE_SUB(NOW(), INTERVAL 10 MINUTE)
GROUP BY sql_id, DATE_FORMAT(execution_timestamp, '%Y-%m-%d %H:%i');
```

### 9.3 å‘Šè­¦è§„åˆ™é…ç½®


**å¤šå±‚æ¬¡å‘Šè­¦è§„åˆ™è®¾è®¡**ï¼š
```yaml
# å‘Šè­¦è§„åˆ™é…ç½®æ–‡ä»¶
alert_rules:
  
  # æ€§èƒ½å›å½’å‘Šè­¦
  performance_regression:
    metric: avg_execution_time
    condition: current_value > baseline_value * 3
    window: 5_minutes
    threshold_count: 3
    severity: critical
    message: "SQLæ€§èƒ½å›å½’æ£€æµ‹: {{sql_id}} æ‰§è¡Œæ—¶é—´å¢åŠ {{improvement_ratio}}å€"
    
  # è®¡åˆ’é¢‘ç¹å˜æ›´å‘Šè­¦  
  plan_instability:
    metric: plan_diversity
    condition: value > 3
    window: 30_minutes
    severity: warning
    message: "æ‰§è¡Œè®¡åˆ’ä¸ç¨³å®š: {{sql_id}} åœ¨30åˆ†é’Ÿå†…ä½¿ç”¨äº†{{plan_count}}ä¸ªä¸åŒè®¡åˆ’"
    
  # è¶…æ—¶æŸ¥è¯¢å‘Šè­¦
  timeout_queries:
    metric: execution_time
    condition: value > 30000  # 30ç§’
    window: immediate
    severity: critical
    message: "æŸ¥è¯¢è¶…æ—¶: {{sql_id}} æ‰§è¡Œæ—¶é—´{{execution_time}}ms"
    
  # é”™è¯¯ç‡æ¿€å¢å‘Šè­¦
  error_rate_spike:
    metric: error_rate
    condition: value > 0.05   # 5%
    window: 5_minutes  
    severity: major
    message: "SQLé”™è¯¯ç‡æ¿€å¢: {{sql_id}} é”™è¯¯ç‡è¾¾åˆ°{{error_rate}}%"
```

**å‘Šè­¦å¼•æ“å®ç°**ï¼š
```python
class AlertEngine:
    
    def __init__(self, config_file):
        self.rules = self.load_alert_rules(config_file)
        self.baseline_manager = BaselineManager()
        
    def evaluate_alerts(self, monitoring_data):
        """è¯„ä¼°å‘Šè­¦æ¡ä»¶"""
        alerts = []
        
        for sql_id, metrics in monitoring_data.items():
            for rule_name, rule in self.rules.items():
                if self.should_trigger_alert(rule, metrics, sql_id):
                    alert = self.create_alert(rule, metrics, sql_id)
                    alerts.append(alert)
                    
        return alerts
        
    def should_trigger_alert(self, rule, metrics, sql_id):
        """åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦"""
        
        if rule['metric'] == 'avg_execution_time':
            baseline = self.baseline_manager.get_baseline_performance(sql_id)
            current_avg = metrics.get('avg_execution_time', 0)
            
            return current_avg > baseline.avg_time * rule['threshold_multiplier']
            
        elif rule['metric'] == 'plan_diversity':
            return metrics.get('plan_count', 0) > rule['condition']['value']
            
        # ... å…¶ä»–è§„åˆ™åˆ¤æ–­é€»è¾‘
        
    def create_alert(self, rule, metrics, sql_id):
        """åˆ›å»ºå‘Šè­¦å¯¹è±¡"""
        return {
            'alert_id': f"{rule['name']}_{sql_id}_{int(time.time())}",
            'sql_id': sql_id,
            'severity': rule['severity'], 
            'message': rule['message'].format(
                sql_id=sql_id,
                **metrics
            ),
            'timestamp': datetime.now(),
            'rule_name': rule['name'],
            'metrics_snapshot': metrics
        }
```

### 9.4 å‘Šè­¦å¤„ç†å’Œå“åº”


**è‡ªåŠ¨åŒ–å‘Šè­¦å“åº”æµç¨‹**ï¼š
```python
class AlertHandler:
    
    def handle_alert(self, alert):
        """å‘Šè­¦å¤„ç†ä¸»æµç¨‹"""
        
        # 1. å‘Šè­¦å»é‡å’Œèšåˆ
        if self.is_duplicate_alert(alert):
            self.update_alert_count(alert)
            return
            
        # 2. æ ¹æ®ä¸¥é‡ç¨‹åº¦é€‰æ‹©å¤„ç†ç­–ç•¥
        if alert['severity'] == 'critical':
            self.handle_critical_alert(alert)
        elif alert['severity'] == 'major':
            self.handle_major_alert(alert)
        else:
            self.handle_warning_alert(alert)
            
        # 3. è®°å½•å‘Šè­¦å†å²
        self.record_alert_history(alert)
        
    def handle_critical_alert(self, alert):
        """å¤„ç†ä¸¥é‡å‘Šè­¦"""
        
        # ç«‹å³é€šçŸ¥
        self.send_immediate_notification(alert, channels=['sms', 'phone', 'email'])
        
        # å¦‚æœæ˜¯æ€§èƒ½å›å½’ï¼Œå°è¯•è‡ªåŠ¨å›æ»š
        if alert['rule_name'] == 'performance_regression':
            self.attempt_automatic_rollback(alert['sql_id'])
            
        # åˆ›å»ºæ•…éšœå•
        self.create_incident_ticket(alert)
        
    def attempt_automatic_rollback(self, sql_id):
        """å°è¯•è‡ªåŠ¨å›æ»šåˆ°åŸºçº¿è®¡åˆ’"""
        
        try:
            # è·å–æœ€è¿‘çš„ç¨³å®šåŸºçº¿
            baseline = self.baseline_manager.get_latest_stable_baseline(sql_id)
            
            if baseline:
                # æ¿€æ´»åŸºçº¿è®¡åˆ’
                self.plan_manager.activate_baseline(sql_id, baseline.baseline_id)
                
                # è®°å½•å›æ»šæ“ä½œ
                self.log_rollback_action(sql_id, baseline.baseline_id, "automatic")
                
                return True
        except Exception as e:
            self.logger.error(f"è‡ªåŠ¨å›æ»šå¤±è´¥: {sql_id}, é”™è¯¯: {str(e)}")
            
        return False
```

**å‘Šè­¦å¯è§†åŒ–ç•Œé¢**ï¼š
```html
<!-- å‘Šè­¦ç›‘æ§é¢æ¿ -->
<div class="alert-dashboard">
    <!-- å‘Šè­¦æ€»è§ˆ -->
    <div class="alert-summary">
        <div class="metric-card critical">
            <h3>ä¸¥é‡å‘Šè­¦</h3>
            <span class="count">{{critical_count}}</span>
        </div>
        <div class="metric-card major">
            <h3>é‡è¦å‘Šè­¦</h3>
            <span class="count">{{major_count}}</span>
        </div>
        <div class="metric-card warning">
            <h3>è­¦å‘Šå‘Šè­¦</h3>
            <span class="count">{{warning_count}}</span>
        </div>
    </div>
    
    <!-- å‘Šè­¦è¶‹åŠ¿å›¾ -->
    <div class="alert-trend">
        <canvas id="alertTrendChart"></canvas>
    </div>
    
    <!-- æ´»è·ƒå‘Šè­¦åˆ—è¡¨ -->
    <div class="active-alerts">
        <table class="alert-table">
            <thead>
                <tr>
                    <th>å‘Šè­¦æ—¶é—´</th>
                    <th>SQL ID</th>
                    <th>ä¸¥é‡ç¨‹åº¦</th>
                    <th>å‘Šè­¦æ¶ˆæ¯</th>
                    <th>å¤„ç†çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- åŠ¨æ€å¡«å……å‘Šè­¦æ•°æ® -->
            </tbody>
        </table>
    </div>
</div>
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§ï¼šåŒä¸€SQLåœ¨ç›¸ä¼¼æ¡ä»¶ä¸‹åº”ä¿æŒä¸€è‡´çš„é«˜æ•ˆæ‰§è¡Œè®¡åˆ’
ğŸ”¸ è®¡åˆ’æ³¢åŠ¨æ ¹æºï¼šç»Ÿè®¡ä¿¡æ¯å˜åŒ–ã€æ•°æ®åˆ†å¸ƒå˜åŒ–ã€ç³»ç»ŸçŠ¶æ€å˜åŒ–
ğŸ”¸ è®¡åˆ’å›å½’é—®é¢˜ï¼šä»é«˜æ•ˆè®¡åˆ’é€€åŒ–ä¸ºä½æ•ˆè®¡åˆ’çš„æ€§èƒ½ä¸‹é™ç°è±¡
ğŸ”¸ è®¡åˆ’å›ºå®šæŠ€æœ¯ï¼šé€šè¿‡Hintã€å­˜å‚¨è¿‡ç¨‹ç­‰æ‰‹æ®µå¼ºåˆ¶ä½¿ç”¨ç‰¹å®šæ‰§è¡Œè®¡åˆ’
ğŸ”¸ SPMç®¡ç†æœºåˆ¶ï¼šç³»ç»ŸåŒ–çš„è®¡åˆ’æ•è·ã€åŸºçº¿ç®¡ç†ã€æ¼”è¿›æ§åˆ¶
ğŸ”¸ ç›‘æ§å‘Šè­¦ä½“ç³»ï¼šåŠæ—¶å‘ç°å’Œå“åº”æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§é—®é¢˜
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç¨³å®šæ€§ä¸æ€§èƒ½çš„å¹³è¡¡**
```
ç†è§£è¦ç‚¹ï¼š
- è¿‡åº¦è¿½æ±‚ç¨³å®šå¯èƒ½é”™å¤±æ€§èƒ½ä¼˜åŒ–æœºä¼š
- è¿‡åº¦è¿½æ±‚æ€§èƒ½å¯èƒ½å¯¼è‡´è®¡åˆ’é¢‘ç¹å˜åŠ¨
- éœ€è¦åœ¨ç¨³å®šæ€§å’Œé€‚åº”æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹
```

**ğŸ”¹ ç»Ÿè®¡ä¿¡æ¯çš„åŒåˆƒå‰‘æ•ˆåº”**
```
æ­£é¢ä½œç”¨ï¼š
- ä¸ºä¼˜åŒ–å™¨æä¾›å‡†ç¡®çš„æ•°æ®åˆ†å¸ƒä¿¡æ¯
- å¸®åŠ©é€‰æ‹©æ›´ä¼˜çš„æ‰§è¡Œè®¡åˆ’

è´Ÿé¢å½±å“ï¼š
- ç»Ÿè®¡ä¿¡æ¯å˜åŒ–å¯èƒ½å¯¼è‡´è®¡åˆ’ä¸ç¨³å®š
- è¿‡äºé¢‘ç¹çš„æ›´æ–°å¢åŠ ç³»ç»Ÿå¼€é”€
```

**ğŸ”¹ è‡ªåŠ¨åŒ–ä¸äººå·¥å¹²é¢„çš„ç»“åˆ**
```
è‡ªåŠ¨åŒ–å¤„ç†ï¼š
- æ—¥å¸¸ç›‘æ§å’Œç®€å•é—®é¢˜çš„è‡ªåŠ¨å¤„ç†
- åŸºäºè§„åˆ™çš„å‘Šè­¦å’Œå“åº”

äººå·¥å¹²é¢„ï¼š
- å¤æ‚é—®é¢˜çš„åˆ†æå’Œå†³ç­–
- ä¸šåŠ¡å½±å“è¯„ä¼°å’Œé£é™©æ§åˆ¶
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒç¨³å®šæ€§ä¿éšœ**ï¼š
- **é¢„é˜²æ€§ç®¡ç†**ï¼šå»ºç«‹è®¡åˆ’åŸºçº¿ï¼Œé¿å…æ„å¤–çš„æ€§èƒ½å›å½’
- **å¿«é€Ÿæ¢å¤èƒ½åŠ›**ï¼šå‡ºç°é—®é¢˜æ—¶èƒ½å¿«é€Ÿå›æ»šåˆ°ç¨³å®šçŠ¶æ€
- **æŒç»­æ”¹è¿›**ï¼šåœ¨ä¿è¯ç¨³å®šçš„å‰æä¸‹é€æ­¥ä¼˜åŒ–æ€§èƒ½

**ğŸ” é—®é¢˜å®šä½å’Œè§£å†³**ï¼š
- **æ ¹å› åˆ†æ**ï¼šç†è§£è®¡åˆ’å˜åŒ–çš„æ·±å±‚åŸå› 
- **å½±å“è¯„ä¼°**ï¼šè¯„ä¼°è®¡åˆ’å˜åŒ–å¯¹ä¸šåŠ¡çš„å½±å“èŒƒå›´
- **è§£å†³æ–¹æ¡ˆ**ï¼šé€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ‰‹æ®µè§£å†³ç¨³å®šæ€§é—®é¢˜

**ğŸ“Š ç›‘æ§å’Œè¿ç»´**ï¼š
- **æŒ‡æ ‡ä½“ç³»**ï¼šå»ºç«‹å…¨é¢çš„ç¨³å®šæ€§ç›‘æ§æŒ‡æ ‡
- **å‘Šè­¦æœºåˆ¶**ï¼šåŠæ—¶å‘ç°å’Œå“åº”ç¨³å®šæ€§é—®é¢˜
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜å“åº”é€Ÿåº¦

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”¸ å»ºç«‹åˆ†å±‚çš„ç¨³å®šæ€§ç­–ç•¥**ï¼š
- **æ ¸å¿ƒSQL**ï¼šä½¿ç”¨å›ºå®šè®¡åˆ’ï¼Œä¸¥æ ¼æ§åˆ¶å˜æ›´
- **ä¸€èˆ¬SQL**ï¼šå…è®¸é€‚åº¦ä¼˜åŒ–ï¼Œä½†ç›‘æ§å˜åŒ–å½±å“
- **ä¸´æ—¶SQL**ï¼šå¯ä»¥è‡ªç”±ä¼˜åŒ–ï¼Œä¸çº³å…¥ç¨³å®šæ€§ç®¡ç†

**ğŸ”¸ å®æ–½æ¸è¿›å¼çš„è®¡åˆ’æ¼”è¿›**ï¼š
- **å°æµé‡æµ‹è¯•**ï¼šæ–°è®¡åˆ’å…ˆåœ¨å°èŒƒå›´å†…éªŒè¯
- **A/Bå¯¹æ¯”**ï¼šé€šè¿‡å¯¹æ¯”æµ‹è¯•éªŒè¯æ”¹è¿›æ•ˆæœ
- **å¯å›æ»šè®¾è®¡**ï¼šç¡®ä¿éšæ—¶èƒ½å›åˆ°ä¹‹å‰çš„ç¨³å®šçŠ¶æ€

**ğŸ”¸ å®Œå–„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»**ï¼š
- **å¤šç»´åº¦ç›‘æ§**ï¼šä¸ä»…ç›‘æ§æ€§èƒ½ï¼Œè¿˜è¦ç›‘æ§ç¨³å®šæ€§æŒ‡æ ‡
- **åˆ†çº§å‘Šè­¦**ï¼šæ ¹æ®å½±å“ç¨‹åº¦è®¾ç½®ä¸åŒçš„å‘Šè­¦ç­–ç•¥
- **è‡ªåŠ¨åŒ–å“åº”**ï¼šå¯¹äºå·²çŸ¥é—®é¢˜å®ç°è‡ªåŠ¨åŒ–å¤„ç†

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
```
æ‰§è¡Œè®¡åˆ’ç¨³å®šæ€§ç®¡ç†çš„ç²¾é«“ï¼š
- ä»¥ç¨³å®šä¸ºåŸºç¡€ï¼Œä»¥æ€§èƒ½ä¸ºç›®æ ‡
- ä»¥ç›‘æ§ä¸ºæ‰‹æ®µï¼Œä»¥è‡ªåŠ¨åŒ–ä¸ºæ–¹å‘
- åœ¨å˜åŒ–ä¸­å¯»æ±‚ç¨³å®šï¼Œåœ¨ç¨³å®šä¸­è¿½æ±‚ä¼˜åŒ–
```