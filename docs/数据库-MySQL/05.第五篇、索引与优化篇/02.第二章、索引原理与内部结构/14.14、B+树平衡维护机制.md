---
title: 14ã€B+æ ‘å¹³è¡¡ç»´æŠ¤æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [B+æ ‘å¹³è¡¡ç»´æŠ¤æ¦‚è¿°](#1-B+æ ‘å¹³è¡¡ç»´æŠ¤æ¦‚è¿°)
2. [è‡ªå¹³è¡¡ç®—æ³•åŸç†](#2-è‡ªå¹³è¡¡ç®—æ³•åŸç†)
3. [æ ‘å¹³è¡¡åˆ¤æ–­æ ‡å‡†](#3-æ ‘å¹³è¡¡åˆ¤æ–­æ ‡å‡†)
4. [èŠ‚ç‚¹åˆ†è£‚ç­–ç•¥](#4-èŠ‚ç‚¹åˆ†è£‚ç­–ç•¥)
5. [é‡å¹³è¡¡è§¦å‘æ¡ä»¶](#5-é‡å¹³è¡¡è§¦å‘æ¡ä»¶)
6. [èŠ‚ç‚¹åˆå¹¶é˜ˆå€¼](#6-èŠ‚ç‚¹åˆå¹¶é˜ˆå€¼)
7. [å¹³è¡¡æ“ä½œäº‹åŠ¡æ€§](#7-å¹³è¡¡æ“ä½œäº‹åŠ¡æ€§)
8. [å¹¶å‘æ’å…¥åˆ é™¤æ§åˆ¶](#8-å¹¶å‘æ’å…¥åˆ é™¤æ§åˆ¶)
9. [å¹³è¡¡ç»´æŠ¤æ€§èƒ½å¼€é”€åˆ†æ](#9-å¹³è¡¡ç»´æŠ¤æ€§èƒ½å¼€é”€åˆ†æ)
10. [å¹³è¡¡ç»´æŠ¤ç­–ç•¥ä¼˜åŒ–](#10-å¹³è¡¡ç»´æŠ¤ç­–ç•¥ä¼˜åŒ–)
11. [å¹³è¡¡ç»´æŠ¤ç›‘æ§æŒ‡æ ‡è®¾è®¡](#11-å¹³è¡¡ç»´æŠ¤ç›‘æ§æŒ‡æ ‡è®¾è®¡)
12. [æç«¯åœºæ™¯å¹³è¡¡ç»´æŠ¤ç­–ç•¥](#12-æç«¯åœºæ™¯å¹³è¡¡ç»´æŠ¤ç­–ç•¥)
13. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#13-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. âš–ï¸ B+æ ‘å¹³è¡¡ç»´æŠ¤æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯B+æ ‘å¹³è¡¡ç»´æŠ¤


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä¸€ä¸ªå›¾ä¹¦é¦†çš„ä¹¦æ¶ç³»ç»Ÿï¼š
â€¢ æ¯å±‚ä¹¦æ¶éƒ½æœ‰å›ºå®šçš„æ‰¿è½½èƒ½åŠ›ï¼ˆèŠ‚ç‚¹å®¹é‡ï¼‰
â€¢ ä¹¦å¤ªå¤šæ—¶éœ€è¦åŠ æ–°ä¹¦æ¶ï¼ˆèŠ‚ç‚¹åˆ†è£‚ï¼‰
â€¢ ä¹¦å¤ªå°‘æ—¶å¯ä»¥åˆå¹¶ä¹¦æ¶ï¼ˆèŠ‚ç‚¹åˆå¹¶ï¼‰
â€¢ æ•´ä¸ªä¹¦æ¶ç³»ç»Ÿè¦ä¿æŒå¹³è¡¡ï¼ˆæ ‘é«˜åº¦å‡åŒ€ï¼‰

B+æ ‘çš„å¹³è¡¡ç»´æŠ¤å°±åƒå›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼Œç¡®ä¿ï¼š
- æ‰€æœ‰ä¹¦æ¶çš„åˆ©ç”¨ç‡åˆç†ï¼ˆèŠ‚ç‚¹å¡«å……åº¦ï¼‰
- æ‰¾ä»»ä½•ä¸€æœ¬ä¹¦çš„æ—¶é—´å·®ä¸å¤šï¼ˆæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼‰
- æ·»åŠ åˆ é™¤ä¹¦ç±ä¸ä¼šè®©ä¹¦æ¶ç³»ç»Ÿæ··ä¹±ï¼ˆç»“æ„ç¨³å®šæ€§ï¼‰
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
B+æ ‘å¹³è¡¡ç»´æŠ¤ï¼šé€šè¿‡è‡ªåŠ¨è°ƒæ•´æ ‘ç»“æ„ï¼Œä¿æŒB+æ ‘æ€§è´¨çš„æœºåˆ¶
ç›®æ ‡ï¼šç»´æŒæŸ¥è¯¢æ€§èƒ½ç¨³å®šï¼Œç¡®ä¿æ‰€æœ‰å¶å­èŠ‚ç‚¹åœ¨åŒä¸€å±‚çº§
æ ¸å¿ƒæ€æƒ³ï¼šå±€éƒ¨è°ƒæ•´ï¼Œå…¨å±€å¹³è¡¡
è§¦å‘æ—¶æœºï¼šæ’å…¥ã€åˆ é™¤æ“ä½œå¯èƒ½ç ´åæ ‘å¹³è¡¡æ—¶
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¹³è¡¡ç»´æŠ¤


**âŒ ä¸å¹³è¡¡B+æ ‘çš„é—®é¢˜**
```
å¤±è¡¡åœºæ™¯ï¼šè¿ç»­æ’å…¥æœ‰åºæ•°æ®
åŸå§‹å¹³è¡¡æ ‘ï¼š         å¤±è¡¡åçš„æ ‘ï¼š
      [5]                [1]
    /     \                \
  [2,3]  [7,8]              [2]
                               \
                               [3]
                                 \
                                 [4]
                                   \
                                   [5]

é—®é¢˜åˆ†æï¼š
â€¢ æ ‘é€€åŒ–ä¸ºé“¾è¡¨ç»“æ„
â€¢ æŸ¥è¯¢æ—¶é—´ä»O(log n)é€€åŒ–ä¸ºO(n)
â€¢ å­˜å‚¨æ•ˆç‡å¤§å¹…ä¸‹é™
â€¢ ç¼“å­˜å‘½ä¸­ç‡é™ä½
```

**âœ… å¹³è¡¡ç»´æŠ¤çš„ä»·å€¼**
```
æ€§èƒ½ä¿éšœï¼š
â€¢ ä¿è¯æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦O(log n)
â€¢ æ‰€æœ‰æ“ä½œæ€§èƒ½ç¨³å®šå¯é¢„æµ‹
â€¢ æœ€å¤§åŒ–å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡

ç³»ç»Ÿç¨³å®šæ€§ï¼š
â€¢ é¿å…æç«¯æƒ…å†µä¸‹çš„æ€§èƒ½åŠ£åŒ–
â€¢ ä¿æŒç´¢å¼•ç»“æ„çš„è§„æ•´æ€§
â€¢ ç¡®ä¿å¹¶å‘æ“ä½œçš„å®‰å…¨æ€§
```

### 1.3 B+æ ‘å¹³è¡¡ç‰¹æ€§


**ğŸ”¸ B+æ ‘çš„å¹³è¡¡ç‰¹æ€§**
```
é«˜åº¦å¹³è¡¡ï¼š
â€¢ æ‰€æœ‰å¶å­èŠ‚ç‚¹éƒ½åœ¨åŒä¸€å±‚
â€¢ ä»æ ¹åˆ°ä»»æ„å¶å­çš„è·¯å¾„é•¿åº¦ç›¸åŒ
â€¢ è¿™æ˜¯B+æ ‘çš„æ ¸å¿ƒç‰¹æ€§

èŠ‚ç‚¹å¡«å……åº¦ï¼š
â€¢ é™¤æ ¹èŠ‚ç‚¹å¤–ï¼Œæ‰€æœ‰èŠ‚ç‚¹è‡³å°‘åŠæ»¡
â€¢ æœ€å¤§åŒ–ç©ºé—´åˆ©ç”¨ç‡
â€¢ ä¿è¯åˆ é™¤æ“ä½œçš„å®‰å…¨æ€§

åˆ†æ”¯å› å­ï¼š
â€¢ å†…éƒ¨èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°é‡åœ¨åˆç†èŒƒå›´å†…
â€¢ æ—¢ä¸å¤ªå°‘ï¼ˆæµªè´¹ç©ºé—´ï¼‰ä¹Ÿä¸å¤ªå¤šï¼ˆå½±å“ç¼“å­˜ï¼‰
â€¢ é€šå¸¸è®¾ç½®ä¸ºé¡µå¤§å°çš„ä¼˜åŒ–å€¼
```

---

## 2. ğŸ”„ è‡ªå¹³è¡¡ç®—æ³•åŸç†


### 2.1 è‡ªå¹³è¡¡çš„æ ¸å¿ƒæ€æƒ³


**ğŸ”¸ å¹³è¡¡ç»´æŠ¤çš„åŸºæœ¬åŸç†**
```
æ ¸å¿ƒæ€æƒ³ï¼šå±€éƒ¨è¿è§„ï¼Œå…¨å±€ä¿®å¤
å·¥ä½œæœºåˆ¶ï¼š
1. æ£€æµ‹è¿è§„ï¼šæ“ä½œåæ£€æŸ¥æ˜¯å¦è¿åB+æ ‘æ€§è´¨
2. å±€éƒ¨è°ƒæ•´ï¼šåœ¨è¿è§„èŠ‚ç‚¹é™„è¿‘è¿›è¡Œæœ€å°è°ƒæ•´
3. é€’å½’ä¿®å¤ï¼šè°ƒæ•´å¯èƒ½å½±å“çˆ¶èŠ‚ç‚¹ï¼Œé€’å½’å‘ä¸Šä¿®å¤
4. å…¨å±€å¹³è¡¡ï¼šç¡®ä¿æ•´æ ‘æ»¡è¶³B+æ ‘æ€§è´¨

å°±åƒå¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”ï¼š
â€¢ ä¸€ä¸ªèŠ‚ç‚¹çš„å˜åŒ–å¯èƒ½å½±å“ç›¸é‚»èŠ‚ç‚¹
â€¢ å½±å“ä¼šå±‚å±‚ä¼ é€’
â€¢ æœ€ç»ˆè¾¾åˆ°æ–°çš„ç¨³å®šçŠ¶æ€
```

### 2.2 è‡ªå¹³è¡¡ç®—æ³•åˆ†ç±»


**ğŸ“Š ä¸»è¦å¹³è¡¡ç®—æ³•å¯¹æ¯”**

| ç®—æ³•ç±»å‹ | **è§¦å‘æ—¶æœº** | **è°ƒæ•´èŒƒå›´** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|----------|-------------|-------------|-----------|-------------|
| **åˆ†è£‚ç®—æ³•** | `èŠ‚ç‚¹è¿‡æ»¡æ—¶` | å•èŠ‚ç‚¹â†’ä¸¤èŠ‚ç‚¹ | O(log n) | æ’å…¥æ“ä½œ |
| **åˆå¹¶ç®—æ³•** | `èŠ‚ç‚¹è¿‡ç©ºæ—¶` | ä¸¤èŠ‚ç‚¹â†’å•èŠ‚ç‚¹ | O(log n) | åˆ é™¤æ“ä½œ |
| **å€Ÿç”¨ç®—æ³•** | `èŠ‚ç‚¹ä¸è¶³æ—¶` | å…„å¼ŸèŠ‚ç‚¹é—´ | O(1) | åˆ é™¤æ“ä½œä¼˜åŒ– |
| **é‡åˆ†å¸ƒç®—æ³•** | `è´Ÿè½½ä¸å‡æ—¶` | ç›¸é‚»èŠ‚ç‚¹é—´ | O(1) | æ‰¹é‡æ“ä½œå |

### 2.3 å¹³è¡¡ç®—æ³•æ ¸å¿ƒæ­¥éª¤


**ğŸ”§ é€šç”¨å¹³è¡¡ç»´æŠ¤æµç¨‹**
```
æ“ä½œæ‰§è¡Œ â†’ æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ â†’ åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´ â†’ é€‰æ‹©è°ƒæ•´ç­–ç•¥ â†’ æ‰§è¡Œè°ƒæ•´ â†’ é€’å½’æ£€æŸ¥çˆ¶èŠ‚ç‚¹
```

**ğŸ’» å¹³è¡¡ç»´æŠ¤ä¼ªä»£ç **
```java
public class BPlusTreeBalancer {
    
    public void maintainBalance(BPlusNode node, Operation operation) {
        // æ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦è¿åB+æ ‘æ€§è´¨
        if (isNodeOverflow(node)) {
            splitNode(node);
        } else if (isNodeUnderflow(node)) {
            if (canBorrowFromSibling(node)) {
                borrowFromSibling(node);
            } else {
                mergeWithSibling(node);
            }
        }
        
        // æ£€æŸ¥çˆ¶èŠ‚ç‚¹æ˜¯å¦å—å½±å“
        if (node.getParent() != null) {
            maintainBalance(node.getParent(), operation);
        }
    }
    
    private boolean isNodeOverflow(BPlusNode node) {
        return node.getKeyCount() > maxKeysPerNode;
    }
    
    private boolean isNodeUnderflow(BPlusNode node) {
        return !node.isRoot() && node.getKeyCount() < minKeysPerNode;
    }
}
```

---

## 3. ğŸ“ æ ‘å¹³è¡¡åˆ¤æ–­æ ‡å‡†


### 3.1 B+æ ‘å¹³è¡¡æ€§å®šä¹‰


**ğŸ”¸ ä»€ä¹ˆç®—æ˜¯"å¹³è¡¡"**
```
B+æ ‘çš„å¹³è¡¡æ€§åŒ…å«å¤šä¸ªç»´åº¦ï¼š

é«˜åº¦å¹³è¡¡ï¼š
â€¢ æ‰€æœ‰å¶å­èŠ‚ç‚¹å¿…é¡»åœ¨åŒä¸€å±‚çº§
â€¢ è¿™æ˜¯B+æ ‘çš„æ ¹æœ¬è¦æ±‚
â€¢ ä¿è¯æŸ¥è¯¢è·¯å¾„é•¿åº¦ä¸€è‡´

å¡«å……åº¦å¹³è¡¡ï¼š
â€¢ èŠ‚ç‚¹å¡«å……ç‡ä¸èƒ½å¤ªä½ï¼ˆæµªè´¹ç©ºé—´ï¼‰
â€¢ èŠ‚ç‚¹å¡«å……ç‡ä¸èƒ½å¤ªé«˜ï¼ˆå½±å“åˆ†è£‚æ•ˆç‡ï¼‰
â€¢ ç»´æŒåœ¨50%-100%ä¹‹é—´

è´Ÿè½½å¹³è¡¡ï¼š
â€¢ ç›¸é‚»èŠ‚ç‚¹çš„å¡«å……åº¦ä¸èƒ½å·®è·è¿‡å¤§
â€¢ é¿å…çƒ­ç‚¹èŠ‚ç‚¹çš„å‡ºç°
â€¢ ä¿è¯æ’å…¥åˆ é™¤æ€§èƒ½å‡åŒ€
```

### 3.2 å¹³è¡¡æ€§é‡åŒ–æŒ‡æ ‡


**ğŸ“Š å¹³è¡¡åº¦è®¡ç®—å…¬å¼**
```java
public class BalanceMetrics {
    
    // è®¡ç®—æ ‘çš„å¹³è¡¡å› å­
    public double calculateBalanceFactor(BPlusTree tree) {
        int minHeight = findMinLeafHeight(tree.getRoot());
        int maxHeight = findMaxLeafHeight(tree.getRoot());
        return (double) minHeight / maxHeight;
    }
    
    // è®¡ç®—èŠ‚ç‚¹å¡«å……ç‡
    public double calculateFillRate(BPlusNode node) {
        return (double) node.getKeyCount() / node.getMaxCapacity();
    }
    
    // è¯„ä¼°æ ‘çš„æ•´ä½“å¥åº·åº¦
    public TreeHealthScore evaluateTreeHealth(BPlusTree tree) {
        double balanceFactor = calculateBalanceFactor(tree);
        double averageFillRate = calculateAverageFillRate(tree);
        
        if (balanceFactor > 0.9 && averageFillRate > 0.6) {
            return TreeHealthScore.EXCELLENT;
        } else if (balanceFactor > 0.8 && averageFillRate > 0.5) {
            return TreeHealthScore.GOOD;
        } else {
            return TreeHealthScore.POOR;
        }
    }
}
```

### 3.3 å¹³è¡¡åˆ¤æ–­çš„å®æ—¶æ£€æµ‹


**âš¡ å®æ—¶å¹³è¡¡çŠ¶æ€ç›‘æ§**
```java
public class RealTimeBalanceMonitor {
    
    private final AtomicLong totalOperations = new AtomicLong(0);
    private final AtomicLong balanceOperations = new AtomicLong(0);
    
    public void recordOperation(BPlusNode node, OperationType operation) {
        totalOperations.incrementAndGet();
        
        if (needsBalanceCheck(node, operation)) {
            boolean balanced = checkAndMaintainBalance(node);
            if (balanced) {
                balanceOperations.incrementAndGet();
            }
        }
    }
    
    private boolean needsBalanceCheck(BPlusNode node, OperationType operation) {
        switch (operation) {
            case INSERT:
                return node.getKeyCount() >= node.getMaxCapacity();
            case DELETE:
                return node.getKeyCount() < getMinKeysRequired(node);
            default:
                return false;
        }
    }
}
```

---

## 4. ğŸŒ¿ èŠ‚ç‚¹åˆ†è£‚ç­–ç•¥


### 4.1 èŠ‚ç‚¹åˆ†è£‚çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯èŠ‚ç‚¹åˆ†è£‚**
```
èŠ‚ç‚¹åˆ†è£‚ï¼šå½“èŠ‚ç‚¹å®¹é‡è¶…è¿‡é™åˆ¶æ—¶ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹æ‹†åˆ†ä¸ºä¸¤ä¸ªèŠ‚ç‚¹çš„æ“ä½œ

å°±åƒæ•™å®¤åº§ä½æ»¡äº†çš„å¤„ç†æ–¹å¼ï¼š
â€¢ åŸæ•™å®¤ï¼š50ä¸ªå­¦ç”Ÿï¼Œå·²åæ»¡
â€¢ æ–°å¢1ä¸ªå­¦ç”Ÿï¼šæ€»å…±51ä¸ªå­¦ç”Ÿ
â€¢ è§£å†³æ–¹æ¡ˆï¼šå¼€è®¾æ–°æ•™å®¤ï¼Œå¹³å‡åˆ†é…å­¦ç”Ÿ
â€¢ ç»“æœï¼šæ•™å®¤1ï¼ˆ25å­¦ç”Ÿï¼‰+ æ•™å®¤2ï¼ˆ26å­¦ç”Ÿï¼‰

B+æ ‘èŠ‚ç‚¹åˆ†è£‚åŒæ ·é“ç†ï¼š
â€¢ åŸèŠ‚ç‚¹ï¼šå·²æ»¡ï¼ˆæ¯”å¦‚100ä¸ªé”®å€¼ï¼‰
â€¢ æ–°æ’å…¥ï¼šè¶…å‡ºå®¹é‡
â€¢ åˆ†è£‚ï¼šæ‹†åˆ†æˆä¸¤ä¸ªèŠ‚ç‚¹ï¼ˆå„50ä¸ªé”®å€¼ï¼‰
```

### 4.2 åˆ†è£‚è§¦å‘æ¡ä»¶


**ğŸ“ åˆ†è£‚é˜ˆå€¼è®¾è®¡**
```java
public class NodeSplitConditions {
    
    public static class NodeCapacity {
        public final int maxKeys = 1000;      // æœ€å¤§é”®å€¼æ•°
        public final int minKeys = 500;       // æœ€å°é”®å€¼æ•°
        public final double presplitRate = 0.9; // é¢„åˆ†è£‚é˜ˆå€¼90%
    }
    
    public boolean shouldSplit(BPlusNode node) {
        // åŸºæœ¬åˆ†è£‚æ¡ä»¶ï¼šè¶…è¿‡æœ€å¤§å®¹é‡
        if (node.getKeyCount() > nodeCapacity.maxKeys) {
            return true;
        }
        
        // é¢„åˆ†è£‚æ¡ä»¶ï¼šæ¥è¿‘æ»¡è½½ä¸”æ’å…¥é¢‘ç¹
        if (isHotInsertNode(node) && 
            node.getKeyCount() > nodeCapacity.maxKeys * nodeCapacity.presplitRate) {
            return true;
        }
        
        return false;
    }
}
```

### 4.3 åˆ†è£‚ç®—æ³•å®ç°


**ğŸ”§ å¶å­èŠ‚ç‚¹åˆ†è£‚**
```java
public class LeafNodeSplitter {
    
    public SplitResult splitLeafNode(LeafNode node) {
        int splitIndex = node.getKeyCount() / 2;
        
        // åˆ›å»ºæ–°çš„å³èŠ‚ç‚¹
        LeafNode rightNode = new LeafNode();
        
        // ç§»åŠ¨å³åŠéƒ¨åˆ†é”®å€¼åˆ°æ–°èŠ‚ç‚¹
        for (int i = splitIndex; i < node.getKeyCount(); i++) {
            rightNode.addKeyValue(node.getKey(i), node.getValue(i));
        }
        
        // æˆªæ–­åŸèŠ‚ç‚¹
        node.truncateAfter(splitIndex - 1);
        
        // æ›´æ–°å¶å­é“¾è¡¨
        rightNode.setNextLeaf(node.getNextLeaf());
        node.setNextLeaf(rightNode);
        
        return new SplitResult(node, rightNode, rightNode.getMinKey());
    }
}
```

**ğŸ”§ å†…éƒ¨èŠ‚ç‚¹åˆ†è£‚**
```java
public class InternalNodeSplitter {
    
    public SplitResult splitInternalNode(InternalNode node) {
        int splitIndex = node.getKeyCount() / 2;
        InternalNode rightNode = new InternalNode();
        
        // é€‰æ‹©ä¸­é—´é”®å€¼ä½œä¸ºä¸Šå‡é”®å€¼
        Comparable promotedKey = node.getKey(splitIndex);
        
        // ç§»åŠ¨å³åŠéƒ¨åˆ†é”®å€¼å’Œå­èŠ‚ç‚¹
        for (int i = splitIndex + 1; i < node.getKeyCount(); i++) {
            rightNode.addKey(node.getKey(i));
            rightNode.addChild(node.getChild(i + 1));
        }
        
        node.truncateAfter(splitIndex - 1);
        
        return new SplitResult(node, rightNode, promotedKey);
    }
}
```

### 4.4 åˆ†è£‚ç­–ç•¥ä¼˜åŒ–


**âš¡ æ™ºèƒ½åˆ†è£‚ç‚¹é€‰æ‹©**
```java
public class OptimizedSplitStrategy {
    
    // åŸºäºæ’å…¥ä½ç½®çš„æ™ºèƒ½åˆ†è£‚
    public int findOptimalSplitPoint(BPlusNode node, Comparable newKey) {
        int insertPos = node.findInsertPosition(newKey);
        int totalSize = node.getKeyCount() + 1;
        
        if (insertPos < totalSize / 4) {
            return totalSize / 3;        // æ’å…¥ä½ç½®é å‰ï¼Œåˆ†è£‚ç‚¹åå·¦
        } else if (insertPos > totalSize * 3 / 4) {
            return totalSize * 2 / 3;    // æ’å…¥ä½ç½®é åï¼Œåˆ†è£‚ç‚¹åå³
        } else {
            return totalSize / 2;        // æ’å…¥ä½ç½®å±…ä¸­ï¼Œå‡åŒ€åˆ†è£‚
        }
    }
    
    // é¢„æµ‹æ€§åˆ†è£‚
    public boolean shouldPreemptiveSplit(BPlusNode node) {
        InsertPattern pattern = analyzeInsertPattern(node);
        double fillRate = (double) node.getKeyCount() / node.getMaxCapacity();
        
        switch (pattern) {
            case SEQUENTIAL: return fillRate > 0.9;  // é¡ºåºæ’å…¥ï¼Œ90%é¢„åˆ†è£‚
            case RANDOM: return fillRate > 0.95;     // éšæœºæ’å…¥ï¼Œ95%åˆ†è£‚
            case HOTSPOT: return fillRate > 0.85;    // çƒ­ç‚¹æ’å…¥ï¼Œ85%é¢„åˆ†è£‚
            default: return false;
        }
    }
}
```

### 4.5 åˆ†è£‚å¯¹çˆ¶èŠ‚ç‚¹çš„å½±å“


**ğŸŒ³ åˆ†è£‚å‘ä¸Šä¼ æ’­**
```
åˆ†è£‚ä¼ æ’­ç¤ºä¾‹ï¼š

åŸå§‹çŠ¶æ€ï¼š
        [50]
       /    \
   [10,20,30,40] [60,70,80,90]

æ’å…¥45åèŠ‚ç‚¹è¿‡æ»¡ï¼š
        [50]
       /    \
[10,20,30,40,45] [60,70,80,90]  â† å·¦èŠ‚ç‚¹è¿‡æ»¡

æ‰§è¡Œåˆ†è£‚ï¼š
        [50]          â†’      [30,50]
       /    \                /  |   \
[10,20,30,40,45] [60,70,80,90] â†’ [10,20] [40,45] [60,70,80,90]

å‘çˆ¶èŠ‚ç‚¹æ’å…¥30ï¼Œå¦‚æœçˆ¶èŠ‚ç‚¹ä¹Ÿè¿‡æ»¡ï¼Œç»§ç»­å‘ä¸Šåˆ†è£‚
```

---

## 5. ğŸš¨ é‡å¹³è¡¡è§¦å‘æ¡ä»¶


### 5.1 è§¦å‘æ¡ä»¶åˆ†ç±»


**ğŸ”¸ ä¸»åŠ¨è§¦å‘æ¡ä»¶**
```
æ’å…¥è§¦å‘ï¼š
â€¢ èŠ‚ç‚¹é”®å€¼æ•°é‡ > æœ€å¤§å®¹é‡
â€¢ é¢„æµ‹æ€§è§¦å‘ï¼šå¡«å……ç‡ > 90%ï¼ˆçƒ­ç‚¹èŠ‚ç‚¹ï¼‰
â€¢ æ‰¹é‡æ’å…¥åçš„æ•´ä½“è¯„ä¼°

åˆ é™¤è§¦å‘ï¼š
â€¢ èŠ‚ç‚¹é”®å€¼æ•°é‡ < æœ€å°å®¹é‡ï¼ˆé€šå¸¸æ˜¯æœ€å¤§å®¹é‡çš„50%ï¼‰
â€¢ ç›¸é‚»èŠ‚ç‚¹å¡«å……ç‡å·®å¼‚è¿‡å¤§
â€¢ æ‰¹é‡åˆ é™¤åçš„ç¢ç‰‡æ•´ç†

æ›´æ–°è§¦å‘ï¼š
â€¢ é”®å€¼å¤§å°æ˜¾è‘—å˜åŒ–å½±å“èŠ‚ç‚¹å®¹é‡
â€¢ é¢‘ç¹æ›´æ–°å¯¼è‡´èŠ‚ç‚¹ç¢ç‰‡åŒ–
```

**ğŸ“Š è§¦å‘é˜ˆå€¼é…ç½®**
```java
public class RebalanceThresholds {
    
    // é˜ˆå€¼é…ç½®
    public static final double SPLIT_THRESHOLD = 1.0;        // 100%æ»¡æ—¶å¼ºåˆ¶åˆ†è£‚
    public static final double PRESPLIT_THRESHOLD = 0.90;    // 90%æ»¡æ—¶é¢„åˆ†è£‚
    public static final double MERGE_THRESHOLD = 0.40;       // 40%ç©ºæ—¶è€ƒè™‘åˆå¹¶
    public static final double UNDERFLOW_THRESHOLD = 0.25;   // 25%ç©ºæ—¶å¼ºåˆ¶åˆå¹¶
    
    public RebalanceDecision shouldRebalance(BPlusNode node) {
        double fillRate = calculateFillRate(node);
        
        if (fillRate >= SPLIT_THRESHOLD) {
            return new RebalanceDecision(RebalanceType.SPLIT, Priority.IMMEDIATE);
        }
        if (fillRate >= PRESPLIT_THRESHOLD && isHotNode(node)) {
            return new RebalanceDecision(RebalanceType.PRESPLIT, Priority.HIGH);
        }
        if (fillRate <= UNDERFLOW_THRESHOLD) {
            return new RebalanceDecision(RebalanceType.MERGE_OR_BORROW, Priority.IMMEDIATE);
        }
        
        return RebalanceDecision.NO_ACTION;
    }
}
```

### 5.2 åŠ¨æ€è§¦å‘æ¡ä»¶è°ƒæ•´


**ğŸ”„ è‡ªé€‚åº”é˜ˆå€¼è°ƒæ•´**
```java
public class AdaptiveThresholds {
    
    private double splitThreshold = 1.0;
    private double mergeThreshold = 0.4;
    
    public void adjustThresholds(TreePerformanceStats stats) {
        // æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´åˆ†è£‚é˜ˆå€¼
        if (stats.getSystemLoad() > 0.8) {
            splitThreshold = 0.85;  // é«˜è´Ÿè½½æ—¶æå‰åˆ†è£‚
        } else if (stats.getSystemLoad() < 0.3) {
            splitThreshold = 1.0;   // ä½è´Ÿè½½æ—¶å‡å°‘åˆ†è£‚
        }
        
        // æ ¹æ®æŸ¥è¯¢æ¨¡å¼è°ƒæ•´åˆå¹¶é˜ˆå€¼
        if (stats.getQueryPattern() == QueryPattern.RANGE_HEAVY) {
            mergeThreshold = 0.5;   // èŒƒå›´æŸ¥è¯¢å¤šï¼Œä¿æŒèŠ‚ç‚¹ç´§å‡‘
        } else if (stats.getQueryPattern() == QueryPattern.POINT_HEAVY) {
            mergeThreshold = 0.3;   // ç‚¹æŸ¥è¯¢å¤šï¼Œå‡å°‘åˆå¹¶æ“ä½œ
        }
    }
}
```

---

## 6. ğŸ”— èŠ‚ç‚¹åˆå¹¶é˜ˆå€¼


### 6.1 åˆå¹¶æ“ä½œåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯èŠ‚ç‚¹åˆå¹¶**
```
èŠ‚ç‚¹åˆå¹¶ï¼šå½“èŠ‚ç‚¹å®¹é‡è¿‡ä½æ—¶ï¼Œå°†ç›¸é‚»çš„ä¸¤ä¸ªèŠ‚ç‚¹åˆå¹¶ä¸ºä¸€ä¸ªèŠ‚ç‚¹çš„æ“ä½œ

ç”Ÿæ´»ç±»æ¯”ï¼š
â€¢ ä¸¤ä¸ªæ•™å®¤å­¦ç”Ÿéƒ½å¾ˆå°‘ï¼ˆèŠ‚ç‚¹å¡«å……ç‡ä½ï¼‰
â€¢ æ•™å®¤Aï¼š15ä¸ªå­¦ç”Ÿï¼Œæ•™å®¤Bï¼š12ä¸ªå­¦ç”Ÿ
â€¢ åˆå¹¶æ–¹æ¡ˆï¼šæŠŠä¸¤ä¸ªæ•™å®¤çš„å­¦ç”Ÿåˆå¹¶åˆ°ä¸€ä¸ªæ•™å®¤
â€¢ ç»“æœï¼šæ–°æ•™å®¤27ä¸ªå­¦ç”Ÿï¼Œé‡Šæ”¾ä¸€ä¸ªæ•™å®¤ç©ºé—´

èŠ‚ç‚¹åˆå¹¶çš„å¥½å¤„ï¼š
â€¢ æé«˜ç©ºé—´åˆ©ç”¨ç‡
â€¢ å‡å°‘æ ‘çš„å±‚çº§ï¼ˆå¯èƒ½ï¼‰
â€¢ é™ä½ç»´æŠ¤å¼€é”€
```

### 6.2 åˆå¹¶è§¦å‘é˜ˆå€¼è®¾è®¡


**ğŸ“ åˆå¹¶é˜ˆå€¼è®¡ç®—**
```java
public class MergeThresholds {
    
    public boolean shouldConsiderMerge(BPlusNode node) {
        if (node.isRoot()) return false;
        
        // å¡«å……ç‡è¿‡ä½æ—¶è€ƒè™‘åˆå¹¶
        double fillRate = (double) node.getKeyCount() / node.getMaxCapacity();
        return fillRate < 0.3;  // 30%ä»¥ä¸‹è€ƒè™‘åˆå¹¶
    }
    
    public boolean canMergeWithSibling(BPlusNode node, BPlusNode sibling) {
        if (sibling == null) return false;
        
        int combinedKeys = node.getKeyCount() + sibling.getKeyCount();
        
        if (node.isLeaf()) {
            return combinedKeys <= node.getMaxCapacity();
        } else {
            return combinedKeys + 1 <= node.getMaxCapacity();  // +1æ˜¯åˆ†éš”é”®
        }
    }
}
```

### 6.3 åˆå¹¶ç®—æ³•å®ç°


**ğŸ”§ å¶å­èŠ‚ç‚¹åˆå¹¶**
```java
public class LeafNodeMerger {
    
    public MergeResult mergeLeafNodes(LeafNode leftNode, LeafNode rightNode) {
        // å°†å³èŠ‚ç‚¹çš„é”®å€¼ç§»åŠ¨åˆ°å·¦èŠ‚ç‚¹
        while (rightNode.getKeyCount() > 0) {
            KeyValuePair pair = rightNode.removeLastKeyValue();
            leftNode.addKeyValue(pair.getKey(), pair.getValue());
        }
        
        // æ›´æ–°å¶å­èŠ‚ç‚¹é“¾è¡¨
        leftNode.setNextLeaf(rightNode.getNextLeaf());
        rightNode.markAsDeleted();
        
        return new MergeResult(leftNode, rightNode);
    }
}
```

### 6.4 å€Ÿç”¨ç®—æ³•ä¼˜åŒ–


**âš¡ èŠ‚ç‚¹é—´å€Ÿç”¨æ“ä½œ**
```java
public class NodeBorrowingOptimizer {
    
    public boolean tryBorrowFromSibling(BPlusNode node) {
        BPlusNode leftSibling = getLeftSibling(node);
        BPlusNode rightSibling = getRightSibling(node);
        
        // ä¼˜å…ˆä»å¡«å……ç‡æ›´é«˜çš„å…„å¼Ÿå€Ÿç”¨
        if (canBorrowFrom(leftSibling) && canBorrowFrom(rightSibling)) {
            return leftSibling.getKeyCount() > rightSibling.getKeyCount() ?
                borrowFromLeft(node, leftSibling) : borrowFromRight(node, rightSibling);
        }
        
        if (canBorrowFrom(leftSibling)) {
            return borrowFromLeft(node, leftSibling);
        }
        
        return canBorrowFrom(rightSibling) && borrowFromRight(node, rightSibling);
    }
    
    private boolean canBorrowFrom(BPlusNode sibling) {
        return sibling != null && 
               sibling.getKeyCount() - 1 >= getMinKeysRequired(sibling);
    }
}
```

---

## 7. ğŸ”’ å¹³è¡¡æ“ä½œäº‹åŠ¡æ€§


### 7.1 äº‹åŠ¡æ€§çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆå¹³è¡¡æ“ä½œéœ€è¦äº‹åŠ¡æ€§**
```
æ•°æ®ä¸€è‡´æ€§é£é™©ï¼š
åœºæ™¯ï¼šèŠ‚ç‚¹åˆ†è£‚è¿‡ç¨‹ä¸­ç³»ç»Ÿå´©æºƒ
æ—¶é—´çº¿ï¼š
T1: åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œç§»åŠ¨éƒ¨åˆ†é”®å€¼
T2: ç³»ç»Ÿå´©æºƒ â† æ­¤æ—¶æ•°æ®å¤„äºä¸­é—´çŠ¶æ€
T3: ç³»ç»Ÿé‡å¯ï¼Œç´¢å¼•ç»“æ„æŸå

é—®é¢˜ï¼š
â€¢ éƒ¨åˆ†é”®å€¼ä¸¢å¤±
â€¢ èŠ‚ç‚¹æŒ‡é’ˆæ··ä¹±
â€¢ ç´¢å¼•æŸ¥è¯¢é”™è¯¯
â€¢ æ•°æ®æ— æ³•æ¢å¤

äº‹åŠ¡æ€§ä¿éšœï¼š
â€¢ è¦ä¹ˆå®Œå…¨æˆåŠŸï¼ˆæ‰€æœ‰æ­¥éª¤éƒ½å®Œæˆï¼‰
â€¢ è¦ä¹ˆå®Œå…¨å¤±è´¥ï¼ˆå›æ»šåˆ°åŸå§‹çŠ¶æ€ï¼‰
â€¢ ä¸å­˜åœ¨ä¸­é—´çŠ¶æ€
```

### 7.2 äº‹åŠ¡æ€§å®ç°æœºåˆ¶


**ğŸ” åŸå­æ€§æ“ä½œå°è£…**
```java
public class TransactionalBalanceOperator {
    
    @Transactional
    public void executeSplitOperation(BPlusNode node) {
        try {
            // è®°å½•åŸå§‹çŠ¶æ€
            NodeSnapshot originalState = createNodeSnapshot(node);
            
            // æ‰§è¡Œåˆ†è£‚æ“ä½œ
            SplitResult result = performSplit(node);
            
            // æ›´æ–°çˆ¶èŠ‚ç‚¹
            propagateSplitToParent(result);
            
            // æäº¤æ“ä½œæ—¥å¿—
            commitOperationLog(OperationType.SPLIT, node, result);
            
        } catch (Exception e) {
            log.error("åˆ†è£‚æ“ä½œå¤±è´¥ï¼Œè‡ªåŠ¨å›æ»š: {}", node.getNodeId(), e);
            throw new BalanceOperationException("èŠ‚ç‚¹åˆ†è£‚å¤±è´¥", e);
        }
    }
}
```

### 7.3 æ•…éšœæ¢å¤æœºåˆ¶


**ğŸ› ï¸ æ“ä½œæ—¥å¿—ä¸æ¢å¤**
```java
public class BalanceRecoveryManager {
    
    public void recoverUncompletedOperations() {
        List<BalanceOperationLog> pendingOps = findPendingOperations();
        
        for (BalanceOperationLog opLog : pendingOps) {
            try {
                recoverSingleOperation(opLog);
            } catch (Exception e) {
                markOperationAsFailed(opLog, e.getMessage());
            }
        }
    }
    
    private void recoverSingleOperation(BalanceOperationLog opLog) {
        BPlusNode targetNode = loadNode(opLog.getTargetNodeId());
        NodeSnapshot currentState = createNodeSnapshot(targetNode);
        
        if (matchesAfterSnapshot(currentState, opLog.getAfterSnapshot())) {
            markOperationAsCompleted(opLog);  // æ“ä½œå·²å®Œæˆ
        } else if (matchesBeforeSnapshot(currentState, opLog.getBeforeSnapshot())) {
            reExecuteOperation(opLog);      // é‡æ–°æ‰§è¡Œæ“ä½œ
        } else {
            markForManualReview(opLog);     // éœ€è¦äººå·¥å¹²é¢„
        }
    }
}
```

---

## 8. ğŸ”„ å¹¶å‘æ’å…¥åˆ é™¤æ§åˆ¶


### 8.1 å¹¶å‘æ§åˆ¶çš„æŒ‘æˆ˜


**ğŸ¤” å¹¶å‘æ“ä½œçš„é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ªèŠ‚ç‚¹

çº¿ç¨‹Aï¼šæ’å…¥é”®å€¼50åˆ°èŠ‚ç‚¹
çº¿ç¨‹Bï¼šåˆ é™¤é”®å€¼30ä»åŒä¸€èŠ‚ç‚¹

å¯èƒ½çš„é—®é¢˜ï¼š
1. è¯»å†™å†²çªï¼šAè¯»å–èŠ‚ç‚¹çŠ¶æ€æ—¶ï¼ŒBæ­£åœ¨ä¿®æ”¹
2. åŒé‡åˆ†è£‚ï¼šAå’ŒBéƒ½è®¤ä¸ºèŠ‚ç‚¹éœ€è¦åˆ†è£‚
3. çŠ¶æ€ä¸ä¸€è‡´ï¼šAçš„ä¿®æ”¹è¢«Bè¦†ç›–
4. æŒ‡é’ˆæ··ä¹±ï¼šèŠ‚ç‚¹æŒ‡é’ˆè¢«é”™è¯¯æ›´æ–°

ç±»æ¯”ï¼šä¸¤ä¸ªäººåŒæ—¶æ•´ç†åŒä¸€ä¸ªæŠ½å±‰
â€¢ æ²¡æœ‰åè°ƒï¼šç‰©å“æ‘†æ”¾æ··ä¹±
â€¢ é‡å¤å·¥ä½œï¼šåŒæ ·çš„æ•´ç†å·¥ä½œåšäº†ä¸¤é
â€¢ ä¸¢å¤±ç‰©å“ï¼šç›¸äº’å¹²æ‰°å¯¼è‡´ç‰©å“ä¸¢å¤±
```

### 8.2 é”ç­–ç•¥è®¾è®¡


**ğŸ” å¤šçº§é”ç­–ç•¥**
```java
public class BTreeLockManager {
    
    public enum LockGranularity {
        TREE_LEVEL,    // æ•´æ ‘é”
        NODE_LEVEL,    // èŠ‚ç‚¹é”
        KEY_LEVEL      // é”®å€¼é”
    }
    
    public void executeWithLock(BPlusNode node, OperationType operation, Runnable action) {
        Lock lock = acquireLock(node, operation);
        try {
            lock.lock();
            action.run();
        } finally {
            lock.unlock();
        }
    }
    
    private Lock acquireLock(BPlusNode node, OperationType operation) {
        String lockKey = "node:" + node.getNodeId();
        return operation.isReadOnly() ? 
            lockManager.acquireReadLock(lockKey) : 
            lockManager.acquireWriteLock(lockKey);
    }
}
```

### 8.3 å¹¶å‘å¹³è¡¡æ“ä½œåè°ƒ


**ğŸš¦ å¹³è¡¡æ“ä½œåè°ƒå™¨**
```java
public class ConcurrentBalanceCoordinator {
    
    private final ConcurrentHashMap<String, RebalanceSession> activeSessions = new ConcurrentHashMap<>();
    
    public boolean tryStartBalanceOperation(BPlusNode node, BalanceOperationType type) {
        String sessionKey = generateSessionKey(node, type);
        RebalanceSession session = new RebalanceSession(node, type);
        
        // åŸå­æ€§æ³¨å†Œä¼šè¯
        RebalanceSession existing = activeSessions.putIfAbsent(sessionKey, session);
        if (existing != null) {
            return false;  // å·²æœ‰ç›¸åŒæ“ä½œåœ¨è¿›è¡Œ
        }
        
        // æ£€æŸ¥å†²çªæ“ä½œ
        if (hasConflictingOperations(node, type)) {
            activeSessions.remove(sessionKey);
            return false;
        }
        
        return true;
    }
    
    public void completeBalanceOperation(BPlusNode node, BalanceOperationType type) {
        String sessionKey = generateSessionKey(node, type);
        activeSessions.remove(sessionKey);
    }
}
```

### 8.4 æ­»é”é¿å…ç­–ç•¥


**ğŸš« æ­»é”é¢„é˜²æœºåˆ¶**
```java
public class DeadlockPrevention {
    
    // æŒ‰èŠ‚ç‚¹IDæ’åºè·å–é”ï¼Œé¿å…æ­»é”
    public void executeWithOrderedLocks(List<BPlusNode> nodes, Runnable action) {
        nodes.sort(Comparator.comparing(BPlusNode::getNodeId));
        
        List<Lock> locks = nodes.stream()
            .map(node -> lockManager.getNodeLock(node.getNodeId()))
            .collect(Collectors.toList());
        
        try {
            // æŒ‰é¡ºåºè·å–é”
            locks.forEach(Lock::lock);
            action.run();
        } finally {
            // æŒ‰ç›¸åé¡ºåºé‡Šæ”¾é”
            Collections.reverse(locks);
            locks.forEach(Lock::unlock);
        }
    }
    
    // è¶…æ—¶æœºåˆ¶
    public boolean executeWithTimeout(BPlusNode node, Duration timeout, Runnable action) {
        Lock lock = lockManager.getNodeLock(node.getNodeId());
        try {
            if (lock.tryLock(timeout.toMillis(), TimeUnit.MILLISECONDS)) {
                action.run();
                return true;
            }
            return false;
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        } finally {
            if (((ReentrantLock) lock).isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

---

## 9. ğŸ“Š å¹³è¡¡ç»´æŠ¤æ€§èƒ½å¼€é”€åˆ†æ


### 9.1 æ€§èƒ½å¼€é”€ç»„æˆåˆ†æ


**ğŸ”¸ å¹³è¡¡æ“ä½œçš„æ€§èƒ½æˆæœ¬**
```
æ—¶é—´å¼€é”€æ„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¹³è¡¡æ“ä½œæ—¶é—´åˆ†è§£              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é”è·å–æ—¶é—´  â”‚  æ•°æ®ç§»åŠ¨æ—¶é—´â”‚  æŒ‡é’ˆæ›´æ–°æ—¶é—´â”‚
â”‚     20%     â”‚     50%     â”‚     20%     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ—¥å¿—è®°å½•   â”‚   ç¼“å­˜åˆ·æ–°   â”‚   éªŒè¯æ£€æŸ¥   â”‚
â”‚     5%      â”‚     3%      â”‚     2%      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å†…å­˜å¼€é”€ï¼š
â€¢ ä¸´æ—¶èŠ‚ç‚¹åˆ›å»ºï¼šé¢å¤–å†…å­˜åˆ†é…
â€¢ å¿«ç…§å­˜å‚¨ï¼šç”¨äºäº‹åŠ¡å›æ»š
â€¢ é”ä¿¡æ¯ç»´æŠ¤ï¼šå¹¶å‘æ§åˆ¶æ•°æ®ç»“æ„
```

**ğŸ“ˆ æ€§èƒ½å¼€é”€æµ‹é‡**
```java
public class BalancePerformanceProfiler {
    
    private final Timer splitTimer = Timer.builder("btree.balance.split").register(meterRegistry);
    private final Counter rebalanceCounter = Counter.builder("btree.balance.operations").register(meterRegistry);
    
    public void profileSplitOperation(BPlusNode node, Supplier<SplitResult> operation) {
        Timer.Sample sample = Timer.start();
        long startMemory = getUsedMemory();
        
        try {
            SplitResult result = operation.get();
            rebalanceCounter.increment("type", "split", "status", "success");
            
            long duration = sample.stop(splitTimer);
            long memoryDelta = getUsedMemory() - startMemory;
            
            log.info("åˆ†è£‚æ€§èƒ½: {}ms, å†…å­˜+{}KB", duration / 1_000_000, memoryDelta / 1024);
            
        } catch (Exception e) {
            rebalanceCounter.increment("type", "split", "status", "failure");
            throw e;
        }
    }
}
```

### 9.2 å¼€é”€ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯**
```java
public class PerformanceOptimizer {
    
    // å»¶è¿Ÿå¹³è¡¡ï¼šéç´§æ€¥æƒ…å†µä¸‹æ‰¹é‡å¤„ç†
    public class DelayedBalancer {
        private final Queue<BalanceTask> pendingTasks = new ConcurrentLinkedQueue<>();
        
        public void scheduleBalance(BPlusNode node, BalanceOperationType type, Priority priority) {
            if (priority == Priority.IMMEDIATE) {
                executeBalanceTask(new BalanceTask(node, type));
            } else {
                pendingTasks.offer(new BalanceTask(node, type));
                if (pendingTasks.size() >= BATCH_SIZE) {
                    processBatch();
                }
            }
        }
    }
    
    // å†…å­˜æ± ä¼˜åŒ–
    public class NodePool {
        private final Queue<BPlusNode> availableNodes = new ConcurrentLinkedQueue<>();
        
        public BPlusNode borrowNode() {
            BPlusNode node = availableNodes.poll();
            return node != null ? node.reset() : new BPlusNode();
        }
        
        public void returnNode(BPlusNode node) {
            node.cleanup();
            availableNodes.offer(node);
        }
    }
}
```

---

## 10. ğŸ¯ å¹³è¡¡ç»´æŠ¤ç­–ç•¥ä¼˜åŒ–


### 10.1 ç­–ç•¥é€‰æ‹©æ¡†æ¶


**ğŸ”¸ å¹³è¡¡ç­–ç•¥å†³ç­–æ ‘**
```
èŠ‚ç‚¹éœ€è¦è°ƒæ•´ï¼Ÿ
        â†“
    èŠ‚ç‚¹è¿‡æ»¡ï¼Ÿ
   â†™        â†˜
  æ˜¯          å¦
  â†“          â†“
æ‰§è¡Œåˆ†è£‚    èŠ‚ç‚¹è¿‡ç©ºï¼Ÿ
  â†“       â†™        â†˜
 å®Œæˆ     æ˜¯          å¦
         â†“          â†“
     å…„å¼Ÿå¯å€Ÿç”¨ï¼Ÿ    æ— éœ€è°ƒæ•´
     â†™       â†˜      â†“
    æ˜¯        å¦     å®Œæˆ
    â†“        â†“
  å€Ÿç”¨æ“ä½œ   åˆå¹¶æ“ä½œ
    â†“        â†“
   å®Œæˆ      å®Œæˆ
```

**ğŸ“Š ç­–ç•¥é€‰æ‹©ç®—æ³•**
```java
public class BalanceStrategySelector {
    
    public BalanceStrategy selectOptimalStrategy(BPlusNode node, OperationContext context) {
        NodeState state = analyzeNodeState(node);
        
        if (state.isOverflow()) {
            return selectSplitStrategy(node, context);
        } else if (state.isUnderflow()) {
            return selectMergeOrBorrowStrategy(node, context);
        } else if (state.isImbalanced()) {
            return selectRedistributeStrategy(node, context);
        }
        
        return BalanceStrategy.NO_OPERATION;
    }
    
    private BalanceStrategy selectSplitStrategy(BPlusNode node, OperationContext context) {
        if (context.isHighConcurrency()) {
            return BalanceStrategy.DELAYED_SPLIT;  // é«˜å¹¶å‘æ—¶å»¶è¿Ÿåˆ†è£‚
        } else if (context.isBatchOperation()) {
            return BalanceStrategy.BATCH_SPLIT;    // æ‰¹é‡æ“ä½œæ—¶æ‰¹é‡åˆ†è£‚
        } else {
            return BalanceStrategy.IMMEDIATE_SPLIT; // ç«‹å³åˆ†è£‚
        }
    }
}
```

### 10.2 è‡ªé€‚åº”å¹³è¡¡ç­–ç•¥


**ğŸ”„ æ ¹æ®è´Ÿè½½æ¨¡å¼è°ƒæ•´ç­–ç•¥**
```java
public class AdaptiveBalanceStrategy {
    
    public void adaptToWorkloadPattern(WorkloadPattern pattern) {
        switch (pattern) {
            case WRITE_HEAVY:
                // å†™å¤šè¯»å°‘ï¼šé™ä½åˆ†è£‚é˜ˆå€¼ï¼Œå‡å°‘é”ç«äº‰
                config.setSplitThreshold(0.85);
                config.setMergeThreshold(0.3);
                config.setDelayedBalanceEnabled(true);
                break;
                
            case READ_HEAVY:
                // è¯»å¤šå†™å°‘ï¼šæé«˜å¡«å……ç‡ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
                config.setSplitThreshold(0.95);
                config.setMergeThreshold(0.5);
                config.setDelayedBalanceEnabled(false);
                break;
                
            case MIXED:
                // è¯»å†™å‡è¡¡ï¼šä½¿ç”¨é»˜è®¤é…ç½®
                config.setSplitThreshold(0.9);
                config.setMergeThreshold(0.4);
                break;
        }
    }
    
    // åŸºäºæ€§èƒ½åé¦ˆçš„åŠ¨æ€è°ƒæ•´
    public void adjustBasedOnPerformance(PerformanceMetrics metrics) {
        if (metrics.getAvgQueryTime() > targetQueryTime * 1.2) {
            // æŸ¥è¯¢æ€§èƒ½ä¸‹é™ï¼Œä¼˜åŒ–æ ‘ç»“æ„
            decreaseMergeThreshold();
        }
        
        if (metrics.getBalanceOperationRate() > 0.1) {
            // å¹³è¡¡æ“ä½œè¿‡é¢‘ç¹ï¼Œè°ƒæ•´é˜ˆå€¼
            increaseSplitThreshold();
        }
    }
}
```

### 10.3 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸš€ æ‰¹é‡å¹³è¡¡å¤„ç†**
```java
public class BatchBalanceProcessor {
    
    public void rebalanceAfterBatch(List<BPlusNode> affectedNodes) {
        // æ”¶é›†éœ€è¦é‡å¹³è¡¡çš„èŠ‚ç‚¹
        Set<BPlusNode> candidates = new HashSet<>(affectedNodes);
        candidates.addAll(getAdjacentNodes(affectedNodes));
        
        // æŒ‰å±‚çº§æ’åºå¤„ç†
        List<BPlusNode> sortedNodes = candidates.stream()
            .sorted(Comparator.comparingInt(BPlusNode::getLevel))
            .collect(Collectors.toList());
        
        // æ‰¹é‡æ‰§è¡Œå¹³è¡¡æ“ä½œ
        for (BPlusNode node : sortedNodes) {
            RebalanceDecision decision = shouldRebalance(node);
            executeRebalance(node, decision);
        }
    }
    
    // é‡åˆ†å¸ƒç®—æ³•ï¼šå¹³è¡¡ç›¸é‚»èŠ‚ç‚¹è´Ÿè½½
    private void redistributeWithSiblings(BPlusNode node) {
        List<BPlusNode> siblings = getSiblings(node);
        int totalKeys = node.getKeyCount() + 
            siblings.stream().mapToInt(BPlusNode::getKeyCount).sum();
        
        int targetKeysPerNode = totalKeys / (siblings.size() + 1);
        redistributeKeys(node, siblings, targetKeysPerNode);
    }
}
```

---

## 11. ğŸ“Š å¹³è¡¡ç»´æŠ¤ç›‘æ§æŒ‡æ ‡è®¾è®¡


### 11.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡


**ğŸ”¸ å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆKPIï¼‰**
```
å¹³è¡¡æ“ä½œé¢‘ç‡ï¼š
â€¢ åˆ†è£‚æ“ä½œæ¬¡æ•°/å°æ—¶
â€¢ åˆå¹¶æ“ä½œæ¬¡æ•°/å°æ—¶
â€¢ å€Ÿç”¨æ“ä½œæ¬¡æ•°/å°æ—¶

å¹³è¡¡æ“ä½œè€—æ—¶ï¼š
â€¢ å¹³å‡åˆ†è£‚æ—¶é—´
â€¢ å¹³å‡åˆå¹¶æ—¶é—´
â€¢ æœ€å¤§æ“ä½œè€—æ—¶

æ ‘å¥åº·åº¦æŒ‡æ ‡ï¼š
â€¢ å¹³å‡èŠ‚ç‚¹å¡«å……ç‡
â€¢ æ ‘é«˜åº¦ç¨³å®šæ€§
â€¢ çƒ­ç‚¹èŠ‚ç‚¹åˆ†å¸ƒ

ç³»ç»Ÿå½±å“æŒ‡æ ‡ï¼š
â€¢ å¹³è¡¡æ“ä½œå¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“
â€¢ é”ç­‰å¾…æ—¶é—´
â€¢ å†…å­˜ä½¿ç”¨å˜åŒ–
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡æ”¶é›†**
```java
public class BalanceMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    private final Map<String, Timer> operationTimers = new ConcurrentHashMap<>();
    
    public void recordBalanceOperation(String operationType, Duration duration, boolean success) {
        // è®°å½•æ“ä½œè€—æ—¶
        Timer timer = operationTimers.computeIfAbsent(operationType, 
            type -> Timer.builder("btree.balance.duration")
                        .tag("operation", type)
                        .register(meterRegistry));
        timer.record(duration);
        
        // è®°å½•æˆåŠŸç‡
        Counter.builder("btree.balance.count")
            .tag("operation", operationType)
            .tag("result", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
    }
    
    public void recordTreeHealth(BPlusTree tree) {
        double avgFillRate = calculateAverageFillRate(tree);
        int treeHeight = tree.getHeight();
        
        Gauge.builder("btree.health.fill_rate")
            .register(meterRegistry, tree, t -> avgFillRate);
            
        Gauge.builder("btree.health.height")
            .register(meterRegistry, tree, t -> treeHeight);
    }
}
```

### 11.2 å‘Šè­¦è§„åˆ™è®¾è®¡


**ğŸš¨ åˆ†çº§å‘Šè­¦ä½“ç³»**

| å‘Šè­¦çº§åˆ« | **è§¦å‘æ¡ä»¶** | **å¤„ç†æ–¹å¼** | **å“åº”æ—¶é—´** |
|----------|-------------|-------------|-------------|
| **ğŸŸ¢ ä¿¡æ¯** | å¡«å……ç‡ < 60% | è®°å½•æ—¥å¿— | æ— éœ€å“åº” |
| **ğŸŸ¡ è­¦å‘Š** | åˆ†è£‚é¢‘ç‡ > 10æ¬¡/åˆ†é’Ÿ | é‚®ä»¶é€šçŸ¥ | 1å°æ—¶å†… |
| **ğŸ”´ é”™è¯¯** | å¹³è¡¡æ“ä½œå¤±è´¥ç‡ > 5% | çŸ­ä¿¡+é‚®ä»¶ | 15åˆ†é’Ÿå†… |
| **ğŸ”´ ä¸¥é‡** | æ ‘é«˜åº¦å¼‚å¸¸å¢é•¿ | ç”µè¯+çŸ­ä¿¡+é‚®ä»¶ | 5åˆ†é’Ÿå†… |

**ğŸ”§ å‘Šè­¦å®ç°**
```java
public class BalanceAlertManager {
    
    public void checkBalanceHealth() {
        for (BPlusTree tree : getAllTrees()) {
            TreeHealthReport report = generateHealthReport(tree);
            
            if (report.getAvgFillRate() < 0.4) {
                sendAlert(AlertLevel.WARNING, "æ ‘å¡«å……ç‡è¿‡ä½: " + report.getAvgFillRate());
            }
            
            if (report.getRebalanceRate() > 0.1) {
                sendAlert(AlertLevel.ERROR, "é‡å¹³è¡¡æ“ä½œè¿‡é¢‘ç¹: " + report.getRebalanceRate());
            }
            
            if (report.getHeightGrowthRate() > 0.05) {
                sendAlert(AlertLevel.CRITICAL, "æ ‘é«˜åº¦å¼‚å¸¸å¢é•¿: " + report.getHeightGrowthRate());
            }
        }
    }
}
```

### 11.3 å¯è§†åŒ–ç›‘æ§é¢æ¿


**ğŸ“Š ç›‘æ§å¤§å±è®¾è®¡**
```
B+æ ‘å¹³è¡¡ç›‘æ§å¤§å±ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¹³è¡¡æ“ä½œç»Ÿè®¡   â”‚    æ€§èƒ½æŒ‡æ ‡     â”‚    å¥åº·åº¦è¯„åˆ†    â”‚
â”‚                â”‚                â”‚                â”‚
â”‚ åˆ†è£‚: 150æ¬¡/å°æ—¶ â”‚ å¹³å‡è€—æ—¶: 5ms   â”‚ æ•´ä½“å¥åº·: 85%   â”‚
â”‚ åˆå¹¶: 80æ¬¡/å°æ—¶  â”‚ æœ€å¤§è€—æ—¶: 50ms  â”‚ å¡«å……ç‡: 78%     â”‚
â”‚ å€Ÿç”¨: 200æ¬¡/å°æ—¶ â”‚ æˆåŠŸç‡: 99.5%   â”‚ å¹³è¡¡åº¦: 92%     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å¹³è¡¡æ“ä½œè¶‹åŠ¿å›¾                         â”‚
â”‚  æ“ä½œæ•°                                             â”‚
â”‚    â†‘                                                â”‚
â”‚ 300â”œâ”€â•­â”€â•®                                           â”‚
â”‚    â”‚  â”‚ â”‚    â•­â”€â•®                                   â”‚
â”‚ 150â”œâ”€â”€â•¯ â•°â”€â”€â”€â”€â•¯ â•°â”€â•®                                 â”‚
â”‚    â”‚             â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’            â”‚
â”‚   0â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´         â”‚
â”‚    12:00  13:00  14:00  15:00  16:00               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 12. âš ï¸ æç«¯åœºæ™¯å¹³è¡¡ç»´æŠ¤ç­–ç•¥


### 12.1 å¤§æ‰¹é‡æ•°æ®æ’å…¥


**ğŸ”¸ æ‰¹é‡æ’å…¥çš„æŒ‘æˆ˜**
```
åœºæ™¯ï¼šçŸ­æ—¶é—´å†…æ’å…¥å¤§é‡æœ‰åºæ•°æ®

é—®é¢˜ï¼š
â€¢ é¢‘ç¹è§¦å‘èŠ‚ç‚¹åˆ†è£‚
â€¢ æ ‘ç»“æ„å¿«é€Ÿå¢é•¿
â€¢ å¤§é‡é”ç«äº‰
â€¢ ç³»ç»Ÿèµ„æºæ¶ˆè€—å‰§å¢

ä¼˜åŒ–ç­–ç•¥ï¼š
1. æš‚åœè‡ªåŠ¨å¹³è¡¡
2. æ‰¹é‡æ’å…¥å®Œæˆåç»Ÿä¸€é‡å¹³è¡¡
3. ä½¿ç”¨æ‰¹é‡æ„å»ºç®—æ³•
4. é¢„åˆ†é…èŠ‚ç‚¹ç©ºé—´
```

**ğŸš€ æ‰¹é‡æ’å…¥ä¼˜åŒ–å®ç°**
```java
public class BulkInsertOptimizer {
    
    public void bulkInsertWithOptimizedBalance(List<KeyValuePair> data) {
        // 1. æš‚åœè‡ªåŠ¨å¹³è¡¡
        balanceManager.pauseAutoBalance();
        
        try {
            // 2. é¢„æ’åºæ•°æ®
            data.sort(Comparator.comparing(KeyValuePair::getKey));
            
            // 3. é¢„ä¼°éœ€è¦çš„èŠ‚ç‚¹æ•°é‡
            int estimatedNodes = estimateRequiredNodes(data.size());
            nodePool.preAllocateNodes(estimatedNodes);
            
            // 4. æ‰¹é‡æ’å…¥
            for (KeyValuePair item : data) {
                insertWithoutBalance(item);
            }
            
            // 5. ç»Ÿä¸€é‡å¹³è¡¡
            globalRebalance();
            
        } finally {
            // 6. æ¢å¤è‡ªåŠ¨å¹³è¡¡
            balanceManager.resumeAutoBalance();
        }
    }
    
    private void globalRebalance() {
        // è‡ªåº•å‘ä¸Šé‡å¹³è¡¡æ•´ä¸ªæ ‘
        List<BPlusNode> leafNodes = getAllLeafNodes();
        for (BPlusNode leaf : leafNodes) {
            if (needsRebalance(leaf)) {
                rebalanceSubtree(leaf);
            }
        }
    }
}
```

### 12.2 æç«¯ååºæ•°æ®å¤„ç†


**ğŸ”„ ååºæ•°æ®çš„ç‰¹æ®Šå¤„ç†**
```java
public class SkewedDataHandler {
    
    // æ£€æµ‹æ•°æ®å€¾æ–œ
    public boolean detectDataSkew(InsertionStats stats) {
        double hotspotRatio = (double) stats.getHotspotInserts() / stats.getTotalInserts();
        return hotspotRatio > 0.8;  // 80%çš„æ’å…¥é›†ä¸­åœ¨å°‘æ•°èŠ‚ç‚¹
    }
    
    // ååºæ•°æ®çš„ç‰¹æ®Šåˆ†è£‚ç­–ç•¥
    public SplitResult handleSkewedSplit(BPlusNode node, InsertionPattern pattern) {
        switch (pattern) {
            case SEQUENTIAL_ASC:
                // é¡ºåºé€’å¢ï¼šåˆ†è£‚ç‚¹åå³ï¼Œå·¦èŠ‚ç‚¹ä¿æŒæ›´å¤šç©ºé—´
                return splitAtRatio(node, 0.3);
                
            case SEQUENTIAL_DESC:
                // é¡ºåºé€’å‡ï¼šåˆ†è£‚ç‚¹åå·¦ï¼Œå³èŠ‚ç‚¹ä¿æŒæ›´å¤šç©ºé—´
                return splitAtRatio(node, 0.7);
                
            case HOTSPOT_CENTER:
                // ä¸­å¿ƒçƒ­ç‚¹ï¼šå‡åŒ€åˆ†è£‚
                return splitAtRatio(node, 0.5);
                
            default:
                return standardSplit(node);
        }
    }
}
```

### 12.3 ç³»ç»Ÿèµ„æºä¸è¶³æ—¶çš„é™çº§ç­–ç•¥


**ğŸ”„ èµ„æºçº¦æŸä¸‹çš„å¹³è¡¡ç­–ç•¥**
```java
public class ResourceConstrainedBalancer {
    
    public void balanceUnderResourceConstraints(SystemResourceState resourceState) {
        if (resourceState.getMemoryUsage() > 0.9) {
            // å†…å­˜ä¸è¶³ï¼šå‡å°‘å¹¶å‘å¹³è¡¡æ“ä½œ
            setMaxConcurrentBalanceOps(2);
            enableAggressiveNodeRecycling(true);
        }
        
        if (resourceState.getCpuUsage() > 0.85) {
            // CPUä¸è¶³ï¼šå¯ç”¨å»¶è¿Ÿå¹³è¡¡
            enableDelayedBalance(true);
            setBalanceBatchSize(500);
        }
        
        if (resourceState.getDiskIOUsage() > 0.8) {
            // IOä¸è¶³ï¼šå‡å°‘æ—¥å¿—è®°å½•
            setBalanceLoggingLevel(LogLevel.ERROR);
            enableCompactLogging(true);
        }
    }
    
    // ç´§æ€¥æƒ…å†µä¸‹çš„æœ€å°åŒ–å¹³è¡¡
    public void emergencyBalance(BPlusNode node) {
        // åªå¤„ç†ä¸¥é‡è¿è§„çš„æƒ…å†µ
        if (node.getKeyCount() > node.getMaxCapacity() * 1.5) {
            quickSplit(node);  // å¿«é€Ÿåˆ†è£‚ï¼Œè·³è¿‡ä¼˜åŒ–
        } else if (node.getKeyCount() < node.getMaxCapacity() * 0.1) {
            quickMerge(node);  // å¿«é€Ÿåˆå¹¶ï¼Œè·³è¿‡æ£€æŸ¥
        }
    }
}
```

### 12.4 æ•…éšœæ¢å¤åœºæ™¯å¤„ç†


**ğŸ› ï¸ ç³»ç»Ÿæ•…éšœåçš„æ¢å¤ç­–ç•¥**
```java
public class FailureRecoveryBalancer {
    
    public void recoverAfterSystemFailure() {
        log.info("å¼€å§‹ç³»ç»Ÿæ•…éšœåçš„å¹³è¡¡æ¢å¤...");
        
        // 1. éªŒè¯æ ‘ç»“æ„å®Œæ•´æ€§
        TreeIntegrityReport integrity = validateTreeIntegrity();
        
        if (!integrity.isValid()) {
            // 2. ä¿®å¤æŸåçš„æ ‘ç»“æ„
            repairCorruptedTree(integrity);
        }
        
        // 3. é‡å»ºå¹³è¡¡çŠ¶æ€
        rebuildBalanceState();
        
        // 4. æ¢å¤æ­£å¸¸å¹³è¡¡æ“ä½œ
        resumeNormalBalance();
    }
    
    private void repairCorruptedTree(TreeIntegrityReport integrity) {
        for (CorruptedNode corruptedNode : integrity.getCorruptedNodes()) {
            switch (corruptedNode.getCorruptionType()) {
                case ORPHANED_NODE:
                    reattachOrphanedNode(corruptedNode);
                    break;
                case BROKEN_POINTER:
                    repairBrokenPointer(corruptedNode);
                    break;
                case INVALID_KEY_ORDER:
                    reorderKeys(corruptedNode);
                    break;
            }
        }
    }
}
```

---

## 13. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 13.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è‡ªå¹³è¡¡ç®—æ³•ï¼šé€šè¿‡åˆ†è£‚ã€åˆå¹¶ã€å€Ÿç”¨æ“ä½œç»´æŒB+æ ‘æ€§è´¨
ğŸ”¸ æ ‘å¹³è¡¡åˆ¤æ–­æ ‡å‡†ï¼šé«˜åº¦å¹³è¡¡+å¡«å……åº¦å¹³è¡¡+è´Ÿè½½å¹³è¡¡
ğŸ”¸ èŠ‚ç‚¹åˆ†è£‚ç­–ç•¥ï¼šæ™ºèƒ½åˆ†è£‚ç‚¹é€‰æ‹©+é¢„æµ‹æ€§åˆ†è£‚
ğŸ”¸ é‡å¹³è¡¡è§¦å‘æ¡ä»¶ï¼šåŸºäºé˜ˆå€¼+è‡ªé€‚åº”è°ƒæ•´
ğŸ”¸ èŠ‚ç‚¹åˆå¹¶é˜ˆå€¼ï¼šæœ€å°å¡«å……åº¦+å…„å¼ŸèŠ‚ç‚¹å®¹é‡æ£€æŸ¥
ğŸ”¸ å¹³è¡¡æ“ä½œäº‹åŠ¡æ€§ï¼šåŸå­æ€§ä¿è¯+æ•…éšœæ¢å¤æœºåˆ¶
ğŸ”¸ å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼šå¤šçº§é”ç­–ç•¥+æ­»é”é¢„é˜²
ğŸ”¸ æ€§èƒ½å¼€é”€åˆ†æï¼šæ—¶é—´æˆæœ¬+å†…å­˜æˆæœ¬+ä¼˜åŒ–ç­–ç•¥
ğŸ”¸ ç­–ç•¥ä¼˜åŒ–ï¼šè‡ªé€‚åº”è°ƒæ•´+æ‰¹é‡å¤„ç†+èµ„æºæ„ŸçŸ¥
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶æŒ‡æ ‡+åˆ†çº§å‘Šè­¦+å¯è§†åŒ–é¢æ¿
ğŸ”¸ æç«¯åœºæ™¯å¤„ç†ï¼šæ‰¹é‡æ•°æ®+ååºå¤„ç†+æ•…éšœæ¢å¤
```

### 13.2 å…³é”®æŠ€æœ¯å†³ç­–ç‚¹


**ğŸ”¹ å¹³è¡¡ç­–ç•¥é€‰æ‹©**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
â€¢ ä¼˜å…ˆé€‰æ‹©å€Ÿç”¨æ“ä½œï¼Œå‡å°‘ç»“æ„å˜åŒ–
â€¢ å¯ç”¨å»¶è¿Ÿå¹³è¡¡ï¼Œæ‰¹é‡å¤„ç†æ“ä½œ
â€¢ ä½¿ç”¨ç»†ç²’åº¦é”ï¼Œå‡å°‘é”ç«äº‰

é«˜æ€§èƒ½è¦æ±‚ï¼š
â€¢ é¢„æµ‹æ€§åˆ†è£‚ï¼Œé¿å…ç´§æ€¥åˆ†è£‚
â€¢ ä¼˜åŒ–åˆ†è£‚ç‚¹é€‰æ‹©ï¼Œå¹³è¡¡è´Ÿè½½
â€¢ å†…å­˜æ± å¤ç”¨ï¼Œå‡å°‘åˆ†é…å¼€é”€

é«˜å¯é æ€§è¦æ±‚ï¼š
â€¢ å®Œæ•´çš„äº‹åŠ¡ä¿æŠ¤æœºåˆ¶
â€¢ è¯¦ç»†çš„æ“ä½œæ—¥å¿—è®°å½•
â€¢ å¿«é€Ÿçš„æ•…éšœæ¢å¤èƒ½åŠ›
```

**ğŸ”¹ æ€§èƒ½ä¸å¯é æ€§çš„å¹³è¡¡**
```
æ€§èƒ½ä¼˜å…ˆç­–ç•¥ï¼š
â€¢ é™ä½äº‹åŠ¡ä¿æŠ¤çº§åˆ«
â€¢ å‡å°‘æ—¥å¿—è®°å½•è¯¦ç»†ç¨‹åº¦
â€¢ å¯ç”¨æ¿€è¿›çš„é¢„åˆ†è£‚ç­–ç•¥

å¯é æ€§ä¼˜å…ˆç­–ç•¥ï¼š
â€¢ å¢å¼ºäº‹åŠ¡ä¿æŠ¤æœºåˆ¶
â€¢ è¯¦ç»†è®°å½•æ‰€æœ‰æ“ä½œ
â€¢ ä¿å®ˆçš„å¹³è¡¡è§¦å‘ç­–ç•¥

å¹³è¡¡ç­–ç•¥ï¼š
â€¢ åˆ†çº§ä¿æŠ¤ï¼šæ ¸å¿ƒæ“ä½œå…¨ä¿æŠ¤ï¼Œè¾…åŠ©æ“ä½œç®€åŒ–ä¿æŠ¤
â€¢ å¯é…ç½®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ä¿æŠ¤çº§åˆ«
â€¢ ç›‘æ§åé¦ˆï¼šåŸºäºå®é™…è¡¨ç°åŠ¨æ€è°ƒæ•´
```

### 13.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ä¸åŒè§„æ¨¡ç³»ç»Ÿçš„å¹³è¡¡ç­–ç•¥**

| ç³»ç»Ÿè§„æ¨¡ | **æ•°æ®é‡** | **å¹¶å‘é‡** | **æ¨èç­–ç•¥** | **å…³é”®é…ç½®** |
|----------|-----------|-----------|-------------|-------------|
| **å°å‹** | < 1GB | < 100 QPS | ç®€å•é˜ˆå€¼è§¦å‘ | é»˜è®¤é…ç½®å³å¯ |
| **ä¸­å‹** | 1-100GB | 100-1000 QPS | è‡ªé€‚åº”+æ‰¹é‡ä¼˜åŒ– | è°ƒä¼˜é˜ˆå€¼+å¹¶å‘æ§åˆ¶ |
| **å¤§å‹** | 100GB-1TB | 1000-10000 QPS | æ™ºèƒ½ç­–ç•¥+ç›‘æ§å‘Šè­¦ | å…¨é¢ä¼˜åŒ–+å®æ—¶ç›‘æ§ |
| **è¶…å¤§å‹** | > 1TB | > 10000 QPS | åˆ†ç‰‡+ä¸“ç”¨ä¼˜åŒ– | å®šåˆ¶åŒ–è§£å†³æ–¹æ¡ˆ |

**ğŸ¯ è¿ç»´æœ€ä½³å®è·µ**
```
æ—¥å¸¸ç›‘æ§ï¼š
â€¢ æ¯å°æ—¶æ£€æŸ¥æ ‘å¥åº·åº¦æŒ‡æ ‡
â€¢ ç›‘æ§å¹³è¡¡æ“ä½œé¢‘ç‡å’Œè€—æ—¶
â€¢ å…³æ³¨ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

æ€§èƒ½è°ƒä¼˜ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´å¹³è¡¡é˜ˆå€¼
â€¢ ä¼˜åŒ–æ‰¹é‡æ“ä½œçš„å¤„ç†ç­–ç•¥
â€¢ å®šæœŸåˆ†æå’Œä¼˜åŒ–çƒ­ç‚¹é—®é¢˜

æ•…éšœé¢„é˜²ï¼š
â€¢ å»ºç«‹å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»
â€¢ å®šæœŸè¿›è¡Œæ•…éšœæ¢å¤æ¼”ç»ƒ
â€¢ ä¿æŒå……è¶³çš„ç³»ç»Ÿèµ„æºä½™é‡
```

### 13.4 å­¦ä¹ è¦ç‚¹å¼ºåŒ–


**ğŸ’¡ æ ¸å¿ƒç†è§£æ£€æŸ¥æ¸…å•**
- [ ] èƒ½è§£é‡ŠB+æ ‘ä¸ºä»€ä¹ˆéœ€è¦å¹³è¡¡ç»´æŠ¤
- [ ] æŒæ¡èŠ‚ç‚¹åˆ†è£‚å’Œåˆå¹¶çš„åŸºæœ¬åŸç†
- [ ] ç†è§£å¹¶å‘æ§åˆ¶çš„é‡è¦æ€§å’Œå®ç°æ–¹æ³•
- [ ] äº†è§£æ€§èƒ½ä¼˜åŒ–çš„ä¸»è¦ç­–ç•¥
- [ ] çŸ¥é“å¦‚ä½•ç›‘æ§å’Œè°ƒä¼˜å¹³è¡¡ç³»ç»Ÿ

**ğŸ§  è®°å¿†è¦ç‚¹**
```
å¹³è¡¡ç»´æŠ¤ä¸‰è¦ç´ ï¼š
â€¢ è§¦å‘æ¡ä»¶è¦åˆç†ï¼ˆä¸èƒ½å¤ªæ•æ„Ÿä¹Ÿä¸èƒ½å¤ªè¿Ÿé’ï¼‰
â€¢ æ“ä½œè¿‡ç¨‹è¦åŸå­ï¼ˆè¦ä¹ˆæˆåŠŸè¦ä¹ˆå›æ»šï¼‰
â€¢ æ€§èƒ½å½±å“è¦å¯æ§ï¼ˆä¸èƒ½å› ä¸ºå¹³è¡¡å½±å“æ­£å¸¸ä¸šåŠ¡ï¼‰

æŠ€æœ¯é€‰æ‹©åŸåˆ™ï¼š
â€¢ å°ç³»ç»Ÿç”¨ç®€å•ç­–ç•¥
â€¢ å¤§ç³»ç»Ÿç”¨æ™ºèƒ½ç­–ç•¥
â€¢ å…³é”®ç³»ç»Ÿç”¨å¯é ç­–ç•¥
```

**âš¡ å®æˆ˜åº”ç”¨ä»·å€¼**
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šç†è§£ç´¢å¼•è‡ªåŠ¨ç»´æŠ¤æœºåˆ¶ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
- **ç³»ç»Ÿè®¾è®¡**ï¼šè®¾è®¡é«˜æ€§èƒ½çš„æ ‘å½¢æ•°æ®ç»“æ„
- **æ•…éšœè¯Šæ–­**ï¼šåˆ†æB+æ ‘æ€§èƒ½é—®é¢˜çš„æ ¹æœ¬åŸå› 
- **å®¹é‡è§„åˆ’**ï¼šè¯„ä¼°å¹³è¡¡ç»´æŠ¤å¯¹ç³»ç»Ÿèµ„æºçš„éœ€æ±‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ’¡ "å¹³è¡¡ç»´æŠ¤å…­å­—è¯€"
åˆ†è£‚åˆå¹¶è¦æ™ºèƒ½ï¼Œè§¦å‘æ¡ä»¶éœ€ç²¾å‡†
å¹¶å‘æ§åˆ¶é˜²å†²çªï¼Œäº‹åŠ¡ä¿è¯åŸå­æ€§
æ€§èƒ½ç›‘æ§å…¨è¦†ç›–ï¼Œæç«¯åœºæ™¯æœ‰é¢„æ¡ˆ
```

**ğŸ¯ æ ¸å¿ƒç†è§£**ï¼š
- B+æ ‘å¹³è¡¡ç»´æŠ¤æ˜¯ä¿è¯ç´¢å¼•æ€§èƒ½çš„å…³é”®æœºåˆ¶
- å¹³è¡¡æ“ä½œçš„ä»£ä»·éœ€è¦ä¸æ€§èƒ½æ”¶ç›Šå¹³è¡¡
- å¹¶å‘ç¯å¢ƒä¸‹çš„å¹³è¡¡ç»´æŠ¤éœ€è¦ç²¾å¿ƒè®¾è®¡
- ç›‘æ§å’Œè°ƒä¼˜æ˜¯å¹³è¡¡ç³»ç»Ÿé•¿æœŸç¨³å®šè¿è¡Œçš„ä¿éšœ