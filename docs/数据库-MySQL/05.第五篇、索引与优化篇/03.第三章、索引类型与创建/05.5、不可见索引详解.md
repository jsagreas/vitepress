---
title: 5ã€ä¸å¯è§ç´¢å¼•è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [ä¸å¯è§ç´¢å¼•åŸºç¡€æ¦‚å¿µ](#1-ä¸å¯è§ç´¢å¼•åŸºç¡€æ¦‚å¿µ)
2. [INVISIBLEç´¢å¼•å±æ€§è¯¦è§£](#2-INVISIBLEç´¢å¼•å±æ€§è¯¦è§£)
3. [ä¼˜åŒ–å™¨å¿½ç•¥æœºåˆ¶åŸç†](#3-ä¼˜åŒ–å™¨å¿½ç•¥æœºåˆ¶åŸç†)
4. [ç´¢å¼•å¯è§æ€§åˆ‡æ¢ç®¡ç†](#4-ç´¢å¼•å¯è§æ€§åˆ‡æ¢ç®¡ç†)
5. [ä¸å¯è§ç´¢å¼•ç›‘æ§ç­–ç•¥](#5-ä¸å¯è§ç´¢å¼•ç›‘æ§ç­–ç•¥)
6. [ç´¢å¼•A/Bæµ‹è¯•æ–¹æ³•](#6-ç´¢å¼•A/Bæµ‹è¯•æ–¹æ³•)
7. [ç”Ÿäº§ç¯å¢ƒå®‰å…¨æµ‹è¯•](#7-ç”Ÿäº§ç¯å¢ƒå®‰å…¨æµ‹è¯•)
8. [ç´¢å¼•å½±å“è¯„ä¼°å·¥å…·](#8-ç´¢å¼•å½±å“è¯„ä¼°å·¥å…·)
9. [ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ](#9-ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä¸å¯è§ç´¢å¼•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ä¸å¯è§ç´¢å¼•


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
ä¸å¯è§ç´¢å¼•æ˜¯MySQL 8.0å¼•å…¥çš„ä¸€ä¸ªç‰¹æ®Šç´¢å¼•å±æ€§ã€‚ç®€å•æ¥è¯´ï¼Œ**ä¸å¯è§ç´¢å¼•å°±åƒæ˜¯ä¸€ä¸ª"éšèº«"çš„ç´¢å¼•** - å®ƒç¡®å®å­˜åœ¨äºè¡¨ä¸­ï¼ŒMySQLä¼šæ­£å¸¸ç»´æŠ¤å®ƒï¼Œä½†æ˜¯æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼š"è§†è€Œä¸è§"ï¼Œä¸ä¼šåœ¨æ‰§è¡Œè®¡åˆ’ä¸­ä½¿ç”¨å®ƒã€‚

```
å½¢è±¡æ¯”å–»ï¼š
å°±åƒç»™ç´¢å¼•æˆ´äº†ä¸€ä¸ª"éšèº«æ–—ç¯·"
â”œâ”€ ç´¢å¼•ç»“æ„ï¼šå®Œå¥½å­˜åœ¨ï¼Œæ­£å¸¸ç»´æŠ¤
â”œâ”€ æ•°æ®æ›´æ–°ï¼šç…§å¸¸æ›´æ–°ç´¢å¼•
â”œâ”€ æŸ¥è¯¢ä¼˜åŒ–ï¼šä¼˜åŒ–å™¨å‡è£…å®ƒä¸å­˜åœ¨
â””â”€ æ‰‹åŠ¨æŒ‡å®šï¼šå¼ºåˆ¶ä½¿ç”¨æ—¶ä»ç„¶æœ‰æ•ˆ
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ä¸å¯è§ç´¢å¼•ï¼Ÿ**
åœ¨ä¼ ç»ŸMySQLä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³æµ‹è¯•åˆ é™¤ä¸€ä¸ªç´¢å¼•å¯¹æ€§èƒ½çš„å½±å“ï¼Œåªèƒ½ï¼š
1. åˆ é™¤ç´¢å¼• â†’ æµ‹è¯•æ€§èƒ½ â†’ å‘ç°é—®é¢˜ â†’ é‡æ–°åˆ›å»ºç´¢å¼•

è¿™ä¸ªè¿‡ç¨‹é£é™©å¾ˆé«˜ï¼Œé‡æ–°åˆ›å»ºç´¢å¼•è€—æ—¶å¾ˆé•¿ã€‚ä¸å¯è§ç´¢å¼•è®©æˆ‘ä»¬å¯ä»¥ï¼š
1. è®¾ä¸ºä¸å¯è§ â†’ æµ‹è¯•æ€§èƒ½ â†’ å‘ç°é—®é¢˜ â†’ è®¾ä¸ºå¯è§ï¼ˆç¬é—´å®Œæˆï¼‰

### 1.2 ä¸å¯è§ç´¢å¼•çš„å·¥ä½œæœºåˆ¶


**ğŸ”„ å·¥ä½œåŸç†å›¾è§£**
```
æŸ¥è¯¢æ‰§è¡Œæµç¨‹å¯¹æ¯”ï¼š

æ™®é€šç´¢å¼•ï¼š
SQLæŸ¥è¯¢ â”€â”€â–¶ æŸ¥è¯¢ä¼˜åŒ–å™¨ â”€â”€â–¶ æ£€æŸ¥æ‰€æœ‰ç´¢å¼• â”€â”€â–¶ é€‰æ‹©æœ€ä¼˜ç´¢å¼• â”€â”€â–¶ æ‰§è¡Œ

ä¸å¯è§ç´¢å¼•ï¼š
SQLæŸ¥è¯¢ â”€â”€â–¶ æŸ¥è¯¢ä¼˜åŒ–å™¨ â”€â”€â–¶ å¿½ç•¥ä¸å¯è§ç´¢å¼• â”€â”€â–¶ ä»å¯è§ç´¢å¼•ä¸­é€‰æ‹© â”€â”€â–¶ æ‰§è¡Œ
                            â”‚
                            â–¼
                      ä¸å¯è§ç´¢å¼•ä»ç„¶è¢«ç»´æŠ¤
                      (INSERT/UPDATE/DELETEä¼šæ›´æ–°)
```

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹æ€»ç»“**
```
å­˜åœ¨ä½†ä¸è¢«ä½¿ç”¨ï¼š
âœ… ç´¢å¼•ç‰©ç†å­˜åœ¨äºç£ç›˜
âœ… æ•°æ®å˜æ›´æ—¶æ­£å¸¸ç»´æŠ¤  
âœ… å¯ä»¥éšæ—¶åˆ‡æ¢å¯è§æ€§
âŒ ä¼˜åŒ–å™¨ä¸ä¼šé€‰æ‹©ä½¿ç”¨
âŒ ä¸å½±å“æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
```

### 1.3 MySQL8.0ç‰¹æ€§èƒŒæ™¯


**ğŸ“ˆ ä¸ºä»€ä¹ˆMySQL 8.0å¼•å…¥è¿™ä¸ªç‰¹æ€§ï¼Ÿ**
```
å®é™…ä¸šåŠ¡ç—›ç‚¹ï¼š

ç´¢å¼•ç®¡ç†éš¾é¢˜
â”œâ”€ ä¸æ•¢åˆ é™¤"å¯èƒ½æœ‰ç”¨"çš„ç´¢å¼•
â”œâ”€ åˆ é™¤åå‘ç°å½±å“æ€§èƒ½éš¾ä»¥å¿«é€Ÿæ¢å¤
â”œâ”€ ç´¢å¼•è¿‡å¤šå½±å“å†™å…¥æ€§èƒ½
â””â”€ ç¼ºå°‘å®‰å…¨çš„ç´¢å¼•æµ‹è¯•æ–¹æ³•

è§£å†³æ–¹æ¡ˆä»·å€¼
â”œâ”€ å®‰å…¨çš„ç´¢å¼•åˆ é™¤éªŒè¯
â”œâ”€ é›¶åœæœºçš„ç´¢å¼•æµ‹è¯•  
â”œâ”€ æ¸è¿›å¼ç´¢å¼•ä¼˜åŒ–
â””â”€ A/Bæµ‹è¯•æ”¯æŒ
```

---

## 2. âš™ï¸ INVISIBLEç´¢å¼•å±æ€§è¯¦è§£


### 2.1 INVISIBLEå±æ€§è¯­æ³•


**ğŸ”§ åˆ›å»ºä¸å¯è§ç´¢å¼•**
```sql
-- åˆ›å»ºè¡¨æ—¶æŒ‡å®šä¸å¯è§ç´¢å¼•
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100),
    created_at TIMESTAMP,
    INDEX idx_email (email) INVISIBLE,    -- åˆ›å»ºæ—¶å°±æ˜¯ä¸å¯è§
    INDEX idx_created (created_at)        -- æ™®é€šå¯è§ç´¢å¼•
);

-- æ·»åŠ ä¸å¯è§ç´¢å¼•åˆ°ç°æœ‰è¡¨
ALTER TABLE users ADD INDEX idx_name (name) INVISIBLE;

-- åˆ›å»ºå¯è§ç´¢å¼•ç„¶åè®¾ä¸ºä¸å¯è§
CREATE INDEX idx_temp ON users (name, email);
ALTER TABLE users ALTER INDEX idx_temp INVISIBLE;
```

**ğŸ”„ å¯è§æ€§åˆ‡æ¢æ“ä½œ**
```sql
-- è®¾ç½®ç´¢å¼•ä¸ºä¸å¯è§
ALTER TABLE users ALTER INDEX idx_name INVISIBLE;

-- è®¾ç½®ç´¢å¼•ä¸ºå¯è§  
ALTER TABLE users ALTER INDEX idx_name VISIBLE;

-- æŸ¥çœ‹ç´¢å¼•å¯è§æ€§çŠ¶æ€
SHOW INDEX FROM users;
-- æˆ–è€…æŸ¥è¯¢ç³»ç»Ÿè¡¨
SELECT 
    INDEX_NAME,
    IS_VISIBLE
FROM information_schema.STATISTICS 
WHERE TABLE_NAME = 'users' 
  AND TABLE_SCHEMA = 'test_db';
```

### 2.2 ä¸å¯è§ç´¢å¼•é™åˆ¶æ¡ä»¶


**âš ï¸ é‡è¦é™åˆ¶è¯´æ˜**
```
ä¸»é”®ç´¢å¼•é™åˆ¶ï¼š
âŒ ä¸»é”®ç´¢å¼•ä¸èƒ½è®¾ä¸ºä¸å¯è§
âŒ å”¯ä¸€çº¦æŸç´¢å¼•ä¸èƒ½è®¾ä¸ºä¸å¯è§
âŒ å¤–é”®çº¦æŸä½¿ç”¨çš„ç´¢å¼•ä¸èƒ½è®¾ä¸ºä¸å¯è§

åŸå› è§£é‡Šï¼š
â”œâ”€ ä¸»é”®ï¼šä¿è¯å”¯ä¸€æ€§ï¼Œå¿…é¡»å¯è§
â”œâ”€ å”¯ä¸€çº¦æŸï¼šä¿è¯æ•°æ®å®Œæ•´æ€§
â””â”€ å¤–é”®ï¼šä¿è¯å¼•ç”¨å®Œæ•´æ€§

ç³»ç»Ÿè¡¨é™åˆ¶ï¼š
âŒ ç³»ç»Ÿæ•°æ®åº“(mysqlã€sys)ä¸­çš„ç´¢å¼•ä¸èƒ½è®¾ä¸ºä¸å¯è§
âŒ å†…éƒ¨ä¸´æ—¶è¡¨ç´¢å¼•ä¸æ”¯æŒ
```

**ğŸ’¡ æ­£ç¡®ç†è§£é™åˆ¶çš„å«ä¹‰**
è¿™äº›é™åˆ¶æ˜¯ä¸ºäº†ä¿è¯æ•°æ®åº“çš„å®Œæ•´æ€§ã€‚å°±åƒæˆ¿å­çš„æ‰¿é‡å¢™ä¸èƒ½éšä¾¿æ‹†é™¤ä¸€æ ·ï¼Œä¿è¯æ•°æ®å®Œæ•´æ€§çš„ç´¢å¼•ä¹Ÿä¸èƒ½éšä¾¿"éšè—"ã€‚

### 2.3 ç´¢å¼•çŠ¶æ€ç®¡ç†


**ğŸ“Š ç´¢å¼•çŠ¶æ€æŸ¥è¯¢æ–¹æ³•**
```sql
-- æ–¹æ³•1ï¼šä½¿ç”¨SHOW INDEXæŸ¥çœ‹
SHOW INDEX FROM users\G

-- è¾“å‡ºç¤ºä¾‹ï¼š
*************************** 1. row ***************************
Table: users
Non_unique: 1
Key_name: idx_name
Seq_in_index: 1  
Column_name: name
Collation: A
Cardinality: 1000
Sub_part: NULL
Packed: NULL
Null: YES
Index_type: BTREE
Comment: 
Index_comment: 
Visible: NO          -- è¿™é‡Œæ˜¾ç¤ºç´¢å¼•æ˜¯å¦å¯è§

-- æ–¹æ³•2ï¼šæŸ¥è¯¢information_schema
SELECT 
    TABLE_NAME,
    INDEX_NAME, 
    COLUMN_NAME,
    IS_VISIBLE
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
  AND IS_VISIBLE = 'NO';  -- æŸ¥æ‰¾æ‰€æœ‰ä¸å¯è§ç´¢å¼•
```

---

## 3. ğŸ§  ä¼˜åŒ–å™¨å¿½ç•¥æœºåˆ¶åŸç†


### 3.1 æŸ¥è¯¢ä¼˜åŒ–å™¨å·¥ä½œæµç¨‹


**ğŸ”„ ä¼˜åŒ–å™¨å¤„ç†æµç¨‹å¯¹æ¯”**
```
ä¼˜åŒ–å™¨ç´¢å¼•é€‰æ‹©æµç¨‹ï¼š

ä¼ ç»Ÿæ¨¡å¼ï¼ˆæ‰€æœ‰ç´¢å¼•å¯è§ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLæŸ¥è¯¢    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æSQLè¯­å¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ‰«ææ‰€æœ‰ç´¢å¼• â”‚ â† åŒ…å«æ‰€æœ‰å·²åˆ›å»ºçš„ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è®¡ç®—æ‰§è¡Œæˆæœ¬ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸å¯è§ç´¢å¼•æ¨¡å¼:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLæŸ¥è¯¢    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æSQLè¯­å¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿‡æ»¤å¯è§ç´¢å¼• â”‚ â† è‡ªåŠ¨å¿½ç•¥INVISIBLEç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è®¡ç®—æ‰§è¡Œæˆæœ¬ â”‚ â† åªè€ƒè™‘å¯è§ç´¢å¼•
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ â”‚ â† ç»“æœå¯èƒ½ä¸åŒï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ‰§è¡Œè®¡åˆ’éªŒè¯æ–¹æ³•


**ğŸ“Š æŸ¥è¯¢è®¡åˆ’å¯¹æ¯”åˆ†æ**
```sql
-- åˆ›å»ºæµ‹è¯•è¡¨å’Œæ•°æ®
CREATE TABLE test_table (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    email VARCHAR(100),
    age INT,
    INDEX idx_name (name),
    INDEX idx_email (email) INVISIBLE    -- ä¸å¯è§ç´¢å¼•
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_table (name, email, age) 
SELECT 
    CONCAT('user_', n),
    CONCAT('user', n, '@test.com'),
    18 + (n % 50)
FROM (
    SELECT @n := @n + 1 AS n
    FROM information_schema.tables t1, 
         information_schema.tables t2,
         (SELECT @n := 0) r
    LIMIT 10000
) numbers;

-- æµ‹è¯•æŸ¥è¯¢1ï¼šæŒ‰emailæŸ¥è¯¢
EXPLAIN FORMAT=JSON 
SELECT * FROM test_table WHERE email = 'user500@test.com';
-- ç»“æœï¼šä¼šä½¿ç”¨å…¨è¡¨æ‰«æï¼Œå› ä¸ºidx_emailä¸å¯è§

-- è®¾ç½®ç´¢å¼•ä¸ºå¯è§åæµ‹è¯•
ALTER TABLE test_table ALTER INDEX idx_email VISIBLE;
EXPLAIN FORMAT=JSON 
SELECT * FROM test_table WHERE email = 'user500@test.com';
-- ç»“æœï¼šä¼šä½¿ç”¨idx_emailç´¢å¼•
```

**ğŸ” æ‰§è¡Œè®¡åˆ’å·®å¼‚åˆ†æ**
```
ä¸å¯è§ç´¢å¼•æ—¶çš„æ‰§è¡Œè®¡åˆ’ï¼š
{
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1021.25"    -- æˆæœ¬å¾ˆé«˜
    },
    "table": {
      "table_name": "test_table",
      "access_type": "ALL",      -- å…¨è¡¨æ‰«æ
      "rows_examined_per_scan": 10000,
      "filtered": "10.00"
    }
  }
}

ç´¢å¼•å¯è§æ—¶çš„æ‰§è¡Œè®¡åˆ’ï¼š
{
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "1.20"       -- æˆæœ¬å¤§å¹…é™ä½  
    },
    "table": {
      "table_name": "test_table",
      "access_type": "ref",      -- ç´¢å¼•æŸ¥æ‰¾
      "possible_keys": ["idx_email"],
      "key": "idx_email",        -- ä½¿ç”¨äº†ç´¢å¼•
      "rows_examined_per_scan": 1,
      "filtered": "100.00"
    }
  }
}
```

### 3.3 å¼ºåˆ¶ä½¿ç”¨ä¸å¯è§ç´¢å¼•


**ğŸ¯ ç‰¹æ®Šæƒ…å†µä¸‹å¼ºåˆ¶ä½¿ç”¨**
```sql
-- å³ä½¿ç´¢å¼•ä¸å¯è§ï¼Œä¹Ÿå¯ä»¥é€šè¿‡USE INDEXå¼ºåˆ¶ä½¿ç”¨
SELECT * FROM test_table 
USE INDEX (idx_email)  -- å¼ºåˆ¶ä½¿ç”¨ä¸å¯è§ç´¢å¼•
WHERE email = 'user500@test.com';

-- æˆ–è€…é€šè¿‡optimizer_switchä¸´æ—¶å¯ç”¨
SET SESSION optimizer_switch = 'use_invisible_indexes=on';
SELECT * FROM test_table WHERE email = 'user500@test.com';
SET SESSION optimizer_switch = 'use_invisible_indexes=off';
```

è¿™ä¸ªç‰¹æ€§è®©æˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™éªŒè¯ä¸å¯è§ç´¢å¼•çš„æ•ˆæœï¼Œè€Œä¸å½±å“æ­£å¸¸çš„æŸ¥è¯¢ä¼˜åŒ–ã€‚

---

## 4. ğŸ”„ ç´¢å¼•å¯è§æ€§åˆ‡æ¢ç®¡ç†


### 4.1 åˆ‡æ¢æ“ä½œè¯¦è§£


**âš¡ å¯è§æ€§åˆ‡æ¢çš„å³æ—¶æ€§**
```sql
-- æ¼”ç¤ºåˆ‡æ¢çš„å³æ—¶æ€§
-- å‡†å¤‡ï¼šåˆ›å»ºä¸€ä¸ªå¯è§ç´¢å¼•
CREATE INDEX idx_test ON test_table (age);

-- æŸ¥çœ‹å½“å‰çŠ¶æ€
SELECT COUNT(*) FROM test_table WHERE age = 25;
-- ä½¿ç”¨EXPLAINç¡®è®¤ä½¿ç”¨äº†idx_test

-- è®¾ç½®ä¸ºä¸å¯è§ï¼ˆç¬é—´å®Œæˆï¼‰
ALTER TABLE test_table ALTER INDEX idx_test INVISIBLE;

-- ç«‹å³å†æ¬¡æŸ¥è¯¢ï¼Œæ‰§è¡Œè®¡åˆ’å·²ç»æ”¹å˜
EXPLAIN SELECT COUNT(*) FROM test_table WHERE age = 25;
-- ç°åœ¨ä¸å†ä½¿ç”¨idx_testï¼Œå¯èƒ½ä½¿ç”¨å…¨è¡¨æ‰«æ

-- è®¾ç½®ä¸ºå¯è§ï¼ˆç¬é—´å®Œæˆï¼‰  
ALTER TABLE test_table ALTER INDEX idx_test VISIBLE;
```

**ğŸ”¸ åˆ‡æ¢æ“ä½œçš„ç‰¹ç‚¹**
- **ç¬é—´å®Œæˆ**ï¼šä¸éœ€è¦é‡å»ºç´¢å¼•ï¼Œåªæ˜¯æ”¹å˜å±æ€§
- **æ— é”æ“ä½œ**ï¼šä¸ä¼šé˜»å¡æ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
- **ç«‹å³ç”Ÿæ•ˆ**ï¼šæ–°çš„æŸ¥è¯¢ç«‹å³ä½¿ç”¨æ–°çš„å¯è§æ€§è®¾ç½®
- **å¯é€†æ“ä½œ**ï¼šå¯ä»¥éšæ—¶åœ¨å¯è§å’Œä¸å¯è§é—´åˆ‡æ¢

### 4.2 æ‰¹é‡ç®¡ç†ç­–ç•¥


**ğŸ“‹ æ‰¹é‡ç´¢å¼•å¯è§æ€§ç®¡ç†**
```sql
-- æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å†—ä½™ç´¢å¼•
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) AS columns,
    IS_VISIBLE
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'your_database'
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_NAME, INDEX_NAME, IS_VISIBLE
ORDER BY TABLE_NAME, INDEX_NAME;

-- æ‰¹é‡è®¾ç½®æµ‹è¯•ç´¢å¼•ä¸ºä¸å¯è§
SET @sql = '';
SELECT GROUP_CONCAT(
    CONCAT('ALTER TABLE ', TABLE_NAME, 
           ' ALTER INDEX ', INDEX_NAME, ' INVISIBLE;')
    SEPARATOR '\n'
) INTO @sql
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
  AND INDEX_NAME LIKE 'idx_test_%'
  AND IS_VISIBLE = 'YES';

-- æ‰§è¡Œæ‰¹é‡æ“ä½œï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
-- PREPARE stmt FROM @sql;
-- EXECUTE stmt;
```

### 4.3 ç´¢å¼•å¯è§æ€§ç®¡ç†ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨ç®¡ç†ç­–ç•¥**
```
ç®¡ç†ç­–ç•¥æ¡†æ¶ï¼š

æƒé™æ§åˆ¶ç­–ç•¥
â”œâ”€ åªæœ‰DBAå…·æœ‰ALTER INDEXæƒé™
â”œâ”€ å¼€å‘äººå‘˜é€šè¿‡å·¥å•ç”³è¯·
â”œâ”€ å»ºç«‹å®¡æ‰¹æµç¨‹å’Œå˜æ›´è®°å½•
â””â”€ é‡è¦ç´¢å¼•è®¾ç½®ä¿æŠ¤æœºåˆ¶

å˜æ›´è®°å½•ç­–ç•¥  
â”œâ”€ è®°å½•æ¯æ¬¡å¯è§æ€§å˜æ›´
â”œâ”€ åŒ…å«å˜æ›´åŸå› å’Œå½±å“åˆ†æ
â”œâ”€ å»ºç«‹å›é€€æ—¶é—´çª—å£
â””â”€ å®šæœŸå®¡è®¡ç´¢å¼•çŠ¶æ€

ç›‘æ§å‘Šè­¦ç­–ç•¥
â”œâ”€ ç›‘æ§ä¸å¯è§ç´¢å¼•æ•°é‡å˜åŒ–
â”œâ”€ å…³æ³¨æŸ¥è¯¢æ€§èƒ½å¼‚å¸¸
â”œâ”€ è®¾ç½®ç´¢å¼•ä½¿ç”¨ç‡å‘Šè­¦
â””â”€ è‡ªåŠ¨æ£€æµ‹å¯è§æ€§å¼‚å¸¸å˜æ›´
```

---

## 5. ğŸ“Š ä¸å¯è§ç´¢å¼•ç›‘æ§ç­–ç•¥


### 5.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
ç´¢å¼•çŠ¶æ€ç›‘æ§ï¼š

æ•°é‡ç»Ÿè®¡æŒ‡æ ‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ€»ç´¢å¼•æ•°é‡                    â”‚
â”‚ â€¢ å¯è§ç´¢å¼•æ•°é‡                  â”‚
â”‚ â€¢ ä¸å¯è§ç´¢å¼•æ•°é‡                â”‚
â”‚ â€¢ ä¸å¯è§ç´¢å¼•å æ¯”                â”‚
â”‚ â€¢ æŒ‰è¡¨ç»Ÿè®¡çš„ç´¢å¼•åˆ†å¸ƒ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€§èƒ½å½±å“æŒ‡æ ‡  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æŸ¥è¯¢å“åº”æ—¶é—´å˜åŒ–              â”‚
â”‚ â€¢ å…¨è¡¨æ‰«ææ¬¡æ•°ç»Ÿè®¡              â”‚
â”‚ â€¢ æ…¢æŸ¥è¯¢æ•°é‡å˜åŒ–                â”‚
â”‚ â€¢ CPUå’ŒIOä½¿ç”¨ç‡å˜åŒ–             â”‚
â”‚ â€¢ å¹¶å‘æŸ¥è¯¢å¤„ç†èƒ½åŠ›              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨æƒ…å†µæŒ‡æ ‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç´¢å¼•å‘½ä¸­ç‡ç»Ÿè®¡                â”‚
â”‚ â€¢ æœªä½¿ç”¨ç´¢å¼•è¯†åˆ«                â”‚  
â”‚ â€¢ å†—ä½™ç´¢å¼•æ£€æµ‹                  â”‚
â”‚ â€¢ ç´¢å¼•ç»´æŠ¤å¼€é”€ç»Ÿè®¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç›‘æ§æŸ¥è¯¢è„šæœ¬


**ğŸ” å®ç”¨ç›‘æ§æŸ¥è¯¢**
```sql
-- 1. æ£€æŸ¥æ‰€æœ‰ä¸å¯è§ç´¢å¼•
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    INDEX_NAME,
    COLUMN_NAME,
    IS_VISIBLE,
    CASE 
        WHEN IS_VISIBLE = 'NO' THEN 'ğŸ”¸ ä¸å¯è§'
        ELSE 'âœ… å¯è§'
    END AS çŠ¶æ€æ˜¾ç¤º
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')
  AND IS_VISIBLE = 'NO'
ORDER BY TABLE_SCHEMA, TABLE_NAME;

-- 2. ç»Ÿè®¡å„è¡¨çš„ç´¢å¼•å¯è§æ€§åˆ†å¸ƒ
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    COUNT(*) AS æ€»ç´¢å¼•æ•°,
    SUM(CASE WHEN IS_VISIBLE = 'YES' THEN 1 ELSE 0 END) AS å¯è§ç´¢å¼•æ•°,
    SUM(CASE WHEN IS_VISIBLE = 'NO' THEN 1 ELSE 0 END) AS ä¸å¯è§ç´¢å¼•æ•°,
    ROUND(
        SUM(CASE WHEN IS_VISIBLE = 'NO' THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 
        2
    ) AS ä¸å¯è§ç´¢å¼•å æ¯”
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_SCHEMA, TABLE_NAME
HAVING ä¸å¯è§ç´¢å¼•æ•° > 0
ORDER BY ä¸å¯è§ç´¢å¼•å æ¯” DESC;

-- 3. æ‰¾å‡ºå¯èƒ½éœ€è¦æ¸…ç†çš„é•¿æœŸä¸å¯è§ç´¢å¼•
SELECT 
    s.TABLE_SCHEMA,
    s.TABLE_NAME, 
    s.INDEX_NAME,
    s.COLUMN_NAME,
    'é•¿æœŸä¸å¯è§ï¼Œå»ºè®®è¯„ä¼°æ˜¯å¦åˆ é™¤' AS å»ºè®®
FROM information_schema.STATISTICS s
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage u
    ON s.TABLE_SCHEMA = u.OBJECT_SCHEMA
   AND s.TABLE_NAME = u.OBJECT_NAME  
   AND s.INDEX_NAME = u.INDEX_NAME
WHERE s.IS_VISIBLE = 'NO'
  AND (u.COUNT_READ IS NULL OR u.COUNT_READ = 0)  -- ä»æœªè¢«è¯»å–
  AND s.TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema');
```

### 5.3 æ€§èƒ½å½±å“ç›‘æ§


**ğŸ“Š æ€§èƒ½ç›‘æ§Dashboard**
```sql
-- åˆ›å»ºç›‘æ§è§†å›¾ï¼šç´¢å¼•ä½¿ç”¨æƒ…å†µæ±‡æ€»
CREATE OR REPLACE VIEW v_index_usage_summary AS
SELECT 
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    COUNT(DISTINCT s.INDEX_NAME) AS æ€»ç´¢å¼•æ•°,
    COUNT(DISTINCT CASE WHEN s.IS_VISIBLE = 'YES' THEN s.INDEX_NAME END) AS å¯è§ç´¢å¼•æ•°,
    COUNT(DISTINCT CASE WHEN s.IS_VISIBLE = 'NO' THEN s.INDEX_NAME END) AS ä¸å¯è§ç´¢å¼•æ•°,
    COUNT(DISTINCT u.INDEX_NAME) AS æœ‰ä½¿ç”¨è®°å½•ç´¢å¼•æ•°,
    ROUND(
        COUNT(DISTINCT u.INDEX_NAME) * 100.0 / 
        COUNT(DISTINCT CASE WHEN s.IS_VISIBLE = 'YES' THEN s.INDEX_NAME END),
        2
    ) AS ç´¢å¼•ä½¿ç”¨ç‡
FROM information_schema.TABLES t
JOIN information_schema.STATISTICS s 
    ON t.TABLE_SCHEMA = s.TABLE_SCHEMA 
   AND t.TABLE_NAME = s.TABLE_NAME
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage u
    ON s.TABLE_SCHEMA = u.OBJECT_SCHEMA
   AND s.TABLE_NAME = u.OBJECT_NAME
   AND s.INDEX_NAME = u.INDEX_NAME
   AND u.COUNT_READ > 0
WHERE t.TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')
  AND s.INDEX_NAME != 'PRIMARY'
GROUP BY t.TABLE_SCHEMA, t.TABLE_NAME;

-- æŸ¥è¯¢ç›‘æ§æ•°æ®
SELECT * FROM v_index_usage_summary 
WHERE ä¸å¯è§ç´¢å¼•æ•° > 0
ORDER BY ä¸å¯è§ç´¢å¼•æ•° DESC;
```

---

## 6. ğŸ§ª ç´¢å¼•A/Bæµ‹è¯•æ–¹æ³•


### 6.1 A/Bæµ‹è¯•è®¾è®¡åŸç†


**ğŸ”¬ A/Bæµ‹è¯•æ–¹æ³•è®º**
```
A/Bæµ‹è¯•åŸºæœ¬æ¦‚å¿µï¼š
å°±åƒåŒ»å­¦è¯•éªŒä¸­çš„å¯¹ç…§ç»„å’Œå®éªŒç»„ï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ç§æƒ…å†µæ¥å¯¹æ¯”æ•ˆæœ

Aç»„ï¼ˆå¯¹ç…§ç»„ï¼‰ï¼šç´¢å¼•å¯è§ï¼Œæ­£å¸¸ä½¿ç”¨
Bç»„ï¼ˆå®éªŒç»„ï¼‰ï¼šç´¢å¼•ä¸å¯è§ï¼Œä¸è¢«ä½¿ç”¨

é€šè¿‡å¯¹æ¯”ä¸¤ç»„çš„æ€§èƒ½è¡¨ç°ï¼Œè¯„ä¼°ç´¢å¼•çš„çœŸå®ä»·å€¼
```

**ğŸ“Š æµ‹è¯•è®¾è®¡æ¡†æ¶**
```
æµ‹è¯•è®¾è®¡è¦ç´ ï¼š

æµ‹è¯•ç›®æ ‡è®¾å®š
â”œâ”€ è¯„ä¼°ç´¢å¼•åˆ é™¤çš„æ€§èƒ½å½±å“
â”œâ”€ éªŒè¯æ–°ç´¢å¼•çš„æ•ˆæœ
â”œâ”€ å‘ç°å†—ä½™ç´¢å¼•
â””â”€ ä¼˜åŒ–ç´¢å¼•ç»„åˆ

æµ‹è¯•ç¯å¢ƒå‡†å¤‡
â”œâ”€ å‡†ç¡®çš„ç”Ÿäº§ç¯å¢ƒå‰¯æœ¬
â”œâ”€ çœŸå®çš„ä¸šåŠ¡æŸ¥è¯¢è´Ÿè½½
â”œâ”€ ç›¸åŒçš„æ•°æ®åˆ†å¸ƒç‰¹å¾
â””â”€ ç¨³å®šçš„æµ‹è¯•æ¡ä»¶

æµ‹è¯•æŒ‡æ ‡ç¡®å®š
â”œâ”€ æŸ¥è¯¢å“åº”æ—¶é—´
â”œâ”€ ååé‡(QPS)
â”œâ”€ èµ„æºä½¿ç”¨ç‡(CPU/IO)
â””â”€ æ…¢æŸ¥è¯¢ç»Ÿè®¡
```

### 6.2 A/Bæµ‹è¯•å®æ–½æµç¨‹


**ğŸ”„ å®Œæ•´æµ‹è¯•æµç¨‹**
```
æµ‹è¯•å®æ–½æ­¥éª¤ï¼š

Phase 1: åŸºçº¿å»ºç«‹(1-2å¤©)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1ï¼šè®°å½•å½“å‰æ€§èƒ½åŸºçº¿          â”‚
â”‚ â€¢ è¿è¡Œæ ‡å‡†ä¸šåŠ¡æŸ¥è¯¢è´Ÿè½½          â”‚
â”‚ â€¢ æ”¶é›†æ€§èƒ½æŒ‡æ ‡æ•°æ®              â”‚
â”‚ â€¢ å»ºç«‹æ€§èƒ½åŸºçº¿æŠ¥å‘Š              â”‚
â”‚                                 â”‚
â”‚ å…³é”®æŒ‡æ ‡ï¼š                      â”‚
â”‚ âœ“ å¹³å‡æŸ¥è¯¢å“åº”æ—¶é—´              â”‚
â”‚ âœ“ 95%åˆ†ä½æ•°å“åº”æ—¶é—´             â”‚  
â”‚ âœ“ QPSååé‡                     â”‚
â”‚ âœ“ æ…¢æŸ¥è¯¢æ•°é‡                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Phase 2: ç´¢å¼•è®¾ä¸ºä¸å¯è§(1-2å¤©)  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2ï¼šæµ‹è¯•æ²¡æœ‰ç›®æ ‡ç´¢å¼•çš„æƒ…å†µ    â”‚
â”‚ â€¢ å°†å¾…æµ‹è¯•ç´¢å¼•è®¾ä¸ºINVISIBLE     â”‚
â”‚ â€¢ è¿è¡Œç›¸åŒçš„æŸ¥è¯¢è´Ÿè½½            â”‚
â”‚ â€¢ æ”¶é›†æ€§èƒ½æ•°æ®                  â”‚
â”‚                                 â”‚
â”‚ ç›‘æ§é‡ç‚¹ï¼š                      â”‚
â”‚ âš ï¸  å“åº”æ—¶é—´æ˜¯å¦æ˜¾è‘—å¢åŠ         â”‚
â”‚ âš ï¸  æ˜¯å¦å‡ºç°æ–°çš„æ…¢æŸ¥è¯¢          â”‚
â”‚ âš ï¸  CPU/IOä½¿ç”¨ç‡å˜åŒ–           â”‚
â”‚ âš ï¸  ç”¨æˆ·ä½“éªŒæ˜¯å¦å—å½±å“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
Phase 3: ç»“æœåˆ†æå’Œå†³ç­–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3ï¼šå¯¹æ¯”åˆ†æï¼Œåšå‡ºå†³ç­–        â”‚
â”‚ â€¢ è®¡ç®—æ€§èƒ½å˜åŒ–å¹…åº¦              â”‚
â”‚ â€¢ è¯„ä¼°ä¸šåŠ¡å½±å“ç¨‹åº¦              â”‚
â”‚ â€¢ åšå‡ºä¿ç•™/åˆ é™¤å†³ç­–             â”‚
â”‚                                 â”‚
â”‚ å†³ç­–æ ‡å‡†ï¼š                      â”‚
â”‚ â€¢ æ€§èƒ½ä¸‹é™ < 5%ï¼šå¯è€ƒè™‘åˆ é™¤     â”‚
â”‚ â€¢ æ€§èƒ½ä¸‹é™ 5-20%ï¼šè°¨æ…è¯„ä¼°      â”‚
â”‚ â€¢ æ€§èƒ½ä¸‹é™ > 20%ï¼šå»ºè®®ä¿ç•™      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 A/Bæµ‹è¯•è„šæœ¬å®ç°


**ğŸ¤– è‡ªåŠ¨åŒ–A/Bæµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash
# MySQLç´¢å¼•A/Bæµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬

# é…ç½®å‚æ•°
DATABASE="test_db"
TABLE="test_table"
INDEX_NAME="idx_test"
TEST_DURATION=300  # 5åˆ†é’Ÿæµ‹è¯•

# æ€§èƒ½æµ‹è¯•å‡½æ•°
run_performance_test() {
    local test_phase=$1
    local output_file=$2
    
    echo "å¼€å§‹ $test_phase æ€§èƒ½æµ‹è¯•..."
    
    # æ¸…ç†æŸ¥è¯¢ç¼“å­˜
    mysql -e "RESET QUERY CACHE;" 2>/dev/null || true
    mysql -e "SELECT SQL_NO_CACHE COUNT(*) FROM $DATABASE.$TABLE;" > /dev/null
    
    # è¿è¡Œæ€§èƒ½æµ‹è¯•
    echo "æ‰§è¡Œæ—¶é—´,æŸ¥è¯¢å“åº”æ—¶é—´(ms),QPS" > $output_file
    
    start_time=$(date +%s)
    while [ $(($(date +%s) - start_time)) -lt $TEST_DURATION ]; do
        # æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢å¹¶è®°å½•æ—¶é—´
        query_time=$(mysql -e "
            SET @start = NOW(3);
            SELECT COUNT(*) FROM $DATABASE.$TABLE WHERE age BETWEEN 20 AND 30;
            SELECT TIMESTAMPDIFF(MICROSECOND, @start, NOW(3))/1000 as response_time_ms;
        " 2>/dev/null | tail -1)
        
        current_time=$(date '+%Y-%m-%d %H:%M:%S')
        echo "$current_time,$query_time,$(calculate_qps)" >> $output_file
        
        sleep 1
    done
    
    echo "$test_phase æµ‹è¯•å®Œæˆ"
}

# A/Bæµ‹è¯•ä¸»æµç¨‹
run_ab_test() {
    echo "å¼€å§‹ç´¢å¼•A/Bæµ‹è¯•ï¼š$INDEX_NAME"
    
    # Phase A: ç´¢å¼•å¯è§çŠ¶æ€æµ‹è¯•
    mysql -e "ALTER TABLE $DATABASE.$TABLE ALTER INDEX $INDEX_NAME VISIBLE;"
    run_performance_test "Aç»„(ç´¢å¼•å¯è§)" "test_a_results.csv"
    
    # Phase B: ç´¢å¼•ä¸å¯è§çŠ¶æ€æµ‹è¯•  
    mysql -e "ALTER TABLE $DATABASE.$TABLE ALTER INDEX $INDEX_NAME INVISIBLE;"
    run_performance_test "Bç»„(ç´¢å¼•ä¸å¯è§)" "test_b_results.csv"
    
    # æ¢å¤ç´¢å¼•å¯è§çŠ¶æ€
    mysql -e "ALTER TABLE $DATABASE.$TABLE ALTER INDEX $INDEX_NAME VISIBLE;"
    
    # ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
    generate_comparison_report
}

# ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
generate_comparison_report() {
    echo "ç”ŸæˆA/Bæµ‹è¯•å¯¹æ¯”æŠ¥å‘Š..."
    
    python3 << 'EOF'
import pandas as pd
import numpy as np

# è¯»å–æµ‹è¯•æ•°æ®
df_a = pd.read_csv('test_a_results.csv')
df_b = pd.read_csv('test_b_results.csv')

# è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
stats_a = {
    'avg_response': df_a['æŸ¥è¯¢å“åº”æ—¶é—´(ms)'].mean(),
    'p95_response': df_a['æŸ¥è¯¢å“åº”æ—¶é—´(ms)'].quantile(0.95),
    'avg_qps': df_a['QPS'].mean()
}

stats_b = {
    'avg_response': df_b['æŸ¥è¯¢å“åº”æ—¶é—´(ms)'].mean(), 
    'p95_response': df_b['æŸ¥è¯¢å“åº”æ—¶é—´(ms)'].quantile(0.95),
    'avg_qps': df_b['QPS'].mean()
}

# ç”ŸæˆæŠ¥å‘Š
print("A/Bæµ‹è¯•ç»“æœå¯¹æ¯”æŠ¥å‘Š")
print("=" * 40)
print(f"Aç»„(ç´¢å¼•å¯è§)   - å¹³å‡å“åº”æ—¶é—´: {stats_a['avg_response']:.2f}ms")
print(f"Bç»„(ç´¢å¼•ä¸å¯è§) - å¹³å‡å“åº”æ—¶é—´: {stats_b['avg_response']:.2f}ms")
print(f"æ€§èƒ½å·®å¼‚: {((stats_b['avg_response'] - stats_a['avg_response']) / stats_a['avg_response'] * 100):+.1f}%")

print(f"\nAç»„(ç´¢å¼•å¯è§)   - P95å“åº”æ—¶é—´: {stats_a['p95_response']:.2f}ms")  
print(f"Bç»„(ç´¢å¼•ä¸å¯è§) - P95å“åº”æ—¶é—´: {stats_b['p95_response']:.2f}ms")
print(f"P95å·®å¼‚: {((stats_b['p95_response'] - stats_a['p95_response']) / stats_a['p95_response'] * 100):+.1f}%")

# ç»™å‡ºå»ºè®®
if stats_b['avg_response'] > stats_a['avg_response'] * 1.2:
    print("\nğŸš¨ å»ºè®®ï¼šä¿ç•™ç´¢å¼•ï¼Œæ€§èƒ½å½±å“æ˜¾è‘—")
elif stats_b['avg_response'] > stats_a['avg_response'] * 1.05:
    print("\nâš ï¸  å»ºè®®ï¼šè°¨æ…è¯„ä¼°ï¼Œæ€§èƒ½æœ‰ä¸€å®šå½±å“")
else:
    print("\nâœ… å»ºè®®ï¼šå¯è€ƒè™‘åˆ é™¤ï¼Œæ€§èƒ½å½±å“è½»å¾®")
EOF
}

# æ‰§è¡ŒA/Bæµ‹è¯•
run_ab_test
```

### 6.3 ç›‘æ§å‘Šè­¦é…ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™è®¾ç½®**
```sql
-- åˆ›å»ºç›‘æ§å‘Šè­¦å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE monitor_invisible_index_alerts()
BEGIN
    DECLARE alert_count INT DEFAULT 0;
    DECLARE alert_message TEXT DEFAULT '';
    
    -- æ£€æŸ¥1ï¼šä¸å¯è§ç´¢å¼•æ•°é‡å¼‚å¸¸å¢åŠ 
    SELECT COUNT(*) INTO alert_count
    FROM information_schema.STATISTICS
    WHERE IS_VISIBLE = 'NO' 
      AND TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema');
    
    IF alert_count > 10 THEN
        SET alert_message = CONCAT('è­¦å‘Šï¼šä¸å¯è§ç´¢å¼•æ•°é‡è¿‡å¤š(', alert_count, 'ä¸ª)ï¼Œè¯·æ£€æŸ¥ç´¢å¼•ç®¡ç†ç­–ç•¥');
        -- è¿™é‡Œå¯ä»¥é›†æˆåˆ°ä½ çš„å‘Šè­¦ç³»ç»Ÿ
        INSERT INTO alert_log (alert_type, alert_message, created_at) 
        VALUES ('INDEX_INVISIBLE_COUNT', alert_message, NOW());
    END IF;
    
    -- æ£€æŸ¥2ï¼šé‡è¦è¡¨çš„ç´¢å¼•è¢«è®¾ä¸ºä¸å¯è§
    SELECT GROUP_CONCAT(CONCAT(TABLE_NAME, '.', INDEX_NAME)) INTO alert_message
    FROM information_schema.STATISTICS
    WHERE IS_VISIBLE = 'NO'
      AND TABLE_NAME IN ('users', 'orders', 'products')  -- é‡è¦ä¸šåŠ¡è¡¨
      AND TABLE_SCHEMA = 'production_db';
    
    IF alert_message IS NOT NULL THEN
        INSERT INTO alert_log (alert_type, alert_message, created_at)
        VALUES ('CRITICAL_INDEX_INVISIBLE', 
                CONCAT('å…³é”®ä¸šåŠ¡è¡¨ç´¢å¼•è¢«è®¾ä¸ºä¸å¯è§ï¼š', alert_message), 
                NOW());
    END IF;
    
END$$
DELIMITER ;

-- è®¾ç½®å®šæ—¶ä»»åŠ¡
-- æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ç›‘æ§æ£€æŸ¥
-- CREATE EVENT monitor_invisible_indexes
-- ON SCHEDULE EVERY 5 MINUTE
-- DO CALL monitor_invisible_index_alerts();
```

---

## 7. ğŸ›¡ï¸ ç”Ÿäº§ç¯å¢ƒå®‰å…¨æµ‹è¯•


### 7.1 ç”Ÿäº§ç¯å¢ƒæµ‹è¯•ç­–ç•¥


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå®‰å…¨æµ‹è¯•åŸåˆ™**
```
æœ€å°é£é™©åŸåˆ™ï¼š
â”œâ”€ åªåœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œæµ‹è¯•
â”œâ”€ å‡†å¤‡ç«‹å³å›é€€æ–¹æ¡ˆ
â”œâ”€ é™åˆ¶æµ‹è¯•æ—¶é—´çª—å£
â””â”€ å…¨ç¨‹ç›‘æ§ä¸šåŠ¡æŒ‡æ ‡

æ¸è¿›å¼æµ‹è¯•ï¼š
â”œâ”€ ä»éå…³é”®ç´¢å¼•å¼€å§‹æµ‹è¯•
â”œâ”€ ä»ä½é¢‘æŸ¥è¯¢ç´¢å¼•å¼€å§‹
â”œâ”€ é€æ­¥æ‰©å¤§æµ‹è¯•èŒƒå›´
â””â”€ ç´¯ç§¯æµ‹è¯•ç»éªŒ

å½±å“é¢æ§åˆ¶ï¼š
â”œâ”€ å•æ¬¡åªæµ‹è¯•ä¸€ä¸ªç´¢å¼•
â”œâ”€ é¿å…åŒæ—¶æµ‹è¯•å¤šä¸ªç›¸å…³ç´¢å¼•
â”œâ”€ é€‰æ‹©å½±å“èŒƒå›´æœ€å°çš„ç´¢å¼•
â””â”€ ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡ä¸å—å½±å“
```

### 7.2 ç”Ÿäº§æµ‹è¯•æµç¨‹è®¾è®¡


**ğŸ“‹ ç”Ÿäº§ç¯å¢ƒæµ‹è¯•SOP**
```
ç”Ÿäº§æµ‹è¯•æ ‡å‡†æ“ä½œæµç¨‹ï¼š

å‰æœŸå‡†å¤‡é˜¶æ®µ(æå‰1å¤©)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡†å¤‡å·¥ä½œæ¸…å•ï¼š                  â”‚
â”‚ â˜‘ ç¡®è®¤ä¸šåŠ¡ä½å³°æ—¶é—´çª—å£          â”‚
â”‚ â˜‘ é€šçŸ¥ç›¸å…³ä¸šåŠ¡æ–¹æµ‹è¯•è®¡åˆ’        â”‚  
â”‚ â˜‘ å‡†å¤‡ç›‘æ§è„šæœ¬å’Œå‘Šè­¦            â”‚
â”‚ â˜‘ ç¡®è®¤å›é€€æ“ä½œæµç¨‹              â”‚
â”‚ â˜‘ æŠ€æœ¯äººå‘˜å€¼ç­å®‰æ’              â”‚
â”‚ â˜‘ åˆ¶å®šå¼‚å¸¸æƒ…å†µå¤„ç†é¢„æ¡ˆ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
æµ‹è¯•æ‰§è¡Œé˜¶æ®µ(30åˆ†é’Ÿå†…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œæ­¥éª¤ï¼š                      â”‚
â”‚ 1. è®°å½•åŸºçº¿æ€§èƒ½æ•°æ®(5åˆ†é’Ÿ)      â”‚
â”‚ 2. è®¾ç½®ç´¢å¼•ä¸ºä¸å¯è§(ç¬é—´)       â”‚
â”‚ 3. å¯†åˆ‡ç›‘æ§æ€§èƒ½å˜åŒ–(20åˆ†é’Ÿ)     â”‚
â”‚ 4. å¦‚æ— å¼‚å¸¸ï¼Œè®¾ç½®ç´¢å¼•ä¸ºå¯è§     â”‚
â”‚ 5. éªŒè¯æ€§èƒ½æ¢å¤æ­£å¸¸(5åˆ†é’Ÿ)      â”‚
â”‚                                 â”‚
â”‚ ç›‘æ§æŒ‡æ ‡ï¼š                      â”‚
â”‚ ğŸ“Š å®æ—¶å“åº”æ—¶é—´ç›‘æ§             â”‚
â”‚ ğŸ“Š æ…¢æŸ¥è¯¢æ—¥å¿—ç›‘æ§               â”‚
â”‚ ğŸ“Š æ•°æ®åº“è¿æ¥æ•°ç›‘æ§             â”‚
â”‚ ğŸ“Š ä¸šåŠ¡æ¥å£æˆåŠŸç‡ç›‘æ§           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
ç»“æœåˆ†æé˜¶æ®µ(å½“å¤©å†…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†æå·¥ä½œï¼š                      â”‚
â”‚ â€¢ å¯¹æ¯”æµ‹è¯•å‰åæ€§èƒ½æ•°æ®          â”‚
â”‚ â€¢ åˆ†æä¸šåŠ¡å½±å“ç¨‹åº¦              â”‚
â”‚ â€¢ è¯„ä¼°ç´¢å¼•ä¿ç•™å¿…è¦æ€§            â”‚
â”‚ â€¢ åˆ¶å®šåç»­å¤„ç†æ–¹æ¡ˆ              â”‚
â”‚ â€¢ æ›´æ–°ç´¢å¼•ç®¡ç†ç­–ç•¥              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 ç”Ÿäº§æµ‹è¯•å®‰å…¨ä¿éšœ


**ğŸ”’ å®‰å…¨ä¿éšœæªæ–½**
```sql
-- æµ‹è¯•å‰å®‰å…¨æ£€æŸ¥è„šæœ¬
DELIMITER $$
CREATE PROCEDURE pre_test_safety_check(
    IN target_table VARCHAR(64),
    IN target_index VARCHAR(64),
    OUT safety_status VARCHAR(20),
    OUT safety_message TEXT
)
BEGIN
    DECLARE index_usage_count BIGINT DEFAULT 0;
    DECLARE table_query_count BIGINT DEFAULT 0;
    DECLARE current_hour INT;
    
    -- æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦é€‚åˆæµ‹è¯•
    SELECT HOUR(NOW()) INTO current_hour;
    IF current_hour BETWEEN 9 AND 17 THEN
        SET safety_status = 'UNSAFE';
        SET safety_message = 'å½“å‰æ—¶é—´ä¸ºä¸šåŠ¡é«˜å³°æœŸï¼Œä¸å»ºè®®è¿›è¡Œç´¢å¼•æµ‹è¯•';
        LEAVE proc;
    END IF;
    
    -- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨é¢‘ç‡
    SELECT IFNULL(COUNT_READ, 0) INTO index_usage_count
    FROM performance_schema.table_io_waits_summary_by_index_usage
    WHERE OBJECT_SCHEMA = DATABASE()
      AND OBJECT_NAME = target_table
      AND INDEX_NAME = target_index;
    
    IF index_usage_count > 10000 THEN  -- é«˜é¢‘ä½¿ç”¨ç´¢å¼•
        SET safety_status = 'CAUTION';
        SET safety_message = CONCAT('ç´¢å¼•ä½¿ç”¨é¢‘ç‡è¾ƒé«˜(', index_usage_count, ')ï¼Œæµ‹è¯•éœ€è¦é¢å¤–è°¨æ…');
    ELSE
        SET safety_status = 'SAFE';
        SET safety_message = 'ç´¢å¼•ä½¿ç”¨é¢‘ç‡é€‚ä¸­ï¼Œå¯ä»¥è¿›è¡Œæµ‹è¯•';
    END IF;
    
END$$
DELIMITER ;

-- ä½¿ç”¨å®‰å…¨æ£€æŸ¥
CALL pre_test_safety_check('users', 'idx_email', @status, @message);
SELECT @status, @message;
```

**âš¡ ç´§æ€¥å›é€€æœºåˆ¶**
```bash
#!/bin/bash
# ç´§æ€¥å›é€€è„šæœ¬

MYSQL_CMD="mysql -u root -p$MYSQL_PASSWORD"

emergency_rollback() {
    local database=$1
    local table=$2
    local index=$3
    
    echo "ğŸš¨ æ‰§è¡Œç´§æ€¥å›é€€ï¼šæ¢å¤ç´¢å¼•å¯è§æ€§"
    echo "æ•°æ®åº“: $database, è¡¨: $table, ç´¢å¼•: $index"
    
    # ç«‹å³æ¢å¤ç´¢å¼•å¯è§æ€§
    $MYSQL_CMD -e "
        USE $database;
        ALTER TABLE $table ALTER INDEX $index VISIBLE;
        SELECT CONCAT('ç´¢å¼• ', '$index', ' å·²æ¢å¤å¯è§') AS status;
    "
    
    if [ $? -eq 0 ]; then
        echo "âœ… ç´§æ€¥å›é€€æˆåŠŸ"
        # å‘é€é€šçŸ¥
        send_notification "ç´¢å¼•$indexå·²ç´§æ€¥æ¢å¤å¯è§"
    else
        echo "âŒ ç´§æ€¥å›é€€å¤±è´¥ï¼Œéœ€è¦äººå·¥å¹²é¢„"
        send_alert "ç´¢å¼•å›é€€å¤±è´¥ï¼Œéœ€è¦ç«‹å³äººå·¥å¤„ç†"
    fi
}

# ç›‘æ§è„šæœ¬ï¼Œå‘ç°å¼‚å¸¸è‡ªåŠ¨å›é€€
monitor_and_rollback() {
    while true; do
        # æ£€æŸ¥æ…¢æŸ¥è¯¢æ•°é‡
        slow_query_count=$($MYSQL_CMD -e "
            SELECT COUNT(*) FROM mysql.slow_log 
            WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 MINUTE);
        " 2>/dev/null | tail -1)
        
        if [ "$slow_query_count" -gt 10 ]; then
            echo "âš ï¸  æ£€æµ‹åˆ°æ…¢æŸ¥è¯¢å¼‚å¸¸å¢åŠ ($slow_query_countä¸ª)ï¼Œæ‰§è¡Œè‡ªåŠ¨å›é€€"
            emergency_rollback "$1" "$2" "$3"
            break
        fi
        
        sleep 30
    done
}
```

---

## 8. ğŸ”§ ç´¢å¼•å½±å“è¯„ä¼°å·¥å…·


### 8.1 å½±å“è¯„ä¼°å·¥å…·é›†


**ğŸ› ï¸ è‡ªå®šä¹‰è¯„ä¼°å·¥å…·**
```sql
-- åˆ›å»ºç´¢å¼•å½±å“è¯„ä¼°å·¥å…·é›†
DELIMITER $$

-- 1. ç´¢å¼•ä½¿ç”¨é¢‘ç‡åˆ†æ
CREATE FUNCTION analyze_index_usage(
    target_schema VARCHAR(64),
    target_table VARCHAR(64), 
    target_index VARCHAR(64)
) RETURNS JSON
READS SQL DATA
BEGIN
    DECLARE result JSON;
    DECLARE usage_stats JSON;
    
    -- è·å–ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
    SELECT JSON_OBJECT(
        'total_reads', IFNULL(COUNT_READ, 0),
        'total_writes', IFNULL(COUNT_WRITE, 0),
        'read_latency_avg', IFNULL(AVG_TIMER_READ/1000000, 0),
        'write_latency_avg', IFNULL(AVG_TIMER_WRITE/1000000, 0),
        'last_access', IFNULL(MAX_TIMER_READ_TIME, 'Never')
    ) INTO usage_stats
    FROM performance_schema.table_io_waits_summary_by_index_usage
    WHERE OBJECT_SCHEMA = target_schema
      AND OBJECT_NAME = target_table
      AND INDEX_NAME = target_index;
    
    -- åˆ†æç›¸å…³æŸ¥è¯¢
    SET result = JSON_OBJECT(
        'index_usage', usage_stats,
        'evaluation_time', NOW(),
        'schema_name', target_schema,
        'table_name', target_table,
        'index_name', target_index
    );
    
    RETURN result;
END$$

-- 2. æŸ¥è¯¢æ€§èƒ½å½±å“é¢„æµ‹
CREATE PROCEDURE predict_query_impact(
    IN target_index VARCHAR(64),
    IN target_table VARCHAR(64)
)
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE sql_text TEXT;
    DECLARE exec_count BIGINT;
    DECLARE avg_latency DECIMAL(10,2);
    
    -- æ¸¸æ ‡ï¼šè·å–ä½¿ç”¨è¯¥ç´¢å¼•çš„æŸ¥è¯¢
    DECLARE query_cursor CURSOR FOR
        SELECT 
            DIGEST_TEXT,
            COUNT_STAR,
            AVG_TIMER_WAIT/1000000 as avg_ms
        FROM performance_schema.events_statements_summary_by_digest
        WHERE DIGEST_TEXT LIKE CONCAT('%', target_table, '%')
          AND COUNT_STAR > 100  -- åªåˆ†ææ‰§è¡Œé¢‘ç‡é«˜çš„æŸ¥è¯¢
        ORDER BY COUNT_STAR DESC
        LIMIT 20;
        
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- åˆ›å»ºä¸´æ—¶ç»“æœè¡¨
    DROP TEMPORARY TABLE IF EXISTS temp_impact_analysis;
    CREATE TEMPORARY TABLE temp_impact_analysis (
        query_digest TEXT,
        execution_count BIGINT,
        avg_latency_ms DECIMAL(10,2),
        predicted_impact VARCHAR(20),
        risk_level VARCHAR(10)
    );
    
    OPEN query_cursor;
    
    read_loop: LOOP
        FETCH query_cursor INTO sql_text, exec_count, avg_latency;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- é¢„æµ‹å½±å“ç¨‹åº¦ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        INSERT INTO temp_impact_analysis VALUES (
            LEFT(sql_text, 100),
            exec_count,
            avg_latency,
            CASE 
                WHEN avg_latency > 100 THEN 'é«˜å½±å“'
                WHEN avg_latency > 50 THEN 'ä¸­ç­‰å½±å“'  
                ELSE 'ä½å½±å“'
            END,
            CASE
                WHEN exec_count > 1000 AND avg_latency > 100 THEN 'HIGH'
                WHEN exec_count > 500 OR avg_latency > 50 THEN 'MEDIUM'
                ELSE 'LOW'
            END
        );
        
    END LOOP;
    
    CLOSE query_cursor;
    
    -- è¾“å‡ºå½±å“è¯„ä¼°æŠ¥å‘Š
    SELECT 
        'ç´¢å¼•å½±å“è¯„ä¼°æŠ¥å‘Š' AS æŠ¥å‘Šç±»å‹,
        NOW() AS è¯„ä¼°æ—¶é—´;
        
    SELECT * FROM temp_impact_analysis ORDER BY risk_level DESC, execution_count DESC;
    
    -- æ€»ä½“é£é™©è¯„ä¼°
    SELECT 
        COUNT(*) AS å—å½±å“æŸ¥è¯¢æ•°,
        SUM(execution_count) AS æ€»æ‰§è¡Œæ¬¡æ•°,
        AVG(avg_latency_ms) AS å¹³å‡å“åº”æ—¶é—´,
        CASE 
            WHEN COUNT(*) = 0 THEN 'âœ… å®‰å…¨'
            WHEN SUM(CASE WHEN risk_level = 'HIGH' THEN 1 ELSE 0 END) > 0 THEN 'ğŸš¨ é«˜é£é™©'
            WHEN SUM(CASE WHEN risk_level = 'MEDIUM' THEN 1 ELSE 0 END) > 2 THEN 'âš ï¸ ä¸­é£é™©'
            ELSE 'âœ… ä½é£é™©'
        END AS æ•´ä½“é£é™©è¯„ä¼°
    FROM temp_impact_analysis;
    
END$$
DELIMITER ;

-- ä½¿ç”¨è¯„ä¼°å·¥å…·
CALL predict_query_impact('idx_email', 'users');
```

### 8.2 è‡ªåŠ¨åŒ–è¯„ä¼°æµç¨‹


**ğŸ¤– æ™ºèƒ½è¯„ä¼°ç³»ç»Ÿ**
```python
# Pythonè„šæœ¬ï¼šæ™ºèƒ½ç´¢å¼•å½±å“è¯„ä¼°
import mysql.connector
import json
import time
from datetime import datetime, timedelta

class IndexImpactAnalyzer:
    def __init__(self, db_config):
        self.db_config = db_config
        self.conn = None
        
    def connect(self):
        """å»ºç«‹æ•°æ®åº“è¿æ¥"""
        self.conn = mysql.connector.connect(**self.db_config)
        
    def analyze_index_impact(self, table_name, index_name):
        """åˆ†æç´¢å¼•å½±å“"""
        
        # 1. æ”¶é›†åŸºçº¿æ•°æ®
        baseline = self.collect_baseline_metrics(table_name)
        print(f"ğŸ“Š åŸºçº¿æ•°æ®æ”¶é›†å®Œæˆ")
        
        # 2. è®¾ç½®ç´¢å¼•ä¸ºä¸å¯è§
        self.set_index_visibility(table_name, index_name, False)
        print(f"ğŸ”§ ç´¢å¼• {index_name} å·²è®¾ä¸ºä¸å¯è§")
        
        # 3. ç›‘æ§æ€§èƒ½å˜åŒ–
        impact_data = self.monitor_performance_change(300)  # ç›‘æ§5åˆ†é’Ÿ
        
        # 4. æ¢å¤ç´¢å¼•å¯è§æ€§
        self.set_index_visibility(table_name, index_name, True)
        print(f"âœ… ç´¢å¼• {index_name} å·²æ¢å¤å¯è§")
        
        # 5. ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
        report = self.generate_impact_report(baseline, impact_data)
        return report
    
    def collect_baseline_metrics(self, table_name):
        """æ”¶é›†æ€§èƒ½åŸºçº¿æ•°æ®"""
        cursor = self.conn.cursor(dictionary=True)
        
        # æ”¶é›†æŸ¥è¯¢æ€§èƒ½åŸºçº¿
        query = """
        SELECT 
            COUNT_STAR as query_count,
            AVG_TIMER_WAIT/1000000 as avg_latency_ms,
            MAX_TIMER_WAIT/1000000 as max_latency_ms
        FROM performance_schema.events_statements_summary_by_digest
        WHERE DIGEST_TEXT LIKE %s
        ORDER BY COUNT_STAR DESC
        LIMIT 10
        """
        
        cursor.execute(query, (f'%{table_name}%',))
        baseline = cursor.fetchall()
        cursor.close()
        
        return {
            'timestamp': datetime.now(),
            'query_stats': baseline,
            'table_name': table_name
        }
    
    def set_index_visibility(self, table_name, index_name, visible):
        """è®¾ç½®ç´¢å¼•å¯è§æ€§"""
        cursor = self.conn.cursor()
        visibility = 'VISIBLE' if visible else 'INVISIBLE'
        
        sql = f"ALTER TABLE {table_name} ALTER INDEX {index_name} {visibility}"
        cursor.execute(sql)
        self.conn.commit()
        cursor.close()
    
    def monitor_performance_change(self, duration_seconds):
        """ç›‘æ§æ€§èƒ½å˜åŒ–"""
        start_time = time.time()
        performance_data = []
        
        while time.time() - start_time < duration_seconds:
            # æ¯30ç§’æ”¶é›†ä¸€æ¬¡æ€§èƒ½æ•°æ®
            metrics = self.collect_current_metrics()
            performance_data.append(metrics)
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡æ€§èƒ½é—®é¢˜
            if self.detect_performance_issue(metrics):
                print("ğŸš¨ æ£€æµ‹åˆ°ä¸¥é‡æ€§èƒ½é—®é¢˜ï¼Œæå‰ç»“æŸæµ‹è¯•")
                break
                
            time.sleep(30)
        
        return performance_data
    
    def detect_performance_issue(self, metrics):
        """æ£€æµ‹ä¸¥é‡æ€§èƒ½é—®é¢˜"""
        # ç®€åŒ–çš„å¼‚å¸¸æ£€æµ‹é€»è¾‘
        if metrics.get('avg_latency_ms', 0) > 1000:  # å¹³å‡å“åº”æ—¶é—´è¶…è¿‡1ç§’
            return True
        if metrics.get('slow_query_count', 0) > 50:   # æ…¢æŸ¥è¯¢æ•°é‡è¿‡å¤š
            return True
        return False
    
    def generate_impact_report(self, baseline, impact_data):
        """ç”Ÿæˆå½±å“è¯„ä¼°æŠ¥å‘Š"""
        if not impact_data:
            return {"status": "æµ‹è¯•ä¸­æ–­", "reason": "æ€§èƒ½å¼‚å¸¸"}
        
        # è®¡ç®—æ€§èƒ½å˜åŒ–
        baseline_avg = baseline['query_stats'][0]['avg_latency_ms'] if baseline['query_stats'] else 0
        impact_avg = sum(d.get('avg_latency_ms', 0) for d in impact_data) / len(impact_data)
        
        change_percent = ((impact_avg - baseline_avg) / baseline_avg * 100) if baseline_avg > 0 else 0
        
        # ç”Ÿæˆå»ºè®®
        recommendation = self.get_recommendation(change_percent)
        
        return {
            "baseline_latency_ms": baseline_avg,
            "test_latency_ms": impact_avg, 
            "change_percent": round(change_percent, 2),
            "recommendation": recommendation,
            "test_duration": len(impact_data) * 30,
            "evaluation_time": datetime.now().isoformat()
        }
    
    def get_recommendation(self, change_percent):
        """æ ¹æ®æ€§èƒ½å˜åŒ–ç»™å‡ºå»ºè®®"""
        if change_percent <= 5:
            return "âœ… å»ºè®®åˆ é™¤ï¼šæ€§èƒ½å½±å“å¾ˆå°"
        elif change_percent <= 20:
            return "âš ï¸ è°¨æ…è€ƒè™‘ï¼šæœ‰ä¸€å®šæ€§èƒ½å½±å“"
        elif change_percent <= 50:
            return "ğŸ”¶ ä¸å»ºè®®åˆ é™¤ï¼šæ€§èƒ½å½±å“è¾ƒå¤§"
        else:
            return "ğŸš¨ å¼ºçƒˆå»ºè®®ä¿ç•™ï¼šæ€§èƒ½å½±å“ä¸¥é‡"

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    db_config = {
        'host': 'localhost',
        'user': 'root', 
        'password': 'your_password',
        'database': 'test_db'
    }
    
    analyzer = IndexImpactAnalyzer(db_config)
    analyzer.connect()
    
    # åˆ†æç´¢å¼•å½±å“
    report = analyzer.analyze_index_impact('users', 'idx_email')
    print("ğŸ“‹ ç´¢å¼•å½±å“è¯„ä¼°æŠ¥å‘Š:")
    print(json.dumps(report, indent=2, ensure_ascii=False))
```

---

## 9. ğŸ“˜ ä½¿ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ


### 9.1 ä¸å¯è§ç´¢å¼•ä½¿ç”¨åœºæ™¯æŒ‡å—


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
```
åœºæ™¯1ï¼šç´¢å¼•åˆ é™¤å®‰å…¨éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šæ€€ç–‘æŸä¸ªç´¢å¼•æ˜¯å¤šä½™çš„        â”‚ 
â”‚ æ‹…å¿ƒï¼šç›´æ¥åˆ é™¤å¯èƒ½å½±å“æ€§èƒ½      â”‚
â”‚ è§£å†³ï¼šå…ˆè®¾ä¸ºä¸å¯è§æµ‹è¯•å½±å“      â”‚
â”‚                                 â”‚
â”‚ å®æ–½æ­¥éª¤ï¼š                      â”‚
â”‚ 1. è®¾ç½®ç´¢å¼•ä¸ºINVISIBLE          â”‚
â”‚ 2. è§‚å¯Ÿ1-2å‘¨æ€§èƒ½è¡¨ç°           â”‚
â”‚ 3. ç¡®è®¤æ— å½±å“åå†ç‰©ç†åˆ é™¤      â”‚
â”‚ 4. å¦‚æœ‰å½±å“ç«‹å³æ¢å¤å¯è§        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯2ï¼šæ–°ç´¢å¼•æ•ˆæœéªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šæ–°å»ºç´¢å¼•æ˜¯å¦çœŸçš„æœ‰æ•ˆ      â”‚
â”‚ æ‹…å¿ƒï¼šç´¢å¼•å¯èƒ½æ²¡æœ‰é¢„æœŸæ•ˆæœ      â”‚  
â”‚ è§£å†³ï¼šåˆ›å»ºåå…ˆè®¾ä¸ºä¸å¯è§       â”‚
â”‚                                 â”‚
â”‚ å®æ–½æ­¥éª¤ï¼š                      â”‚
â”‚ 1. åˆ›å»ºæ–°ç´¢å¼•ï¼Œè®¾ä¸ºINVISIBLE    â”‚
â”‚ 2. é€šè¿‡å¼ºåˆ¶ä½¿ç”¨æµ‹è¯•æ•ˆæœ        â”‚
â”‚ 3. ç¡®è®¤æœ‰æ•ˆåè®¾ä¸ºVISIBLE       â”‚ 
â”‚ 4. æ— æ•ˆåˆ™ç›´æ¥åˆ é™¤               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åœºæ™¯3ï¼šæ¸è¿›å¼ç´¢å¼•ä¼˜åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šæœ‰å¤šä¸ªå¯èƒ½å†—ä½™çš„ç´¢å¼•      â”‚
â”‚ æ‹…å¿ƒï¼šåŒæ—¶åˆ é™¤å¤šä¸ªç´¢å¼•é£é™©å¤§    â”‚
â”‚ è§£å†³ï¼šé€ä¸ªè®¾ä¸ºä¸å¯è§æµ‹è¯•       â”‚
â”‚                                 â”‚
â”‚ å®æ–½æ­¥éª¤ï¼š                      â”‚
â”‚ 1. æŒ‰é£é™©ç¨‹åº¦æ’åºç´¢å¼•          â”‚
â”‚ 2. ä»ä½é£é™©ç´¢å¼•å¼€å§‹æµ‹è¯•        â”‚
â”‚ 3. æ¯æ¬¡åªæµ‹è¯•ä¸€ä¸ªç´¢å¼•          â”‚
â”‚ 4. å»ºç«‹ç´¢å¼•æ¸…ç†è®¡åˆ’            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ç´¢å¼•æµ‹è¯•è‡ªåŠ¨åŒ–æµç¨‹


**ğŸ¤– è‡ªåŠ¨åŒ–æµç¨‹è®¾è®¡**
```
è‡ªåŠ¨åŒ–ç´¢å¼•æµ‹è¯•æµç¨‹ï¼š

é…ç½®é˜¶æ®µ
â”œâ”€ å®šä¹‰æµ‹è¯•ç´¢å¼•åˆ—è¡¨
â”œâ”€ è®¾ç½®æµ‹è¯•æ—¶é—´çª—å£  
â”œâ”€ é…ç½®æ€§èƒ½é˜ˆå€¼
â””â”€ è®¾ç½®å‘Šè­¦é€šçŸ¥

æ‰§è¡Œé˜¶æ®µ
â”œâ”€ è‡ªåŠ¨åŒ–æµ‹è¯•è°ƒåº¦
â”œâ”€ æ€§èƒ½æ•°æ®æ”¶é›†
â”œâ”€ å®æ—¶å¼‚å¸¸æ£€æµ‹  
â””â”€ è‡ªåŠ¨å›é€€æœºåˆ¶

åˆ†æé˜¶æ®µ
â”œâ”€ æ€§èƒ½æ•°æ®åˆ†æ
â”œâ”€ å½±å“è¯„ä¼°è®¡ç®—
â”œâ”€ æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
â””â”€ å†³ç­–å»ºè®®è¾“å‡º

å†³ç­–é˜¶æ®µ  
â”œâ”€ äººå·¥å®¡æ ¸ç»“æœ
â”œâ”€ ç¡®è®¤å¤„ç†æ–¹æ¡ˆ
â”œâ”€ æ‰§è¡Œæ¸…ç†æ“ä½œ
â””â”€ æ›´æ–°ç´¢å¼•ç­–ç•¥
```

**ğŸ“‹ è‡ªåŠ¨åŒ–æµ‹è¯•é…ç½®æ–‡ä»¶**
```yaml
# invisible_index_test_config.yaml
test_configuration:
  # æµ‹è¯•æ—¶é—´çª—å£
  test_windows:
    - start_time: "02:00"
      end_time: "04:00"
      description: "å‡Œæ™¨ä½å³°æœŸæµ‹è¯•"
    - start_time: "14:00" 
      end_time: "15:00"
      description: "ä¸‹åˆä½å³°æœŸæµ‹è¯•"
  
  # æ€§èƒ½é˜ˆå€¼è®¾ç½®
  performance_thresholds:
    max_latency_increase_percent: 20    # æœ€å¤§å»¶è¿Ÿå¢åŠ ç™¾åˆ†æ¯”
    max_slow_query_increase: 50         # æœ€å¤§æ…¢æŸ¥è¯¢å¢åŠ æ•°é‡
    max_cpu_usage_percent: 80           # æœ€å¤§CPUä½¿ç”¨ç‡
    max_test_duration_minutes: 30       # å•æ¬¡æµ‹è¯•æœ€å¤§æ—¶é•¿
  
  # æµ‹è¯•ç´¢å¼•åˆ—è¡¨
  test_indexes:
    - table: "users"
      index: "idx_last_login"
      priority: "low"        # æµ‹è¯•ä¼˜å…ˆçº§
      risk_level: "low"      # é£é™©ç­‰çº§
      
    - table: "orders"
      index: "idx_temp_status"  
      priority: "medium"
      risk_level: "medium"
      
  # é€šçŸ¥é…ç½®
  notifications:
    email:
      - "dba@company.com"
      - "dev-team@company.com"
    webhook_url: "https://hooks.slack.com/..."
```

### 9.3 ç®¡ç†ç»´æŠ¤ç­–ç•¥


**ğŸ”„ æ—¥å¸¸ç»´æŠ¤æµç¨‹**
```
å®šæœŸç»´æŠ¤ä»»åŠ¡ï¼š

æ¯æ—¥æ£€æŸ¥(è‡ªåŠ¨åŒ–)
â”œâ”€ ä¸å¯è§ç´¢å¼•çŠ¶æ€æ£€æŸ¥
â”œâ”€ æ€§èƒ½å¼‚å¸¸å‘Šè­¦ç›‘æ§
â”œâ”€ æµ‹è¯•ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
â””â”€ ç´§æ€¥æƒ…å†µå¤„ç†

æ¯å‘¨è¯„ä¼°(åŠè‡ªåŠ¨åŒ–)  
â”œâ”€ æµ‹è¯•ç»“æœæ±‡æ€»åˆ†æ
â”œâ”€ ç´¢å¼•æ¸…ç†å†³ç­–åˆ¶å®š
â”œâ”€ ä¸‹å‘¨æµ‹è¯•è®¡åˆ’å®‰æ’
â””â”€ ç­–ç•¥è°ƒæ•´ä¼˜åŒ–

æ¯æœˆå›é¡¾(äººå·¥åˆ†æ)
â”œâ”€ ç´¢å¼•ä¼˜åŒ–æ•ˆæœè¯„ä¼°
â”œâ”€ æµ‹è¯•æµç¨‹æ”¹è¿›å»ºè®®
â”œâ”€ å·¥å…·åŠŸèƒ½ä¼˜åŒ–éœ€æ±‚
â””â”€ å›¢é˜ŸåŸ¹è®­éœ€æ±‚è¯„ä¼°
```

**ğŸ“Š ç»´æŠ¤æŒ‡æ ‡çœ‹æ¿**
```sql
-- åˆ›å»ºç»´æŠ¤æŒ‡æ ‡è§†å›¾
CREATE VIEW v_invisible_index_dashboard AS
SELECT 
    'ğŸ“Š æ€»ä½“ç»Ÿè®¡' as æŒ‡æ ‡ç±»åˆ«,
    'æ€»ç´¢å¼•æ•°' as æŒ‡æ ‡åç§°,
    COUNT(*) as æŒ‡æ ‡å€¼,
    'ä¸ª' as å•ä½
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')

UNION ALL

SELECT 
    'ğŸ“Š æ€»ä½“ç»Ÿè®¡',
    'ä¸å¯è§ç´¢å¼•æ•°',
    COUNT(*),
    'ä¸ª'
FROM information_schema.STATISTICS  
WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')
  AND IS_VISIBLE = 'NO'

UNION ALL

SELECT 
    'ğŸ“Š æ€»ä½“ç»Ÿè®¡',
    'ä¸å¯è§ç´¢å¼•å æ¯”',
    ROUND(
        (SELECT COUNT(*) FROM information_schema.STATISTICS 
         WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema')
           AND IS_VISIBLE = 'NO') * 100.0 /
        COUNT(*), 2
    ),
    '%'
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'sys', 'performance_schema', 'information_schema');

-- æŸ¥çœ‹ç»´æŠ¤æŒ‡æ ‡
SELECT * FROM v_invisible_index_dashboard;
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸å¯è§ç´¢å¼•æœ¬è´¨ï¼šå­˜åœ¨ä½†ä¼˜åŒ–å™¨å¿½ç•¥çš„ç´¢å¼•ï¼ŒMySQL 8.0ç‰¹æ€§
ğŸ”¸ å·¥ä½œæœºåˆ¶ï¼šç´¢å¼•æ­£å¸¸ç»´æŠ¤ï¼Œä½†æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸ä¼šé€‰æ‹©ä½¿ç”¨
ğŸ”¸ æ ¸å¿ƒä»·å€¼ï¼šå®‰å…¨çš„ç´¢å¼•æµ‹è¯•æ–¹æ³•ï¼Œé¿å…åˆ é™¤é£é™©
ğŸ”¸ ä½¿ç”¨é™åˆ¶ï¼šä¸»é”®ã€å”¯ä¸€çº¦æŸã€å¤–é”®ç´¢å¼•ä¸èƒ½è®¾ä¸ºä¸å¯è§
ğŸ”¸ åˆ‡æ¢ç‰¹æ€§ï¼šå¯è§æ€§åˆ‡æ¢ç¬é—´å®Œæˆï¼Œéšæ—¶å¯é€†
ğŸ”¸ ç›‘æ§é‡è¦æ€§ï¼šéœ€è¦æŒç»­ç›‘æ§æ€§èƒ½å½±å“å’Œä½¿ç”¨æƒ…å†µ
```

### 10.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æœ€ä½³å®è·µåŸåˆ™**
```
å®‰å…¨ç¬¬ä¸€åŸåˆ™ï¼š
â”œâ”€ ç”Ÿäº§ç¯å¢ƒæµ‹è¯•æ—¶é—´æ§åˆ¶åœ¨30åˆ†é’Ÿå†…
â”œâ”€ å‡†å¤‡è‡ªåŠ¨åŒ–å›é€€æœºåˆ¶
â”œâ”€ ä»ä½é£é™©ç´¢å¼•å¼€å§‹æµ‹è¯•
â””â”€ å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦

å¾ªåºæ¸è¿›åŸåˆ™ï¼š
â”œâ”€ å•æ¬¡åªæµ‹è¯•ä¸€ä¸ªç´¢å¼•
â”œâ”€ å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
â”œâ”€ é€æ­¥æ‰©å¤§æµ‹è¯•èŒƒå›´
â””â”€ ç§¯ç´¯æµ‹è¯•ç»éªŒå’Œæ•°æ®

æ•°æ®é©±åŠ¨åŸåˆ™ï¼š
â”œâ”€ åŸºäºçœŸå®æ€§èƒ½æ•°æ®åšå†³ç­–
â”œâ”€ å»ºç«‹é‡åŒ–çš„è¯„ä¼°æ ‡å‡†
â”œâ”€ æŒç»­ç›‘æ§å’Œè°ƒä¼˜
â””â”€ å®šæœŸè¯„ä¼°ç­–ç•¥æ•ˆæœ
```

**ğŸ”§ æ“ä½œå»ºè®®æ€»ç»“**
```
ç´¢å¼•æµ‹è¯•æµç¨‹ï¼š
1. è¯†åˆ«å¯èƒ½å†—ä½™çš„ç´¢å¼•
2. åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œåˆæ­¥éªŒè¯
3. åˆ¶å®šç”Ÿäº§æµ‹è¯•è®¡åˆ’
4. æ‰§è¡Œä¸å¯è§ç´¢å¼•æµ‹è¯•
5. åˆ†æç»“æœå¹¶åšå‡ºå†³ç­–
6. æ‰§è¡Œç´¢å¼•æ¸…ç†æˆ–ä¿ç•™

ç´¢å¼•ç®¡ç†ç­–ç•¥ï¼š
â”œâ”€ å»ºç«‹ç´¢å¼•æ¸…ç†å®šæœŸè®¡åˆ’
â”œâ”€ ç»´æŠ¤ç´¢å¼•ä½¿ç”¨æƒ…å†µæ–‡æ¡£
â”œâ”€ åŸ¹è®­å›¢é˜Ÿæ­£ç¡®ä½¿ç”¨æ–¹æ³•
â””â”€ å»ºç«‹æœ€ä½³å®è·µçŸ¥è¯†åº“
```

### 10.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§ä½¿ç”¨é—®é¢˜**
```
é—®é¢˜1ï¼šè®¾ç½®ä¸å¯è§åæ€§èƒ½æ€¥å‰§ä¸‹é™æ€ä¹ˆåŠï¼Ÿ
è§£ç­”ï¼šç«‹å³æ‰§è¡Œå›é€€æ“ä½œ
ALTER TABLE table_name ALTER INDEX index_name VISIBLE;
è¯´æ˜ï¼šè¿™è¯´æ˜è¯¥ç´¢å¼•å¯¹ä¸šåŠ¡å¾ˆé‡è¦ï¼Œåº”è¯¥ä¿ç•™

é—®é¢˜2ï¼šå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç´¢å¼•æ˜¯å¦çœŸçš„æ²¡ç”¨ï¼Ÿ
è§£ç­”ï¼šé€šè¿‡performance_schemaæŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡
SELECT COUNT_READ, COUNT_WRITE 
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE INDEX_NAME = 'your_index_name';
å¦‚æœCOUNT_READé•¿æœŸä¸º0ï¼Œè¯´æ˜ç´¢å¼•æœªè¢«ä½¿ç”¨

é—®é¢˜3ï¼šä¸»é”®ç´¢å¼•å¯ä»¥è®¾ä¸ºä¸å¯è§å—ï¼Ÿ
è§£ç­”ï¼šä¸å¯ä»¥ï¼Œä¸»é”®ç´¢å¼•ä¿è¯æ•°æ®å”¯ä¸€æ€§ï¼Œå¿…é¡»å§‹ç»ˆå¯è§
å°è¯•è®¾ç½®ä¼šæ”¶åˆ°é”™è¯¯ï¼šERROR 3522 (HY000): A primary key index cannot be invisible

é—®é¢˜4ï¼šä¸å¯è§ç´¢å¼•ä¼šå½±å“å†™å…¥æ€§èƒ½å—ï¼Ÿ
è§£ç­”ï¼šä¼šçš„ï¼Œä¸å¯è§ç´¢å¼•ä»ç„¶éœ€è¦ç»´æŠ¤
- INSERT/UPDATE/DELETEæ—¶ä»ç„¶æ›´æ–°ç´¢å¼•
- åªæ˜¯SELECTæŸ¥è¯¢æ—¶ä¼˜åŒ–å™¨ä¸ä½¿ç”¨
- æ‰€ä»¥ç¡®è®¤ä¸éœ€è¦çš„ç´¢å¼•åº”è¯¥å½»åº•åˆ é™¤
```

**ğŸ› ï¸ æ•…éšœæ’æŸ¥æŒ‡å—**
```
æ€§èƒ½é—®é¢˜æ’æŸ¥æ­¥éª¤ï¼š

æ­¥éª¤1ï¼šç¡®è®¤é—®é¢˜èŒƒå›´
â”œâ”€ æ£€æŸ¥æ˜¯å¦åªæœ‰ç‰¹å®šæŸ¥è¯¢å—å½±å“
â”œâ”€ ç¡®è®¤é—®é¢˜å‡ºç°çš„æ—¶é—´ç‚¹
â”œâ”€ å¯¹æ¯”å†å²æ€§èƒ½æ•°æ®
â””â”€ è¯†åˆ«å¯èƒ½ç›¸å…³çš„ç´¢å¼•å˜æ›´

æ­¥éª¤2ï¼šå¿«é€Ÿå®šä½åŸå› 
â”œâ”€ æŸ¥çœ‹æœ€è¿‘è®¾ä¸ºä¸å¯è§çš„ç´¢å¼•
â”œâ”€ æ£€æŸ¥EXPLAINæ‰§è¡Œè®¡åˆ’å˜åŒ–
â”œâ”€ åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
â””â”€ ç¡®è®¤ç´¢å¼•ä½¿ç”¨æƒ…å†µ

æ­¥éª¤3ï¼šåˆ¶å®šè§£å†³æ–¹æ¡ˆ
â”œâ”€ è¯„ä¼°ç«‹å³å›é€€çš„å¿…è¦æ€§
â”œâ”€ åˆ†ææ›¿ä»£ä¼˜åŒ–æ–¹æ¡ˆ
â”œâ”€ åˆ¶å®šé•¿æœŸè§£å†³è®¡åˆ’
â””â”€ æ›´æ–°ç´¢å¼•ç®¡ç†ç­–ç•¥
```

### 10.4 ä¸å…¶ä»–MySQLç‰¹æ€§çš„é…åˆ


**ğŸ”— ç‰¹æ€§ç»„åˆä½¿ç”¨**
```
ä¸åœ¨çº¿DDLé…åˆï¼š
-- å®‰å…¨çš„ç´¢å¼•é‡å»ºæµç¨‹
-- 1. åˆ›å»ºæ–°ç´¢å¼•(ä¸å¯è§)
CREATE INDEX idx_new ON table_name (column1, column2) INVISIBLE;

-- 2. éªŒè¯æ–°ç´¢å¼•æ•ˆæœ
ALTER TABLE table_name ALTER INDEX idx_new VISIBLE;
-- æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢éªŒè¯æ•ˆæœ

-- 3. åˆ‡æ¢ç´¢å¼•ä½¿ç”¨
ALTER TABLE table_name ALTER INDEX idx_old INVISIBLE;
ALTER TABLE table_name ALTER INDEX idx_new VISIBLE;

-- 4. ç¡®è®¤æ— é—®é¢˜ååˆ é™¤æ—§ç´¢å¼•
DROP INDEX idx_old ON table_name;

ä¸æŸ¥è¯¢é‡å†™é…åˆï¼š
-- å¯ä»¥é…åˆquery_rewriteæ’ä»¶
-- åœ¨ç´¢å¼•ä¸å¯è§æ—¶è‡ªåŠ¨é‡å†™æŸ¥è¯¢
-- æˆ–è€…æä¾›æŸ¥è¯¢ä¼˜åŒ–å»ºè®®
```

### 10.5 å›¢é˜Ÿåä½œä¸è§„èŒƒ


**ğŸ‘¥ å›¢é˜Ÿä½¿ç”¨è§„èŒƒ**
```
å¼€å‘å›¢é˜Ÿè§„èŒƒï¼š
â”œâ”€ æ–°ç´¢å¼•é»˜è®¤åˆ›å»ºä¸ºä¸å¯è§
â”œâ”€ ç»è¿‡æµ‹è¯•éªŒè¯åè®¾ä¸ºå¯è§
â”œâ”€ ä¸å…è®¸ç›´æ¥åˆ é™¤ç´¢å¼•ï¼Œå…ˆè®¾ä¸ºä¸å¯è§
â””â”€ å»ºç«‹ç´¢å¼•å˜æ›´ç”³è¯·æµç¨‹

DBAå›¢é˜Ÿè§„èŒƒï¼š
â”œâ”€ å®šæœŸå®¡æŸ¥ä¸å¯è§ç´¢å¼•åˆ—è¡¨
â”œâ”€ ç›‘æ§ç´¢å¼•æµ‹è¯•æ‰§è¡Œæƒ…å†µ
â”œâ”€ ç»´æŠ¤ç´¢å¼•æ€§èƒ½åŸºçº¿æ•°æ®
â””â”€ åˆ¶å®šåº”æ€¥å¤„ç†é¢„æ¡ˆ

æµ‹è¯•å›¢é˜Ÿè§„èŒƒï¼š
â”œâ”€ åœ¨åŠŸèƒ½æµ‹è¯•ä¸­åŒ…å«ç´¢å¼•æµ‹è¯•
â”œâ”€ éªŒè¯ç´¢å¼•å¯è§æ€§å¯¹ä¸šåŠ¡çš„å½±å“
â”œâ”€ æŠ¥å‘Šç´¢å¼•ç›¸å…³çš„æ€§èƒ½é—®é¢˜
â””â”€ ååŠ©å»ºç«‹è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹
```

**ğŸ“š çŸ¥è¯†ä¼ æ‰¿æœºåˆ¶**
```
æ–‡æ¡£ç»´æŠ¤ï¼š
â”œâ”€ ç»´æŠ¤ç´¢å¼•æµ‹è¯•ç»éªŒæ–‡æ¡£
â”œâ”€ è®°å½•å…¸å‹é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
â”œâ”€ æ›´æ–°æœ€ä½³å®è·µæŒ‡å—
â””â”€ å»ºç«‹æ¡ˆä¾‹åº“

åŸ¹è®­æœºåˆ¶ï¼š
â”œâ”€ å®šæœŸè¿›è¡Œå›¢é˜ŸåŸ¹è®­
â”œâ”€ åˆ†äº«ç´¢å¼•ä¼˜åŒ–ç»éªŒ
â”œâ”€ æ¼”ç¤ºå·¥å…·ä½¿ç”¨æ–¹æ³•
â””â”€ å»ºç«‹é—®é¢˜è®¨è®ºæœºåˆ¶
```

### 10.6 æ ¸å¿ƒä»·å€¼ä¸æ”¶ç›Š


**ğŸ’° ä¸šåŠ¡ä»·å€¼ä½“ç°**
```
ç›´æ¥æ”¶ç›Šï¼š
â”œâ”€ é™ä½ç´¢å¼•ç»´æŠ¤æˆæœ¬
â”œâ”€ æå‡æŸ¥è¯¢æ€§èƒ½
â”œâ”€ å‡å°‘å­˜å‚¨ç©ºé—´å ç”¨
â””â”€ é™ä½ç³»ç»Ÿè¿ç»´é£é™©

é—´æ¥æ”¶ç›Šï¼š
â”œâ”€ æå‡å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›
â”œâ”€ å»ºç«‹è§„èŒƒåŒ–æµç¨‹
â”œâ”€ ç§¯ç´¯ä¼˜åŒ–ç»éªŒ
â””â”€ å¢å¼ºç³»ç»Ÿç¨³å®šæ€§
```

**ğŸ¯ æŠ€æœ¯ä»·å€¼æ€»ç»“**
- **é£é™©æ§åˆ¶**ï¼šå®‰å…¨çš„ç´¢å¼•æµ‹è¯•æ–¹æ³•ï¼Œé¿å…ç”Ÿäº§äº‹æ•…
- **æ•ˆç‡æå‡**ï¼šè‡ªåŠ¨åŒ–å·¥å…·å‡å°‘äººå·¥æ“ä½œæ—¶é—´
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç³»ç»ŸåŒ–çš„ç´¢å¼•æ¸…ç†æå‡æ•°æ®åº“æ€§èƒ½
- **æˆæœ¬èŠ‚çº¦**ï¼šå‡å°‘ä¸å¿…è¦çš„ç´¢å¼•ç»´æŠ¤å¼€é”€

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¸å¯è§ç´¢å¼•æ˜¯MySQL 8.0çš„å®‰å…¨æµ‹è¯•åˆ©å™¨
- ç´¢å¼•å­˜åœ¨ä½†ä¼˜åŒ–å™¨ä¸ç”¨ï¼Œå¯éšæ—¶åˆ‡æ¢å¯è§æ€§
- ä¸»é”®å”¯ä¸€çº¦æŸä¸èƒ½è®¾ä¸ºä¸å¯è§ï¼Œæ•°æ®å®Œæ•´æ€§ä¼˜å…ˆ
- A/Bæµ‹è¯•æ–¹æ³•ç§‘å­¦è¯„ä¼°ç´¢å¼•ä»·å€¼ï¼Œæ•°æ®é©±åŠ¨å†³ç­–
- ç”Ÿäº§ç¯å¢ƒæµ‹è¯•éœ€è°¨æ…ï¼Œè‡ªåŠ¨åŒ–ç›‘æ§ä¿å®‰å…¨