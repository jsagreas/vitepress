---
title: 22ã€ç´¢å¼•å…ƒæ•°æ®ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ç´¢å¼•å…ƒæ•°æ®åŸºç¡€æ¦‚å¿µ](#1-ç´¢å¼•å…ƒæ•°æ®åŸºç¡€æ¦‚å¿µ)
2. [information_schemaç´¢å¼•ä¿¡æ¯æŸ¥è¯¢](#2-information_schemaç´¢å¼•ä¿¡æ¯æŸ¥è¯¢)
3. [sysåº“ç´¢å¼•ç»Ÿè®¡åˆ†æ](#3-sysåº“ç´¢å¼•ç»Ÿè®¡åˆ†æ)
4. [ç´¢å¼•å®šä¹‰å¤‡ä»½ä¸æ¢å¤](#4-ç´¢å¼•å®šä¹‰å¤‡ä»½ä¸æ¢å¤)
5. [ç´¢å¼•å…ƒæ•°æ®ç‰ˆæœ¬æ§åˆ¶](#5-ç´¢å¼•å…ƒæ•°æ®ç‰ˆæœ¬æ§åˆ¶)
6. [å…ƒæ•°æ®æŸåæ£€æµ‹ä¸ä¿®å¤](#6-å…ƒæ•°æ®æŸåæ£€æµ‹ä¸ä¿®å¤)
7. [ç´¢å¼•ä¾èµ–åˆ†æå·¥å…·](#7-ç´¢å¼•ä¾èµ–åˆ†æå·¥å…·)
8. [å…ƒæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥](#8-å…ƒæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“– ç´¢å¼•å…ƒæ•°æ®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç´¢å¼•å…ƒæ•°æ®


**ğŸ”¸ é€šä¿—ç†è§£**
ç´¢å¼•å…ƒæ•°æ®å°±æ˜¯"å…³äºç´¢å¼•çš„æ•°æ®"ï¼Œç®€å•è¯´å°±æ˜¯æ•°æ®åº“ç”¨æ¥è®°å½•"æˆ‘æœ‰å“ªäº›ç´¢å¼•ï¼Œè¿™äº›ç´¢å¼•é•¿ä»€ä¹ˆæ ·"çš„ä¿¡æ¯ã€‚

```
ç±»æ¯”ç†è§£ï¼š
å›¾ä¹¦é¦†çš„ä¹¦ = æ•°æ®è¡¨ä¸­çš„æ•°æ®
å›¾ä¹¦ç›®å½•å¡ç‰‡ = ç´¢å¼•
ç›®å½•ç®¡ç†ç³»ç»Ÿ = ç´¢å¼•å…ƒæ•°æ®

ç›®å½•ç®¡ç†ç³»ç»Ÿè®°å½•ï¼š
- æœ‰å“ªäº›ç›®å½•å¡ç‰‡
- æ¯ä¸ªå¡ç‰‡æŒ‡å‘å“ªæœ¬ä¹¦
- å¡ç‰‡æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„
- å¡ç‰‡å¤šä¹…æ›´æ–°ä¸€æ¬¡
```

**ğŸ”¸ ç´¢å¼•å…ƒæ•°æ®åŒ…å«çš„ä¿¡æ¯**
```
ç´¢å¼•å…ƒæ•°æ®è®°å½•çš„å†…å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç´¢å¼•åç§°ï¼šidx_user_name             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰€å±è¡¨ï¼šusers                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç´¢å¼•å­—æ®µï¼šname, email               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç´¢å¼•ç±»å‹ï¼šBTREE, HASH              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ›å»ºæ—¶é—´ï¼š2024-01-15 10:30:00      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤§å°ä¿¡æ¯ï¼šå ç”¨ç©ºé—´ã€é¡µæ•°ç­‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç®¡ç†ç´¢å¼•å…ƒæ•°æ®


**ğŸ”¸ å®é™…æ„ä¹‰**
æƒ³è±¡ä½ ç®¡ç†ä¸€ä¸ªå¤§å‹å›¾ä¹¦é¦†ï¼Œå¦‚æœä¸çŸ¥é“æœ‰å“ªäº›ç›®å½•ã€ç›®å½•çš„çŠ¶æ€å¦‚ä½•ï¼Œå°±æ— æ³•æœ‰æ•ˆç»´æŠ¤å›¾ä¹¦é¦†ã€‚ç´¢å¼•å…ƒæ•°æ®ç®¡ç†å°±æ˜¯è¿™ä¸ªé“ç†ã€‚

**ğŸ”¸ å…ƒæ•°æ®ç®¡ç†çš„ä»·å€¼**
- **æ€§èƒ½ç›‘æ§**ï¼šäº†è§£å“ªäº›ç´¢å¼•è¢«é¢‘ç¹ä½¿ç”¨ï¼Œå“ªäº›ä»æœªä½¿ç”¨
- **å®¹é‡è§„åˆ’**ï¼šçŸ¥é“ç´¢å¼•å ç”¨å¤šå°‘å­˜å‚¨ç©ºé—´
- **æ•…éšœè¯Šæ–­**ï¼šå¿«é€Ÿå®šä½ç´¢å¼•ç›¸å…³é—®é¢˜
- **ç‰ˆæœ¬ç®¡ç†**ï¼šè·Ÿè¸ªç´¢å¼•çš„å˜åŒ–å†å²

```
å®é™…å·¥ä½œåœºæ™¯ï¼š
åœºæ™¯1ï¼šæ•°æ®åº“å˜æ…¢äº†
â†’ æŸ¥çœ‹å…ƒæ•°æ®å‘ç°æŸä¸ªå¤§è¡¨ç¼ºå°‘ç´¢å¼•

åœºæ™¯2ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³
â†’ é€šè¿‡å…ƒæ•°æ®æ‰¾åˆ°å ç”¨ç©ºé—´æœ€å¤§çš„æ— ç”¨ç´¢å¼•

åœºæ™¯3ï¼šåº”ç”¨æŠ¥é”™
â†’ é€šè¿‡ä¾èµ–å…³ç³»åˆ†ææ‰¾åˆ°è¢«è¯¯åˆ çš„å…³é”®ç´¢å¼•
```

---

## 2. ğŸ” information_schemaç´¢å¼•ä¿¡æ¯æŸ¥è¯¢


### 2.1 information_schemaæ˜¯ä»€ä¹ˆ


**ğŸ”¸ ç®€å•ç†è§£**
`information_schema`æ˜¯MySQLæä¾›çš„ä¸€ä¸ªç‰¹æ®Šæ•°æ®åº“ï¼Œé‡Œé¢å­˜å‚¨ç€å…³äºæ•´ä¸ªæ•°æ®åº“ç³»ç»Ÿçš„å„ç§ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨ã€åˆ—ã€ç´¢å¼•ç­‰çš„è¯¦ç»†ä¿¡æ¯ã€‚

```
æŠŠæ•°æ®åº“æ¯”ä½œä¸€æ ‹å¤§æ¥¼ï¼š
å®é™…æ•°æ®åº“ = å¤§æ¥¼é‡Œçš„å„ä¸ªæˆ¿é—´å’Œç‰©å“
information_schema = å¤§æ¥¼çš„ç‰©ä¸šç®¡ç†æ¡£æ¡ˆ
é‡Œé¢è®°å½•ç€ï¼š
- æ¯ä¸ªæˆ¿é—´æœ‰ä»€ä¹ˆå®¶å…·ï¼ˆè¡¨ç»“æ„ï¼‰
- æ¯ä»¶å®¶å…·æ”¾åœ¨å“ªé‡Œï¼ˆç´¢å¼•ä½ç½®ï¼‰  
- å®¶å…·ä»€ä¹ˆæ—¶å€™æ·»åŠ çš„ï¼ˆåˆ›å»ºæ—¶é—´ï¼‰
```

### 2.2 æŸ¥è¯¢ç´¢å¼•åŸºæœ¬ä¿¡æ¯


**ğŸ”¸ æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•**
```sql
-- æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰ç´¢å¼•çš„åŸºæœ¬ä¿¡æ¯
SELECT 
    TABLE_SCHEMA as 'æ•°æ®åº“å',
    TABLE_NAME as 'è¡¨å',
    INDEX_NAME as 'ç´¢å¼•å',
    COLUMN_NAME as 'ç´¢å¼•å­—æ®µ',
    SEQ_IN_INDEX as 'å­—æ®µåœ¨ç´¢å¼•ä¸­çš„ä½ç½®',
    INDEX_TYPE as 'ç´¢å¼•ç±»å‹'
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;
```

**ğŸ”¸ æŸ¥è¯¢ç‰¹å®šè¡¨çš„ç´¢å¼•**
```sql
-- æŸ¥çœ‹æŸä¸ªè¡¨çš„æ‰€æœ‰ç´¢å¼•è¯¦æƒ…
SELECT 
    INDEX_NAME as 'ç´¢å¼•å',
    NON_UNIQUE as 'æ˜¯å¦å…è®¸é‡å¤',
    COLUMN_NAME as 'ç´¢å¼•å­—æ®µ', 
    COLLATION as 'æ’åºæ–¹å¼',
    CARDINALITY as 'åŸºæ•°',
    INDEX_TYPE as 'ç´¢å¼•ç±»å‹',
    COMMENT as 'æ³¨é‡Š'
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'your_database' 
  AND TABLE_NAME = 'users'
ORDER BY INDEX_NAME, SEQ_IN_INDEX;
```

### 2.3 ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡æŸ¥è¯¢


**ğŸ”¸ æ‰¾å‡ºä»æœªä½¿ç”¨çš„ç´¢å¼•**
```sql
-- æŸ¥æ‰¾å¯èƒ½æ— ç”¨çš„ç´¢å¼•
SELECT 
    s.TABLE_SCHEMA,
    s.TABLE_NAME,
    s.INDEX_NAME,
    GROUP_CONCAT(s.COLUMN_NAME ORDER BY s.SEQ_IN_INDEX) as 'ç´¢å¼•å­—æ®µ'
FROM information_schema.STATISTICS s
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage p
    ON s.TABLE_SCHEMA = p.OBJECT_SCHEMA
    AND s.TABLE_NAME = p.OBJECT_NAME  
    AND s.INDEX_NAME = p.INDEX_NAME
WHERE s.TABLE_SCHEMA = 'your_database'
  AND s.INDEX_NAME != 'PRIMARY'
  AND (p.COUNT_READ IS NULL OR p.COUNT_READ = 0)
GROUP BY s.TABLE_SCHEMA, s.TABLE_NAME, s.INDEX_NAME;
```

**ğŸ”¸ åˆ†æç´¢å¼•å¤§å°**
```sql
-- æŸ¥çœ‹ç´¢å¼•å ç”¨çš„å­˜å‚¨ç©ºé—´
SELECT 
    TABLE_NAME as 'è¡¨å',
    INDEX_NAME as 'ç´¢å¼•å',
    ROUND(STAT_VALUE * $$innodb_page_size / 1024 / 1024, 2) as 'ç´¢å¼•å¤§å°MB'
FROM information_schema.INNODB_SYS_INDEXES i
JOIN information_schema.INNODB_SYS_TABLESTATS s 
    ON i.TABLE_ID = s.TABLE_ID
WHERE i.NAME != 'PRIMARY'
ORDER BY STAT_VALUE DESC;
```

---

## 3. ğŸ“Š sysåº“ç´¢å¼•ç»Ÿè®¡åˆ†æ


### 3.1 sysåº“çš„ä½œç”¨


**ğŸ”¸ sysåº“ç®€ä»‹**
`sys`åº“æ˜¯MySQL 5.7+ç‰ˆæœ¬æä¾›çš„ä¸€ä¸ªä¾¿æ°‘å·¥å…·åº“ï¼Œå®ƒæŠŠå¤æ‚çš„æ€§èƒ½æ•°æ®æ•´ç†æˆå®¹æ˜“ç†è§£çš„è§†å›¾ã€‚å¦‚æœè¯´`information_schema`æ˜¯åŸå§‹æ¡£æ¡ˆï¼Œé‚£ä¹ˆ`sys`åº“å°±æ˜¯æ•´ç†å¥½çš„ç»Ÿè®¡æŠ¥è¡¨ã€‚

```
å¯¹æ¯”ç†è§£ï¼š
information_schema = åŸå§‹è®°å½•æœ¬
â€¢ ä¿¡æ¯å…¨é¢ä½†å¤æ‚
â€¢ éœ€è¦å¤æ‚SQLæ‰èƒ½è·å¾—æœ‰ç”¨ä¿¡æ¯

sysåº“ = æ•´ç†å¥½çš„åˆ†ææŠ¥å‘Š
â€¢ ä¿¡æ¯ç›´è§‚æ˜“æ‡‚  
â€¢ æä¾›ç°æˆçš„åˆ†æè§†å›¾
```

### 3.2 ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ


**ğŸ”¸ æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡**
```sql
-- æŸ¥çœ‹å“ªäº›ç´¢å¼•ä½¿ç”¨é¢‘ç‡æœ€é«˜
SELECT 
    object_schema as 'æ•°æ®åº“',
    object_name as 'è¡¨å',
    index_name as 'ç´¢å¼•å',
    count_read as 'è¯»å–æ¬¡æ•°',
    count_write as 'å†™å…¥æ¬¡æ•°',
    count_fetch as 'è·å–æ¬¡æ•°'
FROM sys.schema_index_statistics
WHERE object_schema = 'your_database'
ORDER BY count_read DESC;
```

**ğŸ”¸ æ‰¾å‡ºå†—ä½™ç´¢å¼•**
```sql
-- æŸ¥æ‰¾å¯èƒ½é‡å¤çš„ç´¢å¼•
SELECT 
    table_schema as 'æ•°æ®åº“',
    table_name as 'è¡¨å', 
    redundant_index_name as 'å†—ä½™ç´¢å¼•',
    redundant_index_columns as 'å†—ä½™ç´¢å¼•å­—æ®µ',
    dominant_index_name as 'ä¸»å¯¼ç´¢å¼•',
    dominant_index_columns as 'ä¸»å¯¼ç´¢å¼•å­—æ®µ'
FROM sys.schema_redundant_indexes
WHERE table_schema = 'your_database';
```

### 3.3 ç´¢å¼•æ•ˆç‡åˆ†æ


**ğŸ”¸ æœªä½¿ç”¨ç´¢å¼•è¯†åˆ«**
```sql
-- æ‰¾å‡ºä»æ¥æ²¡è¢«ç”¨è¿‡çš„ç´¢å¼•ï¼ˆé™¤äº†ä¸»é”®ï¼‰
SELECT 
    object_schema as 'æ•°æ®åº“',
    object_name as 'è¡¨å',
    index_name as 'ç´¢å¼•å'
FROM sys.schema_unused_indexes
WHERE object_schema = 'your_database';
```

**ğŸ”¸ ç´¢å¼•ç­‰å¾…ç»Ÿè®¡**
```sql
-- æŸ¥çœ‹ç´¢å¼•ç­‰å¾…æƒ…å†µ
SELECT 
    object_schema as 'æ•°æ®åº“',
    object_name as 'è¡¨å',
    index_name as 'ç´¢å¼•å',
    count_read as 'è¯»æ¬¡æ•°',
    sum_timer_read/1000000000 as 'è¯»è€—æ—¶ç§’',
    count_write as 'å†™æ¬¡æ•°',  
    sum_timer_write/1000000000 as 'å†™è€—æ—¶ç§’'
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE object_schema = 'your_database'
  AND count_read > 0
ORDER BY sum_timer_read DESC;
```

---

## 4. ğŸ’¾ ç´¢å¼•å®šä¹‰å¤‡ä»½ä¸æ¢å¤


### 4.1 ä¸ºä»€ä¹ˆè¦å¤‡ä»½ç´¢å¼•å®šä¹‰


**ğŸ”¸ å®é™…åœºæ™¯ç†è§£**
å‡è®¾ä½ ç²¾å¿ƒè°ƒä¼˜äº†æ•°æ®åº“çš„ç´¢å¼•ç»“æ„ï¼Œçªç„¶æœ‰ä¸€å¤©éœ€è¦é‡å»ºæ•°æ®åº“ï¼Œæˆ–è€…è¯¯åˆ äº†æŸä¸ªå…³é”®ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰å¤‡ä»½ç´¢å¼•å®šä¹‰ï¼Œå°±è¦é‡æ–°ä»å¤´åˆ†æå’Œåˆ›å»ºï¼Œè¿™ä¼šæµªè´¹å¤§é‡æ—¶é—´ã€‚

```
å¸¸è§éœ€è¦å¤‡ä»½çš„åœºæ™¯ï¼š
â€¢ æ•°æ®åº“è¿ç§»ï¼šä»æµ‹è¯•ç¯å¢ƒåˆ°ç”Ÿäº§ç¯å¢ƒ
â€¢ ç‰ˆæœ¬å‡çº§ï¼šMySQLç‰ˆæœ¬å‡çº§åé‡å»ºç´¢å¼•  
â€¢ æ•…éšœæ¢å¤ï¼šç¡¬ä»¶æ•…éšœåçš„æ•°æ®åº“é‡å»º
â€¢ æ€§èƒ½å›æ»šï¼šç´¢å¼•ä¼˜åŒ–å¤±è´¥éœ€è¦å›åˆ°åŸçŠ¶æ€
```

### 4.2 ç´¢å¼•å®šä¹‰çš„å¯¼å‡º


**ğŸ”¸ ä½¿ç”¨mysqldumpå¤‡ä»½ç´¢å¼•**
```bash
# åªå¯¼å‡ºè¡¨ç»“æ„ï¼ˆåŒ…æ‹¬ç´¢å¼•å®šä¹‰ï¼‰
mysqldump -u username -p \
  --no-data \
  --routines \
  --triggers \
  your_database > schema_backup.sql

# åªå¯¼å‡ºæŸä¸ªè¡¨çš„ç»“æ„
mysqldump -u username -p \
  --no-data \
  your_database users > users_schema.sql
```

**ğŸ”¸ é€šè¿‡SQLè¯­å¥å¯¼å‡ºç´¢å¼•å®šä¹‰**
```sql
-- ç”Ÿæˆé‡å»ºç´¢å¼•çš„SQLè¯­å¥
SELECT CONCAT(
    'CREATE ',
    CASE WHEN NON_UNIQUE = 0 THEN 'UNIQUE ' ELSE '' END,
    'INDEX `', INDEX_NAME, '` ON `', TABLE_NAME, '` (',
    GROUP_CONCAT(
        CONCAT('`', COLUMN_NAME, '`') 
        ORDER BY SEQ_IN_INDEX 
        SEPARATOR ', '
    ),
    ');'
) as 'ç´¢å¼•åˆ›å»ºè¯­å¥'
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_SCHEMA, TABLE_NAME, INDEX_NAME;
```

### 4.3 ç´¢å¼•å®šä¹‰çš„ç®¡ç†ç­–ç•¥


**ğŸ”¸ åˆ†ç¯å¢ƒç®¡ç†**
```
ç¯å¢ƒç®¡ç†ç­–ç•¥ï¼š
å¼€å‘ç¯å¢ƒ
    â†“ å¯¼å‡ºç´¢å¼•å®šä¹‰
æµ‹è¯•ç¯å¢ƒ  
    â†“ éªŒè¯ç´¢å¼•æ•ˆæœ
é¢„ç”Ÿäº§ç¯å¢ƒ
    â†“ æ€§èƒ½å‹æµ‹
ç”Ÿäº§ç¯å¢ƒ
    â†“ å®šæœŸå¤‡ä»½
```

```sql
-- åˆ›å»ºç´¢å¼•å˜æ›´è®°å½•è¡¨
CREATE TABLE index_change_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(64),
    index_name VARCHAR(64),  
    action_type ENUM('CREATE', 'DROP', 'MODIFY'),
    index_definition TEXT,
    change_reason VARCHAR(255),
    changed_by VARCHAR(64),
    change_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 5. ğŸ”¥ ç´¢å¼•å…ƒæ•°æ®ç‰ˆæœ¬æ§åˆ¶


### 5.1 ç‰ˆæœ¬æ§åˆ¶çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬æ§åˆ¶**
å°±åƒä»£ç éœ€è¦Gitç®¡ç†ä¸€æ ·ï¼Œæ•°æ®åº“çš„ç´¢å¼•ç»“æ„ä¹Ÿä¼šä¸æ–­å˜åŒ–ï¼Œéœ€è¦è·Ÿè¸ªè¿™äº›å˜åŒ–ã€‚

```
ç‰ˆæœ¬æ§åˆ¶è§£å†³çš„é—®é¢˜ï¼š
é—®é¢˜1ï¼šç´¢å¼•ä¼˜åŒ–åæ€§èƒ½åè€Œå˜å·®äº†ï¼Œæ€ä¹ˆå›æ»šï¼Ÿ
é—®é¢˜2ï¼šçº¿ä¸Šç¯å¢ƒçš„ç´¢å¼•å’Œæµ‹è¯•ç¯å¢ƒä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ  
é—®é¢˜3ï¼šå›¢é˜Ÿæˆå‘˜éƒ½åœ¨ä¿®æ”¹ç´¢å¼•ï¼Œå¦‚ä½•åè°ƒï¼Ÿ
é—®é¢˜4ï¼šç´¢å¼•å˜æ›´çš„å†å²è®°å½•åœ¨å“ªé‡ŒæŸ¥çœ‹ï¼Ÿ
```

### 5.2 ç´¢å¼•ç‰ˆæœ¬æ§åˆ¶å®ç°


**ğŸ”¸ åŸºäºGitçš„Schemaç‰ˆæœ¬æ§åˆ¶**
```bash
# é¡¹ç›®ç»“æ„
database_schema/
â”œâ”€â”€ migration/
â”‚   â”œâ”€â”€ v1.0_initial_indexes.sql
â”‚   â”œâ”€â”€ v1.1_add_user_indexes.sql  
â”‚   â””â”€â”€ v1.2_optimize_order_indexes.sql
â”œâ”€â”€ current/
â”‚   â”œâ”€â”€ users_indexes.sql
â”‚   â”œâ”€â”€ orders_indexes.sql
â”‚   â””â”€â”€ products_indexes.sql
â””â”€â”€ scripts/
    â”œâ”€â”€ export_indexes.sh
    â””â”€â”€ apply_indexes.sh
```

**ğŸ”¸ ç´¢å¼•å˜æ›´ç®¡ç†è„šæœ¬**
```bash
#!/bin/bash
# export_indexes.sh - å¯¼å‡ºå½“å‰ç´¢å¼•å®šä¹‰

DB_NAME="your_database"
OUTPUT_DIR="current"
DATE=$(date +%Y%m%d_%H%M%S)

# ä¸ºæ¯ä¸ªè¡¨å¯¼å‡ºç´¢å¼•å®šä¹‰
mysql -u root -p$DB_PASSWORD -e "
SELECT DISTINCT TABLE_NAME 
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA='$DB_NAME'
" | tail -n +2 | while read table; do
    
    echo "-- è¡¨ $table çš„ç´¢å¼•å®šä¹‰ (ç”Ÿæˆæ—¶é—´: $(date))" > "$OUTPUT_DIR/${table}_indexes.sql"
    
    mysql -u root -p$DB_PASSWORD -e "
    SELECT CONCAT(
        'CREATE ',
        CASE WHEN NON_UNIQUE = 0 THEN 'UNIQUE ' ELSE '' END,
        'INDEX \`', INDEX_NAME, '\` ON \`', TABLE_NAME, '\` (',
        GROUP_CONCAT(
            CONCAT('\`', COLUMN_NAME, '\`') 
            ORDER BY SEQ_IN_INDEX 
        ),
        ');'
    )
    FROM information_schema.STATISTICS
    WHERE TABLE_SCHEMA='$DB_NAME' 
      AND TABLE_NAME='$table'
      AND INDEX_NAME != 'PRIMARY'
    GROUP BY INDEX_NAME;
    " >> "$OUTPUT_DIR/${table}_indexes.sql"
    
done

# æäº¤åˆ°Git
git add .
git commit -m "ç´¢å¼•å®šä¹‰å¤‡ä»½ - $DATE"
```

### 5.3 ç‰ˆæœ¬å¯¹æ¯”ä¸å·®å¼‚åˆ†æ


**ğŸ”¸ ç´¢å¼•å˜æ›´æ£€æµ‹**
```sql
-- åˆ›å»ºç´¢å¼•å¿«ç…§è¡¨  
CREATE TABLE index_snapshots (
    id INT AUTO_INCREMENT PRIMARY KEY,
    snapshot_date DATE,
    table_name VARCHAR(64),
    index_name VARCHAR(64),
    index_columns TEXT,
    index_type VARCHAR(16),
    is_unique BOOLEAN,
    comment VARCHAR(255)
);

-- è®°å½•å½“å‰ç´¢å¼•å¿«ç…§
INSERT INTO index_snapshots (
    snapshot_date, table_name, index_name, 
    index_columns, index_type, is_unique
)
SELECT 
    CURDATE(),
    TABLE_NAME,
    INDEX_NAME,
    GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX),
    INDEX_TYPE,
    CASE WHEN NON_UNIQUE = 0 THEN TRUE ELSE FALSE END
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_NAME, INDEX_NAME;
```

**ğŸ”¸ ç‰ˆæœ¬å·®å¼‚å¯¹æ¯”**
```sql
-- å¯¹æ¯”ä¸¤ä¸ªæ—¶é—´ç‚¹çš„ç´¢å¼•å·®å¼‚
SELECT 
    COALESCE(a.table_name, b.table_name) as 'è¡¨å',
    COALESCE(a.index_name, b.index_name) as 'ç´¢å¼•å',
    CASE 
        WHEN a.index_name IS NULL THEN 'æ–°å¢'
        WHEN b.index_name IS NULL THEN 'åˆ é™¤'  
        WHEN a.index_columns != b.index_columns THEN 'ä¿®æ”¹'
        ELSE 'æ— å˜åŒ–'
    END as 'å˜æ›´ç±»å‹',
    a.index_columns as 'å½“å‰å®šä¹‰',
    b.index_columns as 'å†å²å®šä¹‰'
FROM 
    (SELECT * FROM index_snapshots WHERE snapshot_date = '2024-12-01') a
FULL OUTER JOIN 
    (SELECT * FROM index_snapshots WHERE snapshot_date = '2024-11-01') b
    ON a.table_name = b.table_name AND a.index_name = b.index_name
WHERE a.index_name IS NULL 
   OR b.index_name IS NULL 
   OR a.index_columns != b.index_columns;
```

---

## 6. ğŸ”¥ å…ƒæ•°æ®æŸåæ£€æµ‹ä¸ä¿®å¤


### 6.1 ä»€ä¹ˆæ˜¯å…ƒæ•°æ®æŸå


**ğŸ”¸ é€šä¿—ç†è§£**
å…ƒæ•°æ®æŸåå°±åƒå›¾ä¹¦é¦†çš„ç›®å½•å¡ç‰‡å‡ºäº†é—®é¢˜â€”â€”å¯èƒ½å¡ç‰‡å†…å®¹é”™è¯¯ï¼Œæˆ–è€…å¡ç‰‡æŒ‡å‘äº†ä¸å­˜åœ¨çš„ä¹¦ï¼Œæˆ–è€…ä¹¦å­˜åœ¨ä½†æ²¡æœ‰å¯¹åº”çš„å¡ç‰‡ã€‚

```
å¸¸è§çš„å…ƒæ•°æ®æŸåæƒ…å†µï¼š
æƒ…å†µ1ï¼šç´¢å¼•å®šä¹‰å­˜åœ¨ï¼Œä½†å®é™…ç´¢å¼•æ–‡ä»¶ä¸¢å¤±
æƒ…å†µ2ï¼šç´¢å¼•æ–‡ä»¶å­˜åœ¨ï¼Œä½†å…ƒæ•°æ®è®°å½•ä¸¢å¤±
æƒ…å†µ3ï¼šç´¢å¼•å…ƒæ•°æ®è®°å½•é”™è¯¯ï¼ˆå¦‚å¤§å°ã€è¡Œæ•°ç»Ÿè®¡ä¸å¯¹ï¼‰
æƒ…å†µ4ï¼šç´¢å¼•å’Œè¡¨çš„å…³è”å…³ç³»å¼‚å¸¸
```

### 6.2 å…ƒæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ”¸ æ£€æŸ¥ç´¢å¼•æ–‡ä»¶å®Œæ•´æ€§**
```sql
-- MySQLæä¾›çš„ç´¢å¼•ä¸€è‡´æ€§æ£€æŸ¥
CHECK TABLE your_table_name;

-- æ›´è¯¦ç»†çš„æ£€æŸ¥
CHECK TABLE your_table_name EXTENDED;

-- æ£€æŸ¥ç»“æœç¤ºä¾‹ï¼š
-- +-------------------+-------+----------+----------+
-- | Table             | Op    | Msg_type | Msg_text |  
-- +-------------------+-------+----------+----------+
-- | your_db.your_table| check | status   | OK       |
-- +-------------------+-------+----------+----------+
```

**ğŸ”¸ æ£€æŸ¥ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ€§**
```sql
-- æ£€æŸ¥è¡¨çš„ç»Ÿè®¡ä¿¡æ¯æ˜¯å¦è¿‡æ—¶
SELECT 
    TABLE_NAME as 'è¡¨å',
    TABLE_ROWS as 'ç»Ÿè®¡è¡Œæ•°',
    UPDATE_TIME as 'æœ€åæ›´æ–°æ—¶é—´',
    CASE 
        WHEN UPDATE_TIME < DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 'ç»Ÿè®¡ä¿¡æ¯å¯èƒ½è¿‡æ—¶'
        ELSE 'ç»Ÿè®¡ä¿¡æ¯è¾ƒæ–°'
    END as 'çŠ¶æ€è¯„ä¼°'
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'your_database'
  AND TABLE_TYPE = 'BASE TABLE'
ORDER BY UPDATE_TIME;
```

### 6.3 å…ƒæ•°æ®ä¿®å¤ç­–ç•¥


**ğŸ”¸ é‡å»ºç´¢å¼•ç»Ÿè®¡ä¿¡æ¯**
```sql
-- æ›´æ–°è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE users;

-- æ‰¹é‡æ›´æ–°æ‰€æœ‰è¡¨çš„ç»Ÿè®¡ä¿¡æ¯
SELECT CONCAT('ANALYZE TABLE ', TABLE_NAME, ';') as 'SQLè¯­å¥'
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'your_database'
  AND TABLE_TYPE = 'BASE TABLE';
```

**ğŸ”¸ ç´¢å¼•é‡å»º**
```sql
-- é‡å»ºæŸåçš„ç´¢å¼•
-- æ­¥éª¤1ï¼šå…ˆåˆ é™¤æŸåçš„ç´¢å¼•
DROP INDEX idx_user_email ON users;

-- æ­¥éª¤2ï¼šé‡æ–°åˆ›å»ºç´¢å¼•  
CREATE INDEX idx_user_email ON users(email);

-- æ­¥éª¤3ï¼šéªŒè¯ç´¢å¼•æ˜¯å¦æ­£å¸¸
SHOW INDEX FROM users WHERE Key_name = 'idx_user_email';
```

**ğŸ”¸ è‡ªåŠ¨åŒ–ä¿®å¤è„šæœ¬**
```bash
#!/bin/bash
# index_health_check.sh - ç´¢å¼•å¥åº·æ£€æŸ¥è„šæœ¬

DB_NAME="your_database"
LOG_FILE="/var/log/mysql/index_check.log"

echo "$(date): å¼€å§‹ç´¢å¼•å¥åº·æ£€æŸ¥" >> $LOG_FILE

# æ£€æŸ¥æ‰€æœ‰è¡¨
mysql -u root -p$DB_PASSWORD -e "
SELECT TABLE_NAME 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA='$DB_NAME'
" | tail -n +2 | while read table; do
    
    echo "æ£€æŸ¥è¡¨: $table"
    
    # æ‰§è¡Œè¡¨æ£€æŸ¥
    result=$(mysql -u root -p$DB_PASSWORD -e "CHECK TABLE $DB_NAME.$table" 2>&1)
    
    if [[ $result == *"error"* ]]; then
        echo "$(date): å‘ç°é—®é¢˜ - $table: $result" >> $LOG_FILE
        
        # å°è¯•ä¿®å¤
        echo "$(date): å°è¯•ä¿®å¤è¡¨ $table" >> $LOG_FILE
        mysql -u root -p$DB_PASSWORD -e "REPAIR TABLE $DB_NAME.$table"
    fi
    
done

echo "$(date): ç´¢å¼•å¥åº·æ£€æŸ¥å®Œæˆ" >> $LOG_FILE
```

---

## 7. ğŸ”¥ ç´¢å¼•ä¾èµ–åˆ†æå·¥å…·


### 7.1 ä»€ä¹ˆæ˜¯ç´¢å¼•ä¾èµ–å…³ç³»


**ğŸ”¸ ä¾èµ–å…³ç³»çš„æ¦‚å¿µ**
ç´¢å¼•ä¾èµ–å…³ç³»å°±æ˜¯"å“ªäº›ä¸œè¥¿éœ€è¦ç”¨åˆ°è¿™ä¸ªç´¢å¼•"ã€‚åˆ é™¤ä¸€ä¸ªç´¢å¼•å‰ï¼Œå¿…é¡»ææ¸…æ¥šä¼šå½±å“å“ªäº›æŸ¥è¯¢ã€å“ªäº›åº”ç”¨åŠŸèƒ½ã€‚

```
ç´¢å¼•ä¾èµ–å…³ç³»ç¤ºä¾‹ï¼š
ç´¢å¼•ï¼šidx_user_email
    â†“ è¢«ä»¥ä¸‹æŸ¥è¯¢ä¾èµ–
â”œâ”€â”€ ç”¨æˆ·ç™»å½•æŸ¥è¯¢ï¼šWHERE email = ?
â”œâ”€â”€ é‚®ä»¶è¥é”€æŸ¥è¯¢ï¼šWHERE email LIKE '%@gmail.com'  
â”œâ”€â”€ é‡å¤é‚®ç®±æ£€æŸ¥ï¼šGROUP BY email HAVING COUNT(*) > 1
â””â”€â”€ ç”¨æˆ·ç»Ÿè®¡æŠ¥è¡¨ï¼šORDER BY email
```

### 7.2 ä¾èµ–å…³ç³»åˆ†æå®ç°


**ğŸ”¸ æŸ¥è¯¢å†å²åˆ†æ**
```sql
-- åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰¾å‡ºä½¿ç”¨ç‰¹å®šç´¢å¼•çš„æŸ¥è¯¢
-- è¿™éœ€è¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 0.1;  -- è®°å½•è¶…è¿‡0.1ç§’çš„æŸ¥è¯¢

-- åˆ›å»ºæŸ¥è¯¢åˆ†æè¡¨
CREATE TABLE query_index_usage (
    id INT AUTO_INCREMENT PRIMARY KEY,
    query_text TEXT,
    table_name VARCHAR(64),
    index_name VARCHAR(64),
    query_time DECIMAL(10,6),
    rows_examined INT,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ğŸ”¸ å®æ—¶æŸ¥è¯¢ç›‘æ§**
```sql
-- ç›‘æ§å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢åŠå…¶ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    p.ID as 'è¿›ç¨‹ID',
    p.USER as 'ç”¨æˆ·',
    p.HOST as 'æ¥æº',
    p.DB as 'æ•°æ®åº“',
    p.COMMAND as 'å‘½ä»¤',
    p.TIME as 'æ‰§è¡Œæ—¶é—´',
    p.INFO as 'SQLè¯­å¥'
FROM information_schema.PROCESSLIST p
WHERE p.COMMAND = 'Query'
  AND p.INFO IS NOT NULL
  AND p.TIME > 1;  -- æ‰§è¡Œè¶…è¿‡1ç§’çš„æŸ¥è¯¢
```

### 7.3 ä¾èµ–åˆ†æå·¥å…·å¼€å‘


**ğŸ”¸ ç®€å•çš„ä¾èµ–åˆ†æè„šæœ¬**
```python
#!/usr/bin/env python3
# index_dependency_analyzer.py

import mysql.connector
import re
from collections import defaultdict

class IndexDependencyAnalyzer:
    def __init__(self, db_config):
        self.db = mysql.connector.connect(**db_config)
        self.cursor = self.db.cursor()
        
    def analyze_query_dependencies(self, query_sql):
        """åˆ†æSQLæŸ¥è¯¢å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•"""
        dependencies = []
        
        # æå–è¡¨å
        tables = re.findall(r'FROM\s+(\w+)', query_sql, re.IGNORECASE)
        tables.extend(re.findall(r'JOIN\s+(\w+)', query_sql, re.IGNORECASE))
        
        # æå–WHEREæ¡ä»¶ä¸­çš„å­—æ®µ
        where_fields = re.findall(r'WHERE.*?(\w+)\s*[=<>]', query_sql, re.IGNORECASE)
        
        # æŸ¥è¯¢è¿™äº›è¡¨ä¸Šçš„ç›¸å…³ç´¢å¼•
        for table in set(tables):
            self.cursor.execute("""
                SELECT INDEX_NAME, COLUMN_NAME
                FROM information_schema.STATISTICS
                WHERE TABLE_SCHEMA = DATABASE()
                  AND TABLE_NAME = %s
                  AND COLUMN_NAME IN %s
            """, (table, tuple(where_fields) if where_fields else ('',)))
            
            for index_name, column_name in self.cursor.fetchall():
                dependencies.append(f"{table}.{index_name} (å­—æ®µ: {column_name})")
                
        return dependencies
    
    def get_index_usage_report(self, index_name):
        """è·å–æŒ‡å®šç´¢å¼•çš„ä½¿ç”¨æƒ…å†µæŠ¥å‘Š"""
        self.cursor.execute("""
            SELECT 
                count_read, count_write, count_fetch,
                sum_timer_read/1000000000 as read_time_sec
            FROM performance_schema.table_io_waits_summary_by_index_usage
            WHERE INDEX_NAME = %s
        """, (index_name,))
        
        result = self.cursor.fetchone()
        if result:
            return {
                "è¯»å–æ¬¡æ•°": result[0],
                "å†™å…¥æ¬¡æ•°": result[1], 
                "è·å–æ¬¡æ•°": result[2],
                "æ€»è¯»å–æ—¶é—´": f"{result[3]:.3f}ç§’"
            }
        return None

# ä½¿ç”¨ç¤ºä¾‹
db_config = {
    'host': 'localhost',
    'user': 'root', 
    'password': 'your_password',
    'database': 'your_database'
}

analyzer = IndexDependencyAnalyzer(db_config)

# åˆ†ææŸ¥è¯¢çš„ç´¢å¼•ä¾èµ–
sql = "SELECT * FROM users WHERE email = 'test@example.com'"
deps = analyzer.analyze_query_dependencies(sql)
print("æŸ¥è¯¢ä¾èµ–çš„ç´¢å¼•:", deps)

# è·å–ç´¢å¼•ä½¿ç”¨æŠ¥å‘Š
report = analyzer.get_index_usage_report('idx_user_email')
print("ç´¢å¼•ä½¿ç”¨æƒ…å†µ:", report)
```

---

## 8. âœ… å…ƒæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


### 8.1 ä¸€è‡´æ€§æ£€æŸ¥çš„ç»´åº¦


**ğŸ”¸ æ£€æŸ¥èŒƒå›´**
å…ƒæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥è¦ç¡®ä¿æ•°æ®åº“è®°å½•çš„ä¿¡æ¯å’Œå®é™…æƒ…å†µä¸€è‡´ï¼š

```
ä¸€è‡´æ€§æ£€æŸ¥ç»´åº¦ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç´¢å¼•å®šä¹‰ vs å®é™…æ–‡ä»¶                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ ç»Ÿè®¡ä¿¡æ¯ vs çœŸå®æ•°æ®é‡              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤–é”®çº¦æŸ vs ç´¢å¼•æ”¯æŒ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸åŒç¯å¢ƒé—´çš„ç´¢å¼•ä¸€è‡´æ€§              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ä¸€è‡´æ€§æ£€æŸ¥å®ç°


**ğŸ”¸ è·¨ç¯å¢ƒç´¢å¼•å¯¹æ¯”**
```sql
-- åˆ›å»ºç¯å¢ƒå¯¹æ¯”ä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE env_index_comparison AS
SELECT 
    'ç”Ÿäº§ç¯å¢ƒ' as environment,
    TABLE_NAME,
    INDEX_NAME,
    GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) as index_columns
FROM information_schema.STATISTICS  
WHERE TABLE_SCHEMA = 'prod_database'
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_NAME, INDEX_NAME

UNION ALL

SELECT 
    'æµ‹è¯•ç¯å¢ƒ' as environment,
    TABLE_NAME,
    INDEX_NAME, 
    GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) as index_columns
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'test_database'
  AND INDEX_NAME != 'PRIMARY'
GROUP BY TABLE_NAME, INDEX_NAME;

-- æ‰¾å‡ºç¯å¢ƒé—´çš„ç´¢å¼•å·®å¼‚
SELECT 
    table_name as 'è¡¨å',
    index_name as 'ç´¢å¼•å',
    GROUP_CONCAT(environment) as 'å­˜åœ¨ç¯å¢ƒ'
FROM env_index_comparison
GROUP BY table_name, index_name
HAVING COUNT(DISTINCT environment) = 1;  -- åªåœ¨ä¸€ä¸ªç¯å¢ƒä¸­å­˜åœ¨
```

### 8.3 è‡ªåŠ¨åŒ–ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ”¸ å®šæœŸæ£€æŸ¥è„šæœ¬**
```python
#!/usr/bin/env python3
# metadata_consistency_checker.py

import mysql.connector
from datetime import datetime
import json

class MetadataConsistencyChecker:
    def __init__(self, db_configs):
        self.environments = {}
        for env_name, config in db_configs.items():
            self.environments[env_name] = mysql.connector.connect(**config)
    
    def get_environment_indexes(self, env_name):
        """è·å–æŒ‡å®šç¯å¢ƒçš„æ‰€æœ‰ç´¢å¼•ä¿¡æ¯"""
        conn = self.environments[env_name]
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT 
                TABLE_NAME,
                INDEX_NAME,
                GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) as columns,
                INDEX_TYPE,
                NON_UNIQUE
            FROM information_schema.STATISTICS
            WHERE TABLE_SCHEMA = DATABASE()
              AND INDEX_NAME != 'PRIMARY'
            GROUP BY TABLE_NAME, INDEX_NAME
        """)
        
        indexes = {}
        for row in cursor.fetchall():
            table_name, index_name, columns, index_type, non_unique = row
            key = f"{table_name}.{index_name}"
            indexes[key] = {
                "columns": columns,
                "type": index_type,
                "unique": not non_unique
            }
        
        cursor.close()
        return indexes
    
    def compare_environments(self, env1, env2):
        """å¯¹æ¯”ä¸¤ä¸ªç¯å¢ƒçš„ç´¢å¼•å·®å¼‚"""
        indexes1 = self.get_environment_indexes(env1)
        indexes2 = self.get_environment_indexes(env2)
        
        all_indexes = set(indexes1.keys()) | set(indexes2.keys())
        
        differences = {
            "missing_in_" + env2: [],
            "missing_in_" + env1: [],
            "definition_differences": []
        }
        
        for index_key in all_indexes:
            if index_key not in indexes1:
                differences["missing_in_" + env1].append(index_key)
            elif index_key not in indexes2:
                differences["missing_in_" + env2].append(index_key)
            elif indexes1[index_key] != indexes2[index_key]:
                differences["definition_differences"].append({
                    "index": index_key,
                    env1: indexes1[index_key],
                    env2: indexes2[index_key]
                })
        
        return differences
    
    def generate_sync_sql(self, differences, target_env):
        """ç”ŸæˆåŒæ­¥SQLè¯­å¥"""
        sync_sqls = []
        
        # ç”Ÿæˆåˆ›å»ºç¼ºå¤±ç´¢å¼•çš„SQL
        for missing_index in differences.get(f"missing_in_{target_env}", []):
            table_name, index_name = missing_index.split('.')
            # è¿™é‡Œéœ€è¦æ ¹æ®æºç¯å¢ƒçš„ç´¢å¼•å®šä¹‰ç”ŸæˆCREATE INDEXè¯­å¥
            sync_sqls.append(f"-- éœ€è¦åœ¨{target_env}ä¸­åˆ›å»ºç´¢å¼•: {missing_index}")
            
        return sync_sqls

# ä½¿ç”¨ç¤ºä¾‹
db_configs = {
    "production": {
        'host': 'prod-server',
        'user': 'root',
        'password': 'prod_password',
        'database': 'production_db'
    },
    "staging": {
        'host': 'stage-server', 
        'user': 'root',
        'password': 'stage_password',
        'database': 'staging_db'
    }
}

checker = MetadataConsistencyChecker(db_configs)
differences = checker.compare_environments("production", "staging")

print("ç¯å¢ƒå·®å¼‚åˆ†æ:")
print(json.dumps(differences, indent=2, ensure_ascii=False))
```

### 8.4 æŸåä¿®å¤æ“ä½œ


**ğŸ”¸ å¸¸è§ä¿®å¤æ“ä½œ**

> âš ï¸ **é‡è¦æé†’**ï¼šä¿®å¤æ“ä½œå‰åŠ¡å¿…åšå¥½æ•°æ®å¤‡ä»½

```sql
-- 1. ä¿®å¤è¡¨å’Œç´¢å¼•
REPAIR TABLE your_table_name;

-- 2. ä¼˜åŒ–è¡¨ï¼ˆé‡å»ºç´¢å¼•ï¼‰
OPTIMIZE TABLE your_table_name;

-- 3. é‡å»ºç‰¹å®šç´¢å¼•
ALTER TABLE your_table_name DROP INDEX index_name;
ALTER TABLE your_table_name ADD INDEX index_name (column_list);

-- 4. å¼ºåˆ¶åˆ·æ–°ç»Ÿè®¡ä¿¡æ¯
FLUSH TABLES your_table_name;
ANALYZE TABLE your_table_name;
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ç´¢å¼•å…ƒæ•°æ®ç®¡ç†åŸºç¡€**
```
æ ¸å¿ƒæ¦‚å¿µç†è§£ï¼š
â€¢ å…ƒæ•°æ®ï¼šå…³äºæ•°æ®çš„æ•°æ®ï¼Œè®°å½•ç´¢å¼•çš„åŸºæœ¬ä¿¡æ¯
â€¢ information_schemaï¼šMySQLçš„ç³»ç»Ÿä¿¡æ¯æ•°æ®åº“
â€¢ sysåº“ï¼šå‹å¥½çš„æ€§èƒ½åˆ†æè§†å›¾é›†åˆ
â€¢ ç‰ˆæœ¬æ§åˆ¶ï¼šè·Ÿè¸ªç´¢å¼•å˜æ›´å†å²
â€¢ ä¸€è‡´æ€§æ£€æŸ¥ï¼šç¡®ä¿å…ƒæ•°æ®å’Œå®é™…æƒ…å†µåŒ¹é…
```

### 9.2 å…³é”®ç®¡ç†ç­–ç•¥


**ğŸ”¸ æ—¥å¸¸ç®¡ç†æµç¨‹**
```
ç´¢å¼•ç®¡ç†æœ€ä½³å®è·µï¼š
1ï¸âƒ£ å®šæœŸå¤‡ä»½ç´¢å¼•å®šä¹‰
2ï¸âƒ£ ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µ
3ï¸âƒ£ æ£€æŸ¥å…ƒæ•°æ®ä¸€è‡´æ€§
4ï¸âƒ£ åˆ†æç´¢å¼•ä¾èµ–å…³ç³»  
5ï¸âƒ£ æ¸…ç†æ— ç”¨ç´¢å¼•
6ï¸âƒ£ è®°å½•æ‰€æœ‰å˜æ›´æ“ä½œ
```

**ğŸ”¸ é—®é¢˜å¤„ç†æµç¨‹**
```
æ•…éšœå¤„ç†æ­¥éª¤ï¼š
å‘ç°é—®é¢˜
    â†“
æ£€æŸ¥å…ƒæ•°æ®
    â†“
åˆ†æå½±å“èŒƒå›´
    â†“  
åˆ¶å®šä¿®å¤æ–¹æ¡ˆ
    â†“
æ‰§è¡Œä¿®å¤æ“ä½œ
    â†“
éªŒè¯ä¿®å¤ç»“æœ
```

### 9.3 å®ç”¨å·¥å…·ä¸æŠ€å·§


**ğŸ”¸ å¿…å¤‡æŸ¥è¯¢æ¨¡æ¿**
```sql
-- 1. æŸ¥çœ‹è¡¨çš„æ‰€æœ‰ç´¢å¼•
SHOW INDEX FROM table_name;

-- 2. æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT * FROM sys.schema_unused_indexes 
WHERE object_schema = 'your_database';

-- 3. æŸ¥æ‰¾é‡å¤ç´¢å¼•
SELECT * FROM sys.schema_redundant_indexes
WHERE table_schema = 'your_database';

-- 4. ç´¢å¼•å¤§å°ç»Ÿè®¡  
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    ROUND(STAT_VALUE * $$innodb_page_size / 1024 / 1024, 2) as 'Size_MB'
FROM information_schema.INNODB_SYS_INDEXES
ORDER BY STAT_VALUE DESC;
```

### 9.4 å…ƒæ•°æ®ç®¡ç†çš„ä¸šåŠ¡ä»·å€¼


**ğŸ”¸ å¯¹ä¸šåŠ¡çš„ç›´æ¥å½±å“**
- **æ€§èƒ½ç¨³å®š**ï¼šåŠæ—¶å‘ç°å’Œä¿®å¤ç´¢å¼•é—®é¢˜ï¼Œä¿è¯æŸ¥è¯¢æ€§èƒ½
- **æˆæœ¬æ§åˆ¶**ï¼šæ¸…ç†æ— ç”¨ç´¢å¼•ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´å’Œç»´æŠ¤æˆæœ¬
- **é£é™©é˜²æ§**ï¼šç‰ˆæœ¬æ§åˆ¶å’Œä¾èµ–åˆ†æé™ä½è¯¯æ“ä½œé£é™©
- **è¿ç»´æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–å·¥å…·æé«˜æ•°æ®åº“ç®¡ç†æ•ˆç‡

**ğŸ”¸ å›¢é˜Ÿåä½œä»·å€¼**
- **æ ‡å‡†åŒ–æµç¨‹**ï¼šå›¢é˜Ÿæˆå‘˜éµå¾ªç»Ÿä¸€çš„ç´¢å¼•ç®¡ç†è§„èŒƒ
- **çŸ¥è¯†ä¼ æ‰¿**ï¼šç´¢å¼•å˜æ›´å†å²å’ŒåŸå› éƒ½æœ‰è®°å½•
- **è´£ä»»æ˜ç¡®**ï¼šæ¯ä¸ªç´¢å¼•å˜æ›´éƒ½æœ‰æ˜ç¡®çš„è´Ÿè´£äºº
- **å¿«é€Ÿå®šä½**ï¼šå‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿæ‰¾åˆ°ç›¸å…³ä¿¡æ¯

### 9.5 å­¦ä¹ å’Œå®è·µå»ºè®®


> ğŸ“ **æ–°æ‰‹å®è·µè·¯å¾„**

```
å­¦ä¹ å»ºè®®ï¼š
ç¬¬ä¸€æ­¥ï¼šç†Ÿæ‚‰information_schemaå’Œsysåº“çš„åŸºæœ¬æŸ¥è¯¢
ç¬¬äºŒæ­¥ï¼šåœ¨æµ‹è¯•ç¯å¢ƒæ­å»ºç´¢å¼•ç›‘æ§ä½“ç³»
ç¬¬ä¸‰æ­¥ï¼šç¼–å†™ç®€å•çš„ç´¢å¼•ç®¡ç†è„šæœ¬
ç¬¬å››æ­¥ï¼šå»ºç«‹ç´¢å¼•å˜æ›´çš„è®°å½•ä¹ æƒ¯
ç¬¬äº”æ­¥ï¼šé€æ­¥å®Œå–„è‡ªåŠ¨åŒ–ç®¡ç†å·¥å…·
```

**ğŸ”¸ å®é™…æ“ä½œç»ƒä¹ **
```
åŠ¨æ‰‹ç»ƒä¹ æ¸…å•ï¼š
â–¡ æŸ¥è¯¢å½“å‰æ•°æ®åº“çš„æ‰€æœ‰ç´¢å¼•ä¿¡æ¯
â–¡ å¯¼å‡ºç´¢å¼•å®šä¹‰å¹¶åœ¨å¦ä¸€ä¸ªç¯å¢ƒé‡å»º  
â–¡ æ‰¾å‡ºæ•°æ®åº“ä¸­æœªä½¿ç”¨çš„ç´¢å¼•
â–¡ åˆ†ææŸä¸ªå¤æ‚æŸ¥è¯¢çš„ç´¢å¼•ä¾èµ–
â–¡ æ¨¡æ‹Ÿç´¢å¼•æŸåå¹¶è¿›è¡Œä¿®å¤
â–¡ å»ºç«‹ç®€å•çš„ç´¢å¼•å˜æ›´è®°å½•æµç¨‹
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
> ğŸ“ **å…ƒæ•°æ®ç®¡ç†ä¸‰è¦ç´ ï¼šå¤‡ä»½ã€ç›‘æ§ã€æ£€æŸ¥**  
> **ç‰ˆæœ¬æ§åˆ¶é˜²é£é™©ï¼Œä¾èµ–åˆ†æä¿å®‰å…¨**  
> **å·¥å…·è‡ªåŠ¨åŒ–ç®¡ç†ï¼Œä¸€è‡´æ€§æ£€æŸ¥ä¸ºå…ˆ**