---
title: 24ã€ç´¢å¼•çº¦æŸä¸æ•°æ®å®Œæ•´æ€§
---
## ğŸ“š ç›®å½•

1. [æ•°æ®åº“çº¦æŸä¸ç´¢å¼•åŸºç¡€](#1-æ•°æ®åº“çº¦æŸä¸ç´¢å¼•åŸºç¡€)
2. [å”¯ä¸€æ€§çº¦æŸç´¢å¼•](#2-å”¯ä¸€æ€§çº¦æŸç´¢å¼•)
3. [å¤–é”®çº¦æŸç´¢å¼•](#3-å¤–é”®çº¦æŸç´¢å¼•)
4. [æ£€æŸ¥çº¦æŸç´¢å¼•](#4-æ£€æŸ¥çº¦æŸç´¢å¼•)
5. [çº¦æŸéªŒè¯æœºåˆ¶](#5-çº¦æŸéªŒè¯æœºåˆ¶)
6. [çº¦æŸæ€§èƒ½å½±å“åˆ†æ](#6-çº¦æŸæ€§èƒ½å½±å“åˆ†æ)
7. [çº¦æŸç´¢å¼•è®¾è®¡ç­–ç•¥](#7-çº¦æŸç´¢å¼•è®¾è®¡ç­–ç•¥)
8. [çº¦æŸç´¢å¼•ä¼˜åŒ–ç­–ç•¥](#8-çº¦æŸç´¢å¼•ä¼˜åŒ–ç­–ç•¥)
9. [çº¦æŸéªŒè¯æ€§èƒ½ä¼˜åŒ–](#9-çº¦æŸéªŒè¯æ€§èƒ½ä¼˜åŒ–)
10. [çº¦æŸå†²çªå¤„ç†æœºåˆ¶](#10-çº¦æŸå†²çªå¤„ç†æœºåˆ¶)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ æ•°æ®åº“çº¦æŸä¸ç´¢å¼•åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯çº¦æŸä¸ç´¢å¼•çš„å…³ç³»


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
>
> æ•°æ®åº“çº¦æŸæ˜¯ä¿è¯æ•°æ®å®Œæ•´æ€§çš„è§„åˆ™ï¼Œè€Œç´¢å¼•æ˜¯çº¦æŸå®ç°çš„é‡è¦æŠ€æœ¯æ‰‹æ®µã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼šçº¦æŸæ˜¯"è§„åˆ™"ï¼Œç´¢å¼•æ˜¯"æ‰§è¡Œè§„åˆ™çš„å·¥å…·"ã€‚

**ğŸ“‹ çº¦æŸä¸ç´¢å¼•çš„åä½œå…³ç³»**
```
ç°å®ç±»æ¯”ï¼š
çº¦æŸ = äº¤é€šè§„åˆ™ï¼ˆä¸èƒ½é—¯çº¢ç¯ï¼‰
ç´¢å¼• = ç›‘æ§æ‘„åƒå¤´ï¼ˆå¿«é€Ÿå‘ç°è¿è§„ï¼‰

æ•°æ®åº“ä¸­ï¼š
çº¦æŸ = æ•°æ®è§„åˆ™ï¼ˆç”¨æˆ·åä¸èƒ½é‡å¤ï¼‰
ç´¢å¼• = æŸ¥é‡å·¥å…·ï¼ˆå¿«é€Ÿæ£€æŸ¥æ˜¯å¦é‡å¤ï¼‰
```

**ğŸ”— çº¦æŸç±»å‹ä¸å¯¹åº”ç´¢å¼•**

| çº¦æŸç±»å‹ | **ä½œç”¨** | **è‡ªåŠ¨åˆ›å»ºç´¢å¼•** | **ç´¢å¼•ç±»å‹** | **ä¸»è¦ç”¨é€”** |
|---------|---------|----------------|-------------|-------------|
| **PRIMARY KEY** | `ä¸»é”®çº¦æŸï¼Œå”¯ä¸€æ ‡è¯†` | `âœ… è‡ªåŠ¨åˆ›å»º` | `å”¯ä¸€ç´¢å¼•` | `å¿«é€Ÿå®šä½å•æ¡è®°å½•` |
| **UNIQUE** | `å”¯ä¸€æ€§çº¦æŸ` | `âœ… è‡ªåŠ¨åˆ›å»º` | `å”¯ä¸€ç´¢å¼•` | `é˜²é‡å¤æ£€æŸ¥` |
| **FOREIGN KEY** | `å¤–é”®çº¦æŸï¼Œå¼•ç”¨å®Œæ•´æ€§` | `âŒ éœ€æ‰‹åŠ¨åˆ›å»º` | `æ™®é€šç´¢å¼•` | `åŠ é€Ÿå…³è”æŸ¥è¯¢` |
| **CHECK** | `æ£€æŸ¥çº¦æŸï¼Œå€¼èŒƒå›´é™åˆ¶` | `âŒ ä¸åˆ›å»º` | `æ— ` | `æ•°æ®éªŒè¯` |
| **NOT NULL** | `éç©ºçº¦æŸ` | `âŒ ä¸åˆ›å»º` | `æ— ` | `ä¿è¯æ•°æ®å®Œæ•´` |

### 1.2 çº¦æŸçš„æ•°æ®å®Œæ•´æ€§ä½œç”¨


**ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§çš„å››ä¸ªå±‚æ¬¡**
```
1ï¸âƒ£ å®ä½“å®Œæ•´æ€§ï¼šæ¯ä¸ªå®ä½“éƒ½æœ‰å”¯ä¸€æ ‡è¯†
   â†’ PRIMARY KEYçº¦æŸä¿è¯

2ï¸âƒ£ åŸŸå®Œæ•´æ€§ï¼šå­—æ®µå€¼ç¬¦åˆå®šä¹‰åŸŸè¦æ±‚  
   â†’ CHECKçº¦æŸã€æ•°æ®ç±»å‹çº¦æŸä¿è¯

3ï¸âƒ£ å¼•ç”¨å®Œæ•´æ€§ï¼šå¤–é”®å¼•ç”¨å¿…é¡»å­˜åœ¨
   â†’ FOREIGN KEYçº¦æŸä¿è¯

4ï¸âƒ£ ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§ï¼šä¸šåŠ¡è§„åˆ™çº¦æŸ
   â†’ å¤åˆçº¦æŸã€è§¦å‘å™¨ä¿è¯
```

### 1.3 çº¦æŸä¸æ€§èƒ½çš„å¹³è¡¡


**âš–ï¸ çº¦æŸçš„åŒé¢æ•ˆåº”**
```
æ­£é¢æ•ˆåº”ï¼š
âœ… ä¿è¯æ•°æ®è´¨é‡ï¼Œé¿å…è„æ•°æ®
âœ… æä¾›æŸ¥è¯¢ä¼˜åŒ–å™¨æ›´å¤šä¿¡æ¯  
âœ… è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
âœ… å‡å°‘åº”ç”¨å±‚æ•°æ®éªŒè¯è´Ÿæ‹…

è´Ÿé¢æ•ˆåº”ï¼š
âŒ å¢åŠ INSERT/UPDATE/DELETEçš„å¼€é”€
âŒ çº¦æŸæ£€æŸ¥éœ€è¦é¢å¤–è®¡ç®—æ—¶é—´
âŒ å¤–é”®çº¦æŸå¯èƒ½å¯¼è‡´é”ç­‰å¾…
âŒ è¿‡å¤šçº¦æŸå½±å“æ‰¹é‡æ“ä½œæ€§èƒ½
```

---

## 2. ğŸ”‘ å”¯ä¸€æ€§çº¦æŸç´¢å¼•


### 2.1 å”¯ä¸€æ€§çº¦æŸçš„æœ¬è´¨


**ä»€ä¹ˆæ˜¯å”¯ä¸€æ€§çº¦æŸï¼Ÿ**

å”¯ä¸€æ€§çº¦æŸç¡®ä¿è¡¨ä¸­æŒ‡å®šåˆ—æˆ–åˆ—ç»„åˆçš„å€¼ä¸é‡å¤ã€‚æ•°æ®åº“é€šè¿‡åˆ›å»ºå”¯ä¸€ç´¢å¼•æ¥é«˜æ•ˆå®ç°è¿™ä¸ªçº¦æŸã€‚

> **ğŸ’¡ é€šä¿—ç†è§£**
>
> æƒ³è±¡å­¦ç”Ÿè¡¨ä¸­çš„å­¦å·ï¼Œæ¯ä¸ªå­¦ç”Ÿçš„å­¦å·éƒ½å¿…é¡»ä¸åŒã€‚å”¯ä¸€æ€§çº¦æŸå°±æ˜¯è¿™ä¸ª"ä¸èƒ½é‡å¤"çš„è§„åˆ™ï¼Œè€Œå”¯ä¸€ç´¢å¼•å°±æ˜¯å¿«é€Ÿæ£€æŸ¥"æ–°å­¦å·æ˜¯å¦å·²å­˜åœ¨"çš„æŸ¥æ‰¾å·¥å…·ã€‚

### 2.2 PRIMARY KEYçº¦æŸç´¢å¼•


**ğŸ”‘ ä¸»é”®çº¦æŸçš„ç‰¹ç‚¹**
```sql
-- åˆ›å»ºå¸¦ä¸»é”®çš„è¡¨
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,  -- è‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•
SELECT 
    indexname,
    indexdef
FROM pg_indexes 
WHERE tablename = 'users';

-- ç»“æœæ˜¾ç¤ºï¼š
-- users_pkey | CREATE UNIQUE INDEX users_pkey ON users USING btree (user_id)
```

**ğŸ” ä¸»é”®ç´¢å¼•çš„å†…éƒ¨æœºåˆ¶**
```
ä¸»é”®çº¦æŸ = UNIQUEçº¦æŸ + NOT NULLçº¦æŸ

å†…éƒ¨å®ç°æµç¨‹ï¼š
1. ç”¨æˆ·æ’å…¥æ•°æ®ï¼šINSERT INTO users (username) VALUES ('å¼ ä¸‰')
2. ç³»ç»Ÿæ£€æŸ¥ä¸»é”®å”¯ä¸€æ€§ï¼šé€šè¿‡users_pkeyç´¢å¼•å¿«é€ŸæŸ¥æ‰¾
3. å¦‚æœä¸»é”®å·²å­˜åœ¨ï¼šæŠ›å‡ºé‡å¤é”®é”™è¯¯
4. å¦‚æœä¸»é”®ä¸å­˜åœ¨ï¼šæ’å…¥æ•°æ®ï¼ŒåŒæ—¶æ›´æ–°ç´¢å¼•

ç´¢å¼•ç»“æ„ç¤ºæ„ï¼š
user_idç´¢å¼•æ ‘ï¼š
        5
       / \
      2   8
     / \ / \
    1  3 7  9
```

### 2.3 UNIQUEçº¦æŸç´¢å¼•


**ğŸ†” å•åˆ—å”¯ä¸€çº¦æŸ**
```sql
-- åˆ›å»ºå”¯ä¸€çº¦æŸ
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    
    -- å•åˆ—å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_users_username UNIQUE (username),
    CONSTRAINT uk_users_email UNIQUE (email)
);

-- ç­‰ä»·çš„ç´¢å¼•åˆ›å»ºè¯­å¥ï¼ˆç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œï¼‰
-- CREATE UNIQUE INDEX uk_users_username ON users (username);
-- CREATE UNIQUE INDEX uk_users_email ON users (email);
```

**ğŸ”— å¤šåˆ—ç»„åˆå”¯ä¸€çº¦æŸ**
```sql
-- è®¢å•æ˜ç»†è¡¨ï¼šåŒä¸€è®¢å•çš„åŒä¸€å•†å“åªèƒ½æœ‰ä¸€æ¡è®°å½•
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    
    -- å¤šåˆ—ç»„åˆå”¯ä¸€çº¦æŸ
    CONSTRAINT uk_order_product UNIQUE (order_id, product_id)
);

-- è¿™ä¼šåˆ›å»ºä¸€ä¸ªç»„åˆå”¯ä¸€ç´¢å¼•ï¼š
-- CREATE UNIQUE INDEX uk_order_product ON order_items (order_id, product_id);
```

**ğŸ“Š ç»„åˆç´¢å¼•çš„æŸ¥è¯¢ä¼˜åŒ–**
```sql
-- ç»„åˆå”¯ä¸€ç´¢å¼•çš„æŸ¥è¯¢ä¼˜åŒ–æ•ˆæœ

-- é«˜æ•ˆæŸ¥è¯¢1ï¼šå®Œæ•´ä½¿ç”¨ç´¢å¼•
SELECT * FROM order_items 
WHERE order_id = 1001 AND product_id = 2001;
-- æ‰§è¡Œè®¡åˆ’ï¼šIndex Scan using uk_order_product

-- é«˜æ•ˆæŸ¥è¯¢2ï¼šä½¿ç”¨ç´¢å¼•å‰ç¼€  
SELECT * FROM order_items WHERE order_id = 1001;
-- æ‰§è¡Œè®¡åˆ’ï¼šIndex Scan using uk_order_product

-- ä½æ•ˆæŸ¥è¯¢ï¼šä¸èƒ½ä½¿ç”¨ç´¢å¼•
SELECT * FROM order_items WHERE product_id = 2001;
-- æ‰§è¡Œè®¡åˆ’ï¼šSeq Scanï¼ˆéœ€è¦å…¨è¡¨æ‰«æï¼‰

-- ä¼˜åŒ–å»ºè®®ï¼šå¦‚æœç»å¸¸æŒ‰product_idæŸ¥è¯¢ï¼Œåˆ›å»ºé¢å¤–ç´¢å¼•
CREATE INDEX idx_order_items_product ON order_items (product_id);
```

### 2.4 å”¯ä¸€ç´¢å¼•çš„NULLå€¼å¤„ç†


**ğŸ” NULLå€¼çš„ç‰¹æ®Šæ€§**
```sql
-- NULLå€¼åœ¨å”¯ä¸€çº¦æŸä¸­çš„è¡¨ç°
CREATE TABLE test_unique_null (
    id SERIAL PRIMARY KEY,
    code VARCHAR(10) UNIQUE
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO test_unique_null (code) VALUES 
('A001'), ('A002'), (NULL), (NULL), (NULL);

-- æŸ¥è¯¢ç»“æœï¼š
SELECT * FROM test_unique_null;
/*
 id | code 
----+------
  1 | A001
  2 | A002  
  3 | 
  4 | 
  5 | 
*/

-- é‡è¦ç‰¹ç‚¹ï¼šå¤šä¸ªNULLå€¼å¯ä»¥å…±å­˜ï¼Œå› ä¸ºNULL â‰  NULL
```

**ğŸ”§ å¤„ç†NULLçš„ç­–ç•¥**
```sql
-- ç­–ç•¥1ï¼šä½¿ç”¨éƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼ˆæ’é™¤NULLï¼‰
CREATE UNIQUE INDEX uk_code_not_null 
ON test_unique_null (code) 
WHERE code IS NOT NULL;

-- ç­–ç•¥2ï¼šä½¿ç”¨å¤åˆå”¯ä¸€çº¦æŸåŒ…å«é¢å¤–åˆ—
CREATE TABLE test_unique_with_flag (
    id SERIAL PRIMARY KEY,
    code VARCHAR(10),
    is_active BOOLEAN DEFAULT TRUE,
    
    -- ç»„åˆçº¦æŸï¼šæ´»è·ƒè®°å½•çš„codeå¿…é¡»å”¯ä¸€
    CONSTRAINT uk_active_code UNIQUE (code, is_active)
);

-- ç­–ç•¥3ï¼šä½¿ç”¨COALESCEè½¬æ¢NULLä¸ºé»˜è®¤å€¼
CREATE UNIQUE INDEX uk_code_with_default
ON test_unique_null (COALESCE(code, 'DEFAULT'));
```

---

## 3. ğŸ”— å¤–é”®çº¦æŸç´¢å¼•


### 3.1 å¤–é”®çº¦æŸçš„å·¥ä½œæœºåˆ¶


**ä»€ä¹ˆæ˜¯å¤–é”®çº¦æŸï¼Ÿ**

å¤–é”®çº¦æŸç¡®ä¿ä¸€ä¸ªè¡¨ä¸­çš„å­—æ®µå€¼å¿…é¡»åœ¨å¦ä¸€ä¸ªè¡¨ä¸­å­˜åœ¨ï¼Œç»´æŠ¤è¡¨ä¹‹é—´çš„å¼•ç”¨å®Œæ•´æ€§ã€‚

> **ğŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**
>
> å¤–é”®çº¦æŸå°±åƒ"å­¦ç±ç®¡ç†"ï¼šå­¦ç”Ÿè¡¨ä¸­çš„ç­çº§IDå¿…é¡»åœ¨ç­çº§è¡¨ä¸­å­˜åœ¨ï¼Œä¸èƒ½è®©å­¦ç”Ÿå±äºä¸€ä¸ªä¸å­˜åœ¨çš„ç­çº§ã€‚æ•°æ®åº“éœ€è¦å¿«é€Ÿæ£€æŸ¥"è¿™ä¸ªç­çº§IDæ˜¯å¦çœŸå®å­˜åœ¨"ï¼Œè¿™å°±éœ€è¦åœ¨ç­çº§è¡¨ä¸Šå»ºç«‹ç´¢å¼•ã€‚

**ğŸ”— å¤–é”®çº¦æŸçš„æ£€æŸ¥è¿‡ç¨‹**
```sql
-- ç¤ºä¾‹ï¼šè®¢å•å’Œç”¨æˆ·çš„å…³ç³»
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    order_date DATE NOT NULL,
    total_amount DECIMAL(10,2),
    
    -- å¤–é”®çº¦æŸï¼šè®¢å•å¿…é¡»å±äºå­˜åœ¨çš„ç”¨æˆ·
    CONSTRAINT fk_orders_user FOREIGN KEY (user_id) 
    REFERENCES users(user_id) ON DELETE CASCADE
);
```

**ğŸ“Š å¤–é”®æ£€æŸ¥çš„å†…éƒ¨è¿‡ç¨‹**
```
å¤–é”®çº¦æŸæ£€æŸ¥æµç¨‹ï¼š

INSERTæ“ä½œï¼š
1. ç”¨æˆ·å°è¯•æ’å…¥ï¼šINSERT INTO orders (user_id, total_amount) VALUES (999, 100.00)
2. ç³»ç»Ÿæ£€æŸ¥ï¼šåœ¨usersè¡¨ä¸­æŸ¥æ‰¾user_id=999æ˜¯å¦å­˜åœ¨
3. æŸ¥æ‰¾è¿‡ç¨‹ï¼šä½¿ç”¨usersè¡¨çš„ä¸»é”®ç´¢å¼•å¿«é€Ÿå®šä½
4. å¦‚æœä¸å­˜åœ¨ï¼šæŠ›å‡ºå¤–é”®çº¦æŸé”™è¯¯
5. å¦‚æœå­˜åœ¨ï¼šå…è®¸æ’å…¥ï¼ŒåŒæ—¶åœ¨ordersè¡¨çš„å¤–é”®å­—æ®µä¸Šè®°å½•

UPDATEæ“ä½œï¼š
1. æ›´æ–°è®¢å•çš„user_idï¼šUPDATE orders SET user_id=888 WHERE order_id=1
2. ç³»ç»Ÿæ£€æŸ¥ï¼šæ–°çš„user_id=888åœ¨usersè¡¨ä¸­æ˜¯å¦å­˜åœ¨
3. çº¦æŸéªŒè¯ï¼šé€šè¿‡ç´¢å¼•å¿«é€ŸæŸ¥æ‰¾
4. éªŒè¯é€šè¿‡ï¼šæ‰§è¡Œæ›´æ–°æ“ä½œ

DELETEæ“ä½œï¼š
1. åˆ é™¤ç”¨æˆ·ï¼šDELETE FROM users WHERE user_id=123
2. ç³»ç»Ÿæ£€æŸ¥ï¼šordersè¡¨ä¸­æ˜¯å¦æœ‰user_id=123çš„è®°å½•
3. æ£€æŸ¥æ–¹å¼ï¼šåœ¨ordersè¡¨çš„user_idå­—æ®µä¸ŠæŸ¥æ‰¾ï¼ˆéœ€è¦ç´¢å¼•ï¼ï¼‰
4. æ ¹æ®å¤–é”®ç­–ç•¥æ‰§è¡Œï¼šCASCADEåˆ é™¤ç›¸å…³è®¢å•ï¼Œæˆ–RESTRICTé˜»æ­¢åˆ é™¤
```

### 3.2 å¤–é”®ç´¢å¼•çš„é‡è¦æ€§


**ğŸš¨ å¤–é”®å­—æ®µç¼ºå°‘ç´¢å¼•çš„é—®é¢˜**
```sql
-- æ¼”ç¤ºå¤–é”®å­—æ®µç¼ºå°‘ç´¢å¼•çš„æ€§èƒ½é—®é¢˜

-- åˆ›å»ºå¤§è¡¨æµ‹è¯•
CREATE TABLE users_large AS 
SELECT generate_series(1, 100000) as user_id,
       'user_' || generate_series(1, 100000) as username;

CREATE TABLE orders_large (
    order_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    order_date DATE DEFAULT CURRENT_DATE,
    amount DECIMAL(10,2) DEFAULT 100.00
);

-- æ’å…¥100ä¸‡è®¢å•æ•°æ®
INSERT INTO orders_large (user_id, amount)
SELECT 
    (random() * 99999 + 1)::int,
    (random() * 1000)::decimal(10,2)
FROM generate_series(1, 1000000);

-- æ·»åŠ å¤–é”®çº¦æŸï¼ˆæ­¤æ—¶orders_large.user_idæ²¡æœ‰ç´¢å¼•ï¼‰
ALTER TABLE orders_large 
ADD CONSTRAINT fk_orders_user 
FOREIGN KEY (user_id) REFERENCES users_large(user_id);

-- æµ‹è¯•åˆ é™¤ç”¨æˆ·çš„æ€§èƒ½ï¼ˆä¼šå¾ˆæ…¢ï¼ï¼‰
EXPLAIN ANALYZE DELETE FROM users_large WHERE user_id = 1;
-- ç»“æœï¼šéœ€è¦å…¨è¡¨æ‰«æorders_largeæ¥æ£€æŸ¥å¼•ç”¨
```

**ğŸ”§ æ·»åŠ å¤–é”®ç´¢å¼•çš„æ•ˆæœ**
```sql
-- ä¸ºå¤–é”®å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders_large (user_id);

-- å†æ¬¡æµ‹è¯•åˆ é™¤æ€§èƒ½
EXPLAIN ANALYZE DELETE FROM users_large WHERE user_id = 1;
-- ç»“æœï¼šä½¿ç”¨ç´¢å¼•å¿«é€Ÿå®šä½ç›¸å…³è®¢å•ï¼Œæ€§èƒ½å¤§å¹…æå‡

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- æ— ç´¢å¼•ï¼šæ‰§è¡Œæ—¶é—´å¯èƒ½å‡ åç§’åˆ°å‡ åˆ†é’Ÿ
-- æœ‰ç´¢å¼•ï¼šæ‰§è¡Œæ—¶é—´é€šå¸¸å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’
-- æ€§èƒ½æå‡ï¼š100-1000å€
```

### 3.3 å¤–é”®çº¦æŸçš„çº§è”æ“ä½œ


**ğŸ”„ CASCADEæ“ä½œçš„ç´¢å¼•éœ€æ±‚**
```sql
-- çº§è”åˆ é™¤çš„ç´¢å¼•ä¼˜åŒ–
CREATE TABLE departments (
    dept_id SERIAL PRIMARY KEY,
    dept_name VARCHAR(50) NOT NULL
);

CREATE TABLE employees (
    emp_id SERIAL PRIMARY KEY,
    emp_name VARCHAR(50) NOT NULL,
    dept_id INT NOT NULL,
    salary DECIMAL(10,2),
    
    -- çº§è”åˆ é™¤å¤–é”®
    CONSTRAINT fk_emp_dept FOREIGN KEY (dept_id) 
    REFERENCES departments(dept_id) ON DELETE CASCADE
);

-- å…³é”®ç´¢å¼•ï¼šå¤–é”®å­—æ®µç´¢å¼•ï¼ˆå¿…é¡»åˆ›å»ºï¼ï¼‰
CREATE INDEX idx_employees_dept_id ON employees (dept_id);

-- æµ‹è¯•çº§è”åˆ é™¤æ€§èƒ½
EXPLAIN ANALYZE DELETE FROM departments WHERE dept_id = 1;

-- æ‰§è¡Œè®¡åˆ’åˆ†æï¼š
-- 1. åˆ é™¤departmentsè¡¨è®°å½•ï¼šä½¿ç”¨ä¸»é”®ç´¢å¼•ï¼Œå¾ˆå¿«
-- 2. æŸ¥æ‰¾ç›¸å…³employeesè®°å½•ï¼šä½¿ç”¨idx_employees_dept_idç´¢å¼•ï¼Œå¾ˆå¿«
-- 3. åˆ é™¤ç›¸å…³employeesè®°å½•ï¼šæ‰¹é‡åˆ é™¤æ“ä½œ
-- æ€»ä½“æ€§èƒ½ï¼šæœ‰ç´¢å¼•æ—¶ç§’çº§å®Œæˆï¼Œæ— ç´¢å¼•æ—¶å¯èƒ½åˆ†é’Ÿçº§
```

---

## 4. âœ… æ£€æŸ¥çº¦æŸç´¢å¼•


### 4.1 æ£€æŸ¥çº¦æŸçš„ä½œç”¨æœºåˆ¶


**ä»€ä¹ˆæ˜¯æ£€æŸ¥çº¦æŸï¼Ÿ**

æ£€æŸ¥çº¦æŸå®šä¹‰å­—æ®µå€¼å¿…é¡»æ»¡è¶³çš„æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ¯”å¦‚å¹´é¾„å¿…é¡»å¤§äº0ï¼Œå·¥èµ„å¿…é¡»åœ¨åˆç†èŒƒå›´å†…ç­‰ã€‚

> **ğŸ’¡ é€šä¿—è§£é‡Š**
>
> æ£€æŸ¥çº¦æŸå°±åƒ"æ•°æ®éªŒè¯è§„åˆ™"ã€‚æ¯”å¦‚æ³¨å†Œè´¦å·æ—¶å¹´é¾„ä¸èƒ½æ˜¯è´Ÿæ•°ï¼Œå·¥èµ„ä¸èƒ½è¶…è¿‡å…¬å¸æœ€é«˜é™é¢ã€‚æ•°æ®åº“åœ¨æ¯æ¬¡æ’å…¥æˆ–æ›´æ–°æ•°æ®æ—¶éƒ½ä¼šæ£€æŸ¥è¿™äº›è§„åˆ™ã€‚

**ğŸ“‹ æ£€æŸ¥çº¦æŸçš„å…¸å‹åº”ç”¨**
```sql
-- å‘˜å·¥ä¿¡æ¯è¡¨çš„æ£€æŸ¥çº¦æŸ
CREATE TABLE employees (
    emp_id SERIAL PRIMARY KEY,
    emp_name VARCHAR(50) NOT NULL,
    age INT,
    salary DECIMAL(10,2),
    email VARCHAR(100),
    hire_date DATE,
    
    -- æ£€æŸ¥çº¦æŸå®šä¹‰
    CONSTRAINT ck_age_valid CHECK (age >= 18 AND age <= 65),
    CONSTRAINT ck_salary_positive CHECK (salary > 0),
    CONSTRAINT ck_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
    CONSTRAINT ck_hire_date_reasonable CHECK (hire_date >= '2000-01-01' AND hire_date <= CURRENT_DATE)
);
```

**ğŸ” æ£€æŸ¥çº¦æŸçš„éªŒè¯æ—¶æœº**
```
éªŒè¯æ—¶æœºï¼š
INSERTæ—¶ï¼šæ’å…¥æ–°è®°å½•å‰éªŒè¯æ‰€æœ‰æ£€æŸ¥çº¦æŸ
UPDATEæ—¶ï¼šæ›´æ–°è®°å½•æ—¶éªŒè¯è¢«ä¿®æ”¹å­—æ®µçš„æ£€æŸ¥çº¦æŸ
DISABLEæ—¶ï¼šå¯ä»¥æš‚æ—¶ç¦ç”¨çº¦æŸï¼ˆä»…é™ç»´æŠ¤æœŸé—´ï¼‰

éªŒè¯è¿‡ç¨‹ï¼š
ç”¨æˆ·æ“ä½œ â†’ çº¦æŸè¡¨è¾¾å¼è®¡ç®— â†’ è¿”å›TRUE/FALSE â†’ å…è®¸/æ‹’ç»æ“ä½œ
```

### 4.2 æ£€æŸ¥çº¦æŸçš„æ€§èƒ½è€ƒè™‘


**âš¡ æ£€æŸ¥çº¦æŸçš„æ€§èƒ½å½±å“**
```sql
-- æµ‹è¯•æ£€æŸ¥çº¦æŸçš„æ€§èƒ½å½±å“
CREATE TABLE test_performance (
    id SERIAL PRIMARY KEY,
    value1 INT,
    value2 VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ å¤æ‚çš„æ£€æŸ¥çº¦æŸ
ALTER TABLE test_performance 
ADD CONSTRAINT ck_complex_check CHECK (
    value1 > 0 AND 
    value1 < 1000000 AND
    LENGTH(value2) >= 3 AND
    LENGTH(value2) <= 50 AND
    value2 ~* '^[A-Za-z][A-Za-z0-9_]*$' AND  -- æ­£åˆ™è¡¨è¾¾å¼æ£€æŸ¥
    EXTRACT(YEAR FROM created_at) >= 2020
);

-- æ€§èƒ½æµ‹è¯•ï¼šæ‰¹é‡æ’å…¥
EXPLAIN ANALYZE INSERT INTO test_performance (value1, value2)
SELECT 
    (random() * 1000)::int,
    'test_' || generate_series(1, 10000)
FROM generate_series(1, 10000);

-- åˆ†æç»“æœï¼š
-- 1. ç®€å•æ•°å€¼æ£€æŸ¥ï¼šæ€§èƒ½å½±å“å¾ˆå°ï¼ˆå¾®ç§’çº§ï¼‰
-- 2. æ­£åˆ™è¡¨è¾¾å¼æ£€æŸ¥ï¼šæ€§èƒ½å½±å“è¾ƒå¤§ï¼ˆå¯èƒ½æ¯«ç§’çº§ï¼‰
-- 3. å¤åˆæ¡ä»¶æ£€æŸ¥ï¼šå½±å“ä¸æ¡ä»¶å¤æ‚åº¦æˆæ­£æ¯”
```

### 4.3 æ£€æŸ¥çº¦æŸçš„ç´¢å¼•ä¼˜åŒ–


**ğŸ”§ ä¸ºæ£€æŸ¥çº¦æŸç›¸å…³å­—æ®µåˆ›å»ºç´¢å¼•**
```sql
-- è™½ç„¶æ£€æŸ¥çº¦æŸæœ¬èº«ä¸åˆ›å»ºç´¢å¼•ï¼Œä½†ç›¸å…³æŸ¥è¯¢å¯èƒ½éœ€è¦
CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(100) NOT NULL,
    category_id INT NOT NULL,
    price DECIMAL(10,2),
    status VARCHAR(20),
    
    -- æ£€æŸ¥çº¦æŸ
    CONSTRAINT ck_price_positive CHECK (price > 0),
    CONSTRAINT ck_status_valid CHECK (status IN ('active', 'inactive', 'discontinued'))
);

-- ä¸ºç»å¸¸æŸ¥è¯¢çš„çº¦æŸå­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_products_status ON products (status);  -- çŠ¶æ€æŸ¥è¯¢å¾ˆé¢‘ç¹
CREATE INDEX idx_products_category ON products (category_id);  -- åˆ†ç±»æŸ¥è¯¢å¾ˆé¢‘ç¹
CREATE INDEX idx_products_price ON products (price);  -- ä»·æ ¼èŒƒå›´æŸ¥è¯¢å¾ˆé¢‘ç¹

-- ä¼˜åŒ–åçš„æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE SELECT * FROM products 
WHERE status = 'active' AND price BETWEEN 100 AND 500;
-- ä½¿ç”¨å¤åˆç´¢å¼•æ›´å¥½ï¼š
CREATE INDEX idx_products_status_price ON products (status, price);
```

---

## 5. ğŸ” çº¦æŸéªŒè¯æœºåˆ¶


### 5.1 çº¦æŸéªŒè¯çš„æ—¶æœº


**â° éªŒè¯æ—¶æœºåˆ†ç±»**
```
ç«‹å³éªŒè¯ï¼ˆIMMEDIATEï¼‰ï¼š
- æ¯æ¡è¯­å¥æ‰§è¡Œå®Œç«‹å³æ£€æŸ¥çº¦æŸ
- é»˜è®¤è¡Œä¸ºï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- é€‚ç”¨ï¼šå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯

å»¶è¿ŸéªŒè¯ï¼ˆDEFERREDï¼‰ï¼š
- äº‹åŠ¡æäº¤æ—¶æ‰æ£€æŸ¥çº¦æŸ  
- å…è®¸äº‹åŠ¡å†…éƒ¨ä¸´æ—¶è¿åçº¦æŸ
- é€‚ç”¨ï¼šå¤æ‚çš„æ•°æ®æ“ä½œåœºæ™¯
```

**ğŸ”§ å»¶è¿Ÿçº¦æŸçš„åº”ç”¨åœºæ™¯**
```sql
-- åˆ›å»ºå¯å»¶è¿Ÿçš„å¤–é”®çº¦æŸ
CREATE TABLE parent_table (
    id INT PRIMARY KEY,
    name VARCHAR(50)
);

CREATE TABLE child_table (
    id INT PRIMARY KEY,
    parent_id INT,
    name VARCHAR(50),
    
    -- å¯å»¶è¿Ÿçš„å¤–é”®çº¦æŸ
    CONSTRAINT fk_child_parent FOREIGN KEY (parent_id) 
    REFERENCES parent_table(id) 
    DEFERRABLE INITIALLY IMMEDIATE  -- å¯å»¶è¿Ÿï¼Œä½†é»˜è®¤ç«‹å³æ£€æŸ¥
);

-- ä½¿ç”¨å»¶è¿ŸéªŒè¯çš„åœºæ™¯ï¼šæ‰¹é‡æ•°æ®é‡ç»„
BEGIN;
    -- è®¾ç½®çº¦æŸä¸ºå»¶è¿ŸéªŒè¯
    SET CONSTRAINTS fk_child_parent DEFERRED;
    
    -- å¯ä»¥æš‚æ—¶è¿åå¤–é”®çº¦æŸçš„æ“ä½œ
    UPDATE parent_table SET id = id + 1000;  -- ä¿®æ”¹ä¸»é”®
    UPDATE child_table SET parent_id = parent_id + 1000;  -- ä¿®æ”¹å¤–é”®
    
    -- äº‹åŠ¡æäº¤æ—¶æ‰æ£€æŸ¥çº¦æŸ
COMMIT;  -- æ­¤æ—¶æ£€æŸ¥æ‰€æœ‰å»¶è¿Ÿçº¦æŸ
```

### 5.2 çº¦æŸéªŒè¯çš„å†…éƒ¨æœºåˆ¶


**ğŸ” çº¦æŸæ£€æŸ¥çš„æ‰§è¡Œæµç¨‹**
```
çº¦æŸéªŒè¯å†…éƒ¨æµç¨‹ï¼š

1ï¸âƒ£ è¯­å¥è§£æï¼š
   SQLè¯­å¥ â†’ è§£æå™¨ â†’ æ‰§è¡Œè®¡åˆ’

2ï¸âƒ£ çº¦æŸè¯†åˆ«ï¼š
   æ‰§è¡Œè®¡åˆ’ â†’ çº¦æŸæ£€æŸ¥å™¨ â†’ ç›¸å…³çº¦æŸåˆ—è¡¨

3ï¸âƒ£ éªŒè¯æ‰§è¡Œï¼š
   å¯¹äºæ¯ä¸ªçº¦æŸï¼š
   â”œâ”€ å”¯ä¸€çº¦æŸï¼šç´¢å¼•æŸ¥æ‰¾é‡å¤å€¼
   â”œâ”€ å¤–é”®çº¦æŸï¼šç´¢å¼•æŸ¥æ‰¾å¼•ç”¨å€¼  
   â”œâ”€ æ£€æŸ¥çº¦æŸï¼šè¡¨è¾¾å¼è®¡ç®—
   â””â”€ éç©ºçº¦æŸï¼šç®€å•NULLæ£€æŸ¥

4ï¸âƒ£ ç»“æœå¤„ç†ï¼š
   æ‰€æœ‰çº¦æŸé€šè¿‡ â†’ æ‰§è¡Œæ“ä½œ
   ä»»ä¸€çº¦æŸå¤±è´¥ â†’ å›æ»šæ“ä½œï¼ŒæŠ›å‡ºé”™è¯¯
```

**ğŸ“Š çº¦æŸéªŒè¯çš„æ€§èƒ½åˆ†æ**
```sql
-- åˆ›å»ºçº¦æŸéªŒè¯æ€§èƒ½åˆ†æå‡½æ•°
CREATE OR REPLACE FUNCTION analyze_constraint_performance(
    table_name TEXT
) RETURNS TABLE (
    constraint_name TEXT,
    constraint_type TEXT,
    validation_cost TEXT,
    optimization_suggestions TEXT
) AS $$
DECLARE
    constraint_record RECORD;
BEGIN
    FOR constraint_record IN 
        SELECT conname, contype, pg_get_constraintdef(oid) as definition
        FROM pg_constraint 
        WHERE conrelid = table_name::regclass
    LOOP
        constraint_name := constraint_record.conname;
        
        CASE constraint_record.contype
            WHEN 'p' THEN 
                constraint_type := 'ä¸»é”®çº¦æŸ';
                validation_cost := 'ä½ï¼ˆæœ‰è‡ªåŠ¨ç´¢å¼•ï¼‰';
                optimization_suggestions := 'æ— éœ€ä¼˜åŒ–ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ä¼˜åŒ–';
                
            WHEN 'u' THEN
                constraint_type := 'å”¯ä¸€çº¦æŸ';
                validation_cost := 'ä½ï¼ˆæœ‰è‡ªåŠ¨ç´¢å¼•ï¼‰';
                optimization_suggestions := 'è€ƒè™‘ç´¢å¼•åˆ—é¡ºåºï¼Œé¢‘ç¹æŸ¥è¯¢çš„åˆ—åœ¨å‰';
                
            WHEN 'f' THEN
                constraint_type := 'å¤–é”®çº¦æŸ';
                validation_cost := 'ä¸­ç­‰ï¼ˆéœ€æ£€æŸ¥å¼•ç”¨è¡¨ï¼‰';
                optimization_suggestions := 'ç¡®ä¿å¤–é”®å­—æ®µæœ‰ç´¢å¼•ï¼Œå¼•ç”¨å­—æ®µæœ‰ä¸»é”®/å”¯ä¸€ç´¢å¼•';
                
            WHEN 'c' THEN
                constraint_type := 'æ£€æŸ¥çº¦æŸ';
                validation_cost := 'å–å†³äºè¡¨è¾¾å¼å¤æ‚åº¦';
                optimization_suggestions := 'é¿å…å¤æ‚æ­£åˆ™è¡¨è¾¾å¼ï¼Œè€ƒè™‘å‡½æ•°ç´¢å¼•';
                
            ELSE
                constraint_type := 'å…¶ä»–çº¦æŸ';
                validation_cost := 'æœªçŸ¥';
                optimization_suggestions := 'éœ€è¦å…·ä½“åˆ†æ';
        END CASE;
        
        RETURN NEXT;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM analyze_constraint_performance('orders');
```

### 5.3 çº¦æŸéªŒè¯çš„ä¼˜åŒ–ç­–ç•¥


**ğŸš€ éªŒè¯æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```sql
-- ä¼˜åŒ–æŠ€å·§1ï¼šçº¦æŸè¡¨è¾¾å¼ä¼˜åŒ–
-- ä½æ•ˆçš„æ£€æŸ¥çº¦æŸ
ALTER TABLE products ADD CONSTRAINT ck_price_range_slow
CHECK (price BETWEEN (SELECT MIN(base_price) FROM price_config) 
              AND (SELECT MAX(max_price) FROM price_config));

-- é«˜æ•ˆçš„æ£€æŸ¥çº¦æŸï¼ˆé¿å…å­æŸ¥è¯¢ï¼‰
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨å›ºå®šå€¼
ALTER TABLE products ADD CONSTRAINT ck_price_range_fast
CHECK (price BETWEEN 0.01 AND 99999.99);

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨å‡½æ•°ç´¢å¼•
CREATE OR REPLACE FUNCTION is_valid_price(price DECIMAL) 
RETURNS BOOLEAN AS $$
    SELECT price > 0 AND price <= 99999.99;
$$ LANGUAGE SQL IMMUTABLE;

-- åˆ›å»ºåŸºäºå‡½æ•°çš„ç´¢å¼•
CREATE INDEX idx_products_valid_price 
ON products (is_valid_price(price)) 
WHERE NOT is_valid_price(price);  -- åªç´¢å¼•æ— æ•ˆæ•°æ®
```

**ğŸ”§ æ‰¹é‡æ“ä½œçš„çº¦æŸä¼˜åŒ–**
```sql
-- æ‰¹é‡æ’å…¥æ—¶çš„çº¦æŸä¼˜åŒ–ç­–ç•¥

-- æ–¹æ¡ˆ1ï¼šä¸´æ—¶ç¦ç”¨çº¦æŸï¼ˆè°¨æ…ä½¿ç”¨ï¼ï¼‰
ALTER TABLE orders DISABLE TRIGGER ALL;  -- ç¦ç”¨æ‰€æœ‰è§¦å‘å™¨å’Œçº¦æŸ
-- æ‰§è¡Œæ‰¹é‡æ’å…¥...
COPY orders FROM '/path/to/data.csv' WITH CSV HEADER;
-- é‡æ–°å¯ç”¨å¹¶éªŒè¯
ALTER TABLE orders ENABLE TRIGGER ALL;

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨äº‹åŠ¡å’Œå»¶è¿Ÿçº¦æŸ
BEGIN;
    SET CONSTRAINTS ALL DEFERRED;  -- è®¾ç½®æ‰€æœ‰çº¦æŸå»¶è¿ŸéªŒè¯
    
    -- æ‰¹é‡æ•°æ®æ“ä½œ
    INSERT INTO orders SELECT * FROM staging_orders;
    
    -- æäº¤æ—¶éªŒè¯æ‰€æœ‰çº¦æŸ
COMMIT;

-- æ–¹æ¡ˆ3ï¼šåˆ†æ‰¹å¤„ç†
DO $$
DECLARE
    batch_size INT := 10000;
    offset_val INT := 0;
    row_count INT;
BEGIN
    LOOP
        INSERT INTO orders 
        SELECT * FROM staging_orders 
        LIMIT batch_size OFFSET offset_val;
        
        GET DIAGNOSTICS row_count = ROW_COUNT;
        EXIT WHEN row_count = 0;
        
        offset_val := offset_val + batch_size;
        
        -- æ¯æ‰¹æ¬¡åæäº¤ï¼Œé¿å…é•¿äº‹åŠ¡
        COMMIT;
        -- å¯é€‰ï¼šè®°å½•è¿›åº¦
        RAISE NOTICE 'å·²å¤„ç† % è¡Œæ•°æ®', offset_val;
    END LOOP;
END $$;
```

---

## 6. ğŸ“ˆ çº¦æŸæ€§èƒ½å½±å“åˆ†æ


### 6.1 ä¸åŒçº¦æŸç±»å‹çš„æ€§èƒ½å¼€é”€


**ğŸ“Š çº¦æŸæ€§èƒ½å¼€é”€å¯¹æ¯”è¡¨**

| çº¦æŸç±»å‹ | **INSERTå¼€é”€** | **UPDATEå¼€é”€** | **DELETEå¼€é”€** | **æŸ¥è¯¢å½±å“** | **ç´¢å¼•ä¾èµ–** |
|---------|----------------|----------------|----------------|-------------|-------------|
| **PRIMARY KEY** | `ä½` | `ä½-ä¸­` | `ä½` | `âœ… æ­£é¢` | `è‡ªåŠ¨åˆ›å»º` |
| **UNIQUE** | `ä½-ä¸­` | `ä¸­` | `ä½` | `âœ… æ­£é¢` | `è‡ªåŠ¨åˆ›å»º` |
| **FOREIGN KEY** | `ä¸­-é«˜` | `ä¸­-é«˜` | `é«˜` | `â– æ— ç›´æ¥å½±å“` | `éœ€æ‰‹åŠ¨åˆ›å»º` |
| **CHECK** | `ä½-é«˜` | `ä½-é«˜` | `æ— ` | `â– æ— ç›´æ¥å½±å“` | `ä¸åˆ›å»º` |
| **NOT NULL** | `æä½` | `æä½` | `æ— ` | `âœ… è½»å¾®æ­£é¢` | `ä¸åˆ›å»º` |

### 6.2 çº¦æŸæ€§èƒ½æµ‹è¯•æ¡†æ¶


**ğŸ§ª çº¦æŸæ€§èƒ½åŸºå‡†æµ‹è¯•**
```sql
-- åˆ›å»ºçº¦æŸæ€§èƒ½æµ‹è¯•å¥—ä»¶
CREATE OR REPLACE FUNCTION benchmark_constraint_performance(
    table_rows INT DEFAULT 100000
) RETURNS TABLE (
    test_scenario TEXT,
    operation_type TEXT,
    rows_affected INT,
    execution_time_ms NUMERIC,
    constraints_checked INT
) AS $$
DECLARE
    start_time TIMESTAMP;
    end_time TIMESTAMP;
BEGIN
    -- å‡†å¤‡æµ‹è¯•æ•°æ®
    DROP TABLE IF EXISTS constraint_test_table;
    
    -- æµ‹è¯•1ï¼šæ— çº¦æŸè¡¨
    CREATE TABLE constraint_test_table (
        id SERIAL,
        username VARCHAR(50),
        email VARCHAR(100),
        user_id INT,
        age INT,
        salary DECIMAL(10,2)
    );
    
    start_time := clock_timestamp();
    
    INSERT INTO constraint_test_table (username, email, user_id, age, salary)
    SELECT 
        'user_' || i,
        'user' || i || '@example.com',
        i,
        18 + (random() * 47)::int,
        30000 + (random() * 70000)::decimal(10,2)
    FROM generate_series(1, table_rows) i;
    
    end_time := clock_timestamp();
    
    test_scenario := 'æ— çº¦æŸè¡¨';
    operation_type := 'INSERT';
    rows_affected := table_rows;
    execution_time_ms := EXTRACT(EPOCH FROM (end_time - start_time)) * 1000;
    constraints_checked := 0;
    RETURN NEXT;
    
    -- æ¸…ç†æ•°æ®ï¼Œå‡†å¤‡ä¸‹ä¸€è½®æµ‹è¯•
    DELETE FROM constraint_test_table;
    
    -- æµ‹è¯•2ï¼šæ·»åŠ çº¦æŸåçš„æ€§èƒ½
    ALTER TABLE constraint_test_table 
    ADD CONSTRAINT pk_test PRIMARY KEY (id),
    ADD CONSTRAINT uk_test_username UNIQUE (username),
    ADD CONSTRAINT uk_test_email UNIQUE (email),
    ADD CONSTRAINT ck_test_age CHECK (age BETWEEN 18 AND 65),
    ADD CONSTRAINT ck_test_salary CHECK (salary > 0);
    
    start_time := clock_timestamp();
    
    INSERT INTO constraint_test_table (username, email, user_id, age, salary)
    SELECT 
        'user_' || i,
        'user' || i || '@example.com',
        i,
        18 + (random() * 47)::int,
        30000 + (random() * 70000)::decimal(10,2)
    FROM generate_series(1, table_rows) i;
    
    end_time := clock_timestamp();
    
    test_scenario := 'å®Œæ•´çº¦æŸè¡¨';
    operation_type := 'INSERT';
    rows_affected := table_rows;
    execution_time_ms := EXTRACT(EPOCH FROM (end_time - start_time)) * 1000;
    constraints_checked := 5;  -- 5ä¸ªçº¦æŸ
    RETURN NEXT;
    
    -- ç»§ç»­å…¶ä»–æµ‹è¯•...
END;
$$ LANGUAGE plpgsql;
```

### 6.3 çº¦æŸæ€§èƒ½ç›‘æ§


**ğŸ“Š å®æ—¶çº¦æŸæ€§èƒ½ç›‘æ§**
```sql
-- åˆ›å»ºçº¦æŸæ€§èƒ½ç›‘æ§è§†å›¾
CREATE VIEW constraint_performance_monitor AS
WITH constraint_stats AS (
    SELECT 
        schemaname,
        tablename,
        attname as column_name,
        n_distinct,
        most_common_vals,
        most_common_freqs,
        correlation
    FROM pg_stats
    WHERE schemaname = 'public'  -- ä¿®æ”¹ä¸ºå®é™…schema
),
constraint_info AS (
    SELECT 
        t.table_name,
        c.constraint_name,
        c.constraint_type,
        c.is_deferrable,
        c.initially_deferred,
        kcu.column_name
    FROM information_schema.tables t
    JOIN information_schema.table_constraints c ON t.table_name = c.table_name
    JOIN information_schema.key_column_usage kcu ON c.constraint_name = kcu.constraint_name
    WHERE t.table_schema = 'public'
)
SELECT 
    ci.table_name,
    ci.constraint_name,
    ci.constraint_type,
    ci.column_name,
    cs.n_distinct as distinct_values,
    cs.correlation,
    CASE 
        WHEN ci.constraint_type = 'PRIMARY KEY' THEN 'âœ… é«˜æ•ˆ'
        WHEN ci.constraint_type = 'UNIQUE' AND cs.n_distinct > 1000 THEN 'âœ… é«˜æ•ˆ'
        WHEN ci.constraint_type = 'UNIQUE' AND cs.n_distinct <= 100 THEN 'âš ï¸ ä½é€‰æ‹©æ€§'
        WHEN ci.constraint_type = 'FOREIGN KEY' THEN 'ğŸ” éœ€æ£€æŸ¥å¼•ç”¨è¡¨ç´¢å¼•'
        ELSE 'ğŸ“Š éœ€åˆ†æ'
    END as performance_status
FROM constraint_info ci
LEFT JOIN constraint_stats cs ON ci.table_name = cs.tablename AND ci.column_name = cs.column_name
ORDER BY ci.table_name, ci.constraint_name;

-- ä½¿ç”¨ç›‘æ§è§†å›¾
SELECT * FROM constraint_performance_monitor 
WHERE performance_status LIKE '%éœ€%' OR performance_status LIKE '%âš ï¸%';
```

---

## 7. ğŸ—ï¸ çº¦æŸç´¢å¼•è®¾è®¡ç­–ç•¥


### 7.1 çº¦æŸç´¢å¼•è®¾è®¡åŸåˆ™


**ğŸ“ è®¾è®¡åŸåˆ™ä½“ç³»**
```
åŸåˆ™1ï¼šçº¦æŸå¿…è¦æ€§åŸåˆ™
âœ… æ¯ä¸ªçº¦æŸéƒ½åº”è¯¥æœ‰æ˜ç¡®çš„ä¸šåŠ¡æ„ä¹‰
âœ… é¿å…è¿‡åº¦çº¦æŸå¯¼è‡´çš„æ€§èƒ½é—®é¢˜
âŒ ä¸è¦ä¸ºäº†"ä¿é™©"è€Œæ·»åŠ ä¸å¿…è¦çš„çº¦æŸ

åŸåˆ™2ï¼šç´¢å¼•é…å¥—åŸåˆ™  
âœ… å¤–é”®å­—æ®µå¿…é¡»æœ‰ç´¢å¼•
âœ… é¢‘ç¹æŸ¥è¯¢çš„çº¦æŸå­—æ®µåº”è¯¥æœ‰ç´¢å¼•
âœ… å¤åˆçº¦æŸè€ƒè™‘å¤åˆç´¢å¼•

åŸåˆ™3ï¼šæ€§èƒ½å¹³è¡¡åŸåˆ™
âœ… å¹³è¡¡æ•°æ®å®Œæ•´æ€§å’Œæ“ä½œæ€§èƒ½
âœ… è¯»å¤šå†™å°‘ï¼šå¯ä»¥æ·»åŠ æ›´å¤šçº¦æŸ
âœ… å†™å¤šè¯»å°‘ï¼šçº¦æŸè¦è°¨æ…è®¾è®¡
```

### 7.2 å¤åˆçº¦æŸçš„ç´¢å¼•è®¾è®¡


**ğŸ”— å¤åˆçº¦æŸç´¢å¼•ç­–ç•¥**
```sql
-- åœºæ™¯ï¼šç”µå•†è®¢å•ç³»ç»Ÿçš„çº¦æŸè®¾è®¡
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    sku_code VARCHAR(50) NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸šåŠ¡çº¦æŸï¼šåŒä¸€è®¢å•ä¸­åŒä¸€å•†å“åªèƒ½æœ‰ä¸€æ¡è®°å½•
    CONSTRAINT uk_order_product UNIQUE (order_id, product_id),
    
    -- ä¸šåŠ¡çº¦æŸï¼šSKUä»£ç å…¨å±€å”¯ä¸€
    CONSTRAINT uk_global_sku UNIQUE (sku_code),
    
    -- æ£€æŸ¥çº¦æŸï¼šæ•°é‡å’Œä»·æ ¼å¿…é¡»ä¸ºæ­£
    CONSTRAINT ck_quantity_positive CHECK (quantity > 0),
    CONSTRAINT ck_price_positive CHECK (unit_price > 0)
);

-- ç´¢å¼•è®¾è®¡ç­–ç•¥ï¼š

-- 1. ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- CREATE UNIQUE INDEX order_items_pkey ON order_items (item_id);

-- 2. å¤åˆå”¯ä¸€ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰  
-- CREATE UNIQUE INDEX uk_order_product ON order_items (order_id, product_id);

-- 3. SKUå”¯ä¸€ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- CREATE UNIQUE INDEX uk_global_sku ON order_items (sku_code);

-- 4. æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰
-- æŒ‰è®¢å•æŸ¥è¯¢è®¢å•æ˜ç»†ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX idx_order_items_order_id ON order_items (order_id);

-- æŒ‰å•†å“æŸ¥è¯¢ç›¸å…³è®¢å•ï¼ˆä¸­é¢‘æŸ¥è¯¢ï¼‰  
CREATE INDEX idx_order_items_product_id ON order_items (product_id);

-- æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆæŠ¥è¡¨æŸ¥è¯¢ï¼‰
CREATE INDEX idx_order_items_created_at ON order_items (created_at);

-- 5. å¤åˆæŸ¥è¯¢ç´¢å¼•
-- æŒ‰è®¢å•å’Œæ—¶é—´æŸ¥è¯¢ï¼ˆè®¢å•è¯¦æƒ…é¡µï¼‰
CREATE INDEX idx_order_items_order_date ON order_items (order_id, created_at);
```

### 7.3 çº¦æŸç´¢å¼•çš„ç»´æŠ¤ç­–ç•¥


**ğŸ”§ ç´¢å¼•ç»´æŠ¤æœ€ä½³å®è·µ**
```sql
-- çº¦æŸç´¢å¼•ç»´æŠ¤è®¡åˆ’

-- 1. å®šæœŸæ£€æŸ¥çº¦æŸç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch,
    idx_scan,
    CASE 
        WHEN idx_scan = 0 THEN 'ğŸ”´ æœªä½¿ç”¨'
        WHEN idx_scan < 100 THEN 'ğŸŸ¡ ä½ä½¿ç”¨ç‡'
        WHEN idx_scan < 1000 THEN 'ğŸŸ¢ ä¸­ç­‰ä½¿ç”¨'
        ELSE 'âœ… é«˜ä½¿ç”¨ç‡'
    END as usage_status
FROM pg_stat_user_indexes 
WHERE indexrelname LIKE '%uk_%' OR indexrelname LIKE '%fk_%'
ORDER BY idx_scan DESC;

-- 2. å®šæœŸæ£€æŸ¥çº¦æŸç´¢å¼•å¤§å°
SELECT 
    schemaname,
    tablename, 
    indexname,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size,
    pg_size_pretty(pg_relation_size(indrelid)) as table_size,
    ROUND(
        100.0 * pg_relation_size(indexrelid) / pg_relation_size(indrelid), 
        2
    ) as size_ratio_percent
FROM pg_stat_user_indexes
WHERE indexrelname LIKE '%uk_%' OR indexrelname LIKE '%fk_%' OR indexrelname LIKE '%pk_%'
ORDER BY pg_relation_size(indexrelid) DESC;

-- 3. çº¦æŸè¿åç»Ÿè®¡åˆ†æ
CREATE VIEW constraint_violation_stats AS
SELECT 
    table_name,
    constraint_name,
    -- ä»æ—¥å¿—ä¸­ç»Ÿè®¡çº¦æŸè¿åæ¬¡æ•°ï¼ˆéœ€è¦é…ç½®æ—¥å¿—ï¼‰
    COUNT(*) as violation_count,
    MAX(created_at) as last_violation
FROM constraint_violation_log  -- éœ€è¦å»ºç«‹è¿åæ—¥å¿—è¡¨
GROUP BY table_name, constraint_name
ORDER BY violation_count DESC;
```

---

## 8. ğŸš€ çº¦æŸç´¢å¼•ä¼˜åŒ–ç­–ç•¥


### 8.1 å”¯ä¸€çº¦æŸç´¢å¼•ä¼˜åŒ–


**ğŸ”§ å”¯ä¸€ç´¢å¼•çš„é«˜çº§ä¼˜åŒ–**
```sql
-- ç­–ç•¥1ï¼šéƒ¨åˆ†å”¯ä¸€ç´¢å¼•ï¼ˆæ¡ä»¶å”¯ä¸€æ€§ï¼‰
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¸šåŠ¡éœ€æ±‚ï¼šåªæœ‰æ´»è·ƒç”¨æˆ·çš„ç”¨æˆ·åéœ€è¦å”¯ä¸€
-- ä¼ ç»Ÿåšæ³•ï¼šå…¨è¡¨å”¯ä¸€çº¦æŸï¼ˆåŒ…æ‹¬åˆ é™¤çš„ç”¨æˆ·ï¼‰
-- ALTER TABLE users ADD CONSTRAINT uk_username UNIQUE (username);

-- ä¼˜åŒ–åšæ³•ï¼šéƒ¨åˆ†å”¯ä¸€ç´¢å¼•  
CREATE UNIQUE INDEX uk_active_username 
ON users (username) 
WHERE status = 'active';

-- ä¼˜åŠ¿ï¼š
-- 1. åˆ é™¤ç”¨æˆ·åç”¨æˆ·åå¯ä»¥é‡ç”¨
-- 2. ç´¢å¼•æ›´å°ï¼Œæ€§èƒ½æ›´å¥½
-- 3. åªå¯¹æ´»è·ƒç”¨æˆ·æ£€æŸ¥å”¯ä¸€æ€§
```

**ğŸ” å”¯ä¸€ç´¢å¼•ä¸NULLå€¼ä¼˜åŒ–**
```sql
-- åœºæ™¯ï¼šç”¨æˆ·å¯é€‰çš„å”¯ä¸€å­—æ®µ
CREATE TABLE user_profiles (
    profile_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    phone_number VARCHAR(20),  -- å¯é€‰ï¼Œä½†å¦‚æœå¡«å†™å¿…é¡»å”¯ä¸€
    id_card_number VARCHAR(20), -- å¯é€‰ï¼Œä½†å¦‚æœå¡«å†™å¿…é¡»å”¯ä¸€
    
    -- æ–¹æ¡ˆ1ï¼šä¼ ç»Ÿå”¯ä¸€çº¦æŸï¼ˆå…è®¸å¤šä¸ªNULLï¼‰
    CONSTRAINT uk_phone UNIQUE (phone_number),
    CONSTRAINT uk_id_card UNIQUE (id_card_number)
);

-- æ–¹æ¡ˆ2ï¼šæ›´ä¸¥æ ¼çš„å”¯ä¸€æ€§ï¼ˆä¸å…è®¸NULLï¼‰
ALTER TABLE user_profiles 
DROP CONSTRAINT IF EXISTS uk_phone,
ADD CONSTRAINT uk_phone_not_null UNIQUE (phone_number)
INITIALLY DEFERRED;

-- æ·»åŠ éç©ºæ£€æŸ¥
ALTER TABLE user_profiles 
ADD CONSTRAINT ck_phone_format 
CHECK (phone_number IS NOT NULL AND phone_number ~ '^\d{11}$');

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨å‡½æ•°ç´¢å¼•å¤„ç†å¤æ‚å”¯ä¸€æ€§
-- éœ€æ±‚ï¼šé‚®ç®±ä¸åŒºåˆ†å¤§å°å†™çš„å”¯ä¸€æ€§
CREATE UNIQUE INDEX uk_email_case_insensitive 
ON users (LOWER(email)) 
WHERE email IS NOT NULL;
```

### 8.2 å¤–é”®çº¦æŸç´¢å¼•ä¼˜åŒ–


**ğŸ”— å¤–é”®ç´¢å¼•çš„æ™ºèƒ½è®¾è®¡**
```sql
-- å¤–é”®ç´¢å¼•ä¼˜åŒ–æ¡ˆä¾‹ï¼šè®¢å•ç³»ç»Ÿ
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    customer_name VARCHAR(100) NOT NULL,
    customer_type VARCHAR(20) DEFAULT 'regular',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INT NOT NULL,
    order_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    total_amount DECIMAL(12,2),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_orders_customer FOREIGN KEY (customer_id) 
    REFERENCES customers(customer_id) ON DELETE RESTRICT
);

-- å¤–é”®ç´¢å¼•ä¼˜åŒ–ç­–ç•¥ï¼š

-- åŸºç¡€ç´¢å¼•ï¼šå¤–é”®å­—æ®µç´¢å¼•
CREATE INDEX idx_orders_customer_id ON orders (customer_id);

-- ä¼˜åŒ–ç´¢å¼•1ï¼šç»“åˆæŸ¥è¯¢æ¨¡å¼çš„å¤åˆç´¢å¼•
-- ç»å¸¸æŒ‰å®¢æˆ·å’ŒçŠ¶æ€æŸ¥è¯¢è®¢å•
CREATE INDEX idx_orders_customer_status ON orders (customer_id, status);

-- ä¼˜åŒ–ç´¢å¼•2ï¼šç»“åˆæ—¶é—´èŒƒå›´çš„ç´¢å¼•
-- ç»å¸¸æŸ¥è¯¢ç‰¹å®šå®¢æˆ·çš„æœ€è¿‘è®¢å•
CREATE INDEX idx_orders_customer_date ON orders (customer_id, order_date DESC);

-- ä¼˜åŒ–ç´¢å¼•3ï¼šè¦†ç›–ç´¢å¼•
-- è®¢å•åˆ—è¡¨é¡µé¢éœ€è¦ï¼šå®¢æˆ·IDã€è®¢å•æ—¥æœŸã€çŠ¶æ€ã€æ€»é‡‘é¢
CREATE INDEX idx_orders_customer_cover 
ON orders (customer_id) 
INCLUDE (order_date, status, total_amount);
```

**ğŸ“Š å¤–é”®çº¦æŸçš„çº§è”æ“ä½œä¼˜åŒ–**
```sql
-- çº§è”æ“ä½œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥
CREATE TABLE order_items (
    item_id SERIAL PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL,
    
    -- çº§è”åˆ é™¤å¤–é”®
    CONSTRAINT fk_items_order FOREIGN KEY (order_id) 
    REFERENCES orders(order_id) ON DELETE CASCADE
);

-- å…³é”®ä¼˜åŒ–ï¼šå¤–é”®å­—æ®µå¿…é¡»æœ‰é«˜æ•ˆç´¢å¼•
CREATE INDEX idx_order_items_order_id ON order_items (order_id);

-- æ‰¹é‡çº§è”åˆ é™¤ä¼˜åŒ–
-- åœºæ™¯ï¼šåˆ é™¤è¿‡æœŸè®¢å•åŠç›¸å…³æ˜ç»†
EXPLAIN ANALYZE 
DELETE FROM orders 
WHERE order_date < CURRENT_DATE - INTERVAL '1 year';

-- ä¼˜åŒ–ç­–ç•¥ï¼š
-- 1. ç¡®ä¿dateå­—æ®µæœ‰ç´¢å¼•
CREATE INDEX idx_orders_date ON orders (order_date);

-- 2. åˆ†æ‰¹åˆ é™¤é¿å…é•¿äº‹åŠ¡
DO $$
DECLARE
    deleted_count INT;
BEGIN
    LOOP
        DELETE FROM orders 
        WHERE order_id IN (
            SELECT order_id FROM orders 
            WHERE order_date < CURRENT_DATE - INTERVAL '1 year'
            LIMIT 1000
        );
        
        GET DIAGNOSTICS deleted_count = ROW_COUNT;
        EXIT WHEN deleted_count = 0;
        
        -- æäº¤å½“å‰æ‰¹æ¬¡
        COMMIT;
        -- çŸ­æš‚æš‚åœï¼Œé‡Šæ”¾é”
        PERFORM pg_sleep(0.1);
    END LOOP;
END $$;
```

### 8.3 å¤åˆçº¦æŸçš„ä¼˜åŒ–è®¾è®¡


**ğŸ¯ å¤åˆä¸šåŠ¡çº¦æŸä¼˜åŒ–**
```sql
-- å¤æ‚ä¸šåŠ¡åœºæ™¯ï¼šæ´»åŠ¨æŠ¥åç³»ç»Ÿ
CREATE TABLE event_registrations (
    registration_id SERIAL PRIMARY KEY,
    event_id INT NOT NULL,
    user_id INT NOT NULL,
    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'confirmed',
    
    -- ä¸šåŠ¡çº¦æŸ1ï¼šç”¨æˆ·åœ¨åŒä¸€æ´»åŠ¨åªèƒ½æŠ¥åä¸€æ¬¡
    CONSTRAINT uk_user_event UNIQUE (user_id, event_id),
    
    -- ä¸šåŠ¡çº¦æŸ2ï¼šåªæœ‰ç¡®è®¤çŠ¶æ€çš„æŠ¥åæ‰æ£€æŸ¥å”¯ä¸€æ€§
    -- ä½¿ç”¨éƒ¨åˆ†ç´¢å¼•å®ç°
);

-- å¤åˆçº¦æŸçš„ç´¢å¼•è®¾è®¡ï¼š

-- åŸºç¡€å”¯ä¸€ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
-- CREATE UNIQUE INDEX uk_user_event ON event_registrations (user_id, event_id);

-- æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•ï¼š
-- æŒ‰æ´»åŠ¨æŸ¥çœ‹æŠ¥ååˆ—è¡¨
CREATE INDEX idx_registrations_event ON event_registrations (event_id, registration_time DESC);

-- æŒ‰ç”¨æˆ·æŸ¥çœ‹æŠ¥åå†å²
CREATE INDEX idx_registrations_user ON event_registrations (user_id, registration_time DESC);

-- æŒ‰çŠ¶æ€ç®¡ç†æŠ¥å
CREATE INDEX idx_registrations_status ON event_registrations (status, registration_time);

-- é«˜çº§çº¦æŸï¼šæ¡ä»¶å”¯ä¸€æ€§
-- éœ€æ±‚ï¼šç”¨æˆ·å¯ä»¥é‡å¤æŠ¥åï¼Œä½†æ¯ä¸ªæ´»åŠ¨æœ€å¤š1ä¸ªç¡®è®¤çŠ¶æ€çš„æŠ¥å
DROP CONSTRAINT uk_user_event;

-- åˆ›å»ºæ¡ä»¶å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_user_event_confirmed 
ON event_registrations (user_id, event_id) 
WHERE status = 'confirmed';

-- è¿™æ ·ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªå–æ¶ˆçš„æŠ¥åï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªç¡®è®¤çš„æŠ¥å
```

---

## 9. âš¡ çº¦æŸéªŒè¯æ€§èƒ½ä¼˜åŒ–


### 9.1 çº¦æŸéªŒè¯çš„æ€§èƒ½ç“¶é¢ˆ


**ğŸ” è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ**
```sql
-- çº¦æŸéªŒè¯æ€§èƒ½åˆ†æå·¥å…·
CREATE OR REPLACE FUNCTION analyze_constraint_bottlenecks(
    target_table_name TEXT
) RETURNS TABLE (
    constraint_name TEXT,
    constraint_type TEXT,
    estimated_cost NUMERIC,
    bottleneck_type TEXT,
    optimization_suggestion TEXT
) AS $$
DECLARE
    constraint_record RECORD;
    table_size BIGINT;
    index_exists BOOLEAN;
BEGIN
    -- è·å–è¡¨å¤§å°
    SELECT pg_relation_size(target_table_name::regclass) INTO table_size;
    
    FOR constraint_record IN
        SELECT conname, contype, pg_get_constraintdef(oid) as definition
        FROM pg_constraint
        WHERE conrelid = target_table_name::regclass
    LOOP
        constraint_name := constraint_record.conname;
        
        CASE constraint_record.contype
            WHEN 'f' THEN  -- å¤–é”®çº¦æŸ
                constraint_type := 'å¤–é”®çº¦æŸ';
                
                -- æ£€æŸ¥å¤–é”®å­—æ®µæ˜¯å¦æœ‰ç´¢å¼•
                SELECT EXISTS(
                    SELECT 1 FROM pg_index i
                    JOIN pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = ANY(i.indkey)
                    WHERE i.indrelid = target_table_name::regclass
                    AND a.attname = split_part(
                        regexp_replace(constraint_record.definition, '.*\(([^)]+)\).*', '\1'), 
                        ',', 1
                    )
                ) INTO index_exists;
                
                IF NOT index_exists THEN
                    estimated_cost := table_size / 8192.0;  -- ä¼°ç®—éœ€è¦æ‰«æçš„é¡µæ•°
                    bottleneck_type := 'ç¼ºå°‘å¤–é”®ç´¢å¼•';
                    optimization_suggestion := 'ä¸ºå¤–é”®å­—æ®µåˆ›å»ºç´¢å¼•ï¼šCREATE INDEX ON ' || target_table_name || ' (å¤–é”®å­—æ®µ)';
                ELSE
                    estimated_cost := 1.0;  -- æœ‰ç´¢å¼•ï¼Œæˆæœ¬å¾ˆä½
                    bottleneck_type := 'æ— ';
                    optimization_suggestion := 'ç´¢å¼•å·²å­˜åœ¨ï¼Œæ€§èƒ½è‰¯å¥½';
                END IF;
                
            WHEN 'c' THEN  -- æ£€æŸ¥çº¦æŸ
                constraint_type := 'æ£€æŸ¥çº¦æŸ';
                
                IF constraint_record.definition ~* 'REGEXP|~' THEN
                    estimated_cost := 10.0;  -- æ­£åˆ™è¡¨è¾¾å¼æˆæœ¬è¾ƒé«˜
                    bottleneck_type := 'å¤æ‚æ­£åˆ™è¡¨è¾¾å¼';
                    optimization_suggestion := 'è€ƒè™‘ä½¿ç”¨å‡½æ•°ç´¢å¼•æˆ–é¢„è®¡ç®—å­—æ®µ';
                ELSIF constraint_record.definition ~* 'SELECT|EXISTS' THEN
                    estimated_cost := 100.0;  -- å­æŸ¥è¯¢æˆæœ¬å¾ˆé«˜
                    bottleneck_type := 'åŒ…å«å­æŸ¥è¯¢';
                    optimization_suggestion := 'ä½¿ç”¨è§¦å‘å™¨æˆ–åº”ç”¨å±‚éªŒè¯æ›¿ä»£';
                ELSE
                    estimated_cost := 0.1;  -- ç®€å•è¡¨è¾¾å¼æˆæœ¬å¾ˆä½
                    bottleneck_type := 'æ— ';
                    optimization_suggestion := 'ç®€å•çº¦æŸï¼Œæ€§èƒ½è‰¯å¥½';
                END IF;
                
            WHEN 'u' THEN  -- å”¯ä¸€çº¦æŸ
                constraint_type := 'å”¯ä¸€çº¦æŸ';
                estimated_cost := 1.0;  -- æœ‰è‡ªåŠ¨ç´¢å¼•ï¼Œæˆæœ¬ä½
                bottleneck_type := 'æ— ';
                optimization_suggestion := 'ç³»ç»Ÿè‡ªåŠ¨ä¼˜åŒ–ï¼Œè€ƒè™‘æŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–ç´¢å¼•åˆ—é¡ºåº';
        END CASE;
        
        RETURN NEXT;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨åˆ†æå·¥å…·
SELECT * FROM analyze_constraint_bottlenecks('order_items')
ORDER BY estimated_cost DESC;
```

### 9.2 æ‰¹é‡æ“ä½œçš„çº¦æŸä¼˜åŒ–


**ğŸ“¦ å¤§æ‰¹é‡æ•°æ®æ“ä½œä¼˜åŒ–**
```sql
-- åœºæ™¯ï¼šæ‰¹é‡å¯¼å…¥è®¢å•æ•°æ®
CREATE TABLE staging_orders (
    order_id INT,
    customer_id INT,
    product_id INT,
    quantity INT,
    unit_price DECIMAL(10,2),
    order_date DATE
);

-- ä¼˜åŒ–ç­–ç•¥1ï¼šé¢„éªŒè¯æ•°æ®è´¨é‡
CREATE OR REPLACE FUNCTION validate_staging_data()
RETURNS TABLE (
    validation_item TEXT,
    error_count BIGINT,
    sample_errors TEXT
) AS $$
BEGIN
    -- æ£€æŸ¥customer_idçš„æœ‰æ•ˆæ€§
    validation_item := 'æ— æ•ˆå®¢æˆ·ID';
    SELECT COUNT(*), STRING_AGG(DISTINCT customer_id::TEXT, ',') 
    INTO error_count, sample_errors
    FROM staging_orders s
    WHERE NOT EXISTS (SELECT 1 FROM customers c WHERE c.customer_id = s.customer_id)
    LIMIT 5;
    RETURN NEXT;
    
    -- æ£€æŸ¥product_idçš„æœ‰æ•ˆæ€§
    validation_item := 'æ— æ•ˆå•†å“ID';
    SELECT COUNT(*), STRING_AGG(DISTINCT product_id::TEXT, ',')
    INTO error_count, sample_errors  
    FROM staging_orders s
    WHERE NOT EXISTS (SELECT 1 FROM products p WHERE p.product_id = s.product_id)
    LIMIT 5;
    RETURN NEXT;
    
    -- æ£€æŸ¥é‡å¤è®¢å•
    validation_item := 'é‡å¤è®¢å•ID';
    SELECT COUNT(*), STRING_AGG(DISTINCT order_id::TEXT, ',')
    INTO error_count, sample_errors
    FROM (
        SELECT order_id, COUNT(*) 
        FROM staging_orders 
        GROUP BY order_id 
        HAVING COUNT(*) > 1
    ) t;
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql;

-- æ‰§è¡Œæ•°æ®éªŒè¯
SELECT * FROM validate_staging_data();
```

**ğŸš€ æ‰¹é‡æ’å…¥æ€§èƒ½ä¼˜åŒ–**
```sql
-- ä¼˜åŒ–ç­–ç•¥2ï¼šåˆ†æ‰¹æ’å…¥ + çº¦æŸä¼˜åŒ–
DO $$
DECLARE
    batch_size INT := 10000;
    total_rows INT;
    processed_rows INT := 0;
    start_time TIMESTAMP;
    batch_time TIMESTAMP;
BEGIN
    -- è·å–æ€»è¡Œæ•°
    SELECT COUNT(*) INTO total_rows FROM staging_orders;
    
    -- å¼€å§‹æ‰¹é‡å¤„ç†
    start_time := clock_timestamp();
    
    WHILE processed_rows < total_rows LOOP
        batch_time := clock_timestamp();
        
        -- åˆ†æ‰¹æ’å…¥ï¼Œåˆ©ç”¨ç°æœ‰ç´¢å¼•è¿›è¡Œçº¦æŸæ£€æŸ¥
        INSERT INTO orders (order_id, customer_id, product_id, quantity, unit_price, order_date)
        SELECT order_id, customer_id, product_id, quantity, unit_price, order_date
        FROM staging_orders
        ORDER BY order_id  -- æ’åºæ’å…¥ï¼Œæé«˜ç´¢å¼•æ•ˆç‡
        LIMIT batch_size OFFSET processed_rows;
        
        processed_rows := processed_rows + batch_size;
        
        -- è®°å½•è¿›åº¦
        RAISE NOTICE 'æ‰¹æ¬¡å®Œæˆ: %/% è¡Œ, è€—æ—¶: %ms', 
                     processed_rows, total_rows,
                     EXTRACT(EPOCH FROM (clock_timestamp() - batch_time)) * 1000;
        
        -- æäº¤å½“å‰æ‰¹æ¬¡ï¼Œé‡Šæ”¾é”
        COMMIT;
    END LOOP;
    
    RAISE NOTICE 'æ€»è®¡å®Œæˆ: % è¡Œ, æ€»è€—æ—¶: %s', 
                 total_rows, 
                 EXTRACT(EPOCH FROM (clock_timestamp() - start_time));
END $$;
```

### 9.3 çº¦æŸæ£€æŸ¥çš„å¹¶è¡ŒåŒ–ä¼˜åŒ–


**ğŸ”„ å¹¶è¡Œçº¦æŸéªŒè¯**
```sql
-- åœºæ™¯ï¼šå¤§è¡¨çº¦æŸéªŒè¯ä¼˜åŒ–
-- å½“æ·»åŠ æ–°çº¦æŸæ—¶ï¼Œéœ€è¦éªŒè¯ç°æœ‰æ•°æ®

-- æ–¹æ¡ˆ1ï¼šä¼ ç»Ÿçº¦æŸæ·»åŠ ï¼ˆå¯èƒ½å¾ˆæ…¢ï¼‰
-- ALTER TABLE large_table ADD CONSTRAINT ck_new_rule CHECK (value > 0);

-- æ–¹æ¡ˆ2ï¼šå¹¶è¡ŒéªŒè¯ + NOT VALIDçº¦æŸ
-- æ­¥éª¤1ï¼šæ·»åŠ NOT VALIDçº¦æŸï¼ˆä¸éªŒè¯ç°æœ‰æ•°æ®ï¼‰
ALTER TABLE large_table 
ADD CONSTRAINT ck_new_rule CHECK (value > 0) NOT VALID;

-- æ­¥éª¤2ï¼šå¹¶è¡ŒéªŒè¯ç°æœ‰æ•°æ®
SELECT 
    'validation_batch_' || (ROW_NUMBER() OVER () - 1) / 100000 as batch_id,
    COUNT(*) as rows_in_batch,
    COUNT(*) FILTER (WHERE NOT (value > 0)) as violations
FROM large_table
GROUP BY (ROW_NUMBER() OVER () - 1) / 100000;

-- æ­¥éª¤3ï¼šå¦‚æœéªŒè¯é€šè¿‡ï¼Œå¯ç”¨çº¦æŸ
-- ALTER TABLE large_table VALIDATE CONSTRAINT ck_new_rule;

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨å¹¶è¡ŒæŸ¥è¯¢éªŒè¯
SET max_parallel_workers_per_gather = 4;
SET parallel_tuple_cost = 0.1;

-- å¹¶è¡Œæ£€æŸ¥çº¦æŸè¿åæƒ…å†µ
EXPLAIN (ANALYZE, BUFFERS) 
SELECT COUNT(*) 
FROM large_table 
WHERE NOT (value > 0);  -- æ£€æŸ¥çº¦æŸæ¡ä»¶
```

---

## 10. ğŸ› ï¸ çº¦æŸå†²çªå¤„ç†æœºåˆ¶


### 10.1 çº¦æŸå†²çªçš„ç±»å‹ä¸å¤„ç†


**âš ï¸ å¸¸è§çº¦æŸå†²çªç±»å‹**

| å†²çªç±»å‹ | **å‘ç”Ÿåœºæ™¯** | **é”™è¯¯è¡¨ç°** | **å½±å“ç¨‹åº¦** | **å¤„ç†ç­–ç•¥** |
|---------|-------------|-------------|-------------|-------------|
| **å”¯ä¸€æ€§å†²çª** | `æ’å…¥é‡å¤å€¼` | `duplicate key error` | `ğŸ”´ é˜»æ­¢æ“ä½œ` | `ON CONFLICTå¤„ç†` |
| **å¤–é”®å†²çª** | `å¼•ç”¨ä¸å­˜åœ¨çš„å€¼` | `foreign key constraint` | `ğŸ”´ é˜»æ­¢æ“ä½œ` | `å…ˆåˆ›å»ºå¼•ç”¨æ•°æ®` |
| **æ£€æŸ¥çº¦æŸå†²çª** | `å€¼ä¸ç¬¦åˆæ¡ä»¶` | `check constraint violation` | `ğŸ”´ é˜»æ­¢æ“ä½œ` | `ä¿®æ­£æ•°æ®å€¼` |
| **éç©ºå†²çª** | `å¿…å¡«å­—æ®µä¸ºç©º` | `null value constraint` | `ğŸ”´ é˜»æ­¢æ“ä½œ` | `æä¾›é»˜è®¤å€¼` |

### 10.2 å”¯ä¸€çº¦æŸå†²çªå¤„ç†


**ğŸ”§ ON CONFLICTå¤„ç†æœºåˆ¶**
```sql
-- PostgreSQLçš„ON CONFLICTè¯­æ³•å¤„ç†å”¯ä¸€çº¦æŸå†²çª
CREATE TABLE user_login_log (
    user_id INT,
    login_date DATE,
    login_count INT DEFAULT 1,
    last_login_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸï¼šç”¨æˆ·æ¯å¤©åªæœ‰ä¸€æ¡ç™»å½•è®°å½•
    CONSTRAINT uk_user_daily_login UNIQUE (user_id, login_date)
);

-- å¤„ç†ç­–ç•¥1ï¼šå†²çªæ—¶æ›´æ–°è®¡æ•°
INSERT INTO user_login_log (user_id, login_date, last_login_time)
VALUES (123, CURRENT_DATE, CURRENT_TIMESTAMP)
ON CONFLICT (user_id, login_date) 
DO UPDATE SET 
    login_count = user_login_log.login_count + 1,
    last_login_time = EXCLUDED.last_login_time;

-- å¤„ç†ç­–ç•¥2ï¼šå†²çªæ—¶å¿½ç•¥
INSERT INTO user_settings (user_id, setting_name, setting_value)
VALUES (123, 'theme', 'dark')
ON CONFLICT (user_id, setting_name) DO NOTHING;

-- å¤„ç†ç­–ç•¥3ï¼šæ¡ä»¶æ€§æ›´æ–°
INSERT INTO user_preferences (user_id, preference_key, preference_value, updated_at)
VALUES (123, 'language', 'zh-CN', CURRENT_TIMESTAMP)
ON CONFLICT (user_id, preference_key)
DO UPDATE SET 
    preference_value = EXCLUDED.preference_value,
    updated_at = EXCLUDED.updated_at
WHERE user_preferences.updated_at < EXCLUDED.updated_at;  -- åªæœ‰æ›´æ–°çš„æ•°æ®æ‰è¦†ç›–
```

### 10.3 å¤–é”®çº¦æŸå†²çªå¤„ç†


**ğŸ”— å¤–é”®å†²çªçš„é¢„é˜²å’Œå¤„ç†**
```sql
-- åœºæ™¯ï¼šè®¢å•ç³»ç»Ÿä¸­çš„å¤–é”®å†²çªå¤„ç†

-- é—®é¢˜ï¼šåˆ›å»ºè®¢å•æ—¶å®¢æˆ·ä¸å­˜åœ¨
-- è§£å†³æ–¹æ¡ˆï¼šäº‹åŠ¡ä¸­å…ˆåˆ›å»ºå®¢æˆ·ï¼Œå†åˆ›å»ºè®¢å•
CREATE OR REPLACE FUNCTION create_order_with_customer(
    p_customer_name VARCHAR(100),
    p_customer_email VARCHAR(100),
    p_order_items JSONB
) RETURNS INT AS $$
DECLARE
    v_customer_id INT;
    v_order_id INT;
    item JSONB;
BEGIN
    -- 1. å…ˆå°è¯•æŸ¥æ‰¾ç°æœ‰å®¢æˆ·
    SELECT customer_id INTO v_customer_id
    FROM customers 
    WHERE customer_email = p_customer_email;
    
    -- 2. å¦‚æœå®¢æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å®¢æˆ·
    IF v_customer_id IS NULL THEN
        INSERT INTO customers (customer_name, customer_email)
        VALUES (p_customer_name, p_customer_email)
        RETURNING customer_id INTO v_customer_id;
    END IF;
    
    -- 3. åˆ›å»ºè®¢å•ï¼ˆå¤–é”®çº¦æŸç°åœ¨è‚¯å®šæ»¡è¶³ï¼‰
    INSERT INTO orders (customer_id, order_date, status)
    VALUES (v_customer_id, CURRENT_DATE, 'pending')
    RETURNING order_id INTO v_order_id;
    
    -- 4. åˆ›å»ºè®¢å•æ˜ç»†
    FOR item IN SELECT * FROM jsonb_array_elements(p_order_items)
    LOOP
        INSERT INTO order_items (order_id, product_id, quantity, unit_price)
        VALUES (
            v_order_id,
            (item->>'product_id')::INT,
            (item->>'quantity')::INT,
            (item->>'unit_price')::DECIMAL(10,2)
        );
    END LOOP;
    
    RETURN v_order_id;
    
EXCEPTION
    WHEN foreign_key_violation THEN
        RAISE EXCEPTION 'å¤–é”®çº¦æŸé”™è¯¯: å•†å“IDä¸å­˜åœ¨ - %', SQLERRM;
    WHEN unique_violation THEN
        RAISE EXCEPTION 'å”¯ä¸€æ€§çº¦æŸé”™è¯¯: æ•°æ®é‡å¤ - %', SQLERRM;
    WHEN check_violation THEN
        RAISE EXCEPTION 'æ£€æŸ¥çº¦æŸé”™è¯¯: æ•°æ®ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™ - %', SQLERRM;
END;
$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¤ºä¾‹
SELECT create_order_with_customer(
    'å¼ ä¸‰',
    'zhangsan@example.com',
    '[{"product_id": 1001, "quantity": 2, "unit_price": 99.99}]'::jsonb
);
```

**ğŸ›¡ï¸ çº¦æŸå†²çªçš„äº‹åŠ¡å¤„ç†**
```sql
-- å¤æ‚ä¸šåŠ¡åœºæ™¯çš„çº¦æŸå†²çªå¤„ç†
CREATE OR REPLACE FUNCTION safe_transfer_order(
    from_customer_id INT,
    to_customer_id INT,
    order_id INT
) RETURNS BOOLEAN AS $
DECLARE
    order_exists BOOLEAN;
    customer_exists BOOLEAN;
BEGIN
    -- å¼€å¯ä¿å­˜ç‚¹
    SAVEPOINT transfer_start;
    
    BEGIN
        -- éªŒè¯è®¢å•å­˜åœ¨ä¸”å±äºæºå®¢æˆ·
        SELECT EXISTS(
            SELECT 1 FROM orders 
            WHERE order_id = order_id AND customer_id = from_customer_id
        ) INTO order_exists;
        
        IF NOT order_exists THEN
            RAISE EXCEPTION 'è®¢å•ä¸å­˜åœ¨æˆ–ä¸å±äºæŒ‡å®šå®¢æˆ·';
        END IF;
        
        -- éªŒè¯ç›®æ ‡å®¢æˆ·å­˜åœ¨
        SELECT EXISTS(
            SELECT 1 FROM customers WHERE customer_id = to_customer_id
        ) INTO customer_exists;
        
        IF NOT customer_exists THEN
            RAISE EXCEPTION 'ç›®æ ‡å®¢æˆ·ä¸å­˜åœ¨';
        END IF;
        
        -- æ‰§è¡Œè½¬ç§»ï¼ˆå¯èƒ½è§¦å‘çº¦æŸæ£€æŸ¥ï¼‰
        UPDATE orders 
        SET customer_id = to_customer_id,
            updated_at = CURRENT_TIMESTAMP
        WHERE order_id = order_id;
        
        -- æ›´æ–°ç›¸å…³ç»Ÿè®¡ä¿¡æ¯
        UPDATE customer_stats 
        SET order_count = order_count - 1 
        WHERE customer_id = from_customer_id;
        
        UPDATE customer_stats 
        SET order_count = order_count + 1 
        WHERE customer_id = to_customer_id;
        
        RETURN TRUE;
        
    EXCEPTION
        WHEN foreign_key_violation OR check_violation THEN
            -- å›æ»šåˆ°ä¿å­˜ç‚¹
            ROLLBACK TO transfer_start;
            
            -- è®°å½•é”™è¯¯æ—¥å¿—
            INSERT INTO error_log (operation, error_message, occurred_at)
            VALUES ('order_transfer', SQLERRM, CURRENT_TIMESTAMP);
            
            RETURN FALSE;
    END;
END;
$ LANGUAGE plpgsql;
```

### 10.4 çº¦æŸå†²çªçš„è‡ªåŠ¨æ¢å¤æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨ä¿®å¤çº¦æŸå†²çª**
```sql
-- åˆ›å»ºçº¦æŸå†²çªè‡ªåŠ¨ä¿®å¤å·¥å…·
CREATE OR REPLACE FUNCTION auto_fix_constraint_violations(
    target_table TEXT,
    fix_mode TEXT DEFAULT 'report'  -- 'report', 'fix', 'delete'
) RETURNS TABLE (
    violation_type TEXT,
    affected_rows INT,
    fix_action TEXT,
    success_count INT
) AS $
DECLARE
    constraint_record RECORD;
    fix_count INT;
BEGIN
    FOR constraint_record IN
        SELECT conname, contype, pg_get_constraintdef(oid) as definition
        FROM pg_constraint
        WHERE conrelid = target_table::regclass
    LOOP
        CASE constraint_record.contype
            WHEN 'f' THEN  -- å¤–é”®çº¦æŸå†²çª
                violation_type := 'å¤–é”®çº¦æŸè¿å';
                
                -- æŸ¥æ‰¾è¿åå¤–é”®çº¦æŸçš„è®°å½•
                EXECUTE format('
                    SELECT COUNT(*) FROM %I t
                    WHERE NOT EXISTS (
                        SELECT 1 FROM %s r WHERE %s
                    )', 
                    target_table, 
                    /* è¿™é‡Œéœ€è¦è§£æçº¦æŸå®šä¹‰è·å–å¼•ç”¨è¡¨å’Œå­—æ®µ */
                    'r.id = t.foreign_key_field'  -- ç®€åŒ–ç¤ºä¾‹
                ) INTO affected_rows;
                
                IF fix_mode = 'delete' AND affected_rows > 0 THEN
                    -- åˆ é™¤è¿åçº¦æŸçš„è®°å½•
                    EXECUTE format('DELETE FROM %I WHERE ...', target_table);
                    GET DIAGNOSTICS fix_count = ROW_COUNT;
                    success_count := fix_count;
                    fix_action := 'åˆ é™¤è¿åçº¦æŸçš„è®°å½•';
                ELSE
                    fix_action := 'ä»…æŠ¥å‘Šï¼Œæœªæ‰§è¡Œä¿®å¤';
                    success_count := 0;
                END IF;
                
                RETURN NEXT;
                
            WHEN 'c' THEN  -- æ£€æŸ¥çº¦æŸå†²çª
                violation_type := 'æ£€æŸ¥çº¦æŸè¿å';
                
                -- æŸ¥æ‰¾è¿åæ£€æŸ¥çº¦æŸçš„è®°å½•
                EXECUTE format('
                    SELECT COUNT(*) FROM %I WHERE NOT (%s)',
                    target_table,
                    regexp_replace(constraint_record.definition, '^CHECK \((.*)\), '\1')
                ) INTO affected_rows;
                
                fix_action := 'éœ€è¦æ‰‹åŠ¨ä¿®å¤æ•°æ®å€¼';
                success_count := 0;
                RETURN NEXT;
        END CASE;
    END LOOP;
END;
$ LANGUAGE plpgsql;

-- ä½¿ç”¨çº¦æŸå†²çªä¿®å¤å·¥å…·
-- æ­¥éª¤1ï¼šæ£€æŸ¥é—®é¢˜
SELECT * FROM auto_fix_constraint_violations('orders', 'report');

-- æ­¥éª¤2ï¼šæ‰§è¡Œä¿®å¤ï¼ˆè°¨æ…æ“ä½œï¼ï¼‰
-- SELECT * FROM auto_fix_constraint_violations('orders', 'fix');
```

### 10.5 çº¦æŸå†²çªçš„é¢„é˜²æœºåˆ¶


**ğŸ›¡ï¸ å†²çªé¢„é˜²ç­–ç•¥**
```sql
-- ç­–ç•¥1ï¼šæ•°æ®å¯¼å…¥å‰çš„é¢„éªŒè¯
CREATE OR REPLACE FUNCTION pre_validate_import_data(
    source_table TEXT,
    target_table TEXT
) RETURNS TABLE (
    check_item TEXT,
    status TEXT,
    error_count BIGINT,
    sample_errors TEXT[]
) AS $
BEGIN
    -- æ£€æŸ¥1ï¼šä¸»é”®é‡å¤
    check_item := 'ä¸»é”®é‡å¤æ£€æŸ¥';
    EXECUTE format('
        SELECT COUNT(*), ARRAY_AGG(DISTINCT pk_value::TEXT)
        FROM (
            SELECT pk_field as pk_value, COUNT(*)
            FROM %I 
            GROUP BY pk_field
            HAVING COUNT(*) > 1
        ) t',
        source_table
    ) INTO error_count, sample_errors;
    
    status := CASE WHEN error_count = 0 THEN 'âœ… é€šè¿‡' ELSE 'âŒ å¤±è´¥' END;
    RETURN NEXT;
    
    -- æ£€æŸ¥2ï¼šå¤–é”®å¼•ç”¨å­˜åœ¨æ€§
    check_item := 'å¤–é”®å¼•ç”¨æ£€æŸ¥';
    EXECUTE format('
        SELECT COUNT(*), ARRAY_AGG(DISTINCT fk_value::TEXT)
        FROM %I s
        WHERE NOT EXISTS (
            SELECT 1 FROM %s t WHERE t.pk_field = s.fk_field
        )',
        source_table, target_table
    ) INTO error_count, sample_errors;
    
    status := CASE WHEN error_count = 0 THEN 'âœ… é€šè¿‡' ELSE 'âŒ å¤±è´¥' END;
    RETURN NEXT;
    
    -- æ›´å¤šæ£€æŸ¥é¡¹...
END;
$ LANGUAGE plpgsql;
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ çº¦æŸä¸ç´¢å¼•å…³ç³»ï¼šçº¦æŸæ˜¯è§„åˆ™ï¼Œç´¢å¼•æ˜¯æ‰§è¡Œå·¥å…·
ğŸ”¸ å”¯ä¸€æ€§çº¦æŸï¼šè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œä¿è¯æ•°æ®ä¸é‡å¤
ğŸ”¸ å¤–é”®çº¦æŸï¼šéœ€è¦æ‰‹åŠ¨åˆ›å»ºç´¢å¼•ï¼Œä¿è¯å¼•ç”¨å®Œæ•´æ€§
ğŸ”¸ æ£€æŸ¥çº¦æŸï¼šä¸åˆ›å»ºç´¢å¼•ï¼Œä½†å½±å“DMLæ“ä½œæ€§èƒ½
ğŸ”¸ çº¦æŸéªŒè¯ï¼šåœ¨INSERT/UPDATE/DELETEæ—¶è‡ªåŠ¨æ‰§è¡Œ
ğŸ”¸ å†²çªå¤„ç†ï¼šON CONFLICTæœºåˆ¶å’Œäº‹åŠ¡å›æ»šç­–ç•¥
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ çº¦æŸçš„åŒé‡ä½œç”¨**
```
æ•°æ®å®Œæ•´æ€§ä¿è¯ï¼š
- é˜²æ­¢è„æ•°æ®è¿›å…¥ç³»ç»Ÿ
- ç»´æŠ¤ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§
- ä¿è¯è¡¨é—´å…³ç³»çš„æ­£ç¡®æ€§

æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ï¼š
- å”¯ä¸€çº¦æŸè‡ªåŠ¨åˆ›å»ºç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- å¤–é”®çº¦æŸæç¤ºä¼˜åŒ–å™¨ä½¿ç”¨è¿æ¥ç®—æ³•
- çº¦æŸä¿¡æ¯å¸®åŠ©ä¼˜åŒ–å™¨ç”Ÿæˆæ›´å¥½çš„æ‰§è¡Œè®¡åˆ’
```

**ğŸ”¹ æ€§èƒ½å½±å“çš„å¹³è¡¡**
```
æ­£é¢å½±å“ï¼š
âœ… è‡ªåŠ¨ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
âœ… çº¦æŸä¿¡æ¯ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’
âœ… å‡å°‘åº”ç”¨å±‚æ•°æ®éªŒè¯

è´Ÿé¢å½±å“ï¼š
âŒ DMLæ“ä½œéœ€è¦é¢å¤–çš„çº¦æŸæ£€æŸ¥
âŒ å¤–é”®çº¦æŸå¯èƒ½å¯¼è‡´é”ç«äº‰
âŒ å¤æ‚æ£€æŸ¥çº¦æŸå½±å“æ’å…¥æ€§èƒ½

å¹³è¡¡ç­–ç•¥ï¼š
âš–ï¸ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©çº¦æŸç±»å‹
âš–ï¸ è¯»å¤šå†™å°‘ï¼šå¯ä»¥æœ‰æ›´å¤šçº¦æŸ
âš–ï¸ å†™å¤šè¯»å°‘ï¼šçº¦æŸè¦ç²¾ç®€è®¾è®¡
```

**ğŸ”¹ ç´¢å¼•è®¾è®¡çš„å…³é”®è¦ç´ **
```
å¤–é”®ç´¢å¼•å¿…è¦æ€§ï¼š
- å¤–é”®å­—æ®µå¿…é¡»æœ‰ç´¢å¼•ï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰
- ç´¢å¼•åŠ é€Ÿå¤–é”®çº¦æŸéªŒè¯
- ç‰¹åˆ«æ˜¯DELETEæ“ä½œçš„æ€§èƒ½å½±å“å·¨å¤§

å¤åˆçº¦æŸç´¢å¼•ï¼š
- å¤šåˆ—çº¦æŸéœ€è¦å¤åˆç´¢å¼•
- ç´¢å¼•åˆ—é¡ºåºå½±å“æŸ¥è¯¢æ€§èƒ½
- è€ƒè™‘æŸ¥è¯¢æ¨¡å¼è®¾è®¡ç´¢å¼•é¡ºåº

æ¡ä»¶çº¦æŸç´¢å¼•ï¼š
- éƒ¨åˆ†ç´¢å¼•æ”¯æŒæ¡ä»¶å”¯ä¸€æ€§
- WHEREå­å¥é™å®šç´¢å¼•èŒƒå›´
- å‡å°‘ç´¢å¼•å¤§å°ï¼Œæé«˜æ€§èƒ½
```

### 11.3 å®æˆ˜åº”ç”¨æŒ‡å¯¼


**ğŸ¯ çº¦æŸè®¾è®¡å†³ç­–æµç¨‹**
```
æ­¥éª¤1ï¼šä¸šåŠ¡è§„åˆ™åˆ†æ
â†’ å“ªäº›æ•°æ®å¿…é¡»å”¯ä¸€ï¼Ÿ
â†’ å“ªäº›å¼•ç”¨å…³ç³»å¿…é¡»ä¿è¯ï¼Ÿ
â†’ å“ªäº›æ•°å€¼èŒƒå›´å¿…é¡»é™åˆ¶ï¼Ÿ

æ­¥éª¤2ï¼šæ€§èƒ½å½±å“è¯„ä¼°
â†’ æ•°æ®æ“ä½œé¢‘ç‡å¦‚ä½•ï¼Ÿ
â†’ æ•°æ®é‡è§„æ¨¡å¤šå¤§ï¼Ÿ
â†’ å®æ—¶æ€§è¦æ±‚å¦‚ä½•ï¼Ÿ

æ­¥éª¤3ï¼šçº¦æŸç±»å‹é€‰æ‹©
â†’ ä¸¥æ ¼ä¸šåŠ¡è§„åˆ™ï¼šæ•°æ®åº“çº¦æŸ
â†’ æ€§èƒ½æ•æ„Ÿåœºæ™¯ï¼šåº”ç”¨å±‚éªŒè¯
â†’ å¤æ‚è§„åˆ™ï¼šè§¦å‘å™¨å®ç°

æ­¥éª¤4ï¼šç´¢å¼•é…å¥—è®¾è®¡
â†’ å¤–é”®å­—æ®µï¼šå¿…é¡»åˆ›å»ºç´¢å¼•
â†’ æŸ¥è¯¢ä¼˜åŒ–ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡
â†’ å¤åˆåœºæ™¯ï¼šè€ƒè™‘å¤åˆç´¢å¼•
```

**ğŸ”§ è¿ç»´ç›‘æ§è¦ç‚¹**
```
æ—¥å¸¸ç›‘æ§ï¼š
ğŸ“Š çº¦æŸè¿åé¢‘ç‡ç»Ÿè®¡
ğŸ“Š çº¦æŸæ£€æŸ¥æ€§èƒ½ç›‘æ§  
ğŸ“Š çº¦æŸç›¸å…³ç´¢å¼•ä½¿ç”¨ç‡
ğŸ“Š æ‰¹é‡æ“ä½œçš„çº¦æŸå½±å“

æ€§èƒ½è°ƒä¼˜ï¼š
âš¡ è¯†åˆ«çº¦æŸéªŒè¯ç“¶é¢ˆ
âš¡ ä¼˜åŒ–çº¦æŸè¡¨è¾¾å¼
âš¡ è°ƒæ•´ç´¢å¼•è®¾è®¡
âš¡ å¹³è¡¡çº¦æŸæ•°é‡

æ•…éšœå¤„ç†ï¼š
ğŸš¨ çº¦æŸå†²çªå¿«é€Ÿå®šä½
ğŸš¨ çº¦æŸéªŒè¯è¶…æ—¶å¤„ç†
ğŸš¨ çº¦æŸç´¢å¼•æŸåæ¢å¤
ğŸš¨ å¤§æ‰¹é‡æ“ä½œçš„çº¦æŸç­–ç•¥
```

**ğŸ’¡ æœ€ä½³å®è·µåŸåˆ™**
- **çº¦æŸè®¾è®¡è¦æœ‰æ˜ç¡®çš„ä¸šåŠ¡æ„ä¹‰**ï¼šæ¯ä¸ªçº¦æŸéƒ½åº”å¯¹åº”å…·ä½“çš„ä¸šåŠ¡è§„åˆ™
- **å¤–é”®å­—æ®µå¿…é¡»æœ‰ç´¢å¼•**ï¼šè¿™æ˜¯æ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬è¦æ±‚  
- **çº¦æŸéªŒè¯è¦è€ƒè™‘æ€§èƒ½å½±å“**ï¼šå¤æ‚çº¦æŸå¯èƒ½æ˜¾è‘—å½±å“DMLæ€§èƒ½
- **å†²çªå¤„ç†è¦æœ‰å®Œæ•´æ–¹æ¡ˆ**ï¼šåŒ…æ‹¬é¢„é˜²ã€æ£€æµ‹ã€å¤„ç†ã€æ¢å¤çš„å®Œæ•´æµç¨‹
- **ç›‘æ§å’Œç»´æŠ¤è¦å¸¸æ€åŒ–**ï¼šå®šæœŸæ£€æŸ¥çº¦æŸæ€§èƒ½å’Œä½¿ç”¨æƒ…å†µ

**æ ¸å¿ƒè®°å¿†**ï¼š
- çº¦æŸæ˜¯æ•°æ®è´¨é‡çš„å®ˆæŠ¤è€…ï¼Œç´¢å¼•æ˜¯çº¦æŸçš„æ‰§è¡Œåˆ©å™¨
- å¤–é”®å­—æ®µæ²¡æœ‰ç´¢å¼•å°±æ˜¯æ€§èƒ½ç¾éš¾
- çº¦æŸè®¾è®¡è¦åœ¨æ•°æ®å®Œæ•´æ€§å’Œæ€§èƒ½ä¹‹é—´æ‰¾å¹³è¡¡
- ON CONFLICTæœºåˆ¶æ˜¯å¤„ç†çº¦æŸå†²çªçš„ç°ä»£åŒ–æ–¹æ¡ˆ
- æ‰¹é‡æ“ä½œæ—¶è¦ç‰¹åˆ«è€ƒè™‘çº¦æŸéªŒè¯çš„æ€§èƒ½å½±å“