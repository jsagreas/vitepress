---
title: 13ã€æ•°æ®å˜æ¢ä¸å¤„ç†
---
## ğŸ“š ç›®å½•

1. [æ•°æ®å˜æ¢æ¦‚è¿°](#1-æ•°æ®å˜æ¢æ¦‚è¿°)
2. [Transformå˜æ¢æœºåˆ¶](#2-Transformå˜æ¢æœºåˆ¶)
3. [JavaScriptè„šæœ¬å¤„ç†](#3-JavaScriptè„šæœ¬å¤„ç†)
4. [æ•°æ®æ¸…æ´—ä¸æ ¼å¼è½¬æ¢](#4-æ•°æ®æ¸…æ´—ä¸æ ¼å¼è½¬æ¢)
5. [ä¸šåŠ¡é€»è¾‘å¤„ç†](#5-ä¸šåŠ¡é€»è¾‘å¤„ç†)
6. [æ•°æ®éªŒè¯ä¸é”™è¯¯å¤„ç†](#6-æ•°æ®éªŒè¯ä¸é”™è¯¯å¤„ç†)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ•°æ®å˜æ¢æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®å˜æ¢


**ç®€å•ç†è§£**ï¼šæ•°æ®å˜æ¢å°±æ˜¯åœ¨æ•°æ®ä»æºç«¯åŒæ­¥åˆ°ç›®æ ‡ç«¯çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ•°æ®è¿›è¡ŒåŠ å·¥å¤„ç†

```
æ•°æ®æµè½¬è¿‡ç¨‹ï¼š
æºç«¯æ•°æ® â†’ æå–(Extract) â†’ å˜æ¢(Transform) â†’ åŠ è½½(Load) â†’ ç›®æ ‡ç«¯

å˜æ¢çš„ä½œç”¨ï¼š
â”œâ”€ æ•°æ®æ ¼å¼é€‚é…ï¼šæºç«¯å’Œç›®æ ‡ç«¯æ ¼å¼ä¸åŒ
â”œâ”€ ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼šåŠ å…¥ä¸šåŠ¡è§„åˆ™å’Œè®¡ç®—
â”œâ”€ æ•°æ®æ¸…æ´—ï¼šå»é™¤è„æ•°æ®å’Œé”™è¯¯æ•°æ®
â””â”€ æ•°æ®å¢å¼ºï¼šæ·»åŠ é¢å¤–çš„ä¸šåŠ¡å­—æ®µ
```

**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å˜æ¢**ï¼š
- ğŸ”„ **æ ¼å¼å·®å¼‚**ï¼šä¸åŒç³»ç»Ÿé—´æ•°æ®æ ¼å¼ä¸ä¸€è‡´
- ğŸ“Š **ä¸šåŠ¡éœ€æ±‚**ï¼šç›®æ ‡ç«¯éœ€è¦é¢å¤–çš„ä¸šåŠ¡å¤„ç†
- ğŸ§¹ **æ•°æ®è´¨é‡**ï¼šæ¸…æ´—å’Œä¿®æ­£æ•°æ®é—®é¢˜
- ğŸ¯ **å­—æ®µæ˜ å°„**ï¼šæºç«¯å­—æ®µä¸ç›®æ ‡ç«¯å­—æ®µä¸å¯¹åº”

### 1.2 Otterå˜æ¢æ¶æ„


**Otterå˜æ¢å¤„ç†æµç¨‹**ï¼š
```
binlogè§£æ
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®æå–       â”‚ â† è·å–å˜æ›´æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å‰ç½®è¿‡æ»¤       â”‚ â† è¿‡æ»¤ä¸éœ€è¦çš„æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Transformå˜æ¢   â”‚ â† æ ¸å¿ƒå˜æ¢å¤„ç†
â”‚ â”œâ”€ å­—æ®µæ˜ å°„     â”‚
â”‚ â”œâ”€ æ•°æ®æ¸…æ´—     â”‚  
â”‚ â”œâ”€ æ ¼å¼è½¬æ¢     â”‚
â”‚ â””â”€ ä¸šåŠ¡å¤„ç†     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åç½®éªŒè¯       â”‚ â† éªŒè¯å˜æ¢ç»“æœ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç›®æ ‡å†™å…¥       â”‚ â† å†™å…¥ç›®æ ‡ç«¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å˜æ¢çš„åº”ç”¨åœºæ™¯


**å…¸å‹å˜æ¢åœºæ™¯**ï¼š
```
ğŸ”¸ å­—æ®µé‡å‘½åï¼š
æºç«¯ï¼šuser_name â†’ ç›®æ ‡ç«¯ï¼šusername

ğŸ”¸ æ•°æ®ç±»å‹è½¬æ¢ï¼š
æºç«¯ï¼šå­—ç¬¦ä¸² "123" â†’ ç›®æ ‡ç«¯ï¼šæ•´æ•° 123

ğŸ”¸ ä¸šåŠ¡è®¡ç®—ï¼š
æºç«¯ï¼šprice, quantity â†’ ç›®æ ‡ç«¯ï¼štotal_amount = price * quantity

ğŸ”¸ æ•°æ®è„±æ•ï¼š
æºç«¯ï¼šæ‰‹æœºå· 13812345678 â†’ ç›®æ ‡ç«¯ï¼š138****5678

ğŸ”¸ æ•°æ®æ‹†åˆ†ï¼š
æºç«¯ï¼šfull_name "å¼ ä¸‰" â†’ ç›®æ ‡ç«¯ï¼šfirst_name "å¼ ", last_name "ä¸‰"
```

---

## 2. âš™ï¸ Transformå˜æ¢æœºåˆ¶


### 2.1 TransformåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Transform**ï¼šOtterä¸­è´Ÿè´£æ•°æ®å˜æ¢çš„æ ¸å¿ƒç»„ä»¶
- ğŸ¯ **ä½œç”¨ä½ç½®**ï¼šåœ¨æ•°æ®æå–åã€åŠ è½½å‰è¿›è¡Œå¤„ç†
- ğŸ”§ **å¤„ç†æ–¹å¼**ï¼šåŸºäºé…ç½®è§„åˆ™å’Œè„šæœ¬çš„æ•°æ®å¤„ç†
- âš¡ **æ‰§è¡Œæ—¶æœº**ï¼šæ¯æ¡æ•°æ®å˜æ›´éƒ½ä¼šç»è¿‡Transformå¤„ç†

### 2.2 Transformé…ç½®ç»“æ„


**Transformé…ç½®å±‚æ¬¡**ï¼š
```
Pipelineç®¡é“é…ç½®
â”œâ”€ Channelé€šé“é…ç½®
â”‚  â”œâ”€ æ•°æ®æºé…ç½®
â”‚  â”œâ”€ ç›®æ ‡æºé…ç½®
â”‚  â””â”€ Transformå˜æ¢é…ç½®
â”‚     â”œâ”€ å­—æ®µæ˜ å°„è§„åˆ™
â”‚     â”œâ”€ æ•°æ®å¤„ç†è„šæœ¬
â”‚     â”œâ”€ è¿‡æ»¤æ¡ä»¶è®¾ç½®
â”‚     â””â”€ éªŒè¯è§„åˆ™é…ç½®
â””â”€ ç›‘æ§å‘Šè­¦é…ç½®
```

**Transformé…ç½®ç¤ºä¾‹**ï¼š
```xml
<transform>
    <!-- å­—æ®µæ˜ å°„é…ç½® -->
    <columnPairs>
        <columnPair>
            <sourceColumn>user_name</sourceColumn>
            <targetColumn>username</targetColumn>
        </columnPair>
    </columnPairs>
    
    <!-- è„šæœ¬å¤„ç†é…ç½® -->
    <script type="javascript">
        // JavaScriptå¤„ç†é€»è¾‘
        if (rowData.age != null && rowData.age < 18) {
            rowData.category = "minor";
        } else {
            rowData.category = "adult";
        }
    </script>
</transform>
```

### 2.3 å˜æ¢æ‰§è¡Œæµç¨‹


**å•æ¡æ•°æ®å˜æ¢è¿‡ç¨‹**ï¼š
```
1. æ¥æ”¶æºç«¯æ•°æ®å˜æ›´
   â†“
2. è§£æå˜æ›´ç±»å‹ (INSERT/UPDATE/DELETE)
   â†“  
3. åº”ç”¨å­—æ®µæ˜ å°„è§„åˆ™
   â†“
4. æ‰§è¡ŒJavaScriptè„šæœ¬å¤„ç†
   â†“
5. è¿›è¡Œæ•°æ®éªŒè¯æ£€æŸ¥
   â†“
6. ç”Ÿæˆç›®æ ‡ç«¯æ•°æ®æ ¼å¼
   â†“
7. ä¼ é€’ç»™Loadæ¨¡å—
```

**æ‰¹é‡æ•°æ®å¤„ç†**ï¼š
```java
// ä¼ªä»£ç ç¤ºä¾‹
public void processEventData(List<EventData> events) {
    for (EventData event : events) {
        try {
            // 1. å­—æ®µæ˜ å°„
            Map<String, Object> mappedData = applyFieldMapping(event);
            
            // 2. è„šæœ¬å¤„ç†  
            Map<String, Object> transformedData = executeScript(mappedData);
            
            // 3. æ•°æ®éªŒè¯
            validateData(transformedData);
            
            // 4. è®¾ç½®å¤„ç†ç»“æœ
            event.setProcessedData(transformedData);
            
        } catch (Exception e) {
            // é”™è¯¯å¤„ç†
            handleTransformError(event, e);
        }
    }
}
```

---

## 3. ğŸ’» JavaScriptè„šæœ¬å¤„ç†


### 3.1 JavaScriptå¼•æ“æ”¯æŒ


**Otterå†…ç½®JavaScriptå¼•æ“**ï¼š
- ğŸ”§ **å¼•æ“ç±»å‹**ï¼šåŸºäºRhino JavaScriptå¼•æ“
- ğŸ¯ **æ‰§è¡Œç¯å¢ƒ**ï¼šJVMå†…åµŒçš„JavaScriptè¿è¡Œæ—¶
- âš¡ **æ€§èƒ½ç‰¹ç‚¹**ï¼šè§£é‡Šæ‰§è¡Œï¼Œé€‚åˆæ•°æ®å¤„ç†é€»è¾‘

### 3.2 è„šæœ¬ç¼–å†™åŸºç¡€


**è„šæœ¬è®¿é—®çš„å†…ç½®å¯¹è±¡**ï¼š
```javascript
// rowDataï¼šå½“å‰è¡Œæ•°æ®å¯¹è±¡
rowData.username = "newValue";

// tableDataï¼šè¡¨ç›¸å…³ä¿¡æ¯
var tableName = tableData.schemaName + "." + tableData.tableName;

// eventTypeï¼šæ“ä½œç±»å‹
if (eventType == "INSERT") {
    // æ’å…¥æ“ä½œçš„ç‰¹æ®Šå¤„ç†
}

// contextï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¯å­˜å‚¨ä¸´æ—¶æ•°æ®
context.put("processTime", new Date());
```

**åŸºæœ¬æ•°æ®æ“ä½œ**ï¼š
```javascript
// 1. å­—æ®µé‡å‘½å
rowData.new_field = rowData.old_field;
delete rowData.old_field;

// 2. æ•°æ®ç±»å‹è½¬æ¢
rowData.age = parseInt(rowData.age_str);

// 3. å­—ç¬¦ä¸²å¤„ç†
rowData.name = rowData.name.trim().toUpperCase();

// 4. æ—¥æœŸå¤„ç†
if (rowData.created_time) {
    var date = new Date(rowData.created_time);
    rowData.created_date = date.toISOString().substring(0, 10);
}

// 5. æ¡ä»¶å¤„ç†
if (rowData.status == "active") {
    rowData.is_enabled = 1;
} else {
    rowData.is_enabled = 0;
}
```

### 3.3 é«˜çº§è„šæœ¬åŠŸèƒ½


**ğŸ”¸ å¤–éƒ¨å‡½æ•°è°ƒç”¨**ï¼š
```javascript
// è°ƒç”¨Javaå·¥å…·ç±»
var StringUtils = Java.type("org.apache.commons.lang3.StringUtils");
if (StringUtils.isBlank(rowData.description)) {
    rowData.description = "é»˜è®¤æè¿°";
}

// è°ƒç”¨è‡ªå®šä¹‰å·¥å…·ç±»
var DataProcessor = Java.type("com.company.utils.DataProcessor");
rowData.processed_value = DataProcessor.process(rowData.raw_value);
```

**ğŸ”¸ æ•°æ®éªŒè¯é€»è¾‘**ï¼š
```javascript
// æ‰‹æœºå·éªŒè¯
function validatePhone(phone) {
    var pattern = /^1[3-9]\d{9}$/;
    return pattern.test(phone);
}

if (!validatePhone(rowData.phone)) {
    throw new Error("æ— æ•ˆçš„æ‰‹æœºå·: " + rowData.phone);
}

// é‚®ç®±éªŒè¯
function validateEmail(email) {
    var pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return pattern.test(email);
}
```

**ğŸ”¸ å¤æ‚ä¸šåŠ¡å¤„ç†**ï¼š
```javascript
// è®¡ç®—ç”¨æˆ·ç­‰çº§
function calculateUserLevel(totalAmount, registerDays) {
    if (totalAmount > 10000 && registerDays > 365) {
        return "VIP";
    } else if (totalAmount > 5000 && registerDays > 180) {
        return "Gold";
    } else if (totalAmount > 1000 && registerDays > 30) {
        return "Silver";
    } else {
        return "Bronze";
    }
}

rowData.user_level = calculateUserLevel(
    rowData.total_amount, 
    rowData.register_days
);
```

---

## 4. ğŸ§¹ æ•°æ®æ¸…æ´—ä¸æ ¼å¼è½¬æ¢


### 4.1 å¸¸è§æ•°æ®æ¸…æ´—éœ€æ±‚


**æ•°æ®æ¸…æ´—åœºæ™¯æ€»è§ˆ**ï¼š
```
æ•°æ®æ¸…æ´—ç±»å‹ï¼š
â”œâ”€ ç©ºå€¼å¤„ç†ï¼šNULLã€ç©ºå­—ç¬¦ä¸²ã€ç©ºæ ¼
â”œâ”€ é‡å¤æ•°æ®ï¼šåŸºäºä¸šåŠ¡è§„åˆ™å»é‡
â”œâ”€ æ ¼å¼ç»Ÿä¸€ï¼šæ—¥æœŸã€ç”µè¯ã€åœ°å€æ ¼å¼
â”œâ”€ å¼‚å¸¸å€¼ï¼šè¶…å‡ºåˆç†èŒƒå›´çš„æ•°æ®
â”œâ”€ ç¼–ç é—®é¢˜ï¼šå­—ç¬¦ç¼–ç è½¬æ¢
â””â”€ ä¸šåŠ¡è§„åˆ™ï¼šä¸ç¬¦åˆä¸šåŠ¡é€»è¾‘çš„æ•°æ®
```

### 4.2 ç©ºå€¼å’Œå¼‚å¸¸æ•°æ®å¤„ç†


**ğŸ”¸ ç©ºå€¼å¤„ç†ç­–ç•¥**ï¼š
```javascript
// 1. è®¾ç½®é»˜è®¤å€¼
if (!rowData.description || rowData.description.trim() === "") {
    rowData.description = "æš‚æ— æè¿°";
}

// 2. NULLå€¼è½¬æ¢
if (rowData.score === null) {
    rowData.score = 0;
}

// 3. ç©ºå€¼è·³è¿‡å¤„ç†
if (rowData.optional_field === null || 
    rowData.optional_field === undefined) {
    delete rowData.optional_field;
}
```

**ğŸ”¸ å¼‚å¸¸æ•°æ®å¤„ç†**ï¼š
```javascript
// å¹´é¾„èŒƒå›´æ£€æŸ¥
if (rowData.age < 0 || rowData.age > 150) {
    rowData.age = null;  // è®¾ä¸ºç©ºå€¼
    rowData.age_status = "invalid";  // æ·»åŠ çŠ¶æ€æ ‡è®°
}

// é‡‘é¢èŒƒå›´æ£€æŸ¥
if (rowData.amount < 0) {
    throw new Error("é‡‘é¢ä¸èƒ½ä¸ºè´Ÿæ•°: " + rowData.amount);
}

// æšä¸¾å€¼æ£€æŸ¥
var validStatus = ["active", "inactive", "pending"];
if (validStatus.indexOf(rowData.status) === -1) {
    rowData.status = "unknown";
}
```

### 4.3 æ ¼å¼è½¬æ¢å¤„ç†


**ğŸ”¸ æ—¥æœŸæ ¼å¼è½¬æ¢**ï¼š
```javascript
// ç»Ÿä¸€æ—¥æœŸæ ¼å¼
function formatDate(dateStr) {
    if (!dateStr) return null;
    
    var date = new Date(dateStr);
    if (isNaN(date.getTime())) {
        return null;  // æ— æ•ˆæ—¥æœŸ
    }
    
    // è½¬æ¢ä¸º YYYY-MM-DD HH:mm:ss æ ¼å¼
    return date.toISOString().replace('T', ' ').substring(0, 19);
}

rowData.created_time = formatDate(rowData.created_time);
rowData.updated_time = formatDate(rowData.updated_time);
```

**ğŸ”¸ æ•°å€¼æ ¼å¼è½¬æ¢**ï¼š
```javascript
// é‡‘é¢æ ¼å¼å¤„ç†ï¼ˆå»é™¤é€—å·ï¼Œä¿ç•™2ä½å°æ•°ï¼‰
function formatAmount(amountStr) {
    if (!amountStr) return 0;
    
    // å»é™¤é€—å·å’Œå…¶ä»–éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™å°æ•°ç‚¹ï¼‰
    var numStr = amountStr.toString().replace(/[^0-9.-]/g, '');
    var num = parseFloat(numStr);
    
    return isNaN(num) ? 0 : Math.round(num * 100) / 100;
}

rowData.price = formatAmount(rowData.price);
rowData.total = formatAmount(rowData.total);
```

**ğŸ”¸ å­—ç¬¦ä¸²æ ¼å¼å¤„ç†**ï¼š
```javascript
// æ‰‹æœºå·æ ¼å¼ç»Ÿä¸€
function formatPhone(phone) {
    if (!phone) return "";
    
    // å»é™¤æ‰€æœ‰éæ•°å­—å­—ç¬¦
    var digits = phone.replace(/\D/g, '');
    
    // ä¸­å›½æ‰‹æœºå·å¤„ç†
    if (digits.length === 11 && digits.startsWith('1')) {
        return digits;
    }
    
    return phone;  // å…¶ä»–æ ¼å¼ä¿æŒåŸæ ·
}

rowData.phone = formatPhone(rowData.phone);
```

---

## 5. ğŸ¢ ä¸šåŠ¡é€»è¾‘å¤„ç†


### 5.1 ä¸šåŠ¡è§„åˆ™å®ç°


**å¸¸è§ä¸šåŠ¡å¤„ç†éœ€æ±‚**ï¼š
```
ä¸šåŠ¡é€»è¾‘ç±»å‹ï¼š
â”œâ”€ çŠ¶æ€è½¬æ¢ï¼šæ ¹æ®æ¡ä»¶è®¾ç½®çŠ¶æ€
â”œâ”€ åˆ†ç±»æ ‡è®°ï¼šæ•°æ®åˆ†ç±»å’Œæ ‡ç­¾
â”œâ”€ è®¡ç®—å­—æ®µï¼šåŸºäºå…¶ä»–å­—æ®µè®¡ç®—
â”œâ”€ å…³è”æŸ¥è¯¢ï¼šæŸ¥è¯¢ç›¸å…³æ•°æ®
â”œâ”€ ä¸šåŠ¡éªŒè¯ï¼šä¸šåŠ¡è§„åˆ™æ£€æŸ¥
â””â”€ æ•°æ®å¢å¼ºï¼šæ·»åŠ ä¸šåŠ¡ä¿¡æ¯
```

### 5.2 çŠ¶æ€å’Œåˆ†ç±»å¤„ç†


**ğŸ”¸ ç”¨æˆ·çŠ¶æ€ç®¡ç†**ï¼š
```javascript
// ç”¨æˆ·æ´»è·ƒåº¦è®¡ç®—
function calculateActivityStatus(lastLoginTime, registerTime) {
    var now = new Date();
    var lastLogin = new Date(lastLoginTime);
    var register = new Date(registerTime);
    
    var daysSinceLogin = (now - lastLogin) / (1000 * 60 * 60 * 24);
    var daysSinceRegister = (now - register) / (1000 * 60 * 60 * 24);
    
    if (daysSinceLogin <= 7) {
        return "active";
    } else if (daysSinceLogin <= 30) {
        return "inactive";
    } else if (daysSinceRegister > 90) {
        return "dormant";
    } else {
        return "new";
    }
}

rowData.activity_status = calculateActivityStatus(
    rowData.last_login_time, 
    rowData.register_time
);
```

**ğŸ”¸ å•†å“åˆ†ç±»å¤„ç†**ï¼š
```javascript
// å•†å“ä»·æ ¼åˆ†çº§
function getPriceCategory(price) {
    if (price < 100) return "low";
    if (price < 500) return "medium";
    if (price < 2000) return "high";
    return "premium";
}

// å•†å“æ ‡ç­¾ç”Ÿæˆ
function generateProductTags(category, price, brand) {
    var tags = [];
    
    tags.push(category);
    tags.push(getPriceCategory(price));
    
    if (brand && brand.length > 0) {
        tags.push(brand.toLowerCase());
    }
    
    return tags.join(",");
}

rowData.price_category = getPriceCategory(rowData.price);
rowData.tags = generateProductTags(
    rowData.category, 
    rowData.price, 
    rowData.brand
);
```

### 5.3 è®¡ç®—å­—æ®µå¤„ç†


**ğŸ”¸ è´¢åŠ¡è®¡ç®—**ï¼š
```javascript
// è®¢å•é‡‘é¢è®¡ç®—
function calculateOrderAmounts(items) {
    var subtotal = 0;
    var tax = 0;
    var discount = 0;
    
    if (items && items.length > 0) {
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            subtotal += item.price * item.quantity;
        }
    }
    
    // è®¡ç®—ç¨è´¹ï¼ˆ10%ï¼‰
    tax = Math.round(subtotal * 0.1 * 100) / 100;
    
    // è®¡ç®—æŠ˜æ‰£ï¼ˆæ»¡100å‡10ï¼‰
    if (subtotal >= 100) {
        discount = Math.floor(subtotal / 100) * 10;
    }
    
    var total = subtotal + tax - discount;
    
    return {
        subtotal: subtotal,
        tax: tax,
        discount: discount,
        total: Math.round(total * 100) / 100
    };
}

// åº”ç”¨è®¡ç®—ç»“æœ
var amounts = calculateOrderAmounts(rowData.order_items);
rowData.subtotal = amounts.subtotal;
rowData.tax_amount = amounts.tax;
rowData.discount_amount = amounts.discount;
rowData.total_amount = amounts.total;
```

### 5.4 æ•°æ®è„±æ•å¤„ç†


**ğŸ”¸ æ•æ„Ÿä¿¡æ¯è„±æ•**ï¼š
```javascript
// æ‰‹æœºå·è„±æ•
function maskPhone(phone) {
    if (!phone || phone.length < 7) return phone;
    return phone.substring(0, 3) + "****" + phone.substring(phone.length - 4);
}

// èº«ä»½è¯è„±æ•
function maskIdCard(idCard) {
    if (!idCard || idCard.length < 10) return idCard;
    return idCard.substring(0, 3) + "***********" + idCard.substring(idCard.length - 4);
}

// é‚®ç®±è„±æ•
function maskEmail(email) {
    if (!email || email.indexOf('@') === -1) return email;
    var parts = email.split('@');
    var name = parts[0];
    var domain = parts[1];
    
    if (name.length <= 2) {
        return name + "***@" + domain;
    } else {
        return name.substring(0, 2) + "***@" + domain;
    }
}

// åº”ç”¨è„±æ•å¤„ç†
if (rowData.phone) {
    rowData.phone_masked = maskPhone(rowData.phone);
}
if (rowData.id_card) {
    rowData.id_card_masked = maskIdCard(rowData.id_card);
}
if (rowData.email) {
    rowData.email_masked = maskEmail(rowData.email);
}
```

---

## 6. âœ… æ•°æ®éªŒè¯ä¸é”™è¯¯å¤„ç†


### 6.1 æ•°æ®éªŒè¯è§„åˆ™


**éªŒè¯è§„åˆ™ç±»å‹**ï¼š
```
æ•°æ®éªŒè¯ç»´åº¦ï¼š
â”œâ”€ æ ¼å¼éªŒè¯ï¼šæ‰‹æœºå·ã€é‚®ç®±ã€èº«ä»½è¯æ ¼å¼
â”œâ”€ èŒƒå›´éªŒè¯ï¼šæ•°å€¼èŒƒå›´ã€æ—¥æœŸèŒƒå›´
â”œâ”€ é•¿åº¦éªŒè¯ï¼šå­—ç¬¦ä¸²é•¿åº¦é™åˆ¶
â”œâ”€ å¿…å¡«éªŒè¯ï¼šå¿…éœ€å­—æ®µæ£€æŸ¥
â”œâ”€ å”¯ä¸€æ€§éªŒè¯ï¼šä¸šåŠ¡å”¯ä¸€æ€§æ£€æŸ¥
â””â”€ å…³è”éªŒè¯ï¼šå¤–é”®å…³è”æ£€æŸ¥
```

### 6.2 è‡ªå®šä¹‰éªŒè¯å‡½æ•°


**ğŸ”¸ é€šç”¨éªŒè¯å·¥å…·**ï¼š
```javascript
// éªŒè¯å·¥å…·ç±»
var Validator = {
    // æ‰‹æœºå·éªŒè¯
    isValidPhone: function(phone) {
        var pattern = /^1[3-9]\d{9}$/;
        return pattern.test(phone);
    },
    
    // é‚®ç®±éªŒè¯
    isValidEmail: function(email) {
        var pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return pattern.test(email);
    },
    
    // èº«ä»½è¯éªŒè¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
    isValidIdCard: function(idCard) {
        return idCard && idCard.length === 18 && /^\d{17}[\dXx]$/.test(idCard);
    },
    
    // éç©ºéªŒè¯
    isNotEmpty: function(value) {
        return value !== null && value !== undefined && 
               value.toString().trim().length > 0;
    },
    
    // æ•°å€¼èŒƒå›´éªŒè¯
    isInRange: function(value, min, max) {
        var num = parseFloat(value);
        return !isNaN(num) && num >= min && num <= max;
    }
};
```

**ğŸ”¸ ä¸šåŠ¡éªŒè¯è§„åˆ™**ï¼š
```javascript
// ç”¨æˆ·æ•°æ®éªŒè¯
function validateUserData(userData) {
    var errors = [];
    
    // å¿…å¡«å­—æ®µæ£€æŸ¥
    if (!Validator.isNotEmpty(userData.username)) {
        errors.push("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
    }
    
    // æ‰‹æœºå·éªŒè¯
    if (userData.phone && !Validator.isValidPhone(userData.phone)) {
        errors.push("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");
    }
    
    // é‚®ç®±éªŒè¯
    if (userData.email && !Validator.isValidEmail(userData.email)) {
        errors.push("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
    }
    
    // å¹´é¾„èŒƒå›´éªŒè¯
    if (userData.age && !Validator.isInRange(userData.age, 0, 150)) {
        errors.push("å¹´é¾„å¿…é¡»åœ¨0-150ä¹‹é—´");
    }
    
    return errors;
}

// åº”ç”¨éªŒè¯
var validationErrors = validateUserData(rowData);
if (validationErrors.length > 0) {
    throw new Error("æ•°æ®éªŒè¯å¤±è´¥: " + validationErrors.join(", "));
}
```

### 6.3 é”™è¯¯å¤„ç†ç­–ç•¥


**ğŸ”¸ é”™è¯¯å¤„ç†çº§åˆ«**ï¼š
```javascript
// é”™è¯¯å¤„ç†é…ç½®
var ErrorHandler = {
    // ä¸¥é‡é”™è¯¯ï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œåœæ­¢å¤„ç†
    CRITICAL: function(message, data) {
        throw new Error("CRITICAL: " + message + ", data: " + JSON.stringify(data));
    },
    
    // è­¦å‘Šï¼šè®°å½•æ—¥å¿—ï¼Œè®¾ç½®æ ‡è®°ï¼Œç»§ç»­å¤„ç†
    WARNING: function(message, data) {
        console.warn("WARNING: " + message);
        data.warning_flag = true;
        data.warning_message = message;
    },
    
    // ä¿¡æ¯ï¼šè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¤„ç†
    INFO: function(message) {
        console.info("INFO: " + message);
    }
};

// é”™è¯¯å¤„ç†ç¤ºä¾‹
try {
    // å…³é”®ä¸šåŠ¡é€»è¾‘
    if (!rowData.user_id) {
        ErrorHandler.CRITICAL("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º", rowData);
    }
    
    // æ•°æ®æ ¼å¼é—®é¢˜
    if (!Validator.isValidPhone(rowData.phone)) {
        ErrorHandler.WARNING("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®", rowData);
        rowData.phone = null;  // æ¸…ç©ºæ— æ•ˆæ•°æ®
    }
    
} catch (error) {
    // è®°å½•é”™è¯¯ä¿¡æ¯
    rowData.error_info = error.message;
    rowData.process_status = "failed";
    throw error;  // é‡æ–°æŠ›å‡ºï¼Œè®©æ¡†æ¶å¤„ç†
}
```

### 6.4 é”™è¯¯æ•°æ®å¤„ç†


**é”™è¯¯æ•°æ®å¤„ç†æµç¨‹**ï¼š
```
é”™è¯¯æ•°æ®å¤„ç†ç­–ç•¥ï¼š
â”œâ”€ æ•°æ®ä¿®å¤ï¼šå°è¯•è‡ªåŠ¨ä¿®å¤æ•°æ®
â”œâ”€ æ•°æ®æ ‡è®°ï¼šæ ‡è®°æœ‰é—®é¢˜çš„æ•°æ®
â”œâ”€ æ•°æ®è·³è¿‡ï¼šè·³è¿‡å¤„ç†ï¼Œè®°å½•æ—¥å¿—
â”œâ”€ æ•°æ®éš”ç¦»ï¼šå­˜å…¥é”™è¯¯è¡¨ï¼Œäººå·¥å¤„ç†
â””â”€ æµç¨‹ä¸­æ–­ï¼šä¸¥é‡é”™è¯¯æ—¶ä¸­æ–­åŒæ­¥
```

**é”™è¯¯æ¢å¤æœºåˆ¶**ï¼š
```javascript
// æ•°æ®ä¿®å¤å°è¯•
function attemptDataRepair(rowData) {
    var repaired = false;
    
    // å°è¯•ä¿®å¤æ‰‹æœºå·æ ¼å¼
    if (rowData.phone && rowData.phone.length === 11) {
        if (!/^1[3-9]\d{9}$/.test(rowData.phone)) {
            // å¦‚æœæ˜¯çº¯æ•°å­—ä½†æ ¼å¼ä¸å¯¹ï¼Œå¯èƒ½æ˜¯å…¶ä»–é—®é¢˜
            rowData.phone_original = rowData.phone;
            rowData.phone = null;
            repaired = true;
        }
    }
    
    // å°è¯•ä¿®å¤æ—¥æœŸæ ¼å¼
    if (rowData.birth_date && !isValidDate(rowData.birth_date)) {
        // å°è¯•å¸¸è§çš„æ—¥æœŸæ ¼å¼è½¬æ¢
        var dateFormats = ["YYYY-MM-DD", "YYYY/MM/DD", "MM/DD/YYYY"];
        for (var i = 0; i < dateFormats.length; i++) {
            var parsed = parseDate(rowData.birth_date, dateFormats[i]);
            if (parsed) {
                rowData.birth_date = formatDate(parsed);
                repaired = true;
                break;
            }
        }
    }
    
    return repaired;
}

// åº”ç”¨ä¿®å¤é€»è¾‘
if (!validateData(rowData)) {
    var fixed = attemptDataRepair(rowData);
    if (fixed) {
        console.info("æ•°æ®å·²è‡ªåŠ¨ä¿®å¤");
    } else {
        console.warn("æ•°æ®æ— æ³•ä¿®å¤ï¼Œéœ€è¦äººå·¥å¤„ç†");
        rowData.needs_manual_review = true;
    }
}
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 å˜æ¢æ€§èƒ½ä¼˜åŒ–


**æ€§èƒ½ä¼˜åŒ–åŸåˆ™**ï¼š
```
ä¼˜åŒ–ç»´åº¦ï¼š
â”œâ”€ è„šæœ¬æ‰§è¡Œæ•ˆç‡ï¼šå‡å°‘å¤æ‚è®¡ç®—å’Œå¾ªç¯
â”œâ”€ å†…å­˜ä½¿ç”¨ï¼šé¿å…å¤§å¯¹è±¡åˆ›å»ºå’Œå†…å­˜æ³„æ¼
â”œâ”€ å¤–éƒ¨è°ƒç”¨ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢å’ŒHTTPè¯·æ±‚
â”œâ”€ æ‰¹å¤„ç†ï¼šæ‰¹é‡å¤„ç†å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
â””â”€ ç¼“å­˜æœºåˆ¶ï¼šç¼“å­˜è®¡ç®—ç»“æœå’ŒæŸ¥è¯¢ç»“æœ
```

### 7.2 è„šæœ¬ä¼˜åŒ–æŠ€å·§


**ğŸ”¸ é¿å…é‡å¤è®¡ç®—**ï¼š
```javascript
// ä¸æ¨èï¼šé‡å¤è®¡ç®—
for (var i = 0; i < rowData.items.length; i++) {
    if (calculateTax(rowData.items[i].price) > 10) {
        // å¤„ç†é€»è¾‘
    }
}

// æ¨èï¼šç¼“å­˜è®¡ç®—ç»“æœ
var taxCache = {};
for (var i = 0; i < rowData.items.length; i++) {
    var price = rowData.items[i].price;
    if (!taxCache[price]) {
        taxCache[price] = calculateTax(price);
    }
    if (taxCache[price] > 10) {
        // å¤„ç†é€»è¾‘
    }
}
```

**ğŸ”¸ å‡å°‘å¯¹è±¡åˆ›å»º**ï¼š
```javascript
// ä¸æ¨èï¼šé¢‘ç¹åˆ›å»ºDateå¯¹è±¡
function formatTimestamp(timestamp) {
    return new Date(timestamp).toISOString();
}

// æ¨èï¼šå¤ç”¨Dateå¯¹è±¡
var dateFormatter = new Date();
function formatTimestamp(timestamp) {
    dateFormatter.setTime(timestamp);
    return dateFormatter.toISOString();
}
```

**ğŸ”¸ ä¼˜åŒ–å­—ç¬¦ä¸²æ“ä½œ**ï¼š
```javascript
// ä¸æ¨èï¼šå­—ç¬¦ä¸²æ‹¼æ¥
var result = "";
for (var i = 0; i < items.length; i++) {
    result += items[i] + ",";
}

// æ¨èï¼šä½¿ç”¨æ•°ç»„join
var parts = [];
for (var i = 0; i < items.length; i++) {
    parts.push(items[i]);
}
var result = parts.join(",");
```

### 7.3 æ‰¹å¤„ç†ä¼˜åŒ–


**æ‰¹å¤„ç†ç­–ç•¥**ï¼š
```javascript
// æ‰¹é‡æ•°æ®éªŒè¯
function batchValidateData(dataList) {
    var validData = [];
    var invalidData = [];
    
    for (var i = 0; i < dataList.length; i++) {
        var data = dataList[i];
        try {
            validateData(data);
            validData.push(data);
        } catch (error) {
            invalidData.push({
                data: data,
                error: error.message
            });
        }
    }
    
    // æ‰¹é‡è®°å½•æ— æ•ˆæ•°æ®
    if (invalidData.length > 0) {
        logInvalidData(invalidData);
    }
    
    return validData;
}
```

### 7.4 å˜æ¢è§„åˆ™ç®¡ç†


**è§„åˆ™é…ç½®ç®¡ç†**ï¼š
```xml
<!-- transform-rules.xml -->
<transform-rules>
    <!-- ç”¨æˆ·æ•°æ®å˜æ¢è§„åˆ™ -->
    <rule name="user-data-transform" table="users">
        <script src="user-transform.js" />
        <cache enabled="true" size="1000" ttl="300" />
        <validation strict="false" />
    </rule>
    
    <!-- è®¢å•æ•°æ®å˜æ¢è§„åˆ™ -->
    <rule name="order-data-transform" table="orders">
        <script src="order-transform.js" />
        <batch-size>100</batch-size>
        <timeout>5000</timeout>
    </rule>
</transform-rules>
```

**è§„åˆ™çƒ­æ›´æ–°æœºåˆ¶**ï¼š
```java
// ä¼ªä»£ç ï¼šè§„åˆ™ç®¡ç†å™¨
public class TransformRuleManager {
    
    private Map<String, TransformRule> rules = new ConcurrentHashMap<>();
    
    // çƒ­æ›´æ–°è§„åˆ™
    public void updateRule(String tableName, String scriptContent) {
        TransformRule rule = new TransformRule(tableName, scriptContent);
        
        // ç¼–è¯‘éªŒè¯è„šæœ¬
        if (validateScript(scriptContent)) {
            rules.put(tableName, rule);
            log.info("è§„åˆ™æ›´æ–°æˆåŠŸ: " + tableName);
        } else {
            throw new IllegalArgumentException("è„šæœ¬éªŒè¯å¤±è´¥");
        }
    }
    
    // è·å–è§„åˆ™
    public TransformRule getRule(String tableName) {
        return rules.get(tableName);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•°æ®å˜æ¢æœ¬è´¨ï¼šETLè¿‡ç¨‹ä¸­çš„T(Transform)ç¯èŠ‚ï¼Œæ•°æ®åŠ å·¥å¤„ç†
ğŸ”¸ Transformæœºåˆ¶ï¼šOtteræ ¸å¿ƒç»„ä»¶ï¼Œæ”¯æŒå­—æ®µæ˜ å°„å’Œè„šæœ¬å¤„ç†
ğŸ”¸ JavaScriptå¼•æ“ï¼šåŸºäºRhinoçš„è„šæœ¬æ‰§è¡Œç¯å¢ƒï¼Œæ”¯æŒJavaäº’æ“ä½œ
ğŸ”¸ æ•°æ®æ¸…æ´—ï¼šæ ¼å¼ç»Ÿä¸€ã€å¼‚å¸¸å¤„ç†ã€ç©ºå€¼å¤„ç†ã€æ•°æ®éªŒè¯
ğŸ”¸ ä¸šåŠ¡é€»è¾‘ï¼šçŠ¶æ€è½¬æ¢ã€è®¡ç®—å­—æ®µã€æ•°æ®è„±æ•ã€ä¸šåŠ¡è§„åˆ™
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ•°æ®å˜æ¢çš„ä»·å€¼**
```
è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š
âœ… ç³»ç»Ÿå¼‚æ„ï¼šä¸åŒç³»ç»Ÿé—´æ ¼å¼ä¸ç»Ÿä¸€
âœ… ä¸šåŠ¡éœ€æ±‚ï¼šç›®æ ‡ç«¯éœ€è¦é¢å¤–çš„ä¸šåŠ¡å¤„ç†  
âœ… æ•°æ®è´¨é‡ï¼šæ¸…æ´—è„æ•°æ®ï¼Œä¿è¯æ•°æ®è´¨é‡
âœ… å®‰å…¨åˆè§„ï¼šæ•æ„Ÿæ•°æ®è„±æ•ï¼Œæ»¡è¶³åˆè§„è¦æ±‚

å˜æ¢çš„æ—¶æœºé€‰æ‹©ï¼š
â”œâ”€ å®æ—¶å˜æ¢ï¼šæ•°æ®åŒæ­¥è¿‡ç¨‹ä¸­å®æ—¶å¤„ç†
â”œâ”€ æ‰¹é‡å˜æ¢ï¼šå®šæœŸæ‰¹é‡å¤„ç†å†å²æ•°æ®
â””â”€ æ··åˆæ¨¡å¼ï¼šå®æ—¶+æ‰¹é‡ç›¸ç»“åˆ
```

**ğŸ”¹ æ€§èƒ½å’Œç¨³å®šæ€§å¹³è¡¡**
```
æ€§èƒ½è€ƒè™‘ï¼š
â”œâ”€ è„šæœ¬å¤æ‚åº¦ï¼šé¿å…è¿‡äºå¤æ‚çš„å¤„ç†é€»è¾‘
â”œâ”€ å¤–éƒ¨ä¾èµ–ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢å’Œç½‘ç»œè°ƒç”¨
â”œâ”€ å†…å­˜ç®¡ç†ï¼šé¿å…å†…å­˜æ³„æ¼å’Œå¤§å¯¹è±¡åˆ›å»º
â””â”€ é”™è¯¯å¤„ç†ï¼šåˆç†çš„é”™è¯¯æ¢å¤å’Œé™çº§ç­–ç•¥

ç¨³å®šæ€§ä¿éšœï¼š
â”œâ”€ æ•°æ®éªŒè¯ï¼šä¸¥æ ¼çš„æ•°æ®æ ¼å¼å’Œä¸šåŠ¡è§„åˆ™éªŒè¯
â”œâ”€ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•  
â”œâ”€ å›æ»šæœºåˆ¶ï¼šæ”¯æŒæ•°æ®å˜æ¢çš„å›æ»šå’Œé‡è¯•
â””â”€ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§å˜æ¢æ€§èƒ½å’Œé”™è¯¯ç‡
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ å˜æ¢è§„åˆ™è®¾è®¡åŸåˆ™**
```sql
-- 1. ä¿æŒå¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´
-- 2. å¤„ç†è¾¹ç•Œæƒ…å†µï¼šNULLå€¼ã€ç©ºå­—ç¬¦ä¸²ã€å¼‚å¸¸æ•°æ®
-- 3. è®°å½•å¤„ç†è½¨è¿¹ï¼šä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ•°æ®è¿½æº¯
-- 4. æ¨¡å—åŒ–è®¾è®¡ï¼šå°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºç‹¬ç«‹å‡½æ•°
```

**ğŸ”¸ å…¸å‹é…ç½®æ¨¡å¼**
```javascript
// å®Œæ•´çš„å˜æ¢è„šæœ¬æ¨¡æ¿
(function() {
    try {
        // 1. æ•°æ®é¢„å¤„ç†
        preprocessData(rowData);
        
        // 2. ä¸šåŠ¡é€»è¾‘å¤„ç†
        processBusinessLogic(rowData);
        
        // 3. æ•°æ®éªŒè¯
        validateResult(rowData);
        
        // 4. è®¾ç½®å¤„ç†çŠ¶æ€
        rowData.transform_status = "success";
        rowData.transform_time = new Date().toISOString();
        
    } catch (error) {
        // é”™è¯¯å¤„ç†
        rowData.transform_status = "failed";
        rowData.transform_error = error.message;
        
        // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦æŠ›å‡ºå¼‚å¸¸
        if (isCriticalError(error)) {
            throw error;
        }
    }
})();
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ•°æ®å˜æ¢æ˜¯ETLçš„æ ¸å¿ƒç¯èŠ‚ï¼Œè´Ÿè´£æ•°æ®åŠ å·¥å¤„ç†
- JavaScriptè„šæœ¬æä¾›çµæ´»çš„æ•°æ®å¤„ç†èƒ½åŠ›
- æ•°æ®æ¸…æ´—å’ŒéªŒè¯æ˜¯ä¿è¯æ•°æ®è´¨é‡çš„å…³é”®
- æ€§èƒ½ä¼˜åŒ–è¦å¹³è¡¡å¤„ç†æ•ˆç‡å’Œç³»ç»Ÿç¨³å®šæ€§
- å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡æ¡ä»¶