---
title: 16ã€ç›‘æ§ä¸å‘Šè­¦é…ç½®
---
## ğŸ“š ç›®å½•


1. [Otterç›‘æ§ä½“ç³»æ¦‚è¿°](#1-otterç›‘æ§ä½“ç³»æ¦‚è¿°)
2. [åŒæ­¥çŠ¶æ€ç›‘æ§](#2-åŒæ­¥çŠ¶æ€ç›‘æ§)
3. [æ€§èƒ½æŒ‡æ ‡ç›‘æ§](#3-æ€§èƒ½æŒ‡æ ‡ç›‘æ§)
4. [JMXç›‘æ§æ¥å£](#4-jmxç›‘æ§æ¥å£)
5. [å‘Šè­¦è§„åˆ™é…ç½®](#5-å‘Šè­¦è§„åˆ™é…ç½®)
6. [å‘Šè­¦æ¸ é“é…ç½®](#6-å‘Šè­¦æ¸ é“é…ç½®)
7. [ç›‘æ§å¤§ç›˜é…ç½®](#7-ç›‘æ§å¤§ç›˜é…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š Otterç›‘æ§ä½“ç³»æ¦‚è¿°



### 1.1 ç›‘æ§çš„é‡è¦æ€§



**ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Ÿ**
```
æ•°æ®åŒæ­¥åœºæ™¯çš„é£é™©ï¼š
â€¢ æºåº“æ•°æ®å˜æ›´ â†’ ç›®æ ‡åº“å»¶è¿Ÿæ›´æ–° â†’ ä¸šåŠ¡è¯»å–åˆ°æ—§æ•°æ®
â€¢ ç½‘ç»œä¸­æ–­ â†’ åŒæ­¥ä¸­æ–­ â†’ æ•°æ®ä¸ä¸€è‡´
â€¢ èŠ‚ç‚¹æ•…éšœ â†’ æœåŠ¡åœæ­¢ â†’ ä¸šåŠ¡å—å½±å“

ç›‘æ§èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
âœ… åŠæ—¶å‘ç°åŒæ­¥å¼‚å¸¸
âœ… æå‰é¢„è­¦æ½œåœ¨é—®é¢˜  
âœ… å¿«é€Ÿå®šä½æ•…éšœåŸå› 
âœ… ä¿éšœæ•°æ®ä¸€è‡´æ€§
```

### 1.2 Otterç›‘æ§æ¶æ„



```
æ•°æ®åŒæ­¥ç›‘æ§ä½“ç³»æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æºæ•°æ®åº“       â”‚    â”‚   Otteré›†ç¾¤     â”‚    â”‚   ç›®æ ‡æ•°æ®åº“     â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Binlogç›‘æ§  â”‚ â”‚    â”‚ â”‚ èŠ‚ç‚¹ç›‘æ§    â”‚ â”‚    â”‚ â”‚ å†™å…¥ç›‘æ§    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚         â”‚         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚      ç›‘æ§ä¸­å¿ƒ              â”‚
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚ â”‚    æŒ‡æ ‡æ”¶é›†ä¸å­˜å‚¨        â”‚ â”‚
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚ â”‚    å‘Šè­¦è§„åˆ™å¼•æ“          â”‚ â”‚
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                  â”‚ â”‚    å¯è§†åŒ–ç›‘æ§å¤§ç›˜        â”‚ â”‚
                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç›‘æ§æŒ‡æ ‡åˆ†ç±»



**æ ¸å¿ƒç›‘æ§ç»´åº¦**
```
ğŸ”¸ åŒæ­¥çŠ¶æ€ç›‘æ§
â€¢ åŒæ­¥å»¶è¿Ÿæ—¶é—´
â€¢ åŒæ­¥æˆåŠŸç‡
â€¢ é”™è¯¯æ¬¡æ•°ç»Ÿè®¡
â€¢ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

ğŸ”¸ æ€§èƒ½æŒ‡æ ‡ç›‘æ§  
â€¢ åŒæ­¥ååé‡ï¼ˆTPSï¼‰
â€¢ ç½‘ç»œå»¶è¿Ÿ
â€¢ å†…å­˜ä½¿ç”¨ç‡
â€¢ CPUä½¿ç”¨ç‡

ğŸ”¸ èŠ‚ç‚¹å¥åº·ç›‘æ§
â€¢ èŠ‚ç‚¹å­˜æ´»çŠ¶æ€
â€¢ æœåŠ¡è¿›ç¨‹çŠ¶æ€
â€¢ è¿æ¥æ± çŠ¶æ€
â€¢ ç£ç›˜ç©ºé—´ä½¿ç”¨
```

---

## 2. ğŸ¯ åŒæ­¥çŠ¶æ€ç›‘æ§



### 2.1 å»¶è¿Ÿç›‘æ§æŒ‡æ ‡



**ä»€ä¹ˆæ˜¯åŒæ­¥å»¶è¿Ÿï¼Ÿ**
```
å»¶è¿Ÿå®šä¹‰ï¼šä»æºåº“æ•°æ®å˜æ›´åˆ°ç›®æ ‡åº“å®ŒæˆåŒæ­¥çš„æ—¶é—´å·®

å»¶è¿Ÿäº§ç”Ÿçš„åŸå› ï¼š
â€¢ ç½‘ç»œä¼ è¾“æ—¶é—´
â€¢ Otterå¤„ç†æ—¶é—´  
â€¢ ç›®æ ‡åº“å†™å…¥æ—¶é—´
â€¢ ç³»ç»Ÿè´Ÿè½½å½±å“

å»¶è¿Ÿçš„å½±å“ï¼š
âŒ ä¸šåŠ¡è¯»å–åˆ°è¿‡æœŸæ•°æ®
âŒ æ•°æ®ä¸€è‡´æ€§é—®é¢˜
âŒ ç”¨æˆ·ä½“éªŒä¸‹é™
```

**å»¶è¿Ÿç›‘æ§é…ç½®**
```yaml
# å»¶è¿Ÿç›‘æ§é…ç½®

delay_monitoring:
#  # å»¶è¿Ÿé˜ˆå€¼è®¾ç½®
  warning_threshold: 30    # 30ç§’å‘Šè­¦
  critical_threshold: 300  # 5åˆ†é’Ÿä¸¥é‡å‘Šè­¦
  
#  # ç›‘æ§é¢‘ç‡
  check_interval: 10       # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
  
#  # å»¶è¿Ÿè®¡ç®—æ–¹å¼
  calculation_method: "max_delay"  # å–æœ€å¤§å»¶è¿Ÿå€¼
```

### 2.2 é”™è¯¯æ¬¡æ•°ç»Ÿè®¡



**é”™è¯¯ç±»å‹åˆ†ç±»**
```
ğŸ”¸ è¿æ¥é”™è¯¯
â€¢ æ•°æ®åº“è¿æ¥å¤±è´¥
â€¢ ç½‘ç»œè¿æ¥è¶…æ—¶
â€¢ è®¤è¯å¤±è´¥

ğŸ”¸ æ•°æ®é”™è¯¯
â€¢ SQLæ‰§è¡Œå¤±è´¥
â€¢ æ•°æ®æ ¼å¼é”™è¯¯
â€¢ çº¦æŸå†²çª

ğŸ”¸ ç³»ç»Ÿé”™è¯¯  
â€¢ å†…å­˜ä¸è¶³
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³
â€¢ æœåŠ¡è¿›ç¨‹å¼‚å¸¸
```

**é”™è¯¯ç›‘æ§å®ç°**
```java
// é”™è¯¯ç»Ÿè®¡é…ç½®
public class ErrorMonitoring {
    
    // é”™è¯¯è®¡æ•°å™¨
    private final Map<String, AtomicLong> errorCounters = new HashMap<>();
    
    // è®°å½•é”™è¯¯
    public void recordError(String errorType, String message) {
        // å¢åŠ é”™è¯¯è®¡æ•°
        errorCounters.computeIfAbsent(errorType, k -> new AtomicLong(0))
                     .incrementAndGet();
        
        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°å‘Šè­¦é˜ˆå€¼
        checkAlertThreshold(errorType);
        
        // è®°å½•é”™è¯¯è¯¦æƒ…
        logErrorDetails(errorType, message);
    }
    
    // æ£€æŸ¥å‘Šè­¦é˜ˆå€¼
    private void checkAlertThreshold(String errorType) {
        long errorCount = errorCounters.get(errorType).get();
        
        // 5åˆ†é’Ÿå†…é”™è¯¯è¶…è¿‡10æ¬¡è§¦å‘å‘Šè­¦
        if (errorCount > 10) {
            sendAlert("é”™è¯¯é¢‘ç‡è¿‡é«˜", errorType + " é”™è¯¯æ¬¡æ•°: " + errorCount);
        }
    }
}
```

### 2.3 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥



**ä¸€è‡´æ€§æ£€æŸ¥åŸç†**
```
æ£€æŸ¥æ–¹å¼ï¼š
1ï¸âƒ£ è¡Œæ•°å¯¹æ¯”ï¼šsource_count vs target_count
2ï¸âƒ£ æ ¡éªŒå’Œå¯¹æ¯”ï¼šsource_checksum vs target_checksum  
3ï¸âƒ£ æŠ½æ ·å¯¹æ¯”ï¼šéšæœºæŠ½å–æ•°æ®é€æ¡æ¯”è¾ƒ

æ£€æŸ¥æ—¶æœºï¼š
â€¢ å®šæ—¶æ£€æŸ¥ï¼ˆå¦‚æ¯å°æ—¶ä¸€æ¬¡ï¼‰
â€¢ åŒæ­¥å®Œæˆåæ£€æŸ¥
â€¢ æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
```

**ä¸€è‡´æ€§æ£€æŸ¥é…ç½®**
```sql
-- åˆ›å»ºä¸€è‡´æ€§æ£€æŸ¥è¡¨
CREATE TABLE data_consistency_check (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(100) NOT NULL,
    source_count BIGINT NOT NULL,
    target_count BIGINT NOT NULL,
    source_checksum VARCHAR(32),
    target_checksum VARCHAR(32),
    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('PASS', 'FAIL') NOT NULL,
    INDEX idx_table_time (table_name, check_time)
);
```

---

## 3. âš¡ æ€§èƒ½æŒ‡æ ‡ç›‘æ§



### 3.1 åŒæ­¥ååé‡ç›‘æ§



**ååé‡çš„å«ä¹‰**
```
TPS (Transactions Per Second)ï¼šæ¯ç§’å¤„ç†çš„äº‹åŠ¡æ•°
â€¢ è¡¡é‡Otterçš„å¤„ç†èƒ½åŠ›
â€¢ åæ˜ ç³»ç»Ÿè´Ÿè½½æƒ…å†µ
â€¢ å¸®åŠ©å®¹é‡è§„åˆ’

å½±å“ååé‡çš„å› ç´ ï¼š
â€¢ ç¡¬ä»¶é…ç½®ï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œï¼‰
â€¢ æ•°æ®åº“æ€§èƒ½
â€¢ åŒæ­¥è¡¨ç»“æ„å¤æ‚åº¦
â€¢ å¹¶å‘åŒæ­¥ä»»åŠ¡æ•°é‡
```

**ååé‡ç›‘æ§å®ç°**
```java
// TPSç»Ÿè®¡å™¨
public class ThroughputMonitor {
    
    private final AtomicLong processedCount = new AtomicLong(0);
    private final long startTime = System.currentTimeMillis();
    
    // è®°å½•å¤„ç†çš„è®°å½•æ•°
    public void recordProcessed(int count) {
        processedCount.addAndGet(count);
    }
    
    // è®¡ç®—å½“å‰TPS
    public double getCurrentTPS() {
        long elapsed = System.currentTimeMillis() - startTime;
        return processedCount.get() * 1000.0 / elapsed;
    }
    
    // è·å–ç›‘æ§æŒ‡æ ‡
    public MonitorMetrics getMetrics() {
        return MonitorMetrics.builder()
                .tps(getCurrentTPS())
                .totalProcessed(processedCount.get())
                .uptime(System.currentTimeMillis() - startTime)
                .build();
    }
}
```

### 3.2 èŠ‚ç‚¹å¥åº·æ£€æŸ¥



**å¥åº·æ£€æŸ¥ç»´åº¦**
```
ğŸ”¸ è¿›ç¨‹çŠ¶æ€
â€¢ Otterè¿›ç¨‹æ˜¯å¦è¿è¡Œ
â€¢ è¿›ç¨‹CPUä½¿ç”¨ç‡
â€¢ è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡

ğŸ”¸ æœåŠ¡çŠ¶æ€
â€¢ HTTPæ¥å£å“åº”
â€¢ æ•°æ®åº“è¿æ¥çŠ¶æ€
â€¢ åŒæ­¥ä»»åŠ¡è¿è¡ŒçŠ¶æ€

ğŸ”¸ ç³»ç»Ÿèµ„æº
â€¢ æœåŠ¡å™¨CPUä½¿ç”¨ç‡
â€¢ å†…å­˜ä½¿ç”¨ç‡  
â€¢ ç£ç›˜ä½¿ç”¨ç‡
â€¢ ç½‘ç»œè¿æ¥çŠ¶æ€
```

**å¥åº·æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash

# OtterèŠ‚ç‚¹å¥åº·æ£€æŸ¥è„šæœ¬


check_otter_health() {
    local node_id=$1
    local result=""
    
#    # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
    if pgrep -f "otter.node" > /dev/null; then
        result="${result}âœ… Otterè¿›ç¨‹è¿è¡Œæ­£å¸¸\n"
    else
        result="${result}âŒ Otterè¿›ç¨‹æœªè¿è¡Œ\n"
        return 1
    fi
    
#    # æ£€æŸ¥HTTPæ¥å£
    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
        result="${result}âœ… HTTPæ¥å£æ­£å¸¸\n"
    else
        result="${result}âŒ HTTPæ¥å£å¼‚å¸¸\n"
    fi
    
#    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    memory_usage=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
    if (( $(echo "$memory_usage > 80" | bc -l) )); then
        result="${result}âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${memory_usage}%\n"
    else
        result="${result}âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸: ${memory_usage}%\n"
    fi
    
    echo -e "$result"
}

# æ‰§è¡Œæ£€æŸ¥

check_otter_health "node-1"
```

---

## 4. ğŸ“¡ JMXç›‘æ§æ¥å£



### 4.1 JMXç›‘æ§åŸç†



**ä»€ä¹ˆæ˜¯JMXï¼Ÿ**
```
JMX (Java Management Extensions)ï¼šJavaç®¡ç†æ‰©å±•
â€¢ Javaå¹³å°çš„æ ‡å‡†ç›‘æ§æŠ€æœ¯
â€¢ æä¾›åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶ä¿¡æ¯
â€¢ æ”¯æŒè¿œç¨‹ç›‘æ§å’Œç®¡ç†

Otterä¸­çš„JMXåº”ç”¨ï¼š
â€¢ æš´éœ²å†…éƒ¨è¿è¡ŒæŒ‡æ ‡
â€¢ æä¾›è¿œç¨‹ç›‘æ§æ¥å£
â€¢ æ”¯æŒç¬¬ä¸‰æ–¹ç›‘æ§ç³»ç»Ÿé›†æˆ
```

### 4.2 JMXé…ç½®ä¸ä½¿ç”¨



**å¯ç”¨JMXç›‘æ§**
```bash
# Otterå¯åŠ¨æ—¶æ·»åŠ JMXå‚æ•°

JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote"
JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.port=9999"
JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.authenticate=false"
JAVA_OPTS="$JAVA_OPTS -Dcom.sun.management.jmxremote.ssl=false"

# å¯åŠ¨Otter

java $JAVA_OPTS -jar otter-node.jar
```

**JMXæŒ‡æ ‡è·å–**
```java
// JMXå®¢æˆ·ç«¯è¿æ¥ç¤ºä¾‹
public class OtterJMXMonitor {
    
    private MBeanServerConnection connection;
    
    public void connect(String host, int port) throws Exception {
        String url = "service:jmx:rmi:///jndi/rmi://" + host + ":" + port + "/jmxrmi";
        JMXServiceURL serviceURL = new JMXServiceURL(url);
        JMXConnector connector = JMXConnectorFactory.connect(serviceURL);
        connection = connector.getMBeanServerConnection();
    }
    
    // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
    public MemoryUsage getHeapMemoryUsage() throws Exception {
        ObjectName objectName = new ObjectName("java.lang:type=Memory");
        CompositeData heapMemory = (CompositeData) connection.getAttribute(objectName, "HeapMemoryUsage");
        return MemoryUsage.from(heapMemory);
    }
    
    // è·å–åŒæ­¥å»¶è¿Ÿ
    public long getSyncDelay() throws Exception {
        ObjectName objectName = new ObjectName("com.alibaba.otter:type=SyncMonitor");
        return (Long) connection.getAttribute(objectName, "MaxDelay");
    }
}
```

### 4.3 å¸¸ç”¨JMXæŒ‡æ ‡



**æ ¸å¿ƒJMXæŒ‡æ ‡è¡¨**

| æŒ‡æ ‡ç±»åˆ« | **MBeanå¯¹è±¡** | **å±æ€§åç§°** | **è¯´æ˜** |
|---------|-------------|-------------|---------|
| ğŸ”¸ **å†…å­˜ç›‘æ§** | `java.lang:type=Memory` | `HeapMemoryUsage` | `JVMå †å†…å­˜ä½¿ç”¨æƒ…å†µ` |
| ğŸ”¸ **åƒåœ¾å›æ”¶** | `java.lang:type=GarbageCollector` | `CollectionCount` | `GCæ‰§è¡Œæ¬¡æ•°` |
| ğŸ”¸ **çº¿ç¨‹ç›‘æ§** | `java.lang:type=Threading` | `ThreadCount` | `å½“å‰çº¿ç¨‹æ•°é‡` |
| ğŸ”¸ **åŒæ­¥å»¶è¿Ÿ** | `com.alibaba.otter:type=Sync` | `DelayTime` | `åŒæ­¥å»¶è¿Ÿæ—¶é—´` |
| ğŸ”¸ **å¤„ç†é€Ÿåº¦** | `com.alibaba.otter:type=Pipeline` | `ThroughputTPS` | `æ¯ç§’å¤„ç†äº‹åŠ¡æ•°` |

---

## 5. ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®



### 5.1 å‘Šè­¦è§„åˆ™è®¾è®¡



**å‘Šè­¦çº§åˆ«åˆ†ç±»**
```
ğŸŸ¢ INFO (ä¿¡æ¯)
â€¢ ç³»ç»Ÿå¯åŠ¨/åœæ­¢
â€¢ é…ç½®å˜æ›´
â€¢ å®šæ—¶ä»»åŠ¡æ‰§è¡Œ

ğŸŸ¡ WARNING (è­¦å‘Š)  
â€¢ å»¶è¿Ÿè¶…è¿‡30ç§’
â€¢ é”™è¯¯ç‡è¶…è¿‡1%
â€¢ å†…å­˜ä½¿ç”¨è¶…è¿‡70%

ğŸ”´ CRITICAL (ä¸¥é‡)
â€¢ å»¶è¿Ÿè¶…è¿‡5åˆ†é’Ÿ
â€¢ åŒæ­¥ä¸­æ–­
â€¢ èŠ‚ç‚¹ä¸å¯ç”¨
â€¢ æ•°æ®ä¸ä¸€è‡´
```

**å‘Šè­¦è§„åˆ™é…ç½®**
```yaml
# alert_rules.yml

alert_rules:
#  # å»¶è¿Ÿå‘Šè­¦
  - name: "sync_delay_warning"
    level: "WARNING" 
    condition: "sync_delay > 30"
    message: "åŒæ­¥å»¶è¿Ÿè¶…è¿‡30ç§’ï¼Œå½“å‰å»¶è¿Ÿ: {{delay}}ç§’"
    
  - name: "sync_delay_critical"
    level: "CRITICAL"
    condition: "sync_delay > 300"
    message: "åŒæ­¥å»¶è¿Ÿä¸¥é‡ï¼Œè¶…è¿‡5åˆ†é’Ÿï¼Œå½“å‰å»¶è¿Ÿ: {{delay}}ç§’"
    
#  # é”™è¯¯ç‡å‘Šè­¦
  - name: "error_rate_high"
    level: "WARNING"
    condition: "error_rate > 0.01"
    message: "é”™è¯¯ç‡è¿‡é«˜: {{error_rate}}%"
    
#  # èŠ‚ç‚¹çŠ¶æ€å‘Šè­¦
  - name: "node_offline"
    level: "CRITICAL" 
    condition: "node_status == 'OFFLINE'"
    message: "èŠ‚ç‚¹{{node_id}}ç¦»çº¿"
```

### 5.2 å‘Šè­¦è§„åˆ™å¼•æ“



**è§„åˆ™å¼•æ“å®ç°**
```java
// å‘Šè­¦è§„åˆ™å¼•æ“
public class AlertRuleEngine {
    
    private final List<AlertRule> rules = new ArrayList<>();
    private final AlertSender alertSender;
    
    // æ·»åŠ è§„åˆ™
    public void addRule(AlertRule rule) {
        rules.add(rule);
    }
    
    // è¯„ä¼°æ‰€æœ‰è§„åˆ™
    public void evaluateRules(MonitorData data) {
        for (AlertRule rule : rules) {
            if (rule.evaluate(data)) {
                // è§„åˆ™åŒ¹é…ï¼Œå‘é€å‘Šè­¦
                Alert alert = Alert.builder()
                    .level(rule.getLevel())
                    .message(rule.formatMessage(data))
                    .timestamp(System.currentTimeMillis())
                    .build();
                    
                alertSender.sendAlert(alert);
            }
        }
    }
}

// å‘Šè­¦è§„åˆ™å®šä¹‰
public class AlertRule {
    private String name;
    private AlertLevel level;
    private String condition;  // å¦‚ "sync_delay > 30"
    private String messageTemplate;
    
    // è¯„ä¼°è§„åˆ™æ˜¯å¦åŒ¹é…
    public boolean evaluate(MonitorData data) {
        // è§£ææ¡ä»¶è¡¨è¾¾å¼
        return ExpressionEvaluator.evaluate(condition, data);
    }
    
    // æ ¼å¼åŒ–å‘Šè­¦æ¶ˆæ¯
    public String formatMessage(MonitorData data) {
        return TemplateEngine.format(messageTemplate, data);
    }
}
```

---

## 6. ğŸ“¨ å‘Šè­¦æ¸ é“é…ç½®



### 6.1 é‚®ä»¶å‘Šè­¦è®¾ç½®



**é‚®ä»¶å‘Šè­¦é…ç½®**
```properties
# é‚®ä»¶æœåŠ¡å™¨é…ç½®

mail.smtp.host=smtp.company.com
mail.smtp.port=25
mail.smtp.auth=true
mail.smtp.username=monitor@company.com
mail.smtp.password=your_password

# å‘Šè­¦é‚®ä»¶é…ç½®

alert.mail.enabled=true
alert.mail.from=monitor@company.com
alert.mail.to=admin@company.com,dba@company.com
alert.mail.subject.prefix=[Otterå‘Šè­¦]
```

**é‚®ä»¶å‘é€å®ç°**
```java
// é‚®ä»¶å‘Šè­¦å‘é€å™¨
public class EmailAlertSender implements AlertSender {
    
    private final JavaMailSender mailSender;
    private final String fromAddress;
    private final List<String> toAddresses;
    
    @Override
    public void sendAlert(Alert alert) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true);
            
            helper.setFrom(fromAddress);
            helper.setTo(toAddresses.toArray(new String[0]));
            helper.setSubject("[Otterå‘Šè­¦] " + alert.getLevel() + " - " + alert.getTitle());
            
            // æ„å»ºHTMLé‚®ä»¶å†…å®¹
            String htmlContent = buildHtmlContent(alert);
            helper.setText(htmlContent, true);
            
            mailSender.send(message);
            
        } catch (Exception e) {
            logger.error("å‘é€é‚®ä»¶å‘Šè­¦å¤±è´¥", e);
        }
    }
    
    private String buildHtmlContent(Alert alert) {
        return """
            <html>
            <body>
                <h2 style="color: %s">%s</h2>
                <p><strong>æ—¶é—´:</strong> %s</p>
                <p><strong>çº§åˆ«:</strong> %s</p>
                <p><strong>æ¶ˆæ¯:</strong> %s</p>
                <p><strong>è¯¦æƒ…:</strong> %s</p>
            </body>
            </html>
            """.formatted(
                getColorByLevel(alert.getLevel()),
                alert.getTitle(),
                formatTime(alert.getTimestamp()),
                alert.getLevel(),
                alert.getMessage(),
                alert.getDetails()
            );
    }
}
```

### 6.2 é’‰é’‰å‘Šè­¦é›†æˆ



**é’‰é’‰Webhooké…ç½®**
```java
// é’‰é’‰å‘Šè­¦å‘é€å™¨
public class DingTalkAlertSender implements AlertSender {
    
    private final String webhookUrl;
    private final RestTemplate restTemplate;
    
    @Override
    public void sendAlert(Alert alert) {
        try {
            // æ„å»ºé’‰é’‰æ¶ˆæ¯æ ¼å¼
            DingTalkMessage message = DingTalkMessage.builder()
                .msgtype("markdown")
                .markdown(DingTalkMarkdown.builder()
                    .title("OtteråŒæ­¥å‘Šè­¦")
                    .text(buildMarkdownText(alert))
                    .build())
                .build();
            
            // å‘é€åˆ°é’‰é’‰
            restTemplate.postForObject(webhookUrl, message, String.class);
            
        } catch (Exception e) {
            logger.error("å‘é€é’‰é’‰å‘Šè­¦å¤±è´¥", e);
        }
    }
    
    private String buildMarkdownText(Alert alert) {
        return String.format("""
#            ## %s ğŸš¨
            
            **å‘Šè­¦çº§åˆ«**: %s
            
            **å‘Šè­¦æ—¶é—´**: %s
            
            **å‘Šè­¦å†…å®¹**: %s
            
            **å¤„ç†å»ºè®®**: %s
            """, 
            alert.getTitle(),
            getLevelEmoji(alert.getLevel()) + alert.getLevel(),
            formatTime(alert.getTimestamp()),
            alert.getMessage(),
            getSuggestion(alert.getType())
        );
    }
}
```

### 6.3 å¤šæ¸ é“å‘Šè­¦ç­–ç•¥



**å‘Šè­¦å‡çº§æœºåˆ¶**
```
å‘Šè­¦å‡çº§ç­–ç•¥ï¼š

1ï¸âƒ£ WARNINGçº§åˆ«
   â†’ é’‰é’‰ç¾¤é€šçŸ¥
   â†’ è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ

2ï¸âƒ£ CRITICALçº§åˆ«  
   â†’ é’‰é’‰ç¾¤é€šçŸ¥ + @ç›¸å…³äººå‘˜
   â†’ å‘é€é‚®ä»¶ç»™ç®¡ç†å‘˜
   â†’ çŸ­ä¿¡é€šçŸ¥å€¼ç­äººå‘˜

3ï¸âƒ£ è¿ç»­å‘Šè­¦
   â†’ 10åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åˆå¹¶
   â†’ 1å°æ—¶åå¦‚æœæœªè§£å†³å‡çº§å¤„ç†
```

---

## 7. ğŸ“ˆ ç›‘æ§å¤§ç›˜é…ç½®



### 7.1 Grafanaå¤§ç›˜è®¾è®¡



**ç›‘æ§å¤§ç›˜å¸ƒå±€**
```
Otterç›‘æ§å¤§ç›˜å¸ƒå±€ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é›†ç¾¤æ€»è§ˆ       â”‚   å®æ—¶åŒæ­¥çŠ¶æ€    â”‚
â”‚                â”‚                â”‚  
â”‚ â€¢ èŠ‚ç‚¹æ•°é‡      â”‚ â€¢ åŒæ­¥å»¶è¿Ÿ      â”‚
â”‚ â€¢ åŒæ­¥ä»»åŠ¡æ•°    â”‚ â€¢ åŒæ­¥é€Ÿåº¦      â”‚
â”‚ â€¢ æ€»ä½“çŠ¶æ€      â”‚ â€¢ é”™è¯¯è®¡æ•°      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ€§èƒ½æŒ‡æ ‡       â”‚   å‘Šè­¦ç»Ÿè®¡      â”‚
â”‚                â”‚                â”‚
â”‚ â€¢ CPUä½¿ç”¨ç‡     â”‚ â€¢ ä»Šæ—¥å‘Šè­¦      â”‚
â”‚ â€¢ å†…å­˜ä½¿ç”¨ç‡    â”‚ â€¢ å‘Šè­¦è¶‹åŠ¿      â”‚
â”‚ â€¢ ç½‘ç»œæµé‡      â”‚ â€¢ å¤„ç†çŠ¶æ€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Grafanaé…ç½®ç¤ºä¾‹**
```json
{
  "dashboard": {
    "title": "Otteræ•°æ®åŒæ­¥ç›‘æ§",
    "panels": [
      {
        "title": "åŒæ­¥å»¶è¿Ÿ",
        "type": "graph",
        "targets": [
          {
            "expr": "otter_sync_delay_seconds",
            "legendFormat": "{{instance}} - {{pipeline}}"
          }
        ],
        "yAxes": [
          {
            "label": "å»¶è¿Ÿæ—¶é—´(ç§’)",
            "min": 0
          }
        ],
        "alert": {
          "conditions": [
            {
              "query": {
                "queryType": "",
                "refId": "A"
              },
              "reducer": {
                "type": "avg",
                "params": []
              },
              "evaluator": {
                "params": [30],
                "type": "gt"
              }
            }
          ],
          "executionErrorState": "alerting",
          "for": "1m",
          "frequency": "10s",
          "handler": 1,
          "name": "åŒæ­¥å»¶è¿Ÿå‘Šè­¦",
          "noDataState": "no_data"
        }
      }
    ]
  }
}
```

### 7.2 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡



**å…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜**

| æŒ‡æ ‡åç§° | **æŒ‡æ ‡ç±»å‹** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** | **å›¾è¡¨ç±»å‹** |
|---------|-------------|-------------|-------------|-------------|
| ğŸ”¸ **åŒæ­¥å»¶è¿Ÿ** | `Gauge` | `< 10ç§’` | `> 30ç§’` | `æ—¶é—´åºåˆ—å›¾` |
| ğŸ”¸ **åŒæ­¥TPS** | `Counter` | `> 100/s` | `< 50/s` | `æŠ˜çº¿å›¾` |
| ğŸ”¸ **é”™è¯¯ç‡** | `Rate` | `< 0.1%` | `> 1%` | `ç™¾åˆ†æ¯”å›¾` |
| ğŸ”¸ **å†…å­˜ä½¿ç”¨** | `Gauge` | `< 70%` | `> 85%` | `ä»ªè¡¨ç›˜` |
| ğŸ”¸ **èŠ‚ç‚¹çŠ¶æ€** | `Enum` | `UP` | `DOWN` | `çŠ¶æ€å›¾` |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 å¿…é¡»æŒæ¡çš„ç›‘æ§è¦ç‚¹



```
ğŸ”¸ ç›‘æ§ä½“ç³»æ„å»ºï¼šè¦†ç›–æ•°æ®åŒæ­¥å…¨é“¾è·¯çš„ç›‘æ§ç‚¹
ğŸ”¸ å…³é”®æŒ‡æ ‡ï¼šåŒæ­¥å»¶è¿Ÿã€é”™è¯¯ç‡ã€ååé‡ã€èŠ‚ç‚¹å¥åº·çŠ¶æ€  
ğŸ”¸ å‘Šè­¦æœºåˆ¶ï¼šåˆ†çº§å‘Šè­¦ã€å¤šæ¸ é“é€šçŸ¥ã€å‡çº§ç­–ç•¥
ğŸ”¸ å¯è§†åŒ–ï¼šç›´è§‚çš„ç›‘æ§å¤§ç›˜ï¼Œä¾¿äºå¿«é€Ÿå‘ç°é—®é¢˜
ğŸ”¸ è‡ªåŠ¨åŒ–ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜å“åº”é€Ÿåº¦
```

### 8.2 ç›‘æ§é…ç½®æœ€ä½³å®è·µ



**ğŸ”¹ ç›‘æ§æŒ‡æ ‡é€‰æ‹©åŸåˆ™**
```
é‡è¦æ€§æ’åºï¼š
1ï¸âƒ£ ä¸šåŠ¡å½±å“ç±»ï¼šåŒæ­¥å»¶è¿Ÿã€æ•°æ®ä¸€è‡´æ€§
2ï¸âƒ£ ç³»ç»Ÿå¥åº·ç±»ï¼šèŠ‚ç‚¹çŠ¶æ€ã€é”™è¯¯ç‡  
3ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–ç±»ï¼šTPSã€èµ„æºä½¿ç”¨ç‡

é¿å…ç›‘æ§è¿‡è½½ï¼š
â€¢ ä¸ç›‘æ§æ— ç”¨æŒ‡æ ‡
â€¢ åˆç†è®¾ç½®é‡‡é›†é¢‘ç‡
â€¢ åŠæ—¶æ¸…ç†å†å²æ•°æ®
```

**ğŸ”¹ å‘Šè­¦è§„åˆ™è®¾è®¡è¦ç‚¹**
```
å‘Šè­¦åŸåˆ™ï¼š
âœ… æœ‰é—®é¢˜å¿…é¡»å‘Šè­¦
âœ… å‘Šè­¦å¿…é¡»å¯å¤„ç†
âœ… é¿å…å‘Šè­¦é£æš´
âœ… åˆ†çº§åˆ†æ¸ é“é€šçŸ¥

é˜ˆå€¼è®¾ç½®ï¼š
â€¢ åŸºäºå†å²æ•°æ®åˆ†æ
â€¢ è€ƒè™‘ä¸šåŠ¡å®¹å¿åº¦
â€¢ é¢„ç•™ç¼“å†²ç©ºé—´
â€¢ å®šæœŸè¯„ä¼°è°ƒæ•´
```

### 8.3 æ•…éšœå¤„ç†æµç¨‹



**ç›‘æ§å‘ç°é—®é¢˜åçš„å¤„ç†æ­¥éª¤**
```
Step â‘ ï¼šå‘Šè­¦æ¥æ”¶ä¸ç¡®è®¤
â€¢ æ”¶åˆ°å‘Šè­¦ä¿¡æ¯
â€¢ å¿«é€Ÿè¯„ä¼°å½±å“èŒƒå›´
â€¢ ç¡®è®¤é—®é¢˜çœŸå®æ€§

Step â‘¡ï¼šé—®é¢˜å®šä½ä¸åˆ†æ  
â€¢ æŸ¥çœ‹ç›‘æ§å¤§ç›˜
â€¢ åˆ†æç›¸å…³æ—¥å¿—
â€¢ ç¡®å®šæ ¹æœ¬åŸå› 

Step â‘¢ï¼šåº”æ€¥å¤„ç†
â€¢ æ‰§è¡Œåº”æ€¥é¢„æ¡ˆ
â€¢ æ¢å¤ä¸šåŠ¡æœåŠ¡
â€¢ æ§åˆ¶å½±å“èŒƒå›´

Step â‘£ï¼šæ ¹æœ¬è§£å†³
â€¢ ä¿®å¤æ ¹æœ¬é—®é¢˜
â€¢ éªŒè¯ä¿®å¤æ•ˆæœ
â€¢ æ›´æ–°ç›‘æ§è§„åˆ™
```

### 8.4 è¿ç»´å®è·µå»ºè®®



**æ—¥å¸¸ç›‘æ§è¿ç»´**
- **å®šæœŸå·¡æ£€**ï¼šæ¯æ—¥æ£€æŸ¥å…³é”®æŒ‡æ ‡è¶‹åŠ¿
- **é˜ˆå€¼è°ƒä¼˜**ï¼šæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‘Šè­¦é˜ˆå€¼
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›è¡Œå®¹é‡é¢„æµ‹
- **æ–‡æ¡£ç»´æŠ¤**ï¼šåŠæ—¶æ›´æ–°ç›‘æ§å’Œå‘Šè­¦æ–‡æ¡£

**åº”æ€¥å“åº”ä¼˜åŒ–**
- **é¢„æ¡ˆå‡†å¤‡**ï¼šåˆ¶å®šå„ç§æ•…éšœåœºæ™¯çš„åº”æ€¥é¢„æ¡ˆ
- **å·¥å…·å®Œå–„**ï¼šå‡†å¤‡æ•…éšœè¯Šæ–­å’Œæ¢å¤å·¥å…·
- **äººå‘˜åŸ¹è®­**ï¼šç¡®ä¿ç›¸å…³äººå‘˜ç†Ÿæ‚‰å¤„ç†æµç¨‹
- **æ¼”ç»ƒéªŒè¯**ï¼šå®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ç›‘æ§æ˜¯æ•°æ®åŒæ­¥ç³»ç»Ÿçš„"çœ¼ç›"ï¼Œå¿…é¡»è¦†ç›–å…¨é“¾è·¯
- å‘Šè­¦è¦åˆ†çº§åˆ†æ¸ é“ï¼Œé¿å…ä¿¡æ¯è¿‡è½½å’Œé—æ¼
- å¯è§†åŒ–å¤§ç›˜å¸®åŠ©å¿«é€Ÿå‘ç°å’Œå®šä½é—®é¢˜
- ç›‘æ§ç³»ç»Ÿæœ¬èº«ä¹Ÿéœ€è¦ç›‘æ§ï¼Œç¡®ä¿å¯é æ€§