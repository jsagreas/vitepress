---
title: 15ã€Canalä¸MQæ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Canalä¸MQé›†æˆæ¦‚è¿°](#1-Canalä¸MQé›†æˆæ¦‚è¿°)
2. [RocketMQé›†æˆé…ç½®](#2-RocketMQé›†æˆé…ç½®)
3. [Kafkaé›†æˆæ–¹æ¡ˆ](#3-Kafkaé›†æˆæ–¹æ¡ˆ)
4. [RabbitMQæ¶ˆæ¯å‘é€](#4-RabbitMQæ¶ˆæ¯å‘é€)
5. [æ¶ˆæ¯æ ¼å¼å®šä¹‰](#5-æ¶ˆæ¯æ ¼å¼å®šä¹‰)
6. [åˆ†åŒºç­–ç•¥é…ç½®](#6-åˆ†åŒºç­–ç•¥é…ç½®)
7. [æ¶ˆæ¯é¡ºåºä¿è¯](#7-æ¶ˆæ¯é¡ºåºä¿è¯)
8. [é‡å¤æ¶ˆæ¯å¤„ç†](#8-é‡å¤æ¶ˆæ¯å¤„ç†)
9. [æ¶ˆæ¯ä¸¢å¤±å¤„ç†](#9-æ¶ˆæ¯ä¸¢å¤±å¤„ç†)
10. [èƒŒå‹æ§åˆ¶æœºåˆ¶](#10-èƒŒå‹æ§åˆ¶æœºåˆ¶)
11. [æ¶ˆæ¯ç›‘æ§å‘Šè­¦](#11-æ¶ˆæ¯ç›‘æ§å‘Šè­¦)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ Canalä¸MQé›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Canalä¸MQé›†æˆ


**ğŸ“‹ åŸºæœ¬æ¦‚å¿µ**
Canalä¸MQé›†æˆå°±æ˜¯æŠŠCanalç›‘å¬åˆ°çš„MySQLæ•°æ®å˜åŒ–ï¼Œ**è‡ªåŠ¨å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—**ä¸­ã€‚è¿™æ ·å…¶ä»–ç³»ç»Ÿå°±èƒ½ä»æ¶ˆæ¯é˜Ÿåˆ—é‡Œè·å–æ•°æ®åº“çš„å˜æ›´ä¿¡æ¯ï¼Œå®ç°**æ•°æ®åŒæ­¥**å’Œ**äº‹ä»¶é©±åŠ¨**çš„æ¶æ„ã€‚

```
ç®€å•ç†è§£ï¼š
MySQLæ•°æ®åº“ â†’ Canalç›‘å¬ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ å…¶ä»–ç³»ç»Ÿæ¶ˆè´¹

å¥½æ¯”ï¼š
é‚®é€’å‘˜(Canal) ç›‘å¬ é‚®ç®±(MySQL) çš„ä¿¡ä»¶å˜åŒ–
ç„¶åæŠŠä¿¡ä»¶æ”¾åˆ° å¿«é€’æŸœ(MQ) é‡Œ
å…¶ä»–äºº(æ¶ˆè´¹è€…) ä»å¿«é€’æŸœå–ä¿¡ä»¶å¤„ç†
```

### 1.2 ä¸ºä»€ä¹ˆè¦é›†æˆMQ


**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**
```
âœ… è§£è€¦åˆï¼šCanalå’Œæ¶ˆè´¹è€…ä¸ç›´æ¥è¿æ¥ï¼Œé™ä½ç³»ç»Ÿä¾èµ–
âœ… å‰Šå³°å¡«è°·ï¼šMQç¼“å†²çªå‘çš„æ•°æ®å˜æ›´ï¼Œå¹³æ»‘å¤„ç†å‹åŠ›  
âœ… é«˜å¯é ï¼šæ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
âœ… æ°´å¹³æ‰©å±•ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†ï¼Œæå‡ååé‡
âœ… å¼‚æ­¥å¤„ç†ï¼šä¸é˜»å¡æ•°æ®åº“æ“ä½œï¼Œæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦
```

### 1.3 æ”¯æŒçš„MQç±»å‹


**ğŸ“Š å¸¸ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”**

| MQç±»å‹ | **ä¼˜åŠ¿** | **é€‚ç”¨åœºæ™¯** | **é›†æˆéš¾åº¦** |
|---------|---------|-------------|-------------|
| ğŸš€ **RocketMQ** | `é«˜æ€§èƒ½ã€é¡ºåºæ¶ˆæ¯ã€äº‹åŠ¡æ¶ˆæ¯` | `å¤§æ•°æ®é‡ã€é«˜å¹¶å‘` | `ä¸­ç­‰` |
| âš¡ **Kafka** | `è¶…é«˜ååé‡ã€åˆ†åŒºæœºåˆ¶` | `æ—¥å¿—æ”¶é›†ã€æµå¤„ç†` | `ç®€å•` |
| ğŸ° **RabbitMQ** | `çµæ´»è·¯ç”±ã€æ˜“äºä½¿ç”¨` | `ä¸­å°å‹ç³»ç»Ÿã€å¤æ‚è·¯ç”±` | `ç®€å•` |

---

## 2. ğŸš€ RocketMQé›†æˆé…ç½®


### 2.1 RocketMQæ˜¯ä»€ä¹ˆ


**ğŸ“‹ åŸºæœ¬æ¦‚å¿µ**
RocketMQæ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„**åˆ†å¸ƒå¼æ¶ˆæ¯ä¸­é—´ä»¶**ï¼Œä¸“é—¨ä¸ºé«˜å¹¶å‘ã€å¤§æ•°æ®é‡åœºæ™¯è®¾è®¡ã€‚å®ƒå°±åƒä¸€ä¸ª**è¶…çº§é‚®å±€**ï¼Œèƒ½å¤„ç†æµ·é‡æ¶ˆæ¯çš„æ”¶å‘ã€‚

**ğŸ”§ æ ¸å¿ƒç»„ä»¶**
```
Name Serverï¼šæ¶ˆæ¯è·¯ç”±çš„"å¯¼èˆªå‘˜"ï¼Œå‘Šè¯‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å»å“ªæ‰¾æ¶ˆæ¯
Brokerï¼šæ¶ˆæ¯å­˜å‚¨çš„"ä»“åº“ç®¡ç†å‘˜"ï¼Œè´Ÿè´£æ¶ˆæ¯çš„å­˜å‚¨å’Œè½¬å‘
Producerï¼šæ¶ˆæ¯å‘é€è€…ï¼ŒCanalåœ¨è¿™é‡Œæ‰®æ¼”ç”Ÿäº§è€…è§’è‰²
Consumerï¼šæ¶ˆæ¯æ¥æ”¶è€…ï¼Œä¸šåŠ¡ç³»ç»Ÿä»è¿™é‡Œè·å–æ•°æ®å˜æ›´
```

### 2.2 Canalé…ç½®RocketMQ


**âš™ï¸ canal.propertiesæ ¸å¿ƒé…ç½®**
```properties
# å¯ç”¨RocketMQé€‚é…å™¨
canal.serverMode = rocketMQ

# RocketMQ Name Serveråœ°å€ï¼ˆå¿…å¡«ï¼‰
rocketmq.namesrv.addr = 127.0.0.1:9876

# ç”Ÿäº§è€…ç»„åï¼ˆå»ºè®®æŒ‰ä¸šåŠ¡å‘½åï¼‰
rocketmq.producer.group = canal_producer

# æ¶ˆæ¯å‘é€è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
rocketmq.producer.sendMsgTimeout = 10000

# æ¶ˆæ¯é‡è¯•æ¬¡æ•°
rocketmq.producer.retryTimesWhenSendFailed = 3
```

**ğŸ“ instanceå®ä¾‹é…ç½®**
```properties
# canalå®ä¾‹é…ç½®æ–‡ä»¶ï¼šconf/example/instance.properties

# æŒ‡å®šå‘é€çš„Topicåç§°
canal.mq.topic = canal_topic

# æ˜¯å¦å¯ç”¨å•ä¸€Topicæ¨¡å¼ï¼ˆæ¨èï¼‰
canal.mq.dynamicTopic = canal_topic

# åˆ†åŒºå­—æ®µé…ç½®ï¼ˆç”¨äºæ¶ˆæ¯åˆ†åŒºï¼‰
canal.mq.partition = 0
canal.mq.partitionsNum = 4
canal.mq.partitionHash = table
```

### 2.3 æ¶ˆæ¯å‘é€ç¤ºä¾‹


**ğŸ’» å¯åŠ¨CanalæœåŠ¡**
```bash
# 1. å¯åŠ¨RocketMQ Name Server
cd rocketmq/bin
sh mqnamesrv

# 2. å¯åŠ¨RocketMQ Broker  
sh mqbroker -n localhost:9876

# 3. å¯åŠ¨CanalæœåŠ¡
cd canal/bin
sh startup.sh
```

**ğŸ” éªŒè¯æ¶ˆæ¯å‘é€**
```bash
# æŸ¥çœ‹Topicæ˜¯å¦åˆ›å»ºæˆåŠŸ
sh mqadmin topicList -n localhost:9876

# æŸ¥çœ‹æ¶ˆæ¯è¯¦æƒ…
sh mqadmin queryMsgByTopic -n localhost:9876 -t canal_topic
```

---

## 3. âš¡ Kafkaé›†æˆæ–¹æ¡ˆ


### 3.1 Kafkaæ˜¯ä»€ä¹ˆ


**ğŸ“‹ åŸºæœ¬æ¦‚å¿µ**  
Kafkaæ˜¯LinkedInå¼€æºçš„**é«˜ååé‡åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ**ï¼Œç‰¹åˆ«é€‚åˆå¤„ç†**æµå¼æ•°æ®**ã€‚å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª**é«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™**ï¼Œèƒ½åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡è¾†è½¦çš„é€šè¡Œã€‚

**ğŸ—ï¸ æ ¸å¿ƒæ¦‚å¿µ**
```
Topicï¼šæ¶ˆæ¯ä¸»é¢˜ï¼Œç›¸å½“äº"è½¦é“"ï¼Œä¸åŒç±»å‹æ¶ˆæ¯èµ°ä¸åŒè½¦é“
Partitionï¼šåˆ†åŒºï¼ŒæŠŠä¸€ä¸ªè½¦é“åˆ†æˆå¤šä¸ªå°é“ï¼Œæé«˜å¹¶è¡Œåº¦
Producerï¼šç”Ÿäº§è€…ï¼ŒCanalä½œä¸ºæ•°æ®çš„"å‘é€æ–¹"
Consumerï¼šæ¶ˆè´¹è€…ï¼Œä¸šåŠ¡ç³»ç»Ÿä½œä¸ºæ•°æ®çš„"æ¥æ”¶æ–¹"
```

### 3.2 Canalé…ç½®Kafka


**âš™ï¸ åŸºç¡€é…ç½®**
```properties
# canal.propertiesé…ç½®
canal.serverMode = kafka

# Kafkaé›†ç¾¤åœ°å€
kafka.bootstrap.servers = localhost:9092,localhost:9093

# æ¶ˆæ¯åºåˆ—åŒ–æ–¹å¼
kafka.acks = all
kafka.compression.type = gzip
kafka.batch.size = 16384
kafka.linger.ms = 10
```

**ğŸ“Š Topicé…ç½®ç­–ç•¥**
```properties
# å•Topicæ¨¡å¼ï¼ˆæ¨èæ–°æ‰‹ï¼‰
canal.mq.topic = canal_data
canal.mq.dynamicTopic = canal_data

# åŠ¨æ€Topicæ¨¡å¼ï¼ˆæŒ‰è¡¨åˆ†Topicï¼‰
canal.mq.dynamicTopic = ${schema}_${table}
# ä¾‹å¦‚ï¼šuseræ•°æ®åº“çš„orderè¡¨ -> user_order
```

### 3.3 åˆ†åŒºç­–ç•¥é…ç½®


**ğŸ¯ åˆ†åŒºè§„åˆ™è¯¦è§£**
```properties
# æŒ‰è¡¨åhashåˆ†åŒºï¼ˆæ¨èï¼‰
canal.mq.partitionHash = table
canal.mq.partitionsNum = 8

# æŒ‰æ•°æ®åº“ååˆ†åŒº
canal.mq.partitionHash = database  

# æŒ‰ä¸»é”®IDåˆ†åŒºï¼ˆä¿è¯åŒä¸€è®°å½•çš„æ“ä½œæœ‰åºï¼‰
canal.mq.partitionHash = pk_hash
```

**ğŸ’¡ åˆ†åŒºç­–ç•¥ç¤ºä¾‹**
```
å‡è®¾æœ‰8ä¸ªåˆ†åŒºï¼š

è¡¨åhashåˆ†åŒºï¼š
orderè¡¨çš„æ‰€æœ‰å˜æ›´ â†’ åˆ†åŒº3
userè¡¨çš„æ‰€æœ‰å˜æ›´ â†’ åˆ†åŒº1  
productè¡¨çš„æ‰€æœ‰å˜æ›´ â†’ åˆ†åŒº5

ä¸»é”®hashåˆ†åŒºï¼š
ç”¨æˆ·ID=1001çš„æ“ä½œ â†’ åˆ†åŒº1
ç”¨æˆ·ID=1002çš„æ“ä½œ â†’ åˆ†åŒº2
ç”¨æˆ·ID=1003çš„æ“ä½œ â†’ åˆ†åŒº3
```

---

## 4. ğŸ° RabbitMQæ¶ˆæ¯å‘é€


### 4.1 RabbitMQæ˜¯ä»€ä¹ˆ


**ğŸ“‹ åŸºæœ¬æ¦‚å¿µ**
RabbitMQæ˜¯åŸºäºAMQPåè®®çš„**æ¶ˆæ¯ä»£ç†**ï¼Œå°±åƒä¸€ä¸ª**æ™ºèƒ½é‚®å±€**ï¼Œèƒ½æ ¹æ®ä¸åŒè§„åˆ™æŠŠæ¶ˆæ¯å‡†ç¡®æŠ•é€’ç»™éœ€è¦çš„æ”¶ä»¶äººã€‚

**ğŸ”„ æ¶ˆæ¯æµè½¬è¿‡ç¨‹**
```
Canal(ç”Ÿäº§è€…) â†’ Exchange(äº¤æ¢æœº) â†’ Queue(é˜Ÿåˆ—) â†’ æ¶ˆè´¹è€…

å°±åƒï¼š
å¯„ä»¶äºº â†’ é‚®å±€åˆ†æ‹£ä¸­å¿ƒ â†’ æ”¶ä»¶ç®± â†’ æ”¶ä»¶äºº
```

### 4.2 Canalé…ç½®RabbitMQ


**âš™ï¸ è¿æ¥é…ç½®**
```properties
# canal.properties
canal.serverMode = rabbitMQ

# RabbitMQè¿æ¥ä¿¡æ¯
rabbitmq.host = localhost
rabbitmq.port = 5672
rabbitmq.username = guest
rabbitmq.password = guest
rabbitmq.virtual.host = /

# è¿æ¥æ± é…ç½®
rabbitmq.connection.timeout = 60000
rabbitmq.connection.retryTimes = 5
```

**ğŸ“® Exchangeå’ŒQueueé…ç½®**
```properties
# Exchangeé…ç½®
rabbitmq.exchange = canal.exchange
rabbitmq.exchange.type = topic
rabbitmq.exchange.durable = true

# è·¯ç”±è§„åˆ™
rabbitmq.routing.key = canal.routing.key
rabbitmq.queue = canal.queue
rabbitmq.queue.durable = true
```

### 4.3 æ¶ˆæ¯è·¯ç”±ç­–ç•¥


**ğŸ¯ è·¯ç”±è§„åˆ™è®¾è®¡**
```properties
# æŒ‰è¡¨è·¯ç”±ï¼ˆä¸åŒè¡¨å‘åˆ°ä¸åŒé˜Ÿåˆ—ï¼‰
rabbitmq.routing.key = ${database}.${table}

# æŒ‰æ“ä½œç±»å‹è·¯ç”±
rabbitmq.routing.key = ${database}.${table}.${eventType}
# ä¾‹å¦‚ï¼šuser.order.INSERTã€user.order.UPDATE
```

**ğŸ“Š é˜Ÿåˆ—è®¾è®¡ç¤ºä¾‹**
```
Exchange: canal.exchange (type: topic)
â”œâ”€â”€ Queue: user.order.queue (routing: user.order.*)  
â”œâ”€â”€ Queue: user.product.queue (routing: user.product.*)
â””â”€â”€ Queue: log.queue (routing: *.*.INSERT)
```

---

## 5. ğŸ“„ æ¶ˆæ¯æ ¼å¼å®šä¹‰


### 5.1 Canalæ¶ˆæ¯ç»“æ„


**ğŸ“‹ æ ‡å‡†æ¶ˆæ¯æ ¼å¼**
Canalå‘é€çš„æ¶ˆæ¯éµå¾ªç»Ÿä¸€çš„JSONæ ¼å¼ï¼ŒåŒ…å«äº†æ•°æ®å˜æ›´çš„**å®Œæ•´ä¿¡æ¯**ã€‚

```json
{
  "data": [                    // å˜æ›´çš„æ•°æ®è®°å½•
    {
      "id": "1001",
      "username": "å¼ ä¸‰",
      "email": "zhangsan@qq.com",
      "create_time": "2025-01-21 10:30:00"
    }
  ],
  "database": "user_db",       // æ•°æ®åº“å
  "es": 1642752600000,         // äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³  
  "id": 123,                   // binlogæ–‡ä»¶ä¸­çš„ä½ç½®
  "isDdl": false,              // æ˜¯å¦ä¸ºDDLæ“ä½œ
  "mysqlType": {               // MySQLå­—æ®µç±»å‹
    "id": "bigint(20)",
    "username": "varchar(50)",
    "email": "varchar(100)"
  },
  "old": [                     // å˜æ›´å‰çš„æ•°æ®ï¼ˆUPDATEæ—¶æœ‰å€¼ï¼‰
    {
      "email": "old@qq.com"
    }
  ],
  "pkNames": ["id"],           // ä¸»é”®å­—æ®µå
  "sql": "",                   // åŸå§‹SQLï¼ˆDDLæ—¶æœ‰å€¼ï¼‰
  "sqlType": {                 // JDBCå­—æ®µç±»å‹
    "id": -5,
    "username": 12,
    "email": 12
  },
  "table": "user",             // è¡¨å
  "ts": 1642752601000,         // Canalå¤„ç†æ—¶é—´æˆ³
  "type": "UPDATE"             // æ“ä½œç±»å‹ï¼šINSERT/UPDATE/DELETE
}
```

### 5.2 æ¶ˆæ¯æ ¼å¼è§£è¯»


**ğŸ” å…³é”®å­—æ®µè¯´æ˜**
```
âœ… dataï¼šæ–°æ•°æ®å†…å®¹ï¼ŒINSERT/UPDATEåçš„å€¼
âœ… oldï¼šæ—§æ•°æ®å†…å®¹ï¼Œåªæœ‰UPDATEæ“ä½œæ‰æœ‰
âœ… typeï¼šæ“ä½œç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¢åˆ æ”¹å“ªç§æ“ä½œ
âœ… database/tableï¼šå®šä½æ•°æ®æ¥æº
âœ… pkNamesï¼šä¸»é”®ä¿¡æ¯ï¼Œç”¨äºæ•°æ®å®šä½
âœ… es/tsï¼šæ—¶é—´æˆ³ï¼Œç”¨äºé¡ºåºæ§åˆ¶å’Œç›‘æ§
```

### 5.3 è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼


**âš™ï¸ æ¶ˆæ¯è½¬æ¢é…ç½®**
```properties
# å¯ç”¨æ¶ˆæ¯è¿‡æ»¤
canal.instance.filter.regex = .*\\..*

# å­—æ®µè¿‡æ»¤ï¼ˆåªå‘é€æŒ‡å®šå­—æ®µï¼‰
canal.instance.filter.field = id,username,email

# æ¶ˆæ¯æ ¼å¼åŒ–
canal.mq.flatMessage = true  # æ‰å¹³åŒ–æ¶ˆæ¯æ ¼å¼
canal.mq.compressionType = gzip  # æ¶ˆæ¯å‹ç¼©
```

**ğŸ’» è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†å™¨**
```java
// è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼åŒ–
public class CustomMessageFormatter {
    
    public String format(CanalEntry.Entry entry) {
        // æå–å…³é”®ä¿¡æ¯
        String database = entry.getHeader().getSchemaName();
        String table = entry.getHeader().getTableName();
        String eventType = entry.getHeader().getEventType().toString();
        
        // æ„å»ºç®€åŒ–æ¶ˆæ¯
        JSONObject message = new JSONObject();
        message.put("source", database + "." + table);
        message.put("action", eventType);
        message.put("timestamp", System.currentTimeMillis());
        
        return message.toJSONString();
    }
}
```

---

## 6. ğŸ¯ åˆ†åŒºç­–ç•¥é…ç½®


### 6.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯åˆ†åŒº


**ğŸ“‹ åˆ†åŒºæ¦‚å¿µ**
æ¶ˆæ¯åˆ†åŒºå°±æ˜¯æŠŠæ¶ˆæ¯**æŒ‰è§„åˆ™åˆ†åˆ°ä¸åŒçš„"ç›’å­"**é‡Œï¼Œè¿™æ ·å¯ä»¥ï¼š
- **å¹¶è¡Œå¤„ç†**ï¼šå¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å¤„ç†ä¸åŒç›’å­çš„æ¶ˆæ¯
- **ä¿è¯é¡ºåº**ï¼šåŒä¸€ä¸ªç›’å­å†…çš„æ¶ˆæ¯ä¿æŒé¡ºåº
- **è´Ÿè½½å‡è¡¡**ï¼šæ¶ˆæ¯å‡åŒ€åˆ†å¸ƒåˆ°å„ä¸ªç›’å­

```
ä¸åˆ†åŒºçš„æƒ…å†µï¼š
æ‰€æœ‰æ¶ˆæ¯ â†’ ä¸€ä¸ªé˜Ÿåˆ— â†’ ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ï¼ˆæ…¢ï¼‰

åˆ†åŒºçš„æƒ…å†µï¼š  
è®¢å•æ¶ˆæ¯ â†’ åˆ†åŒº1 â†’ æ¶ˆè´¹è€…Aå¤„ç†
ç”¨æˆ·æ¶ˆæ¯ â†’ åˆ†åŒº2 â†’ æ¶ˆè´¹è€…Bå¤„ç†  
å•†å“æ¶ˆæ¯ â†’ åˆ†åŒº3 â†’ æ¶ˆè´¹è€…Cå¤„ç†
```

### 6.2 åˆ†åŒºç­–ç•¥ç±»å‹


**ğŸ² Hashåˆ†åŒºç­–ç•¥**
```properties
# æŒ‰è¡¨åhashï¼ˆæ¨èï¼‰
canal.mq.partitionHash = table
# ä¼˜ç‚¹ï¼šåŒä¸€ä¸ªè¡¨çš„æ“ä½œåœ¨åŒä¸€åˆ†åŒºï¼Œä¿è¯é¡ºåº
# ç¼ºç‚¹ï¼šå¦‚æœè¡¨æ•°é‡å°‘äºåˆ†åŒºæ•°ï¼Œä¼šæœ‰ç©ºé—²åˆ†åŒº

# æŒ‰ä¸»é”®hash
canal.mq.partitionHash = pk_hash  
# ä¼˜ç‚¹ï¼šåŒä¸€æ¡è®°å½•çš„æ“ä½œä¿è¯é¡ºåº
# ç¼ºç‚¹ï¼šå¦‚æœä¸»é”®åˆ†å¸ƒä¸å‡ï¼Œå¯èƒ½å¯¼è‡´åˆ†åŒºä¸å¹³è¡¡

# æŒ‰æ•°æ®åº“åhash
canal.mq.partitionHash = database
# ä¼˜ç‚¹ï¼šåŒä¸€ä¸ªæ•°æ®åº“çš„æ“ä½œåœ¨åŒä¸€åˆ†åŒº
# ç¼ºç‚¹ï¼šæ•°æ®åº“æ•°é‡é€šå¸¸å¾ˆå°‘ï¼Œåˆ†åŒºåˆ©ç”¨ç‡ä½
```

### 6.3 åˆ†åŒºé…ç½®å®è·µ


**âš™ï¸ åˆ†åŒºæ•°é‡è§„åˆ’**
```properties
# åˆ†åŒºæ•°é‡è®¾ç½®åŸåˆ™
canal.mq.partitionsNum = 8

# è®¡ç®—å…¬å¼ï¼š
# åˆ†åŒºæ•° = æ¶ˆè´¹è€…æ•°é‡ Ã— 2~4å€
# ä¾‹å¦‚ï¼š4ä¸ªæ¶ˆè´¹è€… â†’ 8-16ä¸ªåˆ†åŒº

# è€ƒè™‘å› ç´ ï¼š
# âœ… æ¶ˆè´¹è€…æ•°é‡ï¼šåˆ†åŒºæ•°åº”å¤§äºç­‰äºæ¶ˆè´¹è€…æ•°
# âœ… æ¶ˆæ¯é‡ï¼šæ¶ˆæ¯é‡å¤§éœ€è¦æ›´å¤šåˆ†åŒº
# âœ… é¡ºåºè¦æ±‚ï¼šéœ€è¦é¡ºåºæ—¶åˆ†åŒºä¸å®œè¿‡å¤š
```

**ğŸ“Š åˆ†åŒºæ•ˆæœéªŒè¯**
```bash
# KafkaæŸ¥çœ‹åˆ†åŒºæ¶ˆæ¯åˆ†å¸ƒ
kafka-run-class.sh kafka.tools.GetOffsetShell \
  --bootstrap-server localhost:9092 \
  --topic canal_topic

# è¾“å‡ºç¤ºä¾‹ï¼š
# canal_topic:0:1205  # åˆ†åŒº0æœ‰1205æ¡æ¶ˆæ¯
# canal_topic:1:1180  # åˆ†åŒº1æœ‰1180æ¡æ¶ˆæ¯  
# canal_topic:2:1195  # åˆ†åŒº2æœ‰1195æ¡æ¶ˆæ¯
```

---

## 7. ğŸ”„ æ¶ˆæ¯é¡ºåºä¿è¯


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦é¡ºåºä¿è¯


**âš ï¸ ä¹±åºé—®é¢˜ç¤ºä¾‹**
```
æ­£ç¡®é¡ºåºï¼š
1. INSERT user(id=1001, name='å¼ ä¸‰')
2. UPDATE user(id=1001, name='æå››') 
3. DELETE user(id=1001)

ä¹±åºæ‰§è¡Œï¼š
1. DELETE user(id=1001)  âŒ åˆ é™¤äº†ä¸å­˜åœ¨çš„è®°å½•
2. INSERT user(id=1001, name='å¼ ä¸‰')
3. UPDATE user(id=1001, name='æå››')
ç»“æœï¼šæœ€ç»ˆç”¨æˆ·åæ˜¯'æå››'ï¼Œè€Œä¸æ˜¯åˆ é™¤çŠ¶æ€
```

### 7.2 é¡ºåºä¿è¯ç­–ç•¥


**ğŸ¯ åˆ†åŒºçº§åˆ«é¡ºåº**
```properties
# æŒ‰ä¸»é”®åˆ†åŒºï¼ˆæ¨èï¼‰
canal.mq.partitionHash = pk_hash
canal.mq.partitionsNum = 16

# åŸç†ï¼šç›¸åŒä¸»é”®çš„æ“ä½œè¿›å…¥åŒä¸€åˆ†åŒºï¼Œåˆ†åŒºå†…ä¸¥æ ¼æœ‰åº
```

**ğŸ“Š é¡ºåºä¿è¯æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | **é¡ºåºèŒƒå›´** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|------|------------|---------|-----------|-------------|
| ğŸ”¸ **å…¨å±€é¡ºåº** | `æ‰€æœ‰æ¶ˆæ¯æœ‰åº` | `ä½` | `ç®€å•` | `æ¶ˆæ¯é‡å°` |
| ğŸ¯ **åˆ†åŒºé¡ºåº** | `åˆ†åŒºå†…æœ‰åº` | `é«˜` | `ä¸­ç­‰` | `å¤§éƒ¨åˆ†åœºæ™¯` |
| ğŸ“ **ä¸šåŠ¡é¡ºåº** | `ä¸šåŠ¡ç›¸å…³æœ‰åº` | `é«˜` | `å¤æ‚` | `å¤æ‚ä¸šåŠ¡` |

### 7.3 é¡ºåºæ¶ˆè´¹é…ç½®


**âš™ï¸ æœ‰åºæ¶ˆè´¹è®¾ç½®**
```properties
# RocketMQæœ‰åºæ¶ˆè´¹
rocketmq.consumer.messageModel = CLUSTERING
rocketmq.consumer.consumeFromWhere = CONSUME_FROM_FIRST_OFFSET
rocketmq.consumer.consumeMessageBatchMaxSize = 1  # å•æ¡æ¶ˆè´¹ä¿è¯é¡ºåº

# Kafkaæœ‰åºæ¶ˆè´¹
kafka.consumer.max.poll.records = 1  # æ¯æ¬¡æ‹‰å–1æ¡æ¶ˆæ¯
kafka.consumer.enable.auto.commit = false  # æ‰‹åŠ¨æäº¤offset
```

**ğŸ’» æ¶ˆè´¹è€…é¡ºåºå¤„ç†ç¤ºä¾‹**
```java
// RocketMQæœ‰åºæ¶ˆè´¹
@RocketMQMessageListener(
    topic = "canal_topic",
    consumerGroup = "canal_consumer",
    consumeMode = ConsumeMode.ORDERLY  // å…³é”®ï¼šæœ‰åºæ¶ˆè´¹æ¨¡å¼
)
public class OrderedMessageConsumer implements RocketMQListener<String> {
    
    @Override
    public void onMessage(String message) {
        try {
            // å¤„ç†æ¶ˆæ¯
            processMessage(message);
        } catch (Exception e) {
            // å¼‚å¸¸æ—¶è¿”å›RECONSUME_LATERï¼Œç¨åé‡è¯•
            throw new RuntimeException("å¤„ç†å¤±è´¥ï¼Œéœ€è¦é‡è¯•", e);
        }
    }
}
```

---

## 8. ğŸ”„ é‡å¤æ¶ˆæ¯å¤„ç†


### 8.1 é‡å¤æ¶ˆæ¯äº§ç”ŸåŸå› 


**ğŸ” å¸¸è§åœºæ™¯**
```
ç½‘ç»œæŠ–åŠ¨ï¼šæ¶ˆæ¯å‘é€æˆåŠŸä½†ACKä¸¢å¤±ï¼Œå¯¼è‡´é‡å‘
ç³»ç»Ÿé‡å¯ï¼šCanalé‡å¯åä»ä¸Šæ¬¡checkpointé‡æ–°å‘é€
æ¶ˆè´¹è€…é‡å¤ï¼šæ¶ˆè´¹è€…å¤„ç†æˆåŠŸä½†æäº¤offsetå¤±è´¥

ä¸¾ä¾‹ï¼š
ç”¨æˆ·å……å€¼100å…ƒçš„æ¶ˆæ¯è¢«é‡å¤æ¶ˆè´¹
ç¬¬1æ¬¡ï¼šä½™é¢1000 + 100 = 1100 âœ…
ç¬¬2æ¬¡ï¼šä½™é¢1100 + 100 = 1200 âŒ å¤šå……äº†100å…ƒ
```

### 8.2 å¹‚ç­‰æ€§è®¾è®¡


**ğŸ¯ å¹‚ç­‰æ€§åŸç†**
å¹‚ç­‰æ€§å°±æ˜¯**åŒä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡ç»“æœç›¸åŒ**ï¼Œå°±åƒç”µæ¢¯æŒ‰é’®ï¼ŒæŒ‰ä¸€æ¬¡å’ŒæŒ‰åæ¬¡æ•ˆæœä¸€æ ·ã€‚

**ğŸ’¡ å¹‚ç­‰è®¾è®¡æ–¹æ¡ˆ**

```java
// æ–¹æ¡ˆ1ï¼šå”¯ä¸€æ€§çº¦æŸ
@Service
public class UserBalanceService {
    
    public void processRecharge(RechargeMessage msg) {
        // ä½¿ç”¨æ¶ˆæ¯IDä½œä¸ºå”¯ä¸€æ ‡è¯†
        String messageId = msg.getMessageId();
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
        if (rechargeRecordExists(messageId)) {
            log.info("æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡ï¼š{}", messageId);
            return;
        }
        
        // å¤„ç†å……å€¼é€»è¾‘
        rechargeBalance(msg.getUserId(), msg.getAmount());
        
        // è®°å½•å¤„ç†çŠ¶æ€
        saveRechargeRecord(messageId, msg);
    }
}
```

**ğŸ—ƒï¸ å»é‡è¡¨è®¾è®¡**
```sql
-- æ¶ˆæ¯å¤„ç†è®°å½•è¡¨
CREATE TABLE message_process_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) NOT NULL UNIQUE,  -- æ¶ˆæ¯å”¯ä¸€ID
    topic VARCHAR(100) NOT NULL,             -- æ¶ˆæ¯ä¸»é¢˜
    partition_id INT,                        -- åˆ†åŒºID
    offset_id BIGINT,                        -- æ¶ˆæ¯åç§»é‡
    process_status TINYINT DEFAULT 1,        -- å¤„ç†çŠ¶æ€ï¼š1æˆåŠŸ 0å¤±è´¥
    process_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    retry_count INT DEFAULT 0,               -- é‡è¯•æ¬¡æ•°
    INDEX idx_message_id (message_id),
    INDEX idx_topic_partition (topic, partition_id)
);
```

### 8.3 é‡å¤æ£€æµ‹å®ç°


**âš™ï¸ åŸºäºRedisçš„å»é‡**
```java
@Component
public class MessageDeduplicator {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String DEDUP_KEY_PREFIX = "canal:dedup:";
    private static final long DEDUP_EXPIRE_TIME = 24 * 60 * 60; // 24å°æ—¶
    
    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦é‡å¤
     */
    public boolean isDuplicate(String messageId) {
        String key = DEDUP_KEY_PREFIX + messageId;
        
        // ä½¿ç”¨Redisçš„setnxæ“ä½œå®ç°åŸå­æ€§æ£€æŸ¥
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, "1", DEDUP_EXPIRE_TIME, TimeUnit.SECONDS);
            
        return !Boolean.TRUE.equals(success);
    }
    
    /**
     * æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
     */
    public void markProcessed(String messageId) {
        String key = DEDUP_KEY_PREFIX + messageId;
        redisTemplate.opsForValue()
            .set(key, "processed", DEDUP_EXPIRE_TIME, TimeUnit.SECONDS);
    }
}
```

---

## 9. ğŸ“‰ æ¶ˆæ¯ä¸¢å¤±å¤„ç†


### 9.1 æ¶ˆæ¯ä¸¢å¤±åœºæ™¯


**âš ï¸ ä¸¢å¤±é£é™©ç‚¹**
```
Canalå‘é€é˜¶æ®µï¼š
- CanalæœåŠ¡å¼‚å¸¸å…³é—­ï¼Œæœªå‘é€çš„æ¶ˆæ¯ä¸¢å¤±
- ç½‘ç»œæ•…éšœå¯¼è‡´æ¶ˆæ¯å‘é€å¤±è´¥
- MQæœåŠ¡ä¸å¯ç”¨ï¼Œæ¶ˆæ¯æ— æ³•æŠ•é€’

MQå­˜å‚¨é˜¶æ®µï¼š  
- MQæœåŠ¡å™¨å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±
- ç£ç›˜æ•…éšœï¼ŒæŒä¹…åŒ–æ¶ˆæ¯æŸå
- æ¶ˆæ¯è¿‡æœŸè¢«æ¸…ç†

æ¶ˆè´¹å¤„ç†é˜¶æ®µï¼š
- æ¶ˆè´¹è€…å¤„ç†å¤±è´¥ä½†ACKæˆåŠŸ
- æ¶ˆè´¹è€…æœåŠ¡å¼‚å¸¸ï¼Œæ¶ˆæ¯æœªå®Œæ•´å¤„ç†
```

### 9.2 å‘é€ç«¯å¯é æ€§ä¿è¯


**ğŸ”’ Canalå‘é€ç¡®è®¤æœºåˆ¶**
```properties
# RocketMQåŒæ­¥å‘é€ï¼ˆå¯é æ€§æœ€é«˜ï¼‰
rocketmq.producer.sendMsgTimeout = 10000
rocketmq.producer.retryTimesWhenSendFailed = 3
rocketmq.producer.sendLatencyFaultEnable = true

# Kafkaå‘é€ç¡®è®¤
kafka.acks = all  # ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
kafka.retries = 3  # é‡è¯•æ¬¡æ•°
kafka.retry.backoff.ms = 1000  # é‡è¯•é—´éš”
```

**ğŸ“ å‘é€å¤±è´¥å¤„ç†**
```java
// è‡ªå®šä¹‰å‘é€å¤±è´¥å¤„ç†å™¨
public class CanalMessageSendHandler {
    
    private final Logger logger = LoggerFactory.getLogger(getClass());
    
    /**
     * æ¶ˆæ¯å‘é€å¤±è´¥å›è°ƒ
     */
    public void onSendFailed(String topic, String message, Exception e) {
        logger.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œtopic: {}, é”™è¯¯: {}", topic, e.getMessage());
        
        // 1. è®°å½•å¤±è´¥æ—¥å¿—
        saveFailedMessage(topic, message, e);
        
        // 2. é‡è¯•æœºåˆ¶
        retryLater(topic, message);
        
        // 3. å‘Šè­¦é€šçŸ¥
        sendAlert("Canalæ¶ˆæ¯å‘é€å¤±è´¥", e.getMessage());
    }
    
    /**
     * ä¿å­˜å¤±è´¥æ¶ˆæ¯åˆ°æœ¬åœ°æ–‡ä»¶
     */
    private void saveFailedMessage(String topic, String message, Exception e) {
        String fileName = "failed_messages_" + LocalDate.now() + ".log";
        try {
            Files.write(
                Paths.get("logs", fileName),
                (message + "\n").getBytes(),
                StandardOpenOption.CREATE, StandardOpenOption.APPEND
            );
        } catch (IOException ex) {
            logger.error("ä¿å­˜å¤±è´¥æ¶ˆæ¯å¼‚å¸¸", ex);
        }
    }
}
```

### 9.3 æ¶ˆè´¹ç«¯å¯é æ€§ä¿è¯


**âœ… æ‰‹åŠ¨ACKç¡®è®¤**
```java
// Kafkaæ‰‹åŠ¨æäº¤ç¤ºä¾‹
@KafkaListener(topics = "canal_topic")
public void handleMessage(
    @Payload String message,
    @Header KafkaHeaders headers,
    Acknowledgment ack) {
    
    try {
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        processBusinessLogic(message);
        
        // åªæœ‰å¤„ç†æˆåŠŸæ‰æäº¤offset
        ack.acknowledge();
        
    } catch (Exception e) {
        logger.error("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼š{}", message, e);
        // ä¸è°ƒç”¨ack.acknowledge()ï¼Œæ¶ˆæ¯ä¼šé‡æ–°æ¶ˆè´¹
        
        // è®°å½•å¤±è´¥ä¿¡æ¯
        recordFailedMessage(message, e);
    }
}
```

**ğŸ”„ å¤±è´¥é‡è¯•æœºåˆ¶**
```java
@Component
public class MessageRetryHandler {
    
    /**
     * æŒ‡æ•°é€€é¿é‡è¯•
     */
    @Retryable(
        value = {Exception.class},
        maxAttempts = 5,
        backoff = @Backoff(
            delay = 1000,  // åˆå§‹å»¶è¿Ÿ1ç§’
            multiplier = 2  // æ¯æ¬¡ç¿»å€
        )
    )
    public void processWithRetry(String message) throws Exception {
        try {
            businessService.process(message);
        } catch (Exception e) {
            logger.warn("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå°†é‡è¯•ï¼š{}", e.getMessage());
            throw e;  // æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        }
    }
    
    /**
     * é‡è¯•è€—å°½åçš„å¤„ç†
     */
    @Recover
    public void recover(Exception e, String message) {
        logger.error("æ¶ˆæ¯é‡è¯•è€—å°½ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼š{}", message, e);
        
        // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
        sendToDeadLetterQueue(message, e);
        
        // äººå·¥ä»‹å…¥å‘Šè­¦
        sendAlert("æ¶ˆæ¯å¤„ç†å½»åº•å¤±è´¥", message);
    }
}
```

---

## 10. ğŸŒŠ èƒŒå‹æ§åˆ¶æœºåˆ¶


### 10.1 ä»€ä¹ˆæ˜¯èƒŒå‹é—®é¢˜


**ğŸ“‹ èƒŒå‹æ¦‚å¿µ**
èƒŒå‹å°±æ˜¯**ä¸‹æ¸¸å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šä¸Šæ¸¸å‘é€é€Ÿåº¦**ï¼Œå¯¼è‡´æ¶ˆæ¯å †ç§¯ï¼Œå°±åƒæ°´ç®¡å µå¡ä¸€æ ·ã€‚

```
æ­£å¸¸æƒ…å†µï¼š
MySQLå˜æ›´ â†’ Canal â†’ MQ â†’ æ¶ˆè´¹è€…
  100/s     100/s   100/s   100/s  âœ… æµé‡å‡è¡¡

èƒŒå‹æƒ…å†µï¼š
MySQLå˜æ›´ â†’ Canal â†’ MQ â†’ æ¶ˆè´¹è€…  
  1000/s    1000/s  å †ç§¯   50/s   âŒ æ¶ˆæ¯å †ç§¯
```

### 10.2 èƒŒå‹ç›‘æ§æŒ‡æ ‡


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```
æ¶ˆæ¯å †ç§¯é‡ï¼š
- MQä¸­æœªæ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡
- é˜ˆå€¼ï¼šè¶…è¿‡10ä¸‡æ¡éœ€è¦å…³æ³¨

æ¶ˆè´¹å»¶è¿Ÿï¼š
- æ¶ˆæ¯äº§ç”Ÿæ—¶é—´åˆ°æ¶ˆè´¹æ—¶é—´çš„å·®å€¼  
- é˜ˆå€¼ï¼šè¶…è¿‡5åˆ†é’Ÿéœ€è¦å‘Šè­¦

æ¶ˆè´¹é€Ÿç‡ï¼š
- æ¯ç§’æ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡
- å¯¹æ¯”ï¼šç”Ÿäº§é€Ÿç‡ vs æ¶ˆè´¹é€Ÿç‡
```

**âš™ï¸ ç›‘æ§é…ç½®ç¤ºä¾‹**
```properties
# Kafkaæ¶ˆè´¹è€…ç›‘æ§é…ç½®
kafka.consumer.fetch.max.wait.ms = 500
kafka.consumer.max.poll.records = 100  # å•æ¬¡æ‹‰å–æ¶ˆæ¯æ•°
kafka.consumer.session.timeout.ms = 30000

# Canalå†…éƒ¨é˜Ÿåˆ—ç›‘æ§
canal.instance.memory.buffer.size = 16384  # å†…å­˜ç¼“å†²åŒºå¤§å°
canal.instance.memory.buffer.memunit = 1024  # ç¼“å†²å•å…ƒå¤§å°
```

### 10.3 èƒŒå‹æ§åˆ¶ç­–ç•¥


**ğŸš¦ æµé‡æ§åˆ¶æ–¹æ¡ˆ**

```java
// è‡ªé€‚åº”æ¶ˆè´¹æ§åˆ¶
@Component
public class AdaptiveConsumerController {
    
    private volatile int batchSize = 10;  // åŠ¨æ€è°ƒæ•´æ‰¹æ¬¡å¤§å°
    private final AtomicLong processTime = new AtomicLong();
    
    @KafkaListener(topics = "canal_topic")
    public void consume(List<String> messages) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æ‰¹é‡å¤„ç†æ¶ˆæ¯
            processBatch(messages);
            
            // è®¡ç®—å¤„ç†æ—¶é—´
            long duration = System.currentTimeMillis() - startTime;
            processTime.set(duration);
            
            // è‡ªé€‚åº”è°ƒæ•´æ‰¹æ¬¡å¤§å°
            adjustBatchSize(duration, messages.size());
            
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸æ—¶å‡å°æ‰¹æ¬¡
            batchSize = Math.max(1, batchSize / 2);
            logger.error("å¤„ç†å¼‚å¸¸ï¼Œæ‰¹æ¬¡å¤§å°è°ƒæ•´ä¸ºï¼š{}", batchSize, e);
        }
    }
    
    /**
     * æ ¹æ®å¤„ç†æ—¶é—´è°ƒæ•´æ‰¹æ¬¡å¤§å°
     */
    private void adjustBatchSize(long duration, int messageCount) {
        if (duration < 1000 && messageCount == batchSize) {
            // å¤„ç†å¾ˆå¿«ï¼Œå¯ä»¥å¢åŠ æ‰¹æ¬¡
            batchSize = Math.min(100, batchSize + 5);
        } else if (duration > 5000) {
            // å¤„ç†è¾ƒæ…¢ï¼Œå‡å°‘æ‰¹æ¬¡
            batchSize = Math.max(1, batchSize - 2);
        }
    }
}
```

**â¸ï¸ ç†”æ–­é™çº§æœºåˆ¶**
```java
@Component
public class ConsumerCircuitBreaker {
    
    private final CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults("consumer");
    
    @EventListener
    public void handleMessage(String message) {
        Supplier<String> decoratedSupplier = CircuitBreaker
            .decorateSupplier(circuitBreaker, () -> {
                processMessage(message);
                return "success";
            });
            
        Try<String> result = Try.ofSupplier(decoratedSupplier);
        
        if (result.isFailure()) {
            // ç†”æ–­æ—¶çš„é™çº§å¤„ç†
            handleFallback(message, result.getCause());
        }
    }
    
    /**
     * é™çº§å¤„ç†ï¼šæ¶ˆæ¯å­˜å‚¨åˆ°æœ¬åœ°ï¼Œç¨åå¤„ç†
     */
    private void handleFallback(String message, Throwable cause) {
        logger.warn("ç³»ç»Ÿç¹å¿™ï¼Œæ¶ˆæ¯é™çº§å¤„ç†ï¼š{}", cause.getMessage());
        
        // å­˜å‚¨åˆ°æœ¬åœ°é˜Ÿåˆ—ï¼Œç¨åé‡è¯•
        localQueue.offer(message);
    }
}
```

---

## 11. ğŸ“Š æ¶ˆæ¯ç›‘æ§å‘Šè­¦


### 11.1 ç›‘æ§ä½“ç³»è®¾è®¡


**ğŸ“ˆ ç›‘æ§å±‚æ¬¡ç»“æ„**
```
CanalæœåŠ¡ç›‘æ§ï¼š
â”œâ”€â”€ è¿æ¥çŠ¶æ€ï¼šMySQLè¿æ¥æ˜¯å¦æ­£å¸¸
â”œâ”€â”€ è§£ææ€§èƒ½ï¼šbinlogè§£æé€Ÿåº¦å’Œå»¶è¿Ÿ
â”œâ”€â”€ å‘é€çŠ¶æ€ï¼šæ¶ˆæ¯å‘é€æˆåŠŸç‡å’Œå¤±è´¥ç‡
â””â”€â”€ å†…å­˜ä½¿ç”¨ï¼šJVMå†…å­˜å’Œç¼“å†²åŒºä½¿ç”¨æƒ…å†µ

MQç›‘æ§ï¼š  
â”œâ”€â”€ æ¶ˆæ¯å †ç§¯ï¼šTopicæ¶ˆæ¯ç§¯å‹æ•°é‡
â”œâ”€â”€ åˆ†åŒºçŠ¶æ€ï¼šå„åˆ†åŒºæ¶ˆæ¯åˆ†å¸ƒæƒ…å†µ
â”œâ”€â”€ æ¶ˆè´¹å»¶è¿Ÿï¼šæ¶ˆæ¯äº§ç”Ÿåˆ°æ¶ˆè´¹çš„æ—¶é—´å·®
â””â”€â”€ ååé‡ï¼šæ¯ç§’ç”Ÿäº§å’Œæ¶ˆè´¹çš„æ¶ˆæ¯æ•°

æ¶ˆè´¹è€…ç›‘æ§ï¼š
â”œâ”€â”€ æ¶ˆè´¹é€Ÿç‡ï¼šæ¯ç§’å¤„ç†æ¶ˆæ¯æ•°é‡
â”œâ”€â”€ å¤„ç†å»¶è¿Ÿï¼šæ¶ˆæ¯å¤„ç†æ—¶é—´åˆ†å¸ƒ
â”œâ”€â”€ é”™è¯¯ç‡ï¼šå¤„ç†å¤±è´¥çš„æ¶ˆæ¯æ¯”ä¾‹
â””â”€â”€ é‡è¯•æƒ…å†µï¼šé‡è¯•æ¬¡æ•°å’ŒæˆåŠŸç‡
```

### 11.2 å…³é”®æŒ‡æ ‡å®šä¹‰


**ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **æŒ‡æ ‡åç§°** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** | **ç´§æ€¥é˜ˆå€¼** |
|---------|------------|------------|------------|------------|
| ğŸ”„ **å»¶è¿ŸæŒ‡æ ‡** | `æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ` | `< 1ç§’` | `> 10ç§’` | `> 60ç§’` |
| ğŸ“ˆ **å †ç§¯æŒ‡æ ‡** | `æ¶ˆæ¯å †ç§¯æ•°é‡` | `< 1000` | `> 10000` | `> 100000` |
| âš¡ **æ€§èƒ½æŒ‡æ ‡** | `æ¶ˆè´¹é€Ÿç‡` | `> 100/s` | `< 50/s` | `< 10/s` |
| ğŸ¯ **è´¨é‡æŒ‡æ ‡** | `æ¶ˆæ¯æˆåŠŸç‡` | `> 99%` | `< 95%` | `< 90%` |

### 11.3 ç›‘æ§å®ç°æ–¹æ¡ˆ


**âš™ï¸ Prometheusç›‘æ§é…ç½®**
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'canal-server'
    static_configs:
      - targets: ['localhost:11111']  # Canalç®¡ç†ç«¯å£
    metrics_path: /metrics
    scrape_interval: 10s

  - job_name: 'kafka'
    static_configs:
      - targets: ['localhost:9308']  # Kafka Exporter
    metrics_path: /metrics
```

**ğŸ“Š Grafanaä»ªè¡¨æ¿**
```json
{
  "dashboard": {
    "title": "Canalæ¶ˆæ¯ç›‘æ§",
    "panels": [
      {
        "title": "æ¶ˆæ¯å †ç§¯è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "kafka_consumer_lag_sum{topic=\"canal_topic\"}",
            "legendFormat": "æ¶ˆæ¯å †ç§¯æ•°"
          }
        ]
      },
      {
        "title": "æ¶ˆè´¹é€Ÿç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(kafka_consumer_messages_consumed_total[5m])",
            "legendFormat": "æ¶ˆè´¹é€Ÿç‡(/s)"
          }
        ]
      }
    ]
  }
}
```

### 11.4 å‘Šè­¦è§„åˆ™é…ç½®


**ğŸš¨ å‘Šè­¦è§„åˆ™ç¤ºä¾‹**
```yaml
# alerting_rules.yml
groups:
  - name: canal_alerts
    rules:
      # æ¶ˆæ¯å †ç§¯å‘Šè­¦
      - alert: MessageLagHigh
        expr: kafka_consumer_lag_sum{topic="canal_topic"} > 10000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Canalæ¶ˆæ¯å †ç§¯è¿‡å¤š"
          description: "Topic {{ $labels.topic }} å †ç§¯æ¶ˆæ¯æ•°: {{ $value }}"

      # æ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦  
      - alert: ConsumerLatencyHigh
        expr: kafka_consumer_lag_seconds{topic="canal_topic"} > 60
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æ¶ˆè´¹å»¶è¿Ÿè¿‡é«˜"
          description: "å»¶è¿Ÿæ—¶é—´: {{ $value }}ç§’"

      # CanalæœåŠ¡å¼‚å¸¸
      - alert: CanalServiceDown
        expr: up{job="canal-server"} == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "CanalæœåŠ¡ä¸å¯ç”¨"
          description: "CanalæœåŠ¡å·²åœæ­¢è¿è¡Œ"
```

**ğŸ“± å‘Šè­¦é€šçŸ¥é…ç½®**
```java
@Component
public class AlertNotificationService {
    
    /**
     * å‘é€å‘Šè­¦é€šçŸ¥
     */
    public void sendAlert(AlertLevel level, String message, Map<String, Object> metrics) {
        switch (level) {
            case WARNING:
                sendDingTalkMessage(message, metrics);
                break;
            case CRITICAL:
                sendDingTalkMessage(message, metrics);
                sendSmsAlert(message);
                sendEmailAlert(message, metrics);
                break;
            case EMERGENCY:
                sendDingTalkMessage(message, metrics);
                sendSmsAlert(message);
                sendEmailAlert(message, metrics);
                callPhoneAlert();
                break;
        }
    }
    
    /**
     * é’‰é’‰æœºå™¨äººé€šçŸ¥
     */
    private void sendDingTalkMessage(String message, Map<String, Object> metrics) {
        String webhook = "https://oapi.dingtalk.com/robot/send?access_token=xxx";
        
        JSONObject json = new JSONObject();
        json.put("msgtype", "markdown");
        
        JSONObject markdown = new JSONObject();
        markdown.put("title", "Canalç›‘æ§å‘Šè­¦");
        markdown.put("text", buildMarkdownMessage(message, metrics));
        
        json.put("markdown", markdown);
        
        // å‘é€HTTPè¯·æ±‚
        httpClient.post(webhook, json.toString());
    }
    
    /**
     * æ„å»ºå‘Šè­¦æ¶ˆæ¯
     */
    private String buildMarkdownMessage(String message, Map<String, Object> metrics) {
        StringBuilder sb = new StringBuilder();
        sb.append("## ğŸš¨ Canalç›‘æ§å‘Šè­¦\n\n");
        sb.append("**å‘Šè­¦å†…å®¹**: ").append(message).append("\n\n");
        sb.append("**å‘ç”Ÿæ—¶é—´**: ").append(LocalDateTime.now()).append("\n\n");
        
        if (metrics != null && !metrics.isEmpty()) {
            sb.append("**ç›‘æ§æŒ‡æ ‡**:\n\n");
            metrics.forEach((key, value) -> 
                sb.append("- ").append(key).append(": ").append(value).append("\n"));
        }
        
        sb.append("\n> è¯·åŠæ—¶å¤„ç†ï¼");
        return sb.toString();
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Canalä¸MQé›†æˆï¼šå°†æ•°æ®åº“å˜æ›´äº‹ä»¶å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°è§£è€¦å’Œå¼‚æ­¥å¤„ç†
ğŸ”¸ ä¸‰å¤§MQé€‰æ‹©ï¼šRocketMQ(é«˜æ€§èƒ½)ã€Kafka(é«˜åå)ã€RabbitMQ(çµæ´»è·¯ç”±)
ğŸ”¸ æ¶ˆæ¯æ ¼å¼ï¼šç»Ÿä¸€JSONæ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„å˜æ›´ä¿¡æ¯
ğŸ”¸ åˆ†åŒºç­–ç•¥ï¼šæŒ‰è¡¨ã€æŒ‰ä¸»é”®hashåˆ†åŒºï¼Œä¿è¯é¡ºåºå’Œè´Ÿè½½å‡è¡¡
ğŸ”¸ å¯é æ€§ä¿è¯ï¼šé˜²é‡å¤ã€é˜²ä¸¢å¤±ã€é¡ºåºä¿è¯ä¸‰å¤§æ ¸å¿ƒæœºåˆ¶
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦é›†æˆMQ**
```
è§£è€¦ä¼˜åŠ¿ï¼š
- Canalå’Œæ¶ˆè´¹è€…ä¸ç›´æ¥è¿æ¥ï¼Œé™ä½ç³»ç»Ÿä¾èµ–
- å¯ä»¥éšæ—¶æ–°å¢æ¶ˆè´¹è€…ï¼Œä¸å½±å“Canalè¿è¡Œ
- æ¶ˆè´¹è€…å¼‚å¸¸ä¸å½±å“Canalç»§ç»­å·¥ä½œ

æ€§èƒ½ä¼˜åŠ¿ï¼š
- MQæä¾›ç¼“å†²ï¼Œå¹³æ»‘çªå‘æµé‡
- æ”¯æŒå¤šæ¶ˆè´¹è€…å¹¶è¡Œå¤„ç†ï¼Œæé«˜ååé‡
- å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡æ•°æ®åº“æ“ä½œ
```

**ğŸ”¹ åˆ†åŒºç­–ç•¥çš„é€‰æ‹©åŸåˆ™**
```
é¡ºåºè¦æ±‚é«˜ï¼šé€‰æ‹©æŒ‰ä¸»é”®hashåˆ†åŒº
æ€§èƒ½è¦æ±‚é«˜ï¼šé€‰æ‹©æŒ‰è¡¨hashåˆ†åŒºï¼Œå……åˆ†åˆ©ç”¨åˆ†åŒº
ç®€å•åœºæ™¯ï¼šå›ºå®šåˆ†åŒºæˆ–è½®è¯¢åˆ†åŒº

å¹³è¡¡è€ƒè™‘ï¼š
- åˆ†åŒºæ•° = æ¶ˆè´¹è€…æ•° Ã— 2~4å€
- é¿å…çƒ­ç‚¹åˆ†åŒºï¼ˆæŸä¸ªåˆ†åŒºæ¶ˆæ¯è¿‡å¤šï¼‰
- é¢„ç•™æ‰©å±•ç©ºé—´ï¼ˆåˆ†åŒºæ•°ä¸æ˜“ä¿®æ”¹ï¼‰
```

**ğŸ”¹ å¯é æ€§æœºåˆ¶çš„å±‚æ¬¡**
```
å‘é€å¯é æ€§ï¼š
- åŒæ­¥å‘é€ + é‡è¯•æœºåˆ¶
- å‘é€å¤±è´¥æœ¬åœ°å­˜å‚¨
- ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜

å­˜å‚¨å¯é æ€§ï¼š
- MQæŒä¹…åŒ–å­˜å‚¨
- å¤šå‰¯æœ¬æœºåˆ¶
- å®šæœŸå¤‡ä»½

æ¶ˆè´¹å¯é æ€§ï¼š
- æ‰‹åŠ¨ACKç¡®è®¤
- å¤±è´¥é‡è¯•æœºåˆ¶
- æ­»ä¿¡é˜Ÿåˆ—å…œåº•
```

### 12.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä¸šåŠ¡åœºæ™¯**
- **æ•°æ®åŒæ­¥**ï¼šä¸»åº“å˜æ›´åŒæ­¥åˆ°ä»åº“ã€ç¼“å­˜ã€æœç´¢å¼•æ“
- **äº‹ä»¶é©±åŠ¨**ï¼šè®¢å•çŠ¶æ€å˜æ›´è§¦å‘åº“å­˜ã€ç§¯åˆ†ã€é€šçŸ¥ç­‰æ“ä½œ
- **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ•°æ®å˜æ›´ï¼Œç”¨äºå®¡è®¡å’Œå›æº¯
- **å®æ—¶è®¡ç®—**ï¼šå˜æ›´æ•°æ®å®æ—¶æ¨é€åˆ°æµè®¡ç®—å¹³å°

**ğŸ”§ æœ€ä½³å®è·µå»ºè®®**
```
é…ç½®ä¼˜åŒ–ï¼š
- æ ¹æ®ä¸šåŠ¡é‡åˆç†è®¾ç½®åˆ†åŒºæ•°
- è°ƒæ•´æ‰¹æ¬¡å¤§å°å¹³è¡¡å»¶è¿Ÿå’Œååé‡
- é…ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•å‚æ•°

ç›‘æ§å‘Šè­¦ï¼š
- é‡ç‚¹ç›‘æ§æ¶ˆæ¯å †ç§¯å’Œå¤„ç†å»¶è¿Ÿ
- è®¾ç½®å¤šçº§å‘Šè­¦é˜ˆå€¼
- å»ºç«‹å®Œå–„çš„åº”æ€¥å¤„ç†æµç¨‹

æ•…éšœå¤„ç†ï¼š
- å»ºç«‹æ¶ˆæ¯å †ç§¯çš„åº”æ€¥å¤„ç†é¢„æ¡ˆ
- å‡†å¤‡æ‰‹åŠ¨æ•°æ®è¡¥å¿æ–¹æ¡ˆ
- å®šæœŸæ¼”ç»ƒæ•…éšœæ¢å¤æµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Canalé…MQå¥½å¤„å¤šï¼Œè§£è€¦å¼‚æ­¥æ€§èƒ½ä½³
- ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—å„æœ‰é•¿ï¼ŒæŒ‰éœ€é€‰æ‹©æœ€é‡è¦
- åˆ†åŒºé¡ºåºè¦ä¿è¯ï¼Œé‡å¤ä¸¢å¤±è¦é¢„é˜²
- ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œé—®é¢˜å‘ç°è¦è¶æ—©