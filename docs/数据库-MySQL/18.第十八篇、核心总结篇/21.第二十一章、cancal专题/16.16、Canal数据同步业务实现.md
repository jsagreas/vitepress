---
title: 16ã€Canalæ•°æ®åŒæ­¥ä¸šåŠ¡å®ç°
---
## ğŸ“š ç›®å½•

1. [Canalæ•°æ®åŒæ­¥æ¦‚è¿°](#1-Canalæ•°æ®åŒæ­¥æ¦‚è¿°)
2. [ç¼“å­˜åŒæ­¥ç­–ç•¥](#2-ç¼“å­˜åŒæ­¥ç­–ç•¥)
3. [æœç´¢å¼•æ“æ›´æ–°](#3-æœç´¢å¼•æ“æ›´æ–°)
4. [æ•°æ®ä»“åº“ETL](#4-æ•°æ®ä»“åº“ETL)
5. [å®æ—¶è®¡ç®—è§¦å‘](#5-å®æ—¶è®¡ç®—è§¦å‘)
6. [ä¸šåŠ¡äº‹ä»¶å‘å¸ƒ](#6-ä¸šåŠ¡äº‹ä»¶å‘å¸ƒ)
7. [æ•°æ®ä¸€è‡´æ€§ä¿éšœ](#7-æ•°æ®ä¸€è‡´æ€§ä¿éšœ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ Canalæ•°æ®åŒæ­¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Canalæ•°æ®åŒæ­¥


**Canalæ•°æ®åŒæ­¥**ï¼šæŠŠMySQLæ•°æ®åº“çš„å˜æ›´å®æ—¶æ¨é€åˆ°å…¶ä»–ç³»ç»Ÿçš„è¿‡ç¨‹

```
ç®€å•ç†è§£ï¼š
MySQLæ•°æ®å˜äº† â†’ Canalç›‘å¬åˆ°å˜åŒ– â†’ é€šçŸ¥å…¶ä»–ç³»ç»Ÿæ›´æ–°

å°±åƒï¼š
ä½ æ›´æ–°äº†æœ‹å‹åœˆ â†’ å¾®ä¿¡è‡ªåŠ¨é€šçŸ¥å¥½å‹ â†’ å¥½å‹çœ‹åˆ°æœ€æ–°åŠ¨æ€
```

**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åŒæ­¥**ï¼Ÿ
- ğŸ”¸ **ç¼“å­˜æ›´æ–°**ï¼šæ•°æ®åº“æ”¹äº†ï¼Œç¼“å­˜ä¹Ÿè¦è·Ÿç€æ”¹
- ğŸ”¸ **æœç´¢åŒæ­¥**ï¼šå•†å“ä¿¡æ¯å˜äº†ï¼Œæœç´¢ç»“æœä¹Ÿè¦æ›´æ–°
- ğŸ”¸ **æ•°æ®åˆ†æ**ï¼šä¸šåŠ¡æ•°æ®è¦åŒæ­¥åˆ°æ•°æ®ä»“åº“åšåˆ†æ
- ğŸ”¸ **æ¶ˆæ¯é€šçŸ¥**ï¼šè®¢å•çŠ¶æ€å˜äº†è¦é€šçŸ¥ç”¨æˆ·

### 1.2 Canalåœ¨æ•°æ®åŒæ­¥ä¸­çš„ä½œç”¨


```
ä¼ ç»Ÿæ–¹å¼ï¼š                    Canalæ–¹å¼ï¼š
åº”ç”¨ç¨‹åº                      åº”ç”¨ç¨‹åº
    â†“                           â†“
  æ›´æ–°æ•°æ®åº“                    æ›´æ–°æ•°æ®åº“
    â†“                           â†“
  æ‰‹åŠ¨æ›´æ–°ç¼“å­˜                Canalè‡ªåŠ¨ç›‘å¬ 
    â†“                           â†“
  æ‰‹åŠ¨æ›´æ–°æœç´¢                 è‡ªåŠ¨åŒæ­¥åˆ°å„ç³»ç»Ÿ
    â†“
  æ‰‹åŠ¨é€šçŸ¥å…¶ä»–ç³»ç»Ÿ

é—®é¢˜ï¼šå®¹æ˜“é—æ¼ï¼Œä¸å®æ—¶          ä¼˜åŠ¿ï¼šè‡ªåŠ¨åŒ–ï¼Œå®æ—¶æ€§å¼º
```

### 1.3 æ•°æ®åŒæ­¥çš„æ ¸å¿ƒåœºæ™¯


**ğŸ”¸ ç”µå•†ç³»ç»Ÿç¤ºä¾‹**
```
ç”¨æˆ·åœºæ™¯ï¼šå•†å®¶ä¿®æ”¹å•†å“ä»·æ ¼ä»99å…ƒæ”¹ä¸º89å…ƒ

åŒæ­¥é“¾è·¯ï¼š
å•†å“æ•°æ®åº“ â†’ Canalç›‘å¬ â†’ åŒæ­¥åˆ°ï¼š
  â”œâ”€â”€ Redisç¼“å­˜ï¼ˆç”¨æˆ·çœ‹åˆ°æ–°ä»·æ ¼ï¼‰
  â”œâ”€â”€ Elasticsearchï¼ˆæœç´¢ç»“æœæ›´æ–°ï¼‰  
  â”œâ”€â”€ æ•°æ®ä»“åº“ï¼ˆåˆ†æä»·æ ¼è¶‹åŠ¿ï¼‰
  â””â”€â”€ æ¨èç³»ç»Ÿï¼ˆé‡æ–°è®¡ç®—æ¨èï¼‰
```

---

## 2. ğŸ’¾ ç¼“å­˜åŒæ­¥ç­–ç•¥


### 2.1 ç¼“å­˜åŒæ­¥çš„åŸºæœ¬æ¦‚å¿µ


**ç¼“å­˜åŒæ­¥**ï¼šæ•°æ®åº“æ•°æ®å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°ç¼“å­˜ä¸­çš„å¯¹åº”æ•°æ®

```
ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜åŒæ­¥ï¼Ÿ

åœºæ™¯ï¼šç”¨æˆ·æŸ¥çœ‹å•†å“è¯¦æƒ…
1. å…ˆæŸ¥Redisç¼“å­˜ï¼ˆå¿«ï¼Œ1msï¼‰
2. ç¼“å­˜æ²¡æœ‰å†æŸ¥æ•°æ®åº“ï¼ˆæ…¢ï¼Œ100msï¼‰

é—®é¢˜ï¼šæ•°æ®åº“æ›´æ–°äº†ï¼Œç¼“å­˜è¿˜æ˜¯æ—§æ•°æ®
ç»“æœï¼šç”¨æˆ·çœ‹åˆ°é”™è¯¯ä¿¡æ¯
```

### 2.2 å¸¸è§ç¼“å­˜åŒæ­¥æ¨¡å¼


#### ğŸ”„ ç›´æ¥æ›´æ–°æ¨¡å¼


**å·¥ä½œåŸç†**ï¼šæ•°æ®å˜åŒ–æ—¶ç›´æ¥æ›´æ–°ç¼“å­˜
```java
// Canalç›‘å¬å™¨ç¤ºä¾‹
@Component
public class CacheUpdateListener {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // ç›‘å¬å•†å“è¡¨å˜åŒ–
    public void handleProductChange(CanalEntry entry) {
        if ("product".equals(entry.getTableName())) {
            Long productId = entry.getProductId();
            Product product = productService.getById(productId);
            
            // ç›´æ¥æ›´æ–°ç¼“å­˜
            String cacheKey = "product:" + productId;
            redisTemplate.set(cacheKey, product, 3600);
        }
    }
}
```

**ä¼˜ç‚¹**ï¼šæ•°æ®å®æ—¶æ€§å¥½
**ç¼ºç‚¹**ï¼šå¦‚æœç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´

#### ğŸ—‘ï¸ åˆ é™¤ç¼“å­˜æ¨¡å¼


**å·¥ä½œåŸç†**ï¼šæ•°æ®å˜åŒ–æ—¶åˆ é™¤ç¼“å­˜ï¼Œè®©ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°åŠ è½½
```java
public void handleProductChange(CanalEntry entry) {
    if ("product".equals(entry.getTableName())) {
        Long productId = entry.getProductId();
        
        // åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½
        String cacheKey = "product:" + productId;
        redisTemplate.delete(cacheKey);
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•å¯é ï¼Œä¸ä¼šæœ‰è„æ•°æ®
**ç¼ºç‚¹**ï¼šä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¼šç¨æ…¢ï¼ˆéœ€è¦æŸ¥æ•°æ®åº“ï¼‰

### 2.3 ç¼“å­˜åŒæ­¥æœ€ä½³å®è·µ


**ğŸ”¸ å»¶è¿ŸåŒåˆ ç­–ç•¥**
```java
public void handleProductChange(CanalEntry entry) {
    Long productId = entry.getProductId();
    String cacheKey = "product:" + productId;
    
    // ç¬¬ä¸€æ¬¡åˆ é™¤
    redisTemplate.delete(cacheKey);
    
    // å»¶è¿Ÿå†åˆ é™¤ä¸€æ¬¡ï¼ˆé˜²æ­¢è¯»å†™å¹¶å‘é—®é¢˜ï¼‰
    scheduledExecutor.schedule(() -> {
        redisTemplate.delete(cacheKey);
    }, 500, TimeUnit.MILLISECONDS);
}
```

**ğŸ”¸ åˆ†å±‚ç¼“å­˜ç­–ç•¥**
```
L1ç¼“å­˜ï¼ˆåº”ç”¨å†…å­˜ï¼‰â†’ åˆ é™¤ç­–ç•¥ï¼Œå“åº”å¿«
L2ç¼“å­˜ï¼ˆRedisï¼‰   â†’ æ›´æ–°ç­–ç•¥ï¼Œæ•°æ®å‡†ç¡®
L3ç¼“å­˜ï¼ˆæ•°æ®åº“ï¼‰  â†’ æ•°æ®æºå¤´
```

---

## 3. ğŸ” æœç´¢å¼•æ“æ›´æ–°


### 3.1 æœç´¢å¼•æ“åŒæ­¥çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥åˆ°æœç´¢å¼•æ“**ï¼Ÿ

```
ç”¨æˆ·åœºæ™¯ï¼šåœ¨ç”µå•†ç½‘ç«™æœç´¢"æ‰‹æœº"

æœç´¢æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥å…³é”®è¯ â†’ ElasticsearchæŸ¥è¯¢ â†’ è¿”å›å•†å“åˆ—è¡¨

é—®é¢˜ï¼š
- å•†å®¶ä¸Šæ¶æ–°æ‰‹æœºï¼Œä½†æœç´¢ä¸åˆ°
- å•†å“ä¸‹æ¶äº†ï¼Œæœç´¢è¿˜èƒ½æ‰¾åˆ°
- ä»·æ ¼å˜äº†ï¼Œæœç´¢æ˜¾ç¤ºè¿˜æ˜¯è€ä»·æ ¼
```

### 3.2 ElasticsearchåŒæ­¥å®ç°


**ğŸ”¸ åŸºç¡€åŒæ­¥å®ç°**
```java
@Component
public class ElasticsearchSyncListener {
    
    @Autowired
    private ElasticsearchTemplate esTemplate;
    
    public void handleProductChange(CanalEntry entry) {
        String operation = entry.getEventType();
        Long productId = entry.getProductId();
        
        switch (operation) {
            case "INSERT":
            case "UPDATE":
                syncProductToES(productId);
                break;
            case "DELETE":
                deleteProductFromES(productId);
                break;
        }
    }
    
    private void syncProductToES(Long productId) {
        // ä»æ•°æ®åº“è·å–æœ€æ–°å•†å“ä¿¡æ¯
        Product product = productService.getById(productId);
        
        // è½¬æ¢ä¸ºESæ–‡æ¡£æ ¼å¼
        ProductDocument doc = convertToDocument(product);
        
        // æ›´æ–°åˆ°ES
        esTemplate.save(doc);
    }
}
```

### 3.3 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


**ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ›´æ–°**ï¼Ÿ
- å‡å°‘ESæœåŠ¡å™¨å‹åŠ›
- æé«˜åŒæ­¥æ•ˆç‡
- é¿å…é¢‘ç¹ç½‘ç»œè¯·æ±‚

```java
@Component
public class BatchESUpdateListener {
    
    private List<ProductDocument> batchBuffer = new ArrayList<>();
    private static final int BATCH_SIZE = 100;
    
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void flushBatch() {
        if (!batchBuffer.isEmpty()) {
            esTemplate.save(batchBuffer);
            batchBuffer.clear();
        }
    }
    
    public void handleProductChange(CanalEntry entry) {
        ProductDocument doc = convertToDocument(entry);
        batchBuffer.add(doc);
        
        // ç¼“å†²åŒºæ»¡äº†ç«‹å³åˆ·æ–°
        if (batchBuffer.size() >= BATCH_SIZE) {
            flushBatch();
        }
    }
}
```

---

## 4. ğŸ“Š æ•°æ®ä»“åº“ETL


### 4.1 ä»€ä¹ˆæ˜¯æ•°æ®ä»“åº“ETL


**ETL**ï¼šExtractï¼ˆæå–ï¼‰ã€Transformï¼ˆè½¬æ¢ï¼‰ã€Loadï¼ˆåŠ è½½ï¼‰

```
ç®€å•ç†è§£ï¼š
Extractï¼ˆæå–ï¼‰ï¼šä»MySQLæŠŠæ•°æ®æ‹¿å‡ºæ¥
Transformï¼ˆè½¬æ¢ï¼‰ï¼šæŠŠæ•°æ®æ”¹æˆåˆ†æéœ€è¦çš„æ ¼å¼  
Loadï¼ˆåŠ è½½ï¼‰ï¼šæŠŠæ•°æ®æ”¾åˆ°æ•°æ®ä»“åº“é‡Œ

å°±åƒæ¬å®¶ï¼š
æå– = æŠŠä¸œè¥¿ä»è€æˆ¿å­æ‹¿å‡ºæ¥
è½¬æ¢ = æ•´ç†æ‰“åŒ…æˆåˆé€‚çš„æ ·å­
åŠ è½½ = æ”¾åˆ°æ–°æˆ¿å­çš„åˆé€‚ä½ç½®
```

### 4.2 å®æ—¶ETLå®ç°


**ğŸ”¸ æ•°æ®æå–å’Œè½¬æ¢**
```java
@Component
public class DataWarehouseETLListener {
    
    public void handleOrderChange(CanalEntry entry) {
        if ("orders".equals(entry.getTableName())) {
            
            // æå–ï¼šè·å–è®¢å•æ•°æ®
            OrderData orderData = extractOrderData(entry);
            
            // è½¬æ¢ï¼šè½¬æ¢ä¸ºæ•°ä»“æ ¼å¼
            DWOrderFact dwOrder = transformToDWFormat(orderData);
            
            // åŠ è½½ï¼šå†™å…¥æ•°æ®ä»“åº“
            loadToDataWarehouse(dwOrder);
        }
    }
    
    private DWOrderFact transformToDWFormat(OrderData order) {
        return DWOrderFact.builder()
            .orderId(order.getId())
            .userId(order.getUserId())
            .amount(order.getAmount())
            .orderDate(order.getCreateTime())
            .userAge(getUserAge(order.getUserId())) // å…³è”ç”¨æˆ·å¹´é¾„
            .productCategory(getProductCategory(order.getProductId())) // å…³è”å•†å“åˆ†ç±»
            .build();
    }
}
```

### 4.3 ç»´åº¦è¡¨åŒæ­¥


**ä»€ä¹ˆæ˜¯ç»´åº¦è¡¨**ï¼Ÿ
- å­˜å‚¨æè¿°æ€§ä¿¡æ¯çš„è¡¨ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ã€å•†å“åˆ†ç±»ï¼‰
- å˜åŒ–ç›¸å¯¹è¾ƒå°‘ï¼Œä½†å¾ˆé‡è¦

```java
// ç”¨æˆ·ç»´åº¦è¡¨åŒæ­¥
public void handleUserDimensionChange(CanalEntry entry) {
    if ("users".equals(entry.getTableName())) {
        
        UserData userData = extractUserData(entry);
        
        // è½¬æ¢ä¸ºç»´åº¦è¡¨æ ¼å¼
        DWUserDim userDim = DWUserDim.builder()
            .userId(userData.getId())
            .userName(userData.getName())
            .ageGroup(getAgeGroup(userData.getAge())) // å¹´é¾„åˆ†ç»„
            .cityLevel(getCityLevel(userData.getCity())) // åŸå¸‚ç­‰çº§
            .createDate(userData.getCreateTime().toLocalDate())
            .build();
            
        // æ›´æ–°ç»´åº¦è¡¨
        dataWarehouseService.updateUserDimension(userDim);
    }
}

private String getAgeGroup(int age) {
    if (age < 18) return "æœªæˆå¹´";
    if (age < 30) return "é’å¹´";
    if (age < 50) return "ä¸­å¹´"; 
    return "è€å¹´";
}
```

---

## 5. âš¡ å®æ—¶è®¡ç®—è§¦å‘


### 5.1 å®æ—¶è®¡ç®—çš„åº”ç”¨åœºæ™¯


**å®æ—¶è®¡ç®—**ï¼šæ•°æ®ä¸€å˜åŒ–å°±ç«‹å³é‡æ–°è®¡ç®—ç›¸å…³æŒ‡æ ‡

```
å¸¸è§åœºæ™¯ï¼š

ğŸ”¸ å®æ—¶æ¨èç³»ç»Ÿ
ç”¨æˆ·è´­ä¹°äº†æ‰‹æœº â†’ ç«‹å³æ›´æ–°æ¨èç®—æ³• â†’ æ¨èæ‰‹æœºé…ä»¶

ğŸ”¸ å®æ—¶é£æ§ç³»ç»Ÿ  
æ£€æµ‹åˆ°å¼‚å¸¸äº¤æ˜“ â†’ ç«‹å³è®¡ç®—é£é™©åˆ†æ•° â†’ å¯èƒ½å†»ç»“è´¦æˆ·

ğŸ”¸ å®æ—¶è¥é”€ç³»ç»Ÿ
ç”¨æˆ·æµè§ˆå•†å“ â†’ å®æ—¶è®¡ç®—è´­ä¹°æ¦‚ç‡ â†’ æ¨é€ä¼˜æƒ åˆ¸
```

### 5.2 åŸºäºCanalçš„å®æ—¶è®¡ç®—è§¦å‘


```java
@Component
public class RealTimeComputingTrigger {
    
    @Autowired
    private RecommendationService recommendationService;
    
    public void handleUserBehaviorChange(CanalEntry entry) {
        
        if ("user_orders".equals(entry.getTableName())) {
            // ç”¨æˆ·ä¸‹å•ï¼Œè§¦å‘æ¨èé‡ç®—
            Long userId = entry.getUserId();
            Long productId = entry.getProductId();
            
            // å¼‚æ­¥è§¦å‘æ¨èç®—æ³•
            CompletableFuture.runAsync(() -> {
                recommendationService.updateUserProfile(userId, productId);
                recommendationService.refreshRecommendations(userId);
            });
        }
        
        if ("user_clicks".equals(entry.getTableName())) {
            // ç”¨æˆ·ç‚¹å‡»ï¼Œæ›´æ–°çƒ­åº¦
            Long productId = entry.getProductId();
            
            // æ›´æ–°å•†å“çƒ­åº¦åˆ†æ•°
            heatScoreService.incrementHeat(productId);
        }
    }
}
```

### 5.3 æµå¼è®¡ç®—é›†æˆ


**ä¸Flinkç­‰æµè®¡ç®—å¼•æ“é›†æˆ**
```java
// å‘é€åˆ°Kafkaï¼Œç”±Flinkå¤„ç†
@Component  
public class StreamComputingTrigger {
    
    @Autowired
    private KafkaTemplate kafkaTemplate;
    
    public void handleDataChange(CanalEntry entry) {
        
        // æ„é€ äº‹ä»¶æ¶ˆæ¯
        StreamEvent event = StreamEvent.builder()
            .eventType(entry.getEventType())
            .tableName(entry.getTableName())
            .data(entry.getData())
            .timestamp(System.currentTimeMillis())
            .build();
            
        // å‘é€åˆ°Kafka Topicï¼Œç”±Flinkå®æ—¶å¤„ç†
        kafkaTemplate.send("real-time-events", event);
    }
}
```

---

## 6. ğŸ“¢ ä¸šåŠ¡äº‹ä»¶å‘å¸ƒ


### 6.1 ä»€ä¹ˆæ˜¯ä¸šåŠ¡äº‹ä»¶å‘å¸ƒ


**ä¸šåŠ¡äº‹ä»¶**ï¼šæŠŠæ•°æ®åº“å˜åŒ–è½¬æ¢æˆæœ‰ä¸šåŠ¡å«ä¹‰çš„äº‹ä»¶æ¶ˆæ¯

```
æ•°æ®åº“å˜åŒ– â†’ ä¸šåŠ¡äº‹ä»¶

ä¾‹å­ï¼š
ordersè¡¨æ’å…¥ä¸€æ¡è®°å½• â†’ å‘å¸ƒ"è®¢å•åˆ›å»ºäº‹ä»¶"
ordersè¡¨çŠ¶æ€æ”¹ä¸º"å·²æ”¯ä»˜" â†’ å‘å¸ƒ"è®¢å•æ”¯ä»˜äº‹ä»¶"  
ordersè¡¨çŠ¶æ€æ”¹ä¸º"å·²å‘è´§" â†’ å‘å¸ƒ"è®¢å•å‘è´§äº‹ä»¶"
```

### 6.2 äº‹ä»¶å‘å¸ƒå®ç°


**ğŸ”¸ åŸºç¡€äº‹ä»¶å‘å¸ƒ**
```java
@Component
public class BusinessEventPublisher {
    
    @Autowired
    private EventBus eventBus;
    
    public void handleOrderChange(CanalEntry entry) {
        String eventType = entry.getEventType();
        OrderData orderData = entry.getOrderData();
        
        if ("INSERT".equals(eventType)) {
            // å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
            OrderCreatedEvent event = new OrderCreatedEvent(
                orderData.getOrderId(), 
                orderData.getUserId(),
                orderData.getAmount()
            );
            eventBus.publish(event);
        }
        
        if ("UPDATE".equals(eventType)) {
            String oldStatus = entry.getOldData().getStatus();
            String newStatus = entry.getNewData().getStatus();
            
            if ("PAID".equals(newStatus) && !"PAID".equals(oldStatus)) {
                // å‘å¸ƒè®¢å•æ”¯ä»˜äº‹ä»¶
                OrderPaidEvent event = new OrderPaidEvent(orderData.getOrderId());
                eventBus.publish(event);
            }
        }
    }
}
```

### 6.3 äº‹ä»¶è·¯ç”±å’Œå¤„ç†


**ğŸ”¸ å¤šä¸ªç³»ç»Ÿè®¢é˜…åŒä¸€äº‹ä»¶**
```java
// è®¢å•æ”¯ä»˜äº‹ä»¶çš„å¤šä¸ªå¤„ç†å™¨

@EventListener
public class InventoryEventHandler {
    // è®¢å•æ”¯ä»˜åï¼Œæ‰£å‡åº“å­˜
    public void handleOrderPaid(OrderPaidEvent event) {
        inventoryService.decreaseStock(event.getOrderId());
    }
}

@EventListener  
public class NotificationEventHandler {
    // è®¢å•æ”¯ä»˜åï¼Œå‘é€é€šçŸ¥
    public void handleOrderPaid(OrderPaidEvent event) {
        notificationService.sendPaymentSuccess(event.getOrderId());
    }
}

@EventListener
public class PointsEventHandler {
    // è®¢å•æ”¯ä»˜åï¼Œå¢åŠ ç§¯åˆ†
    public void handleOrderPaid(OrderPaidEvent event) {
        pointsService.addPoints(event.getUserId(), event.getAmount());
    }
}
```

---

## 7. ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§ä¿éšœ


### 7.1 æ•°æ®ä¸€è‡´æ€§çš„æŒ‘æˆ˜


**ä¸€è‡´æ€§é—®é¢˜**ï¼šæ•°æ®åœ¨ä¸åŒç³»ç»Ÿé—´å¯èƒ½ä¸ä¸€è‡´

```
é—®é¢˜åœºæ™¯ï¼š
MySQLï¼šå•†å“ä»·æ ¼100å…ƒ
Redisï¼šå•†å“ä»·æ ¼è¿˜æ˜¯120å…ƒï¼ˆåŒæ­¥å¤±è´¥ï¼‰
ç”¨æˆ·çœ‹åˆ°ï¼š120å…ƒï¼ˆé”™è¯¯ä»·æ ¼ï¼‰

åŸå› ï¼š
- ç½‘ç»œå¼‚å¸¸å¯¼è‡´åŒæ­¥å¤±è´¥
- åŒæ­¥ç¨‹åºå‡ºé”™
- ç³»ç»Ÿé‡å¯æ—¶æ•°æ®ä¸¢å¤±
```

### 7.2 å†²çªè§£å†³ç­–ç•¥


**ğŸ”¸ æ—¶é—´æˆ³ç­–ç•¥**
```java
public class ConflictResolver {
    
    public void resolveConflict(ProductData mysqlData, ProductData cacheData) {
        
        // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œé€‰æ‹©æœ€æ–°çš„æ•°æ®
        if (mysqlData.getUpdateTime().isAfter(cacheData.getUpdateTime())) {
            // MySQLæ•°æ®æ›´æ–°ï¼Œæ›´æ–°ç¼“å­˜
            cacheService.updateProduct(mysqlData);
        } else {
            // ç¼“å­˜æ•°æ®æ›´æ–°ï¼Œè¯´æ˜å¯èƒ½æœ‰é—®é¢˜ï¼Œè®°å½•æ—¥å¿—
            logger.warn("Cache data is newer than MySQL data: {}", mysqlData.getId());
        }
    }
}
```

**ğŸ”¸ ç‰ˆæœ¬å·ç­–ç•¥**
```java
public class VersionBasedResolver {
    
    public void handleProductUpdate(CanalEntry entry) {
        ProductData newData = entry.getNewData();
        ProductData cacheData = cacheService.getProduct(newData.getId());
        
        if (cacheData != null && newData.getVersion() <= cacheData.getVersion()) {
            // ç‰ˆæœ¬å·æ²¡æœ‰å¢åŠ ï¼Œå¯èƒ½æ˜¯é‡å¤å¤„ç†ï¼Œå¿½ç•¥
            logger.info("Duplicate or old version data, ignored: {}", newData.getId());
            return;
        }
        
        // æ›´æ–°ç¼“å­˜
        cacheService.updateProduct(newData);
    }
}
```

### 7.3 æ•°æ®è¡¥å¿æœºåˆ¶


**ğŸ”¸ å®šæœŸæ ¡éªŒå’Œä¿®å¤**
```java
@Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public class DataConsistencyChecker {
    
    public void checkAndRepair() {
        
        // æ£€æŸ¥MySQLå’ŒRedisçš„æ•°æ®ä¸€è‡´æ€§
        List<Product> inconsistentProducts = findInconsistentProducts();
        
        for (Product product : inconsistentProducts) {
            // ä»¥MySQLæ•°æ®ä¸ºå‡†ï¼Œä¿®å¤ç¼“å­˜
            cacheService.updateProduct(product);
            
            logger.info("Repaired inconsistent product: {}", product.getId());
        }
    }
    
    private List<Product> findInconsistentProducts() {
        // æŠ½æ ·æ£€æŸ¥ä¸€äº›å•†å“æ•°æ®
        List<Long> sampleIds = getSampleProductIds();
        List<Product> inconsistent = new ArrayList<>();
        
        for (Long id : sampleIds) {
            Product mysqlProduct = productService.getById(id);
            Product cacheProduct = cacheService.getProduct(id);
            
            if (!Objects.equals(mysqlProduct, cacheProduct)) {
                inconsistent.add(mysqlProduct);
            }
        }
        
        return inconsistent;
    }
}
```

### 7.4 åŒæ­¥å»¶è¿Ÿç›‘æ§


**ğŸ”¸ å»¶è¿Ÿç›‘æ§å®ç°**
```java
@Component
public class SyncDelayMonitor {
    
    private final MeterRegistry meterRegistry;
    
    public void recordSyncDelay(CanalEntry entry) {
        long dbChangeTime = entry.getExecuteTime();
        long currentTime = System.currentTimeMillis();
        long delay = currentTime - dbChangeTime;
        
        // è®°å½•å»¶è¿ŸæŒ‡æ ‡
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("canal.sync.delay")
            .tag("table", entry.getTableName())
            .register(meterRegistry));
            
        // å»¶è¿Ÿè¿‡é«˜å‘Šè­¦
        if (delay > 10000) { // è¶…è¿‡10ç§’
            alertService.sendAlert("Canal sync delay too high: " + delay + "ms");
        }
    }
}
```

### 7.5 ä¸šåŠ¡é™çº§æ–¹æ¡ˆ


**ğŸ”¸ ç¼“å­˜é™çº§ç­–ç•¥**
```java
@Component
public class CacheFallbackHandler {
    
    public Product getProduct(Long productId) {
        try {
            // ä¼˜å…ˆä»ç¼“å­˜è·å–
            Product product = cacheService.getProduct(productId);
            if (product != null) {
                return product;
            }
        } catch (Exception e) {
            logger.warn("Cache access failed, fallback to database", e);
        }
        
        // ç¼“å­˜å¤±è´¥ï¼Œé™çº§åˆ°æ•°æ®åº“
        return productService.getById(productId);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Canalæ•°æ®åŒæ­¥æœ¬è´¨ï¼šæŠŠMySQLå˜åŒ–å®æ—¶æ¨é€åˆ°å…¶ä»–ç³»ç»Ÿ
ğŸ”¸ ç¼“å­˜åŒæ­¥ç­–ç•¥ï¼šç›´æ¥æ›´æ–° vs åˆ é™¤ç¼“å­˜ï¼Œå„æœ‰ä¼˜åŠ£
ğŸ”¸ æœç´¢å¼•æ“åŒæ­¥ï¼šä¿è¯æœç´¢ç»“æœä¸æ•°æ®åº“ä¸€è‡´
ğŸ”¸ ETLå®æ—¶åŒ–ï¼šæ•°æ®å˜åŒ–å³æ—¶è¿›å…¥æ•°æ®ä»“åº“
ğŸ”¸ äº‹ä»¶é©±åŠ¨æ¶æ„ï¼šæ•°æ®å˜åŒ–è§¦å‘ä¸šåŠ¡äº‹ä»¶
ğŸ”¸ ä¸€è‡´æ€§ä¿éšœï¼šè§£å†³å¤šç³»ç»Ÿé—´æ•°æ®ä¸ä¸€è‡´é—®é¢˜
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åŒæ­¥ç­–ç•¥é€‰æ‹©**
```
å®æ—¶æ€§è¦æ±‚é«˜ â†’ ç›´æ¥æ›´æ–°ç­–ç•¥
æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜ â†’ åˆ é™¤ç¼“å­˜ç­–ç•¥  
é«˜å¹¶å‘åœºæ™¯ â†’ æ‰¹é‡æ›´æ–°ç­–ç•¥
å¤æ‚ä¸šåŠ¡åœºæ™¯ â†’ äº‹ä»¶å‘å¸ƒç­–ç•¥
```

**ğŸ”¹ ä¸€è‡´æ€§æƒè¡¡**
```
å¼ºä¸€è‡´æ€§ï¼šç‰ºç‰²æ€§èƒ½ï¼Œä¿è¯æ•°æ®ç»å¯¹ä¸€è‡´
æœ€ç»ˆä¸€è‡´æ€§ï¼šå®¹å¿çŸ­æœŸä¸ä¸€è‡´ï¼Œè¿½æ±‚é«˜æ€§èƒ½
ä¸šåŠ¡ç›¸å…³ï¼šæ ¹æ®ä¸šåŠ¡é‡è¦æ€§é€‰æ‹©ç­–ç•¥
```

**ğŸ”¹ ç›‘æ§å’Œé™çº§**
```
ç›‘æ§æŒ‡æ ‡ï¼šåŒæ­¥å»¶è¿Ÿã€æˆåŠŸç‡ã€é”™è¯¯ç‡
å‘Šè­¦æœºåˆ¶ï¼šå»¶è¿Ÿè¿‡é«˜ã€åŒæ­¥å¤±è´¥åŠæ—¶å‘Šè­¦
é™çº§ç­–ç•¥ï¼šåŒæ­¥å¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
æ•°æ®ä¿®å¤ï¼šå®šæœŸæ ¡éªŒå’Œè‡ªåŠ¨ä¿®å¤æœºåˆ¶
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ“Š ä¸šåŠ¡åœºæ™¯åŒ¹é…**
- **ç”µå•†ç³»ç»Ÿ**ï¼šå•†å“ç¼“å­˜åŒæ­¥ã€æœç´¢æ›´æ–°ã€æ¨èè®¡ç®—
- **é‡‘èç³»ç»Ÿ**ï¼šé£æ§å®æ—¶è®¡ç®—ã€ç”¨æˆ·ç”»åƒæ›´æ–°  
- **å†…å®¹å¹³å°**ï¼šå†…å®¹æœç´¢åŒæ­¥ã€çƒ­åº¦è®¡ç®—ã€æ¨èåˆ·æ–°
- **ç‰©æµç³»ç»Ÿ**ï¼šçŠ¶æ€æ›´æ–°ã€è½¨è¿¹åŒæ­¥ã€å¼‚å¸¸å‘Šè­¦

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**
- **ç¼“å­˜åŒæ­¥**ï¼šRedisé›†ç¾¤ + åˆ é™¤ç­–ç•¥ï¼ˆæ¨èï¼‰
- **æœç´¢åŒæ­¥**ï¼šElasticsearch + æ‰¹é‡æ›´æ–°
- **äº‹ä»¶å‘å¸ƒ**ï¼šKafka + EventBus
- **ç›‘æ§å‘Šè­¦**ï¼šPrometheus + Grafana

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
- ä¸è¦ç›²ç›®è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½
- åŒæ­¥å¤±è´¥è¦æœ‰é‡è¯•æœºåˆ¶ï¼Œä½†è¦é¿å…æ— é™é‡è¯•
- æ‰¹é‡å¤„ç†è¦æ§åˆ¶å¤§å°ï¼Œé¿å…å†…å­˜æº¢å‡º
- è¦æœ‰ç›‘æ§å’Œå‘Šè­¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

**æ ¸å¿ƒè®°å¿†**ï¼š
- Canalè®©æ•°æ®åŒæ­¥å˜ç®€å•ï¼Œå®æ—¶æ€§å¼ºæ•ˆæœå¥½
- ç¼“å­˜æœç´¢è¦åŒæ­¥ï¼ŒETLäº‹ä»¶ä¸èƒ½å°‘
- ä¸€è‡´æ€§ç›‘æ§éœ€åšå¥½ï¼Œé™çº§æ–¹æ¡ˆè¦å¯é 
- ä¸šåŠ¡åœºæ™¯å®šç­–ç•¥ï¼Œæ€§èƒ½å‡†ç¡®éœ€å¹³è¡¡