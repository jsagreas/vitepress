---
title: 14ã€Canalæ•°æ®è§£æä¸å¤„ç†
---
## ğŸ“š ç›®å½•

1. [Canalæ¶ˆæ¯ç»“æ„æ¦‚è¿°](#1-Canalæ¶ˆæ¯ç»“æ„æ¦‚è¿°)
2. [Entryæ¶ˆæ¯è¯¦è§£](#2-Entryæ¶ˆæ¯è¯¦è§£)
3. [RowChangeæ•°æ®å˜æ›´è§£æ](#3-RowChangeæ•°æ®å˜æ›´è§£æ)
4. [EventTypeäº‹ä»¶ç±»å‹å¤„ç†](#4-EventTypeäº‹ä»¶ç±»å‹å¤„ç†)
5. [RowDataè¡Œæ•°æ®è§£æ](#5-RowDataè¡Œæ•°æ®è§£æ)
6. [Columnåˆ—æ•°æ®å¤„ç†](#6-Columnåˆ—æ•°æ®å¤„ç†)
7. [äº‹åŠ¡ä¿¡æ¯è·å–](#7-äº‹åŠ¡ä¿¡æ¯è·å–)
8. [DDLè¯­å¥è§£æ](#8-DDLè¯­å¥è§£æ)
9. [æ•°æ®ç±»å‹è½¬æ¢ä¸å¤„ç†](#9-æ•°æ®ç±»å‹è½¬æ¢ä¸å¤„ç†)
10. [æ—¶é—´æˆ³ä¸ç©ºå€¼å¤„ç†](#10-æ—¶é—´æˆ³ä¸ç©ºå€¼å¤„ç†)
11. [å®é™…åº”ç”¨åœºæ™¯](#11-å®é™…åº”ç”¨åœºæ™¯)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Canalæ¶ˆæ¯ç»“æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Canalæ¶ˆæ¯


**é€šä¿—ç†è§£**ï¼šCanalæ¶ˆæ¯å°±åƒæ˜¯æ•°æ®åº“æ“ä½œçš„"å½•åƒå¸¦"ï¼Œè®°å½•äº†æ•°æ®åº“é‡Œå‘ç”Ÿçš„æ‰€æœ‰å˜åŒ–ã€‚

```
æ•°æ®åº“æ“ä½œ                Canalæ¶ˆæ¯
ç”¨æˆ·æ–°å¢ä¸€æ¡è®°å½•    â†’      INSERTäº‹ä»¶æ¶ˆæ¯
ç”¨æˆ·ä¿®æ”¹ä¸€æ¡è®°å½•    â†’      UPDATEäº‹ä»¶æ¶ˆæ¯  
ç”¨æˆ·åˆ é™¤ä¸€æ¡è®°å½•    â†’      DELETEäº‹ä»¶æ¶ˆæ¯
æ‰§è¡Œå»ºè¡¨è¯­å¥       â†’      DDLäº‹ä»¶æ¶ˆæ¯
```

### 1.2 Canalæ¶ˆæ¯çš„å±‚æ¬¡ç»“æ„


Canalçš„æ¶ˆæ¯æ˜¯**åˆ†å±‚åŒ…è£…**çš„ï¼Œå°±åƒä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·ï¼š

```
Message (æœ€å¤–å±‚åŒ…è£…)
  â”œâ”€â”€ Entry[] (å¤šä¸ªæ•°æ®å˜æ›´äº‹ä»¶)
      â”œâ”€â”€ Header (äº‹ä»¶å¤´ä¿¡æ¯)
      â””â”€â”€ StoreValue (å…·ä½“å˜æ›´å†…å®¹)
          â””â”€â”€ RowChange (è¡Œæ•°æ®å˜æ›´è¯¦æƒ…)
              â””â”€â”€ RowData[] (å…·ä½“çš„è¡Œæ•°æ®)
                  â”œâ”€â”€ beforeColumns[] (å˜æ›´å‰æ•°æ®)
                  â””â”€â”€ afterColumns[] (å˜æ›´åæ•°æ®)
```

### 1.3 æ ¸å¿ƒç»„ä»¶å…³ç³»


> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šCanalæ¶ˆæ¯å°±æ˜¯æŠŠMySQLçš„binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰ç¿»è¯‘æˆäº†æˆ‘ä»¬ç¨‹åºèƒ½ç†è§£çš„æ ¼å¼

**å„ç»„ä»¶ä½œç”¨**ï¼š
- **Message**ï¼šä¸€æ‰¹æ¶ˆæ¯çš„å®¹å™¨
- **Entry**ï¼šå•ä¸ªæ•°æ®åº“æ“ä½œäº‹ä»¶
- **RowChange**ï¼šå…·ä½“çš„æ•°æ®è¡Œå˜æ›´
- **Column**ï¼šæ•°æ®åº“è¡¨çš„åˆ—ä¿¡æ¯

---

## 2. ğŸ“¦ Entryæ¶ˆæ¯è¯¦è§£


### 2.1 Entryæ˜¯ä»€ä¹ˆ


**Entry**å°±æ˜¯Canalæ•è·åˆ°çš„**å•ä¸ªæ•°æ®åº“æ“ä½œäº‹ä»¶**ï¼Œå¯ä»¥ç†è§£ä¸º"ä¸€æ¬¡æ•°æ®åº“æ“ä½œçš„å®Œæ•´è®°å½•"ã€‚

### 2.2 Entryçš„ç»„æˆç»“æ„


```java
// Entryæ¶ˆæ¯çš„åŸºæœ¬ç»“æ„
Entry entry = message.getEntries().get(0);

// è·å–äº‹ä»¶å¤´ä¿¡æ¯
Header header = entry.getHeader();
System.out.println("æ•°æ®åº“åï¼š" + header.getSchemaName());
System.out.println("è¡¨åï¼š" + header.getTableName()); 
System.out.println("äº‹ä»¶ç±»å‹ï¼š" + header.getEventType());

// è·å–äº‹ä»¶å†…å®¹
EntryType entryType = entry.getEntryType();
```

### 2.3 Entryç±»å‹åˆ†ç±»


| Entryç±»å‹ | **å«ä¹‰** | **ä»€ä¹ˆæ—¶å€™å‡ºç°** |
|-----------|----------|------------------|
| `ROWDATA` | è¡Œæ•°æ®å˜æ›´ | INSERTã€UPDATEã€DELETEæ“ä½œ |
| `QUERY` | DDLè¯­å¥ | CREATEã€ALTERã€DROPç­‰è¯­å¥ |
| `TRANSACTIONBEGIN` | äº‹åŠ¡å¼€å§‹ | BEGIN TRANSACTION |
| `TRANSACTIONEND` | äº‹åŠ¡ç»“æŸ | COMMIT |

### 2.4 Entryå¤„ç†ç¤ºä¾‹


```java
public void processEntry(Entry entry) {
    Header header = entry.getHeader();
    
    // æ‰“å°åŸºæœ¬ä¿¡æ¯
    System.out.println("=== æ•°æ®åº“æ“ä½œè®°å½• ===");
    System.out.println("æ•°æ®åº“ï¼š" + header.getSchemaName());
    System.out.println("è¡¨åï¼š" + header.getTableName());
    System.out.println("æ“ä½œæ—¶é—´ï¼š" + new Date(header.getExecuteTime()));
    
    // æ ¹æ®ä¸åŒç±»å‹è¿›è¡Œå¤„ç†
    EntryType entryType = entry.getEntryType();
    if (entryType == EntryType.ROWDATA) {
        handleRowData(entry);  // å¤„ç†æ•°æ®å˜æ›´
    } else if (entryType == EntryType.QUERY) {
        handleDDL(entry);      // å¤„ç†DDLè¯­å¥
    }
}
```

---

## 3. ğŸ”„ RowChangeæ•°æ®å˜æ›´è§£æ


### 3.1 RowChangeæ˜¯ä»€ä¹ˆ


**RowChange**åŒ…å«äº†æ•°æ®è¡¨è¡Œçº§åˆ«å˜æ›´çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ˜¯æˆ‘ä»¬æœ€å…³å¿ƒçš„æ ¸å¿ƒæ•°æ®ã€‚

> ğŸ“ **é€šä¿—è§£é‡Š**ï¼šå¦‚æœè¯´Entryæ˜¯"å‘ç”Ÿäº†ä»€ä¹ˆäº‹"ï¼Œé‚£ä¹ˆRowChangeå°±æ˜¯"å…·ä½“æ€ä¹ˆå˜çš„"

### 3.2 è§£æRowChangeæ•°æ®


```java
public void handleRowData(Entry entry) {
    try {
        // è§£æRowChange
        RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
        
        // è·å–äº‹ä»¶ç±»å‹
        EventType eventType = rowChange.getEventType();
        System.out.println("æ“ä½œç±»å‹ï¼š" + eventType);
        
        // è·å–å˜æ›´çš„è¡Œæ•°æ®
        List<RowData> rowDataList = rowChange.getRowDatasList();
        System.out.println("å½±å“è¡Œæ•°ï¼š" + rowDataList.size());
        
        // å¤„ç†æ¯ä¸€è¡Œæ•°æ®
        for (RowData rowData : rowDataList) {
            processRowData(rowData, eventType);
        }
        
    } catch (Exception e) {
        System.err.println("è§£æRowChangeå¤±è´¥ï¼š" + e.getMessage());
    }
}
```

### 3.3 RowChangeå…³é”®å±æ€§


```java
// RowChangeåŒ…å«çš„é‡è¦ä¿¡æ¯
RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());

// 1. äº‹ä»¶ç±»å‹ï¼ˆINSERTã€UPDATEã€DELETEç­‰ï¼‰
EventType eventType = rowChange.getEventType();

// 2. è¡¨ç»“æ„ä¿¡æ¯
boolean isDdl = rowChange.getIsDdl();  // æ˜¯å¦DDLè¯­å¥
String sql = rowChange.getSql();       // åŸå§‹SQLè¯­å¥

// 3. è¡Œæ•°æ®åˆ—è¡¨
List<RowData> rowDataList = rowChange.getRowDatasList();

// 4. æ•°æ®åº“å’Œè¡¨ä¿¡æ¯
String database = entry.getHeader().getSchemaName();
String table = entry.getHeader().getTableName();
```

---

## 4. âš¡ EventTypeäº‹ä»¶ç±»å‹å¤„ç†


### 4.1 EventTypeäº‹ä»¶ç±»å‹è¯¦è§£


Canalæ”¯æŒå¤šç§æ•°æ®åº“æ“ä½œäº‹ä»¶ï¼Œæ¯ç§äº‹ä»¶ä»£è¡¨ä¸åŒçš„æ•°æ®åº“æ“ä½œï¼š

| äº‹ä»¶ç±»å‹ | **å«ä¹‰** | **è§¦å‘åœºæ™¯** | **å¤„ç†é‡ç‚¹** |
|----------|----------|--------------|--------------|
| `INSERT` | æ–°å¢æ•°æ® | `INSERT INTO table...` | å…³æ³¨ afterColumns |
| `UPDATE` | æ›´æ–°æ•°æ® | `UPDATE table SET...` | å¯¹æ¯” beforeColumns å’Œ afterColumns |
| `DELETE` | åˆ é™¤æ•°æ® | `DELETE FROM table...` | å…³æ³¨ beforeColumns |
| `CREATE` | åˆ›å»ºè¡¨ | `CREATE TABLE...` | è¡¨ç»“æ„å˜æ›´ |
| `ALTER` | ä¿®æ”¹è¡¨ | `ALTER TABLE...` | è¡¨ç»“æ„å˜æ›´ |
| `DROP` | åˆ é™¤è¡¨ | `DROP TABLE...` | è¡¨ç»“æ„å˜æ›´ |

### 4.2 ä¸åŒäº‹ä»¶ç±»å‹çš„å¤„ç†ç­–ç•¥


```java
public void processRowData(RowData rowData, EventType eventType) {
    switch (eventType) {
        case INSERT:
            handleInsert(rowData);
            break;
        case UPDATE:
            handleUpdate(rowData);
            break;
        case DELETE:
            handleDelete(rowData);
            break;
        default:
            System.out.println("æš‚ä¸å¤„ç†çš„äº‹ä»¶ç±»å‹ï¼š" + eventType);
    }
}

// å¤„ç†æ–°å¢äº‹ä»¶
private void handleInsert(RowData rowData) {
    System.out.println("=== æ–°å¢æ•°æ® ===");
    List<Column> afterColumns = rowData.getAfterColumnsList();
    for (Column column : afterColumns) {
        System.out.println(column.getName() + " = " + column.getValue());
    }
}

// å¤„ç†æ›´æ–°äº‹ä»¶
private void handleUpdate(RowData rowData) {
    System.out.println("=== æ›´æ–°æ•°æ® ===");
    List<Column> beforeColumns = rowData.getBeforeColumnsList();
    List<Column> afterColumns = rowData.getAfterColumnsList();
    
    // å¯¹æ¯”å˜æ›´å‰åçš„æ•°æ®
    for (int i = 0; i < afterColumns.size(); i++) {
        Column before = beforeColumns.get(i);
        Column after = afterColumns.get(i);
        
        if (!before.getValue().equals(after.getValue())) {
            System.out.println(after.getName() + ": " 
                + before.getValue() + " â†’ " + after.getValue());
        }
    }
}

// å¤„ç†åˆ é™¤äº‹ä»¶
private void handleDelete(RowData rowData) {
    System.out.println("=== åˆ é™¤æ•°æ® ===");
    List<Column> beforeColumns = rowData.getBeforeColumnsList();
    for (Column column : beforeColumns) {
        System.out.println(column.getName() + " = " + column.getValue());
    }
}
```

### 4.3 äº‹ä»¶è¿‡æ»¤å¤„ç†


```java
// åªå¤„ç†æˆ‘ä»¬å…³å¿ƒçš„äº‹ä»¶ç±»å‹
public boolean shouldProcess(EventType eventType) {
    Set<EventType> interestedEvents = Set.of(
        EventType.INSERT,
        EventType.UPDATE, 
        EventType.DELETE
    );
    return interestedEvents.contains(eventType);
}
```

---

## 5. ğŸ“Š RowDataè¡Œæ•°æ®è§£æ


### 5.1 RowDataæ˜¯ä»€ä¹ˆ


**RowData**ä»£è¡¨æ•°æ®è¡¨ä¸­ä¸€è¡Œæ•°æ®çš„å˜æ›´è®°å½•ï¼ŒåŒ…å«å˜æ›´å‰å’Œå˜æ›´åçš„å®Œæ•´åˆ—ä¿¡æ¯ã€‚

> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šRowDataå°±åƒæ˜¯"æ•°æ®çš„å¿«ç…§å¯¹æ¯”"ï¼Œè®°å½•äº†è¿™ä¸€è¡Œæ•°æ®å˜åŒ–çš„å‰åçŠ¶æ€

### 5.2 RowDataçš„ç»“æ„ç»„æˆ


```
RowData ç»“æ„ï¼š
â”œâ”€â”€ beforeColumns[]  â† å˜æ›´å‰çš„åˆ—æ•°æ®ï¼ˆUPDATEã€DELETEæ—¶æœ‰å€¼ï¼‰
â”œâ”€â”€ afterColumns[]   â† å˜æ›´åçš„åˆ—æ•°æ®ï¼ˆINSERTã€UPDATEæ—¶æœ‰å€¼ï¼‰
â””â”€â”€ props           â† é¢å¤–å±æ€§ä¿¡æ¯
```

### 5.3 ä¸åŒæ“ä½œç±»å‹çš„RowDataç‰¹ç‚¹


```java
public void analyzeRowData(RowData rowData, EventType eventType) {
    List<Column> beforeColumns = rowData.getBeforeColumnsList();
    List<Column> afterColumns = rowData.getAfterColumnsList();
    
    switch (eventType) {
        case INSERT:
            // æ–°å¢ï¼šåªæœ‰ afterColumns æœ‰æ•°æ®
            System.out.println("æ–°å¢è®°å½•ï¼ŒafterColumns æ•°é‡ï¼š" + afterColumns.size());
            System.out.println("beforeColumns æ•°é‡ï¼š" + beforeColumns.size()); // é€šå¸¸ä¸º0
            break;
            
        case UPDATE:
            // æ›´æ–°ï¼šbeforeColumns å’Œ afterColumns éƒ½æœ‰æ•°æ®
            System.out.println("æ›´æ–°è®°å½•");
            System.out.println("beforeColumns æ•°é‡ï¼š" + beforeColumns.size());
            System.out.println("afterColumns æ•°é‡ï¼š" + afterColumns.size());
            break;
            
        case DELETE:
            // åˆ é™¤ï¼šåªæœ‰ beforeColumns æœ‰æ•°æ®
            System.out.println("åˆ é™¤è®°å½•ï¼ŒbeforeColumns æ•°é‡ï¼š" + beforeColumns.size());
            System.out.println("afterColumns æ•°é‡ï¼š" + afterColumns.size()); // é€šå¸¸ä¸º0
            break;
    }
}
```

### 5.4 RowDataå®ç”¨å·¥å…·æ–¹æ³•


```java
public class RowDataHelper {
    
    // è·å–ä¸»é”®å€¼
    public static String getPrimaryKeyValue(RowData rowData) {
        List<Column> columns = rowData.getAfterColumnsList();
        if (columns.isEmpty()) {
            columns = rowData.getBeforeColumnsList();
        }
        
        for (Column column : columns) {
            if (column.getIsKey()) {  // ä¸»é”®åˆ—
                return column.getValue();
            }
        }
        return null;
    }
    
    // è½¬æ¢ä¸ºMapæ ¼å¼
    public static Map<String, String> toMap(List<Column> columns) {
        Map<String, String> result = new HashMap<>();
        for (Column column : columns) {
            result.put(column.getName(), column.getValue());
        }
        return result;
    }
    
    // è·å–å˜æ›´çš„å­—æ®µ
    public static Set<String> getChangedFields(RowData rowData) {
        Set<String> changedFields = new HashSet<>();
        List<Column> beforeColumns = rowData.getBeforeColumnsList();
        List<Column> afterColumns = rowData.getAfterColumnsList();
        
        for (int i = 0; i < afterColumns.size(); i++) {
            Column before = beforeColumns.get(i);
            Column after = afterColumns.get(i);
            
            if (!Objects.equals(before.getValue(), after.getValue())) {
                changedFields.add(after.getName());
            }
        }
        return changedFields;
    }
}
```

---

## 6. ğŸ“‹ Columnåˆ—æ•°æ®å¤„ç†


### 6.1 Columnæ˜¯ä»€ä¹ˆ


**Column**ä»£è¡¨æ•°æ®è¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µï¼ˆåˆ—ï¼‰ï¼ŒåŒ…å«äº†å­—æ®µåã€å€¼ã€ç±»å‹ç­‰å®Œæ•´ä¿¡æ¯ã€‚

> ğŸ“ **é€šä¿—è§£é‡Š**ï¼šColumnå°±æ˜¯è¡¨æ ¼ä¸­çš„ä¸€ä¸ªæ ¼å­ï¼Œè®°å½•äº†è¿™ä¸ªæ ¼å­çš„åç§°ã€å†…å®¹ã€æ•°æ®ç±»å‹ç­‰æ‰€æœ‰ä¿¡æ¯

### 6.2 Columnçš„é‡è¦å±æ€§


```java
public void analyzeColumn(Column column) {
    System.out.println("=== åˆ—ä¿¡æ¯åˆ†æ ===");
    System.out.println("åˆ—åï¼š" + column.getName());
    System.out.println("åˆ—å€¼ï¼š" + column.getValue());
    System.out.println("æ•°æ®ç±»å‹ï¼š" + column.getMysqlType());
    System.out.println("æ˜¯å¦ä¸»é”®ï¼š" + column.getIsKey());
    System.out.println("æ˜¯å¦ä¸ºç©ºï¼š" + column.getIsNull());
    System.out.println("æ˜¯å¦æ›´æ–°ï¼š" + column.getUpdated());
    System.out.println("SQLç±»å‹ï¼š" + column.getSqlType());
}
```

### 6.3 Columnå±æ€§è¯¦è§£è¡¨


| å±æ€§ | **å«ä¹‰** | **ç”¨é€”** | **ç¤ºä¾‹** |
|------|----------|----------|----------|
| `name` | åˆ—å | æ ‡è¯†å­—æ®µ | "user_id", "name" |
| `value` | åˆ—å€¼ | å®é™…æ•°æ® | "123", "å¼ ä¸‰" |
| `isKey` | æ˜¯å¦ä¸»é”® | è¯†åˆ«ä¸»é”® | true/false |
| `isNull` | æ˜¯å¦ä¸ºç©º | ç©ºå€¼åˆ¤æ–­ | true/false |
| `updated` | æ˜¯å¦å˜æ›´ | UPDATEæ—¶åˆ¤æ–­å“ªäº›å­—æ®µå˜äº† | true/false |
| `mysqlType` | MySQLç±»å‹ | åŸå§‹ç±»å‹ | "varchar(50)", "int(11)" |
| `sqlType` | SQLç±»å‹ç  | Javaç±»å‹è½¬æ¢ | 12, 4, 93 |

### 6.4 Columnæ•°æ®å¤„ç†å·¥å…·


```java
public class ColumnHelper {
    
    // å®‰å…¨è·å–åˆ—å€¼
    public static String getValue(Column column) {
        return column.getIsNull() ? null : column.getValue();
    }
    
    // è·å–æŒ‡å®šåç§°çš„åˆ—
    public static Column findColumn(List<Column> columns, String columnName) {
        for (Column column : columns) {
            if (column.getName().equals(columnName)) {
                return column;
            }
        }
        return null;
    }
    
    // è·å–æ‰€æœ‰ä¸»é”®åˆ—
    public static List<Column> getPrimaryKeyColumns(List<Column> columns) {
        return columns.stream()
                .filter(Column::getIsKey)
                .collect(Collectors.toList());
    }
    
    // è·å–å˜æ›´çš„åˆ—ï¼ˆä»…UPDATEäº‹ä»¶ï¼‰
    public static List<Column> getUpdatedColumns(List<Column> columns) {
        return columns.stream()
                .filter(Column::getUpdated)
                .collect(Collectors.toList());
    }
    
    // æ ¼å¼åŒ–è¾“å‡ºåˆ—ä¿¡æ¯
    public static String formatColumn(Column column) {
        String value = column.getIsNull() ? "NULL" : column.getValue();
        String keyMark = column.getIsKey() ? "[PK]" : "";
        return String.format("%s%s = %s", column.getName(), keyMark, value);
    }
}
```

---

## 7. ğŸ”„ äº‹åŠ¡ä¿¡æ¯è·å–


### 7.1 Canalä¸­çš„äº‹åŠ¡æ¦‚å¿µ


Canalå¯ä»¥æ•è·MySQLçš„äº‹åŠ¡è¾¹ç•Œï¼Œå¸®åŠ©æˆ‘ä»¬äº†è§£å“ªäº›æ“ä½œå±äºåŒä¸€ä¸ªäº‹åŠ¡ã€‚

> ğŸ’¡ **ä¸ºä»€ä¹ˆé‡è¦**ï¼šåœ¨æ•°æ®åŒæ­¥æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›ä¿æŒäº‹åŠ¡çš„å®Œæ•´æ€§ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥

### 7.2 äº‹åŠ¡ç›¸å…³çš„Entryç±»å‹


```java
public void processTransaction(List<Entry> entries) {
    for (Entry entry : entries) {
        EntryType entryType = entry.getEntryType();
        
        switch (entryType) {
            case TRANSACTIONBEGIN:
                System.out.println("=== äº‹åŠ¡å¼€å§‹ ===");
                handleTransactionBegin(entry);
                break;
                
            case TRANSACTIONEND:
                System.out.println("=== äº‹åŠ¡ç»“æŸ ===");
                handleTransactionEnd(entry);
                break;
                
            case ROWDATA:
                System.out.println("--- æ•°æ®å˜æ›´ ---");
                handleRowData(entry);
                break;
        }
    }
}
```

### 7.3 äº‹åŠ¡ä¿¡æ¯æå–


```java
public class TransactionHelper {
    
    // è·å–äº‹åŠ¡ID
    public static long getTransactionId(Entry entry) {
        Header header = entry.getHeader();
        return header.getLogfileOffset(); // ä½¿ç”¨æ—¥å¿—åç§»é‡ä½œä¸ºäº‹åŠ¡æ ‡è¯†
    }
    
    // è·å–äº‹åŠ¡æ‰§è¡Œæ—¶é—´
    public static Date getTransactionTime(Entry entry) {
        Header header = entry.getHeader();
        return new Date(header.getExecuteTime());
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€äº‹åŠ¡
    public static boolean isSameTransaction(Entry entry1, Entry entry2) {
        return getTransactionId(entry1) == getTransactionId(entry2);
    }
    
    // äº‹åŠ¡ä¿¡æ¯æ‘˜è¦
    public static String getTransactionSummary(Entry entry) {
        Header header = entry.getHeader();
        return String.format("äº‹åŠ¡[%d] æ—¶é—´[%s] ä½ç½®[%d:%d]",
            getTransactionId(entry),
            new Date(header.getExecuteTime()),
            header.getLogfileOffset(),
            header.getLogfileName()
        );
    }
}
```

### 7.4 äº‹åŠ¡æ‰¹å¤„ç†ç¤ºä¾‹


```java
public class TransactionBatchProcessor {
    private List<Entry> currentTransaction = new ArrayList<>();
    
    public void processEntry(Entry entry) {
        EntryType entryType = entry.getEntryType();
        
        if (entryType == EntryType.TRANSACTIONBEGIN) {
            // å¼€å§‹æ–°äº‹åŠ¡
            currentTransaction.clear();
            currentTransaction.add(entry);
            
        } else if (entryType == EntryType.TRANSACTIONEND) {
            // äº‹åŠ¡ç»“æŸï¼Œæ‰¹é‡å¤„ç†
            currentTransaction.add(entry);
            processBatch(currentTransaction);
            currentTransaction.clear();
            
        } else if (entryType == EntryType.ROWDATA) {
            // æ”¶é›†äº‹åŠ¡ä¸­çš„æ•°æ®å˜æ›´
            currentTransaction.add(entry);
        }
    }
    
    private void processBatch(List<Entry> transactionEntries) {
        System.out.println("å¤„ç†äº‹åŠ¡æ‰¹æ¬¡ï¼ŒåŒ…å« " + transactionEntries.size() + " ä¸ªæ“ä½œ");
        
        try {
            // åœ¨è¿™é‡Œå®ç°æ‰¹é‡å¤„ç†é€»è¾‘
            for (Entry entry : transactionEntries) {
                if (entry.getEntryType() == EntryType.ROWDATA) {
                    // å¤„ç†æ•°æ®å˜æ›´
                    handleRowData(entry);
                }
            }
            System.out.println("äº‹åŠ¡æ‰¹æ¬¡å¤„ç†æˆåŠŸ");
            
        } catch (Exception e) {
            System.err.println("äº‹åŠ¡æ‰¹æ¬¡å¤„ç†å¤±è´¥ï¼Œéœ€è¦å›æ»šï¼š" + e.getMessage());
        }
    }
}
```

---

## 8. ğŸ”§ DDLè¯­å¥è§£æ


### 8.1 ä»€ä¹ˆæ˜¯DDLäº‹ä»¶


**DDL**ï¼ˆData Definition Languageï¼‰æ˜¯æ•°æ®å®šä¹‰è¯­è¨€ï¼ŒåŒ…æ‹¬åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤è¡¨ç»“æ„çš„SQLè¯­å¥ã€‚

> ğŸ“ **å¸¸è§DDLè¯­å¥**ï¼šCREATE TABLEã€ALTER TABLEã€DROP TABLEã€CREATE INDEXç­‰

### 8.2 è¯†åˆ«DDLäº‹ä»¶


```java
public void processDDL(Entry entry) {
    // DDLäº‹ä»¶çš„Entryç±»å‹æ˜¯QUERY
    if (entry.getEntryType() != EntryType.QUERY) {
        return;
    }
    
    try {
        RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºDDLè¯­å¥
        if (rowChange.getIsDdl()) {
            String sql = rowChange.getSql();
            EventType eventType = rowChange.getEventType();
            
            System.out.println("=== DDLè¯­å¥æ£€æµ‹ ===");
            System.out.println("ç±»å‹ï¼š" + eventType);
            System.out.println("SQLï¼š" + sql);
            
            handleDDLByType(eventType, sql);
        }
        
    } catch (Exception e) {
        System.err.println("DDLè§£æå¤±è´¥ï¼š" + e.getMessage());
    }
}
```

### 8.3 ä¸åŒDDLç±»å‹å¤„ç†


```java
public void handleDDLByType(EventType eventType, String sql) {
    switch (eventType) {
        case CREATE:
            handleCreateTable(sql);
            break;
        case ALTER:
            handleAlterTable(sql);
            break;
        case DROP:
            handleDropTable(sql);
            break;
        case RENAME:
            handleRenameTable(sql);
            break;
        default:
            System.out.println("å…¶ä»–DDLæ“ä½œï¼š" + eventType);
    }
}

private void handleCreateTable(String sql) {
    System.out.println("ğŸ†• æ£€æµ‹åˆ°å»ºè¡¨æ“ä½œ");
    // å¯ä»¥è§£æè¡¨åã€å­—æ®µç­‰ä¿¡æ¯
    String tableName = extractTableName(sql);
    System.out.println("æ–°å»ºè¡¨ï¼š" + tableName);
}

private void handleAlterTable(String sql) {
    System.out.println("ğŸ”„ æ£€æµ‹åˆ°è¡¨ç»“æ„å˜æ›´");
    // å¯ä»¥è§£æå…·ä½“çš„å˜æ›´å†…å®¹
    System.out.println("å˜æ›´SQLï¼š" + sql);
}

private void handleDropTable(String sql) {
    System.out.println("ğŸ—‘ï¸ æ£€æµ‹åˆ°åˆ è¡¨æ“ä½œ");
    String tableName = extractTableName(sql);
    System.out.println("åˆ é™¤è¡¨ï¼š" + tableName);
    // å¯èƒ½éœ€è¦æ¸…ç†ç›¸å…³ç¼“å­˜æˆ–é…ç½®
}
```

### 8.4 DDLè§£æå·¥å…·


```java
public class DDLParser {
    
    // æå–è¡¨å
    public static String extractTableName(String sql) {
        // ç®€å•çš„æ­£åˆ™åŒ¹é…ï¼Œå®é™…é¡¹ç›®å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æ
        Pattern pattern = Pattern.compile("(?i)\\b(?:create|alter|drop)\\s+table\\s+(?:`?)(\\w+)(?:`?)", 
                                        Pattern.CASE_INSENSITIVE);
        Matcher matcher = pattern.matcher(sql);
        if (matcher.find()) {
            return matcher.group(1);
        }
        return "æœªçŸ¥è¡¨å";
    }
    
    // åˆ¤æ–­DDLç±»å‹
    public static String getDDLType(String sql) {
        String upperSql = sql.toUpperCase().trim();
        if (upperSql.startsWith("CREATE")) return "CREATE";
        if (upperSql.startsWith("ALTER")) return "ALTER";
        if (upperSql.startsWith("DROP")) return "DROP";
        if (upperSql.startsWith("RENAME")) return "RENAME";
        return "UNKNOWN";
    }
    
    // æå–å­—æ®µä¿¡æ¯ï¼ˆé’ˆå¯¹CREATE TABLEï¼‰
    public static List<String> extractColumns(String createTableSql) {
        List<String> columns = new ArrayList<>();
        // è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„SQLè§£æé€»è¾‘
        // ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨å»ºè®®ç”¨ä¸“ä¸šçš„SQLè§£æåº“
        return columns;
    }
}
```

---

## 9. ğŸ”„ æ•°æ®ç±»å‹è½¬æ¢ä¸å¤„ç†


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®ç±»å‹è½¬æ¢


Canalè·å–åˆ°çš„æ•°æ®éƒ½æ˜¯**å­—ç¬¦ä¸²æ ¼å¼**ï¼Œä½†å®é™…åº”ç”¨ä¸­æˆ‘ä»¬éœ€è¦è½¬æ¢æˆå¯¹åº”çš„Javaç±»å‹ã€‚

> âš ï¸ **æ³¨æ„**ï¼šMySQLä¸­çš„`int`å€¼åœ¨Canalä¸­ä¼šå˜æˆå­—ç¬¦ä¸²"123"ï¼Œéœ€è¦è½¬æ¢ä¸ºJavaçš„`Integer`ç±»å‹

### 9.2 MySQLç±»å‹ä¸Javaç±»å‹æ˜ å°„


| MySQLç±»å‹ | **Canalä¸­çš„å€¼** | **Javaç›®æ ‡ç±»å‹** | **è½¬æ¢æ–¹æ³•** |
|-----------|----------------|-----------------|-------------|
| `INT` | "123" | `Integer` | `Integer.parseInt()` |
| `BIGINT` | "1234567890" | `Long` | `Long.parseLong()` |
| `DECIMAL` | "123.45" | `BigDecimal` | `new BigDecimal()` |
| `DATETIME` | "2023-12-01 10:30:00" | `Date` | `SimpleDateFormat.parse()` |
| `VARCHAR` | "hello" | `String` | ç›´æ¥ä½¿ç”¨ |
| `BOOLEAN` | "1"/"0" | `Boolean` | "1".equals() |

### 9.3 ç±»å‹è½¬æ¢å·¥å…·ç±»


```java
public class DataTypeConverter {
    
    private static final DateFormat MYSQL_DATETIME_FORMAT = 
        new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    
    private static final DateFormat MYSQL_DATE_FORMAT = 
        new SimpleDateFormat("yyyy-MM-dd");
    
    // æ ¹æ®MySQLç±»å‹è½¬æ¢æ•°æ®
    public static Object convertValue(Column column) {
        if (column.getIsNull()) {
            return null;
        }
        
        String value = column.getValue();
        String mysqlType = column.getMysqlType().toLowerCase();
        
        try {
            if (mysqlType.contains("int")) {
                return mysqlType.contains("bigint") ? 
                    Long.parseLong(value) : Integer.parseInt(value);
                    
            } else if (mysqlType.contains("decimal") || mysqlType.contains("numeric")) {
                return new BigDecimal(value);
                
            } else if (mysqlType.contains("float")) {
                return Float.parseFloat(value);
                
            } else if (mysqlType.contains("double")) {
                return Double.parseDouble(value);
                
            } else if (mysqlType.contains("datetime") || mysqlType.contains("timestamp")) {
                return MYSQL_DATETIME_FORMAT.parse(value);
                
            } else if (mysqlType.contains("date")) {
                return MYSQL_DATE_FORMAT.parse(value);
                
            } else if (mysqlType.contains("bit") || mysqlType.contains("boolean")) {
                return "1".equals(value);
                
            } else {
                return value; // å­—ç¬¦ä¸²ç±»å‹ç›´æ¥è¿”å›
            }
            
        } catch (Exception e) {
            System.err.println("ç±»å‹è½¬æ¢å¤±è´¥ï¼š" + mysqlType + " = " + value);
            return value; // è½¬æ¢å¤±è´¥æ—¶è¿”å›åŸå§‹å­—ç¬¦ä¸²
        }
    }
    
    // è½¬æ¢ä¸ºæŒ‡å®šçš„Javaç±»å‹
    @SuppressWarnings("unchecked")
    public static <T> T convertTo(Column column, Class<T> targetType) {
        Object convertedValue = convertValue(column);
        
        if (convertedValue == null) {
            return null;
        }
        
        if (targetType.isInstance(convertedValue)) {
            return (T) convertedValue;
        }
        
        // ç±»å‹ä¸åŒ¹é…æ—¶çš„é¢å¤–è½¬æ¢é€»è¾‘
        if (targetType == String.class) {
            return (T) convertedValue.toString();
        }
        
        throw new ClassCastException("æ— æ³•è½¬æ¢ " + convertedValue.getClass() + " åˆ° " + targetType);
    }
}
```

### 9.4 å®é™…ä½¿ç”¨ç¤ºä¾‹


```java
public void processColumns(List<Column> columns) {
    for (Column column : columns) {
        String columnName = column.getName();
        Object javaValue = DataTypeConverter.convertValue(column);
        
        System.out.println(columnName + " (" + column.getMysqlType() + ") = " 
            + javaValue + " [" + (javaValue != null ? javaValue.getClass().getSimpleName() : "null") + "]");
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// user_id (int(11)) = 123 [Integer]
// user_name (varchar(50)) = å¼ ä¸‰ [String]
// create_time (datetime) = Fri Dec 01 10:30:00 CST 2023 [Date]
// is_active (tinyint(1)) = true [Boolean]
```

---

## 10. â° æ—¶é—´æˆ³ä¸ç©ºå€¼å¤„ç†


### 10.1 æ—¶é—´æˆ³å¤„ç†


Canalä¸­çš„æ—¶é—´ä¿¡æ¯åŒ…æ‹¬**æ“ä½œæ‰§è¡Œæ—¶é—´**å’Œ**æ•°æ®ä¸­çš„æ—¶é—´å­—æ®µ**ï¼Œéœ€è¦åˆ†åˆ«å¤„ç†ã€‚

### 10.2 æ“ä½œæ—¶é—´æˆ³è·å–


```java
public class TimestampHelper {
    
    // è·å–æ•°æ®åº“æ“ä½œçš„æ‰§è¡Œæ—¶é—´
    public static Date getExecuteTime(Entry entry) {
        Header header = entry.getHeader();
        long executeTime = header.getExecuteTime();
        return new Date(executeTime);
    }
    
    // æ ¼å¼åŒ–æ“ä½œæ—¶é—´
    public static String formatExecuteTime(Entry entry) {
        Date executeTime = getExecuteTime(entry);
        SimpleDateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS");
        return formatter.format(executeTime);
    }
    
    // è·å–binlogæ–‡ä»¶ä¿¡æ¯
    public static String getBinlogInfo(Entry entry) {
        Header header = entry.getHeader();
        return String.format("æ–‡ä»¶:%s ä½ç½®:%d", 
            header.getLogfileName(), 
            header.getLogfileOffset());
    }
}
```

### 10.3 æ•°æ®ä¸­çš„æ—¶é—´å­—æ®µå¤„ç†


```java
public class TimeFieldProcessor {
    
    private static final SimpleDateFormat MYSQL_DATETIME = 
        new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    
    private static final SimpleDateFormat MYSQL_DATE = 
        new SimpleDateFormat("yyyy-MM-dd");
    
    // è§£æMySQLæ—¶é—´å­—ç¬¦ä¸²
    public static Date parseTimeField(Column column) {
        if (column.getIsNull()) {
            return null;
        }
        
        String value = column.getValue();
        String mysqlType = column.getMysqlType().toLowerCase();
        
        try {
            if (mysqlType.contains("datetime") || mysqlType.contains("timestamp")) {
                return MYSQL_DATETIME.parse(value);
            } else if (mysqlType.contains("date")) {
                return MYSQL_DATE.parse(value);
            }
        } catch (ParseException e) {
            System.err.println("æ—¶é—´è§£æå¤±è´¥ï¼š" + value + " (" + mysqlType + ")");
        }
        
        return null;
    }
    
    // å¤„ç†ç‰¹æ®Šçš„æ—¶é—´å€¼
    public static Date handleSpecialTimeValues(String timeValue) {
        // MySQLä¸­çš„ç‰¹æ®Šæ—¶é—´å€¼å¤„ç†
        if ("0000-00-00 00:00:00".equals(timeValue) || 
            "0000-00-00".equals(timeValue)) {
            return null; // è½¬æ¢ä¸ºnull
        }
        
        // å…¶ä»–ç‰¹æ®Šå€¼å¤„ç†...
        return null;
    }
}
```

### 10.4 ç©ºå€¼å¤„ç†ç­–ç•¥


```java
public class NullValueHandler {
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºå€¼
    public static boolean isNull(Column column) {
        return column.getIsNull() || 
               "".equals(column.getValue()) ||
               "NULL".equalsIgnoreCase(column.getValue());
    }
    
    // å®‰å…¨è·å–åˆ—å€¼
    public static String safeGetValue(Column column) {
        return isNull(column) ? null : column.getValue();
    }
    
    // è·å–éç©ºå€¼æˆ–é»˜è®¤å€¼
    public static String getValueOrDefault(Column column, String defaultValue) {
        String value = safeGetValue(column);
        return value != null ? value : defaultValue;
    }
    
    // ç©ºå€¼è½¬æ¢ç­–ç•¥
    public static Object handleNullValue(Column column, String strategy) {
        if (!isNull(column)) {
            return DataTypeConverter.convertValue(column);
        }
        
        // æ ¹æ®ç­–ç•¥å¤„ç†ç©ºå€¼
        switch (strategy) {
            case "SKIP":
                return null;
            case "EMPTY_STRING":
                return "";
            case "ZERO":
                return getZeroValue(column.getMysqlType());
            default:
                return null;
        }
    }
    
    private static Object getZeroValue(String mysqlType) {
        String type = mysqlType.toLowerCase();
        if (type.contains("int")) return 0;
        if (type.contains("decimal") || type.contains("numeric")) return BigDecimal.ZERO;
        if (type.contains("float") || type.contains("double")) return 0.0;
        return "";
    }
}
```

### 10.5 å®Œæ•´çš„æ•°æ®å¤„ç†ç¤ºä¾‹


```java
public class CompleteDataProcessor {
    
    public void processRowData(RowData rowData, EventType eventType) {
        System.out.println("=== å®Œæ•´æ•°æ®å¤„ç†ç¤ºä¾‹ ===");
        
        List<Column> columns = eventType == EventType.DELETE ? 
            rowData.getBeforeColumnsList() : rowData.getAfterColumnsList();
        
        for (Column column : columns) {
            processColumn(column);
        }
    }
    
    private void processColumn(Column column) {
        String columnName = column.getName();
        String mysqlType = column.getMysqlType();
        
        // 1. ç©ºå€¼æ£€æŸ¥
        if (NullValueHandler.isNull(column)) {
            System.out.println(columnName + " = NULL");
            return;
        }
        
        // 2. ç±»å‹è½¬æ¢
        Object javaValue = DataTypeConverter.convertValue(column);
        
        // 3. ç‰¹æ®Šå¤„ç†
        if (mysqlType.contains("datetime") || mysqlType.contains("timestamp")) {
            Date timeValue = TimeFieldProcessor.parseTimeField(column);
            System.out.println(columnName + " = " + timeValue + " (æ—¶é—´ç±»å‹)");
        } else {
            System.out.println(columnName + " = " + javaValue + " (" + mysqlType + ")");
        }
        
        // 4. ä¸»é”®æ ‡è¯†
        if (column.getIsKey()) {
            System.out.println("  â†‘ è¿™æ˜¯ä¸»é”®å­—æ®µ");
        }
    }
}
```

---

## 11. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 11.1 æ•°æ®åŒæ­¥åœºæ™¯


**åœºæ™¯**ï¼šå°†MySQLæ•°æ®å®æ—¶åŒæ­¥åˆ°Elasticsearch

```java
public class DataSyncToES {
    
    public void syncToElasticsearch(Entry entry) {
        if (entry.getEntryType() != EntryType.ROWDATA) {
            return;
        }
        
        try {
            RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
            EventType eventType = rowChange.getEventType();
            String indexName = entry.getHeader().getTableName();
            
            for (RowData rowData : rowChange.getRowDatasList()) {
                switch (eventType) {
                    case INSERT:
                        insertToES(indexName, rowData);
                        break;
                    case UPDATE:
                        updateToES(indexName, rowData);
                        break;
                    case DELETE:
                        deleteFromES(indexName, rowData);
                        break;
                }
            }
            
        } catch (Exception e) {
            System.err.println("åŒæ­¥åˆ°ESå¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    private void insertToES(String indexName, RowData rowData) {
        Map<String, Object> document = new HashMap<>();
        List<Column> columns = rowData.getAfterColumnsList();
        
        String documentId = null;
        for (Column column : columns) {
            String key = column.getName();
            Object value = DataTypeConverter.convertValue(column);
            document.put(key, value);
            
            // è·å–ä¸»é”®ä½œä¸ºESæ–‡æ¡£ID
            if (column.getIsKey()) {
                documentId = column.getValue();
            }
        }
        
        // è°ƒç”¨ESå®¢æˆ·ç«¯æ’å…¥æ–‡æ¡£
        System.out.println("æ’å…¥ESæ–‡æ¡£ï¼š" + indexName + "/" + documentId);
        // esClient.index(indexName, documentId, document);
    }
}
```

### 11.2 ç¼“å­˜æ›´æ–°åœºæ™¯


**åœºæ™¯**ï¼šæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°Redisç¼“å­˜

```java
public class CacheUpdater {
    
    public void updateCache(Entry entry) {
        if (entry.getEntryType() != EntryType.ROWDATA) {
            return;
        }
        
        try {
            RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
            String tableName = entry.getHeader().getTableName();
            
            // åªå¤„ç†æˆ‘ä»¬å…³å¿ƒçš„è¡¨
            if ("user".equals(tableName)) {
                handleUserTableChange(rowChange);
            } else if ("product".equals(tableName)) {
                handleProductTableChange(rowChange);
            }
            
        } catch (Exception e) {
            System.err.println("ç¼“å­˜æ›´æ–°å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    private void handleUserTableChange(RowChange rowChange) {
        EventType eventType = rowChange.getEventType();
        
        for (RowData rowData : rowChange.getRowDatasList()) {
            String userId = RowDataHelper.getPrimaryKeyValue(rowData);
            String cacheKey = "user:" + userId;
            
            switch (eventType) {
                case INSERT:
                case UPDATE:
                    // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯åˆ°ç¼“å­˜
                    Map<String, Object> userInfo = RowDataHelper.toMap(
                        rowData.getAfterColumnsList());
                    // redisClient.set(cacheKey, userInfo);
                    System.out.println("æ›´æ–°ç”¨æˆ·ç¼“å­˜ï¼š" + cacheKey);
                    break;
                    
                case DELETE:
                    // ä»ç¼“å­˜ä¸­åˆ é™¤
                    // redisClient.delete(cacheKey);
                    System.out.println("åˆ é™¤ç”¨æˆ·ç¼“å­˜ï¼š" + cacheKey);
                    break;
            }
        }
    }
}
```

### 11.3 æ•°æ®å®¡è®¡åœºæ™¯


**åœºæ™¯**ï¼šè®°å½•æ‰€æœ‰æ•°æ®å˜æ›´çš„å®¡è®¡æ—¥å¿—

```java
public class DataAuditor {
    
    public void audit(Entry entry) {
        if (entry.getEntryType() != EntryType.ROWDATA) {
            return;
        }
        
        try {
            RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
            Header header = entry.getHeader();
            
            AuditLog auditLog = new AuditLog();
            auditLog.setDatabase(header.getSchemaName());
            auditLog.setTableName(header.getTableName());
            auditLog.setOperationType(rowChange.getEventType().toString());
            auditLog.setOperationTime(new Date(header.getExecuteTime()));
            auditLog.setBinlogFile(header.getLogfileName());
            auditLog.setBinlogOffset(header.getLogfileOffset());
            
            for (RowData rowData : rowChange.getRowDatasList()) {
                String primaryKey = RowDataHelper.getPrimaryKeyValue(rowData);
                auditLog.setPrimaryKeyValue(primaryKey);
                
                // è®°å½•å˜æ›´è¯¦æƒ…
                if (rowChange.getEventType() == EventType.UPDATE) {
                    Set<String> changedFields = RowDataHelper.getChangedFields(rowData);
                    auditLog.setChangedFields(String.join(",", changedFields));
                }
                
                // ä¿å­˜å®¡è®¡æ—¥å¿—
                saveAuditLog(auditLog);
            }
            
        } catch (Exception e) {
            System.err.println("å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    private void saveAuditLog(AuditLog auditLog) {
        System.out.println("å®¡è®¡æ—¥å¿—ï¼š" + auditLog);
        // ä¿å­˜åˆ°å®¡è®¡æ—¥å¿—è¡¨æˆ–æ–‡ä»¶
    }
}

// å®¡è®¡æ—¥å¿—å®ä½“ç±»
class AuditLog {
    private String database;
    private String tableName;
    private String operationType;
    private Date operationTime;
    private String primaryKeyValue;
    private String changedFields;
    private String binlogFile;
    private long binlogOffset;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Canalæ¶ˆæ¯ç»“æ„ï¼šMessage â†’ Entry â†’ RowChange â†’ RowData â†’ Column
ğŸ”¸ Entryç±»å‹ï¼šROWDATA(æ•°æ®å˜æ›´)ã€QUERY(DDL)ã€TRANSACTION(äº‹åŠ¡è¾¹ç•Œ)
ğŸ”¸ EventTypeï¼šINSERTã€UPDATEã€DELETEã€CREATEã€ALTERã€DROPç­‰
ğŸ”¸ RowDataç»“æ„ï¼šbeforeColumns(å˜æ›´å‰) + afterColumns(å˜æ›´å)
ğŸ”¸ Columnå±æ€§ï¼šnameã€valueã€isKeyã€isNullã€mysqlTypeç­‰
ğŸ”¸ æ•°æ®å¤„ç†ï¼šç±»å‹è½¬æ¢ã€ç©ºå€¼å¤„ç†ã€æ—¶é—´æˆ³å¤„ç†
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ•°æ®è§£æçš„å±‚æ¬¡æ€§**
```
ç†è§£è¦ç‚¹ï¼š
- Canalæ¶ˆæ¯æ˜¯åˆ†å±‚åŒ…è£…çš„ï¼Œéœ€è¦é€å±‚è§£æ
- æ¯ä¸€å±‚éƒ½æœ‰ç‰¹å®šçš„ä½œç”¨å’Œä¿¡æ¯
- æŒæ¡æ¯å±‚çš„è§£ææ–¹æ³•æ˜¯åŸºç¡€
```

**ğŸ”¹ ä¸åŒäº‹ä»¶ç±»å‹çš„å¤„ç†å·®å¼‚**
```
INSERTäº‹ä»¶ï¼šåªå…³æ³¨afterColumns
UPDATEäº‹ä»¶ï¼šå¯¹æ¯”beforeColumnså’ŒafterColumns
DELETEäº‹ä»¶ï¼šåªå…³æ³¨beforeColumns
DDLäº‹ä»¶ï¼šå…³æ³¨SQLè¯­å¥å†…å®¹
```

**ğŸ”¹ æ•°æ®ç±»å‹è½¬æ¢çš„é‡è¦æ€§**
```
Canalä¸­æ‰€æœ‰æ•°æ®éƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼
å®é™…åº”ç”¨éœ€è¦è½¬æ¢ä¸ºå¯¹åº”çš„Javaç±»å‹
è¦å¤„ç†ç‰¹æ®Šå€¼å’Œç©ºå€¼æƒ…å†µ
```

### 12.3 å®é™…åº”ç”¨ä»·å€¼


- **æ•°æ®åŒæ­¥**ï¼šå®æ—¶åŒæ­¥æ•°æ®åˆ°å…¶ä»–ç³»ç»Ÿ
- **ç¼“å­˜æ›´æ–°**ï¼šæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°ç¼“å­˜
- **æ¶ˆæ¯æ¨é€**ï¼šåŸºäºæ•°æ®å˜æ›´è§¦å‘ä¸šåŠ¡äº‹ä»¶
- **æ•°æ®å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰æ•°æ®å˜æ›´å†å²
- **å®æ—¶åˆ†æ**ï¼šåŸºäºæ•°æ®å˜æ›´è¿›è¡Œå®æ—¶ç»Ÿè®¡

### 12.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ ä»£ç å®è·µ**
- ä½¿ç”¨å·¥å…·ç±»å°è£…å¸¸ç”¨çš„è§£æé€»è¾‘
- å¯¹å¼‚å¸¸æƒ…å†µè¿›è¡Œå……åˆ†çš„é”™è¯¯å¤„ç†
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿‡æ»¤ä¸å¿…è¦çš„äº‹ä»¶ç±»å‹
- å®ç°æ‰¹é‡å¤„ç†æé«˜æ€§èƒ½

**âš ï¸ æ³¨æ„äº‹é¡¹**
- Canalè·å–çš„æ•°æ®éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦ç±»å‹è½¬æ¢
- è¦æ­£ç¡®å¤„ç†ç©ºå€¼å’Œç‰¹æ®Šå€¼æƒ…å†µ
- ä¸åŒäº‹ä»¶ç±»å‹çš„æ•°æ®ç»“æ„ä¸åŒ
- DDLäº‹ä»¶å¯èƒ½å½±å“æ•°æ®ç»“æ„ï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–**
- æŒ‰éœ€è§£æï¼Œé¿å…ä¸å¿…è¦çš„æ•°æ®å¤„ç†
- ä½¿ç”¨æ‰¹é‡å¤„ç†å‡å°‘ç½‘ç»œå¼€é”€
- åˆç†è®¾ç½®Canalçš„æ‰¹é‡å¤§å°
- ç›‘æ§å¤„ç†æ€§èƒ½ï¼ŒåŠæ—¶å‘ç°ç“¶é¢ˆ

**æ ¸å¿ƒè®°å¿†**ï¼š
- Canalæ¶ˆæ¯åˆ†å±‚è§£æï¼ŒEntryæ˜¯æ ¸å¿ƒå•ä½
- RowChangeåŒ…å«æ•°æ®å˜æ›´ï¼ŒColumnåŒ…å«å­—æ®µä¿¡æ¯
- ä¸åŒäº‹ä»¶ç±»å‹å¤„ç†æ–¹å¼ä¸åŒï¼Œè¦åˆ†åˆ«å¯¹å¾…
- æ•°æ®ç±»å‹è½¬æ¢å’Œç©ºå€¼å¤„ç†æ˜¯å¿…éœ€ç¯èŠ‚
- å®é™…åº”ç”¨è¦ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯è®¾è®¡å¤„ç†é€»è¾‘