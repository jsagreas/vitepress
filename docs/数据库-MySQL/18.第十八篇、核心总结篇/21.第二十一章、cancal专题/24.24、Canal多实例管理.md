---
title: 24ã€Canalå¤šå®ä¾‹ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Canalå¤šå®ä¾‹åŸºæœ¬æ¦‚å¿µ](#1-Canalå¤šå®ä¾‹åŸºæœ¬æ¦‚å¿µ)
2. [å¤šå®ä¾‹é…ç½®ä¸éƒ¨ç½²](#2-å¤šå®ä¾‹é…ç½®ä¸éƒ¨ç½²)
3. [å®ä¾‹éš”ç¦»ç­–ç•¥](#3-å®ä¾‹éš”ç¦»ç­–ç•¥)
4. [èµ„æºåˆ†é…ä¸è´Ÿè½½å‡è¡¡](#4-èµ„æºåˆ†é…ä¸è´Ÿè½½å‡è¡¡)
5. [å®ä¾‹æ•…éšœåˆ‡æ¢æœºåˆ¶](#5-å®ä¾‹æ•…éšœåˆ‡æ¢æœºåˆ¶)
6. [å®ä¾‹ç›‘æ§ä¸æ²»ç†](#6-å®ä¾‹ç›‘æ§ä¸æ²»ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Canalå¤šå®ä¾‹åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Canalå¤šå®ä¾‹


**æ ¸å¿ƒå®šä¹‰**ï¼š
Canalå¤šå®ä¾‹å°±æ˜¯åœ¨åŒä¸€å°æœåŠ¡å™¨æˆ–é›†ç¾¤ä¸­è¿è¡Œå¤šä¸ªç‹¬ç«‹çš„CanalæœåŠ¡ï¼Œæ¯ä¸ªå®ä¾‹è´Ÿè´£ä¸åŒçš„æ•°æ®åŒæ­¥ä»»åŠ¡ã€‚

**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
å•å®ä¾‹ = ä¸€ä¸ªäººä½ä¸€å¥—æˆ¿å­ï¼Œä»€ä¹ˆéƒ½è¦è‡ªå·±åš
å¤šå®ä¾‹ = ä¸€æ ‹æ¥¼é‡Œä½å¤šæˆ·äººå®¶ï¼Œå„è‡ªç‹¬ç«‹ç”Ÿæ´»ä½†å…±äº«åŸºç¡€è®¾æ–½

ä¼˜åŠ¿å¯¹æ¯”ï¼š
å•æˆ·åˆ«å¢…ï¼ˆå•å®ä¾‹ï¼‰ï¼š
âœ… ç‹¬äº«æ‰€æœ‰èµ„æºï¼Œæ€§èƒ½ç¨³å®š
âŒ æˆæœ¬é«˜ï¼Œèµ„æºæµªè´¹

å…¬å¯“æ¥¼ï¼ˆå¤šå®ä¾‹ï¼‰ï¼š
âœ… èµ„æºå…±äº«ï¼Œæˆæœ¬æ›´ä½
âœ… çµæ´»é…ç½®ï¼ŒæŒ‰éœ€åˆ†é…
âŒ éœ€è¦åˆç†è§„åˆ’ï¼Œé¿å…å†²çª
```

### 1.2 å¤šå®ä¾‹çš„æ ¸å¿ƒä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯éœ€æ±‚**ï¼š
```
ç°å®ä¸šåŠ¡æŒ‘æˆ˜ï¼š
ğŸ“Š è®¢å•ç³»ç»Ÿ â†’ å®æ—¶åŒæ­¥åˆ°æ•°æ®ä»“åº“
ğŸ‘¥ ç”¨æˆ·ç³»ç»Ÿ â†’ åŒæ­¥åˆ°æ¨èç³»ç»Ÿ  
ğŸ’° æ”¯ä»˜ç³»ç»Ÿ â†’ åŒæ­¥åˆ°é£æ§ç³»ç»Ÿ
ğŸ“± æ—¥å¿—ç³»ç»Ÿ â†’ åŒæ­¥åˆ°ç›‘æ§å¹³å°

å•å®ä¾‹é—®é¢˜ï¼š
â€¢ æ‰€æœ‰æ•°æ®æ··åœ¨ä¸€èµ·ï¼Œéš¾ä»¥ç®¡ç†
â€¢ ä¸€ä¸ªåº“å‡ºé—®é¢˜ï¼Œå½±å“æ‰€æœ‰åŒæ­¥
â€¢ æ— æ³•é’ˆå¯¹ä¸åŒä¸šåŠ¡åšä¸ªæ€§åŒ–é…ç½®
â€¢ èµ„æºäº‰æŠ¢ï¼Œæ€§èƒ½äº’ç›¸å½±å“
```

**ğŸ’¡ å¤šå®ä¾‹è§£å†³æ–¹æ¡ˆ**ï¼š
```
ä¸šåŠ¡éš”ç¦»ï¼š
Instance-1: ä¸“é—¨åŒæ­¥è®¢å•åº“
Instance-2: ä¸“é—¨åŒæ­¥ç”¨æˆ·åº“  
Instance-3: ä¸“é—¨åŒæ­¥æ”¯ä»˜åº“

å¥½å¤„æ˜¾è€Œæ˜“è§ï¼š
âœ… æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªæŒ‚äº†ä¸å½±å“å…¶ä»–
âœ… ç‹¬ç«‹é…ç½®ï¼šæ¯ä¸ªä¸šåŠ¡ä¸åŒçš„åŒæ­¥ç­–ç•¥
âœ… æ€§èƒ½éš”ç¦»ï¼šé‡è¦ä¸šåŠ¡ä¿è¯èµ„æº
âœ… çµæ´»æ‰©å±•ï¼šæ–°ä¸šåŠ¡ç›´æ¥åŠ æ–°å®ä¾‹
```

### 1.3 å¤šå®ä¾‹æ¶æ„å›¾ç¤º


```
ä¼ ç»Ÿå•å®ä¾‹æ¶æ„ï¼š
MySQL-A â”€â”€â”€â”€â”
MySQL-B â”€â”€â”€â”€â”¤ å•ä¸ªCanalå®ä¾‹ â”€â”€â”€â–º æ¶ˆæ¯é˜Ÿåˆ— â”€â”€â”€â–º å„ç§ä¸‹æ¸¸ç³»ç»Ÿ
MySQL-C â”€â”€â”€â”€â”˜     (å‹åŠ›å¤§)        (æ•°æ®æ··æ‚)

å¤šå®ä¾‹æ¶æ„ï¼š
MySQL-A â”€â”€â”€â–º Canalå®ä¾‹1 â”€â”€â”€â–º MQ-Topic-A â”€â”€â”€â–º æ•°æ®ä»“åº“
MySQL-B â”€â”€â”€â–º Canalå®ä¾‹2 â”€â”€â”€â–º MQ-Topic-B â”€â”€â”€â–º æ¨èç³»ç»Ÿ  
MySQL-C â”€â”€â”€â–º Canalå®ä¾‹3 â”€â”€â”€â–º MQ-Topic-C â”€â”€â”€â–º é£æ§ç³»ç»Ÿ
      â†“              â†“             â†“
   ç‹¬ç«‹é…ç½®      èµ„æºéš”ç¦»      æ•°æ®åˆ†ç¦»
```

---

## 2. âš™ï¸ å¤šå®ä¾‹é…ç½®ä¸éƒ¨ç½²


### 2.1 å•æœºå¤šå®ä¾‹é…ç½®


**ğŸ”§ ç›®å½•ç»“æ„è§„åˆ’**ï¼š
```
/opt/canal/
â”œâ”€â”€ canal-server/           # Canalä¸»ç¨‹åº
â”œâ”€â”€ conf/                   # å…¬å…±é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ canal.properties    # å…¨å±€é…ç½®
â”‚   â”œâ”€â”€ instance1/          # å®ä¾‹1é…ç½®
â”‚   â”‚   â””â”€â”€ instance.properties
â”‚   â”œâ”€â”€ instance2/          # å®ä¾‹2é…ç½®  
â”‚   â”‚   â””â”€â”€ instance.properties
â”‚   â””â”€â”€ instance3/          # å®ä¾‹3é…ç½®
â”‚       â””â”€â”€ instance.properties
â”œâ”€â”€ logs/                   # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ instance1/
â”‚   â”œâ”€â”€ instance2/
â”‚   â””â”€â”€ instance3/
â””â”€â”€ scripts/               # å¯åŠ¨è„šæœ¬
    â”œâ”€â”€ start-all.sh
    â””â”€â”€ stop-all.sh
```

**ğŸ“ å…¨å±€é…ç½®ç¤ºä¾‹**ï¼š
```properties
# canal.properties - å…¨å±€é…ç½®
canal.port = 11111
canal.metrics.pull.port = 11112

# å¤šå®ä¾‹å®šä¹‰
canal.destinations = instance1,instance2,instance3

# ç®¡ç†ç«¯å£é…ç½®
canal.admin.manager = 127.0.0.1:8089
canal.admin.port = 11110
```

### 2.2 å®ä¾‹ç‹¬ç«‹é…ç½®


**ğŸ¯ å®ä¾‹1é…ç½®ï¼ˆè®¢å•ç³»ç»Ÿï¼‰**ï¼š
```properties
# instance1/instance.properties
# æ•°æ®åº“è¿æ¥é…ç½®
canal.instance.master.address=192.168.1.10:3306
canal.instance.dbUsername=canal_user
canal.instance.dbPassword=canal_pass
canal.instance.defaultDatabaseName=order_db

# ä½ç‚¹ç®¡ç†
canal.instance.master.journal.name=mysql-bin.000001
canal.instance.master.position=4

# è¿‡æ»¤è§„åˆ™ - åªåŒæ­¥è®¢å•ç›¸å…³è¡¨
canal.instance.filter.regex=order_db\\.order_.*,order_db\\.payment_.*

# æ‰¹å¤„ç†é…ç½®
canal.instance.memory.buffer.size=16384
canal.instance.memory.batch.mode=MEMSIZE
```

**ğŸ¯ å®ä¾‹2é…ç½®ï¼ˆç”¨æˆ·ç³»ç»Ÿï¼‰**ï¼š
```properties
# instance2/instance.properties  
canal.instance.master.address=192.168.1.11:3306
canal.instance.dbUsername=canal_user
canal.instance.dbPassword=canal_pass
canal.instance.defaultDatabaseName=user_db

# ä¸“é—¨çš„ç”¨æˆ·æ•°æ®è¿‡æ»¤
canal.instance.filter.regex=user_db\\.user_.*,user_db\\.profile_.*

# ç”¨æˆ·æ•°æ®é‡å¤§ï¼Œè°ƒæ•´ç¼“å­˜
canal.instance.memory.buffer.size=32768
canal.instance.memory.batch.mode=ITEMSIZE
```

### 2.3 Dockerå¤šå®ä¾‹éƒ¨ç½²


**ğŸ³ Docker Composeé…ç½®**ï¼š
```yaml
version: '3.8'
services:
  canal-instance1:
    image: canal/canal-server:v1.1.6
    container_name: canal-order
    ports:
      - "11111:11111"
    environment:
      - canal.destinations=order-instance
      - canal.instance.master.address=mysql-order:3306
      - canal.instance.dbUsername=canal
      - canal.instance.filter.regex=order_db\\..*
    volumes:
      - ./conf/order:/home/admin/canal-server/conf
      - ./logs/order:/home/admin/canal-server/logs
    restart: unless-stopped

  canal-instance2:
    image: canal/canal-server:v1.1.6
    container_name: canal-user
    ports:
      - "11112:11111"
    environment:
      - canal.destinations=user-instance
      - canal.instance.master.address=mysql-user:3306
      - canal.instance.filter.regex=user_db\\..*
    volumes:
      - ./conf/user:/home/admin/canal-server/conf
      - ./logs/user:/home/admin/canal-server/logs
    restart: unless-stopped
```

---

## 3. ğŸ”’ å®ä¾‹éš”ç¦»ç­–ç•¥


### 3.1 èµ„æºéš”ç¦»æœºåˆ¶


**ğŸ’¾ å†…å­˜éš”ç¦»é…ç½®**ï¼š
```
å®ä¾‹èµ„æºåˆ†é…ç­–ç•¥ï¼š

æ ¸å¿ƒä¸šåŠ¡å®ä¾‹ï¼ˆè®¢å•ï¼‰ï¼š
canal.instance.memory.buffer.size=65536    # 64MBç¼“å­˜
canal.instance.memory.buffer.memunit=1024  # 1KBå•ä½

ä¸€èˆ¬ä¸šåŠ¡å®ä¾‹ï¼ˆç”¨æˆ·ï¼‰ï¼š
canal.instance.memory.buffer.size=32768    # 32MBç¼“å­˜  

è¾…åŠ©ä¸šåŠ¡å®ä¾‹ï¼ˆæ—¥å¿—ï¼‰ï¼š
canal.instance.memory.buffer.size=16384    # 16MBç¼“å­˜

ğŸ¯ åˆ†é…åŸåˆ™ï¼š
â€¢ é‡è¦æ€§è¶Šé«˜ï¼Œåˆ†é…å†…å­˜è¶Šå¤š
â€¢ æ•°æ®é‡è¶Šå¤§ï¼Œç¼“å­˜è¶Šå¤§
â€¢ å®æ—¶æ€§è¦æ±‚é«˜ï¼Œä¼˜å…ˆä¿è¯èµ„æº
```

### 3.2 ç½‘ç»œç«¯å£éš”ç¦»


**ğŸŒ ç«¯å£åˆ†é…è§„èŒƒ**ï¼š
```
ç«¯å£åˆ†é…æ–¹æ¡ˆï¼š
åŸºç¡€ç«¯å£ï¼š11110ï¼ˆç®¡ç†ç«¯å£ï¼‰

å®ä¾‹ç«¯å£è§„åˆ’ï¼š
11111: è®¢å•ç³»ç»ŸCanalå®ä¾‹
11112: ç”¨æˆ·ç³»ç»ŸCanalå®ä¾‹  
11113: æ”¯ä»˜ç³»ç»ŸCanalå®ä¾‹
11114: æ—¥å¿—ç³»ç»ŸCanalå®ä¾‹

ç›‘æ§ç«¯å£ï¼š
12111: è®¢å•å®ä¾‹ç›‘æ§
12112: ç”¨æˆ·å®ä¾‹ç›‘æ§
12113: æ”¯ä»˜å®ä¾‹ç›‘æ§

å¥½å¤„ï¼š
âœ… ç«¯å£å†²çªå®Œå…¨é¿å…
âœ… é—®é¢˜å®šä½ä¸€ç›®äº†ç„¶
âœ… ç½‘ç»œæµé‡ä¾¿äºç›‘æ§
```

### 3.3 æ•°æ®éš”ç¦»ç­–ç•¥


**ğŸ“Š æ•°æ®è·¯ç”±éš”ç¦»**ï¼š
```
æ¶ˆæ¯é˜Ÿåˆ—Topicéš”ç¦»ï¼š

å®ä¾‹1ï¼šorder-instance
â””â”€â”€ å‘é€åˆ° â†’ kafka-topic: order-binlog
    â””â”€â”€ æ¶ˆè´¹è€…: æ•°æ®ä»“åº“ã€æŠ¥è¡¨ç³»ç»Ÿ

å®ä¾‹2ï¼šuser-instance  
â””â”€â”€ å‘é€åˆ° â†’ kafka-topic: user-binlog
    â””â”€â”€ æ¶ˆè´¹è€…: æ¨èç³»ç»Ÿã€ç”»åƒç³»ç»Ÿ

å®ä¾‹3ï¼špayment-instance
â””â”€â”€ å‘é€åˆ° â†’ kafka-topic: payment-binlog
    â””â”€â”€ æ¶ˆè´¹è€…: é£æ§ç³»ç»Ÿã€è´¢åŠ¡ç³»ç»Ÿ

éš”ç¦»æ•ˆæœï¼š
ğŸ”¸ æ•°æ®ä¸ä¸²æµï¼šå„èµ°å„çš„é€šé“
ğŸ”¸ æ¶ˆè´¹ç‹¬ç«‹ï¼šä¸‹æ¸¸ç³»ç»Ÿäº’ä¸å½±å“  
ğŸ”¸ æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªtopicæŒ‚äº†ä¸å½±å“å…¶ä»–
```

---

## 4. âš–ï¸ èµ„æºåˆ†é…ä¸è´Ÿè½½å‡è¡¡


### 4.1 CPUèµ„æºåˆ†é…ç­–ç•¥


**ğŸ–¥ï¸ CPUäº²å’Œæ€§é…ç½®**ï¼š
```bash
# ä¸ºä¸åŒå®ä¾‹ç»‘å®šä¸åŒCPUæ ¸å¿ƒ
# 4æ ¸CPUçš„åˆ†é…æ–¹æ¡ˆ

# è®¢å•å®ä¾‹ï¼ˆé‡è¦ï¼‰- ç»‘å®š0,1æ ¸å¿ƒ
taskset -c 0,1 java -jar canal-order-instance.jar

# ç”¨æˆ·å®ä¾‹ï¼ˆä¸€èˆ¬ï¼‰- ç»‘å®š2æ ¸å¿ƒ  
taskset -c 2 java -jar canal-user-instance.jar

# æ—¥å¿—å®ä¾‹ï¼ˆæ™®é€šï¼‰- ç»‘å®š3æ ¸å¿ƒ
taskset -c 3 java -jar canal-log-instance.jar

ä¼˜åŠ¿ï¼š
âœ… é¿å…CPUäº‰æŠ¢
âœ… é‡è¦ä¸šåŠ¡ä¿è¯æ€§èƒ½
âœ… æ•´ä½“èµ„æºåˆ©ç”¨ç‡æ›´é«˜
```

### 4.2 å†…å­˜åˆ†é…ç®¡ç†


**ğŸ“Š JVMå†…å­˜åˆ†é…ç­–ç•¥**ï¼š
```bash
# è®¢å•å®ä¾‹ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
JAVA_OPTS="-Xms2g -Xmx4g -XX:NewRatio=1 -XX:SurvivorRatio=8"

# ç”¨æˆ·å®ä¾‹ï¼ˆé‡è¦ä¸šåŠ¡ï¼‰  
JAVA_OPTS="-Xms1g -Xmx2g -XX:NewRatio=2 -XX:SurvivorRatio=6"

# æ—¥å¿—å®ä¾‹ï¼ˆè¾…åŠ©ä¸šåŠ¡ï¼‰
JAVA_OPTS="-Xms512m -Xmx1g -XX:NewRatio=3 -XX:SurvivorRatio=4"

å†…å­˜åˆ†é…åŸåˆ™ï¼š
ğŸ¯ æ ¸å¿ƒä¸šåŠ¡ï¼šå……è¶³å†…å­˜ï¼Œé¿å…GCå½±å“æ€§èƒ½
ğŸ¯ é‡è¦ä¸šåŠ¡ï¼šé€‚ä¸­å†…å­˜ï¼Œå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬
ğŸ¯ è¾…åŠ©ä¸šåŠ¡ï¼šåŸºæœ¬å†…å­˜ï¼Œæ»¡è¶³è¿è¡Œå³å¯
```

### 4.3 è´Ÿè½½å‡è¡¡å®ç°


**âš–ï¸ æ™ºèƒ½è´Ÿè½½åˆ†é…**ï¼š
```
è´Ÿè½½å‡è¡¡æ¶æ„å›¾ï¼š

                    è´Ÿè½½å‡è¡¡å™¨(Nginx/HAProxy)
                           |
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼              â–¼              â–¼
    Canalå®ä¾‹1       Canalå®ä¾‹2      Canalå®ä¾‹3
    (æœåŠ¡å™¨A)        (æœåŠ¡å™¨B)       (æœåŠ¡å™¨C)
        |               |               |
        â–¼               â–¼               â–¼  
   è®¢å•æ•°æ®åº“        ç”¨æˆ·æ•°æ®åº“       æ”¯ä»˜æ•°æ®åº“

é…ç½®ç¤ºä¾‹ï¼š
upstream canal_cluster {
    # æƒé‡åˆ†é…
    server 192.168.1.10:11111 weight=3;  # é«˜æ€§èƒ½æœåŠ¡å™¨
    server 192.168.1.11:11111 weight=2;  # ä¸­ç­‰æœåŠ¡å™¨
    server 192.168.1.12:11111 weight=1;  # æ™®é€šæœåŠ¡å™¨
    
    # å¥åº·æ£€æŸ¥
    check interval=3000 rise=2 fall=3 timeout=1000;
}
```

---

## 5. ğŸ”„ å®ä¾‹æ•…éšœåˆ‡æ¢æœºåˆ¶


### 5.1 ä¸»å¤‡åˆ‡æ¢ç­–ç•¥


**ğŸ¥ HAé«˜å¯ç”¨æ¶æ„**ï¼š
```
ä¸»å¤‡åˆ‡æ¢æ¶æ„ï¼š

ä¸»èŠ‚ç‚¹                     å¤‡èŠ‚ç‚¹
Canal-Master    â†-----â†’   Canal-Standby
    |                         |
    â–¼                         â–¼
MySQL-Master              MySQL-Slave
    |                         â†‘
    â””â”€â”€â”€â”€â”€â”€â”€ ä¸»ä»å¤åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ‡æ¢æµç¨‹ï¼š
1. å¥åº·æ£€æŸ¥æ£€æµ‹åˆ°ä¸»èŠ‚ç‚¹æ•…éšœ
2. è‡ªåŠ¨æå‡å¤‡èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹
3. æ›´æ–°ä½ç‚¹ä¿¡æ¯ï¼Œç»§ç»­åŒæ­¥
4. æ•…éšœèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨å˜ä¸ºå¤‡èŠ‚ç‚¹
```

**ğŸ”§ è‡ªåŠ¨åˆ‡æ¢é…ç½®**ï¼š
```properties
# HAé…ç½®
canal.instance.ha.enable=true
canal.instance.ha.heartbeatTimeout=2000
canal.instance.ha.failoverTimeout=5000

# ZooKeeperåè°ƒ
canal.zkServers=zk1:2181,zk2:2181,zk3:2181
canal.instance.ha.zkPath=/canal/cluster/order-instance
```

### 5.2 æ•…éšœæ£€æµ‹æœºåˆ¶


**ğŸ‘€ å¤šç»´åº¦å¥åº·æ£€æŸ¥**ï¼š
```java
// å¥åº·æ£€æŸ¥ç›‘æ§ç‚¹
public class InstanceHealthChecker {
    
    // 1. è¿æ¥çŠ¶æ€æ£€æŸ¥
    public boolean checkDatabaseConnection() {
        try {
            Connection conn = getConnection();
            return conn.isValid(5); // 5ç§’è¶…æ—¶
        } catch (Exception e) {
            return false;
        }
    }
    
    // 2. ä½ç‚¹æ›´æ–°æ£€æŸ¥  
    public boolean checkBinlogPosition() {
        long lastUpdate = getLastPositionUpdateTime();
        long now = System.currentTimeMillis();
        return (now - lastUpdate) < 30000; // 30ç§’å†…æœ‰æ›´æ–°
    }
    
    // 3. æ¶ˆæ¯é˜Ÿåˆ—æ£€æŸ¥
    public boolean checkMessageQueue() {
        return mqProducer.isReady() && 
               getQueueDepth() < MAX_QUEUE_SIZE;
    }
}
```

### 5.3 æ•…éšœæ¢å¤æµç¨‹


**ğŸš‘ è‡ªåŠ¨æ¢å¤æœºåˆ¶**ï¼š
```
æ•…éšœæ¢å¤æ—¶åºå›¾ï¼š

æ—¶é—´è½´    ä¸»å®ä¾‹      ç›‘æ§ç³»ç»Ÿ     å¤‡å®ä¾‹      ä¸‹æ¸¸ç³»ç»Ÿ
  |         |           |          |           |
  t1    [è¿è¡Œæ­£å¸¸]   [ç›‘æ§ä¸­]    [å¾…æœº]     [æ­£å¸¸æ¶ˆè´¹]
  |         |           |          |           |
  t2    [âŒæ•…éšœ]    [æ£€æµ‹åˆ°]    [å¾…æœº]     [æ¶ˆè´¹ä¸­æ–­]
  |         |           |          |           |
  t3    [âŒæ•…éšœ]    [è§¦å‘åˆ‡æ¢]  [å¯åŠ¨ä¸­]   [ç­‰å¾…æ¢å¤]
  |         |           |          |           |
  t4    [âŒæ•…éšœ]    [åˆ‡æ¢å®Œæˆ]  [âœ…è¿è¡Œ]   [æ¢å¤æ¶ˆè´¹]
  |         |           |          |           |
  t5    [æ¢å¤ä¸­]     [ç›‘æ§]     [âœ…ä¸»å®ä¾‹]  [æ­£å¸¸è¿è¡Œ]

å…³é”®æ—¶é—´ç‚¹ï¼š
â€¢ t1-t2: æ•…éšœæ£€æµ‹æ—¶é—´ < 30ç§’
â€¢ t2-t3: å†³ç­–æ—¶é—´ < 10ç§’  
â€¢ t3-t4: åˆ‡æ¢æ—¶é—´ < 60ç§’
â€¢ æ€»æ•…éšœæ—¶é—´: < 100ç§’
```

---

## 6. ğŸ“Š å®ä¾‹ç›‘æ§ä¸æ²»ç†


### 6.1 å®ä¾‹ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§ç»´åº¦**ï¼š
```
æ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼š

ğŸ”¸ ååé‡æŒ‡æ ‡ï¼š
â€¢ æ¯ç§’å¤„ç†äº‹ä»¶æ•°(TPS)
â€¢ æ¯ç§’åŒæ­¥æ•°æ®é‡(MB/s)  
â€¢ ç´¯è®¡åŒæ­¥è®°å½•æ•°

ğŸ”¸ å»¶è¿ŸæŒ‡æ ‡ï¼š
â€¢ æ•°æ®åº“åˆ°Canalå»¶è¿Ÿ
â€¢ Canalåˆ°æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿Ÿ
â€¢ ç«¯åˆ°ç«¯æ€»å»¶è¿Ÿ

ğŸ”¸ èµ„æºä½¿ç”¨ï¼š
â€¢ CPUä½¿ç”¨ç‡
â€¢ å†…å­˜ä½¿ç”¨é‡
â€¢ ç½‘ç»œIO
â€¢ ç£ç›˜IO

ğŸ”¸ é”™è¯¯æŒ‡æ ‡ï¼š
â€¢ è¿æ¥å¤±è´¥æ¬¡æ•°
â€¢ è§£æé”™è¯¯æ¬¡æ•°
â€¢ å‘é€å¤±è´¥æ¬¡æ•°
â€¢ é‡è¯•æ¬¡æ•°
```

### 6.2 ç›‘æ§ç³»ç»Ÿæ­å»º


**ğŸ” Prometheus + Grafanaæ–¹æ¡ˆ**ï¼š
```yaml
# canal-monitor.yml
version: '3.8'
services:
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards
```

**ğŸ“Š ç›‘æ§Dashboardé…ç½®**ï¼š
```json
{
  "dashboard": {
    "title": "Canalå¤šå®ä¾‹ç›‘æ§",
    "panels": [
      {
        "title": "å®ä¾‹çŠ¶æ€æ€»è§ˆ",
        "type": "stat",
        "targets": [
          {
            "expr": "canal_instance_status{status=\"running\"}",
            "legendFormat": "è¿è¡Œä¸­å®ä¾‹æ•°"
          }
        ]
      },
      {
        "title": "TPSè¶‹åŠ¿",
        "type": "graph", 
        "targets": [
          {
            "expr": "rate(canal_events_total[5m])",
            "legendFormat": "{{instance}}"
          }
        ]
      }
    ]
  }
}
```

### 6.3 å®ä¾‹æ²»ç†è§„èŒƒ


**ğŸ“‹ è¿ç»´ç®¡ç†è§„èŒƒ**ï¼š

**ğŸ”¸ å®ä¾‹å‘½åè§„èŒƒ**ï¼š
```
å‘½åè§„åˆ™ï¼š{ä¸šåŠ¡ç³»ç»Ÿ}-{ç¯å¢ƒ}-{å®ä¾‹åºå·}

ç¤ºä¾‹ï¼š
order-prod-01    # ç”Ÿäº§ç¯å¢ƒè®¢å•ç³»ç»Ÿå®ä¾‹1
user-test-01     # æµ‹è¯•ç¯å¢ƒç”¨æˆ·ç³»ç»Ÿå®ä¾‹1
payment-dev-02   # å¼€å‘ç¯å¢ƒæ”¯ä»˜ç³»ç»Ÿå®ä¾‹2

å¥½å¤„ï¼š
âœ… ä¸€çœ¼çœ‹å‡ºæ˜¯ä»€ä¹ˆä¸šåŠ¡
âœ… ç¯å¢ƒéš”ç¦»æ¸…æ™°
âœ… æ‰¹é‡æ“ä½œæ–¹ä¾¿
```

**ğŸ”¸ é…ç½®ç®¡ç†è§„èŒƒ**ï¼š
```bash
# é…ç½®ç‰ˆæœ¬åŒ–ç®¡ç†
/opt/canal/config/
â”œâ”€â”€ v1.0/
â”‚   â”œâ”€â”€ order-instance.properties
â”‚   â””â”€â”€ user-instance.properties
â”œâ”€â”€ v1.1/
â”‚   â”œâ”€â”€ order-instance.properties  
â”‚   â””â”€â”€ user-instance.properties
â””â”€â”€ current -> v1.1/

# é…ç½®å˜æ›´æµç¨‹
1. å¼€å‘ç¯å¢ƒæµ‹è¯•æ–°é…ç½®
2. æäº¤é…ç½®åˆ°Gitä»“åº“
3. æµ‹è¯•ç¯å¢ƒéªŒè¯
4. ç”Ÿäº§ç¯å¢ƒæ»šåŠ¨æ›´æ–°
```

### 6.4 æ‰¹é‡æ“ä½œå·¥å…·


**ğŸ› ï¸ å®ä¾‹ç®¡ç†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# canal-manager.sh - Canalå®ä¾‹æ‰¹é‡ç®¡ç†å·¥å…·

CANAL_HOME="/opt/canal"
INSTANCES=("order" "user" "payment")

# æ‰¹é‡å¯åŠ¨
start_all() {
    echo "å¯åŠ¨æ‰€æœ‰Canalå®ä¾‹..."
    for instance in "${INSTANCES[@]}"; do
        echo "å¯åŠ¨å®ä¾‹: $instance"
        systemctl start canal-$instance
        sleep 5
    done
}

# æ‰¹é‡åœæ­¢
stop_all() {
    echo "åœæ­¢æ‰€æœ‰Canalå®ä¾‹..."
    for instance in "${INSTANCES[@]}"; do
        echo "åœæ­¢å®ä¾‹: $instance" 
        systemctl stop canal-$instance
    done
}

# çŠ¶æ€æ£€æŸ¥
status_all() {
    echo "æ£€æŸ¥æ‰€æœ‰å®ä¾‹çŠ¶æ€..."
    for instance in "${INSTANCES[@]}"; do
        status=$(systemctl is-active canal-$instance)
        echo "å®ä¾‹ $instance: $status"
    done
}

# æ—¥å¿—æŸ¥çœ‹
logs() {
    instance=$1
    if [[ " ${INSTANCES[@]} " =~ " $instance " ]]; then
        tail -f $CANAL_HOME/logs/$instance/canal.log
    else
        echo "æ— æ•ˆçš„å®ä¾‹å: $instance"
    fi
}

# ä¸»å‡½æ•°
case "$1" in
    start)   start_all ;;
    stop)    stop_all ;;
    status)  status_all ;;
    logs)    logs $2 ;;
    *)       echo "ç”¨æ³•: $0 {start|stop|status|logs <instance>}" ;;
esac
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ å¤šå®ä¾‹æœ¬è´¨ç†è§£**ï¼š
```
ğŸ”¸ Canalå¤šå®ä¾‹ = å¤šä¸ªç‹¬ç«‹çš„æ•°æ®åŒæ­¥æœåŠ¡
ğŸ”¸ æ¯ä¸ªå®ä¾‹è´Ÿè´£ç‰¹å®šçš„æ•°æ®åº“æˆ–ä¸šåŠ¡
ğŸ”¸ å®ä¾‹é—´ç›¸äº’éš”ç¦»ï¼Œæ•…éšœä¸ä¼šä¼ æ’­
ğŸ”¸ å¯ä»¥é’ˆå¯¹ä¸åŒä¸šåŠ¡åšä¸ªæ€§åŒ–é…ç½®
ğŸ”¸ é€šè¿‡åˆç†èµ„æºåˆ†é…æé«˜æ•´ä½“æ•ˆç‡
```

### 7.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”§ é…ç½®æ ¸å¿ƒåŸåˆ™**ï¼š
```
éš”ç¦»åŸåˆ™ï¼š
â€¢ ç«¯å£éš”ç¦»ï¼šé¿å…å†²çª
â€¢ å†…å­˜éš”ç¦»ï¼šèµ„æºç‹¬äº«
â€¢ æ•°æ®éš”ç¦»ï¼šå„èµ°å„çš„é€šé“
â€¢ é…ç½®éš”ç¦»ï¼šç‹¬ç«‹ç®¡ç†

åˆ†é…åŸåˆ™ï¼š
â€¢ æŒ‰ä¸šåŠ¡é‡è¦æ€§åˆ†é…èµ„æº
â€¢ æŒ‰æ•°æ®é‡å¤§å°è°ƒæ•´ç¼“å­˜
â€¢ æŒ‰å®æ—¶æ€§è¦æ±‚è®¾ç½®ä¼˜å…ˆçº§
â€¢ æŒ‰æ•…éšœå½±å“èŒƒå›´åšå¤‡ä»½
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯æ˜ å°„**ï¼š
```
ç”µå•†åœºæ™¯ï¼š
å®ä¾‹1ï¼šè®¢å•ç³»ç»Ÿ â†’ æ•°æ®ä»“åº“ï¼ˆé‡è¦ï¼‰
å®ä¾‹2ï¼šç”¨æˆ·ç³»ç»Ÿ â†’ æ¨èå¼•æ“ï¼ˆä¸€èˆ¬ï¼‰
å®ä¾‹3ï¼šå•†å“ç³»ç»Ÿ â†’ æœç´¢å¼•æ“ï¼ˆä¸€èˆ¬ï¼‰
å®ä¾‹4ï¼šæ—¥å¿—ç³»ç»Ÿ â†’ ç›‘æ§å¹³å°ï¼ˆè¾…åŠ©ï¼‰

é“¶è¡Œåœºæ™¯ï¼š
å®ä¾‹1ï¼šäº¤æ˜“ç³»ç»Ÿ â†’ é£æ§ç³»ç»Ÿï¼ˆæ ¸å¿ƒï¼‰
å®ä¾‹2ï¼šè´¦æˆ·ç³»ç»Ÿ â†’ æŠ¥è¡¨ç³»ç»Ÿï¼ˆé‡è¦ï¼‰
å®ä¾‹3ï¼šå®¢æˆ·ç³»ç»Ÿ â†’ CRMç³»ç»Ÿï¼ˆä¸€èˆ¬ï¼‰
```

### 7.4 è¿ç»´æœ€ä½³å®è·µ


**ğŸ¯ ç®¡ç†è¦ç‚¹è®°å¿†**ï¼š
```
éƒ¨ç½²ä¸‰åŸåˆ™ï¼š
1. è§„åˆ’å…ˆè¡Œï¼šç«¯å£ã€èµ„æºã€ç›®å½•è§„èŒƒåŒ–
2. éš”ç¦»ä¸ºä¸»ï¼šèµ„æºã€ç½‘ç»œã€æ•°æ®è¦åˆ†ç¦»  
3. ç›‘æ§è·Ÿä¸Šï¼šçŠ¶æ€ã€æ€§èƒ½ã€é”™è¯¯è¦å¯è§

è¿ç»´ä¸‰æ¿æ–§ï¼š
1. è‡ªåŠ¨åŒ–ï¼šæ‰¹é‡å¯åœã€é…ç½®åŒæ­¥ã€æ•…éšœåˆ‡æ¢
2. æ ‡å‡†åŒ–ï¼šå‘½åè§„èŒƒã€é…ç½®æ¨¡æ¿ã€æ“ä½œæµç¨‹
3. å¯è§†åŒ–ï¼šç›‘æ§å¤§å±ã€çŠ¶æ€é¢æ¿ã€æŠ¥è­¦æ¨é€

æ•…éšœå¤„ç†ä¸‰æ­¥éª¤ï¼š
1. å¿«é€Ÿæ£€æµ‹ï¼š30ç§’å†…å‘ç°é—®é¢˜
2. è‡ªåŠ¨åˆ‡æ¢ï¼š60ç§’å†…æ¢å¤æœåŠ¡
3. é—®é¢˜å®šä½ï¼šæ—¥å¿—åˆ†æã€æ ¹å› è¿½è¸ª
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¤šå®ä¾‹ç®¡ç†è®²éš”ç¦»ï¼Œèµ„æºåˆ†é…è¦åˆç†
- æ•…éšœåˆ‡æ¢è¦è‡ªåŠ¨ï¼Œç›‘æ§æ²»ç†ä¸èƒ½å°‘
- é…ç½®è§„èŒƒè¦ç»Ÿä¸€ï¼Œæ‰¹é‡æ“ä½œæ•ˆç‡é«˜

**ğŸ’¡ å®æˆ˜ç»éªŒ**ï¼š
- å¤šå®ä¾‹ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè¦æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚
- èµ„æºåˆ†é…è¦è€ƒè™‘å³°å€¼æƒ…å†µï¼Œç•™æœ‰ä½™é‡
- ç›‘æ§å’Œå‘Šè­¦æ¯”æ•…éšœå¤„ç†æ›´é‡è¦
- æ ‡å‡†åŒ–è¿ç»´æ˜¯å¤šå®ä¾‹ç®¡ç†çš„åŸºç¡€