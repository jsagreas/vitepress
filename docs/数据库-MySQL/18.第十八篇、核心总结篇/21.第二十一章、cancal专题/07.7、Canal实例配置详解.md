---
title: 7、Canal实例配置详解
---
## 📚 目录

1. [Canal配置体系概述](#1-Canal配置体系概述)
2. [全局配置canal.properties详解](#2-全局配置canal-properties详解)
3. [实例配置instance.properties详解](#3-实例配置instance-properties详解)
4. [MySQL连接配置详解](#4-MySQL连接配置详解)
5. [binlog位点配置管理](#5-binlog位点配置管理)
6. [过滤规则配置实战](#6-过滤规则配置实战)
7. [性能优化配置](#7-性能优化配置)
8. [高可用配置](#8-高可用配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🏗️ Canal配置体系概述


### 1.1 什么是Canal配置体系


**Canal配置体系**就像是给Canal这个"数据搬运工"制定工作规则的说明书。它告诉Canal：
- 从哪个MySQL数据库"搬运"数据
- 搬运哪些表的数据
- 怎么搬运（性能、安全等）
- 搬运到哪里去

```
Canal配置层次结构：
┌─────────────────────────────────┐
│        Canal Server             │
│  ┌───────────────────────────┐  │
│  │    canal.properties       │  │ ← 全局配置（整个Canal服务器）
│  │    (全局配置文件)          │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌─────────────────┐            │
│  │   实例1配置      │            │ ← 实例配置（具体某个数据源）
│  │ instance.properties │        │
│  └─────────────────┘            │
│                                 │
│  ┌─────────────────┐            │
│  │   实例2配置      │            │
│  │ instance.properties │        │
│  └─────────────────┘            │
└─────────────────────────────────┘
```

### 1.2 配置文件的作用关系


**🔸 两级配置关系**
```
全局配置 (canal.properties)：
- 管理整个Canal服务器的基础设置
- 比如：服务器端口、日志级别、ZooKeeper连接等
- 相当于"总公司的规章制度"

实例配置 (instance.properties)：
- 管理具体某个数据库连接的设置  
- 比如：MySQL连接信息、同步哪些表等
- 相当于"分公司的具体业务规则"
```

**💡 优先级关系**
```
实例配置 > 全局配置

解释：如果某个配置项在两个文件中都有，
实例配置的设置会覆盖全局配置的设置
```

### 1.3 配置文件位置


**📁 文件目录结构**
```
canal-server/
├── conf/
│   ├── canal.properties              ← 全局配置文件
│   └── example/                      ← 实例目录（可以有多个）
│       └── instance.properties      ← 实例配置文件
├── bin/
│   └── startup.sh
└── lib/
```

---

## 2. ⚙️ 全局配置canal.properties详解


### 2.1 canal.properties的作用


**canal.properties**是Canal服务器的"总控制台"，负责管理整个Canal服务的基础运行环境。

### 2.2 核心配置项详解


#### 🌐 服务器基础配置


```properties
# Canal服务器唯一标识
canal.id = 1
# 解释：每个Canal服务器都需要一个唯一ID，用于集群环境下区分不同服务器

# 服务监听端口
canal.port = 11111  
# 解释：客户端连接Canal服务器时使用的端口号

# 服务器IP地址（留空表示自动获取）
canal.ip =
# 解释：通常留空让Canal自动获取本机IP
```

#### 📊 实例管理配置


```properties
# 默认启动的实例列表
canal.destinations = example
# 解释：Canal启动时会自动加载这些实例
# 多个实例用逗号分隔：example1,example2,example3

# 实例配置模式
canal.conf.dir = ../conf
# 解释：实例配置文件的存放目录
```

#### 🔧 ZooKeeper集群配置


```properties
# 是否启用ZooKeeper
canal.zkServers = 
# 解释：用于Canal集群部署，多个Canal服务器之间协调工作
# 示例：192.168.1.100:2181,192.168.1.101:2181

# ZooKeeper中的根路径
canal.zookeeper.flush.period = 1000
# 解释：向ZooKeeper刷新状态的时间间隔（毫秒）
```

### 2.3 性能调优配置


```properties
# 网络连接配置
canal.socketSoTimeout = 120000
# 解释：Socket超时时间（毫秒），防止长时间无响应

# 内存使用配置  
canal.memory.buffer.size = 16384
# 解释：内存缓冲区大小（字节），影响处理性能

# 线程池配置
canal.instance.memory.buffer.memunit = 1024
# 解释：内存单元大小，用于优化内存使用
```

---

## 3. 🎯 实例配置instance.properties详解


### 3.1 instance.properties的核心作用


**instance.properties**是Canal的"具体任务书"，详细说明了：
- 要监控哪个MySQL数据库
- 监控哪些表
- 如何处理数据变化

### 3.2 基本信息配置


```properties
# 实例工作模式
canal.instance.mode = spring
# 解释：Canal实例的运行模式
# spring模式：使用Spring容器管理（推荐）
# manager模式：使用Canal自带的管理器

# 实例是否延迟启动
canal.instance.lazy = false  
# 解释：true表示延迟启动，false表示立即启动
```

### 3.3 数据源类型配置


```properties
# 数据源类型
canal.instance.master.journal.name = 
canal.instance.master.position = 
# 解释：指定从MySQL的哪个binlog文件和位置开始读取
# 留空表示从最新位置开始
```

---

## 4. 🔗 MySQL连接配置详解


### 4.1 基础连接配置


**连接配置**就是告诉Canal怎么连接到MySQL数据库，就像告诉快递员你家的详细地址一样。

```properties
# MySQL服务器地址和端口
canal.instance.master.address = 127.0.0.1:3306
# 解释：MySQL服务器的IP地址和端口号
# 格式：IP地址:端口号

# 数据库连接账号
canal.instance.dbUsername = canal
canal.instance.dbPassword = canal
# 解释：连接MySQL使用的用户名和密码
# ⚠️ 注意：这个用户需要有特殊权限（REPLICATION权限）
```

### 4.2 连接池配置


```properties
# 连接字符集
canal.instance.connectionCharset = UTF-8
# 解释：数据传输时使用的字符编码，防止中文乱码

# 连接超时配置
canal.instance.defaultDatabaseName = test
# 解释：默认连接的数据库名称

# 启用GTIDs（全局事务标识符）
canal.instance.gtidon = false
# 解释：是否启用MySQL的GTID模式
# GTID是MySQL 5.6+的新特性，用于更好的主从复制
```

### 4.3 连接安全配置


```properties
# SSL连接配置
canal.instance.master.address = 127.0.0.1:3306
# 如果MySQL开启了SSL，需要配置SSL相关参数

# 连接验证
canal.instance.master.heartbeatPeriod = 15000
# 解释：心跳检测间隔（毫秒），确保连接始终有效
```

**💡 MySQL用户权限要求**

Canal连接MySQL的用户需要特殊权限：

```sql
-- 创建Canal专用用户
CREATE USER 'canal'@'%' IDENTIFIED BY 'canal';

-- 授予必要权限
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'canal'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

---

## 5. 📍 binlog位点配置管理


### 5.1 什么是binlog位点


**binlog位点**就像是书签，标记Canal从MySQL binlog的哪个位置开始读取数据。

```
MySQL binlog文件示例：
┌─────────────────────────────────────┐
│ mysql-bin.000001                    │ ← binlog文件名
│ ┌─────────────────────────────────┐ │
│ │ Position 120: INSERT user...    │ │ ← 位置120的操作
│ │ Position 245: UPDATE order...   │ │ ← 位置245的操作  
│ │ Position 380: DELETE product... │ │ ← 位置380的操作
│ │ Position 456: ...              │ │ ← Canal从这里开始读取
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 5.2 位点配置详解


#### 🎯 指定开始位点


```properties
# 指定binlog文件名
canal.instance.master.journal.name = mysql-bin.000001
# 解释：从哪个binlog文件开始读取

# 指定binlog位置  
canal.instance.master.position = 456
# 解释：从文件中的哪个位置开始读取

# 指定时间戳位点
canal.instance.master.timestamp = 
# 解释：从某个时间点开始读取（可以代替文件名+位置的方式）
```

#### 🔄 位点管理策略


```properties
# 位点存储方式
canal.instance.memory.buffer.size = 16384
# 解释：内存中缓存的binlog数据大小

# 位点持久化
canal.instance.memory.buffer.memunit = 1024  
# 解释：内存管理单元大小，影响位点保存频率
```

### 5.3 位点恢复机制


**🔸 Canal启动时的位点选择策略**
```
1. 如果配置了具体的journal.name和position
   → 从指定位置开始

2. 如果配置了timestamp  
   → 从指定时间点开始

3. 如果都没配置
   → 从当前最新位置开始（不会读取历史数据）
```

**⚠️ 重要提醒**
```
位点配置的注意事项：

✅ 生产环境建议：
- 首次启动时指定明确的起始位点
- 定期备份位点信息
- 监控位点延迟情况

❌ 避免的做法：
- 不要随意修改正在运行实例的位点
- 不要在不了解的情况下跳跃位点
```

---

## 6. 🎛️ 过滤规则配置实战


### 6.1 过滤规则的作用


**过滤规则**就像是筛子，决定Canal要"捕捉"哪些数据变化，忽略哪些数据变化。

```
没有过滤规则时：
MySQL中所有表的变化 → 全部发送给Canal客户端

有过滤规则时：  
MySQL中所有表的变化 → 筛选器 → 只有符合规则的变化 → 发送给Canal客户端
```

### 6.2 表名过滤配置


#### 🏷️ 基础表名过滤


```properties
# 数据库和表的过滤规则
canal.instance.filter.regex = .*\\..*
# 解释：正则表达式，指定要监控的数据库和表
# .*\\..*  表示监控所有数据库的所有表

# 具体示例
canal.instance.filter.regex = test\\.user,test\\.order
# 解释：只监控test数据库的user表和order表

# 多数据库示例
canal.instance.filter.regex = shop\\..*, user_center\\.user
# 解释：监控shop数据库的所有表，以及user_center数据库的user表
```

#### 🎯 正则表达式详解


**正则表达式语法说明**：

| 表达式 | 含义 | 示例 |
|-------|------|------|
| `.*` | 匹配任意字符任意次数 | `shop\\..*` = shop数据库的所有表 |
| `\\.` | 匹配点号（.） | `test\\.user` = test.user表 |
| `|` | 或者关系 | `user\\..*|order\\..*` = user或order数据库 |
| `^` | 开始位置 | `^test\\..*` = 以test开头的数据库 |
| `$` | 结束位置 | `.*\\.log$` = 以log结尾的表 |

**🔸 实用过滤规则示例**

```properties
# 示例1：只监控电商核心表
canal.instance.filter.regex = shop\\.user,shop\\.order,shop\\.product

# 示例2：排除日志表和临时表  
canal.instance.filter.regex = ^(?!.*(_log|_temp|_backup)).*\\..*

# 示例3：只监控特定前缀的表
canal.instance.filter.regex = .*\\.(t_|sys_).*

# 示例4：监控多个数据库的用户相关表
canal.instance.filter.regex = (shop|user_center|payment)\\..*user.*
```

### 6.3 字段过滤配置


#### 📝 字段级别过滤


虽然instance.properties主要配置表级过滤，但可以通过客户端进一步实现字段过滤：

```properties
# 表级过滤后，客户端可以进一步处理
# 例如：只关注某些字段的变化
# 这部分通常在Canal客户端代码中实现
```

**客户端字段过滤示例**：
```java
// 在Canal客户端中进行字段过滤
if (rowData.getColumns().stream()
    .anyMatch(column -> 
        "password".equals(column.getName()) || 
        "secret_key".equals(column.getName()))) {
    // 跳过包含敏感字段的变更
    return;
}
```

### 6.4 黑白名单配置


```properties
# 黑名单配置（排除某些表）
canal.instance.filter.black.regex = .*\\.test_.*,.*\\.tmp_.*
# 解释：排除所有test_开头和tmp_开头的表

# 与白名单的组合使用
canal.instance.filter.regex = shop\\..*
canal.instance.filter.black.regex = shop\\.test_.*
# 解释：监控shop数据库所有表，但排除test_开头的表
```

---

## 7. ⚡ 性能优化配置


### 7.1 内存缓冲配置


**内存缓冲**就像是Canal的"工作台"，缓冲区越大，处理数据的效率越高，但占用内存也越多。

```properties
# 内存缓冲区大小（字节）
canal.instance.memory.buffer.size = 16384
# 解释：Canal在内存中缓存的binlog数据大小
# 建议值：16KB-1MB，根据数据量调整

# 内存单元大小
canal.instance.memory.buffer.memunit = 1024
# 解释：内存分配的最小单元（字节）
# 影响内存使用效率

# 批处理大小
canal.instance.memory.rawEntry = true  
# 解释：是否启用原始Entry模式，提高性能
```

**🔸 内存配置调优指南**

```
数据量级          建议buffer.size      适用场景
小型项目          16KB-64KB           几十张表，QPS < 1000
中型项目          64KB-256KB          上百张表，QPS 1000-5000  
大型项目          256KB-1MB           数百张表，QPS > 5000
超大型项目        1MB-4MB             千张表以上，高并发
```

### 7.2 事务处理配置


```properties
# 事务大小限制
canal.instance.transactionSize = 1024
# 解释：单个事务包含的最大变更记录数
# 超过此数值的大事务会被分割处理

# 批量获取大小
canal.instance.memory.buffer.size = 16384
# 解释：每次从内存中获取数据的批量大小
```

### 7.3 网络优化配置


```properties
# 网络超时配置
canal.instance.detecting.timeout = 30000
# 解释：检测超时时间（毫秒）

# 重连配置
canal.instance.detecting.interval.time = 3000  
# 解释：检测间隔时间，用于连接异常时的重连
```

---

## 8. 🛡️ 高可用配置


### 8.1 故障转移配置


**故障转移**就是当主MySQL服务器出现问题时，Canal自动切换到备用MySQL服务器继续工作。

```properties
# 主备切换配置
canal.instance.standby.address = 192.168.1.101:3306
# 解释：备用MySQL服务器地址
# 当主服务器失效时，自动切换到此服务器

# 主备切换用户
canal.instance.standby.journal.name = 
# 解释：备用服务器的binlog起始文件名

# 切换时间配置
canal.instance.detecting.enable = true
# 解释：是否启用连接检测，用于故障发现
```

### 8.2 集群配置


```properties
# ZooKeeper集群配置
canal.zkServers = 192.168.1.100:2181,192.168.1.101:2181,192.168.1.102:2181
# 解释：ZooKeeper集群地址，用于Canal集群协调

# 实例运行节点配置
canal.instance.cluster.node = canal-node-1
# 解释：当前Canal节点在集群中的标识
```

### 8.3 监控配置


```properties
# 延迟监控
canal.instance.detecting.heartbeatHaEnable = true
# 解释：是否启用心跳检测，监控主从延迟

# 位点保存策略
canal.instance.memory.buffer.size = 16384
# 解释：影响位点保存的频率和可靠性
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的配置要点


```
🔸 配置层次：全局配置(canal.properties) + 实例配置(instance.properties)
🔸 连接配置：MySQL地址、用户名密码、权限要求
🔸 位点管理：起始位置、位点恢复、位点持久化
🔸 过滤规则：正则表达式、白名单黑名单、字段过滤
🔸 性能优化：内存缓冲、事务大小、批处理配置
🔸 高可用性：故障转移、集群配置、监控告警
```

### 9.2 关键理解要点


**🔹 配置文件的关系**
```
canal.properties：管家总规则
instance.properties：具体工作指南
优先级：实例配置 > 全局配置
```

**🔹 过滤规则的设计思路**
```
设计原则：
1. 只监控必要的表，减少性能消耗
2. 排除临时表、日志表等无关表
3. 使用正则表达式提高灵活性
4. 结合业务需求制定过滤策略
```

**🔹 性能调优的平衡**
```
内存 vs 性能：
- 内存越大，缓冲能力越强，性能越好
- 但要考虑服务器内存限制

实时性 vs 稳定性：  
- 缓冲区太小影响性能
- 缓冲区太大影响实时性
```

### 9.3 实际应用指导


**✅ 推荐配置模式**
```
开发环境：
- 简单配置，监控少量核心表
- 较小的内存缓冲
- 不需要高可用配置

生产环境：
- 详细的过滤规则
- 充足的内存缓冲配置  
- 完整的高可用和监控配置
- 定期备份配置文件
```

**⚠️ 常见配置错误**
```
连接配置错误：
- 用户权限不足
- 网络连接问题
- 字符集不匹配

过滤规则错误：
- 正则表达式语法错误
- 过滤范围过大或过小
- 忘记转义特殊字符

性能配置错误：  
- 内存配置过小导致频繁GC
- 事务大小配置不合理
- 没有根据实际负载调优
```

**核心记忆要点**：
- Canal配置分两层：全局管服务器，实例管具体库表
- MySQL连接需要特殊权限：REPLICATION SLAVE + REPLICATION CLIENT  
- 过滤规则用正则表达式：数据库\\.表名的格式
- 性能核心在内存缓冲：根据数据量合理配置buffer大小
- 生产环境必须考虑高可用：主备切换 + 集群部署