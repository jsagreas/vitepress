---
title: 13ã€Canal Clientå¼€å‘åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [Canal ClientåŸºç¡€æ¦‚å¿µ](#1-Canal-ClientåŸºç¡€æ¦‚å¿µ)
2. [CanalConnectoræ¥å£è¯¦è§£](#2-CanalConnectoræ¥å£è¯¦è§£)
3. [SimpleCanalConnectorä½¿ç”¨](#3-SimpleCanalConnectorä½¿ç”¨)
4. [ClusterCanalConnectoré›†ç¾¤](#4-ClusterCanalConnectoré›†ç¾¤)
5. [æ¶ˆæ¯è®¢é˜…ä¸å¤„ç†](#5-æ¶ˆæ¯è®¢é˜…ä¸å¤„ç†)
6. [ACKç¡®è®¤æœºåˆ¶](#6-ACKç¡®è®¤æœºåˆ¶)
7. [å¼‚å¸¸å¤„ç†ä¸é‡è¿ç­–ç•¥](#7-å¼‚å¸¸å¤„ç†ä¸é‡è¿ç­–ç•¥)
8. [å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†](#8-å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Canal ClientåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Canal Client


**ç®€å•ç†è§£**ï¼šCanal Clientå°±æ˜¯ä½ çš„åº”ç”¨ç¨‹åºè¿æ¥Canal Serverçš„æ¡¥æ¢ï¼Œç”¨æ¥æ¥æ”¶MySQLçš„æ•°æ®å˜åŒ–

```
MySQLæ•°æ®åº“ â†’ Canal Server â†’ Canal Client â†’ ä½ çš„åº”ç”¨ç¨‹åº
    â†“              â†“            â†“           â†“
   å‘ç”Ÿå˜åŒ–      æ•è·binlog    æ¥æ”¶æ¶ˆæ¯     å¤„ç†ä¸šåŠ¡é€»è¾‘
```

**Canal Clientçš„æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”— **è¿æ¥Canal Server** - å»ºç«‹ç¨³å®šçš„ç½‘ç»œè¿æ¥
- ğŸ“¥ **è®¢é˜…æ•°æ®å˜åŒ–** - æŒ‡å®šè¦ç›‘å¬çš„æ•°æ®åº“å’Œè¡¨
- ğŸ“¨ **æ¥æ”¶å˜æ›´æ¶ˆæ¯** - è·å–å¢åˆ æ”¹çš„å…·ä½“æ•°æ®
- âœ… **ç¡®è®¤æ¶ˆæ¯å¤„ç†** - å‘Šè¯‰Canalå·²ç»å¤„ç†å®Œæˆ

### 1.2 Canal Clientæ¶æ„è®¾è®¡


**Canalå®¢æˆ·ç«¯æ•´ä½“æ¶æ„**ï¼š
```
åº”ç”¨ç¨‹åºå±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡å¤„ç†é€»è¾‘       â”‚ â† ä½ ç¼–å†™çš„å…·ä½“ä¸šåŠ¡ä»£ç 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Canal Client API â”‚ â† æ¶ˆæ¯è·å–ã€ACKç¡®è®¤ç­‰æ“ä½œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CanalConnector     â”‚ â† è¿æ¥å™¨æ¥å£ï¼ˆSimple/Clusterï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç½‘ç»œé€šä¿¡å±‚         â”‚ â† TCPè¿æ¥ã€æ¶ˆæ¯åºåˆ—åŒ–ç­‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
Canal Server
```

**å·¥ä½œæµç¨‹æ¦‚è¿°**ï¼š
1. **å»ºç«‹è¿æ¥** - è¿æ¥åˆ°Canal Server
2. **è®¢é˜…é¢‘é“** - æŒ‡å®šè¦ç›‘å¬çš„destination
3. **è·å–æ¶ˆæ¯** - å¾ªç¯æ‹‰å–æ•°æ®å˜æ›´æ¶ˆæ¯
4. **å¤„ç†æ•°æ®** - è§£ææ¶ˆæ¯å¹¶æ‰§è¡Œä¸šåŠ¡é€»è¾‘
5. **ç¡®è®¤å¤„ç†** - å‘é€ACKç¡®è®¤æ¶ˆæ¯

---

## 2. ğŸ”Œ CanalConnectoræ¥å£è¯¦è§£


### 2.1 CanalConnectoræ ¸å¿ƒæ¥å£


**ä»€ä¹ˆæ˜¯CanalConnector**ï¼šè¿æ¥Canal Serverçš„ç»Ÿä¸€æ¥å£ï¼Œå®šä¹‰äº†æ‰€æœ‰å®¢æˆ·ç«¯æ“ä½œ

```java
public interface CanalConnector {
    // è¿æ¥æ“ä½œ
    void connect() throws CanalClientException;
    void disconnect() throws CanalClientException;
    
    // è®¢é˜…æ“ä½œ
    void subscribe(String filter) throws CanalClientException;
    void unsubscribe() throws CanalClientException;
    
    // æ¶ˆæ¯æ“ä½œ  
    Message get(int batchSize) throws CanalClientException;
    Message getWithoutAck(int batchSize) throws CanalClientException;
    
    // ç¡®è®¤æ“ä½œ
    void ack(long batchId) throws CanalClientException;
    void rollback(long batchId) throws CanalClientException;
}
```

### 2.2 æ¥å£æ–¹æ³•è¯¦è§£


**ğŸ”¸ è¿æ¥ç®¡ç†æ–¹æ³•**
```java
// å»ºç«‹è¿æ¥
connector.connect();  
// ä½œç”¨ï¼šä¸Canal Serverå»ºç«‹TCPè¿æ¥
// æ³¨æ„ï¼šè¿æ¥å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸

// æ–­å¼€è¿æ¥
connector.disconnect();
// ä½œç”¨ï¼šå…³é—­ä¸Canal Serverçš„è¿æ¥
// å»ºè®®ï¼šåº”ç”¨ç¨‹åºé€€å‡ºå‰å¿…é¡»è°ƒç”¨
```

**ğŸ”¸ è®¢é˜…ç®¡ç†æ–¹æ³•**
```java
// è®¢é˜…æ•°æ®å˜åŒ–
connector.subscribe("mydb\\..*");
// å‚æ•°ï¼šæ­£åˆ™è¡¨è¾¾å¼ï¼ŒæŒ‡å®šè¦ç›‘å¬çš„åº“è¡¨
// ç¤ºä¾‹ï¼š
//   ".*\\..*"     - ç›‘å¬æ‰€æœ‰åº“çš„æ‰€æœ‰è¡¨  
//   "test\\..*"   - ç›‘å¬teståº“çš„æ‰€æœ‰è¡¨
//   "test\\.user" - åªç›‘å¬test.userè¡¨

// å–æ¶ˆè®¢é˜…
connector.unsubscribe();
// ä½œç”¨ï¼šåœæ­¢æ¥æ”¶æ•°æ®å˜åŒ–æ¶ˆæ¯
```

### 2.3 CanalConnectorå®ç°ç±»å‹


**Canalæä¾›çš„å®ç°ç±»**ï¼š
```
CanalConnectoræ¥å£
    â”œâ”€ SimpleCanalConnector   â† å•æœºè¿æ¥
    â””â”€ ClusterCanalConnector  â† é›†ç¾¤è¿æ¥

é€‰æ‹©åŸåˆ™ï¼š
â”œâ”€ å¼€å‘æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨SimpleCanalConnector
â”œâ”€ ç”Ÿäº§ç¯å¢ƒï¼šæ¨èClusterCanalConnector  
â””â”€ é«˜å¯ç”¨è¦æ±‚ï¼šå¿…é¡»ä½¿ç”¨ClusterCanalConnector
```

---

## 3. ğŸ”§ SimpleCanalConnectorä½¿ç”¨


### 3.1 SimpleCanalConnectoråŸºæœ¬é…ç½®


**ä»€ä¹ˆæ˜¯SimpleCanalConnector**ï¼šç›´è¿å•ä¸ªCanal Serverå®ä¾‹çš„è¿æ¥å™¨

```java
// åˆ›å»ºè¿æ¥å™¨
CanalConnector connector = CanalConnectors.newSingleConnector(
    new InetSocketAddress("127.0.0.1", 11111),  // Canal Serveråœ°å€
    "example",                                   // destinationåç§°  
    "canal",                                     // ç”¨æˆ·å
    "canal"                                      // å¯†ç 
);
```

**è¿æ¥å‚æ•°è¯´æ˜**ï¼š
- **æœåŠ¡å™¨åœ°å€**ï¼šCanal Serverçš„IPå’Œç«¯å£ï¼ˆé»˜è®¤11111ï¼‰
- **destination**ï¼šCanal Serveré…ç½®çš„å®ä¾‹åç§°
- **ç”¨æˆ·å/å¯†ç **ï¼šCanal Serverçš„è®¤è¯ä¿¡æ¯

### 3.2 åŸºç¡€ä½¿ç”¨ç¤ºä¾‹


```java
public class SimpleCanalClient {
    private CanalConnector connector;
    
    public void start() {
        // 1. åˆ›å»ºè¿æ¥å™¨
        connector = CanalConnectors.newSingleConnector(
            new InetSocketAddress("localhost", 11111),
            "example", "canal", "canal"
        );
        
        try {
            // 2. å»ºç«‹è¿æ¥
            connector.connect();
            
            // 3. è®¢é˜…æ•°æ®å˜åŒ–
            connector.subscribe("test\\..*");
            
            // 4. å¾ªç¯è·å–æ¶ˆæ¯
            while (true) {
                Message message = connector.get(100); // æ‰¹é‡è·å–100æ¡
                long batchId = message.getBatchId();
                
                if (batchId != -1 && !message.getEntries().isEmpty()) {
                    processMessage(message);
                    connector.ack(batchId); // ç¡®è®¤å¤„ç†å®Œæˆ
                }
                
                Thread.sleep(1000); // é¿å…ç©ºè½®è¯¢
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            connector.disconnect();
        }
    }
    
    private void processMessage(Message message) {
        for (Entry entry : message.getEntries()) {
            if (entry.getEntryType() == EntryType.ROWDATA) {
                RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                
                for (RowData rowData : rowChange.getRowDatasList()) {
                    if (rowChange.getEventType() == EventType.INSERT) {
                        System.out.println("æ–°å¢æ•°æ®ï¼š" + rowData.getAfterColumnsList());
                    } else if (rowChange.getEventType() == EventType.UPDATE) {
                        System.out.println("ä¿®æ”¹æ•°æ®ï¼š" + rowData.getAfterColumnsList());
                    } else if (rowChange.getEventType() == EventType.DELETE) {
                        System.out.println("åˆ é™¤æ•°æ®ï¼š" + rowData.getBeforeColumnsList());
                    }
                }
            }
        }
    }
}
```

### 3.3 SimpleCanalConnectorä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹**ï¼š
- é…ç½®ç®€å•ï¼Œé€‚åˆå¿«é€Ÿå¼€å‘
- ç›´è¿æ–¹å¼ï¼Œå»¶è¿Ÿè¾ƒä½
- è°ƒè¯•æ–¹ä¾¿ï¼Œé—®é¢˜å®¹æ˜“å®šä½

**âŒ ç¼ºç‚¹**ï¼š
- å•ç‚¹æ•…éšœé£é™©
- ä¸æ”¯æŒè‡ªåŠ¨æ•…éšœè½¬ç§»
- æ‰©å±•æ€§æœ‰é™

---

## 4. ğŸŒ ClusterCanalConnectoré›†ç¾¤


### 4.1 ClusterCanalConnectoråŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ClusterCanalConnector**ï¼šæ”¯æŒè¿æ¥Canal Serveré›†ç¾¤çš„è¿æ¥å™¨ï¼Œå…·æœ‰é«˜å¯ç”¨ç‰¹æ€§

```
å®¢æˆ·ç«¯åº”ç”¨
    â†“
ClusterCanalConnector
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Canal Serveré›†ç¾¤          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Server1 â”‚  â”‚   Server2   â”‚   â”‚
â”‚  â”‚ (ä¸»)    â”‚  â”‚   (å¤‡)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ZooKeeperåè°ƒæœåŠ¡
```

### 4.2 é›†ç¾¤è¿æ¥é…ç½®


```java
// åŸºäºZooKeeperçš„é›†ç¾¤è¿æ¥
CanalConnector connector = CanalConnectors.newClusterConnector(
    "zk1:2181,zk2:2181,zk3:2181",  // ZooKeeperé›†ç¾¤åœ°å€
    "example",                      // destinationåç§°
    "canal",                       // ç”¨æˆ·å  
    "canal"                        // å¯†ç 
);
```

**é›†ç¾¤é…ç½®å‚æ•°**ï¼š
- **ZooKeeperåœ°å€**ï¼šå¤šä¸ªZKèŠ‚ç‚¹ç”¨é€—å·åˆ†éš”
- **destination**ï¼šé›†ç¾¤ä¸­é…ç½®çš„å®ä¾‹åç§°
- **è®¤è¯ä¿¡æ¯**ï¼šé›†ç¾¤ç»Ÿä¸€çš„ç”¨æˆ·åå¯†ç 

### 4.3 é›†ç¾¤è¿æ¥å®Œæ•´ç¤ºä¾‹


```java
public class ClusterCanalClient {
    private CanalConnector connector;
    private volatile boolean running = true;
    
    public void start() {
        // åˆ›å»ºé›†ç¾¤è¿æ¥å™¨
        connector = CanalConnectors.newClusterConnector(
            "192.168.1.10:2181,192.168.1.11:2181,192.168.1.12:2181",
            "example", "canal", "canal"
        );
        
        try {
            connector.connect();
            connector.subscribe(".*\\..*"); // ç›‘å¬æ‰€æœ‰åº“è¡¨
            
            while (running) {
                try {
                    Message message = connector.get(100);
                    long batchId = message.getBatchId();
                    
                    if (batchId != -1 && !message.getEntries().isEmpty()) {
                        boolean success = processMessageWithRetry(message);
                        if (success) {
                            connector.ack(batchId);
                        } else {
                            connector.rollback(batchId); // å¤„ç†å¤±è´¥ï¼Œå›æ»š
                        }
                    }
                    
                    Thread.sleep(500);
                } catch (CanalClientException e) {
                    // å¤„ç†è¿æ¥å¼‚å¸¸ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨æ•…éšœè½¬ç§»
                    System.err.println("è¿æ¥å¼‚å¸¸ï¼Œç­‰å¾…è‡ªåŠ¨é‡è¿: " + e.getMessage());
                    Thread.sleep(5000);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            if (connector != null) {
                connector.disconnect();
            }
        }
    }
    
    public void stop() {
        running = false;
    }
    
    private boolean processMessageWithRetry(Message message) {
        int maxRetries = 3;
        for (int i = 0; i < maxRetries; i++) {
            try {
                processMessage(message);
                return true;
            } catch (Exception e) {
                System.err.println("å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼Œé‡è¯• " + (i + 1) + "/" + maxRetries);
                if (i == maxRetries - 1) {
                    // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œå¯ä»¥è€ƒè™‘å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                    System.err.println("æ¶ˆæ¯å¤„ç†æœ€ç»ˆå¤±è´¥: " + e.getMessage());
                    return false;
                }
                try {
                    Thread.sleep(1000 * (i + 1)); // æŒ‡æ•°é€€é¿
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    return false;
                }
            }
        }
        return false;
    }
}
```

### 4.4 é›†ç¾¤æ¨¡å¼ä¼˜åŠ¿


**ğŸ”¸ é«˜å¯ç”¨æ€§**
```
ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼š
1. ZooKeeperæ£€æµ‹åˆ°èŠ‚ç‚¹ä¸‹çº¿
2. å®¢æˆ·ç«¯è‡ªåŠ¨è¿æ¥åˆ°å¤‡ç”¨èŠ‚ç‚¹  
3. ä¸šåŠ¡å¤„ç†æ— ä¸­æ–­
4. æ•…éšœèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨åŠ å…¥é›†ç¾¤

æ•…éšœè½¬ç§»æ—¶é—´ï¼šé€šå¸¸ < 30ç§’
```

**ğŸ”¸ è´Ÿè½½å‡è¡¡**
```
å¤šå®¢æˆ·ç«¯åœºæ™¯ï¼š
â”œâ”€ å®¢æˆ·ç«¯Aè¿æ¥ Canal Server1
â”œâ”€ å®¢æˆ·ç«¯Bè¿æ¥ Canal Server2  
â”œâ”€ å®¢æˆ·ç«¯Cè¿æ¥ Canal Server3
â””â”€ è‡ªåŠ¨è´Ÿè½½åˆ†é…ï¼Œé¿å…å•ç‚¹è¿‡è½½
```

---

## 5. ğŸ“¨ æ¶ˆæ¯è®¢é˜…ä¸å¤„ç†


### 5.1 è®¢é˜…æ¶ˆæ¯é…ç½®


**è®¢é˜…è¿‡æ»¤è§„åˆ™**ï¼š
```java
// è®¢é˜…æ‰€æœ‰åº“è¡¨
connector.subscribe(".*\\..*");

// è®¢é˜…ç‰¹å®šæ•°æ®åº“
connector.subscribe("mydb\\..*");

// è®¢é˜…ç‰¹å®šè¡¨
connector.subscribe("mydb\\.users,mydb\\.orders");

// å¤æ‚è¿‡æ»¤è§„åˆ™
connector.subscribe("(db1|db2)\\.table_.*");
```

**è¿‡æ»¤è§„åˆ™è¯­æ³•**ï¼š
```
åŸºç¡€è¯­æ³•ï¼š
â”œâ”€ . : åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦
â”œâ”€ * : åŒ¹é…0ä¸ªæˆ–å¤šä¸ªå­—ç¬¦  
â”œâ”€ \\.: åŒ¹é…å­—é¢ä¸Šçš„ç‚¹å·ï¼ˆåº“è¡¨åˆ†éš”ç¬¦ï¼‰
â”œâ”€ | : æˆ–æ“ä½œ
â”œâ”€ () : åˆ†ç»„
â””â”€ [] : å­—ç¬¦ç±»

å¸¸ç”¨æ¨¡å¼ï¼š
â”œâ”€ "test\\..*"           - teståº“çš„æ‰€æœ‰è¡¨
â”œâ”€ ".*\\.user.*"         - æ‰€æœ‰åº“ä¸­åŒ…å«userçš„è¡¨  
â”œâ”€ "db[1-3]\\..*"       - db1,db2,db3åº“çš„æ‰€æœ‰è¡¨
â””â”€ "(order|product)_.*" - ä»¥order_æˆ–product_å¼€å¤´çš„è¡¨
```

### 5.2 æ‰¹é‡æ¶ˆæ¯å¤„ç†


**æ‰¹é‡è·å–ç­–ç•¥**ï¼š
```java
public class BatchMessageProcessor {
    
    public void processMessages() {
        while (true) {
            // æ‰¹é‡è·å–æ¶ˆæ¯
            Message message = connector.get(100); // ä¸€æ¬¡æœ€å¤š100æ¡
            
            if (message.getBatchId() != -1) {
                List<Entry> entries = message.getEntries();
                
                if (entries.size() > 0) {
                    System.out.println("æœ¬æ‰¹æ¬¡æ¶ˆæ¯æ•°é‡: " + entries.size());
                    
                    // æ‰¹é‡å¤„ç†
                    processBatch(entries);
                    
                    // æ‰¹é‡ç¡®è®¤
                    connector.ack(message.getBatchId());
                }
            }
            
            // é¿å…ç©ºè½®è¯¢CPUæ¶ˆè€—
            if (message.getEntries().isEmpty()) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        }
    }
    
    private void processBatch(List<Entry> entries) {
        List<DataChange> changes = new ArrayList<>();
        
        for (Entry entry : entries) {
            if (entry.getEntryType() == EntryType.ROWDATA) {
                try {
                    RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                    String tableName = entry.getHeader().getTableName();
                    String schemaName = entry.getHeader().getSchemaName();
                    
                    for (RowData rowData : rowChange.getRowDatasList()) {
                        DataChange change = new DataChange();
                        change.setDatabase(schemaName);
                        change.setTable(tableName);
                        change.setEventType(rowChange.getEventType());
                        change.setRowData(rowData);
                        changes.add(change);
                    }
                } catch (Exception e) {
                    System.err.println("è§£ææ¶ˆæ¯å¤±è´¥: " + e.getMessage());
                }
            }
        }
        
        // æ‰¹é‡å¤„ç†ä¸šåŠ¡é€»è¾‘
        if (!changes.isEmpty()) {
            batchProcessChanges(changes);
        }
    }
    
    private void batchProcessChanges(List<DataChange> changes) {
        // æŒ‰è¡¨ååˆ†ç»„å¤„ç†
        Map<String, List<DataChange>> tableGroups = changes.stream()
            .collect(Collectors.groupingBy(c -> c.getDatabase() + "." + c.getTable()));
            
        for (Map.Entry<String, List<DataChange>> entry : tableGroups.entrySet()) {
            String fullTableName = entry.getKey();
            List<DataChange> tableChanges = entry.getValue();
            
            System.out.println("å¤„ç†è¡¨ " + fullTableName + " çš„ " + tableChanges.size() + " æ¡å˜æ›´");
            // å…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
            processTableChanges(fullTableName, tableChanges);
        }
    }
}
```

### 5.3 æ¶ˆæ¯è§£æä¸è½¬æ¢


**Entryæ¶ˆæ¯ç»“æ„è§£æ**ï¼š
```java
public class MessageParser {
    
    public void parseEntry(Entry entry) {
        Header header = entry.getHeader();
        
        // åŸºç¡€ä¿¡æ¯
        System.out.println("æ•°æ®åº“: " + header.getSchemaName());
        System.out.println("è¡¨å: " + header.getTableName());  
        System.out.println("æ“ä½œæ—¶é—´: " + new Date(header.getExecuteTime()));
        System.out.println("binlogä½ç½®: " + header.getLogfileName() + ":" + header.getLogfileOffset());
        
        // è§£æè¡Œæ•°æ®
        if (entry.getEntryType() == EntryType.ROWDATA) {
            try {
                RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                EventType eventType = rowChange.getEventType();
                
                for (RowData rowData : rowChange.getRowDatasList()) {
                    switch (eventType) {
                        case INSERT:
                            handleInsert(rowData.getAfterColumnsList());
                            break;
                        case UPDATE:  
                            handleUpdate(rowData.getBeforeColumnsList(), 
                                       rowData.getAfterColumnsList());
                            break;
                        case DELETE:
                            handleDelete(rowData.getBeforeColumnsList());
                            break;
                        default:
                            System.out.println("æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: " + eventType);
                    }
                }
            } catch (Exception e) {
                System.err.println("è§£æRowæ•°æ®å¤±è´¥: " + e.getMessage());
            }
        }
    }
    
    private void handleInsert(List<Column> columns) {
        System.out.println("=== æ–°å¢è®°å½• ===");
        for (Column column : columns) {
            System.out.println(column.getName() + " = " + column.getValue());
        }
    }
    
    private void handleUpdate(List<Column> before, List<Column> after) {
        System.out.println("=== æ›´æ–°è®°å½• ===");
        
        // æ¯”è¾ƒå˜æ›´çš„å­—æ®µ
        Map<String, String> beforeMap = before.stream()
            .collect(Collectors.toMap(Column::getName, Column::getValue));
        Map<String, String> afterMap = after.stream()  
            .collect(Collectors.toMap(Column::getName, Column::getValue));
            
        for (Column afterCol : after) {
            String name = afterCol.getName();
            String oldValue = beforeMap.get(name);
            String newValue = afterCol.getValue();
            
            if (!Objects.equals(oldValue, newValue)) {
                System.out.println(name + ": " + oldValue + " â†’ " + newValue);
            }
        }
    }
    
    private void handleDelete(List<Column> columns) {
        System.out.println("=== åˆ é™¤è®°å½• ===");
        for (Column column : columns) {
            System.out.println(column.getName() + " = " + column.getValue());
        }
    }
}
```

---

## 6. âœ… ACKç¡®è®¤æœºåˆ¶


### 6.1 ACKæœºåˆ¶åŸç†


**ä»€ä¹ˆæ˜¯ACKç¡®è®¤**ï¼šå‘Šè¯‰Canal Serveræ¶ˆæ¯å·²ç»å¤„ç†å®Œæˆï¼Œå¯ä»¥æ¨è¿›binlogä½ç‚¹

```
æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š
1. Canal Clientè·å–æ¶ˆæ¯ (getæ–¹æ³•)
2. è§£æå¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘
3. å¤„ç†æˆåŠŸåå‘é€ACKç¡®è®¤  
4. Canal Serveræ›´æ–°æ¶ˆè´¹ä½ç‚¹
5. ç»§ç»­å‘é€åç»­æ¶ˆæ¯

ä½ç‚¹æ¨è¿›ç¤ºæ„ï¼š
MySQL binlog: |----å·²ç¡®è®¤----|----å¾…å¤„ç†----|----æœªå‘é€----|
             pos1        pos2(å½“å‰)   pos3        pos4
                                â†‘
                           ACKæ¨è¿›åˆ°è¿™é‡Œ
```

### 6.2 ACKç¡®è®¤æ–¹å¼å¯¹æ¯”


**ğŸ”¸ è‡ªåŠ¨ACK vs æ‰‹åŠ¨ACK**

| æ–¹å¼ | **æ–¹æ³•** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|----------|----------|----------|-------------|
| **è‡ªåŠ¨ACK** | `get(batchSize)` | `ç®€å•ä¾¿æ·ï¼Œæ— éœ€æ‰‹åŠ¨ç¡®è®¤` | `å¤„ç†å¤±è´¥ä¹Ÿä¼šç¡®è®¤ï¼Œå¯èƒ½ä¸¢æ•°æ®` | `å…è®¸å°‘é‡æ•°æ®ä¸¢å¤±çš„åœºæ™¯` |
| **æ‰‹åŠ¨ACK** | `getWithoutAck() + ack()` | `ç²¾ç¡®æ§åˆ¶ï¼Œå¤„ç†æˆåŠŸæ‰ç¡®è®¤` | `éœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œé€»è¾‘å¤æ‚` | `æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯` |

### 6.3 æ‰‹åŠ¨ACKæœ€ä½³å®è·µ


```java
public class ManualAckProcessor {
    private CanalConnector connector;
    
    public void processWithManualAck() {
        while (true) {
            try {
                // è·å–æ¶ˆæ¯ä½†ä¸è‡ªåŠ¨ç¡®è®¤
                Message message = connector.getWithoutAck(100);
                long batchId = message.getBatchId();
                
                if (batchId == -1 || message.getEntries().isEmpty()) {
                    Thread.sleep(1000);
                    continue;
                }
                
                boolean processSuccess = false;
                try {
                    // å¤„ç†ä¸šåŠ¡é€»è¾‘
                    processMessage(message);
                    processSuccess = true;
                    
                } catch (Exception e) {
                    System.err.println("å¤„ç†æ¶ˆæ¯å¤±è´¥: " + e.getMessage());
                    
                    // æ ¹æ®å¼‚å¸¸ç±»å‹å†³å®šæ˜¯å¦é‡è¯•
                    if (isRetryableException(e)) {
                        // å¯é‡è¯•å¼‚å¸¸ï¼Œå›æ»šæ¶ˆæ¯
                        connector.rollback(batchId);
                        System.out.println("æ¶ˆæ¯å·²å›æ»šï¼Œç­‰å¾…é‡è¯•");
                        Thread.sleep(5000);
                        continue;
                    } else {
                        // ä¸å¯é‡è¯•å¼‚å¸¸ï¼Œè®°å½•é”™è¯¯å¹¶è·³è¿‡
                        logFailedMessage(message, e);
                        processSuccess = true; // è·³è¿‡æ­¤æ¶ˆæ¯
                    }
                }
                
                if (processSuccess) {
                    // ç¡®è®¤æ¶ˆæ¯å¤„ç†å®Œæˆ
                    connector.ack(batchId);
                    System.out.println("æ¶ˆæ¯å¤„ç†å®Œæˆï¼ŒbatchId: " + batchId);
                }
                
            } catch (CanalClientException e) {
                System.err.println("Canalè¿æ¥å¼‚å¸¸: " + e.getMessage());
                // è¿æ¥å¼‚å¸¸ï¼Œç­‰å¾…é‡è¿
                try {
                    Thread.sleep(10000);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
    }
    
    private boolean isRetryableException(Exception e) {
        // å®šä¹‰å¯é‡è¯•çš„å¼‚å¸¸ç±»å‹
        return e instanceof SocketTimeoutException ||
               e instanceof ConnectException ||
               e instanceof SQLException ||
               e.getMessage().contains("temporary");
    }
    
    private void logFailedMessage(Message message, Exception e) {
        // è®°å½•å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼Œç”¨äºåç»­æ’æŸ¥
        System.err.println("è®°å½•å¤±è´¥æ¶ˆæ¯åˆ°æ—¥å¿—æˆ–æ­»ä¿¡é˜Ÿåˆ—");
        // å¯ä»¥å†™å…¥æ•°æ®åº“ã€æ–‡ä»¶æˆ–å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    }
}
```

### 6.4 Rollbackå›æ»šæœºåˆ¶


**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨rollback**ï¼š
```java
// åœºæ™¯1ï¼šä¸´æ—¶å¼‚å¸¸ï¼Œå¸Œæœ›é‡æ–°å¤„ç†
try {
    processMessage(message);
    connector.ack(batchId);
} catch (TemporaryException e) {
    connector.rollback(batchId); // å›æ»šï¼Œæ¶ˆæ¯ä¼šé‡æ–°æŠ•é€’
}

// åœºæ™¯2ï¼šå¤„ç†è¶…æ—¶
Future<Boolean> future = executor.submit(() -> processMessage(message));
try {
    boolean success = future.get(30, TimeUnit.SECONDS);
    if (success) {
        connector.ack(batchId);
    } else {
        connector.rollback(batchId);
    }
} catch (TimeoutException e) {
    future.cancel(true);
    connector.rollback(batchId); // è¶…æ—¶å›æ»š
}

// åœºæ™¯3ï¼šèµ„æºä¸è¶³
if (!hasEnoughMemory() || !hasEnoughConnections()) {
    connector.rollback(batchId); // æš‚æ—¶æ— æ³•å¤„ç†
    Thread.sleep(60000); // ç­‰å¾…èµ„æºé‡Šæ”¾
}
```

---

## 7. ğŸ› ï¸ å¼‚å¸¸å¤„ç†ä¸é‡è¿ç­–ç•¥


### 7.1 å¸¸è§å¼‚å¸¸ç±»å‹


**Canal Clientå¯èƒ½é‡åˆ°çš„å¼‚å¸¸**ï¼š
```java
try {
    Message message = connector.get(100);
    // å¤„ç†æ¶ˆæ¯
} catch (CanalClientException e) {
    if (e.getCause() instanceof SocketTimeoutException) {
        // ç½‘ç»œè¶…æ—¶
        System.out.println("ç½‘ç»œè¶…æ—¶ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥");
    } else if (e.getCause() instanceof ConnectException) {
        // è¿æ¥å¤±è´¥  
        System.out.println("æ— æ³•è¿æ¥Canal Serverï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€");
    } else if (e.getMessage().contains("destination not found")) {
        // destinationä¸å­˜åœ¨
        System.out.println("destinationé…ç½®é”™è¯¯");
    } else if (e.getMessage().contains("subscribe failed")) {
        // è®¢é˜…å¤±è´¥
        System.out.println("è®¢é˜…è§„åˆ™æœ‰è¯¯æˆ–æƒé™ä¸è¶³");
    }
}
```

### 7.2 é‡è¿ç­–ç•¥å®ç°


```java
public class ReconnectableCanelClient {
    private CanalConnector connector;
    private volatile boolean running = true;
    private final int maxRetries = 5;
    private final long baseRetryInterval = 1000; // åŸºç¡€é‡è¯•é—´éš”1ç§’
    
    public void startWithReconnect() {
        while (running) {
            try {
                initConnector();
                runMainLoop();
            } catch (Exception e) {
                System.err.println("è¿æ¥å¼‚å¸¸: " + e.getMessage());
                handleConnectionException(e);
            }
        }
    }
    
    private void initConnector() throws Exception {
        int retryCount = 0;
        
        while (retryCount < maxRetries && running) {
            try {
                if (connector != null) {
                    try {
                        connector.disconnect();
                    } catch (Exception e) {
                        // å¿½ç•¥æ–­å¼€è¿æ¥æ—¶çš„å¼‚å¸¸
                    }
                }
                
                // é‡æ–°åˆ›å»ºè¿æ¥å™¨
                connector = CanalConnectors.newClusterConnector(
                    "zk1:2181,zk2:2181,zk3:2181",
                    "example", "canal", "canal"
                );
                
                connector.connect();
                connector.subscribe(".*\\..*");
                
                System.out.println("è¿æ¥æˆåŠŸ");
                return;
                
            } catch (Exception e) {
                retryCount++;
                long waitTime = calculateRetryInterval(retryCount);
                
                System.err.println("è¿æ¥å¤±è´¥ï¼Œ" + waitTime + "msåé‡è¯• (" + 
                                 retryCount + "/" + maxRetries + ")");
                
                if (retryCount >= maxRetries) {
                    throw new RuntimeException("é‡è¿å¤±è´¥æ¬¡æ•°è¶…è¿‡é™åˆ¶", e);
                }
                
                try {
                    Thread.sleep(waitTime);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException("é‡è¿è¢«ä¸­æ–­", ie);
                }
            }
        }
    }
    
    private long calculateRetryInterval(int retryCount) {
        // æŒ‡æ•°é€€é¿ç®—æ³•ï¼š1s, 2s, 4s, 8s, 16s
        return Math.min(baseRetryInterval * (1L << (retryCount - 1)), 30000);
    }
    
    private void runMainLoop() {
        while (running) {
            try {
                Message message = connector.get(100);
                
                if (message.getBatchId() != -1 && !message.getEntries().isEmpty()) {
                    processMessage(message);
                    connector.ack(message.getBatchId());
                } else {
                    Thread.sleep(1000);
                }
                
            } catch (CanalClientException e) {
                // è¿æ¥çº§å¼‚å¸¸ï¼Œè·³å‡ºå¾ªç¯é‡æ–°è¿æ¥
                throw new RuntimeException("Canalè¿æ¥å¼‚å¸¸", e);
            } catch (Exception e) {
                // ä¸šåŠ¡å¤„ç†å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ä½†ä¸ä¸­æ–­è¿æ¥
                System.err.println("æ¶ˆæ¯å¤„ç†å¼‚å¸¸: " + e.getMessage());
            }
        }
    }
    
    private void handleConnectionException(Exception e) {
        // æ ¹æ®å¼‚å¸¸ç±»å‹å†³å®šé‡è¿ç­–ç•¥
        if (e.getCause() instanceof SocketException) {
            System.out.println("ç½‘ç»œå¼‚å¸¸ï¼Œç«‹å³é‡è¿");
        } else if (e.getMessage().contains("authentication")) {
            System.err.println("è®¤è¯å¤±è´¥ï¼Œåœæ­¢é‡è¿");
            running = false;
        } else {
            System.out.println("æœªçŸ¥å¼‚å¸¸ï¼Œç­‰å¾…åé‡è¿");
            try {
                Thread.sleep(5000);
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                running = false;
            }
        }
    }
    
    public void stop() {
        running = false;
        if (connector != null) {
            try {
                connector.disconnect();
            } catch (Exception e) {
                System.err.println("æ–­å¼€è¿æ¥å¤±è´¥: " + e.getMessage());
            }
        }
    }
}
```

### 7.3 è¿æ¥å¥åº·æ£€æŸ¥


```java
public class HealthCheckClient {
    private CanalConnector connector;
    private ScheduledExecutorService healthChecker;
    
    public void startWithHealthCheck() {
        // å¯åŠ¨å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡
        healthChecker = Executors.newScheduledThreadPool(1);
        healthChecker.scheduleAtFixedRate(this::checkHealth, 30, 30, TimeUnit.SECONDS);
        
        // å¯åŠ¨ä¸»å¤„ç†æµç¨‹
        startMainProcess();
    }
    
    private void checkHealth() {
        try {
            // å‘é€å¿ƒè·³æ£€æŸ¥è¿æ¥çŠ¶æ€
            Message heartbeat = connector.getWithoutAck(1);
            if (heartbeat.getBatchId() != -1) {
                connector.ack(heartbeat.getBatchId());
            }
            
            System.out.println("è¿æ¥å¥åº·æ£€æŸ¥é€šè¿‡");
            
        } catch (Exception e) {
            System.err.println("è¿æ¥å¥åº·æ£€æŸ¥å¤±è´¥: " + e.getMessage());
            // è§¦å‘é‡è¿é€»è¾‘
            reconnect();
        }
    }
    
    private void reconnect() {
        try {
            if (connector != null) {
                connector.disconnect();
            }
            // é‡æ–°åˆå§‹åŒ–è¿æ¥å™¨
            initConnector();
        } catch (Exception e) {
            System.err.println("é‡è¿å¤±è´¥: " + e.getMessage());
        }
    }
}
```

---

## 8. ğŸ”„ å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 8.1 å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ


**Canal Clientå®Œæ•´ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
1. åˆå§‹åŒ–é˜¶æ®µ
   â”œâ”€ åŠ è½½é…ç½®å‚æ•°
   â”œâ”€ åˆ›å»ºCanalConnector
   â””â”€ åˆå§‹åŒ–çº¿ç¨‹æ± ç­‰èµ„æº

2. å¯åŠ¨é˜¶æ®µ  
   â”œâ”€ å»ºç«‹ä¸Canal Serverè¿æ¥
   â”œâ”€ è¿›è¡Œèº«ä»½è®¤è¯
   â”œâ”€ è®¢é˜…æ•°æ®å˜åŒ–
   â””â”€ å¯åŠ¨æ¶ˆæ¯å¤„ç†å¾ªç¯

3. è¿è¡Œé˜¶æ®µ
   â”œâ”€ å¾ªç¯è·å–æ¶ˆæ¯
   â”œâ”€ å¤„ç†ä¸šåŠ¡é€»è¾‘  
   â”œâ”€ å‘é€ACKç¡®è®¤
   â””â”€ å¼‚å¸¸å¤„ç†å’Œé‡è¿

4. åœæ­¢é˜¶æ®µ
   â”œâ”€ åœæ­¢æ¶ˆæ¯è·å–å¾ªç¯
   â”œâ”€ å¤„ç†å‰©ä½™æ¶ˆæ¯
   â”œâ”€ å–æ¶ˆè®¢é˜…
   â””â”€ æ–­å¼€è¿æ¥

5. æ¸…ç†é˜¶æ®µ
   â”œâ”€ é‡Šæ”¾çº¿ç¨‹æ± èµ„æº
   â”œâ”€ å…³é—­æ•°æ®åº“è¿æ¥
   â””â”€ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### 8.2 ä¼˜é›…å¯åœå®ç°


```java
public class GracefulCanalClient {
    private CanalConnector connector;
    private ExecutorService executor;
    private volatile boolean running = false;
    private final CountDownLatch shutdownLatch = new CountDownLatch(1);
    
    public void start() {
        if (running) {
            System.out.println("Clientå·²ç»åœ¨è¿è¡Œä¸­");
            return;
        }
        
        try {
            // 1. åˆå§‹åŒ–èµ„æº
            initializeResources();
            
            // 2. å»ºç«‹è¿æ¥
            connectToCanal();
            
            // 3. å¯åŠ¨å¤„ç†çº¿ç¨‹
            startProcessingThread();
            
            // 4. æ³¨å†Œåœæœºé’©å­
            registerShutdownHook();
            
            running = true;
            System.out.println("Canal Clientå¯åŠ¨æˆåŠŸ");
            
        } catch (Exception e) {
            System.err.println("Clientå¯åŠ¨å¤±è´¥: " + e.getMessage());
            cleanup();
            throw new RuntimeException("å¯åŠ¨å¤±è´¥", e);
        }
    }
    
    private void initializeResources() {
        // åˆ›å»ºçº¿ç¨‹æ± 
        executor = Executors.newFixedThreadPool(2);
        
        // åˆ›å»ºè¿æ¥å™¨
        connector = CanalConnectors.newClusterConnector(
            "zk1:2181,zk2:2181,zk3:2181",
            "example", "canal", "canal"
        );
        
        System.out.println("èµ„æºåˆå§‹åŒ–å®Œæˆ");
    }
    
    private void connectToCanal() throws Exception {
        int maxRetries = 3;
        for (int i = 0; i < maxRetries; i++) {
            try {
                connector.connect();
                connector.subscribe(".*\\..*");
                System.out.println("è¿æ¥Canal ServeræˆåŠŸ");
                return;
            } catch (Exception e) {
                System.err.println("è¿æ¥å¤±è´¥ï¼Œé‡è¯• " + (i + 1) + "/" + maxRetries);
                if (i == maxRetries - 1) {
                    throw e;
                }
                Thread.sleep(2000);
            }
        }
    }
    
    private void startProcessingThread() {
        executor.submit(() -> {
            while (running) {
                try {
                    Message message = connector.get(100);
                    
                    if (message.getBatchId() != -1 && !message.getEntries().isEmpty()) {
                        processMessage(message);
                        connector.ack(message.getBatchId());
                    } else {
                        Thread.sleep(1000);
                    }
                    
                } catch (Exception e) {
                    if (running) {
                        System.err.println("å¤„ç†æ¶ˆæ¯å¼‚å¸¸: " + e.getMessage());
                    }
                }
            }
            
            System.out.println("æ¶ˆæ¯å¤„ç†çº¿ç¨‹å·²åœæ­¢");
            shutdownLatch.countDown();
        });
    }
    
    private void registerShutdownHook() {
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            System.out.println("æ£€æµ‹åˆ°ç¨‹åºé€€å‡ºä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…åœæœº...");
            stop();
        }));
    }
    
    public void stop() {
        if (!running) {
            System.out.println("Clientå·²ç»åœæ­¢");
            return;
        }
        
        System.out.println("å¼€å§‹åœæ­¢Canal Client...");
        running = false;
        
        try {
            // 1. ç­‰å¾…å½“å‰å¤„ç†å®Œæˆ
            System.out.println("ç­‰å¾…æ¶ˆæ¯å¤„ç†å®Œæˆ...");
            if (!shutdownLatch.await(30, TimeUnit.SECONDS)) {
                System.err.println("ç­‰å¾…è¶…æ—¶ï¼Œå¼ºåˆ¶åœæ­¢");
            }
            
            // 2. å–æ¶ˆè®¢é˜…
            if (connector != null) {
                try {
                    connector.unsubscribe();
                    System.out.println("å–æ¶ˆè®¢é˜…æˆåŠŸ");
                } catch (Exception e) {
                    System.err.println("å–æ¶ˆè®¢é˜…å¤±è´¥: " + e.getMessage());
                }
            }
            
            // 3. æ–­å¼€è¿æ¥
            if (connector != null) {
                try {
                    connector.disconnect();
                    System.out.println("æ–­å¼€è¿æ¥æˆåŠŸ");
                } catch (Exception e) {
                    System.err.println("æ–­å¼€è¿æ¥å¤±è´¥: " + e.getMessage());
                }
            }
            
            // 4. æ¸…ç†èµ„æº
            cleanup();
            
            System.out.println("Canal Clientåœæ­¢å®Œæˆ");
            
        } catch (Exception e) {
            System.err.println("åœæ­¢è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: " + e.getMessage());
        }
    }
    
    private void cleanup() {
        // å…³é—­çº¿ç¨‹æ± 
        if (executor != null && !executor.isShutdown()) {
            executor.shutdown();
            try {
                if (!executor.awaitTermination(10, TimeUnit.SECONDS)) {
                    executor.shutdownNow();
                }
            } catch (InterruptedException e) {
                executor.shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
        
        System.out.println("èµ„æºæ¸…ç†å®Œæˆ");
    }
    
    public boolean isRunning() {
        return running;
    }
    
    // é˜»å¡ç­‰å¾…ç›´åˆ°åœæ­¢
    public void waitUntilStop() {
        try {
            shutdownLatch.await();
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

### 8.3 é…ç½®ç®¡ç†å’Œç›‘æ§


```java
public class MonitorableCanalClient {
    private final AtomicLong processedMessages = new AtomicLong(0);
    private final AtomicLong errorCount = new AtomicLong(0);
    private volatile long lastMessageTime = System.currentTimeMillis();
    
    // é…ç½®çƒ­æ›´æ–°
    public void updateSubscription(String newFilter) {
        try {
            connector.unsubscribe();
            connector.subscribe(newFilter);
            System.out.println("è®¢é˜…è§„åˆ™å·²æ›´æ–°: " + newFilter);
        } catch (Exception e) {
            System.err.println("æ›´æ–°è®¢é˜…å¤±è´¥: " + e.getMessage());
        }
    }
    
    // è·å–è¿è¡ŒçŠ¶æ€
    public Map<String, Object> getStatus() {
        Map<String, Object> status = new HashMap<>();
        status.put("running", running);
        status.put("processedMessages", processedMessages.get());
        status.put("errorCount", errorCount.get());
        status.put("lastMessageTime", new Date(lastMessageTime));
        status.put("uptime", System.currentTimeMillis() - startTime);
        return status;
    }
    
    // å®šæ—¶è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
    private void startMonitoring() {
        ScheduledExecutorService monitor = Executors.newScheduledThreadPool(1);
        monitor.scheduleAtFixedRate(() -> {
            long processed = processedMessages.get();
            long errors = errorCount.get();
            long timeSinceLastMessage = System.currentTimeMillis() - lastMessageTime;
            
            System.out.println(String.format(
                "ç»Ÿè®¡ä¿¡æ¯ - å·²å¤„ç†: %d, é”™è¯¯: %d, è·ç¦»ä¸Šæ¬¡æ¶ˆæ¯: %dç§’",
                processed, errors, timeSinceLastMessage / 1000
            ));
            
            // æ£€æŸ¥æ˜¯å¦é•¿æ—¶é—´æ²¡æœ‰æ¶ˆæ¯
            if (timeSinceLastMessage > 300000) { // 5åˆ†é’Ÿ
                System.err.println("è­¦å‘Šï¼šè¶…è¿‡5åˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯");
            }
            
        }, 60, 60, TimeUnit.SECONDS);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CanalConnectoræ¥å£ï¼šè¿æ¥Canal Serverçš„æ ¸å¿ƒæŠ½è±¡
ğŸ”¸ è¿æ¥å™¨ç±»å‹ï¼šSimpleCanalConnectorï¼ˆå•æœºï¼‰vs ClusterCanalConnectorï¼ˆé›†ç¾¤ï¼‰
ğŸ”¸ æ¶ˆæ¯å¤„ç†æµç¨‹ï¼šè¿æ¥ â†’ è®¢é˜… â†’ è·å– â†’ å¤„ç† â†’ ç¡®è®¤
ğŸ”¸ ACKç¡®è®¤æœºåˆ¶ï¼šè‡ªåŠ¨ACK vs æ‰‹åŠ¨ACKï¼Œrollbackå›æ»š
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€ä¸šåŠ¡å¼‚å¸¸ã€é‡è¿ç­–ç•¥
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸï¼šå¯åŠ¨ã€è¿è¡Œã€åœæ­¢ã€æ¸…ç†å„é˜¶æ®µç®¡ç†
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿æ¥å™¨é€‰æ‹©ç­–ç•¥**
```
å¼€å‘ç¯å¢ƒï¼š
âœ… SimpleCanalConnector - ç®€å•ç›´æ¥ï¼Œä¾¿äºè°ƒè¯•

ç”Ÿäº§ç¯å¢ƒï¼š
âœ… ClusterCanalConnector - é«˜å¯ç”¨ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
âœ… é…åˆZooKeeperé›†ç¾¤ä½¿ç”¨
âœ… æ”¯æŒè´Ÿè½½å‡è¡¡

é€‰æ‹©ä¾æ®ï¼š
â”œâ”€ å¯ç”¨æ€§è¦æ±‚ï¼šé«˜å¯ç”¨é€‰é›†ç¾¤æ¨¡å¼
â”œâ”€ è¿ç»´å¤æ‚åº¦ï¼šç®€å•éƒ¨ç½²é€‰å•æœºæ¨¡å¼  
â”œâ”€ æ•°æ®é‡è¦æ€§ï¼šå…³é”®æ•°æ®å¿…é¡»ç”¨é›†ç¾¤æ¨¡å¼
â””â”€ æ€§èƒ½è¦æ±‚ï¼šé«˜å¹¶å‘æ¨èé›†ç¾¤æ¨¡å¼
```

**ğŸ”¹ ACKç¡®è®¤çš„é‡è¦æ€§**
```
è‡ªåŠ¨ACKé€‚ç”¨åœºæ™¯ï¼š
âœ… å…è®¸å°‘é‡æ•°æ®ä¸¢å¤±
âœ… å¤„ç†é€»è¾‘ç®€å•ï¼Œå¾ˆå°‘å¤±è´¥
âœ… å¯¹å»¶è¿Ÿè¦æ±‚é«˜

æ‰‹åŠ¨ACKé€‚ç”¨åœºæ™¯ï¼š
âœ… æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸¥æ ¼
âœ… å¤„ç†é€»è¾‘å¤æ‚ï¼Œå¯èƒ½å¤±è´¥
âœ… éœ€è¦ç²¾ç¡®æ§åˆ¶æ¶ˆè´¹è¿›åº¦

> âš ï¸ æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ä½¿ç”¨æ‰‹åŠ¨ACK
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ**
```
åˆ†ç±»å¤„ç†åŸåˆ™ï¼š
â”œâ”€ ç½‘ç»œå¼‚å¸¸ï¼šè‡ªåŠ¨é‡è¿ï¼ŒæŒ‡æ•°é€€é¿
â”œâ”€ è®¤è¯å¼‚å¸¸ï¼šåœæ­¢é‡è¿ï¼Œäººå·¥å¤„ç†
â”œâ”€ ä¸šåŠ¡å¼‚å¸¸ï¼šè®°å½•æ—¥å¿—ï¼Œç»§ç»­å¤„ç†
â””â”€ èµ„æºå¼‚å¸¸ï¼šé‡Šæ”¾èµ„æºï¼Œç­‰å¾…é‡è¯•

é‡è¿ç­–ç•¥ï¼š
â”œâ”€ æœ€å¤§é‡è¯•æ¬¡æ•°ï¼šé¿å…æ— é™é‡è¿
â”œâ”€ é‡è¯•é—´éš”ï¼šæŒ‡æ•°é€€é¿ï¼Œé¿å…å‹å®æœåŠ¡å™¨
â”œâ”€ å¥åº·æ£€æŸ¥ï¼šå®šæœŸæ£€æµ‹è¿æ¥çŠ¶æ€
â””â”€ ç†”æ–­æœºåˆ¶ï¼šè¿ç»­å¤±è´¥åæš‚åœé‡è¿
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```java
// 1. åˆç†è®¾ç½®æ‰¹é‡å¤§å°
Message message = connector.get(100); // ä¸€èˆ¬100-500åˆé€‚

// 2. ä¼˜åŒ–æ¶ˆæ¯è§£æ
// é¿å…é‡å¤è§£æï¼Œç¼“å­˜è§£æç»“æœ

// 3. å¼‚æ­¥å¤„ç†
ExecutorService executor = Executors.newFixedThreadPool(4);
executor.submit(() -> processMessage(message));

// 4. æ‰¹é‡æäº¤  
// ç§¯ç´¯ä¸€å®šæ•°é‡åæ‰¹é‡å†™å…¥æ•°æ®åº“
```

**ğŸ”¸ ç”Ÿäº§éƒ¨ç½²æ¸…å•**
```
éƒ¨ç½²å‰æ£€æŸ¥ï¼š
âœ… Canal Serveré›†ç¾¤æ­£å¸¸è¿è¡Œ
âœ… ZooKeeperé›†ç¾¤ç¨³å®š  
âœ… ç½‘ç»œè¿é€šæ€§æµ‹è¯•
âœ… è®¤è¯ä¿¡æ¯æ­£ç¡®é…ç½®

ç›‘æ§æŒ‡æ ‡ï¼š
âœ… æ¶ˆæ¯å¤„ç†é€Ÿåº¦
âœ… é”™è¯¯ç‡ç»Ÿè®¡
âœ… è¿æ¥çŠ¶æ€ç›‘æ§
âœ… æ¶ˆè´¹å»¶è¿Ÿç›‘æ§

è¿ç»´å·¥å…·ï¼š
âœ… æ—¥å¿—æ”¶é›†å’Œåˆ†æ
âœ… ç›‘æ§å‘Šè­¦æœºåˆ¶
âœ… è‡ªåŠ¨é‡å¯è„šæœ¬
âœ… æ€§èƒ½æŒ‡æ ‡ä»ªè¡¨æ¿
```

**ğŸ”¸ æ•…éšœæ’æŸ¥æŒ‡å—**
```sql
-- 1. æ£€æŸ¥Canal ServerçŠ¶æ€
show master status;
show slave status;

-- 2. æ£€æŸ¥destinationé…ç½®
-- æŸ¥çœ‹Canal Adminæˆ–é…ç½®æ–‡ä»¶

-- 3. æ£€æŸ¥ç½‘ç»œè¿æ¥
telnet canal-server-ip 11111

-- 4. æ£€æŸ¥å®¢æˆ·ç«¯æ—¥å¿—
grep "CanalClientException" application.log
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Canal Clientæ˜¯æ•°æ®åŒæ­¥çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£ç¨³å®šå¯é åœ°æ¶ˆè´¹æ•°æ®å˜æ›´
- é›†ç¾¤æ¨¡å¼ + æ‰‹åŠ¨ACKæ˜¯ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†é…ç½®
- å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé‡è¿æœºåˆ¶æ˜¯ç¨³å®šè¿è¡Œçš„åŸºç¡€
- ä¼˜é›…çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¿è¯æœåŠ¡çš„å¯ç»´æŠ¤æ€§