---
title: 3、慢查询参数配置详解
---
## 📚 目录

1. [慢查询日志基础概念](#1-慢查询日志基础概念)
2. [核心参数详解](#2-核心参数详解)
3. [参数配置实战](#3-参数配置实战)
4. [动态修改方法](#4-动态修改方法)
5. [配置最佳实践](#5-配置最佳实践)
6. [常见问题解答](#6-常见问题解答)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 慢查询日志基础概念


### 1.1 什么是慢查询日志


**🎯 通俗理解**
慢查询日志就像是MySQL的"体检报告"，专门记录那些执行时间超过指定时间的SQL语句。

```
生活中的类比：
🏥 医院体检 → MySQL慢查询监控
📊 体检报告 → 慢查询日志文件
⏰ 异常指标 → 执行时间过长的SQL
👨‍⚕️ 医生建议 → 优化建议
```

**🔸 核心作用**
- **性能监控**：发现执行慢的SQL语句
- **问题定位**：找出系统性能瓶颈
- **优化指导**：为SQL优化提供依据
- **趋势分析**：监控数据库性能变化

### 1.2 慢查询日志的工作原理


**📊 工作流程图**
```
SQL请求 → MySQL执行 → 计算执行时间 → 判断是否超时 → 记录到日志
    ↓           ↓            ↓            ↓           ↓
  用户查询    解析执行     时间统计    与阈值比较   写入日志文件
```

**💡 判断标准**
```
执行时间 ≥ long_query_time → 记录为慢查询
执行时间 < long_query_time → 正常查询，不记录
```

---

## 2. ⚙️ 核心参数详解


### 2.1 slow_query_log - 慢查询开关


**🔸 参数含义**
`slow_query_log` 是慢查询日志的总开关，控制是否启用慢查询日志功能。

```sql
-- 查看当前状态
SHOW VARIABLES LIKE 'slow_query_log';

-- 可能的值
ON  → 启用慢查询日志
OFF → 关闭慢查询日志（默认）
```

**💡 使用场景**
- **开发环境**：建议开启，便于发现问题
- **测试环境**：必须开启，性能测试必备
- **生产环境**：建议开启，但要注意磁盘空间

> ⚠️ **注意事项**
> 
> 开启慢查询日志会产生轻微的性能开销，但相比于性能监控的价值，这个开销是值得的

### 2.2 long_query_time - 时间阈值设置


**🔸 参数含义**
`long_query_time` 定义了"慢查询"的时间标准，单位为秒，支持小数点精度。

```sql
-- 查看当前设置
SHOW VARIABLES LIKE 'long_query_time';

-- 常见设置值
10     → 10秒（默认值）
2      → 2秒
0.5    → 500毫秒
0.1    → 100毫秒
```

**🎯 设置建议**

| 环境类型 | **建议值** | **说明** |
|---------|-----------|----------|
| 🏭 **生产环境** | `1-2秒` | 平衡监控效果与日志量 |
| 🧪 **测试环境** | `0.5秒` | 更严格的性能要求 |
| 💻 **开发环境** | `0.1秒` | 尽早发现性能问题 |
| 📊 **性能调优** | `0.01秒` | 捕获所有可疑查询 |

**🔧 精确设置示例**
```sql
-- 设置为500毫秒
SET GLOBAL long_query_time = 0.5;

-- 设置为100毫秒  
SET GLOBAL long_query_time = 0.1;

-- 设置为1.5秒
SET GLOBAL long_query_time = 1.5;
```

### 2.3 slow_query_log_file - 日志文件路径


**🔸 参数含义**
`slow_query_log_file` 指定慢查询日志文件的存储路径和文件名。

```sql
-- 查看当前路径
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 典型路径示例
/var/lib/mysql/hostname-slow.log     -- Linux默认
C:\ProgramData\MySQL\Data\slow.log  -- Windows
```

**📁 文件路径规划**

```
推荐目录结构：
/var/log/mysql/
├── 📄 slow-query.log          ← 慢查询日志
├── 📄 slow-query.log.1        ← 轮转备份
├── 📄 error.log               ← 错误日志
└── 📄 general.log             ← 通用查询日志

设置路径：
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';
```

> 💡 **路径选择建议**
> 
> - 选择有足够空间的磁盘分区
> - 避免与数据文件在同一磁盘（减少IO竞争）
> - 确保MySQL进程有写入权限

### 2.4 log_queries_not_using_indexes - 索引缺失监控


**🔸 参数含义**
`log_queries_not_using_indexes` 控制是否记录没有使用索引的查询语句。

```sql
-- 查看当前设置
SHOW VARIABLES LIKE 'log_queries_not_using_indexes';

-- 设置值
ON  → 记录未使用索引的查询
OFF → 不记录（默认）
```

**🎯 使用场景分析**

```
开启此参数的效果：

✅ 优点：
- 发现缺少索引的查询
- 识别全表扫描操作
- 提供索引优化建议

⚠️ 注意：
- 可能产生大量日志
- 小表全扫描是正常的
- 需要结合其他参数使用
```

**💡 实际应用示例**
```sql
-- 开启未使用索引查询记录
SET GLOBAL log_queries_not_using_indexes = ON;

-- 这些查询会被记录
SELECT * FROM users WHERE email = 'test@example.com';  -- 没有email索引
SELECT * FROM orders WHERE status = 'pending';         -- 没有status索引
```

### 2.5 log_slow_admin_statements - 管理语句监控


**🔸 参数含义**
`log_slow_admin_statements` 控制是否记录慢的管理语句（如ALTER TABLE、CREATE INDEX等）。

```sql
-- 查看当前设置  
SHOW VARIABLES LIKE 'log_slow_admin_statements';

-- 管理语句包括
ALTER TABLE    -- 表结构修改
CREATE INDEX   -- 索引创建
DROP INDEX     -- 索引删除
OPTIMIZE TABLE -- 表优化
REPAIR TABLE   -- 表修复
```

**🔧 应用场景**
```
何时开启：
✅ 生产环境维护期间
✅ 大表结构变更时
✅ 索引创建优化时
✅ 数据库迁移过程

监控价值：
📊 了解DDL语句执行时间
🔍 发现耗时的维护操作
⏰ 制定维护时间窗口
```

### 2.6 min_examined_row_limit - 扫描行数限制


**🔸 参数含义**
`min_examined_row_limit` 设置记录慢查询的最小扫描行数阈值。

```sql
-- 查看当前设置
SHOW VARIABLES LIKE 'min_examined_row_limit';

-- 默认值：0（不限制）
-- 常用设置：1000、10000、100000
```

**🎯 使用逻辑**
```
记录条件（同时满足）：
1. 执行时间 ≥ long_query_time
2. 扫描行数 ≥ min_examined_row_limit

示例：
long_query_time = 1秒
min_examined_row_limit = 1000

只有执行时间≥1秒 且 扫描行数≥1000 的查询才会被记录
```

**💡 实际应用**
```sql
-- 设置最小扫描1000行
SET GLOBAL min_examined_row_limit = 1000;

-- 这样可以过滤掉一些快速但达到时间阈值的小查询
-- 专注于那些既慢又扫描大量数据的查询
```

### 2.7 log_throttle_queries_not_using_indexes - 日志限流


**🔸 参数含义**
`log_throttle_queries_not_using_indexes` 限制每分钟记录的未使用索引查询数量。

```sql
-- 查看当前设置
SHOW VARIABLES LIKE 'log_throttle_queries_not_using_indexes';

-- 默认值：0（不限制）
-- 建议值：10-60（每分钟）
```

**🚦 限流机制图解**
```
时间轴：  [-------- 1分钟 --------]
未索引查询: ████████████████████████  (100个查询)
               ↓
设置限制10个/分钟
               ↓  
实际记录: ██████████ (只记录前10个)

作用：防止日志文件快速增长
```

**⚖️ 平衡策略**
```
设置考虑因素：

🔸 日志量控制
- 太小：可能遗漏重要查询
- 太大：日志文件快速增长

🔸 建议设置
- 小型应用：10-20个/分钟
- 中型应用：30-50个/分钟  
- 大型应用：50-100个/分钟
```

---

## 3. 🛠️ 参数配置实战


### 3.1 配置文件方式（my.cnf）


**📄 完整配置示例**
```ini
[mysqld]
# ====== 慢查询日志配置 ======

# 启用慢查询日志
slow_query_log = ON

# 设置时间阈值（1秒）
long_query_time = 1.0

# 指定日志文件路径
slow_query_log_file = /var/log/mysql/slow-query.log

# 记录未使用索引的查询
log_queries_not_using_indexes = ON

# 记录慢的管理语句
log_slow_admin_statements = ON

# 最小扫描行数限制
min_examined_row_limit = 1000

# 限制未索引查询记录频率（每分钟30个）
log_throttle_queries_not_using_indexes = 30
```

**🔄 重启生效**
```bash
# Linux系统
sudo systemctl restart mysql

# 或者
sudo service mysql restart

# Windows系统（管理员权限）
net stop mysql
net start mysql
```

### 3.2 运行时动态配置


**⚡ 立即生效的配置**
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = ON;

-- 设置时间阈值为500毫秒
SET GLOBAL long_query_time = 0.5;

-- 设置日志文件路径
SET GLOBAL slow_query_log_file = '/tmp/mysql-slow.log';

-- 开启未索引查询记录
SET GLOBAL log_queries_not_using_indexes = ON;

-- 设置限流
SET GLOBAL log_throttle_queries_not_using_indexes = 20;
```

**✅ 验证配置**
```sql
-- 查看所有慢查询相关参数
SHOW VARIABLES WHERE Variable_name LIKE '%slow%' 
   OR Variable_name LIKE '%query%' 
   AND Variable_name LIKE '%log%';

-- 查看日志状态
SHOW GLOBAL STATUS LIKE 'Slow_queries';
```

### 3.3 不同环境的配置模板


**🏭 生产环境配置**
```ini
[mysqld]
# 生产环境 - 平衡性能与监控
slow_query_log = ON
long_query_time = 2.0
slow_query_log_file = /var/log/mysql/slow-query.log
log_queries_not_using_indexes = ON
log_slow_admin_statements = OFF
min_examined_row_limit = 10000
log_throttle_queries_not_using_indexes = 60
```

**🧪 测试环境配置**
```ini
[mysqld]  
# 测试环境 - 更严格的监控
slow_query_log = ON
long_query_time = 0.5
slow_query_log_file = /var/log/mysql/slow-query.log
log_queries_not_using_indexes = ON
log_slow_admin_statements = ON
min_examined_row_limit = 1000
log_throttle_queries_not_using_indexes = 30
```

**💻 开发环境配置**
```ini
[mysqld]
# 开发环境 - 最严格监控
slow_query_log = ON  
long_query_time = 0.1
slow_query_log_file = /tmp/mysql-slow.log
log_queries_not_using_indexes = ON
log_slow_admin_statements = ON
min_examined_row_limit = 100
log_throttle_queries_not_using_indexes = 10
```

---

## 4. 🔄 动态修改方法


### 4.1 会话级别修改


**🔸 只影响当前连接**
```sql
-- 为当前会话设置（连接断开后失效）
SET SESSION long_query_time = 0.1;

-- 查看会话级别设置
SHOW SESSION VARIABLES LIKE 'long_query_time';
```

### 4.2 全局级别修改


**🔸 影响所有新连接**
```sql
-- 全局设置（重启后失效，除非写入配置文件）
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 1.0;

-- 查看全局设置
SHOW GLOBAL VARIABLES LIKE 'slow_query_log%';
```

### 4.3 持久化配置


**📝 方法一：配置文件**
```bash
# 1. 编辑配置文件
sudo vim /etc/mysql/my.cnf

# 2. 添加配置
[mysqld]
slow_query_log = ON
long_query_time = 1.0

# 3. 重启MySQL
sudo systemctl restart mysql
```

**📝 方法二：SET PERSIST（MySQL 8.0+）**
```sql
-- 持久化设置（重启后仍然有效）
SET PERSIST slow_query_log = ON;
SET PERSIST long_query_time = 1.0;

-- 查看持久化设置
SELECT * FROM performance_schema.persisted_variables;
```

### 4.4 配置生效验证


**🔍 完整验证流程**
```sql
-- 1. 检查参数设置
SHOW VARIABLES LIKE 'slow_query_log%';

-- 2. 检查日志状态  
SHOW GLOBAL STATUS LIKE 'Slow_queries';

-- 3. 测试慢查询
SELECT SLEEP(2); -- 执行一个2秒的查询

-- 4. 再次检查状态
SHOW GLOBAL STATUS LIKE 'Slow_queries';

-- 5. 查看日志文件
-- Linux: tail -f /var/log/mysql/slow-query.log
-- Windows: type C:\ProgramData\MySQL\Data\slow.log
```

---

## 5. 📋 配置最佳实践


### 5.1 生产环境建议


**🎯 核心原则**
```
1. 🚀 性能优先：避免过度监控影响性能
2. 📊 有效监控：捕获真正有价值的慢查询
3. 💾 空间控制：防止日志文件占满磁盘
4. 🔄 定期维护：日志轮转和清理策略
```

**⚙️ 推荐配置**
```sql
-- 生产环境推荐配置
SET GLOBAL slow_query_log = ON;                              -- 启用监控
SET GLOBAL long_query_time = 2.0;                           -- 2秒阈值
SET GLOBAL log_queries_not_using_indexes = ON;              -- 监控索引问题
SET GLOBAL min_examined_row_limit = 10000;                  -- 过滤小查询
SET GLOBAL log_throttle_queries_not_using_indexes = 60;     -- 限流保护
SET GLOBAL log_slow_admin_statements = OFF;                 -- 避免DDL干扰
```

### 5.2 日志管理策略


**📁 日志轮转配置**
```bash
# /etc/logrotate.d/mysql-slow
/var/log/mysql/slow-query.log {
    daily                    # 每天轮转
    missingok               # 文件不存在不报错
    rotate 30               # 保留30天
    compress                # 压缩旧日志
    delaycompress           # 延迟压缩
    notifempty              # 空文件不轮转
    postrotate              # 轮转后执行
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

**🧹 定期清理脚本**
```bash
#!/bin/bash
# cleanup-slow-logs.sh

LOG_DIR="/var/log/mysql"
RETENTION_DAYS=30

# 删除30天前的压缩日志
find $LOG_DIR -name "slow-query.log.*.gz" -mtime +$RETENTION_DAYS -delete

# 刷新日志
mysqladmin flush-logs

echo "慢查询日志清理完成：$(date)"
```

### 5.3 监控告警设置


**📊 关键指标监控**
```sql
-- 监控慢查询数量增长
SELECT 
    DATE(FROM_UNIXTIME(start_time)) as date,
    COUNT(*) as slow_query_count
FROM mysql.slow_log 
WHERE start_time > UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 7 DAY))
GROUP BY DATE(FROM_UNIXTIME(start_time))
ORDER BY date;

-- 监控平均执行时间
SELECT 
    AVG(query_time) as avg_query_time,
    MAX(query_time) as max_query_time,
    COUNT(*) as total_count
FROM mysql.slow_log
WHERE start_time > UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 DAY));
```

**🚨 告警阈值建议**

| 指标 | **告警阈值** | **处理建议** |
|------|-------------|-------------|
| 📈 **慢查询增长率** | `>50%/小时` | 检查应用变更 |
| ⏰ **平均执行时间** | `>5秒` | 分析SQL执行计划 |
| 💾 **日志文件大小** | `>1GB/天` | 调整参数或优化查询 |
| 🔍 **未索引查询比例** | `>20%` | 添加必要索引 |

---

## 6. ❓ 常见问题解答


### 6.1 配置相关问题


**Q: 修改参数后为什么没有生效？**

A: 检查以下几个方面：

```sql
-- 1. 确认参数修改级别
SHOW GLOBAL VARIABLES LIKE 'slow_query_log';  -- 全局级别
SHOW SESSION VARIABLES LIKE 'slow_query_log'; -- 会话级别

-- 2. 检查权限
-- 需要SUPER权限才能修改全局参数

-- 3. 验证语法
SET GLOBAL slow_query_log = 'ON';  -- 正确
SET GLOBAL slow_query_log = 1;     -- 也正确
SET GLOBAL slow_query_log = true;  -- 错误语法
```

**Q: 日志文件路径修改后找不到文件？**

A: 解决步骤：

```bash
# 1. 检查目录权限
ls -la /var/log/mysql/

# 2. 确保MySQL用户有写权限  
sudo chown mysql:mysql /var/log/mysql/
sudo chmod 755 /var/log/mysql/

# 3. 检查SELinux设置（如果启用）
sudo setsebool -P mysql_connect_any 1
```

### 6.2 性能影响问题


**Q: 开启慢查询日志对性能影响大吗？**

A: 影响分析：

```
📊 性能开销评估：

轻微影响（< 2%）：
✅ 只启用slow_query_log
✅ 合理的long_query_time设置

中等影响（2-5%）：
⚠️ 开启log_queries_not_using_indexes
⚠️ 设置较小的long_query_time

显著影响（> 5%）：
❌ long_query_time设置过小（如0.01秒）
❌ 大量未索引查询被记录
❌ 日志文件写入磁盘IO瓶颈
```

**优化建议：**
```sql
-- 生产环境平衡配置
SET GLOBAL long_query_time = 2.0;                    -- 不要太小
SET GLOBAL log_throttle_queries_not_using_indexes = 60; -- 限流保护
SET GLOBAL min_examined_row_limit = 5000;            -- 过滤小查询
```

### 6.3 日志分析问题


**Q: 如何快速分析慢查询日志？**

A: 推荐工具和方法：

```bash
# 1. 使用mysqldumpslow工具
mysqldumpslow -s t -t 10 /var/log/mysql/slow-query.log
# -s t: 按查询时间排序  
# -t 10: 显示前10条

# 2. 使用pt-query-digest（推荐）
pt-query-digest /var/log/mysql/slow-query.log

# 3. 简单的grep分析
grep "Query_time" /var/log/mysql/slow-query.log | head -20
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的参数


```
🔸 slow_query_log：慢查询总开关，生产环境建议开启
🔸 long_query_time：时间阈值，根据业务特点设置（1-2秒）
🔸 slow_query_log_file：日志文件路径，选择合适的存储位置
🔸 log_queries_not_using_indexes：索引监控，帮助发现优化点
🔸 min_examined_row_limit：扫描行数限制，过滤无意义的记录
🔸 log_throttle_queries_not_using_indexes：限流保护，防止日志爆炸
```

### 7.2 配置要点记忆


**🧠 记忆口诀**
```
慢查询配置要点：
开关一定要打开，时间阈值别太小
日志路径要规划，索引监控价值大
扫描行数设限制，限流保护不可忽
动态修改需谨慎，持久配置才安全
```

### 7.3 实际应用建议


**🎯 不同场景的配置策略**

```
新项目上线：
- 开启全部监控参数
- 设置较严格的阈值
- 密切观察日志内容

系统优化期：  
- 临时降低long_query_time
- 开启详细的索引监控
- 分析优化后及时调整

稳定运行期：
- 适度放宽监控阈值
- 重点关注异常增长
- 定期分析和清理日志
```

**核心理解**：
- 慢查询参数配置是MySQL性能优化的第一步
- 合理的配置平衡了监控效果和系统性能
- 不同环境需要不同的配置策略
- 动态调整和持久化配置各有适用场景
- 日志管理和分析同样重要，不能只配置不分析