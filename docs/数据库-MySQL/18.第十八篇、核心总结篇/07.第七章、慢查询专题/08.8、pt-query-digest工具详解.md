---
title: 8ã€pt-query-digestå·¥å…·è¯¦è§£
---
## ðŸ“š ç›®å½•

1. [pt-query-digestå·¥å…·æ¦‚è¿°](#1-pt-query-digestå·¥å…·æ¦‚è¿°)
2. [å®‰è£…é…ç½®è¯¦è§£](#2-å®‰è£…é…ç½®è¯¦è§£)
3. [åŸºæœ¬ä½¿ç”¨è¯­æ³•](#3-åŸºæœ¬ä½¿ç”¨è¯­æ³•)
4. [æ ¸å¿ƒå‚æ•°è¯¦è§£](#4-æ ¸å¿ƒå‚æ•°è¯¦è§£)
5. [æŠ¥å‘Šæ ¼å¼è§£è¯»](#5-æŠ¥å‘Šæ ¼å¼è§£è¯»)
6. [æŸ¥è¯¢æŒ‡çº¹æ¦‚å¿µ](#6-æŸ¥è¯¢æŒ‡çº¹æ¦‚å¿µ)
7. [å®žæˆ˜åº”ç”¨åœºæ™¯](#7-å®žæˆ˜åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ”§ pt-query-digestå·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pt-query-digest


**ðŸ”¸ å·¥å…·å®šä¹‰**
```
pt-query-digestï¼šMySQLæ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æžåˆ©å™¨
æœ¬è´¨ï¼šPercona Toolkitä¸­çš„æ ¸å¿ƒå·¥å…·ä¹‹ä¸€
ä½œç”¨ï¼šå°†æ‚ä¹±çš„æ…¢æŸ¥è¯¢æ—¥å¿—è½¬æ¢ä¸ºç»“æž„åŒ–åˆ†æžæŠ¥å‘Š
ç›®æ ‡ï¼šå¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆï¼Œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
```

**ðŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå·¥å…·**
```
é—®é¢˜åœºæ™¯ï¼š
æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶å‡ åMBç”šè‡³å‡ GB
æˆåƒä¸Šä¸‡æ¡æŸ¥è¯¢è®°å½•æ··æ‚åœ¨ä¸€èµ·
æ‰‹å·¥åˆ†æžè´¹æ—¶è´¹åŠ›ï¼Œéš¾ä»¥æ‰¾åˆ°é‡ç‚¹

pt-query-digestçš„ä»·å€¼ï¼š
âœ… è‡ªåŠ¨åˆ†ç»„ç›¸ä¼¼æŸ¥è¯¢ï¼ˆé€šè¿‡æŒ‡çº¹æŠ€æœ¯ï¼‰
âœ… ç»Ÿè®¡æŸ¥è¯¢é¢‘æ¬¡å’Œæ€§èƒ½æŒ‡æ ‡
âœ… ç”Ÿæˆç›´è§‚çš„åˆ†æžæŠ¥å‘Š
âœ… å¿«é€Ÿè¯†åˆ«æœ€éœ€è¦ä¼˜åŒ–çš„æŸ¥è¯¢
```

### 1.2 å·¥å…·æ ¸å¿ƒåŠŸèƒ½


**ðŸŒŸ ä¸»è¦èƒ½åŠ›**
```
æ—¥å¿—è§£æžï¼š
â€¢ è§£æžMySQLæ…¢æŸ¥è¯¢æ—¥å¿—
â€¢ æ”¯æŒäºŒè¿›åˆ¶æ—¥å¿—åˆ†æž
â€¢ å¤„ç†é€šç”¨æŸ¥è¯¢æ—¥å¿—

ç»Ÿè®¡åˆ†æžï¼š
â€¢ æŸ¥è¯¢é¢‘æ¬¡ç»Ÿè®¡
â€¢ æ‰§è¡Œæ—¶é—´åˆ†æž
â€¢ é”ç­‰å¾…æ—¶é—´ç»Ÿè®¡
â€¢ æ‰«æè¡Œæ•°ç»Ÿè®¡

æŠ¥å‘Šç”Ÿæˆï¼š
â€¢ ç”Ÿæˆè¯¦ç»†çš„åˆ†æžæŠ¥å‘Š
â€¢ æŒ‰ä¸åŒç»´åº¦æŽ’åºå±•ç¤º
â€¢ æä¾›ä¼˜åŒ–å»ºè®®
```

**ðŸŽ¯ é€‚ç”¨åœºæ™¯**
- **æ€§èƒ½è°ƒä¼˜**ï¼šå®šä½æ…¢æŸ¥è¯¢ç“¶é¢ˆ
- **å®¹é‡è§„åˆ’**ï¼šåˆ†æžæŸ¥è¯¢æ¨¡å¼å’Œè´Ÿè½½
- **è¿ç»´ç›‘æŽ§**ï¼šå®šæœŸåˆ†æžæ•°æ®åº“æ€§èƒ½
- **é—®é¢˜æŽ’æŸ¥**ï¼šå¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜æ ¹å› 

---

## 2. âš™ï¸ å®‰è£…é…ç½®è¯¦è§£


### 2.1 å®‰è£…æ–¹å¼é€‰æ‹©


**ðŸ”¸ CentOS/RHELç³»ç»Ÿå®‰è£…**
```bash
# æ–¹å¼ä¸€ï¼šé€šè¿‡yumå®‰è£…ï¼ˆæŽ¨èï¼‰
sudo yum install percona-toolkit

# æ–¹å¼äºŒï¼šä¸‹è½½RPMåŒ…å®‰è£…
wget https://www.percona.com/downloads/percona-toolkit/percona-toolkit-3.5.0/binary/redhat/8/x86_64/percona-toolkit-3.5.0-1.el8.x86_64.rpm
sudo rpm -ivh percona-toolkit-3.5.0-1.el8.x86_64.rpm

# éªŒè¯å®‰è£…
pt-query-digest --version
```

**ðŸ”¸ Ubuntu/Debianç³»ç»Ÿå®‰è£…**
```bash
# æ·»åŠ Perconaå®˜æ–¹æº
wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb
sudo dpkg -i percona-release_latest.generic_all.deb
sudo apt-get update

# å®‰è£…å·¥å…·åŒ…
sudo apt-get install percona-toolkit

# éªŒè¯å®‰è£…
pt-query-digest --version
```

**ðŸ”¸ é€šè¿‡Perl CPANå®‰è£…**
```bash
# å®‰è£…ä¾èµ–
sudo yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes

# ä¸‹è½½æºç 
wget https://www.percona.com/downloads/percona-toolkit/percona-toolkit-3.5.0/source/tarball/percona-toolkit-3.5.0.tar.gz
tar -xzf percona-toolkit-3.5.0.tar.gz
cd percona-toolkit-3.5.0

# ç¼–è¯‘å®‰è£…
perl Makefile.PL
make
sudo make install
```

### 2.2 çŽ¯å¢ƒä¾èµ–æ£€æŸ¥


**ðŸ“‹ å¿…è¦ä¾èµ–**
```bash
# æ£€æŸ¥Perlç‰ˆæœ¬ï¼ˆéœ€è¦5.8+ï¼‰
perl --version

# æ£€æŸ¥å¿…è¦çš„Perlæ¨¡å—
perl -MDBI -e 'print "DBI module OK\n"'
perl -MDBD::mysql -e 'print "DBD::mysql module OK\n"'
perl -MTime::HiRes -e 'print "Time::HiRes module OK\n"'

# å¦‚æžœç¼ºå°‘æ¨¡å—ï¼Œå®‰è£…æ–¹æ³•ï¼š
sudo yum install perl-DBI perl-DBD-MySQL perl-Time-HiRes
# æˆ–
sudo cpan DBI DBD::mysql Time::HiRes
```

---

## 3. ðŸ“ åŸºæœ¬ä½¿ç”¨è¯­æ³•


### 3.1 å‘½ä»¤è¯­æ³•æ ¼å¼


**ðŸ”¸ åŸºæœ¬è¯­æ³•ç»“æž„**
```bash
pt-query-digest [OPTIONS] [FILES]

åŸºæœ¬ç”¨æ³•ç¤ºä¾‹ï¼š
# åˆ†æžæ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶
pt-query-digest /var/log/mysql/slow.log

# åˆ†æžæŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—
pt-query-digest --since '2024-01-01 00:00:00' \
                --until '2024-01-01 23:59:59' \
                /var/log/mysql/slow.log

# è¾“å‡ºç»“æžœåˆ°æ–‡ä»¶
pt-query-digest /var/log/mysql/slow.log > slow_analysis.txt
```

### 3.2 å¸¸ç”¨å‚æ•°ç»„åˆ


**âš¡ å®žç”¨å‘½ä»¤æ¨¡æ¿**
```bash
# æ¨¡æ¿1ï¼šåˆ†æžæœ€è¿‘1å°æ—¶çš„æ…¢æŸ¥è¯¢
pt-query-digest --since '1h' /var/log/mysql/slow.log

# æ¨¡æ¿2ï¼šåªæ˜¾ç¤ºå‰10ä¸ªæœ€æ…¢çš„æŸ¥è¯¢
pt-query-digest --limit 10 /var/log/mysql/slow.log

# æ¨¡æ¿3ï¼šæŒ‰æ‰§è¡Œæ¬¡æ•°æŽ’åº
pt-query-digest --order-by Query_time:cnt /var/log/mysql/slow.log

# æ¨¡æ¿4ï¼šè¿‡æ»¤ç‰¹å®šæ•°æ®åº“çš„æŸ¥è¯¢
pt-query-digest --filter '$event->{db} eq "myapp"' /var/log/mysql/slow.log

# æ¨¡æ¿5ï¼šç”Ÿæˆç²¾ç®€æŠ¥å‘Š
pt-query-digest --no-report --output table /var/log/mysql/slow.log
```

---

## 4. ðŸŽ›ï¸ æ ¸å¿ƒå‚æ•°è¯¦è§£


### 4.1 æ—¶é—´èŒƒå›´å‚æ•°


**ðŸ• --sinceå‚æ•°è¯¦è§£**
```bash
# åŠŸèƒ½ï¼šè®¾ç½®åˆ†æžçš„å¼€å§‹æ—¶é—´
# æ ¼å¼ï¼šæ”¯æŒå¤šç§æ—¶é—´æ ¼å¼

# ç»å¯¹æ—¶é—´æ ¼å¼
--since '2024-01-15 08:00:00'
--since '2024-01-15'

# ç›¸å¯¹æ—¶é—´æ ¼å¼
--since '1h'        # 1å°æ—¶å‰
--since '1d'        # 1å¤©å‰  
--since '1w'        # 1å‘¨å‰
--since '30m'       # 30åˆ†é’Ÿå‰

# å®žé™…åº”ç”¨ç¤ºä¾‹
pt-query-digest --since '2h' /var/log/mysql/slow.log
```

**ðŸ• --untilå‚æ•°è¯¦è§£**
```bash
# åŠŸèƒ½ï¼šè®¾ç½®åˆ†æžçš„ç»“æŸæ—¶é—´
# é…åˆ--sinceä½¿ç”¨ï¼Œç²¾ç¡®æŽ§åˆ¶æ—¶é—´èŒƒå›´

# åˆ†æžç‰¹å®šæ—¶é—´æ®µ
pt-query-digest --since '2024-01-15 08:00:00' \
                --until '2024-01-15 18:00:00' \
                /var/log/mysql/slow.log

# åˆ†æžæ˜¨å¤©çš„æ…¢æŸ¥è¯¢
pt-query-digest --since '1d' --until '12h' /var/log/mysql/slow.log
```

### 4.2 è¿‡æ»¤å’Œé™åˆ¶å‚æ•°


**ðŸ” --filterå‚æ•°è¯¦è§£**
```bash
# åŠŸèƒ½ï¼šæ ¹æ®æ¡ä»¶è¿‡æ»¤æŸ¥è¯¢è®°å½•
# è¯­æ³•ï¼šä½¿ç”¨Perlè¡¨è¾¾å¼è¿›è¡Œè¿‡æ»¤

# å¸¸ç”¨è¿‡æ»¤æ¡ä»¶ç¤ºä¾‹ï¼š

# æŒ‰æ•°æ®åº“åè¿‡æ»¤
--filter '$event->{db} eq "production"'

# æŒ‰æŸ¥è¯¢æ—¶é—´è¿‡æ»¤ï¼ˆå¤§äºŽ5ç§’ï¼‰
--filter '$event->{Query_time} > 5'

# æŒ‰æ‰«æè¡Œæ•°è¿‡æ»¤ï¼ˆå¤§äºŽ10000è¡Œï¼‰
--filter '$event->{Rows_examined} > 10000'

# æŒ‰ç”¨æˆ·è¿‡æ»¤
--filter '$event->{user} eq "app_user"'

# ç»„åˆæ¡ä»¶ï¼ˆæŸ¥è¯¢æ—¶é—´>3ç§’ ä¸” æ‰«æè¡Œæ•°>5000ï¼‰
--filter '$event->{Query_time} > 3 && $event->{Rows_examined} > 5000'

# æŽ’é™¤ç‰¹å®šè¡¨çš„æŸ¥è¯¢
--filter '$event->{arg} !~ /temp_table/'
```

**ðŸ“Š --limitå‚æ•°è¯¦è§£**
```bash
# åŠŸèƒ½ï¼šé™åˆ¶è¾“å‡ºçš„æŸ¥è¯¢æ•°é‡
# é»˜è®¤å€¼ï¼šæ˜¾ç¤ºæ‰€æœ‰æŸ¥è¯¢

# åªæ˜¾ç¤ºå‰5ä¸ªæœ€æ…¢çš„æŸ¥è¯¢
pt-query-digest --limit 5 /var/log/mysql/slow.log

# æ˜¾ç¤ºå‰20ä¸ªæŸ¥è¯¢
pt-query-digest --limit 20 /var/log/mysql/slow.log

# ç»“åˆæŽ’åºä½¿ç”¨
pt-query-digest --order-by Rows_examined:sum --limit 10 /var/log/mysql/slow.log
```

### 4.3 æŽ’åºå‚æ•°è¯¦è§£


**ðŸ“ˆ --order-byå‚æ•°**
```bash
# åŠŸèƒ½ï¼šæŒ‡å®šæŠ¥å‘Šçš„æŽ’åºæ–¹å¼
# æ ¼å¼ï¼šå­—æ®µå:èšåˆå‡½æ•°

# å¸¸ç”¨æŽ’åºé€‰é¡¹ï¼š

# æŒ‰æ€»æŸ¥è¯¢æ—¶é—´æŽ’åºï¼ˆé»˜è®¤ï¼‰
--order-by Query_time:sum

# æŒ‰æŸ¥è¯¢æ¬¡æ•°æŽ’åº
--order-by Query_time:cnt

# æŒ‰å¹³å‡æŸ¥è¯¢æ—¶é—´æŽ’åº  
--order-by Query_time:avg

# æŒ‰æœ€å¤§æŸ¥è¯¢æ—¶é—´æŽ’åº
--order-by Query_time:max

# æŒ‰æ€»æ‰«æè¡Œæ•°æŽ’åº
--order-by Rows_examined:sum

# æŒ‰å¹³å‡æ‰«æè¡Œæ•°æŽ’åº
--order-by Rows_examined:avg

# å®žé™…ä½¿ç”¨ç¤ºä¾‹
pt-query-digest --order-by Query_time:cnt --limit 10 /var/log/mysql/slow.log
```

---

## 5. ðŸ“Š æŠ¥å‘Šæ ¼å¼è§£è¯»


### 5.1 æŠ¥å‘Šæ•´ä½“ç»“æž„


**ðŸ“‹ æŠ¥å‘Šç»„æˆéƒ¨åˆ†**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Overall Statistics        â”‚  â† æ•´ä½“ç»Ÿè®¡ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Profile Summary           â”‚  â† æ€§èƒ½æ¦‚è¦åˆ†æž  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Query Analysis            â”‚  â† è¯¦ç»†æŸ¥è¯¢åˆ†æž
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Query Examples            â”‚  â† æŸ¥è¯¢ç¤ºä¾‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ•´ä½“ç»Ÿè®¡ä¿¡æ¯è§£è¯»


**ðŸ“ˆ Overall Statisticsç¤ºä¾‹**
```
# Time range: 2024-01-15T08:00:00 to 2024-01-15T18:00:00
# Attribute          total     min     max     avg     95%  stddev  median
# ============     ======= ======= ======= ======= ======= ======= =======
# Exec time           234s    10ms     15s   890ms     3s   1.2s   450ms
# Lock time            12s     0us   250ms    45ms   120ms    35ms    28ms
# Rows sent          1.2M       0  125.0k   456.3   2.1k  1.5k     89
# Rows examined     125.6M       0   5.2M  45.1k  195.2k  89.2k   12.3k
# Query size         15.2M      10   8.5k    578   1.2k    425     234
```

**ðŸ’¡ å…³é”®æŒ‡æ ‡å«ä¹‰**
```
Exec timeï¼ˆæ‰§è¡Œæ—¶é—´ï¼‰ï¼š
â€¢ totalï¼šæ‰€æœ‰æŸ¥è¯¢çš„æ€»æ‰§è¡Œæ—¶é—´
â€¢ min/maxï¼šæœ€å¿«/æœ€æ…¢çš„å•æ¬¡æŸ¥è¯¢æ—¶é—´
â€¢ avgï¼šå¹³å‡æ‰§è¡Œæ—¶é—´
â€¢ 95%ï¼š95%çš„æŸ¥è¯¢åœ¨æ­¤æ—¶é—´å†…å®Œæˆ
â€¢ medianï¼šä¸­ä½æ•°æ‰§è¡Œæ—¶é—´

Lock timeï¼ˆé”ç­‰å¾…æ—¶é—´ï¼‰ï¼š
â€¢ æŸ¥è¯¢ç­‰å¾…é”çš„æ€»æ—¶é—´

Rows sentï¼ˆè¿”å›žè¡Œæ•°ï¼‰ï¼š
â€¢ æŸ¥è¯¢è¿”å›žç»™å®¢æˆ·ç«¯çš„æ€»è¡Œæ•°

Rows examinedï¼ˆæ‰«æè¡Œæ•°ï¼‰ï¼š
â€¢ æŸ¥è¯¢æ‰«æçš„æ€»è¡Œæ•°
â€¢ è¯¥å€¼è¿œå¤§äºŽRows sentè¯´æ˜ŽæŸ¥è¯¢æ•ˆçŽ‡ä½Ž

Query sizeï¼ˆæŸ¥è¯¢å¤§å°ï¼‰ï¼š
â€¢ SQLè¯­å¥çš„å­—ç¬¦æ•°ç»Ÿè®¡
```

### 5.3 æ€§èƒ½æ¦‚è¦åˆ†æž


**ðŸ”¥ Profile Summaryç¤ºä¾‹**
```
# Profile
# Rank Query ID           Response time Calls R/Call V/M   Item
# ==== ================== ============= ===== ====== ===== ====
#    1 0x8DDF0A1A77FB0F0D  89.2345 38.1%  2341  0.038  0.02 SELECT user_table
#    2 0x4B2A9F6C8E5D3A7B  45.6789 19.5%  1856  0.025  0.01 SELECT order_table  
#    3 0x9C8F2E1D5A6B4F3E  32.1456 13.7%   892  0.036  0.03 UPDATE product_table
```

**ðŸ“Š å­—æ®µå«ä¹‰è§£é‡Š**
```
Rankï¼šæŽ’åï¼ˆæŒ‰Response timeæŽ’åºï¼‰
Query IDï¼šæŸ¥è¯¢æŒ‡çº¹IDï¼ˆå”¯ä¸€æ ‡è¯†ç›¸ä¼¼æŸ¥è¯¢ï¼‰
Response timeï¼š
â€¢ ç»å¯¹å€¼ï¼šè¯¥ç±»æŸ¥è¯¢çš„æ€»å“åº”æ—¶é—´
â€¢ ç™¾åˆ†æ¯”ï¼šå æ‰€æœ‰æŸ¥è¯¢æ—¶é—´çš„æ¯”ä¾‹
Callsï¼šè¯¥ç±»æŸ¥è¯¢çš„æ‰§è¡Œæ¬¡æ•°
R/Callï¼šæ¯æ¬¡è°ƒç”¨çš„å¹³å‡å“åº”æ—¶é—´
V/Mï¼šå“åº”æ—¶é—´çš„å˜å¼‚ç³»æ•°ï¼ˆæ³¢åŠ¨ç¨‹åº¦ï¼‰
Itemï¼šæŸ¥è¯¢ç±»åž‹å’Œæ¶‰åŠçš„ä¸»è¦è¡¨
```

### 5.4 è¯¦ç»†æŸ¥è¯¢åˆ†æž


**ðŸ” Query Analysisç¤ºä¾‹**
```
# Query 1: 2.34 QPS, 0.89x concurrency, ID 0x8DDF0A1A77FB0F0D at byte 1048576
# This item is included in the report because it matches --limit.
# Scores: V/M = 0.02
# Time range: 2024-01-15T08:00:00 to 2024-01-15T18:00:00
# Attribute    pct   total     min     max     avg     95%  stddev  median
# ============ === ======= ======= ======= ======= ======= ======= =======
# Count         15    2341
# Exec time     38     89s    12ms     2.1s    38ms   85ms    45ms    32ms
# Lock time     25     3.2s     0us    28ms   1.4ms    5ms   2.1ms   890us
# Rows sent     45   125.6k       1     856    53.6     145     89      42
# Rows examine  52    2.3M       1   25.6k  1006.3    2.1k   1.2k     456
# Query size    18    1.2M      45    1.2k   512.3      1k    234     445

# String:
# Databases    myapp
# Hosts        192.168.1.100
# Users        app_user
# Query_time distribution
#   1us-9us    :
#   10us-99us  : ################################################################
#   100us-999us: ################################
#   1ms-9ms    : ########
#   10ms-99ms  : ################
#   100ms-999ms: ####
#   1s-9s      :
#  10s+        :

SELECT user_id, user_name, email, created_time 
FROM user_table 
WHERE status = ? AND created_time > ?
ORDER BY created_time DESC 
LIMIT ?;
```

**ðŸ’¡ åˆ†æžè¦ç‚¹**
```
QPSï¼šæ¯ç§’æŸ¥è¯¢æ•°ï¼ˆQueries Per Secondï¼‰
concurrencyï¼šå¹¶å‘åº¦ï¼ˆåŒæ—¶æ‰§è¡Œçš„æŸ¥è¯¢æ•°ï¼‰
Count pctï¼šè¯¥æŸ¥è¯¢å æ€»æŸ¥è¯¢æ•°çš„ç™¾åˆ†æ¯”
Time distributionï¼šæŸ¥è¯¢æ—¶é—´åˆ†å¸ƒç›´æ–¹å›¾
â€¢ å¯ä»¥çœ‹å‡ºå¤§éƒ¨åˆ†æŸ¥è¯¢åœ¨å“ªä¸ªæ—¶é—´èŒƒå›´å†…
â€¢ æœ‰åŠ©äºŽåˆ¤æ–­æ€§èƒ½ç¨³å®šæ€§
```

---

## 6. ðŸ”‘ æŸ¥è¯¢æŒ‡çº¹æ¦‚å¿µ


### 6.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢æŒ‡çº¹


**ðŸ”¸ æŒ‡çº¹æ¦‚å¿µè§£é‡Š**
```
æŸ¥è¯¢æŒ‡çº¹ï¼ˆQuery Fingerprintï¼‰ï¼š
å°†SQLæŸ¥è¯¢æŠ½è±¡åŒ–å¤„ç†ï¼ŒåŽ»é™¤å…·ä½“å‚æ•°å€¼ï¼Œ
ä¿ç•™æŸ¥è¯¢ç»“æž„çš„æ ‡è¯†ç¬¦

ç›®çš„ï¼š
â€¢ å°†ç»“æž„ç›¸åŒä½†å‚æ•°ä¸åŒçš„æŸ¥è¯¢å½’ä¸ºä¸€ç±»
â€¢ ä¾¿äºŽç»Ÿè®¡åˆ†æžç›¸ä¼¼æŸ¥è¯¢çš„æ€»ä½“æ€§èƒ½
â€¢ å¿«é€Ÿè¯†åˆ«æŸ¥è¯¢æ¨¡å¼
```

**ðŸ’¡ æŒ‡çº¹ç”ŸæˆåŽŸç†**
```
åŽŸå§‹æŸ¥è¯¢1ï¼š
SELECT * FROM users WHERE id = 123 AND status = 'active'

åŽŸå§‹æŸ¥è¯¢2ï¼š  
SELECT * FROM users WHERE id = 456 AND status = 'inactive'

ç”ŸæˆæŒ‡çº¹ï¼š
SELECT * FROM users WHERE id = ? AND status = ?

ç»“æžœï¼šä¸¤ä¸ªæŸ¥è¯¢å…·æœ‰ç›¸åŒçš„æŒ‡çº¹ID
```

### 6.2 æŒ‡çº¹ç”Ÿæˆè§„åˆ™


**ðŸ”§ è½¬æ¢è§„åˆ™**
```
1. æ•°å­—æ›¿æ¢ï¼š
   123, 456, 3.14 â†’ ?

2. å­—ç¬¦ä¸²æ›¿æ¢ï¼š
   'hello', "world" â†’ ?

3. INåˆ—è¡¨æ›¿æ¢ï¼š
   IN (1,2,3,4,5) â†’ IN(?)

4. ç©ºæ ¼æ ‡å‡†åŒ–ï¼š
   å¤šä¸ªç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ª

5. å¤§å°å†™æ ‡å‡†åŒ–ï¼š
   è½¬æ¢ä¸ºç»Ÿä¸€çš„å¤§å°å†™

6. æ³¨é‡Šç§»é™¤ï¼š
   åˆ é™¤SQLæ³¨é‡Š

ç¤ºä¾‹è½¬æ¢è¿‡ç¨‹ï¼š
åŽŸå§‹: SELECT   id,name FROM  users/*æŸ¥è¯¢ç”¨æˆ·*/ WHERE id IN(1,2,3) 
æŒ‡çº¹: select id,name from users where id in(?)
```

### 6.3 æŒ‡çº¹çš„åº”ç”¨ä»·å€¼


**ðŸŽ¯ å®žé™…åº”ç”¨**
```
æ€§èƒ½ç»Ÿè®¡ï¼š
â€¢ ç»Ÿè®¡æŸç±»æŸ¥è¯¢çš„æ€»æ‰§è¡Œæ¬¡æ•°
â€¢ è®¡ç®—å¹³å‡ã€æœ€å¤§ã€æœ€å°æ‰§è¡Œæ—¶é—´
â€¢ è¯†åˆ«é«˜é¢‘æŸ¥è¯¢å’Œæ…¢æŸ¥è¯¢

æ¨¡å¼è¯†åˆ«ï¼š
â€¢ å‘çŽ°åº”ç”¨çš„ä¸»è¦æŸ¥è¯¢æ¨¡å¼
â€¢ è¯†åˆ«å¯èƒ½çš„N+1æŸ¥è¯¢é—®é¢˜
â€¢ åˆ†æžæŸ¥è¯¢çš„æ—¶é—´åˆ†å¸ƒç‰¹å¾

ä¼˜åŒ–æŒ‡å¯¼ï¼š
â€¢ é’ˆå¯¹é«˜é¢‘æ…¢æŸ¥è¯¢è¿›è¡Œç´¢å¼•ä¼˜åŒ–
â€¢ è¯†åˆ«éœ€è¦ç¼“å­˜çš„æŸ¥è¯¢
â€¢ å‘çŽ°éœ€è¦é‡æž„çš„æŸ¥è¯¢é€»è¾‘
```

**ðŸ“Š æŒ‡çº¹IDç¤ºä¾‹**
```
æŒ‡çº¹IDæ ¼å¼ï¼š0x8DDF0A1A77FB0F0D
ç”Ÿæˆæ–¹å¼ï¼šå¯¹æ ‡å‡†åŒ–åŽçš„æŸ¥è¯¢è¿›è¡ŒMD5å“ˆå¸Œ
ç‰¹ç‚¹ï¼š
â€¢ ç›¸åŒç»“æž„çš„æŸ¥è¯¢äº§ç”Ÿç›¸åŒID
â€¢ IDé•¿åº¦å›ºå®šï¼Œä¾¿äºŽç´¢å¼•å’Œæ¯”è¾ƒ
â€¢ å†²çªæ¦‚çŽ‡æžä½Ž
```

---

## 7. ðŸš€ å®žæˆ˜åº”ç”¨åœºæ™¯


### 7.1 æ—¥å¸¸æ€§èƒ½ç›‘æŽ§


**ðŸ“ˆ å®šæœŸåˆ†æžè„šæœ¬**
```bash
#!/bin/bash
# æ¯æ—¥æ…¢æŸ¥è¯¢åˆ†æžè„šæœ¬

DATE=$(date +%Y%m%d)
SLOW_LOG="/var/log/mysql/slow.log"
REPORT_DIR="/opt/mysql_reports"

# åˆ›å»ºæŠ¥å‘Šç›®å½•
mkdir -p $REPORT_DIR

# åˆ†æžæ˜¨å¤©çš„æ…¢æŸ¥è¯¢
pt-query-digest \
  --since '1d' \
  --until '12h' \
  --limit 20 \
  $SLOW_LOG > $REPORT_DIR/slow_analysis_$DATE.txt

# æå–TOP 5æ…¢æŸ¥è¯¢
pt-query-digest \
  --since '1d' \
  --until '12h' \
  --limit 5 \
  --no-report \
  --output table \
  $SLOW_LOG > $REPORT_DIR/top5_slow_$DATE.txt

echo "Daily slow query analysis completed: $REPORT_DIR/slow_analysis_$DATE.txt"
```

### 7.2 é—®é¢˜æŽ’æŸ¥åœºæ™¯


**ðŸ” çªå‘æ€§èƒ½é—®é¢˜åˆ†æž**
```bash
# åœºæ™¯ï¼šä¸‹åˆ3ç‚¹å¼€å§‹æ•°æ®åº“å“åº”å˜æ…¢
# åˆ†æžä¸‹åˆ3ç‚¹åŽçš„æ…¢æŸ¥è¯¢

pt-query-digest \
  --since '2024-01-15 15:00:00' \
  --filter '$event->{Query_time} > 2' \
  --order-by Query_time:max \
  --limit 10 \
  /var/log/mysql/slow.log

# é‡ç‚¹å…³æ³¨ï¼š
# 1. æ˜¯å¦æœ‰æ–°å‡ºçŽ°çš„æ…¢æŸ¥è¯¢æ¨¡å¼
# 2. çŽ°æœ‰æŸ¥è¯¢æ˜¯å¦æ‰§è¡Œæ—¶é—´çªç„¶å¢žé•¿
# 3. é”ç­‰å¾…æ—¶é—´æ˜¯å¦å¼‚å¸¸
```

### 7.3 å®¹é‡è§„åˆ’åˆ†æž


**ðŸ“Š æŸ¥è¯¢æ¨¡å¼åˆ†æž**
```bash
# åˆ†æžä¸€å‘¨çš„æŸ¥è¯¢æ¨¡å¼ï¼Œç”¨äºŽå®¹é‡è§„åˆ’
pt-query-digest \
  --since '1w' \
  --order-by Query_time:cnt \
  --limit 50 \
  /var/log/mysql/slow.log > weekly_query_pattern.txt

# åˆ†æžè¦ç‚¹ï¼š
# 1. å“ªäº›æŸ¥è¯¢é¢‘æ¬¡æœ€é«˜
# 2. æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒç‰¹å¾  
# 3. æ‰«æè¡Œæ•°å’Œè¿”å›žè¡Œæ•°æ¯”ä¾‹
# 4. ä¸åŒæ—¶é—´æ®µçš„æŸ¥è¯¢æ¨¡å¼å·®å¼‚
```

### 7.4 ç´¢å¼•ä¼˜åŒ–æŒ‡å¯¼


**ðŸŽ¯ è¯†åˆ«éœ€è¦ç´¢å¼•çš„æŸ¥è¯¢**
```bash
# æŸ¥æ‰¾æ‰«æè¡Œæ•°è¿‡å¤šçš„æŸ¥è¯¢
pt-query-digest \
  --filter '$event->{Rows_examined} > 10000 && $event->{Rows_sent} < 100' \
  --order-by Rows_examined:avg \
  --limit 20 \
  /var/log/mysql/slow.log

# è¿™ç±»æŸ¥è¯¢ç‰¹å¾ï¼š
# â€¢ æ‰«æè¡Œæ•°è¿œå¤§äºŽè¿”å›žè¡Œæ•°
# â€¢ å¯èƒ½ç¼ºå°‘åˆé€‚çš„ç´¢å¼•
# â€¢ éœ€è¦é‡ç‚¹ä¼˜åŒ–çš„ç›®æ ‡
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ðŸ”¸ pt-query-digestæœ¬è´¨ï¼šMySQLæ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æžå·¥å…·
ðŸ”¸ æŸ¥è¯¢æŒ‡çº¹ï¼šå°†ç›¸ä¼¼æŸ¥è¯¢å½’ç±»çš„æŠ½è±¡æ ‡è¯†
ðŸ”¸ æ—¶é—´èŒƒå›´ï¼š--sinceå’Œ--untilç²¾ç¡®æŽ§åˆ¶åˆ†æžæ—¶æ®µ
ðŸ”¸ è¿‡æ»¤æ¡ä»¶ï¼š--filterå®žçŽ°ç²¾å‡†çš„æŸ¥è¯¢ç­›é€‰
ðŸ”¸ æŽ’åºé™åˆ¶ï¼š--order-byå’Œ--limitæŽ§åˆ¶æŠ¥å‘Šé‡ç‚¹
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ å·¥å…·ä»·å€¼ç†è§£**
```
è§£å†³é—®é¢˜ï¼š
â€¢ æµ·é‡æ…¢æŸ¥è¯¢æ—¥å¿—éš¾ä»¥åˆ†æž
â€¢ æ— æ³•å¿«é€Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ
â€¢ ç¼ºä¹é‡åŒ–çš„ä¼˜åŒ–ä¾æ®

æä¾›èƒ½åŠ›ï¼š
â€¢ è‡ªåŠ¨åˆ†ç»„ç›¸ä¼¼æŸ¥è¯¢
â€¢ ç”Ÿæˆç»“æž„åŒ–åˆ†æžæŠ¥å‘Š  
â€¢ æä¾›è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡
â€¢ æŒ‡å¯¼ç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–
```

**ðŸ”¹ å‚æ•°ä½¿ç”¨æŠ€å·§**
```
æ—¶é—´å‚æ•°ï¼š
â€¢ ä½¿ç”¨ç›¸å¯¹æ—¶é—´æ›´çµæ´»ï¼ˆ1hã€1dã€1wï¼‰
â€¢ ç»å¯¹æ—¶é—´é€‚åˆç‰¹å®šæ—¶æ®µåˆ†æž

è¿‡æ»¤å‚æ•°ï¼š
â€¢ ç»„åˆæ¡ä»¶æé«˜åˆ†æžç²¾åº¦
â€¢ å…³æ³¨æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼ˆQuery_timeã€Rows_examinedï¼‰

æŽ’åºå‚æ•°ï¼š
â€¢ æŒ‰æ‰§è¡Œæ¬¡æ•°æŽ’åºæ‰¾é«˜é¢‘æŸ¥è¯¢
â€¢ æŒ‰æ‰§è¡Œæ—¶é—´æŽ’åºæ‰¾æ…¢æŸ¥è¯¢
â€¢ æŒ‰æ‰«æè¡Œæ•°æŽ’åºæ‰¾æ•ˆçŽ‡ä½ŽæŸ¥è¯¢
```

**ðŸ”¹ æŠ¥å‘Šè§£è¯»è¦ç‚¹**
```
å…³æ³¨æŒ‡æ ‡ä¼˜å…ˆçº§ï¼š
1. Response timeå æ¯”ï¼šæ‰¾å‡ºå½±å“æœ€å¤§çš„æŸ¥è¯¢ç±»åž‹
2. Callsé¢‘æ¬¡ï¼šè¯†åˆ«é«˜é¢‘æŸ¥è¯¢
3. Rows examined/sentæ¯”ä¾‹ï¼šåˆ¤æ–­æŸ¥è¯¢æ•ˆçŽ‡
4. Query time distributionï¼šäº†è§£æ€§èƒ½ç¨³å®šæ€§

ä¼˜åŒ–æ–¹å‘åˆ¤æ–­ï¼š
â€¢ é«˜é¢‘+æ…¢æŸ¥è¯¢ï¼šä¼˜å…ˆä¼˜åŒ–ç›®æ ‡
â€¢ æ‰«æè¡Œæ•°è¿‡å¤šï¼šè€ƒè™‘ç´¢å¼•ä¼˜åŒ–
â€¢ é”ç­‰å¾…æ—¶é—´é•¿ï¼šåˆ†æžå¹¶å‘å†²çª
```

### 8.3 å®žé™…åº”ç”¨ä»·å€¼


- **æ€§èƒ½è°ƒä¼˜**ï¼šå¿«é€Ÿå®šä½æœ€éœ€è¦ä¼˜åŒ–çš„æŸ¥è¯¢
- **è¿ç»´ç›‘æŽ§**ï¼šå»ºç«‹æ—¥å¸¸çš„æ€§èƒ½åˆ†æžæµç¨‹
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºŽæŸ¥è¯¢æ¨¡å¼è¿›è¡Œèµ„æºè§„åˆ’  
- **é—®é¢˜æŽ’æŸ¥**ï¼šçªå‘æ€§èƒ½é—®é¢˜çš„å¿«é€Ÿè¯Šæ–­

**æ ¸å¿ƒè®°å¿†**ï¼š
- pt-query-digestæ˜¯MySQLæ€§èƒ½åˆ†æžçš„å¾—åŠ›åŠ©æ‰‹
- æŸ¥è¯¢æŒ‡çº¹æŠ€æœ¯å®žçŽ°æ™ºèƒ½åˆ†ç»„ç»Ÿè®¡
- çµæ´»çš„å‚æ•°ç»„åˆé€‚åº”ä¸åŒåˆ†æžéœ€æ±‚
- ç»“æž„åŒ–æŠ¥å‘Šæä¾›æ¸…æ™°çš„ä¼˜åŒ–æŒ‡å¯¼