---
title: 29ã€è‡ªå®šä¹‰ç›‘æ§è„šæœ¬å¼€å‘
---
## ğŸ“š ç›®å½•


1. [ç›‘æ§è„šæœ¬å¼€å‘æ¦‚è¿°](#1-ç›‘æ§è„šæœ¬å¼€å‘æ¦‚è¿°)
2. [Shellè„šæœ¬ç›‘æ§å®ç°](#2-Shellè„šæœ¬ç›‘æ§å®ç°)
3. [Pythonç›‘æ§è„šæœ¬ç¼–å†™](#3-Pythonç›‘æ§è„šæœ¬ç¼–å†™)
4. [ç›‘æ§æ•°æ®APIæ¥å£](#4-ç›‘æ§æ•°æ®APIæ¥å£)
5. [å®šæ—¶ä»»åŠ¡é…ç½®æ–¹æ³•](#5-å®šæ—¶ä»»åŠ¡é…ç½®æ–¹æ³•)
6. [ç›‘æ§ç»“æœå­˜å‚¨æ–¹æ¡ˆ](#6-ç›‘æ§ç»“æœå­˜å‚¨æ–¹æ¡ˆ)
7. [å›¾è¡¨ç”Ÿæˆæ–¹æ³•](#7-å›¾è¡¨ç”Ÿæˆæ–¹æ³•)
8. [å‘Šè­¦å®ç°æœºåˆ¶](#8-å‘Šè­¦å®ç°æœºåˆ¶)
9. [ç›‘æ§è„šæœ¬éƒ¨ç½²](#9-ç›‘æ§è„šæœ¬éƒ¨ç½²)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç›‘æ§è„šæœ¬å¼€å‘æ¦‚è¿°



### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç›‘æ§è„šæœ¬



**ç°æœ‰ç›‘æ§å·¥å…·çš„å±€é™æ€§**ï¼š
```
å•†ä¸šç›‘æ§å·¥å…·ï¼š
â€¢ æˆæœ¬é«˜æ˜‚ï¼Œä¸­å°ä¼ä¸šè´Ÿæ‹…é‡
â€¢ åŠŸèƒ½è‡ƒè‚¿ï¼Œå¾ˆå¤šåŠŸèƒ½ç”¨ä¸ä¸Š
â€¢ å®šåˆ¶åŒ–å›°éš¾ï¼Œéš¾ä»¥æ»¡è¶³ç‰¹æ®Šéœ€æ±‚

å¼€æºç›‘æ§å·¥å…·ï¼š
â€¢ é…ç½®å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜
â€¢ èµ„æºæ¶ˆè€—å¤§ï¼Œå½±å“æ•°æ®åº“æ€§èƒ½
â€¢ ä¸å¤Ÿçµæ´»ï¼Œéš¾ä»¥å¿«é€Ÿè°ƒæ•´
```

**è‡ªå®šä¹‰è„šæœ¬çš„ä¼˜åŠ¿**ï¼š
```
ğŸ¯ ç²¾å‡†å®šåˆ¶ï¼šåªç›‘æ§ä½ å…³å¿ƒçš„æŒ‡æ ‡
ğŸ’° æˆæœ¬ä½å»‰ï¼šæ— éœ€é¢å¤–é‡‡è´­è½¯ä»¶
ğŸš€ å¿«é€Ÿå“åº”ï¼šå‘ç°é—®é¢˜ç«‹å³è°ƒæ•´
ğŸ”§ æ˜“äºç»´æŠ¤ï¼šä»£ç ç®€å•ï¼Œä¾¿äºä¿®æ”¹
ğŸ“Š æ•°æ®æŒæ§ï¼šç›‘æ§æ•°æ®å®Œå…¨è‡ªä¸»
```

### 1.2 ç›‘æ§è„šæœ¬çš„æ ¸å¿ƒåŠŸèƒ½



**åŸºç¡€ç›‘æ§åŠŸèƒ½**ï¼š
```
æ•°æ®é‡‡é›†ï¼š
â€¢ æ…¢æŸ¥è¯¢æ—¥å¿—è§£æ
â€¢ æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡æ”¶é›†
â€¢ ç³»ç»Ÿèµ„æºç›‘æ§

æ•°æ®å¤„ç†ï¼š
â€¢ æŒ‡æ ‡è®¡ç®—å’Œç»Ÿè®¡
â€¢ è¶‹åŠ¿åˆ†æ
â€¢ å¼‚å¸¸æ£€æµ‹

ç»“æœè¾“å‡ºï¼š
â€¢ æ—¥å¿—è®°å½•
â€¢ å›¾è¡¨ç”Ÿæˆ
â€¢ å‘Šè­¦é€šçŸ¥
```

### 1.3 æŠ€æœ¯é€‰å‹è€ƒè™‘



| è„šæœ¬è¯­è¨€ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **Shell** | `ç®€å•å¿«é€Ÿï¼Œç³»ç»Ÿé›†æˆå¥½` | `åŠŸèƒ½æœ‰é™ï¼Œå¤æ‚é€»è¾‘å›°éš¾` | `ç®€å•ç›‘æ§ï¼Œç³»ç»Ÿç®¡ç†` |
| **Python** | `åŠŸèƒ½å¼ºå¤§ï¼Œåº“ä¸°å¯Œ` | `æ€§èƒ½ç›¸å¯¹è¾ƒä½` | `å¤æ‚åˆ†æï¼Œæ•°æ®å¤„ç†` |
| **Go** | `æ€§èƒ½ä¼˜ç§€ï¼Œå¹¶å‘å¼º` | `å¼€å‘å‘¨æœŸé•¿` | `é«˜æ€§èƒ½ç›‘æ§ï¼Œå¤§è§„æ¨¡éƒ¨ç½²` |
| **Perl** | `æ–‡æœ¬å¤„ç†å¼º` | `å¯è¯»æ€§å·®ï¼Œç»´æŠ¤å›°éš¾` | `æ—¥å¿—è§£æï¼Œé—ç•™ç³»ç»Ÿ` |

---

## 2. ğŸš Shellè„šæœ¬ç›‘æ§å®ç°



### 2.1 Shellè„šæœ¬çš„ä¼˜åŠ¿



**ä¸ºä»€ä¹ˆé€‰æ‹©Shell**ï¼š
```
å¤©ç„¶ä¼˜åŠ¿ï¼š
â€¢ Linuxç³»ç»ŸåŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–å®‰è£…
â€¢ ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼Œè·å–ä¿¡æ¯æ–¹ä¾¿
â€¢ è„šæœ¬ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½
â€¢ è¿è¡Œæ•ˆç‡é«˜ï¼Œèµ„æºæ¶ˆè€—å°

å®é™…åº”ç”¨ï¼š
â€¢ å¿«é€Ÿæ£€æŸ¥æ•°æ®åº“çŠ¶æ€
â€¢ ç®€å•çš„æ…¢æŸ¥è¯¢ç»Ÿè®¡
â€¢ ç³»ç»Ÿèµ„æºç›‘æ§
â€¢ è‡ªåŠ¨åŒ–è¿ç»´ä»»åŠ¡
```

### 2.2 åŸºç¡€æ…¢æŸ¥è¯¢ç›‘æ§è„šæœ¬



**ğŸ”§ æ ¸å¿ƒç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash

# MySQLæ…¢æŸ¥è¯¢ç›‘æ§è„šæœ¬

# åŠŸèƒ½ï¼šè§£ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œç»Ÿè®¡æ…¢æŸ¥è¯¢æ•°é‡å’Œç±»å‹


# é…ç½®å‚æ•°

MYSQL_HOST="localhost"
MYSQL_USER="monitor"
MYSQL_PASS="password"
SLOW_LOG="/var/log/mysql/slow.log"
ALERT_THRESHOLD=10

# è·å–å½“å‰æ—¶é—´

CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')
LOG_FILE="/var/log/mysql_monitor.log"

# æ£€æŸ¥æ…¢æŸ¥è¯¢æ•°é‡

check_slow_queries() {
#    # è·å–æœ€è¿‘1å°æ—¶çš„æ…¢æŸ¥è¯¢æ•°é‡
    SLOW_COUNT=$(mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASS} \
        -e "SELECT COUNT(*) FROM mysql.slow_log WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 HOUR);" \
        -N 2>/dev/null)
    
    echo "[$CURRENT_TIME] æ…¢æŸ¥è¯¢æ•°é‡: $SLOW_COUNT" >> $LOG_FILE
    
#    # åˆ¤æ–­æ˜¯å¦è¶…è¿‡é˜ˆå€¼
    if [ "$SLOW_COUNT" -gt "$ALERT_THRESHOLD" ]; then
        send_alert "æ…¢æŸ¥è¯¢å‘Šè­¦" "æœ€è¿‘1å°æ—¶æ…¢æŸ¥è¯¢æ•°é‡ï¼š$SLOW_COUNTï¼Œè¶…è¿‡é˜ˆå€¼ï¼š$ALERT_THRESHOLD"
    fi
}

# å‘é€å‘Šè­¦ï¼ˆè¿™é‡Œç”¨é‚®ä»¶ç¤ºä¾‹ï¼‰

send_alert() {
    local subject="$1"
    local message="$2"
    echo "$message" | mail -s "$subject" admin@company.com
}

# ä¸»å‡½æ•°

main() {
    echo "[$CURRENT_TIME] å¼€å§‹ç›‘æ§æ£€æŸ¥" >> $LOG_FILE
    check_slow_queries
    echo "[$CURRENT_TIME] ç›‘æ§æ£€æŸ¥å®Œæˆ" >> $LOG_FILE
}

# æ‰§è¡Œç›‘æ§

main
```

### 2.3 å¢å¼ºç‰ˆShellç›‘æ§è„šæœ¬



**ğŸš€ åŠŸèƒ½æ›´ä¸°å¯Œçš„ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash

# å¢å¼ºç‰ˆMySQLç›‘æ§è„šæœ¬


# é…ç½®æ–‡ä»¶

CONFIG_FILE="/etc/mysql_monitor.conf"
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
else
#    # é»˜è®¤é…ç½®
    MYSQL_HOST="localhost"
    MYSQL_USER="monitor" 
    MYSQL_PASS="password"
    ALERT_EMAIL="admin@company.com"
    SLOW_THRESHOLD=10
    CONNECTION_THRESHOLD=100
fi

# æ—¥å¿—å‡½æ•°

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/mysql_monitor.log
}

# è·å–MySQLçŠ¶æ€

get_mysql_status() {
    mysql -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASS} \
        -e "$1" -N 2>/dev/null
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°

check_connections() {
    local current_conn=$(get_mysql_status "SHOW STATUS LIKE 'Threads_connected';" | awk '{print $2}')
    log_message "å½“å‰è¿æ¥æ•°: $current_conn"
    
    if [ "$current_conn" -gt "$CONNECTION_THRESHOLD" ]; then
        send_alert "è¿æ¥æ•°å‘Šè­¦" "å½“å‰è¿æ¥æ•°ï¼š$current_connï¼Œè¶…è¿‡é˜ˆå€¼ï¼š$CONNECTION_THRESHOLD"
    fi
}

# æ£€æŸ¥æ…¢æŸ¥è¯¢

check_slow_queries() {
    local slow_count=$(get_mysql_status "SHOW STATUS LIKE 'Slow_queries';" | awk '{print $2}')
    log_message "ç´¯è®¡æ…¢æŸ¥è¯¢æ•°: $slow_count"
    
#    # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„é€»è¾‘ï¼Œæ¯”å¦‚ä¸ä¸Šæ¬¡æ£€æŸ¥ç»“æœå¯¹æ¯”
}

# æ£€æŸ¥é”ç­‰å¾…

check_lock_waits() {
    local lock_waits=$(get_mysql_status "SHOW STATUS LIKE 'Table_locks_waited';" | awk '{print $2}')
    log_message "è¡¨é”ç­‰å¾…æ•°: $lock_waits"
}

# å‘é€å‘Šè­¦

send_alert() {
    local subject="MySQLç›‘æ§å‘Šè­¦: $1"
    local message="æ—¶é—´: $(date)
æœåŠ¡å™¨: $(hostname)
è¯¦æƒ…: $2"
    
    echo "$message" | mail -s "$subject" "$ALERT_EMAIL"
    log_message "å‘é€å‘Šè­¦: $1"
}

# ä¸»ç›‘æ§é€»è¾‘

main() {
    log_message "=== å¼€å§‹MySQLç›‘æ§ ==="
    
#    # æ£€æŸ¥MySQLæ˜¯å¦è¿è¡Œ
    if ! mysqladmin -h${MYSQL_HOST} -u${MYSQL_USER} -p${MYSQL_PASS} ping >/dev/null 2>&1; then
        send_alert "æ•°æ®åº“è¿æ¥å¤±è´¥" "æ— æ³•è¿æ¥åˆ°MySQLæœåŠ¡å™¨"
        exit 1
    fi
    
    check_connections
    check_slow_queries  
    check_lock_waits
    
    log_message "=== MySQLç›‘æ§å®Œæˆ ==="
}

main "$@"
```

---

## 3. ğŸ Pythonç›‘æ§è„šæœ¬ç¼–å†™



### 3.1 Pythonçš„ä¼˜åŠ¿



**ä¸ºä»€ä¹ˆé€‰æ‹©Python**ï¼š
```
å¼ºå¤§åŠŸèƒ½ï¼š
â€¢ ä¸°å¯Œçš„ç¬¬ä¸‰æ–¹åº“ï¼ˆpymysql, requests, matplotlibç­‰ï¼‰
â€¢ å¼ºå¤§çš„æ•°æ®å¤„ç†èƒ½åŠ›ï¼ˆpandas, numpyï¼‰
â€¢ å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ
â€¢ æ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘

å®é™…åº”ç”¨ï¼š
â€¢ å¤æ‚çš„æ…¢æŸ¥è¯¢åˆ†æ
â€¢ æ•°æ®å¯è§†åŒ–å›¾è¡¨ç”Ÿæˆ
â€¢ ä¸å„ç§ç³»ç»ŸAPIé›†æˆ
â€¢ æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
```

### 3.2 åŸºç¡€Pythonç›‘æ§è„šæœ¬



**ğŸ”§ æ ¸å¿ƒç›‘æ§ç±»è®¾è®¡**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
MySQLæ…¢æŸ¥è¯¢ç›‘æ§è„šæœ¬
åŠŸèƒ½ï¼šç›‘æ§MySQLæ…¢æŸ¥è¯¢ï¼Œç”ŸæˆæŠ¥è¡¨ï¼Œå‘é€å‘Šè­¦
"""

import pymysql
import logging
import json
import smtplib
from datetime import datetime, timedelta
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

class MySQLMonitor:
    def __init__(self, config_file='config.json'):
        """åˆå§‹åŒ–ç›‘æ§å™¨"""
        self.load_config(config_file)
        self.setup_logging()
        self.db_connection = None
    
    def load_config(self, config_file):
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        try:
            with open(config_file, 'r', encoding='utf-8') as f:
                self.config = json.load(f)
        except FileNotFoundError:
#            # é»˜è®¤é…ç½®
            self.config = {
                "database": {
                    "host": "localhost",
                    "user": "monitor",
                    "password": "password",
                    "database": "mysql"
                },
                "thresholds": {
                    "slow_queries": 10,
                    "connections": 100,
                    "query_time": 2.0
                },
                "email": {
                    "smtp_server": "smtp.company.com",
                    "smtp_port": 587,
                    "username": "monitor@company.com",
                    "password": "email_password",
                    "to_addresses": ["admin@company.com"]
                }
            }
    
    def setup_logging(self):
        """è®¾ç½®æ—¥å¿—"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('/var/log/mysql_monitor.log'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    def connect_database(self):
        """è¿æ¥æ•°æ®åº“"""
        try:
            self.db_connection = pymysql.connect(
                host=self.config['database']['host'],
                user=self.config['database']['user'],
                password=self.config['database']['password'],
                database=self.config['database']['database'],
                charset='utf8mb4'
            )
            self.logger.info("æ•°æ®åº“è¿æ¥æˆåŠŸ")
            return True
        except Exception as e:
            self.logger.error(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
            return False
    
    def get_slow_queries_count(self, hours=1):
        """è·å–æŒ‡å®šæ—¶é—´å†…çš„æ…¢æŸ¥è¯¢æ•°é‡"""
        try:
            with self.db_connection.cursor() as cursor:
                sql = """
                SELECT COUNT(*) as slow_count 
                FROM mysql.slow_log 
                WHERE start_time > %s
                """
                start_time = datetime.now() - timedelta(hours=hours)
                cursor.execute(sql, (start_time,))
                result = cursor.fetchone()
                return result[0] if result else 0
        except Exception as e:
            self.logger.error(f"è·å–æ…¢æŸ¥è¯¢æ•°é‡å¤±è´¥: {e}")
            return 0
    
    def get_current_connections(self):
        """è·å–å½“å‰è¿æ¥æ•°"""
        try:
            with self.db_connection.cursor() as cursor:
                cursor.execute("SHOW STATUS LIKE 'Threads_connected'")
                result = cursor.fetchone()
                return int(result[1]) if result else 0
        except Exception as e:
            self.logger.error(f"è·å–è¿æ¥æ•°å¤±è´¥: {e}")
            return 0
    
    def send_alert(self, subject, message):
        """å‘é€é‚®ä»¶å‘Šè­¦"""
        try:
            msg = MIMEMultipart()
            msg['From'] = self.config['email']['username']
            msg['To'] = ', '.join(self.config['email']['to_addresses'])
            msg['Subject'] = f"MySQLç›‘æ§å‘Šè­¦: {subject}"
            
            msg.attach(MIMEText(message, 'plain', 'utf-8'))
            
            server = smtplib.SMTP(
                self.config['email']['smtp_server'], 
                self.config['email']['smtp_port']
            )
            server.starttls()
            server.login(
                self.config['email']['username'], 
                self.config['email']['password']
            )
            server.send_message(msg)
            server.quit()
            
            self.logger.info(f"å‘Šè­¦é‚®ä»¶å‘é€æˆåŠŸ: {subject}")
        except Exception as e:
            self.logger.error(f"å‘é€å‘Šè­¦é‚®ä»¶å¤±è´¥: {e}")
    
    def check_slow_queries(self):
        """æ£€æŸ¥æ…¢æŸ¥è¯¢"""
        slow_count = self.get_slow_queries_count()
        threshold = self.config['thresholds']['slow_queries']
        
        self.logger.info(f"æœ€è¿‘1å°æ—¶æ…¢æŸ¥è¯¢æ•°é‡: {slow_count}")
        
        if slow_count > threshold:
            message = f"""
            æœåŠ¡å™¨: {self.config['database']['host']}
            æ—¶é—´: {datetime.now()}
            æ…¢æŸ¥è¯¢æ•°é‡: {slow_count}
            å‘Šè­¦é˜ˆå€¼: {threshold}
            """
            self.send_alert("æ…¢æŸ¥è¯¢æ•°é‡è¶…æ ‡", message)
    
    def check_connections(self):
        """æ£€æŸ¥è¿æ¥æ•°"""
        current_conn = self.get_current_connections()
        threshold = self.config['thresholds']['connections']
        
        self.logger.info(f"å½“å‰è¿æ¥æ•°: {current_conn}")
        
        if current_conn > threshold:
            message = f"""
            æœåŠ¡å™¨: {self.config['database']['host']}
            æ—¶é—´: {datetime.now()}
            å½“å‰è¿æ¥æ•°: {current_conn}
            å‘Šè­¦é˜ˆå€¼: {threshold}
            """
            self.send_alert("è¿æ¥æ•°è¶…æ ‡", message)
    
    def run_monitor(self):
        """è¿è¡Œç›‘æ§"""
        self.logger.info("=== å¼€å§‹MySQLç›‘æ§ ===")
        
        if not self.connect_database():
            return False
        
        try:
            self.check_slow_queries()
            self.check_connections()
            self.logger.info("=== MySQLç›‘æ§å®Œæˆ ===")
            return True
        except Exception as e:
            self.logger.error(f"ç›‘æ§è¿‡ç¨‹å‡ºé”™: {e}")
            return False
        finally:
            if self.db_connection:
                self.db_connection.close()

# ä¸»ç¨‹åºå…¥å£

if __name__ == "__main__":
    monitor = MySQLMonitor()
    monitor.run_monitor()
```

### 3.3 é…ç½®æ–‡ä»¶ç¤ºä¾‹



**ğŸ“‹ config.jsoné…ç½®æ–‡ä»¶**ï¼š
```json
{
    "database": {
        "host": "localhost",
        "port": 3306,
        "user": "monitor",
        "password": "your_password",
        "database": "mysql",
        "charset": "utf8mb4"
    },
    "thresholds": {
        "slow_queries": 10,
        "connections": 100,
        "query_time": 2.0,
        "cpu_usage": 80,
        "memory_usage": 90
    },
    "email": {
        "enabled": true,
        "smtp_server": "smtp.company.com",
        "smtp_port": 587,
        "username": "monitor@company.com",
        "password": "email_password",
        "to_addresses": ["admin@company.com", "dba@company.com"]
    },
    "wechat": {
        "enabled": false,
        "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key"
    },
    "logging": {
        "level": "INFO",
        "file": "/var/log/mysql_monitor.log",
        "max_size": "10MB",
        "backup_count": 5
    }
}
```

---

## 4. ğŸŒ ç›‘æ§æ•°æ®APIæ¥å£



### 4.1 ä¸ºä»€ä¹ˆéœ€è¦APIæ¥å£



**APIæ¥å£çš„ä»·å€¼**ï¼š
```
æ•°æ®é›†æˆï¼š
â€¢ ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿé›†æˆ
â€¢ ä¸ºå‰ç«¯ç•Œé¢æä¾›æ•°æ®
â€¢ æ”¯æŒç¬¬ä¸‰æ–¹å·¥å…·è°ƒç”¨

å®æ—¶æŸ¥è¯¢ï¼š
â€¢ æŒ‰éœ€è·å–ç›‘æ§æ•°æ®
â€¢ æ”¯æŒçµæ´»çš„æŸ¥è¯¢æ¡ä»¶
â€¢ æä¾›JSONæ ¼å¼æ•°æ®

æ‰©å±•æ€§ï¼š
â€¢ ä¾¿äºç³»ç»Ÿé—´é›†æˆ
â€¢ æ”¯æŒå¤šç§å®¢æˆ·ç«¯è°ƒç”¨
â€¢ æ–¹ä¾¿åç»­åŠŸèƒ½æ‰©å±•
```

### 4.2 Flask APIå®ç°



**ğŸ”§ åŸºäºFlaskçš„ç›‘æ§API**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
MySQLç›‘æ§APIæ¥å£
æä¾›RESTful APIè·å–ç›‘æ§æ•°æ®
"""

from flask import Flask, jsonify, request
import pymysql
import json
from datetime import datetime, timedelta

app = Flask(__name__)

class MonitorAPI:
    def __init__(self):
        self.load_config()
        
    def load_config(self):
        """åŠ è½½æ•°æ®åº“é…ç½®"""
        self.db_config = {
            'host': 'localhost',
            'user': 'monitor',
            'password': 'password',
            'database': 'mysql',
            'charset': 'utf8mb4'
        }
    
    def get_db_connection(self):
        """è·å–æ•°æ®åº“è¿æ¥"""
        return pymysql.connect(**self.db_config)
    
    def get_slow_queries_stats(self, hours=24):
        """è·å–æ…¢æŸ¥è¯¢ç»Ÿè®¡"""
        try:
            conn = self.get_db_connection()
            with conn.cursor(pymysql.cursors.DictCursor) as cursor:
                sql = """
                SELECT 
                    COUNT(*) as total_count,
                    AVG(query_time) as avg_query_time,
                    MAX(query_time) as max_query_time,
                    sql_text,
                    COUNT(*) as occurrence_count
                FROM mysql.slow_log 
                WHERE start_time > %s
                GROUP BY sql_text
                ORDER BY occurrence_count DESC
                LIMIT 10
                """
                start_time = datetime.now() - timedelta(hours=hours)
                cursor.execute(sql, (start_time,))
                results = cursor.fetchall()
                
#                # è½¬æ¢æ—¶é—´æ ¼å¼
                for row in results:
                    if row['avg_query_time']:
                        row['avg_query_time'] = float(row['avg_query_time'])
                    if row['max_query_time']:
                        row['max_query_time'] = float(row['max_query_time'])
                
                return results
        except Exception as e:
            return {'error': str(e)}
        finally:
            if 'conn' in locals():
                conn.close()
    
    def get_system_status(self):
        """è·å–ç³»ç»ŸçŠ¶æ€"""
        try:
            conn = self.get_db_connection()
            with conn.cursor(pymysql.cursors.DictCursor) as cursor:
#                # è·å–é‡è¦çš„ç³»ç»ŸçŠ¶æ€å˜é‡
                status_vars = [
                    'Threads_connected', 'Threads_running',
                    'Slow_queries', 'Questions',
                    'Uptime', 'Max_used_connections'
                ]
                
                results = {}
                for var in status_vars:
                    cursor.execute("SHOW STATUS LIKE %s", (var,))
                    result = cursor.fetchone()
                    if result:
                        results[var.lower()] = result['Value']
                
                return results
        except Exception as e:
            return {'error': str(e)}
        finally:
            if 'conn' in locals():
                conn.close()

# åˆ›å»ºAPIå®ä¾‹

monitor_api = MonitorAPI()

@app.route('/api/health', methods=['GET'])
def health_check():
    """å¥åº·æ£€æŸ¥æ¥å£"""
    return jsonify({
        'status': 'ok',
        'timestamp': datetime.now().isoformat(),
        'service': 'mysql-monitor-api'
    })

@app.route('/api/slow-queries', methods=['GET'])
def get_slow_queries():
    """è·å–æ…¢æŸ¥è¯¢ç»Ÿè®¡"""
    hours = request.args.get('hours', 24, type=int)
    if hours > 168:  # é™åˆ¶æœ€å¤šæŸ¥è¯¢ä¸€å‘¨
        hours = 168
    
    data = monitor_api.get_slow_queries_stats(hours)
    return jsonify({
        'success': True,
        'data': data,
        'query_hours': hours,
        'timestamp': datetime.now().isoformat()
    })

@app.route('/api/system-status', methods=['GET'])
def get_system_status():
    """è·å–ç³»ç»ŸçŠ¶æ€"""
    data = monitor_api.get_system_status()
    return jsonify({
        'success': True,
        'data': data,
        'timestamp': datetime.now().isoformat()
    })

@app.route('/api/connections', methods=['GET'])
def get_connections_info():
    """è·å–è¿æ¥ä¿¡æ¯"""
    try:
        conn = monitor_api.get_db_connection()
        with conn.cursor(pymysql.cursors.DictCursor) as cursor:
#            # è·å–å½“å‰è¿æ¥åˆ—è¡¨
            cursor.execute("SHOW PROCESSLIST")
            processes = cursor.fetchall()
            
#            # ç»Ÿè®¡è¿æ¥çŠ¶æ€
            status_count = {}
            for process in processes:
                state = process.get('State', 'Unknown')
                status_count[state] = status_count.get(state, 0) + 1
            
            return jsonify({
                'success': True,
                'data': {
                    'total_connections': len(processes),
                    'connection_states': status_count,
                    'processes': processes[:10]  # åªè¿”å›å‰10ä¸ª
                },
                'timestamp': datetime.now().isoformat()
            })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        })
    finally:
        if 'conn' in locals():
            conn.close()

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False)
```

### 4.3 APIä½¿ç”¨ç¤ºä¾‹



**ğŸ“¡ è°ƒç”¨APIæ¥å£çš„æ–¹æ³•**ï¼š
```bash
# å¥åº·æ£€æŸ¥

curl http://localhost:5000/api/health

# è·å–æœ€è¿‘24å°æ—¶æ…¢æŸ¥è¯¢ç»Ÿè®¡

curl "http://localhost:5000/api/slow-queries?hours=24"

# è·å–ç³»ç»ŸçŠ¶æ€

curl http://localhost:5000/api/system-status

# è·å–è¿æ¥ä¿¡æ¯

curl http://localhost:5000/api/connections
```

**ğŸ Pythonå®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹**ï¼š
```python
import requests
import json

def get_monitor_data():
    """è·å–ç›‘æ§æ•°æ®"""
    base_url = "http://localhost:5000/api"
    
#    # è·å–æ…¢æŸ¥è¯¢æ•°æ®
    response = requests.get(f"{base_url}/slow-queries", 
                          params={'hours': 24})
    if response.status_code == 200:
        slow_queries = response.json()
        print("æ…¢æŸ¥è¯¢æ•°æ®:", json.dumps(slow_queries, indent=2))
    
#    # è·å–ç³»ç»ŸçŠ¶æ€
    response = requests.get(f"{base_url}/system-status")
    if response.status_code == 200:
        system_status = response.json()
        print("ç³»ç»ŸçŠ¶æ€:", json.dumps(system_status, indent=2))

if __name__ == "__main__":
    get_monitor_data()
```

---

## 5. â° å®šæ—¶ä»»åŠ¡é…ç½®æ–¹æ³•



### 5.1 Crontabå®šæ—¶ä»»åŠ¡



**ä¸ºä»€ä¹ˆä½¿ç”¨Crontab**ï¼š
```
ç³»ç»ŸåŸç”Ÿï¼š
â€¢ Linuxç³»ç»Ÿè‡ªå¸¦ï¼Œæ— éœ€é¢å¤–å®‰è£…
â€¢ ç¨³å®šå¯é ï¼Œä¹…ç»è€ƒéªŒ
â€¢ é…ç½®ç®€å•ï¼Œæ˜“äºç†è§£

çµæ´»è°ƒåº¦ï¼š
â€¢ æ”¯æŒç²¾ç¡®åˆ°åˆ†é’Ÿçš„è°ƒåº¦
â€¢ å¯ä»¥è®¾ç½®å¤æ‚çš„æ—¶é—´è§„åˆ™
â€¢ æ”¯æŒç¯å¢ƒå˜é‡è®¾ç½®
```

**ğŸ”§ Crontabé…ç½®ç¤ºä¾‹**ï¼š
```bash
# ç¼–è¾‘crontab

crontab -e

# æ·»åŠ ç›‘æ§ä»»åŠ¡

# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡åŸºç¡€ç›‘æ§

*/5 * * * * /usr/local/bin/mysql_monitor_basic.sh

# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡è¯¦ç»†åˆ†æ

0 * * * * /usr/local/bin/python3 /opt/mysql_monitor/monitor.py

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ…¢æŸ¥è¯¢åˆ†ææŠ¥å‘Š

0 2 * * * /usr/local/bin/python3 /opt/mysql_monitor/daily_report.py

# æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹æ‰§è¡Œå‘¨æŠ¥

0 9 * * 1 /usr/local/bin/python3 /opt/mysql_monitor/weekly_report.py

# æŸ¥çœ‹crontabä»»åŠ¡

crontab -l

# æ£€æŸ¥cronæœåŠ¡çŠ¶æ€

systemctl status cron
```

**ğŸ“‹ å®ç”¨çš„Crontabæ—¶é—´é…ç½®**ï¼š
```bash
# æ—¶é—´æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨

# *è¡¨ç¤ºä»»æ„å€¼ï¼Œ*/Nè¡¨ç¤ºæ¯Nä¸ªå•ä½


# å¸¸ç”¨æ—¶é—´é…ç½®ï¼š

*/5 * * * *     # æ¯5åˆ†é’Ÿ
0 */2 * * *     # æ¯2å°æ—¶
0 9-17 * * *    # å·¥ä½œæ—¶é—´æ¯å°æ—¶ï¼ˆ9ç‚¹åˆ°17ç‚¹ï¼‰
0 2 * * *       # æ¯å¤©å‡Œæ™¨2ç‚¹
0 2 * * 0       # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹
0 2 1 * *       # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹
```

### 5.2 Systemdå®šæ—¶å™¨



**Systemd Timerçš„ä¼˜åŠ¿**ï¼š
```
ç°ä»£åŒ–ï¼š
â€¢ systemdåŸç”Ÿæ”¯æŒï¼Œæ›´ç°ä»£çš„æ–¹æ¡ˆ
â€¢ æ›´å¥½çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç®¡ç†
â€¢ æ”¯æŒå¤æ‚çš„ä¾èµ–å…³ç³»

å¯é æ€§ï¼š
â€¢ å¤±è´¥é‡è¯•æœºåˆ¶
â€¢ ç³»ç»Ÿå¯åŠ¨åè‡ªåŠ¨è¿è¡Œ
â€¢ æ›´å¥½çš„èµ„æºç®¡ç†
```

**ğŸ”§ Systemd Timeré…ç½®**ï¼š

**æœåŠ¡æ–‡ä»¶ï¼ˆmysql-monitor.serviceï¼‰**ï¼š
```ini
[Unit]
Description=MySQL Monitor Service
After=network.target mysql.service

[Service]
Type=oneshot
User=mysql-monitor
Group=mysql-monitor
WorkingDirectory=/opt/mysql_monitor
ExecStart=/usr/bin/python3 /opt/mysql_monitor/monitor.py
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**å®šæ—¶å™¨æ–‡ä»¶ï¼ˆmysql-monitor.timerï¼‰**ï¼š
```ini
[Unit]
Description=MySQL Monitor Timer
Requires=mysql-monitor.service

[Timer]
OnBootSec=10min
OnUnitActiveSec=5min
AccuracySec=1s

[Install]
WantedBy=timers.target
```

**å¯ç”¨å’Œç®¡ç†å®šæ—¶å™¨**ï¼š
```bash
# å®‰è£…æœåŠ¡æ–‡ä»¶

sudo cp mysql-monitor.service /etc/systemd/system/
sudo cp mysql-monitor.timer /etc/systemd/system/

# é‡æ–°åŠ è½½systemdé…ç½®

sudo systemctl daemon-reload

# å¯ç”¨å¹¶å¯åŠ¨å®šæ—¶å™¨

sudo systemctl enable mysql-monitor.timer
sudo systemctl start mysql-monitor.timer

# æŸ¥çœ‹å®šæ—¶å™¨çŠ¶æ€

sudo systemctl status mysql-monitor.timer

# æŸ¥çœ‹å®šæ—¶å™¨åˆ—è¡¨

sudo systemctl list-timers

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—

sudo journalctl -u mysql-monitor.service -f
```

### 5.3 Python APScheduler



**é€‚ç”¨åœºæ™¯**ï¼š
```
å¤æ‚è°ƒåº¦ï¼š
â€¢ éœ€è¦å¤æ‚çš„è°ƒåº¦é€»è¾‘
â€¢ åŠ¨æ€ä¿®æ”¹è°ƒåº¦è®¡åˆ’
â€¢ ä¸åº”ç”¨ç¨‹åºé›†æˆ

çµæ´»æ€§ï¼š
â€¢ æ”¯æŒå¤šç§è§¦å‘å™¨
â€¢ å¯ä»¥æŒä¹…åŒ–è°ƒåº¦ä¿¡æ¯
â€¢ æ”¯æŒé›†ç¾¤éƒ¨ç½²
```

**ğŸ APSchedulerç¤ºä¾‹**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
ä½¿ç”¨APSchedulerå®ç°MySQLç›‘æ§è°ƒåº¦
"""

from apscheduler.schedulers.blocking import BlockingScheduler
from apscheduler.triggers.cron import CronTrigger
import logging
from datetime import datetime
from monitor import MySQLMonitor

# è®¾ç½®æ—¥å¿—

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class MonitorScheduler:
    def __init__(self):
        self.scheduler = BlockingScheduler()
        self.monitor = MySQLMonitor()
        self.setup_jobs()
    
    def setup_jobs(self):
        """è®¾ç½®è°ƒåº¦ä»»åŠ¡"""
#        # æ¯5åˆ†é’Ÿæ‰§è¡ŒåŸºç¡€ç›‘æ§
        self.scheduler.add_job(
            func=self.basic_monitor,
            trigger='interval',
            minutes=5,
            id='basic_monitor',
            name='åŸºç¡€ç›‘æ§'
        )
        
#        # æ¯å°æ—¶æ‰§è¡Œè¯¦ç»†åˆ†æ
        self.scheduler.add_job(
            func=self.detailed_analysis,
            trigger='cron',
            minute=0,
            id='detailed_analysis',
            name='è¯¦ç»†åˆ†æ'
        )
        
#        # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ—¥æŠ¥
        self.scheduler.add_job(
            func=self.daily_report,
            trigger='cron',
            hour=2,
            minute=0,
            id='daily_report',
            name='æ—¥æŠ¥ç”Ÿæˆ'
        )
        
#        # å·¥ä½œæ—¥ä¸Šåˆ9ç‚¹æ‰§è¡Œå·¥ä½œæ—¥æŠ¥å‘Š
        self.scheduler.add_job(
            func=self.workday_report,
            trigger='cron',
            day_of_week='mon-fri',
            hour=9,
            minute=0,
            id='workday_report',
            name='å·¥ä½œæ—¥æŠ¥å‘Š'
        )
    
    def basic_monitor(self):
        """åŸºç¡€ç›‘æ§ä»»åŠ¡"""
        logger.info("æ‰§è¡ŒåŸºç¡€ç›‘æ§")
        try:
            self.monitor.run_monitor()
            logger.info("åŸºç¡€ç›‘æ§å®Œæˆ")
        except Exception as e:
            logger.error(f"åŸºç¡€ç›‘æ§å¤±è´¥: {e}")
    
    def detailed_analysis(self):
        """è¯¦ç»†åˆ†æä»»åŠ¡"""
        logger.info("æ‰§è¡Œè¯¦ç»†åˆ†æ")
#        # è¿™é‡Œå¯ä»¥è°ƒç”¨æ›´å¤æ‚çš„åˆ†æé€»è¾‘
        
    def daily_report(self):
        """æ—¥æŠ¥ç”Ÿæˆä»»åŠ¡"""
        logger.info("ç”Ÿæˆæ—¥æŠ¥")
#        # è°ƒç”¨æ—¥æŠ¥ç”Ÿæˆé€»è¾‘
        
    def workday_report(self):
        """å·¥ä½œæ—¥æŠ¥å‘Šä»»åŠ¡"""
        logger.info("ç”Ÿæˆå·¥ä½œæ—¥æŠ¥å‘Š")
#        # è°ƒç”¨å·¥ä½œæ—¥æŠ¥å‘Šé€»è¾‘
    
    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨"""
        logger.info("å¯åŠ¨MySQLç›‘æ§è°ƒåº¦å™¨")
        try:
            self.scheduler.start()
        except (KeyboardInterrupt, SystemExit):
            logger.info("è°ƒåº¦å™¨å·²åœæ­¢")

if __name__ == "__main__":
    scheduler = MonitorScheduler()
    scheduler.start()
```

---

## 6. ğŸ’¾ ç›‘æ§ç»“æœå­˜å‚¨æ–¹æ¡ˆ



### 6.1 å­˜å‚¨æ–¹æ¡ˆé€‰æ‹©



**å­˜å‚¨éœ€æ±‚åˆ†æ**ï¼š
```
æ•°æ®ç‰¹ç‚¹ï¼š
â€¢ æ—¶åºæ•°æ®ï¼šæŒ‰æ—¶é—´é¡ºåºäº§ç”Ÿ
â€¢ é‡å¤§ï¼šç›‘æ§æ•°æ®æŒç»­äº§ç”Ÿ
â€¢ æŸ¥è¯¢æ¨¡å¼ï¼šä¸»è¦æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢
â€¢ ä¿ç•™æœŸï¼šçŸ­æœŸè¯¦ç»†ï¼Œé•¿æœŸæ±‡æ€»

å­˜å‚¨è¦æ±‚ï¼š
â€¢ å†™å…¥æ€§èƒ½è¦å¥½
â€¢ æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢
â€¢ æ•°æ®å‹ç¼©èƒ½åŠ›
â€¢ æ–¹ä¾¿æ•°æ®æ¸…ç†
```

| å­˜å‚¨æ–¹æ¡ˆ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **MySQL** | `ç†Ÿæ‚‰åº¦é«˜ï¼ŒåŠŸèƒ½å®Œæ•´` | `æ—¶åºæ•°æ®æ€§èƒ½ä¸€èˆ¬` | `å°è§„æ¨¡ç›‘æ§ï¼Œç°æœ‰MySQLç¯å¢ƒ` |
| **InfluxDB** | `ä¸“ä¸ºæ—¶åºæ•°æ®è®¾è®¡` | `å­¦ä¹ æˆæœ¬ï¼Œé¢å¤–ç»´æŠ¤` | `å¤§è§„æ¨¡ç›‘æ§ï¼Œä¸“ä¸šæ—¶åºéœ€æ±‚` |
| **æ–‡ä»¶å­˜å‚¨** | `ç®€å•å¯é ï¼Œæ— ä¾èµ–` | `æŸ¥è¯¢ä¸ä¾¿ï¼Œå¹¶å‘å·®` | `ç®€å•åœºæ™¯ï¼Œä¸´æ—¶æ–¹æ¡ˆ` |
| **Redis** | `æ€§èƒ½æä½³ï¼Œæ”¯æŒè¿‡æœŸ` | `å†…å­˜æ¶ˆè€—ï¼ŒæŒä¹…åŒ–é™åˆ¶` | `å®æ—¶ç›‘æ§ï¼Œç¼“å­˜åœºæ™¯` |

### 6.2 MySQLå­˜å‚¨æ–¹æ¡ˆ



**ğŸ—„ï¸ MySQLè¡¨ç»“æ„è®¾è®¡**ï¼š
```sql
-- ç›‘æ§æ•°æ®ä¸»è¡¨
CREATE TABLE monitor_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    server_id VARCHAR(50) NOT NULL COMMENT 'æœåŠ¡å™¨æ ‡è¯†',
    metric_name VARCHAR(100) NOT NULL COMMENT 'æŒ‡æ ‡åç§°',
    metric_value DECIMAL(15,2) NOT NULL COMMENT 'æŒ‡æ ‡å€¼',
    tags JSON COMMENT 'æ ‡ç­¾ä¿¡æ¯',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_server_metric_time (server_id, metric_name, created_at),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB COMMENT='ç›‘æ§æ•°æ®è¡¨';

-- æ…¢æŸ¥è¯¢è®°å½•è¡¨
CREATE TABLE slow_query_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    server_id VARCHAR(50) NOT NULL,
    query_time DECIMAL(10,6) NOT NULL COMMENT 'æŸ¥è¯¢æ—¶é—´(ç§’)',
    lock_time DECIMAL(10,6) NOT NULL COMMENT 'é”ç­‰å¾…æ—¶é—´',
    rows_sent INT NOT NULL COMMENT 'è¿”å›è¡Œæ•°',
    rows_examined INT NOT NULL COMMENT 'æ‰«æè¡Œæ•°',
    sql_text TEXT NOT NULL COMMENT 'SQLè¯­å¥',
    sql_hash VARCHAR(32) NOT NULL COMMENT 'SQLå“ˆå¸Œå€¼',
    detected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_server_time (server_id, detected_at),
    INDEX idx_sql_hash (sql_hash),
    INDEX idx_query_time (query_time)
) ENGINE=InnoDB COMMENT='æ…¢æŸ¥è¯¢è®°å½•è¡¨';

-- å‘Šè­¦è®°å½•è¡¨
CREATE TABLE alert_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    server_id VARCHAR(50) NOT NULL,
    alert_type VARCHAR(50) NOT NULL COMMENT 'å‘Šè­¦ç±»å‹',
    alert_level ENUM('INFO', 'WARNING', 'ERROR', 'CRITICAL') NOT NULL,
    message TEXT NOT NULL COMMENT 'å‘Šè­¦ä¿¡æ¯',
    is_resolved BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å·²è§£å†³',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP NULL,
    INDEX idx_server_type_time (server_id, alert_type, created_at),
    INDEX idx_level_resolved (alert_level, is_resolved)
) ENGINE=InnoDB COMMENT='å‘Šè­¦è®°å½•è¡¨';
```

**ğŸ”§ æ•°æ®å­˜å‚¨ç±»å®ç°**ï¼š
```python
import pymysql
import json
import hashlib
from datetime import datetime

class MonitorDataStorage:
    def __init__(self, db_config):
        self.db_config = db_config
    
    def get_connection(self):
        """è·å–æ•°æ®åº“è¿æ¥"""
        return pymysql.connect(**self.db_config)
    
    def save_metric(self, server_id, metric_name, metric_value, tags=None):
        """ä¿å­˜ç›‘æ§æŒ‡æ ‡"""
        try:
            conn = self.get_connection()
            with conn.cursor() as cursor:
                sql = """
                INSERT INTO monitor_data 
                (server_id, metric_name, metric_value, tags)
                VALUES (%s, %s, %s, %s)
                """
                tags_json = json.dumps(tags) if tags else None
                cursor.execute(sql, (server_id, metric_name, metric_value, tags_json))
                conn.commit()
                return True
        except Exception as e:
            print(f"ä¿å­˜ç›‘æ§æŒ‡æ ‡å¤±è´¥: {e}")
            return False
        finally:
            if 'conn' in locals():
                conn.close()
    
    def save_slow_query(self, server_id, query_info):
        """ä¿å­˜æ…¢æŸ¥è¯¢è®°å½•"""
        try:
            conn = self.get_connection()
            with conn.cursor() as cursor:
#                # è®¡ç®—SQLå“ˆå¸Œå€¼
                sql_hash = hashlib.md5(query_info['sql_text'].encode()).hexdigest()
                
                sql = """
                INSERT INTO slow_query_records
                (server_id, query_time, lock_time, rows_sent, 
                 rows_examined, sql_text, sql_hash)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                """
                cursor.execute(sql, (
                    server_id,
                    query_info['query_time'],
                    query_info['lock_time'],
                    query_info['rows_sent'],
                    query_info['rows_examined'],
                    query_info['sql_text'],
                    sql_hash
                ))
                conn.commit()
                return True
        except Exception as e:
            print(f"ä¿å­˜æ…¢æŸ¥è¯¢è®°å½•å¤±è´¥: {e}")
            return False
        finally:
            if 'conn' in locals():
                conn.close()
    
    def get_metrics_by_time_range(self, server_id, metric_name, start_time, end_time):
        """æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ç›‘æ§æ•°æ®"""
        try:
            conn = self.get_connection()
            with conn.cursor(pymysql.cursors.DictCursor) as cursor:
                sql = """
                SELECT metric_value, created_at, tags
                FROM monitor_data
                WHERE server_id = %s AND metric_name = %s
                AND created_at BETWEEN %s AND %s
                ORDER BY created_at
                """
                cursor.execute(sql, (server_id, metric_name, start_time, end_time))
                results = cursor.fetchall()
                
#                # å¤„ç†tagså­—æ®µ
                for row in results:
                    if row['tags']:
                        row['tags'] = json.loads(row['tags'])
                
                return results
        except Exception as e:
            print(f"æŸ¥è¯¢ç›‘æ§æ•°æ®å¤±è´¥: {e}")
            return []
        finally:
            if 'conn' in locals():
                conn.close()
```

### 6.3 æ•°æ®æ¸…ç†ç­–ç•¥



**ğŸ§¹ è‡ªåŠ¨æ•°æ®æ¸…ç†è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
ç›‘æ§æ•°æ®æ¸…ç†è„šæœ¬
å®šæœŸæ¸…ç†è¿‡æœŸçš„ç›‘æ§æ•°æ®
"""

import pymysql
from datetime import datetime, timedelta
import logging

class DataCleaner:
    def __init__(self, db_config):
        self.db_config = db_config
        self.logger = logging.getLogger(__name__)
    
    def clean_old_data(self, table_name, days_to_keep, time_column='created_at'):
        """æ¸…ç†æŒ‡å®šå¤©æ•°ä¹‹å‰çš„æ•°æ®"""
        try:
            conn = pymysql.connect(**self.db_config)
            with conn.cursor() as cursor:
#                # è®¡ç®—åˆ é™¤çš„æ—¶é—´ç‚¹
                cutoff_date = datetime.now() - timedelta(days=days_to_keep)
                
#                # å…ˆæŸ¥è¯¢è¦åˆ é™¤çš„è®°å½•æ•°
                count_sql = f"SELECT COUNT(*) FROM {table_name} WHERE {time_column} < %s"
                cursor.execute(count_sql, (cutoff_date,))
                delete_count = cursor.fetchone()[0]
                
                if delete_count > 0:
#                    # æ‰§è¡Œåˆ é™¤æ“ä½œ
                    delete_sql = f"DELETE FROM {table_name} WHERE {time_column} < %s LIMIT 10000"
                    
                    total_deleted = 0
                    while True:
                        cursor.execute(delete_sql, (cutoff_date,))
                        affected_rows = cursor.rowcount
                        conn.commit()
                        
                        total_deleted += affected_rows
                        self.logger.info(f"ä»{table_name}åˆ é™¤äº†{affected_rows}æ¡è®°å½•")
                        
                        if affected_rows < 10000:  # æ²¡æœ‰æ›´å¤šæ•°æ®éœ€è¦åˆ é™¤
                            break
                    
                    self.logger.info(f"è¡¨{table_name}æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤{total_deleted}æ¡è®°å½•")
                else:
                    self.logger.info(f"è¡¨{table_name}æ— éœ€æ¸…ç†")
                    
        except Exception as e:
            self.logger.error(f"æ¸…ç†è¡¨{table_name}å¤±è´¥: {e}")
        finally:
            if 'conn' in locals():
                conn.close()
    
    def run_cleanup(self):
        """æ‰§è¡Œæ•°æ®æ¸…ç†ä»»åŠ¡"""
        self.logger.info("å¼€å§‹æ•°æ®æ¸…ç†ä»»åŠ¡")
        
#        # æ¸…ç†ç­–ç•¥ï¼šä¿ç•™ä¸åŒæ—¶é—´é•¿åº¦çš„æ•°æ®
        cleanup_rules = [
            ('monitor_data', 90),  # ç›‘æ§æ•°æ®ä¿ç•™90å¤©
            ('slow_query_records', 30),  # æ…¢æŸ¥è¯¢è®°å½•ä¿ç•™30å¤©  
            ('alert_records', 180)  # å‘Šè­¦è®°å½•ä¿ç•™180å¤©
        ]
        
        for table_name, days_to_keep in cleanup_rules:
            self.clean_old_data(table_name, days_to_keep)
        
        self.logger.info("æ•°æ®æ¸…ç†ä»»åŠ¡å®Œæˆ")

# ä½¿ç”¨ç¤ºä¾‹

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    
    db_config = {
        'host': 'localhost',
        'user': 'monitor',
        'password': 'password',
        'database': 'monitor_db'
    }
    
    cleaner = DataCleaner(db_config)
    cleaner.run_cleanup()
```

---

## 7. ğŸ“Š å›¾è¡¨ç”Ÿæˆæ–¹æ³•



### 7.1 ä¸ºä»€ä¹ˆéœ€è¦å›¾è¡¨



**æ•°æ®å¯è§†åŒ–çš„ä»·å€¼**ï¼š
```
ç›´è§‚å±•ç¤ºï¼š
â€¢ è¶‹åŠ¿ä¸€ç›®äº†ç„¶ï¼Œæ¯”æ•°å­—æ›´ç›´è§‚
â€¢ å¼‚å¸¸ç‚¹å®¹æ˜“å‘ç°
â€¢ å¯¹æ¯”åˆ†ææ›´æ¸…æ™°

å†³ç­–æ”¯æŒï¼š
â€¢ ä¸ºè¿ç»´å†³ç­–æä¾›ä¾æ®
â€¢ å¸®åŠ©å‘ç°ç³»ç»Ÿç“¶é¢ˆ
â€¢ é¢„æµ‹æœªæ¥è¶‹åŠ¿

æ²Ÿé€šå·¥å…·ï¼š
â€¢ å‘é¢†å¯¼æ±‡æŠ¥æ›´æœ‰è¯´æœåŠ›
â€¢ å›¢é˜Ÿé—´æ²Ÿé€šæ›´é«˜æ•ˆ
â€¢ é—®é¢˜æè¿°æ›´å‡†ç¡®
```

### 7.2 Matplotlibå›¾è¡¨ç”Ÿæˆ



**ğŸ Python Matplotlibå®ç°**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
MySQLç›‘æ§å›¾è¡¨ç”Ÿæˆå™¨
ä½¿ç”¨matplotlibç”Ÿæˆå„ç§ç›‘æ§å›¾è¡¨
"""

import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import pymysql

# è®¾ç½®ä¸­æ–‡å­—ä½“

plt.rcParams['font.sans-serif'] = ['SimHei']  # é»‘ä½“
plt.rcParams['axes.unicode_minus'] = False   # æ­£å¸¸æ˜¾ç¤ºè´Ÿå·

class MonitorChart:
    def __init__(self, db_config):
        self.db_config = db_config
        
    def get_data_from_db(self, sql, params=None):
        """ä»æ•°æ®åº“è·å–æ•°æ®"""
        try:
            conn = pymysql.connect(**self.db_config)
            df = pd.read_sql(sql, conn, params=params)
            return df
        except Exception as e:
            print(f"è·å–æ•°æ®å¤±è´¥: {e}")
            return pd.DataFrame()
        finally:
            if 'conn' in locals():
                conn.close()
    
    def generate_slow_query_trend_chart(self, hours=24):
        """ç”Ÿæˆæ…¢æŸ¥è¯¢è¶‹åŠ¿å›¾"""
#        # æŸ¥è¯¢æ•°æ®
        sql = """
        SELECT 
            DATE_FORMAT(detected_at, '%Y-%m-%d %H:00:00') as hour,
            COUNT(*) as slow_count,
            AVG(query_time) as avg_query_time
        FROM slow_query_records 
        WHERE detected_at > %s
        GROUP BY DATE_FORMAT(detected_at, '%Y-%m-%d %H:00:00')
        ORDER BY hour
        """
        start_time = datetime.now() - timedelta(hours=hours)
        df = self.get_data_from_db(sql, [start_time])
        
        if df.empty:
            print("æ— æ…¢æŸ¥è¯¢æ•°æ®")
            return
        
#        # è½¬æ¢æ—¶é—´æ ¼å¼
        df['hour'] = pd.to_datetime(df['hour'])
        
#        # åˆ›å»ºå›¾è¡¨
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))
        
#        # æ…¢æŸ¥è¯¢æ•°é‡è¶‹åŠ¿
        ax1.plot(df['hour'], df['slow_count'], marker='o', linewidth=2)
        ax1.set_title(f'æœ€è¿‘{hours}å°æ—¶æ…¢æŸ¥è¯¢æ•°é‡è¶‹åŠ¿')
        ax1.set_ylabel('æ…¢æŸ¥è¯¢æ•°é‡')
        ax1.grid(True, alpha=0.3)
        
#        # å¹³å‡æŸ¥è¯¢æ—¶é—´è¶‹åŠ¿
        ax2.plot(df['hour'], df['avg_query_time'], marker='s', color='red', linewidth=2)
        ax2.set_title('å¹³å‡æŸ¥è¯¢æ—¶é—´è¶‹åŠ¿')
        ax2.set_ylabel('å¹³å‡æŸ¥è¯¢æ—¶é—´(ç§’)')
        ax2.set_xlabel('æ—¶é—´')
        ax2.grid(True, alpha=0.3)
        
#        # æ ¼å¼åŒ–æ—¶é—´è½´
        for ax in [ax1, ax2]:
            ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d %H:%M'))
            ax.xaxis.set_major_locator(mdates.HourLocator(interval=4))
            plt.setp(ax.xaxis.get_majorticklabels(), rotation=45)
        
        plt.tight_layout()
        
#        # ä¿å­˜å›¾è¡¨
        output_file = f'slow_query_trend_{datetime.now().strftime("%Y%m%d_%H%M")}.png'
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"æ…¢æŸ¥è¯¢è¶‹åŠ¿å›¾å·²ä¿å­˜: {output_file}")
        
        return output_file
    
    def generate_connection_chart(self, hours=24):
        """ç”Ÿæˆè¿æ¥æ•°å˜åŒ–å›¾è¡¨"""
        sql = """
        SELECT 
            created_at,
            metric_value as connections
        FROM monitor_data 
        WHERE metric_name = 'connections' 
        AND created_at > %s
        ORDER BY created_at
        """
        start_time = datetime.now() - timedelta(hours=hours)
        df = self.get_data_from_db(sql, [start_time])
        
        if df.empty:
            print("æ— è¿æ¥æ•°æ•°æ®")
            return
        
        df['created_at'] = pd.to_datetime(df['created_at'])
        
        plt.figure(figsize=(12, 6))
        plt.plot(df['created_at'], df['connections'], linewidth=2)
        plt.title(f'æœ€è¿‘{hours}å°æ—¶æ•°æ®åº“è¿æ¥æ•°å˜åŒ–')
        plt.ylabel('è¿æ¥æ•°')
        plt.xlabel('æ—¶é—´')
        plt.grid(True, alpha=0.3)
        
#        # æ·»åŠ å¹³å‡çº¿
        avg_connections = df['connections'].mean()
        plt.axhline(y=avg_connections, color='red', linestyle='--', 
                   label=f'å¹³å‡å€¼: {avg_connections:.1f}')
        plt.legend()
        
#        # æ ¼å¼åŒ–æ—¶é—´è½´
        plt.gca().xaxis.set_major_formatter(mdates.DateFormatter('%m-%d %H:%M'))
        plt.gca().xaxis.set_major_locator(mdates.HourLocator(interval=4))
        plt.xticks(rotation=45)
        
        plt.tight_layout()
        
        output_file = f'connections_{datetime.now().strftime("%Y%m%d_%H%M")}.png'
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"è¿æ¥æ•°å›¾è¡¨å·²ä¿å­˜: {output_file}")
        
        return output_file
    
    def generate_top_slow_queries_chart(self, limit=10):
        """ç”ŸæˆTopæ…¢æŸ¥è¯¢é¥¼å›¾"""
        sql = """
        SELECT 
            LEFT(sql_text, 50) as sql_summary,
            COUNT(*) as occurrence_count,
            AVG(query_time) as avg_time
        FROM slow_query_records 
        WHERE detected_at > DATE_SUB(NOW(), INTERVAL 24 HOUR)
        GROUP BY sql_hash 
        ORDER BY occurrence_count DESC 
        LIMIT %s
        """
        df = self.get_data_from_db(sql, [limit])
        
        if df.empty:
            print("æ— æ…¢æŸ¥è¯¢æ•°æ®")
            return
        
        plt.figure(figsize=(10, 8))
        
#        # åˆ›å»ºé¥¼å›¾
        colors = plt.cm.Set3(np.linspace(0, 1, len(df)))
        plt.pie(df['occurrence_count'], 
                labels=[f"{row['sql_summary']}..." for _, row in df.iterrows()],
                autopct='%1.1f%%',
                colors=colors,
                startangle=90)
        
        plt.title(f'Top {limit} æ…¢æŸ¥è¯¢åˆ†å¸ƒ (æœ€è¿‘24å°æ—¶)')
        
        output_file = f'top_slow_queries_{datetime.now().strftime("%Y%m%d_%H%M")}.png'
        plt.savefig(output_file, dpi=300, bbox_inches='tight')
        print(f"Topæ…¢æŸ¥è¯¢å›¾è¡¨å·²ä¿å­˜: {output_file}")
        
        return output_file

# ä½¿ç”¨ç¤ºä¾‹

if __name__ == "__main__":
    db_config = {
        'host': 'localhost',
        'user': 'monitor',
        'password': 'password',
        'database': 'monitor_db'
    }
    
    chart_generator = MonitorChart(db_config)
    
#    # ç”Ÿæˆå„ç§å›¾è¡¨
    chart_generator.generate_slow_query_trend_chart(24)
    chart_generator.generate_connection_chart(24)
    chart_generator.generate_top_slow_queries_chart(10)
```

### 7.3 Webå›¾è¡¨å±•ç¤º



**ğŸŒ åŸºäºChart.jsçš„Webå›¾è¡¨**ï¼š
```html
<!DOCTYPE html>
<html>
<head>
    <title>MySQLç›‘æ§å›¾è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 800px;
            height: 400px;
            margin: 20px auto;
        }
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>MySQLç›‘æ§ä»ªè¡¨æ¿</h1>
        
        <div class="chart-container">
            <canvas id="slowQueryChart"></canvas>
        </div>
        
        <div class="chart-container">
            <canvas id="connectionChart"></canvas>
        </div>
    </div>

    <script>
        // æ…¢æŸ¥è¯¢è¶‹åŠ¿å›¾
        const slowQueryCtx = document.getElementById('slowQueryChart').getContext('2d');
        const slowQueryChart = new Chart(slowQueryCtx, {
            type: 'line',
            data: {
                labels: [], // æ—¶é—´æ ‡ç­¾
                datasets: [{
                    label: 'æ…¢æŸ¥è¯¢æ•°é‡',
                    data: [], // æ•°æ®ç‚¹
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'æ…¢æŸ¥è¯¢è¶‹åŠ¿'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // è¿æ¥æ•°å›¾è¡¨
        const connectionCtx = document.getElementById('connectionChart').getContext('2d');
        const connectionChart = new Chart(connectionCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'è¿æ¥æ•°',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'æ•°æ®åº“è¿æ¥æ•°'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // è·å–æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
        async function updateCharts() {
            try {
                // è·å–æ…¢æŸ¥è¯¢æ•°æ®
                const slowQueryResponse = await fetch('/api/slow-queries?hours=24');
                const slowQueryData = await slowQueryResponse.json();
                
                if (slowQueryData.success) {
                    // æ›´æ–°æ…¢æŸ¥è¯¢å›¾è¡¨æ•°æ®
                    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…APIè¿”å›çš„æ•°æ®æ ¼å¼å¤„ç†
                }
                
                // è·å–è¿æ¥æ•°æ®
                const systemResponse = await fetch('/api/system-status');
                const systemData = await systemResponse.json();
                
                if (systemData.success) {
                    // æ›´æ–°è¿æ¥æ•°å›¾è¡¨
                }
                
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
            }
        }

        // å®šæœŸæ›´æ–°å›¾è¡¨
        updateCharts();
        setInterval(updateCharts, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    </script>
</body>
</html>
```

---

## 8. ğŸš¨ å‘Šè­¦å®ç°æœºåˆ¶



### 8.1 é‚®ä»¶å‘Šè­¦å®ç°



**ğŸ“§ SMTPé‚®ä»¶å‘Šè­¦**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
é‚®ä»¶å‘Šè­¦å®ç°
æ”¯æŒHTMLæ ¼å¼é‚®ä»¶ï¼Œé™„ä»¶å‘é€
"""

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.image import MIMEImage
import os

class EmailAlert:
    def __init__(self, smtp_config):
        self.smtp_config = smtp_config
    
    def send_alert_email(self, subject, message, recipients, attachments=None):
        """å‘é€å‘Šè­¦é‚®ä»¶"""
        try:
#            # åˆ›å»ºé‚®ä»¶å¯¹è±¡
            msg = MIMEMultipart()
            msg['From'] = self.smtp_config['username']
            msg['To'] = ', '.join(recipients)
            msg['Subject'] = subject
            
#            # æ·»åŠ é‚®ä»¶æ­£æ–‡
            html_message = self.create_html_message(message)
            msg.attach(MIMEText(html_message, 'html', 'utf-8'))
            
#            # æ·»åŠ é™„ä»¶
            if attachments:
                for attachment_path in attachments:
                    if os.path.exists(attachment_path):
                        self.add_attachment(msg, attachment_path)
            
#            # å‘é€é‚®ä»¶
            server = smtplib.SMTP(
                self.smtp_config['smtp_server'], 
                self.smtp_config['smtp_port']
            )
            server.starttls()
            server.login(
                self.smtp_config['username'], 
                self.smtp_config['password']
            )
            server.send_message(msg)
            server.quit()
            
            print(f"å‘Šè­¦é‚®ä»¶å‘é€æˆåŠŸ: {subject}")
            return True
            
        except Exception as e:
            print(f"å‘é€é‚®ä»¶å¤±è´¥: {e}")
            return False
    
    def create_html_message(self, message_data):
        """åˆ›å»ºHTMLæ ¼å¼çš„é‚®ä»¶å†…å®¹"""
        html_template = """
        <html>
        <head>
            <style>
                body { font-family: Arial, sans-serif; }
                .alert-header { background-color: #f44336; color: white; padding: 10px; }
                .alert-content { padding: 20px; }
                .metric-table { border-collapse: collapse; width: 100%; }
                .metric-table th, .metric-table td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: left; 
                }
                .metric-table th { background-color: #f2f2f2; }
                .warning { color: #ff9800; }
                .error { color: #f44336; }
                .info { color: #2196f3; }
            </style>
        </head>
        <body>
            <div class="alert-header">
                <h2>ğŸš¨ MySQLç›‘æ§å‘Šè­¦</h2>
            </div>
            <div class="alert-content">
                <p><strong>å‘Šè­¦æ—¶é—´:</strong> {timestamp}</p>
                <p><strong>æœåŠ¡å™¨:</strong> {server}</p>
                <p><strong>å‘Šè­¦çº§åˆ«:</strong> <span class="{level_class}">{level}</span></p>
                
                <h3>è¯¦ç»†ä¿¡æ¯:</h3>
                <p>{details}</p>
                
                {metrics_table}
                
                <hr>
                <p><em>æ­¤é‚®ä»¶ç”±MySQLç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€</em></p>
            </div>
        </body>
        </html>
        """
        
#        # æ ¹æ®æ¶ˆæ¯æ•°æ®å¡«å……æ¨¡æ¿
        level_class = message_data.get('level', 'info').lower()
        metrics_html = self.generate_metrics_table(message_data.get('metrics', {}))
        
        return html_template.format(
            timestamp=message_data.get('timestamp', ''),
            server=message_data.get('server', ''),
            level=message_data.get('level', 'INFO'),
            level_class=level_class,
            details=message_data.get('details', ''),
            metrics_table=metrics_html
        )
    
    def generate_metrics_table(self, metrics):
        """ç”ŸæˆæŒ‡æ ‡è¡¨æ ¼HTML"""
        if not metrics:
            return ""
        
        table_html = '<table class="metric-table"><tr><th>æŒ‡æ ‡</th><th>å½“å‰å€¼</th><th>é˜ˆå€¼</th></tr>'
        
        for metric, data in metrics.items():
            table_html += f"""
            <tr>
                <td>{metric}</td>
                <td>{data.get('current', 'N/A')}</td>
                <td>{data.get('threshold', 'N/A')}</td>
            </tr>
            """
        
        table_html += '</table>'
        return table_html
    
    def add_attachment(self, msg, file_path):
        """æ·»åŠ é™„ä»¶åˆ°é‚®ä»¶"""
        filename = os.path.basename(file_path)
        
        if file_path.endswith('.png') or file_path.endswith('.jpg'):
#            # å›¾ç‰‡é™„ä»¶
            with open(file_path, 'rb') as f:
                img_data = f.read()
            img = MIMEImage(img_data)
            img.add_header('Content-Disposition', f'attachment; filename={filename}')
            msg.attach(img)
        else:
#            # å…¶ä»–ç±»å‹é™„ä»¶
            with open(file_path, 'rb') as f:
                attachment_data = f.read()
            attachment = MIMEText(attachment_data, 'base64', 'utf-8')
            attachment.add_header('Content-Disposition', f'attachment; filename={filename}')
            msg.attach(attachment)

# ä½¿ç”¨ç¤ºä¾‹

email_config = {
    'smtp_server': 'smtp.company.com',
    'smtp_port': 587,
    'username': 'monitor@company.com',
    'password': 'password'
}

email_alert = EmailAlert(email_config)

# å‘é€å‘Šè­¦é‚®ä»¶

alert_data = {
    'timestamp': '2024-09-11 16:30:00',
    'server': 'db-server-01',
    'level': 'ERROR',
    'details': 'æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œç³»ç»Ÿæ€§èƒ½å¯èƒ½å—åˆ°å½±å“',
    'metrics': {
        'æ…¢æŸ¥è¯¢æ•°é‡': {'current': 25, 'threshold': 10},
        'å¹³å‡æŸ¥è¯¢æ—¶é—´': {'current': '3.2ç§’', 'threshold': '2.0ç§’'},
        'å½“å‰è¿æ¥æ•°': {'current': 150, 'threshold': 100}
    }
}

email_alert.send_alert_email(
    subject="æ…¢æŸ¥è¯¢å‘Šè­¦",
    message=alert_data,
    recipients=['admin@company.com', 'dba@company.com'],
    attachments=['slow_query_trend.png']
)
```

### 8.2 å¾®ä¿¡å‘Šè­¦é›†æˆ



**ğŸ’¬ ä¼ä¸šå¾®ä¿¡æœºå™¨äººå‘Šè­¦**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
å¾®ä¿¡å‘Šè­¦å®ç°
æ”¯æŒä¼ä¸šå¾®ä¿¡æœºå™¨äººã€ä¸ªäººå¾®ä¿¡ï¼ˆé€šè¿‡ç¬¬ä¸‰æ–¹APIï¼‰
"""

import requests
import json
from datetime import datetime

class WeChatAlert:
    def __init__(self, webhook_url):
        self.webhook_url = webhook_url
    
    def send_text_message(self, content, mentioned_list=None):
        """å‘é€æ–‡æœ¬æ¶ˆæ¯"""
        data = {
            "msgtype": "text",
            "text": {
                "content": content,
                "mentioned_list": mentioned_list or []
            }
        }
        
        return self._send_message(data)
    
    def send_markdown_message(self, content):
        """å‘é€Markdownæ ¼å¼æ¶ˆæ¯"""
        data = {
            "msgtype": "markdown",
            "markdown": {
                "content": content
            }
        }
        
        return self._send_message(data)
    
    def send_alert_message(self, alert_info):
        """å‘é€æ ¼å¼åŒ–çš„å‘Šè­¦æ¶ˆæ¯"""
#        # æ„å»ºMarkdownæ ¼å¼çš„å‘Šè­¦ä¿¡æ¯
        content = f"""
# ğŸš¨ MySQLç›‘æ§å‘Šè­¦



**å‘Šè­¦æ—¶é—´ï¼š** {alert_info.get('timestamp', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))}
**æœåŠ¡å™¨ï¼š** {alert_info.get('server', 'Unknown')}
**å‘Šè­¦çº§åˆ«ï¼š** <font color="warning">{alert_info.get('level', 'INFO')}</font>

## è¯¦ç»†ä¿¡æ¯


{alert_info.get('details', 'æ— è¯¦ç»†ä¿¡æ¯')}

## å…³é”®æŒ‡æ ‡


"""
        
#        # æ·»åŠ æŒ‡æ ‡ä¿¡æ¯
        metrics = alert_info.get('metrics', {})
        for metric, data in metrics.items():
            current = data.get('current', 'N/A')
            threshold = data.get('threshold', 'N/A')
            content += f"- **{metric}ï¼š** {current} (é˜ˆå€¼: {threshold})\n"
        
        content += f"\n> è¯·åŠæ—¶å¤„ç†ï¼Œé¿å…å½±å“ä¸šåŠ¡"
        
        return self.send_markdown_message(content)
    
    def _send_message(self, data):
        """å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡"""
        try:
            headers = {'Content-Type': 'application/json'}
            response = requests.post(
                self.webhook_url,
                data=json.dumps(data),
                headers=headers,
                timeout=10
            )
            
            result = response.json()
            if result.get('errcode') == 0:
                print("å¾®ä¿¡æ¶ˆæ¯å‘é€æˆåŠŸ")
                return True
            else:
                print(f"å¾®ä¿¡æ¶ˆæ¯å‘é€å¤±è´¥: {result.get('errmsg')}")
                return False
                
        except Exception as e:
            print(f"å‘é€å¾®ä¿¡æ¶ˆæ¯å¼‚å¸¸: {e}")
            return False

# Serveré…±å‘Šè­¦ï¼ˆä¸ªäººå¾®ä¿¡æ¨é€ï¼‰

class ServerChanAlert:
    def __init__(self, sckey):
        self.sckey = sckey
        self.api_url = f"https://sctapi.ftqq.com/{sckey}.send"
    
    def send_alert(self, title, content):
        """é€šè¿‡Serveré…±å‘é€æ¶ˆæ¯åˆ°ä¸ªäººå¾®ä¿¡"""
        try:
            data = {
                'title': title,
                'desp': content
            }
            
            response = requests.post(self.api_url, data=data, timeout=10)
            result = response.json()
            
            if result.get('code') == 0:
                print("Serveré…±æ¶ˆæ¯å‘é€æˆåŠŸ")
                return True
            else:
                print(f"Serveré…±æ¶ˆæ¯å‘é€å¤±è´¥: {result.get('message')}")
                return False
                
        except Exception as e:
            print(f"å‘é€Serveré…±æ¶ˆæ¯å¼‚å¸¸: {e}")
            return False

# ä½¿ç”¨ç¤ºä¾‹

if __name__ == "__main__":
#    # ä¼ä¸šå¾®ä¿¡æœºå™¨äºº
    wechat_webhook = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key"
    wechat_alert = WeChatAlert(wechat_webhook)
    
    alert_data = {
        'timestamp': '2024-09-11 16:30:00',
        'server': 'db-server-01',
        'level': 'ERROR',
        'details': 'æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œç³»ç»Ÿæ€§èƒ½å¯èƒ½å—åˆ°å½±å“',
        'metrics': {
            'æ…¢æŸ¥è¯¢æ•°é‡': {'current': 25, 'threshold': 10},
            'å¹³å‡æŸ¥è¯¢æ—¶é—´': {'current': '3.2ç§’', 'threshold': '2.0ç§’'}
        }
    }
    
    wechat_alert.send_alert_message(alert_data)
    
#    # Serveré…±ä¸ªäººå¾®ä¿¡æ¨é€
    server_chan = ServerChanAlert("your_sckey")
    server_chan.send_alert(
        title="MySQLæ…¢æŸ¥è¯¢å‘Šè­¦",
        content="æ…¢æŸ¥è¯¢æ•°é‡: 25ï¼Œå·²è¶…è¿‡é˜ˆå€¼10"
    )
```

### 8.3 ç»¼åˆå‘Šè­¦ç®¡ç†å™¨



**ğŸ”” ç»Ÿä¸€å‘Šè­¦ç®¡ç†**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
ç»¼åˆå‘Šè­¦ç®¡ç†å™¨
ç»Ÿä¸€ç®¡ç†å¤šç§å‘Šè­¦æ–¹å¼ï¼Œæ”¯æŒå‘Šè­¦çº§åˆ«ã€é¢‘ç‡æ§åˆ¶
"""

import time
import json
from datetime import datetime, timedelta
from enum import Enum

class AlertLevel(Enum):
    INFO = "INFO"
    WARNING = "WARNING"
    ERROR = "ERROR"
    CRITICAL = "CRITICAL"

class AlertManager:
    def __init__(self, config):
        self.config = config
        self.alert_history = {}  # ç”¨äºé¢‘ç‡æ§åˆ¶
        
#        # åˆå§‹åŒ–å„ç§å‘Šè­¦æ–¹å¼
        self.email_alert = EmailAlert(config.get('email', {}))
        self.wechat_alert = WeChatAlert(config.get('wechat', {}).get('webhook_url'))
        self.server_chan = ServerChanAlert(config.get('server_chan', {}).get('sckey'))
    
    def send_alert(self, alert_type, level, message, server_id="localhost"):
        """å‘é€å‘Šè­¦"""
#        # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€å‘Šè­¦ï¼ˆé¢‘ç‡æ§åˆ¶ï¼‰
        if not self._should_send_alert(alert_type, level, server_id):
            return False
        
#        # æ„å»ºå‘Šè­¦æ•°æ®
        alert_data = {
            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'server': server_id,
            'level': level.value,
            'alert_type': alert_type,
            'details': message.get('details', ''),
            'metrics': message.get('metrics', {})
        }
        
#        # è®°å½•å‘Šè­¦å†å²
        self._record_alert(alert_type, level, server_id)
        
#        # æ ¹æ®çº§åˆ«å†³å®šå‘é€æ–¹å¼
        success = True
        
        if level in [AlertLevel.ERROR, AlertLevel.CRITICAL]:
#            # ä¸¥é‡å‘Šè­¦ï¼šå‘é€æ‰€æœ‰æ–¹å¼
            success &= self._send_email_alert(alert_data)
            success &= self._send_wechat_alert(alert_data)
            
            if level == AlertLevel.CRITICAL:
#                # æä¸¥é‡å‘Šè­¦ï¼šé¢å¤–å‘é€ä¸ªäººå¾®ä¿¡
                success &= self._send_server_chan_alert(alert_data)
                
        elif level == AlertLevel.WARNING:
#            # è­¦å‘Šçº§åˆ«ï¼šå‘é€å¾®ä¿¡ç¾¤
            success &= self._send_wechat_alert(alert_data)
            
        elif level == AlertLevel.INFO:
#            # ä¿¡æ¯çº§åˆ«ï¼šä»…è®°å½•æ—¥å¿—
            self._log_alert(alert_data)
        
        return success
    
    def _should_send_alert(self, alert_type, level, server_id, interval_minutes=30):
        """æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘é€å‘Šè­¦ï¼ˆé¿å…å‘Šè­¦é£æš´ï¼‰"""
        key = f"{server_id}_{alert_type}_{level.value}"
        
        if key in self.alert_history:
            last_alert_time = self.alert_history[key]
            if datetime.now() - last_alert_time < timedelta(minutes=interval_minutes):
                return False
        
        return True
    
    def _record_alert(self, alert_type, level, server_id):
        """è®°å½•å‘Šè­¦å†å²"""
        key = f"{server_id}_{alert_type}_{level.value}"
        self.alert_history[key] = datetime.now()
        
#        # æ¸…ç†è¿‡æœŸçš„å†å²è®°å½•
        cutoff_time = datetime.now() - timedelta(hours=24)
        expired_keys = [k for k, v in self.alert_history.items() if v < cutoff_time]
        for key in expired_keys:
            del self.alert_history[key]
    
    def _send_email_alert(self, alert_data):
        """å‘é€é‚®ä»¶å‘Šè­¦"""
        try:
            recipients = self.config.get('email', {}).get('recipients', [])
            if not recipients:
                return True
            
            subject = f"MySQLå‘Šè­¦ - {alert_data['alert_type']} ({alert_data['level']})"
            
            return self.email_alert.send_alert_email(
                subject=subject,
                message=alert_data,
                recipients=recipients
            )
        except Exception as e:
            print(f"å‘é€é‚®ä»¶å‘Šè­¦å¤±è´¥: {e}")
            return False
    
    def _send_wechat_alert(self, alert_data):
        """å‘é€å¾®ä¿¡å‘Šè­¦"""
        try:
            if not self.config.get('wechat', {}).get('enabled', False):
                return True
            
            return self.wechat_alert.send_alert_message(alert_data)
        except Exception as e:
            print(f"å‘é€å¾®ä¿¡å‘Šè­¦å¤±è´¥: {e}")
            return False
    
    def _send_server_chan_alert(self, alert_data):
        """å‘é€Serveré…±å‘Šè­¦"""
        try:
            if not self.config.get('server_chan', {}).get('enabled', False):
                return True
            
            title = f"ğŸš¨ {alert_data['alert_type']} - {alert_data['level']}"
            content = f"æœåŠ¡å™¨: {alert_data['server']}\næ—¶é—´: {alert_data['timestamp']}\nè¯¦æƒ…: {alert_data['details']}"
            
            return self.server_chan.send_alert(title, content)
        except Exception as e:
            print(f"å‘é€Serveré…±å‘Šè­¦å¤±è´¥: {e}")
            return False
    
    def _log_alert(self, alert_data):
        """è®°å½•å‘Šè­¦æ—¥å¿—"""
        log_message = f"[{alert_data['timestamp']}] {alert_data['level']} - {alert_data['alert_type']}: {alert_data['details']}"
        print(log_message)
        
#        # è¿™é‡Œå¯ä»¥å†™å…¥æ—¥å¿—æ–‡ä»¶
        with open('/var/log/mysql_alerts.log', 'a') as f:
            f.write(log_message + '\n')

# é…ç½®ç¤ºä¾‹

alert_config = {
    'email': {
        'enabled': True,
        'smtp_server': 'smtp.company.com',
        'smtp_port': 587,
        'username': 'monitor@company.com',
        'password': 'password',
        'recipients': ['admin@company.com', 'dba@company.com']
    },
    'wechat': {
        'enabled': True,
        'webhook_url': 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key'
    },
    'server_chan': {
        'enabled': True,
        'sckey': 'your_server_chan_key'
    }
}

# ä½¿ç”¨ç¤ºä¾‹

alert_manager = AlertManager(alert_config)

# å‘é€ä¸åŒçº§åˆ«çš„å‘Šè­¦

alert_manager.send_alert(
    alert_type="slow_query",
    level=AlertLevel.ERROR,
    message={
        'details': 'æ…¢æŸ¥è¯¢æ•°é‡è¶…è¿‡é˜ˆå€¼',
        'metrics': {
            'æ…¢æŸ¥è¯¢æ•°é‡': {'current': 25, 'threshold': 10}
        }
    },
    server_id="db-server-01"
)
```

---

## 9. ğŸš€ ç›‘æ§è„šæœ¬éƒ¨ç½²



### 9.1 éƒ¨ç½²ç¯å¢ƒå‡†å¤‡



**ğŸ”§ ç³»ç»Ÿç¯å¢ƒé…ç½®**ï¼š
```bash
#!/bin/bash

# MySQLç›‘æ§è„šæœ¬éƒ¨ç½²å‡†å¤‡è„šæœ¬


# åˆ›å»ºç›‘æ§ç”¨æˆ·

sudo useradd -r -s /bin/bash mysql-monitor
sudo mkdir -p /home/mysql-monitor
sudo chown mysql-monitor:mysql-monitor /home/mysql-monitor

# åˆ›å»ºç›®å½•ç»“æ„

sudo mkdir -p /opt/mysql_monitor/{scripts,config,logs,data}
sudo mkdir -p /var/log/mysql_monitor
sudo chown -R mysql-monitor:mysql-monitor /opt/mysql_monitor
sudo chown -R mysql-monitor:mysql-monitor /var/log/mysql_monitor

# å®‰è£…Pythonä¾èµ–

sudo apt update
sudo apt install -y python3 python3-pip python3-venv

# åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ

sudo -u mysql-monitor python3 -m venv /opt/mysql_monitor/venv
sudo -u mysql-monitor /opt/mysql_monitor/venv/bin/pip install -r requirements.txt

echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ"
```

**ğŸ“‹ requirements.txtä¾èµ–æ–‡ä»¶**ï¼š
```txt
pymysql==1.0.2
requests==2.28.1
matplotlib==3.6.0
pandas==1.5.0
numpy==1.24.0
flask==2.2.2
apscheduler==3.9.1
```

### 9.2 é…ç½®æ–‡ä»¶ç®¡ç†



**ğŸ“„ ä¸»é…ç½®æ–‡ä»¶ï¼ˆ/opt/mysql_monitor/config/config.jsonï¼‰**ï¼š
```json
{
    "database": {
        "host": "localhost",
        "port": 3306,
        "user": "monitor",
        "password": "monitor_password",
        "database": "mysql",
        "charset": "utf8mb4"
    },
    "monitoring": {
        "check_interval": 300,
        "data_retention_days": 90,
        "enable_slow_query_analysis": true,
        "enable_connection_monitoring": true,
        "enable_performance_metrics": true
    },
    "thresholds": {
        "slow_queries_per_hour": 10,
        "max_connections": 100,
        "query_time_threshold": 2.0,
        "cpu_threshold": 80,
        "memory_threshold": 90,
        "disk_usage_threshold": 85
    },
    "alerts": {
        "email": {
            "enabled": true,
            "smtp_server": "smtp.company.com",
            "smtp_port": 587,
            "username": "monitor@company.com",
            "password": "email_password",
            "recipients": [
                "admin@company.com",
                "dba@company.com"
            ]
        },
        "wechat": {
            "enabled": true,
            "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your_key"
        },
        "server_chan": {
            "enabled": false,
            "sckey": "your_server_chan_key"
        }
    },
    "logging": {
        "level": "INFO",
        "file": "/var/log/mysql_monitor/monitor.log",
        "max_size_mb": 100,
        "backup_count": 5
    },
    "reports": {
        "daily_report": {
            "enabled": true,
            "time": "08:00"
        },
        "weekly_report": {
            "enabled": true,
            "day": "monday",
            "time": "09:00"
        }
    }
}
```

### 9.3 SystemdæœåŠ¡é…ç½®



**ğŸ”§ æœåŠ¡é…ç½®æ–‡ä»¶ï¼ˆ/etc/systemd/system/mysql-monitor.serviceï¼‰**ï¼š
```ini
[Unit]
Description=MySQL Monitor Service
After=network.target mysql.service
Wants=mysql.service

[Service]
Type=simple
User=mysql-monitor
Group=mysql-monitor
WorkingDirectory=/opt/mysql_monitor
Environment=PATH=/opt/mysql_monitor/venv/bin
ExecStart=/opt/mysql_monitor/venv/bin/python /opt/mysql_monitor/scripts/monitor_daemon.py
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# èµ„æºé™åˆ¶

LimitNOFILE=65536
MemoryLimit=512M

[Install]
WantedBy=multi-user.target
```

**ğŸš€ å¯åŠ¨è„šæœ¬ï¼ˆmonitor_daemon.pyï¼‰**ï¼š
```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-

"""
MySQLç›‘æ§å®ˆæŠ¤è¿›ç¨‹
ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œï¼Œæä¾›æŒç»­ç›‘æ§
"""

import signal
import sys
import time
import threading
import logging
from pathlib import Path

# æ·»åŠ é¡¹ç›®è·¯å¾„

sys.path.insert(0, str(Path(__file__).parent.parent))

from scripts.monitor import MySQLMonitor
from scripts.api_server import app
from scripts.scheduler import MonitorScheduler

class MonitorDaemon:
    def __init__(self):
        self.running = True
        self.monitor = MySQLMonitor()
        self.scheduler = MonitorScheduler()
        self.api_thread = None
        
#        # è®¾ç½®ä¿¡å·å¤„ç†
        signal.signal(signal.SIGTERM, self.signal_handler)
        signal.signal(signal.SIGINT, self.signal_handler)
        
        logging.basicConfig(level=logging.INFO)
        self.logger = logging.getLogger(__name__)
    
    def signal_handler(self, signum, frame):
        """ä¿¡å·å¤„ç†å™¨"""
        self.logger.info(f"æ”¶åˆ°ä¿¡å· {signum}ï¼Œå‡†å¤‡åœæ­¢æœåŠ¡")
        self.running = False
        
        if self.scheduler:
            self.scheduler.stop()
        
        sys.exit(0)
    
    def start_api_server(self):
        """å¯åŠ¨APIæœåŠ¡å™¨"""
        try:
            app.run(host='0.0.0.0', port=5000, debug=False, threaded=True)
        except Exception as e:
            self.logger.error(f"APIæœåŠ¡å™¨å¯åŠ¨å¤±è´¥: {e}")
    
    def run(self):
        """è¿è¡Œå®ˆæŠ¤è¿›ç¨‹"""
        self.logger.info("MySQLç›‘æ§å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨")
        
        try:
#            # å¯åŠ¨APIæœåŠ¡å™¨ï¼ˆåœ¨å•ç‹¬çº¿ç¨‹ä¸­ï¼‰
            self.api_thread = threading.Thread(target=self.start_api_server, daemon=True)
            self.api_thread.start()
            
#            # å¯åŠ¨è°ƒåº¦å™¨
            self.scheduler.start()
            
#            # ä¸»å¾ªç¯
            while self.running:
                time.sleep(1)
                
        except Exception as e:
            self.logger.error(f"å®ˆæŠ¤è¿›ç¨‹è¿è¡Œå¼‚å¸¸: {e}")
        finally:
            self.logger.info("MySQLç›‘æ§å®ˆæŠ¤è¿›ç¨‹åœæ­¢")

if __name__ == "__main__":
    daemon = MonitorDaemon()
    daemon.run()
```

### 9.4 éƒ¨ç½²è„šæœ¬



**ğŸ“¦ è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆdeploy.shï¼‰**ï¼š
```bash
#!/bin/bash

# MySQLç›‘æ§ç³»ç»Ÿè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬


set -e

INSTALL_DIR="/opt/mysql_monitor"
SERVICE_USER="mysql-monitor"
SERVICE_NAME="mysql-monitor"

echo "=== MySQLç›‘æ§ç³»ç»Ÿéƒ¨ç½²å¼€å§‹ ==="

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·

if [ "$EUID" -ne 0 ]; then
    echo "è¯·ä½¿ç”¨rootç”¨æˆ·è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# åˆ›å»ºç³»ç»Ÿç”¨æˆ·

if ! id "$SERVICE_USER" &>/dev/null; then
    echo "åˆ›å»ºç³»ç»Ÿç”¨æˆ·: $SERVICE_USER"
    useradd -r -s /bin/bash -d /home/$SERVICE_USER $SERVICE_USER
    mkdir -p /home/$SERVICE_USER
    chown $SERVICE_USER:$SERVICE_USER /home/$SERVICE_USER
fi

# åˆ›å»ºç›®å½•ç»“æ„

echo "åˆ›å»ºç›®å½•ç»“æ„"
mkdir -p $INSTALL_DIR/{scripts,config,logs,data,venv}
mkdir -p /var/log/mysql_monitor
chown -R $SERVICE_USER:$SERVICE_USER $INSTALL_DIR
chown -R $SERVICE_USER:$SERVICE_USER /var/log/mysql_monitor

# å®‰è£…ç³»ç»Ÿä¾èµ–

echo "å®‰è£…ç³»ç»Ÿä¾èµ–"
apt update
apt install -y python3 python3-pip python3-venv python3-dev mysql-client

# å¤åˆ¶æ–‡ä»¶

echo "å¤åˆ¶ç¨‹åºæ–‡ä»¶"
cp -r scripts/* $INSTALL_DIR/scripts/
cp -r config/* $INSTALL_DIR/config/
chown -R $SERVICE_USER:$SERVICE_USER $INSTALL_DIR

# åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ

echo "åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ"
sudo -u $SERVICE_USER python3 -m venv $INSTALL_DIR/venv
sudo -u $SERVICE_USER $INSTALL_DIR/venv/bin/pip install --upgrade pip
sudo -u $SERVICE_USER $INSTALL_DIR/venv/bin/pip install -r requirements.txt

# è®¾ç½®æƒé™

echo "è®¾ç½®æ–‡ä»¶æƒé™"
chmod +x $INSTALL_DIR/scripts/*.py
chmod 600 $INSTALL_DIR/config/config.json

# å®‰è£…systemdæœåŠ¡

echo "å®‰è£…systemdæœåŠ¡"
cp systemd/$SERVICE_NAME.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable $SERVICE_NAME

# åˆ›å»ºMySQLç›‘æ§ç”¨æˆ·

echo "è¯·æ‰‹åŠ¨åˆ›å»ºMySQLç›‘æ§ç”¨æˆ·:"
echo "CREATE USER 'monitor'@'localhost' IDENTIFIED BY 'monitor_password';"
echo "GRANT SELECT ON mysql.* TO 'monitor'@'localhost';"
echo "GRANT PROCESS ON *.* TO 'monitor'@'localhost';"
echo "FLUSH PRIVILEGES;"

# å¯åŠ¨æœåŠ¡

echo "å¯åŠ¨ç›‘æ§æœåŠ¡"
systemctl start $SERVICE_NAME

# æ£€æŸ¥æœåŠ¡çŠ¶æ€

echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€"
systemctl status $SERVICE_NAME --no-pager

echo "=== MySQLç›‘æ§ç³»ç»Ÿéƒ¨ç½²å®Œæˆ ==="
echo "é…ç½®æ–‡ä»¶ä½ç½®: $INSTALL_DIR/config/config.json"
echo "æ—¥å¿—æ–‡ä»¶ä½ç½®: /var/log/mysql_monitor/"
echo "APIæ¥å£åœ°å€: http://localhost:5000"
echo ""
echo "å¸¸ç”¨å‘½ä»¤:"
echo "  æŸ¥çœ‹æœåŠ¡çŠ¶æ€: systemctl status $SERVICE_NAME"
echo "  æŸ¥çœ‹æ—¥å¿—: journalctl -u $SERVICE_NAME -f"
echo "  é‡å¯æœåŠ¡: systemctl restart $SERVICE_NAME"
```

### 9.5 å¥åº·æ£€æŸ¥è„šæœ¬



**ğŸ” æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆhealth_check.shï¼‰**ï¼š
```bash
#!/bin/bash

# MySQLç›‘æ§ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬


SERVICE_NAME="mysql-monitor"
API_URL="http://localhost:5000/api/health"
LOG_FILE="/var/log/mysql_monitor/health_check.log"

# è®°å½•æ—¥å¿—å‡½æ•°

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€

check_service_status() {
    if systemctl is-active --quiet $SERVICE_NAME; then
        log_message "âœ“ ç›‘æ§æœåŠ¡è¿è¡Œæ­£å¸¸"
        return 0
    else
        log_message "âœ— ç›‘æ§æœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
}

# æ£€æŸ¥APIæ¥å£

check_api_health() {
    if curl -s --max-time 10 $API_URL > /dev/null; then
        log_message "âœ“ APIæ¥å£å“åº”æ­£å¸¸"
        return 0
    else
        log_message "âœ— APIæ¥å£æ— å“åº”"
        return 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥

check_database_connection() {
    python3 -c "
import sys
sys.path.append('/opt/mysql_monitor')
from scripts.monitor import MySQLMonitor
monitor = MySQLMonitor()
if monitor.connect_database():
    print('âœ“ æ•°æ®åº“è¿æ¥æ­£å¸¸')
    exit(0)
else:
    print('âœ— æ•°æ®åº“è¿æ¥å¤±è´¥')
    exit(1)
" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        log_message "âœ“ æ•°æ®åº“è¿æ¥æ­£å¸¸"
        return 0
    else
        log_message "âœ— æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´

check_disk_space() {
    usage=$(df /opt/mysql_monitor | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ $usage -lt 90 ]; then
        log_message "âœ“ ç£ç›˜ç©ºé—´å……è¶³ (ä½¿ç”¨ç‡: ${usage}%)"
        return 0
    else
        log_message "âœ— ç£ç›˜ç©ºé—´ä¸è¶³ (ä½¿ç”¨ç‡: ${usage}%)"
        return 1
    fi
}

# ä¸»æ£€æŸ¥å‡½æ•°

main() {
    log_message "=== å¼€å§‹å¥åº·æ£€æŸ¥ ==="
    
    failed_checks=0
    
    check_service_status || ((failed_checks++))
    check_api_health || ((failed_checks++))
    check_database_connection || ((failed_checks++))
    check_disk_space || ((failed_checks++))
    
    if [ $failed_checks -eq 0 ]; then
        log_message "=== æ‰€æœ‰æ£€æŸ¥é€šè¿‡ ==="
        exit 0
    else
        log_message "=== æ£€æŸ¥å¤±è´¥é¡¹æ•°: $failed_checks ==="
        
#        # å¦‚æœæœ‰å¤±è´¥é¡¹ï¼Œå°è¯•é‡å¯æœåŠ¡
        if [ $failed_checks -gt 2 ]; then
            log_message "å°è¯•é‡å¯ç›‘æ§æœåŠ¡"
            systemctl restart $SERVICE_NAME
            sleep 10
            
            if systemctl is-active --quiet $SERVICE_NAME; then
                log_message "æœåŠ¡é‡å¯æˆåŠŸ"
            else
                log_message "æœåŠ¡é‡å¯å¤±è´¥"
            fi
        fi
        
        exit 1
    fi
}

main "$@"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ ç›‘æ§è„šæœ¬ä»·å€¼ï¼šä½æˆæœ¬ã€é«˜åº¦å®šåˆ¶ã€å¿«é€Ÿå“åº”çš„ç›‘æ§è§£å†³æ–¹æ¡ˆ
ğŸ”¸ æŠ€æœ¯é€‰å‹åŸåˆ™ï¼šShellç®€å•å¿«é€Ÿï¼ŒPythonåŠŸèƒ½å¼ºå¤§ï¼Œé€‰æ‹©é€‚åˆåœºæ™¯çš„è¯­è¨€
ğŸ”¸ APIæ¥å£é‡è¦æ€§ï¼šæ•°æ®é›†æˆã€å®æ—¶æŸ¥è¯¢ã€ç³»ç»Ÿæ‰©å±•çš„åŸºç¡€
ğŸ”¸ å®šæ—¶ä»»åŠ¡é…ç½®ï¼šCrontabç®€å•å¯é ï¼ŒSystemd Timerç°ä»£åŒ–ï¼ŒAPSchedulerçµæ´»å¼ºå¤§
ğŸ”¸ æ•°æ®å­˜å‚¨ç­–ç•¥ï¼šæ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹æ¡ˆ
ğŸ”¸ å›¾è¡¨å¯è§†åŒ–ï¼šæ•°æ®ç›´è§‚å±•ç¤ºï¼Œå†³ç­–æ”¯æŒï¼Œæ²Ÿé€šå·¥å…·
ğŸ”¸ å¤šæ¸ é“å‘Šè­¦ï¼šé‚®ä»¶ã€å¾®ä¿¡ã€çŸ­ä¿¡ç­‰å¤šç§æ–¹å¼ç¡®ä¿å‘Šè­¦åŠæ—¶é€è¾¾
ğŸ”¸ éƒ¨ç½²è‡ªåŠ¨åŒ–ï¼šæ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹ï¼Œå‡å°‘äººå·¥é”™è¯¯
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ è„šæœ¬å¼€å‘æ€è·¯**ï¼š
```
éœ€æ±‚åˆ†æï¼š
â€¢ æ˜ç¡®ç›‘æ§ç›®æ ‡å’Œå…³é”®æŒ‡æ ‡
â€¢ ç¡®å®šå‘Šè­¦é˜ˆå€¼å’Œå“åº”æœºåˆ¶
â€¢ è€ƒè™‘ç³»ç»Ÿèµ„æºå’Œæ€§èƒ½å½±å“

æ¶æ„è®¾è®¡ï¼š
â€¢ æ¨¡å—åŒ–è®¾è®¡ï¼Œä¾¿äºç»´æŠ¤æ‰©å±•
â€¢ é…ç½®æ–‡ä»¶å¤–ç½®ï¼Œæ–¹ä¾¿è°ƒæ•´
â€¢ æ—¥å¿—è®°å½•å®Œæ•´ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

ä»£ç å®ç°ï¼š
â€¢ å¼‚å¸¸å¤„ç†å®Œå–„ï¼Œé¿å…è„šæœ¬å´©æºƒ
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘å¯¹æ•°æ®åº“å½±å“
â€¢ å®‰å…¨è€ƒè™‘ï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯
```

**ğŸ”¹ ç›‘æ§æ•°æ®çš„ä»·å€¼æŒ–æ˜**ï¼š
```
å®æ—¶ç›‘æ§ï¼š
â€¢ åŠæ—¶å‘ç°é—®é¢˜ï¼Œå‡å°‘æ•…éšœå½±å“
â€¢ æŒæ¡ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
â€¢ ä¸ºæ•…éšœæ’æŸ¥æä¾›æ•°æ®æ”¯æŒ

è¶‹åŠ¿åˆ†æï¼š
â€¢ é¢„æµ‹ç³»ç»Ÿå®¹é‡éœ€æ±‚
â€¢ å‘ç°æ€§èƒ½ç“¶é¢ˆ
â€¢ ä¼˜åŒ–ç³»ç»Ÿé…ç½®

ä¸šåŠ¡ä»·å€¼ï¼š
â€¢ æå‡ç³»ç»Ÿå¯ç”¨æ€§
â€¢ é™ä½è¿ç»´æˆæœ¬
â€¢ æ”¯æŒä¸šåŠ¡å†³ç­–
```

**ğŸ”¹ å‘Šè­¦ç­–ç•¥ä¼˜åŒ–**ï¼š
```
å‘Šè­¦çº§åˆ«è®¾è®¡ï¼š
â€¢ INFOï¼šä¿¡æ¯è®°å½•ï¼Œæ— éœ€ç«‹å³å¤„ç†
â€¢ WARNINGï¼šè­¦å‘Šä¿¡æ¯ï¼Œéœ€è¦å…³æ³¨
â€¢ ERRORï¼šé”™è¯¯çŠ¶æ€ï¼Œéœ€è¦åŠæ—¶å¤„ç†
â€¢ CRITICALï¼šä¸¥é‡æ•…éšœï¼Œç«‹å³å“åº”

é¢‘ç‡æ§åˆ¶ï¼š
â€¢ é¿å…å‘Šè­¦é£æš´ï¼Œè®¾ç½®åˆç†é—´éš”
â€¢ ç›¸åŒé—®é¢˜é¿å…é‡å¤å‘é€
â€¢ æ ¹æ®ä¸¥é‡ç¨‹åº¦è°ƒæ•´é¢‘ç‡

æ¸ é“é€‰æ‹©ï¼š
â€¢ å·¥ä½œæ—¶é—´ä¼˜å…ˆå¾®ä¿¡ç¾¤é€šçŸ¥
â€¢ ä¸¥é‡æ•…éšœä½¿ç”¨å¤šæ¸ é“å¹¶å‘
â€¢ éå·¥ä½œæ—¶é—´ä½¿ç”¨ä¸ªäººå¾®ä¿¡
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ“Š ç›‘æ§æŒ‡æ ‡é€‰æ‹©**ï¼š
```
æ ¸å¿ƒæŒ‡æ ‡ï¼ˆå¿…ç›‘æ§ï¼‰ï¼š
â€¢ æ…¢æŸ¥è¯¢æ•°é‡å’Œå¹³å‡æ‰§è¡Œæ—¶é—´
â€¢ æ•°æ®åº“è¿æ¥æ•°
â€¢ CPUå’Œå†…å­˜ä½¿ç”¨ç‡
â€¢ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ

æ‰©å±•æŒ‡æ ‡ï¼ˆæ ¹æ®éœ€è¦ï¼‰ï¼š
â€¢ é”ç­‰å¾…ç»Ÿè®¡
â€¢ ä¸´æ—¶è¡¨ä½¿ç”¨æƒ…å†µ
â€¢ ç´¢å¼•æ•ˆç‡åˆ†æ
â€¢ å¤åˆ¶å»¶è¿Ÿï¼ˆå¦‚æœæœ‰ï¼‰
```

**ğŸ”§ éƒ¨ç½²æœ€ä½³å®è·µ**ï¼š
```
ç¯å¢ƒéš”ç¦»ï¼š
â€¢ ä½¿ç”¨ä¸“é—¨çš„ç›‘æ§ç”¨æˆ·
â€¢ åˆ›å»ºç‹¬ç«‹çš„å·¥ä½œç›®å½•
â€¢ è®¾ç½®åˆé€‚çš„æ–‡ä»¶æƒé™

æœåŠ¡ç®¡ç†ï¼š
â€¢ ä½¿ç”¨systemdç®¡ç†æœåŠ¡
â€¢ é…ç½®è‡ªåŠ¨é‡å¯æœºåˆ¶
â€¢ è®¾ç½®èµ„æºé™åˆ¶

å®‰å…¨è€ƒè™‘ï¼š
â€¢ æ•°æ®åº“ç”¨æˆ·æœ€å°æƒé™
â€¢ é…ç½®æ–‡ä»¶æƒé™æ§åˆ¶
â€¢ æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
```

**ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
è„šæœ¬æ€§èƒ½ï¼š
â€¢ é¿å…é¢‘ç¹çš„æ•°æ®åº“è¿æ¥
â€¢ ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
â€¢ æ‰¹é‡å¤„ç†æ•°æ®ï¼Œå‡å°‘IO

ç³»ç»Ÿå½±å“ï¼š
â€¢ ç›‘æ§é¢‘ç‡é€‚ä¸­ï¼Œé¿å…è¿‡äºé¢‘ç¹
â€¢ é€‰æ‹©ç³»ç»Ÿç©ºé—²æ—¶é—´æ‰§è¡Œé‡å‹ä»»åŠ¡
â€¢ ç›‘æ§è„šæœ¬æœ¬èº«çš„èµ„æºä½¿ç”¨

æ•°æ®å­˜å‚¨ï¼š
â€¢ å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
â€¢ ä½¿ç”¨åˆé€‚çš„ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡
â€¢ è€ƒè™‘æ•°æ®å‹ç¼©å’Œå½’æ¡£
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ



**â— å¸¸è§é—®é¢˜å¤„ç†**ï¼š
```
è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼š
â€¢ æ£€æŸ¥æƒé™è®¾ç½®
â€¢ éªŒè¯æ•°æ®åº“è¿æ¥
â€¢ æŸ¥çœ‹é”™è¯¯æ—¥å¿—å®šä½é—®é¢˜

å‘Šè­¦å‘é€å¤±è´¥ï¼š
â€¢ éªŒè¯é‚®ä»¶æœåŠ¡å™¨é…ç½®
â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
â€¢ ç¡®è®¤è®¤è¯ä¿¡æ¯æ­£ç¡®

æ•°æ®å­˜å‚¨é—®é¢˜ï¼š
â€¢ ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨
â€¢ æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
â€¢ éªŒè¯è¡¨ç»“æ„å®Œæ•´æ€§

æ€§èƒ½å½±å“ï¼š
â€¢ è°ƒæ•´ç›‘æ§é¢‘ç‡
â€¢ ä¼˜åŒ–SQLæŸ¥è¯¢è¯­å¥
â€¢ ä½¿ç”¨ç´¢å¼•æå‡æŸ¥è¯¢æ•ˆç‡
```

**ğŸ”§ è°ƒè¯•æŠ€å·§**ï¼š
```
æ—¥å¿—åˆ†æï¼š
â€¢ è®¾ç½®è¯¦ç»†çš„æ—¥å¿—çº§åˆ«
â€¢ è®°å½•å…³é”®æ“ä½œå’Œå¼‚å¸¸
â€¢ ä½¿ç”¨æ—¥å¿—è½®è½¬é¿å…æ–‡ä»¶è¿‡å¤§

æµ‹è¯•éªŒè¯ï¼š
â€¢ å•ç‹¬æµ‹è¯•å„ä¸ªæ¨¡å—
â€¢ æ¨¡æ‹Ÿå¼‚å¸¸æƒ…å†µ
â€¢ éªŒè¯å‘Šè­¦æœºåˆ¶æœ‰æ•ˆæ€§

ç›‘æ§ç›‘æ§ï¼š
â€¢ ç›‘æ§è„šæœ¬è‡ªèº«çš„è¿è¡ŒçŠ¶æ€
â€¢ è®¾ç½®è„šæœ¬æ‰§è¡Œè¶…æ—¶
â€¢ è®°å½•è„šæœ¬æ‰§è¡Œæ—¶é—´å’Œèµ„æºä½¿ç”¨
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
éœ€æ±‚æ˜ç¡®é€‰å·¥å…·ï¼ŒShellç®€å•Pythonå…¨
APIæ¥å£æ•°æ®é€šï¼Œå®šæ—¶ä»»åŠ¡è‡ªåŠ¨ç®¡
å­˜å‚¨æ–¹æ¡ˆçœ‹åœºæ™¯ï¼Œå›¾è¡¨å±•ç¤ºæ›´ç›´è§‚
å¤šæ¸ é“å‘Šè­¦ä¿æ—¶æ•ˆï¼Œéƒ¨ç½²è‡ªåŠ¨åŒ–å‡äººå·¥
ç›‘æ§æ•°æ®æŒ–ä»·å€¼ï¼Œä¼˜åŒ–ç³»ç»Ÿææ•ˆç‡
```

**ğŸ¯ å­¦ä¹ å»ºè®®**ï¼š
- ä»ç®€å•çš„Shellè„šæœ¬å¼€å§‹ï¼Œé€æ­¥æ·±å…¥
- å®è·µä¸­å­¦ä¹ ï¼Œåœ¨çœŸå®ç¯å¢ƒä¸­éªŒè¯
- å…³æ³¨å®‰å…¨æ€§ï¼Œä¿æŠ¤ç³»ç»Ÿå’Œæ•°æ®å®‰å…¨
- æŒç»­ä¼˜åŒ–ï¼Œæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
- æ–‡æ¡£å®Œå–„ï¼Œä¾¿äºå›¢é˜Ÿåä½œå’ŒçŸ¥è¯†ä¼ æ‰¿