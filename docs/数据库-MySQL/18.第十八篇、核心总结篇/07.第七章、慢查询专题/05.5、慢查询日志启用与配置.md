---
title: 5、慢查询日志启用与配置
---
## 📚 目录

1. [慢查询日志基础概念](#1-慢查询日志基础概念)
2. [动态配置方法](#2-动态配置方法)
3. [静态配置方法](#3-静态配置方法)
4. [配置参数详解](#4-配置参数详解)
5. [配置验证与查看](#5-配置验证与查看)
6. [配置生效范围说明](#6-配置生效范围说明)
7. [常见问题与解决方案](#7-常见问题与解决方案)
8. [最佳实践建议](#8-最佳实践建议)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 慢查询日志基础概念


### 1.1 什么是慢查询日志


**通俗解释**：慢查询日志就像是MySQL的"性能监控记录本"，专门记录那些执行时间超过设定阈值的SQL语句。

```
类比理解：
就像监控摄像头 → 只记录"可疑行为"
慢查询日志 → 只记录"慢SQL语句"

目的：帮助发现和优化数据库性能问题
```

### 1.2 为什么需要慢查询日志


**🔸 性能问题定位**
- 找出拖慢系统的SQL语句
- 识别需要优化的查询
- 监控数据库整体性能状况

**🔸 业务影响分析**
- 了解哪些功能响应慢
- 分析用户体验问题根源
- 为系统优化提供数据支撑

### 1.3 慢查询日志的工作原理


```
SQL执行流程监控：

客户端 → MySQL服务器 → 执行SQL → 记录执行时间
                              ↓
                         执行时间 > 阈值？
                              ↓
                            YES → 写入慢查询日志
                              ↓
                            NO → 正常结束
```

---

## 2. ⚡ 动态配置方法


### 2.1 什么是动态配置


**🔸 动态配置特点**
- **即时生效**：无需重启MySQL服务
- **临时有效**：MySQL重启后配置丢失
- **适用场景**：临时调试、紧急排查问题

### 2.2 启用慢查询日志


**基础启用命令**
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = ON;

-- 设置慢查询时间阈值（秒）
SET GLOBAL long_query_time = 2;

-- 指定慢查询日志文件路径（可选）
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
```

**🔸 参数说明**
- `slow_query_log`：控制是否启用慢查询日志
- `long_query_time`：设置慢查询时间阈值
- `slow_query_log_file`：指定日志文件存储路径

### 2.3 动态配置示例操作


```sql
-- 步骤1：检查当前配置状态
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- 步骤2：启用慢查询日志
SET GLOBAL slow_query_log = ON;

-- 步骤3：设置2秒为慢查询阈值
SET GLOBAL long_query_time = 2.0;

-- 步骤4：验证配置是否生效
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';
```

### 2.4 动态配置的优缺点


| 特性 | **优点** | **缺点** |
|------|---------|---------|
| **生效时间** | `立即生效，无需重启` | `重启后丢失配置` |
| **操作便捷性** | `命令行直接操作` | `需要手动执行命令` |
| **使用场景** | `临时调试、紧急排查` | `不适合长期使用` |

---

## 3. 🔧 静态配置方法


### 3.1 什么是静态配置


**🔸 静态配置特点**
- **持久有效**：写入配置文件，重启后依然有效
- **需要重启**：修改后需重启MySQL服务才能生效
- **适用场景**：生产环境长期使用

### 3.2 my.cnf配置文件设置


**🔸 配置文件位置**
```bash
# 常见配置文件路径
/etc/mysql/my.cnf          # Ubuntu/Debian
/etc/my.cnf               # CentOS/RHEL
/usr/local/mysql/my.cnf   # 编译安装
```

**🔸 配置内容示例**
```ini
[mysqld]
# 启用慢查询日志
slow_query_log = ON

# 设置慢查询时间阈值（秒）
long_query_time = 2

# 指定慢查询日志文件路径
slow_query_log_file = /var/log/mysql/slow.log

# 记录没有使用索引的查询
log_queries_not_using_indexes = ON

# 限制没有使用索引的查询记录频率
log_throttle_queries_not_using_indexes = 10
```

### 3.3 静态配置操作步骤


**步骤流程图**
```
编辑配置文件 → 保存配置 → 重启MySQL服务 → 验证配置
     ↓              ↓           ↓           ↓
  vi my.cnf    :wq保存    systemctl restart  SHOW VARIABLES
```

**🔸 详细操作**
```bash
# 步骤1：编辑配置文件
sudo vi /etc/mysql/my.cnf

# 步骤2：在[mysqld]段添加配置
# （参考上面的配置内容示例）

# 步骤3：保存并重启MySQL服务
sudo systemctl restart mysql
# 或者
sudo service mysql restart

# 步骤4：验证配置是否生效
mysql -u root -p
mysql> SHOW VARIABLES LIKE 'slow_query%';
```

### 3.4 静态配置vs动态配置对比


```
选择建议：

🎯 临时调试排查 → 使用动态配置
   - 快速启用，立即生效
   - 调试完成后可以关闭

🎯 生产环境长期使用 → 使用静态配置  
   - 持久化配置，重启不丢失
   - 统一管理，规范化运维
```

---

## 4. 📋 配置参数详解


### 4.1 核心参数说明


**🔸 slow_query_log**
```sql
-- 功能：控制慢查询日志开关
-- 可选值：ON/OFF 或 1/0
-- 默认值：OFF（关闭）

SET GLOBAL slow_query_log = ON;   -- 启用
SET GLOBAL slow_query_log = OFF;  -- 关闭
```

**🔸 long_query_time** 
```sql
-- 功能：设置慢查询时间阈值
-- 单位：秒（支持小数）
-- 默认值：10秒
-- 建议值：1-3秒

SET GLOBAL long_query_time = 1.5;  -- 1.5秒
SET GLOBAL long_query_time = 2;    -- 2秒
```

**🔸 slow_query_log_file**
```sql
-- 功能：指定慢查询日志文件路径
-- 默认值：hostname-slow.log
-- 注意：确保MySQL有写入权限

SET GLOBAL slow_query_log_file = '/tmp/mysql-slow.log';
```

### 4.2 扩展参数配置


**🔸 log_queries_not_using_indexes**
```sql
-- 功能：记录没有使用索引的查询
-- 用途：发现缺少索引的SQL
-- 注意：可能产生大量日志

SET GLOBAL log_queries_not_using_indexes = ON;
```

**🔸 log_throttle_queries_not_using_indexes**
```sql
-- 功能：限制没有使用索引的查询记录频率
-- 单位：每分钟记录的查询数量
-- 目的：避免日志文件过大

SET GLOBAL log_throttle_queries_not_using_indexes = 10;
```

### 4.3 参数组合建议


| 环境类型 | **long_query_time** | **log_queries_not_using_indexes** | **说明** |
|---------|-------------------|--------------------------------|---------|
| **开发环境** | `1秒` | `ON` | `便于发现性能问题` |
| **测试环境** | `2秒` | `ON` | `模拟生产环境测试` |
| **生产环境** | `2-3秒` | `ON（谨慎使用）` | `平衡监控和性能` |

---

## 5. 🔍 配置验证与查看


### 5.1 查看当前配置状态


**🔸 查看慢查询相关配置**
```sql
-- 查看所有慢查询相关参数
SHOW VARIABLES LIKE 'slow_query%';

-- 查看慢查询时间阈值
SHOW VARIABLES LIKE 'long_query_time';

-- 查看索引相关配置
SHOW VARIABLES LIKE '%log_queries_not_using_indexes%';
```

**🔸 输出结果示例**
```
mysql> SHOW VARIABLES LIKE 'slow_query%';
+---------------------+--------------------------------+
| Variable_name       | Value                          |
+---------------------+--------------------------------+
| slow_query_log      | ON                             |
| slow_query_log_file | /var/log/mysql/mysql-slow.log |
+---------------------+--------------------------------+
```

### 5.2 查看慢查询统计信息


**🔸 查看慢查询状态**
```sql
-- 查看慢查询统计
SHOW STATUS LIKE 'Slow_queries';

-- 查看总查询数
SHOW STATUS LIKE 'Questions';

-- 计算慢查询比例
SELECT 
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
     WHERE VARIABLE_NAME = 'Slow_queries') /
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
     WHERE VARIABLE_NAME = 'Questions') * 100 AS slow_query_percentage;
```

### 5.3 验证日志文件是否生成


**🔸 检查日志文件**
```bash
# 查看日志文件是否存在
ls -la /var/log/mysql/mysql-slow.log

# 查看日志文件大小
du -h /var/log/mysql/mysql-slow.log

# 实时查看日志内容
tail -f /var/log/mysql/mysql-slow.log
```

### 5.4 测试慢查询记录


**🔸 人为制造慢查询测试**
```sql
-- 使用SLEEP函数制造慢查询
SELECT SLEEP(3), 'This is a slow query test';

-- 查看是否记录到日志
-- 在日志文件中应该能看到这条查询记录
```

---

## 6. 🎯 配置生效范围说明


### 6.1 配置作用域概念


**🔸 全局级别（GLOBAL）**
- **作用范围**：影响所有新的数据库连接
- **设置方法**：`SET GLOBAL variable_name = value`
- **持续时间**：直到MySQL服务重启

**🔸 会话级别（SESSION）**
- **作用范围**：只影响当前数据库连接
- **设置方法**：`SET SESSION variable_name = value`
- **持续时间**：直到当前连接断开

### 6.2 慢查询配置的特殊性


```
💡 重要提示：
慢查询日志相关参数只能在全局级别设置！

错误示例：
SET SESSION slow_query_log = ON;  ❌ 会报错

正确示例：  
SET GLOBAL slow_query_log = ON;   ✅ 正确
```

### 6.3 配置生效时机说明


**🔸 动态配置生效时机**
```
设置时机          对现有连接的影响        对新连接的影响
立即设置     →    不影响正在执行的查询   →   立即生效
```

**🔸 静态配置生效时机**
```
MySQL启动时读取配置文件 → 所有连接都使用新配置
```

### 6.4 配置优先级


```
配置优先级（从高到低）：

1. 动态设置的GLOBAL变量
2. 命令行参数  
3. 配置文件参数
4. 默认值

实际应用：
动态设置会覆盖配置文件设置
重启后恢复为配置文件设置
```

---

## 7. ⚠️ 常见问题与解决方案


### 7.1 权限问题


**🔸 问题现象**
```sql
mysql> SET GLOBAL slow_query_log = ON;
ERROR 1227 (42000): Access denied; you need (at least one of) 
the SUPER privilege(s) for this operation
```

**🔸 解决方案**
```sql
-- 使用具有SUPER权限的用户登录
mysql -u root -p

-- 或者赋予用户SUPER权限
GRANT SUPER ON *.* TO 'username'@'host';
FLUSH PRIVILEGES;
```

### 7.2 日志文件路径问题


**🔸 问题现象**
```sql
mysql> SET GLOBAL slow_query_log_file = '/invalid/path/slow.log';
ERROR 29 (HY000): File '/invalid/path/slow.log' not found
```

**🔸 解决方案**
```bash
# 确保目录存在
sudo mkdir -p /var/log/mysql

# 确保MySQL用户有写入权限
sudo chown mysql:mysql /var/log/mysql
sudo chmod 755 /var/log/mysql

# 重新设置日志文件路径
mysql> SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
```

### 7.3 配置不生效问题


**🔸 问题排查步骤**
```sql
-- 1. 确认配置是否正确设置
SHOW VARIABLES LIKE 'slow_query%';

-- 2. 确认是否有权限问题
SHOW GRANTS FOR CURRENT_USER();

-- 3. 检查错误日志
-- 查看MySQL错误日志文件
```

**🔸 解决方案**
```sql
-- 重新设置配置
SET GLOBAL slow_query_log = OFF;
SET GLOBAL slow_query_log = ON;

-- 检查日志文件权限
-- 确保MySQL进程用户有读写权限
```

### 7.4 配置回滚方法


**🔸 动态配置回滚**
```sql
-- 关闭慢查询日志
SET GLOBAL slow_query_log = OFF;

-- 恢复默认时间阈值
SET GLOBAL long_query_time = 10;

-- 关闭索引相关记录
SET GLOBAL log_queries_not_using_indexes = OFF;
```

**🔸 静态配置回滚**
```bash
# 编辑配置文件，注释或删除相关配置
sudo vi /etc/mysql/my.cnf

# 重启MySQL服务
sudo systemctl restart mysql
```

---

## 8. 💡 最佳实践建议


### 8.1 生产环境配置建议


**🔸 推荐配置**
```ini
[mysqld]
# 启用慢查询日志
slow_query_log = ON

# 设置合理的时间阈值
long_query_time = 2

# 指定专门的日志目录
slow_query_log_file = /var/log/mysql/slow-query.log

# 谨慎启用索引记录（可能产生大量日志）
log_queries_not_using_indexes = OFF

# 如果启用索引记录，限制频率
log_throttle_queries_not_using_indexes = 10
```

### 8.2 日志管理建议


**🔸 日志轮转配置**
```bash
# 创建logrotate配置文件
sudo vi /etc/logrotate.d/mysql-slow

# 配置内容：
/var/log/mysql/slow-query.log {
    daily
    missingok
    rotate 7
    compress
    notifempty
    create 644 mysql mysql
    postrotate
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

### 8.3 监控建议


**🔸 定期检查**
```sql
-- 定期查看慢查询数量
SELECT 
    VARIABLE_VALUE as slow_queries 
FROM information_schema.GLOBAL_STATUS 
WHERE VARIABLE_NAME = 'Slow_queries';

-- 计算慢查询比例
-- 建议控制在1%以下
```

### 8.4 阈值设置建议


```
环境建议：

🎯 long_query_time 设置建议：
   - 在线服务：1-2秒
   - 报表系统：5-10秒  
   - 数据分析：10秒以上

🎯 监控频率建议：
   - 开发期：每天检查
   - 测试期：每周检查
   - 生产期：每月检查
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的关键概念


```
🔸 慢查询日志：记录执行时间超过阈值的SQL语句
🔸 动态配置：SET GLOBAL命令，立即生效，重启丢失  
🔸 静态配置：my.cnf文件，需重启，持久有效
🔸 long_query_time：慢查询时间阈值，单位秒
🔸 配置验证：SHOW VARIABLES命令查看当前配置
```

### 9.2 关键操作命令


**🔹 基础配置命令**
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = ON;

-- 设置时间阈值  
SET GLOBAL long_query_time = 2;

-- 查看当前配置
SHOW VARIABLES LIKE 'slow_query%';
```

**🔹 验证命令**
```sql
-- 查看慢查询统计
SHOW STATUS LIKE 'Slow_queries';

-- 查看配置是否生效
SHOW VARIABLES LIKE 'long_query_time';
```

### 9.3 配置选择策略


```
🎯 场景选择：

临时调试 → 动态配置
- 快速启用，立即生效
- 问题解决后可以关闭

生产环境 → 静态配置
- 持久化设置，重启不丢失
- 标准化运维管理

应急排查 → 动态配置
- 无需重启，快速响应
- 不影响服务可用性
```

### 9.4 实际应用价值


- **性能优化**：快速定位慢SQL，针对性优化
- **容量规划**：了解查询性能趋势，预估资源需求
- **故障排查**：性能问题出现时的重要排查工具
- **开发规范**：帮助开发人员写出高效的SQL语句

**💡 核心记忆**：
- 慢查询日志是数据库性能监控的第一步
- 动态配置用于临时调试，静态配置用于长期使用
- 合理设置时间阈值，平衡监控效果和系统开销
- 定期检查和分析慢查询日志，持续优化数据库性能