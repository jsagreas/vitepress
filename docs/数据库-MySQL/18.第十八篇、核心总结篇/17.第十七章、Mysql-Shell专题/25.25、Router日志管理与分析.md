---
title: 25、Router日志管理与分析
---
## 📚 目录

1. [MySQL Router日志系统概述](#1-MySQL-Router日志系统概述)
2. [日志配置与级别管理](#2-日志配置与级别管理)
3. [日志文件类型详解](#3-日志文件类型详解)
4. [日志轮转与存储策略](#4-日志轮转与存储策略)
5. [日志分析与监控](#5-日志分析与监控)
6. [故障诊断与性能分析](#6-故障诊断与性能分析)
7. [日志管理最佳实践](#7-日志管理最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 MySQL Router日志系统概述


### 1.1 什么是MySQL Router日志


**🔸 基本概念**
```
MySQL Router日志就像是餐厅的监控摄像头和记录本：
• 监控摄像头 → 实时记录所有活动（访问日志）
• 记录本 → 记录重要事件和问题（错误日志）
• 账本 → 记录性能数据（性能日志）

作用：帮助运维人员了解Router的运行状态和排查问题
```

**💡 日志系统的重要性**
- **故障排查**：当连接出问题时，通过日志找到根本原因
- **性能监控**：了解哪些查询慢，哪些连接多
- **安全审计**：记录谁在什么时候访问了什么
- **容量规划**：分析流量趋势，预测扩容需求

### 1.2 Router日志架构图

```
MySQL客户端请求流程与日志记录：

客户端应用           MySQL Router              后端MySQL实例
     |                    |                         |
     |--[1]连接请求------->|                         |
     |                    |--[记录访问日志]          |
     |                    |--[2]路由到后端---------->|
     |                    |                    [3]--| 返回结果
     |                    |<-[4]接收响应-------------|
     |<---[5]返回客户端----|                         |
     |                    |--[记录性能日志]          |

每个步骤都会产生相应的日志记录
```

### 1.3 日志记录的生命周期

```
日志生成 → 日志写入 → 日志轮转 → 日志分析 → 日志清理
    ↓         ↓         ↓         ↓         ↓
  实时产生   缓冲写入   定期切换   监控告警   自动删除
```

---

## 2. ⚙️ 日志配置与级别管理


### 2.1 日志级别详解


**🔸 MySQL Router的日志级别**
```
从详细到简略的日志级别：

🔴 FATAL   (致命)：系统崩溃级别的错误
🟠 ERROR   (错误)：需要立即处理的问题  
🟡 WARNING (警告)：需要关注但不影响运行
🔵 INFO    (信息)：一般的运行信息
🟢 DEBUG   (调试)：详细的调试信息
⚪ TRACE   (跟踪)：最详细的跟踪信息
```

**💡 什么时候用哪个级别**
```
生产环境推荐：INFO 或 WARNING
• 记录重要事件，不会产生太多日志
• 便于发现问题，不影响性能

开发环境推荐：DEBUG
• 详细记录所有操作
• 便于排查开发过程中的问题

故障排查时：DEBUG 或 TRACE
• 临时开启详细日志
• 排查完问题后调回INFO级别
```

### 2.2 日志配置方法


#### 🔧 配置文件方式

```ini
# mysqlrouter.conf 配置示例
[DEFAULT]
# 全局日志级别设置
logging_folder = /var/log/mysqlrouter
log_level = INFO

[logger]
# 详细的日志配置
level = INFO
# 日志输出到文件
sinks = filelog
# 时间戳格式
timestamp_precision = second

[filelog]
# 文件日志配置
filename = mysqlrouter.log
# 日志轮转大小 (50MB)
max_size = 52428800
# 保留文件数量
max_files = 10
```

**🔸 配置说明**
- `logging_folder`：日志文件存放目录
- `log_level`：全局日志级别
- `max_size`：单个日志文件最大大小
- `max_files`：保留的日志文件数量

#### 🔧 命令行方式

```bash
# 启动时指定日志级别
mysqlrouter --log-level=DEBUG

# 指定日志输出文件
mysqlrouter --log-file=/var/log/mysqlrouter/router.log

# 同时指定多个日志选项
mysqlrouter \
  --log-level=INFO \
  --log-file=/var/log/mysqlrouter/router.log \
  --config-file=/etc/mysqlrouter/mysqlrouter.conf
```

### 2.3 动态日志级别调整


**🔸 运行时调整日志级别**
```bash
# 通过REST API调整日志级别（如果启用了管理端口）
curl -X PATCH http://localhost:8443/api/20190715/config/logging \
  -H "Content-Type: application/json" \
  -d '{"level": "DEBUG"}'

# 查看当前日志配置
curl http://localhost:8443/api/20190715/config/logging
```

> ⚠️ **注意**：动态调整只在当前运行期间有效，重启后会恢复配置文件设置

---

## 3. 📋 日志文件类型详解


### 3.1 主日志文件（mysqlrouter.log）


**🔸 主要记录内容**
```
启动/关闭事件：
2024-09-11 14:30:15 INFO  [7f8b8c001700] MySQL Router starting
2024-09-11 14:30:15 INFO  [7f8b8c001700] Configuration read from: /etc/mysqlrouter/mysqlrouter.conf
2024-09-11 14:30:16 INFO  [7f8b8c001700] Listening on 0.0.0.0:6446 for MySQL connections

连接事件：
2024-09-11 14:35:22 INFO  [7f8b88003700] New connection from 192.168.1.100:45678
2024-09-11 14:35:22 DEBUG [7f8b88003700] Routing to backend server 192.168.1.10:3306

错误事件：
2024-09-11 14:40:15 ERROR [7f8b88003700] Backend server 192.168.1.10:3306 is unreachable
2024-09-11 14:40:15 WARNING [7f8b88003700] Trying next available backend server
```

**💡 日志格式解读**
```
[时间戳] [级别] [线程ID] 具体消息内容

时间戳：事件发生的准确时间
级别：日志的重要程度
线程ID：处理该事件的线程标识
消息：具体的事件描述
```

### 3.2 访问日志（Access Log）


**🔸 记录客户端访问信息**
```bash
# 启用访问日志配置
[routing:primary]
bind_address = 0.0.0.0
bind_port = 6446
destinations = 192.168.1.10:3306,192.168.1.11:3306
routing_strategy = first-available
# 启用访问日志
access_log = /var/log/mysqlrouter/access.log
```

**🔸 访问日志内容示例**
```
2024-09-11 14:35:22.123 192.168.1.100:45678 -> 192.168.1.10:3306 CONNECT 0ms
2024-09-11 14:35:22.125 192.168.1.100:45678 -> 192.168.1.10:3306 QUERY 15ms "SELECT * FROM users"
2024-09-11 14:35:22.140 192.168.1.100:45678 -> 192.168.1.10:3306 QUERY 3ms "COMMIT"
2024-09-11 14:35:25.200 192.168.1.100:45678 -> 192.168.1.10:3306 DISCONNECT 0ms
```

**💡 访问日志字段说明**
- **时间戳**：请求发生时间（精确到毫秒）
- **客户端地址**：发起请求的客户端IP和端口
- **后端地址**：Router路由到的MySQL实例
- **操作类型**：CONNECT、QUERY、DISCONNECT等
- **耗时**：操作执行时间
- **SQL语句**：执行的具体SQL（可选）

### 3.3 错误日志专项分析


**🔸 常见错误类型及含义**
```
连接错误：
ERROR: Can't connect to MySQL server on '192.168.1.10:3306'
→ 含义：后端MySQL服务器无法连接
→ 解决：检查MySQL服务状态和网络连通性

路由错误：
ERROR: No available backends for routing
→ 含义：所有后端服务器都不可用
→ 解决：检查后端服务器状态，确认配置正确

认证错误：
ERROR: Access denied for user 'router'@'%'
→ 含义：Router连接MySQL的用户权限不足
→ 解决：检查MySQL用户权限设置
```

---

## 4. 🔄 日志轮转与存储策略


### 4.1 日志轮转机制


**🔸 什么是日志轮转**
```
就像日记本写满了要换新本子一样：

旧方式（无轮转）：
mysqlrouter.log → 越来越大 → 最终撑爆磁盘

新方式（有轮转）：
mysqlrouter.log     ← 当前日志（50MB）
mysqlrouter.log.1   ← 上一个日志文件
mysqlrouter.log.2   ← 更早的日志文件
...
mysqlrouter.log.10  ← 最老的日志文件（会被删除）
```

### 4.2 配置日志轮转


**🔧 内置轮转配置**
```ini
[filelog]
filename = mysqlrouter.log
# 单个文件最大50MB
max_size = 52428800
# 保留最近10个文件
max_files = 10
# 轮转触发条件
rotate_on_size = true
```

**🔧 系统级轮转（推荐）**
```bash
# /etc/logrotate.d/mysqlrouter
/var/log/mysqlrouter/*.log {
    daily                    # 每天轮转
    rotate 30               # 保留30天
    compress                # 压缩旧文件
    delaycompress          # 延迟一天压缩
    missingok              # 文件缺失不报错
    notifempty             # 空文件不轮转
    postrotate
        # 轮转后重新打开日志文件
        /bin/kill -USR1 `cat /var/run/mysqlrouter.pid` 2>/dev/null || true
    endscript
}
```

### 4.3 存储策略设计


**📊 存储策略对比表**

| 策略类型 | **保留时间** | **文件大小** | **压缩** | **适用场景** |
|---------|-------------|-------------|---------|-------------|
| **开发环境** | `7天` | `10MB` | `否` | `开发调试` |
| **测试环境** | `15天` | `50MB` | `是` | `功能测试` |
| **生产环境** | `30-90天` | `100MB` | `是` | `生产运维` |
| **合规要求** | `1年+` | `不限` | `是` | `审计合规` |

**💡 存储空间计算**
```
日志大小估算公式：
每日日志大小 = 连接数 × 平均连接时长 × 日志详细程度

示例：
• 1000个连接/天
• 平均连接时长5分钟
• INFO级别日志
• 预估每日日志：约100MB

存储空间需求 = 每日日志大小 × 保留天数 × 压缩比
= 100MB × 30天 × 0.3 = 900MB
```

---

## 5. 📊 日志分析与监控


### 5.1 基础日志分析命令


**🔍 常用日志查看命令**
```bash
# 查看最新日志
tail -f /var/log/mysqlrouter/mysqlrouter.log

# 查看错误日志
grep -i error /var/log/mysqlrouter/mysqlrouter.log

# 统计连接数
grep "New connection" /var/log/mysqlrouter/mysqlrouter.log | wc -l

# 查看特定时间段的日志
sed -n '/2024-09-11 14:30/,/2024-09-11 15:00/p' mysqlrouter.log

# 分析慢查询（如果记录了执行时间）
awk '$NF ~ /[0-9]+ms/ && $NF+0 > 1000 {print}' access.log
```

### 5.2 日志分析脚本


**🔧 自动化分析脚本示例**
```bash
#!/bin/bash
# mysql_router_log_analyzer.sh

LOG_FILE="/var/log/mysqlrouter/mysqlrouter.log"
REPORT_FILE="/tmp/router_report_$(date +%Y%m%d).txt"

echo "MySQL Router 日志分析报告 - $(date)" > $REPORT_FILE
echo "===========================================" >> $REPORT_FILE

# 连接统计
echo "今日连接统计：" >> $REPORT_FILE
grep "$(date +%Y-%m-%d)" $LOG_FILE | grep "New connection" | wc -l >> $REPORT_FILE

# 错误统计
echo "错误数量统计：" >> $REPORT_FILE
grep "$(date +%Y-%m-%d)" $LOG_FILE | grep -c "ERROR" >> $REPORT_FILE

# 后端服务器状态
echo "后端服务器连接失败：" >> $REPORT_FILE
grep "$(date +%Y-%m-%d)" $LOG_FILE | grep "unreachable" | \
  awk '{print $NF}' | sort | uniq -c >> $REPORT_FILE

# 发送报告（可选）
# mail -s "MySQL Router日志报告" admin@company.com < $REPORT_FILE
```

### 5.3 实时监控设置


**🔧 使用tail和grep的实时监控**
```bash
# 监控错误日志
tail -f /var/log/mysqlrouter/mysqlrouter.log | grep --color=always "ERROR\|WARNING"

# 监控连接活动
tail -f /var/log/mysqlrouter/mysqlrouter.log | grep --color=always "connection"

# 监控特定后端服务器
tail -f /var/log/mysqlrouter/mysqlrouter.log | grep "192.168.1.10:3306"
```

**🔧 使用journalctl监控（如果使用systemd）**
```bash
# 实时查看Router日志
journalctl -u mysqlrouter -f

# 查看最近的错误
journalctl -u mysqlrouter -p err -n 50

# 按时间范围查看
journalctl -u mysqlrouter --since "2024-09-11 14:00" --until "2024-09-11 15:00"
```

---

## 6. 🔧 故障诊断与性能分析


### 6.1 常见故障的日志特征


**🚨 连接故障诊断**
```
故障现象：客户端连接不上Router
日志特征：
ERROR: bind: Address already in use
→ 解决：端口被占用，检查端口冲突

ERROR: Can't connect to MySQL server
→ 解决：后端MySQL服务不可用

WARNING: No available backends
→ 解决：所有后端服务器都下线
```

**🚨 性能问题诊断**
```
故障现象：查询响应慢
日志分析：
1. 查看访问日志中的查询时间
   grep "QUERY.*[0-9][0-9][0-9]ms" access.log

2. 统计慢查询数量
   awk '$NF+0 > 1000 {count++} END {print "慢查询数量:", count}' access.log

3. 找出最慢的查询
   awk '$NF+0 > 0 {print $NF, $0}' access.log | sort -n | tail -10
```

### 6.2 性能指标提取


**📈 关键性能指标**
```bash
# 每小时连接数统计
awk '($1 ~ /2024-09-11/ && $2 ~ /1[4-5]:/) && /New connection/ {
    hour = substr($2, 1, 2)
    count[hour]++
} END {
    for (h in count) print "小时 " h ":00 - 连接数:", count[h]
}' mysqlrouter.log

# 后端服务器负载分布
grep "Routing to backend" mysqlrouter.log | \
awk '{print $NF}' | sort | uniq -c | sort -nr

# 连接持续时间分析
awk '/New connection/ {
    conn_time[$NF] = $1 " " $2
} /DISCONNECT/ {
    if ($NF in conn_time) {
        # 简化的时间差计算
        print "连接时长分析需要更复杂的脚本"
    }
}' access.log
```

### 6.3 告警配置


**🔔 基于日志的告警脚本**
```bash
#!/bin/bash
# router_alert.sh - 日志告警脚本

LOG_FILE="/var/log/mysqlrouter/mysqlrouter.log"
ALERT_THRESHOLD=10  # 10分钟内错误数量阈值
CHECK_PERIOD=600    # 检查周期（秒）

# 获取最近10分钟的错误数量
error_count=$(grep "$(date -d '10 minutes ago' '+%Y-%m-%d %H:%M')" $LOG_FILE | grep -c "ERROR")

if [ $error_count -gt $ALERT_THRESHOLD ]; then
    # 发送告警（可以是邮件、短信、API调用等）
    echo "告警：MySQL Router在过去10分钟内出现 $error_count 个错误" | \
    mail -s "MySQL Router告警" admin@company.com
    
    # 记录告警日志
    echo "$(date): 告警触发，错误数量: $error_count" >> /var/log/router_alerts.log
fi
```

---

## 7. 🛠️ 日志管理最佳实践


### 7.1 生产环境配置建议


**🔸 推荐配置模板**
```ini
[DEFAULT]
logging_folder = /var/log/mysqlrouter
log_level = INFO

[logger]
level = INFO
sinks = filelog,syslog
timestamp_precision = microsecond

[filelog]
filename = mysqlrouter.log
max_size = 104857600    # 100MB
max_files = 20          # 保留20个文件
rotate_on_size = true

[syslog]
facility = daemon
tag = mysqlrouter
```

**💡 配置要点说明**
- **日志级别INFO**：平衡详细程度和性能
- **文件大小100MB**：避免单文件过大
- **保留20个文件**：约2GB存储空间
- **同时输出到syslog**：便于集中式日志管理

### 7.2 日志安全与权限


**🔒 文件权限设置**
```bash
# 创建日志目录和设置权限
sudo mkdir -p /var/log/mysqlrouter
sudo chown mysqlrouter:mysqlrouter /var/log/mysqlrouter
sudo chmod 750 /var/log/mysqlrouter

# 日志文件权限
sudo chmod 640 /var/log/mysqlrouter/*.log
```

**🔒 敏感信息处理**
```ini
# 避免记录敏感SQL语句
[routing:primary]
# 不要启用详细的SQL日志记录
# access_log_format = 不包含具体SQL内容的格式
```

> ⚠️ **安全提醒**：日志文件可能包含敏感信息，确保访问权限严格控制

### 7.3 集中式日志管理


**🔧 集成ELK Stack示例**
```bash
# Filebeat配置片段
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/mysqlrouter/*.log
  fields:
    service: mysqlrouter
    environment: production
  fields_under_root: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "mysqlrouter-logs-%{+yyyy.MM.dd}"
```

**🔧 集成Prometheus监控**
```bash
# 使用mtail导出日志指标
mtail --progs /etc/mtail/mysqlrouter.mtail \
     --logs /var/log/mysqlrouter/mysqlrouter.log \
     --port 3903
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 日志类型：主日志、访问日志、错误日志各有不同用途
🔸 日志级别：FATAL > ERROR > WARNING > INFO > DEBUG > TRACE
🔸 轮转机制：防止日志文件过大，保持系统稳定
🔸 分析方法：grep、awk、tail等命令组合使用
🔸 监控告警：主动发现问题，及时响应故障
```

### 8.2 关键理解要点


**🔹 日志配置的平衡艺术**
```
详细度 vs 性能：
• DEBUG级别：信息详细但影响性能
• INFO级别：平衡点，推荐生产环境使用
• WARNING级别：只记录问题，信息可能不足

存储 vs 成本：
• 保留时间长：便于历史分析，但占用存储
• 保留时间短：节省空间，但可能丢失重要信息
```

**🔹 故障诊断的思路**
```
问题定位流程：
1. 查看错误日志 → 找到具体错误信息
2. 分析时间关联 → 确定问题发生时间点
3. 检查访问日志 → 了解当时的连接情况
4. 对比历史数据 → 判断是偶发还是持续问题
```

### 8.3 实际应用价值


**🎯 运维场景应用**
- **日常监控**：通过日志了解系统运行状态
- **故障排查**：快速定位问题根本原因
- **性能优化**：分析慢查询和连接模式
- **容量规划**：基于历史数据预测资源需求
- **安全审计**：记录和分析访问行为

**🔧 实践技能要求**
- 熟练使用Linux日志分析命令
- 能够编写简单的日志分析脚本
- 理解日志轮转和存储策略
- 掌握基本的监控和告警配置

**✅ 学习检查清单**
- [ ] 能够配置不同级别的日志输出
- [ ] 会设置日志轮转和存储策略
- [ ] 能从日志中快速定位连接问题
- [ ] 会分析访问日志中的性能数据
- [ ] 掌握基本的日志监控方法

**🎯 一句话精华**：
日志是MySQL Router的"黑匣子"，记录了所有重要事件，是运维人员排查问题和优化性能的重要工具。

**🧠 记忆要点**：
- 配置要适度：INFO级别平衡性能和信息量
- 轮转要及时：避免日志文件过大影响系统
- 分析要系统：结合时间、错误、性能多维度分析
- 监控要主动：设置告警及时发现问题