---
title: 26、集群升级与维护操作
---
## 📚 目录

1. [MySQL集群升级基础概念](#1-MySQL集群升级基础概念)
2. [滚动升级策略详解](#2-滚动升级策略详解)
3. [升级前的准备工作](#3-升级前的准备工作)
4. [实例逐个升级流程](#4-实例逐个升级流程)
5. [升级验证与回滚](#5-升级验证与回滚)
6. [维护窗口规划](#6-维护窗口规划)
7. [升级最佳实践](#7-升级最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 MySQL集群升级基础概念


### 1.1 什么是MySQL集群升级


**简单理解**：就像给手机系统升级一样，MySQL集群升级就是把数据库从老版本更新到新版本。

```
生活中的类比：
手机升级：iOS 15 → iOS 16
MySQL升级：MySQL 8.0.25 → MySQL 8.0.35

共同特点：
- 保留原有数据和设置
- 获得新功能和性能提升
- 修复已知问题和安全漏洞
```

### 1.2 为什么要升级MySQL集群


**🔸 主要原因**
```
性能提升：
- 查询速度更快
- 内存使用更合理
- 网络传输更高效

安全加强：
- 修复安全漏洞
- 增强数据保护
- 改进权限控制

功能增加：
- 新的SQL语法支持
- 更好的监控工具
- 改进的备份恢复
```

> 💡 **通俗解释**：就像汽车定期保养一样，数据库也需要定期升级来保持最佳状态

### 1.3 MySQL集群的特殊性


**🔸 为什么集群升级比单机复杂**
```
单机升级：关闭→升级→启动
集群升级：要保证服务不中断

挑战：
┌─────────────────────────────────┐
│ 集群升级的复杂性                │
├─────────────────────────────────┤
│ • 多个节点要协调升级            │
│ • 数据同步要保持正常            │
│ • 客户端连接不能断开            │
│ • 版本兼容性要考虑              │
└─────────────────────────────────┘
```

**🔸 集群角色说明**
```
MySQL InnoDB Cluster架构：
        
    MySQL Router
         |
    ┌────┴────┐
    |         |
Primary    Secondary
Master      Slave1, Slave2...

角色说明：
• Primary：主节点，处理写操作
• Secondary：从节点，处理读操作  
• Router：路由器，分发请求
```

---

## 2. 🔄 滚动升级策略详解


### 2.1 什么是滚动升级


**🔸 核心思想**
```
传统升级：全部停机 → 升级 → 全部启动
滚动升级：逐个升级 → 保持服务运行

就像修路一样：
传统方式：整条路封闭修完再通车
滚动方式：修一段通一段，始终有路可走
```

### 2.2 滚动升级的优势


**📊 对比分析**
```
╔══════════════╦══════════════╦══════════════╗
║   升级方式   ║   服务中断   ║   风险程度   ║
╠══════════════╬══════════════╬══════════════╣
║ 停机升级     ║   完全中断   ║     较低     ║
║ 滚动升级     ║   几乎无中断 ║     可控     ║
╚══════════════╩══════════════╩══════════════╝
```

> 🚀 **核心优势**：用户感觉不到数据库在升级，业务照常运行

### 2.3 滚动升级的基本流程


**🔸 升级顺序图**
```
升级阶段时间线：

时刻1: [Primary] [Secondary1] [Secondary2] ← 初始状态
         ↓
时刻2: [Primary] [Secondary1] [升级中...] ← 升级Secondary2
         ↓  
时刻3: [Primary] [升级中...] [Secondary2] ← 升级Secondary1
         ↓
时刻4: [升级中] [Secondary1] [Secondary2] ← 升级Primary
         ↓
时刻5: [Primary] [Secondary1] [Secondary2] ← 完成升级
```

**🔸 关键原则**
```
升级顺序：
1️⃣ 先升级从节点（Secondary）
2️⃣ 最后升级主节点（Primary）
3️⃣ 确保始终有节点在线服务

为什么这样做：
• 从节点升级失败影响相对较小
• 主节点最重要，最后升级最安全
• 可以随时回退到稳定状态
```

---

## 3. 🔍 升级前的准备工作


### 3.1 升级前检查清单


**📋 必做检查项目**
```
系统健康检查：
- [ ] 所有节点状态正常
- [ ] 数据同步无延迟
- [ ] 磁盘空间充足(至少剩余30%)
- [ ] 内存使用正常
- [ ] 网络连接稳定

数据安全检查：
- [ ] 完整备份已完成
- [ ] 备份可用性已验证
- [ ] 重要配置已保存
- [ ] 用户权限已记录
```

> ⚠️ **重要提醒**：升级前的备份就像买保险，虽然希望用不到，但必须要有

### 3.2 兼容性检查


**🔸 版本兼容性规则**
```
MySQL版本升级路径：

安全升级：
8.0.25 → 8.0.35 ✅ (小版本升级)
8.0.x  → 8.1.x  ✅ (次版本升级)

需要注意：
5.7.x  → 8.0.x  ⚠️ (主版本升级，需特殊处理)
8.0.x  → 5.7.x  ❌ (不支持降级)
```

**🔸 配置兼容性检查**
```bash
# 检查当前配置是否兼容新版本
mysqlsh --uri root@localhost -e "
  SELECT $$version;
  SHOW VARIABLES LIKE 'innodb%';
  SELECT * FROM performance_schema.replication_group_members;
"
```

### 3.3 数据迁移考虑


**🔸 需要考虑的数据问题**
```
数据格式变化：
┌─────────────────────────────────┐
│ 版本升级可能影响的数据格式      │
├─────────────────────────────────┤
│ • 字符集和排序规则              │
│ • 数据类型的精度                │
│ • 索引结构的变化                │
│ • 存储引擎的改进                │
└─────────────────────────────────┘
```

**🔸 预处理数据**
```sql
-- 检查可能有问题的数据
SELECT table_schema, table_name, engine 
FROM information_schema.tables 
WHERE engine != 'InnoDB';

-- 检查字符集兼容性
SELECT DISTINCT character_set_name 
FROM information_schema.columns;
```

---

## 4. ⚙️ 实例逐个升级流程


### 4.1 升级从节点（Secondary）


**🔸 详细步骤流程**
```
步骤1: 准备升级节点
┌──────────────────────────────┐
│ 1. 确认节点角色和状态         │
│ 2. 停止应用写入该节点         │
│ 3. 等待数据同步完成           │
│ 4. 记录当前配置               │
└──────────────────────────────┘
         ↓
步骤2: 执行升级
┌──────────────────────────────┐
│ 1. 停止MySQL服务              │
│ 2. 备份数据目录               │
│ 3. 安装新版本软件             │
│ 4. 启动MySQL服务              │
└──────────────────────────────┘
         ↓
步骤3: 验证升级
┌──────────────────────────────┐
│ 1. 检查服务状态               │
│ 2. 验证数据完整性             │
│ 3. 测试连接和查询             │
│ 4. 确认集群同步正常           │
└──────────────────────────────┘
```

**🔸 实际操作命令**
```bash
# 1. 检查节点状态
mysqlsh --uri root@secondary1:3306 -e "
  SELECT member_role, member_state 
  FROM performance_schema.replication_group_members;
"

# 2. 优雅停止服务
sudo systemctl stop mysql

# 3. 升级软件包(Ubuntu/Debian)
sudo apt update
sudo apt install mysql-server=8.0.35-*

# 4. 启动并检查
sudo systemctl start mysql
mysql -u root -p -e "SELECT $$version;"
```

### 4.2 升级主节点（Primary）


**🔸 主节点升级的特殊考虑**
```
主节点升级前：
┌─────────────────────────────────┐
│ 特殊准备工作                    │
├─────────────────────────────────┤
│ • 确保所有从节点已升级完成      │
│ • 检查是否可以进行主从切换      │
│ • 通知业务方可能的短暂影响      │
│ • 准备应急回滚方案              │
└─────────────────────────────────┘
```

**🔸 主从切换操作**
```javascript
// 使用MySQL Shell进行主从切换
var cluster = dba.getCluster('myCluster');

// 查看当前主节点
cluster.status();

// 切换主节点到已升级的从节点
cluster.setPrimaryInstance('secondary1:3306');

// 验证切换结果
cluster.status();
```

> 💡 **关键理解**：主从切换就像换班，让升级好的节点当班长，原来的班长去升级

### 4.3 Router升级


**🔸 MySQL Router升级流程**
```
Router升级策略：
        
客户端应用
    ↓
┌─────────┐    ┌─────────┐
│ Router1 │ ←→ │ Router2 │  (负载均衡)
└─────────┘    └─────────┘
    ↓              ↓
   MySQL集群

升级方法：
1. 先升级Router2，测试无问题
2. 切换流量到Router2
3. 升级Router1
4. 恢复双Router负载均衡
```

---

## 5. ✅ 升级验证与回滚


### 5.1 升级验证步骤


**🔸 全面验证清单**
```
基础功能验证：
- [ ] 所有节点版本一致
- [ ] 集群状态健康
- [ ] 数据同步正常
- [ ] 连接池工作正常

业务功能验证：
- [ ] 读写操作正常
- [ ] 查询性能无异常
- [ ] 事务处理正确
- [ ] 备份恢复可用

性能验证：
- [ ] 响应时间在预期范围
- [ ] 吞吐量无明显下降
- [ ] 资源使用合理
- [ ] 监控指标正常
```

**🔸 验证脚本示例**
```bash
#!/bin/bash
# MySQL集群升级验证脚本

echo "=== 开始升级验证 ==="

# 检查版本一致性
echo "检查版本..."
for host in primary secondary1 secondary2; do
    version=$(mysql -h $host -u root -p${MYSQL_PASSWORD} -e "SELECT $$version;" -s)
    echo "$host: $version"
done

# 检查集群状态
echo "检查集群状态..."
mysqlsh --uri root@primary:3306 -e "
  var cluster = dba.getCluster('myCluster');
  cluster.status();
"

# 测试读写操作
echo "测试读写操作..."
mysql -h primary -u testuser -p${TEST_PASSWORD} -e "
  CREATE DATABASE IF NOT EXISTS upgrade_test;
  USE upgrade_test;
  CREATE TABLE test_table (id INT, data VARCHAR(100));
  INSERT INTO test_table VALUES (1, 'upgrade test');
  SELECT * FROM test_table;
  DROP DATABASE upgrade_test;
"

echo "=== 验证完成 ==="
```

### 5.2 升级回滚方案


**🔸 什么时候需要回滚**
```
需要回滚的情况：
⚠️ 数据损坏或丢失
⚠️ 性能严重下降(>50%)
⚠️ 关键功能无法使用
⚠️ 集群同步失败
⚠️ 应用程序报错
```

**🔸 回滚操作流程**
```
回滚步骤：

紧急回滚（数据损坏）：
1️⃣ 立即停止所有节点
2️⃣ 从备份恢复数据
3️⃣ 重新搭建集群
4️⃣ 验证数据完整性

优雅回滚（功能问题）：
1️⃣ 逐个降级节点
2️⃣ 恢复原配置文件
3️⃣ 重启服务
4️⃣ 验证功能正常
```

> ⚠️ **重要警告**：MySQL通常不支持版本降级，回滚主要依靠数据备份恢复

---

## 6. 📅 维护窗口规划


### 6.1 业务影响评估


**🔸 影响分析表**
```
╔══════════════╦══════════════╦══════════════╦══════════════╗
║   升级阶段   ║   预计时间   ║   业务影响   ║   风险等级   ║
╠══════════════╬══════════════╬══════════════╬══════════════╣
║ 从节点升级   ║   30分钟     ║   读性能下降 ║     低       ║
║ 主从切换     ║   5分钟      ║   短暂中断   ║     中       ║
║ 主节点升级   ║   30分钟     ║   写不可用   ║     高       ║
║ 验证测试     ║   20分钟     ║   性能监控   ║     低       ║
╚══════════════╩══════════════╩══════════════╩══════════════╝
```

### 6.2 维护窗口选择


**🔸 最佳实践建议**
```
时间选择原则：
┌─────────────────────────────────┐
│ 理想的维护窗口时间              │
├─────────────────────────────────┤
│ • 业务访问量最低的时段          │
│ • 开发团队在线的时间            │
│ • 运维团队精力充沛的时候        │
│ • 避开重要业务期间              │
└─────────────────────────────────┘

常见选择：
🌙 凌晨2-6点：用户访问量最低
🎯 周二-周四：避开周末和周一
📊 非月末季末：避开财务高峰期
```

### 6.3 沟通协调计划


**🔸 沟通时间表**
```
升级前1周：
┌─────────────────────────────────┐
│ • 发布升级通知                  │
│ • 与业务方确认维护窗口          │
│ • 准备详细的升级计划            │
│ • 组织升级预演                  │
└─────────────────────────────────┘

升级前1天：
┌─────────────────────────────────┐
│ • 再次确认升级计划              │
│ • 检查备份和准备工作            │
│ • 通知相关人员待命              │
│ • 准备应急联系方式              │
└─────────────────────────────────┘

升级完成后：
┌─────────────────────────────────┐
│ • 发布升级完成通知              │
│ • 总结升级过程和经验            │
│ • 更新文档和操作手册            │
│ • 安排后续监控观察              │
└─────────────────────────────────┘
```

---

## 7. 🎯 升级最佳实践


### 7.1 测试环境先行


**🔸 测试环境的重要性**
```
为什么要先在测试环境升级：

发现问题：
• 兼容性问题      • 性能问题
• 配置问题        • 数据问题

验证方案：
• 升级流程        • 回滚方案
• 时间估算        • 风险评估

积累经验：
• 操作熟练度      • 问题处理
• 文档完善        • 团队配合
```

> 💡 **经验分享**：测试环境升级就像彩排，让你在正式演出前发现所有问题

### 7.2 分批升级策略


**🔸 大规模集群的分批方案**
```
集群规模：Primary(1) + Secondary(6)

分批策略：
第一批：升级2个Secondary
         ↓ (观察24小时)
第二批：升级2个Secondary  
         ↓ (观察24小时)
第三批：升级2个Secondary
         ↓ (观察24小时)  
第四批：升级Primary
```

### 7.3 监控和报警


**🔸 升级过程监控要点**
```
实时监控指标：
┌─────────────────────────────────┐
│ 性能指标                        │
├─────────────────────────────────┤
│ • 查询响应时间                  │
│ • 连接数和活跃会话              │
│ • CPU和内存使用率               │
│ • 磁盘IO和网络IO                │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 功能指标                        │
├─────────────────────────────────┤
│ • 主从同步延迟                  │
│ • 错误日志异常                  │
│ • 集群成员状态                  │
│ • 应用连接成功率                │
└─────────────────────────────────┘
```

### 7.4 文档记录规范


**🔸 升级文档模板**
```
升级记录文档包含：

基本信息：
- 升级时间：2024-XX-XX XX:XX
- 操作人员：张三、李四
- 版本变化：8.0.28 → 8.0.35
- 集群规模：1主3从

操作记录：
- 详细的操作步骤
- 遇到的问题及解决方案  
- 关键命令和输出结果
- 时间节点记录

验证结果：
- 功能验证结果
- 性能对比数据
- 监控截图
- 用户反馈

经验总结：
- 成功的做法
- 需要改进的地方
- 下次升级的建议
- 风险点提示
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 滚动升级：逐个升级节点，保持服务连续性
🔸 升级顺序：先从节点，后主节点，最后Router
🔸 兼容性检查：版本兼容、配置兼容、数据兼容
🔸 验证机制：功能验证、性能验证、业务验证  
🔸 回滚方案：数据备份是回滚的基础保障
🔸 维护窗口：选择业务影响最小的时间段
```

### 8.2 关键理解要点


**🔹 为什么滚动升级是最佳选择**
```
连续服务：
• 用户感受不到中断
• 业务正常运行
• 收入损失最小

风险控制：
• 出问题影响范围小
• 可以随时停止升级
• 有充足时间排查问题

操作灵活：
• 可以调整升级节奏
• 可以根据情况优化流程
• 积累经验逐步改进
```

**🔹 备份的重要性**
```
升级前备份就像：
• 手术前的准备工作
• 出门前的保险
• 考试前的复习

作用：
• 数据安全保障
• 回滚操作基础  
• 心理安全感
• 业务连续性保证
```

**🔹 测试环境的价值**
```
测试环境 = 免费的试错机会

价值体现：
• 发现潜在问题
• 验证操作流程
• 评估时间成本
• 训练操作人员
• 完善文档资料
```

### 8.3 实际应用指导


**🎯 升级决策流程**
```
是否需要升级？
   ↓
安全漏洞 → 必须升级
性能问题 → 评估收益
新功能需求 → 权衡风险
   ↓
制定升级计划
   ↓
测试环境验证  
   ↓
生产环境执行
```

**🎯 风险控制原则**
```
预防为主：
• 充分的准备工作
• 详细的升级计划
• 完整的备份策略

快速响应：
• 实时监控告警
• 明确的回滚触发条件
• 快速的问题处理流程

持续改进：
• 升级后的总结分析
• 流程的持续优化
• 经验的积累传承
```

### 8.4 常见问题与解决


**🔹 升级失败常见原因**
```
配置问题：
• 新版本不兼容的配置参数
• 权限设置不正确
• 网络配置变化

数据问题：
• 字符集不兼容
• 数据类型变化
• 索引结构调整

环境问题：
• 磁盘空间不足
• 内存不够
• 依赖软件版本冲突
```

**🔹 应急处理原则**
```
快速判断：
• 问题严重程度
• 影响范围大小
• 解决难度评估

果断决策：
• 继续排查解决
• 立即回滚操作
• 寻求外部支持

及时沟通：
• 向上级汇报
• 通知业务方
• 协调资源支持
```

**核心记忆口诀**：
- 升级如搬家，准备要充分
- 滚动保服务，先从后主心
- 备份是保险，测试是预演  
- 监控要实时，文档要详细
- 风险早识别，问题快处理