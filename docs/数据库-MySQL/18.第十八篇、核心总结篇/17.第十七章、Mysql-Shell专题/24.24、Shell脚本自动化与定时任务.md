---
title: 24ã€Shellè„šæœ¬è‡ªåŠ¨åŒ–ä¸å®šæ—¶ä»»åŠ¡
---
## ğŸ“š ç›®å½•

1. [MySQL Shellè‡ªåŠ¨åŒ–åŸºç¡€](#1-MySQL-Shellè‡ªåŠ¨åŒ–åŸºç¡€)
2. [Shellè„šæœ¬ç¼–å†™æ ¸å¿ƒæŠ€å·§](#2-Shellè„šæœ¬ç¼–å†™æ ¸å¿ƒæŠ€å·§)
3. [æ‰¹å¤„ç†æ¨¡å¼æ‰§è¡Œ](#3-æ‰¹å¤„ç†æ¨¡å¼æ‰§è¡Œ)
4. [å®šæ—¶ä»»åŠ¡é…ç½®ä¸ç®¡ç†](#4-å®šæ—¶ä»»åŠ¡é…ç½®ä¸ç®¡ç†)
5. [è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬](#5-è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬)
6. [å¤‡ä»½è„šæœ¬å¼€å‘](#6-å¤‡ä»½è„šæœ¬å¼€å‘)
7. [é”™è¯¯é€šçŸ¥æœºåˆ¶](#7-é”™è¯¯é€šçŸ¥æœºåˆ¶)
8. [æ—¥å¿—è½®è½¬ç®¡ç†](#8-æ—¥å¿—è½®è½¬ç®¡ç†)
9. [æ€§èƒ½æ•°æ®æ”¶é›†](#9-æ€§èƒ½æ•°æ®æ”¶é›†)
10. [è¿ç»´å·¥å…·é›†æˆ](#10-è¿ç»´å·¥å…·é›†æˆ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ MySQL Shellè‡ªåŠ¨åŒ–åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯MySQL Shellè‡ªåŠ¨åŒ–


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
MySQL Shellè‡ªåŠ¨åŒ–ï¼šé€šè¿‡è„šæœ¬å’Œå®šæ—¶ä»»åŠ¡å®ç°æ•°æ®åº“è¿ç»´çš„è‡ªåŠ¨åŒ–ç®¡ç†
æœ¬è´¨ï¼šå°†é‡å¤æ€§çš„æ•°æ®åº“æ“ä½œç¼–å†™æˆè„šæœ¬ï¼Œå®šæ—¶æ‰§è¡Œæˆ–è§¦å‘æ‰§è¡Œ
ç›®æ ‡ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜è¿ç»´æ•ˆç‡ï¼Œé™ä½æ“ä½œé£é™©
```

**ğŸ’¡ è‡ªåŠ¨åŒ–çš„ä»·å€¼**
```
ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–ï¼Ÿ
1. é‡å¤æ€§å·¥ä½œï¼šæ¯å¤©çš„å¤‡ä»½ã€ç›‘æ§ã€æŠ¥å‘Šç”Ÿæˆ
2. æ—¶é—´è¦æ±‚ï¼šå‡Œæ™¨å¤‡ä»½ã€å®šæœŸæ£€æŸ¥ã€å®æ—¶ç›‘æ§
3. å‡†ç¡®æ€§è¦æ±‚ï¼šé¿å…äººä¸ºé”™è¯¯ï¼Œæ ‡å‡†åŒ–æ“ä½œ
4. æ•ˆç‡æå‡ï¼šé‡Šæ”¾äººåŠ›åšæ›´æœ‰ä»·å€¼çš„å·¥ä½œ

å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š
â€¢ æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
â€¢ æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ•°æ®åº“è¿æ¥çŠ¶æ€  
â€¢ æ¯å‘¨ç”Ÿæˆæ•°æ®åº“æ€§èƒ½æŠ¥å‘Š
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨å‘é€å‘Šè­¦
```

### 1.2 MySQL Shellçš„ä¸‰ç§è¿è¡Œæ¨¡å¼


**ğŸ”§ äº¤äº’æ¨¡å¼ vs æ‰¹å¤„ç†æ¨¡å¼**
```
äº¤äº’æ¨¡å¼ï¼ˆInteractive Modeï¼‰ï¼š
mysqlsh> \connect root@localhost
mysqlsh> SELECT COUNT(*) FROM users;
ç‰¹ç‚¹ï¼šå®æ—¶äº¤äº’ï¼Œé€‚åˆæµ‹è¯•å’Œè°ƒè¯•

æ‰¹å¤„ç†æ¨¡å¼ï¼ˆBatch Modeï¼‰ï¼š
mysqlsh --file=backup.js
mysqlsh --execute="SELECT VERSION()"
ç‰¹ç‚¹ï¼šè‡ªåŠ¨æ‰§è¡Œï¼Œé€‚åˆè„šæœ¬åŒ–è¿ç»´

SQLæ¨¡å¼ï¼šä¸“é—¨æ‰§è¡ŒSQLè¯­å¥
JSæ¨¡å¼ï¼šæ‰§è¡ŒJavaScriptè„šæœ¬ï¼ŒåŠŸèƒ½æœ€å¼ºå¤§
Pythonæ¨¡å¼ï¼šæ‰§è¡ŒPythonè„šæœ¬ï¼Œæ•°æ®å¤„ç†èƒ½åŠ›å¼º
```

### 1.3 è‡ªåŠ¨åŒ–çš„åŸºæœ¬æ¶æ„


**ğŸ—ï¸ è‡ªåŠ¨åŒ–ç³»ç»Ÿæ¶æ„**
```
å®šæ—¶è°ƒåº¦å±‚ (Cron/Systemd Timer)
    â†“
Shellè„šæœ¬å±‚ (Bash/Shell Scripts)  
    â†“
MySQL Shellå±‚ (JavaScript/Python/SQL)
    â†“
æ•°æ®åº“å±‚ (MySQL Server)
    â†“
æ—¥å¿—åé¦ˆå±‚ (Logs/Notifications)
```

---

## 2. ğŸ“ Shellè„šæœ¬ç¼–å†™æ ¸å¿ƒæŠ€å·§


### 2.1 MySQL Shellè„šæœ¬åŸºç¡€ç»“æ„


**ğŸ”¸ æ ‡å‡†è„šæœ¬æ¨¡æ¿**
```bash
#!/bin/bash
# MySQL Shellè‡ªåŠ¨åŒ–è„šæœ¬æ¨¡æ¿

# åŸºç¡€é…ç½®
MYSQL_SHELL="/usr/bin/mysqlsh"
DB_HOST="localhost"
DB_USER="backup_user"
DB_PASS="your_password"
LOG_FILE="/var/log/mysql/automation.log"

# æ—¥å¿—å‡½æ•°
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# é”™è¯¯å¤„ç†
error_exit() {
    log_message "ERROR: $1"
    exit 1
}

# ä¸»è¦ä¸šåŠ¡é€»è¾‘
main() {
    log_message "å¼€å§‹æ‰§è¡Œè‡ªåŠ¨åŒ–ä»»åŠ¡"
    
    # æ£€æŸ¥MySQL Shellæ˜¯å¦å¯ç”¨
    if ! command -v "$MYSQL_SHELL" &> /dev/null; then
        error_exit "MySQL Shellæœªæ‰¾åˆ°"
    fi
    
    # æ‰§è¡Œå…·ä½“ä»»åŠ¡
    # ...
    
    log_message "ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
}

# è„šæœ¬å…¥å£
main "$@"
```

### 2.2 è¿æ¥ç®¡ç†æœ€ä½³å®è·µ


**ğŸ” å®‰å…¨çš„è¿æ¥æ–¹å¼**
```bash
# æ–¹å¼1ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
cat > /etc/mysql/shell_config.cnf << EOF
[client]
host=localhost
port=3306
user=automation_user
password=secure_password
EOF

# åœ¨è„šæœ¬ä¸­ä½¿ç”¨
$MYSQL_SHELL --defaults-file=/etc/mysql/shell_config.cnf \
    --execute="SELECT VERSION()"

# æ–¹å¼2ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
export MYSQL_PWD="your_password"
$MYSQL_SHELL --user=automation_user --host=localhost \
    --execute="SHOW DATABASES"
```

**ğŸ’¡ è¿æ¥æ± ç®¡ç†æŠ€å·§**
```bash
# è¿æ¥æµ‹è¯•å‡½æ•°
test_connection() {
    local host=$1
    local user=$2
    
    if $MYSQL_SHELL --host="$host" --user="$user" \
        --execute="SELECT 1" &>/dev/null; then
        return 0
    else
        return 1
    fi
}

# é‡è¯•æœºåˆ¶
retry_connection() {
    local max_attempts=3
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if test_connection "$DB_HOST" "$DB_USER"; then
            log_message "è¿æ¥æˆåŠŸ (å°è¯• $attempt/$max_attempts)"
            return 0
        fi
        
        log_message "è¿æ¥å¤±è´¥ï¼Œç­‰å¾…é‡è¯•... ($attempt/$max_attempts)"
        sleep 5
        ((attempt++))
    done
    
    error_exit "è¿æ¥å¤±è´¥ï¼Œå·²é‡è¯• $max_attempts æ¬¡"
}
```

### 2.3 JavaScriptè„šæœ¬åœ¨MySQL Shellä¸­çš„åº”ç”¨


**ğŸ”§ JavaScriptè‡ªåŠ¨åŒ–è„šæœ¬ç¤ºä¾‹**
```javascript
// backup_automation.js - æ•°æ®åº“å¤‡ä»½è‡ªåŠ¨åŒ–è„šæœ¬

// è¿æ¥é…ç½®
const config = {
    host: 'localhost',
    port: 3306,
    user: 'backup_user',
    password: 'backup_password'
};

// æ—¥å¿—å‡½æ•°
function logMessage(message) {
    const timestamp = new Date().toISOString();
    print(`[${timestamp}] ${message}`);
}

// ä¸»å¤‡ä»½å‡½æ•°
function performBackup(database) {
    try {
        logMessage(`å¼€å§‹å¤‡ä»½æ•°æ®åº“: ${database}`);
        
        // è¿æ¥æ•°æ®åº“
        const session = mysql.getSession(config);
        
        // æ‰§è¡Œå¤‡ä»½
        const backupFile = `/backup/${database}_${new Date().toISOString().split('T')[0]}.sql`;
        
        util.dumpSchemas([database], backupFile, {
            consistent: true,
            triggers: true,
            routines: true
        });
        
        logMessage(`å¤‡ä»½å®Œæˆ: ${backupFile}`);
        session.close();
        
    } catch (error) {
        logMessage(`å¤‡ä»½å¤±è´¥: ${error.message}`);
        throw error;
    }
}

// ä¸»å‡½æ•°
function main() {
    try {
        const databases = ['user_data', 'order_system'];
        
        for (let db of databases) {
            performBackup(db);
        }
        
        logMessage('æ‰€æœ‰æ•°æ®åº“å¤‡ä»½å®Œæˆ');
    } catch (error) {
        logMessage(`å¤‡ä»½è¿‡ç¨‹å‡ºé”™: ${error.message}`);
        process.exit(1);
    }
}

// æ‰§è¡Œä¸»å‡½æ•°
main();
```

---

## 3. âš¡ æ‰¹å¤„ç†æ¨¡å¼æ‰§è¡Œ


### 3.1 æ‰¹å¤„ç†æ¨¡å¼çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ‰¹å¤„ç†æ¨¡å¼**
```
æ‰¹å¤„ç†æ¨¡å¼ï¼šMySQL Shelléäº¤äº’å¼æ‰§è¡Œæ¨¡å¼
ç‰¹ç‚¹ï¼šä¸€æ¬¡æ€§æ‰§è¡Œå®Œæ•´çš„è„šæœ¬æˆ–SQLè¯­å¥ï¼Œæ— éœ€äººå·¥å¹²é¢„
ç”¨é€”ï¼šè‡ªåŠ¨åŒ–ä»»åŠ¡ã€å®šæ—¶è„šæœ¬ã€CI/CDé›†æˆ

ä¸äº¤äº’æ¨¡å¼çš„åŒºåˆ«ï¼š
äº¤äº’æ¨¡å¼ï¼šmysqlsh> SELECT * FROM users;  (éœ€è¦æ‰‹åŠ¨è¾“å…¥)
æ‰¹å¤„ç†æ¨¡å¼ï¼šmysqlsh --file=query.sql     (è‡ªåŠ¨æ‰§è¡Œæ–‡ä»¶)
```

### 3.2 æ‰¹å¤„ç†æ‰§è¡Œæ–¹å¼è¯¦è§£


**ğŸ”§ å››ç§ä¸»è¦æ‰§è¡Œæ–¹å¼**

**æ–¹å¼1ï¼šæ–‡ä»¶æ‰§è¡Œ**
```bash
# æ‰§è¡ŒSQLæ–‡ä»¶
mysqlsh --file=maintenance.sql --user=root --host=localhost

# æ‰§è¡ŒJavaScriptæ–‡ä»¶  
mysqlsh --file=backup.js --user=backup_user --host=localhost

# æ‰§è¡ŒPythonæ–‡ä»¶
mysqlsh --file=analytics.py --user=analyst --host=localhost
```

**æ–¹å¼2ï¼šç›´æ¥å‘½ä»¤æ‰§è¡Œ**
```bash
# æ‰§è¡Œå•æ¡SQL
mysqlsh --execute="SHOW PROCESSLIST" --user=monitor --host=localhost

# æ‰§è¡Œç®€å•JavaScript
mysqlsh --javascript --execute="print('Hello MySQL')"
```

**æ–¹å¼3ï¼šæ ‡å‡†è¾“å…¥æ‰§è¡Œ**
```bash
# é€šè¿‡ç®¡é“ä¼ é€’SQL
echo "SELECT COUNT(*) FROM information_schema.tables" | \
    mysqlsh --user=reader --host=localhost
```

### 3.3 æ‰¹å¤„ç†è„šæœ¬çš„é”™è¯¯å¤„ç†


**ğŸ›¡ï¸ å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶**
```javascript
// error_handling.js - é”™è¯¯å¤„ç†ç¤ºä¾‹è„šæœ¬

// å…¨å±€é”™è¯¯å¤„ç†è®¾ç½®
process.on('uncaughtException', function(error) {
    print(`æœªæ•è·çš„å¼‚å¸¸: ${error.message}`);
    process.exit(1);
});

// æ•°æ®åº“æ“ä½œé”™è¯¯å¤„ç†
function executeWithRetry(session, sql, maxRetries = 3) {
    let attempt = 1;
    
    while (attempt <= maxRetries) {
        try {
            print(`æ‰§è¡ŒSQL (å°è¯• ${attempt}/${maxRetries}): ${sql.substring(0, 50)}...`);
            const result = session.sql(sql).execute();
            print(`SQLæ‰§è¡ŒæˆåŠŸ`);
            return result;
            
        } catch (error) {
            print(`SQLæ‰§è¡Œå¤±è´¥ (å°è¯• ${attempt}/${maxRetries}): ${error.message}`);
            
            if (attempt === maxRetries) {
                throw new Error(`SQLæ‰§è¡Œå¤±è´¥ï¼Œå·²é‡è¯• ${maxRetries} æ¬¡: ${error.message}`);
            }
            
            // ç­‰å¾…åé‡è¯•
            print(`ç­‰å¾… ${attempt * 2} ç§’åé‡è¯•...`);
            os.sleep(attempt * 2);
            attempt++;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
try {
    const session = mysql.getSession('admin@localhost');
    
    // æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
    executeWithRetry(session, "ANALYZE TABLE large_table");
    executeWithRetry(session, "OPTIMIZE TABLE important_table");
    
    session.close();
    print('ç»´æŠ¤ä»»åŠ¡å®Œæˆ');
    
} catch (error) {
    print(`ç»´æŠ¤ä»»åŠ¡å¤±è´¥: ${error.message}`);
    process.exit(1);
}
```

---

## 4. â° å®šæ—¶ä»»åŠ¡é…ç½®ä¸ç®¡ç†


### 4.1 Cronå®šæ—¶ä»»åŠ¡åŸºç¡€


**ğŸ”¸ Cronæ—¶é—´è¡¨è¾¾å¼è¯¦è§£**
```
Cronè¡¨è¾¾å¼æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
*    *  *  *  *   å‘½ä»¤
â”‚    â”‚  â”‚  â”‚  â”‚
â”‚    â”‚  â”‚  â”‚  â””â”€â”€ æ˜ŸæœŸå‡  (0-7, 0å’Œ7éƒ½è¡¨ç¤ºå‘¨æ—¥)
â”‚    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€ æœˆä»½ (1-12)
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)  
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)

å¸¸ç”¨æ—¶é—´è¡¨è¾¾å¼ï¼š
0 2 * * *     # æ¯å¤©å‡Œæ™¨2ç‚¹
*/5 * * * *   # æ¯5åˆ†é’Ÿ
0 0 * * 0     # æ¯å‘¨æ—¥åˆå¤œ
0 1 1 * *     # æ¯æœˆ1å·å‡Œæ™¨1ç‚¹
```

**ğŸ’¡ å®ç”¨çš„Croné…ç½®ç¤ºä¾‹**
```bash
# ç¼–è¾‘crontab
crontab -e

# æ•°æ®åº“å¤‡ä»½ - æ¯å¤©å‡Œæ™¨2ç‚¹
0 2 * * * /opt/mysql/scripts/daily_backup.sh >> /var/log/mysql/backup.log 2>&1

# æ€§èƒ½ç›‘æ§ - æ¯5åˆ†é’Ÿ
*/5 * * * * /opt/mysql/scripts/performance_check.sh

# æ—¥å¿—æ¸…ç† - æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹
0 3 * * 0 /opt/mysql/scripts/log_cleanup.sh

# æœˆåº¦æŠ¥å‘Š - æ¯æœˆ1å·ä¸Šåˆ9ç‚¹
0 9 1 * * /opt/mysql/scripts/monthly_report.sh

# æ£€æŸ¥ç£ç›˜ç©ºé—´ - æ¯å°æ—¶
0 * * * * /opt/mysql/scripts/disk_check.sh
```

### 4.2 é«˜çº§å®šæ—¶ä»»åŠ¡ç®¡ç†


**ğŸ”§ æ™ºèƒ½å®šæ—¶ä»»åŠ¡è„šæœ¬**
```bash
#!/bin/bash
# smart_scheduler.sh - æ™ºèƒ½ä»»åŠ¡è°ƒåº¦å™¨

LOCK_DIR="/var/lock/mysql_automation"
SCRIPT_NAME=$(basename "$0")
LOCK_FILE="$LOCK_DIR/$SCRIPT_NAME.lock"

# åˆ›å»ºé”ç›®å½•
mkdir -p "$LOCK_DIR"

# é˜²æ­¢é‡å¤æ‰§è¡Œçš„é”æœºåˆ¶
acquire_lock() {
    if [ -f "$LOCK_FILE" ]; then
        local pid=$(cat "$LOCK_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            log_message "ä»»åŠ¡æ­£åœ¨è¿è¡Œä¸­ (PID: $pid)ï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œ"
            exit 0
        else
            log_message "å‘ç°åƒµå°¸é”æ–‡ä»¶ï¼Œæ¸…ç†ä¸­..."
            rm -f "$LOCK_FILE"
        fi
    fi
    
    echo $$ > "$LOCK_FILE"
    log_message "è·å–ä»»åŠ¡é”æˆåŠŸ (PID: $$)"
}

# é‡Šæ”¾é”
release_lock() {
    rm -f "$LOCK_FILE"
    log_message "é‡Šæ”¾ä»»åŠ¡é”"
}

# ä¿¡å·å¤„ç†
trap 'release_lock; exit' INT TERM EXIT

# ä»»åŠ¡æ‰§è¡Œé€»è¾‘
execute_task() {
    acquire_lock
    
    log_message "å¼€å§‹æ‰§è¡Œå®šæ—¶ä»»åŠ¡: $SCRIPT_NAME"
    local start_time=$(date +%s)
    
    # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    if (( $(echo "$load_avg > 5.0" | bc -l) )); then
        log_message "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ ($load_avg)ï¼Œå»¶è¿Ÿæ‰§è¡Œ"
        sleep 300  # ç­‰å¾…5åˆ†é’Ÿ
    fi
    
    # æ‰§è¡Œå®é™…ä»»åŠ¡
    if perform_main_task; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        log_message "ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶: ${duration}ç§’"
    else
        log_message "ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        return 1
    fi
}

# ä¸»ä»»åŠ¡å‡½æ•°ï¼ˆç”±å…·ä½“è„šæœ¬å®ç°ï¼‰
perform_main_task() {
    # è¿™é‡Œè°ƒç”¨å…·ä½“çš„MySQL Shellä»»åŠ¡
    mysqlsh --file=/opt/mysql/scripts/maintenance.js \
        --log-level=info \
        2>&1 | while read line; do
            log_message "$line"
        done
    
    return ${PIPESTATUS[0]}
}

# æ‰§è¡Œä»»åŠ¡
execute_task "$@"
```

### 4.3 Systemd Timeræ›¿ä»£æ–¹æ¡ˆ


**ğŸ”§ ç°ä»£åŒ–çš„å®šæ—¶ä»»åŠ¡ç®¡ç†**
```bash
# åˆ›å»ºserviceæ–‡ä»¶
cat > /etc/systemd/system/mysql-backup.service << EOF
[Unit]
Description=MySQL Database Backup
After=mysql.service

[Service]
Type=oneshot
User=mysql
Group=mysql
ExecStart=/opt/mysql/scripts/backup.sh
StandardOutput=journal
StandardError=journal
EOF

# åˆ›å»ºtimeræ–‡ä»¶
cat > /etc/systemd/system/mysql-backup.timer << EOF
[Unit]
Description=MySQL Backup Timer
Requires=mysql-backup.service

[Timer]
OnCalendar=daily
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target
EOF

# å¯ç”¨å¹¶å¯åŠ¨timer
systemctl daemon-reload
systemctl enable mysql-backup.timer
systemctl start mysql-backup.timer

# æŸ¥çœ‹timerçŠ¶æ€
systemctl list-timers mysql-backup.timer
```

---

## 5. ğŸ“Š è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬


### 5.1 æ•°æ®åº“å¥åº·çŠ¶æ€ç›‘æ§


**ğŸ” æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```javascript
// health_monitor.js - æ•°æ®åº“å¥åº·ç›‘æ§è„šæœ¬

const MonitoringConfig = {
    thresholds: {
        connections: 80,        // è¿æ¥æ•°é˜ˆå€¼ (%)
        cpu_usage: 85,         // CPUä½¿ç”¨ç‡é˜ˆå€¼ (%)
        memory_usage: 90,      // å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼ (%)
        disk_usage: 85,        // ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼ (%)
        slow_queries: 100,     // æ…¢æŸ¥è¯¢æ•°é‡é˜ˆå€¼
        replication_lag: 10    // å¤åˆ¶å»¶è¿Ÿé˜ˆå€¼ (ç§’)
    },
    check_interval: 300,       // æ£€æŸ¥é—´éš” (ç§’)
    alert_cooldown: 1800      // å‘Šè­¦å†·å´æ—¶é—´ (ç§’)
};

// ç›‘æ§æ£€æŸ¥å™¨ç±»
class DatabaseMonitor {
    constructor(session) {
        this.session = session;
        this.alerts = new Map();
    }
    
    // æ£€æŸ¥è¿æ¥æ•°
    checkConnections() {
        const result = this.session.sql(`
            SELECT 
                VARIABLE_VALUE as current_connections
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME = 'Threads_connected'
        `).execute();
        
        const currentConnections = parseInt(result.fetchOne()[0]);
        
        const maxResult = this.session.sql(`
            SELECT $$max_connections as max_connections
        `).execute();
        
        const maxConnections = parseInt(maxResult.fetchOne()[0]);
        const usagePercent = (currentConnections / maxConnections) * 100;
        
        print(`è¿æ¥æ•°æ£€æŸ¥: ${currentConnections}/${maxConnections} (${usagePercent.toFixed(1)}%)`);
        
        if (usagePercent > MonitoringConfig.thresholds.connections) {
            this.raiseAlert('connections', `è¿æ¥æ•°è¿‡é«˜: ${usagePercent.toFixed(1)}%`);
        }
        
        return {
            metric: 'connections',
            current: currentConnections,
            max: maxConnections,
            usage_percent: usagePercent,
            status: usagePercent > MonitoringConfig.thresholds.connections ? 'WARNING' : 'OK'
        };
    }
    
    // æ£€æŸ¥æ…¢æŸ¥è¯¢
    checkSlowQueries() {
        const result = this.session.sql(`
            SELECT VARIABLE_VALUE as slow_queries
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME = 'Slow_queries'
        `).execute();
        
        const slowQueries = parseInt(result.fetchOne()[0]);
        
        print(`æ…¢æŸ¥è¯¢æ£€æŸ¥: å½“å‰æ€»æ•° ${slowQueries}`);
        
        return {
            metric: 'slow_queries',
            total: slowQueries,
            status: 'OK'
        };
    }
    
    // æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
    checkReplicationLag() {
        try {
            const result = this.session.sql(`
                SHOW SLAVE STATUS
            `).execute();
            
            const slaveStatus = result.fetchOne();
            if (!slaveStatus) {
                return { metric: 'replication', status: 'N/A', message: 'éä»åº“æˆ–å¤åˆ¶æœªé…ç½®' };
            }
            
            const lag = slaveStatus[32]; // Seconds_Behind_Master
            print(`å¤åˆ¶å»¶è¿Ÿæ£€æŸ¥: ${lag} ç§’`);
            
            if (lag > MonitoringConfig.thresholds.replication_lag) {
                this.raiseAlert('replication', `å¤åˆ¶å»¶è¿Ÿè¿‡é«˜: ${lag} ç§’`);
            }
            
            return {
                metric: 'replication',
                lag_seconds: lag,
                status: lag > MonitoringConfig.thresholds.replication_lag ? 'WARNING' : 'OK'
            };
            
        } catch (error) {
            return { metric: 'replication', status: 'ERROR', message: error.message };
        }
    }
    
    // å‘Šè­¦å¤„ç†
    raiseAlert(type, message) {
        const now = Date.now();
        const lastAlert = this.alerts.get(type) || 0;
        
        if (now - lastAlert > MonitoringConfig.alert_cooldown * 1000) {
            print(`ğŸš¨ ALERT: ${message}`);
            this.sendNotification(type, message);
            this.alerts.set(type, now);
        }
    }
    
    // å‘é€é€šçŸ¥ï¼ˆç¤ºä¾‹å®ç°ï¼‰
    sendNotification(type, message) {
        // è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€é’‰é’‰ã€å¾®ä¿¡ç­‰é€šçŸ¥æ–¹å¼
        const alertData = {
            timestamp: new Date().toISOString(),
            type: type,
            message: message,
            hostname: os.getenv('HOSTNAME') || 'unknown'
        };
        
        // å†™å…¥å‘Šè­¦æ—¥å¿—
        const alertLog = JSON.stringify(alertData);
        print(`å‘Šè­¦è®°å½•: ${alertLog}`);
    }
}

// ä¸»ç›‘æ§å‡½æ•°
function runHealthCheck() {
    try {
        print(`å¼€å§‹æ•°æ®åº“å¥åº·æ£€æŸ¥ - ${new Date().toISOString()}`);
        
        const session = mysql.getSession('monitor@localhost');
        const monitor = new DatabaseMonitor(session);
        
        // æ‰§è¡Œå„é¡¹æ£€æŸ¥
        const results = [
            monitor.checkConnections(),
            monitor.checkSlowQueries(),
            monitor.checkReplicationLag()
        ];
        
        // æ±‡æ€»ç»“æœ
        const summary = {
            timestamp: new Date().toISOString(),
            checks: results,
            overall_status: results.every(r => r.status === 'OK' || r.status === 'N/A') ? 'HEALTHY' : 'WARNING'
        };
        
        print(`å¥åº·æ£€æŸ¥å®Œæˆï¼Œæ•´ä½“çŠ¶æ€: ${summary.overall_status}`);
        
        session.close();
        return summary;
        
    } catch (error) {
        print(`å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`);
        throw error;
    }
}

// æ‰§è¡Œå¥åº·æ£€æŸ¥
runHealthCheck();
```

### 5.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§


**ğŸ“ˆ å…³é”®æ€§èƒ½æŒ‡æ ‡æ”¶é›†**
```javascript
// performance_monitor.js - æ€§èƒ½ç›‘æ§è„šæœ¬

class PerformanceMonitor {
    constructor(session) {
        this.session = session;
    }
    
    // æ”¶é›†QPS/TPSæ•°æ®
    collectThroughputMetrics() {
        const queries = this.session.sql(`
            SELECT 
                VARIABLE_NAME,
                VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME IN (
                'Com_select', 'Com_insert', 'Com_update', 'Com_delete',
                'Questions', 'Queries'
            )
        `).execute();
        
        const metrics = {};
        queries.fetchAll().forEach(row => {
            metrics[row[0]] = parseInt(row[1]);
        });
        
        // è®¡ç®—QPS (ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦æ—¶é—´é—´éš”è®¡ç®—)
        const totalQueries = metrics['Questions'] || 0;
        
        return {
            timestamp: new Date().toISOString(),
            total_queries: totalQueries,
            select_count: metrics['Com_select'] || 0,
            insert_count: metrics['Com_insert'] || 0,
            update_count: metrics['Com_update'] || 0,
            delete_count: metrics['Com_delete'] || 0
        };
    }
    
    // æ”¶é›†InnoDBæŒ‡æ ‡
    collectInnoDBMetrics() {
        const result = this.session.sql(`
            SELECT 
                VARIABLE_NAME,
                VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME LIKE 'Innodb_%'
            AND VARIABLE_NAME IN (
                'Innodb_buffer_pool_pages_dirty',
                'Innodb_buffer_pool_pages_total',
                'Innodb_rows_read',
                'Innodb_rows_inserted',
                'Innodb_rows_updated',
                'Innodb_rows_deleted'
            )
        `).execute();
        
        const metrics = {};
        result.fetchAll().forEach(row => {
            metrics[row[0]] = row[1];
        });
        
        return {
            timestamp: new Date().toISOString(),
            dirty_pages: parseInt(metrics['Innodb_buffer_pool_pages_dirty'] || 0),
            total_pages: parseInt(metrics['Innodb_buffer_pool_pages_total'] || 0),
            rows_read: parseInt(metrics['Innodb_rows_read'] || 0),
            rows_inserted: parseInt(metrics['Innodb_rows_inserted'] || 0),
            rows_updated: parseInt(metrics['Innodb_rows_updated'] || 0),
            rows_deleted: parseInt(metrics['Innodb_rows_deleted'] || 0)
        };
    }
}
```

---

## 6. ğŸ’¾ å¤‡ä»½è„šæœ¬å¼€å‘


### 6.1 æ™ºèƒ½å¤‡ä»½ç­–ç•¥


**ğŸ”¸ å¤‡ä»½ç­–ç•¥çš„æ ¸å¿ƒæ€æƒ³**
```
ä»€ä¹ˆæ˜¯æ™ºèƒ½å¤‡ä»½ï¼Ÿ
ä¸æ˜¯ç®€å•çš„"ä¸€åˆ€åˆ‡"å¤‡ä»½ï¼Œè€Œæ˜¯æ ¹æ®æ•°æ®é‡è¦æ€§ã€å˜åŒ–é¢‘ç‡ã€ä¸šåŠ¡éœ€æ±‚æ¥åˆ¶å®šå·®å¼‚åŒ–å¤‡ä»½ç­–ç•¥

å¤‡ä»½ç±»å‹é€‰æ‹©ï¼š
â€¢ å…¨é‡å¤‡ä»½ï¼šå®Œæ•´çš„æ•°æ®åº“å¤‡ä»½ï¼Œå ç”¨ç©ºé—´å¤§ä½†æ¢å¤ç®€å•
â€¢ å¢é‡å¤‡ä»½ï¼šåªå¤‡ä»½å˜åŒ–çš„æ•°æ®ï¼ŒèŠ‚çœç©ºé—´ä½†æ¢å¤å¤æ‚  
â€¢ å·®å¼‚å¤‡ä»½ï¼šå¤‡ä»½è‡ªä¸Šæ¬¡å…¨é‡å¤‡ä»½åçš„æ‰€æœ‰å˜åŒ–

æ—¶é—´ç­–ç•¥ï¼š
â€¢ æ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼šæ¯å°æ—¶å¢é‡ + æ¯å¤©å…¨é‡
â€¢ ä¸€èˆ¬ä¸šåŠ¡æ•°æ®ï¼šæ¯å¤©å¢é‡ + æ¯å‘¨å…¨é‡
â€¢ å†å²æ•°æ®ï¼šæ¯å‘¨å…¨é‡å³å¯
```

**ğŸ’¡ å¤‡ä»½è„šæœ¬æ ¸å¿ƒæ¶æ„**
```bash
#!/bin/bash
# intelligent_backup.sh - æ™ºèƒ½å¤‡ä»½è„šæœ¬

# é…ç½®åŒºåŸŸ
BACKUP_BASE_DIR="/backup/mysql"
MYSQL_SHELL="/usr/bin/mysqlsh"
RETENTION_DAYS=30

# å¤‡ä»½ç­–ç•¥é…ç½®
declare -A BACKUP_STRATEGIES=(
    ["critical"]="hourly_incremental,daily_full"
    ["important"]="daily_incremental,weekly_full"  
    ["normal"]="weekly_full"
)

# æ•°æ®åº“åˆ†ç±»é…ç½®
declare -A DATABASE_CATEGORIES=(
    ["user_data"]="critical"
    ["order_system"]="critical"
    ["log_data"]="normal"
    ["temp_data"]="normal"
)

# è·å–å¤‡ä»½ç­–ç•¥
get_backup_strategy() {
    local database=$1
    local category=${DATABASE_CATEGORIES[$database]:-"normal"}
    echo ${BACKUP_STRATEGIES[$category]}
}

# æ‰§è¡Œå…¨é‡å¤‡ä»½
perform_full_backup() {
    local database=$1
    local backup_dir="$BACKUP_BASE_DIR/full/$(date +%Y%m%d)"
    
    mkdir -p "$backup_dir"
    
    log_message "å¼€å§‹å…¨é‡å¤‡ä»½: $database"
    
    # ä½¿ç”¨MySQL Shellçš„util.dumpSchemas()
    cat > /tmp/backup_${database}.js << EOF
// è¿æ¥æ•°æ®åº“
var session = mysql.getSession('backup_user@localhost');

// æ‰§è¡Œå¤‡ä»½
util.dumpSchemas(['${database}'], '${backup_dir}/${database}', {
    consistent: true,
    showProgress: true,
    compression: 'gzip',
    threads: 4
});

session.close();
print('å¤‡ä»½å®Œæˆ: ${database}');
EOF

    if $MYSQL_SHELL --file=/tmp/backup_${database}.js; then
        log_message "å…¨é‡å¤‡ä»½æˆåŠŸ: $backup_dir/${database}"
        
        # è®¡ç®—å¤‡ä»½æ–‡ä»¶å¤§å°
        local backup_size=$(du -sh "$backup_dir/${database}" | cut -f1)
        log_message "å¤‡ä»½æ–‡ä»¶å¤§å°: $backup_size"
        
        # è®°å½•å¤‡ä»½ä¿¡æ¯
        echo "$(date '+%Y-%m-%d %H:%M:%S'),full,$database,$backup_dir/${database},$backup_size" >> "$BACKUP_BASE_DIR/backup_log.csv"
        
        return 0
    else
        log_message "å…¨é‡å¤‡ä»½å¤±è´¥: $database"
        return 1
    fi
}

# æ™ºèƒ½å¤‡ä»½è°ƒåº¦å™¨
intelligent_backup_scheduler() {
    local database=$1
    local strategy=$(get_backup_strategy "$database")
    local current_hour=$(date +%H)
    local current_day=$(date +%u)  # 1-7, Monday-Sunday
    
    log_message "æ•°æ®åº“ $database çš„å¤‡ä»½ç­–ç•¥: $strategy"
    
    case "$strategy" in
        *"daily_full"*)
            if [ "$current_hour" == "02" ]; then  # å‡Œæ™¨2ç‚¹æ‰§è¡Œå…¨é‡å¤‡ä»½
                perform_full_backup "$database"
            fi
            ;;
        *"weekly_full"*)
            if [ "$current_day" == "7" ] && [ "$current_hour" == "02" ]; then  # å‘¨æ—¥å‡Œæ™¨2ç‚¹
                perform_full_backup "$database"
            fi
            ;;
    esac
}

# å¤‡ä»½éªŒè¯å‡½æ•°
verify_backup() {
    local backup_path=$1
    
    log_message "å¼€å§‹éªŒè¯å¤‡ä»½: $backup_path"
    
    # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
    if [ ! -s "$backup_path" ]; then
        log_message "å¤‡ä»½éªŒè¯å¤±è´¥: æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
        return 1
    fi
    
    # å¦‚æœæ˜¯å‹ç¼©æ–‡ä»¶ï¼Œæ£€æŸ¥å‹ç¼©å®Œæ•´æ€§
    if [[ "$backup_path" == *.gz ]]; then
        if ! gzip -t "$backup_path" 2>/dev/null; then
            log_message "å¤‡ä»½éªŒè¯å¤±è´¥: å‹ç¼©æ–‡ä»¶æŸå"
            return 1
        fi
    fi
    
    log_message "å¤‡ä»½éªŒè¯æˆåŠŸ"
    return 0
}

# ä¸»å¤‡ä»½å‡½æ•°
main_backup() {
    log_message "å¼€å§‹æ™ºèƒ½å¤‡ä»½ä»»åŠ¡"
    
    # è·å–éœ€è¦å¤‡ä»½çš„æ•°æ®åº“åˆ—è¡¨
    local databases="user_data order_system log_data"
    
    for database in $databases; do
        if [[ ! "${DATABASE_CATEGORIES[$database]}" ]]; then
            log_message "è·³è¿‡æœªåˆ†ç±»æ•°æ®åº“: $database"
            continue
        fi
        
        log_message "å¤„ç†æ•°æ®åº“: $database"
        intelligent_backup_scheduler "$database"
    done
    
    log_message "æ™ºèƒ½å¤‡ä»½ä»»åŠ¡å®Œæˆ"
}

# æ‰§è¡Œä¸»å¤‡ä»½ä»»åŠ¡
main_backup "$@"
```

### 6.2 å¤‡ä»½æ¢å¤éªŒè¯


**ğŸ”§ è‡ªåŠ¨åŒ–å¤‡ä»½éªŒè¯è„šæœ¬**
```javascript
// backup_verification.js - å¤‡ä»½éªŒè¯è„šæœ¬

class BackupVerifier {
    constructor() {
        this.testDbName = 'backup_test_' + Date.now();
    }
    
    // éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
    verifyBackupIntegrity(backupPath) {
        try {
            print(`éªŒè¯å¤‡ä»½æ–‡ä»¶: ${backupPath}`);
            
            // åˆ›å»ºæµ‹è¯•æ•°æ®åº“
            const session = mysql.getSession('root@localhost');
            session.sql(`CREATE DATABASE IF NOT EXISTS ${this.testDbName}`).execute();
            
            // å°è¯•æ¢å¤å¤‡ä»½åˆ°æµ‹è¯•æ•°æ®åº“
            util.loadDump(backupPath, {
                schema: this.testDbName,
                ignoreExistingObjects: true,
                threads: 2
            });
            
            // éªŒè¯æ¢å¤çš„æ•°æ®
            const tableCount = session.sql(`
                SELECT COUNT(*) as table_count 
                FROM information_schema.tables 
                WHERE table_schema = '${this.testDbName}'
            `).execute().fetchOne()[0];
            
            print(`æ¢å¤éªŒè¯æˆåŠŸ: æ¢å¤äº† ${tableCount} ä¸ªè¡¨`);
            
            // æ¸…ç†æµ‹è¯•æ•°æ®åº“
            session.sql(`DROP DATABASE ${this.testDbName}`).execute();
            session.close();
            
            return {
                status: 'SUCCESS',
                table_count: tableCount,
                message: 'å¤‡ä»½æ–‡ä»¶å®Œæ•´ä¸”å¯æ­£å¸¸æ¢å¤'
            };
            
        } catch (error) {
            print(`å¤‡ä»½éªŒè¯å¤±è´¥: ${error.message}`);
            
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„æµ‹è¯•æ•°æ®åº“
            try {
                const session = mysql.getSession('root@localhost');
                session.sql(`DROP DATABASE IF EXISTS ${this.testDbName}`).execute();
                session.close();
            } catch (cleanupError) {
                print(`æ¸…ç†æµ‹è¯•æ•°æ®åº“å¤±è´¥: ${cleanupError.message}`);
            }
            
            return {
                status: 'FAILED',
                error: error.message,
                message: 'å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥'
            };
        }
    }
    
    // ç”Ÿæˆå¤‡ä»½æŠ¥å‘Š
    generateBackupReport(backupResults) {
        const report = {
            timestamp: new Date().toISOString(),
            total_backups: backupResults.length,
            successful: backupResults.filter(r => r.status === 'SUCCESS').length,
            failed: backupResults.filter(r => r.status === 'FAILED').length,
            details: backupResults
        };
        
        // è¾“å‡ºæŠ¥å‘Š
        print('=== å¤‡ä»½éªŒè¯æŠ¥å‘Š ===');
        print(`éªŒè¯æ—¶é—´: ${report.timestamp}`);
        print(`æ€»å¤‡ä»½æ•°: ${report.total_backups}`);
        print(`æˆåŠŸ: ${report.successful}`);
        print(`å¤±è´¥: ${report.failed}`);
        print(`æˆåŠŸç‡: ${(report.successful / report.total_backups * 100).toFixed(1)}%`);
        
        return report;
    }
}

// æ‰§è¡Œå¤‡ä»½éªŒè¯
function runBackupVerification() {
    const verifier = new BackupVerifier();
    const backupPaths = [
        '/backup/mysql/full/20241201/user_data',
        '/backup/mysql/full/20241201/order_system'
    ];
    
    const results = [];
    
    for (let path of backupPaths) {
        const result = verifier.verifyBackupIntegrity(path);
        results.push({
            backup_path: path,
            ...result
        });
    }
    
    verifier.generateBackupReport(results);
}

// æ‰§è¡ŒéªŒè¯
runBackupVerification();
```

---

## 7. ğŸš¨ é”™è¯¯é€šçŸ¥æœºåˆ¶


### 7.1 å¤šæ¸ é“é€šçŸ¥ç³»ç»Ÿ


**ğŸ”¸ é€šçŸ¥æœºåˆ¶çš„æ ¸å¿ƒç›®æ ‡**
```
ä»€ä¹ˆæ—¶å€™éœ€è¦é€šçŸ¥ï¼Ÿ
1. å¤‡ä»½å¤±è´¥æˆ–å¼‚å¸¸
2. ç›‘æ§æŒ‡æ ‡è¶…å‡ºé˜ˆå€¼
3. æ•°æ®åº“è¿æ¥å¼‚å¸¸
4. ç£ç›˜ç©ºé—´ä¸è¶³
5. å¤åˆ¶å»¶è¿Ÿè¿‡é«˜

é€šçŸ¥åŸåˆ™ï¼š
â€¢ åŠæ—¶æ€§ï¼šå…³é”®é—®é¢˜ç«‹å³é€šçŸ¥
â€¢ å‡†ç¡®æ€§ï¼šé¿å…è¯¯æŠ¥å’Œæ¼æŠ¥
â€¢ åˆ†çº§æ€§ï¼šä¸åŒé—®é¢˜ä¸åŒä¼˜å…ˆçº§
â€¢ é˜²éªšæ‰°ï¼šé¿å…é‡å¤é€šçŸ¥
```

**ğŸ’¡ å¤šæ¸ é“é€šçŸ¥æ¶æ„**
```bash
#!/bin/bash
# notification_system.sh - é€šçŸ¥ç³»ç»Ÿ

# é€šçŸ¥é…ç½®
EMAIL_ENABLED=true
EMAIL_TO="admin@company.com,dba@company.com"
EMAIL_SMTP="smtp.company.com"

DINGTALK_ENABLED=true
DINGTALK_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"

WECHAT_ENABLED=false
WECHAT_CORP_ID="your_corp_id"
WECHAT_SECRET="your_secret"

# å‘Šè­¦çº§åˆ«å®šä¹‰
declare -A ALERT_LEVELS=(
    ["CRITICAL"]="ğŸ”´ ä¸¥é‡"
    ["WARNING"]="ğŸŸ¡ è­¦å‘Š"  
    ["INFO"]="ğŸ”µ ä¿¡æ¯"
)

# å‘é€é‚®ä»¶é€šçŸ¥
send_email_notification() {
    local level=$1
    local title=$2
    local content=$3
    
    if [ "$EMAIL_ENABLED" != "true" ]; then
        return 0
    fi
    
    local subject="${ALERT_LEVELS[$level]} MySQLå‘Šè­¦: $title"
    
    # æ„å»ºé‚®ä»¶å†…å®¹
    local email_body=$(cat <<EOF
MySQLæ•°æ®åº“å‘Šè­¦é€šçŸ¥

å‘Šè­¦çº§åˆ«: ${ALERT_LEVELS[$level]}
å‘Šè­¦æ ‡é¢˜: $title
å‘Šè­¦æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
æœåŠ¡å™¨: $(hostname)

è¯¦ç»†ä¿¡æ¯:
$content

è¯·åŠæ—¶å¤„ç†æ­¤å‘Šè­¦ã€‚

---
æ­¤é‚®ä»¶ç”±MySQLè‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿå‘é€
EOF
)
    
    # å‘é€é‚®ä»¶ (ä½¿ç”¨mailå‘½ä»¤)
    echo "$email_body" | mail -s "$subject" "$EMAIL_TO"
    
    if [ $? -eq 0 ]; then
        log_message "é‚®ä»¶é€šçŸ¥å‘é€æˆåŠŸ: $title"
    else
        log_message "é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥: $title"
    fi
}

# å‘é€é’‰é’‰é€šçŸ¥
send_dingtalk_notification() {
    local level=$1
    local title=$2
    local content=$3
    
    if [ "$DINGTALK_ENABLED" != "true" ]; then
        return 0
    fi
    
    # æ„å»ºé’‰é’‰æ¶ˆæ¯
    local dingtalk_msg=$(cat <<EOF
{
    "msgtype": "markdown",
    "markdown": {
        "title": "MySQLå‘Šè­¦é€šçŸ¥",
        "text": "## ${ALERT_LEVELS[$level]} MySQLå‘Šè­¦é€šçŸ¥\n\n**å‘Šè­¦æ ‡é¢˜:** $title\n\n**å‘Šè­¦æ—¶é—´:** $(date '+%Y-%m-%d %H:%M:%S')\n\n**æœåŠ¡å™¨:** $(hostname)\n\n**è¯¦ç»†ä¿¡æ¯:**\n\n$content\n\n> è¯·åŠæ—¶å¤„ç†æ­¤å‘Šè­¦"
    }
}
EOF
)
    
    # å‘é€é’‰é’‰é€šçŸ¥
    curl -s -X POST "$DINGTALK_WEBHOOK" \
        -H "Content-Type: application/json" \
        -d "$dingtalk_msg" > /dev/null
    
    if [ $? -eq 0 ]; then
        log_message "é’‰é’‰é€šçŸ¥å‘é€æˆåŠŸ: $title"
    else
        log_message "é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥: $title"
    fi
}

# ç»Ÿä¸€é€šçŸ¥æ¥å£
send_notification() {
    local level=$1
    local title=$2
    local content=$3
    
    log_message "å‘é€${ALERT_LEVELS[$level]}é€šçŸ¥: $title"
    
    # æ ¹æ®çº§åˆ«å†³å®šé€šçŸ¥æ¸ é“
    case "$level" in
        "CRITICAL")
            send_email_notification "$level" "$title" "$content"
            send_dingtalk_notification "$level" "$title" "$content"
            ;;
        "WARNING")
            send_dingtalk_notification "$level" "$title" "$content"
            ;;
        "INFO")
            # ä¿¡æ¯çº§åˆ«åªè®°å½•æ—¥å¿—ï¼Œä¸å‘é€é€šçŸ¥
            log_message "ä¿¡æ¯é€šçŸ¥: $title - $content"
            ;;
        *)
            log_message "æœªçŸ¥å‘Šè­¦çº§åˆ«: $level"
            ;;
    esac
}

# ä½¿ç”¨ç¤ºä¾‹
# send_notification "CRITICAL" "æ•°æ®åº“è¿æ¥å¤±è´¥" "æ— æ³•è¿æ¥åˆ°MySQLæœåŠ¡å™¨ localhost:3306"
# send_notification "WARNING" "ç£ç›˜ç©ºé—´ä¸è¶³" "æ•°æ®ç›®å½• /var/lib/mysql ä½¿ç”¨ç‡è¾¾åˆ°85%"
```

### 7.2 æ™ºèƒ½å‘Šè­¦ç­–ç•¥


**ğŸ§  å‘Šè­¦å»é‡ä¸æŠ‘åˆ¶**
```bash
#!/bin/bash
# smart_alerting.sh - æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ

ALERT_STATE_DIR="/var/lib/mysql/alerts"
mkdir -p "$ALERT_STATE_DIR"

# å‘Šè­¦æŠ‘åˆ¶é…ç½®
ALERT_COOLDOWN=1800      # å‘Šè­¦å†·å´æ—¶é—´ï¼š30åˆ†é’Ÿ
ALERT_ESCALATION=3600    # å‘Šè­¦å‡çº§æ—¶é—´ï¼š1å°æ—¶
MAX_ALERTS_PER_HOUR=10   # æ¯å°æ—¶æœ€å¤§å‘Šè­¦æ•°

# æ£€æŸ¥å‘Šè­¦æ˜¯å¦åº”è¯¥å‘é€
should_send_alert() {
    local alert_key=$1
    local level=$2
    local current_time=$(date +%s)
    
    local state_file="$ALERT_STATE_DIR/${alert_key}.state"
    
    # å¦‚æœçŠ¶æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿™æ˜¯æ–°å‘Šè­¦
    if [ ! -f "$state_file" ]; then
        echo "$current_time,$level,1" > "$state_file"
        return 0  # å‘é€å‘Šè­¦
    fi
    
    # è¯»å–ä¸Šæ¬¡å‘Šè­¦çŠ¶æ€
    local last_alert_time=$(cat "$state_file" | cut -d',' -f1)
    local last_level=$(cat "$state_file" | cut -d',' -f2)
    local alert_count=$(cat "$state_file" | cut -d',' -f3)
    
    local time_diff=$((current_time - last_alert_time))
    
    # æ£€æŸ¥å†·å´æ—¶é—´
    if [ $time_diff -lt $ALERT_COOLDOWN ]; then
        log_message "å‘Šè­¦ $alert_key å¤„äºå†·å´æœŸï¼Œè·³è¿‡å‘é€"
        return 1  # ä¸å‘é€å‘Šè­¦
    fi
    
    # æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§å‘Šè­¦çº§åˆ«
    if [ $time_diff -gt $ALERT_ESCALATION ] && [ "$last_level" == "WARNING" ] && [ "$level" == "WARNING" ]; then
        level="CRITICAL"
        log_message "å‘Šè­¦ $alert_key å‡çº§ä¸ºä¸¥é‡çº§åˆ«"
    fi
    
    # æ£€æŸ¥å‘Šè­¦é¢‘ç‡é™åˆ¶
    local hour_start=$((current_time - 3600))
    if [ $alert_count -gt $MAX_ALERTS_PER_HOUR ] && [ $last_alert_time -gt $hour_start ]; then
        log_message "å‘Šè­¦ $alert_key è§¦å‘é¢‘ç‡é™åˆ¶ï¼Œæš‚åœå‘é€"
        return 1  # ä¸å‘é€å‘Šè­¦
    fi
    
    # æ›´æ–°çŠ¶æ€æ–‡ä»¶
    local new_count=1
    if [ $last_alert_time -gt $hour_start ]; then
        new_count=$((alert_count + 1))
    fi
    
    echo "$current_time,$level,$new_count" > "$state_file"
    return 0  # å‘é€å‘Šè­¦
}

# æ¸…ç†è¿‡æœŸå‘Šè­¦çŠ¶æ€
cleanup_alert_states() {
    local current_time=$(date +%s)
    local expire_time=$((current_time - 86400))  # 24å°æ—¶è¿‡æœŸ
    
    find "$ALERT_STATE_DIR" -name "*.state" -type f | while read state_file; do
        local last_alert_time=$(cat "$state_file" | cut -d',' -f1)
        
        if [ $last_alert_time -lt $expire_time ]; then
            rm -f "$state_file"
            log_message "æ¸…ç†è¿‡æœŸå‘Šè­¦çŠ¶æ€: $(basename "$state_file")"
        fi
    done
}

# æ™ºèƒ½å‘Šè­¦å‘é€å‡½æ•°
smart_alert() {
    local alert_key=$1
    local level=$2
    local title=$3
    local content=$4
    
    # ç”Ÿæˆå‘Šè­¦å”¯ä¸€æ ‡è¯†
    local alert_id=$(echo "$alert_key" | md5sum | cut -d' ' -f1)
    
    # æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘é€å‘Šè­¦
    if should_send_alert "$alert_id" "$level"; then
        send_notification "$level" "$title" "$content"
        log_message "æ™ºèƒ½å‘Šè­¦å·²å‘é€: $alert_key ($level)"
    else
        log_message "æ™ºèƒ½å‘Šè­¦è¢«æŠ‘åˆ¶: $alert_key"
    fi
}

# å®šæœŸæ¸…ç†è¿‡æœŸçŠ¶æ€
cleanup_alert_states

# ä½¿ç”¨ç¤ºä¾‹
# smart_alert "mysql_connection_failed" "CRITICAL" "MySQLè¿æ¥å¤±è´¥" "è¯¦ç»†é”™è¯¯ä¿¡æ¯..."
# smart_alert "disk_space_low" "WARNING" "ç£ç›˜ç©ºé—´ä¸è¶³" "å½“å‰ä½¿ç”¨ç‡: 85%"
```

### 7.3 å‘Šè­¦æ¨¡æ¿ç³»ç»Ÿ


**ğŸ“‹ æ ‡å‡†åŒ–å‘Šè­¦æ¨¡æ¿**
```javascript
// alert_templates.js - å‘Šè­¦æ¨¡æ¿ç³»ç»Ÿ

class AlertTemplateEngine {
    constructor() {
        this.templates = new Map();
        this.initializeTemplates();
    }
    
    // åˆå§‹åŒ–å‘Šè­¦æ¨¡æ¿
    initializeTemplates() {
        // è¿æ¥å¤±è´¥æ¨¡æ¿
        this.templates.set('connection_failed', {
            level: 'CRITICAL',
            title: 'MySQLæ•°æ®åº“è¿æ¥å¤±è´¥',
            template: `
æ•°æ®åº“è¿æ¥å¤±è´¥å‘Šè­¦

æœåŠ¡å™¨: {{hostname}}
æ•°æ®åº“: {{database}}
é”™è¯¯ä¿¡æ¯: {{error_message}}
å‘ç”Ÿæ—¶é—´: {{timestamp}}

å½±å“èŒƒå›´:
- åº”ç”¨ç¨‹åºå¯èƒ½æ— æ³•æ­£å¸¸è®¿é—®æ•°æ®åº“
- å¯èƒ½å¯¼è‡´ä¸šåŠ¡åŠŸèƒ½å¼‚å¸¸

å»ºè®®å¤„ç†æ­¥éª¤:
1. æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€: systemctl status mysql
2. æ£€æŸ¥ç½‘ç»œè¿æ¥: telnet {{host}} {{port}}
3. æ£€æŸ¥è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹MySQLé”™è¯¯æ—¥å¿—: tail -f /var/log/mysql/error.log
`
        });
        
        // ç£ç›˜ç©ºé—´ä¸è¶³æ¨¡æ¿
        this.templates.set('disk_space_low', {
            level: 'WARNING',
            title: 'æ•°æ®åº“ç£ç›˜ç©ºé—´ä¸è¶³',
            template: `
ç£ç›˜ç©ºé—´å‘Šè­¦

æœåŠ¡å™¨: {{hostname}}
æŒ‚è½½ç‚¹: {{mount_point}}
å½“å‰ä½¿ç”¨ç‡: {{usage_percent}}%
å‰©ä½™ç©ºé—´: {{free_space}}
æ€»ç©ºé—´: {{total_space}}
å‘ç”Ÿæ—¶é—´: {{timestamp}}

å½±å“è¯„ä¼°:
- æ•°æ®åº“å†™å…¥å¯èƒ½å—é™
- æ—¥å¿—æ–‡ä»¶å¯èƒ½åœæ­¢å†™å…¥
- ç³»ç»Ÿæ€§èƒ½å¯èƒ½ä¸‹é™

å»ºè®®å¤„ç†æªæ–½:
1. æ¸…ç†æ— ç”¨çš„æ—¥å¿—æ–‡ä»¶
2. åˆ é™¤è¿‡æœŸçš„å¤‡ä»½æ–‡ä»¶  
3. è€ƒè™‘æ‰©å±•ç£ç›˜å®¹é‡
4. ä¼˜åŒ–æ•°æ®å­˜å‚¨ç­–ç•¥
`
        });
        
        // æ…¢æŸ¥è¯¢å‘Šè­¦æ¨¡æ¿
        this.templates.set('slow_query_spike', {
            level: 'WARNING',
            title: 'æ…¢æŸ¥è¯¢æ•°é‡å¼‚å¸¸å¢é•¿',
            template: `
æ…¢æŸ¥è¯¢å‘Šè­¦

æœåŠ¡å™¨: {{hostname}}
å½“å‰æ…¢æŸ¥è¯¢æ•°: {{slow_query_count}}
å¢é•¿æ•°é‡: {{new_slow_queries}}
æ£€æµ‹æ—¶é—´: {{timestamp}}

TOPæ…¢æŸ¥è¯¢:
{{top_slow_queries}}

å»ºè®®ä¼˜åŒ–æªæ–½:
1. åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•
3. ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
4. è€ƒè™‘è°ƒæ•´slow_query_log_long_query_timeå‚æ•°
`
        });
        
        // å¤åˆ¶å»¶è¿Ÿå‘Šè­¦æ¨¡æ¿
        this.templates.set('replication_lag', {
            level: 'WARNING',
            title: 'MySQLä¸»ä»å¤åˆ¶å»¶è¿Ÿ',
            template: `
å¤åˆ¶å»¶è¿Ÿå‘Šè­¦

ä¸»æœåŠ¡å™¨: {{master_host}}
ä»æœåŠ¡å™¨: {{slave_host}}
å»¶è¿Ÿæ—¶é—´: {{lag_seconds}}ç§’
IOçº¿ç¨‹çŠ¶æ€: {{io_running}}
SQLçº¿ç¨‹çŠ¶æ€: {{sql_running}}
å‘ç”Ÿæ—¶é—´: {{timestamp}}

å¯èƒ½åŸå› :
- ç½‘ç»œå»¶è¿Ÿæˆ–ä¸ç¨³å®š
- ä»åº“æœåŠ¡å™¨æ€§èƒ½ä¸è¶³
- å¤§äº‹åŠ¡æˆ–DDLæ“ä½œ
- ä»åº“ç£ç›˜IOç“¶é¢ˆ

å¤„ç†å»ºè®®:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥è´¨é‡
2. æŸ¥çœ‹ä»åº“æœåŠ¡å™¨è´Ÿè½½
3. æ£€æŸ¥å¤åˆ¶é”™è¯¯æ—¥å¿—
4. è€ƒè™‘å¹¶è¡Œå¤åˆ¶é…ç½®
`
        });
    }
    
    // æ¸²æŸ“å‘Šè­¦æ¶ˆæ¯
    renderAlert(templateName, variables) {
        const template = this.templates.get(templateName);
        if (!template) {
            return {
                level: 'INFO',
                title: 'æœªçŸ¥å‘Šè­¦ç±»å‹',
                content: `å‘Šè­¦æ¨¡æ¿ ${templateName} ä¸å­˜åœ¨`
            };
        }
        
        let content = template.template;
        
        // æ›¿æ¢å˜é‡
        for (const [key, value] of Object.entries(variables)) {
            const placeholder = `{{${key}}}`;
            content = content.replace(new RegExp(placeholder, 'g'), value);
        }
        
        // æ·»åŠ é»˜è®¤å˜é‡
        content = content.replace(/{{timestamp}}/g, new Date().toLocaleString('zh-CN'));
        content = content.replace(/{{hostname}}/g, os.getenv('HOSTNAME') || 'unknown');
        
        return {
            level: template.level,
            title: template.title,
            content: content.trim()
        };
    }
    
    // å‘é€æ¨¡æ¿åŒ–å‘Šè­¦
    sendTemplatedAlert(templateName, variables = {}) {
        const alert = this.renderAlert(templateName, variables);
        
        // è¿™é‡Œè°ƒç”¨å®é™…çš„é€šçŸ¥å‘é€å‡½æ•°
        print(`å‘Šè­¦çº§åˆ«: ${alert.level}`);
        print(`å‘Šè­¦æ ‡é¢˜: ${alert.title}`);
        print(`å‘Šè­¦å†…å®¹:\n${alert.content}`);
        
        return alert;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
function demonstrateAlertTemplates() {
    const alertEngine = new AlertTemplateEngine();
    
    // è¿æ¥å¤±è´¥å‘Šè­¦
    alertEngine.sendTemplatedAlert('connection_failed', {
        database: 'production_db',
        error_message: 'Access denied for user \'app\'@\'localhost\'',
        host: 'localhost',
        port: '3306'
    });
    
    // ç£ç›˜ç©ºé—´å‘Šè­¦
    alertEngine.sendTemplatedAlert('disk_space_low', {
        mount_point: '/var/lib/mysql',
        usage_percent: '87',
        free_space: '2.1GB',
        total_space: '20GB'
    });
    
    // å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
    alertEngine.sendTemplatedAlert('replication_lag', {
        master_host: 'mysql-master.company.com',
        slave_host: 'mysql-slave.company.com',
        lag_seconds: '15',
        io_running: 'Yes',
        sql_running: 'Yes'
    });
}

// è¿è¡Œæ¼”ç¤º
demonstrateAlertTemplates();
```

---

## 8. ğŸ“ æ—¥å¿—è½®è½¬ç®¡ç†


### 8.1 MySQLæ—¥å¿—è½®è½¬ç­–ç•¥


**ğŸ”¸ æ—¥å¿—è½®è½¬çš„æ ¸å¿ƒæ¦‚å¿µ**
```
ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬ï¼Ÿ
å®šæœŸå°†å½“å‰æ—¥å¿—æ–‡ä»¶é‡å‘½åå¹¶åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿‡å¤§
é˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½ï¼Œæé«˜æ—¥å¿—æŸ¥çœ‹å’Œåˆ†ææ•ˆç‡

MySQLä¸»è¦æ—¥å¿—ç±»å‹ï¼š
â€¢ é”™è¯¯æ—¥å¿— (error log)
â€¢ æ…¢æŸ¥è¯¢æ—¥å¿— (slow query log)  
â€¢ äºŒè¿›åˆ¶æ—¥å¿— (binary log)
â€¢ ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿— (general log)
â€¢ ä¸­ç»§æ—¥å¿— (relay log)
```

**ğŸ’¡ logrotateé…ç½®æœ€ä½³å®è·µ**
```bash
# /etc/logrotate.d/mysql - MySQLæ—¥å¿—è½®è½¬é…ç½®

# é”™è¯¯æ—¥å¿—è½®è½¬
/var/log/mysql/error.log {
    daily                    # æ¯å¤©è½®è½¬
    missingok               # æ–‡ä»¶ä¸å­˜åœ¨ä¸æŠ¥é”™
    rotate 30               # ä¿ç•™30ä¸ªå†å²æ–‡ä»¶
    compress                # å‹ç¼©æ—§æ—¥å¿—
    delaycompress          # å»¶è¿Ÿå‹ç¼©ï¼ˆä¿ç•™æœ€æ–°ä¸€ä¸ªä¸å‹ç¼©ï¼‰
    notifempty             # ç©ºæ–‡ä»¶ä¸è½®è½¬
    create 0640 mysql mysql # åˆ›å»ºæ–°æ–‡ä»¶çš„æƒé™å’Œæ‰€æœ‰è€…
    postrotate
        # é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        if [ -f /var/run/mysqld/mysqld.pid ]; then
            /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf \
                flush-logs
        fi
    endscript
}

# æ…¢æŸ¥è¯¢æ—¥å¿—è½®è½¬
/var/log/mysql/slow.log {
    daily
    missingok
    rotate 15               # æ…¢æŸ¥è¯¢æ—¥å¿—ä¿ç•™15å¤©
    compress
    delaycompress
    notifempty
    create 0640 mysql mysql
    postrotate
        if [ -f /var/run/mysqld/mysqld.pid ]; then
            /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf \
                flush-logs
        fi
    endscript
}

# ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—è½®è½¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
/var/log/mysql/general.log {
    daily
    missingok
    rotate 7                # ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—åªä¿ç•™7å¤©
    compress
    delaycompress
    notifempty
    create 0640 mysql mysql
    postrotate
        if [ -f /var/run/mysqld/mysqld.pid ]; then
            /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf \
                flush-logs
        fi
    endscript
}
```

### 8.2 äºŒè¿›åˆ¶æ—¥å¿—è‡ªåŠ¨æ¸…ç†


**ğŸ”§ binlogæ™ºèƒ½æ¸…ç†è„šæœ¬**
```bash
#!/bin/bash
# binlog_cleanup.sh - äºŒè¿›åˆ¶æ—¥å¿—æ™ºèƒ½æ¸…ç†

# é…ç½®å‚æ•°
MYSQL_USER="admin"
MYSQL_PASS="admin_password"
MYSQL_HOST="localhost"
BINLOG_RETENTION_DAYS=7        # ä¿ç•™å¤©æ•°
MAX_BINLOG_SIZE_GB=10          # æœ€å¤§æ€»å¤§å°(GB)
MIN_FREE_SPACE_GB=5            # æœ€å°å‰©ä½™ç©ºé—´(GB)

# MySQLè¿æ¥å‘½ä»¤
MYSQL_CMD="mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST"

# è·å–äºŒè¿›åˆ¶æ—¥å¿—ä¿¡æ¯
get_binlog_info() {
    $MYSQL_CMD -e "SHOW BINARY LOGS" | tail -n +2 | while read log_name log_size; do
        echo "$log_name $log_size"
    done
}

# è®¡ç®—äºŒè¿›åˆ¶æ—¥å¿—æ€»å¤§å°
calculate_total_binlog_size() {
    local total_size=0
    
    get_binlog_info | while read log_name log_size; do
        total_size=$((total_size + log_size))
    done | tail -1
    
    echo $total_size
}

# è·å–æ•°æ®ç›®å½•å‰©ä½™ç©ºé—´
get_free_space_gb() {
    local data_dir=$($MYSQL_CMD -e "SELECT $$datadir" | tail -1)
    local free_space_kb=$(df "$data_dir" | tail -1 | awk '{print $4}')
    local free_space_gb=$((free_space_kb / 1024 / 1024))
    
    echo $free_space_gb
}

# åŸºäºæ—¶é—´çš„æ¸…ç†
cleanup_by_retention() {
    local retention_days=$1
    
    log_message "å¼€å§‹åŸºäºä¿ç•™å¤©æ•°($retention_dayså¤©)çš„æ¸…ç†"
    
    # è®¡ç®—æˆªæ­¢æ—¶é—´
    local cutoff_date=$(date -d "$retention_days days ago" '+%Y-%m-%d %H:%M:%S')
    
    # æ¸…ç†è¿‡æœŸçš„äºŒè¿›åˆ¶æ—¥å¿—
    $MYSQL_CMD -e "PURGE BINARY LOGS BEFORE '$cutoff_date'"
    
    if [ $? -eq 0 ]; then
        log_message "åŸºäºæ—¶é—´çš„äºŒè¿›åˆ¶æ—¥å¿—æ¸…ç†å®Œæˆ"
    else
        log_message "åŸºäºæ—¶é—´çš„äºŒè¿›åˆ¶æ—¥å¿—æ¸…ç†å¤±è´¥"
        return 1
    fi
}

# åŸºäºç©ºé—´çš„æ¸…ç†
cleanup_by_space() {
    local max_size_gb=$1
    local max_size_bytes=$((max_size_gb * 1024 * 1024 * 1024))
    
    log_message "å¼€å§‹åŸºäºç©ºé—´é™åˆ¶(${max_size_gb}GB)çš„æ¸…ç†"
    
    local current_size=$(calculate_total_binlog_size)
    
    if [ $current_size -le $max_size_bytes ]; then
        log_message "å½“å‰äºŒè¿›åˆ¶æ—¥å¿—å¤§å°($((current_size/1024/1024/1024))GB)æœªè¶…è¿‡é™åˆ¶"
        return 0
    fi
    
    # è·å–æœ€è€çš„æ—¥å¿—æ–‡ä»¶
    local oldest_log=$($MYSQL_CMD -e "SHOW BINARY LOGS" | tail -n +2 | head -1 | awk '{print $1}')
    
    if [ -n "$oldest_log" ]; then
        log_message "æ¸…ç†æœ€è€çš„äºŒè¿›åˆ¶æ—¥å¿—: $oldest_log"
        $MYSQL_CMD -e "PURGE BINARY LOGS TO '$oldest_log'"
        
        # é€’å½’æ£€æŸ¥ï¼Œç›´åˆ°å¤§å°æ»¡è¶³è¦æ±‚
        cleanup_by_space $max_size_gb
    fi
}

# ç´§æ€¥ç©ºé—´æ¸…ç†
emergency_cleanup() {
    local min_free_gb=$1
    local current_free=$(get_free_space_gb)
    
    if [ $current_free -lt $min_free_gb ]; then
        log_message "ç£ç›˜ç©ºé—´ä¸è¶³(${current_free}GB < ${min_free_gb}GB)ï¼Œå¼€å§‹ç´§æ€¥æ¸…ç†"
        
        # è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„äºŒè¿›åˆ¶æ—¥å¿—
        local current_binlog=$($MYSQL_CMD -e "SHOW MASTER STATUS" | tail -1 | awk '{print $1}')
        
        # æ¸…ç†é™¤å½“å‰æ–‡ä»¶å¤–çš„æ‰€æœ‰äºŒè¿›åˆ¶æ—¥å¿—
        if [ -n "$current_binlog" ]; then
            $MYSQL_CMD -e "PURGE BINARY LOGS TO '$current_binlog'"
            log_message "ç´§æ€¥æ¸…ç†å®Œæˆï¼Œä¿ç•™å½“å‰äºŒè¿›åˆ¶æ—¥å¿—: $current_binlog"
        fi
    fi
}

# ä¸»æ¸…ç†å‡½æ•°
main_cleanup() {
    log_message "å¼€å§‹äºŒè¿›åˆ¶æ—¥å¿—æ™ºèƒ½æ¸…ç†"
    
    # æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—æ˜¯å¦å¯ç”¨
    local binlog_enabled=$($MYSQL_CMD -e "SELECT $$log_bin" | tail -1)
    if [ "$binlog_enabled" != "1" ]; then
        log_message "äºŒè¿›åˆ¶æ—¥å¿—æœªå¯ç”¨ï¼Œè·³è¿‡æ¸…ç†"
        return 0
    fi
    
    # æ˜¾ç¤ºæ¸…ç†å‰çŠ¶æ€
    local total_size_before=$(calculate_total_binlog_size)
    local free_space_before=$(get_free_space_gb)
    
    log_message "æ¸…ç†å‰çŠ¶æ€:"
    log_message "  äºŒè¿›åˆ¶æ—¥å¿—æ€»å¤§å°: $((total_size_before/1024/1024/1024))GB"
    log_message "  ç£ç›˜å‰©ä½™ç©ºé—´: ${free_space_before}GB"
    
    # 1. ç´§æ€¥ç©ºé—´æ¸…ç†
    emergency_cleanup $MIN_FREE_SPACE_GB
    
    # 2. åŸºäºæ—¶é—´çš„å¸¸è§„æ¸…ç†
    cleanup_by_retention $BINLOG_RETENTION_DAYS
    
    # 3. åŸºäºå¤§å°çš„æ¸…ç†
    cleanup_by_space $MAX_BINLOG_SIZE_GB
    
    # æ˜¾ç¤ºæ¸…ç†åçŠ¶æ€
    local total_size_after=$(calculate_total_binlog_size)
    local free_space_after=$(get_free_space_gb)
    
    log_message "æ¸…ç†åçŠ¶æ€:"
    log_message "  äºŒè¿›åˆ¶æ—¥å¿—æ€»å¤§å°: $((total_size_after/1024/1024/1024))GB"
    log_message "  ç£ç›˜å‰©ä½™ç©ºé—´: ${free_space_after}GB"
    log_message "  èŠ‚çœç©ºé—´: $(((total_size_before-total_size_after)/1024/1024/1024))GB"
    
    log_message "äºŒè¿›åˆ¶æ—¥å¿—æ™ºèƒ½æ¸…ç†å®Œæˆ"
}

# æ‰§è¡Œæ¸…ç†
main_cleanup "$@"
```

### 8.3 è‡ªåŠ¨åŒ–æ—¥å¿—åˆ†æ


**ğŸ“Š æ—¥å¿—åˆ†æè‡ªåŠ¨åŒ–è„šæœ¬**
```javascript
// log_analyzer.js - è‡ªåŠ¨åŒ–æ—¥å¿—åˆ†æè„šæœ¬

class MySQLLogAnalyzer {
    constructor() {
        this.logPaths = {
            error: '/var/log/mysql/error.log',
            slow: '/var/log/mysql/slow.log',
            general: '/var/log/mysql/general.log'
        };
        this.patterns = this.initializePatterns();
    }
    
    // åˆå§‹åŒ–æ—¥å¿—åˆ†ææ¨¡å¼
    initializePatterns() {
        return {
            error_patterns: [
                { pattern: /\[ERROR\].*Access denied/, type: 'è®¤è¯å¤±è´¥', severity: 'HIGH' },
                { pattern: /\[ERROR\].*Can't connect to/, type: 'è¿æ¥å¤±è´¥', severity: 'HIGH' },
                { pattern: /\[ERROR\].*Table.*doesn't exist/, type: 'è¡¨ä¸å­˜åœ¨', severity: 'MEDIUM' },
                { pattern: /\[ERROR\].*Disk full/, type: 'ç£ç›˜æ»¡', severity: 'CRITICAL' },
                { pattern: /\[WARNING\].*slave.*lag/, type: 'å¤åˆ¶å»¶è¿Ÿ', severity: 'MEDIUM' }
            ],
            slow_patterns: [
                { pattern: /Query_time: (\d+\.\d+)/, type: 'æ‰§è¡Œæ—¶é—´', extract: 'time' },
                { pattern: /Lock_time: (\d+\.\d+)/, type: 'é”ç­‰å¾…æ—¶é—´', extract: 'lock_time' },
                { pattern: /Rows_examined: (\d+)/, type: 'æ‰«æè¡Œæ•°', extract: 'rows_examined' },
                { pattern: /Rows_sent: (\d+)/, type: 'è¿”å›è¡Œæ•°', extract: 'rows_sent' }
            ]
        };
    }
    
    // åˆ†æé”™è¯¯æ—¥å¿—
    analyzeErrorLog(timeRange = 24) {
        print(`åˆ†æè¿‡å» ${timeRange} å°æ—¶çš„é”™è¯¯æ—¥å¿—...`);
        
        try {
            const errorLog = os.loadTextFile(this.logPaths.error);
            const lines = errorLog.split('\n');
            
            const analysis = {
                total_errors: 0,
                error_types: {},
                critical_errors: [],
                timestamp: new Date().toISOString()
            };
            
            // è®¡ç®—æ—¶é—´èŒƒå›´
            const cutoffTime = new Date(Date.now() - timeRange * 60 * 60 * 1000);
            
            lines.forEach(line => {
                // ç®€åŒ–çš„æ—¶é—´æˆ³æå–ï¼ˆå®é™…éœ€è¦æ›´å¤æ‚çš„è§£æï¼‰
                if (this.isWithinTimeRange(line, cutoffTime)) {
                    this.patterns.error_patterns.forEach(pattern => {
                        if (pattern.pattern.test(line)) {
                            analysis.total_errors++;
                            
                            if (!analysis.error_types[pattern.type]) {
                                analysis.error_types[pattern.type] = 0;
                            }
                            analysis.error_types[pattern.type]++;
                            
                            if (pattern.severity === 'CRITICAL') {
                                analysis.critical_errors.push({
                                    type: pattern.type,
                                    message: line.substring(0, 200),
                                    severity: pattern.severity
                                });
                            }
                        }
                    });
                }
            });
            
            this.generateErrorReport(analysis);
            return analysis;
            
        } catch (error) {
            print(`åˆ†æé”™è¯¯æ—¥å¿—å¤±è´¥: ${error.message}`);
            return null;
        }
    }
    
    // åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
    analyzeSlowLog(limit = 10) {
        print(`åˆ†æTOP ${limit} æ…¢æŸ¥è¯¢...`);
        
        try {
            const session = mysql.getSession('monitor@localhost');
            
            // ä»performance_schemaè·å–æ…¢æŸ¥è¯¢ç»Ÿè®¡
            const slowQueries = session.sql(`
                SELECT 
                    TRUNCATE(SUM_TIMER_WAIT/1000000000000,6) as total_time,
                    COUNT_STAR as exec_count,
                    TRUNCATE(AVG_TIMER_WAIT/1000000000000,6) as avg_time,
                    TRUNCATE(MAX_TIMER_WAIT/1000000000000,6) as max_time,
                    TRUNCATE(SUM_ROWS_EXAMINED/COUNT_STAR,0) as avg_rows_examined,
                    TRUNCATE(SUM_ROWS_SENT/COUNT_STAR,0) as avg_rows_sent,
                    DIGEST_TEXT as query_text
                FROM performance_schema.events_statements_summary_by_digest 
                WHERE DIGEST_TEXT IS NOT NULL 
                AND SUM_TIMER_WAIT > 0
                ORDER BY SUM_TIMER_WAIT DESC 
                LIMIT ${limit}
            `).execute();
            
            const analysis = {
                timestamp: new Date().toISOString(),
                slow_queries: [],
                summary: {
                    total_analyzed: 0,
                    avg_execution_time: 0,
                    max_execution_time: 0,
                    queries_need_optimization: 0
                }
            };
            
            let totalTime = 0;
            let maxTime = 0;
            
            slowQueries.fetchAll().forEach((row, index) => {
                const queryInfo = {
                    rank: index + 1,
                    total_time: parseFloat(row[0]),
                    exec_count: parseInt(row[1]),
                    avg_time: parseFloat(row[2]),
                    max_time: parseFloat(row[3]),
                    avg_rows_examined: parseInt(row[4]),
                    avg_rows_sent: parseInt(row[5]),
                    query_text: row[6].substring(0, 200) + '...',
                    optimization_needed: parseFloat(row[2]) > 1.0 || parseInt(row[4]) > 10000
                };
                
                analysis.slow_queries.push(queryInfo);
                totalTime += queryInfo.total_time;
                maxTime = Math.max(maxTime, queryInfo.max_time);
                
                if (queryInfo.optimization_needed) {
                    analysis.summary.queries_need_optimization++;
                }
            });
            
            analysis.summary.total_analyzed = analysis.slow_queries.length;
            analysis.summary.avg_execution_time = analysis.summary.total_analyzed > 0 ? 
                (totalTime / analysis.summary.total_analyzed).toFixed(3) : 0;
            analysis.summary.max_execution_time = maxTime;
            
            this.generateSlowQueryReport(analysis);
            session.close();
            
            return analysis;
            
        } catch (error) {
            print(`åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—å¤±è´¥: ${error.message}`);
            return null;
        }
    }
    
    // ç”Ÿæˆé”™è¯¯æ—¥å¿—æŠ¥å‘Š
    generateErrorReport(analysis) {
        print('\n=== é”™è¯¯æ—¥å¿—åˆ†ææŠ¥å‘Š ===');
        print(`åˆ†ææ—¶é—´: ${analysis.timestamp}`);
        print(`æ€»é”™è¯¯æ•°: ${analysis.total_errors}`);
        
        if (analysis.total_errors > 0) {
            print('\né”™è¯¯ç±»å‹åˆ†å¸ƒ:');
            for (const [type, count] of Object.entries(analysis.error_types)) {
                print(`  ${type}: ${count} æ¬¡`);
            }
            
            if (analysis.critical_errors.length > 0) {
                print('\nä¸¥é‡é”™è¯¯:');
                analysis.critical_errors.forEach((error, index) => {
                    print(`  ${index + 1}. [${error.severity}] ${error.type}`);
                    print(`     ${error.message}`);
                });
            }
        } else {
            print('âœ… æœªå‘ç°é”™è¯¯è®°å½•');
        }
        
        print('\n');
    }
    
    // ç”Ÿæˆæ…¢æŸ¥è¯¢æŠ¥å‘Š
    generateSlowQueryReport(analysis) {
        print('\n=== æ…¢æŸ¥è¯¢åˆ†ææŠ¥å‘Š ===');
        print(`åˆ†ææ—¶é—´: ${analysis.timestamp}`);
        print(`åˆ†ææŸ¥è¯¢æ•°: ${analysis.summary.total_analyzed}`);
        print(`å¹³å‡æ‰§è¡Œæ—¶é—´: ${analysis.summary.avg_execution_time}ç§’`);
        print(`æœ€å¤§æ‰§è¡Œæ—¶é—´: ${analysis.summary.max_execution_time}ç§’`);
        print(`éœ€è¦ä¼˜åŒ–çš„æŸ¥è¯¢: ${analysis.summary.queries_need_optimization}`);
        
        if (analysis.slow_queries.length > 0) {
            print('\nTOPæ…¢æŸ¥è¯¢è¯¦æƒ…:');
            analysis.slow_queries.forEach(query => {
                print(`\n${query.rank}. æ€»è€—æ—¶: ${query.total_time}ç§’ | æ‰§è¡Œæ¬¡æ•°: ${query.exec_count}`);
                print(`   å¹³å‡è€—æ—¶: ${query.avg_time}ç§’ | å¹³å‡æ‰«æè¡Œæ•°: ${query.avg_rows_examined}`);
                print(`   ${query.optimization_needed ? 'âš ï¸  éœ€è¦ä¼˜åŒ–' : 'âœ… æ€§èƒ½æ­£å¸¸'}`);
                print(`   SQL: ${query.query_text}`);
            });
        }
        
        print('\n');
    }
    
    // æ£€æŸ¥æ—¶é—´èŒƒå›´ï¼ˆç®€åŒ–å®ç°ï¼‰
    isWithinTimeRange(logLine, cutoffTime) {
        // å®é™…å®ç°éœ€è¦è§£ææ—¥å¿—ä¸­çš„æ—¶é—´æˆ³
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾æ‰€æœ‰æ—¥å¿—éƒ½åœ¨æ—¶é—´èŒƒå›´å†…
        return true;
    }
    
    // ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š
    generateComprehensiveReport() {
        print('å¼€å§‹ç”ŸæˆMySQLç»¼åˆæ—¥å¿—åˆ†ææŠ¥å‘Š...\n');
        
        const errorAnalysis = this.analyzeErrorLog(24);
        const slowQueryAnalysis = this.analyzeSlowLog(20);
        
        // ç”Ÿæˆå»ºè®®
        print('=== ä¼˜åŒ–å»ºè®® ===');
        
        if (errorAnalysis && errorAnalysis.total_errors > 100) {
            print('ğŸ“ é”™è¯¯æ—¥å¿—å»ºè®®:');
            print('  - é”™è¯¯æ•°é‡è¿‡å¤šï¼Œå»ºè®®é‡ç‚¹å…³æ³¨è®¤è¯å¤±è´¥å’Œè¿æ¥å¤±è´¥');
            print('  - å®šæœŸæ£€æŸ¥åº”ç”¨ç¨‹åºçš„æ•°æ®åº“è¿æ¥é…ç½®');
        }
        
        if (slowQueryAnalysis && slowQueryAnalysis.summary.queries_need_optimization > 0) {
            print('ğŸ“ æ…¢æŸ¥è¯¢ä¼˜åŒ–å»ºè®®:');
            print('  - å‘ç°éœ€è¦ä¼˜åŒ–çš„æ…¢æŸ¥è¯¢ï¼Œå»ºè®®æ·»åŠ åˆé€‚çš„ç´¢å¼•');
            print('  - æ£€æŸ¥æŸ¥è¯¢è¯­å¥æ˜¯å¦å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–');
            print('  - è€ƒè™‘ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’');
        }
        
        if (slowQueryAnalysis && slowQueryAnalysis.summary.avg_execution_time > 2.0) {
            print('ğŸ“ æ€§èƒ½å»ºè®®:');
            print('  - å¹³å‡æŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå»ºè®®å…¨é¢æ£€æŸ¥æ•°æ®åº“æ€§èƒ½');
            print('  - æ£€æŸ¥æœåŠ¡å™¨ç¡¬ä»¶èµ„æºä½¿ç”¨æƒ…å†µ');
            print('  - è€ƒè™‘è°ƒæ•´MySQLé…ç½®å‚æ•°');
        }
        
        print('\næŠ¥å‘Šç”Ÿæˆå®Œæˆ!');
    }
}

// æ‰§è¡Œæ—¥å¿—åˆ†æ
function runLogAnalysis() {
    try {
        const analyzer = new MySQLLogAnalyzer();
        analyzer.generateComprehensiveReport();
        
    } catch (error) {
        print(`æ—¥å¿—åˆ†ææ‰§è¡Œå¤±è´¥: ${error.message}`);
    }
}

// è¿è¡Œåˆ†æ
runLogAnalysis();
```

---

## 9. ğŸ“ˆ æ€§èƒ½æ•°æ®æ”¶é›†


### 9.1 ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡æ”¶é›†


**ğŸ”¸ æ€§èƒ½æ•°æ®æ”¶é›†çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆè¦æ”¶é›†æ€§èƒ½æ•°æ®ï¼Ÿ
1. é—®é¢˜è¯Šæ–­ï¼šæ€§èƒ½é—®é¢˜çš„å†å²è¶‹åŠ¿åˆ†æ
2. å®¹é‡è§„åˆ’ï¼šé¢„æµ‹æœªæ¥èµ„æºéœ€æ±‚
3. ä¼˜åŒ–éªŒè¯ï¼šä¼˜åŒ–æªæ–½çš„æ•ˆæœè¯„ä¼°
4. åŸºçº¿å»ºç«‹ï¼šæ­£å¸¸æ€§èƒ½æ°´å¹³çš„å‚è€ƒæ ‡å‡†

æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼š
â€¢ QPS/TPSï¼šæŸ¥è¯¢å’Œäº‹åŠ¡å¤„ç†èƒ½åŠ›
â€¢ å“åº”æ—¶é—´ï¼šæŸ¥è¯¢æ‰§è¡Œå»¶è¿Ÿ
â€¢ è¿æ¥æ•°ï¼šå¹¶å‘è¿æ¥æƒ…å†µ  
â€¢ ç¼“å­˜å‘½ä¸­ç‡ï¼šå†…å­˜ä½¿ç”¨æ•ˆç‡
â€¢ ç£ç›˜IOï¼šå­˜å‚¨æ€§èƒ½ç“¶é¢ˆ
â€¢ é”ç­‰å¾…ï¼šå¹¶å‘å†²çªæƒ…å†µ
```

**ğŸ’¡ æ€§èƒ½æ•°æ®æ”¶é›†è„šæœ¬**
```javascript
// performance_collector.js - æ€§èƒ½æ•°æ®æ”¶é›†å™¨

class PerformanceCollector {
    constructor(session) {
        this.session = session;
        this.startTime = Date.now();
        this.lastCollection = new Map();
    }
    
    // æ”¶é›†åŸºç¡€ç³»ç»ŸæŒ‡æ ‡
    collectSystemMetrics() {
        const metrics = {
            timestamp: new Date().toISOString(),
            uptime: null,
            version: null,
            connections: {},
            queries: {},
            innodb: {},
            threads: {},
            memory: {}
        };
        
        // MySQLç‰ˆæœ¬å’Œè¿è¡Œæ—¶é—´
        const basicInfo = this.session.sql(`
            SELECT 
                $$version as version,
                $$version_comment as version_comment,
                $$uptime as uptime
        `).execute().fetchOne();
        
        metrics.version = basicInfo[0];
        metrics.uptime = parseInt(basicInfo[2]);
        
        // è¿æ¥ç»Ÿè®¡
        const connectionStats = this.session.sql(`
            SELECT 
                VARIABLE_NAME, VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME IN (
                'Threads_connected', 'Threads_running', 'Max_used_connections',
                'Connections', 'Aborted_connects'
            )
        `).execute();
        
        connectionStats.fetchAll().forEach(row => {
            const key = row[0].toLowerCase().replace('_', '');
            metrics.connections[key] = parseInt(row[1]);
        });
        
        // æŸ¥è¯¢ç»Ÿè®¡
        const queryStats = this.session.sql(`
            SELECT 
                VARIABLE_NAME, VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME IN (
                'Com_select', 'Com_insert', 'Com_update', 'Com_delete',
                'Questions', 'Queries', 'Slow_queries'
            )
        `).execute();
        
        queryStats.fetchAll().forEach(row => {
            const key = row[0].toLowerCase().replace('com_', '').replace('_', '');
            metrics.queries[key] = parseInt(row[1]);
        });
        
        return metrics;
    }
    
    // æ”¶é›†InnoDBè¯¦ç»†æŒ‡æ ‡
    collectInnoDBMetrics() {
        const innodbMetrics = {
            timestamp: new Date().toISOString(),
            buffer_pool: {},
            io: {},
            locks: {},
            transactions: {}
        };
        
        // ç¼“å†²æ± ç»Ÿè®¡
        const bufferPoolStats = this.session.sql(`
            SELECT 
                VARIABLE_NAME, VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME LIKE 'Innodb_buffer_pool_%'
        `).execute();
        
        bufferPoolStats.fetchAll().forEach(row => {
            const key = row[0].replace('Innodb_buffer_pool_', '').toLowerCase();
            const value = isNaN(row[1]) ? row[1] : parseInt(row[1]);
            innodbMetrics.buffer_pool[key] = value;
        });
        
        // IOç»Ÿè®¡
        const ioStats = this.session.sql(`
            SELECT 
                VARIABLE_NAME, VARIABLE_VALUE
            FROM performance_schema.global_status 
            WHERE VARIABLE_NAME LIKE 'Innodb_data_%' 
            OR VARIABLE_NAME LIKE 'Innodb_os_%'
        `).execute();
        
        ioStats.fetchAll().forEach(row => {
            const key = row[0].replace('Innodb_', '').toLowerCase();
            innodbMetrics.io[key] = parseInt(row[1]);
        });
        
        return innodbMetrics;
    }
    
    // æ”¶é›†é”ç­‰å¾…ç»Ÿè®¡
    collectLockMetrics() {
        try {
            const lockStats = this.session.sql(`
                SELECT 
                    COUNT(*) as waiting_locks,
                    COALESCE(AVG(TIMER_WAIT/1000000000), 0) as avg_wait_time_ms
                FROM performance_schema.events_waits_current 
                WHERE EVENT_NAME LIKE '%lock%' 
                AND TIMER_WAIT IS NOT NULL
            `).execute().fetchOne();
            
            return {
                timestamp: new Date().toISOString(),
                waiting_locks: parseInt(lockStats[0]),
                avg_wait_time_ms: parseFloat(lockStats[1]).toFixed(2)
            };
            
        } catch (error) {
            return {
                timestamp: new Date().toISOString(),
                waiting_locks: 0,
                avg_wait_time_ms: 0,
                error: error.message
            };
        }
    }
    
    // æ”¶é›†TOPæŸ¥è¯¢ç»Ÿè®¡
    collectTopQueries(limit = 10) {
        try {
            const topQueries = this.session.sql(`
                SELECT 
                    DIGEST_TEXT,
                    COUNT_STAR as exec_count,
                    TRUNCATE(SUM_TIMER_WAIT/1000000000000, 6) as total_time_sec,
                    TRUNCATE(AVG_TIMER_WAIT/1000000000000, 6) as avg_time_sec,
                    TRUNCATE(SUM_ROWS_EXAMINED/COUNT_STAR, 0) as avg_rows_examined,
                    TRUNCATE(SUM_ROWS_SENT/COUNT_STAR, 0) as avg_rows_sent
                FROM performance_schema.events_statements_summary_by_digest 
                WHERE DIGEST_TEXT IS NOT NULL 
                ORDER BY SUM_TIMER_WAIT DESC 
                LIMIT ${limit}
            `).execute();
            
            const queries = [];
            topQueries.fetchAll().forEach(row => {
                queries.push({
                    digest: row[0].substring(0, 100) + '...',
                    exec_count: parseInt(row[1]),
                    total_time: parseFloat(row[2]),
                    avg_time: parseFloat(row[3]),
                    avg_rows_examined: parseInt(row[4]),
                    avg_rows_sent: parseInt(row[5])
                });
            });
            
            return {
                timestamp: new Date().toISOString(),
                top_queries: queries
            };
            
        } catch (error) {
            return {
                timestamp: new Date().toISOString(),
                top_queries: [],
                error: error.message
            };
        }
    }
    
    // è®¡ç®—QPS/TPS
    calculateThroughput(currentMetrics) {
        const current = currentMetrics.queries;
        const last = this.lastCollection.get('queries') || {};
        const lastTime = this.lastCollection.get('timestamp') || this.startTime;
        
        const timeInterval = (Date.now() - lastTime) / 1000; // ç§’
        
        if (timeInterval > 0 && Object.keys(last).length > 0) {
            const qps = {
                select: ((current.select || 0) - (last.select || 0)) / timeInterval,
                insert: ((current.insert || 0) - (last.insert || 0)) / timeInterval,
                update: ((current.update || 0) - (last.update || 0)) / timeInterval,
                delete: ((current.delete || 0) - (last.delete || 0)) / timeInterval,
                total: ((current.questions || 0) - (last.questions || 0)) / timeInterval
            };
            
            return {
                timestamp: new Date().toISOString(),
                qps: qps,
                interval_seconds: timeInterval.toFixed(1)
            };
        }
        
        return {
            timestamp: new Date().toISOString(),
            qps: { select: 0, insert: 0, update: 0, delete: 0, total: 0 },
            interval_seconds: 0,
            note: 'First collection, no baseline for calculation'
        };
    }
    
    // ç”Ÿæˆæ€§èƒ½æ‘˜è¦
    generatePerformanceSummary() {
        print('å¼€å§‹æ”¶é›†MySQLæ€§èƒ½æ•°æ®...\n');
        
        const systemMetrics = this.collectSystemMetrics();
        const innodbMetrics = this.collectInnoDBMetrics();
        const lockMetrics = this.collectLockMetrics();
        const topQueries = this.collectTopQueries(5);
        const throughput = this.calculateThroughput(systemMetrics);
        
        // ä¿å­˜å½“å‰æŒ‡æ ‡ç”¨äºä¸‹æ¬¡è®¡ç®—
        this.lastCollection.set('queries', systemMetrics.queries);
        this.lastCollection.set('timestamp', Date.now());
        
        // ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        print('=== MySQLæ€§èƒ½æ•°æ®æ‘˜è¦ ===');
        print(`æ”¶é›†æ—¶é—´: ${systemMetrics.timestamp}`);
        print(`MySQLç‰ˆæœ¬: ${systemMetrics.version}`);
        print(`è¿è¡Œæ—¶é—´: ${Math.floor(systemMetrics.uptime / 86400)}å¤© ${Math.floor((systemMetrics.uptime % 86400) / 3600)}å°æ—¶`);
        
        print('\nğŸ“Š è¿æ¥ç»Ÿè®¡:');
        print(`  å½“å‰è¿æ¥æ•°: ${systemMetrics.connections.threadsconnected}`);
        print(`  æ´»è·ƒè¿æ¥æ•°: ${systemMetrics.connections.threadsrunning}`);
        print(`  å†å²æœ€å¤§è¿æ¥æ•°: ${systemMetrics.connections.maxusedconnections}`);
        print(`  è¿æ¥ä¸­æ–­æ•°: ${systemMetrics.connections.abortedconnects}`);
        
        print('\nâš¡ æŸ¥è¯¢ååé‡ (QPS):');
        print(`  æ€»QPS: ${throughput.qps.total.toFixed(1)}`);
        print(`  SELECT: ${throughput.qps.select.toFixed(1)}`);
        print(`  INSERT: ${throughput.qps.insert.toFixed(1)}`);
        print(`  UPDATE: ${throughput.qps.update.toFixed(1)}`);
        print(`  DELETE: ${throughput.qps.delete.toFixed(1)}`);
        print(`  æ…¢æŸ¥è¯¢æ€»æ•°: ${systemMetrics.queries.slowqueries}`);
        
        print('\nğŸ’¾ InnoDBç¼“å†²æ± :');
        if (innodbMetrics.buffer_pool.pages_total) {
            const hitRate = innodbMetrics.buffer_pool.read_requests > 0 ? 
                ((innodbMetrics.buffer_pool.read_requests - innodbMetrics.buffer_pool.reads) / 
                 innodbMetrics.buffer_pool.read_requests * 100).toFixed(2) : 0;
                 
            const usageRate = ((innodbMetrics.buffer_pool.pages_total - innodbMetrics.buffer_pool.pages_free) / 
                              innodbMetrics.buffer_pool.pages_total * 100).toFixed(1);
                              
            print(`  ç¼“å†²æ± ä½¿ç”¨ç‡: ${usageRate}%`);
            print(`  ç¼“å†²æ± å‘½ä¸­ç‡: ${hitRate}%`);
            print(`  è„é¡µæ•°é‡: ${innodbMetrics.buffer_pool.pages_dirty}`);
        }
        
        print('\nğŸ”’ é”ç­‰å¾…ç»Ÿè®¡:');
        print(`  ç­‰å¾…é”æ•°é‡: ${lockMetrics.waiting_locks}`);
        print(`  å¹³å‡ç­‰å¾…æ—¶é—´: ${lockMetrics.avg_wait_time_ms}ms`);
        
        if (topQueries.top_queries.length > 0) {
            print('\nğŸŒ TOP 5 æŸ¥è¯¢:');
            topQueries.top_queries.forEach((query, index) => {
                print(`  ${index + 1}. æ‰§è¡Œæ¬¡æ•°: ${query.exec_count} | å¹³å‡è€—æ—¶: ${query.avg_time}s`);
                print(`     å¹³å‡æ‰«æè¡Œæ•°: ${query.avg_rows_examined} | SQL: ${query.digest}`);
            });
        }
        
        print('\nâœ… æ€§èƒ½æ•°æ®æ”¶é›†å®Œæˆ');
        
        return {
            system: systemMetrics,
            innodb: innodbMetrics,
            locks: lockMetrics,
            queries: topQueries,
            throughput: throughput
        };
    }
}

// æ‰§è¡Œæ€§èƒ½æ•°æ®æ”¶é›†
function collectPerformanceData() {
    try {
        const session = mysql.getSession('monitor@localhost');
        const collector = new PerformanceCollector(session);
        
        const performanceData = collector.generatePerformanceSummary();
        
        session.close();
        return performanceData;
        
    } catch (error) {
        print(`æ€§èƒ½æ•°æ®æ”¶é›†å¤±è´¥: ${error.message}`);
        return null;
    }
}

// è¿è¡Œæ”¶é›†
collectPerformanceData();
```

### 9.2 å†å²æ•°æ®å­˜å‚¨å’Œè¶‹åŠ¿åˆ†æ


**ğŸ“Š æ€§èƒ½æ•°æ®å­˜å‚¨æ–¹æ¡ˆ**
```bash
#!/bin/bash
# performance_history.sh - æ€§èƒ½æ•°æ®å†å²å­˜å‚¨

# é…ç½®
PERF_DATA_DIR="/var/lib/mysql/performance_data"
RETENTION_DAYS=90
CSV_FILE="$PERF_DATA_DIR/mysql_performance.csv"

# åˆ›å»ºå­˜å‚¨ç›®å½•
mkdir -p "$PERF_DATA_DIR"

# åˆå§‹åŒ–CSVå¤´éƒ¨
initialize_csv() {
    if [ ! -f "$CSV_FILE" ]; then
        cat > "$CSV_FILE" << EOF
timestamp,qps_total,qps_select,qps_insert,qps_update,qps_delete,connections_current,connections_running,slow_queries,buffer_pool_hit_rate,buffer_pool_usage,lock_waits,avg_lock_wait_time
EOF
        log_message "åˆå§‹åŒ–æ€§èƒ½æ•°æ®CSVæ–‡ä»¶: $CSV_FILE"
    fi
}

# æ”¶é›†å¹¶å­˜å‚¨æ€§èƒ½æ•°æ®
collect_and_store() {
    log_message "å¼€å§‹æ”¶é›†æ€§èƒ½æ•°æ®"
    
    # æ‰§è¡ŒMySQL Shellæ€§èƒ½æ”¶é›†è„šæœ¬
    local perf_data=$(mysqlsh --file=/opt/mysql/scripts/performance_collector.js --json 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        log_message "æ€§èƒ½æ•°æ®æ”¶é›†å¤±è´¥"
        return 1
    fi
    
    # è§£æJSONæ•°æ®å¹¶å†™å…¥CSV (ç®€åŒ–å®ç°)
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local csv_line="$timestamp,0,0,0,0,0,0,0,0,0,0,0,0"
    
    # å®é™…å®ç°éœ€è¦è§£æJSONæ•°æ®
    echo "$csv_line" >> "$CSV_FILE"
    
    log_message "æ€§èƒ½æ•°æ®å·²å­˜å‚¨åˆ°: $CSV_FILE"
}

# ç”Ÿæˆè¶‹åŠ¿åˆ†ææŠ¥å‘Š
generate_trend_report() {
    local days=${1:-7}
    local report_file="$PERF_DATA_DIR/trend_report_$(date +%Y%m%d).txt"
    
    log_message "ç”Ÿæˆè¿‡å» $days å¤©çš„è¶‹åŠ¿åˆ†ææŠ¥å‘Š"
    
    # ä½¿ç”¨awkåˆ†æCSVæ•°æ®
    cat > "$report_file" << EOF
MySQLæ€§èƒ½è¶‹åŠ¿åˆ†ææŠ¥å‘Š
ç”Ÿæˆæ—¶é—´: $(date)
åˆ†æå‘¨æœŸ: è¿‡å» $days å¤©

=== QPSè¶‹åŠ¿åˆ†æ ===
EOF
    
    # è®¡ç®—QPSå¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼
    tail -n $((days * 24 * 12)) "$CSV_FILE" | awk -F',' '
    BEGIN { 
        sum=0; count=0; max=0; min=999999;
    }
    NR > 1 { 
        if($2 > 0) {
            sum+=$2; count++; 
            if($2>max) max=$2; 
            if($2<min) min=$2;
        }
    }
    END { 
        if(count>0) {
            printf "å¹³å‡QPS: %.1f\n", sum/count;
            printf "æœ€å¤§QPS: %.1f\n", max;
            printf "æœ€å°QPS: %.1f\n", min;
        }
    }' >> "$report_file"
    
    # ç±»ä¼¼åœ°åˆ†æå…¶ä»–æŒ‡æ ‡...
    
    log_message "è¶‹åŠ¿åˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# æ¸…ç†è¿‡æœŸæ•°æ®
cleanup_old_data() {
    local cutoff_date=$(date -d "$RETENTION_DAYS days ago" '+%Y-%m-%d')
    
    log_message "æ¸…ç† $cutoff_date ä¹‹å‰çš„æ€§èƒ½æ•°æ®"
    
    # å¤‡ä»½åŸæ–‡ä»¶
    cp "$CSV_FILE" "$CSV_FILE.backup"
    
    # ä¿ç•™å¤´éƒ¨å’Œæœ€è¿‘çš„æ•°æ®
    head -1 "$CSV_FILE" > "$CSV_FILE.tmp"
    awk -F',' -v cutoff="$cutoff_date" '
        NR > 1 && $1 >= cutoff { print }
    ' "$CSV_FILE" >> "$CSV_FILE.tmp"
    
    mv "$CSV_FILE.tmp" "$CSV_FILE"
    
    local remaining_lines=$(wc -l < "$CSV_FILE")
    log_message "æ¸…ç†å®Œæˆï¼Œå‰©ä½™ $((remaining_lines - 1)) æ¡è®°å½•"
}

# ä¸»å‡½æ•°
main() {
    initialize_csv
    collect_and_store
    
    # æ¯å¤©ç”Ÿæˆä¸€æ¬¡è¶‹åŠ¿æŠ¥å‘Š
    if [ $(date +%H) -eq 1 ]; then
        generate_trend_report 7
        cleanup_old_data
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

---

## 10. ğŸ”§ è¿ç»´å·¥å…·é›†æˆ


### 10.1 ä¸ä¸»æµè¿ç»´å·¥å…·é›†æˆ


**ğŸ”¸ é›†æˆçš„æ ¸å¿ƒä»·å€¼**
```
ä¸ºä»€ä¹ˆè¦é›†æˆè¿ç»´å·¥å…·ï¼Ÿ
1. ç»Ÿä¸€ç®¡ç†ï¼šé¿å…å·¥å…·å­¤å²›ï¼Œç»Ÿä¸€è¿ç»´å…¥å£
2. è‡ªåŠ¨åŒ–ç¼–æ’ï¼šå®ç°å¤æ‚è¿ç»´æµç¨‹çš„è‡ªåŠ¨åŒ–
3. å¯è§†åŒ–ç›‘æ§ï¼šå›¾å½¢åŒ–å±•ç¤ºæ•°æ®åº“çŠ¶æ€å’Œæ€§èƒ½
4. å‘Šè­¦è”åŠ¨ï¼šä¸ç°æœ‰å‘Šè­¦ç³»ç»Ÿæ— ç¼å¯¹æ¥
5. æ•°æ®å…±äº«ï¼šè¿ç»´æ•°æ®åœ¨ä¸åŒå·¥å…·é—´æµé€š

å¸¸è§é›†æˆåœºæ™¯ï¼š
â€¢ Prometheus + Grafana ç›‘æ§é›†æˆ
â€¢ Ansible è‡ªåŠ¨åŒ–éƒ¨ç½²é›†æˆ
â€¢ Zabbix ç›‘æ§å‘Šè­¦é›†æˆ
â€¢ ELK æ—¥å¿—åˆ†æé›†æˆ
â€¢ Kubernetes å®¹å™¨ç¼–æ’é›†æˆ
```

**ğŸ’¡ Prometheusé›†æˆç¤ºä¾‹**
```bash
#!/bin/bash
# prometheus_exporter.sh - Prometheus MySQLå¯¼å‡ºå™¨

# MySQL Exporteré…ç½®
MYSQL_EXPORTER="/usr/local/bin/mysqld_exporter"
MYSQL_USER="prometheus"
MYSQL_PASS="prometheus_password"
EXPORTER_PORT="9104"
CONFIG_FILE="/etc/mysql/prometheus.cnf"

# åˆ›å»ºMySQL Exporteré…ç½®æ–‡ä»¶
create_exporter_config() {
    cat > "$CONFIG_FILE" << EOF
[client]
host=localhost
port=3306
user=${MYSQL_USER}
password=${MYSQL_PASS}
EOF
    
    chmod 600 "$CONFIG_FILE"
    chown mysql:mysql "$CONFIG_FILE"
    
    log_message "MySQL Exporteré…ç½®æ–‡ä»¶å·²åˆ›å»º: $CONFIG_FILE"
}

# åˆ›å»ºPrometheusç”¨æˆ·
create_prometheus_user() {
    local create_user_sql=$(cat <<EOF
CREATE USER IF NOT EXISTS 'prometheus'@'localhost' IDENTIFIED BY '${MYSQL_PASS}';
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'prometheus'@'localhost';
GRANT SELECT ON performance_schema.* TO 'prometheus'@'localhost';
FLUSH PRIVILEGES;
EOF
)
    
    echo "$create_user_sql" | mysql -u root -p
    
    if [ $? -eq 0 ]; then
        log_message "Prometheusç”¨æˆ·åˆ›å»ºæˆåŠŸ"
    else
        log_message "Prometheusç”¨æˆ·åˆ›å»ºå¤±è´¥"
        return 1
    fi
}

# å¯åŠ¨MySQL Exporter
start_exporter() {
    if pgrep -f mysqld_exporter > /dev/null; then
        log_message "MySQL Exporterå·²åœ¨è¿è¡Œ"
        return 0
    fi
    
    log_message "å¯åŠ¨MySQL Exporter..."
    
    nohup "$MYSQL_EXPORTER" \
        --config.my-cnf="$CONFIG_FILE" \
        --web.listen-address="0.0.0.0:$EXPORTER_PORT" \
        --collect.info_schema.processlist \
        --collect.info_schema.tables \
        --collect.info_schema.innodb_metrics \
        --collect.info_schema.innodb_cmp \
        --collect.info_schema.innodb_cmpmem \
        --collect.perf_schema.file_events \
        --collect.perf_schema.eventswaits \
        > /var/log/mysql/exporter.log 2>&1 &
    
    sleep 3
    
    if pgrep -f mysqld_exporter > /dev/null; then
        log_message "MySQL Exporterå¯åŠ¨æˆåŠŸï¼Œç«¯å£: $EXPORTER_PORT"
    else
        log_message "MySQL Exporterå¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# æµ‹è¯•Exporter
test_exporter() {
    local test_url="http://localhost:$EXPORTER_PORT/metrics"
    
    log_message "æµ‹è¯•MySQL Exporter: $test_url"
    
    if curl -s "$test_url" | head -10 | grep -q "mysql_"; then
        log_message "MySQL Exporteræµ‹è¯•æˆåŠŸ"
        
        # æ˜¾ç¤ºéƒ¨åˆ†æŒ‡æ ‡
        echo "éƒ¨åˆ†å¯ç”¨æŒ‡æ ‡:"
        curl -s "$test_url" | grep "mysql_global_status_connections" | head -5
    else
        log_message "MySQL Exporteræµ‹è¯•å¤±è´¥"
        return 1
    fi
}

# ç”ŸæˆGrafanaä»ªè¡¨æ¿é…ç½®
generate_grafana_dashboard() {
    local dashboard_file="/tmp/mysql_dashboard.json"
    
    cat > "$dashboard_file" << 'EOF'
{
  "dashboard": {
    "title": "MySQL Performance Dashboard",
    "panels": [
      {
        "title": "QPS (Queries Per Second)",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mysql_global_status_questions[5m])",
            "legendFormat": "QPS"
          }
        ]
      },
      {
        "title": "Connection Count",
        "type": "graph", 
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected",
            "legendFormat": "Connected"
          }
        ]
      },
      {
        "title": "InnoDB Buffer Pool Hit Rate",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(mysql_global_status_innodb_buffer_pool_read_requests[5m]) / (rate(mysql_global_status_innodb_buffer_pool_read_requests[5m]) + rate(mysql_global_status_innodb_buffer_pool_reads[5m])) * 100",
            "legendFormat": "Hit Rate %"
          }
        ]
      }
    ]
  }
}
EOF
    
    log_message "Grafanaä»ªè¡¨æ¿é…ç½®å·²ç”Ÿæˆ: $dashboard_file"
    echo "è¯·å°†æ­¤æ–‡ä»¶å¯¼å…¥åˆ°Grafanaä¸­"
}

# ä¸»å‡½æ•°
main() {
    log_message "å¼€å§‹MySQL Prometheusé›†æˆé…ç½®"
    
    create_prometheus_user
    create_exporter_config
    start_exporter
    test_exporter
    generate_grafana_dashboard
    
    log_message "MySQL Prometheusé›†æˆé…ç½®å®Œæˆ"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 10.2 Ansibleè‡ªåŠ¨åŒ–é›†æˆ


**ğŸ”§ Ansible Playbookç¤ºä¾‹**
```yaml
# mysql_automation.yml - MySQLè‡ªåŠ¨åŒ–è¿ç»´Playbook

---
- name: MySQL Database Automation Tasks
  hosts: mysql_servers
  become: yes
  vars:
    mysql_user: "automation"
    mysql_password: "{{ vault_mysql_password }}"
    backup_dir: "/backup/mysql"
    log_dir: "/var/log/mysql"
    
  tasks:
    # å¥åº·æ£€æŸ¥ä»»åŠ¡
    - name: Check MySQL Service Status
      service:
        name: mysql
        state: started
      register: mysql_status
      
    - name: Verify MySQL Connectivity
      mysql_db:
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
        name: information_schema
        state: present
      register: mysql_connectivity
      
    # å¤‡ä»½ä»»åŠ¡
    - name: Create Backup Directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: mysql
        group: mysql
        mode: '0755'
        
    - name: Execute Database Backup
      shell: |
        mysqlsh --user={{ mysql_user }} --password={{ mysql_password }} \
          --file=/opt/mysql/scripts/backup_automation.js
      register: backup_result
      
    - name: Log Backup Result
      lineinfile:
        path: "{{ log_dir }}/automation.log"
        line: "{{ ansible_date_time.iso8601 }} [ANSIBLE] Backup completed: {{ backup_result.rc }}"
        create: yes
        
    # æ€§èƒ½ç›‘æ§ä»»åŠ¡
    - name: Collect Performance Metrics
      shell: |
        mysqlsh --user={{ mysql_user }} --password={{ mysql_password }} \
          --file=/opt/mysql/scripts/performance_collector.js
      register: perf_metrics
      
    # æ—¥å¿—åˆ†æä»»åŠ¡
    - name: Analyze MySQL Logs
      shell: |
        mysqlsh --user={{ mysql_user }} --password={{ mysql_password }} \
          --file=/opt/mysql/scripts/log_analyzer.js
      register: log_analysis
      
    # æ¸…ç†ä»»åŠ¡
    - name: Cleanup Old Logs
      find:
        paths: "{{ log_dir }}"
        age: 30d
        patterns: "*.log.*"
      register: old_logs
      
    - name: Remove Old Log Files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_logs.files }}"
      when: old_logs.files is defined
      
    # æŠ¥å‘Šç”Ÿæˆ
    - name: Generate Daily Report
      template:
        src: daily_report.j2
        dest: "{{ log_dir }}/daily_report_{{ ansible_date_time.date }}.txt"
      vars:
        mysql_status: "{{ mysql_status.state }}"
        backup_status: "{{ 'SUCCESS' if backup_result.rc == 0 else 'FAILED' }}"
        
  handlers:
    - name: restart mysql
      service:
        name: mysql
        state: restarted
        
    - name: send notification
      mail:
        to: "dba@company.com"
        subject: "MySQL Automation Report - {{ inventory_hostname }}"
        body: "MySQL automation tasks completed. Check logs for details."
```

### 10.3 å®¹å™¨åŒ–é›†æˆ


**ğŸ³ Dockeré›†æˆè„šæœ¬**
```bash
#!/bin/bash
# docker_mysql_automation.sh - DockeråŒ–MySQLè‡ªåŠ¨åŒ–

# Dockeré…ç½®
DOCKER_IMAGE="mysql:8.0"
CONTAINER_NAME="mysql-automation"
NETWORK_NAME="mysql-network"
VOLUME_DATA="mysql-data"
VOLUME_LOGS="mysql-logs"
VOLUME_BACKUP="mysql-backup"

# åˆ›å»ºDockerç½‘ç»œå’Œå·
setup_docker_environment() {
    log_message "è®¾ç½®Dockerç¯å¢ƒ"
    
    # åˆ›å»ºç½‘ç»œ
    if ! docker network ls | grep -q "$NETWORK_NAME"; then
        docker network create "$NETWORK_NAME"
        log_message "åˆ›å»ºDockerç½‘ç»œ: $NETWORK_NAME"
    fi
    
    # åˆ›å»ºå·
    for volume in "$VOLUME_DATA" "$VOLUME_LOGS" "$VOLUME_BACKUP"; do
        if ! docker volume ls | grep -q "$volume"; then
            docker volume create "$volume"
            log_message "åˆ›å»ºDockerå·: $volume"
        fi
    done
}

# å¯åŠ¨MySQLå®¹å™¨
start_mysql_container() {
    log_message "å¯åŠ¨MySQLå®¹å™¨"
    
    docker run -d \
        --name "$CONTAINER_NAME" \
        --network "$NETWORK_NAME" \
        -p 3306:3306 \
        -v "$VOLUME_DATA":/var/lib/mysql \
        -v "$VOLUME_LOGS":/var/log/mysql \
        -v "$VOLUME_BACKUP":/backup \
        -v "$(pwd)/scripts":/opt/mysql/scripts \
        -e MYSQL_ROOT_PASSWORD=root_password \
        -e MYSQL_DATABASE=testdb \
        -e MYSQL_USER=automation \
        -e MYSQL_PASSWORD=automation_password \
        --restart=unless-stopped \
        "$DOCKER_IMAGE" \
        --log-error=/var/log/mysql/error.log \
        --slow-query-log=1 \
        --slow-query-log-file=/var/log/mysql/slow.log \
        --long-query-time=1
        
    if [ $? -eq 0 ]; then
        log_message "MySQLå®¹å™¨å¯åŠ¨æˆåŠŸ"
    else
        log_message "MySQLå®¹å™¨å¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# åœ¨å®¹å™¨ä¸­æ‰§è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
execute_automation_in_container() {
    local script_name=$1
    
    log_message "åœ¨å®¹å™¨ä¸­æ‰§è¡Œè‡ªåŠ¨åŒ–è„šæœ¬: $script_name"
    
    docker exec -it "$CONTAINER_NAME" \
        mysqlsh --user=automation --password=automation_password \
        --file="/opt/mysql/scripts/$script_name"
        
    return $?
}

# å®¹å™¨å¥åº·æ£€æŸ¥
health_check_container() {
    log_message "æ‰§è¡Œå®¹å™¨å¥åº·æ£€æŸ¥"
    
    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
    local container_status=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_NAME" 2>/dev/null)
    
    if [ "$container_status" = "healthy" ]; then
        log_message "å®¹å™¨å¥åº·çŠ¶æ€: è‰¯å¥½"
    else
        log_message "å®¹å™¨å¥åº·çŠ¶æ€: å¼‚å¸¸ ($container_status)"
        
        # æŸ¥çœ‹å®¹å™¨æ—¥å¿—
        echo "æœ€è¿‘çš„å®¹å™¨æ—¥å¿—:"
        docker logs --tail=20 "$CONTAINER_NAME"
        
        return 1
    fi
    
    # æ£€æŸ¥MySQLè¿æ¥
    if execute_automation_in_container "health_check.js"; then
        log_message "MySQLè¿æ¥æ£€æŸ¥: æˆåŠŸ"
    else
        log_message "MySQLè¿æ¥æ£€æŸ¥: å¤±è´¥"
        return 1
    fi
}

# å¤‡ä»½å®¹å™¨æ•°æ®
backup_container_data() {
    local backup_name="mysql_backup_$(date +%Y%m%d_%H%M%S)"
    
    log_message "å¼€å§‹å®¹å™¨æ•°æ®å¤‡ä»½: $backup_name"
    
    # åˆ›å»ºæ•°æ®å·å¿«ç…§
    docker run --rm \
        -v "$VOLUME_DATA":/source:ro \
        -v "$VOLUME_BACKUP":/backup \
        alpine:latest \
        tar czf "/backup/$backup_name.tar.gz" -C /source .
        
    if [ $? -eq 0 ]; then
        log_message "å®¹å™¨æ•°æ®å¤‡ä»½å®Œæˆ: $backup_name.tar.gz"
    else
        log_message "å®¹å™¨æ•°æ®å¤‡ä»½å¤±è´¥"
        return 1
    fi
    
    # æ‰§è¡Œé€»è¾‘å¤‡ä»½
    execute_automation_in_container "backup_automation.js"
}

# ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨
monitor_container_resources() {
    log_message "ç›‘æ§å®¹å™¨èµ„æºä½¿ç”¨"
    
    # è·å–å®¹å™¨ç»Ÿè®¡ä¿¡æ¯
    local stats=$(docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}\t{{.BlockIO}}" "$CONTAINER_NAME")
    
    echo "å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ:"
    echo "$stats"
    
    # æ£€æŸ¥èµ„æºä½¿ç”¨æ˜¯å¦è¿‡é«˜
    local cpu_usage=$(echo "$stats" | tail -1 | awk '{print $2}' | sed 's/%//')
    local mem_usage=$(echo "$stats" | tail -1 | awk '{print $4}' | sed 's/%//')
    
    if (( $(echo "$cpu_usage > 80" | bc -l) )); then
        log_message "WARNING: CPUä½¿ç”¨ç‡è¿‡é«˜: ${cpu_usage}%"
    fi
    
    if (( $(echo "$mem_usage > 85" | bc -l) )); then
        log_message "WARNING: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${mem_usage}%"
    fi
}

# å®¹å™¨æ—¥å¿—ç®¡ç†
manage_container_logs() {
    log_message "ç®¡ç†å®¹å™¨æ—¥å¿—"
    
    # è½®è½¬Dockerå®¹å™¨æ—¥å¿—
    docker exec "$CONTAINER_NAME" /bin/bash -c "
        if [ -f /var/log/mysql/error.log ]; then
            logrotate -f /etc/logrotate.d/mysql
        fi
    "
    
    # æ¸…ç†è¿‡æœŸçš„Dockeræ—¥å¿—
    docker exec "$CONTAINER_NAME" find /var/log/mysql -name "*.log.*" -mtime +7 -delete
    
    log_message "å®¹å™¨æ—¥å¿—ç®¡ç†å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    local action=${1:-"all"}
    
    case "$action" in
        "setup")
            setup_docker_environment
            start_mysql_container
            ;;
        "health")
            health_check_container
            ;;
        "backup")
            backup_container_data
            ;;
        "monitor")
            monitor_container_resources
            ;;
        "logs")
            manage_container_logs
            ;;
        "all")
            health_check_container
            backup_container_data
            monitor_container_resources
            manage_container_logs
            ;;
        *)
            echo "ç”¨æ³•: $0 {setup|health|backup|monitor|logs|all}"
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è‡ªåŠ¨åŒ–åŸºç¡€ï¼šMySQL Shellçš„ä¸‰ç§è¿è¡Œæ¨¡å¼åŠå…¶åº”ç”¨åœºæ™¯
ğŸ”¸ è„šæœ¬ç¼–å†™ï¼šShellå’ŒJavaScriptç»“åˆçš„è‡ªåŠ¨åŒ–è„šæœ¬å¼€å‘
ğŸ”¸ æ‰¹å¤„ç†æ‰§è¡Œï¼šéäº¤äº’å¼æ‰§è¡Œæ¨¡å¼çš„é«˜æ•ˆè¿ç”¨
ğŸ”¸ å®šæ—¶ä»»åŠ¡ï¼šCronå’ŒSystemd Timerçš„é…ç½®ä¸ç®¡ç†
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå¤šç»´åº¦ç›‘æ§æŒ‡æ ‡æ”¶é›†å’Œæ™ºèƒ½å‘Šè­¦æœºåˆ¶
ğŸ”¸ å¤‡ä»½ç­–ç•¥ï¼šåŸºäºä¸šåŠ¡é‡è¦æ€§çš„å·®å¼‚åŒ–å¤‡ä»½æ–¹æ¡ˆ
ğŸ”¸ é€šçŸ¥æœºåˆ¶ï¼šå¤šæ¸ é“ã€åˆ†çº§åˆ«çš„å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ
ğŸ”¸ æ—¥å¿—ç®¡ç†ï¼šè½®è½¬ã€æ¸…ç†ã€åˆ†æçš„è‡ªåŠ¨åŒ–å¤„ç†
ğŸ”¸ æ€§èƒ½æ”¶é›†ï¼šå…³é”®æŒ‡æ ‡çš„æŒç»­ç›‘æ§å’Œè¶‹åŠ¿åˆ†æ
ğŸ”¸ å·¥å…·é›†æˆï¼šä¸ä¸»æµè¿ç»´å·¥å…·çš„æ— ç¼å¯¹æ¥
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è‡ªåŠ¨åŒ–çš„æ ¸å¿ƒä»·å€¼**
```
æ•ˆç‡æå‡ï¼š
- å‡å°‘é‡å¤æ€§æ‰‹å·¥æ“ä½œï¼Œé‡Šæ”¾è¿ç»´äººå‘˜æ—¶é—´
- æ ‡å‡†åŒ–æ“ä½œæµç¨‹ï¼Œé™ä½äººä¸ºé”™è¯¯é£é™©
- 24/7ä¸é—´æ–­ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜

å¯é æ€§ä¿éšœï¼š
- ä¸€è‡´æ€§çš„æ“ä½œæ‰§è¡Œï¼Œé¿å…æ“ä½œå·®å¼‚
- å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
- å¤šé‡éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿æ“ä½œå®‰å…¨æ€§
```

**ğŸ”¹ è„šæœ¬è®¾è®¡çš„æœ€ä½³å®è·µ**
```
å¥å£®æ€§è®¾è®¡ï¼š
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- èµ„æºå†²çªæ£€æµ‹å’Œé”æœºåˆ¶
- ä¼˜é›…çš„å¼‚å¸¸æ¢å¤å’Œæ¸…ç†

å¯ç»´æŠ¤æ€§ï¼š
- æ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ³¨é‡Š
- å¯é…ç½®çš„å‚æ•°å’Œç¯å¢ƒé€‚é…
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•
```

**ğŸ”¹ ç›‘æ§å‘Šè­¦çš„æ™ºèƒ½åŒ–**
```
åˆ†çº§å‘Šè­¦ç­–ç•¥ï¼š
- æ ¹æ®é—®é¢˜ä¸¥é‡ç¨‹åº¦é€‰æ‹©é€šçŸ¥æ¸ é“
- å‘Šè­¦æŠ‘åˆ¶æœºåˆ¶é˜²æ­¢å‘Šè­¦é£æš´
- å‡çº§æœºåˆ¶ç¡®ä¿é‡è¦é—®é¢˜å¾—åˆ°å…³æ³¨

æ•°æ®é©±åŠ¨å†³ç­–ï¼š
- åŸºäºå†å²æ•°æ®çš„é˜ˆå€¼è®¾å®š
- è¶‹åŠ¿åˆ†æé¢„æµ‹æ½œåœ¨é—®é¢˜
- æ€§èƒ½åŸºçº¿å»ºç«‹å’Œåå·®æ£€æµ‹
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ç›‘æ§æŒ‡æ ‡ä¼˜å…ˆçº§**
```
ğŸ”´ å…³é”®æŒ‡æ ‡ï¼ˆå¿…é¡»ç›‘æ§ï¼‰ï¼š
- æ•°æ®åº“è¿æ¥çŠ¶æ€å’Œè¿æ¥æ•°
- ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡
- å¤åˆ¶å»¶è¿Ÿï¼ˆä¸»ä»ç¯å¢ƒï¼‰
- ä¸¥é‡é”™è¯¯å’Œå¼‚å¸¸

ğŸŸ¡ é‡è¦æŒ‡æ ‡ï¼ˆå»ºè®®ç›‘æ§ï¼‰ï¼š
- QPS/TPSæ€§èƒ½æŒ‡æ ‡
- ç¼“å†²æ± å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢æ•°é‡å’Œç±»å‹
- é”ç­‰å¾…ç»Ÿè®¡

ğŸŸ¢ å‚è€ƒæŒ‡æ ‡ï¼ˆå¯é€‰ç›‘æ§ï¼‰ï¼š
- ä¸´æ—¶è¡¨åˆ›å»ºæ•°é‡
- è¡¨æ‰«æç»Ÿè®¡
- çº¿ç¨‹çŠ¶æ€åˆ†å¸ƒ
- ç½‘ç»œæµé‡ç»Ÿè®¡
```

**ğŸ”§ è‡ªåŠ¨åŒ–å®æ–½è·¯å¾„**
```
é˜¶æ®µ1ï¼šåŸºç¡€è‡ªåŠ¨åŒ–
- å®šæ—¶å¤‡ä»½è„šæœ¬å¼€å‘
- åŸºç¡€ç›‘æ§å‘Šè­¦é…ç½®
- æ—¥å¿—è½®è½¬è‡ªåŠ¨åŒ–
- ç®€å•çš„å¥åº·æ£€æŸ¥

é˜¶æ®µ2ï¼šæ™ºèƒ½åŒ–è¿ç»´
- å¤šç»´åº¦æ€§èƒ½ç›‘æ§
- æ™ºèƒ½å‘Šè­¦å’ŒæŠ‘åˆ¶
- è‡ªåŠ¨åŒ–æ•…éšœå¤„ç†
- å®¹é‡è§„åˆ’æ”¯æŒ

é˜¶æ®µ3ï¼šå…¨é¢é›†æˆ
- ä¸è¿ç»´å·¥å…·é›†æˆ
- å®¹å™¨åŒ–éƒ¨ç½²æ”¯æŒ
- å¯è§†åŒ–ç›‘æ§é¢æ¿
- è‡ªåŠ¨åŒ–ç¼–æ’æµç¨‹
```

**âš ï¸ å¸¸è§é™·é˜±å’Œæ³¨æ„äº‹é¡¹**
```
å®‰å…¨é£é™©ï¼š
- é¿å…åœ¨è„šæœ¬ä¸­æ˜æ–‡å­˜å‚¨å¯†ç 
- åˆç†è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
- å®šæœŸå®¡æ ¸è‡ªåŠ¨åŒ–è´¦æˆ·æƒé™
- ç›‘æ§è‡ªåŠ¨åŒ–æ“ä½œæ—¥å¿—

æ€§èƒ½å½±å“ï¼š
- ç›‘æ§è„šæœ¬é¿å…é«˜é¢‘æ‰§è¡Œ
- å¤‡ä»½æ“ä½œé€‰æ‹©åˆé€‚æ—¶é—´çª—å£
- æ—¥å¿—åˆ†ææ§åˆ¶èµ„æºæ¶ˆè€—
- æ€§èƒ½æ”¶é›†é¿å…å½±å“ä¸šåŠ¡

å¯é æ€§ä¿éšœï¼š
- å…³é”®æ“ä½œè®¾è®¡å›æ»šæœºåˆ¶
- é‡è¦è„šæœ¬éƒ¨ç½²æµ‹è¯•éªŒè¯
- å»ºç«‹æ“ä½œå®¡è®¡å’Œè¿½è¸ª
- å®šæœŸæµ‹è¯•è‡ªåŠ¨åŒ–åŠŸèƒ½
```

### 11.4 å‘å±•è¶‹åŠ¿å’Œæ‰©å±•æ–¹å‘


**ğŸš€ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
```
AIæ™ºèƒ½åŒ–ï¼š
- æœºå™¨å­¦ä¹ ä¼˜åŒ–å‘Šè­¦é˜ˆå€¼
- å¼‚å¸¸æ£€æµ‹å’Œé¢„æµ‹æ€§ç»´æŠ¤
- è‡ªåŠ¨åŒ–è°ƒä¼˜å‚æ•°å»ºè®®
- æ™ºèƒ½æ•…éšœæ ¹å› åˆ†æ

äº‘åŸç”Ÿé›†æˆï¼š
- Kubernetesé›†æˆå’Œç®¡ç†
- äº‘æœåŠ¡APIè‡ªåŠ¨åŒ–è°ƒç”¨
- å¼¹æ€§æ‰©ç¼©å®¹æ”¯æŒ
- å¤šäº‘ç¯å¢ƒç»Ÿä¸€ç®¡ç†

å¯è§‚æµ‹æ€§å¢å¼ºï¼š
- é“¾è·¯è¿½è¸ªå’Œæ€§èƒ½åˆ†æ
- ä¸šåŠ¡æŒ‡æ ‡å’ŒæŠ€æœ¯æŒ‡æ ‡å…³è”
- å®æ—¶æ•°æ®æµå¤„ç†
- äº¤äº’å¼æ•°æ®æ¢ç´¢
```

**ğŸ’¡ å­¦ä¹ æˆé•¿å»ºè®®**
```
æŠ€èƒ½æ‰©å±•æ–¹å‘ï¼š
1. æ·±å…¥å­¦ä¹ MySQL Shellçš„é«˜çº§ç‰¹æ€§
2. æŒæ¡å®¹å™¨åŒ–å’Œäº‘åŸç”ŸæŠ€æœ¯
3. å­¦ä¹ ç›‘æ§å’Œå¯è§‚æµ‹æ€§å·¥å…·
4. äº†è§£DevOpså’ŒSREå®è·µ

å®è·µé¡¹ç›®å»ºè®®ï¼š
1. æ­å»ºå®Œæ•´çš„MySQLç›‘æ§ä½“ç³»
2. å®ç°å¤šç¯å¢ƒè‡ªåŠ¨åŒ–éƒ¨ç½²
3. å¼€å‘æ™ºèƒ½åŒ–å‘Šè­¦ç³»ç»Ÿ
4. é›†æˆä¸»æµè¿ç»´å·¥å…·é“¾
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- è‡ªåŠ¨åŒ–æ˜¯ç°ä»£æ•°æ®åº“è¿ç»´çš„å¿…ç„¶è¶‹åŠ¿
- è„šæœ¬å¥å£®æ€§æ¯”åŠŸèƒ½å¤æ‚æ€§æ›´é‡è¦
- ç›‘æ§å‘Šè­¦è¦æ™ºèƒ½åŒ–ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
- å·¥å…·é›†æˆèƒ½æ˜¾è‘—æå‡è¿ç»´æ•ˆç‡
- å®‰å…¨å’Œå¯é æ€§å§‹ç»ˆæ˜¯ç¬¬ä¸€ä½çš„