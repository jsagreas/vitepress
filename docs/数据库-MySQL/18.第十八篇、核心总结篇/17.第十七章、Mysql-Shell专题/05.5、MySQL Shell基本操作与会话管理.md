---
title: 5、MySQL Shell基本操作与会话管理
---
## 📚 目录

1. [MySQL Shell基础概念](#1-mysql-shell基础概念)
2. [Shell启动方式详解](#2-shell启动方式详解)
3. [连接URI格式与参数](#3-连接uri格式与参数)
4. [会话建立与管理](#4-会话建立与管理)
5. [多语言模式切换](#5-多语言模式切换)
6. [SSL连接与安全认证](#6-ssl连接与安全认证)
7. [会话状态监控与配置](#7-会话状态监控与配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔧 MySQL Shell基础概念


### 1.1 什么是MySQL Shell


**🔸 基本定义**
MySQL Shell是MySQL官方提供的**高级命令行客户端**，可以理解为传统mysql客户端的"升级版"。

```
传统mysql客户端：只能执行SQL语句
MySQL Shell：SQL + JavaScript + Python + 管理功能

类比：
传统客户端 = 简单计算器
MySQL Shell = 科学计算器 + 编程环境
```

**💡 核心特点**
- **多语言支持**：SQL、JavaScript、Python三种模式
- **现代化界面**：语法高亮、自动补全、历史记录
- **管理功能**：集群管理、备份恢复、性能监控
- **API丰富**：提供丰富的管理API和工具函数

### 1.2 MySQL Shell的优势


| 特性 | **传统mysql客户端** | **MySQL Shell** |
|------|-------------------|-----------------|
| 🔤 **语言支持** | `仅SQL` | `SQL + JavaScript + Python` |
| 🎨 **用户界面** | `基础文本` | `语法高亮 + 自动补全` |
| 🛠️ **管理功能** | `基础查询` | `集群管理 + 备份恢复` |
| 📊 **编程能力** | `无` | `脚本编程 + API调用` |
| 🔍 **调试功能** | `基础` | `详细错误信息 + 调试模式` |

### 1.3 应用场景


**🎯 主要用途**
```
日常开发：
• 数据库连接和查询
• 脚本化数据处理
• 自动化运维任务

生产环境：
• MySQL集群部署和管理
• 数据备份和恢复
• 性能监控和优化

学习研究：
• 交互式学习SQL
• 测试新功能特性
• 原型开发和验证
```

---

## 2. 🚀 Shell启动方式详解


### 2.1 基本启动命令


**🔸 直接启动Shell**
```bash
# 最简单的启动方式
mysqlsh

# 启动后的界面
MySQL Shell 8.0.35
Copyright (c) 2016, 2023, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its affiliates.
Type '\help' or '\?' for help; '\quit' to exit.
MySQL  JS >
```

**💡 启动模式说明**
- **默认模式**：JavaScript模式（显示`MySQL JS >`）
- **交互式**：可以输入命令并立即看到结果
- **提示符**：显示当前语言模式和连接状态

### 2.2 带连接的启动方式


**🔸 启动时直接连接**
```bash
# 使用用户名和主机连接
mysqlsh user@localhost

# 指定端口连接
mysqlsh user@localhost:3307

# 使用完整URI连接
mysqlsh mysql://user:password@localhost:3306/database

# 启动时指定语言模式
mysqlsh --sql user@localhost    # 直接进入SQL模式
mysqlsh --py user@localhost     # 直接进入Python模式
```

### 2.3 常用启动参数


**⚙️ 重要启动选项**
```bash
# 语言模式选择
--sql          # 启动时进入SQL模式
--js           # 启动时进入JavaScript模式（默认）
--py           # 启动时进入Python模式

# 连接相关
--host=HOST    # 指定主机地址
--port=PORT    # 指定端口号
--user=USER    # 指定用户名
--password     # 提示输入密码

# 其他选项
--interactive  # 强制交互模式
--file=FILE    # 执行脚本文件
--quiet        # 减少输出信息
--verbose      # 增加详细输出
```

**🔧 实用启动示例**
```bash
# 生产环境安全连接
mysqlsh --host=192.168.1.100 --port=3306 --user=admin --password

# 执行脚本文件
mysqlsh --file=/path/to/script.js

# 静默模式执行
mysqlsh --quiet --sql --execute="SHOW DATABASES;"
```

### 2.4 启动配置文件


**📁 配置文件位置**
```
Linux/Mac系统：
~/.mysqlsh/mysqlsh.conf

Windows系统：
%APPDATA%\MySQL\mysqlsh\mysqlsh.conf

配置文件格式：JSON格式
{
    "history.autoSave": true,
    "history.maxSize": 1000,
    "autocomplete.nameCache": true
}
```

---

## 3. 🔗 连接URI格式与参数


### 3.1 URI连接格式详解


**🔸 标准URI格式**
```
完整格式：
[scheme://][user[:password]@]host[:port][/schema][?option1=value1&option2=value2]

组成部分说明：
scheme   ：连接协议（mysql, mysqlx）
user     ：数据库用户名
password ：用户密码（可选）
host     ：服务器地址
port     ：端口号（可选）
schema   ：默认数据库（可选）
options  ：连接选项（可选）
```

**💡 实际URI示例**
```bash
# 基础连接
mysql://root@localhost

# 指定密码和数据库
mysql://admin:123456@192.168.1.100:3306/testdb

# X Protocol连接（推荐）
mysqlx://user:password@localhost:33060/mydb

# SSL连接
mysql://user:pass@host:3306/db?ssl-mode=REQUIRED

# 带连接选项
mysql://user@host/db?connect-timeout=10&read-timeout=30
```

### 3.2 连接协议对比


| 协议 | **端口** | **特点** | **适用场景** |
|------|---------|---------|-------------|
| 🔌 **mysql** | `3306` | `传统协议，兼容性好` | `常规SQL操作` |
| ⚡ **mysqlx** | `33060` | `X协议，性能更好` | `Shell管理、API调用` |

**🎯 协议选择建议**
```
使用mysql协议：
• 兼容传统应用
• 简单SQL查询
• 第三方工具连接

使用mysqlx协议：
• MySQL Shell操作
• 集群管理
• 高性能场景
• 现代应用开发
```

### 3.3 连接参数详解


**⚙️ 重要连接参数**
```bash
# 超时设置
connect-timeout=10        # 连接超时（秒）
read-timeout=30          # 读取超时（秒）
write-timeout=30         # 写入超时（秒）

# SSL相关
ssl-mode=REQUIRED        # SSL模式：DISABLED/PREFERRED/REQUIRED
ssl-ca=/path/to/ca.pem   # CA证书路径
ssl-cert=/path/cert.pem  # 客户端证书
ssl-key=/path/key.pem    # 客户端私钥

# 字符集
charset=utf8mb4          # 字符集设置

# 其他选项
compression=true         # 启用压缩
get-server-public-key=true  # 获取服务器公钥
```

**🔧 完整连接示例**
```bash
# 生产环境安全连接
mysqlx://admin:password@prod-server:33060/maindb?ssl-mode=REQUIRED&connect-timeout=10&charset=utf8mb4

# 开发环境快速连接
mysql://dev:123456@localhost:3306/testdb?ssl-mode=DISABLED
```

---

## 4. 🔄 会话建立与管理


### 4.1 全局会话对象


**🔸 session对象概念**
在MySQL Shell中，`session`是一个**全局对象**，代表当前与MySQL服务器的连接。

```javascript
// session对象就像是你和数据库之间的"电话线"
// 通过这条"线"可以：
// 1. 发送SQL命令
// 2. 获取执行结果  
// 3. 管理事务
// 4. 查看连接状态

// 查看当前会话
session
```

### 4.2 会话建立方法


**🔸 方法一：启动时连接**
```bash
# 启动时直接建立会话
mysqlsh mysql://user:password@localhost:3306/testdb

# 进入后session对象自动可用
MySQL  JS > session
<Session:mysql://user@localhost:3306/testdb>
```

**🔸 方法二：Shell内连接**
```javascript
// 在Shell中建立新会话
\connect mysql://user:password@localhost:3306/testdb

// 或使用shell对象方法
session = shell.openSession('mysql://user@localhost:3306')

// 连接到不同服务器
session2 = shell.openSession('mysql://admin@192.168.1.100:3306')
```

**🔸 方法三：交互式连接**
```javascript
// 交互式输入连接信息
\connect user@localhost
// 系统会提示输入密码

// 或使用完整命令
\connect mysql://user@localhost:3306/mydb
```

### 4.3 会话对象操作


**💻 基本会话操作**
```javascript
// 查看会话信息
session.getUri()              // 获取连接URI
session.getCurrentSchema()    // 获取当前数据库
session.getSchemas()          // 获取所有数据库

// 执行SQL语句
session.sql("SHOW DATABASES").execute()
session.sql("USE testdb").execute()

// 切换数据库
session.setCurrentSchema('newdb')

// 检查连接状态
session.isOpen()              // 是否连接
```

### 4.4 多会话管理


**🔀 管理多个连接**
```javascript
// 建立多个会话
session1 = shell.openSession('mysql://user1@server1:3306/db1')
session2 = shell.openSession('mysql://user2@server2:3306/db2')

// 在不同会话间切换
shell.setSession(session1)    // 切换到session1
// 此时全局session对象指向session1

shell.setSession(session2)    // 切换到session2
// 现在全局session对象指向session2

// 查看所有活动会话
// （需要手动管理，Shell不提供内置列表）
```

**⚠️ 会话管理注意事项**
```
🔸 资源管理：及时关闭不用的会话
🔸 连接池：避免创建过多并发连接
🔸 事务状态：切换会话前确保事务完成
🔸 权限差异：不同会话可能有不同权限
```

---

## 5. 🔤 多语言模式切换


### 5.1 三种语言模式


**🎯 语言模式对比**

| 模式 | **提示符** | **主要用途** | **适用场景** |
|------|-----------|-------------|-------------|
| 📝 **SQL模式** | `MySQL SQL >` | `执行SQL语句` | `数据查询、DDL操作` |
| 🟨 **JavaScript模式** | `MySQL JS >` | `脚本编程、API调用` | `自动化、管理任务` |
| 🐍 **Python模式** | `MySQL PY >` | `Python脚本、数据分析` | `数据处理、分析` |

### 5.2 模式切换命令


**🔄 快速切换**
```bash
# 切换到SQL模式
\sql
MySQL SQL >

# 切换到JavaScript模式  
\js
MySQL JS >

# 切换到Python模式
\py
MySQL PY >

# 查看当前模式
\status
```

### 5.3 各模式特点与用法


**📝 SQL模式特点**
```sql
-- SQL模式：直接执行SQL语句
MySQL SQL > SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| testdb             |
+--------------------+

-- 支持所有标准SQL语句
MySQL SQL > SELECT * FROM users WHERE age > 25;

-- 支持MySQL特有语法
MySQL SQL > SHOW PROCESSLIST;
```

**🟨 JavaScript模式特点**
```javascript
// JavaScript模式：可以使用JS语法
MySQL JS > var databases = session.sql("SHOW DATABASES").execute()

// 遍历结果
MySQL JS > for (var row of databases.fetchAll()) {
             print(row[0])
           }

// 使用Shell API
MySQL JS > util.checkForServerUpgrade()

// 定义函数
MySQL JS > function showTables(schema) {
             session.sql(`USE ${schema}`).execute()
             return session.sql("SHOW TABLES").execute()
           }
```

**🐍 Python模式特点**
```python
# Python模式：使用Python语法
MySQL PY > import json

# 执行查询并处理结果
MySQL PY > result = session.sql("SELECT * FROM users").execute()
MySQL PY > rows = result.fetch_all()

# 使用Python数据处理
MySQL PY > for row in rows:
             print(f"User: {row[0]}, Age: {row[1]}")

# 与Python库集成
MySQL PY > import pandas as pd
MySQL PY > # 可以将结果转换为DataFrame
```

### 5.4 模式选择建议


**🎯 选择指南**
```
选择SQL模式：
✅ 执行简单查询
✅ 学习SQL语法
✅ 快速数据查看
✅ 传统SQL操作习惯

选择JavaScript模式：
✅ 自动化脚本编写
✅ 使用Shell管理API
✅ 复杂逻辑处理
✅ 集群管理操作

选择Python模式：
✅ 数据分析和处理
✅ 与Python生态集成
✅ 科学计算需求
✅ 熟悉Python语法
```

---

## 6. 🔒 SSL连接与安全认证


### 6.1 SSL连接基础


**🔸 SSL连接的意义**
SSL（Secure Socket Layer）连接就像给数据传输加了一个"保险箱"，确保：
- **数据加密**：传输过程中数据被加密保护
- **身份验证**：确认服务器身份，防止中间人攻击
- **数据完整性**：确保数据在传输中未被篡改

```
普通连接：  客户端 ----明文数据----> 服务器
SSL连接：   客户端 ----加密数据----> 服务器
           (数据包被加密，即使被截获也无法读取)
```

### 6.2 SSL模式详解


**⚙️ SSL连接模式**
```javascript
// DISABLED：完全禁用SSL
mysql://user:pass@host/db?ssl-mode=DISABLED

// PREFERRED：优先尝试SSL，失败则用普通连接（默认）
mysql://user:pass@host/db?ssl-mode=PREFERRED

// REQUIRED：强制要求SSL，无SSL连接则失败
mysql://user:pass@host/db?ssl-mode=REQUIRED

// VERIFY_CA：验证服务器证书
mysql://user:pass@host/db?ssl-mode=VERIFY_CA&ssl-ca=/path/ca.pem

// VERIFY_IDENTITY：验证服务器证书和主机名
mysql://user:pass@host/db?ssl-mode=VERIFY_IDENTITY&ssl-ca=/path/ca.pem
```

**🔍 模式选择说明**
```
开发环境：
• 使用DISABLED或PREFERRED
• 快速连接，不考虑安全性

测试环境：
• 使用REQUIRED
• 模拟生产环境SSL需求

生产环境：
• 使用VERIFY_CA或VERIFY_IDENTITY
• 最高安全级别
```

### 6.3 证书配置


**📜 SSL证书类型**
```bash
# CA证书：证书颁发机构根证书
ssl-ca=/etc/ssl/certs/ca-cert.pem

# 客户端证书：客户端身份证明
ssl-cert=/etc/ssl/certs/client-cert.pem

# 客户端私钥：与客户端证书配对
ssl-key=/etc/ssl/private/client-key.pem

# 完整的SSL连接示例
mysqlx://user:password@secure-server:33060/db?\
ssl-mode=VERIFY_IDENTITY&\
ssl-ca=/etc/ssl/ca.pem&\
ssl-cert=/etc/ssl/client-cert.pem&\
ssl-key=/etc/ssl/client-key.pem
```

### 6.4 认证方式


**🔐 主要认证方法**
```javascript
// 1. 密码认证（最常用）
\connect mysql://user:password@localhost

// 2. 无密码连接（开发环境）
\connect mysql://root@localhost
// 系统会提示输入密码

// 3. 证书认证
\connect mysqlx://user@secure-host:33060?\
ssl-mode=VERIFY_IDENTITY&\
ssl-cert=/path/client-cert.pem&\
ssl-key=/path/client-key.pem

// 4. 插件认证（如caching_sha2_password）
// 现代MySQL版本默认使用，Shell自动处理
```

**⚠️ 认证注意事项**
```
🔸 密码安全：避免在命令行直接输入密码
🔸 证书管理：定期更新和轮换证书
🔸 权限控制：使用最小权限原则
🔸 连接超时：设置合理的连接超时时间
```

---

## 7. 📊 会话状态监控与配置


### 7.1 会话状态查看


**🔍 查看连接状态**
```javascript
// 查看详细连接信息
\status

// 输出示例：
MySQL Shell version 8.0.35
Connection Id:                85
Default schema:               testdb
Current schema:               testdb
Current user:                 admin@localhost
SSL:                          Cipher in use is TLS_AES_256_GCM_SHA384
Server version:               8.0.35 MySQL Community Server
Protocol version:             Classic 10
Connection:                   localhost via TCP/IP
Server characterset:          utf8mb4
Schema characterset:          utf8mb4
Client characterset:          utf8mb4
Conn. characterset:          utf8mb4
```

**📈 监控会话指标**
```javascript
// 查看会话变量
session.sql("SHOW SESSION VARIABLES LIKE 'connect_timeout'").execute()

// 查看会话状态
session.sql("SHOW SESSION STATUS LIKE 'Threads_connected'").execute()

// 查看当前进程信息
session.sql("SELECT CONNECTION_ID(), USER(), DATABASE()").execute()

// 查看会话持续时间
session.sql("SELECT TIME_TO_SEC(TIMEDIFF(NOW(), \
             (SELECT TIME FROM INFORMATION_SCHEMA.PROCESSLIST \
              WHERE ID = CONNECTION_ID())))").execute()
```

### 7.2 连接超时设置


**⏰ 超时参数配置**
```javascript
// 连接层超时（在URI中设置）
mysql://user:pass@host/db?connect-timeout=10&read-timeout=30&write-timeout=30

// 会话层超时（连接后设置）
session.sql("SET SESSION wait_timeout = 3600").execute()        // 会话空闲超时
session.sql("SET SESSION interactive_timeout = 7200").execute() // 交互超时
session.sql("SET SESSION net_read_timeout = 60").execute()      // 网络读超时
session.sql("SET SESSION net_write_timeout = 60").execute()     // 网络写超时
```

**⚙️ 超时参数说明**
```
connect_timeout：建立连接的超时时间
read_timeout：读取数据的超时时间  
write_timeout：写入数据的超时时间
wait_timeout：会话空闲超时时间
interactive_timeout：交互式会话超时时间
```

### 7.3 会话配置优化


**🔧 性能相关配置**
```javascript
// 字符集设置
session.sql("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci").execute()

// 事务隔离级别
session.sql("SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED").execute()

// 查询缓存设置
session.sql("SET SESSION query_cache_type = ON").execute()

// SQL模式设置
session.sql("SET SESSION sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_DATE'").execute()
```

**📊 监控脚本示例**
```javascript
// 创建会话监控函数
function monitorSession() {
    print("=== MySQL Shell 会话监控 ===")
    
    // 基本信息
    var connId = session.sql("SELECT CONNECTION_ID()").execute().fetchOne()[0]
    var currentUser = session.sql("SELECT USER()").execute().fetchOne()[0]
    var currentDB = session.sql("SELECT DATABASE()").execute().fetchOne()[0]
    
    print(`连接ID: ${connId}`)
    print(`当前用户: ${currentUser}`)
    print(`当前数据库: ${currentDB}`)
    
    // 连接统计
    var threadsConnected = session.sql(
        "SHOW STATUS LIKE 'Threads_connected'"
    ).execute().fetchOne()[1]
    
    print(`当前连接数: ${threadsConnected}`)
    
    // 会话运行时间
    var uptime = session.sql("SHOW STATUS LIKE 'Uptime'").execute().fetchOne()[1]
    print(`服务器运行时间: ${uptime} 秒`)
}

// 调用监控函数
monitorSession()
```

### 7.4 会话管理最佳实践


**💡 管理建议**
```
连接管理：
✅ 使用连接池避免频繁建立连接
✅ 设置合理的超时时间
✅ 及时关闭不需要的会话
✅ 监控连接数和性能指标

安全实践：
✅ 使用SSL加密传输
✅ 避免在脚本中硬编码密码
✅ 定期轮换数据库密码
✅ 使用最小权限原则

性能优化：
✅ 合理设置字符集和排序规则
✅ 选择适当的事务隔离级别
✅ 优化网络超时参数
✅ 监控会话状态和性能
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 MySQL Shell本质：高级命令行客户端，支持多语言和现代化功能
🔸 启动方式：直接启动、带连接启动、参数化启动
🔸 URI格式：标准格式包含协议、用户、主机、端口、数据库和选项
🔸 会话对象：全局session对象代表数据库连接，支持多会话管理
🔸 语言模式：SQL、JavaScript、Python三种模式，各有特定用途
🔸 SSL连接：提供数据加密和身份验证，生产环境必备
🔸 会话管理：包含状态监控、超时设置、性能优化等方面
```

### 8.2 关键操作命令


**🔧 常用命令速查**
```javascript
// 基本连接
\connect mysql://user:password@localhost:3306/database

// 模式切换
\sql    // 切换到SQL模式
\js     // 切换到JavaScript模式  
\py     // 切换到Python模式

// 状态查看
\status // 查看连接状态
session // 查看会话对象

// 会话操作
session.getUri()                    // 获取连接URI
session.getCurrentSchema()          // 获取当前数据库
session.sql("SQL语句").execute()    // 执行SQL
```

### 8.3 实际应用指南


**🎯 应用场景选择**
```
日常开发：
• 使用JavaScript模式进行脚本化操作
• 利用自动补全和语法高亮提高效率
• 通过session对象执行SQL和管理连接

生产运维：
• 使用SSL连接确保数据安全
• 设置合理的超时参数
• 监控会话状态和性能指标
• 使用脚本自动化运维任务

学习研究：
• 在不同语言模式间切换学习
• 利用Shell的交互特性探索功能
• 通过API文档学习高级特性
```

**⚠️ 注意事项**
```
安全方面：
🔸 生产环境必须使用SSL连接
🔸 避免在命令行中暴露密码
🔸 定期更新认证信息
🔸 使用最小权限账户

性能方面：  
🔸 合理设置连接超时参数
🔸 及时关闭不需要的会话
🔸 避免长时间占用连接
🔸 监控连接数和服务器负载

操作方面：
🔸 熟练掌握模式切换
🔸 了解不同协议的特点
🔸 掌握URI格式和参数
🔸 学会使用Shell的帮助系统
```

**核心记忆要点**：
- MySQL Shell是传统客户端的现代化升级版
- session对象是操作数据库的核心入口
- 三种语言模式适用于不同的使用场景
- SSL连接是生产环境的安全保障
- 合理的会话管理是高效操作的基础