---
title: 4、MySQL Router安装与基础配置
---
## 📚 目录

1. [MySQL Router概述](#1-MySQL-Router概述)
2. [系统要求与环境检查](#2-系统要求与环境检查)
3. [安装包选择与下载](#3-安装包选择与下载)
4. [安装步骤详解](#4-安装步骤详解)
5. [基础配置文件](#5-基础配置文件)
6. [端口与网络配置](#6-端口与网络配置)
7. [日志配置管理](#7-日志配置管理)
8. [服务启动配置](#8-服务启动配置)
9. [用户权限设置](#9-用户权限设置)
10. [安装后验证](#10-安装后验证)
11. [基本故障排查](#11-基本故障排查)
12. [核心要点总结](#12-核心要点总结)

---

## 1. 🎯 MySQL Router概述


### 1.1 什么是MySQL Router


**🔸 核心定义**
```
MySQL Router：MySQL官方提供的轻量级中间件
作用：在应用程序和MySQL数据库之间充当"智能代理"
目标：实现负载均衡、故障转移、读写分离等高可用功能
```

**💡 通俗理解**
想象MySQL Router就像一个**智能的交通指挥员**：
- 应用程序要访问数据库时，不直接连接数据库
- 而是先"询问"Router："我要读数据，应该连哪个服务器？"
- Router根据当前情况，指引应用连接到最合适的数据库服务器

### 1.2 Router的核心价值


**🎯 解决的问题**
```
单点故障：
问题：只有一个数据库，挂了就全部不能用
解决：Router可以自动切换到备用数据库

性能瓶颈：
问题：所有请求都打到一个数据库上
解决：Router可以把读请求分散到多个从库

连接复杂：
问题：应用要记住很多数据库地址
解决：应用只需要知道Router的地址就够了
```

### 1.3 典型应用场景


**🏗️ 高可用架构**
```
传统架构：
应用 → MySQL主库（单点故障风险）

Router架构：
应用 → MySQL Router → MySQL主库
                  ├→ MySQL从库1
                  └→ MySQL从库2

优势：
• 主库故障时自动切换到从库
• 读请求自动分发到从库，减轻主库压力
• 应用无需修改代码，透明使用
```

---

## 2. 🔧 系统要求与环境检查


### 2.1 硬件系统要求


**📋 最低配置要求**
| 项目 | **最低要求** | **推荐配置** | **说明** |
|------|-------------|-------------|---------|
| **CPU** | `1核` | `2核以上` | `Router本身占用很少` |
| **内存** | `256MB` | `1GB以上` | `主要用于连接缓存` |
| **磁盘** | `100MB` | `1GB以上` | `程序+日志存储` |
| **网络** | `100Mbps` | `1Gbps以上` | `数据库连接带宽` |

**💡 实际考虑**
- Router作为中间件，**硬件要求很低**
- 主要瓶颈在**网络带宽**和**并发连接数**
- 建议与应用服务器部署在同一网段，**减少网络延迟**

### 2.2 操作系统支持


**🖥️ 支持的操作系统**
```
Linux系列：
✅ Red Hat Enterprise Linux 7.x, 8.x
✅ CentOS 7.x, 8.x  
✅ Ubuntu 18.04, 20.04, 22.04
✅ SUSE Linux Enterprise Server

Windows系列：
✅ Windows Server 2016, 2019, 2022
✅ Windows 10, 11（开发测试用）

其他系统：
✅ macOS 10.15+（开发测试用）
✅ FreeBSD 12.x+
```

### 2.3 环境检查脚本


**🔍 Linux环境检查**
```bash
#!/bin/bash
echo "=== MySQL Router环境检查 ==="

# 检查操作系统版本
echo "1. 操作系统信息："
cat /etc/os-release | grep -E "NAME|VERSION"

# 检查系统资源
echo -e "\n2. 系统资源："
echo "CPU核数：$(nproc)"
echo "内存大小：$(free -h | grep Mem | awk '{print $2}')"
echo "磁盘空间：$(df -h / | tail -1 | awk '{print $4}') 可用"

# 检查网络连通性
echo -e "\n3. 网络检查："
ping -c 2 mysql.server.ip > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "✅ MySQL服务器网络连通"
else
    echo "❌ MySQL服务器网络不通"
fi

# 检查端口占用
echo -e "\n4. 端口检查："
netstat -tlnp | grep -E ":6446|:6447" || echo "端口6446/6447可用"

# 检查依赖库
echo -e "\n5. 依赖检查："
ldconfig -p | grep ssl > /dev/null && echo "✅ SSL库已安装" || echo "❌ 需要安装SSL库"
```

### 2.4 防火墙与安全检查


**🛡️ 防火墙配置**
```bash
# CentOS/RHEL防火墙配置
sudo firewall-cmd --permanent --add-port=6446/tcp  # 读写端口
sudo firewall-cmd --permanent --add-port=6447/tcp  # 只读端口
sudo firewall-cmd --reload

# Ubuntu防火墙配置
sudo ufw allow 6446/tcp
sudo ufw allow 6447/tcp
sudo ufw reload

# 验证端口开放
sudo firewall-cmd --list-ports    # CentOS/RHEL
sudo ufw status                    # Ubuntu
```

---

## 3. 📦 安装包选择与下载


### 3.1 安装包类型对比


**📊 安装方式选择**
| 安装方式 | **优点** | **缺点** | **适用场景** |
|---------|---------|---------|-------------|
| **RPM包** | `安装简单，依赖自动处理` | `版本可能不是最新` | `生产环境，稳定优先` |
| **DEB包** | `Ubuntu系统原生支持` | `版本更新可能滞后` | `Ubuntu生产环境` |
| **二进制包** | `版本最新，通用性强` | `需手动配置环境` | `多版本测试环境` |
| **源码编译** | `完全自定义，性能最优` | `编译复杂，耗时长` | `特殊需求场景` |

### 3.2 版本选择策略


**🎯 版本选择建议**
```
生产环境版本选择：
• 选择GA（正式发布）版本，避免RC（候选）版本
• 与MySQL Server版本保持兼容
• 建议使用LTS（长期支持）版本

版本兼容性：
MySQL 8.0.x ←→ MySQL Router 8.0.x
MySQL 5.7.x ←→ MySQL Router 2.1.x

查看当前MySQL版本：
mysql> SELECT VERSION();
```

### 3.3 下载与验证


**📥 官方下载地址**
```
官方下载页面：
https://dev.mysql.com/downloads/router/

选择步骤：
1. 选择操作系统（Linux/Windows/macOS）
2. 选择架构（x86_64/ARM64）
3. 选择安装包类型（RPM/DEB/TAR）
4. 下载安装包和SHA256校验文件
```

**🔐 安装包验证**
```bash
# 下载校验文件
wget https://dev.mysql.com/downloads/gpg/?file=mysql-router-8.0.35-1.el8.x86_64.rpm.sha256

# 验证安装包完整性
sha256sum -c mysql-router-8.0.35-1.el8.x86_64.rpm.sha256

# 预期输出：
# mysql-router-8.0.35-1.el8.x86_64.rpm: OK
```

---

## 4. ⚙️ 安装步骤详解


### 4.1 RPM包安装（CentOS/RHEL）


**📋 安装步骤**
```bash
# 步骤1：下载安装包
wget https://dev.mysql.com/get/mysql-router-8.0.35-1.el8.x86_64.rpm

# 步骤2：安装依赖（如果需要）
sudo yum install -y openssl-libs

# 步骤3：安装MySQL Router
sudo rpm -ivh mysql-router-8.0.35-1.el8.x86_64.rpm

# 步骤4：验证安装
which mysqlrouter
mysqlrouter --version
```

**⚠️ 常见安装问题**
```bash
# 问题1：依赖包缺失
错误信息：error: Failed dependencies: openssl-libs is needed
解决方法：sudo yum install openssl-libs

# 问题2：权限不足
错误信息：Permission denied
解决方法：使用sudo或root用户安装

# 问题3：端口冲突
错误信息：Address already in use
解决方法：检查并关闭占用端口的进程
```

### 4.2 DEB包安装（Ubuntu/Debian）


**📋 Ubuntu安装步骤**
```bash
# 步骤1：更新包列表
sudo apt update

# 步骤2：下载安装包
wget https://dev.mysql.com/get/mysql-router_8.0.35-1ubuntu20.04_amd64.deb

# 步骤3：安装Router
sudo dpkg -i mysql-router_8.0.35-1ubuntu20.04_amd64.deb

# 步骤4：安装依赖（如果有缺失）
sudo apt-get install -f

# 步骤5：验证安装
dpkg -l | grep mysql-router
mysqlrouter --version
```

### 4.3 二进制包安装（通用方法）


**🔧 手动安装步骤**
```bash
# 步骤1：创建用户和目录
sudo useradd -r -s /bin/false mysqlrouter
sudo mkdir -p /opt/mysql/router
sudo mkdir -p /var/log/mysqlrouter
sudo mkdir -p /var/lib/mysqlrouter

# 步骤2：下载解压
wget https://dev.mysql.com/get/mysql-router-8.0.35-linux-glibc2.17-x86_64.tar.xz
tar -xf mysql-router-8.0.35-linux-glibc2.17-x86_64.tar.xz
sudo mv mysql-router-8.0.35-linux-glibc2.17-x86_64/* /opt/mysql/router/

# 步骤3：设置权限
sudo chown -R mysqlrouter:mysqlrouter /opt/mysql/router
sudo chown -R mysqlrouter:mysqlrouter /var/log/mysqlrouter
sudo chown -R mysqlrouter:mysqlrouter /var/lib/mysqlrouter

# 步骤4：创建软链接
sudo ln -s /opt/mysql/router/bin/mysqlrouter /usr/local/bin/
```

### 4.4 安装后目录结构


**📁 标准目录布局**
```
MySQL Router安装目录结构：

/usr/bin/mysqlrouter              ← 主程序
/etc/mysqlrouter/                 ← 配置文件目录
├── mysqlrouter.conf              ← 主配置文件
└── mysqlrouter.key               ← 密钥文件
/var/log/mysqlrouter/             ← 日志目录
├── mysqlrouter.log               ← 主日志文件
└── error.log                     ← 错误日志
/var/lib/mysqlrouter/             ← 数据目录
└── state.json                    ← 状态文件
/usr/lib/systemd/system/          ← 服务配置（Linux）
└── mysqlrouter.service           ← systemd服务文件
```

---

## 5. 📝 基础配置文件


### 5.1 配置文件结构解析


**📋 主配置文件：`/etc/mysqlrouter/mysqlrouter.conf`**
```ini
# MySQL Router主配置文件示例

[DEFAULT]
# 全局默认设置
user = mysqlrouter
logging_folder = /var/log/mysqlrouter
runtime_folder = /var/lib/mysqlrouter
config_folder = /etc/mysqlrouter

[logger]
# 日志配置
level = INFO
filename = mysqlrouter.log
timestamp_precision = second

[routing:primary]
# 主库读写路由
bind_address = 0.0.0.0
bind_port = 6446
destinations = mysql-primary:3306
routing_strategy = first-available
mode = read-write

[routing:secondary]
# 从库只读路由
bind_address = 0.0.0.0
bind_port = 6447
destinations = mysql-slave1:3306,mysql-slave2:3306
routing_strategy = round-robin
mode = read-only
```

### 5.2 配置段详解


**🔧 [DEFAULT] 全局配置**
```ini
[DEFAULT]
# 运行用户（安全考虑）
user = mysqlrouter

# 核心目录配置
logging_folder = /var/log/mysqlrouter    # 日志存放目录
runtime_folder = /var/lib/mysqlrouter    # 运行时文件目录
config_folder = /etc/mysqlrouter         # 配置文件目录
plugin_folder = /usr/lib64/mysqlrouter   # 插件目录

# 进程配置
pid_file = /var/lib/mysqlrouter/mysqlrouter.pid
keyring_path = /var/lib/mysqlrouter/keyring
master_key_path = /var/lib/mysqlrouter/mysqlrouter.key
```

**📊 [routing] 路由配置**
```ini
[routing:读写路由名称]
# 监听配置
bind_address = 0.0.0.0           # 监听地址（0.0.0.0表示所有接口）
bind_port = 6446                 # 监听端口

# 目标数据库
destinations = host1:3306,host2:3306,host3:3306

# 路由策略
routing_strategy = first-available    # 路由算法
mode = read-write                    # 读写模式

# 连接配置
max_connections = 512                # 最大连接数
max_connect_errors = 100            # 最大连接错误数
```

### 5.3 路由策略详解


**🎯 routing_strategy选项**
```
路由策略说明：

first-available：
• 含义：按顺序尝试，选择第一个可用的服务器
• 适用：主从架构，主库优先
• 示例：主库正常时所有连接都到主库

round-robin：
• 含义：轮询分发，平均分配连接
• 适用：读库负载均衡
• 示例：3个从库，连接依次分配给slave1→slave2→slave3→slave1...

next-available：
• 含义：类似first-available，但会记住上次选择
• 适用：减少连接切换
• 示例：上次连接slave2，下次也优先选择slave2

round-robin-with-fallback：
• 含义：优先轮询，故障时回退
• 适用：复杂的高可用场景
• 示例：从库轮询，从库全挂时连主库
```

### 5.4 配置文件模板


**📝 生产环境配置模板**
```ini
# 生产环境MySQL Router配置模板

[DEFAULT]
user = mysqlrouter
logging_folder = /var/log/mysqlrouter
runtime_folder = /var/lib/mysqlrouter
config_folder = /etc/mysqlrouter

[logger]
level = INFO
filename = mysqlrouter.log
timestamp_precision = second
# 日志轮转配置
max_size = 100M
max_files = 10

# 主库读写路由（应用写操作连接这里）
[routing:primary]
bind_address = 0.0.0.0
bind_port = 6446
destinations = mysql-master.example.com:3306
routing_strategy = first-available
mode = read-write
max_connections = 1024
connect_timeout = 2
client_connect_timeout = 9

# 从库只读路由（应用读操作连接这里）
[routing:secondary] 
bind_address = 0.0.0.0
bind_port = 6447
destinations = mysql-slave1.example.com:3306,mysql-slave2.example.com:3306
routing_strategy = round-robin
mode = read-only
max_connections = 2048
connect_timeout = 2
client_connect_timeout = 9

# 监控和管理接口
[http_server]
port = 8443
ssl = 1
ssl_cert = /etc/mysqlrouter/router-cert.pem
ssl_key = /etc/mysqlrouter/router-key.pem
```

---

## 6. 🌐 端口与网络配置


### 6.1 默认端口说明


**📋 MySQL Router标准端口**
| 端口 | **用途** | **说明** | **对应模式** |
|------|---------|---------|-------------|
| **6446** | `主库读写` | `应用的写操作连接此端口` | `read-write` |
| **6447** | `从库只读` | `应用的读操作连接此端口` | `read-only` |
| **64460** | `主库读写(X协议)` | `MySQL X协议连接` | `read-write` |
| **64470** | `从库只读(X协议)` | `MySQL X协议连接` | `read-only` |
| **8443** | `管理接口` | `Router状态监控和管理` | `HTTP/HTTPS` |

### 6.2 端口配置最佳实践


**🎯 端口规划建议**
```
端口规划原则：

1. 避免与MySQL默认端口冲突：
   MySQL默认：3306
   Router读写：6446  ← 不会冲突
   Router只读：6447  ← 不会冲突

2. 考虑防火墙规则：
   应用服务器 → Router端口：6446,6447（开放）
   Router → MySQL端口：3306（内网开放）
   管理端口：8443（仅管理员访问）

3. 多实例部署：
   Router1：6446,6447
   Router2：6448,6449  ← 递增避免冲突
   Router3：6450,6451
```

**🔧 自定义端口配置**
```ini
# 自定义端口示例
[routing:app_write]
bind_port = 3306      # 使用MySQL标准端口（应用无需修改）
destinations = mysql-master:3306
mode = read-write

[routing:app_read]
bind_port = 3307      # 自定义只读端口
destinations = mysql-slave1:3306,mysql-slave2:3306
mode = read-only

[routing:admin_access]
bind_port = 33060     # 管理员专用端口
destinations = mysql-master:3306
mode = read-write
max_connections = 10   # 限制管理连接数
```

### 6.3 网络安全配置


**🛡️ 监听地址安全配置**
```ini
# 安全的监听地址配置

# ❌ 不安全：监听所有接口
bind_address = 0.0.0.0

# ✅ 安全：只监听内网接口
bind_address = 192.168.1.100

# ✅ 更安全：只监听本地环回（仅本机访问）
bind_address = 127.0.0.1

# ✅ 最佳实践：分别配置不同用途
[routing:internal_app]
bind_address = 192.168.1.100    # 内网应用访问
bind_port = 6446

[routing:local_admin]
bind_address = 127.0.0.1        # 本机管理访问
bind_port = 33060
```

### 6.4 连接限制配置


**⚡ 连接数和超时配置**
```ini
[routing:production]
# 连接数限制
max_connections = 1000           # 最大并发连接数
max_connect_errors = 50          # 最大连接错误数（达到后暂时屏蔽客户端）

# 超时配置
connect_timeout = 3              # 连接MySQL的超时时间（秒）
client_connect_timeout = 9       # 客户端连接超时时间（秒）
read_timeout = 30               # 读取超时时间（秒）
write_timeout = 30              # 写入超时时间（秒）

# 连接池配置（8.0.20+版本支持）
connection_pool_size = 16        # 连接池大小
connection_pool_max_idle_time = 3600  # 空闲连接最大时间（秒）
```

---

## 7. 📊 日志配置管理


### 7.1 日志级别详解


**📋 日志级别说明**
| 级别 | **含义** | **记录内容** | **适用场景** |
|------|---------|-------------|-------------|
| **DEBUG** | `调试信息` | `详细的执行过程信息` | `开发调试` |
| **INFO** | `一般信息` | `启动、连接、路由信息` | `生产监控` |
| **WARNING** | `警告信息` | `非致命错误，连接重试` | `日常运维` |
| **ERROR** | `错误信息` | `连接失败，配置错误` | `故障排查` |
| **FATAL** | `致命错误` | `程序无法继续运行` | `紧急处理` |

### 7.2 日志配置详解


**🔧 完整日志配置**
```ini
[logger]
# 基础日志配置
level = INFO                     # 日志级别
filename = mysqlrouter.log       # 日志文件名
timestamp_precision = second     # 时间戳精度

# 日志轮转配置
max_size = 100M                 # 单个日志文件最大大小
max_files = 10                  # 保留的日志文件数量

# 日志格式配置
format = "[%timestamp%] [%level%] %message%"

# 日志输出配置
sinks = file,console            # 输出到文件和控制台
```

**📝 日志格式自定义**
```ini
# 自定义日志格式选项
%timestamp%     # 时间戳
%level%         # 日志级别
%thread%        # 线程ID
%message%       # 日志消息
%function%      # 函数名（仅DEBUG级别）
%file%          # 文件名（仅DEBUG级别）
%line%          # 行号（仅DEBUG级别）

# 示例：详细格式
format = "[%timestamp%] [%level%] [Thread:%thread%] %message%"

# 示例：简洁格式  
format = "%timestamp% %level%: %message%"
```

### 7.3 日志分类配置


**🎯 按模块分离日志**
```ini
# 主日志记录器
[logger]
level = INFO
filename = mysqlrouter.log

# 路由专用日志
[logger:routing]
level = INFO
filename = routing.log
# 只记录路由相关信息

# 连接专用日志
[logger:connection]  
level = WARNING
filename = connection.log
# 只记录连接问题

# 性能监控日志
[logger:performance]
level = INFO  
filename = performance.log
# 记录性能指标
```

### 7.4 日志监控脚本


**🔍 日志分析脚本**
```bash
#!/bin/bash
# MySQL Router日志监控脚本

LOG_FILE="/var/log/mysqlrouter/mysqlrouter.log"
ERROR_COUNT=$(tail -1000 $LOG_FILE | grep -c "ERROR")
WARNING_COUNT=$(tail -1000 $LOG_FILE | grep -c "WARNING")

echo "=== MySQL Router日志状态 ==="
echo "最近1000行日志中："
echo "错误数量：$ERROR_COUNT"
echo "警告数量：$WARNING_COUNT"

# 检查是否有连接失败
if [ $ERROR_COUNT -gt 10 ]; then
    echo "⚠️  错误数量过多，建议检查MySQL连接"
    tail -20 $LOG_FILE | grep "ERROR"
fi

# 检查最新的路由状态
echo -e "\n=== 最新路由状态 ==="
tail -10 $LOG_FILE | grep -E "routing|connection"
```

---

## 8. 🚀 服务启动配置


### 8.1 systemd服务配置


**📋 创建服务文件**
```bash
# 创建systemd服务文件
sudo nano /usr/lib/systemd/system/mysqlrouter.service
```

**🔧 服务配置内容**
```ini
[Unit]
Description=MySQL Router
Documentation=man:mysqlrouter(1)
After=network.target
Wants=network.target

[Service]
Type=notify
User=mysqlrouter
Group=mysqlrouter
ExecStart=/usr/bin/mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf
Restart=always
RestartSec=3
LimitNOFILE=65535
StandardOutput=journal
StandardError=journal

# 安全设置
PrivateTmp=true
ProtectHome=true
ProtectSystem=strict
ReadWritePaths=/var/log/mysqlrouter /var/lib/mysqlrouter

[Install]
WantedBy=multi-user.target
```

### 8.2 服务管理命令


**⚡ 常用服务操作**
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动Router服务
sudo systemctl start mysqlrouter

# 停止Router服务  
sudo systemctl stop mysqlrouter

# 重启Router服务
sudo systemctl restart mysqlrouter

# 查看服务状态
sudo systemctl status mysqlrouter

# 设置开机自启动
sudo systemctl enable mysqlrouter

# 取消开机自启动
sudo systemctl disable mysqlrouter

# 查看服务日志
sudo journalctl -u mysqlrouter -f
```

### 8.3 手动启动方式


**🔧 命令行启动**
```bash
# 前台启动（调试用）
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf

# 后台启动
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf &

# 指定用户启动
sudo -u mysqlrouter mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf

# 启动时检查配置文件
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf --check-config
```

### 8.4 启动参数详解


**📋 常用启动参数**
```bash
mysqlrouter [选项]

主要选项：
--config=FILE          # 指定配置文件路径
--user=USER            # 指定运行用户
--daemon               # 后台守护进程模式运行
--pid-file=FILE        # 指定PID文件路径
--log-level=LEVEL      # 指定日志级别
--help                 # 显示帮助信息
--version              # 显示版本信息
--check-config         # 检查配置文件语法

示例：
# 使用指定配置文件启动
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf

# 指定用户和日志级别启动
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf --user=mysqlrouter --log-level=DEBUG
```

---

## 9. 👤 用户权限设置


### 9.1 MySQL Router运行用户


**🔧 创建专用用户**
```bash
# 创建mysqlrouter用户（系统用户，不能登录）
sudo useradd -r -s /bin/false -d /var/lib/mysqlrouter -c "MySQL Router" mysqlrouter

# 创建必要目录
sudo mkdir -p /var/lib/mysqlrouter
sudo mkdir -p /var/log/mysqlrouter

# 设置目录权限
sudo chown -R mysqlrouter:mysqlrouter /var/lib/mysqlrouter
sudo chown -R mysqlrouter:mysqlrouter /var/log/mysqlrouter
sudo chmod 750 /var/lib/mysqlrouter
sudo chmod 750 /var/log/mysqlrouter
```

### 9.2 文件权限配置


**🛡️ 安全权限设置**
```bash
# 配置文件权限（防止普通用户查看敏感信息）
sudo chown root:mysqlrouter /etc/mysqlrouter/mysqlrouter.conf
sudo chmod 640 /etc/mysqlrouter/mysqlrouter.conf

# 密钥文件权限（高安全性）
sudo chown mysqlrouter:mysqlrouter /var/lib/mysqlrouter/mysqlrouter.key  
sudo chmod 600 /var/lib/mysqlrouter/mysqlrouter.key

# 日志文件权限
sudo chown mysqlrouter:mysqlrouter /var/log/mysqlrouter/*.log
sudo chmod 644 /var/log/mysqlrouter/*.log

# 验证权限设置
ls -la /etc/mysqlrouter/
ls -la /var/lib/mysqlrouter/
ls -la /var/log/mysqlrouter/
```

### 9.3 MySQL数据库用户权限


**🔑 Router连接MySQL的用户权限**
```sql
-- 在MySQL中创建Router专用用户
CREATE USER 'router_user'@'%' IDENTIFIED BY 'strong_password_here';

-- 授予必要的权限
-- Router需要这些权限来检查服务器状态
GRANT SELECT ON performance_schema.replication_group_members TO 'router_user'@'%';
GRANT SELECT ON performance_schema.replication_group_member_stats TO 'router_user'@'%';
GRANT SELECT ON performance_schema.global_variables TO 'router_user'@'%';

-- 如果使用InnoDB Cluster，还需要这些权限
GRANT SELECT ON mysql_innodb_cluster_metadata.* TO 'router_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证用户创建成功
SELECT User, Host FROM mysql.user WHERE User = 'router_user';
```

### 9.4 网络访问控制


**🌐 IP访问限制**
```sql
-- 限制Router用户只能从特定IP连接
CREATE USER 'router_user'@'192.168.1.100' IDENTIFIED BY 'strong_password';

-- 限制应用用户只能从Router服务器连接MySQL
CREATE USER 'app_user'@'192.168.1.100' IDENTIFIED BY 'app_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_database.* TO 'app_user'@'192.168.1.100';

-- 查看当前连接来源
SELECT USER(), CONNECTION_ID(), HOST FROM INFORMATION_SCHEMA.PROCESSLIST;
```

---

## 10. ✅ 安装后验证


### 10.1 基础功能验证


**🔍 验证Router是否正常运行**
```bash
# 1. 检查进程是否运行
ps aux | grep mysqlrouter
# 应该看到mysqlrouter进程

# 2. 检查端口是否监听
netstat -tlnp | grep mysqlrouter
# 应该看到6446和6447端口处于LISTEN状态

# 3. 检查服务状态
sudo systemctl status mysqlrouter
# 应该显示active (running)状态

# 4. 查看Router版本
mysqlrouter --version
# 显示版本信息确认安装成功
```

### 10.2 连接测试


**🔗 测试数据库连接**
```bash
# 测试读写端口连接（6446）
mysql -h localhost -P 6446 -u your_username -p
# 应该能正常连接到主库

# 测试只读端口连接（6447）  
mysql -h localhost -P 6447 -u your_username -p
# 应该能正常连接到从库

# 在连接后验证当前服务器
mysql> SELECT $$hostname, $$server_id;
# 确认连接到了正确的MySQL服务器
```

### 10.3 路由功能验证


**⚡ 验证负载均衡和故障转移**
```bash
#!/bin/bash
# Router功能验证脚本

echo "=== MySQL Router功能验证 ==="

# 测试读写路由
echo "1. 测试读写路由（端口6446）："
mysql -h localhost -P 6446 -u test_user -ptest_pass -e "SELECT $$hostname as 'Connected to', 'READ-WRITE' as 'Mode';" 2>/dev/null

# 测试只读路由
echo -e "\n2. 测试只读路由（端口6447）："
for i in {1..3}; do
    echo "第${i}次连接："
    mysql -h localhost -P 6447 -u test_user -ptest_pass -e "SELECT $$hostname as 'Connected to', 'READ-ONLY' as 'Mode';" 2>/dev/null
done

# 测试连接数限制
echo -e "\n3. 测试并发连接："
for i in {1..5}; do
    mysql -h localhost -P 6446 -u test_user -ptest_pass -e "SELECT CONNECTION_ID(), NOW();" &
done
wait
```

### 10.4 性能基准测试


**📊 简单性能测试**
```bash
# 使用mysqlslap进行基准测试

# 测试通过Router的性能
mysqlslap --host=localhost --port=6446 --user=test_user --password=test_pass \
  --concurrency=10 --iterations=3 --auto-generate-sql --auto-generate-sql-load-type=mixed

# 测试直连MySQL的性能（对比）
mysqlslap --host=mysql-server --port=3306 --user=test_user --password=test_pass \
  --concurrency=10 --iterations=3 --auto-generate-sql --auto-generate-sql-load-type=mixed

# 比较两次测试结果，Router的性能损失应该很小（通常<5%）
```

---

## 11. 🔧 基本故障排查


### 11.1 常见启动问题


**❌ 问题1：Router无法启动**
```bash
# 症状：systemctl start mysqlrouter失败
# 排查步骤：

# 1. 查看详细错误信息
sudo systemctl status mysqlrouter -l
sudo journalctl -u mysqlrouter --no-pager

# 2. 检查配置文件语法
mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf --check-config

# 3. 检查权限问题
ls -la /etc/mysqlrouter/mysqlrouter.conf
ls -la /var/log/mysqlrouter/
ls -la /var/lib/mysqlrouter/

# 4. 手动启动查看错误
sudo -u mysqlrouter mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf
```

**❌ 问题2：端口冲突**
```bash
# 症状：bind: Address already in use
# 排查步骤：

# 1. 查看端口占用
sudo netstat -tlnp | grep 6446
sudo lsof -i :6446

# 2. 停止冲突的进程
sudo kill -9 <PID>

# 3. 或者修改Router配置使用其他端口
[routing:primary]
bind_port = 6448  # 改为未占用的端口
```

### 11.2 连接问题排查


**❌ 问题3：无法连接到Router**
```bash
# 症状：客户端连接Router失败
# 排查步骤：

# 1. 检查Router是否监听端口
netstat -tlnp | grep mysqlrouter

# 2. 检查防火墙设置
sudo firewall-cmd --list-ports
sudo iptables -L -n

# 3. 检查Router日志
tail -f /var/log/mysqlrouter/mysqlrouter.log

# 4. 测试本地连接
mysql -h 127.0.0.1 -P 6446 -u username -p

# 5. 检查MySQL用户权限
mysql> SELECT User, Host FROM mysql.user WHERE User='your_username';
```

**❌ 问题4：Router连接MySQL失败**
```bash
# 症状：Router启动正常，但无法连接后端MySQL
# 排查步骤：

# 1. 检查MySQL服务器状态
mysql -h mysql-server-ip -P 3306 -u router_user -p

# 2. 检查网络连通性
ping mysql-server-ip
telnet mysql-server-ip 3306

# 3. 检查MySQL错误日志
tail -f /var/log/mysql/error.log

# 4. 验证Router配置中的destinations
cat /etc/mysqlrouter/mysqlrouter.conf | grep destinations
```

### 11.3 性能问题排查


**📊 问题5：Router性能瓶颈**
```bash
# 症状：通过Router连接比直连慢很多
# 排查步骤：

# 1. 检查Router资源使用
top -p $(pgrep mysqlrouter)
iostat -x 1

# 2. 检查连接数
netstat -an | grep :6446 | wc -l

# 3. 分析Router日志中的慢查询
grep -i "slow" /var/log/mysqlrouter/mysqlrouter.log

# 4. 检查网络延迟
ping -c 10 mysql-server-ip

# 5. 调整Router配置
# 增加连接池大小，调整超时时间等
```

### 11.4 故障排查工具脚本


**🛠️ 综合诊断脚本**
```bash
#!/bin/bash
# MySQL Router故障诊断脚本

echo "=== MySQL Router故障诊断 ==="

# 基础检查
echo "1. 基础状态检查："
echo "Router进程：$(pgrep mysqlrouter | wc -l) 个"
echo "服务状态：$(systemctl is-active mysqlrouter)"
echo "端口监听：$(netstat -tln | grep -E ':6446|:6447' | wc -l) 个端口"

# 配置文件检查
echo -e "\n2. 配置文件检查："
if mysqlrouter --config=/etc/mysqlrouter/mysqlrouter.conf --check-config; then
    echo "✅ 配置文件语法正确"
else
    echo "❌ 配置文件有语法错误"
fi

# 权限检查
echo -e "\n3. 权限检查："
if [ -r /etc/mysqlrouter/mysqlrouter.conf ]; then
    echo "✅ 配置文件可读"
else
    echo "❌ 配置文件权限问题"
fi

# 网络连通性检查
echo -e "\n4. 网络连通性检查："
destinations=$(grep "destinations" /etc/mysqlrouter/mysqlrouter.conf | head -1 | cut -d'=' -f2 | tr ',' ' ')
for dest in $destinations; do
    host=$(echo $dest | cut -d':' -f1)
    port=$(echo $dest | cut -d':' -f2)
    if timeout 3 bash -c "echo >/dev/tcp/$host/$port" 2>/dev/null; then
        echo "✅ $dest 连通"
    else
        echo "❌ $dest 不通"
    fi
done

# 日志错误检查
echo -e "\n5. 最近错误日志："
tail -20 /var/log/mysqlrouter/mysqlrouter.log | grep -i error || echo "无错误日志"
```

---

## 12. 📋 核心要点总结


### 12.1 必须掌握的核心概念


```
🔸 MySQL Router本质：MySQL官方中间件，提供负载均衡和高可用
🔸 核心价值：解决单点故障、性能瓶颈、连接复杂性问题
🔸 标准端口：6446(读写)、6447(只读)、8443(管理)
🔸 关键配置：routing段配置路由策略和目标服务器
🔸 运行用户：专用mysqlrouter用户，最小权限原则
🔸 日志管理：INFO级别适合生产，支持日志轮转
```

### 12.2 安装配置要点


**🔹 安装选择策略**
```
生产环境：RPM/DEB包安装，稳定可靠
测试环境：二进制包安装，版本灵活
开发环境：源码编译，自定义优化

版本选择：
• 与MySQL Server版本保持兼容
• 选择GA正式版本，避免RC版本
• 考虑长期支持LTS版本
```

**🔹 配置文件最佳实践**
```
安全配置：
• 使用专用运行用户
• 限制监听地址和端口
• 设置合理的连接数限制

性能配置：
• 根据业务选择合适的路由策略
• 配置连接池和超时参数
• 启用适当的日志级别

高可用配置：
• 配置多个destinations作为备用
• 设置健康检查参数
• 启用故障自动转移
```

### 12.3 运维管理要点


**🔹 服务管理**
```
推荐方式：systemd服务管理
启动顺序：先启动MySQL，再启动Router
监控重点：端口监听、连接数、错误日志
备份内容：配置文件、密钥文件、状态文件
```

**🔹 故障排查思路**
```
问题分层：
1. Router进程层：进程状态、端口监听
2. 配置层：语法检查、权限验证  
3. 网络层：连通性测试、防火墙检查
4. 应用层：用户权限、SQL执行

日志分析：
• ERROR级别：立即处理的问题
• WARNING级别：需要关注的异常
• INFO级别：了解Router运行状态
```

### 12.4 实际应用价值


- **高可用架构**：自动故障转移，提升系统可靠性
- **读写分离**：分散数据库压力，提升整体性能
- **应用透明**：应用无需修改，降低改造成本
- **运维简化**：统一入口管理，简化数据库访问
- **扩展性好**：轻松添加新的数据库节点

**核心记忆**：
- Router是MySQL的智能代理，解决高可用和负载均衡
- 安装简单配置灵活，6446写6447读要记清
- 专用用户最小权限，安全配置是根本
- 日志监控很重要，故障排查有方法