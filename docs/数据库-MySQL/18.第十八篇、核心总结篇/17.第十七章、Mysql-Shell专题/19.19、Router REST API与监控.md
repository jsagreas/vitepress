---
title: 19ã€Router REST APIä¸ç›‘æ§
---
## ğŸ“š ç›®å½•

1. [REST APIåŸºç¡€æ¦‚å¿µ](#1-REST-APIåŸºç¡€æ¦‚å¿µ)
2. [å¯ç”¨å’Œé…ç½®REST API](#2-å¯ç”¨å’Œé…ç½®REST-API)
3. [æ ¸å¿ƒAPIç«¯ç‚¹è¯¦è§£](#3-æ ¸å¿ƒAPIç«¯ç‚¹è¯¦è§£)
4. [çŠ¶æ€æŸ¥è¯¢ä¸æ€§èƒ½ç›‘æ§](#4-çŠ¶æ€æŸ¥è¯¢ä¸æ€§èƒ½ç›‘æ§)
5. [è®¤è¯ä¸å®‰å…¨é…ç½®](#5-è®¤è¯ä¸å®‰å…¨é…ç½®)
6. [ç›‘æ§å·¥å…·é›†æˆ](#6-ç›‘æ§å·¥å…·é›†æˆ)
7. [è‡ªå®šä¹‰ç›‘æ§è„šæœ¬å¼€å‘](#7-è‡ªå®šä¹‰ç›‘æ§è„šæœ¬å¼€å‘)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ REST APIåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Router REST API


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
MySQL Router REST APIï¼šé€šè¿‡HTTPæ¥å£ç›‘æ§å’Œç®¡ç†Routerçš„åŠŸèƒ½
ä½œç”¨ï¼šè®©æˆ‘ä»¬å¯ä»¥ç”¨ç½‘é¡µæˆ–ç¨‹åºæ¥æŸ¥çœ‹Routerçš„è¿è¡ŒçŠ¶æ€
æœ¬è´¨ï¼šæŠŠRouterå†…éƒ¨ä¿¡æ¯é€šè¿‡HTTPæ¥å£æš´éœ²å‡ºæ¥
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦REST API**
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
- åªèƒ½é€šè¿‡æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹çŠ¶æ€
- æ— æ³•å®æ—¶è·å–è¯¦ç»†çš„æ€§èƒ½æ•°æ®
- éš¾ä»¥é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿä¸­
- ç¼ºä¹å¯è§†åŒ–çš„ç›‘æ§ç•Œé¢

REST APIçš„ä¼˜åŠ¿ï¼š
- å®æ—¶è·å–RouterçŠ¶æ€ä¿¡æ¯
- æ–¹ä¾¿é›†æˆå„ç§ç›‘æ§å·¥å…·
- æ”¯æŒè‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬
- æä¾›æ ‡å‡†åŒ–çš„æ•°æ®æ ¼å¼
```

### 1.2 APIçš„åŸºæœ¬å·¥ä½œåŸç†


**ğŸ”„ å·¥ä½œæµç¨‹å›¾ç¤º**
```
ç›‘æ§å®¢æˆ·ç«¯           Router REST API           Routeræ ¸å¿ƒ
     |                      |                      |
     |--HTTP GETè¯·æ±‚-------->|                      |
     |   /api/v1/status     |                      |
     |                      |--æŸ¥è¯¢å†…éƒ¨çŠ¶æ€-------->|
     |                      |<-è¿”å›çŠ¶æ€æ•°æ®---------|
     |<-JSONæ ¼å¼å“åº”--------|                      |
     |   çŠ¶æ€ä¿¡æ¯           |                      |
```

**ğŸ”¸ APIç‰¹ç‚¹**
- **RESTfulè®¾è®¡**ï¼šéµå¾ªRESTæ¶æ„åŸåˆ™ï¼Œä½¿ç”¨æ ‡å‡†HTTPæ–¹æ³•
- **JSONæ ¼å¼**ï¼šæ‰€æœ‰æ•°æ®éƒ½ä»¥JSONæ ¼å¼è¿”å›ï¼Œä¾¿äºè§£æ
- **å®æ—¶æ€§**ï¼šè¿”å›å½“å‰æœ€æ–°çš„RouterçŠ¶æ€ä¿¡æ¯
- **åªè¯»è®¿é—®**ï¼šä¸»è¦æä¾›æŸ¥è¯¢åŠŸèƒ½ï¼Œä¸æ”¯æŒä¿®æ”¹é…ç½®

---

## 2. âš™ï¸ å¯ç”¨å’Œé…ç½®REST API


### 2.1 åŸºç¡€é…ç½®å¯ç”¨


**ğŸ”§ é…ç½®æ–‡ä»¶è®¾ç½®**
```ini
# mysqlrouter.conf é…ç½®æ–‡ä»¶
[http_server]
# å¯ç”¨HTTPæœåŠ¡å™¨
port = 8443
# ç»‘å®šåœ°å€ï¼Œ0.0.0.0è¡¨ç¤ºç›‘å¬æ‰€æœ‰ç½‘å¡
bind_address = 0.0.0.0

[rest_api]
# å¯ç”¨REST APIåŠŸèƒ½
require_realm = default_auth_realm
```

**ğŸ’¡ é…ç½®è¯´æ˜**
```
ç«¯å£é€‰æ‹©ï¼š
- é»˜è®¤8443ç«¯å£ï¼ˆHTTPSï¼‰
- å¯ä»¥è‡ªå®šä¹‰å…¶ä»–ç«¯å£
- é¿å…ä¸å…¶ä»–æœåŠ¡å†²çª

ç»‘å®šåœ°å€ï¼š
- 127.0.0.1ï¼šåªå…è®¸æœ¬æœºè®¿é—®
- 0.0.0.0ï¼šå…è®¸æ‰€æœ‰IPè®¿é—®
- å…·ä½“IPï¼šåªå…è®¸æŒ‡å®šç½‘æ®µè®¿é—®
```

### 2.2 è®¤è¯é…ç½®è®¾ç½®


**ğŸ” åŸºç¡€è®¤è¯é…ç½®**
```ini
[http_auth_realm:default_auth_realm]
# è®¤è¯æ–¹å¼
backend = file
# è®¤è¯æ–‡ä»¶è·¯å¾„
filename = /opt/mysql/router/auth.txt
# è®¤è¯æ–¹å¼ï¼šbasicè¡¨ç¤ºHTTPåŸºç¡€è®¤è¯
method = basic
# åŸŸåï¼ˆå¯é€‰ï¼‰
name = MySQL Router REST API
```

**ğŸ“ åˆ›å»ºè®¤è¯æ–‡ä»¶**
```bash
# åˆ›å»ºè®¤è¯æ–‡ä»¶ç›®å½•
sudo mkdir -p /opt/mysql/router/

# åˆ›å»ºè®¤è¯æ–‡ä»¶ auth.txt
# æ ¼å¼ï¼šç”¨æˆ·å:å¯†ç å“ˆå¸Œ
echo "admin:$apr1$Tg/T8IYS$fmxpRMXyFBm/c3gMWKVv30" > /opt/mysql/router/auth.txt

# è®¾ç½®é€‚å½“çš„æƒé™
sudo chmod 600 /opt/mysql/router/auth.txt
sudo chown mysqlrouter:mysqlrouter /opt/mysql/router/auth.txt
```

> ğŸ’¡ **å®‰å…¨æç¤º**  
> å¯†ç åº”è¯¥ä½¿ç”¨å“ˆå¸Œå€¼å­˜å‚¨ï¼Œä¸è¦ä½¿ç”¨æ˜æ–‡å¯†ç 

### 2.3 HTTPSé…ç½®ï¼ˆæ¨èï¼‰


**ğŸ”’ SSLè¯ä¹¦é…ç½®**
```ini
[http_server]
port = 8443
bind_address = 0.0.0.0
# å¯ç”¨SSL
ssl = 1
# SSLè¯ä¹¦æ–‡ä»¶è·¯å¾„
ssl_cert = /opt/mysql/router/server-cert.pem
# SSLç§é’¥æ–‡ä»¶è·¯å¾„
ssl_key = /opt/mysql/router/server-key.pem

[rest_api]
require_realm = default_auth_realm
```

**ğŸ› ï¸ ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆæµ‹è¯•ç”¨ï¼‰**
```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out server-key.pem 2048

# ç”Ÿæˆè¯ä¹¦è¯·æ±‚
openssl req -new -key server-key.pem -out server-req.pem

# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl x509 -req -in server-req.pem -days 365 -key server-key.pem -out server-cert.pem

# è®¾ç½®æƒé™
chmod 600 server-key.pem server-cert.pem
```

---

## 3. ğŸ” æ ¸å¿ƒAPIç«¯ç‚¹è¯¦è§£


### 3.1 RouteråŸºæœ¬ä¿¡æ¯API


**ğŸ“Š è·å–Routerç‰ˆæœ¬ä¿¡æ¯**
```bash
# APIç«¯ç‚¹
GET /api/20190715/router/status

# è¯·æ±‚ç¤ºä¾‹
curl -u admin:password https://localhost:8443/api/20190715/router/status
```

**ğŸ“‹ å“åº”ç¤ºä¾‹**
```json
{
  "hostname": "mysql-router-01",
  "processId": 12345,
  "productEdition": "MySQL Router",
  "timeStarted": "2025-01-15T10:30:00Z",
  "version": "8.0.32"
}
```

**ğŸ”¸ å­—æ®µå«ä¹‰**
- **hostname**: Routerè¿è¡Œçš„ä¸»æœºå
- **processId**: Routerè¿›ç¨‹ID
- **timeStarted**: Routerå¯åŠ¨æ—¶é—´
- **version**: Routerç‰ˆæœ¬å·

### 3.2 è¿æ¥çŠ¶æ€API


**ğŸ“Š è·å–è¿æ¥ç»Ÿè®¡ä¿¡æ¯**
```bash
# APIç«¯ç‚¹
GET /api/20190715/routes

# è¯·æ±‚ç¤ºä¾‹
curl -u admin:password https://localhost:8443/api/20190715/routes
```

**ğŸ“‹ è¯¦ç»†å“åº”ç¤ºä¾‹**
```json
{
  "routes": [
    {
      "name": "myapp_rw",
      "protocol": "classic",
      "destinations": [
        {
          "address": "192.168.1.10:3306",
          "port": 3306,
          "weight": 1,
          "activeConnections": 15,
          "totalConnections": 1247,
          "timeStarted": "2025-01-15T10:30:00Z"
        }
      ]
    }
  ]
}
```

### 3.3 è¿æ¥è¯¦ç»†ç»Ÿè®¡API


**ğŸ“ˆ è·å–è¯¦ç»†è¿æ¥ä¿¡æ¯**
```bash
# è·å–ç‰¹å®šè·¯ç”±çš„è¿æ¥ä¿¡æ¯
GET /api/20190715/routes/{routeName}/connections

# è¯·æ±‚ç¤ºä¾‹
curl -u admin:password \
  https://localhost:8443/api/20190715/routes/myapp_rw/connections
```

**ğŸ“Š è¿æ¥ç»Ÿè®¡å“åº”**
```json
{
  "activeConnections": 25,
  "totalConnections": 5847,
  "maxConnections": 1000,
  "connectionsRefused": 3,
  "connections": [
    {
      "bytesFromServer": 1048576,
      "bytesToServer": 524288,
      "timeConnectedToServer": "2025-01-15T11:45:30Z",
      "timeLastReceivedFromServer": "2025-01-15T12:00:15Z",
      "timeLastSentToServer": "2025-01-15T12:00:10Z"
    }
  ]
}
```

---

## 4. ğŸ“Š çŠ¶æ€æŸ¥è¯¢ä¸æ€§èƒ½ç›‘æ§


### 4.1 å¥åº·çŠ¶æ€æ£€æŸ¥


**ğŸ¥ åŸºç¡€å¥åº·æ£€æŸ¥ç«¯ç‚¹**
```bash
# ç®€å•å¥åº·æ£€æŸ¥
GET /api/20190715/router/health

# è¯·æ±‚ç¤ºä¾‹
curl -u admin:password https://localhost:8443/api/20190715/router/health
```

**âœ… å¥åº·çŠ¶æ€å“åº”**
```json
{
  "status": "ok",
  "timestamp": "2025-01-15T12:00:00Z",
  "uptime": 7200,
  "warnings": [],
  "errors": []
}
```

### 4.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§


**ğŸ“ˆ è·å–æ€§èƒ½æŒ‡æ ‡**
```bash
# è·å–Routeræ€§èƒ½ç»Ÿè®¡
GET /api/20190715/router/status

# è·å–æ¯ä¸ªè·¯ç”±çš„æ€§èƒ½æ•°æ®
GET /api/20190715/routes/{routeName}/status
```

**ğŸ“Š æ€§èƒ½æ•°æ®ç¤ºä¾‹**
```json
{
  "routeStatus": {
    "myapp_rw": {
      "isAlive": true,
      "totalConnections": 15672,
      "activeConnections": 45,
      "avgResponseTime": 12.5,
      "errorRate": 0.02,
      "lastActivity": "2025-01-15T12:00:00Z"
    }
  }
}
```

### 4.3 å®æ—¶ç›‘æ§è„šæœ¬ç¤ºä¾‹


**ğŸ”§ Pythonç›‘æ§è„šæœ¬**
```python
#!/usr/bin/env python3
import requests
import json
import time
from requests.auth import HTTPBasicAuth

class RouterMonitor:
    def __init__(self, router_host, username, password):
        self.base_url = f"https://{router_host}:8443/api/20190715"
        self.auth = HTTPBasicAuth(username, password)
        # å¿½ç•¥SSLè¯ä¹¦éªŒè¯ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰
        self.session = requests.Session()
        self.session.verify = False
    
    def get_router_status(self):
        """è·å–RouteråŸºæœ¬çŠ¶æ€"""
        try:
            response = self.session.get(
                f"{self.base_url}/router/status",
                auth=self.auth
            )
            return response.json()
        except Exception as e:
            print(f"è·å–çŠ¶æ€å¤±è´¥: {e}")
            return None
    
    def get_routes_info(self):
        """è·å–æ‰€æœ‰è·¯ç”±ä¿¡æ¯"""
        try:
            response = self.session.get(
                f"{self.base_url}/routes",
                auth=self.auth
            )
            return response.json()
        except Exception as e:
            print(f"è·å–è·¯ç”±ä¿¡æ¯å¤±è´¥: {e}")
            return None
    
    def monitor_connections(self):
        """ç›‘æ§è¿æ¥æ•°å˜åŒ–"""
        while True:
            routes = self.get_routes_info()
            if routes:
                for route in routes.get('routes', []):
                    name = route.get('name')
                    active_conn = sum(
                        dest.get('activeConnections', 0) 
                        for dest in route.get('destinations', [])
                    )
                    print(f"è·¯ç”± {name}: æ´»è·ƒè¿æ¥æ•° {active_conn}")
            
            time.sleep(10)  # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    monitor = RouterMonitor('localhost', 'admin', 'password')
    monitor.monitor_connections()
```

---

## 5. ğŸ” è®¤è¯ä¸å®‰å…¨é…ç½®


### 5.1 è®¤è¯æ–¹å¼è¯¦è§£


**ğŸ”¸ HTTP Basicè®¤è¯**
```ini
[http_auth_realm:default_auth_realm]
backend = file
filename = /opt/mysql/router/auth.txt
method = basic
name = Router API
```

**ğŸ”§ è®¤è¯æ–‡ä»¶æ ¼å¼**
```bash
# auth.txt æ–‡ä»¶æ ¼å¼
# ç”¨æˆ·å:åŠ å¯†å¯†ç 

# ä½¿ç”¨htpasswdç”Ÿæˆå¯†ç å“ˆå¸Œ
htpasswd -c /opt/mysql/router/auth.txt admin

# æˆ–è€…æ‰‹åŠ¨åˆ›å»ºï¼ˆä¸æ¨èæ˜æ–‡å¯†ç ï¼‰
# admin:$apr1$Tg/T8IYS$fmxpRMXyFBm/c3gMWKVv30
```

### 5.2 è®¿é—®æƒé™æ§åˆ¶


**ğŸ›¡ï¸ IPè®¿é—®é™åˆ¶é…ç½®**
```ini
[http_server]
port = 8443
# åªå…è®¸ç‰¹å®šIPæ®µè®¿é—®
bind_address = 192.168.1.0/24

# æˆ–è€…åªå…è®¸æœ¬æœºè®¿é—®
bind_address = 127.0.0.1
```

**ğŸ”’ é˜²ç«å¢™é…ç½®å»ºè®®**
```bash
# åªå…è®¸ç‰¹å®šIPè®¿é—®8443ç«¯å£
sudo firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.1.0/24" port protocol="tcp" port="8443" accept'

# é‡æ–°åŠ è½½é˜²ç«å¢™é…ç½®
sudo firewall-cmd --reload
```

### 5.3 SSL/TLSå®‰å…¨é…ç½®


**ğŸ” ç”Ÿäº§ç¯å¢ƒSSLé…ç½®**
```ini
[http_server]
port = 8443
bind_address = 0.0.0.0
ssl = 1
ssl_cert = /etc/ssl/certs/router.crt
ssl_key = /etc/ssl/private/router.key
# æŒ‡å®šSSLåè®®ç‰ˆæœ¬
ssl_protocols = TLSv1.2,TLSv1.3
# æŒ‡å®šåŠ å¯†å¥—ä»¶
ssl_ciphers = HIGH:!aNULL:!MD5
```

---

## 6. ğŸ”§ ç›‘æ§å·¥å…·é›†æˆ


### 6.1 Prometheusé›†æˆ


**ğŸ“Š Prometheusé…ç½®**
```yaml
# prometheus.yml é…ç½®
scrape_configs:
  - job_name: 'mysql-router'
    static_configs:
      - targets: ['mysql-router-01:8443']
    scheme: https
    basic_auth:
      username: 'admin'
      password: 'password'
    tls_config:
      insecure_skip_verify: true  # ä»…æµ‹è¯•ç¯å¢ƒ
    metrics_path: '/api/20190715/routes'
    scrape_interval: 30s
```

**ğŸ”§ è‡ªå®šä¹‰Exporterè„šæœ¬**
```python
#!/usr/bin/env python3
import requests
import time
from prometheus_client import start_http_server, Gauge
from requests.auth import HTTPBasicAuth

# å®šä¹‰PrometheusæŒ‡æ ‡
router_active_connections = Gauge(
    'mysql_router_active_connections',
    'Active connections to MySQL Router',
    ['route_name', 'destination']
)

router_total_connections = Gauge(
    'mysql_router_total_connections',
    'Total connections to MySQL Router',
    ['route_name', 'destination']
)

class RouterExporter:
    def __init__(self, router_url, username, password):
        self.router_url = router_url
        self.auth = HTTPBasicAuth(username, password)
        
    def collect_metrics(self):
        """æ”¶é›†RouteræŒ‡æ ‡"""
        try:
            response = requests.get(
                f"{self.router_url}/api/20190715/routes",
                auth=self.auth,
                verify=False
            )
            data = response.json()
            
            for route in data.get('routes', []):
                route_name = route.get('name')
                for dest in route.get('destinations', []):
                    dest_addr = dest.get('address')
                    
                    router_active_connections.labels(
                        route_name=route_name,
                        destination=dest_addr
                    ).set(dest.get('activeConnections', 0))
                    
                    router_total_connections.labels(
                        route_name=route_name,
                        destination=dest_addr
                    ).set(dest.get('totalConnections', 0))
                    
        except Exception as e:
            print(f"æ”¶é›†æŒ‡æ ‡å¤±è´¥: {e}")

if __name__ == '__main__':
    exporter = RouterExporter(
        'https://localhost:8443',
        'admin',
        'password'
    )
    
    # å¯åŠ¨PrometheusæŒ‡æ ‡æœåŠ¡å™¨
    start_http_server(9090)
    
    while True:
        exporter.collect_metrics()
        time.sleep(30)
```

### 6.2 Grafanaä»ªè¡¨æ¿é…ç½®


**ğŸ“ˆ Grafana Panelé…ç½®ç¤ºä¾‹**
```json
{
  "dashboard": {
    "title": "MySQL Routerç›‘æ§",
    "panels": [
      {
        "title": "æ´»è·ƒè¿æ¥æ•°",
        "type": "graph",
        "targets": [
          {
            "expr": "mysql_router_active_connections",
            "legendFormat": "{{route_name}} - {{destination}}"
          }
        ]
      }
    ]
  }
}
```

### 6.3 Zabbixç›‘æ§é›†æˆ


**ğŸ” Zabbixç›‘æ§é¡¹é…ç½®**
```bash
# Zabbix UserParameteré…ç½®
# /etc/zabbix/zabbix_agentd.d/mysql_router.conf

UserParameter=mysql.router.status[*],/usr/local/bin/check_router_status.sh $1
UserParameter=mysql.router.connections[*],/usr/local/bin/check_router_connections.sh $1 $2
```

**ğŸ› ï¸ ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# check_router_status.sh

ROUTER_HOST="localhost:8443"
USERNAME="admin"
PASSWORD="password"

case $1 in
    "health")
        curl -s -u ${USERNAME}:${PASSWORD} \
            https://${ROUTER_HOST}/api/20190715/router/health \
            -k | jq -r '.status'
        ;;
    "uptime")
        curl -s -u ${USERNAME}:${PASSWORD} \
            https://${ROUTER_HOST}/api/20190715/router/status \
            -k | jq -r '.uptime // 0'
        ;;
    *)
        echo "æœªçŸ¥å‚æ•°"
        exit 1
        ;;
esac
```

---

## 7. ğŸ“ è‡ªå®šä¹‰ç›‘æ§è„šæœ¬å¼€å‘


### 7.1 è¿æ¥ç›‘æ§è„šæœ¬


**ğŸ”§ å®Œæ•´çš„è¿æ¥ç›‘æ§è„šæœ¬**
```python
#!/usr/bin/env python3
"""
MySQL Routerè¿æ¥ç›‘æ§è„šæœ¬
åŠŸèƒ½ï¼šç›‘æ§è¿æ¥æ•°ã€æ€§èƒ½æŒ‡æ ‡ã€å¥åº·çŠ¶æ€
"""

import requests
import json
import time
import logging
import smtplib
from email.mime.text import MIMEText
from requests.auth import HTTPBasicAuth
from datetime import datetime

class RouterMonitor:
    def __init__(self, config):
        self.config = config
        self.router_url = f"https://{config['host']}:{config['port']}"
        self.auth = HTTPBasicAuth(config['username'], config['password'])
        
        # é…ç½®æ—¥å¿—
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('router_monitor.log'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    def check_router_health(self):
        """æ£€æŸ¥Routerå¥åº·çŠ¶æ€"""
        try:
            response = requests.get(
                f"{self.router_url}/api/20190715/router/health",
                auth=self.auth,
                verify=False,
                timeout=10
            )
            
            if response.status_code == 200:
                health_data = response.json()
                return health_data.get('status') == 'ok'
            else:
                self.logger.error(f"å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
                return False
                
        except Exception as e:
            self.logger.error(f"å¥åº·æ£€æŸ¥å¼‚å¸¸: {e}")
            return False
    
    def get_connection_stats(self):
        """è·å–è¿æ¥ç»Ÿè®¡ä¿¡æ¯"""
        try:
            response = requests.get(
                f"{self.router_url}/api/20190715/routes",
                auth=self.auth,
                verify=False,
                timeout=10
            )
            
            if response.status_code == 200:
                return response.json()
            else:
                self.logger.error(f"è·å–è¿æ¥ç»Ÿè®¡å¤±è´¥: {response.status_code}")
                return None
                
        except Exception as e:
            self.logger.error(f"è·å–è¿æ¥ç»Ÿè®¡å¼‚å¸¸: {e}")
            return None
    
    def check_connection_thresholds(self, routes_data):
        """æ£€æŸ¥è¿æ¥æ•°é˜ˆå€¼"""
        alerts = []
        
        for route in routes_data.get('routes', []):
            route_name = route.get('name')
            
            for dest in route.get('destinations', []):
                active_conn = dest.get('activeConnections', 0)
                max_conn = self.config.get('max_connections', 1000)
                
                # è¿æ¥æ•°è¶…è¿‡é˜ˆå€¼80%æ—¶å‘Šè­¦
                if active_conn > max_conn * 0.8:
                    alert_msg = f"è·¯ç”± {route_name} è¿æ¥æ•°è¿‡é«˜: {active_conn}/{max_conn}"
                    alerts.append(alert_msg)
                    self.logger.warning(alert_msg)
        
        return alerts
    
    def send_alert(self, message):
        """å‘é€å‘Šè­¦é‚®ä»¶"""
        if not self.config.get('email_enabled', False):
            return
        
        try:
            msg = MIMEText(message, 'plain', 'utf-8')
            msg['Subject'] = 'MySQL Routerç›‘æ§å‘Šè­¦'
            msg['From'] = self.config['smtp']['from']
            msg['To'] = self.config['smtp']['to']
            
            server = smtplib.SMTP(
                self.config['smtp']['host'],
                self.config['smtp']['port']
            )
            server.starttls()
            server.login(
                self.config['smtp']['username'],
                self.config['smtp']['password']
            )
            server.send_message(msg)
            server.quit()
            
            self.logger.info("å‘Šè­¦é‚®ä»¶å‘é€æˆåŠŸ")
            
        except Exception as e:
            self.logger.error(f"å‘é€å‘Šè­¦é‚®ä»¶å¤±è´¥: {e}")
    
    def run_monitoring(self):
        """è¿è¡Œç›‘æ§å¾ªç¯"""
        self.logger.info("å¼€å§‹Routerç›‘æ§...")
        
        while True:
            try:
                # å¥åº·æ£€æŸ¥
                if not self.check_router_health():
                    alert_msg = "Routerå¥åº·æ£€æŸ¥å¤±è´¥ï¼"
                    self.logger.error(alert_msg)
                    self.send_alert(alert_msg)
                
                # è¿æ¥ç›‘æ§
                routes_data = self.get_connection_stats()
                if routes_data:
                    alerts = self.check_connection_thresholds(routes_data)
                    
                    if alerts:
                        alert_message = "\n".join(alerts)
                        self.send_alert(alert_message)
                    
                    # è®°å½•å½“å‰çŠ¶æ€
                    self.log_current_status(routes_data)
                
                # ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
                time.sleep(self.config.get('check_interval', 60))
                
            except KeyboardInterrupt:
                self.logger.info("ç›‘æ§ç¨‹åºé€€å‡º")
                break
            except Exception as e:
                self.logger.error(f"ç›‘æ§å¼‚å¸¸: {e}")
                time.sleep(30)  # å¼‚å¸¸æ—¶ç­‰å¾…30ç§’å†é‡è¯•
    
    def log_current_status(self, routes_data):
        """è®°å½•å½“å‰çŠ¶æ€"""
        for route in routes_data.get('routes', []):
            route_name = route.get('name')
            total_active = sum(
                dest.get('activeConnections', 0) 
                for dest in route.get('destinations', [])
            )
            
            self.logger.info(f"è·¯ç”± {route_name}: æ´»è·ƒè¿æ¥ {total_active}")

# é…ç½®æ–‡ä»¶ç¤ºä¾‹
config = {
    'host': 'localhost',
    'port': 8443,
    'username': 'admin',
    'password': 'password',
    'max_connections': 1000,
    'check_interval': 60,  # æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    'email_enabled': True,
    'smtp': {
        'host': 'smtp.example.com',
        'port': 587,
        'username': 'monitor@example.com',
        'password': 'email_password',
        'from': 'monitor@example.com',
        'to': 'admin@example.com'
    }
}

if __name__ == '__main__':
    monitor = RouterMonitor(config)
    monitor.run_monitoring()
```

### 7.2 æ€§èƒ½åˆ†æè„šæœ¬


**ğŸ“Š æ€§èƒ½æ•°æ®æ”¶é›†è„šæœ¬**
```bash
#!/bin/bash
# router_performance_collector.sh

ROUTER_HOST="localhost:8443"
USERNAME="admin"
PASSWORD="password"
OUTPUT_DIR="/var/log/mysql-router"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p ${OUTPUT_DIR}

# æ”¶é›†RouterçŠ¶æ€
echo "æ”¶é›†RouterçŠ¶æ€ä¿¡æ¯..."
curl -s -u ${USERNAME}:${PASSWORD} \
    https://${ROUTER_HOST}/api/20190715/router/status \
    -k > ${OUTPUT_DIR}/router_status_${DATE}.json

# æ”¶é›†è·¯ç”±ä¿¡æ¯
echo "æ”¶é›†è·¯ç”±ç»Ÿè®¡ä¿¡æ¯..."
curl -s -u ${USERNAME}:${PASSWORD} \
    https://${ROUTER_HOST}/api/20190715/routes \
    -k > ${OUTPUT_DIR}/routes_status_${DATE}.json

# ç”Ÿæˆç®€å•æŠ¥å‘Š
echo "ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š..."
python3 << EOF
import json
import os
from datetime import datetime

# è¯»å–æ•°æ®æ–‡ä»¶
with open('${OUTPUT_DIR}/routes_status_${DATE}.json', 'r') as f:
    routes_data = json.load(f)

print("=== MySQL Routeræ€§èƒ½æŠ¥å‘Š ===")
print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
print()

for route in routes_data.get('routes', []):
    route_name = route.get('name')
    print(f"è·¯ç”±: {route_name}")
    
    total_active = 0
    total_connections = 0
    
    for dest in route.get('destinations', []):
        addr = dest.get('address')
        active = dest.get('activeConnections', 0)
        total = dest.get('totalConnections', 0)
        
        print(f"  ç›®æ ‡: {addr}")
        print(f"    æ´»è·ƒè¿æ¥: {active}")
        print(f"    æ€»è¿æ¥æ•°: {total}")
        
        total_active += active
        total_connections += total
    
    print(f"  è·¯ç”±æ€»è®¡:")
    print(f"    æ´»è·ƒè¿æ¥: {total_active}")
    print(f"    å†å²æ€»è¿æ¥: {total_connections}")
    print()
EOF

echo "æŠ¥å‘Šå®Œæˆï¼Œæ•°æ®ä¿å­˜åœ¨ ${OUTPUT_DIR}"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ REST APIæœ¬è´¨ï¼šé€šè¿‡HTTPæ¥å£ç›‘æ§å’Œç®¡ç†Router
ğŸ”¸ é…ç½®è¦ç´ ï¼šhttp_server + rest_api + è®¤è¯é…ç½®
ğŸ”¸ æ ¸å¿ƒç«¯ç‚¹ï¼š/router/statusã€/routesã€/health
ğŸ”¸ å®‰å…¨é…ç½®ï¼šHTTPS + è®¤è¯ + è®¿é—®æ§åˆ¶
ğŸ”¸ ç›‘æ§é›†æˆï¼šPrometheusã€Grafanaã€Zabbixç­‰å·¥å…·
ğŸ”¸ è‡ªå®šä¹‰è„šæœ¬ï¼šPython/Bashè„šæœ¬å®ç°å®šåˆ¶ç›‘æ§
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ APIçš„å®é™…ä½œç”¨**
```
å®æ—¶ç›‘æ§ï¼š
- è·å–å½“å‰è¿æ¥æ•°å’ŒçŠ¶æ€
- ç›‘æ§Routerå¥åº·çŠ¶å†µ
- è¿½è¸ªæ€§èƒ½æŒ‡æ ‡å˜åŒ–

è¿ç»´é›†æˆï¼š
- é›†æˆåˆ°ç°æœ‰ç›‘æ§ç³»ç»Ÿ
- å®ç°è‡ªåŠ¨åŒ–å‘Šè­¦
- æ”¯æŒå¯è§†åŒ–å±•ç¤º
```

**ğŸ”¹ å®‰å…¨é…ç½®çš„é‡è¦æ€§**
```
è®¤è¯ä¿æŠ¤ï¼š
- é˜²æ­¢æœªæˆæƒè®¿é—®
- ä½¿ç”¨å¼ºå¯†ç å’Œå“ˆå¸Œå­˜å‚¨
- å¯ç”¨HTTPSåŠ å¯†ä¼ è¾“

è®¿é—®æ§åˆ¶ï¼š
- é™åˆ¶è®¿é—®IPèŒƒå›´
- é…ç½®é˜²ç«å¢™è§„åˆ™
- å®šæœŸæ›´æ–°è®¤è¯ä¿¡æ¯
```

**ğŸ”¹ ç›‘æ§ç­–ç•¥çš„åˆ¶å®š**
```
ç›‘æ§æŒ‡æ ‡é€‰æ‹©ï¼š
- è¿æ¥æ•°ï¼ˆæ´»è·ƒ/æ€»æ•°ï¼‰
- å¥åº·çŠ¶æ€æ£€æŸ¥
- å“åº”æ—¶é—´ç›‘æ§
- é”™è¯¯ç‡ç»Ÿè®¡

å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
- è¿æ¥æ•°è¶…è¿‡80%å‘Šè­¦
- å¥åº·æ£€æŸ¥å¤±è´¥ç«‹å³å‘Šè­¦
- å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼å‘Šè­¦
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è¿ç»´æ•ˆç‡æå‡**
- **å®æ—¶ç›‘æ§**ï¼šéšæ—¶äº†è§£Routerè¿è¡ŒçŠ¶æ€
- **é—®é¢˜é¢„è­¦**ï¼šæå‰å‘ç°æ½œåœ¨é—®é¢˜
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå‡å°‘äººå·¥å¹²é¢„éœ€æ±‚
- **å†å²åˆ†æ**ï¼šåŸºäºæ•°æ®åšå®¹é‡è§„åˆ’

**ğŸ”§ ç›‘æ§ç³»ç»Ÿé›†æˆ**
- **ç»Ÿä¸€ç›‘æ§**ï¼šé›†æˆåˆ°ç°æœ‰ç›‘æ§ä½“ç³»
- **å¯è§†åŒ–å±•ç¤º**ï¼šç›´è§‚çš„å›¾è¡¨å’Œä»ªè¡¨æ¿
- **å‘Šè­¦é€šçŸ¥**ï¼šåŠæ—¶çš„é—®é¢˜é€šçŸ¥æœºåˆ¶
- **æ•°æ®åˆ†æ**ï¼šæ”¯æŒæ€§èƒ½è¶‹åŠ¿åˆ†æ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- REST APIè®©RouterçŠ¶æ€å˜å¾—å¯è§å’Œå¯æ§
- å®‰å…¨é…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…è¦æ¡ä»¶
- ç›‘æ§å·¥å…·é›†æˆèƒ½å¤§å¹…æå‡è¿ç»´æ•ˆç‡
- è‡ªå®šä¹‰è„šæœ¬æä¾›çµæ´»çš„ç›‘æ§è§£å†³æ–¹æ¡ˆ