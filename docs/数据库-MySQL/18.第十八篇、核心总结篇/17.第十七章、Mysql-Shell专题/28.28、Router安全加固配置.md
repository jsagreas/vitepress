---
title: 28ã€Routerå®‰å…¨åŠ å›ºé…ç½®
---
## ðŸ“š ç›®å½•

1. [Routerå®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-routerå®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [ç”¨æˆ·è´¦æˆ·å®‰å…¨ç®¡ç†](#2-ç”¨æˆ·è´¦æˆ·å®‰å…¨ç®¡ç†)
3. [ç½‘ç»œè®¿é—®æŽ§åˆ¶](#3-ç½‘ç»œè®¿é—®æŽ§åˆ¶)
4. [SSL/TLSåŠ å¯†é…ç½®](#4-ssltlsåŠ å¯†é…ç½®)
5. [è®¤è¯æœºåˆ¶ä¸Žæƒé™æŽ§åˆ¶](#5-è®¤è¯æœºåˆ¶ä¸Žæƒé™æŽ§åˆ¶)
6. [é˜²ç«å¢™ä¸Žç«¯å£å®‰å…¨](#6-é˜²ç«å¢™ä¸Žç«¯å£å®‰å…¨)
7. [å®‰å…¨ç›‘æŽ§ä¸Žå…¥ä¾µæ£€æµ‹](#7-å®‰å…¨ç›‘æŽ§ä¸Žå…¥ä¾µæ£€æµ‹)
8. [å®‰å…¨åˆè§„æ£€æŸ¥](#8-å®‰å…¨åˆè§„æ£€æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ” Routerå®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯MySQL Routerå®‰å…¨


**ç®€å•ç†è§£**ï¼š
```
æƒ³è±¡MySQL Routerå°±åƒä¸€ä¸ªæ™ºèƒ½é—¨å«ï¼š
â€¢ ç«™åœ¨åº”ç”¨ç¨‹åºå’Œæ•°æ®åº“ä¹‹é—´
â€¢ æ£€æŸ¥æ¯ä¸ªäººçš„èº«ä»½è¯ï¼ˆè®¤è¯ï¼‰
â€¢ å†³å®šè°èƒ½è¿›å…¥å“ªä¸ªæˆ¿é—´ï¼ˆæŽˆæƒï¼‰
â€¢ ç›‘æŽ§å¯ç–‘è¡Œä¸ºï¼ˆç›‘æŽ§ï¼‰
â€¢ ä¿æŠ¤é€šä¿¡å®‰å…¨ï¼ˆåŠ å¯†ï¼‰

æ²¡æœ‰å®‰å…¨é…ç½®çš„Router = æ²¡æœ‰é—¨å«çš„å¤§æ¥¼ï¼
```

### 1.2 Routerå®‰å…¨å¨èƒåˆ†æž


**ðŸš¨ å¸¸è§å®‰å…¨é£Žé™©**
```
ç½‘ç»œå±‚å¨èƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶æ„å®¢æˆ·ç«¯      â”‚ â”€â”€æ”»å‡»â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ SQLæ³¨å…¥      â”‚           â”‚ MySQL Routerâ”‚
â”‚  â€¢ æš´åŠ›ç ´è§£      â”‚           â”‚ (æ— é˜²æŠ¤)    â”‚
â”‚  â€¢ ä¸­é—´äººæ”»å‡»    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                                    â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ MySQLé›†ç¾¤   â”‚
                            â”‚ (è¢«å…¥ä¾µ)    â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ é£Žé™©å½±å“**
- **æ•°æ®æ³„éœ²**ï¼šæ•æ„Ÿä¿¡æ¯è¢«çªƒå–
- **æ•°æ®ç¯¡æ”¹**ï¼šé‡è¦æ•°æ®è¢«æ¶æ„ä¿®æ”¹
- **æœåŠ¡ä¸­æ–­**ï¼šç³»ç»Ÿè¢«æ”»å‡»å¯¼è‡´ä¸å¯ç”¨
- **åˆè§„è¿è§„**ï¼šä¸ç¬¦åˆå®‰å…¨æ ‡å‡†è¦æ±‚

### 1.3 å®‰å…¨é˜²æŠ¤ä½“ç³»


**ðŸ›¡ï¸ å¤šå±‚é˜²æŠ¤æž¶æž„**
```
å®‰å…¨é˜²æŠ¤å±‚æ¬¡ï¼š
åº”ç”¨å±‚ â”€â”€â”€â”€â”
          â”‚ åº”ç”¨è®¤è¯
ç½‘ç»œå±‚ â”€â”€â”€â”€â”¤ â†“
          â”‚ Routerå®‰å…¨ç½‘å…³ â† æˆ‘ä»¬çš„é‡ç‚¹
ä¼ è¾“å±‚ â”€â”€â”€â”€â”¤ â†“
          â”‚ SSL/TLSåŠ å¯†
æ•°æ®å±‚ â”€â”€â”€â”€â”˜ â†“
             MySQLå®‰å…¨
```

---

## 2. ðŸ‘¤ ç”¨æˆ·è´¦æˆ·å®‰å…¨ç®¡ç†


### 2.1 Routerä¸“ç”¨è´¦æˆ·åˆ›å»º


**ðŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ä¸“ç”¨è´¦æˆ·**
```
å°±åƒé“¶è¡Œå‡ºçº³å‘˜ï¼š
â€¢ ä¸èƒ½ç”¨è¡Œé•¿è´¦æˆ·åšæ—¥å¸¸ä¸šåŠ¡
â€¢ æ¯ä¸ªè§’è‰²æœ‰ç‰¹å®šæƒé™
â€¢ æœ€å°æƒé™åŽŸåˆ™
â€¢ ä¾¿äºŽå®¡è®¡è¿½è¸ª
```

**ðŸ”§ åˆ›å»ºRouterä¸“ç”¨è´¦æˆ·**
```sql
-- 1. åˆ›å»ºRouterç›‘æŽ§è´¦æˆ·
CREATE USER 'router_monitor'@'%' 
IDENTIFIED BY 'Strong_Password_123!' 
PASSWORD_REQUIRE_CURRENT;

-- 2. åˆ›å»ºRouterç®¡ç†è´¦æˆ·  
CREATE USER 'router_admin'@'localhost'
IDENTIFIED BY 'Admin_Pass_456!'
PASSWORD_REQUIRE_CURRENT;

-- 3. è®¾ç½®å¯†ç ç­–ç•¥
ALTER USER 'router_monitor'@'%' 
PASSWORD_EXPIRE_INTERVAL 90;
```

### 2.2 æœ€å°æƒé™åˆ†é…


**ðŸ“‹ æƒé™åˆ†çº§ç­–ç•¥**

| è´¦æˆ·ç±»åž‹ | **æƒé™èŒƒå›´** | **å…·ä½“æƒé™** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| `router_monitor` | **åªè¯»ç›‘æŽ§** | `SELECT on performance_schema.*` | `å¥åº·æ£€æŸ¥ã€çŠ¶æ€ç›‘æŽ§` |
| `router_readwrite` | **è¯»å†™ä¸šåŠ¡** | `SELECT, INSERT, UPDATE, DELETE` | `åº”ç”¨è¿žæŽ¥` |
| `router_admin` | **ç®¡ç†é…ç½®** | `ALL PRIVILEGES on mysql_innodb_cluster_metadata.*` | `é›†ç¾¤ç®¡ç†` |

**ðŸ”§ æƒé™é…ç½®ç¤ºä¾‹**
```sql
-- ç›‘æŽ§è´¦æˆ·æƒé™ï¼ˆæœ€å°åŒ–ï¼‰
GRANT SELECT ON performance_schema.replication_group_members TO 'router_monitor'@'%';
GRANT SELECT ON performance_schema.replication_group_member_stats TO 'router_monitor'@'%';

-- ä¸šåŠ¡è´¦æˆ·æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON business_db.* TO 'router_readwrite'@'%';

-- ç®¡ç†è´¦æˆ·æƒé™
GRANT ALL PRIVILEGES ON mysql_innodb_cluster_metadata.* TO 'router_admin'@'localhost';
```

### 2.3 è´¦æˆ·å®‰å…¨ç­–ç•¥


**ðŸ”’ å¯†ç å®‰å…¨é…ç½®**
```sql
-- å¼ºå¯†ç ç­–ç•¥
SET GLOBAL validate_password.policy = STRONG;
SET GLOBAL validate_password.length = 12;
SET GLOBAL validate_password.mixed_case_count = 2;
SET GLOBAL validate_password.number_count = 2;
SET GLOBAL validate_password.special_char_count = 2;

-- è´¦æˆ·é”å®šç­–ç•¥
ALTER USER 'router_monitor'@'%' 
FAILED_LOGIN_ATTEMPTS 3 
PASSWORD_LOCK_TIME 2;
```

---

## 3. ðŸŒ ç½‘ç»œè®¿é—®æŽ§åˆ¶


### 3.1 IPç™½åå•é…ç½®


**ðŸ’¡ ç½‘ç»œè®¿é—®æŽ§åˆ¶åŽŸç†**
```
åƒå°åŒºé—¨ç¦ç³»ç»Ÿï¼š
â€¢ åªæœ‰ç™»è®°çš„è½¦ç‰Œæ‰èƒ½è¿›å…¥
â€¢ é™Œç”Ÿè½¦è¾†ä¸€å¾‹æ‹’ç»
â€¢ å®šæœŸæ›´æ–°ç™½åå•
â€¢ è®°å½•æ‰€æœ‰è¿›å‡ºè®°å½•
```

**ðŸ“ Routerç½‘ç»œé…ç½®**
```ini
# mysqlrouter.conf
[routing:primary]
bind_address = 192.168.1.100  # åªç»‘å®šå†…ç½‘IP
bind_port = 6446

# å…è®¸çš„å®¢æˆ·ç«¯ç½‘æ®µ
destinations = 192.168.1.10:3306,192.168.1.11:3306

[routing:secondary]  
bind_address = 192.168.1.100
bind_port = 6447
routing_strategy = round-robin-with-fallback
```

### 3.2 ç½‘ç»œåˆ†æ®µéš”ç¦»


**ðŸ—ï¸ ç½‘ç»œæž¶æž„è®¾è®¡**
```
ç½‘ç»œåˆ†æ®µç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æœåŠ¡å™¨     â”‚    â”‚  MySQL Router   â”‚    â”‚   MySQLé›†ç¾¤     â”‚
â”‚ 192.168.1.0/24  â”‚â”€â”€â”€â”€â”‚ 192.168.2.0/24  â”‚â”€â”€â”€â”€â”‚ 192.168.3.0/24  â”‚
â”‚   (DMZåŒºåŸŸ)     â”‚    â”‚   (ä»£ç†åŒºåŸŸ)     â”‚    â”‚   (æ•°æ®åº“åŒºåŸŸ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ðŸ”§ ç½‘ç»œç­–ç•¥é…ç½®**
```bash
# iptablesè§„åˆ™ç¤ºä¾‹
# åªå…è®¸åº”ç”¨æœåŠ¡å™¨è¿žæŽ¥Router
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 6446 -j ACCEPT
iptables -A INPUT -p tcp --dport 6446 -j DROP

# åªå…è®¸Routerè¿žæŽ¥æ•°æ®åº“
iptables -A OUTPUT -d 192.168.3.0/24 -p tcp --dport 3306 -j ACCEPT
```

### 3.3 è¿žæŽ¥æ•°é™åˆ¶


**âš¡ è¿žæŽ¥æŽ§åˆ¶é…ç½®**
```ini
# è¿žæŽ¥æ•°æŽ§åˆ¶
[routing:primary]
max_connections = 100        # æœ€å¤§è¿žæŽ¥æ•°
max_connect_errors = 10      # æœ€å¤§è¿žæŽ¥é”™è¯¯æ•°
connect_timeout = 5          # è¿žæŽ¥è¶…æ—¶æ—¶é—´

[logger]
level = INFO
destinations = /var/log/mysqlrouter/mysqlrouter.log,console
```

---

## 4. ðŸ” SSL/TLSåŠ å¯†é…ç½®


### 4.1 SSLåŠ å¯†åŽŸç†


**ðŸ”’ åŠ å¯†é€šä¿¡ç†è§£**
```
å°±åƒå¯„åŒ…è£¹ï¼š
æ˜Žæ–‡ä¼ è¾“ = æ˜Žä¿¡ç‰‡ï¼šè°éƒ½èƒ½çœ‹åˆ°å†…å®¹
SSLåŠ å¯† = ä¿é™©ç®±ï¼šåªæœ‰æ”¶ä»¶äººèƒ½æ‰“å¼€

ä¼ è¾“è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯ â”€[åŠ å¯†æ•°æ®]â”€â–¶ Router â”€[åŠ å¯†æ•°æ®]â”€â–¶ MySQL
      â—€â”€[åŠ å¯†å“åº”]â”€     â—€â”€[åŠ å¯†å“åº”]â”€
```

### 4.2 SSLè¯ä¹¦é…ç½®


**ðŸ“œ è¯ä¹¦å‡†å¤‡**
```bash
# 1. ç”ŸæˆCAç§é’¥
openssl genrsa -out ca-key.pem 2048

# 2. ç”ŸæˆCAè¯ä¹¦
openssl req -new -x509 -nodes -days 365000 \
  -key ca-key.pem -out ca-cert.pem

# 3. ç”ŸæˆRouterç§é’¥
openssl genrsa -out router-key.pem 2048

# 4. ç”ŸæˆRouterè¯ä¹¦è¯·æ±‚
openssl req -newkey rsa:2048 -days 365000 \
  -nodes -keyout router-key.pem -out router-req.pem

# 5. ç­¾å‘Routerè¯ä¹¦
openssl x509 -req -in router-req.pem -days 365000 \
  -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 \
  -out router-cert.pem
```

### 4.3 Router SSLé…ç½®


**ðŸ”§ SSLé…ç½®æ–‡ä»¶**
```ini
# mysqlrouter.conf
[routing:primary_ssl]
bind_address = 0.0.0.0
bind_port = 6446
destinations = mysql-primary:3306

# SSLé…ç½®
client_ssl_mode = REQUIRED      # è¦æ±‚å®¢æˆ·ç«¯ä½¿ç”¨SSL
client_ssl_cert = /etc/mysql-router/certs/router-cert.pem
client_ssl_key = /etc/mysql-router/certs/router-key.pem
client_ssl_ca = /etc/mysql-router/certs/ca-cert.pem

# æœåŠ¡ç«¯SSLé…ç½®
server_ssl_mode = REQUIRED      # è¦æ±‚æœåŠ¡ç«¯ä½¿ç”¨SSL
server_ssl_verify = VERIFY_CA   # éªŒè¯æœåŠ¡ç«¯è¯ä¹¦
server_ssl_ca = /etc/mysql-router/certs/ca-cert.pem
```

### 4.4 SSLéªŒè¯æµ‹è¯•


**âœ… è¿žæŽ¥æµ‹è¯•**
```bash
# æµ‹è¯•SSLè¿žæŽ¥
mysql -h router-host -P 6446 -u app_user -p \
  --ssl-mode=REQUIRED \
  --ssl-ca=/path/to/ca-cert.pem

# éªŒè¯SSLçŠ¶æ€
mysql> SHOW STATUS LIKE 'Ssl%';
+-------------------+----------+
| Variable_name     | Value    |
+-------------------+----------+
| Ssl_cipher        | AES256-SHA |
| Ssl_version       | TLSv1.2  |
+-------------------+----------+
```

---

## 5. ðŸ›¡ï¸ è®¤è¯æœºåˆ¶ä¸Žæƒé™æŽ§åˆ¶


### 5.1 å¤šå±‚è®¤è¯æž¶æž„


**ðŸ” è®¤è¯æµç¨‹**
```
ä¸‰å±‚è®¤è¯æ¨¡åž‹ï¼š
ç¬¬ä¸€å±‚ï¼šç½‘ç»œå±‚è®¤è¯ (IPç™½åå•)
   â†“
ç¬¬äºŒå±‚ï¼šRouterå±‚è®¤è¯ (Routeré…ç½®)
   â†“  
ç¬¬ä¸‰å±‚ï¼šMySQLå±‚è®¤è¯ (æ•°æ®åº“ç”¨æˆ·æƒé™)

è®¤è¯æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€[1.IPæ£€æŸ¥]â”€â”€â–¶ Router â”€â”€[2.è½¬å‘]â”€â”€â–¶ MySQL
      â—€â”€â”€[4.è¿”å›žç»“æžœ]â”€â”€       â—€â”€â”€[3.ç”¨æˆ·éªŒè¯]â”€â”€
```

### 5.2 Routerè®¤è¯é…ç½®


**ðŸ”§ è®¤è¯ç­–ç•¥è®¾ç½®**
```ini
# mysqlrouter.conf
[metadata_cache:bootstrap]
# Routeræœ¬èº«çš„è®¤è¯ä¿¡æ¯
user = router_admin
password = encrypted_password
ttl = 300
use_gr_notifications = 1

[routing:primary]
# è®¤è¯ç›¸å…³é…ç½®
protocol = classic                    # ä½¿ç”¨ç»å…¸åè®®
routing_strategy = first-available    # è·¯ç”±ç­–ç•¥
max_connections = 512                 # æœ€å¤§è¿žæŽ¥æ•°
```

### 5.3 æƒé™æŽ§åˆ¶æœ€ä½³å®žè·µ


**ðŸ“‹ æƒé™æŽ§åˆ¶ç­–ç•¥**

```
æƒé™åˆ†å±‚ç®¡ç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚æƒé™     â”‚ â”€â”€ åº”ç”¨åŠŸèƒ½æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Routerå±‚æƒé™   â”‚ â”€â”€ è¿žæŽ¥è·¯ç”±æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  æ•°æ®åº“å±‚æƒé™   â”‚ â”€â”€ æ•°æ®æ“ä½œæƒé™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ðŸ’¡ æƒé™é…ç½®ç¤ºä¾‹**
```sql
-- åº”ç”¨åªè¯»ç”¨æˆ·
CREATE USER 'app_readonly'@'%' IDENTIFIED BY 'ReadOnly_Pass_123!';
GRANT SELECT ON app_database.* TO 'app_readonly'@'%';

-- åº”ç”¨è¯»å†™ç”¨æˆ·  
CREATE USER 'app_readwrite'@'%' IDENTIFIED BY 'ReadWrite_Pass_456!';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_database.* TO 'app_readwrite'@'%';

-- ç¦æ­¢DDLæƒé™
REVOKE CREATE, DROP, ALTER ON *.* FROM 'app_readwrite'@'%';
```

---

## 6. ðŸ”¥ é˜²ç«å¢™ä¸Žç«¯å£å®‰å…¨


### 6.1 ç«¯å£å®‰å…¨ç­–ç•¥


**ðŸšª ç«¯å£ç®¡ç†åŽŸåˆ™**
```
ç«¯å£å°±åƒæˆ¿é—´é—¨ï¼š
â€¢ åªå¼€å¿…è¦çš„é—¨ï¼ˆæœ€å°åŒ–æš´éœ²ï¼‰
â€¢ ç»™æ¯æ‰‡é—¨è£…é”ï¼ˆè®¿é—®æŽ§åˆ¶ï¼‰
â€¢ å®šæœŸæ£€æŸ¥é—¨é”ï¼ˆå®‰å…¨å®¡è®¡ï¼‰
â€¢ è®°å½•è¿›å‡ºè®°å½•ï¼ˆæ—¥å¿—ç›‘æŽ§ï¼‰
```

**ðŸ“‹ Routerç«¯å£è§„åˆ’**

| ç«¯å£ç±»åž‹ | **é»˜è®¤ç«¯å£** | **ç”¨é€”** | **å®‰å…¨çº§åˆ«** |
|---------|-------------|---------|-------------|
| `6446` | **è¯»å†™ç«¯å£** | `ä¸»èŠ‚ç‚¹è®¿é—®` | `ðŸ”´ é«˜å±` |
| `6447` | **åªè¯»ç«¯å£** | `ä»ŽèŠ‚ç‚¹è®¿é—®` | `ðŸŸ¡ ä¸­å±` |
| `8443` | **ç®¡ç†ç«¯å£** | `Routerç®¡ç†` | `ðŸ”´ é«˜å±` |
| `33060` | **Xåè®®ç«¯å£** | `æ–‡æ¡£å­˜å‚¨` | `ðŸŸ¡ ä¸­å±` |

### 6.2 é˜²ç«å¢™é…ç½®


**ðŸ”§ iptablesè§„åˆ™é…ç½®**
```bash
#!/bin/bash
# MySQL Routeré˜²ç«å¢™è„šæœ¬

# æ¸…ç©ºçŽ°æœ‰è§„åˆ™
iptables -F

# é»˜è®¤ç­–ç•¥ï¼šæ‹’ç»æ‰€æœ‰
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# å…è®¸æœ¬åœ°å›žçŽ¯
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿žæŽ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# å…è®¸åº”ç”¨æœåŠ¡å™¨è¿žæŽ¥Router
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 6446 -j ACCEPT
iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 6447 -j ACCEPT

# å…è®¸ç®¡ç†å‘˜SSH
iptables -A INPUT -s 192.168.100.0/24 -p tcp --dport 22 -j ACCEPT

# è®°å½•è¢«æ‹’ç»çš„è¿žæŽ¥
iptables -A INPUT -j LOG --log-prefix "ROUTER-BLOCKED: "

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

### 6.3 ç«¯å£ç›‘æŽ§


**ðŸ“Š ç«¯å£çŠ¶æ€ç›‘æŽ§**
```bash
# ç›‘æŽ§è„šæœ¬
#!/bin/bash
# check_router_ports.sh

ROUTER_PORTS="6446 6447 8443"
LOG_FILE="/var/log/router_port_check.log"

for port in $ROUTER_PORTS; do
    if netstat -ln | grep ":$port " > /dev/null; then
        echo "$(date): Port $port is OPEN" >> $LOG_FILE
    else
        echo "$(date): WARNING - Port $port is CLOSED" >> $LOG_FILE
        # å‘é€å‘Šè­¦
        /usr/local/bin/send_alert.sh "Router port $port is down"
    fi
done
```

---

## 7. ðŸ‘ï¸ å®‰å…¨ç›‘æŽ§ä¸Žå…¥ä¾µæ£€æµ‹


### 7.1 Routeræ—¥å¿—ç›‘æŽ§


**ðŸ“ æ—¥å¿—é…ç½®**
```ini
# mysqlrouter.conf
[logger]
level = INFO
# å¤šç›®æ ‡æ—¥å¿—è¾“å‡º
destinations = /var/log/mysqlrouter/router.log,console

# è¯¦ç»†æ—¥å¿—é…ç½®
sinks = filelog,consolelog

[consolelog]
destination = console
level = WARNING

[filelog]  
destination = /var/log/mysqlrouter/router.log
level = INFO
timestamp_precision = microsecond
```

### 7.2 å¼‚å¸¸è¡Œä¸ºæ£€æµ‹


**ðŸš¨ ç›‘æŽ§æŒ‡æ ‡ä½“ç³»**
```
å…³é”®ç›‘æŽ§æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿žæŽ¥æŒ‡æ ‡       â”‚ â”€â”€ è¿žæŽ¥æ•°ã€æˆåŠŸçŽ‡ã€å¤±è´¥çŽ‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ€§èƒ½æŒ‡æ ‡       â”‚ â”€â”€ å“åº”æ—¶é—´ã€åžåé‡ã€å»¶è¿Ÿ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é”™è¯¯æŒ‡æ ‡       â”‚ â”€â”€ é”™è¯¯çŽ‡ã€å¼‚å¸¸è¿žæŽ¥ã€è¶…æ—¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®‰å…¨æŒ‡æ ‡       â”‚ â”€â”€ å¤±è´¥ç™»å½•ã€å¯ç–‘IPã€å¼‚å¸¸è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ðŸ”§ ç›‘æŽ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# router_security_monitor.sh

LOG_FILE="/var/log/mysqlrouter/router.log"
ALERT_THRESHOLD=10

# æ£€æµ‹è¿žæŽ¥å¤±è´¥
failed_connections=$(grep "Failed to connect" $LOG_FILE | wc -l)
if [ $failed_connections -gt $ALERT_THRESHOLD ]; then
    echo "ALERT: Too many failed connections: $failed_connections"
    # å‘é€å‘Šè­¦é€šçŸ¥
fi

# æ£€æµ‹å¯ç–‘IP
suspicious_ips=$(grep "connection refused" $LOG_FILE | \
    awk '{print $5}' | sort | uniq -c | sort -nr | head -5)
echo "Top suspicious IPs: $suspicious_ips"

# æ£€æµ‹å¼‚å¸¸æŸ¥è¯¢æ¨¡å¼
grep -i "select.*information_schema" $LOG_FILE && \
    echo "ALERT: Potential SQL injection attempt detected"
```

### 7.3 å®žæ—¶ç›‘æŽ§é…ç½®


**âš¡ å®žæ—¶ç›‘æŽ§ç³»ç»Ÿ**
```bash
# ä½¿ç”¨fail2banç›‘æŽ§å¼‚å¸¸è¿žæŽ¥
# /etc/fail2ban/jail.local
[mysqlrouter]
enabled = true
port = 6446,6447
filter = mysqlrouter
logpath = /var/log/mysqlrouter/router.log
maxretry = 5
bantime = 3600
findtime = 600

# è¿‡æ»¤è§„åˆ™ /etc/fail2ban/filter.d/mysqlrouter.conf
[Definition]
failregex = .*connection from .* failed.*
ignoreregex =
```

---

## 8. âœ… å®‰å…¨åˆè§„æ£€æŸ¥


### 8.1 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•


**ðŸ“‹ Routerå®‰å…¨æ£€æŸ¥é¡¹ç›®**

| æ£€æŸ¥é¡¹ç›® | **æ£€æŸ¥å†…å®¹** | **é£Žé™©ç­‰çº§** | **ä¿®å¤å»ºè®®** |
|---------|-------------|-------------|-------------|
| **è´¦æˆ·å®‰å…¨** | `ä¸“ç”¨è´¦æˆ·ã€å¯†ç å¼ºåº¦ã€æƒé™æœ€å°åŒ–` | `ðŸ”´ é«˜` | `åˆ›å»ºä¸“ç”¨è´¦æˆ·ï¼Œè®¾ç½®å¼ºå¯†ç ç­–ç•¥` |
| **ç½‘ç»œå®‰å…¨** | `IPç™½åå•ã€ç«¯å£é™åˆ¶ã€SSLåŠ å¯†` | `ðŸ”´ é«˜` | `é…ç½®è®¿é—®æŽ§åˆ¶ï¼Œå¯ç”¨SSL` |
| **æ—¥å¿—ç›‘æŽ§** | `æ—¥å¿—å®Œæ•´æ€§ã€ç›‘æŽ§å‘Šè­¦ã€å®¡è®¡è·Ÿè¸ª` | `ðŸŸ¡ ä¸­` | `å®Œå–„æ—¥å¿—é…ç½®ï¼Œå»ºç«‹ç›‘æŽ§` |
| **é…ç½®å®‰å…¨** | `é»˜è®¤é…ç½®ã€æ•æ„Ÿä¿¡æ¯ã€ç‰ˆæœ¬æ›´æ–°` | `ðŸŸ¡ ä¸­` | `ä¿®æ”¹é»˜è®¤å€¼ï¼Œå®šæœŸæ›´æ–°` |

### 8.2 è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥


**ðŸ”§ å®‰å…¨æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# mysql_router_security_check.sh

echo "=== MySQL Router Security Check ==="
echo "Date: $(date)"
echo

# 1. æ£€æŸ¥Routerè¿›ç¨‹
if pgrep mysqlrouter > /dev/null; then
    echo "âœ… MySQL Router is running"
else
    echo "âŒ MySQL Router is not running"
fi

# 2. æ£€æŸ¥SSLé…ç½®
if grep -q "client_ssl_mode.*REQUIRED" /etc/mysqlrouter/mysqlrouter.conf; then
    echo "âœ… SSL is properly configured"
else
    echo "âš ï¸  SSL configuration needs review"
fi

# 3. æ£€æŸ¥ç«¯å£ç›‘å¬
echo "ðŸ“Š Port listening status:"
netstat -ln | grep -E ":6446|:6447|:8443"

# 4. æ£€æŸ¥æ—¥å¿—æƒé™
if [ -r "/var/log/mysqlrouter/router.log" ]; then
    echo "âœ… Log file is accessible"
    echo "ðŸ“ Recent connection attempts:"
    tail -10 /var/log/mysqlrouter/router.log | grep -i "connection"
else
    echo "âŒ Cannot access log file"
fi

# 5. æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
config_perms=$(stat -c "%a" /etc/mysqlrouter/mysqlrouter.conf)
if [ "$config_perms" = "600" ]; then
    echo "âœ… Configuration file permissions are secure"
else
    echo "âš ï¸  Configuration file permissions: $config_perms (should be 600)"
fi

echo
echo "=== Security Check Complete ==="
```

### 8.3 åˆè§„æŠ¥å‘Šç”Ÿæˆ


**ðŸ“Š å®‰å…¨åˆè§„æŠ¥å‘Šæ¨¡æ¿**
```bash
#!/bin/bash
# generate_compliance_report.sh

REPORT_FILE="/var/log/router_compliance_$(date +%Y%m%d).txt"

cat > $REPORT_FILE << EOF
MySQL Router Security Compliance Report
======================================
Date: $(date)
Environment: Production/Staging/Development

1. AUTHENTICATION & AUTHORIZATION
   - Dedicated service accounts: [Yes/No]
   - Password policy compliance: [Yes/No]
   - Minimum privilege principle: [Yes/No]

2. NETWORK SECURITY
   - IP access controls: [Yes/No]
   - SSL/TLS encryption: [Yes/No]
   - Port security: [Yes/No]

3. MONITORING & LOGGING
   - Comprehensive logging: [Yes/No]
   - Real-time monitoring: [Yes/No]
   - Incident response: [Yes/No]

4. CONFIGURATION SECURITY
   - Secure defaults: [Yes/No]
   - Regular updates: [Yes/No]
   - Change management: [Yes/No]

Compliance Score: XX/16 (XX%)
Risk Level: [Low/Medium/High]

Recommendations:
- [å…·ä½“æ”¹è¿›å»ºè®®]
EOF

echo "Compliance report generated: $REPORT_FILE"
```

---

## 9. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŽŒæ¡çš„å®‰å…¨è¦ç‚¹


```
ðŸ”¸ **è´¦æˆ·å®‰å…¨**ï¼šä¸“ç”¨è´¦æˆ· + æœ€å°æƒé™ + å¼ºå¯†ç ç­–ç•¥
ðŸ”¸ **ç½‘ç»œå®‰å…¨**ï¼šIPç™½åå• + ç«¯å£æŽ§åˆ¶ + SSLåŠ å¯†  
ðŸ”¸ **è®¿é—®æŽ§åˆ¶**ï¼šå¤šå±‚è®¤è¯ + æƒé™åˆ†çº§ + è¿žæŽ¥é™åˆ¶
ðŸ”¸ **ç›‘æŽ§å®¡è®¡**ï¼šå…¨é¢æ—¥å¿— + å®žæ—¶ç›‘æŽ§ + å…¥ä¾µæ£€æµ‹
ðŸ”¸ **åˆè§„ç®¡ç†**ï¼šå®šæœŸæ£€æŸ¥ + å®‰å…¨è¯„ä¼° + æŒç»­æ”¹è¿›
```

### 9.2 å®‰å…¨é…ç½®ä¼˜å…ˆçº§


**ðŸŽ¯ å®‰å…¨å®žæ–½é¡ºåº**
```
ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰ï¼š
1. ä¿®æ”¹é»˜è®¤å¯†ç å’Œç«¯å£
2. åˆ›å»ºä¸“ç”¨æœåŠ¡è´¦æˆ·
3. é…ç½®IPè®¿é—®ç™½åå•
4. å¯ç”¨SSLåŠ å¯†

ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå°½å¿«å®Œæˆï¼‰ï¼š
5. é…ç½®é˜²ç«å¢™è§„åˆ™
6. è®¾ç½®è¿žæŽ¥æ•°é™åˆ¶
7. å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
8. å»ºç«‹ç›‘æŽ§å‘Šè­¦

ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰ï¼š
9. éƒ¨ç½²å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ
10. å»ºç«‹å®‰å…¨åˆè§„æµç¨‹
11. å®šæœŸå®‰å…¨è¯„ä¼°
12. åº”æ€¥å“åº”é¢„æ¡ˆ
```

### 9.3 å®‰å…¨è¿ç»´å®žè·µ


**ðŸ’¡ å®‰å…¨ç®¡ç†è¦ç‚¹**
- **å®šæœŸå®¡è®¡**ï¼šæ¯æœˆæ£€æŸ¥è´¦æˆ·æƒé™å’Œè®¿é—®æ—¥å¿—
- **å¯†ç ç®¡ç†**ï¼šå®šæœŸè½®æ¢å¯†ç ï¼Œä½¿ç”¨å¯†ç ç®¡ç†å·¥å…·
- **è¡¥ä¸æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°Routerç‰ˆæœ¬å’Œç³»ç»Ÿè¡¥ä¸
- **å¤‡ä»½æ¢å¤**ï¼šå®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œè¯ä¹¦
- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šå®‰å…¨äº‹ä»¶å“åº”æµç¨‹

**ðŸš¨ å¸¸è§å®‰å…¨è¯¯åŒº**
```
âŒ é”™è¯¯åšæ³•ï¼š
â€¢ ä½¿ç”¨é»˜è®¤å¯†ç å’Œé…ç½®
â€¢ å¼€æ”¾æ‰€æœ‰ç«¯å£ç»™æ‰€æœ‰IP
â€¢ ä¸å¯ç”¨SSLåŠ å¯†
â€¢ å¿½ç•¥æ—¥å¿—ç›‘æŽ§

âœ… æ­£ç¡®åšæ³•ï¼š
â€¢ ä¿®æ”¹æ‰€æœ‰é»˜è®¤è®¾ç½®
â€¢ æœ€å°åŒ–ç½‘ç»œæš´éœ²é¢
â€¢ å¼ºåˆ¶SSLåŠ å¯†é€šä¿¡
â€¢ å»ºç«‹å®Œå–„ç›‘æŽ§ä½“ç³»
```

### 9.4 åº”æ€¥å“åº”æŒ‡å—


**ðŸ†˜ å®‰å…¨äº‹ä»¶å¤„ç†**
```
å‘çŽ°å®‰å…¨å¨èƒæ—¶çš„å¤„ç†æ­¥éª¤ï¼š

1. ç«‹å³å“åº”ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
   - éš”ç¦»å—å½±å“çš„Router
   - é˜»æ–­å¯ç–‘IPè®¿é—®
   - é€šçŸ¥å®‰å…¨å›¢é˜Ÿ

2. å½±å“è¯„ä¼°ï¼ˆ30åˆ†é’Ÿå†…ï¼‰  
   - åˆ†æžæ”»å‡»èŒƒå›´
   - è¯„ä¼°æ•°æ®é£Žé™©
   - åˆ¶å®šæ¢å¤è®¡åˆ’

3. æ¢å¤æ“ä½œï¼ˆ2å°æ—¶å†…ï¼‰
   - ä¿®å¤å®‰å…¨æ¼æ´ž
   - æ¢å¤æ­£å¸¸æœåŠ¡
   - åŠ å¼ºç›‘æŽ§æŽªæ–½

4. äº‹åŽæ€»ç»“ï¼ˆ24å°æ—¶å†…ï¼‰
   - åˆ†æžæ”»å‡»åŽŸå› 
   - å®Œå–„é˜²æŠ¤æŽªæ–½
   - æ›´æ–°åº”æ€¥é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Routerå®‰å…¨æ˜¯æ•°æ®åº“å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
- å¤šå±‚é˜²æŠ¤æ¯”å•ç‚¹é˜²æŠ¤æ›´å¯é 
- ç›‘æŽ§å’Œå®¡è®¡æ˜¯å‘çŽ°å¨èƒçš„å…³é”®
- å®šæœŸè¯„ä¼°å’Œæ”¹è¿›æ˜¯å®‰å…¨è¿ç»´çš„æ ¸å¿ƒ