---
title: 11ã€é›†ç¾¤å®ä¾‹ç®¡ç†æ“ä½œ
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤å®ä¾‹ç®¡ç†æ¦‚è¿°](#1-é›†ç¾¤å®ä¾‹ç®¡ç†æ¦‚è¿°)
2. [æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤](#2-æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤)
3. [ç§»é™¤é›†ç¾¤å®ä¾‹](#3-ç§»é™¤é›†ç¾¤å®ä¾‹)
4. [å®ä¾‹çŠ¶æ€æ£€æŸ¥ä¸ç›‘æ§](#4-å®ä¾‹çŠ¶æ€æ£€æŸ¥ä¸ç›‘æ§)
5. [å®ä¾‹é…ç½®éªŒè¯ä¸ä¿®å¤](#5-å®ä¾‹é…ç½®éªŒè¯ä¸ä¿®å¤)
6. [æˆå‘˜è§’è‰²ç®¡ç†](#6-æˆå‘˜è§’è‰²ç®¡ç†)
7. [å®ä¾‹æ•…éšœå¤„ç†](#7-å®ä¾‹æ•…éšœå¤„ç†)
8. [å®ä¾‹å…ƒæ•°æ®ç®¡ç†](#8-å®ä¾‹å…ƒæ•°æ®ç®¡ç†)
9. [æ‰¹é‡å®ä¾‹æ“ä½œ](#9-æ‰¹é‡å®ä¾‹æ“ä½œ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ é›†ç¾¤å®ä¾‹ç®¡ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é›†ç¾¤å®ä¾‹ç®¡ç†


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
é›†ç¾¤å®ä¾‹ç®¡ç†å°±æ˜¯å¯¹MySQLé›†ç¾¤ä¸­çš„å„ä¸ªæ•°æ®åº“å®ä¾‹è¿›è¡Œ**å¢åˆ æ”¹æŸ¥**çš„æ“ä½œã€‚ç®€å•è¯´ï¼Œå°±æ˜¯ç®¡ç†é›†ç¾¤é‡Œæœ‰å“ªäº›MySQLæœåŠ¡å™¨ï¼Œå®ƒä»¬çš„çŠ¶æ€å¦‚ä½•ï¼Œä»¥åŠå¦‚ä½•å¯¹å®ƒä»¬è¿›è¡Œç»´æŠ¤ã€‚

```
é›†ç¾¤å®ä¾‹ç®¡ç†çš„æ ¸å¿ƒä»»åŠ¡ï¼š
â€¢ æ·»åŠ æ–°çš„MySQLå®ä¾‹åˆ°é›†ç¾¤
â€¢ ä»é›†ç¾¤ä¸­ç§»é™¤ä¸éœ€è¦çš„å®ä¾‹
â€¢ æ£€æŸ¥å„ä¸ªå®ä¾‹çš„è¿è¡ŒçŠ¶æ€
â€¢ å¤„ç†å®ä¾‹å‡ºç°çš„æ•…éšœé—®é¢˜
â€¢ ç®¡ç†å®ä¾‹çš„è§’è‰²ï¼ˆä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹ï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®ä¾‹ç®¡ç†


**ğŸ’¡ å®é™…åœºæ™¯ç†è§£**
æƒ³è±¡ä½ ç®¡ç†ä¸€ä¸ªå…¬å¸çš„å¤šä¸ªåˆ†åº—ï¼š
- **å¼€æ–°åº—**ï¼šç›¸å½“äºæ·»åŠ æ–°å®ä¾‹åˆ°é›†ç¾¤
- **å…³é—­é—¨åº—**ï¼šç›¸å½“äºç§»é™¤å®ä¾‹
- **æ£€æŸ¥è¥ä¸šçŠ¶æ€**ï¼šç›¸å½“äºæ£€æŸ¥å®ä¾‹çŠ¶æ€
- **å¤„ç†é—¨åº—é—®é¢˜**ï¼šç›¸å½“äºæ•…éšœå¤„ç†

```
ä¸šåŠ¡éœ€æ±‚åœºæ™¯ï¼š
ğŸ”¸ ä¸šåŠ¡æ‰©å±•ï¼šéœ€è¦æ·»åŠ æ›´å¤šå®ä¾‹æå‡æ€§èƒ½
ğŸ”¸ ç¡¬ä»¶ç»´æŠ¤ï¼šéœ€è¦ä¸´æ—¶ç§»é™¤å®ä¾‹è¿›è¡Œç»´æŠ¤
ğŸ”¸ æ•…éšœæ¢å¤ï¼šå®ä¾‹å®•æœºåéœ€è¦é‡æ–°åŠ å…¥é›†ç¾¤
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šè°ƒæ•´å®ä¾‹è§’è‰²åˆ†é…è¯»å†™å‹åŠ›
```

### 1.3 å®ä¾‹ç®¡ç†å·¥å…·


**ğŸ”§ ä¸»è¦ç®¡ç†å·¥å…·**
```
MySQL Shell AdminAPIï¼š
â€¢ cluster.addInstance() - æ·»åŠ å®ä¾‹
â€¢ cluster.removeInstance() - ç§»é™¤å®ä¾‹
â€¢ cluster.status() - æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
â€¢ cluster.describe() - æŸ¥çœ‹é›†ç¾¤è¯¦æƒ…
```

---

## 2. â• æ·»åŠ å®ä¾‹åˆ°é›†ç¾¤


### 2.1 addInstance()æ–¹æ³•è¯¦è§£


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```javascript
cluster.addInstance('user@host:port', options)
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒå¾€å›¢é˜Ÿé‡Œ**æ‹›è˜æ–°å‘˜å·¥**ä¸€æ ·ï¼Œéœ€è¦æŒ‡å®šæ–°å‘˜å·¥çš„è”ç³»æ–¹å¼ï¼ˆç”¨æˆ·å@ä¸»æœº:ç«¯å£ï¼‰ï¼Œå¹¶è®¾ç½®ä¸€äº›å·¥ä½œè§„åˆ™ï¼ˆé€‰é¡¹å‚æ•°ï¼‰ã€‚

### 2.2 æ·»åŠ å®ä¾‹çš„åŸºæœ¬æ­¥éª¤


**ğŸ“‹ æ“ä½œæµç¨‹**
```javascript
// æ­¥éª¤1ï¼šè¿æ¥åˆ°é›†ç¾¤çš„ä¸»å®ä¾‹
shell.connect('admin@192.168.1.10:3306')

// æ­¥éª¤2ï¼šè·å–é›†ç¾¤å¯¹è±¡
var cluster = dba.getCluster('myCluster')

// æ­¥éª¤3ï¼šæ·»åŠ æ–°å®ä¾‹
cluster.addInstance('admin@192.168.1.11:3306')
```

**ğŸ’­ è¿™ä¸ªè¿‡ç¨‹åœ¨åšä»€ä¹ˆï¼Ÿ**
1. å…ˆè¿æ¥åˆ°é›†ç¾¤çš„"è€å¤§"ï¼ˆä¸»å®ä¾‹ï¼‰
2. å‘Šè¯‰è€å¤§ï¼š"æˆ‘è¦ç®¡ç†è¿™ä¸ªå›¢é˜Ÿ"
3. ç„¶åè¯´ï¼š"æŠŠè¿™ä¸ªæ–°äººåŠ åˆ°å›¢é˜Ÿé‡Œ"

### 2.3 æ·»åŠ å®ä¾‹çš„è¯¦ç»†å‚æ•°


**ğŸ”§ å¸¸ç”¨é€‰é¡¹å‚æ•°**
```javascript
cluster.addInstance('admin@192.168.1.11:3306', {
    // æ¢å¤æ–¹å¼ï¼šcloneè¡¨ç¤ºå®Œæ•´å¤åˆ¶æ•°æ®
    recoveryMethod: 'clone',
    
    // æ ‡ç­¾ï¼šç»™å®ä¾‹æ‰“æ ‡ç­¾ï¼Œä¾¿äºç®¡ç†
    label: 'secondary-1',
    
    // ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    timeout: 3600,
    
    // æ˜¯å¦äº¤äº’å¼æ“ä½œ
    interactive: true
})
```

**ğŸ”¸ å‚æ•°å«ä¹‰è§£é‡Š**
- **recoveryMethod**: æ–°å®ä¾‹å¦‚ä½•è·å–æ•°æ®
  - `clone`: å®Œæ•´å¤åˆ¶ï¼ˆæ¨èï¼Œå¿«é€Ÿï¼‰
  - `incremental`: å¢é‡æ¢å¤ï¼ˆé€‚åˆæ•°æ®é‡å°çš„æƒ…å†µï¼‰
- **label**: ç»™å®ä¾‹èµ·ä¸ªåˆ«åï¼Œä¾¿äºè¯†åˆ«
- **timeout**: æœ€å¤šç­‰å¾…å¤šé•¿æ—¶é—´
- **interactive**: æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤æ“ä½œ

### 2.4 æ·»åŠ å®ä¾‹çš„å®é™…ç¤ºä¾‹


**ğŸ’» å®Œæ•´æ“ä½œç¤ºä¾‹**
```javascript
// è¿æ¥åˆ°é›†ç¾¤
shell.connect('admin@master:3306')
var cluster = dba.getCluster('prodCluster')

// æ£€æŸ¥è¦æ·»åŠ çš„å®ä¾‹æ˜¯å¦å¯ç”¨
cluster.checkInstanceState('admin@slave2:3306')

// æ·»åŠ å®ä¾‹ï¼ˆä½¿ç”¨cloneæ–¹å¼ï¼‰
cluster.addInstance('admin@slave2:3306', {
    recoveryMethod: 'clone',
    label: 'slave-server-2'
})

// éªŒè¯æ·»åŠ ç»“æœ
cluster.status()
```

**ğŸ” æ“ä½œè¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ**
1. æ£€æŸ¥æ–°å®ä¾‹çš„é…ç½®æ˜¯å¦ç¬¦åˆè¦æ±‚
2. å¦‚æœéœ€è¦ï¼Œè‡ªåŠ¨ä¿®å¤é…ç½®é—®é¢˜
3. å°†ä¸»å®ä¾‹çš„æ•°æ®å¤åˆ¶åˆ°æ–°å®ä¾‹
4. å°†æ–°å®ä¾‹åŠ å…¥é›†ç¾¤çš„å¤åˆ¶æ‹“æ‰‘
5. æ›´æ–°é›†ç¾¤å…ƒæ•°æ®

---

## 3. â– ç§»é™¤é›†ç¾¤å®ä¾‹


### 3.1 removeInstance()æ–¹æ³•è¯¦è§£


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```javascript
cluster.removeInstance('user@host:port', options)
```

**é€šä¿—è§£é‡Š**ï¼šå°±åƒè®©å‘˜å·¥**ç¦»èŒ**ä¸€æ ·ï¼Œéœ€è¦æŒ‡å®šæ˜¯å“ªä¸ªå‘˜å·¥ï¼ˆå®ä¾‹åœ°å€ï¼‰ï¼Œå¹¶å†³å®šæ˜¯å‹å¥½ç¦»èŒè¿˜æ˜¯å¼ºåˆ¶å¼€é™¤ã€‚

### 3.2 ç§»é™¤å®ä¾‹çš„åŸºæœ¬æ“ä½œ


**ğŸ“‹ æ ‡å‡†ç§»é™¤æµç¨‹**
```javascript
// è·å–é›†ç¾¤å¯¹è±¡
var cluster = dba.getCluster('myCluster')

// ç§»é™¤æŒ‡å®šå®ä¾‹
cluster.removeInstance('admin@192.168.1.11:3306')
```

### 3.3 ç§»é™¤å®ä¾‹çš„é€‰é¡¹å‚æ•°


**ğŸ”§ ç§»é™¤é€‰é¡¹é…ç½®**
```javascript
cluster.removeInstance('admin@192.168.1.11:3306', {
    // å¼ºåˆ¶ç§»é™¤ï¼šå³ä½¿å®ä¾‹æ— æ³•è¿æ¥ä¹Ÿè¦ç§»é™¤
    force: true,
    
    // ç­‰å¾…è¶…æ—¶æ—¶é—´
    timeout: 30,
    
    // æ˜¯å¦äº¤äº’å¼
    interactive: false
})
```

**ğŸ”¸ å‚æ•°è¯´æ˜**
- **force**: 
  - `false`ï¼ˆé»˜è®¤ï¼‰ï¼šæ¸©å’Œç§»é™¤ï¼Œéœ€è¦å®ä¾‹åœ¨çº¿é…åˆ
  - `true`ï¼šå¼ºåˆ¶ç§»é™¤ï¼Œå³ä½¿å®ä¾‹å®•æœºä¹Ÿèƒ½ç§»é™¤
- **timeout**: ç­‰å¾…å®ä¾‹å“åº”çš„æœ€é•¿æ—¶é—´
- **interactive**: æ˜¯å¦éœ€è¦ç”¨æˆ·ç¡®è®¤

### 3.4 ä¸åŒåœºæ™¯çš„ç§»é™¤æ–¹å¼


**ğŸ“Š ç§»é™¤åœºæ™¯å¯¹æ¯”**

| åœºæ™¯ | **ç§»é™¤æ–¹å¼** | **é€‚ç”¨æƒ…å†µ** | **æ³¨æ„äº‹é¡¹** |
|------|-------------|-------------|-------------|
| ğŸŸ¢ **æ­£å¸¸ç»´æŠ¤** | `force: false` | å®ä¾‹è¿è¡Œæ­£å¸¸ | æ•°æ®åŒæ­¥å®Œæˆåç§»é™¤ |
| ğŸŸ¡ **ç¡¬ä»¶æ•…éšœ** | `force: true` | å®ä¾‹æ— æ³•è¿æ¥ | ç›´æ¥ä»å…ƒæ•°æ®ä¸­åˆ é™¤ |
| ğŸ”´ **ç´§æ€¥å¤„ç†** | `force: true, timeout: 5` | éœ€è¦å¿«é€Ÿç§»é™¤ | å¯èƒ½ä¸¢å¤±éƒ¨åˆ†æ•°æ® |

**ğŸ’» å®é™…ç¤ºä¾‹**
```javascript
// åœºæ™¯1ï¼šæ­£å¸¸ç»´æŠ¤ç§»é™¤
cluster.removeInstance('admin@slave1:3306', {
    force: false,
    timeout: 60
})

// åœºæ™¯2ï¼šå¼ºåˆ¶ç§»é™¤æ•…éšœå®ä¾‹
cluster.removeInstance('admin@broken-server:3306', {
    force: true,
    timeout: 10
})
```

---

## 4. ğŸ“Š å®ä¾‹çŠ¶æ€æ£€æŸ¥ä¸ç›‘æ§


### 4.1 cluster.status()è¯¦è§£


**ğŸ”¸ åŸºæœ¬ç”¨æ³•**
```javascript
// æŸ¥çœ‹é›†ç¾¤æ•´ä½“çŠ¶æ€
cluster.status()

// æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ä¿¡æ¯
cluster.status({extended: 1})
```

**é€šä¿—ç†è§£**ï¼šå°±åƒæŸ¥çœ‹å›¢é˜Ÿçš„**å·¥ä½œæŠ¥å‘Š**ï¼Œçœ‹çœ‹æ¯ä¸ªæˆå‘˜çš„å·¥ä½œçŠ¶æ€ã€å¥åº·æƒ…å†µã€å·¥ä½œè´Ÿè½½ç­‰ã€‚

### 4.2 çŠ¶æ€ä¿¡æ¯è§£è¯»


**ğŸ“‹ å…¸å‹çŠ¶æ€è¾“å‡º**
```json
{
    "clusterName": "prodCluster",
    "defaultReplicaSet": {
        "name": "default",
        "primary": "master:3306",
        "ssl": "REQUIRED",
        "status": "OK",
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",
        "topology": {
            "master:3306": {
                "address": "master:3306",
                "mode": "R/W",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            },
            "slave1:3306": {
                "address": "slave1:3306", 
                "mode": "R/O",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            }
        }
    }
}
```

**ğŸ”¸ å…³é”®å­—æ®µå«ä¹‰**
- **status**: å®ä¾‹çŠ¶æ€
  - `ONLINE`: æ­£å¸¸åœ¨çº¿
  - `OFFLINE`: ç¦»çº¿
  - `RECOVERING`: æ¢å¤ä¸­
  - `ERROR`: é”™è¯¯çŠ¶æ€
- **mode**: è¯»å†™æ¨¡å¼
  - `R/W`: å¯è¯»å¯å†™ï¼ˆä¸»å®ä¾‹ï¼‰
  - `R/O`: åªè¯»ï¼ˆä»å®ä¾‹ï¼‰
- **role**: å®ä¾‹è§’è‰²
  - `HA`: é«˜å¯ç”¨æˆå‘˜
  - `PRIMARY`: ä¸»å®ä¾‹

### 4.3 å®ä¾‹çŠ¶æ€ç›‘æ§å‘½ä»¤


**ğŸ”§ å¸¸ç”¨ç›‘æ§å‘½ä»¤**
```javascript
// æ£€æŸ¥å•ä¸ªå®ä¾‹çŠ¶æ€
cluster.checkInstanceState('admin@slave1:3306')

// è·å–é›†ç¾¤è¯¦ç»†æè¿°
cluster.describe()

// æ£€æŸ¥é›†ç¾¤æ•´ä½“å¥åº·çŠ¶å†µ
cluster.checkInstanceConfiguration('admin@slave1:3306')
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```javascript
// å®šæœŸå¥åº·æ£€æŸ¥è„šæœ¬
function healthCheck() {
    var cluster = dba.getCluster('prodCluster')
    var status = cluster.status()
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¦»çº¿å®ä¾‹
    if (status.defaultReplicaSet.status !== 'OK') {
        print('âš ï¸  é›†ç¾¤çŠ¶æ€å¼‚å¸¸ï¼Œéœ€è¦æ£€æŸ¥ï¼')
        print(JSON.stringify(status, null, 2))
    } else {
        print('âœ… é›†ç¾¤çŠ¶æ€æ­£å¸¸')
    }
}
```

---

## 5. ğŸ”§ å®ä¾‹é…ç½®éªŒè¯ä¸ä¿®å¤


### 5.1 é…ç½®éªŒè¯çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯é…ç½®ï¼Ÿ**
å°±åƒæ–°å‘˜å·¥å…¥èŒéœ€è¦**åŸ¹è®­**ä¸€æ ·ï¼Œæ–°çš„MySQLå®ä¾‹åŠ å…¥é›†ç¾¤å‰ï¼Œéœ€è¦ç¡®ä¿å®ƒçš„"å·¥ä½œæŠ€èƒ½"ï¼ˆé…ç½®ï¼‰ç¬¦åˆå›¢é˜Ÿè¦æ±‚ã€‚

```
å¸¸è§é…ç½®é—®é¢˜ï¼š
â€¢ server_id å†²çª
â€¢ binlog æ ¼å¼ä¸æ­£ç¡®
â€¢ GTID æœªå¼€å¯
â€¢ å¤åˆ¶ç›¸å…³å‚æ•°ç¼ºå¤±
```

### 5.2 checkInstanceConfiguration()è¯¦è§£


**ğŸ“‹ é…ç½®æ£€æŸ¥å‘½ä»¤**
```javascript
// æ£€æŸ¥å®ä¾‹é…ç½®
dba.checkInstanceConfiguration('admin@192.168.1.11:3306')
```

**å…¸å‹è¾“å‡ºè§£è¯»**
```
Validating local MySQL instance listening at port 3306 for use in an InnoDB cluster...

NOTE: Instance detected as a sandbox.
Please note that sandbox instances are only suitable for deploying test clusters for use within the same host.

Checking whether existing tables comply with Group Replication requirements...
No incompatible tables detected

Checking instance configuration...
Configuration file mybuild.cnf will also be updated with the changes.

Some variables need to be changed, but cannot be done dynamically on the server.
Do you want to restart the instance after configuring it? [y/N]:
```

### 5.3 è‡ªåŠ¨é…ç½®ä¿®å¤


**ğŸ”§ é…ç½®ä¿®å¤é€‰é¡¹**
```javascript
// æ£€æŸ¥å¹¶è‡ªåŠ¨ä¿®å¤é…ç½®
dba.configureInstance('admin@192.168.1.11:3306', {
    clusterAdmin: 'clusteradmin',
    clusterAdminPassword: 'password',
    restart: true
})
```

**é…ç½®ä¿®å¤è¿‡ç¨‹**
```
è‡ªåŠ¨ä¿®å¤æµç¨‹ï¼š
1. ğŸ“ æ£€æµ‹å½“å‰é…ç½®é—®é¢˜
2. ğŸ”§ ç”Ÿæˆä¿®å¤å»ºè®®
3. âœï¸  æ›´æ–°é…ç½®æ–‡ä»¶
4. ğŸ”„ é‡å¯å®ä¾‹ï¼ˆå¦‚æœéœ€è¦ï¼‰
5. âœ… éªŒè¯ä¿®å¤ç»“æœ
```

### 5.4 å¸¸è§é…ç½®é—®é¢˜åŠè§£å†³


**ğŸ“Š é…ç½®é—®é¢˜é€ŸæŸ¥è¡¨**

| é—®é¢˜ç±»å‹ | **é”™è¯¯æç¤º** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| ğŸ”¢ **server_idå†²çª** | `server_id already in use` | ä¿®æ”¹ä¸ºå”¯ä¸€å€¼ |
| ğŸ“ **binlogæ ¼å¼** | `binlog_format must be ROW` | è®¾ç½®ä¸ºROWæ ¼å¼ |
| ğŸ”„ **GTIDæœªå¼€å¯** | `gtid_mode must be ON` | å¯ç”¨GTIDæ¨¡å¼ |
| ğŸ” **æƒé™ä¸è¶³** | `Access denied` | åˆ›å»ºç®¡ç†ç”¨æˆ· |

**ğŸ’» æ‰‹åŠ¨é…ç½®ç¤ºä¾‹**
```sql
-- ä¿®å¤å¸¸è§é…ç½®é—®é¢˜
SET GLOBAL server_id = 102;
SET GLOBAL binlog_format = 'ROW';
SET GLOBAL gtid_mode = ON;
SET GLOBAL enforce_gtid_consistency = ON;
```

---

## 6. ğŸ‘‘ æˆå‘˜è§’è‰²ç®¡ç†


### 6.1 é›†ç¾¤è§’è‰²æ¦‚å¿µ


**ğŸ”¸ è§’è‰²ç±»å‹è¯´æ˜**
- **PRIMARYï¼ˆä¸»å®ä¾‹ï¼‰**ï¼šå°±åƒå›¢é˜Ÿ**è´Ÿè´£äºº**ï¼Œè´Ÿè´£å¤„ç†å†™æ“ä½œ
- **SECONDARYï¼ˆä»å®ä¾‹ï¼‰**ï¼šå°±åƒå›¢é˜Ÿ**æˆå‘˜**ï¼Œä¸»è¦å¤„ç†è¯»æ“ä½œ
- **ARBITRATORï¼ˆä»²è£è€…ï¼‰**ï¼šå°±åƒ**æŠ•ç¥¨å‘˜**ï¼Œåªå‚ä¸é€‰ä¸¾ä¸å­˜å‚¨æ•°æ®

```
è§’è‰²åˆ†å·¥ç¤ºæ„ï¼š
    PRIMARY (ä¸»å®ä¾‹)
         |
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚        â”‚
SECONDARY  SECONDARY  SECONDARY
 (ä»å®ä¾‹1)  (ä»å®ä¾‹2)  (ä»å®ä¾‹3)
```

### 6.2 è§’è‰²åˆ‡æ¢æ“ä½œ


**ğŸ”„ ä¸»å®ä¾‹åˆ‡æ¢**
```javascript
// å°†æŒ‡å®šå®ä¾‹è®¾ç½®ä¸ºæ–°çš„ä¸»å®ä¾‹
cluster.setPrimaryInstance('admin@slave1:3306')
```

**é€šä¿—ç†è§£**ï¼šå°±åƒè®©åŸæ¥çš„**å‰¯é˜Ÿé•¿å‡èŒä¸ºé˜Ÿé•¿**ï¼ŒåŸé˜Ÿé•¿å˜ä¸ºæ™®é€šæˆå‘˜ã€‚

### 6.3 è§’è‰²ç®¡ç†çš„å®é™…åœºæ™¯


**ğŸ’¡ å¸¸è§è§’è‰²ç®¡ç†åœºæ™¯**
```javascript
// åœºæ™¯1ï¼šä¸»å®ä¾‹ç»´æŠ¤ï¼Œä¸´æ—¶åˆ‡æ¢
cluster.setPrimaryInstance('admin@backup-master:3306')
// ç»´æŠ¤å®Œæˆååˆ‡æ¢å›æ¥
cluster.setPrimaryInstance('admin@original-master:3306')

// åœºæ™¯2ï¼šæ£€æŸ¥å½“å‰ä¸»å®ä¾‹
var status = cluster.status()
print("å½“å‰ä¸»å®ä¾‹: " + status.defaultReplicaSet.primary)
```

### 6.4 è§’è‰²æƒé™è¯´æ˜


**ğŸ“‹ ä¸åŒè§’è‰²çš„æƒé™å¯¹æ¯”**

| è§’è‰² | **è¯»æ“ä½œ** | **å†™æ“ä½œ** | **é€‰ä¸¾æƒ** | **æ•°æ®å­˜å‚¨** |
|------|-----------|-----------|-----------|-------------|
| ğŸŸ¢ **PRIMARY** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æœ‰ | âœ… å®Œæ•´æ•°æ® |
| ğŸ”µ **SECONDARY** | âœ… æ”¯æŒ | âŒ ç¦æ­¢ | âœ… æœ‰ | âœ… å®Œæ•´æ•°æ® |
| ğŸŸ¡ **ARBITRATOR** | âŒ ç¦æ­¢ | âŒ ç¦æ­¢ | âœ… æœ‰ | âŒ æ— æ•°æ® |

---

## 7. ğŸš¨ å®ä¾‹æ•…éšœå¤„ç†


### 7.1 å¸¸è§æ•…éšœç±»å‹


**ğŸ”¸ å®ä¾‹æ•…éšœåˆ†ç±»**
```
ç½‘ç»œæ•…éšœï¼šå®ä¾‹æ— æ³•è¿æ¥
â€¢ ç°è±¡ï¼šstatusæ˜¾ç¤ºOFFLINE
â€¢ åŸå› ï¼šç½‘ç»œæ–­å¼€ã€é˜²ç«å¢™é˜»æ‹¦
â€¢ å½±å“ï¼šæ— æ³•å‚ä¸é›†ç¾¤æ“ä½œ

ç¡¬ä»¶æ•…éšœï¼šæœåŠ¡å™¨å®•æœº
â€¢ ç°è±¡ï¼šå®Œå…¨æ— å“åº”
â€¢ åŸå› ï¼šç¡¬ä»¶æŸåã€åœç”µ
â€¢ å½±å“ï¼šæ•°æ®å¯èƒ½ä¸¢å¤±

è½¯ä»¶æ•…éšœï¼šMySQLè¿›ç¨‹å¼‚å¸¸
â€¢ ç°è±¡ï¼šè¿›ç¨‹å´©æºƒé‡å¯
â€¢ åŸå› ï¼šé…ç½®é”™è¯¯ã€èµ„æºä¸è¶³
â€¢ å½±å“ï¼šæœåŠ¡ä¸­æ–­
```

### 7.2 æ•…éšœè¯Šæ–­æ­¥éª¤


**ğŸ” æ•…éšœæ’æŸ¥æµç¨‹**
```javascript
// æ­¥éª¤1ï¼šæ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€
cluster.status()

// æ­¥éª¤2ï¼šæ£€æŸ¥é—®é¢˜å®ä¾‹è¯¦æƒ…
cluster.checkInstanceState('admin@problem-server:3306')

// æ­¥éª¤3ï¼šæŸ¥çœ‹é›†ç¾¤æ‹“æ‰‘
cluster.describe()

// æ­¥éª¤4ï¼šæ£€æŸ¥å®ä¾‹é…ç½®
dba.checkInstanceConfiguration('admin@problem-server:3306')
```

### 7.3 å®ä¾‹é‡æ–°åŠ å…¥é›†ç¾¤


**ğŸ”„ rejoinInstance()æ–¹æ³•**
```javascript
// é‡æ–°åŠ å…¥ç¦»çº¿çš„å®ä¾‹
cluster.rejoinInstance('admin@recovered-server:3306')
```

**ğŸ’­ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨rejoinInstanceï¼Ÿ**
- å®ä¾‹ä¸´æ—¶ç¦»çº¿åæ¢å¤
- ç½‘ç»œæ•…éšœä¿®å¤å
- MySQLæœåŠ¡é‡å¯å
- æ•°æ®åŒæ­¥ä¸­æ–­å

**å®Œæ•´æ¢å¤ç¤ºä¾‹**
```javascript
// å®ä¾‹æ¢å¤æ“ä½œæµç¨‹
try {
    // å°è¯•é‡æ–°åŠ å…¥
    cluster.rejoinInstance('admin@slave2:3306')
    print('âœ… å®ä¾‹é‡æ–°åŠ å…¥æˆåŠŸ')
} catch (error) {
    print('âŒ é‡æ–°åŠ å…¥å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ·»åŠ ')
    // å¦‚æœé‡æ–°åŠ å…¥å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ·»åŠ 
    cluster.addInstance('admin@slave2:3306', {
        recoveryMethod: 'clone'
    })
}
```

### 7.4 æ•…éšœå¤„ç†æœ€ä½³å®è·µ


**ğŸ“‹ æ•…éšœå¤„ç†æŒ‡å—**

| æ•…éšœç±»å‹ | **é¦–é€‰å¤„ç†æ–¹å¼** | **å¤‡é€‰æ–¹æ¡ˆ** |
|---------|----------------|-------------|
| ğŸŸ¡ **ä¸´æ—¶ç¦»çº¿** | `rejoinInstance()` | ç­‰å¾…è‡ªåŠ¨æ¢å¤ |
| ğŸŸ  **é…ç½®é—®é¢˜** | `configureInstance()` | æ‰‹åŠ¨ä¿®å¤é…ç½® |
| ğŸ”´ **æ•°æ®æŸå** | `removeInstance() + addInstance()` | ä»å¤‡ä»½æ¢å¤ |
| ğŸŸ£ **ç¡¬ä»¶æ•…éšœ** | `removeInstance(force: true)` | æ›´æ¢ç¡¬ä»¶åé‡æ–°æ·»åŠ  |

---

## 8. ğŸ·ï¸ å®ä¾‹å…ƒæ•°æ®ç®¡ç†


### 8.1 ä»€ä¹ˆæ˜¯å®ä¾‹å…ƒæ•°æ®


**ğŸ”¸ å…ƒæ•°æ®æ¦‚å¿µ**
å…ƒæ•°æ®å°±æ˜¯**å…³äºæ•°æ®çš„æ•°æ®**ï¼Œåœ¨é›†ç¾¤ä¸­æŒ‡çš„æ˜¯è®°å½•æ¯ä¸ªå®ä¾‹ä¿¡æ¯çš„æ•°æ®ï¼Œæ¯”å¦‚å®ä¾‹åœ°å€ã€è§’è‰²ã€æ ‡ç­¾ç­‰ã€‚

```
å®ä¾‹å…ƒæ•°æ®åŒ…å«ï¼š
â€¢ å®ä¾‹åœ°å€å’Œç«¯å£
â€¢ å®ä¾‹è§’è‰²å’ŒçŠ¶æ€
â€¢ å®ä¾‹æ ‡ç­¾å’Œæè¿°
â€¢ åŠ å…¥æ—¶é—´å’Œç‰ˆæœ¬ä¿¡æ¯
```

### 8.2 æŸ¥çœ‹å®ä¾‹å…ƒæ•°æ®


**ğŸ” æŸ¥çœ‹å…ƒæ•°æ®å‘½ä»¤**
```javascript
// æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰å®ä¾‹çš„å…ƒæ•°æ®
cluster.describe()

// æŸ¥çœ‹è¯¦ç»†çš„é›†ç¾¤ä¿¡æ¯
cluster.status({extended: 2})
```

### 8.3 æ›´æ–°å®ä¾‹å…ƒæ•°æ®


**âœï¸ å…ƒæ•°æ®æ›´æ–°æ“ä½œ**
```javascript
// ä¿®æ”¹å®ä¾‹æ ‡ç­¾
cluster.setInstanceOption('admin@slave1:3306', 'label', 'backup-server')

// æ·»åŠ å®ä¾‹æ ‡ç­¾
cluster.setInstanceOption('admin@slave1:3306', 'tag:location', 'beijing')
```

**å®é™…åº”ç”¨ç¤ºä¾‹**
```javascript
// ä¸ºä¸åŒæœºæˆ¿çš„å®ä¾‹æ‰“æ ‡ç­¾
cluster.setInstanceOption('admin@slave1:3306', 'tag:datacenter', 'dc1')
cluster.setInstanceOption('admin@slave2:3306', 'tag:datacenter', 'dc2')

// æ ‡è®°å®ä¾‹çš„ç‰¹æ®Šç”¨é€”
cluster.setInstanceOption('admin@slave3:3306', 'tag:purpose', 'backup')
```

### 8.4 å…ƒæ•°æ®çš„å®é™…ç”¨é€”


**ğŸ’¡ æ ‡ç­¾åº”ç”¨åœºæ™¯**
```javascript
// åœºæ™¯1ï¼šæŒ‰åœ°ç†ä½ç½®ç®¡ç†
// å¯ä»¥æ ¹æ®æ ‡ç­¾é€‰æ‹©åˆé€‚çš„å®ä¾‹è¿›è¡Œè¯»æ“ä½œ
var dcTag = cluster.getInstanceOption('admin@slave1:3306', 'tag:datacenter')

// åœºæ™¯2ï¼šç»´æŠ¤è®¡åˆ’ç®¡ç†
// æ ‡è®°æ­£åœ¨ç»´æŠ¤çš„å®ä¾‹
cluster.setInstanceOption('admin@slave2:3306', 'tag:maintenance', 'true')
```

---

## 9. ğŸ”„ æ‰¹é‡å®ä¾‹æ“ä½œ


### 9.1 æ‰¹é‡æ“ä½œçš„éœ€æ±‚


**ğŸ”¸ ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰¹é‡æ“ä½œï¼Ÿ**
- **æ‰©å®¹åœºæ™¯**ï¼šä¸€æ¬¡æ€§æ·»åŠ å¤šä¸ªå®ä¾‹
- **ç»´æŠ¤åœºæ™¯**ï¼šåŒæ—¶ç»´æŠ¤å¤šä¸ªå®ä¾‹
- **è¿ç§»åœºæ™¯**ï¼šæ‰¹é‡æ›´æ¢ç¡¬ä»¶
- **ç›‘æ§åœºæ™¯**ï¼šç»Ÿä¸€æ£€æŸ¥å®ä¾‹çŠ¶æ€

### 9.2 æ‰¹é‡æ·»åŠ å®ä¾‹


**ğŸ“‹ æ‰¹é‡æ·»åŠ è„šæœ¬**
```javascript
// æ‰¹é‡æ·»åŠ å®ä¾‹å‡½æ•°
function addMultipleInstances(cluster, instances) {
    for (let instance of instances) {
        try {
            print(`æ­£åœ¨æ·»åŠ å®ä¾‹: ${instance.address}`)
            cluster.addInstance(instance.address, {
                recoveryMethod: 'clone',
                label: instance.label,
                timeout: 3600
            })
            print(`âœ… ${instance.address} æ·»åŠ æˆåŠŸ`)
        } catch (error) {
            print(`âŒ ${instance.address} æ·»åŠ å¤±è´¥: ${error.message}`)
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
var cluster = dba.getCluster('prodCluster')
var newInstances = [
    {address: 'admin@slave3:3306', label: 'slave-3'},
    {address: 'admin@slave4:3306', label: 'slave-4'},
    {address: 'admin@slave5:3306', label: 'slave-5'}
]

addMultipleInstances(cluster, newInstances)
```

### 9.3 æ‰¹é‡çŠ¶æ€æ£€æŸ¥


**ğŸ” æ‰¹é‡ç›‘æ§è„šæœ¬**
```javascript
// æ‰¹é‡æ£€æŸ¥å®ä¾‹çŠ¶æ€
function checkAllInstances(cluster) {
    var status = cluster.status()
    var topology = status.defaultReplicaSet.topology
    
    print('ğŸ“Š é›†ç¾¤å®ä¾‹çŠ¶æ€æŠ¥å‘Š:')
    print('='.repeat(50))
    
    for (let address in topology) {
        let instance = topology[address]
        let statusIcon = instance.status === 'ONLINE' ? 'ğŸŸ¢' : 'ğŸ”´'
        
        print(`${statusIcon} ${address}:`)
        print(`   çŠ¶æ€: ${instance.status}`)
        print(`   æ¨¡å¼: ${instance.mode}`)
        print(`   è§’è‰²: ${instance.role}`)
        print('')
    }
}

// ä½¿ç”¨ç¤ºä¾‹
var cluster = dba.getCluster('prodCluster')
checkAllInstances(cluster)
```

### 9.4 æ‰¹é‡é…ç½®æ›´æ–°


**âš™ï¸ æ‰¹é‡é…ç½®è„šæœ¬**
```javascript
// æ‰¹é‡æ›´æ–°å®ä¾‹é…ç½®
function updateInstanceTags(cluster, tagUpdates) {
    for (let update of tagUpdates) {
        try {
            cluster.setInstanceOption(
                update.address, 
                update.option, 
                update.value
            )
            print(`âœ… ${update.address} é…ç½®æ›´æ–°æˆåŠŸ`)
        } catch (error) {
            print(`âŒ ${update.address} é…ç½®æ›´æ–°å¤±è´¥: ${error.message}`)
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šæ‰¹é‡æ·»åŠ æ•°æ®ä¸­å¿ƒæ ‡ç­¾
var tagUpdates = [
    {address: 'admin@slave1:3306', option: 'tag:datacenter', value: 'beijing'},
    {address: 'admin@slave2:3306', option: 'tag:datacenter', value: 'shanghai'},
    {address: 'admin@slave3:3306', option: 'tag:datacenter', value: 'beijing'}
]

updateInstanceTags(cluster, tagUpdates)
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ“ä½œ


```
ğŸ”¸ å®ä¾‹æ·»åŠ ï¼šcluster.addInstance() - æ‰©å±•é›†ç¾¤è§„æ¨¡
ğŸ”¸ å®ä¾‹ç§»é™¤ï¼šcluster.removeInstance() - ç¼©å‡æˆ–ç»´æŠ¤
ğŸ”¸ çŠ¶æ€æ£€æŸ¥ï¼šcluster.status() - ç›‘æ§é›†ç¾¤å¥åº·
ğŸ”¸ é…ç½®éªŒè¯ï¼šdba.checkInstanceConfiguration() - ç¡®ä¿é…ç½®æ­£ç¡®
ğŸ”¸ æ•…éšœæ¢å¤ï¼šcluster.rejoinInstance() - æ¢å¤ç¦»çº¿å®ä¾‹
ğŸ”¸ è§’è‰²ç®¡ç†ï¼šcluster.setPrimaryInstance() - ä¸»ä»åˆ‡æ¢
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®ä¾‹ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
æ·»åŠ é˜¶æ®µï¼šé…ç½®éªŒè¯ â†’ æ•°æ®åŒæ­¥ â†’ åŠ å…¥æ‹“æ‰‘
è¿è¡Œé˜¶æ®µï¼šçŠ¶æ€ç›‘æ§ â†’ è§’è‰²ç®¡ç† â†’ æ€§èƒ½ä¼˜åŒ–
æ•…éšœé˜¶æ®µï¼šé—®é¢˜è¯Šæ–­ â†’ æ•…éšœæ¢å¤ â†’ é‡æ–°åŠ å…¥
ç§»é™¤é˜¶æ®µï¼šæ•°æ®åŒæ­¥ â†’ å®‰å…¨ç§»é™¤ â†’ æ¸…ç†å…ƒæ•°æ®
```

**ğŸ”¹ æ“ä½œå®‰å…¨åŸåˆ™**
```
â€¢ æ·»åŠ å®ä¾‹å‰å¿…é¡»éªŒè¯é…ç½®
â€¢ ç§»é™¤å®ä¾‹æ—¶è€ƒè™‘æ•°æ®å®‰å…¨
â€¢ æ•…éšœå¤„ç†è¦å…ˆè¯Šæ–­å†æ“ä½œ
â€¢ æ‰¹é‡æ“ä½œè¦æœ‰é”™è¯¯å¤„ç†æœºåˆ¶
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æ“ä½œåœºæ™¯é€ŸæŸ¥**

| åœºæ™¯ | **æ¨èæ“ä½œ** | **å…³é”®å‚æ•°** | **æ³¨æ„äº‹é¡¹** |
|------|-------------|-------------|-------------|
| ğŸŸ¢ **ä¸šåŠ¡æ‰©å®¹** | `addInstance()` | `recoveryMethod: 'clone'` | é€‰æ‹©åˆé€‚çš„æ¢å¤æ–¹å¼ |
| ğŸŸ¡ **è®¡åˆ’ç»´æŠ¤** | `removeInstance()` | `force: false` | ç¡®ä¿æ•°æ®åŒæ­¥å®Œæˆ |
| ğŸ”´ **ç´§æ€¥æ•…éšœ** | `removeInstance()` | `force: true` | å¿«é€Ÿç§»é™¤æ•…éšœå®ä¾‹ |
| ğŸ”„ **æ•…éšœæ¢å¤** | `rejoinInstance()` | `timeout: é€‚å½“å€¼` | æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ |
| ğŸ‘‘ **ä¸»ä»åˆ‡æ¢** | `setPrimaryInstance()` | æ—  | é€‰æ‹©åˆé€‚çš„æ–°ä¸»å®ä¾‹ |

### 10.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ è¿ç»´å»ºè®®**
```
å®šæœŸç›‘æ§ï¼š
â€¢ æ¯æ—¥æ£€æŸ¥é›†ç¾¤çŠ¶æ€
â€¢ ç›‘æ§å®ä¾‹æ€§èƒ½æŒ‡æ ‡
â€¢ è®°å½•å¼‚å¸¸äº‹ä»¶æ—¥å¿—

é¢„é˜²æªæ–½ï¼š
â€¢ ä¿æŒå®ä¾‹é…ç½®ä¸€è‡´
â€¢ å®šæœŸå¤‡ä»½é›†ç¾¤å…ƒæ•°æ®
â€¢ åˆ¶å®šæ•…éšœåº”æ€¥é¢„æ¡ˆ

æ“ä½œè§„èŒƒï¼š
â€¢ é‡è¦æ“ä½œå‰å…ˆå¤‡ä»½
â€¢ æ‰¹é‡æ“ä½œè¦æµ‹è¯•
â€¢ å˜æ›´è¦æœ‰å®¡æ‰¹æµç¨‹
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†**
- **æ·»åŠ å®ä¾‹**ï¼šåƒæ‹›è˜æ–°å‘˜å·¥ï¼Œè¦éªŒè¯æŠ€èƒ½é…ç½®
- **ç§»é™¤å®ä¾‹**ï¼šåƒå‘˜å·¥ç¦»èŒï¼Œè¦è€ƒè™‘æ˜¯å¦å¼ºåˆ¶
- **çŠ¶æ€æ£€æŸ¥**ï¼šåƒæŸ¥çœ‹å·¥ä½œæŠ¥å‘Šï¼Œäº†è§£å›¢é˜ŸçŠ¶å†µ  
- **æ•…éšœå¤„ç†**ï¼šåƒåŒ»ç”Ÿçœ‹ç—…ï¼Œå…ˆè¯Šæ–­å†æ²»ç–—
- **æ‰¹é‡æ“ä½œ**ï¼šåƒæµæ°´çº¿ä½œä¸šï¼Œè¦æœ‰é”™è¯¯å¤„ç†æœºåˆ¶

**æ ¸å¿ƒåŸåˆ™**ï¼šå®‰å…¨ç¬¬ä¸€ï¼Œæ•°æ®æ— ä»·ï¼Œæ“ä½œæœ‰åºï¼Œç›‘æ§åˆ°ä½