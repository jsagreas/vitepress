---
title: 26ã€å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥å…³é”®å­—
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥æ¦‚è¿°](#1-å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥æ¦‚è¿°)
2. [ä»£ç å—æ§åˆ¶è¯­å¥](#2-ä»£ç å—æ§åˆ¶è¯­å¥)
3. [å˜é‡æ“ä½œè¯­å¥](#3-å˜é‡æ“ä½œè¯­å¥)
4. [æ¡ä»¶æ§åˆ¶è¯­å¥](#4-æ¡ä»¶æ§åˆ¶è¯­å¥)
5. [å¾ªç¯æ§åˆ¶è¯­å¥](#5-å¾ªç¯æ§åˆ¶è¯­å¥)
6. [æµç¨‹è·³è½¬è¯­å¥](#6-æµç¨‹è·³è½¬è¯­å¥)
7. [è¿‡ç¨‹è°ƒç”¨è¯­å¥](#7-è¿‡ç¨‹è°ƒç”¨è¯­å¥)
8. [å¼‚å¸¸å¤„ç†è¯­å¥](#8-å¼‚å¸¸å¤„ç†è¯­å¥)
9. [è¯Šæ–­ä¿¡æ¯è¯­å¥](#9-è¯Šæ–­ä¿¡æ¯è¯­å¥)
10. [ç»¼åˆå®æˆ˜æ¡ˆä¾‹](#10-ç»¼åˆå®æˆ˜æ¡ˆä¾‹)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥


**ğŸ”¸ é€šä¿—ç†è§£**
```
å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥å°±åƒç¼–ç¨‹è¯­è¨€ä¸­çš„æ§åˆ¶ç»“æ„

ç±»æ¯”ç†è§£ï¼š
å†™æ–‡ç«  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å†™å­˜å‚¨è¿‡ç¨‹
    â”‚                      â”‚
æ®µè½ç»“æ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ BEGIN/ENDä»£ç å—
    â”‚                      â”‚
æ¡ä»¶è¡¨è¾¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ IF/THEN/ELSEè¯­å¥
    â”‚                      â”‚
é‡å¤å†…å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ LOOP/WHILEå¾ªç¯
    â”‚                      â”‚
è·³è½¬å¼•ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ GOTO/LABELè¯­å¥
```

**ğŸ’¡ æ§åˆ¶è¯­å¥çš„ä½œç”¨**
- **ä»£ç ç»„ç»‡**ï¼šå°†ç›¸å…³ä»£ç ç»„ç»‡æˆé€»è¾‘å—
- **æ¡ä»¶åˆ¤æ–­**ï¼šæ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒä»£ç 
- **å¾ªç¯å¤„ç†**ï¼šé‡å¤æ‰§è¡Œç›¸åŒçš„å¤„ç†é€»è¾‘
- **å¼‚å¸¸å¤„ç†**ï¼šå¤„ç†è¿è¡Œæ—¶å‡ºç°çš„é”™è¯¯æƒ…å†µ

### 1.2 å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥åˆ†ç±»


**ğŸ“Š æ§åˆ¶è¯­å¥åˆ†ç±»å›¾**
```
å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥
â”œâ”€ ä»£ç å—æ§åˆ¶
â”‚  â”œâ”€ BEGIN (å¼€å§‹å—)
â”‚  â””â”€ END (ç»“æŸå—)
â”‚
â”œâ”€ å˜é‡æ“ä½œ  
â”‚  â”œâ”€ DECLARE (å£°æ˜å˜é‡)
â”‚  â”œâ”€ SET (èµ‹å€¼å˜é‡)
â”‚  â””â”€ SELECT_INTO (æŸ¥è¯¢èµ‹å€¼)
â”‚
â”œâ”€ æ¡ä»¶æ§åˆ¶
â”‚  â”œâ”€ IF/THEN/ELSE (æ¡ä»¶åˆ†æ”¯)
â”‚  â”œâ”€ ELSEIF (å¤šé‡æ¡ä»¶)
â”‚  â””â”€ CASE/WHEN (å¤šåˆ†æ”¯é€‰æ‹©)
â”‚
â”œâ”€ å¾ªç¯æ§åˆ¶
â”‚  â”œâ”€ LOOP (æ— é™å¾ªç¯)
â”‚  â”œâ”€ WHILE (æ¡ä»¶å¾ªç¯)  
â”‚  â”œâ”€ REPEAT/UNTIL (åç½®æ¡ä»¶å¾ªç¯)
â”‚  â”œâ”€ LEAVE (è·³å‡ºå¾ªç¯)
â”‚  â””â”€ ITERATE (ç»§ç»­å¾ªç¯)
â”‚
â”œâ”€ æµç¨‹è·³è½¬
â”‚  â”œâ”€ LABEL (æ ‡ç­¾)
â”‚  â”œâ”€ GOTO (è·³è½¬)
â”‚  â”œâ”€ CALL (è°ƒç”¨è¿‡ç¨‹)
â”‚  â””â”€ RETURN (è¿”å›å€¼)
â”‚
â””â”€ å¼‚å¸¸å¤„ç†
   â”œâ”€ SIGNAL (æŠ›å‡ºå¼‚å¸¸)
   â”œâ”€ RESIGNAL (é‡æ–°æŠ›å‡º)
   â”œâ”€ CONDITION (æ¡ä»¶å®šä¹‰)
   â”œâ”€ HANDLER (å¼‚å¸¸å¤„ç†å™¨)
   â”œâ”€ GET DIAGNOSTICS (è·å–è¯Šæ–­ä¿¡æ¯)
   â””â”€ å¤„ç†åŠ¨ä½œ (CONTINUE/EXIT/UNDO)
```

---

## 2. ğŸ“¦ ä»£ç å—æ§åˆ¶è¯­å¥


### 2.1 BEGINå¼€å§‹å—


**ğŸ”¸ BEGINçš„å«ä¹‰**
```
BEGINå°±æ˜¯å‘Šè¯‰æ•°æ®åº“ï¼š
"ä»è¿™é‡Œå¼€å§‹ï¼Œä¸‹é¢çš„è¯­å¥æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œè¦å½“ä½œä¸€ä¸ªå•å…ƒæ¥æ‰§è¡Œ"

å°±åƒå†™ä½œæ–‡æ—¶çš„æ®µè½æ ‡è®°ï¼Œè¡¨ç¤ºä¸€æ®µå†…å®¹çš„å¼€å§‹
```

**ğŸ’» BEGINè¯­æ³•å’Œä½œç”¨**
```sql
-- åŸºç¡€è¯­æ³•
BEGIN
    -- è¿™é‡Œå†™å…·ä½“çš„SQLè¯­å¥
    -- å¯ä»¥åŒ…å«å¤šæ¡è¯­å¥
END;

-- å®é™…ç¤ºä¾‹
BEGIN
    DECLARE v_count INT DEFAULT 0;
    DECLARE v_message VARCHAR(100);
    
    SELECT COUNT(*) INTO v_count FROM users;
    SET v_message = CONCAT('ç”¨æˆ·æ€»æ•°: ', v_count);
    SELECT v_message;
END;
```

**ğŸ¯ BEGINçš„å®é™…ä½œç”¨**
```
ä»£ç ç»„ç»‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BEGIN                       â”‚ â† é€»è¾‘å—å¼€å§‹
â”‚   å£°æ˜å˜é‡                  â”‚
â”‚   ä¸šåŠ¡é€»è¾‘1                 â”‚ 
â”‚   ä¸šåŠ¡é€»è¾‘2                 â”‚
â”‚   å¼‚å¸¸å¤„ç†                  â”‚
â”‚ END                         â”‚ â† é€»è¾‘å—ç»“æŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½œç”¨åŸŸæ§åˆ¶ï¼š
- BEGINå—å†…å£°æ˜çš„å˜é‡åªåœ¨è¯¥å—å†…æœ‰æ•ˆ
- å—ç»“æŸåå˜é‡è‡ªåŠ¨é‡Šæ”¾
- æ”¯æŒåµŒå¥—ï¼Œå†…å±‚å¯ä»¥è®¿é—®å¤–å±‚å˜é‡
```

### 2.2 ENDç»“æŸå—


**ğŸ”¸ ENDçš„å¿…è¦æ€§**
```
ENDæ˜¯BEGINçš„æ­æ¡£ï¼Œå¿…é¡»æˆå¯¹å‡ºç°

ç±»æ¯”ï¼š
BEGIN = å·¦æ‹¬å· (
END   = å³æ‹¬å· )

æ²¡æœ‰ENDçš„åæœï¼š
âŒ è¯­æ³•é”™è¯¯ï¼Œå­˜å‚¨è¿‡ç¨‹æ— æ³•åˆ›å»º
âŒ æ•°æ®åº“æ— æ³•ç¡®å®šä»£ç å—çš„è¾¹ç•Œ
âŒ å˜é‡ä½œç”¨åŸŸæ··ä¹±
```

**ğŸ’» ENDçš„ä½¿ç”¨è§„åˆ™**
```sql
-- ç®€å•å—ç»“æ„
BEGIN
    -- ä»£ç å†…å®¹
END;

-- åµŒå¥—å—ç»“æ„  
BEGIN
    DECLARE v_outer INT DEFAULT 1;
    
    -- å¤–å±‚é€»è¾‘
    SET v_outer = 10;
    
    BEGIN
        DECLARE v_inner INT DEFAULT 2;
        -- å†…å±‚é€»è¾‘ï¼Œå¯ä»¥è®¿é—®v_outer
        SET v_inner = v_outer + 5;
    END; -- å†…å±‚ç»“æŸ
    
    -- ç»§ç»­å¤–å±‚é€»è¾‘
    -- æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½è®¿é—®v_inneräº†
END; -- å¤–å±‚ç»“æŸ
```

**âš ï¸ ENDä½¿ç”¨æ³¨æ„äº‹é¡¹**
```
é…å¯¹è§„åˆ™ï¼š
âœ… æ¯ä¸ªBEGINå¿…é¡»æœ‰å¯¹åº”çš„END
âœ… åµŒå¥—æ—¶è¦æ³¨æ„å±‚æ¬¡å¯¹åº”å…³ç³»
âœ… å¯ä»¥ç”¨æ³¨é‡Šæ ‡æ˜æ¯ä¸ªENDå¯¹åº”çš„BEGIN

é”™è¯¯ç¤ºä¾‹ï¼š
âŒ BEGIN ... BEGIN ... END; (ç¼ºå°‘ä¸€ä¸ªEND)
âŒ BEGIN ... END END; (å¤šäº†ä¸€ä¸ªEND)
```

---

## 3. ğŸ“‹ å˜é‡æ“ä½œè¯­å¥


### 3.1 DECLAREå£°æ˜å˜é‡


**ğŸ”¸ DECLAREçš„ä½œç”¨**
```
DECLAREå°±æ˜¯å‘Šè¯‰æ•°æ®åº“ï¼š
"æˆ‘éœ€è¦ä¸€ä¸ªå˜é‡æ¥å­˜å‚¨æ•°æ®ï¼Œå®ƒçš„åå­—å«xxxï¼Œç±»å‹æ˜¯xxx"

å°±åƒåœ¨ç¨‹åºå¼€å§‹å‰å‡†å¤‡å¥½éœ€è¦ç”¨çš„å®¹å™¨
```

**ğŸ’» DECLAREå£°æ˜è¯­æ³•**
```sql
-- åŸºæœ¬è¯­æ³•
DECLARE variable_name datatype [DEFAULT default_value];

-- å®é™…ç¤ºä¾‹
DECLARE v_user_id INT;                    -- å£°æ˜æ•´æ•°å˜é‡
DECLARE v_username VARCHAR(50);           -- å£°æ˜å­—ç¬¦ä¸²å˜é‡
DECLARE v_salary DECIMAL(10,2) DEFAULT 0; -- å£°æ˜å¸¦é»˜è®¤å€¼çš„å°æ•°å˜é‡
DECLARE v_birth_date DATE;                -- å£°æ˜æ—¥æœŸå˜é‡
DECLARE v_is_active BOOLEAN DEFAULT TRUE; -- å£°æ˜å¸ƒå°”å˜é‡
```

**ğŸ“Š å˜é‡å£°æ˜çš„ä½ç½®è§„åˆ™**
```
å­˜å‚¨è¿‡ç¨‹ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE PROCEDURE ...        â”‚
â”‚ BEGIN                       â”‚ 
â”‚   â”Œâ”€ å˜é‡å£°æ˜åŒºåŸŸ â”€â”€â”€â”€â”€â”   â”‚ â† DECLAREå¿…é¡»åœ¨è¿™é‡Œ
â”‚   â”‚ DECLARE v1 INT;    â”‚   â”‚
â”‚   â”‚ DECLARE v2 VARCHAR;â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€ æ¸¸æ ‡å£°æ˜åŒºåŸŸ â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ DECLARE cur CURSOR â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€ å¼‚å¸¸å¤„ç†å£°æ˜ â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ DECLARE HANDLER    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€ æ‰§è¡Œé€»è¾‘åŒºåŸŸ â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ SET v1 = 100;      â”‚   â”‚
â”‚   â”‚ SELECT ...         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ END                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å£°æ˜å˜é‡çš„æœ€ä½³å®è·µ**
```sql
-- æ¨èçš„å˜é‡å‘½åå’Œå£°æ˜æ–¹å¼
CREATE PROCEDURE process_user_orders()
BEGIN
    -- 1. åŸºæœ¬æ•°æ®å˜é‡
    DECLARE v_user_id INT DEFAULT 0;           -- ç”¨æˆ·ID
    DECLARE v_order_count INT DEFAULT 0;       -- è®¢å•æ•°é‡
    DECLARE v_total_amount DECIMAL(10,2) DEFAULT 0.00; -- æ€»é‡‘é¢
    
    -- 2. å­—ç¬¦ä¸²å˜é‡
    DECLARE v_user_name VARCHAR(100) DEFAULT '';       -- ç”¨æˆ·å§“å
    DECLARE v_status_message VARCHAR(200) DEFAULT '';  -- çŠ¶æ€æ¶ˆæ¯
    
    -- 3. æ—¥æœŸæ—¶é—´å˜é‡
    DECLARE v_process_date DATE DEFAULT CURDATE();     -- å¤„ç†æ—¥æœŸ
    DECLARE v_start_time TIMESTAMP DEFAULT NOW();      -- å¼€å§‹æ—¶é—´
    
    -- 4. æ§åˆ¶å˜é‡
    DECLARE v_done BOOLEAN DEFAULT FALSE;              -- å¾ªç¯æ§åˆ¶
    DECLARE v_error_occurred BOOLEAN DEFAULT FALSE;    -- é”™è¯¯æ ‡è¯†
    
    -- æ‰§è¡Œé€»è¾‘...
END;
```

### 3.2 SETèµ‹å€¼å˜é‡


**ğŸ”¸ SETçš„å«ä¹‰**
```
SETå°±æ˜¯ç»™å˜é‡èµ‹å€¼ï¼ŒæŠŠæ•°æ®æ”¾åˆ°å˜é‡é‡Œ

ç±»æ¯”ï¼š
å˜é‡ = ç›’å­
SET  = æŠŠä¸œè¥¿æ”¾è¿›ç›’å­çš„åŠ¨ä½œ
å€¼   = æ”¾è¿›å»çš„ä¸œè¥¿
```

**ğŸ’» SETèµ‹å€¼è¯­æ³•**
```sql
-- åŸºæœ¬è¯­æ³•
SET variable_name = value;

-- å„ç§èµ‹å€¼ç¤ºä¾‹
SET v_user_id = 1001;                    -- èµ‹å¸¸é‡å€¼
SET v_username = 'John';                 -- èµ‹å­—ç¬¦ä¸²å€¼
SET v_salary = v_base_salary * 1.1;      -- èµ‹è®¡ç®—ç»“æœ
SET v_current_date = NOW();              -- èµ‹å‡½æ•°è¿”å›å€¼
SET v_is_valid = (v_age >= 18);          -- èµ‹å¸ƒå°”è¡¨è¾¾å¼ç»“æœ
```

**ğŸ¯ SETçš„å®é™…åº”ç”¨åœºæ™¯**
```sql
-- å®Œæ•´çš„å˜é‡èµ‹å€¼ç¤ºä¾‹
CREATE PROCEDURE calculate_employee_bonus(IN emp_id INT)
BEGIN
    DECLARE v_base_salary DECIMAL(10,2) DEFAULT 0;
    DECLARE v_performance_score INT DEFAULT 0;
    DECLARE v_bonus_rate DECIMAL(5,4) DEFAULT 0;
    DECLARE v_final_bonus DECIMAL(10,2) DEFAULT 0;
    DECLARE v_message VARCHAR(200) DEFAULT '';
    
    -- 1. é€šè¿‡è®¡ç®—èµ‹å€¼
    SET v_bonus_rate = 0.15; -- åŸºç¡€å¥–é‡‘æ¯”ä¾‹15%
    
    -- 2. é€šè¿‡æ¡ä»¶èµ‹å€¼
    IF v_performance_score >= 90 THEN
        SET v_bonus_rate = 0.25;  -- ä¼˜ç§€å‘˜å·¥25%
    ELSEIF v_performance_score >= 80 THEN
        SET v_bonus_rate = 0.20;  -- è‰¯å¥½å‘˜å·¥20%
    END IF;
    
    -- 3. é€šè¿‡è®¡ç®—å…¬å¼èµ‹å€¼
    SET v_final_bonus = v_base_salary * v_bonus_rate;
    
    -- 4. é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥èµ‹å€¼
    SET v_message = CONCAT('å‘˜å·¥', emp_id, 'çš„å¥–é‡‘ä¸º: ', v_final_bonus);
    
    SELECT v_message AS result;
END;
```

### 3.3 SELECT_INTOæŸ¥è¯¢èµ‹å€¼


**ğŸ”¸ SELECT INTOçš„ä½œç”¨**
```
SELECT INTOæ˜¯ä»æ•°æ®åº“æŸ¥è¯¢ç»“æœç›´æ¥èµ‹å€¼ç»™å˜é‡

æ™®é€šçš„SELECTï¼šæŠŠç»“æœæ˜¾ç¤ºç»™ç”¨æˆ·çœ‹
SELECT INTOï¼šæŠŠç»“æœå­˜åˆ°å˜é‡é‡Œä¾›ç¨‹åºä½¿ç”¨

å°±åƒï¼š
æ™®é€šSELECT = æŠŠæŸ¥åˆ°çš„ä¿¡æ¯è¯´ç»™ä½ å¬
SELECT INTO = æŠŠæŸ¥åˆ°çš„ä¿¡æ¯å†™åœ¨çº¸æ¡ä¸Šç»™ä½ 
```

**ğŸ’» SELECT INTOè¯­æ³•**
```sql
-- åŸºæœ¬è¯­æ³•
SELECT column1, column2 INTO variable1, variable2 
FROM table_name 
WHERE condition;

-- å•ä¸ªå€¼æŸ¥è¯¢
SELECT username INTO v_username 
FROM users 
WHERE user_id = 1001;

-- å¤šä¸ªå€¼æŸ¥è¯¢
SELECT username, email, age INTO v_name, v_email, v_age
FROM users 
WHERE user_id = 1001;

-- èšåˆæŸ¥è¯¢
SELECT COUNT(*), AVG(salary) INTO v_total_count, v_avg_salary
FROM employees 
WHERE department = 'IT';
```

**ğŸ¯ SELECT INTOçš„å®é™…åº”ç”¨**
```sql
-- å®Œæ•´çš„æŸ¥è¯¢èµ‹å€¼ç¤ºä¾‹
CREATE PROCEDURE get_user_summary(IN user_id INT)
BEGIN
    DECLARE v_username VARCHAR(100);
    DECLARE v_email VARCHAR(200); 
    DECLARE v_total_orders INT DEFAULT 0;
    DECLARE v_total_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_last_order_date DATE;
    DECLARE v_user_level VARCHAR(20) DEFAULT 'Bronze';
    
    -- 1. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    SELECT username, email 
    INTO v_username, v_email
    FROM users 
    WHERE id = user_id;
    
    -- 2. æŸ¥è¯¢ç”¨æˆ·è®¢å•ç»Ÿè®¡
    SELECT COUNT(*), IFNULL(SUM(amount), 0), MAX(order_date)
    INTO v_total_orders, v_total_amount, v_last_order_date
    FROM orders 
    WHERE user_id = user_id;
    
    -- 3. æ ¹æ®æ¶ˆè´¹é‡‘é¢ç¡®å®šç”¨æˆ·ç­‰çº§
    SELECT CASE 
        WHEN v_total_amount >= 10000 THEN 'Platinum'
        WHEN v_total_amount >= 5000 THEN 'Gold'  
        WHEN v_total_amount >= 1000 THEN 'Silver'
        ELSE 'Bronze'
    END INTO v_user_level;
    
    -- 4. è¿”å›æ±‡æ€»ä¿¡æ¯
    SELECT 
        v_username AS username,
        v_email AS email,
        v_total_orders AS total_orders,
        v_total_amount AS total_amount,
        v_last_order_date AS last_order_date,
        v_user_level AS user_level;
END;
```

**âš ï¸ SELECT INTOæ³¨æ„äº‹é¡¹**
```
é‡è¦æ³¨æ„ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢å¿…é¡»è¿”å›ç¡®åˆ‡ä¸€è¡Œæ•°æ®  â”‚ â† ä¸èƒ½æ˜¯0è¡Œæˆ–å¤šè¡Œ
â”‚ 2. å˜é‡æ•°é‡è¦ä¸æŸ¥è¯¢å­—æ®µåŒ¹é…  â”‚ â† æ•°é‡å’Œç±»å‹éƒ½è¦å¯¹åº”
â”‚ 3. æŸ¥è¯¢æ— ç»“æœæ—¶å˜é‡å€¼ä¸ºNULL â”‚ â† è¦è€ƒè™‘NULLå€¼å¤„ç†
â”‚ 4. æŸ¥è¯¢å¤šè¡Œä¼šæŠ¥é”™TOO_MANY_ROWS â”‚ â† éœ€è¦å¼‚å¸¸å¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é”™è¯¯å¤„ç†ç¤ºä¾‹ï¼š
BEGIN
    DECLARE v_username VARCHAR(100) DEFAULT 'Unknown';
    
    -- å¯èƒ½å‡ºé”™çš„æŸ¥è¯¢
    SELECT username INTO v_username 
    FROM users 
    WHERE status = 'active' 
    LIMIT 1;  -- ç¡®ä¿æœ€å¤šè¿”å›ä¸€è¡Œ
    
    -- æ£€æŸ¥æ˜¯å¦æŸ¥åˆ°æ•°æ®
    IF v_username IS NULL THEN
        SET v_username = 'No active user found';
    END IF;
END;
```

---

## 4. ğŸ”€ æ¡ä»¶æ§åˆ¶è¯­å¥


### 4.1 IFæ¡ä»¶è¯­å¥


**ğŸ”¸ IFè¯­å¥çš„å«ä¹‰**
```
IFè¯­å¥å°±æ˜¯è®©ç¨‹åºåšåˆ¤æ–­ï¼Œæ ¹æ®æ¡ä»¶å†³å®šæ‰§è¡Œå“ªäº›ä»£ç 

ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
å¦‚æœä¸‹é›¨ï¼Œå°±å¸¦ä¼
å¦‚æœä¸ä¸‹é›¨ï¼Œå°±ä¸å¸¦ä¼

ç¨‹åºä¸­ï¼š
å¦‚æœç”¨æˆ·ç§¯åˆ†>1000ï¼Œå°±å‡çº§ä¸ºVIP
å¦‚æœç”¨æˆ·ç§¯åˆ†<=1000ï¼Œå°±ä¿æŒæ™®é€šç”¨æˆ·
```

**ğŸ’» IFè¯­å¥è¯­æ³•ç»“æ„**
```sql
-- åŸºæœ¬IFè¯­å¥
IF condition THEN
    -- æ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œçš„è¯­å¥
END IF;

-- IF-ELSEè¯­å¥  
IF condition THEN
    -- æ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œ
ELSE
    -- æ¡ä»¶ä¸ºå‡æ—¶æ‰§è¡Œ
END IF;

-- IF-ELSEIF-ELSEè¯­å¥
IF condition1 THEN
    -- æ¡ä»¶1ä¸ºçœŸæ—¶æ‰§è¡Œ
ELSEIF condition2 THEN  
    -- æ¡ä»¶2ä¸ºçœŸæ—¶æ‰§è¡Œ
ELSE
    -- æ‰€æœ‰æ¡ä»¶éƒ½ä¸ºå‡æ—¶æ‰§è¡Œ
END IF;
```

### 4.2 THENé‚£ä¹ˆæ‰§è¡Œ


**ğŸ”¸ THENçš„ä½œç”¨**
```
THENæ˜¯IFè¯­å¥çš„å¿…éœ€éƒ¨åˆ†ï¼Œè¡¨ç¤º"é‚£ä¹ˆå°±æ‰§è¡Œ..."

è¯­æ³•ç»“æ„ï¼š
IF æ¡ä»¶ THEN æ‰§è¡ŒåŠ¨ä½œ

THENå°±åƒä¸€ä¸ªè¿æ¥è¯ï¼Œè¿æ¥åˆ¤æ–­æ¡ä»¶å’Œæ‰§è¡ŒåŠ¨ä½œ
```

**ğŸ¯ å®Œæ•´çš„IF-THENç¤ºä¾‹**
```sql
-- ç”¨æˆ·ç­‰çº§åˆ¤æ–­ç¤ºä¾‹
CREATE PROCEDURE update_user_level(IN user_id INT)
BEGIN
    DECLARE v_total_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_current_level VARCHAR(20);
    DECLARE v_new_level VARCHAR(20);
    
    -- è·å–ç”¨æˆ·æ€»æ¶ˆè´¹é‡‘é¢
    SELECT IFNULL(SUM(amount), 0) INTO v_total_amount
    FROM orders 
    WHERE user_id = user_id;
    
    -- è·å–å½“å‰ç­‰çº§
    SELECT user_level INTO v_current_level 
    FROM users 
    WHERE id = user_id;
    
    -- æ ¹æ®æ¶ˆè´¹é‡‘é¢åˆ¤æ–­æ–°ç­‰çº§
    IF v_total_amount >= 50000 THEN
        SET v_new_level = 'Diamond';
    ELSEIF v_total_amount >= 20000 THEN
        SET v_new_level = 'Platinum';  
    ELSEIF v_total_amount >= 10000 THEN
        SET v_new_level = 'Gold';
    ELSEIF v_total_amount >= 5000 THEN
        SET v_new_level = 'Silver';
    ELSE
        SET v_new_level = 'Bronze';
    END IF;
    
    -- å¦‚æœç­‰çº§æœ‰å˜åŒ–ï¼Œåˆ™æ›´æ–°æ•°æ®åº“
    IF v_new_level != v_current_level THEN
        UPDATE users 
        SET user_level = v_new_level, level_update_date = NOW()
        WHERE id = user_id;
        
        SELECT CONCAT('ç”¨æˆ·ç­‰çº§å·²ä» ', v_current_level, ' å‡çº§ä¸º ', v_new_level) AS message;
    ELSE
        SELECT 'ç”¨æˆ·ç­‰çº§æ— å˜åŒ–' AS message;
    END IF;
END;
```

### 4.3 ELSEIFå¦åˆ™å¦‚æœ


**ğŸ”¸ ELSEIFçš„ä½œç”¨**
```
ELSEIFç”¨äºå¤šé‡æ¡ä»¶åˆ¤æ–­ï¼Œå½“ç¬¬ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œç»§ç»­åˆ¤æ–­å…¶ä»–æ¡ä»¶

åˆ¤æ–­æµç¨‹ï¼š
æ¡ä»¶1 â†’ ä¸æ»¡è¶³ â†’ æ¡ä»¶2 â†’ ä¸æ»¡è¶³ â†’ æ¡ä»¶3 â†’ ...

å°±åƒå¤šé‡é€‰æ‹©é¢˜ï¼Œä¸€ä¸ªä¸ªé€‰é¡¹å»æ£€æŸ¥
```

**ğŸ’» ELSEIFå®é™…åº”ç”¨**
```sql
-- å‘˜å·¥ç»©æ•ˆè¯„å®šç¤ºä¾‹
CREATE PROCEDURE evaluate_performance(IN emp_id INT)
BEGIN
    DECLARE v_sales_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_customer_rating DECIMAL(3,2) DEFAULT 0;
    DECLARE v_attendance_rate DECIMAL(5,2) DEFAULT 0;
    DECLARE v_performance_grade VARCHAR(10);
    DECLARE v_bonus_multiplier DECIMAL(3,2) DEFAULT 1.0;
    
    -- è·å–å‘˜å·¥å„é¡¹æŒ‡æ ‡
    SELECT sales_total, customer_rating, attendance_rate 
    INTO v_sales_amount, v_customer_rating, v_attendance_rate
    FROM employee_metrics 
    WHERE employee_id = emp_id;
    
    -- ç»¼åˆè¯„å®šç»©æ•ˆç­‰çº§
    IF v_sales_amount >= 100000 AND v_customer_rating >= 4.5 AND v_attendance_rate >= 95 THEN
        SET v_performance_grade = 'A+';
        SET v_bonus_multiplier = 2.0;
    ELSEIF v_sales_amount >= 80000 AND v_customer_rating >= 4.0 AND v_attendance_rate >= 90 THEN
        SET v_performance_grade = 'A';
        SET v_bonus_multiplier = 1.8;
    ELSEIF v_sales_amount >= 60000 AND v_customer_rating >= 3.5 AND v_attendance_rate >= 85 THEN
        SET v_performance_grade = 'B+';
        SET v_bonus_multiplier = 1.5;
    ELSEIF v_sales_amount >= 40000 AND v_customer_rating >= 3.0 AND v_attendance_rate >= 80 THEN
        SET v_performance_grade = 'B';
        SET v_bonus_multiplier = 1.2;
    ELSEIF v_sales_amount >= 20000 AND v_customer_rating >= 2.5 AND v_attendance_rate >= 75 THEN
        SET v_performance_grade = 'C';
        SET v_bonus_multiplier = 1.0;
    ELSE
        SET v_performance_grade = 'D';
        SET v_bonus_multiplier = 0.8;
    END IF;
    
    -- æ›´æ–°ç»©æ•ˆç»“æœ
    UPDATE employees 
    SET performance_grade = v_performance_grade,
        bonus_multiplier = v_bonus_multiplier,
        evaluation_date = NOW()
    WHERE id = emp_id;
    
    SELECT 
        emp_id AS employee_id,
        v_performance_grade AS grade,
        v_bonus_multiplier AS bonus_rate,
        'ç»©æ•ˆè¯„å®šå®Œæˆ' AS status;
END;
```

### 4.4 ELSEå¦åˆ™æ‰§è¡Œ


**ğŸ”¸ ELSEçš„ä½œç”¨**
```
ELSEæ˜¯æ‰€æœ‰æ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶çš„å…œåº•é€‰æ‹©

ç±»æ¯”ï¼š
IF     = å¦‚æœæ˜¯æ™´å¤©ï¼Œå°±å»å…¬å›­
ELSEIF = å¦‚æœæ˜¯é˜´å¤©ï¼Œå°±å»å•†åœº  
ELSE   = å…¶ä»–ä»»ä½•æƒ…å†µï¼Œå°±åœ¨å®¶ä¼‘æ¯

ELSEç¡®ä¿æ€»æœ‰ä¸€ä¸ªæ‰§è¡Œè·¯å¾„ï¼Œé¿å…é—æ¼æƒ…å†µ
```

### 4.5 CASEå¤šåˆ†æ”¯è¯­å¥


**ğŸ”¸ CASEè¯­å¥çš„ä¼˜åŠ¿**
```
CASEè¯­å¥æ˜¯å¤šåˆ†æ”¯é€‰æ‹©çš„å¦ä¸€ç§å†™æ³•ï¼Œæ¯”å¤šä¸ªELSEIFæ›´æ¸…æ™°

CASE vs IF-ELSEIFï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IF-ELSEIF     â”‚    â”‚      CASE       â”‚
â”‚                 â”‚    â”‚                 â”‚  
â”‚ â€¢ é€‚åˆå¤æ‚æ¡ä»¶  â”‚    â”‚ â€¢ é€‚åˆç®€å•å€¼åŒ¹é… â”‚
â”‚ â€¢ æ¡ä»¶å¯ä»¥ä¸åŒ  â”‚    â”‚ â€¢ è¯­æ³•æ›´ç®€æ´    â”‚
â”‚ â€¢ çµæ´»æ€§æ›´é«˜    â”‚    â”‚ â€¢ å¯è¯»æ€§æ›´å¥½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» CASEè¯­å¥è¯­æ³•**
```sql
-- ç®€å•CASEè¯­å¥ï¼ˆå€¼åŒ¹é…ï¼‰
CASE expression
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    WHEN value3 THEN result3
    ELSE default_result
END CASE;

-- æœç´¢CASEè¯­å¥ï¼ˆæ¡ä»¶åˆ¤æ–­ï¼‰
CASE 
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2  
    WHEN condition3 THEN result3
    ELSE default_result
END CASE;
```

### 4.6 WHENæ¡ä»¶åˆ†æ”¯


**ğŸ”¸ WHENçš„ä½¿ç”¨æ–¹æ³•**
```sql
-- è®¢å•çŠ¶æ€å¤„ç†ç¤ºä¾‹
CREATE PROCEDURE process_order_status(IN order_id INT)
BEGIN
    DECLARE v_status VARCHAR(20);
    DECLARE v_action VARCHAR(100);
    DECLARE v_next_step VARCHAR(100);
    
    -- è·å–è®¢å•çŠ¶æ€
    SELECT status INTO v_status FROM orders WHERE id = order_id;
    
    -- ä½¿ç”¨CASE-WHENå¤„ç†ä¸åŒçŠ¶æ€
    CASE v_status
        WHEN 'pending' THEN
            SET v_action = 'ç­‰å¾…æ”¯ä»˜ç¡®è®¤';
            SET v_next_step = 'è”ç³»å®¢æˆ·ç¡®è®¤æ”¯ä»˜æ–¹å¼';
            
        WHEN 'paid' THEN
            SET v_action = 'å¼€å§‹å¤‡è´§';
            SET v_next_step = 'é€šçŸ¥ä»“åº“å‡†å¤‡å‘è´§';
            
        WHEN 'shipped' THEN
            SET v_action = 'å·²å‘è´§';
            SET v_next_step = 'è·Ÿè¸ªç‰©æµä¿¡æ¯';
            
        WHEN 'delivered' THEN
            SET v_action = 'å·²é€è¾¾';
            SET v_next_step = 'ç­‰å¾…å®¢æˆ·ç¡®è®¤æ”¶è´§';
            
        WHEN 'completed' THEN
            SET v_action = 'è®¢å•å®Œæˆ';
            SET v_next_step = 'å½’æ¡£è®¢å•ä¿¡æ¯';
            
        WHEN 'cancelled' THEN
            SET v_action = 'è®¢å•å·²å–æ¶ˆ';
            SET v_next_step = 'å¤„ç†é€€æ¬¾';
            
        ELSE
            SET v_action = 'æœªçŸ¥çŠ¶æ€';
            SET v_next_step = 'äººå·¥å¤„ç†';
    END CASE;
    
    -- è®°å½•å¤„ç†ç»“æœ
    INSERT INTO order_logs (order_id, action, next_step, log_time)
    VALUES (order_id, v_action, v_next_step, NOW());
    
    SELECT v_action AS current_action, v_next_step AS next_step;
END;
```

---

## 5. ğŸ”„ å¾ªç¯æ§åˆ¶è¯­å¥


### 5.1 LOOPæ— é™å¾ªç¯


**ğŸ”¸ LOOPå¾ªç¯çš„ç‰¹ç‚¹**
```
LOOPæ˜¯æœ€åŸºç¡€çš„å¾ªç¯ï¼Œæœ¬èº«æ²¡æœ‰é€€å‡ºæ¡ä»¶ï¼Œéœ€è¦æ‰‹åŠ¨æ§åˆ¶é€€å‡º

ç‰¹ç‚¹ï¼š
â€¢ æ— æ¡ä»¶å¾ªç¯ï¼šä¸ä¼šè‡ªåŠ¨åœæ­¢
â€¢ éœ€è¦LEAVEé€€å‡ºï¼šå¿…é¡»ç”¨LEAVEè¯­å¥è·³å‡º
â€¢ é€‚åˆå¤æ‚æ¡ä»¶ï¼šå½“é€€å‡ºæ¡ä»¶æ¯”è¾ƒå¤æ‚æ—¶ä½¿ç”¨

å±é™©æ€§ï¼š
âŒ å¿˜è®°å†™LEAVEä¼šé€ æˆæ­»å¾ªç¯
âŒ é€€å‡ºæ¡ä»¶é”™è¯¯å¯èƒ½å¯¼è‡´æ— é™æ‰§è¡Œ
```

**ğŸ’» LOOPè¯­æ³•å’Œä½¿ç”¨**
```sql
-- åŸºæœ¬è¯­æ³•
[label:] LOOP
    -- å¾ªç¯ä½“
    IF exit_condition THEN
        LEAVE label;
    END IF;
END LOOP [label];

-- å®é™…ç¤ºä¾‹ï¼šæ‰¹é‡å¤„ç†æ•°æ®
CREATE PROCEDURE batch_process_users()
BEGIN
    DECLARE v_user_id INT DEFAULT 0;
    DECLARE v_batch_size INT DEFAULT 100;
    DECLARE v_processed_count INT DEFAULT 0;
    DECLARE v_total_processed INT DEFAULT 0;
    
    process_loop: LOOP
        -- è·å–ä¸‹ä¸€æ‰¹å¾…å¤„ç†çš„ç”¨æˆ·ID
        SELECT MIN(id) INTO v_user_id 
        FROM users 
        WHERE status = 'pending' AND id > v_user_id
        LIMIT 1;
        
        -- å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œé€€å‡ºå¾ªç¯
        IF v_user_id IS NULL THEN
            LEAVE process_loop;
        END IF;
        
        -- å¤„ç†å½“å‰æ‰¹æ¬¡çš„æ•°æ®
        UPDATE users 
        SET status = 'processed', process_date = NOW()
        WHERE status = 'pending' 
        AND id >= v_user_id 
        AND id < v_user_id + v_batch_size;
        
        -- ç»Ÿè®¡å¤„ç†æ•°é‡
        SET v_processed_count = ROW_COUNT();
        SET v_total_processed = v_total_processed + v_processed_count;
        
        -- è¾“å‡ºè¿›åº¦ä¿¡æ¯
        SELECT CONCAT('å·²å¤„ç† ', v_total_processed, ' ä¸ªç”¨æˆ·') AS progress;
        
        -- å¦‚æœæœ¬æ‰¹æ¬¡å¤„ç†æ•°é‡å°‘äºæ‰¹æ¬¡å¤§å°ï¼Œè¯´æ˜å¤„ç†å®Œäº†
        IF v_processed_count < v_batch_size THEN
            LEAVE process_loop;
        END IF;
        
    END LOOP process_loop;
    
    SELECT CONCAT('æ‰¹é‡å¤„ç†å®Œæˆï¼Œæ€»å…±å¤„ç† ', v_total_processed, ' ä¸ªç”¨æˆ·') AS result;
END;
```

### 5.2 WHILEå¾ªç¯è¯­å¥


**ğŸ”¸ WHILEå¾ªç¯çš„ç‰¹ç‚¹**
```
WHILEæ˜¯å‰ç½®æ¡ä»¶å¾ªç¯ï¼Œå…ˆæ£€æŸ¥æ¡ä»¶å†æ‰§è¡Œå¾ªç¯ä½“

æ‰§è¡Œæµç¨‹ï¼š
1. æ£€æŸ¥æ¡ä»¶
2. å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œæ‰§è¡Œå¾ªç¯ä½“
3. å›åˆ°ç¬¬1æ­¥ç»§ç»­æ£€æŸ¥
4. å¦‚æœæ¡ä»¶ä¸ºå‡ï¼Œé€€å‡ºå¾ªç¯

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ˜ç¡®çš„å¾ªç¯æ¡ä»¶
â€¢ å¯èƒ½ä¸€æ¬¡éƒ½ä¸æ‰§è¡Œçš„æƒ…å†µ
â€¢ æ¡ä»¶ç›¸å¯¹ç®€å•çš„å¾ªç¯
```

**ğŸ’» WHILEå¾ªç¯è¯­æ³•å’Œç¤ºä¾‹**
```sql
-- åŸºæœ¬è¯­æ³•
WHILE condition DO
    -- å¾ªç¯ä½“
END WHILE;

-- å®é™…ç¤ºä¾‹ï¼šè®¡ç®—ç”¨æˆ·ç§¯åˆ†
CREATE PROCEDURE calculate_monthly_points(IN user_id INT, IN target_month INT)
BEGIN
    DECLARE v_current_day INT DEFAULT 1;
    DECLARE v_days_in_month INT DEFAULT 31;
    DECLARE v_daily_points INT DEFAULT 0;
    DECLARE v_total_points INT DEFAULT 0;
    DECLARE v_login_bonus INT DEFAULT 10;
    DECLARE v_activity_bonus INT DEFAULT 0;
    
    -- è·å–ç›®æ ‡æœˆä»½çš„å¤©æ•°
    SET v_days_in_month = DAY(LAST_DAY(STR_TO_DATE(CONCAT('2024-', target_month, '-01'), '%Y-%m-%d')));
    
    -- é€æ—¥è®¡ç®—ç§¯åˆ†
    WHILE v_current_day <= v_days_in_month DO
        -- é‡ç½®æ¯æ—¥ç§¯åˆ†
        SET v_daily_points = 0;
        
        -- æ£€æŸ¥ç”¨æˆ·å½“å¤©æ˜¯å¦ç™»å½•
        SELECT COUNT(*) INTO @login_count
        FROM user_logins 
        WHERE user_id = user_id 
        AND DATE(login_time) = STR_TO_DATE(CONCAT('2024-', target_month, '-', v_current_day), '%Y-%m-%d');
        
        -- å¦‚æœæœ‰ç™»å½•ï¼Œç»™ç™»å½•å¥–åŠ±
        IF @login_count > 0 THEN
            SET v_daily_points = v_daily_points + v_login_bonus;
            
            -- æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–æ´»åŠ¨
            SELECT IFNULL(SUM(points), 0) INTO v_activity_bonus
            FROM user_activities 
            WHERE user_id = user_id 
            AND DATE(activity_date) = STR_TO_DATE(CONCAT('2024-', target_month, '-', v_current_day), '%Y-%m-%d');
            
            SET v_daily_points = v_daily_points + v_activity_bonus;
        END IF;
        
        -- ç´¯åŠ åˆ°æ€»ç§¯åˆ†
        SET v_total_points = v_total_points + v_daily_points;
        
        -- ç§»åŠ¨åˆ°ä¸‹ä¸€å¤©
        SET v_current_day = v_current_day + 1;
    END WHILE;
    
    -- æ›´æ–°ç”¨æˆ·ç§¯åˆ†
    UPDATE users 
    SET total_points = total_points + v_total_points,
        last_point_update = NOW()
    WHERE id = user_id;
    
    SELECT 
        user_id,
        target_month AS month,
        v_total_points AS earned_points,
        'ç§¯åˆ†è®¡ç®—å®Œæˆ' AS status;
END;
```

### 5.3 REPEATé‡å¤å¾ªç¯


**ğŸ”¸ REPEATå¾ªç¯çš„ç‰¹ç‚¹**
```
REPEATæ˜¯åç½®æ¡ä»¶å¾ªç¯ï¼Œå…ˆæ‰§è¡Œå¾ªç¯ä½“å†æ£€æŸ¥æ¡ä»¶

æ‰§è¡Œæµç¨‹ï¼š
1. æ‰§è¡Œå¾ªç¯ä½“
2. æ£€æŸ¥UNTILæ¡ä»¶
3. å¦‚æœæ¡ä»¶ä¸ºå‡ï¼Œå›åˆ°ç¬¬1æ­¥ç»§ç»­
4. å¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œé€€å‡ºå¾ªç¯

ç‰¹ç‚¹ï¼š
â€¢ è‡³å°‘æ‰§è¡Œä¸€æ¬¡ï¼šæ— è®ºæ¡ä»¶å¦‚ä½•ï¼Œå¾ªç¯ä½“è‡³å°‘æ‰§è¡Œä¸€æ¬¡
â€¢ æ¡ä»¶ä¸ºçœŸæ—¶é€€å‡ºï¼šä¸WHILEç›¸å
â€¢ é€‚åˆè‡³å°‘è¦åšä¸€æ¬¡çš„åœºæ™¯
```

**ğŸ’» REPEATè¯­æ³•å’Œç¤ºä¾‹**
```sql
-- åŸºæœ¬è¯­æ³•
REPEAT
    -- å¾ªç¯ä½“
UNTIL condition END REPEAT;

-- å®é™…ç¤ºä¾‹ï¼šç”Ÿæˆå”¯ä¸€ç¼–ç 
CREATE PROCEDURE generate_unique_code(OUT unique_code VARCHAR(20))
BEGIN
    DECLARE v_code VARCHAR(20);
    DECLARE v_exists INT DEFAULT 1;
    DECLARE v_attempt_count INT DEFAULT 0;
    DECLARE v_max_attempts INT DEFAULT 100;
    
    -- é‡å¤ç”Ÿæˆç›´åˆ°æ‰¾åˆ°å”¯ä¸€ç¼–ç 
    REPEAT
        -- ç”Ÿæˆéšæœºç¼–ç 
        SET v_code = CONCAT(
            'USR',
            YEAR(NOW()),
            LPAD(FLOOR(RAND() * 999999), 6, '0')
        );
        
        -- æ£€æŸ¥ç¼–ç æ˜¯å¦å·²å­˜åœ¨
        SELECT COUNT(*) INTO v_exists 
        FROM users 
        WHERE user_code = v_code;
        
        -- å¢åŠ å°è¯•æ¬¡æ•°
        SET v_attempt_count = v_attempt_count + 1;
        
        -- å¦‚æœå°è¯•æ¬¡æ•°è¿‡å¤šï¼Œå¼ºåˆ¶é€€å‡ºé¿å…æ­»å¾ªç¯
        IF v_attempt_count >= v_max_attempts THEN
            SET v_code = CONCAT('USR', NOW(), FLOOR(RAND() * 1000));
            SET v_exists = 0; -- å¼ºåˆ¶è®¤ä¸ºæ˜¯å”¯ä¸€çš„
        END IF;
        
    UNTIL v_exists = 0 END REPEAT;
    
    SET unique_code = v_code;
    
    SELECT 
        unique_code AS generated_code,
        v_attempt_count AS attempts_used,
        'ç¼–ç ç”ŸæˆæˆåŠŸ' AS status;
END;
```

### 5.4 UNTILç›´åˆ°æ¡ä»¶


**ğŸ”¸ UNTILçš„é€»è¾‘**
```
UNTILè¡¨ç¤º"ç›´åˆ°æ¡ä»¶ä¸ºçœŸæ‰åœæ­¢"

é€»è¾‘å¯¹æ¯”ï¼š
WHILE conditionï¼šæ¡ä»¶ä¸ºçœŸå°±ç»§ç»­
UNTIL conditionï¼šæ¡ä»¶ä¸ºçœŸå°±åœæ­¢

è®°å¿†æ–¹æ³•ï¼š
UNTIL = ç›´åˆ°...ä¸ºæ­¢
"é‡å¤æ‰§è¡Œï¼Œç›´åˆ°æ‰¾åˆ°ç»“æœä¸ºæ­¢"
```

### 5.5 LEAVEè·³å‡ºå¾ªç¯


**ğŸ”¸ LEAVEçš„ä½œç”¨**
```
LEAVEç”¨äºç«‹å³è·³å‡ºå¾ªç¯ï¼Œç±»ä¼¼äºå…¶ä»–è¯­è¨€çš„break

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ æå‰é€€å‡ºï¼šæ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æå‰ç»“æŸå¾ªç¯
â€¢ é”™è¯¯å¤„ç†ï¼šå‡ºç°é”™è¯¯æ—¶å®‰å…¨é€€å‡º
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¾åˆ°ç›®æ ‡åä¸å†ç»§ç»­å¾ªç¯
```

**ğŸ’» LEAVEä½¿ç”¨ç¤ºä¾‹**
```sql
-- æŸ¥æ‰¾æ»¡è¶³æ¡ä»¶çš„æ•°æ®
CREATE PROCEDURE find_target_user(IN min_score INT, OUT found_user_id INT)
BEGIN
    DECLARE v_user_id INT DEFAULT 0;
    DECLARE v_score INT DEFAULT 0;
    DECLARE v_checked_count INT DEFAULT 0;
    DECLARE v_max_check INT DEFAULT 1000;
    
    SET found_user_id = 0;
    
    search_loop: LOOP
        -- è·å–ä¸‹ä¸€ä¸ªç”¨æˆ·
        SELECT id, score INTO v_user_id, v_score
        FROM users 
        WHERE id > v_user_id AND status = 'active'
        ORDER BY id 
        LIMIT 1;
        
        -- å¦‚æœæ²¡æœ‰æ›´å¤šç”¨æˆ·ï¼Œé€€å‡ºå¾ªç¯
        IF v_user_id IS NULL THEN
            LEAVE search_loop;
        END IF;
        
        -- æ£€æŸ¥è®¡æ•°å™¨ï¼Œé¿å…æ£€æŸ¥è¿‡å¤š
        SET v_checked_count = v_checked_count + 1;
        IF v_checked_count > v_max_check THEN
            LEAVE search_loop;
        END IF;
        
        -- å¦‚æœæ‰¾åˆ°ç›®æ ‡ç”¨æˆ·ï¼Œè®¾ç½®ç»“æœå¹¶é€€å‡º
        IF v_score >= min_score THEN
            SET found_user_id = v_user_id;
            LEAVE search_loop;  -- æ‰¾åˆ°ç›®æ ‡ï¼Œç«‹å³é€€å‡º
        END IF;
        
    END LOOP search_loop;
    
    IF found_user_id > 0 THEN
        SELECT CONCAT('æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·ID: ', found_user_id) AS result;
    ELSE
        SELECT 'æœªæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·' AS result;
    END IF;
END;
```

### 5.6 ITERATEç»§ç»­å¾ªç¯


**ğŸ”¸ ITERATEçš„ä½œç”¨**
```
ITERATEç”¨äºè·³è¿‡æœ¬æ¬¡å¾ªç¯ï¼Œç›´æ¥è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œç±»ä¼¼äºå…¶ä»–è¯­è¨€çš„continue

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ è·³è¿‡æ— æ•ˆæ•°æ®ï¼šå½“å‰æ•°æ®ä¸ç¬¦åˆè¦æ±‚æ—¶è·³è¿‡
â€¢ æ¡ä»¶è¿‡æ»¤ï¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦å¤„ç†å½“å‰é¡¹
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…å¤„ç†ä¸å¿…è¦çš„æ•°æ®
```

**ğŸ’» ITERATEä½¿ç”¨ç¤ºä¾‹**
```sql
-- æ‰¹é‡å¤„ç†æ•°æ®ï¼Œè·³è¿‡æ— æ•ˆè®°å½•
CREATE PROCEDURE process_valid_orders()
BEGIN
    DECLARE v_order_id INT DEFAULT 0;
    DECLARE v_status VARCHAR(20);
    DECLARE v_amount DECIMAL(10,2);
    DECLARE v_processed_count INT DEFAULT 0;
    DECLARE v_skipped_count INT DEFAULT 0;
    DECLARE v_total_amount DECIMAL(10,2) DEFAULT 0;
    
    process_loop: LOOP
        -- è·å–ä¸‹ä¸€ä¸ªè®¢å•
        SELECT id, status, amount 
        INTO v_order_id, v_status, v_amount
        FROM orders 
        WHERE id > v_order_id AND process_flag = 0
        ORDER BY id 
        LIMIT 1;
        
        -- å¦‚æœæ²¡æœ‰æ›´å¤šè®¢å•ï¼Œé€€å‡ºå¾ªç¯
        IF v_order_id IS NULL THEN
            LEAVE process_loop;
        END IF;
        
        -- è·³è¿‡å·²å–æ¶ˆçš„è®¢å•
        IF v_status = 'cancelled' THEN
            SET v_skipped_count = v_skipped_count + 1;
            ITERATE process_loop;  -- è·³è¿‡æœ¬æ¬¡å¾ªç¯
        END IF;
        
        -- è·³è¿‡é‡‘é¢å¼‚å¸¸çš„è®¢å•
        IF v_amount <= 0 OR v_amount > 100000 THEN
            UPDATE orders 
            SET error_message = 'é‡‘é¢å¼‚å¸¸ï¼Œéœ€è¦äººå·¥å¤„ç†'
            WHERE id = v_order_id;
            
            SET v_skipped_count = v_skipped_count + 1;
            ITERATE process_loop;  -- è·³è¿‡æœ¬æ¬¡å¾ªç¯
        END IF;
        
        -- è·³è¿‡çŠ¶æ€ä¸æ­£ç¡®çš„è®¢å•
        IF v_status NOT IN ('pending', 'confirmed') THEN
            SET v_skipped_count = v_skipped_count + 1;
            ITERATE process_loop;  -- è·³è¿‡æœ¬æ¬¡å¾ªç¯
        END IF;
        
        -- å¤„ç†æœ‰æ•ˆè®¢å•
        UPDATE orders 
        SET status = 'processing', 
            process_flag = 1,
            process_time = NOW()
        WHERE id = v_order_id;
        
        -- ç´¯åŠ ç»Ÿè®¡
        SET v_processed_count = v_processed_count + 1;
        SET v_total_amount = v_total_amount + v_amount;
        
    END LOOP process_loop;
    
    -- è¾“å‡ºå¤„ç†ç»“æœ
    SELECT 
        v_processed_count AS processed_orders,
        v_skipped_count AS skipped_orders,
        v_total_amount AS total_amount,
        'æ‰¹é‡å¤„ç†å®Œæˆ' AS status;
END;
```

---

## 6. ğŸ¯ æµç¨‹è·³è½¬è¯­å¥


### 6.1 LABELæ ‡ç­¾


**ğŸ”¸ LABELçš„ä½œç”¨**
```
LABELå°±åƒä»£ç ä¸­çš„"ä¹¦ç­¾"ï¼Œç»™å¾ªç¯æˆ–ä»£ç å—èµ·ä¸ªåå­—

ä½œç”¨ï¼š
â€¢ æ ‡è¯†å¾ªç¯ï¼šç»™LOOPã€WHILEã€REPEATèµ·åå­—
â€¢ ç²¾ç¡®è·³è½¬ï¼šLEAVEå’ŒITERATEå¯ä»¥æŒ‡å®šè·³è½¬åˆ°å“ªä¸ªæ ‡ç­¾
â€¢ åµŒå¥—æ§åˆ¶ï¼šåœ¨å¤šå±‚åµŒå¥—æ—¶æ˜ç¡®æŒ‡å®šæ“ä½œå¯¹è±¡

è¯­æ³•ï¼š
label_name: LOOP ... END LOOP label_name;
```

**ğŸ’» LABELä½¿ç”¨ç¤ºä¾‹**
```sql
-- å¤šå±‚åµŒå¥—å¾ªç¯çš„æ ‡ç­¾ä½¿ç”¨
CREATE PROCEDURE process_user_orders_by_region()
BEGIN
    DECLARE v_region_id INT DEFAULT 0;
    DECLARE v_user_id INT DEFAULT 0;
    DECLARE v_order_id INT DEFAULT 0;
    DECLARE v_processed_regions INT DEFAULT 0;
    DECLARE v_processed_users INT DEFAULT 0;
    DECLARE v_processed_orders INT DEFAULT 0;
    
    -- å¤–å±‚å¾ªç¯ï¼šå¤„ç†æ‰€æœ‰åœ°åŒº
    region_loop: LOOP
        -- è·å–ä¸‹ä¸€ä¸ªåœ°åŒº
        SELECT id INTO v_region_id 
        FROM regions 
        WHERE id > v_region_id AND status = 'active'
        ORDER BY id 
        LIMIT 1;
        
        IF v_region_id IS NULL THEN
            LEAVE region_loop;  -- é€€å‡ºåœ°åŒºå¾ªç¯
        END IF;
        
        SET v_user_id = 0;  -- é‡ç½®ç”¨æˆ·ID
        
        -- ä¸­å±‚å¾ªç¯ï¼šå¤„ç†è¯¥åœ°åŒºçš„æ‰€æœ‰ç”¨æˆ·
        user_loop: LOOP
            -- è·å–è¯¥åœ°åŒºçš„ä¸‹ä¸€ä¸ªç”¨æˆ·
            SELECT id INTO v_user_id 
            FROM users 
            WHERE id > v_user_id 
            AND region_id = v_region_id 
            AND status = 'active'
            ORDER BY id 
            LIMIT 1;
            
            IF v_user_id IS NULL THEN
                LEAVE user_loop;  -- é€€å‡ºç”¨æˆ·å¾ªç¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªåœ°åŒº
            END IF;
            
            SET v_order_id = 0;  -- é‡ç½®è®¢å•ID
            
            -- å†…å±‚å¾ªç¯ï¼šå¤„ç†è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¢å•
            order_loop: LOOP
                -- è·å–è¯¥ç”¨æˆ·çš„ä¸‹ä¸€ä¸ªå¾…å¤„ç†è®¢å•
                SELECT id INTO v_order_id 
                FROM orders 
                WHERE id > v_order_id 
                AND user_id = v_user_id 
                AND status = 'pending'
                ORDER BY id 
                LIMIT 1;
                
                IF v_order_id IS NULL THEN
                    LEAVE order_loop;  -- é€€å‡ºè®¢å•å¾ªç¯ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªç”¨æˆ·
                END IF;
                
                -- æ£€æŸ¥è®¢å•æ˜¯å¦æœ‰é—®é¢˜
                IF EXISTS(SELECT 1 FROM order_issues WHERE order_id = v_order_id) THEN
                    -- å¦‚æœè®¢å•æœ‰é—®é¢˜ï¼Œè·³è¿‡ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªè®¢å•
                    ITERATE order_loop;
                END IF;
                
                -- å¤„ç†è®¢å•
                UPDATE orders 
                SET status = 'processed', process_time = NOW()
                WHERE id = v_order_id;
                
                SET v_processed_orders = v_processed_orders + 1;
                
            END LOOP order_loop;
            
            SET v_processed_users = v_processed_users + 1;
            
        END LOOP user_loop;
        
        SET v_processed_regions = v_processed_regions + 1;
        
    END LOOP region_loop;
    
    -- è¾“å‡ºå¤„ç†ç»Ÿè®¡
    SELECT 
        v_processed_regions AS processed_regions,
        v_processed_users AS processed_users,
        v_processed_orders AS processed_orders,
        'å¤šå±‚å¤„ç†å®Œæˆ' AS status;
END;
```

### 6.2 GOTOè·³è½¬è¯­å¥


**ğŸ”¸ GOTOçš„è¯´æ˜**
```
é‡è¦æé†’ï¼šMySQLä¸æ”¯æŒGOTOè¯­å¥ï¼

GOTOåœ¨å…¶ä»–æ•°æ®åº“ä¸­çš„ä½œç”¨ï¼š
â€¢ æ— æ¡ä»¶è·³è½¬åˆ°æŒ‡å®šæ ‡ç­¾ä½ç½®
â€¢ å¯ä»¥å®ç°å¤æ‚çš„æµç¨‹æ§åˆ¶

ä¸ºä»€ä¹ˆMySQLä¸æ”¯æŒï¼š
â€¢ é™ä½ä»£ç å¯è¯»æ€§
â€¢ å®¹æ˜“é€ æˆé€»è¾‘æ··ä¹±
â€¢ ç°ä»£ç¼–ç¨‹æ›´æ¨å´‡ç»“æ„åŒ–æ§åˆ¶

æ›¿ä»£æ–¹æ¡ˆï¼š
â€¢ ä½¿ç”¨IF-ELSEå®ç°æ¡ä»¶è·³è½¬
â€¢ ä½¿ç”¨å¾ªç¯+LEAVEå®ç°å¾ªç¯æ§åˆ¶
â€¢ ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹è°ƒç”¨å®ç°æ¨¡å—åŒ–
```

**ğŸ’» GOTOçš„æ›¿ä»£å®ç°**
```sql
-- ä¼ ç»ŸGOTOçš„éœ€æ±‚åœºæ™¯
-- GOTO error_handler; (MySQLä¸æ”¯æŒ)

-- MySQLçš„æ›¿ä»£å®ç°æ–¹å¼
CREATE PROCEDURE safe_process_data(IN data_id INT)
BEGIN
    DECLARE v_error_occurred BOOLEAN DEFAULT FALSE;
    DECLARE v_error_message VARCHAR(500) DEFAULT '';
    DECLARE v_step INT DEFAULT 1;
    
    -- ä½¿ç”¨æ ‡å¿—å˜é‡æ§åˆ¶æµç¨‹ï¼Œæ›¿ä»£GOTO
    process_block: BEGIN
        -- ç¬¬ä¸€æ­¥ï¼šéªŒè¯æ•°æ®
        IF NOT EXISTS(SELECT 1 FROM data_table WHERE id = data_id) THEN
            SET v_error_occurred = TRUE;
            SET v_error_message = 'æ•°æ®ä¸å­˜åœ¨';
            LEAVE process_block;  -- ç­‰æ•ˆäºGOTO error_handler
        END IF;
        SET v_step = 2;
        
        -- ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æƒé™
        IF NOT has_permission(data_id) THEN
            SET v_error_occurred = TRUE;
            SET v_error_message = 'æƒé™ä¸è¶³';
            LEAVE process_block;  -- ç­‰æ•ˆäºGOTO error_handler
        END IF;
        SET v_step = 3;
        
        -- ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œä¸šåŠ¡é€»è¾‘
        IF NOT execute_business_logic(data_id) THEN
            SET v_error_occurred = TRUE;
            SET v_error_message = 'ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå¤±è´¥';
            LEAVE process_block;  -- ç­‰æ•ˆäºGOTO error_handler
        END IF;
        SET v_step = 4;
        
        -- æ­£å¸¸å®Œæˆ
        SELECT 'å¤„ç†æˆåŠŸ' AS result;
        
    END process_block;
    
    -- é”™è¯¯å¤„ç†é€»è¾‘ (ç­‰æ•ˆäºerror_handleræ ‡ç­¾)
    IF v_error_occurred THEN
        SELECT 
            CONCAT('å¤„ç†å¤±è´¥ï¼Œé”™è¯¯å‘ç”Ÿåœ¨æ­¥éª¤', v_step) AS error_info,
            v_error_message AS error_detail;
            
        -- è®°å½•é”™è¯¯æ—¥å¿—
        INSERT INTO error_logs (data_id, step, error_message, error_time)
        VALUES (data_id, v_step, v_error_message, NOW());
    END IF;
END;
```

### 6.3 CALLè°ƒç”¨è¿‡ç¨‹


**ğŸ”¸ CALLçš„ä½œç”¨**
```
CALLç”¨äºè°ƒç”¨å¦ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ï¼Œå®ç°ä»£ç æ¨¡å—åŒ–å’Œå¤ç”¨

ä¼˜åŠ¿ï¼š
â€¢ ä»£ç å¤ç”¨ï¼šé¿å…é‡å¤å†™ç›¸åŒé€»è¾‘
â€¢ æ¨¡å—åŒ–ï¼šå°†å¤æ‚åŠŸèƒ½åˆ†è§£æˆå°æ¨¡å—
â€¢ ç»´æŠ¤æ€§ï¼šä¿®æ”¹åŠŸèƒ½åªéœ€æ”¹ä¸€ä¸ªåœ°æ–¹
â€¢ å¯è¯»æ€§ï¼šä¸»æµç¨‹æ›´æ¸…æ™°æ˜“æ‡‚
```

**ğŸ’» CALLè°ƒç”¨ç¤ºä¾‹**
```sql
-- åˆ›å»ºä¸€äº›åŸºç¡€çš„å·¥å…·è¿‡ç¨‹
-- 1. è®°å½•æ—¥å¿—çš„è¿‡ç¨‹
CREATE PROCEDURE log_operation(IN operation_type VARCHAR(50), IN details VARCHAR(500))
BEGIN
    INSERT INTO operation_logs (operation_type, details, log_time)
    VALUES (operation_type, details, NOW());
END;

-- 2. å‘é€é€šçŸ¥çš„è¿‡ç¨‹
CREATE PROCEDURE send_notification(IN user_id INT, IN message VARCHAR(500))
BEGIN
    INSERT INTO notifications (user_id, message, send_time, status)
    VALUES (user_id, message, NOW(), 'pending');
END;

-- 3. è®¡ç®—ç”¨æˆ·ç§¯åˆ†çš„è¿‡ç¨‹
CREATE PROCEDURE calculate_user_points(IN user_id INT, IN action_type VARCHAR(50), OUT points INT)
BEGIN
    CASE action_type
        WHEN 'login' THEN SET points = 10;
        WHEN 'purchase' THEN SET points = 50;
        WHEN 'review' THEN SET points = 20;
        WHEN 'referral' THEN SET points = 100;
        ELSE SET points = 0;
    END CASE;
    
    -- æ›´æ–°ç”¨æˆ·æ€»ç§¯åˆ†
    UPDATE users 
    SET total_points = total_points + points,
        last_points_update = NOW()
    WHERE id = user_id;
END;

-- ä¸»ä¸šåŠ¡æµç¨‹ï¼Œè°ƒç”¨å„ä¸ªå­è¿‡ç¨‹
CREATE PROCEDURE process_user_purchase(IN user_id INT, IN product_id INT, IN amount DECIMAL(10,2))
BEGIN
    DECLARE v_points INT DEFAULT 0;
    DECLARE v_error_occurred BOOLEAN DEFAULT FALSE;
    DECLARE v_purchase_id INT DEFAULT 0;
    
    -- å¼€å§‹äº‹åŠ¡
    START TRANSACTION;
    
    BEGIN
        -- 1. è®°å½•è´­ä¹°æ“ä½œ
        CALL log_operation('purchase_start', CONCAT('ç”¨æˆ·', user_id, 'è´­ä¹°å•†å“', product_id));
        
        -- 2. åˆ›å»ºè´­ä¹°è®°å½•
        INSERT INTO purchases (user_id, product_id, amount, purchase_time)
        VALUES (user_id, product_id, amount, NOW());
        SET v_purchase_id = LAST_INSERT_ID();
        
        -- 3. è®¡ç®—å¹¶å¢åŠ ç§¯åˆ†
        CALL calculate_user_points(user_id, 'purchase', v_points);
        
        -- 4. å‘é€è´­ä¹°æˆåŠŸé€šçŸ¥
        CALL send_notification(
            user_id, 
            CONCAT('è´­ä¹°æˆåŠŸï¼æ‚¨è·å¾—äº†', v_points, 'ç§¯åˆ†')
        );
        
        -- 5. è®°å½•å®Œæˆæ—¥å¿—
        CALL log_operation(
            'purchase_complete', 
            CONCAT('ç”¨æˆ·', user_id, 'è´­ä¹°å®Œæˆï¼Œè·å¾—ç§¯åˆ†', v_points)
        );
        
        -- æäº¤äº‹åŠ¡
        COMMIT;
        
        SELECT 
            v_purchase_id AS purchase_id,
            v_points AS earned_points,
            'è´­ä¹°å¤„ç†æˆåŠŸ' AS status;
            
    END;
    
EXCEPTION
    WHEN OTHERS THEN
        -- å›æ»šäº‹åŠ¡
        ROLLBACK;
        
        -- è®°å½•é”™è¯¯
        CALL log_operation('purchase_error', CONCAT('ç”¨æˆ·', user_id, 'è´­ä¹°å¤±è´¥: ', SQLERRM));
        
        SELECT 'è´­ä¹°å¤„ç†å¤±è´¥' AS status, SQLERRM AS error_message;
END;
```

### 6.4 RETURNè¿”å›å€¼


**ğŸ”¸ RETURNçš„ä½œç”¨**
```
RETURNç”¨äºä»å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°ä¸­è¿”å›å€¼å¹¶é€€å‡º

åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼š
â€¢ åªèƒ½è¿”å›æ•´æ•°çŠ¶æ€ç 
â€¢ è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸæˆ–å¤±è´¥
â€¢ 0é€šå¸¸è¡¨ç¤ºæˆåŠŸï¼Œé0è¡¨ç¤ºå¤±è´¥

åœ¨å‡½æ•°ä¸­ï¼š
â€¢ å¿…é¡»è¿”å›æŒ‡å®šç±»å‹çš„å€¼
â€¢ å‡½æ•°çš„æ ¸å¿ƒå°±æ˜¯è®¡ç®—å¹¶è¿”å›ç»“æœ
```

**ğŸ’» RETURNä½¿ç”¨ç¤ºä¾‹**
```sql
-- å­˜å‚¨è¿‡ç¨‹ä¸­çš„RETURNï¼ˆè¿”å›çŠ¶æ€ç ï¼‰
CREATE PROCEDURE validate_user_data(IN user_id INT)
BEGIN
    DECLARE v_user_count INT DEFAULT 0;
    DECLARE v_user_status VARCHAR(20);
    
    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    SELECT COUNT(*) INTO v_user_count FROM users WHERE id = user_id;
    IF v_user_count = 0 THEN
        SELECT 'ç”¨æˆ·ä¸å­˜åœ¨' AS error_message;
        RETURN 1001;  -- è¿”å›é”™è¯¯ç 1001
    END IF;
    
    -- æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    SELECT status INTO v_user_status FROM users WHERE id = user_id;
    IF v_user_status = 'blocked' THEN
        SELECT 'ç”¨æˆ·å·²è¢«é˜»æ­¢' AS error_message;
        RETURN 1002;  -- è¿”å›é”™è¯¯ç 1002
    END IF;
    
    IF v_user_status = 'inactive' THEN
        SELECT 'ç”¨æˆ·æœªæ¿€æ´»' AS error_message;
        RETURN 1003;  -- è¿”å›é”™è¯¯ç 1003
    END IF;
    
    -- éªŒè¯é€šè¿‡
    SELECT 'ç”¨æˆ·éªŒè¯é€šè¿‡' AS success_message;
    RETURN 0;  -- è¿”å›æˆåŠŸç 0
END;

-- å‡½æ•°ä¸­çš„RETURNï¼ˆè¿”å›è®¡ç®—ç»“æœï¼‰
CREATE FUNCTION calculate_discount_rate(user_level VARCHAR(20), purchase_amount DECIMAL(10,2))
RETURNS DECIMAL(5,4)
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE discount_rate DECIMAL(5,4) DEFAULT 0.0000;
    
    -- æ ¹æ®ç”¨æˆ·ç­‰çº§ç¡®å®šåŸºç¡€æŠ˜æ‰£
    CASE user_level
        WHEN 'Diamond' THEN SET discount_rate = 0.2000;  -- 20%æŠ˜æ‰£
        WHEN 'Platinum' THEN SET discount_rate = 0.1500; -- 15%æŠ˜æ‰£
        WHEN 'Gold' THEN SET discount_rate = 0.1000;     -- 10%æŠ˜æ‰£
        WHEN 'Silver' THEN SET discount_rate = 0.0500;   -- 5%æŠ˜æ‰£
        ELSE SET discount_rate = 0.0000;                 -- æ— æŠ˜æ‰£
    END CASE;
    
    -- æ ¹æ®è´­ä¹°é‡‘é¢è°ƒæ•´æŠ˜æ‰£
    IF purchase_amount >= 10000 THEN
        SET discount_rate = discount_rate + 0.0500;  -- é¢å¤–5%æŠ˜æ‰£
    ELSEIF purchase_amount >= 5000 THEN
        SET discount_rate = discount_rate + 0.0300;  -- é¢å¤–3%æŠ˜æ‰£
    ELSEIF purchase_amount >= 1000 THEN
        SET discount_rate = discount_rate + 0.0100;  -- é¢å¤–1%æŠ˜æ‰£
    END IF;
    
    -- æŠ˜æ‰£ç‡ä¸èƒ½è¶…è¿‡30%
    IF discount_rate > 0.3000 THEN
        SET discount_rate = 0.3000;
    END IF;
    
    RETURN discount_rate;
END;

-- ä½¿ç”¨è¿”å›å€¼çš„ç¤ºä¾‹
CREATE PROCEDURE process_order_with_discount(IN user_id INT, IN order_amount DECIMAL(10,2))
BEGIN
    DECLARE v_validation_result INT DEFAULT 0;
    DECLARE v_user_level VARCHAR(20);
    DECLARE v_discount_rate DECIMAL(5,4);
    DECLARE v_final_amount DECIMAL(10,2);
    
    -- 1. å…ˆéªŒè¯ç”¨æˆ·
    CALL validate_user_data(user_id);
    -- æ³¨æ„ï¼šåœ¨MySQLä¸­ï¼Œæ— æ³•ç›´æ¥è·å–å­˜å‚¨è¿‡ç¨‹çš„è¿”å›å€¼
    -- éœ€è¦é€šè¿‡OUTå‚æ•°æˆ–è€…å…¶ä»–æ–¹å¼ä¼ é€’çŠ¶æ€
    
    -- 2. è·å–ç”¨æˆ·ç­‰çº§
    SELECT user_level INTO v_user_level FROM users WHERE id = user_id;
    
    -- 3. è®¡ç®—æŠ˜æ‰£ç‡ï¼ˆä½¿ç”¨å‡½æ•°ï¼‰
    SET v_discount_rate = calculate_discount_rate(v_user_level, order_amount);
    
    -- 4. è®¡ç®—æœ€ç»ˆé‡‘é¢
    SET v_final_amount = order_amount * (1 - v_discount_rate);
    
    -- 5. è¿”å›ç»“æœ
    SELECT 
        order_amount AS original_amount,
        v_discount_rate AS discount_rate,
        v_final_amount AS final_amount,
        CONCAT(ROUND(v_discount_rate * 100, 2), '%') AS discount_percentage;
END;
```

---

## 7. ğŸš¨ å¼‚å¸¸å¤„ç†è¯­å¥


### 7.1 SIGNALæŠ›å‡ºå¼‚å¸¸


**ğŸ”¸ SIGNALçš„ä½œç”¨**
```
SIGNALç”¨äºä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå‘Šè¯‰ç³»ç»Ÿ"è¿™é‡Œå‡ºé”™äº†"

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ä¸šåŠ¡é€»è¾‘éªŒè¯å¤±è´¥æ—¶
â€¢ æ£€æµ‹åˆ°ä¸åˆç†çš„æ•°æ®æ—¶  
â€¢ éœ€è¦ä¸­æ–­æ‰§è¡Œå¹¶æŠ¥å‘Šé”™è¯¯æ—¶

å°±åƒç¨‹åºä¸­çš„throwå¼‚å¸¸ï¼Œè®©é”™è¯¯èƒ½è¢«ä¸Šå±‚æ•è·å¤„ç†
```

**ğŸ’» SIGNALè¯­æ³•å’Œä½¿ç”¨**
```sql
-- åŸºæœ¬è¯­æ³•
SIGNAL sqlstate_value [SET MESSAGE_TEXT = 'error_message'];

-- é¢„å®šä¹‰çš„SQLSTATEå€¼
SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯';

-- å®é™…ç¤ºä¾‹ï¼šç”¨æˆ·æ³¨å†ŒéªŒè¯
CREATE PROCEDURE register_user(
    IN p_username VARCHAR(50),
    IN p_email VARCHAR(100), 
    IN p_password VARCHAR(100),
    IN p_age INT
)
BEGIN
    DECLARE v_existing_count INT DEFAULT 0;
    
    -- 1. éªŒè¯ç”¨æˆ·åé•¿åº¦
    IF LENGTH(p_username) < 3 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº3ä¸ªå­—ç¬¦';
    END IF;
    
    IF LENGTH(p_username) > 50 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦';
    END IF;
    
    -- 2. éªŒè¯é‚®ç®±æ ¼å¼ï¼ˆç®€å•éªŒè¯ï¼‰
    IF p_email NOT LIKE '%@%.%' THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
    END IF;
    
    -- 3. éªŒè¯å¹´é¾„
    IF p_age < 16 OR p_age > 120 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'å¹´é¾„å¿…é¡»åœ¨16-120å²ä¹‹é—´';
    END IF;
    
    -- 4. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    SELECT COUNT(*) INTO v_existing_count 
    FROM users 
    WHERE username = p_username;
    
    IF v_existing_count > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'ç”¨æˆ·åå·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å';
    END IF;
    
    -- 5. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    SELECT COUNT(*) INTO v_existing_count 
    FROM users 
    WHERE email = p_email;
    
    IF v_existing_count > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ä½¿ç”¨å…¶ä»–é‚®ç®±';
    END IF;
    
    -- 6. éªŒè¯å¯†ç å¼ºåº¦
    IF LENGTH(p_password) < 8 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½';
    END IF;
    
    -- æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œåˆ›å»ºç”¨æˆ·
    INSERT INTO users (username, email, password, age, create_time, status)
    VALUES (p_username, p_email, MD5(p_password), p_age, NOW(), 'active');
    
    SELECT 'ç”¨æˆ·æ³¨å†ŒæˆåŠŸ' AS result, LAST_INSERT_ID() AS user_id;
END;
```

### 7.2 RESIGNALé‡æ–°æŠ›å‡º


**ğŸ”¸ RESIGNALçš„ä½œç”¨**
```
RESIGNALç”¨äºåœ¨å¼‚å¸¸å¤„ç†å™¨ä¸­é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥ä¿®æ”¹é”™è¯¯ä¿¡æ¯

ä½¿ç”¨åœºæ™¯ï¼š
â€¢ æ•è·å¼‚å¸¸åæ·»åŠ æ›´å¤šä¿¡æ¯å†æŠ›å‡º
â€¢ å°†ç³»ç»Ÿå¼‚å¸¸è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
â€¢ åœ¨å¼‚å¸¸ä¼ æ’­è¿‡ç¨‹ä¸­è®°å½•æ—¥å¿—

å°±åƒæ¥åŠ›èµ›ä¸€æ ·ï¼Œæ¥ä½å¼‚å¸¸ååŠ å·¥å†ä¼ é€’
```

**ğŸ’» RESIGNALä½¿ç”¨ç¤ºä¾‹**
```sql
-- å¸¦é”™è¯¯å¤„ç†çš„æ•°æ®å¤„ç†è¿‡ç¨‹
CREATE PROCEDURE safe_update_user_balance(IN user_id INT, IN amount DECIMAL(10,2))
BEGIN
    DECLARE v_current_balance DECIMAL(10,2) DEFAULT 0;
    DECLARE v_new_balance DECIMAL(10,2);
    DECLARE v_operation_type VARCHAR(20);
    
    -- å¼‚å¸¸å¤„ç†å™¨
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- è®°å½•é”™è¯¯æ—¥å¿—
        INSERT INTO error_logs (operation, user_id, error_message, error_time)
        VALUES ('update_balance', user_id, 
                CONCAT('ä½™é¢æ›´æ–°å¤±è´¥: ', MESSAGE_TEXT), NOW());
        
        -- é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œæ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯
        RESIGNAL SET 
            MESSAGE_TEXT = CONCAT('ç”¨æˆ·', user_id, 'ä½™é¢æ›´æ–°å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    END;
    
    -- å¼€å§‹äº‹åŠ¡
    START TRANSACTION;
    
    -- è·å–å½“å‰ä½™é¢
    SELECT balance INTO v_current_balance 
    FROM user_accounts 
    WHERE user_id = user_id 
    FOR UPDATE;  -- é”å®šè¡Œé˜²æ­¢å¹¶å‘é—®é¢˜
    
    -- è®¡ç®—æ–°ä½™é¢
    SET v_new_balance = v_current_balance + amount;
    SET v_operation_type = IF(amount > 0, 'å……å€¼', 'æ‰£è´¹');
    
    -- éªŒè¯ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
    IF v_new_balance < 0 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = CONCAT('ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢: ', v_current_balance, 
                                 ', æ‰£è´¹é‡‘é¢: ', ABS(amount));
    END IF;
    
    -- æ›´æ–°ä½™é¢
    UPDATE user_accounts 
    SET balance = v_new_balance,
        last_update_time = NOW()
    WHERE user_id = user_id;
    
    -- è®°å½•è´¦æˆ·å˜åŠ¨
    INSERT INTO account_transactions (user_id, operation_type, amount, balance_before, balance_after, transaction_time)
    VALUES (user_id, v_operation_type, amount, v_current_balance, v_new_balance, NOW());
    
    COMMIT;
    
    SELECT 
        v_operation_type AS operation,
        amount AS change_amount,
        v_current_balance AS old_balance,
        v_new_balance AS new_balance,
        'ä½™é¢æ›´æ–°æˆåŠŸ' AS status;
END;
```

### 7.3 GETè·å–è¯Šæ–­ä¿¡æ¯


**ğŸ”¸ GET DIAGNOSTICSçš„ä½œç”¨**
```
GET DIAGNOSTICSç”¨äºè·å–æœ€è¿‘æ‰§è¡Œçš„SQLè¯­å¥çš„è¯¦ç»†ä¿¡æ¯

å¯ä»¥è·å–çš„ä¿¡æ¯ï¼š
â€¢ é”™è¯¯ç ï¼ˆSQLCODEï¼‰
â€¢ é”™è¯¯çŠ¶æ€ï¼ˆSQLSTATEï¼‰  
â€¢ é”™è¯¯æ¶ˆæ¯ï¼ˆMESSAGE_TEXTï¼‰
â€¢ å½±å“çš„è¡Œæ•°ï¼ˆROW_COUNTï¼‰
â€¢ å…¶ä»–è¯Šæ–­ä¿¡æ¯

ç”¨é€”ï¼š
â€¢ é”™è¯¯åˆ†æå’Œè°ƒè¯•
â€¢ è¯¦ç»†çš„å¼‚å¸¸å¤„ç†
â€¢ æ“ä½œç»“æœéªŒè¯
```

**ğŸ’» GET DIAGNOSTICSè¯­æ³•å’Œç¤ºä¾‹**
```sql
-- åŸºæœ¬è¯­æ³•
GET DIAGNOSTICS variable = diagnostic_item;

-- è·å–å¤šä¸ªè¯Šæ–­ä¿¡æ¯
GET DIAGNOSTICS 
    var1 = item1,
    var2 = item2,
    var3 = item3;

-- å®é™…ç¤ºä¾‹ï¼šè¯¦ç»†çš„é”™è¯¯è¯Šæ–­
CREATE PROCEDURE diagnose_data_operation(IN table_name VARCHAR(64), IN operation VARCHAR(20))
BEGIN
    DECLARE v_row_count INT DEFAULT 0;
    DECLARE v_sql_state VARCHAR(5) DEFAULT '';
    DECLARE v_error_code INT DEFAULT 0;
    DECLARE v_error_message TEXT DEFAULT '';
    DECLARE v_sql_statement TEXT DEFAULT '';
    
    -- æ„å»ºåŠ¨æ€SQL
    SET v_sql_statement = CONCAT('SELECT COUNT(*) FROM ', table_name, ' WHERE status = "active"');
    
    -- æ‰§è¡ŒåŠ¨æ€SQLå¹¶è¯Šæ–­
    SET @sql = v_sql_statement;
    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    -- è·å–æ‰§è¡Œç»“æœçš„è¯Šæ–­ä¿¡æ¯
    GET DIAGNOSTICS 
        v_row_count = ROW_COUNT,
        v_sql_state = RETURNED_SQLSTATE;
    
    -- å¦‚æœæœ‰é”™è¯¯ï¼Œè·å–é”™è¯¯ä¿¡æ¯
    IF v_sql_state != '00000' THEN
        GET DIAGNOSTICS CONDITION 1
            v_error_code = MYSQL_ERRNO,
            v_error_message = MESSAGE_TEXT;
            
        -- è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
        INSERT INTO diagnostic_logs (
            operation_type, 
            table_name, 
            sql_statement,
            sql_state,
            error_code,
            error_message,
            log_time
        ) VALUES (
            operation, 
            table_name, 
            v_sql_statement,
            v_sql_state,
            v_error_code,
            v_error_message,
            NOW()
        );
        
        SELECT 
            'æ“ä½œå¤±è´¥' AS status,
            v_sql_state AS sql_state,
            v_error_code AS error_code,
            v_error_message AS error_message;
    ELSE
        -- æ“ä½œæˆåŠŸï¼Œè®°å½•æˆåŠŸä¿¡æ¯
        INSERT INTO operation_logs (
            operation_type,
            table_name,
            affected_rows,
            log_time
        ) VALUES (
            operation,
            table_name,
            v_row_count,
            NOW()
        );
        
        SELECT 
            'æ“ä½œæˆåŠŸ' AS status,
            v_row_count AS processed_rows,
            v_sql_state AS sql_state;
    END IF;
END;
```

### 7.4 DIAGNOSTICSè¯Šæ–­ä¿¡æ¯


**ğŸ”¸ è¯Šæ–­ä¿¡æ¯çš„ç±»å‹**
```
MySQLæä¾›çš„ä¸»è¦è¯Šæ–­ä¿¡æ¯ï¼š

è¯­å¥çº§åˆ«ä¿¡æ¯ï¼š
â€¢ NUMBERï¼šæ¡ä»¶æ•°é‡
â€¢ ROW_COUNTï¼šå½±å“çš„è¡Œæ•°
â€¢ RETURNED_SQLSTATEï¼šè¿”å›çš„SQLçŠ¶æ€

æ¡ä»¶çº§åˆ«ä¿¡æ¯ï¼š
â€¢ CLASS_ORIGINï¼šé”™è¯¯ç±»åˆ«æ¥æº
â€¢ SUBCLASS_ORIGINï¼šé”™è¯¯å­ç±»åˆ«æ¥æº  
â€¢ CONSTRAINT_CATALOGï¼šçº¦æŸç›®å½•
â€¢ CONSTRAINT_SCHEMAï¼šçº¦æŸæ¨¡å¼
â€¢ CONSTRAINT_NAMEï¼šçº¦æŸåç§°
â€¢ CATALOG_NAMEï¼šç›®å½•åç§°
â€¢ SCHEMA_NAMEï¼šæ¨¡å¼åç§°
â€¢ TABLE_NAMEï¼šè¡¨åç§°
â€¢ COLUMN_NAMEï¼šåˆ—åç§°
â€¢ CURSOR_NAMEï¼šæ¸¸æ ‡åç§°
â€¢ MESSAGE_TEXTï¼šé”™è¯¯æ¶ˆæ¯æ–‡æœ¬
â€¢ MYSQL_ERRNOï¼šMySQLé”™è¯¯å·
```

**ğŸ’» å®Œæ•´çš„è¯Šæ–­ä¿¡æ¯æ”¶é›†ç¤ºä¾‹**
```sql
CREATE PROCEDURE comprehensive_error_handler()
BEGIN
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_row_count INT DEFAULT 0;
    DECLARE v_sql_state VARCHAR(5) DEFAULT '';
    DECLARE v_error_code INT DEFAULT 0;
    DECLARE v_error_message TEXT DEFAULT '';
    DECLARE v_table_name VARCHAR(64) DEFAULT '';
    DECLARE v_column_name VARCHAR(64) DEFAULT '';
    
    -- å¼‚å¸¸å¤„ç†å™¨ï¼Œæ”¶é›†å®Œæ•´è¯Šæ–­ä¿¡æ¯
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- è·å–è¯­å¥çº§åˆ«è¯Šæ–­ä¿¡æ¯
        GET DIAGNOSTICS 
            v_error_count = NUMBER,
            v_row_count = ROW_COUNT;
        
        -- å¦‚æœæœ‰é”™è¯¯æ¡ä»¶ï¼Œè·å–ç¬¬ä¸€ä¸ªé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯
        IF v_error_count > 0 THEN
            GET DIAGNOSTICS CONDITION 1
                v_sql_state = RETURNED_SQLSTATE,
                v_error_code = MYSQL_ERRNO,
                v_error_message = MESSAGE_TEXT,
                v_table_name = TABLE_NAME,
                v_column_name = COLUMN_NAME;
        END IF;
        
        -- åˆ›å»ºè¯¦ç»†çš„é”™è¯¯æŠ¥å‘Š
        INSERT INTO comprehensive_error_logs (
            error_count,
            affected_rows,
            sql_state,
            mysql_errno,
            error_message,
            table_name,
            column_name,
            procedure_name,
            error_time
        ) VALUES (
            v_error_count,
            v_row_count,
            v_sql_state,
            v_error_code,
            v_error_message,
            v_table_name,
            v_column_name,
            'comprehensive_error_handler',
            NOW()
        );
        
        -- è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
        SELECT 
            v_error_count AS error_count,
            v_sql_state AS sql_state,
            v_error_code AS mysql_errno,
            v_error_message AS error_message,
            v_table_name AS affected_table,
            v_column_name AS affected_column,
            'è¯¦ç»†é”™è¯¯ä¿¡æ¯å·²è®°å½•' AS status;
    END;
    
    -- æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½å‡ºé”™çš„æ“ä½œ
    INSERT INTO test_table (invalid_column) VALUES ('test_value');
    
    -- å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œæ­£å¸¸è¿”å›
    SELECT 'æ“ä½œæ‰§è¡ŒæˆåŠŸ' AS status;
END;
```

### 7.5 CONDITIONæ¡ä»¶å®šä¹‰


**ğŸ”¸ CONDITIONçš„ä½œç”¨**
```
CONDITIONç”¨äºå®šä¹‰å‘½åçš„å¼‚å¸¸æ¡ä»¶ï¼Œè®©å¼‚å¸¸å¤„ç†æ›´æ¸…æ™°

ä¼˜åŠ¿ï¼š
â€¢ ä»£ç å¯è¯»æ€§ï¼šç”¨æœ‰æ„ä¹‰çš„åå­—ä»£æ›¿SQLSTATEç 
â€¢ ç»´æŠ¤æ€§ï¼šç»Ÿä¸€ç®¡ç†å¼‚å¸¸æ¡ä»¶
â€¢ å¤ç”¨æ€§ï¼šåŒä¸€ä¸ªæ¡ä»¶å¯ä»¥åœ¨å¤šå¤„ä½¿ç”¨

è¯­æ³•ï¼š
DECLARE condition_name CONDITION FOR SQLSTATE 'sqlstate_value';
DECLARE condition_name CONDITION FOR mysql_error_code;
```

**ğŸ’» CONDITIONå®šä¹‰å’Œä½¿ç”¨ç¤ºä¾‹**
```sql
CREATE PROCEDURE user_management_with_conditions(IN action VARCHAR(20), IN user_id INT)
BEGIN
    -- å®šä¹‰å‘½åçš„å¼‚å¸¸æ¡ä»¶
    DECLARE user_not_found CONDITION FOR SQLSTATE '02000';
    DECLARE duplicate_entry CONDITION FOR SQLSTATE '23000';
    DECLARE data_too_long CONDITION FOR 1406;  -- MySQLé”™è¯¯ç 
    DECLARE access_denied CONDITION FOR 1142;
    
    -- å£°æ˜å˜é‡
    DECLARE v_user_count INT DEFAULT 0;
    DECLARE v_error_handled BOOLEAN DEFAULT FALSE;
    
    -- ä¸ºä¸åŒæ¡ä»¶å®šä¹‰å¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR user_not_found
    BEGIN
        INSERT INTO operation_logs (operation, result, details, log_time)
        VALUES (action, 'failed', CONCAT('ç”¨æˆ·ID ', user_id, ' ä¸å­˜åœ¨'), NOW());
        SET v_error_handled = TRUE;
        SELECT 'é”™è¯¯ï¼šç”¨æˆ·ä¸å­˜åœ¨' AS error_message;
    END;
    
    DECLARE CONTINUE HANDLER FOR duplicate_entry
    BEGIN
        INSERT INTO operation_logs (operation, result, details, log_time)
        VALUES (action, 'failed', 'æ•°æ®é‡å¤ï¼Œè¿åå”¯ä¸€æ€§çº¦æŸ', NOW());
        SET v_error_handled = TRUE;
        SELECT 'é”™è¯¯ï¼šæ•°æ®å·²å­˜åœ¨ï¼Œä¸èƒ½é‡å¤åˆ›å»º' AS error_message;
    END;
    
    DECLARE CONTINUE HANDLER FOR data_too_long
    BEGIN
        INSERT INTO operation_logs (operation, result, details, log_time)
        VALUES (action, 'failed', 'æ•°æ®é•¿åº¦è¶…å‡ºå­—æ®µé™åˆ¶', NOW());
        SET v_error_handled = TRUE;
        SELECT 'é”™è¯¯ï¼šè¾“å…¥æ•°æ®è¿‡é•¿' AS error_message;
    END;
    
    DECLARE CONTINUE HANDLER FOR access_denied
    BEGIN
        INSERT INTO operation_logs (operation, result, details, log_time)
        VALUES (action, 'failed', 'æƒé™ä¸è¶³ï¼Œæ‹’ç»è®¿é—®', NOW());
        SET v_error_handled = TRUE;
        SELECT 'é”™è¯¯ï¼šæƒé™ä¸è¶³' AS error_message;
    END;
    
    -- æ ¹æ®åŠ¨ä½œæ‰§è¡Œç›¸åº”æ“ä½œ
    CASE action
        WHEN 'create' THEN
            -- å¯èƒ½è§¦å‘duplicate_entryæ¡ä»¶
            INSERT INTO users (id, username, status) 
            VALUES (user_id, CONCAT('user_', user_id), 'active');
            
        WHEN 'update' THEN
            -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            SELECT COUNT(*) INTO v_user_count FROM users WHERE id = user_id;
            IF v_user_count = 0 THEN
                -- æ‰‹åŠ¨è§¦å‘user_not_foundæ¡ä»¶
                SIGNAL user_not_found;
            END IF;
            
            -- å¯èƒ½è§¦å‘data_too_longæ¡ä»¶
            UPDATE users 
            SET username = CONCAT('updated_very_long_username_', user_id, '_with_extra_long_suffix')
            WHERE id = user_id;
            
        WHEN 'delete' THEN
            -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            SELECT COUNT(*) INTO v_user_count FROM users WHERE id = user_id;
            IF v_user_count = 0 THEN
                SIGNAL user_not_found;
            END IF;
            
            DELETE FROM users WHERE id = user_id;
            
        ELSE
            SELECT 'æœªçŸ¥æ“ä½œç±»å‹' AS error_message;
            SET v_error_handled = TRUE;
    END CASE;
    
    -- å¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œè®°å½•æˆåŠŸæ—¥å¿—
    IF NOT v_error_handled THEN
        INSERT INTO operation_logs (operation, result, details, log_time)
        VALUES (action, 'success', CONCAT('ç”¨æˆ·ID ', user_id, ' æ“ä½œæˆåŠŸ'), NOW());
        SELECT CONCAT(action, ' æ“ä½œæ‰§è¡ŒæˆåŠŸ') AS success_message;
    END IF;
END;
```

### 7.6 HANDLERå¼‚å¸¸å¤„ç†å™¨


**ğŸ”¸ HANDLERçš„ç±»å‹å’Œä½œç”¨**
```
HANDLERæ˜¯å¼‚å¸¸å¤„ç†çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®šä¹‰é‡åˆ°å¼‚å¸¸æ—¶çš„å¤„ç†æ–¹å¼

HANDLERç±»å‹ï¼š
â€¢ CONTINUEï¼šå¤„ç†å¼‚å¸¸åç»§ç»­æ‰§è¡Œåç»­ä»£ç 
â€¢ EXITï¼šå¤„ç†å¼‚å¸¸åé€€å‡ºå½“å‰ä»£ç å—
â€¢ UNDOï¼šå¤„ç†å¼‚å¸¸åæ’¤é”€æ“ä½œï¼ˆMySQLä¸æ”¯æŒï¼‰

è¯­æ³•æ ¼å¼ï¼š
DECLARE handler_action HANDLER FOR condition_value statement;
```

**ğŸ’» ä¸åŒç±»å‹HANDLERçš„å¯¹æ¯”ç¤ºä¾‹**
```sql
-- æ¼”ç¤ºCONTINUEå’ŒEXIT handlerçš„åŒºåˆ«
CREATE PROCEDURE handler_comparison_demo()
BEGIN
    DECLARE v_continue_count INT DEFAULT 0;
    DECLARE v_exit_reached BOOLEAN DEFAULT FALSE;
    
    -- æµ‹è¯•CONTINUE HANDLER
    test_continue_block: BEGIN
        DECLARE CONTINUE HANDLER FOR SQLSTATE '23000'
        BEGIN
            SET v_continue_count = v_continue_count + 1;
            INSERT INTO handler_logs (handler_type, action, log_time)
            VALUES ('CONTINUE', 'å¤„ç†é‡å¤é”®é”™è¯¯ä½†ç»§ç»­æ‰§è¡Œ', NOW());
        END;
        
        -- æ•…æ„æ’å…¥é‡å¤æ•°æ®è§¦å‘å¼‚å¸¸
        INSERT INTO test_unique_table (id, name) VALUES (1, 'test1');
        INSERT INTO test_unique_table (id, name) VALUES (1, 'test2'); -- é‡å¤ï¼Œè§¦å‘å¼‚å¸¸
        INSERT INTO test_unique_table (id, name) VALUES (2, 'test3'); -- ç»§ç»­æ‰§è¡Œ
        
        SELECT 'åœ¨CONTINUE handlerä¸­ï¼Œè¿™æ¡è¯­å¥ä¼šæ‰§è¡Œ' AS continue_demo;
    END test_continue_block;
    
    -- æµ‹è¯•EXIT HANDLER  
    test_exit_block: BEGIN
        DECLARE EXIT HANDLER FOR SQLSTATE '23000'
        BEGIN
            INSERT INTO handler_logs (handler_type, action, log_time)
            VALUES ('EXIT', 'å¤„ç†é‡å¤é”®é”™è¯¯å¹¶é€€å‡ºä»£ç å—', NOW());
        END;
        
        -- æ•…æ„æ’å…¥é‡å¤æ•°æ®è§¦å‘å¼‚å¸¸
        INSERT INTO test_unique_table (id, name) VALUES (3, 'test4');
        INSERT INTO test_unique_table (id, name) VALUES (3, 'test5'); -- é‡å¤ï¼Œè§¦å‘å¼‚å¸¸å¹¶é€€å‡º
        
        -- è¿™æ¡è¯­å¥ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºEXIT handlerå·²ç»é€€å‡ºäº†ä»£ç å—
        SELECT 'åœ¨EXIT handlerä¸­ï¼Œè¿™æ¡è¯­å¥ä¸ä¼šæ‰§è¡Œ' AS exit_demo;
        SET v_exit_reached = TRUE;
    END test_exit_block;
    
    -- æ˜¾ç¤ºç»“æœå¯¹æ¯”
    SELECT 
        v_continue_count AS continue_handler_triggered,
        v_exit_reached AS exit_block_completed,
        CASE 
            WHEN v_exit_reached THEN 'EXIT handleræ²¡æœ‰é˜»æ­¢åç»­æ‰§è¡Œ'
            ELSE 'EXIT handleræˆåŠŸé˜»æ­¢äº†åç»­æ‰§è¡Œ'
        END AS exit_behavior;
END;
```

### 7.7 CONTINUEç»§ç»­å¤„ç†


**ğŸ”¸ CONTINUE HANDLERè¯¦è§£**
```sql
-- å®Œæ•´çš„CONTINUE HANDLERä½¿ç”¨åœºæ™¯
CREATE PROCEDURE batch_insert_with_continue_handler(IN batch_data JSON)
BEGIN
    DECLARE v_total_records INT DEFAULT 0;
    DECLARE v_success_count INT DEFAULT 0;
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_current_index INT DEFAULT 0;
    DECLARE v_user_id INT;
    DECLARE v_username VARCHAR(100);
    DECLARE v_email VARCHAR(200);
    
    -- ä½¿ç”¨CONTINUE HANDLERå¤„ç†å„ç§å¯èƒ½çš„é”™è¯¯
    DECLARE CONTINUE HANDLER FOR SQLSTATE '23000'  -- é‡å¤é”®
    BEGIN
        SET v_error_count = v_error_count + 1;
        INSERT INTO batch_errors (error_type, record_index, error_message, error_time)
        VALUES ('DUPLICATE_KEY', v_current_index, 'æ•°æ®é‡å¤', NOW());
    END;
    
    DECLARE CONTINUE HANDLER FOR SQLSTATE '22001'  -- æ•°æ®è¿‡é•¿
    BEGIN
        SET v_error_count = v_error_count + 1;
        INSERT INTO batch_errors (error_type, record_index, error_message, error_time)
        VALUES ('DATA_TOO_LONG', v_current_index, 'æ•°æ®é•¿åº¦è¶…é™', NOW());
    END;
    
    DECLARE CONTINUE HANDLER FOR SQLSTATE '01000'  -- è­¦å‘Š
    BEGIN
        INSERT INTO batch_warnings (warning_type, record_index, warning_message, warning_time)
        VALUES ('DATA_WARNING', v_current_index, 'æ•°æ®æœ‰è­¦å‘Š', NOW());
    END;
    
    -- è·å–æ‰¹é‡æ•°æ®çš„è®°å½•æ•°
    SET v_total_records = JSON_LENGTH(batch_data);
    
    -- å¼€å§‹æ‰¹é‡å¤„ç†
    WHILE v_current_index < v_total_records DO
        -- æå–å½“å‰è®°å½•çš„æ•°æ®
        SET v_user_id = JSON_UNQUOTE(JSON_EXTRACT(batch_data, CONCAT('$[', v_current_index, '].user_id')));
        SET v_username = JSON_UNQUOTE(JSON_EXTRACT(batch_data, CONCAT('$[', v_current_index, '].username')));
        SET v_email = JSON_UNQUOTE(JSON_EXTRACT(batch_data, CONCAT('$[', v_current_index, '].email')));
        
        -- å°è¯•æ’å…¥æ•°æ®
        INSERT INTO users (id, username, email, create_time, status)
        VALUES (v_user_id, v_username, v_email, NOW(), 'active');
        
        -- å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œå¢åŠ æˆåŠŸè®¡æ•°
        SET v_success_count = v_success_count + 1;
        
        -- ç§»åŠ¨åˆ°ä¸‹ä¸€æ¡è®°å½•
        SET v_current_index = v_current_index + 1;
    END WHILE;
    
    -- è¾“å‡ºæ‰¹é‡å¤„ç†ç»“æœ
    SELECT 
        v_total_records AS total_records,
        v_success_count AS success_count,
        v_error_count AS error_count,
        ROUND(v_success_count / v_total_records * 100, 2) AS success_rate,
        'æ‰¹é‡å¤„ç†å®Œæˆ' AS status;
END;
```

### 7.8 EXITé€€å‡ºå¤„ç†


**ğŸ”¸ EXIT HANDLERçš„åº”ç”¨åœºæ™¯**
```sql
-- å…³é”®ä¸šåŠ¡æ“ä½œçš„EXIT HANDLERä¿æŠ¤
CREATE PROCEDURE critical_financial_transaction(
    IN from_account INT, 
    IN to_account INT, 
    IN amount DECIMAL(10,2)
)
BEGIN
    DECLARE v_from_balance DECIMAL(10,2) DEFAULT 0;
    DECLARE v_to_balance DECIMAL(10,2) DEFAULT 0;
    DECLARE v_transaction_id INT DEFAULT 0;
    
    -- ä½¿ç”¨EXIT HANDLERç¡®ä¿ä»»ä½•é”™è¯¯éƒ½ä¼šå®Œå…¨åœæ­¢äº¤æ˜“
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        -- å›æ»šäº‹åŠ¡
        ROLLBACK;
        
        -- è®°å½•å¤±è´¥çš„äº¤æ˜“
        INSERT INTO failed_transactions (
            from_account, 
            to_account, 
            amount, 
            error_message, 
            attempt_time
        ) VALUES (
            from_account, 
            to_account, 
            amount, 
            CONCAT('äº¤æ˜“å¤±è´¥: ', MESSAGE_TEXT), 
            NOW()
        );
        
        -- å‘é€é”™è¯¯é€šçŸ¥
        CALL send_transaction_alert(
            from_account, 
            CONCAT('äº¤æ˜“å¤±è´¥ï¼Œé‡‘é¢: ', amount, 'ï¼Œè¯·è”ç³»å®¢æœ')
        );
        
        -- è¿”å›é”™è¯¯ä¿¡æ¯åé€€å‡º
        SELECT 
            'FAILED' AS transaction_status,
            MESSAGE_TEXT AS error_message,
            'äº¤æ˜“å·²å›æ»šï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ' AS advice;
    END;
    
    -- å¼€å§‹äº‹åŠ¡
    START TRANSACTION;
    
    -- éªŒè¯è½¬å‡ºè´¦æˆ·
    SELECT balance INTO v_from_balance 
    FROM accounts 
    WHERE account_id = from_account 
    FOR UPDATE;
    
    IF v_from_balance IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'è½¬å‡ºè´¦æˆ·ä¸å­˜åœ¨';
    END IF;
    
    IF v_from_balance < amount THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'è´¦æˆ·ä½™é¢ä¸è¶³';
    END IF;
    
    -- éªŒè¯è½¬å…¥è´¦æˆ·
    SELECT balance INTO v_to_balance 
    FROM accounts 
    WHERE account_id = to_account 
    FOR UPDATE;
    
    IF v_to_balance IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'è½¬å…¥è´¦æˆ·ä¸å­˜åœ¨';
    END IF;
    
    -- åˆ›å»ºäº¤æ˜“è®°å½•
    INSERT INTO transactions (from_account, to_account, amount, transaction_time, status)
    VALUES (from_account, to_account, amount, NOW(), 'processing');
    SET v_transaction_id = LAST_INSERT_ID();
    
    -- æ‰§è¡Œè½¬è´¦
    UPDATE accounts SET balance = balance - amount WHERE account_id = from_account;
    UPDATE accounts SET balance = balance + amount WHERE account_id = to_account;
    
    -- æ›´æ–°äº¤æ˜“çŠ¶æ€
    UPDATE transactions SET status = 'completed' WHERE id = v_transaction_id;
    
    -- æäº¤äº‹åŠ¡
    COMMIT;
    
    -- è®°å½•æˆåŠŸçš„äº¤æ˜“
    INSERT INTO transaction_logs (transaction_id, log_message, log_time)
    VALUES (v_transaction_id, 'äº¤æ˜“æˆåŠŸå®Œæˆ', NOW());
    
    -- è¿”å›æˆåŠŸä¿¡æ¯
    SELECT 
        'SUCCESS' AS transaction_status,
        v_transaction_id AS transaction_id,
        amount AS transferred_amount,
        'äº¤æ˜“æˆåŠŸå®Œæˆ' AS message;
END;
```

### 7.9 UNDOæ’¤é”€å¤„ç†


**ğŸ”¸ UNDO HANDLERè¯´æ˜**
```
é‡è¦æé†’ï¼šMySQLä¸æ”¯æŒUNDO HANDLERï¼

UNDO HANDLERåœ¨å…¶ä»–æ•°æ®åº“ä¸­çš„ä½œç”¨ï¼š
â€¢ è‡ªåŠ¨æ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ
â€¢ æ¢å¤åˆ°å¼‚å¸¸å‘ç”Ÿå‰çš„çŠ¶æ€
â€¢ æä¾›è‡ªåŠ¨çš„å›æ»šæœºåˆ¶

MySQLçš„æ›¿ä»£æ–¹æ¡ˆï¼š
â€¢ ä½¿ç”¨äº‹åŠ¡çš„ROLLBACK
â€¢ åœ¨å¼‚å¸¸å¤„ç†å™¨ä¸­æ‰‹åŠ¨æ’¤é”€æ“ä½œ
â€¢ è®¾è®¡è¡¥å¿æ“ä½œé€»è¾‘
```

**ğŸ’» MySQLä¸­çš„UNDOæ›¿ä»£å®ç°**
```sql
-- æ¨¡æ‹ŸUNDOåŠŸèƒ½çš„æ‰‹åŠ¨æ’¤é”€æ“ä½œ
CREATE PROCEDURE manual_undo_example(IN operation_data JSON)
BEGIN
    DECLARE v_operation_id INT DEFAULT 0;
    DECLARE v_step INT DEFAULT 0;
    DECLARE v_rollback_needed BOOLEAN DEFAULT FALSE;
    
    -- è®°å½•æ“ä½œæ­¥éª¤çš„è¡¨
    CREATE TEMPORARY TABLE operation_steps (
        step_number INT,
        operation_type VARCHAR(50),
        table_name VARCHAR(64),
        record_id INT,
        old_value TEXT,
        new_value TEXT
    );
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        SET v_rollback_needed = TRUE;
        
        -- æ‰§è¡Œæ‰‹åŠ¨æ’¤é”€æ“ä½œ
        CALL perform_manual_undo(v_operation_id);
        
        SELECT 'FAILED' AS status, 'æ“ä½œå·²æ’¤é”€' AS message;
    END;
    
    -- å¼€å§‹å¤åˆæ“ä½œ
    START TRANSACTION;
    
    -- ç”Ÿæˆæ“ä½œID
    INSERT INTO operation_history (start_time, status) VALUES (NOW(), 'running');
    SET v_operation_id = LAST_INSERT_ID();
    
    -- æ­¥éª¤1ï¼šæ›´æ–°ç”¨æˆ·çŠ¶æ€
    SET v_step = 1;
    INSERT INTO operation_steps VALUES (
        v_step, 'UPDATE', 'users', 1001, 'active', 'inactive'
    );
    
    UPDATE users SET status = 'inactive' WHERE id = 1001;
    
    -- æ­¥éª¤2ï¼šæ’å…¥æ—¥å¿—è®°å½•
    SET v_step = 2;
    INSERT INTO operation_steps VALUES (
        v_step, 'INSERT', 'user_logs', 0, '', 'status_change'
    );
    
    INSERT INTO user_logs (user_id, action, log_time) 
    VALUES (1001, 'status_change', NOW());
    
    -- æ­¥éª¤3ï¼šå‘é€é€šçŸ¥
    SET v_step = 3;
    INSERT INTO operation_steps VALUES (
        v_step, 'INSERT', 'notifications', 0, '', 'user_deactivated'
    );
    
    INSERT INTO notifications (user_id, message, send_time)
    VALUES (1001, 'æ‚¨çš„è´¦æˆ·å·²è¢«åœç”¨', NOW());
    
    -- å¦‚æœæ‰€æœ‰æ­¥éª¤æˆåŠŸï¼Œæäº¤äº‹åŠ¡
    COMMIT;
    
    -- æ›´æ–°æ“ä½œå†å²
    UPDATE operation_history 
    SET end_time = NOW(), status = 'completed' 
    WHERE id = v_operation_id;
    
    -- æ¸…ç†ä¸´æ—¶è¡¨
    DROP TEMPORARY TABLE operation_steps;
    
    SELECT 'SUCCESS' AS status, 'æ“ä½œæˆåŠŸå®Œæˆ' AS message;
END;

-- æ‰‹åŠ¨æ’¤é”€æ“ä½œçš„å®ç°
CREATE PROCEDURE perform_manual_undo(IN operation_id INT)
BEGIN
    DECLARE done BOOLEAN DEFAULT FALSE;
    DECLARE v_step INT;
    DECLARE v_operation_type VARCHAR(50);
    DECLARE v_table_name VARCHAR(64);
    DECLARE v_record_id INT;
    DECLARE v_old_value TEXT;
    
    -- æ¸¸æ ‡éå†æ“ä½œæ­¥éª¤ï¼ˆå€’åºæ’¤é”€ï¼‰
    DECLARE step_cursor CURSOR FOR 
        SELECT step_number, operation_type, table_name, record_id, old_value
        FROM operation_steps 
        ORDER BY step_number DESC;
        
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN step_cursor;
    
    undo_loop: LOOP
        FETCH step_cursor INTO v_step, v_operation_type, v_table_name, v_record_id, v_old_value;
        
        IF done THEN
            LEAVE undo_loop;
        END IF;
        
        -- æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œæ’¤é”€
        CASE v_operation_type
            WHEN 'UPDATE' THEN
                -- æ’¤é”€æ›´æ–°ï¼šæ¢å¤æ—§å€¼
                SET @sql = CONCAT('UPDATE ', v_table_name, 
                                 ' SET status = "', v_old_value, 
                                 '" WHERE id = ', v_record_id);
                PREPARE stmt FROM @sql;
                EXECUTE stmt;
                DEALLOCATE PREPARE stmt;
                
            WHEN 'INSERT' THEN
                -- æ’¤é”€æ’å…¥ï¼šåˆ é™¤è®°å½•
                SET @sql = CONCAT('DELETE FROM ', v_table_name, 
                                 ' WHERE id = LAST_INSERT_ID()');
                PREPARE stmt FROM @sql;
                EXECUTE stmt;
                DEALLOCATE PREPARE stmt;
                
            WHEN 'DELETE' THEN
                -- æ’¤é”€åˆ é™¤ï¼šé‡æ–°æ’å…¥ï¼ˆéœ€è¦ä¿å­˜å®Œæ•´è®°å½•ï¼‰
                -- è¿™é‡Œç®€åŒ–å¤„ç†
                INSERT INTO undo_logs (operation_id, message) 
                VALUES (operation_id, CONCAT('æ— æ³•æ’¤é”€DELETEæ“ä½œï¼Œæ­¥éª¤:', v_step));
        END CASE;
        
        -- è®°å½•æ’¤é”€æ“ä½œ
        INSERT INTO undo_logs (operation_id, step_number, undo_action, undo_time)
        VALUES (operation_id, v_step, CONCAT('æ’¤é”€', v_operation_type), NOW());
        
    END LOOP undo_loop;
    
    CLOSE step_cursor;
    
    -- å›æ»šæ•´ä¸ªäº‹åŠ¡
    ROLLBACK;
    
    -- æ ‡è®°æ“ä½œä¸ºå·²æ’¤é”€
    UPDATE operation_history 
    SET end_time = NOW(), status = 'undone' 
    WHERE id = operation_id;
END;
```

---

## 10. ğŸ› ï¸ ç»¼åˆå®æˆ˜æ¡ˆä¾‹


### 10.1 å®Œæ•´çš„ç”¨æˆ·è®¢å•å¤„ç†ç³»ç»Ÿ


**ğŸ¯ ä¸šåŠ¡éœ€æ±‚**
```
å®ç°ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·è®¢å•å¤„ç†ç³»ç»Ÿï¼ŒåŒ…å«ï¼š
â€¢ ç”¨æˆ·éªŒè¯å’Œç­‰çº§åˆ¤æ–­
â€¢ åº“å­˜æ£€æŸ¥å’Œæ‰£å‡
â€¢ ä¼˜æƒ è®¡ç®—å’Œç§¯åˆ†å¥–åŠ±
â€¢ è®¢å•åˆ›å»ºå’ŒçŠ¶æ€ç®¡ç†
â€¢ å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
```

**ğŸ’» ç»¼åˆå®æˆ˜ä»£ç **
```sql
-- ä¸»è®¢å•å¤„ç†æµç¨‹
CREATE PROCEDURE process_user_order(
    IN p_user_id INT,
    IN p_product_id INT, 
    IN p_quantity INT,
    OUT p_order_id INT,
    OUT p_final_amount DECIMAL(10,2),
    OUT p_status_message VARCHAR(500)
)
BEGIN
    -- å˜é‡å£°æ˜åŒºåŸŸ
    DECLARE v_user_level VARCHAR(20) DEFAULT '';
    DECLARE v_user_points INT DEFAULT 0;
    DECLARE v_product_price DECIMAL(10,2) DEFAULT 0;
    DECLARE v_stock_quantity INT DEFAULT 0;
    DECLARE v_original_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_discount_rate DECIMAL(5,4) DEFAULT 0;
    DECLARE v_discount_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_earned_points INT DEFAULT 0;
    DECLARE v_processing_step VARCHAR(50) DEFAULT '';
    
    -- æ§åˆ¶å˜é‡
    DECLARE v_error_occurred BOOLEAN DEFAULT FALSE;
    DECLARE v_warning_count INT DEFAULT 0;
    
    -- æ¡ä»¶å®šä¹‰
    DECLARE user_not_found CONDITION FOR SQLSTATE '45001';
    DECLARE product_not_found CONDITION FOR SQLSTATE '45002';
    DECLARE insufficient_stock CONDITION FOR SQLSTATE '45003';
    DECLARE invalid_quantity CONDITION FOR SQLSTATE '45004';
    
    -- å¼‚å¸¸å¤„ç†å™¨
    DECLARE EXIT HANDLER FOR user_not_found
    BEGIN
        CALL log_operation('ORDER_FAILED', CONCAT('ç”¨æˆ·ä¸å­˜åœ¨: ', p_user_id), 'ERROR');
        SET p_status_message = 'ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·ID';
        SET p_order_id = 0;
        SET p_final_amount = 0;
    END;
    
    DECLARE EXIT HANDLER FOR product_not_found
    BEGIN
        CALL log_operation('ORDER_FAILED', CONCAT('å•†å“ä¸å­˜åœ¨: ', p_product_id), 'ERROR');
        SET p_status_message = 'å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶';
        SET p_order_id = 0;
        SET p_final_amount = 0;
    END;
    
    DECLARE EXIT HANDLER FOR insufficient_stock
    BEGIN
        CALL log_operation('ORDER_FAILED', CONCAT('åº“å­˜ä¸è¶³ï¼Œå•†å“ID: ', p_product_id), 'ERROR');
        SET p_status_message = CONCAT('åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜: ', v_stock_quantity);
        SET p_order_id = 0;
        SET p_final_amount = 0;
    END;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        CALL log_operation('ORDER_ERROR', CONCAT('è®¢å•å¤„ç†å¼‚å¸¸ï¼Œæ­¥éª¤: ', v_processing_step), 'ERROR');
        SET p_status_message = CONCAT('ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚é”™è¯¯ä½ç½®: ', v_processing_step);
        SET p_order_id = 0;
        SET p_final_amount = 0;
    END;
    
    -- è­¦å‘Šå¤„ç†å™¨
    DECLARE CONTINUE HANDLER FOR SQLWARNING
    BEGIN
        SET v_warning_count = v_warning_count + 1;
        CALL log_operation('ORDER_WARNING', CONCAT('å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°è­¦å‘Šï¼Œæ­¥éª¤: ', v_processing_step), 'WARNING');
    END;
    
    -- å¼€å§‹ä¸»è¦å¤„ç†é€»è¾‘
    START TRANSACTION;
    
    -- æ­¥éª¤1ï¼šéªŒè¯è¾“å…¥å‚æ•°
    SET v_processing_step = 'å‚æ•°éªŒè¯';
    IF p_quantity <= 0 OR p_quantity > 999 THEN
        SIGNAL invalid_quantity SET MESSAGE_TEXT = 'è®¢å•æ•°é‡å¿…é¡»åœ¨1-999ä¹‹é—´';
    END IF;
    
    -- æ­¥éª¤2ï¼šéªŒè¯ç”¨æˆ·ä¿¡æ¯
    SET v_processing_step = 'ç”¨æˆ·éªŒè¯';
    SELECT user_level, total_points 
    INTO v_user_level, v_user_points
    FROM users 
    WHERE id = p_user_id AND status = 'active';
    
    IF v_user_level IS NULL THEN
        SIGNAL user_not_found;
    END IF;
    
    -- æ­¥éª¤3ï¼šéªŒè¯å•†å“ä¿¡æ¯
    SET v_processing_step = 'å•†å“éªŒè¯';
    SELECT price, stock_quantity 
    INTO v_product_price, v_stock_quantity
    FROM products 
    WHERE id = p_product_id AND status = 'active';
    
    IF v_product_price IS NULL THEN
        SIGNAL product_not_found;
    END IF;
    
    -- æ­¥éª¤4ï¼šæ£€æŸ¥åº“å­˜
    SET v_processing_step = 'åº“å­˜æ£€æŸ¥';
    IF v_stock_quantity < p_quantity THEN
        SIGNAL insufficient_stock;
    END IF;
    
    -- æ­¥éª¤5ï¼šè®¡ç®—ä»·æ ¼å’ŒæŠ˜æ‰£
    SET v_processing_step = 'ä»·æ ¼è®¡ç®—';
    SET v_original_amount = v_product_price * p_quantity;
    
    -- è°ƒç”¨æŠ˜æ‰£è®¡ç®—å‡½æ•°
    SET v_discount_rate = calculate_discount_rate(v_user_level, v_original_amount);
    SET v_discount_amount = v_original_amount * v_discount_rate;
    SET p_final_amount = v_original_amount - v_discount_amount;
    
    -- æ­¥éª¤6ï¼šæ‰£å‡åº“å­˜
    SET v_processing_step = 'åº“å­˜æ‰£å‡';
    UPDATE products 
    SET stock_quantity = stock_quantity - p_quantity,
        last_stock_update = NOW()
    WHERE id = p_product_id;
    
    -- æ­¥éª¤7ï¼šåˆ›å»ºè®¢å•
    SET v_processing_step = 'è®¢å•åˆ›å»º';
    INSERT INTO orders (
        user_id, 
        product_id, 
        quantity, 
        original_amount, 
        discount_rate,
        discount_amount,
        final_amount, 
        order_time, 
        status
    ) VALUES (
        p_user_id, 
        p_product_id, 
        p_quantity, 
        v_original_amount,
        v_discount_rate,
        v_discount_amount,
        p_final_amount, 
        NOW(), 
        'confirmed'
    );
    
    SET p_order_id = LAST_INSERT_ID();
    
    -- æ­¥éª¤8ï¼šè®¡ç®—å¹¶å¢åŠ ç§¯åˆ†
    SET v_processing_step = 'ç§¯åˆ†è®¡ç®—';
    CALL calculate_user_points(p_user_id, 'purchase', v_earned_points);
    
    -- æ­¥éª¤9ï¼šè®°å½•è®¢å•è¯¦æƒ…
    SET v_processing_step = 'è®¢å•è¯¦æƒ…è®°å½•';
    INSERT INTO order_details (
        order_id,
        user_level,
        earned_points,
        processing_warnings,
        create_time
    ) VALUES (
        p_order_id,
        v_user_level,
        v_earned_points,
        v_warning_count,
        NOW()
    );
    
    -- æ­¥éª¤10ï¼šå‘é€é€šçŸ¥
    SET v_processing_step = 'é€šçŸ¥å‘é€';
    CALL send_notification(
        p_user_id, 
        CONCAT('è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·: ', p_order_id, 'ï¼Œè·å¾—ç§¯åˆ†: ', v_earned_points)
    );
    
    -- æäº¤äº‹åŠ¡
    COMMIT;
    
    -- è®°å½•æˆåŠŸæ—¥å¿—
    CALL log_operation(
        'ORDER_SUCCESS', 
        CONCAT('è®¢å•å¤„ç†æˆåŠŸï¼Œè®¢å•ID: ', p_order_id, 'ï¼Œé‡‘é¢: ', p_final_amount), 
        'INFO'
    );
    
    -- è®¾ç½®æˆåŠŸæ¶ˆæ¯
    SET p_status_message = CONCAT(
        'è®¢å•å¤„ç†æˆåŠŸï¼è®¢å•å·: ', p_order_id, 
        'ï¼ŒåŸä»·: ', v_original_amount,
        'ï¼ŒæŠ˜æ‰£: ', ROUND(v_discount_rate * 100, 2), '%',
        'ï¼Œå®ä»˜: ', p_final_amount,
        'ï¼Œè·å¾—ç§¯åˆ†: ', v_earned_points
    );
    
    -- å¦‚æœæœ‰è­¦å‘Šï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
    IF v_warning_count > 0 THEN
        SET p_status_message = CONCAT(p_status_message, ' (å¤„ç†è¿‡ç¨‹ä¸­æœ‰', v_warning_count, 'ä¸ªè­¦å‘Š)');
    END IF;
    
END;
```

### 10.2 è®¢å•æ‰¹å¤„ç†ç³»ç»Ÿ


**ğŸ’» æ‰¹é‡è®¢å•å¤„ç†ç¤ºä¾‹**
```sql
-- æ‰¹é‡å¤„ç†å¾…æ”¯ä»˜è®¢å•
CREATE PROCEDURE batch_process_pending_orders()
BEGIN
    DECLARE v_order_id INT DEFAULT 0;
    DECLARE v_user_id INT DEFAULT 0;
    DECLARE v_amount DECIMAL(10,2) DEFAULT 0;
    DECLARE v_order_time TIMESTAMP;
    DECLARE v_processed_count INT DEFAULT 0;
    DECLARE v_expired_count INT DEFAULT 0;
    DECLARE v_error_count INT DEFAULT 0;
    DECLARE v_current_time TIMESTAMP DEFAULT NOW();
    DECLARE v_expiry_hours INT DEFAULT 24;
    
    -- æ¸¸æ ‡å£°æ˜
    DECLARE order_cursor CURSOR FOR
        SELECT id, user_id, final_amount, order_time
        FROM orders 
        WHERE status = 'pending'
        ORDER BY order_time;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND 
    BEGIN
        -- å¤„ç†å®Œæ‰€æœ‰è®°å½•
    END;
    
    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
    BEGIN
        SET v_error_count = v_error_count + 1;
        INSERT INTO batch_error_logs (order_id, error_message, error_time)
        VALUES (v_order_id, CONCAT('å¤„ç†è®¢å•å¼‚å¸¸: ', MESSAGE_TEXT), NOW());
    END;
    
    -- å¼€å§‹æ‰¹å¤„ç†
    CALL log_operation('BATCH_START', 'å¼€å§‹æ‰¹é‡å¤„ç†å¾…æ”¯ä»˜è®¢å•', 'INFO');
    
    OPEN order_cursor;
    
    process_loop: LOOP
        FETCH order_cursor INTO v_order_id, v_user_id, v_amount, v_order_time;
        
        -- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ•°æ®
        IF v_order_id IS NULL THEN
            LEAVE process_loop;
        END IF;
        
        -- æ£€æŸ¥è®¢å•æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶æœªæ”¯ä»˜ï¼‰
        IF TIMESTAMPDIFF(HOUR, v_order_time, v_current_time) > v_expiry_hours THEN
            -- å¤„ç†è¿‡æœŸè®¢å•
            BEGIN
                START TRANSACTION;
                
                -- æ›´æ–°è®¢å•çŠ¶æ€ä¸ºè¿‡æœŸ
                UPDATE orders 
                SET status = 'expired', expire_time = NOW()
                WHERE id = v_order_id;
                
                -- æ¢å¤åº“å­˜
                UPDATE products p
                JOIN orders o ON p.id = o.product_id
                SET p.stock_quantity = p.stock_quantity + o.quantity,
                    p.last_stock_update = NOW()
                WHERE o.id = v_order_id;
                
                -- å‘é€è¿‡æœŸé€šçŸ¥
                CALL send_notification(
                    v_user_id, 
                    CONCAT('è®¢å•', v_order_id, 'å·²è¿‡æœŸï¼Œé‡‘é¢', v_amount, 'å…ƒçš„åº“å­˜å·²é‡Šæ”¾')
                );
                
                COMMIT;
                SET v_expired_count = v_expired_count + 1;
            END;
        ELSE
            -- æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€æé†’
            IF TIMESTAMPDIFF(HOUR, v_order_time, v_current_time) > 12 THEN
                CALL send_notification(
                    v_user_id,
                    CONCAT('è®¢å•', v_order_id, 'å³å°†è¿‡æœŸï¼Œè¯·åŠæ—¶æ”¯ä»˜ï¼Œé‡‘é¢: ', v_amount, 'å…ƒ')
                );
            END IF;
        END IF;
        
        SET v_processed_count = v_processed_count + 1;
        
        -- æ¯å¤„ç†100æ¡è®°å½•è¾“å‡ºä¸€æ¬¡è¿›åº¦
        IF MOD(v_processed_count, 100) = 0 THEN
            SELECT CONCAT('å·²å¤„ç† ', v_processed_count, ' æ¡è®¢å•...') AS progress;
        END IF;
        
    END LOOP process_loop;
    
    CLOSE order_cursor;
    
    -- è¾“å‡ºå¤„ç†ç»“æœ
    INSERT INTO batch_process_logs (
        process_type,
        total_processed,
        expired_orders,
        error_count,
        process_time,
        status
    ) VALUES (
        'PENDING_ORDERS',
        v_processed_count,
        v_expired_count,
        v_error_count,
        NOW(),
        'COMPLETED'
    );
    
    SELECT 
        v_processed_count AS total_processed,
        v_expired_count AS expired_orders,
        v_error_count AS error_count,
        ROUND(v_expired_count / v_processed_count * 100, 2) AS expiry_rate,
        'æ‰¹é‡å¤„ç†å®Œæˆ' AS status;
        
    CALL log_operation(
        'BATCH_COMPLETE', 
        CONCAT('æ‰¹é‡å¤„ç†å®Œæˆï¼Œå¤„ç†:', v_processed_count, 'ï¼Œè¿‡æœŸ:', v_expired_count, 'ï¼Œé”™è¯¯:', v_error_count), 
        'INFO'
    );
END;
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä»£ç å—æ§åˆ¶ï¼šBEGIN/ENDæ˜¯å­˜å‚¨è¿‡ç¨‹çš„åŸºæœ¬ç»“æ„ï¼Œå®šä¹‰ä»£ç ä½œç”¨åŸŸ
ğŸ”¸ å˜é‡æ“ä½œï¼šDECLAREå£°æ˜ã€SETèµ‹å€¼ã€SELECT INTOæŸ¥è¯¢èµ‹å€¼æ˜¯æ•°æ®å¤„ç†åŸºç¡€
ğŸ”¸ æ¡ä»¶æ§åˆ¶ï¼šIF/THEN/ELSEå’ŒCASE/WHENå®ç°ä¸šåŠ¡é€»è¾‘åˆ†æ”¯
ğŸ”¸ å¾ªç¯æ§åˆ¶ï¼šLOOP/WHILE/REPEATæä¾›é‡å¤å¤„ç†èƒ½åŠ›ï¼ŒLEAVE/ITERATEæ§åˆ¶æµç¨‹
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šSIGNALæŠ›å‡ºã€HANDLERæ•è·ã€GET DIAGNOSTICSè¯Šæ–­ï¼Œä¿è¯ç¨‹åºå¥å£®æ€§
```

### 11.2 å…³é”®è¯­å¥ä½¿ç”¨è¦ç‚¹


**ğŸ”¹ ä»£ç å—å’Œå˜é‡ç®¡ç†**
```
BEGIN/ENDè¦ç‚¹ï¼š
â€¢ å¿…é¡»æˆå¯¹å‡ºç°ï¼Œæ”¯æŒåµŒå¥—
â€¢ å®šä¹‰å˜é‡ä½œç”¨åŸŸ
â€¢ æ§åˆ¶å¼‚å¸¸å¤„ç†èŒƒå›´

å˜é‡æ“ä½œè¦ç‚¹ï¼š
â€¢ DECLAREå¿…é¡»åœ¨ä»£ç å—å¼€å§‹ä½ç½®
â€¢ SETç”¨äºèµ‹å€¼è®¡ç®—ç»“æœ
â€¢ SELECT INTOç”¨äºæŸ¥è¯¢ç»“æœèµ‹å€¼
â€¢ æ³¨æ„å˜é‡ç±»å‹åŒ¹é…
```

**ğŸ”¹ æ¡ä»¶å’Œå¾ªç¯æ§åˆ¶**
```
æ¡ä»¶æ§åˆ¶é€‰æ‹©ï¼š
â€¢ ç®€å•æ¡ä»¶ï¼šä½¿ç”¨IF/THEN/ELSE
â€¢ å¤šé‡æ¡ä»¶ï¼šä½¿ç”¨ELSEIFæˆ–CASE/WHEN
â€¢ å€¼åŒ¹é…ï¼šCASEæ›´ç®€æ´
â€¢ å¤æ‚æ¡ä»¶ï¼šIFæ›´çµæ´»

å¾ªç¯æ§åˆ¶é€‰æ‹©ï¼š
â€¢ æ˜ç¡®æ¬¡æ•°ï¼šä½¿ç”¨WHILEæˆ–FORï¼ˆå¦‚æœæ”¯æŒï¼‰
â€¢ ä¸ç¡®å®šæ¬¡æ•°ï¼šä½¿ç”¨LOOP + LEAVE
â€¢ è‡³å°‘æ‰§è¡Œä¸€æ¬¡ï¼šä½¿ç”¨REPEAT/UNTIL
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†ç­–ç•¥**
```
å¼‚å¸¸å¤„ç†å±‚æ¬¡ï¼š
â€¢ CONTINUE HANDLERï¼šå¤„ç†åç»§ç»­æ‰§è¡Œ
â€¢ EXIT HANDLERï¼šå¤„ç†åé€€å‡ºå½“å‰å—
â€¢ æ¡ä»¶å‘½åï¼šä½¿ç”¨CONDITIONæé«˜å¯è¯»æ€§
â€¢ è¯Šæ–­ä¿¡æ¯ï¼šç”¨GET DIAGNOSTICSè·å–è¯¦ç»†é”™è¯¯
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‚ç”¨åœºæ™¯åˆ†æ**
- **ä¸šåŠ¡é€»è¾‘å¤æ‚**ï¼šéœ€è¦å¤šé‡æ¡ä»¶åˆ¤æ–­å’Œå¾ªç¯å¤„ç†
- **æ•°æ®æ‰¹é‡å¤„ç†**ï¼šå¤§é‡æ•°æ®çš„é€æ¡æˆ–åˆ†æ‰¹å¤„ç†  
- **äº‹åŠ¡å®Œæ•´æ€§è¦æ±‚é«˜**ï¼šéœ€è¦å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶
- **ç³»ç»Ÿé›†æˆåœºæ™¯**ï¼šå¤šä¸ªç³»ç»Ÿé—´çš„æ•°æ®åŒæ­¥å’Œè½¬æ¢

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
ä»£ç ä¼˜åŒ–ï¼š
â€¢ å‡å°‘åµŒå¥—å±‚æ¬¡ï¼Œæé«˜ä»£ç å¯è¯»æ€§
â€¢ åˆç†ä½¿ç”¨æ¸¸æ ‡ï¼Œé¿å…å¤§ç»“æœé›†å†…å­˜å ç”¨
â€¢ é€‚å½“ä½¿ç”¨ä¸´æ—¶è¡¨æé«˜å¤æ‚æŸ¥è¯¢æ€§èƒ½
â€¢ æ‰¹é‡æ“ä½œä»£æ›¿é€è¡Œå¤„ç†

å¼‚å¸¸å¤„ç†ä¼˜åŒ–ï¼š
â€¢ ç²¾ç¡®å®šä¹‰å¼‚å¸¸æ¡ä»¶ï¼Œé¿å…è¿‡åº¦æ•è·
â€¢ åˆç†é€‰æ‹©CONTINUE vs EXITå¤„ç†æ–¹å¼
â€¢ è®°å½•è¯¦ç»†å¼‚å¸¸ä¿¡æ¯ä¾¿äºè°ƒè¯•
â€¢ è®¾ç½®åˆç†çš„é‡è¯•æœºåˆ¶
```

**ğŸ”¹ å¸¸è§é™·é˜±å’Œæœ€ä½³å®è·µ**
```
å¸¸è§é”™è¯¯ï¼š
âŒ å¿˜è®°å£°æ˜å˜é‡æˆ–å£°æ˜ä½ç½®é”™è¯¯
âŒ æ¡ä»¶åˆ¤æ–­é—æ¼è¾¹ç•Œæƒ…å†µ
âŒ å¾ªç¯æ²¡æœ‰æ­£ç¡®çš„é€€å‡ºæ¡ä»¶
âŒ å¼‚å¸¸å¤„ç†ä¸å®Œæ•´å¯¼è‡´èµ„æºæ³„æ¼

æœ€ä½³å®è·µï¼š
âœ… ç»Ÿä¸€çš„å˜é‡å‘½åè§„èŒƒï¼ˆv_å‰ç¼€ç­‰ï¼‰
âœ… å®Œæ•´çš„å¼‚å¸¸å¤„ç†è¦†ç›–
âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
âœ… åˆç†çš„äº‹åŠ¡è¾¹ç•Œæ§åˆ¶
âœ… å……åˆ†çš„æµ‹è¯•è¦†ç›–å„ç§å¼‚å¸¸æƒ…å†µ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥æ˜¯æ„å»ºå¤æ‚ä¸šåŠ¡é€»è¾‘çš„åŸºç¡€å·¥å…·
- å˜é‡å£°æ˜å’Œèµ‹å€¼æ˜¯æ•°æ®å¤„ç†çš„èµ·ç‚¹ï¼Œä½ç½®å’Œç±»å‹å¾ˆé‡è¦
- æ¡ä»¶æ§åˆ¶å®ç°ä¸šåŠ¡åˆ†æ”¯ï¼Œå¾ªç¯æ§åˆ¶å¤„ç†æ‰¹é‡æ•°æ®
- å¼‚å¸¸å¤„ç†æ˜¯ä¿è¯ç¨‹åºå¥å£®æ€§çš„å…³é”®ï¼Œå¿…é¡»å…¨é¢è€ƒè™‘
- æ ‡ç­¾å’Œè·³è½¬æä¾›ç²¾ç¡®çš„æµç¨‹æ§åˆ¶ï¼Œä½†è¦è°¨æ…ä½¿ç”¨
- è¯Šæ–­ä¿¡æ¯å¸®åŠ©å®šä½é—®é¢˜ï¼Œæ˜¯è°ƒè¯•å’Œç›‘æ§çš„é‡è¦æ‰‹æ®µ

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šå­˜å‚¨è¿‡ç¨‹æ§åˆ¶è¯­å¥å†…å®¹è¾ƒå¤šï¼Œå»ºè®®å…ˆæŒæ¡åŸºç¡€çš„BEGIN/ENDã€å˜é‡æ“ä½œå’Œç®€å•æ¡ä»¶åˆ¤æ–­ï¼Œç„¶åé€æ­¥å­¦ä¹ å¾ªç¯æ§åˆ¶å’Œå¼‚å¸¸å¤„ç†ã€‚é€šè¿‡å®é™…ç¼–å†™å®Œæ•´çš„ä¸šåŠ¡æµç¨‹æ¥åŠ æ·±ç†è§£ï¼Œç‰¹åˆ«è¦é‡è§†å¼‚å¸¸å¤„ç†çš„å®Œæ•´æ€§ã€‚