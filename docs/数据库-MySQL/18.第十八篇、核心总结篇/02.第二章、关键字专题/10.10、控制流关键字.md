---
title: 10、控制流关键字
---
## 📚 目录

1. [控制流概述](#1-控制流概述)
2. [IF条件判断](#2-IF条件判断)
3. [CASE多分支控制](#3-CASE多分支控制)
4. [WHEN条件关键字](#4-WHEN条件关键字)
5. [THEN执行关键字](#5-THEN执行关键字)
6. [ELSE默认分支](#6-ELSE默认分支)
7. [END结束标记](#7-END结束标记)
8. [空值处理函数](#8-空值处理函数)
9. [实际应用场景](#9-实际应用场景)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🎯 控制流概述


### 1.1 什么是SQL控制流


**简单理解**：控制流就是让SQL能够"做判断、做选择"的语法工具

```
就像生活中的决策：
如果下雨 → 带伞
如果不下雨 → 不带伞

SQL控制流：
如果条件A → 执行操作1
如果条件B → 执行操作2
否则 → 执行默认操作
```

### 1.2 控制流的作用


**核心作用**：
- **条件判断** - 根据不同情况执行不同逻辑
- **分支选择** - 在多个选项中选择合适的处理方式  
- **空值处理** - 优雅地处理数据库中的NULL值
- **逻辑简化** - 用一条SQL语句完成复杂的条件处理

### 1.3 控制流语句分类


```
┌─────────────────────┐
│     SQL控制流       │
├─────────────────────┤
│  ├─ 条件判断类      │
│  │   ├─ IF          │
│  │   └─ CASE        │
│  ├─ 空值处理类      │
│  │   ├─ IFNULL      │
│  │   ├─ NULLIF      │
│  │   └─ COALESCE    │
│  └─ 关键字类        │
│      ├─ WHEN        │
│      ├─ THEN        │
│      ├─ ELSE        │
│      └─ END         │
└─────────────────────┘
```

---

## 2. 🔀 IF条件判断


### 2.1 IF语句的本质


**通俗解释**：IF就是"如果...那么..."的意思，让数据库能够根据条件做不同的事情

```
生活例子：
如果成绩 >= 90分，那么显示"优秀"
如果成绩 >= 60分，那么显示"及格"  
否则显示"不及格"
```

### 2.2 IF语法结构


**基本语法**：
```sql
IF(条件表达式, 真值结果, 假值结果)
```

**参数说明**：
- **条件表达式** - 返回TRUE或FALSE的判断条件
- **真值结果** - 条件为真时返回的值
- **假值结果** - 条件为假时返回的值

### 2.3 IF实际应用示例


```sql
-- 例子1：成绩等级判断
SELECT 
    student_name,
    score,
    IF(score >= 60, '及格', '不及格') AS result
FROM students;

-- 例子2：价格折扣计算
SELECT 
    product_name,
    price,
    IF(price > 100, price * 0.9, price) AS final_price
FROM products;

-- 例子3：库存状态显示
SELECT 
    product_name,
    stock,
    IF(stock > 0, '有货', '缺货') AS stock_status
FROM inventory;
```

### 2.4 IF的使用场景


| 场景 | 说明 | 示例 |
|------|------|------|
| **数据分类** | 根据数值范围分类 | `IF(age >= 18, '成人', '未成年')` |
| **状态判断** | 根据条件显示状态 | `IF(is_active = 1, '启用', '禁用')` |
| **计算逻辑** | 条件性计算 | `IF(vip = 1, price * 0.8, price)` |

> 💡 **小技巧**：IF语句可以嵌套使用，但建议不超过2层，否则用CASE更清晰

---

## 3. 🎛️ CASE多分支控制


### 3.1 CASE语句的作用


**通俗理解**：CASE就像是一个"多选题"，可以根据不同条件选择不同的结果

```
就像商店的会员等级：
普通会员 → 无折扣
银卡会员 → 9折
金卡会员 → 8.5折  
钻石会员 → 8折
```

### 3.2 CASE语法形式


**简单CASE语法**：
```sql
CASE 表达式
    WHEN 值1 THEN 结果1
    WHEN 值2 THEN 结果2
    ELSE 默认结果
END
```

**搜索CASE语法**：
```sql
CASE 
    WHEN 条件1 THEN 结果1
    WHEN 条件2 THEN 结果2
    ELSE 默认结果
END
```

### 3.3 CASE实际应用示例


```sql
-- 简单CASE：根据部门代码显示部门名称
SELECT 
    employee_name,
    dept_code,
    CASE dept_code
        WHEN 'IT' THEN '信息技术部'
        WHEN 'HR' THEN '人力资源部'
        WHEN 'FN' THEN '财务部'
        ELSE '其他部门'
    END AS dept_name
FROM employees;

-- 搜索CASE：根据成绩范围分等级
SELECT 
    student_name,
    score,
    CASE 
        WHEN score >= 90 THEN 'A优秀'
        WHEN score >= 80 THEN 'B良好'
        WHEN score >= 70 THEN 'C中等'
        WHEN score >= 60 THEN 'D及格'
        ELSE 'F不及格'
    END AS grade
FROM students;

-- 复杂CASE：订单状态处理
SELECT 
    order_id,
    order_date,
    total_amount,
    CASE 
        WHEN status = 1 AND DATEDIFF(NOW(), order_date) <= 7 THEN '新订单'
        WHEN status = 2 THEN '处理中'
        WHEN status = 3 THEN '已发货'
        WHEN status = 4 THEN '已完成'
        WHEN status = 0 THEN '已取消'
        ELSE '异常状态'
    END AS order_status
FROM orders;
```

### 3.4 CASE vs IF的选择


| 对比项 | IF | CASE |
|-------|----|----|
| **适用场景** | 简单二选一 | 多个条件分支 |
| **可读性** | 简单条件更清晰 | 复杂逻辑更清晰 |
| **性能** | 略快 | 复杂条件下更优 |
| **标准性** | MySQL特有 | SQL标准语法 |

---

## 4. ⏰ WHEN条件关键字


### 4.1 WHEN的含义


**简单理解**：WHEN就是"当...的时候"，用来定义触发条件

```
WHEN就像是开关：
WHEN 开关1打开 → 执行动作1  
WHEN 开关2打开 → 执行动作2
WHEN 开关3打开 → 执行动作3
```

### 4.2 WHEN的使用方式


**在CASE中使用**：
```sql
-- 方式1：值匹配
CASE column_name
    WHEN '值1' THEN '结果1'
    WHEN '值2' THEN '结果2'
END

-- 方式2：条件判断  
CASE
    WHEN 条件1 THEN '结果1'
    WHEN 条件2 THEN '结果2'
END
```

### 4.3 WHEN实际应用


```sql
-- 季度划分示例
SELECT 
    order_date,
    CASE 
        WHEN MONTH(order_date) IN (1,2,3) THEN '第一季度'
        WHEN MONTH(order_date) IN (4,5,6) THEN '第二季度'
        WHEN MONTH(order_date) IN (7,8,9) THEN '第三季度'
        WHEN MONTH(order_date) IN (10,11,12) THEN '第四季度'
    END AS quarter
FROM orders;

-- 年龄分组示例
SELECT 
    name,
    age,
    CASE 
        WHEN age < 18 THEN '未成年'
        WHEN age BETWEEN 18 AND 30 THEN '青年'
        WHEN age BETWEEN 31 AND 50 THEN '中年'  
        WHEN age > 50 THEN '老年'
    END AS age_group
FROM users;
```

> ⚠️ **注意事项**：WHEN条件按从上到下的顺序判断，一旦匹配就不再检查后续条件

---

## 5. ➡️ THEN执行关键字


### 5.1 THEN的作用


**通俗解释**：THEN就是"那么"的意思，跟在WHEN后面，表示"如果满足条件，那么执行什么"

```
完整逻辑链：
WHEN (当条件满足时) THEN (那么返回这个结果)

就像：
当天气下雨时，那么带伞出门
当余额不足时，那么显示"余额不足"
```

### 5.2 THEN的语法位置


```sql
-- THEN的固定搭配
CASE 
    WHEN 条件 THEN 结果  ← THEN紧跟在WHEN条件后
    WHEN 条件 THEN 结果
    ELSE 默认结果
END
```

### 5.3 THEN返回值类型


```sql
-- THEN可以返回不同类型的值

-- 1. 返回字符串
CASE 
    WHEN score >= 90 THEN '优秀'
    WHEN score >= 60 THEN '及格'
    ELSE '不及格'
END

-- 2. 返回数值
CASE 
    WHEN level = 'VIP' THEN price * 0.8
    WHEN level = 'Gold' THEN price * 0.9  
    ELSE price
END

-- 3. 返回NULL
CASE 
    WHEN status = 'deleted' THEN NULL
    ELSE content
END

-- 4. 返回计算结果
CASE 
    WHEN quantity > 100 THEN quantity * 0.95
    WHEN quantity > 50 THEN quantity * 0.98
    ELSE quantity
END
```

> 💡 **重要提示**：同一个CASE语句中，所有THEN的返回值类型应该保持一致

---

## 6. 🔄 ELSE默认分支


### 6.1 ELSE的重要性


**作用说明**：ELSE是"兜底"选项，当所有WHEN条件都不满足时的默认处理

```
生活例子：
如果是工作日 → 上班
如果是周末 → 休息  
其他情况(ELSE) → 按具体安排

SQL中：
WHEN 条件1 → 结果1
WHEN 条件2 → 结果2
ELSE → 默认结果 (兜底处理)
```

### 6.2 ELSE的使用建议


**最佳实践**：
- ✅ **总是添加ELSE** - 确保所有情况都有处理
- ✅ **ELSE返回有意义的值** - 不要返回无意义的内容
- ✅ **考虑异常情况** - ELSE处理非预期的数据

```sql
-- 好的做法：有ELSE兜底
SELECT 
    product_name,
    CASE category
        WHEN 'electronics' THEN '电子产品'
        WHEN 'clothing' THEN '服装'
        WHEN 'food' THEN '食品'
        ELSE '其他类别'  -- 处理新增的分类
    END AS category_name
FROM products;

-- 不好的做法：没有ELSE
SELECT 
    product_name,
    CASE category
        WHEN 'electronics' THEN '电子产品'
        WHEN 'clothing' THEN '服装'
    END AS category_name  -- 其他分类会返回NULL
FROM products;
```

### 6.3 ELSE的实际应用


```sql
-- 价格折扣策略
SELECT 
    customer_name,
    order_amount,
    CASE 
        WHEN customer_type = 'VIP' THEN order_amount * 0.8
        WHEN customer_type = 'Gold' THEN order_amount * 0.9
        WHEN order_amount > 1000 THEN order_amount * 0.95
        ELSE order_amount  -- 普通客户无折扣
    END AS final_amount
FROM orders;

-- 工作日判断
SELECT 
    DATE(now()) as today,
    CASE WEEKDAY(now())
        WHEN 0 THEN '星期一'
        WHEN 1 THEN '星期二'
        WHEN 2 THEN '星期三'
        WHEN 3 THEN '星期四'
        WHEN 4 THEN '星期五'
        WHEN 5 THEN '星期六'
        WHEN 6 THEN '星期日'
        ELSE '未知'  -- 理论上不会执行，但保险起见
    END as day_name;
```

---

## 7. 🏁 END结束标记


### 7.1 END的必要性


**作用说明**：END就像是"句号"，标记CASE语句的结束位置

```
CASE语句结构：
CASE 
    条件判断部分
    ...
END ← 必须有END来结束

就像：
{ 
    代码块内容
} ← 大括号结束标记
```

### 7.2 END的语法规则


**重要规则**：
- ⚠️ **每个CASE必须有对应的END**
- ⚠️ **END不能省略**
- ⚠️ **END后面可以跟别名**

```sql
-- 正确写法
SELECT 
    name,
    CASE 
        WHEN age < 18 THEN '未成年'
        ELSE '成年'
    END AS age_status  -- END后跟别名
FROM users;

-- 错误写法 - 缺少END
SELECT 
    name,
    CASE 
        WHEN age < 18 THEN '未成年'
        ELSE '成年'
    -- 缺少END，语法错误！
FROM users;
```

### 7.3 嵌套CASE中的END


```sql
-- 复杂嵌套示例：每个CASE都要有对应的END
SELECT 
    employee_name,
    CASE department
        WHEN 'IT' THEN 
            CASE level
                WHEN 'Senior' THEN '高级工程师'
                WHEN 'Junior' THEN '初级工程师'  
                ELSE '工程师'
            END  -- 内层CASE的END
        WHEN 'HR' THEN '人力资源'
        ELSE '其他部门'
    END AS position  -- 外层CASE的END
FROM employees;
```

> 💡 **记忆技巧**：把CASE...END看作一对括号，必须成对出现

---

## 8. 🔧 空值处理函数


### 8.1 为什么需要空值处理


**现实问题**：数据库中经常有NULL（空值），需要特殊处理

```
常见空值情况：
- 用户没填写手机号 → phone字段为NULL
- 商品没有折扣 → discount字段为NULL  
- 订单没有备注 → remark字段为NULL

问题：
- NULL参与运算结果为NULL
- NULL显示不美观
- NULL可能导致逻辑错误
```

## 8.2 IFNULL空值处理


### 8.2.1 IFNULL的作用


**通俗解释**：IFNULL就是"如果是空值，就用别的值代替"

**语法**：
```sql
IFNULL(表达式, 替换值)
```

### 8.2.2 IFNULL实际应用


```sql
-- 基本用法：处理空的手机号
SELECT 
    name,
    IFNULL(phone, '未提供') AS contact_phone
FROM users;

-- 数值计算：处理空的折扣
SELECT 
    product_name,
    price,
    IFNULL(discount, 0) AS discount_rate,
    price * (1 - IFNULL(discount, 0)) AS final_price
FROM products;

-- 字符串处理：处理空的描述
SELECT 
    title,
    IFNULL(description, '暂无描述') AS product_desc
FROM products;
```

### 8.2.3 IFNULL使用场景


| 场景 | 示例 | 说明 |
|------|------|------|
| **显示友好信息** | `IFNULL(phone, '未提供')` | 空值显示为有意义的文字 |
| **数值计算** | `IFNULL(discount, 0)` | 空值当作0参与计算 |
| **字符串拼接** | `IFNULL(middle_name, '')` | 避免拼接结果为NULL |

## 8.3 NULLIF相等置空


### 8.3.1 NULLIF的作用


**通俗解释**：NULLIF的作用是"如果两个值相等，就返回NULL，否则返回第一个值"

**语法**：
```sql
NULLIF(表达式1, 表达式2)
```

### 8.3.2 NULLIF实际应用


```sql
-- 处理默认值：将默认的0转为NULL
SELECT 
    product_name,
    NULLIF(discount, 0) AS actual_discount
FROM products;
-- 如果discount是0，返回NULL；否则返回discount的值

-- 处理空字符串：将空字符串转为NULL
SELECT 
    user_name,
    NULLIF(email, '') AS valid_email
FROM users;
-- 如果email是空字符串，返回NULL；否则返回email

-- 避免除零错误
SELECT 
    total_sales,
    order_count,
    total_sales / NULLIF(order_count, 0) AS avg_order_value
FROM sales_summary;
-- 当order_count为0时，NULLIF返回NULL，避免除零错误
```

### 8.3.3 NULLIF的典型场景


```
使用场景：
1. 将"无意义的默认值"转换为NULL
2. 避免除零运算错误
3. 数据清洗：统一空值表示方式
```

## 8.4 COALESCE空值合并


### 8.4.1 COALESCE的强大功能


**通俗解释**：COALESCE是"选择第一个不为空的值"，可以处理多个可能为空的字段

**语法**：
```sql
COALESCE(表达式1, 表达式2, 表达式3, ...)
```

### 8.4.2 COALESCE实际应用


```sql
-- 联系方式优先级：手机>座机>邮箱>默认提示
SELECT 
    user_name,
    COALESCE(mobile_phone, home_phone, email, '无联系方式') AS contact
FROM users;

-- 地址信息合并：详细地址>简要地址>默认地址
SELECT 
    user_name,
    COALESCE(detailed_address, simple_address, '地址不详') AS address
FROM user_addresses;

-- 价格优选：会员价>促销价>原价
SELECT 
    product_name,
    COALESCE(member_price, promo_price, original_price) AS display_price
FROM products;

-- 多语言显示：中文>英文>默认文本
SELECT 
    COALESCE(name_cn, name_en, 'Unknown') AS display_name
FROM products;
```

### 8.4.3 空值处理函数对比


| 函数 | 参数个数 | 作用 | 使用场景 |
|------|---------|------|----------|
| **IFNULL** | 2个 | 空值替换 | 简单的NULL值处理 |
| **NULLIF** | 2个 | 相等置空 | 将特定值转为NULL |
| **COALESCE** | 多个 | 选择首个非空值 | 多个字段的优先级选择 |

```sql
-- 三个函数的联合使用示例
SELECT 
    user_name,
    -- 1. COALESCE选择可用的联系方式
    COALESCE(mobile, phone, email) AS primary_contact,
    
    -- 2. IFNULL处理可能的空值
    IFNULL(address, '地址不详') AS user_address,
    
    -- 3. NULLIF将空字符串转为真正的NULL
    NULLIF(remark, '') AS valid_remark
FROM users;
```

---

## 9. 🚀 实际应用场景


### 9.1 电商系统中的应用


```sql
-- 商品价格显示逻辑
SELECT 
    product_id,
    product_name,
    CASE 
        WHEN is_on_sale = 1 AND sale_price IS NOT NULL THEN 
            CONCAT('￥', sale_price, ' (原价￥', original_price, ')')
        WHEN member_price IS NOT NULL AND user_type = 'member' THEN
            CONCAT('会员价￥', member_price)
        ELSE 
            CONCAT('￥', original_price)
    END AS display_price,
    
    -- 库存状态
    CASE 
        WHEN stock > 100 THEN '现货充足'
        WHEN stock > 10 THEN '库存紧张'  
        WHEN stock > 0 THEN '仅剩几件'
        ELSE '暂时缺货'
    END AS stock_status,
    
    -- 配送信息
    COALESCE(
        NULLIF(express_info, ''),
        '24小时内发货'
    ) AS delivery_info
FROM products;
```

### 9.2 用户管理系统应用


```sql
-- 用户信息完整度检查
SELECT 
    user_id,
    username,
    
    -- 联系方式完整性
    CASE 
        WHEN phone IS NOT NULL AND email IS NOT NULL THEN '联系方式完整'
        WHEN phone IS NOT NULL OR email IS NOT NULL THEN '联系方式部分完整'
        ELSE '缺少联系方式'
    END AS contact_status,
    
    -- 显示姓名
    COALESCE(
        NULLIF(CONCAT(IFNULL(first_name,''), ' ', IFNULL(last_name,'')), ' '),
        nickname, 
        username,
        '匿名用户'
    ) AS display_name,
    
    -- 账户状态
    IF(is_active = 1, '正常', '已禁用') AS account_status

FROM users;
```

### 9.3 订单系统应用


```sql
-- 订单状态和处理建议
SELECT 
    order_id,
    order_date,
    total_amount,
    
    -- 订单状态描述
    CASE status
        WHEN 1 THEN '待付款'
        WHEN 2 THEN '已付款'
        WHEN 3 THEN '配送中'
        WHEN 4 THEN '已完成'
        WHEN 5 THEN '已取消'
        ELSE '状态异常'
    END AS status_desc,
    
    -- 处理优先级
    CASE 
        WHEN status = 1 AND DATEDIFF(NOW(), order_date) > 3 THEN '超期未付款'
        WHEN status = 2 AND DATEDIFF(NOW(), order_date) > 7 THEN '长期未发货'
        WHEN status = 3 AND DATEDIFF(NOW(), ship_date) > 10 THEN '配送超时'
        ELSE '正常处理'
    END AS priority_flag,
    
    -- 客服备注
    IFNULL(
        NULLIF(customer_remark, ''),
        '无特殊要求'
    ) AS remark

FROM orders
WHERE order_date >= DATE_SUB(NOW(), INTERVAL 30 DAY);
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 IF条件判断：简单的二选一逻辑，语法简洁
🔸 CASE多分支：复杂的多条件选择，功能强大  
🔸 WHEN-THEN-ELSE：条件判断的基本逻辑结构
🔸 END结束标记：每个CASE都必须有对应的END
🔸 IFNULL：处理单个字段的空值替换
🔸 NULLIF：将特定值转换为NULL
🔸 COALESCE：从多个值中选择第一个非空值
```

### 10.2 使用选择指南


**何时用IF**：
- ✅ 简单的二选一判断
- ✅ 条件单一明确
- ✅ 追求代码简洁

**何时用CASE**：
- ✅ 多个条件分支
- ✅ 复杂的逻辑判断  
- ✅ 需要SQL标准兼容性

**空值处理选择**：
```
IFNULL → 简单替换：IFNULL(phone, '未提供')
NULLIF → 特值转空：NULLIF(discount, 0)  
COALESCE → 优先选择：COALESCE(mobile, phone, email)
```

### 10.3 最佳实践建议


**🔹 编写建议**：
```
1. 总是提供ELSE分支，确保所有情况都有处理
2. 保持THEN返回值类型一致
3. 复杂逻辑优先使用CASE而不是嵌套IF
4. 空值处理要考虑业务含义
5. 给CASE语句添加有意义的别名
```

**🔹 性能建议**：
```
1. 把最可能匹配的条件放在前面
2. 避免在WHEN中使用复杂的子查询
3. 考虑索引对CASE条件字段的影响
```

**🔹 可读性建议**：
```
1. 适当的缩进和换行
2. 添加注释说明业务逻辑
3. 避免过度嵌套，超过3层考虑拆分
```

### 10.4 实际应用价值


- **数据展示** - 将编码转换为用户友好的显示文本
- **业务逻辑** - 在SQL层面实现复杂的业务规则  
- **数据清洗** - 处理脏数据和空值
- **报表统计** - 根据条件进行分类汇总
- **系统集成** - 不同系统间的数据格式转换

**核心记忆口诀**：
- IF简单二选一，CASE复杂多分支
- WHEN定条件，THEN给结果，ELSE做兜底，END来结束
- IFNULL换空值，NULLIF置为空，COALESCE选最优