---
title: 60ã€å¤‡ä»½è‡ªåŠ¨åŒ–ç®¡ç†ä¸è°ƒåº¦
---
## ğŸ“š ç›®å½•

1. [å¤‡ä»½è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ](#1-å¤‡ä»½è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ)
2. [Shellè„šæœ¬å¤‡ä»½å®ç°](#2-Shellè„šæœ¬å¤‡ä»½å®ç°)
3. [Pythonå¤‡ä»½è„šæœ¬å¼€å‘](#3-Pythonå¤‡ä»½è„šæœ¬å¼€å‘)
4. [å®šæ—¶ä»»åŠ¡è°ƒåº¦é…ç½®](#4-å®šæ—¶ä»»åŠ¡è°ƒåº¦é…ç½®)
5. [å¤‡ä»½ç›‘æ§ä¸æŠ¥å‘Š](#5-å¤‡ä»½ç›‘æ§ä¸æŠ¥å‘Š)
6. [å¼‚å¸¸å¤„ç†ä¸æ¢å¤](#6-å¼‚å¸¸å¤„ç†ä¸æ¢å¤)
7. [é…ç½®æ–‡ä»¶ç®¡ç†](#7-é…ç½®æ–‡ä»¶ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¤‡ä»½è‡ªåŠ¨åŒ–åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤‡ä»½è‡ªåŠ¨åŒ–


**ç®€å•ç†è§£**ï¼šå¤‡ä»½è‡ªåŠ¨åŒ–å°±åƒç»™æ•°æ®åº“å®‰æ’ä¸€ä¸ª"å‹¤åŠ³çš„ä¿å§†"ï¼Œå®ƒä¼šæŒ‰ç…§è®¾å®šçš„æ—¶é—´å’Œè§„åˆ™ï¼Œè‡ªåŠ¨å®Œæˆå¤‡ä»½ã€æ£€æŸ¥ã€æ¸…ç†ç­‰å·¥ä½œï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

```
ä¼ ç»Ÿæ‰‹å·¥å¤‡ä»½ï¼š                    è‡ªåŠ¨åŒ–å¤‡ä»½ï¼š
ç®¡ç†å‘˜æ¯å¤©æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½              ç³»ç»Ÿè‡ªåŠ¨æŒ‰è®¡åˆ’æ‰§è¡Œ
â”œâ”€ å®¹æ˜“å¿˜è®°                      â”œâ”€ å®šæ—¶æ‰§è¡Œï¼Œä¸ä¼šé—æ¼
â”œâ”€ æ“ä½œå¯èƒ½å‡ºé”™                  â”œâ”€ æ ‡å‡†åŒ–æµç¨‹ï¼Œå‡å°‘é”™è¯¯
â”œâ”€ èŠ‚å‡æ—¥æ— äººå€¼å®ˆ                â”œâ”€ 7Ã—24å°æ—¶ä¸é—´æ–­
â””â”€ å¤‡ä»½è´¨é‡ä¸ç¨³å®š                â””â”€ å¤‡ä»½è´¨é‡æ ‡å‡†åŒ–
```

### 1.2 å¤‡ä»½è‡ªåŠ¨åŒ–çš„æ ¸å¿ƒä»·å€¼


**ğŸ”¸ å¯é æ€§ä¿éšœ**
- **æ—¶é—´å‡†ç¡®æ€§**ï¼šä¸¥æ ¼æŒ‰ç…§è®¡åˆ’æ‰§è¡Œï¼Œä¸ä¼šå› ä¸ºäººä¸ºå› ç´ å»¶è¯¯
- **æ“ä½œæ ‡å‡†åŒ–**ï¼šæ¯æ¬¡å¤‡ä»½éƒ½ä½¿ç”¨ç›¸åŒçš„å‚æ•°å’Œæµç¨‹
- **é”™è¯¯å‡å°‘**ï¼šé¿å…æ‰‹å·¥æ“ä½œä¸­çš„è¾“å…¥é”™è¯¯å’Œé—æ¼

**ğŸ”¸ æ•ˆç‡æå‡**
- **æ— äººå€¼å®ˆ**ï¼šèŠ‚å‡æ—¥å’Œå¤œé—´ä¹Ÿèƒ½æ­£å¸¸å¤‡ä»½
- **æ‰¹é‡å¤„ç†**ï¼šå¯ä»¥åŒæ—¶å¤‡ä»½å¤šä¸ªæ•°æ®åº“
- **èµ„æºä¼˜åŒ–**ï¼šåœ¨ç³»ç»Ÿè´Ÿè½½è¾ƒä½æ—¶è‡ªåŠ¨æ‰§è¡Œ

**ğŸ”¸ ç®¡ç†ä¾¿åˆ©**
- **ç»Ÿä¸€ç›‘æ§**ï¼šé›†ä¸­æŸ¥çœ‹æ‰€æœ‰å¤‡ä»½ä»»åŠ¡çŠ¶æ€
- **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¯æ¬¡å¤‡ä»½çš„æ‰§è¡Œæƒ…å†µ
- **æŠ¥å‘Šç”Ÿæˆ**ï¼šè‡ªåŠ¨ç”Ÿæˆå¤‡ä»½æˆåŠŸç‡æŠ¥å‘Š

### 1.3 è‡ªåŠ¨åŒ–å¤‡ä»½çš„åŸºæœ¬æµç¨‹


```
å¤‡ä»½è‡ªåŠ¨åŒ–å®Œæ•´æµç¨‹ï¼š

[å¯åŠ¨] â†’ [ç¯å¢ƒæ£€æŸ¥] â†’ [æ•°æ®åº“è¿æ¥æµ‹è¯•] â†’ [ç©ºé—´æ£€æŸ¥]
  â†“
[å¤‡ä»½æ‰§è¡Œ] â†’ [å¤‡ä»½éªŒè¯] â†’ [å‹ç¼©å¤„ç†] â†’ [å­˜å‚¨ç®¡ç†]
  â†“
[æ—¥å¿—è®°å½•] â†’ [çŠ¶æ€ç›‘æ§] â†’ [æŠ¥å‘Šç”Ÿæˆ] â†’ [å¼‚å¸¸å¤„ç†]
  â†“
[æ¸…ç†å·¥ä½œ] â†’ [ä¸‹æ¬¡è°ƒåº¦] â†’ [ç»“æŸ]
```

---

## 2. ğŸ”§ Shellè„šæœ¬å¤‡ä»½å®ç°


### 2.1 åŸºç¡€Shellå¤‡ä»½è„šæœ¬


**æ ¸å¿ƒæ€è·¯**ï¼šShellè„šæœ¬æ˜¯Linuxç³»ç»Ÿæœ€åŸºç¡€çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼Œè¯­æ³•ç®€å•ï¼Œé€‚åˆå¿«é€Ÿå®ç°å¤‡ä»½åŠŸèƒ½ã€‚

```bash
#!/bin/bash
# MySQLè‡ªåŠ¨å¤‡ä»½è„šæœ¬ - åŸºç¡€ç‰ˆæœ¬

# é…ç½®ä¿¡æ¯
DB_HOST="localhost"
DB_USER="backup_user"
DB_PASS="backup_password"
DB_NAME="production_db"
BACKUP_DIR="/data/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# æ‰§è¡Œå¤‡ä»½
echo "å¼€å§‹å¤‡ä»½æ•°æ®åº“: ${DB_NAME}"
mysqldump -h${DB_HOST} -u${DB_USER} -p${DB_PASS} \
    --single-transaction \
    --routines \
    --triggers \
    ${DB_NAME} > ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql

# æ£€æŸ¥å¤‡ä»½ç»“æœ
if [ $? -eq 0 ]; then
    echo "å¤‡ä»½æˆåŠŸ: ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql"
    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip ${BACKUP_DIR}/${DB_NAME}_${DATE}.sql
    echo "å¤‡ä»½å·²å‹ç¼©"
else
    echo "å¤‡ä»½å¤±è´¥ï¼"
    exit 1
fi
```

### 2.2 å¢å¼ºç‰ˆShellå¤‡ä»½è„šæœ¬


**åŠŸèƒ½æ‰©å±•**ï¼šå¢åŠ é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ã€ç©ºé—´æ£€æŸ¥ç­‰åŠŸèƒ½ï¼Œè®©è„šæœ¬æ›´åŠ ç¨³å®šå¯é ã€‚

```bash
#!/bin/bash
# MySQLå¢å¼ºç‰ˆè‡ªåŠ¨å¤‡ä»½è„šæœ¬

# ================== é…ç½®åŒºåŸŸ ==================
SCRIPT_DIR=$(dirname $0)
CONFIG_FILE="${SCRIPT_DIR}/backup.conf"
LOG_FILE="/var/log/mysql_backup.log"

# åŠ è½½é…ç½®æ–‡ä»¶
source ${CONFIG_FILE}

# ================== å‡½æ•°å®šä¹‰ ==================
# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a ${LOG_FILE}
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    log_message "é”™è¯¯: $1"
    send_alert "å¤‡ä»½å¤±è´¥: $1"
    exit 1
}

# ç©ºé—´æ£€æŸ¥å‡½æ•°
check_disk_space() {
    local required_space=$1
    local available_space=$(df ${BACKUP_DIR} | awk 'NR==2 {print $4}')
    
    if [ ${available_space} -lt ${required_space} ]; then
        error_exit "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦ ${required_space}KBï¼Œå¯ç”¨ ${available_space}KB"
    fi
    log_message "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡"
}

# æ•°æ®åº“è¿æ¥æµ‹è¯•
test_db_connection() {
    mysql -h${DB_HOST} -u${DB_USER} -p${DB_PASS} -e "SELECT 1;" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        error_exit "æ•°æ®åº“è¿æ¥å¤±è´¥"
    fi
    log_message "æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ"
}

# ================== ä¸»è¦é€»è¾‘ ==================
log_message "å¼€å§‹æ‰§è¡Œè‡ªåŠ¨å¤‡ä»½è„šæœ¬"

# 1. ç¯å¢ƒæ£€æŸ¥
test_db_connection
check_disk_space 1000000  # æ£€æŸ¥æ˜¯å¦æœ‰1GBå¯ç”¨ç©ºé—´

# 2. æ‰§è¡Œå¤‡ä»½
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.sql"
log_message "å¼€å§‹å¤‡ä»½æ•°æ®åº“: ${DB_NAME}"

mysqldump -h${DB_HOST} -u${DB_USER} -p${DB_PASS} \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --master-data=2 \
    ${DB_NAME} > ${BACKUP_FILE}

if [ $? -eq 0 ]; then
    log_message "å¤‡ä»½å®Œæˆ: ${BACKUP_FILE}"
    
    # 3. å‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip ${BACKUP_FILE}
    log_message "å¤‡ä»½æ–‡ä»¶å·²å‹ç¼©"
    
    # 4. éªŒè¯å¤‡ä»½æ–‡ä»¶
    if [ -f "${BACKUP_FILE}.gz" ]; then
        BACKUP_SIZE=$(du -h "${BACKUP_FILE}.gz" | cut -f1)
        log_message "å¤‡ä»½éªŒè¯æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: ${BACKUP_SIZE}"
    else
        error_exit "å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥"
    fi
else
    error_exit "mysqldump æ‰§è¡Œå¤±è´¥"
fi

log_message "å¤‡ä»½è„šæœ¬æ‰§è¡Œå®Œæˆ"
```

### 2.3 è„šæœ¬å‚æ•°åŒ–è®¾è®¡


**è®¾è®¡æ€è·¯**ï¼šé€šè¿‡å‚æ•°åŒ–è®©è„šæœ¬æ›´åŠ çµæ´»ï¼Œå¯ä»¥æ ¹æ®ä¸åŒéœ€æ±‚è°ƒæ•´å¤‡ä»½ç­–ç•¥ã€‚

```bash
#!/bin/bash
# å‚æ•°åŒ–å¤‡ä»½è„šæœ¬

# ä½¿ç”¨æ–¹æ³•å±•ç¤º
show_usage() {
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹:"
    echo "  -d, --database    æŒ‡å®šæ•°æ®åº“åç§°"
    echo "  -h, --host        æ•°æ®åº“ä¸»æœºåœ°å€"
    echo "  -u, --user        æ•°æ®åº“ç”¨æˆ·å"
    echo "  -t, --type        å¤‡ä»½ç±»å‹ (full|incremental)"
    echo "  -c, --compress    æ˜¯å¦å‹ç¼© (yes|no)"
    echo "  --help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 -d mydb -h localhost -u backup_user -t full -c yes"
}

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--database)
            DB_NAME="$2"
            shift 2
            ;;
        -h|--host)
            DB_HOST="$2"
            shift 2
            ;;
        -u|--user)
            DB_USER="$2"
            shift 2
            ;;
        -t|--type)
            BACKUP_TYPE="$2"
            shift 2
            ;;
        -c|--compress)
            COMPRESS="$2"
            shift 2
            ;;
        --help)
            show_usage
            exit 0
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1"
            show_usage
            exit 1
            ;;
    esac
done

# å‚æ•°éªŒè¯
if [ -z "${DB_NAME}" ]; then
    echo "é”™è¯¯: å¿…é¡»æŒ‡å®šæ•°æ®åº“åç§°"
    show_usage
    exit 1
fi

# æ ¹æ®å¤‡ä»½ç±»å‹æ‰§è¡Œä¸åŒé€»è¾‘
case ${BACKUP_TYPE} in
    "full")
        # å…¨é‡å¤‡ä»½é€»è¾‘
        BACKUP_OPTIONS="--single-transaction --routines --triggers"
        ;;
    "incremental")
        # å¢é‡å¤‡ä»½é€»è¾‘
        BACKUP_OPTIONS="--single-transaction --master-data=2"
        ;;
    *)
        echo "é”™è¯¯: ä¸æ”¯æŒçš„å¤‡ä»½ç±»å‹ ${BACKUP_TYPE}"
        exit 1
        ;;
esac
```

---

## 3. ğŸ Pythonå¤‡ä»½è„šæœ¬å¼€å‘


### 3.1 Pythonå¤‡ä»½çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆé€‰æ‹©Python**ï¼š
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šæœ‰å¤§é‡çš„ç¬¬ä¸‰æ–¹åº“æ”¯æŒæ•°æ®åº“æ“ä½œã€æ—¥å¿—å¤„ç†ç­‰
- **é”™è¯¯å¤„ç†**ï¼šå¼‚å¸¸å¤„ç†æœºåˆ¶æ›´å®Œå–„ï¼Œä»£ç æ›´å¥å£®
- **æ‰©å±•æ€§å¥½**ï¼šé¢å‘å¯¹è±¡è®¾è®¡ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤
- **è·¨å¹³å°**ï¼šWindowså’ŒLinuxéƒ½èƒ½è¿è¡Œ

### 3.2 åŸºç¡€Pythonå¤‡ä»½è„šæœ¬


```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
MySQLè‡ªåŠ¨å¤‡ä»½è„šæœ¬ - Pythonç‰ˆæœ¬
æä¾›æ›´å¼ºå¤§çš„é”™è¯¯å¤„ç†å’ŒåŠŸèƒ½æ‰©å±•èƒ½åŠ›
"""

import os
import sys
import subprocess
import datetime
import logging
import configparser
from pathlib import Path

class MySQLBackup:
    def __init__(self, config_file="backup.ini"):
        """åˆå§‹åŒ–å¤‡ä»½ç±»"""
        self.config = configparser.ConfigParser()
        self.config.read(config_file)
        
        # è¯»å–é…ç½®
        self.db_host = self.config.get('database', 'host')
        self.db_user = self.config.get('database', 'user')
        self.db_password = self.config.get('database', 'password')
        self.db_name = self.config.get('database', 'name')
        self.backup_dir = self.config.get('backup', 'directory')
        
        # è®¾ç½®æ—¥å¿—
        self.setup_logging()
        
    def setup_logging(self):
        """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
        log_file = self.config.get('logging', 'file', fallback='/var/log/mysql_backup.log')
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler(log_file),
                logging.StreamHandler(sys.stdout)
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    def check_prerequisites(self):
        """æ£€æŸ¥å¤‡ä»½å‰ç½®æ¡ä»¶"""
        # æ£€æŸ¥å¤‡ä»½ç›®å½•
        backup_path = Path(self.backup_dir)
        if not backup_path.exists():
            backup_path.mkdir(parents=True, exist_ok=True)
            self.logger.info(f"åˆ›å»ºå¤‡ä»½ç›®å½•: {self.backup_dir}")
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼ˆè‡³å°‘1GBï¼‰
        disk_usage = os.statvfs(self.backup_dir)
        free_space = disk_usage.f_frsize * disk_usage.f_bavail
        if free_space < 1024 * 1024 * 1024:  # 1GB
            raise Exception(f"ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¯ç”¨ç©ºé—´: {free_space / (1024**3):.2f}GB")
        
        self.logger.info("å‰ç½®æ¡ä»¶æ£€æŸ¥é€šè¿‡")
    
    def test_connection(self):
        """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
        test_cmd = [
            'mysql',
            f'-h{self.db_host}',
            f'-u{self.db_user}',
            f'-p{self.db_password}',
            '-e', 'SELECT 1;'
        ]
        
        try:
            result = subprocess.run(test_cmd, capture_output=True, check=True)
            self.logger.info("æ•°æ®åº“è¿æ¥æµ‹è¯•æˆåŠŸ")
        except subprocess.CalledProcessError as e:
            raise Exception(f"æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
    
    def perform_backup(self):
        """æ‰§è¡Œæ•°æ®åº“å¤‡ä»½"""
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_filename = f"{self.db_name}_{timestamp}.sql"
        backup_path = os.path.join(self.backup_dir, backup_filename)
        
        # æ„å»ºmysqldumpå‘½ä»¤
        dump_cmd = [
            'mysqldump',
            f'-h{self.db_host}',
            f'-u{self.db_user}',
            f'-p{self.db_password}',
            '--single-transaction',
            '--routines',
            '--triggers',
            '--events',
            self.db_name
        ]
        
        self.logger.info(f"å¼€å§‹å¤‡ä»½æ•°æ®åº“: {self.db_name}")
        
        try:
            with open(backup_path, 'w') as backup_file:
                result = subprocess.run(dump_cmd, stdout=backup_file, 
                                      stderr=subprocess.PIPE, check=True)
            
            self.logger.info(f"å¤‡ä»½å®Œæˆ: {backup_path}")
            return backup_path
            
        except subprocess.CalledProcessError as e:
            raise Exception(f"å¤‡ä»½æ‰§è¡Œå¤±è´¥: {e.stderr.decode()}")
    
    def compress_backup(self, backup_path):
        """å‹ç¼©å¤‡ä»½æ–‡ä»¶"""
        try:
            compress_cmd = ['gzip', backup_path]
            subprocess.run(compress_cmd, check=True)
            compressed_path = f"{backup_path}.gz"
            
            # è·å–å‹ç¼©åæ–‡ä»¶å¤§å°
            file_size = os.path.getsize(compressed_path)
            size_mb = file_size / (1024 * 1024)
            
            self.logger.info(f"å¤‡ä»½æ–‡ä»¶å·²å‹ç¼©: {compressed_path}, å¤§å°: {size_mb:.2f}MB")
            return compressed_path
            
        except subprocess.CalledProcessError as e:
            raise Exception(f"æ–‡ä»¶å‹ç¼©å¤±è´¥: {e}")
    
    def run_backup(self):
        """è¿è¡Œå®Œæ•´å¤‡ä»½æµç¨‹"""
        try:
            self.logger.info("å¼€å§‹æ‰§è¡Œè‡ªåŠ¨å¤‡ä»½")
            
            # 1. æ£€æŸ¥å‰ç½®æ¡ä»¶
            self.check_prerequisites()
            
            # 2. æµ‹è¯•æ•°æ®åº“è¿æ¥
            self.test_connection()
            
            # 3. æ‰§è¡Œå¤‡ä»½
            backup_path = self.perform_backup()
            
            # 4. å‹ç¼©å¤‡ä»½æ–‡ä»¶
            compressed_path = self.compress_backup(backup_path)
            
            self.logger.info("è‡ªåŠ¨å¤‡ä»½æ‰§è¡ŒæˆåŠŸ")
            return compressed_path
            
        except Exception as e:
            self.logger.error(f"å¤‡ä»½å¤±è´¥: {e}")
            # è¿™é‡Œå¯ä»¥æ·»åŠ å‘Šè­¦é€šçŸ¥é€»è¾‘
            raise

# ä¸»ç¨‹åºå…¥å£
if __name__ == "__main__":
    try:
        backup = MySQLBackup()
        backup.run_backup()
    except Exception as e:
        print(f"å¤‡ä»½ç¨‹åºå¼‚å¸¸é€€å‡º: {e}")
        sys.exit(1)
```

### 3.3 é…ç½®æ–‡ä»¶ç®¡ç†


**é…ç½®æ–‡ä»¶ç¤ºä¾‹** (`backup.ini`)ï¼š
```ini
[database]
host = localhost
port = 3306
user = backup_user
password = your_password
name = production_db

[backup]
directory = /data/backup/mysql
compress = true
keep_days = 30

[logging]
file = /var/log/mysql_backup.log
level = INFO

[notification]
email_enabled = true
email_to = admin@company.com
smtp_server = mail.company.com
smtp_port = 587
```

---

## 4. â° å®šæ—¶ä»»åŠ¡è°ƒåº¦é…ç½®


### 4.1 Linux Cronå®šæ—¶ä»»åŠ¡


**CronåŸºæœ¬æ¦‚å¿µ**ï¼šCronæ˜¯Linuxç³»ç»Ÿçš„å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå¯ä»¥è®©æˆ‘ä»¬è®¾å®šåœ¨ç‰¹å®šæ—¶é—´è‡ªåŠ¨æ‰§è¡Œè„šæœ¬ã€‚

```bash
# Cronæ—¶é—´æ ¼å¼è¯´æ˜
# åˆ†é’Ÿ(0-59) å°æ—¶(0-23) æ—¥æœŸ(1-31) æœˆä»½(1-12) æ˜ŸæœŸ(0-7)

# å¸¸ç”¨å®šæ—¶è®¾ç½®ç¤ºä¾‹ï¼š
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /path/to/backup_script.sh

# æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹å¤‡ä»½
0 3 * * 0 /path/to/backup_script.sh

# æ¯å¤©å‡Œæ™¨2ç‚¹å’Œ14ç‚¹å¤‡ä»½
0 2,14 * * * /path/to/backup_script.sh

# å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰æ¯å¤©22ç‚¹å¤‡ä»½
0 22 * * 1-5 /path/to/backup_script.sh

# æ¯å°æ—¶çš„ç¬¬30åˆ†é’Ÿæ‰§è¡Œï¼ˆå¢é‡å¤‡ä»½ï¼‰
30 * * * * /path/to/incremental_backup.sh
```

**å®é™…é…ç½®æ­¥éª¤**ï¼š
```bash
# 1. ç¼–è¾‘crontab
crontab -e

# 2. æ·»åŠ å¤‡ä»½ä»»åŠ¡
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå®Œæ•´å¤‡ä»½
0 2 * * * /opt/scripts/mysql_backup.sh >> /var/log/cron_backup.log 2>&1

# 3. æŸ¥çœ‹å½“å‰å®šæ—¶ä»»åŠ¡
crontab -l

# 4. é‡å¯cronæœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
systemctl restart crond
```

### 4.2 é«˜çº§è°ƒåº¦é…ç½®


**å¤šæ•°æ®åº“å¤‡ä»½è°ƒåº¦**ï¼š
```bash
#!/bin/bash
# å¤šæ•°æ®åº“å¤‡ä»½è°ƒåº¦è„šæœ¬

DATABASES=("db1" "db2" "db3" "db4")
SCRIPT_DIR="/opt/scripts"

for db in "${DATABASES[@]}"; do
    echo "å¼€å§‹å¤‡ä»½æ•°æ®åº“: $db"
    
    # ä¸ºæ¯ä¸ªæ•°æ®åº“è®¾ç½®ä¸åŒçš„å¼€å§‹æ—¶é—´ï¼Œé¿å…èµ„æºå†²çª
    ${SCRIPT_DIR}/mysql_backup.py --database=$db
    
    # ç­‰å¾…5åˆ†é’Ÿå†å¤‡ä»½ä¸‹ä¸€ä¸ªæ•°æ®åº“
    sleep 300
done
```

**åˆ†æ—¶æ®µå¤‡ä»½ç­–ç•¥**ï¼š
```bash
# /etc/crontab ä¸­çš„é«˜çº§é…ç½®

# å…¨é‡å¤‡ä»½ï¼šæ¯å‘¨æ—¥å‡Œæ™¨è¿›è¡Œ
0 1 * * 0 backup_user /opt/scripts/full_backup.sh

# å¢é‡å¤‡ä»½ï¼šå·¥ä½œæ—¥æ¯2å°æ—¶è¿›è¡Œ
0 */2 * * 1-5 backup_user /opt/scripts/incremental_backup.sh

# æ—¥å¿—å¤‡ä»½ï¼šæ¯å¤©23ç‚¹å¤‡ä»½MySQL binlog
0 23 * * * backup_user /opt/scripts/binlog_backup.sh

# å¤‡ä»½éªŒè¯ï¼šæ¯å¤©ä¸Šåˆ9ç‚¹éªŒè¯å‰ä¸€å¤©çš„å¤‡ä»½
0 9 * * * backup_user /opt/scripts/verify_backup.sh
```

---

## 5. ğŸ“Š å¤‡ä»½ç›‘æ§ä¸æŠ¥å‘Š


### 5.1 å¤‡ä»½çŠ¶æ€ç›‘æ§


**ç›‘æ§è„šæœ¬æ€è·¯**ï¼šé€šè¿‡æ£€æŸ¥å¤‡ä»½æ–‡ä»¶ã€æ—¥å¿—è®°å½•æ¥åˆ¤æ–­å¤‡ä»½æ˜¯å¦æˆåŠŸï¼Œå¹¶ç”ŸæˆçŠ¶æ€æŠ¥å‘Šã€‚

```bash
#!/bin/bash
# å¤‡ä»½ç›‘æ§è„šæœ¬

BACKUP_DIR="/data/backup/mysql"
LOG_FILE="/var/log/mysql_backup.log"
REPORT_FILE="/tmp/backup_report.txt"

# æ£€æŸ¥ä»Šå¤©çš„å¤‡ä»½æ–‡ä»¶
check_today_backup() {
    local today=$(date +%Y%m%d)
    local backup_files=$(find ${BACKUP_DIR} -name "*${today}*.gz" 2>/dev/null)
    
    if [ -n "$backup_files" ]; then
        echo "âœ… ä»Šæ—¥å¤‡ä»½æ–‡ä»¶å­˜åœ¨:"
        echo "$backup_files" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "   $file (å¤§å°: $size)"
        done
    else
        echo "âŒ ä»Šæ—¥å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨"
    fi
}

# æ£€æŸ¥å¤‡ä»½æ—¥å¿—
check_backup_log() {
    local today=$(date +%Y-%m-%d)
    local success_count=$(grep "$today.*å¤‡ä»½å®Œæˆ" ${LOG_FILE} | wc -l)
    local error_count=$(grep "$today.*é”™è¯¯" ${LOG_FILE} | wc -l)
    
    echo "ğŸ“‹ ä»Šæ—¥å¤‡ä»½æ—¥å¿—ç»Ÿè®¡:"
    echo "   æˆåŠŸæ¬¡æ•°: $success_count"
    echo "   é”™è¯¯æ¬¡æ•°: $error_count"
    
    if [ $error_count -gt 0 ]; then
        echo "âŒ å‘ç°å¤‡ä»½é”™è¯¯ï¼Œæœ€æ–°é”™è¯¯ä¿¡æ¯:"
        grep "$today.*é”™è¯¯" ${LOG_FILE} | tail -3
    fi
}

# ç”Ÿæˆç›‘æ§æŠ¥å‘Š
generate_report() {
    echo "=== MySQLå¤‡ä»½ç›‘æ§æŠ¥å‘Š ===" > ${REPORT_FILE}
    echo "ç”Ÿæˆæ—¶é—´: $(date)" >> ${REPORT_FILE}
    echo "" >> ${REPORT_FILE}
    
    check_today_backup >> ${REPORT_FILE}
    echo "" >> ${REPORT_FILE}
    check_backup_log >> ${REPORT_FILE}
    
    # è¾“å‡ºåˆ°æ§åˆ¶å°
    cat ${REPORT_FILE}
}

generate_report
```

### 5.2 è‡ªåŠ¨æŠ¥å‘Šç”Ÿæˆ


**Pythonç‰ˆæœ¬çš„æŠ¥å‘Šç”Ÿæˆå™¨**ï¼š
```python
#!/usr/bin/env python3
"""
MySQLå¤‡ä»½æŠ¥å‘Šç”Ÿæˆå™¨
ç”Ÿæˆè¯¦ç»†çš„å¤‡ä»½çŠ¶æ€æŠ¥å‘Šå¹¶æ”¯æŒé‚®ä»¶å‘é€
"""

import os
import glob
import datetime
import smtplib
from email.mime.text import MimeText
from email.mime.multipart import MimeMultipart

class BackupReporter:
    def __init__(self):
        self.backup_dir = "/data/backup/mysql"
        self.log_file = "/var/log/mysql_backup.log"
        
    def get_backup_status(self, days=7):
        """è·å–æœ€è¿‘å‡ å¤©çš„å¤‡ä»½çŠ¶æ€"""
        status_report = []
        
        for i in range(days):
            check_date = datetime.datetime.now() - datetime.timedelta(days=i)
            date_str = check_date.strftime("%Y%m%d")
            
            # æŸ¥æ‰¾å½“å¤©çš„å¤‡ä»½æ–‡ä»¶
            backup_pattern = os.path.join(self.backup_dir, f"*{date_str}*.gz")
            backup_files = glob.glob(backup_pattern)
            
            if backup_files:
                total_size = sum(os.path.getsize(f) for f in backup_files)
                size_mb = total_size / (1024 * 1024)
                status = {
                    'date': check_date.strftime("%Y-%m-%d"),
                    'status': 'æˆåŠŸ',
                    'file_count': len(backup_files),
                    'total_size': f"{size_mb:.2f}MB"
                }
            else:
                status = {
                    'date': check_date.strftime("%Y-%m-%d"),
                    'status': 'å¤±è´¥',
                    'file_count': 0,
                    'total_size': '0MB'
                }
            
            status_report.append(status)
        
        return status_report
    
    def generate_html_report(self):
        """ç”ŸæˆHTMLæ ¼å¼çš„æŠ¥å‘Š"""
        status_data = self.get_backup_status()
        
        html = """
        <html>
        <head>
            <title>MySQLå¤‡ä»½çŠ¶æ€æŠ¥å‘Š</title>
            <style>
                table { border-collapse: collapse; width: 100%; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .success { color: green; }
                .failed { color: red; }
            </style>
        </head>
        <body>
            <h2>MySQLå¤‡ä»½çŠ¶æ€æŠ¥å‘Š</h2>
            <p>æŠ¥å‘Šç”Ÿæˆæ—¶é—´: """ + datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S") + """</p>
            
            <table>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>å¤‡ä»½çŠ¶æ€</th>
                    <th>æ–‡ä»¶æ•°é‡</th>
                    <th>æ€»å¤§å°</th>
                </tr>
        """
        
        for item in status_data:
            status_class = "success" if item['status'] == 'æˆåŠŸ' else "failed"
            html += f"""
                <tr>
                    <td>{item['date']}</td>
                    <td class="{status_class}">{item['status']}</td>
                    <td>{item['file_count']}</td>
                    <td>{item['total_size']}</td>
                </tr>
            """
        
        html += """
            </table>
        </body>
        </html>
        """
        
        return html
    
    def send_email_report(self, to_email, smtp_config):
        """å‘é€é‚®ä»¶æŠ¥å‘Š"""
        html_report = self.generate_html_report()
        
        msg = MimeMultipart()
        msg['From'] = smtp_config['username']
        msg['To'] = to_email
        msg['Subject'] = f"MySQLå¤‡ä»½æŠ¥å‘Š - {datetime.datetime.now().strftime('%Y-%m-%d')}"
        
        msg.attach(MimeText(html_report, 'html'))
        
        try:
            server = smtplib.SMTP(smtp_config['server'], smtp_config['port'])
            server.starttls()
            server.login(smtp_config['username'], smtp_config['password'])
            server.send_message(msg)
            server.quit()
            print("é‚®ä»¶æŠ¥å‘Šå‘é€æˆåŠŸ")
        except Exception as e:
            print(f"é‚®ä»¶å‘é€å¤±è´¥: {e}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    reporter = BackupReporter()
    
    # ç”Ÿæˆå¹¶ä¿å­˜HTMLæŠ¥å‘Š
    html_report = reporter.generate_html_report()
    with open("/tmp/backup_report.html", "w") as f:
        f.write(html_report)
    
    print("å¤‡ä»½æŠ¥å‘Šå·²ç”Ÿæˆ: /tmp/backup_report.html")
```

---

## 6. ğŸš¨ å¼‚å¸¸å¤„ç†ä¸æ¢å¤


### 6.1 å¸¸è§å¤‡ä»½å¼‚å¸¸ç±»å‹


**å¼‚å¸¸åˆ†ç±»ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| å¼‚å¸¸ç±»å‹ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** | **é¢„é˜²æªæ–½** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **è¿æ¥å¤±è´¥** | `æ•°æ®åº“æœåŠ¡åœæ­¢ï¼Œç½‘ç»œé—®é¢˜` | `é‡è¯•æœºåˆ¶ï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€` | `è¿æ¥æ± ï¼Œå¥åº·æ£€æŸ¥` |
| ğŸ”¸ **ç©ºé—´ä¸è¶³** | `ç£ç›˜ç©ºé—´è€—å°½` | `æ¸…ç†æ—§å¤‡ä»½ï¼Œæ‰©å®¹å­˜å‚¨` | `ç©ºé—´ç›‘æ§ï¼Œè‡ªåŠ¨æ¸…ç†` |
| ğŸ”¸ **æƒé™é”™è¯¯** | `å¤‡ä»½ç”¨æˆ·æƒé™ä¸è¶³` | `æ£€æŸ¥ç”¨æˆ·æƒé™ï¼Œé‡æ–°æˆæƒ` | `æƒé™æµ‹è¯•ï¼Œå®šæœŸæ£€æŸ¥` |
| ğŸ”¸ **æ–‡ä»¶æŸå** | `å­˜å‚¨ä»‹è´¨æ•…éšœï¼Œä¼ è¾“é”™è¯¯` | `é‡æ–°å¤‡ä»½ï¼ŒéªŒè¯æ ¡éªŒå’Œ` | `å¤šé‡å¤‡ä»½ï¼Œå®Œæ•´æ€§éªŒè¯` |

### 6.2 æ™ºèƒ½å¼‚å¸¸å¤„ç†è„šæœ¬


```bash
#!/bin/bash
# å¸¦å¼‚å¸¸å¤„ç†çš„æ™ºèƒ½å¤‡ä»½è„šæœ¬

BACKUP_DIR="/data/backup/mysql"
LOG_FILE="/var/log/mysql_backup.log"
MAX_RETRY=3
RETRY_INTERVAL=300  # é‡è¯•é—´éš”5åˆ†é’Ÿ

# é‡è¯•å‡½æ•°
retry_command() {
    local command="$1"
    local description="$2"
    local retry_count=0
    
    while [ $retry_count -lt $MAX_RETRY ]; do
        echo "å°è¯•æ‰§è¡Œ: $description (ç¬¬ $((retry_count + 1)) æ¬¡)"
        
        if eval "$command"; then
            echo "$description æ‰§è¡ŒæˆåŠŸ"
            return 0
        else
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $MAX_RETRY ]; then
                echo "$description å¤±è´¥ï¼Œ${RETRY_INTERVAL}ç§’åé‡è¯•..."
                sleep $RETRY_INTERVAL
            fi
        fi
    done
    
    echo "$description é‡è¯• $MAX_RETRY æ¬¡åä»ç„¶å¤±è´¥"
    return 1
}

# ç©ºé—´æ£€æŸ¥å’Œæ¸…ç†
ensure_backup_space() {
    local required_space_gb=2
    local available_space=$(df -BG $BACKUP_DIR | awk 'NR==2 {print $4}' | sed 's/G//')
    
    if [ $available_space -lt $required_space_gb ]; then
        echo "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¼€å§‹æ¸…ç†æ—§å¤‡ä»½..."
        
        # åˆ é™¤7å¤©å‰çš„å¤‡ä»½æ–‡ä»¶
        find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
        
        # é‡æ–°æ£€æŸ¥ç©ºé—´
        available_space=$(df -BG $BACKUP_DIR | awk 'NR==2 {print $4}' | sed 's/G//')
        if [ $available_space -lt $required_space_gb ]; then
            echo "æ¸…ç†åç©ºé—´ä»ä¸è¶³ï¼Œè¯·æ‰‹åŠ¨å¤„ç†"
            return 1
        fi
    fi
    
    echo "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼Œå¯ç”¨ç©ºé—´: ${available_space}GB"
    return 0
}

# æ•°æ®åº“æœåŠ¡æ£€æŸ¥
check_mysql_service() {
    if ! systemctl is-active --quiet mysql; then
        echo "MySQLæœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
        if systemctl start mysql; then
            echo "MySQLæœåŠ¡å¯åŠ¨æˆåŠŸ"
            sleep 10  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        else
            echo "MySQLæœåŠ¡å¯åŠ¨å¤±è´¥"
            return 1
        fi
    fi
    return 0
}

# ä¸»å¤‡ä»½æµç¨‹
main_backup_process() {
    # 1. æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€
    if ! retry_command "check_mysql_service" "MySQLæœåŠ¡æ£€æŸ¥"; then
        echo "MySQLæœåŠ¡å¼‚å¸¸ï¼Œå¤‡ä»½ç»ˆæ­¢"
        return 1
    fi
    
    # 2. æ£€æŸ¥å’Œæ¸…ç†ç£ç›˜ç©ºé—´
    if ! ensure_backup_space; then
        echo "ç£ç›˜ç©ºé—´é—®é¢˜ï¼Œå¤‡ä»½ç»ˆæ­¢"
        return 1
    fi
    
    # 3. æ‰§è¡Œå¤‡ä»½
    local backup_command="mysqldump -ubackup_user -ppassword --single-transaction production_db > ${BACKUP_DIR}/backup_$(date +%Y%m%d_%H%M%S).sql"
    
    if retry_command "$backup_command" "æ•°æ®åº“å¤‡ä»½"; then
        echo "å¤‡ä»½æˆåŠŸå®Œæˆ"
        return 0
    else
        echo "å¤‡ä»½æœ€ç»ˆå¤±è´¥"
        return 1
    fi
}

# å¼‚å¸¸é€šçŸ¥
send_alert() {
    local message="$1"
    echo "$message" | mail -s "MySQLå¤‡ä»½å¼‚å¸¸å‘Šè­¦" admin@company.com
    # ä¹Ÿå¯ä»¥é›†æˆä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰é€šçŸ¥æ–¹å¼
}

# ä¸»ç¨‹åº
echo "[$(date)] å¼€å§‹æ‰§è¡Œå¤‡ä»½ä»»åŠ¡" | tee -a $LOG_FILE

if main_backup_process; then
    echo "[$(date)] å¤‡ä»½ä»»åŠ¡æˆåŠŸå®Œæˆ" | tee -a $LOG_FILE
else
    error_msg="[$(date)] å¤‡ä»½ä»»åŠ¡å¤±è´¥"
    echo "$error_msg" | tee -a $LOG_FILE
    send_alert "$error_msg"
    exit 1
fi
```

### 6.3 å¤‡ä»½éªŒè¯è‡ªåŠ¨åŒ–


**å¤‡ä»½å®Œæ•´æ€§éªŒè¯è„šæœ¬**ï¼š
```python
#!/usr/bin/env python3
"""
å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§éªŒè¯è„šæœ¬
ç¡®ä¿å¤‡ä»½æ–‡ä»¶å¯ä»¥æ­£å¸¸ä½¿ç”¨
"""

import os
import subprocess
import tempfile
import mysql.connector
from pathlib import Path

class BackupValidator:
    def __init__(self, backup_file):
        self.backup_file = backup_file
        self.test_db_name = "backup_test_" + str(os.getpid())
        
    def validate_sql_syntax(self):
        """éªŒè¯SQLæ–‡ä»¶è¯­æ³•"""
        try:
            # ä½¿ç”¨mysqlå‘½ä»¤éªŒè¯è¯­æ³•ï¼ˆä¸æ‰§è¡Œï¼‰
            cmd = ['mysql', '--force', '--batch', '-e', f'source {self.backup_file}']
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode == 0:
                print("âœ… SQLè¯­æ³•éªŒè¯é€šè¿‡")
                return True
            else:
                print(f"âŒ SQLè¯­æ³•éªŒè¯å¤±è´¥: {result.stderr}")
                return False
                
        except Exception as e:
            print(f"âŒ è¯­æ³•éªŒè¯å¼‚å¸¸: {e}")
            return False
    
    def test_restore(self):
        """æµ‹è¯•æ¢å¤åŠŸèƒ½"""
        try:
            # åˆ›å»ºæµ‹è¯•æ•°æ®åº“
            connection = mysql.connector.connect(
                host='localhost',
                user='root',
                password='password'
            )
            cursor = connection.cursor()
            cursor.execute(f"CREATE DATABASE IF NOT EXISTS {self.test_db_name}")
            connection.close()
            
            # æ¢å¤å¤‡ä»½åˆ°æµ‹è¯•æ•°æ®åº“
            restore_cmd = f"mysql {self.test_db_name} < {self.backup_file}"
            result = subprocess.run(restore_cmd, shell=True, capture_output=True)
            
            if result.returncode == 0:
                print("âœ… å¤‡ä»½æ¢å¤æµ‹è¯•é€šè¿‡")
                
                # æ£€æŸ¥è¡¨ç»“æ„å’Œæ•°æ®
                self.verify_restored_data()
                return True
            else:
                print(f"âŒ å¤‡ä»½æ¢å¤æµ‹è¯•å¤±è´¥: {result.stderr.decode()}")
                return False
                
        except Exception as e:
            print(f"âŒ æ¢å¤æµ‹è¯•å¼‚å¸¸: {e}")
            return False
        finally:
            # æ¸…ç†æµ‹è¯•æ•°æ®åº“
            self.cleanup_test_database()
    
    def verify_restored_data(self):
        """éªŒè¯æ¢å¤çš„æ•°æ®"""
        try:
            connection = mysql.connector.connect(
                host='localhost',
                user='root',
                password='password',
                database=self.test_db_name
            )
            cursor = connection.cursor()
            
            # æ£€æŸ¥è¡¨æ•°é‡
            cursor.execute("SHOW TABLES")
            tables = cursor.fetchall()
            table_count = len(tables)
            
            print(f"ğŸ“Š æ¢å¤çš„è¡¨æ•°é‡: {table_count}")
            
            # æ£€æŸ¥æ•°æ®é‡ï¼ˆç¤ºä¾‹ï¼‰
            if table_count > 0:
                for table in tables[:5]:  # åªæ£€æŸ¥å‰5ä¸ªè¡¨
                    table_name = table[0]
                    cursor.execute(f"SELECT COUNT(*) FROM {table_name}")
                    row_count = cursor.fetchone()[0]
                    print(f"   è¡¨ {table_name}: {row_count} è¡Œæ•°æ®")
            
            connection.close()
            
        except Exception as e:
            print(f"âŒ æ•°æ®éªŒè¯å¼‚å¸¸: {e}")
    
    def cleanup_test_database(self):
        """æ¸…ç†æµ‹è¯•æ•°æ®åº“"""
        try:
            connection = mysql.connector.connect(
                host='localhost',
                user='root',
                password='password'
            )
            cursor = connection.cursor()
            cursor.execute(f"DROP DATABASE IF EXISTS {self.test_db_name}")
            connection.close()
            print("ğŸ§¹ æµ‹è¯•æ•°æ®åº“å·²æ¸…ç†")
        except Exception as e:
            print(f"âš ï¸ æ¸…ç†æµ‹è¯•æ•°æ®åº“å¤±è´¥: {e}")
    
    def run_validation(self):
        """è¿è¡Œå®Œæ•´éªŒè¯æµç¨‹"""
        print(f"å¼€å§‹éªŒè¯å¤‡ä»½æ–‡ä»¶: {self.backup_file}")
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(self.backup_file):
            print("âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨")
            return False
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size = os.path.getsize(self.backup_file)
        if file_size == 0:
            print("âŒ å¤‡ä»½æ–‡ä»¶ä¸ºç©º")
            return False
        
        print(f"ğŸ“ æ–‡ä»¶å¤§å°: {file_size / (1024*1024):.2f}MB")
        
        # æ‰§è¡Œå„é¡¹éªŒè¯
        syntax_ok = self.validate_sql_syntax()
        restore_ok = self.test_restore()
        
        if syntax_ok and restore_ok:
            print("âœ… å¤‡ä»½éªŒè¯å…¨éƒ¨é€šè¿‡")
            return True
        else:
            print("âŒ å¤‡ä»½éªŒè¯å¤±è´¥")
            return False

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import sys
    
    if len(sys.argv) != 2:
        print("ä½¿ç”¨æ–¹æ³•: python3 backup_validator.py <backup_file>")
        sys.exit(1)
    
    backup_file = sys.argv[1]
    validator = BackupValidator(backup_file)
    
    if validator.run_validation():
        print("å¤‡ä»½æ–‡ä»¶éªŒè¯æˆåŠŸ")
        sys.exit(0)
    else:
        print("å¤‡ä»½æ–‡ä»¶éªŒè¯å¤±è´¥")
        sys.exit(1)
```

---

## 7. âš™ï¸ é…ç½®æ–‡ä»¶ç®¡ç†


### 7.1 é›†ä¸­åŒ–é…ç½®è®¾è®¡


**é…ç½®æ–‡ä»¶çš„é‡è¦æ€§**ï¼šå°†é…ç½®ä¿¡æ¯ä»è„šæœ¬ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œä¾¿äºç®¡ç†å’Œä¿®æ”¹ï¼Œä¸éœ€è¦æ¯æ¬¡æ”¹é…ç½®éƒ½ä¿®æ”¹è„šæœ¬ä»£ç ã€‚

**ä¸»é…ç½®æ–‡ä»¶ç»“æ„** (`backup_config.conf`)ï¼š
```bash
# MySQLå¤‡ä»½é…ç½®æ–‡ä»¶
# ä½¿ç”¨è¯´æ˜: source backup_config.conf åŠ è½½é…ç½®

# ==================== æ•°æ®åº“é…ç½® ====================
DB_HOST="localhost"
DB_PORT="3306"
DB_USER="backup_user"
DB_PASS="your_secure_password"
DB_NAMES=("production_db" "test_db" "log_db")

# ==================== å¤‡ä»½é…ç½® ====================
BACKUP_BASE_DIR="/data/backup/mysql"
BACKUP_RETENTION_DAYS=30
COMPRESS_BACKUP=true
VERIFY_BACKUP=true

# ==================== è°ƒåº¦é…ç½® ====================
FULL_BACKUP_TIME="0 2 * * 0"      # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹å…¨é‡å¤‡ä»½
INCREMENTAL_BACKUP_TIME="0 */6 * * *"  # æ¯6å°æ—¶å¢é‡å¤‡ä»½

# ==================== ç›‘æ§é…ç½® ====================
LOG_FILE="/var/log/mysql_backup.log"
LOG_LEVEL="INFO"
EMAIL_ALERTS=true
EMAIL_TO="admin@company.com"

# ==================== æ€§èƒ½é…ç½® ====================
PARALLEL_BACKUP=false
MAX_PARALLEL_JOBS=2
MYSQLDUMP_OPTIONS="--single-transaction --routines --triggers --events"
```

### 7.2 ç¯å¢ƒç‰¹å®šé…ç½®


**ä¸åŒç¯å¢ƒçš„é…ç½®ç®¡ç†**ï¼š
```bash
# å¼€å‘ç¯å¢ƒé…ç½® (backup_config_dev.conf)
DB_HOST="dev-mysql-server"
DB_NAMES=("dev_app_db")
BACKUP_RETENTION_DAYS=7
EMAIL_ALERTS=false

# æµ‹è¯•ç¯å¢ƒé…ç½® (backup_config_test.conf)
DB_HOST="test-mysql-server"
DB_NAMES=("test_app_db" "test_analytics_db")
BACKUP_RETENTION_DAYS=14
EMAIL_ALERTS=true

# ç”Ÿäº§ç¯å¢ƒé…ç½® (backup_config_prod.conf)
DB_HOST="prod-mysql-cluster"
DB_NAMES=("prod_app_db" "prod_analytics_db" "prod_log_db")
BACKUP_RETENTION_DAYS=90
EMAIL_ALERTS=true
VERIFY_BACKUP=true
```

**ç¯å¢ƒé…ç½®åŠ è½½è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ç¯å¢ƒé…ç½®åŠ è½½å™¨

load_environment_config() {
    local env=${1:-"prod"}  # é»˜è®¤ç”Ÿäº§ç¯å¢ƒ
    local config_file="/opt/backup/config/backup_config_${env}.conf"
    
    if [ -f "$config_file" ]; then
        echo "åŠ è½½ç¯å¢ƒé…ç½®: $env"
        source "$config_file"
        
        # éªŒè¯å¿…è¦é…ç½®é¡¹
        if [ -z "$DB_HOST" ] || [ -z "$DB_USER" ]; then
            echo "é”™è¯¯: é…ç½®æ–‡ä»¶ç¼ºå°‘å¿…è¦é¡¹"
            exit 1
        fi
        
        echo "é…ç½®åŠ è½½æˆåŠŸ - ä¸»æœº: $DB_HOST, ç”¨æˆ·: $DB_USER"
    else
        echo "é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ - $config_file"
        exit 1
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
# load_environment_config "dev"    # åŠ è½½å¼€å‘ç¯å¢ƒé…ç½®
# load_environment_config "test"   # åŠ è½½æµ‹è¯•ç¯å¢ƒé…ç½®
# load_environment_config "prod"   # åŠ è½½ç”Ÿäº§ç¯å¢ƒé…ç½®
```

### 7.3 é…ç½®éªŒè¯ä¸å®‰å…¨


**é…ç½®å®‰å…¨æ€§æ£€æŸ¥**ï¼š
```python
#!/usr/bin/env python3
"""
é…ç½®æ–‡ä»¶å®‰å…¨æ£€æŸ¥å’ŒéªŒè¯å·¥å…·
"""

import os
import stat
import configparser
import re

class ConfigValidator:
    def __init__(self, config_file):
        self.config_file = config_file
        self.issues = []
    
    def check_file_permissions(self):
        """æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™"""
        file_stat = os.stat(self.config_file)
        file_mode = stat.filemode(file_stat.st_mode)
        
        # é…ç½®æ–‡ä»¶ä¸åº”è¯¥å¯¹å…¶ä»–ç”¨æˆ·å¯è¯»
        if file_stat.st_mode & stat.S_IROTH:
            self.issues.append("âš ï¸ é…ç½®æ–‡ä»¶å¯¹å…¶ä»–ç”¨æˆ·å¯è¯»ï¼Œå­˜åœ¨å®‰å…¨é£é™©")
        
        # é…ç½®æ–‡ä»¶ä¸åº”è¯¥å¯¹ç»„ç”¨æˆ·å¯å†™
        if file_stat.st_mode & stat.S_IWGRP:
            self.issues.append("âš ï¸ é…ç½®æ–‡ä»¶å¯¹ç»„ç”¨æˆ·å¯å†™ï¼Œå­˜åœ¨å®‰å…¨é£é™©")
        
        print(f"ğŸ“ æ–‡ä»¶æƒé™: {file_mode}")
        return len(self.issues) == 0
    
    def check_password_security(self, config):
        """æ£€æŸ¥å¯†ç å®‰å…¨æ€§"""
        for section in config.sections():
            for key, value in config.items(section):
                if 'password' in key.lower() or 'pass' in key.lower():
                    # æ£€æŸ¥å¯†ç å¼ºåº¦
                    if len(value) < 8:
                        self.issues.append(f"âš ï¸ å¯†ç è¿‡çŸ­: {section}.{key}")
                    
                    if value in ['password', '123456', 'admin']:
                        self.issues.append(f"ğŸš¨ ä½¿ç”¨å¼±å¯†ç : {section}.{key}")
                    
                    if not re.search(r'[A-Z]', value):
                        self.issues.append(f"âš ï¸ å¯†ç ç¼ºå°‘å¤§å†™å­—æ¯: {section}.{key}")
    
    def check_required_settings(self, config):
        """æ£€æŸ¥å¿…è¦é…ç½®é¡¹"""
        required_settings = {
            'database': ['host', 'user', 'password'],
            'backup': ['directory'],
            'logging': ['file']
        }
        
        for section, keys in required_settings.items():
            if not config.has_section(section):
                self.issues.append(f"âŒ ç¼ºå°‘é…ç½®èŠ‚: {section}")
                continue
            
            for key in keys:
                if not config.has_option(section, key):
                    self.issues.append(f"âŒ ç¼ºå°‘é…ç½®é¡¹: {section}.{key}")
    
    def validate_paths(self, config):
        """éªŒè¯è·¯å¾„é…ç½®"""
        path_settings = ['backup.directory', 'logging.file']
        
        for setting in path_settings:
            section, key = setting.split('.')
            if config.has_option(section, key):
                path = config.get(section, key)
                parent_dir = os.path.dirname(path)
                
                if not os.path.exists(parent_dir):
                    self.issues.append(f"âš ï¸ è·¯å¾„ä¸å­˜åœ¨: {setting} = {path}")
                elif not os.access(parent_dir, os.W_OK):
                    self.issues.append(f"âš ï¸ è·¯å¾„ä¸å¯å†™: {setting} = {path}")
    
    def run_validation(self):
        """è¿è¡Œå®Œæ•´éªŒè¯"""
        print(f"å¼€å§‹éªŒè¯é…ç½®æ–‡ä»¶: {self.config_file}")
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(self.config_file):
            print("âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨")
            return False
        
        # æ£€æŸ¥æ–‡ä»¶æƒé™
        self.check_file_permissions()
        
        # åŠ è½½é…ç½®
        try:
            config = configparser.ConfigParser()
            config.read(self.config_file)
        except Exception as e:
            self.issues.append(f"âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: {e}")
            self.print_issues()
            return False
        
        # æ‰§è¡Œå„é¡¹æ£€æŸ¥
        self.check_required_settings(config)
        self.check_password_security(config)
        self.validate_paths(config)
        
        # è¾“å‡ºç»“æœ
        self.print_issues()
        
        if len(self.issues) == 0:
            print("âœ… é…ç½®éªŒè¯å…¨éƒ¨é€šè¿‡")
            return True
        else:
            print(f"âŒ å‘ç° {len(self.issues)} ä¸ªé—®é¢˜éœ€è¦å¤„ç†")
            return False
    
    def print_issues(self):
        """è¾“å‡ºå‘ç°çš„é—®é¢˜"""
        if self.issues:
            print("\nå‘ç°çš„é—®é¢˜:")
            for issue in self.issues:
                print(f"  {issue}")
        print()

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import sys
    
    if len(sys.argv) != 2:
        print("ä½¿ç”¨æ–¹æ³•: python3 config_validator.py <config_file>")
        sys.exit(1)
    
    config_file = sys.argv[1]
    validator = ConfigValidator(config_file)
    
    if validator.run_validation():
        sys.exit(0)
    else:
        sys.exit(1)
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å¤‡ä»½è‡ªåŠ¨åŒ–æœ¬è´¨ï¼šç”¨ç¨‹åºä»£æ›¿äººå·¥ï¼Œå®ç°æ ‡å‡†åŒ–ã€å¯é çš„å¤‡ä»½æµç¨‹
ğŸ”¸ è„šæœ¬è¯­è¨€é€‰æ‹©ï¼šShellé€‚åˆç®€å•ä»»åŠ¡ï¼ŒPythoné€‚åˆå¤æ‚é€»è¾‘å’Œé”™è¯¯å¤„ç†
ğŸ”¸ å®šæ—¶è°ƒåº¦æœºåˆ¶ï¼šCronæ˜¯Linuxä¸‹æœ€å¸¸ç”¨çš„ä»»åŠ¡è°ƒåº¦å·¥å…·
ğŸ”¸ å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼šé¢„é˜²ä¸ºä¸»ï¼Œç›‘æ§ä¸ºè¾…ï¼ŒåŠæ—¶å“åº”ï¼Œå¿«é€Ÿæ¢å¤
ğŸ”¸ é…ç½®ç®¡ç†åŸåˆ™ï¼šåˆ†ç¦»é…ç½®å’Œä»£ç ï¼Œæ”¯æŒå¤šç¯å¢ƒï¼Œç¡®ä¿å®‰å…¨æ€§
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½è‡ªåŠ¨åŒ–**ï¼š
```
äººå·¥å¤‡ä»½çš„é—®é¢˜ï¼š
- å®¹æ˜“é—å¿˜ï¼Œç‰¹åˆ«æ˜¯èŠ‚å‡æ—¥
- æ“ä½œä¸æ ‡å‡†ï¼Œå¯èƒ½å‡ºé”™
- æ— æ³•24å°æ—¶ç›‘æ§
- å¤„ç†æ•ˆç‡ä½

è‡ªåŠ¨åŒ–çš„ä»·å€¼ï¼š
- ç¡®ä¿å¤‡ä»½åŠæ—¶æ€§å’Œä¸€è‡´æ€§
- å‡å°‘äººä¸ºé”™è¯¯
- æä¾›æŒç»­ç›‘æ§å’ŒæŠ¥å‘Š
- é™ä½è¿ç»´æˆæœ¬
```

**ğŸ”¹ Shell vs Pythonçš„é€‰æ‹©**ï¼š
```
é€‰æ‹©Shellçš„åœºæ™¯ï¼š
- ç®€å•çš„å¤‡ä»½ä»»åŠ¡
- ä¸»è¦è°ƒç”¨ç³»ç»Ÿå‘½ä»¤
- å›¢é˜Ÿç†Ÿæ‚‰Shellç¼–ç¨‹
- å¿«é€Ÿå®ç°å’Œéƒ¨ç½²

é€‰æ‹©Pythonçš„åœºæ™¯ï¼š
- å¤æ‚çš„é€»è¾‘å¤„ç†
- éœ€è¦ä¸°å¯Œçš„é”™è¯¯å¤„ç†
- è¦é›†æˆç¬¬ä¸‰æ–¹åº“
- éœ€è¦é¢å‘å¯¹è±¡è®¾è®¡
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§**ï¼š
```
ä¸ºä»€ä¹ˆé‡è¦ï¼š
- å¤‡ä»½è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°å„ç§æ„å¤–
- é™é»˜å¤±è´¥æ¯”æ˜æ˜¾å¤±è´¥æ›´å±é™©
- éœ€è¦åŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜

å¤„ç†ç­–ç•¥ï¼š
- é¢„é˜²æ€§æ£€æŸ¥ï¼ˆç©ºé—´ã€æƒé™ã€è¿æ¥ï¼‰
- é‡è¯•æœºåˆ¶ï¼ˆç½‘ç»œæŠ–åŠ¨ã€ä¸´æ—¶æ•…éšœï¼‰
- å‘Šè­¦é€šçŸ¥ï¼ˆåŠæ—¶å‘ç°é—®é¢˜ï¼‰
- é™çº§æ–¹æ¡ˆï¼ˆéƒ¨åˆ†å¤±è´¥æ—¶çš„å¤„ç†ï¼‰
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ è„šæœ¬å¼€å‘æœ€ä½³å®è·µ**ï¼š
```
ä»£ç ç»“æ„ï¼š
âœ… é…ç½®ä¸ä»£ç åˆ†ç¦»
âœ… åŠŸèƒ½æ¨¡å—åŒ–
âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
âœ… å®Œå–„çš„é”™è¯¯å¤„ç†

å®‰å…¨è€ƒè™‘ï¼š
âœ… å¯†ç ä¸ç¡¬ç¼–ç 
âœ… é…ç½®æ–‡ä»¶æƒé™æ§åˆ¶
âœ… æ—¥å¿—æ•æ„Ÿä¿¡æ¯è„±æ•
âœ… å¤‡ä»½æ–‡ä»¶åŠ å¯†å­˜å‚¨

ç›‘æ§è¦æ±‚ï¼š
âœ… æ‰§è¡ŒçŠ¶æ€ç›‘æ§
âœ… æ€§èƒ½æŒ‡æ ‡æ”¶é›†
âœ… å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦
âœ… å®šæœŸæŠ¥å‘Šç”Ÿæˆ
```

**ğŸ”§ è¿ç»´å®æ–½æ­¥éª¤**ï¼š
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è‡ªåŠ¨åŒ–
- ç¼–å†™åŸºæœ¬å¤‡ä»½è„šæœ¬
- é…ç½®å®šæ—¶ä»»åŠ¡
- å®ç°åŸºç¡€ç›‘æ§

ç¬¬äºŒé˜¶æ®µï¼šåŠŸèƒ½å®Œå–„
- å¢åŠ å¼‚å¸¸å¤„ç†
- å®ç°å‚æ•°åŒ–é…ç½®
- æ·»åŠ å¤‡ä»½éªŒè¯

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§
- å¤šç¯å¢ƒé…ç½®ç®¡ç†
- æ™ºèƒ½è°ƒåº¦ä¼˜åŒ–
- é›†æˆä¼ä¸šç›‘æ§ç³»ç»Ÿ
```

**ğŸ“Š æˆåŠŸè¯„ä¼°æ ‡å‡†**ï¼š
```
å¯é æ€§æŒ‡æ ‡ï¼š
- å¤‡ä»½æˆåŠŸç‡ > 99%
- å¼‚å¸¸æ¢å¤æ—¶é—´ < 30åˆ†é’Ÿ
- å¤‡ä»½å®Œæ•´æ€§éªŒè¯ 100%

æ•ˆç‡æŒ‡æ ‡ï¼š
- äººå·¥å¹²é¢„æ¬¡æ•° < 5æ¬¡/æœˆ
- å¤‡ä»½æ—¶é—´åœ¨ä¸šåŠ¡ä½å³°æœŸ
- å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ > 80%

ç®¡ç†æŒ‡æ ‡ï¼š
- å¤‡ä»½ç­–ç•¥æ–‡æ¡£åŒ–
- å¼‚å¸¸å¤„ç†æµç¨‹æ ‡å‡†åŒ–
- å›¢é˜Ÿæˆå‘˜æŒæ¡ç¨‹åº¦ > 80%
```

### 8.4 æ•…éšœæ’æŸ¥æ¸…å•


```
ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­ï¼š

è¿æ¥é—®é¢˜ï¼š
â–¡ æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
â–¡ éªŒè¯ç½‘ç»œè¿é€šæ€§
â–¡ ç¡®è®¤ç”¨æˆ·åå¯†ç æ­£ç¡®
â–¡ æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

ç©ºé—´é—®é¢˜ï¼š
â–¡ æ£€æŸ¥ç£ç›˜å‰©ä½™ç©ºé—´
â–¡ æ¸…ç†å†å²å¤‡ä»½æ–‡ä»¶
â–¡ éªŒè¯å¤‡ä»½ç›®å½•æƒé™
â–¡ è€ƒè™‘å‹ç¼©æ¯”ä¼˜åŒ–

æ€§èƒ½é—®é¢˜ï¼š
â–¡ æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½æƒ…å†µ
â–¡ ä¼˜åŒ–å¤‡ä»½æ—¶é—´çª—å£
â–¡ è°ƒæ•´mysqldumpå‚æ•°
â–¡ è€ƒè™‘å¹¶è¡Œå¤‡ä»½ç­–ç•¥

è„šæœ¬é—®é¢˜ï¼š
â–¡ æ£€æŸ¥è„šæœ¬æ‰§è¡Œæƒé™
â–¡ éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
â–¡ æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
â–¡ æµ‹è¯•å„ä¸ªåŠŸèƒ½æ¨¡å—
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¤‡ä»½è‡ªåŠ¨åŒ–æ˜¯ä¿éšœæ•°æ®å®‰å…¨çš„é‡è¦æ‰‹æ®µ
- è„šæœ¬å¼€å‘è¦è€ƒè™‘å¼‚å¸¸å¤„ç†å’Œç›‘æ§
- é…ç½®ç®¡ç†æ˜¯å®ç°çµæ´»éƒ¨ç½²çš„å…³é”®
- æŒç»­ç›‘æ§å’Œä¼˜åŒ–æ˜¯æˆåŠŸçš„ä¿è¯