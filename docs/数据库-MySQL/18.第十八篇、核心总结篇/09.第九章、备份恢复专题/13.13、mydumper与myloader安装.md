---
title: 13、mydumper与myloader安装
---
## 📚 目录

1. [mydumper工具概述](#1-mydumper工具概述)
2. [系统环境要求](#2-系统环境要求)
3. [依赖包准备](#3-依赖包准备)
4. [安装方式详解](#4-安装方式详解)
5. [配置与验证](#5-配置与验证)
6. [常见问题排查](#6-常见问题排查)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🛠️ mydumper工具概述


### 1.1 什么是mydumper/myloader


**mydumper/myloader**是MySQL数据库的**并行备份恢复工具组合**，相当于传统mysqldump的"升级版"。

```
传统备份方式的问题：
mysqldump：单线程 → 大数据库备份很慢
mysqlhotcopy：只支持MyISAM → 现在几乎不用

mydumper的优势：
✅ 多线程并行 → 备份速度快10倍以上
✅ 支持InnoDB → 现代MySQL主流引擎
✅ 一致性快照 → 数据完整性有保障
✅ 压缩备份 → 节省磁盘空间
```

**核心组件说明：**
- **mydumper**：负责数据备份（相当于加强版mysqldump）
- **myloader**：负责数据恢复（相当于mysql客户端导入）

> **💡 简单理解**：如果把数据库比作一个大仓库，mysqldump就像一个人慢慢搬东西，而mydumper就像一群人同时搬，效率自然高很多。

### 1.2 mydumper的核心特性


**并行处理能力：**
```
单表多线程：
┌─────────────┐    ┌─────────────┐
│   大表A     │ ─→ │ 线程1 块1   │
│ (100万行)   │    │ 线程2 块2   │ ─→ 备份文件
│             │    │ 线程3 块3   │
└─────────────┘    └─────────────┘

多表并行：
表A ─→ 线程1 ─→ A.sql
表B ─→ 线程2 ─→ B.sql  
表C ─→ 线程3 ─→ C.sql
```

**一致性保证：**
- 支持**GTID**（全局事务标识符）
- **快照备份**：所有数据来自同一个时间点
- **事务日志位置**记录：方便增量恢复

---

## 2. 🖥️ 系统环境要求


### 2.1 操作系统支持


**支持的系统：**
```
✅ CentOS/RHEL 7.x, 8.x, 9.x
✅ Ubuntu 18.04, 20.04, 22.04
✅ Debian 9, 10, 11
✅ Amazon Linux 2
✅ SUSE Linux
✅ macOS (通过Homebrew)
```

**架构支持：**
- x86_64 (主流)
- ARM64 (新版本支持)

### 2.2 MySQL版本兼容性


**完全兼容：**
```
MySQL 5.6, 5.7, 8.0, 8.1
MariaDB 10.x 系列
Percona Server 5.6, 5.7, 8.0
```

> **📌 重要提醒**：MySQL 5.5及以下版本不建议使用，功能支持有限。

### 2.3 硬件资源要求


**最低配置：**
```
CPU：2核心
内存：2GB RAM
磁盘：备份文件大小的2倍空间
网络：稳定的数据库连接
```

**推荐配置：**
```
CPU：4核心以上（并行线程数一般设为CPU核心数）
内存：8GB以上
磁盘：SSD，备份大小的3-5倍空间
网络：千兆网络环境
```

---

## 3. 📦 依赖包准备


### 3.1 编译依赖包


**CentOS/RHEL系统：**
```bash
# 基础编译工具
sudo yum groupinstall -y "Development Tools"
sudo yum install -y cmake

# MySQL开发库
sudo yum install -y mysql-devel
# 或者MariaDB开发库
sudo yum install -y mariadb-devel

# 其他必需库
sudo yum install -y \
    glib2-devel \
    zlib-devel \
    pcre-devel \
    openssl-devel \
    libssl-dev
```

**Ubuntu/Debian系统：**
```bash
# 更新包列表
sudo apt update

# 基础编译工具
sudo apt install -y build-essential cmake

# MySQL开发库
sudo apt install -y libmysqlclient-dev
# 或者MariaDB开发库
sudo apt install -y libmariadb-dev

# 其他必需库
sudo apt install -y \
    libglib2.0-dev \
    zlib1g-dev \
    libpcre3-dev \
    libssl-dev
```

### 3.2 依赖包说明


**各依赖包的作用：**
```
mysql-devel：MySQL客户端开发库，连接数据库必需
glib2-devel：GNU C库扩展，处理数据结构和算法
zlib-devel：压缩库，支持备份文件压缩
pcre-devel：正则表达式库，处理字符串匹配
openssl-devel：加密库，支持SSL连接
cmake：跨平台编译工具，构建项目必需
```

> **💭 生活类比**：这些依赖包就像盖房子需要的各种工具和材料，缺一不可。

---

## 4. 🔧 安装方式详解


### 4.1 方式一：yum/apt包管理安装（推荐）


**CentOS/RHEL - 通过EPEL源：**
```bash
# 1. 安装EPEL源
sudo yum install -y epel-release

# 2. 安装mydumper
sudo yum install -y mydumper

# 3. 验证安装
mydumper --version
myloader --version
```

**Ubuntu/Debian：**
```bash
# 1. 更新包列表
sudo apt update

# 2. 安装mydumper
sudo apt install -y mydumper

# 3. 验证安装
mydumper --version
myloader --version
```

**优势与局限：**
```
✅ 优势：
- 安装简单，依赖自动解决
- 系统自动管理更新
- 稳定可靠

❌ 局限：
- 版本可能不是最新
- 定制化程度有限
```

### 4.2 方式二：源码编译安装


**下载源码：**
```bash
# 1. 下载最新版本
cd /usr/local/src
sudo wget https://github.com/mydumper/mydumper/releases/download/v0.15.1-3/mydumper-0.15.1-3.tar.gz

# 2. 解压
sudo tar -xzf mydumper-0.15.1-3.tar.gz
cd mydumper-0.15.1-3
```

**编译配置：**
```bash
# 3. 创建编译目录
mkdir build
cd build

# 4. CMake配置
cmake .. \
    -DCMAKE_INSTALL_PREFIX=/usr/local/mydumper \
    -DMYSQL_CONFIG=/usr/bin/mysql_config \
    -DCMAKE_BUILD_TYPE=Release

# 参数说明：
# CMAKE_INSTALL_PREFIX：安装路径
# MYSQL_CONFIG：MySQL配置路径
# CMAKE_BUILD_TYPE：编译类型（Release为生产版本）
```

**编译和安装：**
```bash
# 5. 编译（使用CPU核心数的线程）
make -j$(nproc)

# 6. 安装
sudo make install

# 7. 创建软链接
sudo ln -s /usr/local/mydumper/bin/mydumper /usr/local/bin/
sudo ln -s /usr/local/mydumper/bin/myloader /usr/local/bin/
```

### 4.3 方式三：二进制包安装


**下载预编译包：**
```bash
# 1. 下载二进制包
cd /tmp
wget https://github.com/mydumper/mydumper/releases/download/v0.15.1-3/mydumper-0.15.1-3.el8.x86_64.rpm

# 2. 安装RPM包（CentOS/RHEL）
sudo rpm -ivh mydumper-0.15.1-3.el8.x86_64.rpm

# 或者安装DEB包（Ubuntu/Debian）
wget https://github.com/mydumper/mydumper/releases/download/v0.15.1-3/mydumper_0.15.1-3_amd64.deb
sudo dpkg -i mydumper_0.15.1-3_amd64.deb
```

### 4.4 方式四：Docker容器部署


**Docker部署：**
```bash
# 1. 拉取镜像
docker pull mydumper/mydumper:latest

# 2. 创建工作目录
mkdir -p /data/mydumper_backup

# 3. 运行容器备份示例
docker run --rm \
    -v /data/mydumper_backup:/backup \
    mydumper/mydumper:latest \
    mydumper \
    --host=192.168.1.100 \
    --user=backup_user \
    --password=backup_pass \
    --database=mydb \
    --outputdir=/backup \
    --threads=4
```

**Docker Compose配置：**
```yaml
version: '3.8'
services:
  mydumper:
    image: mydumper/mydumper:latest
    volumes:
      - /data/mydumper_backup:/backup
      - ./config:/config
    environment:
      - MYSQL_HOST=mysql-server
      - MYSQL_USER=backup_user
      - MYSQL_PASSWORD=backup_pass
    command: >
      mydumper 
      --host=$MYSQL_HOST 
      --user=$MYSQL_USER 
      --password=$MYSQL_PASSWORD 
      --outputdir=/backup 
      --threads=4
```

### 4.5 安装方式对比


| 安装方式 | **难度** | **灵活性** | **版本** | **适用场景** |
|---------|---------|-----------|---------|-------------|
| **包管理** | ⭐ 简单 | ⭐⭐ 一般 | 稳定版 | 生产环境，快速部署 |
| **源码编译** | ⭐⭐⭐ 复杂 | ⭐⭐⭐⭐⭐ 最高 | 最新版 | 定制需求，性能调优 |
| **二进制包** | ⭐⭐ 中等 | ⭐⭐⭐ 较高 | 较新版 | 平衡选择 |
| **Docker** | ⭐⭐ 中等 | ⭐⭐⭐⭐ 高 | 最新版 | 容器化环境 |

---

## 5. ⚙️ 配置与验证


### 5.1 环境变量配置


**添加到PATH：**
```bash
# 编辑环境变量文件
sudo vim /etc/profile

# 添加以下内容
export PATH=$PATH:/usr/local/mydumper/bin

# 或者创建专门的mydumper配置文件
sudo tee /etc/profile.d/mydumper.sh << 'EOF'
#!/bin/bash
export PATH=$PATH:/usr/local/mydumper/bin
export MYDUMPER_HOME=/usr/local/mydumper
EOF

# 使配置生效
source /etc/profile
```

### 5.2 创建备份用户


**创建专用备份用户：**
```sql
-- 连接到MySQL
mysql -u root -p

-- 创建备份用户
CREATE USER 'mydumper_user'@'%' IDENTIFIED BY 'StrongPassword123!';

-- 授权备份权限
GRANT SELECT, SHOW DATABASES, SHOW VIEW, TRIGGER, LOCK TABLES ON *.* 
TO 'mydumper_user'@'%';

-- 如需要备份存储过程和函数
GRANT SELECT ON mysql.proc TO 'mydumper_user'@'%';

-- 如需要获取GTID信息
GRANT REPLICATION CLIENT ON *.* TO 'mydumper_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

**权限说明：**
```
SELECT：读取表数据
SHOW DATABASES：列出数据库
SHOW VIEW：查看视图定义
TRIGGER：备份触发器
LOCK TABLES：锁定表保证一致性
REPLICATION CLIENT：获取binlog位置信息
```

### 5.3 基本功能验证


**验证安装：**
```bash
# 1. 检查版本
mydumper --version
myloader --version

# 2. 查看帮助信息
mydumper --help | head -20
myloader --help | head -20

# 3. 检查依赖库
ldd $(which mydumper)
```

**连接测试：**
```bash
# 测试数据库连接
mydumper \
    --host=localhost \
    --user=mydumper_user \
    --password=StrongPassword123! \
    --no-data \
    --database=mysql \
    --outputdir=/tmp/test_backup

# 检查备份文件
ls -la /tmp/test_backup/
```

**预期输出：**
```
/tmp/test_backup/
├── metadata                    # 元数据文件
├── mysql-schema-create.sql     # 数据库创建语句
├── mysql.user-schema.sql       # 用户表结构
└── ...                         # 其他表结构文件
```

### 5.4 性能基准测试


**简单性能测试：**
```bash
# 1. 创建测试表
mysql -u root -p << 'EOF'
CREATE DATABASE test_perf;
USE test_perf;
CREATE TABLE large_table (
    id INT AUTO_INCREMENT PRIMARY KEY,
    data VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入测试数据
INSERT INTO large_table (data) 
SELECT CONCAT('test_data_', seq) 
FROM (
    SELECT @row := @row + 1 as seq 
    FROM information_schema.tables, (SELECT @row := 0) r 
    LIMIT 100000
) t;
EOF

# 2. 测试不同线程数的备份性能
echo "测试备份性能..."
for threads in 1 2 4 8; do
    echo "线程数: $threads"
    time mydumper \
        --host=localhost \
        --user=mydumper_user \
        --password=StrongPassword123! \
        --database=test_perf \
        --threads=$threads \
        --outputdir=/tmp/perf_test_$threads
done
```

---

## 6. 🔍 常见问题排查


### 6.1 编译相关问题


**问题1：cmake版本过低**
```bash
# 错误信息
CMake Error: CMake 3.5 or higher is required. You are running version 2.8.12

# 解决方案：升级cmake
# CentOS 7
sudo yum remove cmake
sudo yum install cmake3
sudo ln -s /usr/bin/cmake3 /usr/bin/cmake

# 或者从源码编译最新版cmake
```

**问题2：找不到MySQL开发库**
```bash
# 错误信息
Could NOT find MySQL (missing: MYSQL_LIB MYSQL_INCLUDE_DIR)

# 解决方案：安装正确的开发包
# CentOS/RHEL
sudo yum install mysql-devel
# 或者
sudo yum install mariadb-devel

# Ubuntu/Debian
sudo apt install libmysqlclient-dev
# 或者
sudo apt install libmariadb-dev
```

**问题3：编译内存不足**
```bash
# 现象：编译过程中系统卡死或内存不足

# 解决方案：限制并行编译线程
make -j2  # 使用2个线程而不是所有CPU核心

# 或者增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 6.2 运行时问题


**问题1：连接被拒绝**
```bash
# 错误信息
Access denied for user 'mydumper_user'@'hostname'

# 排查步骤：
# 1. 检查用户权限
mysql -u root -p -e "SHOW GRANTS FOR 'mydumper_user'@'%';"

# 2. 检查用户是否存在
mysql -u root -p -e "SELECT User,Host FROM mysql.user WHERE User='mydumper_user';"

# 3. 测试手动连接
mysql -h localhost -u mydumper_user -p
```

**问题2：权限不足**
```bash
# 错误信息
mydumper: Error: Couldn't acquire lock: Access denied; you need (at least one of) the LOCK TABLES privilege(s)

# 解决方案：添加必要权限
mysql -u root -p << 'EOF'
GRANT LOCK TABLES ON *.* TO 'mydumper_user'@'%';
FLUSH PRIVILEGES;
EOF
```

**问题3：输出目录问题**
```bash
# 错误信息
mydumper: Error: Unable to create output directory

# 解决方案：
# 1. 检查目录权限
ls -ld /backup/path/
sudo chmod 755 /backup/path/
sudo chown $(whoami):$(whoami) /backup/path/

# 2. 创建目录
sudo mkdir -p /backup/path/
```

### 6.3 性能相关问题


**问题1：备份速度慢**
```bash
# 排查思路：
# 1. 检查磁盘IO
iostat -x 1

# 2. 检查网络延迟
ping mysql_server_ip

# 3. 调整线程数
mydumper --threads=8  # 增加线程数

# 4. 使用压缩
mydumper --compress  # 启用压缩
```

**问题2：内存使用过高**
```bash
# 调整参数减少内存使用
mydumper \
    --threads=4 \
    --rows=10000 \        # 限制每个chunk的行数
    --chunk-filesize=100  # 限制文件大小（MB）
```

### 6.4 兼容性问题


**MySQL 8.0 认证插件问题：**
```bash
# 错误信息
Authentication plugin 'caching_sha2_password' cannot be loaded

# 解决方案1：修改用户认证方式
mysql -u root -p << 'EOF'
ALTER USER 'mydumper_user'@'%' IDENTIFIED WITH mysql_native_password BY 'StrongPassword123!';
FLUSH PRIVILEGES;
EOF

# 解决方案2：使用支持新认证的mydumper版本（0.12.1+）
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的安装要点


```
🔸 环境要求：Linux系统 + MySQL 5.6以上 + 足够的磁盘空间
🔸 依赖关键：mysql-devel开发库是核心依赖，必须正确安装
🔸 安装选择：生产环境推荐包管理安装，定制需求选择源码编译
🔸 权限配置：备份用户需要SELECT、LOCK TABLES等关键权限
🔸 验证测试：安装后必须进行连接和功能验证
```

### 7.2 安装方式选择指南


**生产环境推荐：**
```
首选：yum/apt包管理安装
- 稳定可靠，自动管理依赖
- 系统原生支持，便于维护

备选：二进制包安装  
- 版本较新，安装相对简单
- 适合包管理器版本过旧的情况
```

**开发测试环境：**
```
首选：Docker容器化部署
- 环境隔离，快速部署
- 版本灵活，便于测试

备选：源码编译安装
- 最新功能，可定制优化
- 适合研究学习使用
```

### 7.3 关键配置要点


**用户权限最小化原则：**
```sql
-- 基础备份权限（必需）
GRANT SELECT, SHOW DATABASES, LOCK TABLES ON *.* TO 'mydumper_user'@'%';

-- 扩展权限（按需添加）
GRANT SHOW VIEW, TRIGGER ON *.* TO 'mydumper_user'@'%';           -- 视图和触发器
GRANT SELECT ON mysql.proc TO 'mydumper_user'@'%';                -- 存储过程
GRANT REPLICATION CLIENT ON *.* TO 'mydumper_user'@'%';           -- GTID信息
```

**环境变量配置：**
```bash
# 系统级配置
echo 'export PATH=$PATH:/usr/local/mydumper/bin' >> /etc/profile

# 用户级配置  
echo 'export PATH=$PATH:/usr/local/mydumper/bin' >> ~/.bashrc
```

### 7.4 故障排查思路


**安装问题排查顺序：**
```
1. 检查系统版本和架构兼容性
2. 确认所有依赖包正确安装
3. 验证MySQL开发库版本匹配
4. 检查编译参数和路径设置
5. 查看详细错误日志信息
```

**运行问题排查顺序：**
```
1. 测试数据库连接和用户权限
2. 检查输出目录权限和空间
3. 验证网络连通性和延迟
4. 调整线程数和内存参数
5. 查看MySQL错误日志
```

### 7.5 最佳实践建议


**安装环境准备：**
- 提前规划安装路径和权限设置
- 预留足够的磁盘空间用于备份文件
- 确保网络环境稳定可靠
- 建议先在测试环境验证完整流程

**版本选择策略：**
- 生产环境选择稳定版本，避免使用最新的开发版本
- 定期关注官方更新，及时修复安全漏洞
- 保持mydumper版本与MySQL版本的兼容性

**监控和维护：**
- 定期检查备份工具的运行状态
- 监控备份任务的执行时间和成功率
- 建立备份验证和恢复测试机制

**核心记忆：**
- mydumper是MySQL并行备份的利器，安装配置是使用的第一步
- 选择合适的安装方式，确保依赖完整、权限正确、功能验证
- 遇到问题要系统排查，从环境、权限、网络等方面逐步定位
- 生产使用前务必充分测试，确保备份恢复流程完整可靠