---
title: 62ã€å¤‡ä»½æ¢å¤è‡ªåŠ¨åŒ–è„šæœ¬
---
## ğŸ“š ç›®å½•

1. [è‡ªåŠ¨åŒ–è„šæœ¬æ¦‚è¿°](#1-è‡ªåŠ¨åŒ–è„šæœ¬æ¦‚è¿°)
2. [Shellè„šæœ¬ç¼–å†™åŸºç¡€](#2-Shellè„šæœ¬ç¼–å†™åŸºç¡€)
3. [å¤‡ä»½è„šæœ¬å¼€å‘](#3-å¤‡ä»½è„šæœ¬å¼€å‘)
4. [æ¢å¤è„šæœ¬å¼€å‘](#4-æ¢å¤è„šæœ¬å¼€å‘)
5. [å®šæ—¶ä»»åŠ¡é…ç½®](#5-å®šæ—¶ä»»åŠ¡é…ç½®)
6. [æ—¥å¿—ä¸ç›‘æ§æœºåˆ¶](#6-æ—¥å¿—ä¸ç›‘æ§æœºåˆ¶)
7. [é”™è¯¯å¤„ç†ä¸é€šçŸ¥](#7-é”™è¯¯å¤„ç†ä¸é€šçŸ¥)
8. [è„šæœ¬æµ‹è¯•ä¸ç»´æŠ¤](#8-è„šæœ¬æµ‹è¯•ä¸ç»´æŠ¤)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤– è‡ªåŠ¨åŒ–è„šæœ¬æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬


**æ‰‹åŠ¨å¤‡ä»½çš„é—®é¢˜**ï¼š
```
âŒ å®¹æ˜“é—å¿˜ï¼šäººå·¥æ“ä½œå¯èƒ½å¿˜è®°æ‰§è¡Œ
âŒ æ—¶é—´ä¸è§„å¾‹ï¼šæ— æ³•ä¿è¯å›ºå®šæ—¶é—´å¤‡ä»½
âŒ æ“ä½œå¤±è¯¯ï¼šæ‰‹åŠ¨å‘½ä»¤å¯èƒ½å‡ºé”™
âŒ ç¼ºä¹ç›‘æ§ï¼šå¤‡ä»½å¤±è´¥æ— æ³•åŠæ—¶å‘ç°
âŒ ç®¡ç†å›°éš¾ï¼šå¤‡ä»½æ–‡ä»¶ç¼ºä¹ç»Ÿä¸€ç®¡ç†
```

**è‡ªåŠ¨åŒ–è„šæœ¬çš„ä¼˜åŠ¿**ï¼š
```
âœ… å®šæ—¶æ‰§è¡Œï¼šæŒ‰é¢„è®¾æ—¶é—´è‡ªåŠ¨å¤‡ä»½
âœ… æ ‡å‡†åŒ–æ“ä½œï¼šé¿å…äººä¸ºæ“ä½œå¤±è¯¯
âœ… æ™ºèƒ½ç›‘æ§ï¼šè‡ªåŠ¨æ£€æµ‹å¤‡ä»½ç»“æœ
âœ… æ–‡ä»¶ç®¡ç†ï¼šè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶
âœ… å¼‚å¸¸é€šçŸ¥ï¼šå¤‡ä»½å¤±è´¥ç«‹å³æŠ¥è­¦
```

### 1.2 è‡ªåŠ¨åŒ–è„šæœ¬çš„æ ¸å¿ƒåŠŸèƒ½


**åŸºç¡€åŠŸèƒ½æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è‡ªåŠ¨åŒ–è„šæœ¬ç³»ç»Ÿ             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ å¤‡ä»½è„šæœ¬    â”‚  ğŸ“¥ æ¢å¤è„šæœ¬      â”‚
â”‚  - æ•°æ®å¯¼å‡º     â”‚  - æ•°æ®å¯¼å…¥       â”‚
â”‚  - æ–‡ä»¶å‹ç¼©     â”‚  - æ–‡ä»¶éªŒè¯       â”‚
â”‚  - å­˜å‚¨ç®¡ç†     â”‚  - æ•°æ®æ ¡éªŒ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â° å®šæ—¶ä»»åŠ¡    â”‚  ğŸ“Š ç›‘æ§ç³»ç»Ÿ      â”‚
â”‚  - crontabé…ç½®  â”‚  - æ—¥å¿—è®°å½•       â”‚
â”‚  - ä»»åŠ¡è°ƒåº¦     â”‚  - çŠ¶æ€æ£€æŸ¥       â”‚
â”‚  - é”™è¯¯å¤„ç†     â”‚  - æŠ¥è­¦é€šçŸ¥       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 è„šæœ¬è®¾è®¡åŸåˆ™


**è®¾è®¡è¦ç‚¹**ï¼š
- **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æˆæ¨¡å—ï¼Œä¾¿äºç»´æŠ¤
- **å‚æ•°åŒ–**ï¼šé€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†å„ç§å‚æ•°
- **å®¹é”™æ€§**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
- **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šæ•°æ®åº“ã€å¤šå­˜å‚¨ä½ç½®
- **ç›‘æ§æ€§**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€æŠ¥å‘Š

---

## 2. ğŸ“ Shellè„šæœ¬ç¼–å†™åŸºç¡€


### 2.1 Shellè„šæœ¬åŸºæœ¬ç»“æ„


**æ ‡å‡†è„šæœ¬æ¨¡æ¿**ï¼š
```bash
#!/bin/bash
# =======================================================
# MySQLè‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
# ä½œè€…ï¼šè¿ç»´å›¢é˜Ÿ
# ç‰ˆæœ¬ï¼šv1.0
# åˆ›å»ºæ—¶é—´ï¼š2025-09-11
# æè¿°ï¼šå®šæ—¶å¤‡ä»½MySQLæ•°æ®åº“ï¼Œæ”¯æŒå‹ç¼©å’Œæ¸…ç†
# =======================================================

# è®¾ç½®è„šæœ¬æ‰§è¡Œç¯å¢ƒ
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™

# è„šæœ¬åŸºæœ¬ä¿¡æ¯
SCRIPT_NAME="mysql_backup.sh"
SCRIPT_VERSION="1.0"
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

# ä¸»è¦åŠŸèƒ½å‡½æ•°
main() {
    echo "è„šæœ¬å¼€å§‹æ‰§è¡Œ..."
    # ä¸»è¦é€»è¾‘åœ¨è¿™é‡Œ
    echo "è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 2.2 å‚æ•°åŒ–é…ç½®è®¾è®¡


**é…ç½®æ–‡ä»¶æ–¹å¼**ï¼ˆ`backup_config.conf`ï¼‰ï¼š
```bash
# =======================================================
# MySQLå¤‡ä»½é…ç½®æ–‡ä»¶
# =======================================================

# æ•°æ®åº“è¿æ¥ä¿¡æ¯
DB_HOST="localhost"
DB_PORT="3306"
DB_USER="backup_user"
DB_PASSWORD="your_password"
DB_NAME="your_database"

# å¤‡ä»½è®¾ç½®
BACKUP_DIR="/data/mysql_backups"
BACKUP_PREFIX="mysql_backup"
COMPRESSION="gzip"  # gzip, zip, none
KEEP_DAYS="7"       # ä¿ç•™å¤©æ•°

# é‚®ä»¶é€šçŸ¥
EMAIL_ENABLED="true"
EMAIL_TO="admin@company.com"
EMAIL_SUBJECT="MySQLå¤‡ä»½æŠ¥å‘Š"

# æ—¥å¿—è®¾ç½®
LOG_DIR="/var/log/mysql_backup"
LOG_LEVEL="INFO"    # DEBUG, INFO, WARN, ERROR
```

**åœ¨è„šæœ¬ä¸­åŠ è½½é…ç½®**ï¼š
```bash
#!/bin/bash

# åŠ è½½é…ç½®æ–‡ä»¶
load_config() {
    local config_file="${SCRIPT_DIR}/backup_config.conf"
    
    if [[ -f "$config_file" ]]; then
        source "$config_file"
        log "INFO" "é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ: $config_file"
    else
        log "ERROR" "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        exit 1
    fi
}

# éªŒè¯é…ç½®å‚æ•°
validate_config() {
    local errors=0
    
    # æ£€æŸ¥å¿…éœ€å‚æ•°
    [[ -z "$DB_HOST" ]] && { log "ERROR" "DB_HOST æœªé…ç½®"; ((errors++)); }
    [[ -z "$DB_USER" ]] && { log "ERROR" "DB_USER æœªé…ç½®"; ((errors++)); }
    [[ -z "$BACKUP_DIR" ]] && { log "ERROR" "BACKUP_DIR æœªé…ç½®"; ((errors++)); }
    
    if [[ $errors -gt 0 ]]; then
        log "ERROR" "é…ç½®éªŒè¯å¤±è´¥ï¼Œå‘ç° $errors ä¸ªé”™è¯¯"
        exit 1
    fi
    
    log "INFO" "é…ç½®éªŒè¯é€šè¿‡"
}
```

### 2.3 æ—¥å¿—è®°å½•æœºåˆ¶


**æ—¥å¿—å‡½æ•°è®¾è®¡**ï¼š
```bash
#!/bin/bash

# æ—¥å¿—å‡½æ•°
log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local log_file="${LOG_DIR}/backup_$(date +%Y%m%d).log"
    
    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    mkdir -p "$LOG_DIR"
    
    # æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
    local log_entry="[$timestamp] [$level] $message"
    
    # å†™å…¥æ—¥å¿—æ–‡ä»¶
    echo "$log_entry" >> "$log_file"
    
    # æ ¹æ®çº§åˆ«è¾“å‡ºåˆ°æ§åˆ¶å°
    case "$level" in
        "ERROR")
            echo -e "\033[31m$log_entry\033[0m" >&2  # çº¢è‰²è¾“å‡ºåˆ°stderr
            ;;
        "WARN")
            echo -e "\033[33m$log_entry\033[0m"      # é»„è‰²
            ;;
        "INFO")
            echo -e "\033[32m$log_entry\033[0m"      # ç»¿è‰²
            ;;
        "DEBUG")
            [[ "$LOG_LEVEL" == "DEBUG" ]] && echo "$log_entry"
            ;;
    esac
}

# ä½¿ç”¨ç¤ºä¾‹
log "INFO" "å¼€å§‹å¤‡ä»½æ•°æ®åº“ $DB_NAME"
log "WARN" "å¤‡ä»½æ–‡ä»¶å·²å­˜åœ¨ï¼Œå°†è¦†ç›–"
log "ERROR" "æ•°æ®åº“è¿æ¥å¤±è´¥"
```

---

## 3. ğŸ—„ï¸ å¤‡ä»½è„šæœ¬å¼€å‘


### 3.1 å®Œæ•´å¤‡ä»½è„šæœ¬æ¨¡æ¿


**ä¸»å¤‡ä»½è„šæœ¬**ï¼ˆ`mysql_backup.sh`ï¼‰ï¼š
```bash
#!/bin/bash
# =======================================================
# MySQLè‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
# =======================================================

set -e
set -u

# è„šæœ¬ç›®å½•å’Œé…ç½®
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
source "${SCRIPT_DIR}/backup_config.conf"

# æ—¥å¿—å‡½æ•°ï¼ˆè¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message"
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database_connection() {
    log "INFO" "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
    
    if mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
        log "INFO" "æ•°æ®åº“è¿æ¥æˆåŠŸ"
        return 0
    else
        log "ERROR" "æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# åˆ›å»ºå¤‡ä»½ç›®å½•
create_backup_directory() {
    local backup_date=$(date +%Y%m%d_%H%M%S)
    CURRENT_BACKUP_DIR="${BACKUP_DIR}/${backup_date}"
    
    if mkdir -p "$CURRENT_BACKUP_DIR"; then
        log "INFO" "å¤‡ä»½ç›®å½•åˆ›å»ºæˆåŠŸ: $CURRENT_BACKUP_DIR"
    else
        log "ERROR" "å¤‡ä»½ç›®å½•åˆ›å»ºå¤±è´¥"
        return 1
    fi
}

# æ‰§è¡Œæ•°æ®åº“å¤‡ä»½
perform_backup() {
    local backup_file="${CURRENT_BACKUP_DIR}/${BACKUP_PREFIX}_$(date +%Y%m%d_%H%M%S).sql"
    
    log "INFO" "å¼€å§‹å¤‡ä»½æ•°æ®åº“: $DB_NAME"
    log "INFO" "å¤‡ä»½æ–‡ä»¶: $backup_file"
    
    # æ‰§è¡Œmysqldumpå¤‡ä»½
    if mysqldump \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --single-transaction \
        --routines \
        --triggers \
        --events \
        --hex-blob \
        --opt \
        "$DB_NAME" > "$backup_file"; then
        
        log "INFO" "æ•°æ®åº“å¤‡ä»½å®Œæˆ"
        BACKUP_FILE="$backup_file"
        return 0
    else
        log "ERROR" "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        return 1
    fi
}

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
compress_backup() {
    if [[ "$COMPRESSION" == "none" ]]; then
        log "INFO" "è·³è¿‡å‹ç¼©æ­¥éª¤"
        return 0
    fi
    
    log "INFO" "å¼€å§‹å‹ç¼©å¤‡ä»½æ–‡ä»¶: $COMPRESSION"
    
    case "$COMPRESSION" in
        "gzip")
            if gzip "$BACKUP_FILE"; then
                BACKUP_FILE="${BACKUP_FILE}.gz"
                log "INFO" "gzipå‹ç¼©å®Œæˆ"
            else
                log "ERROR" "gzipå‹ç¼©å¤±è´¥"
                return 1
            fi
            ;;
        "zip")
            local zip_file="${BACKUP_FILE}.zip"
            if zip "$zip_file" "$BACKUP_FILE" && rm "$BACKUP_FILE"; then
                BACKUP_FILE="$zip_file"
                log "INFO" "zipå‹ç¼©å®Œæˆ"
            else
                log "ERROR" "zipå‹ç¼©å¤±è´¥"
                return 1
            fi
            ;;
    esac
}

# éªŒè¯å¤‡ä»½æ–‡ä»¶
verify_backup() {
    log "INFO" "éªŒè¯å¤‡ä»½æ–‡ä»¶..."
    
    if [[ ! -f "$BACKUP_FILE" ]]; then
        log "ERROR" "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
        return 1
    fi
    
    local file_size=$(stat -c%s "$BACKUP_FILE")
    if [[ $file_size -lt 1024 ]]; then  # å°äº1KBè®¤ä¸ºå¼‚å¸¸
        log "ERROR" "å¤‡ä»½æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½å¤‡ä»½å¤±è´¥: ${file_size} bytes"
        return 1
    fi
    
    log "INFO" "å¤‡ä»½æ–‡ä»¶éªŒè¯é€šè¿‡: $(du -h "$BACKUP_FILE" | cut -f1)"
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    log "INFO" "æ¸…ç† $KEEP_DAYS å¤©å‰çš„å¤‡ä»½æ–‡ä»¶..."
    
    local deleted_count=$(find "$BACKUP_DIR" -type f -name "${BACKUP_PREFIX}_*.sql*" -mtime +$KEEP_DAYS -delete -print | wc -l)
    local deleted_dirs=$(find "$BACKUP_DIR" -type d -empty -mtime +$KEEP_DAYS -delete -print | wc -l)
    
    log "INFO" "æ¸…ç†å®Œæˆ: åˆ é™¤ $deleted_count ä¸ªæ–‡ä»¶, $deleted_dirs ä¸ªç©ºç›®å½•"
}

# ä¸»å‡½æ•°
main() {
    log "INFO" "========== MySQLè‡ªåŠ¨å¤‡ä»½å¼€å§‹ =========="
    
    # æ‰§è¡Œå¤‡ä»½æµç¨‹
    check_database_connection || exit 1
    create_backup_directory || exit 1
    perform_backup || exit 1
    compress_backup || exit 1
    verify_backup || exit 1
    cleanup_old_backups
    
    log "INFO" "========== MySQLè‡ªåŠ¨å¤‡ä»½å®Œæˆ =========="
    log "INFO" "å¤‡ä»½æ–‡ä»¶ä½ç½®: $BACKUP_FILE"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 3.2 å¢é‡å¤‡ä»½è„šæœ¬


**å¢é‡å¤‡ä»½åŸç†è¯´æ˜**ï¼š
å¢é‡å¤‡ä»½æ˜¯æŒ‡åªå¤‡ä»½è‡ªä¸Šæ¬¡å¤‡ä»½ä»¥æ¥å‘ç”Ÿå˜åŒ–çš„æ•°æ®ï¼Œé€šè¿‡MySQLçš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰å®ç°ã€‚

```bash
#!/bin/bash
# =======================================================
# MySQLå¢é‡å¤‡ä»½è„šæœ¬
# =======================================================

# å¢é‡å¤‡ä»½å‡½æ•°
perform_incremental_backup() {
    local last_backup_pos_file="${BACKUP_DIR}/last_backup_position.txt"
    local current_binlog_file=""
    local current_binlog_pos=""
    local start_binlog_file=""
    local start_binlog_pos=""
    
    log "INFO" "å¼€å§‹å¢é‡å¤‡ä»½..."
    
    # è·å–å½“å‰binlogä½ç½®
    local current_status=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "SHOW MASTER STATUS;" | tail -n 1)
    current_binlog_file=$(echo "$current_status" | awk '{print $1}')
    current_binlog_pos=$(echo "$current_status" | awk '{print $2}')
    
    log "INFO" "å½“å‰binlogä½ç½®: $current_binlog_file:$current_binlog_pos"
    
    # è¯»å–ä¸Šæ¬¡å¤‡ä»½ä½ç½®
    if [[ -f "$last_backup_pos_file" ]]; then
        read start_binlog_file start_binlog_pos < "$last_backup_pos_file"
        log "INFO" "ä¸Šæ¬¡å¤‡ä»½ä½ç½®: $start_binlog_file:$start_binlog_pos"
    else
        log "WARN" "æœªæ‰¾åˆ°ä¸Šæ¬¡å¤‡ä»½ä½ç½®ï¼Œæ‰§è¡Œå…¨é‡å¤‡ä»½"
        perform_full_backup
        return $?
    fi
    
    # ç”Ÿæˆå¢é‡å¤‡ä»½æ–‡ä»¶
    local increment_backup_file="${CURRENT_BACKUP_DIR}/increment_$(date +%Y%m%d_%H%M%S).sql"
    
    if mysqlbinlog \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --start-position="$start_binlog_pos" \
        --stop-position="$current_binlog_pos" \
        "$start_binlog_file" > "$increment_backup_file"; then
        
        log "INFO" "å¢é‡å¤‡ä»½å®Œæˆ: $increment_backup_file"
        
        # æ›´æ–°å¤‡ä»½ä½ç½®æ–‡ä»¶
        echo "$current_binlog_file $current_binlog_pos" > "$last_backup_pos_file"
        BACKUP_FILE="$increment_backup_file"
        return 0
    else
        log "ERROR" "å¢é‡å¤‡ä»½å¤±è´¥"
        return 1
    fi
}
```

### 3.3 å¤‡ä»½è„šæœ¬çš„é«˜çº§ç‰¹æ€§


**è¡¨çº§åˆ«å¤‡ä»½**ï¼š
```bash
# å¤‡ä»½æŒ‡å®šè¡¨
backup_specific_tables() {
    local tables="$1"  # è¡¨ååˆ—è¡¨ï¼Œç©ºæ ¼åˆ†éš”
    local backup_file="${CURRENT_BACKUP_DIR}/tables_backup_$(date +%Y%m%d_%H%M%S).sql"
    
    log "INFO" "å¤‡ä»½æŒ‡å®šè¡¨: $tables"
    
    mysqldump \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --single-transaction \
        --routines \
        --triggers \
        "$DB_NAME" $tables > "$backup_file"
    
    BACKUP_FILE="$backup_file"
}

# å¤‡ä»½è¡¨ç»“æ„ï¼ˆä¸åŒ…å«æ•°æ®ï¼‰
backup_schema_only() {
    local backup_file="${CURRENT_BACKUP_DIR}/schema_backup_$(date +%Y%m%d_%H%M%S).sql"
    
    log "INFO" "å¤‡ä»½æ•°æ®åº“ç»“æ„ï¼ˆä¸å«æ•°æ®ï¼‰"
    
    mysqldump \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --no-data \
        --routines \
        --triggers \
        --events \
        "$DB_NAME" > "$backup_file"
    
    BACKUP_FILE="$backup_file"
}
```

---

## 4. ğŸ”„ æ¢å¤è„šæœ¬å¼€å‘


### 4.1 å®Œæ•´æ¢å¤è„šæœ¬


**ä¸»æ¢å¤è„šæœ¬**ï¼ˆ`mysql_restore.sh`ï¼‰ï¼š
```bash
#!/bin/bash
# =======================================================
# MySQLè‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬
# =======================================================

set -e
set -u

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
source "${SCRIPT_DIR}/backup_config.conf"

# ä½¿ç”¨è¯´æ˜
usage() {
    cat << EOF
ä½¿ç”¨æ–¹æ³•: $0 [é€‰é¡¹] <å¤‡ä»½æ–‡ä»¶>

é€‰é¡¹:
    -h, --help          æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    -d, --database      ç›®æ ‡æ•°æ®åº“åï¼ˆé»˜è®¤ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“ï¼‰
    -f, --force         å¼ºåˆ¶æ¢å¤ï¼Œä¸è¿›è¡Œç¡®è®¤
    -t, --test          æµ‹è¯•æ¨¡å¼ï¼ŒåªéªŒè¯å¤‡ä»½æ–‡ä»¶
    -v, --verbose       è¯¦ç»†è¾“å‡ºæ¨¡å¼

ç¤ºä¾‹:
    $0 /path/to/backup.sql
    $0 -d test_db -f /path/to/backup.sql.gz
    $0 --test /path/to/backup.sql

EOF
}

# è§£æå‘½ä»¤è¡Œå‚æ•°
parse_arguments() {
    RESTORE_FILE=""
    TARGET_DB="$DB_NAME"
    FORCE_RESTORE=false
    TEST_MODE=false
    VERBOSE=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                usage
                exit 0
                ;;
            -d|--database)
                TARGET_DB="$2"
                shift 2
                ;;
            -f|--force)
                FORCE_RESTORE=true
                shift
                ;;
            -t|--test)
                TEST_MODE=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -*)
                log "ERROR" "æœªçŸ¥é€‰é¡¹: $1"
                usage
                exit 1
                ;;
            *)
                RESTORE_FILE="$1"
                shift
                ;;
        esac
    done
    
    if [[ -z "$RESTORE_FILE" ]]; then
        log "ERROR" "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶"
        usage
        exit 1
    fi
}

# éªŒè¯å¤‡ä»½æ–‡ä»¶
validate_backup_file() {
    log "INFO" "éªŒè¯å¤‡ä»½æ–‡ä»¶: $RESTORE_FILE"
    
    if [[ ! -f "$RESTORE_FILE" ]]; then
        log "ERROR" "å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $RESTORE_FILE"
        return 1
    fi
    
    # æ£€æŸ¥æ–‡ä»¶æ ¼å¼
    local file_type=$(file "$RESTORE_FILE")
    case "$file_type" in
        *"gzip compressed"*)
            log "INFO" "æ£€æµ‹åˆ°gzipå‹ç¼©æ–‡ä»¶"
            RESTORE_COMMAND="gunzip -c"
            ;;
        *"Zip archive"*)
            log "INFO" "æ£€æµ‹åˆ°zipå‹ç¼©æ–‡ä»¶"
            RESTORE_COMMAND="unzip -p"
            ;;
        *"ASCII text"*|*"UTF-8 text"*)
            log "INFO" "æ£€æµ‹åˆ°SQLæ–‡æœ¬æ–‡ä»¶"
            RESTORE_COMMAND="cat"
            ;;
        *)
            log "ERROR" "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: $file_type"
            return 1
            ;;
    esac
    
    return 0
}

# æµ‹è¯•å¤‡ä»½æ–‡ä»¶å†…å®¹
test_backup_file() {
    log "INFO" "æµ‹è¯•å¤‡ä»½æ–‡ä»¶å†…å®¹..."
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å«SQLè¯­å¥
    local sql_check=$($RESTORE_COMMAND "$RESTORE_FILE" | head -20 | grep -c "^--\|^/\*\|INSERT\|CREATE\|DROP\|ALTER" || true)
    
    if [[ $sql_check -eq 0 ]]; then
        log "ERROR" "å¤‡ä»½æ–‡ä»¶ä¸åŒ…å«æœ‰æ•ˆçš„SQLè¯­å¥"
        return 1
    fi
    
    log "INFO" "å¤‡ä»½æ–‡ä»¶æ ¼å¼éªŒè¯é€šè¿‡"
    
    # å¦‚æœæ˜¯æµ‹è¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯åé€€å‡º
    if [[ "$TEST_MODE" == true ]]; then
        local file_size=$(du -h "$RESTORE_FILE" | cut -f1)
        log "INFO" "å¤‡ä»½æ–‡ä»¶å¤§å°: $file_size"
        log "INFO" "å‹ç¼©æ ¼å¼: $RESTORE_COMMAND"
        log "INFO" "ç›®æ ‡æ•°æ®åº“: $TARGET_DB"
        log "INFO" "æµ‹è¯•å®Œæˆï¼Œæ–‡ä»¶å¯ä»¥æ­£å¸¸æ¢å¤"
        exit 0
    fi
}

# å¤‡ä»½å½“å‰æ•°æ®åº“
backup_current_database() {
    if [[ "$FORCE_RESTORE" == true ]]; then
        log "INFO" "å¼ºåˆ¶æ¨¡å¼ï¼Œè·³è¿‡å½“å‰æ•°æ®åº“å¤‡ä»½"
        return 0
    fi
    
    log "INFO" "æ¢å¤å‰å¤‡ä»½å½“å‰æ•°æ®åº“..."
    local pre_restore_backup="${BACKUP_DIR}/pre_restore_$(date +%Y%m%d_%H%M%S).sql"
    
    if mysqldump \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --single-transaction \
        --routines \
        --triggers \
        --events \
        "$TARGET_DB" > "$pre_restore_backup"; then
        
        log "INFO" "å½“å‰æ•°æ®åº“å¤‡ä»½å®Œæˆ: $pre_restore_backup"
        return 0
    else
        log "ERROR" "å½“å‰æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        return 1
    fi
}

# æ‰§è¡Œæ¢å¤æ“ä½œ
perform_restore() {
    log "INFO" "å¼€å§‹æ¢å¤æ•°æ®åº“: $TARGET_DB"
    log "INFO" "å¤‡ä»½æ–‡ä»¶: $RESTORE_FILE"
    
    # è¯¢é—®ç”¨æˆ·ç¡®è®¤ï¼ˆé™¤éæ˜¯å¼ºåˆ¶æ¨¡å¼ï¼‰
    if [[ "$FORCE_RESTORE" != true ]]; then
        echo -n "ç¡®è®¤è¦æ¢å¤æ•°æ®åº“ '$TARGET_DB' å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰æ•°æ® [y/N]: "
        read -r confirmation
        if [[ "$confirmation" != "y" && "$confirmation" != "Y" ]]; then
            log "INFO" "ç”¨æˆ·å–æ¶ˆæ¢å¤æ“ä½œ"
            exit 0
        fi
    fi
    
    # æ‰§è¡Œæ¢å¤
    local start_time=$(date +%s)
    
    if $RESTORE_COMMAND "$RESTORE_FILE" | mysql \
        --host="$DB_HOST" \
        --port="$DB_PORT" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        "$TARGET_DB"; then
        
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        log "INFO" "æ•°æ®åº“æ¢å¤å®Œæˆï¼Œè€—æ—¶: ${duration}ç§’"
        return 0
    else
        log "ERROR" "æ•°æ®åº“æ¢å¤å¤±è´¥"
        return 1
    fi
}

# æ¢å¤åéªŒè¯
verify_restore() {
    log "INFO" "éªŒè¯æ¢å¤ç»“æœ..."
    
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if ! mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $TARGET_DB; SELECT 1;" >/dev/null 2>&1; then
        log "ERROR" "æ¢å¤åæ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥è¡¨æ•°é‡
    local table_count=$(mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $TARGET_DB; SHOW TABLES;" | wc -l)
    log "INFO" "æ•°æ®åº“åŒ…å« $table_count ä¸ªè¡¨"
    
    # åŸºæœ¬å®Œæ•´æ€§æ£€æŸ¥
    mysql -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $TARGET_DB; CHECK TABLE \$(SHOW TABLES);" >/dev/null 2>&1 || {
        log "WARN" "è¡¨å®Œæ•´æ€§æ£€æŸ¥å‘ç°é—®é¢˜ï¼Œè¯·æ‰‹åŠ¨éªŒè¯"
    }
    
    log "INFO" "æ¢å¤éªŒè¯å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    log "INFO" "========== MySQLæ•°æ®åº“æ¢å¤å¼€å§‹ =========="
    
    parse_arguments "$@"
    validate_backup_file || exit 1
    test_backup_file || exit 1
    backup_current_database || exit 1
    perform_restore || exit 1
    verify_restore || exit 1
    
    log "INFO" "========== MySQLæ•°æ®åº“æ¢å¤å®Œæˆ =========="
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 4.2 è‡ªåŠ¨åŒ–æ¢å¤éªŒè¯


**æ¢å¤éªŒè¯è„šæœ¬**ï¼š
```bash
# æ•°æ®ä¸€è‡´æ€§éªŒè¯
verify_data_consistency() {
    local source_db="$1"
    local target_db="$2"
    
    log "INFO" "å¼€å§‹æ•°æ®ä¸€è‡´æ€§éªŒè¯..."
    
    # æ¯”è¾ƒè¡¨æ•°é‡
    local source_tables=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $source_db; SHOW TABLES;" | wc -l)
    local target_tables=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $target_db; SHOW TABLES;" | wc -l)
    
    if [[ $source_tables -ne $target_tables ]]; then
        log "ERROR" "è¡¨æ•°é‡ä¸åŒ¹é…: æºæ•°æ®åº“($source_tables) vs ç›®æ ‡æ•°æ®åº“($target_tables)"
        return 1
    fi
    
    # æ¯”è¾ƒè¡¨ç»“æ„
    local tables=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $source_db; SHOW TABLES;" | tail -n +2)
    
    while read -r table; do
        local source_checksum=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "CHECKSUM TABLE $source_db.$table;" | awk '{print $2}' | tail -n 1)
        local target_checksum=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "CHECKSUM TABLE $target_db.$table;" | awk '{print $2}' | tail -n 1)
        
        if [[ "$source_checksum" != "$target_checksum" ]]; then
            log "WARN" "è¡¨ $table æ ¡éªŒå’Œä¸åŒ¹é…"
        else
            log "DEBUG" "è¡¨ $table æ ¡éªŒå’ŒåŒ¹é…"
        fi
    done <<< "$tables"
    
    log "INFO" "æ•°æ®ä¸€è‡´æ€§éªŒè¯å®Œæˆ"
}
```

---

## 5. â° å®šæ—¶ä»»åŠ¡é…ç½®


### 5.1 crontabåŸºç¡€çŸ¥è¯†


**crontabæ—¶é—´æ ¼å¼è¯´æ˜**ï¼š
```
åˆ†é’Ÿ(0-59) å°æ—¶(0-23) æ—¥æœŸ(1-31) æœˆä»½(1-12) æ˜ŸæœŸ(0-7)

ç‰¹æ®Šç¬¦å·å«ä¹‰ï¼š
* : ä»»æ„å€¼
, : åˆ†éš”å¤šä¸ªå€¼ (å¦‚: 1,3,5)
- : è¡¨ç¤ºèŒƒå›´ (å¦‚: 1-5)
/ : è¡¨ç¤ºé—´éš” (å¦‚: */10 è¡¨ç¤ºæ¯10åˆ†é’Ÿ)
? : ä¸*ç›¸åŒï¼Œç”¨äºæ—¥æœŸå’Œæ˜ŸæœŸå­—æ®µ

å¸¸ç”¨æ—¶é—´ç¤ºä¾‹ï¼š
0 2 * * *     # æ¯å¤©å‡Œæ™¨2ç‚¹
30 1 * * 0    # æ¯å‘¨æ—¥å‡Œæ™¨1:30
0 */6 * * *   # æ¯6å°æ—¶
0 0 1 * *     # æ¯æœˆ1å·å‡Œæ™¨
```

### 5.2 å¤‡ä»½ä»»åŠ¡è°ƒåº¦é…ç½®


**å®Œæ•´çš„crontabé…ç½®**ï¼š
```bash
#!/bin/bash
# é…ç½®MySQLå¤‡ä»½çš„å®šæ—¶ä»»åŠ¡

# ç¼–è¾‘crontab
configure_backup_cron() {
    log "INFO" "é…ç½®å¤‡ä»½å®šæ—¶ä»»åŠ¡..."
    
    # ç”Ÿæˆcrontabæ¡ç›®
    cat << EOF > /tmp/mysql_backup_cron
# MySQLæ•°æ®åº“è‡ªåŠ¨å¤‡ä»½ä»»åŠ¡
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå…¨é‡å¤‡ä»½
0 2 * * * /data/scripts/mysql_backup.sh >> /var/log/mysql_backup/cron.log 2>&1

# æ¯4å°æ—¶æ‰§è¡Œå¢é‡å¤‡ä»½ï¼ˆå·¥ä½œæ—¶é—´ï¼‰
0 6,10,14,18,22 * * * /data/scripts/mysql_backup.sh --incremental >> /var/log/mysql_backup/cron.log 2>&1

# æ¯å‘¨æ—¥å‡Œæ™¨æ‰§è¡Œå¤‡ä»½æ¸…ç†
0 3 * * 0 /data/scripts/cleanup_old_backups.sh >> /var/log/mysql_backup/cron.log 2>&1

# æ¯æœˆ1å·æ‰§è¡Œå¤‡ä»½éªŒè¯
0 4 1 * * /data/scripts/verify_backups.sh >> /var/log/mysql_backup/cron.log 2>&1
EOF
    
    # å®‰è£…crontab
    crontab /tmp/mysql_backup_cron
    rm /tmp/mysql_backup_cron
    
    log "INFO" "å®šæ—¶ä»»åŠ¡é…ç½®å®Œæˆ"
    
    # æ˜¾ç¤ºå½“å‰crontab
    log "INFO" "å½“å‰å®šæ—¶ä»»åŠ¡åˆ—è¡¨:"
    crontab -l
}

# éªŒè¯crontabé…ç½®
verify_cron_setup() {
    log "INFO" "éªŒè¯å®šæ—¶ä»»åŠ¡é…ç½®..."
    
    if crontab -l | grep -q "mysql_backup.sh"; then
        log "INFO" "å¤‡ä»½ä»»åŠ¡å·²æ­£ç¡®é…ç½®"
    else
        log "ERROR" "å¤‡ä»½ä»»åŠ¡é…ç½®å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥æ—¥å¿—ç›®å½•æƒé™
    if [[ ! -w "/var/log/mysql_backup" ]]; then
        log "WARN" "æ—¥å¿—ç›®å½•æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥"
    fi
}
```

### 5.3 ä»»åŠ¡ç›‘æ§è„šæœ¬


**ç›‘æ§è„šæœ¬**ï¼ˆ`monitor_backup_jobs.sh`ï¼‰ï¼š
```bash
#!/bin/bash
# =======================================================
# å¤‡ä»½ä»»åŠ¡ç›‘æ§è„šæœ¬
# =======================================================

# æ£€æŸ¥å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
check_backup_status() {
    local today=$(date +%Y%m%d)
    local backup_log="/var/log/mysql_backup/backup_${today}.log"
    
    log "INFO" "æ£€æŸ¥ä»Šå¤©çš„å¤‡ä»½ä»»åŠ¡çŠ¶æ€..."
    
    if [[ ! -f "$backup_log" ]]; then
        log "ERROR" "ä»Šå¤©çš„å¤‡ä»½æ—¥å¿—ä¸å­˜åœ¨: $backup_log"
        return 1
    fi
    
    # æ£€æŸ¥æœ€åä¸€æ¬¡å¤‡ä»½æ˜¯å¦æˆåŠŸ
    if grep -q "å¤‡ä»½å®Œæˆ" "$backup_log"; then
        local last_backup_time=$(grep "å¤‡ä»½å®Œæˆ" "$backup_log" | tail -1 | awk '{print $1 " " $2}')
        log "INFO" "æœ€åä¸€æ¬¡å¤‡ä»½æˆåŠŸæ—¶é—´: $last_backup_time"
    else
        log "ERROR" "ä»Šå¤©æ²¡æœ‰æˆåŠŸçš„å¤‡ä»½è®°å½•"
        return 1
    fi
    
    # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    local backup_dir="/data/mysql_backups"
    local today_backups=$(find "$backup_dir" -name "*${today}*" -type f | wc -l)
    
    if [[ $today_backups -gt 0 ]]; then
        log "INFO" "ä»Šå¤©äº§ç”Ÿäº† $today_backups ä¸ªå¤‡ä»½æ–‡ä»¶"
    else
        log "ERROR" "ä»Šå¤©æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
        return 1
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local backup_dir="/data/mysql_backups"
    local threshold=80  # ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼
    
    local disk_usage=$(df "$backup_dir" | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [[ $disk_usage -gt $threshold ]]; then
        log "WARN" "å¤‡ä»½ç›®å½•ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${disk_usage}%"
        return 1
    else
        log "INFO" "å¤‡ä»½ç›®å½•ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: ${disk_usage}%"
    fi
}

# ä¸»ç›‘æ§å‡½æ•°
main() {
    log "INFO" "å¼€å§‹å¤‡ä»½ä»»åŠ¡ç›‘æ§æ£€æŸ¥..."
    
    local status=0
    
    check_backup_status || status=1
    check_disk_space || status=1
    
    if [[ $status -eq 0 ]]; then
        log "INFO" "å¤‡ä»½ä»»åŠ¡ç›‘æ§æ£€æŸ¥é€šè¿‡"
    else
        log "ERROR" "å¤‡ä»½ä»»åŠ¡ç›‘æ§æ£€æŸ¥å‘ç°é—®é¢˜"
        # è¿™é‡Œå¯ä»¥é›†æˆæŠ¥è­¦é€šçŸ¥
    fi
    
    return $status
}

main "$@"
```

---

## 6. ğŸ“Š æ—¥å¿—ä¸ç›‘æ§æœºåˆ¶


### 6.1 å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ


**æ—¥å¿—ç®¡ç†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# =======================================================
# æ—¥å¿—ç®¡ç†ç³»ç»Ÿ
# =======================================================

# æ—¥å¿—çº§åˆ«å®šä¹‰
declare -A LOG_LEVELS=(
    ["DEBUG"]=0
    ["INFO"]=1
    ["WARN"]=2
    ["ERROR"]=3
    ["FATAL"]=4
)

# é«˜çº§æ—¥å¿—å‡½æ•°
log_advanced() {
    local level="$1"
    local message="$2"
    local caller="${3:-$(basename "${BASH_SOURCE[2]}")}"
    local line_no="${4:-${BASH_LINENO[1]}}"
    
    # æ£€æŸ¥æ—¥å¿—çº§åˆ«
    local current_level=${LOG_LEVELS[$LOG_LEVEL]:-1}
    local msg_level=${LOG_LEVELS[$level]:-1}
    
    if [[ $msg_level -lt $current_level ]]; then
        return 0  # è·³è¿‡ä½çº§åˆ«æ—¥å¿—
    fi
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local pid=$$
    local log_file="${LOG_DIR}/backup_$(date +%Y%m%d).log"
    
    # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
    mkdir -p "$LOG_DIR"
    
    # æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
    local log_entry="[$timestamp] [PID:$pid] [$level] [$caller:$line_no] $message"
    
    # å†™å…¥æ—¥å¿—æ–‡ä»¶
    echo "$log_entry" >> "$log_file"
    
    # æ§åˆ¶å°è¾“å‡ºï¼ˆå¸¦é¢œè‰²ï¼‰
    case "$level" in
        "DEBUG")
            echo -e "\033[36m$log_entry\033[0m"  # é’è‰²
            ;;
        "INFO")
            echo -e "\033[32m$log_entry\033[0m"   # ç»¿è‰²
            ;;
        "WARN")
            echo -e "\033[33m$log_entry\033[0m"   # é»„è‰²
            ;;
        "ERROR")
            echo -e "\033[31m$log_entry\033[0m" >&2  # çº¢è‰²åˆ°stderr
            ;;
        "FATAL")
            echo -e "\033[35m$log_entry\033[0m" >&2  # ç´«è‰²åˆ°stderr
            ;;
    esac
}

# æ—¥å¿—è½®è½¬åŠŸèƒ½
rotate_logs() {
    local max_log_files=30  # ä¿ç•™30å¤©çš„æ—¥å¿—
    
    log_advanced "INFO" "å¼€å§‹æ—¥å¿—è½®è½¬..."
    
    # å‹ç¼©7å¤©å‰çš„æ—¥å¿—
    find "$LOG_DIR" -name "backup_*.log" -mtime +7 -not -name "*.gz" -exec gzip {} \;
    
    # åˆ é™¤30å¤©å‰çš„å‹ç¼©æ—¥å¿—
    local deleted_logs=$(find "$LOG_DIR" -name "backup_*.log.gz" -mtime +$max_log_files -delete -print | wc -l)
    
    log_advanced "INFO" "æ—¥å¿—è½®è½¬å®Œæˆï¼Œåˆ é™¤äº† $deleted_logs ä¸ªæ—§æ—¥å¿—æ–‡ä»¶"
}

# æ—¥å¿—ç»Ÿè®¡åˆ†æ
analyze_logs() {
    local days=${1:-7}  # é»˜è®¤åˆ†ææœ€è¿‘7å¤©
    local start_date=$(date -d "$days days ago" +%Y%m%d)
    
    log_advanced "INFO" "åˆ†ææœ€è¿‘ $days å¤©çš„å¤‡ä»½æ—¥å¿—..."
    
    # ç»Ÿè®¡å„çº§åˆ«æ—¥å¿—æ•°é‡
    local error_count=0
    local warn_count=0
    local success_count=0
    
    for ((i=0; i<days; i++)); do
        local check_date=$(date -d "$i days ago" +%Y%m%d)
        local log_file="${LOG_DIR}/backup_${check_date}.log"
        
        if [[ -f "$log_file" ]]; then
            error_count=$((error_count + $(grep -c "ERROR" "$log_file" 2>/dev/null || echo 0)))
            warn_count=$((warn_count + $(grep -c "WARN" "$log_file" 2>/dev/null || echo 0)))
            success_count=$((success_count + $(grep -c "å¤‡ä»½å®Œæˆ" "$log_file" 2>/dev/null || echo 0)))
        fi
    done
    
    # ç”ŸæˆæŠ¥å‘Š
    cat << EOF

========== å¤‡ä»½æ—¥å¿—åˆ†ææŠ¥å‘Š ==========
åˆ†æå‘¨æœŸ: æœ€è¿‘ $days å¤©
æˆåŠŸå¤‡ä»½: $success_count æ¬¡
è­¦å‘Šä¿¡æ¯: $warn_count æ¡
é”™è¯¯ä¿¡æ¯: $error_count æ¡
=====================================

EOF
}
```

### 6.2 æ€§èƒ½ç›‘æ§


**æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼š
```bash
# å¤‡ä»½æ€§èƒ½ç›‘æ§
monitor_backup_performance() {
    local backup_file="$1"
    local start_time="$2"
    local end_time="$3"
    
    # è®¡ç®—å¤‡ä»½æ—¶é—´
    local duration=$((end_time - start_time))
    local hours=$((duration / 3600))
    local minutes=$(((duration % 3600) / 60))
    local seconds=$((duration % 60))
    
    # è®¡ç®—å¤‡ä»½æ–‡ä»¶å¤§å°
    local file_size_bytes=$(stat -c%s "$backup_file")
    local file_size_mb=$((file_size_bytes / 1024 / 1024))
    
    # è®¡ç®—å¤‡ä»½é€Ÿåº¦
    local speed_mbps=0
    if [[ $duration -gt 0 ]]; then
        speed_mbps=$((file_size_mb / duration))
    fi
    
    # è®°å½•æ€§èƒ½æ•°æ®
    cat << EOF >> "${LOG_DIR}/performance.log"
$(date '+%Y-%m-%d %H:%M:%S'),${duration},${file_size_mb},${speed_mbps}
EOF
    
    log_advanced "INFO" "å¤‡ä»½æ€§èƒ½ç»Ÿè®¡:"
    log_advanced "INFO" "  è€—æ—¶: ${hours}h ${minutes}m ${seconds}s"
    log_advanced "INFO" "  å¤§å°: ${file_size_mb} MB"
    log_advanced "INFO" "  é€Ÿåº¦: ${speed_mbps} MB/s"
}
```

---

## 7. ğŸ“§ é”™è¯¯å¤„ç†ä¸é€šçŸ¥


### 7.1 é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ


**é‚®ä»¶é€šçŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# =======================================================
# é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ
# =======================================================

# å‘é€é‚®ä»¶å‡½æ•°
send_email() {
    local subject="$1"
    local message="$2"
    local priority="${3:-normal}"  # normal, high, low
    
    if [[ "$EMAIL_ENABLED" != "true" ]]; then
        log_advanced "DEBUG" "é‚®ä»¶é€šçŸ¥å·²ç¦ç”¨"
        return 0
    fi
    
    local temp_file="/tmp/backup_email_$$.txt"
    
    # ç”Ÿæˆé‚®ä»¶å†…å®¹
    cat << EOF > "$temp_file"
To: $EMAIL_TO
Subject: $subject
Priority: $priority
Content-Type: text/html; charset=utf-8

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f0f0f0; padding: 10px; border-left: 4px solid #007cba; }
        .content { margin: 20px 0; }
        .footer { font-size: 12px; color: #666; margin-top: 20px; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="header">
        <h2>MySQLå¤‡ä»½ç³»ç»Ÿé€šçŸ¥</h2>
    </div>
    <div class="content">
        $message
    </div>
    <div class="footer">
        <p>å‘é€æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')</p>
        <p>æœåŠ¡å™¨: $(hostname)</p>
        <p>è„šæœ¬: $SCRIPT_NAME v$SCRIPT_VERSION</p>
    </div>
</body>
</html>
EOF
    
    # å‘é€é‚®ä»¶
    if command -v sendmail >/dev/null 2>&1; then
        sendmail "$EMAIL_TO" < "$temp_file"
        log_advanced "INFO" "é‚®ä»¶é€šçŸ¥å·²å‘é€: $subject"
    elif command -v mail >/dev/null 2>&1; then
        mail -s "$subject" "$EMAIL_TO" < "$temp_file"
        log_advanced "INFO" "é‚®ä»¶é€šçŸ¥å·²å‘é€: $subject"
    else
        log_advanced "ERROR" "æœªæ‰¾åˆ°é‚®ä»¶å‘é€å·¥å…· (sendmail/mail)"
    fi
    
    rm -f "$temp_file"
}

# å‘é€æˆåŠŸé€šçŸ¥
send_success_notification() {
    local backup_file="$1"
    local duration="$2"
    
    local message="
    <div class='success'>
        <h3>âœ… å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ</h3>
        <p><strong>æ•°æ®åº“:</strong> $DB_NAME</p>
        <p><strong>å¤‡ä»½æ–‡ä»¶:</strong> $(basename "$backup_file")</p>
        <p><strong>æ–‡ä»¶å¤§å°:</strong> $(du -h "$backup_file" | cut -f1)</p>
        <p><strong>æ‰§è¡Œæ—¶é—´:</strong> $duration ç§’</p>
        <p><strong>å¤‡ä»½æ—¶é—´:</strong> $(date '+%Y-%m-%d %H:%M:%S')</p>
    </div>
    "
    
    send_email "MySQLå¤‡ä»½æˆåŠŸ - $DB_NAME" "$message" "normal"
}

# å‘é€å¤±è´¥é€šçŸ¥
send_failure_notification() {
    local error_message="$1"
    local step="$2"
    
    local message="
    <div class='error'>
        <h3>âŒ å¤‡ä»½ä»»åŠ¡æ‰§è¡Œå¤±è´¥</h3>
        <p><strong>æ•°æ®åº“:</strong> $DB_NAME</p>
        <p><strong>å¤±è´¥æ­¥éª¤:</strong> $step</p>
        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> $error_message</p>
        <p><strong>å¤±è´¥æ—¶é—´:</strong> $(date '+%Y-%m-%d %H:%M:%S')</p>
        <p><strong>å»ºè®®æ“ä½œ:</strong> è¯·æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¹¶æ‰‹åŠ¨æ‰§è¡Œå¤‡ä»½</p>
    </div>
    "
    
    send_email "MySQLå¤‡ä»½å¤±è´¥ - $DB_NAME" "$message" "high"
}

# å‘é€è­¦å‘Šé€šçŸ¥
send_warning_notification() {
    local warning_message="$1"
    
    local message="
    <div class='warning'>
        <h3>âš ï¸ å¤‡ä»½ä»»åŠ¡è­¦å‘Š</h3>
        <p><strong>æ•°æ®åº“:</strong> $DB_NAME</p>
        <p><strong>è­¦å‘Šä¿¡æ¯:</strong> $warning_message</p>
        <p><strong>å‘ç”Ÿæ—¶é—´:</strong> $(date '+%Y-%m-%d %H:%M:%S')</p>
    </div>
    "
    
    send_email "MySQLå¤‡ä»½è­¦å‘Š - $DB_NAME" "$message" "normal"
}
```

### 7.2 é”™è¯¯å¤„ç†æœºåˆ¶


**é”™è¯¯å¤„ç†å‡½æ•°**ï¼š
```bash
# å…¨å±€é”™è¯¯å¤„ç†
handle_error() {
    local exit_code=$?
    local line_no=$1
    local step="${2:-æœªçŸ¥æ­¥éª¤}"
    
    if [[ $exit_code -ne 0 ]]; then
        local error_msg="è„šæœ¬åœ¨ç¬¬ $line_no è¡Œæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $exit_code"
        log_advanced "ERROR" "$error_msg"
        
        # å‘é€å¤±è´¥é€šçŸ¥
        send_failure_notification "$error_msg" "$step"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        cleanup_on_error
        
        exit $exit_code
    fi
}

# è®¾ç½®é”™è¯¯é™·é˜±
set_error_trap() {
    trap 'handle_error $LINENO "æ•°æ®åº“è¿æ¥"' ERR
}

# é”™è¯¯æ¢å¤æœºåˆ¶
attempt_recovery() {
    local failed_step="$1"
    local max_retries=3
    local retry_count=0
    
    log_advanced "WARN" "æ­¥éª¤å¤±è´¥: $failed_stepï¼Œå°è¯•æ¢å¤..."
    
    while [[ $retry_count -lt $max_retries ]]; do
        ((retry_count++))
        log_advanced "INFO" "ç¬¬ $retry_count æ¬¡é‡è¯•..."
        
        sleep $((retry_count * 10))  # é€’å¢ç­‰å¾…æ—¶é—´
        
        case "$failed_step" in
            "database_connection")
                if check_database_connection; then
                    log_advanced "INFO" "æ•°æ®åº“è¿æ¥æ¢å¤æˆåŠŸ"
                    return 0
                fi
                ;;
            "backup_execution")
                if perform_backup; then
                    log_advanced "INFO" "å¤‡ä»½æ‰§è¡Œæ¢å¤æˆåŠŸ"
                    return 0
                fi
                ;;
        esac
    done
    
    log_advanced "ERROR" "æ¢å¤å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
    return 1
}

# æ¸…ç†å‡½æ•°
cleanup_on_error() {
    log_advanced "INFO" "æ‰§è¡Œé”™è¯¯æ¸…ç†..."
    
    # æ¸…ç†ä¸å®Œæ•´çš„å¤‡ä»½æ–‡ä»¶
    if [[ -n "${BACKUP_FILE:-}" && -f "$BACKUP_FILE" ]]; then
        local file_size=$(stat -c%s "$BACKUP_FILE")
        if [[ $file_size -lt 1024 ]]; then  # å°äº1KBè®¤ä¸ºæ˜¯ä¸å®Œæ•´æ–‡ä»¶
            rm -f "$BACKUP_FILE"
            log_advanced "INFO" "æ¸…ç†ä¸å®Œæ•´çš„å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
        fi
    fi
    
    # æ¸…ç†ä¸´æ—¶ç›®å½•
    if [[ -n "${TEMP_DIR:-}" && -d "$TEMP_DIR" ]]; then
        rm -rf "$TEMP_DIR"
        log_advanced "INFO" "æ¸…ç†ä¸´æ—¶ç›®å½•: $TEMP_DIR"
    fi
}
```

---

## 8. ğŸ§ª è„šæœ¬æµ‹è¯•ä¸ç»´æŠ¤


### 8.1 è„šæœ¬æµ‹è¯•æ¡†æ¶


**æµ‹è¯•è„šæœ¬**ï¼ˆ`test_backup_scripts.sh`ï¼‰ï¼š
```bash
#!/bin/bash
# =======================================================
# å¤‡ä»½è„šæœ¬æµ‹è¯•æ¡†æ¶
# =======================================================

# æµ‹è¯•ç¯å¢ƒè®¾ç½®
setup_test_environment() {
    export TEST_MODE=true
    export TEST_DB="test_backup_db"
    export TEST_BACKUP_DIR="/tmp/backup_test"
    export LOG_LEVEL="DEBUG"
    
    # åˆ›å»ºæµ‹è¯•ç›®å½•
    mkdir -p "$TEST_BACKUP_DIR"
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®åº“
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS $TEST_DB;"
    
    # åˆ›å»ºæµ‹è¯•è¡¨å’Œæ•°æ®
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" "$TEST_DB" << EOF
CREATE TABLE IF NOT EXISTS test_table (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO test_table (name) VALUES 
('æµ‹è¯•æ•°æ®1'), ('æµ‹è¯•æ•°æ®2'), ('æµ‹è¯•æ•°æ®3');
EOF
    
    echo "æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ"
}

# æµ‹è¯•ç”¨ä¾‹1ï¼šåŸºæœ¬å¤‡ä»½åŠŸèƒ½
test_basic_backup() {
    echo "æµ‹è¯•ç”¨ä¾‹1: åŸºæœ¬å¤‡ä»½åŠŸèƒ½"
    
    # ä¿®æ”¹é…ç½®ä¸ºæµ‹è¯•ç¯å¢ƒ
    local original_db="$DB_NAME"
    local original_dir="$BACKUP_DIR"
    
    export DB_NAME="$TEST_DB"
    export BACKUP_DIR="$TEST_BACKUP_DIR"
    
    # æ‰§è¡Œå¤‡ä»½
    if bash mysql_backup.sh; then
        echo "âœ… åŸºæœ¬å¤‡ä»½æµ‹è¯•é€šè¿‡"
        
        # æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        local backup_files=$(find "$TEST_BACKUP_DIR" -name "*.sql*" | wc -l)
        if [[ $backup_files -gt 0 ]]; then
            echo "âœ… å¤‡ä»½æ–‡ä»¶ç”Ÿæˆæµ‹è¯•é€šè¿‡"
        else
            echo "âŒ å¤‡ä»½æ–‡ä»¶ç”Ÿæˆæµ‹è¯•å¤±è´¥"
            return 1
        fi
    else
        echo "âŒ åŸºæœ¬å¤‡ä»½æµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    # æ¢å¤åŸå§‹é…ç½®
    export DB_NAME="$original_db"
    export BACKUP_DIR="$original_dir"
}

# æµ‹è¯•ç”¨ä¾‹2ï¼šæ¢å¤åŠŸèƒ½
test_restore_functionality() {
    echo "æµ‹è¯•ç”¨ä¾‹2: æ¢å¤åŠŸèƒ½"
    
    # æ‰¾åˆ°æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶
    local backup_file=$(find "$TEST_BACKUP_DIR" -name "*.sql*" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
    
    if [[ -z "$backup_file" ]]; then
        echo "âŒ æœªæ‰¾åˆ°æµ‹è¯•å¤‡ä»½æ–‡ä»¶"
        return 1
    fi
    
    # åˆ›å»ºæ–°çš„æµ‹è¯•æ•°æ®åº“
    local restore_db="${TEST_DB}_restore"
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS $restore_db;"
    
    # æ‰§è¡Œæ¢å¤
    if bash mysql_restore.sh -d "$restore_db" -f "$backup_file"; then
        echo "âœ… æ¢å¤åŠŸèƒ½æµ‹è¯•é€šè¿‡"
        
        # éªŒè¯æ•°æ®
        local record_count=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "USE $restore_db; SELECT COUNT(*) FROM test_table;" | tail -1)
        if [[ $record_count -eq 3 ]]; then
            echo "âœ… æ•°æ®æ¢å¤éªŒè¯é€šè¿‡"
        else
            echo "âŒ æ•°æ®æ¢å¤éªŒè¯å¤±è´¥: æœŸæœ›3æ¡è®°å½•ï¼Œå®é™…$record_countæ¡"
            return 1
        fi
    else
        echo "âŒ æ¢å¤åŠŸèƒ½æµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    # æ¸…ç†æµ‹è¯•æ•°æ®åº“
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "DROP DATABASE $restore_db;"
}

# æµ‹è¯•ç”¨ä¾‹3ï¼šé”™è¯¯å¤„ç†
test_error_handling() {
    echo "æµ‹è¯•ç”¨ä¾‹3: é”™è¯¯å¤„ç†"
    
    # æµ‹è¯•æ•°æ®åº“è¿æ¥å¤±è´¥
    local original_password="$DB_PASSWORD"
    export DB_PASSWORD="wrong_password"
    
    if bash mysql_backup.sh 2>/dev/null; then
        echo "âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: åº”è¯¥å› å¯†ç é”™è¯¯è€Œå¤±è´¥"
        export DB_PASSWORD="$original_password"
        return 1
    else
        echo "âœ… æ•°æ®åº“è¿æ¥é”™è¯¯å¤„ç†æµ‹è¯•é€šè¿‡"
    fi
    
    # æ¢å¤æ­£ç¡®å¯†ç 
    export DB_PASSWORD="$original_password"
}

# æ€§èƒ½æµ‹è¯•
test_performance() {
    echo "æµ‹è¯•ç”¨ä¾‹4: æ€§èƒ½æµ‹è¯•"
    
    local start_time=$(date +%s)
    
    # æ‰§è¡Œå¤‡ä»½
    bash mysql_backup.sh >/dev/null 2>&1
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    echo "å¤‡ä»½è€—æ—¶: ${duration}ç§’"
    
    if [[ $duration -lt 60 ]]; then  # å°æ•°æ®åº“åº”è¯¥åœ¨60ç§’å†…å®Œæˆ
        echo "âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡"
    else
        echo "âš ï¸ æ€§èƒ½æµ‹è¯•è­¦å‘Š: å¤‡ä»½æ—¶é—´è¾ƒé•¿"
    fi
}

# æ¸…ç†æµ‹è¯•ç¯å¢ƒ
cleanup_test_environment() {
    echo "æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
    
    # åˆ é™¤æµ‹è¯•æ•°æ®åº“
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "DROP DATABASE IF EXISTS $TEST_DB;"
    
    # åˆ é™¤æµ‹è¯•æ–‡ä»¶
    rm -rf "$TEST_BACKUP_DIR"
    
    echo "æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ"
}

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
run_all_tests() {
    echo "========== å¼€å§‹å¤‡ä»½è„šæœ¬æµ‹è¯• =========="
    
    local test_results=()
    
    setup_test_environment
    
    # æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
    test_basic_backup && test_results+=("âœ… åŸºæœ¬å¤‡ä»½") || test_results+=("âŒ åŸºæœ¬å¤‡ä»½")
    test_restore_functionality && test_results+=("âœ… æ¢å¤åŠŸèƒ½") || test_results+=("âŒ æ¢å¤åŠŸèƒ½")
    test_error_handling && test_results+=("âœ… é”™è¯¯å¤„ç†") || test_results+=("âŒ é”™è¯¯å¤„ç†")
    test_performance && test_results+=("âœ… æ€§èƒ½æµ‹è¯•") || test_results+=("âŒ æ€§èƒ½æµ‹è¯•")
    
    cleanup_test_environment
    
    # æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    echo "========== æµ‹è¯•ç»“æœæ±‡æ€» =========="
    for result in "${test_results[@]}"; do
        echo "$result"
    done
    echo "=============================="
}

# æ‰§è¡Œæµ‹è¯•
run_all_tests
```

### 8.2 è„šæœ¬ç»´æŠ¤ä¸æ›´æ–°


**ç‰ˆæœ¬ç®¡ç†è„šæœ¬**ï¼š
```bash
# è„šæœ¬ç‰ˆæœ¬ç®¡ç†
manage_script_version() {
    local action="$1"  # check, update, rollback
    
    case "$action" in
        "check")
            echo "å½“å‰è„šæœ¬ç‰ˆæœ¬ä¿¡æ¯:"
            echo "  å¤‡ä»½è„šæœ¬: $(grep "SCRIPT_VERSION=" mysql_backup.sh | cut -d'"' -f2)"
            echo "  æ¢å¤è„šæœ¬: $(grep "SCRIPT_VERSION=" mysql_restore.sh | cut -d'"' -f2)"
            echo "  æœ€åæ›´æ–°: $(stat -c %y mysql_backup.sh)"
            ;;
        "backup")
            local backup_dir="script_backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$backup_dir"
            cp *.sh *.conf "$backup_dir/"
            echo "è„šæœ¬å·²å¤‡ä»½åˆ°: $backup_dir"
            ;;
        "update")
            # åœ¨æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½
            manage_script_version "backup"
            echo "å‡†å¤‡æ›´æ–°è„šæœ¬..."
            # è¿™é‡Œå¯ä»¥é›†æˆä»ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ‹‰å–æœ€æ–°ç‰ˆæœ¬çš„é€»è¾‘
            ;;
    esac
}

# å¥åº·æ£€æŸ¥
health_check() {
    echo "æ‰§è¡Œè„šæœ¬å¥åº·æ£€æŸ¥..."
    
    local issues=0
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [[ ! -f "backup_config.conf" ]]; then
        echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        ((issues++))
    fi
    
    # æ£€æŸ¥è„šæœ¬æƒé™
    if [[ ! -x "mysql_backup.sh" ]]; then
        echo "âŒ å¤‡ä»½è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™"
        ((issues++))
    fi
    
    # æ£€æŸ¥ç›®å½•æƒé™
    if [[ ! -w "$BACKUP_DIR" ]]; then
        echo "âŒ å¤‡ä»½ç›®å½•æ²¡æœ‰å†™æƒé™"
        ((issues++))
    fi
    
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if ! mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "SELECT 1;" >/dev/null 2>&1; then
        echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        ((issues++))
    fi
    
    if [[ $issues -eq 0 ]]; then
        echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        echo "âŒ å‘ç° $issues ä¸ªé—®é¢˜"
    fi
    
    return $issues
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 è‡ªåŠ¨åŒ–è„šæœ¬çš„å…³é”®è¦ç´ 


```
ğŸ”§ è„šæœ¬è®¾è®¡åŸåˆ™:
â€¢ æ¨¡å—åŒ–è®¾è®¡ - åŠŸèƒ½ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤
â€¢ å‚æ•°åŒ–é…ç½® - é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†å‚æ•°
â€¢ å®Œå–„çš„æ—¥å¿— - è®°å½•è¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹
â€¢ é”™è¯¯å¤„ç†æœºåˆ¶ - è‡ªåŠ¨æ¢å¤å’ŒæŠ¥è­¦é€šçŸ¥
â€¢ æµ‹è¯•éªŒè¯ - ç¡®ä¿è„šæœ¬åŠŸèƒ½æ­£ç¡®æ€§

â° å®šæ—¶ä»»åŠ¡é…ç½®:
â€¢ crontabè¯­æ³• - æŒæ¡æ—¶é—´æ ¼å¼è¡¨è¾¾
â€¢ ä»»åŠ¡è°ƒåº¦ - åˆç†å®‰æ’å¤‡ä»½æ—¶é—´
â€¢ æ—¥å¿—è®°å½• - è®°å½•å®šæ—¶ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
â€¢ ç›‘æ§æ£€æŸ¥ - å®šæœŸæ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
```

### 9.2 Shellè„šæœ¬ç¼–å†™æœ€ä½³å®è·µ


**ä»£ç è§„èŒƒè¦ç‚¹**:
```bash
# è„šæœ¬å¤´éƒ¨è§„èŒƒ
#!/bin/bash
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™
set -o pipefail  # ç®¡é“ä¸­ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½è¿”å›éé›¶çŠ¶æ€

# å˜é‡å‘½åè§„èŒƒ
readonly SCRIPT_NAME="mysql_backup.sh"
readonly SCRIPT_VERSION="1.0"
DB_HOST="localhost"  # å…¨å±€å˜é‡å¤§å†™
local backup_file=""  # å±€éƒ¨å˜é‡å°å†™

# å‡½æ•°å®šä¹‰è§„èŒƒ
function_name() {
    local param1="$1"
    local param2="${2:-default_value}"
    
    # å‡½æ•°ä½“
    return 0
}
```

**é”™è¯¯å¤„ç†ç­–ç•¥**:
```
âœ… è®¾ç½®é”™è¯¯é™·é˜± - trapå‘½ä»¤æ•è·é”™è¯¯
âœ… å‚æ•°éªŒè¯ - æ£€æŸ¥å¿…éœ€å‚æ•°æ˜¯å¦å­˜åœ¨
âœ… æ–‡ä»¶æ£€æŸ¥ - éªŒè¯æ–‡ä»¶æƒé™å’Œè·¯å¾„
âœ… ç½‘ç»œæ£€æŸ¥ - ç¡®è®¤æ•°æ®åº“è¿æ¥å¯ç”¨
âœ… ç©ºé—´æ£€æŸ¥ - ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
âœ… é‡è¯•æœºåˆ¶ - ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
âœ… æ¸…ç†æœºåˆ¶ - å¤±è´¥æ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### 9.3 å¤‡ä»½ç­–ç•¥ä¸æœ€ä½³å®è·µ


**å¤‡ä»½ç­–ç•¥ç»„åˆ**:
```
å…¨é‡å¤‡ä»½ï¼ˆWeeklyï¼‰:
â€¢ æ¯å‘¨æ‰§è¡Œä¸€æ¬¡å®Œæ•´å¤‡ä»½
â€¢ åŒ…å«æ‰€æœ‰æ•°æ®å’Œç»“æ„
â€¢ ä½œä¸ºæ¢å¤çš„åŸºå‡†ç‚¹

å¢é‡å¤‡ä»½ï¼ˆDailyï¼‰:
â€¢ æ¯å¤©æ‰§è¡Œå¢é‡å¤‡ä»½
â€¢ åªå¤‡ä»½å˜åŒ–çš„æ•°æ®
â€¢ ç»“åˆbinlogå®ç°

ç»“æ„å¤‡ä»½ï¼ˆMonthlyï¼‰:
â€¢ æ¯æœˆå¤‡ä»½ä¸€æ¬¡è¡¨ç»“æ„
â€¢ ä¾¿äºå¿«é€Ÿé‡å»ºæ•°æ®åº“æ¡†æ¶
â€¢ ç”¨äºå¼€å‘ç¯å¢ƒæ­å»º
```

**å¤‡ä»½æ–‡ä»¶ç®¡ç†**:
```
æ–‡ä»¶å‘½åè§„èŒƒ:
â€¢ å…¨é‡: mysql_full_20250911_020000.sql.gz
â€¢ å¢é‡: mysql_incr_20250911_140000.sql.gz
â€¢ ç»“æ„: mysql_schema_20250901_030000.sql

å­˜å‚¨ç­–ç•¥:
â€¢ æœ¬åœ°å­˜å‚¨: ä¿ç•™7å¤©
â€¢ è¿œç¨‹å­˜å‚¨: ä¿ç•™30å¤©
â€¢ å½’æ¡£å­˜å‚¨: ä¿ç•™1å¹´
â€¢ å‹ç¼©æ¯”ä¾‹: é€šå¸¸å¯è¾¾70-80%
```

### 9.4 ç›‘æ§ä¸æŠ¥è­¦æœºåˆ¶


**ç›‘æ§æŒ‡æ ‡ä½“ç³»**:
```
ğŸ“Š æ‰§è¡ŒçŠ¶æ€ç›‘æ§:
â€¢ å¤‡ä»½æˆåŠŸç‡ - æœ€è¿‘30å¤©æˆåŠŸç‡åº”>95%
â€¢ æ‰§è¡Œæ—¶é—´ - ç›‘æ§å¤‡ä»½è€—æ—¶è¶‹åŠ¿
â€¢ æ–‡ä»¶å¤§å° - æ£€æµ‹å¼‚å¸¸å¤§å°å˜åŒ–
â€¢ é”™è¯¯é¢‘ç‡ - ç»Ÿè®¡å„ç±»é”™è¯¯å‡ºç°æ¬¡æ•°

ğŸ“Š èµ„æºç›‘æ§:
â€¢ ç£ç›˜ä½¿ç”¨ç‡ - å¤‡ä»½ç›®å½•ç©ºé—´ä½¿ç”¨æƒ…å†µ
â€¢ ç½‘ç»œè¿æ¥ - æ•°æ®åº“è¿æ¥çŠ¶æ€
â€¢ ç³»ç»Ÿè´Ÿè½½ - å¤‡ä»½æœŸé—´ç³»ç»Ÿæ€§èƒ½å½±å“
â€¢ å†…å­˜ä½¿ç”¨ - mysqldumpè¿›ç¨‹å†…å­˜æ¶ˆè€—
```

**æŠ¥è­¦ç­–ç•¥è®¾è®¡**:
```
ğŸ”´ ä¸¥é‡å‘Šè­¦ï¼ˆç«‹å³å¤„ç†ï¼‰:
â€¢ è¿ç»­3æ¬¡å¤‡ä»½å¤±è´¥
â€¢ å¤‡ä»½æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼ˆ<10MBæˆ–å˜åŒ–>50%ï¼‰
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³ï¼ˆ>90%ï¼‰
â€¢ æ•°æ®åº“è¿æ¥é•¿æ—¶é—´å¤±è´¥

ğŸŸ¡ è­¦å‘Šå‘Šè­¦ï¼ˆå·¥ä½œæ—¶é—´å¤„ç†ï¼‰:
â€¢ å•æ¬¡å¤‡ä»½å¤±è´¥
â€¢ å¤‡ä»½æ—¶é—´è¶…è¿‡é¢„æœŸ2å€
â€¢ å¤‡ä»½æ–‡ä»¶å‹ç¼©ç‡å¼‚å¸¸
â€¢ æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥

ğŸŸ¢ ä¿¡æ¯é€šçŸ¥ï¼ˆå®šæœŸæ±‡æ€»ï¼‰:
â€¢ æ¯æ—¥å¤‡ä»½æˆåŠŸé€šçŸ¥
â€¢ æ¯å‘¨å¤‡ä»½ç»Ÿè®¡æŠ¥å‘Š
â€¢ æ¯æœˆå­˜å‚¨ç©ºé—´æŠ¥å‘Š
```

### 9.5 è„šæœ¬å‚æ•°åŒ–é…ç½®è¯¦è§£


**é…ç½®æ–‡ä»¶åˆ†å±‚è®¾è®¡**:
```bash
# ä¸»é…ç½®æ–‡ä»¶ (backup_config.conf)
source "${SCRIPT_DIR}/config/database.conf"    # æ•°æ®åº“é…ç½®
source "${SCRIPT_DIR}/config/storage.conf"     # å­˜å‚¨é…ç½®  
source "${SCRIPT_DIR}/config/notification.conf" # é€šçŸ¥é…ç½®
source "${SCRIPT_DIR}/config/schedule.conf"    # è°ƒåº¦é…ç½®

# ç¯å¢ƒç‰¹å®šé…ç½®
case "$ENVIRONMENT" in
    "production")
        source "${SCRIPT_DIR}/config/prod.conf"
        ;;
    "staging")
        source "${SCRIPT_DIR}/config/staging.conf"
        ;;
    "development")
        source "${SCRIPT_DIR}/config/dev.conf"
        ;;
esac
```

**åŠ¨æ€é…ç½®æ›´æ–°**:
```bash
# é…ç½®çƒ­é‡è½½å‡½æ•°
reload_config() {
    local config_file="$1"
    local config_backup="/tmp/config_backup_$.conf"
    
    # å¤‡ä»½å½“å‰é…ç½®
    cp "$config_file" "$config_backup"
    
    # éªŒè¯æ–°é…ç½®
    if validate_config_file "$config_file"; then
        source "$config_file"
        log "INFO" "é…ç½®é‡è½½æˆåŠŸ: $config_file"
        rm "$config_backup"
    else
        log "ERROR" "é…ç½®éªŒè¯å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½é…ç½®"
        cp "$config_backup" "$config_file"
        rm "$config_backup"
        return 1
    fi
}

# é…ç½®å˜æ›´æ£€æµ‹
monitor_config_changes() {
    local config_file="$1"
    local last_modified=$(stat -c %Y "$config_file")
    
    while true; do
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        local current_modified=$(stat -c %Y "$config_file")
        
        if [[ $current_modified -gt $last_modified ]]; then
            log "INFO" "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜æ›´ï¼Œé‡æ–°åŠ è½½..."
            reload_config "$config_file"
            last_modified=$current_modified
        fi
    done
}
```

### 9.6 é«˜çº§åŠŸèƒ½å®ç°


**å¹¶å‘å¤‡ä»½å¤„ç†**:
```bash
# å¤šæ•°æ®åº“å¹¶å‘å¤‡ä»½
backup_multiple_databases() {
    local databases=("${@}")
    local max_concurrent=3
    local pids=()
    
    for db in "${databases[@]}"; do
        # æ§åˆ¶å¹¶å‘æ•°é‡
        while [[ ${#pids[@]} -ge $max_concurrent ]]; do
            wait_for_any_job pids
        done
        
        # å¯åŠ¨å¤‡ä»½å­è¿›ç¨‹
        backup_single_database "$db" &
        pids+=($!)
        log "INFO" "å¯åŠ¨æ•°æ®åº“ $db çš„å¤‡ä»½è¿›ç¨‹: $!"
    done
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for pid in "${pids[@]}"; do
        if wait "$pid"; then
            log "INFO" "å¤‡ä»½è¿›ç¨‹ $pid æˆåŠŸå®Œæˆ"
        else
            log "ERROR" "å¤‡ä»½è¿›ç¨‹ $pid æ‰§è¡Œå¤±è´¥"
        fi
    done
}

# ç­‰å¾…ä»»æ„ä½œä¸šå®Œæˆ
wait_for_any_job() {
    local -n pid_array=$1
    local finished_pid
    
    while true; do
        for i in "${!pid_array[@]}"; do
            if ! kill -0 "${pid_array[i]}" 2>/dev/null; then
                finished_pid=${pid_array[i]}
                unset pid_array[i]
                log "DEBUG" "è¿›ç¨‹ $finished_pid å·²å®Œæˆ"
                return 0
            fi
        done
        sleep 1
    done
}
```

**å¤‡ä»½æ•°æ®å®Œæ•´æ€§æ ¡éªŒ**:
```bash
# å¤‡ä»½å®Œæ•´æ€§æ ¡éªŒ
verify_backup_integrity() {
    local backup_file="$1"
    local original_db="$2"
    
    log "INFO" "å¼€å§‹å¤‡ä»½å®Œæ•´æ€§æ ¡éªŒ..."
    
    # åˆ›å»ºä¸´æ—¶æ•°æ®åº“
    local temp_db="temp_verify_$(date +%s)"
    mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "CREATE DATABASE $temp_db;"
    
    # æ¢å¤åˆ°ä¸´æ—¶æ•°æ®åº“
    if restore_backup_to_database "$backup_file" "$temp_db"; then
        log "INFO" "å¤‡ä»½æ–‡ä»¶æ¢å¤æˆåŠŸï¼Œå¼€å§‹æ•°æ®å¯¹æ¯”..."
        
        # å¯¹æ¯”è¡¨ç»“æ„
        local structure_diff=$(compare_database_structure "$original_db" "$temp_db")
        if [[ -n "$structure_diff" ]]; then
            log "WARN" "å‘ç°è¡¨ç»“æ„å·®å¼‚: $structure_diff"
        fi
        
        # å¯¹æ¯”æ•°æ®å®Œæ•´æ€§
        local data_diff=$(compare_database_data "$original_db" "$temp_db")
        if [[ -n "$data_diff" ]]; then
            log "WARN" "å‘ç°æ•°æ®å·®å¼‚: $data_diff"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ•°æ®åº“
        mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "DROP DATABASE $temp_db;"
        
        log "INFO" "å¤‡ä»½å®Œæ•´æ€§æ ¡éªŒå®Œæˆ"
        return 0
    else
        log "ERROR" "å¤‡ä»½å®Œæ•´æ€§æ ¡éªŒå¤±è´¥"
        mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASSWORD" -e "DROP DATABASE $temp_db;"
        return 1
    fi
}
```

### 9.7 å®é™…åº”ç”¨åœºæ™¯ä¸æ¡ˆä¾‹


**ç”µå•†ç½‘ç«™å¤‡ä»½æ–¹æ¡ˆ**:
```
ä¸šåŠ¡ç‰¹ç‚¹ï¼š
â€¢ é«˜å¹¶å‘è¯»å†™ï¼Œ24å°æ—¶ä¸é—´æ–­æœåŠ¡
â€¢ æ•°æ®é‡è¦æ€§æé«˜ï¼Œä¸å…è®¸ä¸¢å¤±
â€¢ è®¢å•ã€ç”¨æˆ·ã€å•†å“ç­‰æ ¸å¿ƒè¡¨

å¤‡ä»½ç­–ç•¥ï¼š
â€¢ 00:30 - æ¯æ—¥å…¨é‡å¤‡ä»½ï¼ˆä¸šåŠ¡ä½å³°æœŸï¼‰
â€¢ 06:00,12:00,18:00 - å¢é‡å¤‡ä»½
â€¢ å®æ—¶binlogå¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨
â€¢ æ¯å‘¨è·¨åœ°åŸŸå¤‡ä»½åˆ°å¼‚åœ°æœºæˆ¿

è„šæœ¬é…ç½®è¦ç‚¹ï¼š
â€¢ --single-transaction ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§
â€¢ --master-data=2 è®°å½•binlogä½ç½®
â€¢ å‹ç¼©æ¯”ä¾‹è®¾ç½®ä¸ºgzipçº§åˆ«6
â€¢ å¤‡ä»½å®Œæˆåç«‹å³ä¼ è¾“åˆ°è¿œç¨‹å­˜å‚¨
```

**å¼€å‘æµ‹è¯•ç¯å¢ƒå¤‡ä»½**:
```
ä¸šåŠ¡ç‰¹ç‚¹ï¼š
â€¢ æ•°æ®å¯ä»¥å®¹å¿ä¸€å®šç¨‹åº¦ä¸¢å¤±
â€¢ éœ€è¦å¿«é€Ÿæ¢å¤å’Œé‡å»ºç¯å¢ƒ
â€¢ ç»å¸¸éœ€è¦æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹

å¤‡ä»½ç­–ç•¥ï¼š
â€¢ æ¯æ—¥ä¸€æ¬¡å…¨é‡å¤‡ä»½
â€¢ ä¿ç•™æœ€è¿‘7å¤©å¤‡ä»½
â€¢ æä¾›ä¸€é”®æ¢å¤è„šæœ¬
â€¢ æ”¯æŒæŒ‰è¡¨æ¢å¤åŠŸèƒ½

è„šæœ¬ç‰¹è‰²åŠŸèƒ½ï¼š
â€¢ æ•°æ®è„±æ•å¤„ç†
â€¢ å¿«é€Ÿç¯å¢ƒå…‹éš†
â€¢ è‡ªåŠ¨æµ‹è¯•æ•°æ®ç”Ÿæˆ
```

### 9.8 æ•…éšœå¤„ç†ä¸åº”æ€¥é¢„æ¡ˆ


**å¸¸è§æ•…éšœåŠè§£å†³æ–¹æ¡ˆ**:
```
ğŸ”§ æ•…éšœç±»å‹1ï¼šç£ç›˜ç©ºé—´ä¸è¶³
åŸå› åˆ†æï¼šå¤‡ä»½æ–‡ä»¶è¿‡å¤šï¼Œæ¸…ç†ç­–ç•¥å¤±æ•ˆ
è§£å†³æ–¹æ¡ˆï¼š
â€¢ ç«‹å³æ¸…ç†è¿‡æœŸå¤‡ä»½æ–‡ä»¶
â€¢ è°ƒæ•´å¤‡ä»½ä¿ç•™ç­–ç•¥
â€¢ å¢åŠ ç£ç›˜ç©ºé—´æˆ–è¿ç§»åˆ°æ›´å¤§å­˜å‚¨

å¤„ç†è„šæœ¬ï¼š
emergency_cleanup() {
    log "WARN" "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
    find "$BACKUP_DIR" -name "*.sql*" -mtime +3 -delete
    find "$BACKUP_DIR" -type d -empty -delete
}

ğŸ”§ æ•…éšœç±»å‹2ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶
åŸå› åˆ†æï¼šç½‘ç»œé—®é¢˜æˆ–æ•°æ®åº“è´Ÿè½½è¿‡é«˜
è§£å†³æ–¹æ¡ˆï¼š
â€¢ å¢åŠ è¿æ¥è¶…æ—¶æ—¶é—´
â€¢ å®ç°æ–­çº¿é‡è¿æœºåˆ¶
â€¢ é”™å³°æ‰§è¡Œå¤‡ä»½ä»»åŠ¡

å¤„ç†è„šæœ¬ï¼š
robust_mysql_connect() {
    local retries=5
    local delay=30
    
    for ((i=1; i<=retries; i++)); do
        if mysql_connect_test; then
            return 0
        else
            log "WARN" "è¿æ¥å¤±è´¥ï¼Œ${delay}ç§’åé‡è¯• ($i/$retries)"
            sleep $delay
            delay=$((delay * 2))  # æŒ‡æ•°é€€é¿
        fi
    done
    return 1
}
```

**åº”æ€¥æ¢å¤æµç¨‹**:
```
ğŸ“‹ æ•°æ®ä¸¢å¤±åº”æ€¥æ¢å¤ï¼š

1. ç«‹å³åœæ­¢å†™æ“ä½œ
   â€¢ ä¿®æ”¹åº”ç”¨é…ç½®ä¸ºåªè¯»æ¨¡å¼
   â€¢ æˆ–ç›´æ¥åœæ­¢åº”ç”¨æœåŠ¡

2. è¯„ä¼°æ•°æ®ä¸¢å¤±èŒƒå›´
   â€¢ ç¡®å®šæœ€åä¸€æ¬¡æˆåŠŸå¤‡ä»½æ—¶é—´
   â€¢ æ£€æŸ¥binlogå®Œæ•´æ€§
   â€¢ ä¼°ç®—éœ€è¦æ¢å¤çš„æ•°æ®é‡

3. é€‰æ‹©æ¢å¤ç­–ç•¥
   â€¢ å®Œå…¨æ¢å¤ï¼šæ¢å¤åˆ°æœ€æ–°å¤‡ä»½ç‚¹
   â€¢ æ—¶é—´ç‚¹æ¢å¤ï¼šæ¢å¤åˆ°æŒ‡å®šæ—¶é—´
   â€¢ éƒ¨åˆ†æ¢å¤ï¼šåªæ¢å¤ç‰¹å®šè¡¨æˆ–æ•°æ®

4. æ‰§è¡Œæ¢å¤æ“ä½œ
   â€¢ åˆ›å»ºæ–°æ•°æ®åº“å®ä¾‹
   â€¢ æ¢å¤å…¨é‡å¤‡ä»½
   â€¢ åº”ç”¨å¢é‡å¤‡ä»½æˆ–binlog
   â€¢ éªŒè¯æ•°æ®å®Œæ•´æ€§

5. ä¸šåŠ¡åˆ‡æ¢
   â€¢ æ›´æ–°åº”ç”¨é…ç½®
   â€¢ é‡å¯åº”ç”¨æœåŠ¡
   â€¢ ç›‘æ§ä¸šåŠ¡æ¢å¤æƒ…å†µ
```

### 9.9 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**å¤‡ä»½æ€§èƒ½ä¼˜åŒ–**:
```
ğŸš€ æ•°æ®åº“å±‚é¢ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨--single-transactionå‡å°‘é”å®š
â€¢ å¯ç”¨--quické€‰é¡¹é¿å…å†…å­˜é—®é¢˜
â€¢ è®¾ç½®--lock-tables=falseå‡å°‘é”ç­‰å¾…
â€¢ è°ƒæ•´innodb_buffer_pool_size

ğŸš€ ç³»ç»Ÿå±‚é¢ä¼˜åŒ–ï¼š
â€¢ å¤‡ä»½æœŸé—´è°ƒæ•´I/Oè°ƒåº¦ç­–ç•¥
â€¢ ä½¿ç”¨SSDå­˜å‚¨å¤‡ä»½æ–‡ä»¶
â€¢ é…ç½®ä¸“ç”¨å¤‡ä»½ç½‘ç»œ
â€¢ ä¼˜åŒ–æ–‡ä»¶ç³»ç»Ÿå‚æ•°

ğŸš€ ç½‘ç»œå±‚é¢ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨å‹ç¼©ä¼ è¾“
â€¢ å¯ç”¨TCPçª—å£ç¼©æ”¾
â€¢ è°ƒæ•´ç½‘ç»œç¼“å†²åŒºå¤§å°
â€¢ è€ƒè™‘ä¸“çº¿ç½‘ç»œ
```

**è„šæœ¬æ‰§è¡Œä¼˜åŒ–**:
```bash
# å¹¶è¡Œå‹ç¼©ä¼˜åŒ–
compress_backup_parallel() {
    local backup_file="$1"
    local cpu_cores=$(nproc)
    
    case "$COMPRESSION" in
        "gzip")
            pigz -p "$cpu_cores" "$backup_file"
            ;;
        "bzip2")
            pbzip2 -p"$cpu_cores" "$backup_file"
            ;;
        "xz")
            xz -T "$cpu_cores" "$backup_file"
            ;;
    esac
}

# å†…å­˜ä½¿ç”¨ä¼˜åŒ–
optimize_memory_usage() {
    # è®¾ç½®mysqldumpå†…å­˜é™åˆ¶
    export MYSQL_DUMP_MAX_MEMORY="256M"
    
    # ä½¿ç”¨æµå¼å¤„ç†é¿å…å¤§æ–‡ä»¶è½½å…¥å†…å­˜
    mysqldump ... | gzip > backup.sql.gz
    
    # æ¸…ç†ç³»ç»Ÿç¼“å­˜ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
    sync && echo 3 > /proc/sys/vm/drop_caches
}
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è‡ªåŠ¨åŒ–è„šæœ¬æ˜¯æ•°æ®åº“å®‰å…¨çš„é‡è¦ä¿éšœ
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç›‘æ§æœºåˆ¶æ˜¯è„šæœ¬å¯é æ€§çš„å…³é”®
- å®šæ—¶ä»»åŠ¡é…ç½®è¦è€ƒè™‘ä¸šåŠ¡ç‰¹ç‚¹å’Œç³»ç»Ÿè´Ÿè½½
- æµ‹è¯•éªŒè¯æ˜¯ç¡®ä¿è„šæœ¬æ­£ç¡®æ€§çš„å¿…è¦æ­¥éª¤
- çµæ´»çš„é…ç½®ç®¡ç†è®©è„šæœ¬é€‚åº”ä¸åŒç¯å¢ƒéœ€æ±‚