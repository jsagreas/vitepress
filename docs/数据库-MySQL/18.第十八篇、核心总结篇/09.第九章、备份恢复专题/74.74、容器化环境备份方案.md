---
title: 74ã€å®¹å™¨åŒ–ç¯å¢ƒå¤‡ä»½æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•


1. [å®¹å™¨åŒ–å¤‡ä»½æ¦‚è¿°](#1-å®¹å™¨åŒ–å¤‡ä»½æ¦‚è¿°)
2. [Dockerç¯å¢ƒMySQLå¤‡ä»½](#2-Dockerç¯å¢ƒMySQLå¤‡ä»½)
3. [æ•°æ®å·å¤‡ä»½ç­–ç•¥](#3-æ•°æ®å·å¤‡ä»½ç­–ç•¥)
4. [KubernetesæŒä¹…åŒ–å¤‡ä»½](#4-KubernetesæŒä¹…åŒ–å¤‡ä»½)
5. [å®¹å™¨å¤‡ä»½è‡ªåŠ¨åŒ–](#5-å®¹å™¨å¤‡ä»½è‡ªåŠ¨åŒ–)
6. [å¾®æœåŠ¡å¤‡ä»½ç­–ç•¥](#6-å¾®æœåŠ¡å¤‡ä»½ç­–ç•¥)
7. [å®¹å™¨é•œåƒä¸é…ç½®å¤‡ä»½](#7-å®¹å™¨é•œåƒä¸é…ç½®å¤‡ä»½)
8. [å®¹å™¨é—´æ•°æ®è¿ç§»](#8-å®¹å™¨é—´æ•°æ®è¿ç§»)
9. [å¤‡ä»½ç¼–æ’ç®¡ç†](#9-å¤‡ä»½ç¼–æ’ç®¡ç†)
10. [å®¹å™¨æ¢å¤æµç¨‹](#10-å®¹å™¨æ¢å¤æµç¨‹)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ å®¹å™¨åŒ–å¤‡ä»½æ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨åŒ–å¤‡ä»½



**ç®€å•ç†è§£**ï¼šå®¹å™¨åŒ–å¤‡ä»½å°±æ˜¯ç»™è¿è¡Œåœ¨å®¹å™¨é‡Œçš„MySQLæ•°æ®åº“åšå¤‡ä»½

```
ä¼ ç»Ÿå¤‡ä»½ vs å®¹å™¨åŒ–å¤‡ä»½ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼š
MySQLç›´æ¥å®‰è£…åœ¨æœåŠ¡å™¨ä¸Š â†’ ç›´æ¥å¤‡ä»½æ•°æ®åº“æ–‡ä»¶

å®¹å™¨åŒ–æ–¹å¼ï¼š
MySQLè¿è¡Œåœ¨å®¹å™¨å†… â†’ éœ€è¦è€ƒè™‘å®¹å™¨ã€æ•°æ®å·ã€é…ç½®ç­‰å¤šä¸ªå±‚é¢
```

### 1.2 å®¹å™¨åŒ–ç¯å¢ƒçš„ç‰¹æ®Šæ€§



**ğŸ”¸ å®¹å™¨çš„ç‰¹ç‚¹å½±å“å¤‡ä»½**
```
å®¹å™¨ç‰¹æ€§ï¼š
- ä¸´æ—¶æ€§ï¼šå®¹å™¨å¯ä»¥éšæ—¶åˆ›å»ºå’Œé”€æ¯
- éš”ç¦»æ€§ï¼šå®¹å™¨å†…éƒ¨ä¸å¤–éƒ¨ç¯å¢ƒéš”ç¦»
- è½»é‡çº§ï¼šå®¹å™¨åªåŒ…å«å¿…è¦çš„è¿è¡Œç¯å¢ƒ

å¯¹å¤‡ä»½çš„å½±å“ï¼š
âœ… å¥½å¤„ï¼šç¯å¢ƒä¸€è‡´æ€§ï¼Œä¾¿äºè¿ç§»
âŒ æŒ‘æˆ˜ï¼šæ•°æ®æŒä¹…åŒ–ï¼ŒçŠ¶æ€ç®¡ç†
```

### 1.3 éœ€è¦å¤‡ä»½çš„å†…å®¹



**ğŸ“‹ å¤‡ä»½å¯¹è±¡æ¸…å•**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ—„ï¸  MySQLæ•°æ®æ–‡ä»¶                  â”‚
â”‚ ğŸ“  æ•°æ®å·(Volume)                  â”‚
â”‚ âš™ï¸  é…ç½®æ–‡ä»¶                        â”‚
â”‚ ğŸ³  å®¹å™¨é•œåƒ                        â”‚
â”‚ ğŸ“œ  ç¼–æ’æ–‡ä»¶(docker-compose.yml)    â”‚
â”‚ ğŸ”§  ç¯å¢ƒå˜é‡å’Œå‚æ•°                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ³ Dockerç¯å¢ƒMySQLå¤‡ä»½



### 2.1 Docker MySQLå®¹å™¨åŸºç¡€å¤‡ä»½



**ğŸ”¸ æœ€ç®€å•çš„å¤‡ä»½æ–¹å¼**

> ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼šé€šè¿‡`docker exec`å‘½ä»¤åœ¨å®¹å™¨å†…æ‰§è¡Œmysqldump

```bash
# åŸºç¡€å¤‡ä»½å‘½ä»¤

docker exec mysqlå®¹å™¨å mysqldump -uç”¨æˆ·å -på¯†ç  æ•°æ®åº“å > backup.sql

# å®é™…ç¤ºä¾‹

docker exec my-mysql mysqldump -uroot -p123456 mydb > /backup/mydb_$(date +%Y%m%d).sql
```

**æ­¥éª¤æ‹†è§£**ï¼š
```
æ­¥éª¤1ï¸âƒ£ï¼šdocker exec    â†’ åœ¨è¿è¡Œä¸­çš„å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤
æ­¥éª¤2ï¸âƒ£ï¼šmysqldump      â†’ MySQLè‡ªå¸¦çš„å¤‡ä»½å·¥å…·
æ­¥éª¤3ï¸âƒ£ï¼šé‡å®šå‘ >       â†’ å°†å¤‡ä»½å†…å®¹ä¿å­˜åˆ°æ–‡ä»¶
```

### 2.2 Dockerå®¹å™¨å®Œæ•´å¤‡ä»½



**ğŸ”¸ å¤‡ä»½æ‰€æœ‰æ•°æ®åº“**
```bash
# å¤‡ä»½æ‰€æœ‰æ•°æ®åº“

docker exec my-mysql mysqldump -uroot -p123456 --all-databases > all_databases.sql

# å¤‡ä»½æŒ‡å®šæ•°æ®åº“çš„ç»“æ„å’Œæ•°æ®

docker exec my-mysql mysqldump -uroot -p123456 --databases db1 db2 db3 > multiple_dbs.sql
```

**ğŸ”¸ åªå¤‡ä»½æ•°æ®åº“ç»“æ„**
```bash
# åªå¤‡ä»½è¡¨ç»“æ„ï¼Œä¸è¦æ•°æ®

docker exec my-mysql mysqldump -uroot -p123456 --no-data mydb > structure_only.sql

# åªå¤‡ä»½æ•°æ®ï¼Œä¸è¦è¡¨ç»“æ„

docker exec my-mysql mysqldump -uroot -p123456 --no-create-info mydb > data_only.sql
```

### 2.3 è§£å†³å¯†ç å®‰å…¨é—®é¢˜



**âŒ ä¸å®‰å…¨çš„æ–¹å¼**
```bash
# å¯†ç ç›´æ¥å†™åœ¨å‘½ä»¤é‡Œï¼Œå®¹æ˜“æ³„éœ²

docker exec my-mysql mysqldump -uroot -p123456 mydb > backup.sql
```

**âœ… å®‰å…¨çš„æ–¹å¼**
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡

export MYSQL_PWD=123456
docker exec my-mysql mysqldump -uroot mydb > backup.sql

# æ–¹æ³•2ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶

docker exec my-mysql mysqldump --defaults-extra-file=/etc/mysql/backup.cnf mydb > backup.sql

# æ–¹æ³•3ï¼šäº¤äº’å¼è¾“å…¥å¯†ç 

docker exec -it my-mysql mysqldump -uroot -p mydb > backup.sql
```

---

## 3. ğŸ’¾ æ•°æ®å·å¤‡ä»½ç­–ç•¥



### 3.1 ä»€ä¹ˆæ˜¯æ•°æ®å·



**ç®€å•ç†è§£**ï¼šæ•°æ®å·å°±æ˜¯å®¹å™¨å¤–éƒ¨çš„å­˜å‚¨ç©ºé—´ï¼Œç”¨æ¥ä¿å­˜MySQLçš„æ•°æ®æ–‡ä»¶

```
æ²¡æœ‰æ•°æ®å·çš„é—®é¢˜ï¼š
å®¹å™¨ â†’ MySQLæ•°æ® â†’ å®¹å™¨åˆ é™¤ â†’ æ•°æ®ä¸¢å¤± âŒ

ä½¿ç”¨æ•°æ®å·çš„å¥½å¤„ï¼š
å®¹å™¨ â†’ æ•°æ®å· â†’ MySQLæ•°æ® â†’ å®¹å™¨åˆ é™¤ â†’ æ•°æ®è¿˜åœ¨ âœ…
```

### 3.2 æ•°æ®å·çš„ç±»å‹å’Œå¤‡ä»½



**ğŸ”¸ å‘½åæ•°æ®å·å¤‡ä»½**
```bash
# æŸ¥çœ‹æ•°æ®å·

docker volume ls

# æŸ¥çœ‹æ•°æ®å·è¯¦æƒ…

docker volume inspect mysql-data

# å¤‡ä»½å‘½åæ•°æ®å·

docker run --rm \
  -v mysql-data:/data \
  -v /backup:/backup \
  alpine tar czf /backup/mysql-data-backup.tar.gz /data
```

**ç†è§£è¿™ä¸ªå‘½ä»¤**ï¼š
```
--rm              â†’ è¿è¡Œå®Œå°±åˆ é™¤è¿™ä¸ªä¸´æ—¶å®¹å™¨
-v mysql-data:/data â†’ æŠŠè¦å¤‡ä»½çš„æ•°æ®å·æŒ‚è½½åˆ°ä¸´æ—¶å®¹å™¨çš„/dataç›®å½•
-v /backup:/backup  â†’ æŠŠå®¿ä¸»æœºçš„å¤‡ä»½ç›®å½•æŒ‚è½½åˆ°å®¹å™¨
alpine            â†’ ä½¿ç”¨è½»é‡çº§çš„alpineé•œåƒ
tar czf           â†’ æ‰“åŒ…å‹ç¼©æ•°æ®
```

**ğŸ”¸ ç»‘å®šæŒ‚è½½å¤‡ä»½**
```bash
# å¦‚æœMySQLä½¿ç”¨ç»‘å®šæŒ‚è½½

docker run -v /host/mysql-data:/var/lib/mysql mysql

# ç›´æ¥å¤‡ä»½å®¿ä¸»æœºç›®å½•

tar czf mysql-backup-$(date +%Y%m%d).tar.gz /host/mysql-data/
```

### 3.3 æ•°æ®å·å¤‡ä»½æœ€ä½³å®è·µ



**ğŸ”¸ åœæ­¢å®¹å™¨å¤‡ä»½ï¼ˆæœ€å®‰å…¨ï¼‰**
```bash
# 1. åœæ­¢MySQLå®¹å™¨

docker stop my-mysql

# 2. å¤‡ä»½æ•°æ®å·

docker run --rm \
  -v mysql-data:/data \
  -v /backup:/backup \
  alpine tar czf /backup/mysql-$(date +%Y%m%d).tar.gz /data

# 3. é‡å¯MySQLå®¹å™¨

docker start my-mysql
```

**ğŸ”¸ åœ¨çº¿å¤‡ä»½ï¼ˆä¸åœæœºï¼‰**
```bash
# å…ˆåœ¨å®¹å™¨å†…é”è¡¨

docker exec my-mysql mysql -uroot -p123456 -e "FLUSH TABLES WITH READ LOCK;"

# å¿«é€Ÿå¤‡ä»½æ•°æ®å·

docker run --rm \
  -v mysql-data:/data \
  -v /backup:/backup \
  alpine tar czf /backup/mysql-$(date +%Y%m%d).tar.gz /data

# è§£é”è¡¨

docker exec my-mysql mysql -uroot -p123456 -e "UNLOCK TABLES;"
```

---

## 4. â˜¸ï¸ KubernetesæŒä¹…åŒ–å¤‡ä»½



### 4.1 Kubernetesä¸­çš„MySQLéƒ¨ç½²



**ğŸ”¸ å…¸å‹çš„K8s MySQLéƒ¨ç½²ç»“æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL Pod     â”‚
â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ MySQLå®¹å™¨   â”‚ â”‚â—„â”€â”€â–ºâ”‚ PersistentVolume â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚     (PV)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PersistentVolumeClaimâ”‚
â”‚      (PVC)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¦‚å¿µè§£é‡Š**ï¼š
- **Pod**ï¼šè¿è¡ŒMySQLå®¹å™¨çš„æœ€å°å•ä½
- **PVC**ï¼šPodç”³è¯·å­˜å‚¨ç©ºé—´çš„è¯·æ±‚å•
- **PV**ï¼šå®é™…çš„å­˜å‚¨èµ„æº

### 4.2 K8sç¯å¢ƒå¤‡ä»½æ–¹æ³•



**ğŸ”¸ æ–¹æ³•1ï¼šé€šè¿‡kubectlæ‰§è¡Œå¤‡ä»½**
```bash
# è·å–MySQL Podåç§°

kubectl get pods -l app=mysql

# åœ¨Podå†…æ‰§è¡Œå¤‡ä»½

kubectl exec mysql-pod-name -- mysqldump -uroot -p123456 mydb > backup.sql

# æ›´å®‰å…¨çš„æ–¹å¼ï¼šå°†å¤‡ä»½æ–‡ä»¶ä¿å­˜åˆ°Podå†…ï¼Œå†å¤åˆ¶å‡ºæ¥

kubectl exec mysql-pod-name -- mysqldump -uroot -p123456 mydb > /tmp/backup.sql
kubectl cp mysql-pod-name:/tmp/backup.sql ./backup.sql
```

**ğŸ”¸ æ–¹æ³•2ï¼šä½¿ç”¨Jobè¿›è¡Œå¤‡ä»½**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: mysql-backup-job
spec:
  template:
    spec:
      containers:
      - name: mysql-backup
        image: mysql:8.0
        command:
        - mysqldump
        - -h mysql-service
        - -uroot
        - -p123456
        - mydb
        env:
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        volumeMounts:
        - name: backup-storage
          mountPath: /backup
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: backup-pvc
      restartPolicy: OnFailure
```

### 4.3 PVæ•°æ®å¤‡ä»½ç­–ç•¥



**ğŸ”¸ åŸºäºå­˜å‚¨å¿«ç…§çš„å¤‡ä»½**
```yaml
# ä½¿ç”¨StorageClassæ”¯æŒå¿«ç…§

apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: mysql-snapshot
spec:
  volumeSnapshotClassName: csi-snapclass
  source:
    persistentVolumeClaimName: mysql-pvc
```

**ğŸ”¸ ä½¿ç”¨ä¸“ç”¨å¤‡ä»½å®¹å™¨**
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-backup-pod
spec:
  containers:
  - name: backup-container
    image: alpine
    command: ["/bin/sh"]
    args: ["-c", "tar czf /backup/mysql-$(date +%Y%m%d).tar.gz /data && sleep 3600"]
    volumeMounts:
    - name: mysql-data
      mountPath: /data
    - name: backup-storage
      mountPath: /backup
  volumes:
  - name: mysql-data
    persistentVolumeClaim:
      claimName: mysql-pvc
  - name: backup-storage
    persistentVolumeClaim:
      claimName: backup-pvc
```

---

## 5. ğŸ¤– å®¹å™¨å¤‡ä»½è‡ªåŠ¨åŒ–



### 5.1 Docker Composeè‡ªåŠ¨åŒ–å¤‡ä»½



**ğŸ”¸ åŸºæœ¬çš„è‡ªåŠ¨åŒ–è„šæœ¬**
```bash
#!/bin/bash

# mysql-backup.sh


# é…ç½®å‚æ•°

CONTAINER_NAME="my-mysql"
BACKUP_DIR="/backup/mysql"
DB_USER="root"
DB_PASS="123456"
RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•

mkdir -p $BACKUP_DIR

# ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å

BACKUP_FILE="mysql_backup_$(date +%Y%m%d_%H%M%S).sql"

# æ‰§è¡Œå¤‡ä»½

echo "å¼€å§‹å¤‡ä»½MySQLæ•°æ®åº“..."
docker exec $CONTAINER_NAME mysqldump -u$DB_USER -p$DB_PASS --all-databases > $BACKUP_DIR/$BACKUP_FILE

# æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ

if [ $? -eq 0 ]; then
    echo "å¤‡ä»½æˆåŠŸ: $BACKUP_FILE"
#    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip $BACKUP_DIR/$BACKUP_FILE
    echo "å¤‡ä»½å·²å‹ç¼©"
else
    echo "å¤‡ä»½å¤±è´¥!"
    exit 1
fi

# æ¸…ç†æ—§å¤‡ä»½

find $BACKUP_DIR -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete
echo "å·²æ¸…ç† $RETENTION_DAYS å¤©å‰çš„å¤‡ä»½æ–‡ä»¶"
```

**ğŸ”¸ ä½¿ç”¨crontabå®šæ—¶æ‰§è¡Œ**
```bash
# ç¼–è¾‘crontab

crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½

0 2 * * * /path/to/mysql-backup.sh >> /var/log/mysql-backup.log 2>&1

# æ¯6å°æ—¶æ‰§è¡Œä¸€æ¬¡å¤‡ä»½

0 */6 * * * /path/to/mysql-backup.sh >> /var/log/mysql-backup.log 2>&1
```

### 5.2 Docker Composeé›†æˆå¤‡ä»½æœåŠ¡



**ğŸ”¸ åœ¨docker-composeä¸­æ·»åŠ å¤‡ä»½æœåŠ¡**
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: mydb
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  mysql-backup:
    image: alpine
    depends_on:
      - mysql
    volumes:
      - mysql-data:/data:ro  # åªè¯»æŒ‚è½½
      - ./backup:/backup
    command: |
      sh -c "
        while true; do
          tar czf /backup/mysql-$$(date +%Y%m%d_%H%M%S).tar.gz /data
          echo 'å¤‡ä»½å®Œæˆ: mysql-$$(date +%Y%m%d_%H%M%S).tar.gz'
#          # æ¯6å°æ—¶å¤‡ä»½ä¸€æ¬¡
          sleep 21600
        done
      "

volumes:
  mysql-data:
```

### 5.3 é«˜çº§è‡ªåŠ¨åŒ–å¤‡ä»½æ–¹æ¡ˆ



**ğŸ”¸ å¸¦å¥åº·æ£€æŸ¥çš„å¤‡ä»½è„šæœ¬**
```bash
#!/bin/bash

# advanced-backup.sh


# å¥åº·æ£€æŸ¥å‡½æ•°

check_mysql_health() {
    docker exec $CONTAINER_NAME mysqladmin -u$DB_USER -p$DB_PASS ping >/dev/null 2>&1
    return $?
}

# å¤‡ä»½å‡½æ•°

perform_backup() {
    local backup_type=$1
    local backup_file="mysql_${backup_type}_$(date +%Y%m%d_%H%M%S).sql"
    
    case $backup_type in
        "full")
            docker exec $CONTAINER_NAME mysqldump -u$DB_USER -p$DB_PASS \
                --single-transaction --routines --triggers --all-databases > $BACKUP_DIR/$backup_file
            ;;
        "incremental")
#            # å¢é‡å¤‡ä»½éœ€è¦å¯ç”¨binlog
            docker exec $CONTAINER_NAME mysqldump -u$DB_USER -p$DB_PASS \
                --single-transaction --flush-logs --master-data=2 \
                --all-databases > $BACKUP_DIR/$backup_file
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        gzip $BACKUP_DIR/$backup_file
        echo "$(date): $backup_type å¤‡ä»½æˆåŠŸ" >> $LOG_FILE
        
#        # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        send_notification "å¤‡ä»½æˆåŠŸ" "$backup_type å¤‡ä»½å·²å®Œæˆ"
    else
        echo "$(date): $backup_type å¤‡ä»½å¤±è´¥" >> $LOG_FILE
        send_notification "å¤‡ä»½å¤±è´¥" "$backup_type å¤‡ä»½å¤±è´¥ï¼Œè¯·æ£€æŸ¥"
        exit 1
    fi
}

# é€šçŸ¥å‡½æ•°ï¼ˆç¤ºä¾‹ï¼šå‘é€é‚®ä»¶æˆ–é’‰é’‰æ¶ˆæ¯ï¼‰

send_notification() {
    local title=$1
    local message=$2
#    # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰é€šçŸ¥
    echo "$title: $message"
}

# ä¸»ç¨‹åº

if check_mysql_health; then
    perform_backup "full"
else
    echo "MySQLå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå–æ¶ˆå¤‡ä»½"
    exit 1
fi
```

---

## 6. ğŸ—ï¸ å¾®æœåŠ¡å¤‡ä»½ç­–ç•¥



### 6.1 å¾®æœåŠ¡æ¶æ„ä¸­çš„å¤‡ä»½æŒ‘æˆ˜



**ğŸ”¸ å¾®æœåŠ¡ç¯å¢ƒçš„å¤æ‚æ€§**
```
å•ä½“åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æœåŠ¡      â”‚
â”‚        â–¼        â”‚
â”‚   MySQLæ•°æ®åº“   â”‚ â†’ ä¸€ä¸ªæ•°æ®åº“ï¼Œç®€å•å¤‡ä»½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æœåŠ¡A    â”‚  â”‚æœåŠ¡B    â”‚  â”‚æœåŠ¡C    â”‚
â”‚   â–¼     â”‚  â”‚   â–¼     â”‚  â”‚   â–¼     â”‚
â”‚MySQL A  â”‚  â”‚MySQL B  â”‚  â”‚MySQL C  â”‚ â†’ å¤šä¸ªæ•°æ®åº“ï¼Œéœ€è¦åè°ƒå¤‡ä»½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éœ€è¦è€ƒè™‘çš„é—®é¢˜**ï¼š
- æ•°æ®ä¸€è‡´æ€§ï¼šå¤šä¸ªæœåŠ¡çš„æ•°æ®è¦ä¿æŒä¸€è‡´çš„æ—¶é—´ç‚¹
- å¤‡ä»½é¡ºåºï¼šæœ‰ä¾èµ–å…³ç³»çš„æœåŠ¡è¦æŒ‰é¡ºåºå¤‡ä»½
- æ¢å¤åè°ƒï¼šæ¢å¤æ—¶è¦ç¡®ä¿æ‰€æœ‰æœåŠ¡æ•°æ®åŒ¹é…

### 6.2 å¾®æœåŠ¡å¤‡ä»½åè°ƒç­–ç•¥



**ğŸ”¸ æ–¹æ¡ˆ1ï¼šå…¨å±€å¤‡ä»½çª—å£**
```bash
#!/bin/bash

# microservices-backup.sh


# æœåŠ¡åˆ—è¡¨

SERVICES=("user-service" "order-service" "payment-service" "inventory-service")

# 1. åœæ­¢æ‰€æœ‰å†™å…¥æ“ä½œ

echo "åœæ­¢æ‰€æœ‰æœåŠ¡çš„å†™å…¥æ“ä½œ..."
for service in "${SERVICES[@]}"; do
#    # é€šè¿‡APIè®¾ç½®æœåŠ¡ä¸ºåªè¯»æ¨¡å¼
    curl -X PUT http://$service:8080/admin/readonly
done

# 2. ç­‰å¾…å½“å‰äº‹åŠ¡å®Œæˆ

sleep 30

# 3. å¼€å§‹å¹¶è¡Œå¤‡ä»½

echo "å¼€å§‹å¤‡ä»½æ‰€æœ‰æœåŠ¡æ•°æ®..."
backup_pids=()

for service in "${SERVICES[@]}"; do
    {
        docker exec mysql-$service mysqldump -uroot -p123456 \
            --single-transaction --routines --triggers \
            ${service}_db > /backup/${service}_$(date +%Y%m%d_%H%M%S).sql
        gzip /backup/${service}_$(date +%Y%m%d_%H%M%S).sql
    } &
    backup_pids+=($!)
done

# 4. ç­‰å¾…æ‰€æœ‰å¤‡ä»½å®Œæˆ

for pid in "${backup_pids[@]}"; do
    wait $pid
    if [ $? -ne 0 ]; then
        echo "å¤‡ä»½å¤±è´¥ï¼ŒPID: $pid"
        exit 1
    fi
done

# 5. æ¢å¤æœåŠ¡å†™å…¥

echo "æ¢å¤æ‰€æœ‰æœåŠ¡çš„å†™å…¥æ“ä½œ..."
for service in "${SERVICES[@]}"; do
    curl -X PUT http://$service:8080/admin/writable
done

echo "å¾®æœåŠ¡å¤‡ä»½å®Œæˆ!"
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šåŸºäºäº‹åŠ¡æ—¥å¿—çš„å¤‡ä»½**
```yaml
# docker-compose.yml for microservices backup

version: '3.8'
services:
  backup-coordinator:
    image: backup-coordinator:latest
    environment:
      - SERVICES=user-service,order-service,payment-service
      - BACKUP_STRATEGY=transaction_log
    volumes:
      - /backup:/backup
      - /var/run/docker.sock:/var/run/docker.sock
    command: |
      sh -c "
#        # è·å–å…¨å±€äº‹åŠ¡æ—¶é—´ç‚¹
        TIMESTAMP=$$(date +%s)
        
#        # è®°å½•æ‰€æœ‰æœåŠ¡çš„binlogä½ç½®
        for service in user-service order-service payment-service; do
          docker exec mysql-$$service mysql -uroot -p123456 -e 'SHOW MASTER STATUS' > /backup/$$service.binlog.$$TIMESTAMP
        done
        
#        # æ‰§è¡Œå¤‡ä»½
        ./backup-all-services.sh $$TIMESTAMP
      "
```

### 6.3 æœåŠ¡é—´æ•°æ®å…³è”å¤‡ä»½



**ğŸ”¸ æœ‰ä¾èµ–å…³ç³»çš„æœåŠ¡å¤‡ä»½**
```bash
#!/bin/bash

# dependency-aware-backup.sh


# å®šä¹‰æœåŠ¡ä¾èµ–å…³ç³»

declare -A service_deps
service_deps["user-service"]=""                    # åŸºç¡€æœåŠ¡ï¼Œæ— ä¾èµ–
service_deps["order-service"]="user-service"       # è®¢å•ä¾èµ–ç”¨æˆ·
service_deps["payment-service"]="order-service"    # æ”¯ä»˜ä¾èµ–è®¢å•
service_deps["inventory-service"]="order-service"  # åº“å­˜ä¾èµ–è®¢å•

# æŒ‰ä¾èµ–é¡ºåºå¤‡ä»½

backup_with_dependencies() {
    local service=$1
    local backup_id=$(date +%Y%m%d_%H%M%S)
    
#    # å…ˆå¤‡ä»½ä¾èµ–çš„æœåŠ¡
    if [ -n "${service_deps[$service]}" ]; then
        echo "å¤‡ä»½ $service çš„ä¾èµ–æœåŠ¡: ${service_deps[$service]}"
        backup_with_dependencies "${service_deps[$service]}"
    fi
    
#    # å¤‡ä»½å½“å‰æœåŠ¡
    echo "å¤‡ä»½æœåŠ¡: $service"
    docker exec mysql-$service mysqldump -uroot -p123456 \
        --single-transaction \
        --where="created_at <= '$(date -d '@'$BACKUP_TIMESTAMP)'" \
        ${service//-/_}_db > /backup/${service}_${backup_id}.sql
    
#    # è®°å½•å¤‡ä»½å…ƒä¿¡æ¯
    cat > /backup/${service}_${backup_id}.meta <<EOF
{
    "service": "$service",
    "backup_id": "$backup_id",
    "timestamp": "$BACKUP_TIMESTAMP",
    "dependencies": "${service_deps[$service]}",
    "backup_file": "${service}_${backup_id}.sql"
}
EOF
}

# è®¾ç½®å…¨å±€å¤‡ä»½æ—¶é—´æˆ³

BACKUP_TIMESTAMP=$(date +%s)

# å¤‡ä»½æ‰€æœ‰æœåŠ¡

for service in "${!service_deps[@]}"; do
    backup_with_dependencies $service
done
```

---

## 7. ğŸ–¼ï¸ å®¹å™¨é•œåƒä¸é…ç½®å¤‡ä»½



### 7.1 MySQLå®¹å™¨é•œåƒå¤‡ä»½



**ğŸ”¸ ä¸ºä»€ä¹ˆè¦å¤‡ä»½é•œåƒ**
```
åœºæ™¯è¯´æ˜ï¼š
- çº¿ä¸Šè¿è¡Œ mysql:8.0.25
- Docker Hub ä¸Šè¯¥ç‰ˆæœ¬è¢«åˆ é™¤æˆ–æ›´æ–°
- éœ€è¦é‡æ–°éƒ¨ç½²æ—¶æ‰¾ä¸åˆ°åŸç‰ˆæœ¬
- å¯¼è‡´ç¯å¢ƒä¸ä¸€è‡´ï¼Œå¯èƒ½å‡ºç°å…¼å®¹æ€§é—®é¢˜
```

**ğŸ”¸ é•œåƒå¤‡ä»½æ–¹æ³•**
```bash
# 1. å¯¼å‡ºæ­£åœ¨ä½¿ç”¨çš„é•œåƒ

docker save mysql:8.0.25 > mysql_8.0.25.tar

# 2. å‹ç¼©é•œåƒæ–‡ä»¶

gzip mysql_8.0.25.tar

# 3. æ¢å¤é•œåƒï¼ˆåœ¨æ–°ç¯å¢ƒä¸­ï¼‰

docker load < mysql_8.0.25.tar.gz

# 4. æ‰¹é‡å¤‡ä»½æ‰€æœ‰ç›¸å…³é•œåƒ

docker images | grep mysql | awk '{print $1":"$2}' | xargs -I {} docker save {} > {}.tar
```

**ğŸ”¸ è‡ªå®šä¹‰é•œåƒå¤‡ä»½**
```bash
# å¦‚æœä½ æœ‰è‡ªå®šä¹‰çš„MySQLé•œåƒ

docker build -t my-mysql:v1.0 .

# å¤‡ä»½è‡ªå®šä¹‰é•œåƒ

docker save my-mysql:v1.0 > my-mysql-v1.0.tar

# åŒæ—¶å¤‡ä»½Dockerfileå’Œç›¸å…³æ–‡ä»¶

tar czf my-mysql-build-$(date +%Y%m%d).tar.gz Dockerfile configs/ scripts/
```

### 7.2 é…ç½®æ–‡ä»¶å¤‡ä»½



**ğŸ”¸ MySQLé…ç½®æ–‡ä»¶å¤‡ä»½**
```bash
# ä»è¿è¡Œä¸­çš„å®¹å™¨å¤åˆ¶é…ç½®æ–‡ä»¶

docker cp my-mysql:/etc/mysql/my.cnf ./configs/my.cnf
docker cp my-mysql:/etc/mysql/conf.d/ ./configs/conf.d/

# å¤‡ä»½ç¯å¢ƒå˜é‡é…ç½®

docker inspect my-mysql | jq '.[0].Config.Env' > mysql-env.json

# å¤‡ä»½å®¹å™¨å¯åŠ¨å‚æ•°

docker inspect my-mysql | jq '.[0].Args' > mysql-args.json
```

**ğŸ”¸ Docker Composeé…ç½®å¤‡ä»½**
```bash
# å¤‡ä»½docker-composeæ–‡ä»¶åŠç›¸å…³é…ç½®

backup_compose_config() {
    local project_name=$1
    local backup_dir="/backup/compose-configs/$(date +%Y%m%d)"
    
    mkdir -p $backup_dir
    
#    # å¤‡ä»½composeæ–‡ä»¶
    cp docker-compose.yml $backup_dir/
    cp docker-compose.override.yml $backup_dir/ 2>/dev/null || true
    
#    # å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶
    cp .env $backup_dir/ 2>/dev/null || true
    
#    # å¤‡ä»½è‡ªå®šä¹‰é…ç½®ç›®å½•
    if [ -d "./configs" ]; then
        cp -r ./configs $backup_dir/
    fi
    
#    # ç”Ÿæˆæ¢å¤è¯´æ˜
    cat > $backup_dir/README.md <<EOF
# MySQL Docker Compose æ¢å¤è¯´æ˜


# å¤‡ä»½æ—¶é—´


$(date)

# æ¢å¤æ­¥éª¤


1. å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ç›®æ ‡ç¯å¢ƒ
2. æ‰§è¡Œ: docker-compose up -d
3. æ¢å¤æ•°æ®: å‚è€ƒæ•°æ®å¤‡ä»½æ–‡ä»¶

# æ³¨æ„äº‹é¡¹


- æ£€æŸ¥ç«¯å£æ˜¯å¦å†²çª
- ç¡®è®¤æ•°æ®å·è·¯å¾„
- éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
EOF
    
    echo "é…ç½®å¤‡ä»½å®Œæˆ: $backup_dir"
}
```

### 7.3 å®Œæ•´ç¯å¢ƒå¤‡ä»½è„šæœ¬



**ğŸ”¸ ä¸€é”®å¤‡ä»½æ•´ä¸ªMySQLå®¹å™¨ç¯å¢ƒ**
```bash
#!/bin/bash

# complete-mysql-backup.sh


PROJECT_NAME="mysql-project"
BACKUP_ROOT="/backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="$BACKUP_ROOT/$PROJECT_NAME-$DATE"

mkdir -p $BACKUP_DIR

echo "å¼€å§‹å®Œæ•´å¤‡ä»½MySQLå®¹å™¨ç¯å¢ƒ..."

# 1. å¤‡ä»½æ•°æ®

echo "1. å¤‡ä»½MySQLæ•°æ®..."
docker exec my-mysql mysqldump -uroot -p123456 --all-databases > $BACKUP_DIR/mysql-data.sql
gzip $BACKUP_DIR/mysql-data.sql

# 2. å¤‡ä»½æ•°æ®å·

echo "2. å¤‡ä»½æ•°æ®å·..."
docker run --rm \
    -v mysql-data:/data \
    -v $BACKUP_DIR:/backup \
    alpine tar czf /backup/mysql-volume.tar.gz /data

# 3. å¤‡ä»½é•œåƒ

echo "3. å¤‡ä»½å®¹å™¨é•œåƒ..."
docker save mysql:8.0 > $BACKUP_DIR/mysql-image.tar
gzip $BACKUP_DIR/mysql-image.tar

# 4. å¤‡ä»½é…ç½®

echo "4. å¤‡ä»½é…ç½®æ–‡ä»¶..."
docker cp my-mysql:/etc/mysql/my.cnf $BACKUP_DIR/
cp docker-compose.yml $BACKUP_DIR/
cp .env $BACKUP_DIR/ 2>/dev/null || true

# 5. å¤‡ä»½å®¹å™¨ä¿¡æ¯

echo "5. å¤‡ä»½å®¹å™¨å…ƒä¿¡æ¯..."
docker inspect my-mysql > $BACKUP_DIR/container-info.json

# 6. ç”Ÿæˆæ¢å¤è„šæœ¬

cat > $BACKUP_DIR/restore.sh <<EOF
#!/bin/bash

echo "æ¢å¤MySQLå®¹å™¨ç¯å¢ƒ..."

# 1. åŠ è½½é•œåƒ

docker load < mysql-image.tar.gz

# 2. åˆ›å»ºæ•°æ®å·å¹¶æ¢å¤æ•°æ®

docker volume create mysql-data
docker run --rm -v mysql-data:/data -v \$(pwd):/backup alpine tar xzf /backup/mysql-volume.tar.gz -C /

# 3. å¯åŠ¨å®¹å™¨

docker-compose up -d

# 4. ç­‰å¾…MySQLå¯åŠ¨

sleep 30

# 5. æ¢å¤SQLæ•°æ®ï¼ˆå¯é€‰ï¼Œå¦‚æœæ•°æ®å·å¤‡ä»½ä¸å¤Ÿï¼‰

# gunzip mysql-data.sql.gz

# docker exec my-mysql mysql -uroot -p123456 < mysql-data.sql


echo "æ¢å¤å®Œæˆ!"
EOF

chmod +x $BACKUP_DIR/restore.sh

# 7. æ‰“åŒ…æ•´ä¸ªå¤‡ä»½

cd $BACKUP_ROOT
tar czf $PROJECT_NAME-$DATE.tar.gz $PROJECT_NAME-$DATE/

echo "å®Œæ•´å¤‡ä»½å®Œæˆ: $BACKUP_ROOT/$PROJECT_NAME-$DATE.tar.gz"
echo "å¤‡ä»½å¤§å°: $(du -h $PROJECT_NAME-$DATE.tar.gz | cut -f1)"
```

---

## 8. ğŸ”„ å®¹å™¨é—´æ•°æ®è¿ç§»



### 8.1 åŒå®¿ä¸»æœºå®¹å™¨é—´è¿ç§»



**ğŸ”¸ åœºæ™¯ï¼šMySQLç‰ˆæœ¬å‡çº§è¿ç§»**
```
æ—§å®¹å™¨: mysql:5.7  â†’  æ–°å®¹å™¨: mysql:8.0
éœ€è¦ä¿è¯æ•°æ®å®Œæ•´è¿ç§»
```

**ğŸ”¸ è¿ç§»æ­¥éª¤**
```bash
#!/bin/bash

# mysql-container-migration.sh


OLD_CONTAINER="mysql-old"
NEW_CONTAINER="mysql-new"
MIGRATION_DIR="/tmp/mysql-migration"

mkdir -p $MIGRATION_DIR

echo "å¼€å§‹MySQLå®¹å™¨é—´æ•°æ®è¿ç§»..."

# 1. ä»æ—§å®¹å™¨å¯¼å‡ºæ•°æ®

echo "1. ä»æ—§å®¹å™¨å¯¼å‡ºæ•°æ®..."
docker exec $OLD_CONTAINER mysqldump -uroot -p123456 \
    --single-transaction \
    --routines \
    --triggers \
    --all-databases > $MIGRATION_DIR/all_databases.sql

# 2. å¯åŠ¨æ–°å®¹å™¨ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰

echo "2. å¯åŠ¨æ–°å®¹å™¨..."
docker run -d \
    --name $NEW_CONTAINER \
    -e MYSQL_ROOT_PASSWORD=123456 \
    -v mysql-new-data:/var/lib/mysql \
    mysql:8.0

# 3. ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨å®Œæˆ

echo "3. ç­‰å¾…æ–°å®¹å™¨åˆå§‹åŒ–..."
while ! docker exec $NEW_CONTAINER mysqladmin -uroot -p123456 ping >/dev/null 2>&1; do
    echo "ç­‰å¾…MySQLå¯åŠ¨..."
    sleep 5
done

# 4. å¯¼å…¥æ•°æ®åˆ°æ–°å®¹å™¨

echo "4. å¯¼å…¥æ•°æ®åˆ°æ–°å®¹å™¨..."
docker exec -i $NEW_CONTAINER mysql -uroot -p123456 < $MIGRATION_DIR/all_databases.sql

# 5. éªŒè¯æ•°æ®è¿ç§»

echo "5. éªŒè¯æ•°æ®è¿ç§»..."
OLD_DBS=$(docker exec $OLD_CONTAINER mysql -uroot -p123456 -e "SHOW DATABASES;" | grep -v Database | grep -v information_schema | grep -v performance_schema | grep -v mysql | wc -l)
NEW_DBS=$(docker exec $NEW_CONTAINER mysql -uroot -p123456 -e "SHOW DATABASES;" | grep -v Database | grep -v information_schema | grep -v performance_schema | grep -v mysql | wc -l)

if [ $OLD_DBS -eq $NEW_DBS ]; then
    echo "æ•°æ®åº“æ•°é‡éªŒè¯é€šè¿‡: $OLD_DBS = $NEW_DBS"
else
    echo "æ•°æ®åº“æ•°é‡ä¸åŒ¹é…: æ—§å®¹å™¨ $OLD_DBS, æ–°å®¹å™¨ $NEW_DBS"
    exit 1
fi

echo "è¿ç§»å®Œæˆ! è¯·éªŒè¯ä¸šåŠ¡åŠŸèƒ½ååœæ­¢æ—§å®¹å™¨ã€‚"
echo "åœæ­¢æ—§å®¹å™¨å‘½ä»¤: docker stop $OLD_CONTAINER"
echo "åˆ é™¤æ—§å®¹å™¨å‘½ä»¤: docker rm $OLD_CONTAINER"
```

### 8.2 è·¨å®¿ä¸»æœºå®¹å™¨è¿ç§»



**ğŸ”¸ åœºæ™¯ï¼šæœåŠ¡å™¨è¿ç§»æˆ–è´Ÿè½½åˆ†æ‹…**
```
æœåŠ¡å™¨A (192.168.1.10)  â†’  æœåŠ¡å™¨B (192.168.1.20)
éœ€è¦å®Œæ•´è¿ç§»MySQLå®¹å™¨å’Œæ•°æ®
```

**ğŸ”¸ æºæœåŠ¡å™¨æ“ä½œ**
```bash
#!/bin/bash

# source-server-export.sh


CONTAINER_NAME="my-mysql"
EXPORT_DIR="/tmp/mysql-export"
REMOTE_HOST="192.168.1.20"

mkdir -p $EXPORT_DIR

echo "å‡†å¤‡å¯¼å‡ºMySQLå®¹å™¨..."

# 1. å¤‡ä»½æ•°æ®

docker exec $CONTAINER_NAME mysqldump -uroot -p123456 \
    --single-transaction --all-databases > $EXPORT_DIR/mysql-data.sql
gzip $EXPORT_DIR/mysql-data.sql

# 2. å¯¼å‡ºå®¹å™¨é•œåƒ

docker commit $CONTAINER_NAME my-mysql-snapshot
docker save my-mysql-snapshot > $EXPORT_DIR/mysql-image.tar
gzip $EXPORT_DIR/mysql-image.tar

# 3. å¯¼å‡ºæ•°æ®å·

docker run --rm \
    -v mysql-data:/source \
    -v $EXPORT_DIR:/backup \
    alpine tar czf /backup/mysql-volume.tar.gz /source

# 4. å¯¼å‡ºé…ç½®ä¿¡æ¯

docker inspect $CONTAINER_NAME > $EXPORT_DIR/container-config.json

# 5. ä¼ è¾“åˆ°ç›®æ ‡æœåŠ¡å™¨

echo "ä¼ è¾“æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨..."
scp -r $EXPORT_DIR/ root@$REMOTE_HOST:/tmp/

echo "å¯¼å‡ºå®Œæˆï¼è¯·åœ¨ç›®æ ‡æœåŠ¡å™¨æ‰§è¡Œå¯¼å…¥è„šæœ¬ã€‚"
```

**ğŸ”¸ ç›®æ ‡æœåŠ¡å™¨æ“ä½œ**
```bash
#!/bin/bash

# target-server-import.sh


IMPORT_DIR="/tmp/mysql-export"
CONTAINER_NAME="my-mysql"

echo "å¼€å§‹å¯¼å…¥MySQLå®¹å™¨..."

# 1. å¯¼å…¥é•œåƒ

docker load < $IMPORT_DIR/mysql-image.tar.gz

# 2. åˆ›å»ºæ•°æ®å·å¹¶æ¢å¤æ•°æ®

docker volume create mysql-data
docker run --rm \
    -v mysql-data:/target \
    -v $IMPORT_DIR:/backup \
    alpine tar xzf /backup/mysql-volume.tar.gz -C /target --strip-components=1

# 3. ä»é…ç½®æ–‡ä»¶è¯»å–åŸå®¹å™¨å‚æ•°

ORIGINAL_CONFIG=$(cat $IMPORT_DIR/container-config.json)
MYSQL_ROOT_PASSWORD=$(echo $ORIGINAL_CONFIG | jq -r '.[0].Config.Env[]' | grep MYSQL_ROOT_PASSWORD | cut -d'=' -f2)

# 4. å¯åŠ¨æ–°å®¹å™¨

docker run -d \
    --name $CONTAINER_NAME \
    -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
    -v mysql-data:/var/lib/mysql \
    -p 3306:3306 \
    my-mysql-snapshot

# 5. ç­‰å¾…å¯åŠ¨å¹¶éªŒè¯

sleep 30
if docker exec $CONTAINER_NAME mysqladmin -uroot -p$MYSQL_ROOT_PASSWORD ping; then
    echo "MySQLå®¹å™¨è¿ç§»æˆåŠŸï¼"
else
    echo "MySQLå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
    docker logs $CONTAINER_NAME
fi
```

### 8.3 çƒ­è¿ç§»ï¼ˆé›¶åœæœºè¿ç§»ï¼‰



**ğŸ”¸ ä½¿ç”¨ä¸»ä»å¤åˆ¶å®ç°çƒ­è¿ç§»**
```bash
#!/bin/bash

# hot-migration.sh


SOURCE_HOST="192.168.1.10"
TARGET_HOST="192.168.1.20"
MYSQL_USER="root"
MYSQL_PASS="123456"

echo "å¼€å§‹MySQLçƒ­è¿ç§»..."

# 1. åœ¨ç›®æ ‡æœåŠ¡å™¨å¯åŠ¨MySQLä½œä¸ºä»åº“

ssh root@$TARGET_HOST <<EOF
docker run -d \
    --name mysql-slave \
    -e MYSQL_ROOT_PASSWORD=$MYSQL_PASS \
    -e MYSQL_REPLICATION_USER=repl \
    -e MYSQL_REPLICATION_PASSWORD=replpass \
    -v mysql-slave-data:/var/lib/mysql \
    -p 3306:3306 \
    mysql:8.0
EOF

# 2. åœ¨æºæœåŠ¡å™¨é…ç½®ä¸»åº“

docker exec my-mysql mysql -u$MYSQL_USER -p$MYSQL_PASS -e "
CREATE USER 'repl'@'%' IDENTIFIED BY 'replpass';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
"

# 3. è·å–binlogä½ç½®

BINLOG_FILE=$(docker exec my-mysql mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW MASTER STATUS\G" | grep File | awk '{print $2}')
BINLOG_POS=$(docker exec my-mysql mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW MASTER STATUS\G" | grep Position | awk '{print $2}')

# 4. é…ç½®ä»åº“å¤åˆ¶

ssh root@$TARGET_HOST <<EOF
docker exec mysql-slave mysql -u$MYSQL_USER -p$MYSQL_PASS -e "
CHANGE MASTER TO
    MASTER_HOST='$SOURCE_HOST',
    MASTER_USER='repl',
    MASTER_PASSWORD='replpass',
    MASTER_LOG_FILE='$BINLOG_FILE',
    MASTER_LOG_POS=$BINLOG_POS;
START SLAVE;
SHOW SLAVE STATUS\G;
"
EOF

echo "ä¸»ä»å¤åˆ¶å·²å»ºç«‹ï¼Œæ•°æ®æ­£åœ¨åŒæ­¥..."
echo "åŒæ­¥å®Œæˆåï¼Œå¯ä»¥åˆ‡æ¢åº”ç”¨åˆ°æ–°æœåŠ¡å™¨"
```

---

## 9. ğŸµ å¤‡ä»½ç¼–æ’ç®¡ç†



### 9.1 ä½¿ç”¨Docker Composeç¼–æ’å¤‡ä»½



**ğŸ”¸ å®Œæ•´çš„å¤‡ä»½æœåŠ¡ç¼–æ’**
```yaml
# docker-compose.backup.yml

version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: myapp
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-config:/etc/mysql/conf.d
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]
      interval: 30s
      timeout: 10s
      retries: 3

#  # æ•°æ®å¤‡ä»½æœåŠ¡
  mysql-backup:
    image: mysql:8.0
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./backup-scripts:/scripts
      - ./backup-data:/backup
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_USER=root
      - MYSQL_PASSWORD=123456
      - BACKUP_SCHEDULE=0 2 * * *  # æ¯å¤©å‡Œæ™¨2ç‚¹
    command: >
      sh -c "
        echo 'è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡...'
        echo '$${BACKUP_SCHEDULE} /scripts/backup.sh >> /var/log/backup.log 2>&1' | crontab -
        echo 'å¯åŠ¨crondæœåŠ¡...'
        crond -f
      "

#  # å¤‡ä»½ç›‘æ§æœåŠ¡
  backup-monitor:
    image: alpine
    volumes:
      - ./backup-data:/backup:ro
      - ./scripts:/scripts
    environment:
      - NOTIFICATION_URL=https://hooks.dingtalk.com/services/your-webhook
    command: >
      sh -c "
        while true; do
          /scripts/monitor-backup.sh
          sleep 3600  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
        done
      "

#  # å¤‡ä»½æ–‡ä»¶æ¸…ç†æœåŠ¡
  backup-cleaner:
    image: alpine
    volumes:
      - ./backup-data:/backup
    environment:
      - RETENTION_DAYS=30
    command: >
      sh -c "
        while true; do
          find /backup -name '*.sql.gz' -mtime +$${RETENTION_DAYS} -delete
          find /backup -name '*.tar.gz' -mtime +$${RETENTION_DAYS} -delete
          echo 'æ¸…ç†å®Œæˆ: $(date)'
          sleep 86400  # æ¯å¤©æ¸…ç†ä¸€æ¬¡
        done
      "

volumes:
  mysql-data:

networks:
  default:
    name: mysql-backup-network
```

**ğŸ”¸ å¤‡ä»½è„šæœ¬ (backup-scripts/backup.sh)**
```bash
#!/bin/bash

# backup.sh


# é…ç½®å‚æ•°

MYSQL_HOST=${MYSQL_HOST:-localhost}
MYSQL_USER=${MYSQL_USER:-root}
MYSQL_PASSWORD=${MYSQL_PASSWORD:-123456}
BACKUP_DIR=${BACKUP_DIR:-/backup}
DATE=$(date +%Y%m%d_%H%M%S)

# æ—¥å¿—å‡½æ•°

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# å¤‡ä»½å‡½æ•°

backup_mysql() {
    local backup_type=$1
    local backup_file="mysql_${backup_type}_${DATE}.sql"
    
    log "å¼€å§‹ $backup_type å¤‡ä»½..."
    
    case $backup_type in
        "full")
            mysqldump -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWORD \
                --single-transaction \
                --routines \
                --triggers \
                --all-databases > $BACKUP_DIR/$backup_file
            ;;
        "schema")
            mysqldump -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWORD \
                --no-data \
                --routines \
                --triggers \
                --all-databases > $BACKUP_DIR/$backup_file
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        gzip $BACKUP_DIR/$backup_file
        log "$backup_type å¤‡ä»½æˆåŠŸ: ${backup_file}.gz"
        
#        # è®°å½•å¤‡ä»½ä¿¡æ¯
        cat > $BACKUP_DIR/${backup_type}_${DATE}.info <<EOF
{
    "backup_type": "$backup_type",
    "backup_time": "$DATE",
    "backup_file": "${backup_file}.gz",
    "mysql_host": "$MYSQL_HOST",
    "file_size": "$(du -h $BACKUP_DIR/${backup_file}.gz | cut -f1)"
}
EOF
        return 0
    else
        log "$backup_type å¤‡ä»½å¤±è´¥"
        return 1
    fi
}

# ä¸»ç¨‹åº

log "å¤‡ä»½ä»»åŠ¡å¼€å§‹"

# æ£€æŸ¥MySQLè¿æ¥

if ! mysqladmin -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWORD ping >/dev/null 2>&1; then
    log "MySQLè¿æ¥å¤±è´¥ï¼Œé€€å‡ºå¤‡ä»½"
    exit 1
fi

# æ‰§è¡Œå¤‡ä»½

backup_mysql "full"
if [ $? -eq 0 ]; then
    log "å¤‡ä»½ä»»åŠ¡å®Œæˆ"
else
    log "å¤‡ä»½ä»»åŠ¡å¤±è´¥"
    exit 1
fi
```

### 9.2 Kubernetesä¸­çš„å¤‡ä»½ç¼–æ’



**ğŸ”¸ ä½¿ç”¨CronJobå®šæ—¶å¤‡ä»½**
```yaml
# mysql-backup-cronjob.yaml

apiVersion: batch/v1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: database
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mysql-backup
            image: mysql:8.0
            command:
            - /bin/bash
            - -c
            - |
#              # ç­‰å¾…MySQLå‡†å¤‡å°±ç»ª
              until mysqladmin -h mysql-service -uroot -p$MYSQL_ROOT_PASSWORD ping; do
                echo "ç­‰å¾…MySQLå¯åŠ¨..."
                sleep 10
              done
              
#              # æ‰§è¡Œå¤‡ä»½
              DATE=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="mysql_backup_$DATE.sql"
              
              mysqldump -h mysql-service -uroot -p$MYSQL_ROOT_PASSWORD \
                --single-transaction --all-databases > /backup/$BACKUP_FILE
              
              if [ $? -eq 0 ]; then
                gzip /backup/$BACKUP_FILE
                echo "å¤‡ä»½æˆåŠŸ: $BACKUP_FILE.gz"
              else
                echo "å¤‡ä»½å¤±è´¥"
                exit 1
              fi
            env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
```

**ğŸ”¸ å¤‡ä»½çŠ¶æ€ç›‘æ§**
```yaml
# backup-monitor-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backup-monitor
  namespace: database
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backup-monitor
  template:
    metadata:
      labels:
        app: backup-monitor
    spec:
      containers:
      - name: monitor
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          while true; do
#            # æ£€æŸ¥æœ€æ–°å¤‡ä»½æ–‡ä»¶
            LATEST_BACKUP=$(ls -t /backup/*.sql.gz 2>/dev/null | head -n1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              BACKUP_AGE=$(( $(date +%s) - $(stat -c %Y "$LATEST_BACKUP") ))
              
              if [ $BACKUP_AGE -gt 86400 ]; then  # è¶…è¿‡24å°æ—¶
                echo "è­¦å‘Š: å¤‡ä»½æ–‡ä»¶è¿‡æ—§ï¼Œæœ€æ–°å¤‡ä»½: $LATEST_BACKUP"
#                # å‘é€å‘Šè­¦é€šçŸ¥
                curl -X POST $ALERT_WEBHOOK \
                  -H "Content-Type: application/json" \
                  -d "{\"text\":\"MySQLå¤‡ä»½å‘Šè­¦: å¤‡ä»½æ–‡ä»¶è¶…è¿‡24å°æ—¶æœªæ›´æ–°\"}"
              else
                echo "å¤‡ä»½çŠ¶æ€æ­£å¸¸ï¼Œæœ€æ–°å¤‡ä»½: $LATEST_BACKUP"
              fi
            else
              echo "é”™è¯¯: æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
              curl -X POST $ALERT_WEBHOOK \
                -H "Content-Type: application/json" \
                -d "{\"text\":\"MySQLå¤‡ä»½å‘Šè­¦: æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶\"}"
            fi
            
            sleep 3600  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
          done
        env:
        - name: ALERT_WEBHOOK
          value: "https://hooks.dingtalk.com/services/your-webhook"
        volumeMounts:
        - name: backup-storage
          mountPath: /backup
          readOnly: true
      volumes:
      - name: backup-storage
        persistentVolumeClaim:
          claimName: backup-pvc
```

---

## 10. ğŸ”„ å®¹å™¨æ¢å¤æµç¨‹



### 10.1 Dockerç¯å¢ƒæ•°æ®æ¢å¤



**ğŸ”¸ åŸºç¡€æ•°æ®æ¢å¤æµç¨‹**
```bash
#!/bin/bash

# docker-mysql-restore.sh


BACKUP_FILE=$1
CONTAINER_NAME="my-mysql"
MYSQL_USER="root"
MYSQL_PASS="123456"

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ–‡ä»¶è·¯å¾„>"
    echo "ç¤ºä¾‹: $0 /backup/mysql_backup_20250911.sql.gz"
    exit 1
fi

echo "å¼€å§‹MySQLå®¹å™¨æ•°æ®æ¢å¤..."

# 1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶

if [ ! -f "$BACKUP_FILE" ]; then
    echo "é”™è¯¯: å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $BACKUP_FILE"
    exit 1
fi

# 2. åœæ­¢åº”ç”¨æœåŠ¡ï¼ˆé¿å…æ•°æ®å†²çªï¼‰

echo "åœæ­¢åº”ç”¨æœåŠ¡..."
docker-compose stop app-service || true

# 3. å¤‡ä»½å½“å‰æ•°æ®ï¼ˆä»¥é˜²æ¢å¤å¤±è´¥ï¼‰

echo "å¤‡ä»½å½“å‰æ•°æ®ä½œä¸ºå®‰å…¨æªæ–½..."
docker exec $CONTAINER_NAME mysqldump -u$MYSQL_USER -p$MYSQL_PASS \
    --all-databases > /tmp/pre_restore_backup_$(date +%Y%m%d_%H%M%S).sql

# 4. è§£å‹å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯å‹ç¼©çš„ï¼‰

RESTORE_FILE=$BACKUP_FILE
if [[ $BACKUP_FILE == *.gz ]]; then
    echo "è§£å‹å¤‡ä»½æ–‡ä»¶..."
    RESTORE_FILE="/tmp/$(basename $BACKUP_FILE .gz)"
    gunzip -c "$BACKUP_FILE" > "$RESTORE_FILE"
fi

# 5. æ‰§è¡Œæ¢å¤

echo "å¼€å§‹æ¢å¤æ•°æ®..."
docker exec -i $CONTAINER_NAME mysql -u$MYSQL_USER -p$MYSQL_PASS < "$RESTORE_FILE"

if [ $? -eq 0 ]; then
    echo "æ•°æ®æ¢å¤æˆåŠŸ!"
    
#    # 6. éªŒè¯æ¢å¤ç»“æœ
    echo "éªŒè¯æ•°æ®åº“çŠ¶æ€..."
    docker exec $CONTAINER_NAME mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW DATABASES;"
    
#    # 7. é‡å¯åº”ç”¨æœåŠ¡
    echo "é‡å¯åº”ç”¨æœåŠ¡..."
    docker-compose start app-service
    
    echo "æ¢å¤å®Œæˆ!"
else
    echo "æ•°æ®æ¢å¤å¤±è´¥!"
    echo "è¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ¢å¤"
    exit 1
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶

if [[ $BACKUP_FILE == *.gz ]]; then
    rm -f "$RESTORE_FILE"
fi
```

### 10.2 æ•°æ®å·æ¢å¤



**ğŸ”¸ ä»æ•°æ®å·å¤‡ä»½æ¢å¤**
```bash
#!/bin/bash

# volume-restore.sh


VOLUME_BACKUP=$1
NEW_VOLUME_NAME=${2:-mysql-data-restored}

if [ -z "$VOLUME_BACKUP" ]; then
    echo "ç”¨æ³•: $0 <æ•°æ®å·å¤‡ä»½æ–‡ä»¶> [æ–°æ•°æ®å·åç§°]"
    exit 1
fi

echo "å¼€å§‹æ¢å¤æ•°æ®å·..."

# 1. åˆ›å»ºæ–°çš„æ•°æ®å·

docker volume create $NEW_VOLUME_NAME

# 2. ä½¿ç”¨ä¸´æ—¶å®¹å™¨æ¢å¤æ•°æ®

docker run --rm \
    -v $NEW_VOLUME_NAME:/data \
    -v $(dirname $VOLUME_BACKUP):/backup \
    alpine tar xzf /backup/$(basename $VOLUME_BACKUP) -C /data --strip-components=1

if [ $? -eq 0 ]; then
    echo "æ•°æ®å·æ¢å¤æˆåŠŸ: $NEW_VOLUME_NAME"
    echo ""
    echo "ä½¿ç”¨æ–°æ•°æ®å·å¯åŠ¨MySQLå®¹å™¨:"
    echo "docker run -d --name mysql-restored \\"
    echo "  -v $NEW_VOLUME_NAME:/var/lib/mysql \\"
    echo "  -e MYSQL_ROOT_PASSWORD=123456 \\"
    echo "  mysql:8.0"
else
    echo "æ•°æ®å·æ¢å¤å¤±è´¥"
    docker volume rm $NEW_VOLUME_NAME
    exit 1
fi
```

### 10.3 å®Œæ•´ç¯å¢ƒæ¢å¤



**ğŸ”¸ ç¾éš¾æ¢å¤æµç¨‹**
```bash
#!/bin/bash

# disaster-recovery.sh


BACKUP_ARCHIVE=$1
RECOVERY_DIR="/tmp/mysql-recovery"

if [ -z "$BACKUP_ARCHIVE" ]; then
    echo "ç”¨æ³•: $0 <å®Œæ•´å¤‡ä»½å‹ç¼©åŒ…>"
    echo "ç¤ºä¾‹: $0 mysql-project-20250911_143000.tar.gz"
    exit 1
fi

echo "å¼€å§‹MySQLç¯å¢ƒç¾éš¾æ¢å¤..."

# 1. è§£å‹å¤‡ä»½åŒ…

echo "è§£å‹å¤‡ä»½åŒ…..."
mkdir -p $RECOVERY_DIR
tar xzf "$BACKUP_ARCHIVE" -C $RECOVERY_DIR

BACKUP_DIR=$(find $RECOVERY_DIR -maxdepth 1 -type d | grep mysql-project | head -n1)

if [ -z "$BACKUP_DIR" ]; then
    echo "é”™è¯¯: å¤‡ä»½åŒ…æ ¼å¼ä¸æ­£ç¡®"
    exit 1
fi

cd "$BACKUP_DIR"

# 2. æ¢å¤å®¹å™¨é•œåƒ

echo "æ¢å¤å®¹å™¨é•œåƒ..."
if [ -f "mysql-image.tar.gz" ]; then
    docker load < mysql-image.tar.gz
fi

# 3. æ¢å¤æ•°æ®å·

echo "æ¢å¤æ•°æ®å·..."
if [ -f "mysql-volume.tar.gz" ]; then
    docker volume create mysql-data-recovered
    docker run --rm \
        -v mysql-data-recovered:/data \
        -v $(pwd):/backup \
        alpine tar xzf /backup/mysql-volume.tar.gz -C /data --strip-components=1
fi

# 4. æ¢å¤å®¹å™¨é…ç½®

echo "æ¢å¤å®¹å™¨é…ç½®..."
if [ -f "docker-compose.yml" ]; then
#    # ä¿®æ”¹docker-compose.ymlä¸­çš„æ•°æ®å·åç§°
    sed -i 's/mysql-data:/mysql-data-recovered:/g' docker-compose.yml
fi

# 5. å¯åŠ¨æœåŠ¡

echo "å¯åŠ¨MySQLæœåŠ¡..."
if [ -f "docker-compose.yml" ]; then
    docker-compose up -d
else
#    # ä»å®¹å™¨ä¿¡æ¯æ¢å¤å¯åŠ¨å‚æ•°
    if [ -f "container-info.json" ]; then
        MYSQL_ROOT_PASSWORD=$(cat container-info.json | jq -r '.[0].Config.Env[]' | grep MYSQL_ROOT_PASSWORD | cut -d'=' -f2)
        
        docker run -d \
            --name mysql-recovered \
            -e MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD \
            -v mysql-data-recovered:/var/lib/mysql \
            -p 3306:3306 \
            mysql:8.0
    fi
fi

# 6. ç­‰å¾…MySQLå¯åŠ¨

echo "ç­‰å¾…MySQLå¯åŠ¨..."
sleep 30

# 7. éªŒè¯æ¢å¤

CONTAINER_NAME=$(docker ps | grep mysql | awk '{print $NF}' | head -n1)
if [ -n "$CONTAINER_NAME" ]; then
    if docker exec $CONTAINER_NAME mysqladmin -uroot ping >/dev/null 2>&1; then
        echo "MySQLæ¢å¤æˆåŠŸ!"
        
#        # æ˜¾ç¤ºæ•°æ®åº“åˆ—è¡¨
        echo "æ•°æ®åº“åˆ—è¡¨:"
        docker exec $CONTAINER_NAME mysql -uroot -e "SHOW DATABASES;"
        
        echo ""
        echo "æ¢å¤å®Œæˆ! è¯·éªŒè¯ä¸šåŠ¡åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚"
        echo "å®¹å™¨åç§°: $CONTAINER_NAME"
    else
        echo "MySQLå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—:"
        docker logs $CONTAINER_NAME
    fi
else
    echo "æœªæ‰¾åˆ°MySQLå®¹å™¨ï¼Œæ¢å¤å¤±è´¥"
fi
```

### 10.4 åˆ†æ­¥éª¤æ¢å¤æŒ‡å—



**ğŸ”¸ æ¢å¤å‰çš„æ£€æŸ¥æ¸…å•**
```bash
#!/bin/bash

# pre-restore-checklist.sh


echo "=== MySQLå®¹å™¨æ¢å¤å‰æ£€æŸ¥æ¸…å• ==="
echo ""

# 1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶

echo "1. æ£€æŸ¥å¤‡ä»½æ–‡ä»¶:"
if [ -f "$BACKUP_FILE" ]; then
    echo "   âœ… å¤‡ä»½æ–‡ä»¶å­˜åœ¨: $BACKUP_FILE"
    echo "   ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h $BACKUP_FILE | cut -f1)"
    echo "   ğŸ“… åˆ›å»ºæ—¶é—´: $(stat -c %y $BACKUP_FILE)"
else
    echo "   âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨"
fi

# 2. æ£€æŸ¥ç£ç›˜ç©ºé—´

echo ""
echo "2. æ£€æŸ¥ç£ç›˜ç©ºé—´:"
AVAILABLE_SPACE=$(df -h $(dirname $BACKUP_FILE) | awk 'NR==2 {print $4}')
echo "   ğŸ’¾ å¯ç”¨ç©ºé—´: $AVAILABLE_SPACE"

# 3. æ£€æŸ¥Dockerç¯å¢ƒ

echo ""
echo "3. æ£€æŸ¥Dockerç¯å¢ƒ:"
if docker --version >/dev/null 2>&1; then
    echo "   âœ… Docker å¯ç”¨: $(docker --version | cut -d' ' -f3)"
else
    echo "   âŒ Docker ä¸å¯ç”¨"
fi

# 4. æ£€æŸ¥ç«¯å£å ç”¨

echo ""
echo "4. æ£€æŸ¥ç«¯å£å ç”¨:"
if netstat -ln | grep :3306 >/dev/null 2>&1; then
    echo "   âš ï¸  ç«¯å£3306è¢«å ç”¨:"
    netstat -ln | grep :3306
else
    echo "   âœ… ç«¯å£3306å¯ç”¨"
fi

# 5. æ£€æŸ¥ç°æœ‰å®¹å™¨

echo ""
echo "5. æ£€æŸ¥ç°æœ‰MySQLå®¹å™¨:"
MYSQL_CONTAINERS=$(docker ps -a | grep mysql | wc -l)
if [ $MYSQL_CONTAINERS -gt 0 ]; then
    echo "   âš ï¸  å‘ç° $MYSQL_CONTAINERS ä¸ªMySQLå®¹å™¨:"
    docker ps -a | grep mysql
    echo "   ğŸ’¡ å»ºè®®å¤‡ä»½æˆ–åœæ­¢ç°æœ‰å®¹å™¨"
else
    echo "   âœ… æ— ç°æœ‰MySQLå®¹å™¨"
fi

echo ""
echo "=== æ£€æŸ¥å®Œæˆ ==="
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ å®¹å™¨åŒ–å¤‡ä»½ç‰¹ç‚¹ï¼šä¸´æ—¶æ€§ã€éš”ç¦»æ€§ã€è½»é‡çº§å¸¦æ¥çš„å¤‡ä»½æŒ‘æˆ˜
ğŸ”¸ å¤‡ä»½å¯¹è±¡ï¼šæ•°æ®ã€æ•°æ®å·ã€é•œåƒã€é…ç½®ã€ç¼–æ’æ–‡ä»¶
ğŸ”¸ å¤‡ä»½æ–¹å¼ï¼šé€»è¾‘å¤‡ä»½(mysqldump)ã€ç‰©ç†å¤‡ä»½(æ•°æ®å·)
ğŸ”¸ å¤‡ä»½ç­–ç•¥ï¼šå…¨é‡ã€å¢é‡ã€å®šæ—¶ã€è‡ªåŠ¨åŒ–
ğŸ”¸ æ¢å¤æµç¨‹ï¼šå‡†å¤‡ã€æ¢å¤ã€éªŒè¯ã€å¯åŠ¨æœåŠ¡
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ å®¹å™¨åŒ–ç¯å¢ƒvsä¼ ç»Ÿç¯å¢ƒçš„å¤‡ä»½å·®å¼‚**
```
ä¼ ç»Ÿç¯å¢ƒï¼š
- ç›´æ¥è®¿é—®æ•°æ®æ–‡ä»¶
- é…ç½®æ–‡ä»¶å›ºå®šä½ç½®
- æœåŠ¡ç›´æ¥ç®¡ç†

å®¹å™¨åŒ–ç¯å¢ƒï¼š
- é€šè¿‡å®¹å™¨æ¥å£æ“ä½œ
- é…ç½®åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹
- éœ€è¦ç¼–æ’ç®¡ç†
```

**ğŸ”¹ æ•°æ®æŒä¹…åŒ–çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·ï¼š
- å®¹å™¨åˆ é™¤ä¸å½±å“æ•°æ®
- ä¾¿äºå¤‡ä»½å’Œè¿ç§»
- æé«˜I/Oæ€§èƒ½

æ•°æ®å·ç±»å‹é€‰æ‹©ï¼š
- å‘½åæ•°æ®å·ï¼šDockerç®¡ç†ï¼Œä¾¿äºæ“ä½œ
- ç»‘å®šæŒ‚è½½ï¼šç›´æ¥è®¿é—®å®¿ä¸»æœºç›®å½•
- tmpfsæŒ‚è½½ï¼šä¸´æ—¶æ•°æ®ï¼Œé‡å¯ä¸¢å¤±
```

**ğŸ”¹ å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„å¤‡ä»½åè°ƒ**
```
æŒ‘æˆ˜ï¼š
- æ•°æ®ä¸€è‡´æ€§ï¼šå¤šä¸ªæœåŠ¡çš„æ•°æ®è¦åŒæ­¥
- ä¾èµ–å…³ç³»ï¼šæœåŠ¡é—´çš„æ•°æ®ä¾èµ–
- æ¢å¤é¡ºåºï¼šæŒ‰ä¾èµ–å…³ç³»æ¢å¤

è§£å†³æ–¹æ¡ˆï¼š
- å…¨å±€å¤‡ä»½çª—å£
- åŸºäºäº‹åŠ¡æ—¥å¿—çš„å¤‡ä»½
- ä¾èµ–å…³ç³»ç®¡ç†
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ¯ å¤‡ä»½ç­–ç•¥é€‰æ‹©**
```
å°å‹åº”ç”¨ï¼š
âœ… ç®€å•çš„mysqldumpå¤‡ä»½
âœ… å®šæ—¶ä»»åŠ¡+è„šæœ¬
âœ… æœ¬åœ°å­˜å‚¨

ä¸­å‹åº”ç”¨ï¼š
âœ… Docker Composeç¼–æ’
âœ… æ•°æ®å·+é€»è¾‘å¤‡ä»½ç»“åˆ
âœ… è¿œç¨‹å­˜å‚¨å¤‡ä»½

å¤§å‹åº”ç”¨ï¼š
âœ… Kubernetes CronJob
âœ… åˆ†å¸ƒå¼å¤‡ä»½ç­–ç•¥
âœ… å¤‡ä»½ç›‘æ§å’Œå‘Šè­¦
```

**ğŸ”§ æ¢å¤åœºæ™¯åº”å¯¹**
```
æ•°æ®æŸåï¼š
- ç«‹å³åœæ­¢å†™å…¥æ“ä½œ
- ä»æœ€è¿‘çš„å®Œæ•´å¤‡ä»½æ¢å¤
- ä½¿ç”¨å¢é‡å¤‡ä»½è¡¥å……æ•°æ®

å®¹å™¨æ•…éšœï¼š
- æ£€æŸ¥æ•°æ®å·æ˜¯å¦å®Œæ•´
- é‡å»ºå®¹å™¨ï¼ŒæŒ‚è½½åŸæ•°æ®å·
- éªŒè¯æ•°æ®ä¸€è‡´æ€§

æœåŠ¡å™¨è¿ç§»ï¼š
- å®Œæ•´ç¯å¢ƒå¤‡ä»½
- è·¨ä¸»æœºæ•°æ®ä¼ è¾“
- éªŒè¯ä¸šåŠ¡åŠŸèƒ½

ç‰ˆæœ¬å‡çº§ï¼š
- å…¼å®¹æ€§æµ‹è¯•
- æ•°æ®æ ¼å¼è½¬æ¢
- å›æ»šæ–¹æ¡ˆå‡†å¤‡
```

**ğŸš€ æœ€ä½³å®è·µå»ºè®®**
```
å¤‡ä»½é¢‘ç‡ï¼š
- æ ¸å¿ƒæ•°æ®ï¼šæ¯å¤©å…¨é‡å¤‡ä»½
- ä¸€èˆ¬æ•°æ®ï¼šæ¯å‘¨å…¨é‡å¤‡ä»½
- é«˜é¢‘å˜æ›´ï¼šå®æ—¶å¢é‡å¤‡ä»½

å­˜å‚¨ç­–ç•¥ï¼š
- æœ¬åœ°å­˜å‚¨ï¼šå¿«é€Ÿæ¢å¤
- è¿œç¨‹å­˜å‚¨ï¼šç¾éš¾æ¢å¤
- å¤šåœ°å¤‡ä»½ï¼šé«˜å¯ç”¨ä¿éšœ

ç›‘æ§å‘Šè­¦ï¼š
- å¤‡ä»½æˆåŠŸç‡ç›‘æ§
- æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
- å­˜å‚¨ç©ºé—´ç›‘æ§
- æ¢å¤æ—¶é—´æµ‹è¯•
```

### 11.4 å®¹å™¨åŒ–å¤‡ä»½è¿›é˜¶æŠ€å·§



**ğŸ” é«˜çº§å¤‡ä»½æŠ€æœ¯**
```
1. çƒ­å¤‡ä»½æŠ€æœ¯ï¼š
   - åŸºäºMVCCçš„åœ¨çº¿å¤‡ä»½
   - ä½¿ç”¨MySQLçš„BACKUP LOCK
   - é¿å…é•¿æ—¶é—´é”è¡¨

2. å¢é‡å¤‡ä»½å®ç°ï¼š
   - åŸºäºbinlogçš„å¢é‡å¤‡ä»½
   - ä½¿ç”¨mysqlbinlogå·¥å…·
   - æ—¶é—´ç‚¹æ¢å¤(PITR)

3. å¹¶è¡Œå¤‡ä»½ï¼š
   - å¤šæ•°æ®åº“å¹¶è¡Œå¤‡ä»½
   - åˆ†è¡¨å¹¶è¡Œå¯¼å‡º
   - å‹ç¼©å’Œä¼ è¾“å¹¶è¡Œ
```

**ğŸ” å®‰å…¨æ€§è€ƒè™‘**
```
å¤‡ä»½åŠ å¯†ï¼š
- ä¼ è¾“åŠ å¯†ï¼šä½¿ç”¨SSL/TLS
- å­˜å‚¨åŠ å¯†ï¼šåŠ å¯†å¤‡ä»½æ–‡ä»¶
- å¯†é’¥ç®¡ç†ï¼šå®‰å…¨çš„å¯†é’¥å­˜å‚¨

è®¿é—®æ§åˆ¶ï¼š
- å¤‡ä»½ç”¨æˆ·æƒé™æœ€å°åŒ–
- å¤‡ä»½æ–‡ä»¶è®¿é—®é™åˆ¶
- å®¡è®¡æ—¥å¿—è®°å½•

åˆè§„è¦æ±‚ï¼š
- æ•°æ®ä¿ç•™æ”¿ç­–
- éšç§æ•°æ®å¤„ç†
- ç›‘ç®¡è¦æ±‚éµå¾ª
```

### 11.5 æ•…éšœæ’é™¤æŒ‡å—



**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**

> âš ï¸ **é—®é¢˜1**ï¼šå¤‡ä»½è¿‡ç¨‹ä¸­å®¹å™¨åœæ­¢å“åº”
```
åŸå› åˆ†æï¼š
- å†…å­˜ä¸è¶³å¯¼è‡´å®¹å™¨è¢«Kill
- ç£ç›˜ç©ºé—´ä¸è¶³
- mysqldumpè¿›ç¨‹å ç”¨è¿‡å¤šèµ„æº

è§£å†³æ–¹æ¡ˆï¼š
# å¢åŠ å†…å­˜é™åˆ¶

docker run --memory=2g mysql:8.0

# ä½¿ç”¨å•äº‹åŠ¡å¤‡ä»½å‡å°‘é”å®šæ—¶é—´

mysqldump --single-transaction --quick

# åˆ†æ‰¹å¤‡ä»½å¤§è¡¨

mysqldump --where="id BETWEEN 1 AND 100000" table_name
```

> âš ï¸ **é—®é¢˜2**ï¼šæ•°æ®å·å¤‡ä»½ä¸å®Œæ•´
```
åŸå› åˆ†æï¼š
- å¤‡ä»½è¿‡ç¨‹ä¸­æœ‰å†™å…¥æ“ä½œ
- æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒå¿«ç…§
- å¤‡ä»½å·¥å…·å¼‚å¸¸é€€å‡º

è§£å†³æ–¹æ¡ˆï¼š
# åœæœºå¤‡ä»½ï¼ˆæœ€å®‰å…¨ï¼‰

docker stop mysql-container
docker run --rm -v mysql-data:/data -v /backup:/backup alpine tar czf /backup/data.tar.gz /data
docker start mysql-container

# åœ¨çº¿å¤‡ä»½ï¼ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿé”ï¼‰

docker exec mysql-container mysql -e "FLUSH TABLES WITH READ LOCK"
# æ‰§è¡Œå¤‡ä»½

docker exec mysql-container mysql -e "UNLOCK TABLES"
```

> âš ï¸ **é—®é¢˜3**ï¼šè·¨ç‰ˆæœ¬æ¢å¤å¤±è´¥
```
åŸå› åˆ†æï¼š
- MySQLç‰ˆæœ¬ä¸å…¼å®¹
- å­—ç¬¦é›†å·®å¼‚
- SQLè¯­æ³•å˜æ›´

è§£å†³æ–¹æ¡ˆï¼š
# æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§

mysql --version

# ä½¿ç”¨å…¼å®¹é€‰é¡¹

mysqldump --compatible=mysql40

# åˆ†æ­¥æ¢å¤

mysql < schema.sql  # å…ˆæ¢å¤ç»“æ„
mysql < data.sql    # å†æ¢å¤æ•°æ®
```

### 11.6 æ€§èƒ½ä¼˜åŒ–å»ºè®®



**âš¡ å¤‡ä»½æ€§èƒ½ä¼˜åŒ–**
```
mysqldumpä¼˜åŒ–ï¼š
--single-transaction    # ä¿è¯ä¸€è‡´æ€§
--quick                # ä¸ç¼“å­˜æŸ¥è¯¢ç»“æœ
--extended-insert      # ä½¿ç”¨æ‰©å±•æ’å…¥è¯­æ³•
--compress             # å‹ç¼©ä¼ è¾“æ•°æ®
--hex-blob             # äºŒè¿›åˆ¶æ•°æ®åå…­è¿›åˆ¶è¡¨ç¤º

ç¤ºä¾‹ï¼š
mysqldump --single-transaction --quick --extended-insert \
  --compress --hex-blob -uroot -p123456 mydb > backup.sql
```

**ğŸš€ æ¢å¤æ€§èƒ½ä¼˜åŒ–**
```
MySQLé…ç½®ä¼˜åŒ–ï¼š
innodb_buffer_pool_size = 1G      # å¢å¤§ç¼“å†²æ± 
innodb_log_file_size = 256M       # å¢å¤§æ—¥å¿—æ–‡ä»¶
innodb_flush_log_at_trx_commit = 2 # å»¶è¿Ÿåˆ·æ–°æ—¥å¿—
bulk_insert_buffer_size = 256M     # æ‰¹é‡æ’å…¥ä¼˜åŒ–

æ¢å¤æ—¶ä¸´æ—¶è®¾ç½®ï¼š
mysql -e "SET foreign_key_checks=0;"  # ç¦ç”¨å¤–é”®æ£€æŸ¥
mysql -e "SET unique_checks=0;"       # ç¦ç”¨å”¯ä¸€æ€§æ£€æŸ¥
mysql < backup.sql                    # æ‰§è¡Œæ¢å¤
mysql -e "SET foreign_key_checks=1;"  # æ¢å¤å¤–é”®æ£€æŸ¥
mysql -e "SET unique_checks=1;"       # æ¢å¤å”¯ä¸€æ€§æ£€æŸ¥
```

### 11.7 è‡ªåŠ¨åŒ–è¿ç»´é›†æˆ



**ğŸ¤– ä¸CI/CDé›†æˆ**
```yaml
# .gitlab-ci.yml ç¤ºä¾‹

backup_mysql:
  stage: backup
  script:
    - docker exec mysql-prod mysqldump -uroot -p$MYSQL_PASSWORD --all-databases > backup.sql
    - gzip backup.sql
    - aws s3 cp backup.sql.gz s3://mysql-backups/$(date +%Y%m%d)/
  only:
    - schedules
  tags:
    - docker
```

**ğŸ“Š ç›‘æ§é›†æˆ**
```yaml
# Prometheusç›‘æ§é…ç½®

- name: mysql_backup_age
  query: time() - mysql_backup_last_success_timestamp
  rules:
    - alert: MySQLBackupTooOld
      expr: mysql_backup_age > 86400  # è¶…è¿‡24å°æ—¶
      labels:
        severity: warning
      annotations:
        summary: "MySQLå¤‡ä»½è¿‡æœŸ"
        description: "MySQLå¤‡ä»½è¶…è¿‡24å°æ—¶æœªæ›´æ–°"
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®¹å™¨åŒ–å¤‡ä»½éœ€è¦è€ƒè™‘æ•°æ®æŒä¹…åŒ–å’Œç¯å¢ƒä¸€è‡´æ€§
- æ•°æ®å·å¤‡ä»½å’Œé€»è¾‘å¤‡ä»½å„æœ‰ä¼˜åŠ¿ï¼Œå»ºè®®ç»“åˆä½¿ç”¨
- å¾®æœåŠ¡ç¯å¢ƒéœ€è¦åè°ƒå¤šä¸ªæœåŠ¡çš„å¤‡ä»½æ—¶æœº
- è‡ªåŠ¨åŒ–å’Œç›‘æ§æ˜¯å®¹å™¨åŒ–å¤‡ä»½çš„å…³é”®
- æ¢å¤æµç¨‹è¦å……åˆ†æµ‹è¯•ï¼Œç¡®ä¿å¯è¡Œæ€§
- å®‰å…¨æ€§å’Œæ€§èƒ½ä¼˜åŒ–åŒæ ·é‡è¦

**å®æˆ˜å»ºè®®**ï¼š
ä»ç®€å•çš„å•å®¹å™¨å¤‡ä»½å¼€å§‹ï¼Œé€æ­¥æ‰©å±•åˆ°å¤æ‚çš„å¾®æœåŠ¡ç¯å¢ƒã€‚å®šæœŸè¿›è¡Œæ¢å¤æ¼”ç»ƒï¼ŒéªŒè¯å¤‡ä»½çš„æœ‰æ•ˆæ€§ã€‚å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ï¼Œç¡®ä¿å¤‡ä»½ç³»ç»Ÿçš„å¯é è¿è¡Œã€‚