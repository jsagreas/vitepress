---
title: 7ã€gh-ostç›‘æ§ä¸çŠ¶æ€æŸ¥è¯¢
---
## ğŸ“š ç›®å½•

1. [gh-ostç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-gh-ostç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [æ‰§è¡Œè¿›åº¦ç›‘æ§](#2-æ‰§è¡Œè¿›åº¦ç›‘æ§)
3. [çŠ¶æ€ä¿¡æ¯æŸ¥è¯¢](#3-çŠ¶æ€ä¿¡æ¯æŸ¥è¯¢)
4. [æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡](#4-æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡)
5. [å»¶è¿Ÿç›‘æ§æ£€æŸ¥](#5-å»¶è¿Ÿç›‘æ§æ£€æŸ¥)
6. [é€Ÿåº¦æ§åˆ¶ç›‘æ§](#6-é€Ÿåº¦æ§åˆ¶ç›‘æ§)
7. [é”™è¯¯ä¿¡æ¯æ£€æŸ¥](#7-é”™è¯¯ä¿¡æ¯æ£€æŸ¥)
8. [æ—¥å¿—æ–‡ä»¶åˆ†æ](#8-æ—¥å¿—æ–‡ä»¶åˆ†æ)
9. [å®æ—¶çŠ¶æ€æ˜¾ç¤º](#9-å®æ—¶çŠ¶æ€æ˜¾ç¤º)
10. [ç›‘æ§è„šæœ¬å¼€å‘](#10-ç›‘æ§è„šæœ¬å¼€å‘)
11. [å‘Šè­¦æœºåˆ¶è®¾ç½®](#11-å‘Šè­¦æœºåˆ¶è®¾ç½®)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ gh-ostç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯gh-ostç›‘æ§


**ç®€å•ç†è§£**ï¼šå°±åƒå¼€è½¦æ—¶çœ‹ä»ªè¡¨ç›˜ä¸€æ ·ï¼Œgh-ostç›‘æ§è®©æˆ‘ä»¬å®æ—¶äº†è§£DDLæ“ä½œçš„"è¡Œé©¶çŠ¶æ€"

```
ä¼ ç»ŸDDLæ‰§è¡Œï¼š           gh-ostæ‰§è¡Œï¼š
å¼€å§‹ â†’ ... â†’ ç»“æŸ       å¼€å§‹ â†’ è¿›åº¦æ˜¾ç¤º â†’ æ€§èƒ½ç›‘æ§ â†’ ç»“æŸ
    â†‘                     â†‘
  é»‘ç›’å­                 é€æ˜å¯æ§
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ“Š **å®æ—¶ç›‘æ§**ï¼šéšæ—¶äº†è§£DDLæ‰§è¡Œè¿›åº¦
- ğŸ” **é—®é¢˜å‘ç°**ï¼šåŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆå’Œå¼‚å¸¸
- âš¡ **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®ç›‘æ§ç»“æœè°ƒæ•´æ‰§è¡Œç­–ç•¥
- ğŸ›¡ï¸ **é£é™©æ§åˆ¶**ï¼šé¿å…å¯¹ç”Ÿäº§ç¯å¢ƒé€ æˆå½±å“

### 1.2 ç›‘æ§çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§**ï¼š
```
ç”Ÿäº§ç¯å¢ƒDDLç‰¹ç‚¹ï¼š
â€¢ æ•°æ®é‡å¤§ï¼šå‡ åƒä¸‡åˆ°å‡ äº¿è¡Œæ•°æ®
â€¢ æ‰§è¡Œæ—¶é—´é•¿ï¼šå‡ å°æ—¶åˆ°å‡ å¤©
â€¢ å½±å“èŒƒå›´å¹¿ï¼šå¯èƒ½å½±å“æ•´ä¸ªåº”ç”¨
â€¢ é£é™©é«˜ï¼šæ“ä½œä¸å¯é€†

ç›‘æ§è§£å†³çš„é—®é¢˜ï¼š
âœ… çŸ¥é“æ‰§è¡Œåˆ°å“ªä¸€æ­¥äº†
âœ… çŸ¥é“è¿˜éœ€è¦å¤šé•¿æ—¶é—´
âœ… çŸ¥é“æ˜¯å¦å½±å“äº†ä¸šåŠ¡
âœ… çŸ¥é“ä½•æ—¶éœ€è¦å¹²é¢„
```

### 1.3 ç›‘æ§ä½“ç³»æ¶æ„


**ç›‘æ§å±‚æ¬¡ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ç›‘æ§                â”‚ â† ä¸šåŠ¡å½±å“è¯„ä¼°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           gh-ostè¿›ç¨‹ç›‘æ§            â”‚ â† æ‰§è¡ŒçŠ¶æ€è·Ÿè¸ª
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚           MySQLæ€§èƒ½ç›‘æ§             â”‚ â† æ•°æ®åº“å‹åŠ›ç›‘æ§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ç³»ç»Ÿèµ„æºç›‘æ§              â”‚ â† ç¡¬ä»¶èµ„æºä½¿ç”¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“ˆ æ‰§è¡Œè¿›åº¦ç›‘æ§


### 2.1 åŸºæœ¬è¿›åº¦ä¿¡æ¯


**æ ¸å¿ƒè¿›åº¦æŒ‡æ ‡**ï¼š
```bash
# æŸ¥çœ‹åŸºç¡€è¿›åº¦ä¿¡æ¯
echo "status" | nc -U /tmp/gh-ost.sock

# è¿”å›ä¿¡æ¯ç¤ºä¾‹ï¼š
2023-09-11 15:30:21 [info] binlog coordinates: mysql-bin.000123:45678901
2023-09-11 15:30:21 [info] Migrated rows: 1234567 / 5000000 (24.7%)
2023-09-11 15:30:21 [info] ETA: 2h34m12s
```

**è¿›åº¦ä¿¡æ¯è§£è¯»**ï¼š

| æŒ‡æ ‡åç§° | å«ä¹‰è¯´æ˜ | ç¤ºä¾‹å€¼ | é‡è¦ç¨‹åº¦ |
|---------|---------|--------|---------|
| **Migrated rows** | `å·²è¿ç§»çš„è¡Œæ•°` | `1234567` | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **Total rows** | `æ€»è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰` | `5000000` | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **Progress %** | `å®Œæˆç™¾åˆ†æ¯”` | `24.7%` | ğŸ”¥ğŸ”¥ğŸ”¥ |
| **ETA** | `é¢„è®¡å‰©ä½™æ—¶é—´` | `2h34m12s` | ğŸ”¥ğŸ”¥ğŸ”¥ |

### 2.2 è¯¦ç»†è¿›åº¦æŸ¥è¯¢


**è·å–è¯¦ç»†çŠ¶æ€**ï¼š
```bash
# è·å–å®Œæ•´çŠ¶æ€ä¿¡æ¯
echo "chunk-size" | nc -U /tmp/gh-ost.sock
echo "max-lag-millis" | nc -U /tmp/gh-ost.sock
echo "throttle-query" | nc -U /tmp/gh-ost.sock

# æŸ¥çœ‹å½“å‰é…ç½®
ps aux | grep gh-ost | grep -v grep
```

**è¿›åº¦ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# progress_monitor.sh - è¿›åº¦ç›‘æ§è„šæœ¬

SOCKET_FILE="/tmp/gh-ost.sock"

while true; do
    if [ -S "$SOCKET_FILE" ]; then
        echo "=== $(date) ==="
        echo "status" | nc -U $SOCKET_FILE
        echo "throttle-query" | nc -U $SOCKET_FILE
        echo ""
    else
        echo "gh-ost socket not found, DDL may be completed"
        break
    fi
    sleep 30
done
```

### 2.3 è¿›åº¦å¯è§†åŒ–


**ç®€å•è¿›åº¦æ¡æ˜¾ç¤º**ï¼š
```bash
#!/bin/bash
# ä»gh-ostæ—¥å¿—æå–è¿›åº¦ä¿¡æ¯å¹¶æ˜¾ç¤ºè¿›åº¦æ¡

show_progress() {
    local current=$1
    local total=$2
    local width=50
    
    local percent=$((current * 100 / total))
    local filled=$((current * width / total))
    local empty=$((width - filled))
    
    printf "\r["
    printf "%*s" $filled | tr ' ' 'â–ˆ'
    printf "%*s" $empty | tr ' ' 'â–‘'
    printf "] %d%% (%d/%d)" $percent $current $total
}

# ç¤ºä¾‹è¾“å‡ºï¼š
# [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 24% (1234567/5000000)
```

---

## 3. ğŸ” çŠ¶æ€ä¿¡æ¯æŸ¥è¯¢


### 3.1 åŸºç¡€çŠ¶æ€æŸ¥è¯¢


**Socketå‘½ä»¤å¤§å…¨**ï¼š
```bash
# è¿æ¥åˆ°gh-ost Unix socket
SOCKET="/tmp/gh-ost.sock"

# åŸºç¡€çŠ¶æ€å‘½ä»¤
echo "help" | nc -U $SOCKET          # æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤
echo "status" | nc -U $SOCKET        # æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€  
echo "sup" | nc -U $SOCKET           # ç®€åŒ–çŠ¶æ€ä¿¡æ¯
echo "coordinates" | nc -U $SOCKET   # æŸ¥çœ‹binlogä½ç½®
```

**çŠ¶æ€ä¿¡æ¯è¯¦è§£**ï¼š

> ğŸ’¡ **Socketé€šä¿¡åŸç†**ï¼šgh-oståˆ›å»ºUnix socketæ–‡ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡`nc`å‘½ä»¤ä¸å…¶é€šä¿¡ï¼Œå°±åƒæ‰“ç”µè¯ä¸€æ ·è¯¢é—®å½“å‰çŠ¶æ€

```bash
# çŠ¶æ€æŸ¥è¯¢ç¤ºä¾‹åŠå«ä¹‰
$ echo "status" | nc -U /tmp/gh-ost.sock

# è¾“å‡ºè§£è¯»ï¼š
2023-09-11 15:30:21 [info] binlog coordinates: mysql-bin.000123:45678901
# â†‘ å½“å‰å¤„ç†åˆ°çš„binlogæ–‡ä»¶å’Œä½ç½®

2023-09-11 15:30:21 [info] Migrated rows: 1234567 / 5000000 (24.7%)  
# â†‘ å·²è¿ç§»è¡Œæ•° / æ€»ä¼°ç®—è¡Œæ•° (å®Œæˆç™¾åˆ†æ¯”)

2023-09-11 15:30:21 [info] ETA: 2h34m12s
# â†‘ é¢„è®¡å‰©ä½™å®Œæˆæ—¶é—´
```

### 3.2 é…ç½®å‚æ•°æŸ¥è¯¢


**å½“å‰é…ç½®æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹å…³é”®é…ç½®å‚æ•°
echo "chunk-size" | nc -U $SOCKET              # æ¯æ‰¹å¤„ç†è¡Œæ•°
echo "max-lag-millis" | nc -U $SOCKET          # æœ€å¤§å»¶è¿Ÿé˜ˆå€¼
echo "throttle-query" | nc -U $SOCKET          # é™æµæŸ¥è¯¢SQL
echo "nice-ratio" | nc -U $SOCKET              # CPUå‹å¥½æ¯”ç‡
```

**é…ç½®ä¿¡æ¯å¯¹æ¯”è¡¨**ï¼š

| å‚æ•°åç§° | é»˜è®¤å€¼ | ä½œç”¨è¯´æ˜ | è°ƒæ•´å»ºè®® |
|---------|--------|---------|---------|
| **chunk-size** | `1000` | `æ¯æ‰¹å¤„ç†è¡Œæ•°` | é«˜æ€§èƒ½æœºå™¨å¯é€‚å½“å¢åŠ  |
| **max-lag-millis** | `1500ms` | `ä¸»ä»å»¶è¿Ÿé˜ˆå€¼` | è¯»å†™åˆ†ç¦»ç¯å¢ƒéœ€è¦é™ä½ |
| **nice-ratio** | `0` | `CPUè®©æ­¥æ¯”ç‡` | ç¹å¿™ç³»ç»Ÿå»ºè®®è®¾ç½®0.5-1.0 |

### 3.3 å®æ—¶çŠ¶æ€ç›‘æ§


**æŒç»­çŠ¶æ€ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# realtime_monitor.sh - å®æ—¶çŠ¶æ€ç›‘æ§

SOCKET="/tmp/gh-ost.sock"
LOG_FILE="/var/log/gh-ost-monitor.log"

monitor_status() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    if [ -S "$SOCKET" ]; then
        echo "=== $timestamp ===" | tee -a $LOG_FILE
        
        # åŸºç¡€çŠ¶æ€
        echo "status" | nc -U $SOCKET | tee -a $LOG_FILE
        
        # æ€§èƒ½æŒ‡æ ‡  
        echo "throttle-query" | nc -U $SOCKET | tee -a $LOG_FILE
        
        echo "" | tee -a $LOG_FILE
    else
        echo "$timestamp: gh-ost socket not available" | tee -a $LOG_FILE
        return 1
    fi
}

# æ¯30ç§’ç›‘æ§ä¸€æ¬¡
while monitor_status; do
    sleep 30
done
```

---

## 4. ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡


### 4.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡


**å…³é”®æ€§èƒ½æŒ‡æ ‡è¯´æ˜**ï¼š
```
ååé‡æŒ‡æ ‡ï¼š
â€¢ Rows/secï¼šæ¯ç§’å¤„ç†è¡Œæ•°
â€¢ Bytes/secï¼šæ¯ç§’å¤„ç†å­—èŠ‚æ•°  
â€¢ Chunks/secï¼šæ¯ç§’å¤„ç†æ‰¹æ¬¡æ•°

å»¶è¿ŸæŒ‡æ ‡ï¼š
â€¢ Replication lagï¼šä¸»ä»å¤åˆ¶å»¶è¿Ÿ
â€¢ Query timeï¼šå•ä¸ªæŸ¥è¯¢è€—æ—¶
â€¢ Batch timeï¼šå•æ‰¹æ•°æ®å¤„ç†è€—æ—¶

èµ„æºä½¿ç”¨æŒ‡æ ‡ï¼š
â€¢ CPU usageï¼šCPUä½¿ç”¨ç‡
â€¢ Memory usageï¼šå†…å­˜ä½¿ç”¨é‡
â€¢ Disk I/Oï¼šç£ç›˜è¯»å†™é€Ÿåº¦
```

### 4.2 æ€§èƒ½æ•°æ®æ”¶é›†


**æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# performance_collector.sh - æ€§èƒ½æ•°æ®æ”¶é›†

collect_performance() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # MySQLæ€§èƒ½æŒ‡æ ‡
    mysql -e "
    SELECT 
        VARIABLE_VALUE as threads_running 
    FROM INFORMATION_SCHEMA.GLOBAL_STATUS 
    WHERE VARIABLE_NAME='Threads_running';
    
    SELECT 
        VARIABLE_VALUE as slow_queries
    FROM INFORMATION_SCHEMA.GLOBAL_STATUS 
    WHERE VARIABLE_NAME='Slow_queries';
    "
    
    # ç³»ç»Ÿèµ„æºä½¿ç”¨
    echo "=== System Resources at $timestamp ==="
    top -bn1 | grep "gh-ost" | head -5
    iostat -x 1 1 | grep -E "(Device|sda)"
}

# å®šæœŸæ”¶é›†æ€§èƒ½æ•°æ®
while true; do
    collect_performance
    sleep 60
done
```

### 4.3 æ€§èƒ½åŸºå‡†å¯¹æ¯”


**æ€§èƒ½è¡¨ç°å‚è€ƒ**ï¼š

| ç¡¬ä»¶é…ç½® | è¡¨å¤§å° | é¢„æœŸæ€§èƒ½ | å®é™…æ¡ˆä¾‹ |
|---------|--------|---------|---------|
| **8æ ¸16G SSD** | `1000ä¸‡è¡Œ` | `~2000è¡Œ/ç§’` | 1.5å°æ—¶å®Œæˆ |
| **16æ ¸32G SSD** | `5000ä¸‡è¡Œ` | `~5000è¡Œ/ç§’` | 3å°æ—¶å®Œæˆ |
| **32æ ¸64G NVMe** | `2äº¿è¡Œ` | `~8000è¡Œ/ç§’` | 7å°æ—¶å®Œæˆ |

> âš ï¸ **æ³¨æ„**ï¼šå®é™…æ€§èƒ½å—è¡¨ç»“æ„ã€ç´¢å¼•å¤æ‚åº¦ã€ä¸šåŠ¡è´Ÿè½½ç­‰å¤šç§å› ç´ å½±å“

---

## 5. â±ï¸ å»¶è¿Ÿç›‘æ§æ£€æŸ¥


### 5.1 ä¸»ä»å»¶è¿Ÿç›‘æ§


**ä»€ä¹ˆæ˜¯ä¸»ä»å»¶è¿Ÿ**ï¼š
```
ä¸»ä»å¤åˆ¶å»¶è¿Ÿï¼š
ä¸»åº“å†™å…¥ â†’ binlogä¼ è¾“ â†’ ä»åº“åº”ç”¨ â†’ äº§ç”Ÿæ—¶é—´å·®
    â†‘                              â†‘
  å†™å…¥æ—¶é—´                      åº”ç”¨å®Œæˆæ—¶é—´
    |________________å»¶è¿Ÿæ—¶é—´_________________|
```

**å»¶è¿Ÿæ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æ–¹æ³•1ï¼šé€šè¿‡gh-ostæŸ¥çœ‹å»¶è¿Ÿ
echo "lag" | nc -U /tmp/gh-ost.sock

# æ–¹æ³•2ï¼šç›´æ¥æŸ¥è¯¢MySQLä»åº“çŠ¶æ€
mysql -h slave-host -e "SHOW SLAVE STATUS\G" | grep Seconds_Behind_Master

# æ–¹æ³•3ï¼šä½¿ç”¨pt-heartbeatå·¥å…·
pt-heartbeat --database test --monitor --print-master-server-id
```

### 5.2 å»¶è¿Ÿé˜ˆå€¼è®¾ç½®


**å»¶è¿Ÿé˜ˆå€¼é…ç½®**ï¼š
```bash
# æŸ¥çœ‹å½“å‰å»¶è¿Ÿé˜ˆå€¼
echo "max-lag-millis" | nc -U /tmp/gh-ost.sock

# åŠ¨æ€è°ƒæ•´å»¶è¿Ÿé˜ˆå€¼
echo "max-lag-millis=3000" | nc -U /tmp/gh-ost.sock  # è®¾ç½®ä¸º3ç§’

# ä¸åŒåœºæ™¯çš„å»ºè®®é˜ˆå€¼
åœºæ™¯ç±»å‹               å»ºè®®é˜ˆå€¼     è¯´æ˜
è¯»å†™åˆ†ç¦»ç¯å¢ƒ           1000ms      ä¿è¯è¯»ä¸€è‡´æ€§
çº¯ä¸»åº“ç¯å¢ƒ            5000ms      å¯ä»¥é€‚å½“å®½æ¾  
é«˜å³°æœŸæ‰§è¡Œ            500ms       é¿å…å½±å“ä¸šåŠ¡
ä½å³°æœŸæ‰§è¡Œ            10000ms     è¿½æ±‚æ‰§è¡Œæ•ˆç‡
```

### 5.3 å»¶è¿Ÿå¼‚å¸¸å¤„ç†


**å»¶è¿Ÿè¿‡é«˜çš„å¤„ç†ç­–ç•¥**ï¼š
```bash
# æ£€æŸ¥å»¶è¿Ÿå¼‚å¸¸åŸå› 
mysql -e "
SELECT 
    PROCESSLIST_ID,
    PROCESSLIST_USER,
    PROCESSLIST_HOST,
    PROCESSLIST_DB,
    PROCESSLIST_COMMAND,
    PROCESSLIST_TIME,
    PROCESSLIST_STATE,
    LEFT(PROCESSLIST_INFO, 100) as QUERY_TEXT
FROM INFORMATION_SCHEMA.PROCESSLIST 
WHERE PROCESSLIST_TIME > 5
ORDER BY PROCESSLIST_TIME DESC;
"

# ä¸´æ—¶é™ä½æ‰§è¡Œé€Ÿåº¦
echo "chunk-size=500" | nc -U /tmp/gh-ost.sock
echo "nice-ratio=1.0" | nc -U /tmp/gh-ost.sock
```

**å»¶è¿Ÿç›‘æ§å‘Šè­¦**ï¼š
```bash
#!/bin/bash
# lag_monitor.sh - å»¶è¿Ÿç›‘æ§å‘Šè­¦è„šæœ¬

SOCKET="/tmp/gh-ost.sock"
MAX_LAG_THRESHOLD=5000  # 5ç§’å‘Šè­¦é˜ˆå€¼

check_lag() {
    if [ -S "$SOCKET" ]; then
        local current_lag=$(echo "lag" | nc -U $SOCKET 2>/dev/null | grep -o '[0-9]\+')
        
        if [ "$current_lag" -gt "$MAX_LAG_THRESHOLD" ]; then
            echo "WARNING: Replication lag is ${current_lag}ms, exceeds threshold ${MAX_LAG_THRESHOLD}ms"
            
            # å‘é€å‘Šè­¦ (é‚®ä»¶/é’‰é’‰/å¾®ä¿¡ç­‰)
            # send_alert "gh-ost replication lag too high: ${current_lag}ms"
            
            # è‡ªåŠ¨é™é€Ÿ
            echo "chunk-size=200" | nc -U $SOCKET
            echo "Auto reduced chunk-size to 200 due to high lag"
        fi
    fi
}

while true; do
    check_lag
    sleep 60
done
```

---

## 6. ğŸ›ï¸ é€Ÿåº¦æ§åˆ¶ç›‘æ§


### 6.1 æ‰§è¡Œé€Ÿåº¦æŒ‡æ ‡


**é€Ÿåº¦ç›¸å…³æ¦‚å¿µ**ï¼š
```
æ‰§è¡Œé€Ÿåº¦ = æ¯ç§’å¤„ç†çš„æ•°æ®è¡Œæ•°
å½±å“å› ç´ ï¼š
â€¢ chunk-sizeï¼šæ¯æ‰¹å¤„ç†è¡Œæ•° â†‘
â€¢ nice-ratioï¼šCPUè®©æ­¥æ¯”ç‡ â†“  
â€¢ max-lag-millisï¼šå»¶è¿Ÿé˜ˆå€¼é™åˆ¶ â†“
â€¢ throttle-queryï¼šé™æµæŸ¥è¯¢æ¡ä»¶ â†“
```

**é€Ÿåº¦ç›‘æ§å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å½“å‰é€Ÿåº¦é…ç½®
echo "chunk-size" | nc -U /tmp/gh-ost.sock      # æ‰¹æ¬¡å¤§å°
echo "nice-ratio" | nc -U /tmp/gh-ost.sock      # CPUè®©æ­¥æ¯”ç‡  
echo "throttle-query" | nc -U /tmp/gh-ost.sock  # é™æµæŸ¥è¯¢

# å®æ—¶é€Ÿåº¦è®¡ç®—
#!/bin/bash
calculate_speed() {
    local prev_rows=0
    local prev_time=0
    
    while true; do
        local current_rows=$(echo "status" | nc -U /tmp/gh-ost.sock | grep -o 'Migrated rows: [0-9]\+' | grep -o '[0-9]\+')
        local current_time=$(date +%s)
        
        if [ $prev_time -gt 0 ]; then
            local time_diff=$((current_time - prev_time))
            local rows_diff=$((current_rows - prev_rows))
            local speed=$((rows_diff / time_diff))
            
            echo "$(date): Current speed: ${speed} rows/sec"
        fi
        
        prev_rows=$current_rows
        prev_time=$current_time
        sleep 60
    done
}
```

### 6.2 åŠ¨æ€é€Ÿåº¦è°ƒæ•´


**é€Ÿåº¦è°ƒæ•´ç­–ç•¥**ï¼š
```bash
# æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´é€Ÿåº¦
adjust_speed_by_load() {
    local load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    local cpu_cores=$(nproc)
    local load_ratio=$(echo "$load / $cpu_cores" | bc -l)
    
    if (( $(echo "$load_ratio > 0.8" | bc -l) )); then
        # é«˜è´Ÿè½½ï¼Œé™é€Ÿ
        echo "chunk-size=200" | nc -U /tmp/gh-ost.sock
        echo "nice-ratio=2.0" | nc -U /tmp/gh-ost.sock
        echo "High load detected, reducing speed"
        
    elif (( $(echo "$load_ratio < 0.3" | bc -l) )); then
        # ä½è´Ÿè½½ï¼Œæé€Ÿ
        echo "chunk-size=2000" | nc -U /tmp/gh-ost.sock  
        echo "nice-ratio=0" | nc -U /tmp/gh-ost.sock
        echo "Low load detected, increasing speed"
    fi
}
```

### 6.3 é™æµæœºåˆ¶ç›‘æ§


**é™æµæŸ¥è¯¢ç›‘æ§**ï¼š
```bash
# æŸ¥çœ‹å½“å‰é™æµæ¡ä»¶
echo "throttle-query" | nc -U /tmp/gh-ost.sock

# å¸¸è§é™æµæŸ¥è¯¢ç¤ºä¾‹ï¼š
# 1. åŸºäºè¿æ¥æ•°é™æµ
THROTTLE_QUERY="SELECT COUNT(*) FROM INFORMATION_SCHEMA.PROCESSLIST WHERE COMMAND='Query' AND TIME > 2"

# 2. åŸºäºCPUä½¿ç”¨ç‡é™æµ  
THROTTLE_QUERY="SELECT CASE WHEN SUBSTRING_INDEX(LOAD_AVERAGE,',',1) > 4.0 THEN 1 ELSE 0 END as should_throttle FROM (SELECT SUBSTRING_INDEX(SUBSTRING_INDEX(LOAD_AVERAGE,' ',-3),',',1) as LOAD_AVERAGE FROM (SELECT VARIABLE_VALUE as LOAD_AVERAGE FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME='Uptime') t) t2"

# 3. åŸºäºæ…¢æŸ¥è¯¢æ•°é‡é™æµ
THROTTLE_QUERY="SELECT COUNT(*) FROM INFORMATION_SCHEMA.PROCESSLIST WHERE TIME > 10"
```

---

## 7. âŒ é”™è¯¯ä¿¡æ¯æ£€æŸ¥


### 7.1 å¸¸è§é”™è¯¯ç±»å‹


**é”™è¯¯åˆ†ç±»åŠå¤„ç†**ï¼š

| é”™è¯¯ç±»å‹ | å…¸å‹ç—‡çŠ¶ | å¸¸è§åŸå›  | å¤„ç†æ–¹æ³• |
|---------|---------|---------|---------|
| **è¿æ¥é”™è¯¯** | `connection refused` | æ•°æ®åº“è¿æ¥é—®é¢˜ | æ£€æŸ¥è¿æ¥å‚æ•°å’Œæƒé™ |
| **æƒé™é”™è¯¯** | `access denied` | ç”¨æˆ·æƒé™ä¸è¶³ | æ£€æŸ¥SUPERã€REPLICATIONæƒé™ |
| **ç©ºé—´ä¸è¶³** | `disk full` | ç£ç›˜ç©ºé—´ä¸å¤Ÿ | æ¸…ç†ç©ºé—´æˆ–æ›´æ¢ç›®å½• |
| **è¡¨é”å®š** | `table locked` | è¡¨è¢«å…¶ä»–æ“ä½œé”å®š | ç­‰å¾…æˆ–kill blockingæŸ¥è¯¢ |

### 7.2 é”™è¯¯æ—¥å¿—åˆ†æ


**æ—¥å¿—æ–‡ä»¶ä½ç½®**ï¼š
```bash
# gh-osté”™è¯¯æ—¥å¿—é€šå¸¸è¾“å‡ºåˆ°ï¼š
/var/log/gh-ost.log                    # æŒ‡å®šçš„æ—¥å¿—æ–‡ä»¶
/tmp/gh-ost.log                        # é»˜è®¤ä¸´æ—¶æ—¥å¿—
standard error output                  # æ ‡å‡†é”™è¯¯è¾“å‡º

# æŸ¥çœ‹æœ€æ–°é”™è¯¯
tail -f /var/log/gh-ost.log | grep -i error

# åˆ†æé”™è¯¯æ¨¡å¼  
grep -i "error\|failed\|panic" /var/log/gh-ost.log | tail -20
```

**å…¸å‹é”™è¯¯ä¿¡æ¯åˆ†æ**ï¼š
```bash
# æƒé™ç›¸å…³é”™è¯¯
2023-09-11 15:30:21 ERROR connection test failed. Error 1227: Access denied

# ç©ºé—´ä¸è¶³é”™è¯¯  
2023-09-11 15:30:21 ERROR failed to create ghost table: Error 1114: Table is full

# ä¸»ä»å»¶è¿Ÿè¿‡é«˜
2023-09-11 15:30:21 INFO lag is 6.2s, > max-lag of 1.5s, throttling

# è¡¨ç»“æ„ä¸å…¼å®¹
2023-09-11 15:30:21 ERROR Unsupported: table has foreign keys
```

### 7.3 é”™è¯¯é¢„è­¦è„šæœ¬


**è‡ªåŠ¨é”™è¯¯æ£€æµ‹**ï¼š
```bash
#!/bin/bash
# error_monitor.sh - é”™è¯¯ç›‘æ§è„šæœ¬

LOG_FILE="/var/log/gh-ost.log"
ALERT_FILE="/tmp/gh-ost-alerts.log"

monitor_errors() {
    # ç›‘æ§è‡´å‘½é”™è¯¯
    tail -f $LOG_FILE | while read line; do
        echo "$line" | grep -qiE "error|failed|panic|fatal" 
        if [ $? -eq 0 ]; then
            local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            echo "$timestamp: $line" >> $ALERT_FILE
            
            # å‘é€å‘Šè­¦
            echo "gh-ost ERROR detected: $line" | mail -s "gh-ost Alert" admin@company.com
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦æš‚åœæ‰§è¡Œ
            echo "$line" | grep -qiE "fatal|panic"
            if [ $? -eq 0 ]; then
                echo "postpone" | nc -U /tmp/gh-ost.sock
                echo "CRITICAL: gh-ost execution postponed due to fatal error"
            fi
        fi
    done
}

monitor_errors &
```

---

## 8. ğŸ“‹ æ—¥å¿—æ–‡ä»¶åˆ†æ


### 8.1 æ—¥å¿—æ–‡ä»¶ç»“æ„


**gh-ostæ—¥å¿—æ ¼å¼**ï¼š
```
æ—¶é—´æˆ³ [çº§åˆ«] æ¶ˆæ¯å†…å®¹
2023-09-11 15:30:21 [info] binlog coordinates: mysql-bin.000123:45678901
2023-09-11 15:30:22 [info] Migrated rows: 1234567, ETA: 2h34m12s  
2023-09-11 15:30:23 [warn] lag is 2.1s, > max-lag of 1.5s
```

**æ—¥å¿—çº§åˆ«è¯´æ˜**ï¼š
- `[info]`ï¼š**ä¿¡æ¯çº§åˆ«** - æ­£å¸¸æ‰§è¡Œä¿¡æ¯
- `[warn]`ï¼š**è­¦å‘Šçº§åˆ«** - éœ€è¦æ³¨æ„ä½†ä¸å½±å“æ‰§è¡Œ
- `[error]`ï¼š**é”™è¯¯çº§åˆ«** - æ‰§è¡Œå¼‚å¸¸ï¼Œå¯èƒ½å½±å“ç»“æœ
- `[fatal]`ï¼š**è‡´å‘½çº§åˆ«** - ä¸¥é‡é”™è¯¯ï¼Œå¯¼è‡´æ‰§è¡Œä¸­æ­¢

### 8.2 å…³é”®æ—¥å¿—ä¿¡æ¯æå–


**æ—¥å¿—åˆ†æè„šæœ¬**ï¼š
```bash
#!/bin/bash  
# log_analyzer.sh - æ—¥å¿—åˆ†æå·¥å…·

LOG_FILE="/var/log/gh-ost.log"

analyze_progress() {
    echo "=== æ‰§è¡Œè¿›åº¦åˆ†æ ==="
    grep "Migrated rows" $LOG_FILE | tail -10 | while read line; do
        local timestamp=$(echo "$line" | awk '{print $1, $2}')
        local progress=$(echo "$line" | grep -o '[0-9.]\+%')
        local eta=$(echo "$line" | grep -o 'ETA: [^,]*')
        echo "$timestamp - Progress: $progress, $eta"
    done
}

analyze_performance() {
    echo "=== æ€§èƒ½åˆ†æ ==="
    # è®¡ç®—å¹³å‡å¤„ç†é€Ÿåº¦
    local start_time=$(head -1 $LOG_FILE | awk '{print $1, $2}')
    local end_time=$(tail -1 $LOG_FILE | awk '{print $1, $2}')
    local total_rows=$(grep "Migrated rows" $LOG_FILE | tail -1 | grep -o 'Migrated rows: [0-9]\+' | grep -o '[0-9]\+')
    
    echo "Start time: $start_time"  
    echo "Current time: $end_time"
    echo "Total migrated rows: $total_rows"
}

analyze_issues() {
    echo "=== é—®é¢˜åˆ†æ ==="
    echo "Warnings:"
    grep -i "warn" $LOG_FILE | tail -5
    
    echo "Errors:"  
    grep -i "error" $LOG_FILE | tail -5
    
    echo "Throttling events:"
    grep -i "throttling\|lag" $LOG_FILE | tail -5
}

# æ‰§è¡Œåˆ†æ
analyze_progress
echo ""
analyze_performance  
echo ""
analyze_issues
```

### 8.3 æ—¥å¿—è½®è½¬å’Œæ¸…ç†


**æ—¥å¿—ç®¡ç†ç­–ç•¥**ï¼š
```bash
# æ—¥å¿—è½®è½¬é…ç½® (/etc/logrotate.d/gh-ost)
/var/log/gh-ost*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 mysql mysql
    postrotate
        killall -USR1 gh-ost 2>/dev/null || true
    endscript
}

# æ‰‹åŠ¨æ¸…ç†æ—§æ—¥å¿—
find /var/log -name "gh-ost*.log*" -mtime +7 -delete
```

---

## 9. ğŸ“º å®æ—¶çŠ¶æ€æ˜¾ç¤º


### 9.1 å‘½ä»¤è¡ŒçŠ¶æ€é¢æ¿


**ç®€å•çŠ¶æ€æ˜¾ç¤º**ï¼š
```bash
#!/bin/bash
# status_dashboard.sh - ç®€å•çŠ¶æ€é¢æ¿

SOCKET="/tmp/gh-ost.sock"

show_dashboard() {
    clear
    echo "======================================="
    echo "         gh-ost å®æ—¶çŠ¶æ€é¢æ¿          "  
    echo "======================================="
    echo "æ›´æ–°æ—¶é—´: $(date)"
    echo ""
    
    if [ -S "$SOCKET" ]; then
        echo "--- æ‰§è¡Œè¿›åº¦ ---"
        echo "status" | nc -U $SOCKET | grep -E "Migrated|ETA"
        echo ""
        
        echo "--- é…ç½®å‚æ•° ---"
        echo -n "Chunk Size: "
        echo "chunk-size" | nc -U $SOCKET
        echo -n "Max Lag: "  
        echo "max-lag-millis" | nc -U $SOCKET
        echo ""
        
        echo "--- ç³»ç»Ÿè´Ÿè½½ ---"
        uptime
        echo ""
        
        echo "--- MySQLçŠ¶æ€ ---"
        mysql -e "SHOW PROCESSLIST" | grep -c "gh-ost" | awk '{print "Active Connections: " $1}'
        
    else
        echo "gh-ost è¿›ç¨‹æœªè¿è¡Œæˆ–å·²å®Œæˆ"
    fi
    
    echo "======================================="
    echo "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
}

# æ¯5ç§’æ›´æ–°ä¸€æ¬¡
while true; do
    show_dashboard
    sleep 5
done
```

### 9.2 WebçŠ¶æ€é¢æ¿


**ç®€å•HTTPçŠ¶æ€æœåŠ¡**ï¼š
```bash
#!/bin/bash
# web_status.sh - ç®€å•WebçŠ¶æ€é¡µé¢

PORT=8080
SOCKET="/tmp/gh-ost.sock"

generate_html() {
    cat << EOF
<!DOCTYPE html>
<html>
<head>
    <title>gh-ost Status Monitor</title>
    <meta http-equiv="refresh" content="10">
    <style>
        body { font-family: monospace; margin: 20px; }
        .status-box { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .progress { background: #f0f0f0; height: 20px; border-radius: 3px; }
        .progress-bar { background: #4CAF50; height: 100%; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>gh-ost Status Monitor</h1>
    <div class="status-box">
        <h3>Current Status</h3>
        <pre>$(echo "status" | nc -U $SOCKET 2>/dev/null || echo "gh-ost not running")</pre>
    </div>
    
    <div class="status-box">
        <h3>System Load</h3>
        <pre>$(uptime)</pre>
    </div>
    
    <div class="status-box">
        <h3>Last Updated</h3>
        <pre>$(date)</pre>
    </div>
</body>
</html>
EOF
}

# å¯åŠ¨ç®€å•HTTPæœåŠ¡
while true; do
    echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n$(generate_html)" | nc -l -p $PORT -q 1
done
```

---

## 10. ğŸ”§ ç›‘æ§è„šæœ¬å¼€å‘


### 10.1 ç»¼åˆç›‘æ§è„šæœ¬


**å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
#!/bin/bash
# gh-ost_monitor.sh - ç»¼åˆç›‘æ§è„šæœ¬

# é…ç½®å‚æ•°
SOCKET="/tmp/gh-ost.sock"
LOG_FILE="/var/log/gh-ost-monitor.log"  
PID_FILE="/var/run/gh-ost-monitor.pid"
ALERT_THRESHOLD_LAG=5000        # å»¶è¿Ÿå‘Šè­¦é˜ˆå€¼(ms)
ALERT_THRESHOLD_LOAD=4.0        # è´Ÿè½½å‘Šè­¦é˜ˆå€¼
CHECK_INTERVAL=30               # æ£€æŸ¥é—´éš”(ç§’)

# æ—¥å¿—å‡½æ•°
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" | tee -a $LOG_FILE
}

# æ£€æŸ¥gh-ostçŠ¶æ€
check_ghost_status() {
    if [ ! -S "$SOCKET" ]; then
        log_message "WARN" "gh-ost socket not found, process may be completed or failed"
        return 1
    fi
    
    local status=$(echo "status" | nc -U $SOCKET 2>/dev/null)
    if [ -z "$status" ]; then
        log_message "ERROR" "Failed to get status from gh-ost"
        return 1
    fi
    
    echo "$status"
    return 0
}

# æ£€æŸ¥ä¸»ä»å»¶è¿Ÿ
check_replication_lag() {
    if [ -S "$SOCKET" ]; then
        local lag=$(echo "lag" | nc -U $SOCKET 2>/dev/null | grep -o '[0-9]\+')
        if [ -n "$lag" ] && [ "$lag" -gt "$ALERT_THRESHOLD_LAG" ]; then
            log_message "ALERT" "Replication lag too high: ${lag}ms (threshold: ${ALERT_THRESHOLD_LAG}ms)"
            
            # è‡ªåŠ¨è°ƒæ•´å‚æ•°
            echo "chunk-size=200" | nc -U $SOCKET
            echo "nice-ratio=1.0" | nc -U $SOCKET
            log_message "INFO" "Auto-adjusted parameters due to high lag"
        fi
    fi
}

# æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½  
check_system_load() {
    local load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    local threshold=$(echo "$ALERT_THRESHOLD_LOAD" | bc)
    
    if (( $(echo "$load > $threshold" | bc -l) )); then
        log_message "ALERT" "System load too high: $load (threshold: $threshold)"
        
        # é™ä½æ‰§è¡Œé€Ÿåº¦
        if [ -S "$SOCKET" ]; then
            echo "chunk-size=100" | nc -U $SOCKET  
            echo "nice-ratio=2.0" | nc -U $SOCKET
            log_message "INFO" "Reduced execution speed due to high load"
        fi
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
monitor_loop() {
    log_message "INFO" "Starting gh-ost monitoring service"
    
    while true; do
        # æ£€æŸ¥åŸºæœ¬çŠ¶æ€
        if check_ghost_status > /dev/null 2>&1; then
            check_replication_lag
            check_system_load
            
            # è®°å½•å½“å‰çŠ¶æ€
            local progress=$(echo "status" | nc -U $SOCKET | grep "Migrated rows" | grep -o '[0-9.]\+%')
            if [ -n "$progress" ]; then
                log_message "INFO" "Current progress: $progress"
            fi
        else
            log_message "INFO" "gh-ost process not running, stopping monitor"
            break
        fi
        
        sleep $CHECK_INTERVAL
    done
}

# å¯åŠ¨ç›‘æ§
case "$1" in
    start)
        if [ -f "$PID_FILE" ]; then
            echo "Monitor already running (PID: $(cat $PID_FILE))"
            exit 1
        fi
        
        nohup $0 run > /dev/null 2>&1 &
        echo $! > $PID_FILE
        echo "Monitor started (PID: $!)"
        ;;
        
    stop)  
        if [ -f "$PID_FILE" ]; then
            kill $(cat $PID_FILE)
            rm -f $PID_FILE
            echo "Monitor stopped"
        else
            echo "Monitor not running"
        fi
        ;;
        
    run)
        monitor_loop
        rm -f $PID_FILE
        ;;
        
    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;
esac
```

### 10.2 ç›‘æ§æ•°æ®æ”¶é›†


**æ•°æ®æ”¶é›†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# data_collector.sh - ç›‘æ§æ•°æ®æ”¶é›†

DATA_DIR="/var/lib/gh-ost-monitoring"
SOCKET="/tmp/gh-ost.sock"

mkdir -p $DATA_DIR

collect_metrics() {
    local timestamp=$(date +%s)
    local date_str=$(date '+%Y-%m-%d %H:%M:%S')
    
    # åŸºç¡€æŒ‡æ ‡æ–‡ä»¶
    local metrics_file="$DATA_DIR/metrics-$(date +%Y%m%d).csv"
    
    # CSVå¤´éƒ¨ï¼ˆå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼‰
    if [ ! -f "$metrics_file" ]; then
        echo "timestamp,datetime,migrated_rows,progress_pct,eta_seconds,lag_ms,chunk_size,load_avg" > $metrics_file
    fi
    
    if [ -S "$SOCKET" ]; then
        # è·å–çŠ¶æ€ä¿¡æ¯
        local status=$(echo "status" | nc -U $SOCKET)
        local migrated_rows=$(echo "$status" | grep -o 'Migrated rows: [0-9]\+' | grep -o '[0-9]\+')
        local progress_pct=$(echo "$status" | grep -o '[0-9.]\+%' | tr -d '%')
        local eta=$(echo "$status" | grep -o 'ETA: [^,]*' | awk '{print $2}')
        
        # è·å–å…¶ä»–æŒ‡æ ‡  
        local lag=$(echo "lag" | nc -U $SOCKET | grep -o '[0-9]\+')
        local chunk_size=$(echo "chunk-size" | nc -U $SOCKET)
        local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
        
        # å†™å…¥CSV
        echo "$timestamp,$date_str,$migrated_rows,$progress_pct,$eta,$lag,$chunk_size,$load_avg" >> $metrics_file
        
        echo "Metrics collected: $date_str"
    else
        echo "gh-ost not running, skipping collection"
    fi
}

# å®šæœŸæ”¶é›†æ•°æ®
while true; do
    collect_metrics
    sleep 60  # æ¯åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡
done
```

---

## 11. ğŸš¨ å‘Šè­¦æœºåˆ¶è®¾ç½®


### 11.1 å‘Šè­¦è§„åˆ™é…ç½®


**å‘Šè­¦æ¡ä»¶å®šä¹‰**ï¼š
```bash
# å‘Šè­¦è§„åˆ™é…ç½®æ–‡ä»¶ (alert_rules.conf)
cat > /etc/gh-ost/alert_rules.conf << 'EOF'
# å»¶è¿Ÿå‘Šè­¦
ALERT_LAG_THRESHOLD=5000          # ä¸»ä»å»¶è¿Ÿè¶…è¿‡5ç§’
ALERT_LAG_ENABLED=true

# è´Ÿè½½å‘Šè­¦  
ALERT_LOAD_THRESHOLD=4.0          # ç³»ç»Ÿè´Ÿè½½è¶…è¿‡4.0
ALERT_LOAD_ENABLED=true

# é”™è¯¯å‘Šè­¦
ALERT_ERROR_ENABLED=true          # å‡ºç°ERRORæ—¥å¿—

# è¿›åº¦å‘Šè­¦
ALERT_PROGRESS_STUCK=600          # è¿›åº¦è¶…è¿‡10åˆ†é’Ÿæ— å˜åŒ–
ALERT_PROGRESS_ENABLED=true

# å‘Šè­¦é€šé“é…ç½®
ALERT_EMAIL=admin@company.com     # é‚®ä»¶å‘Šè­¦
ALERT_WEBHOOK=http://webhook.url  # Webhookå‘Šè­¦
ALERT_SLACK_CHANNEL=#ops          # Slacké€šé“
EOF
```

### 11.2 å‘Šè­¦å‘é€å®ç°


**å¤šé€šé“å‘Šè­¦è„šæœ¬**ï¼š
```bash
#!/bin/bash  
# alert_sender.sh - å‘Šè­¦å‘é€è„šæœ¬

source /etc/gh-ost/alert_rules.conf

# å‘é€é‚®ä»¶å‘Šè­¦
send_email_alert() {
    local subject=$1
    local message=$2
    
    if [ "$ALERT_EMAIL_ENABLED" = "true" ]; then
        echo "$message" | mail -s "$subject" $ALERT_EMAIL
        echo "Email alert sent to $ALERT_EMAIL"
    fi
}

# å‘é€Webhookå‘Šè­¦
send_webhook_alert() {
    local title=$1  
    local message=$2
    local level=$3
    
    if [ -n "$ALERT_WEBHOOK" ]; then
        curl -X POST $ALERT_WEBHOOK \
             -H "Content-Type: application/json" \
             -d "{
                 \"title\": \"$title\",
                 \"message\": \"$message\", 
                 \"level\": \"$level\",
                 \"timestamp\": \"$(date --iso-8601=seconds)\"
             }"
        echo "Webhook alert sent"
    fi
}

# å‘é€é’‰é’‰å‘Šè­¦  
send_dingtalk_alert() {
    local message=$1
    local webhook_url="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
    
    curl -X POST $webhook_url \
         -H "Content-Type: application/json" \
         -d "{
             \"msgtype\": \"text\",
             \"text\": {
                 \"content\": \"gh-ostå‘Šè­¦: $message\"
             }
         }"
}

# ç»¼åˆå‘Šè­¦å‘é€  
send_alert() {
    local level=$1      # INFO/WARN/ERROR/CRITICAL
    local title=$2      # å‘Šè­¦æ ‡é¢˜
    local message=$3    # å‘Šè­¦å†…å®¹
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local full_message="[$timestamp] [$level] $title: $message"
    
    echo "$full_message"
    
    # æ ¹æ®çº§åˆ«å‘é€ä¸åŒé€šé“å‘Šè­¦
    case $level in
        "CRITICAL"|"ERROR")
            send_email_alert "$title" "$full_message"
            send_webhook_alert "$title" "$full_message" "$level"
            send_dingtalk_alert "$full_message"
            ;;
        "WARN")
            send_webhook_alert "$title" "$full_message" "$level" 
            ;;
        "INFO")
            # ä»…è®°å½•æ—¥å¿—ï¼Œä¸å‘é€å‘Šè­¦
            ;;
    esac
}

# ç¤ºä¾‹è°ƒç”¨
# send_alert "ERROR" "Replication Lag High" "Current lag: 8000ms, threshold: 5000ms"
```

### 11.3 æ™ºèƒ½å‘Šè­¦ç­–ç•¥


**å‘Šè­¦èšåˆå’ŒæŠ‘åˆ¶**ï¼š
```bash
#!/bin/bash
# smart_alerting.sh - æ™ºèƒ½å‘Šè­¦ç­–ç•¥

ALERT_STATE_FILE="/tmp/gh-ost-alert-state"

# å‘Šè­¦çŠ¶æ€ç®¡ç†
update_alert_state() {
    local alert_type=$1
    local status=$2  # firing/resolved  
    local timestamp=$(date +%s)
    
    # æ›´æ–°å‘Šè­¦çŠ¶æ€æ–‡ä»¶
    grep -v "^$alert_type:" $ALERT_STATE_FILE > /tmp/alert_temp 2>/dev/null
    echo "$alert_type:$status:$timestamp" >> /tmp/alert_temp
    mv /tmp/alert_temp $ALERT_STATE_FILE
}

# æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€å‘Šè­¦
should_send_alert() {
    local alert_type=$1
    local current_state=$2
    local suppress_duration=300  # 5åˆ†é’ŸæŠ‘åˆ¶æœŸ
    
    local last_alert=$(grep "^$alert_type:" $ALERT_STATE_FILE 2>/dev/null)
    if [ -n "$last_alert" ]; then
        local last_status=$(echo "$last_alert" | cut -d: -f2)
        local last_time=$(echo "$last_alert" | cut -d: -f3)
        local current_time=$(date +%s)
        
        # å¦‚æœçŠ¶æ€æ²¡æœ‰å˜åŒ–ä¸”åœ¨æŠ‘åˆ¶æœŸå†…ï¼Œä¸å‘é€å‘Šè­¦
        if [ "$last_status" = "$current_state" ] && 
           [ $((current_time - last_time)) -lt $suppress_duration ]; then
            return 1  # ä¸å‘é€
        fi
    fi
    
    return 0  # å‘é€å‘Šè­¦
}

# æ™ºèƒ½å‘Šè­¦æ£€æŸ¥
smart_alert_check() {
    # æ£€æŸ¥ä¸»ä»å»¶è¿Ÿ
    if [ -S "/tmp/gh-ost.sock" ]; then
        local lag=$(echo "lag" | nc -U /tmp/gh-ost.sock | grep -o '[0-9]\+')
        
        if [ -n "$lag" ] && [ "$lag" -gt 5000 ]; then
            if should_send_alert "replication_lag" "firing"; then
                send_alert "WARN" "High Replication Lag" "Current lag: ${lag}ms"
                update_alert_state "replication_lag" "firing"
            fi
        else
            if should_send_alert "replication_lag" "resolved"; then
                send_alert "INFO" "Replication Lag Recovered" "Current lag: ${lag}ms"  
                update_alert_state "replication_lag" "resolved"
            fi
        fi
    fi
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„ç›‘æ§è¦ç‚¹


```
ğŸ”¸ åŸºç¡€ç›‘æ§ï¼šè¿›åº¦ã€çŠ¶æ€ã€é…ç½®å‚æ•°çš„å®æ—¶æŸ¥è¯¢
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šååé‡ã€å»¶è¿Ÿã€èµ„æºä½¿ç”¨ç‡çš„æŒç»­è·Ÿè¸ª  
ğŸ”¸ å¼‚å¸¸ç›‘æ§ï¼šé”™è¯¯æ—¥å¿—ã€å‘Šè­¦æœºåˆ¶ã€è‡ªåŠ¨å¤„ç†ç­–ç•¥
ğŸ”¸ çŠ¶æ€å±•ç¤ºï¼šå‘½ä»¤è¡Œé¢æ¿ã€Webç•Œé¢ã€ç›‘æ§è„šæœ¬å¼€å‘
```

### 12.2 ç›‘æ§æœ€ä½³å®è·µ


**ğŸ”¹ ç›‘æ§ç­–ç•¥åˆ†å±‚**ï¼š
```
å®æ—¶ç›‘æ§å±‚ï¼š
â€¢ Socketå‘½ä»¤æŸ¥è¯¢çŠ¶æ€
â€¢ å…³é”®æŒ‡æ ‡å®æ—¶æ˜¾ç¤º
â€¢ å¼‚å¸¸æƒ…å†µç«‹å³å‘Šè­¦

å†å²æ•°æ®å±‚ï¼š  
â€¢ æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–å­˜å‚¨
â€¢ æ€§èƒ½æ•°æ®å®šæœŸæ”¶é›†
â€¢ è¶‹åŠ¿åˆ†æå’ŒæŠ¥è¡¨ç”Ÿæˆ

è‡ªåŠ¨åŒ–å±‚ï¼š
â€¢ æ™ºèƒ½å‘Šè­¦å’ŒæŠ‘åˆ¶
â€¢ è‡ªåŠ¨å‚æ•°è°ƒæ•´
â€¢ æ•…éšœè‡ªæ„ˆæœºåˆ¶
```

**ğŸ”¹ å‘Šè­¦æœºåˆ¶è®¾è®¡**ï¼š
```
å‘Šè­¦çº§åˆ«ï¼š
â€¢ INFOï¼šæ­£å¸¸ä¿¡æ¯è®°å½•
â€¢ WARNï¼šéœ€è¦å…³æ³¨ä½†ä¸ç´§æ€¥
â€¢ ERRORï¼šéœ€è¦äººå·¥ä»‹å…¥å¤„ç†  
â€¢ CRITICALï¼šéœ€è¦ç«‹å³å¤„ç†

å‘Šè­¦é€šé“ï¼š
â€¢ é‚®ä»¶ï¼šé€‚åˆéç´§æ€¥é€šçŸ¥
â€¢ çŸ­ä¿¡ï¼šé€‚åˆç´§æ€¥å‘Šè­¦
â€¢ é’‰é’‰/å¾®ä¿¡ï¼šé€‚åˆå›¢é˜Ÿåä½œ
â€¢ Webhookï¼šé€‚åˆç³»ç»Ÿé›†æˆ
```

### 12.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ç›‘æ§éƒ¨ç½²å»ºè®®**ï¼š
- âœ… **ç”Ÿäº§ç¯å¢ƒ**ï¼šå¿…é¡»éƒ¨ç½²å®Œæ•´ç›‘æ§ç³»ç»Ÿ
- âœ… **æµ‹è¯•ç¯å¢ƒ**ï¼šè‡³å°‘éƒ¨ç½²åŸºç¡€è¿›åº¦ç›‘æ§  
- âœ… **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥ä½¿ç”¨ç®€åŒ–çš„å‘½ä»¤è¡Œç›‘æ§
- âš ï¸ **ç›‘æ§æœ¬èº«**ï¼šé¿å…ç›‘æ§ç³»ç»Ÿå½±å“gh-ostæ€§èƒ½

**å¸¸è§ç›‘æ§é—®é¢˜**ï¼š
```
Socketè¿æ¥å¤±è´¥ï¼š
â†’ æ£€æŸ¥socketæ–‡ä»¶è·¯å¾„å’Œæƒé™
â†’ ç¡®è®¤gh-ostè¿›ç¨‹æ­£åœ¨è¿è¡Œ

ç›‘æ§è„šæœ¬å ç”¨èµ„æºï¼š  
â†’ è°ƒæ•´ç›‘æ§é¢‘ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹
â†’ ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡

å‘Šè­¦é£æš´é—®é¢˜ï¼š
â†’ å®æ–½å‘Šè­¦æŠ‘åˆ¶å’Œèšåˆç­–ç•¥
â†’ è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
```

**æ ¸å¿ƒè®°ä½ç‚¹**ï¼š
- ç›‘æ§æ˜¯DDLæ“ä½œå®‰å…¨çš„é‡è¦ä¿éšœ
- Socketé€šä¿¡æ˜¯è·å–å®æ—¶çŠ¶æ€çš„æœ€ä½³æ–¹å¼
- æ—¥å¿—åˆ†æèƒ½å¤Ÿå¸®åŠ©ä¼˜åŒ–æ‰§è¡Œç­–ç•¥  
- æ™ºèƒ½å‘Šè­¦æ¯”ç®€å•é˜ˆå€¼å‘Šè­¦æ›´å®ç”¨
- ç›‘æ§ç³»ç»Ÿæœ¬èº«ä¸èƒ½å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½