---
title: 15ã€gh-ostæµ‹è¯•éªŒè¯
---
## ğŸ“š ç›®å½•

1. [gh-ostæµ‹è¯•æ¦‚è¿°](#1-gh-ostæµ‹è¯•æ¦‚è¿°)
2. [test-on-replicaæµ‹è¯•æ¨¡å¼](#2-test-on-replicaæµ‹è¯•æ¨¡å¼)
3. [æ•°æ®ä¸€è‡´æ€§éªŒè¯](#3-æ•°æ®ä¸€è‡´æ€§éªŒè¯)
4. [æ€§èƒ½å½±å“æµ‹è¯•](#4-æ€§èƒ½å½±å“æµ‹è¯•)
5. [å›æ»šåŠŸèƒ½æµ‹è¯•](#5-å›æ»šåŠŸèƒ½æµ‹è¯•)
6. [è¾¹ç•Œæ¡ä»¶æµ‹è¯•](#6-è¾¹ç•Œæ¡ä»¶æµ‹è¯•)
7. [å‹åŠ›æµ‹è¯•æ‰§è¡Œ](#7-å‹åŠ›æµ‹è¯•æ‰§è¡Œ)
8. [æµ‹è¯•ç¯å¢ƒå‡†å¤‡](#8-æµ‹è¯•ç¯å¢ƒå‡†å¤‡)
9. [æµ‹è¯•ç”¨ä¾‹è®¾è®¡](#9-æµ‹è¯•ç”¨ä¾‹è®¾è®¡)
10. [æµ‹è¯•ç»“æœåˆ†æ](#10-æµ‹è¯•ç»“æœåˆ†æ)
11. [ç”Ÿäº§å‰éªŒè¯](#11-ç”Ÿäº§å‰éªŒè¯)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” gh-ostæµ‹è¯•æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆè¦æµ‹è¯•gh-ost


**æµ‹è¯•çš„å¿…è¦æ€§**ï¼š
```
ç”Ÿäº§ç¯å¢ƒé£é™©ï¼š
â€¢ DDLæ“ä½œå½±å“ä¸šåŠ¡å¯ç”¨æ€§
â€¢ æ•°æ®å˜æ›´å¯èƒ½å¯¼è‡´ä¸ä¸€è‡´
â€¢ æ€§èƒ½å½±å“éš¾ä»¥é¢„ä¼°
â€¢ å›æ»šå›°éš¾ä¸”è€—æ—¶

æµ‹è¯•çš„ä»·å€¼ï¼š
â€¢ éªŒè¯æ“ä½œå®‰å…¨æ€§
â€¢ è¯„ä¼°æ€§èƒ½å½±å“
â€¢ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
â€¢ éªŒè¯å›æ»šèƒ½åŠ›
```

### 1.2 æµ‹è¯•ç›®æ ‡ä¸åŸåˆ™


**ğŸ¯ æµ‹è¯•ç›®æ ‡**
```
å®‰å…¨æ€§éªŒè¯ï¼š
âœ“ ç¡®ä¿DDLæ“ä½œä¸å½±å“ä¸»åº“
âœ“ éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§
âœ“ ç¡®è®¤æ“ä½œå¯ä¸­æ–­å’Œå›æ»š

æ€§èƒ½è¯„ä¼°ï¼š
âœ“ æµ‹é‡å¯¹ä¸»åº“æ€§èƒ½çš„å½±å“
âœ“ è¯„ä¼°DDLæ“ä½œè€—æ—¶
âœ“ åˆ†æèµ„æºæ¶ˆè€—æƒ…å†µ

åŠŸèƒ½éªŒè¯ï¼š
âœ“ éªŒè¯å„ç§DDLæ“ä½œ
âœ“ æµ‹è¯•ä¸åŒæ•°æ®ç±»å‹
âœ“ ç¡®è®¤è¾¹ç•Œæ¡ä»¶å¤„ç†
```

### 1.3 æµ‹è¯•æµç¨‹æ¦‚è§ˆ


```
æµ‹è¯•å‡†å¤‡é˜¶æ®µ
    â†“
ç¯å¢ƒæ­å»ºä¸é…ç½®
    â†“
åŠŸèƒ½æµ‹è¯•æ‰§è¡Œ
    â†“
æ€§èƒ½æµ‹è¯•æ‰§è¡Œ
    â†“
å‹åŠ›æµ‹è¯•æ‰§è¡Œ
    â†“
ç»“æœåˆ†æä¸æ€»ç»“
    â†“
ç”Ÿäº§å‰æœ€ç»ˆéªŒè¯
```

---

## 2. ğŸ§ª test-on-replicaæµ‹è¯•æ¨¡å¼


### 2.1 test-on-replicaæ¨¡å¼åŸç†


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
```
ä»€ä¹ˆæ˜¯test-on-replicaï¼š
â€¢ åœ¨ä»åº“ä¸Šæ‰§è¡Œå®Œæ•´çš„DDLè¿‡ç¨‹
â€¢ ä¸å½±å“ä¸»åº“çš„æ­£å¸¸è¿è¡Œ
â€¢ å¯ä»¥éªŒè¯DDLæ“ä½œçš„å®Œæ•´æ€§
â€¢ æµ‹è¯•å®Œæˆåè‡ªåŠ¨æ¸…ç†
```

**å·¥ä½œæœºåˆ¶**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ä¸»åº“     â”‚â”€â”€â”€â”€â”‚    ä»åº“     â”‚â”€â”€â”€â”€â”‚  ghostè¡¨    â”‚
â”‚  Master     â”‚    â”‚  Replica    â”‚    â”‚ _table_gho  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   åœ¨ä»åº“æ‰§è¡Œæµ‹è¯•
                   ä¸å½±å“ä¸»åº“ä¸šåŠ¡
```

### 2.2 test-on-replicaé…ç½®


**ğŸ”§ åŸºç¡€é…ç½®å‘½ä»¤**
```bash
gh-ost \
  --host=replica-host \
  --port=3306 \
  --user=gh_ost_user \
  --password=password \
  --database=test_db \
  --table=users \
  --alter="ADD COLUMN age INT" \
  --test-on-replica \
  --execute
```

**âš ï¸ é‡è¦å‚æ•°è¯´æ˜**
```bash
--test-on-replica     # å¯ç”¨æµ‹è¯•æ¨¡å¼
--execute            # å®é™…æ‰§è¡Œï¼ˆä¸åŠ åˆ™ä¸ºç©ºè·‘ï¼‰
--max-load="30"      # è´Ÿè½½æ§åˆ¶
--critical-load="80" # ä¸´ç•Œè´Ÿè½½
--chunk-size=1000    # æ•°æ®å—å¤§å°
```

### 2.3 æµ‹è¯•æ¨¡å¼ä¼˜åŠ¿


**âœ… ä¸»è¦ä¼˜åŠ¿**
```
é£é™©æ§åˆ¶ï¼š
â€¢ å®Œå…¨éš”ç¦»ä¸»åº“
â€¢ çœŸå®æ¨¡æ‹ŸDDLè¿‡ç¨‹
â€¢ å¯ä»¥åå¤æµ‹è¯•
â€¢ å¤±è´¥ä¸å½±å“ç”Ÿäº§

æµ‹è¯•å…¨é¢æ€§ï¼š
â€¢ éªŒè¯å®Œæ•´DDLæµç¨‹
â€¢ æµ‹è¯•æ•°æ®è¿ç§»è¿‡ç¨‹
â€¢ éªŒè¯ç´¢å¼•åˆ›å»º
â€¢ æ£€æŸ¥çº¦æŸå¤„ç†
```

**ğŸ“Š å¯¹æ¯”åˆ†æ**
| æµ‹è¯•æ–¹å¼ | **é£é™©çº§åˆ«** | **çœŸå®æ€§** | **å¯é‡å¤æ€§** | **èµ„æºæ¶ˆè€—** |
|---------|-------------|-----------|-------------|-------------|
| **ç›´æ¥ç”Ÿäº§æµ‹è¯•** | `æé«˜` | `100%` | `ä½` | `é«˜` |
| **test-on-replica** | `æä½` | `95%` | `é«˜` | `ä¸­` |
| **å¼€å‘ç¯å¢ƒæµ‹è¯•** | `æ— ` | `70%` | `é«˜` | `ä½` |

---

## 3. âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯


### 3.1 ä¸€è‡´æ€§æ£€æŸ¥åŸç†


**ğŸ” æ£€æŸ¥æœºåˆ¶**
```
æ•°æ®ä¸€è‡´æ€§éªŒè¯åŒ…å«ï¼š
â€¢ è¡Œæ•°ä¸€è‡´æ€§æ£€æŸ¥
â€¢ æ•°æ®å†…å®¹ä¸€è‡´æ€§æ£€æŸ¥  
â€¢ ç´¢å¼•ä¸€è‡´æ€§æ£€æŸ¥
â€¢ çº¦æŸä¸€è‡´æ€§æ£€æŸ¥
```

**éªŒè¯è¿‡ç¨‹**ï¼š
```
åŸè¡¨ (table)     â†’    å¯¹æ¯”    â†    ghostè¡¨ (_table_gho)
     â†“                              â†“
è®¡ç®—æ ¡éªŒå’Œ                      è®¡ç®—æ ¡éªŒå’Œ
     â†“                              â†“
è®°å½•è¡Œæ•°                        è®°å½•è¡Œæ•°
     â†“                              â†“
        æ¯”è¾ƒç»“æœï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´
```

### 3.2 ä¸€è‡´æ€§æ£€æŸ¥æ–¹æ³•


**ğŸ“ æ‰‹åŠ¨éªŒè¯æ–¹æ³•**
```sql
-- 1. è¡Œæ•°å¯¹æ¯”
SELECT COUNT(*) FROM original_table;
SELECT COUNT(*) FROM _original_table_gho;

-- 2. æ•°æ®æ ¡éªŒå’Œå¯¹æ¯”
SELECT 
  BIT_XOR(CAST(CRC32(CONCAT_WS(',', col1, col2, col3)) AS UNSIGNED)) 
FROM original_table;

SELECT 
  BIT_XOR(CAST(CRC32(CONCAT_WS(',', col1, col2, col3)) AS UNSIGNED)) 
FROM _original_table_gho;

-- 3. å…³é”®æ•°æ®æŠ½æ ·æ£€æŸ¥
SELECT * FROM original_table WHERE id IN (1,100,1000,10000) 
ORDER BY id;

SELECT * FROM _original_table_gho WHERE id IN (1,100,1000,10000) 
ORDER BY id;
```

**ğŸ”§ è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬**
```bash
#!/bin/bash
# æ•°æ®ä¸€è‡´æ€§è‡ªåŠ¨æ£€æŸ¥è„šæœ¬

DB_HOST="localhost"
DB_USER="test_user"
DB_PASS="password"
DATABASE="test_db"
TABLE="users"
GHOST_TABLE="_${TABLE}_gho"

# æ£€æŸ¥è¡Œæ•°
echo "æ£€æŸ¥è¡Œæ•°ä¸€è‡´æ€§..."
ORIGINAL_COUNT=$(mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DATABASE \
  -e "SELECT COUNT(*) FROM $TABLE;" -s -N)
GHOST_COUNT=$(mysql -h$DB_HOST -u$DB_USER -p$DB_PASS $DATABASE \
  -e "SELECT COUNT(*) FROM $GHOST_TABLE;" -s -N)

if [ "$ORIGINAL_COUNT" = "$GHOST_COUNT" ]; then
    echo "âœ“ è¡Œæ•°ä¸€è‡´: $ORIGINAL_COUNT"
else
    echo "âœ— è¡Œæ•°ä¸ä¸€è‡´: åŸè¡¨($ORIGINAL_COUNT) vs ghostè¡¨($GHOST_COUNT)"
    exit 1
fi

# æ£€æŸ¥æ•°æ®æ ¡éªŒå’Œ
echo "æ£€æŸ¥æ•°æ®æ ¡éªŒå’Œ..."
# è¿™é‡Œæ·»åŠ æ ¡éªŒå’Œæ¯”è¾ƒé€»è¾‘
echo "âœ“ æ•°æ®ä¸€è‡´æ€§éªŒè¯å®Œæˆ"
```

### 3.3 ä¸€è‡´æ€§é—®é¢˜æ’æŸ¥


**ğŸ” å¸¸è§ä¸ä¸€è‡´åŸå› **
```
æ•°æ®åŒæ­¥å»¶è¿Ÿï¼š
â€¢ ä¸»ä»å¤åˆ¶å»¶è¿Ÿ
â€¢ ç½‘ç»œæŠ–åŠ¨å½±å“
â€¢ å¤§äº‹åŠ¡é˜»å¡

æ•°æ®å˜æ›´å†²çªï¼š
â€¢ DDLæœŸé—´æœ‰å†™å…¥
â€¢ è§¦å‘å™¨å½±å“
â€¢ å¤–é”®çº¦æŸé—®é¢˜

gh-osté…ç½®é—®é¢˜ï¼š
â€¢ chunk-sizeè®¾ç½®ä¸å½“
â€¢ max-loadé˜ˆå€¼è¿‡é«˜
â€¢ å¹¶å‘æ§åˆ¶ä¸è¶³
```

---

## 4. âš¡ æ€§èƒ½å½±å“æµ‹è¯•


### 4.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡**
```
æ•°æ®åº“å±‚é¢ï¼š
â€¢ CPUä½¿ç”¨ç‡
â€¢ å†…å­˜ä½¿ç”¨ç‡
â€¢ ç£ç›˜I/O (IOPS/å¸¦å®½)
â€¢ ç½‘ç»œI/O
â€¢ è¿æ¥æ•°

åº”ç”¨å±‚é¢ï¼š
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´
â€¢ äº‹åŠ¡å¤„ç†èƒ½åŠ›(TPS)
â€¢ æŸ¥è¯¢å¤„ç†èƒ½åŠ›(QPS)
â€¢ æ…¢æŸ¥è¯¢æ•°é‡
```

### 4.2 æ€§èƒ½æµ‹è¯•æ–¹æ³•


**ğŸ”§ åŸºå‡†æµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash
# gh-ostæ€§èƒ½å½±å“æµ‹è¯•è„šæœ¬

# æµ‹è¯•å‰åŸºå‡†æ•°æ®æ”¶é›†
echo "æ”¶é›†åŸºå‡†æ€§èƒ½æ•°æ®..."
mysqlslap \
  --host=localhost \
  --user=test_user \
  --password=password \
  --database=test_db \
  --query="SELECT * FROM users WHERE status=1 LIMIT 100" \
  --concurrency=10 \
  --iterations=5 \
  --create-schema > baseline_performance.log

# å¯åŠ¨gh-ostæ“ä½œ
echo "å¯åŠ¨gh-ost DDLæ“ä½œ..."
gh-ost \
  --host=localhost \
  --database=test_db \
  --table=users \
  --alter="ADD INDEX idx_age (age)" \
  --chunk-size=1000 \
  --max-load="Threads_running=25" \
  --execute &

GH_OST_PID=$!

# DDLæœŸé—´æ€§èƒ½ç›‘æ§
echo "ç›‘æ§DDLæœŸé—´æ€§èƒ½..."
while kill -0 $GH_OST_PID 2>/dev/null; do
    # æ”¶é›†æ€§èƒ½æŒ‡æ ‡
    mysql -e "SHOW PROCESSLIST;" >> processlist_during_ddl.log
    mysql -e "SHOW ENGINE INNODB STATUS\G" >> innodb_status.log
    sleep 30
done

echo "DDLå®Œæˆï¼Œæ”¶é›†å®Œæˆåæ€§èƒ½æ•°æ®..."
mysqlslap \
  --host=localhost \
  --user=test_user \
  --password=password \
  --database=test_db \
  --query="SELECT * FROM users WHERE status=1 LIMIT 100" \
  --concurrency=10 \
  --iterations=5 \
  --create-schema > after_ddl_performance.log
```

**ğŸ“ˆ æ€§èƒ½å¯¹æ¯”åˆ†æ**
```sql
-- æŸ¥çœ‹DDLæœŸé—´çš„æ…¢æŸ¥è¯¢
SELECT 
    query_time,
    lock_time,
    rows_sent,
    rows_examined,
    sql_text
FROM mysql.slow_log 
WHERE start_time BETWEEN '2024-01-01 10:00:00' AND '2024-01-01 12:00:00'
ORDER BY query_time DESC
LIMIT 10;

-- æ£€æŸ¥DDLæœŸé—´çš„è¿æ¥æ•°å˜åŒ–
SELECT 
    TIME(ts) as time,
    variable_value as connections
FROM performance_schema.global_status_history
WHERE variable_name = 'Threads_connected'
AND ts BETWEEN '2024-01-01 10:00:00' AND '2024-01-01 12:00:00';
```

### 4.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ è°ƒä¼˜å‚æ•°**
```bash
# ä¿å®ˆé…ç½®ï¼ˆé€‚åˆç¹å¿™ç³»ç»Ÿï¼‰
--chunk-size=500
--max-load="Threads_running=15,Threads_connected=200"
--critical-load="Threads_running=30,Threads_connected=300"
--throttle-query="SELECT SLEEP(1)"

# æ¿€è¿›é…ç½®ï¼ˆé€‚åˆä½è´Ÿè½½ç³»ç»Ÿï¼‰
--chunk-size=2000
--max-load="Threads_running=50"
--critical-load="Threads_running=80"
--throttle-query="SELECT 1"
```

---

## 5. ğŸ”„ å›æ»šåŠŸèƒ½æµ‹è¯•


### 5.1 å›æ»šæœºåˆ¶åŸç†


**ğŸ”„ å›æ»šåŸç†**
```
gh-ostå›æ»šç‰¹ç‚¹ï¼š
â€¢ åŸºäºbinlogä½ç‚¹å›æ»š
â€¢ ä¿ç•™åŸè¡¨ä¸å˜
â€¢ å¯ä»¥éšæ—¶ä¸­æ–­æ“ä½œ
â€¢ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
```

**å›æ»šæ—¶æœº**ï¼š
```
ä¸»åŠ¨å›æ»šï¼š
â€¢ æ‰‹åŠ¨åœæ­¢æ“ä½œ
â€¢ æ£€æµ‹åˆ°å¼‚å¸¸æƒ…å†µ
â€¢ è¾¾åˆ°è´Ÿè½½é˜ˆå€¼

è‡ªåŠ¨å›æ»šï¼š
â€¢ å¤åˆ¶å»¶è¿Ÿè¿‡å¤§
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³
â€¢ è¿æ¥æ•°è¿‡å¤š
```

### 5.2 å›æ»šæ“ä½œæµ‹è¯•


**ğŸ§ª å›æ»šæµ‹è¯•ç”¨ä¾‹**
```bash
# æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸å›æ»š
echo "å¯åŠ¨DDLæ“ä½œ..."
gh-ost \
  --host=localhost \
  --database=test_db \
  --table=users \
  --alter="ADD COLUMN test_col VARCHAR(50)" \
  --execute \
  --serve-socket-file=/tmp/gh-ost.sock &

sleep 10

# æ‰§è¡Œå›æ»š
echo "æ‰§è¡Œå›æ»šæ“ä½œ..."
echo "stop" | socat - /tmp/gh-ost.sock

# éªŒè¯å›æ»šç»“æœ
mysql -e "DESCRIBE test_db.users;" | grep test_col
if [ $? -eq 0 ]; then
    echo "âœ— å›æ»šå¤±è´¥ï¼Œåˆ—ä»å­˜åœ¨"
else
    echo "âœ“ å›æ»šæˆåŠŸ"
fi
```

**ğŸ”§ å›æ»šçŠ¶æ€æ£€æŸ¥**
```bash
# æ£€æŸ¥å›æ»šåçš„çŠ¶æ€
echo "æ£€æŸ¥å›æ»šåçŠ¶æ€..."

# 1. æ£€æŸ¥ghostè¡¨æ˜¯å¦æ¸…ç†
mysql -e "SHOW TABLES LIKE '%_gho';" test_db

# 2. æ£€æŸ¥åŸè¡¨ç»“æ„
mysql -e "DESCRIBE users;" test_db

# 3. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
RECORD_COUNT=$(mysql -e "SELECT COUNT(*) FROM users;" test_db -s -N)
echo "åŸè¡¨è®°å½•æ•°: $RECORD_COUNT"

# 4. æ£€æŸ¥binlogä½ç‚¹
mysql -e "SHOW MASTER STATUS;"
```

### 5.3 å›æ»šæµ‹è¯•åœºæ™¯


**ğŸ“‹ æµ‹è¯•åœºæ™¯è®¾è®¡**
```
åœºæ™¯1ï¼šDDLå¼€å§‹é˜¶æ®µå›æ»š
â€¢ åœ¨æ•°æ®å¤åˆ¶å¼€å§‹å‰åœæ­¢
â€¢ éªŒè¯æ— ä»»ä½•å‰¯ä½œç”¨

åœºæ™¯2ï¼šDDLè¿›è¡Œä¸­å›æ»š
â€¢ åœ¨æ•°æ®å¤åˆ¶50%æ—¶åœæ­¢
â€¢ éªŒè¯æ•°æ®å®Œæ•´æ€§

åœºæ™¯3ï¼šDDLæ¥è¿‘å®Œæˆæ—¶å›æ»š
â€¢ åœ¨cut-overå‰åœæ­¢
â€¢ éªŒè¯å¿«é€Ÿå›æ»šèƒ½åŠ›

åœºæ™¯4ï¼šå¼‚å¸¸æƒ…å†µè‡ªåŠ¨å›æ»š
â€¢ æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­
â€¢ æ¨¡æ‹Ÿç£ç›˜ç©ºé—´ä¸è¶³
```

---

## 6. ğŸ” è¾¹ç•Œæ¡ä»¶æµ‹è¯•


### 6.1 æ•°æ®ç±»å‹è¾¹ç•Œæµ‹è¯•


**ğŸ“Š ç‰¹æ®Šæ•°æ®ç±»å‹æµ‹è¯•**
```sql
-- åˆ›å»ºåŒ…å«å„ç§æ•°æ®ç±»å‹çš„æµ‹è¯•è¡¨
CREATE TABLE boundary_test (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tiny_col TINYINT,
    small_col SMALLINT,
    medium_col MEDIUMINT,
    int_col INT,
    big_col BIGINT,
    decimal_col DECIMAL(65,30),
    float_col FLOAT,
    double_col DOUBLE,
    bit_col BIT(64),
    date_col DATE,
    time_col TIME,
    datetime_col DATETIME(6),
    timestamp_col TIMESTAMP(6),
    year_col YEAR,
    char_col CHAR(255),
    varchar_col VARCHAR(65535),
    binary_col BINARY(255),
    varbinary_col VARBINARY(65535),
    text_col TEXT,
    blob_col BLOB,
    json_col JSON,
    enum_col ENUM('small', 'medium', 'large'),
    set_col SET('a', 'b', 'c', 'd')
);
```

**ğŸ§ª è¾¹ç•Œå€¼æµ‹è¯•æ•°æ®**
```sql
-- æ’å…¥è¾¹ç•Œå€¼æµ‹è¯•æ•°æ®
INSERT INTO boundary_test (
    tiny_col, small_col, medium_col, int_col, big_col,
    decimal_col, float_col, double_col, bit_col,
    date_col, time_col, datetime_col, timestamp_col, year_col,
    char_col, varchar_col, text_col, json_col, enum_col, set_col
) VALUES 
-- æœ€å°å€¼
(-128, -32768, -8388608, -2147483648, -9223372036854775808,
 -99999999999999999999999999999999999.999999999999999999999999999999,
 -3.402823466E+38, -1.7976931348623157E+308, b'0000000000000000000000000000000000000000000000000000000000000000',
 '1000-01-01', '-838:59:59', '1000-01-01 00:00:00.000000', '1970-01-01 00:00:01.000000', 1901,
 '', '', '', '{}', 'small', ''),

-- æœ€å¤§å€¼  
(127, 32767, 8388607, 2147483647, 9223372036854775807,
 99999999999999999999999999999999999.999999999999999999999999999999,
 3.402823466E+38, 1.7976931348623157E+308, b'1111111111111111111111111111111111111111111111111111111111111111',
 '9999-12-31', '838:59:59', '9999-12-31 23:59:59.999999', '2038-01-19 03:14:07.999999', 2155,
 REPEAT('A', 255), REPEAT('B', 1000), REPEAT('C', 65535), 
 '{"key": "value with special chars: ä¸­æ–‡ ğŸ”¥ \\"quotes\\""}', 'large', 'a,b,c,d');
```

### 6.2 å¤§è¡¨DDLæµ‹è¯•


**ğŸ“ˆ å¤§æ•°æ®é‡æµ‹è¯•å‡†å¤‡**
```bash
# åˆ›å»ºå¤§è¡¨æµ‹è¯•æ•°æ®
create_large_table() {
    local table_name=$1
    local record_count=$2
    
    mysql << EOF
CREATE TABLE $table_name (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);

-- ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å¿«é€Ÿæ’å…¥å¤§é‡æ•°æ®
DELIMITER //
CREATE PROCEDURE insert_test_data(IN count INT)
BEGIN
    DECLARE i INT DEFAULT 1;
    WHILE i <= count DO
        INSERT INTO $table_name (user_id, content) VALUES 
        (FLOOR(RAND() * 1000000), CONCAT('Content for record ', i));
        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;

CALL insert_test_data($record_count);
DROP PROCEDURE insert_test_data;
EOF
}

# åˆ›å»º100ä¸‡æ¡è®°å½•çš„æµ‹è¯•è¡¨
create_large_table "large_test_table" 1000000
```

**â±ï¸ å¤§è¡¨DDLæ€§èƒ½æµ‹è¯•**
```bash
# æµ‹è¯•å¤§è¡¨æ·»åŠ ç´¢å¼•çš„æ€§èƒ½
test_large_table_ddl() {
    echo "å¼€å§‹å¤§è¡¨DDLæµ‹è¯•..."
    start_time=$(date +%s)
    
    gh-ost \
        --host=localhost \
        --database=test_db \
        --table=large_test_table \
        --alter="ADD INDEX idx_content (content(50))" \
        --chunk-size=1000 \
        --max-load="Threads_running=20" \
        --execute
    
    end_time=$(date +%s)
    duration=$((end_time - start_time))
    
    echo "DDLå®Œæˆï¼Œè€—æ—¶: ${duration}ç§’"
    
    # éªŒè¯ç´¢å¼•åˆ›å»ºæˆåŠŸ
    mysql -e "SHOW INDEX FROM large_test_table WHERE Key_name='idx_content';" test_db
}
```

### 6.3 ç‰¹æ®Šå­—ç¬¦å¤„ç†æµ‹è¯•


**ğŸ”¤ ç‰¹æ®Šå­—ç¬¦æµ‹è¯•ç”¨ä¾‹**
```sql
-- åˆ›å»ºåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æµ‹è¯•æ•°æ®
INSERT INTO special_char_test (content) VALUES 
('Normal text'),
('Text with "quotes" and ''apostrophes'''),
('Unicode: ä¸­æ–‡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ğ ÑƒÑÑĞºĞ¸Ğ¹ ğŸ”¥ ğŸ’¯ âœ…'),
('Special chars: !@#$%^&*()_+-=[]{}|;:,.<>?'),
('Escape sequences: \n\r\t\b\f\\\"\''),
('SQL injection attempt: ''; DROP TABLE users; --'),
('Long text: ' + REPEAT('A', 10000)),
('Binary data: \x00\x01\x02\x03\xFF'),
('JSON: {"key": "value", "number": 123, "array": [1,2,3]}'),
('XML: <root><item id="1">content</item></root>');
```

---

## 7. ğŸ”¥ å‹åŠ›æµ‹è¯•æ‰§è¡Œ


### 7.1 å‹åŠ›æµ‹è¯•è®¾è®¡


**ğŸ¯ å‹åŠ›æµ‹è¯•ç›®æ ‡**
```
å¹¶å‘å‹åŠ›æµ‹è¯•ï¼š
â€¢ æ¨¡æ‹Ÿé«˜å¹¶å‘è¯»å†™åœºæ™¯
â€¢ æµ‹è¯•DDLå¯¹ä¸šåŠ¡çš„å½±å“
â€¢ éªŒè¯ç³»ç»Ÿç¨³å®šæ€§

èµ„æºå‹åŠ›æµ‹è¯•ï¼š
â€¢ CPUå¯†é›†å‹æ“ä½œ
â€¢ å†…å­˜ä½¿ç”¨å‹åŠ›  
â€¢ ç£ç›˜I/Oå‹åŠ›
â€¢ ç½‘ç»œå¸¦å®½å‹åŠ›
```

### 7.2 å¹¶å‘å‹åŠ›æµ‹è¯•


**ğŸ”§ å¹¶å‘æµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash
# å¹¶å‘å‹åŠ›æµ‹è¯•è„šæœ¬

# å¯åŠ¨å¤šä¸ªå¹¶å‘å†™å…¥è¿›ç¨‹
start_concurrent_writes() {
    local concurrent_count=$1
    local duration=$2
    
    for i in $(seq 1 $concurrent_count); do
        {
            end_time=$(($(date +%s) + duration))
            while [ $(date +%s) -lt $end_time ]; do
                mysql -e "INSERT INTO users (name, email, status) VALUES 
                    ('user_$(date +%s%N)', 'user$(date +%s%N)@test.com', 1);" test_db
                mysql -e "UPDATE users SET status = 2 WHERE id = $((RANDOM % 1000 + 1));" test_db
                mysql -e "DELETE FROM users WHERE id = $((RANDOM % 1000 + 1)) AND status = 2;" test_db
                sleep 0.1
            done
        } &
    done
}

# å¯åŠ¨å¤šä¸ªå¹¶å‘è¯»å–è¿›ç¨‹
start_concurrent_reads() {
    local concurrent_count=$1
    local duration=$2
    
    for i in $(seq 1 $concurrent_count); do
        {
            end_time=$(($(date +%s) + duration))
            while [ $(date +%s) -lt $end_time ]; do
                mysql -e "SELECT * FROM users WHERE status = 1 ORDER BY RAND() LIMIT 10;" test_db >/dev/null
                mysql -e "SELECT COUNT(*) FROM users WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 DAY);" test_db >/dev/null
                sleep 0.05
            done
        } &
    done
}

# æ‰§è¡Œå‹åŠ›æµ‹è¯•
echo "å¯åŠ¨å¹¶å‘å‹åŠ›æµ‹è¯•..."
start_concurrent_writes 10 300  # 10ä¸ªå¹¶å‘å†™å…¥è¿›ç¨‹ï¼ŒæŒç»­5åˆ†é’Ÿ
start_concurrent_reads 20 300   # 20ä¸ªå¹¶å‘è¯»å–è¿›ç¨‹ï¼ŒæŒç»­5åˆ†é’Ÿ

# åœ¨å‹åŠ›æµ‹è¯•è¿›è¡Œä¸­å¯åŠ¨gh-ost
sleep 60
echo "åœ¨å‹åŠ›æµ‹è¯•ä¸­å¯åŠ¨gh-ost DDLæ“ä½œ..."
gh-ost \
    --host=localhost \
    --database=test_db \
    --table=users \
    --alter="ADD COLUMN pressure_test_col INT DEFAULT 0" \
    --chunk-size=500 \
    --max-load="Threads_running=30" \
    --critical-load="Threads_running=50" \
    --execute

# ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
wait
echo "å‹åŠ›æµ‹è¯•å®Œæˆ"
```

### 7.3 èµ„æºç›‘æ§è„šæœ¬


**ğŸ“Š ç³»ç»Ÿèµ„æºç›‘æ§**
```bash
#!/bin/bash
# èµ„æºç›‘æ§è„šæœ¬

monitor_resources() {
    local duration=$1
    local output_file=$2
    
    echo "æ—¶é—´,CPUä½¿ç”¨ç‡,å†…å­˜ä½¿ç”¨ç‡,ç£ç›˜IOPS,ç½‘ç»œæµé‡" > $output_file
    
    end_time=$(($(date +%s) + duration))
    while [ $(date +%s) -lt $end_time ]; do
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        
        # CPUä½¿ç”¨ç‡
        cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        
        # å†…å­˜ä½¿ç”¨ç‡
        mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
        
        # ç£ç›˜IOPS
        disk_iops=$(iostat -x 1 1 | awk '/sda/ {print $4+$5}' | tail -1)
        
        # ç½‘ç»œæµé‡
        net_traffic=$(cat /proc/net/dev | grep eth0 | awk '{print $2+$10}')
        
        echo "$timestamp,$cpu_usage,$mem_usage,$disk_iops,$net_traffic" >> $output_file
        sleep 5
    done
}

# å¯åŠ¨èµ„æºç›‘æ§
monitor_resources 600 "resource_monitor.csv" &
MONITOR_PID=$!

echo "èµ„æºç›‘æ§å·²å¯åŠ¨ï¼ŒPID: $MONITOR_PID"
```

---

## 8. ğŸ—ï¸ æµ‹è¯•ç¯å¢ƒå‡†å¤‡


### 8.1 æµ‹è¯•ç¯å¢ƒæ¶æ„


**ğŸ›ï¸ æ¨èæµ‹è¯•æ¶æ„**
```
ç”Ÿäº§æ¨¡æ‹Ÿç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»åº“      â”‚â”€â”€â”€â”€â”‚   ä»åº“1     â”‚â”€â”€â”€â”€â”‚   ä»åº“2     â”‚
â”‚  (Master)   â”‚    â”‚ (Replica1)  â”‚    â”‚ (Replica2)  â”‚
â”‚  å†™å…¥æµ‹è¯•   â”‚    â”‚ gh-ostæµ‹è¯•  â”‚    â”‚  åªè¯»éªŒè¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   ç›‘æ§èŠ‚ç‚¹  â”‚
                   â”‚ (Monitoring)â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ç¯å¢ƒé…ç½®è¦æ±‚


**ğŸ’¾ ç¡¬ä»¶é…ç½®å»ºè®®**
```
æœ€å°é…ç½®ï¼š
â€¢ CPU: 4æ ¸å¿ƒ
â€¢ å†…å­˜: 8GB
â€¢ å­˜å‚¨: 100GB SSD
â€¢ ç½‘ç»œ: 1Gbps

æ¨èé…ç½®ï¼š
â€¢ CPU: 8æ ¸å¿ƒ
â€¢ å†…å­˜: 16GB  
â€¢ å­˜å‚¨: 500GB SSD
â€¢ ç½‘ç»œ: 10Gbps

ç”Ÿäº§çº§é…ç½®ï¼š
â€¢ CPU: 16æ ¸å¿ƒ
â€¢ å†…å­˜: 64GB
â€¢ å­˜å‚¨: 1TB NVMe SSD
â€¢ ç½‘ç»œ: 10Gbps
```

**âš™ï¸ MySQLé…ç½®ä¼˜åŒ–**
```ini
# my.cnf æµ‹è¯•ç¯å¢ƒé…ç½®
[mysqld]
# åŸºç¡€é…ç½®
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
gtid-mode = ON
enforce-gtid-consistency = ON

# æ€§èƒ½é…ç½®
innodb_buffer_pool_size = 4G
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2
sync_binlog = 0

# å¤åˆ¶é…ç½®
slave-parallel-type = LOGICAL_CLOCK
slave-parallel-workers = 4
slave-preserve-commit-order = ON

# gh-ostç›¸å…³é…ç½®
slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'
```

### 8.3 æµ‹è¯•æ•°æ®å‡†å¤‡


**ğŸ“Š æµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬**
```bash
#!/bin/bash
# æµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬

generate_test_data() {
    local table_name=$1
    local record_count=$2
    
    echo "ç”Ÿæˆæµ‹è¯•æ•°æ®: $table_name ($record_count æ¡è®°å½•)"
    
    mysql << EOF
-- åˆ›å»ºæµ‹è¯•è¡¨
CREATE TABLE IF NOT EXISTS $table_name (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    status TINYINT DEFAULT 1,
    score DECIMAL(10,2) DEFAULT 0.00,
    tags JSON,
    profile TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- ç”Ÿæˆæµ‹è¯•æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER //
CREATE PROCEDURE generate_data(IN count INT)
BEGIN
    DECLARE i INT DEFAULT 1;
    DECLARE batch_size INT DEFAULT 1000;
    DECLARE current_batch INT DEFAULT 0;
    
    WHILE i <= count DO
        SET current_batch = 0;
        START TRANSACTION;
        
        WHILE current_batch < batch_size AND i <= count DO
            INSERT INTO $table_name (
                user_id, username, email, phone, status, score, tags, profile
            ) VALUES (
                i,
                CONCAT('user_', i),
                CONCAT('user_', i, '@test.com'),
                CONCAT('1390000', LPAD(i % 10000, 4, '0')),
                (i % 3) + 1,
                ROUND(RAND() * 100, 2),
                JSON_OBJECT('level', i % 10, 'vip', i % 2),
                CONCAT('Profile for user ', i, '. ', REPEAT('Data ', i % 100))
            );
            
            SET i = i + 1;
            SET current_batch = current_batch + 1;
        END WHILE;
        
        COMMIT;
        
        IF i % 10000 = 0 THEN
            SELECT CONCAT('Generated ', i, ' records') AS progress;
        END IF;
    END WHILE;
END //
DELIMITER ;

-- æ‰§è¡Œæ•°æ®ç”Ÿæˆ
CALL generate_data($record_count);
DROP PROCEDURE generate_data;

-- ç»Ÿè®¡ä¿¡æ¯
SELECT 
    COUNT(*) as total_records,
    MIN(created_at) as first_record,
    MAX(created_at) as last_record
FROM $table_name;
EOF
}

# ç”Ÿæˆä¸åŒè§„æ¨¡çš„æµ‹è¯•æ•°æ®
generate_test_data "small_table" 10000      # 1ä¸‡æ¡è®°å½•
generate_test_data "medium_table" 100000    # 10ä¸‡æ¡è®°å½•  
generate_test_data "large_table" 1000000    # 100ä¸‡æ¡è®°å½•
```

---

## 9. ğŸ“‹ æµ‹è¯•ç”¨ä¾‹è®¾è®¡


### 9.1 åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹


**ğŸ§ª DDLæ“ä½œæµ‹è¯•ç”¨ä¾‹**
```bash
# æµ‹è¯•ç”¨ä¾‹é›†åˆ
declare -A test_cases=(
    ["add_column"]="ADD COLUMN new_col VARCHAR(50) DEFAULT 'test'"
    ["drop_column"]="DROP COLUMN old_col"
    ["modify_column"]="MODIFY COLUMN status TINYINT NOT NULL DEFAULT 1"
    ["add_index"]="ADD INDEX idx_new_col (new_col)"
    ["drop_index"]="DROP INDEX idx_old_col"
    ["add_unique"]="ADD UNIQUE KEY uk_email (email)"
    ["change_column"]="CHANGE COLUMN old_name new_name VARCHAR(100)"
    ["add_foreign_key"]="ADD CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id)"
)

# æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
run_test_case() {
    local test_name=$1
    local alter_statement=$2
    
    echo "æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹: $test_name"
    echo "DDLè¯­å¥: $alter_statement"
    
    # è®°å½•å¼€å§‹æ—¶é—´
    start_time=$(date +%s)
    
    # æ‰§è¡Œgh-ost
    gh-ost \
        --host=localhost \
        --database=test_db \
        --table=test_table \
        --alter="$alter_statement" \
        --test-on-replica \
        --execute \
        --max-load="Threads_running=25" > "test_${test_name}.log" 2>&1
    
    local exit_code=$?
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    if [ $exit_code -eq 0 ]; then
        echo "âœ“ $test_name æµ‹è¯•é€šè¿‡ (è€—æ—¶: ${duration}s)"
        return 0
    else
        echo "âœ— $test_name æµ‹è¯•å¤±è´¥ (è€—æ—¶: ${duration}s)"
        return 1
    fi
}

# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
for test_name in "${!test_cases[@]}"; do
    run_test_case "$test_name" "${test_cases[$test_name]}"
    sleep 5  # æµ‹è¯•é—´éš”
done
```

### 9.2 å¼‚å¸¸æƒ…å†µæµ‹è¯•ç”¨ä¾‹


**âš ï¸ å¼‚å¸¸åœºæ™¯æµ‹è¯•**
```bash
# å¼‚å¸¸æƒ…å†µæµ‹è¯•ç”¨ä¾‹
test_error_scenarios() {
    echo "å¼€å§‹å¼‚å¸¸æƒ…å†µæµ‹è¯•..."
    
    # æµ‹è¯•1: ç£ç›˜ç©ºé—´ä¸è¶³
    test_disk_space_full() {
        echo "æµ‹è¯•: ç£ç›˜ç©ºé—´ä¸è¶³åœºæ™¯"
        # åˆ›å»ºå¤§æ–‡ä»¶å æ»¡ç£ç›˜ç©ºé—´
        dd if=/dev/zero of=/tmp/fillspace bs=1M count=1000 2>/dev/null
        
        gh-ost \
            --host=localhost \
            --database=test_db \
            --table=large_table \
            --alter="ADD COLUMN disk_test VARCHAR(100)" \
            --execute &
        
        local gh_ost_pid=$!
        sleep 10
        
        # æ£€æŸ¥æ˜¯å¦æ­£ç¡®å¤„ç†ç£ç›˜ç©ºé—´ä¸è¶³
        if kill -0 $gh_ost_pid 2>/dev/null; then
            echo "âœ“ gh-ostæ­£ç¡®æ£€æµ‹åˆ°ç£ç›˜ç©ºé—´é—®é¢˜"
        fi
        
        # æ¸…ç†
        rm -f /tmp/fillspace
        kill $gh_ost_pid 2>/dev/null
    }
    
    # æµ‹è¯•2: ç½‘ç»œä¸­æ–­
    test_network_interruption() {
        echo "æµ‹è¯•: ç½‘ç»œä¸­æ–­åœºæ™¯"
        # è¿™é‡Œå¯ä»¥ä½¿ç”¨iptablesæ¨¡æ‹Ÿç½‘ç»œä¸­æ–­
        # å®é™…æµ‹è¯•ä¸­éœ€è¦è°¨æ…æ“ä½œ
    }
    
    # æµ‹è¯•3: é«˜è´Ÿè½½åœºæ™¯
    test_high_load() {
        echo "æµ‹è¯•: é«˜è´Ÿè½½è‡ªåŠ¨åœæ­¢"
        
        # æ¨¡æ‹Ÿé«˜è´Ÿè½½
        stress --cpu 8 --timeout 60s &
        local stress_pid=$!
        
        gh-ost \
            --host=localhost \
            --database=test_db \
            --table=test_table \
            --alter="ADD COLUMN load_test INT" \
            --max-load="Threads_running=5" \
            --critical-load="Threads_running=10" \
            --execute
        
        local exit_code=$?
        kill $stress_pid 2>/dev/null
        
        if [ $exit_code -ne 0 ]; then
            echo "âœ“ gh-ostæ­£ç¡®å¤„ç†é«˜è´Ÿè½½æƒ…å†µ"
        fi
    }
    
    # æ‰§è¡Œå¼‚å¸¸æµ‹è¯•
    test_disk_space_full
    test_high_load
}
```

### 9.3 æµ‹è¯•ç»“æœè®°å½•


**ğŸ“Š æµ‹è¯•ç»“æœæ¨¡æ¿**
```bash
# æµ‹è¯•ç»“æœè®°å½•å‡½æ•°
record_test_result() {
    local test_name=$1
    local result=$2
    local duration=$3
    local details=$4
    
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local log_file="test_results.csv"
    
    # åˆ›å»ºCSVæ ‡é¢˜ï¼ˆä»…åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼‰
    if [ ! -f "$log_file" ]; then
        echo "æ—¶é—´,æµ‹è¯•åç§°,ç»“æœ,è€—æ—¶(ç§’),è¯¦ç»†ä¿¡æ¯" > "$log_file"
    fi
    
    # è®°å½•æµ‹è¯•ç»“æœ
    echo "$timestamp,$test_name,$result,$duration,$details" >> "$log_file"
    
    # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
    printf "%-20s %-10s %-8s %s\n" "$test_name" "$result" "${duration}s" "$details"
}

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
generate_test_report() {
    local report_file="test_report.html"
    
    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>gh-ost æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f0f0f0; padding: 10px; }
        .success { color: green; }
        .failure { color: red; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="header">
        <h1>gh-ost æµ‹è¯•æŠ¥å‘Š</h1>
        <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
    </div>
    
    <h2>æµ‹è¯•ç»“æœæ±‡æ€»</h2>
    <table>
        <tr>
            <th>æµ‹è¯•åç§°</th>
            <th>ç»“æœ</th>
            <th>è€—æ—¶</th>
            <th>è¯¦ç»†ä¿¡æ¯</th>
        </tr>
EOF

    # è¯»å–CSVæ–‡ä»¶å¹¶è½¬æ¢ä¸ºHTMLè¡¨æ ¼
    tail -n +2 test_results.csv | while IFS=',' read -r timestamp name result duration details; do
        local class_name=""
        if [ "$result" = "PASS" ]; then
            class_name="success"
        else
            class_name="failure"
        fi
        
        echo "        <tr>" >> "$report_file"
        echo "            <td>$name</td>" >> "$report_file"
        echo "            <td class=\"$class_name\">$result</td>" >> "$report_file"
        echo "            <td>$duration</td>" >> "$report_file"
        echo "            <td>$details</td>" >> "$report_file"
        echo "        </tr>" >> "$report_file"
    done
    
    cat >> "$report_file" << EOF
    </table>
</body>
</html>
EOF

    echo "æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}
```

---

## 10. ğŸ“ˆ æµ‹è¯•ç»“æœåˆ†æ


### 10.1 æ€§èƒ½æŒ‡æ ‡åˆ†æ


**ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”**
```bash
# æ€§èƒ½æ•°æ®åˆ†æè„šæœ¬
analyze_performance() {
    echo "æ€§èƒ½æŒ‡æ ‡åˆ†ææŠ¥å‘Š"
    echo "===================="
    
    # åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
    echo "æ…¢æŸ¥è¯¢åˆ†æ:"
    mysql -e "
    SELECT 
        COUNT(*) as slow_query_count,
        AVG(query_time) as avg_query_time,
        MAX(query_time) as max_query_time
    FROM mysql.slow_log 
    WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR);
    "
    
    # åˆ†æè¿æ¥æ•°å˜åŒ–
    echo "è¿æ¥æ•°ç»Ÿè®¡:"
    mysql -e "SHOW STATUS LIKE 'Threads_connected';"
    mysql -e "SHOW STATUS LIKE 'Max_used_connections';"
    
    # åˆ†æInnoDBçŠ¶æ€
    echo "InnoDBçŠ¶æ€:"
    mysql -e "SHOW ENGINE INNODB STATUS\G" | grep -A 5 "BACKGROUND THREAD"
    
    # CPUå’Œå†…å­˜ä½¿ç”¨åˆ†æ
    echo "ç³»ç»Ÿèµ„æºä½¿ç”¨:"
    echo "CPUä½¿ç”¨ç‡: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')"
    echo "å†…å­˜ä½¿ç”¨ç‡: $(free | grep Mem | awk '{printf "%.1f%%", $3/$2 * 100.0}')"
}
```

### 10.2 æ•°æ®ä¸€è‡´æ€§åˆ†æ


**âœ… ä¸€è‡´æ€§éªŒè¯ç»“æœ**
```sql
-- æ•°æ®ä¸€è‡´æ€§éªŒè¯æŸ¥è¯¢
-- 1. è®°å½•æ•°å¯¹æ¯”
SELECT 
    'original_table' as table_name,
    COUNT(*) as record_count,
    SUM(CRC32(CONCAT_WS('|', id, name, email, status))) as checksum
FROM original_table
UNION ALL
SELECT 
    'ghost_table' as table_name,
    COUNT(*) as record_count,
    SUM(CRC32(CONCAT_WS('|', id, name, email, status))) as checksum
FROM _original_table_gho;

-- 2. ç´¢å¼•ä¸€è‡´æ€§æ£€æŸ¥
SELECT 
    table_name,
    index_name,
    column_name,
    seq_in_index,
    non_unique
FROM information_schema.statistics 
WHERE table_schema = 'test_db' 
  AND table_name IN ('original_table', '_original_table_gho')
ORDER BY table_name, index_name, seq_in_index;

-- 3. çº¦æŸä¸€è‡´æ€§æ£€æŸ¥  
SELECT 
    table_name,
    constraint_name,
    constraint_type
FROM information_schema.table_constraints
WHERE table_schema = 'test_db'
  AND table_name IN ('original_table', '_original_table_gho');
```

### 10.3 æµ‹è¯•ç»“æœè¯„ä¼°æ ‡å‡†


**ğŸ“Š è¯„ä¼°æ ‡å‡†å®šä¹‰**
```
æ€§èƒ½å½±å“è¯„ä¼°ï¼š
âœ… ä¼˜ç§€: æ€§èƒ½å½±å“ < 5%
âœ… è‰¯å¥½: æ€§èƒ½å½±å“ 5-15%  
âš ï¸  è­¦å‘Š: æ€§èƒ½å½±å“ 15-30%
âŒ ä¸é€šè¿‡: æ€§èƒ½å½±å“ > 30%

æ•°æ®ä¸€è‡´æ€§è¯„ä¼°ï¼š
âœ… é€šè¿‡: 100%æ•°æ®ä¸€è‡´
âŒ ä¸é€šè¿‡: ä»»ä½•æ•°æ®ä¸ä¸€è‡´

ç¨³å®šæ€§è¯„ä¼°ï¼š
âœ… ä¼˜ç§€: 0ä¸ªå¼‚å¸¸
âœ… è‰¯å¥½: 1-2ä¸ªå¯å¿½ç•¥å¼‚å¸¸
âš ï¸  è­¦å‘Š: 3-5ä¸ªéå…³é”®å¼‚å¸¸  
âŒ ä¸é€šè¿‡: å…³é”®å¼‚å¸¸æˆ–>5ä¸ªå¼‚å¸¸
```

---

## 11. âœ”ï¸ ç”Ÿäº§å‰éªŒè¯


### 11.1 ç”Ÿäº§å‰æ£€æŸ¥æ¸…å•


**ğŸ“‹ å®Œæ•´æ£€æŸ¥æ¸…å•**
```
ç¯å¢ƒæ£€æŸ¥ï¼š
â–¡ ä¸»ä»å¤åˆ¶çŠ¶æ€æ­£å¸¸
â–¡ ç£ç›˜ç©ºé—´å……è¶³ (>50% å¯ç”¨ç©ºé—´)
â–¡ ç½‘ç»œè¿æ¥ç¨³å®š
â–¡ å¤‡ä»½ç­–ç•¥å·²ç¡®è®¤

æƒé™æ£€æŸ¥ï¼š
â–¡ gh-ostç”¨æˆ·æƒé™å……è¶³
â–¡ æ“ä½œè¡¨æƒé™æ­£ç¡®
â–¡ binlogæƒé™å·²æˆäºˆ
â–¡ å¤åˆ¶æƒé™å·²ç¡®è®¤

é…ç½®æ£€æŸ¥ï¼š
â–¡ MySQLé…ç½®é€‚åˆgh-ost
â–¡ è´Ÿè½½é˜ˆå€¼åˆç†è®¾ç½®
â–¡ ç›‘æ§ç³»ç»Ÿå·²å‡†å¤‡
â–¡ å›æ»šæ–¹æ¡ˆå·²åˆ¶å®š

æµ‹è¯•éªŒè¯ï¼š
â–¡ test-on-replicaæµ‹è¯•é€šè¿‡
â–¡ æ€§èƒ½å½±å“åœ¨å¯æ¥å—èŒƒå›´
â–¡ æ•°æ®ä¸€è‡´æ€§éªŒè¯é€šè¿‡
â–¡ å¼‚å¸¸æƒ…å†µå¤„ç†éªŒè¯

ä¸šåŠ¡å‡†å¤‡ï¼š
â–¡ ä¸šåŠ¡ä½å³°æ—¶æ®µå·²ç¡®è®¤
â–¡ ç›¸å…³å›¢é˜Ÿå·²é€šçŸ¥
â–¡ ç›‘æ§å‘Šè­¦å·²è®¾ç½®
â–¡ åº”æ€¥è”ç³»äººå·²ç¡®å®š
```

### 11.2 ç”Ÿäº§ç¯å¢ƒæœ€ç»ˆæµ‹è¯•


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒéªŒè¯è„šæœ¬**
```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒæœ€ç»ˆéªŒè¯è„šæœ¬

production_validation() {
    echo "å¼€å§‹ç”Ÿäº§ç¯å¢ƒæœ€ç»ˆéªŒè¯..."
    
    # 1. ç¯å¢ƒçŠ¶æ€æ£€æŸ¥
    check_environment() {
        echo "æ£€æŸ¥ç¯å¢ƒçŠ¶æ€..."
        
        # æ£€æŸ¥ä¸»ä»çŠ¶æ€
        local slave_status=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Slave_SQL_Running" | awk '{print $2}')
        if [ "$slave_status" != "Yes" ]; then
            echo "âŒ ä»åº“çŠ¶æ€å¼‚å¸¸"
            return 1
        fi
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        local disk_usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
        if [ $disk_usage -gt 70 ]; then
            echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${disk_usage}%"
        fi
        
        # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
        local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
        echo "å½“å‰ç³»ç»Ÿè´Ÿè½½: $load_avg"
        
        echo "âœ“ ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
    }
    
    # 2. æœ€å°å½±å“æµ‹è¯•
    minimal_impact_test() {
        echo "æ‰§è¡Œæœ€å°å½±å“æµ‹è¯•..."
        
        # åœ¨ä¸€ä¸ªå°è¡¨ä¸Šæ‰§è¡Œå¿«é€ŸDDL
        gh-ost \
            --host=localhost \
            --database=test_db \
            --table=small_test_table \
            --alter="ADD COLUMN validation_test TINYINT DEFAULT 1" \
            --execute \
            --max-load="Threads_running=10" \
            --chunk-size=100
        
        if [ $? -eq 0 ]; then
            echo "âœ“ æœ€å°å½±å“æµ‹è¯•é€šè¿‡"
            
            # æ¸…ç†æµ‹è¯•åˆ—
            mysql -e "ALTER TABLE test_db.small_test_table DROP COLUMN validation_test;"
        else
            echo "âŒ æœ€å°å½±å“æµ‹è¯•å¤±è´¥"
            return 1
        fi
    }
    
    # 3. ç›‘æ§ç³»ç»ŸéªŒè¯
    monitoring_validation() {
        echo "éªŒè¯ç›‘æ§ç³»ç»Ÿ..."
        
        # æ£€æŸ¥ç›‘æ§è„šæœ¬æ˜¯å¦æ­£å¸¸
        if [ -f "/opt/monitor/gh-ost-monitor.sh" ]; then
            bash /opt/monitor/gh-ost-monitor.sh --test
            echo "âœ“ ç›‘æ§ç³»ç»ŸéªŒè¯å®Œæˆ"
        else
            echo "âš ï¸  ç›‘æ§è„šæœ¬æœªæ‰¾åˆ°"
        fi
    }
    
    # æ‰§è¡Œæ‰€æœ‰éªŒè¯
    check_environment || return 1
    minimal_impact_test || return 1
    monitoring_validation
    
    echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯å®Œæˆï¼Œå¯ä»¥æ‰§è¡Œæ­£å¼DDLæ“ä½œ"
    return 0
}

# æ‰§è¡ŒéªŒè¯
if production_validation; then
    echo "å‡†å¤‡æ‰§è¡Œç”Ÿäº§DDLæ“ä½œ..."
else
    echo "éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é—®é¢˜åé‡è¯•"
    exit 1
fi
```

### 11.3 æ­£å¼æ‰§è¡Œå‡†å¤‡


**ğŸš€ æ­£å¼æ‰§è¡Œå‰å‡†å¤‡**
```bash
# æ­£å¼æ‰§è¡Œè„šæœ¬æ¨¡æ¿
execute_production_ddl() {
    local database=$1
    local table=$2
    local alter_statement=$3
    
    echo "========================================"
    echo "ç”Ÿäº§ç¯å¢ƒDDLæ‰§è¡Œ"
    echo "========================================"
    echo "æ•°æ®åº“: $database"
    echo "è¡¨å: $table"  
    echo "DDLè¯­å¥: $alter_statement"
    echo "æ‰§è¡Œæ—¶é—´: $(date)"
    echo "========================================"
    
    # æœ€åç¡®è®¤
    read -p "ç¡®è®¤æ‰§è¡Œç”Ÿäº§DDLæ“ä½œ? (yes/no): " confirmation
    if [ "$confirmation" != "yes" ]; then
        echo "æ“ä½œå·²å–æ¶ˆ"
        return 1
    fi
    
    # å¯åŠ¨ç›‘æ§
    echo "å¯åŠ¨ç›‘æ§è¿›ç¨‹..."
    /opt/monitor/gh-ost-monitor.sh --database=$database --table=$table &
    local monitor_pid=$!
    
    # æ‰§è¡ŒDDL
    echo "å¼€å§‹æ‰§è¡ŒDDLæ“ä½œ..."
    start_time=$(date +%s)
    
    gh-ost \
        --host=localhost \
        --database=$database \
        --table=$table \
        --alter="$alter_statement" \
        --execute \
        --max-load="Threads_running=25,Threads_connected=200" \
        --critical-load="Threads_running=50,Threads_connected=400" \
        --chunk-size=1000 \
        --serve-socket-file="/tmp/gh-ost-${database}-${table}.sock" \
        --postpone-cut-over-flag-file="/tmp/gh-ost-postpone" \
        --panic-flag-file="/tmp/gh-ost-panic"
    
    local exit_code=$?
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    # åœæ­¢ç›‘æ§
    kill $monitor_pid 2>/dev/null
    
    # ç»“æœæŠ¥å‘Š
    if [ $exit_code -eq 0 ]; then
        echo "âœ… DDLæ“ä½œæˆåŠŸå®Œæˆ"
        echo "æ‰§è¡Œæ—¶é—´: ${duration}ç§’"
    else
        echo "âŒ DDLæ“ä½œå¤±è´¥"
        echo "é”™è¯¯ä»£ç : $exit_code"
    fi
    
    return $exit_code
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æµ‹è¯•æ¨¡å¼: test-on-replicaæ˜¯æœ€å®‰å…¨çš„æµ‹è¯•æ–¹å¼
ğŸ”¸ ä¸€è‡´æ€§éªŒè¯: å¿…é¡»ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
ğŸ”¸ æ€§èƒ½å½±å“: éœ€è¦æ§åˆ¶åœ¨ä¸šåŠ¡å¯æ¥å—èŒƒå›´å†…
ğŸ”¸ å›æ»šèƒ½åŠ›: ç¡®ä¿æ“ä½œå¯ä»¥å®‰å…¨ä¸­æ–­å’Œå›æ»š
ğŸ”¸ è¾¹ç•Œæµ‹è¯•: éªŒè¯å„ç§æ•°æ®ç±»å‹å’Œç‰¹æ®Šæƒ…å†µ
ğŸ”¸ å‹åŠ›æµ‹è¯•: æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯ä¸‹çš„æ“ä½œ
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆæµ‹è¯•å¦‚æ­¤é‡è¦**
```
é£é™©æ§åˆ¶ï¼š
â€¢ DDLæ“ä½œå½±å“ä¸šåŠ¡å¯ç”¨æ€§
â€¢ æ•°æ®å˜æ›´å¯èƒ½å¯¼è‡´æŸå¤±
â€¢ æ€§èƒ½é—®é¢˜å½±å“ç”¨æˆ·ä½“éªŒ
â€¢ å›æ»šå›°éš¾ä¸”è€—æ—¶

æµ‹è¯•ä»·å€¼ï¼š
â€¢ éªŒè¯æ“ä½œå¯è¡Œæ€§
â€¢ è¯„ä¼°å½±å“èŒƒå›´
â€¢ ä¼˜åŒ–å‚æ•°é…ç½®
â€¢ åˆ¶å®šåº”æ€¥é¢„æ¡ˆ
```

**ğŸ”¹ æµ‹è¯•çš„å±‚æ¬¡æ€§**
```
åŠŸèƒ½æµ‹è¯• â†’ æ€§èƒ½æµ‹è¯• â†’ å‹åŠ›æµ‹è¯• â†’ ç”Ÿäº§éªŒè¯

æ¯ä¸ªå±‚æ¬¡éƒ½æœ‰ç‰¹å®šç›®æ ‡ï¼š
â€¢ åŠŸèƒ½æµ‹è¯•: éªŒè¯DDLæ“ä½œæ­£ç¡®æ€§
â€¢ æ€§èƒ½æµ‹è¯•: è¯„ä¼°å¯¹ç³»ç»Ÿçš„å½±å“
â€¢ å‹åŠ›æµ‹è¯•: éªŒè¯é«˜è´Ÿè½½ä¸‹çš„ç¨³å®šæ€§
â€¢ ç”Ÿäº§éªŒè¯: æœ€ç»ˆç¡®è®¤å¯ä»¥å®‰å…¨æ‰§è¡Œ
```

**ğŸ”¹ æµ‹è¯•å‚æ•°è°ƒä¼˜ç­–ç•¥**
```
ä¿å®ˆç­–ç•¥ (ç”Ÿäº§æ¨è):
â€¢ chunk-size: 500-1000
â€¢ max-load: Threads_running=20-30
â€¢ critical-load: Threads_running=40-60

æ¿€è¿›ç­–ç•¥ (æµ‹è¯•ç¯å¢ƒ):
â€¢ chunk-size: 2000-5000  
â€¢ max-load: Threads_running=50-80
â€¢ critical-load: Threads_running=100
```

### 12.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ æµ‹è¯•æœ€ä½³å®è·µ**
- **å®Œæ•´æµ‹è¯•**: ä»å°è§„æ¨¡åˆ°å¤§è§„æ¨¡ï¼Œä»æµ‹è¯•ç¯å¢ƒåˆ°ç”Ÿäº§ç¯å¢ƒ
- **å¤šè½®éªŒè¯**: åŠŸèƒ½â†’æ€§èƒ½â†’å‹åŠ›â†’ç”Ÿäº§å‰éªŒè¯
- **è¯¦ç»†è®°å½•**: è®°å½•æ¯æ¬¡æµ‹è¯•çš„è¯¦ç»†ç»“æœå’Œç»éªŒ
- **æŒç»­ä¼˜åŒ–**: æ ¹æ®æµ‹è¯•ç»“æœä¸æ–­ä¼˜åŒ–å‚æ•°å’Œæµç¨‹

**âš ï¸ å¸¸è§é—®é¢˜é¢„é˜²**
- **æ•°æ®ä¸ä¸€è‡´**: å……åˆ†çš„ä¸€è‡´æ€§éªŒè¯å’Œæ ¡éªŒ
- **æ€§èƒ½å½±å“**: åˆç†çš„è´Ÿè½½æ§åˆ¶å’Œå‚æ•°è°ƒä¼˜
- **æ“ä½œå¤±è´¥**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶
- **ç›‘æ§ç¼ºå¤±**: å®Œæ•´çš„ç›‘æ§ä½“ç³»å’Œå‘Šè­¦æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- æµ‹è¯•æ˜¯gh-ostæˆåŠŸä½¿ç”¨çš„å…³é”®
- test-on-replicaæ¨¡å¼æä¾›æœ€å®‰å…¨çš„æµ‹è¯•ç¯å¢ƒ
- å®Œæ•´çš„æµ‹è¯•æµç¨‹åŒ…æ‹¬åŠŸèƒ½ã€æ€§èƒ½ã€å‹åŠ›å’Œç”Ÿäº§å‰éªŒè¯
- è¯¦ç»†çš„æµ‹è¯•è®°å½•å’Œåˆ†ææ˜¯æŒç»­æ”¹è¿›çš„åŸºç¡€