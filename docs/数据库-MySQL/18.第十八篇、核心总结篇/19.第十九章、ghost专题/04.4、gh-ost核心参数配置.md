---
title: 4、gh-ost核心参数配置
---
## 📚 目录

1. [基础连接参数](#1-基础连接参数)
2. [执行模式控制](#2-执行模式控制)
3. [性能调优参数](#3-性能调优参数)
4. [安全控制参数](#4-安全控制参数)
5. [监控告警参数](#5-监控告警参数)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔗 基础连接参数


### 1.1 数据库连接配置


**🏠 host - 数据库主机地址**
```bash
# 基本用法
--host=192.168.1.100

# 常见配置
--host=localhost      # 本地数据库
--host=db.company.com # 域名方式
--host=10.0.0.50      # 内网IP
```

**💡 host参数含义**：
- 指定要连接的MySQL服务器地址
- 支持IP地址、域名、localhost等格式
- 这是告诉gh-ost"去哪里找数据库"的重要参数

**👤 user - 数据库用户**
```bash
# 用户配置
--user=gh_ost_user

# 权限要求说明
该用户需要以下权限：
✅ SELECT：读取原表数据
✅ INSERT：写入新表数据  
✅ UPDATE：更新数据状态
✅ DELETE：清理临时数据
✅ CREATE：创建影子表
✅ DROP：删除临时表
✅ ALTER：执行表结构变更
✅ REPLICATION SLAVE：读取binlog
```

**🗂️ database - 目标数据库**
```bash
# 数据库指定
--database=ecommerce

# 实际含义
指定要操作的数据库名称，比如：
- ecommerce（电商系统）
- user_center（用户中心）
- order_system（订单系统）
```

**📋 table - 目标表名称**
```bash
# 表名指定
--table=orders

# 完整示例
--database=ecommerce --table=orders
# 意思是：操作ecommerce数据库下的orders表
```

### 1.2 DDL变更语句


**🔧 alter - DDL变更语句**
```bash
# 添加索引
--alter="ADD INDEX idx_user_id (user_id)"

# 添加字段
--alter="ADD COLUMN phone VARCHAR(20) AFTER email"

# 修改字段类型
--alter="MODIFY COLUMN price DECIMAL(10,2)"

# 删除字段（谨慎使用）
--alter="DROP COLUMN old_field"
```

**💡 alter参数理解**：
- 这就是你要对表执行的SQL变更语句
- 不需要写`ALTER TABLE table_name`，只写后面的变更部分
- gh-ost会自动在影子表上执行这些变更

---

## 2. ⚙️ 执行模式控制


### 2.1 执行开关参数


**🚀 execute - 执行模式开关**
```bash
# 测试模式（默认）
gh-ost --host=localhost --user=root --table=orders --alter="ADD INDEX idx_status (status)"

# 真正执行
gh-ost --host=localhost --user=root --table=orders --alter="ADD INDEX idx_status (status)" --execute
```

**🎯 execute参数的作用**：
- **不加`--execute`**：只是测试，不会真正执行变更
- **加上`--execute`**：真正执行DDL变更操作
- 这是一个"安全开关"，防止误操作

### 2.2 副本操作模式


**🧪 test-on-replica - 副本测试模式**
```bash
# 在从库上测试
--test-on-replica --host=slave-server

使用场景：
✅ 验证变更语句是否正确
✅ 测试性能影响
✅ 确认操作流程
```

**📦 migrate-on-replica - 副本迁移模式**
```bash
# 在从库执行迁移
--migrate-on-replica --host=slave-server

实际用途：
- 在从库完成表结构变更
- 减少对主库的影响
- 适合读写分离架构
```

**⚠️ allow-on-master - 主库执行许可**
```bash
# 允许在主库执行（默认禁止）
--allow-on-master

安全提示：
🔴 生产环境需谨慎使用
🟡 建议先在测试环境验证
🟢 确保有完整备份
```

### 2.3 模式选择指导


```
操作环境选择流程：

测试阶段：
--test-on-replica → 从库测试，验证可行性

预生产：
--migrate-on-replica → 从库执行，观察影响

生产环境：
--allow-on-master → 主库执行，需要十足把握
```

---

## 3. ⚡ 性能调优参数


### 3.1 数据处理参数


**📦 chunk-size - 数据块大小**
```bash
# 默认配置
--chunk-size=1000

# 性能调优
--chunk-size=500   # 减少单次处理量，降低影响
--chunk-size=2000  # 增加处理量，提高速度
```

**🎯 chunk-size参数理解**：
- 控制每次复制多少行数据
- **数值越小**：对数据库影响越小，但耗时越长
- **数值越大**：执行速度越快，但可能影响性能
- 需要根据表大小和业务负载调整

### 3.2 复制延迟控制


**⏱️ max-lag-millis - 复制延迟限制**
```bash
# 默认延迟限制
--max-lag-millis=1500

# 严格控制（适合高并发业务）
--max-lag-millis=500

# 宽松控制（适合低峰期）
--max-lag-millis=3000
```

**💡 复制延迟控制机制**：
```
gh-ost工作流程：

1. 检查主从延迟
   ↓
2. 延迟 < max-lag-millis？
   ↓
3. 是 → 继续复制数据
   否 → 暂停等待延迟降低
```

**📊 延迟参数选择建议**：

| 业务类型 | 建议值 | 说明 |
|---------|--------|------|
| **高并发电商** | `500ms` | 严格控制，保证用户体验 |
| **一般业务** | `1500ms` | 默认值，平衡性能和影响 |
| **数据分析** | `3000ms` | 允许较高延迟，注重执行速度 |

### 3.3 节流控制


**🚦 throttle-control-replicas - 节流控制副本**
```bash
# 指定监控的从库
--throttle-control-replicas="slave1.db.com,slave2.db.com"

# 节流触发条件
--throttle-query="SELECT COUNT(*) FROM INFORMATION_SCHEMA.PROCESSLIST WHERE STATE LIKE '%copy%'"
--throttle-flag-file="/tmp/gh-ost-throttle"
```

**🎮 节流控制机制**：
```
节流触发场景：

场景1：从库延迟超限
→ 自动暂停数据复制

场景2：CPU使用率过高  
→ 通过throttle-query监控

场景3：手动干预
→ 创建throttle-flag-file文件
```

---

## 4. 🛡️ 安全控制参数


### 4.1 权限验证


**🔐 用户权限最小化原则**
```sql
-- 创建专用用户
CREATE USER 'gh_ost'@'%' IDENTIFIED BY 'secure_password';

-- 授予必需权限
GRANT SELECT, INSERT, UPDATE, DELETE, 
      CREATE, DROP, ALTER, 
      REPLICATION SLAVE 
ON target_database.* TO 'gh_ost'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4.2 预检查机制


**✅ 执行前安全检查**
```
gh-ost自动检查项目：

🔍 用户权限验证
🔍 表结构兼容性
🔍 主从复制状态  
🔍 磁盘空间充足性
🔍 binlog格式正确性
```

### 4.3 回滚准备


**📋 安全操作清单**
```bash
# 1. 备份原表（强烈建议）
mysqldump -u root -p database_name table_name > table_backup.sql

# 2. 记录当前表结构
SHOW CREATE TABLE original_table;

# 3. 执行gh-ost（带完整日志）
gh-ost \
  --host=localhost \
  --user=gh_ost \
  --database=ecommerce \
  --table=orders \
  --alter="ADD INDEX idx_status (status)" \
  --execute \
  --verbose > gh-ost.log 2>&1
```

---

## 5. 📊 监控告警参数


### 5.1 进度监控


**📈 执行状态查看**
```bash
# 详细输出模式
--verbose

# 进度报告频率
--heartbeat-interval-millis=500
```

**🖥️ 监控信息解读**：
```
典型输出示例：

2025-01-15 10:30:15 INFO Starting migration
2025-01-15 10:30:16 INFO Ghost table created
2025-01-15 10:30:17 INFO Copy: 1000/50000 (2.0%), ETA: 15m30s
2025-01-15 10:30:18 INFO Lag: 200ms, Throttling: false
```

### 5.2 性能指标


**⚡ 关键性能指标**
```
实时监控数据：

📊 复制进度：已处理行数/总行数
⏰ 预计完成时间：ETA计算
🐌 当前延迟：主从复制延迟
🚦 节流状态：是否触发暂停
💾 内存使用：处理缓冲区状态
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基础参数


```
🔸 连接参数：host, user, database, table - 告诉gh-ost去哪里操作什么
🔸 变更语句：alter - 具体要执行的表结构变更
🔸 执行开关：execute - 真正执行的安全开关  
🔸 运行模式：test-on-replica, migrate-on-replica, allow-on-master
🔸 性能控制：chunk-size, max-lag-millis - 平衡速度和影响
```

### 6.2 参数配置最佳实践


**🎯 新手推荐配置**
```bash
# 安全的测试命令
gh-ost \
  --host=test-db \
  --user=gh_ost \
  --database=test_db \
  --table=test_table \
  --alter="ADD INDEX idx_test (test_field)" \
  --chunk-size=500 \
  --max-lag-millis=1000 \
  --test-on-replica \
  --verbose
```

**🚀 生产环境配置**
```bash  
# 生产环境执行模板
gh-ost \
  --host=prod-master \
  --user=gh_ost \
  --database=production_db \
  --table=critical_table \
  --alter="ADD INDEX idx_performance (user_id, created_at)" \
  --chunk-size=1000 \
  --max-lag-millis=500 \
  --allow-on-master \
  --execute \
  --verbose
```

### 6.3 关键理解要点


**🔹 参数作用机制**
```
连接参数 → 确定操作目标
执行模式 → 控制在哪里执行  
性能参数 → 平衡速度与影响
安全参数 → 保证操作可控
监控参数 → 实时了解状态
```

**🔹 参数选择原则**
- **测试优先**：先用test-on-replica验证
- **安全第一**：生产环境必须备份
- **性能平衡**：根据业务负载调整chunk-size
- **延迟控制**：高并发业务降低max-lag-millis
- **监控到位**：使用verbose了解执行状态

### 6.4 实际应用场景


**📱 电商系统示例**
```bash
# 给订单表添加索引
gh-ost \
  --host=ecommerce-db \
  --user=gh_ost \
  --database=shop \
  --table=orders \
  --alter="ADD INDEX idx_user_status (user_id, status)" \
  --chunk-size=800 \
  --max-lag-millis=300 \
  --allow-on-master \
  --execute
```

**📊 数据分析场景**
```bash
# 给日志表添加分区字段
gh-ost \
  --host=analytics-db \
  --user=gh_ost \
  --database=logs \
  --table=access_logs \
  --alter="ADD COLUMN log_date DATE AFTER created_at" \
  --chunk-size=2000 \
  --max-lag-millis=2000 \
  --migrate-on-replica \
  --execute
```

**核心记忆口诀**：
- 连接参数定目标，执行开关保安全
- 模式选择看环境，性能参数要平衡
- 监控日志不能少，备份回滚要准备