---
title: 16、gh-ost故障排除
---
## 📚 目录

1. [故障排除概述](#1-故障排除概述)
2. [常见错误类型与处理](#2-常见错误类型与处理)
3. [权限错误排查](#3-权限错误排查)
4. [连接问题诊断](#4-连接问题诊断)
5. [性能问题分析](#5-性能问题分析)
6. [数据一致性问题](#6-数据一致性问题)
7. [系统资源问题](#7-系统资源问题)
8. [网络问题排查](#8-网络问题排查)
9. [故障恢复流程](#9-故障恢复流程)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 故障排除概述


### 1.1 什么是gh-ost故障排除


gh-ost故障排除就是当MySQL在线变更表结构出现问题时，找出问题原因并解决的过程。简单说，就是**"为什么gh-ost跑不起来或者跑到一半停了"**的问题诊断。

**为什么需要故障排除**：
- gh-ost涉及多个系统组件（MySQL主从、binlog、网络等）
- 在线变更本身就有风险，需要快速定位问题
- 生产环境不允许长时间的表变更失败

### 1.2 故障排除的基本思路


```
故障排除流程：

问题发现 → 现象分析 → 原因定位 → 解决方案 → 验证恢复

具体步骤：
1️⃣ 收集错误信息（日志、报错）
2️⃣ 分析问题类型（权限、连接、性能等）  
3️⃣ 定位根本原因（配置、环境、数据）
4️⃣ 制定解决方案（修复、回滚、重试）
5️⃣ 验证问题解决（测试、监控）
```

### 1.3 故障分类体系


| 故障类型 | **主要原因** | **影响程度** | **紧急程度** |
|---------|-------------|-------------|-------------|
| **权限错误** | 用户权限不足 | 🔴高 | ⚡立即 |
| **连接失败** | 网络或配置问题 | 🔴高 | ⚡立即 |
| **性能问题** | 负载过高 | 🟡中 | ⏱️较急 |
| **空间不足** | 磁盘空间问题 | 🔴高 | ⚡立即 |
| **数据不一致** | 同步异常 | 🔴高 | ⚡立即 |

---

## 2. ⚠️ 常见错误类型与处理


### 2.1 错误信息的解读


gh-ost的错误信息通常包含这些关键信息：
- **错误级别**：`ERROR`、`WARN`、`INFO`
- **错误组件**：`binlog`、`inspector`、`applier`
- **具体原因**：权限、连接、语法等

**典型错误信息格式**：
```
[2024-12-11 08:30:15] ERROR connection error: Access denied for user 'gh_ost'@'%' to database 'test_db'
```

### 2.2 启动阶段常见错误


**🔸 命令参数错误**

```bash
# ❌ 错误示例
gh-ost --user=root --password=123456 --host=localhost \
  --database=test --table=users --alter="ADD COLUMN age INT" \
  --execute

# 报错信息
ERROR: You must specify exactly one of --execute, --test-on-replica, --migrate-on-replica

# ✅ 正确做法
gh-ost --user=root --password=123456 --host=localhost \
  --database=test --table=users \
  --alter="ADD COLUMN age INT" \
  --execute  # 确保只有一个执行参数
```

**解决思路**：
- 检查命令行参数是否完整
- 确认必需参数都已提供
- 避免冲突参数同时使用

**🔸 表不存在错误**

```bash
# 报错信息
ERROR: Table 'test.user' doesn't exist

# 排查方法
mysql -u root -p -e "SHOW TABLES FROM test;"  # 确认表名
mysql -u root -p -e "DESC test.users;"        # 确认表结构
```

**解决方案**：
- 检查数据库名和表名拼写
- 确认表确实存在且可访问
- 注意大小写敏感问题

### 2.3 执行过程中的错误


**🔸 binlog格式错误**

```bash
# 报错信息
ERROR: binlog format is STATEMENT, required ROW

# 检查当前binlog格式
mysql> SHOW VARIABLES LIKE 'binlog_format';

# ✅ 临时修改（需要重启gh-ost）
mysql> SET GLOBAL binlog_format = 'ROW';
```

**重要提醒**：
- ROW格式是gh-ost的硬性要求
- 修改全局设置需要谨慎，影响所有连接
- 建议在维护窗口进行修改

---

## 3. 🔐 权限错误排查


### 3.1 权限问题的本质


权限问题是gh-ost最常见的故障，因为gh-ost需要在多个层面进行操作：
- **数据库层面**：读写原表、创建影子表
- **系统层面**：读取binlog、网络连接
- **复制层面**：监控主从复制状态

### 3.2 必需权限清单


**🔸 基本数据库权限**
```sql
-- gh-ost用户需要的最小权限集合
GRANT SELECT, INSERT, UPDATE, DELETE ON database_name.* TO 'gh_ost'@'%';
GRANT CREATE, DROP, ALTER ON database_name.* TO 'gh_ost'@'%';
GRANT INDEX ON database_name.* TO 'gh_ost'@'%';
```

**🔸 复制相关权限**
```sql
-- binlog读取权限
GRANT REPLICATION CLIENT ON *.* TO 'gh_ost'@'%';
GRANT REPLICATION SLAVE ON *.* TO 'gh_ost'@'%';

-- 进程查看权限
GRANT PROCESS ON *.* TO 'gh_ost'@'%';
```

### 3.3 权限问题诊断步骤


**步骤 ①** 确认用户是否存在
```sql
SELECT User, Host FROM mysql.user WHERE User = 'gh_ost';
```

**步骤 ②** 检查具体权限
```sql
SHOW GRANTS FOR 'gh_ost'@'%';
```

**步骤 ③** 测试连接权限
```bash
# 使用gh-ost相同的用户连接测试
mysql -u gh_ost -p -h hostname -P port database_name
```

### 3.4 权限错误的解决模式


```
权限错误解决流程：

识别缺失权限 → 授予对应权限 → 刷新权限缓存 → 重新测试

常用解决命令：
```sql
-- 授予权限后必须刷新
FLUSH PRIVILEGES;

-- 验证权限生效
SELECT * FROM information_schema.user_privileges 
WHERE grantee LIKE '%gh_ost%';
```

---

## 4. 🔌 连接问题诊断


### 4.1 连接失败的常见原因


连接问题往往不是单纯的网络问题，而是多个因素的组合：

**🔸 网络层面问题**
```bash
# 测试网络连通性
ping target_host
telnet target_host 3306

# 检查端口是否开放
netstat -tlnp | grep 3306
```

**🔸 MySQL服务层面**
```sql
-- 检查MySQL是否正常运行
SHOW PROCESSLIST;

-- 检查连接数限制
SHOW VARIABLES LIKE 'max_connections';
SHOW STATUS LIKE 'Threads_connected';
```

### 4.2 连接超时问题


**问题现象**：
```
ERROR: dial tcp: i/o timeout
ERROR: connection timeout after 10s
```

**诊断方法**：
```bash
# 检查网络延迟
ping -c 5 target_host

# 检查MySQL连接时间
time mysql -u username -p -h target_host -e "SELECT 1;"
```

**解决方案**：
```bash
# 增加连接超时时间
gh-ost --connect-timeout=30 \
  --user=gh_ost --password=password \
  --host=target_host \
  # ... 其他参数
```

### 4.3 主从连接问题


**🔸 从库连接失败**
```
ERROR: Cannot connect to replica host
```

**排查步骤**：
1. 确认从库地址和端口正确
2. 检查从库服务状态
3. 验证复制用户权限

```sql
-- 在主库检查从库状态
SHOW SLAVE HOSTS;

-- 在从库检查复制状态  
SHOW SLAVE STATUS\G
```

**🔸 binlog位置问题**
```
ERROR: Cannot find binlog position
```

**解决方法**：
```sql
-- 检查binlog是否开启
SHOW VARIABLES LIKE 'log_bin';

-- 查看当前binlog文件
SHOW MASTER STATUS;

-- 检查binlog文件是否存在
SHOW BINARY LOGS;
```

---

## 5. ⚡ 性能问题分析


### 5.1 性能问题的表现


性能问题不会导致gh-ost立即失败，但会影响变更效率和系统稳定性：

**常见性能现象**：
- gh-ost进度非常缓慢
- MySQL负载突然升高
- 从库复制延迟增大
- 系统响应时间变长

### 5.2 负载监控与分析


**🔸 MySQL负载指标**
```sql
-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看正在执行的查询
SHOW PROCESSLIST;

-- 查看慢查询统计
SHOW STATUS LIKE 'Slow_queries';
```

**🔸 系统资源监控**
```bash
# CPU使用率
top -p $(pgrep mysqld)

# 内存使用情况
free -h

# 磁盘IO情况
iostat -x 1 5
```

### 5.3 复制延迟问题


**问题识别**：
```sql
-- 检查从库延迟
SHOW SLAVE STATUS\G
-- 关注 Seconds_Behind_Master 字段
```

**延迟原因分析**：
```
主库写入速度 > 从库应用速度

可能原因：
1️⃣ 从库硬件性能不足
2️⃣ 网络带宽限制  
3️⃣ gh-ost批量操作过大
4️⃣ 其他应用占用从库资源
```

**调优策略**：
```bash
# 减少批量大小
gh-ost --chunk-size=500 \  # 默认1000，可适当减小

# 增加复制延迟阈值
--max-lag-millis=2000 \    # 允许2秒延迟

# 限制操作频率
--throttle-query="SELECT SLEEP(0.1)" \
```

### 5.4 性能优化建议


**🔸 硬件层面优化**
- 使用SSD提升IO性能
- 增加内存减少磁盘访问
- 确保网络带宽充足

**🔸 MySQL配置优化**
```sql
-- 调整binlog相关参数
SET GLOBAL sync_binlog = 0;           -- 临时关闭同步写入
SET GLOBAL innodb_flush_log_at_trx_commit = 2;  -- 减少磁盘同步
```

**重要警告**：生产环境谨慎修改这些参数，可能影响数据安全性。

---

## 6. 📊 数据一致性问题


### 6.1 数据一致性问题的危害


数据一致性问题是最严重的故障类型，可能导致：
- 原表和影子表数据不同步
- 数据丢失或重复
- 切换后应用程序异常

### 6.2 一致性问题的检测


**🔸 自动检测机制**
gh-ost内置了一致性检查：
```bash
# 启用一致性检查（默认开启）
gh-ost --test-on-replica \  # 在从库测试模式下检查
  --serve-socket-file=/tmp/gh-ost.sock
```

**🔸 手动验证方法**
```sql
-- 比较原表和影子表行数
SELECT COUNT(*) FROM original_table;
SELECT COUNT(*) FROM _original_table_gho;

-- 检查关键字段的校验和
SELECT COUNT(*), SUM(CRC32(CONCAT_WS(',', col1, col2, col3))) 
FROM original_table;

SELECT COUNT(*), SUM(CRC32(CONCAT_WS(',', col1, col2, col3))) 
FROM _original_table_gho;
```

### 6.3 数据不一致的原因分析


**🔸 binlog解析问题**
```
原因：binlog格式不正确或解析异常
现象：影子表缺少某些更新操作
解决：确保ROW格式，检查binlog完整性
```

**🔸 并发写入冲突**
```
原因：高并发下的数据竞争
现象：数据更新丢失或重复应用  
解决：调整chunk-size，增加延迟控制
```

### 6.4 数据一致性恢复


**发现不一致时的处理流程**：

```
立即暂停 → 分析差异 → 选择策略 → 执行恢复

处理策略：
┌─ 差异较小 → 手动修复差异数据
├─ 差异较大 → 重新执行gh-ost  
└─ 无法修复 → 回滚到原始状态
```

**实际操作示例**：
```bash
# 暂停gh-ost（如果正在运行）
echo "throttle" | nc -U /tmp/gh-ost.sock

# 分析数据差异
pt-table-checksum --databases=your_db --tables=your_table

# 根据情况选择修复或重做
```

---

## 7. 💾 系统资源问题


### 7.1 磁盘空间不足


**问题表现**：
```
ERROR: No space left on device
ERROR: Cannot create temporary table
```

**快速诊断**：
```bash
# 检查磁盘空间
df -h

# 检查MySQL数据目录空间
du -sh /var/lib/mysql/

# 查看最大的表文件
find /var/lib/mysql -name "*.ibd" -exec ls -lh {} \; | sort -k5 -hr | head -10
```

### 7.2 空间需求估算


gh-ost在执行过程中需要的磁盘空间：

```
总空间需求 = 原表大小 + 影子表大小 + binlog空间 + 临时空间

详细计算：
- 影子表：约等于原表大小  
- binlog：执行期间产生的日志
- 临时空间：索引重建等操作需要

建议预留：原表大小的 2.5-3 倍空间
```

**空间清理策略**：
```bash
# 清理旧的binlog文件（谨慎操作）
PURGE BINARY LOGS BEFORE '2024-12-10 00:00:00';

# 清理临时文件
find /tmp -name "*gh-ost*" -delete

# 优化表空间（回收删除数据的空间）
OPTIMIZE TABLE your_table;
```

### 7.3 内存不足问题


**问题现象**：
```
ERROR: Out of memory
MySQL服务重启
查询响应非常慢
```

**内存使用分析**：
```sql
-- 查看MySQL内存使用
SHOW STATUS LIKE 'Innodb_buffer_pool_pages_%';

-- 查看连接使用情况
SHOW STATUS LIKE 'Threads_connected';
SELECT * FROM performance_schema.memory_summary_global_by_event_name 
WHERE event_name LIKE 'memory%' ORDER BY current_alloc DESC LIMIT 10;
```

**内存优化方案**：
```bash
# 减少gh-ost的内存使用
gh-ost --chunk-size=200 \      # 减小批处理大小
  --max-load=Threads_running=20 \  # 限制并发线程
  --critical-load=Threads_running=50
```

---

## 8. 🌐 网络问题排查


### 8.1 网络连接稳定性


网络问题往往是间歇性的，需要持续监控：

```bash
# 持续ping测试
ping -c 100 target_host

# 监控网络连接状态
while true; do
  nc -z target_host 3306 && echo "$(date): OK" || echo "$(date): FAIL"
  sleep 5
done
```

### 8.2 网络延迟对gh-ost的影响


**高延迟环境下的调优**：
```bash
gh-ost --connect-timeout=60 \        # 增加连接超时
  --heartbeat-interval-millis=1000 \ # 增加心跳间隔  
  --nice-ratio=2.0 \                 # 降低执行频率
  # ... 其他参数
```

**网络质量评估**：
```bash
# 使用mtr检测网络质量
mtr -r -c 10 target_host

# 检查网络丢包率
ping -c 100 target_host | grep "packet loss"
```

### 8.3 防火墙和安全组问题


**常见网络访问限制**：
```bash
# 检查本地防火墙规则
iptables -L -n

# 测试端口访问
telnet target_host 3306
nc -zv target_host 3306

# 检查SELinux状态
getenforce
```

**解决网络访问问题**：
```bash
# 临时开放MySQL端口（生产环境谨慎使用）
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT

# 或者添加特定IP访问规则
iptables -A INPUT -s source_ip -p tcp --dport 3306 -j ACCEPT
```

---

## 9. 🔄 故障恢复流程


### 9.1 恢复流程概览


```
故障恢复标准流程：

问题评估 → 风险分析 → 恢复策略 → 执行恢复 → 验证结果

时间要求：
🔴 P0故障（数据不一致）: 30分钟内恢复  
🟡 P1故障（服务中断）  : 2小时内恢复
🟢 P2故障（性能影响）  : 24小时内恢复
```

### 9.2 快速恢复检查清单


**⏱️ 立即检查项（5分钟内）**
- ✅ gh-ost进程是否还在运行
- ✅ MySQL服务是否正常
- ✅ 影子表是否存在
- ✅ 原表是否被锁定
- ✅ 应用服务是否受影响

**🔍 详细检查项（15分钟内）**  
- ✅ binlog是否正常产生
- ✅ 主从复制是否正常
- ✅ 系统资源使用情况
- ✅ 错误日志详细信息
- ✅ 数据一致性快速验证

### 9.3 不同故障类型的恢复策略


**🔸 权限错误恢复**
```bash
# 步骤1：修复权限问题
mysql -u root -p -e "GRANT [required_permissions] TO 'gh_ost'@'%';"
mysql -u root -p -e "FLUSH PRIVILEGES;"

# 步骤2：验证权限
mysql -u gh_ost -p -h target_host -e "SELECT 1;"

# 步骤3：重新启动gh-ost（使用相同参数）
```

**🔸 连接失败恢复**
```bash  
# 步骤1：确认网络和服务
ping target_host && nc -z target_host 3306

# 步骤2：检查连接数限制
mysql -u root -p -e "SHOW PROCESSLIST;" | wc -l

# 步骤3：重新连接（可能需要等待）
```

**🔸 空间不足恢复**
```bash
# 步骤1：立即释放空间
# 清理日志、临时文件等

# 步骤2：评估是否可继续
# 计算剩余空间是否足够完成

# 步骤3：决定继续或中止
# 继续：清理后重启
# 中止：清理影子表
```

### 9.4 回滚操作


**何时需要回滚**：
- 数据一致性无法保证
- 系统资源严重不足
- 业务影响超过预期

**安全回滚步骤**：
```sql
-- 步骤1：停止gh-ost进程
-- kill gh-ost PID 或发送停止信号

-- 步骤2：检查并清理影子表
SHOW TABLES LIKE '%_gho';
DROP TABLE IF EXISTS `_original_table_gho`;
DROP TABLE IF EXISTS `_original_table_ghc`;

-- 步骤3：解除可能的表锁
SHOW PROCESSLIST;  -- 检查是否有锁定进程
-- 必要时 KILL 相关进程

-- 步骤4：验证原表状态
SELECT COUNT(*) FROM original_table;
SHOW CREATE TABLE original_table;
```

### 9.5 恢复后的验证


**数据完整性验证**：
```sql
-- 验证表结构
SHOW CREATE TABLE your_table;

-- 验证数据量
SELECT COUNT(*) FROM your_table;

-- 验证关键业务数据
SELECT * FROM your_table WHERE [business_critical_condition];
```

**系统性能验证**：
```bash
# 检查MySQL负载
mysqladmin -u root -p status

# 检查应用响应时间  
curl -w "Total time: %{time_total}s\n" -o /dev/null -s http://your-app/health

# 检查从库复制状态
mysql -u root -p -e "SHOW SLAVE STATUS\G" | grep -E "(Running|Behind)"
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的故障类型


```
🔸 权限错误：最常见，通过完整权限授予解决
🔸 连接问题：网络或配置引起，需逐层排查
🔸 性能问题：影响效率，通过参数调优缓解
🔸 空间不足：可能中断执行，需提前规划
🔸 数据不一致：最危险，需要立即处理
```

### 10.2 故障排除的核心原则


**🔹 快速定位原则**
```
看日志 → 查状态 → 测连接 → 验数据

优先级排序：
1. 数据安全（一致性检查）
2. 服务可用（连接恢复）  
3. 性能优化（参数调整）
```

**🔹 预防优于治疗**
```
充分测试：先在测试环境验证
资源预留：确保足够的空间和性能余量
监控预警：设置关键指标阈值
回滚准备：制定完整的回滚计划
```

### 10.3 关键排查命令速查


**系统层面**：
```bash
# 进程和资源
ps aux | grep gh-ost
df -h && free -h
netstat -tlnp | grep 3306
```

**MySQL层面**：
```sql  
-- 连接和权限
SHOW PROCESSLIST;
SHOW GRANTS FOR 'gh_ost'@'%';

-- 复制状态
SHOW SLAVE STATUS\G
SHOW MASTER STATUS;

-- 表和数据
SHOW TABLES LIKE '%_gho';
SELECT COUNT(*) FROM [table_name];
```

### 10.4 生产环境最佳实践


**🔹 执行前准备**
- ✅ 完整的权限检查
- ✅ 足够的磁盘空间（3倍原表大小）
- ✅ 网络连接稳定性测试
- ✅ 从库复制状态正常

**🔹 执行中监控**
- ✅ 实时查看gh-ost日志
- ✅ 监控系统资源使用
- ✅ 关注复制延迟变化  
- ✅ 定期检查数据一致性

**🔹 异常时处理**
- ✅ 立即分析错误类型
- ✅ 评估对业务的影响
- ✅ 选择合适的恢复策略
- ✅ 记录处理过程和经验

### 10.5 经验总结


**核心记忆要点**：
- gh-ost故障排除关键在于快速定位问题类型
- 权限和连接问题占故障的80%以上  
- 数据一致性问题虽然少见但最危险
- 预防性检查比事后处理更重要
- 完整的回滚方案是安全执行的保障

**故障排除口诀**：
```
日志先看错误码，权限连接是重点
空间性能要监控，数据一致最关键  
快速定位找根因，安全恢复是目标
```