---
title: 19ã€gh-osté«˜çº§ç‰¹æ€§
---
## ğŸ“š ç›®å½•

1. [hooksé’©å­æœºåˆ¶](#1-hooksé’©å­æœºåˆ¶)
2. [è‡ªå®šä¹‰çŠ¶æ€æ£€æŸ¥](#2-è‡ªå®šä¹‰çŠ¶æ€æ£€æŸ¥)
3. [å¤–éƒ¨å‘½ä»¤é›†æˆ](#3-å¤–éƒ¨å‘½ä»¤é›†æˆ)
4. [åŠ¨æ€é…ç½®è°ƒæ•´](#4-åŠ¨æ€é…ç½®è°ƒæ•´)
5. [æ¡ä»¶æ‰§è¡Œæ§åˆ¶](#5-æ¡ä»¶æ‰§è¡Œæ§åˆ¶)
6. [APIæ¥å£ä½¿ç”¨](#6-APIæ¥å£ä½¿ç”¨)
7. [æ‰©å±•åŠŸèƒ½å¼€å‘](#7-æ‰©å±•åŠŸèƒ½å¼€å‘)
8. [é«˜çº§å‚æ•°é…ç½®](#8-é«˜çº§å‚æ•°é…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ£ hooksé’©å­æœºåˆ¶


### 1.1 é’©å­æœºåˆ¶åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯hooksé’©å­ï¼Ÿ**
```
é’©å­å°±åƒæ˜¯åœ¨gh-ostè¿è¡Œè¿‡ç¨‹ä¸­è®¾ç½®çš„"ç›‘å¬å™¨"
å½“ç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œä½ é¢„å…ˆè®¾ç½®çš„è„šæœ¬
ç±»æ¯”ï¼šå°±åƒé—¨é“ƒå“äº†è‡ªåŠ¨å¼€ç¯ä¸€æ ·
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**
- **äº‹ä»¶è§¦å‘**ï¼šåœ¨å…³é”®èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œæ“ä½œ
- **æµç¨‹æ§åˆ¶**ï¼šæ ¹æ®å¤–éƒ¨æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶é€šçŸ¥è¿ç»´äººå‘˜
- **æ•°æ®æ ¡éªŒ**ï¼šç¡®ä¿è¿ç§»è¿‡ç¨‹çš„æ­£ç¡®æ€§

### 1.2 é’©å­ç±»å‹è¯¦è§£


**ğŸ“‹ ä¸»è¦é’©å­ç±»å‹**

| é’©å­åç§° | **è§¦å‘æ—¶æœº** | **å¸¸ç”¨åœºæ™¯** |
|---------|------------|-------------|
| `--hooks-hint` | **è¿ç§»å¼€å§‹å‰** | `ç¯å¢ƒæ£€æŸ¥ã€æƒé™éªŒè¯` |
| `--hooks-status-file` | **çŠ¶æ€å˜åŒ–æ—¶** | `è¿›åº¦ç›‘æ§ã€å‘Šè­¦é€šçŸ¥` |
| `--hooks-path` | **å„ä¸ªé˜¶æ®µ** | `ç»¼åˆç›‘æ§ç®¡ç†` |

### 1.3 é’©å­è„šæœ¬ç¤ºä¾‹


**ğŸ”§ åŸºç¡€é’©å­è„šæœ¬**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/gh-ost-hook.sh

STAGE="$1"
TABLE="$2"
PROGRESS="$3"

case "$STAGE" in
    "begin")
        echo "å¼€å§‹è¿ç§»è¡¨: $TABLE"
        # å‘é€å¼€å§‹é€šçŸ¥
        curl -X POST "http://monitoring/api/notify" \
             -d "table=$TABLE&status=start"
        ;;
    "progress") 
        echo "è¿ç§»è¿›åº¦: $PROGRESS%"
        # è®°å½•è¿›åº¦æ—¥å¿—
        echo "$(date): $TABLE è¿›åº¦ $PROGRESS%" >> /var/log/gh-ost.log
        ;;
    "success")
        echo "è¿ç§»æˆåŠŸ: $TABLE"
        # å‘é€æˆåŠŸé€šçŸ¥
        curl -X POST "http://monitoring/api/notify" \
             -d "table=$TABLE&status=success"
        ;;
esac
```

**ğŸš€ ä½¿ç”¨é’©å­è„šæœ¬**
```bash
gh-ost \
  --user="root" \
  --host="127.0.0.1" \
  --database="test_db" \
  --table="users" \
  --alter="ADD COLUMN age INT" \
  --hooks-path="/scripts/gh-ost-hook.sh" \
  --execute
```

### 1.4 é«˜çº§é’©å­åº”ç”¨


**ğŸ“Š ç›‘æ§é›†æˆé’©å­**
```bash
#!/bin/bash
# é«˜çº§ç›‘æ§é’©å­ç¤ºä¾‹

HOOK_TYPE="$1"
DATABASE="$2" 
TABLE="$3"
PROGRESS="$4"

# é…ç½®ç›‘æ§ç³»ç»Ÿæ¥å£
PROMETHEUS_GATEWAY="http://prometheus:9091"
SLACK_WEBHOOK="https://hooks.slack.com/your-webhook"

send_metrics() {
    cat <<EOF | curl --data-binary @- \
        $PROMETHEUS_GATEWAY/metrics/job/gh-ost/instance/$DATABASE
gh_ost_progress{database="$DATABASE",table="$TABLE"} $PROGRESS
gh_ost_status{database="$DATABASE",table="$TABLE"} 1
EOF
}

send_slack_notification() {
    local message="$1"
    curl -X POST -H 'Content-type: application/json' \
         --data "{\"text\":\"$message\"}" \
         $SLACK_WEBHOOK
}

case "$HOOK_TYPE" in
    "begin")
        send_slack_notification "ğŸš€ å¼€å§‹è¿ç§» $DATABASE.$TABLE"
        send_metrics
        ;;
    "progress")
        # æ¯10%è¿›åº¦å‘é€ä¸€æ¬¡æŒ‡æ ‡
        if [ $((PROGRESS % 10)) -eq 0 ]; then
            send_metrics
        fi
        ;;
    "success")
        send_slack_notification "âœ… è¿ç§»å®Œæˆ $DATABASE.$TABLE"
        send_metrics
        ;;
esac
```

---

## 2. ğŸ” è‡ªå®šä¹‰çŠ¶æ€æ£€æŸ¥


### 2.1 çŠ¶æ€æ£€æŸ¥æœºåˆ¶


**ä»€ä¹ˆæ˜¯çŠ¶æ€æ£€æŸ¥ï¼Ÿ**
```
çŠ¶æ€æ£€æŸ¥æ˜¯è®©gh-oståœ¨è¿è¡Œè¿‡ç¨‹ä¸­
ä¸»åŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼Œç¡®ä¿å®‰å…¨æ‰§è¡Œ
å°±åƒå¼€è½¦æ—¶çœ‹ä»ªè¡¨ç›˜ä¸€æ ·
```

**ğŸ¯ æ£€æŸ¥å†…å®¹**
- **ç³»ç»Ÿè´Ÿè½½**ï¼šCPUã€å†…å­˜ã€ç£ç›˜IO
- **ä¸»ä»å»¶è¿Ÿ**ï¼šç¡®ä¿å¤åˆ¶ä¸ä¼šæ–­å¼€
- **è¿æ¥æ•°é‡**ï¼šé¿å…è¿æ¥æ± è€—å°½
- **ä¸šåŠ¡æŒ‡æ ‡**ï¼šè‡ªå®šä¹‰ä¸šåŠ¡å¥åº·åº¦

### 2.2 å†…ç½®çŠ¶æ€æ£€æŸ¥


**ğŸ“ˆ ç³»ç»Ÿèµ„æºæ£€æŸ¥**
```bash
# è®¾ç½®è´Ÿè½½æ£€æŸ¥é˜ˆå€¼
gh-ost \
  --max-load="Threads_running=25,Threads_connected=1000" \
  --critical-load="Threads_running=1000,Threads_connected=5000" \
  --nice-ratio=0.5 \
  --database="test_db" \
  --table="users" \
  --alter="ADD INDEX idx_email (email)" \
  --execute
```

**â±ï¸ ä¸»ä»å»¶è¿Ÿæ£€æŸ¥**
```bash
# è®¾ç½®å¤åˆ¶å»¶è¿Ÿé™åˆ¶
gh-ost \
  --max-lag-millis=5000 \
  --replication-lag-query="SELECT SECONDS_BEHIND_MASTER FROM SHOW SLAVE STATUS" \
  --database="test_db" \
  --table="orders" \
  --alter="ADD COLUMN status ENUM('pending','completed')" \
  --execute
```

### 2.3 è‡ªå®šä¹‰çŠ¶æ€è„šæœ¬


**ğŸ”§ ä¸šåŠ¡çŠ¶æ€æ£€æŸ¥è„šæœ¬**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/business-health-check.sh

# æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åœ¨ä¸šåŠ¡é«˜å³°æœŸ
check_business_hours() {
    current_hour=$(date +%H)
    # é¿å…åœ¨ä¸Šåˆ9ç‚¹åˆ°æ™šä¸Š6ç‚¹æ‰§è¡Œ
    if [ $current_hour -ge 9 ] && [ $current_hour -le 18 ]; then
        echo "ä¸šåŠ¡é«˜å³°æœŸï¼Œæš‚åœæ“ä½œ"
        exit 1
    fi
}

# æ£€æŸ¥APIæœåŠ¡å¥åº·åº¦
check_api_health() {
    response=$(curl -s http://api-server/health)
    if [[ "$response" != *"healthy"* ]]; then
        echo "APIæœåŠ¡å¼‚å¸¸ï¼Œæš‚åœè¿ç§»"
        exit 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
check_db_connections() {
    connections=$(mysql -e "SHOW STATUS LIKE 'Threads_connected'" | tail -1 | awk '{print $2}')
    if [ $connections -gt 800 ]; then
        echo "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜: $connections"
        exit 1
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
check_business_hours
check_api_health  
check_db_connections

echo "æ‰€æœ‰æ£€æŸ¥é€šè¿‡"
exit 0
```

**ğŸš€ ä½¿ç”¨è‡ªå®šä¹‰æ£€æŸ¥**
```bash
gh-ost \
  --hooks-status-file="/scripts/business-health-check.sh" \
  --database="shop_db" \
  --table="products" \
  --alter="ADD FULLTEXT INDEX ft_description (description)" \
  --execute
```

---

## 3. ğŸ”Œ å¤–éƒ¨å‘½ä»¤é›†æˆ


### 3.1 å¤–éƒ¨å‘½ä»¤é›†æˆæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å¤–éƒ¨å‘½ä»¤é›†æˆï¼Ÿ**
```
è®©gh-ostèƒ½å¤Ÿè°ƒç”¨å…¶ä»–ç³»ç»Ÿå’Œå·¥å…·
å®ç°æ›´å¤æ‚çš„è‡ªåŠ¨åŒ–æµç¨‹
æ¯”å¦‚ï¼šå¤‡ä»½ã€ç›‘æ§ã€é€šçŸ¥ç­‰
```

**ğŸ¯ é›†æˆåœºæ™¯**
- **å¤‡ä»½ç³»ç»Ÿ**ï¼šè¿ç§»å‰è‡ªåŠ¨å¤‡ä»½
- **ç›‘æ§ç³»ç»Ÿ**ï¼šå®æ—¶ä¸ŠæŠ¥çŠ¶æ€
- **é…ç½®ç®¡ç†**ï¼šåŠ¨æ€è°ƒæ•´å‚æ•°
- **å®¡æ‰¹æµç¨‹**ï¼šéœ€è¦äººå·¥ç¡®è®¤æ—¶æš‚åœ

### 3.2 å¤‡ä»½é›†æˆç¤ºä¾‹


**ğŸ’¾ è‡ªåŠ¨å¤‡ä»½é›†æˆ**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/backup-integration.sh

DATABASE="$1"
TABLE="$2"
OPERATION="$3"

case "$OPERATION" in
    "pre-migration")
        echo "å¼€å§‹å¤‡ä»½ $DATABASE.$TABLE"
        
        # ä½¿ç”¨mysqldumpå¤‡ä»½
        backup_file="/backup/${DATABASE}_${TABLE}_$(date +%Y%m%d_%H%M%S).sql"
        mysqldump --single-transaction \
                  --routines --triggers \
                  $DATABASE $TABLE > $backup_file
        
        if [ $? -eq 0 ]; then
            echo "å¤‡ä»½æˆåŠŸ: $backup_file"
            # å°†å¤‡ä»½ä¿¡æ¯å†™å…¥çŠ¶æ€æ–‡ä»¶
            echo "backup_file=$backup_file" > /tmp/gh-ost-backup.status
        else
            echo "å¤‡ä»½å¤±è´¥ï¼Œåœæ­¢è¿ç§»"
            exit 1
        fi
        ;;
        
    "post-migration")
        echo "è¿ç§»å®Œæˆï¼Œæ¸…ç†æ—§å¤‡ä»½"
        # æ¸…ç†7å¤©å‰çš„å¤‡ä»½
        find /backup -name "${DATABASE}_${TABLE}_*.sql" -mtime +7 -delete
        ;;
esac
```

### 3.3 ç›‘æ§ç³»ç»Ÿé›†æˆ


**ğŸ“Š Prometheusç›‘æ§é›†æˆ**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/prometheus-integration.sh

METRICS_FILE="/tmp/gh-ost-metrics.prom"
PUSH_GATEWAY="http://prometheus-pushgateway:9091"

# ç”ŸæˆPrometheusæŒ‡æ ‡
generate_metrics() {
    local database="$1"
    local table="$2" 
    local progress="$3"
    local stage="$4"
    
    cat > $METRICS_FILE <<EOF
# HELP gh_ost_migration_progress Migration progress percentage
# TYPE gh_ost_migration_progress gauge
gh_ost_migration_progress{database="$database",table="$table"} $progress

# HELP gh_ost_migration_stage Current migration stage  
# TYPE gh_ost_migration_stage gauge
gh_ost_migration_stage{database="$database",table="$table",stage="$stage"} 1
EOF
}

# æ¨é€æŒ‡æ ‡åˆ°Prometheus
push_metrics() {
    curl -X POST --data-binary @$METRICS_FILE \
         "$PUSH_GATEWAY/metrics/job/gh-ost/instance/$(hostname)"
}

# ä¸»é€»è¾‘
DATABASE="$2"
TABLE="$3"
PROGRESS="${4:-0}"
STAGE="$1"

generate_metrics "$DATABASE" "$TABLE" "$PROGRESS" "$STAGE"
push_metrics

echo "ç›‘æ§æŒ‡æ ‡å·²æ¨é€"
```

### 3.4 å®¡æ‰¹æµç¨‹é›†æˆ


**âœ‹ äººå·¥å®¡æ‰¹é›†æˆ**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/approval-integration.sh

STAGE="$1"
DATABASE="$2"
TABLE="$3"

case "$STAGE" in
    "begin")
        echo "è¯·æ±‚å¼€å§‹è¿ç§»å®¡æ‰¹: $DATABASE.$TABLE"
        
        # å‘é€å®¡æ‰¹è¯·æ±‚åˆ°å·¥ä½œæµç³»ç»Ÿ
        approval_id=$(curl -s -X POST \
            "http://workflow-api/approvals" \
            -H "Content-Type: application/json" \
            -d "{
                \"type\": \"database_migration\",
                \"database\": \"$DATABASE\",
                \"table\": \"$TABLE\",
                \"requestor\": \"$(whoami)\"
            }" | jq -r '.approval_id')
        
        echo "å®¡æ‰¹ID: $approval_id"
        
        # ç­‰å¾…å®¡æ‰¹ç»“æœ
        while true; do
            status=$(curl -s "http://workflow-api/approvals/$approval_id" | jq -r '.status')
            
            case "$status" in
                "approved")
                    echo "å®¡æ‰¹é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ"
                    exit 0
                    ;;
                "rejected")
                    echo "å®¡æ‰¹è¢«æ‹’ç»ï¼Œåœæ­¢æ‰§è¡Œ"
                    exit 1
                    ;;
                "pending")
                    echo "ç­‰å¾…å®¡æ‰¹ä¸­..."
                    sleep 30
                    ;;
            esac
        done
        ;;
esac
```

---

## 4. âš™ï¸ åŠ¨æ€é…ç½®è°ƒæ•´


### 4.1 åŠ¨æ€é…ç½®æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯åŠ¨æ€é…ç½®ï¼Ÿ**
```
åœ¨gh-ostè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®å®æ—¶æƒ…å†µ
è°ƒæ•´è¿è¡Œå‚æ•°ï¼Œè€Œä¸éœ€è¦é‡å¯
å°±åƒå¼€è½¦æ—¶è°ƒæ•´é€Ÿåº¦ä¸€æ ·
```

**ğŸ¯ å¯è°ƒæ•´çš„é…ç½®**
- **æ‰§è¡Œé€Ÿåº¦**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´
- **æ£€æŸ¥é¢‘ç‡**ï¼šåŠ¨æ€è°ƒæ•´ç›‘æ§é—´éš”
- **èµ„æºé™åˆ¶**ï¼šæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´é˜ˆå€¼
- **æš‚åœæ¢å¤**ï¼šä¸´æ—¶æš‚åœå’Œæ¢å¤æ‰§è¡Œ

### 4.2 Socketæ¥å£æ§åˆ¶


**ğŸ”Œ å¯ç”¨Socketæ§åˆ¶**
```bash
# å¯ç”¨Unix Socketæ§åˆ¶æ¥å£
gh-ost \
  --user="root" \
  --database="test_db" \
  --table="users" \
  --alter="ADD INDEX idx_name (name)" \
  --serve-socket-file="/tmp/gh-ost.sock" \
  --execute
```

**ğŸ“¡ é€šè¿‡Socketå‘é€å‘½ä»¤**
```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
echo "status" | socat - /tmp/gh-ost.sock

# æš‚åœæ‰§è¡Œ
echo "throttle" | socat - /tmp/gh-ost.sock

# æ¢å¤æ‰§è¡Œ  
echo "no-throttle" | socat - /tmp/gh-ost.sock

# è°ƒæ•´æ‰§è¡Œé€Ÿåº¦ï¼ˆæ¯ç§’å¤„ç†è¡Œæ•°ï¼‰
echo "chunk-size=500" | socat - /tmp/gh-ost.sock

# è°ƒæ•´è´Ÿè½½é˜ˆå€¼
echo "max-load=Threads_running=30" | socat - /tmp/gh-ost.sock
```

### 4.3 HTTP APIæ§åˆ¶


**ğŸŒ å¯ç”¨HTTPæ¥å£**
```bash
gh-ost \
  --user="root" \
  --database="test_db" \
  --table="orders" \
  --alter="ADD COLUMN updated_at TIMESTAMP" \
  --serve-tcp-port=8089 \
  --execute
```

**ğŸ“± HTTP APIä½¿ç”¨ç¤ºä¾‹**
```bash
# è·å–çŠ¶æ€ä¿¡æ¯
curl http://localhost:8089/api/status

# æš‚åœæ‰§è¡Œ
curl -X POST http://localhost:8089/api/throttle

# æ¢å¤æ‰§è¡Œ
curl -X POST http://localhost:8089/api/no-throttle

# è·å–è¿›åº¦ä¿¡æ¯
curl http://localhost:8089/api/migrate-tables
```

### 4.4 è‡ªåŠ¨åŒ–é…ç½®è°ƒæ•´è„šæœ¬


**ğŸ¤– æ™ºèƒ½é…ç½®è°ƒæ•´**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/auto-tune.sh

SOCKET_FILE="/tmp/gh-ost.sock"

# è·å–å½“å‰ç³»ç»Ÿè´Ÿè½½
get_system_load() {
    uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs
}

# è·å–MySQLè¿æ¥æ•°
get_mysql_connections() {
    mysql -e "SHOW STATUS LIKE 'Threads_connected'" | tail -1 | awk '{print $2}'
}

# åŠ¨æ€è°ƒæ•´chunk size
adjust_chunk_size() {
    local load=$(get_system_load)
    local connections=$(get_mysql_connections)
    
    if (( $(echo "$load > 2.0" | bc -l) )); then
        # é«˜è´Ÿè½½æ—¶å‡å°chunk size
        echo "chunk-size=200" | socat - $SOCKET_FILE
        echo "ç³»ç»Ÿé«˜è´Ÿè½½ï¼Œé™ä½å¤„ç†é€Ÿåº¦"
    elif [ $connections -gt 500 ]; then
        # è¿æ¥æ•°å¤šæ—¶å‡å°chunk size  
        echo "chunk-size=300" | socat - $SOCKET_FILE
        echo "è¿æ¥æ•°è¾ƒå¤šï¼Œé€‚å½“é™ä½é€Ÿåº¦"
    else
        # æ­£å¸¸æƒ…å†µä½¿ç”¨é»˜è®¤å€¼
        echo "chunk-size=1000" | socat - $SOCKET_FILE
        echo "ç³»ç»Ÿæ­£å¸¸ï¼Œä½¿ç”¨æ­£å¸¸é€Ÿåº¦"
    fi
}

# å®šæœŸè°ƒæ•´é…ç½®
while true; do
    adjust_chunk_size
    sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
```

---

## 5. ğŸ® æ¡ä»¶æ‰§è¡Œæ§åˆ¶


### 5.1 æ¡ä»¶æ‰§è¡Œæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ¡ä»¶æ‰§è¡Œï¼Ÿ**
```
æ ¹æ®é¢„è®¾çš„æ¡ä»¶æ¥å†³å®šæ˜¯å¦æ‰§è¡Œè¿ç§»
æˆ–è€…åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ ¹æ®æ¡ä»¶æš‚åœ/ç»§ç»­
å°±åƒçº¢ç»¿ç¯æ§åˆ¶äº¤é€šä¸€æ ·
```

**ğŸ¯ å¸¸è§æ¡ä»¶**
- **æ—¶é—´çª—å£**ï¼šåªåœ¨ç‰¹å®šæ—¶é—´æ‰§è¡Œ
- **ç³»ç»ŸçŠ¶æ€**ï¼šè´Ÿè½½ä½æ—¶æ‰æ‰§è¡Œ
- **ä¸šåŠ¡çŠ¶æ€**ï¼šä¸šåŠ¡ç©ºé—²æ—¶æ‰§è¡Œ
- **ä¾èµ–æ£€æŸ¥**ï¼šå‰ç½®æ¡ä»¶æ»¡è¶³æ—¶æ‰§è¡Œ

### 5.2 æ—¶é—´çª—å£æ§åˆ¶


**â° æ—¶é—´çª—å£è„šæœ¬**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/time-window-check.sh

# æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸çš„æ—¶é—´çª—å£å†…
check_time_window() {
    current_hour=$(date +%H)
    current_day=$(date +%u)  # 1=Monday, 7=Sunday
    
    # åªåœ¨å‡Œæ™¨2ç‚¹åˆ°6ç‚¹ä¹‹é—´æ‰§è¡Œ
    if [ $current_hour -lt 2 ] || [ $current_hour -gt 6 ]; then
        echo "ä¸åœ¨ç»´æŠ¤æ—¶é—´çª—å£å†… (02:00-06:00)"
        exit 1
    fi
    
    # ä¸åœ¨å‘¨æœ«æ‰§è¡Œ
    if [ $current_day -eq 6 ] || [ $current_day -eq 7 ]; then
        echo "å‘¨æœ«ä¸æ‰§è¡Œè¿ç§»æ“ä½œ"
        exit 1
    fi
    
    echo "æ—¶é—´çª—å£æ£€æŸ¥é€šè¿‡"
}

check_time_window
```

**ğŸš€ é›†æˆæ—¶é—´çª—å£æ£€æŸ¥**
```bash
gh-ost \
  --user="root" \
  --database="test_db" \
  --table="logs" \
  --alter="ADD INDEX idx_created_at (created_at)" \
  --hooks-hint="/scripts/time-window-check.sh" \
  --execute
```

### 5.3 ä¸šåŠ¡çŠ¶æ€æ¡ä»¶


**ğŸ“Š ä¸šåŠ¡è´Ÿè½½æ£€æŸ¥**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/business-load-check.sh

# æ£€æŸ¥APIè¯·æ±‚é‡
check_api_load() {
    # è·å–æœ€è¿‘5åˆ†é’Ÿçš„APIè¯·æ±‚æ•°
    api_requests=$(curl -s "http://monitoring/api/metrics/requests?window=5m" | jq '.count')
    
    if [ $api_requests -gt 1000 ]; then
        echo "APIè¯·æ±‚é‡è¿‡é«˜: $api_requests/5minï¼Œæš‚åœè¿ç§»"
        exit 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“QPS
check_db_qps() {
    qps=$(mysql -e "SHOW STATUS LIKE 'Queries'" | tail -1 | awk '{print $2}')
    sleep 1
    qps_new=$(mysql -e "SHOW STATUS LIKE 'Queries'" | tail -1 | awk '{print $2}')
    current_qps=$((qps_new - qps))
    
    if [ $current_qps -gt 500 ]; then
        echo "æ•°æ®åº“QPSè¿‡é«˜: $current_qpsï¼Œæš‚åœè¿ç§»"
        exit 1
    fi
}

# æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
check_cache_hit_rate() {
    hit_rate=$(curl -s "http://redis-monitor/stats" | jq '.hit_rate')
    
    if (( $(echo "$hit_rate < 0.8" | bc -l) )); then
        echo "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: $hit_rateï¼Œå¯èƒ½å½±å“æ€§èƒ½"
        exit 1
    fi
}

echo "å¼€å§‹ä¸šåŠ¡è´Ÿè½½æ£€æŸ¥..."
check_api_load
check_db_qps
check_cache_hit_rate
echo "ä¸šåŠ¡è´Ÿè½½æ£€æŸ¥é€šè¿‡"
```

### 5.4 ä¾èµ–æ¡ä»¶æ£€æŸ¥


**ğŸ”— ä¾èµ–æœåŠ¡æ£€æŸ¥**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/dependency-check.sh

# æ£€æŸ¥å¿…è¦æœåŠ¡çŠ¶æ€
check_services() {
    local services=("redis" "elasticsearch" "rabbitmq")
    
    for service in "${services[@]}"; do
        if ! systemctl is-active --quiet $service; then
            echo "ä¾èµ–æœåŠ¡ $service æœªè¿è¡Œ"
            exit 1
        fi
    done
}

# æ£€æŸ¥æ•°æ®åº“ä¸»ä»çŠ¶æ€
check_replication() {
    slave_status=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Slave_SQL_Running" | awk '{print $2}')
    
    if [ "$slave_status" != "Yes" ]; then
        echo "ä¸»ä»å¤åˆ¶å¼‚å¸¸ï¼ŒSQLçº¿ç¨‹æœªè¿è¡Œ"
        exit 1  
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    disk_usage=$(df /var/lib/mysql | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [ $disk_usage -gt 80 ]; then
        echo "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${disk_usage}%"
        exit 1
    fi
}

echo "å¼€å§‹ä¾èµ–æ¡ä»¶æ£€æŸ¥..."
check_services
check_replication  
check_disk_space
echo "ä¾èµ–æ¡ä»¶æ£€æŸ¥é€šè¿‡"
```

---

## 6. ğŸŒ APIæ¥å£ä½¿ç”¨


### 6.1 APIæ¥å£æ¦‚è¿°


**ä»€ä¹ˆæ˜¯gh-ost APIï¼Ÿ**
```
gh-ostæä¾›HTTPå’ŒSocketä¸¤ç§APIæ¥å£
è®©ä½ å¯ä»¥é€šè¿‡ç¨‹åºæ¥ç›‘æ§å’Œæ§åˆ¶è¿ç§»è¿‡ç¨‹
å°±åƒé¥æ§å™¨æ§åˆ¶ç”µè§†ä¸€æ ·
```

**ğŸ¯ APIåŠŸèƒ½**
- **çŠ¶æ€æŸ¥è¯¢**ï¼šè·å–è¿ç§»è¿›åº¦å’ŒçŠ¶æ€
- **å‚æ•°è°ƒæ•´**ï¼šåŠ¨æ€ä¿®æ”¹è¿è¡Œå‚æ•°
- **æµç¨‹æ§åˆ¶**ï¼šæš‚åœã€æ¢å¤ã€åœæ­¢æ“ä½œ
- **ä¿¡æ¯è·å–**ï¼šè·å–è¯¦ç»†çš„è¿è¡Œä¿¡æ¯

### 6.2 HTTP APIè¯¦è§£


**ğŸ“¡ å¯åŠ¨HTTPæœåŠ¡**
```bash
gh-ost \
  --user="root" \
  --database="test_db" \
  --table="users" \
  --alter="ADD COLUMN phone VARCHAR(20)" \
  --serve-tcp-port=8089 \
  --execute
```

**ğŸ” APIç«¯ç‚¹è¯´æ˜**

| ç«¯ç‚¹ | **æ–¹æ³•** | **åŠŸèƒ½** | **è¿”å›å†…å®¹** |
|------|---------|---------|-------------|
| `/api/status` | `GET` | `è·å–çŠ¶æ€` | `è¿›åº¦ã€é˜¶æ®µã€ç»Ÿè®¡ä¿¡æ¯` |
| `/api/migrate-tables` | `GET` | `è·å–è¡¨ä¿¡æ¯` | `åŸè¡¨ã€å½±å­è¡¨ä¿¡æ¯` |
| `/api/throttle` | `POST` | `æš‚åœæ‰§è¡Œ` | `æ“ä½œç»“æœ` |
| `/api/no-throttle` | `POST` | `æ¢å¤æ‰§è¡Œ` | `æ“ä½œç»“æœ` |

### 6.3 APIä½¿ç”¨ç¤ºä¾‹


**ğŸ“Š çŠ¶æ€ç›‘æ§è„šæœ¬**
```python
#!/usr/bin/env python3
# æ–‡ä»¶ï¼šgh-ost-monitor.py

import requests
import time
import json

class GhOstMonitor:
    def __init__(self, host="localhost", port=8089):
        self.base_url = f"http://{host}:{port}/api"
    
    def get_status(self):
        """è·å–è¿ç§»çŠ¶æ€"""
        try:
            response = requests.get(f"{self.base_url}/status")
            return response.json()
        except Exception as e:
            print(f"è·å–çŠ¶æ€å¤±è´¥: {e}")
            return None
    
    def get_progress(self):
        """è·å–è¿ç§»è¿›åº¦"""
        status = self.get_status()
        if status:
            return {
                'progress': status.get('progress', 0),
                'eta': status.get('eta', 'unknown'),
                'current_lag': status.get('current_lag', 0)
            }
        return None
    
    def throttle(self):
        """æš‚åœè¿ç§»"""
        try:
            response = requests.post(f"{self.base_url}/throttle")
            return response.status_code == 200
        except:
            return False
    
    def unthrottle(self):
        """æ¢å¤è¿ç§»"""
        try:
            response = requests.post(f"{self.base_url}/no-throttle")
            return response.status_code == 200
        except:
            return False

# ä½¿ç”¨ç¤ºä¾‹
monitor = GhOstMonitor()

while True:
    progress = monitor.get_progress()
    if progress:
        print(f"è¿›åº¦: {progress['progress']}%, "
              f"é¢„è®¡å®Œæˆ: {progress['eta']}, "
              f"å»¶è¿Ÿ: {progress['current_lag']}ms")
    
    time.sleep(10)
```

### 6.4 WebSocketå®æ—¶ç›‘æ§


**ğŸ”„ å®æ—¶ç›‘æ§é¡µé¢**
```html
<!DOCTYPE html>
<html>
<head>
    <title>gh-ost å®æ—¶ç›‘æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div>
        <h1>gh-ost è¿ç§»ç›‘æ§</h1>
        <div id="status">è¿æ¥ä¸­...</div>
        <canvas id="progressChart" width="400" height="200"></canvas>
        
        <button onclick="pauseMigration()">æš‚åœ</button>
        <button onclick="resumeMigration()">æ¢å¤</button>
    </div>

    <script>
        // è¿›åº¦å›¾è¡¨
        const ctx = document.getElementById('progressChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'è¿ç§»è¿›åº¦',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            }
        });

        // å®šæœŸè·å–çŠ¶æ€
        function updateStatus() {
            fetch('http://localhost:8089/api/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('status').innerHTML = 
                        `è¿›åº¦: ${data.progress}% | çŠ¶æ€: ${data.state}`;
                    
                    // æ›´æ–°å›¾è¡¨
                    const now = new Date().toLocaleTimeString();
                    chart.data.labels.push(now);
                    chart.data.datasets[0].data.push(data.progress);
                    
                    // ä¿æŒæœ€è¿‘20ä¸ªæ•°æ®ç‚¹
                    if (chart.data.labels.length > 20) {
                        chart.data.labels.shift();
                        chart.data.datasets[0].data.shift();
                    }
                    
                    chart.update();
                });
        }

        // æ§åˆ¶å‡½æ•°
        function pauseMigration() {
            fetch('http://localhost:8089/api/throttle', {method: 'POST'});
        }

        function resumeMigration() {
            fetch('http://localhost:8089/api/no-throttle', {method: 'POST'});
        }

        // æ¯5ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(updateStatus, 5000);
        updateStatus();
    </script>
</body>
</html>
```

---

## 7. ğŸ”§ æ‰©å±•åŠŸèƒ½å¼€å‘


### 7.1 æ‰©å±•å¼€å‘æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ‰©å±•åŠŸèƒ½ï¼Ÿ**
```
åŸºäºgh-ostçš„é’©å­å’ŒAPIæœºåˆ¶
å¼€å‘è‡ªå®šä¹‰çš„åŠŸèƒ½æ¨¡å—
è®©gh-osté€‚åº”ç‰¹å®šçš„ä¸šåŠ¡éœ€æ±‚
```

**ğŸ¯ æ‰©å±•åœºæ™¯**
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šä¸è¿ç»´ç³»ç»Ÿé›†æˆ
- **ç›‘æ§å‘Šè­¦**ï¼šå®šåˆ¶åŒ–ç›‘æ§æ–¹æ¡ˆ  
- **æ•°æ®æ ¡éªŒ**ï¼šè‡ªå®šä¹‰æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- **æµç¨‹ç¼–æ’**ï¼šå¤æ‚çš„è¿ç§»æµç¨‹ç®¡ç†

### 7.2 æ’ä»¶æ¶æ„è®¾è®¡


**ğŸ—ï¸ æ’ä»¶ç³»ç»Ÿæ¡†æ¶**
```bash
# ç›®å½•ç»“æ„
/opt/gh-ost-plugins/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ plugin_manager.sh      # æ’ä»¶ç®¡ç†å™¨
â”‚   â””â”€â”€ hooks_dispatcher.sh    # é’©å­åˆ†å‘å™¨
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ backup/               # å¤‡ä»½æ’ä»¶
â”‚   â”œâ”€â”€ monitor/              # ç›‘æ§æ’ä»¶
â”‚   â”œâ”€â”€ validate/             # æ ¡éªŒæ’ä»¶
â”‚   â””â”€â”€ notify/               # é€šçŸ¥æ’ä»¶
â””â”€â”€ config/
    â””â”€â”€ plugins.conf          # æ’ä»¶é…ç½®
```

**ğŸ”Œ æ’ä»¶ç®¡ç†å™¨**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/opt/gh-ost-plugins/core/plugin_manager.sh

PLUGIN_DIR="/opt/gh-ost-plugins/plugins"
CONFIG_FILE="/opt/gh-ost-plugins/config/plugins.conf"

# åŠ è½½æ’ä»¶é…ç½®
load_plugin_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    fi
}

# æ‰§è¡Œæ’ä»¶
execute_plugin() {
    local plugin_name="$1"
    local hook_type="$2"
    shift 2
    local args="$@"
    
    local plugin_script="$PLUGIN_DIR/$plugin_name/main.sh"
    
    if [ -f "$plugin_script" ] && [ -x "$plugin_script" ]; then
        echo "æ‰§è¡Œæ’ä»¶: $plugin_name ($hook_type)"
        "$plugin_script" "$hook_type" $args
        return $?
    else
        echo "æ’ä»¶ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ: $plugin_name"
        return 1
    fi
}

# æ‰§è¡Œæ‰€æœ‰å¯ç”¨çš„æ’ä»¶
execute_enabled_plugins() {
    local hook_type="$1"
    shift
    local args="$@"
    
    load_plugin_config
    
    for plugin in $ENABLED_PLUGINS; do
        execute_plugin "$plugin" "$hook_type" $args
        if [ $? -ne 0 ]; then
            echo "æ’ä»¶ $plugin æ‰§è¡Œå¤±è´¥"
            return 1
        fi
    done
}

# ä¸»å…¥å£
execute_enabled_plugins "$@"
```

### 7.3 ç›‘æ§æ’ä»¶ç¤ºä¾‹


**ğŸ“Š å…¨é¢ç›‘æ§æ’ä»¶**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/opt/gh-ost-plugins/plugins/monitor/main.sh

PLUGIN_NAME="monitor"
LOG_FILE="/var/log/gh-ost-monitor.log"
METRICS_DIR="/tmp/gh-ost-metrics"

# åˆ›å»ºå¿…è¦ç›®å½•
mkdir -p "$METRICS_DIR"

# è®°å½•æ—¥å¿—
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$PLUGIN_NAME] $1" >> "$LOG_FILE"
}

# æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
collect_system_metrics() {
    local database="$1"
    local table="$2"
    
    # CPUä½¿ç”¨ç‡
    cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    
    # å†…å­˜ä½¿ç”¨ç‡
    mem_usage=$(free | grep Mem | awk '{printf "%.2f", $3/$2 * 100.0}')
    
    # ç£ç›˜IO
    disk_io=$(iostat -x 1 1 | tail -1 | awk '{print $10}')
    
    # å†™å…¥æŒ‡æ ‡æ–‡ä»¶
    cat > "$METRICS_DIR/system.metrics" <<EOF
cpu_usage=$cpu_usage
memory_usage=$mem_usage
disk_io_util=$disk_io
timestamp=$(date +%s)
database=$database
table=$table
EOF
    
    log_message "ç³»ç»ŸæŒ‡æ ‡æ”¶é›†å®Œæˆ: CPU=$cpu_usage%, MEM=$mem_usage%, DISK_IO=$disk_io%"
}

# æ”¶é›†MySQLæŒ‡æ ‡
collect_mysql_metrics() {
    local metrics_file="$METRICS_DIR/mysql.metrics"
    
    mysql -e "
    SELECT 
        variable_name, 
        variable_value 
    FROM performance_schema.global_status 
    WHERE variable_name IN (
        'Threads_connected',
        'Threads_running', 
        'Queries',
        'Innodb_rows_read',
        'Innodb_rows_inserted',
        'Innodb_rows_updated',
        'Innodb_rows_deleted'
    )
    " | tail -n +2 > "$metrics_file"
    
    log_message "MySQLæŒ‡æ ‡æ”¶é›†å®Œæˆ"
}

# å‘é€å‘Šè­¦
send_alert() {
    local level="$1"
    local message="$2"
    local database="$3"
    local table="$4"
    
    # å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿ
    curl -X POST "http://alertmanager:9093/api/v1/alerts" \
         -H "Content-Type: application/json" \
         -d "[{
             \"labels\": {
                 \"alertname\": \"GhOstMigration\",
                 \"severity\": \"$level\",
                 \"database\": \"$database\",
                 \"table\": \"$table\"
             },
             \"annotations\": {
                 \"summary\": \"$message\"
             }
         }]"
    
    log_message "å‘Šè­¦å‘é€: $level - $message"
}

# æ’ä»¶ä¸»é€»è¾‘
main() {
    local hook_type="$1"
    local database="$2"
    local table="$3"
    local progress="$4"
    
    case "$hook_type" in
        "begin")
            log_message "å¼€å§‹ç›‘æ§è¿ç§»: $database.$table"
            collect_system_metrics "$database" "$table"
            collect_mysql_metrics
            send_alert "info" "Migration started" "$database" "$table"
            ;;
            
        "progress")
            if [ $((progress % 10)) -eq 0 ]; then
                log_message "è¿ç§»è¿›åº¦: $progress%"
                collect_system_metrics "$database" "$table"
                collect_mysql_metrics
            fi
            ;;
            
        "success")
            log_message "è¿ç§»å®Œæˆ: $database.$table"
            send_alert "info" "Migration completed successfully" "$database" "$table"
            ;;
            
        "error")
            log_message "è¿ç§»å¤±è´¥: $database.$table"
            send_alert "critical" "Migration failed" "$database" "$table"
            ;;
    esac
}

main "$@"
```

### 7.4 æ•°æ®æ ¡éªŒæ’ä»¶


**âœ… æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/opt/gh-ost-plugins/plugins/validate/main.sh

PLUGIN_NAME="validate"
LOG_FILE="/var/log/gh-ost-validate.log"

# è®°å½•æ—¥å¿—
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$PLUGIN_NAME] $1" >> "$LOG_FILE"
}

# æ ¡éªŒæ•°æ®ä¸€è‡´æ€§
validate_data_consistency() {
    local database="$1"
    local original_table="$2"
    local ghost_table="_${original_table}_gho"
    
    log_message "å¼€å§‹æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ: $database.$original_table"
    
    # æ£€æŸ¥è¡Œæ•°
    local original_count=$(mysql -N -e "SELECT COUNT(*) FROM $database.$original_table")
    local ghost_count=$(mysql -N -e "SELECT COUNT(*) FROM $database.$ghost_table")
    
    if [ "$original_count" -ne "$ghost_count" ]; then
        log_message "è¡Œæ•°ä¸ä¸€è‡´: åŸè¡¨=$original_count, å½±å­è¡¨=$ghost_count"
        return 1
    fi
    
    # æ£€æŸ¥æ ¡éªŒå’Œ
    local original_checksum=$(mysql -N -e "CHECKSUM TABLE $database.$original_table" | awk '{print $2}')
    local ghost_checksum=$(mysql -N -e "CHECKSUM TABLE $database.$ghost_table" | awk '{print $2}')
    
    if [ "$original_checksum" != "$ghost_checksum" ]; then
        log_message "æ ¡éªŒå’Œä¸ä¸€è‡´: åŸè¡¨=$original_checksum, å½±å­è¡¨=$ghost_checksum"
        return 1
    fi
    
    log_message "æ•°æ®ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"
    return 0
}

# æŠ½æ ·æ•°æ®å¯¹æ¯”
sample_data_comparison() {
    local database="$1"
    local original_table="$2"
    local ghost_table="_${original_table}_gho"
    local sample_size=1000
    
    log_message "å¼€å§‹æŠ½æ ·æ•°æ®å¯¹æ¯”"
    
    # éšæœºæŠ½å–æ ·æœ¬è¿›è¡Œå¯¹æ¯”
    mysql -e "
    CREATE TEMPORARY TABLE temp_sample AS
    SELECT * FROM $database.$original_table 
    ORDER BY RAND() 
    LIMIT $sample_size;
    
    SELECT 
        'MISMATCH' as status,
        o.*
    FROM temp_sample o
    LEFT JOIN $database.$ghost_table g ON o.id = g.id
    WHERE g.id IS NULL OR 
          o.name != g.name OR 
          o.email != g.email
    LIMIT 10;
    " > /tmp/sample_validation.result
    
    if [ -s /tmp/sample_validation.result ]; then
        log_message "å‘ç°æ•°æ®ä¸ä¸€è‡´ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ /tmp/sample_validation.result"
        return 1
    else
        log_message "æŠ½æ ·æ•°æ®å¯¹æ¯”é€šè¿‡"
        return 0
    fi
}

# æ’ä»¶ä¸»é€»è¾‘
main() {
    local hook_type="$1"
    local database="$2"
    local table="$3"
    
    case "$hook_type" in
        "before-cut-over")
            log_message "åˆ‡æ¢å‰æ•°æ®æ ¡éªŒå¼€å§‹"
            
            if validate_data_consistency "$database" "$table"; then
                log_message "åŸºç¡€ä¸€è‡´æ€§æ ¡éªŒé€šè¿‡"
            else
                log_message "åŸºç¡€ä¸€è‡´æ€§æ ¡éªŒå¤±è´¥ï¼Œåœæ­¢è¿ç§»"
                exit 1
            fi
            
            if sample_data_comparison "$database" "$table"; then
                log_message "æŠ½æ ·æ•°æ®å¯¹æ¯”é€šè¿‡"
            else
                log_message "æŠ½æ ·æ•°æ®å¯¹æ¯”å¤±è´¥ï¼Œåœæ­¢è¿ç§»"
                exit 1
            fi
            
            log_message "æ‰€æœ‰æ ¡éªŒé€šè¿‡ï¼Œå…è®¸åˆ‡æ¢"
            ;;
    esac
}

main "$@"
```

---

## 8. âš™ï¸ é«˜çº§å‚æ•°é…ç½®


### 8.1 æ€§èƒ½è°ƒä¼˜å‚æ•°


**ğŸš€ æ‰§è¡Œæ•ˆç‡å‚æ•°**

| å‚æ•° | **é»˜è®¤å€¼** | **è¯´æ˜** | **è°ƒä¼˜å»ºè®®** |
|------|-----------|---------|-------------|
| `--chunk-size` | `1000` | `æ¯æ¬¡å¤„ç†çš„è¡Œæ•°` | `é«˜é…ç½®å¯ç”¨2000-5000` |
| `--max-lag-millis` | `1500` | `æœ€å¤§å¤åˆ¶å»¶è¿Ÿ(ms)` | `SSDå¯ç”¨500-1000` |
| `--nice-ratio` | `0` | `é™æµæ¯”ä¾‹` | `ä¸šåŠ¡ç¹å¿™æ—¶ç”¨0.5-1.0` |
| `--heartbeat-interval-millis` | `100` | `å¿ƒè·³æ£€æŸ¥é—´éš”` | `ç½‘ç»œå»¶è¿Ÿé«˜æ—¶è°ƒå¤§` |

**ğŸ”§ æ€§èƒ½è°ƒä¼˜ç¤ºä¾‹**
```bash
# é«˜æ€§èƒ½é…ç½®ï¼ˆé€‚ç”¨äºé«˜é…ç½®æœåŠ¡å™¨ï¼‰
gh-ost \
  --user="root" \
  --database="ecommerce" \
  --table="orders" \
  --alter="ADD INDEX idx_user_created (user_id, created_at)" \
  --chunk-size=3000 \
  --max-lag-millis=800 \
  --nice-ratio=0.2 \
  --max-load="Threads_running=50,Threads_connected=2000" \
  --critical-load="Threads_running=100,Threads_connected=3000" \
  --execute

# ä¿å®ˆé…ç½®ï¼ˆé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
gh-ost \
  --user="root" \
  --database="ecommerce" \
  --table="orders" \
  --alter="ADD INDEX idx_status (status)" \
  --chunk-size=500 \
  --max-lag-millis=2000 \
  --nice-ratio=1.0 \
  --max-load="Threads_running=20,Threads_connected=800" \
  --execute
```

### 8.2 å®‰å…¨æ§åˆ¶å‚æ•°


**ğŸ›¡ï¸ å®‰å…¨ç›¸å…³é…ç½®**

```bash
# å®‰å…¨åŠ å›ºé…ç½®
gh-ost \
  --user="migration_user" \
  --password="secure_password" \
  --database="sensitive_db" \
  --table="user_data" \
  --alter="ADD COLUMN encrypted_field TEXT" \
  \
  # æƒé™æ§åˆ¶
  --allow-on-master \
  --assume-rbr \
  --skip-foreign-key-checks=false \
  \
  # å®‰å…¨æ£€æŸ¥
  --panic-flag-file="/tmp/gh-ost-panic" \
  --postpone-cut-over-flag-file="/tmp/gh-ost-postpone" \
  \
  # å®¡è®¡æ—¥å¿—
  --hooks-path="/scripts/audit-hook.sh" \
  \
  --execute
```

**ğŸ”’ æƒé™æœ€å°åŒ–åŸåˆ™**
```sql
-- åˆ›å»ºä¸“ç”¨è¿ç§»ç”¨æˆ·
CREATE USER 'gh_ost_user'@'localhost' IDENTIFIED BY 'strong_password';

-- æˆäºˆæœ€å°å¿…è¦æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE, 
      CREATE, DROP, INDEX, ALTER, 
      LOCK TABLES, TRIGGER, REPLICATION SLAVE 
ON migration_db.* TO 'gh_ost_user'@'localhost';

-- é™åˆ¶è¿æ¥æ•°
ALTER USER 'gh_ost_user'@'localhost' 
WITH MAX_CONNECTIONS_PER_HOUR 100;
```

### 8.3 ç›‘æ§å’Œæ—¥å¿—å‚æ•°


**ğŸ“Š ç›‘æ§é…ç½®è¯¦è§£**
```bash
gh-ost \
  --user="root" \
  --database="app_db" \
  --table="transactions" \
  --alter="ADD COLUMN processor VARCHAR(50)" \
  \
  # è¯¦ç»†æ—¥å¿—é…ç½®
  --verbose \
  --debug \
  --log-file="/var/log/gh-ost/migration.log" \
  \
  # è¿›åº¦æŠ¥å‘Š
  --progress-file="/tmp/gh-ost-progress" \
  --heartbeat-interval-millis=500 \
  \
  # çŠ¶æ€æ£€æŸ¥é¢‘ç‡
  --default-retries=3 \
  --cut-over-exponential-backoff \
  \
  # APIæ¥å£
  --serve-tcp-port=8089 \
  --serve-socket-file="/tmp/gh-ost.sock" \
  \
  --execute
```

### 8.4 ç¯å¢ƒé€‚é…å‚æ•°


**ğŸŒ ä¸åŒç¯å¢ƒé…ç½®æ¨¡æ¿**

```bash
# å¼€å‘ç¯å¢ƒé…ç½®
cat > /etc/gh-ost/dev.conf <<EOF
# å¼€å‘ç¯å¢ƒ - å¿«é€Ÿæ‰§è¡Œ
chunk-size=2000
max-lag-millis=1000
nice-ratio=0.1
max-load=Threads_running=30
serve-tcp-port=8089
verbose=true
EOF

# æµ‹è¯•ç¯å¢ƒé…ç½®  
cat > /etc/gh-ost/test.conf <<EOF
# æµ‹è¯•ç¯å¢ƒ - å¹³è¡¡æ€§èƒ½
chunk-size=1000
max-lag-millis=1500
nice-ratio=0.5
max-load=Threads_running=25
serve-tcp-port=8089
hooks-path=/scripts/test-hooks.sh
EOF

# ç”Ÿäº§ç¯å¢ƒé…ç½®
cat > /etc/gh-ost/prod.conf <<EOF
# ç”Ÿäº§ç¯å¢ƒ - å®‰å…¨ç¬¬ä¸€
chunk-size=500
max-lag-millis=3000
nice-ratio=1.0
max-load=Threads_running=15,Threads_connected=500
critical-load=Threads_running=50,Threads_connected=1000
panic-flag-file=/tmp/gh-ost-panic
hooks-path=/scripts/prod-hooks.sh
serve-socket-file=/tmp/gh-ost.sock
log-file=/var/log/gh-ost/prod.log
EOF

# ä½¿ç”¨é…ç½®æ–‡ä»¶
gh-ost --conf=/etc/gh-ost/prod.conf \
       --database="production_db" \
       --table="critical_table" \
       --alter="ADD INDEX idx_performance (col1, col2)" \
       --execute
```

### 8.5 é«˜çº§é…ç½®æŠ€å·§


**ğŸ’¡ åŠ¨æ€é…ç½®è°ƒæ•´è„šæœ¬**
```bash
#!/bin/bash
# æ–‡ä»¶ï¼š/scripts/dynamic-config.sh

SOCKET_FILE="/tmp/gh-ost.sock"
CONFIG_FILE="/etc/gh-ost/runtime.conf"

# æ ¹æ®æ—¶é—´è°ƒæ•´é…ç½®
adjust_by_time() {
    local hour=$(date +%H)
    
    if [ $hour -ge 9 ] && [ $hour -le 18 ]; then
        # å·¥ä½œæ—¶é—´ - ä¿å®ˆé…ç½®
        echo "chunk-size=300" | socat - $SOCKET_FILE
        echo "nice-ratio=1.5" | socat - $SOCKET_FILE
        echo "å·¥ä½œæ—¶é—´ï¼šä½¿ç”¨ä¿å®ˆé…ç½®"
    else
        # éå·¥ä½œæ—¶é—´ - ç§¯æé…ç½®
        echo "chunk-size=1500" | socat - $SOCKET_FILE  
        echo "nice-ratio=0.5" | socat - $SOCKET_FILE
        echo "éå·¥ä½œæ—¶é—´ï¼šä½¿ç”¨ç§¯æé…ç½®"
    fi
}

# æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´
adjust_by_load() {
    local load=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs)
    local load_int=${load%.*}
    
    if [ $load_int -gt 2 ]; then
        echo "chunk-size=200" | socat - $SOCKET_FILE
        echo "high-load" | socat - $SOCKET_FILE
        echo "é«˜è´Ÿè½½ï¼šé™ä½å¤„ç†é€Ÿåº¦"
    elif [ $load_int -lt 1 ]; then
        echo "chunk-size=2000" | socat - $SOCKET_FILE
        echo "low-load" | socat - $SOCKET_FILE
        echo "ä½è´Ÿè½½ï¼šæé«˜å¤„ç†é€Ÿåº¦"
    fi
}

# ä¸»å¾ªç¯
while true; do
    adjust_by_time
    adjust_by_load
    sleep 300  # æ¯5åˆ†é’Ÿè°ƒæ•´ä¸€æ¬¡
done
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ hooksé’©å­æœºåˆ¶ï¼šåœ¨å…³é”®èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
ğŸ”¸ çŠ¶æ€æ£€æŸ¥ç³»ç»Ÿï¼šåŠ¨æ€ç›‘æ§ç³»ç»ŸçŠ¶æ€ï¼Œç¡®ä¿å®‰å…¨æ‰§è¡Œ
ğŸ”¸ å¤–éƒ¨å‘½ä»¤é›†æˆï¼šä¸å¤‡ä»½ã€ç›‘æ§ã€å®¡æ‰¹ç³»ç»Ÿæ— ç¼é›†æˆ
ğŸ”¸ åŠ¨æ€é…ç½®è°ƒæ•´ï¼šè¿è¡Œæ—¶æ ¹æ®æƒ…å†µè°ƒæ•´å‚æ•°
ğŸ”¸ æ¡ä»¶æ‰§è¡Œæ§åˆ¶ï¼šæ ¹æ®ä¸šåŠ¡æ¡ä»¶å†³å®šæ‰§è¡Œç­–ç•¥
ğŸ”¸ APIæ¥å£ä½¿ç”¨ï¼šé€šè¿‡HTTP/Socketæ¥å£ç›‘æ§å’Œæ§åˆ¶
ğŸ”¸ æ‰©å±•åŠŸèƒ½å¼€å‘ï¼šåŸºäºæ’ä»¶æœºåˆ¶å¼€å‘å®šåˆ¶åŠŸèƒ½
ğŸ”¸ é«˜çº§å‚æ•°é…ç½®ï¼šé’ˆå¯¹ä¸åŒç¯å¢ƒçš„å‚æ•°ä¼˜åŒ–
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é’©å­æœºåˆ¶çš„ä»·å€¼**
```
è‡ªåŠ¨åŒ–è¿ç»´ï¼š
- æ— éœ€äººå·¥å¹²é¢„çš„è‡ªåŠ¨åŒ–æµç¨‹
- ä¸ç°æœ‰è¿ç»´å·¥å…·é“¾æ— ç¼é›†æˆ
- æé«˜æ“ä½œçš„ä¸€è‡´æ€§å’Œå¯é æ€§

ç›‘æ§å‘Šè­¦ï¼š
- å®æ—¶æŒæ¡è¿ç§»çŠ¶æ€
- å¼‚å¸¸æƒ…å†µåŠæ—¶å“åº”
- è¯¦ç»†çš„å®¡è®¡æ—¥å¿—è®°å½•
```

**ğŸ”¹ åŠ¨æ€æ§åˆ¶çš„ä¼˜åŠ¿**
```
çµæ´»æ€§ï¼š
- æ ¹æ®å®æ—¶æƒ…å†µè°ƒæ•´ç­–ç•¥
- æ— éœ€é‡å¯å³å¯ä¿®æ”¹å‚æ•°
- é€‚åº”ä¸åŒçš„ä¸šåŠ¡åœºæ™¯

å®‰å…¨æ€§ï¼š
- å¤šé‡ä¿æŠ¤æœºåˆ¶
- æ¡ä»¶ä¸æ»¡è¶³æ—¶è‡ªåŠ¨æš‚åœ
- ç´§æ€¥æƒ…å†µä¸‹å¿«é€Ÿå¹²é¢„
```

**ğŸ”¹ æ‰©å±•å¼€å‘çš„æ€è·¯**
```
æ¨¡å—åŒ–è®¾è®¡ï¼š
- æ’ä»¶å¼æ¶æ„ä¾¿äºæ‰©å±•
- åŠŸèƒ½è§£è€¦ä¾¿äºç»´æŠ¤
- é…ç½®åŒ–ç®¡ç†ä¾¿äºéƒ¨ç½²

ä¸šåŠ¡é€‚é…ï¼š
- æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚å®šåˆ¶
- ä¸ä¼ä¸šç°æœ‰ç³»ç»Ÿé›†æˆ
- æ»¡è¶³åˆè§„å’Œå®¡è®¡è¦æ±‚
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä½¿ç”¨åœºæ™¯é€‰æ‹©**
- **å°å‹é¡¹ç›®**ï¼šä½¿ç”¨åŸºç¡€é’©å­å³å¯æ»¡è¶³éœ€æ±‚
- **ä¸­å‹é¡¹ç›®**ï¼šç»“åˆAPIæ¥å£å®ç°ç›‘æ§
- **å¤§å‹é¡¹ç›®**ï¼šå¼€å‘å®Œæ•´çš„æ’ä»¶ç³»ç»Ÿ
- **ä¼ä¸šçº§**ï¼šé›†æˆåˆ°DevOpså·¥å…·é“¾ä¸­

**ğŸ› ï¸ æœ€ä½³å®è·µå»ºè®®**
```
æ¸è¿›å¼åº”ç”¨ï¼š
1. å…ˆä½¿ç”¨ç®€å•çš„é’©å­è„šæœ¬
2. å†æ·»åŠ ç›‘æ§å’Œå‘Šè­¦åŠŸèƒ½  
3. æœ€åå¼€å‘å®Œæ•´çš„è‡ªåŠ¨åŒ–ç³»ç»Ÿ

æµ‹è¯•éªŒè¯ï¼š
1. åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯
2. é€æ­¥åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
3. å»ºç«‹å›æ»šå’Œåº”æ€¥é¢„æ¡ˆ

ç›‘æ§è¿ç»´ï¼š
1. å»ºç«‹å®Œå–„çš„æ—¥å¿—è®°å½•
2. è®¾ç½®å…³é”®æŒ‡æ ‡ç›‘æ§
3. å®šæœŸæ£€æŸ¥å’Œä¼˜åŒ–é…ç½®
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- gh-osté«˜çº§ç‰¹æ€§è®©æ•°æ®åº“è¿ç§»æ›´æ™ºèƒ½ã€æ›´å®‰å…¨
- é’©å­æœºåˆ¶æ˜¯è‡ªåŠ¨åŒ–çš„åŸºç¡€ï¼ŒAPIæ¥å£æ˜¯ç›‘æ§çš„æ ¸å¿ƒ
- æ‰©å±•å¼€å‘è¦è€ƒè™‘æ¨¡å—åŒ–å’Œä¸šåŠ¡é€‚é…
- ä¸åŒç¯å¢ƒéœ€è¦ä¸åŒçš„å‚æ•°é…ç½®ç­–ç•¥
- å®è·µä¸­è¦å¾ªåºæ¸è¿›ï¼Œå…ˆç®€å•åå¤æ‚