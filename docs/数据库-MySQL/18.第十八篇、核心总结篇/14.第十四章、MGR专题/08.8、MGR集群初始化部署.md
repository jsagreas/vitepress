---
title: 8、MGR集群初始化部署
---
## 📚 目录


1. [MGR集群部署概述](#1-MGR集群部署概述)
2. [集群引导节点配置](#2-集群引导节点配置)
3. [核心配置参数详解](#3-核心配置参数详解)
4. [集群初始化操作](#4-集群初始化操作)
5. [节点加入集群](#5-节点加入集群)
6. [集群状态验证](#6-集群状态验证)
7. [故障处理与排查](#7-故障处理与排查)
8. [自动化部署方案](#8-自动化部署方案)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🚀 MGR集群部署概述



### 1.1 什么是MGR集群初始化



**通俗理解**：MGR集群初始化就像组建一个团队，需要先选出一个队长（引导节点），然后其他成员依次加入。

```
简单类比：
组建微信群 → MGR集群初始化
群主创建群 → 引导节点启动集群
邀请成员加入 → 其他节点加入集群
群聊正常运行 → 集群提供服务
```

**核心概念**：
- **引导节点**：第一个启动集群的MySQL实例，相当于"开荒者"
- **集群初始化**：让第一个节点创建一个全新的MGR集群
- **节点加入**：后续节点通过网络连接加入已存在的集群

### 1.2 部署流程概览



```
部署步骤流程图：

准备阶段    配置阶段    初始化阶段    验证阶段
    |           |           |           |
    ↓           ↓           ↓           ↓
环境检查 → 参数配置 → 启动引导 → 状态检查
    |           |           |           |
服务器准备   网络配置    节点加入    功能测试
    |           |           |           |
权限设置    用户创建    集群同步    监控配置
```

---

## 2. 🔧 集群引导节点配置



### 2.1 什么是引导节点



**通俗解释**：引导节点就像一个聚会的发起人，他先到聚会地点，然后告诉其他人"聚会开始了，大家可以来了"。

> 💡 **核心概念**：引导节点是集群中第一个启动的节点，它负责创建全新的MGR集群。一旦集群建立，引导节点就和普通节点一样了。

### 2.2 引导节点基础配置



**my.cnf配置示例**：
```ini
[mysqld]
# === 基础配置 ===

server-id = 1
gtid_mode = ON
enforce_gtid_consistency = ON
binlog_format = ROW
log_bin = mysql-bin
log_slave_updates = ON

# === MGR核心配置 ===

plugin_load_add = group_replication.so
group_replication_group_name = "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
group_replication_start_on_boot = OFF
group_replication_local_address = "192.168.1.10:33061"
group_replication_group_seeds = "192.168.1.10:33061,192.168.1.11:33061,192.168.1.12:33061"
group_replication_bootstrap_group = OFF
```

**重要说明**：
- `server-id`：每个节点必须唯一，就像身份证号
- `group_replication_start_on_boot = OFF`：防止自动启动，避免脑裂

### 2.3 关键配置参数理解



```
参数作用通俗解释：

gtid_mode = ON
↓
就像给每个数据变更贴上"唯一标签"，方便追踪

binlog_format = ROW  
↓
记录每一行数据的具体变化，保证同步准确

group_replication_start_on_boot = OFF
↓
服务器重启时不自动加入集群，防止"抢夺领导权"
```

---

## 3. 📋 核心配置参数详解



### 3.1 group_replication_group_name



**作用说明**：这是集群的"身份证"，同一个集群的所有节点必须使用相同的名称。

```sql
-- 设置集群名称（必须是UUID格式）
SET GLOBAL group_replication_group_name = "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa";
```

**通俗理解**：
- 就像微信群的群号，所有成员必须知道这个群号才能加入
- UUID格式保证全球唯一性，避免不同集群冲突

> ⚠️ **注意**：所有节点的group_name必须完全一致，一个字母都不能差！

### 3.2 group_replication_local_address



**作用说明**：告诉其他节点"我在哪里"，用于集群内部通信。

```sql
-- 设置本节点地址
SET GLOBAL group_replication_local_address = "192.168.1.10:33061";
```

**配置要点**：
- **IP地址**：使用本机的实际IP，不能用127.0.0.1
- **端口**：不能与MySQL服务端口相同，通常用33061
- **格式**：必须是"IP:端口"的格式

```
地址配置示例：
节点1：192.168.1.10:33061
节点2：192.168.1.11:33061  
节点3：192.168.1.12:33061

每个节点的IP不同，但端口可以相同
```

### 3.3 group_replication_group_seeds



**作用说明**：这是集群的"通讯录"，新节点通过这个列表找到集群。

```sql
-- 设置集群种子节点列表
SET GLOBAL group_replication_group_seeds = "192.168.1.10:33061,192.168.1.11:33061,192.168.1.12:33061";
```

**通俗理解**：
- 就像通讯录，列出了所有可能的集群成员
- 新节点加入时会尝试连接这些地址
- 不需要列出所有节点，但建议至少包含3个稳定节点

### 3.4 group_replication_bootstrap_group



**作用说明**：这是"开荒令"，只有引导节点在初始化时才设为ON。

```sql
-- 仅在引导节点初始化时使用
SET GLOBAL group_replication_bootstrap_group = ON;
START GROUP_REPLICATION;
SET GLOBAL group_replication_bootstrap_group = OFF;
```

> 🚨 **重要警告**：初始化完成后必须立即设为OFF，否则可能导致脑裂！

---

## 4. ⚡ 集群初始化操作



### 4.1 创建复制用户



**用户创建步骤**：
```sql
-- 1. 创建复制用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'repl_password';

-- 2. 授予复制权限
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 3. 授予备份权限（用于数据同步）
GRANT BACKUP_ADMIN ON *.* TO 'repl'@'%';

-- 4. 刷新权限
FLUSH PRIVILEGES;
```

**通俗解释**：
- 复制用户就像"快递员"，负责在节点间传递数据
- 每个节点都需要这个用户来接收和发送数据

### 4.2 配置复制通道



```sql
-- 配置MGR复制通道
CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='repl_password' FOR CHANNEL 'group_replication_recovery';
```

**作用说明**：
- 告诉MySQL使用哪个用户进行数据同步
- 类似于设置快递员的"工作证"

### 4.3 引导节点启动集群



```sql
-- 步骤1：设置引导标志
SET GLOBAL group_replication_bootstrap_group = ON;

-- 步骤2：启动组复制
START GROUP_REPLICATION;

-- 步骤3：关闭引导标志（重要！）
SET GLOBAL group_replication_bootstrap_group = OFF;
```

**执行流程图**：
```
引导节点启动流程：

准备阶段          启动阶段          完成阶段
    |                |                |
    ↓                ↓                ↓
配置用户 → 设置bootstrap=ON → 启动GR → 设置bootstrap=OFF
    |                |                |
权限设置    创建集群空间      加入正常模式
```

---

## 5. 👥 节点加入集群



### 5.1 加入前的准备工作



**配置检查清单**：
- ✅ my.cnf配置正确
- ✅ group_name与引导节点相同
- ✅ local_address配置正确
- ✅ seeds列表包含引导节点
- ✅ 复制用户已创建

### 5.2 节点加入操作



```sql
-- 在新节点上执行

-- 1. 配置复制通道
CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='repl_password' FOR CHANNEL 'group_replication_recovery';

-- 2. 启动组复制（注意：不需要设置bootstrap）
START GROUP_REPLICATION;
```

**加入过程说明**：
```
节点加入流程：

连接阶段     身份验证     数据同步     正常服务
    |           |           |           |
    ↓           ↓           ↓           ↓
找到集群 → 验证身份 → 同步数据 → 成为成员
    |           |           |           |
通过seeds   用复制用户   从其他节点   参与读写
```

### 5.3 加入状态监控



```sql
-- 查看节点加入状态
SELECT MEMBER_ID, MEMBER_HOST, MEMBER_PORT, MEMBER_STATE 
FROM performance_schema.replication_group_members;
```

**状态说明**：
- `ONLINE`：节点正常工作 ✅
- `RECOVERING`：正在同步数据 ⏳
- `OFFLINE`：节点离线 ❌
- `ERROR`：节点出错 🚨

---

## 6. ✅ 集群状态验证



### 6.1 基础状态检查



```sql
-- 1. 查看集群成员
SELECT MEMBER_ID, MEMBER_HOST, MEMBER_STATE, MEMBER_ROLE 
FROM performance_schema.replication_group_members;

-- 2. 查看组复制状态
SHOW STATUS LIKE 'group_replication%';

-- 3. 检查主节点
SELECT VARIABLE_VALUE 
FROM performance_schema.global_status 
WHERE VARIABLE_NAME = 'group_replication_primary_member';
```

### 6.2 功能测试验证



**数据同步测试**：
```sql
-- 在主节点创建测试数据
CREATE DATABASE test_mgr;
USE test_mgr;
CREATE TABLE test_table (id INT PRIMARY KEY, data VARCHAR(50));
INSERT INTO test_table VALUES (1, 'MGR Test Data');

-- 在其他节点查看数据
SELECT * FROM test_mgr.test_table;
```

**预期结果**：所有节点都能看到相同的数据

### 6.3 集群健康检查



```sql
-- 检查集群健康状态
SELECT 
    MEMBER_HOST,
    MEMBER_PORT,
    MEMBER_STATE,
    IF(global_status.VARIABLE_NAME IS NOT NULL, 'PRIMARY', 'SECONDARY') as MEMBER_ROLE
FROM performance_schema.replication_group_members 
LEFT JOIN performance_schema.global_status 
ON global_status.VARIABLE_NAME = 'group_replication_primary_member' 
AND global_status.VARIABLE_VALUE = replication_group_members.MEMBER_ID;
```

---

## 7. 🔧 故障处理与排查



### 7.1 常见初始化问题



**问题1：group_name不匹配**
```
错误信息：This member has a different group_replication_group_name
解决方案：确保所有节点的group_name完全一致
```

**问题2：网络连接失败**
```
错误信息：Failed to connect to group seeds
解决方案：
1. 检查local_address和seeds配置
2. 确保端口33061可以访问
3. 检查防火墙设置
```

**问题3：权限不足**
```
错误信息：Access denied for user 'repl'
解决方案：
1. 检查复制用户创建是否正确
2. 确认用户权限是否足够
3. 验证密码是否正确
```

### 7.2 故障排查步骤



```
故障排查流程：

第一步：检查基础配置
↓
第二步：验证网络连通性
↓  
第三步：检查用户权限
↓
第四步：查看错误日志
↓
第五步：重置并重试
```

**排查命令**：
```sql
-- 查看MGR相关错误
SHOW GLOBAL STATUS LIKE 'group_replication%';

-- 查看错误日志
SELECT * FROM performance_schema.replication_group_member_stats;

-- 停止组复制
STOP GROUP_REPLICATION;

-- 重新启动
START GROUP_REPLICATION;
```

### 7.3 初始化重置



如果初始化失败，可以重置后重新开始：

```sql
-- 1. 停止组复制
STOP GROUP_REPLICATION;

-- 2. 重置相关状态
RESET MASTER;
RESET SLAVE ALL FOR CHANNEL 'group_replication_recovery';

-- 3. 重新配置复制用户
CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='repl_password' FOR CHANNEL 'group_replication_recovery';

-- 4. 重新启动（引导节点需要设置bootstrap）
START GROUP_REPLICATION;
```

---

## 8. 🤖 自动化部署方案



### 8.1 部署脚本设计



**shell脚本示例**：
```bash
#!/bin/bash

# MGR集群自动部署脚本


# 配置变量

MYSQL_ROOT_PASSWORD="root123"
REPL_PASSWORD="repl123"
GROUP_NAME="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"

# 节点信息

NODES=(
    "192.168.1.10:33061"
    "192.168.1.11:33061" 
    "192.168.1.12:33061"
)

# 函数：创建复制用户

create_repl_user() {
    mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
        CREATE USER IF NOT EXISTS 'repl'@'%' IDENTIFIED BY '${REPL_PASSWORD}';
        GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
        GRANT BACKUP_ADMIN ON *.* TO 'repl'@'%';
        FLUSH PRIVILEGES;
    "
}

# 函数：配置MGR

configure_mgr() {
    local local_address=$1
    local seeds=$(IFS=,; echo "${NODES[*]}")
    
    mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
        SET GLOBAL group_replication_group_name = '${GROUP_NAME}';
        SET GLOBAL group_replication_local_address = '${local_address}';
        SET GLOBAL group_replication_group_seeds = '${seeds}';
        CHANGE MASTER TO MASTER_USER='repl', MASTER_PASSWORD='${REPL_PASSWORD}' FOR CHANNEL 'group_replication_recovery';
    "
}

# 函数：启动引导节点

bootstrap_group() {
    mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
        SET GLOBAL group_replication_bootstrap_group = ON;
        START GROUP_REPLICATION;
        SET GLOBAL group_replication_bootstrap_group = OFF;
    "
}

# 函数：加入集群

join_group() {
    mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
        START GROUP_REPLICATION;
    "
}

# 主执行逻辑

echo "开始MGR集群部署..."
create_repl_user
configure_mgr ${NODES[0]}

if [ "$1" == "bootstrap" ]; then
    echo "启动引导节点..."
    bootstrap_group
else
    echo "加入集群..."
    join_group
fi

echo "部署完成！"
```

### 8.2 部署检查清单



```markdown
# MGR部署检查清单



## 部署前检查


- [ ] 服务器时间同步
- [ ] 网络连通性测试
- [ ] MySQL版本兼容性
- [ ] 磁盘空间充足
- [ ] 内存资源足够

## 配置检查


- [ ] my.cnf配置正确
- [ ] server-id唯一
- [ ] group_name一致
- [ ] 网络地址配置正确
- [ ] 端口可访问

## 部署后验证


- [ ] 所有节点状态ONLINE
- [ ] 数据同步正常
- [ ] 故障转移测试
- [ ] 性能基准测试
- [ ] 监控配置完成
```

### 8.3 监控脚本



```bash
#!/bin/bash

# MGR集群状态监控脚本


check_mgr_status() {
    mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
        SELECT 
            MEMBER_HOST as '节点',
            MEMBER_PORT as '端口',
            MEMBER_STATE as '状态',
            IF(MEMBER_ID = (SELECT VARIABLE_VALUE FROM performance_schema.global_status WHERE VARIABLE_NAME='group_replication_primary_member'), 'PRIMARY', 'SECONDARY') as '角色'
        FROM performance_schema.replication_group_members;
    "
}

# 执行检查

echo "=== MGR集群状态 ==="
check_mgr_status

# 检查是否有异常节点

OFFLINE_COUNT=$(mysql -uroot -p${MYSQL_ROOT_PASSWORD} -sN -e "
    SELECT COUNT(*) FROM performance_schema.replication_group_members 
    WHERE MEMBER_STATE != 'ONLINE'
")

if [ $OFFLINE_COUNT -gt 0 ]; then
    echo "⚠️  发现 $OFFLINE_COUNT 个异常节点！"
    exit 1
else
    echo "✅ 集群状态正常"
    exit 0
fi
```

---

## 9. 📋 核心要点总结



### 9.1 必须掌握的核心概念



```
🔸 引导节点：集群的"创建者"，负责初始化集群
🔸 group_name：集群的唯一标识，所有节点必须相同
🔸 local_address：节点的网络地址，用于集群内通信
🔸 group_seeds：集群成员列表，新节点通过它找到集群
🔸 bootstrap_group：初始化标志，仅引导节点使用一次
```

### 9.2 关键操作步骤



**引导节点初始化**：
```
1. 创建复制用户和权限
2. 配置MGR相关参数
3. 设置bootstrap=ON
4. 启动GROUP_REPLICATION
5. 立即设置bootstrap=OFF
```

**普通节点加入**：
```
1. 确保配置与引导节点一致
2. 配置复制通道
3. 直接启动GROUP_REPLICATION
4. 验证加入状态
```

### 9.3 重要注意事项



> ⚠️ **关键提醒**：
> - bootstrap_group只能在引导节点初始化时使用一次
> - 所有节点的group_name必须完全一致
> - local_address不能使用127.0.0.1
> - 复制用户需要足够的权限
> - 防火墙必须开放33061端口

### 9.4 故障预防要点



```
部署成功的关键因素：
✅ 配置文件仔细检查，参数不能有误
✅ 网络连通性提前测试
✅ 用户权限确保充分
✅ 初始化步骤严格按序执行
✅ 状态验证及时进行
```

### 9.5 实际应用建议



- **生产环境**：建议使用自动化脚本部署，减少人为错误
- **测试验证**：每个步骤都要验证结果，确保无误
- **监控配置**：部署完成后立即配置监控
- **文档记录**：详细记录配置参数和部署过程

**核心记忆**：
- MGR部署就像组建团队：先选队长（引导节点），再邀请成员
- 配置参数要统一，网络地址要准确
- 引导标志用一次，权限用户要配好
- 状态验证很重要，监控配置不可少