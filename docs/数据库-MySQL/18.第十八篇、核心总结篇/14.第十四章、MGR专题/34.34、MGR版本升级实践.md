---
title: 34、MGR版本升级实践
---
## 📚 目录

1. [升级规划与前期准备](#1-升级规划与前期准备)
2. [版本兼容性检查](#2-版本兼容性检查)
3. [升级方案设计](#3-升级方案设计)
4. [滚动升级流程](#4-滚动升级流程)
5. [升级验证与监控](#5-升级验证与监控)
6. [故障处理与回滚](#6-故障处理与回滚)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 升级规划与前期准备


### 1.1 什么是MGR版本升级


**简单理解**：就像给手机系统升级一样，MGR版本升级是把MySQL Group Replication从老版本更新到新版本的过程。

**核心目标**：
```
为什么要升级MGR？
• 获得新功能：新版本的改进特性
• 修复安全漏洞：提高系统安全性
• 性能优化：更好的运行效率
• Bug修复：解决已知问题
```

### 1.2 升级规划制定


**📋 升级规划的核心要素**

```
升级规划就像搬家计划：
搬家前要考虑：
• 什么时候搬？ → 升级时间窗口
• 搬到哪里去？ → 目标版本选择
• 怎么搬家？   → 升级方案制定
• 出问题怎么办？ → 回滚计划
```

**🕐 升级时间窗口规划**

| 考虑因素 | **说明** | **建议** |
|---------|---------|---------|
| **业务影响** | `升级期间可能影响服务` | `选择业务低峰期` |
| **维护窗口** | `预留充足的操作时间` | `至少2-4小时` |
| **人员配备** | `确保技术人员在线` | `核心团队待命` |
| **回滚时间** | `万一需要回退的时间` | `预留1小时回滚时间` |

**💡 升级前准备工作清单**

```
📝 准备工作检查清单：

✅ 数据备份
  • 全库备份（物理+逻辑）
  • 配置文件备份
  • 二进制日志备份

✅ 环境检查
  • 磁盘空间充足（至少50%剩余）
  • 网络连接稳定
  • 系统资源监控

✅ 人员准备
  • DBA团队在线
  • 应用开发团队待命
  • 运维监控团队就位

✅ 文档准备
  • 升级操作手册
  • 回滚操作手册  
  • 应急联系方式
```

---

## 2. 🔍 版本兼容性检查


### 2.1 什么是版本兼容性


**通俗解释**：就像检查新软件能不能在你的电脑上运行一样，版本兼容性检查确保新版本MySQL能和现有环境正常工作。

### 2.2 兼容性检查要点


**🔧 核心检查项目**

```
兼容性检查就像体检：
• 硬件兼容：服务器配置是否满足
• 软件兼容：操作系统、依赖库版本
• 配置兼容：参数设置是否需要调整
• 功能兼容：现有功能是否正常
```

**📊 MySQL版本兼容性矩阵**

| 源版本 | **目标版本** | **兼容性** | **注意事项** |
|--------|------------|-----------|-------------|
| `MySQL 5.7` | `MySQL 8.0` | `⚠️ 需注意` | `认证插件变化` |
| `MySQL 8.0.20` | `MySQL 8.0.30` | `✅ 兼容` | `小版本升级` |
| `MySQL 8.0.25` | `MySQL 8.0.35` | `✅ 兼容` | `推荐升级` |

**🔍 具体检查方法**

```sql
-- 检查当前MGR状态
SELECT * FROM performance_schema.replication_group_members;

-- 检查MGR相关参数
SHOW VARIABLES LIKE 'group_replication%';

-- 检查错误日志中的警告
-- 查看 error.log 文件中的 WARNING 信息

-- 检查数据字典兼容性
SELECT * FROM information_schema.tables 
WHERE table_schema = 'mysql' 
AND table_name LIKE 'group%';
```

### 2.3 常见兼容性问题


**⚠️ 典型兼容性问题及解决方案**

```
问题1：认证插件变化
MySQL 8.0 默认使用 caching_sha2_password

解决方案：
• 升级前检查应用连接方式
• 必要时修改用户认证插件
• 更新应用程序驱动版本

问题2：MGR配置参数变化
某些参数在新版本中名称或默认值改变

解决方案：
• 对比新旧版本参数差异
• 准备参数迁移脚本
• 测试环境先验证
```

---

## 3. 📐 升级方案设计


### 3.1 升级方案类型


**🎯 三种主要升级方案**

```
升级方案就像搬家方式：

方案1：停机升级（一次性搬家）
• 所有节点同时停止
• 统一升级后重启
• 简单但停机时间长

方案2：滚动升级（分批搬家）  
• 一个节点一个节点升级
• 服务基本不中断
• 复杂但影响最小

方案3：蓝绿升级（准备新家）
• 搭建新环境并同步数据
• 切换到新环境
• 安全但资源消耗大
```

### 3.2 滚动升级方案详解（推荐）


**📋 滚动升级原理**

```
滚动升级流程图：

初始状态：
Node1(主) ←→ Node2(从) ←→ Node3(从)
 MGR集群正常运行

步骤1：升级Node3
Node1(主) ←→ Node2(从)    Node3(升级中)
 两节点继续服务

步骤2：Node3重新加入
Node1(主) ←→ Node2(从) ←→ Node3(新版本)
 三节点恢复服务

步骤3：升级Node2
Node1(主) ←→ Node3(从)    Node2(升级中)
 继续提供服务

步骤4：升级Node1
Node2(临时主) ←→ Node3(从)    Node1(升级中)
 主节点切换

最终状态：
Node1(新) ←→ Node2(新) ←→ Node3(新)
 全部升级完成
```

**⚡ 滚动升级优势**

| 优势 | **说明** | **适用场景** |
|------|---------|-------------|
| **服务连续性** | `升级期间服务基本不中断` | `7x24小时业务` |
| **风险可控** | `单节点问题不影响整体` | `生产环境` |
| **回滚容易** | `可随时停止升级过程` | `不确定因素多` |

### 3.3 升级方案选择指导


**🎯 方案选择决策树**

```
如何选择升级方案？

业务能接受停机吗？
├─ 能接受 → 停机升级（最简单）
└─ 不能接受
    ├─ 资源充足？
    │   ├─ 是 → 蓝绿升级（最安全）
    │   └─ 否 → 滚动升级（平衡方案）
    └─ 技术要求高 → 滚动升级
```

---

## 4. 🔄 滚动升级流程


### 4.1 升级前准备工作


**📝 详细准备步骤**

```bash
# 1. 创建升级目录
mkdir -p /opt/mysql-upgrade
cd /opt/mysql-upgrade

# 2. 下载新版本MySQL
wget https://dev.mysql.com/get/Downloads/MySQL-8.0/mysql-8.0.35-linux-glibc2.17-x86_64.tar.xz

# 3. 备份当前配置
cp /etc/my.cnf /opt/mysql-upgrade/my.cnf.backup
cp -r /var/lib/mysql /opt/mysql-upgrade/data.backup

# 4. 检查当前MGR状态
mysql -e "SELECT * FROM performance_schema.replication_group_members;"
```

### 4.2 单节点升级详细步骤


**🔧 Node升级标准流程**

```sql
-- 步骤1：停止MGR服务（在要升级的节点）
STOP GROUP_REPLICATION;

-- 步骤2：检查节点状态
SELECT member_host, member_port, member_state 
FROM performance_schema.replication_group_members;

-- 步骤3：等待数据同步完成
-- 确保 GTID_EXECUTED 一致
SHOW MASTER STATUS;
```

```bash
# 步骤4：停止MySQL服务
systemctl stop mysqld

# 步骤5：备份二进制文件
cp /usr/local/mysql/bin/mysqld /opt/mysql-upgrade/mysqld.old

# 步骤6：安装新版本
tar xf mysql-8.0.35-linux-glibc2.17-x86_64.tar.xz
cp -r mysql-8.0.35-linux-glibc2.17-x86_64/* /usr/local/mysql/

# 步骤7：升级数据字典
/usr/local/mysql/bin/mysql_upgrade --force

# 步骤8：启动MySQL
systemctl start mysqld
```

```sql
-- 步骤9：重新加入MGR集群
START GROUP_REPLICATION;

-- 步骤10：验证节点状态
SELECT member_host, member_port, member_state, member_version
FROM performance_schema.replication_group_members;
```

### 4.3 升级顺序策略


**📊 推荐升级顺序**

```
MGR升级的智能顺序：

第1步：从节点优先
• 先升级Secondary节点
• 对业务影响最小
• 可以验证升级过程

第2步：主节点最后
• Primary节点最后升级
• 确保写入服务连续性
• 升级前触发主从切换

第3步：验证每个节点
• 每升级一个节点都要验证
• 确保MGR集群稳定
• 检查数据一致性
```

**⚠️ 升级过程注意事项**

> **重要提醒：**
> - 每次只升级一个节点
> - 等待节点完全恢复后再升级下一个
> - 密切监控集群状态
> - 保持回滚方案随时可用

---

## 5. ✅ 升级验证与监控


### 5.1 升级后验证检查


**🔍 关键验证项目**

```sql
-- 1. 检查MGR集群状态
SELECT 
    member_host,
    member_port, 
    member_state,
    member_role,
    member_version
FROM performance_schema.replication_group_members;

-- 期望结果：所有节点状态为 ONLINE

-- 2. 检查数据一致性
SELECT $$global.gtid_executed;
-- 所有节点的GTID应该一致

-- 3. 检查MGR配置参数
SHOW VARIABLES LIKE 'group_replication%';

-- 4. 测试读写功能
CREATE DATABASE upgrade_test;
USE upgrade_test;
CREATE TABLE test_table (id INT PRIMARY KEY, data VARCHAR(100));
INSERT INTO test_table VALUES (1, 'upgrade test');
SELECT * FROM test_table;
```

### 5.2 功能验证测试


**📋 业务功能验证**

```
功能验证检查清单：

✅ 数据库连接
  • 应用能否正常连接
  • 连接池是否工作正常
  • 认证是否通过

✅ 读写操作
  • SELECT 查询是否正常
  • INSERT/UPDATE/DELETE 是否正常
  • 事务是否正常提交

✅ MGR特性
  • 自动故障切换是否正常
  • 数据一致性是否保持
  • 新节点加入是否正常

✅ 性能表现
  • 查询响应时间是否正常
  • 吞吐量是否满足要求
  • 资源使用是否合理
```

### 5.3 监控指标设置


**📊 关键监控指标**

| 监控类别 | **关键指标** | **正常范围** | **异常处理** |
|---------|-------------|-------------|-------------|
| **集群状态** | `成员节点数量` | `等于预期节点数` | `立即检查离线节点` |
| **数据一致性** | `GTID差异` | `差异 < 100` | `检查同步延迟` |
| **性能指标** | `查询响应时间` | `< 100ms` | `分析慢查询` |
| **错误日志** | `ERROR/WARNING数量` | `无新增错误` | `分析错误原因` |

```bash
# 监控脚本示例
#!/bin/bash
# MGR升级后监控脚本

echo "=== MGR集群状态检查 ==="
mysql -e "SELECT member_host, member_state FROM performance_schema.replication_group_members;"

echo "=== 错误日志检查 ==="
tail -n 50 /var/log/mysql/error.log | grep -i "error\|warning"

echo "=== 性能指标检查 ==="
mysql -e "SHOW GLOBAL STATUS LIKE 'Questions'; SHOW GLOBAL STATUS LIKE 'Uptime';"
```

---

## 6. 🚨 故障处理与回滚


### 6.1 常见升级故障


**⚠️ 典型故障场景及处理**

```
故障1：节点无法启动
现象：MySQL服务启动失败
原因：配置文件不兼容、权限问题

处理步骤：
1. 检查错误日志
2. 恢复原配置文件  
3. 检查文件权限
4. 尝试重新启动

故障2：节点无法加入集群
现象：START GROUP_REPLICATION 失败
原因：版本不兼容、网络问题

处理步骤：
1. 检查版本兼容性
2. 验证网络连通性
3. 检查MGR配置参数
4. 重置MGR状态后重试
```

### 6.2 回滚方案设计


**🔄 回滚操作流程**

```
何时需要回滚？
• 升级后出现严重故障
• 性能显著下降
• 数据一致性问题
• 业务功能异常

回滚原则：
• 快速恢复业务
• 数据安全第一
• 最小化影响范围
```

**📋 回滚操作步骤**

```bash
# 1. 停止问题节点
systemctl stop mysqld

# 2. 恢复原版本文件
cp /opt/mysql-upgrade/mysqld.old /usr/local/mysql/bin/mysqld
chmod +x /usr/local/mysql/bin/mysqld

# 3. 恢复配置文件
cp /opt/mysql-upgrade/my.cnf.backup /etc/my.cnf

# 4. 启动服务
systemctl start mysqld

# 5. 重新加入集群
mysql -e "START GROUP_REPLICATION;"
```

### 6.3 应急处理预案


**🚨 应急响应流程**

```
应急响应决策树：

发现问题
├─ 影响范围
│   ├─ 单节点问题
│   │   └─ 隔离问题节点，其他节点继续服务
│   └─ 集群整体问题
│       └─ 启动应急预案，考虑整体回滚
└─ 问题严重程度
    ├─ 可接受的性能下降
    │   └─ 制定修复计划，择机修复
    └─ 严重影响业务
        └─ 立即回滚，恢复原版本
```

**📞 应急联系机制**

> **应急联系清单：**
> - 🔧 DBA团队：负责数据库操作
> - 💻 应用团队：负责业务验证
> - 📊 监控团队：提供实时数据
> - 👥 决策团队：做出回滚决定

---

## 7. 📋 核心要点总结


### 7.1 升级成功的关键要素


```
🎯 MGR升级成功的五大要素：

1. 充分准备
   • 详细的升级计划
   • 完整的备份策略
   • 充足的时间窗口

2. 兼容性验证
   • 版本兼容性检查
   • 配置参数验证
   • 功能兼容性测试

3. 滚动升级策略
   • 单节点逐步升级
   • 服务连续性保障
   • 实时状态监控

4. 完善的验证
   • 功能正确性验证
   • 性能指标检查
   • 业务逻辑测试

5. 可靠的回滚
   • 快速回滚方案
   • 应急处理预案
   • 团队协作机制
```

### 7.2 最佳实践建议


**📚 MGR升级最佳实践**

```
实践经验总结：

时间选择：
• 选择业务低峰期
• 预留充足时间窗口
• 避开重要业务时段

操作规范：
• 严格按照步骤执行
• 每步都要验证结果
• 详细记录操作日志

风险控制：
• 多环境测试验证
• 准备多套应急方案
• 保持团队沟通顺畅

监控保障：
• 实时监控集群状态
• 关注性能指标变化
• 及时发现异常问题
```

### 7.3 记忆要点


**🧠 核心记忆口诀**

```
MGR升级要记牢：
准备充分很重要，
兼容检查不能少，
滚动升级风险小，
验证监控要做好，
问题回滚要趁早！
```

**📝 关键检查清单**

- ✅ 升级前：备份、兼容性检查、方案制定
- ✅ 升级中：逐个节点、状态监控、功能验证
- ✅ 升级后：全面测试、性能监控、文档记录

**核心理念**：MGR版本升级是一个系统工程，需要**充分准备、谨慎操作、持续监控**，确保在获得新版本优势的同时，保障业务的连续性和数据的安全性。