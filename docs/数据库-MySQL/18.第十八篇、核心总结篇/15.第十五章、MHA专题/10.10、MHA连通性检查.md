---
title: 10、MHA连通性检查
---
## 📚 目录

1. [MHA连通性检查概述](#1-MHA连通性检查概述)
2. [SSH连通性检查](#2-SSH连通性检查)
3. [复制连通性检查](#3-复制连通性检查)
4. [常见检查失败问题排查](#4-常见检查失败问题排查)
5. [自动化检查脚本](#5-自动化检查脚本)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔍 MHA连通性检查概述


### 1.1 什么是连通性检查


**简单来说**，连通性检查就是MHA在正式工作前的"体检"，确保所有服务器之间能够正常通信和协作。

```
想象一下团队协作：
- 团队成员之间要能互相联系（SSH连通性）
- 大家要能访问共同的工作资料（复制连通性）
- 只有通信畅通，团队才能高效协作

MHA的连通性检查也是同样道理
```

### 1.2 为什么要做连通性检查


**核心目的**：
- 🔸 **预防故障**：提前发现网络和配置问题
- 🔸 **确保可靠**：保证故障切换时MHA能正常工作
- 🔸 **降低风险**：避免关键时刻"掉链子"

**检查时机**：
```
部署阶段：MHA环境搭建完成后
维护阶段：定期执行健康检查
故障前：手动故障切换前的确认
自动化：脚本定时检查
```

### 1.3 MHA连通性检查架构


```
MHA Manager节点
    |
    |-- SSH连通性检查
    |   |-- 检查到Master的SSH连接
    |   |-- 检查到各Slave的SSH连接
    |   └-- 检查各节点间的SSH免密登录
    |
    └-- 复制连通性检查
        |-- 检查主从复制状态
        |-- 检查复制延迟
        |-- 检查复制用户权限
        └-- 检查binlog位置信息
```

---

## 2. 🔐 SSH连通性检查


### 2.1 masterha_check_ssh命令详解


**基本概念**：`masterha_check_ssh`是MHA提供的SSH连通性检查工具，用来验证MHA管理节点能否通过SSH正常连接到所有数据库节点。

### 2.2 基础检查命令


```bash
# 基本SSH连通性检查
masterha_check_ssh --conf=/etc/mha/app1.cnf

# 指定用户检查
masterha_check_ssh --conf=/etc/mha/app1.cnf --user=mha

# 详细输出模式
masterha_check_ssh --conf=/etc/mha/app1.cnf --verbose
```

**命令参数说明**：
- `--conf`：指定MHA配置文件路径
- `--user`：指定SSH连接用户（默认使用配置文件中的用户）
- `--verbose`：显示详细的检查过程信息

### 2.3 检查过程详解


**SSH检查流程**：
```
步骤1：读取配置文件
    ↓
步骤2：解析所有节点信息
    ↓
步骤3：逐一尝试SSH连接
    ↓
步骤4：验证免密登录
    ↓
步骤5：测试命令执行权限
    ↓
步骤6：生成检查报告
```

**成功输出示例**：
```bash
Checking SSH connection...
SSH connection from manager to db1(192.168.1.10): OK
SSH connection from manager to db2(192.168.1.11): OK  
SSH connection from manager to db3(192.168.1.12): OK
SSH connection from db1 to db2: OK
SSH connection from db1 to db3: OK
SSH connection from db2 to db1: OK
SSH connection from db2 to db3: OK
SSH connection from db3 to db1: OK
SSH connection from db3 to db2: OK

SSH connectivity check: PASSED
```

### 2.4 SSH配置检查要点


**必要的SSH配置**：

**① 免密登录配置**：
```bash
# 在MHA管理节点生成密钥对
ssh-keygen -t rsa -b 2048

# 将公钥复制到所有数据库节点
ssh-copy-id mha@192.168.1.10
ssh-copy-id mha@192.168.1.11
ssh-copy-id mha@192.168.1.12
```

**② SSH配置文件优化**：
```bash
# /etc/ssh/ssh_config 或 ~/.ssh/config
Host 192.168.1.*
    StrictHostKeyChecking no
    UserKnownHostsFile /dev/null
    ConnectTimeout 10
    ServerAliveInterval 60
```

**③ 权限检查**：
```bash
# 检查SSH目录权限
ls -la ~/.ssh/
# 应该是：
# drwx------ (700) .ssh目录
# -rw------- (600) private key
# -rw-r--r-- (644) public key
```

---

## 3. 🔄 复制连通性检查


### 3.1 masterha_check_repl命令详解


**基本概念**：`masterha_check_repl`检查MySQL主从复制的健康状态，确保MHA能够正确识别和管理复制拓扑。

### 3.2 基础检查命令


```bash
# 基本复制连通性检查
masterha_check_repl --conf=/etc/mha/app1.cnf

# 检查特定的复制延迟
masterha_check_repl --conf=/etc/mha/app1.cnf --seconds_behind_master=30

# 忽略某些检查项
masterha_check_repl --conf=/etc/mha/app1.cnf --ignore_fail
```

**重要参数**：
- `--seconds_behind_master`：允许的最大复制延迟（秒）
- `--ignore_fail`：忽略非致命性检查失败
- `--check_only`：仅检查不执行操作

### 3.3 复制检查项目详解


**① 主库状态检查**：
```sql
-- MHA会执行类似的检查
SHOW MASTER STATUS;
SHOW PROCESSLIST;
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'server_id';
```

**② 从库状态检查**：
```sql
-- 从库复制状态检查
SHOW SLAVE STATUS\G

-- 关键检查项：
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes  
-- Seconds_Behind_Master: < 配置的阈值
-- Last_Error: 应该为空
```

**③ 复制用户权限检查**：
```sql
-- 检查复制用户权限
SHOW GRANTS FOR 'repl'@'%';

-- 必需权限：
-- REPLICATION SLAVE
-- REPLICATION CLIENT
```

### 3.4 成功检查输出解读


```bash
Checking replication health...
Master MySQL server:
  Host: db1 (192.168.1.10)
  Port: 3306
  Status: OK
  Binary logging: Enabled
  Server ID: 1

Slave MySQL servers:
  Host: db2 (192.168.1.11)
    Port: 3306
    Master_Host: 192.168.1.10
    Master_Port: 3306
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    Seconds_Behind_Master: 2
    Status: OK
    
  Host: db3 (192.168.1.12)
    Port: 3306  
    Master_Host: 192.168.1.10
    Master_Port: 3306
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    Seconds_Behind_Master: 1
    Status: OK

Replication health check: PASSED
```

---

## 4. ⚠️ 常见检查失败问题排查


### 4.1 SSH连通性问题排查


**🔸 权限问题**

**现象**：
```bash
SSH connection failed: Permission denied (publickey)
```

**排查步骤**：
```bash
# 1. 检查SSH密钥权限
ls -la ~/.ssh/
chmod 700 ~/.ssh/
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub

# 2. 检查authorized_keys
cat ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# 3. 测试手动SSH连接
ssh -v mha@192.168.1.10
```

**🔸 网络问题**

**现象**：
```bash
SSH connection failed: Connection timed out
```

**排查方法**：
```bash
# 1. 网络连通性测试
ping 192.168.1.10
telnet 192.168.1.10 22

# 2. 防火墙检查
systemctl status firewalld
iptables -L | grep 22

# 3. SSH服务状态
systemctl status sshd
```

### 4.2 复制连通性问题排查


**🔸 复制中断问题**

**常见错误及解决**：

| 错误类型 | 错误信息 | **解决方法** |
|---------|---------|-------------|
| **IO线程停止** | `Slave_IO_Running: No` | `检查网络连接和复制用户权限` |
| **SQL线程停止** | `Slave_SQL_Running: No` | `查看Last_Error，手动修复数据不一致` |
| **复制延迟过大** | `Seconds_Behind_Master: 300` | `检查网络带宽和磁盘IO性能` |
| **权限不足** | `Access denied for user 'repl'` | `重新授权复制用户权限` |

**🔸 复制用户权限问题**

```sql
-- 检查复制用户
SELECT User, Host FROM mysql.user WHERE User='repl';

-- 重新创建复制用户
DROP USER 'repl'@'%';
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;
```

### 4.3 配置问题诊断


**🔸 配置文件检查**

```bash
# 1. 检查配置文件语法
masterha_check_conf --conf=/etc/mha/app1.cnf

# 2. 检查关键配置项
grep -E "(server|hostname|port)" /etc/mha/app1.cnf

# 3. 验证路径和权限
ls -la /var/log/masterha/
ls -la /etc/mha/
```

**🔸 MySQL参数检查**

```sql
-- 必要的MySQL参数检查
SHOW VARIABLES LIKE 'log_bin';          -- 必须为ON
SHOW VARIABLES LIKE 'server_id';        -- 每个节点必须唯一
SHOW VARIABLES LIKE 'binlog_format';    -- 建议为ROW
SHOW VARIABLES LIKE 'read_only';        -- 从库建议为ON
```

---

## 5. 🤖 自动化检查脚本


### 5.1 基础检查脚本


```bash
#!/bin/bash
# MHA连通性自动检查脚本

# 配置变量
MHA_CONF="/etc/mha/app1.cnf"
LOG_FILE="/var/log/mha_check_$(date +%Y%m%d_%H%M%S).log"
EMAIL_ALERT="admin@company.com"

# 检查函数
check_ssh_connectivity() {
    echo "=== SSH连通性检查 ===" | tee -a $LOG_FILE
    if masterha_check_ssh --conf=$MHA_CONF >> $LOG_FILE 2>&1; then
        echo "✅ SSH连通性检查：通过" | tee -a $LOG_FILE
        return 0
    else
        echo "❌ SSH连通性检查：失败" | tee -a $LOG_FILE
        return 1
    fi
}

check_repl_connectivity() {
    echo "=== 复制连通性检查 ===" | tee -a $LOG_FILE
    if masterha_check_repl --conf=$MHA_CONF >> $LOG_FILE 2>&1; then
        echo "✅ 复制连通性检查：通过" | tee -a $LOG_FILE
        return 0
    else
        echo "❌ 复制连通性检查：失败" | tee -a $LOG_FILE
        return 1
    fi
}

# 主检查流程
main() {
    echo "开始MHA连通性检查 - $(date)" | tee -a $LOG_FILE
    
    ssh_result=0
    repl_result=0
    
    check_ssh_connectivity || ssh_result=1
    check_repl_connectivity || repl_result=1
    
    # 生成检查报告
    if [ $ssh_result -eq 0 ] && [ $repl_result -eq 0 ]; then
        echo "🎉 所有检查通过！MHA环境健康" | tee -a $LOG_FILE
        exit 0
    else
        echo "⚠️ 检查发现问题，请查看日志：$LOG_FILE" | tee -a $LOG_FILE
        # 发送告警邮件
        mail -s "MHA连通性检查失败" $EMAIL_ALERT < $LOG_FILE
        exit 1
    fi
}

main "$@"
```

### 5.2 增强版检查脚本


```bash
#!/bin/bash
# 增强版MHA健康检查脚本

# 配置信息
CONFIG_FILE="/etc/mha/app1.cnf"
LOG_DIR="/var/log/mha"
WEBHOOK_URL="https://hooks.slack.com/your-webhook"

# 创建日志目录
mkdir -p $LOG_DIR
LOG_FILE="$LOG_DIR/mha_health_check_$(date +%Y%m%d_%H%M%S).log"

# 颜色输出函数
print_success() { echo -e "\033[32m✅ $1\033[0m" | tee -a $LOG_FILE; }
print_error() { echo -e "\033[31m❌ $1\033[0m" | tee -a $LOG_FILE; }
print_warning() { echo -e "\033[33m⚠️ $1\033[0m" | tee -a $LOG_FILE; }
print_info() { echo -e "\033[34mℹ️ $1\033[0m" | tee -a $LOG_FILE; }

# 详细的SSH检查
detailed_ssh_check() {
    print_info "开始详细SSH连通性检查..."
    
    # 解析配置文件获取节点信息
    servers=$(grep -E "^server[0-9]+" $CONFIG_FILE | awk -F'=' '{print $1}')
    
    for server_key in $servers; do
        hostname=$(grep "^$server_key" $CONFIG_FILE | awk -F'hostname=' '{print $2}' | awk '{print $1}')
        port=$(grep "^$server_key" $CONFIG_FILE | awk -F'port=' '{print $2}' | awk '{print $1}')
        port=${port:-3306}
        
        print_info "检查节点：$hostname:$port"
        
        # SSH连接测试
        if ssh -o ConnectTimeout=10 -o BatchMode=yes $hostname "echo 'SSH OK'" >/dev/null 2>&1; then
            print_success "SSH连接到 $hostname：成功"
        else
            print_error "SSH连接到 $hostname：失败"
            return 1
        fi
        
        # MySQL连接测试
        if ssh $hostname "mysql -e 'SELECT 1'" >/dev/null 2>&1; then
            print_success "MySQL连接在 $hostname：成功"
        else
            print_warning "MySQL连接在 $hostname：需要检查"
        fi
    done
    
    return 0
}

# 详细的复制检查
detailed_repl_check() {
    print_info "开始详细复制状态检查..."
    
    # 获取主库信息
    master_host=$(grep "^master_host" $CONFIG_FILE | awk -F'=' '{print $2}')
    
    print_info "主库：$master_host"
    
    # 检查主库状态
    master_status=$(ssh $master_host "mysql -e 'SHOW MASTER STATUS\G'" 2>/dev/null)
    if [ $? -eq 0 ]; then
        print_success "主库状态检查：正常"
        echo "$master_status" >> $LOG_FILE
    else
        print_error "主库状态检查：失败"
        return 1
    fi
    
    # 检查从库状态
    slaves=$(grep -E "^server[0-9]+" $CONFIG_FILE | grep -v "master_host" | awk -F'=' '{print $1}')
    
    for slave_key in $slaves; do
        slave_host=$(grep "^$slave_key" $CONFIG_FILE | awk -F'hostname=' '{print $2}' | awk '{print $1}')
        
        print_info "检查从库：$slave_host"
        
        slave_status=$(ssh $slave_host "mysql -e 'SHOW SLAVE STATUS\G'" 2>/dev/null)
        if [ $? -eq 0 ]; then
            io_running=$(echo "$slave_status" | grep "Slave_IO_Running:" | awk '{print $2}')
            sql_running=$(echo "$slave_status" | grep "Slave_SQL_Running:" | awk '{print $2}')
            seconds_behind=$(echo "$slave_status" | grep "Seconds_Behind_Master:" | awk '{print $2}')
            
            if [ "$io_running" = "Yes" ] && [ "$sql_running" = "Yes" ]; then
                print_success "从库 $slave_host 复制状态：正常（延迟：${seconds_behind}秒）"
            else
                print_error "从库 $slave_host 复制状态：异常 (IO:$io_running, SQL:$sql_running)"
                return 1
            fi
        else
            print_error "从库 $slave_host 状态检查：失败"
            return 1
        fi
    done
    
    return 0
}

# 发送通知
send_notification() {
    local status=$1
    local message=$2
    
    # Slack通知
    if [ ! -z "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
             --data "{\"text\":\"MHA健康检查: $status - $message\"}" \
             $WEBHOOK_URL >/dev/null 2>&1
    fi
    
    # 邮件通知
    if command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "MHA健康检查: $status" admin@company.com
    fi
}

# 主函数
main() {
    print_info "========================================"
    print_info "MHA连通性健康检查开始"
    print_info "时间：$(date)"
    print_info "配置文件：$CONFIG_FILE"
    print_info "========================================"
    
    ssh_ok=true
    repl_ok=true
    
    # SSH检查
    if ! detailed_ssh_check; then
        ssh_ok=false
    fi
    
    # 复制检查
    if ! detailed_repl_check; then
        repl_ok=false
    fi
    
    # 生成最终报告
    print_info "========================================"
    if $ssh_ok && $repl_ok; then
        print_success "MHA环境健康检查：全部通过"
        send_notification "SUCCESS" "MHA环境运行正常"
        exit 0
    else
        print_error "MHA环境健康检查：发现问题"
        print_info "详细日志：$LOG_FILE"
        send_notification "FAILED" "MHA环境检查发现问题，请查看日志"
        exit 1
    fi
}

# 执行主函数
main "$@"
```

### 5.3 定时检查配置


**添加到crontab**：
```bash
# 编辑crontab
crontab -e

# 每小时执行一次检查
0 * * * * /usr/local/bin/mha_health_check.sh >/dev/null 2>&1

# 每天早上8点执行详细检查
0 8 * * * /usr/local/bin/mha_detailed_check.sh

# 每周一凌晨执行完整报告
0 2 * * 1 /usr/local/bin/mha_weekly_report.sh
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 连通性检查目的：确保MHA环境在故障切换时能正常工作
🔸 SSH检查：验证管理节点到各数据库节点的免密登录
🔸 复制检查：验证MySQL主从复制的健康状态
🔸 预防性维护：定期检查可以提前发现和解决问题
```

### 6.2 关键命令和用法


| 命令 | **用途** | **常用参数** |
|------|---------|-------------|
| `masterha_check_ssh` | `SSH连通性检查` | `--conf, --user, --verbose` |
| `masterha_check_repl` | `复制连通性检查` | `--conf, --seconds_behind_master` |
| `masterha_check_conf` | `配置文件检查` | `--conf` |

### 6.3 常见问题快速诊断


**🔹 SSH连接失败**：
```bash
# 快速诊断步骤
1. 检查网络连通性：ping + telnet
2. 验证SSH密钥权限：chmod 600 ~/.ssh/id_rsa
3. 测试手动连接：ssh -v user@host
4. 检查防火墙设置：iptables -L
```

**🔹 复制状态异常**：
```sql
-- 快速检查步骤
1. SHOW SLAVE STATUS\G  -- 查看详细错误
2. SHOW PROCESSLIST;    -- 检查是否有锁等待
3. 检查复制用户权限
4. 验证网络连接和磁盘空间
```

### 6.4 最佳实践建议


**🎯 检查频率**：
- **部署后**：立即执行完整检查
- **日常维护**：每小时自动检查
- **变更前**：手动执行确认检查
- **告警后**：立即执行诊断检查

**🔧 自动化策略**：
- 编写检查脚本，集成到监控系统
- 设置合理的告警阈值和通知方式
- 建立检查失败的处理流程
- 定期review检查日志，优化检查策略

**⚠️ 注意事项**：
- 检查过程可能对性能有轻微影响，避免在业务高峰期频繁执行
- 保持检查脚本的版本控制和文档更新
- 建立检查失败的应急响应流程

**核心记忆**：
- 连通性检查是MHA稳定运行的基础保障
- SSH和复制两个检查缺一不可
- 自动化检查比手动检查更可靠
- 预防胜于故障后的紧急处理