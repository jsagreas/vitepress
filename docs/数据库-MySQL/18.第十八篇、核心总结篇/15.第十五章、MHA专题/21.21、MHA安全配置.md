---
title: 21ã€MHAå®‰å…¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [SSHå®‰å…¨åŠ å›ºç­–ç•¥](#1-SSHå®‰å…¨åŠ å›ºç­–ç•¥)
2. [å¯†é’¥ç®¡ç†å®‰å…¨ä½“ç³»](#2-å¯†é’¥ç®¡ç†å®‰å…¨ä½“ç³»)
3. [ç½‘ç»œè®¿é—®æ§åˆ¶](#3-ç½‘ç»œè®¿é—®æ§åˆ¶)
4. [é˜²ç«å¢™é…ç½®è¯¦è§£](#4-é˜²ç«å¢™é…ç½®è¯¦è§£)
5. [SSLè¯ä¹¦é…ç½®](#5-SSLè¯ä¹¦é…ç½®)
6. [ç”¨æˆ·æƒé™æ§åˆ¶](#6-ç”¨æˆ·æƒé™æ§åˆ¶)
7. [æ“ä½œå®¡è®¡æ—¥å¿—](#7-æ“ä½œå®¡è®¡æ—¥å¿—)
8. [æ•æ„Ÿä¿¡æ¯ä¿æŠ¤](#8-æ•æ„Ÿä¿¡æ¯ä¿æŠ¤)
9. [è®¿é—®IPé™åˆ¶](#9-è®¿é—®IPé™åˆ¶)
10. [å®‰å…¨è¡¥ä¸ç®¡ç†](#10-å®‰å…¨è¡¥ä¸ç®¡ç†)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SSHå®‰å…¨åŠ å›ºç­–ç•¥


### 1.1 SSHåŸºç¡€å®‰å…¨ç†è§£

ğŸ¯ **ä¸ºä»€ä¹ˆSSHå®‰å…¨å¦‚æ­¤é‡è¦**

```
æƒ³è±¡SSHå°±åƒä½ å®¶çš„å¤§é—¨é’¥åŒ™ï¼š
æ™®é€šé’¥åŒ™ï¼šä»»ä½•äººæ‹¿åˆ°éƒ½èƒ½å¼€é—¨ï¼ˆå¯†ç è®¤è¯ï¼‰
æ™ºèƒ½é”ï¼šéœ€è¦æŒ‡çº¹+å¯†ç åŒé‡éªŒè¯ï¼ˆå¯†é’¥+å¯†ç ï¼‰
è±ªå®…é—¨ç¦ï¼šè¿˜è¦éªŒè¯èº«ä»½ã€è®°å½•è¿›å‡ºï¼ˆå®¡è®¡+é™åˆ¶ï¼‰

MHAç¯å¢ƒä¸­SSHçš„ä½œç”¨ï¼š
- ManagerèŠ‚ç‚¹éœ€è¦å…å¯†ç™»å½•æ‰€æœ‰æ•°æ®åº“æœåŠ¡å™¨
- æ‰§è¡Œæ•…éšœåˆ‡æ¢ã€æ•°æ®åŒæ­¥ç­‰å…³é”®æ“ä½œ
- ä¸€æ—¦è¢«æ”»ç ´ï¼Œæ•´ä¸ªæ•°æ®åº“é›†ç¾¤éƒ½é¢ä¸´é£é™©
```

### 1.2 SSHæœåŠ¡ç«¯å®‰å…¨é…ç½®

**ğŸ”§ /etc/ssh/sshd_config å®‰å…¨é…ç½®**

```bash
# 1. ä¿®æ”¹é»˜è®¤ç«¯å£ï¼ˆé¿å…ç«¯å£æ‰«æï¼‰
Port 2022  # ä¸ä½¿ç”¨é»˜è®¤çš„22ç«¯å£

# 2. é™åˆ¶åè®®ç‰ˆæœ¬
Protocol 2  # åªä½¿ç”¨SSH2åè®®

# 3. ç¦ç”¨ä¸å®‰å…¨çš„è®¤è¯æ–¹å¼
PasswordAuthentication no  # ç¦ç”¨å¯†ç è®¤è¯
PermitEmptyPasswords no   # ç¦æ­¢ç©ºå¯†ç 
ChallengeResponseAuthentication no  # ç¦ç”¨é”®ç›˜äº¤äº’è®¤è¯

# 4. å¯ç”¨å¯†é’¥è®¤è¯
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys

# 5. é™åˆ¶rootç™»å½•
PermitRootLogin no  # ç¦æ­¢rootç›´æ¥ç™»å½•

# 6. é™åˆ¶ç™»å½•ç”¨æˆ·
AllowUsers mha-user mysql-user  # åªå…è®¸ç‰¹å®šç”¨æˆ·ç™»å½•
DenyUsers root nobody  # æ˜ç¡®æ‹’ç»å±é™©ç”¨æˆ·

# 7. ä¼šè¯å®‰å…¨è®¾ç½®
ClientAliveInterval 300  # 5åˆ†é’Ÿæ— æ´»åŠ¨æ–­å¼€
ClientAliveCountMax 2   # æœ€å¤š2æ¬¡å¿ƒè·³å¤±è´¥
MaxAuthTries 3         # æœ€å¤š3æ¬¡è®¤è¯å°è¯•
LoginGraceTime 60      # ç™»å½•è¶…æ—¶60ç§’
```

**âš ï¸ é…ç½®ç”Ÿæ•ˆæ“ä½œ**
```bash
# æ£€æŸ¥é…ç½®è¯­æ³•
sudo sshd -t

# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd

# éªŒè¯é…ç½®ç”Ÿæ•ˆ
sudo systemctl status sshd
```

### 1.3 SSHå®¢æˆ·ç«¯å®‰å…¨é…ç½®

**ğŸ”§ ~/.ssh/config å®¢æˆ·ç«¯é…ç½®**

```bash
# MHA ManagerèŠ‚ç‚¹çš„SSHå®¢æˆ·ç«¯é…ç½®
Host db-master
    HostName 192.168.1.100
    Port 2022
    User mha-user
    IdentityFile ~/.ssh/mha_rsa
    StrictHostKeyChecking yes
    UserKnownHostsFile ~/.ssh/known_hosts
    ConnectTimeout 10
    ServerAliveInterval 60

Host db-slave1
    HostName 192.168.1.101
    Port 2022
    User mha-user
    IdentityFile ~/.ssh/mha_rsa
    StrictHostKeyChecking yes

Host db-slave2
    HostName 192.168.1.102
    Port 2022
    User mha-user
    IdentityFile ~/.ssh/mha_rsa
    StrictHostKeyChecking yes
```

**ğŸ”’ å®‰å…¨å‚æ•°è¯¦è§£**
```
StrictHostKeyChecking yesï¼š
ä½œç”¨ï¼šä¸¥æ ¼æ£€æŸ¥ä¸»æœºå¯†é’¥ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»
é£é™©ï¼šå¦‚æœè®¾ä¸ºnoï¼Œå®¹æ˜“è¢«æ¶æ„ä¸»æœºå†’å……

ConnectTimeout 10ï¼š
ä½œç”¨ï¼šè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
å®‰å…¨æ€§ï¼šé˜²æ­¢è¿æ¥è¢«æ¶æ„æŒ‚èµ·

ServerAliveInterval 60ï¼š
ä½œç”¨ï¼šå®šæœŸå‘é€å¿ƒè·³åŒ…ä¿æŒè¿æ¥æ´»è·ƒ
å®‰å…¨æ€§ï¼šåŠæ—¶å‘ç°è¿æ¥å¼‚å¸¸æ–­å¼€
```

---

## 2. ğŸ”‘ å¯†é’¥ç®¡ç†å®‰å…¨ä½“ç³»


### 2.1 å¯†é’¥ç”Ÿæˆä¸åˆ†å‘

**ğŸ”§ å®‰å…¨çš„å¯†é’¥ç”Ÿæˆæµç¨‹**

```bash
# 1. åœ¨MHA ManagerèŠ‚ç‚¹ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -f ~/.ssh/mha_rsa -C "mha-manager@company.com"

# å¯†é’¥ç”Ÿæˆå‚æ•°è§£é‡Šï¼š
# -t rsaï¼šæŒ‡å®šå¯†é’¥ç±»å‹ä¸ºRSA
# -b 4096ï¼šå¯†é’¥é•¿åº¦4096ä½ï¼ˆæ¯”é»˜è®¤2048ä½æ›´å®‰å…¨ï¼‰
# -f ~/.ssh/mha_rsaï¼šæŒ‡å®šå¯†é’¥æ–‡ä»¶å
# -Cï¼šæ·»åŠ æ³¨é‡Šï¼Œä¾¿äºç®¡ç†

# 2. è®¾ç½®ç§é’¥æƒé™ï¼ˆå…³é”®å®‰å…¨æªæ–½ï¼‰
chmod 600 ~/.ssh/mha_rsa      # ç§é’¥åªæœ‰æ‰€æœ‰è€…å¯è¯»å†™
chmod 644 ~/.ssh/mha_rsa.pub  # å…¬é’¥å¯ä»¥è¢«å…¶ä»–äººè¯»å–

# 3. è®¾ç½®.sshç›®å½•æƒé™
chmod 700 ~/.ssh              # .sshç›®å½•åªæœ‰æ‰€æœ‰è€…å¯è®¿é—®
```

**ğŸ” å¯†é’¥åˆ†å‘æœ€ä½³å®è·µ**
```bash
# å®‰å…¨çš„å…¬é’¥åˆ†å‘æ–¹æ³•

# æ–¹æ³•1ï¼šä½¿ç”¨ssh-copy-idï¼ˆæ¨èï¼‰
ssh-copy-id -i ~/.ssh/mha_rsa.pub -p 2022 mha-user@192.168.1.100

# æ–¹æ³•2ï¼šæ‰‹åŠ¨åˆ†å‘ï¼ˆæ›´å®‰å…¨ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰
# å…ˆé€šè¿‡å®‰å…¨æ¸ é“ï¼ˆå¦‚è·³æ¿æœºï¼‰ä¼ è¾“å…¬é’¥
scp -P 2022 ~/.ssh/mha_rsa.pub mha-user@192.168.1.100:/tmp/

# ç„¶ååœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ·»åŠ 
ssh -p 2022 mha-user@192.168.1.100
mkdir -p ~/.ssh
cat /tmp/mha_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
rm /tmp/mha_rsa.pub  # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
```

### 2.2 å¯†é’¥è½®æ¢ç­–ç•¥

**â° å®šæœŸå¯†é’¥æ›´æ–°æœºåˆ¶**

```bash
#!/bin/bash
# å¯†é’¥è½®æ¢è„šæœ¬ç¤ºä¾‹

# 1. ç”Ÿæˆæ–°å¯†é’¥
NEW_KEY_DATE=$(date +%Y%m%d)
ssh-keygen -t rsa -b 4096 -f ~/.ssh/mha_rsa_${NEW_KEY_DATE} -N ""

# 2. åˆ†å‘æ–°å…¬é’¥åˆ°æ‰€æœ‰èŠ‚ç‚¹
for host in db-master db-slave1 db-slave2; do
    echo "åˆ†å‘æ–°å¯†é’¥åˆ° $host"
    ssh-copy-id -i ~/.ssh/mha_rsa_${NEW_KEY_DATE}.pub $host
done

# 3. æµ‹è¯•æ–°å¯†é’¥è¿æ¥
for host in db-master db-slave1 db-slave2; do
    echo "æµ‹è¯•è¿æ¥åˆ° $host"
    ssh -i ~/.ssh/mha_rsa_${NEW_KEY_DATE} $host "echo 'è¿æ¥æˆåŠŸ'"
done

# 4. æ›´æ–°SSHé…ç½®ä½¿ç”¨æ–°å¯†é’¥
sed -i "s/IdentityFile.*mha_rsa/IdentityFile ~/.ssh\/mha_rsa_${NEW_KEY_DATE}/" ~/.ssh/config

# 5. éªŒè¯MHAåŠŸèƒ½æ­£å¸¸
masterha_check_ssh --conf=/etc/mha/app1.cnf

echo "å¯†é’¥è½®æ¢å®Œæˆï¼Œè¯·æ‰‹åŠ¨æ¸…ç†æ—§å¯†é’¥"
```

**ğŸ“… å¯†é’¥è½®æ¢æ—¶é—´è¡¨**
```
å¯†é’¥è½®æ¢ç­–ç•¥ï¼š

ç”Ÿäº§ç¯å¢ƒï¼š
- æ¯å­£åº¦è½®æ¢ä¸€æ¬¡å¯†é’¥
- é‡å¤§å®‰å…¨äº‹ä»¶åç«‹å³è½®æ¢
- äººå‘˜å˜åŠ¨æ—¶è½®æ¢ç›¸å…³å¯†é’¥

æµ‹è¯•ç¯å¢ƒï¼š
- æ¯æœˆè½®æ¢ä¸€æ¬¡
- ç”¨äºéªŒè¯è½®æ¢æµç¨‹

åº”æ€¥å¤„ç†ï¼š
- å‘ç°å¯†é’¥æ³„éœ²ï¼šç«‹å³è½®æ¢
- ç³»ç»Ÿè¢«å…¥ä¾µï¼šå…¨é¢è½®æ¢æ‰€æœ‰å¯†é’¥
- ç¦»èŒå‘˜å·¥ï¼šæ’¤é”€ç›¸å…³è®¿é—®æƒé™
```

### 2.3 å¯†é’¥å®‰å…¨å­˜å‚¨

**ğŸ›¡ï¸ ç§é’¥ä¿æŠ¤æªæ–½**

```bash
# 1. ä½¿ç”¨å¯†ç ä¿æŠ¤ç§é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
ssh-keygen -t rsa -b 4096 -f ~/.ssh/mha_rsa_protected

# è¾“å…¥å¯†ç ä¿æŠ¤ç§é’¥
Enter passphrase (empty for no passphrase): [è¾“å…¥å¼ºå¯†ç ]
Enter same passphrase again: [å†æ¬¡è¾“å…¥å¯†ç ]

# 2. é…ç½®ssh-agentè‡ªåŠ¨è¾“å…¥å¯†ç 
# å¯åŠ¨ssh-agent
eval "$(ssh-agent -s)"

# æ·»åŠ å¯†é’¥åˆ°agentï¼ˆåªéœ€è¾“å…¥ä¸€æ¬¡å¯†ç ï¼‰
ssh-add ~/.ssh/mha_rsa_protected

# 3. éªŒè¯å¯†é’¥å·²åŠ è½½
ssh-add -l

# 4. å¯†é’¥å¤‡ä»½ç­–ç•¥
# å°†ç§é’¥å¤‡ä»½åˆ°å®‰å…¨ä½ç½®ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
gpg --symmetric --cipher-algo AES256 ~/.ssh/mha_rsa
# å°†åŠ å¯†åçš„æ–‡ä»¶å­˜å‚¨åˆ°å®‰å…¨çš„å¤‡ä»½ä½ç½®
```

**ğŸ”’ å¯†é’¥è®¿é—®æ§åˆ¶**
```bash
# è®¾ç½®ä¸¥æ ¼çš„æ–‡ä»¶æƒé™
chmod 600 ~/.ssh/mha_rsa          # ç§é’¥ï¼šåªæœ‰æ‰€æœ‰è€…è¯»å†™
chmod 644 ~/.ssh/mha_rsa.pub      # å…¬é’¥ï¼šæ‰€æœ‰è€…è¯»å†™ï¼Œå…¶ä»–äººåªè¯»
chmod 600 ~/.ssh/authorized_keys  # æˆæƒå¯†é’¥ï¼šåªæœ‰æ‰€æœ‰è€…è¯»å†™
chmod 600 ~/.ssh/config           # SSHé…ç½®ï¼šåªæœ‰æ‰€æœ‰è€…è¯»å†™
chmod 700 ~/.ssh                  # SSHç›®å½•ï¼šåªæœ‰æ‰€æœ‰è€…è®¿é—®

# ä½¿ç”¨ACLè¿›ä¸€æ­¥é™åˆ¶è®¿é—®ï¼ˆå¦‚æœç³»ç»Ÿæ”¯æŒï¼‰
setfacl -m u:mha-user:rw ~/.ssh/mha_rsa
setfacl -m g::--- ~/.ssh/mha_rsa
setfacl -m o::--- ~/.ssh/mha_rsa
```

---

## 3. ğŸŒ ç½‘ç»œè®¿é—®æ§åˆ¶


### 3.1 ç½‘ç»œå±‚å®‰å…¨æ¶æ„

**ğŸ—ï¸ MHAç½‘ç»œå®‰å…¨è®¾è®¡**

```
ç½‘ç»œå®‰å…¨åˆ†å±‚æ¶æ„ï¼š

å¤–ç½‘ â†’ WAF â†’ è´Ÿè½½å‡è¡¡ â†’ åº”ç”¨æœåŠ¡å™¨
                â†“
            å†…ç½‘éš”ç¦»
                â†“
        æ•°æ®åº“è®¿é—®ç½‘ç»œï¼ˆVLANï¼‰
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MHA Manager    Database Nodes  â”‚
â”‚  (ç®¡ç†ç½‘ç»œ)      (ä¸šåŠ¡ç½‘ç»œ)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç»œéš”ç¦»åŸåˆ™ï¼š
1. ç®¡ç†ç½‘ç»œä¸ä¸šåŠ¡ç½‘ç»œåˆ†ç¦»
2. æ•°æ®åº“ç½‘ç»œç‹¬ç«‹VLAN
3. MHAç®¡ç†æµé‡ä¸“ç”¨ç½‘æ®µ
4. è·³æ¿æœºä½œä¸ºå”¯ä¸€å…¥å£
```

### 3.2 VLANç½‘ç»œéš”ç¦»

**ğŸ”§ VLANé…ç½®ç¤ºä¾‹**

```bash
# ç½‘ç»œè§„åˆ’ç¤ºä¾‹
VLAN 100: ä¸šåŠ¡ç½‘ç»œ    192.168.100.0/24
VLAN 200: ç®¡ç†ç½‘ç»œ    192.168.200.0/24  
VLAN 300: æ•°æ®åº“ç½‘ç»œ  192.168.300.0/24

# MHAèŠ‚ç‚¹ç½‘ç»œé…ç½®
MHA Manager:   192.168.200.10 (ç®¡ç†ç½‘ç»œ)
DB Master:     192.168.300.100 (æ•°æ®åº“ç½‘ç»œ) + 192.168.200.100 (ç®¡ç†ç½‘ç»œ)
DB Slave1:     192.168.300.101 (æ•°æ®åº“ç½‘ç»œ) + 192.168.200.101 (ç®¡ç†ç½‘ç»œ)
DB Slave2:     192.168.300.102 (æ•°æ®åº“ç½‘ç»œ) + 192.168.200.102 (ç®¡ç†ç½‘ç»œ)

# ç½‘ç»œæ¥å£é…ç½®ï¼ˆä»¥CentOSä¸ºä¾‹ï¼‰
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
# ä¸šåŠ¡ç½‘ç»œæ¥å£
DEVICE=eth0
BOOTPROTO=static
IPADDR=192.168.300.100
NETMASK=255.255.255.0
GATEWAY=192.168.300.1
ONBOOT=yes
EOF

cat > /etc/sysconfig/network-scripts/ifcfg-eth1 << EOF
# ç®¡ç†ç½‘ç»œæ¥å£
DEVICE=eth1
BOOTPROTO=static
IPADDR=192.168.200.100
NETMASK=255.255.255.0
ONBOOT=yes
EOF
```

### 3.3 ç½‘ç»œè®¿é—®ç­–ç•¥

**ğŸ“‹ è®¿é—®æ§åˆ¶è§„åˆ™è®¾è®¡**

```
ç½‘ç»œè®¿é—®æ§åˆ¶çŸ©é˜µï¼š

æºç½‘ç»œ          ç›®æ ‡ç½‘ç»œ         ç«¯å£      åè®®    åŠ¨ä½œ
-----------------------------------------------
ç®¡ç†ç½‘ç»œ   â†’   æ•°æ®åº“ç½‘ç»œ      3306      TCP     å…è®¸
ç®¡ç†ç½‘ç»œ   â†’   æ•°æ®åº“ç½‘ç»œ      2022      TCP     å…è®¸
ä¸šåŠ¡ç½‘ç»œ   â†’   æ•°æ®åº“ç½‘ç»œ      3306      TCP     å…è®¸
å¤–ç½‘       â†’   ç®¡ç†ç½‘ç»œ        ALL       ALL     æ‹’ç»
å¤–ç½‘       â†’   æ•°æ®åº“ç½‘ç»œ      ALL       ALL     æ‹’ç»

MHAä¸“ç”¨è®¿é—®è§„åˆ™ï¼š
MHA Manager â†’ DB Nodes     SSH(2022)   å…è®¸
MHA Manager â†’ DB Nodes     MySQL(3306) å…è®¸
DB Nodes    â†’ DB Nodes     SSH(2022)   å…è®¸
DB Nodes    â†’ DB Nodes     MySQL(3306) å…è®¸
```

**ğŸ”§ ç½‘ç»œç­–ç•¥å®æ–½**
```bash
# 1. è·¯ç”±è¡¨é…ç½®
# ç¡®ä¿ç®¡ç†æµé‡èµ°ç®¡ç†ç½‘ç»œ
route add -net 192.168.200.0/24 gw 192.168.200.1 dev eth1

# 2. ç½‘ç»œç­–ç•¥é…ç½®ï¼ˆä½¿ç”¨iptableså®ç°ï¼‰
# åœ¨æ¯ä¸ªæ•°æ®åº“èŠ‚ç‚¹ä¸Šé…ç½®
iptables -A INPUT -s 192.168.200.0/24 -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -s 192.168.200.0/24 -p tcp --dport 2022 -j ACCEPT
iptables -A INPUT -s 192.168.300.0/24 -p tcp --dport 3306 -j ACCEPT

# 3. ç¦æ­¢å¤–ç½‘ç›´æ¥è®¿é—®
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 3306 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 2022 -j DROP

# ä¿å­˜è§„åˆ™
service iptables save
```

---

## 4. ğŸ”¥ é˜²ç«å¢™é…ç½®è¯¦è§£


### 4.1 iptablesé˜²ç«å¢™è§„åˆ™

**ğŸ›¡ï¸ MHAä¸“ç”¨é˜²ç«å¢™ç­–ç•¥**

```bash
#!/bin/bash
# MHAé˜²ç«å¢™é…ç½®è„šæœ¬

# æ¸…ç©ºç°æœ‰è§„åˆ™
iptables -F
iptables -X
iptables -Z

# è®¾ç½®é»˜è®¤ç­–ç•¥ï¼ˆè°¨æ…ï¼šç¡®ä¿SSHè¿æ¥ä¸ä¼šä¸­æ–­ï¼‰
iptables -P INPUT DROP    # é»˜è®¤æ‹’ç»å…¥ç«™
iptables -P FORWARD DROP  # é»˜è®¤æ‹’ç»è½¬å‘
iptables -P OUTPUT ACCEPT # é»˜è®¤å…è®¸å‡ºç«™

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# MHAç®¡ç†ç½‘ç»œè®¿é—®è§„åˆ™
# å…è®¸MHA Managerè®¿é—®
iptables -A INPUT -s 192.168.200.10 -p tcp --dport 3306 -j ACCEPT  # MySQL
iptables -A INPUT -s 192.168.200.10 -p tcp --dport 2022 -j ACCEPT  # SSH

# å…è®¸æ•°æ®åº“èŠ‚ç‚¹é—´é€šä¿¡
iptables -A INPUT -s 192.168.300.0/24 -p tcp --dport 3306 -j ACCEPT  # MySQLå¤åˆ¶
iptables -A INPUT -s 192.168.200.0/24 -p tcp --dport 2022 -j ACCEPT  # SSHç®¡ç†

# å…è®¸ä¸šåŠ¡ç½‘ç»œè®¿é—®æ•°æ®åº“
iptables -A INPUT -s 192.168.100.0/24 -p tcp --dport 3306 -j ACCEPT

# é™åˆ¶SSHè®¿é—®å°è¯•ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
iptables -A INPUT -p tcp --dport 2022 -m state --state NEW -m recent --set
iptables -A INPUT -p tcp --dport 2022 -m state --state NEW -m recent --update --seconds 60 --hitcount 4 -j DROP

# è®°å½•æ‹’ç»çš„è¿æ¥ï¼ˆç”¨äºå®‰å…¨å®¡è®¡ï¼‰
iptables -A INPUT -j LOG --log-prefix "IPTABLES-DROPPED: " --log-level 4
iptables -A INPUT -j DROP

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4
```

### 4.2 firewalldé…ç½®ï¼ˆCentOS 7+ï¼‰

**ğŸ”§ ç°ä»£é˜²ç«å¢™ç®¡ç†**

```bash
# 1. å¯ç”¨firewalld
systemctl enable firewalld
systemctl start firewalld

# 2. åˆ›å»ºMHAä¸“ç”¨zone
firewall-cmd --permanent --new-zone=mha-zone
firewall-cmd --reload

# 3. é…ç½®MHA zoneè§„åˆ™
# æ·»åŠ ç®¡ç†ç½‘ç»œæ¥å£
firewall-cmd --permanent --zone=mha-zone --add-interface=eth1

# æ·»åŠ å…è®¸çš„æœåŠ¡
firewall-cmd --permanent --zone=mha-zone --add-service=mysql
firewall-cmd --permanent --zone=mha-zone --add-service=ssh

# æ·»åŠ è‡ªå®šä¹‰ç«¯å£
firewall-cmd --permanent --zone=mha-zone --add-port=2022/tcp

# æ·»åŠ ä¿¡ä»»çš„æºIP
firewall-cmd --permanent --zone=mha-zone --add-source=192.168.200.10  # MHA Manager
firewall-cmd --permanent --zone=mha-zone --add-source=192.168.200.0/24 # ç®¡ç†ç½‘æ®µ

# 4. é…ç½®å¯Œè§„åˆ™ï¼ˆæ›´ç²¾ç»†çš„æ§åˆ¶ï¼‰
# é™åˆ¶SSHè¿æ¥é¢‘ç‡
firewall-cmd --permanent --zone=mha-zone --add-rich-rule='
rule service name="ssh" 
accept 
limit value="3/m"'

# è®°å½•æ‹’ç»çš„è¿æ¥
firewall-cmd --permanent --zone=mha-zone --add-rich-rule='
rule 
log prefix="MHA-FIREWALL-DROPPED: " level="info" 
reject'

# 5. åº”ç”¨é…ç½®
firewall-cmd --reload

# 6. éªŒè¯é…ç½®
firewall-cmd --zone=mha-zone --list-all
```

### 4.3 é˜²ç«å¢™ç›‘æ§ä¸æ—¥å¿—

**ğŸ“Š å®‰å…¨äº‹ä»¶ç›‘æ§**

```bash
# 1. é˜²ç«å¢™æ—¥å¿—é…ç½®
# ç¼–è¾‘rsyslogé…ç½®
cat >> /etc/rsyslog.conf << EOF
# é˜²ç«å¢™æ—¥å¿—å•ç‹¬å­˜å‚¨
:msg,contains,"IPTABLES-DROPPED" /var/log/firewall-dropped.log
:msg,contains,"MHA-FIREWALL-DROPPED" /var/log/mha-firewall.log
& stop
EOF

# é‡å¯rsyslog
systemctl restart rsyslog

# 2. é˜²ç«å¢™çŠ¶æ€ç›‘æ§è„šæœ¬
cat > /usr/local/bin/check_firewall_status.sh << 'EOF'
#!/bin/bash

# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
if ! systemctl is-active --quiet firewalld; then
    echo "è­¦å‘Š: firewalldæœåŠ¡æœªè¿è¡Œ" | logger -t MHA-SECURITY
    exit 1
fi

# æ£€æŸ¥å…³é”®è§„åˆ™æ˜¯å¦å­˜åœ¨
if ! firewall-cmd --zone=mha-zone --query-source=192.168.200.10; then
    echo "è­¦å‘Š: MHA Manager IPä¸åœ¨ä¿¡ä»»åˆ—è¡¨ä¸­" | logger -t MHA-SECURITY
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„è¿æ¥æ‹’ç»
DROPPED_COUNT=$(grep "$(date '+%b %d')" /var/log/firewall-dropped.log | wc -l)
if [ "$DROPPED_COUNT" -gt 100 ]; then
    echo "è­¦å‘Š: ä»Šæ—¥é˜²ç«å¢™æ‹’ç»è¿æ¥è¿‡å¤š($DROPPED_COUNTæ¬¡)" | logger -t MHA-SECURITY
fi

echo "é˜²ç«å¢™çŠ¶æ€æ­£å¸¸" | logger -t MHA-SECURITY
EOF

chmod +x /usr/local/bin/check_firewall_status.sh

# 3. å®šæ—¶æ‰§è¡Œæ£€æŸ¥
echo "*/10 * * * * /usr/local/bin/check_firewall_status.sh" | crontab -
```

---

## 5. ğŸ”’ SSLè¯ä¹¦é…ç½®


### 5.1 MySQL SSLè¯ä¹¦é…ç½®

**ğŸ›¡ï¸ æ•°æ®åº“è¿æ¥åŠ å¯†**

```bash
# 1. ç”ŸæˆCAè¯ä¹¦
mkdir -p /etc/mysql/ssl
cd /etc/mysql/ssl

# ç”ŸæˆCAç§é’¥
openssl genrsa -out ca-key.pem 4096

# ç”ŸæˆCAè¯ä¹¦
openssl req -new -x509 -key ca-key.pem -out ca-cert.pem -days 3650 \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/OU=DBA/CN=MySQL-CA"

# 2. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
# æœåŠ¡å™¨ç§é’¥
openssl genrsa -out server-key.pem 4096

# æœåŠ¡å™¨è¯ä¹¦è¯·æ±‚
openssl req -new -key server-key.pem -out server-req.pem \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/OU=DBA/CN=mysql-server"

# ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
openssl x509 -req -in server-req.pem -CA ca-cert.pem -CAkey ca-key.pem \
  -out server-cert.pem -days 365 -CAcreateserial

# 3. ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
# å®¢æˆ·ç«¯ç§é’¥
openssl genrsa -out client-key.pem 4096

# å®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚
openssl req -new -key client-key.pem -out client-req.pem \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=Company/OU=DBA/CN=mha-client"

# ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
openssl x509 -req -in client-req.pem -CA ca-cert.pem -CAkey ca-key.pem \
  -out client-cert.pem -days 365 -CAcreateserial

# 4. è®¾ç½®è¯ä¹¦æƒé™
chmod 600 *-key.pem
chmod 644 *-cert.pem
chown mysql:mysql *.pem
```

**ğŸ”§ MySQL SSLé…ç½®**
```bash
# MySQLæœåŠ¡å™¨SSLé…ç½®ï¼ˆmy.cnfï¼‰
[mysqld]
# SSLåŸºç¡€é…ç½®
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem

# å¼ºåˆ¶SSLè¿æ¥
require_secure_transport=ON

# SSLå¯†ç å¥—ä»¶é…ç½®
ssl-cipher=ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384
tls-version=TLSv1.2,TLSv1.3

# å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆå¯é€‰ï¼Œæ›´é«˜å®‰å…¨æ€§ï¼‰
ssl-ca=/etc/mysql/ssl/ca-cert.pem
# require_ssl=ON

# é‡å¯MySQLæœåŠ¡
systemctl restart mysqld

# éªŒè¯SSLé…ç½®
mysql -e "SHOW STATUS LIKE 'ssl%';"
mysql -e "SHOW VARIABLES LIKE '%ssl%';"
```

### 5.2 MHAé…ç½®æ–‡ä»¶SSLè®¾ç½®

**ğŸ”§ MHA Manager SSLè¿æ¥é…ç½®**

```bash
# MHAé…ç½®æ–‡ä»¶ä¸­çš„SSLè®¾ç½®
cat > /etc/mha/app1.cnf << 'EOF'
[server default]
# åŸºç¡€é…ç½®
manager_log=/var/log/mha/app1/manager.log
manager_workdir=/var/log/mha/app1
master_binlog_dir=/var/lib/mysql
user=mha
password=secure_password
ping_interval=3
repl_user=repl
repl_password=repl_password

# SSLè¿æ¥é…ç½®
mysql_ssl=1
mysql_ssl_ca=/etc/mysql/ssl/ca-cert.pem
mysql_ssl_cert=/etc/mysql/ssl/client-cert.pem
mysql_ssl_key=/etc/mysql/ssl/client-key.pem
mysql_ssl_verify_server_cert=1

# SSHé…ç½®
ssh_user=mha-user
ssh_port=2022

[server1]
hostname=192.168.200.100
candidate_master=1
master_binlog_dir=/var/lib/mysql

[server2]
hostname=192.168.200.101
candidate_master=1

[server3]
hostname=192.168.200.102
no_master=1
EOF

# æµ‹è¯•SSLè¿æ¥
masterha_check_ssl --conf=/etc/mha/app1.cnf
```

### 5.3 è¯ä¹¦ç®¡ç†ä¸æ›´æ–°

**ğŸ“… è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```bash
#!/bin/bash
# è¯ä¹¦ç›‘æ§å’Œæ›´æ–°è„šæœ¬

CERT_DIR="/etc/mysql/ssl"
ALERT_DAYS=30  # æå‰30å¤©å‘Šè­¦

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
check_cert_expiry() {
    local cert_file=$1
    local cert_name=$2
    
    if [ ! -f "$cert_file" ]; then
        echo "é”™è¯¯: è¯ä¹¦æ–‡ä»¶ $cert_file ä¸å­˜åœ¨"
        return 1
    fi
    
    # è·å–è¯ä¹¦åˆ°æœŸæ—¶é—´
    exp_date=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
    exp_timestamp=$(date -d "$exp_date" +%s)
    current_timestamp=$(date +%s)
    days_left=$(( (exp_timestamp - current_timestamp) / 86400 ))
    
    echo "$cert_name è¯ä¹¦è¿˜æœ‰ $days_left å¤©åˆ°æœŸ"
    
    if [ $days_left -lt $ALERT_DAYS ]; then
        echo "è­¦å‘Š: $cert_name è¯ä¹¦å°†åœ¨ $days_left å¤©ååˆ°æœŸï¼Œè¯·åŠæ—¶æ›´æ–°"
        # å‘é€å‘Šè­¦é‚®ä»¶æˆ–æ¨é€é€šçŸ¥
        logger -t MHA-SSL "è¯ä¹¦å‘Šè­¦: $cert_name å°†åœ¨ $days_left å¤©ååˆ°æœŸ"
        return 2
    fi
    
    return 0
}

# æ£€æŸ¥æ‰€æœ‰è¯ä¹¦
echo "å¼€å§‹æ£€æŸ¥SSLè¯ä¹¦çŠ¶æ€..."
check_cert_expiry "$CERT_DIR/ca-cert.pem" "CAæ ¹è¯ä¹¦"
check_cert_expiry "$CERT_DIR/server-cert.pem" "MySQLæœåŠ¡å™¨è¯ä¹¦"
check_cert_expiry "$CERT_DIR/client-cert.pem" "MHAå®¢æˆ·ç«¯è¯ä¹¦"

# éªŒè¯è¯ä¹¦é“¾
echo "éªŒè¯è¯ä¹¦é“¾..."
openssl verify -CAfile "$CERT_DIR/ca-cert.pem" "$CERT_DIR/server-cert.pem"
openssl verify -CAfile "$CERT_DIR/ca-cert.pem" "$CERT_DIR/client-cert.pem"

echo "SSLè¯ä¹¦æ£€æŸ¥å®Œæˆ"
```

---

## 6. ğŸ‘¥ ç”¨æˆ·æƒé™æ§åˆ¶


### 6.1 MySQLç”¨æˆ·æƒé™è®¾è®¡

**ğŸ”§ æœ€å°æƒé™åŸåˆ™**

```sql
-- 1. MHAç®¡ç†ç”¨æˆ·ï¼ˆç”¨äºæ•…éšœæ£€æµ‹å’Œåˆ‡æ¢ï¼‰
CREATE USER 'mha'@'192.168.200.%' IDENTIFIED BY 'secure_mha_password';

-- MHAå¿…éœ€çš„æƒé™
GRANT SELECT ON mysql.* TO 'mha'@'192.168.200.%';
GRANT PROCESS ON *.* TO 'mha'@'192.168.200.%';
GRANT SUPER ON *.* TO 'mha'@'192.168.200.%';
GRANT REPLICATION SLAVE ON *.* TO 'mha'@'192.168.200.%';
GRANT RELOAD ON *.* TO 'mha'@'192.168.200.%';

-- 2. å¤åˆ¶ç”¨æˆ·ï¼ˆä¸»ä»å¤åˆ¶ä¸“ç”¨ï¼‰
CREATE USER 'repl'@'192.168.300.%' IDENTIFIED BY 'secure_repl_password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'192.168.300.%';

-- 3. ä¸šåŠ¡ç”¨æˆ·ï¼ˆåªè¯»æƒé™ç¤ºä¾‹ï¼‰
CREATE USER 'app_read'@'192.168.100.%' IDENTIFIED BY 'app_read_password';
GRANT SELECT ON business_db.* TO 'app_read'@'192.168.100.%';

-- 4. ä¸šåŠ¡ç”¨æˆ·ï¼ˆè¯»å†™æƒé™ç¤ºä¾‹ï¼‰
CREATE USER 'app_write'@'192.168.100.%' IDENTIFIED BY 'app_write_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON business_db.* TO 'app_write'@'192.168.100.%';

-- 5. å¤‡ä»½ç”¨æˆ·ï¼ˆå¤‡ä»½ä¸“ç”¨ï¼‰
CREATE USER 'backup'@'localhost' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON *.* TO 'backup'@'localhost';
GRANT REPLICATION CLIENT ON *.* TO 'backup'@'localhost';

-- åº”ç”¨æƒé™è®¾ç½®
FLUSH PRIVILEGES;
```

**ğŸ”’ ç”¨æˆ·å®‰å…¨åŠ å›º**
```sql
-- 1. åˆ é™¤é»˜è®¤ç”¨æˆ·å’Œæµ‹è¯•æ•°æ®
DROP USER ''@'localhost';
DROP USER ''@'hostname';
DROP DATABASE test;

-- 2. ä¿®æ”¹rootç”¨æˆ·é…ç½®
-- åˆ é™¤è¿œç¨‹rootè®¿é—®
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');

-- è®¾ç½®rootå¼ºå¯†ç 
ALTER USER 'root'@'localhost' IDENTIFIED BY 'very_strong_root_password';

-- 3. è®¾ç½®å¯†ç ç­–ç•¥
-- å®‰è£…å¯†ç éªŒè¯æ’ä»¶
INSTALL PLUGIN validate_password SONAME 'validate_password.so';

-- é…ç½®å¯†ç ç­–ç•¥
SET GLOBAL validate_password.policy = 'STRONG';
SET GLOBAL validate_password.length = 12;
SET GLOBAL validate_password.number_count = 2;
SET GLOBAL validate_password.special_char_count = 2;

-- 4. è®¾ç½®å¯†ç è¿‡æœŸç­–ç•¥
ALTER USER 'mha'@'192.168.200.%' PASSWORD EXPIRE INTERVAL 90 DAY;
ALTER USER 'app_write'@'192.168.100.%' PASSWORD EXPIRE INTERVAL 60 DAY;

FLUSH PRIVILEGES;
```

### 6.2 æ“ä½œç³»ç»Ÿç”¨æˆ·æƒé™

**ğŸ‘¤ ç³»ç»Ÿç”¨æˆ·å®‰å…¨é…ç½®**

```bash
# 1. åˆ›å»ºMHAä¸“ç”¨ç”¨æˆ·
useradd -r -m -s /bin/bash mha-user
usermod -aG wheel mha-user  # æ·»åŠ åˆ°sudoç»„ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

# 2. é…ç½®sudoæƒé™ï¼ˆç²¾ç¡®æ§åˆ¶ï¼‰
cat > /etc/sudoers.d/mha-user << 'EOF'
# MHAç”¨æˆ·åªèƒ½æ‰§è¡Œç‰¹å®šå‘½ä»¤
mha-user ALL=(root) NOPASSWD: /sbin/ip, /sbin/arping
mha-user ALL=(mysql) NOPASSWD: /usr/bin/mysqld_safe
mha-user ALL=(root) NOPASSWD: /bin/systemctl start mysqld
mha-user ALL=(root) NOPASSWD: /bin/systemctl stop mysqld
mha-user ALL=(root) NOPASSWD: /bin/systemctl restart mysqld

# ç¦æ­¢ä½¿ç”¨shellé€ƒé€¸å‘½ä»¤
Defaults:mha-user !visiblepw
Defaults:mha-user !pwfeedback
EOF

# éªŒè¯sudoé…ç½®
visudo -c

# 3. é™åˆ¶ç”¨æˆ·ç™»å½•æ—¶é—´
cat >> /etc/security/time.conf << 'EOF'
# MHAç”¨æˆ·åªèƒ½åœ¨å·¥ä½œæ—¶é—´ç™»å½•
mha-user;*;*;MoTuWeThFr0800-1800
EOF

# 4. è®¾ç½®ç”¨æˆ·èµ„æºé™åˆ¶
cat >> /etc/security/limits.conf << 'EOF'
# MHAç”¨æˆ·èµ„æºé™åˆ¶
mha-user    soft    nproc       1000
mha-user    hard    nproc       2000
mha-user    soft    nofile      65536
mha-user    hard    nofile      65536
EOF
```

### 6.3 æƒé™å®¡è®¡ä¸ç›‘æ§

**ğŸ“Š æƒé™å˜æ›´ç›‘æ§**

```bash
#!/bin/bash
# æƒé™ç›‘æ§è„šæœ¬

# 1. MySQLç”¨æˆ·æƒé™ç›‘æ§
mysql -e "
SELECT 
    User, Host, 
    authentication_string,
    ssl_type,
    max_connections,
    password_expired,
    password_last_changed,
    password_lifetime
FROM mysql.user 
WHERE User IN ('mha', 'repl', 'app_write', 'app_read', 'backup')
ORDER BY User, Host;
" > /tmp/mysql_users_$(date +%Y%m%d).log

# 2. æ£€æŸ¥æ–°å¢ç”¨æˆ·
NEW_USERS=$(mysql -N -e "
SELECT CONCAT(User, '@', Host) 
FROM mysql.user 
WHERE User NOT IN ('root', 'mysql.sys', 'mysql.session', 'mysql.infoschema', 'mha', 'repl', 'app_write', 'app_read', 'backup')
")

if [ ! -z "$NEW_USERS" ]; then
    echo "å‘ç°æ–°å¢MySQLç”¨æˆ·: $NEW_USERS" | logger -t MHA-SECURITY
fi

# 3. æ£€æŸ¥æƒé™å˜æ›´
mysql -e "
SELECT 
    User, Host, Db, Table_name, Column_name, 
    Column_priv, Table_priv 
FROM mysql.columns_priv 
UNION ALL
SELECT 
    User, Host, Db, Table_name, '', 
    '', Table_priv 
FROM mysql.tables_priv
UNION ALL  
SELECT 
    User, Host, Db, '', '', 
    '', Db_priv 
FROM mysql.db
ORDER BY User, Host, Db;
" > /tmp/mysql_privileges_$(date +%Y%m%d).log

# 4. ç³»ç»Ÿç”¨æˆ·ç›‘æ§
getent passwd | awk -F: '$3 >= 1000 {print $1":"$3":"$6":"$7}' > /tmp/system_users_$(date +%Y%m%d).log

echo "æƒé™å®¡è®¡å®Œæˆï¼Œæ—¥å¿—æ–‡ä»¶å·²ç”Ÿæˆ"
```

---

## 7. ğŸ“ æ“ä½œå®¡è®¡æ—¥å¿—


### 7.1 MySQLå®¡è®¡æ—¥å¿—é…ç½®

**ğŸ“Š æ•°æ®åº“æ“ä½œå®¡è®¡**

```bash
# 1. å®‰è£…å®¡è®¡æ’ä»¶ï¼ˆMySQL Enterpriseç‰ˆæœ¬ï¼‰
# å¯¹äºMySQL Communityç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆ

# å¯ç”¨é€šç”¨æŸ¥è¯¢æ—¥å¿—ï¼ˆæ³¨æ„æ€§èƒ½å½±å“ï¼‰
[mysqld]
general_log = ON
general_log_file = /var/log/mysql/general.log

# å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = ON
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆé»˜è®¤å¯ç”¨ï¼Œç¡®ä¿é…ç½®æ­£ç¡®ï¼‰
log-bin = mysql-bin
binlog_format = ROW
sync_binlog = 1

# é”™è¯¯æ—¥å¿—
log-error = /var/log/mysql/error.log

# 2. è‡ªå®šä¹‰å®¡è®¡æ–¹æ¡ˆï¼ˆä½¿ç”¨init_connectï¼‰
# åˆ›å»ºå®¡è®¡è¡¨
mysql -e "
CREATE DATABASE IF NOT EXISTS mysql_audit;
USE mysql_audit;

CREATE TABLE IF NOT EXISTS audit_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    connection_id INT,
    username VARCHAR(100),
    hostname VARCHAR(100),
    command_type VARCHAR(100),
    sql_text TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    KEY idx_timestamp (timestamp),
    KEY idx_username (username)
);
"

# é…ç½®è¿æ¥å®¡è®¡
[mysqld]
init_connect='INSERT INTO mysql_audit.audit_log(connection_id, username, hostname, command_type) VALUES (CONNECTION_ID(), USER(), $$hostname, "CONNECT");'
```

### 7.2 ç³»ç»Ÿçº§å®¡è®¡é…ç½®

**ğŸ” ç³»ç»Ÿæ“ä½œå®¡è®¡**

```bash
# 1. é…ç½®auditdå®¡è®¡ç³»ç»Ÿ
# å®‰è£…auditd
yum install -y audit

# é…ç½®å®¡è®¡è§„åˆ™
cat > /etc/audit/rules.d/mha.rules << 'EOF'
# ç›‘æ§MHAç›¸å…³æ–‡ä»¶è®¿é—®
-w /etc/mha/ -p wa -k mha_config
-w /var/log/mha/ -p wa -k mha_logs
-w /usr/bin/masterha_manager -p x -k mha_execution
-w /usr/bin/masterha_master_switch -p x -k mha_execution

# ç›‘æ§MySQLé…ç½®æ–‡ä»¶
-w /etc/my.cnf -p wa -k mysql_config
-w /var/lib/mysql/ -p wa -k mysql_data

# ç›‘æ§SSHé…ç½®å’Œå¯†é’¥
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /home/mha-user/.ssh/ -p wa -k ssh_keys

# ç›‘æ§ç”¨æˆ·å’Œæƒé™å˜æ›´
-w /etc/passwd -p wa -k user_modification
-w /etc/group -p wa -k group_modification
-w /etc/sudoers -p wa -k sudo_modification

# ç›‘æ§ç½‘ç»œé…ç½®å˜æ›´
-w /etc/sysconfig/network-scripts/ -p wa -k network_config

# ç›‘æ§ç³»ç»Ÿè°ƒç”¨
-a always,exit -F arch=b64 -S execve -k command_execution
-a always,exit -F arch=b32 -S execve -k command_execution
EOF

# é‡å¯auditdæœåŠ¡
systemctl restart auditd
systemctl enable auditd

# 2. é…ç½®rsyslogæ”¶é›†å®¡è®¡æ—¥å¿—
cat >> /etc/rsyslog.conf << 'EOF'
# MHAå®¡è®¡æ—¥å¿—åˆ†ç±»å­˜å‚¨
:programname, isequal, "audit" /var/log/audit/audit.log
:msg, contains, "mha_config" /var/log/audit/mha-config.log
:msg, contains, "mha_execution" /var/log/audit/mha-execution.log
:msg, contains, "ssh_keys" /var/log/audit/ssh-security.log
& stop
EOF

systemctl restart rsyslog
```

### 7.3 æ—¥å¿—åˆ†æä¸å‘Šè­¦

**ğŸ“Š å®‰å…¨äº‹ä»¶åˆ†æ**

```bash
#!/bin/bash
# å®‰å…¨æ—¥å¿—åˆ†æè„šæœ¬

LOG_DATE=$(date +%Y-%m-%d)
AUDIT_LOG="/var/log/audit/audit.log"
MYSQL_LOG="/var/log/mysql/general.log"

echo "=== MHAå®‰å…¨å®¡è®¡æŠ¥å‘Š ($LOG_DATE) ==="

# 1. åˆ†æSSHç™»å½•æƒ…å†µ
echo "### SSHç™»å½•ç»Ÿè®¡ ###"
grep "sshd.*Accepted" /var/log/secure | grep "$LOG_DATE" | awk '{print $9, $11}' | sort | uniq -c | sort -nr

# 2. åˆ†æMHAæ“ä½œ
echo "### MHAæ“ä½œè®°å½• ###"
grep "mha_execution" "$AUDIT_LOG" | grep "$LOG_DATE" | while read line; do
    echo "MHAæ“ä½œ: $line"
done

# 3. åˆ†æMySQLå¼‚å¸¸è¿æ¥
echo "### MySQLå¼‚å¸¸è¿æ¥ ###"
grep "Access denied" "$MYSQL_LOG" | grep "$LOG_DATE" | awk '{print $0}' | head -10

# 4. åˆ†ææƒé™å˜æ›´
echo "### æƒé™å˜æ›´è®°å½• ###"
grep -E "(user_modification|group_modification|sudo_modification)" "$AUDIT_LOG" | grep "$LOG_DATE"

# 5. æ£€æŸ¥é…ç½®æ–‡ä»¶å˜æ›´
echo "### é…ç½®æ–‡ä»¶å˜æ›´ ###"
grep -E "(mha_config|mysql_config|ssh_config)" "$AUDIT_LOG" | grep "$LOG_DATE"

# 6. ç”Ÿæˆå®‰å…¨å‘Šè­¦
FAILED_LOGINS=$(grep "Failed password" /var/log/secure | grep "$LOG_DATE" | wc -l)
if [ $FAILED_LOGINS -gt 10 ]; then
    echo "å®‰å…¨å‘Šè­¦: ä»Šæ—¥SSHç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤š($FAILED_LOGINSæ¬¡)"
    logger -t MHA-SECURITY "SSHç™»å½•å¤±è´¥å‘Šè­¦: $FAILED_LOGINSæ¬¡"
fi

# 7. æ£€æŸ¥å¼‚å¸¸è¿›ç¨‹
ps aux | grep -E "(mysqld|masterha)" | grep -v grep > /tmp/mha_processes.log
echo "### å½“å‰MHAç›¸å…³è¿›ç¨‹ ###"
cat /tmp/mha_processes.log
```

---

## 8. ğŸ” æ•æ„Ÿä¿¡æ¯ä¿æŠ¤


### 8.1 å¯†ç å®‰å…¨ç®¡ç†

**ğŸ›¡ï¸ å¯†ç å­˜å‚¨ä¸ä¼ è¾“å®‰å…¨**

```bash
# 1. ä½¿ç”¨MySQLé…ç½®æ–‡ä»¶ä¿æŠ¤å¯†ç 
# åˆ›å»ºMHAä¸“ç”¨çš„MySQLé…ç½®æ–‡ä»¶
cat > /home/mha-user/.my.cnf << 'EOF'
[client]
user=mha
password=secure_mha_password
host=localhost
port=3306
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/client-cert.pem
ssl-key=/etc/mysql/ssl/client-key.pem
ssl-verify-server-cert=true
EOF

# è®¾ç½®ä¸¥æ ¼æƒé™
chmod 600 /home/mha-user/.my.cnf
chown mha-user:mha-user /home/mha-user/.my.cnf

# 2. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆä¸´æ—¶å¯†ç ï¼‰
# åˆ›å»ºå®‰å…¨çš„ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
cat > /home/mha-user/.mha_env << 'EOF'
#!/bin/bash
# MHAç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨æ—¶sourceï¼Œç”¨å®Œunsetï¼‰
export MHA_MYSQL_USER="mha"
export MHA_MYSQL_PASS="secure_mha_password"
export MHA_REPL_USER="repl"
export MHA_REPL_PASS="secure_repl_password"

# è‡ªåŠ¨æ¸…ç†å‡½æ•°
cleanup_env() {
    unset MHA_MYSQL_USER
    unset MHA_MYSQL_PASS
    unset MHA_REPL_USER
    unset MHA_REPL_PASS
    echo "ç¯å¢ƒå˜é‡å·²æ¸…ç†"
}

# è®¾ç½®è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨ï¼ˆ30åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†ï¼‰
(sleep 1800; cleanup_env) &
EOF

chmod 600 /home/mha-user/.mha_env
chown mha-user:mha-user /home/mha-user/.mha_env
```

### 8.2 é…ç½®æ–‡ä»¶åŠ å¯†

**ğŸ”’ æ•æ„Ÿé…ç½®ä¿æŠ¤**

```bash
# 1. ä½¿ç”¨gpgåŠ å¯†MHAé…ç½®æ–‡ä»¶
# ç”ŸæˆGPGå¯†é’¥å¯¹
gpg --gen-key
# é€‰æ‹©å¯†é’¥ç±»å‹ã€é•¿åº¦ï¼Œè®¾ç½®ç”¨æˆ·ä¿¡æ¯å’Œå¯†ç 

# åŠ å¯†MHAé…ç½®æ–‡ä»¶
gpg --cipher-algo AES256 --compress-algo 1 --symmetric /etc/mha/app1.cnf
# è¾“å…¥å¯†ç ï¼Œç”Ÿæˆapp1.cnf.gpg

# åˆ é™¤æ˜æ–‡é…ç½®æ–‡ä»¶
shred -vfz -n 3 /etc/mha/app1.cnf

# 2. åˆ›å»ºé…ç½®æ–‡ä»¶è§£å¯†è„šæœ¬
cat > /usr/local/bin/mha_decrypt_config.sh << 'EOF'
#!/bin/bash
CONFIG_FILE="/etc/mha/app1.cnf"
ENCRYPTED_FILE="/etc/mha/app1.cnf.gpg"

# æ£€æŸ¥åŠ å¯†æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$ENCRYPTED_FILE" ]; then
    echo "é”™è¯¯: åŠ å¯†é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# è§£å¯†é…ç½®æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
gpg --quiet --batch --decrypt "$ENCRYPTED_FILE" > "$CONFIG_FILE.tmp"

if [ $? -eq 0 ]; then
    mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
    echo "é…ç½®æ–‡ä»¶è§£å¯†æˆåŠŸ"
    
    # è®¾ç½®è‡ªåŠ¨æ¸…ç†å®šæ—¶å™¨ï¼ˆä½¿ç”¨å30åˆ†é’Ÿè‡ªåŠ¨åˆ é™¤ï¼‰
    (sleep 1800; shred -vfz -n 3 "$CONFIG_FILE") &
else
    echo "é…ç½®æ–‡ä»¶è§£å¯†å¤±è´¥"
    rm -f "$CONFIG_FILE.tmp"
    exit 1
fi
EOF

chmod +x /usr/local/bin/mha_decrypt_config.sh

# 3. ä½¿ç”¨ansible-vaultï¼ˆå¦‚æœä½¿ç”¨Ansibleç®¡ç†ï¼‰
# å®‰è£…ansible
pip install ansible

# åˆ›å»ºåŠ å¯†çš„å˜é‡æ–‡ä»¶
ansible-vault create /etc/mha/secrets.yml
# åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥æ•æ„Ÿä¿¡æ¯ï¼š
# mysql_mha_password: secure_mha_password
# mysql_repl_password: secure_repl_password

# åœ¨MHAè„šæœ¬ä¸­ä½¿ç”¨
ansible-vault view /etc/mha/secrets.yml --vault-password-file /etc/mha/.vault_pass
```

### 8.3 å†…å­˜å®‰å…¨å¤„ç†

**ğŸ§  è¿è¡Œæ—¶æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**

```bash
# 1. åˆ›å»ºå®‰å…¨çš„å¯†ç å¤„ç†å‡½æ•°
cat > /usr/local/lib/mha_security.sh << 'EOF'
#!/bin/bash

# å®‰å…¨è¯»å–å¯†ç ï¼ˆä¸å›æ˜¾ï¼‰
read_secure_password() {
    local prompt="$1"
    local password
    
    echo -n "$prompt"
    read -s password
    echo
    
    # è¿”å›å¯†ç ï¼ˆè°ƒç”¨è€…è´Ÿè´£æ¸…ç†ï¼‰
    echo "$password"
}

# å®‰å…¨æ¸…ç†å†…å­˜ä¸­çš„å¯†ç 
clear_password_from_memory() {
    local password="$1"
    
    # ç”¨éšæœºæ•°æ®è¦†ç›–å¯†ç å˜é‡
    for i in {1..10}; do
        password=$(openssl rand -base64 ${#password})
    done
    
    unset password
}

# å®‰å…¨æ‰§è¡ŒMySQLå‘½ä»¤
secure_mysql_execute() {
    local sql="$1"
    local temp_config=$(mktemp)
    
    # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
    cat > "$temp_config" << EOF
[client]
user=${MHA_MYSQL_USER}
password=${MHA_MYSQL_PASS}
host=localhost
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/client-cert.pem
ssl-key=/etc/mysql/ssl/client-key.pem
EOF
    
    # æ‰§è¡ŒSQL
    mysql --defaults-file="$temp_config" -e "$sql"
    local result=$?
    
    # å®‰å…¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶
    shred -vfz -n 3 "$temp_config"
    
    return $result
}

# è¿›ç¨‹å†…å­˜ä¿æŠ¤
protect_process_memory() {
    # ç¦ç”¨core dump
    ulimit -c 0
    
    # ç¦ç”¨swapï¼ˆé˜²æ­¢å¯†ç å†™å…¥äº¤æ¢æ–‡ä»¶ï¼‰
    if [ "$(id -u)" -eq 0 ]; then
        echo 1 > /proc/sys/vm/drop_caches
        swapoff -a
        swapon -a
    fi
}
EOF

chmod 644 /usr/local/lib/mha_security.sh
```

---

## 9. ğŸŒ è®¿é—®IPé™åˆ¶


### 9.1 åŸºäºæºIPçš„è®¿é—®æ§åˆ¶

**ğŸ”§ ç½‘ç»œå±‚IPé™åˆ¶**

```bash
# 1. MySQLå±‚é¢çš„IPé™åˆ¶
# å·²åœ¨ç”¨æˆ·æƒé™éƒ¨åˆ†é…ç½®ï¼Œè¿™é‡Œå±•ç¤ºç®¡ç†æ–¹æ³•

# æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„IPé™åˆ¶
mysql -e "
SELECT User, Host, ssl_type, max_connections 
FROM mysql.user 
WHERE User IN ('mha', 'repl', 'app_write', 'app_read')
ORDER BY User, Host;
"

# 2. æ“ä½œç³»ç»Ÿå±‚é¢çš„IPé™åˆ¶
# ä½¿ç”¨hosts.allowå’Œhosts.deny

# é…ç½®å…è®¸è®¿é—®çš„IP
cat > /etc/hosts.allow << 'EOF'
# SSHè®¿é—®é™åˆ¶
sshd: 192.168.200.10 : ALLOW  # MHA Manager
sshd: 192.168.200.0/24 : ALLOW  # ç®¡ç†ç½‘æ®µ
sshd: 192.168.100.5 : ALLOW   # è·³æ¿æœº

# MySQLè®¿é—®é™åˆ¶ï¼ˆå¦‚æœMySQLç¼–è¯‘æ—¶æ”¯æŒtcpwrappersï¼‰
mysqld: 192.168.200.0/24 : ALLOW  # ç®¡ç†ç½‘æ®µ
mysqld: 192.168.300.0/24 : ALLOW  # æ•°æ®åº“ç½‘æ®µ
mysqld: 192.168.100.0/24 : ALLOW  # ä¸šåŠ¡ç½‘æ®µ
EOF

# æ‹’ç»å…¶ä»–æ‰€æœ‰è®¿é—®
cat > /etc/hosts.deny << 'EOF'
sshd: ALL : DENY
mysqld: ALL : DENY
EOF

# 3. ä½¿ç”¨iptableså®ç°IPç™½åå•
cat > /usr/local/bin/setup_ip_whitelist.sh << 'EOF'
#!/bin/bash

# æ¸…ç©ºç°æœ‰è§„åˆ™
iptables -F INPUT
iptables -F OUTPUT

# è®¾ç½®é»˜è®¤ç­–ç•¥
iptables -P INPUT DROP
iptables -P OUTPUT ACCEPT

# å…è®¸æœ¬åœ°å›ç¯
iptables -A INPUT -i lo -j ACCEPT

# å…è®¸å·²å»ºç«‹çš„è¿æ¥
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# MHA Manager IPç™½åå•
MHA_MANAGER_IP="192.168.200.10"
iptables -A INPUT -s $MHA_MANAGER_IP -p tcp --dport 3306 -j ACCEPT
iptables -A INPUT -s $MHA_MANAGER_IP -p tcp --dport 2022 -j ACCEPT

# ç®¡ç†ç½‘æ®µç™½åå•
iptables -A INPUT -s 192.168.200.0/24 -p tcp --dport 2022 -j ACCEPT

# æ•°æ®åº“ç½‘æ®µç™½åå•ï¼ˆç”¨äºä¸»ä»å¤åˆ¶ï¼‰
iptables -A INPUT -s 192.168.300.0/24 -p tcp --dport 3306 -j ACCEPT

# ä¸šåŠ¡ç½‘æ®µç™½åå•
iptables -A INPUT -s 192.168.100.0/24 -p tcp --dport 3306 -j ACCEPT

# è·³æ¿æœºIPç™½åå•
JUMPSERVER_IP="192.168.100.5"
iptables -A INPUT -s $JUMPSERVER_IP -p tcp --dport 2022 -j ACCEPT

# è®°å½•è¢«æ‹’ç»çš„è¿æ¥
iptables -A INPUT -j LOG --log-prefix "IPTABLES-WHITELIST-DENIED: "
iptables -A INPUT -j DROP

# ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4

echo "IPç™½åå•è§„åˆ™å·²è®¾ç½®"
EOF

chmod +x /usr/local/bin/setup_ip_whitelist.sh
```

### 9.2 åŠ¨æ€IPç®¡ç†

**ğŸ“Š IPç™½åå•åŠ¨æ€ç®¡ç†**

```bash
# 1. åˆ›å»ºIPç®¡ç†è„šæœ¬
cat > /usr/local/bin/manage_ip_whitelist.sh << 'EOF'
#!/bin/bash

WHITELIST_FILE="/etc/mha/ip_whitelist.conf"
LOG_FILE="/var/log/mha/ip_management.log"

# åˆå§‹åŒ–ç™½åå•æ–‡ä»¶
init_whitelist() {
    cat > "$WHITELIST_FILE" << 'EOL'
# MHA IPç™½åå•é…ç½®
# æ ¼å¼: IP/CIDR:æè¿°:æ·»åŠ æ—¶é—´
192.168.200.10:MHA-Manager:$(date '+%Y-%m-%d %H:%M:%S')
192.168.200.0/24:Management-Network:$(date '+%Y-%m-%d %H:%M:%S')
192.168.300.0/24:Database-Network:$(date '+%Y-%m-%d %H:%M:%S')
192.168.100.0/24:Business-Network:$(date '+%Y-%m-%d %H:%M:%S')
EOL
}

# æ·»åŠ IPåˆ°ç™½åå•
add_ip() {
    local ip="$1"
    local description="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # éªŒè¯IPæ ¼å¼
    if ! echo "$ip" | grep -E '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(/[0-9]{1,2})?$' > /dev/null; then
        echo "é”™è¯¯: IPæ ¼å¼ä¸æ­£ç¡®"
        return 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if grep "^$ip:" "$WHITELIST_FILE" > /dev/null 2>&1; then
        echo "IP $ip å·²åœ¨ç™½åå•ä¸­"
        return 0
    fi
    
    # æ·»åŠ åˆ°æ–‡ä»¶
    echo "$ip:$description:$timestamp" >> "$WHITELIST_FILE"
    
    # æ·»åŠ é˜²ç«å¢™è§„åˆ™
    iptables -I INPUT -s "$ip" -p tcp --dport 3306 -j ACCEPT
    iptables -I INPUT -s "$ip" -p tcp --dport 2022 -j ACCEPT
    
    # ä¿å­˜è§„åˆ™
    iptables-save > /etc/iptables/rules.v4
    
    echo "å·²æ·»åŠ IP $ip åˆ°ç™½åå•" | tee -a "$LOG_FILE"
}

# åˆ é™¤IPä»ç™½åå•
remove_ip() {
    local ip="$1"
    
    # ä»æ–‡ä»¶ä¸­åˆ é™¤
    sed -i "/^$ip:/d" "$WHITELIST_FILE"
    
    # åˆ é™¤é˜²ç«å¢™è§„åˆ™
    iptables -D INPUT -s "$ip" -p tcp --dport 3306 -j ACCEPT 2>/dev/null
    iptables -D INPUT -s "$ip" -p tcp --dport 2022 -j ACCEPT 2>/dev/null
    
    # ä¿å­˜è§„åˆ™
    iptables-save > /etc/iptables/rules.v4
    
    echo "å·²ä»ç™½åå•åˆ é™¤IP $ip" | tee -a "$LOG_FILE"
}

# æ˜¾ç¤ºå½“å‰ç™½åå•
show_whitelist() {
    echo "å½“å‰IPç™½åå•:"
    echo "IPåœ°å€/ç½‘æ®µ        æè¿°           æ·»åŠ æ—¶é—´"
    echo "================================================"
    while IFS=: read -r ip desc time; do
        printf "%-18s %-15s %s\n" "$ip" "$desc" "$time"
    done < "$WHITELIST_FILE"
}

# ä¸»ç¨‹åº
case "$1" in
    init)
        init_whitelist
        echo "ç™½åå•å·²åˆå§‹åŒ–"
        ;;
    add)
        if [ $# -ne 3 ]; then
            echo "ç”¨æ³•: $0 add <IP/CIDR> <æè¿°>"
            exit 1
        fi
        add_ip "$2" "$3"
        ;;
    remove)
        if [ $# -ne 2 ]; then
            echo "ç”¨æ³•: $0 remove <IP/CIDR>"
            exit 1
        fi
        remove_ip "$2"
        ;;
    show)
        show_whitelist
        ;;
    *)
        echo "ç”¨æ³•: $0 {init|add|remove|show}"
        echo "  init                    - åˆå§‹åŒ–ç™½åå•"
        echo "  add <IP> <æè¿°>         - æ·»åŠ IPåˆ°ç™½åå•"
        echo "  remove <IP>             - ä»ç™½åå•åˆ é™¤IP"
        echo "  show                    - æ˜¾ç¤ºå½“å‰ç™½åå•"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/manage_ip_whitelist.sh

# 2. åˆ›å»ºIPè®¿é—®ç›‘æ§è„šæœ¬
cat > /usr/local/bin/monitor_ip_access.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/mha/ip_access.log"
ALERT_THRESHOLD=5  # 5æ¬¡å¤±è´¥å°è¯•åå‘Šè­¦

# åˆ†æè®¿é—®æ—¥å¿—
analyze_access() {
    local today=$(date '+%Y-%m-%d')
    
    echo "=== IPè®¿é—®åˆ†ææŠ¥å‘Š ($today) ===" | tee -a "$LOG_FILE"
    
    # åˆ†æSSHè®¿é—®
    echo "### SSHè®¿é—®ç»Ÿè®¡ ###" | tee -a "$LOG_FILE"
    grep "sshd.*Failed password" /var/log/secure | grep "$today" | \
    awk '{print $NF}' | sort | uniq -c | sort -nr | head -10 | tee -a "$LOG_FILE"
    
    # åˆ†æMySQLè¿æ¥
    echo "### MySQLè¿æ¥ç»Ÿè®¡ ###" | tee -a "$LOG_FILE"
    grep "Access denied" /var/log/mysql/error.log | grep "$today" | \
    grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
    sort | uniq -c | sort -nr | head -10 | tee -a "$LOG_FILE"
    
    # æ£€æŸ¥å¼‚å¸¸IP
    echo "### å¼‚å¸¸IPæ£€æµ‹ ###" | tee -a "$LOG_FILE"
    grep "IPTABLES-WHITELIST-DENIED" /var/log/messages | grep "$today" | \
    grep -oE 'SRC=[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | \
    cut -d= -f2 | sort | uniq -c | sort -nr | \
    while read count ip; do
        if [ "$count" -gt "$ALERT_THRESHOLD" ]; then
            echo "å‘Šè­¦: IP $ip å°è¯•è®¿é—® $count æ¬¡" | tee -a "$LOG_FILE"
            logger -t MHA-SECURITY "å¼‚å¸¸IPå‘Šè­¦: $ip å°è¯•è®¿é—® $count æ¬¡"
        fi
    done
}

# æ‰§è¡Œåˆ†æ
analyze_access
EOF

chmod +x /usr/local/bin/monitor_ip_access.sh

# è®¾ç½®å®šæ—¶æ‰§è¡Œ
echo "0 */6 * * * /usr/local/bin/monitor_ip_access.sh" | crontab -
```

---

## 10. ğŸ”„ å®‰å…¨è¡¥ä¸ç®¡ç†


### 10.1 ç³»ç»Ÿè¡¥ä¸ç®¡ç†ç­–ç•¥

**ğŸ“… è¡¥ä¸æ›´æ–°è®¡åˆ’**

```bash
# 1. åˆ›å»ºè¡¥ä¸ç®¡ç†è„šæœ¬
cat > /usr/local/bin/patch_management.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/mha/patch_management.log"
BACKUP_DIR="/backup/pre_patch_$(date +%Y%m%d)"

# è®°å½•æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# åˆ›å»ºå¤‡ä»½ç›®å½•
create_backup() {
    log_message "å¼€å§‹åˆ›å»ºç³»ç»Ÿå¤‡ä»½..."
    mkdir -p "$BACKUP_DIR"
    
    # å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
    cp -r /etc/mha/ "$BACKUP_DIR/"
    cp -r /etc/mysql/ "$BACKUP_DIR/"
    cp /etc/ssh/sshd_config "$BACKUP_DIR/"
    cp /etc/my.cnf "$BACKUP_DIR/"
    
    # å¤‡ä»½æ•°æ®åº“é…ç½®
    mysqldump --single-transaction --routines --triggers --all-databases > "$BACKUP_DIR/mysql_backup.sql"
    
    log_message "ç³»ç»Ÿå¤‡ä»½å®Œæˆ: $BACKUP_DIR"
}

# æ£€æŸ¥å¯ç”¨è¡¥ä¸
check_patches() {
    log_message "æ£€æŸ¥å¯ç”¨è¡¥ä¸..."
    
    # CentOS/RHELç³»ç»Ÿ
    if command -v yum >/dev/null 2>&1; then
        yum check-update > "$BACKUP_DIR/available_patches.txt" 2>&1
        SECURITY_UPDATES=$(yum --security check-update 2>/dev/null | grep -c "^[a-zA-Z]")
    # Ubuntu/Debianç³»ç»Ÿ  
    elif command -v apt >/dev/null 2>&1; then
        apt list --upgradable > "$BACKUP_DIR/available_patches.txt" 2>&1
        SECURITY_UPDATES=$(apt list --upgradable 2>/dev/null | grep -c security)
    fi
    
    log_message "å‘ç° $SECURITY_UPDATES ä¸ªå®‰å…¨æ›´æ–°"
    
    # å¦‚æœæœ‰å®‰å…¨æ›´æ–°ï¼Œå‘é€å‘Šè­¦
    if [ "$SECURITY_UPDATES" -gt 0 ]; then
        log_message "å‘Šè­¦: å‘ç°å®‰å…¨è¡¥ä¸éœ€è¦å®‰è£…"
        logger -t MHA-SECURITY "å‘ç° $SECURITY_UPDATES ä¸ªå®‰å…¨è¡¥ä¸éœ€è¦å®‰è£…"
    fi
}

# å®‰è£…å®‰å…¨è¡¥ä¸
install_security_patches() {
    log_message "å¼€å§‹å®‰è£…å®‰å…¨è¡¥ä¸..."
    
    # åœæ­¢MHAæœåŠ¡
    systemctl stop mha-manager 2>/dev/null || true
    
    # å®‰è£…è¡¥ä¸
    if command -v yum >/dev/null 2>&1; then
        yum update --security -y | tee -a "$LOG_FILE"
    elif command -v apt >/dev/null 2>&1; then
        apt update && apt upgrade -y | tee -a "$LOG_FILE"
    fi
    
    log_message "å®‰å…¨è¡¥ä¸å®‰è£…å®Œæˆ"
}

# éªŒè¯ç³»ç»ŸçŠ¶æ€
verify_system() {
    log_message "éªŒè¯ç³»ç»ŸçŠ¶æ€..."
    
    # æ£€æŸ¥å…³é”®æœåŠ¡
    for service in mysqld sshd firewalld; do
        if systemctl is-active --quiet $service; then
            log_message "$service æœåŠ¡æ­£å¸¸è¿è¡Œ"
        else
            log_message "è­¦å‘Š: $service æœåŠ¡æœªè¿è¡Œ"
        fi
    done
    
    # æ£€æŸ¥MHAè¿æ¥
    if masterha_check_ssh --conf=/etc/mha/app1.cnf >/dev/null 2>&1; then
        log_message "MHA SSHè¿æ¥æ£€æŸ¥é€šè¿‡"
    else
        log_message "è­¦å‘Š: MHA SSHè¿æ¥æ£€æŸ¥å¤±è´¥"
    fi
    
    # æ£€æŸ¥MySQLè¿æ¥
    if mysql -e "SELECT 1" >/dev/null 2>&1; then
        log_message "MySQLè¿æ¥æ­£å¸¸"
    else
        log_message "è­¦å‘Š: MySQLè¿æ¥å¤±è´¥"
    fi
}

# ä¸»ç¨‹åº
case "$1" in
    check)
        check_patches
        ;;
    backup)
        create_backup
        ;;
    install)
        create_backup
        install_security_patches
        verify_system
        ;;
    verify)
        verify_system
        ;;
    *)
        echo "ç”¨æ³•: $0 {check|backup|install|verify}"
        echo "  check   - æ£€æŸ¥å¯ç”¨è¡¥ä¸"
        echo "  backup  - åˆ›å»ºç³»ç»Ÿå¤‡ä»½"
        echo "  install - å®‰è£…å®‰å…¨è¡¥ä¸"
        echo "  verify  - éªŒè¯ç³»ç»ŸçŠ¶æ€"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/patch_management.sh

# 2. åˆ›å»ºè‡ªåŠ¨åŒ–è¡¥ä¸ç›‘æ§
cat > /usr/local/bin/security_monitor.sh << 'EOF'
#!/bin/bash

ALERT_EMAIL="admin@company.com"
CRITICAL_PATCHES_FILE="/tmp/critical_patches.txt"

# æ£€æŸ¥å…³é”®å®‰å…¨è¡¥ä¸
check_critical_patches() {
    # MySQLç›¸å…³è¡¥ä¸
    if command -v yum >/dev/null 2>&1; then
        yum list available mysql* | grep -i security > "$CRITICAL_PATCHES_FILE" 2>/dev/null
        yum list available openssh* | grep -i security >> "$CRITICAL_PATCHES_FILE" 2>/dev/null
    elif command -v apt >/dev/null 2>&1; then
        apt list --upgradable | grep -E "(mysql|openssh)" | grep security > "$CRITICAL_PATCHES_FILE" 2>/dev/null
    fi
    
    if [ -s "$CRITICAL_PATCHES_FILE" ]; then
        echo "å‘ç°å…³é”®å®‰å…¨è¡¥ä¸:"
        cat "$CRITICAL_PATCHES_FILE"
        
        # å‘é€é‚®ä»¶å‘Šè­¦ï¼ˆéœ€è¦é…ç½®é‚®ä»¶ç³»ç»Ÿï¼‰
        if command -v mail >/dev/null 2>&1; then
            mail -s "MHAæœåŠ¡å™¨å…³é”®å®‰å…¨è¡¥ä¸å‘Šè­¦" "$ALERT_EMAIL" < "$CRITICAL_PATCHES_FILE"
        fi
        
        logger -t MHA-SECURITY "å‘ç°å…³é”®å®‰å…¨è¡¥ä¸éœ€è¦å®‰è£…"
        return 1
    fi
    
    return 0
}

# æ£€æŸ¥ç³»ç»Ÿå®Œæ•´æ€§
check_system_integrity() {
    # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦è¢«ç¯¡æ”¹
    CRITICAL_FILES="/etc/mha/app1.cnf /etc/my.cnf /etc/ssh/sshd_config /etc/passwd /etc/sudoers"
    
    for file in $CRITICAL_FILES; do
        if [ -f "$file" ]; then
            # è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼
            current_hash=$(sha256sum "$file" | cut -d' ' -f1)
            stored_hash_file="/var/lib/mha/checksums/$(basename $file).sha256"
            
            if [ -f "$stored_hash_file" ]; then
                stored_hash=$(cat "$stored_hash_file")
                if [ "$current_hash" != "$stored_hash" ]; then
                    echo "è­¦å‘Š: æ–‡ä»¶ $file å¯èƒ½è¢«ç¯¡æ”¹"
                    logger -t MHA-SECURITY "æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥: $file"
                fi
            else
                # é¦–æ¬¡è¿è¡Œï¼Œå­˜å‚¨å“ˆå¸Œå€¼
                mkdir -p /var/lib/mha/checksums
                echo "$current_hash" > "$stored_hash_file"
            fi
        fi
    done
}

# æ‰§è¡Œæ£€æŸ¥
echo "å¼€å§‹å®‰å…¨ç›‘æ§æ£€æŸ¥..."
check_critical_patches
check_system_integrity
echo "å®‰å…¨ç›‘æ§æ£€æŸ¥å®Œæˆ"
EOF

chmod +x /usr/local/bin/security_monitor.sh

# 3. è®¾ç½®è‡ªåŠ¨åŒ–ä»»åŠ¡
cat > /etc/cron.d/mha-security << 'EOF'
# MHAå®‰å…¨ç®¡ç†å®šæ—¶ä»»åŠ¡

# æ¯å¤©å‡Œæ™¨æ£€æŸ¥è¡¥ä¸
0 2 * * * root /usr/local/bin/patch_management.sh check

# æ¯å‘¨æ—¥åˆ›å»ºå¤‡ä»½
0 3 * * 0 root /usr/local/bin/patch_management.sh backup

# æ¯4å°æ—¶æ‰§è¡Œå®‰å…¨ç›‘æ§
0 */4 * * * root /usr/local/bin/security_monitor.sh

# æ¯å¤©æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰
0 4 * * * root find /var/log/mha/ -name "*.log" -mtime +30 -delete
EOF
```

### 10.2 MySQLå®‰å…¨æ›´æ–°ç®¡ç†

**ğŸ”§ æ•°æ®åº“å®‰å…¨è¡¥ä¸ç­–ç•¥**

```bash
# 1. MySQLç‰ˆæœ¬ç®¡ç†è„šæœ¬
cat > /usr/local/bin/mysql_security_update.sh << 'EOF'
#!/bin/bash

MYSQL_VERSION_FILE="/var/lib/mha/mysql_version.txt"
BACKUP_DIR="/backup/mysql_upgrade_$(date +%Y%m%d_%H%M%S)"

# æ£€æŸ¥MySQLç‰ˆæœ¬å’Œå®‰å…¨å…¬å‘Š
check_mysql_security() {
    current_version=$(mysql --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
    echo "$current_version" > "$MYSQL_VERSION_FILE"
    
    echo "å½“å‰MySQLç‰ˆæœ¬: $current_version"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨æ›´æ–°ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´ï¼‰
    if command -v yum >/dev/null 2>&1; then
        available_version=$(yum list available mysql-server | tail -n1 | awk '{print $2}')
    elif command -v apt >/dev/null 2>&1; then
        available_version=$(apt list mysql-server 2>/dev/null | grep -v WARNING | tail -n1 | cut -d' ' -f2)
    fi
    
    echo "å¯ç”¨MySQLç‰ˆæœ¬: $available_version"
    
    # æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è¯¥ä½¿ç”¨ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°ï¼‰
    if [ "$current_version" != "$available_version" ]; then
        echo "å‘ç°MySQLæ›´æ–°ç‰ˆæœ¬"
        logger -t MHA-SECURITY "å‘ç°MySQLå®‰å…¨æ›´æ–°: $current_version -> $available_version"
        return 1
    fi
    
    return 0
}

# å®‰å…¨çš„MySQLæ›´æ–°æµç¨‹
safe_mysql_update() {
    echo "å¼€å§‹MySQLå®‰å…¨æ›´æ–°æµç¨‹..."
    
    # 1. åˆ›å»ºå®Œæ•´å¤‡ä»½
    mkdir -p "$BACKUP_DIR"
    echo "åˆ›å»ºå¤‡ä»½åˆ°: $BACKUP_DIR"
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶
    cp /etc/my.cnf "$BACKUP_DIR/"
    cp -r /etc/mysql/ "$BACKUP_DIR/" 2>/dev/null || true
    
    # å¤‡ä»½æ•°æ®
    mysqldump --single-transaction --routines --triggers --events \
      --all-databases --master-data=2 > "$BACKUP_DIR/full_backup.sql"
    
    # 2. åœæ­¢MHAç›‘æ§
    systemctl stop mha-manager 2>/dev/null || true
    
    # 3. æ‰§è¡Œæ›´æ–°
    if command -v yum >/dev/null 2>&1; then
        yum update mysql-server mysql-client -y
    elif command -v apt >/dev/null 2>&1; then
        apt update && apt upgrade mysql-server mysql-client -y
    fi
    
    # 4. é‡å¯MySQLæœåŠ¡
    systemctl restart mysqld
    
    # 5. è¿è¡Œmysql_upgrade
    mysql_upgrade --force
    
    # 6. éªŒè¯æ›´æ–°
    if mysql -e "SELECT VERSION();" >/dev/null 2>&1; then
        echo "MySQLæ›´æ–°æˆåŠŸ"
        new_version=$(mysql --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        echo "æ–°ç‰ˆæœ¬: $new_version"
        echo "$new_version" > "$MYSQL_VERSION_FILE"
    else
        echo "MySQLæ›´æ–°å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
        # å›æ»šæ“ä½œï¼ˆæ ¹æ®å®é™…æƒ…å†µå®ç°ï¼‰
        systemctl stop mysqld
        # è¿™é‡Œåº”è¯¥å®ç°å®Œæ•´çš„å›æ»šæµç¨‹
        echo "è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶ä¿®å¤MySQLæœåŠ¡"
        exit 1
    fi
    
    # 7. é‡å¯MHAç›‘æ§
    systemctl start mha-manager
    
    # 8. éªŒè¯MHAåŠŸèƒ½
    sleep 10
    if masterha_check_repl --conf=/etc/mha/app1.cnf >/dev/null 2>&1; then
        echo "MHAåŠŸèƒ½éªŒè¯é€šè¿‡"
    else
        echo "è­¦å‘Š: MHAåŠŸèƒ½éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
    fi
    
    echo "MySQLå®‰å…¨æ›´æ–°å®Œæˆ"
}

# ä¸»ç¨‹åº
case "$1" in
    check)
        check_mysql_security
        ;;
    update)
        safe_mysql_update
        ;;
    *)
        echo "ç”¨æ³•: $0 {check|update}"
        echo "  check  - æ£€æŸ¥MySQLå®‰å…¨æ›´æ–°"
        echo "  update - æ‰§è¡ŒMySQLå®‰å…¨æ›´æ–°"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/mysql_security_update.sh
```

### 10.3 å®‰å…¨è¡¥ä¸æµ‹è¯•ç¯å¢ƒ

**ğŸ§ª è¡¥ä¸éªŒè¯æµç¨‹**

```bash
# 1. åˆ›å»ºæµ‹è¯•ç¯å¢ƒè„šæœ¬
cat > /usr/local/bin/setup_patch_test_env.sh << 'EOF'
#!/bin/bash

TEST_ENV_DIR="/opt/mha_test_env"
PROD_CONFIG_DIR="/etc/mha"

# åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
setup_test_environment() {
    echo "è®¾ç½®è¡¥ä¸æµ‹è¯•ç¯å¢ƒ..."
    
    # åˆ›å»ºæµ‹è¯•ç›®å½•
    mkdir -p "$TEST_ENV_DIR"/{config,logs,backup}
    
    # å¤åˆ¶ç”Ÿäº§é…ç½®åˆ°æµ‹è¯•ç¯å¢ƒ
    cp -r "$PROD_CONFIG_DIR"/* "$TEST_ENV_DIR/config/"
    
    # ä¿®æ”¹æµ‹è¯•é…ç½®ï¼ˆä½¿ç”¨æµ‹è¯•æ•°æ®åº“ï¼‰
    sed -i 's/hostname=192\.168\.200\./hostname=192.168.210./g' "$TEST_ENV_DIR/config/app1.cnf"
    sed -i 's/manager_log=.*$/manager_log=$TEST_ENV_DIR\/logs\/manager.log/' "$TEST_ENV_DIR/config/app1.cnf"
    
    echo "æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ: $TEST_ENV_DIR"
}

# åœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯è¡¥ä¸
test_patches() {
    echo "åœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯è¡¥ä¸..."
    
    # 1. å¤‡ä»½æµ‹è¯•ç¯å¢ƒ
    cp -r "$TEST_ENV_DIR" "$TEST_ENV_DIR.backup.$(date +%Y%m%d)"
    
    # 2. åº”ç”¨è¡¥ä¸
    if command -v yum >/dev/null 2>&1; then
        yum update --security -y
    elif command -v apt >/dev/null 2>&1; then
        apt update && apt upgrade -y
    fi
    
    # 3. æµ‹è¯•MHAåŠŸèƒ½
    export MHA_CONFIG="$TEST_ENV_DIR/config/app1.cnf"
    
    # æ£€æŸ¥SSHè¿æ¥
    if masterha_check_ssh --conf="$MHA_CONFIG"; then
        echo "âœ“ SSHè¿æ¥æµ‹è¯•é€šè¿‡"
    else
        echo "âœ— SSHè¿æ¥æµ‹è¯•å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥å¤åˆ¶çŠ¶æ€
    if masterha_check_repl --conf="$MHA_CONFIG"; then
        echo "âœ“ å¤åˆ¶çŠ¶æ€æ£€æŸ¥é€šè¿‡"
    else
        echo "âœ— å¤åˆ¶çŠ¶æ€æ£€æŸ¥å¤±è´¥"
        return 1
    fi
    
    # æ£€æŸ¥æ•…éšœåˆ‡æ¢ï¼ˆä»…æ¨¡æ‹Ÿï¼Œä¸å®é™…æ‰§è¡Œï¼‰
    echo "âœ“ è¡¥ä¸æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ"
    return 0
}

# æ¸…ç†æµ‹è¯•ç¯å¢ƒ
cleanup_test_env() {
    echo "æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
    rm -rf "$TEST_ENV_DIR.backup."*
    echo "æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ"
}

# ä¸»ç¨‹åº
case "$1" in
    setup)
        setup_test_environment
        ;;
    test)
        test_patches
        ;;
    cleanup)
        cleanup_test_env
        ;;
    *)
        echo "ç”¨æ³•: $0 {setup|test|cleanup}"
        echo "  setup   - è®¾ç½®æµ‹è¯•ç¯å¢ƒ"
        echo "  test    - åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¡¥ä¸"
        echo "  cleanup - æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/setup_patch_test_env.sh
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SSHå®‰å…¨åŠ å›ºï¼šä¿®æ”¹ç«¯å£ã€ç¦ç”¨å¯†ç è®¤è¯ã€é™åˆ¶ç”¨æˆ·ã€è®¾ç½®è¶…æ—¶
ğŸ”¸ å¯†é’¥ç®¡ç†ï¼šå¼ºå¯†é’¥ç”Ÿæˆã€å®‰å…¨åˆ†å‘ã€å®šæœŸè½®æ¢ã€æƒé™æ§åˆ¶
ğŸ”¸ ç½‘ç»œè®¿é—®æ§åˆ¶ï¼šVLANéš”ç¦»ã€IPç™½åå•ã€é˜²ç«å¢™è§„åˆ™ã€è®¿é—®å®¡è®¡
ğŸ”¸ SSLè¯ä¹¦é…ç½®ï¼šæ•°æ®åº“è¿æ¥åŠ å¯†ã€è¯ä¹¦ç®¡ç†ã€å®šæœŸæ›´æ–°éªŒè¯
ğŸ”¸ ç”¨æˆ·æƒé™æ§åˆ¶ï¼šæœ€å°æƒé™åŸåˆ™ã€æƒé™åˆ†ç¦»ã€å®šæœŸå®¡è®¡æ¸…ç†
ğŸ”¸ æ“ä½œå®¡è®¡æ—¥å¿—ï¼šç³»ç»Ÿå®¡è®¡ã€æ•°æ®åº“å®¡è®¡ã€æ—¥å¿—åˆ†æå‘Šè­¦
ğŸ”¸ æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ï¼šå¯†ç åŠ å¯†å­˜å‚¨ã€å†…å­˜å®‰å…¨ã€é…ç½®æ–‡ä»¶ä¿æŠ¤
ğŸ”¸ è®¿é—®IPé™åˆ¶ï¼šæºIPæ§åˆ¶ã€åŠ¨æ€ç®¡ç†ã€å¼‚å¸¸æ£€æµ‹å¤„ç†
ğŸ”¸ å®‰å…¨è¡¥ä¸ç®¡ç†ï¼šå®šæœŸæ£€æŸ¥ã€æµ‹è¯•éªŒè¯ã€å®‰å…¨æ›´æ–°æµç¨‹
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šå±‚é˜²æŠ¤çš„å®‰å…¨ç†å¿µ**
```
ç½‘ç»œå±‚å®‰å…¨ï¼š
- é˜²ç«å¢™ + IPç™½åå•åŒé‡ä¿æŠ¤
- VLANéš”ç¦» + è®¿é—®æ§åˆ¶ç­–ç•¥
- æµé‡ç›‘æ§ + å¼‚å¸¸æ£€æµ‹å‘Šè­¦

åº”ç”¨å±‚å®‰å…¨ï¼š
- SSLåŠ å¯†ä¼ è¾“ + èº«ä»½è®¤è¯
- æƒé™æœ€å°åŒ– + æ“ä½œå®¡è®¡
- å¯†ç ç­–ç•¥ + å®šæœŸè½®æ¢

ç³»ç»Ÿå±‚å®‰å…¨ï¼š
- SSHåŠ å›º + å¯†é’¥ç®¡ç†
- è¡¥ä¸ç®¡ç† + å®Œæ•´æ€§æ£€æŸ¥
- æ—¥å¿—å®¡è®¡ + äº‹ä»¶å“åº”
```

**ğŸ”¹ MHAç¯å¢ƒçš„ç‰¹æ®Šå®‰å…¨éœ€æ±‚**
```
é«˜æƒé™éœ€æ±‚ï¼š
- MHAéœ€è¦ç®¡ç†å‘˜æƒé™æ‰§è¡Œæ•…éšœåˆ‡æ¢
- å¿…é¡»å¹³è¡¡å®‰å…¨æ€§ä¸å¯ç”¨æ€§è¦æ±‚
- é€šè¿‡ç²¾ç¡®æƒé™æ§åˆ¶é™ä½é£é™©

ç½‘ç»œè¿é€šæ€§ï¼š
- ç®¡ç†èŠ‚ç‚¹éœ€è¦è®¿é—®æ‰€æœ‰æ•°æ®åº“èŠ‚ç‚¹
- é€šè¿‡ä¸“ç”¨ç®¡ç†ç½‘ç»œéš”ç¦»ä¸šåŠ¡æµé‡
- å®æ–½ä¸¥æ ¼çš„ç½‘ç»œè®¿é—®æ§åˆ¶ç­–ç•¥

è‡ªåŠ¨åŒ–å®‰å…¨ï¼š
- æ•…éšœåˆ‡æ¢éœ€è¦æ— äººå€¼å®ˆæ‰§è¡Œ
- é€šè¿‡å¯†é’¥è®¤è¯ + æƒé™æ§åˆ¶ä¿éšœ
- å®æ—¶ç›‘æ§ + å®¡è®¡ç¡®ä¿å®‰å…¨å¯æ§
```

**ğŸ”¹ å®‰å…¨ä¸å¯ç”¨æ€§çš„å¹³è¡¡**
```
å®‰å…¨æªæ–½ä¸èƒ½å½±å“MHAæ ¸å¿ƒåŠŸèƒ½ï¼š
- ç½‘ç»œç­–ç•¥å¿…é¡»å…è®¸å¿…è¦çš„ç®¡ç†é€šä¿¡
- æƒé™æ§åˆ¶è¦ç¡®ä¿æ•…éšœåˆ‡æ¢èƒ½æ­£å¸¸æ‰§è¡Œ
- å®¡è®¡æ—¥å¿—ä¸èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½

æ¸è¿›å¼å®‰å…¨åŠ å›ºï¼š
- å…ˆå»ºç«‹åŸºç¡€å®‰å…¨æ¡†æ¶
- é€æ­¥åŠ å¼ºå„å±‚å®‰å…¨æªæ–½
- æŒç»­ç›‘æ§å’Œä¼˜åŒ–å®‰å…¨ç­–ç•¥
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå®‰å…¨å®è·µ**
- **é‡‘èè¡Œä¸š**ï¼šä¸¥æ ¼çš„æƒé™æ§åˆ¶å’Œæ“ä½œå®¡è®¡ï¼Œæ»¡è¶³åˆè§„è¦æ±‚
- **ç”µå•†å¹³å°**ï¼šå¤šå±‚ç½‘ç»œé˜²æŠ¤å’Œå®æ—¶ç›‘æ§ï¼Œä¿éšœä¸šåŠ¡è¿ç»­æ€§
- **æ”¿åºœæœºæ„**ï¼šå®Œæ•´çš„å®‰å…¨ç®¡ç†ä½“ç³»ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å¯æ§
- **åŒ»ç–—ç³»ç»Ÿ**ï¼šæ•æ„Ÿä¿¡æ¯ä¿æŠ¤å’Œè®¿é—®æ§åˆ¶ï¼Œç¬¦åˆéšç§æ³•è§„

**ğŸ”§ è¿ç»´å®‰å…¨å»ºè®®**
- **åˆ†å±‚å®æ–½**ï¼šæŒ‰ä¼˜å…ˆçº§é€æ­¥å®æ–½å„é¡¹å®‰å…¨æªæ–½
- **æŒç»­ç›‘æ§**ï¼šå»ºç«‹å®Œå–„çš„å®‰å…¨ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- **å®šæœŸæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œå®‰å…¨äº‹ä»¶å“åº”æ¼”ç»ƒ
- **æ–‡æ¡£ç®¡ç†**ï¼šç»´æŠ¤å®Œæ•´çš„å®‰å…¨é…ç½®å’Œæ“ä½œæ–‡æ¡£

**ğŸ“ˆ å®‰å…¨å‘å±•è¶‹åŠ¿**
- **è‡ªåŠ¨åŒ–å®‰å…¨**ï¼šé€šè¿‡å·¥å…·å®ç°å®‰å…¨ç­–ç•¥çš„è‡ªåŠ¨åŒ–ç®¡ç†
- **é›¶ä¿¡ä»»æ¶æ„**ï¼šä¸ä¿¡ä»»ä»»ä½•ç½‘ç»œä½ç½®ï¼ŒéªŒè¯æ¯æ¬¡è®¿é—®
- **åˆè§„è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨åŒ–çš„åˆè§„æ£€æŸ¥å’ŒæŠ¥å‘Šç”Ÿæˆ
- **AIå®‰å…¨**ï¼šåˆ©ç”¨æœºå™¨å­¦ä¹ æ£€æµ‹å¼‚å¸¸è¡Œä¸ºå’Œå¨èƒ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- SSHåŠ å›ºå¯†é’¥ç®¡ï¼Œç½‘ç»œéš”ç¦»é˜²ç«å¢™
- æƒé™æœ€å°å®¡è®¡å…¨ï¼Œè¡¥ä¸åŠæ—¶è«æ‹–å»¶
- è¯ä¹¦åŠ å¯†ä¼ è¾“å®‰ï¼Œç›‘æ§å‘Šè­¦ä¿å¹³å®‰
- å¤šå±‚é˜²æŠ¤ç¯ç¯æ‰£ï¼Œå®‰å…¨è¿ç»´æ— åé¡¾