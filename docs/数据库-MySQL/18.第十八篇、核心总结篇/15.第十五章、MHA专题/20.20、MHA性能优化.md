---
title: 20、MHA性能优化
---
## 📚 目录

1. [MHA性能优化概述](#1-MHA性能优化概述)
2. [切换性能优化](#2-切换性能优化)
3. [网络延迟优化](#3-网络延迟优化)
4. [存储IO优化](#4-存储IO优化)
5. [脚本执行优化](#5-脚本执行优化)
6. [监控频率调优](#6-监控频率调优)
7. [资源使用优化](#7-资源使用优化)
8. [并发处理优化](#8-并发处理优化)
9. [内存与CPU优化](#9-内存与CPU优化)
10. [网络带宽优化](#10-网络带宽优化)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🚀 MHA性能优化概述


### 1.1 什么是MHA性能优化


**通俗理解**：MHA性能优化就像给汽车调校发动机，让MySQL主从切换更快、更稳定、更省资源。

```
优化前的MHA：              优化后的MHA：
切换时间：30-60秒           切换时间：10-15秒
CPU占用：70%               CPU占用：30%
网络延迟：100ms            网络延迟：20ms
内存使用：2GB              内存使用：800MB
```

**核心目标**：
- **🎯 切换速度**：缩短故障切换时间，减少业务中断
- **💰 资源节省**：降低CPU、内存、网络带宽消耗
- **🔧 稳定性**：提高切换成功率，减少切换失败
- **📊 可监控**：优化监控策略，及时发现问题

### 1.2 性能优化的重要性


**业务影响分析**：
```
切换时间对比：
未优化：60秒切换时间
已优化：15秒切换时间
业务损失：减少75%的服务中断时间

资源成本对比：
未优化：每台服务器2GB内存占用
已优化：每台服务器800MB内存占用
成本节省：节约60%的硬件资源
```

### 1.3 优化策略框架


**性能优化金字塔**：
```
        应用层优化
       ┌─────────────┐
       │ 脚本和配置优化 │
       └─────────────┘
      ┌─────────────────┐
      │   网络层优化     │
      └─────────────────┘
     ┌─────────────────────┐
     │    存储层优化       │
     └─────────────────────┘
    ┌─────────────────────────┐
    │      硬件层优化         │
    └─────────────────────────┘
```

---

## 2. ⚡ 切换性能优化


### 2.1 切换时间分析


**切换过程时间分解**：
```
完整切换流程耗时分析：
┌─────────────────────────────────────────────┐
│ 故障检测     │ 5-10秒  │ 检测主库故障      │
├─────────────────────────────────────────────┤
│ 选举新主     │ 2-5秒   │ 选择最佳从库      │
├─────────────────────────────────────────────┤
│ 数据补齐     │ 10-30秒 │ 应用剩余日志      │
├─────────────────────────────────────────────┤
│ 权限切换     │ 3-8秒   │ 修改只读属性      │
├─────────────────────────────────────────────┤
│ 应用切换     │ 5-15秒  │ 更新应用配置      │
└─────────────────────────────────────────────┘
总计：25-68秒
```

### 2.2 故障检测优化


**检测参数调优**：
```bash
# 默认配置（较慢）
ping_interval=3
ping_type=SELECT
secondary_check_script=/usr/local/bin/masterha_secondary_check

# 优化配置（更快）
ping_interval=1                    # 检测间隔缩短到1秒
ping_type=CONNECT                  # 使用连接检测，更轻量
connect_timeout=3                  # 连接超时3秒
read_timeout=5                     # 读取超时5秒
```

**多重检测机制**：
```bash
# 配置文件 /etc/mha/app1.cnf
[server default]
# 主检测：直接连接检测
ping_type=CONNECT

# 辅助检测：通过其他节点检测
secondary_check_script=/usr/local/bin/masterha_secondary_check \
  -s slave1 -s slave2 --user=root --master_host=master1 \
  --master_ip=192.168.1.10 --master_port=3306
```

### 2.3 数据同步优化


**并行复制配置**：
```sql
-- 在所有从库上启用并行复制
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';
SET GLOBAL slave_parallel_workers = 4;  -- 根据CPU核数调整
SET GLOBAL slave_preserve_commit_order = ON;

-- 优化复制缓冲区
SET GLOBAL relay_log_space_limit = 1073741824;  -- 1GB
SET GLOBAL slave_pending_jobs_size_max = 134217728;  -- 128MB
```

**半同步复制优化**：
```sql
-- 主库配置
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
SET GLOBAL rpl_semi_sync_master_enabled = 1;
SET GLOBAL rpl_semi_sync_master_timeout = 1000;  -- 1秒超时
SET GLOBAL rpl_semi_sync_master_wait_no_slave = OFF;

-- 从库配置
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
SET GLOBAL rpl_semi_sync_slave_enabled = 1;
```

---

## 3. 🌐 网络延迟优化


### 3.1 网络延迟问题诊断


**延迟测试工具**：
```bash
# 基础延迟测试
ping -c 10 192.168.1.10

# MySQL连接延迟测试
time mysql -h192.168.1.10 -uroot -p -e "SELECT 1"

# 网络质量监控脚本
#!/bin/bash
for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
  echo "测试到 $host 的延迟:"
  ping -c 5 $host | tail -1
  echo "---"
done
```

**网络质量分析**：
```
延迟等级划分：
优秀：< 1ms   (同机房内网)
良好：1-5ms   (同城不同机房)
一般：5-20ms  (同省不同城市)
较差：> 20ms  (跨省或国际)

MHA建议：
同机房部署：延迟 < 2ms
同城部署：延迟 < 10ms
跨城部署：需要特殊优化
```

### 3.2 网络参数调优


**系统网络参数优化**：
```bash
# /etc/sysctl.conf 网络优化配置
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144  
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# TCP连接优化
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_fin_timeout = 30

# 应用配置
sysctl -p
```

**MySQL网络优化**：
```sql
-- MySQL网络参数调优
SET GLOBAL max_connect_errors = 1000000;
SET GLOBAL max_connections = 2000;
SET GLOBAL back_log = 500;
SET GLOBAL connect_timeout = 10;
SET GLOBAL net_read_timeout = 30;
SET GLOBAL net_write_timeout = 60;
```

### 3.3 连接池优化


**MHA连接复用**：
```bash
# MHA配置文件优化
[server default]
# 连接复用设置
repl_user=repl
repl_password=replpass
ssh_user=mha

# 连接保持设置
ping_interval=1
master_ip_failover_script=/usr/local/bin/master_ip_failover
master_ip_online_change_script=/usr/local/bin/master_ip_online_change
```

---

## 4. 💾 存储IO优化


### 4.1 存储性能分析


**IO性能测试**：
```bash
# 磁盘IO性能测试
iostat -x 1 10

# MySQL专用IO测试
sysbench fileio --file-total-size=10G prepare
sysbench fileio --file-total-size=10G --file-test-mode=rndrw \
  --time=300 --max-requests=0 run

# 结果分析
echo "IOPS: $(计算每秒IO操作数)"
echo "延迟: $(计算平均响应时间)"
```

**存储性能标准**：
```
存储类型性能对比：
┌─────────────┬─────────┬─────────┬─────────┐
│   存储类型   │  IOPS   │  延迟   │ 带宽    │
├─────────────┼─────────┼─────────┼─────────┤
│ 机械硬盘     │ 100-200 │ 10-15ms │ 150MB/s │
│ SATA SSD    │ 10K-50K │ 0.1-1ms │ 500MB/s │
│ NVMe SSD    │ 50K-1M  │ 0.02ms  │ 3GB/s   │
│ 内存盘      │ 1M+     │ 0.001ms │ 10GB/s  │
└─────────────┴─────────┴─────────┴─────────┘
```

### 4.2 MySQL存储优化


**InnoDB参数调优**：
```sql
-- 缓冲池优化
SET GLOBAL innodb_buffer_pool_size = 8G;  -- 设为物理内存的70%
SET GLOBAL innodb_buffer_pool_instances = 8;

-- 日志优化
SET GLOBAL innodb_log_file_size = 1G;
SET GLOBAL innodb_log_buffer_size = 64M;
SET GLOBAL innodb_flush_log_at_trx_commit = 1;  -- 保证安全性

-- IO优化
SET GLOBAL innodb_io_capacity = 2000;      -- 根据存储IOPS调整
SET GLOBAL innodb_io_capacity_max = 4000;
SET GLOBAL innodb_read_io_threads = 8;
SET GLOBAL innodb_write_io_threads = 8;
```

**文件系统优化**：
```bash
# 文件系统挂载优化
mount -o noatime,nodiratime,nobarrier /dev/sdb1 /var/lib/mysql

# /etc/fstab 持久化配置
/dev/sdb1 /var/lib/mysql ext4 noatime,nodiratime,nobarrier 0 0

# SSD优化
echo noop > /sys/block/sdb/queue/scheduler  # SSD使用noop调度器
echo 1 > /sys/block/sdb/queue/discard_max_bytes  # 启用TRIM
```

### 4.3 二进制日志优化


**binlog性能调优**：
```sql
-- 二进制日志设置
SET GLOBAL binlog_cache_size = 2M;
SET GLOBAL max_binlog_cache_size = 128M;
SET GLOBAL sync_binlog = 1;               -- 保证安全性
SET GLOBAL binlog_group_commit_sync_delay = 100;  -- 批量提交延迟

-- 日志格式优化
SET GLOBAL binlog_format = 'ROW';         -- 推荐使用ROW格式
SET GLOBAL binlog_row_image = 'MINIMAL';  -- 减少日志大小
```

---

## 5. 📜 脚本执行优化


### 5.1 MHA脚本性能分析


**脚本执行时间监控**：
```bash
#!/bin/bash
# 脚本性能监控 /usr/local/bin/mha_script_monitor.sh

# 记录脚本执行时间
exec_time_start=$(date +%s.%N)

# 原始脚本执行
source /usr/local/bin/original_script.sh

# 计算执行时间
exec_time_end=$(date +%s.%N)
exec_time=$(echo "$exec_time_end - $exec_time_start" | bc)

echo "脚本执行时间: ${exec_time}秒" >> /var/log/mha/script_performance.log
```

### 5.2 IP切换脚本优化


**高效IP切换脚本**：
```bash
#!/bin/bash
# 优化版本的IP切换脚本 /usr/local/bin/master_ip_failover_optimized

source /etc/mha/mha_env.sh

VIP="192.168.1.100"
NETMASK="24"
INTERFACE="eth0"

# 函数：快速检查VIP状态
check_vip() {
    local host=$1
    timeout 2 ssh -o ConnectTimeout=1 $host "ip addr show $INTERFACE | grep -q $VIP" 2>/dev/null
    return $?
}

# 函数：添加VIP（优化版）
add_vip() {
    local host=$1
    ssh -o ConnectTimeout=3 $host "
        # 并行执行多个操作
        {
            ip addr add ${VIP}/${NETMASK} dev $INTERFACE
            arping -c 3 -I $INTERFACE $VIP >/dev/null 2>&1 &
        }
        # 立即返回，不等待arping完成
        echo 'VIP added successfully'
    " 2>/dev/null
}

# 函数：删除VIP（优化版）
remove_vip() {
    local host=$1
    ssh -o ConnectTimeout=3 $host "
        ip addr del ${VIP}/${NETMASK} dev $INTERFACE 2>/dev/null || true
        echo 'VIP removed successfully'
    " 2>/dev/null
}

# 主逻辑
case "$1" in
    --command=start)
        echo "开始IP切换..."
        remove_vip $orig_master_host
        add_vip $new_master_host
        ;;
    --command=stopssh)
        echo "停止SSH连接..."
        remove_vip $orig_master_host
        ;;
    *)
        echo "用法: $0 {--command=start|--command=stopssh}"
        exit 1
        ;;
esac
```

### 5.3 监控脚本优化


**轻量级健康检查**：
```bash
#!/bin/bash
# 优化的健康检查脚本 /usr/local/bin/mha_health_check_optimized

MYSQL_HOST=$1
MYSQL_PORT=${2:-3306}
MYSQL_USER="mha_monitor"
MYSQL_PASS="monitor_pass"

# 超时设置
CONNECT_TIMEOUT=2
READ_TIMEOUT=3

# 使用更轻量的检查方式
check_mysql() {
    # 方法1：TCP连接检查（最快）
    timeout $CONNECT_TIMEOUT bash -c "</dev/tcp/$MYSQL_HOST/$MYSQL_PORT" 2>/dev/null
    if [ $? -eq 0 ]; then
        return 0
    fi
    
    # 方法2：MySQL ping（备用）
    timeout $READ_TIMEOUT mysqladmin \
        -h$MYSQL_HOST -P$MYSQL_PORT \
        -u$MYSQL_USER -p$MYSQL_PASS \
        ping >/dev/null 2>&1
    return $?
}

# 执行检查
if check_mysql; then
    echo "MySQL服务正常"
    exit 0
else
    echo "MySQL服务异常"
    exit 1
fi
```

---

## 6. 📊 监控频率调优


### 6.1 监控参数优化


**MHA监控配置调优**：
```bash
# /etc/mha/app1.cnf 监控优化配置
[server default]
# 基础监控参数
ping_interval=1                    # 检测间隔：1秒（默认3秒）
ping_type=CONNECT                  # 连接检测（比SELECT更快）
ping_timeout=5                     # ping超时：5秒

# 二次检查优化
secondary_check_script=/usr/local/bin/mha_secondary_check_fast
candidate_master=1                 # 指定候选主库，减少选举时间

# SSH连接优化
ssh_connection_timeout=5           # SSH连接超时
ssh_options="-o ConnectTimeout=3 -o StrictHostKeyChecking=no"
```

### 6.2 监控频率分级策略


**动态监控频率**：
```bash
#!/bin/bash
# 智能监控频率调整 /usr/local/bin/adaptive_monitoring.sh

# 根据系统负载调整监控频率
get_system_load() {
    uptime | awk '{print $(NF-2)}' | sed 's/,//'
}

# 根据网络延迟调整监控频率  
get_network_delay() {
    ping -c 1 $MASTER_HOST | grep 'time=' | awk '{print $7}' | cut -d= -f2
}

# 动态调整逻辑
adjust_monitoring_frequency() {
    local load=$(get_system_load)
    local delay=$(get_network_delay)
    
    if (( $(echo "$load > 5.0" | bc -l) )); then
        echo "高负载，增加监控频率到0.5秒"
        PING_INTERVAL=0.5
    elif (( $(echo "$delay > 10" | bc -l) )); then
        echo "高延迟，调整监控频率到2秒"
        PING_INTERVAL=2
    else
        echo "正常状态，标准监控频率1秒"
        PING_INTERVAL=1
    fi
}
```

### 6.3 监控数据收集优化


**高效监控数据采集**：
```sql
-- 轻量级监控查询
-- 替代复杂的SHOW STATUS查询
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE 
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN (
    'Threads_connected',
    'Threads_running', 
    'Seconds_Behind_Master'
)
UNION ALL
SELECT 
    'Replication_Status',
    IF(COUNT(*) > 0, 'Running', 'Stopped')
FROM information_schema.processlist 
WHERE COMMAND = 'Binlog Dump';
```

---

## 7. 🔧 资源使用优化


### 7.1 内存使用优化


**MHA进程内存优化**：
```bash
# MHA Manager内存限制
ulimit -v 1048576  # 限制虚拟内存为1GB

# 优化MHA配置以减少内存使用
[server default]
max_ping_errors=3              # 减少错误重试次数
candidate_master=1             # 明确指定候选主库
check_repl_delay=0            # 禁用延迟检查（如果不需要）
```

**MySQL内存参数调优**：
```sql
-- 连接相关内存优化
SET GLOBAL max_connections = 1000;        -- 根据实际需求调整
SET GLOBAL thread_cache_size = 100;       -- 线程缓存
SET GLOBAL table_open_cache = 4000;       -- 表缓存

-- 查询相关内存优化
SET GLOBAL query_cache_type = 0;          -- 禁用查询缓存（MySQL 8.0已移除）
SET GLOBAL sort_buffer_size = 2M;         -- 排序缓冲区
SET GLOBAL read_buffer_size = 1M;         -- 读缓冲区
```

### 7.2 CPU使用优化


**进程优先级调整**：
```bash
# 提高MHA Manager进程优先级
nice -n -10 masterha_manager --conf=/etc/mha/app1.cnf

# 设置CPU亲和性（绑定到特定CPU核心）
taskset -c 0,1 masterha_manager --conf=/etc/mha/app1.cnf

# 限制MHA进程CPU使用率
cpulimit -l 50 -p $(pgrep masterha_manager)
```

**MySQL CPU优化**：
```sql
-- 减少CPU密集操作
SET GLOBAL innodb_stats_auto_recalc = OFF;    -- 关闭自动统计更新
SET GLOBAL innodb_stats_persistent = OFF;     -- 关闭持久化统计
SET GLOBAL performance_schema = OFF;          -- 关闭性能监控（如果不需要）

-- 优化查询处理
SET GLOBAL query_cache_size = 0;              -- 禁用查询缓存减少CPU开销
```

### 7.3 磁盘空间优化


**日志文件管理**：
```bash
#!/bin/bash
# MHA日志清理脚本 /usr/local/bin/mha_log_cleanup.sh

LOG_DIR="/var/log/mha"
MYSQL_LOG_DIR="/var/lib/mysql"

# 清理MHA日志（保留7天）
find $LOG_DIR -name "*.log" -mtime +7 -delete

# 清理MySQL慢查询日志（保留3天）
find $MYSQL_LOG_DIR -name "*slow.log*" -mtime +3 -delete

# 清理MySQL错误日志（保留30天）
find $MYSQL_LOG_DIR -name "error.log.*" -mtime +30 -delete

# 压缩历史日志
find $LOG_DIR -name "*.log" -mtime +1 -exec gzip {} \;

echo "日志清理完成: $(date)"
```

---

## 8. 🔄 并发处理优化


### 8.1 并发连接优化


**SSH连接池管理**：
```bash
# SSH连接复用配置 ~/.ssh/config
Host mha-*
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h-%p
    ControlPersist 600
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ConnectTimeout 5

# 创建socket目录
mkdir -p ~/.ssh/sockets
```

**MySQL连接优化**：
```sql
-- 连接处理优化
SET GLOBAL max_connections = 2000;
SET GLOBAL max_connect_errors = 1000000;
SET GLOBAL back_log = 500;
SET GLOBAL thread_cache_size = 200;

-- 连接超时优化
SET GLOBAL connect_timeout = 10;
SET GLOBAL interactive_timeout = 3600;
SET GLOBAL wait_timeout = 3600;
```

### 8.2 并行操作优化


**并行数据同步**：
```bash
#!/bin/bash
# 并行数据同步脚本 /usr/local/bin/parallel_sync.sh

SLAVE_HOSTS=("slave1" "slave2" "slave3")
NEW_MASTER="slave1"

# 并行执行CHANGE MASTER操作
parallel_change_master() {
    local host=$1
    ssh $host "mysql -e \"
        STOP SLAVE;
        CHANGE MASTER TO 
            MASTER_HOST='$NEW_MASTER',
            MASTER_USER='repl',
            MASTER_PASSWORD='replpass',
            MASTER_AUTO_POSITION=1;
        START SLAVE;
    \"" &
}

# 启动并行操作
for host in "${SLAVE_HOSTS[@]}"; do
    if [ "$host" != "$NEW_MASTER" ]; then
        parallel_change_master $host
    fi
done

# 等待所有操作完成
wait
echo "所有从库重新配置完成"
```

### 8.3 锁等待优化


**减少锁冲突**：
```sql
-- InnoDB锁等待优化
SET GLOBAL innodb_lock_wait_timeout = 10;     -- 锁等待超时10秒
SET GLOBAL innodb_rollback_on_timeout = ON;   -- 超时回滚
SET GLOBAL innodb_deadlock_detect = ON;       -- 死锁检测

-- 减少元数据锁等待
SET GLOBAL lock_wait_timeout = 5;             -- 元数据锁等待5秒
```

---

## 9. 💻 内存与CPU优化


### 9.1 内存分配策略


**系统内存分配**：
```
内存分配建议（16GB服务器）：
┌─────────────────────────────────────────┐
│ 操作系统预留    │ 2GB    │ 12.5%      │
├─────────────────────────────────────────┤
│ MySQL缓冲池     │ 10GB   │ 62.5%      │
├─────────────────────────────────────────┤
│ MySQL其他内存   │ 2GB    │ 12.5%      │
├─────────────────────────────────────────┤
│ MHA进程内存     │ 512MB  │ 3.1%       │
├─────────────────────────────────────────┤
│ 系统缓存       │ 1.5GB  │ 9.4%       │
└─────────────────────────────────────────┘
```

**内存监控脚本**：
```bash
#!/bin/bash
# 内存使用监控 /usr/local/bin/memory_monitor.sh

# 获取内存使用情况
get_memory_usage() {
    free -m | awk 'NR==2{printf "内存使用率: %.2f%%\n", $3*100/$2}'
    
    # MySQL内存使用
    ps aux | grep mysql | grep -v grep | awk '{sum+=$6} END {print "MySQL内存使用:", sum/1024, "MB"}'
    
    # MHA内存使用
    ps aux | grep masterha | grep -v grep | awk '{sum+=$6} END {print "MHA内存使用:", sum/1024, "MB"}'
}

# 内存告警
check_memory_threshold() {
    local usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ $usage -gt 85 ]; then
        echo "警告：内存使用率超过85%，当前为${usage}%"
        # 可以添加告警通知逻辑
    fi
}

get_memory_usage
check_memory_threshold
```

### 9.2 CPU优化策略


**CPU资源分配**：
```bash
# CPU核心绑定
# 将MySQL绑定到前4个核心
taskset -cp 0-3 $(pgrep mysqld)

# 将MHA绑定到后2个核心
taskset -cp 4-5 $(pgrep masterha_manager)

# 查看CPU绑定状态
ps -eo pid,comm,psr | grep -E "(mysql|masterha)"
```

**CPU性能监控**：
```bash
#!/bin/bash
# CPU监控脚本 /usr/local/bin/cpu_monitor.sh

# 获取CPU使用率
get_cpu_usage() {
    echo "=== CPU使用情况 ==="
    top -bn1 | grep "Cpu(s)" | awk '{print "CPU使用率:", $2}'
    
    echo "=== 各进程CPU使用 ==="
    ps aux --sort=-%cpu | head -10 | awk '{printf "%-10s %-10s %s\n", $3"%", $11, $2}'
    
    echo "=== MySQL线程状态 ==="
    mysql -e "SHOW PROCESSLIST" | grep -v "Sleep" | wc -l | awk '{print "活跃连接数:", $1}'
}

# CPU告警检查
check_cpu_threshold() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)
    if (( $(echo "$cpu_usage > 80" | bc -l) )); then
        echo "警告：CPU使用率超过80%，当前为${cpu_usage}%"
    fi
}

get_cpu_usage
check_cpu_threshold
```

---

## 10. 🌐 网络带宽优化


### 10.1 网络流量分析


**带宽监控工具**：
```bash
# 网络流量实时监控
iftop -i eth0 -P

# 网络统计信息
cat /proc/net/dev | awk '
BEGIN{print "接口\t\t接收(MB)\t发送(MB)"}
NR>2{
    rx_mb=$2/1024/1024;
    tx_mb=$10/1024/1024;
    printf "%-15s\t%.2f\t\t%.2f\n", $1, rx_mb, tx_mb
}'

# MySQL网络连接监控
netstat -an | grep :3306 | wc -l
```

### 10.2 数据传输优化


**MySQL网络传输优化**：
```sql
-- 网络缓冲区优化
SET GLOBAL net_buffer_length = 32768;         -- 32KB网络缓冲区
SET GLOBAL max_allowed_packet = 1073741824;   -- 1GB最大包大小
SET GLOBAL net_read_timeout = 30;             -- 读超时30秒
SET GLOBAL net_write_timeout = 60;            -- 写超时60秒

-- 压缩传输（谨慎使用，会增加CPU负载）
-- SET GLOBAL slave_compressed_protocol = ON;
```

**数据同步优化**：
```sql
-- 并行复制配置（减少网络阻塞）
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';
SET GLOBAL slave_parallel_workers = 4;
SET GLOBAL slave_preserve_commit_order = ON;

-- 复制缓冲区优化
SET GLOBAL relay_log_space_limit = 2147483648;  -- 2GB中继日志空间
SET GLOBAL slave_pending_jobs_size_max = 268435456;  -- 256MB待处理作业
```

### 10.3 网络连接优化


**TCP参数调优**：
```bash
# /etc/sysctl.conf 网络优化
# TCP窗口缩放
net.ipv4.tcp_window_scaling = 1

# TCP时间戳
net.ipv4.tcp_timestamps = 1

# TCP选择性确认
net.ipv4.tcp_sack = 1

# TCP拥塞控制
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr

# 应用设置
sysctl -p
```

**连接复用优化**：
```bash
# SSH连接复用配置优化
# ~/.ssh/config
Host *
    ControlMaster auto
    ControlPath ~/.ssh/tmp/%r@%h:%p
    ControlPersist 10m
    Compression yes
    CompressionLevel 6
    ServerAliveInterval 60
    TCPKeepAlive yes
```

---

## 11. 📋 核心要点总结


### 11.1 关键优化要点


```
🔸 切换性能：将故障切换时间从60秒优化到15秒以内
🔸 网络延迟：通过参数调优和连接复用减少网络开销
🔸 存储IO：使用SSD存储和合理的MySQL参数配置
🔸 脚本执行：优化IP切换和监控脚本，减少执行时间
🔸 监控频率：动态调整监控频率，平衡性能和及时性
🔸 资源使用：合理分配CPU、内存资源，避免资源争抢
🔸 并发处理：使用连接池和并行操作提高效率
🔸 网络带宽：优化网络传输和数据同步机制
```

### 11.2 优化效果对比


| 优化项目 | **优化前** | **优化后** | **提升幅度** |
|---------|-----------|-----------|-------------|
| 🕒 **切换时间** | `60秒` | `15秒` | `75%减少` |
| 💾 **内存使用** | `2GB` | `800MB` | `60%节省` |
| ⚡ **CPU占用** | `70%` | `30%` | `57%降低` |
| 🌐 **网络延迟** | `100ms` | `20ms` | `80%改善` |
| 📊 **监控响应** | `10秒` | `3秒` | `70%提升` |

### 11.3 最佳实践建议


**🎯 优化优先级**：
```
高优先级（立即实施）：
✅ 故障检测参数调优
✅ IP切换脚本优化  
✅ MySQL参数基础调优
✅ 网络连接复用配置

中优先级（逐步实施）：
🔄 存储系统升级
🔄 并行复制配置
🔄 监控脚本重写
🔄 系统参数调优

低优先级（长期规划）：
📈 硬件设备升级
📈 网络架构优化
📈 自动化运维工具
📈 多数据中心部署
```

**🔧 实施建议**：
```
1. 测试环境验证：所有优化先在测试环境验证
2. 分步骤实施：避免一次性大量修改
3. 监控效果：实时监控优化效果和稳定性
4. 回滚准备：准备快速回滚方案
5. 文档记录：详细记录所有变更和效果
```

**核心记忆**：
- MHA性能优化重在减少切换时间和资源消耗
- 网络延迟是影响切换性能的关键因素
- 合理的参数配置比硬件升级更重要
- 监控和脚本优化能带来显著效果提升
- 优化需要在性能和稳定性之间找平衡