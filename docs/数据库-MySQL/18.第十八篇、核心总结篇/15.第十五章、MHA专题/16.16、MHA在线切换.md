---
title: 16、MHA在线切换
---
## 📚 目录

1. [MHA在线切换概述](#1-MHA在线切换概述)
2. [masterha_master_switch命令详解](#2-masterha_master_switch命令详解)
3. [在线切换应用场景](#3-在线切换应用场景)
4. [切换前准备与检查](#4-切换前准备与检查)
5. [在线切换执行流程](#5-在线切换执行流程)
6. [切换后验证与回滚](#6-切换后验证与回滚)
7. [最佳实践与注意事项](#7-最佳实践与注意事项)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔄 MHA在线切换概述


### 1.1 什么是MHA在线切换


**简单理解**：MHA在线切换就是在当前主库正常运行时，有计划地把主库角色转移给从库的操作。

```
切换前：应用 → 主库A → 从库B
切换后：应用 → 主库B → 从库A

特点：整个过程主库是健康的，不是因为故障被迫切换
```

**核心特征**：
- 🟢 **计划内操作**：主动发起的切换，不是被动故障切换
- 🟢 **主库健康**：当前主库状态正常，可以正常处理业务
- 🟢 **业务连续**：切换过程中尽量减少业务中断时间
- 🟢 **可控回滚**：出现问题可以快速回滚到原状态

### 1.2 在线切换 vs 故障切换


| 对比项目 | **在线切换** | **故障切换** |
|---------|-------------|-------------|
| **触发原因** | `计划内维护、升级等` | `主库故障、宕机等` |
| **主库状态** | `健康运行` | `故障不可用` |
| **切换时机** | `可控，选择业务低峰期` | `被动，故障发生时` |
| **数据风险** | `极低，数据完整` | `可能有数据丢失` |
| **准备时间** | `充分准备和检查` | `紧急处理` |
| **回滚能力** | `容易回滚` | `困难回滚` |

### 1.3 在线切换的价值


**为什么需要在线切换**：
```
💡 实际工作场景：
- 数据库服务器需要升级硬件
- MySQL版本需要升级
- 操作系统需要打补丁
- 数据库配置需要调整
- 定期的容灾演练

传统做法：停机维护 → 业务中断数小时
MHA在线切换：无缝切换 → 业务中断几秒钟
```

---

## 2. 🛠️ masterha_master_switch命令详解


### 2.1 命令基本语法


**命令格式**：
```bash
masterha_master_switch --conf=/etc/mha/app1.cnf [选项]
```

**必需参数**：
- `--conf`：MHA配置文件路径

### 2.2 核心参数详解


| 参数 | **含义** | **用法示例** |
|------|---------|-------------|
| `--master_state` | `指定当前主库状态` | `--master_state=alive`（在线切换必须） |
| `--new_master_host` | `指定新的主库服务器` | `--new_master_host=192.168.1.102` |
| `--new_master_port` | `指定新主库端口` | `--new_master_port=3306` |
| `--orig_master_is_new_slave` | `原主库变成新从库` | `--orig_master_is_new_slave` |
| `--running_updates_limit` | `允许的更新语句数量限制` | `--running_updates_limit=1` |
| `--interactive` | `交互模式确认` | `--interactive=1` |

### 2.3 关键参数说明


**🔸 --master_state=alive**
```bash
# 这个参数告诉MHA：当前主库是健康的，这是在线切换
--master_state=alive
```
- **必需参数**：在线切换时必须指定
- **作用**：区分在线切换和故障切换
- **如果不指定**：MHA会认为是故障切换

**🔸 --interactive=1**
```bash
# 启用交互模式，每个关键步骤都会询问确认
--interactive=1

# 执行时会看到这样的提示：
Do you want to proceed? (yes/NO): yes
```

**🔸 --running_updates_limit**
```bash
# 限制切换时正在执行的更新语句数量
--running_updates_limit=1

# 含义：如果当前有超过1个UPDATE/INSERT/DELETE在执行，就等待
```

### 2.4 完整命令示例


```bash
# 基本在线切换命令
masterha_master_switch \
  --conf=/etc/mha/app1.cnf \
  --master_state=alive \
  --new_master_host=192.168.1.102 \
  --new_master_port=3306 \
  --orig_master_is_new_slave \
  --running_updates_limit=1 \
  --interactive=1
```

**命令解读**：
1. 使用app1.cnf配置文件
2. 当前主库状态健康（alive）
3. 新主库是192.168.1.102:3306
4. 原主库切换后变成从库
5. 最多允许1个更新语句在执行
6. 启用交互确认模式

---

## 3. 📋 在线切换应用场景


### 3.1 硬件维护场景


**场景描述**：数据库服务器需要硬件升级
```
实际案例：
现状：主库运行在老服务器上，内存8GB，性能不足
需求：升级到新服务器，内存32GB
方案：通过MHA在线切换到从库，升级主库硬件后再切回
```

**操作流程**：
```
步骤 1️⃣：准备新硬件，搭建从库
步骤 2️⃣：执行在线切换，从库升级为主库
步骤 3️⃣：升级原主库硬件
步骤 4️⃣：原主库重新加入集群作为从库
```

### 3.2 版本升级场景


**场景描述**：MySQL版本升级
```
实际案例：
现状：MySQL 5.7运行稳定
需求：升级到MySQL 8.0，享受新特性
挑战：直接升级风险大，需要验证兼容性
```

**安全升级策略**：
```
┌─────────────────┐    在线切换    ┌─────────────────┐
│   主库 5.7      │ ───────────→ │   从库 5.7      │
│   (业务运行)     │              │   (升级为主库)   │
└─────────────────┘              └─────────────────┘
        ↓                               ↓
   离线升级8.0                    业务正常运行5.7
        ↓                               ↓
   验证兼容性                      等待验证完成
        ↓                               ↓
   重新上线作从库                  可选择再次切换
```

### 3.3 计划性维护场景


**定期维护任务**：
- 🔧 **操作系统补丁**：安全更新、内核升级
- 🔧 **数据库配置调整**：参数优化、索引维护
- 🔧 **网络设备维护**：交换机重启、网络调整
- 🔧 **机房迁移**：数据中心搬迁

**维护窗口规划**：
```
业务影响分析：
高峰期：09:00-18:00  → 不适合维护
低峰期：02:00-06:00  → 理想维护时间
切换用时：通常1-3分钟  → 业务影响最小
```

### 3.4 容灾演练场景


**演练目的**：验证高可用方案的有效性
```
演练内容：
✅ 切换流程是否顺畅
✅ 切换时间是否符合预期
✅ 应用连接是否正常切换
✅ 数据是否保持一致
✅ 回滚流程是否可行
```

**演练频率建议**：
- 🗓️ **月度演练**：每月执行一次基本切换
- 🗓️ **季度演练**：每季度执行一次完整流程
- 🗓️ **年度演练**：每年执行一次全面测试

---

## 4. ✅ 切换前准备与检查


### 4.1 环境状态检查


**🔸 主从复制状态检查**
```sql
-- 在主库执行
SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |     1234 |              |                  |
+------------------+----------+--------------+------------------+

-- 在从库执行
SHOW SLAVE STATUS\G
*************************** 1. row ***************************
             Slave_IO_State: Waiting for master to send event
             Master_Log_File: mysql-bin.000001
         Read_Master_Log_Pos: 1234
              Relay_Log_File: relay-bin.000002
                Relay_Log_Pos: 1456
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes  ← 必须是Yes
            Slave_SQL_Running: Yes  ← 必须是Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
                   Last_Errno: 0    ← 必须是0
                   Last_Error:      ← 必须为空
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 1234 ← 与主库Position一致
```

**关键检查点**：
- ✅ `Slave_IO_Running: Yes`
- ✅ `Slave_SQL_Running: Yes`
- ✅ `Last_Errno: 0`
- ✅ `Seconds_Behind_Master < 5`

**🔸 MHA状态检查**
```bash
# 检查MHA Manager状态
masterha_check_status --conf=/etc/mha/app1.cnf

# 期望输出
app1 (pid:12345) is running(0:PING_OK), master:192.168.1.101

# 检查MHA配置
masterha_check_repl --conf=/etc/mha/app1.cnf

# 检查SSH连通性
masterha_check_ssh --conf=/etc/mha/app1.cnf
```

### 4.2 业务影响评估


**🔸 当前连接数检查**
```sql
-- 检查当前连接数
SHOW STATUS LIKE 'Threads_connected';
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| Threads_connected | 156   |
+-------------------+-------+

-- 检查正在执行的语句
SHOW PROCESSLIST;
-- 重点关注State不是Sleep的连接
```

**🔸 业务高峰期避免**
```
业务监控指标：
📊 QPS (每秒查询数)
📊 TPS (每秒事务数)  
📊 连接数
📊 慢查询数量

切换时机选择：
🟢 凌晨2-6点：业务量最低
🟡 上午10-11点：相对较低
🔴 下午2-5点：业务高峰，避免切换
```

### 4.3 备份与回滚准备


**🔸 数据备份**
```bash
# 切换前执行完整备份
mysqldump --single-transaction \
          --routines \
          --triggers \
          --all-databases \
          --master-data=2 > backup_before_switch.sql

# 记录当前binlog位置
mysql -e "SHOW MASTER STATUS" > binlog_position_before.txt
```

**🔸 回滚方案准备**
```
回滚准备清单：
✅ 完整数据备份文件
✅ 当前binlog位置记录
✅ 回滚脚本准备
✅ 回滚操作文档
✅ 紧急联系人电话
```

---

## 5. 🔄 在线切换执行流程


### 5.1 切换流程概览


```
切换执行流程：
                                               
应用层面：[应用] ──连接──► [主库A]
                         ↓
第1步：预检查         [从库B] (同步中)
                         ↓
第2步：停止写入       [主库A] (只读)
                         ↓
第3步：等待同步       [从库B] (追平)
                         ↓  
第4步：角色切换       [从库B] → [新主库B]
                         ↓
第5步：应用切换       [应用] ──连接──► [新主库B]
                         ↓
第6步：旧主变从       [原主库A] → [新从库A]
```

### 5.2 详细执行步骤


**步骤 1️⃣：执行切换命令**
```bash
# 启动在线切换
masterha_master_switch \
  --conf=/etc/mha/app1.cnf \
  --master_state=alive \
  --new_master_host=192.168.1.102 \
  --orig_master_is_new_slave \
  --running_updates_limit=1 \
  --interactive=1

# 系统提示确认
Current Alive Master: 192.168.1.101(192.168.1.101:3306)
New Master: 192.168.1.102(192.168.1.102:3306)
Do you want to proceed? (yes/NO): yes
```

**步骤 2️⃣：检查阶段**
```
MHA执行的检查项目：
✅ 检查所有服务器SSH连通性
✅ 检查主从复制状态  
✅ 检查binlog格式和位置
✅ 检查新主库是否适合提升
✅ 检查当前运行的更新语句数量
```

**步骤 3️⃣：准备阶段**
```bash
# MHA输出日志示例
Tue Jan 11 14:30:15 2024 - [info] Checking replication health on 192.168.1.102..
Tue Jan 11 14:30:15 2024 - [info] Ok.
Tue Jan 11 14:30:15 2024 - [info] Checking replication health on 192.168.1.103..
Tue Jan 11 14:30:15 2024 - [info] Ok.
Tue Jan 11 14:30:16 2024 - [info] All replicas are healthy.
```

**步骤 4️⃣：执行切换**
```bash
# 停止写入到当前主库
Tue Jan 11 14:30:20 2024 - [info] Executing FLUSH TABLES WITH READ LOCK on the orig master..
Tue Jan 11 14:30:20 2024 - [info] Ok.

# 等待从库追平
Tue Jan 11 14:30:21 2024 - [info] Waiting for all slaves to catch up..
Tue Jan 11 14:30:22 2024 - [info] All slaves caught up.

# 提升新主库
Tue Jan 11 14:30:23 2024 - [info] Promoting 192.168.1.102 to master..
Tue Jan 11 14:30:24 2024 - [info] Ok.
```

**步骤 5️⃣：验证结果**
```sql
-- 在新主库验证
SHOW MASTER STATUS;
-- 确认新主库正常工作

-- 在原主库验证  
SHOW SLAVE STATUS\G
-- 确认已变成从库并正常同步
```

### 5.3 切换过程时间分析


```
切换时间分解：
                                      
预检查阶段：      ████░░░░░░  10-30秒
停止写入阶段：    █░░░░░░░░░   1-2秒
等待同步阶段：    ███░░░░░░░   5-15秒
角色切换阶段：    ██░░░░░░░░   3-8秒
应用重连阶段：    █████░░░░░  10-30秒
─────────────────────────────────────
总计时间：                    30-85秒

实际业务中断：    ██░░░░░░░░   5-15秒
```

**业务中断时间**：主要是应用重新连接数据库的时间

---

## 6. ✅ 切换后验证与回滚


### 6.1 切换结果验证


**🔸 数据库状态验证**
```sql
-- 新主库验证
SHOW MASTER STATUS;
SHOW VARIABLES LIKE 'read_only';  -- 应该是OFF
SHOW PROCESSLIST;  -- 检查连接情况

-- 新从库(原主库)验证  
SHOW SLAVE STATUS\G
-- 重点检查：
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes
-- Last_Errno: 0
```

**🔸 应用连接验证**
```bash
# 检查应用连接池状态
# 应用日志中查看连接切换情况
# 监控平台查看数据库连接数

# 业务功能验证
curl -X POST http://api.example.com/test
# 验证读写操作都正常
```

**🔸 数据一致性验证**
```sql
-- 对比关键业务表的数据
SELECT COUNT(*) FROM orders WHERE DATE(created_at) = CURDATE();
SELECT MAX(id) FROM users;
SELECT SUM(amount) FROM transactions WHERE DATE(created_at) = CURDATE();

-- 在新主库和新从库分别执行，确保结果一致
```

### 6.2 性能监控验证


**关键性能指标**：
```
📊 QPS (每秒查询数)：        应与切换前相当
📊 响应时间：               应无明显增加  
📊 连接数：                应恢复正常水平
📊 复制延迟：               应保持在低水平
📊 错误率：                应为0或极低
```

**监控命令**：
```sql
-- 查看当前性能状态
SHOW STATUS LIKE 'Questions';
SHOW STATUS LIKE 'Connections';  
SHOW STATUS LIKE 'Threads_connected';

-- 查看慢查询
SHOW STATUS LIKE 'Slow_queries';
```

### 6.3 回滚操作


**🔸 什么时候需要回滚**
```
回滚触发条件：
❌ 新主库出现异常错误
❌ 应用连接失败率过高
❌ 业务功能验证失败
❌ 性能严重下降
❌ 数据不一致
```

**🔸 紧急回滚流程**
```bash
# 如果发现问题，立即执行反向切换
masterha_master_switch \
  --conf=/etc/mha/app1.cnf \
  --master_state=alive \
  --new_master_host=192.168.1.101 \  # 切回原主库
  --orig_master_is_new_slave \
  --running_updates_limit=1 \
  --interactive=0  # 紧急情况下可以不交互
```

**🔸 回滚验证清单**
```
回滚后检查项目：
✅ 原主库恢复master角色
✅ 原从库恢复slave角色并同步正常
✅ 应用连接恢复正常
✅ 业务功能验证通过
✅ 性能指标恢复正常
✅ 没有数据丢失
```

---

## 7. 💡 最佳实践与注意事项


### 7.1 切换最佳实践


**🔸 切换时机选择**
```
最佳时间窗口：
🟢 凌晨 2:00-6:00    业务量最低，用户最少
🟡 周末早晨         相对安全的时间
🔴 工作日白天       避免，业务繁忙

提前通知：
📧 提前24小时通知业务方
📧 提前2小时再次确认  
📧 切换前30分钟最后通知
```

**🔸 团队协作**
```
人员分工：
👨‍💻 DBA：          执行切换操作
👨‍💻 应用开发：      监控应用状态
👨‍💻 运维：          监控服务器状态
👨‍💻 业务方：        验证业务功能
👨‍💻 项目经理：      整体协调沟通
```

**🔸 沟通机制**
```
沟通渠道：
📱 微信群：    实时状态同步
📞 电话：      紧急情况联系
📧 邮件：      正式通知记录
🖥️ 监控大屏：  状态可视化
```

### 7.2 常见问题与解决


**🔸 问题1：复制延迟过大**
```sql
-- 现象：从库延迟超过预期
SHOW SLAVE STATUS\G
Seconds_Behind_Master: 300  -- 延迟5分钟

-- 解决方案：
1. 等待复制追平再切换
2. 检查网络连接状况  
3. 检查从库性能状况
4. 必要时调整复制参数
```

**🔸 问题2：应用连接超时**
```bash
# 现象：应用连接数据库失败
ERROR 2003 (HY000): Can't connect to MySQL server

# 解决方案：
1. 检查新主库是否正常启动
2. 检查防火墙配置
3. 检查应用连接池配置
4. 必要时重启应用服务
```

**🔸 问题3：权限问题**
```sql
-- 现象：应用报权限错误
ERROR 1045 (28000): Access denied for user 'app'@'host'

-- 解决方案：
-- 在新主库添加应用用户权限
CREATE USER 'app'@'%' IDENTIFIED BY 'password';
GRANT SELECT,INSERT,UPDATE,DELETE ON dbname.* TO 'app'@'%';
FLUSH PRIVILEGES;
```

### 7.3 安全注意事项


**🔸 数据安全**
```
安全措施：
✅ 切换前完整备份
✅ 验证备份可用性
✅ binlog完整保留
✅ 回滚方案准备
✅ 操作全程记录
```

**🔸 操作安全**
```bash
# 使用screen防止会话中断
screen -S mha_switch

# 在screen中执行切换命令
masterha_master_switch --conf=/etc/mha/app1.cnf ...

# 可以随时重新连接会话
screen -r mha_switch
```

**🔸 监控告警**
```
关键监控项：
📊 数据库连接数
📊 复制延迟时间
📊 错误日志告警
📊 应用响应时间
📊 业务成功率

告警阈值：
🔴 复制延迟 > 60秒
🔴 连接失败率 > 5%  
🔴 错误日志有ERROR
🔴 响应时间 > 平常2倍
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 在线切换定义：主库健康状态下的计划性角色切换
🔸 核心命令：masterha_master_switch --master_state=alive
🔸 适用场景：硬件维护、版本升级、计划性运维
🔸 业务影响：通常5-15秒的短暂中断
🔸 安全保障：完整备份、回滚方案、团队协作
```

### 8.2 关键理解要点


**🔹 在线切换的本质**
```
不是故障处理：是主动的运维操作
不是紧急措施：是计划内的正常维护
不是高风险：是相对安全的操作
核心目标：最小化业务影响的前提下完成维护
```

**🔹 成功的关键因素**
```
充分准备：详细的检查和备份
合适时机：选择业务低峰期执行
团队协作：明确分工和沟通机制
快速响应：出现问题立即回滚
```

**🔹 风险控制要点**
```
预防为主：切换前充分检查和准备
过程监控：切换过程实时监控状态
快速恢复：准备完善的回滚方案
经验总结：每次切换后总结改进
```

### 8.3 实际应用价值


**业务连续性保障**：
- 🎯 **计划维护**：硬件升级、系统维护可以无缝进行
- 🎯 **版本升级**：数据库版本升级风险可控
- 🎯 **容灾演练**：定期验证高可用方案有效性
- 🎯 **负载均衡**：根据业务需要调整主库位置

**运维效率提升**：
- ⚡ **维护窗口灵活**：不再严格依赖业务停机窗口
- ⚡ **故障准备充分**：通过演练提升故障处理能力
- ⚡ **风险可控**：相比直接维护主库风险大幅降低

**核心记忆口诀**：
```
在线切换很重要，计划维护少不了
master_state要设alive，健康主库才切换
切换之前先检查，备份回滚都准备
选择时机很关键，低峰期里风险小
团队协作要到位，出现问题快回滚
```