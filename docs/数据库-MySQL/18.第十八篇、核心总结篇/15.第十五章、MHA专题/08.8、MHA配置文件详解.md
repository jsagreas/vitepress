---
title: 8ã€MHAé…ç½®æ–‡ä»¶è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [MHAé…ç½®æ–‡ä»¶æ¦‚è¿°](#1-MHAé…ç½®æ–‡ä»¶æ¦‚è¿°)
2. [app1.cnfé…ç½®æ–‡ä»¶ç»“æ„](#2-app1cnfé…ç½®æ–‡ä»¶ç»“æ„)
3. [server defaultæ®µé…ç½®](#3-server-defaultæ®µé…ç½®)
4. [serverNæ®µé…ç½®è¯¦è§£](#4-serverNæ®µé…ç½®è¯¦è§£)
5. [æ ¸å¿ƒå‚æ•°æ·±åº¦è§£æ](#5-æ ¸å¿ƒå‚æ•°æ·±åº¦è§£æ)
6. [é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ](#6-é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ MHAé…ç½®æ–‡ä»¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHAé…ç½®æ–‡ä»¶


**ğŸ”¸ é€šä¿—ç†è§£**
```
MHAé…ç½®æ–‡ä»¶å°±åƒæ˜¯"é«˜å¯ç”¨é›†ç¾¤çš„è¯´æ˜ä¹¦"
å‘Šè¯‰MHAç®¡ç†å™¨ï¼š
- æœ‰å“ªäº›MySQLæœåŠ¡å™¨
- æ¯å°æœåŠ¡å™¨çš„è§’è‰²å’Œä½ç½®
- å‡ºç°æ•…éšœæ—¶è¯¥æ€ä¹ˆå¤„ç†
- å„ç§è¶…æ—¶å’Œæ£€æŸ¥å‚æ•°
```

**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
```
é…ç½®æ–‡ä»¶çš„ä½œç”¨ï¼š
1. å®šä¹‰é›†ç¾¤æ‹“æ‰‘ï¼šå“ªäº›æœåŠ¡å™¨ç»„æˆä¸€ä¸ªé«˜å¯ç”¨ç¾¤ç»„
2. è®¾ç½®è¿æ¥ä¿¡æ¯ï¼šIPåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åå¯†ç 
3. æŒ‡å®šå·¥ä½œç›®å½•ï¼šæ—¥å¿—å­˜æ”¾ã€ä¸´æ—¶æ–‡ä»¶ä½ç½®
4. é…ç½®æ£€æŸ¥ç­–ç•¥ï¼šå¤šä¹…æ£€æŸ¥ä¸€æ¬¡ã€æ€ä¹ˆåˆ¤æ–­æ•…éšœ
5. å®šåˆ¶æ•…éšœå¤„ç†ï¼šå‘ç”Ÿæ•…éšœæ—¶æ‰§è¡Œä»€ä¹ˆè„šæœ¬
```

### 1.2 é…ç½®æ–‡ä»¶çš„é‡è¦æ€§


**âš ï¸ ä¸ºä»€ä¹ˆé…ç½®æ–‡ä»¶å¦‚æ­¤é‡è¦**
```
é…ç½®æ–‡ä»¶å†³å®šäº†ï¼š
âœ… MHAèƒ½å¦æ­£å¸¸å·¥ä½œ
âœ… æ•…éšœåˆ‡æ¢æ˜¯å¦åŠæ—¶
âœ… æ•°æ®æ˜¯å¦èƒ½å®Œæ•´ä¿æŠ¤
âœ… åˆ‡æ¢è¿‡ç¨‹æ˜¯å¦å¹³æ»‘

é…ç½®é”™è¯¯å¯èƒ½å¯¼è‡´ï¼š
âŒ æ— æ³•æ£€æµ‹åˆ°æ•…éšœ
âŒ åˆ‡æ¢æ—¶é—´è¿‡é•¿
âŒ æ•°æ®ä¸¢å¤±
âŒ æœåŠ¡ä¸­æ–­
```

---

## 2. ğŸ“‹ app1.cnfé…ç½®æ–‡ä»¶ç»“æ„


### 2.1 é…ç½®æ–‡ä»¶æ•´ä½“æ¶æ„


**ğŸ—ï¸ æ–‡ä»¶ç»“æ„å›¾**
```
app1.cnf
â”œâ”€â”€ [server default]     â† å…¨å±€é»˜è®¤é…ç½®æ®µ
â”‚   â”œâ”€â”€ ç®¡ç†å™¨è®¾ç½®
â”‚   â”œâ”€â”€ å·¥ä½œç›®å½•é…ç½®
â”‚   â”œâ”€â”€ æ£€æŸ¥ç­–ç•¥è®¾ç½®
â”‚   â””â”€â”€ è„šæœ¬è·¯å¾„é…ç½®
â”œâ”€â”€ [server1]           â† ç¬¬ä¸€å°MySQLæœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ è¿æ¥ä¿¡æ¯
â”‚   â”œâ”€â”€ è§’è‰²å®šä¹‰
â”‚   â””â”€â”€ ç‰¹æ®Šè®¾ç½®
â”œâ”€â”€ [server2]           â† ç¬¬äºŒå°MySQLæœåŠ¡å™¨é…ç½®
â”‚   â””â”€â”€ ...
â””â”€â”€ [serverN]           â† ç¬¬Nå°MySQLæœåŠ¡å™¨é…ç½®
    â””â”€â”€ ...
```

### 2.2 å®Œæ•´é…ç½®æ–‡ä»¶ç¤ºä¾‹


```ini
[server default]
# ç®¡ç†å™¨é…ç½®
manager_log=/var/log/masterha/app1/manager.log
manager_workdir=/var/log/masterha/app1
user=mha
password=mha123

# å¤åˆ¶ç”¨æˆ·é…ç½®
repl_user=repl
repl_password=repl123

# æ£€æŸ¥é…ç½®
ping_interval=3
secondary_check_script=masterha_secondary_check -s 192.168.1.10 -s 192.168.1.11

# æ•…éšœå¤„ç†è„šæœ¬
shutdown_script=""
master_ip_failover_script=""
master_ip_online_change_script=""

[server1]
hostname=192.168.1.10
port=3306
master_binlog_dir=/var/lib/mysql
candidate_master=1

[server2]
hostname=192.168.1.11  
port=3306
master_binlog_dir=/var/lib/mysql
candidate_master=1

[server3]
hostname=192.168.1.12
port=3306
master_binlog_dir=/var/lib/mysql
no_master=1
```

### 2.3 é…ç½®æ®µçš„ä½œç”¨æœºåˆ¶


**ğŸ“Š é…ç½®ç»§æ‰¿å…³ç³»**
```
é…ç½®ä¼˜å…ˆçº§ï¼š
[serverN] æ®µé…ç½® > [server default] æ®µé…ç½®

ç»§æ‰¿æœºåˆ¶ï¼š
1. å…ˆè¯»å– [server default] çš„é…ç½®ä½œä¸ºé»˜è®¤å€¼
2. å†è¯»å– [serverN] çš„é…ç½®è¦†ç›–é»˜è®¤å€¼
3. æœ€ç»ˆå½¢æˆæ¯å°æœåŠ¡å™¨çš„å®Œæ•´é…ç½®

å®é™…ä¾‹å­ï¼š
[server default]
ping_interval=3        â† é»˜è®¤3ç§’æ£€æŸ¥ä¸€æ¬¡

[server1]  
(æ— ping_intervalé…ç½®)  â† ç»§æ‰¿é»˜è®¤å€¼3ç§’

[server2]
ping_interval=5        â† è¦†ç›–ä¸º5ç§’æ£€æŸ¥ä¸€æ¬¡
```

---

## 3. âš™ï¸ server defaultæ®µé…ç½®


### 3.1 ç®¡ç†å™¨åŸºç¡€é…ç½®


#### ğŸ”¸ manager_logå‚æ•°


**å‚æ•°å«ä¹‰**
```
manager_logï¼šMHAç®¡ç†å™¨çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„
ä½œç”¨ï¼šè®°å½•MHAç®¡ç†å™¨çš„è¿è¡Œæ—¥å¿—
åŒ…å«å†…å®¹ï¼šæ•…éšœæ£€æµ‹ã€åˆ‡æ¢è¿‡ç¨‹ã€é”™è¯¯ä¿¡æ¯ç­‰
```

**é…ç½®ç¤ºä¾‹**
```ini
[server default]
manager_log=/var/log/masterha/app1/manager.log

ç›®å½•ç»“æ„ï¼š
/var/log/masterha/
â””â”€â”€ app1/
    â”œâ”€â”€ manager.log      â† ç®¡ç†å™¨ä¸»æ—¥å¿—
    â”œâ”€â”€ manager.log.1    â† è½®è½¬çš„å†å²æ—¥å¿—
    â””â”€â”€ manager.log.2
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- ç›®å½•å¿…é¡»æå‰åˆ›å»º
- MHAç”¨æˆ·éœ€è¦æœ‰å†™æƒé™
- å»ºè®®å•ç‹¬ä¸ºæ¯ä¸ªMHAåº”ç”¨å»ºç«‹ç›®å½•

#### ğŸ”¸ manager_workdirå‚æ•°


**å‚æ•°å«ä¹‰**
```
manager_workdirï¼šMHAç®¡ç†å™¨çš„å·¥ä½œç›®å½•
ä½œç”¨ï¼šå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ã€çŠ¶æ€æ–‡ä»¶ã€é”æ–‡ä»¶ç­‰
æ–‡ä»¶ç±»å‹ï¼š
- app1.master_status.health  â† ä¸»åº“å¥åº·çŠ¶æ€
- app1.failover.complete     â† æ•…éšœè½¬ç§»å®Œæˆæ ‡è®°
- saved_master_binlog_*      â† ä¿å­˜çš„binlogæ–‡ä»¶
```

**é…ç½®ç¤ºä¾‹**
```ini
[server default]
manager_workdir=/var/log/masterha/app1

å·¥ä½œç›®å½•å†…å®¹ï¼š
/var/log/masterha/app1/
â”œâ”€â”€ app1.master_status.health
â”œâ”€â”€ app1.failover.complete
â”œâ”€â”€ saved_master_binlog_from_192.168.1.10_3306_20241120_143022.binlog
â””â”€â”€ manager.log
```

### 3.2 è¿æ¥è®¤è¯é…ç½®


**ç”¨æˆ·é…ç½®å‚æ•°**
```ini
[server default]
# MHAç®¡ç†ç”¨æˆ·ï¼šç”¨äºè¿æ¥MySQLæ‰§è¡Œç®¡ç†æ“ä½œ
user=mha
password=mha123

# å¤åˆ¶ç”¨æˆ·ï¼šç”¨äºä¸»ä»å¤åˆ¶
repl_user=repl  
repl_password=repl123

# SSHç”¨æˆ·ï¼šç”¨äºæœåŠ¡å™¨é—´SSHè¿æ¥ï¼ˆé€šå¸¸ä¸åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼‰
ssh_user=root
```

**ğŸ” ç”¨æˆ·æƒé™è¦æ±‚**
```
MHAç®¡ç†ç”¨æˆ·æƒé™ï¼š
GRANT ALL PRIVILEGES ON *.* TO 'mha'@'%';
æˆ–è€…æœ€å°æƒé™ï¼š
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, 
      RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, 
      INDEX, ALTER, SHOW DATABASES, SUPER, 
      CREATE TEMPORARY TABLES, LOCK TABLES, 
      EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT 
      ON *.* TO 'mha'@'%';

å¤åˆ¶ç”¨æˆ·æƒé™ï¼š
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
```

---

## 4. ğŸ–¥ï¸ serverNæ®µé…ç½®è¯¦è§£


### 4.1 åŸºæœ¬æœåŠ¡å™¨ä¿¡æ¯


**å¿…éœ€é…ç½®å‚æ•°**
```ini
[server1]
hostname=192.168.1.10    # æœåŠ¡å™¨IPåœ°å€æˆ–ä¸»æœºå
port=3306               # MySQLç«¯å£å·
```

**ğŸ”¸ hostnameå‚æ•°è¯¦è§£**
```
hostnameä½œç”¨ï¼š
- æŒ‡å®šMySQLæœåŠ¡å™¨çš„ç½‘ç»œåœ°å€
- MHAé€šè¿‡æ­¤åœ°å€è¿æ¥MySQL
- å»ºè®®ä½¿ç”¨IPåœ°å€è€Œéä¸»æœºå

é…ç½®é€‰æ‹©ï¼š
âœ… æ¨èï¼šhostname=192.168.1.10
âŒ ä¸æ¨èï¼šhostname=mysql-server1  # ä¾èµ–DNSè§£æ

åŸå› ï¼š
- IPåœ°å€æ›´å¯é ï¼Œä¸ä¾èµ–DNS
- æ•…éšœæ—¶DNSå¯èƒ½ä¹Ÿæœ‰é—®é¢˜
- å‡å°‘ç½‘ç»œè§£æå»¶è¿Ÿ
```

### 4.2 å­˜å‚¨è·¯å¾„é…ç½®


#### ğŸ”¸ master_binlog_dirå‚æ•°


**å‚æ•°å«ä¹‰**
```
master_binlog_dirï¼šMySQL binlogæ–‡ä»¶å­˜æ”¾ç›®å½•
ä½œç”¨ï¼šMHAéœ€è¦çŸ¥é“binlogä½ç½®æ¥ï¼š
1. åˆ†ææœ€æ–°çš„binlogä½ç½®
2. æ•…éšœæ—¶ä¿å­˜å’Œåº”ç”¨å·®å¼‚æ—¥å¿—
3. ç¡®ä¿æ•°æ®å®Œæ•´æ€§
```

**é…ç½®ç¤ºä¾‹**
```ini
[server1]
master_binlog_dir=/var/lib/mysql

å®é™…binlogæ–‡ä»¶ï¼š
/var/lib/mysql/
â”œâ”€â”€ mysql-bin.000001
â”œâ”€â”€ mysql-bin.000002  
â”œâ”€â”€ mysql-bin.000003
â”œâ”€â”€ mysql-bin.index
â””â”€â”€ (å…¶ä»–MySQLæ•°æ®æ–‡ä»¶)
```

**âš ï¸ å…³é”®è¦ç‚¹**
- è·¯å¾„å¿…é¡»æ˜¯binlogæ–‡ä»¶çš„å®é™…å­˜æ”¾ç›®å½•
- æ‰€æœ‰MySQLæœåŠ¡å™¨çš„binlogç›®å½•å»ºè®®ä¿æŒä¸€è‡´
- MHAç”¨æˆ·éœ€è¦æœ‰è¯»æƒé™

#### ğŸ”¸ remote_workdirå‚æ•°


**å‚æ•°å«ä¹‰**
```
remote_workdirï¼šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ä¸´æ—¶å·¥ä½œç›®å½•  
ä½œç”¨ï¼šMHAåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå­˜æ”¾ï¼š
- ä¸‹è½½çš„binlogæ–‡ä»¶
- ä¸´æ—¶SQLè„šæœ¬
- åº”ç”¨å·®å¼‚æ—¥å¿—æ—¶çš„ä¸­é—´æ–‡ä»¶
```

**é…ç½®ç¤ºä¾‹**
```ini
[server1]
remote_workdir=/tmp/masterha

å·¥ä½œç›®å½•ç”¨é€”ï¼š
/tmp/masterha/
â”œâ”€â”€ relay_log_from_master     â† ä»åŸä¸»åº“è·å–çš„relay log
â”œâ”€â”€ apply_diff_relay_logs.sql â† åº”ç”¨å·®å¼‚æ—¥å¿—çš„SQLè„šæœ¬
â””â”€â”€ saved_master_binlog       â† ä¿å­˜çš„ä¸»åº“binlog
```

### 4.3 è§’è‰²å®šä¹‰é…ç½®


**ğŸ¯ æœåŠ¡å™¨è§’è‰²å‚æ•°**
```ini
# å€™é€‰ä¸»åº“ï¼šå¯ä»¥æˆä¸ºæ–°çš„ä¸»åº“
[server1]
candidate_master=1

# ä¸èƒ½æˆä¸ºä¸»åº“ï¼šé€šå¸¸ç”¨äºåªè¯»æœåŠ¡å™¨
[server3]  
no_master=1

# æ™®é€šä»åº“ï¼šé»˜è®¤æƒ…å†µï¼Œå¯ä»¥å‚ä¸ä¸»ä»å¤åˆ¶
[server2]
# æ— ç‰¹æ®Šè§’è‰²é…ç½®
```

**è§’è‰²å®šä¹‰è¯¦è§£**
```
candidate_master=1ï¼š
âœ… å¯ä»¥æå‡ä¸ºæ–°ä¸»åº“
âœ… ä¼˜å…ˆçº§é«˜äºæ™®é€šä»åº“
âœ… é€šå¸¸é…ç½®åœ¨æ€§èƒ½å¥½çš„æœåŠ¡å™¨ä¸Š

no_master=1ï¼š
âŒ æ°¸è¿œä¸ä¼šæˆä¸ºä¸»åº“
âœ… ä»ç„¶å¯ä»¥ä½œä¸ºä»åº“
âœ… é€‚ç”¨äºï¼šåªè¯»æŸ¥è¯¢æœåŠ¡å™¨ã€å¤‡ä»½æœåŠ¡å™¨

æ— è§’è‰²é…ç½®ï¼š
âœ… å¯ä»¥æˆä¸ºä¸»åº“ï¼Œä½†ä¼˜å…ˆçº§ä½äºcandidate_master
âœ… æ­£å¸¸å‚ä¸ä¸»ä»å¤åˆ¶
```

---

## 5. ğŸ“Š æ ¸å¿ƒå‚æ•°æ·±åº¦è§£æ


### 5.1 æ£€æŸ¥ç­–ç•¥å‚æ•°


#### ğŸ”¸ ping_intervalå‚æ•°


**å‚æ•°å«ä¹‰**
```
ping_intervalï¼šå¥åº·æ£€æŸ¥é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰
ä½œç”¨ï¼šMHAå¤šä¹…æ£€æŸ¥ä¸€æ¬¡ä¸»åº“æ˜¯å¦å­˜æ´»
é»˜è®¤å€¼ï¼š3ç§’
```

**åˆç†é…ç½®å»ºè®®**
```ini
# ä¸åŒåœºæ™¯çš„æ¨èé…ç½®
[server default]
ping_interval=3    # ç”Ÿäº§ç¯å¢ƒæ¨èï¼šå¿«é€Ÿå‘ç°æ•…éšœ

# ç‰¹æ®Šæƒ…å†µï¼š
ping_interval=1    # é«˜è¦æ±‚ç¯å¢ƒï¼šæ›´å¿«å‘ç°æ•…éšœ
ping_interval=5    # ç½‘ç»œè¾ƒå·®ç¯å¢ƒï¼šå‡å°‘è¯¯æŠ¥
ping_interval=10   # æµ‹è¯•ç¯å¢ƒï¼šé™ä½æ£€æŸ¥é¢‘ç‡
```

**âš¡ æ€§èƒ½å½±å“åˆ†æ**
```
é—´éš”æ—¶é—´å¯¹æ¯”ï¼š

ping_interval=1ç§’ï¼š
âœ… æ•…éšœå‘ç°æœ€å¿«
âŒ ç½‘ç»œå¼€é”€å¤§ï¼Œå¯èƒ½è¯¯æŠ¥

ping_interval=3ç§’ï¼š  
âœ… å¹³è¡¡çš„é€‰æ‹©
âœ… æ—¢å¿«é€Ÿåˆç¨³å®š

ping_interval=10ç§’ï¼š
âœ… ç½‘ç»œå¼€é”€å°
âŒ æ•…éšœå‘ç°è¾ƒæ…¢
```

#### ğŸ”¸ secondary_check_scriptå‚æ•°


**å‚æ•°å«ä¹‰**
```
secondary_check_scriptï¼šäºŒæ¬¡æ£€æŸ¥è„šæœ¬
ä½œç”¨ï¼šé¿å…"è„‘è£‚"ï¼Œé€šè¿‡å¤šä¸ªè·¯å¾„ç¡®è®¤ä¸»åº“çœŸçš„æ•…éšœäº†
æœºåˆ¶ï¼šä»ä¸åŒç½‘ç»œè·¯å¾„pingä¸»åº“
```

**é…ç½®ç¤ºä¾‹**
```ini
[server default]
secondary_check_script=masterha_secondary_check -s 192.168.1.11 -s 192.168.1.12

å‚æ•°è§£é‡Šï¼š
-s 192.168.1.11  # é€šè¿‡server2æ£€æŸ¥ä¸»åº“
-s 192.168.1.12  # é€šè¿‡server3æ£€æŸ¥ä¸»åº“

æ£€æŸ¥æµç¨‹ï¼š
MHA Manager â†’ ç›´æ¥pingä¸»åº“ï¼ˆå¤±è´¥ï¼‰
           â†’ é€šçŸ¥server2 pingä¸»åº“
           â†’ é€šçŸ¥server3 pingä¸»åº“  
           â†’ å¤šä¸ªç¡®è®¤åæ‰åˆ¤å®šä¸»åº“æ•…éšœ
```

**ğŸ›¡ï¸ ä¸ºä»€ä¹ˆéœ€è¦äºŒæ¬¡æ£€æŸ¥**
```
é˜²æ­¢è¯¯åˆ¤åœºæ™¯ï¼š
1. MHA Manageråˆ°ä¸»åº“çš„ç½‘ç»œæ•…éšœ
2. äº¤æ¢æœºç«¯å£æ•…éšœ
3. ç½‘ç»œæ‹¥å¡å¯¼è‡´çš„ä¸´æ—¶è¶…æ—¶

äºŒæ¬¡æ£€æŸ¥çš„å¥½å¤„ï¼š
âœ… å‡å°‘è¯¯åˆ‡æ¢
âœ… æé«˜åˆ¤æ–­å‡†ç¡®æ€§  
âœ… é¿å…ä¸å¿…è¦çš„æœåŠ¡ä¸­æ–­
```

### 5.2 æ•…éšœå¤„ç†è„šæœ¬


#### ğŸ”¸ shutdown_scriptå‚æ•°


**å‚æ•°å«ä¹‰**
```
shutdown_scriptï¼šå…³é—­åŸä¸»åº“è„šæœ¬
ä½œç”¨ï¼šç¡®ä¿æ•…éšœçš„ä¸»åº“å½»åº•åœæ­¢æœåŠ¡
ç›®çš„ï¼šé˜²æ­¢"åŒä¸»"æƒ…å†µ
```

**å…¸å‹è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# shutdown_script.sh

# è·å–å‚æ•°
ORIG_MASTER_HOST=$1
ORIG_MASTER_IP=$2  
ORIG_MASTER_PORT=$3

# å¼ºåˆ¶å…³é—­MySQL
ssh $ORIG_MASTER_IP "killall mysqld"

# å…³é—­VIPï¼ˆå¦‚æœä½¿ç”¨ï¼‰
ssh $ORIG_MASTER_IP "ip addr del 192.168.1.100/24 dev eth0"

# è®°å½•æ—¥å¿—
echo "$(date): Shutdown completed for $ORIG_MASTER_IP" >> /var/log/mha_shutdown.log
```

**é…ç½®æ–¹æ³•**
```ini
[server default]
shutdown_script=/usr/local/bin/shutdown_script.sh
```

#### ğŸ”¸ VIPåˆ‡æ¢è„šæœ¬


**master_ip_failover_scriptå‚æ•°**
```
ä½œç”¨ï¼šæ•…éšœåˆ‡æ¢æ—¶çš„VIPï¼ˆè™šæ‹ŸIPï¼‰å¤„ç†
åŒ…å«æ“ä½œï¼š
1. ä»æ•…éšœä¸»åº“ç§»é™¤VIP
2. åœ¨æ–°ä¸»åº“ä¸Šæ·»åŠ VIP
3. æ›´æ–°ç›¸å…³æœåŠ¡é…ç½®
```

**ç®€åŒ–VIPåˆ‡æ¢è„šæœ¬**
```bash
#!/bin/bash
# master_ip_failover_script.sh

VIP="192.168.1.100/24"
INTERFACE="eth0"

case "$1" in
    --command=stop)
        # ç§»é™¤VIP
        ip addr del $VIP dev $INTERFACE
        ;;
    --command=start)
        # æ·»åŠ VIP
        ip addr add $VIP dev $INTERFACE
        ;;
esac
```

---

## 6. ğŸ’¡ é…ç½®æ–‡ä»¶æœ€ä½³å®è·µ


### 6.1 ç›®å½•è§„åˆ’å»ºè®®


**ğŸ—‚ï¸ æ¨èç›®å½•ç»“æ„**
```
/etc/masterha/
â”œâ”€â”€ app1.cnf           â† åº”ç”¨1é…ç½®æ–‡ä»¶
â”œâ”€â”€ app2.cnf           â† åº”ç”¨2é…ç½®æ–‡ä»¶  
â””â”€â”€ scripts/
    â”œâ”€â”€ shutdown.sh
    â”œâ”€â”€ failover.sh
    â””â”€â”€ switch.sh

/var/log/masterha/
â”œâ”€â”€ app1/
â”‚   â”œâ”€â”€ manager.log
â”‚   â””â”€â”€ å·¥ä½œæ–‡ä»¶
â””â”€â”€ app2/
    â”œâ”€â”€ manager.log
    â””â”€â”€ å·¥ä½œæ–‡ä»¶
```

### 6.2 é…ç½®æ£€æŸ¥æ¸…å•


**âœ… é…ç½®å‰æ£€æŸ¥**
```
ç½‘ç»œè¿é€šæ€§ï¼š
â–¡ MHA Manageråˆ°æ‰€æœ‰MySQLæœåŠ¡å™¨ç½‘ç»œé€šç•…
â–¡ æ‰€æœ‰MySQLæœåŠ¡å™¨é—´ç½‘ç»œé€šç•…  
â–¡ SSHæ— å¯†ç ç™»å½•é…ç½®å®Œæˆ

MySQLé…ç½®ï¼š
â–¡ æ‰€æœ‰æœåŠ¡å™¨å¼€å¯binlog
â–¡ server_idå”¯ä¸€
â–¡ ä¸»ä»å¤åˆ¶æ­£å¸¸è¿è¡Œ

ç”¨æˆ·æƒé™ï¼š
â–¡ MHAç”¨æˆ·æƒé™é…ç½®æ­£ç¡®
â–¡ å¤åˆ¶ç”¨æˆ·æƒé™é…ç½®æ­£ç¡®
â–¡ SSHç”¨æˆ·æƒé™é…ç½®æ­£ç¡®
```

### 6.3 å¸¸è§é…ç½®é”™è¯¯


**âŒ å…¸å‹é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**
```
é”™è¯¯1ï¼šè·¯å¾„ä¸å­˜åœ¨
é—®é¢˜ï¼šmanager_workdir=/var/log/masterha/app1
è§£å†³ï¼šmkdir -p /var/log/masterha/app1

é”™è¯¯2ï¼šæƒé™ä¸è¶³  
é—®é¢˜ï¼šMHAç”¨æˆ·æ— æ³•è®¿é—®binlogç›®å½•
è§£å†³ï¼šchown mysql:mysql /var/lib/mysql

é”™è¯¯3ï¼šç«¯å£é…ç½®é”™è¯¯
é—®é¢˜ï¼šport=3307 ä½†MySQLå®é™…è¿è¡Œåœ¨3306
è§£å†³ï¼šæ£€æŸ¥MySQLå®é™…ç«¯å£é…ç½®

é”™è¯¯4ï¼šIPåœ°å€é”™è¯¯
é—®é¢˜ï¼šhostname=192.168.1.10 ä½†æœåŠ¡å™¨IPæ˜¯192.168.1.20
è§£å†³ï¼šæ ¸å®å¹¶ä¿®æ­£IPåœ°å€
```

### 6.4 é…ç½®éªŒè¯æ–¹æ³•


**ğŸ” éªŒè¯é…ç½®æ­£ç¡®æ€§**
```bash
# 1. æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
masterha_check_ssh --conf=/etc/masterha/app1.cnf

# 2. æ£€æŸ¥å¤åˆ¶é…ç½®
masterha_check_repl --conf=/etc/masterha/app1.cnf

# 3. æ£€æŸ¥æ•´ä½“çŠ¶æ€  
masterha_check_status --conf=/etc/masterha/app1.cnf

# 4. æµ‹è¯•è¿æ¥
masterha_master_monitor --conf=/etc/masterha/app1.cnf --test
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é…ç½®æ–‡ä»¶ç»“æ„ï¼š[server default] + [serverN] ä¸¤æ®µå¼ç»“æ„
ğŸ”¸ å‚æ•°ç»§æ‰¿ï¼šserverNæ®µè¦†ç›–server defaultæ®µçš„é…ç½®
ğŸ”¸ å…³é”®è·¯å¾„ï¼šmanager_logã€manager_workdirã€master_binlog_dir
ğŸ”¸ æ£€æŸ¥ç­–ç•¥ï¼šping_intervalã€secondary_check_scripté¿å…è¯¯åˆ¤
ğŸ”¸ è§’è‰²å®šä¹‰ï¼šcandidate_masterã€no_masteræ§åˆ¶åˆ‡æ¢é€»è¾‘
```

### 7.2 é…ç½®è¦ç‚¹è®°å¿†


**ğŸ”¹ é…ç½®æ–‡ä»¶ä¸‰è¦ç´ **
```
è·¯å¾„é…ç½®ï¼š
- æ—¥å¿—è·¯å¾„ï¼šè®°å½•MHAè¿è¡ŒçŠ¶æ€
- å·¥ä½œç›®å½•ï¼šå­˜æ”¾ä¸´æ—¶å’ŒçŠ¶æ€æ–‡ä»¶  
- binlogç›®å½•ï¼šMySQLæ—¥å¿—æ–‡ä»¶ä½ç½®

è¿æ¥é…ç½®ï¼š
- æœåŠ¡å™¨åœ°å€ï¼šhostnameå’Œport
- è®¤è¯ä¿¡æ¯ï¼šuserã€passwordã€repl_user

æ£€æŸ¥é…ç½®ï¼š
- æ£€æŸ¥é—´éš”ï¼šping_interval
- äºŒæ¬¡ç¡®è®¤ï¼šsecondary_check_script
- è§’è‰²å®šä¹‰ï¼šcandidate_masterã€no_master
```

**ğŸ”¹ å…³é”®å‚æ•°é€Ÿè®°**
```
manager_logï¼šMHAæ—¥å¿—å†™å“ªé‡Œ
manager_workdirï¼šMHAä¸´æ—¶æ–‡ä»¶æ”¾å“ªé‡Œ  
master_binlog_dirï¼šMySQL binlogåœ¨å“ªé‡Œ
remote_workdirï¼šè¿œç¨‹ä¸´æ—¶ç›®å½•åœ¨å“ªé‡Œ
ping_intervalï¼šå¤šä¹…æ£€æŸ¥ä¸€æ¬¡ï¼ˆç§’ï¼‰
secondary_check_scriptï¼šäºŒæ¬¡ç¡®è®¤è„šæœ¬
shutdown_scriptï¼šå…³é—­æ•…éšœä¸»åº“è„šæœ¬
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ é…ç½®æ–‡ä»¶çš„é‡è¦ä½œç”¨**
- **æ•…éšœæ£€æµ‹**ï¼šå†³å®šå¤šå¿«å‘ç°é—®é¢˜
- **åˆ‡æ¢é€»è¾‘**ï¼šå†³å®šè°èƒ½å½“æ–°ä¸»åº“
- **æ•°æ®ä¿æŠ¤**ï¼šå†³å®šå¦‚ä½•ä¿è¯æ•°æ®å®Œæ•´
- **æœåŠ¡è¿ç»­**ï¼šå†³å®šåˆ‡æ¢æ˜¯å¦å¹³æ»‘

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **ç¯å¢ƒåŒºåˆ†**ï¼šç”Ÿäº§ã€æµ‹è¯•ç¯å¢ƒä½¿ç”¨ä¸åŒæ£€æŸ¥é—´éš”
- **è§’è‰²è§„åˆ’**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆç†åˆ†é…è§’è‰²
- **è·¯å¾„ç»Ÿä¸€**ï¼šæ‰€æœ‰æœåŠ¡å™¨ä½¿ç”¨ç›¸åŒçš„ç›®å½•ç»“æ„
- **å®šæœŸæ£€æŸ¥**ï¼šé…ç½®å˜æ›´åå¿…é¡»éªŒè¯

**æ ¸å¿ƒè®°å¿†**ï¼š
- MHAé…ç½®æ–‡ä»¶æ˜¯é«˜å¯ç”¨çš„"å¤§è„‘"ï¼Œå†³å®šäº†æ•´ä¸ªç³»ç»Ÿçš„è¡Œä¸º
- ä¸¤æ®µå¼ç»“æ„ç®€å•æ¸…æ™°ï¼Œç»§æ‰¿æœºåˆ¶é¿å…é‡å¤é…ç½®
- è·¯å¾„ã€è¿æ¥ã€æ£€æŸ¥ä¸‰å¤§ç±»é…ç½®ç¼ºä¸€ä¸å¯
- æ­£ç¡®é…ç½®æ˜¯MHAç¨³å®šè¿è¡Œçš„åŸºç¡€ä¿éšœ