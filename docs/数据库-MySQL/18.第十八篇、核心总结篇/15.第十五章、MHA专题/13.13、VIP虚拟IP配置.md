---
title: 13ã€VIPè™šæ‹ŸIPé…ç½®
---
## ğŸ“š ç›®å½•

1. [VIPè™šæ‹ŸIPæ¦‚è¿°](#1-VIPè™šæ‹ŸIPæ¦‚è¿°)
2. [MHA VIPè„šæœ¬æœºåˆ¶](#2-MHA-VIPè„šæœ¬æœºåˆ¶)
3. [ç½‘ç»œå‘½ä»¤æ“ä½œè¯¦è§£](#3-ç½‘ç»œå‘½ä»¤æ“ä½œè¯¦è§£)
4. [VIPè„šæœ¬å®šåˆ¶å¼€å‘](#4-VIPè„šæœ¬å®šåˆ¶å¼€å‘)
5. [VIPæ¼‚ç§»æµ‹è¯•éªŒè¯](#5-VIPæ¼‚ç§»æµ‹è¯•éªŒè¯)
6. [æ•…éšœå¤„ç†ä¸æ’é”™](#6-æ•…éšœå¤„ç†ä¸æ’é”™)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ VIPè™šæ‹ŸIPæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯VIPè™šæ‹ŸIP


**ç®€å•ç†è§£**ï¼šVIPå°±æ˜¯ä¸€ä¸ª"ä¼šç§»åŠ¨çš„IPåœ°å€"ï¼Œå“ªå°æœåŠ¡å™¨æ˜¯ä¸»åº“ï¼ŒVIPå°±è·Ÿè°èµ°

```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
åº”ç”¨ç¨‹åº â†’ 192.168.1.10 (ä¸»åº“)
                â†“ (ä¸»åº“æ•…éšœ)
åº”ç”¨ç¨‹åº â†’ éœ€è¦ä¿®æ”¹IP â†’ 192.168.1.11 (æ–°ä¸»åº“)

ä½¿ç”¨VIPçš„æ–¹æ¡ˆï¼š
åº”ç”¨ç¨‹åº â†’ 192.168.1.100 (VIP)
                â†“ (è‡ªåŠ¨æ¼‚ç§»)
åº”ç”¨ç¨‹åº â†’ 192.168.1.100 (VIP) â†’ æ–°ä¸»åº“
```

**VIPçš„æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **é€æ˜åˆ‡æ¢** - åº”ç”¨ç¨‹åºæ— éœ€ä¿®æ”¹è¿æ¥é…ç½®
- âš¡ **è‡ªåŠ¨æ¼‚ç§»** - æ•…éšœæ—¶VIPè‡ªåŠ¨è·³è½¬åˆ°æ–°ä¸»åº“
- ğŸ”„ **å¿«é€Ÿæ¢å¤** - å‡å°‘ä¸šåŠ¡ä¸­æ–­æ—¶é—´
- ğŸ“± **ç»Ÿä¸€è®¿é—®** - åº”ç”¨ç¨‹åºåªéœ€è¦è®°ä½ä¸€ä¸ªIP

### 1.2 VIPåœ¨MHAä¸­çš„ä½œç”¨


**MHAæ¶æ„ä¸­çš„VIPä½ç½®**ï¼š
```
          å®¢æˆ·ç«¯åº”ç”¨
              â†“
         VIP: 192.168.1.100
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å½“å‰ç»‘å®šåˆ°ä¸»åº“    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQLä¸»åº“   â”‚ MySQLä»åº“1  â”‚ MySQLä»åº“2  â”‚
â”‚192.168.1.10 â”‚192.168.1.11 â”‚192.168.1.12 â”‚
â”‚   (Master)  â”‚   (Slave)   â”‚   (Slave)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•…éšœåˆ‡æ¢æ—¶ï¼šVIPä»ä¸»åº“æ¼‚ç§»åˆ°æ–°ä¸»åº“
```

### 1.3 VIPå®ç°åŸç†


**ç½‘ç»œå±‚é¢çš„å®ç°æœºåˆ¶**ï¼š
- ğŸ”¸ **ç½‘ç»œæ¥å£ç»‘å®š** - å°†VIPç»‘å®šåˆ°ç½‘å¡çš„è™šæ‹Ÿæ¥å£
- ğŸ”¸ **ARPé€šå‘Š** - å‘Šè¯‰ç½‘ç»œä¸­çš„å…¶ä»–è®¾å¤‡VIPçš„æ–°ä½ç½®
- ğŸ”¸ **è·¯ç”±æ›´æ–°** - æ›´æ–°ç½‘ç»œè·¯ç”±è¡¨
- ğŸ”¸ **æ¥å£ç®¡ç†** - åŠ¨æ€æ·»åŠ å’Œåˆ é™¤ç½‘ç»œæ¥å£

---

## 2. âš™ï¸ MHA VIPè„šæœ¬æœºåˆ¶


### 2.1 MHA VIPè„šæœ¬ä½“ç³»


**MHAçš„ä¸¤ä¸ªæ ¸å¿ƒVIPè„šæœ¬**ï¼š

| è„šæœ¬åç§° | **è§¦å‘æ—¶æœº** | **ä¸»è¦ä½œç”¨** | **æ‰§è¡Œä½ç½®** |
|----------|-------------|-------------|-------------|
| `master_ip_failover` | **æ•…éšœåˆ‡æ¢æ—¶** | `ä»æ—§ä¸»åº“ç§»é™¤VIPï¼Œæ·»åŠ åˆ°æ–°ä¸»åº“` | `MHA ManagerèŠ‚ç‚¹` |
| `master_ip_online_change` | **åœ¨çº¿åˆ‡æ¢æ—¶** | `è®¡åˆ’å†…åˆ‡æ¢æ—¶çš„VIPè¿ç§»` | `MHA ManagerèŠ‚ç‚¹` |

### 2.2 master_ip_failoverè„šæœ¬è¯¦è§£


**è„šæœ¬çš„å·¥ä½œæµç¨‹**ï¼š
```
æ•…éšœæ£€æµ‹
    â†“
MHAè°ƒç”¨master_ip_failoverè„šæœ¬
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€é˜¶æ®µï¼šä»æ—§ä¸»åº“ç§»é™¤VIP    â”‚
â”‚ 1. SSHè¿æ¥åˆ°æ—§ä¸»åº“          â”‚
â”‚ 2. æ‰§è¡Œifconfigå‘½ä»¤åˆ é™¤VIP  â”‚
â”‚ 3. æ¸…ç†ARPç¼“å­˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒé˜¶æ®µï¼šä¸ºæ–°ä¸»åº“æ·»åŠ VIP    â”‚
â”‚ 1. SSHè¿æ¥åˆ°æ–°ä¸»åº“          â”‚
â”‚ 2. æ‰§è¡Œifconfigå‘½ä»¤æ·»åŠ VIP  â”‚
â”‚ 3. å‘é€å…è´¹ARPåŒ…            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŸºç¡€è„šæœ¬ç»“æ„**ï¼š
```bash
#!/usr/bin/env perl
# master_ip_failoverè„šæœ¬æ¡†æ¶

use strict;
use warnings FATAL => 'all';
use Getopt::Long;

# é…ç½®VIPä¿¡æ¯
my $vip = '192.168.1.100/24';
my $interface = 'eth0:1';

# è§£æå‘½ä»¤è¡Œå‚æ•°
my $command = $ARGV[1];          # stop æˆ– start
my $orig_master_host = $ARGV[2]; # åŸä¸»åº“IP
my $new_master_host = $ARGV[4];  # æ–°ä¸»åº“IP

if ($command eq "stop") {
    # ä»åŸä¸»åº“åˆ é™¤VIP
    &stop_vip();
} elsif ($command eq "start") {
    # åœ¨æ–°ä¸»åº“æ·»åŠ VIP
    &start_vip();
}

sub stop_vip {
    `ssh $orig_master_host "ifconfig $interface down"`;
}

sub start_vip {
    `ssh $new_master_host "ifconfig $interface $vip up"`;
    `ssh $new_master_host "arping -c 3 -A 192.168.1.100"`;
}
```

### 2.3 master_ip_online_changeè„šæœ¬


**åœ¨çº¿åˆ‡æ¢åœºæ™¯**ï¼š
- ğŸ”§ **è®¡åˆ’ç»´æŠ¤** - ä¸»åº“éœ€è¦å‡çº§æˆ–ç»´æŠ¤
- ğŸ”„ **æ‰‹åŠ¨åˆ‡æ¢** - ç®¡ç†å‘˜ä¸»åŠ¨åˆ‡æ¢ä¸»åº“
- âš–ï¸ **è´Ÿè½½å‡è¡¡** - åˆ†æ•£æ•°æ®åº“è´Ÿè½½

**è„šæœ¬æ‰§è¡Œæµç¨‹**ï¼š
```
æ‰‹åŠ¨è§¦å‘åœ¨çº¿åˆ‡æ¢
    â†“
MHAè°ƒç”¨master_ip_online_change
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‡†å¤‡é˜¶æ®µ                    â”‚
â”‚ 1. æ£€æŸ¥é›†ç¾¤çŠ¶æ€æ­£å¸¸         â”‚
â”‚ 2. éªŒè¯æ–°ä¸»åº“å¯ç”¨           â”‚
â”‚ 3. ç¡®è®¤VIPè¿ç§»è„šæœ¬å¯æ‰§è¡Œ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ‡æ¢é˜¶æ®µ                    â”‚
â”‚ 1. ä¼˜é›…åœæ­¢åº”ç”¨å†™å…¥         â”‚
â”‚ 2. ç­‰å¾…ä»åº“åŒæ­¥å®Œæˆ         â”‚
â”‚ 3. æ‰§è¡ŒVIPè¿ç§»              â”‚
â”‚ 4. åˆ‡æ¢ä¸»ä»è§’è‰²             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ”§ ç½‘ç»œå‘½ä»¤æ“ä½œè¯¦è§£


### 3.1 ifconfigå‘½ä»¤ä½¿ç”¨


**ä»€ä¹ˆæ˜¯ifconfig**ï¼šä¼ ç»Ÿçš„ç½‘ç»œæ¥å£é…ç½®å·¥å…·

**ğŸ”¸ åŸºæœ¬VIPæ“ä½œ**
```bash
# æ·»åŠ VIPåˆ°ç½‘å¡
ifconfig eth0:1 192.168.1.100/24 up

# æŸ¥çœ‹ç½‘ç»œæ¥å£çŠ¶æ€
ifconfig eth0:1

# åˆ é™¤VIP
ifconfig eth0:1 down

# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œæ¥å£
ifconfig -a
```

**ğŸ”¸ å‚æ•°è¯´æ˜**
```bash
ifconfig eth0:1 192.168.1.100/24 up
         â”‚   â”‚   â”‚              â”‚  â”‚
         â”‚   â”‚   â”‚              â”‚  â””â”€ å¯ç”¨æ¥å£
         â”‚   â”‚   â”‚              â””â”€ å­ç½‘æ©ç ä½æ•°
         â”‚   â”‚   â””â”€ VIPåœ°å€
         â”‚   â””â”€ è™šæ‹Ÿæ¥å£ç¼–å·
         â””â”€ ç‰©ç†ç½‘å¡åç§°
```

### 3.2 ipå‘½ä»¤ä½¿ç”¨


**ä»€ä¹ˆæ˜¯ipå‘½ä»¤**ï¼šç°ä»£Linuxç³»ç»Ÿæ¨èçš„ç½‘ç»œé…ç½®å·¥å…·

**ğŸ”¸ VIPç®¡ç†æ“ä½œ**
```bash
# æ·»åŠ VIPåœ°å€
ip addr add 192.168.1.100/24 dev eth0 label eth0:1

# æŸ¥çœ‹ç½‘ç»œæ¥å£
ip addr show eth0

# åˆ é™¤VIPåœ°å€  
ip addr del 192.168.1.100/24 dev eth0

# å¯ç”¨/ç¦ç”¨ç½‘ç»œæ¥å£
ip link set eth0:1 up
ip link set eth0:1 down
```

**ğŸ”¸ è·¯ç”±ç®¡ç†**
```bash
# æŸ¥çœ‹è·¯ç”±è¡¨
ip route show

# æ·»åŠ è·¯ç”±
ip route add 192.168.1.0/24 dev eth0

# åˆ é™¤è·¯ç”±
ip route del 192.168.1.0/24 dev eth0
```

### 3.3 ARPç¼“å­˜å¤„ç†


**ä¸ºä»€ä¹ˆéœ€è¦å¤„ç†ARPç¼“å­˜**ï¼š
- ğŸ’­ **ARPç¼“å­˜é—®é¢˜** - ç½‘ç»œè®¾å¤‡è®°ä½äº†VIPçš„æ—§MACåœ°å€
- ğŸ”„ **æ›´æ–°æœºåˆ¶** - éœ€è¦ä¸»åŠ¨é€šçŸ¥ç½‘ç»œVIPçš„æ–°ä½ç½®
- âš¡ **å‡å°‘å»¶è¿Ÿ** - é¿å…ARPç¼“å­˜å¯¼è‡´çš„è¿æ¥å»¶è¿Ÿ

**ğŸ”¸ ARPæ“ä½œå‘½ä»¤**
```bash
# å‘é€å…è´¹ARPåŒ…ï¼ˆé€šçŸ¥ç½‘ç»œVIPæ–°ä½ç½®ï¼‰
arping -c 3 -A 192.168.1.100

# æŸ¥çœ‹ARPç¼“å­˜è¡¨
arp -a

# åˆ é™¤ç‰¹å®šARPç¼“å­˜
arp -d 192.168.1.100

# æ¸…ç©ºæ‰€æœ‰ARPç¼“å­˜ï¼ˆç½‘å…³è®¾å¤‡ä¸Šï¼‰
ip neigh flush all
```

**å…è´¹ARPåŒ…çš„ä½œç”¨**ï¼š
```
VIPæ¼‚ç§»è¿‡ç¨‹ï¼š
æ—§ä¸»åº“ MAC: aa:bb:cc:dd:ee:ff
æ–°ä¸»åº“ MAC: 11:22:33:44:55:66

1. VIPä»æ—§ä¸»åº“ç§»é™¤
2. VIPæ·»åŠ åˆ°æ–°ä¸»åº“
3. æ–°ä¸»åº“å‘é€å…è´¹ARP: "192.168.1.100 ç°åœ¨åœ¨ 11:22:33:44:55:66"
4. ç½‘ç»œä¸­çš„è®¾å¤‡æ›´æ–°ARPç¼“å­˜
5. åç»­æµé‡æ­£ç¡®è·¯ç”±åˆ°æ–°ä¸»åº“
```

---

## 4. ğŸ› ï¸ VIPè„šæœ¬å®šåˆ¶å¼€å‘


### 4.1 ç”Ÿäº§ç¯å¢ƒVIPè„šæœ¬


**å®Œæ•´çš„master_ip_failoverè„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/usr/bin/env perl

use strict;
use warnings FATAL => 'all';
use Getopt::Long;
use MHA::DBHelper;
use MHA::NodeUtil;

# VIPé…ç½®
my $vip = '192.168.1.100';
my $mask = '24';
my $interface = 'eth0:1';
my $ssh_user = 'root';

# æ—¥å¿—å‡½æ•°
sub write_log {
    my $message = shift;
    my $timestamp = `date "+%Y-%m-%d %H:%M:%S"`;
    chomp($timestamp);
    print "[$timestamp] $message\n";
}

# æ£€æŸ¥VIPæ˜¯å¦å­˜åœ¨
sub check_vip {
    my $host = shift;
    my $cmd = "ssh $ssh_user\@$host \"ip addr show | grep $vip\"";
    my $result = `$cmd`;
    return ($result =~ /$vip/) ? 1 : 0;
}

# åˆ é™¤VIP
sub stop_vip {
    my $host = shift;
    write_log("Removing VIP $vip from $host");
    
    # æ£€æŸ¥VIPæ˜¯å¦å­˜åœ¨
    unless (check_vip($host)) {
        write_log("VIP $vip not found on $host");
        return 0;
    }
    
    # åˆ é™¤VIP
    my $cmd = "ssh $ssh_user\@$host \"ip addr del $vip/$mask dev eth0\"";
    my $result = system($cmd);
    
    if ($result == 0) {
        write_log("Successfully removed VIP from $host");
    } else {
        write_log("Failed to remove VIP from $host");
        return 1;
    }
    return 0;
}

# æ·»åŠ VIP
sub start_vip {
    my $host = shift;
    write_log("Adding VIP $vip to $host");
    
    # æ£€æŸ¥VIPæ˜¯å¦å·²å­˜åœ¨
    if (check_vip($host)) {
        write_log("VIP $vip already exists on $host");
        return 0;
    }
    
    # æ·»åŠ VIP
    my $cmd = "ssh $ssh_user\@$host \"ip addr add $vip/$mask dev eth0 label $interface\"";
    my $result = system($cmd);
    
    if ($result != 0) {
        write_log("Failed to add VIP to $host");
        return 1;
    }
    
    # å‘é€å…è´¹ARP
    $cmd = "ssh $ssh_user\@$host \"arping -c 3 -A $vip -I eth0\"";
    system($cmd);
    
    write_log("Successfully added VIP to $host");
    return 0;
}

# ä¸»ç¨‹åºé€»è¾‘
my $command = shift;

if ($command eq "stop") {
    my $orig_master_host = shift;
    exit stop_vip($orig_master_host);
} elsif ($command eq "start") {
    my $new_master_host = shift;
    exit start_vip($new_master_host);
} else {
    print "Usage: $0 {start|stop} <host>\n";
    exit 1;
}
```

### 4.2 è„šæœ¬éƒ¨ç½²é…ç½®


**ğŸ”¸ éƒ¨ç½²æ­¥éª¤**
```bash
# 1. å¤åˆ¶è„šæœ¬åˆ°MHA ManagerèŠ‚ç‚¹
cp master_ip_failover /usr/local/bin/
chmod +x /usr/local/bin/master_ip_failover

# 2. é…ç½®MHAé…ç½®æ–‡ä»¶
vim /etc/mha/app1.cnf

[server default]
master_ip_failover_script=/usr/local/bin/master_ip_failover
master_ip_online_change_script=/usr/local/bin/master_ip_online_change

# 3. é…ç½®SSHå…å¯†ç™»å½•
ssh-keygen -t rsa
ssh-copy-id root@192.168.1.10
ssh-copy-id root@192.168.1.11
ssh-copy-id root@192.168.1.12
```

### 4.3 ç½‘ç»œæ¥å£ç»‘å®šç­–ç•¥


**ä¸åŒçš„VIPç»‘å®šæ–¹å¼**ï¼š

| ç»‘å®šæ–¹å¼ | **å‘½ä»¤ç¤ºä¾‹** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|----------|-------------|----------|----------|
| **è™šæ‹Ÿæ¥å£** | `ifconfig eth0:1 192.168.1.100/24 up` | `å…¼å®¹æ€§å¥½ï¼Œæ˜“ç†è§£` | `è€æ—§å‘½ä»¤ï¼Œé€æ¸åºŸå¼ƒ` |
| **è¾…åŠ©åœ°å€** | `ip addr add 192.168.1.100/24 dev eth0` | `ç°ä»£åŒ–ï¼ŒåŠŸèƒ½å¼ºå¤§` | `éœ€è¦è¾ƒæ–°ç³»ç»Ÿæ”¯æŒ` |
| **åˆ«åæ¥å£** | `ip addr add 192.168.1.100/24 dev eth0 label eth0:vip` | `ä¾¿äºç®¡ç†è¯†åˆ«` | `é…ç½®ç¨å¤æ‚` |

**> ğŸ’¡ å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨`ip`å‘½ä»¤ï¼Œå› ä¸ºå®ƒæ˜¯ç°ä»£Linuxçš„æ ‡å‡†å·¥å…·

---

## 5. ğŸ§ª VIPæ¼‚ç§»æµ‹è¯•éªŒè¯


### 5.1 æµ‹è¯•ç¯å¢ƒå‡†å¤‡


**æµ‹è¯•æ¶æ„æ­å»º**ï¼š
```
æµ‹è¯•ç¯å¢ƒæ‹“æ‰‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MHA Manager   â”‚    â”‚    MySQLä¸»åº“    â”‚    â”‚   MySQLä»åº“     â”‚
â”‚  192.168.1.20   â”‚    â”‚  192.168.1.10   â”‚    â”‚  192.168.1.11   â”‚
â”‚                 â”‚    â”‚  VIPç»‘å®šä½ç½®    â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                        VIP: 192.168.1.100
                              â†“
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   å®¢æˆ·ç«¯æµ‹è¯•     â”‚
                       â”‚  192.168.1.30   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ ç¯å¢ƒæ£€æŸ¥æ¸…å•**
```bash
# 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 192.168.1.10
ping 192.168.1.11

# 2. æ£€æŸ¥SSHå…å¯†ç™»å½•
ssh root@192.168.1.10 "hostname"
ssh root@192.168.1.11 "hostname"

# 3. æ£€æŸ¥MHAé…ç½®
masterha_check_ssh --conf=/etc/mha/app1.cnf
masterha_check_repl --conf=/etc/mha/app1.cnf

# 4. ç¡®è®¤VIPæœªè¢«å ç”¨
ping 192.168.1.100  # åº”è¯¥ä¸é€š
arping 192.168.1.100  # åº”è¯¥æ— å“åº”
```

### 5.2 æ‰‹åŠ¨VIPæµ‹è¯•


**ğŸ”¸ æ‰‹åŠ¨VIPæ“ä½œæµ‹è¯•**
```bash
# åœ¨ä¸»åº“æ·»åŠ VIP
ssh root@192.168.1.10 "ip addr add 192.168.1.100/24 dev eth0"

# éªŒè¯VIPæ˜¯å¦ç”Ÿæ•ˆ
ping 192.168.1.100  # åº”è¯¥èƒ½pingé€š
ssh root@192.168.1.10 "ip addr show eth0"  # åº”è¯¥çœ‹åˆ°VIP

# ä»ä¸»åº“ç§»é™¤VIP
ssh root@192.168.1.10 "ip addr del 192.168.1.100/24 dev eth0"

# åœ¨ä»åº“æ·»åŠ VIP
ssh root@192.168.1.11 "ip addr add 192.168.1.100/24 dev eth0"
ssh root@192.168.1.11 "arping -c 3 -A 192.168.1.100 -I eth0"

# éªŒè¯VIPè¿ç§»æˆåŠŸ
ping 192.168.1.100  # åº”è¯¥èƒ½pingé€šæ–°ä½ç½®
```

### 5.3 è‡ªåŠ¨åŒ–æ•…éšœåˆ‡æ¢æµ‹è¯•


**ğŸ”¸ æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•**
```bash
# 1. å¯åŠ¨MHAç›‘æ§
nohup masterha_manager --conf=/etc/mha/app1.cnf > /var/log/mha/app1.log 2>&1 &

# 2. ç¡®è®¤å½“å‰ä¸»åº“VIPçŠ¶æ€
ssh root@192.168.1.10 "ip addr show | grep 192.168.1.100"

# 3. æ¨¡æ‹Ÿä¸»åº“æ•…éšœï¼ˆåœæ­¢MySQLæœåŠ¡ï¼‰
ssh root@192.168.1.10 "systemctl stop mysql"

# 4. è§‚å¯ŸMHAæ—¥å¿—
tail -f /var/log/mha/app1.log

# 5. éªŒè¯VIPæ˜¯å¦æ¼‚ç§»åˆ°æ–°ä¸»åº“
ping 192.168.1.100
ssh root@192.168.1.11 "ip addr show | grep 192.168.1.100"
```

**æµ‹è¯•ç»“æœéªŒè¯**ï¼š
```bash
# åº”ç”¨ç¨‹åºè¿æ¥æµ‹è¯•
mysql -h 192.168.1.100 -u app_user -p -e "SELECT $$hostname, $$server_id;"

# æ£€æŸ¥ä¸»ä»å…³ç³»
mysql -h 192.168.1.100 -u root -p -e "SHOW MASTER STATUS;"
mysql -h 192.168.1.12 -u root -p -e "SHOW SLAVE STATUS\G"
```

---

## 6. ğŸš¨ æ•…éšœå¤„ç†ä¸æ’é”™


### 6.1 å¸¸è§VIPæ•…éšœåœºæ™¯


**ğŸ”¸ VIPè„šæœ¬æ‰§è¡Œå¤±è´¥**
```bash
æ•…éšœç°è±¡ï¼š
- MHAæ£€æµ‹åˆ°ä¸»åº“æ•…éšœ
- ä½†VIPæ²¡æœ‰è¿ç§»åˆ°æ–°ä¸»åº“
- åº”ç”¨ç¨‹åºæ— æ³•è¿æ¥æ•°æ®åº“

æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥MHAæ—¥å¿—
   tail -f /var/log/mha/app1.log | grep -i "ip_failover"

2. æ‰‹åŠ¨æµ‹è¯•VIPè„šæœ¬
   /usr/local/bin/master_ip_failover stop 192.168.1.10
   /usr/local/bin/master_ip_failover start 192.168.1.11

3. æ£€æŸ¥SSHè¿æ¥
   ssh root@192.168.1.11 "hostname"
```

**ğŸ”¸ ARPç¼“å­˜é—®é¢˜**
```bash
æ•…éšœç°è±¡ï¼š
- VIPå·²ç»è¿ç§»åˆ°æ–°ä¸»åº“
- ä½†å®¢æˆ·ç«¯è¿æ¥ä»ç„¶è·¯ç”±åˆ°æ—§ä¸»åº“
- ç½‘ç»œå­˜åœ¨çŸ­æš‚ä¸å¯è¾¾

è§£å†³æ–¹æ¡ˆï¼š
1. åœ¨æ–°ä¸»åº“å¼ºåˆ¶å‘é€ARP
   arping -c 5 -A 192.168.1.100 -I eth0

2. æ¸…ç†å®¢æˆ·ç«¯ARPç¼“å­˜
   arp -d 192.168.1.100

3. æ¸…ç†äº¤æ¢æœºARPç¼“å­˜ï¼ˆå¦‚æœæœ‰æƒé™ï¼‰
   # ç™»å½•äº¤æ¢æœºæ¸…ç†MACåœ°å€è¡¨
```

### 6.2 VIPæ•…éšœè¯Šæ–­å·¥å…·


**ğŸ”¸ ç½‘ç»œè¯Šæ–­å‘½ä»¤é›†**
```bash
# 1. VIPçŠ¶æ€æ£€æŸ¥
check_vip_status() {
    local host=$1
    echo "=== VIP Status on $host ==="
    ssh root@$host "ip addr show | grep -A 2 -B 2 192.168.1.100"
    ssh root@$host "ip route | grep 192.168.1.100"
}

# 2. ARPè¡¨æ£€æŸ¥
check_arp_table() {
    echo "=== ARP Table Status ==="
    arp -a | grep 192.168.1.100
    arping -c 1 192.168.1.100
}

# 3. ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
check_connectivity() {
    echo "=== Network Connectivity ==="
    ping -c 3 192.168.1.100
    telnet 192.168.1.100 3306
}

# ä½¿ç”¨ç¤ºä¾‹
check_vip_status 192.168.1.10
check_vip_status 192.168.1.11
check_arp_table
check_connectivity
```

### 6.3 è„šæœ¬è°ƒè¯•æŠ€å·§


**ğŸ”¸ å¢å¼ºè„šæœ¬æ—¥å¿—è¾“å‡º**
```bash
# åœ¨VIPè„šæœ¬ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
debug_log() {
    local message="$1"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] DEBUG: $message" >> /var/log/mha/vip_debug.log
}

# è®°å½•æ¯ä¸ªå…³é”®æ­¥éª¤
debug_log "Starting VIP migration from $orig_master to $new_master"
debug_log "Executing command: $cmd"
debug_log "Command result: $result"
```

**ğŸ”¸ è„šæœ¬æµ‹è¯•æ¨¡å¼**
```bash
#!/bin/bash
# è®¾ç½®æµ‹è¯•æ¨¡å¼å˜é‡
TEST_MODE=${TEST_MODE:-0}

execute_command() {
    local cmd="$1"
    if [ "$TEST_MODE" = "1" ]; then
        echo "TEST MODE: Would execute: $cmd"
    else
        eval $cmd
    fi
}

# ä½¿ç”¨æ–¹å¼
TEST_MODE=1 ./master_ip_failover start 192.168.1.11
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ VIPæœ¬è´¨ï¼šè™šæ‹ŸIPåœ°å€ï¼Œå®ç°æ•°æ®åº“æœåŠ¡çš„é€æ˜åˆ‡æ¢
ğŸ”¸ è„šæœ¬æœºåˆ¶ï¼šmaster_ip_failoveræ•…éšœåˆ‡æ¢ï¼Œmaster_ip_online_changeåœ¨çº¿åˆ‡æ¢  
ğŸ”¸ ç½‘ç»œå‘½ä»¤ï¼šifconfigä¼ ç»Ÿå·¥å…·ï¼Œipç°ä»£å·¥å…·ï¼Œarpingå¤„ç†ARPç¼“å­˜
ğŸ”¸ å®ç°åŸç†ï¼šç½‘ç»œæ¥å£ç»‘å®š + ARPé€šå‘Š + è·¯ç”±æ›´æ–°
ğŸ”¸ æµ‹è¯•éªŒè¯ï¼šæ‰‹åŠ¨æµ‹è¯• â†’ è‡ªåŠ¨åŒ–æµ‹è¯• â†’ æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ VIPçš„å·¥ä½œæœºåˆ¶**
```
æ­£å¸¸æƒ…å†µï¼š
åº”ç”¨ â†’ VIP(192.168.1.100) â†’ ä¸»åº“(192.168.1.10)

æ•…éšœåˆ‡æ¢ï¼š
1. æ£€æµ‹ä¸»åº“æ•…éšœ
2. ä»ä¸»åº“ç§»é™¤VIP  
3. åœ¨æ–°ä¸»åº“æ·»åŠ VIP
4. å‘é€å…è´¹ARPåŒ…
5. åº”ç”¨ â†’ VIP(192.168.1.100) â†’ æ–°ä¸»åº“(192.168.1.11)
```

**ğŸ”¹ ç½‘ç»œå‘½ä»¤çš„é€‰æ‹©**
```
ifconfig vs ipå‘½ä»¤ï¼š
âœ… ipå‘½ä»¤ï¼šç°ä»£Linuxæ ‡å‡†ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ¨èä½¿ç”¨
âš ï¸ ifconfigï¼šä¼ ç»Ÿå·¥å…·ï¼Œå…¼å®¹æ€§å¥½ï¼Œé€æ¸è¢«æ›¿ä»£

ARPå¤„ç†çš„é‡è¦æ€§ï¼š
- ç½‘ç»œè®¾å¤‡æœ‰ARPç¼“å­˜æœºåˆ¶
- VIPè¿ç§»åå¿…é¡»æ›´æ–°ç½‘ç»œä¸­çš„ARPä¿¡æ¯
- å…è´¹ARPåŒ…æ˜¯å…³é”®æ­¥éª¤ï¼Œä¸å¯çœç•¥
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®**
```bash
# 1. è„šæœ¬å®‰å…¨æ€§æ£€æŸ¥
chmod 700 /usr/local/bin/master_ip_failover
chown root:root /usr/local/bin/master_ip_failover

# 2. æ—¥å¿—å®¡è®¡é…ç½®
echo "master_ip_failover executed by $(whoami) at $(date)" >> /var/log/mha/vip_audit.log

# 3. ç›‘æ§å‘Šè­¦é…ç½®
# ç›‘æ§VIPæ˜¯å¦æ­£ç¡®ç»‘å®šåˆ°ä¸»åº“
*/1 * * * * /usr/local/bin/check_vip_status.sh

# 4. å¤‡ä»½æ¢å¤è®¡åˆ’
# è®°å½•æ¯æ¬¡VIPè¿ç§»çš„è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ•…éšœå›æº¯
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
è„šæœ¬æ‰§è¡Œé€Ÿåº¦ä¼˜åŒ–ï¼š
- å‡å°‘ä¸å¿…è¦çš„SSHè¿æ¥æ¬¡æ•°
- å¹¶è¡Œæ‰§è¡Œå¯ä»¥å¹¶è¡Œçš„æ“ä½œ
- ä½¿ç”¨SSHè¿æ¥å¤ç”¨(-o ControlMaster=auto)

ç½‘ç»œåˆ‡æ¢é€Ÿåº¦ä¼˜åŒ–ï¼š
- åˆç†è®¾ç½®arpingå‘é€æ¬¡æ•°(3-5æ¬¡å³å¯)
- åœ¨äº¤æ¢æœºå±‚é¢ä¼˜åŒ–ARPè¡¨æ›´æ–°æ—¶é—´
- è€ƒè™‘ä½¿ç”¨keepalivedç­‰ä¸“ä¸šå·¥å…·
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- VIPæ˜¯MHAé«˜å¯ç”¨çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ç°é€æ˜æ•…éšœåˆ‡æ¢
- ä¸¤ä¸ªæ ¸å¿ƒè„šæœ¬è´Ÿè´£ä¸åŒåœºæ™¯çš„VIPè¿ç§»æ“ä½œ
- ç½‘ç»œå‘½ä»¤å’ŒARPå¤„ç†æ˜¯VIPå·¥ä½œçš„æŠ€æœ¯åŸºç¡€
- å……åˆ†æµ‹è¯•å’Œç›‘æ§æ˜¯ä¿è¯VIPå¯é æ€§çš„å…³é”®