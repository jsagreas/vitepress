---
title: 19、MHA常见故障处理
---
## 📚 目录

1. [故障处理概述](#1-故障处理概述)
2. [SSH连接失败处理](#2-SSH连接失败处理)
3. [复制中断处理](#3-复制中断处理)
4. [权限错误处理](#4-权限错误处理)
5. [网络故障处理](#5-网络故障处理)
6. [磁盘空间问题](#6-磁盘空间问题)
7. [配置文件错误](#7-配置文件错误)
8. [脚本执行失败](#8-脚本执行失败)
9. [VIP漂移失败](#9-VIP漂移失败)
10. [数据不一致处理](#10-数据不一致处理)
11. [性能问题处理](#11-性能问题处理)
12. [核心要点总结](#12-核心要点总结)

---

## 1. 🛠️ 故障处理概述


### 1.1 什么是MHA故障处理


**MHA故障处理**就是当MySQL MHA（Master High Availability）高可用环境出现问题时，我们需要采取的诊断和修复措施。

简单来说，就像医生给病人看病一样：
- **发现症状**：系统出现异常表现
- **诊断病因**：找到问题的根本原因  
- **对症下药**：采取相应的解决方案
- **康复观察**：确保问题彻底解决

### 1.2 MHA常见故障类型


```
故障分类图：

网络类故障 ─┬─ SSH连接失败
            ├─ 网络延迟/中断
            └─ 防火墙阻挡

系统类故障 ─┬─ 磁盘空间不足
            ├─ 权限错误
            └─ 配置文件错误

数据库故障 ─┬─ 复制中断
            ├─ 数据不一致
            └─ 性能问题

应用类故障 ─┬─ 脚本执行失败
            └─ VIP漂移失败
```

### 1.3 故障处理基本原则


💡 **处理原则**：
- **安全第一**：确保数据不丢失
- **快速恢复**：尽快恢复服务
- **分析记录**：详细记录故障过程
- **预防为主**：建立监控和预警机制

---

## 2. 🔐 SSH连接失败处理


### 2.1 SSH连接失败是什么


**SSH连接失败**是指MHA Manager无法通过SSH连接到MySQL服务器节点。这就像你想打电话给朋友，但电话一直打不通的情况。

**为什么会出现这个问题？**
- SSH服务停止了
- 网络不通
- 认证失败
- 防火墙阻挡

### 2.2 故障现象识别


**典型错误信息**：
```bash
# MHA日志中常见错误
SSH connection failed: Connection refused (port 22)
Permission denied (publickey,password)
Host key verification failed
Connection timed out
```

**快速检查方法**：
```bash
# 1. 测试SSH连接
ssh mysql@192.168.1.10

# 2. 检查SSH服务状态
systemctl status sshd

# 3. 检查网络连通性
ping 192.168.1.10
telnet 192.168.1.10 22
```

### 2.3 解决方案


#### 🔧 SSH服务问题


**问题：SSH服务未启动**
```bash
# 检查SSH服务
systemctl status sshd

# 启动SSH服务
systemctl start sshd
systemctl enable sshd

# 检查SSH端口
netstat -tlnp | grep :22
```

**问题：SSH配置错误**
```bash
# 检查SSH配置文件
cat /etc/ssh/sshd_config

# 常见配置检查
Port 22                    # 确认端口正确
PermitRootLogin yes       # 允许root登录（如需要）
PubkeyAuthentication yes  # 允许密钥认证
PasswordAuthentication no # 推荐关闭密码认证
```

#### 🔑 密钥认证问题


**设置免密登录**：
```bash
# 1. 在MHA Manager上生成密钥
ssh-keygen -t rsa -b 2048

# 2. 复制公钥到所有MySQL节点
ssh-copy-id mysql@192.168.1.10
ssh-copy-id mysql@192.168.1.11
ssh-copy-id mysql@192.168.1.12

# 3. 测试免密登录
ssh mysql@192.168.1.10 'echo "连接成功"'
```

**权限设置**：
```bash
# 设置正确的文件权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_rsa
```

#### 🛡️ 防火墙问题


```bash
# CentOS 7/8 防火墙设置
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload

# 或者开放特定端口
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --reload

# 检查防火墙状态
firewall-cmd --list-all
```

---

## 3. 🔄 复制中断处理


### 3.1 什么是MySQL复制中断


**MySQL复制中断**是指从服务器（Slave）停止从主服务器（Master）同步数据。这就像两个人在传话，中间的传话过程断了。

**为什么会中断？**
- 网络问题导致连接断开
- 主从服务器数据不一致
- 权限问题
- 二进制日志损坏

### 3.2 故障检查方法


**检查复制状态**：
```sql
-- 在从服务器上执行
SHOW SLAVE STATUS\G

-- 重点关注这些字段：
-- Slave_IO_Running: Yes/No    # IO线程是否运行
-- Slave_SQL_Running: Yes/No   # SQL线程是否运行  
-- Last_Error:                 # 最后的错误信息
-- Seconds_Behind_Master:      # 延迟秒数
```

**常见错误状态**：
| 状态组合 | 含义 | 问题类型 |
|---------|------|----------|
| `IO: No, SQL: Yes` | 无法连接主服务器 | 网络或权限问题 |
| `IO: Yes, SQL: No` | SQL执行错误 | 数据不一致问题 |
| `IO: No, SQL: No` | 复制完全停止 | 严重故障 |

### 3.3 解决方案


#### 🔗 网络连接问题


```bash
# 1. 检查网络连通性
ping master-ip

# 2. 检查MySQL端口
telnet master-ip 3306

# 3. 检查MySQL进程
ps aux | grep mysqld
```

#### 🔑 权限问题


```sql
-- 在主服务器上检查复制用户权限
SELECT User, Host FROM mysql.user WHERE User = 'repl';
SHOW GRANTS FOR 'repl'@'slave-ip';

-- 重新创建复制用户（如有必要）
DROP USER 'repl'@'slave-ip';
CREATE USER 'repl'@'slave-ip' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'slave-ip';
FLUSH PRIVILEGES;
```

#### 📊 数据不一致问题


```sql
-- 方法1：跳过错误（谨慎使用）
STOP SLAVE;
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- 方法2：重新同步（推荐）
STOP SLAVE;
RESET SLAVE ALL;

-- 获取主服务器位置
-- 在主服务器执行：
SHOW MASTER STATUS;

-- 重新配置从服务器
CHANGE MASTER TO
  MASTER_HOST='master-ip',
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_LOG_FILE='mysql-bin.000123',
  MASTER_LOG_POS=4567;

START SLAVE;
```

---

## 4. 🔒 权限错误处理


### 4.1 权限错误是什么


**权限错误**是指MHA在操作过程中没有足够的权限执行某些操作。这就像你想进入某个房间，但没有钥匙一样。

**常见权限问题**：
- 文件权限不正确
- MySQL用户权限不足
- 系统用户权限问题
- 目录访问权限错误

### 4.2 MySQL权限问题


**MHA所需的MySQL权限**：
```sql
-- MHA管理用户需要的权限
CREATE USER 'mha'@'%' IDENTIFIED BY 'mha_password';
GRANT ALL PRIVILEGES ON *.* TO 'mha'@'%';

-- 或者更精确的权限分配
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, 
      RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, 
      INDEX, ALTER, SHOW DATABASES, SUPER, 
      CREATE TEMPORARY TABLES, LOCK TABLES, 
      EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT 
ON *.* TO 'mha'@'%';

FLUSH PRIVILEGES;
```

**检查用户权限**：
```sql
-- 查看当前用户权限
SHOW GRANTS;

-- 查看特定用户权限
SHOW GRANTS FOR 'mha'@'%';

-- 检查用户是否存在
SELECT User, Host FROM mysql.user WHERE User = 'mha';
```

### 4.3 文件权限问题


**MHA相关文件权限设置**：
```bash
# 配置文件权限
chmod 644 /etc/mha/app1.cnf

# 日志目录权限
chmod 755 /var/log/mha
chown mha:mha /var/log/mha

# 脚本文件权限
chmod 755 /usr/local/bin/master_ip_failover
chmod 755 /usr/local/bin/master_ip_online_change

# SSH密钥权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
chmod 600 ~/.ssh/authorized_keys
```

**检查权限的方法**：
```bash
# 查看文件详细权限
ls -la /etc/mha/
ls -la ~/.ssh/

# 检查文件所有者
stat /etc/mha/app1.cnf

# 测试文件是否可读写
test -r /etc/mha/app1.cnf && echo "可读" || echo "不可读"
test -w /etc/mha/app1.cnf && echo "可写" || echo "不可写"
```

---

## 5. 🌐 网络故障处理


### 5.1 网络故障的表现


**网络故障**是指MHA各组件之间无法正常通信。这就像几个人要开会，但电话线路出问题了。

**常见网络问题**：
- 网络延迟过高
- 网络丢包
- 防火墙阻挡
- DNS解析失败

### 5.2 网络诊断方法


**基础连通性测试**：
```bash
# 1. Ping测试
ping -c 4 192.168.1.10

# 2. 端口连通性测试
telnet 192.168.1.10 3306
nc -zv 192.168.1.10 3306

# 3. 路由跟踪
traceroute 192.168.1.10

# 4. 网络延迟测试
mtr 192.168.1.10
```

**MySQL连接测试**：
```bash
# 测试MySQL连接
mysql -h 192.168.1.10 -u mha -p -e "SELECT 1"

# 检查连接超时设置
mysql -e "SHOW VARIABLES LIKE '%timeout%'"
```

### 5.3 网络问题解决


#### 🔧 延迟和超时问题


**调整MHA超时参数**：
```bash
# 在MHA配置文件中设置
[server default]
ping_interval=3
secondary_check_script=/usr/local/bin/masterha_secondary_check -s remote_host1 -s remote_host2
master_connect_retry=10
```

**调整MySQL超时参数**：
```sql
-- 增加连接超时时间
SET GLOBAL connect_timeout = 60;
SET GLOBAL net_read_timeout = 120;
SET GLOBAL net_write_timeout = 120;

-- 持久化配置（写入my.cnf）
[mysqld]
connect_timeout = 60
net_read_timeout = 120
net_write_timeout = 120
```

#### 🛡️ 防火墙配置


```bash
# 开放MySQL端口
firewall-cmd --permanent --add-port=3306/tcp

# 开放SSH端口
firewall-cmd --permanent --add-port=22/tcp

# 开放MHA管理端口（如有自定义）
firewall-cmd --permanent --add-port=10000-10010/tcp

# 重新加载防火墙
firewall-cmd --reload

# 查看开放的端口
firewall-cmd --list-ports
```

---

## 6. 💾 磁盘空间问题


### 6.1 磁盘空间不足的影响


**磁盘空间不足**会导致MySQL和MHA无法正常工作。这就像你的电脑硬盘满了，什么文件都存不了。

**影响范围**：
- MySQL无法写入数据
- 二进制日志无法生成
- MHA日志无法记录
- 故障转移脚本执行失败

### 6.2 磁盘空间检查


**检查磁盘使用情况**：
```bash
# 查看磁盘使用情况
df -h

# 查看目录大小
du -sh /var/lib/mysql
du -sh /var/log/mysql
du -sh /var/log/mha

# 查看最大的文件
find /var/lib/mysql -type f -size +1G -exec ls -lh {} \;
```

**监控关键目录**：
| 目录 | 作用 | 清理建议 |
|------|------|----------|
| `/var/lib/mysql` | MySQL数据目录 | 清理旧的二进制日志 |
| `/var/log/mysql` | MySQL日志目录 | 删除旧的错误日志和慢查询日志 |
| `/var/log/mha` | MHA日志目录 | 定期清理旧的MHA日志 |
| `/tmp` | 临时文件目录 | 清理临时文件 |

### 6.3 空间清理方案


#### 🗂️ MySQL日志清理


```sql
-- 查看二进制日志
SHOW BINARY LOGS;

-- 清理指定日期前的日志
PURGE BINARY LOGS BEFORE '2024-01-01 00:00:00';

-- 清理指定文件前的日志  
PURGE BINARY LOGS TO 'mysql-bin.000123';

-- 设置自动清理（保留7天）
SET GLOBAL expire_logs_days = 7;
```

**在配置文件中设置**：
```ini
[mysqld]
# 自动清理二进制日志（保留7天）
expire_logs_days = 7

# 限制二进制日志文件大小
max_binlog_size = 100M
```

#### 📋 系统日志清理


```bash
# 清理MHA日志
find /var/log/mha -name "*.log" -mtime +30 -delete

# 清理MySQL错误日志
find /var/log/mysql -name "error.log.*" -mtime +7 -delete

# 清理系统临时文件
find /tmp -type f -atime +7 -delete

# 清理系统日志
journalctl --vacuum-time=7d
```

#### 📊 预防措施


**设置磁盘监控脚本**：
```bash
#!/bin/bash
# disk_monitor.sh

THRESHOLD=80
PARTITION="/"

USAGE=$(df -h "$PARTITION" | awk 'NR==2 {print $5}' | sed 's/%//')

if [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "警告：磁盘使用率已达到 ${USAGE}%"
    # 发送邮件或短信告警
    echo "磁盘空间不足警告" | mail -s "磁盘告警" admin@company.com
fi
```

---

## 7. 📝 配置文件错误


### 7.1 配置文件错误类型


**配置文件错误**是指MHA或MySQL的配置文件中存在语法错误或参数设置不当。这就像你给别人写地址，但地址写错了，别人就找不到地方。

**常见配置错误**：
- 语法错误（拼写、格式）
- 参数值错误
- 路径不存在
- 权限配置错误

### 7.2 MHA配置文件检查


**配置文件语法检查**：
```bash
# 检查MHA配置文件语法
masterha_check_ssh --conf=/etc/mha/app1.cnf
masterha_check_repl --conf=/etc/mha/app1.cnf

# 检查配置文件格式
cat -n /etc/mha/app1.cnf | head -20
```

**常见配置错误示例**：
```bash
# ❌ 错误的配置
[server default]
user=mha
password=password123
ssh_user=root
repl_user=repl
repl_password=repl123
ping_interval=3

[server1]
hostname=192.168.1.10
port=3306

# ✅ 正确的配置  
[server default]
user=mha
password=password123
ssh_user=mysql
repl_user=repl
repl_password=repl123
ping_interval=3
master_connect_retry=10

[server1]
hostname=192.168.1.10
port=3306
candidate_master=1
```

### 7.3 MySQL配置检查


**检查MySQL配置文件**：
```bash
# 检查配置文件语法
mysqld --help --verbose | grep "my.cnf"

# 查看当前配置
mysql -e "SHOW VARIABLES LIKE 'server_id'"
mysql -e "SHOW VARIABLES LIKE 'log_bin'"
mysql -e "SHOW VARIABLES LIKE 'read_only'"
```

**关键配置检查**：
```sql
-- 检查server_id（每个服务器必须唯一）
SHOW VARIABLES LIKE 'server_id';

-- 检查二进制日志
SHOW VARIABLES LIKE 'log_bin';

-- 检查只读状态
SHOW VARIABLES LIKE 'read_only';

-- 检查GTID设置
SHOW VARIABLES LIKE 'gtid_mode';
```

---

## 8. 📜 脚本执行失败


### 8.1 脚本执行失败原因


**脚本执行失败**是指MHA的切换脚本或自定义脚本无法正常运行。这就像你写了一个任务清单，但执行时发现有些步骤做不了。

**常见失败原因**：
- 脚本语法错误
- 权限不足
- 依赖程序缺失
- 路径错误

### 8.2 关键脚本类型


**MHA核心脚本**：
```
故障转移脚本：
├── master_ip_failover          # VIP漂移脚本
├── master_ip_online_change     # 在线切换脚本
├── send_report                 # 报告发送脚本
└── power_manager               # 电源管理脚本
```

### 8.3 脚本调试方法


**手动测试脚本**：
```bash
# 测试故障转移脚本
/usr/local/bin/master_ip_failover \
  --command=start \
  --ssh_user=mysql \
  --orig_master_host=192.168.1.10 \
  --orig_master_ip=192.168.1.10 \
  --orig_master_port=3306 \
  --new_master_host=192.168.1.11 \
  --new_master_ip=192.168.1.11 \
  --new_master_port=3306

# 检查脚本权限
ls -la /usr/local/bin/master_ip_failover

# 检查脚本语法（以bash脚本为例）
bash -n /usr/local/bin/master_ip_failover
```

**VIP漂移脚本示例**：
```bash
#!/bin/bash
# master_ip_failover

VIP="192.168.1.100"
NETMASK="24"
INTERFACE="eth0"

case "$1" in
  --command=start)
    echo "Adding VIP $VIP to $INTERFACE"
    ip addr add $VIP/$NETMASK dev $INTERFACE
    arping -c 3 -A $VIP
    ;;
  --command=stop)
    echo "Removing VIP $VIP from $INTERFACE"
    ip addr del $VIP/$NETMASK dev $INTERFACE
    ;;
  *)
    echo "Usage: $0 {--command=start|--command=stop}"
    exit 1
    ;;
esac
```

**脚本权限设置**：
```bash
# 设置执行权限
chmod +x /usr/local/bin/master_ip_failover

# 设置所有者
chown mysql:mysql /usr/local/bin/master_ip_failover

# 检查依赖命令
which ip
which arping
which mysql
```

---

## 9. 🔄 VIP漂移失败


### 9.1 什么是VIP漂移失败


**VIP漂移失败**是指虚拟IP地址无法从故障的主服务器转移到新的主服务器。这就像公司搬家，但新地址的招牌还没挂上，客户找不到新地址。

**VIP的作用**：
- 为应用提供固定的访问地址
- 实现故障时的自动切换
- 避免修改应用配置

### 9.2 VIP漂移检查


**检查当前VIP状态**：
```bash
# 查看网络接口
ip addr show

# 检查VIP是否存在
ip addr show | grep "192.168.1.100"

# 检查ARP表
arp -a | grep "192.168.1.100"

# 测试VIP连通性
ping 192.168.1.100
```

**检查网络接口配置**：
```bash
# 查看网络接口信息
ifconfig eth0

# 检查接口状态
ethtool eth0

# 查看路由表
ip route show
```

### 9.3 VIP漂移故障解决


#### 🔧 手动VIP操作


```bash
# 手动添加VIP
ip addr add 192.168.1.100/24 dev eth0

# 手动删除VIP  
ip addr del 192.168.1.100/24 dev eth0

# 发送免费ARP
arping -c 3 -A 192.168.1.100

# 或使用传统方式
ifconfig eth0:1 192.168.1.100 netmask 255.255.255.0 up
ifconfig eth0:1 down
```

#### 📋 VIP脚本优化


**改进的VIP脚本**：
```bash
#!/bin/bash
# 增强版 master_ip_failover

VIP="192.168.1.100"
NETMASK="24"
INTERFACE="eth0"
LOG_FILE="/var/log/mha/vip.log"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

add_vip() {
    log_message "开始添加VIP $VIP"
    
    # 检查VIP是否已存在
    if ip addr show | grep -q "$VIP"; then
        log_message "VIP $VIP 已存在，先删除"
        ip addr del $VIP/$NETMASK dev $INTERFACE 2>/dev/null
    fi
    
    # 添加VIP
    if ip addr add $VIP/$NETMASK dev $INTERFACE; then
        log_message "VIP $VIP 添加成功"
        # 发送免费ARP
        arping -c 3 -A $VIP -I $INTERFACE
        log_message "ARP广播完成"
        exit 0
    else
        log_message "VIP $VIP 添加失败"
        exit 1
    fi
}

remove_vip() {
    log_message "开始删除VIP $VIP"
    
    if ip addr del $VIP/$NETMASK dev $INTERFACE 2>/dev/null; then
        log_message "VIP $VIP 删除成功"
        exit 0
    else
        log_message "VIP $VIP 删除失败或不存在"
        exit 1
    fi
}

case "$1" in
    --command=start)
        add_vip
        ;;
    --command=stop)
        remove_vip
        ;;
    *)
        echo "Usage: $0 {--command=start|--command=stop}"
        exit 1
        ;;
esac
```

---

## 10. 📊 数据不一致处理


### 10.1 数据不一致的表现


**数据不一致**是指主从服务器之间的数据不同步。这就像两本账本记录不一样，需要找出差异并修正。

**常见不一致情况**：
- 从服务器缺少数据
- 从服务器有多余数据  
- 数据内容不匹配
- 表结构不一致

### 10.2 数据一致性检查


**使用pt-table-checksum检查**：
```bash
# 安装percona-toolkit
yum install percona-toolkit

# 检查数据一致性
pt-table-checksum \
  --host=192.168.1.10 \
  --user=mha \
  --password=password \
  --databases=test \
  --replicate=percona.checksums

# 查看检查结果
mysql -e "SELECT * FROM percona.checksums WHERE this_crc != master_crc"
```

**手动数据对比**：
```sql
-- 比较表行数
SELECT COUNT(*) FROM table1;  -- 在主服务器执行
SELECT COUNT(*) FROM table1;  -- 在从服务器执行

-- 比较表结构
SHOW CREATE TABLE table1;

-- 比较特定数据
SELECT * FROM table1 WHERE id BETWEEN 1000 AND 2000;
```

### 10.3 数据同步修复


#### 🔄 使用pt-table-sync修复


```bash
# 修复数据不一致
pt-table-sync \
  --host=192.168.1.11 \
  --user=mha \
  --password=password \
  --databases=test \
  --sync-to-master \
  --print

# 执行修复（去掉--print参数）
pt-table-sync \
  --host=192.168.1.11 \
  --user=mha \
  --password=password \
  --databases=test \
  --sync-to-master \
  --execute
```

#### 🗂️ 手动修复方法


```sql
-- 方法1：重新同步整个数据库
-- 在主服务器上
FLUSH TABLES WITH READ LOCK;
SHOW MASTER STATUS;  -- 记录位置

-- 导出数据
mysqldump --single-transaction --master-data=2 \
  --databases test > test_backup.sql

UNLOCK TABLES;

-- 在从服务器上
STOP SLAVE;
mysql < test_backup.sql

-- 重新设置复制
CHANGE MASTER TO 
  MASTER_LOG_FILE='mysql-bin.000456',
  MASTER_LOG_POS=123456;

START SLAVE;
```

**增量修复方案**：
```sql
-- 方法2：仅修复不一致的表
-- 创建修复脚本
SELECT CONCAT(
  'INSERT IGNORE INTO ', 
  table_schema, '.', table_name, 
  ' SELECT * FROM master_', table_schema, '.', table_name, 
  ' WHERE NOT EXISTS (SELECT 1 FROM ', 
  table_schema, '.', table_name, ' s WHERE s.id = master_', 
  table_schema, '.', table_name, '.id);'
) AS repair_sql
FROM information_schema.tables 
WHERE table_schema = 'test';
```

---

## 11. ⚡ 性能问题处理


### 11.1 性能问题识别


**性能问题**是指MHA环境中MySQL运行缓慢，影响故障切换效率。这就像汽车发动机有问题，跑不快还费油。

**性能问题表现**：
- 主从延迟增大
- 查询响应慢
- 故障切换时间长
- CPU或内存使用率高

### 11.2 性能监控指标


**关键性能指标**：
```sql
-- 检查主从延迟
SHOW SLAVE STATUS\G
-- 重点关注：Seconds_Behind_Master

-- 检查连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW VARIABLES LIKE 'max_connections';

-- 检查查询统计
SHOW STATUS LIKE 'Queries';
SHOW STATUS LIKE 'Slow_queries';

-- 检查锁等待
SHOW STATUS LIKE 'Table_locks_waited';
SHOW STATUS LIKE 'Innodb_row_lock_waits';
```

**系统资源监控**：
```bash
# CPU使用率
top -p $(pgrep mysqld)

# 内存使用
free -h
cat /proc/meminfo

# 磁盘IO
iostat -x 1 5
iotop

# 网络状况  
iftop
nethogs
```

### 11.3 性能优化方案


#### 🎯 MySQL参数优化


```sql
-- 调整缓冲区大小
SET GLOBAL innodb_buffer_pool_size = 2147483648;  -- 2GB

-- 调整日志缓冲区
SET GLOBAL innodb_log_buffer_size = 67108864;     -- 64MB

-- 调整连接相关参数
SET GLOBAL max_connections = 200;
SET GLOBAL thread_cache_size = 16;

-- 调整查询缓存
SET GLOBAL query_cache_size = 134217728;          -- 128MB
SET GLOBAL query_cache_type = 1;
```

**持久化配置**：
```ini
[mysqld]
# 缓冲区设置
innodb_buffer_pool_size = 2G
innodb_log_buffer_size = 64M

# 连接设置
max_connections = 200
thread_cache_size = 16

# 查询缓存
query_cache_size = 128M
query_cache_type = 1

# IO优化
innodb_flush_log_at_trx_commit = 2
sync_binlog = 0
```

#### 📊 复制优化


```sql
-- 并行复制设置
SET GLOBAL slave_parallel_workers = 4;
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';

-- 调整复制缓冲区
SET GLOBAL slave_pending_jobs_size_max = 134217728;

-- 跳过某些事件以提高速度
SET GLOBAL slave_skip_errors = 1007,1008,1050,1396;
```

#### 🔧 系统级优化


```bash
# 调整文件描述符限制
echo "mysql soft nofile 65535" >> /etc/security/limits.conf
echo "mysql hard nofile 65535" >> /etc/security/limits.conf

# 调整内核参数
echo "net.core.rmem_default = 262144" >> /etc/sysctl.conf
echo "net.core.rmem_max = 16777216" >> /etc/sysctl.conf
sysctl -p

# 磁盘调度算法优化
echo deadline > /sys/block/sda/queue/scheduler
```

---

## 12. 📋 核心要点总结


### 12.1 必须掌握的故障处理技能


```
🔸 SSH连接问题：密钥认证、权限设置、防火墙配置
🔸 复制中断：状态检查、权限修复、重新同步
🔸 权限错误：MySQL权限、文件权限、系统权限
🔸 网络故障：连通性测试、超时调整、防火墙配置
🔸 磁盘空间：监控清理、自动化管理、预防措施
🔸 配置错误：语法检查、参数验证、配置备份
🔸 脚本失败：权限检查、依赖验证、手动测试
🔸 VIP漂移：网络配置、ARP广播、脚本优化
🔸 数据不一致：一致性检查、同步修复、监控预防
🔸 性能问题：指标监控、参数优化、系统调优
```

### 12.2 故障处理最佳实践


**🔹 预防为主**：
- 建立完善的监控体系
- 定期检查系统状态
- 做好配置备份
- 制定标准操作流程

**🔹 快速响应**：
- 建立故障响应流程
- 准备常用排查命令
- 维护故障处理文档
- 定期进行故障演练

**🔹 详细记录**：
- 记录故障现象和处理过程
- 分析故障根本原因
- 总结经验教训
- 更新处理文档

### 12.3 故障处理工具箱


**📋 常用检查命令**：
```bash
# SSH连接检查
ssh -v user@host
telnet host 22

# MySQL连接检查  
mysql -h host -u user -p -e "SELECT 1"
mysqladmin -h host -u user -p ping

# 网络检查
ping host
traceroute host
mtr host

# 磁盘检查
df -h
du -sh directory

# 进程检查
ps aux | grep mysql
systemctl status mysqld
```

**🔧 故障恢复脚本模板**：
```bash
#!/bin/bash
# MHA故障快速检查脚本

echo "=== MHA环境快速检查 ==="

# 检查SSH连接
for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
    echo "检查SSH连接: $host"
    ssh -o ConnectTimeout=5 mysql@$host "echo 'SSH连接正常'" || echo "SSH连接失败"
done

# 检查MySQL服务
for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
    echo "检查MySQL服务: $host"  
    mysql -h $host -u mha -p$password -e "SELECT 1" 2>/dev/null && echo "MySQL连接正常" || echo "MySQL连接失败"
done

# 检查复制状态
echo "检查主从复制状态"
mysql -h 192.168.1.11 -u mha -p$password -e "SHOW SLAVE STATUS\G" | grep -E "(Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master)"

echo "=== 检查完成 ==="
```

### 12.4 应急处理流程


**💡 故障处理步骤**：
1. **快速评估**：确定故障影响范围和严重程度
2. **紧急止损**：采取措施防止故障扩大
3. **问题定位**：使用工具和日志找出根本原因
4. **实施修复**：按照标准流程进行修复
5. **验证恢复**：确认服务恢复正常
6. **总结改进**：记录经验，优化预防措施

**⚠️ 注意事项**：
- 修复前一定要备份重要数据
- 在测试环境验证修复方案
- 保持与相关人员的沟通
- 详细记录每个操作步骤

**核心记忆口诀**：
- 故障不慌张，按步骤排查
- SSH网络先检查，权限配置要规范  
- 复制中断找原因，数据一致是关键
- 日志监控做到位，预防胜过治疗法