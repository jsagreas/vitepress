---
title: 7、MHA Node安装配置
---
## 📚 目录

1. [MHA Node概述](#1-MHA-Node概述)
2. [安装前准备工作](#2-安装前准备工作)
3. [依赖包安装](#3-依赖包安装)
4. [MHA Node安装](#4-MHA-Node安装)
5. [安装验证](#5-安装验证)
6. [权限配置](#6-权限配置)
7. [目录结构说明](#7-目录结构说明)
8. [故障排查](#8-故障排查)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔧 MHA Node概述


### 1.1 什么是MHA Node


**MHA Node** 就是运行在**每台MySQL服务器上的客户端工具**，可以理解为MHA系统的"手脚"。

```
简单理解：
MHA Manager = 大脑（决策中心）
MHA Node    = 手脚（执行工具）

大脑发出指令 → 手脚执行操作
```

### 1.2 MHA Node的作用


**🎯 核心功能**：
- **监控MySQL状态**：实时检测MySQL服务是否正常
- **执行故障切换**：当主库故障时执行具体的切换操作
- **数据恢复**：进行binlog应用和数据一致性保证
- **SSH通信**：与MHA Manager进行通信协调

**💡 工作原理**：
```
正常情况：
MHA Manager ←→ MHA Node(Master)
            ←→ MHA Node(Slave1) 
            ←→ MHA Node(Slave2)

故障情况：
MHA Manager 发现Master故障
         ↓
指挥各个Node执行切换
         ↓
Node们协作完成故障转移
```

### 1.3 安装位置


**📍 安装规则**：
- **每台MySQL服务器**都必须安装MHA Node
- **MHA Manager服务器**也要安装MHA Node（因为Manager可能也是MySQL服务器）
- **所有参与MHA的服务器**都需要安装

```
典型部署架构：

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Master        │    │   Slave1        │    │   Slave2        │
│   MySQL         │    │   MySQL         │    │   MySQL         │
│   MHA Node ✓    │    │   MHA Node ✓    │    │   MHA Node ✓    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │  MHA Manager    │
                    │  MHA Node ✓     │
                    └─────────────────┘
```

---

## 2. 📋 安装前准备工作


### 2.1 系统环境检查


**🔍 环境要求**：
- **操作系统**：CentOS 7/8、RHEL 7/8、Ubuntu 18.04+
- **Perl版本**：5.8.1+（MHA Node是Perl编写的）
- **MySQL版本**：5.6+、8.0+
- **网络连通性**：所有节点间可以SSH互通

**检查命令**：
```bash
# 检查操作系统版本
cat /etc/os-release

# 检查Perl版本
perl --version

# 检查MySQL版本
mysql --version

# 检查网络连通性（在每台机器上执行）
ping 其他机器IP
```

### 2.2 主机规划


**🏗️ 示例环境**：
```
主机规划：
192.168.1.100  mysql-master   （主库）
192.168.1.101  mysql-slave1   （从库1）
192.168.1.102  mysql-slave2   （从库2）
192.168.1.103  mha-manager    （管理节点）

所有机器都需要安装MHA Node！
```

### 2.3 SSH无密码登录配置


**🔑 为什么需要SSH免密**：
- MHA Manager需要在各个MySQL服务器上执行命令
- 故障切换时需要快速执行，不能手动输入密码
- 各个MySQL服务器之间也需要相互通信

**配置步骤**：
```bash
# 1. 在MHA Manager上生成密钥对
ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ""

# 2. 复制公钥到所有MySQL服务器
ssh-copy-id root@192.168.1.100
ssh-copy-id root@192.168.1.101  
ssh-copy-id root@192.168.1.102

# 3. 测试免密登录
ssh root@192.168.1.100 "hostname"
ssh root@192.168.1.101 "hostname"
ssh root@192.168.1.102 "hostname"
```

---

## 3. 📦 依赖包安装


### 3.1 基础依赖包


**MHA Node需要的Perl模块**：

```bash
# CentOS/RHEL系统
yum install -y perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch
yum install -y perl-Parallel-ForkManager perl-ExtUtils-CBuilder
yum install -y perl-ExtUtils-MakeMaker perl-CPAN

# Ubuntu/Debian系统  
apt-get install -y libdbd-mysql-perl libconfig-tiny-perl
apt-get install -y liblog-dispatch-perl libparallel-forkmanager-perl
```

### 3.2 依赖关系说明


**🔗 各依赖包的作用**：

| 依赖包 | **作用说明** |
|--------|-------------|
| `perl-DBD-MySQL` | **MySQL数据库连接驱动**，让Perl可以连接MySQL |
| `perl-Config-Tiny` | **配置文件解析模块**，读取MHA配置文件 |
| `perl-Log-Dispatch` | **日志处理模块**，记录MHA运行日志 |
| `perl-Parallel-ForkManager` | **并行处理模块**，支持多进程操作 |

### 3.3 检查依赖是否安装成功


```bash
# 检查Perl模块是否正确安装
perl -MDBD::mysql -e "print 'DBD::mysql is installed\n'"
perl -MConfig::Tiny -e "print 'Config::Tiny is installed\n'"
perl -MLog::Dispatch -e "print 'Log::Dispatch is installed\n'"

# 如果没有报错，说明依赖安装成功
```

---

## 4. 🚀 MHA Node安装


### 4.1 下载MHA Node安装包


**📥 获取安装包**：
```bash
# 方法1：从官方GitHub下载
cd /tmp
wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58.tar.gz

# 方法2：如果网络不好，可以先下载到本地再上传
# 下载地址：https://github.com/yoshinorim/mha4mysql-node/releases
```

### 4.2 编译安装MHA Node


**🔧 安装步骤**：
```bash
# 1. 解压安装包
cd /tmp
tar -zxf mha4mysql-node-0.58.tar.gz
cd mha4mysql-node-0.58

# 2. 编译安装
perl Makefile.PL
make
make install

# 安装完成后会看到类似输出：
# Installing /usr/local/bin/save_binary_logs
# Installing /usr/local/bin/apply_diff_relay_logs
# Installing /usr/local/bin/filter_mysqlbinlog
# Installing /usr/local/bin/purge_relay_logs
```

### 4.3 RPM包安装方式


**如果有RPM包，可以直接安装**：
```bash
# 下载RPM包
wget https://github.com/yoshinorim/mha4mysql-node/releases/download/v0.58/mha4mysql-node-0.58-0.el7.noarch.rpm

# 安装RPM包
rpm -ivh mha4mysql-node-0.58-0.el7.noarch.rpm

# 或者使用yum安装
yum localinstall mha4mysql-node-0.58-0.el7.noarch.rpm
```

### 4.4 验证安装是否成功


```bash
# 检查MHA Node工具是否安装成功
which save_binary_logs
which apply_diff_relay_logs
which filter_mysqlbinlog
which purge_relay_logs

# 应该显示类似：
# /usr/local/bin/save_binary_logs
# /usr/local/bin/apply_diff_relay_logs
# /usr/local/bin/filter_mysqlbinlog
# /usr/local/bin/purge_relay_logs
```

---

## 5. ✅ 安装验证


### 5.1 工具功能测试


**🧪 测试各个工具是否正常**：

```bash
# 1. 测试save_binary_logs
save_binary_logs --help

# 2. 测试apply_diff_relay_logs  
apply_diff_relay_logs --help

# 3. 测试filter_mysqlbinlog
filter_mysqlbinlog --help

# 4. 测试purge_relay_logs
purge_relay_logs --help

# 如果都能正常显示帮助信息，说明安装成功
```

### 5.2 MySQL连接测试


**🔌 测试MHA Node是否能连接MySQL**：

```bash
# 在MySQL服务器上测试本地连接
mysql -uroot -p -e "SELECT VERSION();"

# 测试从MHA Manager连接各个MySQL服务器
# （这个测试在安装MHA Manager后进行）
```

### 5.3 SSH连接测试


```bash
# 在MHA Manager上测试到各MySQL服务器的SSH连接
ssh mysql-master "which save_binary_logs"
ssh mysql-slave1 "which save_binary_logs"  
ssh mysql-slave2 "which save_binary_logs"

# 应该都能返回工具路径，说明安装和SSH都正常
```

---

## 6. 🔐 权限配置


### 6.1 文件权限设置


**📁 重要文件权限**：
```bash
# 设置MHA Node工具的执行权限
chmod +x /usr/local/bin/save_binary_logs
chmod +x /usr/local/bin/apply_diff_relay_logs
chmod +x /usr/local/bin/filter_mysqlbinlog
chmod +x /usr/local/bin/purge_relay_logs

# 检查权限
ls -l /usr/local/bin/{save_binary_logs,apply_diff_relay_logs,filter_mysqlbinlog,purge_relay_logs}
```

### 6.2 MySQL用户权限


**👤 MHA需要的MySQL权限**：
```sql
-- 在MySQL中创建MHA专用用户
CREATE USER 'mha'@'%' IDENTIFIED BY 'mha123456';

-- 授予必要权限
GRANT ALL PRIVILEGES ON *.* TO 'mha'@'%';
GRANT SUPER, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'mha'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

**🔍 权限说明**：
- **SUPER**：执行管理操作，如设置只读模式
- **REPLICATION SLAVE**：读取binlog进行复制
- **REPLICATION CLIENT**：获取复制状态信息
- **ALL PRIVILEGES**：执行故障转移时的各种操作

### 6.3 系统用户权限


```bash
# MHA通常使用root用户运行，确保root可以：
# 1. 执行MHA Node工具
# 2. 读写MySQL的binlog文件
# 3. SSH到其他服务器

# 检查MySQL数据目录权限
ls -l /var/lib/mysql/

# 如果权限不够，调整权限
chown -R mysql:mysql /var/lib/mysql/
```

---

## 7. 📂 目录结构说明


### 7.1 安装目录结构


**🗂️ MHA Node安装后的目录结构**：

```
/usr/local/bin/                 ← 二进制工具目录
├── save_binary_logs            ← 保存binlog工具
├── apply_diff_relay_logs       ← 应用relay log差异工具  
├── filter_mysqlbinlog          ← 过滤binlog工具
└── purge_relay_logs           ← 清理relay log工具

/usr/local/share/perl5/         ← Perl模块目录
└── MHA/
    └── NodeUtil.pm            ← MHA Node核心模块

/usr/local/man/                 ← 帮助文档目录
└── man1/
    ├── save_binary_logs.1
    ├── apply_diff_relay_logs.1
    ├── filter_mysqlbinlog.1
    └── purge_relay_logs.1
```

### 7.2 各工具的作用


**🔧 二进制工具详解**：

| 工具名称 | **主要功能** | **使用场景** |
|---------|-------------|-------------|
| `save_binary_logs` | **保存主库的binlog文件** | 故障切换时保存最新的binlog |
| `apply_diff_relay_logs` | **应用relay log差异** | 让从库数据保持一致 |
| `filter_mysqlbinlog` | **过滤binlog内容** | 去除不需要的binlog事件 |
| `purge_relay_logs` | **清理relay log** | 避免磁盘空间不足 |

### 7.3 日志文件位置


```bash
# MHA Node运行时的日志位置（由MHA Manager配置决定）
/var/log/mha/                   ← 通常的日志目录
├── app1.log                    ← MHA应用日志
└── app1_error.log             ← 错误日志

# MySQL的相关日志
/var/log/mysql/                 
├── error.log                   ← MySQL错误日志
└── slow.log                   ← 慢查询日志
```

---

## 8. 🔧 故障排查


### 8.1 常见安装问题


**❌ 问题1：Perl模块缺失**
```bash
# 错误信息：
Can't locate DBD/mysql.pm in @INC

# 解决方法：
yum install -y perl-DBD-MySQL
# 或
cpan install DBD::mysql
```

**❌ 问题2：编译失败**
```bash
# 错误信息：
Can't locate ExtUtils/MakeMaker.pm

# 解决方法：
yum install -y perl-ExtUtils-MakeMaker perl-CPAN
```

**❌ 问题3：权限不足**
```bash
# 错误信息：
Permission denied

# 解决方法：
# 使用sudo或root用户安装
sudo make install
```

### 8.2 连接问题排查


**🔍 SSH连接问题**：
```bash
# 检查SSH服务状态
systemctl status sshd

# 检查防火墙设置
firewall-cmd --list-all

# 测试SSH连接
ssh -v root@target_host

# 检查SSH密钥
cat ~/.ssh/authorized_keys
```

**🔍 MySQL连接问题**：
```bash
# 检查MySQL服务状态
systemctl status mysqld

# 检查MySQL端口
netstat -tulpn | grep 3306

# 测试MySQL连接
mysql -h target_host -u mha -p -e "SELECT 1;"
```

### 8.3 版本兼容性问题


**📋 版本对应关系**：

| MySQL版本 | **推荐MHA Node版本** | **兼容性** |
|----------|-------------------|----------|
| MySQL 5.6 | MHA Node 0.56+ | ✅ 完全兼容 |
| MySQL 5.7 | MHA Node 0.57+ | ✅ 完全兼容 |
| MySQL 8.0 | MHA Node 0.58+ | ✅ 需要最新版本 |

> 💡 **建议**：使用最新版本的MHA Node可以获得最好的兼容性和稳定性

### 8.4 卸载和清理


**🗑️ 完全卸载MHA Node**：
```bash
# 1. 删除二进制文件
rm -f /usr/local/bin/save_binary_logs
rm -f /usr/local/bin/apply_diff_relay_logs
rm -f /usr/local/bin/filter_mysqlbinlog
rm -f /usr/local/bin/purge_relay_logs

# 2. 删除Perl模块
rm -rf /usr/local/share/perl5/MHA/

# 3. 删除帮助文档
rm -f /usr/local/man/man1/save_binary_logs.1
rm -f /usr/local/man/man1/apply_diff_relay_logs.1
rm -f /usr/local/man/man1/filter_mysqlbinlog.1
rm -f /usr/local/man/man1/purge_relay_logs.1

# 4. 清理配置和日志（可选）
rm -rf /etc/mha/
rm -rf /var/log/mha/
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 MHA Node本质：运行在每台MySQL服务器上的客户端工具
🔸 安装位置：所有参与MHA的MySQL服务器都必须安装
🔸 核心功能：监控状态、执行切换、数据恢复、SSH通信
🔸 依赖关系：需要Perl环境和相关模块支持
🔸 权限要求：需要MySQL管理权限和系统文件访问权限
```

### 9.2 关键理解要点


**🔹 MHA Node的角色定位**
```
理解要点：
- MHA Node是"执行者"，MHA Manager是"指挥者"
- 每台MySQL服务器上的Node负责本地操作
- 所有Node协作完成整个故障转移过程
```

**🔹 安装的重要性**
```
为什么每台机器都要安装：
- 故障可能发生在任何一台MySQL服务器上
- 每台机器都可能成为新的主库
- 数据一致性需要所有节点参与
```

**🔹 依赖关系的必要性**
```
各种依赖的作用：
- Perl模块：MHA Node是用Perl编写的
- MySQL驱动：需要连接和操作MySQL
- SSH免密：故障切换时需要快速执行命令
```

### 9.3 实际运维要点


**🎯 安装检查清单**
- [ ] 所有MySQL服务器都安装了MHA Node
- [ ] Perl依赖模块全部安装成功  
- [ ] SSH免密登录配置完成
- [ ] MySQL用户权限设置正确
- [ ] 网络连通性测试通过
- [ ] 工具执行权限设置正确

**🎯 故障预防**
- 定期检查MHA Node工具是否正常
- 监控磁盘空间，避免日志文件过大
- 定期测试SSH连接和MySQL连接
- 保持MHA Node版本与MySQL版本兼容

**核心记忆**：
- MHA Node是每台MySQL服务器的必装工具
- 安装简单但依赖关系要处理好
- SSH免密和MySQL权限是关键配置
- 安装完成要做充分的验证测试