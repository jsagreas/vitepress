---
title: 4、MySQL主从复制配置
---
## 📚 目录

1. [主从复制基本概念](#1-主从复制基本概念)
2. [主库配置详解](#2-主库配置详解)
3. [从库配置详解](#3-从库配置详解)
4. [复制用户创建与授权](#4-复制用户创建与授权)
5. [建立主从连接](#5-建立主从连接)
6. [复制状态监控](#6-复制状态监控)
7. [常见故障排查](#7-常见故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 主从复制基本概念


### 1.1 什么是主从复制


**🔸 简单理解**
```
主从复制就像"老师讲课，学生做笔记"：
- 主库（Master）= 老师，负责处理写操作
- 从库（Slave）= 学生，负责复制主库的数据
- binlog = 老师的讲课录音，记录所有操作
- relay log = 学生的听课笔记，暂存要执行的操作
```

**🔸 工作原理图示**
```
主库(Master)                          从库(Slave)
    ↓                                    ↑
写操作 → binlog日志                   relay log → 执行SQL
         ↓                              ↑
    IO线程读取 ←────网络传输────→ IO线程接收
                                       ↓
                                   SQL线程执行
```

### 1.2 复制的核心作用


**📈 主要用途**
- **读写分离**：主库写，从库读，分担压力
- **数据备份**：从库作为热备，防止数据丢失  
- **高可用**：主库故障时，从库可以顶上
- **负载均衡**：多个从库分担读请求

**⚡ 复制过程三步骤**
```
步骤1️⃣：主库记录变更到binlog（二进制日志）
步骤2️⃣：从库IO线程读取主库binlog，写入relay log
步骤3️⃣：从库SQL线程读取relay log，执行SQL语句
```

---

## 2. 🔧 主库配置详解


### 2.1 server_id设置


**🔸 什么是server_id**
```
server_id就像身份证号码，每个MySQL实例都要有唯一的ID
- 主库和从库的server_id必须不同
- 通常主库设为1，从库设为2、3、4...
- 取值范围：1 到 4294967295
```

**配置示例**
```ini
# 主库配置文件 /etc/my.cnf
[mysqld]
server_id = 1        # 主库ID设为1
```

### 2.2 binlog配置详解


**🔸 binlog是什么**
```
binlog（二进制日志）= 数据库的"行车记录仪"
- 记录所有对数据库的修改操作（INSERT、UPDATE、DELETE等）
- 从库通过读取binlog来同步数据
- 也是数据恢复的重要工具
```

**核心binlog参数**
```ini
# 启用binlog
log_bin = mysql-bin                    # binlog文件名前缀

# binlog格式（重要！）
binlog_format = ROW                    # 推荐使用ROW格式

# binlog过期时间
expire_logs_days = 7                   # 7天后自动删除旧binlog

# 每个binlog文件大小
max_binlog_size = 100M                 # 单个文件最大100MB
```

**🔍 binlog格式对比**
| 格式 | **特点** | **优缺点** |
|------|----------|-----------|
| `ROW` | 记录每行的具体变化 | ✅精确，❌文件大 |
| `STATEMENT` | 记录原始SQL语句 | ✅文件小，❌可能不一致 |
| `MIXED` | 智能混合模式 | ✅平衡，❌复杂 |

> 💡 **推荐使用ROW格式**：虽然binlog文件会大一些，但能确保主从数据完全一致

### 2.3 主库完整配置


```ini
# /etc/my.cnf 主库配置
[mysqld]
# 基本设置
server_id = 1
port = 3306

# binlog配置
log_bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# 复制相关
sync_binlog = 1                        # 每次提交事务都同步binlog到磁盘
binlog_cache_size = 1M                 # binlog缓存大小

# 其他推荐设置
innodb_flush_log_at_trx_commit = 1     # 事务安全
read_only = 0                          # 主库允许写入
```

---

## 3. ⚙️ 从库配置详解


### 3.1 从库server_id设置


```ini
# 从库配置文件 /etc/my.cnf
[mysqld]
server_id = 2        # 从库ID，必须与主库不同
```

### 3.2 relay log配置


**🔸 relay log是什么**
```
relay log（中继日志）= 从库的"待办事项清单"
- 从库IO线程从主库读取binlog，写入relay log
- 从库SQL线程读取relay log，执行SQL语句
- 就像一个中转站，缓存要执行的操作
```

**relay log配置**
```ini
# relay log设置
relay_log = relay-bin                  # relay log文件名前缀
relay_log_index = relay-bin.index      # 索引文件
max_relay_log_size = 100M              # 单个relay log最大大小

# 自动清理relay log
relay_log_purge = 1                    # 执行完成后自动删除
```

### 3.3 从库安全设置


```ini
# 从库安全配置
read_only = 1                          # 从库只读（防止误写）
skip_slave_start = 1                   # 启动时不自动开始复制
```

> ⚠️ **重要提醒**：`read_only=1`只对普通用户生效，root用户仍可写入

### 3.4 从库完整配置


```ini
# /etc/my.cnf 从库配置
[mysqld]
# 基本设置
server_id = 2
port = 3306

# relay log配置
relay_log = relay-bin
relay_log_index = relay-bin.index
max_relay_log_size = 100M
relay_log_purge = 1

# 安全设置
read_only = 1
skip_slave_start = 1

# 复制相关
slave_net_timeout = 60                 # 网络超时时间
slave_skip_errors = 1062,1032         # 跳过特定错误（谨慎使用）
```

---

## 4. 👤 复制用户创建与授权


### 4.1 为什么需要复制用户


**🔸 专用账户的作用**
```
就像给快递员单独配钥匙：
- 从库需要连接主库读取binlog
- 不能用root账户（安全风险大）
- 创建专门的复制账户，只给必要权限
```

### 4.2 在主库创建复制用户


```sql
-- 在主库执行，创建复制用户
CREATE USER 'repl_user'@'从库IP地址' IDENTIFIED BY 'StrongPassword123!';

-- 授予复制权限
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'从库IP地址';

-- 刷新权限
FLUSH PRIVILEGES;
```

**🔍 权限说明**
- `REPLICATION SLAVE`：允许读取主库的binlog
- `从库IP地址`：可以用具体IP或'%'（任意IP，但不安全）

**实际例子**
```sql
-- 假设从库IP是192.168.1.102
CREATE USER 'repl_user'@'192.168.1.102' IDENTIFIED BY 'ReplicationPass2024!';
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'192.168.1.102';
FLUSH PRIVILEGES;

-- 验证用户创建成功
SELECT user, host FROM mysql.user WHERE user = 'repl_user';
```

---

## 5. 🔗 建立主从连接


### 5.1 获取主库状态


**在主库执行**
```sql
-- 查看主库当前状态（重要！）
SHOW MASTER STATUS;
```

**输出示例**
```
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |      154 |              |                  |
+------------------+----------+--------------+------------------+
```

> 📝 **记住这两个值**：
> - `File`: mysql-bin.000001（当前binlog文件）
> - `Position`: 154（当前位置）

### 5.2 配置从库连接


**🔸 CHANGE MASTER TO命令详解**
```sql
-- 在从库执行，配置主库连接信息
CHANGE MASTER TO
  MASTER_HOST='主库IP地址',           -- 主库地址
  MASTER_PORT=3306,                  -- 主库端口
  MASTER_USER='repl_user',           -- 复制用户名
  MASTER_PASSWORD='密码',            -- 复制用户密码
  MASTER_LOG_FILE='mysql-bin.000001', -- 主库binlog文件
  MASTER_LOG_POS=154;                -- 主库binlog位置
```

**实际操作示例**
```sql
-- 假设主库IP是192.168.1.101
CHANGE MASTER TO
  MASTER_HOST='192.168.1.101',
  MASTER_PORT=3306,
  MASTER_USER='repl_user',
  MASTER_PASSWORD='ReplicationPass2024!',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154;
```

### 5.3 启动从库复制


```sql
-- 启动复制进程
START SLAVE;

-- 查看复制状态
SHOW SLAVE STATUS\G
```

**🔍 状态检查重点**
```
关键指标：
- Slave_IO_Running: Yes     # IO线程运行正常
- Slave_SQL_Running: Yes    # SQL线程运行正常
- Seconds_Behind_Master: 0  # 延迟秒数（越小越好）
- Last_Error: （空）        # 无错误信息
```

---

## 6. 📊 复制状态监控


### 6.1 关键监控命令


**主库监控**
```sql
-- 查看主库状态
SHOW MASTER STATUS;

-- 查看连接的从库
SHOW PROCESSLIST;
```

**从库监控**
```sql
-- 查看从库详细状态
SHOW SLAVE STATUS\G

-- 简化状态检查
SELECT 
  SLAVE_IO_RUNNING,
  SLAVE_SQL_RUNNING,
  SECONDS_BEHIND_MASTER,
  LAST_ERROR
FROM performance_schema.replication_connection_status
JOIN performance_schema.replication_applier_status;
```

### 6.2 健康状态判断


**✅ 复制正常的标志**
```
1. Slave_IO_Running: Yes
2. Slave_SQL_Running: Yes  
3. Seconds_Behind_Master: 0或很小的数字
4. Last_IO_Error: （空）
5. Last_SQL_Error: （空）
```

**⚠️ 需要注意的指标**
```
延迟监控：
- Seconds_Behind_Master < 5秒：优秀
- 5-30秒：可接受
- >30秒：需要优化

位置监控：
- Read_Master_Log_Pos：从主库读取的位置
- Exec_Master_Log_Pos：在从库执行的位置
- 两者接近表示延迟低
```

---

## 7. 🚨 常见故障排查


### 7.1 连接问题排查


**故障现象**：`Slave_IO_Running: No`

```sql
-- 查看详细错误
SHOW SLAVE STATUS\G

-- 常见错误原因：
```

**📋 排查清单**
```
1. 网络连通性检查：
   ping 主库IP地址
   telnet 主库IP 3306

2. 用户权限检查：
   从库能否用复制用户连接主库
   mysql -h主库IP -u repl_user -p

3. 防火墙检查：
   主库3306端口是否开放
   iptables -L | grep 3306

4. binlog文件检查：
   主库binlog文件是否存在
   SHOW BINARY LOGS;
```

### 7.2 SQL执行错误


**故障现象**：`Slave_SQL_Running: No`

**常见错误类型**
```
错误1062：主键冲突
- 原因：从库有重复数据
- 解决：删除冲突数据或跳过该错误

错误1032：找不到要更新的行  
- 原因：从库缺少对应数据
- 解决：手动插入缺失数据

错误1146：表不存在
- 原因：从库缺少对应表
- 解决：创建缺失的表
```

**应急处理**
```sql
-- 跳过一个错误（谨慎使用！）
STOP SLAVE;
SET GLOBAL SQL_SLAVE_SKIP_COUNTER = 1;
START SLAVE;

-- 重置复制（重新开始）
STOP SLAVE;
RESET SLAVE;
-- 然后重新执行CHANGE MASTER TO
```

### 7.3 延迟问题处理


**延迟原因分析**
```
网络原因：
- 网络带宽不足
- 网络延迟高
- 丢包严重

硬件原因：
- 从库IO性能差
- 内存不足
- CPU负载高

配置原因：
- binlog格式不当
- 缓冲区设置过小
- 并行复制未开启
```

**优化建议**
```sql
-- 开启并行复制（MySQL 5.7+）
SET GLOBAL slave_parallel_workers = 4;
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';

-- 调整缓冲区
SET GLOBAL relay_log_space_limit = 500M;
SET GLOBAL slave_pending_jobs_size_max = 100M;
```

---

## 8. 📋 核心要点总结


### 8.1 配置要点回顾


**🔸 主库必配参数**
```ini
server_id = 1                 # 唯一ID
log_bin = mysql-bin          # 开启binlog
binlog_format = ROW          # 使用ROW格式
sync_binlog = 1              # 安全同步
```

**🔸 从库必配参数**  
```ini
server_id = 2                # 不同于主库的ID
read_only = 1               # 只读保护
skip_slave_start = 1        # 手动启动复制
relay_log = relay-bin       # 中继日志
```

### 8.2 操作步骤记忆


**📝 配置流程**
```
1️⃣ 配置主库：server_id + binlog
2️⃣ 配置从库：server_id + relay_log + 只读
3️⃣ 创建复制用户：REPLICATION SLAVE权限
4️⃣ 获取主库状态：SHOW MASTER STATUS
5️⃣ 连接主从：CHANGE MASTER TO
6️⃣ 启动复制：START SLAVE
7️⃣ 检查状态：SHOW SLAVE STATUS
```

### 8.3 监控要点


**🔍 日常检查指标**
- `Slave_IO_Running = Yes`：IO线程正常
- `Slave_SQL_Running = Yes`：SQL线程正常  
- `Seconds_Behind_Master < 5`：延迟可控
- `Last_Error 为空`：无错误

### 8.4 故障处理原则


> ⚠️ **安全第一**：
> - 修复前先备份数据
> - 跳过错误要谨慎，可能导致数据不一致
> - 重大问题建议重新搭建主从关系

**🔧 故障处理思路**
```
1. 查看错误日志，确定具体原因
2. 检查网络连通性和权限
3. 验证配置文件参数  
4. 必要时重新初始化复制
5. 建立监控，预防再次发生
```

**核心记忆**：
- 主从复制 = 主库写binlog，从库读取并执行
- server_id必须唯一，binlog格式推荐ROW
- 复制用户只给REPLICATION SLAVE权限
- 监控重点：两个线程都要Running，延迟要控制
- 故障排查：先看日志，再查网络，最后查配置