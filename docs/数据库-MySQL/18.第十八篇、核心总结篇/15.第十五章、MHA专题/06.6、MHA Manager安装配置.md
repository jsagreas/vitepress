---
title: 6ã€MHA Managerå®‰è£…é…ç½®
---
## ğŸ“š ç›®å½•

1. [MHA Manageræ¦‚è¿°](#1-mha-manageræ¦‚è¿°)
2. [å®‰è£…å‰å‡†å¤‡å·¥ä½œ](#2-å®‰è£…å‰å‡†å¤‡å·¥ä½œ)
3. [ä¾èµ–åŒ…å®‰è£…é…ç½®](#3-ä¾èµ–åŒ…å®‰è£…é…ç½®)
4. [MHA Manageræ ¸å¿ƒå®‰è£…](#4-mha-manageræ ¸å¿ƒå®‰è£…)
5. [é…ç½®æ–‡ä»¶è¯¦è§£](#5-é…ç½®æ–‡ä»¶è¯¦è§£)
6. [æœåŠ¡ç®¡ç†ä¸å¯åŠ¨](#6-æœåŠ¡ç®¡ç†ä¸å¯åŠ¨)
7. [æ—¥å¿—ç®¡ç†é…ç½®](#7-æ—¥å¿—ç®¡ç†é…ç½®)
8. [ç‰ˆæœ¬å‡çº§ç­–ç•¥](#8-ç‰ˆæœ¬å‡çº§ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ MHA Manageræ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHA Manager


**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
```
MHA Manager = MySQLé«˜å¯ç”¨æ¶æ„çš„ç®¡ç†èŠ‚ç‚¹
ä½œç”¨ï¼šç›‘æ§MySQLä¸»ä»å¤åˆ¶é›†ç¾¤ï¼Œè‡ªåŠ¨å¤„ç†ä¸»åº“æ•…éšœåˆ‡æ¢
ä½ç½®ï¼šç‹¬ç«‹æœåŠ¡å™¨ï¼Œä¸ä¸MySQLæ•°æ®åº“æœåŠ¡å™¨æ··éƒ¨
```

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸ªå·¥å‚çš„ç”Ÿäº§çº¿ï¼ŒMHA Managerå°±åƒæ˜¯**æ€»è°ƒåº¦å‘˜**ï¼š
- **ç›‘æ§å·¥äºº**ï¼šå®æ—¶æ£€æŸ¥æ¯ä¸ªMySQLæœåŠ¡å™¨çš„å¥åº·çŠ¶æ€
- **åº”æ€¥æŒ‡æŒ¥**ï¼šä¸»åº“å‡ºé—®é¢˜æ—¶ï¼Œç«‹å³æŒ‡æŒ¥ä»åº“æ¥ç®¡å·¥ä½œ
- **æµç¨‹åè°ƒ**ï¼šç¡®ä¿åˆ‡æ¢è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸¢å¤±ã€æœåŠ¡ä¸ä¸­æ–­

### 1.2 Manageråœ¨MHAæ¶æ„ä¸­çš„è§’è‰²


```
MHAé«˜å¯ç”¨æ¶æ„å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç›‘æ§    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MHA Manager   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   MySQL Master  â”‚
â”‚   (ç®¡ç†èŠ‚ç‚¹)     â”‚            â”‚   (ä¸»æ•°æ®åº“)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â”‚                              â”‚ å¤åˆ¶
         â–¼ ç®¡ç†                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MHA Node      â”‚            â”‚   MySQL Slave1  â”‚
â”‚   (ä»£ç†èŠ‚ç‚¹)     â”‚            â”‚   (ä»æ•°æ®åº“1)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                              â”‚
         â”‚                              â”‚ å¤åˆ¶
         â–¼ ç®¡ç†                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MHA Node      â”‚            â”‚   MySQL Slave2  â”‚
â”‚   (ä»£ç†èŠ‚ç‚¹)     â”‚            â”‚   (ä»æ•°æ®åº“2)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ Managerçš„æ ¸å¿ƒèŒè´£**
- **å¥åº·æ£€æŸ¥**ï¼šæ¯éš”å‡ ç§’æ£€æŸ¥ä¸»åº“æ˜¯å¦æ­£å¸¸
- **æ•…éšœåˆ¤æ–­**ï¼šä¸»åº“æ— å“åº”æ—¶ç¡®è®¤æ˜¯å¦çœŸçš„æ•…éšœ
- **åˆ‡æ¢å†³ç­–**ï¼šé€‰æ‹©æœ€åˆé€‚çš„ä»åº“ä½œä¸ºæ–°ä¸»åº“
- **æ•°æ®è¡¥å¿**ï¼šç¡®ä¿æ–°ä¸»åº“æ‹¥æœ‰æœ€æ–°çš„æ•°æ®
- **é…ç½®æ›´æ–°**ï¼šä¿®æ”¹åº”ç”¨ç¨‹åºçš„æ•°æ®åº“è¿æ¥é…ç½®

---

## 2. ğŸ”§ å®‰è£…å‰å‡†å¤‡å·¥ä½œ


### 2.1 æœåŠ¡å™¨ç¯å¢ƒè¦æ±‚


**ğŸ“Š ç¡¬ä»¶é…ç½®å»ºè®®**

| ç¯å¢ƒç±»å‹ | **CPU** | **å†…å­˜** | **ç£ç›˜** | **ç½‘ç»œ** |
|---------|---------|---------|---------|---------|
| `ç”Ÿäº§ç¯å¢ƒ` | `2æ ¸ä»¥ä¸Š` | `4GBä»¥ä¸Š` | `50GBä»¥ä¸Š` | `åƒå…†ç½‘å¡` |
| `æµ‹è¯•ç¯å¢ƒ` | `1æ ¸` | `2GB` | `20GB` | `ç™¾å…†ç½‘å¡` |
| `å¼€å‘ç¯å¢ƒ` | `1æ ¸` | `1GB` | `10GB` | `ç™¾å…†ç½‘å¡` |

**ğŸ”¸ æ“ä½œç³»ç»Ÿè¦æ±‚**
```bash
# æ”¯æŒçš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬
CentOS 7/8, RHEL 7/8
Ubuntu 18.04/20.04/22.04
Debian 9/10/11

# æŸ¥çœ‹å½“å‰ç³»ç»Ÿç‰ˆæœ¬
cat /etc/os-release
```

### 2.2 ç½‘ç»œç¯å¢ƒé…ç½®


**ğŸŒ ç½‘ç»œè¿é€šæ€§æ£€æŸ¥**
```bash
# æ£€æŸ¥ä¸MySQLæœåŠ¡å™¨çš„è¿é€šæ€§
ping mysql-master.example.com
ping mysql-slave1.example.com  
ping mysql-slave2.example.com

# æ£€æŸ¥SSHè¿æ¥
ssh root@mysql-master.example.com "echo 'SSHè¿æ¥æ­£å¸¸'"
ssh root@mysql-slave1.example.com "echo 'SSHè¿æ¥æ­£å¸¸'"
ssh root@mysql-slave2.example.com "echo 'SSHè¿æ¥æ­£å¸¸'"
```

**ğŸ”‘ SSHå¯†é’¥è®¤è¯è®¾ç½®**
```bash
# ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ""

# åˆ†å‘å…¬é’¥åˆ°æ‰€æœ‰MySQLæœåŠ¡å™¨
ssh-copy-id root@mysql-master.example.com
ssh-copy-id root@mysql-slave1.example.com
ssh-copy-id root@mysql-slave2.example.com

# éªŒè¯å…å¯†ç™»å½•
ssh root@mysql-master.example.com "hostname"
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆéœ€è¦SSHå…å¯†ç™»å½•ï¼Ÿ**  
> MHA Manageréœ€è¦è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ¥ç®¡ç†MySQLæœåŠ¡å™¨ï¼Œæ¯”å¦‚åœæ­¢æ•…éšœçš„ä¸»åº“ã€å¯åŠ¨æ–°çš„ä¸»åº“ç­‰ã€‚å°±åƒé¥æ§å™¨æ§åˆ¶ç”µè§†ä¸€æ ·ï¼Œéœ€è¦å»ºç«‹å¯é çš„é€šä¿¡é€šé“ã€‚

### 2.3 ç”¨æˆ·æƒé™å‡†å¤‡


**ğŸ‘¤ åˆ›å»ºMHAä¸“ç”¨ç”¨æˆ·**
```bash
# åˆ›å»ºmhaç”¨æˆ·
useradd -m -s /bin/bash mha

# è®¾ç½®å¯†ç 
passwd mha

# æ·»åŠ sudoæƒé™
echo "mha ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# åˆ‡æ¢åˆ°mhaç”¨æˆ·
su - mha
```

---

## 3. ğŸ“¦ ä¾èµ–åŒ…å®‰è£…é…ç½®


### 3.1 ç³»ç»ŸåŸºç¡€ä¾èµ–


**ğŸ”¸ CentOS/RHELç³»ç»Ÿ**
```bash
# å®‰è£…å¼€å‘å·¥å…·ç»„
yum groupinstall -y "Development Tools"

# å®‰è£…åŸºç¡€ä¾èµ–åŒ…
yum install -y \
    perl-CPAN \
    perl-DBD-MySQL \
    perl-Config-Tiny \
    perl-Log-Dispatch \
    perl-Parallel-ForkManager \
    perl-Time-HiRes \
    wget \
    git
```

**ğŸ”¸ Ubuntu/Debianç³»ç»Ÿ**
```bash
# æ›´æ–°åŒ…ç´¢å¼•
apt update

# å®‰è£…åŸºç¡€ä¾èµ–
apt install -y \
    build-essential \
    libdbd-mysql-perl \
    libconfig-tiny-perl \
    liblog-dispatch-perl \
    libparallel-forkmanager-perl \
    libtime-hires-perl \
    wget \
    git \
    perl-doc
```

### 3.2 Perlæ¨¡å—å®‰è£…è¯¦è§£


**ğŸ“‹ æ ¸å¿ƒPerlæ¨¡å—è¯´æ˜**

| æ¨¡å—åç§° | **ä½œç”¨è¯´æ˜** | **ä¸ºä»€ä¹ˆéœ€è¦** |
|---------|-------------|---------------|
| `DBD::mysql` | `MySQLæ•°æ®åº“è¿æ¥é©±åŠ¨` | `è¿æ¥å’Œæ“ä½œMySQLæ•°æ®åº“` |
| `Config::Tiny` | `é…ç½®æ–‡ä»¶è§£æ` | `è¯»å–MHAé…ç½®æ–‡ä»¶` |
| `Log::Dispatch` | `æ—¥å¿—è®°å½•ç³»ç»Ÿ` | `è®°å½•MHAè¿è¡Œæ—¥å¿—` |
| `Parallel::ForkManager` | `å¹¶è¡Œè¿›ç¨‹ç®¡ç†` | `åŒæ—¶ç›‘æ§å¤šä¸ªMySQLå®ä¾‹` |
| `Time::HiRes` | `é«˜ç²¾åº¦æ—¶é—´` | `ç²¾ç¡®çš„æ•…éšœæ£€æµ‹æ—¶é—´` |

**ğŸ”§ æ‰‹åŠ¨å®‰è£…Perlæ¨¡å—**
```bash
# å¯åŠ¨CPANäº¤äº’æ¨¡å¼
cpan

# åœ¨CPANä¸­å®‰è£…æ¨¡å—
install DBD::mysql
install Config::Tiny
install Log::Dispatch  
install Parallel::ForkManager
install Time::HiRes

# é€€å‡ºCPAN
exit
```

**âœ… éªŒè¯æ¨¡å—å®‰è£…**
```bash
# åˆ›å»ºæµ‹è¯•è„šæœ¬
cat > test_perl_modules.pl << 'EOF'
#!/usr/bin/perl
use strict;
use warnings;

my @modules = qw(
    DBD::mysql
    Config::Tiny
    Log::Dispatch
    Parallel::ForkManager
    Time::HiRes
);

foreach my $module (@modules) {
    eval "use $module";
    if ($@) {
        print "âŒ $module - å®‰è£…å¤±è´¥\n";
    } else {
        print "âœ… $module - å®‰è£…æˆåŠŸ\n";
    }
}
EOF

# è¿è¡Œæµ‹è¯•
perl test_perl_modules.pl
```

### 3.3 ä¾èµ–é—®é¢˜æ’æŸ¥


**ğŸ” å¸¸è§é—®é¢˜è§£å†³**
```bash
# é—®é¢˜1: DBD::mysqlå®‰è£…å¤±è´¥
# è§£å†³ï¼šå®‰è£…MySQLå¼€å‘åŒ…
yum install -y mysql-devel
# æˆ– Ubuntuç³»ç»Ÿ
apt install -y libmysqlclient-dev

# é—®é¢˜2: ç¼ºå°‘Cç¼–è¯‘å™¨
# è§£å†³ï¼šå®‰è£…ç¼–è¯‘å·¥å…·
yum groupinstall -y "Development Tools"
# æˆ– Ubuntuç³»ç»Ÿ  
apt install -y build-essential

# é—®é¢˜3: CPANé…ç½®é—®é¢˜
# è§£å†³ï¼šé‡æ–°é…ç½®CPAN
cpan
# åœ¨CPANä¸­æ‰§è¡Œ
o conf init
```

---

## 4. ğŸš€ MHA Manageræ ¸å¿ƒå®‰è£…


### 4.1 ä¸‹è½½MHA Manageræºç 


**ğŸ“¥ è·å–å®˜æ–¹æºç åŒ…**
```bash
# åˆ›å»ºå®‰è£…ç›®å½•
mkdir -p /opt/mha
cd /opt/mha

# ä¸‹è½½MHA Manageræºç åŒ…
wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.58/mha4mysql-manager-0.58.tar.gz

# è§£å‹æºç åŒ…
tar -zxvf mha4mysql-manager-0.58.tar.gz
cd mha4mysql-manager-0.58
```

> ğŸ“ **ç‰ˆæœ¬é€‰æ‹©è¯´æ˜**  
> v0.58æ˜¯ç›®å‰æœ€ç¨³å®šçš„ç‰ˆæœ¬ï¼Œç»è¿‡å¤§é‡ç”Ÿäº§ç¯å¢ƒéªŒè¯ã€‚æ–°ç‰ˆæœ¬è™½ç„¶åŠŸèƒ½æ›´ä¸°å¯Œï¼Œä½†å¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜ï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç¨³å®šç‰ˆæœ¬ã€‚

### 4.2 ç¼–è¯‘å®‰è£…è¿‡ç¨‹


**ğŸ”¨ æ ‡å‡†ç¼–è¯‘å®‰è£…**
```bash
# æ£€æŸ¥å®‰è£…ç¯å¢ƒ
perl Makefile.PL

# ç¼–è¯‘æºç 
make

# è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
make test

# å®‰è£…åˆ°ç³»ç»Ÿ
make install
```

**ğŸ“ å®‰è£…è·¯å¾„è¯´æ˜**
```bash
# MHA Managerå®‰è£…åçš„æ–‡ä»¶åˆ†å¸ƒ
/usr/local/bin/
â”œâ”€â”€ masterha_check_repl      # å¤åˆ¶æ£€æŸ¥å·¥å…·
â”œâ”€â”€ masterha_check_ssh       # SSHè¿æ¥æ£€æŸ¥å·¥å…·  
â”œâ”€â”€ masterha_check_status    # çŠ¶æ€æ£€æŸ¥å·¥å…·
â”œâ”€â”€ masterha_conf_host       # ä¸»æœºé…ç½®å·¥å…·
â”œâ”€â”€ masterha_manager         # æ ¸å¿ƒç®¡ç†ç¨‹åº
â”œâ”€â”€ masterha_master_monitor  # ä¸»åº“ç›‘æ§ç¨‹åº
â”œâ”€â”€ masterha_master_switch   # ä¸»åº“åˆ‡æ¢å·¥å…·
â”œâ”€â”€ masterha_secondary_check # äºŒæ¬¡æ£€æŸ¥å·¥å…·
â””â”€â”€ masterha_stop            # åœæ­¢å·¥å…·

/usr/local/share/perl5/
â””â”€â”€ MHA/                     # Perlæ¨¡å—æ–‡ä»¶
```

### 4.3 å®‰è£…éªŒè¯


**âœ… éªŒè¯å®‰è£…æˆåŠŸ**
```bash
# æ£€æŸ¥æ ¸å¿ƒå‘½ä»¤æ˜¯å¦å¯ç”¨
which masterha_manager
which masterha_check_repl
which masterha_check_ssh

# æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
masterha_manager --version

# æ£€æŸ¥å¸®åŠ©ä¿¡æ¯
masterha_manager --help
```

**ğŸ”§ åˆ›å»ºå¿…è¦ç›®å½•**
```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•
mkdir -p /etc/mha

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /var/log/mha

# åˆ›å»ºå·¥ä½œç›®å½•
mkdir -p /var/lib/mha

# è®¾ç½®ç›®å½•æƒé™
chown -R mha:mha /etc/mha /var/log/mha /var/lib/mha
chmod 755 /etc/mha /var/log/mha /var/lib/mha
```

---

## 5. âš™ï¸ é…ç½®æ–‡ä»¶è¯¦è§£


### 5.1 ä¸»é…ç½®æ–‡ä»¶ç»“æ„


**ğŸ“„ åˆ›å»ºä¸»é…ç½®æ–‡ä»¶**
```bash
# åˆ›å»ºMHAé›†ç¾¤é…ç½®æ–‡ä»¶
cat > /etc/mha/mysql_cluster.cnf << 'EOF'
[server default]
# MHA Managerå·¥ä½œç›®å½•
manager_workdir=/var/lib/mha
# MHA Manageræ—¥å¿—æ–‡ä»¶
manager_log=/var/log/mha/manager.log
# è¿œç¨‹å·¥ä½œç›®å½•
remote_workdir=/tmp

# SSHè¿æ¥é…ç½®
user=root
ssh_user=root
repl_user=replication
repl_password=replication_password

# æ•…éšœæ£€æµ‹é…ç½®
ping_interval=3
ping_type=SELECT

# äºŒæ¬¡æ£€æŸ¥ä¸»æœºï¼ˆé¿å…ç½‘ç»œåˆ†åŒºè¯¯åˆ¤ï¼‰
secondary_check_script=/usr/local/bin/masterha_secondary_check -s 192.168.1.10 -s 192.168.1.11

[server1]
hostname=mysql-master.example.com
ip=192.168.1.10
port=3306
master_binlog_dir=/var/lib/mysql

[server2]
hostname=mysql-slave1.example.com
ip=192.168.1.11
port=3306
candidate_master=1
check_repl_delay=0

[server3]
hostname=mysql-slave2.example.com
ip=192.168.1.12
port=3306
no_master=1
EOF
```

### 5.2 é…ç½®å‚æ•°è¯¦ç»†è¯´æ˜


**ğŸ”¸ å…¨å±€é…ç½®å‚æ•°**

| å‚æ•°åç§° | **å«ä¹‰è¯´æ˜** | **æ¨èå€¼** | **ä½œç”¨è§£é‡Š** |
|---------|-------------|-----------|-------------|
| `manager_workdir` | `Managerå·¥ä½œç›®å½•` | `/var/lib/mha` | `å­˜å‚¨ä¸´æ—¶æ–‡ä»¶å’ŒçŠ¶æ€ä¿¡æ¯` |
| `manager_log` | `æ—¥å¿—æ–‡ä»¶è·¯å¾„` | `/var/log/mha/manager.log` | `è®°å½•Managerè¿è¡Œæ—¥å¿—` |
| `ping_interval` | `å¥åº·æ£€æŸ¥é—´éš”(ç§’)` | `3` | `æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡ä¸»åº“çŠ¶æ€` |
| `ping_type` | `æ£€æŸ¥æ–¹å¼` | `SELECT` | `ä½¿ç”¨SQLæŸ¥è¯¢æ£€æŸ¥æ•°æ®åº“` |
| `secondary_check_script` | `äºŒæ¬¡æ£€æŸ¥è„šæœ¬` | `masterha_secondary_check` | `é˜²æ­¢ç½‘ç»œåˆ†åŒºè¯¯åˆ¤` |

**ğŸ”¸ æœåŠ¡å™¨é…ç½®å‚æ•°**

| å‚æ•°åç§° | **å«ä¹‰è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|---------|-------------|-------------|
| `candidate_master=1` | `å€™é€‰ä¸»åº“æ ‡è®°` | `ä¼˜å…ˆé€‰æ‹©æ­¤æœåŠ¡å™¨ä½œä¸ºæ–°ä¸»åº“` |
| `no_master=1` | `ç¦æ­¢ä½œä¸ºä¸»åº“` | `åªè¯»ä»åº“ï¼Œä¸å‚ä¸ä¸»åº“é€‰ä¸¾` |
| `check_repl_delay=0` | `å¿½ç•¥å¤åˆ¶å»¶è¿Ÿ` | `å³ä½¿æœ‰å»¶è¿Ÿä¹Ÿå¯æˆä¸ºä¸»åº“` |
| `master_binlog_dir` | `binlogæ–‡ä»¶ç›®å½•` | `æŒ‡å®šäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ä½ç½®` |

### 5.3 é«˜çº§é…ç½®é€‰é¡¹


**ğŸ”§ æ•…éšœåˆ‡æ¢è„šæœ¬é…ç½®**
```bash
# åˆ›å»ºæ•…éšœåˆ‡æ¢è„šæœ¬
cat > /usr/local/bin/master_ip_failover << 'EOF'
#!/usr/bin/env perl
# è¿™ä¸ªè„šæœ¬å¤„ç†VIPï¼ˆè™šæ‹ŸIPï¼‰çš„åˆ‡æ¢
use strict;
use warnings FATAL => 'all';

# VIPé…ç½®
my $vip = '192.168.1.100/24';
my $key = '1';
my $ssh_start_vip = "/sbin/ifconfig eth0:$key $vip";
my $ssh_stop_vip = "/sbin/ifconfig eth0:$key down";

# è„šæœ¬é€»è¾‘...
# ï¼ˆå®é™…ç”Ÿäº§ç¯å¢ƒéœ€è¦å®Œæ•´çš„VIPåˆ‡æ¢é€»è¾‘ï¼‰
EOF

chmod +x /usr/local/bin/master_ip_failover
```

**ğŸ“§ é‚®ä»¶é€šçŸ¥é…ç½®**
```bash
# åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é‚®ä»¶é€šçŸ¥
echo "
# é‚®ä»¶é€šçŸ¥é…ç½®
report_script=/usr/local/bin/send_report
" >> /etc/mha/mysql_cluster.cnf

# åˆ›å»ºé‚®ä»¶é€šçŸ¥è„šæœ¬
cat > /usr/local/bin/send_report << 'EOF'
#!/bin/bash
# å‘é€æ•…éšœåˆ‡æ¢é€šçŸ¥é‚®ä»¶
subject="MHAæ•…éšœåˆ‡æ¢é€šçŸ¥"
body="MySQLä¸»åº“å·²å‘ç”Ÿæ•…éšœåˆ‡æ¢ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
echo "$body" | mail -s "$subject" admin@example.com
EOF

chmod +x /usr/local/bin/send_report
```

---

## 6. ğŸ›ï¸ æœåŠ¡ç®¡ç†ä¸å¯åŠ¨


### 6.1 æ‰‹åŠ¨å¯åŠ¨æ–¹å¼


**ğŸš€ å¯åŠ¨MHA Manager**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
masterha_check_ssh --conf=/etc/mha/mysql_cluster.cnf
masterha_check_repl --conf=/etc/mha/mysql_cluster.cnf

# å¯åŠ¨MHA Managerï¼ˆå‰å°è¿è¡Œï¼‰
masterha_manager --conf=/etc/mha/mysql_cluster.cnf

# åå°è¿è¡Œæ–¹å¼
nohup masterha_manager --conf=/etc/mha/mysql_cluster.cnf > /var/log/mha/manager.log 2>&1 &
```

**ğŸ” æ£€æŸ¥è¿è¡ŒçŠ¶æ€**
```bash
# æŸ¥çœ‹MHAçŠ¶æ€
masterha_check_status --conf=/etc/mha/mysql_cluster.cnf

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
ps aux | grep masterha_manager

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/mha/manager.log
```

### 6.2 ç³»ç»ŸæœåŠ¡é…ç½®


**ğŸ“‹ åˆ›å»ºSystemdæœåŠ¡**
```bash
# åˆ›å»ºæœåŠ¡é…ç½®æ–‡ä»¶
cat > /etc/systemd/system/mha-manager.service << 'EOF'
[Unit]
Description=MHA Manager Service
After=network.target mysql.service
Wants=network.target

[Service]
Type=simple
User=mha
Group=mha
ExecStart=/usr/local/bin/masterha_manager --conf=/etc/mha/mysql_cluster.cnf --ignore_last_failover
ExecStop=/usr/local/bin/masterha_stop --conf=/etc/mha/mysql_cluster.cnf
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

**ğŸ”§ æœåŠ¡ç®¡ç†å‘½ä»¤**
```bash
# é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡
systemctl daemon-reload

# å¯åŠ¨MHAæœåŠ¡
systemctl start mha-manager

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable mha-manager

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status mha-manager

# åœæ­¢æœåŠ¡
systemctl stop mha-manager

# é‡å¯æœåŠ¡
systemctl restart mha-manager
```

### 6.3 è¿›ç¨‹ç®¡ç†å·¥å…·


**ğŸ”§ åˆ›å»ºç®¡ç†è„šæœ¬**
```bash
# åˆ›å»ºMHAç®¡ç†è„šæœ¬
cat > /usr/local/bin/mha-control << 'EOF'
#!/bin/bash

CONF_FILE="/etc/mha/mysql_cluster.cnf"
PID_FILE="/var/run/mha/manager.pid"
LOG_FILE="/var/log/mha/manager.log"

case "$1" in
    start)
        echo "å¯åŠ¨MHA Manager..."
        nohup masterha_manager --conf=$CONF_FILE --pid_file=$PID_FILE > $LOG_FILE 2>&1 &
        echo "MHA Managerå·²å¯åŠ¨"
        ;;
    stop)
        echo "åœæ­¢MHA Manager..."
        masterha_stop --conf=$CONF_FILE
        echo "MHA Managerå·²åœæ­¢"
        ;;
    status)
        masterha_check_status --conf=$CONF_FILE
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    *)
        echo "ç”¨æ³•: $0 {start|stop|status|restart}"
        exit 1
        ;;
esac
EOF

chmod +x /usr/local/bin/mha-control
```

---

## 7. ğŸ“Š æ—¥å¿—ç®¡ç†é…ç½®


### 7.1 æ—¥å¿—æ–‡ä»¶ç»“æ„


**ğŸ“ æ—¥å¿—ç›®å½•ç»„ç»‡**
```
/var/log/mha/
â”œâ”€â”€ manager.log              # ä¸»è¦è¿è¡Œæ—¥å¿—
â”œâ”€â”€ mysql_cluster.log        # é›†ç¾¤æ“ä½œæ—¥å¿—
â”œâ”€â”€ failover/               # æ•…éšœåˆ‡æ¢æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ app1.failover.complete.2024-01-15_10-30-45
â”‚   â””â”€â”€ app1.failover.error.2024-01-15_09-25-12
â””â”€â”€ archived/               # å½’æ¡£æ—¥å¿—ç›®å½•
    â”œâ”€â”€ manager.log.2024-01-14
    â””â”€â”€ manager.log.2024-01-13
```

### 7.2 æ—¥å¿—è½®è½¬é…ç½®


**ğŸ”„ é…ç½®logrotate**
```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
cat > /etc/logrotate.d/mha << 'EOF'
/var/log/mha/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 mha mha
    postrotate
        /bin/kill -HUP `cat /var/run/mha/manager.pid 2> /dev/null` 2> /dev/null || true
    endrotate
}
EOF
```

### 7.3 æ—¥å¿—åˆ†æå·¥å…·


**ğŸ” åˆ›å»ºæ—¥å¿—åˆ†æè„šæœ¬**
```bash
# åˆ›å»ºæ—¥å¿—åˆ†æå·¥å…·
cat > /usr/local/bin/mha-log-analyzer << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/mha/manager.log"

case "$1" in
    errors)
        echo "=== MHAé”™è¯¯æ—¥å¿— ==="
        grep -i "error\|failed\|exception" $LOG_FILE | tail -20
        ;;
    warnings)
        echo "=== MHAè­¦å‘Šæ—¥å¿— ==="
        grep -i "warning\|warn" $LOG_FILE | tail -20
        ;;
    failover)
        echo "=== æ•…éšœåˆ‡æ¢è®°å½• ==="
        grep -i "failover\|master_switch" $LOG_FILE | tail -10
        ;;
    status)
        echo "=== æœ€æ–°çŠ¶æ€ä¿¡æ¯ ==="
        tail -50 $LOG_FILE | grep -i "status\|health\|ping"
        ;;
    *)
        echo "ç”¨æ³•: $0 {errors|warnings|failover|status}"
        ;;
esac
EOF

chmod +x /usr/local/bin/mha-log-analyzer
```

---

## 8. ğŸ”„ ç‰ˆæœ¬å‡çº§ç­–ç•¥


### 8.1 å‡çº§å‰å‡†å¤‡


**ğŸ“‹ å‡çº§å‰æ£€æŸ¥æ¸…å•**
- [ ] å¤‡ä»½å½“å‰é…ç½®æ–‡ä»¶
- [ ] è®°å½•å½“å‰ç‰ˆæœ¬ä¿¡æ¯
- [ ] æ£€æŸ¥æ–°ç‰ˆæœ¬å…¼å®¹æ€§
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [ ] é€šçŸ¥ç›¸å…³äººå‘˜

**ğŸ’¾ é…ç½®å¤‡ä»½**
```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /backup/mha/$(date +%Y%m%d)

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp -r /etc/mha/ /backup/mha/$(date +%Y%m%d)/
cp -r /usr/local/bin/masterha_* /backup/mha/$(date +%Y%m%d)/

# è®°å½•å½“å‰ç‰ˆæœ¬
masterha_manager --version > /backup/mha/$(date +%Y%m%d)/version.txt
```

### 8.2 å‡çº§æ‰§è¡Œæ­¥éª¤


**ğŸ”§ å®‰å…¨å‡çº§æµç¨‹**
```bash
# 1. åœæ­¢MHAæœåŠ¡
systemctl stop mha-manager

# 2. ä¸‹è½½æ–°ç‰ˆæœ¬
cd /opt/mha
wget https://github.com/yoshinorim/mha4mysql-manager/releases/download/v0.59/mha4mysql-manager-0.59.tar.gz

# 3. è§£å‹å¹¶å®‰è£…
tar -zxvf mha4mysql-manager-0.59.tar.gz
cd mha4mysql-manager-0.59
perl Makefile.PL
make && make install

# 4. éªŒè¯å®‰è£…
masterha_manager --version

# 5. å¯åŠ¨æœåŠ¡
systemctl start mha-manager

# 6. æ£€æŸ¥çŠ¶æ€
masterha_check_status --conf=/etc/mha/mysql_cluster.cnf
```

### 8.3 å›æ»šæ–¹æ¡ˆ


**âª å‡çº§å¤±è´¥å›æ»š**
```bash
# 1. åœæ­¢æ–°ç‰ˆæœ¬æœåŠ¡
systemctl stop mha-manager

# 2. æ¢å¤æ—§ç‰ˆæœ¬æ–‡ä»¶
cp /backup/mha/$(date +%Y%m%d)/masterha_* /usr/local/bin/

# 3. æ¢å¤é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
cp -r /backup/mha/$(date +%Y%m%d)/mha/ /etc/

# 4. é‡å¯æœåŠ¡
systemctl start mha-manager

# 5. éªŒè¯å›æ»šæˆåŠŸ
masterha_manager --version
masterha_check_status --conf=/etc/mha/mysql_cluster.cnf
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


**ğŸ”¸ MHA Manageræœ¬è´¨**
```
MHA Manager = MySQLé›†ç¾¤çš„"å¤§è„‘"
èŒè´£ï¼šç›‘æ§ + å†³ç­– + æ‰§è¡Œ
ç›®æ ‡ï¼šè‡ªåŠ¨åŒ–æ•…éšœæ¢å¤ï¼Œæœ€å¤§åŒ–å¯ç”¨æ€§
```

**ğŸ”¸ å®‰è£…æ ¸å¿ƒè¦ç´ **
```
ğŸ”§ ä¾èµ–ç¯å¢ƒï¼šPerlæ¨¡å— + SSHå…å¯† + ç½‘ç»œè¿é€š
ğŸ“¦ æ ¸å¿ƒç»„ä»¶ï¼šmha4mysql-manageråŒ…
âš™ï¸ é…ç½®æ–‡ä»¶ï¼šé›†ç¾¤æ‹“æ‰‘ + æ•…éšœå¤„ç†ç­–ç•¥
ğŸ›ï¸ æœåŠ¡ç®¡ç†ï¼šå¯åŠ¨ + ç›‘æ§ + æ—¥å¿—
```

### 9.2 å…³é”®å‘½ä»¤é€ŸæŸ¥


| å‘½ä»¤ | **ä½œç”¨** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| `masterha_manager` | `å¯åŠ¨MHAç®¡ç†è¿›ç¨‹` | `å¼€å§‹ç›‘æ§MySQLé›†ç¾¤` |
| `masterha_check_ssh` | `æ£€æŸ¥SSHè¿æ¥` | `å®‰è£…åéªŒè¯é€šä¿¡æ­£å¸¸` |
| `masterha_check_repl` | `æ£€æŸ¥å¤åˆ¶çŠ¶æ€` | `éªŒè¯MySQLä¸»ä»å¤åˆ¶` |
| `masterha_check_status` | `æŸ¥çœ‹MHAçŠ¶æ€` | `æ—¥å¸¸çŠ¶æ€æ£€æŸ¥` |
| `masterha_stop` | `åœæ­¢MHAç®¡ç†` | `ç»´æŠ¤æ—¶åœæ­¢ç›‘æ§` |

### 9.3 å¸¸è§é—®é¢˜è§£å†³


**ğŸ”§ å®‰è£…é˜¶æ®µé—®é¢˜**
- **Perlæ¨¡å—ç¼ºå¤±** â†’ ä½¿ç”¨CPANå®‰è£…æˆ–ç³»ç»ŸåŒ…ç®¡ç†å™¨
- **ç¼–è¯‘å¤±è´¥** â†’ æ£€æŸ¥å¼€å‘å·¥å…·åŒ…å’ŒMySQLå¼€å‘åº“
- **æƒé™é—®é¢˜** â†’ ç¡®ä¿mhaç”¨æˆ·æœ‰è¶³å¤Ÿæƒé™

**ğŸ”§ è¿è¡Œé˜¶æ®µé—®é¢˜**
- **SSHè¿æ¥å¤±è´¥** â†’ æ£€æŸ¥å¯†é’¥é…ç½®å’Œç½‘ç»œè¿é€šæ€§
- **MySQLè¿æ¥å¤±è´¥** â†’ éªŒè¯æ•°æ®åº“è´¦å·å’Œæƒé™
- **æ—¥å¿—æ–‡ä»¶è¿‡å¤§** â†’ é…ç½®æ—¥å¿—è½®è½¬ç­–ç•¥

### 9.4 æœ€ä½³å®è·µå»ºè®®


**ğŸŒŸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
1. **ç‹¬ç«‹éƒ¨ç½²**ï¼šManagerå•ç‹¬éƒ¨ç½²ï¼Œä¸ä¸MySQLæ··éƒ¨
2. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥æœºåˆ¶
3. **å®šæœŸæµ‹è¯•**ï¼šæ¨¡æ‹Ÿæ•…éšœéªŒè¯åˆ‡æ¢æµç¨‹
4. **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•é…ç½®å˜æ›´å’Œæ•…éšœå¤„ç†è¿‡ç¨‹

**ğŸŒŸ æ—¥å¸¸ç»´æŠ¤è¦ç‚¹**
1. **æ—¥å¿—ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥é”™è¯¯æ—¥å¿—
2. **çŠ¶æ€æ£€æŸ¥**ï¼šæ¯æ—¥éªŒè¯MHAè¿è¡ŒçŠ¶æ€
3. **é…ç½®å¤‡ä»½**ï¼šå˜æ›´å‰å¤‡ä»½é…ç½®æ–‡ä»¶
4. **ç‰ˆæœ¬è·Ÿè¸ª**ï¼šå…³æ³¨å®‰å…¨æ›´æ–°å’Œbugä¿®å¤

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- MHA Manageræ˜¯MySQLé«˜å¯ç”¨çš„"æŒ‡æŒ¥å®˜"
- å®‰è£…æˆåŠŸçš„å…³é”®æ˜¯ä¾èµ–åŒ…å®Œæ•´
- é…ç½®æ–‡ä»¶å®šä¹‰äº†æ•´ä¸ªé›†ç¾¤çš„è¡Œä¸º
- æœåŠ¡åŒ–ç®¡ç†è®©è¿ç»´æ›´åŠ ä¾¿æ·
- æ—¥å¿—æ˜¯æ’æŸ¥é—®é¢˜çš„é‡è¦çº¿ç´¢