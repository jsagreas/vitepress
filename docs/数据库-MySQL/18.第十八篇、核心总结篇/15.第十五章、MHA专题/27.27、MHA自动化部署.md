---
title: 27ã€MHAè‡ªåŠ¨åŒ–éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [MHAè‡ªåŠ¨åŒ–éƒ¨ç½²æ¦‚è¿°](#1-MHAè‡ªåŠ¨åŒ–éƒ¨ç½²æ¦‚è¿°)
2. [Ansibleè‡ªåŠ¨åŒ–åŸºç¡€](#2-Ansibleè‡ªåŠ¨åŒ–åŸºç¡€)
3. [éƒ¨ç½²è„šæœ¬ç¼–å†™](#3-éƒ¨ç½²è„šæœ¬ç¼–å†™)
4. [é…ç½®æ¨¡æ¿ç®¡ç†](#4-é…ç½®æ¨¡æ¿ç®¡ç†)
5. [æ‰¹é‡éƒ¨ç½²å®æ–½](#5-æ‰¹é‡éƒ¨ç½²å®æ–½)
6. [ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–](#6-ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–)
7. [é…ç½®æ–‡ä»¶ç”Ÿæˆä¸æœåŠ¡å¯åŠ¨](#7-é…ç½®æ–‡ä»¶ç”Ÿæˆä¸æœåŠ¡å¯åŠ¨)
8. [éƒ¨ç½²éªŒè¯ä¸å›æ»šæœºåˆ¶](#8-éƒ¨ç½²éªŒè¯ä¸å›æ»šæœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ MHAè‡ªåŠ¨åŒ–éƒ¨ç½²æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHAè‡ªåŠ¨åŒ–éƒ¨ç½²


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
MHAè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼šé€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·æ‰¹é‡éƒ¨ç½²MHAé›†ç¾¤çš„æ–¹æ³•
ç›®æ ‡ï¼šå‡å°‘äººå·¥æ“ä½œï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼Œé™ä½å‡ºé”™ç‡
æ ¸å¿ƒç†å¿µï¼šä¸€æ¬¡ç¼–å†™ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œæ ‡å‡†åŒ–éƒ¨ç½²
```

MHAè‡ªåŠ¨åŒ–éƒ¨ç½²å°±åƒ**å·¥å‚æµæ°´çº¿**ä¸€æ ·ï¼ŒæŠŠå¤æ‚çš„æ‰‹å·¥éƒ¨ç½²è¿‡ç¨‹å˜æˆæ ‡å‡†åŒ–çš„è‡ªåŠ¨æµç¨‹ã€‚

### 1.2 è‡ªåŠ¨åŒ–éƒ¨ç½²çš„ä»·å€¼


**ä¼ ç»Ÿæ‰‹å·¥éƒ¨ç½²é—®é¢˜ï¼š**
```
âŒ è€—æ—¶é•¿ï¼šå•ä¸ªèŠ‚ç‚¹éƒ¨ç½²éœ€è¦1-2å°æ—¶
âŒ æ˜“å‡ºé”™ï¼šé…ç½®æ–‡ä»¶æ‰‹å†™å®¹æ˜“é”™è¯¯
âŒ ä¸ä¸€è‡´ï¼šä¸åŒç¯å¢ƒé…ç½®å·®å¼‚å¤§  
âŒ éš¾ç»´æŠ¤ï¼šç¼ºä¹æ ‡å‡†åŒ–æµç¨‹
âŒ æ— æ³•æ‰¹é‡ï¼šæ— æ³•åŒæ—¶éƒ¨ç½²å¤šå¥—ç¯å¢ƒ
```

**è‡ªåŠ¨åŒ–éƒ¨ç½²ä¼˜åŠ¿ï¼š**
```
âœ… å¿«é€Ÿï¼šæ•´å¥—ç¯å¢ƒ30åˆ†é’Ÿå†…å®Œæˆ
âœ… å‡†ç¡®ï¼šæ¨¡æ¿åŒ–é…ç½®é¿å…äººä¸ºé”™è¯¯
âœ… æ ‡å‡†ï¼šæ‰€æœ‰ç¯å¢ƒä½¿ç”¨ç›¸åŒæ ‡å‡†
âœ… å¯é‡å¤ï¼šéšæ—¶å¯ä»¥é‡æ–°éƒ¨ç½²
âœ… å¯æ‰©å±•ï¼šæ”¯æŒå¤§è§„æ¨¡æ‰¹é‡éƒ¨ç½²
```

### 1.3 è‡ªåŠ¨åŒ–éƒ¨ç½²æ¶æ„å›¾


```
éƒ¨ç½²æ§åˆ¶æœº                     ç›®æ ‡æœåŠ¡å™¨é›†ç¾¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ansible    â”‚               â”‚  MySQL Master           â”‚
â”‚  æ§åˆ¶èŠ‚ç‚¹   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  192.168.1.10          â”‚
â”‚             â”‚  SSHè¿æ¥       â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                       â”‚  MySQL Slave1           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  192.168.1.11          â”‚
      â”‚                       â”‚                         â”‚
      â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                       â”‚  MySQL Slave2           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  192.168.1.12          â”‚
      â”‚                       â”‚                         â”‚
      â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                       â”‚  MHA Manager            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  192.168.1.20          â”‚
                              â”‚                         â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ› ï¸ Ansibleè‡ªåŠ¨åŒ–åŸºç¡€


### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©Ansible


**Ansibleç®€ä»‹**
```
å®šä¹‰ï¼šåŸºäºPythonçš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·
ç‰¹ç‚¹ï¼šæ— å®¢æˆ·ç«¯(Agentless)ã€åŸºäºSSHã€å£°æ˜å¼é…ç½®
ä¼˜åŠ¿ï¼šå­¦ä¹ æˆæœ¬ä½ã€åŠŸèƒ½å¼ºå¤§ã€ç¤¾åŒºæ´»è·ƒ
```

**Ansible vs å…¶ä»–å·¥å…·å¯¹æ¯”**

| å·¥å…· | **å®¢æˆ·ç«¯** | **å­¦ä¹ éš¾åº¦** | **é€‚ç”¨åœºæ™¯** | **MHAéƒ¨ç½²é€‚é…æ€§** |
|------|------------|--------------|--------------|-------------------|
| **Ansible** | `æ— éœ€å®‰è£…` | `ç®€å•` | `ä¸­å°è§„æ¨¡` | `â­â­â­â­â­` |
| **Puppet** | `éœ€è¦Agent` | `å¤æ‚` | `å¤§è§„æ¨¡ä¼ä¸š` | `â­â­â­` |
| **Chef** | `éœ€è¦Agent` | `å¤æ‚` | `å¤§è§„æ¨¡ä¼ä¸š` | `â­â­â­` |
| **SaltStack** | `éœ€è¦Agent` | `ä¸­ç­‰` | `å¤§è§„æ¨¡é›†ç¾¤` | `â­â­â­â­` |

### 2.2 Ansibleæ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ ¸å¿ƒç»„ä»¶è§£é‡Š**
```
Inventoryï¼ˆæ¸…å•ï¼‰ï¼šå®šä¹‰è¦ç®¡ç†çš„æœåŠ¡å™¨åˆ—è¡¨
Playbookï¼ˆå‰§æœ¬ï¼‰ï¼šå®šä¹‰å…·ä½“çš„æ‰§è¡Œä»»åŠ¡
Taskï¼ˆä»»åŠ¡ï¼‰ï¼šå…·ä½“çš„æ“ä½œæ­¥éª¤
Moduleï¼ˆæ¨¡å—ï¼‰ï¼šæ‰§è¡Œä»»åŠ¡çš„å·¥å…·
Templateï¼ˆæ¨¡æ¿ï¼‰ï¼šé…ç½®æ–‡ä»¶æ¨¡æ¿
```

**ç®€å•ç±»æ¯”ç†è§£**
- **Inventory** = é€šè®¯å½•ï¼ˆè®°å½•æ‰€æœ‰æœåŠ¡å™¨ä¿¡æ¯ï¼‰
- **Playbook** = èœè°±ï¼ˆè¯¦ç»†çš„æ“ä½œæ­¥éª¤ï¼‰  
- **Task** = èœè°±ä¸­çš„æ¯ä¸€æ­¥ï¼ˆåˆ‡èœã€ç‚’èœç­‰ï¼‰
- **Module** = å¨å…·ï¼ˆåˆ€ã€é”…ã€é“²å­ç­‰å·¥å…·ï¼‰
- **Template** = æ ‡å‡†åŒ–é£Ÿè°±ï¼ˆå¯é‡å¤ä½¿ç”¨çš„æ¨¡æ¿ï¼‰

### 2.3 Ansibleç¯å¢ƒå‡†å¤‡


**æ§åˆ¶èŠ‚ç‚¹å®‰è£…**
```bash
# CentOS/RHEL å®‰è£…
yum install -y epel-release
yum install -y ansible

# Ubuntu å®‰è£…  
apt update
apt install -y ansible

# éªŒè¯å®‰è£…
ansible --version
```

**SSHå…å¯†ç™»å½•é…ç½®**
```bash
# ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ""

# åˆ†å‘å…¬é’¥åˆ°æ‰€æœ‰ç›®æ ‡æœåŠ¡å™¨
for ip in 192.168.1.10 192.168.1.11 192.168.1.12 192.168.1.20; do
    ssh-copy-id root@$ip
done

# æµ‹è¯•è¿æ¥
ansible all -m ping -i inventory
```

---

## 3. ğŸ“ éƒ¨ç½²è„šæœ¬ç¼–å†™


### 3.1 Inventoryæ¸…å•æ–‡ä»¶


**ğŸ”¸ ä¸»æœºæ¸…å•ç»“æ„**
```ini
# inventory/hosts.ini
[mysql_masters]
mysql-master ansible_host=192.168.1.10 server_id=1 role=master

[mysql_slaves]  
mysql-slave1 ansible_host=192.168.1.11 server_id=2 role=slave
mysql-slave2 ansible_host=192.168.1.12 server_id=3 role=slave

[mha_managers]
mha-manager ansible_host=192.168.1.20

[mysql_cluster:children]
mysql_masters
mysql_slaves

[all:vars]
# MySQLåŸºç¡€é…ç½®
mysql_version=8.0.35
mysql_root_password=SecurePass123!
mysql_data_dir=/var/lib/mysql
mysql_log_dir=/var/log/mysql

# MHAé…ç½®
mha_version=0.58
mha_user=mha
mha_password=MhaPass123!
mha_work_dir=/var/log/masterha

# ç½‘ç»œé…ç½®
repl_user=repl
repl_password=ReplPass123!
```

### 3.2 ä¸»Playbookæ–‡ä»¶


**ğŸ”¸ æ ¸å¿ƒéƒ¨ç½²æµç¨‹**
```yaml
# deploy-mha.yml
---
- name: "éƒ¨ç½²MHAé«˜å¯ç”¨é›†ç¾¤"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "æ˜¾ç¤ºéƒ¨ç½²å¼€å§‹ä¿¡æ¯"
      debug:
        msg: "å¼€å§‹éƒ¨ç½²MHAé›†ç¾¤ - {{ ansible_date_time.iso8601 }}"

# ç¬¬ä¸€é˜¶æ®µï¼šç¯å¢ƒåˆå§‹åŒ–
- import_playbook: playbooks/01-prepare-environment.yml
- import_playbook: playbooks/02-install-dependencies.yml

# ç¬¬äºŒé˜¶æ®µï¼šMySQLå®‰è£…é…ç½®  
- import_playbook: playbooks/03-install-mysql.yml
- import_playbook: playbooks/04-configure-replication.yml

# ç¬¬ä¸‰é˜¶æ®µï¼šMHAå®‰è£…é…ç½®
- import_playbook: playbooks/05-install-mha.yml  
- import_playbook: playbooks/06-configure-mha.yml

# ç¬¬å››é˜¶æ®µï¼šéªŒè¯éƒ¨ç½²
- import_playbook: playbooks/07-verify-deployment.yml

- name: "éƒ¨ç½²å®Œæˆæ€»ç»“"
  hosts: localhost
  gather_facts: false
  tasks:
    - name: "æ˜¾ç¤ºéƒ¨ç½²å®Œæˆä¿¡æ¯"  
      debug:
        msg: 
          - "âœ… MHAé›†ç¾¤éƒ¨ç½²å®Œæˆï¼"
          - "ğŸ” è¯·æ£€æŸ¥éªŒè¯ç»“æœ"
          - "ğŸ“ éƒ¨ç½²æ—¶é—´ï¼š{{ ansible_date_time.iso8601 }}"
```

### 3.3 åˆ†æ¨¡å—Playbookç¤ºä¾‹


**ç¯å¢ƒå‡†å¤‡æ¨¡å—**
```yaml
# playbooks/01-prepare-environment.yml  
---
- name: "ç¯å¢ƒåˆå§‹åŒ–"
  hosts: all
  become: yes
  tasks:
    - name: "è®¾ç½®ä¸»æœºå"
      hostname:
        name: "{{ inventory_hostname }}"
        
    - name: "é…ç½®hostsæ–‡ä»¶"
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_host }} {{ item }}"
        state: present
      loop: "{{ groups['all'] }}"
      
    - name: "å…³é—­SELinux"
      selinux:
        state: disabled
      when: ansible_os_family == "RedHat"
      
    - name: "å…³é—­é˜²ç«å¢™"
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: false
      loop:
        - firewalld
        - iptables
      ignore_errors: yes
      
    - name: "é…ç½®æ—¶é—´åŒæ­¥"
      yum:
        name: chrony
        state: present
      when: ansible_os_family == "RedHat"
```

---

## 4. ğŸ“„ é…ç½®æ¨¡æ¿ç®¡ç†


### 4.1 MySQLé…ç½®æ¨¡æ¿


**ğŸ”¸ MySQLä¸»ä»é…ç½®æ¨¡æ¿**
```ini
# templates/mysql/my.cnf.j2
[mysqld]
# åŸºç¡€é…ç½®
user = mysql
port = 3306
basedir = /usr/local/mysql
datadir = {{ mysql_data_dir }}
socket = /tmp/mysql.sock
pid-file = /var/run/mysqld/mysqld.pid

# æœåŠ¡å™¨IDé…ç½®(æ¯å°æœåŠ¡å™¨ä¸åŒ)
server-id = {{ server_id }}

# äºŒè¿›åˆ¶æ—¥å¿—é…ç½®
log-bin = mysql-bin
binlog-format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# ä¸»ä»å¤åˆ¶é…ç½®
{% if role == 'master' %}
# ä¸»åº“ç‰¹æœ‰é…ç½®
log-slave-updates = 1
auto_increment_increment = 2
auto_increment_offset = 1
{% else %}
# ä»åº“ç‰¹æœ‰é…ç½®  
read_only = 1
log_slave_updates = 1
relay_log = relay-bin
relay_log_index = relay-bin.index
{% endif %}

# æ€§èƒ½ä¼˜åŒ–é…ç½®
innodb_buffer_pool_size = {{ ansible_memtotal_mb // 2 }}M
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 1
sync_binlog = 1

# è¿æ¥é…ç½®
max_connections = 1000
max_connect_errors = 100000

# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

[client]
default-character-set = utf8mb4
socket = /tmp/mysql.sock
```

### 4.2 MHAé…ç½®æ¨¡æ¿


**ğŸ”¸ MHAç®¡ç†é…ç½®æ¨¡æ¿**
```ini
# templates/mha/mha.cnf.j2
[server default]
# MHAç®¡ç†ç”¨æˆ·
user={{ mha_user }}
password={{ mha_password }}
ssh_user=root

# å¤åˆ¶ç”¨æˆ·
repl_user={{ repl_user }}  
repl_password={{ repl_password }}

# å·¥ä½œç›®å½•
manager_workdir={{ mha_work_dir }}/{{ cluster_name }}
manager_log={{ mha_work_dir }}/{{ cluster_name }}/manager.log
remote_workdir=/tmp

# æ•…éšœè½¬ç§»è„šæœ¬
master_ip_failover_script=/usr/local/bin/master_ip_failover
shutdown_script=""

# é‚®ä»¶é€šçŸ¥
report_script=/usr/local/bin/send_report

# æ£€æŸ¥é—´éš”
ping_interval=3
ping_type=SELECT

# ä»åº“é…ç½®
{% for host in groups['mysql_slaves'] %}
[server{{ loop.index + 1 }}]
hostname={{ hostvars[host].ansible_host }}
port=3306
{% endfor %}

# ä¸»åº“é…ç½®
[server1]  
hostname={{ hostvars[groups['mysql_masters'][0]].ansible_host }}
port=3306
candidate_master=1
check_repl_delay=0
```

### 4.3 æ•…éšœè½¬ç§»è„šæœ¬æ¨¡æ¿


**ğŸ”¸ VIPæ¼‚ç§»è„šæœ¬**
```bash
# templates/scripts/master_ip_failover.j2
#!/usr/bin/env perl
use strict;
use warnings FATAL => 'all';
use Getopt::Long;

my (
    $command,        $ssh_user,      $orig_master_host,
    $orig_master_ip, $orig_master_port, $new_master_host,
    $new_master_ip,  $new_master_port
);

# VIPé…ç½®
my $vip = '{{ virtual_ip }}';
my $interface = '{{ network_interface }}';

GetOptions(
    'command=s'          => \$command,
    'ssh_user=s'         => \$ssh_user,
    'orig_master_host=s' => \$orig_master_host,
    'orig_master_ip=s'   => \$orig_master_ip,
    'orig_master_port=i' => \$orig_master_port,
    'new_master_host=s'  => \$new_master_host,
    'new_master_ip=s'    => \$new_master_ip,
    'new_master_port=i'  => \$new_master_port,
);

if ( $command eq "stop" || $command eq "stopssh" ) {
    # åœæ­¢åŸä¸»åº“VIP
    my $exit_code = 1;
    eval {
        print "ç§»é™¤VIP $vip ä» $orig_master_host($orig_master_ip)\n";
        &stop_vip();
        $exit_code = 0;
    };
    if ($@) {
        warn $@;
        exit $exit_code;
    }
    exit $exit_code;
}
elsif ( $command eq "start" ) {
    # å¯åŠ¨æ–°ä¸»åº“VIP
    my $exit_code = 10;
    eval {
        print "æ·»åŠ VIP $vip åˆ° $new_master_host($new_master_ip)\n";
        &start_vip();
        $exit_code = 0;
    };
    if ($@) {
        warn $@;
        exit $exit_code;  
    }
    exit $exit_code;
}

sub start_vip() {
    `ssh $ssh_user\@$new_master_ip \" ip addr add $vip/24 dev $interface \"`;
}

sub stop_vip() {
    `ssh $ssh_user\@$orig_master_ip \" ip addr del $vip/24 dev $interface \"`;
}
```

---

## 5. ğŸš€ æ‰¹é‡éƒ¨ç½²å®æ–½


### 5.1 éƒ¨ç½²å‰æ£€æŸ¥


**ğŸ”¸ ç¯å¢ƒæ£€æŸ¥è„šæœ¬**
```yaml
# playbooks/pre-check.yml
---
- name: "éƒ¨ç½²å‰ç¯å¢ƒæ£€æŸ¥"
  hosts: all
  gather_facts: yes
  tasks:
    - name: "æ£€æŸ¥æ“ä½œç³»ç»Ÿç‰ˆæœ¬"
      assert:
        that:
          - ansible_os_family == "RedHat"
          - ansible_distribution_major_version|int >= 7
        fail_msg: "ä»…æ”¯æŒCentOS/RHEL 7.xåŠä»¥ä¸Šç‰ˆæœ¬"
        
    - name: "æ£€æŸ¥å†…å­˜å¤§å°"  
      assert:
        that:
          - ansible_memtotal_mb >= 2048
        fail_msg: "å†…å­˜è‡³å°‘éœ€è¦2GB"
        
    - name: "æ£€æŸ¥ç£ç›˜ç©ºé—´"
      assert:
        that:
          - item.size_available > 10000000000  # 10GB
        fail_msg: "ç£ç›˜å¯ç”¨ç©ºé—´è‡³å°‘éœ€è¦10GB"
      loop: "{{ ansible_mounts }}"
      when: item.mount == "/"
      
    - name: "æ£€æŸ¥ç½‘ç»œè¿é€šæ€§"
      wait_for:
        host: "{{ item }}"
        port: 22
        timeout: 10
      loop: "{{ groups['all'] }}"
      delegate_to: localhost
```

### 5.2 æ‰¹é‡éƒ¨ç½²å‘½ä»¤


**ğŸ”¸ å®Œæ•´éƒ¨ç½²æµç¨‹**
```bash
#!/bin/bash
# deploy.sh - MHAæ‰¹é‡éƒ¨ç½²è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"  
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥Ansibleæ˜¯å¦å®‰è£…
check_ansible() {
    if ! command -v ansible &> /dev/null; then
        log_error "Ansibleæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Ansible"
        exit 1
    fi
    log_info "Ansibleæ£€æŸ¥é€šè¿‡"
}

# æ£€æŸ¥SSHè¿æ¥
check_ssh() {
    log_info "æ£€æŸ¥SSHè¿æ¥..."
    if ansible all -m ping -i inventory/hosts.ini > /dev/null 2>&1; then
        log_info "SSHè¿æ¥æ£€æŸ¥é€šè¿‡"
    else
        log_error "SSHè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥å…å¯†ç™»å½•é…ç½®"
        exit 1
    fi
}

# æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥
pre_check() {
    log_info "æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥..."
    ansible-playbook -i inventory/hosts.ini playbooks/pre-check.yml
    if [ $? -eq 0 ]; then
        log_info "éƒ¨ç½²å‰æ£€æŸ¥é€šè¿‡"
    else
        log_error "éƒ¨ç½²å‰æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
}

# æ‰§è¡Œä¸»éƒ¨ç½²
main_deploy() {
    log_info "å¼€å§‹ä¸»éƒ¨ç½²æµç¨‹..."
    ansible-playbook -i inventory/hosts.ini deploy-mha.yml
    if [ $? -eq 0 ]; then
        log_info "MHAéƒ¨ç½²å®Œæˆ"
    else
        log_error "MHAéƒ¨ç½²å¤±è´¥"
        exit 1
    fi
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹MHAè‡ªåŠ¨åŒ–éƒ¨ç½²"
    
    check_ansible
    check_ssh  
    pre_check
    main_deploy
    
    log_info "ğŸ‰ MHAé›†ç¾¤éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
    log_info "ğŸ“‹ è¯·æŸ¥çœ‹éƒ¨ç½²éªŒè¯ç»“æœ"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 5.3 å¹¶è¡Œéƒ¨ç½²ä¼˜åŒ–


**ğŸ”¸ Ansibleå¹¶è¡Œé…ç½®**
```ini
# ansible.cfg
[defaults]
host_key_checking = False
forks = 10                    # å¹¶è¡Œæ‰§è¡Œä»»åŠ¡æ•°
gathering = smart             # æ™ºèƒ½factæ”¶é›†
fact_caching = jsonfile       # factç¼“å­˜
fact_caching_connection = /tmp/ansible_fact_cache
fact_caching_timeout = 3600   # ç¼“å­˜1å°æ—¶

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s
pipelining = True             # SSHç®¡é“åŒ–
control_path = /tmp/ansible-ssh-%%h-%%p-%%r
```

**åˆ†ç»„å¹¶è¡Œéƒ¨ç½²ç­–ç•¥**
```yaml
# ç­–ç•¥ï¼šå…ˆéƒ¨ç½²MySQLï¼Œå†éƒ¨ç½²MHA
- name: "MySQLèŠ‚ç‚¹å¹¶è¡Œéƒ¨ç½²"
  hosts: mysql_cluster
  strategy: free              # è‡ªç”±ç­–ç•¥ï¼Œå„èŠ‚ç‚¹ç‹¬ç«‹æ‰§è¡Œ
  serial: "100%"              # æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶æ‰§è¡Œ
  
- name: "MHAç®¡ç†èŠ‚ç‚¹éƒ¨ç½²"  
  hosts: mha_managers
  serial: 1                   # ä¸²è¡Œæ‰§è¡Œï¼Œç¡®ä¿ç¨³å®š
```

---

## 6. ğŸ”§ ç¯å¢ƒåˆå§‹åŒ–ä¸ä¾èµ–


### 6.1 ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–


**ğŸ”¸ åŸºç¡€ç¯å¢ƒé…ç½®**
```yaml
# playbooks/02-install-dependencies.yml
---
- name: "å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…"
  hosts: all
  become: yes
  tasks:
    - name: "å®‰è£…åŸºç¡€å·¥å…·åŒ…"
      yum:
        name:
          - wget
          - curl  
          - vim
          - net-tools
          - lsof
          - telnet
          - tree
          - htop
        state: present
        
    - name: "å®‰è£…ç¼–è¯‘å·¥å…·"
      yum:
        name:
          - gcc
          - gcc-c++
          - make
          - cmake
          - automake
          - autoconf
          - libtool
        state: present
        
    - name: "å®‰è£…MySQLä¾èµ–"
      yum:
        name:
          - libaio
          - libaio-devel
          - numactl
          - numactl-devel
        state: present

    - name: "å®‰è£…Perlæ¨¡å—(MHAä¾èµ–)"
      yum:
        name:
          - perl-DBD-MySQL
          - perl-Config-Tiny
          - perl-Log-Dispatch
          - perl-Parallel-ForkManager
          - perl-ExtUtils-CBuilder
          - perl-ExtUtils-MakeMaker
          - perl-CPAN
        state: present
```

### 6.2 ç”¨æˆ·å’Œç›®å½•åˆ›å»º


**ğŸ”¸ åˆ›å»ºå¿…è¦çš„ç”¨æˆ·å’Œç›®å½•**
```yaml
- name: "åˆ›å»ºMySQLç”¨æˆ·"
  user:
    name: mysql
    system: yes
    shell: /sbin/nologin
    home: /var/lib/mysql
    create_home: no
    
- name: "åˆ›å»ºMHAç”¨æˆ·"
  user:
    name: "{{ mha_user }}"
    system: yes
    shell: /bin/bash
    groups: mysql
    append: yes
    
- name: "åˆ›å»ºå¿…è¦ç›®å½•"
  file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'
  loop:
    - "{{ mysql_data_dir }}"
    - "{{ mysql_log_dir }}"
    - /usr/local/mysql
    - /etc/mysql
    
- name: "åˆ›å»ºMHAå·¥ä½œç›®å½•"
  file:
    path: "{{ item }}"
    state: directory  
    owner: "{{ mha_user }}"
    group: "{{ mha_user }}"
    mode: '0755'
  loop:
    - "{{ mha_work_dir }}"
    - /usr/local/mha
```

### 6.3 ä¾èµ–åŒ…å®‰è£…ç­–ç•¥


**ä¾èµ–å®‰è£…ä¼˜å…ˆçº§**
```
â‘ ç³»ç»ŸåŸºç¡€åŒ… â†’ â‘¡ç¼–è¯‘å·¥å…· â†’ â‘¢MySQLä¾èµ– â†’ â‘£Perlæ¨¡å— â†’ â‘¤MHAä¾èµ–
```

**ğŸ”¸ åˆ†é˜¶æ®µå®‰è£…éªŒè¯**
```yaml
- name: "éªŒè¯å…³é”®ä¾èµ–åŒ…"
  command: rpm -q {{ item }}
  register: package_check
  failed_when: package_check.rc != 0
  loop:
    - libaio
    - perl-DBD-MySQL
    - perl-Config-Tiny
    
- name: "éªŒè¯Perlæ¨¡å—"
  shell: perl -M{{ item }} -e 'print "OK\n"'
  register: perl_check
  failed_when: perl_check.rc != 0
  loop:
    - DBI
    - DBD::mysql
    - Config::Tiny
    - Log::Dispatch
```

---

## 7. âš™ï¸ é…ç½®æ–‡ä»¶ç”Ÿæˆä¸æœåŠ¡å¯åŠ¨


### 7.1 MySQLé…ç½®æ–‡ä»¶ç”Ÿæˆ


**ğŸ”¸ åŠ¨æ€é…ç½®ç”Ÿæˆ**
```yaml
- name: "ç”ŸæˆMySQLé…ç½®æ–‡ä»¶"
  template:
    src: mysql/my.cnf.j2
    dest: /etc/my.cnf
    owner: root
    group: root
    mode: '0644'
    backup: yes                    # å¤‡ä»½åŸæœ‰é…ç½®
  notify: restart mysql
  
- name: "éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•"
  shell: "mysqld --help --verbose > /dev/null"
  register: config_check
  failed_when: config_check.rc != 0
  
- name: "ç”ŸæˆMySQLå¯åŠ¨è„šæœ¬"
  template:
    src: mysql/mysqld.service.j2
    dest: /etc/systemd/system/mysqld.service
    owner: root
    group: root
    mode: '0644'
  notify: reload systemd
```

### 7.2 MHAé…ç½®æ–‡ä»¶ç”Ÿæˆ


**ğŸ”¸ é›†ç¾¤é…ç½®ç”Ÿæˆ**
```yaml
- name: "ç”ŸæˆMHAé›†ç¾¤é…ç½®"
  template:
    src: mha/mha.cnf.j2
    dest: "/etc/mha/{{ cluster_name }}.cnf"
    owner: "{{ mha_user }}"
    group: "{{ mha_user }}"
    mode: '0600'                   # æ•æ„Ÿæ–‡ä»¶æƒé™
    
- name: "ç”Ÿæˆæ•…éšœè½¬ç§»è„šæœ¬"
  template:
    src: scripts/master_ip_failover.j2
    dest: /usr/local/bin/master_ip_failover
    owner: root
    group: root
    mode: '0755'
    
- name: "ç”ŸæˆæŠ¥å‘Šè„šæœ¬"
  template:
    src: scripts/send_report.j2
    dest: /usr/local/bin/send_report  
    owner: root
    group: root
    mode: '0755'
```

### 7.3 æœåŠ¡å¯åŠ¨ä¸éªŒè¯


**ğŸ”¸ æœåŠ¡å¯åŠ¨æµç¨‹**
```yaml
# MySQLæœåŠ¡å¯åŠ¨
- name: "å¯åŠ¨MySQLæœåŠ¡"
  systemd:
    name: mysqld
    state: started
    enabled: yes
    daemon_reload: yes
  register: mysql_start_result
  
- name: "ç­‰å¾…MySQLå¯åŠ¨"
  wait_for:
    port: 3306
    host: "{{ ansible_default_ipv4.address }}"
    delay: 10
    timeout: 60
    
- name: "éªŒè¯MySQLè¿è¡ŒçŠ¶æ€"
  shell: "mysqladmin -u root ping"
  register: mysql_ping
  retries: 5
  delay: 10
  until: mysql_ping.rc == 0

# MHA ManageræœåŠ¡
- name: "å¯åŠ¨MHA Manager"
  shell: "nohup masterha_manager --conf=/etc/mha/{{ cluster_name }}.cnf > /dev/null 2>&1 &"
  args:
    creates: "{{ mha_work_dir }}/{{ cluster_name }}/manager.pid"
  when: inventory_hostname in groups['mha_managers']
  
- name: "éªŒè¯MHA ManagerçŠ¶æ€"
  shell: "masterha_check_status --conf=/etc/mha/{{ cluster_name }}.cnf"
  register: mha_status
  when: inventory_hostname in groups['mha_managers']
```

### 7.4 é…ç½®æ–‡ä»¶æ¨¡æ¿å˜é‡


**ğŸ”¸ æ¨¡æ¿å˜é‡è®¾è®¡**
```yaml
# group_vars/all.yml
cluster_name: "mha_cluster"
virtual_ip: "192.168.1.100"
network_interface: "eth0"

# MySQLç›¸å…³å˜é‡
mysql_bind_address: "{{ ansible_default_ipv4.address }}"
mysql_max_connections: 1000
mysql_innodb_buffer_pool_size: "{{ (ansible_memtotal_mb * 0.7) | int }}M"

# MHAç›¸å…³å˜é‡  
mha_check_interval: 3
mha_ping_type: "SELECT"
mha_candidate_master: "{{ 'yes' if inventory_hostname in groups['mysql_masters'] else 'no' }}"

# å®‰å…¨ç›¸å…³å˜é‡
mysql_users:
  - name: "{{ mha_user }}"
    password: "{{ mha_password }}"
    priv: "*.*:ALL"
    host: "%"
  - name: "{{ repl_user }}"
    password: "{{ repl_password }}"
    priv: "*.*:REPLICATION SLAVE"
    host: "%"
```

---

## 8. âœ… éƒ¨ç½²éªŒè¯ä¸å›æ»šæœºåˆ¶


### 8.1 éƒ¨ç½²éªŒè¯æ£€æŸ¥


**ğŸ”¸ å¤šå±‚æ¬¡éªŒè¯ç­–ç•¥**
```yaml
# playbooks/07-verify-deployment.yml
---
- name: "MHAé›†ç¾¤éƒ¨ç½²éªŒè¯"
  hosts: all
  gather_facts: no
  tasks:
    # ç¬¬ä¸€å±‚ï¼šæœåŠ¡çŠ¶æ€éªŒè¯
    - name: "éªŒè¯MySQLæœåŠ¡çŠ¶æ€"
      systemd:
        name: mysqld
      register: mysql_service
      failed_when: mysql_service.status.ActiveState != "active"
      
    # ç¬¬äºŒå±‚ï¼šè¿æ¥æ€§éªŒè¯
    - name: "éªŒè¯MySQLè¿æ¥"
      mysql_info:
        login_user: root
        login_password: "{{ mysql_root_password }}"
      register: mysql_info
      
    # ç¬¬ä¸‰å±‚ï¼šå¤åˆ¶çŠ¶æ€éªŒè¯
    - name: "æ£€æŸ¥ä¸»ä»å¤åˆ¶çŠ¶æ€"
      mysql_replication:
        login_user: root
        login_password: "{{ mysql_root_password }}"
        mode: getslave
      register: slave_status
      when: inventory_hostname in groups['mysql_slaves']
      
    - name: "éªŒè¯å¤åˆ¶å»¶è¿Ÿ"
      assert:
        that:
          - slave_status.Seconds_Behind_Master is defined
          - slave_status.Seconds_Behind_Master|int <= 5
        fail_msg: "å¤åˆ¶å»¶è¿Ÿè¿‡å¤§: {{ slave_status.Seconds_Behind_Master }}ç§’"
      when: inventory_hostname in groups['mysql_slaves']

- name: "MHAç®¡ç†éªŒè¯"
  hosts: mha_managers
  tasks:
    # ç¬¬å››å±‚ï¼šMHAåŠŸèƒ½éªŒè¯
    - name: "æ£€æŸ¥MHAé…ç½®"
      shell: "masterha_check_conf --conf=/etc/mha/{{ cluster_name }}.cnf"
      register: mha_conf_check
      
    - name: "æ£€æŸ¥SSHè¿æ¥"
      shell: "masterha_check_ssh --conf=/etc/mha/{{ cluster_name }}.cnf"
      register: mha_ssh_check
      
    - name: "æ£€æŸ¥å¤åˆ¶çŠ¶æ€"
      shell: "masterha_check_repl --conf=/etc/mha/{{ cluster_name }}.cnf"
      register: mha_repl_check
      
    - name: "éªŒè¯MHA ManagerçŠ¶æ€"
      shell: "masterha_check_status --conf=/etc/mha/{{ cluster_name }}.cnf"
      register: mha_manager_status
      ignore_errors: yes
```

### 8.2 éªŒè¯ç»“æœæŠ¥å‘Š


**ğŸ”¸ éªŒè¯æŠ¥å‘Šç”Ÿæˆ**
```yaml
- name: "ç”ŸæˆéªŒè¯æŠ¥å‘Š"
  hosts: localhost
  tasks:
    - name: "æ”¶é›†éªŒè¯ç»“æœ"
      set_fact:
        verification_report:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          mysql_nodes: "{{ groups['mysql_cluster'] | length }}"
          mha_managers: "{{ groups['mha_managers'] | length }}"
          mysql_status: "{{ hostvars[item]['mysql_service']['status']['ActiveState'] }}"
          replication_delay: "{{ hostvars[item]['slave_status']['Seconds_Behind_Master'] | default('N/A') }}"
      loop: "{{ groups['mysql_cluster'] }}"
      
    - name: "ä¿å­˜éªŒè¯æŠ¥å‘Š"
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              MHAé›†ç¾¤éƒ¨ç½²éªŒè¯æŠ¥å‘Š
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          éƒ¨ç½²æ—¶é—´: {{ verification_report.timestamp }}
          
          ğŸ“Š é›†ç¾¤æ¦‚å†µ:
          - MySQLèŠ‚ç‚¹æ•°: {{ verification_report.mysql_nodes }}
          - MHAç®¡ç†èŠ‚ç‚¹: {{ verification_report.mha_managers }}
          
          âœ… éªŒè¯ç»“æœ:
          {% for host in groups['mysql_cluster'] %}
          - {{ host }}: {{ hostvars[host]['mysql_service']['status']['ActiveState'] | default('æœªçŸ¥') }}
          {% endfor %}
          
          ğŸ“ˆ å¤åˆ¶çŠ¶æ€:
          {% for host in groups['mysql_slaves'] %}
          - {{ host }}: å»¶è¿Ÿ {{ hostvars[host]['slave_status']['Seconds_Behind_Master'] | default('N/A') }}ç§’
          {% endfor %}
          
          ğŸ”§ MHAçŠ¶æ€:
          - é…ç½®æ£€æŸ¥: {{ hostvars[groups['mha_managers'][0]]['mha_conf_check']['rc'] == 0 | ternary('é€šè¿‡','å¤±è´¥') }}
          - SSHæ£€æŸ¥: {{ hostvars[groups['mha_managers'][0]]['mha_ssh_check']['rc'] == 0 | ternary('é€šè¿‡','å¤±è´¥') }}
          - å¤åˆ¶æ£€æŸ¥: {{ hostvars[groups['mha_managers'][0]]['mha_repl_check']['rc'] == 0 | ternary('é€šè¿‡','å¤±è´¥') }}
        dest: "./reports/mha-deployment-report-{{ ansible_date_time.epoch }}.txt"
        
    - name: "æ˜¾ç¤ºéªŒè¯æ‘˜è¦"
      debug:
        msg:
          - "ğŸ“‹ éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ"
          - "ğŸ“‚ æŠ¥å‘Šä½ç½®: ./reports/"
          - "ğŸ” è¯·æ£€æŸ¥è¯¦ç»†éªŒè¯ç»“æœ"
```

### 8.3 å›æ»šæœºåˆ¶è®¾è®¡


**ğŸ”¸ å›æ»šç­–ç•¥æ¡†æ¶**
```yaml
# playbooks/rollback.yml
---
- name: "MHAéƒ¨ç½²å›æ»š"
  hosts: all
  become: yes
  vars:
    rollback_steps:
      - "åœæ­¢MHAæœåŠ¡"
      - "åœæ­¢MySQLæœåŠ¡"  
      - "æ¢å¤é…ç½®æ–‡ä»¶"
      - "æ¸…ç†å®‰è£…æ–‡ä»¶"
      - "æ¢å¤ç³»ç»Ÿè®¾ç½®"
      
  tasks:
    - name: "ç¡®è®¤å›æ»šæ“ä½œ"
      pause:
        prompt: |
          âš ï¸  è­¦å‘Šï¼šå³å°†æ‰§è¡Œå›æ»šæ“ä½œï¼
          è¿™å°†æ¸…é™¤æ‰€æœ‰MHAå’ŒMySQLé…ç½®
          ç¡®è®¤ç»§ç»­å—ï¼Ÿ(yes/no)
      register: rollback_confirm
      when: inventory_hostname == groups['all'][0]
      
    - name: "éªŒè¯å›æ»šç¡®è®¤"
      fail:
        msg: "å›æ»šæ“ä½œå·²å–æ¶ˆ"
      when: rollback_confirm.user_input != "yes"
      
    # æ­¥éª¤1ï¼šåœæ­¢æœåŠ¡
    - name: "åœæ­¢MHA Manager"
      shell: "masterha_stop --conf=/etc/mha/{{ cluster_name }}.cnf"
      ignore_errors: yes
      when: inventory_hostname in groups['mha_managers']
      
    - name: "åœæ­¢MySQLæœåŠ¡"
      systemd:
        name: mysqld
        state: stopped
      ignore_errors: yes
      
    # æ­¥éª¤2ï¼šæ¢å¤é…ç½®
    - name: "æ¢å¤åŸå§‹é…ç½®æ–‡ä»¶"
      shell: |
        if [ -f /etc/my.cnf.ansible_backup ]; then
          mv /etc/my.cnf.ansible_backup /etc/my.cnf
        fi
      ignore_errors: yes
      
    # æ­¥éª¤3ï¼šæ¸…ç†å®‰è£…æ–‡ä»¶
    - name: "æ¸…ç†MySQLæ•°æ®ç›®å½•"
      file:
        path: "{{ mysql_data_dir }}"
        state: absent
      when: rollback_confirm.user_input == "yes"
      
    - name: "æ¸…ç†MHAé…ç½®"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/mha
        - "{{ mha_work_dir }}"
        - /usr/local/mha
      when: inventory_hostname in groups['mha_managers']
      
    # æ­¥éª¤4ï¼šæ¸…ç†ç”¨æˆ·
    - name: "åˆ é™¤åˆ›å»ºçš„ç”¨æˆ·"
      user:
        name: "{{ item }}"
        state: absent
        remove: yes
      loop:
        - mysql
        - "{{ mha_user }}"
      ignore_errors: yes
```

### 8.4 éƒ¨ç½²å¤±è´¥å¤„ç†


**ğŸ”¸ å¤±è´¥æ¢å¤æœºåˆ¶**
```yaml
# handlers/main.yml  
---
- name: "éƒ¨ç½²å¤±è´¥å¤„ç†"
  block:
    - name: "æ”¶é›†é”™è¯¯ä¿¡æ¯"
      setup:
      register: error_facts
      
    - name: "ç”Ÿæˆé”™è¯¯æŠ¥å‘Š"
      copy:
        content: |
          âŒ MHAéƒ¨ç½²å¤±è´¥æŠ¥å‘Š
          å¤±è´¥æ—¶é—´: {{ ansible_date_time.iso8601 }}
          å¤±è´¥èŠ‚ç‚¹: {{ inventory_hostname }}
          é”™è¯¯ä¿¡æ¯: {{ ansible_failed_result.msg | default('æœªçŸ¥é”™è¯¯') }}
          
          ğŸ” ç³»ç»Ÿä¿¡æ¯:
          - æ“ä½œç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          - å†…å­˜: {{ ansible_memtotal_mb }}MB
          - ç£ç›˜: {{ ansible_mounts | map(attribute='size_available') | list }}
          
          ğŸ“ å»ºè®®æ“ä½œ:
          1. æ£€æŸ¥é”™è¯¯ä¿¡æ¯
          2. ä¿®å¤é—®é¢˜åé‡æ–°éƒ¨ç½²
          3. æˆ–æ‰§è¡Œå›æ»šæ“ä½œ
        dest: "/tmp/mha-deploy-error-{{ ansible_date_time.epoch }}.log"
        
    - name: "å‘é€å‘Šè­¦é€šçŸ¥"
      mail:
        to: "{{ admin_email | default('admin@company.com') }}"
        subject: "MHAéƒ¨ç½²å¤±è´¥ - {{ inventory_hostname }}"
        body: "è¯·æ£€æŸ¥èŠ‚ç‚¹ {{ inventory_hostname }} çš„éƒ¨ç½²çŠ¶æ€"
      ignore_errors: yes
  rescue:
    - name: "æ‰§è¡Œè‡ªåŠ¨å›æ»š"
      include_tasks: rollback.yml
      when: auto_rollback | default(false)
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼šé€šè¿‡å·¥å…·å‡å°‘äººå·¥æ“ä½œï¼Œæé«˜æ•ˆç‡å’Œå‡†ç¡®æ€§
ğŸ”¸ Ansibleï¼šæ— å®¢æˆ·ç«¯çš„è‡ªåŠ¨åŒ–å·¥å…·ï¼ŒåŸºäºSSHå’ŒYAMLé…ç½®
ğŸ”¸ Playbookï¼šå®šä¹‰éƒ¨ç½²ä»»åŠ¡çš„è„šæœ¬æ–‡ä»¶ï¼Œç±»ä¼¼èœè°±
ğŸ”¸ æ¨¡æ¿ï¼šå¯é‡å¤ä½¿ç”¨çš„é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼Œæ”¯æŒå˜é‡æ›¿æ¢
ğŸ”¸ æ‰¹é‡éƒ¨ç½²ï¼šåŒæ—¶éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ï¼Œæé«˜éƒ¨ç½²æ•ˆç‡
ğŸ”¸ éªŒè¯æœºåˆ¶ï¼šå¤šå±‚æ¬¡æ£€æŸ¥ç¡®ä¿éƒ¨ç½²è´¨é‡
ğŸ”¸ å›æ»šæœºåˆ¶ï¼šéƒ¨ç½²å¤±è´¥æ—¶çš„æ¢å¤ç­–ç•¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è‡ªåŠ¨åŒ–éƒ¨ç½²çš„ä»·å€¼**
```
æ•ˆç‡æå‡ï¼š
- æ‰‹å·¥éƒ¨ç½²ï¼š4å°æœåŠ¡å™¨éœ€è¦4-8å°æ—¶
- è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š4å°æœåŠ¡å™¨éœ€è¦30-60åˆ†é’Ÿ
- æ•ˆç‡æå‡ï¼š8-16å€

å‡†ç¡®æ€§æå‡ï¼š
- æ¶ˆé™¤äººä¸ºé…ç½®é”™è¯¯
- æ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹
- å‡å°‘ç¯å¢ƒå·®å¼‚
```

**ğŸ”¹ Ansible vs ä¼ ç»Ÿè„šæœ¬**
```
ä¼ ç»ŸShellè„šæœ¬é—®é¢˜ï¼š
âŒ éš¾ä»¥ç®¡ç†ï¼šè„šæœ¬åˆ†æ•£ï¼Œç»´æŠ¤å›°éš¾
âŒ é”™è¯¯å¤„ç†ï¼šç¼ºä¹ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
âŒ å¹‚ç­‰æ€§ï¼šé‡å¤æ‰§è¡Œå¯èƒ½äº§ç”Ÿå‰¯ä½œç”¨
âŒ å¯è¯»æ€§ï¼šå¤æ‚é€»è¾‘éš¾ä»¥ç†è§£

Ansibleä¼˜åŠ¿ï¼š
âœ… å£°æ˜å¼ï¼šæè¿°ç›®æ ‡çŠ¶æ€ï¼Œè€Œéæ‰§è¡Œæ­¥éª¤
âœ… å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´
âœ… æ¨¡å—åŒ–ï¼šä¸°å¯Œçš„é¢„åˆ¶æ¨¡å—
âœ… å¯è¯»æ€§ï¼šYAMLæ ¼å¼ç›´è§‚æ˜“æ‡‚
```

**ğŸ”¹ é…ç½®æ¨¡æ¿çš„è®¾è®¡åŸåˆ™**
```
æ¨¡æ¿è®¾è®¡è¦ç‚¹ï¼š
1. å‚æ•°åŒ–ï¼šæ‰€æœ‰ç¯å¢ƒç›¸å…³å‚æ•°ä½¿ç”¨å˜é‡
2. å¯å¤ç”¨ï¼šåŒä¸€ä¸ªæ¨¡æ¿é€‚ç”¨äºä¸åŒç¯å¢ƒ
3. å¯ç»´æŠ¤ï¼šæ¨¡æ¿ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´
4. å®‰å…¨æ€§ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**éƒ¨ç½²ç¯å¢ƒè§„åˆ’**
```
å¼€å‘ç¯å¢ƒï¼š
- å•æœºæ¨¡æ‹Ÿï¼šä¸€å°æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´ç¯å¢ƒ
- å¿«é€Ÿè¿­ä»£ï¼šæ”¯æŒå¿«é€Ÿé‡æ–°éƒ¨ç½²
- èµ„æºæœ€å°ï¼šæœ€ä½é…ç½®æ»¡è¶³åŠŸèƒ½éªŒè¯

æµ‹è¯•ç¯å¢ƒï¼š  
- å¤šæœºéƒ¨ç½²ï¼šæ¥è¿‘ç”Ÿäº§çš„é›†ç¾¤æ¶æ„
- ç¨³å®šæ€§æµ‹è¯•ï¼šæ”¯æŒå„ç§æ•…éšœæµ‹è¯•
- è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šé›†æˆè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

ç”Ÿäº§ç¯å¢ƒï¼š
- é«˜å¯ç”¨ï¼šå®Œæ•´çš„é«˜å¯ç”¨æ¶æ„
- ç›‘æ§å‘Šè­¦ï¼šå®Œå–„çš„ç›‘æ§ä½“ç³»
- å¤‡ä»½æ¢å¤ï¼šå®šæœŸå¤‡ä»½å’Œæ¢å¤æµ‹è¯•
```

**éƒ¨ç½²æœ€ä½³å®è·µ**
```
éƒ¨ç½²å‰å‡†å¤‡ï¼š
âœ… ç¯å¢ƒæ£€æŸ¥ï¼šç¡®ä¿æ»¡è¶³æœ€ä½è¦æ±‚
âœ… ç½‘ç»œè§„åˆ’ï¼šç¡®ä¿ç½‘ç»œè¿é€šæ€§
âœ… æƒé™é…ç½®ï¼šé…ç½®å¿…è¦çš„ç”¨æˆ·æƒé™
âœ… å¤‡ä»½ç­–ç•¥ï¼šåˆ¶å®šæ•°æ®å¤‡ä»½è®¡åˆ’

éƒ¨ç½²è¿‡ç¨‹ï¼š
âœ… åˆ†æ­¥æ‰§è¡Œï¼šåˆ†é˜¶æ®µæ‰§è¡Œéƒ¨ç½²ä»»åŠ¡
âœ… éªŒè¯æ£€æŸ¥ï¼šæ¯ä¸ªé˜¶æ®µåè¿›è¡ŒéªŒè¯
âœ… æ—¥å¿—è®°å½•ï¼šè¯¦ç»†è®°å½•éƒ¨ç½²è¿‡ç¨‹
âœ… å¼‚å¸¸å¤„ç†ï¼šåˆ¶å®šå¼‚å¸¸å¤„ç†é¢„æ¡ˆ

éƒ¨ç½²åç»´æŠ¤ï¼š
âœ… ç›‘æ§å‘Šè­¦ï¼šå»ºç«‹ç›‘æ§å‘Šè­¦æœºåˆ¶
âœ… å®šæœŸæ£€æŸ¥ï¼šå®šæœŸæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
âœ… æ–‡æ¡£æ›´æ–°ï¼šåŠæ—¶æ›´æ–°éƒ¨ç½²æ–‡æ¡£
âœ… ç‰ˆæœ¬ç®¡ç†ï¼šç®¡ç†é…ç½®æ–‡ä»¶ç‰ˆæœ¬
```

### 9.4 å·¥ç¨‹å®è·µè¦ç‚¹


```
å›¢é˜Ÿåä½œï¼š
- ä»£ç ç‰ˆæœ¬ç®¡ç†ï¼šä½¿ç”¨Gitç®¡ç†æ‰€æœ‰è„šæœ¬å’Œé…ç½®
- æƒé™æ§åˆ¶ï¼šæ§åˆ¶ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æƒé™
- æ–‡æ¡£è§„èŒƒï¼šç»´æŠ¤è¯¦ç»†çš„éƒ¨ç½²æ–‡æ¡£
- çŸ¥è¯†åˆ†äº«ï¼šå®šæœŸè¿›è¡ŒæŠ€æœ¯åˆ†äº«

è´¨é‡ä¿è¯ï¼š
- æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼šç”Ÿäº§éƒ¨ç½²å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- ç°åº¦å‘å¸ƒï¼šåˆ†æ‰¹æ¬¡éƒ¨ç½²é™ä½é£é™©
- ç›‘æ§å‘Šè­¦ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
- åº”æ€¥é¢„æ¡ˆï¼šåˆ¶å®šè¯¦ç»†çš„åº”æ€¥å“åº”é¢„æ¡ˆ

æŒç»­æ”¹è¿›ï¼š
- åé¦ˆæ”¶é›†ï¼šæ”¶é›†ä½¿ç”¨åé¦ˆä¼˜åŒ–æµç¨‹
- è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼šé€æ­¥æé«˜è‡ªåŠ¨åŒ–ç¨‹åº¦
- å·¥å…·å‡çº§ï¼šè·Ÿè¿›å·¥å…·ç‰ˆæœ¬æ›´æ–°
- æœ€ä½³å®è·µï¼šæ€»ç»“å¹¶æ¨å¹¿æœ€ä½³å®è·µ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è‡ªåŠ¨éƒ¨ç½²ææ•ˆç‡ï¼ŒAnsibleå·¥å…·æ˜¯é¦–é€‰
- æ¨¡æ¿å˜é‡é…ç½®åŒ–ï¼Œæ‰¹é‡éƒ¨ç½²æ ‡å‡†åŒ–  
- éªŒè¯å›æ»šä¿è´¨é‡ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š
- åˆ†æ­¥å®æ–½é™é£é™©ï¼ŒæŒç»­æ”¹è¿›ä¿ƒå‘å±•