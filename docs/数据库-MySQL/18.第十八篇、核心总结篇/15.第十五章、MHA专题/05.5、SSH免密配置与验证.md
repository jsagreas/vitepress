---
title: 5、SSH免密配置与验证
---
## 📚 目录

1. [SSH免密配置概述](#1-SSH免密配置概述)
2. [SSH密钥生成详解](#2-SSH密钥生成详解)
3. [公钥分发与配置](#3-公钥分发与配置)
4. [SSH连接测试与验证](#4-SSH连接测试与验证)
5. [权限设置与安全加固](#5-权限设置与安全加固)
6. [批量配置脚本实战](#6-批量配置脚本实战)
7. [连接故障排查指南](#7-连接故障排查指南)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔐 SSH免密配置概述


### 1.1 什么是SSH免密登录


SSH免密登录就是让你从一台服务器登录到另一台服务器时，不需要输入密码，系统自动帮你完成身份验证。

**通俗理解**：
```
就像你家的指纹锁一样：
- 传统SSH登录 = 用钥匙开门（每次都要输入密码）
- SSH免密登录 = 指纹开门（系统自动识别你的身份）
```

### 1.2 为什么MHA需要SSH免密


在MySQL MHA高可用架构中，SSH免密配置是**必须条件**，不是可选项：

**🎯 核心原因**：
- **自动故障切换**：当主库宕机时，MHA需要立即连接各个节点执行切换操作
- **无人值守**：故障往往发生在半夜，不可能有人手动输入密码
- **时间要求严格**：数据库切换要求在秒级完成，输入密码会耽误时间

**📊 MHA SSH通信示意图**：
```
    MHA Manager节点
    (192.168.1.100)
          |
    SSH免密连接到所有MySQL节点
          |
    ┌─────────┬─────────┬─────────┐
    │  Master │ Slave1  │ Slave2  │
    │192.168. │192.168. │192.168. │
    │  1.101  │  1.102  │  1.103  │
    └─────────┴─────────┴─────────┘
```

### 1.3 SSH免密配置的本质原理


SSH免密登录基于**公钥加密技术**，简单说就是：

**🔑 工作原理**：
```
1. 你生成一对密钥：公钥 + 私钥
2. 把公钥放到目标服务器上
3. 连接时，你用私钥证明身份
4. 目标服务器用公钥验证你的身份
5. 验证通过，免密登录成功
```

**💡 生活类比**：
```
公钥 = 你家门上的锁
私钥 = 你的钥匙
只有你的钥匙能打开你家的锁
```

---

## 2. 🔧 SSH密钥生成详解


### 2.1 ssh-keygen命令基础


`ssh-keygen`是SSH密钥生成的核心命令，它的作用就是帮你生成一对密钥。

**🔸 基础命令格式**：
```bash
ssh-keygen [选项] -t 密钥类型
```

### 2.2 密钥类型选择


| 密钥类型 | **特点** | **适用场景** | **推荐程度** |
|---------|---------|-------------|-------------|
| `rsa` | `最通用，兼容性好` | `生产环境首选` | ⭐⭐⭐⭐⭐ |
| `ed25519` | `安全性高，速度快` | `新系统推荐` | ⭐⭐⭐⭐ |
| `ecdsa` | `安全性好，性能好` | `现代系统` | ⭐⭐⭐ |
| `dsa` | `已过时，不安全` | `不建议使用` | ❌ |

**🎯 生产环境推荐**：RSA 2048位或4096位

### 2.3 实际密钥生成操作


**📍 基础生成（推荐方式）**：
```bash
# 生成RSA 2048位密钥（默认）
ssh-keygen -t rsa -b 2048

# 生成RSA 4096位密钥（更安全）
ssh-keygen -t rsa -b 4096 -C "mha-manager@company.com"
```

**📋 交互式生成过程**：
```bash
[root@mha-manager ~]# ssh-keygen -t rsa -b 2048
Generating public/private rsa key pair.

# 1. 询问密钥保存位置（直接回车使用默认）
Enter file in which to save the key (/root/.ssh/id_rsa): 

# 2. 询问是否设置密码（直接回车表示无密码）
Enter passphrase (empty for no passphrase): 

# 3. 确认密码（直接回车）
Enter same passphrase again: 

# 4. 生成结果
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
```

**🔸 生成文件说明**：
```bash
~/.ssh/id_rsa     # 私钥文件（保密，不能泄露）
~/.ssh/id_rsa.pub # 公钥文件（可以公开，需要分发）
```

### 2.4 批量生成密钥脚本


对于MHA集群，通常需要在多个节点生成密钥：

```bash
#!/bin/bash
# 批量生成SSH密钥脚本

# 定义节点列表
NODES=("192.168.1.100" "192.168.1.101" "192.168.1.102" "192.168.1.103")

for node in "${NODES[@]}"; do
    echo "=== 在节点 $node 生成SSH密钥 ==="
    
    ssh root@$node "
        # 检查是否已存在密钥
        if [ ! -f ~/.ssh/id_rsa ]; then
            # 生成密钥（无交互）
            ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N ''
            echo '密钥生成完成'
        else
            echo '密钥已存在，跳过生成'
        fi
    "
done
```

---

## 3. 📤 公钥分发与配置


### 3.1 ssh-copy-id命令详解


`ssh-copy-id`是分发公钥最简单的命令，它会自动把你的公钥复制到目标服务器。

**🔸 基础语法**：
```bash
ssh-copy-id [用户名@]目标服务器IP
```

**💡 工作过程**：
```
1. 读取本地公钥文件（~/.ssh/id_rsa.pub）
2. 连接到目标服务器（需要输入密码）
3. 把公钥内容追加到目标服务器的 ~/.ssh/authorized_keys 文件
4. 设置正确的文件权限
```

### 3.2 单个节点公钥分发


**📍 基础分发操作**：
```bash
# 从MHA Manager分发公钥到MySQL主库
ssh-copy-id root@192.168.1.101

# 从MHA Manager分发公钥到MySQL从库1
ssh-copy-id root@192.168.1.102

# 从MHA Manager分发公钥到MySQL从库2
ssh-copy-id root@192.168.1.103
```

**📋 实际执行过程**：
```bash
[root@mha-manager ~]# ssh-copy-id root@192.168.1.101
/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
The authenticity of host '192.168.1.101 (192.168.1.101)' can't be established.
ECDSA key fingerprint is SHA256:xxx...
Are you sure you want to continue connecting (yes/no)? yes

/bin/ssh-copy-id: INFO: attempting to log in with the new key(s)
/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new key(s)
root@192.168.1.101's password: [输入目标服务器密码]

Number of key(s) added: 1
```

### 3.3 双向免密配置


MHA架构中，不仅Manager需要免密连接到各个MySQL节点，各个MySQL节点之间也需要相互免密连接。

**🔄 双向免密配置流程**：
```
MHA架构SSH免密配置关系图：

Manager(100) ←→ Master(101)
    ↓              ↓
    ↓         Slave1(102)
    ↓              ↓  
    └────→ Slave2(103)

所有节点都需要能免密连接到其他所有节点
```

**📝 完整双向配置脚本**：
```bash
#!/bin/bash
# MHA集群双向SSH免密配置脚本

# 定义所有节点
NODES=("192.168.1.100" "192.168.1.101" "192.168.1.102" "192.168.1.103")
NODE_NAMES=("mha-manager" "mysql-master" "mysql-slave1" "mysql-slave2")

echo "开始配置MHA集群SSH双向免密..."

# 1. 在所有节点生成密钥
for i in "${!NODES[@]}"; do
    node=${NODES[$i]}
    name=${NODE_NAMES[$i]}
    
    echo "=== 在 $name($node) 生成SSH密钥 ==="
    ssh root@$node "
        if [ ! -f ~/.ssh/id_rsa ]; then
            ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N '' -C '$name'
            echo '$name 密钥生成完成'
        fi
    "
done

# 2. 配置双向免密
for i in "${!NODES[@]}"; do
    from_node=${NODES[$i]}
    from_name=${NODE_NAMES[$i]}
    
    for j in "${!NODES[@]}"; do
        to_node=${NODES[$j]}
        to_name=${NODE_NAMES[$j]}
        
        # 跳过自己到自己
        if [ "$from_node" != "$to_node" ]; then
            echo "配置 $from_name → $to_name 免密连接"
            ssh root@$from_node "ssh-copy-id -o StrictHostKeyChecking=no root@$to_node"
        fi
    done
done

echo "MHA集群SSH双向免密配置完成！"
```

### 3.4 手动分发公钥方法


如果`ssh-copy-id`命令不可用，可以手动分发：

```bash
# 1. 查看本地公钥内容
cat ~/.ssh/id_rsa.pub

# 2. 复制公钥内容，然后在目标服务器执行：
mkdir -p ~/.ssh
echo "ssh-rsa AAAAB3NzaC1yc2EAAAA... 你的公钥内容" >> ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

---

## 4. ✅ SSH连接测试与验证


### 4.1 基础连接测试


配置完成后，必须验证SSH免密连接是否正常工作。

**📍 基础测试命令**：
```bash
# 测试免密连接到目标服务器
ssh root@192.168.1.101

# 执行远程命令测试
ssh root@192.168.1.101 "hostname && date"

# 测试后立即退出
ssh root@192.168.1.101 "echo 'SSH免密连接成功'"
```

**✅ 成功标志**：
- 无需输入密码直接连接成功
- 能正常执行远程命令
- 连接过程无报错信息

### 4.2 MHA专用连接测试


MHA有专门的SSH连接检查命令：

```bash
# 检查MHA Manager到所有MySQL节点的SSH连接
masterha_check_ssh --conf=/etc/mha/app1.cnf

# 检查所有MySQL节点之间的SSH连接
masterha_check_repl --conf=/etc/mha/app1.cnf
```

**📋 正常输出示例**：
```bash
[root@mha-manager ~]# masterha_check_ssh --conf=/etc/mha/app1.cnf
Mon Jan 16 14:30:00 2025 - [info] Reading default configuration from /etc/mha/app1.cnf..
Mon Jan 16 14:30:00 2025 - [info] Checking SSH connection to mysql1(192.168.1.101:22)..
Mon Jan 16 14:30:00 2025 - [info]   ok.
Mon Jan 16 14:30:00 2025 - [info] Checking SSH connection to mysql2(192.168.1.102:22)..
Mon Jan 16 14:30:00 2025 - [info]   ok.
Mon Jan 16 14:30:00 2025 - [info] Checking SSH connection to mysql3(192.168.1.103:22)..
Mon Jan 16 14:30:00 2025 - [info]   ok.
Mon Jan 16 14:30:00 2025 - [info] All SSH connections are reachable.
```

### 4.3 批量连接测试脚本


```bash
#!/bin/bash
# MHA集群SSH连接批量测试脚本

# 定义所有节点
NODES=("192.168.1.100" "192.168.1.101" "192.168.1.102" "192.168.1.103")
NODE_NAMES=("mha-manager" "mysql-master" "mysql-slave1" "mysql-slave2")

echo "开始测试MHA集群SSH免密连接..."
echo "========================================"

# 测试矩阵
for i in "${!NODES[@]}"; do
    from_node=${NODES[$i]}
    from_name=${NODE_NAMES[$i]}
    
    echo "从 $from_name($from_node) 测试连接："
    
    for j in "${!NODES[@]}"; do
        to_node=${NODES[$j]}
        to_name=${NODE_NAMES[$j]}
        
        if [ "$from_node" != "$to_node" ]; then
            # 测试连接
            result=$(ssh root@$from_node "ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no root@$to_node 'echo success' 2>/dev/null")
            
            if [ "$result" = "success" ]; then
                echo "  ✅ → $to_name($to_node): 连接成功"
            else
                echo "  ❌ → $to_name($to_node): 连接失败"
            fi
        fi
    done
    echo ""
done

echo "SSH连接测试完成！"
```

---

## 5. 🔒 权限设置与安全加固


### 5.1 SSH目录和文件权限


SSH对文件权限要求非常严格，权限不对会导致免密登录失败。

**🔸 标准权限设置**：
```bash
# SSH目录权限
chmod 700 ~/.ssh

# 私钥权限（只有所有者可读写）
chmod 600 ~/.ssh/id_rsa

# 公钥权限（所有者可读写，其他人可读）
chmod 644 ~/.ssh/id_rsa.pub

# authorized_keys权限（只有所有者可读写）
chmod 600 ~/.ssh/authorized_keys

# known_hosts权限（所有者可读写，其他人可读）
chmod 644 ~/.ssh/known_hosts
```

**📋 权限检查脚本**：
```bash
#!/bin/bash
# SSH权限检查和修复脚本

check_and_fix_permissions() {
    local user_home=$1
    local ssh_dir="$user_home/.ssh"
    
    echo "检查和修复 $ssh_dir 的权限..."
    
    # 确保SSH目录存在
    if [ ! -d "$ssh_dir" ]; then
        mkdir -p "$ssh_dir"
    fi
    
    # 设置目录权限
    chmod 700 "$ssh_dir"
    
    # 设置文件权限
    [ -f "$ssh_dir/id_rsa" ] && chmod 600 "$ssh_dir/id_rsa"
    [ -f "$ssh_dir/id_rsa.pub" ] && chmod 644 "$ssh_dir/id_rsa.pub"
    [ -f "$ssh_dir/authorized_keys" ] && chmod 600 "$ssh_dir/authorized_keys"
    [ -f "$ssh_dir/known_hosts" ] && chmod 644 "$ssh_dir/known_hosts"
    
    echo "权限修复完成"
}

# 修复root用户权限
check_and_fix_permissions "/root"
```

### 5.2 known_hosts配置


`known_hosts`文件记录已知主机的指纹，用于防止中间人攻击。

**🔸 第一次连接时的处理**：
```bash
# 第一次连接会提示
ssh root@192.168.1.101
The authenticity of host '192.168.1.101 (192.168.1.101)' can't be established.
ECDSA key fingerprint is SHA256:xxx...
Are you sure you want to continue connecting (yes/no)? yes
```

**📍 批量添加known_hosts**：
```bash
#!/bin/bash
# 批量添加主机到known_hosts

NODES=("192.168.1.101" "192.168.1.102" "192.168.1.103")

for node in "${NODES[@]}"; do
    # 扫描主机密钥并添加到known_hosts
    ssh-keyscan -H $node >> ~/.ssh/known_hosts
    echo "已添加 $node 到 known_hosts"
done

# 去重
sort ~/.ssh/known_hosts | uniq > ~/.ssh/known_hosts.tmp
mv ~/.ssh/known_hosts.tmp ~/.ssh/known_hosts
```

### 5.3 SSH安全加固


**🔐 SSH服务配置优化**：
```bash
# 编辑SSH配置文件
vim /etc/ssh/sshd_config

# 推荐安全配置
Port 22                          # 可以改为非标准端口
PermitRootLogin yes             # MHA需要root登录
PasswordAuthentication yes      # 保留密码认证作为备用
PubkeyAuthentication yes        # 启用公钥认证
AuthorizedKeysFile .ssh/authorized_keys
MaxAuthTries 3                  # 限制认证尝试次数
ClientAliveInterval 60          # 保持连接活跃
ClientAliveCountMax 3           # 客户端无响应次数限制

# 重启SSH服务
systemctl restart sshd
```

**⚠️ 安全注意事项**：
```
🔸 私钥安全：私钥文件绝不能泄露，权限必须是600
🔸 定期轮换：定期更换SSH密钥，特别是人员变动时
🔸 访问控制：使用防火墙限制SSH访问来源
🔸 日志监控：监控SSH登录日志，发现异常及时处理
🔸 备份密钥：安全备份SSH密钥，避免丢失
```

---

## 6. 📜 批量配置脚本实战


### 6.1 完整自动化配置脚本


这个脚本可以一键完成整个MHA集群的SSH免密配置：

```bash
#!/bin/bash
# MHA集群SSH免密配置一键脚本
# 作者：运维团队
# 版本：v1.0

set -e  # 遇到错误立即退出

# =============================================================================
# 配置参数
# =============================================================================

# 定义集群节点信息
declare -A CLUSTER_NODES=(
    ["mha-manager"]="192.168.1.100"
    ["mysql-master"]="192.168.1.101"
    ["mysql-slave1"]="192.168.1.102"
    ["mysql-slave2"]="192.168.1.103"
)

# SSH用户
SSH_USER="root"

# 密钥类型和长度
KEY_TYPE="rsa"
KEY_BITS="2048"

# =============================================================================
# 工具函数
# =============================================================================

log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" >&2
}

check_node_connectivity() {
    local node_ip=$1
    local node_name=$2
    
    if ping -c 1 -W 1 $node_ip >/dev/null 2>&1; then
        log_info "$node_name($node_ip) 网络连通正常"
        return 0
    else
        log_error "$node_name($node_ip) 网络不通"
        return 1
    fi
}

# =============================================================================
# 主要功能函数
# =============================================================================

# 1. 检查环境
check_environment() {
    log_info "开始环境检查..."
    
    # 检查必要命令
    for cmd in ssh ssh-keygen ssh-copy-id; do
        if ! command -v $cmd >/dev/null 2>&1; then
            log_error "命令 $cmd 不存在，请安装 openssh 相关包"
            exit 1
        fi
    done
    
    # 检查节点连通性
    local failed_nodes=()
    for node_name in "${!CLUSTER_NODES[@]}"; do
        node_ip=${CLUSTER_NODES[$node_name]}
        if ! check_node_connectivity $node_ip $node_name; then
            failed_nodes+=("$node_name($node_ip)")
        fi
    done
    
    if [ ${#failed_nodes[@]} -ne 0 ]; then
        log_error "以下节点网络不通: ${failed_nodes[*]}"
        exit 1
    fi
    
    log_info "环境检查完成"
}

# 2. 生成SSH密钥
generate_ssh_keys() {
    log_info "开始生成SSH密钥..."
    
    for node_name in "${!CLUSTER_NODES[@]}"; do
        node_ip=${CLUSTER_NODES[$node_name]}
        
        log_info "在 $node_name($node_ip) 生成SSH密钥"
        
        ssh $SSH_USER@$node_ip "
            if [ ! -f ~/.ssh/id_$KEY_TYPE ]; then
                ssh-keygen -t $KEY_TYPE -b $KEY_BITS -f ~/.ssh/id_$KEY_TYPE -N '' -C '$node_name@mha-cluster'
                echo 'SSH密钥生成完成'
            else
                echo 'SSH密钥已存在，跳过生成'
            fi
        " || {
            log_error "在 $node_name 生成SSH密钥失败"
            exit 1
        }
    done
    
    log_info "SSH密钥生成完成"
}

# 3. 分发公钥
distribute_keys() {
    log_info "开始分发SSH公钥..."
    
    local total_connections=0
    local success_connections=0
    
    for from_name in "${!CLUSTER_NODES[@]}"; do
        from_ip=${CLUSTER_NODES[$from_name]}
        
        for to_name in "${!CLUSTER_NODES[@]}"; do
            to_ip=${CLUSTER_NODES[$to_name]}
            
            # 跳过自己到自己
            if [ "$from_name" != "$to_name" ]; then
                total_connections=$((total_connections + 1))
                
                log_info "配置 $from_name → $to_name 免密连接"
                
                if ssh $SSH_USER@$from_ip "ssh-copy-id -o StrictHostKeyChecking=no $SSH_USER@$to_ip" >/dev/null 2>&1; then
                    success_connections=$((success_connections + 1))
                    echo "  ✅ 成功"
                else
                    echo "  ❌ 失败"
                fi
            fi
        done
    done
    
    log_info "公钥分发完成: $success_connections/$total_connections 连接配置成功"
}

# 4. 测试连接
test_connections() {
    log_info "开始测试SSH免密连接..."
    
    local total_tests=0
    local success_tests=0
    
    for from_name in "${!CLUSTER_NODES[@]}"; do
        from_ip=${CLUSTER_NODES[$from_name]}
        
        echo "从 $from_name($from_ip) 测试连接："
        
        for to_name in "${!CLUSTER_NODES[@]}"; do
            to_ip=${CLUSTER_NODES[$to_name]}
            
            if [ "$from_name" != "$to_name" ]; then
                total_tests=$((total_tests + 1))
                
                # 测试连接
                if ssh $SSH_USER@$from_ip "ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no $SSH_USER@$to_ip 'echo success'" 2>/dev/null | grep -q "success"; then
                    echo "  ✅ → $to_name($to_ip): 连接成功"
                    success_tests=$((success_tests + 1))
                else
                    echo "  ❌ → $to_name($to_ip): 连接失败"
                fi
            fi
        done
        echo ""
    done
    
    log_info "连接测试完成: $success_tests/$total_tests 连接测试成功"
    
    if [ $success_tests -eq $total_tests ]; then
        log_info "🎉 所有SSH免密连接配置成功！"
        return 0
    else
        log_error "部分SSH连接配置失败，请检查配置"
        return 1
    fi
}

# 5. 权限修复
fix_permissions() {
    log_info "开始修复SSH权限..."
    
    for node_name in "${!CLUSTER_NODES[@]}"; do
        node_ip=${CLUSTER_NODES[$node_name]}
        
        log_info "修复 $node_name($node_ip) SSH权限"
        
        ssh $SSH_USER@$node_ip "
            chmod 700 ~/.ssh
            chmod 600 ~/.ssh/id_* 2>/dev/null || true
            chmod 644 ~/.ssh/*.pub 2>/dev/null || true
            chmod 600 ~/.ssh/authorized_keys 2>/dev/null || true
            chmod 644 ~/.ssh/known_hosts 2>/dev/null || true
            echo 'SSH权限修复完成'
        "
    done
    
    log_info "SSH权限修复完成"
}

# =============================================================================
# 主程序
# =============================================================================

main() {
    log_info "开始MHA集群SSH免密配置..."
    log_info "集群节点: ${!CLUSTER_NODES[*]}"
    
    # 执行配置步骤
    check_environment
    generate_ssh_keys
    distribute_keys
    fix_permissions
    test_connections
    
    if [ $? -eq 0 ]; then
        echo ""
        echo "🎉 MHA集群SSH免密配置成功完成！"
        echo ""
        echo "📋 配置总结："
        echo "  - 集群节点数: ${#CLUSTER_NODES[@]}"
        echo "  - SSH连接数: $((${#CLUSTER_NODES[@]} * (${#CLUSTER_NODES[@]} - 1)))"
        echo "  - 密钥类型: $KEY_TYPE $KEY_BITS 位"
        echo ""
        echo "⚡ 接下来可以运行 MHA 检查命令："
        echo "  masterha_check_ssh --conf=/etc/mha/app1.cnf"
        echo "  masterha_check_repl --conf=/etc/mha/app1.cnf"
    else
        echo ""
        echo "❌ SSH免密配置过程中出现错误，请检查日志"
        exit 1
    fi
}

# 脚本入口
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

### 6.2 脚本使用方法


**📍 下载和使用**：
```bash
# 1. 保存脚本
cat > mha_ssh_setup.sh << 'EOF'
# ... 上面的完整脚本内容 ...
EOF

# 2. 添加执行权限
chmod +x mha_ssh_setup.sh

# 3. 修改脚本中的节点信息
vim mha_ssh_setup.sh

# 4. 运行脚本
./mha_ssh_setup.sh
```

**✅ 执行成功输出示例**：
```bash
[2025-01-16 14:30:00] [INFO] 开始MHA集群SSH免密配置...
[2025-01-16 14:30:00] [INFO] 集群节点: mha-manager mysql-master mysql-slave1 mysql-slave2
[2025-01-16 14:30:01] [INFO] 开始环境检查...
[2025-01-16 14:30:01] [INFO] mha-manager(192.168.1.100) 网络连通正常
[2025-01-16 14:30:01] [INFO] mysql-master(192.168.1.101) 网络连通正常
[2025-01-16 14:30:01] [INFO] mysql-slave1(192.168.1.102) 网络连通正常
[2025-01-16 14:30:01] [INFO] mysql-slave2(192.168.1.103) 网络连通正常
[2025-01-16 14:30:01] [INFO] 环境检查完成
...

🎉 MHA集群SSH免密配置成功完成！

📋 配置总结：
  - 集群节点数: 4
  - SSH连接数: 12
  - 密钥类型: rsa 2048 位

⚡ 接下来可以运行 MHA 检查命令：
  masterha_check_ssh --conf=/etc/mha/app1.cnf
  masterha_check_repl --conf=/etc/mha/app1.cnf
```

---

## 7. 🔍 连接故障排查指南


### 7.1 常见问题和解决方案


**❌ 问题1：Permission denied (publickey,password)**

**🔍 原因分析**：
- SSH目录或文件权限不正确
- authorized_keys文件不存在或内容错误
- SSH服务配置问题

**✅ 解决方案**：
```bash
# 1. 检查并修复权限
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub

# 2. 检查authorized_keys内容
cat ~/.ssh/authorized_keys

# 3. 重新分发公钥
ssh-copy-id root@target_server

# 4. 检查SSH服务配置
grep -E "PubkeyAuthentication|AuthorizedKeysFile" /etc/ssh/sshd_config
```

**❌ 问题2：Host key verification failed**

**🔍 原因分析**：
- 目标主机的密钥指纹发生变化
- known_hosts文件中的记录不匹配

**✅ 解决方案**：
```bash
# 1. 删除旧的主机密钥记录
ssh-keygen -R 192.168.1.101

# 2. 重新连接并接受新密钥
ssh root@192.168.1.101

# 3. 或者批量更新known_hosts
ssh-keyscan 192.168.1.101 >> ~/.ssh/known_hosts
```

**❌ 问题3：Connection refused**

**🔍 原因分析**：
- SSH服务未启动
- 防火墙阻止连接
- 端口配置错误

**✅ 解决方案**：
```bash
# 1. 检查SSH服务状态
systemctl status sshd

# 2. 启动SSH服务
systemctl start sshd
systemctl enable sshd

# 3. 检查防火墙
firewall-cmd --list-services
firewall-cmd --permanent --add-service=ssh
firewall-cmd --reload

# 4. 检查端口监听
netstat -tlnp | grep :22
```

### 7.2 故障排查工具命令


**🔧 详细调试连接**：
```bash
# 使用详细模式连接，显示调试信息
ssh -vvv root@192.168.1.101

# 测试特定私钥文件
ssh -i ~/.ssh/id_rsa root@192.168.1.101

# 仅使用密钥认证，不使用密码
ssh -o PasswordAuthentication=no root@192.168.1.101

# 跳过主机密钥检查（仅测试用）
ssh -o StrictHostKeyChecking=no root@192.168.1.101
```

**📋 系统日志检查**：
```bash
# 查看SSH服务日志
journalctl -u sshd -f

# 查看认证日志
tail -f /var/log/secure

# 查看系统消息
tail -f /var/log/messages
```

### 7.3 故障排查检查清单


**☑️ SSH免密连接故障排查清单**

**🔸 网络层检查**：
```bash
☐ ping 目标服务器是否通畅
☐ telnet 目标服务器 22 端口是否开放
☐ 防火墙是否允许SSH服务
☐ SELinux 是否影响SSH连接
```

**🔸 SSH服务检查**：
```bash
☐ SSH服务是否正常运行
☐ SSH配置文件语法是否正确
☐ SSH端口配置是否正确
☐ 用户是否被允许SSH登录
```

**🔸 密钥和权限检查**：
```bash
☐ SSH密钥是否正确生成
☐ 公钥是否正确分发到目标服务器
☐ SSH目录权限是否正确 (700)
☐ 私钥文件权限是否正确 (600)
☐ authorized_keys 权限是否正确 (600)
☐ authorized_keys 内容是否正确
```

**🔸 配置文件检查**：
```bash
☐ /etc/ssh/sshd_config 配置是否正确
☐ PubkeyAuthentication 是否启用
☐ AuthorizedKeysFile 路径是否正确
☐ PermitRootLogin 是否允许
```

### 7.4 故障排查脚本


```bash
#!/bin/bash
# SSH免密连接故障排查脚本

TARGET_HOST=$1
SSH_USER=${2:-root}

if [ -z "$TARGET_HOST" ]; then
    echo "用法: $0 <目标主机IP> [SSH用户名]"
    exit 1
fi

echo "开始排查 SSH 免密连接到 $SSH_USER@$TARGET_HOST ..."
echo "================================================"

# 1. 网络连通性检查
echo "1. 检查网络连通性..."
if ping -c 1 -W 1 $TARGET_HOST >/dev/null 2>&1; then
    echo "  ✅ 网络连通正常"
else
    echo "  ❌ 网络不通，请检查网络配置"
    exit 1
fi

# 2. SSH端口检查
echo "2. 检查SSH端口..."
if timeout 5 bash -c "</dev/tcp/$TARGET_HOST/22" 2>/dev/null; then
    echo "  ✅ SSH端口(22)可访问"
else
    echo "  ❌ SSH端口(22)不可访问，请检查防火墙和SSH服务"
fi

# 3. 本地密钥检查
echo "3. 检查本地SSH密钥..."
if [ -f ~/.ssh/id_rsa ]; then
    echo "  ✅ 私钥文件存在"
    
    # 检查私钥权限
    perm=$(stat -c "%a" ~/.ssh/id_rsa)
    if [ "$perm" = "600" ]; then
        echo "  ✅ 私钥权限正确 (600)"
    else
        echo "  ⚠️  私钥权限不正确 ($perm)，建议修改为 600"
        echo "      修复命令: chmod 600 ~/.ssh/id_rsa"
    fi
else
    echo "  ❌ 私钥文件不存在，请先生成SSH密钥"
    echo "      生成命令: ssh-keygen -t rsa -b 2048"
fi

if [ -f ~/.ssh/id_rsa.pub ]; then
    echo "  ✅ 公钥文件存在"
else
    echo "  ❌ 公钥文件不存在"
fi

# 4. SSH目录权限检查
echo "4. 检查SSH目录权限..."
if [ -d ~/.ssh ]; then
    perm=$(stat -c "%a" ~/.ssh)
    if [ "$perm" = "700" ]; then
        echo "  ✅ SSH目录权限正确 (700)"
    else
        echo "  ⚠️  SSH目录权限不正确 ($perm)，建议修改为 700"
        echo "      修复命令: chmod 700 ~/.ssh"
    fi
else
    echo "  ❌ SSH目录不存在"
fi

# 5. 测试SSH连接
echo "5. 测试SSH连接..."
if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o PasswordAuthentication=no $SSH_USER@$TARGET_HOST "echo 'SSH连接成功'" 2>/dev/null; then
    echo "  ✅ SSH免密连接成功"
else
    echo "  ❌ SSH免密连接失败"
    echo "      请检查目标服务器的 authorized_keys 配置"
    echo "      分发公钥命令: ssh-copy-id $SSH_USER@$TARGET_HOST"
fi

# 6. 检查目标服务器配置（如果能连接的话）
echo "6. 检查目标服务器配置..."
if ssh $SSH_USER@$TARGET_HOST "echo 'test'" >/dev/null 2>&1; then
    echo "  检查目标服务器 authorized_keys 文件..."
    
    auth_keys_check=$(ssh $SSH_USER@$TARGET_HOST "
        if [ -f ~/.ssh/authorized_keys ]; then
            perm=\$(stat -c '%a' ~/.ssh/authorized_keys)
            if [ \"\$perm\" = '600' ]; then
                echo 'authorized_keys权限正确'
            else
                echo \"authorized_keys权限不正确(\$perm)\"
            fi
        else
            echo 'authorized_keys文件不存在'
        fi
    ")
    echo "    $auth_keys_check"
else
    echo "  ⚠️  无法连接到目标服务器，跳过远程检查"
fi

echo ""
echo "故障排查完成！"
echo "如果问题仍未解决，请查看详细SSH调试信息："
echo "ssh -vvv $SSH_USER@$TARGET_HOST"
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心知识


**🔸 SSH免密配置本质**：
- 基于公钥加密技术的身份认证机制
- 用公钥私钥对替代用户名密码认证
- MHA高可用架构的必需基础配置

**🔸 核心操作命令**：
```bash
# 生成密钥对
ssh-keygen -t rsa -b 2048

# 分发公钥
ssh-copy-id root@目标服务器

# 测试连接
ssh root@目标服务器

# MHA连接检查
masterha_check_ssh --conf=/etc/mha/app1.cnf
```

**🔸 关键文件和权限**：
```bash
~/.ssh/                 (700)  # SSH目录
~/.ssh/id_rsa          (600)  # 私钥文件
~/.ssh/id_rsa.pub      (644)  # 公钥文件
~/.ssh/authorized_keys (600)  # 授权密钥文件
~/.ssh/known_hosts     (644)  # 已知主机文件
```

### 8.2 MHA架构SSH配置要求


**🎯 配置范围**：
- **Manager → 所有MySQL节点**：必须配置
- **MySQL节点之间**：相互免密连接
- **双向通信**：每个节点都能免密连接到其他节点

**⚡ 配置验证**：
```bash
# SSH连接检查
masterha_check_ssh --conf=/etc/mha/app1.cnf

# 复制检查（包含SSH测试）
masterha_check_repl --conf=/etc/mha/app1.cnf
```

### 8.3 常见问题快速解决


| 问题类型 | **快速解决方案** |
|---------|-----------------|
| `Permission denied` | `检查权限：chmod 700 ~/.ssh; chmod 600 ~/.ssh/*` |
| `Host key verification failed` | `删除旧记录：ssh-keygen -R IP地址` |
| `Connection refused` | `检查服务：systemctl start sshd` |
| `No route to host` | `检查网络和防火墙配置` |

### 8.4 生产环境最佳实践


**🔐 安全建议**：
- 使用RSA 2048位或更高强度密钥
- 定期轮换SSH密钥
- 限制SSH访问来源IP
- 监控SSH登录日志
- 备份重要密钥文件

**⚡ 运维建议**：
- 使用自动化脚本批量配置
- 建立SSH连接监控
- 文档化密钥管理流程
- 制定应急处理预案

**核心记忆**：
- SSH免密是MHA的基础要求，不是可选项
- 权限设置必须严格按照标准执行
- 双向免密配置确保MHA功能完整
- 自动化脚本提高配置效率和准确性