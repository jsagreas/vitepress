---
title: 15、MHA故障切换演练
---
## 📚 目录

1. [故障切换演练概述](#1-故障切换演练概述)
2. [演练计划制定](#2-演练计划制定)
3. [主库故障模拟方法](#3-主库故障模拟方法)
4. [切换过程监控与测量](#4-切换过程监控与测量)
5. [数据一致性验证](#5-数据一致性验证)
6. [应用影响评估](#6-应用影响评估)
7. [回滚演练](#7-回滚演练)
8. [演练报告编写](#8-演练报告编写)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 故障切换演练概述


### 1.1 演练的重要意义


**什么是故障切换演练？**
故障切换演练就是**人为模拟数据库主库发生故障**，测试MHA能否正常完成自动切换的过程。这就像消防演习一样，平时多练习，真正出问题时才不会手忙脚乱。

```
现实场景对比：
消防演习 → 模拟火灾，练习逃生
故障演练 → 模拟主库故障，练习切换

目的都是：提前发现问题，确保关键时刻能正常运行
```

**为什么要做演练？**
- 🔍 **验证MHA配置是否正确**：确保切换能正常进行
- ⏱️ **测量切换时间**：了解业务中断时长
- 🎯 **训练运维团队**：熟悉故障处理流程
- 📊 **评估业务影响**：了解故障对应用的具体影响

### 1.2 演练类型分类


**按故障类型分类：**
```
硬件故障模拟：
├── 服务器宕机         # 模拟主库服务器完全宕机
├── 网络中断           # 模拟网络连接问题
├── 磁盘故障           # 模拟存储设备损坏
└── 内存不足           # 模拟系统资源耗尽

软件故障模拟：
├── MySQL进程异常      # 模拟数据库进程崩溃
├── 复制中断           # 模拟主从复制异常
├── 连接数耗尽         # 模拟连接池满载
└── SQL执行异常        # 模拟大查询阻塞
```

**按演练规模分类：**
- **桌面演练**：理论推演，不实际操作
- **功能演练**：单个功能测试
- **全面演练**：完整的端到端测试

---

## 2. 📋 演练计划制定


### 2.1 演练前准备清单


**环境准备检查项：**

| 检查项目 | **检查内容** | **预期结果** |
|---------|-------------|-------------|
| 🔧 **MHA配置** | `masterha_check_repl` 检查复制 | `MySQL Replication Health is OK` |
| 🔧 **MHA配置** | `masterha_check_ssh` 检查SSH | `SSH connection OK` |
| 📊 **监控系统** | 确认监控工具正常 | 能够记录切换过程 |
| 👥 **人员到位** | 运维、开发、业务人员就位 | 关键人员在线 |
| 📞 **通知机制** | 测试告警通知是否正常 | 能正常接收告警 |

**数据备份确认：**
```bash
# 演练前必须确保有完整备份
mysqldump --all-databases --master-data=2 > backup_before_drill.sql

# 记录当前主库状态
mysql> SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000123 |     4567 |              |                  |
+------------------+----------+--------------+------------------+
```

### 2.2 演练时间规划


**时间安排建议：**
```
演练总时长：2-4小时

时间分配：
├── 准备阶段：30分钟     # 环境检查、人员就位
├── 演练执行：60分钟     # 实际故障模拟和切换
├── 验证阶段：60分钟     # 数据一致性检查
├── 恢复阶段：30分钟     # 环境恢复
└── 总结阶段：30分钟     # 演练总结和报告

最佳演练时间：
✅ 业务低峰期（如凌晨2-6点）
✅ 非工作日（周末）
❌ 避免业务高峰期
❌ 避免重要活动期间
```

### 2.3 角色分工


```
演练角色分工表：

指挥官（1人）：
├── 总体协调演练过程
├── 决策关键问题
└── 对外沟通协调

执行员（2-3人）：
├── 执行具体操作命令
├── 监控系统状态
└── 记录操作日志

监控员（1-2人）：
├── 实时监控各项指标
├── 记录切换时间
└── 观察应用状态

业务验证员（1-2人）：
├── 验证业务功能
├── 检查数据正确性
└── 评估用户影响
```

---

## 3. ⚡ 主库故障模拟方法


### 3.1 进程级故障模拟


**方法1：Kill MySQL进程**
```bash
# 查找MySQL主进程ID
ps aux | grep mysqld
# root      1234  0.1  2.3 1234567 234567 ?   Sl   Jan01   1:23 /usr/sbin/mysqld

# 模拟进程崩溃（温和方式）
kill 1234

# 模拟进程强制终止（暴力方式）
kill -9 1234

# 验证进程确实停止
ps aux | grep mysqld | grep -v grep
```

> **💡 提示**：`kill` 命令模拟的是MySQL进程异常退出，这是生产环境中最常见的故障类型。

**方法2：停止MySQL服务**
```bash
# 使用系统服务命令停止
systemctl stop mysqld
# 或者
service mysqld stop

# 验证服务状态
systemctl status mysqld
```

### 3.2 网络级故障模拟


**方法1：iptables阻断连接**
```bash
# 阻断MySQL端口3306的连接
iptables -A INPUT -p tcp --dport 3306 -j DROP
iptables -A OUTPUT -p tcp --sport 3306 -j DROP

# 验证连接被阻断
mysql -h master_ip -u root -p
# ERROR 2003 (HY000): Can't connect to MySQL server

# 恢复网络（演练结束后）
iptables -D INPUT -p tcp --dport 3306 -j DROP
iptables -D OUTPUT -p tcp --sport 3306 -j DROP
```

**方法2：断开网络接口**
```bash
# 临时禁用网络接口
ifdown eth0

# 验证网络不通
ping master_ip
# ping: sendmsg: Network is unreachable

# 恢复网络
ifup eth0
```

### 3.3 系统级故障模拟


**方法1：服务器重启**
```bash
# 立即重启服务器
reboot

# 强制重启（模拟断电）
echo 1 > /proc/sys/kernel/sysrq
echo b > /proc/sysrq-trigger
```

**方法2：磁盘故障模拟**
```bash
# 模拟磁盘只读（谨慎操作）
mount -o remount,ro /var/lib/mysql

# 验证磁盘状态
touch /var/lib/mysql/test_file
# touch: cannot touch '/var/lib/mysql/test_file': Read-only file system
```

### 3.4 故障模拟最佳实践


```
故障选择建议：

🔰 初次演练：
推荐使用 kill MySQL进程
原因：影响范围小，容易控制和恢复

🔥 进阶演练：
使用网络中断模拟
原因：更接近真实故障场景

💀 高级演练：
服务器直接重启
原因：最真实的硬件故障模拟

⚠️ 注意事项：
1. 从轻到重，循序渐进
2. 确保有完整的回滚方案
3. 在测试环境先验证
4. 准备多种故障恢复方法
```

---

## 4. ⏱️ 切换过程监控与测量


### 4.1 关键时间点监控


**切换时间关键节点：**
```
故障切换时间线：

T0: 故障发生时间
 ↓ (故障检测时间)
T1: MHA检测到故障
 ↓ (决策时间)  
T2: 开始执行切换
 ↓ (切换执行时间)
T3: 新主库启动完成
 ↓ (应用切换时间)
T4: 应用连接到新主库
 ↓ (验证时间)
T5: 业务完全恢复

总切换时间 = T5 - T0
MHA切换时间 = T3 - T1
```

**监控命令和方法：**
```bash
# 1. 监控MHA Manager日志
tail -f /var/log/masterha/app1/manager.log

# 2. 监控MySQL错误日志
tail -f /var/log/mysqld.log

# 3. 实时监控复制状态
watch -n 1 "mysql -e 'SHOW SLAVE STATUS\G' | grep -E 'Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master'"

# 4. 监控连接数变化
watch -n 1 "mysql -e 'SHOW STATUS LIKE \"Threads_connected\"'"
```

### 4.2 性能指标采集


**关键监控指标：**

| 监控维度 | **具体指标** | **正常值范围** | **异常阈值** |
|---------|-------------|---------------|-------------|
| 🕐 **时间指标** | 故障检测时间 | < 30秒 | > 60秒 |
| 🕐 **时间指标** | 切换执行时间 | < 60秒 | > 120秒 |
| 🕐 **时间指标** | 应用恢复时间 | < 30秒 | > 60秒 |
| 📊 **连接指标** | 连接数变化 | 平滑过渡 | 大幅波动 |
| 📊 **延迟指标** | 复制延迟 | < 1秒 | > 5秒 |

**监控脚本示例：**
```bash
#!/bin/bash
# failover_monitor.sh - 故障切换监控脚本

LOG_FILE="/tmp/failover_monitor.log"
START_TIME=$(date +%s)

echo "开始监控故障切换过程..." | tee -a $LOG_FILE
echo "开始时间: $(date)" | tee -a $LOG_FILE

# 循环监控直到切换完成
while true; do
    CURRENT_TIME=$(date +%s)
    ELAPSED=$((CURRENT_TIME - START_TIME))
    
    # 检查MHA状态
    MHA_STATUS=$(masterha_check_status --conf=/etc/masterha/app1.cnf)
    
    # 检查当前主库
    CURRENT_MASTER=$(mysql -h vip -e "SELECT $$hostname" 2>/dev/null)
    
    echo "[$ELAPSED秒] MHA状态: $MHA_STATUS, 当前主库: $CURRENT_MASTER" | tee -a $LOG_FILE
    
    # 如果检测到新主库，则退出监控
    if [[ $CURRENT_MASTER != "original_master" ]]; then
        echo "检测到主库切换完成！" | tee -a $LOG_FILE
        break
    fi
    
    sleep 5
done
```

### 4.3 日志收集与分析


**重要日志文件位置：**
```
MHA相关日志：
├── /var/log/masterha/app1/manager.log      # MHA Manager日志
├── /var/log/masterha/app1/app1.failover.log # 故障切换详细日志
└── /tmp/masterha_check_*.log               # 健康检查日志

MySQL相关日志：
├── /var/log/mysqld.log                     # MySQL错误日志
├── /var/lib/mysql/mysql-bin.000xxx         # 二进制日志
└── /var/lib/mysql/relay-log.000xxx         # 中继日志

系统相关日志：
├── /var/log/messages                       # 系统日志
├── /var/log/secure                         # 安全日志
└── /var/log/network                        # 网络日志
```

---

## 5. ✅ 数据一致性验证


### 5.1 基础一致性检查


**检查主从数据同步状态：**
```sql
-- 在新主库上检查
SHOW MASTER STATUS;

-- 在从库上检查
SHOW SLAVE STATUS\G

-- 关键字段解释：
-- Slave_IO_Running: Yes     # IO线程正常运行
-- Slave_SQL_Running: Yes    # SQL线程正常运行  
-- Seconds_Behind_Master: 0  # 复制延迟为0
-- Last_Error: (空)          # 没有复制错误
```

**数据行数对比检查：**
```sql
-- 主要业务表行数统计
SELECT 
    TABLE_NAME,
    TABLE_ROWS 
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY TABLE_NAME;

-- 对比切换前后的表行数
-- 如果有差异，需要进一步分析原因
```

### 5.2 校验和数据一致性


**使用pt-table-checksum工具：**
```bash
# 安装percona-toolkit
yum install percona-toolkit

# 执行数据一致性检查
pt-table-checksum \
  --host=new_master_ip \
  --user=checksum_user \
  --password=password \
  --databases=your_database \
  --chunk-size=1000

# 检查结果解读：
# DIFFS=0 表示数据一致
# DIFFS>0 表示有数据不一致，需要修复
```

**手动抽样验证：**
```sql
-- 选择几个关键业务表进行抽样检查
-- 例：订单表最近的记录
SELECT * FROM orders 
WHERE created_time > '2024-01-15 14:00:00' 
ORDER BY id DESC 
LIMIT 10;

-- 比较主库和从库的结果是否一致
-- 重点关注：
-- 1. 记录总数是否一致
-- 2. 最新记录是否一致  
-- 3. 关键字段值是否一致
```

### 5.3 业务数据验证


**核心业务指标检查：**
```sql
-- 1. 用户账户余额汇总
SELECT SUM(balance) as total_balance 
FROM user_accounts;

-- 2. 今日订单总额
SELECT COUNT(*) as order_count, SUM(amount) as total_amount
FROM orders 
WHERE DATE(created_time) = CURDATE();

-- 3. 库存数据一致性
SELECT product_id, SUM(stock_quantity) as total_stock
FROM inventory 
GROUP BY product_id
HAVING total_stock < 0;  -- 检查是否有负库存异常
```

**切换前后对比表：**

| 验证项目 | **切换前** | **切换后** | **状态** |
|---------|-----------|-----------|---------|
| 📊 总订单数 | 1,234,567 | 1,234,567 | ✅ 一致 |
| 💰 账户余额总计 | 8,765,432.10 | 8,765,432.10 | ✅ 一致 |
| 📦 商品库存总数 | 98,765 | 98,765 | ✅ 一致 |
| 👥 在线用户数 | 2,345 | 2,340 | ⚠️ 轻微差异 |

---

## 6. 📊 应用影响评估


### 6.1 应用连接监控


**连接池状态检查：**
```bash
# 应用服务器上检查数据库连接
netstat -an | grep :3306 | wc -l

# 应用日志中的连接异常
grep -i "connection" /var/log/application.log | tail -20

# 检查应用是否能正常连接新主库
mysql -h new_master_ip -u app_user -p -e "SELECT 1"
```

**应用响应时间监控：**
```
正常情况下的响应时间基线：
├── 用户登录接口：< 200ms
├── 商品查询接口：< 500ms  
├── 订单创建接口：< 1000ms
└── 数据报表接口：< 5000ms

故障切换期间的响应时间：
├── 故障期间：请求超时或失败
├── 切换完成后：可能比平时慢20-50%
├── 完全恢复后：恢复到正常水平
└── 预期恢复时间：5-10分钟
```

### 6.2 用户体验影响


**用户请求失败统计：**
```bash
# 统计应用错误日志中的数据库相关错误
awk '/数据库连接失败|连接超时|无法连接/ {count++} END {print "错误次数:", count}' /var/log/app.log

# HTTP状态码统计（如果有nginx日志）
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr
#   1250 200    # 正常请求
#     45 500    # 服务器错误（可能是数据库连接问题）
#     12 503    # 服务不可用
```

**业务功能影响评估表：**

| 业务功能 | **影响等级** | **影响时长** | **影响描述** |
|---------|-------------|-------------|-------------|
| 🔐 用户登录 | **高** | 2-3分钟 | 无法验证用户身份 |
| 🛒 商品浏览 | **中** | 1-2分钟 | 商品信息无法加载 |
| 💳 在线支付 | **高** | 2-3分钟 | 支付流程中断 |
| 📊 数据报表 | **低** | 5-10分钟 | 报表生成延迟 |

### 6.3 性能基线对比


**数据库性能指标对比：**
```sql
-- 切换前后的QPS对比
SHOW GLOBAL STATUS LIKE 'Queries';
SHOW GLOBAL STATUS LIKE 'Questions';

-- 连接数对比  
SHOW GLOBAL STATUS LIKE 'Threads_connected';
SHOW GLOBAL STATUS LIKE 'Max_used_connections';

-- 锁等待情况
SHOW GLOBAL STATUS LIKE 'Table_locks_waited';
SHOW GLOBAL STATUS LIKE 'Innodb_row_lock_waits';
```

---

## 7. 🔄 回滚演练


### 7.1 回滚场景设计


**什么时候需要回滚？**
- ❌ **新主库性能严重下降**：响应时间超过可接受范围
- ❌ **数据一致性问题**：发现数据丢失或不一致
- ❌ **应用兼容性问题**：应用无法正常连接新主库
- ❌ **业务功能异常**：关键业务功能无法正常工作

### 7.2 回滚操作步骤


**步骤1：评估回滚可行性**
```bash
# 检查原主库是否可以恢复
ssh original_master "systemctl status mysqld"

# 检查原主库数据完整性
ssh original_master "mysqlcheck --all-databases"

# 评估数据差异
# 如果切换后有新数据写入，回滚会更复杂
```

**步骤2：准备回滚环境**
```bash
# 停止应用写入（重要！）
# 将应用设置为只读模式或维护模式

# 备份当前新主库数据
mysqldump --all-databases --master-data=2 > backup_new_master.sql

# 记录新主库的binlog位置
mysql> SHOW MASTER STATUS;
```

**步骤3：执行回滚切换**
```bash
# 方法1：如果原主库可以直接启动
systemctl start mysqld

# 方法2：如果需要从备份恢复原主库
mysql < backup_before_drill.sql

# 重新配置VIP到原主库
# 具体操作取决于VIP实现方式（keepalived/MHA VIP等）
```

### 7.3 回滚验证清单


```
回滚后验证项目：

✅ 数据库服务状态
├── 原主库MySQL服务正常启动
├── 从库复制正常连接到原主库
└── 所有节点状态健康

✅ 数据一致性检查
├── 关键业务数据完整
├── 数据表行数正确
└── 业务指标数值正确

✅ 应用功能验证
├── 应用能正常连接数据库
├── 关键业务功能正常
└── 性能指标恢复正常

✅ 监控告警状态
├── 数据库监控指标正常
├── 应用监控指标正常
└── 无异常告警信息
```

---

## 8. 📝 演练报告编写


### 8.1 报告基本结构


```
故障切换演练报告模板：

1. 演练概要
   ├── 演练时间、参与人员
   ├── 演练目标和范围
   └── 演练环境描述

2. 演练执行过程
   ├── 故障模拟方法
   ├── 切换执行步骤
   └── 遇到的问题和解决方法

3. 关键指标统计
   ├── 切换时间统计
   ├── 业务影响评估
   └── 数据一致性结果

4. 问题和改进建议
   ├── 发现的配置问题
   ├── 流程优化建议
   └── 监控改进建议

5. 附录
   ├── 详细操作日志
   ├── 监控截图
   └── 配置文件变更记录
```

### 8.2 关键数据统计


**切换时间统计表：**
```
时间节点统计：

故障发生时间：    2024-01-15 14:30:00
MHA检测时间：     2024-01-15 14:30:25  (延迟: 25秒)
开始切换时间：    2024-01-15 14:30:35  (延迟: 35秒)  
切换完成时间：    2024-01-15 14:31:20  (总耗时: 80秒)
应用恢复时间：    2024-01-15 14:31:45  (总耗时: 105秒)
业务完全恢复：    2024-01-15 14:32:30  (总耗时: 150秒)

关键指标：
├── MHA故障检测时间：25秒  (目标: <30秒) ✅
├── 切换执行时间：45秒     (目标: <60秒) ✅  
├── 总业务中断时间：150秒  (目标: <180秒) ✅
└── 数据丢失：0条记录      (目标: 0) ✅
```

**问题记录表：**

| 问题类型 | **具体问题** | **影响程度** | **解决方案** | **状态** |
|---------|-------------|-------------|-------------|---------|
| ⚠️ **配置问题** | SSH密钥权限不正确 | **中** | 重新配置密钥权限 | ✅ 已解决 |
| ⚠️ **监控问题** | 告警延迟5分钟才收到 | **高** | 优化告警配置 | 🔄 进行中 |
| ⚠️ **应用问题** | 连接池配置偏小 | **中** | 增加连接池大小 | ✅ 已解决 |

### 8.3 改进建议总结


**短期改进建议（1周内）：**
```
🔧 配置优化：
├── 调整MHA检测间隔从30秒到15秒
├── 优化SSH连接超时时间配置
└── 增加应用连接池大小到200

📊 监控优化：
├── 添加切换时间监控指标
├── 设置更细粒度的告警阈值
└── 增加业务层面的健康检查

📖 流程优化：
├── 更新故障处理操作手册
├── 制定标准的回滚操作流程
└── 建立演练后问题跟踪机制
```

**长期改进建议（1个月内）：**
```
🏗️ 架构优化：
├── 考虑部署多主架构减少切换时间
├── 评估读写分离降低主库压力
└── 研究容器化部署提高可用性

🎓 团队建设：
├── 定期进行故障切换培训
├── 建立故障处理专家团队
└── 制定应急响应标准流程

🔄 持续改进：
├── 每季度进行一次全面演练
├── 建立演练效果评估机制
└── 持续优化演练场景和流程
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的关键点


```
🔸 演练目的：验证MHA配置、测量切换时间、训练团队、评估影响
🔸 故障模拟：进程kill、网络中断、服务器重启等多种方式
🔸 时间监控：检测时间、切换时间、恢复时间等关键节点
🔸 一致性验证：数据行数、校验和、业务指标等多维度检查
🔸 影响评估：连接状态、响应时间、用户体验等方面评估
🔸 回滚准备：确保有完整的回滚方案和验证机制
🔸 报告编写：详细记录过程、问题、指标和改进建议
```

### 9.2 演练成功的关键要素


**🔹 充分的准备工作**
```
环境检查：
- MHA配置正确性验证
- 监控系统正常运行  
- 备份数据完整可用
- 团队人员培训到位

计划制定：
- 详细的演练步骤
- 明确的角色分工
- 完整的时间安排
- 充分的风险评估
```

**🔹 规范的执行流程**
```
操作规范：
- 严格按照预定计划执行
- 实时记录关键时间节点
- 多人确认重要操作
- 保持沟通渠道畅通

监控重点：
- 切换过程全程监控
- 关键指标实时采集
- 异常情况及时响应
- 详细日志完整保存
```

**🔹 全面的验证检查**
```
技术验证：
- 数据库服务状态正常
- 复制关系重新建立
- 数据一致性完全验证
- 性能指标恢复正常

业务验证：
- 应用功能正常可用
- 用户访问体验正常
- 关键业务指标正确
- 监控告警状态正常
```

### 9.3 常见问题和解决方案


**🔹 切换时间过长问题**
```
可能原因：
- SSH连接配置不当
- 网络延迟较高
- 从库数据延迟较大
- MHA配置参数不合理

解决方案：
- 优化SSH连接配置
- 使用更快的网络链路
- 提前确保主从同步
- 调整MHA检测参数
```

**🔹 数据一致性问题**
```
可能原因：
- 切换时有未提交事务
- 二进制日志位置不准确
- 从库复制延迟较大
- 应用写入时机不当

解决方案：
- 使用半同步复制
- 严格控制切换时机
- 监控复制延迟状态
- 应用层面配合切换
```

### 9.4 最佳实践建议


**🎯 演练频率建议**
- **月度演练**：基础功能验证，持续30分钟
- **季度演练**：全面场景测试，持续2-4小时
- **年度演练**：极端场景模拟，包含容灾切换

**🎯 团队能力建设**
- **轮岗培训**：确保多人掌握操作技能
- **文档维护**：及时更新操作手册和流程
- **经验分享**：定期分享故障处理经验

**核心记忆要点**：
- 故障演练如消防演习，平时多练关键时刻不慌
- 监控切换过程每个时间节点，量化分析改进效果
- 数据一致性是底线，业务影响要最小化
- 演练不是目的，通过演练发现问题持续改进才是核心