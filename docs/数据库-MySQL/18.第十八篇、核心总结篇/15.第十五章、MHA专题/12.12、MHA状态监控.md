---
title: 12ã€MHAçŠ¶æ€ç›‘æŽ§
---
## ðŸ“š ç›®å½•

1. [MHAç›‘æŽ§æ¦‚è¿°](#1-MHAç›‘æŽ§æ¦‚è¿°)
2. [åŸºç¡€çŠ¶æ€æ£€æŸ¥å‘½ä»¤](#2-åŸºç¡€çŠ¶æ€æ£€æŸ¥å‘½ä»¤)
3. [é…ç½®çŠ¶æ€éªŒè¯](#3-é…ç½®çŠ¶æ€éªŒè¯)
4. [æ—¥å¿—æ–‡ä»¶ç›‘æŽ§](#4-æ—¥å¿—æ–‡ä»¶ç›‘æŽ§)
5. [è¿›ç¨‹ä¸Žèµ„æºç›‘æŽ§](#5-è¿›ç¨‹ä¸Žèµ„æºç›‘æŽ§)
6. [ç½‘ç»œè¿žæŽ¥ç›‘æŽ§](#6-ç½‘ç»œè¿žæŽ¥ç›‘æŽ§)
7. [å‘Šè­¦é…ç½®ä¸Žç®¡ç†](#7-å‘Šè­¦é…ç½®ä¸Žç®¡ç†)
8. [ç›‘æŽ§è„šæœ¬å¼€å‘](#8-ç›‘æŽ§è„šæœ¬å¼€å‘)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ” MHAç›‘æŽ§æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æŽ§MHA


**ç®€å•ç†è§£**ï¼šMHAå°±åƒå®¶é‡Œçš„ä¿é™©ç³»ç»Ÿï¼Œä½ å¾—æ—¶åˆ»çŸ¥é“å®ƒæ˜¯å¦æ­£å¸¸å·¥ä½œ

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å®¶é‡Œè£…äº†é˜²ç›—æŠ¥è­¦å™¨ â†’ éœ€è¦å®šæœŸæ£€æŸ¥æ˜¯å¦æ­£å¸¸
MHAé«˜å¯ç”¨ç³»ç»Ÿ    â†’ éœ€è¦ç›‘æŽ§å„ä¸ªç»„ä»¶çŠ¶æ€

ç›‘æŽ§çš„å¿…è¦æ€§ï¼š
âœ… åŠæ—¶å‘çŽ°é—®é¢˜ï¼Œé¿å…æ•…éšœæ—¶æ‰å‘çŽ°MHAä¸å¯ç”¨
âœ… ç¡®ä¿æ•…éšœåˆ‡æ¢èƒ½åŠ›å§‹ç»ˆå¯é 
âœ… é¢„é˜²æ€§ç»´æŠ¤ï¼Œé™ä½Žä¸šåŠ¡é£Žé™©
```

### 1.2 MHAç›‘æŽ§çš„æ ¸å¿ƒå†…å®¹


**ç›‘æŽ§å››å¤§ç»´åº¦**ï¼š
```
ðŸ”¸ è¿è¡ŒçŠ¶æ€ç›‘æŽ§
â€¢ MHA Manageræ˜¯å¦è¿è¡Œæ­£å¸¸
â€¢ å„èŠ‚ç‚¹è¿žæŽ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸
â€¢ ä¸»ä»Žå¤åˆ¶æ˜¯å¦å¥åº·

ðŸ”¸ é…ç½®çŠ¶æ€ç›‘æŽ§  
â€¢ é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
â€¢ SSHè¿žæŽ¥æ˜¯å¦å¯ç”¨
â€¢ å¤åˆ¶ç”¨æˆ·æƒé™æ˜¯å¦æ­£å¸¸

ðŸ”¸ èµ„æºçŠ¶æ€ç›‘æŽ§
â€¢ æœåŠ¡å™¨CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨çŽ‡
â€¢ ç½‘ç»œè¿žæŽ¥æ•°å’Œå»¶è¿Ÿ
â€¢ MySQLè¿›ç¨‹çŠ¶æ€

ðŸ”¸ æ—¥å¿—çŠ¶æ€ç›‘æŽ§
â€¢ é”™è¯¯æ—¥å¿—åˆ†æž
â€¢ æ€§èƒ½æ—¥å¿—ç›‘æŽ§
â€¢ å‘Šè­¦ä¿¡æ¯æ”¶é›†
```

### 1.3 ç›‘æŽ§æž¶æž„å›¾ç¤º


```
ç›‘æŽ§ä½“ç³»ç»“æž„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘Šè­¦ç³»ç»Ÿ       â”‚    â”‚   ç›‘æŽ§å¹³å°       â”‚
â”‚  (é‚®ä»¶/çŸ­ä¿¡)     â”‚    â”‚ (Grafana/Zabbix)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â”‚       ç›‘æŽ§æ•°æ®æ”¶é›†     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                â”‚                â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ MHA    â”‚    â”‚   MySQL   â”‚    â”‚  ç³»ç»Ÿèµ„æº  â”‚
â”‚ Managerâ”‚    â”‚   èŠ‚ç‚¹    â”‚    â”‚   ç›‘æŽ§    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš¡ åŸºç¡€çŠ¶æ€æ£€æŸ¥å‘½ä»¤


### 2.1 masterha_check_statuså‘½ä»¤è¯¦è§£


**æ ¸å¿ƒä½œç”¨**ï¼šæ£€æŸ¥MHA Managerå½“å‰çš„è¿è¡ŒçŠ¶æ€

**åŸºæœ¬è¯­æ³•**ï¼š
```bash
masterha_check_status --conf=/etc/masterha/app1.cnf
```

**å‘½ä»¤è¿”å›žç»“æžœè§£è¯»**ï¼š
```bash
# æ­£å¸¸è¿è¡ŒçŠ¶æ€
app1 (pid:12345) is running(0:PING_OK), master:192.168.1.10

# åœæ­¢çŠ¶æ€  
app1 is stopped(2:NOT_RUNNING).

# å¼‚å¸¸çŠ¶æ€
app1 is stopped(1:NOT_RUNNING).
```

**çŠ¶æ€ç å«ä¹‰è¯´æ˜Ž**ï¼š
| çŠ¶æ€ç  | å«ä¹‰ | è¯´æ˜Ž |
|--------|------|------|
| **0** | `PING_OK` | MHAæ­£å¸¸è¿è¡Œï¼Œä¸»åº“çŠ¶æ€è‰¯å¥½ |
| **1** | `NOT_RUNNING` | MHAæœªè¿è¡Œï¼Œå¯èƒ½æ˜¯å¼‚å¸¸åœæ­¢ |
| **2** | `NOT_RUNNING` | MHAæ­£å¸¸åœæ­¢ |
| **3** | `PARTIALLY_RUNNING` | MHAéƒ¨åˆ†è¿è¡Œï¼Œå­˜åœ¨é—®é¢˜ |

### 2.2 å®žç”¨çš„çŠ¶æ€æ£€æŸ¥è„šæœ¬


```bash
#!/bin/bash
# MHAçŠ¶æ€æ£€æŸ¥è„šæœ¬

MHA_CONF="/etc/masterha/app1.cnf"
LOG_FILE="/var/log/mha_check.log"

# èŽ·å–å½“å‰æ—¶é—´
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# æ£€æŸ¥MHAçŠ¶æ€
echo "[$TIMESTAMP] å¼€å§‹æ£€æŸ¥MHAçŠ¶æ€..." >> $LOG_FILE

STATUS_OUTPUT=$(masterha_check_status --conf=$MHA_CONF 2>&1)
STATUS_CODE=$?

if [ $STATUS_CODE -eq 0 ]; then
    echo "[$TIMESTAMP] âœ… MHAè¿è¡Œæ­£å¸¸: $STATUS_OUTPUT" >> $LOG_FILE
else
    echo "[$TIMESTAMP] âŒ MHAçŠ¶æ€å¼‚å¸¸: $STATUS_OUTPUT" >> $LOG_FILE
    # è¿™é‡Œå¯ä»¥æ·»åŠ å‘Šè­¦é€»è¾‘
    # send_alert "MHAçŠ¶æ€å¼‚å¸¸: $STATUS_OUTPUT"
fi
```

### 2.3 å®šæ—¶çŠ¶æ€æ£€æŸ¥


**è®¾ç½®å®šæ—¶ä»»åŠ¡**ï¼š
```bash
# ç¼–è¾‘crontab
crontab -e

# æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡MHAçŠ¶æ€
* * * * * /usr/local/bin/mha_status_check.sh

# æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆæŽ¨èï¼‰
*/5 * * * * /usr/local/bin/mha_status_check.sh
```

---

## 3. ðŸ”§ é…ç½®çŠ¶æ€éªŒè¯


### 3.1 masterha_conf_hostå‘½ä»¤è¯¦è§£


**æ ¸å¿ƒä½œç”¨**ï¼šéªŒè¯MHAé…ç½®æ–‡ä»¶ä¸­å„ä¸»æœºçš„è¿žæŽ¥çŠ¶æ€

**åŸºæœ¬è¯­æ³•**ï¼š
```bash
masterha_conf_host --conf=/etc/masterha/app1.cnf --host=192.168.1.10
```

**å‘½ä»¤æ‰§è¡Œè¿‡ç¨‹**ï¼š
```
æ£€æŸ¥æ­¥éª¤ï¼š
1. SSHè¿žæŽ¥æµ‹è¯•
2. MySQLè¿žæŽ¥æµ‹è¯•  
3. å¤åˆ¶ç”¨æˆ·æƒé™éªŒè¯
4. å¿…è¦å·¥å…·æ£€æŸ¥(mysqlbinlogç­‰)
```

### 3.2 å®Œæ•´é…ç½®æ£€æŸ¥è„šæœ¬


```bash
#!/bin/bash
# å®Œæ•´çš„MHAé…ç½®æ£€æŸ¥è„šæœ¬

MHA_CONF="/etc/masterha/app1.cnf"
HOSTS=("192.168.1.10" "192.168.1.11" "192.168.1.12")

echo "ðŸ” å¼€å§‹MHAé…ç½®æ£€æŸ¥..."

# æ£€æŸ¥æ¯ä¸ªä¸»æœº
for host in "${HOSTS[@]}"; do
    echo "æ­£åœ¨æ£€æŸ¥ä¸»æœº: $host"
    
    # SSHè¿žæŽ¥æ£€æŸ¥
    if ssh -o ConnectTimeout=5 $host "echo 'SSHè¿žæŽ¥æˆåŠŸ'" > /dev/null 2>&1; then
        echo "  âœ… SSHè¿žæŽ¥æ­£å¸¸"
    else
        echo "  âŒ SSHè¿žæŽ¥å¤±è´¥"
    fi
    
    # é…ç½®æ–‡ä»¶éªŒè¯
    masterha_conf_host --conf=$MHA_CONF --host=$host
    
    if [ $? -eq 0 ]; then
        echo "  âœ… ä¸»æœº $host é…ç½®éªŒè¯é€šè¿‡"
    else
        echo "  âŒ ä¸»æœº $host é…ç½®éªŒè¯å¤±è´¥"
    fi
    echo ""
done
```

### 3.3 é…ç½®æ£€æŸ¥çš„å…³é”®ç‚¹


**SSHè¿žæŽ¥æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥SSHå…å¯†ç™»å½•
ssh mysql@192.168.1.10 "whoami"

# æ£€æŸ¥SSHå¯†é’¥
ls -la ~/.ssh/id_rsa*
```

**MySQLè¿žæŽ¥æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥å¤åˆ¶ç”¨æˆ·
mysql -h192.168.1.10 -urepl -p'password' -e "SHOW GRANTS;"

# æ£€æŸ¥ç®¡ç†ç”¨æˆ·æƒé™
mysql -h192.168.1.10 -umha -p'password' -e "SHOW GRANTS;"
```

---

## 4. ðŸ“‹ æ—¥å¿—æ–‡ä»¶ç›‘æŽ§


### 4.1 MHAæ—¥å¿—æ–‡ä»¶ç±»åž‹


**æ—¥å¿—æ–‡ä»¶åˆ†ç±»**ï¼š
```
ðŸ”¸ Manageræ—¥å¿—
æ–‡ä»¶ä½ç½®: /var/log/masterha/app1/manager.log
ä½œç”¨: è®°å½•MHA Managerçš„è¿è¡ŒçŠ¶æ€å’Œå†³ç­–è¿‡ç¨‹

ðŸ”¸ æ•…éšœåˆ‡æ¢æ—¥å¿—
æ–‡ä»¶ä½ç½®: /var/log/masterha/app1/app1.failover.complete
ä½œç”¨: è®°å½•æ¯æ¬¡æ•…éšœåˆ‡æ¢çš„è¯¦ç»†è¿‡ç¨‹

ðŸ”¸ åœ¨çº¿åˆ‡æ¢æ—¥å¿—  
æ–‡ä»¶ä½ç½®: /var/log/masterha/app1/app1.master_switch.log
ä½œç”¨: è®°å½•æ‰‹åŠ¨ä¸»ä»Žåˆ‡æ¢çš„è¿‡ç¨‹

ðŸ”¸ èŠ‚ç‚¹æ—¥å¿—
æ–‡ä»¶ä½ç½®: /var/log/masterha/app1/node.log
ä½œç”¨: è®°å½•å„ä¸ªMySQLèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯
```

### 4.2 æ—¥å¿—ç›‘æŽ§è„šæœ¬


```bash
#!/bin/bash
# MHAæ—¥å¿—ç›‘æŽ§è„šæœ¬

LOG_DIR="/var/log/masterha/app1"
MANAGER_LOG="$LOG_DIR/manager.log"
ERROR_KEYWORDS=("ERROR" "FATAL" "failed" "timeout" "connection lost")

# ç›‘æŽ§Manageræ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
monitor_manager_log() {
    echo "ðŸ” ç›‘æŽ§Manageræ—¥å¿—..."
    
    # èŽ·å–æœ€è¿‘10åˆ†é’Ÿçš„æ—¥å¿—
    RECENT_LOGS=$(find $MANAGER_LOG -mmin -10 -exec tail -100 {} \;)
    
    for keyword in "${ERROR_KEYWORDS[@]}"; do
        if echo "$RECENT_LOGS" | grep -i "$keyword" > /dev/null; then
            echo "âš ï¸  å‘çŽ°é”™è¯¯å…³é”®å­—: $keyword"
            echo "$RECENT_LOGS" | grep -i "$keyword" | tail -5
        fi
    done
}

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
check_log_size() {
    LOG_SIZE=$(du -m $MANAGER_LOG | cut -f1)
    if [ $LOG_SIZE -gt 100 ]; then
        echo "âš ï¸  æ—¥å¿—æ–‡ä»¶è¿‡å¤§: ${LOG_SIZE}MBï¼Œå»ºè®®æ¸…ç†"
    fi
}

# æ‰§è¡Œç›‘æŽ§
monitor_manager_log
check_log_size
```

### 4.3 æ—¥å¿—åˆ†æžè¦ç‚¹


**å…³é”®é”™è¯¯ä¿¡æ¯**ï¼š
```bash
# ä¸»åº“è¿žæŽ¥å¤±è´¥
grep "Connection lost" /var/log/masterha/app1/manager.log

# ä»Žåº“å»¶è¿Ÿè¿‡å¤§
grep "Slave lag" /var/log/masterha/app1/manager.log

# æ•…éšœåˆ‡æ¢è§¦å‘
grep "Started automated failover" /var/log/masterha/app1/manager.log
```

---

## 5. ðŸ’» è¿›ç¨‹ä¸Žèµ„æºç›‘æŽ§


### 5.1 MHAè¿›ç¨‹ç›‘æŽ§


**æ ¸å¿ƒMHAè¿›ç¨‹**ï¼š
```bash
# æŸ¥çœ‹MHA Managerè¿›ç¨‹
ps aux | grep masterha_manager | grep -v grep

# æŸ¥çœ‹è¿›ç¨‹è¯¦ç»†ä¿¡æ¯
pgrep -f masterha_manager | xargs ps -p

# è¿›ç¨‹èµ„æºä½¿ç”¨æƒ…å†µ
top -p $(pgrep -f masterha_manager)
```

**è¿›ç¨‹ç›‘æŽ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# MHAè¿›ç¨‹ç›‘æŽ§è„šæœ¬

check_mha_process() {
    MHA_PID=$(pgrep -f masterha_manager)
    
    if [ -z "$MHA_PID" ]; then
        echo "âŒ MHA Managerè¿›ç¨‹æœªè¿è¡Œ"
        return 1
    else
        echo "âœ… MHA Managerè¿›ç¨‹è¿è¡Œæ­£å¸¸ (PID: $MHA_PID)"
        
        # æ£€æŸ¥è¿›ç¨‹èµ„æºä½¿ç”¨
        PROCESS_INFO=$(ps -p $MHA_PID -o pid,pcpu,pmem,etime,cmd)
        echo "$PROCESS_INFO"
    fi
}

check_mha_process
```

### 5.2 ç³»ç»Ÿèµ„æºç›‘æŽ§


**èµ„æºç›‘æŽ§æŒ‡æ ‡**ï¼š
```bash
# CPUä½¿ç”¨çŽ‡æ£€æŸ¥
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
echo "CPUä½¿ç”¨çŽ‡: ${CPU_USAGE}%"

# å†…å­˜ä½¿ç”¨çŽ‡æ£€æŸ¥  
MEM_INFO=$(free | grep Mem)
MEM_TOTAL=$(echo $MEM_INFO | awk '{print $2}')
MEM_USED=$(echo $MEM_INFO | awk '{print $3}')
MEM_USAGE=$(awk "BEGIN {printf \"%.1f\", $MEM_USED/$MEM_TOTAL*100}")
echo "å†…å­˜ä½¿ç”¨çŽ‡: ${MEM_USAGE}%"

# ç£ç›˜ä½¿ç”¨çŽ‡æ£€æŸ¥
DISK_USAGE=$(df -h | grep -vE '^Filesystem|tmpfs|cdrom' | awk '{print $5}' | cut -d'%' -f1 | sort -n | tail -1)
echo "ç£ç›˜ä½¿ç”¨çŽ‡: ${DISK_USAGE}%"
```

### 5.3 MySQLè¿›ç¨‹ç›‘æŽ§


```bash
#!/bin/bash
# MySQLè¿›ç¨‹ç›‘æŽ§

check_mysql_process() {
    MYSQL_PROCESSES=$(ps aux | grep mysqld | grep -v grep | wc -l)
    
    if [ $MYSQL_PROCESSES -eq 0 ]; then
        echo "âŒ MySQLè¿›ç¨‹æœªè¿è¡Œ"
    else
        echo "âœ… MySQLè¿›ç¨‹è¿è¡Œæ­£å¸¸ (è¿›ç¨‹æ•°: $MYSQL_PROCESSES)"
        
        # æ£€æŸ¥MySQLè¿žæŽ¥æ•°
        CONNECTIONS=$(mysql -e "SHOW STATUS LIKE 'Threads_connected';" | awk 'NR==2{print $2}')
        echo "å½“å‰è¿žæŽ¥æ•°: $CONNECTIONS"
        
        # æ£€æŸ¥MySQLçŠ¶æ€
        mysql -e "SHOW SLAVE STATUS\G" | grep -E "(Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master)"
    fi
}

check_mysql_process
```

---

## 6. ðŸŒ ç½‘ç»œè¿žæŽ¥ç›‘æŽ§


### 6.1 ç½‘ç»œè¿žæŽ¥çŠ¶æ€æ£€æŸ¥


**ç½‘ç»œè¿žé€šæ€§æµ‹è¯•**ï¼š
```bash
#!/bin/bash
# ç½‘ç»œè¿žæŽ¥ç›‘æŽ§è„šæœ¬

MYSQL_HOSTS=("192.168.1.10" "192.168.1.11" "192.168.1.12")
MYSQL_PORT=3306

# æ£€æŸ¥MySQLç«¯å£è¿žé€šæ€§
check_mysql_connectivity() {
    for host in "${MYSQL_HOSTS[@]}"; do
        echo "æ£€æŸ¥ $host:$MYSQL_PORT è¿žé€šæ€§..."
        
        # ä½¿ç”¨telnetæ£€æŸ¥ç«¯å£
        timeout 5 bash -c "echo >/dev/tcp/$host/$MYSQL_PORT" 2>/dev/null
        
        if [ $? -eq 0 ]; then
            echo "  âœ… $host MySQLç«¯å£è¿žé€šæ­£å¸¸"
        else
            echo "  âŒ $host MySQLç«¯å£è¿žæŽ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
        PING_TIME=$(ping -c 1 $host | grep "time=" | awk -F'time=' '{print $2}' | awk '{print $1}')
        echo "  ðŸ“¶ ç½‘ç»œå»¶è¿Ÿ: $PING_TIME"
    done
}

check_mysql_connectivity
```

### 6.2 MySQLè¿žæŽ¥æ± ç›‘æŽ§


```bash
# æ£€æŸ¥MySQLè¿žæŽ¥çŠ¶æ€
mysql -e "
SELECT 
    SUBSTRING_INDEX(host, ':', 1) as client_ip,
    COUNT(*) as connection_count,
    user,
    command,
    state
FROM information_schema.processlist 
WHERE user != 'system user'
GROUP BY client_ip, user, command, state
ORDER BY connection_count DESC;
"

# æ£€æŸ¥è¿žæŽ¥æ•°é™åˆ¶
mysql -e "SHOW VARIABLES LIKE 'max_connections';"
mysql -e "SHOW STATUS LIKE 'Threads_connected';"
```

### 6.3 ç½‘ç»œæ€§èƒ½ç›‘æŽ§


```bash
#!/bin/bash
# ç½‘ç»œæ€§èƒ½ç›‘æŽ§

# æ£€æŸ¥ç½‘ç»œå¸¦å®½ä½¿ç”¨
check_network_bandwidth() {
    echo "ðŸ“Š ç½‘ç»œå¸¦å®½ä½¿ç”¨æƒ…å†µ:"
    sar -n DEV 1 3 | grep -E "(eth0|ens|bond)"
}

# æ£€æŸ¥ç½‘ç»œè¿žæŽ¥æ•°
check_network_connections() {
    echo "ðŸ”— ç½‘ç»œè¿žæŽ¥ç»Ÿè®¡:"
    netstat -an | awk '/tcp/ {state[$6]++} END {for(i in state) print i, state[i]}'
}

check_network_bandwidth
check_network_connections
```

---

## 7. ðŸš¨ å‘Šè­¦é…ç½®ä¸Žç®¡ç†


### 7.1 å‘Šè­¦è§„åˆ™è®¾è®¡


**å‘Šè­¦çº§åˆ«åˆ†ç±»**ï¼š
```
ðŸ”´ ç´§æ€¥å‘Šè­¦ (Critical)
â€¢ MHA Managerè¿›ç¨‹åœæ­¢
â€¢ ä¸»åº“å®•æœº
â€¢ æ•…éšœåˆ‡æ¢å¤±è´¥

ðŸŸ¡ è­¦å‘Šå‘Šè­¦ (Warning)  
â€¢ ä»Žåº“å»¶è¿Ÿè¿‡å¤§
â€¢ è¿žæŽ¥æ•°æŽ¥è¿‘ä¸Šé™
â€¢ ç£ç›˜ç©ºé—´ä¸è¶³

ðŸŸ¢ ä¿¡æ¯å‘Šè­¦ (Info)
â€¢ æ•…éšœåˆ‡æ¢æˆåŠŸ
â€¢ é…ç½®å˜æ›´
â€¢ å®šæœŸå¥åº·æ£€æŸ¥æŠ¥å‘Š
```

### 7.2 é‚®ä»¶å‘Šè­¦è„šæœ¬


```bash
#!/bin/bash
# é‚®ä»¶å‘Šè­¦è„šæœ¬

MAIL_TO="admin@company.com"
MAIL_SUBJECT_PREFIX="[MHAç›‘æŽ§]"

send_alert() {
    local alert_level=$1
    local alert_message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # æ ¹æ®å‘Šè­¦çº§åˆ«è®¾ç½®ä¸»é¢˜
    case $alert_level in
        "CRITICAL")
            subject="$MAIL_SUBJECT_PREFIX ðŸ”´ç´§æ€¥å‘Šè­¦"
            ;;
        "WARNING")  
            subject="$MAIL_SUBJECT_PREFIX ðŸŸ¡è­¦å‘Šå‘Šè­¦"
            ;;
        "INFO")
            subject="$MAIL_SUBJECT_PREFIX ðŸŸ¢ä¿¡æ¯é€šçŸ¥"
            ;;
    esac
    
    # é‚®ä»¶å†…å®¹
    email_body="
æ—¶é—´: $timestamp
çº§åˆ«: $alert_level
æ¶ˆæ¯: $alert_message

---
MHAç›‘æŽ§ç³»ç»Ÿè‡ªåŠ¨å‘é€
"
    
    # å‘é€é‚®ä»¶
    echo "$email_body" | mail -s "$subject" $MAIL_TO
    
    # è®°å½•æ—¥å¿—
    echo "[$timestamp] å‘é€å‘Šè­¦: $alert_level - $alert_message" >> /var/log/mha_alerts.log
}

# ä½¿ç”¨ç¤ºä¾‹
# send_alert "CRITICAL" "MHA Managerè¿›ç¨‹åœæ­¢è¿è¡Œ"
```

### 7.3 é›†æˆç›‘æŽ§å¹³å°


**Zabbixç›‘æŽ§é…ç½®ç¤ºä¾‹**ï¼š
```bash
# Zabbix Agenté…ç½®
# /etc/zabbix/zabbix_agentd.d/mha.conf

UserParameter=mha.status,/usr/local/bin/mha_status_check.sh
UserParameter=mha.process.count,ps aux | grep masterha_manager | grep -v grep | wc -l
UserParameter=mysql.slave.lag,mysql -e "SHOW SLAVE STATUS\G" | grep Seconds_Behind_Master | awk '{print $2}'
```

---

## 8. ðŸ› ï¸ ç›‘æŽ§è„šæœ¬å¼€å‘


### 8.1 ç»¼åˆç›‘æŽ§è„šæœ¬æž¶æž„


```bash
#!/bin/bash
# MHAç»¼åˆç›‘æŽ§è„šæœ¬
# æ–‡ä»¶: /usr/local/bin/mha_comprehensive_monitor.sh

# é…ç½®åŒºåŸŸ
MHA_CONF="/etc/masterha/app1.cnf"
LOG_DIR="/var/log/mha_monitor"
ALERT_EMAIL="admin@company.com"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p $LOG_DIR

# ä¸»ç›‘æŽ§å‡½æ•°
main_monitor() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local status_file="$LOG_DIR/status_$(date '+%Y%m%d').log"
    
    echo "[$timestamp] å¼€å§‹MHAç»¼åˆç›‘æŽ§æ£€æŸ¥..." >> $status_file
    
    # 1. åŸºç¡€çŠ¶æ€æ£€æŸ¥
    check_mha_status
    
    # 2. é…ç½®éªŒè¯
    check_configuration
    
    # 3. èµ„æºç›‘æŽ§
    check_system_resources
    
    # 4. ç½‘ç»œè¿žæŽ¥æ£€æŸ¥
    check_network_status
    
    # 5. MySQLçŠ¶æ€æ£€æŸ¥
    check_mysql_status
    
    echo "[$timestamp] MHAç›‘æŽ§æ£€æŸ¥å®Œæˆ" >> $status_file
}

# MHAçŠ¶æ€æ£€æŸ¥å‡½æ•°
check_mha_status() {
    local status_output=$(masterha_check_status --conf=$MHA_CONF 2>&1)
    local status_code=$?
    
    if [ $status_code -eq 0 ]; then
        echo "âœ… MHAçŠ¶æ€æ­£å¸¸: $status_output" >> $status_file
    else
        echo "âŒ MHAçŠ¶æ€å¼‚å¸¸: $status_output" >> $status_file
        send_alert "CRITICAL" "MHAçŠ¶æ€æ£€æŸ¥å¤±è´¥: $status_output"
    fi
}

# æ‰§è¡Œç›‘æŽ§
main_monitor
```

### 8.2 ç›‘æŽ§æ•°æ®æ”¶é›†è„šæœ¬


```bash
#!/bin/bash
# ç›‘æŽ§æ•°æ®æ”¶é›†è„šæœ¬

collect_monitoring_data() {
    local data_file="/tmp/mha_monitoring_data.json"
    local timestamp=$(date '+%s')
    
    # æ”¶é›†å„ç§ç›‘æŽ§æ•°æ®
    cat > $data_file << EOF
{
    "timestamp": $timestamp,
    "mha_status": "$(masterha_check_status --conf=$MHA_CONF 2>&1 | head -1)",
    "system_load": "$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')",
    "memory_usage": "$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')",
    "disk_usage": "$(df -h / | awk 'NR==2{print $5}' | tr -d '%')",
    "mysql_connections": "$(mysql -e 'SHOW STATUS LIKE \"Threads_connected\"' | awk 'NR==2{print $2}')",
    "slave_lag": "$(mysql -e 'SHOW SLAVE STATUS\\G' | grep Seconds_Behind_Master | awk '{print $2}')"
}
EOF
    
    # å¯ä»¥å°†æ•°æ®å‘é€åˆ°ç›‘æŽ§ç³»ç»Ÿ
    # curl -X POST -H "Content-Type: application/json" -d @$data_file http://monitoring-server/api/mha
}

collect_monitoring_data
```

### 8.3 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬


```bash
#!/bin/bash
# MHAç›‘æŽ§è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

deploy_monitoring() {
    echo "ðŸš€ å¼€å§‹éƒ¨ç½²MHAç›‘æŽ§ç³»ç»Ÿ..."
    
    # 1. åˆ›å»ºå¿…è¦ç›®å½•
    mkdir -p /usr/local/bin/mha_monitoring
    mkdir -p /var/log/mha_monitor
    mkdir -p /etc/mha_monitoring
    
    # 2. å¤åˆ¶ç›‘æŽ§è„šæœ¬
    cp mha_comprehensive_monitor.sh /usr/local/bin/mha_monitoring/
    chmod +x /usr/local/bin/mha_monitoring/*
    
    # 3. è®¾ç½®å®šæ—¶ä»»åŠ¡
    (crontab -l 2>/dev/null; echo "*/5 * * * * /usr/local/bin/mha_monitoring/mha_comprehensive_monitor.sh") | crontab -
    
    # 4. é…ç½®æ—¥å¿—è½®è½¬
    cat > /etc/logrotate.d/mha_monitoring << EOF
/var/log/mha_monitor/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
EOF
    
    echo "âœ… MHAç›‘æŽ§ç³»ç»Ÿéƒ¨ç½²å®Œæˆ"
}

deploy_monitoring
```

---

## 9. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŽŒæ¡çš„ç›‘æŽ§æŠ€èƒ½


```
ðŸ”¸ åŸºç¡€çŠ¶æ€æ£€æŸ¥ï¼šç†Ÿç»ƒä½¿ç”¨masterha_check_statuså‘½ä»¤
ðŸ”¸ é…ç½®éªŒè¯ï¼šæŽŒæ¡masterha_conf_hostçš„ä½¿ç”¨æ–¹æ³•
ðŸ”¸ æ—¥å¿—åˆ†æžï¼šèƒ½å¤Ÿå¿«é€Ÿå®šä½MHAæ—¥å¿—ä¸­çš„å…³é”®ä¿¡æ¯
ðŸ”¸ èµ„æºç›‘æŽ§ï¼šäº†è§£ç³»ç»Ÿèµ„æºå¯¹MHAè¿è¡Œçš„å½±å“
ðŸ”¸ å‘Šè­¦é…ç½®ï¼šå»ºç«‹æœ‰æ•ˆçš„å‘Šè­¦æœºåˆ¶
```

### 9.2 ç›‘æŽ§æœ€ä½³å®žè·µ


**ðŸ”¹ ç›‘æŽ§é¢‘çŽ‡è®¾ç½®**ï¼š
```
å®žæ—¶ç›‘æŽ§ï¼šMHAè¿›ç¨‹çŠ¶æ€ï¼ˆæ¯åˆ†é’Ÿï¼‰
å¸¸è§„ç›‘æŽ§ï¼šé…ç½®å’Œç½‘ç»œçŠ¶æ€ï¼ˆæ¯5åˆ†é’Ÿï¼‰
æ·±åº¦ç›‘æŽ§ï¼šèµ„æºä½¿ç”¨å’Œæ€§èƒ½ï¼ˆæ¯15åˆ†é’Ÿï¼‰
æŠ¥å‘Šç›‘æŽ§ï¼šæ—¥å¿—åˆ†æžå’Œè¶‹åŠ¿ï¼ˆæ¯å°æ—¶ï¼‰
```

**ðŸ”¹ å‘Šè­¦ç­–ç•¥åˆ¶å®š**ï¼š
```
åˆ†çº§å‘Šè­¦ï¼š
â€¢ ç«‹å³å¤„ç†ï¼šä¸»åº“å®•æœºã€MHAæ•…éšœ
â€¢ å°½å¿«å¤„ç†ï¼šä»Žåº“å»¶è¿Ÿã€èµ„æºå‘Šè­¦  
â€¢ å®šæœŸå¤„ç†ï¼šé…ç½®å˜æ›´ã€æ€§èƒ½ä¼˜åŒ–

å‘Šè­¦æ”¶æ•›ï¼š
â€¢ é¿å…å‘Šè­¦é£Žæš´
â€¢ è®¾ç½®å‘Šè­¦é—´éš”
â€¢ å»ºç«‹å‘Šè­¦å‡çº§æœºåˆ¶
```

**ðŸ”¹ ç›‘æŽ§æ•°æ®ç®¡ç†**ï¼š
```
æ•°æ®ä¿ç•™ï¼š
â€¢ å®žæ—¶æ•°æ®ï¼šä¿ç•™7å¤©
â€¢ æ±‡æ€»æ•°æ®ï¼šä¿ç•™30å¤©
â€¢ åŽ†å²è¶‹åŠ¿ï¼šä¿ç•™1å¹´

æ•°æ®åˆ†æžï¼š
â€¢ å»ºç«‹æ€§èƒ½åŸºçº¿
â€¢ è¶‹åŠ¿åˆ†æžé¢„è­¦
â€¢ å®¹é‡è§„åˆ’æ”¯æŒ
```

### 9.3 æ•…éšœæŽ’æŸ¥æ€è·¯


**ç›‘æŽ§å¼‚å¸¸æ—¶çš„å¤„ç†æ­¥éª¤**ï¼š
```
1. ç¡®è®¤å‘Šè­¦çœŸå®žæ€§
   â†’ é¿å…è¯¯æŠ¥æµªè´¹èµ„æº

2. è¯„ä¼°å½±å“èŒƒå›´
   â†’ åˆ¤æ–­æ˜¯å¦å½±å“ä¸šåŠ¡

3. æ‰§è¡Œåº”æ€¥æŽªæ–½
   â†’ ä¼˜å…ˆä¿è¯ä¸šåŠ¡è¿žç»­æ€§

4. æ·±å…¥åˆ†æžæ ¹å› 
   â†’ ä»Žæ—¥å¿—å’Œç›‘æŽ§æ•°æ®å…¥æ‰‹

5. åˆ¶å®šé¢„é˜²æŽªæ–½
   â†’ é¿å…ç±»ä¼¼é—®é¢˜å†æ¬¡å‘ç”Ÿ
```

### 9.4 å®žé™…åº”ç”¨å»ºè®®


- **ç›‘æŽ§å·¥å…·é€‰æ‹©**ï¼šæ ¹æ®ä¼ä¸šè§„æ¨¡é€‰æ‹©åˆé€‚çš„ç›‘æŽ§å¹³å°
- **è„šæœ¬æ ‡å‡†åŒ–**ï¼šå»ºç«‹ç»Ÿä¸€çš„ç›‘æŽ§è„šæœ¬è§„èŒƒ
- **æ–‡æ¡£ç»´æŠ¤**ï¼šåŠæ—¶æ›´æ–°ç›‘æŽ§ç›¸å…³æ–‡æ¡£
- **å›¢é˜ŸåŸ¹è®­**ï¼šç¡®ä¿è¿ç»´å›¢é˜Ÿç†Ÿæ‚‰ç›‘æŽ§æ“ä½œ
- **å®šæœŸæ¼”ç»ƒ**ï¼šé€šè¿‡æ•…éšœæ¼”ç»ƒéªŒè¯ç›‘æŽ§æ•ˆæžœ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- MHAç›‘æŽ§æ˜¯é«˜å¯ç”¨ä¿éšœçš„é‡è¦çŽ¯èŠ‚
- ç›‘æŽ§è¦è¦†ç›–çŠ¶æ€ã€é…ç½®ã€èµ„æºã€ç½‘ç»œå››ä¸ªç»´åº¦
- å‘Šè­¦è¦åˆ†çº§åˆ†ç±»ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
- ç›‘æŽ§è„šæœ¬è¦æ ‡å‡†åŒ–ã€è‡ªåŠ¨åŒ–
- å®šæœŸæ£€æŸ¥å’Œä¼˜åŒ–ç›‘æŽ§ç­–ç•¥