---
title: 17ã€MHAæ•…éšœæ¢å¤
---
## ğŸ“š ç›®å½•

1. [æ•…éšœæ¢å¤æ¦‚è¿°](#1-æ•…éšœæ¢å¤æ¦‚è¿°)
2. [æ•…éšœæ¢å¤æµç¨‹è¯¦è§£](#2-æ•…éšœæ¢å¤æµç¨‹è¯¦è§£)
3. [åŸä¸»åº“ä¿®å¤ä¸æ•°æ®åŒæ­¥](#3-åŸä¸»åº“ä¿®å¤ä¸æ•°æ®åŒæ­¥)
4. [å¤åˆ¶å…³ç³»é‡å»º](#4-å¤åˆ¶å…³ç³»é‡å»º)
5. [æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯](#5-æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯)
6. [æœåŠ¡é‡æ–°ä¸Šçº¿ç­–ç•¥](#6-æœåŠ¡é‡æ–°ä¸Šçº¿ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æ•…éšœæ¢å¤æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯MHAæ•…éšœæ¢å¤


**ç®€å•ç†è§£**ï¼šå½“ä¸»åº“å®•æœºï¼ŒMHAè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ä¸»åº“åï¼Œæˆ‘ä»¬éœ€è¦æŠŠåŸæ¥çš„ä¸»åº“ä¿®å¥½ï¼Œç„¶åé‡æ–°åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«æ•…éšœæ¢å¤ã€‚

```
æ•…éšœå‰çš„çŠ¶æ€ï¼š
åŸä¸»åº“(Master) â†’ ä»åº“1(Slave1) â†’ ä»åº“2(Slave2)
     â†“
   åº”ç”¨è¿æ¥

æ•…éšœåˆ‡æ¢åï¼š
åŸä¸»åº“(æ•…éšœ) â†’ ä»åº“1(æ–°Master) â†’ ä»åº“2(Slave)
                    â†“
                  åº”ç”¨è¿æ¥

æ•…éšœæ¢å¤åï¼š
ä»åº“1(Master) â†’ åŸä¸»åº“(Slave) â†’ ä»åº“2(Slave)
     â†“
   åº”ç”¨è¿æ¥
```

### 1.2 æ•…éšœæ¢å¤çš„æ ¸å¿ƒç›®æ ‡


**ğŸ¯ ä¸»è¦ç›®æ ‡**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹æ•°æ®å®Œå…¨ä¸€è‡´
- **æœåŠ¡ç¨³å®šæ€§**ï¼šæ¢å¤å®Œæ•´çš„é«˜å¯ç”¨æ¶æ„
- **é›¶æ•°æ®ä¸¢å¤±**ï¼šåŸä¸»åº“çš„æ•°æ®ä¸èƒ½ä¸¢å¤±
- **æœ€å°åœæœºæ—¶é—´**ï¼šå°½å¿«æ¢å¤æœåŠ¡

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ•…éšœæ¢å¤**
```
ä¸æ¢å¤çš„é—®é¢˜ï¼š
- å¤±å»ä¸€ä¸ªæ•°æ®åº“èŠ‚ç‚¹ï¼Œé™ä½äº†å¯ç”¨æ€§
- åŸä¸»åº“å¯èƒ½æœ‰æœ€æ–°çš„æ•°æ®æ²¡æœ‰åŒæ­¥
- é›†ç¾¤èŠ‚ç‚¹å‡å°‘ï¼Œé£é™©å¢åŠ 
- èµ„æºæµªè´¹ï¼ŒæŠ•èµ„æ‰“æ°´æ¼‚

æ¢å¤åçš„å¥½å¤„ï¼š
- é‡æ–°è·å¾—å®Œæ•´çš„é«˜å¯ç”¨èƒ½åŠ›
- æ•°æ®å®‰å…¨æ€§æå‡
- è´Ÿè½½åˆ†æ‹…èƒ½åŠ›å¢å¼º
- æ¶æ„å®Œæ•´æ€§æ¢å¤
```

---

## 2. ğŸ“‹ æ•…éšœæ¢å¤æµç¨‹è¯¦è§£


### 2.1 æ•…éšœæ¢å¤æ€»ä½“æµç¨‹


**ğŸ”„ å®Œæ•´æ¢å¤æµç¨‹**
```
æ­¥éª¤1ï¼šç¯å¢ƒè¯„ä¼°
   â†“
æ­¥éª¤2ï¼šåŸä¸»åº“ä¿®å¤
   â†“  
æ­¥éª¤3ï¼šæ•°æ®å·®å¼‚åˆ†æ
   â†“
æ­¥éª¤4ï¼šæ•°æ®åŒæ­¥æ¢å¤
   â†“
æ­¥éª¤5ï¼šå¤åˆ¶å…³ç³»é‡å»º
   â†“
æ­¥éª¤6ï¼šæ•°æ®ä¸€è‡´æ€§éªŒè¯
   â†“
æ­¥éª¤7ï¼šæœåŠ¡é‡æ–°ä¸Šçº¿
```

### 2.2 ç¯å¢ƒè¯„ä¼°é˜¶æ®µ


**ğŸ” è¯„ä¼°æ£€æŸ¥é¡¹**
```bash
# 1. æ£€æŸ¥å½“å‰é›†ç¾¤çŠ¶æ€
masterha_check_status --conf=/etc/mha/app1.cnf

# 2. æŸ¥çœ‹æ–°ä¸»åº“çŠ¶æ€
mysql -hæ–°ä¸»åº“IP -e "SHOW MASTER STATUS\G"
mysql -hæ–°ä¸»åº“IP -e "SHOW SLAVE STATUS\G"

# 3. æ£€æŸ¥åŸä¸»åº“ç¡¬ä»¶çŠ¶æ€
ping åŸä¸»åº“IP
ssh åŸä¸»åº“IP "df -h"
ssh åŸä¸»åº“IP "free -m"
```

**ğŸ“Š è¯„ä¼°ç»“æœåˆ†æ**
| æ£€æŸ¥é¡¹ | **æ­£å¸¸çŠ¶æ€** | **å¼‚å¸¸å¤„ç†** |
|-------|-------------|-------------|
| ç½‘ç»œè¿é€šæ€§ | `pingé€šï¼Œsshæ­£å¸¸` | `æ£€æŸ¥ç½‘ç»œé…ç½®ï¼Œé˜²ç«å¢™è®¾ç½®` |
| ç£ç›˜ç©ºé—´ | `å……è¶³ç©ºé—´å¯ç”¨` | `æ¸…ç†æ—¥å¿—ï¼Œæ‰©å®¹ç£ç›˜` |
| MySQLè¿›ç¨‹ | `è¿›ç¨‹æ­£å¸¸æˆ–å·²åœæ­¢` | `å¼ºåˆ¶æ€æ­»å¼‚å¸¸è¿›ç¨‹` |
| æ•°æ®æ–‡ä»¶ | `æ–‡ä»¶å®Œæ•´æ— æŸå` | `ä½¿ç”¨å¤‡ä»½æ¢å¤æ•°æ®æ–‡ä»¶` |

### 2.3 åŸä¸»åº“é—®é¢˜è¯Šæ–­


**ğŸ”§ å¸¸è§æ•…éšœç±»å‹åŠå¤„ç†**
```bash
# ç¡¬ä»¶æ•…éšœè¯Šæ–­
dmesg | grep -i error
cat /var/log/messages | grep mysql

# MySQLé”™è¯¯æ—¥å¿—åˆ†æ  
tail -100 /var/log/mysql/error.log

# æ•°æ®æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥
mysqlcheck --all-databases --check
```

---

## 3. ğŸ› ï¸ åŸä¸»åº“ä¿®å¤ä¸æ•°æ®åŒæ­¥


### 3.1 åŸä¸»åº“ä¿®å¤æ­¥éª¤


**ğŸ”§ ä¿®å¤æ“ä½œæµç¨‹**
```bash
# 1. åœæ­¢MySQLæœåŠ¡ï¼ˆå¦‚æœè¿˜åœ¨è¿è¡Œï¼‰
systemctl stop mysqld

# 2. å¤‡ä»½å½“å‰æ•°æ®ç›®å½•
cp -r /var/lib/mysql /var/lib/mysql.backup.$(date +%Y%m%d)

# 3. æ£€æŸ¥å¹¶ä¿®å¤MySQLé…ç½®
vim /etc/my.cnf
# ç¡®ä¿ä»¥ä¸‹é…ç½®æ­£ç¡®ï¼š
# server-id = åŸæ¥çš„server-id
# log-bin = mysql-bin
# relay-log = mysql-relay-bin
# read_only = 1  # ä½œä¸ºä»åº“å¯åŠ¨

# 4. å¯åŠ¨MySQLåˆ°å®‰å…¨æ¨¡å¼
mysqld_safe --skip-networking --skip-grant-tables &

# 5. é‡ç½®å¤åˆ¶é…ç½®
mysql -e "STOP SLAVE;"
mysql -e "RESET SLAVE ALL;"
mysql -e "RESET MASTER;"
```

### 3.2 æ•°æ®å·®å¼‚åˆ†æ


**ğŸ“Š åˆ†ææ•°æ®å·®å¼‚çš„æ–¹æ³•**
```sql
-- 1. æ¯”è¾ƒbinlogä½ç½®
-- åœ¨åŸä¸»åº“æ‰§è¡Œ
SHOW MASTER STATUS;

-- åœ¨æ–°ä¸»åº“æ‰§è¡Œ  
SHOW MASTER STATUS;

-- 2. æŸ¥çœ‹åŸä¸»åº“æœ€åçš„äº‹åŠ¡
mysqlbinlog --start-datetime='æ•…éšœæ—¶é—´' mysql-bin.000001

-- 3. æ£€æŸ¥æ˜¯å¦æœ‰æœªåŒæ­¥çš„æ•°æ®
SELECT * FROM information_schema.processlist 
WHERE command = 'Binlog Dump';
```

**ğŸ’¡ æ•°æ®å·®å¼‚çš„å…¸å‹æƒ…å†µ**
```
æƒ…å†µ1ï¼šåŸä¸»åº“æœ‰æœªåŒæ­¥çš„æ–°æ•°æ®
è§£å†³ï¼šéœ€è¦å°†è¿™éƒ¨åˆ†æ•°æ®åŒæ­¥åˆ°æ–°ä¸»åº“

æƒ…å†µ2ï¼šåŸä¸»åº“æ•°æ®å®Œå…¨åŒæ­¥
è§£å†³ï¼šç›´æ¥é‡å»ºå¤åˆ¶å…³ç³»å³å¯

æƒ…å†µ3ï¼šåŸä¸»åº“æ•°æ®æœ‰æŸå
è§£å†³ï¼šä½¿ç”¨æ–°ä¸»åº“æ•°æ®å®Œå…¨é‡å»ºåŸä¸»åº“
```

### 3.3 å¢é‡æ•°æ®æ¢å¤


**ğŸ“ˆ å¢é‡æ¢å¤æ“ä½œ**
```bash
# 1. å¯¼å‡ºåŸä¸»åº“æœªåŒæ­¥çš„æ•°æ®
mysqlbinlog --start-position=å·®å¼‚ä½ç½® mysql-bin.000001 > incremental.sql

# 2. åœ¨æ–°ä¸»åº“åº”ç”¨å¢é‡æ•°æ®
mysql -hæ–°ä¸»åº“IP < incremental.sql

# 3. éªŒè¯å¢é‡æ•°æ®åº”ç”¨ç»“æœ
mysql -hæ–°ä¸»åº“IP -e "SHOW MASTER STATUS;"
```

### 3.4 å…¨é‡æ•°æ®æ¢å¤


**ğŸ“¦ å…¨é‡æ¢å¤æ­¥éª¤**
```bash
# 1. ä»æ–°ä¸»åº“å¯¼å‡ºå®Œæ•´æ•°æ®
mysqldump --single-transaction --routines --triggers \
  --all-databases --master-data=2 > fullbackup.sql

# 2. åœæ­¢åŸä¸»åº“MySQL
systemctl stop mysqld

# 3. æ¸…ç©ºåŸä¸»åº“æ•°æ®ç›®å½•
rm -rf /var/lib/mysql/*

# 4. åˆå§‹åŒ–MySQLæ•°æ®ç›®å½•
mysqld --initialize-insecure --user=mysql

# 5. å¯åŠ¨MySQLå¹¶å¯¼å…¥æ•°æ®
systemctl start mysqld
mysql < fullbackup.sql
```

---

## 4. ğŸ”— å¤åˆ¶å…³ç³»é‡å»º


### 4.1 é…ç½®åŸä¸»åº“ä¸ºä»åº“


**âš™ï¸ CHANGE MASTER TOé…ç½®**
```sql
-- 1. åœæ­¢åŸæœ‰å¤åˆ¶ï¼ˆå¦‚æœæœ‰ï¼‰
STOP SLAVE;
RESET SLAVE ALL;

-- 2. é…ç½®æ–°çš„ä¸»ä»å…³ç³»
CHANGE MASTER TO 
  MASTER_HOST='æ–°ä¸»åº“IP',
  MASTER_PORT=3306,
  MASTER_USER='å¤åˆ¶ç”¨æˆ·å',
  MASTER_PASSWORD='å¤åˆ¶å¯†ç ',
  MASTER_LOG_FILE='æ–°ä¸»åº“binlogæ–‡ä»¶å',
  MASTER_LOG_POS=æ–°ä¸»åº“binlogä½ç½®;

-- 3. å¯åŠ¨å¤åˆ¶
START SLAVE;

-- 4. æ£€æŸ¥å¤åˆ¶çŠ¶æ€
SHOW SLAVE STATUS\G;
```

**ğŸ” å…³é”®å‚æ•°è¯´æ˜**
```
MASTER_HOSTï¼šæ–°ä¸»åº“çš„IPåœ°å€
MASTER_PORTï¼šæ–°ä¸»åº“çš„ç«¯å£ï¼Œé€šå¸¸æ˜¯3306
MASTER_USERï¼šç”¨äºå¤åˆ¶çš„ç”¨æˆ·å
MASTER_PASSWORDï¼šå¤åˆ¶ç”¨æˆ·çš„å¯†ç 
MASTER_LOG_FILEï¼šä»å“ªä¸ªbinlogæ–‡ä»¶å¼€å§‹å¤åˆ¶
MASTER_LOG_POSï¼šä»binlogæ–‡ä»¶çš„å“ªä¸ªä½ç½®å¼€å§‹å¤åˆ¶
```

### 4.2 å¤åˆ¶çŠ¶æ€ç›‘æ§


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```sql
-- æŸ¥çœ‹å¤åˆ¶çŠ¶æ€çš„å…³é”®ä¿¡æ¯
SHOW SLAVE STATUS\G;

-- é‡ç‚¹å…³æ³¨ä»¥ä¸‹å­—æ®µï¼š
-- Slave_IO_Running: Yes    # IOçº¿ç¨‹è¿è¡Œæ­£å¸¸
-- Slave_SQL_Running: Yes   # SQLçº¿ç¨‹è¿è¡Œæ­£å¸¸  
-- Master_Log_File: mysql-bin.000001  # å½“å‰è¯»å–çš„ä¸»åº“binlog
-- Read_Master_Log_Pos: ä½ç½®   # å·²è¯»å–çš„binlogä½ç½®
-- Relay_Master_Log_File: mysql-bin.000001  # å·²æ‰§è¡Œçš„ä¸»åº“binlog
-- Exec_Master_Log_Pos: ä½ç½®   # å·²æ‰§è¡Œçš„binlogä½ç½®
-- Seconds_Behind_Master: 0    # å¤åˆ¶å»¶è¿Ÿç§’æ•°
-- Last_IO_Error: ç©º    # IOé”™è¯¯ä¿¡æ¯
-- Last_SQL_Error: ç©º   # SQLé”™è¯¯ä¿¡æ¯
```

### 4.3 å¤åˆ¶å¼‚å¸¸å¤„ç†


**âš ï¸ å¸¸è§å¤åˆ¶é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**

| é—®é¢˜ç±»å‹ | **é”™è¯¯ç°è±¡** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| è¿æ¥é—®é¢˜ | `Slave_IO_Running: No` | `æ£€æŸ¥ç½‘ç»œã€ç”¨æˆ·æƒé™ã€é˜²ç«å¢™` |
| SQLæ‰§è¡Œé”™è¯¯ | `Slave_SQL_Running: No` | `æŸ¥çœ‹Last_SQL_Errorï¼Œæ‰‹å·¥ä¿®å¤å†²çª` |
| å¤åˆ¶å»¶è¿Ÿ | `Seconds_Behind_Master > 0` | `æ£€æŸ¥ç½‘ç»œã€ç£ç›˜IOã€SQLä¼˜åŒ–` |
| é‡å¤é”®é”™è¯¯ | `Duplicate entry error` | `è·³è¿‡é”™è¯¯æˆ–æ‰‹å·¥è§£å†³å†²çª` |

```sql
-- è·³è¿‡å¤åˆ¶é”™è¯¯ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
STOP SLAVE;
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- æ‰‹å·¥è§£å†³å†²çªåé‡æ–°å¯åŠ¨å¤åˆ¶
STOP SLAVE;
-- æ‰‹å·¥å¤„ç†å†²çªæ•°æ®
START SLAVE;
```

---

## 5. âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä¸éªŒè¯


### 5.1 pt-table-checksuméªŒè¯


**ğŸ” æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·**
```bash
# å®‰è£…percona-toolkit
yum install percona-toolkit

# åœ¨æ–°ä¸»åº“ä¸Šæ‰§è¡Œchecksum
pt-table-checksum \
  --host=æ–°ä¸»åº“IP \
  --user=checksumç”¨æˆ· \
  --password=å¯†ç  \
  --databases=éœ€è¦æ£€æŸ¥çš„æ•°æ®åº“ \
  --replicate=percona.checksums

# æŸ¥çœ‹checksumç»“æœ
mysql -hæ–°ä¸»åº“IP -e "SELECT * FROM percona.checksums WHERE this_crc != master_crc;"
```

**ğŸ“Š checksumç»“æœåˆ†æ**
```sql
-- æ­£å¸¸æƒ…å†µï¼šæ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜æ•°æ®ä¸€è‡´
-- å¼‚å¸¸æƒ…å†µï¼šæœ‰è¾“å‡ºï¼Œè¯´æ˜å­˜åœ¨æ•°æ®ä¸ä¸€è‡´

-- æŸ¥çœ‹è¯¦ç»†çš„ä¸ä¸€è‡´ä¿¡æ¯
SELECT db, tbl, chunk, boundaries, this_crc, master_crc 
FROM percona.checksums 
WHERE this_crc != master_crc 
   OR master_crc IS NULL 
   OR this_crc IS NULL;
```

### 5.2 æ‰‹å·¥æ•°æ®éªŒè¯


**ğŸ”§ å…³é”®æ•°æ®éªŒè¯**
```sql
-- 1. æ¯”è¾ƒæ€»è®°å½•æ•°
SELECT 
  table_schema,
  table_name,
  table_rows
FROM information_schema.tables 
WHERE table_schema NOT IN ('information_schema','mysql','performance_schema');

-- 2. æ¯”è¾ƒå…³é”®ä¸šåŠ¡è¡¨çš„MD5å€¼
SELECT COUNT(*), MD5(GROUP_CONCAT(id,name,email ORDER BY id)) as checksum
FROM user_table;

-- 3. éªŒè¯æœ€æ–°æ’å…¥çš„æ•°æ®
SELECT MAX(id), MAX(create_time) FROM å…³é”®ä¸šåŠ¡è¡¨;
```

### 5.3 å¤åˆ¶ä½ç½®éªŒè¯


**ğŸ“ binlogä½ç½®ä¸€è‡´æ€§æ£€æŸ¥**
```sql
-- åœ¨æ–°ä¸»åº“æ‰§è¡Œ
SHOW MASTER STATUS;

-- åœ¨åŸä¸»åº“ï¼ˆç°åœ¨çš„ä»åº“ï¼‰æ‰§è¡Œ
SHOW SLAVE STATUS\G;

-- éªŒè¯ç‚¹ï¼š
-- 1. Relay_Master_Log_File åº”è¯¥ç­‰äº ä¸»åº“çš„ File
-- 2. Exec_Master_Log_Pos åº”è¯¥ç­‰äº ä¸»åº“çš„ Position  
-- 3. Seconds_Behind_Master åº”è¯¥ä¸º 0
```

---

## 6. ğŸš€ æœåŠ¡é‡æ–°ä¸Šçº¿ç­–ç•¥


### 6.1 åˆ†é˜¶æ®µä¸Šçº¿è®¡åˆ’


**ğŸ“… ä¸Šçº¿æ—¶é—´è§„åˆ’**
```
é˜¶æ®µ1ï¼šä½å³°æœŸé¢„ä¸Šçº¿ï¼ˆå‡Œæ™¨2-4ç‚¹ï¼‰
- å®ŒæˆåŸºç¡€é…ç½®å’Œæ•°æ®åŒæ­¥
- è¿›è¡Œåˆæ­¥åŠŸèƒ½éªŒè¯

é˜¶æ®µ2ï¼šè§‚å¯ŸæœŸä¸Šçº¿ï¼ˆä½å³°æœŸæŒç»­ç›‘æ§ï¼‰  
- ç›‘æ§å¤åˆ¶çŠ¶æ€ç¨³å®šæ€§
- è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ

é˜¶æ®µ3ï¼šæ­£å¼ä¸Šçº¿ï¼ˆä¸šåŠ¡é«˜å³°æœŸï¼‰
- å¼€æ”¾æ‰€æœ‰è¯»å†™æµé‡
- æŒç»­ç›‘æ§å‘Šè­¦
- ç¡®ä¿æœåŠ¡ç¨³å®š
```

### 6.2 åº”ç”¨è¿æ¥åˆ‡æ¢


**ğŸ”„ è¿æ¥åˆ‡æ¢ç­–ç•¥**
```
è¯»å†™åˆ†ç¦»ç¯å¢ƒï¼š
1. å…ˆå°†åŸä¸»åº“åŠ å…¥è¯»åº“æ± 
2. é€æ­¥åˆ†é…è¯»æµé‡åˆ°åŸä¸»åº“
3. è§‚å¯Ÿæ€§èƒ½å’Œç¨³å®šæ€§
4. æ ¹æ®éœ€è¦è°ƒæ•´æµé‡åˆ†é…

è´Ÿè½½å‡è¡¡ç¯å¢ƒï¼š
1. åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸­æ·»åŠ åŸä¸»åº“èŠ‚ç‚¹
2. è®¾ç½®è¾ƒä½çš„æƒé‡å€¼
3. é€æ­¥æé«˜æƒé‡
4. ç›‘æ§æ•´ä½“æ€§èƒ½è¡¨ç°
```

### 6.3 ç›‘æ§å‘Šè­¦é…ç½®


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```bash
# 1. å¤åˆ¶çŠ¶æ€ç›‘æ§
mysql -e "SHOW SLAVE STATUS\G" | grep -E "Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master"

# 2. æ€§èƒ½ç›‘æ§
mysql -e "SHOW GLOBAL STATUS LIKE 'Questions';"
mysql -e "SHOW GLOBAL STATUS LIKE 'Threads_connected';"

# 3. é”™è¯¯æ—¥å¿—ç›‘æ§
tail -f /var/log/mysql/error.log | grep -i error
```

**âš ï¸ å‘Šè­¦é˜ˆå€¼è®¾ç½®**
| æŒ‡æ ‡ | **å‘Šè­¦æ¡ä»¶** | **å¤„ç†å»ºè®®** |
|------|-------------|-------------|
| å¤åˆ¶å»¶è¿Ÿ | `Seconds_Behind_Master > 30` | `æ£€æŸ¥ç½‘ç»œå’Œç£ç›˜IO` |
| è¿æ¥æ•° | `Threads_connected > 80%æœ€å¤§å€¼` | `æ£€æŸ¥åº”ç”¨è¿æ¥æ± é…ç½®` |
| å¤åˆ¶ä¸­æ–­ | `Slave_IO_Running = No` | `ç«‹å³æ£€æŸ¥ç½‘ç»œå’Œé…ç½®` |
| é”™è¯¯æ—¥å¿— | `ERRORçº§åˆ«æ—¥å¿—å‡ºç°` | `æ ¹æ®å…·ä½“é”™è¯¯è¿›è¡Œå¤„ç†` |

### 6.4 å›æ»šå‡†å¤‡


**ğŸ”™ å›æ»šæ–¹æ¡ˆå‡†å¤‡**
```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
cp /etc/mha/app1.cnf /etc/mha/app1.cnf.backup
cp /etc/my.cnf /etc/my.cnf.backup

# 2. å‡†å¤‡å¿«é€Ÿç§»é™¤è„šæœ¬
cat > remove_node.sh << 'EOF'
#!/bin/bash
# ä»MHAé…ç½®ä¸­ç§»é™¤èŠ‚ç‚¹
sed -i '/åŸä¸»åº“é…ç½®æ®µ/,/ä¸‹ä¸€ä¸ªé…ç½®æ®µå‰/d' /etc/mha/app1.cnf
# é‡å¯MHAç®¡ç†è¿›ç¨‹
masterha_stop --conf=/etc/mha/app1.cnf
masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover
EOF

# 3. å‡†å¤‡åº”ç”¨è¿æ¥å¿«é€Ÿåˆ‡æ¢
# åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸­å‡†å¤‡åŸä¸»åº“èŠ‚ç‚¹çš„å¿«é€Ÿç§»é™¤æ“ä½œ
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæµç¨‹


```
ğŸ”¸ æ•…éšœæ¢å¤å››å¤§é˜¶æ®µï¼šè¯„ä¼°â†’ä¿®å¤â†’é‡å»ºâ†’éªŒè¯
ğŸ”¸ æ•°æ®åŒæ­¥ä¸¤ç§æ–¹å¼ï¼šå¢é‡æ¢å¤å’Œå…¨é‡æ¢å¤
ğŸ”¸ å¤åˆ¶é‡å»ºæ ¸å¿ƒï¼šCHANGE MASTER TOé…ç½®æ­£ç¡®
ğŸ”¸ ä¸€è‡´æ€§éªŒè¯å·¥å…·ï¼špt-table-checksum + æ‰‹å·¥éªŒè¯
ğŸ”¸ ä¸Šçº¿ç­–ç•¥åŸåˆ™ï¼šåˆ†é˜¶æ®µã€å¯å›æ»šã€æŒç»­ç›‘æ§
```

### 7.2 å…³é”®æ“ä½œè¦ç‚¹


**ğŸ”¹ æ•°æ®å®‰å…¨ç¬¬ä¸€**
```
æ“ä½œå‰å¿…åšï¼š
- å¤‡ä»½å½“å‰æ•°æ®å’Œé…ç½®
- è¯„ä¼°æ•°æ®å·®å¼‚å’Œæ¢å¤æ–¹æ¡ˆ
- å‡†å¤‡å›æ»šè®¡åˆ’

æ“ä½œä¸­ç›‘æ§ï¼š
- å®æ—¶ç›‘æ§å¤åˆ¶çŠ¶æ€
- åŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸
- è®°å½•è¯¦ç»†æ“ä½œæ—¥å¿—
```

**ğŸ”¹ é…ç½®é‡å»ºè¦ç‚¹**
```
CHANGE MASTER TOå…³é”®å‚æ•°ï¼š
- MASTER_HOSTï¼šæ–°ä¸»åº“IPåœ°å€
- MASTER_LOG_FILEï¼šæ­£ç¡®çš„binlogæ–‡ä»¶å
- MASTER_LOG_POSï¼šå‡†ç¡®çš„binlogä½ç½®
- å¤åˆ¶ç”¨æˆ·æƒé™ï¼šç¡®ä¿æœ‰REPLICATION SLAVEæƒé™
```

**ğŸ”¹ éªŒè¯æ£€æŸ¥æ¸…å•**
```
â˜‘ï¸ å¤åˆ¶çŠ¶æ€ï¼šIOå’ŒSQLçº¿ç¨‹éƒ½æ˜¯Yes
â˜‘ï¸ å¤åˆ¶å»¶è¿Ÿï¼šSeconds_Behind_Masterä¸º0
â˜‘ï¸ æ•°æ®ä¸€è‡´æ€§ï¼špt-table-checksumæ— å·®å¼‚
â˜‘ï¸ é”™è¯¯æ—¥å¿—ï¼šæ— ERRORçº§åˆ«é”™è¯¯
â˜‘ï¸ æ€§èƒ½æŒ‡æ ‡ï¼šCPUã€å†…å­˜ã€ç£ç›˜IOæ­£å¸¸
```

### 7.3 å¸¸è§é—®é¢˜é¢„é˜²


**âš ï¸ å…¸å‹é—®é¢˜åŠé¢„é˜²**
- **å¤åˆ¶ç”¨æˆ·æƒé™ä¸è¶³**ï¼šæå‰ç¡®è®¤REPLICATION SLAVEæƒé™
- **binlogä½ç½®é”™è¯¯**ï¼šä»”ç»†æ ¸å¯¹MASTER_LOG_FILEå’ŒMASTER_LOG_POS
- **ç½‘ç»œè¿æ¥é—®é¢˜**ï¼šæ£€æŸ¥é˜²ç«å¢™ã€hostsæ–‡ä»¶é…ç½®
- **æ•°æ®ä¸ä¸€è‡´**ï¼šä½¿ç”¨pt-table-checksumå½»åº•éªŒè¯
- **æ€§èƒ½ä¸‹é™**ï¼šç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶è°ƒæ•´é…ç½®

### 7.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ å®æˆ˜ç»éªŒæ€»ç»“**
- **æ“ä½œæ—¶æœº**ï¼šé€‰æ‹©ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œæ¢å¤æ“ä½œ
- **åˆ†æ­¥æ‰§è¡Œ**ï¼šå°†å¤æ‚æ“ä½œåˆ†è§£ä¸ºå¤šä¸ªç®€å•æ­¥éª¤
- **å……åˆ†æµ‹è¯•**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒå…ˆæ¼”ç»ƒæ•´ä¸ªæµç¨‹
- **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªæ“ä½œæ­¥éª¤å’Œç»“æœ
- **å›¢é˜Ÿåä½œ**ï¼šDBAã€è¿ç»´ã€å¼€å‘å›¢é˜Ÿå¯†åˆ‡é…åˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
MHAæ•…éšœæ¢å¤æœ‰ç« æ³•
è¯„ä¼°ä¿®å¤æ˜¯åŸºç¡€
æ•°æ®åŒæ­¥è¦ä»”ç»†
å¤åˆ¶é‡å»ºæœ€å…³é”®
ä¸€è‡´éªŒè¯ä¸èƒ½å°‘
åˆ†æ­¥ä¸Šçº¿ä¿å¹³å®‰
```