---
title: 29ã€BINLOGç›‘æ§ä¸å‘Šè­¦
---
## ğŸ“š ç›®å½•

1. [BINLOGç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-BINLOGç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [BINLOGçŠ¶æ€ç›‘æ§](#2-BINLOGçŠ¶æ€ç›‘æ§)
3. [æ–‡ä»¶å¤§å°ä¸ç£ç›˜ç›‘æ§](#3-æ–‡ä»¶å¤§å°ä¸ç£ç›˜ç›‘æ§)
4. [å†™å…¥æ€§èƒ½ä¸å¤åˆ¶å»¶è¿Ÿç›‘æ§](#4-å†™å…¥æ€§èƒ½ä¸å¤åˆ¶å»¶è¿Ÿç›‘æ§)
5. [ç›‘æ§å·¥å…·ä¸å¹³å°é›†æˆ](#5-ç›‘æ§å·¥å…·ä¸å¹³å°é›†æˆ)
6. [å‘Šè­¦ç­–ç•¥ä¸é˜ˆå€¼è®¾ç½®](#6-å‘Šè­¦ç­–ç•¥ä¸é˜ˆå€¼è®¾ç½®)
7. [ç›‘æ§è„šæœ¬å¼€å‘å®æˆ˜](#7-ç›‘æ§è„šæœ¬å¼€å‘å®æˆ˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ BINLOGç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯BINLOGç›‘æ§


**ç®€å•ç†è§£**ï¼šBINLOGç›‘æ§å°±åƒç»™MySQLçš„"æ—¥è®°æœ¬"å®‰è£…ç›‘æ§æ‘„åƒå¤´

```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
ç›‘æ§BINLOG = ç›‘æ§å·¥å‚çš„ç”Ÿäº§çº¿
- ç”Ÿäº§é€Ÿåº¦å¦‚ä½•ï¼ˆå†™å…¥é€Ÿåº¦ï¼‰
- äº§å“è´¨é‡å¦‚ä½•ï¼ˆæ—¥å¿—å®Œæ•´æ€§ï¼‰
- ä»“åº“å¤Ÿä¸å¤Ÿç”¨ï¼ˆç£ç›˜ç©ºé—´ï¼‰
- è¿è¾“æ˜¯å¦åŠæ—¶ï¼ˆå¤åˆ¶å»¶è¿Ÿï¼‰
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **é¢„é˜²æ•…éšœ**ï¼šæå‰å‘ç°é—®é¢˜ï¼Œé¿å…æ•°æ®åº“å´©æºƒ
- **ä¿éšœæ•°æ®å®‰å…¨**ï¼šç¡®ä¿BINLOGæ­£å¸¸è®°å½•ï¼Œæ•°æ®ä¸ä¸¢å¤±
- **ä¼˜åŒ–æ€§èƒ½**ï¼šç›‘æ§ç“¶é¢ˆï¼ŒåŠæ—¶è°ƒä¼˜
- **è¾…åŠ©è¿ç»´å†³ç­–**ï¼šåŸºäºç›‘æ§æ•°æ®åšå®¹é‡è§„åˆ’

### 1.2 ä¸ºä»€ä¹ˆBINLOGç›‘æ§å¦‚æ­¤é‡è¦


**é—®é¢˜åœºæ™¯**ï¼šæ²¡æœ‰ç›‘æ§ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```
çœŸå®æ¡ˆä¾‹ï¼š
æŸç”µå•†ç½‘ç«™ï¼ŒBINLOGç£ç›˜æ»¡äº†
â†’ æ•°æ®åº“æ— æ³•å†™å…¥
â†’ ç”¨æˆ·æ— æ³•ä¸‹å•
â†’ æŸå¤±æƒ¨é‡

å¦‚æœæœ‰ç›‘æ§ï¼š
ç£ç›˜ä½¿ç”¨ç‡80% â†’ å‘Šè­¦
è¿ç»´æå‰æ‰©å®¹ â†’ é¿å…æ•…éšœ
```

> ğŸ“Œ **æ ¸å¿ƒç†å¿µ**  
> BINLOGæ˜¯MySQLçš„ç”Ÿå‘½çº¿ï¼Œç›‘æ§BINLOGå°±æ˜¯ä¿æŠ¤æ•°æ®åº“çš„å¿ƒè„

### 1.3 BINLOGç›‘æ§çš„æ ¸å¿ƒç»´åº¦


```
ç›‘æ§ç»´åº¦å…¨æ™¯å›¾ï¼š

çŠ¶æ€ç›‘æ§           æ€§èƒ½ç›‘æ§           å®¹é‡ç›‘æ§
    â†“                 â†“                 â†“
æ˜¯å¦æ­£å¸¸å¼€å¯     å†™å…¥é€Ÿåº¦å¿«æ…¢      ç£ç›˜ç©ºé—´å¤Ÿç”¨
å¤åˆ¶æ˜¯å¦æ­£å¸¸     IOå‹åŠ›å¤§å°        æ–‡ä»¶å¤§å°æ§åˆ¶
æ ¼å¼æ˜¯å¦æ­£ç¡®     ç½‘ç»œä¼ è¾“é€Ÿåº¦      ä¿ç•™æ—¶é—´åˆç†

    â†“                 â†“                 â†“
å‘Šè­¦é€šçŸ¥ â† â† â† ç»¼åˆåˆ†æå†³ç­– â†’ â†’ â†’ è‡ªåŠ¨å¤„ç†
```

---

## 2. ğŸ“Š BINLOGçŠ¶æ€ç›‘æ§


### 2.1 åŸºç¡€çŠ¶æ€æ£€æŸ¥


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼šBINLOGæ˜¯å¦æ­£å¸¸å¯ç”¨

```sql
-- æ£€æŸ¥BINLOGæ˜¯å¦å¼€å¯
SHOW VARIABLES LIKE 'log_bin';
-- ç»“æœï¼šON = æ­£å¸¸ï¼ŒOFF = å¼‚å¸¸

-- æ£€æŸ¥BINLOGæ ¼å¼
SHOW VARIABLES LIKE 'binlog_format';
-- å¸¸è§å€¼ï¼šROWã€STATEMENTã€MIXED
```

**ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# BINLOGåŸºç¡€çŠ¶æ€æ£€æŸ¥

check_binlog_status() {
    # æ£€æŸ¥BINLOGæ˜¯å¦å¼€å¯
    binlog_status=$(mysql -e "SHOW VARIABLES LIKE 'log_bin';" | grep log_bin | awk '{print $2}')
    
    if [ "$binlog_status" != "ON" ]; then
        echo "ğŸš¨ BINLOGæœªå¼€å¯ï¼"
        send_alert "BINLOGçŠ¶æ€å¼‚å¸¸"
        return 1
    fi
    
    echo "âœ… BINLOGçŠ¶æ€æ­£å¸¸"
    return 0
}
```

### 2.2 BINLOGæ–‡ä»¶çŠ¶æ€ç›‘æ§


**å…³é”®æ£€æŸ¥é¡¹**ï¼šå½“å‰BINLOGæ–‡ä»¶ä¿¡æ¯

```sql
-- æŸ¥çœ‹å½“å‰BINLOGæ–‡ä»¶
SHOW MASTER STATUS;
-- å…³æ³¨ï¼šFileï¼ˆå½“å‰æ–‡ä»¶åï¼‰ã€Positionï¼ˆå†™å…¥ä½ç½®ï¼‰

-- æŸ¥çœ‹æ‰€æœ‰BINLOGæ–‡ä»¶
SHOW BINARY LOGS;
-- å…³æ³¨ï¼šæ–‡ä»¶æ•°é‡ã€æ–‡ä»¶å¤§å°
```

**çŠ¶æ€ç›‘æ§è¦ç‚¹**ï¼š

| ç›‘æ§é¡¹ | **æ­£å¸¸çŠ¶æ€** | **å¼‚å¸¸çŠ¶æ€** | **å¤„ç†å»ºè®®** |
|--------|-------------|-------------|-------------|
| æ–‡ä»¶åˆ‡æ¢ | `å®šæœŸåˆ‡æ¢` | `é•¿æ—¶é—´ä¸åˆ‡æ¢` | `æ£€æŸ¥max_binlog_sizeè®¾ç½®` |
| æ–‡ä»¶æ•°é‡ | `ç¬¦åˆé¢„æœŸ` | `è¿‡å¤šæˆ–è¿‡å°‘` | `è°ƒæ•´expire_logs_days` |
| å†™å…¥ä½ç½® | `æŒç»­å¢é•¿` | `åœæ­¢å¢é•¿` | `æ£€æŸ¥æ•°æ®åº“å†™å…¥çŠ¶æ€` |

### 2.3 å¤åˆ¶çŠ¶æ€ç›‘æ§


**ä¸»ä»å¤åˆ¶ç›‘æ§**ï¼šç¡®ä¿BINLOGæ­£å¸¸ä¼ è¾“

```sql
-- åœ¨ä»åº“æ‰§è¡Œ
SHOW SLAVE STATUS\G

-- é‡ç‚¹å…³æ³¨å­—æ®µï¼š
-- Slave_IO_Running: Yes/No
-- Slave_SQL_Running: Yes/No  
-- Seconds_Behind_Master: å»¶è¿Ÿç§’æ•°
-- Last_Error: é”™è¯¯ä¿¡æ¯
```

**å¤åˆ¶å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š

```bash
check_replication() {
    # æ£€æŸ¥IOçº¿ç¨‹çŠ¶æ€
    io_status=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Slave_IO_Running" | awk '{print $2}')
    
    # æ£€æŸ¥SQLçº¿ç¨‹çŠ¶æ€  
    sql_status=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Slave_SQL_Running" | awk '{print $2}')
    
    # æ£€æŸ¥å»¶è¿Ÿæ—¶é—´
    delay=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master" | awk '{print $2}')
    
    if [ "$io_status" != "Yes" ] || [ "$sql_status" != "Yes" ]; then
        echo "ğŸš¨ å¤åˆ¶çº¿ç¨‹å¼‚å¸¸ï¼IO:$io_status SQL:$sql_status"
        return 1
    fi
    
    if [ "$delay" -gt 300 ]; then  # å»¶è¿Ÿè¶…è¿‡5åˆ†é’Ÿ
        echo "âš ï¸ å¤åˆ¶å»¶è¿Ÿè¿‡å¤§ï¼š${delay}ç§’"
        return 1
    fi
    
    echo "âœ… å¤åˆ¶çŠ¶æ€æ­£å¸¸ï¼Œå»¶è¿Ÿï¼š${delay}ç§’"
}
```

---

## 3. ğŸ’¾ æ–‡ä»¶å¤§å°ä¸ç£ç›˜ç›‘æ§


### 3.1 BINLOGæ–‡ä»¶å¤§å°ç›‘æ§


**ä¸ºä»€ä¹ˆè¦ç›‘æ§æ–‡ä»¶å¤§å°**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
å•ä¸ªBINLOGæ–‡ä»¶è¿‡å¤§ â†’ ä¸»ä»åŒæ­¥æ…¢
æ–‡ä»¶è¿‡å° â†’ é¢‘ç¹åˆ‡æ¢ï¼Œå½±å“æ€§èƒ½
æ–‡ä»¶å¢é•¿å¼‚å¸¸ â†’ å¯èƒ½æœ‰å¤§æ‰¹é‡æ“ä½œ

ç›‘æ§ç›®æ ‡ï¼š
- å•æ–‡ä»¶å¤§å°æ§åˆ¶åœ¨åˆç†èŒƒå›´ï¼ˆé€šå¸¸100MB-1GBï¼‰
- æ–‡ä»¶å¢é•¿é€Ÿåº¦ç¬¦åˆä¸šåŠ¡é¢„æœŸ
- åŠæ—¶å‘ç°å¼‚å¸¸å¤§å°çš„æ–‡ä»¶
```

**æ–‡ä»¶å¤§å°æ£€æŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# BINLOGæ–‡ä»¶å¤§å°ç›‘æ§

monitor_binlog_size() {
    local max_size_mb=1024  # å•æ–‡ä»¶æœ€å¤§1GB
    local warn_size_mb=800  # è­¦å‘Šé˜ˆå€¼800MB
    
    # è·å–å½“å‰BINLOGæ–‡ä»¶å¤§å°
    current_file=$(mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $1}')
    binlog_dir="/var/lib/mysql"
    
    if [ -f "$binlog_dir/$current_file" ]; then
        size_mb=$(du -m "$binlog_dir/$current_file" | awk '{print $1}')
        
        if [ $size_mb -gt $max_size_mb ]; then
            echo "ğŸš¨ BINLOGæ–‡ä»¶è¿‡å¤§ï¼š${size_mb}MB"
            send_alert "BINLOGæ–‡ä»¶å¤§å°å¼‚å¸¸" "å½“å‰æ–‡ä»¶ï¼š$current_file å¤§å°ï¼š${size_mb}MB"
        elif [ $size_mb -gt $warn_size_mb ]; then
            echo "âš ï¸ BINLOGæ–‡ä»¶æ¥è¿‘ä¸Šé™ï¼š${size_mb}MB"
        else
            echo "âœ… BINLOGæ–‡ä»¶å¤§å°æ­£å¸¸ï¼š${size_mb}MB"
        fi
    fi
}
```

### 3.2 ç£ç›˜ç©ºé—´ç›‘æ§


**ç£ç›˜ç›‘æ§çš„é‡è¦æ€§**ï¼š

> âš ï¸ **ä¸¥é‡åæœ**  
> BINLOGç£ç›˜ç©ºé—´ä¸è¶³ â†’ æ•°æ®åº“æ— æ³•å†™å…¥ â†’ ä¸šåŠ¡ä¸­æ–­

**ç£ç›˜ç›‘æ§ç­–ç•¥**ï¼š

```bash
monitor_disk_space() {
    local binlog_dir="/var/lib/mysql"
    local critical_threshold=90  # 90%å‘Šè­¦
    local warning_threshold=80   # 80%é¢„è­¦
    
    # è·å–ç£ç›˜ä½¿ç”¨ç‡
    disk_usage=$(df "$binlog_dir" | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [ $disk_usage -gt $critical_threshold ]; then
        echo "ğŸš¨ BINLOGç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³ï¼š${disk_usage}%"
        # ç´§æ€¥å¤„ç†ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ—¥å¿—
        mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 3 DAY);"
        send_critical_alert "BINLOGç£ç›˜ç©ºé—´ç´§æ€¥"
    elif [ $disk_usage -gt $warning_threshold ]; then
        echo "âš ï¸ BINLOGç£ç›˜ç©ºé—´é¢„è­¦ï¼š${disk_usage}%"
        send_warning_alert "BINLOGç£ç›˜ç©ºé—´é¢„è­¦"
    else
        echo "âœ… BINLOGç£ç›˜ç©ºé—´å……è¶³ï¼š${disk_usage}%"
    fi
}
```

### 3.3 æ–‡ä»¶æ•°é‡ç›‘æ§


**æ–‡ä»¶æ•°é‡ç›‘æ§çš„æ„ä¹‰**ï¼š

```
æ–‡ä»¶è¿‡å¤šçš„é—®é¢˜ï¼š
- å ç”¨ç£ç›˜ç©ºé—´
- å½±å“å¤‡ä»½æ•ˆç‡
- ç®¡ç†å¤æ‚åº¦å¢åŠ 

æ–‡ä»¶è¿‡å°‘çš„é—®é¢˜ï¼š
- å¯èƒ½æ¸…ç†è¿‡åº¦
- ä¸åˆ©äºæ•…éšœæ¢å¤
- ç¼ºå°‘å†å²æ•°æ®
```

**æ–‡ä»¶æ•°é‡æ£€æŸ¥**ï¼š

```bash
monitor_binlog_count() {
    local max_files=100      # æœ€å¤§æ–‡ä»¶æ•°
    local min_files=7        # æœ€å°æ–‡ä»¶æ•°ï¼ˆä¸€å‘¨ï¼‰
    
    # ç»Ÿè®¡BINLOGæ–‡ä»¶æ•°é‡
    file_count=$(mysql -e "SHOW BINARY LOGS;" | wc -l)
    file_count=$((file_count - 1))  # å‡å»è¡¨å¤´
    
    if [ $file_count -gt $max_files ]; then
        echo "âš ï¸ BINLOGæ–‡ä»¶è¿‡å¤šï¼š${file_count}ä¸ª"
        echo "å»ºè®®æ‰§è¡Œæ¸…ç†æ“ä½œ"
    elif [ $file_count -lt $min_files ]; then
        echo "âš ï¸ BINLOGæ–‡ä»¶è¿‡å°‘ï¼š${file_count}ä¸ª"
        echo "æ£€æŸ¥æ˜¯å¦æ¸…ç†è¿‡åº¦"
    else
        echo "âœ… BINLOGæ–‡ä»¶æ•°é‡æ­£å¸¸ï¼š${file_count}ä¸ª"
    fi
}
```

---

## 4. âš¡ å†™å…¥æ€§èƒ½ä¸å¤åˆ¶å»¶è¿Ÿç›‘æ§


### 4.1 BINLOGå†™å…¥é€Ÿåº¦ç›‘æ§


**ä¸ºä»€ä¹ˆç›‘æ§å†™å…¥é€Ÿåº¦**ï¼š

```
å†™å…¥é€Ÿåº¦åæ˜ ï¼š
- æ•°æ®åº“å†™å…¥å‹åŠ›
- ç£ç›˜IOæ€§èƒ½
- ä¸šåŠ¡æ´»è·ƒç¨‹åº¦
- æ˜¯å¦æœ‰æ€§èƒ½ç“¶é¢ˆ

ç›‘æ§æŒ‡æ ‡ï¼š
- æ¯ç§’å†™å…¥å­—èŠ‚æ•°
- æ¯åˆ†é’Ÿæ–‡ä»¶å¢é•¿é‡
- å†™å…¥æ“ä½œé¢‘ç‡
```

**å†™å…¥é€Ÿåº¦ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# BINLOGå†™å…¥é€Ÿåº¦ç›‘æ§

monitor_binlog_write_speed() {
    local interval=60  # ç›‘æ§é—´éš”60ç§’
    
    # ç¬¬ä¸€æ¬¡é‡‡æ ·
    position1=$(mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $2}')
    file1=$(mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $1}')
    time1=$(date +%s)
    
    sleep $interval
    
    # ç¬¬äºŒæ¬¡é‡‡æ ·
    position2=$(mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $2}')
    file2=$(mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $1}')
    time2=$(date +%s)
    
    # è®¡ç®—å†™å…¥é€Ÿåº¦
    if [ "$file1" = "$file2" ]; then
        # åŒä¸€æ–‡ä»¶å†…çš„ä½ç½®å˜åŒ–
        bytes_written=$((position2 - position1))
    else
        # æ–‡ä»¶å‘ç”Ÿåˆ‡æ¢ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        echo "âš ï¸ BINLOGæ–‡ä»¶å‘ç”Ÿåˆ‡æ¢ï¼š$file1 â†’ $file2"
        return
    fi
    
    time_diff=$((time2 - time1))
    bytes_per_second=$((bytes_written / time_diff))
    mb_per_minute=$(echo "scale=2; $bytes_per_second * 60 / 1024 / 1024" | bc)
    
    echo "ğŸ“Š BINLOGå†™å…¥é€Ÿåº¦ï¼š${bytes_per_second} bytes/s (${mb_per_minute} MB/min)"
    
    # æ€§èƒ½å‘Šè­¦åˆ¤æ–­
    if [ $bytes_per_second -gt 10485760 ]; then  # 10MB/s
        echo "âš ï¸ BINLOGå†™å…¥é€Ÿåº¦è¿‡å¿«ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜"
    fi
}
```

### 4.2 å¤åˆ¶å»¶è¿Ÿæ·±åº¦ç›‘æ§


**å»¶è¿Ÿç›‘æ§çš„é‡è¦æ€§**ï¼š

```
å¤åˆ¶å»¶è¿Ÿå½±å“ï¼š
- æ•°æ®ä¸€è‡´æ€§
- è¯»å†™åˆ†ç¦»æ•ˆæœ
- æ•…éšœåˆ‡æ¢èƒ½åŠ›
- ä¸šåŠ¡æ•°æ®å‡†ç¡®æ€§

å»¶è¿Ÿç±»å‹ï¼š
IOå»¶è¿Ÿï¼šç½‘ç»œä¼ è¾“å»¶è¿Ÿ
SQLå»¶è¿Ÿï¼šä»åº“æ‰§è¡Œå»¶è¿Ÿ
```

**è¯¦ç»†å»¶è¿Ÿç›‘æ§**ï¼š

```bash
monitor_replication_delay() {
    # è·å–è¯¦ç»†å¤åˆ¶çŠ¶æ€
    slave_status=$(mysql -e "SHOW SLAVE STATUS\G")
    
    # æå–å…³é”®æŒ‡æ ‡
    io_running=$(echo "$slave_status" | grep "Slave_IO_Running" | awk '{print $2}')
    sql_running=$(echo "$slave_status" | grep "Slave_SQL_Running" | awk '{print $2}')
    seconds_behind=$(echo "$slave_status" | grep "Seconds_Behind_Master" | awk '{print $2}')
    master_log_file=$(echo "$slave_status" | grep "Master_Log_File" | awk '{print $2}')
    read_master_log_pos=$(echo "$slave_status" | grep "Read_Master_Log_Pos" | awk '{print $2}')
    relay_master_log_file=$(echo "$slave_status" | grep "Relay_Master_Log_File" | awk '{print $2}')
    exec_master_log_pos=$(echo "$slave_status" | grep "Exec_Master_Log_Pos" | awk '{print $2}')
    
    echo "ğŸ“Š å¤åˆ¶çŠ¶æ€è¯¦æƒ…ï¼š"
    echo "  IOçº¿ç¨‹: $io_running"
    echo "  SQLçº¿ç¨‹: $sql_running"
    echo "  å»¶è¿Ÿæ—¶é—´: ${seconds_behind}ç§’"
    echo "  ä¸»åº“æ—¥å¿—: $master_log_file:$read_master_log_pos"
    echo "  æ‰§è¡Œä½ç½®: $relay_master_log_file:$exec_master_log_pos"
    
    # è®¡ç®—å…·ä½“å»¶è¿Ÿç±»å‹
    if [ "$master_log_file" != "$relay_master_log_file" ]; then
        echo "âš ï¸ æ£€æµ‹åˆ°IOå»¶è¿Ÿï¼šæ—¥å¿—æ–‡ä»¶æœªåŒæ­¥"
    elif [ "$read_master_log_pos" != "$exec_master_log_pos" ]; then
        echo "âš ï¸ æ£€æµ‹åˆ°SQLå»¶è¿Ÿï¼šæ‰§è¡Œä½ç½®è½å"
    fi
    
    # å»¶è¿Ÿå‘Šè­¦
    if [ "$seconds_behind" != "NULL" ] && [ $seconds_behind -gt 30 ]; then
        if [ $seconds_behind -gt 300 ]; then
            echo "ğŸš¨ ä¸¥é‡å»¶è¿Ÿå‘Šè­¦ï¼š${seconds_behind}ç§’"
        else
            echo "âš ï¸ å»¶è¿Ÿé¢„è­¦ï¼š${seconds_behind}ç§’"
        fi
    fi
}
```

### 4.3 ç½‘ç»œä¼ è¾“ç›‘æ§


**ç½‘ç»œç›‘æ§æŒ‡æ ‡**ï¼š

```bash
monitor_network_binlog() {
    # ç›‘æ§BINLOGç›¸å…³ç½‘ç»œæµé‡
    local interface="eth0"
    
    # è·å–ç½‘ç»œç»Ÿè®¡
    rx_bytes_before=$(cat /proc/net/dev | grep $interface | awk '{print $2}')
    tx_bytes_before=$(cat /proc/net/dev | grep $interface | awk '{print $10}')
    
    sleep 10
    
    rx_bytes_after=$(cat /proc/net/dev | grep $interface | awk '{print $2}')
    tx_bytes_after=$(cat /proc/net/dev | grep $interface | awk '{print $10}')
    
    # è®¡ç®—ä¼ è¾“é€Ÿç‡
    rx_speed=$(( (rx_bytes_after - rx_bytes_before) / 10 ))
    tx_speed=$(( (tx_bytes_after - tx_bytes_before) / 10 ))
    
    echo "ğŸ“Š ç½‘ç»œä¼ è¾“é€Ÿç‡ï¼š"
    echo "  æ¥æ”¶: $(( rx_speed / 1024 )) KB/s"
    echo "  å‘é€: $(( tx_speed / 1024 )) KB/s"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸æµé‡
    if [ $tx_speed -gt 104857600 ]; then  # 100MB/s
        echo "âš ï¸ BINLOGä¼ è¾“æµé‡å¼‚å¸¸å¤§"
    fi
}
```

---

## 5. ğŸ”§ ç›‘æ§å·¥å…·ä¸å¹³å°é›†æˆ


### 5.1 Zabbixé›†æˆç›‘æ§


**Zabbixæ¨¡æ¿é…ç½®**ï¼š

```bash
# Zabbixç”¨æˆ·å‚æ•°é…ç½®æ–‡ä»¶
# /etc/zabbix/zabbix_agentd.d/mysql_binlog.conf

# BINLOGçŠ¶æ€æ£€æŸ¥
UserParameter=mysql.binlog.status,mysql -e "SHOW VARIABLES LIKE 'log_bin';" | grep log_bin | awk '{print $2}'

# BINLOGæ–‡ä»¶æ•°é‡
UserParameter=mysql.binlog.count,mysql -e "SHOW BINARY LOGS;" | wc -l | awk '{print $1-1}'

# å½“å‰BINLOGæ–‡ä»¶å¤§å°
UserParameter=mysql.binlog.size,mysql -e "SHOW MASTER STATUS;" | tail -1 | awk '{print $2}'

# å¤åˆ¶å»¶è¿Ÿ
UserParameter=mysql.slave.delay,mysql -e "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master" | awk '{print $2}'

# ç£ç›˜ä½¿ç”¨ç‡
UserParameter=mysql.binlog.disk,df /var/lib/mysql | tail -1 | awk '{print $5}' | sed 's/%//'
```

**Zabbixç›‘æ§é¡¹é…ç½®**ï¼š

| ç›‘æ§é¡¹ | **é”®å€¼** | **æ›´æ–°é—´éš”** | **å‘Šè­¦é˜ˆå€¼** |
|--------|----------|-------------|-------------|
| BINLOGçŠ¶æ€ | `mysql.binlog.status` | `60s` | `â‰  ON` |
| æ–‡ä»¶æ•°é‡ | `mysql.binlog.count` | `300s` | `> 50` |
| å¤åˆ¶å»¶è¿Ÿ | `mysql.slave.delay` | `60s` | `> 300` |
| ç£ç›˜ä½¿ç”¨ç‡ | `mysql.binlog.disk` | `60s` | `> 80%` |

### 5.2 Prometheusç›‘æ§


**PrometheusæŒ‡æ ‡æ”¶é›†**ï¼š

```yaml
# mysql_exporteré…ç½®
# my.cnfé…ç½®æ®µ
[client]
user=mysql_exporter
password=your_password
host=localhost
port=3306

# å…³é”®æŒ‡æ ‡è¯´æ˜
mysql_global_variables_log_bin          # BINLOGæ˜¯å¦å¼€å¯
mysql_slave_lag_seconds                 # å¤åˆ¶å»¶è¿Ÿç§’æ•°  
mysql_info_schema_table_size_bytes      # è¡¨å¤§å°ä¿¡æ¯
mysql_binlog_size_bytes                 # BINLOGå¤§å°
```

**Grafanaä»ªè¡¨æ¿é…ç½®**ï¼š

```json
{
  "dashboard": {
    "title": "MySQL BINLOGç›‘æ§",
    "panels": [
      {
        "title": "BINLOGæ–‡ä»¶å¤§å°è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "mysql_binlog_size_bytes",
            "legendFormat": "BINLOGå¤§å°"
          }
        ]
      },
      {
        "title": "å¤åˆ¶å»¶è¿Ÿ",
        "type": "stat",
        "targets": [
          {
            "expr": "mysql_slave_lag_seconds",
            "legendFormat": "å»¶è¿Ÿç§’æ•°"
          }
        ]
      }
    ]
  }
}
```

### 5.3 è‡ªå®šä¹‰ç›‘æ§å¹³å°


**ç›‘æ§æ•°æ®APIæ¥å£**ï¼š

```python
#!/usr/bin/env python3
# MySQL BINLOGç›‘æ§API

import pymysql
import json
from flask import Flask, jsonify

app = Flask(__name__)

def get_mysql_connection():
    return pymysql.connect(
        host='localhost',
        user='monitor',
        password='password',
        database='mysql'
    )

@app.route('/api/binlog/status')
def binlog_status():
    """è·å–BINLOGçŠ¶æ€ä¿¡æ¯"""
    conn = get_mysql_connection()
    cursor = conn.cursor()
    
    # è·å–åŸºç¡€çŠ¶æ€
    cursor.execute("SHOW VARIABLES LIKE 'log_bin'")
    log_bin_status = cursor.fetchone()[1]
    
    cursor.execute("SHOW MASTER STATUS")
    master_status = cursor.fetchone()
    
    cursor.execute("SHOW BINARY LOGS")
    binary_logs = cursor.fetchall()
    
    result = {
        'binlog_enabled': log_bin_status == 'ON',
        'current_file': master_status[0],
        'current_position': master_status[1], 
        'file_count': len(binary_logs),
        'total_size': sum([log[1] for log in binary_logs]),
        'timestamp': time.time()
    }
    
    cursor.close()
    conn.close()
    
    return jsonify(result)

@app.route('/api/binlog/replication')  
def replication_status():
    """è·å–å¤åˆ¶çŠ¶æ€ä¿¡æ¯"""
    conn = get_mysql_connection()
    cursor = conn.cursor()
    
    cursor.execute("SHOW SLAVE STATUS")
    slave_status = cursor.fetchone()
    
    if slave_status:
        result = {
            'io_running': slave_status[10] == 'Yes',
            'sql_running': slave_status[11] == 'Yes',
            'seconds_behind_master': slave_status[32],
            'last_error': slave_status[19],
            'master_log_file': slave_status[5],
            'read_master_log_pos': slave_status[6]
        }
    else:
        result = {'error': 'Not a slave server'}
    
    cursor.close() 
    conn.close()
    
    return jsonify(result)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
```

---

## 6. ğŸš¨ å‘Šè­¦ç­–ç•¥ä¸é˜ˆå€¼è®¾ç½®


### 6.1 å‘Šè­¦çº§åˆ«å®šä¹‰


**å‘Šè­¦ä¸¥é‡æ€§åˆ†çº§**ï¼š

```
å‘Šè­¦çº§åˆ«ä½“ç³»ï¼š

ğŸ”´ ä¸¥é‡å‘Šè­¦ (Critical)
- BINLOGç£ç›˜ç©ºé—´ > 90%
- å¤åˆ¶ä¸­æ–­ (IO/SQLçº¿ç¨‹åœæ­¢)
- BINLOGæœåŠ¡å¼‚å¸¸å…³é—­

ğŸŸ¡ è­¦å‘Šå‘Šè­¦ (Warning)  
- BINLOGç£ç›˜ç©ºé—´ > 80%
- å¤åˆ¶å»¶è¿Ÿ > 5åˆ†é’Ÿ
- æ–‡ä»¶å¤§å°å¼‚å¸¸

ğŸ”µ ä¿¡æ¯å‘Šè­¦ (Info)
- æ–‡ä»¶åˆ‡æ¢é¢‘ç¹
- å†™å…¥é€Ÿåº¦å¼‚å¸¸
- ç½‘ç»œå»¶è¿Ÿå¢åŠ 
```

### 6.2 åŠ¨æ€é˜ˆå€¼è®¾ç½®


**æ™ºèƒ½é˜ˆå€¼ç­–ç•¥**ï¼š

```bash
#!/bin/bash
# åŠ¨æ€é˜ˆå€¼è®¡ç®—

calculate_dynamic_threshold() {
    local metric=$1
    local history_days=7
    
    # è·å–å†å²æ•°æ®
    history_data=$(get_metric_history "$metric" "$history_days")
    
    # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
    avg=$(echo "$history_data" | awk '{sum+=$1} END {print sum/NR}')
    max=$(echo "$history_data" | sort -n | tail -1)
    min=$(echo "$history_data" | sort -n | head -1)
    
    # è®¡ç®—æ ‡å‡†å·®
    stddev=$(echo "$history_data" | awk -v avg=$avg '
        {sum+=($1-avg)^2} 
        END {print sqrt(sum/NR)}
    ')
    
    # åŠ¨æ€é˜ˆå€¼ = å‡å€¼ + 2å€æ ‡å‡†å·®
    warning_threshold=$(echo "$avg + 2 * $stddev" | bc)
    critical_threshold=$(echo "$avg + 3 * $stddev" | bc)
    
    echo "åŠ¨æ€é˜ˆå€¼ - è­¦å‘Š:$warning_threshold ä¸¥é‡:$critical_threshold"
}
```

### 6.3 å‘Šè­¦æŠ‘åˆ¶ä¸æ”¶æ•›


**å‘Šè­¦æ”¶æ•›ç­–ç•¥**ï¼š

```bash
# å‘Šè­¦çŠ¶æ€ç®¡ç†
declare -A alert_status
declare -A alert_count
declare -A alert_last_time

send_smart_alert() {
    local alert_type=$1
    local message=$2
    local current_time=$(date +%s)
    local suppress_duration=300  # 5åˆ†é’ŸæŠ‘åˆ¶æœŸ
    
    # æ£€æŸ¥æ˜¯å¦åœ¨æŠ‘åˆ¶æœŸå†…
    if [[ ${alert_last_time[$alert_type]} ]]; then
        local time_diff=$((current_time - ${alert_last_time[$alert_type]}))
        if [ $time_diff -lt $suppress_duration ]; then
            echo "å‘Šè­¦è¢«æŠ‘åˆ¶ï¼š$alert_type (è·ç¦»ä¸Šæ¬¡ ${time_diff}ç§’)"
            return
        fi
    fi
    
    # è®¡æ•°ç®¡ç†
    alert_count[$alert_type]=$((${alert_count[$alert_type]:-0} + 1))
    alert_last_time[$alert_type]=$current_time
    
    # å‘é€å‘Šè­¦
    if [ ${alert_count[$alert_type]} -eq 1 ]; then
        # é¦–æ¬¡å‘Šè­¦ - ç«‹å³å‘é€
        send_alert_notification "$alert_type" "$message"
    elif [ $((${alert_count[$alert_type]} % 5)) -eq 0 ]; then
        # æ¯5æ¬¡å‘Šè­¦å‘é€ä¸€æ¬¡æ±‡æ€»
        send_alert_notification "$alert_type" "å‘Šè­¦æŒç»­ï¼Œç¬¬${alert_count[$alert_type]}æ¬¡: $message"
    fi
}
```

### 6.4 å¤šæ¸ é“å‘Šè­¦é€šçŸ¥


**å‘Šè­¦é€šçŸ¥å®ç°**ï¼š

```bash
#!/bin/bash
# å¤šæ¸ é“å‘Šè­¦é€šçŸ¥

send_alert_notification() {
    local alert_level=$1
    local alert_type=$2  
    local message=$3
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # æ ¼å¼åŒ–å‘Šè­¦æ¶ˆæ¯
    alert_msg="[MySQL BINLOGå‘Šè­¦]
æ—¶é—´: $timestamp
çº§åˆ«: $alert_level
ç±»å‹: $alert_type  
å†…å®¹: $message
ä¸»æœº: $(hostname)
IP: $(hostname -I | awk '{print $1}')"

    case $alert_level in
        "CRITICAL")
            # ä¸¥é‡å‘Šè­¦ - å¤šæ¸ é“é€šçŸ¥
            send_email_alert "$alert_msg"
            send_sms_alert "$alert_msg"
            send_webhook_alert "$alert_msg"
            ;;
        "WARNING")
            # è­¦å‘Šå‘Šè­¦ - é‚®ä»¶+Webhook
            send_email_alert "$alert_msg"
            send_webhook_alert "$alert_msg"
            ;;
        "INFO")
            # ä¿¡æ¯å‘Šè­¦ - ä»…Webhook
            send_webhook_alert "$alert_msg"
            ;;
    esac
}

send_email_alert() {
    local message=$1
    echo "$message" | mail -s "MySQL BINLOGå‘Šè­¦" admin@company.com
}

send_sms_alert() {
    local message=$1
    # è°ƒç”¨çŸ­ä¿¡API
    curl -X POST "https://sms-api.com/send" \
         -d "phone=13800000000" \
         -d "message=$message"
}

send_webhook_alert() {
    local message=$1
    # å‘é€åˆ°é’‰é’‰/ä¼ä¸šå¾®ä¿¡
    curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN" \
         -H "Content-Type: application/json" \
         -d "{
             \"msgtype\": \"text\",
             \"text\": {
                 \"content\": \"$message\"
             }
         }"
}
```

---

## 7. ğŸ’» ç›‘æ§è„šæœ¬å¼€å‘å®æˆ˜


### 7.1 ç»¼åˆç›‘æ§è„šæœ¬


**å®Œæ•´ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# MySQL BINLOGç»¼åˆç›‘æ§è„šæœ¬
# æ–‡ä»¶ï¼šmysql_binlog_monitor.sh

# é…ç½®å‚æ•°
MYSQL_USER="monitor"
MYSQL_PASS="password"
MYSQL_HOST="localhost"
MYSQL_PORT="3306"
BINLOG_DIR="/var/lib/mysql"
LOG_FILE="/var/log/mysql_binlog_monitor.log"

# æ—¥å¿—å‡½æ•°
log_message() {
    local level=$1
    local message=$2
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $message" | tee -a "$LOG_FILE"
}

# MySQLè¿æ¥å‡½æ•°
mysql_exec() {
    local sql=$1
    mysql -h"$MYSQL_HOST" -P"$MYSQL_PORT" -u"$MYSQL_USER" -p"$MYSQL_PASS" -e "$sql" 2>/dev/null
}

# ä¸»ç›‘æ§å‡½æ•°
main_monitor() {
    log_message "INFO" "å¼€å§‹BINLOGç›‘æ§æ£€æŸ¥"
    
    # 1. åŸºç¡€çŠ¶æ€æ£€æŸ¥
    check_binlog_basic_status
    
    # 2. æ–‡ä»¶ç›‘æ§  
    check_binlog_files
    
    # 3. ç£ç›˜ç›‘æ§
    check_disk_space
    
    # 4. å¤åˆ¶ç›‘æ§
    check_replication_status
    
    # 5. æ€§èƒ½ç›‘æ§
    check_performance_metrics
    
    log_message "INFO" "BINLOGç›‘æ§æ£€æŸ¥å®Œæˆ"
}

# åŸºç¡€çŠ¶æ€æ£€æŸ¥
check_binlog_basic_status() {
    log_message "INFO" "æ£€æŸ¥BINLOGåŸºç¡€çŠ¶æ€"
    
    # æ£€æŸ¥BINLOGæ˜¯å¦å¼€å¯
    binlog_enabled=$(mysql_exec "SHOW VARIABLES LIKE 'log_bin';" | grep log_bin | awk '{print $2}')
    
    if [ "$binlog_enabled" != "ON" ]; then
        log_message "CRITICAL" "BINLOGæœªå¼€å¯"
        send_alert "CRITICAL" "BINLOGçŠ¶æ€å¼‚å¸¸" "BINLOGæœåŠ¡æœªå¼€å¯"
        return 1
    fi
    
    # æ£€æŸ¥BINLOGæ ¼å¼
    binlog_format=$(mysql_exec "SHOW VARIABLES LIKE 'binlog_format';" | grep binlog_format | awk '{print $2}')
    log_message "INFO" "BINLOGæ ¼å¼: $binlog_format"
    
    # æ£€æŸ¥å½“å‰çŠ¶æ€
    master_status=$(mysql_exec "SHOW MASTER STATUS;")
    if [ -z "$master_status" ]; then
        log_message "CRITICAL" "æ— æ³•è·å–MASTERçŠ¶æ€"
        send_alert "CRITICAL" "BINLOGçŠ¶æ€å¼‚å¸¸" "æ— æ³•è·å–MASTERçŠ¶æ€"
        return 1
    fi
    
    log_message "INFO" "BINLOGåŸºç¡€çŠ¶æ€æ­£å¸¸"
}

# æ–‡ä»¶ç›‘æ§
check_binlog_files() {
    log_message "INFO" "æ£€æŸ¥BINLOGæ–‡ä»¶çŠ¶æ€"
    
    # è·å–æ–‡ä»¶åˆ—è¡¨
    binary_logs=$(mysql_exec "SHOW BINARY LOGS;")
    file_count=$(echo "$binary_logs" | wc -l)
    file_count=$((file_count - 1))  # å‡å»è¡¨å¤´
    
    # æ–‡ä»¶æ•°é‡æ£€æŸ¥
    if [ $file_count -gt 100 ]; then
        log_message "WARNING" "BINLOGæ–‡ä»¶è¿‡å¤š: $file_count ä¸ª"
        send_alert "WARNING" "BINLOGæ–‡ä»¶æ•°é‡" "å½“å‰æ–‡ä»¶æ•°: $file_count"
    elif [ $file_count -lt 3 ]; then
        log_message "WARNING" "BINLOGæ–‡ä»¶è¿‡å°‘: $file_count ä¸ª"  
        send_alert "WARNING" "BINLOGæ–‡ä»¶æ•°é‡" "å½“å‰æ–‡ä»¶æ•°: $file_count"
    fi
    
    # å½“å‰æ–‡ä»¶å¤§å°æ£€æŸ¥
    current_file=$(mysql_exec "SHOW MASTER STATUS;" | tail -1 | awk '{print $1}')
    if [ -f "$BINLOG_DIR/$current_file" ]; then
        file_size_mb=$(du -m "$BINLOG_DIR/$current_file" | awk '{print $1}')
        
        if [ $file_size_mb -gt 1024 ]; then  # 1GB
            log_message "WARNING" "å½“å‰BINLOGæ–‡ä»¶è¿‡å¤§: ${file_size_mb}MB"
            send_alert "WARNING" "BINLOGæ–‡ä»¶å¤§å°" "å½“å‰æ–‡ä»¶: $current_file å¤§å°: ${file_size_mb}MB"
        fi
    fi
    
    log_message "INFO" "BINLOGæ–‡ä»¶çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œæ–‡ä»¶æ•°: $file_count"
}

# ç£ç›˜ç©ºé—´æ£€æŸ¥
check_disk_space() {
    log_message "INFO" "æ£€æŸ¥BINLOGç£ç›˜ç©ºé—´"
    
    disk_usage=$(df "$BINLOG_DIR" | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [ $disk_usage -gt 90 ]; then
        log_message "CRITICAL" "BINLOGç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³: ${disk_usage}%"
        send_alert "CRITICAL" "ç£ç›˜ç©ºé—´ç´§æ€¥" "ä½¿ç”¨ç‡: ${disk_usage}%"
        
        # è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„æ—¥å¿—
        log_message "INFO" "å°è¯•è‡ªåŠ¨æ¸…ç†è¿‡æœŸBINLOG"
        mysql_exec "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"
        
    elif [ $disk_usage -gt 80 ]; then
        log_message "WARNING" "BINLOGç£ç›˜ç©ºé—´é¢„è­¦: ${disk_usage}%"
        send_alert "WARNING" "ç£ç›˜ç©ºé—´é¢„è­¦" "ä½¿ç”¨ç‡: ${disk_usage}%"
    fi
    
    log_message "INFO" "ç£ç›˜ç©ºé—´æ£€æŸ¥å®Œæˆï¼Œä½¿ç”¨ç‡: ${disk_usage}%"
}

# å¤åˆ¶çŠ¶æ€æ£€æŸ¥
check_replication_status() {
    log_message "INFO" "æ£€æŸ¥å¤åˆ¶çŠ¶æ€"
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºä»åº“
    slave_status=$(mysql_exec "SHOW SLAVE STATUS\G")
    
    if [ -z "$slave_status" ]; then
        log_message "INFO" "å½“å‰æœåŠ¡å™¨ä¸æ˜¯ä»åº“ï¼Œè·³è¿‡å¤åˆ¶æ£€æŸ¥"
        return 0
    fi
    
    # æå–å…³é”®æŒ‡æ ‡
    io_running=$(echo "$slave_status" | grep "Slave_IO_Running" | awk '{print $2}')
    sql_running=$(echo "$slave_status" | grep "Slave_SQL_Running" | awk '{print $2}')
    seconds_behind=$(echo "$slave_status" | grep "Seconds_Behind_Master" | awk '{print $2}')
    last_error=$(echo "$slave_status" | grep "Last_Error" | cut -d: -f2-)
    
    # æ£€æŸ¥å¤åˆ¶çº¿ç¨‹çŠ¶æ€
    if [ "$io_running" != "Yes" ] || [ "$sql_running" != "Yes" ]; then
        log_message "CRITICAL" "å¤åˆ¶çº¿ç¨‹å¼‚å¸¸ IO:$io_running SQL:$sql_running"
        send_alert "CRITICAL" "å¤åˆ¶ä¸­æ–­" "IOçº¿ç¨‹:$io_running SQLçº¿ç¨‹:$sql_running é”™è¯¯:$last_error"
        return 1
    fi
    
    # æ£€æŸ¥å»¶è¿Ÿ
    if [ "$seconds_behind" != "NULL" ] && [ "$seconds_behind" != "0" ]; then
        if [ $seconds_behind -gt 300 ]; then  # 5åˆ†é’Ÿ
            log_message "CRITICAL" "å¤åˆ¶ä¸¥é‡å»¶è¿Ÿ: ${seconds_behind}ç§’"
            send_alert "CRITICAL" "å¤åˆ¶å»¶è¿Ÿä¸¥é‡" "å»¶è¿Ÿæ—¶é—´: ${seconds_behind}ç§’"
        elif [ $seconds_behind -gt 60 ]; then  # 1åˆ†é’Ÿ
            log_message "WARNING" "å¤åˆ¶å»¶è¿Ÿé¢„è­¦: ${seconds_behind}ç§’"
            send_alert "WARNING" "å¤åˆ¶å»¶è¿Ÿé¢„è­¦" "å»¶è¿Ÿæ—¶é—´: ${seconds_behind}ç§’"
        fi
    fi
    
    log_message "INFO" "å¤åˆ¶çŠ¶æ€æ£€æŸ¥å®Œæˆï¼Œå»¶è¿Ÿ: ${seconds_behind}ç§’"
}

# æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥  
check_performance_metrics() {
    log_message "INFO" "æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡"
    
    # è·å–BINLOGç›¸å…³çŠ¶æ€å˜é‡
    binlog_cache_use=$(mysql_exec "SHOW STATUS LIKE 'Binlog_cache_use';" | awk '{print $2}')
    binlog_cache_disk_use=$(mysql_exec "SHOW STATUS LIKE 'Binlog_cache_disk_use';" | awk '{print $2}')
    
    # è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
    if [ $binlog_cache_use -gt 0 ]; then
        cache_hit_rate=$(echo "scale=2; (1 - $binlog_cache_disk_use / $binlog_cache_use) * 100" | bc)
        log_message "INFO" "BINLOGç¼“å­˜å‘½ä¸­ç‡: ${cache_hit_rate}%"
        
        if [ $(echo "$cache_hit_rate < 95" | bc) -eq 1 ]; then
            log_message "WARNING" "BINLOGç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: ${cache_hit_rate}%"
            send_alert "WARNING" "æ€§èƒ½é¢„è­¦" "BINLOGç¼“å­˜å‘½ä¸­ç‡: ${cache_hit_rate}%"
        fi
    fi
}

# å‘Šè­¦å‘é€å‡½æ•°
send_alert() {
    local level=$1
    local type=$2
    local message=$3
    
    # è¿™é‡Œé›†æˆå®é™…çš„å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ
    log_message "ALERT" "[$level] $type: $message"
    
    # ç¤ºä¾‹ï¼šå‘é€åˆ°é’‰é’‰
    # curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN" \
    #      -H "Content-Type: application/json" \
    #      -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"[$level] $type: $message\"}}"
}

# è„šæœ¬å…¥å£
main() {
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    mkdir -p "$(dirname "$LOG_FILE")"
    
    # æ‰§è¡Œç›‘æ§
    main_monitor
    
    # æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™30å¤©ï¼‰
    find "$(dirname "$LOG_FILE")" -name "*.log" -mtime +30 -delete
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 7.2 å®šæ—¶ä»»åŠ¡é…ç½®


**Crontabå®šæ—¶æ‰§è¡Œ**ï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ç›‘æ§ä»»åŠ¡
# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡åŸºç¡€ç›‘æ§
*/5 * * * * /usr/local/bin/mysql_binlog_monitor.sh

# æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡è¯¦ç»†æ£€æŸ¥
0 * * * * /usr/local/bin/mysql_binlog_monitor.sh --detailed

# æ¯å¤©å‡Œæ™¨æ‰§è¡Œæ¸…ç†ä»»åŠ¡
0 2 * * * /usr/local/bin/mysql_binlog_cleanup.sh

# æ¯å‘¨ç”Ÿæˆç›‘æ§æŠ¥å‘Š
0 6 * * 1 /usr/local/bin/mysql_binlog_report.sh
```

### 7.3 ç›‘æ§æ•°æ®å¯è§†åŒ–


**ç›‘æ§æ•°æ®æ”¶é›†è„šæœ¬**ï¼š

```bash
#!/bin/bash
# ç›‘æ§æ•°æ®æ”¶é›†å¹¶å­˜å‚¨åˆ°InfluxDB

collect_metrics() {
    local timestamp=$(date +%s)
    
    # æ”¶é›†å„é¡¹æŒ‡æ ‡
    binlog_enabled=$(mysql_exec "SHOW VARIABLES LIKE 'log_bin';" | grep log_bin | awk '{print $2=="ON" ? 1 : 0}')
    file_count=$(mysql_exec "SHOW BINARY LOGS;" | wc -l)
    disk_usage=$(df /var/lib/mysql | tail -1 | awk '{print $5}' | sed 's/%//')
    
    # å‘é€åˆ°InfluxDB
    curl -i -XPOST 'http://localhost:8086/write?db=mysql_monitoring' \
         --data-binary "
mysql_binlog,host=$(hostname) enabled=${binlog_enabled}i,file_count=${file_count}i,disk_usage=${disk_usage}i ${timestamp}000000000
"
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ BINLOGç›‘æ§æœ¬è´¨ï¼šé¢„é˜²å¼è¿ç»´ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’ŒæœåŠ¡ç¨³å®š
ğŸ”¸ ç›‘æ§ç»´åº¦ï¼šçŠ¶æ€ã€æ€§èƒ½ã€å®¹é‡ã€å¤åˆ¶å››å¤§ç»´åº¦å…¨è¦†ç›–
ğŸ”¸ å‘Šè­¦ç­–ç•¥ï¼šåˆ†çº§å‘Šè­¦ã€æ™ºèƒ½é˜ˆå€¼ã€å¤šæ¸ é“é€šçŸ¥
ğŸ”¸ è‡ªåŠ¨åŒ–å¤„ç†ï¼šç›‘æ§è„šæœ¬åŒ–ã€å‘Šè­¦è‡ªåŠ¨åŒ–ã€é—®é¢˜è‡ªä¿®å¤
ğŸ”¸ å¹³å°é›†æˆï¼šæ”¯æŒä¸»æµç›‘æ§å¹³å°ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆBINLOGç›‘æ§å¦‚æ­¤é‡è¦**
```
æ•°æ®å®‰å…¨ä¿éšœï¼š
- BINLOGæ˜¯æ•°æ®æ¢å¤çš„åŸºç¡€
- å¤åˆ¶åŒæ­¥çš„å…³é”®ç»„ä»¶  
- æ•…éšœæ’æŸ¥çš„é‡è¦ä¾æ®

ä¸šåŠ¡è¿ç»­æ€§ï¼š
- é˜²æ­¢ç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´æœåŠ¡ä¸­æ–­
- åŠæ—¶å‘ç°å¤åˆ¶é—®é¢˜é¿å…æ•°æ®ä¸ä¸€è‡´
- æ€§èƒ½å¼‚å¸¸æ—©æœŸé¢„è­¦
```

**ğŸ”¹ ç›‘æ§æŒ‡æ ‡çš„ä¼˜å…ˆçº§**
```
ğŸ”´ ä¸¥é‡çº§åˆ«ï¼š
- BINLOGæœåŠ¡çŠ¶æ€ (å¼€å¯/å…³é—­)
- ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ (>90%)
- å¤åˆ¶çº¿ç¨‹çŠ¶æ€ (ä¸­æ–­)

ğŸŸ¡ è­¦å‘Šçº§åˆ«ï¼š  
- å¤åˆ¶å»¶è¿Ÿæ—¶é—´ (>5åˆ†é’Ÿ)
- æ–‡ä»¶å¤§å°å¼‚å¸¸ (è¿‡å¤§/è¿‡å°)
- æ€§èƒ½æŒ‡æ ‡å¼‚å¸¸

ğŸ”µ ä¿¡æ¯çº§åˆ«ï¼š
- æ–‡ä»¶æ•°é‡å˜åŒ–
- å†™å…¥é€Ÿåº¦æ³¢åŠ¨
- ç½‘ç»œä¼ è¾“çŠ¶æ€
```

**ğŸ”¹ è‡ªåŠ¨åŒ–å¤„ç†çš„è¾¹ç•Œ**
```
å¯ä»¥è‡ªåŠ¨å¤„ç†ï¼š
âœ… æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶
âœ… å‘é€å‘Šè­¦é€šçŸ¥  
âœ… æ”¶é›†ç›‘æ§æ•°æ®
âœ… ç”ŸæˆçŠ¶æ€æŠ¥å‘Š

éœ€è¦äººå·¥ä»‹å…¥ï¼š
âŒ ä¿®å¤å¤åˆ¶é”™è¯¯
âŒ è°ƒæ•´é…ç½®å‚æ•°
âŒ å¤„ç†ç£ç›˜æ•…éšœ
âŒ ä¸šåŠ¡å½±å“å†³ç­–
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


- **æ•…éšœé¢„é˜²**ï¼š90%çš„BINLOGç›¸å…³æ•…éšœå¯é€šè¿‡ç›‘æ§æå‰å‘ç°
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºç›‘æ§æ•°æ®è¿›è¡Œå®¹é‡è§„åˆ’å’Œæ€§èƒ½è°ƒä¼˜
- **è¿ç»´æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–ç›‘æ§å‡å°‘80%çš„äººå·¥æ£€æŸ¥å·¥ä½œ
- **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿BINLOGå®Œæ•´æ€§ï¼Œä¿éšœæ•°æ®æ¢å¤èƒ½åŠ›
- **åˆè§„å®¡è®¡**ï¼šç›‘æ§æ—¥å¿—ä¸ºå®¡è®¡æä¾›å®Œæ•´çš„æ“ä½œè®°å½•

### 8.4 ç›‘æ§æœ€ä½³å®è·µ


```
ğŸ“‹ ç›‘æ§æ¸…å•ï¼š
âœ… å»ºç«‹åˆ†å±‚ç›‘æ§ä½“ç³»ï¼ˆåŸºç¡€â†’åº”ç”¨â†’ä¸šåŠ¡ï¼‰
âœ… è®¾ç½®åˆç†å‘Šè­¦é˜ˆå€¼ï¼ˆé¿å…å‘Šè­¦é£æš´ï¼‰
âœ… å®ç°ç›‘æ§æ•°æ®çš„é•¿æœŸå­˜å‚¨å’Œåˆ†æ
âœ… å®šæœŸreviewå’Œä¼˜åŒ–ç›‘æ§ç­–ç•¥
âœ… å»ºç«‹ç›‘æ§æ•…éšœçš„åº”æ€¥å“åº”æµç¨‹

âš ï¸ å¸¸è§è¯¯åŒºï¼š
âŒ ç›‘æ§æŒ‡æ ‡è¿‡å¤šå¯¼è‡´é‡ç‚¹ä¸çªå‡º
âŒ å‘Šè­¦é˜ˆå€¼è®¾ç½®ä¸å½“ï¼ˆè¿‡æ•æ„Ÿæˆ–è¿‡è¿Ÿé’ï¼‰  
âŒ åªç›‘æ§ä¸åˆ†æï¼Œç¼ºå°‘æ•°æ®ä»·å€¼æŒ–æ˜
âŒ ç›‘æ§ç³»ç»Ÿæœ¬èº«ç¼ºå°‘å¯é æ€§ä¿éšœ
âŒ ç¼ºå°‘ç›‘æ§æ•ˆæœçš„éªŒè¯å’Œæ¼”ç»ƒ
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- BINLOGç›‘æ§æ˜¯MySQLè¿ç»´çš„ç”Ÿå‘½çº¿ï¼Œå…³ç³»æ•°æ®å®‰å…¨
- ç›‘æ§è¦å…¨é¢ä½†é‡ç‚¹çªå‡ºï¼Œå‘Šè­¦è¦åŠæ—¶ä½†ä¸èƒ½è¿‡åº¦
- è‡ªåŠ¨åŒ–ç›‘æ§é…åˆäººå·¥åˆ†æï¼Œæ•ˆæœæœ€ä½³
- ç›‘æ§ä¸æ˜¯ç›®çš„ï¼Œé¢„é˜²æ•…éšœå’Œä¼˜åŒ–æ€§èƒ½æ‰æ˜¯ç›®æ ‡