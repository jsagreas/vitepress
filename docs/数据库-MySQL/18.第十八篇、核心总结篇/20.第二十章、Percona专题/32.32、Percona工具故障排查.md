---
title: 32ã€Perconaå·¥å…·æ•…éšœæ’æŸ¥
---
## ğŸ“š ç›®å½•


1. [å¸¸è§æ•…éšœåˆ†ç±»](#1-å¸¸è§æ•…éšœåˆ†ç±»)
2. [é”™è¯¯ä¿¡æ¯è§£è¯»](#2-é”™è¯¯ä¿¡æ¯è§£è¯»)
3. [æ—¥å¿—åˆ†ææ–¹æ³•](#3-æ—¥å¿—åˆ†ææ–¹æ³•)
4. [è°ƒè¯•æ¨¡å¼ä½¿ç”¨](#4-è°ƒè¯•æ¨¡å¼ä½¿ç”¨)
5. [æ•…éšœé‡ç°æ–¹æ³•](#5-æ•…éšœé‡ç°æ–¹æ³•)
6. [é—®é¢˜å®šä½æŠ€å·§](#6-é—®é¢˜å®šä½æŠ€å·§)
7. [è§£å†³æ–¹æ¡ˆæ€»ç»“](#7-è§£å†³æ–¹æ¡ˆæ€»ç»“)
8. [é¢„é˜²æªæ–½å»ºè®®](#8-é¢„é˜²æªæ–½å»ºè®®)
9. [æ•…éšœå¤„ç†æµç¨‹](#9-æ•…éšœå¤„ç†æµç¨‹)
10. [ç»éªŒçŸ¥è¯†ç§¯ç´¯](#10-ç»éªŒçŸ¥è¯†ç§¯ç´¯)

---

## 1. ğŸ“Š å¸¸è§æ•…éšœåˆ†ç±»



### 1.1 æ•…éšœç±»å‹å…¨è§ˆ



**æ ¹æ®å½±å“èŒƒå›´åˆ†ç±»**ï¼š

```
æŒ‰å½±å“èŒƒå›´åˆ†ç±»:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿æ¥é—®é¢˜       â”‚   æ€§èƒ½é—®é¢˜       â”‚   æ•°æ®é—®é¢˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ— æ³•è¿æ¥æ•°æ®åº“ â”‚ â€¢ å·¥å…·æ‰§è¡Œç¼“æ…¢   â”‚ â€¢ æ•°æ®ä¸ä¸€è‡´     â”‚
â”‚ â€¢ æƒé™è®¤è¯å¤±è´¥   â”‚ â€¢ å†…å­˜å ç”¨è¿‡é«˜   â”‚ â€¢ å¤‡ä»½æ–‡ä»¶æŸå   â”‚
â”‚ â€¢ ç½‘ç»œè¶…æ—¶æ–­å¼€   â”‚ â€¢ CPUä½¿ç”¨ç‡å¼‚å¸¸  â”‚ â€¢ æ¢å¤æ•°æ®é”™è¯¯   â”‚
â”‚ â€¢ SSLè¯ä¹¦é—®é¢˜    â”‚ â€¢ ç£ç›˜IOç“¶é¢ˆ    â”‚ â€¢ åŒæ­¥å»¶è¿Ÿè¿‡å¤§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŒ‰å·¥å…·åˆ†ç±»çš„å¸¸è§é—®é¢˜



**ğŸ”¸ pt-table-checksum å¸¸è§é—®é¢˜**

| é—®é¢˜ç±»å‹ | **å…¸å‹è¡¨ç°** | **å½±å“ç¨‹åº¦** | **å¸¸è§åŸå› ** |
|---------|-------------|-------------|-------------|
| **æ ¡éªŒå¤±è´¥** | `DIFFSåˆ—æ˜¾ç¤ºé0å€¼` | `ğŸ”´ ä¸¥é‡` | `ä¸»ä»æ•°æ®ä¸ä¸€è‡´` |
| **æ‰§è¡Œè¶…æ—¶** | `å·¥å…·è¿è¡Œä¸­æ–­é€€å‡º` | `ğŸŸ¡ ä¸­ç­‰` | `è¡¨è¿‡å¤§æˆ–ç½‘ç»œé—®é¢˜` |
| **æƒé™é”™è¯¯** | `Access deniedé”™è¯¯` | `ğŸ”´ ä¸¥é‡` | `ç¼ºå°‘å¿…è¦æƒé™` |
| **å¤åˆ¶å»¶è¿Ÿ** | `ä»åº“å»¶è¿ŸæŒç»­å¢å¤§` | `ğŸŸ¡ ä¸­ç­‰` | `ä¸»ä»æ€§èƒ½å·®å¼‚` |

**ğŸ”¸ pt-online-schema-change å¸¸è§é—®é¢˜**

```
é—®é¢˜åœºæ™¯åˆ†æ:

åœºæ™¯1: DDLæ“ä½œå¡æ­»
è¡¨ç°: é•¿æ—¶é—´æ— å“åº”ï¼Œä¸šåŠ¡å†™å…¥é˜»å¡
åŸå› : è·å–ä¸åˆ°å…ƒæ•°æ®é”æˆ–å­˜åœ¨é•¿äº‹åŠ¡

åœºæ™¯2: æ•°æ®ä¸ä¸€è‡´  
è¡¨ç°: æ–°è¡¨æ•°æ®é‡ä¸åŸè¡¨ä¸ç¬¦
åŸå› : é«˜å¹¶å‘å†™å…¥æ—¶è§¦å‘å™¨åŒæ­¥å¤±è´¥

åœºæ™¯3: ç£ç›˜ç©ºé—´ä¸è¶³
è¡¨ç°: æ“ä½œä¸­æ–­ï¼ŒæŠ¥å‘Šç©ºé—´é”™è¯¯
åŸå› : æœªé¢„ä¼°ä¸´æ—¶è¡¨ç©ºé—´éœ€æ±‚
```

**ğŸ”¸ pt-archiver å¸¸è§é—®é¢˜**

```
å½’æ¡£é—®é¢˜ç±»å‹:
1. å½’æ¡£é€Ÿåº¦è¿‡æ…¢
   - æ‰¹é‡å¤§å°è®¾ç½®ä¸å½“
   - ç›®æ ‡å­˜å‚¨æ€§èƒ½ç“¶é¢ˆ
   - ç½‘ç»œå¸¦å®½é™åˆ¶

2. æ•°æ®ä¸¢å¤±é£é™©
   - åˆ é™¤æ“ä½œè¿‡äºæ¿€è¿›
   - å½’æ¡£è¿‡ç¨‹ä¸­æ–­æœªæ¢å¤
   - äº‹åŠ¡è¾¹ç•Œå¤„ç†é”™è¯¯

3. ä¸šåŠ¡å½±å“è¿‡å¤§
   - é”ç«äº‰å¯¼è‡´æŸ¥è¯¢é˜»å¡
   - IOå‹åŠ›å½±å“æ­£å¸¸ä¸šåŠ¡
   - ä¸»ä»å»¶è¿Ÿæ€¥å‰§å¢åŠ 
```

### 1.3 æ•…éšœä¸¥é‡ç¨‹åº¦åˆ†çº§



**ğŸš¨ ä¸¥é‡ç¨‹åº¦åˆ†ç±»**ï¼š

```
P0çº§åˆ« - ä¸šåŠ¡ä¸­æ–­:
â€¢ æ•°æ®åº“è¿æ¥å®Œå…¨å¤±è´¥
â€¢ æ•°æ®ä¸¥é‡æŸåæˆ–ä¸¢å¤±
â€¢ ä¸»ä»å¤åˆ¶å½»åº•æ–­å¼€
â€¢ å…³é”®ä¸šåŠ¡è¡¨æ— æ³•è®¿é—®

P1çº§åˆ« - ä¸šåŠ¡ä¸¥é‡å½±å“:
â€¢ æ€§èƒ½ä¸¥é‡ä¸‹é™(å“åº”æ—¶é—´>5ç§’)
â€¢ éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨
â€¢ æ•°æ®ä¸ä¸€è‡´ä½†å¯è®¿é—®
â€¢ ä¸»ä»å»¶è¿Ÿ>30ç§’

P2çº§åˆ« - ä¸šåŠ¡è½»å¾®å½±å“:
â€¢ æ€§èƒ½è½»å¾®ä¸‹é™(å“åº”æ—¶é—´>2ç§’)
â€¢ å·¥å…·æ‰§è¡Œæ—¶é—´å»¶é•¿
â€¢ èµ„æºä½¿ç”¨ç‡åé«˜
â€¢ ä¸»ä»å»¶è¿Ÿ5-30ç§’

P3çº§åˆ« - æ— ä¸šåŠ¡å½±å“:
â€¢ å·¥å…·è¿è¡Œå‘Šè­¦ä½†æ­£å¸¸
â€¢ æ—¥å¿—ä¸­æœ‰warningä¿¡æ¯
â€¢ èµ„æºä½¿ç”¨åœ¨æ­£å¸¸èŒƒå›´å†…
â€¢ æ€§èƒ½æŒ‡æ ‡ç•¥æœ‰æ³¢åŠ¨
```

---

## 2. ğŸ” é”™è¯¯ä¿¡æ¯è§£è¯»



### 2.1 æƒé™ç›¸å…³é”™è¯¯



**ğŸ”¸ å¸¸è§æƒé™é”™è¯¯ç±»å‹**

```sql
-- é”™è¯¯1: åŸºæœ¬è¿æ¥æƒé™ä¸è¶³
ERROR 1045 (28000): Access denied for user 'pt_user'@'localhost'

è§£è¯»: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œæˆ–è€…ç”¨æˆ·ä¸å­˜åœ¨
è§£å†³: æ£€æŸ¥ç”¨æˆ·å‡­æ®ï¼Œç¡®è®¤ç”¨æˆ·æ˜¯å¦å·²åˆ›å»º

-- é”™è¯¯2: è¡¨çº§æƒé™ä¸è¶³  
ERROR 1142 (42000): SELECT command denied to user 'pt_user'@'localhost' for table 'users'

è§£è¯»: ç¼ºå°‘è¡¨çš„SELECTæƒé™
è§£å†³: GRANT SELECT ON database.table TO 'pt_user'@'localhost';

-- é”™è¯¯3: å¤åˆ¶æƒé™ä¸è¶³
ERROR 1227 (42000): Access denied; you need (at least one of) the REPLICATION SLAVE privilege(s)

è§£è¯»: ç¼ºå°‘å¤åˆ¶ç›¸å…³æƒé™
è§£å†³: GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'pt_user'@'localhost';
```

### 2.2 è¿æ¥ç›¸å…³é”™è¯¯



**ğŸ“¡ ç½‘ç»œè¿æ¥é—®é¢˜è§£è¯»**

```bash
# é”™è¯¯1: è¿æ¥è¶…æ—¶

ERROR 2003 (HY000): Can't connect to MySQL server on 'host' (110)

åˆ†ææ­¥éª¤:
1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§: ping host
2. æ£€æŸ¥ç«¯å£å¼€æ”¾: telnet host 3306  
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. æ£€æŸ¥MySQLæœåŠ¡çŠ¶æ€

# é”™è¯¯2: è¿æ¥æ•°é™åˆ¶

ERROR 1040 (HY000): Too many connections

åˆ†æåŸå› :
- å½“å‰è¿æ¥æ•°å·²è¾¾åˆ°max_connectionsé™åˆ¶
- å¯èƒ½å­˜åœ¨è¿æ¥æ³„æ¼
- ä¸šåŠ¡å¹¶å‘é‡è¶…å‡ºé¢„æœŸ

è§£å†³æ–¹æ¡ˆ:
- ä¸´æ—¶: SET GLOBAL max_connections = æ›´å¤§å€¼;
- é•¿æœŸ: ä¼˜åŒ–åº”ç”¨è¿æ¥æ± ï¼Œæ’æŸ¥è¿æ¥æ³„æ¼
```

### 2.3 æ•°æ®ç›¸å…³é”™è¯¯



**ğŸ’¾ æ•°æ®å®Œæ•´æ€§é”™è¯¯**

```
é”™è¯¯ç±»å‹1: ä¸»é”®å†²çª
ERROR 1062 (23000): Duplicate entry '123' for key 'PRIMARY'

äº§ç”Ÿåœºæ™¯:
- pt-table-syncåŒæ­¥æ•°æ®æ—¶
- pt-archiverå½’æ¡£è¿‡ç¨‹ä¸­
- pt-online-schema-changeæ•°æ®è¿ç§»æ—¶

è§£å†³æ€è·¯:
1. æ£€æŸ¥æ•°æ®æºçš„å”¯ä¸€æ€§
2. ç¡®è®¤åŒæ­¥ç­–ç•¥æ˜¯å¦æ­£ç¡®
3. æ’æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦æœ‰å¹¶å‘æ’å…¥

é”™è¯¯ç±»å‹2: å¤–é”®çº¦æŸå†²çª  
ERROR 1452 (23000): Cannot add or update a child row: a foreign key constraint fails

å¸¸è§åœºæ™¯:
- æ•°æ®å½’æ¡£æ—¶è¿åå¼•ç”¨å®Œæ•´æ€§
- åœ¨çº¿DDLè¿‡ç¨‹ä¸­å¤–é”®å¤„ç†ä¸å½“
- ä¸»ä»æ•°æ®åŒæ­¥æ—¶å¤–é”®ä¸ä¸€è‡´

å¤„ç†æ–¹æ³•:
1. æš‚æ—¶ç¦ç”¨å¤–é”®æ£€æŸ¥: SET foreign_key_checks = 0;
2. è°ƒæ•´æ“ä½œé¡ºåºï¼Œå…ˆå¤„ç†ä¸»è¡¨
3. ä½¿ç”¨--no-foreign-key-checkså‚æ•°
```

### 2.4 å·¥å…·ç‰¹å®šé”™è¯¯



**ğŸ”§ pt-table-checksum é”™è¯¯è§£è¯»**

```
é”™è¯¯ä¿¡æ¯: Replica lag is 25 seconds on host1. Waiting.
å«ä¹‰è§£é‡Š: ä»åº“å»¶è¿Ÿè¿‡å¤§ï¼Œå·¥å…·è‡ªåŠ¨ç­‰å¾…
å½±å“ç¨‹åº¦: è½»å¾®ï¼Œä¼šè‡ªåŠ¨æ¢å¤
å¤„ç†å»ºè®®: æ£€æŸ¥ä»åº“æ€§èƒ½ï¼Œé€‚å½“è°ƒæ•´--max-lagå‚æ•°

é”™è¯¯ä¿¡æ¯: Cannot checksum table db.table: no PRIMARY KEY or unique index
å«ä¹‰è§£é‡Š: è¡¨ç¼ºå°‘ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼Œæ— æ³•è¿›è¡Œæ ¡éªŒ
å½±å“ç¨‹åº¦: ä¸¥é‡ï¼Œæ— æ³•æ ¡éªŒè¯¥è¡¨
å¤„ç†å»ºè®®: ä¸ºè¡¨æ·»åŠ ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•åé‡è¯•

é”™è¯¯ä¿¡æ¯: Checksum query killed or crashed
å«ä¹‰è§£é‡Š: æ ¡éªŒæŸ¥è¯¢è¢«ç»ˆæ­¢æˆ–å´©æºƒ
å½±å“ç¨‹åº¦: ä¸­ç­‰ï¼Œå½±å“æ ¡éªŒè¿›åº¦
å¤„ç†å»ºè®®: æ£€æŸ¥æŸ¥è¯¢è¶…æ—¶è®¾ç½®ï¼Œæ’æŸ¥ç³»ç»Ÿèµ„æºé—®é¢˜
```

---

## 3. ğŸ“‹ æ—¥å¿—åˆ†ææ–¹æ³•



### 3.1 æ—¥å¿—æ–‡ä»¶ä½ç½®ä¸ç±»å‹



**ğŸ“ æ—¥å¿—æ–‡ä»¶åˆ†å¸ƒ**

```
ç³»ç»Ÿæ—¥å¿—ä½ç½®:
/var/log/mysql/           â† MySQLæœåŠ¡æ—¥å¿—
  â”œâ”€â”€ error.log          â† é”™è¯¯æ—¥å¿—(æœ€é‡è¦)
  â”œâ”€â”€ slow.log           â† æ…¢æŸ¥è¯¢æ—¥å¿—  
  â”œâ”€â”€ general.log        â† é€šç”¨æŸ¥è¯¢æ—¥å¿—
  â””â”€â”€ binlog.000001      â† äºŒè¿›åˆ¶æ—¥å¿—

Perconaå·¥å…·æ—¥å¿—:
/tmp/pt-*.log            â† å·¥å…·ä¸´æ—¶æ—¥å¿—
~/.percona-toolkit.log   â† ç”¨æˆ·é…ç½®æ—¥å¿—
è‡ªå®šä¹‰ä½ç½®               â† é€šè¿‡--logå‚æ•°æŒ‡å®š
```

### 3.2 é”™è¯¯æ—¥å¿—åˆ†ææŠ€å·§



**ğŸ” MySQLé”™è¯¯æ—¥å¿—åˆ†æ**

```bash
# 1. æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯ä¿¡æ¯

tail -f /var/log/mysql/error.log

# 2. è¿‡æ»¤ç‰¹å®šæ—¶é—´æ®µçš„é”™è¯¯

grep "2024-01-15 14:3[0-9]" /var/log/mysql/error.log

# 3. ç»Ÿè®¡é”™è¯¯ç±»å‹åˆ†å¸ƒ

grep "ERROR" /var/log/mysql/error.log | \
awk '{print $6}' | sort | uniq -c | sort -nr

# 4. æŸ¥æ‰¾Perconaå·¥å…·ç›¸å…³é”™è¯¯

grep -i "percona\|pt-" /var/log/mysql/error.log
```

**å…³é”®é”™è¯¯æ¨¡å¼è¯†åˆ«**ï¼š

```
æ¨¡å¼1: è¿æ¥é—®é¢˜
[ERROR] Aborted connection 123 to db: 'test' user: 'pt_user'
åˆ†æ: è¿æ¥å¼‚å¸¸ä¸­æ–­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–å·¥å…·å¼‚å¸¸é€€å‡º

æ¨¡å¼2: æƒé™é—®é¢˜  
[ERROR] Access denied for user 'pt_user'@'%' (using password: YES)
åˆ†æ: æƒé™é…ç½®é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ç”¨æˆ·æƒé™è®¾ç½®

æ¨¡å¼3: èµ„æºä¸è¶³
[ERROR] Out of memory; restart server and try again
åˆ†æ: å†…å­˜ä¸è¶³ï¼Œå¯èƒ½æ˜¯å·¥å…·æ¶ˆè€—èµ„æºè¿‡å¤š
```

### 3.3 æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ



**â° æ…¢æŸ¥è¯¢åˆ†ææµç¨‹**

```bash
# 1. å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—

mysql> SET GLOBAL slow_query_log = 'ON';
mysql> SET GLOBAL long_query_time = 2.0;

# 2. ä½¿ç”¨pt-query-digeståˆ†æ

pt-query-digest /var/log/mysql/slow.log > slow_analysis.txt

# 3. é‡ç‚¹å…³æ³¨Perconaå·¥å…·äº§ç”Ÿçš„æ…¢æŸ¥è¯¢

pt-query-digest /var/log/mysql/slow.log --filter '
  $event->{user} =~ /pt_user/ or 
  $event->{arg} =~ /pt-table-checksum|pt-online-schema-change/'
```

**æ…¢æŸ¥è¯¢åˆ†æè¦ç‚¹**ï¼š

```
åˆ†æç»´åº¦:
1. æ‰§è¡Œæ—¶é—´ (Query_time)
   - >10ç§’: éœ€è¦ç«‹å³ä¼˜åŒ–
   - 5-10ç§’: é‡ç‚¹å…³æ³¨
   - 2-5ç§’: é€‚å½“ä¼˜åŒ–

2. é”ç­‰å¾…æ—¶é—´ (Lock_time)  
   - >1ç§’: å¯èƒ½å­˜åœ¨é”ç«äº‰
   - æ£€æŸ¥æ˜¯å¦ä¸ä¸šåŠ¡é«˜å³°é‡å 

3. æ‰«æè¡Œæ•° (Rows_examined)
   - ä¸è¿”å›è¡Œæ•°æ¯”è¾ƒ
   - æ¯”å€¼è¿‡å¤§è¯´æ˜ç´¢å¼•ä¸å¤Ÿä¼˜åŒ–

4. æŸ¥è¯¢æ¨¡å¼
   - æ˜¯å¦ä¸ºå·¥å…·ç”Ÿæˆçš„æŸ¥è¯¢
   - æ˜¯å¦å¯ä»¥é€šè¿‡å‚æ•°è°ƒä¼˜
```

### 3.4 å·¥å…·æ—¥å¿—æ·±åº¦åˆ†æ



**ğŸ“Š pt-online-schema-change æ—¥å¿—åˆ†æ**

```bash
# å…¸å‹æ—¥å¿—ç‰‡æ®µåˆ†æ

2024-01-15T14:30:15 Creating new table...
2024-01-15T14:30:16 Created new table db._users_new OK.
2024-01-15T14:30:17 Waiting for new table to replicate to all slaves...
2024-01-15T14:30:20 Started copying approximately 1000000 rows...
2024-01-15T14:45:30 Copied 500000/1000000 50% 01:15 remain
2024-01-15T15:00:45 Copied 1000000/1000000 100% 00:00 remain  
2024-01-15T15:00:46 Analyzing new table...
2024-01-15T15:00:50 Swapping tables...
2024-01-15T15:00:51 Successfully altered `db`.`users`.

å…³é”®æ—¶é—´èŠ‚ç‚¹åˆ†æ:
- åˆ›å»ºæ–°è¡¨: å³æ—¶å®Œæˆ
- ç­‰å¾…å¤åˆ¶: 10ç§’(æ­£å¸¸)
- æ•°æ®å¤åˆ¶: 30åˆ†é’Ÿ(åˆç†)
- è¡¨åˆ‡æ¢: 1ç§’(ç†æƒ³)
```

**æ—¥å¿—å¼‚å¸¸æ¨¡å¼è¯†åˆ«**ï¼š

```
å¼‚å¸¸æ¨¡å¼1: å¤åˆ¶åœæ»
Copied 234567/1000000 23% 02:30 remain
Copied 234567/1000000 23% 02:30 remain  â† è¿›åº¦é•¿æ—¶é—´æ— å˜åŒ–
åˆ†æ: å¯èƒ½é‡åˆ°å¤§äº‹åŠ¡æˆ–é”ç­‰å¾…

å¼‚å¸¸æ¨¡å¼2: å†…å­˜å‘Šè­¦
InnoDB: Out of memory; restart server and try again
åˆ†æ: å†…å­˜ä¸è¶³ï¼Œéœ€è¦è°ƒæ•´æ‰¹é‡å¤§å°æˆ–å¢åŠ å†…å­˜

å¼‚å¸¸æ¨¡å¼3: ä¸»ä»å»¶è¿Ÿè¿‡å¤§  
Replica lag is 120 seconds on slave1. Waiting.
åˆ†æ: ä»åº“æ€§èƒ½ä¸è¶³æˆ–ç½‘ç»œé—®é¢˜
```

---

## 4. ğŸ”§ è°ƒè¯•æ¨¡å¼ä½¿ç”¨



### 4.1 è°ƒè¯•å‚æ•°è¯¦è§£



**ğŸ¯ é€šç”¨è°ƒè¯•å‚æ•°**

```bash
# 1. å¢åŠ è¯¦ç»†è¾“å‡º

--verbose               # æ˜¾ç¤ºè¯¦ç»†æ‰§è¡Œä¿¡æ¯
--debug                 # å¯ç”¨è°ƒè¯•æ¨¡å¼  
--print                 # æ‰“å°SQLè¯­å¥ä½†ä¸æ‰§è¡Œ
--dry-run              # æ¨¡æ‹Ÿæ‰§è¡Œï¼Œä¸å®é™…æ“ä½œ

# 2. æ—¥å¿—æ§åˆ¶å‚æ•°

--log                  # æŒ‡å®šæ—¥å¿—æ–‡ä»¶è·¯å¾„
--progress             # æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
--statistics           # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯

# ç¤ºä¾‹: pt-table-checksumè°ƒè¯•æ¨¡å¼

pt-table-checksum \
  --dry-run \           # æ¨¡æ‹Ÿæ‰§è¡Œ
  --print \             # æ‰“å°SQL
  --verbose \           # è¯¦ç»†è¾“å‡º
  --databases=test \    # æŒ‡å®šæ•°æ®åº“
  h=localhost,u=root,p=password
```

### 4.2 åˆ†æ­¥è°ƒè¯•ç­–ç•¥



**ğŸ“ pt-online-schema-change åˆ†æ­¥è°ƒè¯•**

```bash
# æ­¥éª¤1: æ£€æŸ¥è¡¨ç»“æ„å’Œæƒé™

pt-online-schema-change \
  --alter="ADD COLUMN email VARCHAR(100)" \
  --dry-run \           # åªæ£€æŸ¥ï¼Œä¸æ‰§è¡Œ
  --print \             # æ‰“å°æ‰€æœ‰SQL
  D=test,t=users

# æ­¥éª¤2: æµ‹è¯•è§¦å‘å™¨åˆ›å»º

pt-online-schema-change \
  --alter="ADD COLUMN email VARCHAR(100)" \
  --execute \
  --no-swap-tables \    # ä¸æ‰§è¡Œæœ€åçš„è¡¨åˆ‡æ¢
  --no-drop-new-table \ # ä¿ç•™æ–°è¡¨ç”¨äºæ£€æŸ¥
  D=test,t=users

# æ­¥éª¤3: éªŒè¯æ•°æ®ä¸€è‡´æ€§

pt-table-checksum \
  --databases=test \
  --tables=users,_users_new \
  h=localhost,u=root,p=password

# æ­¥éª¤4: æ‰‹åŠ¨å®Œæˆåˆ‡æ¢(å¦‚æœä¸€åˆ‡æ­£å¸¸)

RENAME TABLE users TO users_old, _users_new TO users;
```

### 4.3 è°ƒè¯•ä¿¡æ¯è§£è¯»



**ğŸ“Š è°ƒè¯•è¾“å‡ºåˆ†æ**

```
# pt-table-checksum è°ƒè¯•è¾“å‡ºç¤ºä¾‹

# TSè¡¨ç¤ºtimestampï¼ŒHOSTè¡¨ç¤ºä¸»æœºï¼ŒROWSè¡¨ç¤ºè¡Œæ•°


TS                 ERRORS  DIFFS  ROWS  CHUNKS  SKIPPED    TIME TABLE
01-15T14:30:15          0      0  1000       1        0   0.123 test.users
01-15T14:30:16          0      0  5000       1        0   0.456 test.orders

å…³é”®å­—æ®µè§£é‡Š:
- ERRORS: æ£€æŸ¥è¿‡ç¨‹ä¸­çš„é”™è¯¯æ•°é‡
- DIFFS: å‘ç°çš„æ•°æ®å·®å¼‚æ•°é‡  
- ROWS: æ£€æŸ¥çš„æ€»è¡Œæ•°
- CHUNKS: åˆ†å—å¤„ç†çš„å—æ•°
- SKIPPED: è·³è¿‡çš„å—æ•°(é€šå¸¸å› ä¸ºå»¶è¿Ÿè¿‡å¤§)
- TIME: æ£€æŸ¥è€—æ—¶(ç§’)

# pt-online-schema-change è°ƒè¯•è¾“å‡º

Creating triggers...
CREATE TRIGGER `pt_osc_test_users_del` ...
CREATE TRIGGER `pt_osc_test_users_upd` ...
CREATE TRIGGER `pt_osc_test_users_ins` ...

å…³é”®ä¿¡æ¯:
- æ˜¾ç¤ºåˆ›å»ºçš„è§¦å‘å™¨åç§°
- å¯ä»¥éªŒè¯è§¦å‘å™¨é€»è¾‘æ˜¯å¦æ­£ç¡®
- ä¾¿äºå‡ºé—®é¢˜æ—¶æ‰‹åŠ¨æ¸…ç†
```

### 4.4 æ€§èƒ½è°ƒè¯•æŠ€å·§



**âš¡ æ€§èƒ½ç“¶é¢ˆå®šä½**

```bash
# 1. ä½¿ç”¨ç³»ç»Ÿç›‘æ§å‘½ä»¤

# åœ¨å·¥å…·è¿è¡ŒæœŸé—´ç›‘æ§ç³»ç»Ÿèµ„æº

watch -n 1 'iostat -x 1 1; free -h; mysqladmin processlist'

# 2. MySQLæ€§èƒ½ç›‘æ§

# ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡  

watch -n 2 'mysql -e "
SELECT 
  VARIABLE_NAME,
  VARIABLE_VALUE 
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN (
  \"Threads_running\",
  \"Innodb_buffer_pool_reads\", 
  \"Innodb_buffer_pool_read_requests\",
  \"Handler_read_rnd_next\"
);"'

# 3. å·¥å…·ç‰¹å®šæ€§èƒ½åˆ†æ

pt-stalk \
  --function=processlist \  # ç›‘æ§è¿›ç¨‹åˆ—è¡¨
  --variable=Threads_running \
  --threshold=20 \          # é˜ˆå€¼è§¦å‘
  --cycles=5 \              # ç›‘æ§å‘¨æœŸ
  --interval=1              # æ£€æŸ¥é—´éš”
```

---

## 5. ğŸ”„ æ•…éšœé‡ç°æ–¹æ³•



### 5.1 é‡ç°ç¯å¢ƒå‡†å¤‡



**ğŸ—ï¸ æµ‹è¯•ç¯å¢ƒæ­å»º**

```bash
# 1. åˆ›å»ºéš”ç¦»çš„æµ‹è¯•ç¯å¢ƒ

docker run -d --name mysql-test \
  -e MYSQL_ROOT_PASSWORD=testpass \
  -p 3307:3306 \
  mysql:8.0

# 2. å¤åˆ¶ç”Ÿäº§æ•°æ®ç»“æ„

mysqldump -h prod_host -u user -p \
  --no-data \              # åªå¯¼å‡ºç»“æ„
  --routines \             # åŒ…å«å­˜å‚¨è¿‡ç¨‹
  --triggers \             # åŒ…å«è§¦å‘å™¨
  production_db > schema.sql

# 3. å¯¼å…¥æµ‹è¯•ç¯å¢ƒ

mysql -h localhost -P 3307 -u root -p < schema.sql

# 4. ç”Ÿæˆæµ‹è¯•æ•°æ®

# ä½¿ç”¨pt-table-syncæˆ–è‡ªå®šä¹‰è„šæœ¬ç”Ÿæˆæµ‹è¯•æ•°æ®

```

### 5.2 æ•…éšœåœºæ™¯æ¨¡æ‹Ÿ



**ğŸ­ å¸¸è§æ•…éšœæ¨¡æ‹Ÿæ–¹æ³•**

```bash
# åœºæ™¯1: æ¨¡æ‹Ÿé«˜å¹¶å‘å†™å…¥ç¯å¢ƒ

# åˆ›å»ºå¹¶å‘å†™å…¥è„šæœ¬

cat > concurrent_writes.sh << 'EOF'
#!/bin/bash

for i in {1..100}; do
  {
    mysql -h localhost -P 3307 -u root -ptest -e "
    INSERT INTO test_table (name, value) 
    VALUES ('user_$RANDOM', $RANDOM);
    " &
  }
done
wait
EOF

# åœºæ™¯2: æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ

# ä½¿ç”¨tcå‘½ä»¤æ¨¡æ‹Ÿç½‘ç»œé—®é¢˜

tc qdisc add dev eth0 root netem delay 100ms 20ms

# åœºæ™¯3: æ¨¡æ‹Ÿç£ç›˜IOå‹åŠ›

# ä½¿ç”¨fioå·¥å…·åˆ¶é€ IOè´Ÿè½½

fio --name=iotest --rw=randwrite --size=1G --bs=4k \
    --numjobs=4 --runtime=300 --group_reporting

# åœºæ™¯4: æ¨¡æ‹Ÿå†…å­˜ä¸è¶³

# åˆ›å»ºå†…å­˜æ¶ˆè€—è¿›ç¨‹

stress --vm 2 --vm-bytes 2G --timeout 600s
```

### 5.3 å‚æ•°è°ƒæ•´é‡ç°



**âš™ï¸ é€šè¿‡å‚æ•°è°ƒæ•´é‡ç°é—®é¢˜**

```bash
# é‡ç°pt-online-schema-changeå¡æ­»é—®é¢˜

pt-online-schema-change \
  --alter="ADD COLUMN test_col INT" \
  --chunk-size=100 \        # å‡å°æ‰¹é‡å¤§å°
  --max-lag=1 \             # é™ä½å»¶è¿Ÿé˜ˆå€¼
  --critical-load="Threads_running:10" \  # é™ä½è´Ÿè½½é˜ˆå€¼
  --execute \
  D=test,t=large_table

# é‡ç°pt-table-checksumè¶…æ—¶é—®é¢˜  

pt-table-checksum \
  --chunk-size=500 \        # å‡å°å—å¤§å°
  --max-lag=0.5 \           # æä½å»¶è¿Ÿé˜ˆå€¼
  --lock-wait-timeout=5 \   # çŸ­é”ç­‰å¾…æ—¶é—´
  --databases=test

# é‡ç°æƒé™ç›¸å…³é—®é¢˜

# åˆ›å»ºå—é™æƒé™ç”¨æˆ·

CREATE USER 'limited_user'@'localhost' IDENTIFIED BY 'password';
GRANT SELECT ON test.* TO 'limited_user'@'localhost';
# ç„¶åä½¿ç”¨è¯¥ç”¨æˆ·è¿è¡Œéœ€è¦INSERTæƒé™çš„å·¥å…·

```

### 5.4 æ•°æ®çŠ¶æ€é‡ç°



**ğŸ’¾ ç‰¹å®šæ•°æ®çŠ¶æ€æ„é€ **

```sql
-- æ„é€ ä¸»ä»ä¸ä¸€è‡´åœºæ™¯
-- åœ¨ä¸»åº“æ‰§è¡Œ
INSERT INTO test_table VALUES (1, 'master_data');

-- åœ¨ä»åº“æ‰§è¡Œ(åœæ­¢å¤åˆ¶å)
STOP SLAVE;
INSERT INTO test_table VALUES (1, 'slave_data');
START SLAVE;

-- æ„é€ å¤§äº‹åŠ¡åœºæ™¯
START TRANSACTION;
UPDATE large_table SET status = 'processing' WHERE id BETWEEN 1 AND 100000;
-- ä¿æŒäº‹åŠ¡å¼€å¯çŠ¶æ€ï¼Œç„¶åè¿è¡ŒPerconaå·¥å…·

-- æ„é€ é”äº‰ç”¨åœºæ™¯
-- ä¼šè¯1: é•¿æ—¶é—´æŒæœ‰é”
LOCK TABLES test_table WRITE;
SELECT SLEEP(300);

-- ä¼šè¯2: è¿è¡ŒPerconaå·¥å…·(ä¼šé‡åˆ°é”ç­‰å¾…)
pt-table-checksum --databases=test
```

---

## 6. ğŸ¯ é—®é¢˜å®šä½æŠ€å·§



### 6.1 ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•



**ğŸ” 5W1Hé—®é¢˜åˆ†ææ³•**

```
é—®é¢˜å®šä½æ¡†æ¶:

What - ä»€ä¹ˆé—®é¢˜ï¼Ÿ
â€¢ å…·ä½“é”™è¯¯ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ å½±å“èŒƒå›´æœ‰å¤šå¤§ï¼Ÿ
â€¢ è¡¨ç°ç—‡çŠ¶æœ‰å“ªäº›ï¼Ÿ

When - ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ  
â€¢ å…·ä½“å‘ç”Ÿæ—¶é—´ï¼Ÿ
â€¢ æ˜¯å¦æœ‰æ—¶é—´è§„å¾‹ï¼Ÿ
â€¢ æŒç»­æ—¶é—´å¤šé•¿ï¼Ÿ

Where - åœ¨å“ªé‡Œå‘ç”Ÿï¼Ÿ
â€¢ å…·ä½“å“ªå°æœåŠ¡å™¨ï¼Ÿ
â€¢ å“ªä¸ªæ•°æ®åº“ã€å“ªå¼ è¡¨ï¼Ÿ
â€¢ ç½‘ç»œçš„å“ªä¸ªç¯èŠ‚ï¼Ÿ

Who - è°ç›¸å…³ï¼Ÿ
â€¢ å“ªä¸ªç”¨æˆ·è´¦å·ï¼Ÿ
â€¢ å“ªä¸ªåº”ç”¨ç¨‹åºï¼Ÿ
â€¢ å“ªä¸ªå·¥å…·ç‰ˆæœ¬ï¼Ÿ

Why - ä¸ºä»€ä¹ˆå‘ç”Ÿï¼Ÿ
â€¢ æ ¹æœ¬åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ è§¦å‘æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ
â€¢ ç¯å¢ƒå˜åŒ–äº†ä»€ä¹ˆï¼Ÿ

How - å¦‚ä½•è§£å†³ï¼Ÿ
â€¢ ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Ÿ
â€¢ é•¿æœŸè§£å†³æ–¹æ¡ˆï¼Ÿ
â€¢ é¢„é˜²æªæ–½ï¼Ÿ
```

### 6.2 æŠ€æœ¯å®šä½æ‰‹æ®µ



**ğŸ”§ å¤šå±‚æ¬¡è¯Šæ–­æ–¹æ³•**

```bash
# 1. ç³»ç»Ÿå±‚é¢æ£€æŸ¥

# æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

top -p $(pgrep pt-)           # ç›‘æ§å·¥å…·è¿›ç¨‹
iostat -x 1                  # ç›‘æ§IOçŠ¶å†µ  
free -h                      # æ£€æŸ¥å†…å­˜ä½¿ç”¨
df -h                        # æ£€æŸ¥ç£ç›˜ç©ºé—´

# 2. ç½‘ç»œå±‚é¢æ£€æŸ¥

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œå»¶è¿Ÿ

ping -c 10 mysql_host         # åŸºæœ¬è¿é€šæ€§
telnet mysql_host 3306        # ç«¯å£å¯è¾¾æ€§
mtr mysql_host                # ç½‘ç»œè·¯å¾„åˆ†æ

# 3. MySQLå±‚é¢æ£€æŸ¥

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

mysql -e "SHOW PROCESSLIST;"                    # æ´»è·ƒè¿æ¥
mysql -e "SHOW ENGINE INNODB STATUS\G"         # InnoDBçŠ¶æ€
mysql -e "SHOW SLAVE STATUS\G"                 # ä¸»ä»çŠ¶æ€
mysql -e "SHOW GLOBAL STATUS LIKE 'Thread%';"  # çº¿ç¨‹çŠ¶æ€

# 4. å·¥å…·å±‚é¢æ£€æŸ¥

# æ£€æŸ¥å·¥å…·é…ç½®å’ŒçŠ¶æ€

pt-table-checksum --version    # ç‰ˆæœ¬ä¿¡æ¯
which pt-table-checksum        # ç¨‹åºä½ç½®
ldd $(which pt-table-checksum) # ä¾èµ–åº“æ£€æŸ¥
```

### 6.3 æ—¥å¿—ç›¸å…³æ€§åˆ†æ



**ğŸ“Š æ—¶é—´çº¿å…³è”åˆ†æ**

```bash
# æ„å»ºæ—¶é—´çº¿ï¼Œå…³è”å¤šä¸ªæ—¥å¿—æº

# 1. MySQLé”™è¯¯æ—¥å¿—

grep "2024-01-15 14:3[0-9]" /var/log/mysql/error.log > timeline.txt

# 2. ç³»ç»Ÿæ—¥å¿—  

grep "2024-01-15 14:3[0-9]" /var/log/syslog >> timeline.txt

# 3. åº”ç”¨æ—¥å¿—

grep "2024-01-15 14:3[0-9]" /var/log/application.log >> timeline.txt

# 4. å·¥å…·æ—¥å¿—

grep "2024-01-15 14:3[0-9]" /tmp/pt-*.log >> timeline.txt

# 5. æŒ‰æ—¶é—´æ’åºåˆ†æ

sort timeline.txt | less

# å…³é”®æ—¶é—´ç‚¹è¯†åˆ«

å…³æ³¨æ—¶é—´ç‚¹ï¼š
- 14:30:00: å·¥å…·å¼€å§‹æ‰§è¡Œ
- 14:31:30: é¦–æ¬¡å‡ºç°å‘Šè­¦
- 14:32:45: é”™è¯¯å¼€å§‹é¢‘ç¹å‡ºç°  
- 14:35:00: å·¥å…·å¼‚å¸¸é€€å‡º
- 14:35:30: ç³»ç»Ÿæ¢å¤æ­£å¸¸

åˆ†æé‡ç‚¹ï¼š
- å‘Šè­¦å‡ºç°å‰1-2åˆ†é’Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
- é”™è¯¯é«˜å³°æœŸçš„ç³»ç»ŸçŠ¶æ€å¦‚ä½•ï¼Ÿ
- æ¢å¤è¿‡ç¨‹ä¸­åšäº†å“ªäº›æ“ä½œï¼Ÿ
```

### 6.4 æ€§èƒ½åŸºçº¿å¯¹æ¯”



**ğŸ“ˆ æ€§èƒ½å¼‚å¸¸æ£€æµ‹**

```sql
-- å»ºç«‹æ€§èƒ½åŸºçº¿
CREATE TABLE performance_baseline (
  metric_name VARCHAR(100),
  baseline_value DECIMAL(20,2),
  measurement_time TIMESTAMP,
  INDEX(metric_name, measurement_time)
);

-- æ”¶é›†å…³é”®æŒ‡æ ‡åŸºçº¿æ•°æ®
INSERT INTO performance_baseline 
SELECT 
  'queries_per_second',
  VARIABLE_VALUE,
  NOW()
FROM performance_schema.global_status 
WHERE VARIABLE_NAME = 'Queries';

-- å®æ—¶å¯¹æ¯”æ£€æµ‹å¼‚å¸¸
SELECT 
  s.VARIABLE_NAME,
  s.VARIABLE_VALUE as current_value,
  b.baseline_value,
  (s.VARIABLE_VALUE - b.baseline_value) / b.baseline_value * 100 as change_percent
FROM performance_schema.global_status s
JOIN performance_baseline b ON s.VARIABLE_NAME = b.metric_name
WHERE ABS((s.VARIABLE_VALUE - b.baseline_value) / b.baseline_value) > 0.2;  -- 20%å˜åŒ–é˜ˆå€¼
```

---

## 7. ğŸ’¡ è§£å†³æ–¹æ¡ˆæ€»ç»“



### 7.1 æƒé™é—®é¢˜è§£å†³æ–¹æ¡ˆ



**ğŸ” æƒé™é…ç½®æ ‡å‡†æ¨¡æ¿**

```sql
-- 1. pt-table-checksum æœ€å°æƒé™
CREATE USER 'pt_checksum'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER ON *.* TO 'pt_checksum'@'%';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'pt_checksum'@'%';
GRANT PROCESS ON *.* TO 'pt_checksum'@'%';

-- 2. pt-online-schema-change æƒé™
CREATE USER 'pt_osc'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, TRIGGER ON *.* TO 'pt_osc'@'%';
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'pt_osc'@'%';
GRANT LOCK TABLES ON *.* TO 'pt_osc'@'%';

-- 3. pt-archiver æƒé™
CREATE USER 'pt_archiver'@'%' IDENTIFIED BY 'strong_password';  
GRANT SELECT, INSERT, DELETE ON source_db.* TO 'pt_archiver'@'%';
GRANT INSERT ON archive_db.* TO 'pt_archiver'@'%';
GRANT FILE ON *.* TO 'pt_archiver'@'%';  -- å¦‚éœ€å¯¼å‡ºåˆ°æ–‡ä»¶

-- æƒé™éªŒè¯è„šæœ¬
pt-mysql-summary --user=pt_checksum --password=strong_password --host=localhost
```

### 7.2 æ€§èƒ½é—®é¢˜è§£å†³æ–¹æ¡ˆ



**âš¡ æ€§èƒ½ä¼˜åŒ–å‚æ•°æ¨¡æ¿**

```bash
# 1. é«˜æ€§èƒ½åœºæ™¯é…ç½®

# é€‚ç”¨äºå¤œé—´ç»´æŠ¤çª—å£ï¼Œè¿½æ±‚æ‰§è¡Œé€Ÿåº¦

pt-online-schema-change \
  --chunk-size=5000 \           # å¤§æ‰¹é‡æå‡é€Ÿåº¦
  --chunk-time=1 \              # è¾ƒå¤§æ—¶é—´ç‰‡
  --max-lag=10 \                # å…è®¸æ›´å¤§å»¶è¿Ÿ
  --critical-load="Threads_running:50" \
  --max-load="Threads_running:30" \
  --execute

# 2. ä½å½±å“åœºæ™¯é…ç½®  

# é€‚ç”¨äºä¸šåŠ¡é«˜å³°æœŸï¼Œè¿½æ±‚æœ€å°å½±å“

pt-online-schema-change \
  --chunk-size=500 \            # å°æ‰¹é‡å‡å°‘å½±å“
  --chunk-time=0.1 \            # å°æ—¶é—´ç‰‡
  --max-lag=1 \                 # ä¸¥æ ¼å»¶è¿Ÿæ§åˆ¶
  --critical-load="Threads_running:10" \
  --max-load="Threads_running:5" \
  --sleep=1 \                   # æ‰¹æ¬¡é—´ä¼‘æ¯
  --execute

# 3. å¹³è¡¡æ€§èƒ½é…ç½®

# é€‚ç”¨äºä¸€èˆ¬æƒ…å†µï¼Œå¹³è¡¡é€Ÿåº¦å’Œå½±å“

pt-online-schema-change \
  --chunk-size=1000 \
  --chunk-time=0.5 \
  --max-lag=5 \
  --critical-load="Threads_running:25" \
  --max-load="Threads_running:15" \
  --progress="time,30" \        # 30ç§’æŠ¥å‘Šè¿›åº¦
  --execute
```

### 7.3 è¿æ¥é—®é¢˜è§£å†³æ–¹æ¡ˆ



**ğŸ”— è¿æ¥æ•…éšœä¿®å¤ç­–ç•¥**

```bash
# è¿æ¥é—®é¢˜è¯Šæ–­æµç¨‹

# 1. åŸºç¡€è¿é€šæ€§æµ‹è¯•

ping mysql_host
telnet mysql_host 3306
nmap -p 3306 mysql_host

# 2. MySQLæœåŠ¡çŠ¶æ€æ£€æŸ¥

systemctl status mysql
mysql -e "SELECT 1;" 2>&1

# 3. è¿æ¥æ•°æ£€æŸ¥

mysql -e "SHOW GLOBAL STATUS LIKE 'Max_used_connections';"
mysql -e "SHOW VARIABLES LIKE 'max_connections';"
mysql -e "SHOW PROCESSLIST;" | wc -l

# 4. æƒé™éªŒè¯

mysql -u pt_user -p -e "SELECT USER(), CURRENT_USER();"

# è¿æ¥å‚æ•°ä¼˜åŒ–

pt-table-checksum \
  --max-lag=5 \
  --chunk-size=1000 \
  --retries=3 \                 # å¤±è´¥é‡è¯•æ¬¡æ•°
  --set-vars="innodb_lock_wait_timeout=50" \
  --set-vars="lock_wait_timeout=60" \
  h=mysql_host,u=pt_user,p=password
```

### 7.4 æ•°æ®ä¸€è‡´æ€§é—®é¢˜è§£å†³



**ğŸ”„ æ•°æ®ä¿®å¤æ ‡å‡†æµç¨‹**

```bash
# 1. é—®é¢˜ç¡®è®¤é˜¶æ®µ

pt-table-checksum \
  --databases=problem_db \
  --tables=problem_table \
  h=master_host,u=pt_user,p=password

# 2. å·®å¼‚åˆ†æé˜¶æ®µ  

pt-table-checksum \
  --replicate-check-only \     # åªæ£€æŸ¥å·²æœ‰ç»“æœ
  --databases=problem_db \
  h=master_host,u=pt_user,p=password

# 3. æ•°æ®ä¿®å¤é˜¶æ®µ

pt-table-sync \
  --execute \                  # å®é™…æ‰§è¡Œä¿®å¤
  --verbose \                  # æ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹  
  --chunk-size=1000 \
  --set-vars="foreign_key_checks=0" \
  h=master_host,D=problem_db,t=problem_table \
  h=slave_host

# 4. ä¿®å¤éªŒè¯é˜¶æ®µ

pt-table-checksum \
  --databases=problem_db \
  --tables=problem_table \
  h=master_host,u=pt_user,p=password

# é¢„é˜²æ€§æªæ–½

# å®šæœŸæ£€æŸ¥è„šæœ¬

cat > daily_checksum.sh << 'EOF'
#!/bin/bash

LOG_FILE="/var/log/pt-checksum-$(date +%Y%m%d).log"
pt-table-checksum \
  --databases=production_db \
  --quiet \
  h=master,u=pt_user,p=password >> $LOG_FILE 2>&1

# æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚

if grep -q "DIFFS" $LOG_FILE; then
  echo "Data inconsistency detected!" | mail -s "PT-Checksum Alert" admin@company.com
fi
EOF
```

---

## 8. ğŸ›¡ï¸ é¢„é˜²æªæ–½å»ºè®®



### 8.1 ç›‘æ§ä½“ç³»å»ºè®¾



**ğŸ“Š åˆ†å±‚ç›‘æ§æ¶æ„**

```
ç›‘æ§ä½“ç³»ç»“æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŸºç¡€è®¾æ–½ç›‘æ§   â”‚   æ•°æ®åº“ç›‘æ§     â”‚   å·¥å…·ä¸“é¡¹ç›‘æ§   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ CPU/å†…å­˜/ç£ç›˜ â”‚ â€¢ è¿æ¥æ•°/TPS/QPS â”‚ â€¢ å·¥å…·æ‰§è¡ŒçŠ¶æ€   â”‚
â”‚ â€¢ ç½‘ç»œå»¶è¿Ÿ/å¸¦å®½ â”‚ â€¢ ä¸»ä»å»¶è¿Ÿ/çŠ¶æ€  â”‚ â€¢ é”™è¯¯ç‡/å‘Šè­¦   â”‚
â”‚ â€¢ ç³»ç»Ÿè´Ÿè½½/è¿›ç¨‹ â”‚ â€¢ é”ç­‰å¾…/æ­»é”   â”‚ â€¢ æ€§èƒ½åŸºçº¿å¯¹æ¯”   â”‚
â”‚ â€¢ ç£ç›˜IO/ç©ºé—´   â”‚ â€¢ æ…¢æŸ¥è¯¢/ç´¢å¼•   â”‚ â€¢ èµ„æºä½¿ç”¨è¶‹åŠ¿   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ” å…³é”®æŒ‡æ ‡é…ç½®**

```bash
# 1. åŸºç¡€ç›‘æ§æŒ‡æ ‡

# CPUä½¿ç”¨ç‡ç›‘æ§

cpu_threshold=80
current_cpu=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
if (( $(echo "$current_cpu > $cpu_threshold" | bc -l) )); then
  echo "CPU usage high: $current_cpu%" | mail -s "CPU Alert" admin@company.com
fi

# 2. MySQLä¸“é¡¹ç›‘æ§

mysql_monitor() {
#  # è¿æ¥æ•°ç›‘æ§
  max_conn=$(mysql -e "SHOW VARIABLES LIKE 'max_connections';" | awk 'NR==2{print $2}')
  curr_conn=$(mysql -e "SHOW STATUS LIKE 'Threads_connected';" | awk 'NR==2{print $2}')
  conn_ratio=$(echo "scale=2; $curr_conn / $max_conn * 100" | bc)
  
  if (( $(echo "$conn_ratio > 80" | bc -l) )); then
    echo "Connection usage: $conn_ratio%" | mail -s "MySQL Connection Alert" admin@company.com
  fi
  
#  # ä¸»ä»å»¶è¿Ÿç›‘æ§
  slave_lag=$(mysql -e "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master" | awk '{print $2}')
  if [[ "$slave_lag" != "NULL" ]] && [[ $slave_lag -gt 10 ]]; then
    echo "Slave lag: $slave_lag seconds" | mail -s "Replication Alert" admin@company.com
  fi
}

# 3. Perconaå·¥å…·ä¸“é¡¹ç›‘æ§

pt_monitor() {
#  # æ£€æŸ¥å·¥å…·è¿›ç¨‹çŠ¶æ€
  pt_processes=$(pgrep -f "pt-" | wc -l)
  if [[ $pt_processes -gt 5 ]]; then
    echo "Too many PT tools running: $pt_processes" | mail -s "PT Tools Alert" admin@company.com
  fi
  
#  # æ£€æŸ¥å·¥å…·é”™è¯¯æ—¥å¿—
  error_count=$(grep -c "ERROR" /var/log/pt-tools.log)
  if [[ $error_count -gt 10 ]]; then
    echo "PT tools error count: $error_count" | mail -s "PT Tools Error Alert" admin@company.com
  fi
}
```

### 8.2 å®¹é‡è§„åˆ’å»ºè®®



**ğŸ“ˆ èµ„æºéœ€æ±‚è¯„ä¼°**

```
å®¹é‡è§„åˆ’ç»´åº¦:

ç£ç›˜ç©ºé—´è§„åˆ’:
â€¢ åŸè¡¨å¤§å° Ã— 2.5 = æœ€å°æ‰€éœ€ç©ºé—´
â€¢ è€ƒè™‘ä¸´æ—¶è¡¨ã€æ—¥å¿—ã€å¤‡ä»½ç©ºé—´
â€¢ é¢„ç•™30%çš„ç¼“å†²ç©ºé—´

å†…å­˜éœ€æ±‚è§„åˆ’:  
â€¢ InnoDB Buffer Poolä¿æŒ75%å‘½ä¸­ç‡
â€¢ å·¥å…·è¿›ç¨‹å†…å­˜ â‰ˆ chunk-size Ã— è¡Œå¤§å° Ã— 2
â€¢ ç³»ç»Ÿé¢„ç•™å†…å­˜ â‰¥ 2GB

ç½‘ç»œå¸¦å®½è§„åˆ’:
â€¢ ä¸»ä»å¤åˆ¶å¸¦å®½ = å³°å€¼å†™å…¥é‡ Ã— 1.5
â€¢ å·¥å…·æ‰§è¡Œå¸¦å®½ = è¡¨å¤§å° Ã· æ‰§è¡Œæ—¶é—´çª—å£
â€¢ é¢„ç•™50%çš„å¸¦å®½ç¼“å†²

æ‰§è¡Œæ—¶é—´è§„åˆ’:
â€¢ æ•°æ®å¤åˆ¶æ—¶é—´ = è¡¨å¤§å° Ã· (chunk-size Ã— é¢‘ç‡)
â€¢ æ€»æ‰§è¡Œæ—¶é—´ = å¤åˆ¶æ—¶é—´ + 20%ç¼“å†²
â€¢ ç»´æŠ¤çª—å£ â‰¥ æ€»æ‰§è¡Œæ—¶é—´ Ã— 1.5
```

### 8.3 æ ‡å‡†æ“ä½œç¨‹åº



**ğŸ“‹ SOPæ–‡æ¡£æ¨¡æ¿**

```markdown
# Perconaå·¥å…·æ‰§è¡Œæ ‡å‡†æµç¨‹



## æ‰§è¡Œå‰æ£€æŸ¥æ¸…å•


â–¡ ç¡®è®¤ç»´æŠ¤çª—å£æ—¶é—´
â–¡ æ£€æŸ¥ç³»ç»Ÿèµ„æºçŠ¶å†µï¼ˆCPU < 50%, å†…å­˜ > 20%, ç£ç›˜ > 30%ï¼‰
â–¡ éªŒè¯ä¸»ä»å¤åˆ¶çŠ¶æ€æ­£å¸¸ï¼ˆå»¶è¿Ÿ < 5ç§’ï¼‰
â–¡ å¤‡ä»½å…³é”®æ•°æ®
â–¡ å‡†å¤‡å›æ»šæ–¹æ¡ˆ
â–¡ é€šçŸ¥ç›¸å…³å›¢é˜Ÿ

## æ‰§è¡Œè¿‡ç¨‹ç›‘æ§


â–¡ å®æ—¶ç›‘æ§ç³»ç»Ÿèµ„æº
â–¡ è·Ÿè¸ªå·¥å…·æ‰§è¡Œè¿›åº¦
â–¡ è§‚å¯Ÿä¸»ä»å¤åˆ¶å»¶è¿Ÿ
â–¡ è®°å½•å…³é”®æ—¶é—´èŠ‚ç‚¹
â–¡ ä¿æŒä¸ä¸šåŠ¡å›¢é˜Ÿæ²Ÿé€š

## æ‰§è¡ŒåéªŒè¯


â–¡ éªŒè¯æ•°æ®å®Œæ•´æ€§
â–¡ æ£€æŸ¥åº”ç”¨åŠŸèƒ½æ­£å¸¸
â–¡ ç¡®è®¤æ€§èƒ½æŒ‡æ ‡ç¨³å®š
â–¡ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
â–¡ æ›´æ–°æ–‡æ¡£è®°å½•

## å¼‚å¸¸å¤„ç†æµç¨‹


â–¡ ç«‹å³åœæ­¢å·¥å…·æ‰§è¡Œ
â–¡ è¯„ä¼°å½±å“èŒƒå›´
â–¡ å¯åŠ¨åº”æ€¥å“åº”
â–¡ æ‰§è¡Œå›æ»šè®¡åˆ’
â–¡ åˆ†ææ ¹æœ¬åŸå› 
```

### 8.4 çŸ¥è¯†ç®¡ç†ä½“ç³»



**ğŸ“š ç»éªŒçŸ¥è¯†åº“å»ºè®¾**

```
çŸ¥è¯†åº“ç»“æ„:

1. é—®é¢˜æ¡ˆä¾‹åº“
   - é—®é¢˜æè¿°
   - ç¯å¢ƒä¿¡æ¯  
   - è§£å†³è¿‡ç¨‹
   - ç»éªŒæ•™è®­
   - é¢„é˜²æªæ–½

2. æœ€ä½³å®è·µåº“
   - å‚æ•°é…ç½®æ¨¡æ¿
   - æ‰§è¡Œæ—¶æœºå»ºè®®
   - æ€§èƒ½ä¼˜åŒ–æŠ€å·§
   - å®‰å…¨æ³¨æ„äº‹é¡¹

3. å·¥å…·ä½¿ç”¨æ‰‹å†Œ
   - å¸¸ç”¨å‘½ä»¤é›†åˆ
   - å‚æ•°è¯´æ˜è¯¦è§£
   - ä½¿ç”¨åœºæ™¯æŒ‡å—
   - æ•…éšœæ’æŸ¥æ­¥éª¤

4. ç¯å¢ƒé…ç½®åº“
   - æµ‹è¯•ç¯å¢ƒæ­å»º
   - æƒé™é…ç½®æ¨¡æ¿
   - ç›‘æ§è„šæœ¬é›†åˆ
   - è‡ªåŠ¨åŒ–å·¥å…·è„šæœ¬
```

---

## 9. ğŸ”„ æ•…éšœå¤„ç†æµç¨‹



### 9.1 åº”æ€¥å“åº”æœºåˆ¶



**ğŸš¨ æ•…éšœå“åº”åˆ†çº§**

```
æ•…éšœå“åº”æµç¨‹:

P0çº§åˆ« - ç«‹å³å“åº”ï¼ˆ5åˆ†é’Ÿå†…ï¼‰:
1. ç«‹å³åœæ­¢æ‰€æœ‰Perconaå·¥å…·æ‰§è¡Œ
2. è¯„ä¼°ä¸šåŠ¡å½±å“èŒƒå›´
3. å¯åŠ¨åº”æ€¥æŒ‡æŒ¥ä¸­å¿ƒ
4. é€šçŸ¥æ‰€æœ‰ç›¸å…³å›¢é˜Ÿ
5. å¼€å§‹æ‰§è¡Œåº”æ€¥æ¢å¤æ–¹æ¡ˆ

P1çº§åˆ« - å¿«é€Ÿå“åº”ï¼ˆ15åˆ†é’Ÿå†…ï¼‰:
1. æš‚åœå½“å‰å·¥å…·æ‰§è¡Œ
2. åˆ†æé—®é¢˜å½±å“ç¨‹åº¦
3. é€šçŸ¥æ ¸å¿ƒæŠ€æœ¯å›¢é˜Ÿ
4. åˆ¶å®šä¸´æ—¶è§£å†³æ–¹æ¡ˆ
5. å‡†å¤‡è¯¦ç»†ä¿®å¤è®¡åˆ’

P2çº§åˆ« - æ ‡å‡†å“åº”ï¼ˆ30åˆ†é’Ÿå†…ï¼‰:
1. è®°å½•é—®é¢˜è¯¦ç»†ä¿¡æ¯
2. åˆ†æé—®é¢˜æ ¹æœ¬åŸå› 
3. åˆ¶å®šè§£å†³æ–¹æ¡ˆ
4. æŒ‰è®¡åˆ’æ‰§è¡Œä¿®å¤
5. è·Ÿè¸ªä¿®å¤æ•ˆæœ

P3çº§åˆ« - å»¶è¿Ÿå“åº”ï¼ˆ2å°æ—¶å†…ï¼‰:
1. æ”¶é›†é—®é¢˜ç›¸å…³ä¿¡æ¯
2. å®‰æ’åˆé€‚æ—¶é—´å¤„ç†
3. åˆ¶å®šé¢„é˜²æªæ–½
4. æ›´æ–°çŸ¥è¯†åº“
5. ä¼˜åŒ–æµç¨‹æ–‡æ¡£
```

### 9.2 é—®é¢˜å‡çº§æœºåˆ¶



**ğŸ“ å‡çº§å†³ç­–æ ‘**

```
å‡çº§å†³ç­–æµç¨‹:

é—®é¢˜å‘ç”Ÿ â†’ åˆæ­¥è¯„ä¼°
    â”‚
    â”œâ”€ èƒ½åœ¨30åˆ†é’Ÿå†…è§£å†³ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ å½“å€¼å·¥ç¨‹å¸ˆå¤„ç†
    â”‚   â””â”€ å¦ â†’ å‡çº§åˆ°é«˜çº§å·¥ç¨‹å¸ˆ
    â”‚
    â”œâ”€ å½±å“æ ¸å¿ƒä¸šåŠ¡ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ å‡çº§åˆ°æŠ€æœ¯ä¸»ç®¡
    â”‚   â””â”€ å¦ â†’ ç»§ç»­æŠ€æœ¯å¤„ç†
    â”‚
    â”œâ”€ éœ€è¦ä¸šåŠ¡å†³ç­–ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ å‡çº§åˆ°ä¸šåŠ¡è´Ÿè´£äºº
    â”‚   â””â”€ å¦ â†’ ç»§ç»­æŠ€æœ¯å¤„ç†
    â”‚
    â””â”€ éœ€è¦å¤–éƒ¨æ”¯æŒï¼Ÿ
        â”œâ”€ æ˜¯ â†’ è”ç³»å‚å•†æŠ€æœ¯æ”¯æŒ
        â””â”€ å¦ â†’ å†…éƒ¨è§£å†³

å‡çº§è”ç³»æ–¹å¼:
- å½“å€¼å·¥ç¨‹å¸ˆ: æ‰‹æœº + ä¼ä¸šå¾®ä¿¡
- é«˜çº§å·¥ç¨‹å¸ˆ: ç”µè¯ + çŸ­ä¿¡
- æŠ€æœ¯ä¸»ç®¡: ç”µè¯ + é‚®ä»¶
- ä¸šåŠ¡è´Ÿè´£äºº: ç”µè¯ + é¢è°ˆ
```

### 9.3 æ²Ÿé€šåè°ƒæœºåˆ¶



**ğŸ“¢ ä¿¡æ¯ä¼ é€’æµç¨‹**

```bash
# æ•…éšœé€šçŸ¥æ¨¡æ¿è„šæœ¬

send_alert() {
  local severity=$1
  local title=$2  
  local message=$3
  local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
  
#  # æ„é€ é€šçŸ¥å†…å®¹
  cat > /tmp/alert_message.txt << EOF
ã€æ•…éšœç­‰çº§ã€‘: $severity
ã€å‘ç”Ÿæ—¶é—´ã€‘: $timestamp
ã€æ•…éšœæ ‡é¢˜ã€‘: $title
ã€è¯¦ç»†æè¿°ã€‘: $message
ã€å½“å‰çŠ¶æ€ã€‘: æ­£åœ¨å¤„ç†ä¸­
ã€é¢„è®¡æ¢å¤ã€‘: è¯„ä¼°ä¸­
ã€æŠ€æœ¯è´Ÿè´£äººã€‘: $(whoami)
ã€è”ç³»æ–¹å¼ã€‘: æŠ€æœ¯çƒ­çº¿ 400-xxx-xxxx
EOF

#  # å‘é€é€šçŸ¥
  case $severity in
    "P0"|"P1")
#      # ç´§æ€¥é€šçŸ¥: çŸ­ä¿¡ + å¾®ä¿¡ + é‚®ä»¶
      send_sms "$(cat /tmp/alert_message.txt)"
      send_wechat "$(cat /tmp/alert_message.txt)"  
      send_email "$(cat /tmp/alert_message.txt)"
      ;;
    "P2")
#      # æ ‡å‡†é€šçŸ¥: å¾®ä¿¡ + é‚®ä»¶
      send_wechat "$(cat /tmp/alert_message.txt)"
      send_email "$(cat /tmp/alert_message.txt)"
      ;;
    "P3")
#      # æ™®é€šé€šçŸ¥: é‚®ä»¶
      send_email "$(cat /tmp/alert_message.txt)"
      ;;
  esac
}

# ä½¿ç”¨ç¤ºä¾‹

send_alert "P1" "pt-online-schema-changeæ‰§è¡Œå¤±è´¥" \
  "å¤§è¡¨DDLæ“ä½œåœ¨ç¬¬3æ­¥å‡ºç°é”ç­‰å¾…è¶…æ—¶ï¼Œå½“å‰ä¸šåŠ¡æŸ¥è¯¢å“åº”æ—¶é—´å¢åŠ åˆ°5ç§’"
```

### 9.4 æ¢å¤éªŒè¯æµç¨‹



**âœ… æ¢å¤æ£€æŸ¥æ ‡å‡†**

```sql
-- æ•°æ®åº“æ¢å¤éªŒè¯æ£€æŸ¥å•
-- 1. åŸºç¡€è¿æ¥éªŒè¯
SELECT 'Connection Test' as test_name, 
       NOW() as test_time, 
       CONNECTION_ID() as connection_id;

-- 2. ä¸»ä»çŠ¶æ€éªŒè¯
SHOW SLAVE STATUS\G

-- 3. è¡¨ç»“æ„å®Œæ•´æ€§éªŒè¯
SELECT 
  TABLE_SCHEMA,
  TABLE_NAME,
  TABLE_ROWS,
  CREATE_TIME,
  UPDATE_TIME
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY TABLE_NAME;

-- 4. ç´¢å¼•å®Œæ•´æ€§éªŒè¯
SELECT 
  TABLE_NAME,
  INDEX_NAME,
  COLUMN_NAME,
  SEQ_IN_INDEX
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'your_database'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;

-- 5. æƒé™éªŒè¯
SELECT 
  User,
  Host,
  Select_priv,
  Insert_priv,
  Update_priv,
  Delete_priv
FROM mysql.user 
WHERE User LIKE 'pt_%';

-- 6. æ€§èƒ½æŒ‡æ ‡éªŒè¯
SELECT 
  VARIABLE_NAME,
  VARIABLE_VALUE
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN (
  'Threads_connected',
  'Threads_running', 
  'Queries',
  'Questions',
  'Uptime'
);
```

**ğŸ“Š ä¸šåŠ¡åŠŸèƒ½éªŒè¯**

```bash
# ä¸šåŠ¡åŠŸèƒ½éªŒè¯è„šæœ¬

business_validation() {
  echo "å¼€å§‹ä¸šåŠ¡åŠŸèƒ½éªŒè¯..."
  
#  # 1. æ ¸å¿ƒæŸ¥è¯¢æµ‹è¯•
  mysql -e "SELECT COUNT(*) FROM core_table WHERE status = 'active';" > /tmp/test1.log
  if [[ $? -eq 0 ]]; then
    echo "âœ“ æ ¸å¿ƒæŸ¥è¯¢æµ‹è¯•é€šè¿‡"
  else
    echo "âœ— æ ¸å¿ƒæŸ¥è¯¢æµ‹è¯•å¤±è´¥"
    return 1
  fi
  
#  # 2. å†™å…¥åŠŸèƒ½æµ‹è¯•
  test_id=$(date +%s)
  mysql -e "INSERT INTO test_table (id, name, created_at) VALUES ($test_id, 'test', NOW());" > /tmp/test2.log
  if [[ $? -eq 0 ]]; then
    echo "âœ“ å†™å…¥åŠŸèƒ½æµ‹è¯•é€šè¿‡"
#    # æ¸…ç†æµ‹è¯•æ•°æ®
    mysql -e "DELETE FROM test_table WHERE id = $test_id;"
  else
    echo "âœ— å†™å…¥åŠŸèƒ½æµ‹è¯•å¤±è´¥"
    return 1
  fi
  
#  # 3. åº”ç”¨æ¥å£æµ‹è¯•
  response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health)
  if [[ "$response" == "200" ]]; then
    echo "âœ“ åº”ç”¨æ¥å£æµ‹è¯•é€šè¿‡"
  else
    echo "âœ— åº”ç”¨æ¥å£æµ‹è¯•å¤±è´¥ï¼Œè¿”å›ç : $response"
    return 1
  fi
  
  echo "ä¸šåŠ¡åŠŸèƒ½éªŒè¯å®Œæˆ"
  return 0
}
```

---

## 10. ğŸ“– ç»éªŒçŸ¥è¯†ç§¯ç´¯



### 10.1 å…¸å‹æ¡ˆä¾‹åº“



**ğŸ“š ç»å…¸æ•…éšœæ¡ˆä¾‹é›†**

```markdown
## æ¡ˆä¾‹1: pt-online-schema-changeæ­»é”é—®é¢˜



**é—®é¢˜æè¿°**: 
åœ¨ç»™å¤§è¡¨æ·»åŠ ç´¢å¼•æ—¶ï¼Œpt-online-schema-changeå·¥å…·è¿è¡Œåˆ°50%è¿›åº¦æ—¶å‡ºç°æ­»é”ï¼Œ
å¯¼è‡´å¤§é‡ä¸šåŠ¡æŸ¥è¯¢è¢«é˜»å¡ã€‚

**ç¯å¢ƒä¿¡æ¯**:
- MySQL 8.0.25
- è¡¨å¤§å°: 5000ä¸‡è¡Œ
- å¹¶å‘è¿æ¥: 200+
- æ‰§è¡Œæ—¶é—´: ä¸šåŠ¡é«˜å³°æœŸ

**é—®é¢˜åˆ†æ**:
1. å·¥å…·åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ä¸ä¸šåŠ¡æŸ¥è¯¢äº§ç”Ÿé”ç«äº‰
2. è§¦å‘å™¨é€»è¾‘ä¸ç°æœ‰ç´¢å¼•æŸ¥è¯¢è·¯å¾„å†²çª
3. chunk-sizeè®¾ç½®è¿‡å¤§ï¼Œå•æ¬¡æ“ä½œæ—¶é—´è¿‡é•¿

**è§£å†³è¿‡ç¨‹**:
1. ç«‹å³åœæ­¢pt-oscæ‰§è¡Œ
2. KILLé˜»å¡çš„æŸ¥è¯¢è¿›ç¨‹  
3. è°ƒæ•´å‚æ•°é‡æ–°æ‰§è¡Œ:
   - chunk-size: 5000 â†’ 1000
   - max-load: Threads_running:30 â†’ 15
   - æ·»åŠ sleepé—´éš”: 0.5ç§’

**ç»éªŒæ•™è®­**:
- é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸæ‰§è¡Œå¤§è¡¨DDL
- åˆç†è®¾ç½®è´Ÿè½½é˜ˆå€¼å’Œæ‰¹é‡å¤§å°
- å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œä¸­æ–­æœºåˆ¶

**é¢„é˜²æªæ–½**:
- åˆ¶å®šè¯¦ç»†çš„æ‰§è¡Œè®¡åˆ’å’Œæ—¶é—´çª—å£
- åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯å‚æ•°é…ç½®
- å»ºç«‹è‡ªåŠ¨åŒ–çš„ç›‘æ§å‘Šè­¦æœºåˆ¶
```

### 10.2 å‚æ•°è°ƒä¼˜ç»éªŒ



**âš™ï¸ å‚æ•°é…ç½®ç»éªŒæ€»ç»“**

```bash
# ä¸åŒåœºæ™¯çš„å‚æ•°é…ç½®æ¨¡æ¿


# 1. å¤§è¡¨DDL (>1000ä¸‡è¡Œ)

pt-online-schema-change \
  --chunk-size=500 \              # å°æ‰¹é‡å‡å°‘é”ç«äº‰
  --chunk-time=0.1 \              # çŸ­æ—¶é—´ç‰‡
  --sleep=0.5 \                   # å¢åŠ ä¼‘æ¯é—´éš”
  --max-lag=1 \                   # ä¸¥æ ¼æ§åˆ¶å»¶è¿Ÿ
  --critical-load="Threads_running:10,Threads_connected:100" \
  --max-load="Threads_running:5,Threads_connected:80" \
  --check-slave-lag \             # æ£€æŸ¥æ‰€æœ‰ä»åº“
  --recursion-method="hosts" \    # æŒ‡å®šä»åº“å‘ç°æ–¹å¼
  --execute

# 2. å°è¡¨DDL (<100ä¸‡è¡Œ)  

pt-online-schema-change \
  --chunk-size=2000 \             # å¯ä»¥ç”¨è¾ƒå¤§æ‰¹é‡
  --chunk-time=0.5 \
  --max-lag=5 \                   # å…è®¸ç¨å¤§å»¶è¿Ÿ
  --critical-load="Threads_running:25" \
  --max-load="Threads_running:15" \
  --execute

# 3. ç´§æ€¥ä¿®å¤åœºæ™¯

pt-online-schema-change \
  --chunk-size=1000 \
  --chunk-time=1 \                # è¾ƒå¤§æ—¶é—´ç‰‡æå‡é€Ÿåº¦
  --max-lag=10 \                  # å…è®¸æ›´å¤§å»¶è¿Ÿ
  --critical-load="Threads_running:50" \
  --max-load="Threads_running:30" \
  --no-check-replication-filters \  # è·³è¿‡ä¸€äº›æ£€æŸ¥
  --execute

# å‚æ•°é€‰æ‹©ç»éªŒå…¬å¼

chunk_size = min(10000, è¡¨æ€»è¡Œæ•° / 1000)
chunk_time = ä¸šåŠ¡ç¹å¿™åº¦ * 0.1  # ç¹å¿™åº¦1-10
max_lag = ä¸šåŠ¡å®¹å¿åº¦ * 5       # å®¹å¿åº¦1-10ç§’
sleep = (1 - ç»´æŠ¤çª—å£ç´§è¿«åº¦) * 1.0  # ç´§è¿«åº¦0-1
```

### 10.3 æ€§èƒ½åŸºå‡†æ•°æ®



**ğŸ“Š æ€§èƒ½åŸºå‡†å‚è€ƒè¡¨**

| è¡¨å¤§å° | **æ¨èchunk-size** | **é¢„ä¼°æ—¶é—´** | **å†…å­˜éœ€æ±‚** | **æ³¨æ„äº‹é¡¹** |
|--------|-------------------|-------------|-------------|-------------|
| `< 10ä¸‡è¡Œ` | `5000-10000` | `5-15åˆ†é’Ÿ` | `< 100MB` | `å¯åœ¨ä¸šåŠ¡æœŸæ‰§è¡Œ` |
| `10ä¸‡-100ä¸‡è¡Œ` | `2000-5000` | `30åˆ†é’Ÿ-2å°æ—¶` | `100-500MB` | `é€‰æ‹©ä½å³°æœŸæ‰§è¡Œ` |
| `100ä¸‡-1000ä¸‡è¡Œ` | `1000-2000` | `2-8å°æ—¶` | `500MB-2GB` | `å¿…é¡»åœ¨ç»´æŠ¤çª—å£` |
| `1000ä¸‡-1äº¿è¡Œ` | `500-1000` | `8-24å°æ—¶` | `2-8GB` | `åˆ†å¤šæ¬¡æ‰§è¡Œ` |
| `> 1äº¿è¡Œ` | `200-500` | `1å¤©ä»¥ä¸Š` | `> 8GB` | `è€ƒè™‘åˆ†è¡¨æ–¹æ¡ˆ` |

**âš¡ ä¸åŒç¡¬ä»¶é…ç½®çš„æ€§èƒ½å‚è€ƒ**

```
ç¡¬ä»¶é…ç½®å¯¹æ€§èƒ½çš„å½±å“:

CPUæ€§èƒ½å½±å“:
- 8æ ¸å¿ƒ: åŸºå‡†æ€§èƒ½
- 16æ ¸å¿ƒ: æ€§èƒ½æå‡20-30%
- 32æ ¸å¿ƒ: æ€§èƒ½æå‡40-50%

å†…å­˜å¤§å°å½±å“:
- 8GB: é€‚åˆå°è¡¨æ“ä½œ
- 32GB: é€‚åˆä¸­ç­‰è§„æ¨¡è¡¨  
- 64GB+: é€‚åˆå¤§è¡¨æ“ä½œ

ç£ç›˜ç±»å‹å½±å“:
- HDDæœºæ¢°ç›˜: åŸºå‡†é€Ÿåº¦
- SATA SSD: é€Ÿåº¦æå‡3-5å€
- NVMe SSD: é€Ÿåº¦æå‡5-10å€

ç½‘ç»œå¸¦å®½å½±å“:
- åƒå…†ç½‘ç»œ: å¯èƒ½æˆä¸ºç“¶é¢ˆ
- ä¸‡å…†ç½‘ç»œ: é€šå¸¸ä¸æ˜¯ç“¶é¢ˆ
- å»¶è¿Ÿ < 1ms: æœ€ä½³æ€§èƒ½
```

### 10.4 çŸ¥è¯†ä¼ æ‰¿æœºåˆ¶



**ğŸ“ å›¢é˜ŸçŸ¥è¯†å…±äº«**

```markdown
# çŸ¥è¯†ä¼ æ‰¿ä½“ç³»å»ºè®¾



## 1. æ–‡æ¡£ä½“ç³»


- **æ“ä½œæ‰‹å†Œ**: è¯¦ç»†çš„æ­¥éª¤è¯´æ˜å’Œå‚æ•°é…ç½®
- **æ•…éšœæ¡ˆä¾‹**: çœŸå®é—®é¢˜çš„å®Œæ•´è§£å†³è¿‡ç¨‹  
- **æœ€ä½³å®è·µ**: ç»éªŒæ€»ç»“å’Œä¼˜åŒ–å»ºè®®
- **åŸ¹è®­ææ–™**: æ–°äººåŸ¹è®­å’ŒæŠ€èƒ½æå‡èµ„æ–™

## 2. æŠ€èƒ½è®¤è¯


- **åˆçº§è®¤è¯**: åŸºæœ¬å·¥å…·ä½¿ç”¨å’Œå¸¸è§é—®é¢˜å¤„ç†
- **ä¸­çº§è®¤è¯**: å¤æ‚åœºæ™¯å¤„ç†å’Œæ€§èƒ½è°ƒä¼˜
- **é«˜çº§è®¤è¯**: æ¶æ„è®¾è®¡å’Œå›¢é˜ŸåŸ¹è®­èƒ½åŠ›

## 3. å®šæœŸåˆ†äº«


- **æ¯å‘¨æŠ€æœ¯åˆ†äº«**: åˆ†äº«æ–°å‘ç°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- **æœˆåº¦æ€»ç»“ä¼šè®®**: å›é¡¾å½“æœˆé—®é¢˜å’Œæ”¹è¿›æªæ–½
- **å­£åº¦åŸ¹è®­è®¡åˆ’**: ç³»ç»Ÿæ€§çš„æŠ€èƒ½æå‡åŸ¹è®­

## 4. å·¥å…·å¹³å°


- **çŸ¥è¯†åº“ç³»ç»Ÿ**: é›†ä¸­å­˜å‚¨å’Œæ£€ç´¢æŠ€æœ¯æ–‡æ¡£
- **æ¡ˆä¾‹ç®¡ç†ç³»ç»Ÿ**: è®°å½•å’Œè·Ÿè¸ªé—®é¢˜å¤„ç†è¿‡ç¨‹
- **ç›‘æ§å‘Šè­¦å¹³å°**: å®æ—¶ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦
- **è‡ªåŠ¨åŒ–å·¥å…·**: å¸¸ç”¨æ“ä½œçš„è„šæœ¬åŒ–å’Œè‡ªåŠ¨åŒ–
```

**ğŸ“ åŸ¹è®­è®¡åˆ’æ¨¡æ¿**

```bash
# æ–°äººåŸ¹è®­å¤§çº² (ä¸ºæœŸ2å‘¨)


# ç¬¬1å‘¨: åŸºç¡€çŸ¥è¯†


ç¬¬1å¤©: MySQLåŸºç¡€å’ŒPerconaå·¥å…·ä»‹ç»
ç¬¬2å¤©: pt-table-checksumåŸç†å’Œä½¿ç”¨
ç¬¬3å¤©: pt-online-schema-changeåŸç†å’Œä½¿ç”¨  
ç¬¬4å¤©: pt-archiverå’Œå…¶ä»–å·¥å…·ä»‹ç»
ç¬¬5å¤©: å®éªŒç¯å¢ƒæ­å»ºå’ŒåŸºç¡€æ“ä½œç»ƒä¹ 

# ç¬¬2å‘¨: å®æˆ˜æ¼”ç»ƒ


ç¬¬1å¤©: æ•…éšœæ’æŸ¥æ–¹æ³•å’Œå·¥å…·ä½¿ç”¨
ç¬¬2å¤©: æ€§èƒ½è°ƒä¼˜å’Œå‚æ•°é…ç½®
ç¬¬3å¤©: ç›‘æ§ä½“ç³»å’Œå‘Šè­¦å¤„ç†
ç¬¬4å¤©: çœŸå®æ¡ˆä¾‹åˆ†æå’Œæ¨¡æ‹Ÿæ¼”ç»ƒ
ç¬¬5å¤©: æŠ€èƒ½è€ƒæ ¸å’Œç»éªŒæ€»ç»“

# æŠ€èƒ½è€ƒæ ¸æ ‡å‡†


- èƒ½ç‹¬ç«‹å®Œæˆå¸¸è§DDLæ“ä½œ
- èƒ½å¿«é€Ÿå®šä½å’Œè§£å†³åŸºç¡€é—®é¢˜
- ç†è§£æ ¸å¿ƒåŸç†å’Œæœ€ä½³å®è·µ
- èƒ½ç¼–å†™åŸºç¡€çš„ç›‘æ§å’Œè‡ªåŠ¨åŒ–è„šæœ¬
```

---

## ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾



```
ğŸ”¸ æ•…éšœåˆ†ç±»ä½“ç³»: è¿æ¥ã€æ€§èƒ½ã€æ•°æ®ä¸‰å¤§ç±»é—®é¢˜çš„è¯†åˆ«å’Œå¤„ç†
ğŸ”¸ é”™è¯¯ä¿¡æ¯è§£è¯»: æƒé™ã€è¿æ¥ã€æ•°æ®ç›¸å…³é”™è¯¯çš„å¿«é€Ÿè¯Šæ–­  
ğŸ”¸ æ—¥å¿—åˆ†ææŠ€èƒ½: å¤šæºæ—¥å¿—å…³è”åˆ†æå’Œé—®é¢˜å®šä½æ–¹æ³•
ğŸ”¸ è°ƒè¯•æ¨¡å¼åº”ç”¨: åˆ†æ­¥è°ƒè¯•å’Œæ€§èƒ½è°ƒä¼˜çš„ç³»ç»Ÿæ–¹æ³•
ğŸ”¸ é—®é¢˜é‡ç°æŠ€å·§: æµ‹è¯•ç¯å¢ƒæ­å»ºå’Œæ•…éšœåœºæ™¯æ¨¡æ‹Ÿ
ğŸ”¸ è§£å†³æ–¹æ¡ˆæ²‰æ·€: æ ‡å‡†åŒ–çš„ä¿®å¤æµç¨‹å’Œå‚æ•°æ¨¡æ¿
ğŸ”¸ é¢„é˜²æªæ–½å»ºè®¾: ç›‘æ§ä½“ç³»ã€å®¹é‡è§„åˆ’ã€æ ‡å‡†æµç¨‹
ğŸ”¸ åº”æ€¥å“åº”æœºåˆ¶: åˆ†çº§å“åº”ã€å‡çº§å†³ç­–ã€æ¢å¤éªŒè¯
ğŸ”¸ ç»éªŒçŸ¥è¯†ç®¡ç†: æ¡ˆä¾‹ç§¯ç´¯ã€å‚æ•°è°ƒä¼˜ã€å›¢é˜Ÿä¼ æ‰¿
```

### å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ¯ æ—¥å¸¸è¿ç»´è¦ç‚¹**:
```
ç›‘æ§æ£€æŸ¥ï¼š
- æ¯æ—¥æ£€æŸ¥ç³»ç»Ÿèµ„æºå’Œæ•°æ®åº“çŠ¶æ€  
- å®šæœŸéªŒè¯ç›‘æ§å‘Šè­¦æœºåˆ¶
- è·Ÿè¸ªPerconaå·¥å…·æ‰§è¡Œæ—¥å¿—
- åˆ†ææ€§èƒ½è¶‹åŠ¿å’Œå¼‚å¸¸æ¨¡å¼

æ•…éšœå¤„ç†ï¼š
- å¿«é€Ÿå®šä½é—®é¢˜æ ¹æœ¬åŸå› 
- æŒ‰æ ‡å‡†æµç¨‹æ‰§è¡Œæ¢å¤æ“ä½œ
- åŠæ—¶æ²Ÿé€šå’Œå‡çº§å†³ç­–
- å®Œæ•´è®°å½•å¤„ç†è¿‡ç¨‹

é¢„é˜²æ”¹è¿›ï¼š
- å®šæœŸæ›´æ–°çŸ¥è¯†åº“å’Œæ¡ˆä¾‹
- ä¼˜åŒ–ç›‘æ§ç­–ç•¥å’Œé˜ˆå€¼
- æ”¹è¿›è‡ªåŠ¨åŒ–å·¥å…·å’Œè„šæœ¬
- åŠ å¼ºå›¢é˜ŸæŠ€èƒ½åŸ¹è®­
```

**ğŸ› ï¸ æ•…éšœå¤„ç†æ ¸å¿ƒåŸåˆ™**:
```
å‡†ç¡®æ€§ä¼˜å…ˆï¼š
- å……åˆ†æ”¶é›†ä¿¡æ¯å†åˆ†æ
- éªŒè¯å‡è®¾åå†è¡ŒåŠ¨
- å¤šé‡ç¡®è®¤é¿å…è¯¯åˆ¤

å®‰å…¨æ€§ä¿éšœï¼š
- æ“ä½œå‰åšå¥½å¤‡ä»½
- åˆ†æ­¥éªŒè¯é™ä½é£é™©  
- å‡†å¤‡å›æ»šæ–¹æ¡ˆ

æ•ˆç‡æ€§æå‡ï¼š
- å»ºç«‹æ ‡å‡†å¤„ç†æµç¨‹
- ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·
- ç§¯ç´¯å¯å¤ç”¨ç»éªŒ

æŒç»­æ€§æ”¹è¿›ï¼š
- åˆ†ææ ¹æœ¬åŸå› 
- å®Œå–„é¢„é˜²æªæ–½
- ä¼˜åŒ–å¤„ç†æµç¨‹
- åˆ†äº«ç»éªŒæ•™è®­
```

**ğŸ’¡ ç»éªŒæ€»ç»“è¦ç‚¹**:
```
æŠ€æœ¯å±‚é¢ï¼š
- æŒæ¡æ ¸å¿ƒå·¥å…·åŸç†å’Œå‚æ•°è°ƒä¼˜
- ç†Ÿç»ƒä½¿ç”¨è°ƒè¯•å’Œåˆ†ææ–¹æ³•
- å»ºç«‹å®Œæ•´çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
- ä¸æ–­å­¦ä¹ æ–°ç‰ˆæœ¬ç‰¹æ€§å’Œæœ€ä½³å®è·µ

ç®¡ç†å±‚é¢ï¼š
- å»ºç«‹æ ‡å‡†åŒ–çš„æ“ä½œæµç¨‹
- å®Œå–„å›¢é˜Ÿåä½œå’Œæ²Ÿé€šæœºåˆ¶
- åŠ å¼ºé£é™©æ§åˆ¶å’Œåº”æ€¥å“åº”
- ä¿ƒè¿›çŸ¥è¯†ç§¯ç´¯å’ŒæŠ€èƒ½ä¼ æ‰¿

ä¸šåŠ¡å±‚é¢ï¼š
- æ·±å…¥ç†è§£ä¸šåŠ¡éœ€æ±‚å’Œçº¦æŸ
- å¹³è¡¡æŠ€æœ¯æ–¹æ¡ˆå’Œä¸šåŠ¡å½±å“
- ä¸»åŠ¨æ²Ÿé€šå’Œç®¡ç†é¢„æœŸ
- æŒç»­ä¼˜åŒ–æœåŠ¡è´¨é‡
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ•…éšœæ’æŸ¥æœ‰æ–¹æ³•ï¼Œåˆ†ç±»å®šä½æ˜¯å…³é”®
- æ—¥å¿—åˆ†ææ‰¾çº¿ç´¢ï¼Œè°ƒè¯•æ¨¡å¼åŠ©è¯Šæ–­  
- æ ‡å‡†æµç¨‹ä¿å®‰å…¨ï¼Œå›¢é˜Ÿåä½œè§£éš¾é¢˜
- ç»éªŒç§¯ç´¯ä¿ƒæå‡ï¼Œé¢„é˜²æªæ–½é˜²æœªç„¶