---
title: 30ã€pt-table-syncå¤‡ä»½ä¸€è‡´æ€§éªŒè¯
---
## ğŸ“š ç›®å½•

1. [pt-table-syncå·¥å…·æ¦‚è¿°](#1-pt-table-syncå·¥å…·æ¦‚è¿°)
2. [å¤‡ä»½æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥](#2-å¤‡ä»½æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥)
3. [æ¢å¤æ•°æ®éªŒè¯å®è·µ](#3-æ¢å¤æ•°æ®éªŒè¯å®è·µ)
4. [å¤‡ä»½å®Œæ•´æ€§æµ‹è¯•](#4-å¤‡ä»½å®Œæ•´æ€§æµ‹è¯•)
5. [å¢é‡å¤‡ä»½éªŒè¯æ–¹æ¡ˆ](#5-å¢é‡å¤‡ä»½éªŒè¯æ–¹æ¡ˆ)
6. [è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹](#6-è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹)
7. [ç›‘æ§ä¸ä¼˜åŒ–ç­–ç•¥](#7-ç›‘æ§ä¸ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ pt-table-syncå·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pt-table-sync


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
`pt-table-sync`å°±åƒæ˜¯æ•°æ®åº“çš„"æ ¡å¯¹å‘˜"ï¼Œä¸“é—¨è´Ÿè´£æ£€æŸ¥ä¸¤ä¸ªæ•°æ®åº“è¡¨ä¹‹é—´çš„æ•°æ®æ˜¯å¦å®Œå…¨ä¸€è‡´ã€‚åœ¨å¤‡ä»½éªŒè¯åœºæ™¯ä¸­ï¼Œå®ƒå¸®æˆ‘ä»¬ç¡®è®¤å¤‡ä»½å‡ºæ¥çš„æ•°æ®å’ŒåŸå§‹æ•°æ®æ˜¯ä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚

```
ç®€å•æ¯”å–»ï¼š
åŸå§‹æ•°æ®åº“ = åŸç‰ˆæ–‡æ¡£
å¤‡ä»½æ•°æ®åº“ = å¤å°ä»¶
pt-table-sync = æ ¡å¯¹å‘˜ï¼ˆé€å­—é€å¥å¯¹æ¯”ï¼‰
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**ï¼š
- **æ•°æ®åŒæ­¥**ï¼šè®©ä¸¤ä¸ªè¡¨çš„æ•°æ®ä¿æŒä¸€è‡´
- **å·®å¼‚æ£€æµ‹**ï¼šæ‰¾å‡ºæ•°æ®ä¸ä¸€è‡´çš„åœ°æ–¹
- **å¤‡ä»½éªŒè¯**ï¼šç¡®è®¤å¤‡ä»½æ•°æ®çš„å‡†ç¡®æ€§
- **æ•°æ®ä¿®å¤**ï¼šè‡ªåŠ¨ä¿®å¤å‘ç°çš„å·®å¼‚

### 1.2 å·¥å…·ç‰¹ç‚¹ä¸ä¼˜åŠ¿


**â­ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
```
ğŸ”¸ æ™ºèƒ½å¯¹æ¯”ï¼šé€è¡Œæ¯”è¾ƒæ•°æ®å·®å¼‚
ğŸ”¸ å®‰å…¨æ¨¡å¼ï¼šåªæ£€æŸ¥ä¸ä¿®æ”¹ï¼ˆ--dry-runï¼‰
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†å—å¤„ç†å¤§è¡¨æ•°æ®
ğŸ”¸ çµæ´»é…ç½®ï¼šæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥
ğŸ”¸ è¯¦ç»†æŠ¥å‘Šï¼šæä¾›å®Œæ•´çš„å·®å¼‚åˆ†æ
```

**ğŸ“Š å·¥å…·ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| å¯¹æ¯”é¡¹ç›® | **pt-table-sync** | **ä¼ ç»Ÿæ–¹æ³•** | **ä¼˜åŠ¿** |
|---------|------------------|-------------|---------|
| æ€§èƒ½ | åˆ†å—å¤„ç† âš¡ | å…¨è¡¨æ‰«æ ğŸ¢ | å¤„ç†å¤§è¡¨æ›´é«˜æ•ˆ |
| å®‰å…¨æ€§ | æ”¯æŒåªè¯»æ¨¡å¼ ğŸ”’ | å®¹æ˜“è¯¯æ“ä½œ âš ï¸ | éªŒè¯æ›´å®‰å…¨ |
| å‡†ç¡®æ€§ | é€è¡Œæ ¡éªŒ âœ… | ç®€å•ç»Ÿè®¡ ğŸ“Š | å‘ç°ç»†å¾®å·®å¼‚ |
| è‡ªåŠ¨åŒ– | è„šæœ¬å‹å¥½ ğŸ¤– | æ‰‹å·¥æ“ä½œ âœ‹ | æ˜“äºé›†æˆ |

---

## 2. ğŸ” å¤‡ä»½æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


### 2.1 åŸºæœ¬ä¸€è‡´æ€§éªŒè¯


**ğŸ’¡ ç†è§£æ¦‚å¿µ**ï¼š
æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å°±æ˜¯ç¡®ä¿å¤‡ä»½å‡ºæ¥çš„æ•°æ®å’Œæºæ•°æ®å®Œå…¨ç›¸åŒï¼ŒåŒ…æ‹¬æ•°æ®å†…å®¹ã€æ•°æ®ç»“æ„ã€ç´¢å¼•çŠ¶æ€ç­‰å„ä¸ªæ–¹é¢ã€‚

**ğŸ”¢ åŸºæœ¬éªŒè¯æ­¥éª¤**ï¼š

1ï¸âƒ£ **è¿æ¥é…ç½®**ï¼š
```bash
# åŸºæœ¬çš„ä¸€è‡´æ€§æ£€æŸ¥å‘½ä»¤
pt-table-sync --dry-run \
  --print \
  h=æºæ•°æ®åº“ä¸»æœº,D=æ•°æ®åº“å,t=è¡¨å \
  h=å¤‡ä»½æ•°æ®åº“ä¸»æœº,D=æ•°æ®åº“å,t=è¡¨å
```

2ï¸âƒ£ **è¯¦ç»†æ£€æŸ¥ç¤ºä¾‹**ï¼š
```bash
# å®Œæ•´çš„å¤‡ä»½éªŒè¯å‘½ä»¤
pt-table-sync \
  --dry-run \           # åªæ£€æŸ¥ä¸ä¿®æ”¹
  --print \             # æ‰“å°å·®å¼‚
  --chunk-size=1000 \   # åˆ†å—å¤§å°
  --where="id>0" \      # æŒ‡å®šæ£€æŸ¥èŒƒå›´
  h=192.168.1.10,u=root,p=password,D=production,t=users \
  h=192.168.1.20,u=backup_user,p=backup_pass,D=backup_db,t=users
```

### 2.2 ä¸€è‡´æ€§æ£€æŸ¥é…ç½®


**ğŸ“‹ é‡è¦å‚æ•°è¯´æ˜**ï¼š

```bash
# æ£€æŸ¥æ¨¡å¼å‚æ•°
--dry-run              # åªæ£€æŸ¥ä¸ä¿®æ”¹ï¼ˆéªŒè¯å¿…å¤‡ï¼‰
--print                # æ‰“å°å‘ç°çš„å·®å¼‚
--verbose              # æ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹

# æ€§èƒ½ä¼˜åŒ–å‚æ•°  
--chunk-size=N         # æ¯æ¬¡å¤„ç†çš„è¡Œæ•°
--chunk-time=N         # æ¯å—å¤„ç†æ—¶é—´é™åˆ¶
--max-lag=N            # ä¸»ä»å»¶è¿Ÿé˜ˆå€¼

# å®‰å…¨æ§åˆ¶å‚æ•°
--lock-and-rename      # é”è¡¨é‡å‘½åï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
--no-foreign-key-checks # è·³è¿‡å¤–é”®æ£€æŸ¥
--where="æ¡ä»¶"          # æŒ‡å®šæ£€æŸ¥èŒƒå›´
```

**âš ï¸ é‡è¦æé†’**ï¼š
> åœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå¤‡ä»½éªŒè¯æ—¶ï¼ŒåŠ¡å¿…ä½¿ç”¨`--dry-run`å‚æ•°ï¼Œé¿å…æ„å¤–ä¿®æ”¹æ•°æ®ã€‚

### 2.3 å¸¸è§éªŒè¯åœºæ™¯


**ğŸ“± å®é™…åº”ç”¨åœºæ™¯**ï¼š

```bash
# åœºæ™¯1ï¼šå…¨è¡¨æ•°æ®éªŒè¯
pt-table-sync --dry-run --print \
  h=prod_server,D=ecommerce,t=orders \
  h=backup_server,D=ecommerce_backup,t=orders

# åœºæ™¯2ï¼šæŒ‡å®šæ—¶é—´èŒƒå›´éªŒè¯
pt-table-sync --dry-run --print \
  --where="created_date >= '2024-01-01'" \
  h=source,D=app_db,t=transactions \
  h=backup,D=app_db_backup,t=transactions

# åœºæ™¯3ï¼šå¤šè¡¨æ‰¹é‡éªŒè¯
pt-table-sync --dry-run --print \
  --databases=shop_db \
  h=primary \
  h=backup_host
```

---

## 3. âœ… æ¢å¤æ•°æ®éªŒè¯å®è·µ


### 3.1 æ¢å¤åéªŒè¯æµç¨‹


**ğŸ’¡ ä¸ºä»€ä¹ˆè¦éªŒè¯æ¢å¤**ï¼š
æ•°æ®æ¢å¤å°±åƒä»å¤‡ä»½å…‰ç›˜ä¸­æ¢å¤æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤æ¢å¤å‡ºæ¥çš„æ–‡ä»¶æ˜¯å®Œæ•´çš„ã€æ­£ç¡®çš„ï¼Œæ²¡æœ‰åœ¨æ¢å¤è¿‡ç¨‹ä¸­å‡ºç°æŸåæˆ–ä¸¢å¤±ã€‚

**ğŸ”„ éªŒè¯æµç¨‹å›¾**ï¼š
```
æ•°æ®æ¢å¤ â†’ åŸºç¡€æ£€æŸ¥ â†’ ä¸€è‡´æ€§éªŒè¯ â†’ åŠŸèƒ½æµ‹è¯• â†’ éªŒè¯é€šè¿‡
    â†“         â†“          â†“          â†“         â†“
  æ¢å¤å®Œæˆ   è¡¨ç»“æ„OK   æ•°æ®ä¸€è‡´    åº”ç”¨æ­£å¸¸   ä¸Šçº¿å‡†å¤‡
```

### 3.2 æ¢å¤éªŒè¯æ“ä½œ


**ğŸ”¢ è¯¦ç»†éªŒè¯æ­¥éª¤**ï¼š

1ï¸âƒ£ **è¡¨ç»“æ„éªŒè¯**ï¼š
```bash
# æ¯”è¾ƒè¡¨ç»“æ„æ˜¯å¦ä¸€è‡´
mysqldump --no-data --single-transaction \
  -håŸå§‹æœåŠ¡å™¨ -uç”¨æˆ· -på¯†ç  æ•°æ®åº“å è¡¨å > original_structure.sql

mysqldump --no-data --single-transaction \
  -hæ¢å¤æœåŠ¡å™¨ -uç”¨æˆ· -på¯†ç  æ•°æ®åº“å è¡¨å > restored_structure.sql

# å¯¹æ¯”ç»“æ„æ–‡ä»¶
diff original_structure.sql restored_structure.sql
```

2ï¸âƒ£ **æ•°æ®å†…å®¹éªŒè¯**ï¼š
```bash
# ä½¿ç”¨pt-table-syncéªŒè¯æ•°æ®ä¸€è‡´æ€§
pt-table-sync --dry-run --print \
  --chunk-size=5000 \
  h=åŸå§‹åº“,D=database_name,t=table_name \
  h=æ¢å¤åº“,D=database_name,t=table_name
```

3ï¸âƒ£ **æ•°æ®é‡ç»Ÿè®¡éªŒè¯**ï¼š
```bash
# å¯¹æ¯”æ€»è¡Œæ•°
mysql -håŸå§‹æœåŠ¡å™¨ -e "SELECT COUNT(*) FROM database.table"
mysql -hæ¢å¤æœåŠ¡å™¨ -e "SELECT COUNT(*) FROM database.table"

# å¯¹æ¯”æ•°æ®æ ¡éªŒå’Œ
mysql -håŸå§‹æœåŠ¡å™¨ -e "CHECKSUM TABLE database.table"
mysql -hæ¢å¤æœåŠ¡å™¨ -e "CHECKSUM TABLE database.table"
```

### 3.3 éªŒè¯ç»“æœè§£è¯»


**ğŸ“Š ç»“æœåˆ†æç¤ºä¾‹**ï¼š

```bash
# æ­£å¸¸æƒ…å†µè¾“å‡ºï¼ˆæ— å·®å¼‚ï¼‰
# NOTE: --dry-run mode enabled.
# Syncing h=backup_server,D=test_db,t=users
# Done syncing h=backup_server,D=test_db,t=users

# å‘ç°å·®å¼‚æ—¶çš„è¾“å‡º
REPLACE INTO `test_db`.`users`(`id`, `name`, `email`) VALUES ('101', 'John', 'john@email.com');
DELETE FROM `test_db`.`users` WHERE `id`='102';
```

**ğŸ’¡ ç»“æœå«ä¹‰è§£è¯»**ï¼š
- **æ— è¾“å‡º**ï¼šæ•°æ®å®Œå…¨ä¸€è‡´ï¼Œæ¢å¤æˆåŠŸ
- **REPLACEè¯­å¥**ï¼šæ¢å¤åº“ä¸­è¯¥è®°å½•ä¸åŸåº“ä¸åŒ
- **DELETEè¯­å¥**ï¼šæ¢å¤åº“ä¸­å¤šäº†åŸåº“æ²¡æœ‰çš„è®°å½•
- **INSERTè¯­å¥**ï¼šæ¢å¤åº“ä¸­ç¼ºå°‘åŸåº“çš„è®°å½•

---

## 4. ğŸ›¡ï¸ å¤‡ä»½å®Œæ•´æ€§æµ‹è¯•


### 4.1 å®Œæ•´æ€§æµ‹è¯•ç­–ç•¥


**ğŸ’¡ ä»€ä¹ˆæ˜¯å®Œæ•´æ€§æµ‹è¯•**ï¼š
å°±åƒæ£€æŸ¥ä¸€ä¸ªå‹ç¼©åŒ…æ˜¯å¦å®Œæ•´ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯å¤‡ä»½æ–‡ä»¶æ˜¯å¦åŒ…å«äº†æ‰€æœ‰åº”è¯¥æœ‰çš„æ•°æ®ï¼Œæ²¡æœ‰ç¼ºå¤±æˆ–æŸåã€‚

**ğŸ¯ æµ‹è¯•ç»´åº¦**ï¼š
```
æ•°æ®å®Œæ•´æ€§ï¼šæ‰€æœ‰æ•°æ®è¡Œéƒ½åœ¨
ç»“æ„å®Œæ•´æ€§ï¼šè¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸéƒ½åœ¨  
å…³ç³»å®Œæ•´æ€§ï¼šå¤–é”®å…³ç³»ä¿æŒæ­£ç¡®
ä¸šåŠ¡å®Œæ•´æ€§ï¼šä¸šåŠ¡é€»è¾‘æ•°æ®ä¸€è‡´
```

### 4.2 å®Œæ•´æ€§æµ‹è¯•æ–¹æ³•


**ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•**ï¼š

1ï¸âƒ£ **æ•°æ®é‡æ£€æŸ¥**ï¼š
```bash
# åˆ›å»ºéªŒè¯è„šæœ¬
#!/bin/bash

# å®šä¹‰æ•°æ®åº“ä¿¡æ¯
SOURCE_HOST="192.168.1.10"
BACKUP_HOST="192.168.1.20" 
DATABASE="production_db"

# æ£€æŸ¥å„è¡¨è¡Œæ•°
for table in users orders products payments; do
    echo "æ£€æŸ¥è¡¨: $table"
    
    # æºåº“è¡Œæ•°
    source_count=$(mysql -h$SOURCE_HOST -N -e "SELECT COUNT(*) FROM $DATABASE.$table")
    
    # å¤‡ä»½åº“è¡Œæ•°  
    backup_count=$(mysql -h$BACKUP_HOST -N -e "SELECT COUNT(*) FROM $DATABASE.$table")
    
    echo "æºåº“: $source_count è¡Œ, å¤‡ä»½åº“: $backup_count è¡Œ"
    
    if [ "$source_count" != "$backup_count" ]; then
        echo "âŒ æ•°æ®é‡ä¸ä¸€è‡´!"
    else
        echo "âœ… æ•°æ®é‡ä¸€è‡´"
    fi
done
```

2ï¸âƒ£ **å…³é”®æ•°æ®éªŒè¯**ï¼š
```bash
# éªŒè¯å…³é”®ä¸šåŠ¡æ•°æ®
pt-table-sync --dry-run --print \
  --where="status='active' AND created_date >= CURDATE()" \
  h=æºåº“,D=shop,t=orders \
  h=å¤‡ä»½åº“,D=shop,t=orders
```

### 4.3 è‡ªåŠ¨åŒ–å®Œæ•´æ€§æ£€æŸ¥


**ğŸ¤– è‡ªåŠ¨åŒ–è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# å¤‡ä»½å®Œæ•´æ€§è‡ªåŠ¨æ£€æŸ¥è„šæœ¬

# é…ç½®ä¿¡æ¯
CONFIG_FILE="/etc/backup_verify.conf"
LOG_FILE="/var/log/backup_verify.log"

# è®°å½•æ—¥å¿—å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

# æ‰§è¡Œå®Œæ•´æ€§æ£€æŸ¥
check_table_integrity() {
    local table=$1
    
    log_message "å¼€å§‹æ£€æŸ¥è¡¨: $table"
    
    # æ‰§è¡Œpt-table-syncæ£€æŸ¥
    result=$(pt-table-sync --dry-run --print \
        h=$SOURCE_HOST,D=$DATABASE,t=$table \
        h=$BACKUP_HOST,D=$DATABASE,t=$table 2>&1)
    
    # åˆ¤æ–­ç»“æœ
    if [ -z "$result" ]; then
        log_message "âœ… $table æ•°æ®ä¸€è‡´"
        return 0
    else
        log_message "âŒ $table å‘ç°å·®å¼‚:"
        log_message "$result"
        return 1
    fi
}

# ä¸»ç¨‹åº
main() {
    log_message "å¼€å§‹å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥"
    
    # è¯»å–è¦æ£€æŸ¥çš„è¡¨åˆ—è¡¨
    while read table; do
        check_table_integrity "$table"
    done < table_list.txt
    
    log_message "å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ"
}

main
```

---

## 5. ğŸ“ˆ å¢é‡å¤‡ä»½éªŒè¯æ–¹æ¡ˆ


### 5.1 å¢é‡å¤‡ä»½éªŒè¯åŸç†


**ğŸ’¡ ç†è§£å¢é‡å¤‡ä»½éªŒè¯**ï¼š
å¢é‡å¤‡ä»½å°±åƒè®°å½•æ—¥è®°çš„"å¢é‡"ï¼Œåªè®°å½•ä»Šå¤©æ–°å‘ç”Ÿçš„äº‹æƒ…ã€‚éªŒè¯æ—¶éœ€è¦ç¡®ä¿è¿™äº›"å¢é‡"æ•°æ®æ­£ç¡®åœ°åˆå¹¶åˆ°äº†å¤‡ä»½ä¸­ã€‚

**ğŸ”„ å¢é‡éªŒè¯æµç¨‹**ï¼š
```
å…¨é‡å¤‡ä»½ + å¢é‡1 + å¢é‡2 + å¢é‡3 = å®Œæ•´æ•°æ®
    â†“       â†“       â†“       â†“         â†“
  éªŒè¯åŸºç¡€  éªŒè¯æ–°å¢  éªŒè¯æ›´æ–°  éªŒè¯åˆ é™¤   éªŒè¯å®Œæ•´æ€§
```

### 5.2 å¢é‡å¤‡ä»½éªŒè¯å®ç°


**ğŸ“… æŒ‰æ—¶é—´æ®µéªŒè¯**ï¼š

```bash
# éªŒè¯ç‰¹å®šæ—¶é—´æ®µçš„å¢é‡æ•°æ®
verify_incremental_backup() {
    local start_time=$1
    local end_time=$2
    
    echo "éªŒè¯æ—¶é—´æ®µ: $start_time åˆ° $end_time"
    
    # éªŒè¯æ–°å¢æ•°æ®
    pt-table-sync --dry-run --print \
        --where="created_time BETWEEN '$start_time' AND '$end_time'" \
        h=production,D=app_db,t=user_activity \
        h=backup,D=app_db,t=user_activity
        
    # éªŒè¯ä¿®æ”¹æ•°æ®  
    pt-table-sync --dry-run --print \
        --where="updated_time BETWEEN '$start_time' AND '$end_time'" \
        h=production,D=app_db,t=user_profiles \
        h=backup,D=app_db,t=user_profiles
}

# ä½¿ç”¨ç¤ºä¾‹
verify_incremental_backup "2024-09-11 00:00:00" "2024-09-11 23:59:59"
```

### 5.3 å¢é‡éªŒè¯ç­–ç•¥


**ğŸ“‹ éªŒè¯ç­–ç•¥è¡¨**ï¼š

| éªŒè¯ç±»å‹ | **éªŒè¯æ–¹æ³•** | **éªŒè¯é¢‘ç‡** | **é‡ç‚¹å…³æ³¨** |
|---------|-------------|-------------|-------------|
| å®æ—¶éªŒè¯ | æ¯æ¬¡å¢é‡å â° | ç«‹å³æ‰§è¡Œ | æœ€æ–°æ•°æ® |
| å®šæœŸéªŒè¯ | æ¯æ—¥æ±‡æ€» ğŸ“… | æ¯å¤©ä¸€æ¬¡ | ç´¯ç§¯ä¸€è‡´æ€§ |
| å®Œæ•´éªŒè¯ | å…¨é‡å¯¹æ¯” ğŸ“Š | æ¯å‘¨ä¸€æ¬¡ | æ•´ä½“å®Œæ•´æ€§ |
| æŠ½æ ·éªŒè¯ | éšæœºæ£€æŸ¥ ğŸ² | æ¯å°æ—¶ | æ•°æ®è´¨é‡ |

**ğŸ” éªŒè¯è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# å¢é‡å¤‡ä»½éªŒè¯è„šæœ¬

# è·å–æœ€åä¸€æ¬¡éªŒè¯æ—¶é—´
LAST_VERIFY_TIME=$(cat /var/lib/backup/last_verify_time.txt 2>/dev/null || echo "1970-01-01 00:00:00")
CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S')

echo "éªŒè¯å¢é‡æ•°æ®: $LAST_VERIFY_TIME åˆ° $CURRENT_TIME"

# éªŒè¯ä¸»è¦ä¸šåŠ¡è¡¨
TABLES=("orders" "users" "products" "payments")

for table in "${TABLES[@]}"; do
    echo "æ£€æŸ¥è¡¨: $table"
    
    # éªŒè¯åˆ›å»ºæ—¶é—´åœ¨æ­¤åŒºé—´çš„æ•°æ®
    pt-table-sync --dry-run --print \
        --where="created_at > '$LAST_VERIFY_TIME'" \
        h=prod,D=ecommerce,t=$table \
        h=backup,D=ecommerce,t=$table
        
    # éªŒè¯æ›´æ–°æ—¶é—´åœ¨æ­¤åŒºé—´çš„æ•°æ®
    pt-table-sync --dry-run --print \
        --where="updated_at > '$LAST_VERIFY_TIME'" \
        h=prod,D=ecommerce,t=$table \
        h=backup,D=ecommerce,t=$table
done

# æ›´æ–°éªŒè¯æ—¶é—´æˆ³
echo "$CURRENT_TIME" > /var/lib/backup/last_verify_time.txt
```

---

## 6. ğŸ¤– è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹


### 6.1 è‡ªåŠ¨åŒ–éªŒè¯æ¶æ„


**ğŸ’¡ ç†è§£è‡ªåŠ¨åŒ–éªŒè¯**ï¼š
å°±åƒå·¥å‚çš„è´¨æ£€æµæ°´çº¿ï¼Œæ¯ä¸ªäº§å“éƒ½è¦ç»è¿‡è‡ªåŠ¨åŒ–æ£€æµ‹ï¼Œç¡®ä¿è´¨é‡åˆæ ¼æ‰èƒ½å‡ºå‚ã€‚æ•°æ®å¤‡ä»½ä¹Ÿéœ€è¦è¿™æ ·çš„è‡ªåŠ¨åŒ–è´¨æ£€æµç¨‹ã€‚

**ğŸ—ï¸ è‡ªåŠ¨åŒ–æ¶æ„å›¾**ï¼š
```
å¤‡ä»½ä»»åŠ¡ â†’ éªŒè¯è§¦å‘ â†’ æ‰§è¡Œæ£€æŸ¥ â†’ ç»“æœåˆ†æ â†’ æŠ¥å‘Šé€šçŸ¥
    â†“         â†“         â†“         â†“         â†“
  å®Œæˆä¿¡å·    å¯åŠ¨è„šæœ¬   å¤šç§éªŒè¯   ç»“æœæ±‡æ€»   é‚®ä»¶/çŸ­ä¿¡
```

### 6.2 éªŒè¯æµç¨‹è®¾è®¡


**ğŸ”„ å®Œæ•´éªŒè¯æµç¨‹**ï¼š

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–å¤‡ä»½éªŒè¯ä¸»æµç¨‹

# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_DIR="/etc/backup-verify"
LOG_DIR="/var/log/backup-verify"
REPORT_DIR="/var/reports/backup-verify"

# åˆ›å»ºä»Šæ—¥éªŒè¯æŠ¥å‘Š
REPORT_FILE="$REPORT_DIR/verify_$(date +%Y%m%d_%H%M%S).html"

# åˆå§‹åŒ–éªŒè¯æŠ¥å‘Š
init_report() {
    cat > $REPORT_FILE << EOF
<!DOCTYPE html>
<html>
<head><title>å¤‡ä»½éªŒè¯æŠ¥å‘Š - $(date)</title></head>
<body>
<h1>å¤‡ä»½éªŒè¯æŠ¥å‘Š</h1>
<p>éªŒè¯æ—¶é—´: $(date)</p>
<table border="1">
<tr><th>è¡¨å</th><th>çŠ¶æ€</th><th>å·®å¼‚æ•°é‡</th><th>è¯¦ç»†ä¿¡æ¯</th></tr>
EOF
}

# æ‰§è¡Œè¡¨éªŒè¯
verify_table() {
    local database=$1
    local table=$2
    local result_file="/tmp/verify_${table}_$$.log"
    
    # æ‰§è¡ŒéªŒè¯
    pt-table-sync --dry-run --print \
        h=$SOURCE_HOST,D=$database,t=$table \
        h=$BACKUP_HOST,D=$database,t=$table \
        > $result_file 2>&1
    
    # åˆ†æç»“æœ
    if [ -s $result_file ]; then
        # æœ‰å·®å¼‚
        diff_count=$(wc -l < $result_file)
        echo "<tr><td>$table</td><td style='color:red'>å¼‚å¸¸</td><td>$diff_count</td><td>å‘ç°å·®å¼‚</td></tr>" >> $REPORT_FILE
        return 1
    else
        # æ— å·®å¼‚
        echo "<tr><td>$table</td><td style='color:green'>æ­£å¸¸</td><td>0</td><td>æ•°æ®ä¸€è‡´</td></tr>" >> $REPORT_FILE
        return 0
    fi
}

# ä¸»éªŒè¯ç¨‹åº
main() {
    init_report
    
    local total_tables=0
    local failed_tables=0
    
    # è¯»å–è¡¨åˆ—è¡¨å¹¶éªŒè¯
    while IFS=',' read -r database table; do
        total_tables=$((total_tables + 1))
        
        if ! verify_table "$database" "$table"; then
            failed_tables=$((failed_tables + 1))
        fi
    done < "$CONFIG_DIR/table_list.csv"
    
    # å®ŒæˆæŠ¥å‘Š
    cat >> $REPORT_FILE << EOF
</table>
<h2>éªŒè¯æ±‡æ€»</h2>
<p>æ€»è¡¨æ•°: $total_tables</p>
<p>å¤±è´¥è¡¨æ•°: $failed_tables</p>
<p>æˆåŠŸç‡: $(( (total_tables - failed_tables) * 100 / total_tables ))%</p>
</body>
</html>
EOF
    
    # å‘é€æŠ¥å‘Š
    send_report "$REPORT_FILE" "$failed_tables"
}
```

### 6.3 å®šæ—¶ä»»åŠ¡é›†æˆ


**â° Cronä»»åŠ¡é…ç½®**ï¼š

```bash
# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå®Œæ•´éªŒè¯
0 2 * * * /opt/scripts/backup_verify_full.sh

# æ¯4å°æ—¶æ‰§è¡Œå¢é‡éªŒè¯  
0 */4 * * * /opt/scripts/backup_verify_incremental.sh

# æ¯å°æ—¶æ‰§è¡Œå…³é”®è¡¨éªŒè¯
0 * * * * /opt/scripts/backup_verify_critical.sh
```

**ğŸ“§ ç»“æœé€šçŸ¥é…ç½®**ï¼š

```bash
# å‘é€éªŒè¯æŠ¥å‘Šå‡½æ•°
send_report() {
    local report_file=$1
    local failed_count=$2
    
    # æ ¹æ®å¤±è´¥æ•°é‡é€‰æ‹©é€šçŸ¥æ–¹å¼
    if [ $failed_count -eq 0 ]; then
        # éªŒè¯æˆåŠŸï¼Œå‘é€ç®€å•é€šçŸ¥
        echo "å¤‡ä»½éªŒè¯æˆåŠŸ - $(date)" | \
        mail -s "âœ… å¤‡ä»½éªŒè¯æˆåŠŸ" admin@company.com
    else
        # éªŒè¯å¤±è´¥ï¼Œå‘é€è¯¦ç»†æŠ¥å‘Š
        mail -s "âŒ å¤‡ä»½éªŒè¯å‘ç°é—®é¢˜" \
             -a $report_file \
             admin@company.com < /dev/null
             
        # å‘é€ç´§æ€¥é€šçŸ¥
        curl -X POST "https://api.sms.com/send" \
             -d "message=å¤‡ä»½éªŒè¯å¤±è´¥ï¼Œå‘ç°${failed_count}ä¸ªè¡¨å­˜åœ¨å·®å¼‚" \
             -d "phone=13800138000"
    fi
}
```

---

## 7. ğŸ“Š ç›‘æ§ä¸ä¼˜åŒ–ç­–ç•¥


### 7.1 éªŒè¯æ€§èƒ½ç›‘æ§


**ğŸ’¡ ä¸ºä»€ä¹ˆè¦ç›‘æ§éªŒè¯æ€§èƒ½**ï¼š
éªŒè¯å·¥ä½œæœ¬èº«ä¹Ÿä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œæˆ‘ä»¬éœ€è¦ç›‘æ§éªŒè¯è¿‡ç¨‹ï¼Œç¡®ä¿å®ƒä¸ä¼šå½±å“æ­£å¸¸ä¸šåŠ¡ï¼ŒåŒæ—¶ä¼˜åŒ–éªŒè¯æ•ˆç‡ã€‚

**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```bash
# éªŒè¯æ€§èƒ½ç›‘æ§è„šæœ¬
#!/bin/bash

monitor_verification() {
    local start_time=$(date +%s)
    local table=$1
    
    echo "å¼€å§‹ç›‘æ§è¡¨ $table çš„éªŒè¯è¿‡ç¨‹"
    
    # è·å–ç³»ç»Ÿè´Ÿè½½
    load_before=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}')
    
    # è·å–å†…å­˜ä½¿ç”¨
    memory_before=$(free -m | awk 'NR==2{printf "%.2f", $3*100/$2}')
    
    # æ‰§è¡ŒéªŒè¯ï¼ˆåå°è¿è¡Œå¹¶è·å–PIDï¼‰
    pt-table-sync --dry-run --print \
        --chunk-size=1000 \
        h=source,D=db,t=$table \
        h=backup,D=db,t=$table &
    
    local verify_pid=$!
    
    # ç›‘æ§éªŒè¯è¿‡ç¨‹
    while kill -0 $verify_pid 2>/dev/null; do
        # ç›‘æ§CPUå’Œå†…å­˜ä½¿ç”¨
        ps -p $verify_pid -o pid,pcpu,pmem,time
        sleep 10
    done
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    echo "è¡¨ $table éªŒè¯å®Œæˆï¼Œè€—æ—¶: ${duration}ç§’"
}
```

### 7.2 éªŒè¯ç­–ç•¥ä¼˜åŒ–


**âš–ï¸ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

| ä¼˜åŒ–æ–¹å‘ | **ä¼˜åŒ–æ–¹æ³•** | **é€‚ç”¨åœºæ™¯** | **æ•ˆæœ** |
|---------|-------------|-------------|---------|
| åˆ†å—å¤§å° | è°ƒæ•´chunk-size ğŸ“Š | å¤§è¡¨éªŒè¯ | å¹³è¡¡é€Ÿåº¦ä¸èµ„æº |
| å¹¶è¡ŒéªŒè¯ | å¤šè¡¨åŒæ—¶éªŒè¯ âš¡ | å¤šè¡¨åœºæ™¯ | æå‡æ•´ä½“æ•ˆç‡ |
| æ—¶é—´æ§åˆ¶ | è®¾ç½®æ—¶é—´çª—å£ â° | ä¸šåŠ¡é«˜å³° | é¿å…å½±å“ä¸šåŠ¡ |
| èµ„æºé™åˆ¶ | é™åˆ¶CPU/å†…å­˜ ğŸ”§ | å…±äº«æœåŠ¡å™¨ | ä¿æŠ¤ç³»ç»Ÿç¨³å®š |

**ğŸ”§ ä¼˜åŒ–é…ç½®ç¤ºä¾‹**ï¼š

```bash
# å¤§è¡¨ä¼˜åŒ–é…ç½®
verify_large_table() {
    pt-table-sync --dry-run --print \
        --chunk-size=500 \        # å°å—å¤„ç†
        --chunk-time=0.5 \        # é™åˆ¶å¤„ç†æ—¶é—´
        --max-lag=5 \             # æ§åˆ¶ä¸»ä»å»¶è¿Ÿ
        --quiet \                 # å‡å°‘è¾“å‡º
        h=source,D=big_db,t=large_table \
        h=backup,D=big_db,t=large_table
}

# å¤šè¡¨å¹¶è¡ŒéªŒè¯
parallel_verify() {
    # å®šä¹‰è¡¨åˆ—è¡¨
    tables=("users" "orders" "products" "logs")
    
    # å¹¶è¡Œæ‰§è¡ŒéªŒè¯
    for table in "${tables[@]}"; do
        verify_table "$table" &
    done
    
    # ç­‰å¾…æ‰€æœ‰éªŒè¯å®Œæˆ
    wait
    echo "æ‰€æœ‰è¡¨éªŒè¯å®Œæˆ"
}
```

### 7.3 è´¨é‡è¯„ä¼°ä½“ç³»


**ğŸ“‹ å¤‡ä»½è´¨é‡è¯„ä¼°æ¡†æ¶**ï¼š

```bash
#!/bin/bash
# å¤‡ä»½è´¨é‡è¯„ä¼°è„šæœ¬

calculate_backup_quality() {
    local total_tables=0
    local consistent_tables=0
    local total_rows=0
    local consistent_rows=0
    
    # é€è¡¨è¯„ä¼°
    while read table; do
        total_tables=$((total_tables + 1))
        
        # è·å–è¡¨è¡Œæ•°
        table_rows=$(mysql -N -e "SELECT COUNT(*) FROM app_db.$table")
        total_rows=$((total_rows + table_rows))
        
        # éªŒè¯ä¸€è‡´æ€§
        result=$(pt-table-sync --dry-run --print \
                h=source,D=app_db,t=$table \
                h=backup,D=app_db,t=$table)
        
        if [ -z "$result" ]; then
            consistent_tables=$((consistent_tables + 1))
            consistent_rows=$((consistent_rows + table_rows))
        fi
        
    done < table_list.txt
    
    # è®¡ç®—è´¨é‡æŒ‡æ ‡
    local table_consistency=$((consistent_tables * 100 / total_tables))
    local row_consistency=$((consistent_rows * 100 / total_rows))
    
    # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
    cat << EOF
ğŸ“Š å¤‡ä»½è´¨é‡è¯„ä¼°æŠ¥å‘Š
================================
è¡¨çº§ä¸€è‡´æ€§: ${table_consistency}%
è¡Œçº§ä¸€è‡´æ€§: ${row_consistency}%
æ€»è¡¨æ•°é‡: ${total_tables}
ä¸€è‡´è¡¨æ•°: ${consistent_tables}
æ€»è¡Œæ•°é‡: ${total_rows}
ä¸€è‡´è¡Œæ•°: ${consistent_rows}

è´¨é‡ç­‰çº§: $(get_quality_grade $table_consistency)
EOF
}

# è´¨é‡ç­‰çº§è¯„å®š
get_quality_grade() {
    local score=$1
    if [ $score -ge 95 ]; then
        echo "ğŸ¥‡ ä¼˜ç§€"
    elif [ $score -ge 90 ]; then
        echo "ğŸ¥ˆ è‰¯å¥½"  
    elif [ $score -ge 80 ]; then
        echo "ğŸ¥‰ åˆæ ¼"
    else
        echo "âŒ éœ€è¦æ”¹è¿›"
    fi
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ pt-table-syncæœ¬è´¨ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å’ŒåŒæ­¥å·¥å…·
ğŸ”¸ å¤‡ä»½éªŒè¯ç›®çš„ï¼šç¡®ä¿å¤‡ä»½æ•°æ®å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
ğŸ”¸ éªŒè¯ç»´åº¦ï¼šæ•°æ®å†…å®¹ã€è¡¨ç»“æ„ã€ä¸šåŠ¡é€»è¾‘ã€æ—¶é—´ä¸€è‡´æ€§
ğŸ”¸ è‡ªåŠ¨åŒ–ä»·å€¼ï¼šæé«˜éªŒè¯æ•ˆç‡ï¼Œå‡å°‘äººå·¥é”™è¯¯
ğŸ”¸ ç›‘æ§é‡è¦æ€§ï¼šç¡®ä¿éªŒè¯è¿‡ç¨‹ä¸å½±å“æ­£å¸¸ä¸šåŠ¡
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½éªŒè¯**
```
æ•°æ®å®‰å…¨ï¼šå¤‡ä»½æ˜¯æœ€åä¸€é“é˜²çº¿
ä¸šåŠ¡è¿ç»­æ€§ï¼šæ•…éšœæ—¶éœ€è¦å¿«é€Ÿæ¢å¤
åˆè§„è¦æ±‚ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„
é£é™©æ§åˆ¶ï¼šæå‰å‘ç°å¤‡ä»½é—®é¢˜
```

**ğŸ”¹ éªŒè¯ç­–ç•¥é€‰æ‹©**
```
å…¨é‡éªŒè¯ï¼šé€‚åˆé‡è¦æ•°æ®ï¼ŒéªŒè¯å®Œæ•´
å¢é‡éªŒè¯ï¼šé€‚åˆæ—¥å¸¸æ£€æŸ¥ï¼Œæ•ˆç‡é«˜
æŠ½æ ·éªŒè¯ï¼šé€‚åˆå¤§æ•°æ®é‡ï¼Œæˆæœ¬ä½
å®æ—¶éªŒè¯ï¼šé€‚åˆå…³é”®ä¸šåŠ¡ï¼Œæ—¶æ•ˆæ€§å¼º
```

**ğŸ”¹ è‡ªåŠ¨åŒ–çš„ä»·å€¼**
```
ä¸€è‡´æ€§ï¼šé¿å…äººå·¥æ“ä½œå·®å¼‚
åŠæ—¶æ€§ï¼šè‡ªåŠ¨è§¦å‘ï¼Œå¿«é€Ÿå‘ç°é—®é¢˜  
å¯é æ€§ï¼šå‡å°‘é—æ¼ï¼Œæé«˜è¦†ç›–ç‡
æ•ˆç‡æ€§ï¼šèŠ‚çœäººåŠ›ï¼Œæå‡æ•ˆç‡
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**â­ æœ¬èŠ‚æ ¸å¿ƒè¦ç‚¹**
- å¤‡ä»½éªŒè¯æ˜¯æ•°æ®å®‰å…¨çš„é‡è¦ç¯èŠ‚
- pt-table-syncæä¾›äº†å¼ºå¤§çš„ä¸€è‡´æ€§æ£€æŸ¥èƒ½åŠ›
- è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹èƒ½å¤Ÿæé«˜æ•ˆç‡å’Œå¯é æ€§
- æ€§èƒ½ç›‘æ§ç¡®ä¿éªŒè¯è¿‡ç¨‹ä¸å½±å“ä¸šåŠ¡
- è´¨é‡è¯„ä¼°ä½“ç³»å¸®åŠ©æŒç»­æ”¹è¿›å¤‡ä»½ç­–ç•¥

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
ğŸ”¸ éªŒè¯ç­–ç•¥ï¼šç»“åˆå…¨é‡ã€å¢é‡ã€æŠ½æ ·å¤šç§æ–¹å¼
ğŸ”¸ å®‰å…¨åŸåˆ™ï¼šå§‹ç»ˆä½¿ç”¨--dry-runè¿›è¡ŒéªŒè¯
ğŸ”¸ æ€§èƒ½æ§åˆ¶ï¼šåˆç†è®¾ç½®chunk-sizeå’Œæ—¶é—´é™åˆ¶
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå»ºç«‹å®Œå–„çš„é€šçŸ¥å’ŒæŠ¥å‘Šæœºåˆ¶
ğŸ”¸ å®šæœŸè¯„ä¼°ï¼šæŒç»­ä¼˜åŒ–éªŒè¯ç­–ç•¥å’Œå·¥å…·é…ç½®
```

**ğŸ¯ å­¦ä¹ æ£€éªŒ**
```
âœ… ç†è§£pt-table-syncçš„å·¥ä½œåŸç†å’Œä½¿ç”¨æ–¹æ³•
âœ… æŒæ¡ä¸åŒåœºæ™¯ä¸‹çš„éªŒè¯ç­–ç•¥é€‰æ‹©
âœ… èƒ½å¤Ÿè®¾è®¡å’Œå®ç°è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹
âœ… äº†è§£éªŒè¯æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§æ–¹æ³•
âœ… å…·å¤‡å¤‡ä»½è´¨é‡è¯„ä¼°å’Œæ”¹è¿›èƒ½åŠ›
```

**ğŸ”— ç›¸å…³çŸ¥è¯†é“¾æ¥**
- å‰ç½®çŸ¥è¯†ï¼šMySQLå¤‡ä»½ç­–ç•¥ã€æ•°æ®åº“å¤åˆ¶åŸç†
- ç›¸å…³å·¥å…·ï¼špt-table-checksumã€mysqldumpã€mysqlbinlog
- åç»­å­¦ä¹ ï¼šç¾å¤‡åˆ‡æ¢ã€æ•°æ®æ¢å¤æ¼”ç»ƒã€é«˜å¯ç”¨æ¶æ„