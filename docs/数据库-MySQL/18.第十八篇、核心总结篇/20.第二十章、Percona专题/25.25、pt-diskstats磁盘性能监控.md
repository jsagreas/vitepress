---
title: 25、pt-diskstats磁盘性能监控
---
## 📚 目录

1. [pt-diskstats基础概念](#1-pt-diskstats基础概念)
2. [监控原理与工作机制](#2-监控原理与工作机制)
3. [磁盘IO统计分析](#3-磁盘IO统计分析)
4. [性能瓶颈识别方法](#4-性能瓶颈识别方法)
5. [IOPS与延迟监控](#5-IOPS与延迟监控)
6. [实用监控配置](#6-实用监控配置)
7. [性能趋势分析](#7-性能趋势分析)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 pt-diskstats基础概念


### 1.1 什么是pt-diskstats


**简单理解**：`pt-diskstats`就像是给你的硬盘装了一个"体检仪"，随时监控磁盘的健康状况。

```
类比理解：
就像医生用听诊器检查心跳一样
pt-diskstats = 磁盘的听诊器
能听出磁盘是否"心跳"正常
```

**🔸 核心功能**
- **实时监控**：持续观察磁盘的工作状态
- **性能分析**：告诉你磁盘快不快、忙不忙
- **瓶颈发现**：找出影响数据库性能的磁盘问题
- **趋势跟踪**：记录磁盘性能的变化趋势

### 1.2 为什么需要磁盘监控


**💡 实际场景理解**
```
想象你在使用电脑时：
- 打开文件很慢 → 可能是磁盘读取慢
- 保存文件卡顿 → 可能是磁盘写入慢
- 系统响应慢 → 可能是磁盘忙不过来

对于MySQL数据库也是一样的道理！
```

**🔹 监控价值**
- **提前预警**：磁盘问题还没影响用户时就发现
- **定位问题**：快速找到性能瓶颈的真正原因
- **优化指导**：为硬件升级和配置调优提供依据

### 1.3 pt-diskstats的特点


| 特点 | **说明** | **实际好处** |
|------|----------|-------------|
| 🔄 **持续监控** | `不间断地收集磁盘数据` | `24小时掌握磁盘状态` |
| 📊 **详细统计** | `提供丰富的性能指标` | `全面了解磁盘性能` |
| 🎯 **易于理解** | `数据展示直观清晰` | `运维人员容易上手` |
| ⚡ **轻量级** | `监控本身不占用太多资源` | `不影响生产环境性能` |

---

## 2. ⚙️ 监控原理与工作机制


### 2.1 数据来源原理


**🔸 Linux系统的磁盘统计**
```
pt-diskstats从哪里获取数据？
主要来源：/proc/diskstats 文件

这个文件就像是Linux系统的"磁盘账本"
记录着每个磁盘的所有活动
```

**📋 /proc/diskstats文件内容示例**
```bash
# 查看原始磁盘统计数据
cat /proc/diskstats

# 输出示例：
#   8       0 sda 2000 50 40000 1000 1500 30 24000 800 0 1200 1800
#   |       |  |   |    |   |     |    |    |   |     |   | |    |
#   主设备号 次设备号 设备名 读次数 读扇区数... 写次数 写扇区数...
```

### 2.2 工作流程机制


```
pt-diskstats工作流程：
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 读取系统数据  │ -> │ 计算性能指标  │ -> │ 格式化输出    │
│ /proc/diskstats│    │ IOPS/延迟等   │    │ 易读的报告    │
└──────────────┘    └──────────────┘    └──────────────┘
       ↓                     ↓                     ↓
   定期采样             统计分析             实时显示
  (如每5秒)           (计算平均值)          (终端输出)
```

### 2.3 监控指标计算


**🔢 关键指标的计算方法**

**IOPS (每秒IO操作数)**
```
IOPS = (当前读次数 + 当前写次数 - 上次读次数 - 上次写次数) / 时间间隔

通俗理解：
就像数汽车通过收费站的数量
IOPS越高 = 磁盘处理的请求越多
```

**延迟时间**
```
平均延迟 = 总IO时间 / IO次数

通俗理解：
就像排队等待的平均时间
延迟越低 = 磁盘响应越快
```

---

## 3. 📊 磁盘IO统计分析


### 3.1 基本使用方法


**🔧 简单使用示例**
```bash
# 最基本的使用方法
pt-diskstats

# 指定监控间隔（每5秒显示一次）
pt-diskstats --interval=5

# 监控特定设备
pt-diskstats --devices-regex='sda|sdb'
```

### 3.2 输出解读


**📈 典型输出示例**
```
#ts device    rd_s rd_avkb rd_mb_s rd_max rd_rt wr_s wr_avkb wr_mb_s wr_max wr_rt busy in_prg io_s
10:30:01 sda     12    8.0     0.1     20   15   45   16.0     0.7     50   25   15     0   57
```

**🔸 各列含义通俗解释**

| 列名 | **含义** | **通俗理解** |
|------|----------|-------------|
| `rd_s` | **每秒读操作数** | `磁盘每秒读了几次文件` |
| `rd_avkb` | **平均读取大小(KB)** | `每次读操作的平均文件大小` |
| `rd_mb_s` | **每秒读取MB数** | `磁盘每秒读了多少MB数据` |
| `rd_rt` | **读操作响应时间(ms)** | `读一次文件平均要等多久` |
| `wr_s` | **每秒写操作数** | `磁盘每秒写了几次文件` |
| `wr_mb_s` | **每秒写入MB数** | `磁盘每秒写了多少MB数据` |
| `busy` | **磁盘忙碌百分比** | `磁盘有多少时间在干活` |

### 3.3 关键指标分析


**⭐ 重点关注的指标**

**磁盘忙碌度 (busy)**
```
busy值含义：
• 0-30%   → 磁盘很闲，性能充足
• 30-70%  → 磁盘适中，正常工作
• 70-90%  → 磁盘较忙，需要关注
• 90%以上 → 磁盘过载，性能瓶颈

实际意义：
就像看CPU使用率一样
busy越高说明磁盘越忙
```

**IOPS性能评估**
```
不同存储的IOPS参考值：
• 传统HDD：    100-200 IOPS
• SATA SSD：   10,000-50,000 IOPS  
• NVMe SSD：   100,000-500,000 IOPS

如果监控显示的IOPS接近硬件极限
说明磁盘可能成为瓶颈
```

---

## 4. 🔍 性能瓶颈识别方法


### 4.1 瓶颈判断标准


**🚨 性能警告信号**

> **⚠️ 当出现以下情况时，需要重点关注：**
> - 磁盘busy率持续超过80%
> - 读写延迟超过20ms
> - IOPS接近硬件理论上限
> - 队列深度(in_prg)经常大于1

### 4.2 瓶颈分析方法


**📋 分析步骤**

```
步骤1：观察总体趋势
→ 使用pt-diskstats持续监控15-30分钟
→ 记录busy、IOPS、延迟的变化

步骤2：识别高峰时段
→ 找出哪个时间段磁盘最忙
→ 对应检查数据库的操作日志

步骤3：区分读写瓶颈
→ 对比rd_s和wr_s的数值
→ 判断是读多还是写多导致的问题
```

**🔧 实用监控命令**
```bash
# 监控5分钟，每10秒输出一次
pt-diskstats --interval=10 --run-time=300

# 只关注最繁忙的磁盘
pt-diskstats --group-by=sample --show-timestamps
```

### 4.3 常见瓶颈场景


**📝 典型场景分析**

| 场景 | **表现特征** | **可能原因** | **解决思路** |
|------|-------------|-------------|-------------|
| 🔄 **读瓶颈** | `rd_s高，rd_rt大` | `查询太多，索引不足` | `优化查询，添加索引` |
| 💾 **写瓶颈** | `wr_s高，wr_rt大` | `大量写入，日志频繁` | `批量写入，优化事务` |
| ⏱️ **延迟高** | `rt值持续>20ms` | `磁盘老化，IO竞争` | `升级硬件，分散IO` |
| 📈 **IOPS满** | `io_s接近硬件上限` | `并发过高，小IO多` | `增加磁盘，优化并发` |

---

## 5. ⚡ IOPS与延迟监控


### 5.1 IOPS监控重点


**🎯 IOPS监控策略**

**监控目标设置**
```
根据硬件类型设置合理的IOPS预期：

HDD硬盘：
• 正常：50-150 IOPS
• 警告：>150 IOPS
• 危险：>200 IOPS

SSD硬盘：
• 正常：1000-5000 IOPS
• 警告：>8000 IOPS  
• 危险：>15000 IOPS
```

**🔧 IOPS优化监控脚本**
```bash
#!/bin/bash
# 监控IOPS并设置告警
pt-diskstats --interval=5 | while read line; do
    iops=$(echo $line | awk '{print $13}')
    if [ "$iops" -gt 1000 ]; then
        echo "警告：IOPS过高 - $iops" | logger
    fi
done
```

### 5.2 延迟分析技巧


**⏱️ 延迟监控重点**

**延迟标准参考**
```
理想延迟标准：
• HDD：        <10ms (正常)    >20ms (需优化)
• SATA SSD：   <1ms (正常)     >5ms (需优化)  
• NVMe SSD：   <0.1ms (正常)   >1ms (需优化)

实际意义：
延迟直接影响用户体验
数据库查询的响应时间
```

**📊 延迟趋势分析**
```bash
# 统计平均延迟趋势
pt-diskstats --interval=10 --run-time=600 | \
awk '{sum+=$6; count++} END {print "平均读延迟:", sum/count "ms"}'
```

### 5.3 存储性能基准


**📏 性能基准建立**

**基准测试方法**
```
1. 建立基线
   → 在系统空闲时运行pt-diskstats
   → 记录正常情况下的各项指标

2. 压力测试
   → 模拟高负载情况
   → 观察各指标的变化

3. 制定阈值
   → 根据基线和压力测试结果
   → 设置合理的告警阈值
```

---

## 6. 🔧 实用监控配置


### 6.1 告警阈值配置


**⚠️ 实用告警配置**

```bash
# 创建监控脚本 diskstats_monitor.sh
#!/bin/bash

# 设置告警阈值
BUSY_THRESHOLD=80      # 磁盘忙碌度阈值
LATENCY_THRESHOLD=20   # 延迟阈值(ms)
IOPS_THRESHOLD=1000    # IOPS阈值

pt-diskstats --interval=30 | while read timestamp device rd_s rd_avkb rd_mb_s rd_max rd_rt wr_s wr_avkb wr_mb_s wr_max wr_rt busy in_prg io_s; do
    # 跳过表头
    if [[ "$timestamp" =~ ^[0-9] ]]; then
        # 检查磁盘忙碌度
        if (( $(echo "$busy > $BUSY_THRESHOLD" | bc -l) )); then
            echo "告警：磁盘 $device 忙碌度过高 - $busy%"
        fi
        
        # 检查延迟
        if (( $(echo "$rd_rt > $LATENCY_THRESHOLD" | bc -l) )); then
            echo "告警：磁盘 $device 读延迟过高 - ${rd_rt}ms"
        fi
    fi
done
```

### 6.2 监控数据存储


**📁 数据持久化配置**

```bash
# 将监控数据保存到文件
pt-diskstats --interval=60 --run-time=86400 > /var/log/diskstats_$(date +%Y%m%d).log

# 定期清理老日志（保留30天）
find /var/log/ -name "diskstats_*.log" -mtime +30 -delete
```

**🔄 自动化监控部署**
```bash
# 添加到crontab，每天自动启动监控
# 每天0点启动新的监控
0 0 * * * /path/to/diskstats_monitor.sh &

# 每小时检查监控进程是否正常
0 * * * * pgrep -f "pt-diskstats" || /path/to/diskstats_monitor.sh &
```

### 6.3 集成到监控系统


**📈 与Zabbix集成示例**
```bash
# 创建Zabbix监控项
# 1. 磁盘忙碌度
pt-diskstats --interval=60 --iterations=1 | tail -1 | awk '{print $12}'

# 2. IOPS监控  
pt-diskstats --interval=60 --iterations=1 | tail -1 | awk '{print $13}'

# 3. 平均延迟
pt-diskstats --interval=60 --iterations=1 | tail -1 | awk '{print ($5+$11)/2}'
```

---

## 7. 📈 性能趋势分析


### 7.1 趋势数据收集


**📊 长期趋势监控**

```bash
# 创建趋势分析脚本
#!/bin/bash
LOG_FILE="/var/log/diskstats_trend.log"

while true; do
    # 收集关键指标
    pt-diskstats --interval=300 --iterations=1 | tail -1 | \
    awk -v date="$(date '+%Y-%m-%d %H:%M:%S')" \
    '{printf "%s,%s,%.2f,%.2f,%.2f,%d\n", date, $2, $12, ($5+$11)/2, $8+$3, $13}' \
    >> $LOG_FILE
    
    sleep 300  # 每5分钟记录一次
done &
```

### 7.2 趋势分析方法


**🔍 数据分析技巧**

**日趋势分析**
```bash
# 分析一天内的磁盘忙碌度变化
grep "$(date +%Y-%m-%d)" /var/log/diskstats_trend.log | \
awk -F',' '{print $2, $3}' | \
sort | uniq -c | sort -nr
```

**周期性模式识别**
```bash
# 找出一周内的高峰时段
for day in {1..7}; do
    date_str=$(date -d "$day days ago" +%Y-%m-%d)
    echo "=== $date_str ==="
    grep "$date_str" /var/log/diskstats_trend.log | \
    awk -F',' '$3 > 80 {print $1}' | \
    cut -d' ' -f2 | sort | uniq -c
done
```

### 7.3 性能预测


**🔮 容量规划指导**

> **💡 趋势分析的实际价值**
> - **容量规划**：预测何时需要升级硬件
> - **优化指导**：找出性能优化的最佳时机  
> - **故障预防**：提前发现性能下降趋势

**预测模型示例**
```
基于历史数据的简单预测：

如果IOPS增长趋势：每月增长10%
当前IOPS：1000
硬件上限：5000
预计达到80%上限时间：约8个月

提前准备硬件升级计划！
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


**🔸 基础理解**
```
pt-diskstats = 磁盘性能监控工具
主要监控：IOPS、延迟、忙碌度、吞吐量
数据来源：Linux /proc/diskstats文件
应用场景：数据库性能优化、硬件规划
```

### 8.2 关键监控指标


| 指标类型 | **重点关注** | **正常范围** | **告警阈值** |
|---------|-------------|-------------|-------------|
| 🔄 **IOPS** | `每秒IO操作数` | `<硬件上限70%` | `>硬件上限80%` |
| ⏱️ **延迟** | `响应时间` | `HDD<10ms,SSD<1ms` | `HDD>20ms,SSD>5ms` |
| 📊 **忙碌度** | `磁盘利用率` | `<70%` | `>80%` |
| 📈 **吞吐量** | `数据传输速率` | `根据应用需求` | `接近带宽上限` |

### 8.3 实用操作要点


**🎯 日常监控建议**

```
监控频率建议：
• 实时监控：每5-10秒
• 趋势分析：每5分钟
• 告警检查：每30秒
• 历史统计：每小时
```

**🔧 优化指导原则**
- **读瓶颈**：优化查询，增加索引，考虑读写分离
- **写瓶颈**：批量操作，优化事务，使用SSD
- **延迟高**：检查硬件健康，减少IO竞争
- **IOPS满**：分散负载，升级到更快的存储

### 8.4 最佳实践建议


> **⭐ 核心记忆要点**
> - pt-diskstats帮你监控磁盘"健康状况"
> - 重点看busy、IOPS、延迟三个指标  
> - 超过阈值要及时优化或升级硬件
> - 结合MySQL慢查询日志分析更准确

**🚀 进阶应用方向**
- 结合其他Percona工具进行综合分析
- 集成到自动化运维平台
- 建立基于趋势的预警机制
- 制定基于数据的硬件升级策略

**核心价值**：通过pt-diskstats，你可以像医生一样为数据库的"心脏"（存储系统）做定期体检，确保数据库始终保持最佳性能状态！