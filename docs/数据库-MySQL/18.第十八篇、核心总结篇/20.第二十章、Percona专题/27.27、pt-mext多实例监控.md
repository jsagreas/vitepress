---
title: 27ã€pt-mextå¤šå®ä¾‹ç›‘æ§
---
## ğŸ“š ç›®å½•

1. [pt-mextå·¥å…·æ¦‚è¿°](#1-pt-mextå·¥å…·æ¦‚è¿°)
2. [å¤šå®ä¾‹ç›‘æ§æ ¸å¿ƒæ¦‚å¿µ](#2-å¤šå®ä¾‹ç›‘æ§æ ¸å¿ƒæ¦‚å¿µ)
3. [çŠ¶æ€å˜é‡å¯¹æ¯”ä¸åˆ†æ](#3-çŠ¶æ€å˜é‡å¯¹æ¯”ä¸åˆ†æ)
4. [æ€§èƒ½æŒ‡æ ‡èšåˆæœºåˆ¶](#4-æ€§èƒ½æŒ‡æ ‡èšåˆæœºåˆ¶)
5. [å®ä¾‹é—´æ€§èƒ½å¯¹æ¯”](#5-å®ä¾‹é—´æ€§èƒ½å¯¹æ¯”)
6. [ç›‘æ§æ•°æ®æ ¼å¼åŒ–](#6-ç›‘æ§æ•°æ®æ ¼å¼åŒ–)
7. [è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡](#7-è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡)
8. [ç›‘æ§è„šæœ¬é›†æˆ](#8-ç›‘æ§è„šæœ¬é›†æˆ)
9. [æ€§èƒ½è¶‹åŠ¿åˆ†æ](#9-æ€§èƒ½è¶‹åŠ¿åˆ†æ)
10. [å¼‚å¸¸æ£€æµ‹æœºåˆ¶](#10-å¼‚å¸¸æ£€æµ‹æœºåˆ¶)
11. [ç›‘æ§æ•°æ®å¯¼å‡º](#11-ç›‘æ§æ•°æ®å¯¼å‡º)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ pt-mextå·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pt-mext


**ç®€å•ç†è§£**ï¼špt-mextå°±åƒæ˜¯MySQLçš„"å¤šå±ç›‘è§†å™¨"ï¼Œèƒ½åŒæ—¶ç›‘æ§å¤šä¸ªMySQLå®ä¾‹ï¼ŒæŠŠå®ƒä»¬çš„çŠ¶æ€å˜åŒ–æ”¾åœ¨ä¸€èµ·å¯¹æ¯”åˆ†æã€‚

```
ä¼ ç»Ÿç›‘æ§æ–¹å¼ï¼š
MySQLå®ä¾‹1 â†’ å•ç‹¬æŸ¥çœ‹çŠ¶æ€
MySQLå®ä¾‹2 â†’ å•ç‹¬æŸ¥çœ‹çŠ¶æ€  
MySQLå®ä¾‹3 â†’ å•ç‹¬æŸ¥çœ‹çŠ¶æ€
é—®é¢˜ï¼šæ— æ³•ç›´æ¥å¯¹æ¯”ï¼Œå‘ç°é—®é¢˜å›°éš¾

pt-mextç›‘æ§æ–¹å¼ï¼š
å®ä¾‹1 | å®ä¾‹2 | å®ä¾‹3
-----|------|------
QPS  |  QPS |  QPS
TPS  |  TPS |  TPS
è¿æ¥ |  è¿æ¥ |  è¿æ¥
ä¸€ç›®äº†ç„¶çš„å¯¹æ¯”ï¼
```

### 1.2 pt-mextçš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ ä¸»è¦åŠŸèƒ½**ï¼š
- **å¤šå®ä¾‹åŒæ—¶ç›‘æ§**ï¼šä¸€ä¸ªç•Œé¢çœ‹æ‰€æœ‰MySQLå®ä¾‹
- **çŠ¶æ€å˜é‡å¯¹æ¯”**ï¼šç›´è§‚å¯¹æ¯”å„å®ä¾‹æ€§èƒ½æŒ‡æ ‡
- **å·®å€¼è®¡ç®—**ï¼šè‡ªåŠ¨è®¡ç®—å˜åŒ–é‡ï¼Œä¸ç”¨æ‰‹å·¥ç®—
- **æ ¼å¼åŒ–è¾“å‡º**ï¼šæ•°æ®æ’åˆ—æ•´é½ï¼Œä¾¿äºé˜…è¯»

â”Œâ”€ æ ¸å¿ƒä»·å€¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°±åƒåŒæ—¶çœ‹å¤šä¸ªä»ªè¡¨ç›˜ï¼š      â”‚
â”‚ â€¢ å¿«é€Ÿå‘ç°å¼‚å¸¸å®ä¾‹         â”‚
â”‚ â€¢ å¯¹æ¯”ä¸åŒå®ä¾‹è´Ÿè½½         â”‚
â”‚ â€¢ åˆ†ææ€§èƒ½å·®å¼‚åŸå›          â”‚
â”‚ â€¢ ç›‘æ§é›†ç¾¤æ•´ä½“çŠ¶æ€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 1.3 ä½¿ç”¨åœºæ™¯


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
```
ğŸ¢ ä¼ä¸šçº§MySQLé›†ç¾¤ï¼š
- ä¸»ä»å¤åˆ¶ç›‘æ§ï¼šå¯¹æ¯”ä¸»åº“ä»åº“çŠ¶æ€
- åˆ†ç‰‡é›†ç¾¤ç›‘æ§ï¼šç›‘æ§å„åˆ†ç‰‡æ€§èƒ½
- è¯»å†™åˆ†ç¦»ç›‘æ§ï¼šå¯¹æ¯”è¯»åº“å†™åº“è´Ÿè½½

ğŸ” æ•…éšœæ’æŸ¥ï¼š
- å¿«é€Ÿå®šä½é—®é¢˜å®ä¾‹
- å¯¹æ¯”æ­£å¸¸ä¸å¼‚å¸¸å®ä¾‹å·®å¼‚
- åˆ†ææ€§èƒ½ç“¶é¢ˆåˆ†å¸ƒ

ğŸ“Š æ€§èƒ½è°ƒä¼˜ï¼š
- å¯¹æ¯”ä¼˜åŒ–å‰åæ•ˆæœ
- åˆ†æä¸åŒé…ç½®å½±å“
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
```

---

## 2. ğŸŒ å¤šå®ä¾‹ç›‘æ§æ ¸å¿ƒæ¦‚å¿µ


### 2.1 ä»€ä¹ˆæ˜¯å¤šå®ä¾‹ç›‘æ§


**é€šä¿—è§£é‡Š**ï¼šå°±åƒåŒæ—¶ç›‘æ§å¤šå°æœºå™¨çš„CPUä½¿ç”¨ç‡ï¼Œå¤šå®ä¾‹ç›‘æ§æ˜¯åŒæ—¶çœ‹å¤šä¸ªMySQLæœåŠ¡å™¨çš„è¿è¡ŒçŠ¶æ€ã€‚

```
å•å®ä¾‹ç›‘æ§ vs å¤šå®ä¾‹ç›‘æ§ï¼š

å•å®ä¾‹ç›‘æ§ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
æ—¶é—´    QPS    TPS    è¿æ¥æ•°
10:00   1000   800    50
10:01   1100   900    55
10:02   1200   950    60

å¤šå®ä¾‹ç›‘æ§ï¼ˆpt-mextæ–¹å¼ï¼‰ï¼š
æ—¶é—´    å®ä¾‹A-QPS  å®ä¾‹B-QPS  å®ä¾‹C-QPS
10:00   1000      800       1200
10:01   1100      850       1300
10:02   1200      900       1400
```

### 2.2 ç›‘æ§æ•°æ®æ¥æº


**ğŸ” æ•°æ®è·å–æ–¹å¼**ï¼š
```bash
# pt-mextä»è¿™äº›åœ°æ–¹è·å–æ•°æ®
SHOW GLOBAL STATUS;    # å…¨å±€çŠ¶æ€å˜é‡
SHOW VARIABLES;        # ç³»ç»Ÿå˜é‡
SHOW PROCESSLIST;      # è¿›ç¨‹åˆ—è¡¨
SHOW ENGINE INNODB STATUS;  # InnoDBå¼•æ“çŠ¶æ€
```

**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```
è¿æ¥ç›¸å…³ï¼š
â€¢ Connections - æ€»è¿æ¥æ•°
â€¢ Threads_connected - å½“å‰è¿æ¥æ•°
â€¢ Threads_running - æ´»è·ƒçº¿ç¨‹æ•°

æŸ¥è¯¢ç›¸å…³ï¼š
â€¢ Questions - æ€»æŸ¥è¯¢æ•°
â€¢ Queries - æ€»è¯­å¥æ•°
â€¢ Com_select - SELECTè¯­å¥æ•°
â€¢ Com_insert - INSERTè¯­å¥æ•°

æ€§èƒ½ç›¸å…³ï¼š
â€¢ Innodb_rows_read - è¯»å–è¡Œæ•°
â€¢ Innodb_rows_inserted - æ’å…¥è¡Œæ•°
â€¢ Innodb_buffer_pool_read_requests - ç¼“å†²æ± è¯»è¯·æ±‚
```

### 2.3 ç›‘æ§é¢‘ç‡ä¸æ—¶é—´çª—å£


**â° æ—¶é—´è®¾ç½®æ¦‚å¿µ**ï¼š
```
é‡‡é›†é—´éš”ï¼šæ¯éš”å¤šé•¿æ—¶é—´é‡‡é›†ä¸€æ¬¡æ•°æ®
æ—¶é—´çª—å£ï¼šè®¡ç®—å·®å€¼çš„æ—¶é—´èŒƒå›´
è¾“å‡ºé¢‘ç‡ï¼šå¤šä¹…æ˜¾ç¤ºä¸€æ¬¡ç»“æœ

ç¤ºä¾‹é…ç½®ï¼š
--interval=5   # æ¯5ç§’é‡‡é›†ä¸€æ¬¡
--count=12     # é‡‡é›†12æ¬¡ï¼ˆæ€»å…±1åˆ†é’Ÿï¼‰
```

---

## 3. ğŸ“Š çŠ¶æ€å˜é‡å¯¹æ¯”ä¸åˆ†æ


### 3.1 çŠ¶æ€å˜é‡åŸºç¡€


**ä»€ä¹ˆæ˜¯çŠ¶æ€å˜é‡**ï¼šMySQLå†…éƒ¨çš„"è®¡æ•°å™¨"ï¼Œè®°å½•å„ç§æ“ä½œçš„ç´¯è®¡æ¬¡æ•°ã€‚

```
ç†è§£çŠ¶æ€å˜é‡ï¼š
å°±åƒæ±½è½¦çš„é‡Œç¨‹è¡¨ï¼š
â€¢ Connections = æ€»å¯åŠ¨æ¬¡æ•°
â€¢ Questions = æ€»è¡Œé©¶é‡Œç¨‹  
â€¢ Com_select = é«˜é€Ÿå…¬è·¯è¡Œé©¶é‡Œç¨‹
â€¢ Com_insert = å¸‚åŒºè¡Œé©¶é‡Œç¨‹

è¿™äº›æ•°å­—åªå¢ä¸å‡ï¼Œæ‰€ä»¥è¦çœ‹"å¢é•¿é€Ÿåº¦"ï¼
```

### 3.2 å·®å€¼è®¡ç®—åŸç†


**ğŸ§® ä¸ºä»€ä¹ˆè¦ç®—å·®å€¼**ï¼š
```
ç›´æ¥çœ‹ç´¯è®¡å€¼æ²¡æ„ä¹‰ï¼š
æ—¶é—´    Questionsç´¯è®¡å€¼    æ„ä¹‰
10:00   1000000          ä¸çŸ¥é“å¿™ä¸å¿™
10:01   1001000          è¿˜æ˜¯ä¸çŸ¥é“

çœ‹å·®å€¼æ‰æœ‰æ„ä¹‰ï¼š
æ—¶é—´    Questionså·®å€¼     æ„ä¹‰  
10:00   1000            æ¯åˆ†é’Ÿ1000ä¸ªæŸ¥è¯¢
10:01   1000            è´Ÿè½½ç¨³å®š
10:02   2000            è´Ÿè½½çªç„¶ç¿»å€ï¼
```

### 3.3 å¯¹æ¯”åˆ†ææŠ€å·§


**ğŸ“ˆ å®ä¾‹é—´å¯¹æ¯”æ–¹æ³•**ï¼š
```
æ­£å¸¸æƒ…å†µï¼ˆè´Ÿè½½å‡è¡¡è‰¯å¥½ï¼‰ï¼š
å®ä¾‹A: QPS=1000  TPS=800  è¿æ¥=50
å®ä¾‹B: QPS=1100  TPS=850  è¿æ¥=55  
å®ä¾‹C: QPS=900   TPS=750  è¿æ¥=45
â†’ ä¸‰ä¸ªå®ä¾‹è´Ÿè½½ç›¸è¿‘ï¼Œæ­£å¸¸

å¼‚å¸¸æƒ…å†µï¼ˆæŸå®ä¾‹æœ‰é—®é¢˜ï¼‰ï¼š
å®ä¾‹A: QPS=1000  TPS=800  è¿æ¥=50
å®ä¾‹B: QPS=2500  TPS=2000 è¿æ¥=200  â† å¼‚å¸¸ï¼
å®ä¾‹C: QPS=900   TPS=750  è¿æ¥=45
â†’ å®ä¾‹Bè´Ÿè½½è¿‡é«˜ï¼Œéœ€è¦æ£€æŸ¥
```

**ğŸ” å¸¸è§å¼‚å¸¸æ¨¡å¼**ï¼š

| å¼‚å¸¸ç±»å‹ | **è¡¨ç°** | **å¯èƒ½åŸå› ** | **å¤„ç†å»ºè®®** |
|---------|---------|-------------|-------------|
| **è¿æ¥æ•°å¼‚å¸¸** | `æŸå®ä¾‹è¿æ¥æ•°è¿œé«˜äºå…¶ä»–` | `è¿æ¥æ± é…ç½®ä¸å½“` | `æ£€æŸ¥åº”ç”¨è¿æ¥é…ç½®` |
| **QPSä¸å‡è¡¡** | `æŸ¥è¯¢åˆ†å¸ƒä¸¥é‡ä¸å‡` | `è´Ÿè½½å‡è¡¡å¤±æ•ˆ` | `æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨é…ç½®` |
| **æ…¢æŸ¥è¯¢é›†ä¸­** | `æŸå®ä¾‹TPSä½ä½†QPSé«˜` | `æœ‰æ…¢æŸ¥è¯¢åœ¨è¿è¡Œ` | `æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—` |
| **é”ç­‰å¾…** | `çº¿ç¨‹æ•°é«˜ä½†QPSä½` | `å­˜åœ¨é”ç«äº‰` | `æ£€æŸ¥é”ç­‰å¾…æƒ…å†µ` |

---

## 4. âš¡ æ€§èƒ½æŒ‡æ ‡èšåˆæœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯æ€§èƒ½æŒ‡æ ‡èšåˆ


**ç®€å•ç†è§£**ï¼šæŠŠå¤šä¸ªå®ä¾‹çš„æ•°æ®"åˆå¹¶è®¡ç®—"ï¼Œå¾—åˆ°æ•´ä½“æ€§èƒ½æ¦‚å†µã€‚

```
èšåˆè®¡ç®—ç¤ºä¾‹ï¼š

åŸå§‹æ•°æ®ï¼š
å®ä¾‹A: QPS=1000, è¿æ¥=50
å®ä¾‹B: QPS=1200, è¿æ¥=60  
å®ä¾‹C: QPS=800,  è¿æ¥=40

èšåˆç»“æœï¼š
æ€»QPS = 1000+1200+800 = 3000
å¹³å‡QPS = 3000/3 = 1000
æœ€å¤§QPS = 1200
æœ€å°QPS = 800
æ€»è¿æ¥ = 50+60+40 = 150
```

### 4.2 èšåˆæ–¹å¼ç±»å‹


**ğŸ“Š å¸¸ç”¨èšåˆæ–¹å¼**ï¼š

```
æ±‚å’Œèšåˆï¼ˆSUMï¼‰ï¼š
é€‚ç”¨æŒ‡æ ‡ï¼šQPSã€TPSã€è¿æ¥æ•°
å«ä¹‰ï¼šæ•´ä¸ªé›†ç¾¤çš„æ€»å¤„ç†èƒ½åŠ›
ä¾‹å­ï¼šæ‰€æœ‰å®ä¾‹QPSç›¸åŠ  = é›†ç¾¤æ€»QPS

å¹³å‡èšåˆï¼ˆAVGï¼‰ï¼š  
é€‚ç”¨æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€CPUä½¿ç”¨ç‡
å«ä¹‰ï¼šé›†ç¾¤çš„å¹³å‡æ€§èƒ½æ°´å¹³
ä¾‹å­ï¼šæ‰€æœ‰å®ä¾‹å“åº”æ—¶é—´å¹³å‡ = é›†ç¾¤å¹³å‡å“åº”æ—¶é—´

æœ€å¤§/æœ€å°èšåˆï¼ˆMAX/MINï¼‰ï¼š
é€‚ç”¨æŒ‡æ ‡ï¼šä»»ä½•æŒ‡æ ‡
å«ä¹‰ï¼šæ‰¾å‡ºæ€§èƒ½æœ€å¥½/æœ€å·®çš„å®ä¾‹
ä¾‹å­ï¼šæ‰¾å‡ºQPSæœ€é«˜çš„å®ä¾‹
```

### 4.3 èšåˆæ•°æ®çš„ä»·å€¼


**ğŸ¯ èšåˆåˆ†æçš„æ„ä¹‰**ï¼š

â”Œâ”€ å®¹é‡è§„åˆ’ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ€»QPS = é›†ç¾¤æœ€å¤§å¤„ç†èƒ½åŠ›  â”‚
â”‚ â€¢ å¹³å‡è´Ÿè½½ = å•å®ä¾‹å…¸å‹è´Ÿè½½ â”‚
â”‚ â€¢ å³°å€¼è´Ÿè½½ = éœ€è¦çš„å†—ä½™é‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ€§èƒ½ä¼˜åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ è´Ÿè½½åˆ†å¸ƒæ˜¯å¦å‡åŒ€         â”‚
â”‚ â€¢ å“ªä¸ªå®ä¾‹æ˜¯ç“¶é¢ˆ           â”‚
â”‚ â€¢ æ‰©å®¹è¿˜æ˜¯ä¼˜åŒ–             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## 5. âš–ï¸ å®ä¾‹é—´æ€§èƒ½å¯¹æ¯”


### 5.1 å¯¹æ¯”ç»´åº¦


**ğŸ” ä¸»è¦å¯¹æ¯”è§’åº¦**ï¼š

```
ååé‡å¯¹æ¯”ï¼š
â€¢ QPSå¯¹æ¯” - æŸ¥è¯¢å¤„ç†èƒ½åŠ›
â€¢ TPSå¯¹æ¯” - äº‹åŠ¡å¤„ç†èƒ½åŠ›  
â€¢ è¿æ¥æ•°å¯¹æ¯” - å¹¶å‘å¤„ç†èƒ½åŠ›

èµ„æºä½¿ç”¨å¯¹æ¯”ï¼š
â€¢ CPUä½¿ç”¨ç‡å¯¹æ¯”
â€¢ å†…å­˜ä½¿ç”¨ç‡å¯¹æ¯”
â€¢ ç£ç›˜IOå¯¹æ¯”
â€¢ ç½‘ç»œæµé‡å¯¹æ¯”

å“åº”æ—¶é—´å¯¹æ¯”ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´
â€¢ 95%å“åº”æ—¶é—´
â€¢ æœ€å¤§å“åº”æ—¶é—´
```

### 5.2 å¯¹æ¯”åˆ†ææ–¹æ³•


**ğŸ“ˆ æ•°æ®å¯¹æ¯”æŠ€å·§**ï¼š

```bash
# ä½¿ç”¨pt-mextè¿›è¡Œå®ä¾‹å¯¹æ¯”
pt-mext -- mysqladmin extended-status -h host1 \
        -- mysqladmin extended-status -h host2 \
        -- mysqladmin extended-status -h host3
```

**è¾“å‡ºæ ¼å¼ç¤ºä¾‹**ï¼š
```
Variable_name           host1    host2    host3    
Questions               1000     1200     800      
Connections             50       60       40       
Threads_connected       25       30       20       
Com_select              800      950      600      
Com_insert              150      180      120      
```

### 5.3 æ€§èƒ½å·®å¼‚åˆ†æ


**ğŸ” å·®å¼‚åŸå› åˆ†æ**ï¼š

```
ç¡¬ä»¶å·®å¼‚ï¼š
ä¸åŒæœåŠ¡å™¨é…ç½® â†’ æ€§èƒ½å¤©ç„¶ä¸åŒ
è§£å†³ï¼šé…ç½®æƒé‡ï¼ŒæŒ‰æ€§èƒ½åˆ†é…è´Ÿè½½

é…ç½®å·®å¼‚ï¼š  
MySQLå‚æ•°è®¾ç½®ä¸åŒ â†’ å½±å“æ€§èƒ½
è§£å†³ï¼šç»Ÿä¸€é…ç½®ï¼Œæˆ–é’ˆå¯¹æ€§è°ƒä¼˜

è´Ÿè½½å·®å¼‚ï¼š
ä¸šåŠ¡åˆ†é…ä¸å‡ â†’ æŸäº›å®ä¾‹å‹åŠ›å¤§
è§£å†³ï¼šè°ƒæ•´è´Ÿè½½å‡è¡¡ç­–ç•¥

æ•°æ®å·®å¼‚ï¼š
åˆ†ç‰‡æ•°æ®é‡ä¸åŒ â†’ æŸ¥è¯¢å¤æ‚åº¦ä¸åŒ  
è§£å†³ï¼šæ•°æ®é‡æ–°åˆ†å¸ƒæˆ–åˆ†ç‰‡ç­–ç•¥è°ƒæ•´
```

---

## 6. ğŸ¨ ç›‘æ§æ•°æ®æ ¼å¼åŒ–


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æ ¼å¼åŒ–


**ğŸ“‹ æ ¼å¼åŒ–çš„ä»·å€¼**ï¼š

```
åŸå§‹æ•°æ®ï¼ˆéš¾ä»¥é˜…è¯»ï¼‰ï¼š
Questions:1234567,Connections:123,Threads_connected:45...

æ ¼å¼åŒ–åï¼ˆæ¸…æ™°æ˜“è¯»ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡åç§°        â”‚ å®ä¾‹A  â”‚ å®ä¾‹B  â”‚ å®ä¾‹C  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Questions       â”‚ 1,235K â”‚ 1,456K â”‚ 987K   â”‚
â”‚ Connections     â”‚ 123    â”‚ 156    â”‚ 98     â”‚
â”‚ Threads_conn    â”‚ 45     â”‚ 67     â”‚ 34     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ ¼å¼åŒ–é€‰é¡¹


**ğŸ”§ pt-mextæ ¼å¼åŒ–åŠŸèƒ½**ï¼š

```bash
# æ•°å€¼æ ¼å¼åŒ–
--format-numbers    # å¤§æ•°å­—ç”¨Kã€Mã€Gè¡¨ç¤º
# 1234567 â†’ 1.23M

# åˆ—å¯¹é½  
--align            # åˆ—å¯¹é½ï¼Œç¾è§‚æ˜“è¯»

# æ’åº
--sort-by-size     # æŒ‰æ•°å€¼å¤§å°æ’åº
--sort-by-name     # æŒ‰åç§°æ’åº

# è¿‡æ»¤
--include=Questions,Connections  # åªæ˜¾ç¤ºæŒ‡å®šæŒ‡æ ‡
--exclude=Com_*                  # æ’é™¤ç‰¹å®šæŒ‡æ ‡
```

### 6.3 è‡ªå®šä¹‰æ ¼å¼åŒ–


**ğŸ“Š å®šåˆ¶è¾“å‡ºæ ¼å¼**ï¼š

```bash
# åˆ›å»ºè‡ªå®šä¹‰æ ¼å¼åŒ–è„šæœ¬
#!/bin/bash
pt-mext --format-numbers --align \
        --include="Questions,Connections,Threads_connected,Com_select,Com_insert" \
        -- mysqladmin ext -h db1 \
        -- mysqladmin ext -h db2 \
        -- mysqladmin ext -h db3 | \
awk '
BEGIN { print "=== MySQLé›†ç¾¤ç›‘æ§æŠ¥å‘Š ===" }
/Questions/ { print "æŸ¥è¯¢é‡: " $0 }
/Connections/ { print "è¿æ¥æ•°: " $0 }
/Threads_connected/ { print "æ´»è·ƒè¿æ¥: " $0 }
END { print "=== æŠ¥å‘Šç»“æŸ ===" }
'
```

---

## 7. ğŸ¯ è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡


### 7.1 ç›‘æ§æŒ‡æ ‡åˆ†ç±»


**ğŸ“Š MySQLç›‘æ§æŒ‡æ ‡ä½“ç³»**ï¼š

```
è¿æ¥æŒ‡æ ‡ï¼š
â€¢ Connections - ç´¯è®¡è¿æ¥æ•°
â€¢ Threads_connected - å½“å‰è¿æ¥æ•°  
â€¢ Threads_running - è¿è¡Œä¸­çº¿ç¨‹æ•°
â€¢ Max_used_connections - æœ€å¤§è¿æ¥æ•°

æŸ¥è¯¢æŒ‡æ ‡ï¼š
â€¢ Questions - æ€»æŸ¥è¯¢æ•°
â€¢ Queries - æ€»è¯­å¥æ•°
â€¢ Com_select - SELECTæ¬¡æ•°
â€¢ Com_insert - INSERTæ¬¡æ•°
â€¢ Com_update - UPDATEæ¬¡æ•°
â€¢ Com_delete - DELETEæ¬¡æ•°

InnoDBæŒ‡æ ‡ï¼š
â€¢ Innodb_buffer_pool_read_requests - ç¼“å†²æ± è¯»è¯·æ±‚
â€¢ Innodb_buffer_pool_reads - ç‰©ç†è¯»æ¬¡æ•°  
â€¢ Innodb_rows_read - è¯»å–è¡Œæ•°
â€¢ Innodb_rows_inserted - æ’å…¥è¡Œæ•°
```

### 7.2 è‡ªå®šä¹‰æŒ‡æ ‡é…ç½®


**ğŸ”§ åˆ›å»ºè‡ªå®šä¹‰ç›‘æ§é…ç½®**ï¼š

```bash
# åˆ›å»ºæŒ‡æ ‡é…ç½®æ–‡ä»¶ custom_metrics.conf
[basic_metrics]
Questions
Connections  
Threads_connected
Threads_running

[performance_metrics]
Com_select
Com_insert
Com_update
Com_delete
Innodb_buffer_pool_read_requests
Innodb_buffer_pool_reads

[innodb_metrics]
Innodb_rows_read
Innodb_rows_inserted
Innodb_rows_updated
Innodb_rows_deleted
```

### 7.3 ä¸šåŠ¡ç›¸å…³æŒ‡æ ‡


**ğŸ“ˆ ä¸šåŠ¡å±‚é¢ç›‘æ§æŒ‡æ ‡**ï¼š

```
è®¡ç®—å‹æŒ‡æ ‡ï¼ˆéœ€è¦å…¬å¼è®¡ç®—ï¼‰ï¼š

QPS = Questionså·®å€¼ / æ—¶é—´é—´éš”
TPS = (Com_commit + Com_rollback)å·®å€¼ / æ—¶é—´é—´éš”  
ç¼“å­˜å‘½ä¸­ç‡ = (è¯»è¯·æ±‚ - ç‰©ç†è¯») / è¯»è¯·æ±‚ * 100%
è¿æ¥ä½¿ç”¨ç‡ = å½“å‰è¿æ¥æ•° / æœ€å¤§è¿æ¥æ•° * 100%

ä¸šåŠ¡æŒ‡æ ‡ç¤ºä¾‹ï¼š
ç”¨æˆ·æ´»è·ƒåº¦ = Com_select / Questions * 100%
å†™å…¥æ¯”ä¾‹ = (Com_insert + Com_update) / Questions * 100%
äº‹åŠ¡æ¯”ä¾‹ = TPS / QPS * 100%
```

**ğŸ’¡ è‡ªå®šä¹‰æŒ‡æ ‡è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ä¸šåŠ¡æŒ‡æ ‡è®¡ç®—è„šæœ¬

# è·å–åŸºç¡€æ•°æ®
eval $(pt-mext --samples=2 --interval=1 \
       -- mysqladmin ext -h $HOST | \
       tail -1 | \
       awk '{
         print "questions=" $2
         print "com_select=" $3  
         print "com_insert=" $4
         print "connections=" $5
       }')

# è®¡ç®—ä¸šåŠ¡æŒ‡æ ‡
qps=$((questions))
select_ratio=$((com_select * 100 / questions))
insert_ratio=$((com_insert * 100 / questions))

echo "QPS: $qps"
echo "æŸ¥è¯¢æ¯”ä¾‹: ${select_ratio}%"  
echo "æ’å…¥æ¯”ä¾‹: ${insert_ratio}%"
```

---

## 8. ğŸ”— ç›‘æ§è„šæœ¬é›†æˆ


### 8.1 é›†æˆç›‘æ§ç³»ç»Ÿ


**ğŸ—ï¸ ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿé›†æˆ**ï¼š

```
å¸¸è§ç›‘æ§ç³»ç»Ÿé›†æˆï¼š

Zabbixé›†æˆï¼š
pt-mextè¾“å‡º â†’ Zabbix Agent â†’ Zabbix Server

Prometheusé›†æˆï¼š  
pt-mextè¾“å‡º â†’ è‡ªå®šä¹‰Exporter â†’ Prometheus

Nagiosé›†æˆï¼š
pt-mextè¾“å‡º â†’ Nagiosæ’ä»¶ â†’ Nagios Core

Grafanaå±•ç¤ºï¼š
æ•°æ®æº â†’ Grafana Dashboard â†’ å¯è§†åŒ–å›¾è¡¨
```

### 8.2 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬


**ğŸ¤– ç›‘æ§è‡ªåŠ¨åŒ–å®ç°**ï¼š

```bash
#!/bin/bash
# mysql_cluster_monitor.sh - MySQLé›†ç¾¤è‡ªåŠ¨ç›‘æ§è„šæœ¬

# é…ç½®å‚æ•°
HOSTS="db1,db2,db3"
INTERVAL=60
LOGFILE="/var/log/mysql_cluster_monitor.log"
ALERT_THRESHOLD_QPS=5000
ALERT_EMAIL="admin@company.com"

# ç›‘æ§å‡½æ•°
monitor_cluster() {
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # ä½¿ç”¨pt-mextè·å–æ•°æ®
    result=$(pt-mext --samples=2 --interval=5 \
             $(echo $HOSTS | sed 's/,/ -- mysqladmin ext -h /g' | sed 's/^/-- mysqladmin ext -h /'))
    
    # è®°å½•æ—¥å¿—
    echo "[$timestamp] $result" >> $LOGFILE
    
    # æ£€æŸ¥å¼‚å¸¸
    check_alerts "$result"
}

# å¼‚å¸¸æ£€æµ‹å‡½æ•°  
check_alerts() {
    local data="$1"
    
    # æ£€æŸ¥QPSæ˜¯å¦è¶…è¿‡é˜ˆå€¼
    high_qps=$(echo "$data" | awk -v threshold=$ALERT_THRESHOLD_QPS '
        /Questions/ { 
            for(i=2; i<=NF; i++) {
                if($i > threshold) print "Host" (i-1) ": QPS=" $i
            }
        }')
    
    if [ -n "$high_qps" ]; then
        echo "QPSå‘Šè­¦: $high_qps" | mail -s "MySQLé›†ç¾¤QPSå¼‚å¸¸" $ALERT_EMAIL
    fi
}

# ä¸»å¾ªç¯
while true; do
    monitor_cluster
    sleep $INTERVAL
done
```

### 8.3 é›†æˆé…ç½®ç¤ºä¾‹


**ğŸ“Š Zabbixé›†æˆé…ç½®**ï¼š

```bash
# zabbix_mysql_cluster.conf
# Zabbix Agenté…ç½®

UserParameter=mysql.cluster.qps,/opt/scripts/get_cluster_qps.sh
UserParameter=mysql.cluster.connections,/opt/scripts/get_cluster_connections.sh
UserParameter=mysql.cluster.status,/opt/scripts/get_cluster_status.sh

# get_cluster_qps.shè„šæœ¬å†…å®¹
#!/bin/bash
pt-mext --samples=2 --interval=1 \
        -- mysqladmin ext -h db1 \
        -- mysqladmin ext -h db2 \
        -- mysqladmin ext -h db3 | \
awk '/Questions/ { 
    total=0; 
    for(i=2;i<=NF;i++) total+=$i; 
    print total 
}'
```

---

## 9. ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿åˆ†æ


### 9.1 è¶‹åŠ¿åˆ†ææ¦‚å¿µ


**ğŸ“Š ä»€ä¹ˆæ˜¯æ€§èƒ½è¶‹åŠ¿**ï¼šé€šè¿‡è§‚å¯Ÿä¸€æ®µæ—¶é—´å†…çš„æ€§èƒ½æŒ‡æ ‡å˜åŒ–ï¼Œå‘ç°ç³»ç»Ÿæ€§èƒ½çš„å˜åŒ–è§„å¾‹ã€‚

```
è¶‹åŠ¿åˆ†æçš„ä»·å€¼ï¼š

çŸ­æœŸè¶‹åŠ¿ï¼ˆåˆ†é’Ÿçº§ï¼‰ï¼š
â€¢ å‘ç°çªå‘æ€§èƒ½é—®é¢˜
â€¢ ç›‘æ§å®æ—¶è´Ÿè½½å˜åŒ–
â€¢ å¿«é€Ÿæ•…éšœå“åº”

ä¸­æœŸè¶‹åŠ¿ï¼ˆå°æ—¶çº§ï¼‰ï¼š  
â€¢ åˆ†æä¸šåŠ¡é«˜å³°æœŸ
â€¢ ä¼˜åŒ–èµ„æºé…ç½®
â€¢ é¢„æµ‹å®¹é‡éœ€æ±‚

é•¿æœŸè¶‹åŠ¿ï¼ˆå¤©/å‘¨/æœˆçº§ï¼‰ï¼š
â€¢ ä¸šåŠ¡å¢é•¿è§„åˆ’
â€¢ ç¡¬ä»¶å‡çº§å†³ç­–
â€¢ æˆæœ¬ä¼˜åŒ–åˆ†æ
```

### 9.2 è¶‹åŠ¿åˆ†ææ–¹æ³•


**ğŸ“ˆ æ•°æ®æ”¶é›†ä¸åˆ†æ**ï¼š

```bash
# é•¿æœŸç›‘æ§æ•°æ®æ”¶é›†è„šæœ¬
#!/bin/bash
# trend_monitor.sh

LOGDIR="/var/log/mysql_trends"
DATE=$(date '+%Y%m%d')
LOGFILE="$LOGDIR/mysql_cluster_$DATE.log"

# æ¯5åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡æ•°æ®
while true; do
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # ä½¿ç”¨pt-mextè·å–æ€§èƒ½æ•°æ®
    data=$(pt-mext --samples=2 --interval=5 \
           -- mysqladmin ext -h db1 \
           -- mysqladmin ext -h db2 \
           -- mysqladmin ext -h db3)
    
    # æ ¼å¼åŒ–å¹¶è®°å½•
    echo "[$timestamp]" >> $LOGFILE
    echo "$data" >> $LOGFILE
    echo "---" >> $LOGFILE
    
    sleep 300  # 5åˆ†é’Ÿé—´éš”
done
```

### 9.3 è¶‹åŠ¿æ•°æ®åˆ†æ


**ğŸ“Š è¶‹åŠ¿åˆ†ææŠ€å·§**ï¼š

```bash
# è¶‹åŠ¿åˆ†æè„šæœ¬ analyze_trends.sh
#!/bin/bash

LOGFILE="$1"
METRIC="$2"  # è¦åˆ†æçš„æŒ‡æ ‡ï¼Œå¦‚Questions

# æå–æŒ‡æ ‡æ•°æ®
extract_metric_data() {
    grep -A 20 "\[$timestamp\]" $LOGFILE | \
    grep "$METRIC" | \
    awk '{print $2, $3, $4}' # å‡è®¾æœ‰3ä¸ªå®ä¾‹
}

# è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
calculate_stats() {
    local data_file="/tmp/metric_data.txt"
    extract_metric_data > $data_file
    
    echo "=== $METRIC è¶‹åŠ¿åˆ†æ ==="
    echo "æ•°æ®æ ·æœ¬æ•°: $(wc -l < $data_file)"
    
    # è®¡ç®—å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼
    awk '{
        sum1+=$1; sum2+=$2; sum3+=$3;
        if(NR==1) {min1=max1=$1; min2=max2=$2; min3=max3=$3}
        if($1<min1) min1=$1; if($1>max1) max1=$1;
        if($2<min2) min2=$2; if($2>max2) max2=$2;
        if($3<min3) min3=$3; if($3>max3) max3=$3;
    } END {
        print "å®ä¾‹1 - å¹³å‡:"sum1/NR" æœ€å°:"min1" æœ€å¤§:"max1;
        print "å®ä¾‹2 - å¹³å‡:"sum2/NR" æœ€å°:"min2" æœ€å¤§:"max2;
        print "å®ä¾‹3 - å¹³å‡:"sum3/NR" æœ€å°:"min3" æœ€å¤§:"max3;
    }' $data_file
}

# è¶‹åŠ¿æ–¹å‘åˆ†æ
analyze_trend_direction() {
    echo "=== è¶‹åŠ¿æ–¹å‘åˆ†æ ==="
    
    # å¯¹æ¯”æœ€è¿‘1å°æ—¶ä¸å‰1å°æ—¶çš„å¹³å‡å€¼
    recent_avg=$(tail -12 $data_file | awk '{sum+=$1} END {print sum/NR}')  # æœ€è¿‘1å°æ—¶
    previous_avg=$(head -12 $data_file | tail -12 | awk '{sum+=$1} END {print sum/NR}')  # å‰1å°æ—¶
    
    trend=$(echo "$recent_avg $previous_avg" | awk '{
        diff = $1 - $2;
        if(diff > $2*0.1) print "ä¸Šå‡è¶‹åŠ¿ +"int(diff);
        else if(diff < -$2*0.1) print "ä¸‹é™è¶‹åŠ¿ "int(diff);
        else print "è¶‹åŠ¿å¹³ç¨³";
    }')
    
    echo "è¶‹åŠ¿åˆ¤æ–­: $trend"
}

# æ‰§è¡Œåˆ†æ
calculate_stats
analyze_trend_direction
```

---

## 10. ğŸš¨ å¼‚å¸¸æ£€æµ‹æœºåˆ¶


### 10.1 å¼‚å¸¸æ£€æµ‹åŸç†


**ğŸ” ä»€ä¹ˆæ˜¯å¼‚å¸¸æ£€æµ‹**ï¼šé€šè¿‡è®¾å®šé˜ˆå€¼æˆ–ç®—æ³•ï¼Œè‡ªåŠ¨å‘ç°ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡çš„å¼‚å¸¸å˜åŒ–ã€‚

```
å¼‚å¸¸æ£€æµ‹æ–¹æ³•ï¼š

é˜ˆå€¼æ£€æµ‹ï¼š
â€¢ ç»å¯¹é˜ˆå€¼ï¼šQPS > 5000åˆ™å‘Šè­¦
â€¢ ç›¸å¯¹é˜ˆå€¼ï¼šQPSå¢é•¿ > 50%åˆ™å‘Šè­¦
â€¢ ç™¾åˆ†æ¯”é˜ˆå€¼ï¼šè¿æ¥ä½¿ç”¨ç‡ > 80%åˆ™å‘Šè­¦

ç»Ÿè®¡æ£€æµ‹ï¼š
â€¢ æ ‡å‡†å·®æ£€æµ‹ï¼šåç¦»å¹³å‡å€¼2ä¸ªæ ‡å‡†å·®
â€¢ ç§»åŠ¨å¹³å‡ï¼šåç¦»ç§»åŠ¨å¹³å‡å€¼ä¸€å®šæ¯”ä¾‹
â€¢ åŒæ¯”æ£€æµ‹ï¼šä¸å†å²åŒæœŸå¯¹æ¯”

æœºå™¨å­¦ä¹ æ£€æµ‹ï¼š
â€¢ å¼‚å¸¸æ¨¡å¼è¯†åˆ«
â€¢ å­£èŠ‚æ€§è°ƒæ•´  
â€¢ é¢„æµ‹æ€§åˆ†æ
```

### 10.2 å¼‚å¸¸æ£€æµ‹å®ç°


**ğŸš¨ åŸºç¡€å¼‚å¸¸æ£€æµ‹è„šæœ¬**ï¼š

```bash
#!/bin/bash
# mysql_anomaly_detector.sh

# é…ç½®å‚æ•°
QPS_THRESHOLD=5000
CONN_THRESHOLD=80  # è¿æ¥ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
TPS_GROWTH_THRESHOLD=50  # TPSå¢é•¿ç™¾åˆ†æ¯”

# å†å²æ•°æ®æ–‡ä»¶
HISTORY_FILE="/tmp/mysql_history.dat"
CURRENT_FILE="/tmp/mysql_current.dat"

# è·å–å½“å‰æ•°æ®
get_current_metrics() {
    pt-mext --samples=2 --interval=5 \
            -- mysqladmin ext -h db1 \
            -- mysqladmin ext -h db2 \
            -- mysqladmin ext -h db3 | \
    awk '
    /Questions/ { print "QPS", $2, $3, $4 }
    /Connections/ { print "CONN", $2, $3, $4 }  
    /Threads_connected/ { print "ACTIVE_CONN", $2, $3, $4 }
    /Max_used_connections/ { print "MAX_CONN", $2, $3, $4 }
    ' > $CURRENT_FILE
}

# å¼‚å¸¸æ£€æµ‹å‡½æ•°
detect_anomalies() {
    local alerts=""
    
    # æ£€æŸ¥QPSå¼‚å¸¸
    qps_alerts=$(awk -v threshold=$QPS_THRESHOLD '
    /QPS/ { 
        for(i=2; i<=NF; i++) {
            if($i > threshold) 
                print "å®ä¾‹"(i-1)": QPSè¿‡é«˜ "$i" (é˜ˆå€¼:"threshold")"
        }
    }' $CURRENT_FILE)
    
    # æ£€æŸ¥è¿æ¥ä½¿ç”¨ç‡å¼‚å¸¸
    conn_alerts=$(awk -v threshold=$CONN_THRESHOLD '
    /ACTIVE_CONN/ { 
        getline maxline < "/dev/stdin"  # è¯»å–MAX_CONNè¡Œ
        for(i=2; i<=NF; i++) {
            ratio = $i / maxline[i] * 100
            if(ratio > threshold)
                print "å®ä¾‹"(i-1)": è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜ "int(ratio)"% (é˜ˆå€¼:"threshold"%)"
        }
    }' $CURRENT_FILE)
    
    # å¦‚æœæœ‰å†å²æ•°æ®ï¼Œæ£€æŸ¥å¢é•¿ç‡å¼‚å¸¸
    if [ -f $HISTORY_FILE ]; then
        growth_alerts=$(check_growth_anomaly)
    fi
    
    # æ±‡æ€»å‘Šè­¦ä¿¡æ¯
    alerts="$qps_alerts\n$conn_alerts\n$growth_alerts"
    
    if [ -n "$alerts" ]; then
        echo -e "MySQLé›†ç¾¤å¼‚å¸¸æ£€æµ‹æŠ¥å‘Š:\n$alerts" | \
        mail -s "MySQLé›†ç¾¤å¼‚å¸¸å‘Šè­¦" admin@company.com
    fi
}

# å¢é•¿ç‡å¼‚å¸¸æ£€æµ‹
check_growth_anomaly() {
    awk -v threshold=$TPS_GROWTH_THRESHOLD '
    FNR==NR { 
        # è¯»å–å†å²æ•°æ®
        if(/QPS/) { for(i=2;i<=NF;i++) hist_qps[i]=$i }
        next
    }
    /QPS/ { 
        # å¯¹æ¯”å½“å‰æ•°æ®
        for(i=2; i<=NF; i++) {
            if(hist_qps[i] > 0) {
                growth = ($i - hist_qps[i]) / hist_qps[i] * 100
                if(growth > threshold)
                    print "å®ä¾‹"(i-1)": QPSå¢é•¿è¿‡å¿« "int(growth)"% (é˜ˆå€¼:"threshold"%)"
            }
        }
    }
    ' $HISTORY_FILE $CURRENT_FILE
}

# æ›´æ–°å†å²æ•°æ®
update_history() {
    cp $CURRENT_FILE $HISTORY_FILE
}

# ä¸»æ‰§è¡Œæµç¨‹
get_current_metrics
detect_anomalies  
update_history
```

### 10.3 æ™ºèƒ½å¼‚å¸¸æ£€æµ‹


**ğŸ¤– é«˜çº§å¼‚å¸¸æ£€æµ‹æ–¹æ³•**ï¼š

```bash
#!/bin/bash
# smart_anomaly_detector.sh - æ™ºèƒ½å¼‚å¸¸æ£€æµ‹

# åŸºäºç§»åŠ¨å¹³å‡çš„å¼‚å¸¸æ£€æµ‹
detect_moving_average_anomaly() {
    local metric="$1"
    local window_size=12  # 1å°æ—¶çª—å£ï¼ˆ5åˆ†é’Ÿé—´éš”ï¼‰
    
    # è®¡ç®—ç§»åŠ¨å¹³å‡å’Œæ ‡å‡†å·®
    tail -$((window_size * 2)) $HISTORY_FILE | \
    awk -v metric="$metric" -v window=$window_size '
    /$metric/ {
        values[NR] = $2  # å‡è®¾åˆ†æç¬¬ä¸€ä¸ªå®ä¾‹
        if(NR > window) {
            # è®¡ç®—ç§»åŠ¨å¹³å‡
            sum = 0
            for(i = NR-window+1; i <= NR; i++) sum += values[i]
            avg = sum / window
            
            # è®¡ç®—æ ‡å‡†å·®
            sum_sq = 0  
            for(i = NR-window+1; i <= NR; i++) 
                sum_sq += (values[i] - avg) ^ 2
            stddev = sqrt(sum_sq / window)
            
            # æ£€æµ‹å¼‚å¸¸ï¼ˆè¶…è¿‡2ä¸ªæ ‡å‡†å·®ï¼‰
            if(abs(values[NR] - avg) > 2 * stddev) {
                print "å¼‚å¸¸æ£€æµ‹: " metric " å½“å‰å€¼:" values[NR] " å¹³å‡å€¼:" avg " æ ‡å‡†å·®:" stddev
            }
        }
    }'
}

# å‘¨æœŸæ€§å¼‚å¸¸æ£€æµ‹ï¼ˆä¸å†å²åŒæœŸå¯¹æ¯”ï¼‰  
detect_seasonal_anomaly() {
    local current_hour=$(date '+%H')
    local current_day=$(date '+%u')  # å‘¨å‡ 
    
    # æŸ¥æ‰¾å†å²åŒæœŸæ•°æ®ï¼ˆç›¸åŒå°æ—¶ã€ç›¸åŒæ˜ŸæœŸå‡ ï¼‰
    historical_data=$(find /var/log/mysql_trends -name "*.log" -mtime -30 | \
                     xargs grep "$(date '+%Y-.*-%u.*%H:' | sed 's/%u/'$current_day'/;s/%H/'$current_hour'/')" | \
                     tail -10)  # æœ€è¿‘10æ¬¡åŒæœŸæ•°æ®
    
    if [ -n "$historical_data" ]; then
        # å¯¹æ¯”å½“å‰æ•°æ®ä¸å†å²åŒæœŸ
        echo "$historical_data" | awk '...'  # å®ç°å¯¹æ¯”é€»è¾‘
    fi
}

# é¢„æµ‹æ€§å¼‚å¸¸æ£€æµ‹
detect_predictive_anomaly() {
    # åŸºäºæœ€è¿‘è¶‹åŠ¿é¢„æµ‹ä¸‹ä¸€ä¸ªæ—¶é—´ç‚¹çš„å€¼
    # å¦‚æœå®é™…å€¼ä¸é¢„æµ‹å€¼å·®å¼‚è¿‡å¤§ï¼Œåˆ™æŠ¥å‘Šå¼‚å¸¸
    
    recent_data=$(tail -6 $HISTORY_FILE)  # æœ€è¿‘30åˆ†é’Ÿæ•°æ®
    
    # ç®€å•çº¿æ€§å›å½’é¢„æµ‹
    predicted_value=$(echo "$recent_data" | awk '
    BEGIN { sum_x=0; sum_y=0; sum_xy=0; sum_x2=0; n=0 }
    /QPS/ { 
        n++; x=n; y=$2;
        sum_x += x; sum_y += y; 
        sum_xy += x*y; sum_x2 += x*x;
    }
    END {
        if(n >= 3) {
            slope = (n*sum_xy - sum_x*sum_y) / (n*sum_x2 - sum_x*sum_x)
            intercept = (sum_y - slope*sum_x) / n
            next_x = n + 1
            predicted = slope * next_x + intercept
            print predicted
        }
    }')
    
    if [ -n "$predicted_value" ]; then
        current_value=$(tail -1 $CURRENT_FILE | awk '/QPS/ {print $2}')
        deviation=$(echo "$current_value $predicted_value" | awk '{
            diff = abs($1 - $2)
            ratio = diff / $2 * 100
            if(ratio > 30) print "é¢„æµ‹å¼‚å¸¸: å½“å‰å€¼"$1" é¢„æµ‹å€¼"$2" åå·®"int(ratio)"%"
        }')
        
        if [ -n "$deviation" ]; then
            echo "$deviation"
        fi
    fi
}
```

---

## 11. ğŸ“¤ ç›‘æ§æ•°æ®å¯¼å‡º


### 11.1 æ•°æ®å¯¼å‡ºæ ¼å¼


**ğŸ“Š å¸¸è§å¯¼å‡ºæ ¼å¼**ï¼š

```
CSVæ ¼å¼ï¼ˆExcelå…¼å®¹ï¼‰ï¼š
æ—¶é—´,å®ä¾‹A_QPS,å®ä¾‹B_QPS,å®ä¾‹C_QPS,æ€»QPS
2025-01-15 10:00:00,1000,1200,800,3000
2025-01-15 10:05:00,1100,1300,900,3300

JSONæ ¼å¼ï¼ˆç¨‹åºå¤„ç†ï¼‰ï¼š
{
  "timestamp": "2025-01-15T10:00:00Z",
  "instances": {
    "db1": {"qps": 1000, "connections": 50},
    "db2": {"qps": 1200, "connections": 60},
    "db3": {"qps": 800, "connections": 40}
  },
  "cluster": {"total_qps": 3000, "total_connections": 150}
}

XMLæ ¼å¼ï¼ˆæ ‡å‡†åŒ–ï¼‰ï¼š
<mysql_cluster_metrics timestamp="2025-01-15T10:00:00Z">
  <instance name="db1" qps="1000" connections="50"/>
  <instance name="db2" qps="1200" connections="60"/>
  <instance name="db3" qps="800" connections="40"/>
</mysql_cluster_metrics>
```

### 11.2 æ•°æ®å¯¼å‡ºå®ç°


**ğŸ“ CSVå¯¼å‡ºè„šæœ¬**ï¼š

```bash
#!/bin/bash
# export_to_csv.sh

OUTPUT_FILE="mysql_cluster_metrics_$(date '+%Y%m%d').csv"
TEMP_FILE="/tmp/mysql_export_temp.txt"

# CSVå¤´éƒ¨
echo "æ—¶é—´,å®ä¾‹A_QPS,å®ä¾‹B_QPS,å®ä¾‹C_QPS,å®ä¾‹A_è¿æ¥,å®ä¾‹B_è¿æ¥,å®ä¾‹C_è¿æ¥,å®ä¾‹A_TPS,å®ä¾‹B_TPS,å®ä¾‹C_TPS" > $OUTPUT_FILE

# æ•°æ®å¯¼å‡ºå‡½æ•°
export_current_data() {
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è·å–ç›‘æ§æ•°æ®
    pt-mext --samples=2 --interval=5 \
            -- mysqladmin ext -h db1 \
            -- mysqladmin ext -h db2 \
            -- mysqladmin ext -h db3 > $TEMP_FILE
    
    # è§£æå¹¶æ ¼å¼åŒ–æ•°æ®
    qps_data=$(grep "Questions" $TEMP_FILE | awk '{print $2","$3","$4}')
    conn_data=$(grep "Connections" $TEMP_FILE | awk '{print $2","$3","$4}')  
    tps_data=$(grep "Com_commit" $TEMP_FILE | awk '{print $2","$3","$4}')
    
    # å†™å…¥CSV
    echo "$timestamp,$qps_data,$conn_data,$tps_data" >> $OUTPUT_FILE
}

# JSONå¯¼å‡ºå‡½æ•°
export_to_json() {
    timestamp=$(date -Iseconds)
    
    # è·å–æ•°æ®
    pt-mext --samples=2 --interval=5 \
            -- mysqladmin ext -h db1 \
            -- mysqladmin ext -h db2 \
            -- mysqladmin ext -h db3 | \
    awk -v ts="$timestamp" '
    BEGIN { print "{" }
    /Questions/ { 
        print "  \"timestamp\": \"" ts "\","
        print "  \"instances\": {"
        print "    \"db1\": {\"qps\": " $2 "},"
        print "    \"db2\": {\"qps\": " $3 "},"  
        print "    \"db3\": {\"qps\": " $4 "}"
        print "  },"
    }
    /Connections/ {
        print "  \"connections\": {"
        print "    \"db1\": " $2 ","
        print "    \"db2\": " $3 ","
        print "    \"db3\": " $4
        print "  }"
    }
    END { print "}" }
    ' > "mysql_cluster_$(date '+%Y%m%d_%H%M%S').json"
}

# æ‰¹é‡å†å²æ•°æ®å¯¼å‡º
export_historical_data() {
    local start_date="$1"
    local end_date="$2"
    local log_dir="/var/log/mysql_trends"
    
    echo "å¯¼å‡ºå†å²æ•°æ®: $start_date åˆ° $end_date"
    
    # æŸ¥æ‰¾æŒ‡å®šæ—¶é—´æ®µçš„æ—¥å¿—æ–‡ä»¶
    find $log_dir -name "mysql_cluster_*.log" -newermt "$start_date" ! -newermt "$end_date" | \
    while read logfile; do
        echo "å¤„ç†æ–‡ä»¶: $logfile"
        
        # è§£ææ—¥å¿—æ–‡ä»¶å¹¶è½¬æ¢ä¸ºCSVæ ¼å¼
        awk '
        /^\[.*\]$/ { 
            timestamp = substr($0, 2, length($0)-2)
            getline  # è¯»å–ä¸‹ä¸€è¡Œæ•°æ®
        }
        /Questions/ { 
            print timestamp "," $2 "," $3 "," $4
        }
        ' "$logfile" >> "historical_export_${start_date}_${end_date}.csv"
    done
}

# æ‰§è¡Œå¯¼å‡º
case "$1" in
    "csv")
        export_current_data
        ;;
    "json")  
        export_to_json
        ;;
    "historical")
        export_historical_data "$2" "$3"
        ;;
    *)
        echo "ç”¨æ³•: $0 {csv|json|historical start_date end_date}"
        echo "ç¤ºä¾‹: $0 historical '2025-01-01' '2025-01-15'"
        ;;
esac
```

### 11.3 æ•°æ®å¯¼å‡ºè‡ªåŠ¨åŒ–


**ğŸ¤– å®šæ—¶å¯¼å‡ºè®¾ç½®**ï¼š

```bash
# æ·»åŠ åˆ°crontabå®šæ—¶ä»»åŠ¡
# crontab -e

# æ¯å°æ—¶å¯¼å‡ºCSVæ•°æ®
0 * * * * /opt/scripts/export_to_csv.sh csv

# æ¯å¤©å‡Œæ™¨2ç‚¹å¯¼å‡ºJSONæ ¼å¼çš„æ—¥æŠ¥
0 2 * * * /opt/scripts/export_to_json.sh daily_report

# æ¯å‘¨ä¸€å¯¼å‡ºä¸Šå‘¨çš„å†å²æ•°æ®
0 3 * * 1 /opt/scripts/export_historical_data.sh weekly

# æ¯æœˆ1å·å¯¼å‡ºä¸Šæœˆçš„å®Œæ•´æ•°æ®  
0 4 1 * * /opt/scripts/export_historical_data.sh monthly
```

**ğŸ“Š æ•°æ®å‹ç¼©ä¸æ¸…ç†**ï¼š

```bash
#!/bin/bash
# data_maintenance.sh - æ•°æ®ç»´æŠ¤è„šæœ¬

DATA_DIR="/var/export/mysql_metrics"
ARCHIVE_DIR="/var/archive/mysql_metrics"

# å‹ç¼©30å¤©å‰çš„æ•°æ®
compress_old_data() {
    find $DATA_DIR -name "*.csv" -mtime +30 | while read file; do
        echo "å‹ç¼©æ–‡ä»¶: $file"
        gzip "$file"
        mv "$file.gz" $ARCHIVE_DIR/
    done
}

# åˆ é™¤90å¤©å‰çš„å½’æ¡£æ•°æ®
cleanup_archive() {
    find $ARCHIVE_DIR -name "*.gz" -mtime +90 -delete
    echo "æ¸…ç†å®Œæˆ: åˆ é™¤90å¤©å‰çš„å½’æ¡£æ•°æ®"
}

# æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
check_data_integrity() {
    local errors=0
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ–‡ä»¶
    find $DATA_DIR -name "*.csv" -size 0 | while read empty_file; do
        echo "å‘ç°ç©ºæ–‡ä»¶: $empty_file"
        errors=$((errors + 1))
    done
    
    # æ£€æŸ¥æ•°æ®æ ¼å¼
    find $DATA_DIR -name "*.csv" -mtime -1 | while read recent_file; do
        # æ£€æŸ¥CSVæ ¼å¼æ˜¯å¦æ­£ç¡®
        line_count=$(wc -l < "$recent_file")
        if [ $line_count -lt 2 ]; then
            echo "æ•°æ®å¼‚å¸¸: $recent_file è¡Œæ•°è¿‡å°‘"
            errors=$((errors + 1))
        fi
    done
    
    if [ $errors -eq 0 ]; then
        echo "æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
    else
        echo "å‘ç° $errors ä¸ªæ•°æ®é—®é¢˜"
    fi
}

# æ‰§è¡Œç»´æŠ¤ä»»åŠ¡
compress_old_data
cleanup_archive
check_data_integrity
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ pt-mextæœ¬è´¨ï¼šå¤šå®ä¾‹ç›‘æ§çš„"æ”¾å¤§é•œ"ï¼ŒæŠŠå¤šä¸ªMySQLå®ä¾‹æ”¾åœ¨ä¸€èµ·å¯¹æ¯”
ğŸ”¸ çŠ¶æ€å˜é‡ï¼šMySQLçš„"è®¡æ•°å™¨"ï¼Œè®°å½•å„ç§æ“ä½œç´¯è®¡æ¬¡æ•°
ğŸ”¸ å·®å€¼è®¡ç®—ï¼šçœ‹å¢é•¿é€Ÿåº¦è€Œä¸æ˜¯ç´¯è®¡å€¼ï¼Œæ‰èƒ½åˆ¤æ–­çœŸå®è´Ÿè½½
ğŸ”¸ æ€§èƒ½èšåˆï¼šæŠŠå¤šä¸ªå®ä¾‹çš„æ•°æ®åˆå¹¶ï¼Œå¾—åˆ°é›†ç¾¤æ•´ä½“æ€§èƒ½
ğŸ”¸ å¼‚å¸¸æ£€æµ‹ï¼šè®¾å®šè§„åˆ™è‡ªåŠ¨å‘ç°æ€§èƒ½é—®é¢˜ï¼Œæå‰é¢„è­¦
ğŸ”¸ æ•°æ®å¯¼å‡ºï¼šæŠŠç›‘æ§æ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œç”¨äºåˆ†æå’ŒæŠ¥å‘Š
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦å¤šå®ä¾‹ç›‘æ§**ï¼š
```
å•å®ä¾‹é—®é¢˜ï¼š
â€¢ æ— æ³•å¯¹æ¯” - ä¸çŸ¥é“å“ªä¸ªå®ä¾‹æœ‰é—®é¢˜
â€¢ ç¼ºä¹å…¨å±€ - çœ‹ä¸åˆ°é›†ç¾¤æ•´ä½“çŠ¶æ€  
â€¢ æ•ˆç‡ä½ä¸‹ - éœ€è¦é€ä¸ªæ£€æŸ¥æ¯ä¸ªå®ä¾‹

å¤šå®ä¾‹ä»·å€¼ï¼š
â€¢ ä¸€çœ¼çœ‹ç©¿ - ç«‹å³å‘ç°å¼‚å¸¸å®ä¾‹
â€¢ å…¨å±€æŠŠæ§ - æŒæ¡é›†ç¾¤æ•´ä½“æ€§èƒ½
â€¢ é«˜æ•ˆè¿ç»´ - ä¸€ä¸ªå·¥å…·ç®¡ç†æ‰€æœ‰å®ä¾‹
```

**ğŸ”¹ çŠ¶æ€å˜é‡çš„æ­£ç¡®ç†è§£**ï¼š
```
ç´¯è®¡å€¼ vs å¢é•¿ç‡ï¼š
ç´¯è®¡å€¼ï¼šQuestions=1000000 â†’ ä¸çŸ¥é“å¿™ä¸å¿™
å¢é•¿ç‡ï¼šæ¯åˆ†é’Ÿ+1000 â†’ çŸ¥é“å½“å‰è´Ÿè½½

å°±åƒçœ‹è½¦çš„é‡Œç¨‹è¡¨ï¼š
æ€»é‡Œç¨‹ï¼š100000å…¬é‡Œ â†’ ä¸çŸ¥é“ç°åœ¨å¼€å¤šå¿«
æ—¶é€Ÿï¼š60å…¬é‡Œ/å°æ—¶ â†’ çŸ¥é“å½“å‰é€Ÿåº¦
```

**ğŸ”¹ ç›‘æ§æ•°æ®çš„ä»·å€¼é“¾**ï¼š
```
åŸå§‹æ•°æ® â†’ å·®å€¼è®¡ç®— â†’ è¶‹åŠ¿åˆ†æ â†’ å¼‚å¸¸æ£€æµ‹ â†’ å†³ç­–æ”¯æŒ

æ¯ä¸€æ­¥éƒ½æœ‰ä»·å€¼ï¼š
â€¢ åŸå§‹æ•°æ®ï¼šè®°å½•å‘ç”Ÿäº†ä»€ä¹ˆ
â€¢ å·®å€¼è®¡ç®—ï¼šçŸ¥é“å˜åŒ–æœ‰å¤šå¿«
â€¢ è¶‹åŠ¿åˆ†æï¼šé¢„æµ‹å°†è¦å‘ç”Ÿä»€ä¹ˆ
â€¢ å¼‚å¸¸æ£€æµ‹ï¼šæå‰å‘ç°é—®é¢˜
â€¢ å†³ç­–æ”¯æŒï¼šæŒ‡å¯¼è¿ç»´å†³ç­–
```

### 12.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ç›‘æ§å®è·µå»ºè®®**ï¼š
```
ç›‘æ§é¢‘ç‡è®¾ç½®ï¼š
â€¢ å®æ—¶ç›‘æ§ï¼š5-10ç§’é—´éš”ï¼Œå¿«é€Ÿå‘ç°é—®é¢˜
â€¢ è¶‹åŠ¿åˆ†æï¼š5åˆ†é’Ÿé—´éš”ï¼Œè§‚å¯Ÿæ€§èƒ½å˜åŒ–
â€¢ å†å²åˆ†æï¼š1å°æ—¶é—´éš”ï¼Œé•¿æœŸè¶‹åŠ¿è·Ÿè¸ª

å‘Šè­¦é˜ˆå€¼è®¾ç½®ï¼š
â€¢ ä¸è¦è®¾å¤ªæ•æ„Ÿ - é¿å…è¯¯æŠ¥è¿‡å¤š
â€¢ ä¸è¦è®¾å¤ªç²—ç³™ - é¿å…æ¼æŠ¥é—®é¢˜
â€¢ åŠ¨æ€è°ƒæ•´ - æ ¹æ®å†å²æ•°æ®ä¼˜åŒ–

æ•°æ®å­˜å‚¨ç­–ç•¥ï¼š
â€¢ å®æ—¶æ•°æ®ï¼šä¿å­˜24å°æ—¶ï¼Œç”¨äºæ•…éšœæ’æŸ¥
â€¢ å†å²æ•°æ®ï¼šä¿å­˜3ä¸ªæœˆï¼Œç”¨äºè¶‹åŠ¿åˆ†æ
â€¢ å½’æ¡£æ•°æ®ï¼šå‹ç¼©ä¿å­˜1å¹´ï¼Œç”¨äºå¯¹æ¯”åˆ†æ
```

**ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯**ï¼š
```
ä¸»ä»å¤åˆ¶ç›‘æ§ï¼š
â€¢ å¯¹æ¯”ä¸»åº“ä»åº“çš„QPSã€å»¶è¿Ÿ
â€¢ æ£€æŸ¥å¤åˆ¶æ˜¯å¦æ­£å¸¸
â€¢ ç›‘æ§ä»åº“è´Ÿè½½åˆ†å¸ƒ

åˆ†ç‰‡é›†ç¾¤ç›‘æ§ï¼š
â€¢ å¯¹æ¯”å„åˆ†ç‰‡çš„è´Ÿè½½å‡è¡¡
â€¢ å‘ç°çƒ­ç‚¹åˆ†ç‰‡
â€¢ åˆ†æåˆ†ç‰‡ç­–ç•¥æ•ˆæœ

è¯»å†™åˆ†ç¦»ç›‘æ§ï¼š
â€¢ å¯¹æ¯”è¯»åº“å†™åº“çš„è´Ÿè½½
â€¢ ç›‘æ§è¯»å†™åˆ†ç¦»æ•ˆæœ
â€¢ ä¼˜åŒ–è¯»å†™æ¯”ä¾‹é…ç½®
```

### 12.4 å·¥ç¨‹å®è·µè¦ç‚¹


```
è„šæœ¬ç¼–å†™å»ºè®®ï¼š
â€¢ é”™è¯¯å¤„ç†ï¼šè€ƒè™‘ç½‘ç»œæ–­å¼€ã€æ•°æ®åº“å®•æœºç­‰å¼‚å¸¸æƒ…å†µ
â€¢ æ—¥å¿—è®°å½•ï¼šè®°å½•è¯¦ç»†çš„æ“ä½œæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
â€¢ é…ç½®ç®¡ç†ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†å‚æ•°ï¼Œä¾¿äºç»´æŠ¤
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæé«˜æ•ˆç‡

é›†æˆæ³¨æ„äº‹é¡¹ï¼š
â€¢ å…¼å®¹æ€§ï¼šç¡®ä¿ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿå…¼å®¹
â€¢ å®‰å…¨æ€§ï¼šä½¿ç”¨ä¸“ç”¨ç›‘æ§è´¦å·ï¼Œé™åˆ¶æƒé™
â€¢ å¯é æ€§ï¼šè®¾ç½®å¤šç§å‘Šè­¦é€šé“ï¼Œé¿å…å•ç‚¹æ•…éšœ
â€¢ å¯æ‰©å±•æ€§ï¼šè®¾è®¡æ¨¡å—åŒ–æ¶æ„ï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- pt-mextæ˜¯MySQLå¤šå®ä¾‹ç›‘æ§çš„åˆ©å™¨
- å…³æ³¨å¢é•¿ç‡è€Œä¸æ˜¯ç´¯è®¡å€¼æ‰æœ‰æ„ä¹‰
- å¯¹æ¯”åˆ†ææ˜¯å‘ç°é—®é¢˜çš„æœ€å¿«æ–¹æ³•
- è‡ªåŠ¨åŒ–ç›‘æ§æ¯”æ‰‹å·¥ç›‘æ§æ›´å¯é 
- æ•°æ®å¯¼å‡ºä¸ºæ·±å…¥åˆ†ææä¾›åŸºç¡€