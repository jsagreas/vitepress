---
title: 13ã€pt-heartbeatå¤åˆ¶å»¶è¿Ÿç›‘æ§
---
## ğŸ“š ç›®å½•

1. [pt-heartbeatå·¥å…·æ¦‚è¿°](#1-pt-heartbeatå·¥å…·æ¦‚è¿°)
2. [å¿ƒè·³è¡¨è®¾è®¡åŸç†](#2-å¿ƒè·³è¡¨è®¾è®¡åŸç†)
3. [å¤åˆ¶å»¶è¿Ÿè®¡ç®—æœºåˆ¶](#3-å¤åˆ¶å»¶è¿Ÿè®¡ç®—æœºåˆ¶)
4. [ç›‘æ§æ•°æ®æ”¶é›†ä¸å­˜å‚¨](#4-ç›‘æ§æ•°æ®æ”¶é›†ä¸å­˜å‚¨)
5. [å»¶è¿Ÿé˜ˆå€¼å‘Šè­¦é…ç½®](#5-å»¶è¿Ÿé˜ˆå€¼å‘Šè­¦é…ç½®)
6. [å¤šä»åº“ç›‘æ§ç®¡ç†](#6-å¤šä»åº“ç›‘æ§ç®¡ç†)
7. [ç½‘ç»œå»¶è¿Ÿæ’é™¤æŠ€å·§](#7-ç½‘ç»œå»¶è¿Ÿæ’é™¤æŠ€å·§)
8. [è‡ªåŠ¨åŒ–ç›‘æ§éƒ¨ç½²](#8-è‡ªåŠ¨åŒ–ç›‘æ§éƒ¨ç½²)
9. [å›¾å½¢åŒ–å±•ç¤ºé›†æˆ](#9-å›¾å½¢åŒ–å±•ç¤ºé›†æˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” pt-heartbeatå·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯pt-heartbeat


**ç®€å•ç†è§£**ï¼špt-heartbeatå°±åƒæ˜¯ç»™MySQLä¸»ä»å¤åˆ¶è£…äº†ä¸€ä¸ª"å¿ƒè·³ç›‘æµ‹å™¨"ï¼Œä¸“é—¨ç”¨æ¥æ£€æµ‹æ•°æ®åŒæ­¥çš„å»¶è¿Ÿæƒ…å†µã€‚

```
æƒ³è±¡ä¸€ä¸‹åŒ»é™¢çš„å¿ƒç”µå›¾ç›‘æµ‹ï¼š
åŒ»ç”Ÿéœ€è¦å®æ—¶çœ‹åˆ°ç—…äººçš„å¿ƒè·³æƒ…å†µ
pt-heartbeatå°±æ˜¯MySQLå¤åˆ¶çš„"å¿ƒç”µå›¾"
å®æ—¶ç›‘æµ‹æ•°æ®åŒæ­¥çš„"å¿ƒè·³"çŠ¶æ€
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **å»¶è¿Ÿç›‘æµ‹**ï¼šå‡†ç¡®æµ‹é‡ä¸»ä»å¤åˆ¶çš„å»¶è¿Ÿæ—¶é—´
- **å®æ—¶å‘Šè­¦**ï¼šå½“å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼æ—¶åŠæ—¶é€šçŸ¥
- **å†å²è®°å½•**ï¼šä¿å­˜å»¶è¿Ÿæ•°æ®ç”¨äºåˆ†æè¶‹åŠ¿
- **å¤šåº“æ”¯æŒ**ï¼šå¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªä»åº“

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§å¤åˆ¶å»¶è¿Ÿ


**ç°å®åœºæ™¯ç†è§£**ï¼š
```
ç”µå•†ç½‘ç«™çš„å…¸å‹é—®é¢˜ï¼š
ç”¨æˆ·åœ¨ä¸»åº“ä¸‹å• â†’ è®¢å•å†™å…¥æˆåŠŸ
ç«‹å³æŸ¥è¯¢è®¢å•çŠ¶æ€ â†’ æŸ¥è¯¢ä»åº“
å¦‚æœä»åº“å»¶è¿Ÿ5ç§’ â†’ ç”¨æˆ·çœ‹ä¸åˆ°è®¢å•
ç”¨æˆ·ä»¥ä¸ºä¸‹å•å¤±è´¥ â†’ é‡å¤ä¸‹å•
```

**å»¶è¿Ÿçš„å±å®³**ï¼š
- **æ•°æ®ä¸ä¸€è‡´**ï¼šè¯»å†™åˆ†ç¦»æ—¶å¯èƒ½è¯»åˆ°æ—§æ•°æ®
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šä¾èµ–å®æ—¶æ•°æ®çš„åŠŸèƒ½å‡ºé”™
- **ç”¨æˆ·ä½“éªŒå·®**ï¼šé¡µé¢æ˜¾ç¤ºä¸åŠæ—¶
- **è¿ç»´å›°æ‰°**ï¼šä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™å‡ºé—®é¢˜

### 1.3 pt-heartbeatçš„å·¥ä½œæ€è·¯


**åŸºæœ¬åŸç†**ï¼š
```
ä¸»åº“ç«¯ï¼šæ¯ç§’å¾€å¿ƒè·³è¡¨æ’å…¥å½“å‰æ—¶é—´æˆ³
ä»åº“ç«¯ï¼šè¯»å–å¿ƒè·³è¡¨çš„æœ€æ–°æ—¶é—´æˆ³
å»¶è¿Ÿè®¡ç®—ï¼šå½“å‰æ—¶é—´ - å¿ƒè·³è¡¨æ—¶é—´ = å»¶è¿Ÿ
```

**ç±»æ¯”ç†è§£**ï¼š
```
å°±åƒä¸¤åœ°é€šä¿¡ï¼š
åŒ—äº¬æ€»éƒ¨æ¯åˆ†é’Ÿå‘ä¸€æ¬¡æ—¶é—´æŠ¥å‘Šï¼š"ç°åœ¨æ˜¯10:30"
ä¸Šæµ·åˆ†éƒ¨æ”¶åˆ°åå¯¹æ¯”æœ¬åœ°æ—¶é—´
å¦‚æœåˆ†éƒ¨10:32æ”¶åˆ°"10:30"çš„æŠ¥å‘Š
è¯´æ˜é€šä¿¡å»¶è¿Ÿäº†2åˆ†é’Ÿ
```

---

## 2. ğŸ’“ å¿ƒè·³è¡¨è®¾è®¡åŸç†


### 2.1 å¿ƒè·³è¡¨çš„ç»“æ„è®¾è®¡


**è¡¨ç»“æ„è¯´æ˜**ï¼š
```sql
-- pt-heartbeaté»˜è®¤åˆ›å»ºçš„å¿ƒè·³è¡¨
CREATE TABLE heartbeat (
    ts TIMESTAMP NOT NULL,          -- æ—¶é—´æˆ³å­—æ®µ
    server_id INT NOT NULL,         -- æœåŠ¡å™¨ID  
    file VARCHAR(255) DEFAULT NULL, -- binlogæ–‡ä»¶å
    position BIGINT DEFAULT NULL,   -- binlogä½ç½®
    relay_master_log_file VARCHAR(255) DEFAULT NULL,
    exec_master_log_pos BIGINT DEFAULT NULL,
    PRIMARY KEY (server_id)
);
```

**å­—æ®µå«ä¹‰é€šä¿—è§£é‡Š**ï¼š
- `ts`ï¼š**å¿ƒè·³æ—¶é—´** - ä¸»åº“å†™å…¥æ•°æ®çš„æ—¶é—´æˆ³
- `server_id`ï¼š**æœåŠ¡å™¨æ ‡è¯†** - åŒºåˆ†ä¸åŒçš„MySQLå®ä¾‹
- `file`ï¼š**æ—¥å¿—æ–‡ä»¶** - è®°å½•binlogæ–‡ä»¶ä½ç½®
- `position`ï¼š**æ—¥å¿—ä½ç½®** - ç²¾ç¡®å®šä½æ•°æ®ä½ç½®

### 2.2 å¿ƒè·³æ•°æ®å†™å…¥æœºåˆ¶


**ä¸»åº“å†™å…¥è¿‡ç¨‹**ï¼š
```bash
# pt-heartbeatåœ¨ä¸»åº“ä¸Šè¿è¡Œ
pt-heartbeat \
  --host=master-db \
  --user=monitor \
  --password=password \
  --database=test \
  --table=heartbeat \
  --update \           # æ›´æ–°æ¨¡å¼
  --interval=1         # æ¯ç§’æ›´æ–°ä¸€æ¬¡
```

**å®é™…æ‰§è¡Œçš„SQL**ï¼š
```sql
-- æ¯ç§’æ‰§è¡Œä¸€æ¬¡è¿™æ ·çš„æ›´æ–°
UPDATE heartbeat 
SET ts = NOW(), 
    file = 'mysql-bin.000123',
    position = 12345678
WHERE server_id = 1;
```

**æ•°æ®å†™å…¥æµç¨‹å›¾**ï¼š
```
ä¸»åº“pt-heartbeatç¨‹åº
        |
        | æ¯1ç§’æ‰§è¡Œ
        â†“
   UPDATE heartbeatè¡¨
        |
        | binlogè®°å½•
        â†“
    ä»åº“æ¥æ”¶binlog
        |
        | é‡æ”¾SQL
        â†“
   ä»åº“heartbeatè¡¨æ›´æ–°
```

### 2.3 ä¸ºä»€ä¹ˆç”¨UPDATEè€Œä¸æ˜¯INSERT


**UPDATEçš„ä¼˜åŠ¿**ï¼š
```
INSERTæ–¹å¼é—®é¢˜ï¼š
- è¡¨ä¼šæ— é™å¢é•¿ï¼Œå½±å“æ€§èƒ½
- éœ€è¦å®šæœŸæ¸…ç†å†å²æ•°æ®
- æŸ¥è¯¢æœ€æ–°è®°å½•éœ€è¦æ’åº

UPDATEæ–¹å¼ä¼˜åŠ¿ï¼š
- è¡¨å¤§å°å›ºå®šï¼ˆæ¯ä¸ªserver_idä¸€è¡Œï¼‰
- ä¸éœ€è¦æ¸…ç†æ•°æ®
- æŸ¥è¯¢é€Ÿåº¦å¿«ï¼ˆä¸»é”®æŸ¥è¯¢ï¼‰
```

**å¯¹æ¯”ç¤ºä¾‹**ï¼š
```sql
-- INSERTæ–¹å¼ï¼ˆä¸æ¨èï¼‰
INSERT INTO heartbeat (ts, server_id) VALUES (NOW(), 1);
-- è¡¨ä¼šä¸æ–­å¢é•¿ï¼š1è¡Œã€2è¡Œã€3è¡Œ...

-- UPDATEæ–¹å¼ï¼ˆæ¨èï¼‰  
UPDATE heartbeat SET ts = NOW() WHERE server_id = 1;
-- è¡¨å¤§å°å›ºå®šï¼šæ°¸è¿œåªæœ‰1è¡Œï¼ˆæ¯ä¸ªserver_idï¼‰
```

---

## 3. â±ï¸ å¤åˆ¶å»¶è¿Ÿè®¡ç®—æœºåˆ¶


### 3.1 å»¶è¿Ÿè®¡ç®—çš„åŸºæœ¬å…¬å¼


**æ ¸å¿ƒè®¡ç®—å…¬å¼**ï¼š
```
å¤åˆ¶å»¶è¿Ÿ = å½“å‰æ—¶é—´ - å¿ƒè·³è¡¨ä¸­çš„æ—¶é—´æˆ³
```

**é€šä¿—ç†è§£**ï¼š
```
å‡è®¾ç°åœ¨æ˜¯ä¸‹åˆ3ç‚¹æ•´ï¼š
ä¸»åº“åœ¨ä¸‹åˆ2:58åˆ†å†™å…¥å¿ƒè·³æ•°æ®
ä»åº“ç°åœ¨è¯»åˆ°çš„å¿ƒè·³æ—¶é—´æ˜¯2:58åˆ†  
å»¶è¿Ÿ = 3:00 - 2:58 = 2åˆ†é’Ÿ
```

### 3.2 ä»åº“å»¶è¿Ÿæ£€æµ‹å‘½ä»¤


**åŸºæœ¬æ£€æµ‹å‘½ä»¤**ï¼š
```bash
# åœ¨ä»åº“ä¸Šè¿è¡Œæ£€æµ‹
pt-heartbeat \
  --host=slave-db \
  --user=monitor \
  --password=password \
  --database=test \
  --table=heartbeat \
  --monitor \          # ç›‘æ§æ¨¡å¼
  --print \            # æ‰“å°ç»“æœ
  --interval=1         # æ¯ç§’æ£€æµ‹ä¸€æ¬¡
```

**è¾“å‡ºç»“æœç¤ºä¾‹**ï¼š
```
0.00s [01-15T10:30:01]  # å»¶è¿Ÿ0ç§’
0.50s [01-15T10:30:02]  # å»¶è¿Ÿ0.5ç§’  
2.31s [01-15T10:30:03]  # å»¶è¿Ÿ2.31ç§’
```

### 3.3 å»¶è¿Ÿè®¡ç®—çš„ç²¾ç¡®æ€§


**æ—¶é—´ç²¾åº¦è¯´æ˜**ï¼š
```sql
-- pt-heartbeatä½¿ç”¨çš„æ—¶é—´å‡½æ•°
SELECT NOW(6);  -- å¾®ç§’çº§ç²¾åº¦
-- ç»“æœï¼š2025-01-15 10:30:01.123456
```

**ç²¾åº¦å¯¹æ¯”**ï¼š
- **NOW()**ï¼šç§’çº§ç²¾åº¦ï¼Œå»¶è¿Ÿæ£€æµ‹è¯¯å·®å¯èƒ½è¾¾åˆ°1ç§’
- **NOW(6)**ï¼šå¾®ç§’çº§ç²¾åº¦ï¼Œå»¶è¿Ÿæ£€æµ‹ç²¾ç¡®åˆ°å¾®ç§’
- **å®é™…å»ºè®®**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¾®ç§’ç²¾åº¦

### 3.4 ç‰¹æ®Šæƒ…å†µçš„å¤„ç†


**æ—¶é’ŸåŒæ­¥é—®é¢˜**ï¼š
```
é—®é¢˜ï¼šä¸»ä»æœåŠ¡å™¨æ—¶é’Ÿä¸åŒæ­¥
ä¸»åº“æ—¶é—´ï¼š10:30:00
ä»åº“æ—¶é—´ï¼š10:29:50ï¼ˆæ…¢10ç§’ï¼‰

é”™è¯¯è®¡ç®—ï¼š10:29:50 - 10:30:00 = -10ç§’ï¼ˆè´Ÿå»¶è¿Ÿï¼Ÿï¼‰
æ­£ç¡®åšæ³•ï¼šç¡®ä¿æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥ï¼ˆä½¿ç”¨NTPï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å®‰è£…NTPæœåŠ¡
yum install -y ntp

# é…ç½®æ—¶é’ŸåŒæ­¥
ntpdate -s time.nist.gov

# è®¾ç½®å®šæ—¶åŒæ­¥
echo "0 */6 * * * /usr/sbin/ntpdate time.nist.gov" | crontab -
```

---

## 4. ğŸ“Š ç›‘æ§æ•°æ®æ”¶é›†ä¸å­˜å‚¨


### 4.1 æ•°æ®æ”¶é›†æ–¹å¼


**å®æ—¶ç›‘æ§æ¨¡å¼**ï¼š
```bash
# æŒç»­ç›‘æ§å¹¶æ˜¾ç¤ºç»“æœ
pt-heartbeat \
  --monitor \
  --host=slave1 \
  --database=test \
  --print \
  --interval=1
```

**æ•°æ®å­˜å‚¨æ¨¡å¼**ï¼š
```bash
# å°†ç›‘æ§æ•°æ®å­˜å‚¨åˆ°æ–‡ä»¶
pt-heartbeat \
  --monitor \
  --host=slave1 \
  --database=test \
  --log=/var/log/mysql/heartbeat.log \
  --interval=5
```

### 4.2 ç›‘æ§æ•°æ®æ ¼å¼


**æ—¥å¿—æ–‡ä»¶æ ¼å¼**ï¼š
```
# /var/log/mysql/heartbeat.log
2025-01-15T10:30:01 0.23
2025-01-15T10:30:06 0.45  
2025-01-15T10:30:11 1.20
2025-01-15T10:30:16 0.33
```

**æ•°æ®å­—æ®µè¯´æ˜**ï¼š
- **æ—¶é—´æˆ³**ï¼šæ£€æµ‹æ—¶é—´
- **å»¶è¿Ÿå€¼**ï¼šä»¥ç§’ä¸ºå•ä½çš„å»¶è¿Ÿæ—¶é—´

### 4.3 æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ


**åˆ›å»ºç›‘æ§ç»“æœè¡¨**ï¼š
```sql
-- åˆ›å»ºå»¶è¿Ÿç›‘æ§ç»“æœè¡¨
CREATE TABLE replication_lag (
    id INT AUTO_INCREMENT PRIMARY KEY,
    slave_host VARCHAR(100) NOT NULL,
    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    lag_seconds DECIMAL(10,6) NOT NULL,
    INDEX idx_slave_time (slave_host, check_time)
);
```

**æ•°æ®å…¥åº“è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ç›‘æ§æ•°æ®å…¥åº“è„šæœ¬

while true; do
    LAG=$(pt-heartbeat --monitor --host=slave1 --database=test --frames=1)
    
    mysql -e "INSERT INTO monitor.replication_lag (slave_host, lag_seconds) 
              VALUES ('slave1', $LAG);"
              
    sleep 10
done
```

### 4.4 æ•°æ®æ¸…ç†ç­–ç•¥


**å†å²æ•°æ®æ¸…ç†**ï¼š
```sql
-- æ¸…ç†7å¤©å‰çš„ç›‘æ§æ•°æ®
DELETE FROM replication_lag 
WHERE check_time < DATE_SUB(NOW(), INTERVAL 7 DAY);

-- è®¾ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡
CREATE EVENT clean_old_lag_data
ON SCHEDULE EVERY 1 DAY
DO DELETE FROM replication_lag 
   WHERE check_time < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

---

## 5. ğŸš¨ å»¶è¿Ÿé˜ˆå€¼å‘Šè­¦é…ç½®


### 5.1 é˜ˆå€¼å‘Šè­¦çš„åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯é˜ˆå€¼å‘Šè­¦**ï¼š
```
é˜ˆå€¼ï¼šè®¾å®šä¸€ä¸ªå»¶è¿Ÿçš„"è­¦æˆ’çº¿"
æ¯”å¦‚ï¼šå»¶è¿Ÿè¶…è¿‡5ç§’å°±å‘Šè­¦
ç›®çš„ï¼šåŠæ—¶å‘ç°å¤åˆ¶é—®é¢˜
```

**å‘Šè­¦çº§åˆ«è®¾è®¡**ï¼š
- **è½»å¾®å»¶è¿Ÿ**ï¼š1-3ç§’ï¼Œå‘é€é‚®ä»¶é€šçŸ¥
- **ä¸­åº¦å»¶è¿Ÿ**ï¼š3-10ç§’ï¼Œå‘é€çŸ­ä¿¡å‘Šè­¦  
- **ä¸¥é‡å»¶è¿Ÿ**ï¼š>10ç§’ï¼Œç”µè¯å‘Šè­¦

### 5.2 Shellè„šæœ¬å‘Šè­¦å®ç°


**åŸºç¡€å‘Šè­¦è„šæœ¬**ï¼š
```bash
#!/bin/bash
# replication_alert.sh - å¤åˆ¶å»¶è¿Ÿå‘Šè­¦è„šæœ¬

# é…ç½®å‚æ•°
SLAVE_HOST="slave1"
WARNING_THRESHOLD=3    # è­¦å‘Šé˜ˆå€¼ï¼š3ç§’
CRITICAL_THRESHOLD=10  # ä¸¥é‡é˜ˆå€¼ï¼š10ç§’
EMAIL="admin@company.com"

# è·å–å½“å‰å»¶è¿Ÿ
LAG=$(pt-heartbeat --monitor --host=$SLAVE_HOST --database=test --frames=1)

# å»¶è¿Ÿæ£€æŸ¥å’Œå‘Šè­¦
if (( $(echo "$LAG > $CRITICAL_THRESHOLD" | bc -l) )); then
    echo "CRITICAL: Replication lag is ${LAG}s" | \
    mail -s "MySQL Replication CRITICAL Alert" $EMAIL
    
elif (( $(echo "$LAG > $WARNING_THRESHOLD" | bc -l) )); then
    echo "WARNING: Replication lag is ${LAG}s" | \
    mail -s "MySQL Replication Warning" $EMAIL
fi
```

### 5.3 é«˜çº§å‘Šè­¦é…ç½®


**å¸¦æ¢å¤é€šçŸ¥çš„å‘Šè­¦**ï¼š
```bash
#!/bin/bash
# advanced_alert.sh - é«˜çº§å‘Šè­¦è„šæœ¬

LOCK_FILE="/tmp/replication_alert.lock"
LAG=$(pt-heartbeat --monitor --host=slave1 --database=test --frames=1)

if (( $(echo "$LAG > 5" | bc -l) )); then
    # å¦‚æœå»¶è¿Ÿè¶…è¿‡5ç§’ä¸”æœªå‘Šè­¦è¿‡
    if [ ! -f $LOCK_FILE ]; then
        echo "Alert: Replication lag is ${LAG}s" | \
        mail -s "MySQL Replication Alert" admin@company.com
        
        # åˆ›å»ºå‘Šè­¦é”æ–‡ä»¶
        echo $LAG > $LOCK_FILE
    fi
else
    # å¦‚æœå»¶è¿Ÿæ¢å¤æ­£å¸¸ä¸”ä¹‹å‰æœ‰å‘Šè­¦
    if [ -f $LOCK_FILE ]; then
        echo "Recovery: Replication lag is now ${LAG}s" | \
        mail -s "MySQL Replication Recovered" admin@company.com
        
        # åˆ é™¤å‘Šè­¦é”æ–‡ä»¶
        rm -f $LOCK_FILE
    fi
fi
```

### 5.4 é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ


**Zabbixé›†æˆç¤ºä¾‹**ï¼š
```bash
# åˆ›å»ºZabbixç›‘æ§é¡¹è„šæœ¬
#!/bin/bash
# /etc/zabbix/scripts/mysql_lag.sh

pt-heartbeat --monitor --host=slave1 --database=test --frames=1
```

**Zabbixé…ç½®**ï¼š
```
ç›‘æ§é¡¹é…ç½®ï¼š
- Name: MySQL Replication Lag
- Type: External check  
- Key: mysql_lag.sh
- Update interval: 30s

è§¦å‘å™¨é…ç½®ï¼š
- Expression: {host:mysql_lag.sh.last()}>5
- Severity: High
- Description: MySQL replication lag > 5 seconds
```

---

## 6. ğŸ”„ å¤šä»åº“ç›‘æ§ç®¡ç†


### 6.1 å¤šä»åº“æ¶æ„åœºæ™¯


**å…¸å‹å¤šä»åº“æ¶æ„**ï¼š
```
          ä¸»åº“ (Master)
             |
    +--------+--------+
    |        |        |
  ä»åº“1    ä»åº“2    ä»åº“3
 (è¯»ä¸šåŠ¡)  (å¤‡ä»½)   (åˆ†æ)
```

**ç›‘æ§éœ€æ±‚**ï¼š
- æ¯ä¸ªä»åº“éƒ½éœ€è¦ç‹¬ç«‹ç›‘æ§
- ä¸åŒä»åº“å¯èƒ½æœ‰ä¸åŒçš„å»¶è¿Ÿè¦æ±‚
- éœ€è¦ç»Ÿä¸€çš„ç›‘æ§è§†å›¾

### 6.2 å¤šä»åº“ç›‘æ§è„šæœ¬


**å¹¶è¡Œç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# multi_slave_monitor.sh - å¤šä»åº“ç›‘æ§è„šæœ¬

# ä»åº“åˆ—è¡¨
SLAVES=(
    "slave1:3306"
    "slave2:3306" 
    "slave3:3306"
)

# ç›‘æ§å‡½æ•°
monitor_slave() {
    local slave_host=$1
    local lag=$(pt-heartbeat --monitor --host=$slave_host --database=test --frames=1)
    
    echo "$(date '+%Y-%m-%d %H:%M:%S') $slave_host $lag" >> /var/log/mysql/multi_slave_lag.log
    
    # æ£€æŸ¥å‘Šè­¦é˜ˆå€¼
    if (( $(echo "$lag > 5" | bc -l) )); then
        echo "ALERT: $slave_host lag is ${lag}s" | \
        mail -s "Slave $slave_host Alert" admin@company.com
    fi
}

# å¹¶è¡Œç›‘æ§æ‰€æœ‰ä»åº“
for slave in "${SLAVES[@]}"; do
    monitor_slave $slave &
done

# ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
wait
```

### 6.3 é…ç½®æ–‡ä»¶ç®¡ç†


**ç›‘æ§é…ç½®æ–‡ä»¶**ï¼š
```ini
# /etc/mysql/heartbeat.conf
[master]
host=master-db
port=3306
user=monitor
password=monitor123
database=test

[slave1]
host=slave1
port=3306
threshold_warning=3
threshold_critical=10
email=team1@company.com

[slave2]  
host=slave2
port=3306
threshold_warning=5
threshold_critical=15
email=team2@company.com
```

**è¯»å–é…ç½®çš„è„šæœ¬**ï¼š
```bash
#!/bin/bash
# è¯»å–é…ç½®æ–‡ä»¶è¿›è¡Œç›‘æ§

CONFIG_FILE="/etc/mysql/heartbeat.conf"

# è¯»å–é…ç½®å‡½æ•°
get_config() {
    local section=$1
    local key=$2
    awk -F= -v section="[$section]" -v key="$key" '
        $0 == section { in_section=1; next }
        /^\[/ { in_section=0 }
        in_section && $1 == key { print $2; exit }
    ' $CONFIG_FILE
}

# ç›‘æ§slave1
SLAVE1_HOST=$(get_config "slave1" "host")
SLAVE1_THRESHOLD=$(get_config "slave1" "threshold_warning")

LAG=$(pt-heartbeat --monitor --host=$SLAVE1_HOST --database=test --frames=1)

if (( $(echo "$LAG > $SLAVE1_THRESHOLD" | bc -l) )); then
    echo "Slave1 lag: ${LAG}s exceeds threshold: ${SLAVE1_THRESHOLD}s"
fi
```

### 6.4 ç›‘æ§çŠ¶æ€æ±‡æ€»


**çŠ¶æ€æ±‡æ€»è„šæœ¬**ï¼š
```bash
#!/bin/bash
# slave_status_summary.sh - ä»åº“çŠ¶æ€æ±‡æ€»

echo "=== MySQL Replication Status Summary ==="
echo "Time: $(date)"
echo "========================================="

SLAVES=("slave1" "slave2" "slave3")

for slave in "${SLAVES[@]}"; do
    LAG=$(pt-heartbeat --monitor --host=$slave --database=test --frames=1 2>/dev/null)
    
    if [ $? -eq 0 ]; then
        if (( $(echo "$LAG > 5" | bc -l) )); then
            STATUS="âŒ ALERT"
        elif (( $(echo "$LAG > 1" | bc -l) )); then
            STATUS="âš ï¸  WARNING"  
        else
            STATUS="âœ… OK"
        fi
        
        printf "%-10s: %8.2fs %s\n" $slave $LAG "$STATUS"
    else
        printf "%-10s: %8s %s\n" $slave "ERROR" "âŒ FAILED"
    fi
done

echo "========================================="
```

---

## 7. ğŸŒ ç½‘ç»œå»¶è¿Ÿæ’é™¤æŠ€å·§


### 7.1 ç½‘ç»œå»¶è¿Ÿä¸å¤åˆ¶å»¶è¿Ÿçš„åŒºåˆ«


**æ¦‚å¿µåŒºåˆ†**ï¼š
```
ç½‘ç»œå»¶è¿Ÿï¼šæ•°æ®åŒ…åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„æ—¶é—´
å¤åˆ¶å»¶è¿Ÿï¼šä»ä¸»åº“å†™å…¥åˆ°ä»åº“æ‰§è¡Œå®Œæˆçš„æ€»æ—¶é—´

å¤åˆ¶å»¶è¿Ÿ = ç½‘ç»œå»¶è¿Ÿ + SQLæ‰§è¡Œå»¶è¿Ÿ + å…¶ä»–å¼€é”€
```

**å®é™…åœºæ™¯**ï¼š
```
ä¸»åº“åœ¨åŒ—äº¬ï¼Œä»åº“åœ¨ä¸Šæµ·ï¼š
- ç½‘ç»œå»¶è¿Ÿï¼š30ms
- SQLæ‰§è¡Œå»¶è¿Ÿï¼š100ms  
- æ€»å¤åˆ¶å»¶è¿Ÿï¼š130ms

å¦‚æœçœ‹åˆ°å¤åˆ¶å»¶è¿Ÿ500msï¼š
- å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼ˆç½‘ç»œå»¶è¿Ÿå˜æˆ470msï¼‰
- å¯èƒ½æ˜¯ä»åº“æ€§èƒ½é—®é¢˜ï¼ˆSQLæ‰§è¡Œå˜æ…¢ï¼‰
```

### 7.2 ç½‘ç»œå»¶è¿Ÿæµ‹è¯•æ–¹æ³•


**åŸºç¡€ç½‘ç»œæµ‹è¯•**ï¼š
```bash
# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping -c 10 slave-host

# æµ‹è¯•MySQLè¿æ¥å»¶è¿Ÿ
time mysql -h slave-host -e "SELECT 1;"

# æµ‹è¯•æŒç»­ç½‘ç»œè´¨é‡
mtr --report --report-cycles=100 slave-host
```

**MySQLä¸“ç”¨ç½‘ç»œæµ‹è¯•**ï¼š
```bash
# æµ‹è¯•MySQLç½‘ç»œå»¶è¿Ÿ
#!/bin/bash
start_time=$(date +%s.%N)
mysql -h slave-host -e "SELECT NOW();" > /dev/null
end_time=$(date +%s.%N)

network_delay=$(echo "$end_time - $start_time" | bc)
echo "MySQL network delay: ${network_delay}s"
```

### 7.3 æ’é™¤ç½‘ç»œå› ç´ çš„æŠ€å·§


**æœ¬åœ°å»¶è¿Ÿæµ‹è¯•**ï¼š
```bash
# åœ¨ä»åº“æœ¬åœ°æµ‹è¯•ï¼ˆæ’é™¤ç½‘ç»œå› ç´ ï¼‰
# ç›´æ¥è¿æ¥æœ¬åœ°MySQLæŸ¥çœ‹å»¶è¿Ÿ
pt-heartbeat --monitor --host=localhost --database=test --frames=1
```

**å¯¹æ¯”æµ‹è¯•æ–¹æ³•**ï¼š
```bash
#!/bin/bash
# network_vs_replication.sh - ç½‘ç»œä¸å¤åˆ¶å»¶è¿Ÿå¯¹æ¯”

# æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ
NETWORK_DELAY=$(time mysql -h slave-host -e "SELECT 1;" 2>&1 | grep real | awk '{print $2}')

# æµ‹è¯•å¤åˆ¶å»¶è¿Ÿ  
REPLICATION_LAG=$(pt-heartbeat --monitor --host=slave-host --database=test --frames=1)

echo "Network delay: $NETWORK_DELAY"
echo "Replication lag: $REPLICATION_LAG"

# åˆ¤æ–­ä¸»è¦é—®é¢˜
if (( $(echo "$REPLICATION_LAG > $NETWORK_DELAY * 10" | bc -l) )); then
    echo "Primary issue: Replication performance"
else
    echo "Primary issue: Network latency"
fi
```

### 7.4 ç½‘ç»œä¼˜åŒ–å»ºè®®


**ç½‘ç»œé…ç½®ä¼˜åŒ–**ï¼š
```bash
# TCPçª—å£å¤§å°ä¼˜åŒ–
echo 'net.core.rmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 134217728' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_rmem = 4096 87380 134217728' >> /etc/sysctl.conf

# åº”ç”¨é…ç½®
sysctl -p
```

**MySQLç½‘ç»œä¼˜åŒ–**ï¼š
```sql
-- å¢åŠ ç½‘ç»œç¼“å†²åŒº
SET GLOBAL slave_net_timeout = 120;
SET GLOBAL slave_compressed_protocol = 1;  -- å¯ç”¨å‹ç¼©

-- æ‰¹é‡ä¼ è¾“ä¼˜åŒ–
SET GLOBAL slave_pending_jobs_size_max = 134217728;
```

---

## 8. ğŸ¤– è‡ªåŠ¨åŒ–ç›‘æ§éƒ¨ç½²


### 8.1 è‡ªåŠ¨åŒ–éƒ¨ç½²çš„ç›®æ ‡


**éƒ¨ç½²ç›®æ ‡**ï¼š
- **ä¸€é”®éƒ¨ç½²**ï¼šç®€åŒ–ç›‘æ§ç³»ç»Ÿçš„å®‰è£…é…ç½®
- **æ ‡å‡†åŒ–**ï¼šç¡®ä¿æ‰€æœ‰ç¯å¢ƒé…ç½®ä¸€è‡´
- **å¯æ‰©å±•**ï¼šæ–¹ä¾¿æ·»åŠ æ–°çš„ä»åº“ç›‘æ§
- **æ˜“ç»´æŠ¤**ï¼šä¾¿äºå‡çº§å’Œæ•…éšœæ’æŸ¥

### 8.2 Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²


**ç›®å½•ç»“æ„**ï¼š
```
mysql-heartbeat-monitor/
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ hosts              # ä¸»æœºæ¸…å•
â”œâ”€â”€ playbooks/
â”‚   â””â”€â”€ deploy.yml         # éƒ¨ç½²å‰§æœ¬
â”œâ”€â”€ roles/
â”‚   â””â”€â”€ heartbeat/
â”‚       â”œâ”€â”€ tasks/main.yml
â”‚       â”œâ”€â”€ templates/
â”‚       â””â”€â”€ files/
â””â”€â”€ group_vars/
    â””â”€â”€ all.yml            # å…¨å±€å˜é‡
```

**ä¸»æœºæ¸…å•é…ç½®**ï¼š
```ini
# inventory/hosts
[mysql_masters]
master-db ansible_host=192.168.1.10

[mysql_slaves]  
slave1 ansible_host=192.168.1.11
slave2 ansible_host=192.168.1.12
slave3 ansible_host=192.168.1.13

[mysql:children]
mysql_masters
mysql_slaves
```

**éƒ¨ç½²å‰§æœ¬**ï¼š
```yaml
# playbooks/deploy.yml
---
- name: Deploy pt-heartbeat monitoring
  hosts: mysql
  become: yes
  
  tasks:
    - name: Install Percona Toolkit
      yum:
        name: percona-toolkit
        state: present
        
    - name: Create heartbeat database
      mysql_db:
        name: heartbeat_monitor
        state: present
      when: inventory_hostname in groups['mysql_masters']
      
    - name: Create heartbeat table
      mysql_query:
        query: |
          CREATE TABLE IF NOT EXISTS heartbeat_monitor.heartbeat (
            ts TIMESTAMP NOT NULL,
            server_id INT NOT NULL,
            file VARCHAR(255) DEFAULT NULL,
            position BIGINT DEFAULT NULL,
            PRIMARY KEY (server_id)
          );
      when: inventory_hostname in groups['mysql_masters']
      
    - name: Deploy heartbeat update script
      template:
        src: heartbeat_update.sh.j2
        dest: /usr/local/bin/heartbeat_update.sh
        mode: '0755'
      when: inventory_hostname in groups['mysql_masters']
      
    - name: Deploy heartbeat monitor script  
      template:
        src: heartbeat_monitor.sh.j2
        dest: /usr/local/bin/heartbeat_monitor.sh
        mode: '0755'
      when: inventory_hostname in groups['mysql_slaves']
```

### 8.3 Dockerå®¹å™¨åŒ–éƒ¨ç½²


**Dockerfile**ï¼š
```dockerfile
# Dockerfile
FROM centos:7

# å®‰è£…ä¾èµ–
RUN yum install -y wget mysql

# å®‰è£…Percona Toolkit
RUN wget https://repo.percona.com/yum/percona-release-latest.noarch.rpm && \
    rpm -ivh percona-release-latest.noarch.rpm && \
    yum install -y percona-toolkit

# å¤åˆ¶ç›‘æ§è„šæœ¬
COPY scripts/ /usr/local/bin/
RUN chmod +x /usr/local/bin/*.sh

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¯åŠ¨è„šæœ¬
CMD ["/usr/local/bin/start_monitor.sh"]
```

**Docker Composeé…ç½®**ï¼š
```yaml
# docker-compose.yml  
version: '3.8'

services:
  heartbeat-monitor:
    build: .
    environment:
      - MYSQL_MASTER_HOST=master-db
      - MYSQL_SLAVE_HOSTS=slave1,slave2,slave3
      - MYSQL_USER=monitor
      - MYSQL_PASSWORD=password
      - CHECK_INTERVAL=10
      - ALERT_THRESHOLD=5
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    restart: unless-stopped
```

### 8.4 ç›‘æ§è„šæœ¬æ¨¡æ¿


**å¯åŠ¨è„šæœ¬æ¨¡æ¿**ï¼š
```bash
#!/bin/bash
# start_monitor.sh - ç›‘æ§å¯åŠ¨è„šæœ¬

# ç¯å¢ƒå˜é‡æ£€æŸ¥
: ${MYSQL_MASTER_HOST:?"MYSQL_MASTER_HOST is required"}
: ${MYSQL_SLAVE_HOSTS:?"MYSQL_SLAVE_HOSTS is required"}

# åˆ†å‰²ä»åº“åˆ—è¡¨
IFS=',' read -ra SLAVES <<< "$MYSQL_SLAVE_HOSTS"

# å¯åŠ¨ä¸»åº“å¿ƒè·³æ›´æ–°
if [ "$MYSQL_MASTER_HOST" ]; then
    echo "Starting heartbeat update on master: $MYSQL_MASTER_HOST"
    /usr/local/bin/heartbeat_update.sh &
fi

# å¯åŠ¨ä»åº“å»¶è¿Ÿç›‘æ§
for slave in "${SLAVES[@]}"; do
    echo "Starting lag monitor for slave: $slave"
    /usr/local/bin/heartbeat_monitor.sh "$slave" &
done

# ä¿æŒå®¹å™¨è¿è¡Œ
wait
```

**é…ç½®æ–‡ä»¶ç”Ÿæˆ**ï¼š
```bash
#!/bin/bash
# generate_config.sh - ç”Ÿæˆé…ç½®æ–‡ä»¶

cat > /app/config/heartbeat.conf << EOF
[master]
host=${MYSQL_MASTER_HOST}
user=${MYSQL_USER}
password=${MYSQL_PASSWORD}
database=heartbeat_monitor

$(for slave in "${SLAVES[@]}"; do
    echo "[${slave}]"
    echo "host=${slave}"
    echo "threshold=${ALERT_THRESHOLD:-5}"
    echo
done)
EOF
```

---

## 9. ğŸ“ˆ å›¾å½¢åŒ–å±•ç¤ºé›†æˆ


### 9.1 Grafanaé›†æˆæ–¹æ¡ˆ


**æ•°æ®æºé…ç½®**ï¼š
```sql
-- åˆ›å»ºGrafanaæ•°æ®æºè¡¨
CREATE TABLE grafana_heartbeat (
    id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    slave_host VARCHAR(100) NOT NULL,
    lag_seconds DECIMAL(10,6) NOT NULL,
    INDEX idx_time_host (timestamp, slave_host)
);
```

**æ•°æ®é‡‡é›†è„šæœ¬**ï¼š
```bash
#!/bin/bash
# grafana_collector.sh - Grafanaæ•°æ®é‡‡é›†

SLAVES=("slave1" "slave2" "slave3")

while true; do
    for slave in "${SLAVES[@]}"; do
        LAG=$(pt-heartbeat --monitor --host=$slave --database=test --frames=1 2>/dev/null)
        
        if [ $? -eq 0 ]; then
            mysql -e "INSERT INTO monitor.grafana_heartbeat (slave_host, lag_seconds) 
                      VALUES ('$slave', $LAG);"
        fi
    done
    
    sleep 10
done
```

### 9.2 Grafana Dashboardé…ç½®


**Panelé…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "title": "MySQL Replication Lag",
  "type": "graph",
  "targets": [
    {
      "rawSql": "SELECT timestamp as time, lag_seconds as value, slave_host FROM grafana_heartbeat WHERE $__timeFilter(timestamp) ORDER BY timestamp",
      "format": "time_series"
    }
  ],
  "yAxes": [
    {
      "label": "Lag (seconds)",
      "min": 0
    }
  ],
  "alert": {
    "conditions": [
      {
        "query": {"params": ["A", "5m", "now"]},
        "reducer": {"params": [], "type": "avg"},
        "evaluator": {"params": [5], "type": "gt"}
      }
    ]
  }
}
```

### 9.3 å®æ—¶ç›‘æ§å¤§å±


**Webç›‘æ§é¡µé¢**ï¼š
```html
<!DOCTYPE html>
<html>
<head>
    <title>MySQL Replication Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-card {
            display: inline-block;
            margin: 10px;
            padding: 20px;
            border-radius: 8px;
            min-width: 200px;
        }
        .status-ok { background-color: #d4edda; }
        .status-warning { background-color: #fff3cd; }
        .status-error { background-color: #f8d7da; }
    </style>
</head>
<body>
    <h1>MySQL Replication Status</h1>
    
    <div id="status-cards"></div>
    
    <canvas id="lagChart" width="800" height="400"></canvas>
    
    <script>
        // è·å–ç›‘æ§æ•°æ®
        async function fetchLagData() {
            const response = await fetch('/api/replication-lag');
            return await response.json();
        }
        
        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        function updateStatusCards(data) {
            const container = document.getElementById('status-cards');
            container.innerHTML = '';
            
            data.forEach(slave => {
                const card = document.createElement('div');
                card.className = `status-card ${getStatusClass(slave.lag)}`;
                card.innerHTML = `
                    <h3>${slave.host}</h3>
                    <p>Lag: ${slave.lag.toFixed(2)}s</p>
                    <p>Status: ${getStatusText(slave.lag)}</p>
                `;
                container.appendChild(card);
            });
        }
        
        function getStatusClass(lag) {
            if (lag < 1) return 'status-ok';
            if (lag < 5) return 'status-warning';
            return 'status-error';
        }
        
        function getStatusText(lag) {
            if (lag < 1) return 'OK';
            if (lag < 5) return 'WARNING';
            return 'CRITICAL';
        }
        
        // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(async () => {
            const data = await fetchLagData();
            updateStatusCards(data);
        }, 10000);
    </script>
</body>
</html>
```

### 9.4 ç§»åŠ¨ç«¯å‘Šè­¦åº”ç”¨


**å¾®ä¿¡å°ç¨‹åºå‘Šè­¦**ï¼š
```javascript
// å°ç¨‹åºå‘Šè­¦æ¨é€
const sendWechatAlert = (slaveHost, lagSeconds) => {
    const message = {
        touser: '@all',
        msgtype: 'text',
        text: {
            content: `MySQLå¤åˆ¶å‘Šè­¦\nä»åº“: ${slaveHost}\nå»¶è¿Ÿ: ${lagSeconds}ç§’\næ—¶é—´: ${new Date().toLocaleString()}`
        }
    };
    
    // å‘é€åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤
    wx.request({
        url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send',
        method: 'POST',
        data: message
    });
};
```

**é’‰é’‰æœºå™¨äººå‘Šè­¦**ï¼š
```bash
#!/bin/bash
# dingtalk_alert.sh - é’‰é’‰å‘Šè­¦

WEBHOOK_URL="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
SLAVE_HOST=$1  
LAG_SECONDS=$2

curl -X POST "$WEBHOOK_URL" \
     -H 'Content-Type: application/json' \
     -d '{
         "msgtype": "text",
         "text": {
             "content": "MySQLå¤åˆ¶å»¶è¿Ÿå‘Šè­¦\nä»åº“: '$SLAVE_HOST'\nå»¶è¿Ÿ: '$LAG_SECONDS'ç§’\nè¯·åŠæ—¶å¤„ç†ï¼"
         }
     }'
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ pt-heartbeatå·¥ä½œåŸç†ï¼šé€šè¿‡å¿ƒè·³è¡¨ç›‘æµ‹ä¸»ä»å¤åˆ¶å»¶è¿Ÿ
ğŸ”¸ å¿ƒè·³è¡¨è®¾è®¡ï¼šä½¿ç”¨UPDATEè€ŒéINSERTï¼Œä¿æŒè¡¨å¤§å°å›ºå®š
ğŸ”¸ å»¶è¿Ÿè®¡ç®—å…¬å¼ï¼šå½“å‰æ—¶é—´ - å¿ƒè·³è¡¨æ—¶é—´æˆ³ = å¤åˆ¶å»¶è¿Ÿ  
ğŸ”¸ ç›‘æ§éƒ¨ç½²æ–¹å¼ï¼šä¸»åº“æ›´æ–°å¿ƒè·³ï¼Œä»åº“æ£€æµ‹å»¶è¿Ÿ
ğŸ”¸ å‘Šè­¦æœºåˆ¶é…ç½®ï¼šè®¾ç½®é˜ˆå€¼ï¼ŒåŠæ—¶å‘ç°å¤åˆ¶é—®é¢˜
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§å¤åˆ¶å»¶è¿Ÿ**
```
ä¸šåŠ¡å½±å“ï¼š
- è¯»å†™åˆ†ç¦»æ—¶å¯èƒ½è¯»åˆ°æ—§æ•°æ®
- ä¾èµ–å®æ—¶æ•°æ®çš„åŠŸèƒ½å¼‚å¸¸
- å½±å“ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡æ­£ç¡®æ€§

æŠ€æœ¯ä»·å€¼ï¼š
- åŠæ—¶å‘ç°å¤åˆ¶é—®é¢˜
- ä¸ºæ€§èƒ½ä¼˜åŒ–æä¾›æ•°æ®æ”¯æ’‘
- ä¿éšœæ•°æ®ä¸€è‡´æ€§
```

**ğŸ”¹ pt-heartbeat vs SHOW SLAVE STATUS**
```
SHOW SLAVE STATUSé—®é¢˜ï¼š
- Seconds_Behind_Masterä¸å¤Ÿå‡†ç¡®
- æ— æ³•è®°å½•å†å²æ•°æ®
- ä¸æ”¯æŒè‡ªå®šä¹‰å‘Šè­¦

pt-heartbeatä¼˜åŠ¿ï¼š  
- åŸºäºå®é™…æ•°æ®ä¼ è¾“æµ‹é‡
- å¯ä»¥è®°å½•è¯¦ç»†çš„å†å²æ•°æ®
- æ”¯æŒçµæ´»çš„å‘Šè­¦é…ç½®
```

**ğŸ”¹ ç›‘æ§ç³»ç»Ÿè®¾è®¡è¦ç‚¹**
```
å¯é æ€§ï¼šé¿å…å•ç‚¹æ•…éšœï¼Œç¡®ä¿ç›‘æ§ç³»ç»Ÿè‡ªèº«ç¨³å®š
å‡†ç¡®æ€§ï¼šæ’é™¤ç½‘ç»œå»¶è¿Ÿç­‰å¹²æ‰°å› ç´ 
å®æ—¶æ€§ï¼šåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå‘Šè­¦é€šçŸ¥
æ‰©å±•æ€§ï¼šæ”¯æŒå¤šä»åº“ï¼Œæ–¹ä¾¿æ·»åŠ æ–°çš„ç›‘æ§å¯¹è±¡
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**è¿ç»´ä»·å€¼**ï¼š
- **æ•…éšœé¢„è­¦**ï¼šåœ¨é—®é¢˜å½±å“ä¸šåŠ¡å‰åŠæ—¶å‘ç°
- **æ€§èƒ½ç›‘æ§**ï¼šæŒç»­è·Ÿè¸ªå¤åˆ¶æ€§èƒ½è¶‹åŠ¿
- **å®¹é‡è§„åˆ’**ï¼šä¸ºä»åº“æ€§èƒ½ä¼˜åŒ–æä¾›æ•°æ®æ”¯æ’‘
- **SLAä¿éšœ**ï¼šç¡®ä¿è¾¾åˆ°æœåŠ¡çº§åˆ«åè®®è¦æ±‚

**ä¸šåŠ¡ä»·å€¼**ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿éšœè¯»å†™åˆ†ç¦»æ¶æ„çš„æ•°æ®å‡†ç¡®æ€§
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…å› å»¶è¿Ÿå¯¼è‡´çš„é¡µé¢æ˜¾ç¤ºé—®é¢˜
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šåŠæ—¶å‘ç°å¹¶å¤„ç†å¤åˆ¶æ•…éšœ

### 10.4 æœ€ä½³å®è·µå»ºè®®


**éƒ¨ç½²å»ºè®®**ï¼š
```
âœ… ä½¿ç”¨ä¸“é—¨çš„ç›‘æ§ç”¨æˆ·ï¼Œæƒé™æœ€å°åŒ–
âœ… å¿ƒè·³è¡¨æ”¾åœ¨ç‹¬ç«‹çš„æ•°æ®åº“ä¸­
âœ… è®¾ç½®åˆç†çš„æ£€æµ‹é—´éš”ï¼ˆå»ºè®®5-10ç§’ï¼‰
âœ… é…ç½®å¤šçº§å‘Šè­¦é˜ˆå€¼
âœ… å®šæœŸæ¸…ç†å†å²ç›‘æ§æ•°æ®
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```
ğŸ”§ ç¡®ä¿æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥ï¼ˆä½¿ç”¨NTPï¼‰
ğŸ”§ ä¼˜åŒ–ç½‘ç»œé…ç½®ï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ
ğŸ”§ ç›‘æ§ä»åº“æ€§èƒ½ï¼ŒåŠæ—¶å‘ç°ç“¶é¢ˆ
ğŸ”§ ç»“åˆå…¶ä»–ç›‘æ§å·¥å…·ï¼Œå½¢æˆå®Œæ•´ç›‘æ§ä½“ç³»
ğŸ”§ å®šæœŸæµ‹è¯•å‘Šè­¦æœºåˆ¶çš„æœ‰æ•ˆæ€§
```

**æ•…éšœå¤„ç†**ï¼š
```
ğŸš¨ å»¶è¿Ÿçªç„¶å¢å¤§ï¼šæ£€æŸ¥ä»åº“æ€§èƒ½å’Œç½‘ç»œçŠ¶å†µ
ğŸš¨ ç›‘æ§å¤±æ•ˆï¼šæ£€æŸ¥pt-heartbeatè¿›ç¨‹å’Œæ•°æ®åº“è¿æ¥
ğŸš¨ è¯¯æŠ¥é¢‘ç¹ï¼šè°ƒæ•´å‘Šè­¦é˜ˆå€¼æˆ–æ£€æµ‹é—´éš”
ğŸš¨ æ•°æ®ä¸æ›´æ–°ï¼šæ£€æŸ¥ä¸»åº“å¿ƒè·³æ›´æ–°è¿›ç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **å¿ƒè·³ç›‘æµ‹ä¿åŒæ­¥ï¼Œå»¶è¿Ÿç›‘æ§ä¸èƒ½å°‘**
- **UPDATEå¿ƒè·³è¡¨ä¸å¢é•¿ï¼Œå‡†ç¡®å»¶è¿Ÿæœ‰ä¿éšœ**  
- **ä¸»åº“å†™å…¥ä»åº“è¯»ï¼Œæ—¶é—´å·®å€¼å³å»¶è¿Ÿ**
- **é˜ˆå€¼å‘Šè­¦åŠæ—¶æŠ¥ï¼Œæ•…éšœå¤„ç†è¦è¶æ—©**