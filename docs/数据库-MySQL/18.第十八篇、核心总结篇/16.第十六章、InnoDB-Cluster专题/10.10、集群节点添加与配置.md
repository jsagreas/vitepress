---
title: 10、集群节点添加与配置
---
## 📚 目录

1. [cluster.addInstance()操作详解](#1-cluster-addinstance操作详解)
2. [节点准备工作](#2-节点准备工作)
3. [实例配置检查](#3-实例配置检查)
4. [数据同步过程](#4-数据同步过程)
5. [节点加入验证](#5-节点加入验证)
6. [配置文件同步](#6-配置文件同步)
7. [节点角色分配](#7-节点角色分配)
8. [加入失败处理](#8-加入失败处理)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🚀 cluster.addInstance()操作详解


### 1.1 什么是addInstance操作


**简单理解**：`addInstance()`就像是给一个团队添加新成员的过程。想象你有一个工作小组，现在要加入一个新同事，你需要：
- 确保新同事具备基本技能
- 把他介绍给团队其他成员  
- 同步之前的工作内容
- 分配具体角色和职责

MySQL InnoDB Cluster的`addInstance()`操作就是这个道理。

### 1.2 基本语法和用法


**💡 基础语法**
```javascript
// 连接到集群
var cluster = dba.getCluster('myCluster')

// 添加新节点到集群
cluster.addInstance('用户名@新节点IP:端口')
```

**🔧 实际示例**
```javascript
// 1. 连接MySQL Shell到主节点
mysqlsh root@192.168.1.10:3306

// 2. 获取现有集群
var cluster = dba.getCluster('prodCluster')

// 3. 添加新节点
cluster.addInstance('root@192.168.1.12:3306')
```

### 1.3 添加过程中的关键步骤


**📋 自动执行的步骤**
```
步骤1: 连接验证
├── 检查目标实例是否可连接
├── 验证用户权限是否足够
└── 确认实例状态是否正常

步骤2: 配置检查
├── 检查MySQL版本兼容性
├── 验证必需的参数设置
└── 检查端口和防火墙

步骤3: 数据同步
├── 选择数据源（通常是主节点）
├── 创建备份并传输到新节点
└── 应用备份恢复数据

步骤4: 集群注册
├── 将新节点信息写入集群元数据
├── 配置Group Replication
└── 启动复制进程
```

---

## 2. 🔧 节点准备工作


### 2.1 硬件和系统准备


**💻 基础环境要求**

| 项目 | 要求 | 说明 |
|------|------|------|
| **操作系统** | `Linux/Unix` | CentOS 7+, Ubuntu 18+ |
| **内存** | `≥4GB` | 生产环境建议8GB+ |
| **磁盘空间** | `≥20GB` | 数据目录需要足够空间 |
| **网络** | `稳定连接` | 节点间延迟<10ms |

### 2.2 MySQL软件安装


**📦 安装步骤**
```bash
# CentOS/RHEL系统
# 1. 下载MySQL官方仓库
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
sudo rpm -ivh mysql80-community-release-el7-3.noarch.rpm

# 2. 安装MySQL Server
sudo yum install mysql-server mysql-shell

# 3. 启动MySQL服务
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

### 2.3 网络和防火墙配置


**🔥 防火墙端口开放**
```bash
# 开放MySQL端口（默认3306）
sudo firewall-cmd --permanent --add-port=3306/tcp

# 开放Group Replication端口（默认33061）
sudo firewall-cmd --permanent --add-port=33061/tcp

# 重新加载防火墙规则
sudo firewall-cmd --reload
```

**🌐 网络连通性测试**
```bash
# 从新节点测试连接到现有集群节点
telnet 192.168.1.10 3306
telnet 192.168.1.11 3306

# 测试Group Replication端口
telnet 192.168.1.10 33061
telnet 192.168.1.11 33061
```

### 2.4 用户权限准备


**👤 创建集群管理用户**
```sql
-- 在新节点上创建管理用户
CREATE USER 'clusteradmin'@'%' IDENTIFIED BY 'StrongPassword123!';

-- 授予必要权限
GRANT ALL PRIVILEGES ON *.* TO 'clusteradmin'@'%' WITH GRANT OPTION;
GRANT BACKUP_ADMIN ON *.* TO 'clusteradmin'@'%';
GRANT CLONE_ADMIN ON *.* TO 'clusteradmin'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

---

## 3. 🔍 实例配置检查


### 3.1 checkInstanceConfiguration检查


**🔎 配置检查的作用**

想象你要加入一个乐队，首先要检查你的乐器是否调音准确，是否具备基本的演奏技能。`checkInstanceConfiguration`就是这样的"入团考试"。

```javascript
// 检查实例是否符合集群要求
dba.checkInstanceConfiguration('root@192.168.1.12:3306')
```

### 3.2 常见的配置问题和解决


**⚠️ 典型配置问题**

```
问题1: server_id未设置或重复
解决方案:
```
```sql
-- 设置唯一的server_id
SET GLOBAL server_id = 12;
-- 写入配置文件
[mysqld]
server_id = 12
```

```
问题2: binlog未启用
解决方案:
```
```sql
-- 检查binlog状态
SHOW VARIABLES LIKE 'log_bin';
-- 在my.cnf中添加
[mysqld]
log-bin = mysql-bin
```

```
问题3: GTID未启用
解决方案:
```
```sql
-- 启用GTID
SET GLOBAL gtid_mode = ON;
SET GLOBAL enforce_gtid_consistency = ON;
-- 配置文件设置
[mysqld]
gtid_mode = ON
enforce_gtid_consistency = ON
```

### 3.3 自动配置修复


**🔧 使用configureInstance自动修复**
```javascript
// 自动配置实例以满足集群要求
dba.configureInstance('root@192.168.1.12:3306')

// 示例输出：
// Configuring MySQL instance at 192.168.1.12:3306 for use in an InnoDB cluster...
// The instance '192.168.1.12:3306' is valid for InnoDB cluster usage.
```

---

## 4. 🔄 数据同步过程


### 4.1 数据同步的工作原理


**📊 数据同步就像复制文件**

假设你有一台电脑上的重要文件，现在要完整复制到另一台电脑上：

```
源电脑（主节点）          目标电脑（新节点）
┌─────────────────┐      ┌─────────────────┐
│ 重要文件.doc    │ ───► │ 重要文件.doc    │
│ 数据库.sql      │ ───► │ 数据库.sql      │
│ 配置文件.conf   │ ───► │ 配置文件.conf   │
└─────────────────┘      └─────────────────┘
```

MySQL的数据同步有几种方式：

### 4.2 Clone插件同步（推荐方式）


**⚡ Clone同步的优势**
- **速度快**：直接复制数据文件
- **一致性好**：保证数据完整性
- **自动化**：无需人工干预

```javascript
// addInstance时自动选择Clone方式
cluster.addInstance('root@192.168.1.12:3306', {
    recoveryMethod: 'clone'
})
```

**🔄 Clone同步过程**
```
① 主节点创建一致性快照
② 通过网络传输数据到新节点
③ 新节点应用数据并启动复制
④ 同步完成，新节点加入集群
```

### 4.3 增量同步方式


**📈 什么时候使用增量同步**

当新节点已经有部分数据，且与集群数据差异不大时：

```javascript
// 使用增量同步
cluster.addInstance('root@192.168.1.12:3306', {
    recoveryMethod: 'incremental'
})
```

### 4.4 同步进度监控


**📊 查看同步状态**
```javascript
// 查看集群状态
cluster.status()

// 示例输出显示同步进度
{
    "clusterName": "prodCluster",
    "defaultReplicaSet": {
        "status": "OK",
        "topology": {
            "192.168.1.10:3306": {"status": "ONLINE", "mode": "R/W"},
            "192.168.1.11:3306": {"status": "ONLINE", "mode": "R/O"},
            "192.168.1.12:3306": {"status": "RECOVERING", "mode": "R/O"}
        }
    }
}
```

---

## 5. ✅ 节点加入验证


### 5.1 验证加入是否成功


**🔍 检查节点状态**

节点成功加入后，就像新员工正式入职，需要确认他能正常参与工作：

```javascript
// 查看详细集群状态
cluster.status({extended: true})
```

**📋 健康状态指标**

| 状态 | 含义 | 说明 |
|------|------|------|
| **ONLINE** | `正常在线` | 节点工作正常，可以处理请求 |
| **RECOVERING** | `数据恢复中` | 正在同步数据，暂不提供服务 |
| **OFFLINE** | `离线状态` | 节点不可用，需要检查问题 |
| **ERROR** | `错误状态` | 节点出现故障，需要修复 |

### 5.2 数据一致性验证


**🔄 验证数据同步**
```sql
-- 在主节点创建测试表
CREATE DATABASE test_sync;
USE test_sync;
CREATE TABLE sync_test (id INT PRIMARY KEY, data VARCHAR(50));
INSERT INTO sync_test VALUES (1, 'sync test data');

-- 在新节点查询验证
USE test_sync;
SELECT * FROM sync_test;
-- 应该能看到相同的数据
```

### 5.3 性能测试验证


**⚡ 简单性能测试**
```sql
-- 测试读取性能
SELECT COUNT(*) FROM information_schema.tables;

-- 测试连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看复制延迟
SHOW SLAVE STATUS\G
```

---

## 6. 📋 配置文件同步


### 6.1 配置同步的重要性


**🔧 为什么需要配置同步**

想象一个乐队，每个乐手都需要按照相同的乐谱演奏，否则就会出现不和谐的声音。MySQL集群也是如此，所有节点需要有一致的配置。

### 6.2 自动配置同步


**⚙️ addInstance自动处理的配置**
```
MySQL配置参数自动同步:
├── server_id (自动生成唯一值)
├── gtid_mode = ON
├── enforce_gtid_consistency = ON
├── log_bin = mysql-bin
├── binlog_format = ROW
├── binlog_checksum = NONE
├── log_slave_updates = ON
└── master_info_repository = TABLE
```

### 6.3 手动配置验证


**🔍 检查关键配置参数**
```sql
-- 检查GTID配置
SHOW VARIABLES LIKE 'gtid_mode';
SHOW VARIABLES LIKE 'enforce_gtid_consistency';

-- 检查binlog配置
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'binlog_format';

-- 检查server_id（每个节点必须唯一）
SHOW VARIABLES LIKE 'server_id';
```

### 6.4 配置文件备份


**💾 保存配置以防丢失**
```bash
# 备份MySQL配置文件
cp /etc/my.cnf /etc/my.cnf.backup.$(date +%Y%m%d)

# 查看当前生效的配置
mysqld --print-defaults
```

---

## 7. 👥 节点角色分配


### 7.1 集群角色的理解


**🎭 集群中的角色就像剧团**

```
主节点（PRIMARY）     → 导演，负责决策和协调
次节点（SECONDARY）   → 演员，执行任务和备份
仲裁节点（ARBITRATOR）→ 监督，投票但不存储数据
```

### 7.2 自动角色分配机制


**🤖 MySQL自动角色分配规则**

```
角色分配逻辑:
┌─────────────────────────────────────┐
│ 1. 数据完整性最高的节点成为PRIMARY   │
│ 2. 其他节点自动成为SECONDARY        │
│ 3. 如果配置了仲裁节点，仅参与投票   │
└─────────────────────────────────────┘
```

### 7.3 查看和管理角色


**👀 查看当前角色分配**
```javascript
// 查看集群拓扑和角色
cluster.status()

// 查看详细的角色信息
cluster.describe()
```

**🔄 手动切换角色**
```javascript
// 手动指定新的主节点（在主节点故障时）
cluster.setPrimaryInstance('root@192.168.1.11:3306')
```

### 7.4 角色切换的触发条件


**⚡ 自动故障转移**
```
主节点故障时的处理:
① 检测到主节点不可用
② 剩余节点进行投票选举
③ 选举新的主节点
④ 自动切换读写流量
⑤ 故障节点恢复后成为从节点
```

---

## 8. 🚨 加入失败处理


### 8.1 常见失败原因


**❌ 典型的失败场景**

```
网络问题:
├── 防火墙阻断连接
├── 端口未开放
└── 网络延迟过高

配置问题:
├── MySQL版本不兼容
├── 必要参数未设置
└── 权限不足

资源问题:
├── 磁盘空间不足
├── 内存不够
└── CPU负载过高

数据问题:
├── 数据不一致
├── GTID冲突
└── 存在不兼容的表
```

### 8.2 诊断失败原因


**🔍 故障诊断步骤**

**① 检查错误日志**
```bash
# 查看MySQL错误日志
tail -f /var/log/mysqld.log

# 查看MySQL Shell日志
tail -f ~/.mysqlsh/mysqlsh.log
```

**② 网络连接测试**
```bash
# 测试基本连接
mysql -h 192.168.1.12 -u root -p

# 测试Group Replication端口
telnet 192.168.1.12 33061
```

**③ 配置验证**
```javascript
// 重新检查实例配置
dba.checkInstanceConfiguration('root@192.168.1.12:3306')
```

### 8.3 常见问题解决方案


**🔧 解决方案集合**

**问题1：GTID不一致**
```sql
-- 重置GTID
RESET MASTER;
SET GLOBAL gtid_purged = '';
```

**问题2：权限不足**
```sql
-- 重新授权
GRANT ALL ON *.* TO 'clusteradmin'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

**问题3：磁盘空间不足**
```bash
# 清理binlog文件
mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"

# 检查磁盘使用
df -h /var/lib/mysql/
```

### 8.4 强制移除和重新添加


**🔄 重新开始的步骤**
```javascript
// 1. 如果节点部分加入，先移除
cluster.removeInstance('root@192.168.1.12:3306', {force: true})

// 2. 清理节点上的集群配置
// 在问题节点上执行
dba.dropMetadataSchema()

// 3. 重新配置和添加
dba.configureInstance('root@192.168.1.12:3306')
cluster.addInstance('root@192.168.1.12:3306')
```

---

## 9. 📝 核心要点总结


### 9.1 关键操作流程


**📋 标准添加流程**
```
①② 准备阶段：
   ├── 安装MySQL软件
   ├── 配置网络和防火墙
   └── 创建管理用户

③④ 配置阶段：
   ├── 检查实例配置
   ├── 自动修复配置问题
   └── 验证配置正确性

⑤⑥ 加入阶段：
   ├── 执行addInstance命令
   ├── 等待数据同步完成
   └── 验证节点状态

⑦⑧ 验证阶段：
   ├── 检查集群状态
   ├── 测试数据一致性
   └── 确认角色分配
```

### 9.2 必须掌握的核心概念


```
🔸 addInstance操作：向集群添加新节点的核心命令
🔸 数据同步：Clone和增量同步两种方式
🔸 配置检查：确保节点满足集群要求
🔸 角色分配：PRIMARY和SECONDARY的自动分配
🔸 故障处理：诊断和解决加入失败问题
```

### 9.3 最佳实践建议


**✅ 推荐做法**
- **提前规划**：确保硬件资源充足
- **网络优化**：保证节点间低延迟连接
- **配置标准化**：使用相同的MySQL版本和配置
- **监控到位**：实时监控添加过程和节点状态
- **备份验证**：添加前备份现有集群配置

**❌ 避免的错误**
- 在生产高峰期添加节点
- 忽略网络和防火墙配置
- 跳过配置检查步骤
- 不验证数据同步完整性
- 缺乏故障回退计划

**💡 实用小技巧**
- 使用MySQL Shell的自动补全功能
- 定期练习添加和移除节点操作
- 维护详细的集群拓扑文档
- 建立标准的故障处理流程

**核心记忆要点**：
- **准备充分**：硬件、网络、配置一个都不能少
- **自动为主**：优先使用自动配置和同步
- **验证到位**：每个步骤都要验证结果
- **故障预案**：准备充分的失败处理方案