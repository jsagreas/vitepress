---
title: 9、InnoDB Cluster 集群初始化
---
## 📚 目录

1. [集群初始化概述](#1-集群初始化概述)
2. [dba.createCluster()命令详解](#2-dba-createCluster-命令详解)
3. [Bootstrap节点配置](#3-Bootstrap节点配置)
4. [集群初始化参数详解](#4-集群初始化参数详解)
5. [初始化验证与检查](#5-初始化验证与检查)
6. [集群状态查看与确认](#6-集群状态查看与确认)
7. [初始化故障排查](#7-初始化故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 集群初始化概述


### 1.1 什么是集群初始化


**简单理解**：集群初始化就是把第一台MySQL服务器"变身"成集群的"老大"，然后其他服务器可以陆续加入。

```
初始化前：                    初始化后：
MySQL服务器1                   MySQL集群
MySQL服务器2          →        ┌─ Bootstrap节点 (服务器1)
MySQL服务器3                   ├─ 待加入节点 (服务器2)
                              └─ 待加入节点 (服务器3)
```

> 💡 **核心概念**：Bootstrap节点是集群的"创始人"，负责建立集群的基础架构和规则。

### 1.2 初始化的作用


**主要功能**：
- **建立集群身份** - 给集群起名字，确定身份
- **配置元数据** - 设置集群的基础信息和规则
- **启动组复制** - 开启MySQL的Group Replication功能
- **创建管理账户** - 建立集群管理所需的用户权限

### 1.3 初始化流程概览


```
准备阶段 → 执行初始化 → 验证结果 → 确认状态
    ↓           ↓           ↓          ↓
检查配置     运行命令     检查报错    查看集群
```

---

## 2. 🔧 dba.createCluster()命令详解


### 2.1 基本语法结构


**命令格式**：
```javascript
dba.createCluster('集群名称', {选项参数})
```

> 📖 **语法说明**：`dba`是MySQL Shell的数据库管理对象，`createCluster`是创建集群的方法。

### 2.2 最简单的创建方式


```javascript
// 最基础的集群创建
var cluster = dba.createCluster('myCluster')
```

**解释**：
- `'myCluster'` - 集群名称，可以自定义
- `var cluster` - 把创建的集群对象保存到变量中，方便后续操作

### 2.3 带参数的创建方式


```javascript
// 带完整参数的集群创建
var cluster = dba.createCluster('myCluster', {
    groupName: 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee',
    localAddress: '192.168.1.10:33061',
    exitStateAction: 'READ_ONLY',
    memberWeight: 50,
    consistency: 'BEFORE_ON_PRIMARY_FAILOVER',
    expelTimeout: 3600
})
```

### 2.4 createCluster方法的返回值


**返回对象**：创建成功后返回一个`Cluster`对象
```javascript
// 返回的集群对象可以用来管理集群
cluster.status()        // 查看集群状态
cluster.addInstance()   // 添加新节点
cluster.removeInstance() // 移除节点
```

---

## 3. ⚙️ Bootstrap节点配置


### 3.1 Bootstrap节点是什么


**通俗解释**：Bootstrap节点就是集群的"第一个成员"，相当于建群的群主。

```
现实生活类比：
建微信群 → 创建InnoDB Cluster
群主     → Bootstrap节点  
群成员   → 其他集群节点
```

### 3.2 Bootstrap节点的特殊性


**核心特点**：
- ✅ **集群发起者** - 负责创建和初始化集群
- ✅ **元数据存储** - 保存集群的配置信息
- ✅ **初始Primary** - 通常成为集群的主写节点
- ✅ **状态仲裁** - 在集群故障时参与状态判断

### 3.3 Bootstrap节点配置要求


**MySQL配置文件示例**：
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# 基础配置
server-id = 1
log-bin = mysql-bin
binlog_format = ROW
gtid_mode = ON
enforce_gtid_consistency = ON

# Group Replication配置
plugin_load_add = 'group_replication.so'
group_replication_start_on_boot = OFF
group_replication_bootstrap_group = OFF
group_replication_group_name = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'
group_replication_local_address = '192.168.1.10:33061'
```

> ⚠️ **重要提醒**：`group_replication_bootstrap_group`必须设为OFF，这个参数只在特殊恢复场景下使用。

### 3.4 Bootstrap节点选择原则


**选择标准**：
- 🔸 **硬件性能好** - CPU、内存、磁盘性能较强
- 🔸 **网络稳定** - 网络延迟低，带宽充足
- 🔸 **地理位置** - 最好在网络中心位置
- 🔸 **运维便利** - 便于管理和维护

---

## 4. 📋 集群初始化参数详解


### 4.1 必需参数


#### 集群名称参数


```javascript
dba.createCluster('myCluster')
```

**说明**：
- **作用** - 给集群起一个识别名称
- **要求** - 只能包含字母、数字、下划线
- **建议** - 使用有意义的名称，如`prod_web_cluster`

### 4.2 网络相关参数


#### groupName参数


```javascript
{
    groupName: 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee'
}
```

**解释**：
- **作用** - Group Replication的组标识符
- **格式** - 必须是标准UUID格式
- **生成** - 可用`SELECT UUID()`生成

> 💡 **小贴士**：如果不指定，MySQL Shell会自动生成一个UUID。

#### localAddress参数


```javascript
{
    localAddress: '192.168.1.10:33061'
}
```

**解释**：
- **作用** - 本节点的Group Replication通信地址
- **格式** - `IP地址:端口号`
- **端口** - 通常使用MySQL端口+10000（如3306→33061）

### 4.3 故障处理参数


#### exitStateAction参数


```javascript
{
    exitStateAction: 'READ_ONLY'
}
```

**选项说明**：
- `READ_ONLY` - 节点异常时变为只读（**推荐**）
- `OFFLINE_MODE` - 节点异常时进入离线模式
- `ABORT_SERVER` - 节点异常时关闭MySQL服务

> 🔧 **实践建议**：生产环境推荐使用`READ_ONLY`，既保护数据又保持服务可用。

#### expelTimeout参数


```javascript
{
    expelTimeout: 3600
}
```

**解释**：
- **作用** - 节点失联后被踢出集群的等待时间
- **单位** - 秒
- **默认** - 0（立即踢出）
- **建议** - 设置3600（1小时），避免网络抖动误踢

### 4.4 性能调优参数


#### memberWeight参数


```javascript
{
    memberWeight: 50
}
```

**解释**：
- **作用** - 节点在Primary选举中的权重
- **范围** - 0-100
- **用途** - 权重高的节点更容易成为Primary

#### consistency参数


```javascript
{
    consistency: 'BEFORE_ON_PRIMARY_FAILOVER'
}
```

**一致性级别**：
- `EVENTUAL` - 最终一致性（性能最好）
- `BEFORE` - 读前一致性
- `AFTER` - 写后一致性
- `BEFORE_ON_PRIMARY_FAILOVER` - 主节点切换时的读前一致性（**推荐**）

---

## 5. ✅ 初始化验证与检查


### 5.1 初始化前的预检查


**检查清单**：

```bash
# 1. 检查MySQL配置
mysqlsh --uri root@192.168.1.10:3306 \
        --execute "dba.checkInstanceConfiguration()"
```

**检查项目**：
- ✅ **二进制日志** - `log_bin = ON`
- ✅ **GTID模式** - `gtid_mode = ON`
- ✅ **Group Replication插件** - 已加载
- ✅ **网络配置** - 端口可访问

### 5.2 配置自动修复


```javascript
// 自动修复配置问题
dba.configureInstance('root@192.168.1.10:3306')
```

**修复内容**：
- 🔧 自动设置必需的MySQL参数
- 🔧 创建集群管理账户
- 🔧 配置SSL证书
- 🔧 重启MySQL服务（如需要）

### 5.3 手动验证方法


**关键配置检查**：
```sql
-- 检查GTID状态
SHOW VARIABLES LIKE 'gtid_mode';
SHOW VARIABLES LIKE 'enforce_gtid_consistency';

-- 检查二进制日志
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'binlog_format';

-- 检查Group Replication
SHOW PLUGINS;
SELECT * FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_NAME = 'group_replication';
```

### 5.4 网络连通性测试


```bash
# 测试Group Replication端口
telnet 192.168.1.10 33061

# 测试MySQL端口
mysql -h 192.168.1.10 -P 3306 -u root -p
```

---

## 6. 📊 集群状态查看与确认


### 6.1 基本状态查看


```javascript
// 查看集群整体状态
cluster.status()
```

**输出示例**：
```json
{
    "clusterName": "myCluster",
    "defaultReplicaSet": {
        "name": "default",
        "primary": "192.168.1.10:3306",
        "ssl": "REQUIRED",
        "status": "OK",
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.",
        "topology": {
            "192.168.1.10:3306": {
                "address": "192.168.1.10:3306",
                "mode": "R/W",
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE"
            }
        }
    }
}
```

### 6.2 状态字段解释


**重要字段说明**：

| 字段 | 含义 | 正常值 |
|------|------|--------|
| `status` | 集群整体状态 | `OK` |
| `statusText` | 状态描述 | `Cluster is ONLINE...` |
| `primary` | 当前主节点 | 节点IP:端口 |
| `mode` | 节点模式 | `R/W`（读写）或`R/O`（只读） |
| `role` | 节点角色 | `HA`（高可用节点） |

### 6.3 详细状态查看


```javascript
// 查看扩展状态信息
cluster.status({extended: 1})

// 查看更详细的状态
cluster.status({extended: 2})
```

**扩展信息包括**：
- 🔍 Group Replication详细状态
- 🔍 网络延迟信息
- 🔍 事务应用状态
- 🔍 成员权重信息

### 6.4 使用SQL查看状态


```sql
-- 查看Group Replication成员状态
SELECT 
    MEMBER_ID,
    MEMBER_HOST,
    MEMBER_PORT,
    MEMBER_STATE,
    MEMBER_ROLE
FROM performance_schema.replication_group_members;

-- 查看复制状态
SELECT 
    CHANNEL_NAME,
    SERVICE_STATE,
    LAST_ERROR_MESSAGE
FROM performance_schema.replication_connection_status;
```

---

## 7. 🚨 初始化故障排查


### 7.1 常见错误类型


#### 配置错误


**错误信息**：
```
MySQL Error 3092: The server is not configured properly to be an active member of the group
```

**解决方法**：
```javascript
// 1. 检查配置
dba.checkInstanceConfiguration('root@192.168.1.10:3306')

// 2. 自动修复
dba.configureInstance('root@192.168.1.10:3306')

// 3. 重启MySQL服务
```

#### 网络连接错误


**错误信息**：
```
Unable to connect to the target instance 192.168.1.10:3306
```

**排查步骤**：
1. **检查MySQL服务** - `systemctl status mysql`
2. **检查端口监听** - `netstat -tlnp | grep 3306`
3. **检查防火墙** - `ufw status` 或 `iptables -L`
4. **检查网络** - `ping 192.168.1.10`

#### UUID冲突错误


**错误信息**：
```
Group Replication failed to start: This member has a group_replication_group_name value that is incompatible with the group
```

**解决方法**：
```sql
-- 生成新的UUID
SELECT UUID();

-- 更新配置文件中的group_name
-- 重启MySQL服务
```

### 7.2 日志文件分析


**关键日志位置**：
```bash
# MySQL错误日志
tail -f /var/log/mysql/error.log

# MySQL Shell日志
tail -f ~/.mysqlsh/mysqlsh.log
```

**常见日志关键词**：
- `Group Replication` - Group Replication相关
- `Plugin group_replication` - 插件状态
- `Member with address` - 成员状态变化
- `Primary election` - 主节点选举

### 7.3 强制重新初始化


> ⚠️ **危险操作**：仅在测试环境或数据可丢失的情况下使用

```javascript
// 1. 停止Group Replication
dba.stopGroupReplication()

// 2. 重置Group Replication
dba.resetGroupReplication()

// 3. 重新创建集群
var cluster = dba.createCluster('myCluster')
```

### 7.4 故障排查流程图


```
初始化失败
     ↓
检查错误信息
     ↓
┌─────────────┬─────────────┬─────────────┐
│  配置错误   │  网络错误   │  权限错误   │
│     ↓       │     ↓       │     ↓       │
│ 修复配置    │ 检查网络    │ 检查用户    │
│ 重启服务    │ 修复连接    │ 修复权限    │
└─────────────┴─────────────┴─────────────┘
           ↓
    重新尝试初始化
           ↓
      ┌─成功─┐  ┌─失败─┐
      │ 完成 │  │ 继续 │
      │ 部署 │  │ 排查 │
      └─────┘  └─────┘
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 集群初始化：将第一台MySQL服务器转换为集群Bootstrap节点
🔸 dba.createCluster()：MySQL Shell中创建集群的核心命令
🔸 Bootstrap节点：集群的创始节点，负责初始化和管理集群元数据
🔸 集群参数：网络配置、故障处理、性能调优等关键参数设置
🔸 状态验证：通过cluster.status()和SQL查询确认集群状态
```

### 8.2 关键操作步骤


**🔹 标准初始化流程**：
```
1. 预检查 → dba.checkInstanceConfiguration()
2. 配置修复 → dba.configureInstance()
3. 创建集群 → dba.createCluster()
4. 状态确认 → cluster.status()
5. 保存配置 → 持久化集群对象
```

**🔹 重要配置参数**：
```
必需参数：
- clusterName: 集群名称
- groupName: Group Replication组ID

推荐参数：
- exitStateAction: 'READ_ONLY'
- expelTimeout: 3600
- consistency: 'BEFORE_ON_PRIMARY_FAILOVER'
```

### 8.3 故障预防要点


**🔹 配置检查清单**：
- ✅ MySQL版本兼容（≥8.0.11）
- ✅ 二进制日志开启
- ✅ GTID模式启用
- ✅ Group Replication插件加载
- ✅ 网络端口可访问
- ✅ 用户权限充足

**🔹 常见问题避免**：
- 🚫 不要在生产环境设置`group_replication_bootstrap_group=ON`
- 🚫 不要使用相同的`server_id`
- 🚫 不要忽略网络延迟和带宽要求
- 🚫 不要跳过初始化前的配置检查

### 8.4 实际应用建议


**生产环境最佳实践**：
- 🎯 **Bootstrap节点选择**：选择性能最好、网络最稳定的服务器
- 🎯 **参数调优**：根据业务特点调整一致性级别和超时时间
- 🎯 **监控设置**：建立集群状态监控和告警机制
- 🎯 **备份策略**：确保集群初始化后的配置文件备份

**核心记忆**：
- 集群初始化是构建InnoDB Cluster的第一步
- Bootstrap节点是集群的基础，选择和配置要谨慎
- dba.createCluster()是创建集群的核心命令
- 初始化后必须验证状态，确保集群正常运行
- 掌握故障排查方法，遇到问题能快速定位解决