---
title: 20、集群版本升级管理
---
## 📚 目录

1. [集群升级概述](#1-集群升级概述)
2. [升级前准备工作](#2-升级前准备工作)
3. [滚动升级策略](#3-滚动升级策略)
4. [元数据升级管理](#4-元数据升级管理)
5. [升级过程监控](#5-升级过程监控)
6. [升级验证测试](#6-升级验证测试)
7. [回滚方案管理](#7-回滚方案管理)
8. [升级最佳实践](#8-升级最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔄 集群升级概述


### 1.1 什么是集群版本升级


**简单理解**：集群版本升级就是把MySQL集群从旧版本更新到新版本，就像手机系统升级一样。

```
旧版本集群          升级过程          新版本集群
MySQL 8.0.25  →  逐步更新替换  →  MySQL 8.0.35
    ↓               ↓               ↓
功能有限         升级过程中         功能增强
性能一般         保持服务         性能提升
```

### 1.2 为什么要升级集群


**🎯 升级的主要原因**：
- **安全修复** - 新版本修复了安全漏洞，保护数据安全
- **性能提升** - 新版本优化了查询速度，提高处理能力
- **新功能** - 获得新的数据库特性和管理功能
- **Bug修复** - 解决旧版本中发现的各种问题
- **长期支持** - 旧版本会停止维护，需要跟上主流版本

### 1.3 集群升级的挑战


**⚠️ 升级面临的问题**：
```
服务中断风险：升级过程可能影响业务
数据一致性：确保数据不丢失不错乱  
兼容性问题：新旧版本可能不兼容
回滚困难：升级失败后难以恢复
性能影响：升级过程会消耗系统资源
```

---

## 2. 📋 升级前准备工作


### 2.1 版本兼容性检查


**🔍 检查什么**：
- **MySQL版本兼容性** - 确认目标版本是否支持当前配置
- **应用程序兼容性** - 检查应用是否支持新版本的MySQL
- **操作系统兼容性** - 确认OS版本是否支持新MySQL版本

```bash
# 检查当前版本信息
mysqlsh --help --version

# 检查集群状态
mysqlsh> cluster.status()

# 检查升级路径兼容性
mysqlsh> util.checkForServerUpgrade()
```

### 2.2 升级前完整备份


**💾 备份策略**：

```
数据备份层次：
┌─────────────────────┐
│   全量数据备份       │ ← 完整的数据库备份
├─────────────────────┤
│   配置文件备份       │ ← my.cnf等配置文件
├─────────────────────┤  
│   集群元数据备份     │ ← 集群拓扑和状态信息
├─────────────────────┤
│   二进制日志备份     │ ← binlog日志文件
└─────────────────────┘
```

**实际备份操作**：
```bash
# 1. 停止写入操作（可选）
mysqlsh> cluster.setPrimaryInstance('primary:3306', {runningTransactionsTimeout: 60})

# 2. 创建完整备份
mysqldump --single-transaction --routines --triggers \
          --all-databases > backup_before_upgrade.sql

# 3. 备份配置文件
cp /etc/mysql/my.cnf /backup/my.cnf.backup

# 4. 备份集群元数据
mysqlsh> util.dumpInstance('/backup/cluster_metadata')
```

### 2.3 升级环境准备


**🔧 环境检查清单**：

| 检查项目 | **检查内容** | **确认标准** |
|---------|------------|-------------|
| 🔋 **系统资源** | `CPU、内存、磁盘空间` | `足够的资源支持升级过程` |
| 🌐 **网络连接** | `集群节点间网络稳定性` | `延迟<10ms，无丢包` |
| 💾 **存储空间** | `数据目录剩余空间` | `至少预留30%空闲空间` |
| ⏰ **维护窗口** | `业务低峰期时间安排` | `充足的时间完成升级` |

---

## 3. 🔄 滚动升级策略


### 3.1 什么是滚动升级


**通俗解释**：滚动升级就像换轮胎一样，一次只换一个轮子，车子还能继续开，不用停下来。

```
集群滚动升级过程：

初始状态：     第一步：        第二步：        第三步：
A(8.0.25)     A(8.0.35)      A(8.0.35)      A(8.0.35)
B(8.0.25)  →  B(8.0.25)  →   B(8.0.35)  →   B(8.0.35)
C(8.0.25)     C(8.0.25)      C(8.0.25)      C(8.0.35)
   ↓             ↓              ↓              ↓
 全旧版本      升级节点A      升级节点B      全新版本
```

### 3.2 滚动升级详细步骤


**📝 升级操作流程**：

**步骤1：升级Secondary节点**
```bash
# 在第一个Secondary节点上操作
# 1. 停止MySQL服务
sudo systemctl stop mysql

# 2. 升级MySQL软件包
sudo apt update && sudo apt install mysql-server=8.0.35*

# 3. 启动服务
sudo systemctl start mysql

# 4. 检查节点状态
mysqlsh> cluster.status()
```

**步骤2：验证升级结果**
```bash
# 检查节点是否正常加入集群
mysqlsh> cluster.status()

# 输出示例：
{
    "clusterName": "myCluster",
    "defaultReplicaSet": {
        "topology": {
            "node1:3306": {
                "mode": "R/W",           # Primary节点
                "status": "ONLINE",
                "version": "8.0.25"
            },
            "node2:3306": {
                "mode": "R/O",           # Secondary节点
                "status": "ONLINE", 
                "version": "8.0.35"      # 已升级
            }
        }
    }
}
```

**步骤3：逐步升级其他Secondary节点**
```bash
# 对剩余的Secondary节点重复步骤1-2
# 确保每个节点升级后都能正常工作
```

**步骤4：升级Primary节点**
```bash
# 1. 切换Primary节点
mysqlsh> cluster.setPrimaryInstance('upgraded_secondary:3306')

# 2. 升级原Primary节点
# 重复之前的升级步骤

# 3. 验证整个集群
mysqlsh> cluster.status()
```

### 3.3 升级过程中的注意事项


**⚠️ 重要提醒**：
```
同时只升级一个节点：避免集群不稳定
升级顺序很重要：先Secondary后Primary
每步都要验证：确保节点正常才继续下一步
保持网络畅通：升级过程中网络不能中断
监控集群状态：随时准备处理异常情况
```

---

## 4. 🔧 元数据升级管理


### 4.1 什么是元数据升级


**简单解释**：元数据就像集群的"配置信息档案"，记录了集群有哪些节点、谁是主节点等信息。升级MySQL版本后，这些信息的格式可能会变化，需要专门升级。

```
元数据包含的信息：
┌─────────────────────┐
│  集群拓扑结构        │ ← 哪些服务器在集群中
├─────────────────────┤
│  节点角色信息        │ ← 谁是主节点，谁是从节点  
├─────────────────────┤
│  配置参数设置        │ ← 集群运行的各种设置
├─────────────────────┤
│  版本兼容信息        │ ← 支持哪些MySQL版本
└─────────────────────┘
```

### 4.2 执行元数据升级


**🔄 使用dba.upgradeMetadata()命令**：

```javascript
// 连接到集群
mysqlsh> \connect root@primary:3306

// 获取集群对象
mysqlsh> var cluster = dba.getCluster()

// 检查是否需要元数据升级
mysqlsh> dba.checkInstanceConfiguration('primary:3306')

// 执行元数据升级
mysqlsh> dba.upgradeMetadata()
```

### 4.3 元数据升级过程详解


**📊 升级过程监控**：

```javascript
// 详细的元数据升级示例
mysqlsh> dba.upgradeMetadata({dryRun: true})  // 先模拟运行

// 输出示例：
{
    "upgradeRequired": true,
    "currentVersion": "2.0.0",
    "targetVersion": "2.1.0", 
    "changes": [
        "Update cluster metadata schema",
        "Migrate configuration parameters",
        "Update version compatibility info"
    ]
}

// 确认无误后执行真正的升级
mysqlsh> dba.upgradeMetadata()
```

**⚙️ 升级过程说明**：
```
第一阶段：检查元数据版本
↓
第二阶段：备份当前元数据
↓  
第三阶段：更新元数据结构
↓
第四阶段：迁移配置信息
↓
第五阶段：验证升级结果
```

---

## 5. 📊 升级过程监控


### 5.1 监控关键指标


**📈 需要监控的重要指标**：

| 监控类别 | **关键指标** | **正常范围** | **异常处理** |
|---------|------------|-------------|-------------|
| 🔗 **集群状态** | `节点在线状态` | `所有节点ONLINE` | `检查网络和服务状态` |
| ⚡ **性能指标** | `查询响应时间` | `<100ms` | `检查是否有性能退化` |
| 💾 **复制延迟** | `Secondary延迟` | `<1秒` | `检查网络和IO性能` |
| 🔄 **事务处理** | `事务成功率` | `>99.9%` | `检查是否有事务失败` |

### 5.2 实时监控命令


**🔍 常用监控脚本**：

```bash
#!/bin/bash
# 集群升级监控脚本

# 检查集群整体状态
check_cluster_status() {
    mysqlsh --sql -e "
    SELECT 
        member_host,
        member_port,
        member_state,
        member_role
    FROM performance_schema.replication_group_members;
    "
}

# 检查复制延迟
check_replication_lag() {
    mysqlsh --sql -e "
    SELECT 
        channel_name,
        lag_from_original_commit_timestamp
    FROM performance_schema.replication_connection_status;
    "
}

# 持续监控循环
while true; do
    echo "=== $(date) ==="
    check_cluster_status
    check_replication_lag
    sleep 30
done
```

### 5.3 异常情况处理


**🚨 常见异常及处理方法**：

```
节点离线 → 检查服务状态，重启MySQL服务
复制中断 → 检查网络连接，重新配置复制
性能下降 → 监控系统资源，必要时暂停升级
数据不一致 → 立即停止升级，检查数据完整性
```

---

## 6. ✅ 升级验证测试


### 6.1 功能验证测试


**🧪 基本功能测试**：

```sql
-- 1. 数据读写测试
CREATE TABLE upgrade_test (
    id INT PRIMARY KEY,
    data VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO upgrade_test (id, data) VALUES (1, 'test data');
SELECT * FROM upgrade_test;

-- 2. 事务测试
START TRANSACTION;
INSERT INTO upgrade_test (id, data) VALUES (2, 'transaction test');
COMMIT;

-- 3. 索引测试
CREATE INDEX idx_data ON upgrade_test(data);
EXPLAIN SELECT * FROM upgrade_test WHERE data = 'test data';
```

### 6.2 集群特性验证


**🔗 集群功能测试**：

```javascript
// 1. 故障转移测试
mysqlsh> cluster.status()

// 模拟主节点故障（谨慎操作）
// 停止Primary节点，观察是否自动选举新Primary

// 2. 读写分离测试
// 连接到不同节点，测试读写操作

// 3. 数据一致性测试  
// 在Primary写入数据，检查Secondary是否同步
```

### 6.3 性能对比测试


**📊 性能基准测试**：

```bash
# 升级前性能基准
mysqlslap --create-schema=test_db \
          --query="SELECT * FROM test_table LIMIT 1000" \
          --concurrency=50 --iterations=10

# 升级后性能对比
# 重复相同测试，对比结果
```

---

## 7. 🔙 回滚方案管理


### 7.1 什么时候需要回滚


**⚠️ 回滚触发条件**：
- **升级失败** - 升级过程中出现无法解决的错误
- **性能严重下降** - 新版本性能明显不如旧版本
- **功能异常** - 应用程序无法正常工作
- **数据一致性问题** - 发现数据丢失或错乱

### 7.2 回滚准备工作


**📋 回滚前检查**：

```
回滚决策流程：
问题是否可以快速修复？ → 是 → 尝试修复
    ↓ 否
业务影响是否严重？ → 是 → 立即回滚
    ↓ 否  
是否在维护窗口内？ → 是 → 继续调试
    ↓ 否
执行回滚操作
```

### 7.3 回滚执行步骤


**🔄 安全回滚流程**：

```bash
# 1. 停止所有写入操作
mysqlsh> cluster.setOption('writeProtection', 'enabled')

# 2. 确认数据一致性
mysqlsh> cluster.status()

# 3. 回滚到备份版本
# 停止新版本MySQL
sudo systemctl stop mysql

# 恢复旧版本软件
sudo apt install mysql-server=8.0.25*

# 恢复配置文件
sudo cp /backup/my.cnf.backup /etc/mysql/my.cnf

# 4. 恢复数据（如果需要）
mysql < backup_before_upgrade.sql

# 5. 重启集群
sudo systemctl start mysql
mysqlsh> cluster.rejoinInstance('node:3306')
```

### 7.4 回滚后验证


**✅ 回滚验证清单**：
- 所有节点服务正常启动
- 集群状态恢复到升级前
- 应用程序功能正常
- 数据完整性检查通过
- 性能恢复到预期水平

---

## 8. 🎯 升级最佳实践


### 8.1 升级时机选择


**⏰ 最佳升级时间**：
```
业务角度：选择业务低峰期
技术角度：系统资源充足时期
人员角度：技术团队都在线时
风险角度：有足够时间处理问题时
```

### 8.2 升级策略建议


**🛡️ 风险控制策略**：

| 策略类型 | **具体做法** | **适用场景** |
|---------|------------|-------------|
| 🧪 **测试环境先行** | `在测试环境完整演练升级过程` | `所有生产环境升级` |
| 🔄 **分批升级** | `先升级不重要集群，再升级核心集群` | `多集群环境` |
| ⏸️ **暂停点设置** | `每个步骤后暂停，确认无误再继续` | `高风险升级` |
| 👥 **双人操作** | `重要操作需要两人确认` | `核心生产环境` |

### 8.3 升级团队协作


**👥 团队分工建议**：
```
升级负责人：统筹整个升级过程
DBA：执行具体的数据库操作  
运维工程师：监控系统资源和网络
应用开发：验证应用功能
测试工程师：执行功能测试
```

### 8.4 文档和沟通


**📝 必要文档**：
- **升级计划书** - 详细的升级步骤和时间安排
- **回滚预案** - 遇到问题时的应对方案  
- **验证清单** - 升级后需要检查的项目
- **联系方式** - 相关人员的联系信息

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的关键概念


```
🔸 滚动升级：一次只升级一个节点，保持服务可用
🔸 元数据升级：使用dba.upgradeMetadata()更新集群配置信息  
🔸 版本兼容性：确保新旧版本能够正常协作
🔸 备份策略：升级前必须做完整备份
🔸 监控验证：升级过程中持续监控集群状态
🔸 回滚准备：升级失败时能够快速恢复
```

### 9.2 升级成功的关键要素


**🎯 成功升级的要点**：
```
充分准备：详细的升级计划和充足的备份
稳步推进：一步一验证，不急躁冒进
持续监控：实时关注集群状态变化
团队协作：各角色人员密切配合
应急准备：随时准备执行回滚方案
```

### 9.3 常见错误避免


**❌ 避免这些错误**：
```
同时升级多个节点 → 可能导致集群不可用
跳过备份环节 → 出问题时无法快速恢复  
忽略兼容性检查 → 升级后功能异常
缺少监控 → 问题发现不及时
没有回滚预案 → 升级失败时手忙脚乱
```

### 9.4 升级价值与意义


**💡 为什么要重视集群升级**：
- **保障安全** - 及时修复安全漏洞，保护数据安全
- **提升性能** - 获得更好的查询性能和处理能力
- **降低风险** - 使用稳定的新版本，减少生产故障
- **技术跟进** - 保持技术栈的先进性和可维护性

**核心记忆**：
- 集群升级要小心谨慎，步步为营
- 滚动升级保服务，元数据升级要跟上
- 监控验证不能少，回滚预案要准备
- 团队协作是关键，文档沟通要到位