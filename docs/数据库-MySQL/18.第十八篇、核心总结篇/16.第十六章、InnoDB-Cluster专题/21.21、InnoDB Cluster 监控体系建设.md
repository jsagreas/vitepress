---
title: 21ã€InnoDB Cluster ç›‘æ§ä½“ç³»å»ºè®¾
---
## ğŸ“š ç›®å½•

1. [InnoDB Clusterç›‘æ§ä½“ç³»æ¦‚è¿°](#1-InnoDB-Clusterç›‘æ§ä½“ç³»æ¦‚è¿°)
2. [Performance Schemaæ ¸å¿ƒç›‘æ§](#2-Performance-Schemaæ ¸å¿ƒç›‘æ§)
3. [replication_group_membersè¡¨è¯¦è§£](#3-replication_group_membersè¡¨è¯¦è§£)
4. [replication_group_member_statsè¡¨åˆ†æ](#4-replication_group_member_statsè¡¨åˆ†æ)
5. [å…³é”®æ€§èƒ½æŒ‡æ ‡KPIä½“ç³»](#5-å…³é”®æ€§èƒ½æŒ‡æ ‡KPIä½“ç³»)
6. [ç›‘æ§æ•°æ®é‡‡é›†ç­–ç•¥](#6-ç›‘æ§æ•°æ®é‡‡é›†ç­–ç•¥)
7. [å‘Šè­¦è§„åˆ™é…ç½®](#7-å‘Šè­¦è§„åˆ™é…ç½®)
8. [ç›‘æ§å·¥å…·é›†æˆ](#8-ç›‘æ§å·¥å…·é›†æˆ)
9. [å¯è§†åŒ–ç›‘æ§ç•Œé¢](#9-å¯è§†åŒ–ç›‘æ§ç•Œé¢)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” InnoDB Clusterç›‘æ§ä½“ç³»æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„Clusterç›‘æ§

**ğŸ¯ ç›‘æ§çš„æ ¸å¿ƒä»·å€¼**

```
ä¼ ç»Ÿå•æœºMySQL vs InnoDB Clusterç›‘æ§å·®å¼‚ï¼š

å•æœºMySQLç›‘æ§ï¼š
- å…³æ³¨å•ä¸ªå®ä¾‹çš„æ€§èƒ½æŒ‡æ ‡
- ç›‘æ§è¿æ¥æ•°ã€QPSã€æ…¢æŸ¥è¯¢ç­‰
- ç›¸å¯¹ç®€å•ç›´è§‚

InnoDB Clusterç›‘æ§ï¼š
- éœ€è¦ç›‘æ§æ•´ä¸ªé›†ç¾¤çš„å¥åº·çŠ¶æ€
- å…³æ³¨èŠ‚ç‚¹é—´çš„åè°ƒå’Œä¸€è‡´æ€§
- å¤åˆ¶å»¶è¿Ÿã€è„‘è£‚æ£€æµ‹ã€æ•…éšœè½¬ç§»
- åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§æŒ‘æˆ˜
```

**ğŸ”¸ Clusterç‰¹æœ‰çš„ç›‘æ§æŒ‘æˆ˜**
```
1. èŠ‚ç‚¹çŠ¶æ€ç®¡ç†
   æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„çŠ¶æ€ï¼šONLINEã€RECOVERINGã€OFFLINE
   éœ€è¦å®æ—¶äº†è§£å“ªäº›èŠ‚ç‚¹æ­£å¸¸å·¥ä½œ

2. æ•°æ®ä¸€è‡´æ€§ç›‘æ§
   ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¿æŒä¸€è‡´
   æ£€æµ‹åˆ†åŒºè„‘è£‚å’Œæ•°æ®å†²çª

3. æ€§èƒ½åè°ƒç›‘æ§
   ç›‘æ§èŠ‚ç‚¹é—´çš„ç½‘ç»œå»¶è¿Ÿ
   æ£€æµ‹æ€§èƒ½ç“¶é¢ˆå’Œçƒ­ç‚¹é—®é¢˜

4. æ•…éšœæ¢å¤ç›‘æ§
   è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤è¿‡ç¨‹
   ç›‘æ§æ•…éšœè½¬ç§»çš„æ•ˆæœå’Œæ—¶é—´
```

### 1.2 ç›‘æ§ä½“ç³»æ¶æ„è®¾è®¡

**ğŸ—ï¸ å®Œæ•´ç›‘æ§æ¶æ„**

```
ç›‘æ§æ•°æ®æµå‘ï¼š
MySQLèŠ‚ç‚¹ â†’ Performance Schema â†’ æ•°æ®é‡‡é›†å™¨ â†’ æ—¶åºæ•°æ®åº“ â†’ å¯è§†åŒ–å±•ç¤º
    â†“              â†“                â†“             â†“           â†“
   å®ä¾‹æŒ‡æ ‡     é›†ç¾¤çŠ¶æ€ä¿¡æ¯      å®šæœŸæ”¶é›†      å†å²æ•°æ®      å‘Šè­¦é€šçŸ¥

ç›‘æ§å±‚æ¬¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å±•ç¤ºå±‚                           â”‚
â”‚  Grafanaä»ªè¡¨æ¿ | å‘Šè­¦é€šçŸ¥ | æŠ¥è¡¨ç³»ç»Ÿ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                å¤„ç†å±‚                           â”‚
â”‚  æ•°æ®èšåˆ | å‘Šè­¦åˆ¤æ–­ | è¶‹åŠ¿åˆ†æ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                å­˜å‚¨å±‚                           â”‚
â”‚  Prometheus | InfluxDB | MySQL                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                é‡‡é›†å±‚                           â”‚
â”‚  Exporter | è‡ªå®šä¹‰è„šæœ¬ | Performance Schema    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æ•°æ®å±‚                           â”‚
â”‚  InnoDB ClusterèŠ‚ç‚¹ | Router | Shell           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ç›‘æ§èŒƒå›´åˆ’åˆ†

**ğŸ“Š ç›‘æ§å¯¹è±¡åˆ†ç±»**

```
ğŸŸ¢ åŸºç¡€è®¾æ–½ç›‘æ§ï¼š
- æœåŠ¡å™¨ç¡¬ä»¶ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- æ“ä½œç³»ç»Ÿï¼šè¿›ç¨‹ã€æ–‡ä»¶å¥æŸ„ã€å†…æ ¸å‚æ•°
- ç½‘ç»œè¿æ¥ï¼šå¸¦å®½ä½¿ç”¨ã€å»¶è¿Ÿã€ä¸¢åŒ…ç‡

ğŸŸ¡ æ•°æ®åº“å®ä¾‹ç›‘æ§ï¼š
- MySQLåŸºç¡€æŒ‡æ ‡ï¼šè¿æ¥æ•°ã€QPSã€TPS
- InnoDBå¼•æ“ï¼šç¼“å†²æ± ã€é”ç­‰å¾…ã€æ—¥å¿—
- æŸ¥è¯¢æ€§èƒ½ï¼šæ…¢æŸ¥è¯¢ã€æ‰§è¡Œè®¡åˆ’

ğŸ”´ é›†ç¾¤ä¸“é¡¹ç›‘æ§ï¼š
- èŠ‚ç‚¹çŠ¶æ€ï¼šåœ¨çº¿çŠ¶æ€ã€è§’è‰²åˆ†é…
- å¤åˆ¶æ€§èƒ½ï¼šå»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡
- ä¸€è‡´æ€§æ£€æŸ¥ï¼šæ•°æ®åŒæ­¥ã€å†²çªæ£€æµ‹

ğŸŸ£ ä¸šåŠ¡å±‚ç›‘æ§ï¼š
- åº”ç”¨è¿æ¥ï¼šRouterè¿æ¥åˆ†å‘
- è¯»å†™åˆ†ç¦»ï¼šè¯»å†™è¯·æ±‚æ¯”ä¾‹å’Œæ€§èƒ½
- ä¸šåŠ¡æŒ‡æ ‡ï¼šè®¢å•é‡ã€ç”¨æˆ·æ´»è·ƒåº¦
```

---

## 2. ğŸ“ˆ Performance Schemaæ ¸å¿ƒç›‘æ§


### 2.1 Performance Schemaåœ¨Clusterä¸­çš„ä½œç”¨

**ğŸ¯ ç†è§£Performance Schemaçš„ä»·å€¼**

```
Performance Schemaå°±åƒæ˜¯MySQLçš„"ä½“æ£€æŠ¥å‘Š"ï¼š
- è®°å½•æ•°æ®åº“å†…éƒ¨çš„å„ç§è¿è¡ŒçŠ¶æ€
- æä¾›è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œè¯Šæ–­ä¿¡æ¯
- åœ¨Clusterç¯å¢ƒä¸­æ›´åŠ é‡è¦

ä¸ºä»€ä¹ˆåœ¨Clusterä¸­æ›´é‡è¦ï¼Ÿ
1. å¤šèŠ‚ç‚¹åè°ƒï¼šéœ€è¦äº†è§£æ¯ä¸ªèŠ‚ç‚¹çš„è¯¦ç»†çŠ¶æ€
2. æ€§èƒ½ç“¶é¢ˆï¼šæ‰¾å‡ºæ‹–æ…¢æ•´ä¸ªé›†ç¾¤çš„èŠ‚ç‚¹
3. æ•…éšœè¯Šæ–­ï¼šå®šä½é›†ç¾¤é—®é¢˜çš„æ ¹æœ¬åŸå› 
```

### 2.2 æ ¸å¿ƒç›‘æ§è¡¨è¯¦è§£

**ğŸ“Š é‡è¦çš„Performance Schemaè¡¨**

```sql
-- 1. å¤åˆ¶ç»„åŸºç¡€ä¿¡æ¯
SELECT * FROM performance_schema.replication_group_members;

-- 2. å¤åˆ¶ç»„æ€§èƒ½ç»Ÿè®¡
SELECT * FROM performance_schema.replication_group_member_stats;

-- 3. è¿æ¥çŠ¶æ€ç›‘æ§
SELECT * FROM performance_schema.replication_connection_status;

-- 4. åº”ç”¨å™¨çŠ¶æ€ç›‘æ§
SELECT * FROM performance_schema.replication_applier_status;

-- 5. äº‹ä»¶ç­‰å¾…ç›‘æ§
SELECT * FROM performance_schema.events_waits_summary_global_by_event_name;
```

### 2.3 å®æ—¶çŠ¶æ€æŸ¥è¯¢æŠ€å·§

**ğŸ”§ å¸¸ç”¨ç›‘æ§æŸ¥è¯¢**

```sql
-- å¿«é€Ÿæ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€
SELECT 
    MEMBER_HOST,
    MEMBER_PORT,
    MEMBER_STATE,
    MEMBER_ROLE,
    MEMBER_VERSION
FROM performance_schema.replication_group_members
ORDER BY MEMBER_STATE DESC;

-- æ£€æŸ¥èŠ‚ç‚¹æ€§èƒ½å·®å¼‚
SELECT 
    MEMBER_ID,
    COUNT_TRANSACTIONS_IN_QUEUE,
    COUNT_TRANSACTIONS_CHECKED,
    COUNT_CONFLICTS_DETECTED,
    COUNT_TRANSACTIONS_ROWS_VALIDATING
FROM performance_schema.replication_group_member_stats;

-- ç›‘æ§è¿æ¥å’Œäº‹åŠ¡å¤„ç†
SELECT 
    EVENT_NAME,
    COUNT_STAR,
    SUM_TIMER_WAIT/1000000000 as TOTAL_TIME_SEC,
    AVG_TIMER_WAIT/1000000000 as AVG_TIME_SEC
FROM performance_schema.events_statements_summary_global_by_event_name
WHERE EVENT_NAME LIKE '%transaction%'
ORDER BY TOTAL_TIME_SEC DESC;
```

**ğŸ’¡ ç›‘æ§è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash
# Clusterå¥åº·æ£€æŸ¥è„šæœ¬

echo "=== InnoDB ClusterçŠ¶æ€æ£€æŸ¥ ==="

# æ£€æŸ¥é›†ç¾¤æˆå‘˜çŠ¶æ€
mysql -e "
SELECT 
    MEMBER_HOST as 'èŠ‚ç‚¹',
    MEMBER_STATE as 'çŠ¶æ€',
    MEMBER_ROLE as 'è§’è‰²',
    IF(MEMBER_STATE='ONLINE','âœ“','âœ—') as 'å¥åº·çŠ¶æ€'
FROM performance_schema.replication_group_members;
"

# æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡
mysql -e "
SELECT 
    SUBSTRING_INDEX(MEMBER_ID,'-',1) as 'èŠ‚ç‚¹ç®€ç§°',
    COUNT_TRANSACTIONS_IN_QUEUE as 'é˜Ÿåˆ—äº‹åŠ¡æ•°',
    COUNT_CONFLICTS_DETECTED as 'å†²çªæ£€æµ‹æ•°'
FROM performance_schema.replication_group_member_stats;
"
```

---

## 3. ğŸ‘¥ replication_group_membersè¡¨è¯¦è§£


### 3.1 è¡¨ç»“æ„å’Œå­—æ®µå«ä¹‰

**ğŸ“‹ æ ¸å¿ƒå­—æ®µè§£æ**

```sql
-- replication_group_membersè¡¨ç»“æ„
DESC performance_schema.replication_group_members;

å­—æ®µè¯¦è§£ï¼š
CHANNEL_NAME     -- å¤åˆ¶é€šé“åç§°
MEMBER_ID        -- æˆå‘˜å”¯ä¸€æ ‡è¯†ç¬¦
MEMBER_HOST      -- æˆå‘˜ä¸»æœºåœ°å€  
MEMBER_PORT      -- æˆå‘˜ç«¯å£å·
MEMBER_STATE     -- æˆå‘˜å½“å‰çŠ¶æ€
MEMBER_ROLE      -- æˆå‘˜è§’è‰²(PRIMARY/SECONDARY)
MEMBER_VERSION   -- æˆå‘˜MySQLç‰ˆæœ¬
```

**ğŸ”¸ MEMBER_STATEçŠ¶æ€è¯¦è§£**
```
ONLINE        -- æ­£å¸¸åœ¨çº¿ï¼Œå¯ä»¥å¤„ç†è¯»å†™è¯·æ±‚
RECOVERING    -- æ­£åœ¨æ¢å¤ä¸­ï¼Œè¿½èµ¶é›†ç¾¤æ•°æ®
OFFLINE       -- ç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•æä¾›æœåŠ¡
ERROR         -- é”™è¯¯çŠ¶æ€ï¼Œéœ€è¦äººå·¥å¹²é¢„
UNREACHABLE   -- ç½‘ç»œä¸å¯è¾¾ï¼Œå¯èƒ½çš„ç½‘ç»œåˆ†åŒº

çŠ¶æ€è½¬æ¢æµç¨‹ï¼š
OFFLINE â†’ RECOVERING â†’ ONLINE
              â†“
           ERROR (å¼‚å¸¸æƒ…å†µ)
```

### 3.2 å®æ—¶çŠ¶æ€ç›‘æ§

**ğŸ“Š èŠ‚ç‚¹çŠ¶æ€ç›‘æ§æŸ¥è¯¢**

```sql
-- åŸºç¡€çŠ¶æ€æ£€æŸ¥
SELECT 
    CONCAT(MEMBER_HOST,':',MEMBER_PORT) AS 'èŠ‚ç‚¹åœ°å€',
    MEMBER_STATE AS 'çŠ¶æ€',
    MEMBER_ROLE AS 'è§’è‰²',
    CASE 
        WHEN MEMBER_STATE = 'ONLINE' THEN 'æ­£å¸¸'
        WHEN MEMBER_STATE = 'RECOVERING' THEN 'æ¢å¤ä¸­'
        WHEN MEMBER_STATE = 'OFFLINE' THEN 'ç¦»çº¿'
        ELSE 'å¼‚å¸¸'
    END AS 'ä¸­æ–‡çŠ¶æ€'
FROM performance_schema.replication_group_members;

-- æ£€æŸ¥PRIMARYèŠ‚ç‚¹
SELECT 
    CONCAT(MEMBER_HOST,':',MEMBER_PORT) AS 'PRIMARYèŠ‚ç‚¹'
FROM performance_schema.replication_group_members 
WHERE MEMBER_ROLE = 'PRIMARY' 
  AND MEMBER_STATE = 'ONLINE';

-- ç»Ÿè®¡å„çŠ¶æ€èŠ‚ç‚¹æ•°é‡
SELECT 
    MEMBER_STATE AS 'èŠ‚ç‚¹çŠ¶æ€',
    COUNT(*) AS 'èŠ‚ç‚¹æ•°é‡'
FROM performance_schema.replication_group_members 
GROUP BY MEMBER_STATE;
```

### 3.3 èŠ‚ç‚¹å˜æ›´å†å²è·Ÿè¸ª

**ğŸ“ˆ çŠ¶æ€å˜æ›´ç›‘æ§**

```sql
-- åˆ›å»ºç›‘æ§è®°å½•è¡¨
CREATE TABLE cluster_status_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    check_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    member_host VARCHAR(255),
    member_port INT,
    member_state VARCHAR(20),
    member_role VARCHAR(20)
);

-- å®šæœŸè®°å½•é›†ç¾¤çŠ¶æ€çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE RecordClusterStatus()
BEGIN
    INSERT INTO cluster_status_history 
    (member_host, member_port, member_state, member_role)
    SELECT 
        MEMBER_HOST,
        MEMBER_PORT, 
        MEMBER_STATE,
        MEMBER_ROLE
    FROM performance_schema.replication_group_members;
END$$
DELIMITER ;

-- æ¯åˆ†é’Ÿæ‰§è¡ŒçŠ¶æ€è®°å½•
-- é…ç½®å®šæ—¶ä»»åŠ¡: */1 * * * * mysql -e "CALL RecordClusterStatus();"
```

**ğŸ” çŠ¶æ€å˜æ›´åˆ†æ**
```sql
-- æŸ¥çœ‹æœ€è¿‘çš„çŠ¶æ€å˜æ›´
SELECT 
    check_time AS 'æ£€æŸ¥æ—¶é—´',
    CONCAT(member_host,':',member_port) AS 'èŠ‚ç‚¹',
    member_state AS 'çŠ¶æ€',
    member_role AS 'è§’è‰²'
FROM cluster_status_history 
WHERE check_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
ORDER BY check_time DESC;

-- æ£€æµ‹çŠ¶æ€å¼‚å¸¸èŠ‚ç‚¹
SELECT 
    CONCAT(member_host,':',member_port) AS 'å¼‚å¸¸èŠ‚ç‚¹',
    member_state AS 'å½“å‰çŠ¶æ€',
    COUNT(*) AS 'å¼‚å¸¸æ¬¡æ•°'
FROM cluster_status_history 
WHERE member_state != 'ONLINE' 
  AND check_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
GROUP BY member_host, member_port, member_state
ORDER BY å¼‚å¸¸æ¬¡æ•° DESC;
```

---

## 4. ğŸ“Š replication_group_member_statsè¡¨åˆ†æ


### 4.1 è¡¨ç»“æ„å’Œå…³é”®æŒ‡æ ‡

**ğŸ“‹ æ€§èƒ½ç»Ÿè®¡å­—æ®µè§£æ**

```sql
-- æŸ¥çœ‹ç»Ÿè®¡è¡¨ç»“æ„
SELECT 
    COLUMN_NAME as 'å­—æ®µå',
    COLUMN_COMMENT as 'å­—æ®µè¯´æ˜'
FROM information_schema.COLUMNS 
WHERE TABLE_NAME = 'replication_group_member_stats' 
  AND TABLE_SCHEMA = 'performance_schema';

æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼š
COUNT_TRANSACTIONS_IN_QUEUE         -- é˜Ÿåˆ—ä¸­ç­‰å¾…å¤„ç†çš„äº‹åŠ¡æ•°
COUNT_TRANSACTIONS_CHECKED          -- å·²æ£€æŸ¥çš„äº‹åŠ¡æ•°
COUNT_CONFLICTS_DETECTED            -- æ£€æµ‹åˆ°çš„å†²çªæ•°
COUNT_TRANSACTIONS_ROWS_VALIDATING  -- æ­£åœ¨éªŒè¯çš„äº‹åŠ¡è¡Œæ•°
TRANSACTIONS_COMMITTED_ALL_MEMBERS  -- æ‰€æœ‰æˆå‘˜éƒ½å·²æäº¤çš„äº‹åŠ¡
LAST_CONFLICT_FREE_TRANSACTION      -- æœ€åä¸€ä¸ªæ— å†²çªäº‹åŠ¡
```

### 4.2 äº‹åŠ¡å¤„ç†æ€§èƒ½ç›‘æ§

**âš¡ äº‹åŠ¡é˜Ÿåˆ—å’Œå†²çªç›‘æ§**

```sql
-- äº‹åŠ¡å¤„ç†æ•´ä½“çŠ¶å†µ
SELECT 
    SUBSTRING_INDEX(MEMBER_ID, '-', 1) AS 'èŠ‚ç‚¹ID',
    COUNT_TRANSACTIONS_IN_QUEUE AS 'é˜Ÿåˆ—äº‹åŠ¡æ•°',
    COUNT_TRANSACTIONS_CHECKED AS 'å·²æ£€æŸ¥äº‹åŠ¡æ•°',
    COUNT_CONFLICTS_DETECTED AS 'å†²çªæ•°',
    ROUND(
        COUNT_CONFLICTS_DETECTED / 
        NULLIF(COUNT_TRANSACTIONS_CHECKED, 0) * 100, 2
    ) AS 'å†²çªç‡%'
FROM performance_schema.replication_group_member_stats;

-- æ£€æŸ¥äº‹åŠ¡å¤„ç†ç“¶é¢ˆ
SELECT 
    MEMBER_ID,
    COUNT_TRANSACTIONS_IN_QUEUE AS 'é˜Ÿåˆ—ç§¯å‹',
    COUNT_TRANSACTIONS_ROWS_VALIDATING AS 'éªŒè¯ä¸­è¡Œæ•°',
    CASE 
        WHEN COUNT_TRANSACTIONS_IN_QUEUE > 100 THEN 'é˜Ÿåˆ—ç§¯å‹ä¸¥é‡'
        WHEN COUNT_TRANSACTIONS_IN_QUEUE > 50 THEN 'é˜Ÿåˆ—ç§¯å‹ä¸­ç­‰'
        WHEN COUNT_TRANSACTIONS_IN_QUEUE > 10 THEN 'é˜Ÿåˆ—ç§¯å‹è½»å¾®'
        ELSE 'é˜Ÿåˆ—æ­£å¸¸'
    END AS 'é˜Ÿåˆ—çŠ¶æ€è¯„ä¼°'
FROM performance_schema.replication_group_member_stats;
```

### 4.3 å†²çªæ£€æµ‹å’Œåˆ†æ

**ğŸš¨ æ•°æ®å†²çªç›‘æ§**

```sql
-- å†²çªç»Ÿè®¡åˆ†æ
SELECT 
    m.MEMBER_HOST,
    m.MEMBER_PORT,
    s.COUNT_CONFLICTS_DETECTED AS 'å†²çªæ€»æ•°',
    s.COUNT_TRANSACTIONS_CHECKED AS 'æ£€æŸ¥æ€»æ•°',
    ROUND(
        s.COUNT_CONFLICTS_DETECTED / 
        NULLIF(s.COUNT_TRANSACTIONS_CHECKED, 0) * 100, 4
    ) AS 'å†²çªç‡%'
FROM performance_schema.replication_group_members m
JOIN performance_schema.replication_group_member_stats s
  ON m.MEMBER_ID = s.MEMBER_ID
WHERE m.MEMBER_STATE = 'ONLINE'
ORDER BY å†²çªç‡% DESC;

-- å†²çªè¶‹åŠ¿ç›‘æ§
CREATE TABLE conflict_history (
    record_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    member_id VARCHAR(36),
    conflicts_detected INT,
    transactions_checked INT,
    conflict_rate DECIMAL(10,4)
);

-- è®°å½•å†²çªå†å²çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE RecordConflictStats()
BEGIN
    INSERT INTO conflict_history 
    (member_id, conflicts_detected, transactions_checked, conflict_rate)
    SELECT 
        MEMBER_ID,
        COUNT_CONFLICTS_DETECTED,
        COUNT_TRANSACTIONS_CHECKED,
        ROUND(
            COUNT_CONFLICTS_DETECTED / 
            NULLIF(COUNT_TRANSACTIONS_CHECKED, 0) * 100, 4
        )
    FROM performance_schema.replication_group_member_stats;
END$$
DELIMITER ;
```

**ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿åˆ†æ**
```sql
-- æœ€è¿‘1å°æ—¶çš„å†²çªè¶‹åŠ¿
SELECT 
    DATE_FORMAT(record_time, '%H:%i') AS 'æ—¶é—´',
    AVG(conflict_rate) AS 'å¹³å‡å†²çªç‡%',
    MAX(conflict_rate) AS 'æœ€é«˜å†²çªç‡%',
    COUNT(DISTINCT member_id) AS 'èŠ‚ç‚¹æ•°'
FROM conflict_history 
WHERE record_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY DATE_FORMAT(record_time, '%H:%i')
ORDER BY æ—¶é—´;

-- è¯†åˆ«å†²çªé¢‘å‘çš„èŠ‚ç‚¹
SELECT 
    member_id AS 'é—®é¢˜èŠ‚ç‚¹',
    AVG(conflict_rate) AS 'å¹³å‡å†²çªç‡%',
    MAX(conflict_rate) AS 'æœ€é«˜å†²çªç‡%',
    COUNT(*) AS 'è®°å½•æ•°'
FROM conflict_history 
WHERE record_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
  AND conflict_rate > 1.0  -- å†²çªç‡è¶…è¿‡1%
GROUP BY member_id
ORDER BY å¹³å‡å†²çªç‡% DESC;
```

---

## 5. ğŸ“ å…³é”®æ€§èƒ½æŒ‡æ ‡KPIä½“ç³»


### 5.1 é›†ç¾¤å¯ç”¨æ€§KPI

**ğŸ¯ å¯ç”¨æ€§å…³é”®æŒ‡æ ‡å®šä¹‰**

```
ğŸŸ¢ é›†ç¾¤æ•´ä½“å¯ç”¨æ€§æŒ‡æ ‡ï¼š

1. é›†ç¾¤å¯ç”¨ç‡ = æ­£å¸¸æœåŠ¡æ—¶é—´ / æ€»æ—¶é—´ * 100%
   ç›®æ ‡ï¼šâ‰¥ 99.9% (å¹´åœæœºæ—¶é—´ < 8.76å°æ—¶)

2. èŠ‚ç‚¹åœ¨çº¿ç‡ = ONLINEèŠ‚ç‚¹æ•° / æ€»èŠ‚ç‚¹æ•° * 100%
   ç›®æ ‡ï¼šâ‰¥ 66.7% (3èŠ‚ç‚¹è‡³å°‘2ä¸ªåœ¨çº¿)

3. PRIMARYèŠ‚ç‚¹ç¨³å®šæ€§ = PRIMARYè§’è‰²è¿ç»­æ—¶é—´
   ç›®æ ‡ï¼šæ•…éšœåˆ‡æ¢æ¬¡æ•° < 5æ¬¡/æœˆ

4. è‡ªåŠ¨æ•…éšœæ¢å¤ç‡ = è‡ªåŠ¨æ¢å¤æˆåŠŸæ¬¡æ•° / æ•…éšœæ€»æ¬¡æ•° * 100%
   ç›®æ ‡ï¼šâ‰¥ 95%
```

**ğŸ“Š å¯ç”¨æ€§ç›‘æ§å®ç°**
```sql
-- å®æ—¶å¯ç”¨æ€§æ£€æŸ¥
SELECT 
    COUNT(*) AS 'æ€»èŠ‚ç‚¹æ•°',
    SUM(CASE WHEN MEMBER_STATE = 'ONLINE' THEN 1 ELSE 0 END) AS 'åœ¨çº¿èŠ‚ç‚¹æ•°',
    ROUND(
        SUM(CASE WHEN MEMBER_STATE = 'ONLINE' THEN 1 ELSE 0 END) / 
        COUNT(*) * 100, 2
    ) AS 'èŠ‚ç‚¹åœ¨çº¿ç‡%',
    CASE 
        WHEN SUM(CASE WHEN MEMBER_STATE = 'ONLINE' THEN 1 ELSE 0 END) >= 2 
        THEN 'é›†ç¾¤å¯ç”¨' 
        ELSE 'é›†ç¾¤é£é™©' 
    END AS 'å¯ç”¨æ€§çŠ¶æ€'
FROM performance_schema.replication_group_members;

-- PRIMARYç¨³å®šæ€§ç›‘æ§
CREATE TABLE primary_change_log (
    change_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    old_primary VARCHAR(100),
    new_primary VARCHAR(100),
    change_reason VARCHAR(255)
);
```

### 5.2 æ€§èƒ½ååé‡KPI

**âš¡ æ€§èƒ½å…³é”®æŒ‡æ ‡**

```
ğŸŸ¡ æ€§èƒ½ååé‡æŒ‡æ ‡ï¼š

1. é›†ç¾¤æ€»QPS = æ‰€æœ‰èŠ‚ç‚¹QPSä¹‹å’Œ
   ç›®æ ‡ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾å®šåŸºçº¿

2. å†™äº‹åŠ¡å»¶è¿Ÿ = äº‹åŠ¡æäº¤å“åº”æ—¶é—´
   ç›®æ ‡ï¼šP95 < 100ms, P99 < 500ms

3. å¤åˆ¶å»¶è¿Ÿ = ä¸»ä»æ•°æ®åŒæ­¥å»¶è¿Ÿ
   ç›®æ ‡ï¼šå¹³å‡ < 10ms, æœ€å¤§ < 100ms

4. äº‹åŠ¡å†²çªç‡ = å†²çªäº‹åŠ¡æ•° / æ€»äº‹åŠ¡æ•° * 100%
   ç›®æ ‡ï¼š< 1%
```

**ğŸ”§ æ€§èƒ½ç›‘æ§æŸ¥è¯¢**
```sql
-- é›†ç¾¤ååé‡ç»Ÿè®¡
SELECT 
    'QPS' AS 'æŒ‡æ ‡ç±»å‹',
    SUM(VARIABLE_VALUE) AS 'å½“å‰å€¼'
FROM performance_schema.global_status 
WHERE VARIABLE_NAME = 'Queries'
UNION ALL
SELECT 
    'TPS' AS 'æŒ‡æ ‡ç±»å‹',
    SUM(VARIABLE_VALUE) AS 'å½“å‰å€¼'
FROM performance_schema.global_status 
WHERE VARIABLE_NAME IN ('Com_commit', 'Com_rollback');

-- å¤åˆ¶å»¶è¿Ÿç›‘æ§
SELECT 
    CHANNEL_NAME AS 'å¤åˆ¶é€šé“',
    LAST_HEARTBEAT_TIMESTAMP AS 'æœ€åå¿ƒè·³æ—¶é—´',
    TIMESTAMPDIFF(SECOND, LAST_HEARTBEAT_TIMESTAMP, NOW()) AS 'å»¶è¿Ÿç§’æ•°',
    CASE 
        WHEN TIMESTAMPDIFF(SECOND, LAST_HEARTBEAT_TIMESTAMP, NOW()) < 10 THEN 'æ­£å¸¸'
        WHEN TIMESTAMPDIFF(SECOND, LAST_HEARTBEAT_TIMESTAMP, NOW()) < 60 THEN 'è½»å¾®å»¶è¿Ÿ'
        ELSE 'ä¸¥é‡å»¶è¿Ÿ'
    END AS 'å»¶è¿ŸçŠ¶æ€'
FROM performance_schema.replication_connection_status;
```

### 5.3 èµ„æºåˆ©ç”¨ç‡KPI

**ğŸ’» èµ„æºæ¶ˆè€—æŒ‡æ ‡**

```
ğŸ”´ èµ„æºåˆ©ç”¨ç‡æŒ‡æ ‡ï¼š

1. CPUåˆ©ç”¨ç‡ = å·²ä½¿ç”¨CPU / æ€»CPU * 100%
   ç›®æ ‡ï¼šå¹³å‡ < 70%, å³°å€¼ < 90%

2. å†…å­˜åˆ©ç”¨ç‡ = å·²ä½¿ç”¨å†…å­˜ / æ€»å†…å­˜ * 100%
   ç›®æ ‡ï¼š< 80%

3. ç£ç›˜åˆ©ç”¨ç‡ = å·²ä½¿ç”¨ç£ç›˜ / æ€»ç£ç›˜ * 100%
   ç›®æ ‡ï¼š< 85%

4. ç½‘ç»œå¸¦å®½åˆ©ç”¨ç‡ = ç½‘ç»œæµé‡ / å¸¦å®½å®¹é‡ * 100%
   ç›®æ ‡ï¼š< 80%
```

**ğŸ“ˆ èµ„æºç›‘æ§å®ç°**
```sql
-- MySQLå†…å­˜ä½¿ç”¨ç›‘æ§
SELECT 
    event_name AS 'å†…å­˜äº‹ä»¶',
    current_count AS 'å½“å‰æ•°é‡',
    current_alloc AS 'å½“å‰åˆ†é…',
    ROUND(current_alloc/1024/1024, 2) AS 'å½“å‰åˆ†é…MB'
FROM performance_schema.memory_summary_global_by_event_name 
WHERE current_alloc > 0 
ORDER BY current_alloc DESC 
LIMIT 10;

-- è¿æ¥æ•°ä½¿ç”¨ç‡
SELECT 
    'max_connections' AS 'é…ç½®é¡¹',
    $$max_connections AS 'æœ€å¤§å€¼',
    (SELECT COUNT(*) FROM information_schema.PROCESSLIST) AS 'å½“å‰å€¼',
    ROUND(
        (SELECT COUNT(*) FROM information_schema.PROCESSLIST) / 
        $$max_connections * 100, 2
    ) AS 'ä½¿ç”¨ç‡%';
```

---

## 6. ğŸ”„ ç›‘æ§æ•°æ®é‡‡é›†ç­–ç•¥


### 6.1 æ•°æ®é‡‡é›†é¢‘ç‡è®¾è®¡

**â° åˆ†å±‚é‡‡é›†ç­–ç•¥**

```
ç›‘æ§æ•°æ®é‡‡é›†é¢‘ç‡åˆ†çº§ï¼š

ğŸ”´ å®æ—¶çº§ (1-5ç§’)ï¼š
- é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€
- ä¸»èŠ‚ç‚¹å¿ƒè·³æ£€æµ‹
- å…³é”®é”™è¯¯æ—¥å¿—

ğŸŸ¡ é«˜é¢‘çº§ (30ç§’-1åˆ†é’Ÿ)ï¼š
- æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- äº‹åŠ¡å¤„ç†é‡
- å¤åˆ¶å»¶è¿Ÿæ•°æ®

ğŸŸ¢ ä¸­é¢‘çº§ (5-15åˆ†é’Ÿ)ï¼š
- èµ„æºä½¿ç”¨ç»Ÿè®¡
- æ…¢æŸ¥è¯¢åˆ†æ
- è¿æ¥æ•°ç»Ÿè®¡

ğŸŸ£ ä½é¢‘çº§ (1å°æ—¶-1å¤©)ï¼š
- å†å²è¶‹åŠ¿åˆ†æ
- å®¹é‡è§„åˆ’æ•°æ®
- é•¿æœŸæ€§èƒ½æŠ¥å‘Š
```

**ğŸ”§ é‡‡é›†é…ç½®ç¤ºä¾‹**
```bash
# ç›‘æ§é…ç½®æ–‡ä»¶ monitor_config.yaml
data_collection:
  real_time:  # å®æ—¶ç›‘æ§ - 5ç§’é—´éš”
    interval: 5
    metrics:
      - cluster_member_status
      - primary_heartbeat
      - error_log_monitor
  
  high_frequency:  # é«˜é¢‘ç›‘æ§ - 30ç§’é—´éš”
    interval: 30
    metrics:
      - performance_stats
      - transaction_stats
      - replication_lag
  
  medium_frequency:  # ä¸­é¢‘ç›‘æ§ - 5åˆ†é’Ÿé—´éš”
    interval: 300
    metrics:
      - resource_usage
      - slow_query_stats
      - connection_stats
```

### 6.2 æ•°æ®é‡‡é›†è„šæœ¬è®¾è®¡

**ğŸ“ è‡ªåŠ¨åŒ–é‡‡é›†å®ç°**

```bash
#!/bin/bash
# InnoDB Clusterç›‘æ§æ•°æ®é‡‡é›†è„šæœ¬

# é…ç½®å‚æ•°
MYSQL_HOST="localhost"
MYSQL_PORT="3306"
MYSQL_USER="monitor_user"
MYSQL_PASS="secure_password"
OUTPUT_DIR="/var/log/mysql_monitor"

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p $OUTPUT_DIR

# 1. å®æ—¶çŠ¶æ€é‡‡é›†å‡½æ•°
collect_realtime_data() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # é›†ç¾¤æˆå‘˜çŠ¶æ€
    mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASS \
    -e "SELECT '$timestamp' as check_time, 
           MEMBER_HOST, MEMBER_PORT, MEMBER_STATE, MEMBER_ROLE
        FROM performance_schema.replication_group_members;" \
    > $OUTPUT_DIR/cluster_status_$(date +%Y%m%d).log
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç¦»çº¿èŠ‚ç‚¹
    offline_nodes=$(mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASS \
    -e "SELECT COUNT(*) FROM performance_schema.replication_group_members 
        WHERE MEMBER_STATE != 'ONLINE';" -N)
    
    if [ "$offline_nodes" -gt 0 ]; then
        echo "[$timestamp] è­¦å‘Š: å‘ç° $offline_nodes ä¸ªç¦»çº¿èŠ‚ç‚¹" >> $OUTPUT_DIR/alerts.log
    fi
}

# 2. æ€§èƒ½æ•°æ®é‡‡é›†å‡½æ•°
collect_performance_data() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # äº‹åŠ¡ç»Ÿè®¡
    mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASS \
    -e "SELECT '$timestamp' as check_time,
           MEMBER_ID,
           COUNT_TRANSACTIONS_IN_QUEUE,
           COUNT_TRANSACTIONS_CHECKED,
           COUNT_CONFLICTS_DETECTED
        FROM performance_schema.replication_group_member_stats;" \
    >> $OUTPUT_DIR/performance_stats_$(date +%Y%m%d).log
}

# 3. èµ„æºä½¿ç”¨é‡‡é›†å‡½æ•°
collect_resource_data() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è¿æ¥æ•°ç»Ÿè®¡
    connections=$(mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASS \
    -e "SELECT COUNT(*) FROM information_schema.PROCESSLIST;" -N)
    
    max_connections=$(mysql -h$MYSQL_HOST -P$MYSQL_PORT -u$MYSQL_USER -p$MYSQL_PASS \
    -e "SELECT $$max_connections;" -N)
    
    connection_usage=$(echo "scale=2; $connections * 100 / $max_connections" | bc)
    
    echo "$timestamp,$connections,$max_connections,$connection_usage" \
    >> $OUTPUT_DIR/connection_stats_$(date +%Y%m%d).log
}

# ä¸»æ‰§è¡Œé€»è¾‘
case "$1" in
    "realtime")
        collect_realtime_data
        ;;
    "performance")
        collect_performance_data
        ;;
    "resource")
        collect_resource_data
        ;;
    *)
        echo "ç”¨æ³•: $0 {realtime|performance|resource}"
        exit 1
        ;;
esac
```

### 6.3 æ•°æ®å­˜å‚¨ç­–ç•¥

**ğŸ’¾ æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ**

```
æ•°æ®å­˜å‚¨åˆ†å±‚ç­–ç•¥ï¼š

ğŸ“Š æ—¶åºæ•°æ®åº“ (Prometheus/InfluxDB)ï¼š
- å®æ—¶æ€§èƒ½æŒ‡æ ‡
- å†å²è¶‹åŠ¿æ•°æ®
- è‡ªåŠ¨æ•°æ®å‹ç¼©

ğŸ“ æ—¥å¿—æ–‡ä»¶ï¼š
- è¯¦ç»†çš„äº‹ä»¶è®°å½•
- é”™è¯¯å’Œå¼‚å¸¸ä¿¡æ¯
- ä¾¿äºé—®é¢˜å›æº¯

ğŸ—„ï¸ å…³ç³»æ•°æ®åº“ï¼š
- é…ç½®ä¿¡æ¯å­˜å‚¨
- å‘Šè­¦è§„åˆ™å®šä¹‰
- ç›‘æ§å…ƒæ•°æ®ç®¡ç†

â˜ï¸ å¯¹è±¡å­˜å‚¨ï¼š
- é•¿æœŸå†å²æ•°æ®å½’æ¡£
- å¤§æ–‡ä»¶å¤‡ä»½å­˜å‚¨
- æˆæœ¬ä¼˜åŒ–æ–¹æ¡ˆ
```

**ğŸ”§ å­˜å‚¨é…ç½®ç¤ºä¾‹**
```yaml
# æ•°æ®å­˜å‚¨é…ç½®
storage:
  timeseries:
    type: "prometheus"
    retention: "30d"
    compression: true
    
  logs:
    path: "/var/log/mysql_monitor"
    rotation: "daily"
    retention: "90d"
    
  database:
    type: "mysql"
    host: "monitor-db"
    database: "mysql_monitor"
    
  archive:
    type: "s3"
    bucket: "mysql-monitor-archive"
    retention: "2y"
```

---

## 7. ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®


### 7.1 å‘Šè­¦çº§åˆ«åˆ†ç±»

**ğŸ“¢ å‘Šè­¦ä¸¥é‡ç¨‹åº¦å®šä¹‰**

```
å‘Šè­¦çº§åˆ«åˆ†ç±»ï¼š

ğŸ”´ CRITICAL (ç´§æ€¥)ï¼š
- é›†ç¾¤ä¸å¯ç”¨ (åœ¨çº¿èŠ‚ç‚¹ < 2)
- PRIMARYèŠ‚ç‚¹å®•æœº
- æ•°æ®ä¸¢å¤±é£é™©
- å“åº”æ—¶é—´ï¼šç«‹å³å¤„ç† (< 5åˆ†é’Ÿ)

ğŸŸ¡ WARNING (è­¦å‘Š)ï¼š
- èŠ‚ç‚¹çŠ¶æ€å¼‚å¸¸
- æ€§èƒ½æŒ‡æ ‡è¶…é˜ˆå€¼
- èµ„æºä½¿ç”¨ç‡è¿‡é«˜
- å“åº”æ—¶é—´ï¼š1å°æ—¶å†…å¤„ç†

ğŸŸ¢ INFO (ä¿¡æ¯)ï¼š
- é…ç½®å˜æ›´é€šçŸ¥
- å®šæœŸçŠ¶æ€æŠ¥å‘Š
- æ€§èƒ½è¶‹åŠ¿æé†’
- å“åº”æ—¶é—´ï¼šå·¥ä½œæ—¶é—´å†…å¤„ç†

âšª DEBUG (è°ƒè¯•)ï¼š
- è¯¦ç»†è¯Šæ–­ä¿¡æ¯
- å¼€å‘è°ƒè¯•æ•°æ®
- æ€§èƒ½åˆ†ææ•°æ®
- å“åº”æ—¶é—´ï¼šå¯é€‰å¤„ç†
```

### 7.2 æ ¸å¿ƒå‘Šè­¦è§„åˆ™

**âš™ï¸ å…³é”®å‘Šè­¦è§„åˆ™é…ç½®**

```yaml
# å‘Šè­¦è§„åˆ™é…ç½®æ–‡ä»¶ alert_rules.yaml

groups:
  - name: innodb_cluster_critical
    interval: 30s
    rules:
      # é›†ç¾¤å¯ç”¨æ€§å‘Šè­¦
      - alert: ClusterUnavailable
        expr: mysql_cluster_online_nodes < 2
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "InnoDB Clusterä¸å¯ç”¨"
          description: "é›†ç¾¤åœ¨çº¿èŠ‚ç‚¹æ•°å°‘äº2ä¸ªï¼Œé›†ç¾¤ä¸å¯ç”¨"
      
      # PRIMARYèŠ‚ç‚¹æ•…éšœ
      - alert: PrimaryNodeDown
        expr: mysql_cluster_primary_nodes == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "PRIMARYèŠ‚ç‚¹ä¸å¯ç”¨"
          description: "æ²¡æœ‰å¯ç”¨çš„PRIMARYèŠ‚ç‚¹"
      
      # é«˜å†²çªç‡å‘Šè­¦
      - alert: HighConflictRate
        expr: mysql_cluster_conflict_rate > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "äº‹åŠ¡å†²çªç‡è¿‡é«˜"
          description: "é›†ç¾¤äº‹åŠ¡å†²çªç‡è¶…è¿‡5%"

  - name: innodb_cluster_performance
    interval: 1m
    rules:
      # å¤åˆ¶å»¶è¿Ÿå‘Šè­¦
      - alert: ReplicationLag
        expr: mysql_replication_lag_seconds > 60
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "å¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
          description: "å¤åˆ¶å»¶è¿Ÿè¶…è¿‡60ç§’"
      
      # äº‹åŠ¡é˜Ÿåˆ—ç§¯å‹
      - alert: TransactionQueueBacklog
        expr: mysql_transaction_queue_size > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "äº‹åŠ¡é˜Ÿåˆ—ç§¯å‹"
          description: "äº‹åŠ¡é˜Ÿåˆ—ç§¯å‹è¶…è¿‡100ä¸ª"
```

### 7.3 å‘Šè­¦é€šçŸ¥é…ç½®

**ğŸ“± å‘Šè­¦é€šçŸ¥æ¸ é“è®¾ç½®**

```yaml
# å‘Šè­¦é€šçŸ¥é…ç½® alertmanager.yaml

global:
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'mysql-alerts@company.com'

route:
  group_by: ['alertname', 'cluster']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default'
  routes:
    # ç´§æ€¥å‘Šè­¦ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # è­¦å‘Šçº§åˆ«çš„å‘Šè­¦
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 2m
      repeat_interval: 2h

receivers:
  # ç´§æ€¥å‘Šè­¦é€šçŸ¥
  - name: 'critical-alerts'
    email_configs:
      - to: 'dba-oncall@company.com'
        subject: 'ğŸ”´ CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          å‘Šè­¦æ—¶é—´: {{ .GroupLabels.alertname }}
          é›†ç¾¤: {{ .GroupLabels.cluster }}
          è¯¦æƒ…: {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
    
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/...'
        channel: '#dba-alerts'
        title: 'ğŸ”´ MySQLé›†ç¾¤ç´§æ€¥å‘Šè­¦'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
    
    webhook_configs:
      - url: 'http://phone-call-service/alert'  # ç”µè¯å‘Šè­¦
  
  # è­¦å‘Šçº§åˆ«é€šçŸ¥
  - name: 'warning-alerts'
    email_configs:
      - to: 'dba-team@company.com'
        subject: 'ğŸŸ¡ WARNING: {{ .GroupLabels.alertname }}'
```

### 7.4 å‘Šè­¦å¤„ç†æµç¨‹

**ğŸ”„ å‘Šè­¦å“åº”æ ‡å‡†åŒ–æµç¨‹**

```
å‘Šè­¦å¤„ç†SOP (æ ‡å‡†æ“ä½œç¨‹åº)ï¼š

1. å‘Šè­¦æ¥æ”¶ (0-5åˆ†é’Ÿ)
   â”œâ”€ ç¡®è®¤å‘Šè­¦ä¿¡æ¯
   â”œâ”€ åˆæ­¥å½±å“è¯„ä¼°
   â””â”€ å¯åŠ¨åº”æ€¥å“åº”

2. é—®é¢˜è¯Šæ–­ (5-15åˆ†é’Ÿ)
   â”œâ”€ æ£€æŸ¥é›†ç¾¤çŠ¶æ€
   â”œâ”€ åˆ†æé”™è¯¯æ—¥å¿—
   â”œâ”€ ç¡®å®šæ ¹æœ¬åŸå› 
   â””â”€ è¯„ä¼°ä¿®å¤æ–¹æ¡ˆ

3. é—®é¢˜å¤„ç† (15åˆ†é’Ÿ-æ•°å°æ—¶)
   â”œâ”€ æ‰§è¡Œä¿®å¤æªæ–½
   â”œâ”€ ç›‘æ§ä¿®å¤æ•ˆæœ
   â”œâ”€ éªŒè¯é›†ç¾¤æ¢å¤
   â””â”€ æ›´æ–°å¤„ç†è®°å½•

4. äº‹åæ€»ç»“ (24å°æ—¶å†…)
   â”œâ”€ ç¼–å†™æ•…éšœæŠ¥å‘Š
   â”œâ”€ åˆ†æé¢„é˜²æªæ–½
   â”œâ”€ ä¼˜åŒ–ç›‘æ§è§„åˆ™
   â””â”€ æ›´æ–°åº”æ€¥æ‰‹å†Œ
```

**ğŸ“‹ å‘Šè­¦å¤„ç†è®°å½•æ¨¡æ¿**
```sql
-- åˆ›å»ºå‘Šè­¦å¤„ç†è®°å½•è¡¨
CREATE TABLE alert_handling_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    alert_time TIMESTAMP,
    alert_name VARCHAR(100),
    severity VARCHAR(20),
    description TEXT,
    handler VARCHAR(50),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    actions_taken TEXT,
    root_cause TEXT,
    prevention_measures TEXT,
    status VARCHAR(20) DEFAULT 'OPEN'
);

-- è®°å½•å‘Šè­¦å¤„ç†è¿‡ç¨‹
INSERT INTO alert_handling_log 
(alert_time, alert_name, severity, description, handler, start_time)
VALUES 
('2024-01-11 10:30:00', 'ClusterUnavailable', 'CRITICAL', 
 'é›†ç¾¤åœ¨çº¿èŠ‚ç‚¹æ•°å°‘äº2ä¸ª', 'DBA_Zhang', NOW());
```

---

## 8. ğŸ”§ ç›‘æ§å·¥å…·é›†æˆ


### 8.1 Prometheusé›†æˆæ–¹æ¡ˆ

**ğŸ“Š Prometheusç›‘æ§é›†æˆ**

```yaml
# MySQL Exporteré…ç½® mysql_exporter.yml
collectors:
  # å¯ç”¨InnoDB Clusterç›¸å…³é‡‡é›†å™¨
  - cluster
  - replication
  - performance_schema
  - info_schema

cluster:
  # é›†ç¾¤çŠ¶æ€ç›‘æ§
  collect_cluster_status: true
  collect_member_stats: true
  
replication:
  # å¤åˆ¶çŠ¶æ€ç›‘æ§
  collect_replica_status: true
  collect_group_replication: true

# Prometheusé…ç½® prometheus.yml
scrape_configs:
  - job_name: 'mysql-cluster'
    static_configs:
      - targets: 
        - 'mysql-node1:9104'
        - 'mysql-node2:9104'  
        - 'mysql-node3:9104'
    scrape_interval: 15s
    metrics_path: /metrics
    
    # æ·»åŠ é›†ç¾¤æ ‡ç­¾
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - target_label: cluster
        replacement: 'production-cluster'
```

**ğŸ” å…³é”®Metricså®šä¹‰**
```
# InnoDB Clusteræ ¸å¿ƒæŒ‡æ ‡

mysql_cluster_member_state{member_host, member_role}  # èŠ‚ç‚¹çŠ¶æ€
mysql_cluster_online_nodes                           # åœ¨çº¿èŠ‚ç‚¹æ•°
mysql_cluster_primary_nodes                          # PRIMARYèŠ‚ç‚¹æ•°
mysql_cluster_conflict_rate                          # å†²çªç‡
mysql_replication_lag_seconds                        # å¤åˆ¶å»¶è¿Ÿ
mysql_transaction_queue_size                         # äº‹åŠ¡é˜Ÿåˆ—é•¿åº¦
mysql_cluster_member_uptime                          # èŠ‚ç‚¹è¿è¡Œæ—¶é—´
```

### 8.2 Grafanaä»ªè¡¨æ¿è®¾è®¡

**ğŸ“ˆ å¯è§†åŒ–ä»ªè¡¨æ¿é…ç½®**

```json
{
  "dashboard": {
    "title": "InnoDB Clusterç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "é›†ç¾¤æ¦‚è§ˆ",
        "type": "stat",
        "targets": [
          {
            "expr": "mysql_cluster_online_nodes",
            "legendFormat": "åœ¨çº¿èŠ‚ç‚¹æ•°"
          },
          {
            "expr": "mysql_cluster_primary_nodes", 
            "legendFormat": "PRIMARYèŠ‚ç‚¹æ•°"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "yellow", "value": 2},
                {"color": "green", "value": 3}
              ]
            }
          }
        }
      },
      {
        "title": "èŠ‚ç‚¹çŠ¶æ€",
        "type": "table",
        "targets": [
          {
            "expr": "mysql_cluster_member_state",
            "format": "table"
          }
        ]
      },
      {
        "title": "äº‹åŠ¡å†²çªç‡è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mysql_cluster_conflicts_total[5m]) * 100",
            "legendFormat": "å†²çªç‡%"
          }
        ]
      }
    ]
  }
}
```

### 8.3 Zabbixé›†æˆæ–¹æ¡ˆ

**ğŸ”” Zabbixç›‘æ§é›†æˆ**

```bash
# Zabbixç›‘æ§è„šæœ¬ mysql_cluster_check.sh
#!/bin/bash

MYSQL_USER="zabbix"
MYSQL_PASS="zabbix_password"
MYSQL_HOST="$1"
CHECK_TYPE="$2"

case "$CHECK_TYPE" in
    "cluster_status")
        # æ£€æŸ¥é›†ç¾¤çŠ¶æ€
        mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASS \
        -e "SELECT COUNT(*) FROM performance_schema.replication_group_members 
            WHERE MEMBER_STATE='ONLINE';" -N
        ;;
    
    "primary_count")
        # æ£€æŸ¥PRIMARYèŠ‚ç‚¹æ•°
        mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASS \
        -e "SELECT COUNT(*) FROM performance_schema.replication_group_members 
            WHERE MEMBER_ROLE='PRIMARY' AND MEMBER_STATE='ONLINE';" -N
        ;;
    
    "conflict_rate")
        # è®¡ç®—å†²çªç‡
        mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASS \
        -e "SELECT ROUND(
                SUM(COUNT_CONFLICTS_DETECTED) / 
                NULLIF(SUM(COUNT_TRANSACTIONS_CHECKED), 0) * 100, 2
            ) FROM performance_schema.replication_group_member_stats;" -N
        ;;
esac
```

**âš™ï¸ Zabbixæ¨¡æ¿é…ç½®**
```xml
<!-- Zabbixæ¨¡æ¿ç‰‡æ®µ -->
<template>
    <name>InnoDB Cluster</name>
    <items>
        <item>
            <name>é›†ç¾¤åœ¨çº¿èŠ‚ç‚¹æ•°</name>
            <type>EXTERNAL</type>
            <key>mysql_cluster_check.sh[{HOST.CONN},cluster_status]</key>
            <delay>30s</delay>
            <triggers>
                <trigger>
                    <expression>{last()}&lt;2</expression>
                    <name>é›†ç¾¤èŠ‚ç‚¹æ•°ä¸è¶³</name>
                    <priority>HIGH</priority>
                </trigger>
            </triggers>
        </item>
        
        <item>
            <name>PRIMARYèŠ‚ç‚¹æ•°</name>
            <type>EXTERNAL</type>
            <key>mysql_cluster_check.sh[{HOST.CONN},primary_count]</key>
            <delay>30s</delay>
            <triggers>
                <trigger>
                    <expression>{last()}=0</expression>
                    <name>æ²¡æœ‰PRIMARYèŠ‚ç‚¹</name>
                    <priority>DISASTER</priority>
                </trigger>
            </triggers>
        </item>
    </items>
</template>
```

---

## 9. ğŸ–¥ï¸ å¯è§†åŒ–ç›‘æ§ç•Œé¢


### 9.1 ç›‘æ§å¤§å±è®¾è®¡

**ğŸ“º è¿ç»´ä¸­å¿ƒå¤§å±å¸ƒå±€**

```
ç›‘æ§å¤§å±å¸ƒå±€è®¾è®¡ (1920x1080):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  InnoDB Cluster ç›‘æ§ä¸­å¿ƒ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é›†ç¾¤æ¦‚è§ˆ       â”‚    èŠ‚ç‚¹çŠ¶æ€     â”‚     æ€§èƒ½æŒ‡æ ‡        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚åœ¨çº¿èŠ‚ç‚¹ 3/3 â”‚ â”‚ â”‚Node1: âœ“ PRIâ”‚ â”‚ â”‚QPS: 1,234       â”‚ â”‚
â”‚ â”‚PRIMARY: 1   â”‚ â”‚ â”‚Node2: âœ“ SECâ”‚ â”‚ â”‚TPS: 456         â”‚ â”‚
â”‚ â”‚çŠ¶æ€: å¥åº·   â”‚ â”‚ â”‚Node3: âœ“ SECâ”‚ â”‚ â”‚å»¶è¿Ÿ: 5ms        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®æ—¶å‘Šè­¦       â”‚    äº‹åŠ¡ç»Ÿè®¡     â”‚     èµ„æºä½¿ç”¨        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚å½“å‰: 0ä¸ª    â”‚ â”‚ â”‚å†²çªç‡: 0.1% â”‚ â”‚ â”‚CPU: 45%         â”‚ â”‚
â”‚ â”‚ä»Šæ—¥: 2ä¸ª    â”‚ â”‚ â”‚é˜Ÿåˆ—: 12ä¸ª   â”‚ â”‚ â”‚å†…å­˜: 67%        â”‚ â”‚
â”‚ â”‚æœ¬å‘¨: 8ä¸ª    â”‚ â”‚ â”‚åå: é«˜     â”‚ â”‚ â”‚ç£ç›˜: 34%        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ€§èƒ½è¶‹åŠ¿å›¾è¡¨                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         QPS/TPS 24å°æ—¶è¶‹åŠ¿                          â”‚ â”‚
â”‚  â”‚  2000 â”¤                                           â”‚ â”‚
â”‚  â”‚  1500 â”¤     â–²                                     â”‚ â”‚
â”‚  â”‚  1000 â”¤   â–²   â–²                                   â”‚ â”‚
â”‚  â”‚   500 â”¤ â–²       â–²                                 â”‚ â”‚
â”‚  â”‚     0 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚       00:00   06:00   12:00   18:00   24:00       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ç§»åŠ¨ç«¯ç›‘æ§ç•Œé¢

**ğŸ“± ç§»åŠ¨ç›‘æ§APPè®¾è®¡**

```html
<!-- ç§»åŠ¨ç«¯ç›‘æ§é¡µé¢å¸ƒå±€ -->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySQL Clusterç›‘æ§</title>
    <style>
        .status-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-online { border-left: 4px solid #28a745; }
        .status-warning { border-left: 4px solid #ffc107; }
        .status-error { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <!-- é›†ç¾¤çŠ¶æ€å¡ç‰‡ -->
        <div class="status-card status-online">
            <h3>ğŸŸ¢ é›†ç¾¤çŠ¶æ€: å¥åº·</h3>
            <p>åœ¨çº¿èŠ‚ç‚¹: 3/3</p>
            <p>PRIMARY: node1:3306</p>
            <p>æœ€åæ£€æŸ¥: åˆšåˆš</p>
        </div>
        
        <!-- æ€§èƒ½æŒ‡æ ‡å¡ç‰‡ -->
        <div class="status-card">
            <h3>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h3>
            <p>QPS: 1,234 | TPS: 456</p>
            <p>å†²çªç‡: 0.1%</p>
            <p>å¤åˆ¶å»¶è¿Ÿ: 5ms</p>
        </div>
        
        <!-- å‘Šè­¦ä¿¡æ¯å¡ç‰‡ -->
        <div class="status-card status-warning">
            <h3>ğŸ”” æœ€æ–°å‘Šè­¦</h3>
            <p>Node2 CPUä½¿ç”¨ç‡ 85%</p>
            <p>æ—¶é—´: 2024-01-11 14:30</p>
            <button onclick="acknowledgeAlert()">ç¡®è®¤</button>
        </div>
    </div>
</body>
</html>
```

### 9.3 è‡ªå®šä¹‰ç›‘æ§æŠ¥è¡¨

**ğŸ“‹ å®šåˆ¶åŒ–æŠ¥è¡¨ç³»ç»Ÿ**

```python
# ç›‘æ§æŠ¥è¡¨ç”Ÿæˆå™¨ report_generator.py
import mysql.connector
from datetime import datetime, timedelta
import matplotlib.pyplot as plt
import pandas as pd

class ClusterReportGenerator:
    def __init__(self, config):
        self.config = config
        self.conn = mysql.connector.connect(**config['database'])
    
    def generate_daily_report(self, date):
        """ç”Ÿæˆæ—¥æŠ¥"""
        report = {
            'date': date,
            'cluster_availability': self.calc_availability(date),
            'performance_summary': self.calc_performance(date),
            'alert_summary': self.calc_alerts(date),
            'recommendations': self.generate_recommendations(date)
        }
        
        # ç”ŸæˆPDFæŠ¥å‘Š
        self.create_pdf_report(report)
        return report
    
    def calc_availability(self, date):
        """è®¡ç®—å¯ç”¨æ€§"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT 
                COUNT(CASE WHEN member_state = 'ONLINE' THEN 1 END) * 100.0 / 
                COUNT(*) as availability_rate
            FROM cluster_status_history 
            WHERE DATE(check_time) = %s
        """, (date,))
        
        result = cursor.fetchone()
        return result[0] if result else 0
    
    def calc_performance(self, date):
        """è®¡ç®—æ€§èƒ½æŒ‡æ ‡"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT 
                AVG(qps) as avg_qps,
                MAX(qps) as max_qps,
                AVG(conflict_rate) as avg_conflict_rate,
                MAX(conflict_rate) as max_conflict_rate
            FROM performance_stats 
            WHERE DATE(record_time) = %s
        """, (date,))
        
        return cursor.fetchone()
    
    def generate_recommendations(self, date):
        """ç”Ÿæˆä¼˜åŒ–å»ºè®®"""
        recommendations = []
        
        # åŸºäºæ€§èƒ½æ•°æ®ç”Ÿæˆå»ºè®®
        perf = self.calc_performance(date)
        if perf and perf[3] > 1.0:  # å†²çªç‡è¶…è¿‡1%
            recommendations.append(
                "æ£€æµ‹åˆ°è¾ƒé«˜çš„äº‹åŠ¡å†²çªç‡ï¼Œå»ºè®®ä¼˜åŒ–åº”ç”¨ç¨‹åºçš„äº‹åŠ¡è®¾è®¡"
            )
        
        availability = self.calc_availability(date)
        if availability < 99.9:
            recommendations.append(
                "é›†ç¾¤å¯ç”¨æ€§ä½äºç›®æ ‡å€¼ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œå’Œç¡¬ä»¶ç¨³å®šæ€§"
            )
        
        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
config = {
    'database': {
        'host': 'monitor-db',
        'user': 'monitor',
        'password': 'password',
        'database': 'mysql_monitor'
    }
}

generator = ClusterReportGenerator(config)
report = generator.generate_daily_report('2024-01-11')
```

**ğŸ“Š æŠ¥è¡¨æ¨¡æ¿ç¤ºä¾‹**
```html
<!-- æ—¥æŠ¥æ¨¡æ¿ daily_report_template.html -->
<html>
<head>
    <title>InnoDB Cluster æ—¥æŠ¥ - {{ date }}</title>
    <style>
        .report-header { 
            background: #007bff; 
            color: white; 
            padding: 20px; 
            text-align: center; 
        }
        .metric-box { 
            display: inline-block; 
            margin: 10px; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .good { background-color: #d4edda; }
        .warning { background-color: #fff3cd; }
        .danger { background-color: #f8d7da; }
    </style>
</head>
<body>
    <div class="report-header">
        <h1>InnoDB Cluster è¿è¡Œæ—¥æŠ¥</h1>
        <h2>{{ date }}</h2>
    </div>
    
    <div class="content">
        <h3>ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</h3>
        <div class="metric-box {{ 'good' if availability >= 99.9 else 'warning' }}">
            <h4>å¯ç”¨æ€§</h4>
            <p>{{ availability }}%</p>
        </div>
        
        <div class="metric-box {{ 'good' if avg_conflict_rate < 1.0 else 'warning' }}">
            <h4>å¹³å‡å†²çªç‡</h4>
            <p>{{ avg_conflict_rate }}%</p>
        </div>
        
        <h3>ğŸ”” å‘Šè­¦ç»Ÿè®¡</h3>
        <ul>
            {% for alert in alerts %}
            <li>{{ alert.time }} - {{ alert.message }}</li>
            {% endfor %}
        </ul>
        
        <h3>ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
        <ul>
            {% for rec in recommendations %}
            <li>{{ rec }}</li>
            {% endfor %}
        </ul>
    </div>
</body>
</html>
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç›‘æ§ä½“ç³»ï¼šPerformance Schemaæ˜¯æ ¸å¿ƒæ•°æ®æºï¼Œæä¾›è¯¦ç»†çš„é›†ç¾¤çŠ¶æ€ä¿¡æ¯
ğŸ”¸ å…³é”®è¡¨æ ¼ï¼šreplication_group_membersè®°å½•èŠ‚ç‚¹çŠ¶æ€ï¼Œmember_statsè®°å½•æ€§èƒ½æ•°æ®
ğŸ”¸ KPIä½“ç³»ï¼šå¯ç”¨æ€§ã€æ€§èƒ½ã€èµ„æºåˆ©ç”¨ç‡ä¸‰å¤§ç±»æŒ‡æ ‡å…¨é¢è¯„ä¼°é›†ç¾¤å¥åº·
ğŸ”¸ æ•°æ®é‡‡é›†ï¼šåˆ†å±‚é‡‡é›†ç­–ç•¥ï¼Œå®æ—¶ã€é«˜é¢‘ã€ä¸­é¢‘ã€ä½é¢‘ä¸åŒçº§åˆ«
ğŸ”¸ å‘Šè­¦é…ç½®ï¼šCRITICALã€WARNINGã€INFOä¸‰çº§å‘Šè­¦ï¼Œå¯¹åº”ä¸åŒå“åº”æ—¶é—´
ğŸ”¸ å·¥å…·é›†æˆï¼šPrometheusã€Grafanaã€Zabbixç­‰ä¸»æµç›‘æ§å·¥å…·çš„é›†æˆæ–¹æ¡ˆ
ğŸ”¸ å¯è§†åŒ–ï¼šå¤§å±ç›‘æ§ã€ç§»åŠ¨ç«¯ã€å®šåˆ¶æŠ¥è¡¨å¤šç§å±•ç¤ºå½¢å¼
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆInnoDB Clusteréœ€è¦ä¸“é—¨çš„ç›‘æ§**
```
å¤æ‚æ€§æŒ‘æˆ˜ï¼š
- å¤šèŠ‚ç‚¹åè°ƒæ¯”å•æœºå¤æ‚å¾—å¤š
- åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•…éšœæ¨¡å¼æ›´å¤šæ ·
- æ•°æ®ä¸€è‡´æ€§è¦æ±‚æ›´ä¸¥æ ¼

ç›‘æ§ä»·å€¼ï¼š
- åŠæ—¶å‘ç°æ½œåœ¨é—®é¢˜ï¼Œé¢„é˜²æ•…éšœå‘ç”Ÿ
- å¿«é€Ÿå®šä½é—®é¢˜æ ¹å› ï¼Œç¼©çŸ­æ•…éšœæ—¶é—´
- ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆï¼Œæå‡æ•´ä½“æ•ˆç‡
- ä¸ºå®¹é‡è§„åˆ’æä¾›æ•°æ®æ”¯æ’‘
```

**ğŸ”¹ Performance Schemaçš„æ ¸å¿ƒä»·å€¼**
```
æ•°æ®æƒå¨æ€§ï¼š
- MySQLå®˜æ–¹æä¾›çš„å†…éƒ¨çŠ¶æ€æ¥å£
- æ•°æ®å®æ—¶æ€§å’Œå‡†ç¡®æ€§æœ‰ä¿éšœ
- æ¶µç›–é›†ç¾¤è¿è¡Œçš„æ–¹æ–¹é¢é¢

ä½¿ç”¨ä¾¿åˆ©æ€§ï¼š
- æ ‡å‡†SQLæŸ¥è¯¢ï¼Œå­¦ä¹ æˆæœ¬ä½
- ä¸°å¯Œçš„è¡¨æ ¼å’Œå­—æ®µï¼Œä¿¡æ¯å…¨é¢
- æ”¯æŒå†å²æ•°æ®è®°å½•å’Œåˆ†æ
```

**ğŸ”¹ ç›‘æ§å·¥å…·é€‰æ‹©ç­–ç•¥**
```
å·¥å…·ç‰¹ç‚¹å¯¹æ¯”ï¼š
- Prometheus: æ—¶åºæ•°æ®å­˜å‚¨ä¼˜ç§€ï¼Œå‘Šè­¦åŠŸèƒ½å¼ºå¤§
- Grafana: å¯è§†åŒ–æ•ˆæœå¥½ï¼Œä»ªè¡¨æ¿é…ç½®çµæ´»
- Zabbix: ä¼ä¸šçº§ç›‘æ§ï¼Œè¿ç»´æµç¨‹å®Œå–„

é€‰æ‹©åŸåˆ™ï¼š
- å°å›¢é˜Ÿï¼šé€‰æ‹©è½»é‡çº§æ–¹æ¡ˆ (Prometheus + Grafana)
- å¤§ä¼ä¸šï¼šé€‰æ‹©ä¼ä¸šçº§æ–¹æ¡ˆ (Zabbix + è‡ªç ”)
- äº‘ç¯å¢ƒï¼šé€‰æ‹©äº‘åŸç”Ÿæ–¹æ¡ˆ (Cloud Monitoring)
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **é‡‘èäº¤æ˜“ç³»ç»Ÿ**ï¼šå®æ—¶ç›‘æ§äº¤æ˜“å¤„ç†ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨
- **ç”µå•†å¹³å°**ï¼šç›‘æ§è®¢å•å¤„ç†æ€§èƒ½ï¼Œä¿éšœç”¨æˆ·ä½“éªŒ
- **æ¸¸æˆå¹³å°**ï¼šç›‘æ§ç©å®¶æ•°æ®åŒæ­¥ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
- **ç‰©è”ç½‘å¹³å°**ï¼šç›‘æ§è®¾å¤‡æ•°æ®é‡‡é›†ï¼Œç¡®ä¿æœåŠ¡ç¨³å®š

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **ç›‘æ§å…¨é¢æ€§**ï¼šè¦†ç›–åŸºç¡€è®¾æ–½ã€æ•°æ®åº“ã€åº”ç”¨ä¸‰ä¸ªå±‚é¢
- **å‘Šè­¦ç²¾å‡†æ€§**ï¼šå‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥ï¼Œæé«˜å“åº”æ•ˆç‡
- **è‡ªåŠ¨åŒ–ç¨‹åº¦**ï¼šå°½å¯èƒ½å®ç°è‡ªåŠ¨åŒ–ç›‘æ§å’Œå¤„ç†
- **å›¢é˜Ÿåä½œ**ï¼šå»ºç«‹æ¸…æ™°çš„ç›‘æ§èŒè´£åˆ†å·¥å’Œæµç¨‹

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **æ™ºèƒ½åŒ–ç›‘æ§**ï¼šAIè¾…åŠ©çš„å¼‚å¸¸æ£€æµ‹å’Œæ ¹å› åˆ†æ
- **äº‘åŸç”Ÿç›‘æ§**ï¼šæ›´å¥½åœ°æ”¯æŒå®¹å™¨åŒ–å’Œå¾®æœåŠ¡
- **å¯è§‚æµ‹æ€§**ï¼šä»ç›‘æ§å‘å…¨é¢å¯è§‚æµ‹æ€§æ¼”è¿›
- **è‡ªæ„ˆèƒ½åŠ›**ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤èƒ½åŠ›

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Performance Schemaæ˜¯æ•°æ®æºï¼Œè¡¨æ ¼å­—æ®µè¦ç†Ÿç»ƒ
- åˆ†å±‚é‡‡é›†å®šç­–ç•¥ï¼Œå‘Šè­¦è§„åˆ™è¦ç²¾å‡†
- å·¥å…·é›†æˆé€‰åˆé€‚ï¼Œå¯è§†åŒ–ç•Œé¢è¦ç¾è§‚
- ç›‘æ§å…¨é¢é˜²æ•…éšœï¼Œè¿ç»´æ•ˆç‡å¤§æå‡