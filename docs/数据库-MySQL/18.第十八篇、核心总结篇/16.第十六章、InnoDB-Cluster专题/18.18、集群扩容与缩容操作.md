---
title: 18、集群扩容与缩容操作
---
## 📚 目录

1. [集群扩容与缩容概述](#1-集群扩容与缩容概述)
2. [扩容操作详解](#2-扩容操作详解)
3. [缩容操作详解](#3-缩容操作详解)
4. [容量规划策略](#4-容量规划策略)
5. [监控与故障处理](#5-监控与故障处理)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 集群扩容与缩容概述


### 1.1 什么是集群扩缩容


**扩容（Scale Out）**：向现有集群中添加新的MySQL实例节点
**缩容（Scale In）**：从集群中移除不需要的MySQL实例节点

💡 **通俗理解**：
```
扩容就像：餐厅生意好了，增加服务员和厨师
缩容就像：淡季时减少员工数量，降低成本

集群扩容：业务增长 → 性能不够 → 加机器
集群缩容：业务下降 → 资源浪费 → 减机器
```

### 1.2 为什么需要扩缩容


**扩容场景**：
- 📈 **业务增长**：用户量激增，现有节点处理不过来
- 🏃‍♂️ **性能瓶颈**：查询变慢，需要分散负载
- 🛡️ **高可用需求**：增加备用节点，提升容灾能力
- 🌍 **地域扩展**：业务扩展到新地区，需要就近部署

**缩容场景**：
- 📉 **业务下降**：用户减少，节点资源利用率低
- 💰 **成本优化**：减少服务器开支
- 🔧 **硬件淘汰**：老旧设备需要下线
- 🏗️ **架构调整**：重新规划集群结构

### 1.3 扩缩容基本原理


```
InnoDB Cluster架构：

原始集群（3节点）：          扩容后（4节点）：
┌─────────┐                ┌─────────┐
│ Node-1  │◄──────────────►│ Node-1  │◄────┐
│(Primary)│                │(Primary)│     │
└─────────┘                └─────────┘     │
     ▲                          ▲          │
     │                          │          │
     ▼                          ▼          ▼
┌─────────┐                ┌─────────┐ ┌─────────┐
│ Node-2  │◄──────────────►│ Node-2  │◄│ Node-4  │
│(Secondary)               │(Secondary) │ (新节点) │
└─────────┘                └─────────┘ └─────────┘
     ▲                          ▲          ▲
     │                          │          │
     ▼                          ▼          │
┌─────────┐                ┌─────────┐     │
│ Node-3  │◄──────────────►│ Node-3  │◄────┘
│(Secondary)               │(Secondary)
└─────────┘                └─────────┘

扩容过程：新节点加入 → 数据同步 → 投票权获得
```

---

## 2. ⬆️ 扩容操作详解


### 2.1 扩容前准备工作


**🔍 环境检查清单**

| 检查项目 | 具体要求 | 检查命令 |
|---------|---------|----------|
| **硬件资源** | CPU、内存、磁盘满足要求 | `htop`, `df -h` |
| **网络连通性** | 各节点间网络正常 | `ping`, `telnet` |
| **MySQL版本** | 版本一致性 | `SELECT VERSION()` |
| **防火墙配置** | 端口开放 | `netstat -tlnp` |
| **时间同步** | 时间差小于30秒 | `date`, `ntpstat` |

**📋 准备步骤详解**

```bash
# 1️⃣ 在新节点安装MySQL
sudo apt update
sudo apt install mysql-server mysql-shell

# 2️⃣ 配置MySQL基本参数
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
```

```ini
# MySQL配置示例
[mysqld]
server-id = 4                    # 新节点唯一ID
bind-address = 0.0.0.0          # 允许远程连接
port = 3306
datadir = /var/lib/mysql

# InnoDB Cluster必需配置
gtid_mode = ON                   # 开启GTID
enforce_gtid_consistency = ON    # 强制GTID一致性
binlog_checksum = NONE          # 关闭binlog校验
log_slave_updates = ON          # 记录从库更新
binlog_format = ROW             # 行级复制
master_info_repository = TABLE   # 主库信息存储在表中
relay_log_info_repository = TABLE # 中继日志信息存储在表中
```

**⚠️ 重要注意事项**

> **配置一致性**：新节点的MySQL配置必须与现有节点保持一致，特别是GTID相关配置
> **数据目录权限**：确保mysql用户对数据目录有完整读写权限
> **内存分配**：根据服务器配置合理设置innodb_buffer_pool_size

### 2.2 使用cluster.addInstance()扩容


**🚀 扩容操作步骤**

```javascript
// 1️⃣ 连接到集群
mysqlsh> \connect root@node1:3306
mysqlsh> var cluster = dba.getCluster()

// 2️⃣ 检查集群状态
mysqlsh> cluster.status()
```

```json
{
    "clusterName": "myCluster", 
    "defaultReplicaSet": {
        "name": "default", 
        "primary": "node1:3306", 
        "ssl": "REQUIRED", 
        "status": "OK", 
        "statusText": "Cluster is ONLINE and can tolerate up to ONE failure.", 
        "topology": {
            "node1:3306": {
                "address": "node1:3306", 
                "mode": "R/W", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }, 
            "node2:3306": {
                "address": "node2:3306", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }, 
            "node3:3306": {
                "address": "node3:3306", 
                "mode": "R/O", 
                "readReplicas": {}, 
                "role": "HA", 
                "status": "ONLINE"
            }
        }
    }
}
```

```javascript
// 3️⃣ 添加新实例
mysqlsh> cluster.addInstance('root@node4:3306')
```

**💬 扩容过程详解**

```
扩容交互过程：

Please provide the password for 'root@node4:3306': ********

The instance 'node4:3306' is valid for Cluster usage.

Validating instance at node4:3306...
✓ Instance configuration is suitable.
✓ Instance has no incompatible tables.

Clone plugin is available and will be used during the recovery process.

State recovery will use Clone for distributing the data to the new instance.

NOTE: User 'mysql_innodb_cluster_r0' already exists at instance 'node4:3306'. 
It will be deleted and recreated with a new password.

Creating user mysql_innodb_cluster_r0@%.
Account mysql_innodb_cluster_r0@% was successfully created.

Adding instance to the cluster...

Monitoring recovery process of the new cluster member. Press ^C to stop monitoring and let it continue in background.
Clone based state recovery is now in progress.

NOTE: A server restart is expected to happen as part of the clone process. 
If the server does not support the RESTART command or does not come back after a while, 
you may need to manually start it back.

Waiting for clone to finish...
NOTE: node4:3306 is being cloned from node1:3306
** Stage DROP DATA: Starting
** Stage DROP DATA: Completed
** Stage FILE COPY: Starting
** Stage FILE COPY: Completed  
** Stage PAGE COPY: Starting
** Stage PAGE COPY: Completed
** Stage REDO COPY: Starting
** Stage REDO COPY: Completed
** Stage FILE SYNC: Starting
** Stage FILE SYNC: Completed
** Stage RESTART: Starting
** Stage RESTART: Completed

The instance 'node4:3306' was successfully added to the cluster.
```

### 2.3 数据重新分布


**📊 数据同步原理**

```
数据同步过程：

Primary节点 (node1)          新节点 (node4)
┌─────────────────┐         ┌─────────────────┐
│     完整数据     │   Clone  │                 │
│   ├── Table1    │ ────────►│   ├── Table1    │
│   ├── Table2    │         │   ├── Table2    │
│   └── Table3    │         │   └── Table3    │
└─────────────────┘         └─────────────────┘
         │                           │
         │ 实时更新                   │ 同步应用
         ▼                           ▼
┌─────────────────┐         ┌─────────────────┐
│    Binlog      │  复制    │   Relay Log    │
│  ├── Event1    │ ────────►│  ├── Event1    │
│  ├── Event2    │         │  ├── Event2    │
│  └── Event3    │         │  └── Event3    │
└─────────────────┘         └─────────────────┘

1️⃣ Clone阶段：完整数据复制
2️⃣ 追赶阶段：应用增量更新
3️⃣ 同步阶段：实时数据同步
```

**🔍 监控同步进度**

```sql
-- 查看Clone进度
SELECT STAGE, STATE, 
       ROUND(ESTIMATE/1024/1024, 2) AS 'Estimate(MB)',
       ROUND(DATA/1024/1024, 2) AS 'Data(MB)',
       ROUND(100*DATA/ESTIMATE, 2) AS 'Progress(%)'
FROM performance_schema.clone_progress;

-- 查看复制延迟
SHOW SLAVE STATUS\G
-- 关注：Seconds_Behind_Master 应该为0或很小的值
```

### 2.4 扩容影响评估


**⚡ 性能影响分析**

| 影响阶段 | 性能影响 | 持续时间 | 缓解措施 |
|---------|---------|---------|----------|
| **数据复制** | 主库I/O增加20-30% | 根据数据量决定 | 选择业务低峰期 |
| **网络传输** | 带宽占用增加 | 复制期间 | 限制复制速度 |
| **追赶同步** | 轻微影响 | 几分钟到几小时 | 监控复制延迟 |
| **正常运行** | 性能提升 | 扩容完成后 | 配置读写分离 |

**📈 扩容收益预期**

```
读性能提升计算：
原有3节点 → 扩容到4节点

理论读能力提升：+33%
实际提升（考虑负载均衡）：+25-30%

写性能：无明显变化（仍然单点写入）
容灾能力：从容忍1个节点故障 → 容忍2个节点故障
```

---

## 3. ⬇️ 缩容操作详解


### 3.1 缩容前数据安全检查


**🛡️ 安全检查清单**

```bash
# 1️⃣ 确认要移除的节点不是Primary
mysqlsh> cluster.status()
# 确保要移除的节点role不是"HA"且mode不是"R/W"

# 2️⃣ 检查集群健康状态
mysqlsh> cluster.status()
# 确保所有节点状态都是"ONLINE"

# 3️⃣ 验证数据同步状态
mysql> SHOW SLAVE STATUS\G
# 确保Seconds_Behind_Master为0
```

**⚠️ 缩容风险评估**

💡 **重要提醒**：
- **不能移除Primary节点**：必须先进行主节点切换
- **保持奇数节点**：避免脑裂问题
- **数据完整性**：确保数据已完全同步
- **容灾能力**：评估移除节点后的故障容忍度

```
容灾能力对比：

5节点集群：
┌───┬───┬───┬───┬───┐
│ 1 │ 2 │ 3 │ 4 │ 5 │  ← 可容忍2个节点故障
└───┴───┴───┴───┴───┘

缩容到3节点：
┌───┬───┬───┐
│ 1 │ 2 │ 3 │  ← 只能容忍1个节点故障
└───┴───┴───┘

风险：容灾能力下降！
```

### 3.2 使用cluster.removeInstance()缩容


**🔧 缩容操作步骤**

```javascript
// 1️⃣ 如果要移除Primary节点，先切换主节点
mysqlsh> cluster.setPrimaryInstance('root@node2:3306')

// 2️⃣ 移除指定实例
mysqlsh> cluster.removeInstance('root@node4:3306')
```

**💬 缩容过程详解**

```
缩容交互过程：

The instance will be removed from the InnoDB cluster. Depending on the instance
being the Seed or not, the Metadata session might become invalid. If so, please
start a new session to the Metadata Storage R/W instance.

Are you sure you want to continue? [y/N]: y

The instance 'node4:3306' was successfully removed from the cluster.

WARNING: The instance 'node4:3306' is still part of the MySQL Server but 
is no longer managed by InnoDB cluster. Please ensure that:

- The instance is shutdown or started with --skip-slave-start to avoid 
  attempts to replicate from the former cluster
- Reset the instance if you want to use it in another cluster

You can use the following MySQL Shell command to clean up the instance:
dba.rebootClusterFromCompleteOutage()
```

**🧹 清理移除的节点**

```javascript
// 在被移除的节点上执行清理操作
mysqlsh> \connect root@node4:3306
mysqlsh> dba.dropMetadataSchema()

// 或者重置实例
mysqlsh> dba.configureInstance('root@node4:3306', {clearReadOnly: true})
```

```sql
-- 手动清理复制配置
STOP SLAVE;
RESET SLAVE ALL;
RESET MASTER;

-- 清理相关用户
DROP USER 'mysql_innodb_cluster_r0'@'%';
DROP USER 'mysql_innodb_cluster_1'@'%';
```

### 3.3 缩容后集群重新平衡


**⚖️ 负载重新分布**

```
缩容前负载分布（4节点）：
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│ Node-1  │ │ Node-2  │ │ Node-3  │ │ Node-4  │
│  25%    │ │  25%    │ │  25%    │ │  25%    │
└─────────┘ └─────────┘ └─────────┘ └─────────┘

缩容后负载分布（3节点）：
┌─────────┐ ┌─────────┐ ┌─────────┐
│ Node-1  │ │ Node-2  │ │ Node-3  │
│  33.3%  │ │  33.3%  │ │  33.3%  │  ← 负载自动重新分配
└─────────┘ └─────────┘ └─────────┘
```

**🔄 应用层配置调整**

```yaml
# 更新应用配置中的数据库连接
database:
  cluster_nodes:
    - host: node1
      port: 3306
    - host: node2  
      port: 3306
    - host: node3
      port: 3306
    # 移除 node4 配置

# MySQL Router配置更新
routing:
  read_write_split:
    destinations: node1:3306,node2:3306,node3:3306
```

---

## 4. 📊 容量规划策略


### 4.1 容量评估方法


**📈 业务指标监控**

| 监控指标 | 正常范围 | 扩容阈值 | 缩容阈值 |
|---------|---------|---------|---------|
| **CPU使用率** | 20-60% | >80%持续1小时 | <20%持续1周 |
| **内存使用率** | 40-70% | >85%持续30分钟 | <30%持续1周 |
| **磁盘I/O** | <80% | >90%持续1小时 | <40%持续1周 |
| **连接数** | <70%最大值 | >85%最大值 | <30%最大值 |
| **查询响应时间** | <100ms | >500ms | 稳定在<50ms |

**📊 容量计算公式**

```
节点数量规划公式：

所需节点数 = ⌈(预期负载 × 安全系数) / 单节点容量⌉

示例计算：
- 预期QPS：10,000
- 单节点处理能力：4,000 QPS  
- 安全系数：1.5（考虑峰值和故障）
- 所需节点数：⌈(10,000 × 1.5) / 4,000⌉ = 4节点

容灾考虑：
- 至少3个节点（基本高可用）
- 推荐5个节点（容忍2个故障）
- 奇数个节点（避免脑裂）
```

### 4.2 自动扩缩容策略


**🤖 自动化扩容触发条件**

```bash
#!/bin/bash
# 自动扩容脚本示例

# 监控指标采集
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
CONNECTION_USAGE=$(mysql -e "SHOW STATUS LIKE 'Threads_connected'" | awk 'NR==2{print $2}')

# 扩容条件判断
if [[ $CPU_USAGE > 80 && $MEMORY_USAGE > 85 ]]; then
    echo "触发自动扩容条件"
    # 调用扩容API或脚本
    /scripts/auto_scale_out.sh
fi

# 缩容条件判断  
if [[ $CPU_USAGE < 20 && $MEMORY_USAGE < 30 ]]; then
    echo "触发自动缩容条件"
    # 调用缩容API或脚本
    /scripts/auto_scale_in.sh
fi
```

**⏰ 扩缩容时间窗口**

💡 **最佳实践时间安排**：

```
扩容时间窗口：
🌙 深夜时段（0:00-6:00）  ← 推荐
📉 业务低峰期（工作日14:00-16:00）
🔄 维护窗口（周末凌晨）

避免时间：
🚫 业务高峰期（9:00-12:00, 19:00-22:00）
🚫 促销活动期间
🚫 月初月末结算期
```

### 4.3 成本优化考虑


**💰 成本效益分析**

```
扩容成本分析：

硬件成本：
├── 服务器采购：¥50,000/台
├── 网络设备：¥5,000/台  
├── 机柜空间：¥2,000/月/台
└── 电力消耗：¥1,000/月/台

人力成本：
├── 部署时间：8小时 × ¥500/小时 = ¥4,000
├── 测试验证：4小时 × ¥500/小时 = ¥2,000
└── 监控配置：2小时 × ¥500/小时 = ¥1,000

机会成本：
└── 延迟扩容导致的业务损失评估

总成本评估：¥65,000（一次性）+ ¥3,000/月（运维）
```

**📉 云服务vs自建对比**

| 方案类型 | 扩容时间 | 初始成本 | 运维成本 | 灵活性 |
|---------|---------|---------|---------|--------|
| **云数据库** | 5-10分钟 | 低 | 低 | 高 |
| **云主机自建** | 30-60分钟 | 中 | 中 | 中 |
| **物理机自建** | 1-7天 | 高 | 高 | 低 |

---

## 5. 📊 监控与故障处理


### 5.1 扩缩容监控指标


**🔍 关键监控项目**

```sql
-- 集群状态监控
SELECT * FROM performance_schema.replication_group_members;

-- 数据同步延迟监控  
SELECT CHANNEL_NAME, SERVICE_STATE, 
       COUNT_TRANSACTIONS_IN_QUEUE,
       LAST_HEARTBEAT_TIMESTAMP
FROM performance_schema.replication_connection_status;

-- 性能指标监控
SELECT EVENT_NAME, COUNT_STAR, SUM_TIMER_WAIT
FROM performance_schema.events_waits_summary_global_by_event_name 
WHERE EVENT_NAME LIKE 'wait/synch/mutex/group_rpl%';
```

**📈 监控告警配置**

```yaml
# Prometheus监控配置示例
groups:
  - name: mysql_cluster_scaling
    rules:
      - alert: ClusterNodeDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL集群节点下线"
          
      - alert: ReplicationLag
        expr: mysql_slave_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "复制延迟过高"
          
      - alert: HighCPUUsage
        expr: cpu_usage_percent > 80
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高，考虑扩容"
```

### 5.2 常见故障及处理


**❌ 扩容失败处理**

```
故障现象：addInstance()操作失败

常见原因及解决方案：

1️⃣ 网络连接问题
检查：ping node4
解决：配置防火墙，检查网络连接

2️⃣ MySQL配置不兼容  
检查：GTID、binlog格式配置
解决：统一配置参数，重启MySQL

3️⃣ 版本不匹配
检查：SELECT VERSION()
解决：升级或降级到相同版本

4️⃣ 磁盘空间不足
检查：df -h
解决：清理磁盘空间或扩容磁盘

5️⃣ 权限问题
检查：用户权限和文件权限
解决：GRANT ALL PRIVILEGES，chmod 755
```

**🔄 扩容回滚步骤**

```javascript
// 如果扩容过程中出现问题，回滚步骤：

// 1️⃣ 从集群中移除有问题的节点
mysqlsh> cluster.removeInstance('root@node4:3306', {force: true})

// 2️⃣ 清理节点配置
mysqlsh> \connect root@node4:3306  
mysqlsh> dba.dropMetadataSchema()

// 3️⃣ 重置MySQL配置
mysql> STOP SLAVE;
mysql> RESET SLAVE ALL;
mysql> RESET MASTER;

// 4️⃣ 验证集群状态
mysqlsh> cluster.status()
```

**⚠️ 缩容风险处理**

```
缩容失败场景：

场景1：移除Primary节点失败
解决：
1. 先执行setPrimaryInstance()切换主节点
2. 等待切换完成后再移除原主节点

场景2：数据不同步
解决：
1. 暂停缩容操作
2. 检查并修复数据同步问题
3. 确认数据一致后再继续

场景3：集群状态异常
解决：
1. 使用cluster.rescan()重新扫描
2. 必要时使用dba.rebootClusterFromCompleteOutage()
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 扩容本质：向集群添加新节点，提升处理能力和容灾能力
🔸 缩容本质：从集群移除节点，优化资源使用和成本
🔸 核心命令：cluster.addInstance() 和 cluster.removeInstance()
🔸 数据同步：通过Clone + Binlog复制实现数据一致性
🔸 监控重要性：实时监控集群状态和性能指标
```

### 6.2 关键操作要点


**🔹 扩容操作要点**：
```
准备工作要充分：
- 硬件资源检查
- 网络连通性验证  
- MySQL配置统一
- 选择合适时间窗口

扩容过程要监控：
- 数据复制进度
- 系统性能影响
- 网络带宽使用
- 复制延迟情况
```

**🔹 缩容操作要点**：
```
安全检查要仔细：
- 确认不是Primary节点
- 验证数据同步完整
- 评估容灾能力影响
- 考虑业务负载变化

清理工作要彻底：
- 停止复制进程
- 清理集群元数据
- 删除复制用户
- 更新应用配置
```

### 6.3 最佳实践建议


**📝 容量规划原则**：
- **预留容量**：保持30-40%的性能余量
- **奇数节点**：避免脑裂问题
- **分批扩容**：大规模扩容分批进行
- **成本控制**：根据业务需求合理配置

**🛡️ 风险控制措施**：
- **备份数据**：扩缩容前完整备份
- **测试验证**：在测试环境先验证
- **监控告警**：设置完善的监控体系
- **回滚准备**：准备应急回滚方案

**⚡ 性能优化技巧**：
- **读写分离**：合理利用多个节点
- **负载均衡**：使用MySQL Router分发请求
- **索引优化**：扩容后重新评估索引策略
- **参数调优**：根据新的集群规模调整参数

**核心记忆**：
- 扩容提能力，缩容省成本
- 准备要充分，监控要及时
- 安全第一位，数据不能丢
- 奇数个节点，避免脑裂险