---
title: 34ã€InnoDB Clusteréƒ¨ç½²å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„åˆ’](#1-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„åˆ’)
2. [éƒ¨ç½²æ­¥éª¤è¯¦è§£](#2-éƒ¨ç½²æ­¥éª¤è¯¦è§£)
3. [é…ç½®æ¨¡æ¿ç®¡ç†](#3-é…ç½®æ¨¡æ¿ç®¡ç†)
4. [éƒ¨ç½²éªŒè¯æ¸…å•](#4-éƒ¨ç½²éªŒè¯æ¸…å•)
5. [ä¸Šçº¿å‰æµ‹è¯•](#5-ä¸Šçº¿å‰æµ‹è¯•)
6. [åˆ‡æ¢ç­–ç•¥åˆ¶å®š](#6-åˆ‡æ¢ç­–ç•¥åˆ¶å®š)
7. [å›æ»šæ–¹æ¡ˆå‡†å¤‡](#7-å›æ»šæ–¹æ¡ˆå‡†å¤‡)
8. [ç”Ÿäº§ç¯å¢ƒç›‘æ§](#8-ç”Ÿäº§ç¯å¢ƒç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„åˆ’


### 1.1 ä»€ä¹ˆæ˜¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„åˆ’


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ è¦åœ¨å…¬å¸æ­å»ºä¸€å¥—é‡è¦çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œå°±åƒåœ¨ç¹å¿™çš„å•†ä¸šåŒºå»ºä¸€å®¶é“¶è¡Œã€‚ä½ ä¸èƒ½éšä¾¿æ‰¾ä¸ªåœ°æ–¹å°±å¼€å§‹å»ºï¼Œè€Œæ˜¯è¦**ç²¾å¿ƒè§„åˆ’**æ¯ä¸€ä¸ªç»†èŠ‚ã€‚

ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è§„åˆ’å°±æ˜¯**ä¸ºMySQL InnoDB Clusteråœ¨çœŸå®ä¸šåŠ¡ç¯å¢ƒä¸­ä¸Šçº¿åšçš„å…¨é¢å‡†å¤‡å·¥ä½œ**ã€‚

### 1.2 ç¡¬ä»¶èµ„æºè§„åˆ’


**ğŸ”§ æœåŠ¡å™¨é…ç½®è§„åˆ’**

```
å…¸å‹3èŠ‚ç‚¹é›†ç¾¤ç¡¬ä»¶é…ç½®ï¼š

ä¸»èŠ‚ç‚¹ï¼ˆPrimaryï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CPU: 16æ ¸å¿ƒ         â”‚ â† å¤„ç†è¯»å†™è¯·æ±‚
â”‚ å†…å­˜: 64GB          â”‚ â† InnoDBç¼“å†²æ± 
â”‚ å­˜å‚¨: 2TB SSD       â”‚ â† æ•°æ®å­˜å‚¨
â”‚ ç½‘ç»œ: ä¸‡å…†ç½‘å¡      â”‚ â† é«˜é€ŸåŒæ­¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä»èŠ‚ç‚¹ï¼ˆSecondaryï¼‰x2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CPU: 12æ ¸å¿ƒ         â”‚ â† å¤„ç†åªè¯»è¯·æ±‚
â”‚ å†…å­˜: 32GB          â”‚ â† ç¼“å­˜çƒ­ç‚¹æ•°æ®
â”‚ å­˜å‚¨: 1TB SSD       â”‚ â† æ•°æ®å‰¯æœ¬
â”‚ ç½‘ç»œ: ä¸‡å…†ç½‘å¡      â”‚ â† æ¥æ”¶åŒæ­¥æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é…ç½®é€‰æ‹©åŸåˆ™**ï¼š
- **CPU**: æ ¹æ®å¹¶å‘è¿æ¥æ•°é€‰æ‹©ï¼Œæ¯100å¹¶å‘éœ€è¦2-4æ ¸å¿ƒ
- **å†…å­˜**: æ•°æ®é›†å¤§å°çš„25-50%ä½œä¸ºç¼“å†²æ± 
- **å­˜å‚¨**: SSDå¿…é€‰ï¼ŒIOPSè¦æ±‚>10000
- **ç½‘ç»œ**: ä¸‡å…†ç½‘ç»œç¡®ä¿æ•°æ®åŒæ­¥ä¸æˆä¸ºç“¶é¢ˆ

### 1.3 ç½‘ç»œæ¶æ„è§„åˆ’


**ğŸŒ ç½‘ç»œæ‹“æ‰‘è®¾è®¡**

```
ç”Ÿäº§ç½‘ç»œæ‹“æ‰‘:

å¤–ç½‘ç”¨æˆ·
    â†“
[ è´Ÿè½½å‡è¡¡å™¨ ]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åº”ç”¨æœåŠ¡å™¨é›†ç¾¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (å†…ç½‘è®¿é—®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      MySQL Router é›†ç¾¤          â”‚
â”‚ Router1   Router2   Router3     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (é›†ç¾¤å†…ç½‘)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      InnoDB Cluster             â”‚
â”‚ Node1     Node2     Node3       â”‚
â”‚(Primary) (Secondary)(Secondary) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”’ ç½‘ç»œå®‰å…¨é…ç½®**ï¼š
```bash
# é˜²ç«å¢™è§„åˆ™ç¤ºä¾‹
# MySQLæœåŠ¡ç«¯å£
iptables -A INPUT -p tcp --dport 3306 -s å†…ç½‘æ®µ -j ACCEPT

# MySQL X Protocolç«¯å£ 
iptables -A INPUT -p tcp --dport 33060 -s å†…ç½‘æ®µ -j ACCEPT

# MySQL Routerç«¯å£
iptables -A INPUT -p tcp --dport 6446 -s åº”ç”¨æœåŠ¡å™¨æ®µ -j ACCEPT
iptables -A INPUT -p tcp --dport 6447 -s åº”ç”¨æœåŠ¡å™¨æ®µ -j ACCEPT
```

### 1.4 å®¹é‡è§„åˆ’ä¸æ‰©å±•ç­–ç•¥


**ğŸ“Š å®¹é‡è¯„ä¼°æ¨¡å‹**

| ä¸šåŠ¡æŒ‡æ ‡ | å½“å‰å€¼ | 1å¹´é¢„æœŸ | 3å¹´é¢„æœŸ | é…ç½®å»ºè®® |
|---------|--------|---------|---------|----------|
| **æ•°æ®é‡** | 500GB | 2TB | 8TB | é¢„ç•™3å€ç©ºé—´ |
| **QPS** | 5000 | 15000 | 50000 | æŒ‰å³°å€¼2å€é…ç½® |
| **å¹¶å‘è¿æ¥** | 200 | 600 | 2000 | è¿æ¥æ± ä¼˜åŒ– |
| **ç½‘ç»œå¸¦å®½** | 100Mbps | 500Mbps | 2Gbps | ä¸‡å…†ç½‘ç»œ |

**ğŸš€ æ‰©å±•è·¯å¾„è§„åˆ’**ï¼š
```
é˜¶æ®µ1: 3èŠ‚ç‚¹åŸºç¡€é›†ç¾¤
  â†“ (ä¸šåŠ¡å¢é•¿)
é˜¶æ®µ2: å¢åŠ åªè¯»èŠ‚ç‚¹ â†’ 5èŠ‚ç‚¹
  â†“ (è¯»å†™åˆ†ç¦»ä¼˜åŒ–)  
é˜¶æ®µ3: åˆ†ç‰‡é›†ç¾¤ â†’ å¤šä¸ª3èŠ‚ç‚¹cluster
  â†“ (å…¨çƒåŒ–éƒ¨ç½²)
é˜¶æ®µ4: è·¨åœ°åŸŸéƒ¨ç½² â†’ å¼‚åœ°ç¾å¤‡
```

---

## 2. ğŸ“ éƒ¨ç½²æ­¥éª¤è¯¦è§£


### 2.1 é¢„éƒ¨ç½²ç¯å¢ƒå‡†å¤‡


**ğŸ”§ ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–**

```bash
# 1. æ“ä½œç³»ç»Ÿä¼˜åŒ–
echo "vm.swappiness = 1" >> /etc/sysctl.conf
echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
sysctl -p

# 2. æ—¶é—´åŒæ­¥é…ç½®
yum install -y chrony
systemctl enable chronyd
systemctl start chronyd

# 3. ç”¨æˆ·å’Œç›®å½•åˆ›å»º
useradd -r -s /sbin/nologin mysql
mkdir -p /data/mysql/{data,logs,tmp}
chown -R mysql:mysql /data/mysql
```

**ğŸ“¦ MySQLè½¯ä»¶å®‰è£…**ï¼š
```bash
# ä¸‹è½½MySQL 8.0ç‰ˆæœ¬
wget https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm
yum install -y mysql80-community-release-el8-1.noarch.rpm

# å®‰è£…MySQLæœåŠ¡å™¨å’ŒShell
yum install -y mysql-community-server mysql-shell

# å¯åŠ¨MySQLæœåŠ¡
systemctl enable mysqld
systemctl start mysqld
```

### 2.2 é›†ç¾¤èŠ‚ç‚¹é…ç½®


**âš™ï¸ ä¸»èŠ‚ç‚¹åˆå§‹åŒ–**

```sql
-- 1. è·å–ä¸´æ—¶å¯†ç 
grep 'temporary password' /var/log/mysqld.log

-- 2. ç™»å½•å¹¶ä¿®æ”¹å¯†ç 
mysql -u root -p
ALTER USER 'root'@'localhost' IDENTIFIED BY 'StrongPassword123!';

-- 3. åˆ›å»ºé›†ç¾¤ç®¡ç†ç”¨æˆ·
CREATE USER 'clusteradmin'@'%' IDENTIFIED BY 'ClusterPass123!';
GRANT ALL PRIVILEGES ON *.* TO 'clusteradmin'@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

**ğŸ”§ é›†ç¾¤é…ç½®æ–‡ä»¶**ï¼š
```ini
# /etc/my.cnf - ç”Ÿäº§ç¯å¢ƒé…ç½®
[mysqld]
# åŸºæœ¬é…ç½®
server_id = 1
bind_address = 0.0.0.0
port = 3306

# InnoDBé…ç½®
innodb_buffer_pool_size = 32G        # å†…å­˜çš„50-70%
innodb_log_file_size = 2G            # ç¼“å†²æ± çš„6-25%
innodb_flush_log_at_trx_commit = 1   # æ•°æ®å®‰å…¨æ€§æœ€é«˜
innodb_doublewrite = ON              # é˜²æ­¢é¡µæŸå

# å¤åˆ¶é…ç½®
log_bin = mysql-bin
binlog_format = ROW
sync_binlog = 1                      # æ¯æ¬¡æäº¤åŒæ­¥åˆ°ç£ç›˜
gtid_mode = ON                       # å¯ç”¨GTID
enforce_gtid_consistency = ON

# Group Replicationé…ç½®
plugin_load_add = 'group_replication.so'
group_replication_group_name = "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
group_replication_start_on_boot = OFF
group_replication_local_address = "192.168.1.10:33061"
group_replication_group_seeds = "192.168.1.10:33061,192.168.1.11:33061,192.168.1.12:33061"

# æ€§èƒ½è°ƒä¼˜
max_connections = 1000
thread_cache_size = 100
table_open_cache = 4000
query_cache_type = 0                 # 8.0ç‰ˆæœ¬å»ºè®®å…³é—­
```

### 2.3 é›†ç¾¤åˆ›å»ºè¿‡ç¨‹


**ğŸš€ ä½¿ç”¨MySQL Shellåˆ›å»ºé›†ç¾¤**

```javascript
// 1. è¿æ¥åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
\connect clusteradmin@192.168.1.10:3306

// 2. æ£€æŸ¥èŠ‚ç‚¹é…ç½®
dba.checkInstanceConfiguration('clusteradmin@192.168.1.10:3306')

// 3. åˆ›å»ºé›†ç¾¤
var cluster = dba.createCluster('prodCluster', {
    adoptFromGR: false,
    memberSslMode: 'REQUIRED',
    ipWhitelist: '192.168.1.0/24',
    exitStateAction: 'READ_ONLY'
})

// 4. æ·»åŠ ç¬¬äºŒä¸ªèŠ‚ç‚¹
cluster.addInstance('clusteradmin@192.168.1.11:3306', {
    recoveryMethod: 'clone',
    waitRecovery: 2
})

// 5. æ·»åŠ ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹  
cluster.addInstance('clusteradmin@192.168.1.12:3306', {
    recoveryMethod: 'clone', 
    waitRecovery: 2
})

// 6. æ£€æŸ¥é›†ç¾¤çŠ¶æ€
cluster.status()
```

**ğŸ“Š é›†ç¾¤åˆ›å»ºè¿‡ç¨‹ç›‘æ§**ï¼š
```
åˆ›å»ºè¿›åº¦è·Ÿè¸ª:
Step 1: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] èŠ‚ç‚¹1åˆå§‹åŒ–å®Œæˆ
Step 2: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ          ] èŠ‚ç‚¹2åŠ å…¥ä¸­...
        â””â”€ æ•°æ®å…‹éš†: 45% (450GB/1TB)
        â””â”€ é¢„è®¡å‰©ä½™: 15åˆ†é’Ÿ
Step 3: [                    ] ç­‰å¾…èŠ‚ç‚¹2å®Œæˆ
```

---

## 3. ğŸ“‹ é…ç½®æ¨¡æ¿ç®¡ç†


### 3.1 é…ç½®æ–‡ä»¶æ¨¡æ¿åŒ–


**ğŸ”§ é…ç½®æ¨¡æ¿ç»“æ„**

```
é…ç½®ç®¡ç†ç›®å½•ç»“æ„:
/opt/mysql-config/
â”œâ”€â”€ templates/              # é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ my.cnf.primary      # ä¸»èŠ‚ç‚¹æ¨¡æ¿
â”‚   â”œâ”€â”€ my.cnf.secondary    # ä»èŠ‚ç‚¹æ¨¡æ¿
â”‚   â””â”€â”€ router.conf         # Routeré…ç½®æ¨¡æ¿
â”œâ”€â”€ environments/           # ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ production/         # ç”Ÿäº§ç¯å¢ƒ
â”‚   â”œâ”€â”€ staging/           # é¢„å‘å¸ƒç¯å¢ƒ
â”‚   â””â”€â”€ development/       # å¼€å‘ç¯å¢ƒ
â””â”€â”€ scripts/               # éƒ¨ç½²è„šæœ¬
    â”œâ”€â”€ deploy.sh          # éƒ¨ç½²è„šæœ¬
    â””â”€â”€ validate.sh        # éªŒè¯è„šæœ¬
```

**ğŸ“ å‚æ•°åŒ–é…ç½®æ¨¡æ¿**ï¼š
```ini
# my.cnf.primary æ¨¡æ¿
[mysqld]
# åŸºæœ¬å‚æ•° - ä½¿ç”¨å˜é‡æ›¿æ¢
server_id = {{SERVER_ID}}
bind_address = {{BIND_ADDRESS}}
datadir = {{DATA_DIR}}

# æ€§èƒ½å‚æ•° - æ ¹æ®ç¡¬ä»¶é…ç½®
innodb_buffer_pool_size = {{BUFFER_POOL_SIZE}}
max_connections = {{MAX_CONNECTIONS}}

# é›†ç¾¤å‚æ•°
group_replication_local_address = "{{LOCAL_ADDRESS}}:33061"
group_replication_group_seeds = "{{GROUP_SEEDS}}"
```

### 3.2 ç¯å¢ƒå˜é‡é…ç½®


**ğŸŒ ç”Ÿäº§ç¯å¢ƒå˜é‡æ–‡ä»¶**ï¼š
```bash
# /opt/mysql-config/environments/production/cluster1.env

# é›†ç¾¤åŸºæœ¬ä¿¡æ¯
CLUSTER_NAME="prodCluster"
CLUSTER_DOMAIN="mysql.company.com"

# èŠ‚ç‚¹é…ç½®
NODE1_IP="192.168.1.10"
NODE2_IP="192.168.1.11" 
NODE3_IP="192.168.1.12"

# ç¡¬ä»¶é…ç½®
BUFFER_POOL_SIZE="32G"      # 64GBå†…å­˜çš„50%
MAX_CONNECTIONS="1000"
THREAD_CACHE_SIZE="100"

# ç½‘ç»œé…ç½®
GROUP_SEEDS="192.168.1.10:33061,192.168.1.11:33061,192.168.1.12:33061"

# å®‰å…¨é…ç½®
SSL_MODE="REQUIRED"
IP_WHITELIST="192.168.1.0/24,10.0.0.0/8"

# è·¯å¾„é…ç½®
DATA_DIR="/data/mysql/data"
LOG_DIR="/data/mysql/logs"
TMP_DIR="/data/mysql/tmp"
```

### 3.3 è‡ªåŠ¨åŒ–é…ç½®ç”Ÿæˆ


**ğŸ¤– é…ç½®ç”Ÿæˆè„šæœ¬**ï¼š
```bash
#!/bin/bash
# generate-config.sh - è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶

ENV_FILE=$1
TEMPLATE_DIR="/opt/mysql-config/templates"
OUTPUT_DIR="/opt/mysql-config/generated"

# åŠ è½½ç¯å¢ƒå˜é‡
source $ENV_FILE

# ç”Ÿæˆä¸»èŠ‚ç‚¹é…ç½®
envsubst < $TEMPLATE_DIR/my.cnf.primary > $OUTPUT_DIR/node1.cnf

# ä¸ºæ¯ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸åŒçš„server_id
sed -i "s/{{SERVER_ID}}/1/" $OUTPUT_DIR/node1.cnf
sed -i "s/{{LOCAL_ADDRESS}}/$NODE1_IP/" $OUTPUT_DIR/node1.cnf

echo "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ: $OUTPUT_DIR/"
ls -la $OUTPUT_DIR/
```

**âœ… é…ç½®éªŒè¯å·¥å…·**ï¼š
```bash
#!/bin/bash  
# validate-config.sh - éªŒè¯é…ç½®æ–‡ä»¶

CONFIG_FILE=$1

# æ£€æŸ¥è¯­æ³•
mysqld --defaults-file=$CONFIG_FILE --validate-config
if [ $? -eq 0 ]; then
    echo "âœ… é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®"
else
    echo "âŒ é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
    exit 1
fi

# æ£€æŸ¥å…³é”®å‚æ•°
if grep -q "group_replication_group_name" $CONFIG_FILE; then
    echo "âœ… é›†ç¾¤é…ç½®æ­£ç¡®"
else
    echo "âŒ ç¼ºå°‘é›†ç¾¤é…ç½®"
    exit 1
fi
```

---

## 4. âœ… éƒ¨ç½²éªŒè¯æ¸…å•


### 4.1 ç³»ç»Ÿç¯å¢ƒéªŒè¯


**ğŸ” ç¡¬ä»¶èµ„æºæ£€æŸ¥**

```bash
# ç³»ç»Ÿèµ„æºéªŒè¯è„šæœ¬
#!/bin/bash
echo "=== ç¡¬ä»¶èµ„æºéªŒè¯ ==="

# CPUæ£€æŸ¥
CPU_CORES=$(nproc)
echo "CPUæ ¸å¿ƒæ•°: $CPU_CORES (å»ºè®®â‰¥8æ ¸)"
[ $CPU_CORES -ge 8 ] && echo "âœ… CPUæ»¡è¶³è¦æ±‚" || echo "âŒ CPUä¸è¶³"

# å†…å­˜æ£€æŸ¥  
MEM_GB=$(free -g | awk '/^Mem:/{print $2}')
echo "å†…å­˜å¤§å°: ${MEM_GB}GB (å»ºè®®â‰¥32GB)"
[ $MEM_GB -ge 32 ] && echo "âœ… å†…å­˜æ»¡è¶³è¦æ±‚" || echo "âŒ å†…å­˜ä¸è¶³"

# ç£ç›˜æ£€æŸ¥
DISK_GB=$(df -BG /data | awk 'NR==2{print $2}' | sed 's/G//')
echo "æ•°æ®ç£ç›˜: ${DISK_GB}GB (å»ºè®®â‰¥1TB)"
[ $DISK_GB -ge 1000 ] && echo "âœ… ç£ç›˜æ»¡è¶³è¦æ±‚" || echo "âŒ ç£ç›˜ä¸è¶³"

# ç½‘ç»œæ£€æŸ¥
NETWORK_SPEED=$(ethtool eth0 | grep "Speed:" | awk '{print $2}')
echo "ç½‘ç»œé€Ÿåº¦: $NETWORK_SPEED (å»ºè®®â‰¥1Gbps)"
```

**ğŸ”’ å®‰å…¨é…ç½®éªŒè¯**

| æ£€æŸ¥é¡¹ | éªŒè¯å‘½ä»¤ | æœŸæœ›ç»“æœ | é‡è¦æ€§ |
|--------|----------|----------|--------|
| **é˜²ç«å¢™çŠ¶æ€** | `systemctl status firewalld` | Active | ğŸ”´ å¿…é¡» |
| **SELinuxçŠ¶æ€** | `getenforce` | Enforcing/Disabled | ğŸŸ¡ å»ºè®® |
| **ç”¨æˆ·æƒé™** | `ls -la /data/mysql` | mysql:mysql | ğŸ”´ å¿…é¡» |
| **ç«¯å£ç›‘å¬** | `netstat -tlnp \| grep 3306` | ä»…å†…ç½‘IP | ğŸ”´ å¿…é¡» |

### 4.2 MySQLæœåŠ¡éªŒè¯


**ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥**

```sql
-- è¿æ¥æµ‹è¯•
SELECT 'MySQLæœåŠ¡æ­£å¸¸' AS status;

-- ç‰ˆæœ¬ç¡®è®¤
SELECT VERSION() AS mysql_version;

-- æ’ä»¶çŠ¶æ€
SHOW PLUGINS WHERE Name = 'group_replication';

-- ç”¨æˆ·æƒé™éªŒè¯
SHOW GRANTS FOR 'clusteradmin'@'%';

-- é…ç½®å‚æ•°éªŒè¯
SELECT 
    $$server_id,
    $$gtid_mode,
    $$group_replication_group_name;
```

### 4.3 é›†ç¾¤å®Œæ•´æ€§éªŒè¯


**ğŸ”„ é›†ç¾¤çŠ¶æ€å…¨é¢æ£€æŸ¥**

```javascript
// MySQL Shellä¸­æ‰§è¡Œ
// 1. é›†ç¾¤æ•´ä½“çŠ¶æ€
var cluster = dba.getCluster()
var status = cluster.status()

// æ£€æŸ¥å…³é”®çŠ¶æ€ä¿¡æ¯
if (status.defaultReplicaSet.topology) {
    print("âœ… é›†ç¾¤æ‹“æ‰‘æ­£å¸¸")
    
    // æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çŠ¶æ€
    for (let node in status.defaultReplicaSet.topology) {
        let nodeStatus = status.defaultReplicaSet.topology[node].status
        print(`èŠ‚ç‚¹ ${node}: ${nodeStatus}`)
    }
} else {
    print("âŒ é›†ç¾¤æ‹“æ‰‘å¼‚å¸¸")
}
```

**ğŸ§ª æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**ï¼š
```sql
-- åœ¨ä¸»èŠ‚ç‚¹æ’å…¥æµ‹è¯•æ•°æ®
USE test;
CREATE TABLE deployment_test (
    id INT AUTO_INCREMENT PRIMARY KEY,
    data VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO deployment_test (data) VALUES ('éƒ¨ç½²éªŒè¯æµ‹è¯•');

-- åœ¨ä»èŠ‚ç‚¹éªŒè¯æ•°æ®
-- (ç­‰å¾…1-2ç§’åæŸ¥è¯¢)
SELECT * FROM deployment_test;
```

---

## 5. ğŸ§ª ä¸Šçº¿å‰æµ‹è¯•


### 5.1 åŠŸèƒ½æµ‹è¯•


**ğŸ“ åŸºç¡€åŠŸèƒ½æµ‹è¯•æ¸…å•**

```sql
-- 1. è¯»å†™æ“ä½œæµ‹è¯•
USE test;

-- å†™å…¥æµ‹è¯•
INSERT INTO deployment_test (data) VALUES ('å†™å…¥æµ‹è¯•1');
UPDATE deployment_test SET data = 'æ›´æ–°æµ‹è¯•' WHERE id = 1;

-- è¯»å–æµ‹è¯•  
SELECT COUNT(*) FROM deployment_test;
SELECT * FROM deployment_test ORDER BY id DESC LIMIT 10;

-- åˆ é™¤æµ‹è¯•
DELETE FROM deployment_test WHERE data LIKE '%æµ‹è¯•%';
```

**ğŸ”„ æ•…éšœåˆ‡æ¢æµ‹è¯•**ï¼š
```bash
# æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœ
# åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œ
sudo systemctl stop mysqld

# åœ¨MySQL Shellä¸­æ£€æŸ¥é›†ç¾¤çŠ¶æ€
\connect clusteradmin@192.168.1.11:3306
var cluster = dba.getCluster()
cluster.status()

# éªŒè¯æ–°ä¸»èŠ‚ç‚¹é€‰ä¸¾
# åº”è¯¥çœ‹åˆ°æ–°çš„PrimaryèŠ‚ç‚¹
```

### 5.2 æ€§èƒ½åŸºå‡†æµ‹è¯•


**âš¡ å‹åŠ›æµ‹è¯•é…ç½®**

```bash
# ä½¿ç”¨sysbenchè¿›è¡Œæ€§èƒ½æµ‹è¯•
# 1. å‡†å¤‡æµ‹è¯•æ•°æ®
sysbench oltp_read_write \
    --mysql-host=192.168.1.10 \
    --mysql-port=3306 \
    --mysql-user=clusteradmin \
    --mysql-password='ClusterPass123!' \
    --mysql-db=testdb \
    --tables=4 \
    --table-size=1000000 \
    prepare

# 2. æ‰§è¡Œè¯»å†™æ··åˆæµ‹è¯•
sysbench oltp_read_write \
    --mysql-host=192.168.1.10 \
    --mysql-port=3306 \
    --mysql-user=clusteradmin \
    --mysql-password='ClusterPass123!' \
    --mysql-db=testdb \
    --tables=4 \
    --table-size=1000000 \
    --threads=50 \
    --time=300 \
    --report-interval=10 \
    run
```

**ğŸ“Š æ€§èƒ½æŒ‡æ ‡è¯„ä¼°**

| æµ‹è¯•åœºæ™¯ | QPSç›®æ ‡ | å“åº”æ—¶é—´ç›®æ ‡ | é€šè¿‡æ ‡å‡† |
|---------|---------|-------------|----------|
| **çº¯è¯»æ“ä½œ** | >8000 | <10ms | 95%è¯·æ±‚è¾¾æ ‡ |
| **çº¯å†™æ“ä½œ** | >2000 | <50ms | 95%è¯·æ±‚è¾¾æ ‡ |
| **è¯»å†™æ··åˆ** | >5000 | <20ms | 90%è¯·æ±‚è¾¾æ ‡ |
| **é«˜å¹¶å‘åœºæ™¯** | >3000 | <100ms | 85%è¯·æ±‚è¾¾æ ‡ |

### 5.3 å®¹ç¾æµ‹è¯•


**ğŸš¨ ç¾éš¾åœºæ™¯æ¨¡æ‹Ÿ**

```bash
# åœºæ™¯1: å•èŠ‚ç‚¹æ•…éšœ
echo "=== æµ‹è¯•å•èŠ‚ç‚¹æ•…éšœæ¢å¤ ==="
# åœæ­¢ä¸€ä¸ªä»èŠ‚ç‚¹
ssh node2 "sudo systemctl stop mysqld"
# ç­‰å¾…30ç§’ï¼ŒéªŒè¯é›†ç¾¤ä»ç„¶å¯ç”¨
sleep 30
# æ¢å¤èŠ‚ç‚¹
ssh node2 "sudo systemctl start mysqld"

# åœºæ™¯2: ç½‘ç»œåˆ†åŒº
echo "=== æµ‹è¯•ç½‘ç»œåˆ†åŒºå¤„ç† ==="  
# ä¸´æ—¶é˜»æ–­ä¸€ä¸ªèŠ‚ç‚¹çš„ç½‘ç»œ
ssh node3 "sudo iptables -I INPUT -s 192.168.1.0/24 -j DROP"
# éªŒè¯é›†ç¾¤è¡Œä¸º
# æ¢å¤ç½‘ç»œ
ssh node3 "sudo iptables -D INPUT -s 192.168.1.0/24 -j DROP"
```

---

## 6. ğŸ”„ åˆ‡æ¢ç­–ç•¥åˆ¶å®š


### 6.1 ä¸šåŠ¡åˆ‡æ¢æ—¶é—´çª—å£


**â° åˆ‡æ¢æ—¶é—´è§„åˆ’**

```
åˆ‡æ¢æ—¶é—´çª—å£è¯„ä¼°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡ä½å³°æœŸ: å‡Œæ™¨ 2:00-4:00          â”‚
â”‚ é¢„ä¼°åˆ‡æ¢æ—¶é—´: 30åˆ†é’Ÿ                â”‚
â”‚ éªŒè¯æ—¶é—´: 30åˆ†é’Ÿ                    â”‚
â”‚ åº”æ€¥å¤„ç†æ—¶é—´: 60åˆ†é’Ÿ                â”‚
â”‚ æ€»æ—¶é—´çª—å£: 2å°æ—¶                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯¦ç»†æ—¶é—´å®‰æ’:
02:00-02:05  å‡†å¤‡å·¥ä½œï¼Œç¡®è®¤ç¯å¢ƒ
02:05-02:15  åœæ­¢åº”ç”¨æœåŠ¡
02:15-02:35  æ•°æ®åº“åˆ‡æ¢
02:35-02:45  åº”ç”¨é…ç½®æ›´æ–°  
02:45-03:15  åŠŸèƒ½éªŒè¯æµ‹è¯•
03:15-04:00  ç›‘æ§è§‚å¯ŸæœŸ
```

### 6.2 åˆ‡æ¢æ‰§è¡Œæ­¥éª¤


**ğŸ“‹ æ ‡å‡†åˆ‡æ¢æµç¨‹**

```bash
#!/bin/bash
# æ•°æ®åº“åˆ‡æ¢è„šæœ¬ switch-to-cluster.sh

# ç¬¬1æ­¥: å‡†å¤‡å·¥ä½œ
echo "æ­¥éª¤1: åˆ‡æ¢å‰å‡†å¤‡"
# å¤‡ä»½å½“å‰é…ç½®
cp /etc/my.cnf /etc/my.cnf.backup.$(date +%Y%m%d)

# ç¬¬2æ­¥: åœæ­¢åº”ç”¨æœåŠ¡
echo "æ­¥éª¤2: åœæ­¢åº”ç”¨æœåŠ¡"
for app in web-app1 web-app2 api-service; do
    systemctl stop $app
    echo "å·²åœæ­¢: $app"
done

# ç¬¬3æ­¥: æ•°æ®åº“æœ€ç»ˆåŒæ­¥
echo "æ­¥éª¤3: ç¡®ä¿æ•°æ®åŒæ­¥å®Œæˆ"
mysql -e "FLUSH LOGS; FLUSH TABLES WITH READ LOCK;"
sleep 10
mysql -e "UNLOCK TABLES;"

# ç¬¬4æ­¥: æ›´æ–°åº”ç”¨é…ç½®
echo "æ­¥éª¤4: æ›´æ–°æ•°æ®åº“è¿æ¥é…ç½®"
# å°†åº”ç”¨è¿æ¥ä»å•æœºæ”¹ä¸ºé›†ç¾¤
sed -i 's/192.168.1.100:3306/192.168.1.10:6446/' /app/config/database.conf

# ç¬¬5æ­¥: å¯åŠ¨åº”ç”¨æœåŠ¡
echo "æ­¥éª¤5: å¯åŠ¨åº”ç”¨æœåŠ¡"
for app in web-app1 web-app2 api-service; do
    systemctl start $app
    echo "å·²å¯åŠ¨: $app"
done

echo "åˆ‡æ¢å®Œæˆï¼Œå¼€å§‹éªŒè¯..."
```

### 6.3 åˆ‡æ¢éªŒè¯æ­¥éª¤


**âœ… åˆ‡æ¢åéªŒè¯æ£€æŸ¥**

```bash
# éªŒè¯è„šæœ¬ verify-switch.sh
#!/bin/bash

echo "=== å¼€å§‹åˆ‡æ¢éªŒè¯ ==="

# 1. æ•°æ®åº“è¿æ¥éªŒè¯
echo "éªŒè¯æ•°æ®åº“è¿æ¥..."
mysql -h 192.168.1.10 -P 6446 -u app_user -e "SELECT 1" > /dev/null 2>&1
[ $? -eq 0 ] && echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸" || echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"

# 2. åº”ç”¨æœåŠ¡éªŒè¯
echo "éªŒè¯åº”ç”¨æœåŠ¡..."
for service in web-app1 web-app2 api-service; do
    if systemctl is-active $service > /dev/null; then
        echo "âœ… $service è¿è¡Œæ­£å¸¸"
    else
        echo "âŒ $service æœªè¿è¡Œ"
    fi
done

# 3. ä¸šåŠ¡åŠŸèƒ½éªŒè¯
echo "éªŒè¯ä¸šåŠ¡åŠŸèƒ½..."
# æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ
curl -f http://localhost:8080/health > /dev/null 2>&1
[ $? -eq 0 ] && echo "âœ… ä¸šåŠ¡æ¥å£æ­£å¸¸" || echo "âŒ ä¸šåŠ¡æ¥å£å¼‚å¸¸"

# 4. æ•°æ®ä¸€è‡´æ€§éªŒè¯
echo "éªŒè¯æ•°æ®ä¸€è‡´æ€§..."
# åœ¨ä¸åŒèŠ‚ç‚¹æŸ¥è¯¢å…³é”®ä¸šåŠ¡æ•°æ®
RESULT1=$(mysql -h 192.168.1.10 -P 6447 -u app_user -e "SELECT COUNT(*) FROM users" | tail -n1)
RESULT2=$(mysql -h 192.168.1.11 -P 3306 -u app_user -e "SELECT COUNT(*) FROM users" | tail -n1)
[ "$RESULT1" = "$RESULT2" ] && echo "âœ… æ•°æ®ä¸€è‡´æ€§æ­£å¸¸" || echo "âŒ æ•°æ®ä¸ä¸€è‡´"
```

---

## 7. ğŸ”™ å›æ»šæ–¹æ¡ˆå‡†å¤‡


### 7.1 å›æ»šè§¦å‘æ¡ä»¶


**ğŸš¨ å›æ»šå†³ç­–æ ‡å‡†**

| å¼‚å¸¸ç±»å‹ | è§¦å‘æ¡ä»¶ | å›æ»šæ—¶é—´ | ä¼˜å…ˆçº§ |
|---------|----------|----------|--------|
| **è¿æ¥å¤±è´¥** | è¿æ¥æˆåŠŸç‡<95% | ç«‹å³ | ğŸ”´ P0 |
| **æ€§èƒ½ä¸‹é™** | å“åº”æ—¶é—´>åŸæ¥2å€ | 15åˆ†é’Ÿå†… | ğŸŸ¡ P1 |
| **æ•°æ®å¼‚å¸¸** | å‘ç°æ•°æ®ä¸ä¸€è‡´ | ç«‹å³ | ğŸ”´ P0 |
| **ä¸šåŠ¡åŠŸèƒ½å¼‚å¸¸** | æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨ | 5åˆ†é’Ÿå†… | ğŸ”´ P0 |

**âš–ï¸ å›æ»šå†³ç­–æµç¨‹**ï¼š
```
å¼‚å¸¸å‘ç°
    â†“
è¯„ä¼°å½±å“èŒƒå›´
    â†“
æ˜¯å¦è¾¾åˆ°å›æ»šæ¡ä»¶ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ æ‰§è¡Œå›æ»š
    â””â”€ å¦ â†’ ç»§ç»­ç›‘æ§
         â†“
     é—®é¢˜æ˜¯å¦è§£å†³ï¼Ÿ
         â”œâ”€ æ˜¯ â†’ ç»§ç»­è§‚å¯Ÿ
         â””â”€ å¦ â†’ è€ƒè™‘å›æ»š
```

### 7.2 å›æ»šæ‰§è¡Œæ­¥éª¤


**âª å¿«é€Ÿå›æ»šæµç¨‹**

```bash
#!/bin/bash
# ç´§æ€¥å›æ»šè„šæœ¬ emergency-rollback.sh

echo "=== ç´§æ€¥å›æ»šå¼€å§‹ ==="
START_TIME=$(date)

# ç¬¬1æ­¥: ç«‹å³åœæ­¢åº”ç”¨æœåŠ¡
echo "æ­¥éª¤1: åœæ­¢åº”ç”¨æœåŠ¡"
for app in web-app1 web-app2 api-service; do
    systemctl stop $app
    echo "å·²åœæ­¢: $app"
done

# ç¬¬2æ­¥: æ¢å¤åŸæ•°æ®åº“é…ç½®
echo "æ­¥éª¤2: æ¢å¤æ•°æ®åº“é…ç½®"
if [ -f /etc/my.cnf.backup.$(date +%Y%m%d) ]; then
    cp /etc/my.cnf.backup.$(date +%Y%m%d) /etc/my.cnf
    echo "âœ… é…ç½®æ–‡ä»¶å·²æ¢å¤"
else
    echo "âŒ å¤‡ä»½é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# ç¬¬3æ­¥: æ¢å¤åº”ç”¨é…ç½®
echo "æ­¥éª¤3: æ¢å¤åº”ç”¨è¿æ¥é…ç½®"
# å°†è¿æ¥åœ°å€æ”¹å›åŸæ¥çš„å•æœº
sed -i 's/192.168.1.10:6446/192.168.1.100:3306/' /app/config/database.conf

# ç¬¬4æ­¥: å¯åŠ¨åŸæ•°æ®åº“æœåŠ¡
echo "æ­¥éª¤4: å¯åŠ¨åŸæ•°æ®åº“"
systemctl start mysqld-single
sleep 10

# ç¬¬5æ­¥: å¯åŠ¨åº”ç”¨æœåŠ¡
echo "æ­¥éª¤5: å¯åŠ¨åº”ç”¨æœåŠ¡"
for app in web-app1 web-app2 api-service; do
    systemctl start $app
    sleep 5
    if systemctl is-active $app > /dev/null; then
        echo "âœ… $app å¯åŠ¨æˆåŠŸ"
    else
        echo "âŒ $app å¯åŠ¨å¤±è´¥"
    fi
done

END_TIME=$(date)
echo "=== å›æ»šå®Œæˆ ==="
echo "å¼€å§‹æ—¶é—´: $START_TIME"
echo "ç»“æŸæ—¶é—´: $END_TIME"
```

### 7.3 å›æ»šåéªŒè¯


**ğŸ” å›æ»šéªŒè¯æ¸…å•**

```bash
# å›æ»šéªŒè¯è„šæœ¬
#!/bin/bash

echo "=== å›æ»šåéªŒè¯å¼€å§‹ ==="

# 1. æ•°æ®åº“æœåŠ¡éªŒè¯
mysql -h 192.168.1.100 -u root -e "SELECT 'database ok'" > /dev/null 2>&1
[ $? -eq 0 ] && echo "âœ… åŸæ•°æ®åº“æœåŠ¡æ­£å¸¸" || echo "âŒ åŸæ•°æ®åº“æœåŠ¡å¼‚å¸¸"

# 2. åº”ç”¨è¿æ¥éªŒè¯
curl -f http://localhost:8080/health > /dev/null 2>&1
[ $? -eq 0 ] && echo "âœ… åº”ç”¨æœåŠ¡æ¢å¤æ­£å¸¸" || echo "âŒ åº”ç”¨æœåŠ¡ä»æœ‰é—®é¢˜"

# 3. å…³é”®ä¸šåŠ¡éªŒè¯
# æ‰§è¡Œå…³é”®ä¸šåŠ¡æ“ä½œæµ‹è¯•
echo "è¿›è¡Œå…³é”®ä¸šåŠ¡æµ‹è¯•..."

# 4. æ€§èƒ½éªŒè¯
echo "æ£€æŸ¥ç³»ç»Ÿæ€§èƒ½..."
RESPONSE_TIME=$(curl -w "%{time_total}" -o /dev/null -s http://localhost:8080/api/test)
if (( $(echo "$RESPONSE_TIME < 0.5" | bc -l) )); then
    echo "âœ… å“åº”æ—¶é—´æ­£å¸¸: ${RESPONSE_TIME}s"
else
    echo "âš ï¸ å“åº”æ—¶é—´è¾ƒæ…¢: ${RESPONSE_TIME}s"
fi
```

---

## 8. ğŸ“Š ç”Ÿäº§ç¯å¢ƒç›‘æ§


### 8.1 ç›‘æ§ä½“ç³»æ¶æ„


**ğŸ—ï¸ ç›‘æ§æ¶æ„è®¾è®¡**

```
ç›‘æ§æ•°æ®æµ:
MySQL Cluster â†’ Exporters â†’ Prometheus â†’ Grafana â†’ å‘Šè­¦
     â†“             â†“           â†“           â†“        â†“
  æ€§èƒ½æŒ‡æ ‡      æ•°æ®é‡‡é›†     æ•°æ®å­˜å‚¨    å¯è§†åŒ–    é€šçŸ¥
     â†“             â†“           â†“           â†“        â†“
  é”™è¯¯æ—¥å¿—      æ—¥å¿—æ”¶é›†     æ£€ç´¢åˆ†æ    dashboard  çŸ­ä¿¡/é‚®ä»¶
```

**ğŸ“¡ ç›‘æ§ç»„ä»¶éƒ¨ç½²**ï¼š
```bash
# 1. å®‰è£…MySQL Exporter
wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.14.0/mysqld_exporter-0.14.0.linux-amd64.tar.gz
tar xvf mysqld_exporter-0.14.0.linux-amd64.tar.gz
sudo mv mysqld_exporter-0.14.0.linux-amd64/mysqld_exporter /usr/local/bin/

# 2. åˆ›å»ºç›‘æ§ç”¨æˆ·
mysql -e "
CREATE USER 'exporter'@'localhost' IDENTIFIED BY 'MonitorPass123!' WITH MAX_USER_CONNECTIONS 3;
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'localhost';
FLUSH PRIVILEGES;
"

# 3. é…ç½®systemdæœåŠ¡
cat > /etc/systemd/system/mysqld_exporter.service << EOF
[Unit]
Description=MySQL Exporter
After=network.target

[Service]
Type=simple
Restart=always
User=mysql
ExecStart=/usr/local/bin/mysqld_exporter \
  --config.my-cnf=/etc/mysqld_exporter/.my.cnf \
  --collect.global_status \
  --collect.info_schema.innodb_metrics \
  --collect.auto_increment.columns \
  --collect.global_variables \
  --collect.info_schema.processlist

[Install]
WantedBy=multi-user.target
EOF
```

### 8.2 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ é›†ç¾¤å¥åº·æŒ‡æ ‡**

| æŒ‡æ ‡ç±»åˆ« | å…³é”®æŒ‡æ ‡ | å‘Šè­¦é˜ˆå€¼ | æ£€æŸ¥é¢‘ç‡ |
|---------|----------|----------|----------|
| **è¿æ¥çŠ¶æ€** | `mysql_global_status_threads_connected` | >800 | 30ç§’ |
| **æŸ¥è¯¢æ€§èƒ½** | `mysql_global_status_questions` | QPS>5000 | 10ç§’ |
| **å¤åˆ¶å»¶è¿Ÿ** | `mysql_slave_lag_seconds` | >5ç§’ | 30ç§’ |
| **é”™è¯¯ç‡** | `mysql_global_status_connection_errors_total` | >10/min | 1åˆ†é’Ÿ |

**ğŸ’¾ å­˜å‚¨ç›‘æ§æŒ‡æ ‡**ï¼š
```sql
-- å…³é”®å­˜å‚¨æŒ‡æ ‡æŸ¥è¯¢
SELECT 
    'InnoDBç¼“å†²æ± ä½¿ç”¨ç‡' AS metric,
    ROUND(
        (SELECT variable_value FROM information_schema.global_status WHERE variable_name = 'Innodb_buffer_pool_pages_data') /
        (SELECT variable_value FROM information_schema.global_variables WHERE variable_name = 'innodb_buffer_pool_size') * 16384 * 100, 2
    ) AS value_percent;

-- ç£ç›˜ä½¿ç”¨ç‡
SELECT 
    table_schema AS 'Database',
    ROUND(SUM(data_length + index_length) / 1024 / 1024 / 1024, 2) AS 'Size_GB'
FROM information_schema.tables 
GROUP BY table_schema
ORDER BY Size_GB DESC;
```

### 8.3 å‘Šè­¦è§„åˆ™é…ç½®


**ğŸš¨ Prometheuså‘Šè­¦è§„åˆ™**

```yaml
# mysql-cluster-alerts.yml
groups:
- name: mysql-cluster
  rules:
  # é›†ç¾¤å¯ç”¨æ€§å‘Šè­¦
  - alert: MySQLClusterDown
    expr: mysql_up == 0
    for: 30s
    labels:
      severity: critical
    annotations:
      summary: "MySQLèŠ‚ç‚¹ {{ $labels.instance }} ä¸å¯ç”¨"
      description: "é›†ç¾¤èŠ‚ç‚¹å·²ç»å®•æœºè¶…è¿‡30ç§’"

  # ä¸»ä»å»¶è¿Ÿå‘Šè­¦  
  - alert: MySQLReplicationLag
    expr: mysql_slave_lag_seconds > 5
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MySQLå¤åˆ¶å»¶è¿Ÿè¿‡é«˜"
      description: "å»¶è¿Ÿæ—¶é—´: {{ $value }}ç§’"

  # è¿æ¥æ•°å‘Šè­¦
  - alert: MySQLTooManyConnections
    expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections > 0.8
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "MySQLè¿æ¥æ•°è¿‡å¤š"
      description: "å½“å‰è¿æ¥æ•°å æ¯”: {{ $value | humanizePercentage }}"

  # æŸ¥è¯¢æ€§èƒ½å‘Šè­¦
  - alert: MySQLSlowQueries
    expr: rate(mysql_global_status_slow_queries[5m]) > 10
    for: 2m
    labels:
      severity: warning  
    annotations:
      summary: "MySQLæ…¢æŸ¥è¯¢å¢å¤š"
      description: "æ…¢æŸ¥è¯¢é¢‘ç‡: {{ $value }}/ç§’"
```

### 8.4 å¯è§†åŒ–Dashboard


**ğŸ“Š Grafanaç›‘æ§é¢æ¿**

```json
{
  "dashboard": {
    "title": "MySQL InnoDB Clusterç›‘æ§",
    "panels": [
      {
        "title": "é›†ç¾¤çŠ¶æ€æ¦‚è§ˆ",
        "type": "stat",
        "targets": [
          {
            "expr": "mysql_up",
            "legendFormat": "èŠ‚ç‚¹{{instance}}"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢æ€§èƒ½è¶‹åŠ¿", 
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mysql_global_status_questions[5m])",
            "legendFormat": "QPS"
          },
          {
            "expr": "rate(mysql_global_status_slow_queries[5m])",
            "legendFormat": "æ…¢æŸ¥è¯¢/ç§’"
          }
        ]
      },
      {
        "title": "è¿æ¥æ•°ç›‘æ§",
        "type": "graph", 
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected",
            "legendFormat": "å½“å‰è¿æ¥æ•°"
          },
          {
            "expr": "mysql_global_variables_max_connections",
            "legendFormat": "æœ€å¤§è¿æ¥æ•°"
          }
        ]
      }
    ]
  }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 éƒ¨ç½²æˆåŠŸçš„å…³é”®è¦ç´ 


```
ğŸ¯ éƒ¨ç½²æˆåŠŸå››å¤§è¦ç´ :

1. å……åˆ†è§„åˆ’ ğŸ“‹
   â€¢ ç¡¬ä»¶å®¹é‡é¢„ä¼°å‡†ç¡®
   â€¢ ç½‘ç»œæ¶æ„è®¾è®¡åˆç†
   â€¢ æ‰©å±•è·¯å¾„è§„åˆ’æ¸…æ™°

2. æ ‡å‡†æµç¨‹ âš™ï¸
   â€¢ é…ç½®æ¨¡æ¿åŒ–ç®¡ç†
   â€¢ éƒ¨ç½²æ­¥éª¤æ ‡å‡†åŒ–
   â€¢ éªŒè¯æµç¨‹è‡ªåŠ¨åŒ–

3. å®Œå–„æµ‹è¯• ğŸ§ª
   â€¢ åŠŸèƒ½æµ‹è¯•å…¨è¦†ç›–
   â€¢ æ€§èƒ½åŸºå‡†éªŒè¯
   â€¢ å®¹ç¾åœºæ™¯æ¼”ç»ƒ

4. ç›‘æ§ä¿éšœ ğŸ“Š
   â€¢ å®æ—¶çŠ¶æ€ç›‘æ§
   â€¢ å…³é”®æŒ‡æ ‡å‘Šè­¦
   â€¢ å¯è§†åŒ–è¿ç»´
```

### 9.2 å¸¸è§éƒ¨ç½²é—®é¢˜åŠè§£å†³


**âš ï¸ å…¸å‹é—®é¢˜å¤„ç†**

| é—®é¢˜ç±»å‹ | å¸¸è§åŸå›  | è§£å†³æ–¹æ¡ˆ | é¢„é˜²æªæ–½ |
|---------|----------|----------|----------|
| **èŠ‚ç‚¹åŠ å…¥å¤±è´¥** | ç½‘ç»œè¿é€šæ€§é—®é¢˜ | æ£€æŸ¥é˜²ç«å¢™å’Œè·¯ç”± | éƒ¨ç½²å‰ç½‘ç»œæµ‹è¯• |
| **æ•°æ®åŒæ­¥ç¼“æ…¢** | ç£ç›˜IOç“¶é¢ˆ | ä¼˜åŒ–ç£ç›˜é…ç½® | ä½¿ç”¨SSDå­˜å‚¨ |
| **æ€§èƒ½ä¸è¾¾æ ‡** | é…ç½®å‚æ•°ä¸å½“ | è°ƒä¼˜å…³é”®å‚æ•° | åŸºäºå‹æµ‹è°ƒä¼˜ |
| **ç›‘æ§æ•°æ®ç¼ºå¤±** | æƒé™é…ç½®é”™è¯¯ | é‡æ–°è®¾ç½®ç›‘æ§ç”¨æˆ·æƒé™ | éƒ¨ç½²æ—¶éªŒè¯ç›‘æ§ |

### 9.3 è¿ç»´æœ€ä½³å®è·µ


**ğŸ’¡ ç”Ÿäº§è¿ç»´å»ºè®®**

```
æ—¥å¸¸è¿ç»´è¦ç‚¹:

âœ… å®šæœŸå¤‡ä»½
   â€¢ æ¯æ—¥å…¨é‡å¤‡ä»½
   â€¢ å®æ—¶binlogå¤‡ä»½
   â€¢ å®šæœŸæ¢å¤æ¼”ç»ƒ

âœ… æ€§èƒ½ç›‘æ§  
   â€¢ å…³æ³¨èµ„æºä½¿ç”¨è¶‹åŠ¿
   â€¢ è®¾ç½®åˆç†å‘Šè­¦é˜ˆå€¼
   â€¢ å®šæœŸæ€§èƒ½åŸºçº¿æµ‹è¯•

âœ… å®‰å…¨ç»´æŠ¤
   â€¢ å®šæœŸæ›´æ–°å¯†ç 
   â€¢ å®¡è®¡ç”¨æˆ·æƒé™
   â€¢ ç›‘æ§å¼‚å¸¸è¿æ¥

âœ… å®¹é‡ç®¡ç†
   â€¢ ç›‘æ§å­˜å‚¨ä½¿ç”¨ç‡
   â€¢ æå‰æ‰©å®¹è§„åˆ’
   â€¢ æ•°æ®å½’æ¡£ç­–ç•¥
```

**ğŸ“ˆ æŒç»­ä¼˜åŒ–æ–¹å‘**

- **æ€§èƒ½ä¼˜åŒ–**: åŸºäºç›‘æ§æ•°æ®æŒç»­è°ƒä¼˜
- **è‡ªåŠ¨åŒ–**: æé«˜éƒ¨ç½²å’Œè¿ç»´è‡ªåŠ¨åŒ–ç¨‹åº¦
- **æ ‡å‡†åŒ–**: å»ºç«‹å®Œå–„çš„è¿ç»´æ ‡å‡†å’Œæµç¨‹
- **äººå‘˜åŸ¹è®­**: æå‡å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›å’Œåº”æ€¥å¤„ç†èƒ½åŠ›

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> "è§„åˆ’å…ˆè¡Œï¼Œæµç¨‹æ ‡å‡†ï¼Œ
> æµ‹è¯•å……åˆ†ï¼Œç›‘æ§å®Œå–„ï¼Œ  
> é—®é¢˜é¢„æ¡ˆï¼ŒæŒç»­ä¼˜åŒ–ï¼Œ
> ç”Ÿäº§ç¨³å®šï¼Œä¸šåŠ¡å®‰å…¨"

**ğŸ’ª éƒ¨ç½²æˆåŠŸæ ‡å¿—**ï¼š
- æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€æ­£å¸¸
- æ€§èƒ½æŒ‡æ ‡è¾¾åˆ°é¢„æœŸ
- ç›‘æ§å‘Šè­¦æ­£å¸¸è¿è¡Œ
- ä¸šåŠ¡åŠŸèƒ½éªŒè¯é€šè¿‡
- è¿ç»´å›¢é˜Ÿå…·å¤‡ç»´æŠ¤èƒ½åŠ›