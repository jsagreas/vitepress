---
title: 19、集群成员管理与角色变更
---
## 📚 目录

1. [集群成员管理概述](#1-集群成员管理概述)
2. [集群成员查看与状态监控](#2-集群成员查看与状态监控)
3. [节点重新加入集群](#3-节点重新加入集群)
4. [主节点切换管理](#4-主节点切换管理)
5. [成员权重与优先级调整](#5-成员权重与优先级调整)
6. [节点状态管理](#6-节点状态管理)
7. [成员视图变更处理](#7-成员视图变更处理)
8. [角色变更验证与故障排除](#8-角色变更验证与故障排除)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 集群成员管理概述


### 1.1 什么是集群成员管理


**集群成员管理**就是对 MySQL InnoDB Cluster 中各个节点进行管理和维护的过程。简单来说，就是管理集群中每个 MySQL 服务器的状态、角色和参与情况。

**核心概念理解**：
```
集群成员 = 参与集群的每个 MySQL 服务器实例
成员管理 = 对这些服务器的添加、移除、状态监控等操作
角色变更 = 主节点、从节点之间的角色切换
```

### 1.2 集群成员的基本角色


**🔸 主要角色类型**：

```
主节点 (Primary)：
• 含义：负责处理写操作的节点
• 作用：接受应用程序的增删改操作
• 特点：同一时间只有一个主节点

从节点 (Secondary)：
• 含义：负责处理读操作的节点
• 作用：从主节点同步数据，提供读取服务
• 特点：可以有多个从节点

仲裁节点 (Arbitrator)：
• 含义：不存储数据，只参与投票
• 作用：在网络分区时帮助选举新主节点
• 特点：资源消耗最小
```

### 1.3 成员管理的核心任务


**📋 日常管理任务**：
- **状态监控**：定期检查每个节点的健康状况
- **角色管理**：控制主从角色的分配和切换
- **故障处理**：处理节点离线、网络分区等问题
- **性能优化**：调整成员权重，优化集群性能

---

## 2. 🔍 集群成员查看与状态监控


### 2.1 cluster.describe() 基础用法


**基本语法理解**：
```javascript
// 最简单的集群描述命令
cluster.describe()

// 含义：查看当前集群的基本信息
// 作用：显示集群名称、成员列表、拓扑结构等
```

**💡 实际执行示例**：
```javascript
MySQL  JS > var cluster = dba.getCluster()
MySQL  JS > cluster.describe()
{
    "clusterName": "myCluster", 
    "defaultReplicaSet": {
        "name": "default", 
        "topology": [
            {
                "address": "mysql1:3306", 
                "label": "mysql1:3306", 
                "role": "HA"
            }, 
            {
                "address": "mysql2:3306", 
                "label": "mysql2:3306", 
                "role": "HA"
            }, 
            {
                "address": "mysql3:3306", 
                "label": "mysql3:3306", 
                "role": "HA"
            }
        ]
    }
}
```

### 2.2 详细状态信息查看


**cluster.status() 详细状态**：
```javascript
// 查看集群详细状态
cluster.status()

// 含义：获取比 describe() 更详细的状态信息
// 包含：节点状态、复制延迟、成员模式等
```

**状态信息解读**：
```javascript
{
    "clusterName": "myCluster",
    "defaultReplicaSet": {
        "status": "OK",                    // 集群整体状态
        "statusText": "Cluster is ONLINE", // 状态描述
        "topology": {
            "mysql1:3306": {
                "address": "mysql1:3306",
                "mode": "R/W",             // 读写模式 (主节点)
                "readReplicas": {},
                "role": "HA",
                "status": "ONLINE",        // 节点状态
                "version": "8.0.28"
            },
            "mysql2:3306": {
                "address": "mysql2:3306", 
                "mode": "R/O",             // 只读模式 (从节点)
                "readReplicas": {},
                "replicationLag": null,    // 复制延迟
                "role": "HA",
                "status": "ONLINE",
                "version": "8.0.28"
            }
        }
    }
}
```

### 2.3 成员状态详细说明


**🔸 节点状态类型**：

| 状态 | 含义 | 说明 |
|------|------|------|
| `ONLINE` | **在线正常** | 节点运行正常，参与集群操作 |
| `OFFLINE` | **离线状态** | 节点无法连接或已停止 |
| `RECOVERING` | **恢复中** | 节点正在同步数据，追赶进度 |
| `UNREACHABLE` | **不可达** | 网络连接问题，无法通信 |
| `ERROR` | **错误状态** | 节点出现严重错误 |

**🔸 节点模式类型**：

| 模式 | 含义 | 角色 |
|------|------|------|
| `R/W` | **读写模式** | 主节点，可以处理写操作 |
| `R/O` | **只读模式** | 从节点，只能处理读操作 |
| `n/a` | **不适用** | 节点离线或错误状态 |

---

## 3. 🔄 节点重新加入集群


### 3.1 cluster.rejoinInstance() 基本用法


**什么时候需要重新加入**：
```
常见场景：
• 节点意外离线后重新启动
• 网络故障恢复后节点重连
• 手动移除节点后想重新加入
• 节点数据同步出现问题
```

**基本语法**：
```javascript
// 重新加入指定节点
cluster.rejoinInstance('mysql2:3306')

// 含义：让已经离线的节点重新加入集群
// 作用：恢复节点的集群成员身份和数据同步
```

### 3.2 重新加入的详细步骤


**🔧 操作步骤示例**：

```javascript
// 第1步：检查集群状态
MySQL  JS > var cluster = dba.getCluster()
MySQL  JS > cluster.status()

// 第2步：检查问题节点状态
// 假设 mysql2:3306 显示为 OFFLINE

// 第3步：尝试重新加入
MySQL  JS > cluster.rejoinInstance('mysql2:3306')
Rejoining instance 'mysql2:3306' to cluster 'myCluster'...

Re-creating recovery account...
NOTE: User 'mysql_innodb_cluster_102'@'%' already exists at instance 'mysql1:3306'.
Rejoining instance to the InnoDB cluster. Depending on the original problem that made the instance unavailable, the rejoin operation might not be successful and further manual steps will be required to fix the underlying problem.

Please wait for the instance to apply pending changes...
The instance 'mysql2:3306' was successfully rejoined to the cluster.

// 第4步：验证重新加入结果
MySQL  JS > cluster.status()
```

### 3.3 重新加入的选项配置


**常用配置选项**：
```javascript
// 带选项的重新加入
cluster.rejoinInstance('mysql2:3306', {
    'recoveryMethod': 'auto',        // 恢复方法：auto/clone/incremental
    'waitRecovery': 3,              // 等待恢复完成的级别 (0-3)
    'certSubject': null             // SSL证书主题
})
```

**🔸 recoveryMethod 选项说明**：

| 方法 | 含义 | 适用场景 |
|------|------|----------|
| `auto` | **自动选择** | 让系统自动选择最佳恢复方式 |
| `incremental` | **增量恢复** | 数据差异不大，通过日志追赶 |
| `clone` | **完整克隆** | 数据差异太大，需要完整复制 |

---

## 4. 🎛️ 主节点切换管理


### 4.1 主节点切换的概念


**什么是主节点切换**：
```
主节点切换 = 将集群的主节点角色从一个节点转移到另一个节点
目的：
• 计划内维护：主节点需要维护时的优雅切换
• 负载均衡：将写操作负载转移到性能更好的节点
• 故障恢复：主节点故障时的紧急切换
```

### 4.2 手动主节点切换


**cluster.setPrimaryInstance() 用法**：
```javascript
// 手动设置新的主节点
cluster.setPrimaryInstance('mysql3:3306')

// 含义：将 mysql3:3306 设置为新的主节点
// 作用：其他节点自动变为从节点，开始从新主节点同步数据
```

**🔧 切换操作示例**：
```javascript
// 第1步：查看当前主节点
MySQL  JS > cluster.status()
// 假设当前主节点是 mysql1:3306 (mode: "R/W")

// 第2步：执行主节点切换
MySQL  JS > cluster.setPrimaryInstance('mysql2:3306')
Setting instance 'mysql2:3306' as the primary instance of cluster 'myCluster'...

Instance 'mysql1:3306' was switched from PRIMARY to SECONDARY.
Instance 'mysql2:3306' was switched from SECONDARY to PRIMARY.

The instance 'mysql2:3306' was successfully elected primary.

// 第3步：验证切换结果
MySQL  JS > cluster.status()
// 现在 mysql2:3306 应该显示 mode: "R/W"
```

### 4.3 主节点选举规则


**自动选举条件**：
```
选举触发时机：
• 当前主节点故障或离线
• 集群分区后需要重新选举
• 手动触发选举过程

选举规则：
1. 数据最新的节点优先
2. 成员权重高的节点优先  
3. 服务器ID小的节点优先
4. 网络连接最稳定的节点优先
```

---

## 5. ⚖️ 成员权重与优先级调整


### 5.1 成员权重的概念


**什么是成员权重**：
```
成员权重 = 节点在主节点选举中的优先级分数
作用：
• 影响自动故障切换时的主节点选择
• 控制哪个节点更可能成为主节点
• 实现基于硬件性能的智能选举
```

**权重值说明**：
```
权重范围：0-100
• 100：最高优先级，最可能被选为主节点
• 50：默认权重，中等优先级
• 0：最低优先级，避免成为主节点
```

### 5.2 查看和设置成员权重


**查看当前权重**：
```javascript
// 查看集群详细配置
cluster.options()

// 或者查看特定实例配置
cluster.describe()
```

**设置成员权重**：
```javascript
// 设置节点权重
cluster.setInstanceOption('mysql1:3306', 'memberWeight', 100)
cluster.setInstanceOption('mysql2:3306', 'memberWeight', 75) 
cluster.setInstanceOption('mysql3:3306', 'memberWeight', 50)

// 含义：
// mysql1 权重最高，优先成为主节点
// mysql2 权重中等，作为备选主节点
// mysql3 权重最低，一般作为从节点
```

### 5.3 权重设置的实践建议


**🎯 权重设置策略**：

```
高性能服务器：权重 80-100
• 含义：CPU、内存、存储性能最好的服务器
• 作用：优先承担主节点的写操作负载

中等性能服务器：权重 50-70  
• 含义：性能适中的服务器
• 作用：作为备用主节点，平时处理读操作

低性能服务器：权重 10-30
• 含义：性能较差或专用于特殊用途的服务器
• 作用：主要处理读操作，避免成为主节点
```

**实际配置示例**：
```javascript
// 生产环境的典型权重配置
cluster.setInstanceOption('prod-mysql-01:3306', 'memberWeight', 100)  // 主生产服务器
cluster.setInstanceOption('prod-mysql-02:3306', 'memberWeight', 80)   // 备用生产服务器  
cluster.setInstanceOption('backup-mysql-01:3306', 'memberWeight', 20) // 备份专用服务器
```

---

## 6. 📊 节点状态管理


### 6.1 节点状态监控


**实时状态检查**：
```javascript
// 检查集群整体状态
cluster.status()

// 检查特定节点状态
cluster.status({extended: 1})  // 显示更详细信息
cluster.status({extended: 2})  // 显示完整的状态信息
```

**🔸 extended 参数说明**：

| 级别 | 含义 | 显示内容 |
|------|------|----------|
| `0` | **基础信息** | 节点状态、角色、模式 |
| `1` | **详细信息** | 包含复制延迟、连接信息 |
| `2` | **完整信息** | 包含所有可用的状态数据 |

### 6.2 处理离线节点


**节点离线的常见原因**：
```
网络问题：
• 网络中断或延迟过高
• 防火墙规则阻断连接
• DNS解析问题

服务问题：  
• MySQL服务停止
• 服务器硬件故障
• 磁盘空间不足

配置问题：
• 集群配置错误
• 用户权限问题
• SSL证书过期
```

**处理离线节点的步骤**：
```javascript
// 第1步：确认节点状态
cluster.status()

// 第2步：尝试重新加入
cluster.rejoinInstance('offline-node:3306')

// 第3步：如果重新加入失败，检查节点本身
// 连接到问题节点进行诊断
\connect offline-node:3306
\sql SHOW VARIABLES LIKE 'group_replication%';

// 第4步：根据问题采取相应措施
// 如果是配置问题，修复配置后重新加入
// 如果是硬件问题，可能需要从集群中移除该节点
```

### 6.3 节点健康检查脚本


**定期健康检查**：
```javascript
// 创建健康检查函数
function checkClusterHealth() {
    var cluster = dba.getCluster();
    var status = cluster.status();
    
    print("=== 集群健康检查报告 ===");
    print("集群名称: " + status.clusterName);
    print("集群状态: " + status.defaultReplicaSet.status);
    
    // 检查每个节点
    var topology = status.defaultReplicaSet.topology;
    for (var node in topology) {
        var nodeInfo = topology[node];
        print("节点: " + node);
        print("  状态: " + nodeInfo.status);
        print("  模式: " + nodeInfo.mode);
        print("  角色: " + nodeInfo.role);
        
        if (nodeInfo.status !== "ONLINE") {
            print("  ⚠️  警告: 节点状态异常!");
        }
    }
}

// 执行检查
checkClusterHealth();
```

---

## 7. 🔄 成员视图变更处理


### 7.1 什么是成员视图变更


**成员视图变更的含义**：
```
成员视图 = 集群对当前所有成员节点的认知状态
视图变更 = 当集群成员发生变化时，更新这个认知状态

常见的视图变更：
• 新节点加入集群
• 现有节点离开集群  
• 节点角色发生变化
• 网络分区导致的成员状态变化
```

### 7.2 视图变更的监控


**监控视图变更**：
```javascript
// 查看集群事件日志
cluster.status({extended: 2});

// 在MySQL中查看Group Replication日志
\sql SELECT * FROM performance_schema.replication_group_member_stats;
\sql SELECT * FROM performance_schema.replication_group_members;
```

**理解输出信息**：
```sql
-- 成员状态表
SELECT 
    MEMBER_ID,
    MEMBER_HOST, 
    MEMBER_PORT,
    MEMBER_STATE,           -- 成员状态
    MEMBER_ROLE             -- 成员角色 (PRIMARY/SECONDARY)
FROM performance_schema.replication_group_members;

-- 输出示例：
-- MEMBER_STATE: ONLINE/OFFLINE/RECOVERING/UNREACHABLE/ERROR
-- MEMBER_ROLE: PRIMARY/SECONDARY
```

### 7.3 处理异常的视图变更


**脑裂问题处理**：
```javascript
// 当出现脑裂（多个节点都认为自己是主节点）时
// 第1步：停止所有节点的Group Replication
\sql STOP GROUP_REPLICATION;

// 第2步：选择数据最新的节点作为引导节点
\sql SET GLOBAL group_replication_bootstrap_group=ON;
\sql START GROUP_REPLICATION;
\sql SET GLOBAL group_replication_bootstrap_group=OFF;

// 第3步：其他节点重新加入
cluster.rejoinInstance('other-node:3306');
```

---

## 8. ✅ 角色变更验证与故障排除


### 8.1 角色变更验证


**验证主节点切换是否成功**：
```javascript
// 第1步：检查集群状态
var status = cluster.status();
print("当前主节点信息：");

// 第2步：找出主节点
var topology = status.defaultReplicaSet.topology;
for (var node in topology) {
    if (topology[node].mode === "R/W") {
        print("主节点: " + node);
        print("状态: " + topology[node].status);
    }
}

// 第3步：测试写操作
\connect primary-node:3306
\sql CREATE DATABASE test_write_access;
\sql DROP DATABASE test_write_access;
// 如果成功，说明主节点切换正常
```

### 8.2 常见问题排除


**🔧 问题1：节点无法重新加入**
```javascript
// 排查步骤：
// 1. 检查网络连接
\connect problem-node:3306

// 2. 检查Group Replication状态  
\sql SHOW VARIABLES LIKE 'group_replication%';

// 3. 检查错误日志
\sql SHOW GLOBAL STATUS LIKE 'group_replication%';

// 4. 重置Group Replication配置
\sql STOP GROUP_REPLICATION;
\sql RESET MASTER;
\sql RESET SLAVE;

// 5. 重新加入
cluster.rejoinInstance('problem-node:3306');
```

**🔧 问题2：主节点切换失败**
```javascript
// 可能原因和解决方法：

// 原因1：目标节点数据不是最新
// 解决：等待数据同步完成后再切换
\sql SELECT * FROM performance_schema.replication_group_member_stats;

// 原因2：网络分区问题
// 解决：检查网络连接，确保所有节点互通

// 原因3：集群状态异常
// 解决：先修复集群状态，再进行切换
cluster.rescan();  // 重新扫描集群拓扑
```

### 8.3 角色变更最佳实践


**🎯 安全的角色变更流程**：

```markdown
变更前检查：
- [ ] 确认所有节点状态正常 (ONLINE)
- [ ] 检查数据同步延迟是否在可接受范围内
- [ ] 验证目标节点的硬件资源充足
- [ ] 确保网络连接稳定

执行变更：  
- [ ] 在低峰期执行切换操作
- [ ] 使用 cluster.setPrimaryInstance() 进行切换
- [ ] 实时监控切换过程的状态变化

变更后验证：
- [ ] 确认新主节点处于 R/W 模式
- [ ] 测试应用程序的读写功能正常
- [ ] 检查所有从节点的数据同步状态
- [ ] 更新应用程序的数据库连接配置
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 集群成员管理：对MySQL InnoDB Cluster中各节点的状态和角色进行管理
🔸 cluster.describe()：查看集群基本信息和成员列表的命令
🔸 cluster.rejoinInstance()：让离线节点重新加入集群的操作
🔸 主节点切换：将主要的写操作节点角色转移到其他节点
🔸 成员权重：影响主节点选举优先级的数值配置
🔸 节点状态：ONLINE、OFFLINE、RECOVERING等状态的含义
🔸 视图变更：集群成员状态发生变化时的更新过程
```

### 9.2 关键理解要点


**🔹 集群成员管理的本质**
```
核心目的：
• 保证集群的高可用性
• 确保数据的一致性和完整性  
• 优化集群的性能表现
• 及时响应和处理故障

管理范围：
• 节点的加入和退出
• 角色的分配和切换
• 状态的监控和维护
• 权重的配置和调整
```

**🔹 状态监控的重要性**
```
为什么要持续监控：
• 及早发现潜在问题
• 预防故障扩散
• 优化集群性能
• 确保服务可用性

监控的关键指标：
• 节点在线状态
• 数据同步延迟
• 网络连接质量
• 系统资源使用情况
```

### 9.3 实际应用指导


**🎯 日常运维建议**

```
定期检查任务：
• 每日：检查集群整体状态 cluster.status()
• 每周：检查节点权重配置是否合理
• 每月：进行主节点切换测试
• 每季度：全面检查集群配置和性能

故障响应流程：
1. 立即检查集群状态，确定影响范围
2. 尝试重新加入离线节点 
3. 如果重新加入失败，分析根本原因
4. 根据业务需要决定是否进行主节点切换
5. 修复问题后验证集群功能正常

预防性措施：
• 设置合理的成员权重
• 建立监控告警机制
• 定期备份集群配置
• 制定详细的故障处理预案
```

**🔧 操作最佳实践**

```
安全操作原则：
• 在低峰期进行重要变更
• 变更前做好完整备份
• 逐步验证每个操作结果
• 保持详细的操作记录

性能优化建议：
• 根据硬件性能设置权重
• 合理分配读写负载
• 定期检查网络延迟
• 监控系统资源使用率

故障预防措施：
• 建立冗余的网络连接
• 配置合适的超时参数
• 定期测试故障切换流程
• 保持软件版本的一致性
```

### 9.4 实际价值体现


- **高可用保障**：通过成员管理确保集群24/7稳定运行
- **性能优化**：通过权重调整和角色管理优化资源利用
- **故障恢复**：快速识别和修复集群中的问题节点
- **运维效率**：自动化的状态监控和故障处理流程

**核心记忆口诀**：
- 集群成员要管好，状态监控不能少
- 权重设置要合理，主从切换要稳妥  
- 离线重联有方法，故障排查有步骤
- 验证测试要到位，预防措施要做好