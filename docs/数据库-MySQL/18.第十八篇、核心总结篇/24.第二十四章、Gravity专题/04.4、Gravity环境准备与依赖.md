---
title: 4、Gravity环境准备与依赖
---
## 📚 目录

1. [Gravity环境准备概述](#1-gravity环境准备概述)
2. [系统环境要求](#2-系统环境要求)
3. [Go语言环境配置](#3-go语言环境配置)
4. [MySQL版本兼容性](#4-mysql版本兼容性)
5. [依赖包安装](#5-依赖包安装)
6. [网络环境要求](#6-网络环境要求)
7. [磁盘空间规划](#7-磁盘空间规划)
8. [内存资源配置](#8-内存资源配置)
9. [权限准备](#9-权限准备)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 Gravity环境准备概述


### 1.1 什么是Gravity


**🔸 核心定义**
```
Gravity：摩拜单车开源的MySQL数据同步工具
目标：实现MySQL数据库之间的实时数据同步
特点：高性能、低延迟、可靠的数据传输
应用场景：数据备份、读写分离、多活架构
```

**💡 为什么需要环境准备**
```
环境准备的重要性：
🔸 确保Gravity能正常运行
🔸 避免运行时出现兼容性问题
🔸 保证数据同步的稳定性和性能
🔸 满足生产环境的可靠性要求

准备不充分的后果：
❌ 同步中断，数据丢失
❌ 性能瓶颈，延迟增加
❌ 兼容性问题，功能异常
❌ 资源不足，系统崩溃
```

### 1.2 环境准备检查清单


**📋 准备工作概览**
```
✅ 系统环境：Linux/macOS，内核版本检查
✅ Go环境：版本1.16+，环境变量配置
✅ MySQL：版本5.7+，binlog开启
✅ 依赖包：Git、Make、网络库等
✅ 网络：端口开放，防火墙配置
✅ 存储：日志空间，数据缓存空间
✅ 内存：根据数据量配置合适内存
✅ 权限：数据库用户权限，系统用户权限
```

---

## 2. 🖥️ 系统环境要求


### 2.1 操作系统支持


**🔸 推荐操作系统**
```
Linux发行版（推荐）：
• CentOS 7.0+ / RHEL 7.0+
• Ubuntu 18.04+ / Debian 9+
• Amazon Linux 2
• 其他主流Linux发行版

macOS（开发测试）：
• macOS 10.14+
• 主要用于本地开发和测试

不支持的系统：
❌ Windows（官方不支持）
❌ 过老的Linux版本（如CentOS 6.x）
```

**💻 系统架构要求**
```
CPU架构：
✅ x86_64（主流服务器架构）
✅ ARM64（部分云服务器支持）
❌ 32位系统不推荐

最低配置：
CPU：2核心
内存：4GB
磁盘：20GB可用空间
网络：千兆网卡
```

### 2.2 内核版本要求


**🔧 内核版本检查**
```bash
# 查看当前内核版本
uname -r

# 推荐内核版本
Linux内核 3.10+ （最低要求）
Linux内核 4.0+  （推荐版本）
Linux内核 5.0+  （最佳性能）
```

**⚠️ 内核兼容性说明**
```
为什么需要较新内核：
• 更好的网络性能优化
• 改进的内存管理机制
• 更稳定的文件系统支持
• 更完善的容器化支持

检查命令：
cat /etc/os-release  # 查看系统版本
cat /proc/version    # 查看详细版本信息
```

---

## 3. 🔧 Go语言环境配置


### 3.1 Go版本要求


**🎯 版本兼容性**
```
支持的Go版本：
✅ Go 1.16+  （最低要求）
✅ Go 1.18+  （推荐版本）
✅ Go 1.19+  （最新稳定版）

不支持的版本：
❌ Go 1.15及以下（语法和包管理问题）
❌ Go 2.0+（未来版本，兼容性未知）
```

**📦 Go安装方法**

**方法1：官方安装包（推荐）**
```bash
# 下载官方安装包
wget https://golang.org/dl/go1.19.linux-amd64.tar.gz

# 解压到系统目录
sudo tar -C /usr/local -xzf go1.19.linux-amd64.tar.gz

# 验证安装
/usr/local/go/bin/go version
```

**方法2：包管理器安装**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install golang-go

# CentOS/RHEL
sudo yum install golang
# 或使用dnf (较新版本)
sudo dnf install golang

# macOS
brew install go
```

### 3.2 环境变量配置


**🔸 必需的环境变量**
```bash
# 编辑profile文件
vim ~/.bashrc
# 或者 vim ~/.bash_profile

# 添加Go环境变量
export GOROOT=/usr/local/go          # Go安装目录
export GOPATH=$HOME/go               # Go工作空间
export PATH=$PATH:$GOROOT/bin:$GOPATH/bin

# 模块代理设置（可选，加速下载）
export GOPROXY=https://goproxy.cn,direct
export GOSUMDB=sum.golang.google.cn
```

**✅ 环境验证**
```bash
# 重新加载环境变量
source ~/.bashrc

# 验证Go环境
go version                    # 查看Go版本
go env GOROOT                # 查看Go安装路径
go env GOPATH                # 查看工作空间路径
go env GOPROXY               # 查看代理设置
```

### 3.3 Go模块支持


**📋 模块模式说明**
```
Go Module（推荐）：
• Go 1.16+默认启用
• 更好的依赖管理
• 版本控制支持

检查模块支持：
go env GO111MODULE  # 应该返回 "on" 或为空
```

---

## 4. 🗄️ MySQL版本兼容性


### 4.1 支持的MySQL版本


**✅ 兼容版本列表**
```
MySQL官方版本：
• MySQL 5.7.x （最低支持版本）
• MySQL 8.0.x （推荐版本）

MySQL分支版本：
• Percona Server 5.7+
• MariaDB 10.2+（基本兼容）

云数据库：
• AWS RDS MySQL
• 阿里云RDS MySQL  
• 腾讯云CDB MySQL
• Google Cloud SQL MySQL
```

**❌ 不支持的版本**
```
过老版本：
❌ MySQL 5.6及以下（binlog格式不兼容）
❌ MySQL 4.x（功能严重缺失）

非MySQL数据库：
❌ PostgreSQL（不同的数据库系统）
❌ Oracle（商业数据库，协议不同）
❌ SQL Server（微软数据库）
```

### 4.2 MySQL配置要求


**🔧 必需的配置项**
```ini
# MySQL配置文件 /etc/my.cnf 或 /etc/mysql/my.cnf

[mysqld]
# 开启binlog（必需）
log-bin=mysql-bin
binlog-format=ROW              # 必须是ROW格式
binlog-row-image=FULL          # 完整行镜像

# 服务器ID（必需，主从复制用）
server-id=1                    # 每个MySQL实例必须唯一

# 其他推荐配置
max_binlog_size=1G             # binlog文件大小
expire_logs_days=7             # binlog保留天数
sync_binlog=1                  # 安全刷盘
innodb_flush_log_at_trx_commit=1  # 事务安全
```

**⚠️ 配置验证命令**
```sql
-- 检查binlog是否开启
SHOW VARIABLES LIKE 'log_bin';

-- 检查binlog格式
SHOW VARIABLES LIKE 'binlog_format';

-- 检查服务器ID
SHOW VARIABLES LIKE 'server_id';

-- 查看binlog文件
SHOW BINARY LOGS;
```

### 4.3 用户权限要求


**👤 数据库用户权限**
```sql
-- 创建Gravity专用用户
CREATE USER 'gravity'@'%' IDENTIFIED BY 'strong_password';

-- 授予必需权限
GRANT SELECT ON *.* TO 'gravity'@'%';           -- 读取数据
GRANT REPLICATION SLAVE ON *.* TO 'gravity'@'%'; -- 读取binlog
GRANT REPLICATION CLIENT ON *.* TO 'gravity'@'%'; -- 获取主库信息

-- 如果需要写入目标库
GRANT INSERT, UPDATE, DELETE ON target_db.* TO 'gravity'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

---

## 5. 📦 依赖包安装


### 5.1 基础系统依赖


**🔸 必需的系统工具**
```bash
# CentOS/RHEL
sudo yum install -y git make gcc wget curl

# Ubuntu/Debian  
sudo apt update
sudo apt install -y git make gcc wget curl

# macOS
# 如果没有安装Xcode Command Line Tools
xcode-select --install
```

**📋 依赖说明**
```
Git：版本控制，下载源码
Make：构建工具，编译Gravity
GCC：C编译器，编译CGO依赖
Wget/Curl：下载工具，获取依赖包
```

### 5.2 Go语言依赖包


**📥 核心依赖库**
```bash
# Gravity会自动管理Go依赖，主要包括：
go.mod 文件中的依赖：
• github.com/go-sql-driver/mysql  # MySQL驱动
• github.com/golang/protobuf      # 协议缓冲区
• github.com/sirupsen/logrus      # 日志库
• github.com/spf13/cobra          # 命令行工具
• github.com/BurntSushi/toml      # 配置文件解析
```

**🔄 依赖更新命令**
```bash
# 在Gravity项目目录下执行
go mod download    # 下载依赖
go mod tidy        # 清理不需要的依赖
go mod verify      # 验证依赖完整性
```

### 5.3 可选优化工具


**⚡ 性能监控工具**
```bash
# 系统监控
sudo yum install -y htop iotop nethogs  # CentOS
sudo apt install -y htop iotop nethogs  # Ubuntu

# 网络工具
sudo yum install -y tcpdump wireshark-cli
sudo apt install -y tcpdump tshark
```

---

## 6. 🌐 网络环境要求


### 6.1 端口要求


**🔌 必需开放的端口**
```
MySQL端口：
• 3306 （默认MySQL端口）
• 自定义端口（如果MySQL使用非标准端口）

Gravity管理端口：
• 8080 （默认Web管理界面）
• 可在配置文件中自定义

监控端口（可选）：
• 9090 （Prometheus metrics）
• 自定义监控端口
```

**🔥 防火墙配置**
```bash
# CentOS 7+ (firewalld)
sudo firewall-cmd --permanent --add-port=3306/tcp
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload

# Ubuntu (ufw)
sudo ufw allow 3306/tcp
sudo ufw allow 8080/tcp
sudo ufw reload

# 传统iptables
sudo iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
```

### 6.2 网络连通性


**📡 连接测试**
```bash
# 测试MySQL连接
telnet mysql_host 3306
# 或使用nc
nc -zv mysql_host 3306

# 测试网络延迟
ping mysql_host

# 测试带宽（可选）
iperf3 -c mysql_host  # 需要对方也运行iperf3服务
```

**⚠️ 网络要求说明**
```
延迟要求：
• 内网环境：< 1ms （最佳）
• 同城机房：< 10ms （可接受）
• 跨城连接：< 50ms （需谨慎）

带宽要求：
• 最低：10Mbps
• 推荐：100Mbps+
• 高负载：1Gbps+

稳定性要求：
• 丢包率：< 0.1%
• 连接稳定：支持长连接
```

---

## 7. 💾 磁盘空间规划


### 7.1 存储空间需求


**📊 空间计算公式**
```
总空间需求 = 程序空间 + 日志空间 + 缓存空间 + 临时空间

程序空间：50MB （Gravity二进制文件）
日志空间：10GB+ （根据保留策略）
缓存空间：数据量的 5-10% （内存不足时的缓存）
临时空间：2GB+ （故障恢复、数据重传）
```

**💡 实际规划建议**
```
小规模环境（< 100GB数据）：
总空间：20GB
日志：5GB
缓存：2GB
临时：1GB

中等规模（100GB - 1TB数据）：
总空间：100GB  
日志：30GB
缓存：20GB
临时：10GB

大规模环境（> 1TB数据）：
总空间：500GB+
日志：200GB+
缓存：100GB+
临时：50GB+
```

### 7.2 磁盘性能要求


**⚡ I/O性能建议**
```
磁盘类型优先级：
1. NVMe SSD （最佳性能）
2. SATA SSD （推荐）
3. SAS 硬盘 （可接受）
4. SATA 硬盘 （最低要求）

IOPS要求：
• 最低：1000 IOPS
• 推荐：5000+ IOPS  
• 高负载：10000+ IOPS

延迟要求：
• SSD：< 1ms
• 机械硬盘：< 10ms
```

**🔧 磁盘测试命令**
```bash
# 测试写入性能
dd if=/dev/zero of=/path/test.img bs=1G count=1 oflag=direct

# 测试读取性能  
dd if=/path/test.img of=/dev/null bs=1G count=1 iflag=direct

# 使用fio进行详细测试（需要安装fio）
sudo yum install fio  # CentOS
sudo apt install fio  # Ubuntu

fio -filename=/path/test -direct=1 -iodepth 1 -thread -rw=write -ioengine=psync -bs=4k -size=2G -numjobs=1 -runtime=60 -group_reporting -name=test
```

---

## 8. 🧠 内存资源配置


### 8.1 内存需求估算


**📊 内存使用分析**
```
Gravity内存使用构成：
• 程序运行：200MB （基础内存）
• 连接池：每个连接 2MB
• 数据缓冲：取决于同步量
• 日志缓冲：100MB
• 系统缓存：建议预留 50%

内存计算公式：
总内存 = 基础内存 + (连接数 × 2MB) + 数据缓冲 + 系统预留
```

**💾 不同负载的内存建议**
```
轻量级负载：
• 数据量：< 10GB
• 内存需求：2GB
• 说明：小型应用，数据变化不频繁

中等负载：
• 数据量：10GB - 100GB  
• 内存需求：8GB
• 说明：中型应用，正常业务负载

重负载：
• 数据量：> 100GB
• 内存需求：16GB+
• 说明：大型应用，高并发写入
```

### 8.2 内存优化配置


**⚙️ 系统级内存优化**
```bash
# 查看当前内存使用
free -h
cat /proc/meminfo

# 优化内存参数（添加到 /etc/sysctl.conf）
vm.swappiness=10              # 减少swap使用
vm.dirty_ratio=15             # 控制脏页比例
vm.dirty_background_ratio=5   # 后台写入阈值
net.core.rmem_max=134217728   # 网络接收缓冲区
net.core.wmem_max=134217728   # 网络发送缓冲区

# 应用配置
sudo sysctl -p
```

**📈 内存监控命令**
```bash
# 实时内存监控
top -p $(pidof gravity)  # 监控Gravity进程
htop                     # 更直观的监控界面

# 内存详细分析
cat /proc/$(pidof gravity)/status | grep -i mem
cat /proc/$(pidof gravity)/smaps | grep -i rss
```

---

## 9. 🔐 权限准备


### 9.1 系统用户权限


**👤 运行用户配置**
```bash
# 创建专用用户（推荐）
sudo useradd -r -s /bin/bash gravity
sudo mkdir -p /home/gravity
sudo chown gravity:gravity /home/gravity

# 或使用现有用户
# 确保用户有足够权限访问：
# - Gravity程序文件
# - 配置文件目录
# - 日志文件目录
# - 临时文件目录
```

**📁 文件权限设置**
```bash
# 设置程序权限
chmod +x /path/to/gravity
chown gravity:gravity /path/to/gravity

# 设置配置文件权限
chmod 640 /etc/gravity/config.toml
chown gravity:gravity /etc/gravity/config.toml

# 设置日志目录权限
mkdir -p /var/log/gravity
chown -R gravity:gravity /var/log/gravity
chmod 755 /var/log/gravity
```

### 9.2 数据库权限详解


**🗄️ 源数据库权限（只读）**
```sql
-- 创建只读用户
CREATE USER 'gravity_reader'@'gravity_host' IDENTIFIED BY 'secure_password';

-- 基础读取权限
GRANT SELECT ON source_db.* TO 'gravity_reader'@'gravity_host';

-- binlog读取权限（必需）
GRANT REPLICATION SLAVE ON *.* TO 'gravity_reader'@'gravity_host';
GRANT REPLICATION CLIENT ON *.* TO 'gravity_reader'@'gravity_host';

-- 查看权限验证
SHOW GRANTS FOR 'gravity_reader'@'gravity_host';
```

**🎯 目标数据库权限（读写）**
```sql
-- 创建写入用户
CREATE USER 'gravity_writer'@'gravity_host' IDENTIFIED BY 'secure_password';

-- 写入权限
GRANT SELECT, INSERT, UPDATE, DELETE ON target_db.* TO 'gravity_writer'@'gravity_host';

-- 可选：DDL权限（如果需要同步表结构变更）
GRANT CREATE, DROP, ALTER ON target_db.* TO 'gravity_writer'@'gravity_host';

-- 应用权限
FLUSH PRIVILEGES;
```

### 9.3 网络访问权限


**🌐 网络白名单配置**
```bash
# MySQL访问控制
# 在MySQL中限制访问来源
CREATE USER 'gravity'@'192.168.1.100' IDENTIFIED BY 'password';  # 具体IP
CREATE USER 'gravity'@'192.168.1.%' IDENTIFIED BY 'password';    # 网段
CREATE USER 'gravity'@'%.company.com' IDENTIFIED BY 'password';   # 域名

# 系统防火墙规则
# 只允许特定IP访问MySQL
sudo iptables -A INPUT -p tcp -s 192.168.1.100 --dport 3306 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 3306 -j DROP
```

---

## 10. 📋 核心要点总结


### 10.1 必须完成的准备工作


```
🔸 系统环境：Linux/macOS，内核3.10+，架构x86_64
🔸 Go环境：版本1.16+，正确配置GOROOT和GOPATH
🔸 MySQL：版本5.7+，开启ROW格式binlog，配置server-id
🔸 网络：开放3306和8080端口，确保连通性
🔸 存储：至少20GB空间，SSD优先
🔸 内存：最低2GB，推荐8GB+
🔸 权限：数据库用户权限，系统文件权限
```

### 10.2 关键配置检查


**✅ 环境验证清单**
```bash
# 1. 系统检查
uname -a                    # 系统信息
free -h                     # 内存检查
df -h                       # 磁盘空间

# 2. Go环境检查  
go version                  # Go版本
go env GOROOT GOPATH        # 环境变量

# 3. MySQL检查
mysql -u gravity -p -e "SELECT $$version, $$log_bin, $$binlog_format, $$server_id;"

# 4. 网络检查
telnet mysql_host 3306      # 连接测试
```

### 10.3 常见问题预防


**🚨 环境准备常见坑点**
```
Go环境问题：
❌ GOPATH未设置或设置错误
❌ Go版本过低，模块支持不完整
❌ 网络代理问题，依赖下载失败

MySQL配置问题：
❌ binlog未开启或格式错误
❌ 用户权限不足，无法读取binlog
❌ 字符集不一致，数据同步异常

系统资源问题：
❌ 磁盘空间不足，日志堆积
❌ 内存不够，进程被kill
❌ 网络不通，连接超时
```

### 10.4 最佳实践建议


**🎯 生产环境建议**
```
资源规划：
• 按数据量的2倍预留磁盘空间
• 内存配置建议为数据缓冲的3倍
• 网络带宽预留50%余量

安全配置：
• 使用专用数据库用户，最小权限原则
• 定期更换数据库密码
• 启用SSL连接（如果需要）

监控告警：
• 设置磁盘空间告警（80%使用率）
• 配置内存使用监控
• 监控网络连接状态
```

**核心记忆**：
- 环境准备是Gravity稳定运行的基础
- Go 1.16+、MySQL 5.7+、足够的资源是最低要求
- 权限配置要遵循最小权限原则
- 生产环境要考虑资源冗余和监控告警