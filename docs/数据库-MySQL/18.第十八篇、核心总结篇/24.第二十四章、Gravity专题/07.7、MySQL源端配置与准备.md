---
title: 7、MySQL源端配置与准备
---
## 📚 目录

1. [Gravity工具概述](#1-gravity工具概述)
2. [binlog配置要求](#2-binlog配置要求)
3. [用户权限配置](#3-用户权限配置)
4. [复制用户创建](#4-复制用户创建)
5. [GTID模式配置](#5-gtid模式配置)
6. [字符集配置](#6-字符集配置)
7. [时区设置](#7-时区设置)
8. [网络访问配置](#8-网络访问配置)
9. [安全连接配置](#9-安全连接配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🚀 Gravity工具概述


### 1.1 什么是Gravity


**定义**：Gravity是摩拜单车开源的MySQL数据同步工具，专门用于**实时同步**MySQL数据到其他存储系统。

```
数据同步流程：
MySQL源库 → Gravity工具 → 目标存储系统
   ↓             ↓            ↓
 binlog      解析转换      Kafka/ES等
```

**🎯 核心功能**：
- **实时数据同步**：基于MySQL binlog实现毫秒级数据同步
- **多目标支持**：可同步到Kafka、Elasticsearch、MongoDB等
- **高可用性**：支持集群部署，自动故障转移
- **数据转换**：支持数据格式转换和过滤

### 1.2 工作原理


```
Gravity工作原理图：
    
    MySQL主库                  Gravity集群                目标系统
   ┌─────────┐               ┌──────────────┐           ┌─────────┐
   │ binlog  │──读取binlog──→│  解析模块    │──转换──→  │ Kafka   │
   │ 数据变更 │               │  过滤模块    │           │ ES      │
   │ DML/DDL │               │  路由模块    │           │ MongoDB │
   └─────────┘               └──────────────┘           └─────────┘
                                     │
                                ┌────┴────┐
                                │ 元数据存储 │
                                │ (位点信息) │
                                └─────────┘
```

**⚡ 关键特点**：
- **准实时性**：延迟通常在毫秒到秒级
- **可靠性**：支持断点续传，不丢失数据
- **扩展性**：插件化架构，易于扩展新的目标系统

---

## 2. 📊 binlog配置要求


### 2.1 什么是binlog


> 💡 **通俗解释**：binlog（Binary Log）是MySQL的**"变更日记本"**，记录了所有对数据库的修改操作。就像银行流水账一样，记录每一笔交易。

**🔍 binlog的作用**：
- **数据恢复**：可以通过binlog恢复数据到任意时间点
- **主从复制**：从库通过读取主库binlog保持数据同步
- **数据同步**：Gravity等工具通过解析binlog实现数据同步

### 2.2 必要的binlog配置


**📝 配置文件位置**：`/etc/mysql/mysql.conf.d/mysqld.cnf`或`/etc/my.cnf`

```ini
[mysqld]
# 1. 启用binlog（必须）
log-bin = mysql-bin
server-id = 1

# 2. binlog格式配置（关键）
binlog-format = ROW

# 3. binlog文件设置
max_binlog_size = 100M
expire_logs_days = 7
binlog-do-db = your_database_name

# 4. 其他重要配置
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1
```

### 2.3 配置项详细说明


| 配置项 | **作用说明** | **推荐值** | **重要性** |
|--------|-------------|-----------|-----------|
| `log-bin` | **启用binlog**，指定binlog文件前缀 | `mysql-bin` | 🔥 **必须** |
| `server-id` | **唯一服务器标识**，主从复制必需 | `1`（唯一数字） | 🔥 **必须** |
| `binlog-format` | **binlog记录格式** | `ROW` | 🔥 **必须** |
| `max_binlog_size` | **单个binlog文件最大大小** | `100M-1G` | ⚠️ **重要** |
| `expire_logs_days` | **binlog保留天数** | `7-30天` | ⚠️ **重要** |

### 2.4 binlog格式选择


**🔸 ROW格式**（**推荐**）：
```sql
-- 原SQL：UPDATE users SET age = age + 1 WHERE city = 'Beijing'
-- ROW格式记录：每一行的具体变更
-- 优点：记录精确，支持所有SQL语句
-- 缺点：文件较大
```

**🔸 STATEMENT格式**（**不推荐**）：
```sql
-- 记录原始SQL语句
-- 缺点：某些函数（如NOW()）可能导致主从不一致
```

> ⚠️ **注意**：Gravity工具**强烈推荐使用ROW格式**，因为它提供最准确的数据变更信息。

### 2.5 验证binlog配置


```sql
-- 检查binlog是否启用
SHOW VARIABLES LIKE 'log_bin';
-- 结果应该是：ON

-- 检查binlog格式
SHOW VARIABLES LIKE 'binlog_format';
-- 结果应该是：ROW

-- 查看当前binlog文件
SHOW MASTER STATUS;

-- 查看binlog文件列表
SHOW BINARY LOGS;
```

---

## 3. 🔐 用户权限配置


### 3.1 权限配置原理


> 💡 **通俗解释**：就像给Gravity工具发放**"工作证"**，让它能够**读取binlog**、**查询表结构**、**监控同步状态**等。

**🎯 权限配置目标**：
- 让Gravity能够连接MySQL
- 读取binlog数据
- 查询表结构信息
- 监控复制状态

### 3.2 最小权限原则


```sql
-- 创建专用用户（推荐做法）
CREATE USER 'gravity'@'%' IDENTIFIED BY 'SecurePassword123!';

-- 授予必要权限
GRANT SELECT ON *.* TO 'gravity'@'%';
GRANT REPLICATION SLAVE ON *.* TO 'gravity'@'%';
GRANT REPLICATION CLIENT ON *.* TO 'gravity'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 3.3 权限详细说明


| 权限类型 | **作用说明** | **使用场景** |
|---------|-------------|-------------|
| `SELECT` | **读取表数据**，获取表结构 | 全量同步、表结构查询 |
| `REPLICATION SLAVE` | **读取binlog**文件 | 增量同步的核心权限 |
| `REPLICATION CLIENT` | **查看复制状态** | 监控同步位点、状态 |

### 3.4 权限验证


```sql
-- 验证用户权限
SHOW GRANTS FOR 'gravity'@'%';

-- 测试连接（在Gravity工具服务器上执行）
mysql -h mysql_host -u gravity -p -e "SHOW MASTER STATUS;"
```

> 🔧 **实践建议**：
> - 使用强密码（包含大小写字母、数字、特殊字符）
> - 定期更换密码
> - 限制连接来源IP（将`%`改为具体IP）

---

## 4. 👤 复制用户创建


### 4.1 复制用户的作用


> 💡 **通俗解释**：复制用户就是专门负责**"搬运数据"**的工人，它的工作就是不断地从MySQL的binlog中读取数据变更，然后"搬运"到目标系统。

**🔄 复制用户工作流程**：
```
MySQL binlog → 复制用户读取 → Gravity处理 → 目标系统
     ↓              ↓             ↓          ↓
   数据变更      权限验证      格式转换     数据存储
```

### 4.2 创建复制用户的步骤


**步骤1：规划用户信息**
```bash
# 用户规划
用户名：gravity_repl
密码：Gravity_Repl_2024!
访问范围：指定IP或局域网
```

**步骤2：创建用户**
```sql
-- 方式一：限制特定IP访问（推荐）
CREATE USER 'gravity_repl'@'192.168.1.100' IDENTIFIED BY 'Gravity_Repl_2024!';

-- 方式二：允许局域网访问
CREATE USER 'gravity_repl'@'192.168.1.%' IDENTIFIED BY 'Gravity_Repl_2024!';

-- 方式三：允许任意IP访问（不推荐，仅测试环境）
CREATE USER 'gravity_repl'@'%' IDENTIFIED BY 'Gravity_Repl_2024!';
```

**步骤3：授予权限**
```sql
-- 核心权限授予
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'gravity_repl'@'192.168.1.100';

-- 如果需要读取表结构（建议添加）
GRANT SELECT ON *.* TO 'gravity_repl'@'192.168.1.100';

-- 应用权限
FLUSH PRIVILEGES;
```

### 4.3 用户安全配置


**🔒 密码策略**：
```sql
-- 查看密码策略
SHOW VARIABLES LIKE 'validate_password%';

-- 设置密码策略（如果需要）
SET GLOBAL validate_password.policy = MEDIUM;
SET GLOBAL validate_password.length = 12;
```

**⏰ 用户有效期管理**：
```sql
-- 设置密码过期时间（可选）
ALTER USER 'gravity_repl'@'192.168.1.100' PASSWORD EXPIRE INTERVAL 90 DAY;

-- 查看用户信息
SELECT user, host, password_expired, password_lifetime 
FROM mysql.user 
WHERE user = 'gravity_repl';
```

### 4.4 连接测试


```bash
# 在Gravity服务器上测试连接
mysql -h mysql_server_ip -u gravity_repl -p

# 测试复制权限
mysql -h mysql_server_ip -u gravity_repl -p -e "SHOW MASTER STATUS;"
mysql -h mysql_server_ip -u gravity_repl -p -e "SHOW SLAVE STATUS;"
```

---

## 5. 🔄 GTID模式配置


### 5.1 什么是GTID


> 💡 **通俗解释**：GTID（Global Transaction Identifier）就像给每个数据库事务发放的**"全球身份证号"**，无论在哪个MySQL服务器上，这个号码都是唯一的。

**🎯 GTID的优势**：
- **全局唯一**：每个事务都有唯一标识
- **自动故障转移**：主库故障时，从库可以自动找到正确的同步位置
- **简化运维**：不需要手动指定binlog文件名和位置

### 5.2 GTID工作原理


```
GTID组成结构：
server_uuid:transaction_id

示例：
3E11FA47-71CA-11E1-9E33-C80AA9429562:1-5

解释：
├─ 3E11FA47-71CA-11E1-9E33-C80AA9429562  ← 服务器UUID
└─ 1-5                                   ← 事务序号范围（1,2,3,4,5）
```

### 5.3 启用GTID配置


**📝 配置文件修改**：
```ini
[mysqld]
# GTID相关配置
gtid-mode = ON                          # 启用GTID模式
enforce-gtid-consistency = ON           # 强制GTID一致性
log-slave-updates = ON                  # 从库也记录binlog（集群环境必需）

# binlog相关（与GTID配合）
log-bin = mysql-bin
binlog-format = ROW
server-id = 1                          # 确保每个服务器ID唯一
```

**🔄 在线启用GTID**（MySQL 5.7.6+）：
```sql
-- 步骤1：设置只读模式
SET $$GLOBAL.READ_ONLY = ON;

-- 步骤2：等待所有事务完成
-- 确保 SHOW PROCESSLIST; 中没有活跃的更新事务

-- 步骤3：启用GTID一致性检查
SET $$GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN;
-- 观察错误日志，确保没有警告

SET $$GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;

-- 步骤4：启用GTID模式
SET $$GLOBAL.GTID_MODE = OFF_PERMISSIVE;
SET $$GLOBAL.GTID_MODE = ON_PERMISSIVE;
SET $$GLOBAL.GTID_MODE = ON;

-- 步骤5：恢复写入
SET $$GLOBAL.READ_ONLY = OFF;
```

### 5.4 GTID状态验证


```sql
-- 检查GTID配置
SHOW VARIABLES LIKE 'gtid_mode';
SHOW VARIABLES LIKE 'enforce_gtid_consistency';

-- 查看GTID执行情况
SHOW MASTER STATUS;
-- 会显示 Executed_Gtid_Set 字段

-- 查看GTID详细信息
SELECT $$GLOBAL.GTID_EXECUTED;
SELECT $$GLOBAL.GTID_PURGED;
```

### 5.5 Gravity中GTID的优势


**🚀 对Gravity工具的好处**：

| 传统位点模式 | **GTID模式** |
|-------------|-------------|
| 需要指定binlog文件名和位置 | **自动定位**同步位置 |
| 主库故障切换复杂 | **自动故障转移** |
| 容易出现重复或遗漏 | **严格保证**事务完整性 |
| 运维工作量大 | **运维简化** |

> ⚠️ **注意事项**：
> - GTID模式下不支持某些SQL语句（如CREATE TABLE ... SELECT）
> - 启用后建议不要随意关闭
> - 集群中所有节点都应启用GTID

---

## 6. 🌐 字符集配置


### 6.1 字符集的重要性


> 💡 **通俗解释**：字符集就像**"语言翻译器"**，告诉MySQL如何正确存储和显示中文、英文、特殊符号等字符。配置不当会导致乱码问题。

**🎯 字符集配置目标**：
- 确保中文等多语言字符正确存储
- 避免数据同步过程中的乱码问题
- 保证源库和目标系统字符编码一致

### 6.2 推荐字符集配置


**📝 MySQL配置文件设置**：
```ini
[mysqld]
# 字符集配置（推荐UTF8MB4）
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 初始化连接字符集
init_connect = 'SET NAMES utf8mb4'

[mysql]
# 客户端默认字符集
default-character-set = utf8mb4

[client]
# 客户端连接字符集
default-character-set = utf8mb4
```

### 6.3 字符集选择说明


| 字符集 | **特点** | **适用场景** | **推荐度** |
|--------|---------|-------------|-----------|
| `utf8mb4` | **完整UTF-8**，支持emoji表情 | 现代应用，多语言 | 🔥 **强烈推荐** |
| `utf8` | **UTF-8子集**，不支持4字节字符 | 旧版本兼容 | ⚠️ **不推荐** |
| `latin1` | **单字节**字符集 | 纯英文环境 | ❌ **不推荐** |

> 🔧 **为什么选择utf8mb4**：
> - 支持所有Unicode字符（包括emoji）
> - 向后兼容utf8
> - 现代应用的标准选择

### 6.4 验证字符集配置


```sql
-- 查看服务器字符集配置
SHOW VARIABLES LIKE 'character_set%';
SHOW VARIABLES LIKE 'collation%';

-- 查看数据库字符集
SHOW CREATE DATABASE your_database_name;

-- 查看表字符集
SHOW CREATE TABLE your_table_name;

-- 查看连接字符集
SHOW VARIABLES LIKE 'character_set_connection';
```

### 6.5 修改现有数据库字符集


```sql
-- 修改数据库字符集
ALTER DATABASE your_database_name 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 修改表字符集
ALTER TABLE your_table_name 
CONVERT TO CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 修改特定字段字符集
ALTER TABLE your_table_name 
MODIFY COLUMN your_column VARCHAR(255) 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 6.6 Gravity字符集注意事项


**🔄 同步过程中的字符集处理**：
```yaml
# Gravity配置示例
source:
  type: mysql
  host: localhost
  charset: utf8mb4  # 确保与MySQL配置一致

target:
  type: kafka
  charset: utf8mb4  # 目标系统字符集配置
```

> ⚠️ **重要提醒**：
> - 源库、Gravity工具、目标系统的字符集配置必须保持一致
> - 修改字符集前务必备份数据
> - 生产环境变更需要在维护窗口进行

---

## 7. ⏰ 时区设置


### 7.1 时区的重要性


> 💡 **通俗解释**：时区就像**"时间标准"**，确保所有系统对同一个时间点的理解是一致的。如果时区不统一，可能导致数据同步时间戳错乱。

**🎯 时区配置目标**：
- 确保数据同步时时间戳准确
- 避免夏令时变更导致的时间混乱
- 保证分布式系统时间一致性

### 7.2 时区配置方式


**📝 MySQL配置文件设置**：
```ini
[mysqld]
# 推荐：使用UTC时区
default-time-zone = '+00:00'

# 或者使用系统时区
# default-time-zone = SYSTEM

# 时区表初始化（重要）
# 需要加载时区数据：mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root mysql
```

**🔧 运行时设置**：
```sql
-- 设置全局时区
SET GLOBAL time_zone = '+00:00';

-- 设置会话时区
SET time_zone = '+00:00';

-- 查看当前时区设置
SELECT $$global.time_zone, $$session.time_zone;

-- 查看当前时间
SELECT NOW(), UTC_TIMESTAMP();
```

### 7.3 时区选择建议


| 时区设置 | **优点** | **缺点** | **适用场景** |
|---------|---------|---------|-------------|
| `UTC (+00:00)` | **标准时间**，无夏令时 | 可能与本地时间不符 | 🔥 **全球化应用** |
| `Asia/Shanghai` | **符合中国时区** | 可能有夏令时历史问题 | 🌏 **中国本土应用** |
| `SYSTEM` | **跟随系统时区** | 系统时区变更影响数据库 | ⚠️ **单机环境** |

> 🔧 **推荐做法**：
> - 数据库统一使用UTC时区
> - 应用层处理时区转换
> - 避免使用本地时区

### 7.4 时区数据初始化


```bash
# Linux系统初始化MySQL时区表
mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql

# 验证时区表是否加载成功
mysql -u root -p -e "SELECT COUNT(*) FROM mysql.time_zone_name;"
```

### 7.5 Gravity时区配置


**🔄 Gravity配置文件示例**：
```yaml
source:
  type: mysql
  host: localhost
  timezone: "UTC"  # 与MySQL时区保持一致

target:
  type: kafka
  timezone: "UTC"  # 目标系统时区配置

# 时间字段处理
transform:
  - type: timestamp
    format: "2006-01-02 15:04:05"
    timezone: "UTC"
```

### 7.6 时区验证和测试


```sql
-- 创建测试表
CREATE TABLE timezone_test (
    id INT AUTO_INCREMENT PRIMARY KEY,
    event_time DATETIME,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入测试数据
INSERT INTO timezone_test (event_time) VALUES ('2024-09-12 10:30:00');

-- 查看结果（注意DATETIME和TIMESTAMP的区别）
SELECT 
    event_time,
    created_at,
    UNIX_TIMESTAMP(event_time) as event_unix,
    UNIX_TIMESTAMP(created_at) as created_unix
FROM timezone_test;
```

> ⚠️ **注意事项**：
> - DATETIME类型不受时区影响
> - TIMESTAMP类型会根据时区自动转换
> - 建议生产环境统一使用UTC时区

---

## 8. 🌐 网络访问配置


### 8.1 网络访问概述


> 💡 **通俗解释**：网络访问配置就像给MySQL**"装门禁系统"**，控制谁能连接、从哪里连接、怎么连接。

**🎯 网络配置目标**：
- 确保Gravity工具能够连接MySQL
- 提供足够的网络带宽支持数据同步
- 保证网络连接的稳定性和安全性

### 8.2 MySQL网络监听配置


**📝 基础网络配置**：
```ini
[mysqld]
# 监听地址配置
bind-address = 0.0.0.0          # 允许所有IP连接（谨慎使用）
# bind-address = 192.168.1.10   # 仅监听特定IP（推荐）

# 端口配置
port = 3306

# 连接数配置
max_connections = 1000          # 最大连接数
max_user_connections = 50       # 单用户最大连接数

# 网络超时配置
wait_timeout = 28800           # 连接超时（8小时）
interactive_timeout = 28800    # 交互超时
net_read_timeout = 60          # 网络读取超时
net_write_timeout = 60         # 网络写入超时
```

### 8.3 防火墙配置


**🔥 Linux防火墙设置**：
```bash
# CentOS/RHEL 使用 firewalld
sudo firewall-cmd --permanent --add-port=3306/tcp
sudo firewall-cmd --reload

# 或者添加服务
sudo firewall-cmd --permanent --add-service=mysql
sudo firewall-cmd --reload

# Ubuntu 使用 ufw
sudo ufw allow 3306/tcp
sudo ufw allow from 192.168.1.0/24 to any port 3306

# 查看防火墙状态
sudo firewall-cmd --list-all  # CentOS
sudo ufw status               # Ubuntu
```

### 8.4 网络性能优化


**⚡ TCP参数优化**：
```bash
# /etc/sysctl.conf 网络参数优化
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# 应用配置
sudo sysctl -p
```

**💾 MySQL网络缓冲区优化**：
```ini
[mysqld]
# 网络缓冲区配置
max_allowed_packet = 64M       # 最大数据包大小
net_buffer_length = 32K        # 网络缓冲区大小

# InnoDB缓冲池（影响网络性能）
innodb_buffer_pool_size = 1G   # 根据内存调整
```

### 8.5 连接测试和验证


**🔍 基础连接测试**：
```bash
# 从Gravity服务器测试MySQL连接
telnet mysql_server_ip 3306

# MySQL客户端连接测试
mysql -h mysql_server_ip -u gravity_user -p

# 查看网络连接状态
netstat -an | grep 3306
ss -tuln | grep 3306
```

**📊 连接状态监控**：
```sql
-- 查看当前连接数
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- 查看连接详情
SHOW PROCESSLIST;

-- 查看网络状态
SHOW STATUS LIKE 'Bytes_%';
SHOW STATUS LIKE 'Com_select';
```

### 8.6 网络故障排查


**🛠️ 常见问题排查**：

```bash
# 1. 检查端口是否开放
nmap -p 3306 mysql_server_ip

# 2. 检查MySQL是否监听
sudo netstat -tlnp | grep 3306

# 3. 检查防火墙规则
sudo iptables -L -n | grep 3306

# 4. 检查DNS解析
nslookup mysql_server_hostname

# 5. 测试网络延迟
ping mysql_server_ip
```

**📋 故障排查清单**：

| 问题现象 | **可能原因** | **解决方案** |
|---------|-------------|-------------|
| 连接被拒绝 | 防火墙阻挡 | 检查防火墙规则 |
| 连接超时 | 网络不通 | 检查网络连通性 |
| 权限拒绝 | 用户权限问题 | 检查用户授权 |
| 连接过多 | 连接数限制 | 增加max_connections |

---

## 9. 🔒 安全连接配置


### 9.1 SSL/TLS加密连接


> 💡 **通俗解释**：SSL加密就像给数据传输**"穿上防护服"**，确保数据在网络传输过程中不被窃听或篡改。

**🛡️ SSL连接的好处**：
- **数据加密**：防止网络窃听
- **身份验证**：确认服务器身份
- **完整性保护**：防止数据篡改
- **合规要求**：满足安全规范

### 9.2 MySQL SSL配置


**📝 生成SSL证书**：
```bash
# 使用MySQL自带工具生成证书
mysql_ssl_rsa_setup --datadir=/var/lib/mysql

# 或者手动生成证书
# 1. 生成CA私钥
openssl genrsa 2048 > ca-key.pem

# 2. 生成CA证书
openssl req -new -x509 -nodes -days 3600 -key ca-key.pem -out ca.pem

# 3. 生成服务器私钥和证书
openssl req -newkey rsa:2048 -days 3600 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 3600 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem
```

**📝 MySQL SSL配置**：
```ini
[mysqld]
# SSL证书配置
ssl-ca = /var/lib/mysql/ca.pem
ssl-cert = /var/lib/mysql/server-cert.pem
ssl-key = /var/lib/mysql/server-key.pem

# SSL配置选项
require_secure_transport = ON   # 强制使用加密连接（可选）
```

### 9.3 用户SSL配置


```sql
-- 创建要求SSL连接的用户
CREATE USER 'gravity_ssl'@'%' 
IDENTIFIED BY 'SecurePassword123!' 
REQUIRE SSL;

-- 或者要求特定证书
CREATE USER 'gravity_cert'@'%' 
IDENTIFIED BY 'SecurePassword123!' 
REQUIRE X509;

-- 授予权限
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* 
TO 'gravity_ssl'@'%';

FLUSH PRIVILEGES;
```

### 9.4 SSL连接验证


```sql
-- 检查SSL状态
SHOW VARIABLES LIKE 'have_ssl';
-- 结果应该是：YES

-- 查看SSL配置
SHOW VARIABLES LIKE 'ssl%';

-- 查看当前连接的SSL状态
SHOW STATUS LIKE 'Ssl%';

-- 查看连接是否使用SSL
SELECT 
    CONNECTION_ID(),
    USER(),
    HOST(),
    CONNECTION_TYPE,
    SSL_VERSION,
    SSL_CIPHER
FROM performance_schema.session_status 
WHERE VARIABLE_NAME = 'Ssl_version';
```

### 9.5 Gravity SSL配置


**🔧 Gravity配置文件**：
```yaml
source:
  type: mysql
  host: mysql_server
  port: 3306
  username: gravity_ssl
  password: SecurePassword123!
  
  # SSL配置
  ssl:
    enabled: true
    ca: "/path/to/ca.pem"
    cert: "/path/to/client-cert.pem"    # 客户端证书（如果需要）
    key: "/path/to/client-key.pem"     # 客户端私钥（如果需要）
    skip_verify: false                 # 是否跳过证书验证（不推荐）
```

### 9.6 网络安全最佳实践


**🔐 访问控制**：
```sql
-- 限制用户访问来源
CREATE USER 'gravity'@'192.168.1.%' IDENTIFIED BY 'SecurePassword123!';

-- 定期审查用户权限
SELECT user, host, authentication_string 
FROM mysql.user 
WHERE user LIKE 'gravity%';
```

**📊 安全监控**：
```sql
-- 开启审计日志（MySQL Enterprise版）
-- 或使用第三方审计工具

-- 监控连接尝试
SHOW STATUS LIKE 'Connection_errors%';

-- 查看失败的登录尝试
SELECT * FROM performance_schema.events_statements_history 
WHERE SQL_TEXT LIKE '%ACCESS DENIED%';
```

**🛡️ 额外安全措施**：

| 安全措施 | **配置方法** | **安全级别** |
|---------|-------------|-------------|
| **IP白名单** | 防火墙 + MySQL用户限制 | 🔥 **高** |
| **VPN连接** | 通过VPN访问数据库 | 🔥 **高** |
| **端口更改** | 修改默认3306端口 | ⚠️ **中** |
| **fail2ban** | 自动封禁暴力破解IP | ⚠️ **中** |

---

## 10. 📋 核心要点总结


### 10.1 必须完成的配置清单


**✅ 基础配置检查表**：

- [ ] **binlog启用**：`log-bin = mysql-bin`
- [ ] **binlog格式**：`binlog-format = ROW`
- [ ] **服务器ID**：`server-id = 唯一数字`
- [ ] **字符集**：`character-set-server = utf8mb4`
- [ ] **时区设置**：`default-time-zone = '+00:00'`

**✅ 用户权限检查表**：

- [ ] **复制用户创建**：具有REPLICATION权限的专用用户
- [ ] **权限验证**：能够执行`SHOW MASTER STATUS`
- [ ] **连接测试**：从Gravity服务器能够成功连接
- [ ] **安全配置**：强密码 + IP限制

**✅ 高级配置检查表**：

- [ ] **GTID启用**：`gtid-mode = ON`（推荐）
- [ ] **SSL配置**：证书配置和用户SSL要求（生产环境）
- [ ] **网络优化**：防火墙 + 性能参数调优
- [ ] **监控配置**：连接数和性能监控

### 10.2 关键配置参数速查


```ini
# MySQL源端核心配置模板
[mysqld]
# binlog配置
log-bin = mysql-bin
server-id = 1
binlog-format = ROW
max_binlog_size = 100M
expire_logs_days = 7

# GTID配置（推荐）
gtid-mode = ON
enforce-gtid-consistency = ON
log-slave-updates = ON

# 字符集和时区
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
default-time-zone = '+00:00'

# 网络和连接
bind-address = 0.0.0.0
max_connections = 1000
max_allowed_packet = 64M

# SSL配置（生产环境）
ssl-ca = /var/lib/mysql/ca.pem
ssl-cert = /var/lib/mysql/server-cert.pem
ssl-key = /var/lib/mysql/server-key.pem
```

### 10.3 常见问题解决


**🔧 问题排查指南**：

| 问题症状 | **可能原因** | **解决方案** |
|---------|-------------|-------------|
| Gravity连接失败 | 网络/权限问题 | 检查防火墙和用户权限 |
| 字符乱码 | 字符集不一致 | 统一使用utf8mb4 |
| 时间戳错误 | 时区配置问题 | 统一使用UTC时区 |
| 同步延迟高 | binlog格式/网络问题 | 使用ROW格式，优化网络 |
| SSL连接失败 | 证书配置错误 | 检查证书路径和权限 |

### 10.4 性能优化建议


**⚡ 关键优化点**：

1. **binlog优化**：
   - 使用SSD存储binlog文件
   - 合理设置`max_binlog_size`
   - 定期清理过期binlog

2. **网络优化**：
   - 使用千兆或万兆网络
   - 优化TCP参数
   - 考虑专用网络连接

3. **资源分配**：
   - 为MySQL分配足够内存
   - 使用高性能存储
   - 监控CPU和IO使用率

### 10.5 安全最佳实践


**🛡️ 安全建议**：

- **最小权限原则**：只授予必要的权限
- **强密码策略**：复杂密码 + 定期更换
- **网络隔离**：使用内网或VPN连接
- **加密传输**：生产环境启用SSL
- **审计监控**：记录和监控数据库访问

> 💡 **记住**：正确的源端配置是Gravity数据同步成功的基础，每一个配置项都影响同步的稳定性和性能。建议在测试环境完全验证配置后再应用到生产环境。