---
title: 14、Gravity服务管理
---
## 📚 目录

1. [Gravity服务概述](#1-gravity服务概述)
2. [服务启动与停止](#2-服务启动与停止)
3. [进程管理详解](#3-进程管理详解)
4. [配置热重载机制](#4-配置热重载机制)
5. [服务状态查询](#5-服务状态查询)
6. [日志管理体系](#6-日志管理体系)
7. [进程监控策略](#7-进程监控策略)
8. [资源使用监控](#8-资源使用监控)
9. [服务健康检查](#9-服务健康检查)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌟 Gravity服务概述


### 1.1 什么是Gravity服务管理


**Gravity服务管理**就是对摩拜单车开源的MySQL同步工具进行运维操作的一套管理体系。

> 💡 **通俗理解**：就像管理一个工厂的生产线一样，需要启动、停止、监控、维护整个数据同步流水线

**核心作用**：
```
数据库A ──[Gravity服务]──> 数据库B
     ↑                       ↑
   监控管理               监控结果
```

### 1.2 服务管理的重要性


**为什么需要服务管理？**

```
没有管理的后果：
❌ 服务崩溃不知道
❌ 数据同步中断
❌ 性能问题无法发现
❌ 故障排查困难

有管理的好处：
✅ 服务状态实时掌控
✅ 问题及时发现处理
✅ 性能优化有据可依
✅ 故障快速定位解决
```

### 1.3 Gravity架构简介


```
┌─────────────────────────────────────────┐
│             Gravity服务架构              │
├─────────────────────────────────────────┤
│  输入端(Input)    │  处理器(Pipeline)     │
│  ┌─────────────┐  │  ┌─────────────────┐ │
│  │ MySQL Binlog │──│  │ 数据转换&过滤    │ │
│  │ 监听器       │  │  │                 │ │
│  └─────────────┘  │  └─────────────────┘ │
├─────────────────────────────────────────┤
│              输出端(Output)               │
│  ┌─────────────────────────────────────┐ │
│  │ MySQL/Kafka/ClickHouse等目标端      │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

---

## 2. 🚀 服务启动与停止


### 2.1 基本启动方式


**最简单的启动方法**：

```bash
# 方式1：直接启动（前台运行）
./gravity --config=config.toml

# 方式2：后台启动
nohup ./gravity --config=config.toml &

# 方式3：使用systemd管理
systemctl start gravity
```

> 💡 **新手提示**：`config.toml`是配置文件，里面写着数据库连接信息、同步规则等

### 2.2 启动参数详解


| 参数 | 说明 | 示例 |
|------|------|------|
| `--config` | **配置文件路径** | `--config=/etc/gravity/config.toml` |
| `--log-level` | **日志级别** | `--log-level=info` |
| `--position-cache` | **位置缓存文件** | `--position-cache=/data/position` |

**配置文件示例**：
```toml
# 基本配置示例
[input]
type = "mysql"
host = "127.0.0.1"
port = 3306
username = "replication_user"
password = "password"

[output]
type = "mysql"
host = "192.168.1.100"
port = 3306
```

### 2.3 优雅停止服务


**什么是优雅停止？**
> 优雅停止就是让服务"有礼貌地"关闭，先处理完手头的工作再退出，不是强行杀死

```bash
# 方式1：发送SIGTERM信号（推荐）
kill -TERM <gravity_pid>

# 方式2：使用systemd
systemctl stop gravity

# 方式3：通过HTTP API（如果启用）
curl -X POST http://localhost:8080/shutdown
```

**停止过程**：
```
1. 接收停止信号
2. 停止接收新的binlog事件
3. 处理完队列中的数据
4. 保存当前位置信息
5. 关闭数据库连接
6. 退出进程
```

### 2.4 强制停止（慎用）


```bash
# 强制杀死进程（不推荐）
kill -9 <gravity_pid>

# 查找并强制停止
pkill -9 gravity
```

> ⚠️ **重要警告**：强制停止可能导致数据丢失或位置信息不准确

---

## 3. 🔧 进程管理详解


### 3.1 进程查看与识别


**查看Gravity进程**：

```bash
# 查看所有Gravity进程
ps aux | grep gravity

# 查看进程详细信息
ps -ef | grep gravity

# 查看进程树
pstree -p | grep gravity
```

**输出示例**：
```
user    12345  0.1  2.3  123456  78901  ?  Sl  10:30  0:05 ./gravity --config=config.toml
```

**字段含义**：
- `12345`：**进程ID(PID)**
- `0.1`：**CPU使用率**
- `2.3`：**内存使用率**
- `Sl`：**进程状态**（S=休眠，l=多线程）

### 3.2 进程状态监控


**进程状态含义**：

| 状态 | 含义 | 说明 |
|------|------|------|
| `R` | **运行中** | 正在执行或等待执行 |
| `S` | **可中断睡眠** | 等待事件完成 |
| `D` | **不可中断睡眠** | 通常在等待I/O |
| `Z` | **僵尸进程** | 已结束但父进程未回收 |
| `T` | **停止** | 被信号停止 |

### 3.3 systemd服务管理


**创建systemd服务文件**：

```ini
# /etc/systemd/system/gravity.service
[Unit]
Description=Gravity MySQL Sync Service
After=network.target mysql.service

[Service]
Type=simple
User=gravity
Group=gravity
WorkingDirectory=/opt/gravity
ExecStart=/opt/gravity/gravity --config=/etc/gravity/config.toml
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

**systemd常用命令**：

```bash
# 启用服务（开机自启）
systemctl enable gravity

# 启动服务
systemctl start gravity

# 查看服务状态
systemctl status gravity

# 重启服务
systemctl restart gravity

# 重新加载配置
systemctl reload gravity

# 查看服务日志
journalctl -u gravity -f
```

### 3.4 进程监控脚本


**简单的进程监控脚本**：

```bash
#!/bin/bash
# gravity_monitor.sh

GRAVITY_PID=$(pgrep -f "gravity --config")

if [ -z "$GRAVITY_PID" ]; then
    echo "[$(date)] Gravity进程未运行，正在重启..."
    systemctl start gravity
else
    echo "[$(date)] Gravity进程运行正常，PID: $GRAVITY_PID"
fi
```

---

## 4. 🔄 配置热重载机制


### 4.1 什么是配置热重载


> 💡 **通俗解释**：热重载就像给汽车加油一样，不用停车熄火，直接加油继续跑

**热重载的好处**：
- ✅ **无需停服**：服务继续运行
- ✅ **配置生效**：新配置立即应用
- ✅ **业务连续**：数据同步不中断

### 4.2 支持热重载的配置项


**可以热重载的配置**：
```toml
# 日志级别
log-level = "debug"

# 同步规则
[filter]
do-dbs = ["db1", "db2"]
ignore-dbs = ["test"]

# 输出配置
[output]
batch-size = 1000
flush-interval = "1s"
```

**不能热重载的配置**：
```toml
# 数据库连接信息
[input]
host = "127.0.0.1"  # 需要重启
port = 3306         # 需要重启
```

### 4.3 热重载操作方法


**方法1：发送SIGHUP信号**
```bash
# 找到进程ID
PID=$(pgrep -f gravity)

# 发送重载信号
kill -HUP $PID
```

**方法2：使用systemd**
```bash
systemctl reload gravity
```

**方法3：HTTP API方式**
```bash
curl -X POST http://localhost:8080/reload
```

### 4.4 重载过程监控


**查看重载日志**：
```bash
# 实时查看日志
tail -f /var/log/gravity/gravity.log | grep -i reload

# 或使用journalctl
journalctl -u gravity -f | grep -i reload
```

**重载成功的日志示例**：
```
2025-09-12 15:30:00 [INFO] 收到配置重载信号
2025-09-12 15:30:01 [INFO] 正在重新加载配置文件
2025-09-12 15:30:01 [INFO] 配置重载完成
```

---

## 5. 📊 服务状态查询


### 5.1 基本状态查询


**查询服务运行状态**：

```bash
# 使用systemctl查询
systemctl status gravity

# 使用ps命令查询
ps aux | grep gravity

# 查询端口占用
netstat -tlnp | grep :8080
```

**状态输出解读**：
```
● gravity.service - Gravity MySQL Sync Service
   Loaded: loaded (/etc/systemd/system/gravity.service; enabled; vendor preset: disabled)
   Active: active (running) since 三 2025-09-12 15:30:00 CST; 2h 5min ago
```

状态说明：
- `loaded`：**服务文件已加载**
- `enabled`：**开机自启已启用**
- `active (running)`：**服务正在运行**

### 5.2 详细状态信息


**通过HTTP API查询**：

```bash
# 查询基本状态
curl http://localhost:8080/status

# 查询同步位置
curl http://localhost:8080/position

# 查询性能指标
curl http://localhost:8080/metrics
```

**状态JSON示例**：
```json
{
  "status": "running",
  "uptime": "2h5m30s",
  "version": "1.0.0",
  "input": {
    "type": "mysql",
    "connected": true,
    "binlog_file": "mysql-bin.000001",
    "binlog_position": 12345
  },
  "output": {
    "type": "mysql", 
    "connected": true,
    "events_sent": 98765
  }
}
```

### 5.3 自定义状态检查脚本


```bash
#!/bin/bash
# check_gravity_status.sh

echo "=== Gravity服务状态检查 ==="

# 检查进程
if pgrep -f gravity > /dev/null; then
    echo "✅ 进程运行正常"
else
    echo "❌ 进程未运行"
    exit 1
fi

# 检查端口
if netstat -tlnp | grep :8080 > /dev/null; then
    echo "✅ 监听端口正常"
else
    echo "⚠️ 监听端口异常"
fi

# 检查API响应
if curl -s http://localhost:8080/status > /dev/null; then
    echo "✅ API响应正常"
else
    echo "❌ API无响应"
fi

echo "检查完成"
```

---

## 6. 📝 日志管理体系


### 6.1 日志级别详解


**Gravity支持的日志级别**：

| 级别 | 含义 | 使用场景 |
|------|------|----------|
| `debug` | **调试信息** | 开发调试时使用 |
| `info` | **一般信息** | 正常运行日志 |
| `warn` | **警告信息** | 潜在问题提示 |
| `error` | **错误信息** | 需要关注的错误 |
| `fatal` | **严重错误** | 导致程序退出 |

> 💡 **经验提示**：生产环境建议使用`info`级别，调试时使用`debug`

### 6.2 日志配置


**配置文件中的日志设置**：
```toml
[log]
level = "info"
file = "/var/log/gravity/gravity.log"
max-size = "100MB"
max-days = 7
compress = true
```

**配置项说明**：
- `level`：**日志级别**
- `file`：**日志文件路径**
- `max-size`：**单个日志文件最大大小**
- `max-days`：**日志保留天数**
- `compress`：**是否压缩旧日志**

### 6.3 日志轮转管理


**使用logrotate管理日志**：

```bash
# /etc/logrotate.d/gravity
/var/log/gravity/gravity.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    postrotate
        /bin/kill -HUP $(cat /var/run/gravity.pid 2>/dev/null) 2>/dev/null || true
    endscript
}
```

**logrotate配置说明**：
- `daily`：**每天轮转**
- `rotate 30`：**保留30天**
- `compress`：**压缩旧日志**
- `postrotate`：**轮转后重新打开日志文件**

### 6.4 日志查看技巧


**常用日志查看命令**：

```bash
# 实时查看日志
tail -f /var/log/gravity/gravity.log

# 查看最近100行
tail -100 /var/log/gravity/gravity.log

# 按时间范围查看
grep "2025-09-12 15:" /var/log/gravity/gravity.log

# 查看错误日志
grep -i error /var/log/gravity/gravity.log

# 统计错误数量
grep -c "ERROR" /var/log/gravity/gravity.log
```

**日志分析示例**：
```bash
# 查看同步延迟情况
grep "lag" /var/log/gravity/gravity.log | tail -10

# 查看连接异常
grep -i "connection" /var/log/gravity/gravity.log | grep -i error

# 统计处理事件数量
grep "events processed" /var/log/gravity/gravity.log | tail -5
```

---

## 7. 👁️ 进程监控策略


### 7.1 基础进程监控


**CPU和内存监控**：

```bash
# 查看进程资源使用
top -p $(pgrep gravity)

# 查看进程详细信息
cat /proc/$(pgrep gravity)/status

# 使用htop查看（更友好）
htop -p $(pgrep gravity)
```

**监控输出解读**：
```
PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
12345 gravity  20   0  234567  45678   1234 S   1.5  2.3   0:15.67 gravity
```

字段含义：
- `%CPU`：**CPU使用率**
- `%MEM`：**内存使用率**
- `VIRT`：**虚拟内存大小**
- `RES`：**物理内存使用**

### 7.2 进程监控脚本


**完整的监控脚本**：

```bash
#!/bin/bash
# gravity_monitor.sh

PROCESS_NAME="gravity"
LOG_FILE="/var/log/gravity_monitor.log"
MAX_CPU=80    # CPU使用率阈值
MAX_MEM=80    # 内存使用率阈值

# 获取进程信息
PID=$(pgrep -f $PROCESS_NAME)

if [ -z "$PID" ]; then
    echo "[$(date)] 错误：$PROCESS_NAME 进程未运行" >> $LOG_FILE
    # 可以在这里添加重启逻辑
    systemctl start gravity
    exit 1
fi

# 获取CPU和内存使用率
CPU_USAGE=$(ps -p $PID -o %cpu --no-headers | awk '{print int($1)}')
MEM_USAGE=$(ps -p $PID -o %mem --no-headers | awk '{print int($1)}')

echo "[$(date)] PID: $PID, CPU: ${CPU_USAGE}%, MEM: ${MEM_USAGE}%" >> $LOG_FILE

# 检查阈值
if [ $CPU_USAGE -gt $MAX_CPU ]; then
    echo "[$(date)] 警告：CPU使用率过高 ${CPU_USAGE}%" >> $LOG_FILE
fi

if [ $MEM_USAGE -gt $MAX_MEM ]; then
    echo "[$(date)] 警告：内存使用率过高 ${MEM_USAGE}%" >> $LOG_FILE
fi
```

### 7.3 自动化监控部署


**使用crontab定时监控**：

```bash
# 编辑crontab
crontab -e

# 添加监控任务（每分钟检查一次）
* * * * * /opt/scripts/gravity_monitor.sh

# 每5分钟检查一次
*/5 * * * * /opt/scripts/gravity_monitor.sh
```

**使用systemd timer**：

```ini
# /etc/systemd/system/gravity-monitor.timer
[Unit]
Description=Gravity Monitor Timer

[Timer]
OnCalendar=*:0/5  # 每5分钟执行
Persistent=true

[Install]
WantedBy=timers.target
```

---

## 8. 📈 资源使用监控


### 8.1 系统资源监控


**CPU监控**：

```bash
# 查看Gravity进程CPU使用
pidstat -p $(pgrep gravity) 1 5

# 查看CPU核心使用情况
mpstat -P ALL 1 5
```

**内存监控**：

```bash
# 查看进程内存详情
pmap -d $(pgrep gravity)

# 查看系统内存状态
free -h

# 查看进程内存映射
cat /proc/$(pgrep gravity)/smaps
```

### 8.2 网络资源监控


**网络连接监控**：

```bash
# 查看Gravity的网络连接
netstat -anp | grep $(pgrep gravity)

# 查看网络流量
iftop -i eth0

# 使用ss命令查看连接
ss -tnp | grep gravity
```

**网络连接状态解读**：
```
tcp  0  0  192.168.1.10:12345  192.168.1.20:3306  ESTABLISHED  12345/gravity
```

- `192.168.1.10:12345`：**本地地址和端口**
- `192.168.1.20:3306`：**远程MySQL地址**
- `ESTABLISHED`：**连接已建立**

### 8.3 磁盘I/O监控


**磁盘使用监控**：

```bash
# 查看磁盘使用率
df -h

# 查看进程I/O统计
pidstat -d -p $(pgrep gravity) 1 5

# 查看系统I/O情况
iostat -x 1 5
```

**I/O监控指标**：
- `kB_rd/s`：**每秒读取KB数**
- `kB_wr/s`：**每秒写入KB数**
- `kB_ccwr/s`：**每秒取消写入KB数**

### 8.4 资源告警设置


**资源使用告警脚本**：

```bash
#!/bin/bash
# resource_alert.sh

PID=$(pgrep gravity)
ALERT_EMAIL="admin@company.com"

# CPU检查
CPU_USAGE=$(ps -p $PID -o %cpu --no-headers | awk '{print int($1)}')
if [ $CPU_USAGE -gt 80 ]; then
    echo "Gravity CPU使用率过高: ${CPU_USAGE}%" | mail -s "Gravity告警" $ALERT_EMAIL
fi

# 内存检查
MEM_USAGE=$(ps -p $PID -o %mem --no-headers | awk '{print int($1)}')
if [ $MEM_USAGE -gt 80 ]; then
    echo "Gravity内存使用率过高: ${MEM_USAGE}%" | mail -s "Gravity告警" $ALERT_EMAIL
fi

# 磁盘检查
DISK_USAGE=$(df /var/log/gravity | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 90 ]; then
    echo "Gravity日志磁盘使用率过高: ${DISK_USAGE}%" | mail -s "Gravity告警" $ALERT_EMAIL
fi
```

---

## 9. 🏥 服务健康检查


### 9.1 健康检查指标


**核心健康指标**：

| 指标类型 | 检查项目 | 正常状态 |
|----------|----------|----------|
| **进程状态** | 进程是否运行 | 运行中 |
| **网络连接** | 数据库连接 | 已连接 |
| **数据同步** | binlog位置更新 | 持续更新 |
| **API响应** | HTTP接口 | 正常响应 |
| **资源使用** | CPU/内存 | 在合理范围内 |

### 9.2 健康检查脚本


**综合健康检查脚本**：

```bash
#!/bin/bash
# health_check.sh

HEALTH_SCORE=0
MAX_SCORE=5

echo "=== Gravity健康检查开始 ==="

# 1. 进程检查
if pgrep gravity > /dev/null; then
    echo "✅ 进程检查: 正常"
    ((HEALTH_SCORE++))
else
    echo "❌ 进程检查: 异常"
fi

# 2. 端口检查
if netstat -tlnp | grep :8080 > /dev/null; then
    echo "✅ 端口检查: 正常"
    ((HEALTH_SCORE++))
else
    echo "❌ 端口检查: 异常"
fi

# 3. API检查
if curl -s --connect-timeout 5 http://localhost:8080/status > /dev/null; then
    echo "✅ API检查: 正常"
    ((HEALTH_SCORE++))
else
    echo "❌ API检查: 异常"
fi

# 4. 日志检查（最近1分钟是否有日志更新）
if [ -f /var/log/gravity/gravity.log ]; then
    LAST_LOG=$(find /var/log/gravity/gravity.log -mmin -1)
    if [ -n "$LAST_LOG" ]; then
        echo "✅ 日志检查: 正常"
        ((HEALTH_SCORE++))
    else
        echo "⚠️ 日志检查: 可能异常（1分钟内无更新）"
    fi
else
    echo "❌ 日志检查: 日志文件不存在"
fi

# 5. 资源检查
PID=$(pgrep gravity)
if [ -n "$PID" ]; then
    CPU_USAGE=$(ps -p $PID -o %cpu --no-headers | awk '{print int($1)}')
    if [ $CPU_USAGE -lt 90 ]; then
        echo "✅ 资源检查: 正常"
        ((HEALTH_SCORE++))
    else
        echo "⚠️ 资源检查: CPU使用率过高($CPU_USAGE%)"
    fi
fi

# 健康评分
echo "=== 健康评分: $HEALTH_SCORE/$MAX_SCORE ==="

if [ $HEALTH_SCORE -eq $MAX_SCORE ]; then
    echo "🎉 服务状态: 完全健康"
    exit 0
elif [ $HEALTH_SCORE -ge 3 ]; then
    echo "⚠️ 服务状态: 基本健康"
    exit 0
else
    echo "❌ 服务状态: 存在问题"
    exit 1
fi
```

### 9.3 自动故障恢复


**故障自动恢复脚本**：

```bash
#!/bin/bash
# auto_recovery.sh

LOG_FILE="/var/log/gravity_recovery.log"

# 执行健康检查
if ! /opt/scripts/health_check.sh; then
    echo "[$(date)] 检测到服务异常，开始自动恢复" >> $LOG_FILE
    
    # 尝试重启服务
    systemctl restart gravity
    
    # 等待30秒
    sleep 30
    
    # 再次检查
    if /opt/scripts/health_check.sh; then
        echo "[$(date)] 服务恢复成功" >> $LOG_FILE
        # 发送恢复通知
        echo "Gravity服务已自动恢复" | mail -s "服务恢复" admin@company.com
    else
        echo "[$(date)] 自动恢复失败，需要人工介入" >> $LOG_FILE
        # 发送故障通知
        echo "Gravity服务自动恢复失败，请立即检查" | mail -s "紧急故障" admin@company.com
    fi
fi
```

### 9.4 健康检查集成


**集成到监控系统**：

```bash
# 与Prometheus集成
# 创建metrics输出脚本
#!/bin/bash
# gravity_metrics.sh

PID=$(pgrep gravity)
if [ -n "$PID" ]; then
    CPU_USAGE=$(ps -p $PID -o %cpu --no-headers)
    MEM_USAGE=$(ps -p $PID -o %mem --no-headers)
    
    echo "gravity_cpu_usage $CPU_USAGE"
    echo "gravity_memory_usage $MEM_USAGE" 
    echo "gravity_status 1"
else
    echo "gravity_status 0"
fi
```

**与Nagios集成**：

```bash
#!/bin/bash
# nagios_gravity_check.sh

# Nagios插件返回码
OK=0
WARNING=1
CRITICAL=2
UNKNOWN=3

if /opt/scripts/health_check.sh > /dev/null 2>&1; then
    echo "OK - Gravity服务运行正常"
    exit $OK
else
    echo "CRITICAL - Gravity服务异常"
    exit $CRITICAL
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本操作


```
🔸 服务启停：systemctl start/stop/restart gravity
🔸 状态查询：systemctl status gravity
🔸 日志查看：tail -f /var/log/gravity/gravity.log
🔸 进程监控：ps aux | grep gravity
🔸 配置重载：systemctl reload gravity
🔸 健康检查：curl http://localhost:8080/status
```

### 10.2 关键理解要点


**🔹 服务管理的核心理念**
```
预防胜于治疗：
• 做好监控预警，提前发现问题
• 自动化脚本减少人工操作
• 标准化操作流程避免误操作

持续改进：
• 根据监控数据优化配置
• 总结故障经验完善预案
• 定期演练确保应急能力
```

**🔹 故障处理优先级**
```
1级（立即处理）：服务完全停止
2级（1小时内）：服务异常但未停止
3级（当天处理）：性能警告
4级（计划处理）：优化建议
```

### 10.3 最佳实践建议


**🎯 日常运维规范**
- **监控检查**：每日检查服务状态和资源使用
- **日志分析**：定期分析日志发现潜在问题
- **备份验证**：确保配置文件和位置信息备份有效
- **文档更新**：及时更新操作手册和故障处理记录

**🎯 应急处置流程**
```
故障发现 → 快速评估 → 紧急处理 → 原因分析 → 预防改进

紧急处理原则：
1. 先恢复服务，再分析原因
2. 保存现场信息便于事后分析
3. 及时沟通避免影响扩大
```

**🎯 性能优化要点**
- **资源配置**：根据实际负载调整内存和CPU配置
- **网络优化**：优化数据库连接池和网络参数
- **存储优化**：合理配置日志轮转和数据存储
- **参数调优**：根据业务特点调整同步参数

### 10.4 常见问题解决


| 问题现象 | 可能原因 | 解决方法 |
|----------|----------|----------|
| **服务启动失败** | 配置文件错误 | 检查配置语法和权限 |
| **同步延迟增大** | 网络或目标库性能问题 | 检查网络和数据库状态 |
| **内存使用过高** | 缓存配置不当 | 调整缓存大小参数 |
| **连接频繁断开** | 网络不稳定 | 增加重连机制和超时设置 |

**核心记忆要点**：
- Gravity服务管理就是确保数据同步稳定运行
- 监控、日志、健康检查是运维三大支柱
- 自动化脚本能大大提高运维效率
- 故障处理要快速响应，预防为主