---
title: 5、Gravity安装与部署实战
---
## 📚 目录

1. [Gravity工具概述](#1-gravity工具概述)
2. [安装前准备工作](#2-安装前准备工作)
3. [二进制包安装方式](#3-二进制包安装方式)
4. [源码编译安装方式](#4-源码编译安装方式)
5. [配置文件准备](#5-配置文件准备)
6. [服务启动与验证](#6-服务启动与验证)
7. [部署故障排查](#7-部署故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 Gravity工具概述


### 1.1 什么是Gravity

`🔸 基础` **Gravity**是摩拜单车开源的MySQL数据同步工具，主要用于解决MySQL数据库的实时同步问题。

**💡 核心作用**：
- **数据同步**：将MySQL数据实时同步到其他系统
- **数据流转**：支持MySQL到Kafka、MongoDB等多种目标端
- **实时处理**：基于MySQL binlog实现准实时数据同步

**🎯 应用场景**：
```
业务场景举例：
电商系统 → 订单数据 → 实时同步到数据仓库
用户系统 → 用户信息 → 同步到搜索引擎
日志系统 → 操作记录 → 推送到消息队列
```

### 1.2 工作原理简述

**⚡ 基本工作流程**：
```
MySQL数据库 → binlog日志 → Gravity读取 → 数据转换 → 目标系统

详细过程：
1. 监听MySQL的binlog变化
2. 解析binlog中的数据变更
3. 按配置规则转换数据格式
4. 将数据推送到目标系统
```

### 1.3 核心优势

| 优势特点 | **具体说明** | **实际价值** |
|---------|------------|-------------|
| 🚀 **实时性强** | `基于binlog，毫秒级延迟` | `业务数据及时同步` |
| 🔧 **配置灵活** | `支持多种同步规则` | `适应不同业务需求` |
| 💪 **性能稳定** | `经过摩拜生产环境验证` | `可靠性有保障` |
| 🔌 **扩展性好** | `支持多种目标端` | `满足复杂架构需求` |

---

## 2. 📋 安装前准备工作


### 2.1 系统环境要求

**🔸 操作系统**：
- **推荐**：CentOS 7/8, Ubuntu 18.04+
- **支持**：大多数Linux发行版
- **不支持**：Windows系统

**🔸 硬件要求**：
```
最低配置：
- CPU: 2核心
- 内存: 4GB
- 磁盘: 20GB可用空间

推荐配置：
- CPU: 4核心以上
- 内存: 8GB以上  
- 磁盘: 50GB以上SSD
```

### 2.2 依赖软件检查

**📦 必须安装的软件**：

| 软件名称 | **版本要求** | **安装检查命令** | **用途说明** |
|---------|------------|-----------------|-------------|
| **Go语言** | `≥ 1.13` | `go version` | `编译Gravity源码` |
| **Git** | `≥ 2.0` | `git --version` | `下载源码` |
| **MySQL** | `≥ 5.6` | `mysql --version` | `数据源` |

**🔧 依赖检查脚本**：
```bash
#!/bin/bash
# 检查系统依赖

echo "=== 系统依赖检查 ==="

# 检查Go版本
if command -v go &> /dev/null; then
    echo "✅ Go已安装: $(go version)"
else
    echo "❌ Go未安装，需要安装Go 1.13+"
fi

# 检查Git
if command -v git &> /dev/null; then
    echo "✅ Git已安装: $(git --version)"
else
    echo "❌ Git未安装"
fi

# 检查MySQL客户端
if command -v mysql &> /dev/null; then
    echo "✅ MySQL客户端已安装"
else
    echo "⚠️  MySQL客户端未安装"
fi
```

### 2.3 网络环境准备

**🌐 网络连通性要求**：
- **MySQL连接**：确保能够连接到源MySQL数据库
- **目标端连接**：确保能够连接到同步目标（如Kafka、MongoDB等）
- **互联网访问**：下载依赖包时需要访问外网

**💡 连接测试方法**：
```bash
# 测试MySQL连接
mysql -h<mysql_host> -P<port> -u<username> -p

# 测试端口连通性  
telnet <target_host> <port>

# 测试网络延迟
ping <target_host>
```

---

## 3. 📦 二进制包安装方式


### 3.1 下载预编译包

**🎯 推荐方式**：直接使用官方预编译的二进制包，**简单快速**，适合大多数用户。

**📥 下载步骤**：
```bash
# 创建安装目录
mkdir -p /opt/gravity
cd /opt/gravity

# 下载最新版本（以v1.0.0为例）
wget https://github.com/moiot/gravity/releases/download/v1.0.0/gravity-linux-amd64.tar.gz

# 解压文件
tar -xzf gravity-linux-amd64.tar.gz

# 查看解压内容
ls -la
```

### 3.2 文件结构说明

**📁 解压后的目录结构**：
```
gravity/
├── gravity              # 主程序可执行文件
├── config/             # 配置文件目录
│   ├── config.toml     # 主配置文件模板
│   └── sample/         # 示例配置文件
├── docs/               # 文档目录
├── LICENSE             # 许可证文件
└── README.md           # 说明文档
```

### 3.3 环境变量配置

**🔧 添加到系统PATH**：
```bash
# 编辑环境变量文件
vi ~/.bashrc

# 添加以下内容
export GRAVITY_HOME=/opt/gravity
export PATH=$PATH:$GRAVITY_HOME

# 使配置生效
source ~/.bashrc

# 验证安装
gravity --version
```

### 3.4 创建系统服务

**🔸 进阶** 为了方便管理，可以创建systemd服务：

```bash
# 创建服务文件
sudo vi /etc/systemd/system/gravity.service
```

```ini
[Unit]
Description=Gravity MySQL Sync Tool
After=network.target

[Service]
Type=simple
User=gravity
Group=gravity
WorkingDirectory=/opt/gravity
ExecStart=/opt/gravity/gravity --config=/opt/gravity/config/config.toml
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

---

## 4. 🛠️ 源码编译安装方式


### 4.1 何时选择源码编译

**🤔 选择依据**：
- ✅ **需要自定义功能**：修改源码适应特殊需求
- ✅ **特殊平台**：官方没有提供对应平台的二进制包
- ✅ **学习目的**：想要深入了解Gravity的实现
- ❌ **一般使用**：建议直接用二进制包

### 4.2 源码下载与编译

**📥 下载源码**：
```bash
# 克隆仓库
git clone https://github.com/moiot/gravity.git
cd gravity

# 查看版本标签
git tag -l

# 切换到稳定版本（推荐）
git checkout v1.0.0
```

**🔨 编译过程**：
```bash
# 设置Go模块代理（国内用户）
export GOPROXY=https://goproxy.cn,direct

# 下载依赖
go mod download

# 编译
make build

# 编译成功后会在bin目录生成可执行文件
ls bin/
```

### 4.3 编译常见问题

**🐛 问题排查**：

| 问题现象 | **可能原因** | **解决方法** |
|---------|------------|-------------|
| `网络连接超时` | `无法访问GitHub` | `使用代理或国内镜像` |
| `依赖下载失败` | `Go模块代理问题` | `设置GOPROXY环境变量` |
| `编译错误` | `Go版本过低` | `升级Go到1.13+` |
| `权限错误` | `目录权限不足` | `使用sudo或修改权限` |

**💡 编译优化**：
```bash
# 启用Go模块代理加速下载
export GOPROXY=https://goproxy.cn,direct

# 设置Go模块缓存目录
export GOMODCACHE=/tmp/gomod

# 并行编译（利用多核CPU）
make -j4 build
```

---

## 5. ⚙️ 配置文件准备


### 5.1 配置文件结构

**📝 主配置文件**：`config.toml`是Gravity的核心配置文件，控制整个同步流程。

**🔍 配置文件的组成部分**：
```
config.toml
├── [input]      # 数据输入配置（MySQL信息）
├── [filter]     # 数据过滤配置（同步哪些表）
├── [output]     # 数据输出配置（目标系统）
└── [scheduler]  # 调度器配置（并发控制）
```

### 5.2 基础配置示例

**📋 最简配置模板**：
```toml
# Gravity配置文件示例

# === 输入配置：MySQL数据源 ===
[input]
type = "mysql"

[input.config]
source-host = "127.0.0.1"
source-port = 3306
source-user = "root"
source-password = "password"
source-schema = "test_db"

# === 过滤配置：指定同步的表 ===
[[filter]]
type = "table-filter"
[filter.config]
match-schema = "test_db"
match-table = "users"

# === 输出配置：同步到Kafka ===
[output]
type = "kafka"
[output.config]
broker-addrs = ["127.0.0.1:9092"]
topic = "mysql-sync"
```

### 5.3 配置参数详解

**🔸 必须配置** 的关键参数：

| 配置项 | **作用说明** | **示例值** | **注意事项** |
|--------|------------|------------|-------------|
| `source-host` | `MySQL服务器地址` | `192.168.1.100` | `确保网络可达` |
| `source-port` | `MySQL端口号` | `3306` | `默认3306` |
| `source-user` | `数据库用户名` | `sync_user` | `需要复制权限` |
| `source-password` | `数据库密码` | `your_password` | `建议加密存储` |
| `source-schema` | `要同步的数据库` | `business_db` | `单个数据库名` |

### 5.4 权限配置要求

**🔒 MySQL用户权限**：
```sql
-- 创建专用同步用户
CREATE USER 'gravity_sync'@'%' IDENTIFIED BY 'your_password';

-- 授予必要权限
GRANT REPLICATION SLAVE ON *.* TO 'gravity_sync'@'%';
GRANT REPLICATION CLIENT ON *.* TO 'gravity_sync'@'%';
GRANT SELECT ON your_database.* TO 'gravity_sync'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

**⚠️ 权限说明**：
- **REPLICATION SLAVE**：读取binlog的权限
- **REPLICATION CLIENT**：获取主库状态的权限  
- **SELECT**：读取表数据的权限

---

## 6. 🚀 服务启动与验证


### 6.1 启动前检查

**✅ 启动检查清单**：
```bash
# 1. 配置文件语法检查
gravity --config=config.toml --check-config

# 2. MySQL连接测试
mysql -h<host> -P<port> -u<user> -p<password> -e "SHOW MASTER STATUS;"

# 3. 目标端连接测试（以Kafka为例）
kafka-console-producer.sh --broker-list localhost:9092 --topic test

# 4. 磁盘空间检查
df -h

# 5. 进程端口检查
netstat -tlnp | grep 8080
```

### 6.2 启动服务

**🔧 不同启动方式**：

**方式1：前台启动（调试用）**：
```bash
# 前台启动，可以看到实时日志
gravity --config=config.toml

# 带调试信息启动
gravity --config=config.toml --log-level=debug
```

**方式2：后台启动（生产用）**：
```bash
# 后台启动
nohup gravity --config=config.toml > gravity.log 2>&1 &

# 查看进程
ps aux | grep gravity

# 查看日志
tail -f gravity.log
```

**方式3：系统服务启动**：
```bash
# 启动服务
sudo systemctl start gravity

# 查看状态
sudo systemctl status gravity

# 设置开机自启
sudo systemctl enable gravity
```

### 6.3 验证同步效果

**📊 验证步骤**：

**步骤1：检查服务状态**
```bash
# 查看进程是否正常
ps aux | grep gravity

# 查看端口监听
netstat -tlnp | grep gravity

# 查看日志
tail -f gravity.log
```

**步骤2：测试数据同步**
```sql
-- 在源MySQL中插入测试数据
INSERT INTO users (name, email) VALUES ('test_user', 'test@example.com');

-- 更新数据
UPDATE users SET email = 'new@example.com' WHERE name = 'test_user';

-- 删除数据
DELETE FROM users WHERE name = 'test_user';
```

**步骤3：验证目标端数据**
```bash
# 如果同步到Kafka，查看消息
kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic mysql-sync --from-beginning

# 如果同步到文件，查看文件内容
tail -f /path/to/output/file
```

### 6.4 监控指标检查

**📈 关键监控指标**：
```
监控项目          正常范围        异常告警
同步延迟          < 1秒          > 5秒
错误率           < 0.1%         > 1%
内存使用          < 80%          > 90%
CPU使用           < 70%          > 85%
磁盘使用          < 80%          > 90%
```

---

## 7. 🔧 部署故障排查


### 7.1 常见启动问题

**🐛 启动失败排查流程**：

```
启动失败
    ↓
检查配置文件
    ↓
检查依赖服务
    ↓  
检查网络连接
    ↓
检查权限设置
    ↓
查看详细日志
```

### 7.2 具体问题解决方案

**❌ 问题1：配置文件错误**
```bash
# 现象：启动时报配置文件格式错误
# 解决：使用工具检查TOML格式
gravity --config=config.toml --check-config

# 常见错误：
# - 缺少引号
# - 缩进错误  
# - 特殊字符未转义
```

**❌ 问题2：MySQL连接失败**
```bash
# 现象：无法连接到MySQL数据库
# 排查步骤：

# 1. 检查网络连通性
telnet mysql_host 3306

# 2. 检查用户权限
mysql -h<host> -u<user> -p -e "SHOW GRANTS;"

# 3. 检查binlog配置
mysql -h<host> -u<user> -p -e "SHOW VARIABLES LIKE 'log_bin';"
```

**❌ 问题3：内存不足**
```bash
# 现象：进程被kill或OOM错误
# 解决方案：

# 1. 检查系统内存
free -h

# 2. 调整Gravity内存限制
# 在配置文件中添加：
[scheduler]
batch-size = 100        # 减少批次大小
worker-count = 2        # 减少并发数

# 3. 增加系统swap
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 7.3 日志分析技巧

**📝 日志级别设置**：
```toml
# 配置文件中设置日志级别
[log]
level = "info"          # 生产环境
level = "debug"         # 调试环境
level = "error"         # 只记录错误
```

**🔍 关键日志关键词**：
| 日志类型 | **关键词** | **含义说明** |
|---------|-----------|-------------|
| **连接问题** | `connection refused` | `目标服务无法连接` |
| **权限问题** | `access denied` | `数据库权限不足` |
| **同步问题** | `binlog position` | `binlog位置相关` |
| **性能问题** | `slow query` | `查询性能慢` |

### 7.4 应急处理预案

**🚨 应急处理流程**：

**场景1：服务突然停止**
```bash
# 1. 快速重启服务
sudo systemctl restart gravity

# 2. 如果重启失败，检查错误日志
journalctl -u gravity -f

# 3. 临时恢复方案：手动启动
nohup gravity --config=config.toml > gravity.log 2>&1 &
```

**场景2：同步延迟过大**  
```bash
# 1. 检查网络延迟
ping mysql_host
ping kafka_host

# 2. 检查系统负载
top
iostat 1

# 3. 临时优化：调整并发参数
# 修改config.toml中的worker-count
```

**场景3：磁盘空间不足**
```bash
# 1. 清理日志文件
find /var/log -name "*.log" -mtime +7 -delete

# 2. 压缩旧日志
gzip /path/to/gravity/*.log

# 3. 调整日志轮转
logrotate -f /etc/logrotate.d/gravity
```

---

## 8. 📋 核心要点总结


### 8.1 安装部署要点

```
🔸 环境准备：Go 1.13+、MySQL 5.6+、足够的系统资源
🔸 安装方式：二进制包（推荐）或源码编译
🔸 配置核心：正确配置MySQL连接和同步规则
🔸 权限要求：MySQL用户需要REPLICATION相关权限
🔸 启动验证：前台调试→后台运行→系统服务
```

### 8.2 部署最佳实践

**🎯 生产环境建议**：
- ✅ **资源规划**：预留足够的CPU、内存、磁盘空间
- ✅ **高可用设计**：配置主备部署，避免单点故障
- ✅ **监控告警**：设置关键指标监控和告警机制
- ✅ **备份策略**：定期备份配置文件和重要数据
- ✅ **版本管理**：使用稳定版本，制定升级计划

### 8.3 故障预防措施  

**🛡️ 预防策略**：
- **配置检查**：部署前充分测试配置文件
- **权限验证**：确保数据库用户权限完整
- **网络测试**：验证所有网络连接的稳定性
- **资源监控**：实时监控系统资源使用情况
- **日志轮转**：避免日志文件占满磁盘空间

### 8.4 记忆要点

```
💡 安装记忆口诀：
环境准备要充分，权限配置不能少
二进制包最简单，源码编译为定制
配置文件是核心，连接测试要验证
启动方式有三种，监控日志保稳定
```

**🚀 下一步学习**：
- 📍 **前置知识**：MySQL binlog原理
- 🎯 **当前内容**：Gravity安装部署
- 🔜 **后续内容**：配置规则详解、性能优化