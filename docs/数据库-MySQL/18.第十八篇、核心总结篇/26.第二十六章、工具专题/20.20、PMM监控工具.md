---
title: 20、PMM监控工具
---
## 📚 目录

1. [PMM监控平台概述](#1-PMM监控平台概述)
2. [PMM Server服务端部署](#2-PMM-Server服务端部署)
3. [PMM Client客户端配置](#3-PMM-Client客户端配置)
4. [性能监控面板详解](#4-性能监控面板详解)
5. [查询分析功能应用](#5-查询分析功能应用)
6. [慢查询监控实践](#6-慢查询监控实践)
7. [系统指标监控体系](#7-系统指标监控体系)
8. [告警通知机制配置](#8-告警通知机制配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 PMM监控平台概述


### 1.1 PMM是什么


**PMM（Percona Monitoring and Management）**：Percona公司开发的**免费开源**数据库监控和管理平台

```
简单理解PMM：
就像给数据库装了一个"体检设备"
- 实时监控数据库的"健康状况"
- 发现性能问题和瓶颈
- 提供详细的分析报告
- 帮助优化数据库性能
```

### 1.2 PMM核心价值


**🔸 为什么需要PMM？**
```
传统监控的问题：
❌ 只能看到基础指标（CPU、内存）
❌ 无法深入分析SQL查询性能  
❌ 问题发生后才知道，缺乏预警
❌ 数据分散在各个地方，难以关联分析

PMM的优势：
✅ 专门针对数据库的深度监控
✅ 可视化图表，一目了然
✅ 历史数据保存，方便对比分析
✅ 自动发现性能瓶颈
✅ 支持多种数据库（MySQL、PostgreSQL、MongoDB）
```

### 1.3 PMM架构组成


**🏗️ PMM双组件架构**
```
PMM整体架构：

┌─────────────────┐    数据传输    ┌─────────────────┐
│   PMM Client    │ ──────────────> │   PMM Server    │
│  (数据收集端)    │                │  (数据分析端)    │
│                 │                │                 │
│ • pmm-admin     │                │ • Grafana       │
│ • mysqld_exporter│               │ • Prometheus    │ 
│ • node_exporter │                │ • ClickHouse    │
│ • pt-stalk      │                │ • AlertManager  │
└─────────────────┘                └─────────────────┘
     ↑                                       ↑
     │                                       │
┌─────────────┐                         ┌───────────┐
│  MySQL数据库  │                         │  Web界面   │
│    服务器    │                         │   访问    │
└─────────────┘                         └───────────┘
```

**组件说明：**
- **PMM Client**：安装在数据库服务器上，负责收集监控数据
- **PMM Server**：独立服务器，负责存储数据和提供监控界面

---

## 2. ⚙️ PMM Server服务端部署


### 2.1 PMM Server部署方式


**🔸 三种部署方式**

| 部署方式 | **适用场景** | **优点** | **缺点** |
|---------|-------------|----------|----------|
| 🐳 **Docker容器** | `测试环境、快速部署` | `部署简单、资源隔离` | `需要Docker知识` |
| 📦 **OVA虚拟机** | `VMware环境` | `开箱即用、无需配置` | `只支持VMware` |
| 🔧 **手动安装** | `定制化需求` | `完全控制、灵活配置` | `配置复杂` |

### 2.2 Docker方式部署（推荐）


**🚀 快速部署步骤**

```bash
# 1. 拉取PMM Server镜像
docker pull percona/pmm-server:2

# 2. 创建数据卷（持久化存储）
docker volume create pmm-data

# 3. 启动PMM Server容器
docker run -d \
  -p 80:80 \
  -p 443:443 \
  --volume pmm-data:/srv \
  --name pmm-server \
  --restart always \
  percona/pmm-server:2

# 4. 查看容器状态
docker ps | grep pmm-server

# 5. 获取默认admin密码
docker logs pmm-server | grep "Generated default password"
```

**💡 部署完成验证**
```bash
# 检查服务状态
curl -I http://your-server-ip

# 浏览器访问
http://your-server-ip
默认账号：admin
密码：查看容器日志获取
```

### 2.3 PMM Server初始配置


**🔧 首次登录配置流程**

```
访问流程图：
浏览器 → http://PMM-Server-IP → 登录页面
  ↓
输入admin账号密码 → 强制修改密码 → 进入主界面
  ↓  
设置时区 → 配置SMTP → 创建普通用户账号
```

**初始设置清单：**
- ✅ **修改管理员密码**：增强安全性
- ✅ **设置正确时区**：确保监控数据时间准确
- ✅ **配置邮件服务**：用于告警通知
- ✅ **创建只读用户**：给开发人员查看权限

---

## 3. 🔌 PMM Client客户端配置


### 3.1 PMM Client安装


**🔸 在MySQL服务器上安装PMM Client**

```bash
# CentOS/RHEL系统安装
# 1. 添加Percona仓库
yum install -y https://repo.percona.com/yum/percona-release-latest.noarch.rpm
percona-release setup pmm2-client

# 2. 安装PMM Client
yum install -y pmm2-client

# 3. 验证安装
pmm-admin --version
```

```bash
# Ubuntu/Debian系统安装
# 1. 添加仓库
wget https://repo.percona.com/apt/percona-release_latest.generic_all.deb
dpkg -i percona-release_latest.generic_all.deb
percona-release setup pmm2-client

# 2. 更新并安装
apt update
apt install -y pmm2-client
```

### 3.2 连接PMM Server


**🔗 配置Client连接到Server**

```bash
# 1. 配置PMM Server连接信息
pmm-admin config --server-insecure-tls --server-url=https://admin:password@PMM-SERVER-IP

# 参数说明：
# --server-insecure-tls：忽略SSL证书验证（测试环境）
# --server-url：PMM Server的访问地址
# admin:password：登录账号密码
# PMM-SERVER-IP：PMM Server的IP地址

# 2. 验证连接状态
pmm-admin status

# 正常输出示例：
# pmm-admin 2.x.x
# PMM Server      | PMM-SERVER-IP
# Agent ID        | /agent_id/xxxxxxxx
# Node ID         | /node_id/xxxxxxxx
```

### 3.3 添加MySQL监控


**📊 配置MySQL数据库监控**

```bash
# 1. 添加MySQL服务监控
pmm-admin add mysql \
  --username=pmm_user \
  --password=pmm_password \
  --service-name=mysql-prod \
  --host=127.0.0.1 \
  --port=3306

# 参数详解：
# --username：MySQL监控用户名
# --password：MySQL监控密码  
# --service-name：在PMM中显示的服务名称
# --host：MySQL服务器地址
# --port：MySQL端口号
```

**🔑 创建MySQL监控用户**
```sql
-- 在MySQL中创建PMM监控专用用户
CREATE USER 'pmm_user'@'%' IDENTIFIED BY 'pmm_password';

-- 授予必要的监控权限
GRANT SELECT, PROCESS, REPLICATION CLIENT, RELOAD, BACKUP_ADMIN ON *.* TO 'pmm_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证用户权限
SHOW GRANTS FOR 'pmm_user'@'%';
```

### 3.4 验证监控配置


**✅ 检查监控状态**

```bash
# 查看所有监控服务
pmm-admin list

# 输出示例：
# Service type  Service name     Address and port  Service ID
# mysql         mysql-prod       127.0.0.1:3306    /service_id/xxx
# linux:metrics localhost        -                 /service_id/xxx

# 检查数据收集状态
pmm-admin status

# 测试连接
pmm-admin check-network
```

---

## 4. 📊 性能监控面板详解


### 4.1 PMM监控界面布局


**🎨 Grafana监控面板结构**

```
PMM监控界面布局：

┌────────────────────────────────────────────────┐
│  顶部导航栏：Home | Dashboards | Explore | 设置  │
├────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────────────────┐ │
│  │   服务列表    │  │      主要监控面板         │ │
│  │              │  │                          │ │
│  │ • MySQL实例   │  │  ┌─────────┬─────────┐   │ │
│  │ • 系统监控    │  │  │ QPS图表 │ 连接数   │   │ │
│  │ • 慢查询     │  │  ├─────────┼─────────┤   │ │
│  │ • 告警状态    │  │  │ 响应时间│ 锁等待   │   │ │
│  │              │  │  └─────────┴─────────┘   │ │
│  └──────────────┘  └──────────────────────────┘ │
└────────────────────────────────────────────────┘
```

### 4.2 关键监控面板详解


**🔸 MySQL Overview面板**

| 监控项目 | **含义说明** | **正常范围** | **异常信号** |
|---------|-------------|-------------|-------------|
| 🔄 **QPS** | `每秒查询数量` | `根据业务而定` | `突然大幅波动` |
| 🔗 **Connections** | `当前连接数` | `<max_connections的80%` | `接近最大连接数` |
| ⏱️ **Response Time** | `平均响应时间` | `<100ms` | `>500ms需关注` |
| 🔒 **Lock Time** | `锁等待时间` | `<10ms` | `>100ms有问题` |
| 💾 **InnoDB Buffer** | `缓冲池命中率` | `>95%` | `<90%需优化` |

**🔸 系统资源监控**
```
系统监控重点指标：

CPU使用率：
  ┌─────────────────────────────────┐
  │ ████████████░░░░░░░░░░░░░░░░░░░ │ 60%
  └─────────────────────────────────┘
  正常：<70%    警告：70-85%    危险：>85%

内存使用率：
  ┌─────────────────────────────────┐
  │ ██████████████████████░░░░░░░░░ │ 75%
  └─────────────────────────────────┘
  正常：<80%    警告：80-90%    危险：>90%

磁盘I/O：
  读取：1000 IOPS    写入：500 IOPS
  延迟：<10ms 正常   >50ms 需关注
```

### 4.3 自定义监控面板


**🎨 创建个性化面板**

```
自定义面板步骤：
1. 点击"+"号 → Create Dashboard
2. Add Query → 选择数据源
3. 配置查询语句和图表类型
4. 设置显示样式和阈值
5. 保存面板并设置权限
```

**常用自定义监控示例：**
```sql
-- 监控特定数据库的查询量
SELECT 
  rate(mysql_global_status_queries[5m]) 
FROM prometheus 
WHERE instance = "mysql-prod:3306"

-- 监控表锁等待情况  
SELECT 
  mysql_global_status_table_locks_waited
FROM prometheus
WHERE instance = "mysql-prod:3306"
```

---

## 5. 🔍 查询分析功能应用


### 5.1 Query Analytics概述


**🎯 Query Analytics是什么**

```
Query Analytics功能：
就像给数据库装了"行车记录仪"
- 记录每一条SQL查询的执行情况
- 分析哪些查询最慢、最频繁
- 找出性能瓶颈的根本原因
- 提供SQL优化建议
```

### 5.2 查询分析界面


**📊 Query Analytics界面布局**

```
Query Analytics主界面：

┌─────────────────────────────────────────────────────┐
│  时间范围: [最近1小时 ▼]  刷新: [自动 ▼]  过滤器: [] │
├─────────────────────────────────────────────────────┤
│  排序依据: [总执行时间 ▼]                            │
├─────────────────────────────────────────────────────┤
│  Top查询列表:                                       │
│  ┌─┬──────────────┬──────┬──────┬──────┬─────────┐  │
│  │#│ 查询类型      │ 总时间│ 次数 │平均时间│ 数据库  │  │
│  ├─┼──────────────┼──────┼──────┼──────┼─────────┤  │
│  │1│ SELECT users  │ 120s │ 1500│ 80ms│ app_db  │  │
│  │2│ UPDATE orders │ 95s  │ 800 │120ms│ app_db  │  │
│  │3│ INSERT logs   │ 75s  │2000 │ 38ms│ log_db  │  │
│  └─┴──────────────┴──────┴──────┴──────┴─────────┘  │
└─────────────────────────────────────────────────────┘
```

### 5.3 查询性能分析实践


**🔍 分析慢查询的步骤**

```
慢查询分析流程：

1. 选择时间范围
   ↓
2. 按总执行时间排序
   ↓  
3. 点击问题查询查看详情
   ↓
4. 查看执行计划和索引使用
   ↓
5. 分析优化建议
   ↓
6. 实施优化方案
```

**实际案例分析：**
```sql
-- 发现的问题查询
SELECT * FROM users u 
LEFT JOIN orders o ON u.id = o.user_id 
WHERE u.created_at > '2024-01-01' 
ORDER BY u.created_at DESC;

-- 问题分析：
❌ SELECT * 选择了不需要的字段
❌ 没有LIMIT限制结果数量  
❌ 可能缺少created_at字段的索引
❌ JOIN可能产生大量数据

-- 优化方案：
✅ 只选择需要的字段
✅ 添加LIMIT限制
✅ 确保有适当的索引
✅ 考虑分页查询
```

### 5.4 查询优化建议


**🚀 常见优化策略**

| 问题类型 | **优化建议** | **预期效果** |
|---------|-------------|-------------|
| 🐌 **全表扫描** | `添加适当索引` | `查询时间减少90%+` |
| 📊 **返回数据过多** | `添加LIMIT和WHERE条件` | `减少网络传输和内存使用` |
| 🔄 **重复查询** | `使用缓存或合并查询` | `减少数据库负载` |
| 🔗 **JOIN性能差** | `检查JOIN条件索引` | `JOIN执行时间大幅减少` |

---

## 6. 🐌 慢查询监控实践


### 6.1 慢查询监控配置


**⚙️ MySQL慢查询日志设置**

```sql
-- 1. 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';

-- 2. 设置慢查询阈值（秒）
SET GLOBAL long_query_time = 2.0;

-- 3. 设置日志文件路径
SET GLOBAL slow_query_log_file = '/var/log/mysql/mysql-slow.log';

-- 4. 记录未使用索引的查询
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- 5. 查看当前配置
SHOW VARIABLES LIKE '%slow%';
```

### 6.2 PMM慢查询分析


**📈 慢查询监控面板**

```
PMM慢查询监控显示：

慢查询趋势图：
时间   9:00  10:00  11:00  12:00  13:00
查询数   │     │     │     │     │
      20├─────┼─────┼──●──┼─────┤
      15│     │   ● │  │  │  ●  │
      10│  ●  │  │  │  │  │ ╱│  │  
       5│ ╱│  │ ╱   │ ╱   │╱ │  │
       0└─────┴─────┴─────┴─────┘
         正常  升高  峰值  回落

Top 5 慢查询类型：
1. SELECT FROM large_table     - 45% (平均3.2s)
2. JOIN 多表查询               - 25% (平均2.8s)  
3. UPDATE 批量更新             - 15% (平均2.1s)
4. DELETE 大量数据             - 10% (平均4.5s)
5. 其他复杂查询               - 5%  (平均2.3s)
```

### 6.3 慢查询优化实战


**🔧 典型慢查询优化案例**

```sql
-- 案例1：缺少索引的查询
-- 原始查询（执行时间：3.2秒）
SELECT * FROM orders 
WHERE customer_id = 12345 
  AND order_date > '2024-01-01';

-- 问题分析：
-- customer_id和order_date字段缺少合适索引

-- 优化方案：
-- 1. 创建复合索引
CREATE INDEX idx_orders_customer_date 
ON orders(customer_id, order_date);

-- 2. 只选择需要的字段
SELECT order_id, order_date, amount 
FROM orders 
WHERE customer_id = 12345 
  AND order_date > '2024-01-01';

-- 优化后执行时间：0.05秒
```

---

## 7. 📊 系统指标监控体系


### 7.1 系统监控架构


**🏗️ PMM系统监控层次**

```
系统监控层次结构：

┌─────────────────────────────────────┐
│           应用层监控                 │
│  • SQL查询性能                      │ 
│  • 连接池状态                       │
│  • 事务处理                         │
├─────────────────────────────────────┤
│           数据库层监控               │
│  • MySQL状态变量                    │
│  • InnoDB引擎指标                   │
│  • 锁等待和死锁                     │
├─────────────────────────────────────┤
│           系统层监控                 │
│  • CPU、内存、磁盘使用              │
│  • 网络I/O、磁盘I/O                 │
│  • 系统负载和进程                   │
├─────────────────────────────────────┤
│           硬件层监控                 │
│  • 服务器温度                       │
│  • 磁盘健康状态                     │
│  • 网卡状态                         │
└─────────────────────────────────────┘
```

### 7.2 关键系统指标详解


**⚡ CPU监控指标**

| 指标名称 | **含义** | **正常值** | **问题排查** |
|---------|---------|-----------|-------------|
| **CPU使用率** | `处理器繁忙程度` | `<70%` | `识别高CPU进程` |
| **CPU等待I/O** | `等待磁盘读写时间` | `<20%` | `检查磁盘性能` |
| **系统负载** | `平均等待执行任务数` | `<CPU核心数` | `分析负载来源` |
| **上下文切换** | `进程切换频率` | `<10000/s` | `检查进程数量` |

**💾 内存监控指标**
```
内存使用分析：

总内存：16GB
┌─────────────────────────────────────────────┐
│ 已用内存    │ InnoDB缓冲池 │  系统缓存  │空闲│
│   2GB      │     8GB      │    4GB    │2GB │
└─────────────────────────────────────────────┘

关键指标：
• 内存使用率：87.5% (14GB/16GB)
• InnoDB缓冲池命中率：98.2%
• 系统缓存使用：4GB
• 内存交换：0 (理想状态)
```

### 7.3 磁盘I/O性能监控


**📀 磁盘性能指标**

```
磁盘I/O监控面板：

IOPS (每秒I/O操作数)：
读取: ████████░░ 800 IOPS
写入: ████░░░░░░ 400 IOPS

延迟监控：
平均延迟: 5ms   (优秀: <10ms)
最大延迟: 25ms  (关注: >50ms)

磁盘使用率：
/data: ████████████████░░░░ 80%
/logs: ██████░░░░░░░░░░░░░░ 30%
```

**🔍 I/O性能分析**
```bash
# 查看实时I/O统计
iostat -x 1

# 关键指标解读：
# %util：磁盘使用率 (<80%正常)
# avgqu-sz：平均队列长度 (<2正常)  
# await：平均等待时间 (<20ms正常)
# svctm：平均服务时间 (<10ms正常)
```

---

## 8. 🚨 告警通知机制配置


### 8.1 告警系统架构


**📢 PMM告警流程**

```
告警处理流程图：

监控数据收集 → 规则引擎判断 → 触发告警 → 发送通知
     ↓              ↓            ↓          ↓
  Prometheus    AlertManager   Alert Rule  Notification
   数据源         告警管理      告警规则    通知渠道
     │              │            │          │
     │              │            │          ├→ 邮件
     │              │            │          ├→ 微信  
     │              │            │          ├→ 钉钉
     │              │            │          └→ Slack
```

### 8.2 配置邮件告警


**📧 SMTP邮件配置**

```bash
# 1. 编辑PMM Server配置
docker exec -it pmm-server vi /etc/grafana/grafana.ini

# 2. 配置SMTP设置
[smtp]
enabled = true
host = smtp.company.com:587
user = alert@company.com
password = your_password
skip_verify = true
from_address = alert@company.com
from_name = PMM Alert System
```

**✉️ 创建邮件通知渠道**
```
Grafana配置步骤：
1. 登录Grafana → Alerting → Notification channels
2. 点击"New channel"
3. 选择类型：Email
4. 配置接收邮箱地址
5. 测试发送
6. 保存配置
```

### 8.3 告警规则配置


**⚠️ 常用告警规则**

```yaml
# MySQL连接数告警
- alert: MySQL_High_Connections
  expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "MySQL连接数过高"
    description: "{{ $labels.instance }} 连接数使用率超过80%"

# 慢查询告警  
- alert: MySQL_Slow_Queries
  expr: rate(mysql_global_status_slow_queries[5m]) > 10
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "慢查询增加"
    description: "{{ $labels.instance }} 慢查询频率: {{ $value }}/秒"
```

### 8.4 告警级别管理


**🚦 告警分级策略**

| 级别 | **条件** | **响应时间** | **通知方式** |
|------|---------|-------------|-------------|
| 🟢 **INFO** | `轻微异常` | `1小时内` | `邮件` |
| 🟡 **WARNING** | `需要关注` | `30分钟内` | `邮件+短信` |
| 🔴 **CRITICAL** | `严重问题` | `5分钟内` | `邮件+短信+电话` |
| ⚫ **EMERGENCY** | `系统宕机` | `立即响应` | `所有渠道` |

**📱 多渠道通知配置**
```bash
# 微信企业号通知
curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "msgtype": "text",
    "text": {
      "content": "PMM告警：MySQL连接数过高！"
    }
  }'

# 钉钉机器人通知  
curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{
    "msgtype": "text", 
    "text": {
      "content": "PMM告警：慢查询数量激增！"
    }
  }'
```

---

## 9. 📋 核心要点总结


### 9.1 PMM核心价值


```
🎯 PMM解决的核心问题：
• 数据库性能可视化：图表化展示复杂的性能数据
• 问题快速定位：精准找到性能瓶颈根源
• 历史趋势分析：基于历史数据预测性能问题
• 自动化监控：7×24小时不间断监控
• 多维度分析：从SQL到系统全方位监控
```

### 9.2 关键技术特点


**🔸 技术架构优势**
```
分布式架构：
✅ Client-Server分离，扩展性好
✅ 支持监控多个数据库实例
✅ 数据集中存储和分析
✅ 基于成熟开源组件构建

监控深度：
✅ SQL级别的详细分析
✅ 系统资源全面监控  
✅ 自动发现性能瓶颈
✅ 提供优化建议
```

### 9.3 实施最佳实践


**📚 部署建议**
```
生产环境建议：
🔸 PMM Server独立部署，确保稳定性
🔸 配置足够的磁盘空间存储历史数据
🔸 设置合理的数据保留策略
🔸 配置SSL证书确保数据传输安全
🔸 定期备份PMM配置和数据

监控策略：
🔸 根据业务特点设置告警阈值
🔸 重点监控核心业务相关指标
🔸 建立问题处理标准操作流程
🔸 定期回顾和优化监控策略
```

### 9.4 常见问题解决


**🔧 故障排查指南**

| 问题现象 | **可能原因** | **解决方案** |
|---------|-------------|-------------|
| **数据不更新** | `Client连接异常` | `检查网络和认证信息` |
| **图表显示异常** | `时间范围设置问题` | `调整时间范围和刷新频率` |
| **告警不生效** | `邮件配置错误` | `检查SMTP设置和测试邮件` |
| **性能数据缺失** | `权限不足` | `检查MySQL监控用户权限` |

**🎯 学习路径建议**
```
PMM学习进阶路径：
1. 基础操作：部署和基本配置
2. 监控理解：理解各种性能指标含义
3. 问题分析：学会从图表发现问题
4. 优化实践：结合监控数据优化数据库
5. 高级应用：自定义监控和告警规则
```

### 9.5 PMM核心价值总结


**💡 为什么选择PMM**
- **免费开源**：无需额外许可费用，社区支持活跃
- **专业针对性**：专门为数据库监控设计，功能全面
- **易于使用**：图形化界面直观，学习成本低
- **扩展性强**：支持多种数据库，可自定义监控
- **企业级特性**：支持大规模部署和高可用配置

**核心记忆**：
- PMM是数据库的"健康体检专家"，实时监控和诊断
- 双组件架构简单清晰：Client收集，Server分析
- 监控不是目的，发现和解决问题才是核心价值
- 告警机制要合理设置，避免"狼来了"效应
- 结合业务特点制定监控策略，不要盲目追求全面