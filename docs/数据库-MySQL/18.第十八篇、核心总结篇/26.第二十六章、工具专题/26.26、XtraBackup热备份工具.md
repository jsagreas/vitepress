---
title: 26ã€XtraBackupçƒ­å¤‡ä»½å·¥å…·
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Percona XtraBackup](#1-ä»€ä¹ˆæ˜¯percona-xtrabackup)
2. [çƒ­å¤‡ä»½åŸç†æ·±åº¦è§£æ](#2-çƒ­å¤‡ä»½åŸç†æ·±åº¦è§£æ)
3. [ç‰©ç†å¤‡ä»½æœºåˆ¶è¯¦è§£](#3-ç‰©ç†å¤‡ä»½æœºåˆ¶è¯¦è§£)
4. [å¢é‡å¤‡ä»½ç­–ç•¥ä¸å®ç°](#4-å¢é‡å¤‡ä»½ç­–ç•¥ä¸å®ç°)
5. [å¤‡ä»½æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#5-å¤‡ä»½æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
6. [å¹¶è¡Œå¤‡ä»½å¤„ç†æœºåˆ¶](#6-å¹¶è¡Œå¤‡ä»½å¤„ç†æœºåˆ¶)
7. [å¤‡ä»½éªŒè¯ä¸å®Œæ•´æ€§æ£€æŸ¥](#7-å¤‡ä»½éªŒè¯ä¸å®Œæ•´æ€§æ£€æŸ¥)
8. [å‹ç¼©ä¸åŠ å¯†å¤‡ä»½](#8-å‹ç¼©ä¸åŠ å¯†å¤‡ä»½)
9. [è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬è®¾è®¡](#9-è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬è®¾è®¡)
10. [å¤‡ä»½ç›‘æ§ä¸å‘Šè­¦æœºåˆ¶](#10-å¤‡ä»½ç›‘æ§ä¸å‘Šè­¦æœºåˆ¶)
11. [æ¢å¤æ“ä½œè¯¦ç»†æµç¨‹](#11-æ¢å¤æ“ä½œè¯¦ç»†æµç¨‹)
12. [ä¼ä¸šçº§å¤‡ä»½æ–¹æ¡ˆè®¾è®¡](#12-ä¼ä¸šçº§å¤‡ä»½æ–¹æ¡ˆè®¾è®¡)
13. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#13-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯Percona XtraBackup


### 1.1 åŸºæœ¬æ¦‚å¿µè§£é‡Š


**Percona XtraBackup**æ˜¯ä»€ä¹ˆï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒå°±åƒæ˜¯æ•°æ®åº“çš„"æ‹ç…§å™¨"ï¼Œèƒ½åœ¨æ•°æ®åº“æ­£å¸¸è¿è¡Œçš„æ—¶å€™ç»™æ•´ä¸ªæ•°æ®åº“æ‹ä¸ªå®Œæ•´çš„"ç…§ç‰‡"ï¼ˆå¤‡ä»½ï¼‰ï¼Œè€Œä¸”ä¸ä¼šå½±å“ä¸šåŠ¡çš„æ­£å¸¸ä½¿ç”¨ã€‚

```
ä¼ ç»Ÿå¤‡ä»½ vs XtraBackupï¼š

ä¼ ç»Ÿmysqldumpå¤‡ä»½ï¼š
æ•°æ®åº“ â”€â”€é”è¡¨â”€â”€> å¯¼å‡ºæ•°æ® â”€â”€è§£é”â”€â”€> å¤‡ä»½å®Œæˆ
        â†‘                    â†“
    ä¸šåŠ¡åœæ­¢              ä¸šåŠ¡æ¢å¤
    ï¼ˆå½±å“ç”¨æˆ·ä½¿ç”¨ï¼‰

XtraBackupçƒ­å¤‡ä»½ï¼š
æ•°æ®åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ­£å¸¸è¿è¡Œ
  â†“                              â†‘
åå°å¤‡ä»½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> å¤‡ä»½å®Œæˆ â”€â”€â”€â”€â”˜
ï¼ˆä¸å½±å“ä¸šåŠ¡ï¼‰
```

### 1.2 æ ¸å¿ƒä¼˜åŠ¿è¯´æ˜


**ä¸ºä»€ä¹ˆè¦ç”¨XtraBackupï¼Ÿ**

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒä½ å¯ä»¥è¾¹çœ‹ç”µå½±è¾¹å½•å±ä¸€æ ·ï¼ŒXtraBackupè®©æ•°æ®åº“èƒ½å¤Ÿè¾¹å·¥ä½œè¾¹å¤‡ä»½

**ä¸»è¦ä¼˜åŠ¿ï¼š**
- **ğŸ”¥ é›¶åœæœºæ—¶é—´**ï¼šä¸šåŠ¡ä¸å—å½±å“ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- **âš¡ å¤‡ä»½é€Ÿåº¦å¿«**ï¼šç›´æ¥å¤åˆ¶æ–‡ä»¶ï¼Œæ¯”é€»è¾‘å¯¼å‡ºå¿«å‡ åå€
- **ğŸ’¾ èŠ‚çœå­˜å‚¨**ï¼šæ”¯æŒå¢é‡å¤‡ä»½ï¼Œåªå¤‡ä»½å˜åŒ–çš„æ•°æ®
- **ğŸ”’ æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¯ XtraBackupæœ€ä½³ä½¿ç”¨åœºæ™¯      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… å¤§å‹ç”Ÿäº§æ•°æ®åº“ï¼ˆ100GB+ï¼‰     â”‚
â”‚ âœ… 7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡          â”‚
â”‚ âœ… å¯¹å¤‡ä»½é€Ÿåº¦è¦æ±‚é«˜            â”‚
â”‚ âœ… éœ€è¦å¢é‡å¤‡ä»½èŠ‚çœç©ºé—´        â”‚
â”‚ âœ… å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸¥æ ¼        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ ä¸é€‚ç”¨çš„åœºæ™¯                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ å°å‹æ•°æ®åº“ï¼ˆ<10GBï¼‰         â”‚
â”‚ âŒ å¯ä»¥æ¥å—åœæœºçš„åœºæ™¯          â”‚
â”‚ âŒ åªéœ€è¦éƒ¨åˆ†è¡¨å¤‡ä»½            â”‚
â”‚ âŒ è·¨ä¸åŒMySQLç‰ˆæœ¬æ¢å¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”¥ çƒ­å¤‡ä»½åŸç†æ·±åº¦è§£æ


### 2.1 ä»€ä¹ˆæ˜¯çƒ­å¤‡ä»½


**çƒ­å¤‡ä»½**å°±åƒç»™ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„æœºå™¨æ‹ç…§ï¼Œè¿™ä¸ªæœºå™¨åœ¨æ‹ç…§è¿‡ç¨‹ä¸­è¿˜åœ¨ä¸æ–­å·¥ä½œå’Œå˜åŒ–ã€‚å…³é”®æ˜¯è¦ä¿è¯æ‹å‡ºæ¥çš„ç…§ç‰‡æ˜¯å®Œæ•´ã€æ¸…æ™°ã€æ²¡æœ‰æ¨¡ç³Šçš„ã€‚

```
çƒ­å¤‡ä»½çš„æŒ‘æˆ˜ï¼š
æ—¶é—´ç‚¹1: [æ•°æ®A] [æ•°æ®B] [æ•°æ®C]  â† å¼€å§‹å¤‡ä»½
æ—¶é—´ç‚¹2: [æ•°æ®A'] [æ•°æ®B] [æ•°æ®C'] â† æ•°æ®åœ¨å˜åŒ–
æ—¶é—´ç‚¹3: [æ•°æ®A'] [æ•°æ®B'] [æ•°æ®C'] â† å¤‡ä»½å®Œæˆ

é—®é¢˜ï¼šå¦‚ä½•ä¿è¯å¤‡ä»½çš„æ•°æ®æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§ï¼Ÿ
```

### 2.2 InnoDBå­˜å‚¨å¼•æ“çš„MVCCæœºåˆ¶


**MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰**æ˜¯çƒ­å¤‡ä»½çš„åŸºç¡€ï¼š

> ğŸ“Œ **ç®€å•ç†è§£**ï¼šå°±åƒé“¶è¡Œçš„æµæ°´è´¦ï¼Œæ¯æ¬¡äº¤æ˜“éƒ½æœ‰ç‰ˆæœ¬å·ï¼Œå¯ä»¥æŸ¥çœ‹ä»»æ„æ—¶é—´ç‚¹çš„è´¦æˆ·çŠ¶æ€

```
MVCCå·¥ä½œåŸç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹åŠ¡1: SELECT * FROM users;            â”‚ â† çœ‹åˆ°ç‰ˆæœ¬1çš„æ•°æ®
â”‚ äº‹åŠ¡2: UPDATE users SET name='æ–°åå­—'; â”‚ â† åˆ›å»ºç‰ˆæœ¬2
â”‚ äº‹åŠ¡1: SELECT * FROM users;            â”‚ â† ä»ç„¶çœ‹åˆ°ç‰ˆæœ¬1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

XtraBackupåˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼š
- å¼€å§‹æ—¶è®°å½•LSNï¼ˆæ—¥å¿—åºå·ï¼‰
- å¤åˆ¶æ•°æ®æ–‡ä»¶æ—¶çœ‹åˆ°ä¸€è‡´çš„å¿«ç…§
- åŒæ—¶è®°å½•å¢é‡æ—¥å¿—å˜åŒ–
```

### 2.3 LSNï¼ˆæ—¥å¿—åºåˆ—å·ï¼‰çš„ä½œç”¨


**LSN**å°±åƒæ˜¯æ•°æ®åº“çš„"æ—¶é—´æˆ³"ï¼Œæ¯ä¸ªå˜æ›´éƒ½æœ‰å”¯ä¸€çš„ç¼–å·ï¼š

```
LSNå·¥ä½œç¤ºä¾‹ï¼š
LSN 1000: åˆ›å»ºç”¨æˆ·å¼ ä¸‰
LSN 1001: åˆ›å»ºç”¨æˆ·æå››  
LSN 1002: åˆ é™¤ç”¨æˆ·ç‹äº”
LSN 1003: ä¿®æ”¹ç”¨æˆ·èµµå…­

å¤‡ä»½è¿‡ç¨‹ï¼š
å¼€å§‹å¤‡ä»½æ—¶LSN = 1001
â”œâ”€ å¤åˆ¶æ•°æ®æ–‡ä»¶ï¼ˆçœ‹åˆ°LSN 1001æ—¶çš„çŠ¶æ€ï¼‰
â”œâ”€ åŒæ—¶è®°å½•1002ã€1003çš„å˜æ›´æ—¥å¿—
â””â”€ æœ€ååº”ç”¨å¢é‡æ—¥å¿—ï¼Œä¿è¯æ•°æ®å®Œæ•´
```

### 2.4 çƒ­å¤‡ä»½çš„ä¸‰ä¸ªé˜¶æ®µ


```
XtraBackupçƒ­å¤‡ä»½æµç¨‹ï¼š

é˜¶æ®µ1: ğŸ“· æ‹æ‘„å¿«ç…§
â”œâ”€ è®°å½•å½“å‰LSNä½ç½®
â”œâ”€ å¯åŠ¨åå°å¤åˆ¶è¿›ç¨‹
â””â”€ å¼€å§‹å¤åˆ¶InnoDBæ•°æ®æ–‡ä»¶

é˜¶æ®µ2: ğŸ“ è·Ÿè¸ªå˜åŒ–  
â”œâ”€ æŒç»­ç›‘æ§redo log
â”œâ”€ è®°å½•æ‰€æœ‰æ•°æ®å˜æ›´
â””â”€ ç¡®ä¿ä¸ä¸¢å¤±ä»»ä½•ä¿®æ”¹

é˜¶æ®µ3: ğŸ”„ ä¸€è‡´æ€§å¤„ç†
â”œâ”€ å®Œæˆæ•°æ®æ–‡ä»¶å¤åˆ¶
â”œâ”€ åº”ç”¨å¢é‡redo log
â””â”€ ç”Ÿæˆä¸€è‡´æ€§å¤‡ä»½
```

---

## 3. ğŸ’¾ ç‰©ç†å¤‡ä»½æœºåˆ¶è¯¦è§£


### 3.1 ç‰©ç†å¤‡ä»½ vs é€»è¾‘å¤‡ä»½


**ç‰©ç†å¤‡ä»½**å°±åƒå¤åˆ¶æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œ**é€»è¾‘å¤‡ä»½**å°±åƒæŠŠå†…å®¹é‡æ–°å†™ä¸€éï¼š

```
ç‰©ç†å¤‡ä»½ï¼ˆXtraBackupï¼‰ï¼š
åŸå§‹æ–‡ä»¶: user.ibd (1GB)
    â†“
ç›´æ¥å¤åˆ¶: user.ibd (1GB) â† é€Ÿåº¦å¿«ï¼Œæ ¼å¼ä¸å˜

é€»è¾‘å¤‡ä»½ï¼ˆmysqldumpï¼‰ï¼š
åŸå§‹æ–‡ä»¶: user.ibd (1GB)
    â†“
è¯»å–æ•°æ®: SELECT * FROM user
    â†“
ç”ŸæˆSQL: INSERT INTO user VALUES(...)
    â†“  
è¾“å‡ºæ–‡ä»¶: user.sql (1.2GB) â† é€Ÿåº¦æ…¢ï¼Œéœ€è¦é‡æ–°è§£æ
```

### 3.2 InnoDBæ–‡ä»¶ç»“æ„


**InnoDBçš„æ–‡ä»¶ç»„ç»‡**ï¼š

```
MySQLæ•°æ®ç›®å½•ç»“æ„ï¼š
/var/lib/mysql/
â”œâ”€â”€ ibdata1              â† ç³»ç»Ÿè¡¨ç©ºé—´ï¼ˆå…±äº«ï¼‰
â”œâ”€â”€ ib_logfile0         â† redoæ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ ib_logfile1         â† redoæ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ mysql/              â† ç³»ç»Ÿæ•°æ®åº“
â”œâ”€â”€ test_db/           â† ä¸šåŠ¡æ•°æ®åº“
â”‚   â”œâ”€â”€ user.frm       â† è¡¨ç»“æ„å®šä¹‰
â”‚   â”œâ”€â”€ user.ibd       â† è¡¨æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ order.ibd      â† è¡¨æ•°æ®æ–‡ä»¶
â””â”€â”€ performance_schema/ â† æ€§èƒ½ç›‘æ§åº“
```

### 3.3 ç‰©ç†å¤‡ä»½çš„å¤åˆ¶ç­–ç•¥


**XtraBackupå¦‚ä½•æ™ºèƒ½å¤åˆ¶**ï¼š

```bash
# åŸºæœ¬å¤‡ä»½å‘½ä»¤
xtrabackup --backup --target-dir=/backup/full_backup

# XtraBackupå†…éƒ¨åšäº†ä»€ä¹ˆï¼š
# 1. æ‰«ææ•°æ®ç›®å½•ï¼Œè¯†åˆ«éœ€è¦å¤‡ä»½çš„æ–‡ä»¶
# 2. æŒ‰ä¼˜å…ˆçº§å¤åˆ¶æ–‡ä»¶
# 3. å¤„ç†ä¸åŒç±»å‹æ–‡ä»¶çš„ç‰¹æ®Šéœ€æ±‚
```

**æ–‡ä»¶å¤åˆ¶ä¼˜å…ˆçº§**ï¼š

```
é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¤åˆ¶ï¼‰ï¼š
â”œâ”€ ç³»ç»Ÿè¡¨ç©ºé—´ ibdata1
â”œâ”€ redoæ—¥å¿—æ–‡ä»¶ ib_logfile*
â””â”€ æ•°æ®å­—å…¸æ–‡ä»¶ *.frm

ä¸­ä¼˜å…ˆçº§ï¼ˆå¹¶è¡Œå¤åˆ¶ï¼‰ï¼š
â”œâ”€ å¤§è¡¨æ•°æ®æ–‡ä»¶ *.ibd
â””â”€ ç´¢å¼•æ–‡ä»¶

ä½ä¼˜å…ˆçº§ï¼ˆæœ€åå¤„ç†ï¼‰ï¼š
â”œâ”€ ä¸´æ—¶æ–‡ä»¶
â””â”€ éInnoDBå¼•æ“æ–‡ä»¶
```

### 3.4 é¡µé¢çº§å¤åˆ¶æœºåˆ¶


> ğŸ’¡ **å…³é”®ç†è§£**ï¼šXtraBackupä¸æ˜¯ç®€å•çš„æ–‡ä»¶å¤åˆ¶ï¼Œè€Œæ˜¯æŒ‰é¡µé¢ï¼ˆpageï¼‰æ™ºèƒ½å¤åˆ¶

```
InnoDBé¡µé¢ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡µé¢å¤´éƒ¨ä¿¡æ¯     â”‚ â† åŒ…å«LSNä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®é™…æ•°æ®å†…å®¹     â”‚ â† è¡¨è®°å½•æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¡µé¢å°¾éƒ¨æ ¡éªŒ     â”‚ â† æ•°æ®å®Œæ•´æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ™ºèƒ½å¤åˆ¶è¿‡ç¨‹ï¼š
1. è¯»å–é¡µé¢å¤´éƒ¨çš„LSN
2. åˆ¤æ–­é¡µé¢æ˜¯å¦éœ€è¦å¤åˆ¶
3. éªŒè¯é¡µé¢å®Œæ•´æ€§
4. å¤åˆ¶æœ‰æ•ˆé¡µé¢æ•°æ®
```

---

## 4. ğŸ“ˆ å¢é‡å¤‡ä»½ç­–ç•¥ä¸å®ç°


### 4.1 å¢é‡å¤‡ä»½åŸºæœ¬æ¦‚å¿µ


**å¢é‡å¤‡ä»½**å°±åƒæ‰‹æœºç…§ç‰‡çš„å¢é‡åŒæ­¥ï¼Œåªä¼ è¾“æ–°æ‹çš„ç…§ç‰‡ï¼Œä¸ç”¨æ¯æ¬¡éƒ½ä¼ å…¨éƒ¨ç…§ç‰‡ï¼š

```
å…¨é‡å¤‡ä»½ vs å¢é‡å¤‡ä»½ï¼š

ä¼ ç»Ÿå…¨é‡å¤‡ä»½ï¼ˆæ¯å¤©1TBï¼‰ï¼š
å‘¨ä¸€: å¤‡ä»½1TBæ•°æ® â”€â”€> å­˜å‚¨1TB
å‘¨äºŒ: å¤‡ä»½1TBæ•°æ® â”€â”€> å­˜å‚¨2TB  
å‘¨ä¸‰: å¤‡ä»½1TBæ•°æ® â”€â”€> å­˜å‚¨3TB
... ä¸€å‘¨å­˜å‚¨7TB

å¢é‡å¤‡ä»½ç­–ç•¥ï¼š
å‘¨ä¸€: å…¨é‡å¤‡ä»½1TB â”€â”€> å­˜å‚¨1TB
å‘¨äºŒ: å¢é‡å¤‡ä»½20GB â”€â”€> å­˜å‚¨1.02TB
å‘¨ä¸‰: å¢é‡å¤‡ä»½15GB â”€â”€> å­˜å‚¨1.035TB  
... ä¸€å‘¨å­˜å‚¨çº¦1.1TBï¼ˆèŠ‚çœ85%ç©ºé—´ï¼‰
```

### 4.2 LSNé©±åŠ¨çš„å¢é‡è¯†åˆ«


**XtraBackupå¦‚ä½•çŸ¥é“å“ªäº›æ•°æ®æ˜¯æ–°çš„**ï¼š

```
LSNå¢é‡è¯†åˆ«æœºåˆ¶ï¼š

ç¬¬ä¸€æ¬¡å…¨å¤‡ï¼ˆå‘¨ä¸€ï¼‰ï¼š
â”œâ”€ è®°å½•ç»“æŸLSN: 500000
â”œâ”€ å¤‡ä»½æ‰€æœ‰æ•°æ®é¡µé¢
â””â”€ åˆ›å»ºæ£€æŸ¥ç‚¹æ–‡ä»¶

ç¬¬ä¸€æ¬¡å¢å¤‡ï¼ˆå‘¨äºŒï¼‰ï¼š  
â”œâ”€ è¯»å–ä¸Šæ¬¡LSN: 500000
â”œâ”€ æ‰«æå½“å‰LSN: 520000
â”œâ”€ åªå¤‡ä»½LSN > 500000çš„é¡µé¢
â””â”€ æ›´æ–°æ£€æŸ¥ç‚¹LSN: 520000

ç¬¬äºŒæ¬¡å¢å¤‡ï¼ˆå‘¨ä¸‰ï¼‰ï¼š
â”œâ”€ è¯»å–ä¸Šæ¬¡LSN: 520000  
â”œâ”€ æ‰«æå½“å‰LSN: 535000
â”œâ”€ åªå¤‡ä»½LSN > 520000çš„é¡µé¢
â””â”€ æ›´æ–°æ£€æŸ¥ç‚¹LSN: 535000
```

### 4.3 å¢é‡å¤‡ä»½å®æˆ˜å‘½ä»¤


```bash
# 1. åˆ›å»ºå…¨é‡å¤‡ä»½åŸºçº¿
xtrabackup --backup \
  --target-dir=/backup/base \
  --datadir=/var/lib/mysql

# 2. åˆ›å»ºç¬¬ä¸€ä¸ªå¢é‡å¤‡ä»½
xtrabackup --backup \
  --target-dir=/backup/inc1 \
  --incremental-basedir=/backup/base \
  --datadir=/var/lib/mysql

# 3. åˆ›å»ºç¬¬äºŒä¸ªå¢é‡å¤‡ä»½  
xtrabackup --backup \
  --target-dir=/backup/inc2 \
  --incremental-basedir=/backup/inc1 \
  --datadir=/var/lib/mysql
```

### 4.4 å¢é‡å¤‡ä»½é“¾ç®¡ç†


```
å¢é‡å¤‡ä»½é“¾ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¨é‡å¤‡ä»½     â”‚â”€â”€â”€â–¶â”‚ å¢é‡å¤‡ä»½1   â”‚â”€â”€â”€â–¶â”‚ å¢é‡å¤‡ä»½2   â”‚
â”‚ (Base)      â”‚    â”‚ (Inc1)      â”‚    â”‚ (Inc2)      â”‚
â”‚ LSN: 0-500K â”‚    â”‚ LSN:500K-520Kâ”‚   â”‚ LSN:520K-535Kâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¢å¤æ—¶å¿…é¡»æŒ‰é¡ºåºï¼šBase â†’ Inc1 â†’ Inc2
```

> âš ï¸ **é‡è¦æé†’**ï¼šå¢é‡å¤‡ä»½æœ‰ä¾èµ–å…³ç³»ï¼Œä¸­é—´ä»»ä½•ä¸€ä¸ªå¤‡ä»½ä¸¢å¤±ï¼Œåé¢çš„å¤‡ä»½éƒ½æ— æ³•ä½¿ç”¨

**å¢é‡å¤‡ä»½æœ€ä½³å®è·µ**ï¼š

```
æ¨èç­–ç•¥ï¼ˆ7å¤©å‘¨æœŸï¼‰ï¼š
â”œâ”€ å‘¨æ—¥ï¼šåˆ›å»ºå…¨é‡å¤‡ä»½
â”œâ”€ å‘¨ä¸€ï¼šåŸºäºå‘¨æ—¥åˆ›å»ºå¢é‡å¤‡ä»½
â”œâ”€ å‘¨äºŒï¼šåŸºäºå‘¨ä¸€åˆ›å»ºå¢é‡å¤‡ä»½
â”œâ”€ ...
â””â”€ å‘¨å…­ï¼šåŸºäºå‘¨äº”åˆ›å»ºå¢é‡å¤‡ä»½

ä¼˜ç‚¹ï¼šæ¢å¤æœ€å¤šéœ€è¦7ä¸ªæ–‡ä»¶
ç¼ºç‚¹ï¼šè¶Šåˆ°åé¢æ¢å¤è¶Šæ…¢

æ›¿ä»£ç­–ç•¥ï¼ˆæ··åˆç­–ç•¥ï¼‰ï¼š
â”œâ”€ æ¯æœˆ1å·ï¼šå…¨é‡å¤‡ä»½
â”œâ”€ æ¯å‘¨æ—¥ï¼šåŸºäºå…¨é‡çš„å¢é‡å¤‡ä»½
â””â”€ æ¯å¤©ï¼šåŸºäºå½“å‘¨å‘¨æ—¥çš„å¢é‡å¤‡ä»½
```

---

## 5. âš¡ å¤‡ä»½æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 5.1 å½±å“å¤‡ä»½æ€§èƒ½çš„å…³é”®å› ç´ 


```
å¤‡ä»½æ€§èƒ½çš„ç“¶é¢ˆåˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ ç£ç›˜I/Oç“¶é¢ˆ (æœ€å¸¸è§)                â”‚
â”‚ â”œâ”€ æ•°æ®ç›˜è¯»å–é€Ÿåº¦                      â”‚  
â”‚ â”œâ”€ å¤‡ä»½ç›˜å†™å…¥é€Ÿåº¦                      â”‚
â”‚ â””â”€ ç½‘ç»œå­˜å‚¨çš„ä¼ è¾“é€Ÿåº¦                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ–¥ï¸ CPUå¤„ç†ç“¶é¢ˆ                        â”‚
â”‚ â”œâ”€ æ•°æ®å‹ç¼©å¤„ç†                        â”‚
â”‚ â”œâ”€ åŠ å¯†è§£å¯†è¿ç®—                        â”‚  
â”‚ â””â”€ æ ¡éªŒå’Œè®¡ç®—                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”„ å¹¶å‘å¤„ç†ç“¶é¢ˆ                        â”‚
â”‚ â”œâ”€ å¤‡ä»½çº¿ç¨‹æ•°é‡                        â”‚
â”‚ â”œâ”€ æ•°æ®åº“é”ç«äº‰                        â”‚
â”‚ â””â”€ å†…å­˜ç¼“å†²åŒºå¤§å°                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å¹¶è¡Œå¤‡ä»½çº¿ç¨‹ä¼˜åŒ–


**å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†**ï¼š

```bash
# åŸºæœ¬å¹¶è¡Œé…ç½®ï¼ˆ4ä¸ªçº¿ç¨‹ï¼‰
xtrabackup --backup \
  --parallel=4 \
  --target-dir=/backup/full

# é«˜çº§å¹¶è¡Œé…ç½®
xtrabackup --backup \
  --parallel=8 \            # 8ä¸ªå¹¶è¡Œçº¿ç¨‹
  --compress-threads=4 \    # 4ä¸ªå‹ç¼©çº¿ç¨‹  
  --encrypt-threads=2 \     # 2ä¸ªåŠ å¯†çº¿ç¨‹
  --target-dir=/backup/full
```

**çº¿ç¨‹æ•°é‡é€‰æ‹©åŸåˆ™**ï¼š

```
ç¡¬ä»¶é…ç½®å»ºè®®ï¼š
â”œâ”€ CPUæ ¸å¿ƒæ•° â‰¤ 4æ ¸ï¼šparallel=2-4
â”œâ”€ CPUæ ¸å¿ƒæ•° 4-8æ ¸ï¼šparallel=4-8  
â”œâ”€ CPUæ ¸å¿ƒæ•° â‰¥ 8æ ¸ï¼šparallel=8-16
â””â”€ SSDå­˜å‚¨ï¼šå¯é€‚å½“å¢åŠ çº¿ç¨‹æ•°

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
- çº¿ç¨‹è¿‡å¤šä¼šå¢åŠ CPUå¼€é”€
- ç½‘ç»œå­˜å‚¨è¦è€ƒè™‘å¸¦å®½é™åˆ¶
- ç”Ÿäº§ç¯å¢ƒé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡
```

### 5.3 I/Oæ€§èƒ½è°ƒä¼˜


```bash
# I/Oä¼˜åŒ–å‚æ•°é…ç½®
xtrabackup --backup \
  --read-buffer-size=10M \     # è¯»ç¼“å†²åŒºå¤§å°
  --compress \                 # å¯ç”¨å‹ç¼©å‡å°‘I/O
  --compress-chunk-size=64K \  # å‹ç¼©å—å¤§å°
  --target-dir=/backup/full

# ç³»ç»Ÿå±‚é¢I/Oä¼˜åŒ–
echo 'deadline' > /sys/block/sda/queue/scheduler  # I/Oè°ƒåº¦å™¨
echo 8192 > /sys/block/sda/queue/read_ahead_kb    # é¢„è¯»å¤§å°
```

### 5.4 ç½‘ç»œä¼ è¾“ä¼˜åŒ–


å¯¹äºè¿œç¨‹å¤‡ä»½çš„ç½‘ç»œä¼˜åŒ–ï¼š

```bash
# ä½¿ç”¨å‹ç¼©ä¼ è¾“
xtrabackup --backup \
  --compress \
  --stream=xbstream \
  --parallel=4 | \
  ssh user@backup-server \
  "xbstream -x -C /remote/backup/"

# ç½‘ç»œé™é€Ÿï¼ˆé¿å…å½±å“ä¸šåŠ¡ï¼‰
xtrabackup --backup \
  --throttle=100 \              # é™åˆ¶I/Oä¸º100 I/Oæ“ä½œ/ç§’
  --target-dir=/backup/full
```

### 5.5 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**å¤‡ä»½æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼š

```bash
# ç›‘æ§å¤‡ä»½è¿›åº¦å’Œæ€§èƒ½
xtrabackup --backup \
  --stats \                    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
  --print-progress \           # æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯  
  --target-dir=/backup/full

# è¾“å‡ºç¤ºä¾‹ï¼š
# [01] Copying ./ibdata1 to /backup/full/ibdata1
# [01] ...done
# [02] Copying ./mysql/user.MYD to /backup/full/mysql/user.MYD  
# Progress: 1024MB of 5120MB (20%) copied
```

---

## 6. ğŸ”„ å¹¶è¡Œå¤‡ä»½å¤„ç†æœºåˆ¶


### 6.1 å¹¶è¡Œå¤‡ä»½çš„å·¥ä½œåŸç†


**å¹¶è¡Œå¤‡ä»½**å°±åƒå¤šä¸ªäººåŒæ—¶æ¬å®¶ï¼Œæ¯ä¸ªäººè´Ÿè´£ä¸åŒçš„æˆ¿é—´ï¼Œæœ€ååˆå¹¶æˆå®Œæ•´çš„æ–°å®¶ï¼š

```
å•çº¿ç¨‹å¤‡ä»½ vs å¹¶è¡Œå¤‡ä»½ï¼š

å•çº¿ç¨‹ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
è¡¨1 â”€â”€â–¶ è¡¨2 â”€â”€â–¶ è¡¨3 â”€â”€â–¶ è¡¨4 â”€â”€â–¶ å®Œæˆ
      ä¸²è¡Œå¤„ç†ï¼Œé€Ÿåº¦æ…¢

å¹¶è¡Œå¤‡ä»½ï¼ˆXtraBackupï¼‰ï¼š
è¡¨1 â”€â”€â–¶ â”
è¡¨2 â”€â”€â–¶ â”œâ”€â–¶ æ±‡æ€» â”€â”€â–¶ å®Œæˆ
è¡¨3 â”€â”€â–¶ â”¤     å¹¶è¡Œå¤„ç†ï¼Œé€Ÿåº¦å¿«
è¡¨4 â”€â”€â–¶ â”˜
```

### 6.2 çº¿ç¨‹åˆ†å·¥æœºåˆ¶


```
XtraBackupå¹¶è¡Œçº¿ç¨‹åˆ†å·¥ï¼š

ä¸»çº¿ç¨‹ï¼ˆåè°ƒè€…ï¼‰ï¼š
â”œâ”€ æ‰«ææ•°æ®ç›®å½•ç»“æ„
â”œâ”€ åˆ†é…å·¥ä½œä»»åŠ¡ç»™å·¥ä½œçº¿ç¨‹  
â”œâ”€ ç›‘æ§å¤‡ä»½è¿›åº¦
â””â”€ å¤„ç†redoæ—¥å¿—

å·¥ä½œçº¿ç¨‹1ï¼š
â”œâ”€ è´Ÿè´£å¤§è¡¨Açš„æ•°æ®å¤åˆ¶
â””â”€ å¤„ç†ç›¸å…³ç´¢å¼•æ–‡ä»¶

å·¥ä½œçº¿ç¨‹2ï¼š  
â”œâ”€ è´Ÿè´£å¤§è¡¨Bçš„æ•°æ®å¤åˆ¶
â””â”€ å¤„ç†ç›¸å…³ç´¢å¼•æ–‡ä»¶

å·¥ä½œçº¿ç¨‹Nï¼š
â”œâ”€ è´Ÿè´£å‰©ä½™å°è¡¨å¤åˆ¶
â””â”€ å¤„ç†ç³»ç»Ÿè¡¨ç©ºé—´
```

### 6.3 ä»»åŠ¡åˆ†é…ç­–ç•¥


**XtraBackupå¦‚ä½•æ™ºèƒ½åˆ†é…ä»»åŠ¡**ï¼š

```
ä»»åŠ¡åˆ†é…ç®—æ³•ï¼š

1. æ–‡ä»¶å¤§å°ä¼˜å…ˆï¼š
   â”œâ”€ å¤§æ–‡ä»¶ï¼ˆ>100MBï¼‰ï¼šå•ç‹¬åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹
   â”œâ”€ ä¸­æ–‡ä»¶ï¼ˆ10-100MBï¼‰ï¼šå¯å¤šä¸ªæ–‡ä»¶åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹
   â””â”€ å°æ–‡ä»¶ï¼ˆ<10MBï¼‰ï¼šæ‰¹é‡åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹

2. è´Ÿè½½å‡è¡¡ï¼š
   â”œâ”€ ç›‘æ§å„çº¿ç¨‹å·¥ä½œè´Ÿè½½
   â”œâ”€ åŠ¨æ€è°ƒæ•´ä»»åŠ¡åˆ†é…
   â””â”€ é¿å…æŸäº›çº¿ç¨‹ç©ºé—²

3. ä¾èµ–å…³ç³»å¤„ç†ï¼š
   â”œâ”€ ä¼˜å…ˆå¤„ç†ç‹¬ç«‹æ–‡ä»¶
   â”œâ”€ æœ€åå¤„ç†æœ‰ä¾èµ–çš„æ–‡ä»¶
   â””â”€ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
```

### 6.4 å¹¶è¡Œå¤‡ä»½çš„åŒæ­¥æœºåˆ¶


```bash
# å¹¶è¡Œå¤‡ä»½é…ç½®ç¤ºä¾‹
xtrabackup --backup \
  --parallel=4 \              # 4ä¸ªå·¥ä½œçº¿ç¨‹
  --target-dir=/backup/full \
  --datadir=/var/lib/mysql

# å†…éƒ¨åŒæ­¥æœºåˆ¶ï¼š
# 1. æ‰€æœ‰çº¿ç¨‹ç­‰å¾…ä¸»çº¿ç¨‹å®Œæˆåˆå§‹åŒ–
# 2. å¹¶è¡Œå¤åˆ¶å„è‡ªè´Ÿè´£çš„æ–‡ä»¶  
# 3. åŒæ­¥ç‚¹ï¼šç­‰å¾…æ‰€æœ‰æ–‡ä»¶å¤åˆ¶å®Œæˆ
# 4. ä¸»çº¿ç¨‹å¤„ç†æœ€ç»ˆçš„ä¸€è‡´æ€§æ£€æŸ¥
```

### 6.5 å¹¶è¡Œåº¦è°ƒä¼˜å»ºè®®


```
å¹¶è¡Œåº¦é…ç½®æŒ‡å—ï¼š

ç¡¬ä»¶è¯„ä¼°ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CPUæ ¸å¿ƒæ•°       â”‚ æ¨èå¹¶è¡Œåº¦      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2-4æ ¸          â”‚ 2-4             â”‚
â”‚ 4-8æ ¸          â”‚ 4-8             â”‚  
â”‚ 8-16æ ¸         â”‚ 8-12            â”‚
â”‚ 16æ ¸+          â”‚ 12-16           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­˜å‚¨ç±»å‹å½±å“ï¼š
â”œâ”€ ä¼ ç»ŸHDDï¼šå¹¶è¡Œåº¦é€‚ä¸­ï¼ˆ4-6ï¼‰
â”œâ”€ SSDå­˜å‚¨ï¼šå¹¶è¡Œåº¦å¯ä»¥è¾ƒé«˜ï¼ˆ8-12ï¼‰
â”œâ”€ NVMeå­˜å‚¨ï¼šå¹¶è¡Œåº¦å¯ä»¥å¾ˆé«˜ï¼ˆ12-16ï¼‰
â””â”€ ç½‘ç»œå­˜å‚¨ï¼šéœ€è€ƒè™‘å¸¦å®½é™åˆ¶

ç”Ÿäº§ç¯å¢ƒè€ƒé‡ï¼š
âš ï¸ é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸä½¿ç”¨é«˜å¹¶è¡Œåº¦
âš ï¸ ç›‘æ§å¯¹æ­£å¸¸ä¸šåŠ¡çš„å½±å“  
âš ï¸ é¢„ç•™è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æº
```

---

## 7. âœ… å¤‡ä»½éªŒè¯ä¸å®Œæ•´æ€§æ£€æŸ¥


### 7.1 ä¸ºä»€ä¹ˆå¤‡ä»½éªŒè¯å¾ˆé‡è¦


**å¤‡ä»½éªŒè¯**å°±åƒä¹°ä¿é™©åå®šæœŸæ£€æŸ¥ä¿å•æ˜¯å¦æœ‰æ•ˆï¼Œç¡®ä¿å…³é”®æ—¶åˆ»çœŸçš„èƒ½æ´¾ä¸Šç”¨åœºï¼š

> ğŸ“Š **ç»Ÿè®¡æ•°æ®**ï¼šçº¦30%çš„å¤‡ä»½åœ¨çœŸæ­£éœ€è¦æ¢å¤æ—¶å‘ç°æœ‰é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯ç¼ºå°‘éªŒè¯æœºåˆ¶

```
å¤‡ä»½å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š
â”œâ”€ ğŸ”´ æ–‡ä»¶æŸåï¼šä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®é”™è¯¯
â”œâ”€ ğŸ”´ ä¸å®Œæ•´ï¼šå¤‡ä»½è¿‡ç¨‹ä¸­æ–­å¯¼è‡´æ–‡ä»¶ç¼ºå¤±  
â”œâ”€ ğŸ”´ ä¸ä¸€è‡´ï¼šå¤‡ä»½æœŸé—´æ•°æ®å˜æ›´å¤„ç†é”™è¯¯
â”œâ”€ ğŸ”´ ç¯å¢ƒé—®é¢˜ï¼šç›®æ ‡ç¯å¢ƒä¸å…¼å®¹
â””â”€ ğŸ”´ æƒé™é—®é¢˜ï¼šæ¢å¤æ—¶ç¼ºå°‘å¿…è¦æƒé™
```

### 7.2 XtraBackupå†…ç½®éªŒè¯æœºåˆ¶


```bash
# 1. å¤‡ä»½æ—¶å¯ç”¨æ ¡éªŒ
xtrabackup --backup \
  --checksum \              # å¯ç”¨æ ¡éªŒå’ŒéªŒè¯
  --target-dir=/backup/full

# 2. å‡†å¤‡é˜¶æ®µéªŒè¯
xtrabackup --prepare \
  --target-dir=/backup/full

# å‡†å¤‡é˜¶æ®µåšä»€ä¹ˆï¼š
# â”œâ”€ åº”ç”¨redoæ—¥å¿—ç¡®ä¿ä¸€è‡´æ€§
# â”œâ”€ å›æ»šæœªå®Œæˆçš„äº‹åŠ¡  
# â”œâ”€ éªŒè¯æ‰€æœ‰æ•°æ®æ–‡ä»¶å®Œæ•´æ€§
# â””â”€ ç”Ÿæˆæ¢å¤å°±ç»ªçš„å¤‡ä»½é›†
```

### 7.3 å¤šå±‚æ¬¡éªŒè¯ç­–ç•¥


```
å®Œæ•´çš„éªŒè¯ä½“ç³»ï¼š

Level 1 - æ–‡ä»¶çº§éªŒè¯ï¼š
â”œâ”€ æ ¡éªŒå’ŒéªŒè¯ï¼ˆCRC32/MD5ï¼‰
â”œâ”€ æ–‡ä»¶å¤§å°æ£€æŸ¥
â””â”€ æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

Level 2 - æ•°æ®çº§éªŒè¯ï¼š  
â”œâ”€ InnoDBé¡µé¢æ ¡éªŒ
â”œâ”€ ç´¢å¼•ä¸€è‡´æ€§æ£€æŸ¥
â””â”€ å¤–é”®çº¦æŸæ£€æŸ¥

Level 3 - é€»è¾‘éªŒè¯ï¼š
â”œâ”€ è¡¨ç»“æ„å®Œæ•´æ€§
â”œâ”€ æ•°æ®è®°å½•æ•°éªŒè¯
â””â”€ ä¸šåŠ¡é€»è¾‘æ£€æŸ¥

Level 4 - æ¢å¤éªŒè¯ï¼š
â”œâ”€ åœ¨æµ‹è¯•ç¯å¢ƒå®Œæ•´æ¢å¤
â”œâ”€ å¯åŠ¨MySQLæœåŠ¡éªŒè¯
â””â”€ æ‰§è¡Œå…³é”®ä¸šåŠ¡æŸ¥è¯¢
```

### 7.4 è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬


```bash
#!/bin/bash
# XtraBackupå¤‡ä»½éªŒè¯è„šæœ¬

BACKUP_DIR="/backup/full_$(date +%Y%m%d)"
LOG_FILE="/backup/logs/verify_$(date +%Y%m%d).log"

echo "å¼€å§‹å¤‡ä»½éªŒè¯: $(date)" >> $LOG_FILE

# 1. åŸºæœ¬æ–‡ä»¶æ£€æŸ¥
echo "æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§..." >> $LOG_FILE
if [ ! -f "$BACKUP_DIR/xtrabackup_info" ]; then
    echo "ERROR: å¤‡ä»½ä¿¡æ¯æ–‡ä»¶ç¼ºå¤±" >> $LOG_FILE
    exit 1
fi

# 2. å‡†å¤‡å¤‡ä»½ï¼ˆéªŒè¯æ•°æ®ä¸€è‡´æ€§ï¼‰
echo "æ‰§è¡Œå¤‡ä»½å‡†å¤‡å’ŒéªŒè¯..." >> $LOG_FILE
xtrabackup --prepare --target-dir=$BACKUP_DIR >> $LOG_FILE 2>&1

if [ $? -ne 0 ]; then
    echo "ERROR: å¤‡ä»½å‡†å¤‡å¤±è´¥ï¼Œæ•°æ®å¯èƒ½ä¸ä¸€è‡´" >> $LOG_FILE
    exit 1
fi

# 3. ç£ç›˜ç©ºé—´æ£€æŸ¥
echo "æ£€æŸ¥ç£ç›˜ç©ºé—´..." >> $LOG_FILE
BACKUP_SIZE=$(du -sh $BACKUP_DIR | cut -f1)
echo "å¤‡ä»½å¤§å°: $BACKUP_SIZE" >> $LOG_FILE

# 4. å‘é€éªŒè¯ç»“æœ
echo "å¤‡ä»½éªŒè¯å®Œæˆ: $(date)" >> $LOG_FILE
echo "éªŒè¯çŠ¶æ€: æˆåŠŸ" >> $LOG_FILE
```

### 7.5 æµ‹è¯•æ¢å¤éªŒè¯


**æœ€å¯é çš„éªŒè¯æ–¹å¼æ˜¯å®é™…æ¢å¤æµ‹è¯•**ï¼š

```bash
# æµ‹è¯•æ¢å¤è„šæœ¬
#!/bin/bash

# 1. åœæ­¢æµ‹è¯•MySQLå®ä¾‹
systemctl stop mysql-test

# 2. æ¸…ç©ºæµ‹è¯•æ•°æ®ç›®å½•  
rm -rf /var/lib/mysql-test/*

# 3. ä»å¤‡ä»½æ¢å¤æ•°æ®
xtrabackup --copy-back \
  --target-dir=/backup/full_20240912 \
  --datadir=/var/lib/mysql-test

# 4. ä¿®å¤æƒé™
chown -R mysql:mysql /var/lib/mysql-test

# 5. å¯åŠ¨æµ‹è¯•å®ä¾‹
systemctl start mysql-test

# 6. éªŒè¯æ•°æ®åº“å¯åŠ¨å’ŒåŸºæœ¬åŠŸèƒ½
mysql -u root -h 127.0.0.1 -P 3307 -e "SHOW DATABASES;"
```

### 7.6 ç›‘æ§å¤‡ä»½è´¨é‡æŒ‡æ ‡


```
å¤‡ä»½è´¨é‡KPIæŒ‡æ ‡ï¼š

æˆåŠŸç‡æŒ‡æ ‡ï¼š
â”œâ”€ å¤‡ä»½æˆåŠŸç‡ï¼šç›®æ ‡ > 99%
â”œâ”€ éªŒè¯é€šè¿‡ç‡ï¼šç›®æ ‡ > 98%  
â””â”€ æ¢å¤æˆåŠŸç‡ï¼šç›®æ ‡ > 99%

æ€§èƒ½æŒ‡æ ‡ï¼š
â”œâ”€ å¤‡ä»½å®Œæˆæ—¶é—´ï¼šç›‘æ§è¶‹åŠ¿å˜åŒ–
â”œâ”€ å¤‡ä»½æ–‡ä»¶å¤§å°ï¼šç›‘æ§å¢é•¿è¶‹åŠ¿
â””â”€ ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šCPUã€å†…å­˜ã€I/O

æ•°æ®è´¨é‡æŒ‡æ ‡ï¼š
â”œâ”€ æ•°æ®å®Œæ•´æ€§ï¼šæ ¡éªŒå’Œä¸€è‡´æ€§
â”œâ”€ å¤‡ä»½æ–°é²œåº¦ï¼šæœ€åå¤‡ä»½æ—¶é—´
â””â”€ æ¢å¤æ—¶é—´ç›®æ ‡ï¼šRTOè¾¾æˆç‡
```

---

## 8. ğŸ”’ å‹ç¼©ä¸åŠ å¯†å¤‡ä»½


### 8.1 å‹ç¼©å¤‡ä»½çš„åŸç†å’Œä¼˜åŠ¿


**å¤‡ä»½å‹ç¼©**å°±åƒæ‰“åŒ…è¡Œæç®±ï¼ŒæŠŠåŒæ ·çš„ä¸œè¥¿è£…åˆ°æ›´å°çš„ç©ºé—´é‡Œï¼š

```
å‹ç¼©å¤‡ä»½çš„å¥½å¤„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ å­˜å‚¨ç©ºé—´èŠ‚çœ 60-80%                  â”‚
â”‚ âš¡ ç½‘ç»œä¼ è¾“æ—¶é—´å‡å°‘ 50-70%              â”‚  
â”‚ ğŸ’° å­˜å‚¨æˆæœ¬é™ä½ï¼ˆç‰¹åˆ«æ˜¯äº‘å­˜å‚¨ï¼‰          â”‚
â”‚ ğŸ”„ å¤‡ä»½é€Ÿåº¦å¯èƒ½æå‡ï¼ˆI/Oå‡å°‘ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‹ç¼©æ•ˆæœç¤ºä¾‹ï¼š
åŸå§‹å¤‡ä»½: 100GB
â”œâ”€ ä½¿ç”¨å‹ç¼©: 25GB (75%å‹ç¼©ç‡)
â”œâ”€ ä¼ è¾“æ—¶é—´: ä»2å°æ—¶å‡å°‘åˆ°30åˆ†é’Ÿ  
â””â”€ å­˜å‚¨æˆæœ¬: èŠ‚çœ75%è´¹ç”¨
```

### 8.2 XtraBackupå‹ç¼©é…ç½®


```bash
# åŸºæœ¬å‹ç¼©å¤‡ä»½
xtrabackup --backup \
  --compress \                    # å¯ç”¨å‹ç¼©
  --target-dir=/backup/compressed

# é«˜çº§å‹ç¼©é…ç½®
xtrabackup --backup \
  --compress \                    # å¯ç”¨å‹ç¼©
  --compress-threads=4 \          # 4ä¸ªå‹ç¼©çº¿ç¨‹
  --compress-chunk-size=64K \     # å‹ç¼©å—å¤§å°
  --target-dir=/backup/compressed

# è§£å‹æ¢å¤
xtrabackup --decompress \
  --target-dir=/backup/compressed
```

### 8.3 å‹ç¼©ç®—æ³•é€‰æ‹©


```
å‹ç¼©ç®—æ³•å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‹ç¼©ç®—æ³•    â”‚ å‹ç¼©ç‡     â”‚ å‹ç¼©é€Ÿåº¦   â”‚ CPUæ¶ˆè€—      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ lz4 (é»˜è®¤)  â”‚ ä¸­ç­‰(50%)  â”‚ éå¸¸å¿«     â”‚ ä½           â”‚
â”‚ zlib        â”‚ é«˜(70%)    â”‚ ä¸­ç­‰       â”‚ ä¸­ç­‰         â”‚  
â”‚ lzma        â”‚ å¾ˆé«˜(80%)  â”‚ æ…¢         â”‚ é«˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€‰æ‹©å»ºè®®ï¼š
â”œâ”€ ç½‘ç»œå¸¦å®½å……è¶³ï¼šé€‰æ‹©lz4ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
â”œâ”€ å­˜å‚¨ç©ºé—´æœ‰é™ï¼šé€‰æ‹©lzmaï¼ˆå‹ç¼©ç‡ä¼˜å…ˆï¼‰  
â””â”€ å¹³è¡¡æ–¹æ¡ˆï¼šé€‰æ‹©zlibï¼ˆæ€§èƒ½å’Œå‹ç¼©ç‡å¹³è¡¡ï¼‰
```

### 8.4 åŠ å¯†å¤‡ä»½é…ç½®


**ä¸ºä»€ä¹ˆéœ€è¦åŠ å¯†å¤‡ä»½ï¼Ÿ**

> ğŸ” **å®‰å…¨è€ƒé‡**ï¼šå¤‡ä»½æ–‡ä»¶åŒ…å«å®Œæ•´çš„ä¸šåŠ¡æ•°æ®ï¼Œå¦‚æœæ³„éœ²åæœä¸¥é‡

```bash
# AESåŠ å¯†å¤‡ä»½
xtrabackup --backup \
  --encrypt=AES256 \              # AES256åŠ å¯†ç®—æ³•
  --encrypt-key-file=/etc/mysql/backup.key \  # å¯†é’¥æ–‡ä»¶
  --target-dir=/backup/encrypted

# ç”ŸæˆåŠ å¯†å¯†é’¥
openssl rand -base64 24 > /etc/mysql/backup.key
chmod 600 /etc/mysql/backup.key

# è§£å¯†æ¢å¤
xtrabackup --decrypt=AES256 \
  --encrypt-key-file=/etc/mysql/backup.key \
  --target-dir=/backup/encrypted
```

### 8.5 å‹ç¼©+åŠ å¯†ç»„åˆä½¿ç”¨


```bash
# å…ˆå‹ç¼©å†åŠ å¯†ï¼ˆæ¨èæ–¹å¼ï¼‰
xtrabackup --backup \
  --compress \                    # ç¬¬ä¸€æ­¥ï¼šå‹ç¼©æ•°æ®
  --encrypt=AES256 \              # ç¬¬äºŒæ­¥ï¼šåŠ å¯†å‹ç¼©åçš„æ•°æ®
  --encrypt-key-file=/etc/mysql/backup.key \
  --compress-threads=4 \          # å‹ç¼©çº¿ç¨‹æ•°
  --encrypt-threads=2 \           # åŠ å¯†çº¿ç¨‹æ•°  
  --target-dir=/backup/secure

# æ¢å¤æ—¶å…ˆè§£å¯†å†è§£å‹
xtrabackup --decrypt=AES256 \
  --encrypt-key-file=/etc/mysql/backup.key \
  --target-dir=/backup/secure

xtrabackup --decompress \
  --target-dir=/backup/secure
```

### 8.6 æ€§èƒ½ä¼˜åŒ–å»ºè®®


```
å‹ç¼©åŠ å¯†æ€§èƒ½è°ƒä¼˜ï¼š

CPUèµ„æºåˆ†é…ï¼š
â”œâ”€ æ€»CPUæ ¸å¿ƒæ•° â‰¥ 8æ ¸ï¼š
â”‚   â”œâ”€ å¤‡ä»½çº¿ç¨‹ï¼š4ä¸ª
â”‚   â”œâ”€ å‹ç¼©çº¿ç¨‹ï¼š2ä¸ª
â”‚   â””â”€ åŠ å¯†çº¿ç¨‹ï¼š2ä¸ª
â””â”€ æ€»CPUæ ¸å¿ƒæ•° < 8æ ¸ï¼šé€‚å½“å‡å°‘çº¿ç¨‹æ•°

I/Oä¼˜åŒ–ï¼š
â”œâ”€ å‹ç¼©å‡å°‘I/Oå†™å…¥é‡
â”œâ”€ ä½†å¢åŠ CPUè®¡ç®—å¼€é”€
â””â”€ éœ€è¦å¹³è¡¡CPUå’ŒI/Oèµ„æº

ç½‘ç»œä¼ è¾“ï¼š
â”œâ”€ å‹ç¼©+åŠ å¯†å¤§å¹…å‡å°‘ä¼ è¾“é‡
â”œâ”€ é€‚åˆè¿œç¨‹å¤‡ä»½åœºæ™¯
â””â”€ æ³¨æ„è§£å¯†æ—¶çš„å®‰å…¨æ€§
```

---

## 9. ğŸ¤– è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬è®¾è®¡


### 9.1 è‡ªåŠ¨åŒ–å¤‡ä»½çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨åŒ–ï¼Ÿ**äººå·¥å¤‡ä»½å°±åƒæ¯å¤©æ‰‹åŠ¨é—¹é’Ÿä¸€æ ·ä¸é è°±ï¼Œè€Œè‡ªåŠ¨åŒ–å°±åƒè®¾å®šå¥½çš„é—¹é’Ÿï¼Œé£é›¨æ— é˜»ã€‚

```
äººå·¥å¤‡ä»½ vs è‡ªåŠ¨åŒ–å¤‡ä»½ï¼š

äººå·¥å¤‡ä»½é—®é¢˜ï¼š
â”œâ”€ ğŸ˜´ å¿˜è®°æ‰§è¡Œå¤‡ä»½
â”œâ”€ ğŸ• æ—¶é—´ä¸å›ºå®š  
â”œâ”€ ğŸ˜µ é…ç½®å‚æ•°è®°å¿†é”™è¯¯
â”œâ”€ ğŸ“ å¤‡ä»½æ–‡ä»¶å‘½åæ··ä¹±
â””â”€ âŒ ç¼ºå°‘é”™è¯¯å¤„ç†

è‡ªåŠ¨åŒ–å¤‡ä»½ä¼˜åŠ¿ï¼š
â”œâ”€ â° å®šæ—¶è‡ªåŠ¨æ‰§è¡Œ
â”œâ”€ ğŸ¯ å‚æ•°é…ç½®æ ‡å‡†åŒ–
â”œâ”€ ğŸ“Š å®Œæ•´çš„æ—¥å¿—è®°å½•
â”œâ”€ ğŸ“§ è‡ªåŠ¨é”™è¯¯é€šçŸ¥
â””â”€ ğŸ”„ æ”¯æŒé‡è¯•æœºåˆ¶
```

### 9.2 å®Œæ•´çš„è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬


```bash
#!/bin/bash
# XtraBackupè‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬
# ä½œè€…ï¼šæ•°æ®åº“ç®¡ç†å‘˜
# ç‰ˆæœ¬ï¼š2.0

# ===== é…ç½®å‚æ•° =====
MYSQL_USER="backup_user"
MYSQL_PASSWORD="secure_password"  
BACKUP_BASE_DIR="/backup"
LOG_DIR="/backup/logs"
RETENTION_DAYS=7                    # ä¿ç•™å¤©æ•°
PARALLEL_THREADS=4                  # å¹¶è¡Œçº¿ç¨‹æ•°

# åŠ¨æ€å˜é‡
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="$BACKUP_BASE_DIR/full_$DATE"
LOG_FILE="$LOG_DIR/backup_$DATE.log"

# ===== å‡½æ•°å®šä¹‰ =====

# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local required_space=$1
    local available_space=$(df $BACKUP_BASE_DIR | awk 'NR==2 {print $4}')
    
    if [ $available_space -lt $required_space ]; then
        log_message "ERROR: ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦${required_space}KBï¼Œå¯ç”¨${available_space}KB"
        send_alert "å¤‡ä»½å¤±è´¥ï¼šç£ç›˜ç©ºé—´ä¸è¶³"
        exit 1
    fi
    
    log_message "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡ï¼šå¯ç”¨${available_space}KB"
}

# å‘é€å‘Šè­¦é€šçŸ¥
send_alert() {
    local message=$1
    # é‚®ä»¶é€šçŸ¥
    echo "$message" | mail -s "XtraBackup Alert" admin@company.com
    # é’‰é’‰/å¾®ä¿¡é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    # curl -X POST "https://api.webhook.com" -d "message=$message"
}

# æ¸…ç†è¿‡æœŸå¤‡ä»½
cleanup_old_backups() {
    log_message "å¼€å§‹æ¸…ç†${RETENTION_DAYS}å¤©å‰çš„å¤‡ä»½æ–‡ä»¶..."
    find $BACKUP_BASE_DIR -name "full_*" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \;
    find $LOG_DIR -name "backup_*.log" -mtime +$RETENTION_DAYS -delete
    log_message "è¿‡æœŸå¤‡ä»½æ¸…ç†å®Œæˆ"
}

# ===== ä¸»è¦å¤‡ä»½é€»è¾‘ =====

main_backup() {
    log_message "å¼€å§‹XtraBackupå…¨é‡å¤‡ä»½..."
    
    # 1. é¢„æ£€æŸ¥
    check_disk_space 10485760  # æ£€æŸ¥10GBå¯ç”¨ç©ºé—´
    
    # 2. åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p $BACKUP_DIR
    mkdir -p $LOG_DIR
    
    # 3. æ‰§è¡Œå¤‡ä»½
    log_message "å¤‡ä»½å‚æ•°ï¼šå¹¶è¡Œåº¦=$PARALLEL_THREADSï¼Œç›®æ ‡ç›®å½•=$BACKUP_DIR"
    
    xtrabackup --backup \
        --user=$MYSQL_USER \
        --password=$MYSQL_PASSWORD \
        --parallel=$PARALLEL_THREADS \
        --compress \
        --target-dir=$BACKUP_DIR \
        --datadir=/var/lib/mysql 2>&1 | tee -a $LOG_FILE
    
    # 4. æ£€æŸ¥å¤‡ä»½ç»“æœ
    if [ ${PIPESTATUS[0]} -eq 0 ]; then
        log_message "âœ… å¤‡ä»½æ‰§è¡ŒæˆåŠŸ"
        
        # 5. å¤‡ä»½éªŒè¯
        log_message "å¼€å§‹å¤‡ä»½éªŒè¯..."
        xtrabackup --prepare --target-dir=$BACKUP_DIR 2>&1 | tee -a $LOG_FILE
        
        if [ $? -eq 0 ]; then
            log_message "âœ… å¤‡ä»½éªŒè¯æˆåŠŸ"
            
            # 6. è®°å½•å¤‡ä»½ä¿¡æ¯
            BACKUP_SIZE=$(du -sh $BACKUP_DIR | cut -f1)
            log_message "å¤‡ä»½å®Œæˆï¼šå¤§å°=$BACKUP_SIZE"
            
            # 7. æ¸…ç†è¿‡æœŸå¤‡ä»½
            cleanup_old_backups
            
            return 0
        else
            log_message "âŒ å¤‡ä»½éªŒè¯å¤±è´¥"
            send_alert "å¤‡ä»½éªŒè¯å¤±è´¥ï¼š$BACKUP_DIR"
            return 1
        fi
    else
        log_message "âŒ å¤‡ä»½æ‰§è¡Œå¤±è´¥"
        send_alert "å¤‡ä»½æ‰§è¡Œå¤±è´¥ï¼šæŸ¥çœ‹æ—¥å¿— $LOG_FILE"
        return 1
    fi
}

# ===== è„šæœ¬å…¥å£ =====
log_message "========== XtraBackupè‡ªåŠ¨å¤‡ä»½å¼€å§‹ =========="

# æ‰§è¡Œå¤‡ä»½
main_backup

if [ $? -eq 0 ]; then
    log_message "ğŸ‰ å¤‡ä»½ä»»åŠ¡å…¨éƒ¨å®Œæˆ"
else
    log_message "ğŸ’¥ å¤‡ä»½ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
fi

log_message "========== XtraBackupè‡ªåŠ¨å¤‡ä»½ç»“æŸ =========="
```

### 9.3 Crontabå®šæ—¶ä»»åŠ¡é…ç½®


```bash
# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e

# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå…¨é‡å¤‡ä»½
0 2 * * * /opt/scripts/xtrabackup_auto.sh >/dev/null 2>&1

# å·¥ä½œæ—¥æ¯6å°æ—¶æ‰§è¡Œå¢é‡å¤‡ä»½  
0 6,12,18 * * 1-5 /opt/scripts/xtrabackup_incremental.sh

# æ¯å‘¨æ—¥æ‰§è¡Œå¤‡ä»½æ–‡ä»¶å½’æ¡£
0 4 * * 0 /opt/scripts/backup_archive.sh
```

### 9.4 ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶


```bash
# å¤‡ä»½çŠ¶æ€ç›‘æ§è„šæœ¬
#!/bin/bash
# æ£€æŸ¥æœ€è¿‘24å°æ—¶å†…æ˜¯å¦æœ‰æˆåŠŸçš„å¤‡ä»½

LAST_BACKUP=$(find /backup -name "full_*" -type d -mtime -1 | wc -l)

if [ $LAST_BACKUP -eq 0 ]; then
    echo "WARNING: 24å°æ—¶å†…æ²¡æœ‰å‘ç°æ–°çš„å¤‡ä»½æ–‡ä»¶"
    # å‘é€å‘Šè­¦
    echo "å¤‡ä»½å¼‚å¸¸ï¼š24å°æ—¶å†…æ²¡æœ‰æ–°å¤‡ä»½" | \
    mail -s "Backup Alert" admin@company.com
else
    echo "OK: å‘ç° $LAST_BACKUP ä¸ªæœ€è¿‘çš„å¤‡ä»½"
fi

# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å¤§å°å¼‚å¸¸
LATEST_BACKUP=$(ls -td /backup/full_* | head -1)
if [ -n "$LATEST_BACKUP" ]; then
    BACKUP_SIZE=$(du -s $LATEST_BACKUP | awk '{print $1}')
    # å¦‚æœå¤‡ä»½æ–‡ä»¶å°äºé¢„æœŸå¤§å°ï¼ˆæ¯”å¦‚å°äº1GBï¼‰ï¼Œå‘å‡ºå‘Šè­¦
    if [ $BACKUP_SIZE -lt 1048576 ]; then
        echo "WARNING: å¤‡ä»½æ–‡ä»¶å¤§å°å¼‚å¸¸ï¼Œå¯èƒ½å¤‡ä»½ä¸å®Œæ•´"
    fi
fi
```

---

## 10. ğŸ“Š å¤‡ä»½ç›‘æ§ä¸å‘Šè­¦æœºåˆ¶


### 10.1 ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½ç›‘æ§


**å¤‡ä»½ç›‘æ§**å°±åƒåŒ»é™¢çš„ç—…äººç›‘æŠ¤ä»ªï¼Œæ—¶åˆ»å…³æ³¨"ç—…äºº"ï¼ˆå¤‡ä»½ç³»ç»Ÿï¼‰çš„"ç”Ÿå‘½ä½“å¾"ï¼š

```
æ²¡æœ‰ç›‘æ§çš„é£é™©ï¼š
â”œâ”€ ğŸ˜± å¤‡ä»½é™é»˜å¤±è´¥ï¼Œæ•°æ®ä¸¢å¤±æ—¶æ‰å‘ç°
â”œâ”€ ğŸ“ˆ å¤‡ä»½æ–‡ä»¶å¼‚å¸¸å¢å¤§ï¼Œç£ç›˜ç©ºé—´è€—å°½  
â”œâ”€ â° å¤‡ä»½æ—¶é—´è¿‡é•¿ï¼Œå½±å“ä¸šåŠ¡æ€§èƒ½
â”œâ”€ ğŸ’¾ å¤‡ä»½è´¨é‡ä¸‹é™ï¼Œæ¢å¤æ—¶å‡ºç°é—®é¢˜
â””â”€ ğŸ”„ å¤‡ä»½è„šæœ¬é”™è¯¯ï¼Œé•¿æœŸæœªæ‰§è¡Œ

ç›‘æ§çš„ä»·å€¼ï¼š
â”œâ”€ ğŸš¨ å®æ—¶å‘ç°é—®é¢˜ï¼ŒåŠæ—¶å¤„ç†
â”œâ”€ ğŸ“Š æ€§èƒ½è¶‹åŠ¿åˆ†æï¼Œé¢„é˜²é—®é¢˜
â”œâ”€ ğŸ“‹ åˆè§„æ€§æ£€æŸ¥ï¼Œæ»¡è¶³å®¡è®¡è¦æ±‚  
â””â”€ ğŸ¯ ä¼˜åŒ–å¤‡ä»½ç­–ç•¥ï¼Œæå‡æ•ˆç‡
```

### 10.2 å…³é”®ç›‘æ§æŒ‡æ ‡


```
æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼š

1. å¯ç”¨æ€§æŒ‡æ ‡ (SLAç›¸å…³)ï¼š
â”œâ”€ å¤‡ä»½æˆåŠŸç‡ï¼šâ‰¥ 99%
â”œâ”€ éªŒè¯é€šè¿‡ç‡ï¼šâ‰¥ 98%  
â”œâ”€ æŒ‰æ—¶å®Œæˆç‡ï¼šâ‰¥ 95%
â””â”€ æ¢å¤æˆåŠŸç‡ï¼šâ‰¥ 99%

2. æ€§èƒ½æŒ‡æ ‡ (æ•ˆç‡ç›¸å…³)ï¼š
â”œâ”€ å¤‡ä»½å®Œæˆæ—¶é—´ï¼šç›‘æ§è¶‹åŠ¿
â”œâ”€ å¤‡ä»½ä¼ è¾“é€Ÿåº¦ï¼šMB/s
â”œâ”€ ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼šCPUã€å†…å­˜ã€I/O
â””â”€ å‹ç¼©æ¯”ç‡ï¼šç©ºé—´èŠ‚çœæ•ˆæœ

3. å®¹é‡æŒ‡æ ‡ (èµ„æºç›¸å…³)ï¼š  
â”œâ”€ å¤‡ä»½æ–‡ä»¶å¤§å°ï¼šå¢é•¿è¶‹åŠ¿
â”œâ”€ ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ï¼š< 80%
â”œâ”€ ä¿ç•™å¤‡ä»½æ•°é‡ï¼šç¬¦åˆç­–ç•¥
â””â”€ ç½‘ç»œå¸¦å®½å ç”¨ï¼š< 50%

4. è´¨é‡æŒ‡æ ‡ (æ•°æ®ç›¸å…³)ï¼š
â”œâ”€ æ•°æ®å®Œæ•´æ€§ï¼šæ ¡éªŒå’Œä¸€è‡´
â”œâ”€ å¤‡ä»½æ–°é²œåº¦ï¼š< 24å°æ—¶
â”œâ”€ LSNè¿ç»­æ€§ï¼šå¢é‡å¤‡ä»½é“¾
â””â”€ æµ‹è¯•æ¢å¤é¢‘ç‡ï¼šâ‰¥ 1æ¬¡/æœˆ
```

### 10.3 ç›‘æ§ç³»ç»Ÿå®ç°


**åŸºäºZabbixçš„ç›‘æ§é…ç½®**ï¼š

```bash
# XtraBackupç›‘æ§è„šæœ¬ - Zabbix Agent
#!/bin/bash
# æ–‡ä»¶è·¯å¾„ï¼š/etc/zabbix/scripts/check_xtrabackup.sh

case $1 in
    "backup_success_rate")
        # æ£€æŸ¥æœ€è¿‘7å¤©å¤‡ä»½æˆåŠŸç‡
        TOTAL=$(find /backup/logs -name "backup_*.log" -mtime -7 | wc -l)
        SUCCESS=$(find /backup/logs -name "backup_*.log" -mtime -7 -exec grep -l "å¤‡ä»½å®Œæˆ" {} \; | wc -l)
        if [ $TOTAL -gt 0 ]; then
            echo "scale=2; $SUCCESS * 100 / $TOTAL" | bc
        else
            echo "0"
        fi
        ;;
    "last_backup_size")
        # æœ€è¿‘ä¸€æ¬¡å¤‡ä»½å¤§å°ï¼ˆKBï¼‰
        LATEST_BACKUP=$(ls -td /backup/full_* 2>/dev/null | head -1)
        if [ -n "$LATEST_BACKUP" ]; then
            du -s $LATEST_BACKUP | awk '{print $1}'
        else
            echo "0"
        fi
        ;;
    "backup_duration")
        # æœ€è¿‘ä¸€æ¬¡å¤‡ä»½è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰
        LATEST_LOG=$(ls -t /backup/logs/backup_*.log 2>/dev/null | head -1)
        if [ -n "$LATEST_LOG" ]; then
            START=$(grep "å¤‡ä»½å¼€å§‹" $LATEST_LOG | head -1 | awk '{print $1" "$2}')
            END=$(grep "å¤‡ä»½å®Œæˆ" $LATEST_LOG | tail -1 | awk '{print $1" "$2}')
            if [ -n "$START" ] && [ -n "$END" ]; then
                START_SEC=$(date -d "$START" +%s)
                END_SEC=$(date -d "$END" +%s)
                echo $(( ($END_SEC - $START_SEC) / 60 ))
            else
                echo "0"
            fi
        else
            echo "0"
        fi
        ;;
    "disk_usage_percent")
        # å¤‡ä»½ç£ç›˜ä½¿ç”¨ç‡
        df /backup | awk 'NR==2 {print $5}' | tr -d '%'
        ;;
esac
```

**Zabbixæ¨¡æ¿é…ç½®**ï¼š

```xml
<!-- XtraBackupç›‘æ§æ¨¡æ¿ -->
<items>
    <item>
        <name>XtraBackup - å¤‡ä»½æˆåŠŸç‡</name>
        <key>system.run[/etc/zabbix/scripts/check_xtrabackup.sh backup_success_rate]</key>
        <delay>1h</delay>
        <value_type>FLOAT</value_type>
        <units>%</units>
    </item>
    
    <item>
        <name>XtraBackup - æœ€åå¤‡ä»½å¤§å°</name>
        <key>system.run[/etc/zabbix/scripts/check_xtrabackup.sh last_backup_size]</key>
        <delay>1h</delay>
        <value_type>UINT64</value_type>
        <units>KB</units>
    </item>
</items>

<triggers>
    <trigger>
        <name>XtraBackupå¤‡ä»½æˆåŠŸç‡è¿‡ä½</name>
        <expression>{host:system.run[/etc/zabbix/scripts/check_xtrabackup.sh backup_success_rate].last()}&lt;95</expression>
        <priority>HIGH</priority>
    </trigger>
</triggers>
```

### 10.4 å‘Šè­¦ç­–ç•¥è®¾è®¡


```
åˆ†çº§å‘Šè­¦ç­–ç•¥ï¼š

ğŸ”´ P1 - ç´§æ€¥å‘Šè­¦ï¼ˆç«‹å³å¤„ç†ï¼‰ï¼š
â”œâ”€ å¤‡ä»½è¿ç»­å¤±è´¥ > 2æ¬¡
â”œâ”€ ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ > 90%
â”œâ”€ 24å°æ—¶å†…æ— æˆåŠŸå¤‡ä»½
â””â”€ å¤‡ä»½æ–‡ä»¶æŸåæˆ–ç¼ºå¤±

ğŸŸ¡ P2 - é‡è¦å‘Šè­¦ï¼ˆ2å°æ—¶å†…å¤„ç†ï¼‰ï¼š
â”œâ”€ å¤‡ä»½æˆåŠŸç‡ < 95%  
â”œâ”€ å¤‡ä»½æ—¶é—´è¶…è¿‡é¢„æœŸ > 50%
â”œâ”€ ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡ > 80%
â””â”€ å¤‡ä»½æ–‡ä»¶å¤§å°å¼‚å¸¸å˜åŒ– > 30%

ğŸŸ¢ P3 - ä¸€èˆ¬å‘Šè­¦ï¼ˆ24å°æ—¶å†…å¤„ç†ï¼‰ï¼š
â”œâ”€ å¤‡ä»½æ€§èƒ½ä¸‹é™ > 20%
â”œâ”€ å‹ç¼©ç‡å¼‚å¸¸å˜åŒ–
â”œâ”€ ç³»ç»Ÿèµ„æºæ¶ˆè€—è¿‡é«˜
â””â”€ éå…³é”®ç»„ä»¶çŠ¶æ€å¼‚å¸¸
```

### 10.5 è‡ªåŠ¨åŒ–å‘Šè­¦è„šæœ¬


```bash
#!/bin/bash
# æ™ºèƒ½å‘Šè­¦è„šæœ¬
# æ–‡ä»¶ï¼š/opt/scripts/backup_alert.sh

# é…ç½®å‚æ•°
WEBHOOK_URL="https://hooks.slack.com/your/webhook"  # Slacké€šçŸ¥
EMAIL_TO="dba@company.com"                          # é‚®ä»¶é€šçŸ¥
PHONE_API="https://api.sms.com/send"               # çŸ­ä¿¡é€šçŸ¥

# å‘Šè­¦å‡½æ•°
send_alert() {
    local level=$1      # å‘Šè­¦çº§åˆ«ï¼šP1/P2/P3
    local title=$2      # å‘Šè­¦æ ‡é¢˜  
    local message=$3    # è¯¦ç»†ä¿¡æ¯
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # æ„é€ å‘Šè­¦ä¿¡æ¯
    local alert_msg="ğŸš¨ XtraBackupå‘Šè­¦
çº§åˆ«ï¼š$level
æ—¶é—´ï¼š$timestamp
æ ‡é¢˜ï¼š$title
è¯¦æƒ…ï¼š$message
æœåŠ¡å™¨ï¼š$(hostname -f)"

    case $level in
        "P1")
            # ç´§æ€¥å‘Šè­¦ï¼šé‚®ä»¶+çŸ­ä¿¡+IM
            echo "$alert_msg" | mail -s "ã€P1ç´§æ€¥ã€‘XtraBackupå‘Šè­¦" $EMAIL_TO
            # å‘é€çŸ­ä¿¡ï¼ˆéœ€è¦çŸ­ä¿¡APIï¼‰
            # curl -X POST $PHONE_API -d "message=$title"
            # å‘é€Slacké€šçŸ¥
            curl -X POST $WEBHOOK_URL \
                -H 'Content-type: application/json' \
                --data "{\"text\":\"$alert_msg\"}"
            ;;
        "P2")
            # é‡è¦å‘Šè­¦ï¼šé‚®ä»¶+IM  
            echo "$alert_msg" | mail -s "ã€P2é‡è¦ã€‘XtraBackupå‘Šè­¦" $EMAIL_TO
            curl -X POST $WEBHOOK_URL \
                -H 'Content-type: application/json' \
                --data "{\"text\":\"$alert_msg\"}"
            ;;
        "P3")
            # ä¸€èˆ¬å‘Šè­¦ï¼šä»…IMé€šçŸ¥
            curl -X POST $WEBHOOK_URL \
                -H 'Content-type: application/json' \
                --data "{\"text\":\"$alert_msg\"}"
            ;;
    esac
}

# æ£€æŸ¥å¤‡ä»½çŠ¶æ€
check_backup_status() {
    # æ£€æŸ¥æœ€è¿‘24å°æ—¶æ˜¯å¦æœ‰æˆåŠŸå¤‡ä»½
    local recent_success=$(find /backup -name "full_*" -type d -mtime -1 | wc -l)
    
    if [ $recent_success -eq 0 ]; then
        send_alert "P1" "24å°æ—¶å†…æ— æˆåŠŸå¤‡ä»½" "å¯èƒ½å­˜åœ¨å¤‡ä»½è„šæœ¬æ•…éšœæˆ–ç³»ç»Ÿé—®é¢˜"
    fi
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_usage=$(df /backup | awk 'NR==2 {print $5}' | tr -d '%')
    
    if [ $disk_usage -gt 90 ]; then
        send_alert "P1" "å¤‡ä»½ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³" "ä½¿ç”¨ç‡ï¼š${disk_usage}%ï¼Œè¯·ç«‹å³æ¸…ç†"
    elif [ $disk_usage -gt 80 ]; then
        send_alert "P2" "å¤‡ä»½ç£ç›˜ç©ºé—´ä¸è¶³" "ä½¿ç”¨ç‡ï¼š${disk_usage}%ï¼Œå»ºè®®æ¸…ç†è¿‡æœŸå¤‡ä»½"
    fi
}

# æ‰§è¡Œæ£€æŸ¥
check_backup_status
```

---

## 11. ğŸ”„ æ¢å¤æ“ä½œè¯¦ç»†æµç¨‹


### 11.1 æ¢å¤å‰çš„å‡†å¤‡å·¥ä½œ


**æ•°æ®æ¢å¤**å°±åƒåŒ»é™¢çš„æ€¥æ•‘æ‰‹æœ¯ï¼Œéœ€è¦å……åˆ†çš„å‡†å¤‡å’Œä¸¥æ ¼çš„æµç¨‹ï¼Œä¸èƒ½æœ‰ä»»ä½•ç–å¿½ï¼š

```
æ¢å¤å‰æ£€æŸ¥æ¸…å•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ å¿…è¦æ€§è¯„ä¼°                          â”‚
â”‚ â”œâ”€ ç¡®è®¤æ•°æ®ç¡®å®éœ€è¦æ¢å¤                â”‚
â”‚ â”œâ”€ è¯„ä¼°æ¢å¤çš„ä¸šåŠ¡å½±å“èŒƒå›´              â”‚
â”‚ â””â”€ è·å¾—ç›¸å…³è´Ÿè´£äººæˆæƒ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ¯ æ¢å¤ç›®æ ‡ç¡®è®¤                        â”‚
â”‚ â”œâ”€ ç¡®å®šæ¢å¤åˆ°å“ªä¸ªæ—¶é—´ç‚¹                â”‚
â”‚ â”œâ”€ ç¡®è®¤éœ€è¦æ¢å¤çš„æ•°æ®èŒƒå›´              â”‚
â”‚ â””â”€ æ˜ç¡®æ¢å¤åçš„æ•°æ®éªŒè¯æ ‡å‡†            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¾ å¤‡ä»½æ–‡ä»¶éªŒè¯                        â”‚
â”‚ â”œâ”€ æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§                  â”‚
â”‚ â”œâ”€ éªŒè¯å¤‡ä»½æ–‡ä»¶å¯ç”¨æ€§                  â”‚
â”‚ â””â”€ ç¡®è®¤å¢é‡å¤‡ä»½é“¾çš„è¿ç»­æ€§              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ–¥ï¸ ç¯å¢ƒå‡†å¤‡                          â”‚
â”‚ â”œâ”€ å‡†å¤‡è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´                  â”‚
â”‚ â”œâ”€ ç¡®è®¤MySQLç‰ˆæœ¬å…¼å®¹æ€§                â”‚
â”‚ â””â”€ å¤‡ä»½å½“å‰æ•°æ®ï¼ˆå¦‚æœæœ‰å¿…è¦ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.2 å®Œå…¨æ¢å¤æµç¨‹


**åœºæ™¯ï¼šæœåŠ¡å™¨ç¡¬ä»¶æ•…éšœï¼Œéœ€è¦å®Œæ•´æ¢å¤æ•°æ®åº“**

```bash
# æ­¥éª¤1ï¼šåœæ­¢MySQLæœåŠ¡
sudo systemctl stop mysql
sudo systemctl status mysql  # ç¡®è®¤å·²åœæ­¢

# æ­¥éª¤2ï¼šå¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆé¢„é˜²æªæ–½ï¼‰
sudo mv /var/lib/mysql /var/lib/mysql_backup_$(date +%Y%m%d_%H%M%S)

# æ­¥éª¤3ï¼šå‡†å¤‡æ¢å¤ç›®å½•
sudo mkdir -p /var/lib/mysql
sudo chown mysql:mysql /var/lib/mysql

# æ­¥éª¤4ï¼šæ¢å¤å…¨é‡å¤‡ä»½
echo "å¼€å§‹æ¢å¤å…¨é‡å¤‡ä»½..."
sudo xtrabackup --copy-back \
    --target-dir=/backup/full_20240912 \
    --datadir=/var/lib/mysql

# æ­¥éª¤5ï¼šä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R mysql:mysql /var/lib/mysql
sudo chmod -R 755 /var/lib/mysql

# æ­¥éª¤6ï¼šå¯åŠ¨MySQLå¹¶éªŒè¯
sudo systemctl start mysql
sudo systemctl status mysql

# æ­¥éª¤7ï¼šåŸºæœ¬éªŒè¯
mysql -u root -p << EOF
SHOW DATABASES;
USE your_business_db;
SHOW TABLES;
SELECT COUNT(*) FROM important_table;
EOF
```

### 11.3 å¢é‡æ¢å¤æµç¨‹


**åœºæ™¯ï¼šéœ€è¦æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹ï¼Œä½¿ç”¨å¢é‡å¤‡ä»½**

```bash
#!/bin/bash
# å¢é‡æ¢å¤è„šæœ¬

BASE_BACKUP="/backup/full_20240910"
INC1_BACKUP="/backup/inc1_20240911"  
INC2_BACKUP="/backup/inc2_20240912"
RESTORE_DIR="/tmp/mysql_restore"

echo "=== å¼€å§‹å¢é‡æ¢å¤æµç¨‹ ==="

# æ­¥éª¤1ï¼šå‡†å¤‡å…¨é‡å¤‡ä»½
echo "å‡†å¤‡å…¨é‡å¤‡ä»½..."
xtrabackup --prepare --apply-log-only \
    --target-dir=$BASE_BACKUP

if [ $? -ne 0 ]; then
    echo "âŒ å…¨é‡å¤‡ä»½å‡†å¤‡å¤±è´¥"
    exit 1
fi

# æ­¥éª¤2ï¼šåº”ç”¨ç¬¬ä¸€ä¸ªå¢é‡å¤‡ä»½
echo "åº”ç”¨å¢é‡å¤‡ä»½1..."
xtrabackup --prepare --apply-log-only \
    --target-dir=$BASE_BACKUP \
    --incremental-dir=$INC1_BACKUP

if [ $? -ne 0 ]; then
    echo "âŒ å¢é‡å¤‡ä»½1åº”ç”¨å¤±è´¥"  
    exit 1
fi

# æ­¥éª¤3ï¼šåº”ç”¨ç¬¬äºŒä¸ªå¢é‡å¤‡ä»½ï¼ˆæœ€åä¸€ä¸ªä¸ç”¨--apply-log-onlyï¼‰
echo "åº”ç”¨å¢é‡å¤‡ä»½2..."
xtrabackup --prepare \
    --target-dir=$BASE_BACKUP \
    --incremental-dir=$INC2_BACKUP

if [ $? -ne 0 ]; then
    echo "âŒ å¢é‡å¤‡ä»½2åº”ç”¨å¤±è´¥"
    exit 1
fi

# æ­¥éª¤4ï¼šæœ€ç»ˆå‡†å¤‡
echo "æ‰§è¡Œæœ€ç»ˆå‡†å¤‡..."
xtrabackup --prepare --target-dir=$BASE_BACKUP

if [ $? -eq 0 ]; then
    echo "âœ… å¢é‡æ¢å¤å‡†å¤‡å®Œæˆï¼Œå¯ä»¥è¿›è¡Œcopy-backæ“ä½œ"
else
    echo "âŒ æœ€ç»ˆå‡†å¤‡å¤±è´¥"
    exit 1
fi
```

### 11.4 éƒ¨åˆ†æ•°æ®æ¢å¤


**åœºæ™¯ï¼šåªéœ€è¦æ¢å¤æŸäº›è¡¨ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°æ®åº“**

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨--tables-fileå‚æ•°
echo "users" > /tmp/tables_to_restore.txt
echo "orders" >> /tmp/tables_to_restore.txt

xtrabackup --backup \
    --tables-file=/tmp/tables_to_restore.txt \
    --target-dir=/backup/partial_backup

# æ–¹æ³•2ï¼šä»å®Œæ•´å¤‡ä»½ä¸­æå–ç‰¹å®šè¡¨
# å…ˆå‡†å¤‡å®Œæ•´å¤‡ä»½
xtrabackup --prepare --target-dir=/backup/full_backup

# ç„¶ååªå¤åˆ¶éœ€è¦çš„è¡¨æ–‡ä»¶
mkdir -p /tmp/partial_restore/your_db
cp /backup/full_backup/your_db/users.* /tmp/partial_restore/your_db/
cp /backup/full_backup/your_db/orders.* /tmp/partial_restore/your_db/

# ä½¿ç”¨MySQLå¯¼å…¥ç‰¹å®šè¡¨
mysql -u root -p your_db << EOF
DROP TABLE IF EXISTS users_backup;
CREATE TABLE users_backup LIKE users;
# ç„¶åä½¿ç”¨ALTER TABLE ... IMPORT TABLESPACEå¯¼å…¥æ•°æ®
EOF
```

### 11.5 æ—¶é—´ç‚¹æ¢å¤ï¼ˆPITRï¼‰


**åœºæ™¯ï¼šæ¢å¤åˆ°è¯¯æ“ä½œå‰çš„ç²¾ç¡®æ—¶é—´ç‚¹**

```bash
# ç»„åˆXtraBackupå’Œbinlogå®ç°ç²¾ç¡®æ—¶é—´ç‚¹æ¢å¤

# æ­¥éª¤1ï¼šæ¢å¤åˆ°æœ€è¿‘çš„XtraBackupå¤‡ä»½ç‚¹
echo "æ¢å¤åˆ°å¤‡ä»½æ—¶é—´ç‚¹..."
xtrabackup --copy-back \
    --target-dir=/backup/full_20240912 \
    --datadir=/var/lib/mysql

# æ­¥éª¤2ï¼šå¯åŠ¨MySQLåˆ°å¤‡ä»½æ—¶é—´ç‚¹
sudo systemctl start mysql

# æ­¥éª¤3ï¼šæŸ¥æ‰¾è¯¯æ“ä½œçš„ç²¾ç¡®æ—¶é—´
mysql -u root -p << EOF
SHOW MASTER STATUS;  # è®°å½•å½“å‰binlogä½ç½®
EOF

# æ­¥éª¤4ï¼šä»å¤‡ä»½æ—¶é—´ç‚¹åˆ°è¯¯æ“ä½œå‰åº”ç”¨binlog
# å‡è®¾è¯¯æ“ä½œå‘ç”Ÿåœ¨2024-09-12 14:30:00
mysqlbinlog --start-datetime="2024-09-12 12:00:00" \
           --stop-datetime="2024-09-12 14:29:59" \
           /var/lib/mysql/mysql-bin.000001 | \
           mysql -u root -p

echo "âœ… æ—¶é—´ç‚¹æ¢å¤å®Œæˆï¼Œæ•°æ®å·²æ¢å¤åˆ°è¯¯æ“ä½œå‰"
```

### 11.6 æ¢å¤éªŒè¯å’Œæµ‹è¯•


```bash
#!/bin/bash
# æ¢å¤åæ•°æ®éªŒè¯è„šæœ¬

echo "=== å¼€å§‹æ¢å¤åéªŒè¯ ==="

# 1. åŸºç¡€è¿æ¥æµ‹è¯•
echo "1. æµ‹è¯•MySQLè¿æ¥..."
mysql -u root -p -e "SELECT VERSION();" 2>/dev/null
if [ $? -eq 0 ]; then
    echo "âœ… MySQLè¿æ¥æ­£å¸¸"
else
    echo "âŒ MySQLè¿æ¥å¤±è´¥"
    exit 1
fi

# 2. æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥
echo "2. æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§..."
mysql -u root -p << EOF
CHECK TABLE mysql.user;
CHECK TABLE information_schema.tables;
EOF

# 3. ä¸šåŠ¡æ•°æ®éªŒè¯
echo "3. éªŒè¯å…³é”®ä¸šåŠ¡æ•°æ®..."
mysql -u root -p << EOF
USE your_business_db;

-- æ£€æŸ¥ä¸»è¦è¡¨çš„è®°å½•æ•°
SELECT 'users' as table_name, COUNT(*) as record_count FROM users
UNION ALL
SELECT 'orders' as table_name, COUNT(*) as record_count FROM orders
UNION ALL  
SELECT 'products' as table_name, COUNT(*) as record_count FROM products;

-- æ£€æŸ¥æ•°æ®çš„æ—¶é—´èŒƒå›´
SELECT 
    MIN(created_at) as earliest_record,
    MAX(created_at) as latest_record
FROM orders;
EOF

# 4. åº”ç”¨ç¨‹åºè¿æ¥æµ‹è¯•
echo "4. æµ‹è¯•åº”ç”¨ç¨‹åºè¿æ¥..."
# æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æµ‹è¯•æ–¹å¼
curl -f http://localhost:8080/health-check 2>/dev/null
if [ $? -eq 0 ]; then
    echo "âœ… åº”ç”¨ç¨‹åºè¿æ¥æ­£å¸¸"
else
    echo "âš ï¸ åº”ç”¨ç¨‹åºè¿æ¥å¼‚å¸¸ï¼Œéœ€è¦æ£€æŸ¥é…ç½®"
fi

echo "=== éªŒè¯å®Œæˆ ==="
```

### 11.7 æ¢å¤å¸¸è§é—®é¢˜å¤„ç†


**æƒé™é—®é¢˜è§£å†³**ï¼š
```bash
# å¸¸è§æƒé™é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ
# é”™è¯¯ï¼šCan't create/write to file '/var/lib/mysql/...' (Errcode: 13)

# è§£å†³æ–¹æ¡ˆï¼š
sudo chown -R mysql:mysql /var/lib/mysql
sudo chmod -R 755 /var/lib/mysql
sudo restorecon -R /var/lib/mysql  # SELinuxç¯å¢ƒä¸‹
```

**ç©ºé—´ä¸è¶³å¤„ç†**ï¼š
```bash
# æ£€æŸ¥å’Œé‡Šæ”¾ç©ºé—´
df -h /var/lib/mysql

# ä¸´æ—¶æ‰©å®¹æ–¹æ¡ˆ
sudo lvextend -L +10G /dev/vg0/mysql_lv  # LVMç¯å¢ƒ
sudo resize2fs /dev/vg0/mysql_lv

# æˆ–ä½¿ç”¨è½¯é“¾æ¥åˆ°å…¶ä»–ç£ç›˜
sudo ln -s /data/mysql_temp /var/lib/mysql/temp_restore
```

**ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜**ï¼š
```bash
# æ£€æŸ¥MySQLç‰ˆæœ¬å…¼å®¹æ€§
mysql --version
# å¦‚æœç‰ˆæœ¬ä¸å…¼å®¹ï¼Œå¯èƒ½éœ€è¦ï¼š

# 1. å‡çº§/é™çº§MySQLç‰ˆæœ¬
# 2. ä½¿ç”¨mysql_upgradeå·¥å…·
mysql_upgrade -u root -p

# 3. æ‰‹åŠ¨ä¿®å¤ç³»ç»Ÿè¡¨
mysql -u root -p mysql < /usr/share/mysql/mysql_system_tables_fix.sql
```

---

## 12. ğŸ¢ ä¼ä¸šçº§å¤‡ä»½æ–¹æ¡ˆè®¾è®¡


### 12.1 ä¼ä¸šå¤‡ä»½éœ€æ±‚åˆ†æ


**ä¼ä¸šçº§å¤‡ä»½**å°±åƒä¸ºä¸€ä¸ªå¤§å‹ä¼ä¸šè®¾è®¡ä¿é™©æ–¹æ¡ˆï¼Œéœ€è¦è€ƒè™‘å„ç§é£é™©å’Œéœ€æ±‚ï¼š

```
ä¼ä¸šçº§å¤‡ä»½éœ€æ±‚çŸ©é˜µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡ç±»å‹       â”‚ RTOç›®æ ‡     â”‚ RPOç›®æ ‡     â”‚ å¤‡ä»½ç­–ç•¥    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿ   â”‚ < 1å°æ—¶     â”‚ < 15åˆ†é’Ÿ    â”‚ å®æ—¶+å¢é‡   â”‚
â”‚ å®¢æˆ·ç®¡ç†ç³»ç»Ÿ   â”‚ < 4å°æ—¶     â”‚ < 1å°æ—¶     â”‚ æ¯å°æ—¶å¢é‡  â”‚
â”‚ æŠ¥è¡¨åˆ†æç³»ç»Ÿ   â”‚ < 24å°æ—¶    â”‚ < 4å°æ—¶     â”‚ æ¯4å°æ—¶å¢é‡ â”‚
â”‚ æ—¥å¿—å®¡è®¡ç³»ç»Ÿ   â”‚ < 48å°æ—¶    â”‚ < 24å°æ—¶    â”‚ æ¯æ—¥å…¨é‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RTO (Recovery Time Objective)ï¼šæ¢å¤æ—¶é—´ç›®æ ‡
RPO (Recovery Point Objective)ï¼šæ¢å¤ç‚¹ç›®æ ‡
```

### 12.2 å¤šå±‚æ¬¡å¤‡ä»½æ¶æ„


```
ä¼ä¸šçº§å¤‡ä»½æ¶æ„è®¾è®¡ï¼š

                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   ç”Ÿäº§æ•°æ®åº“     â”‚
                   â”‚   Primary DB    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚  æœ¬åœ°å¤‡ä»½    â”‚  â”‚  å¼‚åœ°å¤‡ä»½    â”‚  â”‚  äº‘ç«¯å¤‡ä»½    â”‚
   â”‚ Local Backupâ”‚  â”‚Remote Backupâ”‚  â”‚Cloud Backup â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                 â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚ å¿«é€Ÿæ¢å¤   â”‚    â”‚ ç¾éš¾æ¢å¤   â”‚    â”‚ é•¿æœŸå½’æ¡£   â”‚
   â”‚ 15min RTO â”‚    â”‚ 4h RTO    â”‚    â”‚ åˆè§„ä¿å­˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 åˆ†çº§å¤‡ä»½ç­–ç•¥


```bash
#!/bin/bash
# ä¼ä¸šçº§åˆ†çº§å¤‡ä»½è„šæœ¬
# æ ¹æ®ä¸šåŠ¡é‡è¦æ€§æ‰§è¡Œä¸åŒå¤‡ä»½ç­–ç•¥

# é…ç½®ä¸åŒä¸šåŠ¡ç³»ç»Ÿçš„å¤‡ä»½ç­–ç•¥
declare -A BACKUP_CONFIG=(
    ["core_trading"]="realtime,15min,local+remote+cloud"
    ["crm_system"]="hourly,1hour,local+remote"  
    ["report_system"]="4hourly,4hour,local"
    ["log_system"]="daily,24hour,local"
)

# æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿ - æœ€é«˜ä¼˜å…ˆçº§
backup_core_trading() {
    echo "æ‰§è¡Œæ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿå¤‡ä»½..."
    
    # 1. å®æ—¶binlogå¤‡ä»½åˆ°è¿œç¨‹
    rsync -avz --delete /var/lib/mysql/mysql-bin.* backup-server:/backup/core/binlog/
    
    # 2. æ¯15åˆ†é’Ÿå¢é‡å¤‡ä»½
    if [ $(date +%M) -eq 0 ] || [ $(date +%M) -eq 15 ] || [ $(date +%M) -eq 30 ] || [ $(date +%M) -eq 45 ]; then
        xtrabackup --backup \
            --incremental-basedir=/backup/core/last \
            --target-dir=/backup/core/inc_$(date +%Y%m%d_%H%M) \
            --compress --encrypt=AES256
            
        # åŒæ­¥åˆ°å¤šä¸ªä½ç½®
        rsync -avz /backup/core/inc_$(date +%Y%m%d_%H%M) backup-server:/backup/core/
        aws s3 sync /backup/core/ s3://company-backup/core/
    fi
}

# CRMç³»ç»Ÿ - é‡è¦çº§åˆ«
backup_crm_system() {
    echo "æ‰§è¡ŒCRMç³»ç»Ÿå¤‡ä»½..."
    
    # æ¯å°æ—¶å¢é‡å¤‡ä»½
    if [ $(date +%M) -eq 5 ]; then
        xtrabackup --backup \
            --incremental-basedir=/backup/crm/last \
            --target-dir=/backup/crm/inc_$(date +%Y%m%d_%H) \
            --compress
            
        # åŒæ­¥åˆ°è¿œç¨‹
        rsync -avz /backup/crm/ backup-server:/backup/crm/
    fi
}

# æ‰§è¡Œå¯¹åº”çš„å¤‡ä»½ç­–ç•¥
case $1 in
    "core")
        backup_core_trading
        ;;
    "crm") 
        backup_crm_system
        ;;
    "all")
        backup_core_trading
        backup_crm_system
        # å…¶ä»–ç³»ç»Ÿå¤‡ä»½...
        ;;
esac
```

### 12.4 å¼‚åœ°å®¹ç¾å¤‡ä»½


```bash
#!/bin/bash
# å¼‚åœ°å®¹ç¾å¤‡ä»½æ–¹æ¡ˆ

# å¼‚åœ°å¤‡ä»½é…ç½®
REMOTE_SERVERS=("backup-server-bj" "backup-server-sh" "backup-server-gz")
CLOUD_PROVIDERS=("aws-s3" "aliyun-oss" "tencent-cos")

# å¼‚åœ°åŒæ­¥å‡½æ•°
sync_to_remote() {
    local backup_file=$1
    local sync_success=0
    
    # åŒæ­¥åˆ°å¤šä¸ªå¼‚åœ°æœåŠ¡å™¨
    for server in "${REMOTE_SERVERS[@]}"; do
        echo "åŒæ­¥åˆ° $server..."
        rsync -avz --progress $backup_file $server:/backup/disaster-recovery/
        if [ $? -eq 0 ]; then
            ((sync_success++))
            echo "âœ… $server åŒæ­¥æˆåŠŸ"
        else
            echo "âŒ $server åŒæ­¥å¤±è´¥"
        fi
    done
    
    # åŒæ­¥åˆ°å¤šä¸ªäº‘å­˜å‚¨
    for provider in "${CLOUD_PROVIDERS[@]}"; do
        case $provider in
            "aws-s3")
                aws s3 cp $backup_file s3://company-dr-backup/mysql/
                ;;
            "aliyun-oss")
                ossutil cp $backup_file oss://company-dr-backup/mysql/
                ;;
            "tencent-cos")
                coscli cp $backup_file cos://company-dr-backup/mysql/
                ;;
        esac
    done
    
    # è‡³å°‘æœ‰ä¸€ä¸ªè¿œç¨‹ä½ç½®åŒæ­¥æˆåŠŸæ‰ç®—æˆåŠŸ
    if [ $sync_success -gt 0 ]; then
        return 0
    else
        return 1
    fi
}

# æ‰§è¡Œå¼‚åœ°å¤‡ä»½
LATEST_BACKUP=$(ls -t /backup/full_* | head -1)
if [ -n "$LATEST_BACKUP" ]; then
    sync_to_remote $LATEST_BACKUP
    if [ $? -eq 0 ]; then
        echo "âœ… å¼‚åœ°å¤‡ä»½å®Œæˆ"
    else
        echo "âŒ å¼‚åœ°å¤‡ä»½å¤±è´¥ï¼Œéœ€è¦äººå·¥æ£€æŸ¥"
        # å‘é€å‘Šè­¦
        send_alert "P1" "å¼‚åœ°å¤‡ä»½å¤±è´¥" "æ‰€æœ‰è¿œç¨‹ä½ç½®åŒæ­¥å¤±è´¥"
    fi
fi
```

### 12.5 åˆè§„æ€§å¤‡ä»½ç®¡ç†


```bash
#!/bin/bash
# åˆè§„æ€§å¤‡ä»½ç®¡ç†è„šæœ¬
# æ»¡è¶³è¡Œä¸šç›‘ç®¡è¦æ±‚ï¼ˆå¦‚é“¶è¡Œã€ä¿é™©ç­‰ï¼‰

# åˆè§„é…ç½®
COMPLIANCE_RETENTION_YEARS=7        # æ³•è§„è¦æ±‚ä¿å­˜7å¹´
IMMUTABLE_STORAGE_PATH="/archive"   # ä¸å¯å˜å­˜å‚¨è·¯å¾„  
AUDIT_LOG="/var/log/backup_audit.log"

# åˆè§„æ€§å¤‡ä»½å‡½æ•°
compliance_backup() {
    local backup_date=$(date +%Y%m%d)
    local backup_dir="/backup/compliance/${backup_date}"
    local archive_dir="/archive/mysql/${backup_date}"
    
    echo "$(date): å¼€å§‹åˆè§„æ€§å¤‡ä»½" >> $AUDIT_LOG
    
    # 1. åˆ›å»ºå®Œæ•´å¤‡ä»½
    xtrabackup --backup \
        --target-dir=$backup_dir \
        --compress --encrypt=AES256 \
        --encrypt-key-file=/etc/mysql/compliance.key
    
    # 2. ç”Ÿæˆæ•°å­—ç­¾å
    find $backup_dir -type f -exec sha256sum {} \; > $backup_dir/checksums.sha256
    gpg --sign --armor $backup_dir/checksums.sha256
    
    # 3. ç§»è‡³ä¸å¯å˜å­˜å‚¨
    cp -r $backup_dir $archive_dir
    chmod -R 444 $archive_dir  # åªè¯»æƒé™
    
    # 4. è®°å½•åˆè§„ä¿¡æ¯
    cat >> $backup_dir/compliance_info.txt << EOF
å¤‡ä»½æ—¥æœŸ: $(date)
å¤‡ä»½ç±»å‹: åˆè§„æ€§å®Œæ•´å¤‡ä»½
åŠ å¯†ç®—æ³•: AES256
ä¿ç•™æœŸé™: ${COMPLIANCE_RETENTION_YEARS}å¹´
æ•°å­—ç­¾å: å·²ç”ŸæˆGPGç­¾å
å®¡è®¡è·Ÿè¸ª: è®°å½•åœ¨ $AUDIT_LOG
EOF
    
    echo "$(date): åˆè§„æ€§å¤‡ä»½å®Œæˆ, è·¯å¾„: $archive_dir" >> $AUDIT_LOG
}

# åˆè§„æ€§æ¸…ç†ï¼ˆåªæœ‰è¶…è¿‡æ³•å®šæœŸé™æ‰èƒ½åˆ é™¤ï¼‰
compliance_cleanup() {
    echo "$(date): å¼€å§‹åˆè§„æ€§æ¸…ç†æ£€æŸ¥" >> $AUDIT_LOG
    
    find /archive/mysql -type d -mtime +$((COMPLIANCE_RETENTION_YEARS * 365)) | while read old_backup; do
        if [ -n "$old_backup" ]; then
            echo "$(date): åˆ é™¤è¿‡æœŸåˆè§„å¤‡ä»½: $old_backup" >> $AUDIT_LOG
            rm -rf "$old_backup"
        fi
    done
}

# æ¯æœˆæ‰§è¡Œåˆè§„æ€§å¤‡ä»½
if [ $(date +%d) -eq 1 ]; then
    compliance_backup
fi

# æ¯å¹´æ£€æŸ¥ä¸€æ¬¡è¿‡æœŸå¤‡ä»½
if [ $(date +%m%d) == "0101" ]; then
    compliance_cleanup
fi
```

### 12.6 å¤‡ä»½TCOæˆæœ¬ä¼˜åŒ–


```
ä¼ä¸šå¤‡ä»½æˆæœ¬ä¼˜åŒ–åˆ†æï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæœ¬é¡¹ç›®        â”‚ ä¼ ç»Ÿæ–¹æ¡ˆ     â”‚ ä¼˜åŒ–æ–¹æ¡ˆ     â”‚ èŠ‚çœæ¯”ä¾‹    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å­˜å‚¨æˆæœ¬        â”‚ 100ä¸‡/å¹´    â”‚ 40ä¸‡/å¹´     â”‚ 60%         â”‚
â”‚ â”‚ æœ¬åœ°å­˜å‚¨      â”‚ 60ä¸‡        â”‚ 20ä¸‡        â”‚ (å‹ç¼©+å»é‡) â”‚
â”‚ â”‚ äº‘ç«¯å­˜å‚¨      â”‚ 40ä¸‡        â”‚ 20ä¸‡        â”‚ (æ™ºèƒ½åˆ†å±‚)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç½‘ç»œæˆæœ¬        â”‚ 20ä¸‡/å¹´     â”‚ 8ä¸‡/å¹´      â”‚ 60%         â”‚
â”‚ â”‚ å¼‚åœ°ä¼ è¾“      â”‚ 15ä¸‡        â”‚ 5ä¸‡         â”‚ (å¢é‡åŒæ­¥)  â”‚
â”‚ â”‚ äº‘ç«¯ä¼ è¾“      â”‚ 5ä¸‡         â”‚ 3ä¸‡         â”‚ (å‹ç¼©ä¼ è¾“)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ äººåŠ›æˆæœ¬        â”‚ 80ä¸‡/å¹´     â”‚ 30ä¸‡/å¹´     â”‚ 62%         â”‚
â”‚ â”‚ æ—¥å¸¸ç»´æŠ¤      â”‚ 50ä¸‡        â”‚ 15ä¸‡        â”‚ (è‡ªåŠ¨åŒ–)    â”‚
â”‚ â”‚ æ•…éšœå¤„ç†      â”‚ 30ä¸‡        â”‚ 15ä¸‡        â”‚ (ç›‘æ§é¢„è­¦)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»æˆæœ¬          â”‚ 200ä¸‡/å¹´    â”‚ 78ä¸‡/å¹´     â”‚ 61%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–ç­–ç•¥ï¼š
ğŸ¯ æ™ºèƒ½å‹ç¼©ï¼šå¹³å‡èŠ‚çœ70%å­˜å‚¨ç©ºé—´
ğŸ¯ å¢é‡å¤‡ä»½ï¼šå‡å°‘90%çš„ä¼ è¾“æ•°æ®é‡  
ğŸ¯ è‡ªåŠ¨åŒ–è¿ç»´ï¼šå‡å°‘80%äººå·¥æ“ä½œ
ğŸ¯ äº‘å­˜å‚¨åˆ†å±‚ï¼šå†·æ•°æ®æˆæœ¬é™ä½85%
```

---

## 13. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 13.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ XtraBackupæœ¬è´¨ï¼šMySQL InnoDBçš„ç‰©ç†çƒ­å¤‡ä»½å·¥å…·
ğŸ”¸ çƒ­å¤‡ä»½åŸç†ï¼šåŸºäºMVCCå’ŒLSNæœºåˆ¶å®ç°åœ¨çº¿å¤‡ä»½
ğŸ”¸ ç‰©ç†å¤‡ä»½ä¼˜åŠ¿ï¼šé€Ÿåº¦å¿«ã€ä¸€è‡´æ€§å¥½ã€æ”¯æŒå¢é‡
ğŸ”¸ å¢é‡å¤‡ä»½ç­–ç•¥ï¼šåŸºäºLSNè¯†åˆ«å˜æ›´ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
ğŸ”¸ å¤‡ä»½éªŒè¯é‡è¦æ€§ï¼š30%å¤‡ä»½é—®é¢˜åœ¨æ¢å¤æ—¶æ‰å‘ç°
ğŸ”¸ ä¼ä¸šçº§æ–¹æ¡ˆï¼šå¤šå±‚æ¬¡ã€å¤šåœ°ç‚¹ã€è‡ªåŠ¨åŒ–ç®¡ç†
```

### 13.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆXtraBackupé€‚åˆä¼ä¸šçº§åº”ç”¨**
```
æŠ€æœ¯ä¼˜åŠ¿ï¼š
â”œâ”€ é›¶åœæœºæ—¶é—´ï¼šä¸šåŠ¡æ— æ„ŸçŸ¥å¤‡ä»½
â”œâ”€ é«˜æ€§èƒ½ï¼šæ¯”mysqldumpå¿«10-100å€
â”œâ”€ ä¸€è‡´æ€§ä¿è¯ï¼šåŸºäºInnoDBçš„MVCCæœºåˆ¶
â”œâ”€ ç©ºé—´æ•ˆç‡ï¼šå¢é‡å¤‡ä»½èŠ‚çœ60-80%ç©ºé—´
â””â”€ æ‰©å±•æ€§å¥½ï¼šæ”¯æŒå‹ç¼©ã€åŠ å¯†ã€å¹¶è¡Œå¤„ç†

é€‚ç”¨åœºæ™¯ï¼š
â”œâ”€ å¤§å‹æ•°æ®åº“ï¼š>100GBï¼Œä¼ ç»Ÿå¤‡ä»½å¤ªæ…¢
â”œâ”€ é«˜å¯ç”¨ç³»ç»Ÿï¼š7Ã—24å°æ—¶æœåŠ¡ä¸èƒ½ä¸­æ–­
â”œâ”€ æˆæœ¬æ•æ„Ÿï¼šå­˜å‚¨å’Œå¸¦å®½æˆæœ¬æ§åˆ¶ä¸¥æ ¼
â””â”€ åˆè§„è¦æ±‚ï¼šéœ€è¦å¯é çš„å¤‡ä»½éªŒè¯æœºåˆ¶
```

**ğŸ”¹ å¤‡ä»½ç­–ç•¥è®¾è®¡æ€è·¯**
```
ä¸šåŠ¡åˆ†æ â†’ ç¡®å®šRTO/RPOç›®æ ‡
    â†“
æŠ€æœ¯é€‰å‹ â†’ é€‰æ‹©å¤‡ä»½å·¥å…·å’Œæ–¹æ¡ˆ  
    â†“
æ¶æ„è®¾è®¡ â†’ æœ¬åœ°+å¼‚åœ°+äº‘ç«¯å¤šå±‚æ¬¡
    â†“
è‡ªåŠ¨åŒ–å®æ–½ â†’ è„šæœ¬+ç›‘æ§+å‘Šè­¦
    â†“
æŒç»­ä¼˜åŒ– â†’ æˆæœ¬æ§åˆ¶+æ€§èƒ½è°ƒä¼˜
```

**ğŸ”¹ æ¢å¤æ“ä½œçš„å…³é”®ç‚¹**
```
å‡†å¤‡å·¥ä½œï¼š
â”œâ”€ å……åˆ†éªŒè¯å¤‡ä»½å®Œæ•´æ€§
â”œâ”€ ç¡®è®¤æ¢å¤èŒƒå›´å’Œæ—¶é—´ç‚¹
â”œâ”€ å‡†å¤‡è¶³å¤Ÿçš„ç³»ç»Ÿèµ„æº
â””â”€ åˆ¶å®šè¯¦ç»†çš„æ¢å¤è®¡åˆ’

æ‰§è¡Œè¿‡ç¨‹ï¼š
â”œâ”€ ä¸¥æ ¼æŒ‰ç…§æµç¨‹æ“ä½œ
â”œâ”€ è®°å½•æ¯ä¸ªæ­¥éª¤çš„ç»“æœ
â”œâ”€ é‡åˆ°é—®é¢˜åŠæ—¶æ­¢æŸ
â””â”€ ä¿æŒä¸ä¸šåŠ¡æ–¹çš„æ²Ÿé€š

éªŒè¯æµ‹è¯•ï¼š
â”œâ”€ æ•°æ®å®Œæ•´æ€§éªŒè¯
â”œâ”€ ä¸šåŠ¡åŠŸèƒ½æµ‹è¯•
â”œâ”€ æ€§èƒ½åŸºå‡†æµ‹è¯•
â””â”€ åº”ç”¨ç¨‹åºå…¼å®¹æ€§æµ‹è¯•
```

### 13.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼**
- **é£é™©é˜²æ§**ï¼šæ•°æ®ä¸¢å¤±é£é™©é™ä½99%ä»¥ä¸Š
- **æˆæœ¬èŠ‚çº¦**ï¼šç›¸æ¯”å•†ä¸šå¤‡ä»½è§£å†³æ–¹æ¡ˆèŠ‚çœ60-80%æˆæœ¬
- **æ•ˆç‡æå‡**ï¼šè‡ªåŠ¨åŒ–ç¨‹åº¦æé«˜ï¼Œäººå·¥æ“ä½œå‡å°‘80%
- **åˆè§„æ»¡è¶³**ï¼šæ»¡è¶³å„ç±»è¡Œä¸šç›‘ç®¡è¦æ±‚

**ğŸ”§ æŠ€æœ¯ä»·å€¼**  
- **æ¶æ„ä¼˜åŒ–**ï¼šæ¨åŠ¨æ•°æ®åº“æ¶æ„å‘é«˜å¯ç”¨æ¼”è¿›
- **è¿ç»´æå‡**ï¼šå»ºç«‹å®Œå–„çš„å¤‡ä»½è¿ç»´ä½“ç³»
- **æŠ€èƒ½å‘å±•**ï¼šDBAå›¢é˜ŸæŠ€èƒ½æ°´å¹³å…¨é¢æå‡
- **æ ‡å‡†åˆ¶å®š**ï¼šå½¢æˆä¼ä¸šçº§å¤‡ä»½ç®¡ç†æ ‡å‡†

### 13.4 æœ€ä½³å®è·µå»ºè®®


**ğŸŒŸ æ—¥å¸¸è¿ç»´æœ€ä½³å®è·µ**
```
å¤‡ä»½æ‰§è¡Œï¼š
âœ… éä¸šåŠ¡é«˜å³°æœŸæ‰§è¡Œå¤§å¤‡ä»½
âœ… è®¾ç½®åˆç†çš„å¹¶è¡Œåº¦å’Œèµ„æºé™åˆ¶
âœ… å®šæœŸè½®æ¢å¤‡ä»½ä»‹è´¨å’Œä½ç½®
âœ… å»ºç«‹å¤‡ä»½æ‰§è¡Œæ—¥å¿—å’Œå®¡è®¡è·Ÿè¸ª

ç›‘æ§å‘Šè­¦ï¼š
âœ… è®¾ç½®å¤šå±‚çº§å‘Šè­¦æœºåˆ¶
âœ… å®šä¹‰æ˜ç¡®çš„é—®é¢˜å‡çº§æµç¨‹  
âœ… å»ºç«‹å¤‡ä»½è´¨é‡è¯„ä¼°æŒ‡æ ‡
âœ… å®šæœŸè¿›è¡Œå¤‡ä»½æ¢å¤æ¼”ç»ƒ

å®‰å…¨ç®¡ç†ï¼š
âœ… å¤‡ä»½æ•°æ®åŠ å¯†å­˜å‚¨
âœ… ä¸¥æ ¼æ§åˆ¶å¤‡ä»½æ–‡ä»¶è®¿é—®æƒé™
âœ… å®šæœŸæ›´æ–°åŠ å¯†å¯†é’¥
âœ… å»ºç«‹å¤‡ä»½æ•°æ®é”€æ¯æµç¨‹
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
```
é…ç½®é™·é˜±ï¼š
âŒ å¿˜è®°éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
âŒ å¢é‡å¤‡ä»½é“¾æ–­è£‚å¯¼è‡´æ— æ³•æ¢å¤
âŒ å¤‡ä»½æ–‡ä»¶æƒé™è®¾ç½®ä¸å½“
âŒ ç£ç›˜ç©ºé—´è€—å°½å¯¼è‡´å¤‡ä»½å¤±è´¥

æ“ä½œé™·é˜±ï¼š
âŒ æ¢å¤å‰æ²¡æœ‰å……åˆ†æµ‹è¯•
âŒ æ¢å¤æ—¶è¦†ç›–äº†æœ‰ç”¨çš„æ•°æ®
âŒ æ²¡æœ‰è®°å½•æ¢å¤æ“ä½œçš„è¯¦ç»†æ­¥éª¤
âŒ æ¢å¤åå¿˜è®°éªŒè¯æ•°æ®ä¸€è‡´æ€§

ç®¡ç†é™·é˜±ï¼š
âŒ å¤‡ä»½ç­–ç•¥ä¸ä¸šåŠ¡éœ€æ±‚ä¸åŒ¹é…
âŒ ç¼ºä¹å®šæœŸçš„å¤‡ä»½æ¼”ç»ƒ
âŒ å¤‡ä»½æˆæœ¬æ§åˆ¶ä¸å½“
âŒ å›¢é˜ŸæŠ€èƒ½åŸ¹è®­ä¸è¶³
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **XtraBackupçƒ­å¤‡ä»½ï¼Œç‰©ç†å¤åˆ¶é€Ÿåº¦å¿«**
- **LSNæœºåˆ¶ä¿ä¸€è‡´ï¼Œå¢é‡å¤‡ä»½çœç©ºé—´**  
- **å‹ç¼©åŠ å¯†ä¿å®‰å…¨ï¼Œå¹¶è¡Œå¤„ç†æ•ˆç‡é«˜**
- **ç›‘æ§å‘Šè­¦é˜²æ„å¤–ï¼ŒéªŒè¯æ¢å¤æ˜¯å…³é”®**
- **ä¼ä¸šæ–¹æ¡ˆåˆ†å±‚æ¬¡ï¼Œè‡ªåŠ¨è¿ç»´é™æˆæœ¬**

> ğŸ’¡ **æœ€ç»ˆå»ºè®®**ï¼šXtraBackupæ˜¯ä¼ä¸šçº§MySQLå¤‡ä»½çš„é¦–é€‰å·¥å…·ï¼Œä½†æˆåŠŸçš„å¤‡ä»½æ–¹æ¡ˆéœ€è¦æŠ€æœ¯ã€æµç¨‹ã€ç®¡ç†ä¸‰æ–¹é¢çš„å®Œç¾ç»“åˆã€‚ä»å°è§„æ¨¡å¼€å§‹å®è·µï¼Œé€æ­¥å®Œå–„ï¼Œæœ€ç»ˆå½¢æˆé€‚åˆè‡ªå·±ä¼ä¸šçš„å¤‡ä»½ä½“ç³»ã€‚