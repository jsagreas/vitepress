---
title: 13、安全配置与加固
---
## 📚 目录

1. [ProxySQL安全概述](#1-ProxySQL安全概述)
2. [SSL连接安全配置](#2-SSL连接安全配置)
3. [用户认证与权限管理](#3-用户认证与权限管理)
4. [网络访问控制](#4-网络访问控制)
5. [管理接口安全加固](#5-管理接口安全加固)
6. [审计日志与监控](#6-审计日志与监控)
7. [安全基线配置](#7-安全基线配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🛡️ ProxySQL安全概述


### 1.1 什么是ProxySQL安全配置


**📋 核心定义**
```
ProxySQL安全配置：保护数据库中间件免受攻击的综合防护体系
目标：确保数据传输安全、访问控制严格、操作可追溯
重点：多层防护，从网络到应用全方位保护
```

> **💡 核心理解**
> ProxySQL作为数据库中间件，就像是数据库的"安全门卫"，需要对进出的每个人和每个请求都进行严格检查

### 1.2 安全威胁分析


**⚠️ 主要安全风险**
```
数据传输风险：
• 明文传输被窃听
• 中间人攻击
• 数据包篡改

访问控制风险：
• 未授权访问
• 权限提升攻击
• 弱密码破解

管理风险：
• 管理接口暴露
• 配置信息泄露
• 操作无审计记录
```

### 1.3 安全防护层次


```
┌─────────────────────────────┐
│        应用层安全           │ ← 用户认证、权限控制
├─────────────────────────────┤
│        传输层安全           │ ← SSL/TLS加密传输
├─────────────────────────────┤
│        网络层安全           │ ← 防火墙、访问控制
├─────────────────────────────┤
│        主机层安全           │ ← 系统加固、文件权限
└─────────────────────────────┘
```

---

## 2. 🔐 SSL连接安全配置


### 2.1 SSL基础概念解析


**🔸 什么是SSL连接**
```
SSL（安全套接字层）：在客户端和ProxySQL之间建立加密通道
作用：防止数据在传输过程中被偷看或篡改
比喻：就像给数据穿上"隐身衣"，外人看不到真实内容
```

**📊 SSL连接流程**
```
客户端                    ProxySQL                 MySQL
   |                         |                       |
   |--[1]请求SSL连接-------->|                       |
   |<-[2]返回证书------------|                       |
   |--[3]验证证书并协商密钥->|                       |
   |<-[4]确认加密通道--------|                       |
   |===[5]加密数据传输]=====|===加密转发===========|
```

### 2.2 SSL证书配置


**🔧 证书文件准备**
```bash
# 生成自签名证书（测试环境）
openssl req -x509 -newkey rsa:4096 -keyout proxysql-key.pem \
  -out proxysql-cert.pem -days 365 -nodes

# 设置文件权限
chmod 600 proxysql-key.pem
chmod 644 proxysql-cert.pem
chown proxysql:proxysql proxysql-*.pem
```

**📝 ProxySQL SSL配置**
```sql
-- 启用SSL配置
SET mysql-have_ssl='true';

-- 配置证书路径
SET mysql-ssl_cert='/etc/proxysql/ssl/proxysql-cert.pem';
SET mysql-ssl_key='/etc/proxysql/ssl/proxysql-key.pem';

-- 配置CA证书（可选）
SET mysql-ssl_ca='/etc/proxysql/ssl/ca-cert.pem';

-- 强制SSL连接（推荐生产环境）
SET mysql-ssl_p2s_cert='/etc/proxysql/ssl/proxysql-cert.pem';
SET mysql-ssl_p2s_key='/etc/proxysql/ssl/proxysql-key.pem';

-- 保存配置
SAVE MYSQL VARIABLES TO DISK;
```

### 2.3 客户端SSL连接验证


**✅ 连接测试**
```bash
# 使用SSL连接ProxySQL
mysql -h proxysql_host -P 6033 -u username -p \
  --ssl-mode=REQUIRED \
  --ssl-cert=client-cert.pem \
  --ssl-key=client-key.pem

# 验证SSL状态
mysql> \s
# 应该显示：SSL: Cipher in use is xxx
```

> **⚠️ 常见误区**
> 很多人以为只要配置了证书就安全了，其实还需要验证证书有效性和设置强制SSL策略

---

## 3. 👤 用户认证与权限管理


### 3.1 用户认证机制详解


**🔸 认证方式对比**

| 认证方式 | **安全等级** | **使用场景** | **配置复杂度** |
|---------|-------------|-------------|---------------|
| **密码认证** | `中等` | `基础环境` | `简单` |
| **SSL证书认证** | `高` | `生产环境` | `复杂` |
| **双因素认证** | `最高` | `敏感环境` | `最复杂` |

### 3.2 安全用户配置


**👥 用户创建最佳实践**
```sql
-- 创建具有最小权限的用户
INSERT INTO mysql_users (
    username, password, default_hostgroup, 
    max_connections, active
) VALUES (
    'app_user',                    -- 应用用户名
    PASSWORD('Strong@Pass123!'),   -- 强密码
    1,                            -- 默认主机组
    100,                          -- 最大连接数限制
    1                             -- 激活状态
);

-- 只读用户配置
INSERT INTO mysql_users (
    username, password, default_hostgroup,
    max_connections, active
) VALUES (
    'readonly_user',
    PASSWORD('ReadOnly@2024!'),
    2,                            -- 只读主机组
    50,
    1
);
```

**🔒 密码安全策略**
```sql
-- 密码复杂度要求示例
强密码标准：
✓ 最少12位字符
✓ 包含大小写字母、数字、特殊字符
✓ 不包含用户名、常见词汇
✓ 定期更换（建议90天）

示例强密码：
❌ 弱密码：123456, admin, password
✅ 强密码：MyApp@2024#Secure!, Pr0xy$QL!2024
```

### 3.3 权限最小化配置


**📋 权限分级管理**
```sql
-- 应用读写用户权限
INSERT INTO mysql_query_rules (
    username, match_pattern, destination_hostgroup,
    apply, comment
) VALUES (
    'app_user', '^SELECT.*', 1, 1, '应用查询权限'
),
(
    'app_user', '^INSERT.*|^UPDATE.*|^DELETE.*', 1, 1, '应用写入权限'
);

-- 只读用户权限限制
INSERT INTO mysql_query_rules (
    username, match_pattern, destination_hostgroup,
    apply, comment
) VALUES (
    'readonly_user', '^SELECT.*', 2, 1, '只读查询权限'
),
(
    'readonly_user', '^INSERT.*|^UPDATE.*|^DELETE.*', 
    NULL, 0, '禁止写操作'
);
```

> **💡 核心理解**
> 权限最小化就像给员工发门卡，只给他们需要进入的房间权限，不需要的地方就不给

---

## 4. 🌐 网络访问控制


### 4.1 网络安全基础


**🔸 网络访问控制原理**
```
网络层防护：控制哪些IP可以连接ProxySQL
传输层防护：限制端口访问和连接数
应用层防护：基于用户和业务的访问控制
```

### 4.2 IP白名单配置


**📝 主机组访问控制**
```sql
-- 配置允许的客户端IP范围
INSERT INTO mysql_servers (
    hostgroup_id, hostname, port, weight,
    max_connections, comment
) VALUES (
    0, '192.168.1.100', 3306, 1000, 200, '主库'
),
(
    1, '192.168.1.101', 3306, 900, 200, '从库1'
);

-- 用户IP限制配置
UPDATE mysql_users SET 
    default_hostgroup = 1,
    max_connections = 10
WHERE username = 'external_user';
```

**🔧 防火墙规则配置**
```bash
# iptables规则示例
# 只允许指定网段访问ProxySQL
iptables -A INPUT -p tcp --dport 6033 -s 192.168.1.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 6033 -j DROP

# 限制管理端口访问
iptables -A INPUT -p tcp --dport 6032 -s 192.168.1.10 -j ACCEPT
iptables -A INPUT -p tcp --dport 6032 -j DROP

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

### 4.3 连接数限制配置


**📊 连接池安全配置**
```sql
-- 全局连接数限制
SET mysql-max_connections=1000;

-- 用户级连接数限制
UPDATE mysql_users SET max_connections = 50 
WHERE username = 'app_user';

-- 主机组连接数限制
UPDATE mysql_servers SET max_connections = 200 
WHERE hostgroup_id = 1;

-- 保存配置
SAVE MYSQL USERS TO DISK;
SAVE MYSQL SERVERS TO DISK;
```

---

## 5. ⚙️ 管理接口安全加固


### 5.1 管理接口安全风险


**⚠️ 管理接口常见风险**
```
默认密码风险：
• admin/admin等弱密码
• 未修改默认凭据
• 密码明文存储

网络暴露风险：
• 管理端口对外开放
• 未配置访问控制
• 缺少SSL保护
```

### 5.2 管理员账户加固


**🔐 管理员密码配置**
```sql
-- 修改默认admin密码
UPDATE global_variables SET variable_value = 'NewAdmin@2024!' 
WHERE variable_name = 'admin-admin_credentials';

-- 创建专用管理员账户
INSERT INTO global_variables (variable_name, variable_value) 
VALUES ('admin-admin_credentials', 'secadmin:SecurePass@2024!');

-- 禁用默认admin账户（推荐）
UPDATE global_variables SET variable_value = 'admin:' 
WHERE variable_name = 'admin-admin_credentials';
```

### 5.3 管理接口网络限制


**🌐 接口访问控制**
```bash
# 配置管理接口监听地址
# 只监听内网地址，不对外开放
proxysql --admin-interface=127.0.0.1:6032

# 配置文件方式
cat > /etc/proxysql.cnf << EOF
admin_variables= {
    admin_credentials="secadmin:SecurePass@2024!"
    mysql_ifaces="0.0.0.0:6032"  # 管理接口
    mysql_ifaces="127.0.0.1:6032"  # 仅本地访问
}
EOF
```

**🔒 SSH隧道访问（推荐）**
```bash
# 通过SSH隧道安全访问管理接口
ssh -L 6032:localhost:6032 user@proxysql-server

# 本地连接管理接口
mysql -h 127.0.0.1 -P 6032 -u secadmin -p
```

> **💡 核心理解**
> 管理接口就像是后台管理系统，绝对不能让外人随便进入，要像保护家里的保险箱一样严格

---

## 6. 📊 审计日志与监控


### 6.1 审计日志的重要性


**🔸 为什么需要审计日志**
```
合规要求：满足安全合规标准
安全分析：发现异常访问行为
故障排查：快速定位问题原因
责任追溯：确定操作责任人
```

### 6.2 审计日志配置


**📝 启用审计功能**
```sql
-- 启用查询日志
SET mysql-eventslog_filename='/var/lib/proxysql/queries.log';
SET mysql-eventslog_filesize=104857600;  -- 100MB
SET mysql-eventslog_default_log=1;

-- 启用错误日志
SET mysql-log_unhealthy_connections=1;

-- 保存配置
SAVE MYSQL VARIABLES TO DISK;
```

**🔧 日志格式配置**
```bash
# 日志轮转配置 /etc/logrotate.d/proxysql
/var/lib/proxysql/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    postrotate
        systemctl reload proxysql
    endscript
}
```

### 6.3 监控告警配置


**📈 关键监控指标**
```sql
-- 监控连接数
SELECT * FROM stats_mysql_connection_pool;

-- 监控查询统计
SELECT * FROM stats_mysql_query_digest 
ORDER BY sum_time DESC LIMIT 10;

-- 监控用户连接
SELECT * FROM stats_mysql_users;
```

**🚨 告警规则示例**
```bash
# 异常连接告警脚本
#!/bin/bash
CONNECTIONS=$(mysql -h127.0.0.1 -P6032 -usecadmin -p'password' \
  -e "SELECT SUM(ConnUsed) FROM stats_mysql_connection_pool;" -sN)

if [ $CONNECTIONS -gt 800 ]; then
    echo "ProxySQL连接数过高: $CONNECTIONS" | \
    mail -s "ProxySQL告警" admin@company.com
fi
```

---

## 7. 🛡️ 安全基线配置


### 7.1 安全基线检查清单


**📋 生产环境安全检查**

```markdown
**🔧 系统层安全**
- [ ] 操作系统版本最新且已打补丁
- [ ] 防火墙已配置并启用
- [ ] SSH密钥认证，禁用密码登录
- [ ] 非root用户运行ProxySQL
- [ ] 文件权限正确配置

**🔐 应用层安全**  
- [ ] 默认密码已修改
- [ ] SSL/TLS已启用
- [ ] 用户权限最小化
- [ ] 审计日志已启用
- [ ] 管理接口访问限制

**📊 监控层安全**
- [ ] 监控告警已配置
- [ ] 日志轮转已设置
- [ ] 备份策略已制定
- [ ] 恢复流程已测试
```

### 7.2 安全配置模板


**🔧 生产环境配置模板**
```sql
-- ProxySQL安全配置模板

-- 1. SSL配置
SET mysql-have_ssl='true';
SET mysql-ssl_cert='/etc/proxysql/ssl/server-cert.pem';
SET mysql-ssl_key='/etc/proxysql/ssl/server-key.pem';

-- 2. 连接限制
SET mysql-max_connections=1000;
SET mysql-default_query_timeout=3600000;

-- 3. 用户安全
-- 强密码用户示例
INSERT INTO mysql_users VALUES (
    'prod_app','PASSWORD_HASH',0,1,1,100,300,1,0,'',''
);

-- 4. 查询规则
INSERT INTO mysql_query_rules VALUES (
    1,'prod_app','^SELECT.*FOR UPDATE',1,1,NULL,1,0,0,0,'',''
);

-- 5. 审计配置
SET mysql-eventslog_filename='/var/log/proxysql/queries.log';
SET mysql-eventslog_default_log=1;

-- 保存所有配置
SAVE MYSQL VARIABLES TO DISK;
SAVE MYSQL USERS TO DISK;
SAVE MYSQL QUERY RULES TO DISK;
```

### 7.3 定期安全检查


**🔍 安全检查脚本**
```bash
#!/bin/bash
# ProxySQL安全检查脚本

echo "=== ProxySQL安全检查报告 ==="
echo "检查时间: $(date)"

# 检查SSL状态
echo "1. SSL配置检查:"
mysql -h127.0.0.1 -P6032 -usecadmin -p'password' \
  -e "SELECT variable_name,variable_value FROM global_variables 
      WHERE variable_name LIKE '%ssl%';"

# 检查用户权限
echo "2. 用户权限检查:"
mysql -h127.0.0.1 -P6032 -usecadmin -p'password' \
  -e "SELECT username,default_hostgroup,max_connections,active 
      FROM mysql_users;"

# 检查连接状态
echo "3. 连接状态检查:"
mysql -h127.0.0.1 -P6032 -usecadmin -p'password' \
  -e "SELECT hostgroup,srv_host,ConnUsed,ConnFree,ConnOK,ConnERR 
      FROM stats_mysql_connection_pool;"

echo "=== 检查完成 ==="
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的安全要点


```
🔸 SSL加密：保护数据传输安全，防止窃听和篡改
🔸 用户认证：强密码策略，权限最小化原则
🔸 网络控制：IP白名单，防火墙规则，连接数限制
🔸 管理安全：管理接口加固，SSH隧道访问
🔸 审计监控：操作可追溯，异常可告警
🔸 基线配置：安全检查清单，定期安全评估
```

### 8.2 安全配置优先级


**🔥 高优先级（必须配置）**
```
1. 修改默认密码
2. 启用SSL加密
3. 配置防火墙规则
4. 限制管理接口访问
5. 启用审计日志
```

**⭐ 中优先级（建议配置）**
```
1. 用户权限细化
2. 连接数限制
3. 查询规则优化
4. 监控告警配置
5. 安全检查脚本
```

**📌 低优先级（可选配置）**
```
1. 双因素认证
2. 高级审计功能
3. 性能监控
4. 自动化运维
5. 合规性报告
```

### 8.3 常见安全误区


> **⚠️ 常见误区**
> - 以为配置了SSL就绝对安全了
> - 管理接口直接暴露在公网上
> - 使用弱密码或默认密码
> - 给所有用户相同的权限
> - 不关注审计日志和监控

### 8.4 安全最佳实践


**🎯 核心安全原则**
```
深度防护：多层安全措施，不依赖单点防护
最小权限：用户只能访问必需的资源
定期检查：持续监控和定期安全评估
快速响应：建立安全事件响应流程
持续改进：根据威胁变化调整安全策略
```

**💡 记忆要点**
- SSL加密像给数据穿"防护服"
- 用户权限像发"门禁卡"，只给需要的权限
- 审计日志像"监控摄像头"，记录所有操作
- 网络控制像"安检门"，只让可信的连接通过

**核心记忆口诀**：
*SSL加密数据传，权限最小用户管*  
*网络控制防外敌，审计监控保平安*  
*基线配置要定期，安全防护不松懈*