---
title: 11ã€é›†ç¾¤éƒ¨ç½²ä¸ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ProxySQLé›†ç¾¤æ¦‚å¿µä¸æ¶æ„](#1-ProxySQLé›†ç¾¤æ¦‚å¿µä¸æ¶æ„)
2. [é›†ç¾¤é…ç½®åŒæ­¥æœºåˆ¶](#2-é›†ç¾¤é…ç½®åŒæ­¥æœºåˆ¶)
3. [èŠ‚ç‚¹é—´é€šä¿¡é…ç½®](#3-èŠ‚ç‚¹é—´é€šä¿¡é…ç½®)
4. [é›†ç¾¤éƒ¨ç½²å®æˆ˜](#4-é›†ç¾¤éƒ¨ç½²å®æˆ˜)
5. [é›†ç¾¤ç›‘æ§ä¸ç®¡ç†](#5-é›†ç¾¤ç›‘æ§ä¸ç®¡ç†)
6. [æ•…éšœå¤„ç†ä¸è¿ç»´](#6-æ•…éšœå¤„ç†ä¸è¿ç»´)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ProxySQLé›†ç¾¤æ¦‚å¿µä¸æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯ProxySQLé›†ç¾¤


ğŸ’­ **æ€è€ƒä¸€ä¸‹**ï¼šä¸ºä»€ä¹ˆéœ€è¦ProxySQLé›†ç¾¤ï¼Ÿ

```
å•ä¸ªProxySQLå®ä¾‹çš„é—®é¢˜ï¼š
åº”ç”¨ â†’ ProxySQL â†’ MySQLé›†ç¾¤
       â†‘ 
   å•ç‚¹æ•…éšœé£é™©

é›†ç¾¤åŒ–è§£å†³æ–¹æ¡ˆï¼š
åº”ç”¨ â†’ ProxySQLé›†ç¾¤ â†’ MySQLé›†ç¾¤
       â†‘
   é«˜å¯ç”¨ä¿éšœ
```

ğŸ·ï¸ **ä¸“ä¸šæœ¯è¯­**ï¼š
- `ProxySQL Cluster` = å¤šä¸ªProxySQLå®ä¾‹ç»„æˆçš„é›†ç¾¤ï¼Œé…ç½®è‡ªåŠ¨åŒæ­¥
- `é›†ç¾¤èŠ‚ç‚¹` = é›†ç¾¤ä¸­çš„æ¯ä¸ªProxySQLå®ä¾‹
- `é…ç½®åŒæ­¥` = é›†ç¾¤å†…é…ç½®å˜æ›´çš„è‡ªåŠ¨ä¼ æ’­æœºåˆ¶

ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼š
ProxySQLé›†ç¾¤å°±åƒä¸€ä¸ªå›¢é˜Ÿï¼Œæ¯ä¸ªæˆå‘˜éƒ½çŸ¥é“ç›¸åŒçš„ä¿¡æ¯ï¼ˆé…ç½®ï¼‰ï¼Œå½“å…¶ä¸­ä¸€äººå­¦åˆ°æ–°çŸ¥è¯†ï¼ˆé…ç½®å˜æ›´ï¼‰æ—¶ï¼Œä¼šç«‹å³åˆ†äº«ç»™å…¶ä»–æ‰€æœ‰äººã€‚

### 1.2 é›†ç¾¤æ¶æ„è®¾è®¡


**ğŸ—ï¸ é›†ç¾¤æ‹“æ‰‘ç»“æ„**ï¼š
```
          åº”ç”¨å±‚
      â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
      â”‚App1 â”‚App2 â”‚App3 â”‚
      â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚ LB/VIP  â”‚ â† è´Ÿè½½å‡è¡¡å™¨
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        â”‚        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”
â”‚Proxy1â”‚ â”‚Proxy2â”‚ â”‚Proxy3â”‚ â† ProxySQLé›†ç¾¤
â””â”€â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜
    â”‚       â”‚       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ MySQL Master  â”‚
    â”‚   Slaves...   â”‚ â† åç«¯æ•°æ®åº“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ“‹ **é›†ç¾¤ç‰¹ç‚¹**ï¼š
- âœ… **é…ç½®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹ä¿æŒç›¸åŒé…ç½®
- âœ… **è‡ªåŠ¨åŒæ­¥**ï¼šé…ç½®å˜æ›´è‡ªåŠ¨ä¼ æ’­åˆ°æ‰€æœ‰èŠ‚ç‚¹
- âœ… **æ•…éšœè½¬ç§»**ï¼šå•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- âœ… **æ°´å¹³æ‰©å±•**ï¼šå¯åŠ¨æ€æ·»åŠ æˆ–ç§»é™¤èŠ‚ç‚¹

### 1.3 é›†ç¾¤vså•å®ä¾‹å¯¹æ¯”


| ç‰¹æ€§ | **å•å®ä¾‹éƒ¨ç½²** | **é›†ç¾¤éƒ¨ç½²** |
|------|---------------|-------------|
| ğŸ¯ **å¯ç”¨æ€§** | `å•ç‚¹æ•…éšœé£é™©` | `é«˜å¯ç”¨ä¿éšœ` |
| âš¡ **æ€§èƒ½** | `å•èŠ‚ç‚¹å¤„ç†èƒ½åŠ›é™åˆ¶` | `è´Ÿè½½åˆ†æ‹…ï¼Œæ€§èƒ½æå‡` |
| ğŸ”§ **é…ç½®ç®¡ç†** | `æ‰‹åŠ¨é…ç½®å•ä¸ªå®ä¾‹` | `é…ç½®è‡ªåŠ¨åŒæ­¥` |
| ğŸ“ˆ **æ‰©å±•æ€§** | `å‚ç›´æ‰©å±•ï¼ˆå‡çº§ç¡¬ä»¶ï¼‰` | `æ°´å¹³æ‰©å±•ï¼ˆå¢åŠ èŠ‚ç‚¹ï¼‰` |
| ğŸ› ï¸ **è¿ç»´å¤æ‚åº¦** | `ç®€å•` | `ç›¸å¯¹å¤æ‚` |
| ğŸ’° **æˆæœ¬** | `ä½` | `ä¸­ç­‰ï¼ˆéœ€è¦å¤šå°æœåŠ¡å™¨ï¼‰` |

---

## 2. ğŸ”„ é›†ç¾¤é…ç½®åŒæ­¥æœºåˆ¶


### 2.1 é…ç½®åŒæ­¥åŸç†


ğŸ¤” **ä¸ºä»€ä¹ˆè¿™æ ·**ï¼šProxySQLé›†ç¾¤å¦‚ä½•ä¿è¯æ‰€æœ‰èŠ‚ç‚¹é…ç½®ä¸€è‡´ï¼Ÿ

```
é…ç½®åŒæ­¥æµç¨‹ï¼š
ç®¡ç†å‘˜ â†’ ä¿®æ”¹Node1é…ç½® â†’ Node1æ£€æµ‹å˜æ›´ â†’ å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ â†’ å…¨é›†ç¾¤åŒæ­¥
```

**ğŸ” æ·±å…¥ç†è§£**ï¼šé…ç½®åŒæ­¥æœºåˆ¶

```sql
-- ProxySQLé›†ç¾¤é…ç½®è¡¨ç»“æ„
-- proxysql_clustersè¡¨ï¼šè®°å½•é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
CREATE TABLE proxysql_clusters (
    hostname VARCHAR(255),
    port INT,
    weight INT,
    comment VARCHAR(255)
);

-- é…ç½®æ£€æŸ¥å’ŒåŒæ­¥
-- æ¯ä¸ªèŠ‚ç‚¹å®šæœŸæ£€æŸ¥é…ç½®ç‰ˆæœ¬
-- å‘ç°ä¸ä¸€è‡´æ—¶è‡ªåŠ¨åŒæ­¥
```

### 2.2 é…ç½®åŒæ­¥å·¥ä½œæœºåˆ¶


**ğŸ“Š åŒæ­¥è¿‡ç¨‹è¯¦è§£**ï¼š

```
1. é…ç½®å˜æ›´æ£€æµ‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    é…ç½®ä¿®æ”¹    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†ç«¯æ“ä½œ   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ Node1 é…ç½®   â”‚
â”‚LOAD TO RUNTIMEâ”‚              â”‚ ç‰ˆæœ¬å·+1     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. å˜æ›´é€šçŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   é€šçŸ¥æ¶ˆæ¯   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Node2, Node3 â”‚
â”‚ ç‰ˆæœ¬å·: 1001 â”‚             â”‚ ç‰ˆæœ¬å·: 1000 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. é…ç½®æ‹‰å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   è¯·æ±‚é…ç½®   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node2, Node3 â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Node1        â”‚
â”‚ è·å–æœ€æ–°é…ç½®  â”‚             â”‚ æä¾›é…ç½®æ•°æ®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. é…ç½®åº”ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node2, Node3 â”‚              â”‚ é›†ç¾¤é…ç½®     â”‚
â”‚ æ›´æ–°å¹¶åº”ç”¨   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ å®Œå…¨ä¸€è‡´     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 é…ç½®åŒæ­¥å®ç°


**ğŸ”§ é›†ç¾¤é…ç½®è®¾ç½®**ï¼š

```sql
-- 1. é…ç½®é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
INSERT INTO proxysql_clusters (hostname, port, weight, comment) VALUES
('192.168.1.10', 6032, 1000, 'ProxySQL Node 1'),
('192.168.1.11', 6032, 1000, 'ProxySQL Node 2'),
('192.168.1.12', 6032, 1000, 'ProxySQL Node 3');

-- åº”ç”¨é…ç½®
LOAD PROXYSQL CLUSTERS TO RUNTIME;
SAVE PROXYSQL CLUSTERS TO DISK;
```

**âš¡ å¿«é€Ÿé…ç½®ç¤ºä¾‹**ï¼š

```bash
# Node1 é…ç½®æ–‡ä»¶ proxysql.cnf
proxysql_clusters = (
    {
        hostname = "192.168.1.10"
        port = 6032
        weight = 1000
        comment = "Primary Node"
    },
    {
        hostname = "192.168.1.11" 
        port = 6032
        weight = 1000
        comment = "Secondary Node"
    }
)
```

---

## 3. ğŸŒ èŠ‚ç‚¹é—´é€šä¿¡é…ç½®


### 3.1 é€šä¿¡ç«¯å£ä¸åè®®


ğŸ·ï¸ **ä¸“ä¸šæœ¯è¯­**ï¼š
- `ç®¡ç†ç«¯å£` = ProxySQLç®¡ç†æ¥å£ï¼Œé»˜è®¤6032
- `é›†ç¾¤é€šä¿¡` = èŠ‚ç‚¹é—´é…ç½®åŒæ­¥é€šä¿¡
- `å¿ƒè·³æ£€æµ‹` = èŠ‚ç‚¹é—´å¥åº·çŠ¶æ€æ£€æŸ¥

**ğŸ“‹ ç«¯å£é…ç½®è¯´æ˜**ï¼š

```
ProxySQLç«¯å£è§„åˆ’ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç«¯å£      â”‚  åè®®   â”‚      ç”¨é€”       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    6033     â”‚  MySQL  â”‚ åº”ç”¨è¿æ¥ç«¯å£     â”‚
â”‚    6032     â”‚  MySQL  â”‚ ç®¡ç†ç«¯å£        â”‚ 
â”‚    6080     â”‚  HTTP   â”‚ Webç®¡ç†ç•Œé¢     â”‚
â”‚    6070     â”‚  HTTP   â”‚ RESTful API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 èŠ‚ç‚¹é€šä¿¡å®‰å…¨é…ç½®


**ğŸ”’ é›†ç¾¤å®‰å…¨è®¾ç½®**ï¼š

```sql
-- é…ç½®é›†ç¾¤è®¤è¯ç”¨æˆ·
INSERT INTO proxysql_clusters_credentials (username, password, comment) VALUES
('cluster_admin', 'secure_password123', 'Cluster sync user');

-- åº”ç”¨è®¤è¯é…ç½®
LOAD PROXYSQL CLUSTERS CREDENTIALS TO RUNTIME;
SAVE PROXYSQL CLUSTERS CREDENTIALS TO DISK;
```

**ğŸ›¡ï¸ ç½‘ç»œå®‰å…¨é…ç½®**ï¼š

```ini
# proxysql.cnf ç½‘ç»œé…ç½®
[proxysql]
# ç»‘å®šç®¡ç†æ¥å£åˆ°æ‰€æœ‰ç½‘å¡ï¼ˆé›†ç¾¤éœ€è¦ï¼‰
admin-mysql_ifaces="0.0.0.0:6032"

# é…ç½®SSLï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
admin-ssl_ca="/path/to/ca.pem"
admin-ssl_cert="/path/to/server-cert.pem"  
admin-ssl_key="/path/to/server-key.pem"
```

### 3.3 é›†ç¾¤é€šä¿¡ç›‘æ§


**ğŸ“Š é€šä¿¡çŠ¶æ€æ£€æŸ¥**ï¼š

```sql
-- æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€
SELECT * FROM proxysql_clusters;

-- æ£€æŸ¥é…ç½®åŒæ­¥çŠ¶æ€
SELECT * FROM stats_proxysql_clusters;

-- æŸ¥çœ‹æœ€ååŒæ­¥æ—¶é—´
SELECT hostname, port, last_check_ms 
FROM stats_proxysql_clusters 
ORDER BY last_check_ms DESC;
```

---

## 4. ğŸš€ é›†ç¾¤éƒ¨ç½²å®æˆ˜


### 4.1 éƒ¨ç½²è§„åˆ’


ğŸ’­ **æ€è€ƒä¸€ä¸‹**ï¼šé›†ç¾¤éƒ¨ç½²éœ€è¦è€ƒè™‘å“ªäº›å› ç´ ï¼Ÿ

**ğŸ¯ éƒ¨ç½²è§„åˆ’è¦ç‚¹**ï¼š
- **èŠ‚ç‚¹æ•°é‡**ï¼šé€šå¸¸3ä¸ªèŠ‚ç‚¹ï¼ˆå¥‡æ•°ä¸ªï¼Œé¿å…è„‘è£‚ï¼‰
- **ç¡¬ä»¶é…ç½®**ï¼šCPU 4æ ¸+ï¼Œå†…å­˜8GB+ï¼ŒSSDå­˜å‚¨
- **ç½‘ç»œè¦æ±‚**ï¼šä½å»¶è¿Ÿï¼Œé«˜å¸¦å®½ï¼Œç¨³å®šè¿æ¥
- **åœ°ç†åˆ†å¸ƒ**ï¼šä¸åŒæœºæˆ¿æˆ–å¯ç”¨åŒºéƒ¨ç½²

### 4.2 ç¬¬ä¸€ä¸ªèŠ‚ç‚¹éƒ¨ç½²


**ğŸ”§ Node1 å®‰è£…é…ç½®**ï¼š

```bash
# 1. å®‰è£…ProxySQL
yum install -y proxysql

# 2. é…ç½®æ–‡ä»¶ /etc/proxysql.cnf
cat > /etc/proxysql.cnf << 'EOF'
datadir="/var/lib/proxysql"

admin_variables=
{
    admin_credentials="admin:admin_password"
    mysql_ifaces="0.0.0.0:6032"
    restapi_enabled=true
    restapi_port=6070
}

mysql_variables=
{
    threads=4
    max_connections=2048
    default_query_delay=0
    default_query_timeout=36000000
    interfaces="0.0.0.0:6033"
}

# é›†ç¾¤é…ç½®
proxysql_clusters=
(
    {
        hostname="192.168.1.10"
        port=6032
        weight=1000
        comment="Node1"
    }
)
EOF

# 3. å¯åŠ¨æœåŠ¡
systemctl enable proxysql
systemctl start proxysql
```

### 4.3 æ·»åŠ å…¶ä»–èŠ‚ç‚¹


**ğŸŒŸ Node2 éƒ¨ç½²**ï¼š

```bash
# 1. å¤åˆ¶Node1é…ç½®å¹¶ä¿®æ”¹
cp /etc/proxysql.cnf /tmp/proxysql_node2.cnf

# 2. ä¿®æ”¹é›†ç¾¤é…ç½®
cat >> /tmp/proxysql_node2.cnf << 'EOF'
proxysql_clusters=
(
    {
        hostname="192.168.1.10"
        port=6032
        weight=1000
        comment="Node1"
    },
    {
        hostname="192.168.1.11"
        port=6032
        weight=1000
        comment="Node2"
    }
)
EOF

# 3. éƒ¨ç½²åˆ°Node2æœåŠ¡å™¨
scp /tmp/proxysql_node2.cnf root@192.168.1.11:/etc/proxysql.cnf
ssh root@192.168.1.11 'systemctl start proxysql'
```

### 4.4 é›†ç¾¤åˆå§‹åŒ–é…ç½®


**âš¡ é…ç½®MySQLåç«¯**ï¼š

```sql
-- åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œï¼ˆä¼šè‡ªåŠ¨åŒæ­¥åˆ°å…¶ä»–èŠ‚ç‚¹ï¼‰
-- 1. é…ç½®åç«¯MySQLæœåŠ¡å™¨
INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight, comment) VALUES
(0, '192.168.1.20', 3306, 1000, 'MySQL Master'),
(1, '192.168.1.21', 3306, 900, 'MySQL Slave1'),
(1, '192.168.1.22', 3306, 900, 'MySQL Slave2');

-- 2. é…ç½®ç”¨æˆ·
INSERT INTO mysql_users(username, password, default_hostgroup, comment) VALUES
('app_user', 'app_password', 0, 'Application User');

-- 3. é…ç½®æŸ¥è¯¢è·¯ç”±
INSERT INTO mysql_query_rules(rule_id, match_pattern, destination_hostgroup, apply) VALUES
(1, '^SELECT.*', 1, 1),
(2, '^INSERT|UPDATE|DELETE.*', 0, 1);

-- 4. åº”ç”¨é…ç½®
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL USERS TO RUNTIME; 
LOAD MYSQL QUERY RULES TO RUNTIME;

-- 5. ä¿å­˜é…ç½®
SAVE MYSQL SERVERS TO DISK;
SAVE MYSQL USERS TO DISK;
SAVE MYSQL QUERY RULES TO DISK;
```

---

## 5. ğŸ“Š é›†ç¾¤ç›‘æ§ä¸ç®¡ç†


### 5.1 é›†ç¾¤çŠ¶æ€ç›‘æ§


**ğŸ” å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- 1. é›†ç¾¤èŠ‚ç‚¹å¥åº·çŠ¶æ€
SELECT 
    hostname,
    port,
    weight,
    CASE 
        WHEN last_check_ms > 0 THEN 'Online'
        ELSE 'Offline'
    END as status,
    last_check_ms
FROM stats_proxysql_clusters;

-- 2. é…ç½®åŒæ­¥çŠ¶æ€æ£€æŸ¥
SELECT 
    hostname,
    port,
    checksum,
    changed_at
FROM proxysql_clusters_checksums
ORDER BY changed_at DESC;

-- 3. é›†ç¾¤æ€§èƒ½ç»Ÿè®¡
SELECT 
    hostname,
    Queries,
    Queries_frontends,
    Queries_backends
FROM stats_proxysql_clusters_metrics;
```

### 5.2 é…ç½®ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ“‹ ä¸€è‡´æ€§éªŒè¯è„šæœ¬**ï¼š

```bash
#!/bin/bash
# cluster_config_check.sh

NODES=("192.168.1.10" "192.168.1.11" "192.168.1.12")
PORT="6032"
USER="admin"
PASS="admin_password"

echo "ğŸ” é›†ç¾¤é…ç½®ä¸€è‡´æ€§æ£€æŸ¥"
echo "========================"

for node in "${NODES[@]}"; do
    echo "ğŸ“ æ£€æŸ¥èŠ‚ç‚¹: $node"
    
    # æ£€æŸ¥MySQLæœåŠ¡å™¨é…ç½®
    mysql -h$node -P$PORT -u$USER -p$PASS -e "
        SELECT COUNT(*) as server_count 
        FROM mysql_servers;" 2>/dev/null
    
    # æ£€æŸ¥ç”¨æˆ·é…ç½®
    mysql -h$node -P$PORT -u$USER -p$PASS -e "
        SELECT COUNT(*) as user_count 
        FROM mysql_users;" 2>/dev/null
        
    echo "âœ… $node æ£€æŸ¥å®Œæˆ"
    echo "---"
done
```

### 5.3 é›†ç¾¤ç›‘æ§è„šæœ¬


**ğŸ“ˆ å…¨é¢ç›‘æ§è„šæœ¬**ï¼š

```python
#!/usr/bin/env python3
# proxysql_cluster_monitor.py

import pymysql
import json
import time
from datetime import datetime

class ProxySQLClusterMonitor:
    def __init__(self, nodes):
        self.nodes = nodes
        self.results = {}
    
    def check_node_health(self, host, port, user, password):
        """æ£€æŸ¥å•ä¸ªèŠ‚ç‚¹å¥åº·çŠ¶æ€"""
        try:
            conn = pymysql.connect(
                host=host, port=port, 
                user=user, password=password
            )
            
            # åŸºæœ¬è¿æ¥æ£€æŸ¥
            with conn.cursor() as cursor:
                cursor.execute("SELECT 1")
                result = cursor.fetchone()
                
            # è·å–ç»Ÿè®¡ä¿¡æ¯
            with conn.cursor() as cursor:
                cursor.execute("""
                    SELECT Variable_name, Variable_value 
                    FROM stats_mysql_global 
                    WHERE Variable_name IN (
                        'ProxySQL_Uptime', 
                        'Questions',
                        'Active_Transactions'
                    )
                """)
                stats = dict(cursor.fetchall())
            
            conn.close()
            
            return {
                'status': 'healthy',
                'stats': stats,
                'checked_at': datetime.now().isoformat()
            }
            
        except Exception as e:
            return {
                'status': 'error',
                'error': str(e),
                'checked_at': datetime.now().isoformat()
            }
    
    def monitor_cluster(self):
        """ç›‘æ§æ•´ä¸ªé›†ç¾¤"""
        print("ğŸ” ProxySQLé›†ç¾¤ç›‘æ§æŠ¥å‘Š")
        print("=" * 50)
        
        for node in self.nodes:
            result = self.check_node_health(**node)
            print(f"ğŸ“ èŠ‚ç‚¹ {node['host']}:{node['port']}")
            
            if result['status'] == 'healthy':
                print("âœ… çŠ¶æ€: å¥åº·")
                uptime = result['stats'].get('ProxySQL_Uptime', 'N/A')
                questions = result['stats'].get('Questions', 'N/A')
                print(f"   è¿è¡Œæ—¶é—´: {uptime}ç§’")
                print(f"   æ€»æŸ¥è¯¢æ•°: {questions}")
            else:
                print("âŒ çŠ¶æ€: å¼‚å¸¸")
                print(f"   é”™è¯¯: {result['error']}")
            
            print("-" * 30)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    nodes = [
        {'host': '192.168.1.10', 'port': 6032, 'user': 'admin', 'password': 'admin_password'},
        {'host': '192.168.1.11', 'port': 6032, 'user': 'admin', 'password': 'admin_password'},
        {'host': '192.168.1.12', 'port': 6032, 'user': 'admin', 'password': 'admin_password'}
    ]
    
    monitor = ProxySQLClusterMonitor(nodes)
    monitor.monitor_cluster()
```

---

## 6. ğŸ› ï¸ æ•…éšœå¤„ç†ä¸è¿ç»´


### 6.1 å¸¸è§æ•…éšœåœºæ™¯


**ğŸš¨ å…¸å‹æ•…éšœç±»å‹**ï¼š

| æ•…éšœç±»å‹ | **ç°è±¡** | **å½±å“** | **å¤„ç†ä¼˜å…ˆçº§** |
|---------|---------|----------|---------------|
| ğŸ”´ **èŠ‚ç‚¹å®•æœº** | `èŠ‚ç‚¹æ— å“åº”` | `éƒ¨åˆ†è¯·æ±‚å¤±è´¥` | `é«˜` |
| ğŸŸ¡ **é…ç½®ä¸åŒæ­¥** | `èŠ‚ç‚¹è¡Œä¸ºä¸ä¸€è‡´` | `æŸ¥è¯¢ç»“æœå¼‚å¸¸` | `ä¸­` |
| ğŸŸ  **ç½‘ç»œåˆ†åŒº** | `èŠ‚ç‚¹é—´é€šä¿¡ä¸­æ–­` | `é…ç½®æ— æ³•åŒæ­¥` | `é«˜` |
| ğŸŸ¢ **æ€§èƒ½ä¸‹é™** | `å“åº”æ—¶é—´å¢åŠ ` | `ç”¨æˆ·ä½“éªŒå·®` | `ä¸­` |

### 6.2 èŠ‚ç‚¹æ•…éšœå¤„ç†


**âš¡ èŠ‚ç‚¹æ•…éšœæ¢å¤æµç¨‹**ï¼š

```bash
# 1. æ£€æŸ¥æ•…éšœèŠ‚ç‚¹çŠ¶æ€
systemctl status proxysql

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/lib/proxysql/proxysql.log

# 3. é‡å¯æœåŠ¡
systemctl restart proxysql

# 4. éªŒè¯æ¢å¤
mysql -h192.168.1.11 -P6032 -uadmin -p -e "SELECT 1"

# 5. æ£€æŸ¥é›†ç¾¤åŒæ­¥
mysql -h192.168.1.11 -P6032 -uadmin -p -e "
SELECT hostname, last_check_ms 
FROM stats_proxysql_clusters"
```

### 6.3 é…ç½®ä¸åŒæ­¥å¤„ç†


**ğŸ”§ å¼ºåˆ¶é…ç½®åŒæ­¥**ï¼š

```sql
-- åœ¨é…ç½®æ­£ç¡®çš„èŠ‚ç‚¹æ‰§è¡Œ
-- 1. æŸ¥çœ‹å½“å‰é…ç½®ç‰ˆæœ¬
SELECT * FROM proxysql_clusters_checksums;

-- 2. å¼ºåˆ¶æ¨é€é…ç½®åˆ°æŒ‡å®šèŠ‚ç‚¹
PROXYSQL FLUSH CONFIGDB;

-- 3. åœ¨é—®é¢˜èŠ‚ç‚¹æ‰§è¡Œé‡æ–°åŠ è½½
LOAD PROXYSQL CLUSTERS FROM CONFIG;
LOAD MYSQL SERVERS FROM CONFIG;
LOAD MYSQL USERS FROM CONFIG;
LOAD MYSQL QUERY RULES FROM CONFIG;

-- 4. åº”ç”¨é…ç½®
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL USERS TO RUNTIME;
LOAD MYSQL QUERY RULES TO RUNTIME;
```

### 6.4 é›†ç¾¤æ‰©å®¹ç¼©å®¹


**ğŸ“ˆ æ·»åŠ æ–°èŠ‚ç‚¹**ï¼š

```bash
# 1. åœ¨ç°æœ‰èŠ‚ç‚¹æ·»åŠ æ–°èŠ‚ç‚¹ä¿¡æ¯
mysql -h192.168.1.10 -P6032 -uadmin -p << 'EOF'
INSERT INTO proxysql_clusters (hostname, port, weight, comment) VALUES
('192.168.1.13', 6032, 1000, 'New Node 4');

LOAD PROXYSQL CLUSTERS TO RUNTIME;
SAVE PROXYSQL CLUSTERS TO DISK;
EOF

# 2. åœ¨æ–°èŠ‚ç‚¹é…ç½®é›†ç¾¤ä¿¡æ¯
# (åŒ…å«æ‰€æœ‰ç°æœ‰èŠ‚ç‚¹ + è‡ªå·±)

# 3. å¯åŠ¨æ–°èŠ‚ç‚¹
ssh root@192.168.1.13 'systemctl start proxysql'

# 4. éªŒè¯é›†ç¾¤çŠ¶æ€
mysql -h192.168.1.10 -P6032 -uadmin -p -e "
SELECT * FROM stats_proxysql_clusters"
```

**ğŸ“‰ ç§»é™¤èŠ‚ç‚¹**ï¼š

```sql
-- 1. ä»é›†ç¾¤é…ç½®ä¸­ç§»é™¤èŠ‚ç‚¹
DELETE FROM proxysql_clusters 
WHERE hostname = '192.168.1.13';

-- 2. åº”ç”¨é…ç½®
LOAD PROXYSQL CLUSTERS TO RUNTIME;
SAVE PROXYSQL CLUSTERS TO DISK;

-- 3. åœæ­¢è¢«ç§»é™¤çš„èŠ‚ç‚¹
-- ssh root@192.168.1.13 'systemctl stop proxysql'
```

### 6.5 å¤‡ä»½æ¢å¤ç­–ç•¥


**ğŸ’¾ é›†ç¾¤é…ç½®å¤‡ä»½**ï¼š

```bash
#!/bin/bash
# backup_proxysql_config.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/proxysql"
mkdir -p $BACKUP_DIR

# ä»ä»»æ„å¥åº·èŠ‚ç‚¹å¤‡ä»½é…ç½®
mysql -h192.168.1.10 -P6032 -uadmin -p << EOF > $BACKUP_DIR/config_$DATE.sql
-- å¤‡ä»½æ‰€æœ‰é…ç½®è¡¨
SELECT 'INSERT INTO mysql_servers VALUES' as '';
SELECT CONCAT('(', hostgroup_id, ',\'', hostname, '\',', port, ',', weight, ',\'', status, '\',', compression, ',', max_connections, ',', max_replication_lag, ',', use_ssl, ',', max_latency_ms, ',\'', comment, '\');') 
FROM mysql_servers;

SELECT 'INSERT INTO mysql_users VALUES' as '';
SELECT CONCAT('(\'', username, '\',\'', password, '\',', active, ',', use_ssl, ',', default_hostgroup, ',', default_schema, ',', schema_locked, ',', transaction_persistent, ',', fast_forward, ',', backend, ',', frontend, ',\'', comment, '\');')
FROM mysql_users;
EOF

echo "âœ… é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_DIR/config_$DATE.sql"
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤æ¦‚å¿µï¼šå¤šä¸ªProxySQLå®ä¾‹ç»„æˆï¼Œé…ç½®è‡ªåŠ¨åŒæ­¥çš„é«˜å¯ç”¨æ¶æ„
ğŸ”¸ é…ç½®åŒæ­¥ï¼šé›†ç¾¤å†…é…ç½®å˜æ›´çš„è‡ªåŠ¨ä¼ æ’­ï¼Œä¿è¯ä¸€è‡´æ€§
ğŸ”¸ èŠ‚ç‚¹é€šä¿¡ï¼šåŸºäºMySQLåè®®çš„é›†ç¾¤å†…éƒ¨é€šä¿¡æœºåˆ¶
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šå•èŠ‚ç‚¹æ•…éšœæ—¶çš„è‡ªåŠ¨åˆ‡æ¢å’Œæ¢å¤
ğŸ”¸ é›†ç¾¤ç®¡ç†ï¼šèŠ‚ç‚¹æ·»åŠ ã€ç§»é™¤ã€ç›‘æ§ç­‰è¿ç»´æ“ä½œ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é›†ç¾¤çš„ä»·å€¼**ï¼š
```
é«˜å¯ç”¨æ€§ï¼š
- å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- é…ç½®è‡ªåŠ¨åŒæ­¥ï¼Œå‡å°‘äººå·¥é”™è¯¯
- è´Ÿè½½åˆ†æ‹…ï¼Œæå‡æ•´ä½“æ€§èƒ½

ç®¡ç†ä¾¿åˆ©ï¼š
- ä¸€å¤„ä¿®æ”¹ï¼Œå…¨é›†ç¾¤ç”Ÿæ•ˆ
- ç»Ÿä¸€ç›‘æ§ï¼Œé›†ä¸­ç®¡ç†
- æ˜“äºæ‰©å±•ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´
```

**ğŸ”¹ éƒ¨ç½²æœ€ä½³å®è·µ**ï¼š
```
èŠ‚ç‚¹è§„åˆ’ï¼š
- å¥‡æ•°ä¸ªèŠ‚ç‚¹ï¼ˆ3ã€5ã€7ï¼‰é¿å…è„‘è£‚
- åˆ†å¸ƒåœ¨ä¸åŒæœºæˆ¿æˆ–å¯ç”¨åŒº
- ç¡¬ä»¶é…ç½®ç›¸åŒï¼Œç¡®ä¿æ€§èƒ½ä¸€è‡´

é…ç½®ç®¡ç†ï¼š
- ç»Ÿä¸€é…ç½®æ–‡ä»¶æ¨¡æ¿
- å®šæœŸå¤‡ä»½é›†ç¾¤é…ç½®
- å»ºç«‹é…ç½®å˜æ›´æµç¨‹

ç›‘æ§å‘Šè­¦ï¼š
- å®æ—¶ç›‘æ§èŠ‚ç‚¹çŠ¶æ€
- é…ç½®åŒæ­¥çŠ¶æ€æ£€æŸ¥
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **å¤§å‹ç”µå•†**ï¼šåŒ11ç­‰é«˜å³°æœŸé—´çš„æ•°æ®åº“è®¿é—®è´Ÿè½½å‡è¡¡
- **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“ç³»ç»Ÿçš„é«˜å¯ç”¨æ•°æ®åº“ä»£ç†
- **SaaSå¹³å°**ï¼šå¤šç§Ÿæˆ·ç¯å¢ƒä¸‹çš„æ•°æ®åº“è¿æ¥ç®¡ç†
- **æ¸¸æˆæœåŠ¡**ï¼šå®æ—¶æ•°æ®æŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–

**ğŸ”§ è¿ç»´å®è·µ**ï¼š
- **ç°åº¦å‘å¸ƒ**ï¼šåœ¨é›†ç¾¤ç¯å¢ƒä¸‹å®‰å…¨è¿›è¡Œé…ç½®å˜æ›´
- **æ•…éšœæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡ŒèŠ‚ç‚¹æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•
- **æ€§èƒ½è°ƒä¼˜**ï¼šåŸºäºé›†ç¾¤ç›‘æ§æ•°æ®è¿›è¡Œå‚æ•°ä¼˜åŒ–
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®ä¸šåŠ¡å¢é•¿é¢„æµ‹é›†ç¾¤æ‰©å®¹éœ€æ±‚

**ğŸ’¡ è®°å¿†æŠ€å·§**ï¼š
- **é›†ç¾¤ä¸‰è¦ç´ **ï¼šå¤šèŠ‚ç‚¹ + é…ç½®åŒæ­¥ + é«˜å¯ç”¨
- **éƒ¨ç½²å£è¯€**ï¼šå…ˆè§„åˆ’ã€å†éƒ¨ç½²ã€åç›‘æ§ã€å¸¸æ¼”ç»ƒ
- **æ•…éšœå¤„ç†**ï¼šå¿«å®šä½ã€å…ˆæ¢å¤ã€ååˆ†æã€é‡é¢„é˜²

**ğŸ“ å­¦ä¹ å»ºè®®**ï¼š
1. **å…ˆç†è§£å•å®ä¾‹**ï¼šç¡®ä¿æŒæ¡ProxySQLåŸºæœ¬åŠŸèƒ½
2. **åŠ¨æ‰‹æ­å»º**ï¼šåœ¨è™šæ‹Ÿæœºç¯å¢ƒæ­å»º3èŠ‚ç‚¹é›†ç¾¤
3. **æ•…éšœæ¨¡æ‹Ÿ**ï¼šäººä¸ºåˆ¶é€ æ•…éšœï¼Œç»ƒä¹ æ¢å¤æµç¨‹
4. **ç›‘æ§å®è·µ**ï¼šç¼–å†™ç›‘æ§è„šæœ¬ï¼Œç†Ÿæ‚‰é›†ç¾¤çŠ¶æ€
5. **é…ç½®ç®¡ç†**ï¼šç»ƒä¹ é…ç½®å˜æ›´å’ŒåŒæ­¥æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- ProxySQLé›†ç¾¤é€šè¿‡é…ç½®è‡ªåŠ¨åŒæ­¥å®ç°é«˜å¯ç”¨
- èŠ‚ç‚¹é—´åŸºäºMySQLåè®®è¿›è¡Œé€šä¿¡å’Œé…ç½®ä¼ æ’­
- ç›‘æ§å’Œæ•…éšœå¤„ç†æ˜¯é›†ç¾¤è¿ç»´çš„é‡è¦ç¯èŠ‚
- åˆç†çš„éƒ¨ç½²è§„åˆ’æ˜¯é›†ç¾¤ç¨³å®šè¿è¡Œçš„åŸºç¡€