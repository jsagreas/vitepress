---
title: 3、ProxySQL核心配置详解
---
## 📚 目录

1. [ProxySQL配置文件概述](#1-ProxySQL配置文件概述)
2. [Admin接口配置详解](#2-Admin接口配置详解)
3. [MySQL接口配置详解](#3-MySQL接口配置详解)
4. [数据目录与日志配置](#4-数据目录与日志配置)
5. [性能优化配置](#5-性能优化配置)
6. [网络连接配置](#6-网络连接配置)
7. [安全配置(SSL证书)](#7-安全配置SSL证书)
8. [集群配置参数](#8-集群配置参数)
9. [监控与调试配置](#9-监控与调试配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔧 ProxySQL配置文件概述


### 1.1 什么是proxysql.cnf配置文件


**简单理解**：`proxysql.cnf`就是ProxySQL的"大脑配置文件"，告诉ProxySQL该怎么工作

```
通俗比喻：
proxysql.cnf = 汽车的仪表盘设置
- 速度限制 → 连接数限制
- 油耗模式 → 内存使用策略  
- 导航设置 → 路由规则配置
- 安全配置 → SSL加密设置
```

**配置文件特点**：
- **位置**：通常在`/etc/proxysql.cnf`或启动目录
- **格式**：JSON格式，结构清晰易读
- **作用**：定义ProxySQL启动时的初始配置
- **优先级**：配置文件 < 数据库内配置

### 1.2 配置文件基本结构


```
proxysql.cnf配置架构：

┌─────────────────────┐
│    proxysql.cnf     │
├─────────────────────┤
│  datadir           │ ← 数据存储目录
│  admin_variables   │ ← 管理接口设置
│  mysql_interfaces  │ ← MySQL连接接口
│  mysql_servers     │ ← 后端MySQL服务器
│  mysql_users       │ ← 用户账号信息
│  mysql_query_rules │ ← SQL路由规则
│  scheduler         │ ← 定时任务
└─────────────────────┘
```

**核心配置块**：
```json
{
  "datadir": "/var/lib/proxysql",           // 数据目录
  "admin_variables": { },                   // 管理接口配置
  "mysql_interfaces": [ ],                  // MySQL接口配置
  "mysql_servers": [ ],                     // 后端服务器
  "mysql_users": [ ],                       // 用户管理
  "mysql_query_rules": [ ]                  // 查询路由规则
}
```

### 1.3 配置文件的工作原理


**配置加载流程**：
```
ProxySQL启动过程：

1. 读取proxysql.cnf文件
   ↓
2. 解析JSON配置内容  
   ↓
3. 初始化各个模块
   ↓
4. 加载到内存配置
   ↓
5. 启动服务监听端口
```

**重要理解**：
- 配置文件只在**首次启动**时被完全读取
- 后续配置修改主要通过**Admin接口**进行
- 配置分为三层：`RUNTIME` → `MEMORY` → `DISK`

---

## 2. 🔑 Admin接口配置详解


### 2.1 Admin接口是什么


**通俗解释**：Admin接口就是ProxySQL的"管理后台"，类似网站的管理员面板

```
生活比喻：
Admin接口 = 汽车的维修诊断接口
- 可以查看引擎状态 → 查看连接状态
- 可以调整参数 → 修改配置参数
- 可以运行诊断 → 执行SQL查询
- 需要专用工具连接 → 需要mysql客户端连接
```

### 2.2 Admin接口基础配置


```json
"admin_variables": {
  "admin_credentials": "admin:admin;radmin:radmin",
  "mysql_ifaces": "0.0.0.0:6032;/tmp/proxysql_admin.sock",
  "refresh_interval": 2000,
  "debug": false,
  "cluster_username": "cluster",
  "cluster_password": "cluster123"
}
```

**配置参数详解**：

**`admin_credentials`** - 管理员账号
```
格式：用户名:密码;用户名:密码
作用：定义可以连接Admin接口的账号
示例：admin:admin123;readonly:readonly123

理解：就像设置管理员密码，保护重要配置不被随意修改
```

**`mysql_ifaces`** - 监听接口
```
格式：IP:端口;socket文件路径
默认：0.0.0.0:6032
作用：定义Admin接口的连接方式

0.0.0.0:6032 → 允许任何IP通过6032端口连接
127.0.0.1:6032 → 只允许本机连接
/tmp/proxysql_admin.sock → Unix socket连接方式
```

### 2.3 Admin接口高级配置


```json
"admin_variables": {
  "refresh_interval": 2000,
  "read_only": false,
  "hash_passwords": true,
  "vacuum_stats": true,
  "stats_time_backend_query": true,
  "stats_time_query_processor": true
}
```

**高级参数说明**：

**`refresh_interval`** - 刷新间隔
```
单位：毫秒
默认：2000 (2秒)
作用：多久刷新一次统计信息
类比：汽车仪表盘的刷新频率
```

**`read_only`** - 只读模式
```
true：只能查看，不能修改配置
false：可以正常修改配置
场景：生产环境可设为true，防止误操作
```

**实际使用示例**：
```bash
# 连接Admin接口
mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt='ProxySQL Admin> '

# 查看当前配置
ProxySQL Admin> SELECT * FROM global_variables WHERE variable_name LIKE 'admin%';

# 修改配置
ProxySQL Admin> UPDATE global_variables SET variable_value='3000' 
                WHERE variable_name='admin-refresh_interval';
```

---

## 3. 🔌 MySQL接口配置详解


### 3.1 MySQL接口的作用


**通俗理解**：MySQL接口就是ProxySQL对外提供服务的"门面"，客户端通过这个接口连接

```
餐厅比喻：
MySQL接口 = 餐厅的服务窗口
- 接待客人 → 接受客户端连接
- 收取订单 → 接收SQL请求  
- 传递给厨房 → 转发给后端MySQL
- 返回菜品 → 返回查询结果
```

### 3.2 MySQL接口基础配置


```json
"mysql_interfaces": [
  {
    "address": "0.0.0.0",
    "port": 6033,
    "socket": "/tmp/proxysql.sock"
  }
]
```

**配置参数详解**：

**`address`** - 监听地址
```
0.0.0.0 → 监听所有网卡，允许远程连接
127.0.0.1 → 只监听本机，仅本地连接
具体IP → 只监听指定网卡

安全建议：
- 开发环境：可以用0.0.0.0
- 生产环境：建议用具体IP地址
```

**`port`** - 监听端口
```
默认：6033
作用：客户端连接的端口号
注意：不要与真实MySQL端口(3306)冲突

端口选择建议：
- 6033：ProxySQL默认端口
- 3306：避免使用，容易混淆
- 自定义：如3307、3308等
```

### 3.3 多接口配置示例


```json
"mysql_interfaces": [
  {
    "address": "0.0.0.0",
    "port": 6033,
    "socket": "/tmp/proxysql.sock"
  },
  {
    "address": "192.168.1.100", 
    "port": 3307
  }
]
```

**多接口应用场景**：
```
场景1：内外网分离
- 内网接口：192.168.1.100:3307 (内部应用)
- 外网接口：0.0.0.0:6033 (外部应用)

场景2：服务分离  
- 读写接口：192.168.1.100:3307
- 只读接口：192.168.1.100:3308

场景3：Socket连接
- TCP连接：用于网络应用
- Socket连接：用于本机应用，性能更好
```

**客户端连接示例**：
```bash
# 通过TCP连接
mysql -h 192.168.1.100 -P 6033 -u myuser -p

# 通过Socket连接  
mysql -S /tmp/proxysql.sock -u myuser -p

# 应用程序连接字符串
jdbc:mysql://192.168.1.100:6033/mydb
```

---

## 4. 📁 数据目录与日志配置


### 4.1 数据目录配置详解


**数据目录是什么**：ProxySQL存放所有数据文件的地方，类似MySQL的datadir

```
文件系统结构：
/var/lib/proxysql/
├── proxysql.db          ← 主配置数据库
├── proxysql_stats.db    ← 统计信息数据库  
├── cluster.log          ← 集群日志
├── proxysql.log         ← 主日志文件
└── proxysql.pid         ← 进程ID文件
```

**基础配置**：
```json
{
  "datadir": "/var/lib/proxysql",
  "errorlog": "/var/lib/proxysql/proxysql.log"
}
```

**目录权限要求**：
```bash
# 创建数据目录
sudo mkdir -p /var/lib/proxysql

# 设置正确权限
sudo chown proxysql:proxysql /var/lib/proxysql
sudo chmod 750 /var/lib/proxysql

# 确保ProxySQL用户有读写权限
ls -la /var/lib/proxysql
drwxr-x--- 2 proxysql proxysql 4096 Sep 11 14:30 proxysql
```

### 4.2 日志配置详解


**日志系统配置**：
```json
"admin_variables": {
  "mysql_ifaces": "0.0.0.0:6032",
  "admin_credentials": "admin:admin",
  "debug": false,
  "cluster_check_interval_ms": 1000,
  "cluster_check_status_frequency": 100
}
```

**重要日志参数**：

**`errorlog`** - 错误日志
```
作用：记录ProxySQL的错误和警告信息
位置：通常在数据目录下
重要性：排查问题的主要依据

查看日志：
tail -f /var/lib/proxysql/proxysql.log
```

**`debug`** - 调试模式
```
false：正常模式，只记录重要信息
true：调试模式，记录详细信息

注意：调试模式会产生大量日志，仅用于排查问题
```

### 4.3 日志管理最佳实践


**日志轮转配置**：
```bash
# 创建logrotate配置
sudo vim /etc/logrotate.d/proxysql

/var/lib/proxysql/proxysql.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

**日志监控脚本**：
```bash
#!/bin/bash
# 监控ProxySQL日志中的ERROR
tail -f /var/lib/proxysql/proxysql.log | grep -i error | while read line; do
    echo "$(date): $line" >> /var/log/proxysql_errors.log
    # 可以添加告警逻辑
done
```

---

## 5. ⚡ 性能优化配置


### 5.1 线程配置参数


**线程配置的重要性**：线程数量直接影响ProxySQL的并发处理能力

```
线程配置比喻：
ProxySQL = 快餐店
线程 = 服务员数量
- 线程太少 → 服务员不够，客人排队等待
- 线程太多 → 服务员太多，资源浪费
- 合适数量 → 高效服务，资源利用最优
```

**核心线程配置**：
```json
"admin_variables": {
  "mysql-threads": 4,
  "mysql-max_connections": 2048,
  "mysql-default_query_delay": 0,
  "mysql-default_query_timeout": 36000000,
  "mysql-have_compress": true,
  "mysql-poll_timeout": 2000,
  "mysql-interfaces": "0.0.0.0:6033",
  "mysql-default_schema": "information_schema"
}
```

**线程参数详解**：

**`mysql-threads`** - 工作线程数
```
默认值：4
建议值：CPU核心数 * 2
作用：处理MySQL请求的线程数量

计算公式：
- 4核CPU → 建议设置8个线程
- 8核CPU → 建议设置16个线程
- 16核CPU → 建议设置32个线程
```

**`mysql-max_connections`** - 最大连接数
```
默认值：2048
作用：允许的最大客户端连接数
考虑因素：
- 应用连接池大小
- 后端MySQL连接限制
- 服务器内存容量
```

### 5.2 内存配置优化


**内存相关配置**：
```json
"admin_variables": {
  "mysql-query_cache_size_MB": 256,
  "mysql-query_cache_stores_empty_result": true,
  "mysql-commands_stats": true,
  "mysql-sessions_sort": true,
  "mysql-connect_retries_on_failure": 10
}
```

**内存参数说明**：

**`mysql-query_cache_size_MB`** - 查询缓存大小
```
单位：MB
默认：256MB
作用：缓存查询结果，提高重复查询性能

内存计算：
- 小型应用：128-256MB
- 中型应用：512-1024MB  
- 大型应用：2048-4096MB
```

**内存使用监控**：
```sql
-- 查看内存使用情况
SELECT * FROM stats_memory_metrics;

-- 查看查询缓存命中率
SELECT * FROM stats_mysql_query_cache;
```

### 5.3 连接池配置优化


**连接池配置**：
```json
"mysql_servers": [
  {
    "address": "192.168.1.10",
    "port": 3306,
    "hostgroup": 0,
    "status": "ONLINE",
    "weight": 1000,
    "compression": 0,
    "max_connections": 200,
    "max_replication_lag": 10,
    "use_ssl": 0,
    "max_latency_ms": 0,
    "comment": "Primary MySQL Server"
  }
]
```

**连接池参数详解**：

**`max_connections`** - 每台服务器最大连接数
```
作用：控制ProxySQL到后端MySQL的连接数
计算：后端MySQL max_connections / ProxySQL实例数

例如：
MySQL max_connections = 1000
ProxySQL实例数 = 2
每个ProxySQL max_connections = 400-500
```

**连接复用配置**：
```sql
-- 配置连接复用
UPDATE global_variables SET variable_value='true' 
WHERE variable_name='mysql-multiplexing';

-- 配置连接池大小
UPDATE mysql_servers SET max_connections=100 
WHERE hostgroup_id=0;
```

---

## 6. 🌐 网络连接配置


### 6.1 网络接口配置详解


**网络配置的重要性**：决定了ProxySQL如何与客户端和后端服务器通信

```
网络配置架构：

客户端应用
    ↓ (TCP/Socket)
ProxySQL接口 (mysql_interfaces)
    ↓ (TCP连接池)
后端MySQL服务器
```

**网络超时配置**：
```json
"admin_variables": {
  "mysql-connect_timeout_server": 3000,
  "mysql-connect_timeout_server_max": 10000,
  "mysql-ping_timeout_server": 500,
  "mysql-ping_interval_server_msec": 120000,
  "mysql-client_host_cache_size": 0,
  "mysql-client_host_error_counts": 0
}
```

### 6.2 超时参数详解


**`mysql-connect_timeout_server`** - 服务器连接超时
```
单位：毫秒
默认：3000ms (3秒)
作用：连接后端MySQL的超时时间

设置建议：
- 本地网络：1000-3000ms
- 跨机房：5000-10000ms
- 云环境：3000-8000ms
```

**`mysql-ping_timeout_server`** - 心跳超时
```
作用：检测后端MySQL是否存活
默认：500ms
场景：网络不稳定时适当增加
```

**`mysql-ping_interval_server_msec`** - 心跳间隔
```
单位：毫秒  
默认：120000ms (2分钟)
作用：多久检查一次后端服务器状态

调优建议：
- 网络稳定：120000ms (2分钟)
- 网络不稳定：60000ms (1分钟)
- 要求高可用：30000ms (30秒)
```

### 6.3 网络监控配置


**连接状态监控**：
```sql
-- 查看连接池状态
SELECT * FROM stats_mysql_connection_pool;

-- 查看网络延迟统计
SELECT * FROM stats_mysql_commands_counters;

-- 查看错误连接统计  
SELECT * FROM stats_mysql_connection_pool_reset;
```

**网络问题排查**：
```bash
# 检查网络连通性
telnet 192.168.1.10 3306

# 检查网络延迟
ping -c 4 192.168.1.10

# 查看ProxySQL连接状态
mysql -u admin -p -h 127.0.0.1 -P 6032 -e "
SELECT srv_host, srv_port, status, Queries, Bytes_data_sent, Bytes_data_recv 
FROM stats_mysql_connection_pool;"
```

---

## 7. 🔒 安全配置(SSL证书)


### 7.1 SSL配置概述


**SSL的作用**：为ProxySQL提供加密通信，保护数据传输安全

```
SSL通信流程：

客户端                     ProxySQL                  MySQL服务器
   |                          |                           |
   |--[SSL握手]--------------->|                           |
   |<-[证书验证]---------------|                           |
   |                          |--[SSL连接]--------------->|
   |                          |<-[加密通道]---------------|
   |--[加密SQL请求]----------->|--[解密转发]-------------->|
   |<-[加密结果]---------------|<-[加密结果]---------------|
```

### 7.2 SSL基础配置


**SSL配置参数**：
```json
"admin_variables": {
  "mysql-have_ssl": true,
  "mysql-ssl_p2s_ca": "/etc/proxysql/ssl/ca.pem",
  "mysql-ssl_p2s_cert": "/etc/proxysql/ssl/client.pem", 
  "mysql-ssl_p2s_key": "/etc/proxysql/ssl/client-key.pem",
  "mysql-ssl_p2s_cipher": "",
  "mysql-ssl_p2s_crl": "",
  "mysql-ssl_p2s_crlpath": ""
}
```

**SSL文件说明**：

**`mysql-ssl_p2s_ca`** - CA证书
```
作用：验证服务器证书的根证书
位置：/etc/proxysql/ssl/ca.pem
来源：通常由MySQL服务器提供
```

**`mysql-ssl_p2s_cert`** - 客户端证书
```
作用：ProxySQL作为客户端连接MySQL时使用
位置：/etc/proxysql/ssl/client.pem
```

**`mysql-ssl_p2s_key`** - 客户端私钥
```
作用：客户端证书对应的私钥
位置：/etc/proxysql/ssl/client-key.pem
权限：600 (仅所有者可读写)
```

### 7.3 SSL证书部署


**证书文件准备**：
```bash
# 创建SSL目录
sudo mkdir -p /etc/proxysql/ssl

# 复制证书文件
sudo cp ca.pem /etc/proxysql/ssl/
sudo cp client-cert.pem /etc/proxysql/ssl/  
sudo cp client-key.pem /etc/proxysql/ssl/

# 设置正确权限
sudo chown -R proxysql:proxysql /etc/proxysql/ssl
sudo chmod 644 /etc/proxysql/ssl/ca.pem
sudo chmod 644 /etc/proxysql/ssl/client-cert.pem  
sudo chmod 600 /etc/proxysql/ssl/client-key.pem
```

**SSL配置验证**：
```sql
-- 检查SSL配置
SELECT variable_name, variable_value 
FROM global_variables 
WHERE variable_name LIKE 'mysql-ssl%';

-- 测试SSL连接
SELECT * FROM mysql_servers WHERE use_ssl=1;
```

### 7.4 SSL故障排查


**常见SSL问题**：
```bash
# 检查证书有效性
openssl x509 -in /etc/proxysql/ssl/client-cert.pem -text -noout

# 检查私钥匹配
openssl rsa -in /etc/proxysql/ssl/client-key.pem -check

# 测试SSL连接
openssl s_client -connect 192.168.1.10:3306 \
  -cert /etc/proxysql/ssl/client-cert.pem \
  -key /etc/proxysql/ssl/client-key.pem \
  -CAfile /etc/proxysql/ssl/ca.pem
```

---

## 8. 🌐 集群配置参数


### 8.1 ProxySQL集群概述


**集群的作用**：多个ProxySQL实例之间同步配置，实现高可用

```
ProxySQL集群架构：

   ProxySQL-1          ProxySQL-2          ProxySQL-3
       |                   |                   |
       |<---配置同步------->|<---配置同步------->|
       |                   |                   |
       ↓                   ↓                   ↓
   MySQL主库           MySQL主库           MySQL主库
   MySQL从库           MySQL从库           MySQL从库
```

### 8.2 集群基础配置


**集群配置参数**：
```json
"admin_variables": {
  "cluster_username": "cluster",
  "cluster_password": "cluster123", 
  "cluster_check_interval_ms": 200,
  "cluster_check_status_frequency": 100,
  "cluster_mysql_query_rules_diffs_before_sync": 3,
  "cluster_mysql_servers_diffs_before_sync": 3,
  "cluster_mysql_users_diffs_before_sync": 3,
  "cluster_proxysql_servers_diffs_before_sync": 3
}
```

**集群参数详解**：

**`cluster_username/password`** - 集群认证
```
作用：集群节点间通信的认证信息
安全：密码要足够复杂，避免使用默认值
建议：cluster_user_2024!@#
```

**`cluster_check_interval_ms`** - 检查间隔
```
单位：毫秒
默认：200ms
作用：多久检查一次其他节点的配置变化

调优：
- 实时性要求高：100-200ms
- 网络带宽有限：500-1000ms
```

### 8.3 集群节点配置


**添加集群节点**：
```sql
-- 在每个ProxySQL节点上执行
INSERT INTO proxysql_servers(hostname, port, weight, comment) VALUES
('192.168.1.11', 6032, 1000, 'ProxySQL Node 1'),
('192.168.1.12', 6032, 1000, 'ProxySQL Node 2'), 
('192.168.1.13', 6032, 1000, 'ProxySQL Node 3');

-- 加载配置到运行时
LOAD PROXYSQL SERVERS TO RUNTIME;

-- 保存配置到磁盘
SAVE PROXYSQL SERVERS TO DISK;
```

**集群状态监控**：
```sql
-- 查看集群节点状态
SELECT hostname, port, weight, status, comment 
FROM runtime_proxysql_servers;

-- 查看配置同步状态
SELECT * FROM stats_proxysql_servers_checksums;

-- 查看集群同步日志
SELECT * FROM stats_proxysql_servers_metrics;
```

### 8.4 集群故障处理


**集群脑裂处理**：
```sql
-- 检查配置差异
SELECT hostname, port, checksum, changed_at 
FROM stats_proxysql_servers_checksums;

-- 强制同步配置
PROXYSQL FLUSH CONFIGDB; 

-- 重新加载集群配置
LOAD PROXYSQL SERVERS FROM DISK;
LOAD PROXYSQL SERVERS TO RUNTIME;
```

---

## 9. 📊 监控与调试配置


### 9.1 监控统计配置


**监控配置的重要性**：帮助了解ProxySQL的运行状态和性能表现

```
监控体系架构：

ProxySQL内部统计
       ↓
统计数据库表 (stats_*)
       ↓  
监控工具读取 (Prometheus/Grafana)
       ↓
告警系统
```

**监控相关配置**：
```json
"admin_variables": {
  "mysql-commands_stats": true,
  "mysql-sessions_sort": true, 
  "mysql-threads": 4,
  "mysql-max_connections": 2048,
  "mysql-monitor_username": "monitor",
  "mysql-monitor_password": "monitor123",
  "mysql-monitor_history": 600000,
  "mysql-monitor_connect_interval": 60000,
  "mysql-monitor_ping_interval": 10000,
  "mysql-monitor_read_only_interval": 1500,
  "mysql-monitor_replication_lag_interval": 10000
}
```

### 9.2 监控参数详解


**`mysql-commands_stats`** - 命令统计
```
作用：是否收集SQL命令的统计信息
true：收集详细的SQL执行统计
false：不收集，节省性能

查看统计：
SELECT * FROM stats_mysql_commands_counters;
```

**`mysql-monitor_*`** - 监控配置
```
mysql-monitor_username：监控用户名
mysql-monitor_password：监控密码
mysql-monitor_connect_interval：连接检查间隔(毫秒)
mysql-monitor_ping_interval：心跳检查间隔(毫秒)
mysql-monitor_read_only_interval：只读状态检查间隔
mysql-monitor_replication_lag_interval：复制延迟检查间隔
```

### 9.3 调试配置选项


**调试模式配置**：
```json
"admin_variables": {
  "debug": false,
  "mysql-eventslog_filesize": 100000000,
  "mysql-eventslog_default_log": 0,
  "mysql-eventslog_format": 1,
  "mysql-auditlog_filesize": 100000000,
  "mysql-auditlog_filename": ""
}
```

**调试参数说明**：

**`debug`** - 调试模式
```
false：正常模式
true：调试模式，输出详细日志

注意：调试模式会影响性能，仅用于问题排查
```

**`mysql-eventslog_*`** - 事件日志
```
eventslog_filesize：日志文件大小限制
eventslog_default_log：默认日志级别  
eventslog_format：日志格式

用途：记录详细的SQL执行事件
```

### 9.4 监控最佳实践


**关键监控指标**：
```sql
-- 连接池使用情况
SELECT hostgroup, srv_host, srv_port, status, 
       ConnUsed, ConnFree, ConnOK, ConnERR
FROM stats_mysql_connection_pool;

-- SQL查询统计
SELECT Command, Total_Time_us, Total_cnt, cnt_100us, cnt_1ms, cnt_10ms
FROM stats_mysql_commands_counters 
ORDER BY Total_Time_us DESC LIMIT 10;

-- 查询规则命中统计
SELECT rule_id, hits, match_digest, destination_hostgroup 
FROM stats_mysql_query_rules 
ORDER BY hits DESC LIMIT 10;
```

**监控脚本示例**：
```bash
#!/bin/bash
# ProxySQL健康检查脚本

PROXYSQL_HOST="127.0.0.1"
PROXYSQL_PORT="6032"
PROXYSQL_USER="admin"
PROXYSQL_PASS="admin"

# 检查ProxySQL是否运行
if ! mysql -u$PROXYSQL_USER -p$PROXYSQL_PASS -h$PROXYSQL_HOST -P$PROXYSQL_PORT -e "SELECT 1" &>/dev/null; then
    echo "ERROR: ProxySQL is not responding"
    exit 1
fi

# 检查后端MySQL连接
mysql -u$PROXYSQL_USER -p$PROXYSQL_PASS -h$PROXYSQL_HOST -P$PROXYSQL_PORT -e "
SELECT srv_host, srv_port, status, ConnUsed, ConnFree 
FROM stats_mysql_connection_pool 
WHERE status != 'ONLINE';" | grep -v "srv_host"

if [ $? -eq 0 ]; then
    echo "WARNING: Some MySQL servers are not online"
fi

echo "ProxySQL health check completed"
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心配置


```
🔸 配置文件结构：proxysql.cnf的JSON格式和主要配置块
🔸 Admin接口：管理员连接、认证、监听配置
🔸 MySQL接口：客户端连接的门面配置
🔸 数据目录：数据文件存储和日志管理
🔸 性能优化：线程数、内存、连接池配置
🔸 网络配置：超时、心跳、连接管理
🔸 安全配置：SSL证书和加密通信
🔸 集群配置：多节点配置同步
🔸 监控调试：统计信息和故障排查
```

### 10.2 配置要点理解


**🔹 配置层次关系**
```
配置文件 → 内存配置 → 运行时配置
- 配置文件：启动时读取的初始配置
- 内存配置：可以修改但未生效的配置  
- 运行时配置：当前生效的配置

操作命令：
LOAD ... TO RUNTIME  (加载到运行时)
SAVE ... TO DISK     (保存到磁盘)
```

**🔹 性能调优原则**
```
线程配置：CPU核心数的1-2倍
内存配置：根据查询缓存需求设置
连接池：不超过后端MySQL连接限制
超时配置：根据网络环境调整
```

**🔹 安全配置要点**
```
Admin接口：使用强密码，限制监听地址
SSL配置：正确设置证书文件和权限
集群安全：使用复杂的集群认证密码
监控账号：最小权限原则
```

### 10.3 实际应用指导


**🎯 生产环境配置建议**
```
数据目录：独立磁盘，定期备份
日志管理：配置日志轮转，监控错误日志
性能监控：开启统计收集，定期分析
安全加固：SSL加密，访问控制
集群部署：至少3个节点，奇数个避免脑裂
```

**🛠️ 故障排查思路**
```
1. 检查日志文件：查看错误和警告信息
2. 查看统计信息：分析连接池和SQL执行状态  
3. 检查配置同步：集群环境检查配置一致性
4. 网络连通性：验证到后端MySQL的连接
5. 资源使用：检查CPU、内存、连接数
```

**🔧 日常维护任务**
```
配置备份：定期备份proxysql.cnf和数据库
性能监控：关注连接池使用率、SQL响应时间
日志清理：定期清理过期日志文件
安全审计：检查访问账号和权限设置
版本更新：关注ProxySQL版本更新和安全补丁
```

### 10.4 核心记忆要点


**核心记忆口诀**：
- **配置三层**：文件→内存→运行时，层层递进要记清
- **接口两个**：Admin管理、MySQL服务，各司其职不混淆  
- **性能四要素**：线程、内存、连接、超时，合理配置保性能
- **安全三保障**：认证、加密、权限，多重防护保安全
- **监控全覆盖**：连接、查询、错误、资源，实时掌握系统状态

**实践要点**：
- 先理解作用，再配置参数
- 小步调整，逐步优化
- 监控先行，数据说话
- 安全第一，性能第二
- 文档记录，便于维护