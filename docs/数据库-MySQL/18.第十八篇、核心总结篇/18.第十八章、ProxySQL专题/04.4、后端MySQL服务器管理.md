---
title: 4、后端MySQL服务器管理
---
## 📚 目录

1. [后端服务器管理概述](#1-后端服务器管理概述)
2. [mysql_servers表详解](#2-mysql_servers表详解)
3. [服务器添加与配置](#3-服务器添加与配置)
4. [服务器状态管理](#4-服务器状态管理)
5. [权重与负载均衡](#5-权重与负载均衡)
6. [健康检查配置](#6-健康检查配置)
7. [读写分离配置](#7-读写分离配置)
8. [故障转移机制](#8-故障转移机制)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 后端服务器管理概述


### 1.1 什么是后端服务器管理


**简单理解**：
ProxySQL就像一个"聪明的交通指挥员"，它需要知道有哪些MySQL服务器可以使用，每个服务器的状态如何，哪个服务器负责处理什么类型的请求。这就是后端服务器管理的核心作用。

```
客户端应用
    ↓
ProxySQL中间件 ← 这里管理所有后端MySQL服务器
    ↓
┌─────────┬─────────┬─────────┐
│MySQL主库│MySQL从库│MySQL从库│
│ (写操作)│ (读操作)│ (读操作)│
└─────────┴─────────┴─────────┘
```

### 1.2 为什么需要管理后端服务器


**解决的核心问题**：

🔹 **服务器发现** - ProxySQL怎么知道有哪些MySQL服务器？
🔹 **负载分配** - 多个服务器时，请求该发给谁？
🔹 **故障处理** - 某个服务器宕机了怎么办？
🔹 **读写分离** - 读请求和写请求要分别发给不同的服务器
🔹 **性能优化** - 根据服务器性能合理分配负载

### 1.3 管理架构概览


```
ProxySQL管理层次：
┌─────────────────────────────────┐
│     ProxySQL Admin接口          │ ← 管理入口
├─────────────────────────────────┤
│     mysql_servers表             │ ← 服务器配置存储
├─────────────────────────────────┤
│     健康检查模块                │ ← 监控服务器状态
├─────────────────────────────────┤
│     负载均衡引擎                │ ← 请求分发逻辑
└─────────────────────────────────┘
```

---

## 2. 📋 mysql_servers表详解


### 2.1 表结构说明


`mysql_servers`表是ProxySQL管理后端MySQL服务器的核心配置表。就像一个"服务器通讯录"，记录了所有可用服务器的详细信息。

```sql
-- 查看mysql_servers表结构
DESC mysql_servers;
```

### 2.2 关键字段详解


| 字段名 | 数据类型 | 作用说明 | 示例值 |
|--------|----------|----------|--------|
| `hostgroup_id` | **INT** | `服务器组ID，用于区分不同用途的服务器` | `0(写组)，1(读组)` |
| `hostname` | **VARCHAR** | `MySQL服务器IP地址或主机名` | `192.168.1.10` |
| `port` | **INT** | `MySQL服务器端口号` | `3306` |
| `status` | **VARCHAR** | `服务器当前状态` | `ONLINE，OFFLINE` |
| `weight` | **INT** | `负载权重，数值越大分配越多请求` | `1000` |
| `compression` | **INT** | `是否启用压缩(0关闭，1开启)` | `0` |
| `max_connections` | **INT** | `最大连接数限制` | `1000` |
| `max_replication_lag` | **INT** | `最大复制延迟(秒)` | `10` |
| `use_ssl` | **INT** | `是否使用SSL连接` | `0` |
| `max_latency_ms` | **INT** | `最大延迟毫秒数` | `1000` |
| `comment` | **VARCHAR** | `服务器备注信息` | `主库服务器` |

### 2.3 服务器组概念


**hostgroup_id**是服务器管理的核心概念：

```
常见的服务器组划分：
┌─────────────────┬──────────────────┐
│  hostgroup_id   │     用途说明     │
├─────────────────┼──────────────────┤
│       0         │   写操作组(主库)  │
│       1         │   读操作组(从库)  │
│       2         │   备用读组       │
│       3         │   报表专用组     │
└─────────────────┴──────────────────┘

作用：通过不同的组ID，可以实现读写分离和负载分配
```

---

## 3. ⚙️ 服务器添加与配置


### 3.1 添加后端服务器


**基本语法**：
```sql
INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, status
) VALUES (
    组ID, 'IP地址', 端口, 权重, '状态'
);
```

**实际示例**：
```sql
-- 添加主库服务器(写操作组)
INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, status, comment
) VALUES (
    0, '192.168.1.10', 3306, 1000, 'ONLINE', 'MySQL主库'
);

-- 添加从库服务器(读操作组)
INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, status, comment
) VALUES (
    1, '192.168.1.11', 3306, 900, 'ONLINE', 'MySQL从库1'
);

INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, status, comment
) VALUES (
    1, '192.168.1.12', 3306, 800, 'ONLINE', 'MySQL从库2'
);
```

### 3.2 配置高级参数


```sql
-- 配置带完整参数的服务器
INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, status,
    max_connections, max_replication_lag, max_latency_ms,
    use_ssl, compression, comment
) VALUES (
    1, '192.168.1.13', 3306, 1000, 'ONLINE',
    500,    -- 最大连接数
    30,     -- 最大复制延迟30秒
    2000,   -- 最大延迟2秒
    0,      -- 不使用SSL
    0,      -- 不使用压缩
    '高性能读库'
);
```

### 3.3 应用配置变更


```sql
-- 配置变更后必须执行以下命令才能生效
LOAD MYSQL SERVERS TO RUNTIME;  -- 加载到运行时
SAVE MYSQL SERVERS TO DISK;     -- 保存到磁盘
```

> **💡 重要提示**：配置修改后必须执行上述命令，否则更改不会生效！

---

## 4. 🔧 服务器状态管理


### 4.1 服务器状态类型


```
服务器状态说明：
┌─────────────┬─────────────────────────────┐
│    状态     │           含义说明          │
├─────────────┼─────────────────────────────┤
│   ONLINE    │ 在线可用，正常处理请求      │
│   OFFLINE   │ 离线不可用，不接收新请求    │
│ SOFT_OFFLINE│ 软下线，完成现有连接后下线  │
│ SHUNNED     │ 被屏蔽，健康检查失败后状态  │
└─────────────┴─────────────────────────────┘
```

### 4.2 手动修改服务器状态


```sql
-- 将服务器设置为离线(维护时使用)
UPDATE mysql_servers 
SET status='OFFLINE' 
WHERE hostname='192.168.1.11' AND port=3306;

-- 将服务器重新上线
UPDATE mysql_servers 
SET status='ONLINE' 
WHERE hostname='192.168.1.11' AND port=3306;

-- 应用状态变更
LOAD MYSQL SERVERS TO RUNTIME;
```

### 4.3 查看服务器状态


```sql
-- 查看所有服务器状态
SELECT 
    hostgroup_id,
    hostname,
    port,
    status,
    weight,
    ConnUsed,    -- 当前使用连接数
    MaxConnUsed, -- 历史最大连接数
    Queries,     -- 处理的查询数
    comment
FROM stats_mysql_connection_pool 
ORDER BY hostgroup_id, hostname;
```

**状态监控示例输出**：
```
+----------+---------------+------+--------+--------+---------+-------------+---------+-------------+
|hostgroup |hostname       |port  |status  |weight  |ConnUsed |MaxConnUsed  |Queries  |comment      |
+----------+---------------+------+--------+--------+---------+-------------+---------+-------------+
|0         |192.168.1.10   |3306  |ONLINE  |1000    |5        |15           |1245     |MySQL主库    |
|1         |192.168.1.11   |3306  |ONLINE  |900     |8        |20           |3456     |MySQL从库1   |
|1         |192.168.1.12   |3306  |ONLINE  |800     |6        |18           |2890     |MySQL从库2   |
+----------+---------------+------+--------+--------+---------+-------------+---------+-------------+
```

---

## 5. ⚖️ 权重与负载均衡


### 5.1 权重机制原理


**权重的作用**：
权重就像"服务器的处理能力评分"，ProxySQL根据这个评分来决定给每个服务器分配多少请求。

```
权重分配示例：
服务器A: 权重1000  →  40%的请求
服务器B: 权重800   →  32%的请求  
服务器C: 权重700   →  28%的请求

计算公式：
服务器占比 = 该服务器权重 ÷ 总权重 × 100%
```

### 5.2 权重配置策略


```sql
-- 根据服务器性能配置不同权重
UPDATE mysql_servers SET weight = 1500 
WHERE hostname='192.168.1.11';  -- 高性能服务器

UPDATE mysql_servers SET weight = 1000 
WHERE hostname='192.168.1.12';  -- 标准性能服务器

UPDATE mysql_servers SET weight = 500 
WHERE hostname='192.168.1.13';  -- 较低性能服务器

-- 应用权重配置
LOAD MYSQL SERVERS TO RUNTIME;
```

### 5.3 负载均衡算法


ProxySQL支持多种负载均衡算法：

| 算法类型 | 适用场景 | 优缺点 |
|----------|----------|--------|
| **权重轮询** | `服务器性能不同` | `考虑权重，分配均匀` |
| **最少连接** | `长连接应用` | `避免连接堆积，但计算开销大` |
| **随机分配** | `短连接应用` | `简单快速，但可能不均匀` |

---

## 6. 🏥 健康检查配置


### 6.1 健康检查机制


ProxySQL会定期检查后端MySQL服务器的健康状态，就像"医生定期体检"一样。

```
健康检查流程：
ProxySQL → [连接测试] → MySQL服务器
    ↓
[检查结果] → ONLINE/SHUNNED
    ↓
[更新状态] → 路由表更新
```

### 6.2 配置健康检查参数


```sql
-- 配置健康检查相关参数
SET mysql-monitor_enabled='true';                    -- 启用监控
SET mysql-monitor_connect_interval=2000;             -- 连接检查间隔2秒
SET mysql-monitor_connect_timeout=1000;              -- 连接超时1秒
SET mysql-monitor_ping_interval=10000;               -- ping检查间隔10秒
SET mysql-monitor_ping_timeout=1000;                 -- ping超时1秒

-- 应用配置
LOAD MYSQL VARIABLES TO RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
```

### 6.3 查看健康检查日志


```sql
-- 查看连接监控日志
SELECT * FROM monitor.mysql_server_connect_log 
ORDER BY time_start_us DESC LIMIT 10;

-- 查看ping监控日志  
SELECT * FROM monitor.mysql_server_ping_log 
ORDER BY time_start_us DESC LIMIT 10;
```

### 6.4 自定义健康检查


```sql
-- 设置自定义健康检查查询
SET mysql-monitor_query_interval=5000;              -- 查询检查间隔5秒
SET mysql-monitor_query_timeout=1000;               -- 查询超时1秒
SET mysql-monitor_query='SELECT 1 as ping_check';   -- 自定义检查语句

LOAD MYSQL VARIABLES TO RUNTIME;
```

---

## 7. 🔄 读写分离配置


### 7.1 读写分离原理


读写分离的核心思想是：**写操作发给主库，读操作发给从库**。

```
读写分离架构：
客户端应用
    ↓
ProxySQL判断SQL类型
    ↓
┌─────────────┬─────────────┐
│  写操作SQL  │  读操作SQL  │
│     ↓       │     ↓       │
│  主库(组0)  │  从库(组1)  │ 
└─────────────┴─────────────┘
```

### 7.2 配置读写分离


```sql
-- 第一步：配置服务器组
-- 主库放在组0(写组)
INSERT INTO mysql_servers VALUES (0,'192.168.1.10',3306,1000,'ONLINE',0,1000,10,1000,0,0,'主库');

-- 从库放在组1(读组)  
INSERT INTO mysql_servers VALUES (1,'192.168.1.11',3306,900,'ONLINE',0,1000,10,1000,0,0,'从库1');
INSERT INTO mysql_servers VALUES (1,'192.168.1.12',3306,800,'ONLINE',0,1000,10,1000,0,0,'从库2');

-- 第二步：配置路由规则(在mysql_query_rules表中)
INSERT INTO mysql_query_rules (
    rule_id, active, match_pattern, destination_hostgroup, apply
) VALUES (
    1, 1, '^SELECT.*', 1, 1  -- SELECT查询路由到读组(组1)
);

INSERT INTO mysql_query_rules (
    rule_id, active, match_pattern, destination_hostgroup, apply  
) VALUES (
    2, 1, '^INSERT|UPDATE|DELETE.*', 0, 1  -- 写操作路由到写组(组0)
);

-- 应用配置
LOAD MYSQL SERVERS TO RUNTIME;
LOAD MYSQL QUERY RULES TO RUNTIME;
```

### 7.3 验证读写分离


```sql
-- 查看查询路由统计
SELECT 
    hostgroup,
    schemaname,
    digest_text,
    count_star as query_count
FROM stats_mysql_query_digest 
WHERE digest_text LIKE 'SELECT%' 
ORDER BY count_star DESC;
```

---

## 8. 🛡️ 故障转移机制


### 8.1 自动故障转移


当ProxySQL检测到服务器故障时，会自动将其状态改为`SHUNNED`，停止向其发送新请求。

```
故障转移流程：
正常状态: ONLINE → 处理请求
    ↓
健康检查失败
    ↓  
自动标记: SHUNNED → 停止新请求
    ↓
现有连接: 等待完成 → 关闭连接
    ↓
流量转移: 其他服务器 → 承接负载
```

### 8.2 配置故障转移参数


```sql
-- 配置故障检测敏感度
SET mysql-monitor_connect_interval=1000;     -- 检查频率1秒
SET mysql-monitor_connect_timeout=200;       -- 超时200ms就认为失败
SET mysql-monitor_ping_max_failures=3;       -- 连续3次失败后下线

-- 配置复制延迟检测
UPDATE mysql_servers 
SET max_replication_lag=30 
WHERE hostgroup_id=1;  -- 从库最大延迟30秒

LOAD MYSQL VARIABLES TO RUNTIME;
LOAD MYSQL SERVERS TO RUNTIME;
```

### 8.3 手动故障恢复


```sql
-- 当服务器恢复后，手动将其重新上线
UPDATE mysql_servers 
SET status='ONLINE' 
WHERE hostname='192.168.1.11' AND port=3306;

LOAD MYSQL SERVERS TO RUNTIME;

-- 验证服务器是否重新接收请求
SELECT hostname, status, ConnUsed, Queries 
FROM stats_mysql_connection_pool 
WHERE hostname='192.168.1.11';
```

### 8.4 延迟监控配置


```sql
-- 配置复制延迟监控
INSERT INTO mysql_servers(
    hostgroup_id, hostname, port, weight, 
    max_replication_lag, status
) VALUES (
    1, '192.168.1.13', 3306, 1000,
    10,  -- 最大允许延迟10秒
    'ONLINE'
);

-- 当从库延迟超过设定值时，ProxySQL会自动将其标记为SHUNNED
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 mysql_servers表：ProxySQL后端服务器配置的核心表
🔸 hostgroup_id：服务器组概念，用于区分读写服务器
🔸 权重机制：通过weight字段控制负载分配比例
🔸 状态管理：ONLINE/OFFLINE/SHUNNED等状态的含义和作用
🔸 健康检查：自动监控服务器可用性的机制
🔸 配置生效：修改后必须LOAD TO RUNTIME才能生效
```

### 9.2 关键理解要点


**🔹 服务器组的作用**
```
理解要点：
- hostgroup_id是实现读写分离的基础
- 不同的组ID代表不同的用途和角色
- 通过查询规则将SQL路由到对应的组
```

**🔹 权重与负载均衡**
```
实际应用：
- 权重越高，分配的请求越多
- 可以根据服务器性能调整权重
- 权重为0等同于临时下线
```

**🔹 故障转移机制**
```
保障高可用：
- 自动检测服务器故障
- 自动停止向故障服务器发送请求
- 需要手动恢复或自动恢复(配置依赖)
```

### 9.3 实际应用价值


**📊 生产环境建议**：
- **定期监控**：查看stats表了解服务器状态
- **合理权重**：根据服务器性能设置权重
- **健康检查**：配置合适的检查频率和超时时间
- **文档记录**：在comment字段记录服务器用途

**🔧 故障处理流程**：
1. 通过监控发现服务器异常
2. 查看ProxySQL日志确认问题
3. 手动下线故障服务器
4. 修复服务器问题
5. 验证后重新上线

**核心记忆**：
- 后端服务器管理是ProxySQL的基础功能
- mysql_servers表记录所有服务器信息
- 通过hostgroup_id实现读写分离
- 健康检查保障系统高可用性
- 配置修改后必须加载到运行时才生效