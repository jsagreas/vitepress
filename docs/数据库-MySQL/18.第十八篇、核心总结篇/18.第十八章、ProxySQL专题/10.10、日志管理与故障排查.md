---
title: 10、日志管理与故障排查
---
## 📚 目录

1. [日志系统概述](#1-日志系统概述)
2. [错误日志分析](#2-错误日志分析)
3. [查询日志记录](#3-查询日志记录)
4. [审计日志配置](#4-审计日志配置)
5. [日志级别与轮转](#5-日志级别与轮转)
6. [慢查询日志监控](#6-慢查询日志监控)
7. [连接日志分析](#7-连接日志分析)
8. [故障诊断方法](#8-故障诊断方法)
9. [常见问题处理](#9-常见问题处理)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 📊 日志系统概述


### 1.1 ProxySQL日志体系结构


**🔸 日志系统的作用**
```
ProxySQL日志系统就像医院的病历记录：
• 记录每个"病人"(连接)的状态
• 追踪每次"治疗"(查询)的过程  
• 发现"病症"(故障)的根本原因
• 预防"疾病"(性能问题)的发生
```

**📋 日志类型分类**

| 日志类型 | **作用** | **重要程度** | **适用场景** |
|---------|----------|-------------|-------------|
| 🔴 **错误日志** | `记录系统异常和错误` | `★★★★★` | `故障诊断` |
| 📝 **查询日志** | `记录SQL执行详情` | `★★★★☆` | `性能优化` |
| 🔍 **审计日志** | `记录安全相关操作` | `★★★☆☆` | `安全审计` |
| 🐌 **慢查询日志** | `记录执行缓慢的SQL` | `★★★★☆` | `性能调优` |
| 🔗 **连接日志** | `记录连接建立和断开` | `★★★☆☆` | `连接问题排查` |

### 1.2 日志系统架构图


```
ProxySQL日志系统架构：

应用程序                      ProxySQL                      MySQL后端
    |                           |                              |
    |--SQL查询---------------->  |                              |
    |                           |--记录查询日志                  |
    |                           |--检查慢查询阈值                |
    |                           |--转发查询------------------> |
    |                           |                              |
    |                           |<-返回结果-------------------- |
    |                           |--记录响应时间                  |
    |<-返回结果------------------|--记录连接状态                  |
    |                           |                              |
                                |
                            日志文件系统
                                |
                ┌--------------┼--------------┐
                |              |              |
         错误日志文件      查询日志文件     审计日志文件
         proxysql.log    queries.log    audit.log
```

### 1.3 日志存储位置


**📁 默认日志目录结构**
```bash
/var/lib/proxysql/
├── proxysql.log          # 主要错误日志
├── proxysql_queries.log  # 查询日志
├── proxysql_audit.log    # 审计日志
└── stats/
    ├── connection.log    # 连接统计
    └── performance.log   # 性能统计
```

---

## 2. 🚨 错误日志分析


### 2.1 错误日志的重要性


**💡 为什么错误日志如此重要？**
```
错误日志就像汽车的故障指示灯：
✅ 及时发现问题：系统异常第一时间记录
✅ 定位故障根源：详细的错误信息和堆栈
✅ 监控系统健康：通过日志了解系统状态
✅ 预防重大故障：小问题及时处理避免扩大
```

### 2.2 错误日志配置


**🔧 基础配置方法**
```sql
-- 启用错误日志
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-log_error';

-- 设置日志文件路径
UPDATE global_variables SET variable_value='/var/log/proxysql/error.log' 
WHERE variable_name='mysql-log_error_file';

-- 应用配置
LOAD MYSQL VARIABLES TO RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
```

### 2.3 常见错误类型分析


**⚠️ 连接相关错误**
```bash
# 示例错误日志内容
2025-09-11 16:30:45 [ERROR] MySQL_Connection.cpp:2156:connect_socket(): 
  [conn=12345] Failed to connect to 192.168.1.100:3306. Error: "Connection refused"

解读说明：
• 时间戳：2025-09-11 16:30:45
• 级别：ERROR(错误级别)
• 位置：MySQL_Connection.cpp代码文件
• 连接ID：conn=12345
• 问题：连接192.168.1.100:3306被拒绝
```

**🔍 错误日志解读技巧**
```
错误日志的5W分析法：
• What(什么错误)：Connection refused
• When(什么时候)：2025-09-11 16:30:45
• Where(在哪里)：192.168.1.100:3306
• Who(哪个连接)：conn=12345
• Why(为什么)：需要进一步分析网络、防火墙等
```

### 2.4 错误级别说明


| 级别 | **含义** | **紧急程度** | **处理建议** |
|------|----------|-------------|-------------|
| `FATAL` | `致命错误，系统无法继续运行` | `🔴 立即处理` | `重启服务，检查配置` |
| `ERROR` | `严重错误，功能受影响` | `🟠 尽快处理` | `检查日志，修复问题` |
| `WARN` | `警告信息，可能影响性能` | `🟡 关注监控` | `分析原因，优化配置` |
| `INFO` | `一般信息，正常运行状态` | `🟢 定期检查` | `了解系统状态` |

---

## 3. 📝 查询日志记录


### 3.1 查询日志的价值


**🎯 查询日志能告诉我们什么？**
```
查询日志就像餐厅的点菜记录：
📊 客户偏好：哪些SQL被频繁执行
⏱️ 服务效率：每个查询花费多长时间
🍽️ 菜品质量：哪些查询执行有问题
📈 业务趋势：访问模式的变化规律
```

### 3.2 查询日志配置


**🔧 启用查询日志**
```sql
-- 启用查询日志记录
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-log_query';

-- 设置查询日志文件
UPDATE global_variables SET variable_value='/var/log/proxysql/queries.log' 
WHERE variable_name='mysql-log_query_file';

-- 设置记录阈值(毫秒)
UPDATE global_variables SET variable_value='100' 
WHERE variable_name='mysql-log_query_time_threshold';

-- 应用配置
LOAD MYSQL VARIABLES TO RUNTIME;
```

### 3.3 查询日志格式解析


**📋 日志条目示例**
```
2025-09-11 16:45:23.456 [INFO] Thread-12: Query: "SELECT * FROM users WHERE id=1001" 
  Duration: 89ms, Backend: mysql-server1:3306, User: app_user
```

**🔍 字段含义说明**
```
日志字段解析：
• 时间戳：2025-09-11 16:45:23.456 (精确到毫秒)
• 线程ID：Thread-12 (处理查询的线程)
• SQL语句：SELECT * FROM users WHERE id=1001
• 执行时间：89ms (查询总耗时)
• 后端服务器：mysql-server1:3306 (实际执行的MySQL)
• 用户信息：app_user (发起查询的用户)
```

### 3.4 查询日志分析方法


**📊 日志分析实用技巧**
```bash
# 1. 统计最频繁的查询类型
grep -o "Query: \"[^\"]*" /var/log/proxysql/queries.log | \
  cut -d'"' -f2 | cut -d' ' -f1 | sort | uniq -c | sort -nr

# 2. 查找慢查询(>1秒)
grep "Duration: [1-9][0-9][0-9][0-9]ms" /var/log/proxysql/queries.log

# 3. 按用户统计查询量
grep "User:" /var/log/proxysql/queries.log | \
  cut -d',' -f3 | sort | uniq -c | sort -nr
```

---

## 4. 🔒 审计日志配置


### 4.1 审计日志的必要性


**🛡️ 为什么需要审计日志？**
```
审计日志就像银行的交易记录：
🔐 安全合规：满足数据安全法规要求
👤 用户追踪：记录谁在什么时候做了什么
🚨 异常检测：发现可疑的数据库操作
📋 责任追溯：出现问题时能够追查责任
```

### 4.2 审计日志配置方法


**🔧 启用审计功能**
```sql
-- 启用审计日志
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-log_audit';

-- 设置审计日志文件
UPDATE global_variables SET variable_value='/var/log/proxysql/audit.log' 
WHERE variable_name='mysql-log_audit_file';

-- 配置审计规则(记录所有DDL和DML操作)
UPDATE global_variables SET variable_value='DDL,DML,DCL' 
WHERE variable_name='mysql-log_audit_filter';

LOAD MYSQL VARIABLES TO RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
```

### 4.3 审计日志内容


**📋 审计记录示例**
```json
{
  "timestamp": "2025-09-11T16:50:15.789Z",
  "user": "admin_user",
  "client_ip": "192.168.1.50",
  "database": "production_db",
  "operation": "DROP TABLE",
  "query": "DROP TABLE temp_backup",
  "status": "SUCCESS",
  "duration_ms": 245
}
```

**🔍 关键审计事件**
```
高风险操作审计：
🔴 数据删除：DELETE, DROP, TRUNCATE
🟠 结构修改：ALTER TABLE, CREATE INDEX
🟡 权限变更：GRANT, REVOKE, CREATE USER
🔵 数据导出：SELECT ... INTO OUTFILE
🟢 登录事件：连接建立和断开
```

---

## 5. ⚙️ 日志级别与轮转


### 5.1 日志级别设置


**📊 日志级别配置原则**
```
日志级别选择策略：
🔴 生产环境：ERROR级别 (减少IO，关注严重问题)
🟡 测试环境：WARN级别 (发现潜在问题)
🟢 开发环境：INFO级别 (详细调试信息)
🔵 调试模式：DEBUG级别 (所有细节)
```

**🔧 日志级别配置**
```sql
-- 设置日志级别为ERROR
UPDATE global_variables SET variable_value='ERROR' 
WHERE variable_name='mysql-log_level';

-- 只记录错误和致命错误
UPDATE global_variables SET variable_value='ERROR,FATAL' 
WHERE variable_name='mysql-log_level';

LOAD MYSQL VARIABLES TO RUNTIME;
```

### 5.2 日志轮转配置


**🔄 为什么需要日志轮转？**
```
日志轮转就像清理垃圾桶：
💾 节省磁盘空间：防止日志文件无限增长
⚡ 提高性能：小文件读写更高效
🔍 便于查找：按时间分割便于定位问题
📦 便于备份：小文件更容易备份和传输
```

**🔧 logrotate配置示例**
```bash
# /etc/logrotate.d/proxysql
/var/log/proxysql/*.log {
    daily                    # 每天轮转
    rotate 30               # 保留30个文件
    compress               # 压缩旧文件
    delaycompress          # 延迟一天压缩
    missingok              # 文件不存在不报错
    notifempty             # 空文件不轮转
    postrotate             # 轮转后执行
        systemctl reload proxysql
    endscript
}
```

### 5.3 日志大小管理


**📏 日志文件大小控制**
```sql
-- 设置单个日志文件最大大小(MB)
UPDATE global_variables SET variable_value='100' 
WHERE variable_name='mysql-log_max_file_size';

-- 设置日志保留天数
UPDATE global_variables SET variable_value='7' 
WHERE variable_name='mysql-log_retention_days';

LOAD MYSQL VARIABLES TO RUNTIME;
```

---

## 6. 🐌 慢查询日志监控


### 6.1 慢查询的危害


**⚠️ 慢查询的影响**
```
慢查询就像交通堵塞：
🚗 阻塞其他查询：占用连接池资源
⏰ 延长响应时间：用户体验下降
💰 增加成本：CPU和内存消耗增加
🔥 可能雪崩：一个慢查询引发连锁反应
```

### 6.2 慢查询阈值配置


**🎯 合理设置慢查询阈值**
```sql
-- 设置慢查询阈值为500毫秒
UPDATE global_variables SET variable_value='500' 
WHERE variable_name='mysql-slow_query_log_time_threshold';

-- 启用慢查询日志
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-slow_query_log';

-- 设置慢查询日志文件
UPDATE global_variables SET variable_value='/var/log/proxysql/slow.log' 
WHERE variable_name='mysql-slow_query_log_file';

LOAD MYSQL VARIABLES TO RUNTIME;
```

**📊 阈值设置参考**
```
慢查询阈值建议：
🔴 在线业务：100-200毫秒
🟡 报表查询：1-2秒
🟢 批处理：5-10秒
🔵 数据分析：30秒以上
```

### 6.3 慢查询日志分析


**📋 慢查询日志格式**
```
# Time: 2025-09-11T16:55:30.123456Z
# User@Host: app_user[app_user] @  [192.168.1.20]  Id: 12345
# Query_time: 2.543210  Lock_time: 0.000123  Rows_sent: 15  Rows_examined: 50000
# Timestamp: 1694450130
SELECT u.*, p.profile_data 
FROM users u 
LEFT JOIN profiles p ON u.id = p.user_id 
WHERE u.created_at > '2025-01-01' 
ORDER BY u.created_at DESC;
```

**🔍 慢查询分析指标**
```
关键指标解读：
⏱️ Query_time: 2.543210    # 总执行时间
🔒 Lock_time: 0.000123     # 等待锁的时间
📤 Rows_sent: 15           # 返回的行数
👀 Rows_examined: 50000    # 扫描的行数

性能问题判断：
• Rows_examined/Rows_sent 比值过大 → 需要优化索引
• Lock_time 占比过高 → 锁竞争严重
• Query_time 超过阈值 → 需要SQL优化
```

### 6.4 慢查询优化建议


**💡 常见优化策略**
```
慢查询优化技巧：
🎯 添加合适索引：WHERE和ORDER BY字段
📊 优化查询逻辑：避免全表扫描
🔍 使用覆盖索引：减少回表查询
🗂️ 分页查询：LIMIT分批处理大数据集
⚡ 查询缓存：缓存频繁查询结果
```

---

## 7. 🔗 连接日志分析


### 7.1 连接日志的作用


**🌐 连接日志监控价值**
```
连接日志就像门卫记录：
👥 统计访客数量：了解系统负载
⏰ 记录访问时间：分析访问模式
🚪 追踪进出记录：监控连接状态
🚨 发现异常行为：识别可疑连接
```

### 7.2 连接日志配置


**🔧 启用连接日志**
```sql
-- 启用连接日志
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-log_connections';

-- 记录连接详细信息
UPDATE global_variables SET variable_value='detailed' 
WHERE variable_name='mysql-log_connections_level';

LOAD MYSQL VARIABLES TO RUNTIME;
```

### 7.3 连接日志分析


**📊 连接状态监控**
```sql
-- 查看当前连接统计
SELECT 
    hostgroup_id,
    srv_host,
    srv_port,
    status,
    ConnUsed,
    ConnFree,
    ConnOK,
    ConnERR
FROM stats_mysql_connection_pool
ORDER BY hostgroup_id, srv_host;
```

**🔍 连接问题诊断**
```bash
# 分析连接日志中的常见问题

# 1. 连接失败统计
grep "Connection failed" /var/log/proxysql/connections.log | \
  wc -l

# 2. 超时连接统计  
grep "Connection timeout" /var/log/proxysql/connections.log | \
  cut -d' ' -f1-2 | sort | uniq -c

# 3. 按客户端IP统计连接数
grep "New connection" /var/log/proxysql/connections.log | \
  grep -o "from [0-9.]*" | sort | uniq -c | sort -nr
```

### 7.4 连接池监控指标


**📈 关键监控指标**
```
连接池健康指标：
✅ 连接使用率：ConnUsed/(ConnUsed+ConnFree) < 80%
✅ 连接成功率：ConnOK/(ConnOK+ConnERR) > 99%
✅ 平均连接时间：< 100ms
✅ 连接队列长度：< 10

异常情况告警：
🚨 连接池耗尽：ConnFree = 0
🚨 连接失败率高：ConnERR/ConnOK > 1%
🚨 连接超时频繁：timeout事件 > 10/分钟
```

---

## 8. 🔧 故障诊断方法


### 8.1 故障诊断流程


**🔍 系统化诊断步骤**
```
故障诊断的6步法：

1️⃣ 现象确认
   └── 收集故障现象和用户反馈
   
2️⃣ 日志分析
   └── 检查错误日志、慢查询日志
   
3️⃣ 状态检查
   └── 查看连接池、后端服务器状态
   
4️⃣ 性能分析
   └── 分析查询性能、资源使用情况
   
5️⃣ 根因定位
   └── 根据日志和状态确定根本原因
   
6️⃣ 解决验证
   └── 实施解决方案并验证效果
```

### 8.2 常用诊断命令


**🛠️ ProxySQL诊断工具箱**
```sql
-- 1. 检查ProxySQL运行状态
SELECT * FROM stats_mysql_global;

-- 2. 查看后端服务器状态
SELECT hostgroup_id, hostname, port, status, weight 
FROM mysql_servers;

-- 3. 检查连接池状态
SELECT * FROM stats_mysql_connection_pool 
ORDER BY hostgroup_id;

-- 4. 查看慢查询统计
SELECT * FROM stats_mysql_query_digest 
WHERE exec_time_ms > 1000 
ORDER BY exec_time_ms DESC LIMIT 10;

-- 5. 检查路由规则
SELECT rule_id, match_pattern, destination_hostgroup, apply 
FROM mysql_query_rules 
WHERE active=1;
```

### 8.3 日志分析技巧


**📋 高效日志分析方法**
```bash
# 1. 快速定位错误时间点
grep -n "ERROR\|FATAL" /var/log/proxysql/proxysql.log | tail -20

# 2. 分析特定时间段的日志
sed -n '/2025-09-11 16:00:00/,/2025-09-11 17:00:00/p' \
  /var/log/proxysql/proxysql.log

# 3. 统计错误类型分布
grep "ERROR" /var/log/proxysql/proxysql.log | \
  grep -o "Error: [^\"]*" | sort | uniq -c | sort -nr

# 4. 实时监控日志
tail -f /var/log/proxysql/proxysql.log | \
  grep --color=always "ERROR\|WARN"
```

### 8.4 性能问题排查


**⚡ 性能问题诊断清单**
```
性能问题排查步骤：

📊 1. 基础指标检查
   • CPU使用率：< 80%
   • 内存使用率：< 90%  
   • 磁盘IO：< 80%
   • 网络延迟：< 10ms

🔍 2. ProxySQL指标
   • 查询响应时间：< 100ms
   • 连接池使用率：< 80%
   • 路由规则命中率：> 95%
   • 后端服务器健康度：100%

🐌 3. 慢查询分析
   • 识别TOP 10慢查询
   • 分析执行计划
   • 检查索引使用情况
   • 优化SQL语句

🔗 4. 连接问题
   • 连接超时设置
   • 最大连接数配置
   • 连接池大小调优
```

---

## 9. ❗ 常见问题处理


### 9.1 连接问题处理


**🔗 连接失败常见原因**

**问题1：连接被拒绝**
```bash
# 错误信息
ERROR: Connection refused to backend mysql-server1:3306

# 诊断步骤
1. 检查后端MySQL服务状态
   systemctl status mysql
   
2. 验证网络连通性
   telnet mysql-server1 3306
   
3. 检查防火墙规则
   iptables -L | grep 3306
   
4. 验证MySQL用户权限
   SHOW GRANTS FOR 'proxy_user'@'proxysql_host';
```

**问题2：连接池耗尽**
```sql
# 错误现象：客户端连接超时
# 解决方案：
-- 增加连接池大小
UPDATE mysql_servers SET max_connections=200 
WHERE hostname='mysql-server1';

-- 减少连接超时时间
UPDATE global_variables SET variable_value='10' 
WHERE variable_name='mysql-connect_timeout_server';

LOAD MYSQL SERVERS TO RUNTIME;
```

### 9.2 性能问题处理


**⚡ 查询慢问题解决**

**问题：查询响应时间过长**
```sql
-- 1. 识别慢查询
SELECT digest_text, exec_time_ms, count_star 
FROM stats_mysql_query_digest 
WHERE exec_time_ms > 1000 
ORDER BY exec_time_ms DESC;

-- 2. 分析查询路由
SELECT rule_id, match_pattern, destination_hostgroup 
FROM mysql_query_rules 
WHERE active=1;

-- 3. 检查后端负载
SELECT hostgroup_id, hostname, Queries, Bytes_sent 
FROM stats_mysql_connection_pool;
```

**🔧 优化方案**
```sql
-- 方案1：添加查询路由规则
INSERT INTO mysql_query_rules 
(rule_id, match_pattern, destination_hostgroup, apply) 
VALUES 
(10, '^SELECT.*FROM reports.*', 2, 1);

-- 方案2：启用查询缓存
UPDATE global_variables SET variable_value='ON' 
WHERE variable_name='mysql-query_cache_size_MB';

LOAD MYSQL QUERY RULES TO RUNTIME;
```

### 9.3 故障恢复流程


**🚨 紧急故障处理步骤**
```
故障应急响应流程：

⏰ 5分钟内 - 快速响应
1. 确认故障范围和影响
2. 检查ProxySQL和MySQL服务状态  
3. 启动备用方案(如切换到备库)

⏰ 15分钟内 - 临时恢复
1. 分析错误日志找到直接原因
2. 实施临时修复措施
3. 恢复基本服务功能

⏰ 30分钟内 - 稳定恢复
1. 根因分析和彻底修复
2. 验证系统完全恢复正常
3. 更新监控和告警规则

⏰ 故障后 - 总结改进
1. 编写故障报告
2. 优化预防措施
3. 完善应急预案
```

### 9.4 预防措施建议


**🛡️ 故障预防最佳实践**
```
预防故障的黄金法则：

🔍 监控告警
• 设置关键指标告警阈值
• 定期检查日志异常模式
• 建立7x24小时监控体系

📊 定期巡检
• 每日检查系统状态报告
• 每周分析性能趋势
• 每月评估容量规划

🎯 自动化运维
• 自动化日志轮转和清理
• 自动化备份和恢复测试
• 自动化健康检查脚本

📚 知识管理
• 建立故障处理知识库
• 定期更新操作手册
• 组织故障演练培训
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 日志系统价值：ProxySQL的"黑匣子"，记录所有重要事件
🔸 日志类型分工：错误日志查故障，查询日志看性能，审计日志保安全
🔸 配置管理原则：生产环境重点关注ERROR级别，开发测试可以更详细
🔸 分析方法技巧：结合多种日志交叉分析，快速定位问题根源
🔸 故障处理流程：现象确认→日志分析→状态检查→根因定位→解决验证
```

### 10.2 关键配置参数


**🎯 重要参数速查表**

| 参数名称 | **推荐值** | **作用说明** |
|---------|-----------|-------------|
| `mysql-log_error` | `ON` | `启用错误日志记录` |
| `mysql-log_query` | `ON` | `启用查询日志记录` |
| `mysql-log_query_time_threshold` | `100` | `查询记录阈值(毫秒)` |
| `mysql-slow_query_log_time_threshold` | `500` | `慢查询阈值(毫秒)` |
| `mysql-log_level` | `ERROR` | `生产环境日志级别` |
| `mysql-log_max_file_size` | `100` | `单文件最大大小(MB)` |

### 10.3 故障诊断技能清单


**📝 必备诊断技能**
- [ ] 能够快速定位错误日志中的关键信息
- [ ] 会分析慢查询日志找出性能瓶颈
- [ ] 掌握连接池状态检查方法
- [ ] 熟悉常见故障的处理流程
- [ ] 能够配置合适的日志级别和轮转策略

### 10.4 最佳实践建议


**🏆 日志管理黄金法则**
```
日志管理三要素：
1️⃣ 记录要全面：重要事件不遗漏
2️⃣ 分析要及时：问题发现要迅速  
3️⃣ 处理要彻底：根本原因要解决

运维管理三原则：
🔍 预防为主：通过监控提前发现问题
⚡ 快速响应：故障发生时迅速处理
📚 持续改进：总结经验完善流程
```

### 10.5 进阶学习方向


**🚀 深入学习建议**
- **日志分析工具**：学习ELK Stack进行大规模日志分析
- **监控系统**：掌握Prometheus+Grafana监控体系
- **自动化运维**：使用Ansible等工具自动化日志管理
- **性能调优**：深入学习MySQL和ProxySQL性能优化
- **高可用架构**：了解故障转移和灾难恢复机制

**💡 核心记忆口诀**：
- 日志管理三步走：配置记录，及时分析，快速处理
- 故障诊断五要素：现象、日志、状态、性能、根因
- 预防措施要到位：监控、巡检、自动化、知识库