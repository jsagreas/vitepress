---
title: 2、ProxySQL安装部署实战
---
## 📚 目录

1. [ProxySQL中间件概述](#1-ProxySQL中间件概述)
2. [安装方式选择与规划](#2-安装方式选择与规划)
3. [二进制包安装实战](#3-二进制包安装实战)
4. [源码编译安装](#4-源码编译安装)
5. [Docker容器部署](#5-Docker容器部署)
6. [配置初始化与启动](#6-配置初始化与启动)
7. [安装验证与故障排查](#7-安装验证与故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 ProxySQL中间件概述


### 1.1 什么是ProxySQL


**💡 通俗理解**
ProxySQL就像是MySQL数据库前面的一个"智能代理"，想象一下：
- 你要去银行办事，但银行有很多个窗口
- ProxySQL就像大厅里的叫号机和引导员
- 它会根据你的业务类型，把你分配到最合适的窗口
- 还能处理排队、负载均衡等问题

```
传统直连模式：
应用 ──直接连接──→ MySQL数据库

ProxySQL代理模式：
应用 ──→ ProxySQL ──智能分发──→ MySQL集群
              ↓
          读写分离、负载均衡、连接池等
```

### 1.2 ProxySQL核心作用


**🔸 主要功能**
```
连接池管理：
• 复用数据库连接，减少连接开销
• 控制最大连接数，保护数据库

读写分离：
• 自动识别SQL类型
• 读操作分发到从库，写操作发到主库

负载均衡：
• 多个数据库节点间分散压力
• 支持多种负载均衡算法

SQL路由：
• 根据规则将SQL发送到指定数据库
• 支持按库、表、用户等维度路由

查询缓存：
• 缓存频繁查询的结果
• 提升查询响应速度
```

### 1.3 为什么选择ProxySQL


**🎯 核心优势**
```
性能优异：
• C++编写，性能接近原生MySQL
• 支持数十万QPS的高并发

功能丰富：
• 内置读写分离、负载均衡
• 支持SQL重写、查询缓存
• 提供详细的监控统计

易于管理：
• 配置动态生效，无需重启
• 提供管理界面和SQL接口
• 支持配置热更新

高可用性：
• 自动故障切换
• 健康检查机制
• 集群部署支持
```

---

## 2. ⚖️ 安装方式选择与规划


### 2.1 安装方式对比


| 安装方式 | **适用场景** | **优势** | **劣势** | **难度** |
|---------|------------|---------|---------|---------|
| 🔧 **二进制包** | `生产环境` | `安装快速，稳定可靠` | `版本选择有限` | `⭐⭐` |
| 📦 **源码编译** | `定制需求` | `版本最新，可定制` | `编译耗时，依赖复杂` | `⭐⭐⭐⭐` |
| 🐳 **Docker容器** | `开发测试` | `环境隔离，部署简单` | `性能有损耗` | `⭐⭐⭐` |
| 📋 **包管理器** | `快速部署` | `依赖自动处理` | `版本可能较旧` | `⭐` |

### 2.2 环境需求规划


**📊 系统要求**
```
操作系统支持：
• CentOS/RHEL 7.x, 8.x
• Ubuntu 18.04, 20.04
• Debian 9, 10
• SUSE Linux Enterprise

硬件配置建议：
测试环境：
- CPU：2核心
- 内存：4GB
- 硬盘：20GB

生产环境：
- CPU：4核心以上
- 内存：8GB以上
- 硬盘：50GB以上（用于日志和缓存）
```

**🔧 依赖组件**
```
系统依赖：
• glibc 2.17+
• libstdc++ 6.0+
• openssl 1.0+

开发工具（源码编译需要）：
• gcc/g++ 5.0+
• cmake 3.0+
• make
• git
```

### 2.3 部署架构规划


**🏗️ 单机部署架构**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   应用服务   │───▶│  ProxySQL   │───▶│  MySQL主库  │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  MySQL从库  │
                   └─────────────┘
```

**🔄 高可用部署架构**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   应用服务   │───▶│ ProxySQL-1  │───▶│  MySQL主库  │
│             │    │             │    │             │
│             │    └─────────────┘    └─────────────┘
│             │           │                   │
│             │    ┌─────────────┐           │
│             │───▶│ ProxySQL-2  │───────────┘
└─────────────┘    │             │
                   └─────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │  MySQL从库  │
                   └─────────────┘
```

---

## 3. 🔧 二进制包安装实战


### 3.1 下载ProxySQL安装包


**💡 理解要点**
二进制包安装是最常用的方式，就像安装其他软件一样，下载→安装→配置→启动。

**📥 下载步骤**
```bash
# 1. 创建安装目录
mkdir -p /opt/proxysql
cd /opt/proxysql

# 2. 下载最新版本（以2.4.4为例）
wget https://github.com/sysown/proxysql/releases/download/v2.4.4/proxysql-2.4.4-1-centos7.x86_64.rpm

# 3. 验证下载文件
ls -la proxysql-2.4.4-1-centos7.x86_64.rpm
```

> **📌 重要提醒**：选择与你的操作系统匹配的版本，CentOS用rpm包，Ubuntu用deb包

### 3.2 安装ProxySQL


**CentOS/RHEL系统安装：**
```bash
# 1. 安装rpm包
sudo yum install -y proxysql-2.4.4-1-centos7.x86_64.rpm

# 或者使用rpm命令
sudo rpm -ivh proxysql-2.4.4-1-centos7.x86_64.rpm
```

**Ubuntu/Debian系统安装：**
```bash
# 1. 下载deb包
wget https://github.com/sysown/proxysql/releases/download/v2.4.4/proxysql_2.4.4-ubuntu20_amd64.deb

# 2. 安装deb包
sudo dpkg -i proxysql_2.4.4-ubuntu20_amd64.deb

# 3. 修复可能的依赖问题
sudo apt-get install -f
```

### 3.3 安装后文件布局


**📂 安装目录结构**
```
ProxySQL安装后的文件分布：

/usr/bin/proxysql           # 主程序文件
/etc/proxysql.cnf          # 主配置文件
/var/lib/proxysql/         # 数据目录
├── proxysql.db           # SQLite数据库文件
└── proxysql_stats.db     # 统计信息数据库

/var/log/proxysql.log      # 日志文件
/etc/systemd/system/proxysql.service  # 系统服务文件
```

### 3.4 创建ProxySQL用户


```bash
# 1. 创建专用用户（如果不存在）
sudo useradd -r -s /bin/false proxysql

# 2. 设置目录权限
sudo chown -R proxysql:proxysql /var/lib/proxysql
sudo chown -R proxysql:proxysql /var/log/proxysql.log
```

---

## 4. 📦 源码编译安装


### 4.1 什么时候需要源码编译


**🤔 使用场景**
```
定制化需求：
• 需要特定版本功能
• 要修改默认配置
• 集成自定义模块

系统兼容性：
• 没有预编译包的系统
• 特殊的系统环境
• 需要特定编译选项
```

### 4.2 安装编译依赖


```bash
# CentOS/RHEL系统
sudo yum groupinstall -y "Development Tools"
sudo yum install -y cmake3 openssl-devel

# Ubuntu/Debian系统  
sudo apt-get update
sudo apt-get install -y build-essential cmake libssl-dev libmysqlclient-dev
```

### 4.3 源码编译步骤


```bash
# 1. 克隆源码
git clone https://github.com/sysown/proxysql.git
cd proxysql

# 2. 切换到稳定版本
git checkout v2.4.4

# 3. 编译（这一步比较耗时，可能需要10-30分钟）
make

# 4. 安装
sudo make install
```

> **⏰ 时间提醒**：编译过程比较耗时，可以去泡杯茶等待

### 4.4 编译后配置


```bash
# 1. 创建配置目录
sudo mkdir -p /etc/proxysql

# 2. 复制配置文件模板
sudo cp /usr/local/etc/proxysql.cnf /etc/proxysql/

# 3. 创建数据目录
sudo mkdir -p /var/lib/proxysql
sudo chown proxysql:proxysql /var/lib/proxysql
```

---

## 5. 🐳 Docker容器部署


### 5.1 Docker部署的优势


**💡 容器化的好处**
```
环境隔离：
• 不污染宿主机环境
• 避免依赖冲突

快速部署：
• 一条命令启动
• 配置标准化

易于管理：
• 版本控制简单
• 扩容缩容方便
```

### 5.2 Docker快速部署


**🚀 一键启动**
```bash
# 1. 拉取官方镜像
docker pull proxysql/proxysql:2.4.4

# 2. 创建配置目录
mkdir -p /opt/proxysql/conf
mkdir -p /opt/proxysql/data

# 3. 启动容器
docker run -d \
  --name proxysql \
  -p 6032:6032 \
  -p 6033:6033 \
  -v /opt/proxysql/conf:/etc/proxysql \
  -v /opt/proxysql/data:/var/lib/proxysql \
  proxysql/proxysql:2.4.4
```

### 5.3 Docker Compose部署


**📋 compose配置文件**
```yaml
# docker-compose.yml
version: '3.8'

services:
  proxysql:
    image: proxysql/proxysql:2.4.4
    container_name: proxysql
    restart: unless-stopped
    ports:
      - "6032:6032"  # 管理端口
      - "6033:6033"  # MySQL端口
    volumes:
      - ./conf:/etc/proxysql
      - ./data:/var/lib/proxysql
      - ./logs:/var/log
    environment:
      - MYSQL_ROOT_PASSWORD=your_password
```

**启动命令：**
```bash
# 1. 创建compose文件后启动
docker-compose up -d

# 2. 查看状态
docker-compose ps

# 3. 查看日志
docker-compose logs -f proxysql
```

---

## 6. ⚙️ 配置初始化与启动


### 6.1 配置文件详解


**📝 主配置文件位置**
```
默认配置文件路径：
• /etc/proxysql.cnf        # 主配置文件
• /var/lib/proxysql/       # 数据文件目录
```

### 6.2 核心配置参数


**🔧 基础配置示例**
```ini
# /etc/proxysql.cnf

# 数据文件路径
datadir="/var/lib/proxysql"

# 管理员配置
admin_variables=
{
    admin_credentials="admin:admin;radmin:radmin"
    mysql_ifaces="0.0.0.0:6032"
    refresh_interval=2000
}

# MySQL配置
mysql_variables=
{
    threads=4
    max_connections=2048
    default_query_delay=0
    default_query_timeout=36000000
    interfaces="0.0.0.0:6033"
    server_version="8.0.25"
}
```

> **💡 配置解释**：
> - `6032端口`：管理端口，用于配置ProxySQL
> - `6033端口`：MySQL端口，应用连接这个端口
> - `threads`：工作线程数，通常设置为CPU核心数
> - `max_connections`：最大连接数

### 6.3 启动ProxySQL服务


**🚀 启动方式选择**

**方式1：systemd服务启动（推荐）**
```bash
# 1. 启动服务
sudo systemctl start proxysql

# 2. 设置开机自启
sudo systemctl enable proxysql

# 3. 查看服务状态
sudo systemctl status proxysql
```

**方式2：直接启动**
```bash
# 1. 前台启动（用于调试）
sudo proxysql -f

# 2. 后台启动
sudo proxysql -D /var/lib/proxysql -c /etc/proxysql.cnf
```

### 6.4 初始管理员设置


**👤 连接管理端口**
```bash
# 1. 连接ProxySQL管理端口
mysql -u admin -padmin -h 127.0.0.1 -P 6032

# 2. 查看当前配置
SELECT * FROM global_variables WHERE variable_name LIKE '%admin%';
```

**🔑 修改管理员密码**
```sql
-- 1. 更新管理员密码
UPDATE global_variables 
SET variable_value='newadmin:newpassword123' 
WHERE variable_name='admin-admin_credentials';

-- 2. 加载配置到运行时
LOAD ADMIN VARIABLES TO RUNTIME;

-- 3. 保存配置到磁盘
SAVE ADMIN VARIABLES TO DISK;
```

---

## 7. ✅ 安装验证与故障排查


### 7.1 端口监听检查


**🔍 验证ProxySQL是否正常启动**
```bash
# 1. 检查端口监听情况
netstat -tlnp | grep proxysql
# 应该看到：
# tcp  0.0.0.0:6032  LISTEN  proxysql
# tcp  0.0.0.0:6033  LISTEN  proxysql

# 2. 检查进程状态
ps aux | grep proxysql

# 3. 查看服务状态
systemctl status proxysql
```

**✅ 正常输出示例**
```
● proxysql.service - High Performance Advanced Proxy for MySQL
   Loaded: loaded (/etc/systemd/system/proxysql.service; enabled)
   Active: active (running) since Wed 2024-01-10 10:30:45 CST; 2min ago
```

### 7.2 连接测试


**🔗 管理端口连接测试**
```bash
# 1. 连接管理端口（6032）
mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt='ProxySQL Admin> '

# 2. 执行测试查询
ProxySQL Admin> SELECT VERSION();
```

**🔗 MySQL端口连接测试**
```bash
# 连接MySQL端口（6033）
# 注意：这时还没有配置后端MySQL，连接会失败，这是正常的
mysql -h 127.0.0.1 -P 6033
```

### 7.3 数据库文件检查


**📂 验证数据文件**
```bash
# 1. 检查数据目录
ls -la /var/lib/proxysql/
# 应该看到：
# proxysql.db        # 主数据库文件
# proxysql_stats.db  # 统计数据库文件

# 2. 检查文件权限
ls -la /var/lib/proxysql/
# 文件属主应该是proxysql用户
```

### 7.4 日志文件分析


**📋 查看日志信息**
```bash
# 1. 查看最新日志
tail -f /var/log/proxysql.log

# 2. 查看启动日志
grep -i "starting\|started" /var/log/proxysql.log

# 3. 查看错误日志
grep -i "error\|failed" /var/log/proxysql.log
```

**✅ 正常日志示例**
```
2024-01-10 10:30:45 [INFO] ProxySQL version 2.4.4-0-g39ad51b
2024-01-10 10:30:45 [INFO] Using config file /etc/proxysql.cnf
2024-01-10 10:30:45 [INFO] Starting ProxySQL
2024-01-10 10:30:45 [INFO] Listening on 0.0.0.0:6032
2024-01-10 10:30:45 [INFO] Listening on 0.0.0.0:6033
```

### 7.5 常见安装问题排查


**🚨 问题1：端口被占用**
```bash
# 检查端口占用
lsof -i :6032
lsof -i :6033

# 解决方案：
# 1. 停止占用端口的进程，或
# 2. 修改ProxySQL配置使用其他端口
```

**🚨 问题2：权限不足**
```bash
# 检查文件权限
ls -la /var/lib/proxysql/
ls -la /etc/proxysql.cnf

# 解决方案：
sudo chown -R proxysql:proxysql /var/lib/proxysql/
sudo chmod 600 /etc/proxysql.cnf
```

**🚨 问题3：依赖库缺失**
```bash
# 检查依赖
ldd /usr/bin/proxysql

# CentOS解决方案：
sudo yum install -y openssl-libs

# Ubuntu解决方案：
sudo apt-get install -y libssl1.1
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的安装概念


```
🔸 ProxySQL本质：MySQL的智能代理中间件，提供连接池、读写分离等功能
🔸 安装方式：二进制包（推荐）、源码编译、Docker容器三种方式
🔸 核心端口：6032管理端口、6033MySQL服务端口
🔸 配置文件：/etc/proxysql.cnf主配置，/var/lib/proxysql/数据目录
🔸 服务管理：使用systemctl管理服务，支持开机自启
```

### 8.2 关键安装步骤


**🔹 安装流程总结**
```
环境准备 → 下载安装包 → 安装ProxySQL → 配置初始化 → 启动服务 → 验证安装
```

**🔹 重要配置项**
```
管理端口：6032（用于配置管理）
服务端口：6033（应用连接端口）  
工作线程：通常设置为CPU核心数
最大连接：根据实际需求设置
管理员账号：默认admin/admin，建议修改
```

### 8.3 生产环境注意事项


**🎯 安全配置**
```
修改默认密码：
• 管理员密码不要使用默认值
• 使用强密码策略

网络安全：
• 管理端口不要对外开放
• 使用防火墙限制访问

文件权限：
• 配置文件权限设置为600
• 数据目录属主设置为proxysql用户
```

**🔧 性能优化**
```
资源配置：
• 根据实际负载调整线程数
• 合理设置连接池大小
• 预留足够的内存空间

监控配置：
• 配置日志轮转
• 开启性能监控
• 设置告警机制
```

### 8.4 故障排查检查清单


```
📋 **安装验证清单**
- [ ] 端口6032和6033正常监听
- [ ] proxysql进程正常运行
- [ ] 可以连接到管理端口
- [ ] 配置文件权限正确
- [ ] 数据文件创建成功
- [ ] 日志文件没有错误信息
- [ ] 系统服务注册成功
```

**核心记忆**：
- ProxySQL是MySQL的智能代理，提供连接池和读写分离
- 二进制包安装最简单，生产环境首选
- 6032管理端口配置，6033服务端口连接
- 安装后必须验证端口监听和服务状态
- 生产环境要修改默认密码和设置权限