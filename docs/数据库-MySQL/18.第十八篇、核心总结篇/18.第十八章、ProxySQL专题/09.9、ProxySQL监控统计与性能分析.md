---
title: 9ã€ProxySQLç›‘æ§ç»Ÿè®¡ä¸æ€§èƒ½åˆ†æ
---
## ğŸ“š ç›®å½•

1. [ProxySQLç›‘æ§ä½“ç³»æ¦‚è¿°](#1-ProxySQLç›‘æ§ä½“ç³»æ¦‚è¿°)
2. [Statsç»Ÿè®¡è¡¨è¯¦è§£](#2-Statsç»Ÿè®¡è¡¨è¯¦è§£)
3. [è¿æ¥ç»Ÿè®¡åˆ†æ](#3-è¿æ¥ç»Ÿè®¡åˆ†æ)
4. [æŸ¥è¯¢ç»Ÿè®¡ç›‘æ§](#4-æŸ¥è¯¢ç»Ÿè®¡ç›‘æ§)
5. [æ€§èƒ½åˆ†æä¸ä¼˜åŒ–](#5-æ€§èƒ½åˆ†æä¸ä¼˜åŒ–)
6. [ç›‘æ§å‘Šè­¦é…ç½®](#6-ç›‘æ§å‘Šè­¦é…ç½®)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ProxySQLç›‘æ§ä½“ç³»æ¦‚è¿°


### 1.1 ç›‘æ§çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ProxySQLï¼Ÿ**
```
å°±åƒåŒ»ç”Ÿç»™ç—…äººä½“æ£€ä¸€æ ·ï¼ŒProxySQLç›‘æ§å¸®æˆ‘ä»¬ï¼š
â€¢ åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
â€¢ äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€  
â€¢ ä¼˜åŒ–é…ç½®å‚æ•°
â€¢ é¢„é˜²æ•…éšœå‘ç”Ÿ
```

**ç›‘æ§èƒ½å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆï¼Ÿ**
- **è¿æ¥æƒ…å†µ**ï¼šæœ‰å¤šå°‘å®¢æˆ·ç«¯è¿æ¥ï¼Œè¿æ¥æ˜¯å¦æ­£å¸¸
- **æŸ¥è¯¢æ€§èƒ½**ï¼šå“ªäº›SQLè·‘å¾—æ…¢ï¼Œæ‰§è¡Œäº†å¤šå°‘æ¬¡
- **åç«¯çŠ¶æ€**ï¼šMySQLæœåŠ¡å™¨æ˜¯å¦å¥åº·
- **èµ„æºä½¿ç”¨**ï¼šå†…å­˜ã€CPUä½¿ç”¨æƒ…å†µ

### 1.2 ProxySQLç›‘æ§æ¶æ„


```
ç›‘æ§æ•°æ®æµå‘ï¼š
å®¢æˆ·ç«¯åº”ç”¨ â†’ ProxySQL â†’ MySQLåç«¯
     â†“           â†“         â†“
   è¿æ¥ç»Ÿè®¡    æŸ¥è¯¢ç»Ÿè®¡   æœåŠ¡å™¨ç»Ÿè®¡
     â†“           â†“         â†“
        Statsç»Ÿè®¡è¡¨æ”¶é›†
             â†“
     ç›‘æ§å·¥å…·è¯»å–åˆ†æ
             â†“
       å‘Šè­¦å’Œå¯è§†åŒ–
```

### 1.3 ç›‘æ§æ•°æ®çš„è·å–æ–¹å¼


**ğŸ”¸ ç®¡ç†æ¥å£æŸ¥è¯¢**
```sql
-- è¿æ¥åˆ°ProxySQLç®¡ç†ç«¯å£
mysql -h127.0.0.1 -P6032 -uadmin -padmin

-- æŸ¥çœ‹æ‰€æœ‰ç»Ÿè®¡è¡¨
SHOW TABLES FROM stats;
```

**ğŸ”¸ å¤–éƒ¨ç›‘æ§å·¥å…·**
- Prometheus + Grafana
- Zabbix
- Nagios
- è‡ªå®šä¹‰è„šæœ¬

---

## 2. ğŸ“Š Statsç»Ÿè®¡è¡¨è¯¦è§£


### 2.1 ç»Ÿè®¡è¡¨æ¦‚è§ˆ


**ProxySQLæä¾›çš„ä¸»è¦ç»Ÿè®¡è¡¨ï¼š**
```sql
+--------------------------------+
| stats.stats_mysql_connection_pool  -- è¿æ¥æ± ç»Ÿè®¡
| stats.stats_mysql_commands_counters -- å‘½ä»¤è®¡æ•°å™¨  
| stats.stats_mysql_query_digest     -- æŸ¥è¯¢æ‘˜è¦ç»Ÿè®¡
| stats.stats_mysql_query_rules      -- æŸ¥è¯¢è§„åˆ™ç»Ÿè®¡
| stats.stats_mysql_users            -- ç”¨æˆ·ç»Ÿè®¡
| stats.stats_mysql_global           -- å…¨å±€ç»Ÿè®¡
| stats.stats_memory                 -- å†…å­˜ä½¿ç”¨ç»Ÿè®¡
+--------------------------------+
```

### 2.2 è¿æ¥æ± ç»Ÿè®¡è¡¨


**ğŸ” æŸ¥çœ‹è¿æ¥æ± çŠ¶æ€**
```sql
SELECT 
    hostgroup,     -- ä¸»æœºç»„ID
    srv_host,      -- æœåŠ¡å™¨åœ°å€
    srv_port,      -- æœåŠ¡å™¨ç«¯å£
    status,        -- æœåŠ¡å™¨çŠ¶æ€
    ConnUsed,      -- æ­£åœ¨ä½¿ç”¨çš„è¿æ¥æ•°
    ConnFree,      -- ç©ºé—²è¿æ¥æ•°
    ConnOK,        -- æ­£å¸¸è¿æ¥æ•°
    ConnERR,       -- é”™è¯¯è¿æ¥æ•°
    MaxConnUsed,   -- æœ€å¤§ä½¿ç”¨è¿æ¥æ•°
    Queries,       -- æŸ¥è¯¢æ€»æ•°
    Bytes_data_sent,   -- å‘é€å­—èŠ‚æ•°
    Bytes_data_recv    -- æ¥æ”¶å­—èŠ‚æ•°
FROM stats.stats_mysql_connection_pool;
```

**ğŸ“‹ å…³é”®æŒ‡æ ‡å«ä¹‰ï¼š**
- `ConnUsed`ï¼šå½“å‰æ´»è·ƒè¿æ¥ï¼Œè¿‡é«˜è¯´æ˜è´Ÿè½½å¤§
- `ConnFree`ï¼šç©ºé—²è¿æ¥ï¼Œä¸º0å¯èƒ½éœ€è¦å¢åŠ è¿æ¥æ•°
- `ConnERR`ï¼šé”™è¯¯è¿æ¥ï¼Œé0éœ€è¦æ£€æŸ¥åç«¯çŠ¶æ€
- `MaxConnUsed`ï¼šå†å²æœ€å¤§è¿æ¥æ•°ï¼Œç”¨äºå®¹é‡è§„åˆ’

### 2.3 å‘½ä»¤ç»Ÿè®¡è¡¨


**ğŸ“Š æŸ¥çœ‹SQLå‘½ä»¤æ‰§è¡Œç»Ÿè®¡**
```sql
SELECT 
    Command,           -- SQLå‘½ä»¤ç±»å‹
    Total_Time_us,     -- æ€»æ‰§è¡Œæ—¶é—´(å¾®ç§’)
    Total_cnt,         -- æ€»æ‰§è¡Œæ¬¡æ•°
    cnt_100us,         -- 100å¾®ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_500us,         -- 500å¾®ç§’å†…å®Œæˆçš„æ¬¡æ•°  
    cnt_1ms,           -- 1æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_5ms,           -- 5æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_10ms,          -- 10æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_50ms,          -- 50æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_100ms,         -- 100æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_500ms,         -- 500æ¯«ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_1s,            -- 1ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_5s,            -- 5ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_10s,           -- 10ç§’å†…å®Œæˆçš„æ¬¡æ•°
    cnt_INFs           -- è¶…è¿‡10ç§’çš„æ¬¡æ•°
FROM stats.stats_mysql_commands_counters;
```

**ğŸ’¡ æ€§èƒ½åˆ†ææŠ€å·§ï¼š**
```sql
-- è®¡ç®—å¹³å‡å“åº”æ—¶é—´
SELECT 
    Command,
    Total_cnt,
    ROUND(Total_Time_us/Total_cnt/1000, 2) as avg_time_ms
FROM stats.stats_mysql_commands_counters 
WHERE Total_cnt > 0
ORDER BY avg_time_ms DESC;
```

---

## 3. ğŸ”— è¿æ¥ç»Ÿè®¡åˆ†æ


### 3.1 å®¢æˆ·ç«¯è¿æ¥ç›‘æ§


**æŸ¥çœ‹å½“å‰è¿æ¥æ¦‚å†µï¼š**
```sql
-- æŸ¥çœ‹å…¨å±€è¿æ¥ç»Ÿè®¡
SELECT 
    Variable_name, 
    Variable_value 
FROM stats.stats_mysql_global 
WHERE Variable_name LIKE '%connection%' 
   OR Variable_name LIKE '%client%';
```

**ğŸ” é‡è¦è¿æ¥æŒ‡æ ‡ï¼š**
```
Client_Connections_created      -- åˆ›å»ºçš„å®¢æˆ·ç«¯è¿æ¥æ€»æ•°
Client_Connections_connected    -- å½“å‰å®¢æˆ·ç«¯è¿æ¥æ•°  
Server_Connections_created      -- åˆ›å»ºçš„æœåŠ¡å™¨è¿æ¥æ€»æ•°
Server_Connections_connected    -- å½“å‰æœåŠ¡å™¨è¿æ¥æ•°
```

### 3.2 è¿æ¥å¼‚å¸¸ç›‘æ§


**ğŸ“ˆ è¿æ¥é”™è¯¯ç»Ÿè®¡ï¼š**
```sql
-- æŸ¥çœ‹è¿æ¥ç›¸å…³é”™è¯¯
SELECT 
    Variable_name,
    Variable_value
FROM stats.stats_mysql_global 
WHERE Variable_name LIKE '%error%' 
   OR Variable_name LIKE '%aborted%'
   OR Variable_name LIKE '%timeout%';
```

**âš ï¸ éœ€è¦å…³æ³¨çš„å¼‚å¸¸æŒ‡æ ‡ï¼š**
- `Client_Connections_aborted`ï¼šå®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€
- `Server_Connections_aborted`ï¼šæœåŠ¡å™¨è¿æ¥å¼‚å¸¸
- `ConnPool_get_conn_timeout`ï¼šè¿æ¥æ± è¶…æ—¶

### 3.3 è¿æ¥æ± å¥åº·æ£€æŸ¥


**ğŸ¥ è¿æ¥æ± çŠ¶æ€è¯Šæ–­ï¼š**
```sql
-- æ£€æŸ¥è¿æ¥æ± æ˜¯å¦å¥åº·
SELECT 
    hostgroup,
    srv_host,
    srv_port,
    status,
    CASE 
        WHEN ConnERR > 0 THEN 'âš ï¸ æœ‰é”™è¯¯è¿æ¥'
        WHEN ConnFree = 0 THEN 'âš ï¸ è¿æ¥æ± è€—å°½'  
        WHEN ConnUsed > ConnFree * 3 THEN 'âš ï¸ è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜'
        ELSE 'âœ… çŠ¶æ€æ­£å¸¸'
    END as health_status,
    CONCAT(
        'Used:', ConnUsed, 
        ' Free:', ConnFree, 
        ' Err:', ConnERR
    ) as detail
FROM stats.stats_mysql_connection_pool;
```

---

## 4. ğŸ“ æŸ¥è¯¢ç»Ÿè®¡ç›‘æ§


### 4.1 æŸ¥è¯¢æ‘˜è¦ç»Ÿè®¡


**ğŸ” SQLæ‰§è¡Œç»Ÿè®¡åˆ†æï¼š**
```sql
SELECT 
    hostgroup,         -- ä¸»æœºç»„
    schemaname,        -- æ•°æ®åº“å
    username,          -- ç”¨æˆ·å
    digest,            -- SQLæ‘˜è¦(å»æ‰å…·ä½“å‚æ•°å€¼)
    digest_text,       -- SQLæ–‡æœ¬
    count_star,        -- æ‰§è¡Œæ¬¡æ•°
    first_seen,        -- é¦–æ¬¡æ‰§è¡Œæ—¶é—´
    last_seen,         -- æœ€åæ‰§è¡Œæ—¶é—´
    sum_time,          -- æ€»æ‰§è¡Œæ—¶é—´(å¾®ç§’)
    min_time,          -- æœ€å°æ‰§è¡Œæ—¶é—´
    max_time,          -- æœ€å¤§æ‰§è¡Œæ—¶é—´
    avg_time,          -- å¹³å‡æ‰§è¡Œæ—¶é—´
    rows_affected,     -- å½±å“è¡Œæ•°
    rows_sent          -- è¿”å›è¡Œæ•°
FROM stats.stats_mysql_query_digest 
ORDER BY sum_time DESC 
LIMIT 10;
```

### 4.2 æ…¢æŸ¥è¯¢è¯†åˆ«


**ğŸŒ æ‰¾å‡ºæ‰§è¡Œæœ€æ…¢çš„SQLï¼š**
```sql
-- æŒ‰å¹³å‡æ‰§è¡Œæ—¶é—´æ’åº
SELECT 
    SUBSTRING(digest_text, 1, 50) as sql_preview,
    count_star as exec_count,
    ROUND(avg_time/1000, 2) as avg_time_ms,
    ROUND(max_time/1000, 2) as max_time_ms,
    ROUND(sum_time/1000, 2) as total_time_ms
FROM stats.stats_mysql_query_digest 
WHERE avg_time > 10000  -- å¹³å‡è¶…è¿‡10msçš„æŸ¥è¯¢
ORDER BY avg_time DESC 
LIMIT 10;
```

**ğŸ“Š æ…¢æŸ¥è¯¢åˆ†å¸ƒåˆ†æï¼š**
```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ
SELECT 
    CASE 
        WHEN avg_time < 1000 THEN '< 1ms'
        WHEN avg_time < 10000 THEN '1-10ms'  
        WHEN avg_time < 100000 THEN '10-100ms'
        WHEN avg_time < 1000000 THEN '100ms-1s'
        ELSE '> 1s'
    END as time_range,
    COUNT(*) as query_count,
    SUM(count_star) as total_executions
FROM stats.stats_mysql_query_digest 
GROUP BY 
    CASE 
        WHEN avg_time < 1000 THEN '< 1ms'
        WHEN avg_time < 10000 THEN '1-10ms'  
        WHEN avg_time < 100000 THEN '10-100ms'
        WHEN avg_time < 1000000 THEN '100ms-1s'
        ELSE '> 1s'
    END
ORDER BY 
    CASE 
        WHEN time_range = '< 1ms' THEN 1
        WHEN time_range = '1-10ms' THEN 2
        WHEN time_range = '10-100ms' THEN 3
        WHEN time_range = '100ms-1s' THEN 4
        ELSE 5
    END;
```

### 4.3 æŸ¥è¯¢è§„åˆ™å‘½ä¸­ç»Ÿè®¡


**ğŸ¯ æŸ¥çœ‹è·¯ç”±è§„åˆ™æ•ˆæœï¼š**
```sql
SELECT 
    rule_id,
    hits,              -- å‘½ä¸­æ¬¡æ•°
    match_digest,      -- åŒ¹é…çš„SQLæ‘˜è¦
    match_pattern,     -- åŒ¹é…æ¨¡å¼
    destination_hostgroup  -- è·¯ç”±åˆ°çš„ä¸»æœºç»„
FROM stats.stats_mysql_query_rules 
ORDER BY hits DESC;
```

---

## 5. âš¡ æ€§èƒ½åˆ†æä¸ä¼˜åŒ–


### 5.1 æ€§èƒ½åŸºçº¿å»ºç«‹


**ğŸ“ˆ å»ºç«‹æ€§èƒ½åŸºçº¿çš„æ­¥éª¤ï¼š**

```
ç¬¬ä¸€æ­¥ï¼šæ”¶é›†åŸºç¡€æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­£å¸¸ä¸šåŠ¡æ—¶æ®µçš„å…³é”®æŒ‡æ ‡ï¼š        â”‚
â”‚ â€¢ å¹³å‡å“åº”æ—¶é—´                  â”‚
â”‚ â€¢ QPS (æ¯ç§’æŸ¥è¯¢æ•°)              â”‚
â”‚ â€¢ è¿æ¥æ•°ä½¿ç”¨æƒ…å†µ                â”‚
â”‚ â€¢ é”™è¯¯ç‡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒæ­¥ï¼šå®šæœŸå¯¹æ¯”åˆ†æ
å½“å‰æŒ‡æ ‡ vs åŸºçº¿æŒ‡æ ‡ = æ€§èƒ½å˜åŒ–è¶‹åŠ¿
```

**ğŸ’» åŸºçº¿æ•°æ®æ”¶é›†è„šæœ¬ï¼š**
```sql
-- æ€§èƒ½åŸºçº¿å¿«ç…§
SELECT 
    'QPS' as metric,
    SUM(count_star) as current_value,
    NOW() as snapshot_time
FROM stats.stats_mysql_query_digest
WHERE last_seen > DATE_SUB(NOW(), INTERVAL 1 HOUR)

UNION ALL

SELECT 
    'avg_response_time_ms',
    ROUND(AVG(avg_time)/1000, 2),
    NOW()
FROM stats.stats_mysql_query_digest
WHERE last_seen > DATE_SUB(NOW(), INTERVAL 1 HOUR)

UNION ALL  

SELECT 
    'active_connections',
    SUM(ConnUsed),
    NOW()
FROM stats.stats_mysql_connection_pool;
```

### 5.2 å†…å­˜ä½¿ç”¨ç›‘æ§


**ğŸ’¾ å†…å­˜ç»Ÿè®¡åˆ†æï¼š**
```sql
SELECT 
    Variable_name,
    Variable_value,
    CASE 
        WHEN Variable_name LIKE '%memory%' THEN 
            CONCAT(ROUND(Variable_value/1024/1024, 2), ' MB')
        ELSE Variable_value
    END as formatted_value
FROM stats.stats_memory
ORDER BY Variable_value DESC;
```

**âš ï¸ å†…å­˜ä½¿ç”¨å‘Šè­¦é˜ˆå€¼ï¼š**
```
æŸ¥è¯¢ç¼“å­˜å†…å­˜ä½¿ç”¨ > 80%  â†’ éœ€è¦æ¸…ç†æˆ–æ‰©å®¹
è¿æ¥ç¼“å†²åŒºä½¿ç”¨ > 90%   â†’ å¯èƒ½å†…å­˜æ³„æ¼
SQLite3å†…å­˜ > 100MB    â†’ ç»Ÿè®¡æ•°æ®è¿‡å¤š
```

### 5.3 æŸ¥è¯¢ç¼“å­˜åˆ†æ


**ğŸ—ƒï¸ æŸ¥è¯¢ç¼“å­˜æ•ˆæœç›‘æ§ï¼š**
```sql
-- æŸ¥çœ‹æŸ¥è¯¢ç¼“å­˜ç»Ÿè®¡
SELECT 
    Variable_name,
    Variable_value
FROM stats.stats_mysql_global 
WHERE Variable_name LIKE '%query_cache%'
   OR Variable_name LIKE '%Query_Cache%';
```

**ğŸ“Š ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—ï¼š**
```sql
-- è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡
SELECT 
    a.Variable_value as cache_hits,
    b.Variable_value as cache_misses,
    ROUND(
        a.Variable_value * 100.0 / 
        (a.Variable_value + b.Variable_value), 2
    ) as hit_rate_percent
FROM 
    (SELECT Variable_value FROM stats.stats_mysql_global 
     WHERE Variable_name = 'Com_select_for_update_or_equivalent') a,
    (SELECT Variable_value FROM stats.stats_mysql_global 
     WHERE Variable_name = 'Questions') b;
```

---

## 6. ğŸš¨ ç›‘æ§å‘Šè­¦é…ç½®


### 6.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡æ¸…å•ï¼š**

| ç›‘æ§ç±»åˆ« | **æŒ‡æ ‡åç§°** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| ğŸ”— **è¿æ¥** | `æ´»è·ƒè¿æ¥æ•°` | `< 80% max_connections` | `> 90%` |
| ğŸ”— **è¿æ¥** | `è¿æ¥é”™è¯¯ç‡` | `< 1%` | `> 5%` |
| âš¡ **æ€§èƒ½** | `å¹³å‡å“åº”æ—¶é—´` | `< 50ms` | `> 100ms` |
| âš¡ **æ€§èƒ½** | `æ…¢æŸ¥è¯¢æ¯”ä¾‹` | `< 5%` | `> 10%` |
| ğŸ’¾ **èµ„æº** | `å†…å­˜ä½¿ç”¨ç‡` | `< 80%` | `> 90%` |
| ğŸ¯ **å¯ç”¨æ€§** | `åç«¯æœåŠ¡å™¨çŠ¶æ€` | `ONLINE` | `OFFLINE/SHUNNED` |

### 6.2 å‘Šè­¦è§„åˆ™é…ç½®


**ğŸ“‹ ProxySQLç›‘æ§å‘Šè­¦è„šæœ¬ç¤ºä¾‹ï¼š**
```bash
#!/bin/bash
# proxysql_monitor.sh

PROXYSQL_HOST="127.0.0.1"
PROXYSQL_PORT="6032"
PROXYSQL_USER="admin"
PROXYSQL_PASS="admin"

# æ£€æŸ¥è¿æ¥æ± çŠ¶æ€
check_connection_pool() {
    local error_conn=$(mysql -h$PROXYSQL_HOST -P$PROXYSQL_PORT \
        -u$PROXYSQL_USER -p$PROXYSQL_PASS -N -e \
        "SELECT SUM(ConnERR) FROM stats.stats_mysql_connection_pool;")
    
    if [ "$error_conn" -gt 0 ]; then
        echo "âš ï¸ è­¦å‘Š: æ£€æµ‹åˆ° $error_conn ä¸ªé”™è¯¯è¿æ¥"
        # å‘é€å‘Šè­¦é€šçŸ¥
    fi
}

# æ£€æŸ¥æ…¢æŸ¥è¯¢
check_slow_queries() {
    local slow_queries=$(mysql -h$PROXYSQL_HOST -P$PROXYSQL_PORT \
        -u$PROXYSQL_USER -p$PROXYSQL_PASS -N -e \
        "SELECT COUNT(*) FROM stats.stats_mysql_query_digest 
         WHERE avg_time > 100000;")  # è¶…è¿‡100ms
    
    if [ "$slow_queries" -gt 10 ]; then
        echo "âš ï¸ è­¦å‘Š: æ£€æµ‹åˆ° $slow_queries ä¸ªæ…¢æŸ¥è¯¢"
    fi
}

# æ£€æŸ¥åç«¯æœåŠ¡å™¨çŠ¶æ€  
check_backend_status() {
    mysql -h$PROXYSQL_HOST -P$PROXYSQL_PORT \
        -u$PROXYSQL_USER -p$PROXYSQL_PASS -e \
        "SELECT hostgroup_id, hostname, port, status 
         FROM mysql_servers 
         WHERE status != 'ONLINE';" | \
    while read line; do
        if [ ! -z "$line" ]; then
            echo "ğŸ”´ é”™è¯¯: åç«¯æœåŠ¡å™¨å¼‚å¸¸ - $line"
        fi
    done
}

# æ‰§è¡Œæ£€æŸ¥
check_connection_pool
check_slow_queries  
check_backend_status
```

### 6.3 Grafanaç›‘æ§å¤§å±


**ğŸ“Š Grafana Dashboardé…ç½®è¦ç‚¹ï¼š**

```
æ ¸å¿ƒç›‘æ§é¢æ¿å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿æ¥æ•°è¶‹åŠ¿    â”‚   QPSå˜åŒ–è¶‹åŠ¿   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å“åº”æ—¶é—´åˆ†å¸ƒ   â”‚   æ…¢æŸ¥è¯¢Top10   â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯æœåŠ¡å™¨çŠ¶æ€  â”‚   é”™è¯¯ç‡ç»Ÿè®¡    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        æŸ¥è¯¢è·¯ç”±è§„åˆ™å‘½ä¸­æƒ…å†µ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ Prometheusé‡‡é›†é…ç½®ï¼š**
```yaml
# prometheus.yml
- job_name: 'proxysql'
  static_configs:
    - targets: ['proxysql:6070']  # ProxySQL metricsç«¯å£
  scrape_interval: 15s
  metrics_path: /metrics
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„ç›‘æ§è¦ç‚¹


```
ğŸ”¸ Statsè¡¨ä½“ç³»ï¼šæŒæ¡å„ç»Ÿè®¡è¡¨çš„ä½œç”¨å’ŒæŸ¥è¯¢æ–¹æ³•
ğŸ”¸ è¿æ¥ç›‘æ§ï¼šè¿æ¥æ± çŠ¶æ€ã€è¿æ¥é”™è¯¯ã€è¿æ¥ä½¿ç”¨ç‡
ğŸ”¸ æŸ¥è¯¢åˆ†æï¼šæ…¢æŸ¥è¯¢è¯†åˆ«ã€SQLæ‘˜è¦ç»Ÿè®¡ã€æ‰§è¡Œæ—¶é—´åˆ†å¸ƒ  
ğŸ”¸ æ€§èƒ½åŸºçº¿ï¼šå»ºç«‹åŸºçº¿ã€å¯¹æ¯”åˆ†æã€è¶‹åŠ¿é¢„æµ‹
ğŸ”¸ å‘Šè­¦é…ç½®ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ã€å¼‚å¸¸è‡ªåŠ¨å‘Šè­¦
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘æ§çš„æœ¬è´¨ç›®çš„**
```
ä¸æ˜¯ä¸ºäº†ç›‘æ§è€Œç›‘æ§ï¼Œè€Œæ˜¯ï¼š
â€¢ åŠæ—¶å‘ç°é—®é¢˜ â†’ å‡å°‘æ•…éšœå½±å“
â€¢ äº†è§£æ€§èƒ½è¶‹åŠ¿ â†’ æå‰æ‰©å®¹è§„åˆ’  
â€¢ ä¼˜åŒ–é…ç½®å‚æ•° â†’ æå‡ç³»ç»Ÿæ€§èƒ½
â€¢ å»ºç«‹è¿ç»´è§„èŒƒ â†’ ä¿éšœæœåŠ¡ç¨³å®š
```

**ğŸ”¹ å…³é”®æŒ‡æ ‡çš„å«ä¹‰**
```
è¿æ¥ç±»æŒ‡æ ‡ï¼š
â€¢ ConnUsed â†’ å½“å‰ä¸šåŠ¡è´Ÿè½½æƒ…å†µ
â€¢ ConnERR â†’ åç«¯æ•°æ®åº“å¥åº·çŠ¶æ€
â€¢ ConnFree â†’ è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†

æ€§èƒ½ç±»æŒ‡æ ‡ï¼š
â€¢ avg_time â†’ SQLæ‰§è¡Œæ•ˆç‡
â€¢ count_star â†’ SQLæ‰§è¡Œé¢‘ç‡
â€¢ sum_time â†’ SQLæ€»è€—æ—¶(ä¼˜åŒ–é‡ç‚¹)
```

**ğŸ”¹ ç›‘æ§æ•°æ®çš„æ—¶æ•ˆæ€§**
```
å®æ—¶ç›‘æ§ï¼šè¿æ¥çŠ¶æ€ã€é”™è¯¯ç‡
çŸ­æœŸç›‘æ§ï¼šæŸ¥è¯¢æ€§èƒ½ã€èµ„æºä½¿ç”¨(å°æ—¶çº§)
é•¿æœŸç›‘æ§ï¼šå®¹é‡è§„åˆ’ã€æ€§èƒ½è¶‹åŠ¿(å¤©/å‘¨çº§)
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ç”Ÿäº§ç¯å¢ƒç›‘æ§æœ€ä½³å®è·µï¼š**
- **åˆ†å±‚ç›‘æ§**ï¼šåŸºç¡€ç›‘æ§ + ä¸šåŠ¡ç›‘æ§ + ç”¨æˆ·ä½“éªŒç›‘æ§
- **å‘Šè­¦åˆ†çº§**ï¼šç´§æ€¥å‘Šè­¦(ç”µè¯) + è­¦å‘Šå‘Šè­¦(é‚®ä»¶) + ä¿¡æ¯é€šçŸ¥
- **æ•°æ®ä¿ç•™**ï¼šå®æ—¶æ•°æ®7å¤©ï¼Œå†å²æ•°æ®30å¤©ï¼Œè¶‹åŠ¿æ•°æ®1å¹´
- **å®šæœŸå·¡æ£€**ï¼šæ¯æ—¥æ£€æŸ¥å…³é”®æŒ‡æ ‡ï¼Œæ¯å‘¨åˆ†ææ€§èƒ½è¶‹åŠ¿

**ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯ï¼š**
```
ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹å…¨å±€ç»Ÿè®¡ â†’ åˆ¤æ–­æ•´ä½“çŠ¶å†µ
ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥è¿æ¥æ± çŠ¶æ€ â†’ å®šä½è¿æ¥é—®é¢˜
ç¬¬ä¸‰æ­¥ï¼šåˆ†ææŸ¥è¯¢ç»Ÿè®¡ â†’ æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ  
ç¬¬å››æ­¥ï¼šæŸ¥çœ‹é”™è¯¯ç»Ÿè®¡ â†’ ç¡®è®¤å¼‚å¸¸åŸå› 
ç¬¬äº”æ­¥ï¼šå¯¹æ¯”å†å²æ•°æ® â†’ åˆ†æå˜åŒ–è¶‹åŠ¿
```

> ğŸ“Œ **ä¸€å¥è¯æ€»ç»“**  
> ProxySQLç›‘æ§å°±åƒç»™ç³»ç»Ÿåšä½“æ£€ï¼Œé€šè¿‡Statsç»Ÿè®¡è¡¨å®æ—¶äº†è§£ç³»ç»Ÿå¥åº·çŠ¶å†µï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜ï¼Œä¿éšœæ•°æ®åº“æœåŠ¡ç¨³å®šè¿è¡Œã€‚

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç»Ÿè®¡è¡¨æ˜¯æ•°æ®æºï¼Œè¿æ¥æŸ¥è¯¢è¦ç›‘æ§
- æ€§èƒ½åŸºçº¿å»ºç«‹å¥½ï¼Œå¼‚å¸¸å˜åŒ–æ—©å‘ç°  
- å‘Šè­¦é…ç½®è¦åˆç†ï¼Œæ•…éšœæ’æŸ¥æœ‰æ€è·¯
- ç›‘æ§ä¸æ˜¯ä¸ºç›‘æ§ï¼ŒåŠæ—¶è§£å†³æ‰æ˜¯ç‹é“