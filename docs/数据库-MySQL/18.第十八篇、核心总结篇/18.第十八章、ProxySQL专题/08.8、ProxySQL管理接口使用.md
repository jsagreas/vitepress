---
title: 8、ProxySQL管理接口使用
---
## 📚 目录

1. [ProxySQL管理接口概述](#1-ProxySQL管理接口概述)
2. [Admin接口连接方式](#2-Admin接口连接方式)
3. [核心管理命令详解](#3-核心管理命令详解)
4. [配置查看与修改操作](#4-配置查看与修改操作)
5. [统计信息查询监控](#5-统计信息查询监控)
6. [配置加载保存机制](#6-配置加载保存机制)
7. [热更新操作实践](#7-热更新操作实践)
8. [管理用户权限控制](#8-管理用户权限控制)
9. [批量操作与自动化](#9-批量操作与自动化)
10. [安全防护最佳实践](#10-安全防护最佳实践)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🎯 ProxySQL管理接口概述


### 1.1 什么是ProxySQL管理接口


**💡 通俗理解**
想象ProxySQL就像一个智能路由器，管理接口就是这个路由器的"控制面板"。通过这个控制面板，你可以：
- 查看当前运行状态（就像看路由器状态灯）
- 修改配置参数（就像修改WiFi密码）
- 监控流量统计（就像查看网络使用量）
- 重启或重新加载配置（就像重启路由器）

```
ProxySQL架构简图：
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端应用     │────│  ProxySQL代理   │────│   MySQL服务器   │
│   (业务流量)     │    │                 │    │   (数据库集群)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   管理接口       │ ← 我们要学习的部分
                       │ (Admin Interface)│
                       └─────────────────┘
```

### 1.2 管理接口的核心作用


**🔧 主要功能**
```
配置管理：
• 查看和修改代理规则
• 管理后端MySQL服务器
• 设置用户认证信息
• 配置监控参数

运行监控：
• 查看连接池状态
• 监控SQL执行统计
• 检查服务器健康状态
• 分析性能指标

运维操作：
• 热更新配置（不停机）
• 加载和保存配置
• 备份和恢复设置
• 执行批量操作
```

### 1.3 接口类型与端口


**📊 接口端口说明**
```
默认端口配置：
┌─────────────────┬─────────┬─────────────────────┐
│    接口类型      │  端口   │        用途         │
├─────────────────┼─────────┼─────────────────────┤
│ 业务接口(MySQL)  │  6033   │ 应用程序连接使用     │
│ 管理接口(Admin)  │  6032   │ 管理员配置监控使用   │
│ Web管理界面     │  6080   │ 浏览器图形化管理     │
└─────────────────┴─────────┴─────────────────────┘

重要理解：
• 6033端口：应用连接，就像正常的MySQL端口
• 6032端口：管理专用，只有管理员使用
• 两个端口功能完全不同，不要搞混！
```

---

## 2. 🔌 Admin接口连接方式


### 2.1 命令行连接方法


**⚡ 基础连接语法**
```bash
# 标准连接方式
mysql -u admin -padmin -h 127.0.0.1 -P6032 --prompt='ProxySQL Admin> '

# 参数解释：
# -u admin     ：用户名（默认是admin）
# -padmin      ：密码（默认是admin，注意p和密码间无空格）
# -h 127.0.0.1 ：主机地址
# -P6032       ：管理端口（注意是大写P）
# --prompt     ：自定义提示符，方便区分
```

**🔍 连接成功示例**
```bash
# 执行连接命令后看到：
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.5.30 (ProxySQL Admin Module)

ProxySQL Admin> SHOW DATABASES;
+-----+---------------+-------------------------------------+
| seq | name          | file                                |
+-----+---------------+-------------------------------------+
| 0   | main          |                                     |
| 2   | disk          | /var/lib/proxysql/proxysql.db       |
| 3   | stats         |                                     |
| 4   | monitor       |                                     |
+-----+---------------+-------------------------------------+

# 看到这个输出说明连接成功了！
```

### 2.2 不同连接场景


**🏠 本地连接**
```bash
# 在ProxySQL所在机器上
mysql -u admin -padmin -h localhost -P6032

# 或者使用Unix socket（如果启用）
mysql -u admin -padmin -S /tmp/proxysql_admin.sock
```

**🌐 远程连接**
```bash
# 连接远程ProxySQL服务器
mysql -u admin -padmin -h 192.168.1.100 -P6032

# 注意：需要确保防火墙开放6032端口
# 并且ProxySQL配置允许远程连接
```

**🔒 安全连接配置**
```sql
-- 修改默认管理员密码
ProxySQL Admin> UPDATE global_variables 
                SET variable_value='new_secure_password' 
                WHERE variable_name='admin-admin_credentials';

-- 保存配置
ProxySQL Admin> SAVE ADMIN VARIABLES TO DISK;
```

### 2.3 连接故障排查


**❌ 常见连接问题**
```bash
# 问题1：连接被拒绝
ERROR 2003 (HY000): Can't connect to MySQL server on '127.0.0.1' (111)

解决思路：
1. 检查ProxySQL是否启动：ps aux | grep proxysql
2. 检查端口是否监听：netstat -tlnp | grep 6032
3. 检查防火墙设置：iptables -L | grep 6032

# 问题2：认证失败
ERROR 1045 (28000): Access denied for user 'admin'@'localhost'

解决思路：
1. 确认用户名密码正确
2. 检查管理员账户配置
3. 查看ProxySQL错误日志
```

---

## 3. 🛠️ 核心管理命令详解


### 3.1 数据库层级结构


**📊 ProxySQL内部数据库**
```
ProxySQL内部结构：
├── main 数据库      ← 运行时配置（内存中）
├── disk 数据库      ← 持久化配置（磁盘上）
├── stats 数据库     ← 统计信息（只读）
└── monitor 数据库   ← 监控日志（只读）

理解要点：
• main：当前生效的配置，重启会丢失
• disk：保存到磁盘的配置，重启后恢复
• stats：实时统计数据，用于监控分析
• monitor：监控检查日志，用于故障排查
```

### 3.2 基础查看命令


**👀 查看基本信息**
```sql
-- 1. 查看版本信息
ProxySQL Admin> SELECT $$version;
+-------------------------+
| $$version               |
+-------------------------+
| 2.4.4-ProxySQL-2.4.4   |
+-------------------------+

-- 2. 查看所有数据库
ProxySQL Admin> SHOW DATABASES;

-- 3. 查看当前数据库
ProxySQL Admin> SELECT DATABASE();

-- 4. 切换到指定数据库
ProxySQL Admin> USE stats;  -- 切换到统计数据库
```

**📋 查看表结构**
```sql
-- 查看main数据库中的所有表
ProxySQL Admin> SHOW TABLES FROM main;
+----------------------------------------------------+
| tables                                             |
+----------------------------------------------------+
| global_variables                                   | ← 全局变量配置
| mysql_collations                                   | ← 字符集配置
| mysql_group_replication_hostgroups                | ← 组复制配置
| mysql_query_rules                                  | ← 查询路由规则
| mysql_replication_hostgroups                      | ← 主从复制配置
| mysql_servers                                      | ← 后端服务器列表
| mysql_users                                        | ← 用户认证信息
| proxysql_servers                                   | ← ProxySQL集群
| scheduler                                          | ← 定时任务
+----------------------------------------------------+
```

### 3.3 帮助命令系统


**❓ 获取帮助信息**
```sql
-- 查看所有可用命令
ProxySQL Admin> SHOW COMMANDS;

-- 查看特定表的结构
ProxySQL Admin> DESCRIBE mysql_servers;
+-------------+---------+------+-----+---------+-------+
| Field       | Type    | Null | Key | Default | Extra |
+-------------+---------+------+-----+---------+-------+
| hostgroup_id| int(11) | NO   |     | NULL    |       |
| hostname    | varchar | NO   |     | NULL    |       |
| port        | int(11) | NO   |     | 3306    |       |
| status      | varchar | NO   |     | ONLINE  |       |
| weight      | int(11) | NO   |     | 1000    |       |
| compression | int(11) | NO   |     | 0       |       |
| max_connections| int  | NO   |     | 1000    |       |
+-------------+---------+------+-----+---------+-------+
```

---

## 4. ⚙️ 配置查看与修改操作


### 4.1 全局变量管理


**🔧 查看全局配置**
```sql
-- 查看所有全局变量
ProxySQL Admin> SELECT * FROM global_variables;

-- 查看特定变量（支持模糊匹配）
ProxySQL Admin> SELECT * FROM global_variables 
                WHERE variable_name LIKE '%admin%';
+---------------------------+----------------+
| variable_name             | variable_value |
+---------------------------+----------------+
| admin-admin_credentials   | admin:admin    | ← 管理员账户
| admin-mysql_ifaces       | 0.0.0.0:6032   | ← 管理接口地址
| admin-telnet_admin_ifaces | 0.0.0.0:6032   | ← telnet接口
| admin-web_enabled         | true           | ← Web界面开关
+---------------------------+----------------+
```

**✏️ 修改全局变量**
```sql
-- 修改变量值（以连接池大小为例）
ProxySQL Admin> UPDATE global_variables 
                SET variable_value='16' 
                WHERE variable_name='mysql-default_max_connections';

-- 确认修改
ProxySQL Admin> SELECT * FROM global_variables 
                WHERE variable_name='mysql-default_max_connections';

-- 重要提醒：修改后需要加载才能生效！
ProxySQL Admin> LOAD MYSQL VARIABLES TO RUNTIME;
```

### 4.2 后端服务器管理


**🏠 查看MySQL服务器**
```sql
ProxySQL Admin> SELECT * FROM mysql_servers;
+--------------+---------------+------+-----------+--------+--------+--------------+
| hostgroup_id | hostname      | port | status    | weight | compression | max_connections |
+--------------+---------------+------+-----------+--------+--------+--------------+
| 0            | 192.168.1.10  | 3306 | ONLINE    | 1000   | 0      | 1000         |
| 1            | 192.168.1.11  | 3306 | ONLINE    | 900    | 0      | 1000         |
| 1            | 192.168.1.12  | 3306 | OFFLINE_SOFT | 800 | 0      | 1000         |
+--------------+---------------+------+-----------+--------+--------+--------------+

字段含义解释：
• hostgroup_id：服务器组ID（0通常是写组，1是读组）
• hostname：服务器IP地址
• port：MySQL端口号
• status：服务器状态（ONLINE/OFFLINE_SOFT/OFFLINE_HARD）
• weight：权重（数值越大，分配的连接越多）
• max_connections：最大连接数
```

**➕ 添加新服务器**
```sql
-- 添加一台新的MySQL服务器到读组
ProxySQL Admin> INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight) 
                VALUES (1, '192.168.1.13', 3306, 1000);

-- 查询确认
ProxySQL Admin> SELECT * FROM mysql_servers WHERE hostname='192.168.1.13';

-- 让配置生效
ProxySQL Admin> LOAD MYSQL SERVERS TO RUNTIME;
```

**🔄 修改服务器状态**
```sql
-- 将服务器设为离线状态（维护时使用）
ProxySQL Admin> UPDATE mysql_servers 
                SET status='OFFLINE_SOFT' 
                WHERE hostname='192.168.1.12';

-- OFFLINE_SOFT：软离线，现有连接继续，不接受新连接
-- OFFLINE_HARD：硬离线，立即断开所有连接

-- 恢复在线状态
ProxySQL Admin> UPDATE mysql_servers 
                SET status='ONLINE' 
                WHERE hostname='192.168.1.12';
```

### 4.3 用户认证管理


**👤 查看用户配置**
```sql
ProxySQL Admin> SELECT * FROM mysql_users;
+----------+-------------------------------------------+--------+---------+
| username | password                                  | active | default_hostgroup |
+----------+-------------------------------------------+--------+---------+
| app_user | *84AAC12F54AB666ECFC2A83C676908C8BBC381B1  | 1      | 0         |
| read_user| *94BDCEBE19083CE2A1F959FD02F964C7AF4CFC29  | 1      | 1         |
+----------+-------------------------------------------+--------+---------+

字段说明：
• username：应用连接的用户名
• password：MySQL格式的密码哈希值
• active：是否激活（1=是，0=否）
• default_hostgroup：默认连接的服务器组
```

**👤 添加新用户**
```sql
-- 添加新的应用用户
ProxySQL Admin> INSERT INTO mysql_users(username, password, default_hostgroup) 
                VALUES ('new_app', '*2470C0C06DEE42FD1618BB99005ADCA2EC9D1E19', 0);

-- 密码哈希值可以从MySQL服务器获取：
-- SELECT PASSWORD('your_password');

-- 激活配置
ProxySQL Admin> LOAD MYSQL USERS TO RUNTIME;
```

---

## 5. 📊 统计信息查询监控


### 5.1 连接池状态监控


**🔌 查看连接池统计**
```sql
-- 切换到统计数据库
ProxySQL Admin> USE stats;

-- 查看连接池状态
ProxySQL Admin> SELECT * FROM stats_mysql_connection_pool;
+--------------+----------+----------+----------+----------+----------+----------+
| hostgroup    | srv_host | srv_port | status   | ConnUsed | ConnFree | ConnOK   |
+--------------+----------+----------+----------+----------+----------+----------+
| 0            | 192.168.1.10 | 3306 | ONLINE   | 5        | 10       | 15       |
| 1            | 192.168.1.11 | 3306 | ONLINE   | 2        | 8        | 10       |
| 1            | 192.168.1.12 | 3306 | OFFLINE_SOFT | 0    | 0        | 0        |
+--------------+----------+----------+----------+----------+----------+----------+

字段含义：
• ConnUsed：正在使用的连接数
• ConnFree：空闲连接数
• ConnOK：健康连接总数
• 通过这些数据可以判断负载分布是否均匀
```

**📈 查看连接历史趋势**
```sql
-- 查看连接池历史数据（每5秒记录一次）
ProxySQL Admin> SELECT * FROM stats_mysql_connection_pool_reset;

-- 查看全局连接统计
ProxySQL Admin> SELECT * FROM stats_mysql_global;
+----------------------------+----------------+
| Variable_Name              | Variable_Value |
+----------------------------+----------------+
| ProxySQL_Uptime            | 3600           | ← 运行时间（秒）
| Active_Transactions        | 12             | ← 活跃事务数
| Client_Connections_aborted | 0              | ← 异常断开的客户端
| Client_Connections_connected| 25            | ← 当前客户端连接
| Questions                  | 15234          | ← 总查询数
| Slow_queries               | 23             | ← 慢查询数
+----------------------------+----------------+
```

### 5.2 查询性能分析


**🔍 查看查询统计**
```sql
-- 查看查询规则匹配统计
ProxySQL Admin> SELECT * FROM stats_mysql_query_rules;
+-------+------+----------+----------+----------+
| rule_id | matches | nrexec | digest   | match_pattern |
+-------+------+----------+----------+----------+
| 1     | 1250 | 1250     | 0x789A...| SELECT.*FROM users |
| 2     | 890  | 890      | 0x456B...| INSERT.*INTO logs  |
+-------+------+----------+----------+----------+

字段解释：
• rule_id：规则ID
• matches：匹配次数
• nrexec：执行次数
• 可以看出哪些规则使用频率高
```

**⚡ 查看慢查询统计**
```sql
-- 查看查询摘要统计（类似于MySQL的performance_schema）
ProxySQL Admin> SELECT digest, digest_text, count_star, sum_time 
                FROM stats_mysql_query_digest 
                ORDER BY sum_time DESC LIMIT 5;

+----------+------------------------+------------+----------+
| digest   | digest_text            | count_star | sum_time |
+----------+------------------------+------------+----------+
| 0x789A...| SELECT * FROM users WHERE id=?  | 1250  | 45000 |
| 0x456B...| INSERT INTO logs VALUES(...)     | 890   | 23000 |
+----------+------------------------+------------+----------+

分析要点：
• count_star：查询执行次数
• sum_time：总耗时（微秒）
• 找出执行次数多或耗时长的查询进行优化
```

### 5.3 服务器健康监控


**💓 查看服务器监控日志**
```sql
-- 切换到监控数据库
ProxySQL Admin> USE monitor;

-- 查看服务器连接测试日志
ProxySQL Admin> SELECT * FROM mysql_server_connect_log 
                ORDER BY time_start_us DESC LIMIT 10;
+---------------+------+------------------+-------------------+
| hostname      | port | time_start_us    | connect_success_time_us |
+---------------+------+------------------+-------------------+
| 192.168.1.10  | 3306 | 1694678400000000 | 1523              |
| 192.168.1.11  | 3306 | 1694678400000000 | 1234              |
+---------------+------+------------------+-------------------+

-- 查看服务器Ping测试日志
ProxySQL Admin> SELECT * FROM mysql_server_ping_log 
                WHERE hostname='192.168.1.10' 
                ORDER BY time_start_us DESC LIMIT 5;
```

---

## 6. 💾 配置加载保存机制


### 6.1 理解三层配置结构


**📊 ProxySQL配置层次**
```
配置流向图：
┌─────────────┐    LOAD TO     ┌─────────────┐    SAVE TO    ┌─────────────┐
│ DISK 配置   │──────────────→ │ RUNTIME配置 │─────────────→ │ MEMORY配置  │
│ (持久化)    │                │ (当前生效)   │               │ (临时修改)   │
└─────────────┘                └─────────────┘               └─────────────┘
      ↑                               │                             │
      │         SAVE TO DISK         │                             │
      └──────────────────────────────┘                             │
                                      │                             │
                                      │      UPDATE/INSERT/DELETE   │
                                      │←────────────────────────────┘

理解要点：
1. MEMORY：你直接修改的配置（INSERT/UPDATE/DELETE）
2. RUNTIME：当前正在使用的配置（LOAD后生效）
3. DISK：保存到磁盘的配置（重启后恢复）
```

### 6.2 配置加载操作


**📥 加载配置到运行时**
```sql
-- 加载服务器配置
ProxySQL Admin> LOAD MYSQL SERVERS TO RUNTIME;
Query OK, 0 rows affected (0.01 sec)

-- 加载用户配置
ProxySQL Admin> LOAD MYSQL USERS TO RUNTIME;

-- 加载全局变量
ProxySQL Admin> LOAD MYSQL VARIABLES TO RUNTIME;

-- 加载查询规则
ProxySQL Admin> LOAD MYSQL QUERY RULES TO RUNTIME;

-- 一次性加载所有MySQL相关配置
ProxySQL Admin> LOAD MYSQL SERVERS TO RUNTIME;
ProxySQL Admin> LOAD MYSQL USERS TO RUNTIME; 
ProxySQL Admin> LOAD MYSQL VARIABLES TO RUNTIME;
ProxySQL Admin> LOAD MYSQL QUERY RULES TO RUNTIME;
```

**⚠️ 重要注意事项**
```sql
-- 配置修改后必须LOAD才能生效
-- 例如：修改服务器后
UPDATE mysql_servers SET weight=500 WHERE hostname='192.168.1.10';
-- 此时修改还没生效，必须执行：
LOAD MYSQL SERVERS TO RUNTIME;
-- 现在修改才真正生效！

-- 检查是否有未加载的配置
SHOW MYSQL SERVERS;  -- 查看RUNTIME配置
SELECT * FROM mysql_servers;  -- 查看MEMORY配置
-- 如果两者不同，说明有配置未加载
```

### 6.3 配置保存操作


**💾 保存配置到磁盘**
```sql
-- 保存服务器配置到磁盘
ProxySQL Admin> SAVE MYSQL SERVERS TO DISK;

-- 保存用户配置到磁盘
ProxySQL Admin> SAVE MYSQL USERS TO DISK;

-- 保存全局变量到磁盘
ProxySQL Admin> SAVE MYSQL VARIABLES TO DISK;

-- 保存查询规则到磁盘
ProxySQL Admin> SAVE MYSQL QUERY RULES TO DISK;

-- 保存管理接口配置
ProxySQL Admin> SAVE ADMIN VARIABLES TO DISK;
```

**🔄 完整的配置更新流程**
```sql
-- 标准配置更新流程示例：添加新服务器
-- 步骤1：修改配置（存储在MEMORY）
INSERT INTO mysql_servers(hostgroup_id, hostname, port) 
VALUES (1, '192.168.1.14', 3306);

-- 步骤2：加载到运行时（开始生效）
LOAD MYSQL SERVERS TO RUNTIME;

-- 步骤3：测试验证配置是否正常工作
-- 可以通过stats库查看连接情况

-- 步骤4：保存到磁盘（持久化）
SAVE MYSQL SERVERS TO DISK;

-- 这样即使重启也不会丢失配置
```

---

## 7. 🔥 热更新操作实践


### 7.1 热更新的核心概念


**💡 什么是热更新**
热更新指在ProxySQL运行过程中修改配置，无需重启服务就能使新配置生效。这对于生产环境非常重要，可以做到：
- **零停机时间**：业务连接不会中断
- **平滑切换**：新配置逐渐生效
- **快速回滚**：发现问题可以立即恢复

```
热更新过程示意：
业务连接 ──────────┐
                  ▼
              ┌─────────┐
              │ProxySQL │ ← 运行中，不停机
              └─────────┘
                  │
修改配置 ────→ LOAD ────→ 新配置生效 ← 业务无感知
```

### 7.2 常见热更新场景


**🔧 服务器状态调整**
```sql
-- 场景：某台MySQL服务器需要维护
-- 1. 先将服务器设为软离线（现有连接保持，不接受新连接）
UPDATE mysql_servers 
SET status='OFFLINE_SOFT' 
WHERE hostname='192.168.1.11';

LOAD MYSQL SERVERS TO RUNTIME;

-- 2. 等待现有连接自然结束（可以监控连接数）
SELECT ConnUsed FROM stats.stats_mysql_connection_pool 
WHERE srv_host='192.168.1.11';

-- 3. 维护完成后恢复在线
UPDATE mysql_servers 
SET status='ONLINE' 
WHERE hostname='192.168.1.11';

LOAD MYSQL SERVERS TO RUNTIME;
```

**⚖️ 负载权重调整**
```sql
-- 场景：调整服务器负载分配
-- 降低服务器A的权重，提高服务器B的权重
UPDATE mysql_servers SET weight=500 WHERE hostname='192.168.1.10';
UPDATE mysql_servers SET weight=1500 WHERE hostname='192.168.1.11';

LOAD MYSQL SERVERS TO RUNTIME;

-- 查看效果（权重高的服务器会分配更多连接）
SELECT srv_host, srv_port, ConnUsed, ConnFree 
FROM stats.stats_mysql_connection_pool;
```

**👤 用户权限调整**
```sql
-- 场景：临时禁用某个用户
UPDATE mysql_users SET active=0 WHERE username='problem_user';
LOAD MYSQL USERS TO RUNTIME;

-- 用户立即无法新建连接，现有连接不受影响

-- 恢复用户权限
UPDATE mysql_users SET active=1 WHERE username='problem_user';
LOAD MYSQL USERS TO RUNTIME;
```

### 7.3 热更新最佳实践


**✅ 安全的热更新步骤**
```sql
-- 1. 备份当前配置（以服务器配置为例）
CREATE TABLE mysql_servers_backup AS SELECT * FROM mysql_servers;

-- 2. 修改配置
UPDATE mysql_servers SET weight=800 WHERE hostname='192.168.1.10';

-- 3. 加载配置
LOAD MYSQL SERVERS TO RUNTIME;

-- 4. 验证配置效果
SELECT * FROM stats.stats_mysql_connection_pool;

-- 5. 如果一切正常，保存到磁盘
SAVE MYSQL SERVERS TO DISK;

-- 6. 清理备份表
DROP TABLE mysql_servers_backup;
```

**🚨 快速回滚方案**
```sql
-- 如果发现配置有问题，可以快速回滚
-- 方法1：从备份表恢复
DELETE FROM mysql_servers;
INSERT INTO mysql_servers SELECT * FROM mysql_servers_backup;
LOAD MYSQL SERVERS TO RUNTIME;

-- 方法2：从磁盘重新加载（恢复到最后一次保存的状态）
LOAD MYSQL SERVERS FROM DISK;
LOAD MYSQL SERVERS TO RUNTIME;
```

---

## 8. 🔐 管理用户权限控制


### 8.1 管理接口安全机制


**🔒 认证层级理解**
ProxySQL的管理接口有两层安全控制：
1. **接口级别**：谁能连接到管理接口
2. **命令级别**：连接后能执行哪些操作

```
安全控制结构：
┌─────────────────┐
│   管理员用户     │ ← admin用户（完全权限）
├─────────────────┤
│   统计用户       │ ← stats用户（只读统计）
├─────────────────┤
│   普通用户       │ ← 无管理接口权限
└─────────────────┘
```

### 8.2 管理员账户配置


**👑 查看管理员配置**
```sql
-- 查看当前管理员账户设置
SELECT * FROM global_variables 
WHERE variable_name='admin-admin_credentials';
+---------------------------+----------------+
| variable_name             | variable_value |
+---------------------------+----------------+
| admin-admin_credentials   | admin:admin    |
+---------------------------+----------------+

-- 格式说明：username:password
-- 可以配置多个管理员，用分号分隔：user1:pass1;user2:pass2
```

**🔑 修改管理员密码**
```sql
-- 修改默认管理员密码
UPDATE global_variables 
SET variable_value='admin:new_strong_password' 
WHERE variable_name='admin-admin_credentials';

-- 添加新的管理员用户
UPDATE global_variables 
SET variable_value='admin:new_strong_password;dba_user:dba_password' 
WHERE variable_name='admin-admin_credentials';

-- 保存配置
SAVE ADMIN VARIABLES TO DISK;

-- 注意：修改后当前连接仍然有效，新连接需要新密码
```

### 8.3 统计用户配置


**📊 配置只读统计用户**
```sql
-- 查看统计用户配置
SELECT * FROM global_variables 
WHERE variable_name='admin-stats_credentials';

-- 配置统计专用用户（只能查看统计信息）
UPDATE global_variables 
SET variable_value='stats_user:stats_password' 
WHERE variable_name='admin-stats_credentials';

SAVE ADMIN VARIABLES TO DISK;
```

**📈 统计用户使用方式**
```bash
# 使用统计用户连接
mysql -u stats_user -pstats_password -h 127.0.0.1 -P6032

# 统计用户只能查看stats和monitor数据库
ProxySQL Admin> USE stats;
ProxySQL Admin> SELECT * FROM stats_mysql_connection_pool;  -- ✅ 可以

ProxySQL Admin> USE main;
ProxySQL Admin> SELECT * FROM mysql_servers;  -- ❌ 权限不足
```

### 8.4 网络访问控制


**🌐 接口绑定配置**
```sql
-- 查看管理接口绑定地址
SELECT * FROM global_variables 
WHERE variable_name='admin-mysql_ifaces';
+---------------------------+----------------+
| variable_name             | variable_value |
+---------------------------+----------------+
| admin-mysql_ifaces        | 0.0.0.0:6032   |
+---------------------------+----------------+

-- 修改为只允许本地访问
UPDATE global_variables 
SET variable_value='127.0.0.1:6032' 
WHERE variable_name='admin-mysql_ifaces';

-- 或者绑定到特定内网IP
UPDATE global_variables 
SET variable_value='192.168.1.100:6032' 
WHERE variable_name='admin-mysql_ifaces';

LOAD ADMIN VARIABLES TO RUNTIME;
SAVE ADMIN VARIABLES TO DISK;
```

---

## 9. 🤖 批量操作与自动化


### 9.1 SQL脚本批量操作


**📝 创建配置脚本**
```bash
# 创建服务器批量配置脚本 add_servers.sql
cat > add_servers.sql << 'EOF'
-- 批量添加多台MySQL服务器
INSERT INTO mysql_servers(hostgroup_id, hostname, port, weight) VALUES
(0, '192.168.1.20', 3306, 1000),
(1, '192.168.1.21', 3306, 1000),
(1, '192.168.1.22', 3306, 1000),
(1, '192.168.1.23', 3306, 1000);

-- 加载配置
LOAD MYSQL SERVERS TO RUNTIME;
SAVE MYSQL SERVERS TO DISK;

-- 查看结果
SELECT hostgroup_id, hostname, port, status, weight FROM mysql_servers;
EOF
```

**⚡ 执行批量脚本**
```bash
# 方法1：通过文件执行
mysql -u admin -padmin -h 127.0.0.1 -P6032 < add_servers.sql

# 方法2：在管理界面中执行
ProxySQL Admin> source add_servers.sql;

# 方法3：一行命令执行
mysql -u admin -padmin -h 127.0.0.1 -P6032 \
  -e "INSERT INTO mysql_servers VALUES (1,'192.168.1.24',3306,'ONLINE',1000,0,1000); 
      LOAD MYSQL SERVERS TO RUNTIME;"
```

### 9.2 Shell脚本自动化


**🔧 服务器健康检查脚本**
```bash
#!/bin/bash
# proxysql_health_check.sh

# 连接配置
PROXY_HOST="127.0.0.1"
PROXY_PORT="6032"
PROXY_USER="admin"
PROXY_PASS="admin"

# 检查连接池状态
check_connection_pool() {
    echo "=== 连接池状态检查 ==="
    mysql -u$PROXY_USER -p$PROXY_PASS -h$PROXY_HOST -P$PROXY_PORT \
          -e "SELECT hostgroup, srv_host, srv_port, status, ConnUsed, ConnFree 
              FROM stats.stats_mysql_connection_pool;" 2>/dev/null
}

# 检查服务器状态
check_server_status() {
    echo "=== 服务器状态检查 ==="
    mysql -u$PROXY_USER -p$PROXY_PASS -h$PROXY_HOST -P$PROXY_PORT \
          -e "SELECT hostgroup_id, hostname, port, status, weight 
              FROM mysql_servers ORDER BY hostgroup_id, hostname;" 2>/dev/null
}

# 检查异常连接
check_failed_connections() {
    echo "=== 异常连接检查 ==="
    mysql -u$PROXY_USER -p$PROXY_PASS -h$PROXY_HOST -P$PROXY_PORT \
          -e "SELECT hostname, port, time_start_us, connect_error 
              FROM monitor.mysql_server_connect_log 
              WHERE connect_success_time_us IS NULL 
              ORDER BY time_start_us DESC LIMIT 10;" 2>/dev/null
}

# 执行检查
check_connection_pool
check_server_status  
check_failed_connections
```

**📊 自动化监控脚本**
```bash
#!/bin/bash
# proxysql_monitor.sh

# 获取关键指标
get_metrics() {
    local query="
    SELECT 
        Variable_Name, 
        Variable_Value 
    FROM stats.stats_mysql_global 
    WHERE Variable_Name IN (
        'Client_Connections_connected',
        'Questions',
        'Slow_queries',
        'Server_Connections_connected'
    );"
    
    mysql -u admin -padmin -h 127.0.0.1 -P6032 -e "$query" 2>/dev/null
}

# 检查慢查询
check_slow_queries() {
    local query="
    SELECT 
        LEFT(digest_text, 50) as query_pattern,
        count_star as executions,
        sum_time/1000 as total_time_ms,
        (sum_time/count_star)/1000 as avg_time_ms
    FROM stats.stats_mysql_query_digest 
    WHERE sum_time > 100000  -- 大于100ms的查询
    ORDER BY sum_time DESC 
    LIMIT 5;"
    
    echo "=== 慢查询统计 ==="
    mysql -u admin -padmin -h 127.0.0.1 -P6032 -e "$query" 2>/dev/null
}

# 每分钟执行一次
while true; do
    echo "$(date): ProxySQL监控报告"
    get_metrics
    check_slow_queries
    echo "---"
    sleep 60
done
```

### 9.3 配置备份恢复自动化


**💾 自动备份脚本**
```bash
#!/bin/bash
# proxysql_backup.sh

BACKUP_DIR="/var/backups/proxysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/proxysql_config_$DATE.sql"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 导出配置
echo "-- ProxySQL配置备份 - $DATE" > $BACKUP_FILE
echo "-- 全局变量" >> $BACKUP_FILE
mysql -u admin -padmin -h 127.0.0.1 -P6032 \
  -e "SELECT CONCAT('UPDATE global_variables SET variable_value=\"', variable_value, 
      '\" WHERE variable_name=\"', variable_name, '\";') 
      FROM global_variables;" -s -N >> $BACKUP_FILE

echo "-- MySQL服务器" >> $BACKUP_FILE  
mysql -u admin -padmin -h 127.0.0.1 -P6032 \
  -e "SELECT CONCAT('INSERT INTO mysql_servers VALUES (', hostgroup_id, ',\"', hostname, 
      '\",', port, ',\"', status, '\",', weight, ',', compression, ',', max_connections, ');') 
      FROM mysql_servers;" -s -N >> $BACKUP_FILE

echo "-- MySQL用户" >> $BACKUP_FILE
mysql -u admin -padmin -h 127.0.0.1 -P6032 \
  -e "SELECT CONCAT('INSERT INTO mysql_users VALUES (\"', username, '\",\"', password, 
      '\",', active, ',', default_hostgroup, ');') 
      FROM mysql_users;" -s -N >> $BACKUP_FILE

echo "配置备份完成: $BACKUP_FILE"

# 保留最近7天的备份
find $BACKUP_DIR -name "proxysql_config_*.sql" -mtime +7 -delete
```

---

## 10. 🛡️ 安全防护最佳实践


### 10.1 访问控制安全


**🔐 强化管理接口安全**
```sql
-- 1. 修改默认密码
UPDATE global_variables 
SET variable_value='admin:ComplexPassword123!' 
WHERE variable_name='admin-admin_credentials';

-- 2. 限制接口绑定（只允许内网访问）
UPDATE global_variables 
SET variable_value='192.168.1.100:6032' 
WHERE variable_name='admin-mysql_ifaces';

-- 3. 禁用Web管理界面（如果不需要）
UPDATE global_variables 
SET variable_value='false' 
WHERE variable_name='admin-web_enabled';

-- 4. 配置统计用户（分离权限）
UPDATE global_variables 
SET variable_value='monitoring:MonitorPass456' 
WHERE variable_name='admin-stats_credentials';

LOAD ADMIN VARIABLES TO RUNTIME;
SAVE ADMIN VARIABLES TO DISK;
```

**🔥 防火墙配置**
```bash
# iptables规则示例（只允许特定IP访问管理端口）
# 允许本机访问
iptables -A INPUT -i lo -p tcp --dport 6032 -j ACCEPT

# 允许管理网段访问
iptables -A INPUT -s 192.168.100.0/24 -p tcp --dport 6032 -j ACCEPT

# 拒绝其他访问
iptables -A INPUT -p tcp --dport 6032 -j DROP

# 保存规则
iptables-save > /etc/iptables/rules.v4
```

### 10.2 操作审计与日志


**📝 启用详细日志**
```sql
-- 启用查询日志
UPDATE global_variables 
SET variable_value='true' 
WHERE variable_name='mysql-eventslog_enabled';

-- 设置日志文件路径
UPDATE global_variables 
SET variable_value='/var/log/proxysql_queries.log' 
WHERE variable_name='mysql-eventslog_filename';

-- 设置日志级别
UPDATE global_variables 
SET variable_value='5' 
WHERE variable_name='mysql-log_verbosity';

LOAD MYSQL VARIABLES TO RUNTIME;
SAVE MYSQL VARIABLES TO DISK;
```

**🔍 管理操作记录**
```bash
# 在~/.mysql_history中会记录管理命令
# 可以创建专门的操作日志
cat >> ~/.bash_profile << 'EOF'
# ProxySQL管理操作记录
export MYSQL_HISTFILE="/var/log/proxysql_admin_commands.log"
alias proxysql-admin='mysql -u admin -padmin -h 127.0.0.1 -P6032 --prompt="ProxySQL Admin> "'
EOF
```

### 10.3 监控告警机制


**📊 关键指标监控**
```sql
-- 创建监控视图，便于外部监控系统调用
-- 连接数告警（连接数过高）
SELECT 
    srv_host,
    srv_port,
    ConnUsed,
    ConnFree,
    CASE 
        WHEN ConnUsed > 800 THEN 'CRITICAL'
        WHEN ConnUsed > 600 THEN 'WARNING' 
        ELSE 'OK'
    END as status
FROM stats.stats_mysql_connection_pool;

-- 慢查询告警
SELECT 
    count(*) as slow_query_count,
    CASE 
        WHEN count(*) > 100 THEN 'CRITICAL'
        WHEN count(*) > 50 THEN 'WARNING'
        ELSE 'OK' 
    END as status
FROM stats.stats_mysql_query_digest 
WHERE sum_time/count_star > 1000000;  -- 平均响应时间>1秒
```

**🚨 自动告警脚本**
```bash
#!/bin/bash
# proxysql_alert.sh

# 检查连接数异常
check_connections() {
    local high_conn=$(mysql -u admin -padmin -h 127.0.0.1 -P6032 \
        -e "SELECT COUNT(*) FROM stats.stats_mysql_connection_pool 
            WHERE ConnUsed > 800;" -s -N 2>/dev/null)
    
    if [ "$high_conn" -gt 0 ]; then
        echo "ALERT: 发现连接数过高的服务器" | mail -s "ProxySQL告警" admin@company.com
    fi
}

# 检查服务器离线
check_offline_servers() {
    local offline=$(mysql -u admin -padmin -h 127.0.0.1 -P6032 \
        -e "SELECT COUNT(*) FROM mysql_servers 
            WHERE status LIKE 'OFFLINE%';" -s -N 2>/dev/null)
    
    if [ "$offline" -gt 0 ]; then
        echo "ALERT: 发现离线的MySQL服务器" | mail -s "ProxySQL告警" admin@company.com
    fi
}

# 定期检查
check_connections
check_offline_servers
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


```
🔸 管理接口本质：ProxySQL的"控制面板"，用于配置和监控
🔸 三层配置结构：MEMORY（修改）→ RUNTIME（生效）→ DISK（持久化）
🔸 核心操作命令：SELECT查看、UPDATE修改、LOAD加载、SAVE保存
🔸 统计监控体系：stats库看性能、monitor库看健康状态
🔸 热更新机制：无需重启即可使配置生效，保证业务连续性
🔸 安全防护要点：修改默认密码、限制网络访问、分离权限
```

### 11.2 关键理解要点


**🔹 为什么需要LOAD操作**
```
配置修改流程：
• 直接修改表 → 只是改了MEMORY层，还没生效
• LOAD TO RUNTIME → 配置开始生效，但重启会丢失  
• SAVE TO DISK → 配置持久化，重启后恢复

记忆要点：
• 改了不LOAD = 白改
• LOAD了不SAVE = 重启丢失
```

**🔹 统计信息的价值**
```
stats库的作用：
• 性能分析：找出慢查询、热点查询
• 负载监控：查看服务器连接分布
• 故障诊断：分析连接失败、超时等问题

monitor库的作用：
• 健康检查：服务器连通性测试日志  
• 故障追踪：连接失败的详细错误信息
```

**🔹 热更新的安全性**
```
安全热更新原则：
1. 先备份 → 防止误操作
2. 小步修改 → 降低风险
3. 立即验证 → 发现问题及时回滚
4. 确认无误后再保存 → 避免错误持久化
```

### 11.3 实际应用价值


**🎯 日常运维场景**
- **服务器维护**：热更新服务器状态，零停机维护
- **负载调整**：动态调整权重，优化性能分布
- **故障处理**：快速隔离问题服务器，保证业务稳定
- **性能优化**：通过统计分析找出性能瓶颈
- **容量规划**：基于监控数据制定扩容计划

**🔧 自动化运维**
- **健康监控**：自动检查服务器状态和连接池
- **配置管理**：脚本化的配置部署和回滚
- **告警机制**：及时发现和通知异常情况
- **备份恢复**：定期备份配置，快速恢复能力

**核心记忆**：
- 管理接口是ProxySQL的大脑，掌控全局配置
- 三层配置理解透，热更新操作不出错
- 统计监控是眼睛，性能问题早发现
- 安全防护要做好，权限网络都重要
- 自动化脚本是帮手，日常运维更轻松