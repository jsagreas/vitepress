---
title: 35ã€æ­»é”ç›‘æ§ä¸æ—¥å¿—åˆ†æ
---
## ğŸ“š ç›®å½•


1. [æ­»é”ç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-æ­»é”ç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [ç›‘æ§æŒ‡æ ‡è®¾è®¡ä¸å®ç°](#2-ç›‘æ§æŒ‡æ ‡è®¾è®¡ä¸å®ç°)
3. [æ­»é”æ—¥å¿—åˆ†æè¯¦è§£](#3-æ­»é”æ—¥å¿—åˆ†æè¯¦è§£)
4. [SHOW ENGINE STATUSè¯¦è§£](#4-show-engine-statusè¯¦è§£)
5. [performance_schemaç›‘æ§åº”ç”¨](#5-performance_schemaç›‘æ§åº”ç”¨)
6. [å¯è§†åŒ–ç›‘æ§ä¸å‘Šè­¦](#6-å¯è§†åŒ–ç›‘æ§ä¸å‘Šè­¦)
7. [è‡ªåŠ¨åŒ–åˆ†æä¸æŠ¥å‘Šç”Ÿæˆ](#7-è‡ªåŠ¨åŒ–åˆ†æä¸æŠ¥å‘Šç”Ÿæˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ­»é”ç›‘æ§åŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯æ­»é”ç›‘æ§



**ğŸ’¡ ç®€å•ç†è§£**ï¼š
æ­»é”ç›‘æ§å°±åƒæ˜¯ç»™æ•°æ®åº“å®‰è£…äº†ä¸€ä¸ª"ä½“æ£€ä»ª"ï¼Œéšæ—¶æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å‡ºç°äº†"äº¤é€šå µå¡"çš„æƒ…å†µã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ä¸¤è¾†è½¦åœ¨çª„è·¯ç›¸é‡ï¼Œéƒ½ä¸è®©è·¯ â†’ äº¤é€šæ­»é”
æ•°æ®åº“ä¸­ä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æº â†’ æ•°æ®åº“æ­»é”

ç›‘æ§çš„ä½œç”¨ï¼š
å®æ—¶å‘ç° â†’ å¿«é€Ÿå¤„ç† â†’ é¢„é˜²å†æ¬¡å‘ç”Ÿ
```

**ğŸ”¸ æ­»é”ç›‘æ§çš„æ ¸å¿ƒä»·å€¼**ï¼š
- **åŠæ—¶å‘ç°**ï¼šç¬¬ä¸€æ—¶é—´çŸ¥é“æ­»é”å‘ç”Ÿäº†
- **é—®é¢˜å®šä½**ï¼šæ‰¾åˆ°æ˜¯å“ªäº›SQLè¯­å¥å¼•èµ·çš„
- **æ€§èƒ½åˆ†æ**ï¼šäº†è§£æ­»é”å¯¹æ•°æ®åº“æ€§èƒ½çš„å½±å“
- **é¢„é˜²æªæ–½**ï¼šé€šè¿‡å†å²æ•°æ®é¢„æµ‹å’Œé¢„é˜²

### 1.2 æ­»é”ç›‘æ§çš„å±‚æ¬¡ç»“æ„



```
MySQLæ­»é”ç›‘æ§ä½“ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åº”ç”¨å±‚ç›‘æ§               â”‚ â† ä¸šåŠ¡å½±å“åˆ†æ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ•°æ®åº“å±‚ç›‘æ§             â”‚ â† MySQLå†…éƒ¨ç›‘æ§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ç³»ç»Ÿå±‚ç›‘æ§               â”‚ â† æœåŠ¡å™¨èµ„æºç›‘æ§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é‡ç‚¹å…³æ³¨ï¼šæ•°æ®åº“å±‚ç›‘æ§ï¼ˆæœ¬æ–‡é‡ç‚¹ï¼‰
```

### 1.3 æ­»é”ç›‘æ§çš„å…³é”®æ—¶æœº



**â° å…³é”®ç›‘æ§æ—¶é—´ç‚¹**ï¼š
- **äº‹åŠ¡æ‰§è¡Œæ—¶**ï¼šå®æ—¶ç›‘æ§é”ç­‰å¾…æƒ…å†µ
- **æ­»é”å‘ç”Ÿæ—¶**ï¼šç«‹å³æ•è·è¯¦ç»†ä¿¡æ¯
- **æ­»é”è§£å†³å**ï¼šåˆ†æå½±å“å’ŒåŸå› 
- **å®šæœŸå·¡æ£€**ï¼šæŸ¥çœ‹å†å²è¶‹åŠ¿å’Œæ¨¡å¼

---

## 2. ğŸ“Š ç›‘æ§æŒ‡æ ‡è®¾è®¡ä¸å®ç°



### 2.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ä½“ç³»



**ğŸ¯ æ­»é”ç›‘æ§çš„å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **å…·ä½“æŒ‡æ ‡** | **å«ä¹‰è¯´æ˜** | **æ­£å¸¸èŒƒå›´** |
|---------|-------------|-------------|-------------|
| ğŸ”¢ **æ•°é‡æŒ‡æ ‡** | `æ­»é”æ¬¡æ•°` | å•ä½æ—¶é—´å†…æ­»é”å‘ç”Ÿæ¬¡æ•° | `<10æ¬¡/å°æ—¶` |
| â±ï¸ **æ—¶é—´æŒ‡æ ‡** | `æ­»é”æŒç»­æ—¶é—´` | ä»æ­»é”åˆ°è§£å†³çš„æ—¶é—´ | `<100ms` |
| ğŸ“ˆ **å½±å“æŒ‡æ ‡** | `å›æ»šäº‹åŠ¡æ•°` | å› æ­»é”è¢«å›æ»šçš„äº‹åŠ¡æ•°é‡ | `<5%æ€»äº‹åŠ¡` |
| ğŸ”„ **é¢‘ç‡æŒ‡æ ‡** | `æ­»é”ç‡` | æ­»é”æ¬¡æ•°/æ€»äº‹åŠ¡æ•° | `<0.1%` |

### 2.2 ç›‘æ§æŒ‡æ ‡è·å–æ–¹æ³•



**ğŸ“‹ åŸºç¡€ç›‘æ§SQL**ï¼š

```sql
-- è·å–æ­»é”åŸºæœ¬ç»Ÿè®¡
SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks';

-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    r.trx_id AS waiting_trx_id,
    r.trx_mysql_thread_id AS waiting_thread,
    r.trx_query AS waiting_query,
    b.trx_id AS blocking_trx_id,
    b.trx_mysql_thread_id AS blocking_thread,
    b.trx_query AS blocking_query
FROM information_schema.INNODB_LOCK_WAITS w
INNER JOIN information_schema.INNODB_TRX r ON r.trx_id = w.requesting_trx_id
INNER JOIN information_schema.INNODB_TRX b ON b.trx_id = w.blocking_trx_id;
```

**ğŸ”§ ç›‘æ§æŒ‡æ ‡è®¡ç®—ç¤ºä¾‹**ï¼š

```python
# Pythonç›‘æ§è„šæœ¬ç¤ºä¾‹

import mysql.connector
import time
from datetime import datetime

class DeadlockMonitor:
    def __init__(self, db_config):
        self.db_config = db_config
        self.last_deadlock_count = 0
        
    def get_deadlock_metrics(self):
        """è·å–æ­»é”ç›‘æ§æŒ‡æ ‡"""
        conn = mysql.connector.connect(**self.db_config)
        cursor = conn.cursor()
        
#        # è·å–å½“å‰æ­»é”æ€»æ•°
        cursor.execute("SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks'")
        current_deadlocks = int(cursor.fetchone()[1])
        
#        # è®¡ç®—æ–°å¢æ­»é”æ•°
        new_deadlocks = current_deadlocks - self.last_deadlock_count
        self.last_deadlock_count = current_deadlocks
        
#        # è·å–äº‹åŠ¡ç»Ÿè®¡
        cursor.execute("SHOW GLOBAL STATUS LIKE 'Com_commit'")
        commits = int(cursor.fetchone()[1])
        
#        # è®¡ç®—æ­»é”ç‡
        deadlock_rate = (new_deadlocks / commits * 100) if commits > 0 else 0
        
        return {
            'timestamp': datetime.now(),
            'total_deadlocks': current_deadlocks,
            'new_deadlocks': new_deadlocks,
            'deadlock_rate': deadlock_rate
        }
```

### 2.3 è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡



**ğŸ’ é«˜çº§ç›‘æ§æŒ‡æ ‡**ï¼š

```sql
-- æ­»é”æ¶‰åŠçš„è¡¨ç»Ÿè®¡
CREATE VIEW deadlock_table_stats AS
SELECT 
    table_schema,
    table_name,
    COUNT(*) as deadlock_count,
    AVG(lock_duration) as avg_duration
FROM deadlock_log 
GROUP BY table_schema, table_name
ORDER BY deadlock_count DESC;

-- æ­»é”æ—¶é—´æ®µåˆ†å¸ƒ
CREATE VIEW deadlock_time_distribution AS
SELECT 
    HOUR(deadlock_time) as hour_of_day,
    COUNT(*) as deadlock_count,
    AVG(affected_rows) as avg_affected_rows
FROM deadlock_log 
GROUP BY HOUR(deadlock_time)
ORDER BY deadlock_count DESC;
```

---

## 3. ğŸ“‹ æ­»é”æ—¥å¿—åˆ†æè¯¦è§£



### 3.1 æ­»é”æ—¥å¿—çš„åŸºæœ¬æ ¼å¼



**ğŸ“„ æ ‡å‡†æ­»é”æ—¥å¿—ç»“æ„**ï¼š

```
æ­»é”æ—¥å¿—ç¤ºä¾‹è§£æï¼š

========================
LATEST DETECTED DEADLOCK
========================
2024-09-10 14:30:45 0x7f8b2c001700
*** (1) TRANSACTION:
TRANSACTION 421394679004, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 12345, OS thread handle 140236124321536, query id 98765432 localhost root updating
UPDATE users SET balance = balance - 100 WHERE id = 1

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 58 page no 4 n bits 72 index PRIMARY of table test.users 
trx id 421394679004 lock_mode X locks rec but not gap waiting

*** (2) TRANSACTION:
TRANSACTION 421394679005, ACTIVE 0 sec starting index read  
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 12346, OS thread handle 140236124584704, query id 98765433 localhost root updating
UPDATE users SET balance = balance + 100 WHERE id = 2

*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 58 page no 4 n bits 72 index PRIMARY of table test.users 
trx id 421394679005 lock_mode X locks rec but not gap

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 58 page no 4 n bits 72 index PRIMARY of table test.users 
trx id 421394679005 lock_mode X locks rec but not gap waiting

*** WE ROLL BACK TRANSACTION (1)
```

### 3.2 æ­»é”æ—¥å¿—å­—æ®µè¯¦è§£



**ğŸ” å…³é”®å­—æ®µå«ä¹‰è¯´æ˜**ï¼š

```
æ—¥å¿—å­—æ®µè§£æï¼š

ğŸ”¸ TRANSACTION IDï¼šäº‹åŠ¡å”¯ä¸€æ ‡è¯†å·
  - ç¤ºä¾‹ï¼š421394679004
  - ä½œç”¨ï¼šåŒºåˆ†ä¸åŒäº‹åŠ¡ï¼Œè¿½è¸ªäº‹åŠ¡ç”Ÿå‘½å‘¨æœŸ

ğŸ”¸ ACTIVEæ—¶é—´ï¼šäº‹åŠ¡æ´»è·ƒæ—¶é—´
  - ç¤ºä¾‹ï¼šACTIVE 0 sec
  - å«ä¹‰ï¼šäº‹åŠ¡ä»å¼€å§‹åˆ°æ­»é”å‘ç”Ÿçš„æ—¶é—´

ğŸ”¸ MySQL thread idï¼šæ•°æ®åº“è¿æ¥ID  
  - ç¤ºä¾‹ï¼š12345
  - ä½œç”¨ï¼šå…³è”åˆ°å…·ä½“çš„æ•°æ®åº“è¿æ¥

ğŸ”¸ lock_modeï¼šé”çš„ç±»å‹
  - Xï¼šæ’ä»–é”ï¼ˆå†™é”ï¼‰
  - Sï¼šå…±äº«é”ï¼ˆè¯»é”ï¼‰
  - IXï¼šæ„å‘æ’ä»–é”
  - ISï¼šæ„å‘å…±äº«é”

ğŸ”¸ locks rec but not gapï¼šé”çš„èŒƒå›´
  - rec but not gapï¼šåªé”è®°å½•ï¼Œä¸é”é—´éš™
  - gapï¼šåªé”é—´éš™
  - rec and gapï¼šé”è®°å½•å’Œé—´éš™
```

### 3.3 æ­»é”æ—¥å¿—è§£è¯»æŠ€å·§



**ğŸ’¡ æ—¥å¿—åˆ†ææ­¥éª¤**ï¼š

```
åˆ†ææµç¨‹ï¼š

ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«å‚ä¸æ­»é”çš„äº‹åŠ¡
â”œâ”€â”€ æ‰¾åˆ° *** (1) TRANSACTION å’Œ *** (2) TRANSACTION
â””â”€â”€ è®°å½•äº‹åŠ¡IDå’Œçº¿ç¨‹ID

ç¬¬äºŒæ­¥ï¼šåˆ†æé”ç­‰å¾…å…³ç³»  
â”œâ”€â”€ æŸ¥çœ‹ WAITING FOR THIS LOCK
â”œâ”€â”€ æŸ¥çœ‹ HOLDS THE LOCK(S)
â””â”€â”€ ç†è§£è°åœ¨ç­‰å¾…è°çš„é”

ç¬¬ä¸‰æ­¥ï¼šå®šä½é—®é¢˜SQL
â”œâ”€â”€ æ‰¾åˆ°å…·ä½“çš„UPDATE/DELETE/INSERTè¯­å¥
â”œâ”€â”€ åˆ†æWHEREæ¡ä»¶å’Œæ¶‰åŠçš„è¡¨
â””â”€â”€ ç†è§£ä¸šåŠ¡é€»è¾‘

ç¬¬å››æ­¥ï¼šç¡®è®¤å›æ»šç­–ç•¥
â”œâ”€â”€ æŸ¥çœ‹ WE ROLL BACK TRANSACTION
â””â”€â”€ ç†è§£MySQLé€‰æ‹©å›æ»šå“ªä¸ªäº‹åŠ¡çš„åŸå› 
```

**ğŸ”§ æ—¥å¿—è§£æå·¥å…·è„šæœ¬**ï¼š

```python
import re
from datetime import datetime

class DeadlockLogParser:
    def parse_deadlock_log(self, log_content):
        """è§£ææ­»é”æ—¥å¿—"""
        deadlock_info = {
            'timestamp': None,
            'transactions': [],
            'rollback_transaction': None
        }
        
#        # æå–æ—¶é—´æˆ³
        time_pattern = r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})'
        time_match = re.search(time_pattern, log_content)
        if time_match:
            deadlock_info['timestamp'] = time_match.group(1)
        
#        # æå–äº‹åŠ¡ä¿¡æ¯
        trx_pattern = r'\*\*\* \((\d+)\) TRANSACTION:\s*TRANSACTION (\d+)'
        trx_matches = re.findall(trx_pattern, log_content)
        
        for trx_num, trx_id in trx_matches:
            transaction = {
                'number': int(trx_num),
                'id': trx_id,
                'query': self.extract_query(log_content, trx_num),
                'thread_id': self.extract_thread_id(log_content, trx_num)
            }
            deadlock_info['transactions'].append(transaction)
        
#        # æå–å›æ»šä¿¡æ¯
        rollback_pattern = r'WE ROLL BACK TRANSACTION \((\d+)\)'
        rollback_match = re.search(rollback_pattern, log_content)
        if rollback_match:
            deadlock_info['rollback_transaction'] = int(rollback_match.group(1))
        
        return deadlock_info
    
    def extract_query(self, log_content, trx_num):
        """æå–äº‹åŠ¡çš„SQLè¯­å¥"""
        pattern = f'\\*\\*\\* \\({trx_num}\\) TRANSACTION:.*?query id \\d+ \\w+ \\w+ \\w+\\s+(.+?)\\s*\\*\\*\\*'
        match = re.search(pattern, log_content, re.DOTALL)
        return match.group(1).strip() if match else None
```

---

## 4. ğŸ” SHOW ENGINE STATUSè¯¦è§£



### 4.1 SHOW ENGINE INNODB STATUSåŸºç¡€



**ğŸ“Š åŸºæœ¬ç”¨æ³•**ï¼š

```sql
-- è·å–InnoDBå¼•æ“çŠ¶æ€ä¿¡æ¯
SHOW ENGINE INNODB STATUS;

-- è¿™ä¸ªå‘½ä»¤ä¼šè¿”å›å¤§é‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
-- âœ… æ­»é”ä¿¡æ¯ï¼ˆLATEST DETECTED DEADLOCKï¼‰
-- âœ… äº‹åŠ¡ä¿¡æ¯ï¼ˆTRANSACTIONSï¼‰  
-- âœ… é”ä¿¡æ¯ï¼ˆLOCK WAITSï¼‰
-- âœ… ç¼“å†²æ± çŠ¶æ€
-- âœ… IOç»Ÿè®¡ä¿¡æ¯
```

**ğŸ¯ æ­»é”ç›¸å…³éƒ¨åˆ†é‡ç‚¹å…³æ³¨**ï¼š

```
SHOW ENGINE INNODB STATUS è¾“å‡ºç»“æ„ï¼š

=====================================
2024-09-10 14:30:45 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 60 seconds
-----------------
BACKGROUND THREAD
-----------------
... (å…¶ä»–ä¿¡æ¯)

------------------------
LATEST DETECTED DEADLOCK    â† é‡ç‚¹å…³æ³¨è¿™éƒ¨åˆ†ï¼
------------------------
2024-09-10 14:30:44
*** (1) TRANSACTION:
... (è¯¦ç»†æ­»é”ä¿¡æ¯)

------------
TRANSACTIONS    â† å½“å‰æ´»è·ƒäº‹åŠ¡ä¿¡æ¯
------------
Trx id counter 421394679010
Purge done for trx's n:o < 421394679005 undo n:o < 0
History list length 25
LIST OF TRANSACTIONS FOR EACH SESSION:
```

### 4.2 æ­»é”ä¿¡æ¯æå–ä¸åˆ†æ



**ğŸ”§ è‡ªåŠ¨åŒ–æå–æ­»é”ä¿¡æ¯**ï¼š

```python
class InnoDBStatusAnalyzer:
    def extract_deadlock_info(self, db_connection):
        """ä»SHOW ENGINE INNODB STATUSä¸­æå–æ­»é”ä¿¡æ¯"""
        cursor = db_connection.cursor()
        cursor.execute("SHOW ENGINE INNODB STATUS")
        result = cursor.fetchone()
        
        if result and len(result) > 2:
            status_info = result[2]  # Statusä¿¡æ¯åœ¨ç¬¬3åˆ—
            
#            # æŸ¥æ‰¾æœ€æ–°æ­»é”ä¿¡æ¯
            deadlock_start = status_info.find("LATEST DETECTED DEADLOCK")
            if deadlock_start == -1:
                return None
                
#            # æ‰¾åˆ°æ­»é”ä¿¡æ¯ç»“æŸä½ç½®
            deadlock_end = status_info.find("------------", deadlock_start + 1)
            if deadlock_end == -1:
                deadlock_section = status_info[deadlock_start:]
            else:
                deadlock_section = status_info[deadlock_start:deadlock_end]
            
            return self.parse_deadlock_section(deadlock_section)
        
        return None
    
    def parse_deadlock_section(self, deadlock_text):
        """è§£ææ­»é”ä¿¡æ¯éƒ¨åˆ†"""
        info = {
            'timestamp': None,
            'transaction_1': {},
            'transaction_2': {},
            'rollback_info': None
        }
        
#        # æå–æ—¶é—´æˆ³
        lines = deadlock_text.split('\n')
        for line in lines:
            if re.match(r'\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}', line.strip()):
                info['timestamp'] = line.strip()
                break
        
#        # æå–äº‹åŠ¡ä¿¡æ¯
        info['transaction_1'] = self.extract_transaction_info(deadlock_text, 1)
        info['transaction_2'] = self.extract_transaction_info(deadlock_text, 2)
        
#        # æå–å›æ»šä¿¡æ¯
        rollback_match = re.search(r'WE ROLL BACK TRANSACTION \((\d+)\)', deadlock_text)
        if rollback_match:
            info['rollback_info'] = int(rollback_match.group(1))
        
        return info
```

### 4.3 çŠ¶æ€ä¿¡æ¯çš„å®šæœŸæ”¶é›†



**â° å®šæœŸç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash

# MySQLæ­»é”ç›‘æ§è„šæœ¬


# é…ç½®ä¿¡æ¯

DB_HOST="localhost"
DB_USER="monitor_user"  
DB_PASS="monitor_pass"
DB_NAME="mysql"
LOG_FILE="/var/log/mysql_deadlock_monitor.log"

# è·å–å½“å‰æ­»é”è®¡æ•°

get_deadlock_count() {
    mysql -h$DB_HOST -u$DB_USER -p$DB_PASS -e \
    "SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks';" | \
    awk 'NR==2 {print $2}'
}

# æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ­»é”

check_deadlock() {
    current_count=$(get_deadlock_count)
    
    if [ -f "/tmp/last_deadlock_count" ]; then
        last_count=$(cat /tmp/last_deadlock_count)
    else
        last_count=0
    fi
    
    if [ "$current_count" -gt "$last_count" ]; then
        echo "$(date): æ£€æµ‹åˆ°æ–°æ­»é”! å½“å‰æ€»æ•°: $current_count" >> $LOG_FILE
        
#        # è·å–è¯¦ç»†æ­»é”ä¿¡æ¯
        mysql -h$DB_HOST -u$DB_USER -p$DB_PASS -e \
        "SHOW ENGINE INNODB STATUS\G" | \
        sed -n '/LATEST DETECTED DEADLOCK/,/^$/p' >> $LOG_FILE
        
        echo "----------------------------------------" >> $LOG_FILE
    fi
    
    echo $current_count > /tmp/last_deadlock_count
}

# æ‰§è¡Œæ£€æŸ¥

check_deadlock
```

---

## 5. ğŸ“ˆ performance_schemaç›‘æ§åº”ç”¨



### 5.1 performance_schemaåŸºç¡€è®¾ç½®



**âš™ï¸ å¯ç”¨performance_schemaç›‘æ§**ï¼š

```sql
-- æ£€æŸ¥performance_schemaæ˜¯å¦å¯ç”¨
SHOW VARIABLES LIKE 'performance_schema';

-- å¯ç”¨ç›¸å…³çš„ç›‘æ§å™¨ï¼ˆéœ€è¦é‡å¯MySQLï¼‰
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES' 
WHERE NAME LIKE 'wait/lock%';

-- å¯ç”¨ç›¸å…³çš„æ¶ˆè´¹è€…
UPDATE performance_schema.setup_consumers 
SET ENABLED = 'YES' 
WHERE NAME LIKE '%events_waits%';
```

**ğŸ”§ é”ç­‰å¾…ç›‘æ§é…ç½®**ï¼š

```sql
-- å¯ç”¨é”ç­‰å¾…äº‹ä»¶æ”¶é›†
UPDATE performance_schema.setup_instruments 
SET ENABLED = 'YES', TIMED = 'YES'
WHERE NAME IN (
    'wait/lock/table/sql/handler',
    'wait/lock/metadata/sql/mdl'
);

-- æŸ¥çœ‹å½“å‰é…ç½®çŠ¶æ€
SELECT NAME, ENABLED, TIMED 
FROM performance_schema.setup_instruments 
WHERE NAME LIKE 'wait/lock%' AND ENABLED = 'YES';
```

### 5.2 é”ç­‰å¾…äº‹ä»¶åˆ†æ



**ğŸ“Š é”ç­‰å¾…è¯¦ç»†åˆ†æ**ï¼š

```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SELECT 
    ewc.EVENT_NAME,
    ewc.OBJECT_SCHEMA,
    ewc.OBJECT_NAME,
    ewc.LOCK_TYPE,
    ewc.LOCK_DURATION,
    ewc.LOCK_STATUS,
    p.HOST,
    p.USER,
    p.DB,
    pi.INFO as CURRENT_STATEMENT
FROM performance_schema.events_waits_current ewc
LEFT JOIN performance_schema.threads t ON ewc.THREAD_ID = t.THREAD_ID
LEFT JOIN information_schema.PROCESSLIST p ON t.PROCESSLIST_ID = p.ID  
LEFT JOIN information_schema.PROCESSLIST pi ON t.PROCESSLIST_ID = pi.ID
WHERE ewc.EVENT_NAME LIKE 'wait/lock%'
AND ewc.LOCK_STATUS = 'WAITING';

-- ç»Ÿè®¡é”ç­‰å¾…æ—¶é—´æœ€é•¿çš„è¯­å¥
SELECT 
    DIGEST_TEXT,
    COUNT_STAR as EXEC_COUNT,
    SUM_TIMER_WAIT/1000000000 as TOTAL_WAIT_TIME_SEC,
    AVG_TIMER_WAIT/1000000000 as AVG_WAIT_TIME_SEC,
    MAX_TIMER_WAIT/1000000000 as MAX_WAIT_TIME_SEC
FROM performance_schema.events_statements_summary_by_digest
WHERE SUM_LOCK_TIME > 0
ORDER BY SUM_TIMER_WAIT DESC
LIMIT 10;
```

### 5.3 åŸºäºperformance_schemaçš„ç›‘æ§è§†å›¾



**ğŸ“‹ åˆ›å»ºç›‘æ§è§†å›¾**ï¼š

```sql
-- é”ç­‰å¾…æ±‡æ€»è§†å›¾
CREATE VIEW lock_waits_summary AS
SELECT 
    OBJECT_SCHEMA as db_name,
    OBJECT_NAME as table_name,
    LOCK_TYPE,
    COUNT(*) as wait_count,
    AVG(TIMER_WAIT)/1000000 as avg_wait_ms,
    MAX(TIMER_WAIT)/1000000 as max_wait_ms,
    SUM(TIMER_WAIT)/1000000 as total_wait_ms
FROM performance_schema.events_waits_history_long
WHERE EVENT_NAME LIKE 'wait/lock%'
AND TIMER_END IS NOT NULL
GROUP BY OBJECT_SCHEMA, OBJECT_NAME, LOCK_TYPE
ORDER BY total_wait_ms DESC;

-- å½“å‰æ´»è·ƒè¿æ¥çš„é”æƒ…å†µ
CREATE VIEW current_lock_waits AS  
SELECT 
    t.PROCESSLIST_ID as connection_id,
    t.PROCESSLIST_USER as user,
    t.PROCESSLIST_HOST as host,
    ewc.OBJECT_SCHEMA,
    ewc.OBJECT_NAME,
    ewc.LOCK_TYPE,
    ewc.LOCK_DURATION,
    (ewc.TIMER_WAIT)/1000000 as wait_time_ms,
    p.INFO as current_sql
FROM performance_schema.events_waits_current ewc
JOIN performance_schema.threads t ON ewc.THREAD_ID = t.THREAD_ID
LEFT JOIN information_schema.PROCESSLIST p ON t.PROCESSLIST_ID = p.ID
WHERE ewc.EVENT_NAME LIKE 'wait/lock%'
AND ewc.TIMER_END IS NULL;
```

**ğŸ¯ å®æ—¶ç›‘æ§æŸ¥è¯¢**ï¼š

```sql
-- å®æ—¶æ­»é”é£é™©ç›‘æ§
SELECT 
    COUNT(DISTINCT ewc.THREAD_ID) as waiting_connections,
    COUNT(*) as total_waits,
    AVG(ewc.TIMER_WAIT)/1000000 as avg_wait_ms,
    MAX(ewc.TIMER_WAIT)/1000000 as max_wait_ms
FROM performance_schema.events_waits_current ewc
WHERE ewc.EVENT_NAME LIKE 'wait/lock%'
AND ewc.TIMER_END IS NULL;

-- æ½œåœ¨æ­»é”æ£€æµ‹ï¼ˆç›¸äº’ç­‰å¾…ï¼‰
WITH lock_waits AS (
    SELECT 
        t.PROCESSLIST_ID as waiting_thread,
        ewc.OBJECT_SCHEMA,
        ewc.OBJECT_NAME,
        'WAITING' as status
    FROM performance_schema.events_waits_current ewc
    JOIN performance_schema.threads t ON ewc.THREAD_ID = t.THREAD_ID  
    WHERE ewc.EVENT_NAME LIKE 'wait/lock%'
    AND ewc.TIMER_END IS NULL
)
SELECT 
    lw1.waiting_thread as thread1,
    lw2.waiting_thread as thread2,
    lw1.OBJECT_SCHEMA,
    lw1.OBJECT_NAME
FROM lock_waits lw1
JOIN lock_waits lw2 ON lw1.OBJECT_SCHEMA = lw2.OBJECT_SCHEMA
    AND lw1.OBJECT_NAME = lw2.OBJECT_NAME
    AND lw1.waiting_thread != lw2.waiting_thread;
```

---

## 6. ğŸ“Š å¯è§†åŒ–ç›‘æ§ä¸å‘Šè­¦



### 6.1 ç›‘æ§ä»ªè¡¨æ¿è®¾è®¡



**ğŸ“ˆ å…³é”®ç›‘æ§å›¾è¡¨**ï¼š

```
æ­»é”ç›‘æ§ä»ªè¡¨æ¿å¸ƒå±€ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ­»é”è¶‹åŠ¿å›¾     â”‚   æ­»é”ç‡ç»Ÿè®¡     â”‚
â”‚                â”‚                â”‚
â”‚  ğŸ“ˆ 24å°æ—¶è¶‹åŠ¿   â”‚  âš¡ å®æ—¶æ­»é”ç‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   TOPæ­»é”è¡¨     â”‚   æ­»é”æ—¶é—´åˆ†å¸ƒ   â”‚
â”‚                â”‚                â”‚
â”‚  ğŸ“Š çƒ­ç‚¹è¡¨ç»Ÿè®¡   â”‚  â° æ—¶æ®µåˆ†æ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ ç›‘æ§æŒ‡æ ‡é‡‡é›†è„šæœ¬**ï¼š

```python
import json
import time
from datetime import datetime, timedelta

class DeadlockDashboard:
    def __init__(self, db_config):
        self.db_config = db_config
        
    def collect_metrics(self):
        """æ”¶é›†ç›‘æ§æŒ‡æ ‡"""
        conn = mysql.connector.connect(**self.db_config)
        cursor = conn.cursor()
        
        metrics = {
            'timestamp': datetime.now().isoformat(),
            'deadlock_count': self.get_deadlock_count(cursor),
            'deadlock_rate': self.calculate_deadlock_rate(cursor),
            'top_deadlock_tables': self.get_top_deadlock_tables(cursor),
            'hourly_distribution': self.get_hourly_distribution(cursor)
        }
        
        conn.close()
        return metrics
    
    def get_deadlock_count(self, cursor):
        """è·å–æ­»é”æ€»æ•°"""
        cursor.execute("SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks'")
        return int(cursor.fetchone()[1])
    
    def calculate_deadlock_rate(self, cursor):
        """è®¡ç®—æ­»é”ç‡"""
#        # è·å–æœ€è¿‘1å°æ—¶çš„äº‹åŠ¡æ•°å’Œæ­»é”æ•°
        cursor.execute("""
            SELECT 
                (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
                 WHERE VARIABLE_NAME = 'Innodb_deadlocks') as deadlocks,
                (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
                 WHERE VARIABLE_NAME = 'Com_commit') as commits
        """)
        
        result = cursor.fetchone()
        deadlocks, commits = result
        
        return (float(deadlocks) / float(commits) * 100) if commits > 0 else 0
    
    def generate_alert(self, metrics):
        """ç”Ÿæˆå‘Šè­¦"""
        alerts = []
        
#        # æ­»é”æ•°é‡å‘Šè­¦
        if metrics['deadlock_count'] > 100:  # é˜ˆå€¼å¯é…ç½®
            alerts.append({
                'level': 'WARNING',
                'message': f"æ­»é”æ¬¡æ•°è¿‡å¤š: {metrics['deadlock_count']}",
                'time': metrics['timestamp']
            })
        
#        # æ­»é”ç‡å‘Šè­¦
        if metrics['deadlock_rate'] > 0.5:  # 0.5%
            alerts.append({
                'level': 'CRITICAL', 
                'message': f"æ­»é”ç‡è¿‡é«˜: {metrics['deadlock_rate']:.2f}%",
                'time': metrics['timestamp']
            })
        
        return alerts
```

### 6.2 å‘Šè­¦æœºåˆ¶è®¾è®¡



**âš ï¸ å¤šå±‚æ¬¡å‘Šè­¦ç­–ç•¥**ï¼š

```
å‘Šè­¦çº§åˆ«è®¾è®¡ï¼š

ğŸŸ¢ INFOï¼ˆä¿¡æ¯ï¼‰ï¼š
â”œâ”€â”€ æ­»é”ç‡ < 0.1%
â”œâ”€â”€ å•å°æ—¶æ­»é” < 10æ¬¡  
â””â”€â”€ ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

ğŸŸ¡ WARNINGï¼ˆè­¦å‘Šï¼‰ï¼š
â”œâ”€â”€ æ­»é”ç‡ 0.1% - 0.5%
â”œâ”€â”€ å•å°æ—¶æ­»é” 10-50æ¬¡
â””â”€â”€ éœ€è¦å…³æ³¨ï¼Œæš‚ä¸å½±å“ä¸šåŠ¡

ğŸ”´ CRITICALï¼ˆä¸¥é‡ï¼‰ï¼š
â”œâ”€â”€ æ­»é”ç‡ > 0.5%
â”œâ”€â”€ å•å°æ—¶æ­»é” > 50æ¬¡
â””â”€â”€ ä¸¥é‡å½±å“ä¸šåŠ¡ï¼Œéœ€ç«‹å³å¤„ç†

ğŸš¨ EMERGENCYï¼ˆç´§æ€¥ï¼‰ï¼š
â”œâ”€â”€ è¿ç»­å¤§é‡æ­»é”
â”œâ”€â”€ æ•°æ®åº“å“åº”å¼‚å¸¸
â””â”€â”€ ä¸šåŠ¡å®Œå…¨æ— æ³•ä½¿ç”¨
```

**ğŸ“± å‘Šè­¦é€šçŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash

# æ­»é”å‘Šè­¦é€šçŸ¥è„šæœ¬


send_alert() {
    local level=$1
    local message=$2
    local timestamp=$3
    
#    # é‚®ä»¶å‘Šè­¦
    echo "æ—¶é—´: $timestamp" > /tmp/alert_mail.txt
    echo "çº§åˆ«: $level" >> /tmp/alert_mail.txt  
    echo "ä¿¡æ¯: $message" >> /tmp/alert_mail.txt
    
    mail -s "MySQLæ­»é”å‘Šè­¦-$level" admin@company.com < /tmp/alert_mail.txt
    
#    # ä¼ä¸šå¾®ä¿¡/é’‰é’‰å‘Šè­¦ï¼ˆç¤ºä¾‹ï¼‰
    if [ "$level" = "CRITICAL" ] || [ "$level" = "EMERGENCY" ]; then
        curl -X POST "https://webhook.dingtalk.com/robot/send?access_token=YOUR_TOKEN" \
        -H "Content-Type: application/json" \
        -d '{
            "msgtype": "text",
            "text": {
                "content": "ğŸš¨MySQLæ­»é”å‘Šè­¦\nçº§åˆ«: '$level'\nä¿¡æ¯: '$message'\næ—¶é—´: '$timestamp'"
            }
        }'
    fi
}

# æ£€æŸ¥æ­»é”çŠ¶æ€å¹¶å‘é€å‘Šè­¦

check_and_alert() {
    deadlock_count=$(mysql -u monitor -ppassword -e \
        "SHOW GLOBAL STATUS LIKE 'Innodb_deadlocks';" | awk 'NR==2 {print $2}')
    
    current_time=$(date '+%Y-%m-%d %H:%M:%S')
    
#    # è¯»å–ä¸Šæ¬¡æ£€æŸ¥çš„æ­»é”æ•°
    last_count_file="/tmp/last_deadlock_check"
    if [ -f "$last_count_file" ]; then
        last_count=$(cat $last_count_file)
    else
        last_count=0
    fi
    
#    # è®¡ç®—æ–°å¢æ­»é”
    new_deadlocks=$((deadlock_count - last_count))
    
#    # æ ¹æ®æ–°å¢æ­»é”æ•°é‡åˆ¤æ–­å‘Šè­¦çº§åˆ«
    if [ $new_deadlocks -gt 20 ]; then
        send_alert "CRITICAL" "15åˆ†é’Ÿå†…æ–°å¢æ­»é”$new_deadlocksæ¬¡" "$current_time"
    elif [ $new_deadlocks -gt 10 ]; then
        send_alert "WARNING" "15åˆ†é’Ÿå†…æ–°å¢æ­»é”$new_deadlocksæ¬¡" "$current_time"
    fi
    
#    # ä¿å­˜å½“å‰æ­»é”æ•°
    echo $deadlock_count > $last_count_file
}

check_and_alert
```

### 6.3 å¯è§†åŒ–å›¾è¡¨å®ç°



**ğŸ“Š Grafanaç›‘æ§é…ç½®ç¤ºä¾‹**ï¼š

```json
{
  "dashboard": {
    "title": "MySQLæ­»é”ç›‘æ§",
    "panels": [
      {
        "title": "æ­»é”è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "mysql_global_status_innodb_deadlocks",
            "legendFormat": "æ­»é”æ€»æ•°"
          }
        ],
        "yAxes": [
          {
            "label": "æ­»é”æ¬¡æ•°",
            "min": 0
          }
        ],
        "alert": {
          "conditions": [
            {
              "query": {
                "params": ["A", "5m", "now"]
              },
              "reducer": {
                "type": "diff",
                "params": []
              },
              "evaluator": {
                "params": [10],
                "type": "gt"
              }
            }
          ],
          "executionErrorState": "alerting",
          "for": "0m",
          "frequency": "10s",
          "handler": 1,
          "name": "æ­»é”å¢é•¿å‘Šè­¦",
          "noDataState": "no_data",
          "notifications": []
        }
      },
      {
        "title": "æ­»é”çƒ­ç‚¹è¡¨",
        "type": "table",
        "targets": [
          {
            "format": "table",
            "rawSql": "SELECT table_name, deadlock_count FROM deadlock_table_stats ORDER BY deadlock_count DESC LIMIT 10"
          }
        ]
      }
    ]
  }
}
```

---

## 7. ğŸ¤– è‡ªåŠ¨åŒ–åˆ†æä¸æŠ¥å‘Šç”Ÿæˆ



### 7.1 è‡ªåŠ¨åŒ–æ—¥å¿—åˆ†æ



**ğŸ”§ æ™ºèƒ½æ—¥å¿—è§£æç³»ç»Ÿ**ï¼š

```python
import re
import pandas as pd
from collections import defaultdict, Counter

class DeadlockAnalyzer:
    def __init__(self):
        self.deadlock_patterns = {
            'transaction_pattern': r'\*\*\* \((\d+)\) TRANSACTION:.*?TRANSACTION (\d+)',
            'query_pattern': r'MySQL thread id (\d+).*?\n(.+?)(?=\*\*\*|\n\*)',
            'table_pattern': r'index (\w+) of table (\w+)\.(\w+)',
            'lock_pattern': r'lock_mode (\w+)'
        }
    
    def analyze_deadlock_trends(self, log_files):
        """åˆ†ææ­»é”è¶‹åŠ¿"""
        analysis_result = {
            'total_deadlocks': 0,
            'time_distribution': defaultdict(int),
            'table_hotspots': Counter(),
            'query_patterns': Counter(),
            'lock_types': Counter()
        }
        
        for log_file in log_files:
            with open(log_file, 'r') as f:
                content = f.read()
                deadlocks = self.extract_deadlocks(content)
                
                for deadlock in deadlocks:
                    analysis_result['total_deadlocks'] += 1
                    
#                    # æ—¶é—´åˆ†å¸ƒç»Ÿè®¡
                    if deadlock.get('timestamp'):
                        hour = deadlock['timestamp'].hour
                        analysis_result['time_distribution'][hour] += 1
                    
#                    # è¡¨çƒ­ç‚¹ç»Ÿè®¡
                    for table in deadlock.get('tables', []):
                        analysis_result['table_hotspots'][table] += 1
                    
#                    # æŸ¥è¯¢æ¨¡å¼ç»Ÿè®¡
                    for query in deadlock.get('queries', []):
                        pattern = self.extract_query_pattern(query)
                        analysis_result['query_patterns'][pattern] += 1
        
        return analysis_result
    
    def extract_deadlocks(self, log_content):
        """ä»æ—¥å¿—ä¸­æå–æ­»é”ä¿¡æ¯"""
        deadlocks = []
        
#        # æŸ¥æ‰¾æ‰€æœ‰æ­»é”å—
        deadlock_blocks = re.findall(
            r'LATEST DETECTED DEADLOCK.*?(?=LATEST DETECTED DEADLOCK|\Z)', 
            log_content, 
            re.DOTALL
        )
        
        for block in deadlock_blocks:
            deadlock_info = self.parse_deadlock_block(block)
            if deadlock_info:
                deadlocks.append(deadlock_info)
        
        return deadlocks
    
    def generate_analysis_report(self, analysis_result):
        """ç”Ÿæˆåˆ†ææŠ¥å‘Š"""
        report = f"""
# MySQLæ­»é”åˆ†ææŠ¥å‘Š


# ğŸ“Š æ€»ä½“ç»Ÿè®¡


- **æ­»é”æ€»æ•°**: {analysis_result['total_deadlocks']}
- **åˆ†ææ—¶é—´æ®µ**: {self.get_analysis_period()}

# ğŸ• æ—¶é—´åˆ†å¸ƒåˆ†æ


"""
#        # æ—¶é—´åˆ†å¸ƒ
        for hour in sorted(analysis_result['time_distribution'].keys()):
            count = analysis_result['time_distribution'][hour]
            percentage = (count / analysis_result['total_deadlocks']) * 100
            report += f"- **{hour:02d}:00-{hour:02d}:59**: {count}æ¬¡ ({percentage:.1f}%)\n"
        
        report += f"""
# ğŸ¯ çƒ­ç‚¹è¡¨åˆ†æ


"""
#        # çƒ­ç‚¹è¡¨
        for table, count in analysis_result['table_hotspots'].most_common(10):
            percentage = (count / analysis_result['total_deadlocks']) * 100
            report += f"- **{table}**: {count}æ¬¡ ({percentage:.1f}%)\n"
        
        report += f"""
# ğŸ” æŸ¥è¯¢æ¨¡å¼åˆ†æ


"""
#        # æŸ¥è¯¢æ¨¡å¼
        for pattern, count in analysis_result['query_patterns'].most_common(5):
            percentage = (count / analysis_result['total_deadlocks']) * 100
            report += f"- **{pattern}**: {count}æ¬¡ ({percentage:.1f}%)\n"
        
        return report
```

### 7.2 å®šæœŸæŠ¥å‘Šç”Ÿæˆ



**ğŸ“… è‡ªåŠ¨åŒ–æŠ¥å‘Šç”Ÿæˆç³»ç»Ÿ**ï¼š

```python
from datetime import datetime, timedelta
import schedule
import time

class DeadlockReportGenerator:
    def __init__(self, db_config, email_config):
        self.db_config = db_config
        self.email_config = email_config
        self.analyzer = DeadlockAnalyzer()
    
    def generate_daily_report(self):
        """ç”Ÿæˆæ—¥æŠ¥"""
        yesterday = datetime.now() - timedelta(days=1)
        report_date = yesterday.strftime('%Y-%m-%d')
        
#        # æ”¶é›†æ•°æ®
        metrics = self.collect_daily_metrics(yesterday)
        
#        # ç”ŸæˆæŠ¥å‘Š
        report_content = f"""
# MySQLæ­»é”ç›‘æ§æ—¥æŠ¥ - {report_date}


# ğŸ“ˆ å…³é”®æŒ‡æ ‡


- **æ­»é”æ€»æ•°**: {metrics['total_deadlocks']}
- **æ­»é”ç‡**: {metrics['deadlock_rate']:.3f}%
- **å¹³å‡å“åº”æ—¶é—´**: {metrics['avg_response_time']:.2f}ms
- **å—å½±å“äº‹åŠ¡**: {metrics['affected_transactions']}

# ğŸ“Š è¯¦ç»†åˆ†æ


{self.generate_detailed_analysis(metrics)}

# ğŸ¯ ä¼˜åŒ–å»ºè®®


{self.generate_recommendations(metrics)}

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
        
#        # å‘é€æŠ¥å‘Š
        self.send_report(report_content, f"MySQLæ­»é”ç›‘æ§æ—¥æŠ¥-{report_date}")
        
#        # ä¿å­˜åˆ°æ–‡ä»¶
        report_file = f"/var/log/mysql_deadlock_report_{report_date}.md"
        with open(report_file, 'w') as f:
            f.write(report_content)
    
    def generate_weekly_report(self):
        """ç”Ÿæˆå‘¨æŠ¥"""
        end_date = datetime.now()
        start_date = end_date - timedelta(days=7)
        
#        # æ”¶é›†ä¸€å‘¨çš„æ•°æ®
        weekly_metrics = self.collect_weekly_metrics(start_date, end_date)
        
        report_content = f"""
# MySQLæ­»é”ç›‘æ§å‘¨æŠ¥


# ğŸ“… æŠ¥å‘Šå‘¨æœŸ


{start_date.strftime('%Y-%m-%d')} è‡³ {end_date.strftime('%Y-%m-%d')}

# ğŸ“Š å‘¨åº¦æ¦‚å†µ


- **å‘¨æ­»é”æ€»æ•°**: {weekly_metrics['total_deadlocks']}
- **æ—¥å‡æ­»é”**: {weekly_metrics['daily_avg']:.1f}æ¬¡
- **æ­»é”å¢é•¿ç‡**: {weekly_metrics['growth_rate']:.1f}%
- **æœ€é«˜å³°æ—¥æœŸ**: {weekly_metrics['peak_day']}

# ğŸ“ˆ è¶‹åŠ¿åˆ†æ


{self.analyze_weekly_trends(weekly_metrics)}

# ğŸ” æ·±åº¦åˆ†æ


{self.generate_deep_analysis(weekly_metrics)}
"""
        
        self.send_report(report_content, f"MySQLæ­»é”ç›‘æ§å‘¨æŠ¥")
    
    def schedule_reports(self):
        """è°ƒåº¦æŠ¥å‘Šç”Ÿæˆ"""
#        # æ¯å¤©æ—©ä¸Š8ç‚¹ç”Ÿæˆæ—¥æŠ¥
        schedule.every().day.at("08:00").do(self.generate_daily_report)
        
#        # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹ç”Ÿæˆå‘¨æŠ¥  
        schedule.every().monday.at("09:00").do(self.generate_weekly_report)
        
#        # è¿è¡Œè°ƒåº¦
        while True:
            schedule.run_pending()
            time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

### 7.3 æ™ºèƒ½ä¼˜åŒ–å»ºè®®



**ğŸ’¡ åŸºäºåˆ†æçš„ä¼˜åŒ–å»ºè®®ç”Ÿæˆ**ï¼š

```python
class DeadlockOptimizationAdvisor:
    def __init__(self):
        self.optimization_rules = {
            'high_frequency_table': self.suggest_index_optimization,
            'long_transaction': self.suggest_transaction_optimization,
            'hot_time_period': self.suggest_scheduling_optimization,
            'query_pattern': self.suggest_query_optimization
        }
    
    def analyze_and_suggest(self, deadlock_data):
        """åˆ†ææ­»é”æ•°æ®å¹¶æä¾›ä¼˜åŒ–å»ºè®®"""
        suggestions = []
        
#        # åˆ†æçƒ­ç‚¹è¡¨
        hot_tables = self.identify_hot_tables(deadlock_data)
        if hot_tables:
            suggestions.extend(self.suggest_index_optimization(hot_tables))
        
#        # åˆ†ææ—¶é—´æ¨¡å¼
        time_patterns = self.analyze_time_patterns(deadlock_data)
        if time_patterns:
            suggestions.extend(self.suggest_scheduling_optimization(time_patterns))
        
#        # åˆ†ææŸ¥è¯¢æ¨¡å¼
        query_patterns = self.analyze_query_patterns(deadlock_data)
        if query_patterns:
            suggestions.extend(self.suggest_query_optimization(query_patterns))
        
        return self.format_suggestions(suggestions)
    
    def suggest_index_optimization(self, hot_tables):
        """ç´¢å¼•ä¼˜åŒ–å»ºè®®"""
        suggestions = []
        for table, deadlock_count in hot_tables:
            if deadlock_count > 10:  # é˜ˆå€¼å¯é…ç½®
                suggestions.append({
                    'type': 'INDEX',
                    'priority': 'HIGH',
                    'table': table,
                    'suggestion': f'æ£€æŸ¥è¡¨ {table} çš„ç´¢å¼•è®¾è®¡ï¼Œè€ƒè™‘æ·»åŠ åˆé€‚çš„ç´¢å¼•ä»¥å‡å°‘é”å†²çª',
                    'details': f'è¯¥è¡¨æ¶‰åŠ {deadlock_count} æ¬¡æ­»é”ï¼Œå»ºè®®åˆ†ææŸ¥è¯¢æ¨¡å¼å¹¶ä¼˜åŒ–ç´¢å¼•'
                })
        return suggestions
    
    def suggest_query_optimization(self, query_patterns):
        """æŸ¥è¯¢ä¼˜åŒ–å»ºè®®"""
        suggestions = []
        for pattern, count in query_patterns:
            if 'ORDER BY' in pattern and count > 5:
                suggestions.append({
                    'type': 'QUERY',
                    'priority': 'MEDIUM', 
                    'suggestion': 'ä¼˜åŒ–ORDER BYæŸ¥è¯¢ï¼Œè€ƒè™‘ä½¿ç”¨ç´¢å¼•é¿å…æ–‡ä»¶æ’åº',
                    'pattern': pattern,
                    'count': count
                })
            elif 'UPDATE' in pattern and 'WHERE' not in pattern:
                suggestions.append({
                    'type': 'QUERY',
                    'priority': 'HIGH',
                    'suggestion': 'é¿å…æ— WHEREæ¡ä»¶çš„UPDATEè¯­å¥ï¼Œå®¹æ˜“é€ æˆå¤§èŒƒå›´é”å®š',
                    'pattern': pattern
                })
        return suggestions
    
    def format_suggestions(self, suggestions):
        """æ ¼å¼åŒ–ä¼˜åŒ–å»ºè®®"""
        formatted = "## ğŸ¯ ä¼˜åŒ–å»ºè®®\n\n"
        
#        # æŒ‰ä¼˜å…ˆçº§åˆ†ç»„
        high_priority = [s for s in suggestions if s['priority'] == 'HIGH']
        medium_priority = [s for s in suggestions if s['priority'] == 'MEDIUM']
        low_priority = [s for s in suggestions if s['priority'] == 'LOW']
        
        if high_priority:
            formatted += "### ğŸ”´ é«˜ä¼˜å…ˆçº§\n"
            for suggestion in high_priority:
                formatted += f"- **{suggestion['type']}**: {suggestion['suggestion']}\n"
                if 'details' in suggestion:
                    formatted += f"  - {suggestion['details']}\n"
        
        if medium_priority:
            formatted += "\n### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§\n"
            for suggestion in medium_priority:
                formatted += f"- **{suggestion['type']}**: {suggestion['suggestion']}\n"
        
        if low_priority:
            formatted += "\n### ğŸŸ¢ ä½ä¼˜å…ˆçº§\n"
            for suggestion in low_priority:
                formatted += f"- **{suggestion['type']}**: {suggestion['suggestion']}\n"
        
        return formatted
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ æ­»é”ç›‘æ§æœ¬è´¨ï¼šå®æ—¶å‘ç°ã€å¿«é€Ÿå®šä½ã€é¢„é˜²å†æ¬¡å‘ç”Ÿ
ğŸ”¸ ç›‘æ§å±‚æ¬¡ï¼šåº”ç”¨å±‚ã€æ•°æ®åº“å±‚ã€ç³»ç»Ÿå±‚çš„å®Œæ•´ç›‘æ§ä½“ç³»
ğŸ”¸ å…³é”®æŒ‡æ ‡ï¼šæ­»é”æ¬¡æ•°ã€æ­»é”ç‡ã€å“åº”æ—¶é—´ã€å½±å“èŒƒå›´
ğŸ”¸ æ—¥å¿—åˆ†æï¼šç†è§£æ­»é”æ—¥å¿—æ ¼å¼ã€æå–å…³é”®ä¿¡æ¯ã€æ‰¾åˆ°æ ¹å› 
ğŸ”¸ å·¥å…·ä½¿ç”¨ï¼šSHOW ENGINE STATUSã€performance_schemaã€è‡ªå®šä¹‰è„šæœ¬
ğŸ”¸ å‘Šè­¦æœºåˆ¶ï¼šå¤šçº§åˆ«å‘Šè­¦ã€åŠæ—¶é€šçŸ¥ã€è‡ªåŠ¨åŒ–å¤„ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ç›‘æ§çš„ä»·å€¼**ï¼š
```
ä¸æ˜¯ä¸ºäº†ç›‘æ§è€Œç›‘æ§ï¼š
âœ… å‘ç°é—®é¢˜ â†’ ä¸šåŠ¡å½±å“æœ€å°åŒ–
âœ… åˆ†æåŸå›  â†’ ä»æ ¹æºè§£å†³é—®é¢˜  
âœ… é¢„é˜²å¤å‘ â†’ æå‡ç³»ç»Ÿç¨³å®šæ€§
âœ… ä¼˜åŒ–æ€§èƒ½ â†’ æ”¹å–„ç”¨æˆ·ä½“éªŒ
```

**ğŸ”¹ ç›‘æ§æŒ‡æ ‡çš„é€‰æ‹©**ï¼š
```
é‡è¦ä½†ä¸ç´§æ€¥ï¼šæ­»é”æ€»æ•°ç»Ÿè®¡
é‡è¦ä¸”ç´§æ€¥ï¼šå®æ—¶æ­»é”ç‡ã€é”ç­‰å¾…æ—¶é—´
ä¸é‡è¦ä½†ç´§æ€¥ï¼šå•ä¸ªæ­»é”äº‹ä»¶
ä¸é‡è¦ä¸ç´§æ€¥ï¼šå†å²è¶‹åŠ¿åˆ†æ

å…³æ³¨é‡ç‚¹ï¼šé‡è¦ä¸”ç´§æ€¥çš„æŒ‡æ ‡
```

**ğŸ”¹ æ—¥å¿—åˆ†æçš„æŠ€å·§**ï¼š
```
ä¸‰æ­¥èµ°ç­–ç•¥ï¼š
ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿå®šä½ï¼ˆè°ã€ä½•æ—¶ã€ä»€ä¹ˆæ“ä½œï¼‰
ç¬¬äºŒæ­¥ï¼šæ·±å…¥åˆ†æï¼ˆä¸ºä»€ä¹ˆå‘ç”Ÿã€å½±å“èŒƒå›´ï¼‰  
ç¬¬ä¸‰æ­¥ï¼šåˆ¶å®šæ–¹æ¡ˆï¼ˆå¦‚ä½•é¿å…ã€å¦‚ä½•ä¼˜åŒ–ï¼‰
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ“Š ç›‘æ§å®æ–½æ­¥éª¤**ï¼š
```
Phase 1: åŸºç¡€ç›‘æ§æ­å»º
â”œâ”€â”€ å¯ç”¨ç›¸å…³ç›‘æ§å‚æ•°
â”œâ”€â”€ éƒ¨ç½²ç›‘æ§è„šæœ¬
â””â”€â”€ é…ç½®åŸºç¡€å‘Šè­¦

Phase 2: æ·±åº¦åˆ†æèƒ½åŠ›
â”œâ”€â”€ æ—¥å¿—è‡ªåŠ¨è§£æ
â”œâ”€â”€ è¶‹åŠ¿åˆ†ææŠ¥å‘Š
â””â”€â”€ ä¼˜åŒ–å»ºè®®ç”Ÿæˆ

Phase 3: æ™ºèƒ½åŒ–è¿ç»´  
â”œâ”€â”€ é¢„æµ‹æ€§åˆ†æ
â”œâ”€â”€ è‡ªåŠ¨ä¼˜åŒ–å»ºè®®
â””â”€â”€ å®Œæ•´è¿ç»´ä½“ç³»
```

**âš ï¸ ç›‘æ§æ³¨æ„äº‹é¡¹**ï¼š
```
é¿å…ç›‘æ§è¿‡è½½ï¼š
âŒ ä¸è¦æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æŒ‡æ ‡
âœ… ä¸“æ³¨äºä¸šåŠ¡å…³é”®æŒ‡æ ‡

é¿å…å‘Šè­¦ç–²åŠ³ï¼š
âŒ ä¸è¦è®¾ç½®è¿‡äºæ•æ„Ÿçš„é˜ˆå€¼
âœ… åˆç†è®¾ç½®å‘Šè­¦çº§åˆ«å’Œé¢‘ç‡

é¿å…åˆ†æparalysisï¼š
âŒ ä¸è¦é™·å…¥æ— æ­¢å¢ƒçš„æ•°æ®åˆ†æ
âœ… é‡ç‚¹å…³æ³¨å¯æ“ä½œçš„æ´å¯Ÿ
```

**ğŸ¯ æˆåŠŸç›‘æ§çš„å…³é”®**ï¼š

- **åŠæ—¶æ€§**ï¼šé—®é¢˜å‘ç”Ÿæ—¶èƒ½å¤Ÿç¬¬ä¸€æ—¶é—´å‘ç°
- **å‡†ç¡®æ€§**ï¼šå‘Šè­¦ä¿¡æ¯å‡†ç¡®ï¼Œå‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥
- **å¯æ“ä½œæ€§**ï¼šç›‘æ§ä¿¡æ¯èƒ½å¤ŸæŒ‡å¯¼å…·ä½“çš„ä¼˜åŒ–è¡ŒåŠ¨
- **æŒç»­æ€§**ï¼šé•¿æœŸç¨³å®šè¿è¡Œï¼ŒæŒç»­æä¾›ä»·å€¼

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç›‘æ§ä¸æ˜¯ç›®çš„ï¼Œè§£å†³é—®é¢˜æ‰æ˜¯ç›®æ ‡
- æ•°æ®è¦è½¬åŒ–ä¸ºä¿¡æ¯ï¼Œä¿¡æ¯è¦è½¬åŒ–ä¸ºè¡ŒåŠ¨
- å·¥å…·æ˜¯æ‰‹æ®µï¼Œåˆ†æå’Œä¼˜åŒ–æ˜¯å…³é”®
- é¢„é˜²èƒœäºæ²»ç–—ï¼ŒæŒç»­ä¼˜åŒ–èƒœäºè¢«åŠ¨å“åº”