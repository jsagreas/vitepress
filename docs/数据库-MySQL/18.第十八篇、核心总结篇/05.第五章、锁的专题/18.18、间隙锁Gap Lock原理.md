---
title: 18ã€é—´éš™é”Gap LockåŸç†
---
## ğŸ“š ç›®å½•

1. [é—´éš™é”åŸºæœ¬æ¦‚å¿µ](#1-é—´éš™é”åŸºæœ¬æ¦‚å¿µ)
2. [é—´éš™çš„è¯†åˆ«ä¸ç†è§£](#2-é—´éš™çš„è¯†åˆ«ä¸ç†è§£)
3. [Gap Lockå·¥ä½œåŸç†](#3-gap-lockå·¥ä½œåŸç†)
4. [å¹»è¯»é˜²æŠ¤æœºåˆ¶](#4-å¹»è¯»é˜²æŠ¤æœºåˆ¶)
5. [å…¼å®¹æ€§ä¸å†²çªè§„åˆ™](#5-å…¼å®¹æ€§ä¸å†²çªè§„åˆ™)
6. [æ€§èƒ½å½±å“ä¸ä¼˜åŒ–](#6-æ€§èƒ½å½±å“ä¸ä¼˜åŒ–)
7. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#7-å®æˆ˜æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ é—´éš™é”åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é—´éš™é”


**ğŸ”¸ é€šä¿—å®šä¹‰**
é—´éš™é”(Gap Lock)å°±åƒæ˜¯åœ¨æ•°æ®åº“è®°å½•ä¹‹é—´æ”¾ç½®çš„"éšå½¢æ …æ "ï¼Œå®ƒä¸é”å®šä»»ä½•å®é™…å­˜åœ¨çš„è®°å½•ï¼Œè€Œæ˜¯é”å®šè®°å½•ä¸è®°å½•ä¹‹é—´çš„"ç©ºéš™"ã€‚

```
æƒ³è±¡ä¸€ä¸ªåœè½¦åœºçš„ä¾‹å­ï¼š
åœè½¦ä½ï¼š  [è½¦A]  ç©ºä½  ç©ºä½  [è½¦B]  ç©ºä½  [è½¦C]
é—´éš™é”ï¼š        â†‘    â†‘           â†‘
               é”ä½è¿™äº›ç©ºä½ï¼Œé˜²æ­¢æ–°è½¦åœå…¥
```

**ğŸ’¡ æœ¬è´¨ç†è§£**
- **ä¸é”è®°å½•**ï¼šé—´éš™é”ä»ä¸é”å®šå·²å­˜åœ¨çš„è®°å½•
- **é”ç©ºé—´**ï¼šä¸“é—¨é”å®šè®°å½•ä¹‹é—´çš„"ç©ºéš™åŒºé—´"
- **é˜²æ’å…¥**ï¼šé˜»æ­¢åœ¨è¿™äº›ç©ºéš™ä¸­æ’å…¥æ–°è®°å½•
- **ä¿æŠ¤èŒƒå›´**ï¼šç¡®ä¿èŒƒå›´æŸ¥è¯¢çš„ç¨³å®šæ€§

### 1.2 é—´éš™é”çš„ä½œç”¨


**ğŸ¯ æ ¸å¿ƒç›®æ ‡**
```
ä¸»è¦ä½œç”¨ï¼š
âœ… é˜²æ­¢å¹»è¯»ï¼šç¡®ä¿åŒä¸€äº‹åŠ¡ä¸­é‡å¤æ‰§è¡Œç›¸åŒæŸ¥è¯¢å¾—åˆ°ç›¸åŒç»“æœ
âœ… èŒƒå›´ä¿æŠ¤ï¼šç»´æŠ¤èŒƒå›´æŸ¥è¯¢çš„ä¸€è‡´æ€§
âœ… æ’å…¥æ§åˆ¶ï¼šæ§åˆ¶å¹¶å‘æ’å…¥æ“ä½œçš„ä½ç½®
```

**ğŸ“‹ å®é™…åœºæ™¯**
```sql
-- äº‹åŠ¡Aæ‰§è¡ŒèŒƒå›´æŸ¥è¯¢
SELECT * FROM users WHERE age BETWEEN 20 AND 30;
-- è¿”å›ï¼šid=5(age=25), id=8(age=28)

-- å¦‚æœæ²¡æœ‰é—´éš™é”ï¼Œäº‹åŠ¡Bå¯èƒ½æ’å…¥ï¼š
INSERT INTO users(age) VALUES(22); -- ä¼šé€ æˆå¹»è¯»

-- æœ‰äº†é—´éš™é”ï¼Œè¿™ä¸ªæ’å…¥ä¼šè¢«é˜»å¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
```

### 1.3 é—´éš™é”çš„ç‰¹æ®Šæ€§è´¨


**ğŸ”¹ ç‹¬ç‰¹ç‰¹å¾**
```
ä¸å…¶ä»–é”çš„åŒºåˆ«ï¼š
â€¢ è®°å½•é”ï¼šé”å®šå…·ä½“å­˜åœ¨çš„è®°å½•
â€¢ é—´éš™é”ï¼šé”å®šä¸å­˜åœ¨è®°å½•çš„ç©ºé—´
â€¢ ä¸´é”®é”ï¼šè®°å½•é” + é—´éš™é”çš„ç»„åˆ

é—´éš™é”çš„"å®½å®¹æ€§"ï¼š
â€¢ å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰åŒä¸€é—´éš™çš„é—´éš™é”
â€¢ é—´éš™é”ä¹‹é—´ä¸å†²çª
â€¢ åªä¸æ’å…¥æ“ä½œå†²çª
```

---

## 2. ğŸ“ é—´éš™çš„è¯†åˆ«ä¸ç†è§£


### 2.1 ä»€ä¹ˆæ˜¯é—´éš™


**ğŸ”¸ é—´éš™çš„æ¦‚å¿µ**
é—´éš™æ˜¯æŒ‡ç´¢å¼•è®°å½•ä¹‹é—´çš„"ç©ºç™½åŒºåŸŸ"ï¼Œè¿™äº›åŒºåŸŸç›®å‰æ²¡æœ‰è®°å½•ï¼Œä½†å¯èƒ½ä¼šæœ‰æ–°è®°å½•æ’å…¥ã€‚

```
å‡è®¾æœ‰ç´¢å¼•å€¼ï¼š10, 20, 30, 40

é—´éš™åˆ†å¸ƒï¼š
(-âˆ, 10)     â† ç¬¬ä¸€ä¸ªé—´éš™ï¼šå°äº10çš„åŒºé—´
(10, 20)     â† è®°å½•é—´é—´éš™ï¼š10åˆ°20ä¹‹é—´  
(20, 30)     â† è®°å½•é—´é—´éš™ï¼š20åˆ°30ä¹‹é—´
(30, 40)     â† è®°å½•é—´é—´éš™ï¼š30åˆ°40ä¹‹é—´
(40, +âˆ)     â† æœ€åé—´éš™ï¼šå¤§äº40çš„åŒºé—´
```

### 2.2 é—´éš™çš„åŠ¨æ€ç‰¹æ€§


**ğŸ“Š é—´éš™ä¼šå˜åŒ–**
```sql
-- åˆå§‹çŠ¶æ€ï¼šusersè¡¨æœ‰idä¸º1,5,10çš„è®°å½•
-- é—´éš™åˆ†å¸ƒï¼š(-âˆ,1), (1,5), (5,10), (10,+âˆ)

-- æ’å…¥æ–°è®°å½•å
INSERT INTO users(id) VALUES(3);
-- æ–°çš„é—´éš™åˆ†å¸ƒï¼š(-âˆ,1), (1,3), (3,5), (5,10), (10,+âˆ)

-- åˆ é™¤è®°å½•å  
DELETE FROM users WHERE id=5;
-- é—´éš™åˆ†å¸ƒï¼š(-âˆ,1), (1,3), (3,10), (10,+âˆ)
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- é—´éš™æ˜¯**åŠ¨æ€**çš„ï¼Œä¼šéšç€æ•°æ®å˜åŒ–è€Œå˜åŒ–
- é—´éš™é”é”å®šçš„æ˜¯**å½“å‰æ—¶åˆ»**çš„é—´éš™çŠ¶æ€
- æ–°æ’å…¥çš„è®°å½•ä¼š**æ‹†åˆ†**åŸæœ‰é—´éš™

### 2.3 ä¸åŒç´¢å¼•çš„é—´éš™


**ğŸ”¹ ä¸»é”®ç´¢å¼•é—´éš™**
```sql
-- è¡¨ç»“æ„ï¼šid(ä¸»é”®), name, age
-- æ•°æ®ï¼šid=1,3,7,10

SELECT * FROM users WHERE id > 5 AND id < 8 FOR UPDATE;
-- é”å®šé—´éš™ï¼š(5,7) å’Œ (7,8)
-- å®é™…ä¸Šid=7å­˜åœ¨ï¼Œæ‰€ä»¥çœŸæ­£çš„é—´éš™æ˜¯(7,10)
```

**ğŸ”¹ æ™®é€šç´¢å¼•é—´éš™**
```sql
-- ageå­—æ®µæœ‰ç´¢å¼•ï¼Œæ•°æ®ï¼šage=20,25,30,35

SELECT * FROM users WHERE age > 22 AND age < 28 FOR UPDATE;
-- é”å®šé—´éš™ï¼š(20,25) å’Œ (25,30)ä¹‹é—´ç¬¦åˆæ¡ä»¶çš„éƒ¨åˆ†
```

---

## 3. âš™ï¸ Gap Lockå·¥ä½œåŸç†


### 3.1 é—´éš™é”çš„è§¦å‘æ¡ä»¶


**ğŸš¨ ä½•æ—¶äº§ç”Ÿé—´éš™é”**
```
è§¦å‘åœºæ™¯ï¼š
1ï¸âƒ£ ä½¿ç”¨èŒƒå›´æŸ¥è¯¢æ¡ä»¶ï¼ˆBETWEEN, >, <, >=, <=ï¼‰
2ï¸âƒ£ äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºREPEATABLE READæˆ–SERIALIZABLE  
3ï¸âƒ£ ä½¿ç”¨SELECT...FOR UPDATEæˆ–SELECT...LOCK IN SHARE MODE
4ï¸âƒ£ UPDATE/DELETEçš„WHEREæ¡ä»¶æ¶‰åŠèŒƒå›´æŸ¥è¯¢
```

**ğŸ“‹ å…·ä½“ç¤ºä¾‹**
```sql
-- âœ… ä¼šäº§ç”Ÿé—´éš™é”çš„æ“ä½œ
SELECT * FROM users WHERE age > 20 FOR UPDATE;
SELECT * FROM users WHERE id BETWEEN 5 AND 15 LOCK IN SHARE MODE;
UPDATE users SET name='å¼ ä¸‰' WHERE age > 25 AND age < 35;

-- âŒ ä¸ä¼šäº§ç”Ÿé—´éš™é”çš„æ“ä½œ  
SELECT * FROM users WHERE id = 10 FOR UPDATE;  -- ç²¾ç¡®åŒ¹é…
SELECT * FROM users WHERE age > 20;            -- æ²¡æœ‰é”å®šè¯­å¥
```

### 3.2 é—´éš™é”çš„é”å®šèŒƒå›´


**ğŸ¯ èŒƒå›´ç¡®å®šè§„åˆ™**
```
é”å®šèŒƒå›´è®¡ç®—ï¼š
â€¢ æ‰¾åˆ°æŸ¥è¯¢æ¡ä»¶æ¶‰åŠçš„æ‰€æœ‰ç´¢å¼•è®°å½•
â€¢ ç¡®å®šè¿™äº›è®°å½•ä¹‹é—´å’Œä¸¤ç«¯çš„é—´éš™
â€¢ é”å®šæ‰€æœ‰ç›¸å…³é—´éš™

ç¤ºä¾‹åˆ†æï¼š
æ•°æ®ï¼šid = 1, 5, 10, 15, 20
æŸ¥è¯¢ï¼šWHERE id > 7 AND id < 18 FOR UPDATE

åˆ†æè¿‡ç¨‹ï¼š
1. æ‰¾åˆ°è¾¹ç•Œï¼šå·¦è¾¹ç•Œåœ¨(5,10)é—´ï¼Œå³è¾¹ç•Œåœ¨(15,20)é—´
2. æ¶‰åŠè®°å½•ï¼šid=10, id=15  
3. é”å®šé—´éš™ï¼š(5,10), (10,15), (15,20)
```

### 3.3 é—´éš™é”ä¸ç´¢å¼•çš„å…³ç³»


**ğŸ“Š ç´¢å¼•ç±»å‹å½±å“**
```
ä¸»é”®ç´¢å¼•ï¼š
â€¢ é—´éš™é”èŒƒå›´æœ€ç²¾ç¡®
â€¢ é”å®šèŒƒå›´æœ€å°
â€¢ æ€§èƒ½å½±å“ç›¸å¯¹è¾ƒå°

æ™®é€šç´¢å¼•ï¼š
â€¢ å¯èƒ½é”å®šæ›´å¤§èŒƒå›´
â€¢ éœ€è¦è€ƒè™‘ç´¢å¼•å€¼é‡å¤æƒ…å†µ
â€¢ é”å®šèŒƒå›´å¯èƒ½æ‰©å¤§

æ— ç´¢å¼•ï¼š
â€¢ å…¨è¡¨æ‰«æï¼Œé”å®šæ‰€æœ‰é—´éš™
â€¢ æ€§èƒ½å½±å“æœ€å¤§
â€¢ å¹¶å‘åº¦æœ€ä½
```

---

## 4. ğŸ‘» å¹»è¯»é˜²æŠ¤æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯å¹»è¯»


**ğŸ”¸ å¹»è¯»ç°è±¡**
å¹»è¯»æ˜¯æŒ‡åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç›¸åŒçš„æŸ¥è¯¢åœ¨ä¸åŒæ—¶é—´æ‰§è¡Œæ—¶ï¼Œè¿”å›äº†ä¸åŒæ•°é‡çš„è®°å½•ã€‚

```
å¹»è¯»ç¤ºä¾‹ï¼š
æ—¶åˆ»1ï¼šSELECT COUNT(*) FROM users WHERE age > 25; -- è¿”å›3æ¡
æ—¶åˆ»2ï¼šå¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†age=30çš„è®°å½•  
æ—¶åˆ»3ï¼šSELECT COUNT(*) FROM users WHERE age > 25; -- è¿”å›4æ¡

é—®é¢˜ï¼šåŒä¸€äº‹åŠ¡ä¸­ç›¸åŒæŸ¥è¯¢è¿”å›äº†ä¸åŒç»“æœï¼
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦é˜²æ­¢å¹»è¯»**
```
ä¸šåŠ¡å½±å“ï¼š
âŒ æŠ¥è¡¨ç»Ÿè®¡ä¸ä¸€è‡´
âŒ è´¢åŠ¡è®¡ç®—å‡ºç°åå·®  
âŒ åº“å­˜ç®¡ç†æ··ä¹±
âŒ æ•°æ®åˆ†æç»“æœä¸å¯é 
```

### 4.2 é—´éš™é”é˜²æŠ¤åŸç†


**ğŸ›¡ï¸ é˜²æŠ¤æœºåˆ¶**
```
é˜²æŠ¤æ­¥éª¤ï¼š
1ï¸âƒ£ äº‹åŠ¡Aæ‰§è¡ŒèŒƒå›´æŸ¥è¯¢
2ï¸âƒ£ ç³»ç»Ÿè‡ªåŠ¨åœ¨ç›¸å…³é—´éš™ä¸ŠåŠ é—´éš™é”
3ï¸âƒ£ å…¶ä»–äº‹åŠ¡å°è¯•æ’å…¥è¯¥èŒƒå›´çš„è®°å½•
4ï¸âƒ£ æ’å…¥æ“ä½œè¢«é˜»å¡ï¼Œç­‰å¾…é—´éš™é”é‡Šæ”¾
5ï¸âƒ£ äº‹åŠ¡Aå†æ¬¡æ‰§è¡Œç›¸åŒæŸ¥è¯¢ï¼Œç»“æœä¸€è‡´
```

**ğŸ“‹ å®æˆ˜æ¼”ç¤º**
```sql
-- äº‹åŠ¡A
BEGIN;
SELECT * FROM users WHERE age BETWEEN 20 AND 30 FOR UPDATE;
-- è‡ªåŠ¨åœ¨(19,21), (25,31)ç­‰é—´éš™åŠ é”

-- äº‹åŠ¡Bï¼ˆä¼šè¢«é˜»å¡ï¼‰
INSERT INTO users(age) VALUES(25); -- ç­‰å¾…ä¸­...

-- äº‹åŠ¡Aå†æ¬¡æŸ¥è¯¢
SELECT * FROM users WHERE age BETWEEN 20 AND 30; 
-- ç»“æœä¸ç¬¬ä¸€æ¬¡å®Œå…¨ç›¸åŒï¼Œæ²¡æœ‰å¹»è¯»
COMMIT; -- é‡Šæ”¾é”ï¼Œäº‹åŠ¡Bçš„æ’å…¥æ‰èƒ½æ‰§è¡Œ
```

### 4.3 é˜²æŠ¤èŒƒå›´çš„ç²¾ç¡®æ€§


**ğŸ¯ é”å®šç­–ç•¥**
```
ç²¾ç¡®é˜²æŠ¤ï¼š
â€¢ åªé”å®šå¯èƒ½å½±å“æŸ¥è¯¢ç»“æœçš„é—´éš™
â€¢ ä¸ä¼šè¿‡åº¦é”å®šæ— å…³åŒºåŸŸ
â€¢ åœ¨ä¿æŠ¤æ€§å’Œæ€§èƒ½ä¹‹é—´å¹³è¡¡

ç¤ºä¾‹åˆ†æï¼š
æŸ¥è¯¢ï¼šSELECT * FROM users WHERE age > 25 AND status = 'active'

é”å®šèŒƒå›´ï¼š
âœ… age > 25çš„é—´éš™ï¼ˆé˜²æ­¢æ’å…¥age=30çš„è®°å½•ï¼‰
âœ… ç°æœ‰è®°å½•çš„é—´éš™ï¼ˆé˜²æ­¢æ’å…¥å½±å“ç»“æœçš„è®°å½•ï¼‰
âŒ age <= 25çš„é—´éš™ï¼ˆä¸ä¼šå½±å“æŸ¥è¯¢ç»“æœï¼‰
```

---

## 5. ğŸ¤ å…¼å®¹æ€§ä¸å†²çªè§„åˆ™


### 5.1 é—´éš™é”çš„å…¼å®¹æ€§


**ğŸ”¹ ç‰¹æ®Šçš„å…¼å®¹æ€§**
é—´éš™é”æœ‰ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„æ€§è´¨ï¼š**å¤šä¸ªé—´éš™é”ä¹‹é—´ç›¸äº’å…¼å®¹**ã€‚

```
å…¼å®¹æ€§è¡¨æ ¼ï¼š
                é—´éš™é”    è®°å½•é”    ä¸´é”®é”
é—´éš™é”           âœ…       â“        â“
è®°å½•é”           â“       âŒ        âŒ  
ä¸´é”®é”           â“       âŒ        âŒ

âœ… = å…¼å®¹   âŒ = å†²çª   â“ = å–å†³äºå…·ä½“æƒ…å†µ
```

**ğŸ’¡ ä¸ºä»€ä¹ˆé—´éš™é”ç›¸äº’å…¼å®¹**
```
ç†è®ºåŸºç¡€ï¼š
â€¢ é—´éš™é”åªé˜»æ­¢INSERTæ“ä½œ
â€¢ ä¸åŒäº‹åŠ¡çš„é—´éš™é”ç›®æ ‡ç›¸åŒï¼šéƒ½æ˜¯é˜²æ­¢æ’å…¥
â€¢ å¤šä¸ª"é˜²æ­¢æ’å…¥"çš„é”ä¸ä¼šäº’ç›¸å¹²æ‰°
â€¢ å°±åƒå¤šä¸ªäººåŒæ—¶è¯´"è¿™é‡Œä¸èƒ½åœè½¦"ï¼Œä¸ä¼šå†²çª
```

### 5.2 é—´éš™é”ä¸å…¶ä»–æ“ä½œçš„å†²çª


**âŒ ä¸æ’å…¥æ“ä½œçš„å†²çª**
```sql
-- äº‹åŠ¡Aï¼šæŒæœ‰é—´éš™é”
SELECT * FROM users WHERE id > 10 AND id < 20 FOR UPDATE;
-- é”å®šé—´éš™ï¼š(10, 15), (15, 20)ç­‰

-- äº‹åŠ¡Bï¼šæ’å…¥æ“ä½œï¼ˆä¼šé˜»å¡ï¼‰
INSERT INTO users(id, name) VALUES(12, 'å¼ ä¸‰'); -- ç­‰å¾…é—´éš™é”é‡Šæ”¾
INSERT INTO users(id, name) VALUES(18, 'æå››'); -- ç­‰å¾…é—´éš™é”é‡Šæ”¾

-- äº‹åŠ¡Bï¼šä¸å†²çªçš„æ“ä½œ
INSERT INTO users(id, name) VALUES(25, 'ç‹äº”'); -- ä¸åœ¨é”å®šé—´éš™å†…ï¼Œå¯ä»¥æ‰§è¡Œ
```

**âœ… ä¸æŸ¥è¯¢æ“ä½œçš„å…¼å®¹**
```sql
-- äº‹åŠ¡Aï¼šæŒæœ‰é—´éš™é”
SELECT * FROM users WHERE id > 10 AND id < 20 FOR UPDATE;

-- äº‹åŠ¡Bï¼šæŸ¥è¯¢æ“ä½œï¼ˆä¸ä¼šé˜»å¡ï¼‰
SELECT * FROM users WHERE id > 12 AND id < 18;           -- æ™®é€šæŸ¥è¯¢
SELECT * FROM users WHERE id = 15;                       -- ç²¾ç¡®æŸ¥è¯¢  
SELECT * FROM users WHERE id > 15 AND id < 25 FOR UPDATE; -- å¦ä¸€ä¸ªèŒƒå›´çš„åŠ é”æŸ¥è¯¢
```

### 5.3 æ­»é”é£é™©


**âš ï¸ é—´éš™é”æ­»é”åœºæ™¯**
```sql
-- æ­»é”åœºæ™¯ç¤ºä¾‹
-- äº‹åŠ¡A
BEGIN;
SELECT * FROM users WHERE id > 10 AND id < 20 FOR UPDATE;
-- æŒæœ‰é—´éš™é”(10,20)

-- äº‹åŠ¡B  
BEGIN;
SELECT * FROM users WHERE id > 15 AND id < 25 FOR UPDATE;
-- æŒæœ‰é—´éš™é”(15,25)

-- äº‹åŠ¡Aå°è¯•æ’å…¥
INSERT INTO users(id) VALUES(22); -- è¢«äº‹åŠ¡Bçš„é—´éš™é”é˜»å¡

-- äº‹åŠ¡Bå°è¯•æ’å…¥  
INSERT INTO users(id) VALUES(12); -- è¢«äº‹åŠ¡Açš„é—´éš™é”é˜»å¡

-- ç»“æœï¼šæ­»é”ï¼MySQLä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡
```

**ğŸ›¡ï¸ æ­»é”é¢„é˜²ç­–ç•¥**
```
é¢„é˜²æ–¹æ³•ï¼š
1ï¸âƒ£ æŒ‰ç›¸åŒé¡ºåºè®¿é—®æ•°æ®ï¼šç»Ÿä¸€äº‹åŠ¡ä¸­æ“ä½œæ•°æ®çš„é¡ºåº
2ï¸âƒ£ ç¼©çŸ­äº‹åŠ¡æ—¶é—´ï¼šå‡å°‘é”æŒæœ‰æ—¶é—´
3ï¸âƒ£ ä½¿ç”¨æ›´ç²¾ç¡®çš„æŸ¥è¯¢æ¡ä»¶ï¼šå‡å°‘é—´éš™é”èŒƒå›´
4ï¸âƒ£ è€ƒè™‘é™ä½éš”ç¦»çº§åˆ«ï¼šåœ¨ä¸šåŠ¡å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨RCçº§åˆ«
```

---

## 6. ğŸ“Š æ€§èƒ½å½±å“ä¸ä¼˜åŒ–


### 6.1 æ€§èƒ½å½±å“åˆ†æ


**ğŸ“‰ è´Ÿé¢å½±å“**
```
å¹¶å‘åº¦é™ä½ï¼š
â€¢ æ’å…¥æ“ä½œè¢«é¢‘ç¹é˜»å¡
â€¢ äº‹åŠ¡ç­‰å¾…æ—¶é—´å¢åŠ 
â€¢ ååé‡ä¸‹é™

é”äº‰ç”¨å¢åŠ ï¼š
â€¢ æ›´å¤šé”èµ„æºæ¶ˆè€—
â€¢ æ­»é”æ£€æµ‹å¼€é”€
â€¢ é”ç®¡ç†å¤æ‚åº¦æå‡
```

**ğŸ“Š æ€§èƒ½æµ‹è¯•å¯¹æ¯”**
```
æµ‹è¯•åœºæ™¯ï¼š1000å¹¶å‘æ’å…¥æ“ä½œ

æ— é—´éš™é”ï¼ˆREAD COMMITTEDï¼‰ï¼š
â€¢ TPS: 8000+
â€¢ å¹³å‡å“åº”æ—¶é—´: 15ms
â€¢ æ­»é”æ¬¡æ•°: 0

æœ‰é—´éš™é”ï¼ˆREPEATABLE READï¼‰ï¼š
â€¢ TPS: 3000+  
â€¢ å¹³å‡å“åº”æ—¶é—´: 45ms
â€¢ æ­»é”æ¬¡æ•°: 12æ¬¡/åˆ†é’Ÿ
```

### 6.2 ä¼˜åŒ–ç­–ç•¥


**ğŸš€ ç´¢å¼•ä¼˜åŒ–**
```sql
-- âŒ ä½æ•ˆï¼šæ— ç´¢å¼•å¯¼è‡´å…¨è¡¨é—´éš™é”
SELECT * FROM users WHERE age > 25 FOR UPDATE;

-- âœ… é«˜æ•ˆï¼šæœ‰ç´¢å¼•ç²¾ç¡®é”å®š
-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_age ON users(age);
SELECT * FROM users WHERE age > 25 FOR UPDATE;
```

**ğŸ¯ æŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–**
```sql
-- âŒ èŒƒå›´è¿‡å¤§
SELECT * FROM users WHERE age > 10 FOR UPDATE;

-- âœ… ç²¾ç¡®èŒƒå›´  
SELECT * FROM users WHERE age >= 25 AND age <= 35 FOR UPDATE;

-- âœ… æ›´ç²¾ç¡®æ¡ä»¶
SELECT * FROM users WHERE age = 30 AND status = 'active' FOR UPDATE;
```

**âš¡ äº‹åŠ¡è®¾è®¡ä¼˜åŒ–**
```sql
-- âŒ é•¿äº‹åŠ¡
BEGIN;
SELECT * FROM users WHERE age > 25 FOR UPDATE;
-- ... æ‰§è¡Œå¾ˆå¤šå…¶ä»–æ“ä½œ ...
-- ... 5åˆ†é’Ÿåæ‰æäº¤ ...
COMMIT;

-- âœ… çŸ­äº‹åŠ¡
BEGIN;  
SELECT * FROM users WHERE age > 25 FOR UPDATE;
UPDATE users SET status = 'processed' WHERE age > 25;
COMMIT; -- ç«‹å³æäº¤
```

### 6.3 éš”ç¦»çº§åˆ«é€‰æ‹©


**ğŸ“‹ çº§åˆ«å¯¹æ¯”**
```
READ COMMITTEDï¼ˆRCï¼‰ï¼š
âœ… æ— é—´éš™é”ï¼Œå¹¶å‘åº¦é«˜
âœ… æ’å…¥æ€§èƒ½å¥½
âŒ å¯èƒ½å‡ºç°å¹»è¯»
âŒ æ•°æ®ä¸€è‡´æ€§è¾ƒå¼±

REPEATABLE READï¼ˆRRï¼‰ï¼š
âœ… æœ‰é—´éš™é”ï¼Œé˜²æ­¢å¹»è¯»
âœ… æ•°æ®ä¸€è‡´æ€§å¼º  
âŒ å¹¶å‘åº¦è¾ƒä½
âŒ å¯èƒ½æ­»é”

é€‰æ‹©å»ºè®®ï¼š
â€¢ OLTPç³»ç»Ÿï¼šè€ƒè™‘RCçº§åˆ«
â€¢ æŠ¥è¡¨ç³»ç»Ÿï¼šä½¿ç”¨RRçº§åˆ«  
â€¢ é‡‘èç³»ç»Ÿï¼šå¿…é¡»RRçº§åˆ«
```

---

## 7. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 7.1 ç”µå•†åº“å­˜ç®¡ç†æ¡ˆä¾‹


**ğŸ“¦ ä¸šåŠ¡åœºæ™¯**
```sql
-- å•†å“åº“å­˜è¡¨
CREATE TABLE inventory (
    product_id INT PRIMARY KEY,
    stock_count INT,
    reserved_count INT,
    INDEX idx_stock (stock_count)
);

-- ä¸šåŠ¡éœ€æ±‚ï¼šæŸ¥è¯¢åº“å­˜å……è¶³çš„å•†å“å¹¶é¢„ç•™åº“å­˜
```

**ğŸ”’ é—´éš™é”åˆ†æ**
```sql
-- æŸ¥è¯¢åº“å­˜å¤§äº10çš„å•†å“
SELECT * FROM inventory WHERE stock_count > 10 FOR UPDATE;

-- é—´éš™é”å½±å“ï¼š
-- 1. é”å®š(10, +âˆ)çš„é—´éš™
-- 2. é˜»æ­¢æ’å…¥stock_count > 10çš„æ–°å•†å“
-- 3. å…¶ä»–äº‹åŠ¡æ— æ³•æ·»åŠ é«˜åº“å­˜å•†å“
```

**ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ**
```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç²¾ç¡®æ¡ä»¶
SELECT * FROM inventory 
WHERE stock_count >= 10 AND stock_count <= 1000 
FOR UPDATE;

-- æ–¹æ¡ˆ2ï¼šåˆ†æ‰¹å¤„ç†
SELECT * FROM inventory 
WHERE stock_count > 10 
LIMIT 100 FOR UPDATE;

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨ä¹è§‚é”
SELECT product_id, stock_count, version 
FROM inventory WHERE stock_count > 10;

UPDATE inventory 
SET reserved_count = reserved_count + 1, version = version + 1
WHERE product_id = ? AND version = ?;
```

### 7.2 è®¢å•ç³»ç»Ÿæ¡ˆä¾‹


**ğŸ“‹ ä¸šåŠ¡åœºæ™¯**
```sql  
-- è®¢å•è¡¨
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    amount DECIMAL(10,2),
    created_at DATETIME,
    INDEX idx_created (created_at)
);

-- éœ€æ±‚ï¼šç»Ÿè®¡ä»Šæ—¥è®¢å•æ€»é‡‘é¢
```

**ğŸš« é—®é¢˜åˆ†æ**
```sql
-- æœ‰é—®é¢˜çš„æŸ¥è¯¢
SELECT SUM(amount) FROM orders 
WHERE created_at >= '2024-01-01 00:00:00' 
AND created_at < '2024-01-02 00:00:00'
FOR UPDATE;

-- é—®é¢˜ï¼šé”å®šäº†æ•´ä¸ªæ—¶é—´èŒƒå›´çš„é—´éš™
-- å½±å“ï¼šæ–°è®¢å•æ— æ³•æ’å…¥åˆ°ä»Šæ—¥
```

**âœ… è§£å†³æ–¹æ¡ˆ**
```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨å¿«ç…§è¯»
SELECT SUM(amount) FROM orders 
WHERE created_at >= '2024-01-01 00:00:00' 
AND created_at < '2024-01-02 00:00:00';
-- ä¸åŠ é”ï¼Œå…è®¸å¹»è¯»ï¼Œä½†ç»Ÿè®¡åœºæ™¯ä¸‹é€šå¸¸å¯æ¥å—

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ±‡æ€»è¡¨
CREATE TABLE daily_summary (
    date DATE PRIMARY KEY,
    total_amount DECIMAL(12,2),
    order_count INT
);
-- å®šæœŸæ±‡æ€»ï¼Œé¿å…å®æ—¶è®¡ç®—çš„é”é—®é¢˜
```

### 7.3 ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿæ¡ˆä¾‹


**ğŸ¯ å¤æ‚åœºæ™¯åˆ†æ**
```sql
-- ç§¯åˆ†ç­‰çº§å‡çº§é€»è¾‘
-- æŸ¥æ‰¾ç§¯åˆ†åœ¨8000-10000ä¹‹é—´çš„ç”¨æˆ·ï¼Œå‡†å¤‡å‡çº§ä¸ºVIP

BEGIN;
SELECT user_id, points FROM users 
WHERE points >= 8000 AND points < 10000 
FOR UPDATE;

-- é—´éš™é”å½±å“ï¼š
-- 1. é”å®š(7999, 8000), (8000, 10000), (10000, 10001)ç­‰é—´éš™
-- 2. é˜»æ­¢æ–°ç”¨æˆ·ç§¯åˆ†è¾¾åˆ°å‡çº§åŒºé—´
-- 3. å½±å“ç§¯åˆ†ç³»ç»Ÿçš„å®æ—¶æ€§
```

**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**
```sql
-- ç­–ç•¥1ï¼šåˆ†é¡µå¤„ç†
SELECT user_id, points FROM users 
WHERE points >= 8000 AND points < 10000 
ORDER BY user_id 
LIMIT 50 FOR UPDATE;

-- ç­–ç•¥2ï¼šå¼‚æ­¥å¤„ç†
-- 1. å…ˆæ— é”æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·
-- 2. æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
-- 3. å¤„ç†æ—¶ä½¿ç”¨ä¹è§‚é”æˆ–ç‰ˆæœ¬å·æ§åˆ¶

-- ç­–ç•¥3ï¼šä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æ‰¹é‡å¤„ç†
DELIMITER $$
CREATE PROCEDURE upgrade_vip_users()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE user_id INT;
    DECLARE cur CURSOR FOR 
        SELECT id FROM users WHERE points >= 8000 AND points < 10000;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur;
    read_loop: LOOP
        FETCH cur INTO user_id;
        IF done THEN LEAVE read_loop; END IF;
        
        -- å•ä¸ªç”¨æˆ·å¤„ç†ï¼Œå‡å°‘é”èŒƒå›´
        UPDATE users SET level = 'VIP' WHERE id = user_id;
    END LOOP;
    CLOSE cur;
END$$
DELIMITER ;
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»ç†è§£çš„æ¦‚å¿µ


```
ğŸ”¸ é—´éš™é”æœ¬è´¨ï¼šé”å®šè®°å½•ä¹‹é—´çš„"ç©ºéš™"ï¼Œä¸é”è®°å½•æœ¬èº«
ğŸ”¸ æ ¸å¿ƒä½œç”¨ï¼šé˜²æ­¢å¹»è¯»ï¼Œä¿æŠ¤èŒƒå›´æŸ¥è¯¢çš„ä¸€è‡´æ€§  
ğŸ”¸ è§¦å‘æ¡ä»¶ï¼šRRçº§åˆ«ä¸‹çš„èŒƒå›´æŸ¥è¯¢ + åŠ é”æ“ä½œ
ğŸ”¸ å…¼å®¹ç‰¹æ€§ï¼šé—´éš™é”ä¹‹é—´ç›¸äº’å…¼å®¹ï¼Œåªä¸æ’å…¥æ“ä½œå†²çª
ğŸ”¸ æ€§èƒ½å½±å“ï¼šé™ä½å¹¶å‘åº¦ï¼Œå¯èƒ½å¯¼è‡´æ­»é”
```

### 8.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ é—´éš™è¯†åˆ«**
```
è®°å¿†æ–¹æ³•ï¼š
â€¢ æŠŠç´¢å¼•å€¼æƒ³è±¡æˆåœè½¦åœºçš„è½¦ä½
â€¢ é—´éš™å°±æ˜¯ç©ºé—²çš„è½¦ä½åŒºé—´  
â€¢ é—´éš™é”å°±æ˜¯åœ¨ç©ºè½¦ä½æ”¾ç½®"ç¦åœ"æ ‡å¿—
â€¢ é˜²æ­¢å…¶ä»–è½¦ï¼ˆæ–°è®°å½•ï¼‰åœå…¥è¿™äº›ä½ç½®
```

**ğŸ”¹ é”å®šèŒƒå›´ç¡®å®š**
```
ç¡®å®šæ­¥éª¤ï¼š
1ï¸âƒ£ æ‰¾åˆ°æŸ¥è¯¢æ¡ä»¶æ¶‰åŠçš„ç´¢å¼•è¾¹ç•Œ
2ï¸âƒ£ è¯†åˆ«è¾¹ç•Œä¹‹é—´å’Œä¸¤ç«¯çš„æ‰€æœ‰é—´éš™
3ï¸âƒ£ å¯¹ç›¸å…³é—´éš™åŠ é”
4ï¸âƒ£ é˜»æ­¢å‘è¿™äº›é—´éš™æ’å…¥æ–°è®°å½•
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ ä½¿ç”¨ç²¾ç¡®æŸ¥è¯¢æ¡ä»¶ï¼Œå‡å°‘é”å®šèŒƒå›´
â€¢ åˆ›å»ºåˆé€‚çš„ç´¢å¼•ï¼Œæé«˜é”å®šç²¾åº¦
â€¢ ç¼©çŸ­äº‹åŠ¡æ—¶é—´ï¼Œå‡å°‘é”æŒæœ‰æ—¶é•¿  
â€¢ è€ƒè™‘ä¸šåŠ¡éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„éš”ç¦»çº§åˆ«
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯**
- **é‡‘èç³»ç»Ÿ**ï¼šéœ€è¦å¼ºä¸€è‡´æ€§ï¼Œé˜²æ­¢æ•°æ®å¼‚å¸¸
- **æŠ¥è¡¨ç»Ÿè®¡**ï¼šéœ€è¦ç¨³å®šçš„æ•°æ®å¿«ç…§
- **åº“å­˜ç®¡ç†**ï¼šé˜²æ­¢è¶…å–ç­‰ä¸šåŠ¡å¼‚å¸¸
- **å®¡è®¡ç³»ç»Ÿ**ï¼šéœ€è¦å®Œæ•´çš„æ•°æ®è¿½è¸ª

**âŒ ä¸é€‚ç”¨åœºæ™¯**  
- **é«˜å¹¶å‘å†™å…¥**ï¼šå¤§é‡æ’å…¥æ“ä½œçš„ç³»ç»Ÿ
- **å®æ—¶æ€§è¦æ±‚é«˜**ï¼šéœ€è¦ç«‹å³å¯è§æ€§çš„åœºæ™¯
- **ç®€å•CRUD**ï¼šæ²¡æœ‰å¤æ‚ä¸šåŠ¡é€»è¾‘çš„åº”ç”¨
- **æ•°æ®åˆ†æ**ï¼šå¯ä»¥å®¹å¿æ•°æ®ä¸ä¸€è‡´çš„åˆ†æåœºæ™¯

### 8.4 æ•…éšœæ’æŸ¥è¦ç‚¹


**ğŸ” å¸¸è§é—®é¢˜**
```
é—®é¢˜ç°è±¡ï¼š
â— æ’å…¥æ“ä½œé•¿æ—¶é—´ç­‰å¾…
â— æ­»é”é¢‘ç¹å‘ç”Ÿ
â— ç³»ç»ŸTPSçªç„¶ä¸‹é™
â— äº‹åŠ¡è¶…æ—¶å¼‚å¸¸å¢å¤š

æ’æŸ¥æ–¹æ³•ï¼š
1ï¸âƒ£ æŸ¥çœ‹é”ç­‰å¾…ï¼šSHOW ENGINE INNODB STATUS
2ï¸âƒ£ åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
3ï¸âƒ£ æ£€æŸ¥äº‹åŠ¡éš”ç¦»çº§åˆ«  
4ï¸âƒ£ å®¡æŸ¥èŒƒå›´æŸ¥è¯¢çš„SQL
5ï¸âƒ£ ç›‘æ§æ­»é”æ—¥å¿—
```

**ğŸ› ï¸ è§£å†³æ€è·¯**
```
immediate actions:
â€¢ æ€æ‰é•¿æ—¶é—´æŒæœ‰é”çš„äº‹åŠ¡
â€¢ ä¸´æ—¶è°ƒæ•´éš”ç¦»çº§åˆ«åˆ°RC
â€¢ ä¼˜åŒ–æŸ¥è¯¢æ¡ä»¶å‡å°‘é”èŒƒå›´

long-term solutions:
â€¢ é‡æ–°è®¾è®¡ç´¢å¼•ç­–ç•¥
â€¢ æ‹†åˆ†å¤§äº‹åŠ¡ä¸ºå°äº‹åŠ¡  
â€¢ å¼•å…¥ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›
â€¢ è€ƒè™‘åˆ†åº“åˆ†è¡¨é™ä½å•è¡¨å‹åŠ›
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é—´éš™é”ä¸é”è®°å½•é”ç©ºéš™ï¼Œé˜²æ­¢å¹»è¯»ä¿ä¸€è‡´
- èŒƒå›´æŸ¥è¯¢è§¦å‘é—´éš™é”ï¼Œæ’å…¥æ“ä½œä¼šé˜»å¡
- ä¼˜åŒ–ç´¢å¼•ç¼©çŸ­äº‹åŠ¡ï¼Œæ€§èƒ½æå‡æœ‰æŠ€å·§