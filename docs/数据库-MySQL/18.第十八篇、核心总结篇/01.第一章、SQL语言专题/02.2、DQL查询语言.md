---
title: 2ã€DQLæŸ¥è¯¢è¯­è¨€
---
## ğŸ“š ç›®å½•

1. [åŸºç¡€æŸ¥è¯¢è¯­å¥](#1-åŸºç¡€æŸ¥è¯¢è¯­å¥)
2. [æ¡ä»¶æŸ¥è¯¢WHERE](#2-æ¡ä»¶æŸ¥è¯¢WHERE)
3. [æ’åºæŸ¥è¯¢ORDER BY](#3-æ’åºæŸ¥è¯¢ORDER-BY)
4. [åˆ†ç»„æŸ¥è¯¢GROUP BY](#4-åˆ†ç»„æŸ¥è¯¢GROUP-BY)
5. [åˆ†ç»„è¿‡æ»¤HAVING](#5-åˆ†ç»„è¿‡æ»¤HAVING)
6. [å­æŸ¥è¯¢](#6-å­æŸ¥è¯¢)
7. [è¡¨è¿æ¥æŸ¥è¯¢](#7-è¡¨è¿æ¥æŸ¥è¯¢)
8. [è”åˆæŸ¥è¯¢UNION](#8-è”åˆæŸ¥è¯¢UNION)
9. [çª—å£å‡½æ•°æŸ¥è¯¢](#9-çª—å£å‡½æ•°æŸ¥è¯¢)
10. [å…¬ç”¨è¡¨è¡¨è¾¾å¼CTE](#10-å…¬ç”¨è¡¨è¡¨è¾¾å¼CTE)
11. [é«˜çº§æŸ¥è¯¢æŠ€å·§](#11-é«˜çº§æŸ¥è¯¢æŠ€å·§)
12. [æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#12-æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
13. [å®é™…ä¸šåŠ¡æŸ¥è¯¢æ¡ˆä¾‹](#13-å®é™…ä¸šåŠ¡æŸ¥è¯¢æ¡ˆä¾‹)
14. [æ•°æ®åˆ†ææŸ¥è¯¢](#14-æ•°æ®åˆ†ææŸ¥è¯¢)
15. [æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ](#15-æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ)
16. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#16-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åŸºç¡€æŸ¥è¯¢è¯­å¥


### 1.1 SELECTåŸºç¡€è¯­æ³•


**ä»€ä¹ˆæ˜¯SELECTæŸ¥è¯¢**ï¼šSELECTæ˜¯SQLä¸­æœ€é‡è¦çš„è¯­å¥ï¼Œå°±åƒä»å›¾ä¹¦é¦†æ‰¾ä¹¦ä¸€æ ·ï¼Œå‘Šè¯‰æ•°æ®åº“ä½ è¦ä»€ä¹ˆä¿¡æ¯ã€‚

```
æŸ¥è¯¢çš„åŸºæœ¬ç»“æ„ï¼š
SELECT è¦ä»€ä¹ˆå­—æ®µ
FROM   ä»å“ªä¸ªè¡¨
WHERE  æ»¡è¶³ä»€ä¹ˆæ¡ä»¶
```

#### SELECT * æŸ¥è¯¢æ‰€æœ‰å­—æ®µ


**æ¦‚å¿µå«ä¹‰**ï¼š`SELECT *` è¡¨ç¤ºé€‰æ‹©è¡¨ä¸­çš„æ‰€æœ‰åˆ—ï¼Œæ˜Ÿå·(*)æ˜¯é€šé…ç¬¦ã€‚

```sql
-- æŸ¥è¯¢ç”¨æˆ·è¡¨ä¸­æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯
SELECT * FROM users;
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **å¼€å‘è°ƒè¯•æ—¶**ï¼šå¿«é€ŸæŸ¥çœ‹è¡¨ç»“æ„å’Œæ•°æ®
- âœ… **æ•°æ®æ¢ç´¢æ—¶**ï¼šäº†è§£è¡¨ä¸­æœ‰å“ªäº›å­—æ®µ
- âŒ **ç”Ÿäº§ç¯å¢ƒ**ï¼šå½±å“æ€§èƒ½ï¼Œä¼ è¾“ä¸å¿…è¦çš„æ•°æ®

#### SELECT æŒ‡å®šå­—æ®µæŸ¥è¯¢


**ä¸ºä»€ä¹ˆè¦æŒ‡å®šå­—æ®µ**ï¼šå°±åƒç‚¹èœä¸€æ ·ï¼Œåªè¦è‡ªå·±éœ€è¦çš„ï¼Œä¸è¦å…¨éƒ¨ä¸Šé½ã€‚

```sql
-- åªæŸ¥è¯¢ç”¨æˆ·çš„å§“åå’Œé‚®ç®±
SELECT name, email FROM users;

-- æŸ¥è¯¢å•†å“çš„åç§°å’Œä»·æ ¼
SELECT product_name, price FROM products;
```

**å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **å‡å°‘ç½‘ç»œä¼ è¾“**ï¼šåªä¼ è¾“éœ€è¦çš„æ•°æ®
- **æé«˜æŸ¥è¯¢é€Ÿåº¦**ï¼šæ•°æ®åº“åªéœ€è¦è¯»å–æŒ‡å®šåˆ—
- **èŠ‚çœå†…å­˜**ï¼šåº”ç”¨ç¨‹åºå ç”¨æ›´å°‘å†…å­˜

### 1.2 å­—æ®µé€‰æ‹©ä¸è¡¨è¾¾å¼


#### DISTINCT å»é‡æŸ¥è¯¢


**ä»€ä¹ˆæ˜¯å»é‡**ï¼šå»é™¤æŸ¥è¯¢ç»“æœä¸­çš„é‡å¤è®°å½•ï¼Œå°±åƒæ•´ç†ç…§ç‰‡æ—¶åˆ é™¤é‡å¤çš„ç…§ç‰‡ã€‚

```sql
-- æŸ¥è¯¢æ‰€æœ‰ä¸é‡å¤çš„åŸå¸‚
SELECT DISTINCT city FROM users;

-- æŸ¥è¯¢æ‰€æœ‰ä¸é‡å¤çš„å•†å“ç±»åˆ«
SELECT DISTINCT category FROM products;

-- å¤šå­—æ®µç»„åˆå»é‡
SELECT DISTINCT city, age FROM users;
```

**å»é‡åŸç†**ï¼š
```
åŸå§‹æ•°æ®ï¼š              å»é‡åï¼š
åŒ—äº¬                   åŒ—äº¬
ä¸Šæµ·                   ä¸Šæµ·  
åŒ—äº¬          â†’        å¹¿å·
å¹¿å·
ä¸Šæµ·
```

#### å­—æ®µåˆ«å(AS)


**ä¸ºä»€ä¹ˆè¦ç”¨åˆ«å**ï¼šç»™å­—æ®µèµ·ä¸ªå¥½è®°çš„åå­—ï¼Œå°±åƒç»™æ–‡ä»¶å¤¹é‡å‘½åä¸€æ ·ã€‚

```sql
-- ç»™å­—æ®µèµ·åˆ«å
SELECT name AS ç”¨æˆ·å, email AS é‚®ç®± FROM users;

-- è®¡ç®—å­—æ®µåˆ«å
SELECT price * quantity AS total_amount FROM order_items;

-- ASå¯ä»¥çœç•¥
SELECT name ç”¨æˆ·å, email é‚®ç®± FROM users;
```

#### è¡¨åˆ«å


**è¡¨åˆ«åçš„ä½œç”¨**ï¼šç»™è¡¨èµ·ç®€çŸ­çš„åå­—ï¼Œç‰¹åˆ«æ˜¯å¤šè¡¨æŸ¥è¯¢æ—¶å¾ˆæœ‰ç”¨ã€‚

```sql
-- è¡¨åˆ«ååŸºæœ¬ç”¨æ³•
SELECT u.name, u.email 
FROM users AS u;

-- å¤šè¡¨æŸ¥è¯¢ä¸­çš„è¡¨åˆ«å
SELECT u.name, o.order_date
FROM users u, orders o
WHERE u.id = o.user_id;
```

### 1.3 å­—æ®µè¡¨è¾¾å¼è®¡ç®—


#### å¸¸é‡å­—æ®µ


**ä»€ä¹ˆæ˜¯å¸¸é‡å­—æ®µ**ï¼šåœ¨æŸ¥è¯¢ç»“æœä¸­æ·»åŠ å›ºå®šå€¼ï¼Œå°±åƒåœ¨è¡¨æ ¼ä¸­åŠ ä¸€åˆ—å¤‡æ³¨ã€‚

```sql
-- æ·»åŠ å¸¸é‡å­—æ®µ
SELECT name, 'VIPå®¢æˆ·' AS customer_type 
FROM users 
WHERE points > 1000;

-- æ•°å­—å¸¸é‡
SELECT product_name, price, 0.1 AS tax_rate 
FROM products;
```

#### è®¡ç®—å­—æ®µ


**å­—æ®µè¿ç®—çš„æ„ä¹‰**ï¼šå¯¹æ•°æ®è¿›è¡Œè®¡ç®—å¤„ç†ï¼Œå¾—åˆ°æ–°çš„æœ‰æ„ä¹‰çš„ä¿¡æ¯ã€‚

```sql
-- åŸºæœ¬æ•°å­¦è¿ç®—
SELECT 
    product_name,
    price,
    price * 0.8 AS discounted_price,
    price - (price * 0.8) AS discount_amount
FROM products;

-- å­—ç¬¦ä¸²æ‹¼æ¥
SELECT 
    CONCAT(first_name, ' ', last_name) AS full_name,
    CONCAT('ç”¨æˆ·ID: ', id) AS user_info
FROM users;
```

**å®ç”¨è®¡ç®—ç¤ºä¾‹**ï¼š
```sql
-- è®¡ç®—è®¢å•æ€»é‡‘é¢
SELECT 
    order_id,
    quantity,
    unit_price,
    quantity * unit_price AS line_total,
    quantity * unit_price * 1.1 AS total_with_tax
FROM order_items;
```

### 1.4 ç»“æœæ§åˆ¶


#### LIMIT é™åˆ¶ç»“æœæ•°é‡


**ä¸ºä»€ä¹ˆè¦é™åˆ¶ç»“æœ**ï¼šå°±åƒçœ‹æ–°é—»åªçœ‹å¤´æ¡ä¸€æ ·ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ã€‚

```sql
-- æŸ¥è¯¢å‰10ä¸ªç”¨æˆ·
SELECT * FROM users LIMIT 10;

-- è·³è¿‡å‰20æ¡ï¼Œå–10æ¡ï¼ˆåˆ†é¡µæŸ¥è¯¢ï¼‰
SELECT * FROM users LIMIT 20, 10;

-- æ ‡å‡†SQLå†™æ³•ï¼ˆMySQL 8.0+æ¨èï¼‰
SELECT * FROM users LIMIT 10 OFFSET 20;
```

**åˆ†é¡µæŸ¥è¯¢åº”ç”¨**ï¼š
```sql
-- ç¬¬ä¸€é¡µï¼šæ˜¾ç¤ºå‰10æ¡
SELECT * FROM products ORDER BY id LIMIT 10;

-- ç¬¬äºŒé¡µï¼šè·³è¿‡å‰10æ¡ï¼Œå†å–10æ¡
SELECT * FROM products ORDER BY id LIMIT 10 OFFSET 10;

-- ç¬¬ä¸‰é¡µï¼šè·³è¿‡å‰20æ¡ï¼Œå†å–10æ¡
SELECT * FROM products ORDER BY id LIMIT 10 OFFSET 20;
```

---

## 2. â“ æ¡ä»¶æŸ¥è¯¢WHERE


### 2.1 åŸºç¡€æ¡ä»¶æŸ¥è¯¢


**WHEREå­å¥çš„ä½œç”¨**ï¼šå°±åƒç­›é€‰å™¨ï¼Œåªè®©ç¬¦åˆæ¡ä»¶çš„æ•°æ®é€šè¿‡ã€‚

```
æ•°æ®ç­›é€‰è¿‡ç¨‹ï¼š
æ‰€æœ‰æ•°æ® â†’ WHEREæ¡ä»¶ â†’ ç¬¦åˆæ¡ä»¶çš„æ•°æ®

ä¾‹å¦‚ï¼š1000ä¸ªç”¨æˆ· â†’ WHERE age > 18 â†’ 800ä¸ªæˆå¹´ç”¨æˆ·
```

#### æ¯”è¾ƒæ“ä½œç¬¦


**ç­‰å€¼æŸ¥è¯¢(=)**ï¼šæŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„è®°å½•ã€‚

```sql
-- æŸ¥æ‰¾ç‰¹å®šå¹´é¾„çš„ç”¨æˆ·
SELECT * FROM users WHERE age = 25;

-- æŸ¥æ‰¾ç‰¹å®šåŸå¸‚çš„ç”¨æˆ·
SELECT * FROM users WHERE city = 'åŒ—äº¬';

-- æŸ¥æ‰¾ç‰¹å®šçŠ¶æ€çš„è®¢å•
SELECT * FROM orders WHERE status = 'completed';
```

**ä¸ç­‰å€¼æŸ¥è¯¢(!= å’Œ <>)**ï¼šæŸ¥æ‰¾ä¸åŒ¹é…çš„è®°å½•ã€‚

```sql
-- æŸ¥æ‰¾éåŒ—äº¬ç”¨æˆ·ï¼ˆä¸¤ç§å†™æ³•ç­‰ä»·ï¼‰
SELECT * FROM users WHERE city != 'åŒ—äº¬';
SELECT * FROM users WHERE city <> 'åŒ—äº¬';

-- æŸ¥æ‰¾æœªå®Œæˆçš„è®¢å•
SELECT * FROM orders WHERE status != 'completed';
```

**å¤§å°æ¯”è¾ƒæŸ¥è¯¢**ï¼šæ•°å€¼å’Œæ—¥æœŸæ¯”è¾ƒã€‚

```sql
-- å¹´é¾„å¤§äº18å²çš„ç”¨æˆ·
SELECT * FROM users WHERE age > 18;

-- ä»·æ ¼åœ¨100å…ƒä»¥ä¸Šçš„å•†å“
SELECT * FROM products WHERE price >= 100;

-- æœ€è¿‘ä¸€å‘¨çš„è®¢å•
SELECT * FROM orders 
WHERE created_date >= DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 2.2 é€»è¾‘æ¡ä»¶ç»„åˆ


#### AND é€»è¾‘ä¸


**ANDçš„å«ä¹‰**ï¼šæ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³ï¼Œå°±åƒè€ƒè¯•æ‰€æœ‰ç§‘ç›®éƒ½è¦åŠæ ¼ã€‚

```sql
-- å¹´é¾„åœ¨18-60ä¹‹é—´çš„åŒ—äº¬ç”¨æˆ·
SELECT * FROM users 
WHERE age >= 18 AND age <= 60 AND city = 'åŒ—äº¬';

-- ä»·æ ¼åœ¨100-500ä¹‹é—´çš„åœ¨å”®å•†å“
SELECT * FROM products 
WHERE price >= 100 AND price <= 500 AND status = 'active';
```

#### OR é€»è¾‘æˆ–


**ORçš„å«ä¹‰**ï¼šä»»ä¸€æ¡ä»¶æ»¡è¶³å³å¯ï¼Œå°±åƒå¤šä¸ªå…¥å­¦æ¡ä»¶æ»¡è¶³å…¶ä¸­ä¸€ä¸ªå°±è¡Œã€‚

```sql
-- åŒ—äº¬æˆ–ä¸Šæµ·çš„ç”¨æˆ·
SELECT * FROM users 
WHERE city = 'åŒ—äº¬' OR city = 'ä¸Šæµ·';

-- VIPç”¨æˆ·æˆ–æ¶ˆè´¹é‡‘é¢å¤§äº10000çš„ç”¨æˆ·
SELECT * FROM users 
WHERE vip_level = 'gold' OR total_spent > 10000;
```

#### NOT é€»è¾‘é


**NOTçš„å«ä¹‰**ï¼šæ’é™¤æ»¡è¶³æ¡ä»¶çš„è®°å½•ã€‚

```sql
-- éåŒ—äº¬ç”¨æˆ·
SELECT * FROM users WHERE NOT city = 'åŒ—äº¬';

-- æœªåˆ é™¤çš„å•†å“
SELECT * FROM products WHERE NOT status = 'deleted';
```

#### æ¡ä»¶åˆ†ç»„()


**æ‹¬å·çš„é‡è¦æ€§**ï¼šæ”¹å˜æ¡ä»¶ä¼˜å…ˆçº§ï¼Œå°±åƒæ•°å­¦è¿ç®—ä¸­çš„æ‹¬å·ã€‚

```sql
-- é”™è¯¯çš„é€»è¾‘ï¼šå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ç»“æœ
SELECT * FROM users 
WHERE age > 18 AND city = 'åŒ—äº¬' OR city = 'ä¸Šæµ·';

-- æ­£ç¡®çš„åˆ†ç»„ï¼šå…ˆåˆ¤æ–­åŸå¸‚ï¼Œå†åˆ¤æ–­å¹´é¾„
SELECT * FROM users 
WHERE age > 18 AND (city = 'åŒ—äº¬' OR city = 'ä¸Šæµ·');
```

### 2.3 èŒƒå›´ä¸é›†åˆæŸ¥è¯¢


#### BETWEEN èŒƒå›´æŸ¥è¯¢


**BETWEENçš„å«ä¹‰**ï¼šåœ¨æŸä¸ªèŒƒå›´å†…ï¼ŒåŒ…å«è¾¹ç•Œå€¼ã€‚

```sql
-- ä»·æ ¼åœ¨100åˆ°500ä¹‹é—´çš„å•†å“ï¼ˆåŒ…å«100å’Œ500ï¼‰
SELECT * FROM products 
WHERE price BETWEEN 100 AND 500;

-- æœ€è¿‘ä¸€ä¸ªæœˆçš„è®¢å•
SELECT * FROM orders 
WHERE created_date BETWEEN '2024-01-01' AND '2024-01-31';

-- NOT BETWEENï¼šæ’é™¤æŸä¸ªèŒƒå›´
SELECT * FROM products 
WHERE price NOT BETWEEN 100 AND 500;
```

**BETWEEN vs å¤§å°æ¯”è¾ƒ**ï¼š
```sql
-- ä»¥ä¸‹ä¸¤ä¸ªæŸ¥è¯¢ç­‰ä»·
SELECT * FROM products WHERE price BETWEEN 100 AND 500;
SELECT * FROM products WHERE price >= 100 AND price <= 500;
```

#### IN é›†åˆæŸ¥è¯¢


**INçš„å«ä¹‰**ï¼šåœ¨æŒ‡å®šçš„å€¼åˆ—è¡¨ä¸­ï¼Œç±»ä¼¼äºå¤šä¸ªORæ¡ä»¶ã€‚

```sql
-- æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„ç”¨æˆ·
SELECT * FROM users 
WHERE city IN ('åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³');

-- æŸ¥è¯¢ç‰¹å®šçŠ¶æ€çš„è®¢å•
SELECT * FROM orders 
WHERE status IN ('pending', 'processing', 'shipped');

-- NOT INï¼šä¸åœ¨æŒ‡å®šåˆ—è¡¨ä¸­
SELECT * FROM users 
WHERE city NOT IN ('åŒ—äº¬', 'ä¸Šæµ·');
```

**IN vs ORæ¯”è¾ƒ**ï¼š
```sql
-- ä»¥ä¸‹ä¸¤ä¸ªæŸ¥è¯¢ç­‰ä»·ï¼Œä½†INæ›´ç®€æ´
SELECT * FROM users WHERE city IN ('åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·');
SELECT * FROM users WHERE city = 'åŒ—äº¬' OR city = 'ä¸Šæµ·' OR city = 'å¹¿å·';
```

### 2.4 æ¨¡ç³ŠæŸ¥è¯¢


#### LIKE æ¨¡ç³ŠåŒ¹é…


**LIKEçš„ä½œç”¨**ï¼šæ¨¡ç³ŠæŸ¥æ‰¾ï¼Œæ”¯æŒé€šé…ç¬¦åŒ¹é…ã€‚

**é€šé…ç¬¦è¯´æ˜**ï¼š
- `%`ï¼šè¡¨ç¤ºä»»æ„é•¿åº¦çš„ä»»æ„å­—ç¬¦ï¼ˆåŒ…æ‹¬0ä¸ªå­—ç¬¦ï¼‰
- `_`ï¼šè¡¨ç¤ºå•ä¸ªä»»æ„å­—ç¬¦

```sql
-- å‰ç¼€åŒ¹é…ï¼šå§“å¼ çš„ç”¨æˆ·
SELECT * FROM users WHERE name LIKE 'å¼ %';

-- åç¼€åŒ¹é…ï¼šé‚®ç®±æ˜¯gmailçš„ç”¨æˆ·
SELECT * FROM users WHERE email LIKE '%@gmail.com';

-- åŒ…å«åŒ¹é…ï¼šåå­—ä¸­åŒ…å«"å°"çš„ç”¨æˆ·
SELECT * FROM users WHERE name LIKE '%å°%';

-- å•å­—ç¬¦åŒ¹é…ï¼šå§“æä¸”åå­—åªæœ‰ä¸¤ä¸ªå­—çš„ç”¨æˆ·
SELECT * FROM users WHERE name LIKE 'æ_';
```

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```sql
-- æœç´¢åŠŸèƒ½ï¼šæ ¹æ®å…³é”®è¯æœç´¢å•†å“
SELECT * FROM products 
WHERE product_name LIKE '%æ‰‹æœº%' 
   OR product_name LIKE '%ç”µè„‘%';

-- æ•°æ®æ¸…ç†ï¼šæŸ¥æ‰¾å¯èƒ½çš„é‡å¤æ•°æ®
SELECT * FROM users 
WHERE phone LIKE '138%' AND LENGTH(phone) = 11;
```

#### REGEXP æ­£åˆ™è¡¨è¾¾å¼


**æ­£åˆ™è¡¨è¾¾å¼çš„ä¼˜åŠ¿**ï¼šæ›´å¼ºå¤§çš„æ¨¡å¼åŒ¹é…èƒ½åŠ›ã€‚

```sql
-- åŒ¹é…ä»¥å¤§å†™å­—æ¯å¼€å¤´çš„å§“å
SELECT * FROM users WHERE name REGEXP '^[A-Z]';

-- åŒ¹é…11ä½æ•°å­—çš„æ‰‹æœºå·
SELECT * FROM users WHERE phone REGEXP '^[0-9]{11}$';

-- åŒ¹é…é‚®ç®±æ ¼å¼
SELECT * FROM users 
WHERE email REGEXP '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$';
```

### 2.5 ç©ºå€¼æŸ¥è¯¢


#### IS NULL ç©ºå€¼å¤„ç†


**ç©ºå€¼çš„å«ä¹‰**ï¼šNULLè¡¨ç¤º"æœªçŸ¥"æˆ–"æ— å€¼"ï¼Œä¸åŒäºç©ºå­—ç¬¦ä¸²''æˆ–æ•°å­—0ã€‚

```sql
-- æŸ¥è¯¢æ²¡æœ‰å¡«å†™ç”µè¯çš„ç”¨æˆ·
SELECT * FROM users WHERE phone IS NULL;

-- æŸ¥è¯¢å¡«å†™äº†ç”µè¯çš„ç”¨æˆ·
SELECT * FROM users WHERE phone IS NOT NULL;

-- æŸ¥è¯¢æ²¡æœ‰åˆ†ç±»çš„å•†å“
SELECT * FROM products WHERE category_id IS NULL;
```

**ç©ºå€¼åˆ¤æ–­æ³¨æ„äº‹é¡¹**ï¼š
```sql
-- é”™è¯¯ï¼šæ— æ³•æ‰¾åˆ°NULLå€¼
SELECT * FROM users WHERE phone = NULL;

-- æ­£ç¡®ï¼šä½¿ç”¨IS NULL
SELECT * FROM users WHERE phone IS NULL;

-- ç©ºå€¼åœ¨æ¡ä»¶ä¸­çš„è¡Œä¸º
SELECT * FROM users WHERE age > 18;  -- NULL ageä¸ä¼šè¢«åŒ…å«åœ¨ç»“æœä¸­
```

---

## 3. ğŸ“Š æ’åºæŸ¥è¯¢ORDER BY


### 3.1 åŸºç¡€æ’åº


**æ’åºçš„ä½œç”¨**ï¼šæŒ‰æŒ‡å®šè§„åˆ™æ’åˆ—æŸ¥è¯¢ç»“æœï¼Œå°±åƒæ•´ç†ä¹¦æ¶æŒ‰å­—æ¯é¡ºåºæ’åˆ—ã€‚

#### ASC å‡åºæ’åº


**å‡åºæ’åº**ï¼šä»å°åˆ°å¤§ã€ä»æ—©åˆ°æ™šã€ä»Aåˆ°Zçš„é¡ºåºã€‚

```sql
-- æŒ‰å¹´é¾„å‡åºæ’åˆ—ï¼ˆé»˜è®¤å°±æ˜¯å‡åºï¼‰
SELECT * FROM users ORDER BY age;
SELECT * FROM users ORDER BY age ASC;

-- æŒ‰åˆ›å»ºæ—¶é—´å‡åºï¼ˆæœ€æ—©çš„åœ¨å‰ï¼‰
SELECT * FROM orders ORDER BY created_date ASC;

-- æŒ‰ä»·æ ¼å‡åº
SELECT * FROM products ORDER BY price ASC;
```

#### DESC é™åºæ’åº


**é™åºæ’åº**ï¼šä»å¤§åˆ°å°ã€ä»æ™šåˆ°æ—©ã€ä»Zåˆ°Açš„é¡ºåºã€‚

```sql
-- æŒ‰è–ªèµ„é™åºæ’åˆ—ï¼ˆæœ€é«˜è–ªèµ„åœ¨å‰ï¼‰
SELECT * FROM employees ORDER BY salary DESC;

-- æŒ‰è®¢å•é‡‘é¢é™åºï¼ˆå¤§è®¢å•åœ¨å‰ï¼‰
SELECT * FROM orders ORDER BY total_amount DESC;

-- æŒ‰è¯„åˆ†é™åºï¼ˆé«˜è¯„åˆ†åœ¨å‰ï¼‰
SELECT * FROM products ORDER BY rating DESC;
```

### 3.2 å¤šå­—æ®µæ’åº


**å¤šå­—æ®µæ’åºçš„æ„ä¹‰**ï¼šå…ˆæŒ‰ç¬¬ä¸€ä¸ªå­—æ®µæ’åºï¼Œç›¸åŒçš„å†æŒ‰ç¬¬äºŒä¸ªå­—æ®µæ’åºã€‚

```sql
-- å…ˆæŒ‰éƒ¨é—¨åˆ†ç»„ï¼ŒåŒéƒ¨é—¨å†…æŒ‰è–ªèµ„é™åº
SELECT * FROM employees 
ORDER BY department ASC, salary DESC;

-- å…ˆæŒ‰åˆ›å»ºæ—¥æœŸï¼ŒåŒä¸€å¤©çš„æŒ‰é‡‘é¢é™åº
SELECT * FROM orders 
ORDER BY DATE(created_date), total_amount DESC;

-- å…ˆæŒ‰åŸå¸‚ï¼ŒåŒåŸå¸‚æŒ‰å¹´é¾„ï¼ŒåŒå¹´é¾„æŒ‰å§“å
SELECT * FROM users 
ORDER BY city, age DESC, name ASC;
```

**æ’åºä¼˜å…ˆçº§ç¤ºä¾‹**ï¼š
```
åŸå§‹æ•°æ®ï¼š              æ’åºç»“æœï¼ˆéƒ¨é—¨ASCï¼Œè–ªèµ„DESCï¼‰ï¼š
å¼ ä¸‰ ç ”å‘éƒ¨ 8000      â†’   æå›› äººäº‹éƒ¨ 6000
æå›› äººäº‹éƒ¨ 6000          ç‹äº” äººäº‹éƒ¨ 5000  
ç‹äº” äººäº‹éƒ¨ 5000          å¼ ä¸‰ ç ”å‘éƒ¨ 8000
èµµå…­ ç ”å‘éƒ¨ 7000          èµµå…­ ç ”å‘éƒ¨ 7000
```

### 3.3 è¡¨è¾¾å¼æ’åº


#### è®¡ç®—å­—æ®µæ’åº


**è¡¨è¾¾å¼æ’åºçš„åº”ç”¨**ï¼šåŸºäºè®¡ç®—ç»“æœè¿›è¡Œæ’åºã€‚

```sql
-- æŒ‰æŠ˜æ‰£ä»·æ’åº
SELECT product_name, price, price * 0.8 AS discounted_price
FROM products 
ORDER BY price * 0.8 DESC;

-- æŒ‰æ€»é‡‘é¢æ’åº
SELECT order_id, quantity, unit_price
FROM order_items
ORDER BY quantity * unit_price DESC;
```

#### å‡½æ•°æ’åº


**å‡½æ•°æ’åºçš„ç”¨é€”**ï¼šä½¿ç”¨å‡½æ•°å¤„ç†åçš„ç»“æœæ’åºã€‚

```sql
-- æŒ‰å§“åé•¿åº¦æ’åº
SELECT name FROM users 
ORDER BY CHAR_LENGTH(name) DESC;

-- æŒ‰æœˆä»½æ’åº
SELECT * FROM orders 
ORDER BY MONTH(created_date), DAY(created_date);

-- æŒ‰æœ€åæ›´æ–°æ—¶é—´æ’åº
SELECT * FROM products 
ORDER BY UNIX_TIMESTAMP(updated_at) DESC;
```

#### FIELD è‡ªå®šä¹‰æ’åº


**è‡ªå®šä¹‰æ’åºé¡ºåº**ï¼šæŒ‰ä¸šåŠ¡é€»è¾‘å®šä¹‰çš„é¡ºåºæ’åºã€‚

```sql
-- æŒ‰è®¢å•çŠ¶æ€çš„ä¸šåŠ¡ä¼˜å…ˆçº§æ’åº
SELECT * FROM orders 
ORDER BY FIELD(status, 'pending', 'processing', 'shipped', 'completed', 'cancelled');

-- æŒ‰é‡è¦æ€§æ’åº
SELECT * FROM tasks 
ORDER BY FIELD(priority, 'high', 'medium', 'low');

-- æŒ‰å‘¨å‡ æ’åºï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
SELECT * FROM schedules 
ORDER BY FIELD(day_name, 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥');
```

### 3.4 ç©ºå€¼æ’åºå¤„ç†


**ç©ºå€¼æ’åºè¡Œä¸º**ï¼šMySQLä¸­NULLå€¼åœ¨å‡åºæ—¶æ’åœ¨æœ€å‰é¢ï¼Œé™åºæ—¶æ’åœ¨æœ€åé¢ã€‚

```sql
-- æ§åˆ¶NULLå€¼çš„æ’åºä½ç½®
SELECT name, phone FROM users 
ORDER BY phone IS NULL, phone;

-- è®©æœ‰ç”µè¯å·ç çš„ç”¨æˆ·æ’åœ¨å‰é¢
SELECT name, phone FROM users 
ORDER BY phone IS NULL ASC, phone ASC;
```

**ç©ºå€¼æ’åºç­–ç•¥**ï¼š
```sql
-- æ–¹æ³•1ï¼šä½¿ç”¨IFNULLå¤„ç†ç©ºå€¼
SELECT name, IFNULL(phone, 'æ— ç”µè¯') AS phone_display
FROM users 
ORDER BY IFNULL(phone, 'zzzz');

-- æ–¹æ³•2ï¼šä½¿ç”¨COALESCEå¤„ç†ç©ºå€¼
SELECT name, COALESCE(phone, 'æ— ç”µè¯') AS phone_display
FROM users 
ORDER BY COALESCE(phone, 'zzzz');
```

---

## 4. ğŸ“ˆ åˆ†ç»„æŸ¥è¯¢GROUP BY


### 4.1 åŸºç¡€åˆ†ç»„æ¦‚å¿µ


**åˆ†ç»„çš„å«ä¹‰**ï¼šå°†å…·æœ‰ç›¸åŒç‰¹å¾çš„æ•°æ®å½’ä¸ºä¸€ç»„ï¼Œå°±åƒæŠŠå­¦ç”ŸæŒ‰ç­çº§åˆ†ç»„ã€‚

```
åˆ†ç»„è¿‡ç¨‹ç¤ºæ„ï¼š
åŸå§‹æ•°æ®ï¼š              åˆ†ç»„åï¼š
å¼ ä¸‰ åŒ—äº¬ 25           åŒ—äº¬ç»„: å¼ ä¸‰(25), æå››(30)
æå›› åŒ—äº¬ 30     â†’     ä¸Šæµ·ç»„: ç‹äº”(28)  
ç‹äº” ä¸Šæµ· 28           å¹¿å·ç»„: èµµå…­(35)
èµµå…­ å¹¿å· 35
```

### 4.2 åŸºç¡€åˆ†ç»„æŸ¥è¯¢


#### ç®€å•åˆ†ç»„ç»Ÿè®¡


**COUNT() è®¡æ•°ç»Ÿè®¡**ï¼šç»Ÿè®¡æ¯ç»„æœ‰å¤šå°‘æ¡è®°å½•ã€‚

```sql
-- ç»Ÿè®¡æ¯ä¸ªåŸå¸‚æœ‰å¤šå°‘ç”¨æˆ·
SELECT city, COUNT(*) AS user_count
FROM users 
GROUP BY city;

-- ç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨æœ‰å¤šå°‘å‘˜å·¥
SELECT department, COUNT(*) AS employee_count
FROM employees 
GROUP BY department;

-- ç»Ÿè®¡æ¯ç§å•†å“ç±»åˆ«æœ‰å¤šå°‘å•†å“
SELECT category, COUNT(*) AS product_count
FROM products 
GROUP BY category;
```

#### AVG() å¹³å‡å€¼ç»Ÿè®¡


**å¹³å‡å€¼çš„æ„ä¹‰**ï¼šäº†è§£æ¯ç»„çš„å¹³å‡æ°´å¹³ã€‚

```sql
-- è®¡ç®—æ¯ä¸ªåŸå¸‚ç”¨æˆ·çš„å¹³å‡å¹´é¾„
SELECT city, AVG(age) AS avg_age
FROM users 
GROUP BY city;

-- è®¡ç®—æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡è–ªèµ„
SELECT department, AVG(salary) AS avg_salary
FROM employees 
GROUP BY department;

-- è®¡ç®—æ¯ä¸ªç±»åˆ«å•†å“çš„å¹³å‡ä»·æ ¼
SELECT category, AVG(price) AS avg_price
FROM products 
GROUP BY category;
```

### 4.3 å¤šå­—æ®µåˆ†ç»„


**å¤šå­—æ®µåˆ†ç»„çš„åº”ç”¨**ï¼šæŒ‰å¤šä¸ªç»´åº¦è¿›è¡Œç»†åˆ†ç»Ÿè®¡ã€‚

```sql
-- æŒ‰éƒ¨é—¨å’ŒèŒä½åˆ†ç»„ç»Ÿè®¡
SELECT 
    department, 
    position, 
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary
FROM employees 
GROUP BY department, position;

-- æŒ‰å¹´æœˆåˆ†ç»„ç»Ÿè®¡è®¢å•
SELECT 
    YEAR(order_date) AS order_year,
    MONTH(order_date) AS order_month,
    COUNT(*) AS order_count,
    SUM(total_amount) AS monthly_sales
FROM orders 
GROUP BY YEAR(order_date), MONTH(order_date)
ORDER BY order_year, order_month;
```

**æ—¶é—´åˆ†ç»„çš„å®ç”¨æŠ€å·§**ï¼š
```sql
-- æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆå»é™¤æ—¶é—´éƒ¨åˆ†ï¼‰
SELECT 
    DATE(created_at) AS order_date,
    COUNT(*) AS daily_orders
FROM orders 
GROUP BY DATE(created_at);

-- æŒ‰å°æ—¶åˆ†ç»„ï¼ˆåˆ†æè®¿é—®é«˜å³°ï¼‰
SELECT 
    HOUR(visit_time) AS visit_hour,
    COUNT(*) AS visit_count
FROM page_visits 
GROUP BY HOUR(visit_time)
ORDER BY visit_hour;
```

### 4.4 èšåˆå‡½æ•°è¯¦è§£


#### SUM() æ±‚å’Œç»Ÿè®¡


**æ±‚å’Œçš„åº”ç”¨åœºæ™¯**ï¼šè®¡ç®—æ€»é‡‘é¢ã€æ€»æ•°é‡ç­‰ã€‚

```sql
-- è®¡ç®—æ¯ä¸ªé”€å”®å‘˜çš„æ€»ä¸šç»©
SELECT 
    salesperson_id,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_sales
FROM orders 
GROUP BY salesperson_id;

-- è®¡ç®—æ¯ä¸ªå•†å“ç±»åˆ«çš„åº“å­˜æ€»é‡
SELECT 
    category,
    SUM(stock_quantity) AS total_stock
FROM products 
GROUP BY category;
```

#### MIN() å’Œ MAX() æœ€å€¼ç»Ÿè®¡


**æœ€å€¼ç»Ÿè®¡çš„æ„ä¹‰**ï¼šäº†è§£æ¯ç»„çš„æå€¼æƒ…å†µã€‚

```sql
-- æ¯ä¸ªéƒ¨é—¨çš„è–ªèµ„èŒƒå›´
SELECT 
    department,
    MIN(salary) AS min_salary,
    MAX(salary) AS max_salary,
    MAX(salary) - MIN(salary) AS salary_range
FROM employees 
GROUP BY department;

-- æ¯ä¸ªç”¨æˆ·çš„é¦–æ¬¡å’Œæœ€è¿‘è´­ä¹°æ—¶é—´
SELECT 
    user_id,
    MIN(order_date) AS first_order,
    MAX(order_date) AS latest_order,
    COUNT(*) AS total_orders
FROM orders 
GROUP BY user_id;
```

#### ç»¼åˆç»Ÿè®¡åº”ç”¨


**å¤šæŒ‡æ ‡ç»¼åˆåˆ†æ**ï¼šä¸€æ¬¡æŸ¥è¯¢è·å¾—å¤šç§ç»Ÿè®¡ä¿¡æ¯ã€‚

```sql
-- å•†å“ç±»åˆ«ç»¼åˆåˆ†æ
SELECT 
    category,
    COUNT(*) AS product_count,
    AVG(price) AS avg_price,
    MIN(price) AS min_price,
    MAX(price) AS max_price,
    SUM(stock_quantity) AS total_stock
FROM products 
GROUP BY category
HAVING COUNT(*) >= 5  -- åªæ˜¾ç¤ºå•†å“æ•°é‡>=5çš„ç±»åˆ«
ORDER BY avg_price DESC;
```

### 4.5 åˆ†ç»„ç»“æœæ’åº


**åˆ†ç»„æ’åºçš„é‡è¦æ€§**ï¼šè®©åˆ†ç»„ç»“æœæ›´æœ‰æ„ä¹‰ã€‚

```sql
-- æŒ‰éƒ¨é—¨äººæ•°é™åºæ’åˆ—
SELECT 
    department, 
    COUNT(*) AS employee_count
FROM employees 
GROUP BY department
ORDER BY employee_count DESC;

-- æŒ‰é”€å”®é¢æ’åºæ‰¾å‡ºTOPé”€å”®å‘˜
SELECT 
    salesperson_name,
    SUM(order_amount) AS total_sales
FROM sales 
GROUP BY salesperson_name
ORDER BY total_sales DESC
LIMIT 10;
```

---

## 5. ğŸ” åˆ†ç»„è¿‡æ»¤HAVING


### 5.1 HAVINGä¸WHEREçš„åŒºåˆ«


**æ ¹æœ¬åŒºåˆ«**ï¼šWHEREè¿‡æ»¤è¡Œæ•°æ®ï¼ŒHAVINGè¿‡æ»¤åˆ†ç»„ç»“æœã€‚

```
æŸ¥è¯¢æ‰§è¡Œé¡ºåºï¼š
1. FROM é€‰æ‹©è¡¨
2. WHERE è¿‡æ»¤è¡Œ
3. GROUP BY åˆ†ç»„
4. HAVING è¿‡æ»¤åˆ†ç»„
5. SELECT é€‰æ‹©å­—æ®µ  
6. ORDER BY æ’åº
```

**å¯¹æ¯”ç¤ºä¾‹**ï¼š
```sql
-- WHEREï¼šå…ˆè¿‡æ»¤ï¼Œå†åˆ†ç»„
SELECT city, COUNT(*) 
FROM users 
WHERE age >= 18          -- å…ˆè¿‡æ»¤å‡ºæˆå¹´ç”¨æˆ·
GROUP BY city            -- å†æŒ‰åŸå¸‚åˆ†ç»„ç»Ÿè®¡
HAVING COUNT(*) > 10;    -- æœ€ååªæ˜¾ç¤ºç”¨æˆ·æ•°>10çš„åŸå¸‚

-- å¦‚æœæ²¡æœ‰WHEREï¼Œä¼šåŒ…å«æ‰€æœ‰å¹´é¾„æ®µç”¨æˆ·
SELECT city, COUNT(*) 
FROM users 
GROUP BY city
HAVING COUNT(*) > 10;    -- ç»Ÿè®¡æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…å«æœªæˆå¹´ï¼‰
```

### 5.2 åŸºç¡€HAVINGè¿‡æ»¤


#### èšåˆç»“æœè¿‡æ»¤


**COUNT() è¿‡æ»¤**ï¼šç­›é€‰å‡ºè®°å½•æ•°æ»¡è¶³æ¡ä»¶çš„åˆ†ç»„ã€‚

```sql
-- æ‰¾å‡ºå‘˜å·¥äººæ•°è¶…è¿‡5äººçš„éƒ¨é—¨
SELECT department, COUNT(*) AS employee_count
FROM employees 
GROUP BY department
HAVING COUNT(*) > 5;

-- æ‰¾å‡ºè®¢å•æ•°é‡è¶…è¿‡100çš„å®¢æˆ·
SELECT customer_id, COUNT(*) AS order_count
FROM orders 
GROUP BY customer_id
HAVING COUNT(*) > 100;
```

**AVG() è¿‡æ»¤**ï¼šç­›é€‰å¹³å‡å€¼æ»¡è¶³æ¡ä»¶çš„åˆ†ç»„ã€‚

```sql
-- æ‰¾å‡ºå¹³å‡è–ªèµ„è¶…è¿‡8000çš„éƒ¨é—¨
SELECT department, AVG(salary) AS avg_salary
FROM employees 
GROUP BY department
HAVING AVG(salary) > 8000;

-- æ‰¾å‡ºå¹³å‡è¯„åˆ†è¶…è¿‡4.5çš„å•†å“ç±»åˆ«
SELECT category, AVG(rating) AS avg_rating
FROM products 
GROUP BY category
HAVING AVG(rating) > 4.5;
```

**SUM() è¿‡æ»¤**ï¼šç­›é€‰æ€»å’Œæ»¡è¶³æ¡ä»¶çš„åˆ†ç»„ã€‚

```sql
-- æ‰¾å‡ºæ€»é”€å”®é¢è¶…è¿‡100ä¸‡çš„é”€å”®åŒºåŸŸ
SELECT region, SUM(sales_amount) AS total_sales
FROM sales 
GROUP BY region
HAVING SUM(sales_amount) > 1000000;
```

### 5.3 å¤æ‚HAVINGæ¡ä»¶


#### å¤šæ¡ä»¶ç»„åˆ


**ANDæ¡ä»¶ç»„åˆ**ï¼šå¤šä¸ªèšåˆæ¡ä»¶åŒæ—¶æ»¡è¶³ã€‚

```sql
-- éƒ¨é—¨äººæ•°>5ä¸”å¹³å‡è–ªèµ„>8000çš„éƒ¨é—¨
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary
FROM employees 
GROUP BY department
HAVING COUNT(*) > 5 AND AVG(salary) > 8000;

-- è®¢å•æ•°>50ä¸”æ€»é‡‘é¢>100ä¸‡çš„å®¢æˆ·
SELECT 
    customer_id,
    COUNT(*) AS order_count,
    SUM(total_amount) AS total_spent
FROM orders 
GROUP BY customer_id
HAVING COUNT(*) > 50 AND SUM(total_amount) > 1000000;
```

**ORæ¡ä»¶ç»„åˆ**ï¼šä»»ä¸€èšåˆæ¡ä»¶æ»¡è¶³ã€‚

```sql
-- éƒ¨é—¨äººæ•°>20æˆ–å¹³å‡è–ªèµ„>15000çš„éƒ¨é—¨
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary
FROM employees 
GROUP BY department
HAVING COUNT(*) > 20 OR AVG(salary) > 15000;
```

#### èŒƒå›´è¿‡æ»¤


**BETWEENåœ¨HAVINGä¸­çš„åº”ç”¨**ï¼š

```sql
-- å¹³å‡å¹´é¾„åœ¨25-35ä¹‹é—´çš„åŸå¸‚
SELECT 
    city,
    AVG(age) AS avg_age,
    COUNT(*) AS user_count
FROM users 
GROUP BY city
HAVING AVG(age) BETWEEN 25 AND 35;
```

### 5.4 HAVINGå®é™…åº”ç”¨


#### ä¸šåŠ¡æŠ¥è¡¨åˆ†æ


**é”€å”®åˆ†æ**ï¼š

```sql
-- æ‰¾å‡ºè¡¨ç°ä¼˜ç§€çš„é”€å”®å›¢é˜Ÿ
SELECT 
    team_name,
    COUNT(*) AS salesperson_count,
    AVG(monthly_sales) AS avg_sales,
    SUM(monthly_sales) AS team_total
FROM sales_performance 
GROUP BY team_name
HAVING COUNT(*) >= 5           -- è‡³å°‘5äººçš„å›¢é˜Ÿ
   AND AVG(monthly_sales) > 50000  -- äººå‡æœˆé”€å”®>5ä¸‡
   AND SUM(monthly_sales) > 500000 -- å›¢é˜Ÿæ€»é”€å”®>50ä¸‡
ORDER BY team_total DESC;
```

**å®¢æˆ·åˆ†çº§**ï¼š

```sql
-- è¯†åˆ«é«˜ä»·å€¼å®¢æˆ·ç¾¤ä½“
SELECT 
    CASE 
        WHEN SUM(order_amount) >= 100000 THEN 'VIPå®¢æˆ·'
        WHEN SUM(order_amount) >= 50000 THEN 'é‡è¦å®¢æˆ·'  
        ELSE 'æ™®é€šå®¢æˆ·'
    END AS customer_level,
    COUNT(*) AS customer_count,
    AVG(SUM(order_amount)) AS avg_spent_per_customer
FROM orders 
GROUP BY customer_id
HAVING SUM(order_amount) >= 10000  -- åªç»Ÿè®¡æ¶ˆè´¹>=1ä¸‡çš„å®¢æˆ·
GROUP BY customer_level;           -- å†æŒ‰å®¢æˆ·ç­‰çº§åˆ†ç»„
```

---

## 6. ğŸ”— å­æŸ¥è¯¢


### 6.1 å­æŸ¥è¯¢åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢**ï¼šæŸ¥è¯¢è¯­å¥å†…åµŒå¥—å¦ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œå°±åƒä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·ã€‚

```
å­æŸ¥è¯¢ç»“æ„ï¼š
SELECT ... 
FROM ... 
WHERE column æ“ä½œç¬¦ (SELECT ... FROM ...)
                    â†‘
                å­æŸ¥è¯¢ï¼ˆå†…æŸ¥è¯¢ï¼‰
```

**å­æŸ¥è¯¢çš„æ‰§è¡Œé¡ºåº**ï¼š
1. å…ˆæ‰§è¡Œå†…å±‚å­æŸ¥è¯¢
2. å°†ç»“æœæä¾›ç»™å¤–å±‚æŸ¥è¯¢ä½¿ç”¨
3. æ‰§è¡Œå¤–å±‚æŸ¥è¯¢å¾—åˆ°æœ€ç»ˆç»“æœ

### 6.2 æ ‡é‡å­æŸ¥è¯¢


**æ ‡é‡å­æŸ¥è¯¢çš„ç‰¹ç‚¹**ï¼šå­æŸ¥è¯¢è¿”å›å•ä¸ªå€¼ï¼ˆä¸€è¡Œä¸€åˆ—ï¼‰ã€‚

#### æ¯”è¾ƒè¿ç®—ä¸­çš„æ ‡é‡å­æŸ¥è¯¢


```sql
-- æŸ¥æ‰¾è–ªèµ„é«˜äºå¹³å‡è–ªèµ„çš„å‘˜å·¥
SELECT name, salary
FROM employees 
WHERE salary > (SELECT AVG(salary) FROM employees);

-- æŸ¥æ‰¾ä»·æ ¼é«˜äºå¹³å‡ä»·æ ¼çš„å•†å“
SELECT product_name, price
FROM products 
WHERE price > (SELECT AVG(price) FROM products);

-- æŸ¥æ‰¾æœ€æ–°è®¢å•çš„è¯¦ç»†ä¿¡æ¯
SELECT *
FROM orders 
WHERE created_date = (SELECT MAX(created_date) FROM orders);
```

#### SELECTåˆ—è¡¨ä¸­çš„æ ‡é‡å­æŸ¥è¯¢


**åœ¨é€‰æ‹©åˆ—è¡¨ä¸­ä½¿ç”¨å­æŸ¥è¯¢**ï¼šä¸ºæ¯è¡Œæ•°æ®æ·»åŠ ç»Ÿè®¡ä¿¡æ¯ã€‚

```sql
-- æ˜¾ç¤ºå‘˜å·¥è–ªèµ„åŠä¸å¹³å‡è–ªèµ„çš„å·®é¢
SELECT 
    name,
    salary,
    (SELECT AVG(salary) FROM employees) AS avg_salary,
    salary - (SELECT AVG(salary) FROM employees) AS salary_diff
FROM employees;

-- æ˜¾ç¤ºå•†å“ä»·æ ¼åŠåœ¨åŒç±»åˆ«ä¸­çš„æ’å
SELECT 
    product_name,
    category,
    price,
    (SELECT COUNT(*) 
     FROM products p2 
     WHERE p2.category = products.category 
       AND p2.price >= products.price) AS price_rank
FROM products;
```

### 6.3 åˆ—å­æŸ¥è¯¢


**åˆ—å­æŸ¥è¯¢çš„ç‰¹ç‚¹**ï¼šå­æŸ¥è¯¢è¿”å›å¤šä¸ªå€¼ï¼ˆå¤šè¡Œä¸€åˆ—ï¼‰ã€‚

#### INå­æŸ¥è¯¢


**INçš„åº”ç”¨åœºæ™¯**ï¼šåˆ¤æ–­æŸå€¼æ˜¯å¦åœ¨ç»“æœé›†ä¸­ã€‚

```sql
-- æŸ¥æ‰¾æœ‰è®¢å•çš„å®¢æˆ·ä¿¡æ¯
SELECT *
FROM customers 
WHERE customer_id IN (
    SELECT DISTINCT customer_id 
    FROM orders
);

-- æŸ¥æ‰¾è´­ä¹°è¿‡æŒ‡å®šç±»åˆ«å•†å“çš„å®¢æˆ·
SELECT *
FROM customers 
WHERE customer_id IN (
    SELECT DISTINCT o.customer_id
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    WHERE p.category = 'ç”µå­äº§å“'
);
```

#### ANYå­æŸ¥è¯¢


**ANYçš„å«ä¹‰**ï¼šæ»¡è¶³å­æŸ¥è¯¢ä¸­ä»»æ„ä¸€ä¸ªå€¼çš„æ¡ä»¶ã€‚

```sql
-- æŸ¥æ‰¾ä»·æ ¼é«˜äºä»»ä¸€ç”µå­äº§å“çš„å•†å“
SELECT product_name, price, category
FROM products 
WHERE price > ANY (
    SELECT price 
    FROM products 
    WHERE category = 'ç”µå­äº§å“'
);

-- æŸ¥æ‰¾è–ªèµ„é«˜äºä»»ä¸€ç ”å‘éƒ¨å‘˜å·¥çš„æ‰€æœ‰å‘˜å·¥
SELECT name, department, salary
FROM employees 
WHERE salary > ANY (
    SELECT salary 
    FROM employees 
    WHERE department = 'ç ”å‘éƒ¨'
);
```

#### ALLå­æŸ¥è¯¢


**ALLçš„å«ä¹‰**ï¼šæ»¡è¶³å­æŸ¥è¯¢ä¸­æ‰€æœ‰å€¼çš„æ¡ä»¶ã€‚

```sql
-- æŸ¥æ‰¾ä»·æ ¼é«˜äºæ‰€æœ‰ä¹¦ç±çš„å•†å“
SELECT product_name, price, category
FROM products 
WHERE price > ALL (
    SELECT price 
    FROM products 
    WHERE category = 'å›¾ä¹¦'
);

-- æŸ¥æ‰¾è–ªèµ„é«˜äºæ‰€æœ‰å®ä¹ ç”Ÿçš„æ­£å¼å‘˜å·¥
SELECT name, salary, employment_type
FROM employees 
WHERE salary > ALL (
    SELECT salary 
    FROM employees 
    WHERE employment_type = 'å®ä¹ ç”Ÿ'
) AND employment_type = 'æ­£å¼å‘˜å·¥';
```

### 6.4 è¡Œå­æŸ¥è¯¢


**è¡Œå­æŸ¥è¯¢çš„ç‰¹ç‚¹**ï¼šå­æŸ¥è¯¢è¿”å›ä¸€è¡Œå¤šåˆ—ï¼Œç”¨äºå¤šå­—æ®µåŒ¹é…ã€‚

```sql
-- æŸ¥æ‰¾ä¸å¼ ä¸‰åŒéƒ¨é—¨åŒèŒä½çš„å‘˜å·¥
SELECT *
FROM employees 
WHERE (department, position) = (
    SELECT department, position
    FROM employees 
    WHERE name = 'å¼ ä¸‰'
);

-- æŸ¥æ‰¾æ¯ä¸ªéƒ¨é—¨è–ªèµ„æœ€é«˜çš„å‘˜å·¥
SELECT *
FROM employees e1
WHERE (department, salary) IN (
    SELECT department, MAX(salary)
    FROM employees e2
    GROUP BY department
);
```

### 6.5 è¡¨å­æŸ¥è¯¢ï¼ˆæ´¾ç”Ÿè¡¨ï¼‰


**è¡¨å­æŸ¥è¯¢çš„åº”ç”¨**ï¼šå­æŸ¥è¯¢åœ¨FROMå­å¥ä¸­ï¼Œåˆ›å»ºä¸´æ—¶è¡¨ã€‚

```sql
-- æŸ¥æ‰¾æ¯ä¸ªéƒ¨é—¨å¹³å‡è–ªèµ„æœ€é«˜çš„å‰3ä¸ªéƒ¨é—¨
SELECT dept_name, avg_salary
FROM (
    SELECT 
        department AS dept_name,
        AVG(salary) AS avg_salary
    FROM employees 
    GROUP BY department
) AS dept_avg
ORDER BY avg_salary DESC
LIMIT 3;

-- æŸ¥æ‰¾é”€å”®é¢è¶…è¿‡å¹³å‡æ°´å¹³çš„é”€å”®å‘˜è¯¦ç»†ä¿¡æ¯
SELECT s.*, avg_stats.overall_avg
FROM salespersons s
JOIN (
    SELECT AVG(monthly_sales) AS overall_avg
    FROM salespersons
) AS avg_stats
WHERE s.monthly_sales > avg_stats.overall_avg;
```

### 6.6 EXISTSå­æŸ¥è¯¢


**EXISTSçš„å«ä¹‰**ï¼šæ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦è¿”å›ç»“æœï¼Œè¿”å›TRUE/FALSEã€‚

#### EXISTSå­˜åœ¨æ€§æ£€æŸ¥


```sql
-- æŸ¥æ‰¾æœ‰è®¢å•çš„å®¢æˆ·
SELECT *
FROM customers c
WHERE EXISTS (
    SELECT 1 
    FROM orders o 
    WHERE o.customer_id = c.customer_id
);

-- æŸ¥æ‰¾æœ‰åº“å­˜çš„å•†å“
SELECT *
FROM products p
WHERE EXISTS (
    SELECT 1 
    FROM inventory i
    WHERE i.product_id = p.product_id 
      AND i.quantity > 0
);
```

#### NOT EXISTS ä¸å­˜åœ¨æ£€æŸ¥


```sql
-- æŸ¥æ‰¾æ²¡æœ‰è®¢å•çš„å®¢æˆ·ï¼ˆæ½œåœ¨æµå¤±å®¢æˆ·ï¼‰
SELECT *
FROM customers c
WHERE NOT EXISTS (
    SELECT 1 
    FROM orders o 
    WHERE o.customer_id = c.customer_id
);

-- æŸ¥æ‰¾æ²¡æœ‰ä»»ä½•é”€å”®è®°å½•çš„å•†å“
SELECT *
FROM products p
WHERE NOT EXISTS (
    SELECT 1 
    FROM order_items oi
    WHERE oi.product_id = p.product_id
);
```

**EXISTS vs INçš„æ€§èƒ½å¯¹æ¯”**ï¼š
```sql
-- EXISTSï¼šé€šå¸¸æ€§èƒ½æ›´å¥½ï¼Œç‰¹åˆ«æ˜¯å¤§æ•°æ®é‡æ—¶
SELECT * FROM customers c
WHERE EXISTS (SELECT 1 FROM orders o WHERE o.customer_id = c.customer_id);

-- INï¼šå½“å­æŸ¥è¯¢ç»“æœé›†è¾ƒå°æ—¶æ€§èƒ½ä¸é”™
SELECT * FROM customers 
WHERE customer_id IN (SELECT customer_id FROM orders);
```

---

## 7. ğŸ”— è¡¨è¿æ¥æŸ¥è¯¢


### 7.1 è¡¨è¿æ¥åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è¡¨è¿æ¥**ï¼šå°†ä¸¤ä¸ªæˆ–å¤šä¸ªè¡¨çš„æ•°æ®ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±åƒæ‹¼å›¾ä¸€æ ·æŠŠç›¸å…³ä¿¡æ¯æ‹¼æ¥å®Œæ•´ã€‚

```
è¡¨è¿æ¥ç¤ºæ„å›¾ï¼š
ç”¨æˆ·è¡¨                è®¢å•è¡¨                è¿æ¥ç»“æœ
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ID  â”‚å§“åâ”‚          â”‚ID  â”‚ç”¨æˆ·IDâ”‚          â”‚å§“åâ”‚è®¢å•IDâ”‚é‡‘é¢â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤    â†’     â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤    â†’     â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚1   â”‚å¼ ä¸‰â”‚          â”‚101 â”‚1    â”‚          â”‚å¼ ä¸‰â”‚101 â”‚500 â”‚
â”‚2   â”‚æå››â”‚          â”‚102 â”‚1    â”‚          â”‚å¼ ä¸‰â”‚102 â”‚300 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

### 7.2 å†…è¿æ¥INNER JOIN


**å†…è¿æ¥çš„ç‰¹ç‚¹**ï¼šåªè¿”å›ä¸¤è¡¨éƒ½æœ‰åŒ¹é…æ•°æ®çš„è®°å½•ã€‚

#### ç­‰å€¼è¿æ¥


**åŸºç¡€å†…è¿æ¥è¯­æ³•**ï¼š

```sql
-- æŸ¥è¯¢å‘˜å·¥åŠå…¶éƒ¨é—¨ä¿¡æ¯
SELECT e.name, e.salary, d.department_name
FROM employees e
INNER JOIN departments d ON e.department_id = d.department_id;

-- æŸ¥è¯¢è®¢å•åŠå®¢æˆ·ä¿¡æ¯
SELECT o.order_id, o.order_date, c.customer_name, o.total_amount
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id;
```

**JOINä¸WHEREçš„ç­‰ä»·å†™æ³•**ï¼š
```sql
-- ä½¿ç”¨JOINï¼ˆæ¨èå†™æ³•ï¼‰
SELECT e.name, d.department_name
FROM employees e
INNER JOIN departments d ON e.department_id = d.department_id;

-- ä½¿ç”¨WHEREï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰
SELECT e.name, d.department_name
FROM employees e, departments d
WHERE e.department_id = d.department_id;
```

#### å¤šæ¡ä»¶è¿æ¥


**å¤åˆè¿æ¥æ¡ä»¶**ï¼š

```sql
-- è¿æ¥æ¡ä»¶åŒ…å«å¤šä¸ªå­—æ®µ
SELECT *
FROM order_items oi
INNER JOIN products p ON oi.product_id = p.product_id 
                     AND oi.product_version = p.version;

-- è¿æ¥æ¡ä»¶åŒ…å«èŒƒå›´åˆ¤æ–­
SELECT s.student_name, c.course_name, sc.score
FROM students s
INNER JOIN student_courses sc ON s.student_id = sc.student_id
INNER JOIN courses c ON sc.course_id = c.course_id
WHERE sc.score >= 60;
```

### 7.3 å¤–è¿æ¥


#### LEFT JOIN å·¦å¤–è¿æ¥


**å·¦è¿æ¥çš„ç‰¹ç‚¹**ï¼šä¿ç•™å·¦è¡¨æ‰€æœ‰è®°å½•ï¼Œå³è¡¨æ²¡æœ‰åŒ¹é…çš„æ˜¾ç¤ºNULLã€‚

```sql
-- æŸ¥è¯¢æ‰€æœ‰å®¢æˆ·åŠå…¶è®¢å•ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ²¡æœ‰è®¢å•çš„å®¢æˆ·ï¼‰
SELECT c.customer_name, o.order_id, o.total_amount
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id;

-- æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥åŠå…¶éƒ¨é—¨ä¿¡æ¯ï¼ˆåŒ…æ‹¬æœªåˆ†é…éƒ¨é—¨çš„å‘˜å·¥ï¼‰
SELECT e.name, IFNULL(d.department_name, 'æœªåˆ†é…éƒ¨é—¨') AS dept
FROM employees e
LEFT JOIN departments d ON e.department_id = d.department_id;
```

**LEFT JOINçš„å®é™…åº”ç”¨**ï¼š
```sql
-- æ‰¾å‡ºæ²¡æœ‰è®¢å•çš„å®¢æˆ·ï¼ˆå®¢æˆ·æµå¤±åˆ†æï¼‰
SELECT c.customer_name, c.registration_date
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
WHERE o.customer_id IS NULL;

-- ç»Ÿè®¡æ¯ä¸ªå®¢æˆ·çš„è®¢å•æ•°é‡ï¼ˆåŒ…æ‹¬0ä¸ªè®¢å•çš„å®¢æˆ·ï¼‰
SELECT 
    c.customer_name,
    COUNT(o.order_id) AS order_count,
    IFNULL(SUM(o.total_amount), 0) AS total_spent
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id;
```

#### RIGHT JOIN å³å¤–è¿æ¥


**å³è¿æ¥çš„ç‰¹ç‚¹**ï¼šä¿ç•™å³è¡¨æ‰€æœ‰è®°å½•ï¼Œå·¦è¡¨æ²¡æœ‰åŒ¹é…çš„æ˜¾ç¤ºNULLã€‚

```sql
-- æŸ¥è¯¢æ‰€æœ‰éƒ¨é—¨åŠå…¶å‘˜å·¥ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ²¡æœ‰å‘˜å·¥çš„éƒ¨é—¨ï¼‰
SELECT d.department_name, e.name, e.salary
FROM employees e
RIGHT JOIN departments d ON e.department_id = d.department_id;

-- ç­‰ä»·çš„LEFT JOINå†™æ³•ï¼ˆæ¨èï¼‰
SELECT d.department_name, e.name, e.salary
FROM departments d
LEFT JOIN employees e ON d.department_id = e.department_id;
```

### 7.4 å¤šè¡¨è¿æ¥


**ä¸‰è¡¨æˆ–æ›´å¤šè¡¨çš„è¿æ¥**ï¼š

```sql
-- æŸ¥è¯¢è®¢å•è¯¦ç»†ä¿¡æ¯ï¼ˆå®¢æˆ·ã€è®¢å•ã€å•†å“ï¼‰
SELECT 
    c.customer_name,
    o.order_id,
    o.order_date,
    p.product_name,
    oi.quantity,
    oi.unit_price
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
INNER JOIN order_items oi ON o.order_id = oi.order_id
INNER JOIN products p ON oi.product_id = p.product_id;

-- å‘˜å·¥ã€éƒ¨é—¨ã€é¡¹ç›®ä¸‰è¡¨è¿æ¥
SELECT 
    e.name AS employee_name,
    d.department_name,
    pr.project_name,
    ep.role
FROM employees e
INNER JOIN departments d ON e.department_id = d.department_id
INNER JOIN employee_projects ep ON e.employee_id = ep.employee_id
INNER JOIN projects pr ON ep.project_id = pr.project_id;
```

### 7.5 è‡ªè¿æ¥


**è‡ªè¿æ¥çš„åº”ç”¨**ï¼šè¡¨ä¸è‡ªå·±è¿æ¥ï¼Œå¤„ç†å±‚çº§å…³ç³»ã€‚

```sql
-- æŸ¥è¯¢å‘˜å·¥åŠå…¶ç›´å±ä¸Šçº§
SELECT 
    e1.name AS employee_name,
    e1.position,
    e2.name AS manager_name
FROM employees e1
LEFT JOIN employees e2 ON e1.manager_id = e2.employee_id;

-- æŸ¥è¯¢åŒéƒ¨é—¨çš„å‘˜å·¥å¯¹æ¯”
SELECT 
    e1.name AS employee1,
    e2.name AS employee2,
    e1.salary AS salary1,
    e2.salary AS salary2
FROM employees e1
INNER JOIN employees e2 ON e1.department_id = e2.department_id
WHERE e1.employee_id < e2.employee_id;  -- é¿å…é‡å¤å’Œè‡ªå·±æ¯”è¾ƒ
```

**å±‚çº§æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
-- æŸ¥è¯¢ç»ç†åŠå…¶ä¸‹å±æ•°é‡
SELECT 
    m.name AS manager_name,
    COUNT(s.employee_id) AS subordinate_count
FROM employees m
LEFT JOIN employees s ON m.employee_id = s.manager_id
GROUP BY m.employee_id, m.name
HAVING COUNT(s.employee_id) > 0;
```

---

## 8. ğŸ”— è”åˆæŸ¥è¯¢UNION


### 8.1 UNIONåŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯UNION**ï¼šå°†å¤šä¸ªæŸ¥è¯¢ç»“æœåˆå¹¶æˆä¸€ä¸ªç»“æœé›†ï¼Œå°±åƒæŠŠå¤šä¸ªåˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§åˆ—è¡¨ã€‚

**UNIONçš„è¦æ±‚**ï¼š
- å„æŸ¥è¯¢çš„åˆ—æ•°å¿…é¡»ç›¸åŒ
- å¯¹åº”åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»å…¼å®¹
- åˆ—åä»¥ç¬¬ä¸€ä¸ªæŸ¥è¯¢ä¸ºå‡†

### 8.2 UNION vs UNION ALL


#### UNIONï¼ˆå»é‡åˆå¹¶ï¼‰


**UNIONçš„ç‰¹ç‚¹**ï¼šè‡ªåŠ¨å»é™¤é‡å¤è®°å½•ã€‚

```sql
-- åˆå¹¶å‘˜å·¥å’Œå®¢æˆ·çš„å§“ååˆ—è¡¨ï¼ˆå»é‡ï¼‰
SELECT name FROM employees
UNION
SELECT customer_name FROM customers;

-- åˆå¹¶ä¸åŒçŠ¶æ€çš„è®¢å•
SELECT order_id, 'pending' AS status FROM pending_orders
UNION  
SELECT order_id, 'completed' AS status FROM completed_orders;
```

#### UNION ALLï¼ˆä¿ç•™é‡å¤ï¼‰


**UNION ALLçš„ç‰¹ç‚¹**ï¼šä¿ç•™æ‰€æœ‰è®°å½•ï¼ŒåŒ…æ‹¬é‡å¤è®°å½•ï¼Œæ€§èƒ½æ›´å¥½ã€‚

```sql
-- åˆå¹¶æ‰€æœ‰ç”¨æˆ·æ´»åŠ¨è®°å½•ï¼ˆä¿ç•™é‡å¤ï¼‰
SELECT user_id, activity, activity_date FROM login_logs
UNION ALL
SELECT user_id, activity, activity_date FROM purchase_logs
UNION ALL
SELECT user_id, activity, activity_date FROM browsing_logs;
```

**æ€§èƒ½å¯¹æ¯”**ï¼š
```sql
-- UNIONï¼šéœ€è¦æ’åºå»é‡ï¼Œæ€§èƒ½è¾ƒæ…¢
SELECT product_name FROM products WHERE category = 'A'
UNION
SELECT product_name FROM products WHERE category = 'B';

-- UNION ALLï¼šç›´æ¥åˆå¹¶ï¼Œæ€§èƒ½æ›´å¥½
SELECT product_name FROM products WHERE category = 'A'
UNION ALL
SELECT product_name FROM products WHERE category = 'B';
```

### 8.3 å¤æ‚UNIONåº”ç”¨


#### å¸¦æ¡ä»¶çš„UNION


```sql
-- åˆ†åˆ«ç»Ÿè®¡VIPå’Œæ™®é€šå®¢æˆ·ï¼Œç„¶ååˆå¹¶
(SELECT 
    'VIPå®¢æˆ·' AS customer_type,
    COUNT(*) AS count,
    AVG(total_spent) AS avg_spent
 FROM customers 
 WHERE vip_level = 'gold')
UNION ALL
(SELECT 
    'æ™®é€šå®¢æˆ·' AS customer_type,
    COUNT(*) AS count, 
    AVG(total_spent) AS avg_spent
 FROM customers 
 WHERE vip_level = 'none')
ORDER BY avg_spent DESC;
```

#### UNIONç»“æœæ’åº


**æ•´ä½“æ’åº**ï¼šå¯¹åˆå¹¶åçš„ç»“æœè¿›è¡Œæ’åºã€‚

```sql
-- åˆå¹¶å‘˜å·¥å’Œç®¡ç†å±‚ä¿¡æ¯ï¼ŒæŒ‰è–ªèµ„æ’åº
SELECT name, salary, 'employee' AS type 
FROM employees
UNION ALL
SELECT name, salary, 'manager' AS type 
FROM managers
ORDER BY salary DESC;
```

**åˆ†ç»„æ’åº**ï¼šå¯¹æ¯ä¸ªå­æŸ¥è¯¢åˆ†åˆ«æ’åºã€‚

```sql
-- åˆ†åˆ«å–æ¯ä¸ªéƒ¨é—¨çš„å‰2åå‘˜å·¥
(SELECT name, department, salary
 FROM employees 
 WHERE department = 'é”€å”®éƒ¨'
 ORDER BY salary DESC 
 LIMIT 2)
UNION ALL
(SELECT name, department, salary
 FROM employees 
 WHERE department = 'æŠ€æœ¯éƒ¨'
 ORDER BY salary DESC 
 LIMIT 2);
```

### 8.4 UNIONå®é™…åº”ç”¨æ¡ˆä¾‹


#### æ•°æ®å½’æ¡£åˆå¹¶


```sql
-- åˆå¹¶å†å²æ•°æ®å’Œå½“å‰æ•°æ®
SELECT order_id, customer_id, order_date, 'current' AS data_source
FROM current_orders
WHERE order_date >= '2024-01-01'
UNION ALL
SELECT order_id, customer_id, order_date, 'archive' AS data_source  
FROM archived_orders
WHERE order_date >= '2024-01-01'
ORDER BY order_date DESC;
```

#### æŠ¥è¡¨æ•°æ®æ•´åˆ


```sql
-- æ•´åˆä¸åŒæ¸ é“çš„é”€å”®æ•°æ®
SELECT 
    'çº¿ä¸Šé”€å”®' AS channel,
    SUM(amount) AS total_sales,
    COUNT(*) AS order_count
FROM online_sales
WHERE DATE(sale_date) = CURDATE()
UNION ALL
SELECT 
    'çº¿ä¸‹é”€å”®' AS channel,
    SUM(amount) AS total_sales,
    COUNT(*) AS order_count
FROM offline_sales  
WHERE DATE(sale_date) = CURDATE()
UNION ALL
SELECT 
    'åˆè®¡' AS channel,
    SUM(total_sales) AS total_sales,
    SUM(order_count) AS order_count
FROM (
    SELECT SUM(amount) AS total_sales, COUNT(*) AS order_count FROM online_sales WHERE DATE(sale_date) = CURDATE()
    UNION ALL
    SELECT SUM(amount) AS total_sales, COUNT(*) AS order_count FROM offline_sales WHERE DATE(sale_date) = CURDATE()
) AS combined;
```

---

## 9. ğŸ“Š çª—å£å‡½æ•°æŸ¥è¯¢


### 9.1 çª—å£å‡½æ•°åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯çª—å£å‡½æ•°**ï¼šåœ¨ç»“æœé›†çš„æ¯ä¸€è¡Œä¸Šï¼ŒåŸºäºä¸è¯¥è¡Œç›¸å…³çš„ä¸€ç»„è¡Œè¿›è¡Œè®¡ç®—ã€‚å®ƒä¸ä¼šæ”¹å˜ç»“æœé›†çš„è¡Œæ•°ï¼Œå°±åƒç»™æ¯è¡Œæ•°æ®é…ä¸ª"åŠ©æ‰‹"æ¥åšè®¡ç®—ã€‚

```
çª—å£å‡½æ•° vs èšåˆå‡½æ•°ï¼š

èšåˆå‡½æ•°ï¼š                    çª—å£å‡½æ•°ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚éƒ¨é—¨â”‚å§“åâ”‚è–ªèµ„â”‚             â”‚éƒ¨é—¨â”‚å§“åâ”‚è–ªèµ„â”‚æ’åâ”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤             â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ç ”å‘â”‚å¼ ä¸‰â”‚8000â”‚   GROUP BY   â”‚ç ”å‘â”‚å¼ ä¸‰â”‚8000â”‚ 1  â”‚
â”‚ç ”å‘â”‚æå››â”‚7000â”‚      â†’      â”‚ç ”å‘â”‚æå››â”‚7000â”‚ 2  â”‚
â”‚é”€å”®â”‚ç‹äº”â”‚6000â”‚             â”‚é”€å”®â”‚ç‹äº”â”‚6000â”‚ 1  â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
  3è¡Œå˜1è¡Œ                       ä¿æŒ3è¡Œï¼Œå¢åŠ è®¡ç®—åˆ—
```

**çª—å£å‡½æ•°è¯­æ³•**ï¼š
```sql
çª—å£å‡½æ•°å() OVER (
    [PARTITION BY åˆ†ç»„åˆ—]  -- å¯é€‰ï¼šæŒ‰ä»€ä¹ˆåˆ†ç»„
    [ORDER BY æ’åºåˆ—]      -- å¯é€‰ï¼šæŒ‰ä»€ä¹ˆæ’åº  
    [ROWS/RANGE èŒƒå›´]      -- å¯é€‰ï¼šè®¡ç®—èŒƒå›´
)
```

### 9.2 æ’åå‡½æ•°


#### ROW_NUMBER() è¡Œå·


**ROW_NUMBERç‰¹ç‚¹**ï¼šä¸ºæ¯è¡Œåˆ†é…å”¯ä¸€çš„è¿ç»­æ•´æ•°ï¼Œå³ä½¿å€¼ç›¸åŒä¹Ÿä¼šæœ‰ä¸åŒæ’åã€‚

```sql
-- ä¸ºæ‰€æœ‰å‘˜å·¥æŒ‰è–ªèµ„æ’åºç¼–å·
SELECT 
    name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num
FROM employees;

-- ä¸ºæ¯ä¸ªéƒ¨é—¨å†…çš„å‘˜å·¥æŒ‰è–ªèµ„æ’åºç¼–å·
SELECT 
    department,
    name,
    salary,
    ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS dept_row_num
FROM employees;
```

#### RANK() æ’å


**RANKç‰¹ç‚¹**ï¼šç›¸åŒå€¼è·å¾—ç›¸åŒæ’åï¼Œä½†ä¼šè·³è¿‡åç»­æ’åã€‚

```sql
-- å‘˜å·¥è–ªèµ„æ’åï¼ˆç›¸åŒè–ªèµ„åŒæ’åï¼Œè·³è¿‡åç»­åæ¬¡ï¼‰
SELECT 
    name,
    salary,
    RANK() OVER (ORDER BY salary DESC) AS salary_rank
FROM employees;

-- ç¤ºä¾‹ç»“æœï¼š
-- å¼ ä¸‰ 10000  1
-- æå›› 10000  1  
-- ç‹äº”  9000  3  â† è·³è¿‡äº†ç¬¬2å
-- èµµå…­  8000  4
```

#### DENSE_RANK() å¯†é›†æ’å


**DENSE_RANKç‰¹ç‚¹**ï¼šç›¸åŒå€¼è·å¾—ç›¸åŒæ’åï¼Œä¸è·³è¿‡åç»­æ’åã€‚

```sql
-- éƒ¨é—¨å†…å‘˜å·¥è–ªèµ„å¯†é›†æ’å
SELECT 
    department,
    name,
    salary,
    DENSE_RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS dense_rank
FROM employees;

-- ç¤ºä¾‹ç»“æœï¼š
-- ç ”å‘éƒ¨ å¼ ä¸‰ 10000  1
-- ç ”å‘éƒ¨ æå›› 10000  1
-- ç ”å‘éƒ¨ ç‹äº”  9000  2  â† ä¸è·³è¿‡æ’å
-- ç ”å‘éƒ¨ èµµå…­  8000  3
```

#### æ’åå‡½æ•°å¯¹æ¯”


```sql
-- ä¸‰ç§æ’åå‡½æ•°å¯¹æ¯”
SELECT 
    name,
    salary,
    ROW_NUMBER() OVER (ORDER BY salary DESC) AS row_num,
    RANK() OVER (ORDER BY salary DESC) AS rank_num,
    DENSE_RANK() OVER (ORDER BY salary DESC) AS dense_rank_num
FROM employees
ORDER BY salary DESC;
```

### 9.3 èšåˆçª—å£å‡½æ•°


#### SUM() OVER ç´¯è®¡æ±‚å’Œ


**ç´¯è®¡æ±‚å’Œçš„åº”ç”¨**ï¼šè®¡ç®—è¿è¡Œæ€»è®¡ã€‚

```sql
-- æŒ‰æ—¥æœŸè®¡ç®—é”€å”®é¢ç´¯è®¡
SELECT 
    sale_date,
    daily_sales,
    SUM(daily_sales) OVER (ORDER BY sale_date) AS cumulative_sales
FROM daily_sales_summary
ORDER BY sale_date;

-- æ¯ä¸ªé”€å”®å‘˜çš„ç´¯è®¡ä¸šç»©
SELECT 
    salesperson,
    month,
    monthly_sales,
    SUM(monthly_sales) OVER (
        PARTITION BY salesperson 
        ORDER BY month
    ) AS cumulative_sales
FROM sales_monthly;
```

#### AVG() OVER ç§»åŠ¨å¹³å‡


**ç§»åŠ¨å¹³å‡çš„ä½œç”¨**ï¼šå¹³æ»‘æ•°æ®æ³¢åŠ¨ï¼Œè¯†åˆ«è¶‹åŠ¿ã€‚

```sql
-- è®¡ç®—3ä¸ªæœˆç§»åŠ¨å¹³å‡é”€å”®é¢
SELECT 
    month,
    sales_amount,
    AVG(sales_amount) OVER (
        ORDER BY month 
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS three_month_avg
FROM monthly_sales;

-- è®¡ç®—æ¯ä¸ªäº§å“çš„ä»·æ ¼åœ¨åŒç±»åˆ«ä¸­çš„å¹³å‡æ°´å¹³
SELECT 
    category,
    product_name,
    price,
    AVG(price) OVER (PARTITION BY category) AS category_avg_price,
    price - AVG(price) OVER (PARTITION BY category) AS price_diff
FROM products;
```

### 9.4 å–å€¼å‡½æ•°


#### LAG() å’Œ LEAD() è®¿é—®ç›¸é‚»è¡Œ


**LAG()çš„ä½œç”¨**ï¼šè®¿é—®å½“å‰è¡Œä¹‹å‰çš„æ•°æ®ã€‚

```sql
-- è®¡ç®—é”€å”®é¢ç¯æ¯”å¢é•¿
SELECT 
    month,
    sales_amount,
    LAG(sales_amount, 1) OVER (ORDER BY month) AS prev_month_sales,
    sales_amount - LAG(sales_amount, 1) OVER (ORDER BY month) AS month_growth,
    ROUND(
        (sales_amount - LAG(sales_amount, 1) OVER (ORDER BY month)) / 
        LAG(sales_amount, 1) OVER (ORDER BY month) * 100, 2
    ) AS growth_rate_pct
FROM monthly_sales;
```

**LEAD()çš„ä½œç”¨**ï¼šè®¿é—®å½“å‰è¡Œä¹‹åçš„æ•°æ®ã€‚

```sql
-- é¢„æµ‹æ€§åˆ†æï¼šå½“å‰é”€å”®ä¸ä¸‹æœŸå¯¹æ¯”
SELECT 
    quarter,
    sales,
    LEAD(sales, 1) OVER (ORDER BY quarter) AS next_quarter_sales,
    CASE 
        WHEN LEAD(sales, 1) OVER (ORDER BY quarter) > sales THEN 'é¢„æœŸä¸Šå‡'
        WHEN LEAD(sales, 1) OVER (ORDER BY quarter) < sales THEN 'é¢„æœŸä¸‹é™'
        ELSE 'é¢„æœŸæŒå¹³'
    END AS trend_prediction
FROM quarterly_sales;
```

#### FIRST_VALUE() å’Œ LAST_VALUE()


**å–çª—å£å†…çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå€¼**ï¼š

```sql
-- æ¯”è¾ƒæ¯ä¸ªå‘˜å·¥è–ªèµ„ä¸éƒ¨é—¨æœ€é«˜ã€æœ€ä½è–ªèµ„
SELECT 
    department,
    name,
    salary,
    FIRST_VALUE(salary) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
    ) AS dept_max_salary,
    LAST_VALUE(salary) OVER (
        PARTITION BY department 
        ORDER BY salary DESC
        ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS dept_min_salary
FROM employees;
```

### 9.5 çª—å£èŒƒå›´æ§åˆ¶


**ROWS vs RANGE**ï¼š

```sql
-- ROWSï¼šæŒ‰è¡Œæ•°æ§åˆ¶çª—å£
SELECT 
    order_date,
    sales_amount,
    AVG(sales_amount) OVER (
        ORDER BY order_date
        ROWS BETWEEN 2 PRECEDING AND 2 FOLLOWING  -- å‰2è¡Œåˆ°å2è¡Œ
    ) AS five_day_avg
FROM daily_sales;

-- RANGEï¼šæŒ‰å€¼èŒƒå›´æ§åˆ¶çª—å£  
SELECT 
    order_date,
    sales_amount,
    AVG(sales_amount) OVER (
        ORDER BY order_date
        RANGE BETWEEN INTERVAL 7 DAY PRECEDING AND CURRENT ROW  -- è¿‡å»7å¤©
    ) AS weekly_avg
FROM daily_sales;
```

**å¸¸ç”¨çª—å£èŒƒå›´**ï¼š
```sql
-- ä»å¼€å§‹åˆ°å½“å‰è¡Œ
ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW

-- ä»å½“å‰è¡Œåˆ°ç»“æŸ
ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING

-- å‰Nè¡Œåˆ°åMè¡Œ
ROWS BETWEEN N PRECEDING AND M FOLLOWING
```

---

## 10. ğŸ”„ å…¬ç”¨è¡¨è¡¨è¾¾å¼CTE


### 10.1 CTEåŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯CTE**ï¼šCommon Table Expressionï¼ˆå…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼‰ï¼Œå°±åƒåœ¨æŸ¥è¯¢å‰å…ˆå®šä¹‰ä¸€ä¸ªä¸´æ—¶çš„"è‰ç¨¿çº¸"ï¼Œè®©å¤æ‚æŸ¥è¯¢æ›´æ¸…æ™°æ˜“æ‡‚ã€‚

**CTEçš„ä¼˜åŠ¿**ï¼š
- **å¯è¯»æ€§å¼º**ï¼šå°†å¤æ‚æŸ¥è¯¢åˆ†è§£æˆç®€å•æ­¥éª¤
- **å¯é‡ç”¨**ï¼šåŒä¸€ä¸ªCTEå¯ä»¥è¢«å¤šæ¬¡å¼•ç”¨
- **é€’å½’æ”¯æŒ**ï¼šå¤„ç†å±‚æ¬¡ç»“æ„æ•°æ®

### 10.2 éé€’å½’CTE


#### åŸºç¡€CTEè¯­æ³•


```sql
-- CTEåŸºæœ¬ç»“æ„
WITH cte_name AS (
    -- å­æŸ¥è¯¢å®šä¹‰
    SELECT ...
)
-- ä¸»æŸ¥è¯¢ä½¿ç”¨CTE
SELECT ... FROM cte_name ...
```

**ç®€å•CTEç¤ºä¾‹**ï¼š

```sql
-- è®¡ç®—éƒ¨é—¨å¹³å‡è–ªèµ„ï¼Œç„¶åæŸ¥æ‰¾é«˜äºå¹³å‡è–ªèµ„çš„å‘˜å·¥
WITH dept_avg AS (
    SELECT 
        department,
        AVG(salary) AS avg_salary
    FROM employees 
    GROUP BY department
)
SELECT 
    e.name,
    e.department,
    e.salary,
    da.avg_salary,
    e.salary - da.avg_salary AS salary_diff
FROM employees e
JOIN dept_avg da ON e.department = da.department
WHERE e.salary > da.avg_salary;
```

#### å¤šä¸ªCTE


**å¤šæ­¥éª¤æ•°æ®å¤„ç†**ï¼š

```sql
-- é”€å”®ä¸šç»©åˆ†æï¼šå¤šä¸ªCTEé…åˆä½¿ç”¨
WITH 
-- ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ¯ä¸ªé”€å”®å‘˜çš„æœˆåº¦ä¸šç»©
monthly_sales AS (
    SELECT 
        salesperson_id,
        DATE_FORMAT(sale_date, '%Y-%m') AS sale_month,
        SUM(amount) AS monthly_total
    FROM sales 
    GROUP BY salesperson_id, DATE_FORMAT(sale_date, '%Y-%m')
),
-- ç¬¬äºŒæ­¥ï¼šè®¡ç®—å¹³å‡æœˆåº¦ä¸šç»©
sales_avg AS (
    SELECT 
        salesperson_id,
        AVG(monthly_total) AS avg_monthly_sales
    FROM monthly_sales
    GROUP BY salesperson_id
),
-- ç¬¬ä¸‰æ­¥ï¼šè®¡ç®—ä¸šç»©æ’å
sales_ranking AS (
    SELECT 
        salesperson_id,
        avg_monthly_sales,
        RANK() OVER (ORDER BY avg_monthly_sales DESC) AS sales_rank
    FROM sales_avg
)
-- æœ€ç»ˆæŸ¥è¯¢ï¼šå±•ç¤ºTop10é”€å”®å‘˜
SELECT 
    sp.name,
    sr.avg_monthly_sales,
    sr.sales_rank
FROM sales_ranking sr
JOIN salespersons sp ON sr.salesperson_id = sp.id
WHERE sr.sales_rank <= 10;
```

### 10.3 é€’å½’CTE


**é€’å½’CTEçš„åº”ç”¨**ï¼šå¤„ç†æ ‘å½¢ç»“æ„ã€å±‚æ¬¡å…³ç³»æ•°æ®ã€‚

#### ç»„ç»‡æ¶æ„å±‚æ¬¡æŸ¥è¯¢


```sql
-- æŸ¥è¯¢å®Œæ•´çš„ç»„ç»‡æ¶æ„å±‚æ¬¡
WITH RECURSIVE emp_hierarchy AS (
    -- é”šç‚¹æŸ¥è¯¢ï¼šæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼ˆæœ€é«˜å±‚ç®¡ç†è€…ï¼‰
    SELECT 
        employee_id,
        name,
        manager_id,
        position,
        1 AS level,
        CAST(name AS CHAR(1000)) AS path
    FROM employees 
    WHERE manager_id IS NULL
    
    UNION ALL
    
    -- é€’å½’æŸ¥è¯¢ï¼šæ‰¾åˆ°ä¸‹çº§å‘˜å·¥
    SELECT 
        e.employee_id,
        e.name,
        e.manager_id,
        e.position,
        eh.level + 1,
        CONCAT(eh.path, ' -> ', e.name) AS path
    FROM employees e
    JOIN emp_hierarchy eh ON e.manager_id = eh.employee_id
)
SELECT * FROM emp_hierarchy ORDER BY level, name;
```

#### å•†å“ç±»åˆ«å±‚æ¬¡ç»“æ„


```sql
-- æŸ¥è¯¢å•†å“ç±»åˆ«çš„å®Œæ•´å±‚æ¬¡ç»“æ„
WITH RECURSIVE category_tree AS (
    -- æ‰¾åˆ°é¡¶çº§ç±»åˆ«
    SELECT 
        category_id,
        category_name,
        parent_category_id,
        0 AS level,
        category_name AS full_path
    FROM categories 
    WHERE parent_category_id IS NULL
    
    UNION ALL
    
    -- æ‰¾åˆ°å­ç±»åˆ«
    SELECT 
        c.category_id,
        c.category_name,
        c.parent_category_id,
        ct.level + 1,
        CONCAT(ct.full_path, ' > ', c.category_name) AS full_path
    FROM categories c
    JOIN category_tree ct ON c.parent_category_id = ct.category_id
)
SELECT 
    REPEAT('  ', level) AS indent,
    category_name,
    level,
    full_path
FROM category_tree 
ORDER BY full_path;
```

### 10.4 CTEå®é™…åº”ç”¨æ¡ˆä¾‹


#### æ•°æ®åˆ†æä¸­çš„CTEåº”ç”¨


```sql
-- å®¢æˆ·ä»·å€¼åˆ†æï¼šç»“åˆå¤šä¸ªç»´åº¦è¯„ä¼°å®¢æˆ·
WITH 
-- å®¢æˆ·è®¢å•ç»Ÿè®¡
customer_orders AS (
    SELECT 
        customer_id,
        COUNT(*) AS total_orders,
        SUM(total_amount) AS total_spent,
        AVG(total_amount) AS avg_order_value,
        MIN(order_date) AS first_order_date,
        MAX(order_date) AS last_order_date
    FROM orders 
    GROUP BY customer_id
),
-- å®¢æˆ·æ´»è·ƒåº¦è®¡ç®—
customer_activity AS (
    SELECT 
        customer_id,
        total_orders,
        total_spent,
        avg_order_value,
        DATEDIFF(CURDATE(), last_order_date) AS days_since_last_order,
        DATEDIFF(last_order_date, first_order_date) AS customer_lifetime_days
    FROM customer_orders
),
-- å®¢æˆ·åˆ†çº§
customer_segments AS (
    SELECT 
        customer_id,
        total_orders,
        total_spent,
        days_since_last_order,
        CASE 
            WHEN total_spent >= 10000 AND days_since_last_order <= 30 THEN 'VIPæ´»è·ƒ'
            WHEN total_spent >= 10000 AND days_since_last_order > 30 THEN 'VIPæ²‰ç¡'
            WHEN total_spent >= 5000 AND days_since_last_order <= 60 THEN 'é‡è¦æ´»è·ƒ'
            WHEN total_spent >= 5000 AND days_since_last_order > 60 THEN 'é‡è¦æ²‰ç¡'
            WHEN days_since_last_order <= 90 THEN 'æ™®é€šæ´»è·ƒ'
            ELSE 'æ™®é€šæ²‰ç¡'
        END AS customer_segment
    FROM customer_activity
)
-- æœ€ç»ˆç»“æœï¼šå„å®¢æˆ·ç¾¤ä½“ç»Ÿè®¡
SELECT 
    customer_segment,
    COUNT(*) AS customer_count,
    AVG(total_spent) AS avg_customer_value,
    SUM(total_spent) AS segment_total_value
FROM customer_segments
GROUP BY customer_segment
ORDER BY segment_total_value DESC;
```

---

## 11. ğŸ¯ é«˜çº§æŸ¥è¯¢æŠ€å·§


### 11.1 å¤æ‚æ¡ä»¶æŸ¥è¯¢


#### å¤šæ¡ä»¶é€»è¾‘ç»„åˆ


**å¤æ‚ä¸šåŠ¡è§„åˆ™æŸ¥è¯¢**ï¼š

```sql
-- å¤æ‚çš„å®¢æˆ·ç­›é€‰è§„åˆ™
SELECT customer_id, customer_name, vip_level, total_spent, registration_date
FROM customers 
WHERE (
    -- VIPå®¢æˆ·ï¼šä¸é™åˆ¶æ¶ˆè´¹é‡‘é¢å’Œæ—¶é—´
    (vip_level IN ('gold', 'platinum'))
    OR 
    -- é«˜æ¶ˆè´¹å®¢æˆ·ï¼šæ¶ˆè´¹è¶…è¿‡5ä¸‡
    (total_spent > 50000)
    OR 
    -- æ–°å®¢æˆ·é«˜æ½œåŠ›ï¼šæ³¨å†Œ3ä¸ªæœˆå†…ä¸”æ¶ˆè´¹è¶…è¿‡5åƒ
    (registration_date >= DATE_SUB(CURDATE(), INTERVAL 3 MONTH) 
     AND total_spent > 5000)
) 
AND status = 'active'  -- å¿…é¡»æ˜¯æ´»è·ƒçŠ¶æ€
AND email IS NOT NULL; -- å¿…é¡»æœ‰é‚®ç®±è”ç³»æ–¹å¼
```

#### CASE WHEN æ¡ä»¶è¡¨è¾¾å¼


**å¤šæ¡ä»¶åˆ†æ”¯å¤„ç†**ï¼š

```sql
-- å‘˜å·¥ç»©æ•ˆç­‰çº§è¯„å®š
SELECT 
    name,
    department,
    sales_amount,
    customer_satisfaction,
    CASE 
        WHEN sales_amount >= 100000 AND customer_satisfaction >= 4.5 THEN 'Sçº§'
        WHEN sales_amount >= 80000 AND customer_satisfaction >= 4.0 THEN 'Açº§'
        WHEN sales_amount >= 60000 AND customer_satisfaction >= 3.5 THEN 'Bçº§'
        WHEN sales_amount >= 40000 AND customer_satisfaction >= 3.0 THEN 'Cçº§'
        ELSE 'Dçº§'
    END AS performance_grade,
    CASE 
        WHEN sales_amount >= 100000 THEN sales_amount * 0.05
        WHEN sales_amount >= 80000 THEN sales_amount * 0.04
        WHEN sales_amount >= 60000 THEN sales_amount * 0.03
        ELSE sales_amount * 0.02
    END AS bonus_amount
FROM sales_performance;
```

### 11.2 é«˜æ•ˆåˆ†é¡µæŸ¥è¯¢


#### ä¼ ç»ŸLIMITåˆ†é¡µçš„é—®é¢˜


**å¤§åç§»é‡åˆ†é¡µé—®é¢˜**ï¼š

```sql
-- æ•ˆç‡ä½ï¼šéœ€è¦æ‰«æå‰é¢æ‰€æœ‰æ•°æ®å†è·³è¿‡
SELECT * FROM products ORDER BY id LIMIT 100000, 20;
```

#### åŸºäºç´¢å¼•çš„åˆ†é¡µä¼˜åŒ–


**æ¸¸æ ‡åˆ†é¡µæ³•**ï¼š

```sql
-- ç¬¬ä¸€é¡µï¼šæ­£å¸¸æŸ¥è¯¢
SELECT * FROM products WHERE status = 'active' ORDER BY id LIMIT 20;

-- åç»­é¡µï¼šåŸºäºæœ€åä¸€æ¡è®°å½•çš„ID
SELECT * FROM products 
WHERE status = 'active' AND id > 12345  -- ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„ID
ORDER BY id 
LIMIT 20;
```

**å­æŸ¥è¯¢åˆ†é¡µæ³•**ï¼š

```sql
-- å…ˆæ‰¾åˆ°èµ·å§‹ä½ç½®çš„IDï¼Œå†æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯
SELECT * FROM products 
WHERE id >= (
    SELECT id FROM products 
    ORDER BY id 
    LIMIT 100000, 1
)
ORDER BY id 
LIMIT 20;
```

### 11.3 å»é‡æŸ¥è¯¢æŠ€å·§


#### å¤šç§å»é‡æ–¹æ³•å¯¹æ¯”


**DISTINCTå»é‡**ï¼š

```sql
-- ç®€å•å­—æ®µå»é‡
SELECT DISTINCT city FROM customers;

-- å¤šå­—æ®µç»„åˆå»é‡
SELECT DISTINCT city, age FROM customers;
```

**GROUP BYå»é‡**ï¼š

```sql
-- ä½¿ç”¨åˆ†ç»„å®ç°å»é‡ï¼ˆå¯ä»¥é…åˆå…¶ä»–èšåˆå‡½æ•°ï¼‰
SELECT city, COUNT(*) AS customer_count
FROM customers 
GROUP BY city;
```

**çª—å£å‡½æ•°å»é‡**ï¼š

```sql
-- ä¿ç•™æ¯ç»„ä¸­çš„ç¬¬ä¸€æ¡è®°å½•
SELECT customer_id, customer_name, city, registration_date
FROM (
    SELECT 
        customer_id, 
        customer_name, 
        city, 
        registration_date,
        ROW_NUMBER() OVER (PARTITION BY city ORDER BY registration_date) AS rn
    FROM customers
) ranked
WHERE rn = 1;
```

### 11.4 æ¡ä»¶ç»Ÿè®¡æŠ€å·§


#### CASE WHENç»Ÿè®¡


**æ¡ä»¶èšåˆç»Ÿè®¡**ï¼š

```sql
-- è®¢å•çŠ¶æ€åˆ†å¸ƒç»Ÿè®¡
SELECT 
    DATE(order_date) AS order_date,
    COUNT(*) AS total_orders,
    COUNT(CASE WHEN status = 'completed' THEN 1 END) AS completed_orders,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) AS pending_orders,
    COUNT(CASE WHEN status = 'cancelled' THEN 1 END) AS cancelled_orders,
    ROUND(
        COUNT(CASE WHEN status = 'completed' THEN 1 END) * 100.0 / COUNT(*), 2
    ) AS completion_rate
FROM orders 
WHERE order_date >= '2024-01-01'
GROUP BY DATE(order_date)
ORDER BY order_date;
```

#### SUM + CASEæ¡ä»¶æ±‚å’Œ


**é‡‘é¢ç»Ÿè®¡åˆ†æ**ï¼š

```sql
-- å„æ¸ é“é”€å”®é¢ç»Ÿè®¡
SELECT 
    customer_segment,
    COUNT(*) AS customer_count,
    SUM(CASE WHEN channel = 'online' THEN order_amount ELSE 0 END) AS online_sales,
    SUM(CASE WHEN channel = 'offline' THEN order_amount ELSE 0 END) AS offline_sales,
    SUM(CASE WHEN channel = 'mobile' THEN order_amount ELSE 0 END) AS mobile_sales,
    SUM(order_amount) AS total_sales
FROM customer_orders 
GROUP BY customer_segment
ORDER BY total_sales DESC;
```

### 11.5 åŠ¨æ€æŸ¥è¯¢æ„å»º


#### å¯é€‰æ¡ä»¶æŸ¥è¯¢


**çµæ´»çš„æœç´¢æ¡ä»¶**ï¼š

```sql
-- æ¨¡æ‹ŸåŠ¨æ€WHEREæ¡ä»¶ï¼ˆæ ¹æ®å‚æ•°å†³å®šæ˜¯å¦å¯ç”¨æ¡ä»¶ï¼‰
SELECT * FROM products 
WHERE 1=1  -- å ä½æ¡ä»¶ï¼Œä¾¿äºåç»­ANDæ¡ä»¶
  AND (@category IS NULL OR category = @category)
  AND (@min_price IS NULL OR price >= @min_price)  
  AND (@max_price IS NULL OR price <= @max_price)
  AND (@keyword IS NULL OR product_name LIKE CONCAT('%', @keyword, '%'));
```

**å¤šå€¼INæ¡ä»¶**ï¼š

```sql
-- å¤„ç†å¯å˜é•¿åº¦çš„INæ¡ä»¶
SELECT * FROM customers
WHERE FIND_IN_SET(city, 'åŒ—äº¬,ä¸Šæµ·,å¹¿å·') > 0;  -- åŸå¸‚åœ¨æŒ‡å®šåˆ—è¡¨ä¸­

-- æˆ–è€…ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼
SELECT * FROM customers 
WHERE city REGEXP 'åŒ—äº¬|ä¸Šæµ·|å¹¿å·';
```

---

## 12. âš¡ æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–


### 12.1 ç´¢å¼•åˆ©ç”¨æŸ¥è¯¢


#### ç­‰å€¼æŸ¥è¯¢ç´¢å¼•ä¼˜åŒ–


**å•åˆ—ç´¢å¼•åº”ç”¨**ï¼š

```sql
-- åˆ©ç”¨ä¸»é”®ç´¢å¼•ï¼ˆæœ€å¿«ï¼‰
SELECT * FROM users WHERE id = 12345;

-- åˆ©ç”¨å”¯ä¸€ç´¢å¼•
SELECT * FROM users WHERE email = 'user@example.com';

-- åˆ©ç”¨æ™®é€šç´¢å¼•
SELECT * FROM orders WHERE customer_id = 12345;
```

#### èŒƒå›´æŸ¥è¯¢ç´¢å¼•ä¼˜åŒ–


**èŒƒå›´æŸ¥è¯¢æœ€ä½³å®è·µ**ï¼š

```sql
-- å¥½çš„èŒƒå›´æŸ¥è¯¢ï¼šèƒ½å¤Ÿåˆ©ç”¨ç´¢å¼•
SELECT * FROM orders 
WHERE order_date >= '2024-01-01' AND order_date <= '2024-12-31'
ORDER BY order_date;

-- é¿å…ï¼šå‡½æ•°ç ´åç´¢å¼•
SELECT * FROM orders WHERE YEAR(order_date) = 2024;  -- ä¸ä¼šä½¿ç”¨ç´¢å¼•

-- æ¨èï¼šæ”¹å†™ä¸ºèŒƒå›´æŸ¥è¯¢
SELECT * FROM orders 
WHERE order_date >= '2024-01-01' AND order_date < '2025-01-01';
```

#### å¤åˆç´¢å¼•ä¼˜åŒ–


**æœ€å·¦å‰ç¼€åŸåˆ™**ï¼š

```sql
-- å‡è®¾æœ‰å¤åˆç´¢å¼•ï¼šKEY idx_customer_date (customer_id, order_date)

-- èƒ½ä½¿ç”¨ç´¢å¼•ï¼šç¬¦åˆæœ€å·¦å‰ç¼€
SELECT * FROM orders WHERE customer_id = 123;
SELECT * FROM orders WHERE customer_id = 123 AND order_date > '2024-01-01';

-- ä¸èƒ½ä½¿ç”¨ç´¢å¼•ï¼šè·³è¿‡äº†ç¬¬ä¸€ä¸ªå­—æ®µ  
SELECT * FROM orders WHERE order_date > '2024-01-01';
```

### 12.2 è¦†ç›–ç´¢å¼•æŸ¥è¯¢


**ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•**ï¼šæŸ¥è¯¢éœ€è¦çš„æ‰€æœ‰åˆ—éƒ½åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€å›è¡¨æŸ¥è¯¢ã€‚

```sql
-- å‡è®¾æœ‰ç´¢å¼•ï¼šKEY idx_name_email (name, email)

-- è¦†ç›–ç´¢å¼•æŸ¥è¯¢ï¼šåªéœ€è¦nameå’Œemailå­—æ®µ
SELECT name, email FROM users WHERE name = 'å¼ ä¸‰';

-- éè¦†ç›–ç´¢å¼•ï¼šéœ€è¦é¢å¤–çš„phoneå­—æ®µï¼Œå¿…é¡»å›è¡¨
SELECT name, email, phone FROM users WHERE name = 'å¼ ä¸‰';
```

**è¦†ç›–ç´¢å¼•çš„åº”ç”¨**ï¼š

```sql
-- ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–ï¼šåˆ©ç”¨ç´¢å¼•ç›´æ¥è®¡æ•°
SELECT COUNT(*) FROM orders WHERE status = 'completed';

-- å¦‚æœstatusæœ‰ç´¢å¼•ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šå¾ˆå¿«
-- å› ä¸ºCOUNT(*)å¯ä»¥ç›´æ¥ä»ç´¢å¼•è·å–ç»“æœ
```

### 12.3 æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’åˆ†æ


#### EXPLAINåˆ†æ


**æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’**ï¼š

```sql
-- åˆ†ææŸ¥è¯¢æ€§èƒ½
EXPLAIN SELECT * FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE o.order_date >= '2024-01-01';

-- è¯¦ç»†åˆ†æ
EXPLAIN FORMAT=JSON SELECT * FROM orders WHERE customer_id = 123;
```

**å…³é”®æŒ‡æ ‡è§£è¯»**ï¼š
```
typeåˆ—ï¼ˆè¿æ¥ç±»å‹ï¼Œæ€§èƒ½ä»å¥½åˆ°åï¼‰ï¼š
- constï¼šå¸¸é‡æŸ¥è¯¢ï¼Œæœ€å¿«
- eq_refï¼šä¸»é”®æˆ–å”¯ä¸€é”®æŸ¥è¯¢
- refï¼šç´¢å¼•æŸ¥è¯¢
- rangeï¼šèŒƒå›´æŸ¥è¯¢
- indexï¼šç´¢å¼•æ‰«æ
- ALLï¼šå…¨è¡¨æ‰«æï¼Œæœ€æ…¢

keyåˆ—ï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•
rowsåˆ—ï¼šä¼°ç®—æ‰«æè¡Œæ•°
Extraåˆ—ï¼šé¢å¤–ä¿¡æ¯
- Using indexï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•
- Using whereï¼šä½¿ç”¨WHEREè¿‡æ»¤
- Using temporaryï¼šä½¿ç”¨ä¸´æ—¶è¡¨
- Using filesortï¼šä½¿ç”¨æ–‡ä»¶æ’åº
```

### 12.4 å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–


#### åˆ†æ‰¹å¤„ç†ç­–ç•¥


**é¿å…å¤§äº‹åŠ¡**ï¼š

```sql
-- åˆ†æ‰¹åˆ é™¤æ•°æ®ï¼Œé¿å…é”è¡¨æ—¶é—´è¿‡é•¿
DELETE FROM logs WHERE created_date < '2023-01-01' LIMIT 1000;

-- åœ¨åº”ç”¨ç¨‹åºä¸­å¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°åˆ é™¤å®Œæˆ
-- æ¯æ¬¡åˆ é™¤åæš‚åœå‡ æ¯«ç§’ï¼Œå‡å°‘å¯¹ç³»ç»Ÿå½±å“
```

**åˆ†é¡µå¤„ç†å¤§ç»“æœé›†**ï¼š

```sql
-- å¤„ç†ç™¾ä¸‡çº§æ•°æ®çš„åˆ†é¡µæŸ¥è¯¢
SELECT * FROM large_table 
WHERE id > @last_id 
ORDER BY id 
LIMIT 5000;

-- @last_idåœ¨æ¯æ¬¡æŸ¥è¯¢åæ›´æ–°ä¸ºå½“å‰æ‰¹æ¬¡çš„æœ€å¤§ID
```

#### æŸ¥è¯¢ç¼“å­˜ä¼˜åŒ–


**æŸ¥è¯¢ç¼“å­˜ç›¸å…³**ï¼š

```sql
-- ç¦ç”¨ç‰¹å®šæŸ¥è¯¢çš„ç¼“å­˜ï¼ˆé€‚ç”¨äºé¢‘ç¹å˜æ›´çš„æ•°æ®ï¼‰
SELECT SQL_NO_CACHE * FROM real_time_data WHERE status = 'active';

-- å¼ºåˆ¶ä½¿ç”¨ç¼“å­˜
SELECT SQL_CACHE * FROM static_config WHERE type = 'system';
```

### 12.5 ç´¢å¼•æç¤º


**å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•**ï¼š

```sql
-- å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šç´¢å¼•
SELECT * FROM users USE INDEX (idx_city_age) 
WHERE city = 'åŒ—äº¬' AND age > 18;

-- å¿½ç•¥ç‰¹å®šç´¢å¼•
SELECT * FROM users IGNORE INDEX (idx_name) 
WHERE name LIKE '%å¼ %';

-- å¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼ˆå¦‚æœä¸èƒ½ä½¿ç”¨åˆ™æŠ¥é”™ï¼‰
SELECT * FROM users FORCE INDEX (idx_email) 
WHERE email = 'test@example.com';
```

---

## 13. ğŸ’¼ å®é™…ä¸šåŠ¡æŸ¥è¯¢æ¡ˆä¾‹


### 13.1 ç”µå•†ä¸šåŠ¡æŸ¥è¯¢


#### è®¢å•åˆ†ææŸ¥è¯¢


**è®¢å•è¯¦æƒ…ç»Ÿè®¡**ï¼š

```sql
-- è®¢å•è¯¦ç»†åˆ†æï¼šåŒ…å«å®¢æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯ã€æ”¯ä»˜ä¿¡æ¯
SELECT 
    o.order_id,
    o.order_no,
    c.customer_name,
    c.phone,
    c.city,
    o.order_date,
    o.status,
    COUNT(oi.item_id) AS item_count,
    SUM(oi.quantity * oi.unit_price) AS items_total,
    o.shipping_fee,
    o.discount_amount,
    o.total_amount,
    CASE o.status
        WHEN 'completed' THEN 'å·²å®Œæˆ'
        WHEN 'shipped' THEN 'å·²å‘è´§'
        WHEN 'processing' THEN 'å¤„ç†ä¸­'
        WHEN 'pending' THEN 'å¾…å¤„ç†'
        WHEN 'cancelled' THEN 'å·²å–æ¶ˆ'
    END AS status_desc,
    DATEDIFF(CURDATE(), o.order_date) AS days_since_order
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
LEFT JOIN order_items oi ON o.order_id = oi.order_id
WHERE o.order_date >= '2024-01-01'
GROUP BY o.order_id
ORDER BY o.order_date DESC;
```

#### é”€å”®ç»Ÿè®¡åˆ†æ


**æ¯æ—¥é”€å”®ç»Ÿè®¡**ï¼š

```sql
-- æ¯æ—¥é”€å”®æ±‡æ€»æŠ¥è¡¨
WITH daily_stats AS (
    SELECT 
        DATE(order_date) AS sale_date,
        COUNT(*) AS order_count,
        COUNT(DISTINCT customer_id) AS customer_count,
        SUM(total_amount) AS total_sales,
        AVG(total_amount) AS avg_order_value,
        SUM(CASE WHEN status = 'completed' THEN total_amount ELSE 0 END) AS completed_sales,
        COUNT(CASE WHEN status = 'cancelled' THEN 1 END) AS cancelled_count
    FROM orders
    WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    GROUP BY DATE(order_date)
)
SELECT 
    sale_date,
    order_count,
    customer_count,
    total_sales,
    ROUND(avg_order_value, 2) AS avg_order_value,
    completed_sales,
    cancelled_count,
    ROUND(cancelled_count * 100.0 / order_count, 2) AS cancellation_rate,
    -- ä¸å‰ä¸€å¤©å¯¹æ¯”
    LAG(total_sales) OVER (ORDER BY sale_date) AS prev_day_sales,
    ROUND(
        (total_sales - LAG(total_sales) OVER (ORDER BY sale_date)) / 
        LAG(total_sales) OVER (ORDER BY sale_date) * 100, 2
    ) AS day_over_day_growth
FROM daily_stats
ORDER BY sale_date DESC;
```

### 13.2 ç”¨æˆ·åˆ†ææŸ¥è¯¢


#### ç”¨æˆ·è¡Œä¸ºåˆ†æ


**ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ**ï¼š

```sql
-- ç”¨æˆ·æ´»è·ƒåº¦ä¸ä»·å€¼åˆ†æ
WITH user_activity AS (
    SELECT 
        u.customer_id,
        u.customer_name,
        u.registration_date,
        u.city,
        COUNT(o.order_id) AS total_orders,
        IFNULL(SUM(o.total_amount), 0) AS total_spent,
        IFNULL(AVG(o.total_amount), 0) AS avg_order_value,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date,
        DATEDIFF(CURDATE(), IFNULL(MAX(o.order_date), u.registration_date)) AS days_since_last_activity
    FROM customers u
    LEFT JOIN orders o ON u.customer_id = o.customer_id AND o.status = 'completed'
    GROUP BY u.customer_id
),
user_segments AS (
    SELECT 
        *,
        CASE 
            WHEN total_orders = 0 THEN 'æœªæ¶ˆè´¹ç”¨æˆ·'
            WHEN total_orders = 1 THEN 'å•æ¬¡æ¶ˆè´¹ç”¨æˆ·'
            WHEN total_orders BETWEEN 2 AND 5 THEN 'ä½é¢‘æ¶ˆè´¹ç”¨æˆ·'  
            WHEN total_orders BETWEEN 6 AND 15 THEN 'ä¸­é¢‘æ¶ˆè´¹ç”¨æˆ·'
            ELSE 'é«˜é¢‘æ¶ˆè´¹ç”¨æˆ·'
        END AS frequency_segment,
        CASE 
            WHEN total_spent = 0 THEN 'é›¶æ¶ˆè´¹'
            WHEN total_spent < 1000 THEN 'ä½ä»·å€¼'
            WHEN total_spent < 5000 THEN 'ä¸­ä»·å€¼'
            WHEN total_spent < 20000 THEN 'é«˜ä»·å€¼'
            ELSE 'è¶…é«˜ä»·å€¼'
        END AS value_segment,
        CASE 
            WHEN days_since_last_activity <= 30 THEN 'æ´»è·ƒ'
            WHEN days_since_last_activity <= 90 THEN 'ä¸€èˆ¬'
            ELSE 'æ²‰ç¡'
        END AS activity_segment
    FROM user_activity
)
SELECT 
    frequency_segment,
    value_segment,
    activity_segment,
    COUNT(*) AS user_count,
    ROUND(AVG(total_spent), 2) AS avg_customer_value,
    ROUND(AVG(days_since_last_activity), 0) AS avg_days_inactive
FROM user_segments
GROUP BY frequency_segment, value_segment, activity_segment
ORDER BY user_count DESC;
```

#### ç”¨æˆ·ç•™å­˜åˆ†æ


**æ–°ç”¨æˆ·ç•™å­˜ç‡åˆ†æ**ï¼š

```sql
-- è®¡ç®—æ–°ç”¨æˆ·çš„ç•™å­˜ç‡
WITH user_cohorts AS (
    SELECT 
        customer_id,
        DATE_FORMAT(registration_date, '%Y-%m') AS cohort_month,
        registration_date
    FROM customers
    WHERE registration_date >= '2024-01-01'
),
user_orders AS (
    SELECT 
        o.customer_id,
        MIN(o.order_date) AS first_order_date
    FROM orders o
    JOIN user_cohorts uc ON o.customer_id = uc.customer_id
    WHERE o.status = 'completed'
    GROUP BY o.customer_id
),
retention_analysis AS (
    SELECT 
        uc.cohort_month,
        COUNT(DISTINCT uc.customer_id) AS registered_users,
        COUNT(DISTINCT uo.customer_id) AS converted_users,
        COUNT(DISTINCT CASE 
            WHEN DATEDIFF(uo.first_order_date, uc.registration_date) <= 7 
            THEN uo.customer_id 
        END) AS day_7_buyers,
        COUNT(DISTINCT CASE 
            WHEN DATEDIFF(uo.first_order_date, uc.registration_date) <= 30 
            THEN uo.customer_id 
        END) AS day_30_buyers
    FROM user_cohorts uc
    LEFT JOIN user_orders uo ON uc.customer_id = uo.customer_id
    GROUP BY uc.cohort_month
)
SELECT 
    cohort_month,
    registered_users,
    converted_users,
    ROUND(converted_users * 100.0 / registered_users, 2) AS conversion_rate,
    day_7_buyers,
    ROUND(day_7_buyers * 100.0 / registered_users, 2) AS day_7_retention_rate,
    day_30_buyers,
    ROUND(day_30_buyers * 100.0 / registered_users, 2) AS day_30_retention_rate
FROM retention_analysis
ORDER BY cohort_month;
```

### 13.3 åº“å­˜ä¸å•†å“åˆ†æ


#### åº“å­˜çŠ¶æ€æŸ¥è¯¢


**å•†å“åº“å­˜ç»¼åˆåˆ†æ**ï¼š

```sql
-- å•†å“åº“å­˜çŠ¶æ€ä¸é”€å”®è¡¨ç°åˆ†æ
SELECT 
    p.category,
    p.product_name,
    p.price,
    IFNULL(i.stock_quantity, 0) AS current_stock,
    IFNULL(i.reserved_quantity, 0) AS reserved_stock,
    IFNULL(i.available_quantity, 0) AS available_stock,
    -- æœ€è¿‘30å¤©é”€é‡
    IFNULL(sales_30d.sold_quantity, 0) AS sold_last_30days,
    -- åº“å­˜å¤©æ•°é¢„ä¼°
    CASE 
        WHEN IFNULL(sales_30d.sold_quantity, 0) = 0 THEN 'æ— é”€é‡'
        ELSE CONCAT(
            ROUND(IFNULL(i.available_quantity, 0) / (IFNULL(sales_30d.sold_quantity, 0) / 30), 0), 
            'å¤©'
        )
    END AS estimated_stock_days,
    -- åº“å­˜çŠ¶æ€
    CASE 
        WHEN IFNULL(i.available_quantity, 0) = 0 THEN 'ç¼ºè´§'
        WHEN IFNULL(i.available_quantity, 0) < 10 THEN 'åº“å­˜ç´§å¼ '
        WHEN IFNULL(i.available_quantity, 0) < 50 THEN 'åº“å­˜æ­£å¸¸'
        ELSE 'åº“å­˜å……è¶³'
    END AS stock_status,
    -- å•†å“çŠ¶æ€
    CASE 
        WHEN p.status = 'active' THEN 'åœ¨å”®'
        WHEN p.status = 'inactive' THEN 'ä¸‹æ¶'
        ELSE 'å…¶ä»–'
    END AS product_status
FROM products p
LEFT JOIN inventory i ON p.product_id = i.product_id
LEFT JOIN (
    SELECT 
        oi.product_id,
        SUM(oi.quantity) AS sold_quantity
    FROM order_items oi
    JOIN orders o ON oi.order_id = o.order_id
    WHERE o.status = 'completed'
      AND o.order_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
    GROUP BY oi.product_id
) sales_30d ON p.product_id = sales_30d.product_id
ORDER BY 
    CASE 
        WHEN IFNULL(i.available_quantity, 0) = 0 THEN 1
        WHEN IFNULL(i.available_quantity, 0) < 10 THEN 2
        ELSE 3
    END,
    sales_30d.sold_quantity DESC;
```

#### å•†å“é”€é‡æ’è¡Œ


**é”€é‡æ’è¡Œæ¦œåˆ†æ**ï¼š

```sql
-- å•†å“é”€é‡æ’è¡Œæ¦œï¼ˆå¤šç»´åº¦åˆ†æï¼‰
WITH product_sales AS (
    SELECT 
        p.product_id,
        p.product_name,
        p.category,
        p.price,
        COUNT(DISTINCT o.order_id) AS order_count,
        SUM(oi.quantity) AS total_quantity_sold,
        SUM(oi.quantity * oi.unit_price) AS total_revenue,
        AVG(oi.unit_price) AS avg_selling_price,
        COUNT(DISTINCT o.customer_id) AS unique_customers
    FROM products p
    JOIN order_items oi ON p.product_id = oi.product_id
    JOIN orders o ON oi.order_id = o.order_id
    WHERE o.status = 'completed'
      AND o.order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)  -- æœ€è¿‘90å¤©
    GROUP BY p.product_id
),
ranked_products AS (
    SELECT 
        *,
        RANK() OVER (ORDER BY total_quantity_sold DESC) AS quantity_rank,
        RANK() OVER (ORDER BY total_revenue DESC) AS revenue_rank,
        RANK() OVER (PARTITION BY category ORDER BY total_quantity_sold DESC) AS category_quantity_rank
    FROM product_sales
)
SELECT 
    quantity_rank,
    product_name,
    category,
    price,
    total_quantity_sold,
    total_revenue,
    order_count,
    unique_customers,
    ROUND(total_revenue / total_quantity_sold, 2) AS avg_revenue_per_unit,
    ROUND(total_quantity_sold / order_count, 2) AS avg_quantity_per_order,
    category_quantity_rank
FROM ranked_products
WHERE quantity_rank <= 20  -- Top 20å•†å“
ORDER BY quantity_rank;
```

### 13.4 è´¢åŠ¡æŠ¥è¡¨æŸ¥è¯¢


#### æ”¶å…¥ç»Ÿè®¡åˆ†æ


**æœˆåº¦æ”¶å…¥æŠ¥è¡¨**ï¼š

```sql
-- ç»¼åˆè´¢åŠ¡æ”¶å…¥åˆ†ææŠ¥è¡¨
WITH monthly_revenue AS (
    SELECT 
        YEAR(order_date) AS revenue_year,
        MONTH(order_date) AS revenue_month,
        COUNT(*) AS total_orders,
        COUNT(DISTINCT customer_id) AS unique_customers,
        SUM(total_amount) AS gross_revenue,
        SUM(discount_amount) AS total_discounts,
        SUM(shipping_fee) AS shipping_revenue,
        SUM(total_amount - discount_amount) AS net_revenue,
        AVG(total_amount) AS avg_order_value
    FROM orders
    WHERE status = 'completed'
      AND order_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    GROUP BY YEAR(order_date), MONTH(order_date)
),
revenue_with_comparison AS (
    SELECT 
        *,
        CONCAT(revenue_year, '-', LPAD(revenue_month, 2, '0')) AS year_month,
        LAG(net_revenue) OVER (ORDER BY revenue_year, revenue_month) AS prev_month_revenue,
        LAG(net_revenue, 12) OVER (ORDER BY revenue_year, revenue_month) AS same_month_last_year
    FROM monthly_revenue
)
SELECT 
    year_month,
    total_orders,
    unique_customers,
    gross_revenue,
    total_discounts,
    shipping_revenue,
    net_revenue,
    ROUND(avg_order_value, 2) AS avg_order_value,
    -- ç¯æ¯”å¢é•¿ç‡
    CASE 
        WHEN prev_month_revenue IS NOT NULL THEN
            ROUND((net_revenue - prev_month_revenue) / prev_month_revenue * 100, 2)
        ELSE NULL
    END AS month_over_month_growth,
    -- åŒæ¯”å¢é•¿ç‡  
    CASE 
        WHEN same_month_last_year IS NOT NULL THEN
            ROUND((net_revenue - same_month_last_year) / same_month_last_year * 100, 2)
        ELSE NULL
    END AS year_over_year_growth,
    -- ç´¯è®¡æ”¶å…¥
    SUM(net_revenue) OVER (
        ORDER BY revenue_year, revenue_month 
        ROWS UNBOUNDED PRECEDING
    ) AS cumulative_revenue
FROM revenue_with_comparison
ORDER BY revenue_year DESC, revenue_month DESC;
```

---

## 14. ğŸ“Š æ•°æ®åˆ†ææŸ¥è¯¢


### 14.1 ç»Ÿè®¡åˆ†ææŸ¥è¯¢


#### åŸºç¡€ç»Ÿè®¡åˆ†æ


**å¤šç»´åº¦ç»Ÿè®¡åˆ†æ**ï¼š

```sql
-- ç”¨æˆ·è¡Œä¸ºç»¼åˆç»Ÿè®¡åˆ†æ
SELECT 
    'æ€»ä½“æ¦‚å†µ' AS metric_category,
    'ç”¨æˆ·æ€»æ•°' AS metric_name,
    COUNT(*) AS metric_value,
    NULL AS percentage
FROM customers

UNION ALL

SELECT 
    'ç”¨æˆ·çŠ¶æ€åˆ†å¸ƒ' AS metric_category,
    CONCAT(status, 'ç”¨æˆ·') AS metric_name,
    COUNT(*) AS metric_value,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM customers), 2) AS percentage
FROM customers
GROUP BY status

UNION ALL

SELECT 
    'åœ°åŸŸåˆ†å¸ƒ' AS metric_category,
    city AS metric_name,
    COUNT(*) AS metric_value,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM customers), 2) AS percentage  
FROM customers
WHERE city IS NOT NULL
GROUP BY city
HAVING COUNT(*) >= 10  -- åªæ˜¾ç¤ºç”¨æˆ·æ•°>=10çš„åŸå¸‚

ORDER BY metric_category, metric_value DESC;
```

#### ç™¾åˆ†æ¯”å’Œå æ¯”åˆ†æ


**å„ç»´åº¦å æ¯”åˆ†æ**ï¼š

```sql
-- é”€å”®é¢å æ¯”åˆ†æ  
WITH sales_by_category AS (
    SELECT 
        p.category,
        SUM(oi.quantity * oi.unit_price) AS category_sales,
        COUNT(DISTINCT o.customer_id) AS category_customers
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    WHERE o.status = 'completed'
      AND o.order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
    GROUP BY p.category
),
total_sales AS (
    SELECT SUM(category_sales) AS overall_total
    FROM sales_by_category
)
SELECT 
    sbc.category,
    sbc.category_sales,
    sbc.category_customers,
    ROUND(sbc.category_sales * 100.0 / ts.overall_total, 2) AS sales_percentage,
    ROUND(sbc.category_sales / sbc.category_customers, 2) AS avg_sales_per_customer,
    -- é”€å”®é¢æ’å
    RANK() OVER (ORDER BY sbc.category_sales DESC) AS sales_rank
FROM sales_by_category sbc
CROSS JOIN total_sales ts
ORDER BY sbc.category_sales DESC;
```

### 14.2 æ’åå’Œå¯¹æ¯”åˆ†æ


#### TOP Nåˆ†æ


**å¤šå±‚æ¬¡æ’ååˆ†æ**ï¼š

```sql
-- é”€å”®ä¸šç»©å¤šç»´åº¦æ’ååˆ†æ
WITH sales_performance AS (
    SELECT 
        sp.salesperson_id,
        sp.name,
        sp.department,
        sp.region,
        COUNT(DISTINCT o.order_id) AS total_orders,
        SUM(o.total_amount) AS total_sales,
        COUNT(DISTINCT o.customer_id) AS unique_customers,
        AVG(o.total_amount) AS avg_order_value,
        -- è®¡ç®—æœˆåº¦å¹³å‡é”€å”®é¢
        SUM(o.total_amount) / COUNT(DISTINCT DATE_FORMAT(o.order_date, '%Y-%m')) AS avg_monthly_sales
    FROM salespersons sp
    LEFT JOIN orders o ON sp.salesperson_id = o.salesperson_id
    WHERE o.order_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
      AND o.status = 'completed'
    GROUP BY sp.salesperson_id
),
ranked_performance AS (
    SELECT 
        *,
        -- å…¨å…¬å¸æ’å
        RANK() OVER (ORDER BY total_sales DESC) AS company_rank,
        -- éƒ¨é—¨å†…æ’å
        RANK() OVER (PARTITION BY department ORDER BY total_sales DESC) AS dept_rank,
        -- åŒºåŸŸå†…æ’å  
        RANK() OVER (PARTITION BY region ORDER BY total_sales DESC) AS region_rank,
        -- å®¢æˆ·æ•°é‡æ’å
        RANK() OVER (ORDER BY unique_customers DESC) AS customer_count_rank
    FROM sales_performance
)
SELECT 
    name,
    department,
    region,
    total_orders,
    total_sales,
    unique_customers,
    ROUND(avg_order_value, 2) AS avg_order_value,
    ROUND(avg_monthly_sales, 2) AS avg_monthly_sales,
    company_rank,
    dept_rank,
    region_rank,
    -- ç»©æ•ˆç­‰çº§è¯„å®š
    CASE 
        WHEN company_rank <= 5 THEN 'Sçº§æ˜æ˜Ÿ'
        WHEN company_rank <= 20 THEN 'Açº§ä¼˜ç§€'
        WHEN dept_rank <= 3 THEN 'Bçº§è‰¯å¥½'
        ELSE 'Cçº§æ™®é€š'
    END AS performance_grade
FROM ranked_performance
ORDER BY total_sales DESC
LIMIT 50;
```

#### åˆ†ç»„å¯¹æ¯”åˆ†æ


**ç¾¤ä½“å¯¹æ¯”åˆ†æ**ï¼š

```sql
-- VIP vs æ™®é€šå®¢æˆ·å¯¹æ¯”åˆ†æ
WITH customer_segments AS (
    SELECT 
        c.customer_id,
        c.customer_name,
        c.vip_level,
        c.registration_date,
        CASE 
            WHEN c.vip_level IN ('gold', 'platinum') THEN 'VIPå®¢æˆ·'
            ELSE 'æ™®é€šå®¢æˆ·'
        END AS customer_type,
        COUNT(o.order_id) AS total_orders,
        IFNULL(SUM(o.total_amount), 0) AS total_spent,
        IFNULL(AVG(o.total_amount), 0) AS avg_order_value,
        DATEDIFF(CURDATE(), MAX(o.order_date)) AS days_since_last_order
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id AND o.status = 'completed'
    GROUP BY c.customer_id
)
SELECT 
    customer_type,
    COUNT(*) AS customer_count,
    -- è®¢å•ç›¸å…³æŒ‡æ ‡
    ROUND(AVG(total_orders), 2) AS avg_orders_per_customer,
    SUM(total_orders) AS total_orders_all,
    -- é‡‘é¢ç›¸å…³æŒ‡æ ‡
    ROUND(AVG(total_spent), 2) AS avg_customer_value,
    SUM(total_spent) AS total_revenue,
    ROUND(AVG(avg_order_value), 2) AS avg_order_value,
    -- æ´»è·ƒåº¦æŒ‡æ ‡
    ROUND(AVG(days_since_last_order), 0) AS avg_days_since_last_order,
    COUNT(CASE WHEN days_since_last_order <= 30 THEN 1 END) AS active_customers,
    ROUND(
        COUNT(CASE WHEN days_since_last_order <= 30 THEN 1 END) * 100.0 / COUNT(*), 2
    ) AS active_rate
FROM customer_segments
GROUP BY customer_type
ORDER BY total_revenue DESC;
```

### 14.3 è¶‹åŠ¿åˆ†ææŸ¥è¯¢


#### æ—¶é—´åºåˆ—åˆ†æ


**é”€å”®è¶‹åŠ¿åˆ†æ**ï¼š

```sql
-- é”€å”®è¶‹åŠ¿åˆ†æï¼ˆæ—¥ã€å‘¨ã€æœˆå¤šæ—¶é—´ç»´åº¦ï¼‰
WITH daily_sales AS (
    SELECT 
        DATE(order_date) AS sale_date,
        DAYOFWEEK(order_date) AS day_of_week,
        WEEK(order_date) AS week_num,
        COUNT(*) AS daily_orders,
        SUM(total_amount) AS daily_revenue,
        COUNT(DISTINCT customer_id) AS daily_customers
    FROM orders
    WHERE status = 'completed'
      AND order_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
    GROUP BY DATE(order_date)
),
sales_with_trends AS (
    SELECT 
        *,
        -- 7æ—¥ç§»åŠ¨å¹³å‡
        AVG(daily_revenue) OVER (
            ORDER BY sale_date 
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ) AS revenue_7day_ma,
        -- ç¯æ¯”å¢é•¿ï¼ˆä¸å‰ä¸€å¤©æ¯”è¾ƒï¼‰
        LAG(daily_revenue, 1) OVER (ORDER BY sale_date) AS prev_day_revenue,
        -- å‘¨åŒæ¯”ï¼ˆä¸ä¸Šå‘¨åŒä¸€å¤©æ¯”è¾ƒï¼‰
        LAG(daily_revenue, 7) OVER (ORDER BY sale_date) AS same_day_last_week
    FROM daily_sales
)
SELECT 
    sale_date,
    CASE day_of_week
        WHEN 1 THEN 'å‘¨æ—¥' WHEN 2 THEN 'å‘¨ä¸€' WHEN 3 THEN 'å‘¨äºŒ'
        WHEN 4 THEN 'å‘¨ä¸‰' WHEN 5 THEN 'å‘¨å››' WHEN 6 THEN 'å‘¨äº”' 
        WHEN 7 THEN 'å‘¨å…­'
    END AS weekday,
    daily_orders,
    daily_revenue,
    daily_customers,
    ROUND(revenue_7day_ma, 2) AS revenue_7day_moving_avg,
    -- æ—¥ç¯æ¯”å¢é•¿ç‡
    CASE 
        WHEN prev_day_revenue > 0 THEN 
            ROUND((daily_revenue - prev_day_revenue) / prev_day_revenue * 100, 2)
        ELSE NULL
    END AS day_over_day_growth,
    -- å‘¨åŒæ¯”å¢é•¿ç‡
    CASE 
        WHEN same_day_last_week > 0 THEN 
            ROUND((daily_revenue - same_day_last_week) / same_day_last_week * 100, 2)
        ELSE NULL  
    END AS week_over_week_growth
FROM sales_with_trends
ORDER BY sale_date DESC
LIMIT 30;
```

### 14.4 æ•°æ®é€è§†åˆ†æ


#### è¡Œè½¬åˆ—é€è§†


**é”€å”®æ•°æ®é€è§†åˆ†æ**ï¼š

```sql
-- æŒ‰æœˆä»½å’Œäº§å“ç±»åˆ«çš„é”€å”®é¢é€è§†è¡¨
WITH monthly_category_sales AS (
    SELECT 
        DATE_FORMAT(o.order_date, '%Y-%m') AS sale_month,
        p.category,
        SUM(oi.quantity * oi.unit_price) AS sales_amount
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p ON oi.product_id = p.product_id
    WHERE o.status = 'completed'
      AND o.order_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
    GROUP BY DATE_FORMAT(o.order_date, '%Y-%m'), p.category
)
SELECT 
    sale_month,
    ROUND(SUM(CASE WHEN category = 'ç”µå­äº§å“' THEN sales_amount ELSE 0 END), 2) AS electronics_sales,
    ROUND(SUM(CASE WHEN category = 'æœè£…é‹å¸½' THEN sales_amount ELSE 0 END), 2) AS clothing_sales,
    ROUND(SUM(CASE WHEN category = 'å®¶å±…ç”¨å“' THEN sales_amount ELSE 0 END), 2) AS home_sales,
    ROUND(SUM(CASE WHEN category = 'å›¾ä¹¦éŸ³åƒ' THEN sales_amount ELSE 0 END), 2) AS books_sales,
    ROUND(SUM(CASE WHEN category = 'é£Ÿå“é¥®æ–™' THEN sales_amount ELSE 0 END), 2) AS food_sales,
    ROUND(SUM(sales_amount), 2) AS total_sales,
    -- è®¡ç®—å„ç±»åˆ«å æ¯”
    ROUND(SUM(CASE WHEN category = 'ç”µå­äº§å“' THEN sales_amount ELSE 0 END) / SUM(sales_amount) * 100, 2) AS electronics_pct,
    ROUND(SUM(CASE WHEN category = 'æœè£…é‹å¸½' THEN sales_amount ELSE 0 END) / SUM(sales_amount) * 100, 2) AS clothing_pct
FROM monthly_category_sales
GROUP BY sale_month
ORDER BY sale_month DESC;
```

---

## 15. âš¡ æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ


### 15.1 é«˜æ•ˆæŸ¥è¯¢ç¼–å†™åŸåˆ™


#### æŸ¥è¯¢ä¼˜åŒ–åŸºæœ¬åŸåˆ™


**æ ¸å¿ƒä¼˜åŒ–æ€è·¯**ï¼š

```sql
-- 1. å…ˆè¿‡æ»¤ï¼Œåè¿æ¥ï¼šå‡å°‘è¿æ¥çš„æ•°æ®é‡
-- å¥½çš„å†™æ³•ï¼šå…ˆè¿‡æ»¤å†è¿æ¥
SELECT c.name, o.order_date, o.total_amount
FROM customers c
JOIN (
    SELECT customer_id, order_date, total_amount 
    FROM orders 
    WHERE order_date >= '2024-01-01'  -- å…ˆè¿‡æ»¤
) o ON c.customer_id = o.customer_id;

-- 2. ä½¿ç”¨EXISTSæ›¿ä»£INï¼ˆå­æŸ¥è¯¢ç»“æœé›†å¾ˆå¤§æ—¶ï¼‰
-- æ¨èï¼šä½¿ç”¨EXISTS
SELECT * FROM customers c
WHERE EXISTS (
    SELECT 1 FROM orders o 
    WHERE o.customer_id = c.customer_id 
      AND o.total_amount > 1000
);

-- 3. é¿å…SELECT *ï¼ŒåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
-- å¥½çš„å†™æ³•ï¼šæŒ‡å®šå…·ä½“å­—æ®µ
SELECT customer_id, name, email FROM customers WHERE city = 'åŒ—äº¬';
```

#### ç´¢å¼•å‹å¥½çš„æŸ¥è¯¢å†™æ³•


**ç´¢å¼•æœ€ä½³å®è·µ**ï¼š

```sql
-- 1. ç­‰å€¼æŸ¥è¯¢ä¼˜äºèŒƒå›´æŸ¥è¯¢
SELECT * FROM orders WHERE customer_id = 123;  -- ä¼˜å…ˆä½¿ç”¨

-- 2. é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
-- ä¸å¥½çš„å†™æ³•ï¼š
SELECT * FROM orders WHERE YEAR(order_date) = 2024;

-- å¥½çš„å†™æ³•ï¼š
SELECT * FROM orders 
WHERE order_date >= '2024-01-01' AND order_date < '2025-01-01';

-- 3. å¤åˆç´¢å¼•çš„å­—æ®µé¡ºåºå¾ˆé‡è¦
-- å‡è®¾ç´¢å¼•ä¸º KEY idx_customer_date_status (customer_id, order_date, status)
-- èƒ½å……åˆ†åˆ©ç”¨ç´¢å¼•ï¼š
SELECT * FROM orders 
WHERE customer_id = 123 
  AND order_date >= '2024-01-01' 
  AND status = 'completed';
```

### 15.2 å¤§æ•°æ®é‡æŸ¥è¯¢ä¼˜åŒ–


#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


**æ·±åº¦åˆ†é¡µä¼˜åŒ–ç­–ç•¥**ï¼š

```sql
-- æ–¹æ³•1ï¼šä½¿ç”¨å­æŸ¥è¯¢åˆ†é¡µï¼ˆæ¨èï¼‰
SELECT o.* FROM orders o
JOIN (
    SELECT order_id FROM orders 
    ORDER BY order_id 
    LIMIT 100000, 20
) tmp ON o.order_id = tmp.order_id;

-- æ–¹æ³•2ï¼šæ¸¸æ ‡åˆ†é¡µï¼ˆæ€§èƒ½æœ€å¥½ï¼‰
SELECT * FROM orders 
WHERE order_id > 1234567  -- ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªID
ORDER BY order_id 
LIMIT 20;

-- æ–¹æ³•3ï¼šåŸºäºæ—¶é—´çš„åˆ†é¡µ
SELECT * FROM orders 
WHERE created_date >= '2024-01-15 10:30:00'  -- ä¸Šä¸€é¡µçš„æœ€åæ—¶é—´
ORDER BY created_date, order_id 
LIMIT 20;
```

#### æ‰¹é‡æ•°æ®å¤„ç†


**é¿å…å¤§äº‹åŠ¡çš„ç­–ç•¥**ï¼š

```sql
-- åˆ†æ‰¹æ›´æ–°æ•°æ®
UPDATE orders SET status = 'archived' 
WHERE order_date < '2023-01-01' 
  AND status = 'completed'
LIMIT 1000;

-- åˆ†æ‰¹åˆ é™¤æ•°æ®  
DELETE FROM logs 
WHERE created_date < DATE_SUB(NOW(), INTERVAL 1 YEAR)
LIMIT 5000;

-- åœ¨åº”ç”¨ç¨‹åºä¸­å¾ªç¯æ‰§è¡Œï¼Œæ¯æ¬¡é—´éš”å‡ æ¯«ç§’
-- é¿å…é•¿æ—¶é—´é”è¡¨å½±å“å…¶ä»–æ“ä½œ
```

### 15.3 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–


#### å­æŸ¥è¯¢ä¼˜åŒ–


**å­æŸ¥è¯¢é‡å†™æŠ€å·§**ï¼š

```sql
-- 1. å°†ç›¸å…³å­æŸ¥è¯¢æ”¹ä¸ºè¿æ¥æŸ¥è¯¢
-- ä½æ•ˆçš„ç›¸å…³å­æŸ¥è¯¢ï¼š
SELECT * FROM customers c
WHERE (
    SELECT COUNT(*) FROM orders o 
    WHERE o.customer_id = c.customer_id
) > 5;

-- ä¼˜åŒ–åçš„è¿æ¥æŸ¥è¯¢ï¼š
SELECT DISTINCT c.* FROM customers c
JOIN (
    SELECT customer_id FROM orders 
    GROUP BY customer_id 
    HAVING COUNT(*) > 5
) o ON c.customer_id = o.customer_id;

-- 2. ä½¿ç”¨ä¸´æ—¶è¡¨å¤„ç†å¤æ‚é€»è¾‘
CREATE TEMPORARY TABLE high_value_customers AS
SELECT customer_id, SUM(total_amount) AS total_spent
FROM orders 
WHERE status = 'completed'
GROUP BY customer_id
HAVING SUM(total_amount) > 10000;

-- ç„¶åä½¿ç”¨ä¸´æ—¶è¡¨è¿›è¡Œåç»­æŸ¥è¯¢
SELECT c.name, hvc.total_spent
FROM customers c
JOIN high_value_customers hvc ON c.customer_id = hvc.customer_id;
```

#### èšåˆæŸ¥è¯¢ä¼˜åŒ–


**èšåˆå‡½æ•°ä¼˜åŒ–æŠ€å·§**ï¼š

```sql
-- 1. ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–COUNTæŸ¥è¯¢
-- å¦‚æœåªéœ€è¦è®¡æ•°ï¼Œè€ƒè™‘ä½¿ç”¨ç´¢å¼•å­—æ®µ
SELECT COUNT(customer_id) FROM orders;  -- å¦‚æœcustomer_idæœ‰ç´¢å¼•

-- 2. é¿å…COUNT(DISTINCT)çš„æ€§èƒ½é—®é¢˜
-- ä½æ•ˆå†™æ³•ï¼š
SELECT COUNT(DISTINCT customer_id) FROM orders;

-- ä¼˜åŒ–å†™æ³•ï¼š
SELECT COUNT(*) FROM (
    SELECT customer_id FROM orders GROUP BY customer_id
) tmp;

-- 3. ä½¿ç”¨UNION ALLä¼˜åŒ–å¤æ‚ç»Ÿè®¡
-- å°†å¤æ‚çš„ç»Ÿè®¡æ‹†åˆ†æˆå¤šä¸ªç®€å•æŸ¥è¯¢ï¼Œå†UNION
SELECT 'total_orders' AS metric, COUNT(*) AS value FROM orders
UNION ALL
SELECT 'completed_orders', COUNT(*) FROM orders WHERE status = 'completed'  
UNION ALL
SELECT 'total_revenue', SUM(total_amount) FROM orders WHERE status = 'completed';
```

### 15.4 ç¼“å­˜å’Œå­˜å‚¨ä¼˜åŒ–


#### æŸ¥è¯¢ç¼“å­˜ç­–ç•¥


**æŸ¥è¯¢ç¼“å­˜ä½¿ç”¨å»ºè®®**ï¼š

```sql
-- 1. å¯¹äºé¢‘ç¹æŸ¥è¯¢ä¸”æ•°æ®å˜åŒ–ä¸é¢‘ç¹çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ç¼“å­˜
SELECT SQL_CACHE * FROM products WHERE category = 'electronics';

-- 2. å¯¹äºå®æ—¶æ€§è¦æ±‚é«˜çš„æŸ¥è¯¢ï¼Œç¦ç”¨ç¼“å­˜
SELECT SQL_NO_CACHE * FROM inventory WHERE product_id = 123;

-- 3. ä½¿ç”¨åº”ç”¨å±‚ç¼“å­˜ä»£æ›¿æŸ¥è¯¢ç¼“å­˜
-- åœ¨åº”ç”¨ç¨‹åºä¸­ç¼“å­˜æŸ¥è¯¢ç»“æœï¼Œæ§åˆ¶ç¼“å­˜å¤±æ•ˆç­–ç•¥
```

#### åˆ†åŒºè¡¨æŸ¥è¯¢


**åˆ†åŒºè¡¨æŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- åˆ©ç”¨åˆ†åŒºè£å‰ªï¼ŒåªæŸ¥è¯¢ç›¸å…³åˆ†åŒº
SELECT * FROM orders_partitioned 
WHERE order_date >= '2024-01-01' 
  AND order_date < '2024-02-01';

-- è·¨åˆ†åŒºæŸ¥è¯¢æ—¶æ³¨æ„æ€§èƒ½å½±å“
SELECT customer_id, COUNT(*) 
FROM orders_partitioned 
GROUP BY customer_id;  -- å¯èƒ½éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†åŒº
```

### 15.5 ç›‘æ§å’Œè°ƒä¼˜


#### æ…¢æŸ¥è¯¢è¯†åˆ«


**æ…¢æŸ¥è¯¢åˆ†ææ–¹æ³•**ï¼š

```sql
-- 1. æŸ¥çœ‹å½“å‰è¿è¡Œçš„æŸ¥è¯¢
SHOW PROCESSLIST;

-- 2. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—é…ç½®
SHOW VARIABLES LIKE 'slow_query%';

-- 3. åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN FORMAT=JSON 
SELECT * FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE o.order_date >= '2024-01-01';

-- 4. æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SHOW INDEX FROM orders;
```

#### æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**å…³é”®æ€§èƒ½æŒ‡æ ‡**ï¼š

```sql
-- 1. æŸ¥çœ‹è¡¨çš„çŠ¶æ€ä¿¡æ¯
SHOW TABLE STATUS LIKE 'orders';

-- 2. æŸ¥çœ‹ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
SELECT 
    table_name,
    index_name,
    seq_in_index,
    column_name,
    cardinality
FROM information_schema.statistics 
WHERE table_schema = 'your_database'
  AND table_name = 'orders';

-- 3. ç›‘æ§è¿æ¥æ•°å’ŒæŸ¥è¯¢æ•°
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Questions';
```

---

## 16. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 16.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SELECTåŸºç¡€ï¼šæŸ¥è¯¢è¯­æ³•ã€å­—æ®µé€‰æ‹©ã€åˆ«åã€LIMIT
ğŸ”¸ WHEREæ¡ä»¶ï¼šæ¯”è¾ƒæ“ä½œã€é€»è¾‘ç»„åˆã€èŒƒå›´æŸ¥è¯¢ã€æ¨¡ç³ŠåŒ¹é…ã€ç©ºå€¼å¤„ç†
ğŸ”¸ ORDER BYæ’åºï¼šå•å­—æ®µã€å¤šå­—æ®µã€è¡¨è¾¾å¼æ’åºã€è‡ªå®šä¹‰æ’åº
ğŸ”¸ GROUP BYåˆ†ç»„ï¼šåŸºç¡€åˆ†ç»„ã€å¤šå­—æ®µåˆ†ç»„ã€èšåˆå‡½æ•°åº”ç”¨
ğŸ”¸ HAVINGè¿‡æ»¤ï¼šèšåˆç»“æœè¿‡æ»¤ã€å¤æ‚æ¡ä»¶ç»„åˆ
ğŸ”¸ å­æŸ¥è¯¢ï¼šæ ‡é‡ã€åˆ—ã€è¡Œã€è¡¨å­æŸ¥è¯¢ã€EXISTSå­æŸ¥è¯¢
ğŸ”¸ è¡¨è¿æ¥ï¼šå†…è¿æ¥ã€å¤–è¿æ¥ã€å¤šè¡¨è¿æ¥ã€è‡ªè¿æ¥
ğŸ”¸ UNIONè”åˆï¼šç»“æœåˆå¹¶ã€å»é‡ä¸ä¿ç•™ã€å¤æ‚åº”ç”¨
ğŸ”¸ çª—å£å‡½æ•°ï¼šæ’åã€èšåˆã€å–å€¼å‡½æ•°ã€çª—å£èŒƒå›´æ§åˆ¶
ğŸ”¸ CTEè¡¨è¾¾å¼ï¼šéé€’å½’ã€é€’å½’CTEåº”ç”¨
ğŸ”¸ é«˜çº§æŠ€å·§ï¼šå¤æ‚æ¡ä»¶ã€åˆ†é¡µä¼˜åŒ–ã€å»é‡æ–¹æ³•ã€æ¡ä»¶ç»Ÿè®¡
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç´¢å¼•åˆ©ç”¨ã€è¦†ç›–ç´¢å¼•ã€æ‰§è¡Œè®¡åˆ’åˆ†æ
```

### 16.2 æŸ¥è¯¢ç¼–å†™æœ€ä½³å®è·µ


**ğŸ”¹ SQLç¼–å†™è§„èŒƒ**
```
å¯è¯»æ€§åŸåˆ™ï¼š
â€¢ ä½¿ç”¨é€‚å½“çš„ç¼©è¿›å’Œæ¢è¡Œ
â€¢ å…³é”®å­—å¤§å†™ï¼Œå­—æ®µåå°å†™
â€¢ å¤æ‚æŸ¥è¯¢ä½¿ç”¨CTEåˆ†è§£
â€¢ æ·»åŠ å¿…è¦çš„æ³¨é‡Šè¯´æ˜

æ€§èƒ½ä¼˜å…ˆåŸåˆ™ï¼š
â€¢ å…ˆè¿‡æ»¤åè¿æ¥ï¼Œå‡å°‘æ•°æ®é‡
â€¢ åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œé¿å…SELECT *
â€¢ åˆç†ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æ
â€¢ å¤æ‚æŸ¥è¯¢è€ƒè™‘åˆ†æ­¥å¤„ç†
```

**ğŸ”¹ æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**
```
ç´¢å¼•ä¼˜åŒ–ï¼š
â€¢ åœ¨WHEREã€ORDER BYã€JOINå­—æ®µä¸Šå»ºç«‹ç´¢å¼•
â€¢ å¤åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
â€¢ é¿å…åœ¨ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨å‡½æ•°
â€¢ å®šæœŸåˆ†æå’Œä¼˜åŒ–ç´¢å¼•ä½¿ç”¨æƒ…å†µ

æŸ¥è¯¢é‡å†™ï¼š
â€¢ ç›¸å…³å­æŸ¥è¯¢æ”¹ä¸ºè¿æ¥æŸ¥è¯¢
â€¢ å¤æ‚HAVINGæ”¹ä¸ºWHEREæ¡ä»¶
â€¢ å¤§ç»“æœé›†ä½¿ç”¨LIMITé™åˆ¶
â€¢ åˆç†ä½¿ç”¨ä¸´æ—¶è¡¨å¤„ç†å¤æ‚é€»è¾‘
```

### 16.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
```
ç”µå•†åœºæ™¯ï¼š
â€¢ è®¢å•ç»Ÿè®¡ï¼šé”€å”®é¢ã€è®¢å•æ•°ã€å®¢æˆ·æ•°åˆ†æ
â€¢ ç”¨æˆ·åˆ†æï¼šç”¨æˆ·ä»·å€¼ã€æ´»è·ƒåº¦ã€ç•™å­˜ç‡åˆ†æ
â€¢ å•†å“åˆ†æï¼šé”€é‡æ’è¡Œã€åº“å­˜çŠ¶æ€ã€ç±»åˆ«å¯¹æ¯”
â€¢ è´¢åŠ¡æŠ¥è¡¨ï¼šæ”¶å…¥ç»Ÿè®¡ã€åŒæ¯”ç¯æ¯”åˆ†æ

ä¼ä¸šç®¡ç†ï¼š
â€¢ å‘˜å·¥ç®¡ç†ï¼šéƒ¨é—¨ç»Ÿè®¡ã€ç»©æ•ˆæ’åã€è–ªèµ„åˆ†æ
â€¢ é¡¹ç›®ç®¡ç†ï¼šè¿›åº¦è·Ÿè¸ªã€èµ„æºåˆ†é…ã€æˆæœ¬åˆ†æ
â€¢ å®¢æˆ·å…³ç³»ï¼šå®¢æˆ·åˆ†çº§ã€æ»¡æ„åº¦åˆ†æã€æµå¤±é¢„è­¦
```

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**
```
ç®€å•æŸ¥è¯¢ï¼š
â€¢ ä½¿ç”¨åŸºç¡€SELECTã€WHEREã€ORDER BY
â€¢ é€‚åˆæ•°æ®é‡å°ã€é€»è¾‘ç®€å•çš„åœºæ™¯

å¤æ‚åˆ†æï¼š
â€¢ ä½¿ç”¨çª—å£å‡½æ•°ã€CTEã€å­æŸ¥è¯¢ç»„åˆ
â€¢ é€‚åˆå¤æ‚ç»Ÿè®¡ã€æ’åã€è¶‹åŠ¿åˆ†æ

å¤§æ•°æ®é‡ï¼š
â€¢ ä¼˜å…ˆè€ƒè™‘åˆ†é¡µã€ç´¢å¼•ã€åˆ†åŒº
â€¢ ä½¿ç”¨æ‰¹é‡å¤„ç†ï¼Œé¿å…å¤§äº‹åŠ¡
â€¢ è€ƒè™‘è¯»å†™åˆ†ç¦»ã€ç¼“å­˜ç­–ç•¥
```

### 16.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“ å­¦ä¹ å»ºè®®**
```
åˆçº§é˜¶æ®µï¼š
1. æŒæ¡SELECTã€WHEREã€ORDER BYåŸºæœ¬è¯­æ³•
2. ç†Ÿç»ƒä½¿ç”¨GROUP BYå’Œèšåˆå‡½æ•°
3. ç†è§£åŸºæœ¬çš„è¡¨è¿æ¥æ“ä½œ
4. å­¦ä¼šç®€å•çš„å­æŸ¥è¯¢åº”ç”¨

ä¸­çº§é˜¶æ®µï¼š
1. æŒæ¡å¤æ‚çš„å¤šè¡¨è¿æ¥å’Œå­æŸ¥è¯¢
2. å­¦ä¹ çª—å£å‡½æ•°å’ŒCTEåº”ç”¨
3. ç†è§£ç´¢å¼•åŸç†å’ŒæŸ¥è¯¢ä¼˜åŒ–
4. èƒ½å¤Ÿåˆ†ææ‰§è¡Œè®¡åˆ’

é«˜çº§é˜¶æ®µï¼š
1. ç²¾é€šå¤æ‚çš„ä¸šåŠ¡æŸ¥è¯¢ç¼–å†™
2. èƒ½å¤Ÿè¿›è¡Œæ·±åº¦æ€§èƒ½ä¼˜åŒ–
3. æŒæ¡å¤§æ•°æ®é‡æŸ¥è¯¢å¤„ç†
4. å…·å¤‡æ•°æ®åº“æ¶æ„è®¾è®¡èƒ½åŠ›
```

**âš ï¸ å¸¸è§é™·é˜±**
```
æ€§èƒ½é™·é˜±ï¼š
â€¢ SELECT * æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
â€¢ åœ¨å¤§è¡¨ä¸Šä½¿ç”¨OFFSETæ·±åº¦åˆ†é¡µ
â€¢ åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
â€¢ ä¸åˆç†çš„å­æŸ¥è¯¢å’Œè¿æ¥

é€»è¾‘é™·é˜±ï¼š
â€¢ NULLå€¼çš„æ¯”è¾ƒå’Œåˆ¤æ–­
â€¢ GROUP BYå’ŒHAVINGçš„ä½¿ç”¨é¡ºåº
â€¢ UNIONå’ŒUNION ALLçš„é€‰æ‹©
â€¢ å¤–è¿æ¥çš„é€»è¾‘ç†è§£

æ•°æ®é™·é˜±ï¼š
â€¢ é‡å¤æ•°æ®çš„å¤„ç†
â€¢ æ•°æ®ç±»å‹è½¬æ¢é—®é¢˜
â€¢ æ—¶åŒºå’Œæ—¥æœŸæ ¼å¼é—®é¢˜
â€¢ å­—ç¬¦ç¼–ç å’Œæ’åºè§„åˆ™
```

### 16.5 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ’¡ å®ç”¨æŠ€å·§**
```
è°ƒè¯•æŠ€å·§ï¼š
â€¢ ä½¿ç”¨EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’
â€¢ åˆ†æ­¥éªŒè¯å¤æ‚æŸ¥è¯¢çš„æ¯ä¸ªéƒ¨åˆ†
â€¢ ä½¿ç”¨ä¸´æ—¶è¡¨ç®€åŒ–å¤æ‚é€»è¾‘
â€¢ è®°å½•å’Œåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—

ç»´æŠ¤æŠ€å·§ï¼š
â€¢ å®šæœŸæ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
â€¢ ç›‘æ§ç´¢å¼•ä½¿ç”¨æƒ…å†µå’Œç¢ç‰‡
â€¢ åŠæ—¶æ¸…ç†æ— ç”¨çš„å†å²æ•°æ®
â€¢ å»ºç«‹æŸ¥è¯¢æ€§èƒ½åŸºå‡†æµ‹è¯•

å›¢é˜Ÿåä½œï¼š
â€¢ å»ºç«‹SQLç¼–å†™è§„èŒƒå’Œæ¨¡æ¿
â€¢ ä»£ç å®¡æŸ¥å…³æ³¨æ€§èƒ½å’Œå¯è¯»æ€§
â€¢ æ–‡æ¡£åŒ–å¤æ‚æŸ¥è¯¢çš„ä¸šåŠ¡é€»è¾‘
â€¢ åˆ†äº«æœ€ä½³å®è·µå’Œç»éªŒæ•™è®­
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æŸ¥è¯¢å…ˆæƒ³ç´¢å¼•ç”¨ï¼Œè¿‡æ»¤æ¡ä»¶è¦åˆç†
- åˆ†ç»„èšåˆè¦æ˜ç¡®ï¼Œçª—å£å‡½æ•°å·§åº”ç”¨  
- è¿æ¥å­æŸ¥è¯¢çµæ´»ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯å…³é”®
- ä¸šåŠ¡é€»è¾‘è¦æ¸…æ™°ï¼Œå¯è¯»ç»´æŠ¤æœ€é‡è¦