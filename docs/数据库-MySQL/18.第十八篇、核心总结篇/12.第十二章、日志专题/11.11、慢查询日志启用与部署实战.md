---
title: 11、慢查询日志启用与部署实战
---
## 📚 目录

1. [启用前的环境检查](#1-启用前的环境检查)
2. [慢查询日志启用配置](#2-慢查询日志启用配置)
3. [日志文件位置规划](#3-日志文件位置规划)
4. [磁盘空间规划与监控](#4-磁盘空间规划与监控)
5. [生产环境部署实战](#5-生产环境部署实战)
6. [部署后功能验证](#6-部署后功能验证)
7. [常见部署问题排查](#7-常见部署问题排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 启用前的环境检查


### 1.1 什么是环境检查


**通俗解释**：就像搬新家前要先检查房子的水电气一样，启用慢查询日志前也要检查MySQL环境是否准备好了。

**检查的目的**：
- 🎯 确保MySQL版本支持慢查询功能
- 🎯 检查当前配置状态，避免重复设置
- 🎯 评估服务器资源，确保不会影响性能

### 1.2 检查MySQL版本和权限


**📋 基础检查命令**

```sql
-- 查看MySQL版本（确保版本支持慢查询）
SELECT VERSION();

-- 查看当前用户权限（确保有管理权限）
SHOW GRANTS FOR CURRENT_USER();

-- 检查是否为超级用户
SELECT USER(), SUPER_PRIV FROM mysql.user WHERE user = USER();
```

**💡 版本要求说明**：
- MySQL 5.0+ 都支持慢查询日志
- 但建议使用 5.7+ 版本，功能更完善

### 1.3 当前慢查询配置检查


**🔍 检查现有配置**

```sql
-- 查看所有慢查询相关配置
SHOW VARIABLES LIKE 'slow%';

-- 查看长查询时间设置
SHOW VARIABLES LIKE 'long_query_time';

-- 查看是否记录没有使用索引的查询
SHOW VARIABLES LIKE 'log_queries_not_using_indexes';
```

**📊 配置参数含义解释**

| 参数名称 | 含义解释 | 默认值 | 建议值 |
|---------|---------|--------|--------|
| `slow_query_log` | 是否开启慢查询日志 | OFF | ON |
| `slow_query_log_file` | 慢查询日志文件路径 | 自动生成 | 自定义路径 |
| `long_query_time` | 慢查询时间阈值(秒) | 10 | 1-5 |
| `log_queries_not_using_indexes` | 记录未使用索引的查询 | OFF | ON |

### 1.4 服务器资源检查


**💻 检查服务器资源**

```bash
# 检查磁盘空间（慢查询日志会占用磁盘）
df -h

# 检查MySQL数据目录位置
mysql -e "SHOW VARIABLES LIKE 'datadir';"

# 检查MySQL进程状态
ps aux | grep mysql

# 检查系统负载
top -p `pgrep mysql`
```

---

## 2. ⚙️ 慢查询日志启用配置


### 2.1 启用方式对比


**🔄 两种启用方式对比**

```
方式1：动态启用（SET GLOBAL命令）
优点：立即生效，无需重启MySQL
缺点：重启后失效，临时性设置

方式2：配置文件启用（my.cnf）
优点：永久生效，重启后依然有效
缺点：需要重启MySQL服务
```

### 2.2 动态启用详解


**⚡ SET GLOBAL命令启用**

```sql
-- 步骤1：启用慢查询日志
SET GLOBAL slow_query_log = 'ON';

-- 步骤2：设置慢查询时间阈值（2秒）
SET GLOBAL long_query_time = 2;

-- 步骤3：设置日志文件位置（可选）
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';

-- 步骤4：启用记录未使用索引的查询
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- 步骤5：验证设置是否生效
SHOW VARIABLES LIKE 'slow%';
SHOW VARIABLES LIKE 'long_query_time';
```

**💡 命令解释**：
- `SET GLOBAL` 是MySQL的全局设置命令
- `slow_query_log = 'ON'` 就是打开慢查询日志开关
- `long_query_time = 2` 意思是超过2秒的查询才记录

### 2.3 配置文件启用详解


**📝 修改MySQL配置文件**

```ini
# 编辑MySQL配置文件（通常是/etc/mysql/my.cnf或/etc/my.cnf）
[mysqld]
# 启用慢查询日志
slow_query_log = 1

# 设置慢查询日志文件路径
slow_query_log_file = /var/log/mysql/slow.log

# 设置慢查询时间阈值（单位：秒）
long_query_time = 2

# 记录没有使用索引的查询
log_queries_not_using_indexes = 1

# 设置未使用索引查询的记录频率限制（每分钟最多记录10条）
log_throttle_queries_not_using_indexes = 10
```

**🔧 配置文件修改步骤**

```bash
# 步骤1：备份原配置文件
sudo cp /etc/mysql/my.cnf /etc/mysql/my.cnf.backup

# 步骤2：编辑配置文件
sudo vi /etc/mysql/my.cnf

# 步骤3：重启MySQL服务
sudo systemctl restart mysql

# 步骤4：检查服务状态
sudo systemctl status mysql
```

---

## 3. 📁 日志文件位置规划


### 3.1 为什么要规划日志位置


**通俗解释**：就像在家里要规划垃圾桶放哪里一样，慢查询日志文件也要合理规划位置。

**规划考虑因素**：
- 🎯 **磁盘空间**：日志文件会越来越大
- 🎯 **访问权限**：MySQL要能读写文件
- 🎯 **备份方便**：便于日志文件的备份和管理
- 🎯 **性能影响**：不要放在高负载的磁盘上

### 3.2 推荐的目录结构


**📂 标准目录规划**

```
Linux系统推荐结构：
/var/log/mysql/          ← 日志主目录
├── slow.log            ← 慢查询日志文件
├── error.log           ← 错误日志
├── general.log         ← 通用查询日志
└── archive/            ← 归档目录
    ├── slow-2024-01.log
    ├── slow-2024-02.log
    └── ...

Windows系统推荐结构：
C:\MySQL\logs\
├── slow.log
├── error.log
└── archive\
```

### 3.3 文件权限设置


**🔐 设置正确的文件权限**

```bash
# 创建日志目录
sudo mkdir -p /var/log/mysql

# 设置目录权限（MySQL用户可读写）
sudo chown mysql:mysql /var/log/mysql
sudo chmod 755 /var/log/mysql

# 创建日志文件
sudo touch /var/log/mysql/slow.log

# 设置文件权限
sudo chown mysql:mysql /var/log/mysql/slow.log
sudo chmod 644 /var/log/mysql/slow.log
```

**💡 权限说明**：
- `mysql:mysql` 表示文件属于mysql用户和mysql用户组
- `755` 表示所有者可读写执行，其他人只能读和执行
- `644` 表示所有者可读写，其他人只能读

### 3.4 自定义日志文件命名


**📝 有意义的文件名规划**

```sql
-- 按日期命名日志文件
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-2024-01.log';

-- 按服务器名称命名
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-web01.log';

-- 按业务模块命名
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-ecommerce.log';
```

---

## 4. 💽 磁盘空间规划与监控


### 4.1 慢查询日志会占用多少空间


**通俗解释**：慢查询日志就像记账本，每次慢查询都会记一笔，时间长了账本就厚了。

**📊 空间占用评估**

```
日志增长因素：
✅ 查询频率：每天执行多少次慢查询
✅ 查询复杂度：复杂查询记录的信息更多
✅ 数据库活跃度：越活跃的数据库日志越多

经验估算：
🔸 中小型网站：每天 10-100MB
🔸 中型电商网站：每天 100MB-1GB  
🔸 大型互联网应用：每天 1GB-10GB+
```

### 4.2 磁盘空间检查与规划


**🔍 空间检查命令**

```bash
# 检查当前磁盘使用情况
df -h

# 检查MySQL数据目录空间
du -sh /var/lib/mysql/

# 检查日志目录空间
du -sh /var/log/mysql/

# 实时监控磁盘使用
watch -n 5 'df -h | grep mysql'
```

**📈 空间规划建议**

```
空间规划原则：
🎯 预留空间：至少预留30天的日志空间
🎯 告警阈值：磁盘使用率达到80%时告警
🎯 清理策略：定期清理或归档旧日志
🎯 备用方案：准备日志轮转机制
```

### 4.3 日志轮转配置


**🔄 自动日志轮转设置**

```bash
# 创建logrotate配置文件
sudo vi /etc/logrotate.d/mysql-slow

# 配置内容
/var/log/mysql/slow.log {
    daily                    # 每天轮转
    rotate 30               # 保留30天的日志
    compress                # 压缩旧日志
    delaycompress          # 延迟压缩
    missingok              # 文件不存在不报错
    create 644 mysql mysql  # 创建新文件的权限
    postrotate
        # 轮转后重新加载MySQL日志
        /usr/bin/mysqladmin flush-logs
    endscript
}
```

### 4.4 监控脚本部署


**📊 磁盘空间监控脚本**

```bash
#!/bin/bash
# 文件名：monitor_mysql_logs.sh

# 设置阈值（磁盘使用率超过80%告警）
THRESHOLD=80

# 检查日志目录磁盘使用率
USAGE=$(df /var/log/mysql | tail -1 | awk '{print $5}' | sed 's/%//')

if [ $USAGE -gt $THRESHOLD ]; then
    echo "警告：MySQL日志磁盘使用率已达到 ${USAGE}%"
    echo "请及时清理或归档旧日志文件"
    
    # 发送邮件告警（需要配置邮件服务）
    # echo "磁盘空间不足" | mail -s "MySQL日志告警" admin@company.com
fi

# 显示当前日志文件大小
echo "当前慢查询日志文件大小："
ls -lh /var/log/mysql/slow.log
```

---

## 5. 🚀 生产环境部署实战


### 5.1 生产环境部署注意事项


**⚠️ 生产环境特别注意**

> 💡 **重要提示**：生产环境操作要格外谨慎，任何配置变更都可能影响业务运行。

**🔸 部署前必做检查**：
- ✅ **业务低峰期**：选择用户访问量最少的时候操作
- ✅ **备份数据**：先备份数据库和配置文件
- ✅ **回滚方案**：准备好快速回滚的方案
- ✅ **团队通知**：通知相关技术人员待命

### 5.2 生产环境部署步骤


**📋 完整部署流程**

```bash
# === 步骤1：部署前准备 ===

# 1.1 备份当前配置
sudo cp /etc/mysql/my.cnf /etc/mysql/my.cnf.backup.$(date +%Y%m%d)

# 1.2 备份当前MySQL状态
mysql -e "SHOW VARIABLES LIKE 'slow%'" > mysql_config_backup.txt

# 1.3 检查MySQL服务状态
sudo systemctl status mysql

# === 步骤2：创建日志环境 ===

# 2.1 创建日志目录
sudo mkdir -p /var/log/mysql/archive

# 2.2 设置权限
sudo chown -R mysql:mysql /var/log/mysql
sudo chmod 755 /var/log/mysql

# === 步骤3：配置慢查询日志 ===

# 3.1 使用动态方式先测试（不需要重启）
mysql -e "
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 3;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
SET GLOBAL log_queries_not_using_indexes = 'ON';
"

# 3.2 验证配置生效
mysql -e "SHOW VARIABLES LIKE 'slow%';"
```

### 5.3 配置文件永久化


**📝 写入配置文件确保重启后有效**

```bash
# 编辑MySQL配置文件
sudo vi /etc/mysql/my.cnf

# 在[mysqld]部分添加以下配置
```

```ini
[mysqld]
# === 慢查询日志配置 ===
# 启用慢查询日志
slow_query_log = 1

# 慢查询日志文件路径
slow_query_log_file = /var/log/mysql/slow.log

# 慢查询时间阈值（生产环境建议3-5秒）
long_query_time = 3

# 记录未使用索引的查询
log_queries_not_using_indexes = 1

# 限制未使用索引查询的记录频率（避免日志过多）
log_throttle_queries_not_using_indexes = 10
```

### 5.4 MySQL服务重启操作


**🔄 安全重启MySQL服务**

```bash
# 重启前检查
echo "准备重启MySQL服务..."

# 1. 检查当前连接数
mysql -e "SHOW PROCESSLIST;" | wc -l

# 2. 重启MySQL服务
sudo systemctl restart mysql

# 3. 检查重启后状态
sudo systemctl status mysql

# 4. 测试数据库连接
mysql -e "SELECT 1;"

echo "MySQL服务重启完成"
```

---

## 6. ✅ 部署后功能验证


### 6.1 启用状态验证


**🔍 验证慢查询日志是否正常启用**

```sql
-- 查看慢查询日志启用状态
SHOW VARIABLES LIKE 'slow_query_log';

-- 查看日志文件路径
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 查看时间阈值设置
SHOW VARIABLES LIKE 'long_query_time';

-- 查看完整配置
SHOW VARIABLES LIKE 'slow%';
SHOW VARIABLES LIKE '%log%' AND Variable_name LIKE '%slow%';
```

**📊 预期结果对照**

| 配置项 | 预期值 | 说明 |
|-------|--------|------|
| slow_query_log | ON | 慢查询日志已启用 |
| slow_query_log_file | /var/log/mysql/slow.log | 日志文件路径正确 |
| long_query_time | 3.000000 | 阈值设置为3秒 |

### 6.2 测试慢查询生成


**🧪 人工生成慢查询进行测试**

```sql
-- 测试1：使用SLEEP函数模拟慢查询
SELECT SLEEP(5) AS test_slow_query;

-- 测试2：查询大量数据（如果有大表）
SELECT COUNT(*) FROM information_schema.columns;

-- 测试3：没有使用索引的查询（如果开启了log_queries_not_using_indexes）
SELECT * FROM mysql.user WHERE host LIKE '%localhost%';
```

**💡 测试说明**：
- `SLEEP(5)` 会让查询休眠5秒，肯定超过3秒阈值
- 查询系统表通常比较慢
- 这些测试查询应该被记录到慢查询日志中

### 6.3 检查日志文件生成


**📁 验证日志文件是否正常生成**

```bash
# 检查日志文件是否存在
ls -la /var/log/mysql/slow.log

# 查看日志文件内容
tail -f /var/log/mysql/slow.log

# 检查日志文件大小变化
watch -n 2 'ls -lh /var/log/mysql/slow.log'

# 统计日志中的查询数量
grep -c "^# Time:" /var/log/mysql/slow.log
```

### 6.4 验证日志内容格式


**📝 检查日志内容是否正常**

```bash
# 查看最近的慢查询记录
tail -20 /var/log/mysql/slow.log
```

**预期的日志格式示例**：
```
# Time: 2024-01-21T10:30:45.123456Z
# User@Host: root[root] @ localhost []
# Query_time: 5.001234  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 1
use test;
SET timestamp=1705834245;
SELECT SLEEP(5) AS test_slow_query;
```

---

## 7. 🔧 常见部署问题排查


### 7.1 权限问题排查


**❌ 问题：权限不足导致日志无法写入**

```
错误现象：
- 配置显示正确，但日志文件不生成
- MySQL错误日志中有权限错误信息
```

**🔍 排查步骤**：

```bash
# 1. 检查日志文件权限
ls -la /var/log/mysql/slow.log

# 2. 检查目录权限
ls -ld /var/log/mysql/

# 3. 检查MySQL进程用户
ps aux | grep mysql

# 4. 修复权限问题
sudo chown mysql:mysql /var/log/mysql/slow.log
sudo chmod 644 /var/log/mysql/slow.log
```

### 7.2 路径问题排查


**❌ 问题：日志文件路径错误**

```
错误现象：
- 设置了日志路径，但文件出现在其他位置
- 或者根本找不到日志文件
```

**🔍 排查方法**：

```sql
-- 查看实际的日志文件路径
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 查看MySQL数据目录
SHOW VARIABLES LIKE 'datadir';
```

```bash
# 搜索系统中的慢查询日志文件
find /var -name "*slow*" -type f 2>/dev/null
find /var/lib/mysql -name "*slow*" -type f 2>/dev/null
```

### 7.3 配置不生效问题


**❌ 问题：配置看起来正确但不生效**

**🔍 可能原因和解决方法**：

```sql
-- 1. 检查是否真的启用了
SHOW VARIABLES LIKE 'slow_query_log';

-- 2. 检查时间阈值是否过大
SHOW VARIABLES LIKE 'long_query_time';

-- 3. 强制刷新日志
FLUSH LOGS;

-- 4. 重新设置配置
SET GLOBAL slow_query_log = 'OFF';
SET GLOBAL slow_query_log = 'ON';
```

### 7.4 日志文件过大问题


**❌ 问题：日志文件增长太快，占用大量磁盘空间**

**🔧 解决方案**：

```bash
# 1. 临时清空日志文件（不删除文件）
sudo truncate -s 0 /var/log/mysql/slow.log

# 2. 调整日志阈值（减少记录）
mysql -e "SET GLOBAL long_query_time = 10;"

# 3. 关闭未使用索引查询记录
mysql -e "SET GLOBAL log_queries_not_using_indexes = 'OFF';"

# 4. 设置日志轮转
sudo vi /etc/logrotate.d/mysql-slow
```

### 7.5 部署回滚方案


**🔄 快速回滚到部署前状态**

```bash
# 1. 关闭慢查询日志
mysql -e "SET GLOBAL slow_query_log = 'OFF';"

# 2. 恢复原配置文件
sudo cp /etc/mysql/my.cnf.backup /etc/mysql/my.cnf

# 3. 重启MySQL服务
sudo systemctl restart mysql

# 4. 验证回滚结果
mysql -e "SHOW VARIABLES LIKE 'slow%';"
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 动态启用：SET GLOBAL命令，立即生效但重启失效
🔸 永久启用：修改my.cnf配置文件，重启后依然有效  
🔸 文件权限：mysql用户必须有日志文件的读写权限
🔸 磁盘规划：慢查询日志会持续增长，需要监控磁盘空间
🔸 生产部署：必须在业务低峰期操作，准备回滚方案
```

### 8.2 关键操作命令速查


**⚡ 常用启用命令**：
```sql
-- 快速启用慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 3;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';

-- 查看当前配置
SHOW VARIABLES LIKE 'slow%';
```

**🔧 常用系统命令**：
```bash
# 检查日志文件
tail -f /var/log/mysql/slow.log

# 设置文件权限  
sudo chown mysql:mysql /var/log/mysql/slow.log

# 检查磁盘空间
df -h /var/log/mysql/
```

### 8.3 部署最佳实践


**🎯 生产环境部署建议**：
- **时间选择**：选择业务低峰期（凌晨2-6点）
- **配置保守**：长查询时间设置保守一些（3-5秒）
- **监控到位**：部署后密切监控日志文件大小
- **备份先行**：操作前必须备份配置和数据
- **测试验证**：部署后必须验证功能正常

**💡 常见错误避免**：
- ❌ 不要在高峰期重启MySQL服务
- ❌ 不要设置过小的长查询时间（避免日志过多）
- ❌ 不要忘记设置文件权限
- ❌ 不要忽略磁盘空间监控

**核心记忆**：
- 慢查询日志启用简单，但生产环境要谨慎
- 权限和路径设置是成功的关键
- 磁盘空间规划不可忽视
- 部署后验证比部署本身更重要