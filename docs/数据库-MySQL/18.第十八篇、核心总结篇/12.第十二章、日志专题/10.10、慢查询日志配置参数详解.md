---
title: 10、慢查询日志配置参数详解
---
## 📚 目录

1. [慢查询日志配置概述](#1-慢查询日志配置概述)
2. [核心配置参数详解](#2-核心配置参数详解)
3. [高级配置参数说明](#3-高级配置参数说明)
4. [配置方法与实践](#4-配置方法与实践)
5. [参数优先级与生效机制](#5-参数优先级与生效机制)
6. [配置验证与测试](#6-配置验证与测试)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 慢查询日志配置概述


### 1.1 什么是慢查询日志配置


**💡 通俗理解**
慢查询日志配置就像给MySQL装了一个"监控摄像头"，专门盯着那些执行时间超过预设时间的SQL语句。就好比你在厨房做饭，设定一个定时器，超过这个时间还没做好的菜就被记录下来，方便后续分析为什么这么慢。

**🔸 核心作用**
```
监控目标：执行时间较长的SQL语句
记录内容：SQL语句、执行时间、扫描行数等
分析用途：性能优化、问题排查、系统调优
```

### 1.2 配置参数分类


**📋 参数类型划分**
```
基础开关类：
├── slow_query_log          # 是否启用慢查询日志
└── slow_query_log_file     # 日志文件存储位置

阈值控制类：
├── long_query_time         # 慢查询时间阈值
└── min_examined_row_limit  # 扫描行数限制

特殊情况类：
├── log_queries_not_using_indexes     # 记录未使用索引的查询
├── log_slow_admin_statements         # 记录管理语句
├── log_slow_slave_statements         # 记录从库复制语句
└── log_throttle_queries_not_using_indexes  # 限流控制
```

### 1.3 配置的重要性


**⚡ 为什么要配置慢查询日志**
```
性能诊断：
• 快速定位性能瓶颈SQL
• 了解系统负载分布情况
• 为优化提供数据支撑

问题排查：
• 应用响应慢的原因分析
• 数据库锁等待问题追踪
• 异常SQL语句识别

容量规划：
• 评估硬件资源需求
• 预测系统增长趋势
• 制定扩容策略
```

---

## 2. ⚙️ 核心配置参数详解


### 2.1 slow_query_log - 日志开关


**🔸 参数含义**
这是慢查询日志的总开关，就像家里的电源总闸一样，不打开这个开关，其他所有配置都不会生效。

**💻 配置语法**
```sql
-- 查看当前状态
SHOW VARIABLES LIKE 'slow_query_log';

-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';

-- 关闭慢查询日志  
SET GLOBAL slow_query_log = 'OFF';
```

**📊 参数详情**
| 属性 | 说明 |
|------|------|
| **默认值** | `OFF` (关闭状态) |
| **可选值** | `ON` / `OFF` 或 `1` / `0` |
| **作用域** | 全局变量 |
| **动态修改** | ✅ 支持运行时修改 |

### 2.2 long_query_time - 时间阈值


**🔸 参数含义**
这个参数定义了"慢"的标准，就像设定一个计时器，超过这个时间的SQL就被认为是"慢查询"。

**💡 通俗解释**
假设你设置 `long_query_time = 2`，那么执行时间超过2秒的SQL语句就会被记录到慢查询日志中。这就像约定"超过2秒才做好的菜就算慢"。

**💻 配置示例**
```sql
-- 查看当前阈值
SHOW VARIABLES LIKE 'long_query_time';

-- 设置为2秒
SET GLOBAL long_query_time = 2;

-- 设置为0.5秒（更严格）
SET GLOBAL long_query_time = 0.5;

-- 设置为10秒（更宽松）
SET GLOBAL long_query_time = 10;
```

**📊 时间设置建议**
| 环境类型 | 推荐阈值 | 说明 |
|----------|----------|------|
| **开发环境** | `1-2秒` | 便于及早发现问题 |
| **测试环境** | `2-5秒` | 模拟生产环境 |
| **生产环境** | `1-10秒` | 根据业务要求调整 |
| **OLAP系统** | `30-60秒` | 分析查询可接受较长时间 |

### 2.3 slow_query_log_file - 日志文件路径


**🔸 参数含义**
指定慢查询日志存储的文件位置，就像指定一个专门的文件夹来存放这些"慢查询记录"。

**💻 配置方法**
```sql
-- 查看当前日志文件路径
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 设置自定义路径
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';

-- 使用默认命名（主机名-slow.log）
SET GLOBAL slow_query_log_file = '/var/lib/mysql/mysql-slow.log';
```

**⚠️ 重要注意事项**
```
文件权限：
• MySQL进程必须有写入权限
• 目录必须存在且可访问
• 建议使用mysql用户权限

路径规划：
• 避免与数据文件同一磁盘（性能考虑）
• 确保有足够的磁盘空间
• 便于日志轮转和备份

命名建议：
• 包含实例标识：mysql1-slow.log
• 包含日期信息：slow-20250115.log  
• 便于管理和识别
```

### 2.4 log_queries_not_using_indexes - 索引使用监控


**🔸 参数含义**
这个参数控制是否记录那些没有使用索引的查询，即使它们执行很快。就像给所有"不走正道"的查询都拍照留档。

**💡 为什么重要**
没有使用索引的查询虽然在数据量小时执行很快，但随着数据量增长，可能变成严重的性能问题。提前发现这类查询非常重要。

**💻 配置示例**
```sql
-- 启用未使用索引查询的记录
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- 关闭此功能
SET GLOBAL log_queries_not_using_indexes = 'OFF';

-- 查看当前状态
SHOW VARIABLES LIKE 'log_queries_not_using_indexes';
```

**📈 使用场景对比**
```
开启的好处：
✅ 及早发现潜在性能问题
✅ 数据量小时就能发现问题SQL
✅ 便于制定索引优化策略

可能的问题：
⚠️ 日志量可能很大
⚠️ 某些合理的全表扫描也被记录
⚠️ 需要结合其他参数控制

适用场景：
• 开发和测试环境：建议开启
• 生产环境：根据情况决定
• 性能调优期间：强烈建议开启
```

---

## 3. 🔧 高级配置参数说明


### 3.1 min_examined_row_limit - 扫描行数限制


**🔸 参数含义**
只有扫描行数超过这个限制的查询才会被记录，避免记录那些虽然时间长但实际工作量不大的查询。

**💡 通俗理解**
就像快递员送货，不是看用了多长时间，而是看搬了多少件货物。只有搬运货物超过一定数量的"配送"才被认为是值得关注的。

**💻 配置示例**
```sql
-- 设置最小扫描行数为1000行
SET GLOBAL min_examined_row_limit = 1000;

-- 查看当前设置
SHOW VARIABLES LIKE 'min_examined_row_limit';

-- 实际效果示例
-- 假设设置为1000，那么：
-- 扫描900行，耗时3秒 → 不记录（行数不够）
-- 扫描1500行，耗时3秒 → 记录（满足条件）
```

**📊 设置建议**
| 系统类型 | 推荐值 | 原因 |
|----------|--------|------|
| **OLTP系统** | `100-1000` | 事务系统不应扫描大量数据 |
| **OLAP系统** | `10000-100000` | 分析系统扫描大量数据正常 |
| **混合系统** | `1000-5000` | 平衡考虑 |

### 3.2 log_slow_admin_statements - 管理语句记录


**🔸 参数含义**
控制是否记录管理类语句（如 `ALTER TABLE`、`CREATE INDEX` 等）的执行情况。

**💡 实际意义**
管理语句通常执行时间较长，但这是正常的。是否记录这类语句取决于你的监控需求。

**💻 常见管理语句**
```sql
-- 这些语句在开启后会被记录
ALTER TABLE users ADD INDEX idx_email (email);
CREATE INDEX idx_created_at ON orders (created_at);
OPTIMIZE TABLE large_table;
REPAIR TABLE corrupted_table;
```

**🎯 使用建议**
```
建议开启的情况：
• 需要监控DDL语句性能
• 分析表结构变更影响
• 维护操作性能评估

建议关闭的情况：
• 只关注业务SQL性能
• 减少日志存储压力
• 避免管理语句干扰分析
```

### 3.3 log_throttle_queries_not_using_indexes - 限流控制


**🔸 参数含义**
当开启 `log_queries_not_using_indexes` 时，限制每分钟记录的未使用索引查询数量，防止日志爆炸。

**💡 通俗解释**
就像限速摄像头，不是每个超速的车都拍照，而是每分钟最多拍几张，避免照片太多处理不过来。

**💻 配置示例**
```sql
-- 设置每分钟最多记录10条未使用索引的查询
SET GLOBAL log_throttle_queries_not_using_indexes = 10;

-- 设置为0表示不限制
SET GLOBAL log_throttle_queries_not_using_indexes = 0;
```

**📊 实际效果对比**
```
不限制的情况（值为0）：
时间段    记录条数
10:00    156条未使用索引查询
10:01    203条未使用索引查询
10:02    189条未使用索引查询

限制为10的情况：
时间段    记录条数
10:00    10条未使用索引查询（实际可能有156条）
10:01    10条未使用索引查询（实际可能有203条）
10:02    10条未使用索引查询（实际可能有189条）
```

---

## 4. 💻 配置方法与实践


### 4.1 动态配置 vs 永久配置


**🔸 动态配置（运行时修改）**
```sql
-- 优点：立即生效，无需重启
-- 缺点：重启后失效

-- 基本语法
SET GLOBAL 参数名 = 值;

-- 实际示例
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
```

**🔸 永久配置（配置文件修改）**
```ini
# 在 my.cnf 或 my.ini 文件中添加
[mysqld]
# 启用慢查询日志
slow_query_log = 1

# 设置阈值为2秒
long_query_time = 2

# 指定日志文件位置
slow_query_log_file = /var/log/mysql/slow.log

# 记录未使用索引的查询
log_queries_not_using_indexes = 1

# 设置扫描行数限制
min_examined_row_limit = 1000
```

### 4.2 完整配置示例


**📋 生产环境推荐配置**
```ini
[mysqld]
# === 慢查询日志基础配置 ===
slow_query_log = 1
long_query_time = 2
slow_query_log_file = /var/log/mysql/slow-query.log

# === 高级配置 ===
# 记录未使用索引的查询
log_queries_not_using_indexes = 1

# 限制未使用索引查询记录频率（每分钟10条）
log_throttle_queries_not_using_indexes = 10

# 只记录扫描超过1000行的查询
min_examined_row_limit = 1000

# 不记录管理语句（减少干扰）
log_slow_admin_statements = 0

# 记录从库复制相关的慢查询
log_slow_slave_statements = 1
```

**🎯 开发环境配置示例**
```ini
[mysqld]
# 开发环境更严格的配置
slow_query_log = 1
long_query_time = 1                    # 更短的阈值
slow_query_log_file = /tmp/dev-slow.log

# 记录所有相关查询
log_queries_not_using_indexes = 1
log_slow_admin_statements = 1
min_examined_row_limit = 100           # 更低的行数限制

# 不限制记录频率（开发环境数据量小）
log_throttle_queries_not_using_indexes = 0
```

### 4.3 配置修改的实际操作


**🔧 步骤化操作指南**

**① 查看当前配置状态**
```sql
-- 查看所有慢查询相关配置
SHOW VARIABLES LIKE '%slow%';
SHOW VARIABLES LIKE '%query%';

-- 查看具体参数
SELECT 
    $$global.slow_query_log as '慢查询开关',
    $$global.long_query_time as '时间阈值',
    $$global.slow_query_log_file as '日志文件';
```

**② 动态修改配置**
```sql
-- 启用慢查询日志
SET GLOBAL slow_query_log = 'ON';

-- 设置合适的阈值
SET GLOBAL long_query_time = 2;

-- 验证修改结果
SHOW VARIABLES LIKE 'slow_query_log';
```

**③ 永久配置修改**
```bash
# 1. 编辑配置文件
sudo vim /etc/mysql/my.cnf

# 2. 添加配置内容
[mysqld]
slow_query_log = 1
long_query_time = 2

# 3. 重启MySQL服务
sudo systemctl restart mysql

# 4. 验证配置生效
mysql -e "SHOW VARIABLES LIKE 'slow_query_log';"
```

---

## 5. ⚖️ 参数优先级与生效机制


### 5.1 全局变量与会话变量


**🔸 变量作用域概念**
```
全局变量（GLOBAL）：
• 影响所有新建连接
• 不影响当前已建立的连接
• 需要SUPER权限修改

会话变量（SESSION）：
• 只影响当前连接
• 连接结束后设置失效
• 普通用户可以修改自己的会话变量
```

**💻 实际操作示例**
```sql
-- 设置全局变量（影响新连接）
SET GLOBAL long_query_time = 2;

-- 设置会话变量（只影响当前连接）
SET SESSION long_query_time = 1;

-- 查看不同级别的设置
SELECT $$global.long_query_time, $$session.long_query_time;

-- 结果可能是：
-- $$global.long_query_time: 2
-- $$session.long_query_time: 1
```

### 5.2 配置优先级关系


**📊 优先级层次**
```
优先级（从高到低）：
1. 会话级别设置
2. 全局级别设置  
3. 配置文件设置
4. 编译时默认值

实际生效规则：
• 慢查询日志功能本身由全局设置控制
• 具体阈值可以会话级别覆盖
• 但日志记录始终基于全局开关
```

**💡 实际影响示例**
```sql
-- 场景：全局开启，会话设置不同阈值
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 5;

-- 连接A设置会话阈值
SET SESSION long_query_time = 1;

-- 连接B使用全局阈值
-- （未设置会话变量）

-- 结果：
-- 连接A：超过1秒的查询被记录
-- 连接B：超过5秒的查询被记录
-- 但都记录到同一个日志文件
```

### 5.3 参数修改的生效机制


**🔄 生效时机说明**
```
立即生效的参数：
• slow_query_log（开关）
• long_query_time（阈值）
• log_queries_not_using_indexes
• min_examined_row_limit

需要重启的参数：
• slow_query_log_file（某些版本）
• 部分高级参数

延迟生效的情况：
• 已建立连接的会话变量
• 某些缓存机制的影响
```

**🧪 验证生效的方法**
```sql
-- 1. 修改参数
SET GLOBAL long_query_time = 1;

-- 2. 验证参数值
SHOW VARIABLES LIKE 'long_query_time';

-- 3. 执行测试查询
SELECT SLEEP(2); -- 强制等待2秒

-- 4. 检查日志文件
-- 查看是否有新记录生成
```

---

## 6. ✅ 配置验证与测试


### 6.1 配置正确性验证


**🔍 基础验证方法**
```sql
-- 验证慢查询日志是否启用
SHOW VARIABLES LIKE 'slow_query_log';
-- 期望结果：ON

-- 验证时间阈值设置
SHOW VARIABLES LIKE 'long_query_time';
-- 期望结果：你设置的数值

-- 验证日志文件路径
SHOW VARIABLES LIKE 'slow_query_log_file';
-- 期望结果：有效的文件路径

-- 验证文件是否可写
SELECT $$global.slow_query_log_file as log_file;
-- 然后检查该文件的权限
```

**📁 文件系统验证**
```bash
# 检查日志文件是否存在
ls -la /var/log/mysql/slow-query.log

# 检查文件权限（应该是mysql用户可写）
# 期望输出类似：-rw-r----- 1 mysql mysql

# 检查目录权限
ls -ld /var/log/mysql/
# 确保mysql用户有写入权限

# 检查磁盘空间
df -h /var/log/mysql/
```

### 6.2 功能测试方法


**🧪 基础功能测试**
```sql
-- 测试1：确认慢查询记录功能
-- 执行一个故意的慢查询
SELECT SLEEP(3), 'slow query test';

-- 测试2：检查日志是否生成记录
-- 在系统命令行执行：
-- tail -f /var/log/mysql/slow-query.log
```

**🎯 未使用索引测试**
```sql
-- 创建测试表
CREATE TABLE test_table (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    email VARCHAR(100)
);

-- 插入测试数据
INSERT INTO test_table VALUES 
(1, 'Alice', 'alice@example.com'),
(2, 'Bob', 'bob@example.com');

-- 执行不使用索引的查询
SELECT * FROM test_table WHERE name = 'Alice';
-- 这个查询会全表扫描，应该被记录（如果启用了相应配置）

-- 清理测试
DROP TABLE test_table;
```

### 6.3 性能影响测试


**📊 日志记录对性能的影响**
```sql
-- 测试方法：对比开启前后的性能

-- 1. 关闭慢查询日志
SET GLOBAL slow_query_log = 'OFF';

-- 2. 执行基准测试
-- （使用实际业务查询或基准测试工具）

-- 3. 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';

-- 4. 重复相同测试

-- 5. 对比结果
-- 正常情况下性能影响应该很小（< 5%）
```

**⚠️ 常见问题排查**
```
问题1：日志文件没有生成
可能原因：
• 路径不存在或权限不足
• MySQL进程无法写入文件
• 参数设置错误

解决方法：
• 检查目录权限：chmod 755 /var/log/mysql/
• 检查文件所有者：chown mysql:mysql /var/log/mysql/
• 使用默认路径测试

问题2：没有记录到慢查询
可能原因：
• 查询时间未超过阈值
• 会话变量覆盖了全局设置
• 扫描行数未达到限制

解决方法：
• 降低long_query_time阈值
• 检查会话变量设置
• 使用SLEEP()函数强制测试
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心配置


**🎯 最重要的三个参数**
```
slow_query_log：
• 作用：慢查询日志总开关
• 设置：ON/OFF
• 重要性：★★★★★

long_query_time：
• 作用：定义"慢"的标准
• 设置：根据业务需求调整（通常1-10秒）
• 重要性：★★★★★

slow_query_log_file：
• 作用：指定日志存储位置
• 设置：有效的文件路径
• 重要性：★★★★☆
```

### 7.2 配置最佳实践


**✅ 推荐做法**
```
生产环境：
• 启用慢查询日志
• 设置合理的时间阈值（2-5秒）
• 谨慎使用log_queries_not_using_indexes
• 设置适当的限流参数

开发环境：
• 使用更严格的阈值（1秒）
• 启用所有监控选项
• 便于及早发现问题

监控维护：
• 定期分析日志内容
• 及时清理旧日志文件
• 监控日志文件大小
```

### 7.3 关键理解要点


**💡 核心概念理解**
```
配置的本质：
• 定义什么是"慢查询"
• 控制记录哪些信息
• 平衡监控需求与系统开销

参数间的关系：
• 主开关控制整体功能
• 阈值参数定义记录标准
• 高级参数提供精细控制

生效机制：
• 全局设置影响所有新连接
• 会话设置影响当前连接
• 配置文件确保重启后保持
```

### 7.4 实际应用指导


**🔧 配置选择指南**
```
根据系统类型选择：
OLTP系统（在线事务）：
• 阈值：1-3秒
• 重点：业务SQL性能
• 配置：保守设置，避免日志过多

OLAP系统（在线分析）：
• 阈值：10-30秒
• 重点：复杂查询优化
• 配置：可以记录更多信息

混合系统：
• 阈值：2-5秒
• 重点：平衡监控需求
• 配置：根据主要业务调整
```

**⚡ 常见误区避免**
```
误区1：阈值设置过低
• 问题：产生大量无用日志
• 解决：根据业务实际需求设置

误区2：开启所有监控选项
• 问题：日志量爆炸，影响性能
• 解决：有选择性地开启功能

误区3：只看配置，不看效果
• 问题：配置了但不分析利用
• 解决：建立定期分析机制
```

**核心记忆要点**：
- 慢查询配置是性能优化的第一步，核心是定义"慢"的标准
- 三个必备参数：开关、阈值、文件路径，其他都是辅助功能
- 配置要根据系统类型和业务需求调整，不是越严格越好
- 重点是用好配置产生的日志数据，而不仅仅是配置本身