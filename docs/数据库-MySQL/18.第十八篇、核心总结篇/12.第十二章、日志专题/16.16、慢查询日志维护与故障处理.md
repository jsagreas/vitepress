---
title: 16、慢查询日志维护与故障处理
---
## 📚 目录

1. [日志文件大小管理](#1-日志文件大小管理)
2. [日志轮转配置详解](#2-日志轮转配置详解)
3. [磁盘空间问题处理](#3-磁盘空间问题处理)
4. [日志文件损坏恢复](#4-日志文件损坏恢复)
5. [权限问题诊断与修复](#5-权限问题诊断与修复)
6. [性能影响评估与控制](#6-性能影响评估与控制)
7. [故障诊断与应急处理](#7-故障诊断与应急处理)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📊 日志文件大小管理


### 1.1 慢查询日志增长规律


**📈 日志增长的影响因素**
```
影响日志大小的核心因素：
• 查询频率：每秒执行的SQL数量
• 慢查询比例：超过阈值的查询占比
• SQL复杂度：查询语句的长度和复杂程度
• 参数记录：是否记录查询参数
```

**🔍 增长速度估算**
```
典型场景下的日志增长：
小型网站：每天 10-50MB
中型电商：每天 200-500MB  
大型平台：每天 2-10GB
高并发系统：每天 20GB+

计算公式：
日志大小 ≈ 慢查询数量 × 平均SQL长度 × 1.2（元数据开销）
```

### 1.2 文件大小监控


**📋 监控脚本示例**
```bash
#!/bin/bash
# MySQL慢查询日志大小监控脚本

SLOW_LOG_PATH="/var/log/mysql/mysql-slow.log"
MAX_SIZE_MB=1000  # 1GB限制
ALERT_SIZE_MB=800 # 800MB告警

# 获取当前文件大小(MB)
current_size=$(du -m "$SLOW_LOG_PATH" | cut -f1)

echo "当前慢查询日志大小: ${current_size}MB"

if [ $current_size -gt $MAX_SIZE_MB ]; then
    echo "🔴 紧急：日志文件超过${MAX_SIZE_MB}MB，需要立即处理！"
    # 发送告警邮件或短信
elif [ $current_size -gt $ALERT_SIZE_MB ]; then
    echo "🟡 警告：日志文件接近限制大小，建议尽快处理"
fi
```

**💡 实时监控配置**
```sql
-- 查看慢查询日志当前状态
SHOW VARIABLES LIKE 'slow_query_log%';

-- 查看日志文件路径和大小
SHOW VARIABLES LIKE 'slow_query_log_file';

-- 动态查看慢查询统计
SHOW GLOBAL STATUS LIKE 'Slow_queries';
```

### 1.3 大小限制策略


**⚙️ 预防性控制措施**
```sql
-- 调整慢查询阈值，减少记录数量
SET GLOBAL long_query_time = 2.0;  -- 从1秒调整到2秒

-- 关闭不必要的详细记录
SET GLOBAL log_queries_not_using_indexes = OFF;

-- 限制记录频率（MySQL 8.0+）
SET GLOBAL log_throttle_queries_not_using_indexes = 10;
```

---

## 2. 🔄 日志轮转配置详解


### 2.1 什么是日志轮转


**🔸 日志轮转的概念**
```
日志轮转就像换新本子写日记：
• 当前日志文件写满了，就关闭它
• 创建一个新的日志文件继续写
• 旧的文件按日期重命名保存
• 超过保留期的旧文件自动删除

目的：防止单个文件过大，便于管理和备份
```

### 2.2 logrotate工具配置


**📝 基础logrotate配置**
```bash
# /etc/logrotate.d/mysql-slow
/var/log/mysql/mysql-slow.log {
    daily          # 每天轮转一次
    missingok      # 文件不存在不报错
    rotate 30      # 保留30个历史文件
    compress       # 压缩旧文件节省空间
    delaycompress  # 延迟一天压缩，避免影响正在使用的文件
    notifempty     # 文件为空时不轮转
    create 640 mysql mysql  # 创建新文件的权限和所有者
    
    postrotate
        # 轮转后通知MySQL重新打开日志文件
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin ping &>/dev/null; then
           /usr/bin/mysqladmin flush-logs
        fi
    endscript
}
```

**🔧 高级配置选项**
```bash
# 按大小轮转的配置
/var/log/mysql/mysql-slow.log {
    size 500M      # 文件超过500MB就轮转
    weekly         # 每周检查一次
    rotate 12      # 保留12个文件（约3个月）
    compress
    delaycompress
    
    # 自定义轮转后处理
    postrotate
        # 发送通知邮件
        echo "MySQL慢查询日志已轮转" | mail -s "日志轮转通知" admin@company.com
        
        # 重启日志记录
        systemctl reload mysql
    endscript
}
```

### 2.3 手动轮转操作


**⚡ 紧急手动轮转**
```bash
# 方法1：使用logrotate强制轮转
sudo logrotate -f /etc/logrotate.d/mysql-slow

# 方法2：MySQL内部轮转
mysql -u root -p -e "FLUSH LOGS;"

# 方法3：手动移动文件
sudo mv /var/log/mysql/mysql-slow.log /var/log/mysql/mysql-slow.log.$(date +%Y%m%d)
sudo systemctl restart mysql
```

**📋 轮转验证检查**
```bash
# 检查轮转是否成功
ls -la /var/log/mysql/mysql-slow*

# 验证新日志文件正在写入
tail -f /var/log/mysql/mysql-slow.log

# 检查logrotate状态
sudo logrotate -d /etc/logrotate.d/mysql-slow  # 调试模式
```

---

## 3. 💾 磁盘空间问题处理


### 3.1 磁盘空间不足的紧急处理


**🚨 紧急处理步骤**
```bash
# 第1步：立即检查磁盘使用情况
df -h /var/log/mysql/

# 第2步：临时关闭慢查询日志
mysql -u root -p -e "SET GLOBAL slow_query_log = OFF;"

# 第3步：压缩或移动大日志文件
gzip /var/log/mysql/mysql-slow.log.old
mv /var/log/mysql/mysql-slow.log.* /tmp/backup/

# 第4步：清理当前日志文件
> /var/log/mysql/mysql-slow.log

# 第5步：重新启用日志记录
mysql -u root -p -e "SET GLOBAL slow_query_log = ON;"
```

### 3.2 预防性空间管理


**📊 空间监控脚本**
```bash
#!/bin/bash
# 磁盘空间预警脚本

LOG_DIR="/var/log/mysql"
WARN_THRESHOLD=80    # 80%使用率告警
CRITICAL_THRESHOLD=90 # 90%使用率严重告警

# 获取磁盘使用率
usage=$(df "$LOG_DIR" | tail -1 | awk '{print $5}' | sed 's/%//')

echo "当前磁盘使用率: ${usage}%"

if [ $usage -gt $CRITICAL_THRESHOLD ]; then
    echo "🔴 严重告警：磁盘使用率超过${CRITICAL_THRESHOLD}%"
    # 自动执行清理操作
    find "$LOG_DIR" -name "*.log.*" -mtime +7 -delete
    echo "已自动清理7天前的日志文件"
    
elif [ $usage -gt $WARN_THRESHOLD ]; then
    echo "🟡 预警：磁盘使用率超过${WARN_THRESHOLD}%"
    echo "建议及时清理日志文件"
fi
```

### 3.3 智能清理策略


**🧹 自动清理配置**
```bash
# 创建清理脚本 /usr/local/bin/mysql-log-cleanup.sh
#!/bin/bash

LOG_DIR="/var/log/mysql"
KEEP_DAYS=30  # 保留30天

# 删除超过保留期的压缩日志
find "$LOG_DIR" -name "mysql-slow.log.*.gz" -mtime +$KEEP_DAYS -delete

# 压缩7天前的未压缩日志
find "$LOG_DIR" -name "mysql-slow.log.*" ! -name "*.gz" -mtime +7 -exec gzip {} \;

# 记录清理日志
echo "$(date): 清理完成，删除了$(find "$LOG_DIR" -name "mysql-slow.log.*.gz" -mtime +$KEEP_DAYS | wc -l)个过期文件"
```

**⏰ 定时任务配置**
```bash
# 添加到crontab中，每天凌晨2点执行清理
0 2 * * * /usr/local/bin/mysql-log-cleanup.sh >> /var/log/mysql-cleanup.log 2>&1
```

---

## 4. 🔧 日志文件损坏恢复


### 4.1 日志损坏的常见原因


**❗ 损坏原因分析**
```
常见损坏原因：
• 磁盘空间满：写入中断导致文件截断
• 异常关机：MySQL进程被强制终止
• 磁盘故障：坏道或I/O错误
• 权限问题：MySQL无法写入文件
• 文件系统错误：文件系统损坏
```

### 4.2 损坏检测方法


**🔍 损坏检测脚本**
```bash
#!/bin/bash
# 慢查询日志完整性检查

SLOW_LOG="/var/log/mysql/mysql-slow.log"

echo "检查慢查询日志文件完整性..."

# 检查文件是否存在且可读
if [ ! -r "$SLOW_LOG" ]; then
    echo "🔴 错误：日志文件不存在或不可读"
    exit 1
fi

# 检查文件末尾是否完整
last_line=$(tail -1 "$SLOW_LOG")
if [[ "$last_line" =~ "SET timestamp=" ]] && [ -z "$(echo "$last_line" | grep ';')" ]; then
    echo "🟡 警告：日志文件可能在写入中被截断"
fi

# 检查是否有异常字符
if grep -q $'\0' "$SLOW_LOG"; then
    echo "🔴 错误：检测到二进制字符，文件可能损坏"
fi

echo "✅ 日志文件检查完成"
```

### 4.3 损坏恢复步骤


**🛠️ 恢复处理流程**
```bash
# 第1步：备份损坏的文件
cp /var/log/mysql/mysql-slow.log /var/log/mysql/mysql-slow.log.corrupted.$(date +%Y%m%d)

# 第2步：尝试修复文件（移除损坏部分）
head -n -10 /var/log/mysql/mysql-slow.log > /tmp/mysql-slow-fixed.log
mv /tmp/mysql-slow-fixed.log /var/log/mysql/mysql-slow.log

# 第3步：修复文件权限
chown mysql:mysql /var/log/mysql/mysql-slow.log
chmod 640 /var/log/mysql/mysql-slow.log

# 第4步：重启慢查询日志记录
mysql -u root -p -e "
SET GLOBAL slow_query_log = OFF;
SET GLOBAL slow_query_log = ON;
"

# 第5步：验证恢复结果
echo "测试查询" | mysql -u root -p test
tail -f /var/log/mysql/mysql-slow.log
```

---

## 5. 🔐 权限问题诊断与修复


### 5.1 权限问题的典型症状


**⚠️ 常见权限错误表现**
```
错误症状：
• MySQL错误日志显示"Permission denied"
• 慢查询日志停止更新
• 新建日志文件失败
• logrotate执行失败

错误日志示例：
[ERROR] Could not open mysql-slow.log for logging (error 13)
[Warning] Can't create/write to file '/var/log/mysql/mysql-slow.log'
```

### 5.2 权限诊断脚本


**🔍 全面权限检查**
```bash
#!/bin/bash
# MySQL慢查询日志权限诊断脚本

SLOW_LOG="/var/log/mysql/mysql-slow.log"
LOG_DIR="/var/log/mysql"

echo "=== MySQL慢查询日志权限诊断 ==="

# 检查MySQL用户是否存在
if ! id mysql > /dev/null 2>&1; then
    echo "🔴 错误：mysql用户不存在"
    exit 1
fi

# 检查日志目录权限
echo "📁 日志目录权限检查："
ls -ld "$LOG_DIR"

dir_owner=$(stat -c "%U" "$LOG_DIR")
dir_group=$(stat -c "%G" "$LOG_DIR")
dir_perms=$(stat -c "%a" "$LOG_DIR")

if [ "$dir_owner" != "mysql" ]; then
    echo "🔴 目录所有者错误：应该是mysql，当前是$dir_owner"
fi

if [ "$dir_perms" -lt 755 ]; then
    echo "🔴 目录权限不足：当前$dir_perms，建议755"
fi

# 检查日志文件权限
if [ -f "$SLOW_LOG" ]; then
    echo "📄 日志文件权限检查："
    ls -l "$SLOW_LOG"
    
    file_owner=$(stat -c "%U" "$SLOW_LOG")
    file_group=$(stat -c "%G" "$SLOW_LOG")
    file_perms=$(stat -c "%a" "$SLOW_LOG")
    
    if [ "$file_owner" != "mysql" ]; then
        echo "🔴 文件所有者错误：应该是mysql，当前是$file_owner"
    fi
    
    if [ "$file_perms" -lt 640 ]; then
        echo "🔴 文件权限不足：当前$file_perms，建议640"
    fi
fi

echo "✅ 权限诊断完成"
```

### 5.3 权限修复操作


**🛠️ 标准权限修复**
```bash
#!/bin/bash
# 权限修复脚本

LOG_DIR="/var/log/mysql"
SLOW_LOG="/var/log/mysql/mysql-slow.log"

echo "开始修复MySQL慢查询日志权限..."

# 修复目录权限
sudo chown mysql:mysql "$LOG_DIR"
sudo chmod 755 "$LOG_DIR"

# 修复日志文件权限
if [ -f "$SLOW_LOG" ]; then
    sudo chown mysql:mysql "$SLOW_LOG"
    sudo chmod 640 "$SLOW_LOG"
fi

# 修复所有相关日志文件权限
sudo chown mysql:mysql "$LOG_DIR"/mysql-slow.log*
sudo chmod 640 "$LOG_DIR"/mysql-slow.log*

# 验证修复结果
echo "修复后的权限状态："
ls -la "$LOG_DIR"/mysql-slow*

# 重启MySQL确保权限生效
echo "重启MySQL服务..."
sudo systemctl restart mysql

echo "✅ 权限修复完成"
```

---

## 6. ⚡ 性能影响评估与控制


### 6.1 慢查询日志对性能的影响


**📊 性能影响分析**
```
日志记录的性能开销：
• I/O开销：每个慢查询都要写磁盘
• CPU开销：日志格式化和写入处理
• 锁竞争：多个连接同时写日志
• 磁盘空间：日志文件占用存储空间

影响程度：
轻度影响：< 5% 性能下降
中度影响：5-15% 性能下降  
重度影响：> 15% 性能下降
```

### 6.2 性能监控指标


**📈 关键监控指标**
```sql
-- 慢查询统计信息
SHOW GLOBAL STATUS LIKE 'Slow_queries';
SHOW GLOBAL STATUS LIKE 'Questions';

-- 计算慢查询比例
SELECT 
    (SELECT VARIABLE_VALUE FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME='Slow_queries') /
    (SELECT VARIABLE_VALUE FROM INFORMATION_SCHEMA.GLOBAL_STATUS WHERE VARIABLE_NAME='Questions') * 100 
    AS slow_query_percentage;

-- I/O统计
SHOW GLOBAL STATUS LIKE 'Innodb_data_writes';
SHOW GLOBAL STATUS LIKE 'Innodb_data_written';
```

**🔍 系统级监控**
```bash
# 监控MySQL进程的I/O
iostat -x 1 | grep mysql

# 监控磁盘写入速度
iotop -o -u mysql

# 监控日志文件增长速度
watch -n 5 'ls -lh /var/log/mysql/mysql-slow.log'
```

### 6.3 性能优化策略


**⚙️ 优化配置参数**
```sql
-- 调整慢查询阈值，减少记录频率
SET GLOBAL long_query_time = 3.0;  -- 从1秒调整到3秒

-- 关闭不使用索引的查询记录
SET GLOBAL log_queries_not_using_indexes = OFF;

-- 限制每分钟记录的不使用索引查询数量
SET GLOBAL log_throttle_queries_not_using_indexes = 10;

-- 关闭管理语句记录
SET GLOBAL log_slow_admin_statements = OFF;
```

**💾 I/O优化措施**
```bash
# 将日志目录移到高速SSD
sudo mkdir /ssd/mysql-logs
sudo chown mysql:mysql /ssd/mysql-logs

# 修改MySQL配置
echo "slow_query_log_file = /ssd/mysql-logs/mysql-slow.log" >> /etc/mysql/mysql.conf.d/mysqld.cnf

# 重启MySQL应用配置
sudo systemctl restart mysql
```

---

## 7. 🚨 故障诊断与应急处理


### 7.1 常见故障场景


**❗ 典型故障分类**
```
🔴 严重故障：
• 日志记录完全停止
• 磁盘空间耗尽
• 文件系统损坏
• MySQL进程异常

🟡 一般故障：
• 日志轮转失败
• 权限配置错误
• 性能影响过大
• 日志格式异常
```

### 7.2 故障诊断流程


**🔍 系统化诊断步骤**
```bash
#!/bin/bash
# MySQL慢查询日志故障诊断脚本

echo "=== MySQL慢查询日志故障诊断 ==="

# 第1步：检查MySQL服务状态
echo "1. 检查MySQL服务状态..."
systemctl status mysql | head -10

# 第2步：检查慢查询日志配置
echo "2. 检查慢查询日志配置..."
mysql -u root -p -e "
SHOW VARIABLES LIKE 'slow_query_log%';
SHOW VARIABLES LIKE 'long_query_time';
SHOW GLOBAL STATUS LIKE 'Slow_queries';
"

# 第3步：检查日志文件状态
echo "3. 检查日志文件状态..."
SLOW_LOG=$(mysql -u root -p -se "SELECT $$slow_query_log_file;")
echo "日志文件路径: $SLOW_LOG"

if [ -f "$SLOW_LOG" ]; then
    echo "文件大小: $(du -h "$SLOW_LOG")"
    echo "最后修改: $(stat -c "%y" "$SLOW_LOG")"
    echo "权限信息: $(ls -l "$SLOW_LOG")"
else
    echo "🔴 错误：日志文件不存在"
fi

# 第4步：检查磁盘空间
echo "4. 检查磁盘空间..."
df -h $(dirname "$SLOW_LOG")

# 第5步：检查错误日志
echo "5. 检查MySQL错误日志..."
tail -20 /var/log/mysql/error.log | grep -i "slow\|log"

echo "=== 诊断完成 ==="
```

### 7.3 应急处理预案


**🚨 紧急关闭步骤**
```sql
-- 紧急情况下立即关闭慢查询日志
SET GLOBAL slow_query_log = OFF;

-- 检查关闭状态
SHOW VARIABLES LIKE 'slow_query_log';
```

**🔄 快速恢复步骤**
```bash
#!/bin/bash
# 慢查询日志快速恢复脚本

SLOW_LOG="/var/log/mysql/mysql-slow.log"

echo "开始快速恢复慢查询日志..."

# 第1步：备份当前状态
if [ -f "$SLOW_LOG" ]; then
    cp "$SLOW_LOG" "${SLOW_LOG}.backup.$(date +%Y%m%d_%H%M%S)"
fi

# 第2步：重新创建日志文件
sudo touch "$SLOW_LOG"
sudo chown mysql:mysql "$SLOW_LOG"
sudo chmod 640 "$SLOW_LOG"

# 第3步：重启日志记录
mysql -u root -p -e "
SET GLOBAL slow_query_log = OFF;
FLUSH LOGS;
SET GLOBAL slow_query_log = ON;
"

# 第4步：验证恢复状态
echo "验证恢复状态..."
mysql -u root -p -e "
SHOW VARIABLES LIKE 'slow_query_log%';
SELECT 'Recovery test query' as test;
"

# 第5步：检查日志是否正常写入
sleep 2
if [ -s "$SLOW_LOG" ]; then
    echo "✅ 慢查询日志恢复成功"
else
    echo "🔴 警告：日志可能未正常恢复，请进一步检查"
fi
```

### 7.4 错误码对照表


| 错误类型 | **错误信息** | **可能原因** | **解决方案** |
|---------|------------|-------------|-------------|
| 🔴 **权限错误** | `Permission denied` | `文件权限不正确` | `chown mysql:mysql 日志文件` |
| 🔴 **空间错误** | `No space left on device` | `磁盘空间不足` | `清理旧日志或扩容磁盘` |
| 🟡 **文件错误** | `File not found` | `日志文件被误删` | `重新创建文件并重启服务` |
| 🟡 **配置错误** | `Invalid log file name` | `路径配置错误` | `检查slow_query_log_file配置` |

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的维护技能


```
🔸 日志大小管理：监控文件大小，防止过度增长
🔸 轮转配置：使用logrotate自动管理日志文件
🔸 空间监控：预防磁盘空间不足导致的服务中断
🔸 权限管理：确保MySQL进程有正确的文件访问权限
🔸 性能控制：平衡日志详细程度与系统性能
🔸 故障处理：快速诊断和恢复日志记录功能
```

### 8.2 关键理解要点


**🔹 预防重于治疗**
```
维护原则：
• 定期监控：不要等问题发生才处理
• 自动化管理：减少人工操作失误
• 备份策略：重要日志要有备份
• 容量规划：提前预估日志增长需求
```

**🔹 性能与监控的平衡**
```
平衡策略：
• 生产环境：适当调高阈值，减少记录
• 开发环境：详细记录，便于问题定位
• 监控环境：定期采样，不必全量记录
• 紧急情况：可临时关闭，优先保证服务
```

### 8.3 实际维护检查清单


**📋 日常维护清单**
```
每日检查：
☐ 查看日志文件大小增长
☐ 检查磁盘空间使用情况
☐ 确认日志轮转是否正常
☐ 监控慢查询数量趋势

每周检查：
☐ 清理过期的历史日志文件
☐ 检查logrotate配置有效性
☐ 评估日志记录对性能影响
☐ 更新监控脚本和阈值

每月检查：
☐ 分析日志增长趋势
☐ 优化日志记录参数
☐ 测试故障恢复流程
☐ 更新维护文档
```

**🚨 应急响应清单**
```
发现问题时：
1️⃣ 立即评估影响范围
2️⃣ 执行故障诊断脚本
3️⃣ 记录问题现象和操作
4️⃣ 实施临时解决方案
5️⃣ 制定根本解决计划
6️⃣ 验证修复效果
7️⃣ 总结经验教训
```

### 8.4 最佳实践建议


- **监控优先**：建立完善的监控体系，问题早发现早处理
- **自动化管理**：使用脚本和工具自动化日常维护工作
- **容量规划**：根据业务增长合理规划存储容量
- **文档记录**：详细记录配置变更和故障处理过程
- **定期演练**：定期测试故障恢复流程，确保应急处理有效

**核心记忆**：
- 慢查询日志维护是系统稳定运行的基础
- 预防性维护比故障后处理更重要
- 自动化工具能大幅提高维护效率
- 性能影响控制是日志管理的关键平衡点