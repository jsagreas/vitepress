---
title: 7ã€ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ä¸å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—åˆ†æå·¥å…·æ¦‚è¿°](#1-æ—¥å¿—åˆ†æå·¥å…·æ¦‚è¿°)
2. [mysqldumpslowå·¥å…·è¯¦è§£](#2-mysqldumpslowå·¥å…·è¯¦è§£)  
3. [pt-query-digesté«˜çº§åˆ†æ](#3-pt-query-digesté«˜çº§åˆ†æ)
4. [æ–‡æœ¬å¤„ç†å·¥å…·å®æˆ˜](#4-æ–‡æœ¬å¤„ç†å·¥å…·å®æˆ˜)
5. [è‡ªå®šä¹‰æ—¥å¿—è§£æè„šæœ¬](#5-è‡ªå®šä¹‰æ—¥å¿—è§£æè„šæœ¬)
6. [ç»Ÿè®¡åˆ†ææ–¹æ³•](#6-ç»Ÿè®¡åˆ†ææ–¹æ³•)
7. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#7-å®æˆ˜æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ—¥å¿—åˆ†æå·¥å…·æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„åˆ†æå·¥å…·


**é—®é¢˜èƒŒæ™¯**ï¼šä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶å¾€å¾€éå¸¸åºå¤§ï¼Œæ‰‹å·¥åˆ†æå‡ ä¹ä¸å¯èƒ½

```
ç°å®æƒ…å†µç¤ºä¾‹ï¼š
ç”Ÿäº§ç¯å¢ƒæ—¥å¿—å¤§å°ï¼šæ¯å¤©å‡ ä¸ªGBåˆ°å‡ åGB
æŸ¥è¯¢æ¡æ•°ï¼šæ¯ç§’å‡ ç™¾åˆ°å‡ åƒæ¡æŸ¥è¯¢
äººå·¥åˆ†æéš¾åº¦ï¼šå¦‚å¤§æµ·æé’ˆï¼Œæ— ä»ä¸‹æ‰‹

å·¥å…·çš„ä»·å€¼ï¼š
âœ… è‡ªåŠ¨ç»Ÿè®¡å’Œåˆ†ç±»
âœ… è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
âœ… å‘ç°å¼‚å¸¸è®¿é—®æ¨¡å¼
âœ… ç”Ÿæˆå¯è¯»æ€§æŠ¥å‘Š
```

### 1.2 å¸¸ç”¨åˆ†æå·¥å…·åˆ†ç±»


```
å®˜æ–¹å·¥å…·ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  mysqldumpslow  â”‚ â† MySQLè‡ªå¸¦çš„æ…¢æŸ¥è¯¢åˆ†æå·¥å…·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰æ–¹ä¸“ä¸šå·¥å…·ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pt-query-digest â”‚ â† Percona Toolkitä¸­çš„å¼ºå¤§åˆ†æå·¥å…·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿå·¥å…·ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  grep/awk/sed   â”‚ â† Linuxæ–‡æœ¬å¤„ç†ä¸‰å‰‘å®¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è‡ªå®šä¹‰è„šæœ¬ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python/Shellè„šæœ¬ â”‚ â† é’ˆå¯¹ç‰¹å®šéœ€æ±‚çš„å®šåˆ¶åŒ–å·¥å…·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å·¥å…·é€‰æ‹©ç­–ç•¥


| åˆ†æéœ€æ±‚ | **æ¨èå·¥å…·** | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** |
|---------|------------|-------------|---------|
| ğŸš€ **å¿«é€Ÿæ¦‚è§ˆ** | `mysqldumpslow` | `ç®€å•ç»Ÿè®¡åˆ†æ` | `ä½¿ç”¨ç®€å•ï¼ŒMySQLè‡ªå¸¦` |
| ğŸ“Š **æ·±åº¦åˆ†æ** | `pt-query-digest` | `è¯¦ç»†æ€§èƒ½åˆ†æ` | `åŠŸèƒ½å¼ºå¤§ï¼ŒæŠ¥å‘Šè¯¦ç»†` |
| ğŸ”§ **å®šåˆ¶éœ€æ±‚** | `è‡ªå®šä¹‰è„šæœ¬` | `ç‰¹æ®Šåˆ†æéœ€æ±‚` | `çµæ´»æ€§æœ€é«˜` |
| ğŸ“ **ä¸´æ—¶æŸ¥çœ‹** | `grep/awk/sed` | `å¿«é€ŸæŸ¥æ‰¾ç‰¹å®šå†…å®¹` | `è½»é‡çº§ï¼Œå“åº”å¿«` |

---

## 2. ğŸ› ï¸ mysqldumpslowå·¥å…·è¯¦è§£


### 2.1 å·¥å…·åŸºæœ¬ä»‹ç»


**ä»€ä¹ˆæ˜¯mysqldumpslow**ï¼š
- MySQLå®˜æ–¹è‡ªå¸¦çš„æ—¥å¿—åˆ†æå·¥å…·
- ä¸»è¦ç”¨äºåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œä½†ä¹Ÿèƒ½å¤„ç†ä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—
- èƒ½å¤Ÿå¯¹ç›¸ä¼¼æŸ¥è¯¢è¿›è¡Œèšåˆç»Ÿè®¡

**å·¥ä½œåŸç†**ï¼š
```
åŸå§‹æ—¥å¿—è®°å½•ï¼š
SELECT * FROM users WHERE id = 1;
SELECT * FROM users WHERE id = 100;
SELECT * FROM users WHERE id = 999;

mysqldumpslowå¤„ç†åï¼š
SELECT * FROM users WHERE id = N;  (æ‰§è¡Œ3æ¬¡)
```

### 2.2 åŸºæœ¬è¯­æ³•å’Œå‚æ•°


**ğŸ“‹ åŸºæœ¬ä½¿ç”¨è¯­æ³•**ï¼š
```bash
mysqldumpslow [é€‰é¡¹] æ—¥å¿—æ–‡ä»¶å
```

**ğŸ”§ å¸¸ç”¨å‚æ•°è¯¦è§£**ï¼š

```bash
# åŸºæœ¬å‚æ•°
-sï¼šæ’åºæ–¹å¼
  c = æŸ¥è¯¢æ¬¡æ•°(count)
  t = æŸ¥è¯¢æ—¶é—´(time) 
  l = é”å®šæ—¶é—´(lock)
  r = è¿”å›è®°å½•æ•°(rows)
  
-tï¼šæ˜¾ç¤ºå‰Næ¡è®°å½•
-gï¼šgrepæ¨¡å¼ï¼Œåªæ˜¾ç¤ºåŒ¹é…çš„æŸ¥è¯¢

# å®ç”¨ç¤ºä¾‹
mysqldumpslow -s c -t 10 /var/log/mysql/general.log
# å«ä¹‰ï¼šæŒ‰æŸ¥è¯¢æ¬¡æ•°æ’åºï¼Œæ˜¾ç¤ºå‰10æ¡
```

### 2.3 å®é™…ä½¿ç”¨ç¤ºä¾‹


**ğŸ¯ åœºæ™¯1ï¼šæŸ¥æ‰¾æ‰§è¡Œæœ€é¢‘ç¹çš„æŸ¥è¯¢**

```bash
mysqldumpslow -s c -t 20 /var/log/mysql/general.log

# è¾“å‡ºç»“æœç¤ºä¾‹ï¼š
Count: 1500  Time=0.01s (15s)  Lock=0.00s (0s)  Rows=1.0 (1500), user[db]@[host]
SELECT * FROM products WHERE category_id = N

Count: 800   Time=0.05s (40s)  Lock=0.00s (0s)  Rows=10.5 (8400), user[db]@[host]  
SELECT * FROM orders WHERE user_id = N AND status = 'S'
```

**è§£è¯»è¯´æ˜**ï¼š
- `Count: 1500`ï¼šè¿™ç±»æŸ¥è¯¢æ‰§è¡Œäº†1500æ¬¡
- `Time=0.01s (15s)`ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´0.01ç§’ï¼Œæ€»è€—æ—¶15ç§’
- `Rows=1.0 (1500)`ï¼šå¹³å‡è¿”å›1è¡Œï¼Œæ€»å…±è¿”å›1500è¡Œ

**ğŸ¯ åœºæ™¯2ï¼šæŸ¥æ‰¾ç‰¹å®šè¡¨çš„æŸ¥è¯¢**

```bash
mysqldumpslow -g "FROM users" /var/log/mysql/general.log

# åªæ˜¾ç¤ºæ¶‰åŠusersè¡¨çš„æŸ¥è¯¢ç»Ÿè®¡
```

**ğŸ¯ åœºæ™¯3ï¼šæŸ¥æ‰¾è€—æ—¶æœ€é•¿çš„æŸ¥è¯¢**

```bash
mysqldumpslow -s t -t 10 /var/log/mysql/general.log

# æŒ‰æ€»è€—æ—¶æ’åºï¼Œæ‰¾å‡ºæœ€è€—æ—¶çš„æŸ¥è¯¢ç±»å‹
```

### 2.4 è¾“å‡ºç»“æœåˆ†ææŠ€å·§


**ğŸ” å…³é”®æŒ‡æ ‡è§£è¯»**ï¼š

```
Count: æ‰§è¡Œæ¬¡æ•°
â”œâ”€ é«˜é¢‘æŸ¥è¯¢ â†’ ä¼˜åŒ–ä»·å€¼å¤§
â”œâ”€ ä½é¢‘æŸ¥è¯¢ â†’ å¯èƒ½æ˜¯æ‰¹å¤„ç†
â””â”€ å¼‚å¸¸é«˜é¢‘ â†’ å¯èƒ½å­˜åœ¨é—®é¢˜

Time: æ‰§è¡Œæ—¶é—´  
â”œâ”€ å¹³å‡æ—¶é—´é«˜ â†’ æŸ¥è¯¢æ•ˆç‡é—®é¢˜
â”œâ”€ æ€»æ—¶é—´é«˜ â†’ å½±å“æ•´ä½“æ€§èƒ½
â””â”€ æ—¶é—´æ³¢åŠ¨å¤§ â†’ å¯èƒ½æœ‰é”ç­‰å¾…

Rows: è¿”å›è¡Œæ•°
â”œâ”€ è¿”å›è¡Œæ•°å¤š â†’ å¯èƒ½ç¼ºå°‘WHEREæ¡ä»¶
â”œâ”€ è¿”å›è¡Œæ•°å°‘ä½†è€—æ—¶é•¿ â†’ ç´¢å¼•é—®é¢˜
â””â”€ è¿”å›è¡Œæ•°ä¸º0 â†’ å¯èƒ½æ˜¯UPDATE/DELETE
```

---

## 3. ğŸ“Š pt-query-digesté«˜çº§åˆ†æ


### 3.1 å·¥å…·ä»‹ç»ä¸å®‰è£…


**ä»€ä¹ˆæ˜¯pt-query-digest**ï¼š
- Percona Toolkitä¸­æœ€å¼ºå¤§çš„æŸ¥è¯¢åˆ†æå·¥å…·
- èƒ½åˆ†æMySQLçš„å„ç§æ—¥å¿—æ–‡ä»¶
- ç”Ÿæˆè¯¦ç»†çš„HTMLå’Œæ–‡æœ¬æŠ¥å‘Š

**ğŸ”§ å®‰è£…æ–¹æ³•**ï¼š

```bash
# CentOS/RHEL
yum install percona-toolkit

# Ubuntu/Debian  
apt-get install percona-toolkit

# éªŒè¯å®‰è£…
pt-query-digest --version
```

### 3.2 åŸºæœ¬ä½¿ç”¨æ–¹æ³•


**ğŸ“‹ åŸºæœ¬è¯­æ³•**ï¼š
```bash
pt-query-digest [é€‰é¡¹] æ—¥å¿—æ–‡ä»¶
```

**ğŸš€ å¿«é€Ÿå¼€å§‹ç¤ºä¾‹**ï¼š

```bash
# åˆ†æä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—
pt-query-digest /var/log/mysql/general.log > analysis_report.txt

# ç”ŸæˆHTMLæŠ¥å‘Š
pt-query-digest --output html /var/log/mysql/general.log > report.html
```

### 3.3 é«˜çº§åˆ†æåŠŸèƒ½


**ğŸ¯ æŒ‰æ—¶é—´æ®µåˆ†æ**ï¼š

```bash
# åˆ†æç‰¹å®šæ—¶é—´æ®µçš„æŸ¥è¯¢
pt-query-digest \
  --since '2024-09-01 09:00:00' \
  --until '2024-09-01 18:00:00' \
  /var/log/mysql/general.log
```

**ğŸ¯ è¿‡æ»¤ç‰¹å®šç”¨æˆ·**ï¼š

```bash
# åªåˆ†æç‰¹å®šç”¨æˆ·çš„æŸ¥è¯¢
pt-query-digest \
  --filter '$event->{user} eq "webapp"' \
  /var/log/mysql/general.log
```

**ğŸ¯ åˆ†æç‰¹å®šæ•°æ®åº“**ï¼š

```bash
# åªåˆ†æç‰¹å®šæ•°æ®åº“çš„æŸ¥è¯¢
pt-query-digest \
  --filter '$event->{db} eq "ecommerce"' \
  /var/log/mysql/general.log
```

### 3.4 æŠ¥å‘Šè§£è¯»


**ğŸ“Š æŠ¥å‘Šç»“æ„è§£æ**ï¼š

```
pt-query-digestæŠ¥å‘ŠåŒ…å«ï¼š

1. æ•´ä½“ç»Ÿè®¡æ¦‚è§ˆ
   â”œâ”€ æ€»æŸ¥è¯¢æ•°é‡
   â”œâ”€ å”¯ä¸€æŸ¥è¯¢æ•°é‡  
   â”œâ”€ æ€»æ‰§è¡Œæ—¶é—´
   â””â”€ å¹³å‡QPS

2. æŸ¥è¯¢è¯¦ç»†æ’è¡Œ
   â”œâ”€ æŒ‰æ‰§è¡Œæ—¶é—´æ’åº
   â”œâ”€ æŒ‰æ‰§è¡Œæ¬¡æ•°æ’åº
   â””â”€ æŒ‰æ£€æŸ¥è¡Œæ•°æ’åº

3. å•ä¸ªæŸ¥è¯¢è¯¦æƒ…
   â”œâ”€ æŸ¥è¯¢æ¨¡æ¿
   â”œâ”€ æ‰§è¡Œç»Ÿè®¡
   â”œâ”€ EXPLAINåˆ†æ
   â””â”€ å®é™…æŸ¥è¯¢ç¤ºä¾‹
```

**ğŸ” å…³é”®æŒ‡æ ‡å«ä¹‰**ï¼š

| æŒ‡æ ‡åç§° | **å«ä¹‰è¯´æ˜** | **åˆ†æé‡ç‚¹** |
|---------|------------|-------------|
| **Query time** | `æŸ¥è¯¢æ‰§è¡Œæ—¶é—´` | `å¹³å‡æ—¶é—´è¿‡é•¿éœ€è¦ä¼˜åŒ–` |
| **Lock time** | `é”ç­‰å¾…æ—¶é—´` | `é«˜é”ç­‰å¾…è¯´æ˜å¹¶å‘é—®é¢˜` |
| **Rows sent** | `è¿”å›è¡Œæ•°` | `è¿”å›è¡Œæ•°è¿‡å¤šå¯èƒ½ç¼ºå°‘é™åˆ¶` |
| **Rows examined** | `æ£€æŸ¥è¡Œæ•°` | `æ£€æŸ¥è¡Œæ•°è¿œå¤§äºè¿”å›è¡Œæ•°è¯´æ˜æ•ˆç‡ä½` |

---

## 4. âš¡ æ–‡æœ¬å¤„ç†å·¥å…·å®æˆ˜


### 4.1 grepå·¥å…·å®ç”¨æŠ€å·§


**ğŸ” åŸºæœ¬æŸ¥æ‰¾æ“ä½œ**ï¼š

```bash
# æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·çš„æŸ¥è¯¢
grep "user@localhost" /var/log/mysql/general.log

# æŸ¥æ‰¾ç‰¹å®šæ—¶é—´æ®µçš„æŸ¥è¯¢
grep "2024-09-01 1[0-5]:" /var/log/mysql/general.log

# æŸ¥æ‰¾SELECTæŸ¥è¯¢
grep "SELECT" /var/log/mysql/general.log

# æŸ¥æ‰¾UPDATE/DELETEæ“ä½œ
grep -E "(UPDATE|DELETE)" /var/log/mysql/general.log
```

**ğŸ¯ é«˜çº§è¿‡æ»¤æŠ€å·§**ï¼š

```bash
# æŸ¥æ‰¾æ¶‰åŠç‰¹å®šè¡¨çš„æŸ¥è¯¢
grep -i "FROM users\|JOIN users\|UPDATE users" /var/log/mysql/general.log

# æ’é™¤ç³»ç»ŸæŸ¥è¯¢
grep -v "information_schema\|performance_schema" /var/log/mysql/general.log

# æŸ¥æ‰¾å¯èƒ½çš„SQLæ³¨å…¥å°è¯•
grep -i "union\|drop\|truncate" /var/log/mysql/general.log
```

### 4.2 awkå·¥å…·ç»Ÿè®¡åˆ†æ


**ğŸ“Š æŸ¥è¯¢ç±»å‹ç»Ÿè®¡**ï¼š

```bash
# ç»Ÿè®¡ä¸åŒæŸ¥è¯¢ç±»å‹çš„æ•°é‡
awk '/Query/ {
    if($0 ~ /SELECT/) select++
    else if($0 ~ /INSERT/) insert++  
    else if($0 ~ /UPDATE/) update++
    else if($0 ~ /DELETE/) delete++
}
END {
    print "SELECT:", select
    print "INSERT:", insert  
    print "UPDATE:", update
    print "DELETE:", delete
}' /var/log/mysql/general.log
```

**ğŸ“ˆ æŒ‰å°æ—¶ç»Ÿè®¡æŸ¥è¯¢é‡**ï¼š

```bash
# ç»Ÿè®¡æ¯å°æ—¶çš„æŸ¥è¯¢æ•°é‡
awk '/Query/ {
    hour = substr($2, 1, 2)
    count[hour]++
}
END {
    for(h in count) {
        print "Hour " h ": " count[h] " queries"
    }
}' /var/log/mysql/general.log | sort
```

### 4.3 sedå·¥å…·æ•°æ®æ¸…æ´—


**ğŸ§¹ æ—¥å¿—æ ¼å¼è§„èŒƒåŒ–**ï¼š

```bash
# ç§»é™¤æ—¶é—´æˆ³ï¼Œåªä¿ç•™æŸ¥è¯¢è¯­å¥
sed 's/^[0-9-]* [0-9:]*[[:space:]]*[0-9]*[[:space:]]*Query[[:space:]]*//g' \
  /var/log/mysql/general.log > clean_queries.txt

# å°†æ‰€æœ‰æŸ¥è¯¢è½¬æ¢ä¸ºå¤§å†™ï¼ˆä¾¿äºç»Ÿä¸€åˆ†æï¼‰
sed 's/.*/\U&/' /var/log/mysql/general.log
```

### 4.4 ç»„åˆä½¿ç”¨å®ä¾‹


**ğŸ”§ å¤åˆåˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ—¥å¿—åˆ†æç»„åˆè„šæœ¬

LOG_FILE="/var/log/mysql/general.log"
REPORT_FILE="daily_report.txt"

echo "=== MySQLæŸ¥è¯¢æ—¥å¿—åˆ†ææŠ¥å‘Š ===" > $REPORT_FILE
echo "åˆ†ææ—¶é—´: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# æ€»æŸ¥è¯¢æ•°ç»Ÿè®¡
echo "æ€»æŸ¥è¯¢æ•°é‡:" >> $REPORT_FILE
grep -c "Query" $LOG_FILE >> $REPORT_FILE
echo "" >> $REPORT_FILE

# æŸ¥è¯¢ç±»å‹åˆ†å¸ƒ
echo "æŸ¥è¯¢ç±»å‹åˆ†å¸ƒ:" >> $REPORT_FILE
grep "Query" $LOG_FILE | \
awk '{if($0~/SELECT/) s++; else if($0~/INSERT/) i++; else if($0~/UPDATE/) u++; else if($0~/DELETE/) d++} 
     END{print "SELECT:"s" INSERT:"i" UPDATE:"u" DELETE:"d}' >> $REPORT_FILE
echo "" >> $REPORT_FILE

# æœ€æ´»è·ƒçš„ç”¨æˆ·
echo "æœ€æ´»è·ƒç”¨æˆ·TOP5:" >> $REPORT_FILE
grep "Query" $LOG_FILE | \
awk '{match($0, /[a-zA-Z0-9_]+\[/); user=substr($0,RSTART,RLENGTH-1); count[user]++} 
     END{for(u in count) print count[u], u}' | \
sort -nr | head -5 >> $REPORT_FILE
```

---

## 5. ğŸ”§ è‡ªå®šä¹‰æ—¥å¿—è§£æè„šæœ¬


### 5.1 Pythonè§£æè„šæœ¬å¼€å‘


**ğŸ“ åŸºç¡€è§£æå™¨æ¡†æ¶**ï¼š

```python
#!/usr/bin/env python3
import re
import sys
from collections import defaultdict, Counter
from datetime import datetime

class GeneralLogAnalyzer:
    def __init__(self, log_file):
        self.log_file = log_file
        self.queries = []
        self.stats = defaultdict(int)
        
    def parse_log(self):
        """è§£ææ—¥å¿—æ–‡ä»¶"""
        with open(self.log_file, 'r', encoding='utf-8', errors='ignore') as f:
            current_query = None
            
            for line in f:
                line = line.strip()
                
                # åŒ¹é…æŸ¥è¯¢è¡Œ
                query_match = re.match(r'(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})\s+(\d+)\s+Query\s+(.+)', line)
                
                if query_match:
                    timestamp, thread_id, query = query_match.groups()
                    
                    self.queries.append({
                        'timestamp': timestamp,
                        'thread_id': thread_id,
                        'query': query.strip(),
                        'query_type': self._get_query_type(query)
                    })
    
    def _get_query_type(self, query):
        """è¯†åˆ«æŸ¥è¯¢ç±»å‹"""
        query_upper = query.upper().strip()
        
        if query_upper.startswith('SELECT'):
            return 'SELECT'
        elif query_upper.startswith('INSERT'):
            return 'INSERT'
        elif query_upper.startswith('UPDATE'):
            return 'UPDATE'
        elif query_upper.startswith('DELETE'):
            return 'DELETE'
        else:
            return 'OTHER'
    
    def generate_stats(self):
        """ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯"""
        total_queries = len(self.queries)
        query_types = Counter(q['query_type'] for q in self.queries)
        
        print(f"æ€»æŸ¥è¯¢æ•°é‡: {total_queries}")
        print("\næŸ¥è¯¢ç±»å‹åˆ†å¸ƒ:")
        for qtype, count in query_types.most_common():
            percentage = (count / total_queries) * 100
            print(f"  {qtype}: {count} ({percentage:.1f}%)")
        
        return {
            'total': total_queries,
            'types': dict(query_types)
        }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("ç”¨æ³•: python3 log_analyzer.py <æ—¥å¿—æ–‡ä»¶è·¯å¾„>")
        sys.exit(1)
    
    analyzer = GeneralLogAnalyzer(sys.argv[1])
    analyzer.parse_log()
    analyzer.generate_stats()
```

### 5.2 é«˜çº§åŠŸèƒ½æ‰©å±•


**ğŸ¯ æŸ¥è¯¢é¢‘ç‡åˆ†æ**ï¼š

```python
def analyze_query_frequency(self):
    """åˆ†ææŸ¥è¯¢é¢‘ç‡æ¨¡å¼"""
    from datetime import datetime, timedelta
    
    # æŒ‰å°æ—¶ç»Ÿè®¡æŸ¥è¯¢é‡
    hourly_stats = defaultdict(int)
    
    for query in self.queries:
        try:
            dt = datetime.strptime(query['timestamp'], '%Y-%m-%d %H:%M:%S')
            hour_key = dt.strftime('%H:00')
            hourly_stats[hour_key] += 1
        except ValueError:
            continue
    
    print("\næ¯å°æ—¶æŸ¥è¯¢åˆ†å¸ƒ:")
    for hour in sorted(hourly_stats.keys()):
        count = hourly_stats[hour]
        bar = 'â–ˆ' * (count // 10)  # ç®€å•çš„æŸ±çŠ¶å›¾
        print(f"  {hour}: {count:5d} {bar}")
```

**ğŸ” æ…¢æŸ¥è¯¢è¯†åˆ«**ï¼š

```python
def identify_potential_slow_queries(self):
    """è¯†åˆ«å¯èƒ½çš„æ…¢æŸ¥è¯¢æ¨¡å¼"""
    suspicious_patterns = [
        r'SELECT \* FROM \w+ WHERE',  # å…¨è¡¨æŸ¥è¯¢
        r'SELECT .* FROM \w+ ORDER BY .* LIMIT \d+',  # å¤§é‡æ’åº
        r'SELECT .* FROM \w+ JOIN \w+ JOIN',  # å¤šè¡¨å…³è”
    ]
    
    suspicious_queries = []
    
    for query in self.queries:
        sql = query['query']
        
        for pattern in suspicious_patterns:
            if re.search(pattern, sql, re.IGNORECASE):
                suspicious_queries.append({
                    'query': sql[:100] + '...' if len(sql) > 100 else sql,
                    'timestamp': query['timestamp'],
                    'pattern': pattern
                })
                break
    
    if suspicious_queries:
        print(f"\nå‘ç° {len(suspicious_queries)} ä¸ªå¯ç–‘æŸ¥è¯¢:")
        for i, sq in enumerate(suspicious_queries[:10]):  # åªæ˜¾ç¤ºå‰10ä¸ª
            print(f"  {i+1}. {sq['timestamp']}: {sq['query']}")
```

### 5.3 Shellè„šæœ¬å¿«é€Ÿåˆ†æ


**âš¡ ä¸€é”®åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# quick_analysis.sh - å¿«é€Ÿæ—¥å¿—åˆ†æè„šæœ¬

LOG_FILE=${1:-/var/log/mysql/general.log}

if [ ! -f "$LOG_FILE" ]; then
    echo "é”™è¯¯: æ—¥å¿—æ–‡ä»¶ $LOG_FILE ä¸å­˜åœ¨"
    exit 1
fi

echo "=== MySQLä¸€èˆ¬æŸ¥è¯¢æ—¥å¿—å¿«é€Ÿåˆ†æ ==="
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
echo "åˆ†ææ—¶é—´: $(date)"
echo

# åŸºæœ¬ç»Ÿè®¡
echo "ğŸ“Š åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯:"
total_queries=$(grep -c "Query" "$LOG_FILE")
echo "  æ€»æŸ¥è¯¢æ•°: $total_queries"

if [ $total_queries -eq 0 ]; then
    echo "  è­¦å‘Š: æœªå‘ç°ä»»ä½•æŸ¥è¯¢è®°å½•"
    exit 0
fi

# æŸ¥è¯¢ç±»å‹åˆ†å¸ƒ
echo
echo "ğŸ“ˆ æŸ¥è¯¢ç±»å‹åˆ†å¸ƒ:"
grep "Query" "$LOG_FILE" | \
awk '{
    if($0 ~ /SELECT/) select++
    else if($0 ~ /INSERT/) insert++
    else if($0 ~ /UPDATE/) update++
    else if($0 ~ /DELETE/) delete++
    else other++
}
END {
    total = select + insert + update + delete + other
    if(total > 0) {
        printf "  SELECT: %d (%.1f%%)\n", select, select*100/total
        printf "  INSERT: %d (%.1f%%)\n", insert, insert*100/total
        printf "  UPDATE: %d (%.1f%%)\n", update, update*100/total
        printf "  DELETE: %d (%.1f%%)\n", delete, delete*100/total
        printf "  OTHER:  %d (%.1f%%)\n", other, other*100/total
    }
}'

# æœ€æ´»è·ƒè¡¨åˆ†æ
echo
echo "ğŸ”¥ æœ€æ´»è·ƒçš„è¡¨ (TOP 10):"
grep -i "Query" "$LOG_FILE" | \
grep -oiE "(FROM|INTO|UPDATE|JOIN)\s+\w+" | \
awk '{print tolower($2)}' | \
sort | uniq -c | sort -nr | head -10 | \
awk '{printf "  %-20s: %dæ¬¡\n", $2, $1}'
```

---

## 6. ğŸ“Š ç»Ÿè®¡åˆ†ææ–¹æ³•


### 6.1 æŸ¥è¯¢é¢‘ç‡ç»Ÿè®¡åˆ†æ


**ğŸ“ˆ æ—¶é—´ç»´åº¦åˆ†æ**ï¼š

æŸ¥è¯¢é¢‘ç‡çš„æ—¶é—´åˆ†å¸ƒèƒ½å¤Ÿæ­ç¤ºä¸šåŠ¡è®¿é—®æ¨¡å¼ï¼š

```
å…¸å‹åˆ†æç»´åº¦ï¼š
æŒ‰å°æ—¶ç»Ÿè®¡ â†’ å‘ç°ä¸šåŠ¡é«˜å³°æœŸ
æŒ‰å¤©ç»Ÿè®¡   â†’ è¯†åˆ«å‘¨æœŸæ€§è§„å¾‹  
æŒ‰å‘¨ç»Ÿè®¡   â†’ å‘ç°å·¥ä½œæ—¥/å‘¨æœ«å·®å¼‚
æŒ‰æœˆç»Ÿè®¡   â†’ è§‚å¯Ÿä¸šåŠ¡å¢é•¿è¶‹åŠ¿
```

**å®é™…åˆ†æç¤ºä¾‹**ï¼š

```bash
# æŒ‰å°æ—¶ç»Ÿè®¡æŸ¥è¯¢åˆ†å¸ƒ
awk '/Query/ {
    match($0, /[0-9]{2}:[0-9]{2}:[0-9]{2}/)
    if(RSTART) {
        hour = substr($0, RSTART, 2)
        count[hour]++
    }
}
END {
    print "å°æ—¶\tæŸ¥è¯¢æ•°\tå æ¯”\tè¶‹åŠ¿å›¾"
    total = 0
    for(h in count) total += count[h]
    
    for(i=0; i<24; i++) {
        h = sprintf("%02d", i)
        cnt = count[h] ? count[h] : 0
        pct = total > 0 ? cnt*100/total : 0
        bar = ""
        for(j=0; j<cnt/100; j++) bar = bar "â–ˆ"
        printf "%s\t%d\t%.1f%%\t%s\n", h, cnt, pct, bar
    }
}' /var/log/mysql/general.log
```

### 6.2 ç”¨æˆ·æ´»åŠ¨åˆ†æ


**ğŸ‘¥ ç”¨æˆ·è¡Œä¸ºæ¨¡å¼è¯†åˆ«**ï¼š

é€šè¿‡åˆ†æä¸åŒç”¨æˆ·çš„æŸ¥è¯¢æ¨¡å¼ï¼Œå¯ä»¥è¯†åˆ«ï¼š
- **æ­£å¸¸ç”¨æˆ·**ï¼šæŸ¥è¯¢é¢‘ç‡ç¨³å®šï¼Œç±»å‹å¤šæ ·
- **çˆ¬è™«ç¨‹åº**ï¼šé«˜é¢‘ç‡ï¼Œæ¨¡å¼åŒ–æŸ¥è¯¢
- **å¼‚å¸¸ç”¨æˆ·**ï¼šå¼‚å¸¸é«˜é¢‘æˆ–å¯ç–‘æŸ¥è¯¢æ¨¡å¼

```python
def analyze_user_behavior(self):
    """ç”¨æˆ·è¡Œä¸ºåˆ†æ"""
    user_stats = defaultdict(lambda: {
        'query_count': 0,
        'query_types': defaultdict(int),
        'query_times': [],
        'unique_queries': set()
    })
    
    # æå–ç”¨æˆ·ä¿¡æ¯å¹¶ç»Ÿè®¡
    for query in self.queries:
        # ä»æŸ¥è¯¢æ—¥å¿—ä¸­æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¼å¼å¯èƒ½å› é…ç½®è€Œå¼‚ï¼‰
        user_match = re.search(r'(\w+)\[(\w+)\]', query.get('raw_line', ''))
        if user_match:
            username = user_match.group(1)
            
            user_stats[username]['query_count'] += 1
            user_stats[username]['query_types'][query['query_type']] += 1
            user_stats[username]['query_times'].append(query['timestamp'])
            user_stats[username]['unique_queries'].add(query['query'][:50])
    
    # åˆ†æç»“æœ
    print("\nğŸ‘¥ ç”¨æˆ·æ´»åŠ¨åˆ†æ:")
    sorted_users = sorted(user_stats.items(), 
                         key=lambda x: x[1]['query_count'], 
                         reverse=True)
    
    for username, stats in sorted_users[:10]:
        query_diversity = len(stats['unique_queries'])
        most_common_type = max(stats['query_types'], 
                              key=stats['query_types'].get)
        
        print(f"  {username}:")
        print(f"    æ€»æŸ¥è¯¢: {stats['query_count']}")
        print(f"    æŸ¥è¯¢å¤šæ ·æ€§: {query_diversity}")
        print(f"    ä¸»è¦æŸ¥è¯¢ç±»å‹: {most_common_type}")
        
        # åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚å¸¸ç”¨æˆ·
        if stats['query_count'] > 10000:  # é˜ˆå€¼å¯è°ƒæ•´
            print(f"    âš ï¸  é«˜é¢‘ç”¨æˆ·ï¼Œéœ€è¦å…³æ³¨")
        elif query_diversity < 5 and stats['query_count'] > 100:
            print(f"    ğŸ¤– å¯èƒ½æ˜¯è‡ªåŠ¨åŒ–ç¨‹åº")
```

### 6.3 æ•°æ®åº“è®¿é—®æ¨¡å¼åˆ†æ


**ğŸ¯ è¡¨è®¿é—®çƒ­åº¦åˆ†æ**ï¼š

```sql
-- ç”Ÿæˆè¡¨è®¿é—®ç»Ÿè®¡çš„SQLï¼ˆéœ€è¦å…ˆç”¨å·¥å…·æå–è¡¨åï¼‰
SELECT 
    table_name,
    access_count,
    ROUND(access_count * 100.0 / total_count, 2) as percentage
FROM (
    SELECT 
        table_name,
        COUNT(*) as access_count,
        SUM(COUNT(*)) OVER() as total_count
    FROM parsed_queries 
    WHERE table_name IS NOT NULL
    GROUP BY table_name
) t
ORDER BY access_count DESC
LIMIT 20;
```

**ğŸ“Š æŸ¥è¯¢å¤æ‚åº¦åˆ†æ**ï¼š

```python
def analyze_query_complexity(self):
    """åˆ†ææŸ¥è¯¢å¤æ‚åº¦"""
    complexity_stats = {
        'simple': 0,      # ç®€å•æŸ¥è¯¢ï¼ˆå•è¡¨ï¼Œæ— JOINï¼‰
        'moderate': 0,    # ä¸­ç­‰å¤æ‚ï¼ˆ2-3ä¸ªè¡¨ï¼‰
        'complex': 0      # å¤æ‚æŸ¥è¯¢ï¼ˆå¤šè¡¨JOINï¼Œå­æŸ¥è¯¢ç­‰ï¼‰
    }
    
    for query in self.queries:
        sql = query['query'].upper()
        
        # ç»Ÿè®¡JOINæ•°é‡
        join_count = sql.count('JOIN')
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å­æŸ¥è¯¢
        has_subquery = '(' in sql and 'SELECT' in sql[sql.find('(')+1:]
        
        # åˆ†ç±»
        if join_count == 0 and not has_subquery:
            complexity_stats['simple'] += 1
        elif join_count <= 2 and not has_subquery:
            complexity_stats['moderate'] += 1
        else:
            complexity_stats['complex'] += 1
    
    total = sum(complexity_stats.values())
    
    print("\nğŸ¯ æŸ¥è¯¢å¤æ‚åº¦åˆ†å¸ƒ:")
    for level, count in complexity_stats.items():
        percentage = (count / total * 100) if total > 0 else 0
        print(f"  {level.capitalize()}: {count} ({percentage:.1f}%)")
```

---

## 7. ğŸª å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 7.1 æ¡ˆä¾‹1ï¼šç”µå•†ç½‘ç«™æ€§èƒ½é—®é¢˜æ’æŸ¥


**ğŸ“‹ èƒŒæ™¯æè¿°**ï¼š
æŸç”µå•†ç½‘ç«™åœ¨ä¿ƒé”€æ´»åŠ¨æœŸé—´å‡ºç°å“åº”ç¼“æ…¢ï¼Œéœ€è¦é€šè¿‡æ—¥å¿—åˆ†ææ‰¾å‡ºé—®é¢˜æ ¹æºã€‚

**ğŸ” åˆ†æè¿‡ç¨‹**ï¼š

```bash
# æ­¥éª¤1ï¼šè·å–æ´»åŠ¨æœŸé—´çš„æ—¥å¿—
pt-query-digest \
  --since '2024-09-01 10:00:00' \
  --until '2024-09-01 14:00:00' \
  /var/log/mysql/general.log > promotion_analysis.txt

# æ­¥éª¤2ï¼šæ‰¾å‡ºæœ€é¢‘ç¹çš„æŸ¥è¯¢
head -50 promotion_analysis.txt
```

**ğŸ“Š å‘ç°çš„é—®é¢˜**ï¼š

```
åˆ†æç»“æœæ‘˜è¦ï¼š
1. å•†å“åº“å­˜æŸ¥è¯¢å æ€»æŸ¥è¯¢çš„45%
   SELECT stock_quantity FROM products WHERE product_id = ?
   
2. ç”¨æˆ·è´­ç‰©è½¦æŸ¥è¯¢é¢‘ç‡å¼‚å¸¸é«˜
   SELECT * FROM cart_items WHERE user_id = ?
   
3. å•†å“è¯¦æƒ…é¡µæŸ¥è¯¢ç¼ºå°‘ç´¢å¼•
   SELECT * FROM products WHERE category_id = ? ORDER BY sales_count DESC
```

**ğŸ’¡ ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- 1. æ·»åŠ å•†å“åº“å­˜ç¼“å­˜æœºåˆ¶
-- 2. ä¼˜åŒ–è´­ç‰©è½¦æŸ¥è¯¢ï¼Œæ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_cart_user_status ON cart_items(user_id, status);

-- 3. ä¸ºå•†å“åˆ†ç±»æŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX idx_products_category_sales ON products(category_id, sales_count);
```

### 7.2 æ¡ˆä¾‹2ï¼šå¼‚å¸¸ç”¨æˆ·è¡Œä¸ºæ£€æµ‹


**ğŸš¨ èƒŒæ™¯æè¿°**ï¼š
å‘ç°æ•°æ®åº“è´Ÿè½½å¼‚å¸¸ï¼Œæ€€ç–‘æœ‰ç”¨æˆ·è¿›è¡Œæ¶æ„æ“ä½œæˆ–çˆ¬è™«æ”»å‡»ã€‚

**ğŸ” æ£€æµ‹è„šæœ¬**ï¼š

```python
#!/usr/bin/env python3
import re
from collections import defaultdict
from datetime import datetime, timedelta

def detect_suspicious_activity(log_file):
    """æ£€æµ‹å¯ç–‘ç”¨æˆ·æ´»åŠ¨"""
    
    user_activity = defaultdict(lambda: {
        'queries_per_minute': defaultdict(int),
        'total_queries': 0,
        'unique_ips': set(),
        'query_patterns': defaultdict(int)
    })
    
    with open(log_file, 'r') as f:
        for line in f:
            # è§£ææ—¥å¿—è¡Œ
            match = re.match(r'(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}):\d{2}\s+\d+\s+Query\s+(.+)', line)
            if not match:
                continue
                
            time_minute, query = match.groups()
            
            # æå–ç”¨æˆ·ä¿¡æ¯ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
            user_match = re.search(r'(\w+)\[(\w+)\]', line)
            if user_match:
                username = user_match.group(1)
                
                user_activity[username]['queries_per_minute'][time_minute] += 1
                user_activity[username]['total_queries'] += 1
                
                # åˆ†ææŸ¥è¯¢æ¨¡å¼
                if 'SELECT' in query.upper():
                    user_activity[username]['query_patterns']['SELECT'] += 1
                elif 'INSERT' in query.upper():
                    user_activity[username]['query_patterns']['INSERT'] += 1
    
    # æ£€æµ‹å¼‚å¸¸
    print("ğŸš¨ å¯ç–‘ç”¨æˆ·æ´»åŠ¨æ£€æµ‹ç»“æœ:")
    
    for username, activity in user_activity.items():
        # æ£€æµ‹é«˜é¢‘ç‡ç”¨æˆ·
        max_queries_per_minute = max(activity['queries_per_minute'].values()) if activity['queries_per_minute'] else 0
        
        # å¼‚å¸¸åˆ¤æ–­æ¡ä»¶
        is_suspicious = False
        reasons = []
        
        if max_queries_per_minute > 100:  # æ¯åˆ†é’Ÿè¶…è¿‡100ä¸ªæŸ¥è¯¢
            is_suspicious = True
            reasons.append(f"é«˜é¢‘æŸ¥è¯¢: {max_queries_per_minute}/åˆ†é’Ÿ")
        
        if activity['total_queries'] > 10000:  # æ€»æŸ¥è¯¢è¶…è¿‡1ä¸‡
            is_suspicious = True
            reasons.append(f"æ€»æŸ¥è¯¢è¿‡å¤š: {activity['total_queries']}")
        
        # æŸ¥è¯¢æ¨¡å¼å•ä¸€ï¼ˆå¯èƒ½æ˜¯çˆ¬è™«ï¼‰
        select_ratio = activity['query_patterns']['SELECT'] / activity['total_queries']
        if select_ratio > 0.95 and activity['total_queries'] > 1000:
            is_suspicious = True
            reasons.append(f"æŸ¥è¯¢æ¨¡å¼å•ä¸€: {select_ratio:.1%} SELECT")
        
        if is_suspicious:
            print(f"\nâš ï¸  ç”¨æˆ·: {username}")
            print(f"   æ€»æŸ¥è¯¢æ•°: {activity['total_queries']}")
            print(f"   å³°å€¼é¢‘ç‡: {max_queries_per_minute}/åˆ†é’Ÿ")
            print(f"   å¼‚å¸¸åŸå› : {', '.join(reasons)}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    detect_suspicious_activity('/var/log/mysql/general.log')
```

### 7.3 æ¡ˆä¾‹3ï¼šä¸šåŠ¡å¢é•¿è¶‹åŠ¿åˆ†æ


**ğŸ“ˆ èƒŒæ™¯æè¿°**ï¼š
è¿è¥å›¢é˜Ÿéœ€è¦äº†è§£ä¸åŒä¸šåŠ¡æ¨¡å—çš„ä½¿ç”¨è¶‹åŠ¿ï¼Œä¸ºèµ„æºè§„åˆ’æä¾›æ•°æ®æ”¯æŒã€‚

**ğŸ“Š åˆ†æå®ç°**ï¼š

```bash
#!/bin/bash
# business_trend_analysis.sh

LOG_FILE="/var/log/mysql/general.log"
OUTPUT_DIR="./trend_analysis"

mkdir -p "$OUTPUT_DIR"

echo "ğŸ“ˆ ä¸šåŠ¡å¢é•¿è¶‹åŠ¿åˆ†æå¼€å§‹..."

# 1. æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»æŸ¥è¯¢
echo "æ­£åœ¨åˆ†æä¸šåŠ¡æ¨¡å—æŸ¥è¯¢åˆ†å¸ƒ..."

# ç”¨æˆ·ç›¸å…³æŸ¥è¯¢
grep -i "Query.*\(users\|user_profiles\|user_settings\)" "$LOG_FILE" | wc -l > "$OUTPUT_DIR/user_queries.count"

# è®¢å•ç›¸å…³æŸ¥è¯¢  
grep -i "Query.*\(orders\|order_items\|payments\)" "$LOG_FILE" | wc -l > "$OUTPUT_DIR/order_queries.count"

# å•†å“ç›¸å…³æŸ¥è¯¢
grep -i "Query.*\(products\|categories\|inventory\)" "$LOG_FILE" | wc -l > "$OUTPUT_DIR/product_queries.count"

# 2. ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Š
cat << EOF > "$OUTPUT_DIR/trend_report.txt"
=== ä¸šåŠ¡æ¨¡å—æŸ¥è¯¢ç»Ÿè®¡æŠ¥å‘Š ===
ç”Ÿæˆæ—¶é—´: $(date)

ç”¨æˆ·æ¨¡å—æŸ¥è¯¢æ•°: $(cat "$OUTPUT_DIR/user_queries.count")
è®¢å•æ¨¡å—æŸ¥è¯¢æ•°: $(cat "$OUTPUT_DIR/order_queries.count")  
å•†å“æ¨¡å—æŸ¥è¯¢æ•°: $(cat "$OUTPUT_DIR/product_queries.count")

æ€»æŸ¥è¯¢æ•°: $(grep -c "Query" "$LOG_FILE")

å„æ¨¡å—å æ¯”:
EOF

# è®¡ç®—å æ¯”
total_queries=$(grep -c "Query" "$LOG_FILE")
user_queries=$(cat "$OUTPUT_DIR/user_queries.count")
order_queries=$(cat "$OUTPUT_DIR/order_queries.count")
product_queries=$(cat "$OUTPUT_DIR/product_queries.count")

if [ $total_queries -gt 0 ]; then
    user_pct=$(echo "scale=1; $user_queries * 100 / $total_queries" | bc)
    order_pct=$(echo "scale=1; $order_queries * 100 / $total_queries" | bc)
    product_pct=$(echo "scale=1; $product_queries * 100 / $total_queries" | bc)
    
    echo "ç”¨æˆ·æ¨¡å—: $user_pct%" >> "$OUTPUT_DIR/trend_report.txt"
    echo "è®¢å•æ¨¡å—: $order_pct%" >> "$OUTPUT_DIR/trend_report.txt"
    echo "å•†å“æ¨¡å—: $product_pct%" >> "$OUTPUT_DIR/trend_report.txt"
fi

echo "âœ… åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜åœ¨: $OUTPUT_DIR/trend_report.txt"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å·¥å…·ä½¿ç”¨


```
ğŸ”¸ mysqldumpslowï¼šMySQLè‡ªå¸¦å·¥å…·ï¼Œé€‚åˆå¿«é€Ÿåˆ†æ
ğŸ”¸ pt-query-digestï¼šåŠŸèƒ½æœ€å¼ºå¤§ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
ğŸ”¸ grep/awk/sedï¼šè½»é‡çº§å·¥å…·ï¼Œé€‚åˆç®€å•è¿‡æ»¤å’Œç»Ÿè®¡
ğŸ”¸ è‡ªå®šä¹‰è„šæœ¬ï¼šé’ˆå¯¹ç‰¹å®šéœ€æ±‚çš„çµæ´»è§£å†³æ–¹æ¡ˆ
```

### 8.2 å…³é”®åˆ†æç»´åº¦


**ğŸ”¹ æ€§èƒ½åˆ†æç»´åº¦**ï¼š
```
æŸ¥è¯¢é¢‘ç‡ â†’ æ‰¾å‡ºçƒ­ç‚¹æŸ¥è¯¢
æ‰§è¡Œæ—¶é—´ â†’ è¯†åˆ«æ…¢æŸ¥è¯¢æ¨¡å¼  
èµ„æºæ¶ˆè€— â†’ è¯„ä¼°ç³»ç»Ÿè´Ÿè½½
æŸ¥è¯¢å¤æ‚åº¦ â†’ ä¼˜åŒ–SQLç»“æ„
```

**ğŸ”¹ ä¸šåŠ¡åˆ†æç»´åº¦**ï¼š
```
ç”¨æˆ·è¡Œä¸º â†’ è¯†åˆ«å¼‚å¸¸æ´»åŠ¨
è®¿é—®æ¨¡å¼ â†’ äº†è§£ä¸šåŠ¡ç‰¹ç‚¹
å¢é•¿è¶‹åŠ¿ â†’ æ”¯æŒå®¹é‡è§„åˆ’
å®‰å…¨ç›‘æ§ â†’ é˜²èŒƒæ¶æ„æ”»å‡»
```

### 8.3 å®æˆ˜åº”ç”¨ä»·å€¼


**ğŸ¯ é—®é¢˜æ’æŸ¥åœºæ™¯**ï¼š
- **æ€§èƒ½é—®é¢˜**ï¼šé€šè¿‡æ—¥å¿—åˆ†ææ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ
- **å¼‚å¸¸æ£€æµ‹**ï¼šè¯†åˆ«å¯ç–‘ç”¨æˆ·è¡Œä¸ºå’Œå®‰å…¨å¨èƒ
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹èµ„æºéœ€æ±‚
- **ä¸šåŠ¡åˆ†æ**ï¼šäº†è§£ç”¨æˆ·ä½¿ç”¨æ¨¡å¼å’Œä¸šåŠ¡ç‰¹ç‚¹

**ğŸ”§ ä¼˜åŒ–æŒ‡å¯¼**ï¼š
- **ç´¢å¼•ä¼˜åŒ–**ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼æ·»åŠ åˆé€‚ç´¢å¼•
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šé‡å†™ä½æ•ˆSQLè¯­å¥
- **æ¶æ„è°ƒæ•´**ï¼šåŸºäºè®¿é—®æ¨¡å¼è°ƒæ•´ç³»ç»Ÿæ¶æ„
- **ç¼“å­˜ç­–ç•¥**ï¼šé’ˆå¯¹çƒ­ç‚¹æŸ¥è¯¢å®æ–½ç¼“å­˜

**æ ¸å¿ƒè®°å¿†**ï¼š
- å·¥å…·é€‰æ‹©è¦çœ‹éœ€æ±‚ï¼šç®€å•ç”¨mysqldumpslowï¼Œæ·±åº¦ç”¨pt-query-digest
- åˆ†æè¦æœ‰é‡ç‚¹ï¼šå…³æ³¨é«˜é¢‘æŸ¥è¯¢å’Œå¼‚å¸¸æ¨¡å¼
- ç»“æœè¦èƒ½æŒ‡å¯¼ä¼˜åŒ–ï¼šä¸åªæ˜¯ç»Ÿè®¡ï¼Œæ›´è¦å‘ç°é—®é¢˜
- ç›‘æ§è¦æˆä½“ç³»ï¼šå®šæœŸåˆ†æï¼ŒåŠæ—¶å‘ç°è¶‹åŠ¿å˜åŒ–