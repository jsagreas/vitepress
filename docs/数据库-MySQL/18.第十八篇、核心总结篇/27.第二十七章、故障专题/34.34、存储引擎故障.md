---
title: 34ã€å­˜å‚¨å¼•æ“æ•…éšœ
---
## ğŸ“š ç›®å½•

1. [å­˜å‚¨å¼•æ“æ•…éšœæ¦‚è¿°](#1-å­˜å‚¨å¼•æ“æ•…éšœæ¦‚è¿°)
2. [InnoDBå­˜å‚¨å¼•æ“æ•…éšœ](#2-InnoDBå­˜å‚¨å¼•æ“æ•…éšœ)
3. [MyISAMè¡¨æŸåé—®é¢˜](#3-MyISAMè¡¨æŸåé—®é¢˜)
4. [å­˜å‚¨å¼•æ“åˆ‡æ¢æ•…éšœ](#4-å­˜å‚¨å¼•æ“åˆ‡æ¢æ•…éšœ)
5. [äº‹åŠ¡æ—¥å¿—å¼‚å¸¸å¤„ç†](#5-äº‹åŠ¡æ—¥å¿—å¼‚å¸¸å¤„ç†)
6. [è¡¨ç©ºé—´ç®¡ç†é”™è¯¯](#6-è¡¨ç©ºé—´ç®¡ç†é”™è¯¯)
7. [å­˜å‚¨å¼•æ“å‚æ•°ä¸æ€§èƒ½é—®é¢˜](#7-å­˜å‚¨å¼•æ“å‚æ•°ä¸æ€§èƒ½é—®é¢˜)
8. [å­˜å‚¨å¼•æ“ç›‘æ§ä¸é¢„é˜²](#8-å­˜å‚¨å¼•æ“ç›‘æ§ä¸é¢„é˜²)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ å­˜å‚¨å¼•æ“æ•…éšœæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å­˜å‚¨å¼•æ“


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
å­˜å‚¨å¼•æ“å°±åƒæ˜¯MySQLçš„"æ•°æ®ç®¡å®¶"ï¼Œè´Ÿè´£å†³å®šæ•°æ®æ€ä¹ˆå­˜ã€æ€ä¹ˆå–ã€æ€ä¹ˆç®¡ç†ã€‚å°±åƒä¸åŒçš„ä»“åº“ç®¡ç†å‘˜æœ‰ä¸åŒçš„ç®¡ç†æ–¹å¼ä¸€æ ·ã€‚

```
MySQLæ¶æ„ç®€å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    MySQL Server     â”‚ â† æ¥æ”¶SQLè¯·æ±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å­˜å‚¨å¼•æ“å±‚        â”‚ â† å®é™…ç®¡ç†æ•°æ®
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚InnoDBâ”‚ â”‚MyISAM â”‚ â”‚ â† ä¸åŒçš„å­˜å‚¨å¼•æ“
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ–‡ä»¶ç³»ç»Ÿ         â”‚ â† æ•°æ®æœ€ç»ˆå­˜åœ¨ç£ç›˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å¸¸è§å­˜å‚¨å¼•æ“ç‰¹ç‚¹


| å­˜å‚¨å¼•æ“ | **ä¸»è¦ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **å¸¸è§æ•…éšœ** |
|---------|-------------|-------------|-------------|
| **InnoDB** | `æ”¯æŒäº‹åŠ¡ã€è¡Œé”ã€å¤–é”®` | `OLTPä¸šåŠ¡ã€é«˜å¹¶å‘` | `äº‹åŠ¡æ—¥å¿—æŸåã€æ­»é”` |
| **MyISAM** | `è¡¨é”ã€æŸ¥è¯¢å¿«ã€ä¸æ”¯æŒäº‹åŠ¡` | `è¯»å¤šå†™å°‘ã€æ•°æ®ä»“åº“` | `è¡¨æ–‡ä»¶æŸåã€ç´¢å¼•å¼‚å¸¸` |
| **Memory** | `æ•°æ®å­˜åœ¨å†…å­˜` | `ä¸´æ—¶æ•°æ®ã€ç¼“å­˜` | `æœåŠ¡å™¨é‡å¯æ•°æ®ä¸¢å¤±` |
| **Archive** | `é«˜å‹ç¼©æ¯”ã€åªèƒ½æ’å…¥æŸ¥è¯¢` | `æ—¥å¿—å­˜å‚¨ã€å½’æ¡£` | `å‹ç¼©æ–‡ä»¶æŸå` |

### 1.3 å­˜å‚¨å¼•æ“æ•…éšœåˆ†ç±»


**ğŸ”¸ æŒ‰å½±å“èŒƒå›´åˆ†ç±»**ï¼š
```
å®ä¾‹çº§æ•…éšœï¼š
â€¢ æ•´ä¸ªMySQLæœåŠ¡æ— æ³•å¯åŠ¨
â€¢ æ‰€æœ‰è¡¨éƒ½æ— æ³•è®¿é—®
â€¢ ç¤ºä¾‹ï¼šäº‹åŠ¡æ—¥å¿—æŸåã€å‚æ•°é…ç½®é”™è¯¯

è¡¨çº§æ•…éšœï¼š
â€¢ å•ä¸ªæˆ–éƒ¨åˆ†è¡¨æ— æ³•è®¿é—®
â€¢ å…¶ä»–è¡¨æ­£å¸¸å·¥ä½œ
â€¢ ç¤ºä¾‹ï¼šMyISAMè¡¨æ–‡ä»¶æŸåã€è¡¨ç©ºé—´å¼‚å¸¸

æ•°æ®çº§æ•…éšœï¼š
â€¢ è¡¨èƒ½è®¿é—®ä½†æ•°æ®å¼‚å¸¸
â€¢ æŸ¥è¯¢ç»“æœé”™è¯¯æˆ–ä¸å®Œæ•´
â€¢ ç¤ºä¾‹ï¼šç´¢å¼•æŸåã€æ•°æ®é¡µæŸå
```

---

## 2. ğŸ—ï¸ InnoDBå­˜å‚¨å¼•æ“æ•…éšœ


### 2.1 InnoDBåŸºç¡€æ¶æ„


**ğŸ’¡ InnoDBå·¥ä½œåŸç†**ï¼š
InnoDBåƒä¸€ä¸ªç°ä»£åŒ–çš„é“¶è¡Œï¼Œæœ‰å®Œå–„çš„è´¦æœ¬ï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰ã€ä¿é™©ç®±ï¼ˆè¡¨ç©ºé—´ï¼‰ï¼Œæ”¯æŒå®‰å…¨çš„è½¬è´¦æ“ä½œï¼ˆäº‹åŠ¡ï¼‰ã€‚

```
InnoDBæ ¸å¿ƒç»„ä»¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Buffer Pool           â”‚ â† å†…å­˜ç¼“å†²æ± 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Redo Log    â”‚   Undo Log      â”‚ â† é‡åš/æ’¤é”€æ—¥å¿—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       è¡¨ç©ºé—´æ–‡ä»¶               â”‚ â† å®é™…æ•°æ®å­˜å‚¨
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚.ibd  â”‚ â”‚.ibd  â”‚ â”‚.ibd  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 InnoDBå¯åŠ¨å¤±è´¥æ•…éšœ


**ğŸš¨ å¸¸è§é”™è¯¯ä¿¡æ¯**ï¼š
```sql
-- å…¸å‹é”™è¯¯æ—¥å¿—
InnoDB: Database page corruption on disk or a failed file read
InnoDB: The log sequence number in the system tablespace does not match
InnoDB: Unable to open the system tablespace
```

**ğŸ”§ æ•…éšœå¤„ç†æ­¥éª¤**ï¼š

**Step 1: å¼ºåˆ¶æ¢å¤æ¨¡å¼**
```ini
# åœ¨my.cnfä¸­æ·»åŠ 
[mysqld]
innodb_force_recovery = 1

# æ¢å¤çº§åˆ«è¯´æ˜ï¼š
# 1: å¿½ç•¥æŸåçš„é¡µé¢
# 2: é˜»æ­¢åå°çº¿ç¨‹è¿è¡Œ
# 3: ä¸è¿›è¡Œäº‹åŠ¡å›æ»š
# 4: ä¸è¿›è¡Œæ’å…¥ç¼“å†²åŒºåˆå¹¶
# 5: ä¸æŸ¥çœ‹æ’¤é”€æ—¥å¿—
# 6: ä¸è¿›è¡Œå‰æ»šæ“ä½œ
```

**Step 2: æ•°æ®å¯¼å‡º**
```bash
# å¯åŠ¨MySQLåç«‹å³å¯¼å‡ºæ•°æ®
mysqldump --single-transaction --routines --triggers \
  --all-databases > backup_$(date +%Y%m%d).sql

# å¯¼å‡ºå•ä¸ªè¡¨
mysqldump dbname tablename > table_backup.sql
```

**Step 3: é‡å»ºå®ä¾‹**
```bash
# 1. åœæ­¢MySQL
systemctl stop mysql

# 2. å¤‡ä»½åŸæ•°æ®ç›®å½•
mv /var/lib/mysql /var/lib/mysql_backup

# 3. é‡æ–°åˆå§‹åŒ–
mysql_install_db --user=mysql --datadir=/var/lib/mysql

# 4. å¯åŠ¨å¹¶æ¢å¤æ•°æ®
mysql < backup_$(date +%Y%m%d).sql
```

### 2.3 InnoDBè¡¨ç©ºé—´æŸå


**ğŸ’¡ è¡¨ç©ºé—´æ¦‚å¿µ**ï¼š
è¡¨ç©ºé—´å°±åƒæ–‡ä»¶æŸœï¼Œæ¯ä¸ªæŠ½å±‰ï¼ˆè¡¨ï¼‰éƒ½æœ‰è‡ªå·±çš„å­˜å‚¨åŒºåŸŸã€‚å½“æ–‡ä»¶æŸœæŸåæ—¶ï¼Œéœ€è¦ä¿®å¤æˆ–é‡å»ºã€‚

**ğŸ” æŸåæ£€æµ‹**ï¼š
```sql
-- æ£€æŸ¥è¡¨å®Œæ•´æ€§
CHECK TABLE your_table_name;

-- ä¿®å¤è¡¨
REPAIR TABLE your_table_name;

-- æŸ¥çœ‹è¡¨çŠ¶æ€
SHOW TABLE STATUS LIKE 'your_table_name'\G
```

**ğŸ› ï¸ ä¿®å¤æ–¹æ³•**ï¼š

**æ–¹æ³•1: ä½¿ç”¨innodb_force_recovery**
```sql
-- è®¾ç½®å¼ºåˆ¶æ¢å¤åé‡å¯MySQL
SET GLOBAL innodb_force_recovery = 1;

-- å¯¼å‡ºæ•°æ®
SELECT * INTO OUTFILE '/tmp/table_data.txt' 
FROM your_table_name;
```

**æ–¹æ³•2: é‡å»ºè¡¨**
```sql
-- åˆ›å»ºæ–°è¡¨ç»“æ„
CREATE TABLE new_table_name LIKE old_table_name;

-- æ’å…¥å¯æ¢å¤çš„æ•°æ®
INSERT INTO new_table_name 
SELECT * FROM old_table_name;

-- é‡å‘½åè¡¨
RENAME TABLE old_table_name TO old_table_backup,
             new_table_name TO old_table_name;
```

### 2.4 InnoDBæ­»é”é—®é¢˜


**ğŸ’¡ æ­»é”åŸç†**ï¼š
æ­»é”å°±åƒä¸¤ä¸ªäººäº’ç›¸ç­‰å¯¹æ–¹è®©è·¯ï¼Œç»“æœéƒ½èµ°ä¸äº†ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”å°±å½¢æˆæ­»é”ã€‚

```
æ­»é”åœºæ™¯ç¤ºä¾‹ï¼š
æ—¶é—´  äº‹åŠ¡A                äº‹åŠ¡B
T1    é”å®šè®°å½•1             
T2                         é”å®šè®°å½•2
T3    è¯·æ±‚é”å®šè®°å½•2ï¼ˆç­‰å¾…ï¼‰   
T4                         è¯·æ±‚é”å®šè®°å½•1ï¼ˆç­‰å¾…ï¼‰
ç»“æœ  â† æ­»é”å‘ç”Ÿ â†’
```

**ğŸ” æ­»é”æ£€æµ‹**ï¼š
```sql
-- æŸ¥çœ‹å½“å‰é”çŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- æŸ¥çœ‹æ­»é”æ—¥å¿—
SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCKS;
SELECT * FROM INFORMATION_SCHEMA.INNODB_LOCK_WAITS;
```

**ğŸ›¡ï¸ æ­»é”é¢„é˜²**ï¼š
```sql
-- 1. ç»Ÿä¸€é”å®šé¡ºåº
BEGIN;
SELECT * FROM table1 WHERE id = 1 FOR UPDATE;  -- å…ˆé”1
SELECT * FROM table2 WHERE id = 2 FOR UPDATE;  -- åé”2
COMMIT;

-- 2. ç¼©çŸ­äº‹åŠ¡æ—¶é—´
BEGIN;
-- å°½å¿«å®Œæˆæ“ä½œ
UPDATE table1 SET col1 = 'value' WHERE id = 1;
COMMIT;  -- ç«‹å³æäº¤

-- 3. é™ä½éš”ç¦»çº§åˆ«ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

---

## 3. ğŸ“ MyISAMè¡¨æŸåé—®é¢˜


### 3.1 MyISAMå­˜å‚¨ç»“æ„


**ğŸ’¡ MyISAMç‰¹ç‚¹**ï¼š
MyISAMå°±åƒä¼ ç»Ÿçš„æ–‡ä»¶æŸœï¼Œæ¯ä¸ªè¡¨å¯¹åº”ä¸‰ä¸ªæ–‡ä»¶ï¼šæ•°æ®æ–‡ä»¶ï¼ˆ.MYDï¼‰ã€ç´¢å¼•æ–‡ä»¶ï¼ˆ.MYIï¼‰ã€è¡¨ç»“æ„æ–‡ä»¶ï¼ˆ.frmï¼‰ã€‚

```
MyISAMæ–‡ä»¶ç»“æ„ï¼š
table_name.frm  â† è¡¨ç»“æ„å®šä¹‰
table_name.MYD  â† è¡¨æ•°æ®ï¼ˆMyISAM Dataï¼‰
table_name.MYI  â† è¡¨ç´¢å¼•ï¼ˆMyISAM Indexï¼‰

æŸåå½±å“ï¼š
.frmæŸå  â†’ è¡¨æ— æ³•æ‰“å¼€
.MYDæŸå  â†’ æ•°æ®è¯»å–é”™è¯¯
.MYIæŸå  â†’ æŸ¥è¯¢é€Ÿåº¦æ…¢ï¼Œç´¢å¼•å¤±æ•ˆ
```

### 3.2 MyISAMè¡¨æŸåæ£€æµ‹


**ğŸ” æ£€æµ‹å‘½ä»¤**ï¼š
```sql
-- æ£€æŸ¥è¡¨å®Œæ•´æ€§
CHECK TABLE table_name;

-- æ‰©å±•æ£€æŸ¥
CHECK TABLE table_name EXTENDED;

-- æ£€æŸ¥æ‰€æœ‰MyISAMè¡¨
SELECT table_name 
FROM information_schema.tables 
WHERE engine = 'MyISAM' AND table_schema = 'your_database';
```

**ğŸ“Š æ£€æŸ¥ç»“æœè§£è¯»**ï¼š
```sql
-- æ­£å¸¸ç»“æœ
Table    Op      Msg_type    Msg_text
mydb.mytable check   status      OK

-- æŸåç»“æœ
Table    Op      Msg_type    Msg_text
mydb.mytable check   error       Table is marked as crashed
mydb.mytable check   error       Corrupt
```

### 3.3 MyISAMè¡¨ä¿®å¤


**ğŸ”§ ä¿®å¤æ–¹æ³•å¯¹æ¯”**ï¼š

| ä¿®å¤æ–¹æ³• | **é€Ÿåº¦** | **æˆåŠŸç‡** | **æ•°æ®å®‰å…¨æ€§** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-----------|---------------|-------------|
| `REPAIR TABLE` | **å¿«** | **ä¸­ç­‰** | **é«˜** | **è½»å¾®æŸå** |
| `myisamchk` | **ä¸­ç­‰** | **é«˜** | **ä¸­ç­‰** | **ä¸­åº¦æŸå** |
| `myisamchk --recover` | **æ…¢** | **å¾ˆé«˜** | **ä½** | **ä¸¥é‡æŸå** |

**æ–¹æ³•1: åœ¨çº¿ä¿®å¤**
```sql
-- MySQLè¿è¡Œæ—¶ä¿®å¤
REPAIR TABLE table_name;

-- å¿«é€Ÿä¿®å¤
REPAIR TABLE table_name QUICK;

-- æ‰©å±•ä¿®å¤
REPAIR TABLE table_name EXTENDED;
```

**æ–¹æ³•2: ç¦»çº¿ä¿®å¤**
```bash
# 1. åœæ­¢MySQLæœåŠ¡
systemctl stop mysql

# 2. è¿›å…¥æ•°æ®ç›®å½•
cd /var/lib/mysql/database_name

# 3. æ£€æŸ¥è¡¨
myisamchk table_name.MYI

# 4. ä¿®å¤è¡¨
myisamchk --recover table_name.MYI

# 5. å¼ºåˆ¶ä¿®å¤ï¼ˆä¸¥é‡æŸåæ—¶ï¼‰
myisamchk --safe-recover table_name.MYI

# 6. é‡å¯MySQL
systemctl start mysql
```

**æ–¹æ³•3: é‡å»ºç´¢å¼•**
```bash
# åˆ é™¤å¹¶é‡å»ºç´¢å¼•æ–‡ä»¶
rm table_name.MYI
myisamchk --create-missing-keys table_name.MYD
```

### 3.4 MyISAMé¢„é˜²æªæ–½


**ğŸ›¡ï¸ é¢„é˜²ç­–ç•¥**ï¼š
```ini
# my.cnfé…ç½®ä¼˜åŒ–
[mysqld]
# å¯ç”¨MyISAMè‡ªåŠ¨æ¢å¤
myisam_recover_options = BACKUP,FORCE

# è®¾ç½®é”®ç¼“å†²åŒºå¤§å°
key_buffer_size = 256M

# å»¶è¿Ÿé”®å†™å…¥
delay_key_write = ALL

[myisamchk]
# ä¿®å¤æ—¶çš„å†…å­˜è®¾ç½®
key_buffer_size = 128M
sort_buffer_size = 128M
read_buffer = 32M
write_buffer = 32M
```

---

## 4. ğŸ”„ å­˜å‚¨å¼•æ“åˆ‡æ¢æ•…éšœ


### 4.1 å­˜å‚¨å¼•æ“åˆ‡æ¢åœºæ™¯


**ğŸ’¡ ä¸ºä»€ä¹ˆè¦åˆ‡æ¢å­˜å‚¨å¼•æ“**ï¼š
å°±åƒæ¬å®¶ä¸€æ ·ï¼Œæœ‰æ—¶å€™åŸæ¥çš„æˆ¿å­ï¼ˆå­˜å‚¨å¼•æ“ï¼‰ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ¬åˆ°æ›´åˆé€‚çš„åœ°æ–¹ã€‚

**å¸¸è§åˆ‡æ¢åœºæ™¯**ï¼š
```
MyISAM â†’ InnoDBï¼š
â€¢ éœ€è¦äº‹åŠ¡æ”¯æŒ
â€¢ è¦æ±‚æ›´å¥½çš„å¹¶å‘æ€§èƒ½
â€¢ éœ€è¦å¤–é”®çº¦æŸ
â€¢ è¦æ±‚å´©æºƒæ¢å¤èƒ½åŠ›

InnoDB â†’ MyISAMï¼š
â€¢ åªè¯»æŸ¥è¯¢ä¸ºä¸»
â€¢ éœ€è¦æ›´å¿«çš„SELECTæ€§èƒ½
â€¢ å­˜å‚¨ç©ºé—´è¦æ±‚ä¸¥æ ¼
â€¢ ç®€å•çš„æ•°æ®ç»“æ„
```

### 4.2 ALTER TABLEåˆ‡æ¢æ–¹æ³•


**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
åˆ‡æ¢å­˜å‚¨å¼•æ“ä¼šé‡å»ºæ•´ä¸ªè¡¨ï¼Œå°±åƒæ¬å®¶è¦æŠŠæ‰€æœ‰ä¸œè¥¿é‡æ–°è£…ç®±ä¸€æ ·ï¼Œéœ€è¦æ—¶é—´å’Œç©ºé—´ã€‚

```sql
-- åŸºæœ¬åˆ‡æ¢è¯­æ³•
ALTER TABLE table_name ENGINE = InnoDB;

-- æŸ¥çœ‹å½“å‰å­˜å‚¨å¼•æ“
SHOW CREATE TABLE table_name;
SHOW TABLE STATUS LIKE 'table_name';
```

**ğŸ•’ åˆ‡æ¢æ—¶é—´ä¼°ç®—**ï¼š
```
è¡¨å¤§å°         é¢„ä¼°æ—¶é—´
1GB           2-5åˆ†é’Ÿ
10GB          20-50åˆ†é’Ÿ  
100GB         3-8å°æ—¶
1TB           1-3å¤©

å½±å“å› ç´ ï¼š
â€¢ ç£ç›˜I/Oæ€§èƒ½
â€¢ ç´¢å¼•æ•°é‡
â€¢ æœåŠ¡å™¨è´Ÿè½½
â€¢ å†…å­˜å¤§å°
```

### 4.3 åœ¨çº¿åˆ‡æ¢ç­–ç•¥


**æ–¹æ³•1: pt-online-schema-change**
```bash
# å®‰è£…Percona Toolkit
yum install percona-toolkit

# åœ¨çº¿åˆ‡æ¢å­˜å‚¨å¼•æ“
pt-online-schema-change \
  --alter "ENGINE=InnoDB" \
  --execute \
  --host=localhost \
  --user=root \
  --password=yourpassword \
  D=database_name,t=table_name
```

**æ–¹æ³•2: åˆ›å»ºæ–°è¡¨æ–¹å¼**
```sql
-- 1. åˆ›å»ºæ–°è¡¨ç»“æ„
CREATE TABLE table_name_new LIKE table_name;
ALTER TABLE table_name_new ENGINE = InnoDB;

-- 2. å¯¼å…¥æ•°æ®
INSERT INTO table_name_new SELECT * FROM table_name;

-- 3. é‡å‘½åè¡¨
RENAME TABLE 
  table_name TO table_name_old,
  table_name_new TO table_name;

-- 4. éªŒè¯ååˆ é™¤æ—§è¡¨
DROP TABLE table_name_old;
```

### 4.4 åˆ‡æ¢æ•…éšœå¤„ç†


**ğŸš¨ å¸¸è§æ•…éšœåŠè§£å†³**ï¼š

**æ•…éšœ1: ç£ç›˜ç©ºé—´ä¸è¶³**
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# è§£å†³æ–¹æ¡ˆ
# 1. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
# 2. æ‰©å±•ç£ç›˜ç©ºé—´
# 3. ä½¿ç”¨å¤–éƒ¨ä¸´æ—¶ç›®å½•
SET SESSION tmpdir = '/external/temp/path';
```

**æ•…éšœ2: å­—ç¬¦é›†ä¸å…¼å®¹**
```sql
-- æ£€æŸ¥å­—ç¬¦é›†
SHOW CREATE TABLE table_name;

-- ç»Ÿä¸€å­—ç¬¦é›†
ALTER TABLE table_name CONVERT TO CHARACTER SET utf8mb4;
ALTER TABLE table_name ENGINE = InnoDB;
```

**æ•…éšœ3: ä¸»é”®ç¼ºå¤±ï¼ˆMyISAMâ†’InnoDBï¼‰**
```sql
-- InnoDBè¦æ±‚æœ‰ä¸»é”®
-- æ·»åŠ è‡ªå¢ä¸»é”®
ALTER TABLE table_name ADD COLUMN id INT AUTO_INCREMENT PRIMARY KEY FIRST;

-- ç„¶ååˆ‡æ¢å¼•æ“
ALTER TABLE table_name ENGINE = InnoDB;
```

---

## 5. ğŸ“ äº‹åŠ¡æ—¥å¿—å¼‚å¸¸å¤„ç†


### 5.1 äº‹åŠ¡æ—¥å¿—åŸºç¡€


**ğŸ’¡ äº‹åŠ¡æ—¥å¿—ä½œç”¨**ï¼š
äº‹åŠ¡æ—¥å¿—å°±åƒé“¶è¡Œçš„æµæ°´è´¦ï¼Œè®°å½•æ¯ä¸€ç¬”äº¤æ˜“ï¼Œç¡®ä¿å‡ºé—®é¢˜æ—¶èƒ½æ‰¾å›è®°å½•æˆ–å›æ»šæ“ä½œã€‚

```
InnoDBæ—¥å¿—ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redo Log      â”‚ â† é‡åšæ—¥å¿—ï¼ˆç¡®ä¿å·²æäº¤äº‹åŠ¡ä¸ä¸¢å¤±ï¼‰
â”‚   ib_logfile0   â”‚   
â”‚   ib_logfile1   â”‚   
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Undo Log      â”‚ â† æ’¤é”€æ—¥å¿—ï¼ˆæ”¯æŒäº‹åŠ¡å›æ»šï¼‰
â”‚   ibdata1ä¸­     â”‚   
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Binary Log    â”‚ â† äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆä¸»ä»å¤åˆ¶ã€æ—¶é—´ç‚¹æ¢å¤ï¼‰
â”‚   mysql-bin.*   â”‚   
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Redo LogæŸåå¤„ç†


**ğŸ” æŸåç—‡çŠ¶**ï¼š
```
é”™è¯¯æ—¥å¿—ç¤ºä¾‹ï¼š
InnoDB: The log file ./ib_logfile1 is of different size
InnoDB: Log file ./ib_logfile0 is of different size  
InnoDB: Cannot create log files because data files are corrupt
```

**ğŸ› ï¸ ä¿®å¤æ­¥éª¤**ï¼š

**Step 1: å®‰å…¨åœæ­¢MySQL**
```bash
# æ­£å¸¸åœæ­¢
mysqladmin shutdown

# å¦‚æœæ— æ³•æ­£å¸¸åœæ­¢ï¼Œå¼ºåˆ¶åœæ­¢
killall mysqld
```

**Step 2: å¤‡ä»½ç°æœ‰æ—¥å¿—**
```bash
cd /var/lib/mysql
mv ib_logfile0 ib_logfile0.bak
mv ib_logfile1 ib_logfile1.bak
```

**Step 3: é‡å»ºæ—¥å¿—æ–‡ä»¶**
```bash
# MySQLä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
systemctl start mysql

# æ£€æŸ¥é”™è¯¯æ—¥å¿—
tail -f /var/log/mysql/error.log
```

**âš ï¸ ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼š
```ini
# å¦‚æœæ•°æ®æ–‡ä»¶ä¹ŸæŸåï¼Œéœ€è¦å¼ºåˆ¶æ¢å¤
[mysqld]
innodb_force_recovery = 6
innodb_purge_threads = 0
innodb_large_prefix = 0
innodb_undo_logs = 0
```

### 5.3 Binary Logå¼‚å¸¸å¤„ç†


**ğŸ’¡ Binary Logç”¨é€”**ï¼š
Binary Logè®°å½•æ‰€æœ‰ä¿®æ”¹æ•°æ®çš„SQLè¯­å¥ï¼Œç”¨äºä¸»ä»å¤åˆ¶å’Œæ•°æ®æ¢å¤ã€‚

**ğŸ” æ£€æŸ¥Binary Log**ï¼š
```sql
-- æŸ¥çœ‹Binary Logæ–‡ä»¶
SHOW BINARY LOGS;

-- æŸ¥çœ‹Binary Logå†…å®¹
SHOW BINLOG EVENTS IN 'mysql-bin.000001';

-- æ£€æŸ¥Binary LogçŠ¶æ€
SHOW MASTER STATUS;
```

**ğŸ› ï¸ æŸåå¤„ç†**ï¼š
```bash
# 1. æ£€æŸ¥Binary Logå®Œæ•´æ€§
mysqlbinlog mysql-bin.000001 > /dev/null

# 2. å¦‚æœæŸåï¼Œä»æŒ‡å®šä½ç½®å¼€å§‹è¯»å–
mysqlbinlog --start-position=1000 mysql-bin.000001

# 3. é‡ç½®Binary Logï¼ˆæ³¨æ„ï¼šä¼šå½±å“å¤åˆ¶ï¼‰
mysql -e "RESET MASTER;"

# 4. æ¸…ç†æ—§çš„Binary Log
mysql -e "PURGE BINARY LOGS BEFORE '2024-01-01 00:00:00';"
```

---

## 6. ğŸ’¾ è¡¨ç©ºé—´ç®¡ç†é”™è¯¯


### 6.1 è¡¨ç©ºé—´æ¦‚å¿µ


**ğŸ’¡ è¡¨ç©ºé—´ç†è§£**ï¼š
è¡¨ç©ºé—´å°±åƒä¸€ä¸ªå¤§ä»“åº“ï¼Œé‡Œé¢æœ‰å¾ˆå¤šè´§æ¶ï¼ˆè¡¨ï¼‰ï¼Œæ¯ä¸ªè´§æ¶å­˜æ”¾ä¸åŒçš„å•†å“ï¼ˆæ•°æ®ï¼‰ã€‚

```
InnoDBè¡¨ç©ºé—´ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç³»ç»Ÿè¡¨ç©ºé—´              â”‚
â”‚         ibdata1                â”‚ â† å…±äº«è¡¨ç©ºé—´
â”‚    (åŒ…å«æ•°æ®å­—å…¸ã€æ’¤é”€æ—¥å¿—)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ç‹¬ç«‹è¡¨ç©ºé—´              â”‚
â”‚   table1.ibd  table2.ibd      â”‚ â† æ¯è¡¨ä¸€ä¸ªæ–‡ä»¶
â”‚   table3.ibd  table4.ibd      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è¡¨ç©ºé—´é…ç½®


**ğŸ”§ å…³é”®å‚æ•°è®¾ç½®**ï¼š
```ini
[mysqld]
# å¯ç”¨ç‹¬ç«‹è¡¨ç©ºé—´ï¼ˆæ¨èï¼‰
innodb_file_per_table = ON

# ç³»ç»Ÿè¡¨ç©ºé—´å¤§å°
innodb_data_file_path = ibdata1:100M:autoextend

# è¡¨ç©ºé—´è‡ªåŠ¨æ‰©å±•å¢é‡
innodb_autoextend_increment = 64

# è¡¨ç©ºé—´æ”¶ç¼©
innodb_undo_tablespaces = 2
```

### 6.3 è¡¨ç©ºé—´æ•…éšœå¤„ç†


**æ•…éšœ1: è¡¨ç©ºé—´æ–‡ä»¶ç¼ºå¤±**
```sql
-- é”™è¯¯ä¿¡æ¯
ERROR 1812: Table 'test.user' doesn't exist in engine

-- è§£å†³æ–¹æ¡ˆ1: é‡æ–°å¯¼å…¥è¡¨ç©ºé—´
ALTER TABLE user DISCARD TABLESPACE;
-- å¤åˆ¶å¤‡ä»½çš„.ibdæ–‡ä»¶åˆ°æ•°æ®ç›®å½•
ALTER TABLE user IMPORT TABLESPACE;
```

**æ•…éšœ2: è¡¨ç©ºé—´æŸå**
```bash
# æ£€æŸ¥è¡¨ç©ºé—´å®Œæ•´æ€§
innochecksum /var/lib/mysql/dbname/table_name.ibd

# å¦‚æœæŸåï¼Œå°è¯•ä¿®å¤
mysql --execute="SET GLOBAL innodb_force_recovery=1;"
mysqldump dbname table_name > table_backup.sql

# é‡å»ºè¡¨
mysql --execute="DROP TABLE dbname.table_name;"
mysql dbname < table_backup.sql
```

**æ•…éšœ3: è¡¨ç©ºé—´æ»¡**
```sql
-- æŸ¥çœ‹è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT 
  table_schema,
  table_name,
  ROUND(data_length/1024/1024, 2) AS data_mb,
  ROUND(index_length/1024/1024, 2) AS index_mb
FROM information_schema.tables 
WHERE engine = 'InnoDB'
ORDER BY data_length DESC;

-- é‡Šæ”¾ç©ºé—´
OPTIMIZE TABLE table_name;
ALTER TABLE table_name ENGINE=InnoDB;
```

---

## 7. âš™ï¸ å­˜å‚¨å¼•æ“å‚æ•°ä¸æ€§èƒ½é—®é¢˜


### 7.1 InnoDBå…³é”®å‚æ•°


**ğŸ’¡ å‚æ•°å½±å“ç†è§£**ï¼š
å­˜å‚¨å¼•æ“å‚æ•°å°±åƒæ±½è½¦çš„å„ç§è®¾ç½®ï¼Œåˆé€‚çš„è®¾ç½®èƒ½è®©è½¦è·‘å¾—æ›´å¿«æ›´ç¨³ã€‚

**ğŸ”§ æ ¸å¿ƒå‚æ•°é…ç½®**ï¼š
```ini
[mysqld]
# === å†…å­˜ç›¸å…³ ===
# InnoDBç¼“å†²æ± å¤§å°ï¼ˆæ¨èç³»ç»Ÿå†…å­˜çš„70-80%ï¼‰
innodb_buffer_pool_size = 8G

# ç¼“å†²æ± å®ä¾‹æ•°ï¼ˆå¤§å†…å­˜æ—¶è®¾ç½®ï¼‰
innodb_buffer_pool_instances = 8

# === æ—¥å¿—ç›¸å…³ ===
# é‡åšæ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_file_size = 1G

# é‡åšæ—¥å¿—ç¼“å†²åŒºå¤§å°
innodb_log_buffer_size = 64M

# æ—¥å¿—åˆ·ç›˜ç­–ç•¥
innodb_flush_log_at_trx_commit = 1

# === I/Oç›¸å…³ ===
# I/Oçº¿ç¨‹æ•°
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# åˆ·ç›˜æ–¹å¼
innodb_flush_method = O_DIRECT
```

**ğŸ“Š å‚æ•°è°ƒä¼˜æŒ‡å—**ï¼š

| å‚æ•° | **ä½œç”¨** | **æ¨èå€¼** | **è°ƒä¼˜å»ºè®®** |
|-----|---------|-----------|-------------|
| `innodb_buffer_pool_size` | **å†…å­˜ç¼“å†²æ± ** | **å†…å­˜çš„70-80%** | **æ ¹æ®buffer poolå‘½ä¸­ç‡è°ƒæ•´** |
| `innodb_log_file_size` | **é‡åšæ—¥å¿—å¤§å°** | **1-4GB** | **å†™å…¥é‡å¤§æ—¶å¢åŠ ** |
| `innodb_flush_log_at_trx_commit` | **æ—¥å¿—åˆ·ç›˜ç­–ç•¥** | **1ï¼ˆå®‰å…¨ï¼‰** | **é«˜æ€§èƒ½æ—¶è®¾ä¸º2** |
| `innodb_io_capacity` | **I/Oèƒ½åŠ›** | **SSD:2000 HDD:200** | **æ ¹æ®ç£ç›˜æ€§èƒ½è°ƒæ•´** |

### 7.2 MyISAMå‚æ•°ä¼˜åŒ–


```ini
[mysqld]
# === MyISAMä¸“ç”¨å‚æ•° ===
# é”®ç¼“å†²åŒºå¤§å°
key_buffer_size = 256M

# è¡¨ç¼“å­˜å¤§å°
table_open_cache = 2000

# å»¶è¿Ÿå†™å…¥é”®
delay_key_write = ALL

# å¹¶å‘æ’å…¥çº§åˆ«
concurrent_insert = 2

# === æŸ¥è¯¢ç¼“å­˜ ===
query_cache_type = ON
query_cache_size = 128M
query_cache_limit = 2M
```

### 7.3 æ€§èƒ½é—®é¢˜è¯Šæ–­


**ğŸ” æ€§èƒ½ç›‘æ§SQL**ï¼š
```sql
-- æŸ¥çœ‹InnoDBçŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- ç¼“å†²æ± å‘½ä¸­ç‡
SELECT 
  ROUND(
    (1 - (Innodb_buffer_pool_reads / Innodb_buffer_pool_read_requests)) * 100, 2
  ) AS buffer_pool_hit_rate
FROM 
  (SELECT variable_value AS Innodb_buffer_pool_reads 
   FROM performance_schema.global_status 
   WHERE variable_name = 'Innodb_buffer_pool_reads') AS reads,
  (SELECT variable_value AS Innodb_buffer_pool_read_requests 
   FROM performance_schema.global_status 
   WHERE variable_name = 'Innodb_buffer_pool_read_requests') AS requests;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```sql
-- 1. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE your_table;

-- 2. ä¼˜åŒ–è¡¨ç»“æ„
OPTIMIZE TABLE your_table;

-- 3. æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
EXPLAIN SELECT * FROM your_table WHERE condition;

-- 4. æ·»åŠ åˆé€‚ç´¢å¼•
CREATE INDEX idx_column ON your_table(column_name);
```

---

## 8. ğŸ“Š å­˜å‚¨å¼•æ“ç›‘æ§ä¸é¢„é˜²


### 8.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ’¡ ç›‘æ§é‡è¦æ€§**ï¼š
ç›‘æ§å°±åƒä½“æ£€ï¼Œèƒ½åŠæ—©å‘ç°é—®é¢˜ï¼Œé¿å…å°æ¯›ç—…å˜æˆå¤§æ•…éšœã€‚

```
ç›‘æ§å±‚æ¬¡ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®ä¾‹çº§ç›‘æ§             â”‚
â”‚    â€¢ æœåŠ¡çŠ¶æ€                 â”‚
â”‚    â€¢ è¿æ¥æ•°                   â”‚  
â”‚    â€¢ å†…å­˜ä½¿ç”¨                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         å­˜å‚¨å¼•æ“ç›‘æ§           â”‚
â”‚    â€¢ ç¼“å†²æ± çŠ¶æ€               â”‚
â”‚    â€¢ äº‹åŠ¡çŠ¶æ€                 â”‚
â”‚    â€¢ é”ç­‰å¾…                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         è¡¨çº§ç›‘æ§               â”‚
â”‚    â€¢ è¡¨å¤§å°                   â”‚
â”‚    â€¢ ç´¢å¼•æ•ˆç‡                 â”‚
â”‚    â€¢ æŸ¥è¯¢æ€§èƒ½                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å…³é”®ç›‘æ§SQL


**ğŸ” InnoDBç›‘æ§**ï¼š
```sql
-- 1. ç¼“å†²æ± çŠ¶æ€
SELECT 
  pool_id,
  pool_size * $$innodb_page_size / 1024 / 1024 AS pool_size_mb,
  free_buffers * $$innodb_page_size / 1024 / 1024 AS free_mb,
  database_pages * $$innodb_page_size / 1024 / 1024 AS data_mb
FROM information_schema.innodb_buffer_pool_stats;

-- 2. äº‹åŠ¡çŠ¶æ€
SELECT 
  trx_id,
  trx_state,
  trx_started,
  trx_query,
  trx_rows_locked,
  trx_rows_modified
FROM information_schema.innodb_trx;

-- 3. é”ç­‰å¾…
SELECT 
  waiting_trx_id,
  waiting_query,
  blocking_trx_id,
  blocking_query
FROM information_schema.innodb_lock_waits 
JOIN information_schema.innodb_trx 
  ON waiting_trx_id = trx_id;
```

**ğŸ” å­˜å‚¨ç©ºé—´ç›‘æ§**ï¼š
```sql
-- è¡¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
SELECT 
  table_schema AS 'æ•°æ®åº“',
  table_name AS 'è¡¨å',
  engine AS 'å­˜å‚¨å¼•æ“',
  ROUND(data_length/1024/1024, 2) AS 'æ•°æ®å¤§å°(MB)',
  ROUND(index_length/1024/1024, 2) AS 'ç´¢å¼•å¤§å°(MB)',
  ROUND((data_length + index_length)/1024/1024, 2) AS 'æ€»å¤§å°(MB)'
FROM information_schema.tables 
WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys')
ORDER BY (data_length + index_length) DESC;

-- æ•°æ®åº“å¤§å°ç»Ÿè®¡
SELECT 
  table_schema AS 'æ•°æ®åº“',
  COUNT(*) AS 'è¡¨æ•°é‡',
  ROUND(SUM(data_length)/1024/1024, 2) AS 'æ•°æ®å¤§å°(MB)',
  ROUND(SUM(index_length)/1024/1024, 2) AS 'ç´¢å¼•å¤§å°(MB)',
  ROUND(SUM(data_length + index_length)/1024/1024, 2) AS 'æ€»å¤§å°(MB)'
FROM information_schema.tables 
GROUP BY table_schema
ORDER BY SUM(data_length + index_length) DESC;
```

### 8.3 è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬


**ğŸ¤– ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# MySQLå­˜å‚¨å¼•æ“å¥åº·æ£€æŸ¥è„šæœ¬

MYSQL_USER="monitor"
MYSQL_PASS="your_password"
MYSQL_HOST="localhost"
LOG_FILE="/var/log/mysql_health.log"

echo "$(date): å¼€å§‹MySQLå­˜å‚¨å¼•æ“å¥åº·æ£€æŸ¥" >> $LOG_FILE

# 1. æ£€æŸ¥InnoDBçŠ¶æ€
echo "æ£€æŸ¥InnoDBçŠ¶æ€..." >> $LOG_FILE
mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e "
SELECT 
  CASE 
    WHEN $$global.innodb_force_recovery > 0 THEN 'WARNING: InnoDBå¤„äºæ¢å¤æ¨¡å¼'
    ELSE 'OK: InnoDBçŠ¶æ€æ­£å¸¸'
  END AS innodb_status;
" >> $LOG_FILE

# 2. æ£€æŸ¥ç¼“å†²æ± å‘½ä¸­ç‡
echo "æ£€æŸ¥ç¼“å†²æ± å‘½ä¸­ç‡..." >> $LOG_FILE
mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e "
SELECT 
  CONCAT(
    ROUND((1 - Innodb_buffer_pool_reads / Innodb_buffer_pool_read_requests) * 100, 2),
    '%'
  ) AS buffer_pool_hit_rate
FROM 
  (SELECT VARIABLE_VALUE AS Innodb_buffer_pool_reads 
   FROM performance_schema.global_status 
   WHERE VARIABLE_NAME = 'Innodb_buffer_pool_reads') reads,
  (SELECT VARIABLE_VALUE AS Innodb_buffer_pool_read_requests 
   FROM performance_schema.global_status 
   WHERE VARIABLE_NAME = 'Innodb_buffer_pool_read_requests') requests;
" >> $LOG_FILE

# 3. æ£€æŸ¥è¡¨æŸå
echo "æ£€æŸ¥è¡¨å®Œæ•´æ€§..." >> $LOG_FILE
mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST -e "
SELECT CONCAT('CHECK TABLE ', table_schema, '.', table_name, ';') 
FROM information_schema.tables 
WHERE engine IN ('MyISAM', 'InnoDB') 
  AND table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys');
" | mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_HOST >> $LOG_FILE

echo "$(date): MySQLå­˜å‚¨å¼•æ“å¥åº·æ£€æŸ¥å®Œæˆ" >> $LOG_FILE
```

### 8.4 é¢„é˜²æ€§ç»´æŠ¤


**ğŸ›¡ï¸ å®šæœŸç»´æŠ¤ä»»åŠ¡**ï¼š

**æ¯æ—¥ä»»åŠ¡**ï¼š
```bash
# 1. æ£€æŸ¥é”™è¯¯æ—¥å¿—
tail -100 /var/log/mysql/error.log | grep -i "error\|warning"

# 2. ç›‘æ§ç£ç›˜ç©ºé—´
df -h /var/lib/mysql

# 3. æ£€æŸ¥æ…¢æŸ¥è¯¢
mysql -e "SELECT COUNT(*) FROM mysql.slow_log WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 DAY);"
```

**æ¯å‘¨ä»»åŠ¡**ï¼š
```sql
-- 1. è¡¨å®Œæ•´æ€§æ£€æŸ¥
CHECK TABLE important_table1, important_table2;

-- 2. ä¼˜åŒ–è¡¨
OPTIMIZE TABLE log_table;

-- 3. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE user_table, order_table;
```

**æ¯æœˆä»»åŠ¡**ï¼š
```bash
# 1. æ¸…ç†Binary Log
mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"

# 2. å¤‡ä»½é…ç½®æ–‡ä»¶
cp /etc/mysql/my.cnf /backup/my.cnf.$(date +%Y%m%d)

# 3. æ£€æŸ¥è¡¨ç¢ç‰‡
mysql -e "
SELECT 
  table_schema,
  table_name,
  ROUND(data_free/1024/1024, 2) AS data_free_mb
FROM information_schema.tables 
WHERE data_free > 100*1024*1024;
"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å­˜å‚¨å¼•æ“ï¼šMySQLçš„æ•°æ®ç®¡ç†ç»„ä»¶ï¼Œå†³å®šæ•°æ®å­˜å‚¨å’Œæ£€ç´¢æ–¹å¼
ğŸ”¸ InnoDBç‰¹ç‚¹ï¼šæ”¯æŒäº‹åŠ¡ã€è¡Œé”ã€å¤–é”®ï¼Œé€‚åˆOLTPåœºæ™¯
ğŸ”¸ MyISAMç‰¹ç‚¹ï¼šè¡¨é”ã€æŸ¥è¯¢å¿«ã€æ–‡ä»¶ç‹¬ç«‹ï¼Œé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯
ğŸ”¸ äº‹åŠ¡æ—¥å¿—ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æœºåˆ¶
ğŸ”¸ è¡¨ç©ºé—´ï¼šæ•°æ®ç‰©ç†å­˜å‚¨çš„é€»è¾‘æ¦‚å¿µ
```

### 9.2 å…³é”®æ•…éšœå¤„ç†è¦ç‚¹


**ğŸ”¹ InnoDBæ•…éšœå¤„ç†**ï¼š
```
å¯åŠ¨å¤±è´¥ â†’ ä½¿ç”¨innodb_force_recoveryå¼ºåˆ¶å¯åŠ¨ â†’ å¯¼å‡ºæ•°æ® â†’ é‡å»ºå®ä¾‹
è¡¨æŸå â†’ CHECK TABLEæ£€æŸ¥ â†’ REPAIR TABLEä¿®å¤ â†’ é‡å»ºè¡¨
æ­»é” â†’ æŸ¥çœ‹INNODB STATUS â†’ ä¼˜åŒ–äº‹åŠ¡é€»è¾‘ â†’ ç»Ÿä¸€é”å®šé¡ºåº
```

**ğŸ”¹ MyISAMæ•…éšœå¤„ç†**ï¼š
```
è¡¨æŸå â†’ CHECK TABLEæ£€æŸ¥ â†’ REPAIR TABLEåœ¨çº¿ä¿®å¤ â†’ myisamchkç¦»çº¿ä¿®å¤
ç´¢å¼•æŸå â†’ åˆ é™¤.MYIæ–‡ä»¶ â†’ myisamchké‡å»ºç´¢å¼•
```

**ğŸ”¹ å­˜å‚¨å¼•æ“åˆ‡æ¢**ï¼š
```
åœ¨çº¿åˆ‡æ¢ â†’ pt-online-schema-changeå·¥å…·
ç¦»çº¿åˆ‡æ¢ â†’ ALTER TABLE ENGINE=xxx
æ³¨æ„äº‹é¡¹ â†’ ç£ç›˜ç©ºé—´ã€å­—ç¬¦é›†ã€ä¸»é”®è¦æ±‚
```

### 9.3 é¢„é˜²ä¸ç›‘æ§ç­–ç•¥


**ğŸ”¹ å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
- **InnoDBç¼“å†²æ± å‘½ä¸­ç‡**ï¼š>95%ä¸ºä½³
- **äº‹åŠ¡é”ç­‰å¾…**ï¼šé¿å…é•¿æ—¶é—´é”ç­‰å¾…
- **ç£ç›˜ç©ºé—´ä½¿ç”¨**ï¼šä¿æŒå……è¶³å‰©ä½™ç©ºé—´
- **è¡¨å®Œæ•´æ€§**ï¼šå®šæœŸCHECK TABLE

**ğŸ”¹ å‚æ•°ä¼˜åŒ–åŸåˆ™**ï¼š
- **å†…å­˜é…ç½®**ï¼šInnoDBç¼“å†²æ± è®¾ä¸ºå†…å­˜70-80%
- **æ—¥å¿—é…ç½®**ï¼šæ ¹æ®å†™å…¥é‡è°ƒæ•´æ—¥å¿—æ–‡ä»¶å¤§å°
- **I/Oé…ç½®**ï¼šæ ¹æ®ç¡¬ä»¶æ€§èƒ½è°ƒæ•´I/Oå‚æ•°

### 9.4 å®é™…åº”ç”¨ä»·å€¼


- **æ•…éšœé¢„é˜²**ï¼šé€šè¿‡ç›‘æ§å’Œç»´æŠ¤å‡å°‘æ•…éšœå‘ç”Ÿ
- **å¿«é€Ÿæ¢å¤**ï¼šæŒæ¡æ•…éšœå¤„ç†æ–¹æ³•ç¼©çŸ­åœæœºæ—¶é—´
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†é…ç½®å‚æ•°æå‡ç³»ç»Ÿæ€§èƒ½
- **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - å­˜å‚¨å¼•æ“æ•…éšœè¦åˆ†ç±»å¤„ç†ï¼šInnoDBçœ‹æ—¥å¿—ï¼ŒMyISAMä¿®æ–‡ä»¶
> - é¢„é˜²èƒœäºæ²»ç–—ï¼šå®šæœŸç›‘æ§ã€åŠæ—¶ç»´æŠ¤ã€å‚æ•°ä¼˜åŒ–
> - æ•…éšœå¤„ç†ä¸‰æ­¥éª¤ï¼šå…ˆå¤‡ä»½ã€å†ä¿®å¤ã€åéªŒè¯
> - åˆ‡æ¢å¼•æ“éœ€è°¨æ…ï¼šè¯„ä¼°é£é™©ã€å……è¶³ç©ºé—´ã€å®Œæ•´æµ‹è¯•