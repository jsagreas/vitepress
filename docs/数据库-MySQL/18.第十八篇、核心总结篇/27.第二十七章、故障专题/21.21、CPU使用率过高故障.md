---
title: 21ã€CPUä½¿ç”¨ç‡è¿‡é«˜æ•…éšœ
---
## ğŸ“š ç›®å½•

1. [é«˜CPUä½¿ç”¨ç‡è¯Šæ–­æ–¹æ³•](#1-é«˜CPUä½¿ç”¨ç‡è¯Šæ–­æ–¹æ³•)
2. [æ…¢æŸ¥è¯¢CPUæ¶ˆè€—åˆ†æ](#2-æ…¢æŸ¥è¯¢CPUæ¶ˆè€—åˆ†æ)
3. [å¹¶å‘è¿æ¥è¿‡å¤šé—®é¢˜](#3-å¹¶å‘è¿æ¥è¿‡å¤šé—®é¢˜)
4. [é”äº‰ç”¨å¯¼è‡´CPUé«˜](#4-é”äº‰ç”¨å¯¼è‡´CPUé«˜)
5. [æŸ¥è¯¢ä¼˜åŒ–å»ºè®®](#5-æŸ¥è¯¢ä¼˜åŒ–å»ºè®®)
6. [ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–](#6-ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–)
7. [å¹¶å‘æ§åˆ¶ç­–ç•¥](#7-å¹¶å‘æ§åˆ¶ç­–ç•¥)
8. [CPUæ€§èƒ½ç›‘æ§](#8-CPUæ€§èƒ½ç›‘æ§)
9. [è´Ÿè½½å‡è¡¡ä¼˜åŒ–](#9-è´Ÿè½½å‡è¡¡ä¼˜åŒ–)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” é«˜CPUä½¿ç”¨ç‡è¯Šæ–­æ–¹æ³•


### 1.1 CPUä½¿ç”¨ç‡è¿‡é«˜çš„ç—‡çŠ¶è¯†åˆ«

ğŸ¯ **ç®€å•ç†è§£**ï¼šMySQLçš„CPUå°±åƒé¤å…çš„å¨å¸ˆ

```
æ­£å¸¸æƒ…å†µï¼šå¨å¸ˆæœ‰æ¡ä¸ç´Šåœ°åšèœï¼Œæ•ˆç‡å¾ˆé«˜
CPUè¿‡é«˜ï¼šå¨å¸ˆå¿™å¾—å›¢å›¢è½¬ï¼Œä½†èœå“è´¨é‡ä¸‹é™ï¼Œå®¢äººç­‰å¾…æ—¶é—´å˜é•¿

MySQL CPUè¿‡é«˜çš„å…¸å‹è¡¨ç°ï¼š
1. æŸ¥è¯¢å“åº”å˜æ…¢
2. è¿æ¥ç­‰å¾…æ—¶é—´å¢åŠ 
3. ç³»ç»Ÿæ•´ä½“æ€§èƒ½ä¸‹é™
4. å…¶ä»–åº”ç”¨å—åˆ°å½±å“
```

**ğŸ”¸ å¿«é€Ÿè¯†åˆ«CPUé—®é¢˜çš„æ–¹æ³•**
```bash
# 1. ç³»ç»Ÿçº§CPUä½¿ç”¨ç‡æ£€æŸ¥
top -p $(pgrep mysqld)
# è§‚å¯Ÿï¼š%CPUåˆ—ï¼Œæ­£å¸¸åº”è¯¥<80%

# 2. MySQLè¿›ç¨‹è¯¦ç»†ä¿¡æ¯
ps aux | grep mysqld
# å…³æ³¨ï¼šCPUä½¿ç”¨ç™¾åˆ†æ¯”

# 3. ç³»ç»Ÿå¹³å‡è´Ÿè½½
uptime
# load averageåº”è¯¥<CPUæ ¸å¿ƒæ•°

# 4. CPUä½¿ç”¨ç‡å†å²è¶‹åŠ¿
sar -u 1 10  # æ¯ç§’é‡‡æ ·ï¼Œè¿ç»­10æ¬¡
```

### 1.2 å¿«é€Ÿå®šä½é—®é¢˜çš„è¯Šæ–­æµç¨‹

**ğŸ“‹ ç³»ç»Ÿæ€§è¯Šæ–­æ­¥éª¤**

```
è¯Šæ–­æµç¨‹å›¾ï¼š
é—®é¢˜å‘ç° â†’ ç³»ç»Ÿå±‚é¢åˆ†æ â†’ MySQLå±‚é¢åˆ†æ â†’ å…·ä½“æŸ¥è¯¢åˆ†æ
    â†“            â†“             â†“              â†“
CPUä½¿ç”¨ç‡é«˜   è¿›ç¨‹çŠ¶æ€æ£€æŸ¥   è¿æ¥æ•°æ£€æŸ¥     æ…¢æŸ¥è¯¢åˆ†æ
```

**ğŸ”§ åˆ†å±‚è¯Šæ–­å‘½ä»¤**
```sql
-- MySQLå±‚é¢çš„å¿«é€Ÿè¯Šæ–­

-- 1. å½“å‰è¿æ¥çŠ¶æ€
SHOW PROCESSLIST;
-- é‡ç‚¹å…³æ³¨ï¼šStateåˆ—çš„çŠ¶æ€ï¼ŒTimeåˆ—çš„æ‰§è¡Œæ—¶é—´

-- 2. å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢
SELECT * FROM information_schema.processlist 
WHERE command != 'Sleep' AND time > 5
ORDER BY time DESC;

-- 3. æœåŠ¡å™¨çŠ¶æ€æ¦‚è§ˆ
SHOW STATUS LIKE 'Threads_%';
-- Threads_connected: å½“å‰è¿æ¥æ•°
-- Threads_running: æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æ•°

-- 4. æŸ¥è¯¢æ‰§è¡Œç»Ÿè®¡
SHOW STATUS LIKE 'Com_select';
SHOW STATUS LIKE 'Questions';
```

### 1.3 CPUä½¿ç”¨æ¨¡å¼åˆ†æ

**ğŸ“Š ä¸åŒç±»å‹çš„CPUæ¶ˆè€—ç‰¹å¾**

```
CPUæ¶ˆè€—æ¨¡å¼è¯†åˆ«ï¼š

1. æŒç»­é«˜CPU (>90%)
   ç‰¹å¾ï¼šé•¿æ—¶é—´ä¿æŒé«˜ä½¿ç”¨ç‡
   å¯èƒ½åŸå› ï¼šå¤æ‚æŸ¥è¯¢ã€ç¼ºå¤±ç´¢å¼•ã€é”ç­‰å¾…

2. æ³¢åŠ¨æ€§é«˜CPU (50%-90%é—´è·³åŠ¨)
   ç‰¹å¾ï¼šå‘¨æœŸæ€§ä¸Šå‡ä¸‹é™
   å¯èƒ½åŸå› ï¼šå®šæ—¶ä»»åŠ¡ã€æ‰¹å¤„ç†ä½œä¸š

3. çªå‘æ€§é«˜CPU (ç¬é—´100%)
   ç‰¹å¾ï¼šçŸ­æ—¶é—´å†²é«˜åå›è½
   å¯èƒ½åŸå› ï¼šå¹¶å‘çªå¢ã€ç¼“å­˜å¤±æ•ˆ

4. æ¸è¿›æ€§ä¸Šå‡CPU
   ç‰¹å¾ï¼šä½¿ç”¨ç‡é€æ­¥æ”€å‡
   å¯èƒ½åŸå› ï¼šæ•°æ®é‡å¢é•¿ã€ç´¢å¼•ç¢ç‰‡åŒ–
```

**ğŸ’¡ æ¨¡å¼å¯¹åº”çš„å¤„ç†ç­–ç•¥**
```
æŒç»­é«˜CPU â†’ é‡ç‚¹æ£€æŸ¥æ…¢æŸ¥è¯¢å’Œç´¢å¼•
æ³¢åŠ¨æ€§é«˜CPU â†’ æ£€æŸ¥å®šæ—¶ä»»åŠ¡å’Œæ‰¹å¤„ç†
çªå‘æ€§é«˜CPU â†’ åˆ†æå¹¶å‘æ§åˆ¶å’Œè¿æ¥æ± 
æ¸è¿›æ€§ä¸Šå‡ â†’ è€ƒè™‘ç»´æŠ¤çª—å£å’Œå®¹é‡è§„åˆ’
```

---

## 2. ğŸŒ æ…¢æŸ¥è¯¢CPUæ¶ˆè€—åˆ†æ


### 2.1 æ…¢æŸ¥è¯¢è¯†åˆ«ä¸åˆ†æ

**ğŸ¯ ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢é€ æˆçš„CPUæ¶ˆè€—**

```
å½¢è±¡ç†è§£ï¼š
æ™®é€šæŸ¥è¯¢å°±åƒèµ°æ¥¼æ¢¯ - ä¸€æ­¥æ­¥æœ‰åºè¿›è¡Œ
æ…¢æŸ¥è¯¢å°±åƒæ¬å®¶å…· - éœ€è¦å¤§é‡ä½“åŠ›ï¼ˆCPUï¼‰ä¸”è€—æ—¶å¾ˆé•¿

æ…¢æŸ¥è¯¢å¯¹CPUçš„å½±å“ï¼š
1. é•¿æ—¶é—´å ç”¨CPUèµ„æº
2. é˜»å¡å…¶ä»–æŸ¥è¯¢çš„æ‰§è¡Œ
3. å¯¼è‡´è¿æ¥æ•°ç§¯å‹
4. å¼•å‘é”ç­‰å¾…é“¾æ¡
```

**ğŸ”§ æ…¢æŸ¥è¯¢æ—¥å¿—é…ç½®ä¸åˆ†æ**
```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';
SET GLOBAL long_query_time = 2;  -- è¶…è¿‡2ç§’çš„æŸ¥è¯¢è®°å½•
SET GLOBAL log_queries_not_using_indexes = 'ON';  -- è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢çŠ¶æ€
SHOW VARIABLES LIKE 'slow_query%';
SHOW STATUS LIKE 'Slow_queries';
```

**ğŸ“Š æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·**
```bash
# ä½¿ç”¨mysqldumpslowåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
mysqldumpslow -s c -t 10 /var/log/mysql/slow.log
# -s c: æŒ‰æŸ¥è¯¢æ¬¡æ•°æ’åº
# -t 10: æ˜¾ç¤ºå‰10æ¡

# åˆ†æè¾“å‡ºç¤ºä¾‹ï¼š
# Count: 152  Time=5.23s (793s)  Lock=0.00s (0s)  Rows=1.0 (152), user[database]
# SELECT * FROM orders WHERE status = 'N' ORDER BY create_time;

# å…³é”®æŒ‡æ ‡è§£è¯»ï¼š
# Count: æ‰§è¡Œæ¬¡æ•° (152æ¬¡)
# Time: å¹³å‡æ‰§è¡Œæ—¶é—´ (5.23ç§’)
# Total: æ€»æ¶ˆè€—æ—¶é—´ (793ç§’)
# Lock: é”ç­‰å¾…æ—¶é—´
# Rows: å¹³å‡è¿”å›è¡Œæ•°
```

### 2.2 é«˜CPUæ¶ˆè€—æŸ¥è¯¢çš„ç‰¹å¾

**ğŸ” å…¸å‹çš„CPUå¯†é›†å‹æŸ¥è¯¢æ¨¡å¼**

```sql
-- 1. å…¨è¡¨æ‰«ææŸ¥è¯¢
SELECT * FROM large_table WHERE non_indexed_column = 'value';
-- é—®é¢˜ï¼šéœ€è¦æ£€æŸ¥æ¯ä¸€è¡Œæ•°æ®

-- 2. å¤æ‚JOINæŸ¥è¯¢
SELECT * FROM table1 t1
JOIN table2 t2 ON t1.id = t2.foreign_id
JOIN table3 t3 ON t2.id = t3.another_id
WHERE t1.status = 'active';
-- é—®é¢˜ï¼šå¤šè¡¨å…³è”è®¡ç®—é‡å¤§

-- 3. æ’åºå¤§é‡æ•°æ®
SELECT * FROM orders ORDER BY create_time LIMIT 10;
-- é—®é¢˜ï¼šå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œéœ€è¦å…¨è¡¨æ’åº

-- 4. èšåˆè®¡ç®—æŸ¥è¯¢
SELECT category, COUNT(*), AVG(price), SUM(amount)
FROM products
GROUP BY category;
-- é—®é¢˜ï¼šéœ€è¦å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œåˆ†ç»„è®¡ç®—
```

### 2.3 å®æ—¶æ…¢æŸ¥è¯¢ç›‘æ§

**ğŸ“Š å®æ—¶å‘ç°CPUæ¶ˆè€—å¤§çš„æŸ¥è¯¢**

```sql
-- æŸ¥æ‰¾å½“å‰æ‰§è¡Œæ—¶é—´è¶…è¿‡5ç§’çš„æŸ¥è¯¢
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    LEFT(info, 100) as query_snippet
FROM information_schema.processlist 
WHERE time > 5 
    AND command != 'Sleep'
ORDER BY time DESC;

-- æŸ¥æ‰¾CPUä½¿ç”¨ç‡é«˜çš„æŸ¥è¯¢ï¼ˆéœ€è¦performance_schemaï¼‰
SELECT 
    thread_id,
    event_name,
    current_allocated,
    current_avg_alloc,
    current_max_alloc
FROM performance_schema.memory_summary_by_thread_by_event_name
WHERE current_allocated > 1024*1024*10  -- è¶…è¿‡10MBå†…å­˜ä½¿ç”¨
ORDER BY current_allocated DESC;
```

**âš¡ ç´§æ€¥å¤„ç†æ…¢æŸ¥è¯¢**
```sql
-- ç»ˆæ­¢ç‰¹å®šçš„æ…¢æŸ¥è¯¢
KILL QUERY 12345;  -- 12345æ˜¯è¿›ç¨‹ID

-- æ‰¹é‡ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
-- æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…ä½¿ç”¨
SELECT CONCAT('KILL QUERY ', id, ';') as kill_stmt
FROM information_schema.processlist 
WHERE time > 300  -- è¶…è¿‡5åˆ†é’Ÿ
    AND command != 'Sleep'
    AND user != 'replication_user';  -- æ’é™¤å¤åˆ¶ç”¨æˆ·
```

---

## 3. ğŸ”— å¹¶å‘è¿æ¥è¿‡å¤šé—®é¢˜


### 3.1 è¿æ¥æ•°è¿‡å¤šçš„å½±å“æœºåˆ¶

**ğŸ¯ è¿æ¥å°±åƒé¤å…çš„åº§ä½**

```
é¤å…ç±»æ¯”ï¼š
æ­£å¸¸æƒ…å†µï¼šå®¢äººæ•°é‡é€‚ä¸­ï¼ŒæœåŠ¡å‘˜èƒ½ç…§é¡¾åˆ°æ¯ä¸ªå®¢äºº
è¿æ¥è¿‡å¤šï¼šå®¢äººå¤ªå¤šï¼ŒæœåŠ¡å‘˜å¿™ä¸è¿‡æ¥ï¼ŒæœåŠ¡è´¨é‡ä¸‹é™

MySQLè¿æ¥è¿‡å¤šçš„é—®é¢˜ï¼š
1. æ¯ä¸ªè¿æ¥æ¶ˆè€—å†…å­˜èµ„æº
2. çº¿ç¨‹åˆ‡æ¢å¼€é”€å¢å¤§
3. é”ç«äº‰åŠ å‰§
4. CPUåœ¨çº¿ç¨‹è°ƒåº¦ä¸ŠèŠ±è´¹è¿‡å¤šæ—¶é—´
```

**ğŸ“Š è¿æ¥æ•°ç›‘æ§æŒ‡æ ‡**
```sql
-- æŸ¥çœ‹å½“å‰è¿æ¥ç›¸å…³çŠ¶æ€
SHOW STATUS LIKE 'Threads_%';
-- Threads_connected: å½“å‰è¿æ¥æ•°
-- Threads_running: æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°
-- Threads_cached: çº¿ç¨‹ç¼“å­˜ä¸­çš„çº¿ç¨‹æ•°

SHOW STATUS LIKE 'Max_used_connections';
-- å†å²æœ€å¤§è¿æ¥æ•°

SHOW STATUS LIKE 'Connection%';
-- Connections: æ€»è¿æ¥æ¬¡æ•°
-- Connection_errors_%: å„ç§è¿æ¥é”™è¯¯

SHOW VARIABLES LIKE 'max_connections';
-- æœ€å¤§å…è®¸è¿æ¥æ•°é…ç½®
```

### 3.2 è¿æ¥æ± é…ç½®ä¼˜åŒ–

**ğŸ”§ åˆç†çš„è¿æ¥ç®¡ç†ç­–ç•¥**

```sql
-- è¿æ¥ç›¸å…³å‚æ•°ä¼˜åŒ–
SET GLOBAL max_connections = 200;          -- æœ€å¤§è¿æ¥æ•°
SET GLOBAL max_user_connections = 50;      -- å•ç”¨æˆ·æœ€å¤§è¿æ¥æ•°
SET GLOBAL interactive_timeout = 300;      -- äº¤äº’å¼è¿æ¥è¶…æ—¶(5åˆ†é’Ÿ)
SET GLOBAL wait_timeout = 600;             -- éäº¤äº’å¼è¿æ¥è¶…æ—¶(10åˆ†é’Ÿ)
SET GLOBAL connect_timeout = 10;           -- è¿æ¥å»ºç«‹è¶…æ—¶æ—¶é—´

-- çº¿ç¨‹æ± ç›¸å…³é…ç½®
SET GLOBAL thread_cache_size = 16;         -- çº¿ç¨‹ç¼“å­˜å¤§å°
SET GLOBAL thread_pool_size = 8;           -- çº¿ç¨‹æ± å¤§å°(å¦‚æœå¯ç”¨)
```

**ğŸ’¡ åº”ç”¨å±‚è¿æ¥æ± é…ç½®å»ºè®®**
```
è¿æ¥æ± æœ€ä½³å®è·µï¼š

1. åˆå§‹è¿æ¥æ•°è®¾ç½®
   åˆå§‹è¿æ¥æ•° = CPUæ ¸å¿ƒæ•° * 2
   ä¾‹å¦‚ï¼š8æ ¸CPUï¼Œè®¾ç½®åˆå§‹è¿æ¥16ä¸ª

2. æœ€å¤§è¿æ¥æ•°è®¾ç½®
   æœ€å¤§è¿æ¥æ•° = CPUæ ¸å¿ƒæ•° * 4
   ä¾‹å¦‚ï¼š8æ ¸CPUï¼Œæœ€å¤§è¿æ¥32ä¸ª

3. è¿æ¥è¶…æ—¶è®¾ç½®
   è·å–è¿æ¥è¶…æ—¶ï¼š3-5ç§’
   è¿æ¥ç©ºé—²è¶…æ—¶ï¼š30åˆ†é’Ÿ
   è¿æ¥ç”Ÿå­˜æ—¶é—´ï¼š2-4å°æ—¶

4. è¿æ¥éªŒè¯
   å¯ç”¨è¿æ¥æœ‰æ•ˆæ€§æ£€æŸ¥
   è®¾ç½®åˆé€‚çš„éªŒè¯æŸ¥è¯¢ï¼ˆå¦‚SELECT 1ï¼‰
```

### 3.3 è¿æ¥æ•°å¼‚å¸¸æ’æŸ¥

**ğŸš¨ å®šä½è¿æ¥æ•°è¿‡å¤šçš„æ ¹æœ¬åŸå› **

```sql
-- åˆ†æè¿æ¥æ¥æºåˆ†å¸ƒ
SELECT 
    substring_index(host, ':', 1) as client_ip,
    user,
    db,
    COUNT(*) as connection_count
FROM information_schema.processlist
GROUP BY client_ip, user, db
ORDER BY connection_count DESC;

-- æŸ¥çœ‹é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥
SELECT 
    id,
    user,
    host,
    db,
    command,
    time,
    state
FROM information_schema.processlist 
WHERE command = 'Sleep' 
    AND time > 1800  -- ç©ºé—²è¶…è¿‡30åˆ†é’Ÿ
ORDER BY time DESC;

-- åˆ†æè¿æ¥çŠ¶æ€åˆ†å¸ƒ
SELECT 
    state,
    COUNT(*) as connection_count
FROM information_schema.processlist
GROUP BY state
ORDER BY connection_count DESC;
```

**ğŸ”§ è¿æ¥æ¸…ç†ç­–ç•¥**
```bash
#!/bin/bash
# è¿æ¥æ¸…ç†è„šæœ¬

# 1. æ¸…ç†é•¿æ—¶é—´ç©ºé—²è¿æ¥
mysql -e "
SELECT CONCAT('KILL ', id, ';') as kill_stmt
FROM information_schema.processlist 
WHERE command = 'Sleep' 
    AND time > 3600  -- ç©ºé—²è¶…è¿‡1å°æ—¶
    AND user NOT IN ('replication_user', 'monitor_user')
" | grep -v kill_stmt | mysql

# 2. æ¸…ç†å¼‚å¸¸çŠ¶æ€è¿æ¥
mysql -e "
SELECT CONCAT('KILL ', id, ';') as kill_stmt
FROM information_schema.processlist 
WHERE state IN ('Locked', 'Waiting for table level lock')
    AND time > 300  -- ç­‰å¾…è¶…è¿‡5åˆ†é’Ÿ
" | grep -v kill_stmt | mysql
```

---

## 4. ğŸ”’ é”äº‰ç”¨å¯¼è‡´CPUé«˜


### 4.1 é”äº‰ç”¨çš„CPUæ¶ˆè€—æœºåˆ¶

**ğŸ¯ é”äº‰ç”¨å°±åƒäº¤é€šå µå¡**

```
äº¤é€šç±»æ¯”ï¼š
æ­£å¸¸æƒ…å†µï¼šè½¦è¾†æœ‰åºé€šè¡Œï¼Œé“è·¯ç•…é€š
é”äº‰ç”¨ï¼šå¤šè¾†è½¦äº‰æŠ¢åŒä¸€ä¸ªè½¦é“ï¼Œé€ æˆæ‹¥å µï¼Œå¤§å®¶éƒ½åœ¨ç©ºè½¬

MySQLé”äº‰ç”¨å¯¹CPUçš„å½±å“ï¼š
1. ç­‰å¾…é”çš„çº¿ç¨‹ä¸æ–­æ£€æŸ¥é”çŠ¶æ€
2. é”æŒæœ‰è€…å¤„ç†é€Ÿåº¦å˜æ…¢
3. é”ç­‰å¾…é˜Ÿåˆ—ç®¡ç†æ¶ˆè€—CPU
4. æ­»é”æ£€æµ‹ç®—æ³•é¢‘ç¹è¿è¡Œ
```

**ğŸ” é”äº‰ç”¨çš„è¯†åˆ«æ–¹æ³•**
```sql
-- æŸ¥çœ‹å½“å‰é”ç­‰å¾…æƒ…å†µ
SHOW ENGINE INNODB STATUS\G

-- é‡ç‚¹å…³æ³¨ä»¥ä¸‹éƒ¨åˆ†ï¼š
-- TRANSACTIONSéƒ¨åˆ†ï¼šæ˜¾ç¤ºå½“å‰æ´»è·ƒäº‹åŠ¡
-- LATEST DETECTED DEADLOCKï¼šæœ€è¿‘çš„æ­»é”ä¿¡æ¯
-- BUFFER POOL AND MEMORYï¼šå†…å­˜ä½¿ç”¨æƒ…å†µ

-- ä½¿ç”¨performance_schemaæŸ¥çœ‹é”ç­‰å¾…
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread,
    b.trx_query blocking_query
FROM information_schema.innodb_lock_waits w
JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id
JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id;
```

### 4.2 å¸¸è§çš„é”äº‰ç”¨åœºæ™¯

**ğŸ“Š å…¸å‹é”äº‰ç”¨æ¨¡å¼åˆ†æ**

```sql
-- 1. è¡¨çº§é”äº‰ç”¨
-- åœºæ™¯ï¼šå¤§é‡SELECTå’ŒALTER TABLEåŒæ—¶æ‰§è¡Œ
SHOW OPEN TABLES WHERE in_use > 0;

-- 2. è¡Œçº§é”äº‰ç”¨
-- åœºæ™¯ï¼šå¤šä¸ªäº‹åŠ¡ä¿®æ”¹åŒä¸€è¡Œæ•°æ®
SELECT 
    lock_type,
    lock_mode,
    lock_status,
    lock_data,
    INDEX_NAME
FROM performance_schema.data_locks
WHERE OBJECT_NAME = 'your_table_name';

-- 3. æ„å‘é”å†²çª
-- åœºæ™¯ï¼šSELECT...FOR UPDATEå’ŒDDLæ“ä½œå†²çª
SELECT 
    object_schema,
    object_name,
    lock_type,
    lock_duration,
    lock_status
FROM performance_schema.metadata_locks
WHERE object_type = 'TABLE';
```

**âš ï¸ é«˜é£é™©é”äº‰ç”¨SQLæ¨¡å¼**
```sql
-- å±é™©æ¨¡å¼1ï¼šé•¿äº‹åŠ¡ä¸­çš„UPDATE
BEGIN;
UPDATE large_table SET status = 'processed' WHERE condition;
-- å¦‚æœè¿™é‡Œæœ‰å…¶ä»–è€—æ—¶æ“ä½œï¼Œä¼šé•¿æ—¶é—´æŒé”
-- ... å…¶ä»–æ“ä½œ
COMMIT;

-- å±é™©æ¨¡å¼2ï¼šSELECT FOR UPDATEå¤§èŒƒå›´é”å®š
SELECT * FROM orders 
WHERE status = 'pending' 
    AND create_time > '2024-01-01'
FOR UPDATE;  -- å¯èƒ½é”å®šå¤§é‡è¡Œ

-- å±é™©æ¨¡å¼3ï¼šæ— ç´¢å¼•æ¡ä»¶çš„UPDATE
UPDATE products SET price = price * 1.1 
WHERE category = 'electronics';  -- å¦‚æœcategoryæ²¡æœ‰ç´¢å¼•ï¼Œä¼šé”è¡¨
```

### 4.3 é”äº‰ç”¨ä¼˜åŒ–ç­–ç•¥

**ğŸ”§ å‡å°‘é”äº‰ç”¨çš„æŠ€æœ¯æ‰‹æ®µ**

```sql
-- 1. ä¼˜åŒ–äº‹åŠ¡å¤§å°
-- åŸåˆ™ï¼šäº‹åŠ¡è¶Šå°ï¼Œé”æŒæœ‰æ—¶é—´è¶ŠçŸ­

-- ä¸å¥½çš„åšæ³•ï¼š
BEGIN;
UPDATE table1 SET col1 = val1 WHERE id = 1;
-- ä¸­é—´æœ‰å…¶ä»–è€—æ—¶æ“ä½œ
SELECT * FROM other_table WHERE complex_condition;
UPDATE table2 SET col2 = val2 WHERE id = 2;
COMMIT;

-- å¥½çš„åšæ³•ï¼š
-- åˆ†è§£ä¸ºå¤šä¸ªå°äº‹åŠ¡
UPDATE table1 SET col1 = val1 WHERE id = 1;
UPDATE table2 SET col2 = val2 WHERE id = 2;

-- 2. ä¼˜åŒ–è®¿é—®é¡ºåº
-- åŸåˆ™ï¼šå§‹ç»ˆæŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æºï¼Œé¿å…æ­»é”

-- ä¸å¥½çš„åšæ³•ï¼ˆå¯èƒ½æ­»é”ï¼‰ï¼š
-- äº‹åŠ¡A: é”å®šè®¢å•1ï¼Œç„¶åé”å®šè®¢å•2
-- äº‹åŠ¡B: é”å®šè®¢å•2ï¼Œç„¶åé”å®šè®¢å•1

-- å¥½çš„åšæ³•ï¼š
-- æ‰€æœ‰äº‹åŠ¡éƒ½æŒ‰IDå‡åºè®¿é—®
UPDATE orders SET status = 'confirmed' 
WHERE id IN (1, 2) 
ORDER BY id;  -- å…³é”®ï¼šORDER BYç¡®ä¿é¡ºåº

-- 3. ä½¿ç”¨é€‚å½“çš„éš”ç¦»çº§åˆ«
-- å¯¹äºä¸éœ€è¦å¼ºä¸€è‡´æ€§çš„æŸ¥è¯¢ï¼Œé™ä½éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

---

## 5. âš¡ æŸ¥è¯¢ä¼˜åŒ–å»ºè®®


### 5.1 SQLæŸ¥è¯¢ä¼˜åŒ–åŸºæœ¬åŸåˆ™

**ğŸ¯ æŸ¥è¯¢ä¼˜åŒ–å°±åƒä¼˜åŒ–å‡ºè¡Œè·¯çº¿**

```
è·¯çº¿ç±»æ¯”ï¼š
åŸå§‹è·¯çº¿ï¼šç»•è¿œè·¯ï¼Œç»è¿‡æ‹¥å µè·¯æ®µï¼Œè€—æ—¶è€—æ²¹
ä¼˜åŒ–è·¯çº¿ï¼šèµ°ç›´è·¯ï¼Œé¿å¼€é«˜å³°ï¼Œå¿«é€Ÿåˆ°è¾¾

SQLä¼˜åŒ–çš„æ ¸å¿ƒç›®æ ‡ï¼š
1. å‡å°‘æ•°æ®è¯»å–é‡
2. é¿å…ä¸å¿…è¦çš„è®¡ç®—
3. åˆ©ç”¨ç´¢å¼•å¿«é€Ÿå®šä½
4. å‡å°‘ä¸´æ—¶è¡¨å’Œæ–‡ä»¶æ’åº
```

**ğŸ“‹ æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•**
```
ğŸ”¸ SELECTè¯­å¥ä¼˜åŒ–ï¼š
âœ… é¿å…SELECT * - åªé€‰æ‹©éœ€è¦çš„åˆ—
âœ… ä½¿ç”¨LIMITé™åˆ¶è¿”å›è¡Œæ•°
âœ… åœ¨WHEREæ¡ä»¶ä¸­ä½¿ç”¨ç´¢å¼•åˆ—
âœ… é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°

ğŸ”¸ JOINä¼˜åŒ–ï¼š
âœ… ç¡®ä¿å…³è”æ¡ä»¶æœ‰ç´¢å¼•
âœ… å°è¡¨åœ¨å‰ï¼Œå¤§è¡¨åœ¨å
âœ… é¿å…ä¸å¿…è¦çš„å…³è”
âœ… è€ƒè™‘ä½¿ç”¨EXISTSæ›¿ä»£IN

ğŸ”¸ å­æŸ¥è¯¢ä¼˜åŒ–ï¼š
âœ… è€ƒè™‘æ”¹å†™ä¸ºJOIN
âœ… ä½¿ç”¨EXISTSä»£æ›¿INå­æŸ¥è¯¢
âœ… é¿å…ç›¸å…³å­æŸ¥è¯¢
```

### 5.2 EXPLAINæ‰§è¡Œè®¡åˆ’åˆ†æ

**ğŸ” è¯»æ‡‚æŸ¥è¯¢çš„"ä½“æ£€æŠ¥å‘Š"**

```sql
-- ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢
EXPLAIN SELECT * FROM orders o
JOIN customers c ON o.customer_id = c.id
WHERE o.status = 'pending'
    AND c.city = 'Beijing'
ORDER BY o.create_time DESC
LIMIT 10;

-- å…³é”®å­—æ®µè§£è¯»ï¼š
-- id: æŸ¥è¯¢åºåˆ—å·
-- select_type: æŸ¥è¯¢ç±»å‹ï¼ˆSIMPLEã€SUBQUERYç­‰ï¼‰
-- table: æ¶‰åŠçš„è¡¨
-- type: è¿æ¥ç±»å‹ï¼ˆæ€§èƒ½ä»å¥½åˆ°åï¼šsystem > const > eq_ref > ref > range > index > ALLï¼‰
-- possible_keys: å¯èƒ½ä½¿ç”¨çš„ç´¢å¼•
-- key: å®é™…ä½¿ç”¨çš„ç´¢å¼•  
-- key_len: ç´¢å¼•é•¿åº¦
-- ref: ç´¢å¼•å‚è€ƒ
-- rows: æ‰«æè¡Œæ•°ä¼°è®¡
-- Extra: é¢å¤–ä¿¡æ¯
```

**ğŸ“Š æ‰§è¡Œè®¡åˆ’çš„æ€§èƒ½è­¦ç¤º**
```
ğŸš¨ æ€§èƒ½çº¢è‰²è­¦å‘Šï¼š
- type = ALL (å…¨è¡¨æ‰«æ)
- type = index (ç´¢å¼•å…¨æ‰«æ)
- ExtraåŒ…å«"Using filesort"
- ExtraåŒ…å«"Using temporary"
- rowsæ•°å€¼å¾ˆå¤§

ğŸŸ¡ æ€§èƒ½é»„è‰²è­¦å‘Šï¼š
- type = rangeä½†rowså¾ˆå¤§
- keyä¸ºNULLï¼ˆæœªä½¿ç”¨ç´¢å¼•ï¼‰
- ExtraåŒ…å«"Using where"

ğŸŸ¢ æ€§èƒ½ç»¿è‰²è‰¯å¥½ï¼š
- type = const, eq_ref, ref
- keyæ˜¾ç¤ºä½¿ç”¨äº†åˆé€‚ç´¢å¼•
- rowsæ•°å€¼è¾ƒå°
- Extraæ˜¾ç¤º"Using index"ï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
```

### 5.3 å¸¸è§æŸ¥è¯¢æ€§èƒ½é—®é¢˜

**ğŸ”§ å…¸å‹é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

```sql
-- é—®é¢˜1ï¼šå‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
-- é”™è¯¯å†™æ³•ï¼š
SELECT * FROM orders WHERE YEAR(create_time) = 2024;

-- æ­£ç¡®å†™æ³•ï¼š
SELECT * FROM orders 
WHERE create_time >= '2024-01-01' 
    AND create_time < '2025-01-01';

-- é—®é¢˜2ï¼šLIKEå‰ç¼€é€šé…ç¬¦
-- é”™è¯¯å†™æ³•ï¼š
SELECT * FROM products WHERE name LIKE '%phone%';

-- æ­£ç¡®å†™æ³•ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼š
SELECT * FROM products WHERE name LIKE 'phone%';
-- æˆ–è€…ä½¿ç”¨å…¨æ–‡ç´¢å¼•ï¼š
SELECT * FROM products WHERE MATCH(name) AGAINST('phone');

-- é—®é¢˜3ï¼šORæ¡ä»¶ä¼˜åŒ–
-- ä½æ•ˆå†™æ³•ï¼š
SELECT * FROM users WHERE status = 'active' OR status = 'pending';

-- é«˜æ•ˆå†™æ³•ï¼š
SELECT * FROM users WHERE status IN ('active', 'pending');
-- æˆ–è€…åˆ†åˆ«æŸ¥è¯¢åUNIONï¼š
SELECT * FROM users WHERE status = 'active'
UNION
SELECT * FROM users WHERE status = 'pending';

-- é—®é¢˜4ï¼šå¤§OFFSETåˆ†é¡µ
-- ä½æ•ˆå†™æ³•ï¼š
SELECT * FROM orders ORDER BY id LIMIT 100000, 20;

-- é«˜æ•ˆå†™æ³•ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰ï¼š
SELECT * FROM orders WHERE id > 100000 ORDER BY id LIMIT 20;
```

---

## 6. ğŸ—‚ï¸ ç´¢å¼•ä½¿ç”¨ä¼˜åŒ–


### 6.1 ç´¢å¼•å¯¹CPUæ€§èƒ½çš„å½±å“

**ğŸ¯ ç´¢å¼•å°±åƒå›¾ä¹¦é¦†çš„ç›®å½•å¡ç‰‡**

```
å›¾ä¹¦ç®¡ç†ç±»æ¯”ï¼š
æ²¡æœ‰ç´¢å¼•ï¼šè¦æ‰¾ä¸€æœ¬ä¹¦éœ€è¦ä¸€æ’æ’åœ°æ‰¾ï¼Œè€—æ—¶è€—åŠ›
æœ‰ç´¢å¼•ï¼šæŸ¥ç›®å½•å¡ç‰‡ç›´æ¥å®šä½ï¼Œå¿«é€Ÿç²¾å‡†

ç´¢å¼•å¯¹CPUçš„å½±å“ï¼š
ä¼˜ç‚¹ï¼š
1. å¤§å¹…å‡å°‘æ•°æ®æ‰«æé‡
2. é¿å…å…¨è¡¨æ‰«æçš„CPUæ¶ˆè€—
3. åŠ é€Ÿæ’åºå’Œåˆ†ç»„æ“ä½œ
4. æé«˜JOINæ“ä½œæ•ˆç‡

ç¼ºç‚¹ï¼š
1. ç»´æŠ¤ç´¢å¼•éœ€è¦é¢å¤–CPU
2. æ’å…¥/æ›´æ–°/åˆ é™¤æ—¶æ›´æ–°ç´¢å¼•
3. è¿‡å¤šç´¢å¼•å½±å“å†™å…¥æ€§èƒ½
```

### 6.2 ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ

**ğŸ“Š ç›‘æ§ç´¢å¼•æ•ˆç‡çš„æ–¹æ³•**

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME,
    COUNT_FETCH,
    COUNT_INSERT,
    COUNT_UPDATE,
    COUNT_DELETE
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'sys')
ORDER BY COUNT_FETCH DESC;

-- æ‰¾å‡ºæœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME
FROM performance_schema.table_io_waits_summary_by_index_usage
WHERE INDEX_NAME IS NOT NULL
    AND COUNT_FETCH = 0
    AND OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'sys');

-- æŸ¥çœ‹è¡¨çš„ç´¢å¼•ä¿¡æ¯
SHOW INDEX FROM your_table_name;

-- åˆ†æç´¢å¼•é€‰æ‹©æ€§
SELECT 
    INDEX_NAME,
    CARDINALITY,
    CARDINALITY / (SELECT COUNT(*) FROM your_table_name) as selectivity
FROM information_schema.STATISTICS
WHERE TABLE_SCHEMA = 'your_database'
    AND TABLE_NAME = 'your_table_name';
```

### 6.3 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**ğŸ”§ è®¾è®¡é«˜æ•ˆç´¢å¼•çš„åŸåˆ™**

```sql
-- 1. è”åˆç´¢å¼•çš„åˆ—é¡ºåºä¼˜åŒ–
-- åŸåˆ™ï¼šé€‰æ‹©æ€§é«˜çš„åˆ—åœ¨å‰ï¼Œå¸¸ç”¨æŸ¥è¯¢æ¡ä»¶åœ¨å‰

-- æŸ¥è¯¢åœºæ™¯åˆ†æï¼š
-- å¸¸è§æŸ¥è¯¢1ï¼šWHERE status = 'active' AND city = 'Beijing'
-- å¸¸è§æŸ¥è¯¢2ï¼šWHERE status = 'active' AND age > 25
-- å¸¸è§æŸ¥è¯¢3ï¼šWHERE status = 'active'

-- åˆ†æå„åˆ—çš„é€‰æ‹©æ€§ï¼š
SELECT 
    COUNT(DISTINCT status) / COUNT(*) as status_selectivity,
    COUNT(DISTINCT city) / COUNT(*) as city_selectivity,
    COUNT(DISTINCT age) / COUNT(*) as age_selectivity
FROM users;

-- å¦‚æœcityé€‰æ‹©æ€§æ›´é«˜ï¼Œä¼˜åŒ–ç´¢å¼•é¡ºåºï¼š
-- åŸæ¥ï¼šKEY idx_status_city (status, city)
-- ä¼˜åŒ–ï¼šKEY idx_city_status (city, status)

-- 2. è¦†ç›–ç´¢å¼•è®¾è®¡
-- ç›®æ ‡ï¼šæŸ¥è¯¢åªéœ€è®¿é—®ç´¢å¼•ï¼Œä¸éœ€å›è¡¨

-- åŸæŸ¥è¯¢éœ€è¦å›è¡¨ï¼š
SELECT name, email FROM users WHERE status = 'active';
-- ç´¢å¼•ï¼šKEY idx_status (status)

-- åˆ›å»ºè¦†ç›–ç´¢å¼•ï¼š
CREATE INDEX idx_status_name_email ON users(status, name, email);
-- ç°åœ¨æŸ¥è¯¢å®Œå…¨ä½¿ç”¨ç´¢å¼•ï¼Œæ— éœ€å›è¡¨

-- 3. å‰ç¼€ç´¢å¼•ä¼˜åŒ–
-- å¯¹äºé•¿å­—ç¬¦ä¸²å­—æ®µï¼Œä½¿ç”¨å‰ç¼€ç´¢å¼•èŠ‚çœç©ºé—´

-- åˆ†æå‰ç¼€é•¿åº¦çš„é€‰æ‹©æ€§ï¼š
SELECT 
    ROUND(COUNT(DISTINCT LEFT(email, 5)) / COUNT(*), 4) as prefix_5,
    ROUND(COUNT(DISTINCT LEFT(email, 10)) / COUNT(*), 4) as prefix_10,
    ROUND(COUNT(DISTINCT LEFT(email, 15)) / COUNT(*), 4) as prefix_15,
    ROUND(COUNT(DISTINCT email) / COUNT(*), 4) as full_column
FROM users;

-- é€‰æ‹©é€‚å½“é•¿åº¦åˆ›å»ºå‰ç¼€ç´¢å¼•ï¼š
CREATE INDEX idx_email_prefix ON users(email(10));
```

**ğŸ’¡ ç´¢å¼•ç»´æŠ¤æœ€ä½³å®è·µ**
```sql
-- å®šæœŸæ£€æŸ¥ç´¢å¼•ç¢ç‰‡
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    ENGINE,
    ROUND(DATA_LENGTH/1024/1024, 2) as data_mb,
    ROUND(INDEX_LENGTH/1024/1024, 2) as index_mb,
    ROUND(DATA_FREE/1024/1024, 2) as free_mb
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'performance_schema', 'sys')
    AND DATA_FREE > 1024*1024*10  -- ç¢ç‰‡è¶…è¿‡10MB
ORDER BY DATA_FREE DESC;

-- é‡å»ºç¢ç‰‡åŒ–ä¸¥é‡çš„ç´¢å¼•
ALTER TABLE your_table_name ENGINE=InnoDB;
-- æˆ–è€…
OPTIMIZE TABLE your_table_name;
```

---

## 7. ğŸ›ï¸ å¹¶å‘æ§åˆ¶ç­–ç•¥


### 7.1 å¹¶å‘æ§åˆ¶çš„åŸºæœ¬åŸç†

**ğŸ¯ å¹¶å‘æ§åˆ¶å°±åƒäº¤é€šç®¡åˆ¶**

```
äº¤é€šç®¡åˆ¶ç±»æ¯”ï¼š
çº¢ç»¿ç¯ï¼šæ§åˆ¶ä¸åŒæ–¹å‘è½¦è¾†é€šè¡Œæ—¶æœº
é™é€Ÿæ ‡å¿—ï¼šæ§åˆ¶è½¦è¾†è¡Œé©¶é€Ÿåº¦
è½¦é“åˆ’åˆ†ï¼šä¸åŒç±»å‹è½¦è¾†åˆ†é“è¡Œé©¶

MySQLå¹¶å‘æ§åˆ¶ç›®æ ‡ï¼š
1. ä¿è¯æ•°æ®ä¸€è‡´æ€§
2. æé«˜ç³»ç»Ÿååé‡
3. é¿å…æ­»é”å‘ç”Ÿ
4. åˆç†åˆ†é…CPUèµ„æº
```

**ğŸ”§ MySQLå¹¶å‘æ§åˆ¶æœºåˆ¶**
```sql
-- 1. è¿æ¥æ•°æ§åˆ¶
SET GLOBAL max_connections = 200;
SET GLOBAL max_user_connections = 50;

-- 2. æŸ¥è¯¢å¹¶å‘æ§åˆ¶
-- é™åˆ¶åŒæ—¶æ‰§è¡Œçš„æŸ¥è¯¢æ•°é‡
SET GLOBAL max_running_queries = 100;

-- 3. äº‹åŠ¡è¶…æ—¶æ§åˆ¶
SET GLOBAL innodb_lock_wait_timeout = 50;  -- é”ç­‰å¾…è¶…æ—¶
SET GLOBAL interactive_timeout = 300;       -- äº¤äº’è¶…æ—¶
SET GLOBAL wait_timeout = 600;             -- éäº¤äº’è¶…æ—¶

-- 4. çº¿ç¨‹æ± é…ç½®ï¼ˆMySQL 8.0+ï¼‰
SET GLOBAL thread_pool_size = 8;           -- çº¿ç¨‹æ± å¤§å°
SET GLOBAL thread_pool_max_threads = 2000; -- æœ€å¤§çº¿ç¨‹æ•°
```

### 7.2 è¯»å†™åˆ†ç¦»ä¸è´Ÿè½½æ§åˆ¶

**ğŸ“Š åˆ†æµç­–ç•¥å‡å°‘CPUå‹åŠ›**

```
è¯»å†™åˆ†ç¦»æ¶æ„ï¼š
å†™æ“ä½œ â†’ ä¸»åº“ (Master)
è¯»æ“ä½œ â†’ ä»åº“ (Slave1, Slave2, Slave3)

ä¼˜åŠ¿ï¼š
1. ä¸»åº“ä¸“æ³¨å†™æ“ä½œï¼ŒCPUå‹åŠ›å‡å°
2. è¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªä»åº“
3. å¯æ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©æœ€ä¼˜ä»åº“
4. æ•…éšœéš”ç¦»ï¼Œè¯»å†™äº’ä¸å½±å“
```

**ğŸ”§ åº”ç”¨å±‚è¯»å†™åˆ†ç¦»å®ç°**
```python
# ç®€åŒ–çš„è¯»å†™åˆ†ç¦»ç¤ºä¾‹ï¼ˆPythonï¼‰
class DatabaseRouter:
    def __init__(self):
        self.master_db = create_connection('master_host')
        self.slave_dbs = [
            create_connection('slave1_host'),
            create_connection('slave2_host'),
            create_connection('slave3_host')
        ]
        self.slave_index = 0
    
    def get_write_connection(self):
        return self.master_db
    
    def get_read_connection(self):
        # è½®è¯¢é€‰æ‹©ä»åº“
        db = self.slave_dbs[self.slave_index]
        self.slave_index = (self.slave_index + 1) % len(self.slave_dbs)
        return db
    
    def execute_query(self, sql, params=None):
        if sql.strip().upper().startswith(('SELECT', 'SHOW', 'DESCRIBE')):
            return self.get_read_connection().execute(sql, params)
        else:
            return self.get_write_connection().execute(sql, params)
```

### 7.3 æŸ¥è¯¢é˜Ÿåˆ—ä¸é™æµæœºåˆ¶

**â³ å¹³æ»‘å¤„ç†å¹¶å‘é«˜å³°**

```sql
-- æŸ¥è¯¢ä¼˜å…ˆçº§æ§åˆ¶
-- ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·è´¦å·ï¼Œè®¾ç½®ä¸åŒèµ„æºé™åˆ¶

-- åˆ›å»ºé™åˆ¶ç”¨æˆ·
CREATE USER 'app_user'@'%' IDENTIFIED BY 'password';
CREATE USER 'report_user'@'%' IDENTIFIED BY 'password';
CREATE USER 'batch_user'@'%' IDENTIFIED BY 'password';

-- è®¾ç½®ä¸åŒçš„èµ„æºé™åˆ¶
ALTER USER 'app_user'@'%' 
    WITH MAX_CONNECTIONS_PER_HOUR 1000
         MAX_QUERIES_PER_HOUR 10000;

ALTER USER 'report_user'@'%'
    WITH MAX_CONNECTIONS_PER_HOUR 100
         MAX_QUERIES_PER_HOUR 1000;

ALTER USER 'batch_user'@'%'
    WITH MAX_CONNECTIONS_PER_HOUR 10
         MAX_QUERIES_PER_HOUR 100;
```

**ğŸ›ï¸ åº”ç”¨å±‚é™æµç­–ç•¥**
```python
import time
from collections import defaultdict, deque

class QueryRateLimiter:
    def __init__(self):
        self.request_counts = defaultdict(deque)
        self.limits = {
            'SELECT': 100,  # æ¯åˆ†é’Ÿ100æ¬¡æŸ¥è¯¢
            'INSERT': 50,   # æ¯åˆ†é’Ÿ50æ¬¡æ’å…¥
            'UPDATE': 30,   # æ¯åˆ†é’Ÿ30æ¬¡æ›´æ–°
            'DELETE': 10    # æ¯åˆ†é’Ÿ10æ¬¡åˆ é™¤
        }
    
    def is_allowed(self, query_type, user_id):
        now = time.time()
        user_requests = self.request_counts[f"{user_id}_{query_type}"]
        
        # æ¸…ç†1åˆ†é’Ÿå‰çš„è¯·æ±‚è®°å½•
        while user_requests and user_requests[0] < now - 60:
            user_requests.popleft()
        
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if len(user_requests) >= self.limits.get(query_type, 100):
            return False
        
        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        user_requests.append(now)
        return True
```

---

## 8. ğŸ“Š CPUæ€§èƒ½ç›‘æ§


### 8.1 ç³»ç»Ÿçº§CPUç›‘æ§

**ğŸ“ˆ å»ºç«‹å®Œæ•´çš„ç›‘æ§ä½“ç³»**

```bash
# 1. å®æ—¶CPUä½¿ç”¨ç‡ç›‘æ§
top -p $(pgrep mysqld) -d 1
# å…³æ³¨æŒ‡æ ‡ï¼š
# %CPU: MySQLè¿›ç¨‹çš„CPUä½¿ç”¨ç‡
# %MEM: å†…å­˜ä½¿ç”¨ç‡
# VIRT/RES: è™šæ‹Ÿå†…å­˜/ç‰©ç†å†…å­˜ä½¿ç”¨

# 2. å†å²CPUä½¿ç”¨è¶‹åŠ¿
sar -u 1 60 > cpu_usage.log
# %user: ç”¨æˆ·æ€CPUä½¿ç”¨ç‡
# %system: ç³»ç»Ÿæ€CPUä½¿ç”¨ç‡  
# %iowait: IOç­‰å¾…CPUä½¿ç”¨ç‡
# %idle: ç©ºé—²CPUç™¾åˆ†æ¯”

# 3. MySQLè¿›ç¨‹è¯¦ç»†ä¿¡æ¯
ps -eo pid,ppid,cmd,%cpu,%mem,time --sort=-%cpu | grep mysqld

# 4. CPUæ ¸å¿ƒä½¿ç”¨åˆ†å¸ƒ
mpstat -P ALL 1 10
# æŸ¥çœ‹å„CPUæ ¸å¿ƒçš„è´Ÿè½½åˆ†å¸ƒ
```

### 8.2 MySQLå†…éƒ¨æ€§èƒ½ç›‘æ§

**ğŸ” æ·±å…¥MySQLå†…éƒ¨æŒ‡æ ‡**

```sql
-- 1. æŸ¥è¯¢æ‰§è¡Œç»Ÿè®¡
SELECT 
    EVENT_NAME,
    COUNT_STAR as total_queries,
    SUM_TIMER_WAIT/1000000000000 as total_time_sec,
    AVG_TIMER_WAIT/1000000000000 as avg_time_sec,
    MAX_TIMER_WAIT/1000000000000 as max_time_sec
FROM performance_schema.events_statements_summary_global_by_event_name
WHERE EVENT_NAME LIKE 'statement/sql/%'
ORDER BY SUM_TIMER_WAIT DESC
LIMIT 10;

-- 2. çº¿ç¨‹çŠ¶æ€åˆ†æ
SELECT 
    STATE,
    COUNT(*) as thread_count,
    AVG(TIME) as avg_time_sec
FROM information_schema.processlist
WHERE COMMAND != 'Sleep'
GROUP BY STATE
ORDER BY thread_count DESC;

-- 3. è¡¨çº§æ“ä½œç»Ÿè®¡
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    COUNT_READ,
    COUNT_WRITE,
    COUNT_DELETE,
    SUM_TIMER_READ/1000000000000 as read_time_sec,
    SUM_TIMER_WRITE/1000000000000 as write_time_sec
FROM performance_schema.table_io_waits_summary_by_table
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'performance_schema', 'sys')
ORDER BY SUM_TIMER_READ + SUM_TIMER_WRITE DESC
LIMIT 10;

-- 4. å†…å­˜ä½¿ç”¨åˆ†æ
SELECT 
    EVENT_NAME,
    CURRENT_COUNT_USED,
    CURRENT_SIZE_USED,
    HIGH_COUNT_USED,
    HIGH_SIZE_USED
FROM performance_schema.memory_summary_global_by_event_name
WHERE CURRENT_SIZE_USED > 0
ORDER BY CURRENT_SIZE_USED DESC
LIMIT 10;
```

### 8.3 è‡ªåŠ¨åŒ–ç›‘æ§å‘Šè­¦

**ğŸš¨ å»ºç«‹ä¸»åŠ¨ç›‘æ§æœºåˆ¶**

```python
# MySQL CPUç›‘æ§è„šæœ¬ç¤ºä¾‹
import psutil
import mysql.connector
import time
import smtplib
from email.mime.text import MIMEText

class MySQLCPUMonitor:
    def __init__(self, mysql_config, alert_config):
        self.mysql_config = mysql_config
        self.alert_config = alert_config
        self.alert_history = {}
    
    def get_mysql_cpu_usage(self):
        # è·å–MySQLè¿›ç¨‹CPUä½¿ç”¨ç‡
        for proc in psutil.process_iter(['pid', 'name', 'cpu_percent']):
            if 'mysqld' in proc.info['name']:
                return proc.info['cpu_percent']
        return 0
    
    def get_mysql_connections(self):
        # è·å–MySQLè¿æ¥æ•°
        try:
            conn = mysql.connector.connect(**self.mysql_config)
            cursor = conn.cursor()
            cursor.execute("SHOW STATUS LIKE 'Threads_connected'")
            result = cursor.fetchone()
            return int(result[1])
        except Exception as e:
            print(f"è·å–è¿æ¥æ•°å¤±è´¥: {e}")
            return 0
        finally:
            if 'conn' in locals():
                conn.close()
    
    def check_cpu_threshold(self):
        cpu_usage = self.get_mysql_cpu_usage()
        connections = self.get_mysql_connections()
        
        # CPUä½¿ç”¨ç‡å‘Šè­¦é˜ˆå€¼
        if cpu_usage > 90:
            self.send_alert('CRITICAL', f'MySQL CPUä½¿ç”¨ç‡è¿‡é«˜: {cpu_usage}%')
        elif cpu_usage > 80:
            self.send_alert('WARNING', f'MySQL CPUä½¿ç”¨ç‡å‘Šè­¦: {cpu_usage}%')
        
        # è¿æ¥æ•°å‘Šè­¦é˜ˆå€¼
        if connections > 180:
            self.send_alert('WARNING', f'MySQLè¿æ¥æ•°è¿‡é«˜: {connections}')
        
        return cpu_usage, connections
    
    def send_alert(self, level, message):
        # é¿å…é‡å¤å‘Šè­¦
        if message in self.alert_history:
            if time.time() - self.alert_history[message] < 300:  # 5åˆ†é’Ÿå†…ä¸é‡å¤
                return
        
        self.alert_history[message] = time.time()
        
        # å‘é€é‚®ä»¶å‘Šè­¦
        try:
            msg = MIMEText(f"å‘Šè­¦çº§åˆ«: {level}\nå‘Šè­¦å†…å®¹: {message}")
            msg['Subject'] = f'MySQLç›‘æ§å‘Šè­¦ - {level}'
            msg['From'] = self.alert_config['from_email']
            msg['To'] = self.alert_config['to_email']
            
            smtp = smtplib.SMTP(self.alert_config['smtp_server'])
            smtp.send_message(msg)
            smtp.quit()
        except Exception as e:
            print(f"å‘é€å‘Šè­¦é‚®ä»¶å¤±è´¥: {e}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    mysql_config = {
        'host': 'localhost',
        'user': 'monitor_user',
        'password': 'monitor_password',
        'database': 'information_schema'
    }
    
    alert_config = {
        'smtp_server': 'smtp.company.com',
        'from_email': 'monitor@company.com',
        'to_email': 'dba@company.com'
    }
    
    monitor = MySQLCPUMonitor(mysql_config, alert_config)
    
    while True:
        cpu_usage, connections = monitor.check_cpu_threshold()
        print(f"CPU: {cpu_usage}%, è¿æ¥æ•°: {connections}")
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## 9. âš–ï¸ è´Ÿè½½å‡è¡¡ä¼˜åŒ–


### 9.1 æ•°æ®åº“è´Ÿè½½å‡è¡¡æ¶æ„

**ğŸ¯ åˆ†æ•£å‹åŠ›çš„ç³»ç»Ÿè®¾è®¡**

```
è´Ÿè½½å‡è¡¡æ¶æ„å›¾ï¼š

                åº”ç”¨æœåŠ¡å™¨
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
              â”‚      â”‚      â”‚
        è´Ÿè½½å‡è¡¡å™¨   â”‚   ç›‘æ§ç³»ç»Ÿ
              â”‚      â”‚      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚      â”‚      â”‚         â”‚
  ä¸»åº“     ä»åº“1   ä»åº“2   ä»åº“3    ä»åº“4
 (å†™æ“ä½œ)  (è¯»æ“ä½œ) (è¯»æ“ä½œ) (æŠ¥è¡¨)  (å¤‡ä»½)

è´Ÿè½½åˆ†é…ç­–ç•¥ï¼š
ä¸»åº“ï¼šå¤„ç†æ‰€æœ‰å†™æ“ä½œ(INSERT/UPDATE/DELETE)
ä»åº“1-2ï¼šå¤„ç†å®æ—¶æŸ¥è¯¢(SELECT)
ä»åº“3ï¼šå¤„ç†æŠ¥è¡¨å’Œåˆ†ææŸ¥è¯¢
ä»åº“4ï¼šä¸“é—¨ç”¨äºå¤‡ä»½å’Œç»´æŠ¤
```

### 9.2 è¯»å†™åˆ†ç¦»è´Ÿè½½ä¼˜åŒ–

**ğŸ“Š æ™ºèƒ½åˆ†æµç­–ç•¥**

```python
# é«˜çº§è¯»å†™åˆ†ç¦»è·¯ç”±å™¨
class SmartDBRouter:
    def __init__(self):
        self.master = DatabaseConnection('master_host')
        self.slaves = {
            'realtime': [
                DatabaseConnection('slave1_host'),
                DatabaseConnection('slave2_host')
            ],
            'analytics': [
                DatabaseConnection('slave3_host')
            ],
            'backup': [
                DatabaseConnection('slave4_host')
            ]
        }
        self.connection_stats = {}
    
    def route_query(self, sql, query_type='realtime'):
        # å†™æ“ä½œç›´æ¥è·¯ç”±åˆ°ä¸»åº“
        if self._is_write_operation(sql):
            return self.master
        
        # æ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©ä»åº“ç»„
        if 'report' in sql.lower() or 'analytics' in query_type:
            slave_group = self.slaves['analytics']
        else:
            slave_group = self.slaves['realtime']
        
        # é€‰æ‹©è´Ÿè½½æœ€ä½çš„ä»åº“
        return self._select_least_loaded_slave(slave_group)
    
    def _is_write_operation(self, sql):
        write_keywords = ['INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'TRUNCATE']
        return any(sql.upper().startswith(keyword) for keyword in write_keywords)
    
    def _select_least_loaded_slave(self, slave_group):
        # é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„ä»åº“
        min_connections = float('inf')
        best_slave = None
        
        for slave in slave_group:
            connections = self._get_connection_count(slave)
            if connections < min_connections:
                min_connections = connections
                best_slave = slave
        
        return best_slave
    
    def _get_connection_count(self, db_connection):
        try:
            result = db_connection.execute("SHOW STATUS LIKE 'Threads_connected'")
            return int(result[0][1])
        except:
            return 999  # æŸ¥è¯¢å¤±è´¥æ—¶è®¾ç½®é«˜å€¼ï¼Œé¿å…é€‰ä¸­
```

### 9.3 è¿æ¥æ± è´Ÿè½½å‡è¡¡

**ğŸ”„ è¿æ¥æ± çº§åˆ«çš„è´Ÿè½½æ§åˆ¶**

```java
// Javaè¿æ¥æ± è´Ÿè½½å‡è¡¡ç¤ºä¾‹
public class LoadBalancedConnectionPool {
    private final List<DataSource> masterPools;
    private final List<DataSource> slavePools;
    private final AtomicInteger slaveIndex = new AtomicInteger(0);
    private final LoadBalancer loadBalancer;
    
    public LoadBalancedConnectionPool() {
        // åˆå§‹åŒ–ä¸»åº“è¿æ¥æ± 
        this.masterPools = Arrays.asList(
            createDataSource("master1_host"),
            createDataSource("master2_host")  // ä¸»ä¸»å¤åˆ¶åœºæ™¯
        );
        
        // åˆå§‹åŒ–ä»åº“è¿æ¥æ± 
        this.slavePools = Arrays.asList(
            createDataSource("slave1_host"),
            createDataSource("slave2_host"),
            createDataSource("slave3_host")
        );
        
        this.loadBalancer = new RoundRobinLoadBalancer();
    }
    
    public Connection getWriteConnection() throws SQLException {
        // ä¸»åº“è´Ÿè½½å‡è¡¡ï¼ˆå¦‚æœæœ‰å¤šä¸ªä¸»åº“ï¼‰
        DataSource masterPool = loadBalancer.select(masterPools);
        return masterPool.getConnection();
    }
    
    public Connection getReadConnection() throws SQLException {
        // ä»åº“è´Ÿè½½å‡è¡¡
        DataSource slavePool = loadBalancer.select(slavePools);
        Connection conn = null;
        
        try {
            conn = slavePool.getConnection();
            // æ£€æŸ¥ä»åº“å»¶è¿Ÿ
            if (checkReplicationLag(conn) > 5) {  // å»¶è¿Ÿè¶…è¿‡5ç§’
                conn.close();
                // å°è¯•å…¶ä»–ä»åº“
                return getReadConnection();
            }
            return conn;
        } catch (SQLException e) {
            if (conn != null) conn.close();
            // ä»åº“è¿æ¥å¤±è´¥ï¼Œé™çº§åˆ°ä¸»åº“
            return getWriteConnection();
        }
    }
    
    private int checkReplicationLag(Connection conn) throws SQLException {
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery("SHOW SLAVE STATUS");
        if (rs.next()) {
            return rs.getInt("Seconds_Behind_Master");
        }
        return 0;
    }
}

// è´Ÿè½½å‡è¡¡ç®—æ³•æ¥å£
interface LoadBalancer {
    <T> T select(List<T> servers);
}

// è½®è¯¢è´Ÿè½½å‡è¡¡
class RoundRobinLoadBalancer implements LoadBalancer {
    private final AtomicInteger index = new AtomicInteger(0);
    
    @Override
    public <T> T select(List<T> servers) {
        if (servers.isEmpty()) {
            throw new IllegalArgumentException("æœåŠ¡å™¨åˆ—è¡¨ä¸ºç©º");
        }
        int current = index.getAndIncrement();
        return servers.get(current % servers.size());
    }
}

// åŠ æƒè´Ÿè½½å‡è¡¡
class WeightedLoadBalancer implements LoadBalancer {
    private final Map<Object, Integer> weights = new HashMap<>();
    
    public void setWeight(Object server, int weight) {
        weights.put(server, weight);
    }
    
    @Override
    public <T> T select(List<T> servers) {
        // æ ¹æ®æƒé‡é€‰æ‹©æœåŠ¡å™¨
        int totalWeight = servers.stream()
            .mapToInt(server -> weights.getOrDefault(server, 1))
            .sum();
        
        int random = new Random().nextInt(totalWeight);
        int currentWeight = 0;
        
        for (T server : servers) {
            currentWeight += weights.getOrDefault(server, 1);
            if (random < currentWeight) {
                return server;
            }
        }
        
        return servers.get(0);  // é»˜è®¤è¿”å›ç¬¬ä¸€ä¸ª
    }
}
```

### 9.4 åº”ç”¨å±‚è´Ÿè½½ä¼˜åŒ–

**âš¡ å‡å°‘æ•°æ®åº“å‹åŠ›çš„åº”ç”¨ç­–ç•¥**

```python
# ç¼“å­˜+æ•°æ®åº“çš„ç»„åˆè´Ÿè½½ä¼˜åŒ–
import redis
import time
from functools import wraps

class DatabaseLoadOptimizer:
    def __init__(self):
        self.redis_client = redis.Redis(host='redis_host')
        self.db_router = SmartDBRouter()
        self.query_cache = {}
    
    def cached_query(self, cache_time=300):
        """æŸ¥è¯¢ç»“æœç¼“å­˜è£…é¥°å™¨"""
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                # ç”Ÿæˆç¼“å­˜é”®
                cache_key = f"{func.__name__}:{hash(str(args) + str(kwargs))}"
                
                # å°è¯•ä»Redisè·å–ç¼“å­˜
                cached_result = self.redis_client.get(cache_key)
                if cached_result:
                    return json.loads(cached_result)
                
                # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡ŒæŸ¥è¯¢
                result = func(*args, **kwargs)
                
                # å­˜å‚¨åˆ°Redisç¼“å­˜
                self.redis_client.setex(
                    cache_key, 
                    cache_time, 
                    json.dumps(result, default=str)
                )
                
                return result
            return wrapper
        return decorator
    
    @cached_query(cache_time=600)  # ç¼“å­˜10åˆ†é’Ÿ
    def get_user_profile(self, user_id):
        """è·å–ç”¨æˆ·èµ„æ–™ï¼ˆé€‚åˆç¼“å­˜ï¼‰"""
        sql = "SELECT * FROM users WHERE id = %s"
        conn = self.db_router.route_query(sql, 'realtime')
        return conn.execute(sql, (user_id,))
    
    def get_real_time_data(self, query_params):
        """å®æ—¶æ•°æ®æŸ¥è¯¢ï¼ˆä¸ç¼“å­˜ï¼‰"""
        sql = "SELECT * FROM orders WHERE status = %s AND create_time > %s"
        conn = self.db_router.route_query(sql, 'realtime')
        return conn.execute(sql, query_params)
    
    def batch_insert_optimization(self, data_list):
        """æ‰¹é‡æ’å…¥ä¼˜åŒ–"""
        # å°†å¤§æ‰¹é‡æ‹†åˆ†ä¸ºå°æ‰¹æ¬¡
        batch_size = 1000
        conn = self.db_router.route_query("INSERT", 'write')
        
        for i in range(0, len(data_list), batch_size):
            batch = data_list[i:i + batch_size]
            
            # ä½¿ç”¨æ‰¹é‡æ’å…¥
            sql = "INSERT INTO table_name (col1, col2, col3) VALUES "
            values = []
            params = []
            
            for item in batch:
                values.append("(%s, %s, %s)")
                params.extend([item['col1'], item['col2'], item['col3']])
            
            final_sql = sql + ",".join(values)
            conn.execute(final_sql, params)
            
            # æ§åˆ¶æ’å…¥é€Ÿåº¦ï¼Œé¿å…å†²å‡»æ•°æ®åº“
            time.sleep(0.01)  # 10mså»¶è¿Ÿ
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CPUé«˜ä½¿ç”¨ç‡æ ¹å› ï¼šæ…¢æŸ¥è¯¢ã€å¹¶å‘è¿‡å¤šã€é”äº‰ç”¨ã€ç´¢å¼•ç¼ºå¤±
ğŸ”¸ è¯Šæ–­æ–¹æ³•ï¼šç³»ç»Ÿç›‘æ§ã€MySQLçŠ¶æ€ã€æ‰§è¡Œè®¡åˆ’ã€é”åˆ†æ
ğŸ”¸ ä¼˜åŒ–ç­–ç•¥ï¼šæŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•ä¼˜åŒ–ã€å¹¶å‘æ§åˆ¶ã€è´Ÿè½½å‡è¡¡
ğŸ”¸ ç›‘æ§ä½“ç³»ï¼šå®æ—¶ç›‘æ§ã€è¶‹åŠ¿åˆ†æã€è‡ªåŠ¨å‘Šè­¦ã€æ€§èƒ½åŸºçº¿
ğŸ”¸ é¢„é˜²æªæ–½ï¼šå®¹é‡è§„åˆ’ã€æ¶æ„è®¾è®¡ã€ä»£ç å®¡æŸ¥ã€å‹åŠ›æµ‹è¯•
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CPUä½¿ç”¨ç‡è¿‡é«˜çš„æœ¬è´¨åŸå› **
```
æ ¸å¿ƒé—®é¢˜ï¼š
- èµ„æºç«äº‰ï¼šå¤šä¸ªæŸ¥è¯¢äº‰æŠ¢CPUèµ„æº
- æ•ˆç‡ä½ä¸‹ï¼šæŸ¥è¯¢æ‰§è¡Œæ•ˆç‡å·®ï¼Œæ¶ˆè€—è¿‡å¤šCPU
- è®¾è®¡ç¼ºé™·ï¼šæ¶æ„è®¾è®¡ä¸åˆç†ï¼Œå•ç‚¹å‹åŠ›è¿‡å¤§

è§£å†³æ€è·¯ï¼š
- æé«˜æ•ˆç‡ï¼šä¼˜åŒ–æŸ¥è¯¢å’Œç´¢å¼•
- åˆ†æ•£å‹åŠ›ï¼šè¯»å†™åˆ†ç¦»å’Œè´Ÿè½½å‡è¡¡  
- æ§åˆ¶å¹¶å‘ï¼šé™åˆ¶è¿æ¥æ•°å’ŒæŸ¥è¯¢å¹¶å‘
```

**ğŸ”¹ è¯Šæ–­é—®é¢˜çš„ç³»ç»Ÿæ–¹æ³•**
```
åˆ†å±‚è¯Šæ–­æ³•ï¼š
ç¬¬1å±‚ï¼šç³»ç»Ÿå±‚é¢ - ç¡®è®¤CPUç¡®å®è¿‡é«˜
ç¬¬2å±‚ï¼šè¿›ç¨‹å±‚é¢ - ç¡®è®¤æ˜¯MySQLå¯¼è‡´
ç¬¬3å±‚ï¼šMySQLå±‚é¢ - æ‰¾å‡ºå…·ä½“åŸå› 
ç¬¬4å±‚ï¼šæŸ¥è¯¢å±‚é¢ - å®šä½é—®é¢˜SQL

å·¥å…·ç»„åˆï¼š
ç³»ç»Ÿå·¥å…·ï¼štopã€sarã€mpstat
MySQLå·¥å…·ï¼šSHOWå‘½ä»¤ã€performance_schema
åˆ†æå·¥å…·ï¼šEXPLAINã€æ…¢æŸ¥è¯¢æ—¥å¿—
```

**ğŸ”¹ ä¼˜åŒ–ç­–ç•¥çš„ä¼˜å…ˆçº§**
```
ç´§æ€¥å¤„ç†ï¼ˆç«‹å³è§æ•ˆï¼‰ï¼š
1. ç»ˆæ­¢å¼‚å¸¸æŸ¥è¯¢
2. é™åˆ¶è¿æ¥æ•°
3. ä¸´æ—¶é™çº§æœåŠ¡

çŸ­æœŸä¼˜åŒ–ï¼ˆ1-3å¤©ï¼‰ï¼š
1. æ·»åŠ ç¼ºå¤±ç´¢å¼•
2. ä¼˜åŒ–æ…¢æŸ¥è¯¢
3. è°ƒæ•´å‚æ•°é…ç½®

é•¿æœŸè§„åˆ’ï¼ˆ1-3ä¸ªæœˆï¼‰ï¼š
1. æ¶æ„ä¼˜åŒ–
2. å®¹é‡æ‰©å±•
3. ç›‘æ§å®Œå–„
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **ç”µå•†å¤§ä¿ƒ**ï¼šåº”å¯¹çªå‘æµé‡çš„CPUä¼˜åŒ–ç­–ç•¥
- **é‡‘èäº¤æ˜“**ï¼šé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½ä¿éšœ
- **å†…å®¹å¹³å°**ï¼šå¤§æ•°æ®é‡æŸ¥è¯¢çš„CPUæ§åˆ¶
- **ä¼ä¸šç³»ç»Ÿ**ï¼šæ—¥å¸¸è¿ç»´ä¸­çš„æ€§èƒ½ç›‘æ§

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **å»ºç«‹åŸºçº¿**ï¼šè®°å½•æ­£å¸¸æƒ…å†µä¸‹çš„CPUä½¿ç”¨æ¨¡å¼
- **åˆ†çº§å‘Šè­¦**ï¼šè®¾ç½®ä¸åŒç­‰çº§çš„CPUå‘Šè­¦é˜ˆå€¼
- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šCPUè¿‡é«˜çš„æ ‡å‡†å¤„ç†æµç¨‹
- **å®šæœŸä¼˜åŒ–**ï¼šå»ºç«‹å®šæœŸçš„æ€§èƒ½æ£€æŸ¥æœºåˆ¶

**ğŸ“ˆ æŒç»­æ”¹è¿›æ–¹å‘**
- **è‡ªåŠ¨åŒ–ç›‘æ§**ï¼šæ›´æ™ºèƒ½çš„å¼‚å¸¸æ£€æµ‹å’Œè‡ªåŠ¨å¤„ç†
- **é¢„æµ‹æ€§ä¼˜åŒ–**ï¼šåŸºäºå†å²æ•°æ®é¢„æµ‹æ€§èƒ½é—®é¢˜
- **äº‘åŸç”Ÿé€‚é…**ï¼šé€‚åº”å®¹å™¨åŒ–å’Œå¾®æœåŠ¡æ¶æ„
- **AIè¾…åŠ©è¯Šæ–­**ï¼šåˆ©ç”¨æœºå™¨å­¦ä¹ æé«˜é—®é¢˜è¯Šæ–­å‡†ç¡®æ€§

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- CPUè¿‡é«˜è«æ…Œå¼ ï¼Œåˆ†å±‚è¯Šæ–­æ‰¾çœŸç›¸
- æ…¢æŸ¥è¯¢æ˜¯ä¸»å…ƒå‡¶ï¼Œç´¢å¼•ä¼˜åŒ–æœ€æœ‰æ•ˆ
- å¹¶å‘æ§åˆ¶è¦åˆç†ï¼Œè´Ÿè½½å‡è¡¡åˆ†å‹åŠ›
- ç›‘æ§å‘Šè­¦è¦å®Œå–„ï¼Œé¢„é˜²èƒœäºäº‹åè¡¥