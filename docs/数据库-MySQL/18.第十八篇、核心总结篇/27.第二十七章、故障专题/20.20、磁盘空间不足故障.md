---
title: 20、磁盘空间不足故障
---
## 📚 目录

1. [磁盘空间不足故障概述](#1-磁盘空间不足故障概述)
2. [故障表现与诊断](#2-故障表现与诊断)
3. [紧急处理措施](#3-紧急处理措施)
4. [预防与监控机制](#4-预防与监控机制)
5. [长期解决方案](#5-长期解决方案)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 💾 磁盘空间不足故障概述


### 1.1 什么是磁盘空间不足故障


**简单理解**：就像你的手机存储空间满了一样，MySQL数据库所在的磁盘空间用完了，导致数据库无法正常工作。

**故障本质**：
```
正常情况：应用程序 → MySQL → 磁盘有空间 → 数据正常写入
故障情况：应用程序 → MySQL → 磁盘空间满 → 写入失败 → 服务异常
```

**为什么会发生**：
- 📈 **数据增长过快** - 业务数据急剧增长
- 🗂️ **日志文件堆积** - 二进制日志、错误日志等没有定期清理
- 🔄 **临时文件残留** - 复杂查询产生的临时文件未清理
- ⚙️ **表空间自动扩展** - InnoDB表空间文件不断增长

### 1.2 故障影响范围


**立即影响**：
```
🚨 数据写入失败
🚨 事务回滚
🚨 应用程序报错
🚨 用户操作异常
```

**连锁反应**：
```
数据库写入失败 → 应用程序异常 → 用户无法操作 → 业务中断
```

### 1.3 常见触发场景


**业务场景示例**：
- **电商大促** - 订单数据暴增，日志文件快速增长
- **数据导入** - 大批量数据导入时空间不足
- **备份操作** - 备份文件占用过多空间
- **日志未清理** - 长期运行后日志文件堆积

---

## 2. 🔍 故障表现与诊断


### 2.1 典型错误信息


**核心错误信息**：
```bash
# 最常见的错误提示
ERROR 1114 (HY000): The table 'table_name' is full
ERROR 3 (HY000): Error writing file '/tmp/xxx' (errno: 28 "No space left on device")
ERROR 1021 (HY000): Disk full (/tmp/#sql_xxx.MYI); waiting for someone to free some space...
```

**系统层面错误**：
```bash
# 系统磁盘空间不足
-bash: cannot create temp file for here-document: No space left on device
# MySQL服务启动失败
mysqld: Can't create/write to file '/var/log/mysql/error.log' (Errcode: 28)
```

### 2.2 故障诊断步骤


**第一步：快速确认磁盘使用情况**
```bash
# 查看磁盘使用率
df -h
```

**输出示例解读**：
```bash
文件系统        容量  已用  可用 使用率 挂载点
/dev/sda1        20G   19G   1G   95%  /
/dev/sda2       100G   98G   2G   98%  /var/lib/mysql
```

> 💡 **关键指标**：使用率超过 **90%** 就需要警惕，超过 **95%** 属于高危状态

**第二步：定位具体占用空间的文件**
```bash
# 查找MySQL数据目录下的大文件
du -sh /var/lib/mysql/*

# 查找最大的几个文件
find /var/lib/mysql -type f -exec du -h {} \; | sort -hr | head -10
```

**第三步：检查MySQL相关目录**
```bash
# 检查主要目录占用
du -sh /var/lib/mysql/          # 数据目录
du -sh /var/log/mysql/          # 日志目录
du -sh /tmp/                    # 临时文件目录
```

### 2.3 空间占用分析


**MySQL数据库空间占用构成**：
```
MySQL总空间占用
├── 数据文件 (60-80%)
│   ├── .ibd文件 (表数据)
│   ├── .frm文件 (表结构)
│   └── ibdata1 (系统表空间)
├── 日志文件 (10-25%)
│   ├── 二进制日志 (mysql-bin.*)
│   ├── 错误日志 (error.log)
│   ├── 慢查询日志 (slow.log)
│   └── 中继日志 (relay-bin.*)
└── 临时文件 (5-15%)
    ├── 排序临时文件
    └── 查询缓存文件
```

**空间占用检查脚本**：
```sql
-- 查看数据库大小
SELECT 
    table_schema AS '数据库',
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS '大小(MB)'
FROM information_schema.tables 
GROUP BY table_schema
ORDER BY SUM(data_length + index_length) DESC;

-- 查看具体表大小
SELECT 
    table_name AS '表名',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS '大小(MB)'
FROM information_schema.tables 
WHERE table_schema = 'your_database_name'
ORDER BY (data_length + index_length) DESC;
```

---

## 3. 🚨 紧急处理措施


### 3.1 立即释放空间策略


**🔥 紧急处理优先级**：
1. **清理二进制日志** (效果最快)
2. **清理临时文件** (风险最小)
3. **删除不必要的备份文件** (空间释放大)
4. **压缩或删除老旧日志** (长期有效)

### 3.2 清理二进制日志


**什么是二进制日志**：
> 💡 二进制日志记录了所有修改数据的SQL语句，用于主从复制和数据恢复。但如果不定期清理，会占用大量空间。

**安全清理步骤**：
```sql
-- 1. 查看当前二进制日志
SHOW BINARY LOGS;

-- 2. 查看主从复制状态(如果有从库)
SHOW SLAVE STATUS\G

-- 3. 安全清理7天前的日志
PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 或者清理到指定日志文件
PURGE BINARY LOGS TO 'mysql-bin.000100';
```

**⚠️ 重要注意事项**：
- 🚨 **有主从复制时**：确保从库已同步完成再清理
- 🚨 **需要恢复时**：确保不需要这些日志进行数据恢复
- 🚨 **生产环境**：建议先备份重要日志再清理

### 3.3 清理临时文件


**临时文件位置**：
```bash
# MySQL临时目录(通常是/tmp)
SHOW VARIABLES LIKE 'tmpdir';

# 清理MySQL临时文件
rm -f /tmp/#sql_*
rm -f /tmp/ML*
rm -f /tmp/MY*
```

**InnoDB临时表空间**：
```sql
-- 查看临时表空间大小
SELECT FILE_NAME, TABLESPACE_NAME, 
       ROUND(TOTAL_EXTENTS*64/1024,2) AS 'SIZE_MB'
FROM INFORMATION_SCHEMA.FILES 
WHERE TABLESPACE_NAME LIKE '%temp%';

-- 重启MySQL释放临时表空间
sudo systemctl restart mysql
```

### 3.4 压缩和归档日志


**错误日志处理**：
```bash
# 备份当前错误日志
cp /var/log/mysql/error.log /backup/error.log.$(date +%Y%m%d)

# 清空错误日志
> /var/log/mysql/error.log

# 或者压缩归档
gzip /var/log/mysql/error.log.old
```

**慢查询日志处理**：
```bash
# 压缩旧的慢查询日志
gzip /var/log/mysql/slow.log.old

# 清空当前慢查询日志
> /var/log/mysql/slow.log
```

### 3.5 紧急迁移策略


**数据文件迁移**(风险较高，谨慎操作)：
```bash
# 1. 停止MySQL服务
sudo systemctl stop mysql

# 2. 迁移数据到其他磁盘
sudo mv /var/lib/mysql /mnt/new_disk/mysql

# 3. 创建软链接
sudo ln -s /mnt/new_disk/mysql /var/lib/mysql

# 4. 启动MySQL服务
sudo systemctl start mysql
```

**表空间迁移**(MySQL 5.6+)：
```sql
-- 创建新表空间
CREATE TABLESPACE new_tablespace 
ADD DATAFILE '/mnt/new_disk/new_tablespace.ibd' 
FILE_BLOCK_SIZE = 16K;

-- 移动表到新表空间
ALTER TABLE large_table TABLESPACE new_tablespace;
```

---

## 4. 📊 预防与监控机制


### 4.1 磁盘使用率监控


**监控指标设置**：
```bash
# 磁盘使用率检查脚本
#!/bin/bash
THRESHOLD=85  # 告警阈值85%

df -h | awk '
NR>1 {
    gsub(/%/, "", $5)
    if ($5 > THRESHOLD) {
        print "WARNING: " $6 " 使用率 " $5 "%"
    }
}'
```

**监控告警级别**：
- 🟢 **正常状态**: < 80%
- 🟡 **注意状态**: 80% - 90%
- 🟠 **警告状态**: 90% - 95%
- 🔴 **紧急状态**: > 95%

### 4.2 自动清理机制


**二进制日志自动清理配置**：
```sql
-- 设置二进制日志保留天数
SET GLOBAL expire_logs_days = 7;

-- 写入配置文件 /etc/mysql/my.cnf
[mysqld]
expire_logs_days = 7          # 保留7天
max_binlog_size = 100M        # 单个日志文件最大100MB
```

**系统定时清理脚本**：
```bash
#!/bin/bash
# /etc/cron.daily/mysql-cleanup.sh

# 清理7天前的二进制日志
mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"

# 清理临时文件
find /tmp -name "#sql_*" -mtime +1 -delete
find /tmp -name "ML*" -mtime +1 -delete

# 压缩旧日志
find /var/log/mysql -name "*.log.*" -mtime +7 -exec gzip {} \;
```

### 4.3 空间预警机制


**预警脚本实现**：
```bash
#!/bin/bash
# 磁盘空间预警脚本

MYSQL_DATA_DIR="/var/lib/mysql"
EMAIL="admin@company.com"
WARNING_THRESHOLD=80
CRITICAL_THRESHOLD=90

# 获取磁盘使用率
USAGE=$(df $MYSQL_DATA_DIR | awk 'NR==2 {gsub(/%/, "", $5); print $5}')

if [ $USAGE -gt $CRITICAL_THRESHOLD ]; then
    echo "CRITICAL: MySQL磁盘使用率 ${USAGE}%" | mail -s "MySQL磁盘空间紧急告警" $EMAIL
elif [ $USAGE -gt $WARNING_THRESHOLD ]; then
    echo "WARNING: MySQL磁盘使用率 ${USAGE}%" | mail -s "MySQL磁盘空间告警" $EMAIL
fi
```

### 4.4 容量规划策略


**增长趋势分析**：
```sql
-- 创建空间使用历史表
CREATE TABLE disk_usage_history (
    record_date DATE,
    database_name VARCHAR(64),
    size_mb DECIMAL(15,2),
    growth_mb DECIMAL(15,2)
);

-- 定期记录数据库大小
INSERT INTO disk_usage_history 
SELECT 
    CURDATE(),
    table_schema,
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2),
    0
FROM information_schema.tables 
GROUP BY table_schema;
```

**容量预测公式**：
```
预计天数 = (可用空间 / 日均增长量)
```

---

## 5. 🔧 长期解决方案


### 5.1 存储架构优化


**分离存储策略**：
```
数据存储架构优化：

原始架构：
/var/lib/mysql/  (所有数据在一个磁盘)
├── 数据文件
├── 日志文件
└── 临时文件

优化架构：
/var/lib/mysql/         (SSD - 热数据)
├── 系统数据库
└── 核心业务表

/data/mysql_archive/    (HDD - 冷数据)
├── 历史数据表
└── 归档数据

/logs/mysql/           (独立磁盘 - 日志)
├── 二进制日志
├── 错误日志
└── 慢查询日志
```

**表空间管理策略**：
```sql
-- 独立表空间配置
SET GLOBAL innodb_file_per_table = ON;

-- 创建独立表空间的表
CREATE TABLE large_table (
    id INT PRIMARY KEY,
    data TEXT
) TABLESPACE = innodb_file_per_table;
```

### 5.2 数据生命周期管理


**数据分层存储**：
```sql
-- 热数据表(最近3个月)
CREATE TABLE orders_hot AS 
SELECT * FROM orders 
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 温数据表(3-12个月)
CREATE TABLE orders_warm AS 
SELECT * FROM orders 
WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 12 MONTH) 
                      AND DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 冷数据表(12个月以前)
CREATE TABLE orders_cold AS 
SELECT * FROM orders 
WHERE create_time < DATE_SUB(NOW(), INTERVAL 12 MONTH);
```

**自动归档机制**：
```bash
#!/bin/bash
# 数据自动归档脚本

# 导出12个月前的数据
mysqldump --where="create_time < DATE_SUB(NOW(), INTERVAL 12 MONTH)" \
          database_name table_name > archive_$(date +%Y%m%d).sql

# 删除已归档的数据
mysql -e "DELETE FROM table_name 
           WHERE create_time < DATE_SUB(NOW(), INTERVAL 12 MONTH);"

# 优化表空间
mysql -e "OPTIMIZE TABLE table_name;"
```

### 5.3 配置优化


**关键参数配置**：
```ini
# /etc/mysql/my.cnf
[mysqld]
# 二进制日志管理
expire_logs_days = 7                    # 自动清理7天前的日志
max_binlog_size = 100M                  # 单个日志文件大小限制

# InnoDB配置
innodb_file_per_table = ON              # 独立表空间
innodb_autoextend_increment = 64        # 自动扩展增量(MB)

# 临时文件配置
tmp_table_size = 64M                    # 内存临时表大小
max_heap_table_size = 64M               # 内存表最大大小

# 查询缓存(如果启用)
query_cache_size = 128M                 # 查询缓存大小
```

### 5.4 备份策略优化


**差异化备份策略**：
```bash
# 完整备份(每周一次)
mysqldump --single-transaction --routines --triggers \
          --all-databases > full_backup_$(date +%Y%m%d).sql

# 增量备份(每日)
mysqlbinlog --start-datetime="$(date -d '1 day ago' '+%Y-%m-%d %H:%M:%S')" \
            /var/lib/mysql/mysql-bin.* > incremental_$(date +%Y%m%d).sql

# 自动清理旧备份
find /backup -name "*.sql" -mtime +30 -delete
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的关键知识


```
🔸 故障识别：No space left on device 是最明显的信号
🔸 诊断方法：df -h 查看磁盘使用率，du -sh 定位大文件
🔸 紧急处理：优先清理二进制日志和临时文件
🔸 预防监控：设置85%告警阈值，建立自动清理机制
🔸 长期方案：分离存储、数据归档、容量规划
```

### 6.2 故障处理优先级


**🚨 紧急处理顺序**：
```
1. 清理二进制日志 → 快速释放大量空间
2. 清理临时文件 → 风险最小的操作
3. 压缩日志文件 → 适中的空间释放
4. 数据迁移 → 最后选择，风险较高
```

### 6.3 预防策略要点


**📊 监控指标**：
- **磁盘使用率**: < 90%
- **日志文件大小**: 定期检查
- **数据增长趋势**: 月度分析
- **临时文件清理**: 每日自动执行

**🔧 配置要点**：
- `expire_logs_days = 7` - 自动清理日志
- `innodb_file_per_table = ON` - 独立表空间
- `max_binlog_size = 100M` - 限制单个日志大小

### 6.4 实际操作建议


**💡 最佳实践**：
- **定期检查** - 每周检查磁盘使用情况
- **自动清理** - 设置定时任务自动清理日志
- **容量规划** - 根据业务增长预估空间需求
- **分离存储** - 数据、日志、备份分别存储

**⚠️ 关键提醒**：
- 生产环境操作前必须备份
- 清理日志前确认主从同步状态
- 数据迁移操作需要停机维护
- 建立完整的监控告警机制

**核心记忆口诀**：
```
磁盘空间要监控，日志清理是关键
临时文件常清理，数据归档做规划
告警机制要建立，预防胜过治疗法
```