---
title: 3、MySQL状态查询与诊断命令
---
## 📚 目录

1. [MySQL诊断命令概述](#1-MySQL诊断命令概述)
2. [SHOW STATUS命令详解](#2-SHOW-STATUS命令详解)
3. [SHOW PROCESSLIST进程查看](#3-SHOW-PROCESSLIST进程查看)
4. [SHOW ENGINE INNODB STATUS分析](#4-SHOW-ENGINE-INNODB-STATUS分析)
5. [SHOW VARIABLES配置查看](#5-SHOW-VARIABLES配置查看)
6. [INFORMATION_SCHEMA系统表](#6-INFORMATION_SCHEMA系统表)
7. [PERFORMANCE_SCHEMA性能表](#7-PERFORMANCE_SCHEMA性能表)
8. [诊断SQL语句集合](#8-诊断SQL语句集合)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 MySQL诊断命令概述


### 1.1 什么是MySQL诊断命令


**简单理解**：MySQL诊断命令就像是医生给病人体检用的各种仪器和检查手段

```
医生体检         MySQL诊断
├─ 测血压        ├─ SHOW STATUS (查看运行状态)
├─ 听心跳        ├─ SHOW PROCESSLIST (查看正在执行的任务)
├─ 查血常规      ├─ SHOW ENGINE STATUS (查看存储引擎状态)
├─ 测体温        ├─ SHOW VARIABLES (查看配置参数)
└─ X光片         └─ 查看系统表 (深度分析)
```

### 1.2 为什么需要诊断命令


**核心作用**：
- 📊 **实时监控** - 了解MySQL当前运行状况
- 🐛 **故障排查** - 找出性能问题和错误原因  
- ⚡ **性能优化** - 发现性能瓶颈和优化点
- 📈 **容量规划** - 评估资源使用情况

> 💡 **通俗比喻**
> 
> MySQL诊断命令就像汽车仪表盘，通过各种指示灯和数值，让你知道发动机转速、油耗、水温等关键信息，帮你判断车子是否正常运行

### 1.3 诊断命令分类


```
MySQL诊断工具箱
├─ 📊 状态查看类
│   ├─ SHOW STATUS - 运行统计数据
│   └─ SHOW ENGINE STATUS - 存储引擎状态
├─ 🔍 进程监控类  
│   ├─ SHOW PROCESSLIST - 当前连接和查询
│   └─ SHOW FULL PROCESSLIST - 完整进程信息
├─ ⚙️ 配置查看类
│   └─ SHOW VARIABLES - 系统配置参数
└─ 📋 系统表查询类
    ├─ INFORMATION_SCHEMA - 元数据信息
    └─ PERFORMANCE_SCHEMA - 性能监控数据
```

---

## 2. 📊 SHOW STATUS命令详解


### 2.1 SHOW STATUS基本概念


**什么是SHOW STATUS**：
SHOW STATUS用来查看MySQL服务器的运行统计信息，就像查看一个工厂的生产报表

**基本语法**：
```sql
-- 查看所有状态变量
SHOW STATUS;

-- 查看全局状态(所有连接的累计)
SHOW GLOBAL STATUS;

-- 查看当前会话状态
SHOW SESSION STATUS;

-- 按条件筛选
SHOW STATUS LIKE 'pattern%';
```

### 2.2 核心状态变量详解


#### 🔗 连接相关状态


```sql
-- 查看连接统计
SHOW GLOBAL STATUS LIKE 'Connections';
SHOW GLOBAL STATUS LIKE 'Max_used_connections';
SHOW GLOBAL STATUS LIKE 'Threads_connected';
```

| 状态变量 | 含义解释 | 正常范围 |
|----------|----------|----------|
| `Connections` | 总连接次数(累计) | 持续增长 |
| `Max_used_connections` | 历史最大并发连接数 | < max_connections的80% |
| `Threads_connected` | 当前连接数 | 根据业务需求 |
| `Aborted_connects` | 失败的连接次数 | 越少越好 |

**实际例子**：
```sql
-- 检查连接使用率
SELECT 
    VARIABLE_VALUE as current_connections,
    $$max_connections as max_connections,
    ROUND(VARIABLE_VALUE/$$max_connections*100,2) as usage_percent
FROM information_schema.GLOBAL_STATUS 
WHERE VARIABLE_NAME='Threads_connected';
```

#### 📊 查询执行统计


```sql
-- 查看SQL执行统计
SHOW GLOBAL STATUS LIKE 'Com_select';     -- SELECT语句执行次数
SHOW GLOBAL STATUS LIKE 'Com_insert';     -- INSERT语句执行次数  
SHOW GLOBAL STATUS LIKE 'Com_update';     -- UPDATE语句执行次数
SHOW GLOBAL STATUS LIKE 'Com_delete';     -- DELETE语句执行次数
```

**读写比例分析**：
```sql
-- 计算读写比例
SELECT 
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Com_select') as selects,
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Com_insert') +
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Com_update') +
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Com_delete') as writes;
```

#### 💾 缓存命中率


```sql
-- 查询缓存相关
SHOW GLOBAL STATUS LIKE 'Qcache%';

-- InnoDB缓冲池命中率
SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool%';
```

**缓冲池命中率计算**：
```sql
-- InnoDB缓冲池命中率(应该>95%)
SELECT 
    ROUND((1 - (Innodb_buffer_pool_reads / Innodb_buffer_pool_read_requests)) * 100, 2) as hit_rate
FROM (
    SELECT 
        VARIABLE_VALUE as Innodb_buffer_pool_reads
    FROM information_schema.GLOBAL_STATUS 
    WHERE VARIABLE_NAME='Innodb_buffer_pool_reads'
) t1,
(
    SELECT 
        VARIABLE_VALUE as Innodb_buffer_pool_read_requests
    FROM information_schema.GLOBAL_STATUS 
    WHERE VARIABLE_NAME='Innodb_buffer_pool_read_requests'  
) t2;
```

### 2.3 常用状态监控脚本


```sql
-- 快速健康检查脚本
SELECT 
    'Connections' as metric,
    VARIABLE_VALUE as current_value,
    '当前连接数' as description
FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected'

UNION ALL

SELECT 
    'QPS',
    ROUND(VARIABLE_VALUE/$$uptime, 2),
    '每秒查询数'
FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Questions'

UNION ALL

SELECT 
    'Slow_queries',
    VARIABLE_VALUE,
    '慢查询数量'
FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Slow_queries';
```

---

## 3. 👥 SHOW PROCESSLIST进程查看


### 3.1 SHOW PROCESSLIST基本概念


**什么是PROCESSLIST**：
就像任务管理器显示正在运行的程序一样，SHOW PROCESSLIST显示MySQL中正在执行的所有连接和查询

**基本用法**：
```sql
-- 查看当前进程(只显示前100个字符的SQL)
SHOW PROCESSLIST;

-- 查看完整进程信息
SHOW FULL PROCESSLIST;
```

### 3.2 进程列表字段解释


```
进程信息字段说明:
┌─────────┬──────────┬─────────┬──────────┬─────────┬──────┬───────┬──────────┐
│   Id    │   User   │  Host   │    db    │ Command │ Time │ State │   Info   │
├─────────┼──────────┼─────────┼──────────┼─────────┼──────┼───────┼──────────┤
│ 进程ID  │  用户名  │ 客户端  │ 数据库名 │ 命令类型│ 耗时 │ 状态  │ SQL语句  │
└─────────┴──────────┴─────────┴──────────┴─────────┴──────┴───────┴──────────┘
```

| 字段 | 含义说明 | 示例值 |
|------|----------|--------|
| **Id** | 连接ID，可用于KILL操作 | 12345 |
| **User** | 连接的用户名 | root, app_user |
| **Host** | 客户端IP和端口 | localhost:3306 |
| **db** | 当前使用的数据库 | test, app_db |
| **Command** | 当前执行的命令类型 | Query, Sleep |
| **Time** | 命令执行时间(秒) | 0, 120 |
| **State** | 当前状态 | Sending data |
| **Info** | 正在执行的SQL语句 | SELECT * FROM... |

### 3.3 常见Command类型


```sql
-- 不同的连接状态
Sleep          -- 连接空闲，等待下个命令
Query          -- 正在执行查询
Connect        -- 正在连接
Quit           -- 正在断开连接
Kill           -- 正在终止其他连接
```

> ⚠️ **注意**
> 
> - **Sleep状态过多** - 可能存在连接池配置问题
> - **长时间Query** - 可能是慢查询或锁等待
> - **大量Connect** - 可能是连接创建过于频繁

### 3.4 实用查询技巧


#### 🔍 查找问题连接


```sql
-- 查找运行时间超过60秒的查询
SELECT * FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep' AND TIME > 60;

-- 查找正在执行的SELECT查询
SELECT ID, USER, HOST, DB, TIME, INFO 
FROM information_schema.PROCESSLIST 
WHERE COMMAND = 'Query' AND INFO LIKE 'SELECT%';

-- 查找锁等待
SELECT * FROM information_schema.PROCESSLIST 
WHERE STATE LIKE '%lock%';
```

#### 🚫 终止问题连接


```sql
-- 终止特定连接
KILL 12345;

-- 批量终止长时间运行的查询
SELECT CONCAT('KILL ', ID, ';') as kill_sql
FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep' AND TIME > 300;
```

> 🔥 **重要提醒**
> 
> 使用KILL命令要谨慎，确保不会影响正常业务

### 3.5 进程监控脚本


```sql
-- 连接状态统计
SELECT 
    COMMAND,
    COUNT(*) as count,
    AVG(TIME) as avg_time
FROM information_schema.PROCESSLIST 
GROUP BY COMMAND 
ORDER BY count DESC;

-- 每个用户的连接数
SELECT 
    USER,
    COUNT(*) as connections,
    SUM(TIME) as total_time
FROM information_schema.PROCESSLIST 
GROUP BY USER;
```

---

## 4. 🏗️ SHOW ENGINE INNODB STATUS分析


### 4.1 InnoDB状态报告概述


**什么是InnoDB STATUS**：
这是InnoDB存储引擎的"体检报告"，包含了事务、锁、缓冲池、IO等各方面的详细信息

```sql
-- 查看InnoDB详细状态
SHOW ENGINE INNODB STATUS\G
```

> 💡 **为什么重要**
> 
> InnoDB是MySQL最重要的存储引擎，大部分性能问题都与InnoDB相关

### 4.2 InnoDB状态报告结构


```
InnoDB状态报告内容:
├─ 📊 BACKGROUND THREAD (后台线程信息)
├─ 💾 BUFFER POOL AND MEMORY (缓冲池和内存)  
├─ 🔄 TRANSACTIONS (事务信息)
├─ 🔒 DEADLOCKS (死锁信息)
├─ 📁 FILE I/O (文件IO统计)
├─ 📝 LOG (日志信息)
└─ 🔍 ROW OPERATIONS (行操作统计)
```

### 4.3 关键指标解读


#### 💾 缓冲池状态


```
Buffer pool size   8192        # 缓冲池总页数(每页16KB)
Free buffers       1024        # 空闲页数  
Database pages     7000        # 数据页数
Old database pages 2590        # 老化页数
```

**缓冲池健康度计算**：
```sql
-- 缓冲池使用率
使用率 = (总页数 - 空闲页数) / 总页数 * 100%
正常范围: 70% - 95%
```

#### 🔄 事务和锁信息


```
Trx id counter 12345           # 事务ID计数器
Purge done for trx's n:o < 12340  # 已清理的事务
History list length 10         # 历史列表长度(未提交事务数)
```

**关键指标说明**：
- **History list length** - 如果数值很大(>1000)，说明有长事务阻塞清理
- **锁等待时间** - 如果经常出现锁等待，需要优化查询

#### 📁 IO性能指标


```
Pending normal aio reads: 0    # 等待的异步读取
Pending normal aio writes: 0   # 等待的异步写入
Ibuf: size 1, free list len 0  # 插入缓冲信息
```

### 4.4 常见问题诊断


#### 🐌 发现慢查询问题


```sql
-- 查看当前长事务
SELECT 
    trx_id,
    trx_started,
    trx_query,
    TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) as duration_seconds
FROM information_schema.INNODB_TRX 
WHERE TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) > 60;
```

#### 🔒 死锁分析


当出现死锁时，InnoDB STATUS会显示最近的死锁信息：
```
LATEST DETECTED DEADLOCK
------------------------
2023-12-06 10:30:15 0x7f8a1c000700
*** (1) TRANSACTION:
TRANSACTION 421147827686744, ACTIVE 0 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s)
```

---

## 5. ⚙️ SHOW VARIABLES配置查看


### 5.1 系统变量基本概念


**什么是系统变量**：
MySQL的配置参数，就像操作系统的设置选项，控制MySQL的行为和性能

```sql
-- 查看所有系统变量
SHOW VARIABLES;

-- 查看全局变量
SHOW GLOBAL VARIABLES;

-- 查看会话变量
SHOW SESSION VARIABLES;

-- 按模式查找
SHOW VARIABLES LIKE 'innodb%';
```

### 5.2 重要配置参数分类


#### 🔗 连接和网络配置


```sql
-- 连接相关参数
SHOW VARIABLES LIKE 'max_connections';        -- 最大连接数
SHOW VARIABLES LIKE 'max_connect_errors';     -- 最大连接错误数
SHOW VARIABLES LIKE 'connect_timeout';        -- 连接超时时间
SHOW VARIABLES LIKE 'wait_timeout';           -- 连接空闲超时
SHOW VARIABLES LIKE 'interactive_timeout';    -- 交互式连接超时
```

| 参数 | 默认值 | 推荐设置 | 说明 |
|------|--------|----------|------|
| `max_connections` | 151 | 根据硬件调整 | 最大并发连接数 |
| `wait_timeout` | 28800秒 | 300-600秒 | 非交互连接超时 |
| `interactive_timeout` | 28800秒 | 3600秒 | 交互连接超时 |

#### 💾 内存相关配置


```sql
-- InnoDB内存配置
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';     -- 缓冲池大小
SHOW VARIABLES LIKE 'innodb_log_buffer_size';      -- 日志缓冲区大小

-- 查询缓存配置  
SHOW VARIABLES LIKE 'query_cache_size';            -- 查询缓存大小
SHOW VARIABLES LIKE 'query_cache_type';            -- 查询缓存类型

-- 排序和连接缓冲区
SHOW VARIABLES LIKE 'sort_buffer_size';            -- 排序缓冲区
SHOW VARIABLES LIKE 'join_buffer_size';            -- 连接缓冲区
```

**内存配置建议**：
```
服务器内存分配建议:
├─ InnoDB缓冲池: 物理内存的 70-80%
├─ 操作系统: 物理内存的 10-15%  
├─ MySQL其他组件: 物理内存的 5-10%
└─ 应用程序: 剩余内存
```

#### 📊 日志和性能配置


```sql
-- 慢查询日志
SHOW VARIABLES LIKE 'slow_query_log';           -- 是否开启慢查询日志
SHOW VARIABLES LIKE 'long_query_time';          -- 慢查询阈值(秒)
SHOW VARIABLES LIKE 'slow_query_log_file';      -- 慢查询日志文件

-- InnoDB日志配置
SHOW VARIABLES LIKE 'innodb_log_file_size';     -- 重做日志文件大小
SHOW VARIABLES LIKE 'innodb_flush_log_at_trx_commit';  -- 事务提交刷盘策略
```

### 5.3 配置优化检查脚本


```sql
-- 关键配置检查
SELECT 
    'max_connections' as parameter,
    $$max_connections as current_value,
    'Connection limit' as description
UNION ALL
SELECT 
    'innodb_buffer_pool_size',
    ROUND($$innodb_buffer_pool_size/1024/1024/1024, 2),
    'InnoDB buffer pool (GB)'
UNION ALL  
SELECT 
    'long_query_time',
    $$long_query_time,
    'Slow query threshold (seconds)';
```

---

## 6. 📋 INFORMATION_SCHEMA系统表


### 6.1 INFORMATION_SCHEMA概述


**什么是INFORMATION_SCHEMA**：
MySQL的"数据字典"，存储了数据库的元数据信息，就像图书馆的目录索引

```
INFORMATION_SCHEMA包含的信息:
├─ 📚 数据库和表结构信息
├─ 🔍 索引和约束信息
├─ 👥 用户权限信息
├─ 🔄 存储引擎信息
└─ 📊 统计信息
```

### 6.2 常用系统表详解


#### 📊 统计信息表


```sql
-- 查看表大小和行数
SELECT 
    TABLE_SCHEMA as database_name,
    TABLE_NAME as table_name,
    TABLE_ROWS as row_count,
    ROUND(DATA_LENGTH/1024/1024, 2) as data_size_mb,
    ROUND(INDEX_LENGTH/1024/1024, 2) as index_size_mb
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA NOT IN ('information_schema', 'mysql', 'performance_schema')
ORDER BY DATA_LENGTH DESC;
```

#### 🔍 索引使用情况


```sql
-- 查看从未使用的索引
SELECT 
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    t.INDEX_NAME
FROM information_schema.STATISTICS t
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage p 
    ON t.TABLE_SCHEMA = p.OBJECT_SCHEMA 
    AND t.TABLE_NAME = p.OBJECT_NAME 
    AND t.INDEX_NAME = p.INDEX_NAME
WHERE p.INDEX_NAME IS NULL 
    AND t.TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema');
```

#### 👥 连接和会话信息


```sql
-- 查看当前连接详细信息
SELECT 
    ID,
    USER,
    HOST,
    DB,
    COMMAND,
    TIME,
    STATE,
    LEFT(INFO, 50) as SQL_TEXT
FROM information_schema.PROCESSLIST 
WHERE COMMAND != 'Sleep';
```

### 6.3 实用查询模板


#### 📈 数据库空间使用分析


```sql
-- 各数据库空间使用情况
SELECT 
    TABLE_SCHEMA as database_name,
    COUNT(*) as table_count,
    SUM(TABLE_ROWS) as total_rows,
    ROUND(SUM(DATA_LENGTH)/1024/1024/1024, 2) as data_gb,
    ROUND(SUM(INDEX_LENGTH)/1024/1024/1024, 2) as index_gb,
    ROUND((SUM(DATA_LENGTH) + SUM(INDEX_LENGTH))/1024/1024/1024, 2) as total_gb
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA NOT IN ('information_schema', 'mysql', 'performance_schema')
GROUP BY TABLE_SCHEMA
ORDER BY total_gb DESC;
```

#### 🔍 表结构分析


```sql
-- 查看大表TOP10
SELECT 
    CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) as full_table_name,
    TABLE_ROWS,
    ROUND(DATA_LENGTH/1024/1024, 2) as data_mb,
    ROUND(INDEX_LENGTH/1024/1024, 2) as index_mb,
    ENGINE
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA NOT IN ('information_schema', 'mysql', 'performance_schema')
ORDER BY DATA_LENGTH DESC 
LIMIT 10;
```

---

## 7. 📈 PERFORMANCE_SCHEMA性能表


### 7.1 PERFORMANCE_SCHEMA概述


**什么是PERFORMANCE_SCHEMA**：
MySQL的"性能监控中心"，专门收集性能相关的统计数据，就像汽车的行车电脑

> 💡 **注意**
> 
> PERFORMANCE_SCHEMA在MySQL 5.6+版本才完善，需要开启相关配置

```sql
-- 检查是否启用
SHOW VARIABLES LIKE 'performance_schema';
```

### 7.2 重要性能表分类


#### 🔍 SQL语句性能分析


```sql
-- 查看执行最慢的SQL
SELECT 
    DIGEST_TEXT as sql_text,
    COUNT_STAR as exec_count,
    AVG_TIMER_WAIT/1000000000 as avg_time_sec,
    MAX_TIMER_WAIT/1000000000 as max_time_sec,
    SUM_ROWS_EXAMINED as total_rows_examined
FROM performance_schema.events_statements_summary_by_digest 
ORDER BY AVG_TIMER_WAIT DESC 
LIMIT 10;
```

#### 📊 表和索引IO统计


```sql
-- 表IO性能统计
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    COUNT_READ,
    COUNT_WRITE,
    SUM_TIMER_READ/1000000000 as read_time_sec,
    SUM_TIMER_WRITE/1000000000 as write_time_sec
FROM performance_schema.table_io_waits_summary_by_table 
WHERE OBJECT_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema')
ORDER BY SUM_TIMER_READ + SUM_TIMER_WRITE DESC;
```

#### 🔐 锁等待分析


```sql
-- 查看锁等待情况
SELECT 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    LOCK_TYPE,
    LOCK_DURATION,
    COUNT_STAR as lock_count,
    SUM_TIMER_WAIT/1000000000 as total_wait_sec
FROM performance_schema.table_lock_waits_summary_by_table 
ORDER BY SUM_TIMER_WAIT DESC;
```

### 7.3 性能监控脚本


```sql
-- 综合性能检查
SELECT 
    'Top CPU SQL' as metric,
    DIGEST_TEXT as details,
    ROUND(SUM_TIMER_WAIT/1000000000, 2) as value
FROM performance_schema.events_statements_summary_by_digest 
ORDER BY SUM_TIMER_WAIT DESC LIMIT 1

UNION ALL

SELECT 
    'Most Executed SQL',
    LEFT(DIGEST_TEXT, 50),
    COUNT_STAR
FROM performance_schema.events_statements_summary_by_digest 
ORDER BY COUNT_STAR DESC LIMIT 1;
```

---

## 8. 🛠️ 诊断SQL语句集合


### 8.1 快速健康检查脚本


```sql
-- MySQL健康检查一键脚本
-- 1. 基本信息
SELECT 
    '=== 基本信息 ===' as category,
    'MySQL版本' as item,
    $$version as value
UNION ALL
SELECT '基本信息', '运行时间(小时)', ROUND($$uptime/3600, 2)
UNION ALL  
SELECT '基本信息', '当前时间', NOW()

UNION ALL

-- 2. 连接状态
SELECT 
    '=== 连接状态 ===' as category,
    '当前连接数' as item,
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected') as value
UNION ALL
SELECT '连接状态', '最大连接数', $$max_connections
UNION ALL
SELECT '连接状态', '历史最大连接', (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Max_used_connections')

UNION ALL

-- 3. 性能指标
SELECT 
    '=== 性能指标 ===' as category,
    'QPS(每秒查询)', 
    ROUND((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Questions')/$$uptime, 2)
UNION ALL
SELECT '性能指标', '慢查询数', (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Slow_queries')
UNION ALL
SELECT '性能指标', '慢查询阈值(秒)', $$long_query_time;
```

### 8.2 性能问题排查脚本


```sql
-- 查找性能瓶颈
-- 1. 找出正在运行的慢查询
SELECT 
    'Current Slow Queries' as check_type,
    ID as process_id,
    USER,
    HOST,
    DB,
    TIME as duration_sec,
    LEFT(INFO, 100) as sql_text
FROM information_schema.PROCESSLIST 
WHERE COMMAND = 'Query' AND TIME > 5;

-- 2. 检查锁等待
SELECT 
    'Lock Waits' as check_type,
    ID,
    USER,
    HOST,
    DB,
    TIME,
    STATE
FROM information_schema.PROCESSLIST 
WHERE STATE LIKE '%lock%';

-- 3. 检查连接数使用率
SELECT 
    'Connection Usage' as check_type,
    CONCAT(
        ROUND(
            (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected') / 
            $$max_connections * 100, 2
        ), '%'
    ) as usage_rate,
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected') as current_conn,
    $$max_connections as max_conn;
```

### 8.3 日常监控脚本


```sql
-- 创建监控视图
CREATE OR REPLACE VIEW mysql_health_monitor AS
SELECT 
    'connections' as metric,
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected') as current_value,
    $$max_connections as max_value,
    ROUND((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Threads_connected')/$$max_connections*100, 2) as usage_percent

UNION ALL

SELECT 
    'qps',
    ROUND((SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Questions')/$$uptime, 2),
    NULL,
    NULL

UNION ALL

SELECT 
    'slow_queries',
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS WHERE VARIABLE_NAME='Slow_queries'),
    NULL,
    NULL;

-- 使用监控视图
SELECT * FROM mysql_health_monitor;
```

### 8.4 故障排查清单


**🔍 系统化排查步骤**：

```
MySQL故障排查清单:

1️⃣ 基础检查
   ☑️ 检查MySQL服务状态
   ☑️ 查看错误日志
   ☑️ 确认磁盘空间

2️⃣ 连接问题  
   ☑️ 检查当前连接数
   ☑️ 查看连接使用率
   ☑️ 检查网络连通性

3️⃣ 性能问题
   ☑️ 查看慢查询日志
   ☑️ 检查锁等待情况
   ☑️ 分析缓冲池命中率

4️⃣ 资源问题
   ☑️ 检查CPU使用率
   ☑️ 检查内存使用情况
   ☑️ 检查磁盘IO
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心命令


```
🔥 最重要的诊断命令:
├─ SHOW PROCESSLIST        ← 查看当前执行的查询
├─ SHOW GLOBAL STATUS      ← 查看运行状态统计  
├─ SHOW ENGINE INNODB STATUS ← 查看InnoDB详细状态
├─ SHOW VARIABLES          ← 查看配置参数
└─ 查询系统表             ← 深度分析工具
```

### 9.2 关键指标理解


**🎯 核心监控指标**：
- **连接数** - 当前连接/最大连接比例
- **QPS** - 每秒查询数，评估负载
- **慢查询** - 超过阈值的查询数量
- **缓冲池命中率** - 内存使用效率
- **锁等待** - 并发冲突情况

### 9.3 故障排查思路


**📊 系统化诊断流程**：

```
故障排查思路:
问题发现 → 收集信息 → 分析定位 → 解决问题 → 验证效果

具体步骤:
1. 现象描述: 慢、卡、报错、连不上
2. 收集信息: 用诊断命令收集数据
3. 分析定位: 根据数据找出根因  
4. 解决问题: 调整配置或优化SQL
5. 验证效果: 再次检查确认恢复
```

### 9.4 实际应用建议


**💡 最佳实践**：
- **定期检查** - 每天执行健康检查脚本
- **建立基线** - 记录正常情况下的各项指标
- **监控告警** - 设置关键指标的阈值告警
- **文档记录** - 记录每次故障的原因和解决方法

**⚠️ 注意事项**：
- 生产环境使用KILL命令要谨慎
- 大量诊断查询可能影响性能
- 重要操作前要做好备份
- 配置修改后要重启MySQL服务

**核心记忆**：
- 诊断命令是MySQL管理的基础工具
- 理解每个指标的含义比记住命令更重要  
- 系统化的排查思路比零散的技巧更有效
- 预防胜于治疗，日常监控很关键