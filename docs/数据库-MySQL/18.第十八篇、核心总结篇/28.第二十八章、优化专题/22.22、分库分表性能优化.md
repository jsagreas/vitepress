---
title: 22ã€åˆ†åº“åˆ†è¡¨æ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [åˆ†åº“åˆ†è¡¨åŸºç¡€æ¦‚å¿µ](#1-åˆ†åº“åˆ†è¡¨åŸºç¡€æ¦‚å¿µ)
2. [åˆ†åº“åˆ†è¡¨ç­–ç•¥è®¾è®¡](#2-åˆ†åº“åˆ†è¡¨ç­–ç•¥è®¾è®¡)
3. [åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™](#3-åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™)
4. [è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–](#4-è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–)
5. [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](#5-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†)
6. [æ•°æ®è¿ç§»æ€§èƒ½](#6-æ•°æ®è¿ç§»æ€§èƒ½)
7. [åˆ†ç‰‡æ•°æ®å‡è¡¡](#7-åˆ†ç‰‡æ•°æ®å‡è¡¡)
8. [åˆ†ç‰‡è·¯ç”±ä¼˜åŒ–](#8-åˆ†ç‰‡è·¯ç”±ä¼˜åŒ–)
9. [åˆ†ç‰‡æ€§èƒ½ç›‘æ§](#9-åˆ†ç‰‡æ€§èƒ½ç›‘æ§)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š åˆ†åº“åˆ†è¡¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨


**ğŸ”¸ ç®€å•ç†è§£**
```
æƒ³è±¡ä¸€ä¸‹å›¾ä¹¦é¦†çš„ç®¡ç†ï¼š
åŸæ¥ï¼šæ‰€æœ‰ä¹¦éƒ½æ”¾åœ¨ä¸€ä¸ªå¤§ä¹¦åº“é‡Œ
é—®é¢˜ï¼šä¹¦è¶Šæ¥è¶Šå¤šï¼Œæ‰¾ä¹¦è¶Šæ¥è¶Šæ…¢ï¼Œç®¡ç†å‘˜ç´¯å¾—è¦æ­»

åˆ†åº“åˆ†è¡¨å°±åƒï¼š
åˆ†åº“ï¼šå»ºç«‹å¤šä¸ªåˆ†é¦†ï¼ŒæŒ‰åœ°åŒºåˆ†å¸ƒ
åˆ†è¡¨ï¼šæ¯ä¸ªé¦†å†…æŒ‰ç±»åˆ«åˆ†åŒºåŸŸ
ç»“æœï¼šæ‰¾ä¹¦æ›´å¿«ï¼Œç®¡ç†æ›´è½»æ¾
```

**æ ¸å¿ƒå®šä¹‰**ï¼š
- **åˆ†åº“ï¼ˆæ°´å¹³åˆ†åº“ï¼‰**ï¼šæŠŠä¸€ä¸ªæ•°æ®åº“çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“ä¸­
- **åˆ†è¡¨ï¼ˆæ°´å¹³åˆ†è¡¨ï¼‰**ï¼šæŠŠä¸€å¼ å¤§è¡¨çš„æ•°æ®åˆ†æ•£åˆ°å¤šå¼ è¡¨ä¸­
- **ç›®æ ‡**ï¼šè§£å†³å•è¡¨æ•°æ®é‡è¿‡å¤§å¯¼è‡´çš„æ€§èƒ½é—®é¢˜

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨


**ğŸš¨ å•è¡¨æ€§èƒ½ç“¶é¢ˆ**
```
æ€§èƒ½ä¸‹é™çš„ä¸´ç•Œç‚¹ï¼š
- MyISAMå¼•æ“ï¼š500ä¸‡-1000ä¸‡æ¡è®°å½•
- InnoDBå¼•æ“ï¼š2000ä¸‡-5000ä¸‡æ¡è®°å½•
- è¶…è¿‡è¿™ä¸ªé‡çº§ï¼ŒæŸ¥è¯¢é€Ÿåº¦æ˜æ˜¾ä¸‹é™

å®é™…æ¡ˆä¾‹ï¼š
ç”¨æˆ·è¡¨1000ä¸‡æ¡è®°å½•ï¼š
SELECT * FROM users WHERE age > 25;
æ‰§è¡Œæ—¶é—´ï¼š15ç§’

åˆ†æˆ10ä¸ªè¡¨åï¼Œæ¯è¡¨100ä¸‡è®°å½•ï¼š
SELECT * FROM users_1 WHERE age > 25;
æ‰§è¡Œæ—¶é—´ï¼š0.5ç§’
```

**ğŸ“ˆ ä¸šåŠ¡å¢é•¿å‹åŠ›**
```
ç”µå•†ç½‘ç«™è®¢å•è¡¨å¢é•¿ï¼š
ç¬¬1å¹´ï¼š100ä¸‡è®¢å•
ç¬¬3å¹´ï¼š5000ä¸‡è®¢å•  â† æŸ¥è¯¢å˜æ…¢
ç¬¬5å¹´ï¼š2äº¿è®¢å•     â† ç³»ç»Ÿå¡æ­»

ç¤¾äº¤å¹³å°ç”¨æˆ·æ•°æ®ï¼š
æ³¨å†Œç”¨æˆ·ï¼š1000ä¸‡
æ´»è·ƒç”¨æˆ·ï¼š500ä¸‡
æ¯æ—¥æ–°å¢ï¼š10ä¸‡    â† æ•°æ®å¢é•¿å¤ªå¿«
```

### 1.3 åˆ†åº“åˆ†è¡¨çš„åŸºæœ¬ç±»å‹


**å‚ç›´æ‹†åˆ† vs æ°´å¹³æ‹†åˆ†**

```
å‚ç›´æ‹†åˆ†ï¼ˆæŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ï¼‰ï¼š
åŸæ¥çš„å¤§è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users (ç”¨æˆ·ä¿¡æ¯å¤§å…¨è¡¨)    â”‚
â”‚ - id, name, email       â”‚
â”‚ - phone, address        â”‚
â”‚ - login_time, ip        â”‚
â”‚ - order_count, balance  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‚ç›´æ‹†åˆ†åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_basic   â”‚  â”‚ user_contact â”‚  â”‚ user_profile â”‚
â”‚ - id, name   â”‚  â”‚ - id, phone  â”‚  â”‚ - id, login  â”‚
â”‚ - email      â”‚  â”‚ - address    â”‚  â”‚ - order_cnt  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
æ°´å¹³æ‹†åˆ†ï¼ˆæŒ‰æ•°æ®é‡åˆ†ï¼‰ï¼š
åŸæ¥çš„å¤§è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orders (1000ä¸‡æ¡è®¢å•)    â”‚
â”‚ - id: 1~10,000,000     â”‚
â”‚ - user_id, amount      â”‚
â”‚ - create_time          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ°´å¹³æ‹†åˆ†åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ orders_1     â”‚  â”‚ orders_2     â”‚  â”‚ orders_3     â”‚
â”‚ id: 1~333ä¸‡  â”‚  â”‚ id: 333~666ä¸‡â”‚  â”‚ id: 666~1000ä¸‡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ¯ åˆ†åº“åˆ†è¡¨ç­–ç•¥è®¾è®¡


### 2.1 åˆ†åº“ç­–ç•¥é€‰æ‹©


**æŒ‰ä¸šåŠ¡åŠŸèƒ½åˆ†åº“ï¼ˆå‚ç›´åˆ†åº“ï¼‰**
```
ç”µå•†ç³»ç»Ÿåˆ†åº“ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_db     â”‚  â”‚ order_db    â”‚  â”‚ product_db  â”‚
â”‚ - users     â”‚  â”‚ - orders    â”‚  â”‚ - products  â”‚
â”‚ - profiles  â”‚  â”‚ - payments  â”‚  â”‚ - inventory â”‚
â”‚ - addresses â”‚  â”‚ - refunds   â”‚  â”‚ - categoriesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼šä¸šåŠ¡è¾¹ç•Œæ¸…æ™°ï¼Œç»´æŠ¤ç®€å•
ç¼ºç‚¹ï¼šæ— æ³•è§£å†³å•è¡¨æ•°æ®é‡è¿‡å¤§é—®é¢˜
```

**æŒ‰æ•°æ®ç‰¹å¾åˆ†åº“ï¼ˆæ°´å¹³åˆ†åº“ï¼‰**
```
ç”¨æˆ·æ•°æ®æŒ‰IDèŒƒå›´åˆ†åº“ï¼š
database_1: user_id 1~1000ä¸‡
database_2: user_id 1000ä¸‡~2000ä¸‡
database_3: user_id 2000ä¸‡~3000ä¸‡

æˆ–è€…æŒ‰hashå€¼åˆ†åº“ï¼š
user_id % 4 = 0 â†’ database_1
user_id % 4 = 1 â†’ database_2
user_id % 4 = 2 â†’ database_3
user_id % 4 = 3 â†’ database_4
```

### 2.2 åˆ†è¡¨ç­–ç•¥é€‰æ‹©


**ğŸ“… æŒ‰æ—¶é—´åˆ†è¡¨**
```
è®¢å•è¡¨æŒ‰æœˆåˆ†è¡¨ï¼š
orders_202401  (1æœˆè®¢å•)
orders_202402  (2æœˆè®¢å•)
orders_202403  (3æœˆè®¢å•)
...

æŸ¥è¯¢ç¤ºä¾‹ï¼š
-- æŸ¥è¯¢3æœˆè®¢å•
SELECT * FROM orders_202403 WHERE status = 'paid';

-- æŸ¥è¯¢å­£åº¦è®¢å•ï¼ˆéœ€è¦unionï¼‰
SELECT * FROM orders_202401 
UNION ALL
SELECT * FROM orders_202402
UNION ALL
SELECT * FROM orders_202403
WHERE create_time >= '2024-01-01';
```

**ğŸ”¢ æŒ‰IDèŒƒå›´åˆ†è¡¨**
```
ç”¨æˆ·è¡¨æŒ‰IDåˆ†è¡¨ï¼š
users_1: id 1~100ä¸‡
users_2: id 100ä¸‡~200ä¸‡
users_3: id 200ä¸‡~300ä¸‡

è·¯ç”±é€»è¾‘ï¼š
if (user_id <= 1000000) {
    table = "users_1";
} else if (user_id <= 2000000) {
    table = "users_2";
} else {
    table = "users_3";
}
```

**#ï¸âƒ£ æŒ‰å“ˆå¸Œåˆ†è¡¨**
```
ç”¨æˆ·è¡¨æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†è¡¨ï¼š
table_name = "users_" + (user_id % 8);

ä¾‹å¦‚ï¼š
user_id = 12345
12345 % 8 = 1
è¡¨å = users_1
```

### 2.3 åˆ†ç‰‡æ•°é‡è®¾è®¡


**ğŸ“ åˆ†ç‰‡æ•°é‡è®¡ç®—**
```
åˆ†ç‰‡æ•°é‡ = é¢„ä¼°æ€»æ•°æ®é‡ / å•ç‰‡æœ€ä¼˜æ•°æ®é‡

ä¾‹å¦‚ï¼š
é¢„ä¼°ç”¨æˆ·æ•°ï¼š1äº¿
å•è¡¨æœ€ä¼˜æ•°æ®é‡ï¼š500ä¸‡
åˆ†ç‰‡æ•°é‡ï¼š1äº¿ Ã· 500ä¸‡ = 20ä¸ªåˆ†ç‰‡

ğŸ’¡ å»ºè®®ï¼š
- é€‰æ‹©2çš„å¹‚æ¬¡æ–¹ï¼š8, 16, 32, 64
- ä¾¿äºåç»­æ‰©å®¹ï¼ˆåˆ†ç‰‡ç¿»å€ï¼‰
- é¿å…é€‰æ‹©è´¨æ•°ï¼Œä¸åˆ©äºæ‰©å®¹
```

**âš–ï¸ åˆ†åº“åˆ†è¡¨ç»„åˆç­–ç•¥**
```
å¸¸è§ç»„åˆæ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼š4åº“Ã—8è¡¨ = 32åˆ†ç‰‡
- 4ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªåº“8å¼ è¡¨
- é€‚åˆä¸­ç­‰è§„æ¨¡åº”ç”¨

æ–¹æ¡ˆ2ï¼š8åº“Ã—16è¡¨ = 128åˆ†ç‰‡  
- 8ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªåº“16å¼ è¡¨
- é€‚åˆå¤§å‹åº”ç”¨

è·¯ç”±ç®—æ³•ï¼š
db_index = user_id % åº“æ•°é‡
table_index = (user_id / åº“æ•°é‡) % è¡¨æ•°é‡
```

---

## 3. ğŸ—ï¸ åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™


### 3.1 ä»€ä¹ˆæ˜¯åˆ†ç‰‡é”®


**ğŸ”‘ åˆ†ç‰‡é”®å®šä¹‰**
```
åˆ†ç‰‡é”®å°±åƒé’¥åŒ™ï¼Œå†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªåˆ†ç‰‡ä¸­

ç¤ºä¾‹ï¼š
ç”¨æˆ·è¡¨ä»¥user_idä½œä¸ºåˆ†ç‰‡é”®ï¼š
INSERT INTO users (user_id=12345, name="å¼ ä¸‰")
â†“
12345 % 8 = 1
â†“
å­˜å‚¨åˆ°: users_1 è¡¨ä¸­
```

### 3.2 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™


**åŸåˆ™1ï¼šæ•°æ®å‡åŒ€åˆ†å¸ƒ**
```
âœ… å¥½çš„åˆ†ç‰‡é”®ï¼šuser_id
12345 % 4 = 1 â†’ database_1
12346 % 4 = 2 â†’ database_2  
12347 % 4 = 3 â†’ database_3
12348 % 4 = 0 â†’ database_0
æ•°æ®åˆ†å¸ƒå‡åŒ€

âŒ åçš„åˆ†ç‰‡é”®ï¼šcreate_time
2024å¹´æ•°æ®å…¨åœ¨ä¸€ä¸ªåˆ†ç‰‡
2023å¹´æ•°æ®å…¨åœ¨å¦ä¸€ä¸ªåˆ†ç‰‡
åˆ†å¸ƒä¸å‡åŒ€
```

**åŸåˆ™2ï¼šæŸ¥è¯¢è·¯ç”±ç®€å•**
```
âœ… ç”¨æˆ·æŸ¥è¯¢è‡ªå·±çš„è®¢å•ï¼š
SELECT * FROM orders WHERE user_id = 12345;
å¯ä»¥ç›´æ¥è·¯ç”±åˆ°ä¸€ä¸ªåˆ†ç‰‡

âŒ æŒ‰å•†å“åç§°æŸ¥è¯¢ï¼š
SELECT * FROM orders WHERE product_name = 'iPhone';
éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡ï¼Œæ€§èƒ½å·®
```

**åŸåˆ™3ï¼šå‡å°‘è·¨åˆ†ç‰‡æŸ¥è¯¢**
```
ä¸šåŠ¡åœºæ™¯åˆ†æï¼š
- ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼š80%
- å•†å®¶æŸ¥çœ‹å•†å“è®¢å•ï¼š15%  
- ç®¡ç†å‘˜ç»Ÿè®¡åˆ†æï¼š5%

é€‰æ‹©user_idä½œä¸ºåˆ†ç‰‡é”®ï¼š
80%çš„æŸ¥è¯¢åªéœ€è¦è®¿é—®ä¸€ä¸ªåˆ†ç‰‡
```

### 3.3 å¸¸è§åˆ†ç‰‡é”®é€‰æ‹©


**ğŸ‘¤ ç”¨æˆ·ç›¸å…³è¡¨**
```
åˆ†ç‰‡é”®é€‰æ‹©ï¼šuser_id

ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨ï¼š
CREATE TABLE users_1 (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100)
);

ç”¨æˆ·è®¢å•è¡¨ï¼š
CREATE TABLE user_orders_1 (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,  â† åˆ†ç‰‡é”®
    amount DECIMAL(10,2)
);
```

**ğŸ›’ è®¢å•ç›¸å…³è¡¨**
```
æƒ…å†µ1ï¼šæŒ‰ç”¨æˆ·åˆ†ç‰‡
åˆ†ç‰‡é”®ï¼šuser_id
å¥½å¤„ï¼šç”¨æˆ·æŸ¥è‡ªå·±è®¢å•å¾ˆå¿«
åå¤„ï¼šå•†å®¶æŸ¥å•†å“è®¢å•è¦è·¨åˆ†ç‰‡

æƒ…å†µ2ï¼šæŒ‰è®¢å•IDåˆ†ç‰‡  
åˆ†ç‰‡é”®ï¼šorder_id
å¥½å¤„ï¼šæ•°æ®åˆ†å¸ƒå‡åŒ€
åå¤„ï¼šç”¨æˆ·æŸ¥è‡ªå·±è®¢å•è¦è·¨åˆ†ç‰‡

é€‰æ‹©å»ºè®®ï¼šçœ‹ä¸»è¦æŸ¥è¯¢åœºæ™¯
```

**ğŸ“¦ å•†å“ç›¸å…³è¡¨**
```
å•†å“ä¿¡æ¯è¡¨ï¼š
åˆ†ç‰‡é”®ï¼šproduct_id
åŸå› ï¼šæŒ‰å•†å“IDæŸ¥è¯¢æ˜¯ä¸»è¦åœºæ™¯

å•†å“è¯„ä»·è¡¨ï¼š
åˆ†ç‰‡é”®ï¼šproduct_id ï¼ˆä¸æ˜¯user_idï¼‰
åŸå› ï¼šé€šå¸¸æ˜¯æŸ¥çœ‹æŸå•†å“çš„è¯„ä»·
```

---

## 4. ğŸ” è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–


### 4.1 è·¨åˆ†ç‰‡æŸ¥è¯¢é—®é¢˜


**ğŸš¨ æ€§èƒ½é—®é¢˜**
```
å•åˆ†ç‰‡æŸ¥è¯¢ï¼š
SELECT * FROM users_1 WHERE age > 25;
è€—æ—¶ï¼š100ms

è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼š
SELECT * FROM users_1 WHERE age > 25
UNION ALL
SELECT * FROM users_2 WHERE age > 25
UNION ALL
SELECT * FROM users_3 WHERE age > 25
UNION ALL  
SELECT * FROM users_4 WHERE age > 25;
è€—æ—¶ï¼š400msï¼ˆ4å€æ—¶é—´ï¼‰
```

**ğŸ”§ å¤æ‚æ€§é—®é¢˜**
```
æ’åºæŸ¥è¯¢ï¼š
SELECT * FROM orders WHERE status = 'paid' 
ORDER BY create_time DESC LIMIT 10;

è·¨åˆ†ç‰‡å®ç°ï¼š
1. ä»æ¯ä¸ªåˆ†ç‰‡æŸ¥è¯¢10æ¡æ•°æ®
2. åœ¨åº”ç”¨å±‚åˆå¹¶ç»“æœ
3. é‡æ–°æ’åºå–å‰10æ¡
4. é€»è¾‘å¤æ‚ï¼Œæ€§èƒ½å·®
```

### 4.2 è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥


**ç­–ç•¥1ï¼šæŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–**
```
âŒ é¿å…çš„æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE age BETWEEN 20 AND 30;
éœ€è¦æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡

âœ… æ¨èçš„æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE user_id = 12345 AND age > 20;
å¯ä»¥ç›´æ¥è·¯ç”±åˆ°ä¸€ä¸ªåˆ†ç‰‡
```

**ç­–ç•¥2ï¼šæ•°æ®å†—ä½™è®¾è®¡**
```
åŸå§‹è®¾è®¡ï¼š
ordersè¡¨ï¼šorder_id, user_id, product_id, amount
productsè¡¨ï¼šproduct_id, name, category

è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼š
SELECT o.*, p.name 
FROM orders o JOIN products p 
ON o.product_id = p.product_id;

ä¼˜åŒ–è®¾è®¡ï¼š
ordersè¡¨ï¼šorder_id, user_id, product_id, amount, product_name
å†—ä½™product_nameï¼Œé¿å…joinæŸ¥è¯¢
```

**ç­–ç•¥3ï¼šåˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
```
è·¨åˆ†ç‰‡åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ï¼š

æ™®é€šæ–¹æ³•ï¼ˆæ…¢ï¼‰ï¼š
1. æŸ¥è¯¢æ‰€æœ‰åˆ†ç‰‡çš„æ•°æ®
2. åº”ç”¨å±‚æ’åº
3. å–æŒ‡å®šé¡µçš„æ•°æ®

æ¸¸æ ‡æ–¹æ³•ï¼ˆå¿«ï¼‰ï¼š
1. ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºæ¸¸æ ‡
2. æ¯æ¬¡æŸ¥è¯¢å¤§äºæŸæ—¶é—´æˆ³çš„æ•°æ®
3. é¿å…å¤§offsetæŸ¥è¯¢

ç¤ºä¾‹ï¼š
-- ç¬¬ä¸€é¡µ
SELECT * FROM orders WHERE create_time > '2024-01-01' 
ORDER BY create_time LIMIT 10;

-- ä¸‹ä¸€é¡µï¼ˆä½¿ç”¨ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„æ—¶é—´ï¼‰
SELECT * FROM orders WHERE create_time > '2024-01-15 14:30:25'
ORDER BY create_time LIMIT 10;
```

### 4.3 èšåˆæŸ¥è¯¢å¤„ç†


**ğŸ“Š COUNTæŸ¥è¯¢**
```
æŸ¥è¯¢æ€»ç”¨æˆ·æ•°ï¼š
SELECT COUNT(*) FROM users;

åˆ†ç‰‡å®ç°ï¼š
SELECT COUNT(*) FROM users_1;  -- ç»“æœï¼š100ä¸‡
SELECT COUNT(*) FROM users_2;  -- ç»“æœï¼š150ä¸‡  
SELECT COUNT(*) FROM users_3;  -- ç»“æœï¼š120ä¸‡
SELECT COUNT(*) FROM users_4;  -- ç»“æœï¼š130ä¸‡

åº”ç”¨å±‚æ±‡æ€»ï¼š100 + 150 + 120 + 130 = 500ä¸‡
```

**ğŸ’° SUMæŸ¥è¯¢**
```
æŸ¥è¯¢æ€»é”€å”®é¢ï¼š
SELECT SUM(amount) FROM orders;

åˆ†ç‰‡å®ç°ï¼š
SELECT SUM(amount) FROM orders_1;  -- ç»“æœï¼š500ä¸‡
SELECT SUM(amount) FROM orders_2;  -- ç»“æœï¼š600ä¸‡
SELECT SUM(amount) FROM orders_3;  -- ç»“æœï¼š450ä¸‡  
SELECT SUM(amount) FROM orders_4;  -- ç»“æœï¼š550ä¸‡

åº”ç”¨å±‚æ±‡æ€»ï¼š500 + 600 + 450 + 550 = 2100ä¸‡
```

---

## 5. ğŸ”„ åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†


### 5.1 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜


**ğŸ¯ é—®é¢˜åœºæ™¯**
```
ç”µå•†ä¸‹å•åœºæ™¯ï¼š
1. æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆuser_db.usersè¡¨ï¼‰
2. åˆ›å»ºè®¢å•è®°å½•ï¼ˆorder_db.ordersè¡¨ï¼‰
3. æ‰£å‡å•†å“åº“å­˜ï¼ˆproduct_db.inventoryè¡¨ï¼‰

é—®é¢˜ï¼šä¸‰ä¸ªæ“ä½œåˆ†å¸ƒåœ¨ä¸åŒæ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ
```

**ğŸ’” ä¸€è‡´æ€§æŒ‘æˆ˜**
```
å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š

åœºæ™¯1ï¼šç½‘ç»œæ•…éšœ
Step1: æ‰£å‡ç”¨æˆ·ä½™é¢ âœ… æˆåŠŸ  
Step2: åˆ›å»ºè®¢å•è®°å½• âŒ ç½‘ç»œè¶…æ—¶
Step3: æ‰£å‡å•†å“åº“å­˜ âŒ æœªæ‰§è¡Œ
ç»“æœï¼šé’±æ‰£äº†ï¼Œè®¢å•æ²¡åˆ›å»º

åœºæ™¯2ï¼šæ•°æ®åº“å®•æœº  
Step1: æ‰£å‡ç”¨æˆ·ä½™é¢ âœ… æˆåŠŸ
Step2: åˆ›å»ºè®¢å•è®°å½• âœ… æˆåŠŸ
Step3: æ‰£å‡å•†å“åº“å­˜ âŒ æ•°æ®åº“å®•æœº
ç»“æœï¼šè¶…å–é—®é¢˜
```

### 5.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰


**ğŸ“‹ 2PCåŸºæœ¬æµç¨‹**
```
å‚ä¸è€…ï¼šç”¨æˆ·DBã€è®¢å•DBã€å•†å“DB
åè°ƒè€…ï¼šåº”ç”¨æœåŠ¡å™¨

é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
åè°ƒè€… â†’ ç”¨æˆ·DBï¼šå‡†å¤‡æ‰£å‡ä½™é¢
ç”¨æˆ·DB â†’ åè°ƒè€…ï¼šå‡†å¤‡å°±ç»ª
åè°ƒè€… â†’ è®¢å•DBï¼šå‡†å¤‡åˆ›å»ºè®¢å•  
è®¢å•DB â†’ åè°ƒè€…ï¼šå‡†å¤‡å°±ç»ª
åè°ƒè€… â†’ å•†å“DBï¼šå‡†å¤‡æ‰£å‡åº“å­˜
å•†å“DB â†’ åè°ƒè€…ï¼šå‡†å¤‡å°±ç»ª

é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ
åè°ƒè€… â†’ æ‰€æœ‰DBï¼šæäº¤äº‹åŠ¡
æ‰€æœ‰DB â†’ åè°ƒè€…ï¼šæäº¤å®Œæˆ
```

**âš ï¸ 2PCçš„é—®é¢˜**
```
é—®é¢˜1ï¼šæ€§èƒ½é—®é¢˜
- éœ€è¦ä¸¤è½®ç½‘ç»œé€šä¿¡
- äº‹åŠ¡æŒæœ‰é”æ—¶é—´é•¿
- æ•´ä½“è€—æ—¶å¢åŠ 

é—®é¢˜2ï¼šå•ç‚¹æ•…éšœ
- åè°ƒè€…å®•æœºï¼Œæ‰€æœ‰å‚ä¸è€…ç­‰å¾…
- å‚ä¸è€…å®•æœºï¼Œå½±å“æ•´ä½“äº‹åŠ¡

é—®é¢˜3ï¼šæ•°æ®ä¸ä¸€è‡´
- ç½‘ç»œåˆ†åŒºæ—¶å¯èƒ½å‡ºç°è„‘è£‚
```

### 5.3 è¡¥å¿äº‹åŠ¡ï¼ˆTCCï¼‰


**ğŸ”„ TCCæ¨¡å¼**
```
TCC = Try-Confirm-Cancel

Tryé˜¶æ®µï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡
- æ£€æŸ¥ä¸šåŠ¡æ¡ä»¶
- é¢„ç•™ä¸šåŠ¡èµ„æº
- ä¸å®é™…æäº¤

Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œ
- çœŸæ­£æ‰§è¡Œä¸šåŠ¡é€»è¾‘
- é‡Šæ”¾é¢„ç•™èµ„æº

Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œ
- å›æ»šTryé˜¶æ®µæ“ä½œ
- é‡Šæ”¾é¢„ç•™èµ„æº
```

**ğŸ’¡ TCCå®ç°ç¤ºä¾‹**
```java
// æ‰£å‡ä½™é¢çš„TCCå®ç°
public class AccountService {
    
    // Tryï¼šå†»ç»“é‡‘é¢
    public boolean tryReduce(Long userId, BigDecimal amount) {
        User user = userDao.findById(userId);
        if (user.getBalance().compareTo(amount) >= 0) {
            user.setFrozenAmount(user.getFrozenAmount().add(amount));
            userDao.update(user);
            return true;
        }
        return false;
    }
    
    // Confirmï¼šçœŸæ­£æ‰£å‡
    public void confirmReduce(Long userId, BigDecimal amount) {
        User user = userDao.findById(userId);
        user.setBalance(user.getBalance().subtract(amount));
        user.setFrozenAmount(user.getFrozenAmount().subtract(amount));
        userDao.update(user);
    }
    
    // Cancelï¼šé‡Šæ”¾å†»ç»“
    public void cancelReduce(Long userId, BigDecimal amount) {
        User user = userDao.findById(userId);
        user.setFrozenAmount(user.getFrozenAmount().subtract(amount));
        userDao.update(user);
    }
}
```

### 5.4 åˆ†å¸ƒå¼äº‹åŠ¡æœ€ä½³å®è·µ


**ğŸ¯ è®¾è®¡åŸåˆ™**
```
åŸåˆ™1ï¼šå°½é‡é¿å…åˆ†å¸ƒå¼äº‹åŠ¡
- é€šè¿‡ä¸šåŠ¡æ‹†åˆ†å‡å°‘è·¨åº“æ“ä½œ
- æ•°æ®å†—ä½™å‡å°‘å…³è”æŸ¥è¯¢
- å¼‚æ­¥æ¶ˆæ¯å¤„ç†éæ ¸å¿ƒæ“ä½œ

åŸåˆ™2ï¼šæœ€ç»ˆä¸€è‡´æ€§ä»£æ›¿å¼ºä¸€è‡´æ€§
- æ ¸å¿ƒä¸šåŠ¡ä¿è¯å¼ºä¸€è‡´æ€§
- éæ ¸å¿ƒä¸šåŠ¡å…è®¸çŸ­æš‚ä¸ä¸€è‡´
- é€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´

åŸåˆ™3ï¼šé€‰æ‹©åˆé€‚çš„è§£å†³æ–¹æ¡ˆ
- ç®€å•åœºæ™¯ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨
- å¤æ‚åœºæ™¯ï¼šSagaæ¨¡å¼  
- é«˜æ€§èƒ½åœºæ™¯ï¼šTCCæ¨¡å¼
```

---

## 6. ğŸ“¦ æ•°æ®è¿ç§»æ€§èƒ½


### 6.1 æ•°æ®è¿ç§»åœºæ™¯


**ğŸ“ˆ æ‰©å®¹è¿ç§»**
```
ä¸šåŠ¡å¢é•¿å¯¼è‡´çš„æ‰©å®¹ï¼š

åŸå§‹é…ç½®ï¼š2åº“Ã—4è¡¨ = 8åˆ†ç‰‡
æ–°çš„é…ç½®ï¼š4åº“Ã—8è¡¨ = 32åˆ†ç‰‡

è¿ç§»æŒ‘æˆ˜ï¼š
- æ•°æ®é‡å¤§ï¼š1TBæ•°æ®éœ€è¦é‡æ–°åˆ†å¸ƒ
- æœåŠ¡å¯ç”¨ï¼šè¿ç§»æœŸé—´ç³»ç»Ÿä¸èƒ½åœæœº
- æ•°æ®ä¸€è‡´ï¼šæ–°è€æ•°æ®å¿…é¡»ä¿æŒåŒæ­¥
```

**ğŸ”§ æ¶æ„è°ƒæ•´è¿ç§»**
```
åˆ†ç‰‡é”®è°ƒæ•´ï¼š
åŸæ¥ï¼šæŒ‰user_idåˆ†ç‰‡
ç°åœ¨ï¼šæŒ‰order_idåˆ†ç‰‡

åŸå› ï¼šæŸ¥è¯¢æ¨¡å¼å˜åŒ–ï¼Œéœ€è¦è°ƒæ•´åˆ†ç‰‡ç­–ç•¥
å½±å“ï¼šæ‰€æœ‰æ•°æ®éƒ½éœ€è¦é‡æ–°åˆ†å¸ƒ
```

### 6.2 åœ¨çº¿æ•°æ®è¿ç§»ç­–ç•¥


**ç­–ç•¥1ï¼šåœæœºè¿ç§»ï¼ˆä¸æ¨èï¼‰**
```
è¿ç§»æ­¥éª¤ï¼š
1. åœæ­¢åº”ç”¨æœåŠ¡
2. å¯¼å‡ºæ‰€æœ‰æ•°æ®
3. æŒ‰æ–°è§„åˆ™å¯¼å…¥æ•°æ®
4. éªŒè¯æ•°æ®æ­£ç¡®æ€§
5. å¯åŠ¨åº”ç”¨æœåŠ¡

é—®é¢˜ï¼š
- åœæœºæ—¶é—´é•¿ï¼ˆå°æ—¶çº§åˆ«ï¼‰
- ä¸šåŠ¡æŸå¤±å¤§
- ç”¨æˆ·ä½“éªŒå·®
```

**ç­–ç•¥2ï¼šåŒå†™è¿ç§»ï¼ˆæ¨èï¼‰**
```
è¿ç§»æµç¨‹ï¼š

ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡æ–°åˆ†ç‰‡
1. åˆ›å»ºæ–°çš„åˆ†ç‰‡è¡¨ç»“æ„
2. æ•°æ®åŒæ­¥ç¨‹åºå‡†å¤‡å°±ç»ª

ç¬¬äºŒé˜¶æ®µï¼šå†å²æ•°æ®è¿ç§»  
1. å¯åŠ¨æ•°æ®åŒæ­¥ç¨‹åº
2. å°†è€åˆ†ç‰‡æ•°æ®æŒ‰æ–°è§„åˆ™åŒæ­¥åˆ°æ–°åˆ†ç‰‡
3. éªŒè¯æ•°æ®ä¸€è‡´æ€§

ç¬¬ä¸‰é˜¶æ®µï¼šåŒå†™æ¨¡å¼
1. æ–°æ•°æ®åŒæ—¶å†™å…¥è€åˆ†ç‰‡å’Œæ–°åˆ†ç‰‡
2. ç»§ç»­åŒæ­¥å†å²æ•°æ®
3. éªŒè¯æ–°è€åˆ†ç‰‡æ•°æ®ä¸€è‡´

ç¬¬å››é˜¶æ®µï¼šè¯»å†™åˆ‡æ¢
1. è¯»æ“ä½œåˆ‡æ¢åˆ°æ–°åˆ†ç‰‡
2. å†™æ“ä½œåªå†™æ–°åˆ†ç‰‡
3. åœæ­¢æ•°æ®åŒæ­¥ç¨‹åº
4. åˆ é™¤è€åˆ†ç‰‡æ•°æ®
```

### 6.3 è¿ç§»æ€§èƒ½ä¼˜åŒ–


**ğŸš€ å¹¶å‘è¿ç§»**
```java
// åˆ†æ‰¹å¹¶å‘è¿ç§»æ•°æ®
public class DataMigrationService {
    
    private ExecutorService executor = Executors.newFixedThreadPool(8);
    
    public void migrateData() {
        // æŒ‰IDèŒƒå›´åˆ†æ‰¹
        for (long startId = 1; startId <= 10000000; startId += 100000) {
            long endId = Math.min(startId + 99999, 10000000);
            
            executor.submit(() -> {
                migrateBatch(startId, endId);
            });
        }
    }
    
    private void migrateBatch(long startId, long endId) {
        List<User> users = userDao.findByIdRange(startId, endId);
        
        for (User user : users) {
            // æŒ‰æ–°è§„åˆ™è®¡ç®—åˆ†ç‰‡
            String newTableName = calculateNewTable(user.getUserId());
            // æ’å…¥æ–°åˆ†ç‰‡
            newUserDao.insert(newTableName, user);
        }
    }
}
```

**âš¡ æ€§èƒ½è°ƒä¼˜å‚æ•°**
```
æ‰¹é‡å¤§å°ä¼˜åŒ–ï¼š
- å¤ªå°ï¼šç½‘ç»œå¼€é”€å¤§ï¼Œæ•ˆç‡ä½
- å¤ªå¤§ï¼šå†…å­˜å ç”¨å¤šï¼Œå¯èƒ½è¶…æ—¶
- å»ºè®®ï¼š1000-5000æ¡/æ‰¹

å¹¶å‘æ•°é‡æ§åˆ¶ï¼š
- æ ¹æ®æ•°æ®åº“è¿æ¥æ•°ç¡®å®š
- ç›‘æ§CPUå’Œå†…å­˜ä½¿ç”¨ç‡
- å»ºè®®ï¼š4-16ä¸ªå¹¶å‘çº¿ç¨‹

ç½‘ç»œä¼˜åŒ–ï¼š
- ä½¿ç”¨æ‰¹é‡æ’å…¥è¯­å¥
- å¼€å¯äº‹åŠ¡æ‰¹é‡æäº¤  
- å‹ç¼©ç½‘ç»œä¼ è¾“æ•°æ®
```

### 6.4 è¿ç§»æ•°æ®æ ¡éªŒ


**ğŸ” æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ**
```java
public class DataValidator {
    
    // æ ¡éªŒæ€»æ•°æ®é‡
    public boolean validateCount() {
        long oldCount = oldDao.countAll();
        long newCount = newDao.countAll();
        
        return oldCount == newCount;
    }
    
    // æ ¡éªŒæ•°æ®å®Œæ•´æ€§
    public boolean validateData(long userId) {
        User oldUser = oldDao.findById(userId);
        User newUser = newDao.findById(userId);
        
        return Objects.equals(oldUser, newUser);
    }
    
    // æŠ½æ ·æ ¡éªŒ
    public boolean sampleValidate() {
        // éšæœºæŠ½å–1%æ•°æ®è¿›è¡Œæ ¡éªŒ
        List<Long> sampleIds = generateSampleIds(0.01);
        
        for (Long userId : sampleIds) {
            if (!validateData(userId)) {
                log.error("æ•°æ®æ ¡éªŒå¤±è´¥: userId={}", userId);
                return false;
            }
        }
        
        return true;
    }
}
```

---

## 7. âš–ï¸ åˆ†ç‰‡æ•°æ®å‡è¡¡


### 7.1 æ•°æ®å€¾æ–œé—®é¢˜


**ğŸ“Š ä»€ä¹ˆæ˜¯æ•°æ®å€¾æ–œ**
```
ç†æƒ³æƒ…å†µä¸‹çš„æ•°æ®åˆ†å¸ƒï¼š
åˆ†ç‰‡1ï¼š100ä¸‡æ¡æ•°æ®
åˆ†ç‰‡2ï¼š100ä¸‡æ¡æ•°æ®  
åˆ†ç‰‡3ï¼š100ä¸‡æ¡æ•°æ®
åˆ†ç‰‡4ï¼š100ä¸‡æ¡æ•°æ®
æ¯ä¸ªåˆ†ç‰‡è´Ÿè½½ç›¸ç­‰

å®é™…å¯èƒ½å‡ºç°çš„å€¾æ–œï¼š
åˆ†ç‰‡1ï¼š300ä¸‡æ¡æ•°æ®  â† æ•°æ®è¿‡å¤š
åˆ†ç‰‡2ï¼š50ä¸‡æ¡æ•°æ®   â† æ•°æ®è¿‡å°‘
åˆ†ç‰‡3ï¼š100ä¸‡æ¡æ•°æ®
åˆ†ç‰‡4ï¼š50ä¸‡æ¡æ•°æ®
è´Ÿè½½ä¸å‡è¡¡ï¼Œçƒ­ç‚¹é—®é¢˜
```

**ğŸ”¥ çƒ­ç‚¹åˆ†ç‰‡é—®é¢˜**
```
æ¡ˆä¾‹ï¼šç”µå•†å¹³å°ç”¨æˆ·è¡¨æŒ‰user_idåˆ†ç‰‡

åˆ†ç‰‡è§„åˆ™ï¼šuser_id % 4

é—®é¢˜åˆ†æï¼š
- æ—©æœŸç”¨æˆ·IDï¼š1, 2, 3, 4, 5...ï¼ˆè¿ç»­ï¼‰
- è¿™äº›è€ç”¨æˆ·é€šå¸¸æ›´æ´»è·ƒ
- å¯¼è‡´æŸäº›åˆ†ç‰‡è®¿é—®é‡å¤§ï¼Œæˆä¸ºçƒ­ç‚¹

çƒ­ç‚¹åˆ†ç‰‡ï¼šuser_id % 4 = 0 çš„åˆ†ç‰‡
- åŒ…å«å¤§é‡æ´»è·ƒç”¨æˆ·
- æŸ¥è¯¢è¯·æ±‚å¤šï¼Œæ€§èƒ½å‹åŠ›å¤§
- æˆä¸ºç³»ç»Ÿç“¶é¢ˆ
```

### 7.2 æ•°æ®å‡è¡¡ç­–ç•¥


**ç­–ç•¥1ï¼šé€‰æ‹©åˆé€‚çš„åˆ†ç‰‡é”®**
```
âŒ å®¹æ˜“å€¾æ–œçš„åˆ†ç‰‡é”®ï¼š

æ—¶é—´å­—æ®µï¼š
æŒ‰create_timeåˆ†ç‰‡ï¼Œæ–°æ•°æ®éƒ½é›†ä¸­åœ¨æœ€æ–°åˆ†ç‰‡

åœ°åŸŸå­—æ®µï¼š
æŒ‰cityåˆ†ç‰‡ï¼Œä¸€çº¿åŸå¸‚æ•°æ®å¤šï¼Œå°åŸå¸‚æ•°æ®å°‘

çŠ¶æ€å­—æ®µï¼š
æŒ‰statusåˆ†ç‰‡ï¼ŒæŸäº›çŠ¶æ€çš„æ•°æ®ç‰¹åˆ«å¤š

âœ… åˆ†å¸ƒå‡åŒ€çš„åˆ†ç‰‡é”®ï¼š

ç”¨æˆ·IDï¼š
è‡ªå¢IDï¼Œåˆ†å¸ƒç›¸å¯¹å‡åŒ€

è®¢å•IDï¼š  
UUIDæˆ–é›ªèŠ±IDï¼Œéšæœºæ€§å¥½

å“ˆå¸Œå€¼ï¼š
å¯¹ä¸šåŠ¡å­—æ®µè®¡ç®—hashï¼Œåˆ†å¸ƒå‡åŒ€
```

**ç­–ç•¥2ï¼šä¸€è‡´æ€§å“ˆå¸Œç®—æ³•**
```
ä¼ ç»Ÿå–æ¨¡ç®—æ³•é—®é¢˜ï¼š
user_id % 4 = åˆ†ç‰‡ç¼–å·
å¢åŠ åˆ†ç‰‡æ—¶ï¼Œæ‰€æœ‰æ•°æ®éƒ½éœ€è¦é‡æ–°åˆ†å¸ƒ

ä¸€è‡´æ€§å“ˆå¸Œä¼˜åŠ¿ï¼š
- å¢åŠ èŠ‚ç‚¹æ—¶ï¼Œåªå½±å“éƒ¨åˆ†æ•°æ®
- å‡å°‘æ•°æ®è¿ç§»é‡
- æ”¯æŒåŠ¨æ€æ‰©ç¼©å®¹

å®ç°ç¤ºä¾‹ï¼š
1. å°†å“ˆå¸Œç©ºé—´æ˜ å°„ä¸ºç¯å½¢
2. èŠ‚ç‚¹å’Œæ•°æ®éƒ½æ˜ å°„åˆ°ç¯ä¸Š
3. æ•°æ®å­˜å‚¨åˆ°é¡ºæ—¶é’ˆæœ€è¿‘èŠ‚ç‚¹
4. æ·»åŠ èŠ‚ç‚¹åªå½±å“å±€éƒ¨æ•°æ®
```

### 7.3 åŠ¨æ€æ•°æ®é‡åˆ†å¸ƒ


**ğŸ”„ çƒ­ç‚¹åˆ†ç‰‡æ‹†åˆ†**
```java
public class ShardRebalancer {
    
    // æ£€æµ‹çƒ­ç‚¹åˆ†ç‰‡
    public List<String> detectHotShards() {
        List<String> hotShards = new ArrayList<>();
        
        for (String shardName : allShards) {
            ShardMetrics metrics = getShardMetrics(shardName);
            
            if (metrics.getQps() > hotThreshold || 
                metrics.getDataSize() > sizeThreshold) {
                hotShards.add(shardName);
            }
        }
        
        return hotShards;
    }
    
    // æ‹†åˆ†çƒ­ç‚¹åˆ†ç‰‡
    public void splitHotShard(String hotShardName) {
        // 1. åˆ›å»ºæ–°åˆ†ç‰‡
        String newShardName = createNewShard();
        
        // 2. æ•°æ®è¿ç§»ï¼ˆè¿ç§»ä¸€åŠæ•°æ®åˆ°æ–°åˆ†ç‰‡ï¼‰
        migrateHalfData(hotShardName, newShardName);
        
        // 3. æ›´æ–°è·¯ç”±è§„åˆ™
        updateRoutingRules(hotShardName, newShardName);
        
        // 4. éªŒè¯æ•°æ®ä¸€è‡´æ€§
        validateDataConsistency(hotShardName, newShardName);
    }
}
```

**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡**
```
éœ€è¦ç›‘æ§çš„åˆ†ç‰‡æŒ‡æ ‡ï¼š

æ•°æ®é‡æŒ‡æ ‡ï¼š
- æ¯ä¸ªåˆ†ç‰‡çš„è®°å½•æ•°
- æ¯ä¸ªåˆ†ç‰‡çš„å­˜å‚¨ç©ºé—´
- æ•°æ®å¢é•¿é€Ÿç‡

æ€§èƒ½æŒ‡æ ‡ï¼š
- æ¯ä¸ªåˆ†ç‰‡çš„QPSï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰
- å¹³å‡å“åº”æ—¶é—´  
- æ…¢æŸ¥è¯¢æ•°é‡

èµ„æºæŒ‡æ ‡ï¼š
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜IOä½¿ç”¨ç‡

å‘Šè­¦è§„åˆ™ï¼š
å½“æŸä¸ªåˆ†ç‰‡çš„æŒ‡æ ‡è¶…è¿‡å¹³å‡å€¼çš„2å€æ—¶å‘Šè­¦
```

### 7.4 é¢„é˜²æ•°æ®å€¾æ–œ


**ğŸ¯ è®¾è®¡é˜¶æ®µé¢„é˜²**
```
åˆ†ç‰‡é”®é€‰æ‹©æ£€æŸ¥æ¸…å•ï¼š

âœ… æ•°æ®åˆ†å¸ƒæ£€æŸ¥ï¼š
- åˆ†æå†å²æ•°æ®åˆ†å¸ƒç‰¹å¾
- é¢„æµ‹æœªæ¥æ•°æ®å¢é•¿æ¨¡å¼
- é€‰æ‹©åˆ†å¸ƒå‡åŒ€çš„å­—æ®µ

âœ… ä¸šåŠ¡ç‰¹å¾æ£€æŸ¥ï¼š
- åˆ†æä¸»è¦æŸ¥è¯¢æ¨¡å¼
- è€ƒè™‘ä¸šåŠ¡å‘å±•è¶‹åŠ¿
- é¿å…æ˜æ˜¾çš„çƒ­ç‚¹ä¸šåŠ¡

âœ… æ‰©å±•æ€§æ£€æŸ¥ï¼š
- æ”¯æŒåŠ¨æ€å¢åŠ åˆ†ç‰‡
- æ•°æ®è¿ç§»æˆæœ¬å¯æ§
- è·¯ç”±è§„åˆ™æ˜“äºè°ƒæ•´
```

**ğŸ› ï¸ è¿è¡Œæ—¶è°ƒä¼˜**
```
åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼š

è´Ÿè½½å‡è¡¡ï¼š
- å®æ—¶ç›‘æ§åˆ†ç‰‡è´Ÿè½½
- è‡ªåŠ¨è·¯ç”±åˆ°è´Ÿè½½ä½çš„åˆ†ç‰‡
- é¿å…é›ªå´©æ•ˆåº”

ç¼“å­˜ä¼˜åŒ–ï¼š
- çƒ­ç‚¹æ•°æ®å¢åŠ ç¼“å­˜
- å‡å°‘æ•°æ®åº“è®¿é—®å‹åŠ›
- æé«˜æ•´ä½“æ€§èƒ½

è¯»å†™åˆ†ç¦»ï¼š
- è¯»æ“ä½œåˆ†æ•£åˆ°å¤šä¸ªå‰¯æœ¬
- å†™æ“ä½œé›†ä¸­åˆ°ä¸»åˆ†ç‰‡
- é™ä½ä¸»åˆ†ç‰‡å‹åŠ›
```

---

## 8. ğŸš— åˆ†ç‰‡è·¯ç”±ä¼˜åŒ–


### 8.1 è·¯ç”±ç³»ç»Ÿæ¶æ„


**ğŸ—ï¸ è·¯ç”±ç»„ä»¶ç»“æ„**
```
åº”ç”¨å±‚æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨æœåŠ¡å±‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            åˆ†ç‰‡è·¯ç”±ä¸­é—´ä»¶               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è·¯ç”±è®¡ç®—  â”‚ è¿æ¥æ±   â”‚ ç»“æœåˆå¹¶   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            æ•°æ®åº“è¿æ¥å±‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DB1    â”‚  DB2    â”‚  DB3    â”‚  DB4   â”‚
â”‚ Table1  â”‚ Table1  â”‚ Table1  â”‚ Table1  â”‚
â”‚ Table2  â”‚ Table2  â”‚ Table2  â”‚ Table2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ§­ è·¯ç”±è®¡ç®—é€»è¾‘**
```java
public class ShardingRouter {
    
    // è·¯ç”±é…ç½®
    private ShardingConfig config;
    
    public RouteResult route(String sql, Object... params) {
        // 1. è§£æSQLï¼Œæå–åˆ†ç‰‡é”®å€¼
        ShardingKey key = extractShardingKey(sql, params);
        
        // 2. è®¡ç®—ç›®æ ‡åˆ†ç‰‡
        String targetDB = calculateDatabase(key);
        String targetTable = calculateTable(key);
        
        // 3. é‡å†™SQL
        String rewrittenSQL = rewriteSQL(sql, targetTable);
        
        return new RouteResult(targetDB, rewrittenSQL, params);
    }
    
    private String calculateDatabase(ShardingKey key) {
        return "db_" + (key.getValue() % config.getDatabaseCount());
    }
    
    private String calculateTable(ShardingKey key) {
        long tableIndex = (key.getValue() / config.getDatabaseCount()) 
                         % config.getTableCountPerDB();
        return key.getLogicTable() + "_" + tableIndex;
    }
}
```

### 8.2 SQLè§£æä¸é‡å†™


**ğŸ“ SQLé‡å†™ç¤ºä¾‹**
```
åŸå§‹SQLï¼š
SELECT * FROM users WHERE user_id = 12345;

è§£æè¿‡ç¨‹ï¼š
1. æå–åˆ†ç‰‡é”®ï¼šuser_id = 12345
2. è®¡ç®—åˆ†ç‰‡ï¼š12345 % 4 = 1 â†’ db_1
3. è®¡ç®—è¡¨ï¼š(12345 / 4) % 8 = 2 â†’ users_2

é‡å†™åSQLï¼š
SELECT * FROM users_2 WHERE user_id = 12345;

æ‰§è¡Œç›®æ ‡ï¼šdb_1.users_2
```

**ğŸ”„ å¤æ‚SQLå¤„ç†**
```java
public class SQLRewriter {
    
    public String rewriteSQL(String sql, List<String> targetTables) {
        
        if (targetTables.size() == 1) {
            // å•è¡¨æŸ¥è¯¢ï¼Œç›´æ¥æ›¿æ¢è¡¨å
            return sql.replace("users", targetTables.get(0));
        } else {
            // å¤šè¡¨æŸ¥è¯¢ï¼Œç”ŸæˆUNIONè¯­å¥
            StringBuilder unionSQL = new StringBuilder();
            
            for (int i = 0; i < targetTables.size(); i++) {
                if (i > 0) {
                    unionSQL.append(" UNION ALL ");
                }
                
                String tableSQL = sql.replace("users", targetTables.get(i));
                unionSQL.append("(").append(tableSQL).append(")");
            }
            
            return unionSQL.toString();
        }
    }
}

// è·¨åˆ†ç‰‡æŸ¥è¯¢ç¤ºä¾‹
åŸå§‹SQLï¼šSELECT * FROM users WHERE age > 25 ORDER BY create_time LIMIT 10;

é‡å†™åSQLï¼š
(SELECT * FROM users_1 WHERE age > 25 ORDER BY create_time LIMIT 10)
UNION ALL  
(SELECT * FROM users_2 WHERE age > 25 ORDER BY create_time LIMIT 10)
UNION ALL
(SELECT * FROM users_3 WHERE age > 25 ORDER BY create_time LIMIT 10)
UNION ALL
(SELECT * FROM users_4 WHERE age > 25 ORDER BY create_time LIMIT 10)
ORDER BY create_time LIMIT 10;
```

### 8.3 è¿æ¥æ± ç®¡ç†


**ğŸŠ è¿æ¥æ± ä¼˜åŒ–**
```java
public class ShardingDataSource {
    
    // ä¸ºæ¯ä¸ªåˆ†ç‰‡ç»´æŠ¤ç‹¬ç«‹è¿æ¥æ± 
    private Map<String, DataSource> dataSources;
    
    public ShardingDataSource(ShardingConfig config) {
        this.dataSources = new HashMap<>();
        
        // ä¸ºæ¯ä¸ªæ•°æ®åº“åˆ›å»ºè¿æ¥æ± 
        for (String dbName : config.getDatabaseNames()) {
            HikariConfig hikariConfig = new HikariConfig();
            hikariConfig.setJdbcUrl(config.getJdbcUrl(dbName));
            hikariConfig.setMaximumPoolSize(20);  // è¿æ¥æ± å¤§å°
            hikariConfig.setMinimumIdle(5);       // æœ€å°ç©ºé—²è¿æ¥
            
            DataSource ds = new HikariDataSource(hikariConfig);
            dataSources.put(dbName, ds);
        }
    }
    
    public Connection getConnection(String dbName) throws SQLException {
        DataSource ds = dataSources.get(dbName);
        return ds.getConnection();
    }
}
```

**âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```
è¿æ¥æ± å‚æ•°è°ƒä¼˜ï¼š

æœ€å¤§è¿æ¥æ•°ï¼š
- æ ¹æ®æ•°æ®åº“æœåŠ¡å™¨é…ç½®è®¾ç½®
- è€ƒè™‘åº”ç”¨å¹¶å‘é‡
- å»ºè®®ï¼š10-50ä¸ªè¿æ¥/åˆ†ç‰‡

è¿æ¥è¶…æ—¶ï¼š
- è¿æ¥è·å–è¶…æ—¶ï¼š5ç§’
- è¿æ¥éªŒè¯è¶…æ—¶ï¼š3ç§’  
- è¿æ¥ç©ºé—²è¶…æ—¶ï¼š10åˆ†é’Ÿ

è¿æ¥å¤ç”¨ï¼š
- å¼€å¯è¿æ¥é¢„çƒ­
- å®šæœŸæ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§
- åŠæ—¶å›æ”¶æ— æ•ˆè¿æ¥
```

### 8.4 ç»“æœåˆå¹¶ä¼˜åŒ–


**ğŸ”€ åˆ†é¡µæŸ¥è¯¢åˆå¹¶**
```java
public class ResultMerger {
    
    public List<User> mergePaginatedResults(List<List<User>> shardResults, 
                                          int offset, int limit) {
        // 1. åˆå¹¶æ‰€æœ‰åˆ†ç‰‡ç»“æœ
        List<User> allResults = new ArrayList<>();
        for (List<User> shardResult : shardResults) {
            allResults.addAll(shardResult);
        }
        
        // 2. æ’åºï¼ˆå¦‚æœéœ€è¦ï¼‰
        allResults.sort(Comparator.comparing(User::getCreateTime).reversed());
        
        // 3. åˆ†é¡µå¤„ç†
        int start = Math.min(offset, allResults.size());
        int end = Math.min(offset + limit, allResults.size());
        
        return allResults.subList(start, end);
    }
}

// æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…è·å–è¿‡å¤šæ•°æ®
// æ¯ä¸ªåˆ†ç‰‡åªæŸ¥è¯¢ offset + limit æ¡è®°å½•
// è€Œä¸æ˜¯æŸ¥è¯¢æ‰€æœ‰è®°å½•å†åˆ†é¡µ
```

**ğŸ“Š èšåˆç»“æœåˆå¹¶**
```java
public class AggregationMerger {
    
    // COUNTåˆå¹¶
    public long mergeCount(List<Long> counts) {
        return counts.stream().mapToLong(Long::longValue).sum();
    }
    
    // SUMåˆå¹¶  
    public BigDecimal mergeSum(List<BigDecimal> sums) {
        return sums.stream()
                   .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    // AVGåˆå¹¶ï¼ˆéœ€è¦é¢å¤–ä¿¡æ¯ï¼‰
    public double mergeAvg(List<AvgResult> avgResults) {
        long totalCount = 0;
        BigDecimal totalSum = BigDecimal.ZERO;
        
        for (AvgResult result : avgResults) {
            totalCount += result.getCount();
            totalSum = totalSum.add(result.getSum());
        }
        
        return totalSum.divide(new BigDecimal(totalCount), 2, 
                              RoundingMode.HALF_UP).doubleValue();
    }
}
```

---

## 9. ğŸ“ˆ åˆ†ç‰‡æ€§èƒ½ç›‘æ§


### 9.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
æ•°æ®åº“å±‚é¢æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QPS/TPS     â”‚ æ¯ç§’æŸ¥è¯¢æ•°/äº‹åŠ¡æ•°         â”‚
â”‚ å“åº”æ—¶é—´     â”‚ å¹³å‡/P95/P99å“åº”æ—¶é—´      â”‚
â”‚ è¿æ¥æ•°       â”‚ æ´»è·ƒè¿æ¥/æ€»è¿æ¥æ•°         â”‚
â”‚ é”ç­‰å¾…       â”‚ é”ç­‰å¾…æ—¶é—´/æ­»é”æ¬¡æ•°       â”‚
â”‚ æ…¢æŸ¥è¯¢       â”‚ æ…¢æŸ¥è¯¢æ•°é‡/æ‰§è¡Œæ—¶é—´       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†ç‰‡å±‚é¢æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®åˆ†å¸ƒ     â”‚ å„åˆ†ç‰‡æ•°æ®é‡å¯¹æ¯”          â”‚
â”‚ è´Ÿè½½å‡è¡¡     â”‚ å„åˆ†ç‰‡QPSå¯¹æ¯”            â”‚
â”‚ è·¯ç”±æ•ˆç‡     â”‚ å•åˆ†ç‰‡/è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹      â”‚
â”‚ è¿ç§»çŠ¶æ€     â”‚ æ•°æ®è¿ç§»è¿›åº¦/æˆåŠŸç‡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š ç›‘æ§æ•°æ®æ”¶é›†**
```java
public class ShardingMonitor {
    
    private MeterRegistry meterRegistry;
    
    public void recordQuery(String shardName, long executionTime, 
                           boolean crossShard) {
        // è®°å½•æŸ¥è¯¢æ¬¡æ•°
        Counter.builder("sharding.query.count")
                .tag("shard", shardName)
                .tag("cross_shard", String.valueOf(crossShard))
                .register(meterRegistry)
                .increment();
        
        // è®°å½•æ‰§è¡Œæ—¶é—´
        Timer.builder("sharding.query.time")
                .tag("shard", shardName)
                .register(meterRegistry)
                .record(executionTime, TimeUnit.MILLISECONDS);
    }
    
    // æ”¶é›†åˆ†ç‰‡æ•°æ®é‡
    public void collectShardDataSize() {
        for (String shardName : getAllShards()) {
            long dataSize = getShardDataSize(shardName);
            
            Gauge.builder("sharding.data.size")
                    .tag("shard", shardName)
                    .register(meterRegistry, () -> dataSize);
        }
    }
}
```

### 9.2 æ€§èƒ½å‘Šè­¦ç³»ç»Ÿ


**ğŸš¨ å‘Šè­¦è§„åˆ™è®¾ç½®**
```yaml
# å‘Šè­¦è§„åˆ™é…ç½®
alerts:
  # å“åº”æ—¶é—´å‘Šè­¦
  - name: slow_query_alert
    condition: avg_response_time > 1000ms
    duration: 5m
    message: "åˆ†ç‰‡{{$shard}}å“åº”æ—¶é—´è¿‡é•¿: {{$value}}ms"
    
  # æ•°æ®å€¾æ–œå‘Šè­¦  
  - name: data_skew_alert
    condition: max_shard_size / min_shard_size > 2
    duration: 10m
    message: "æ•°æ®åˆ†å¸ƒä¸å‡ï¼Œæœ€å¤§åˆ†ç‰‡æ˜¯æœ€å°åˆ†ç‰‡çš„{{$ratio}}å€"
    
  # è¿æ¥æ•°å‘Šè­¦
  - name: connection_alert
    condition: active_connections > 80% of max_connections
    duration: 3m
    message: "åˆ†ç‰‡{{$shard}}è¿æ¥æ•°è¿‡é«˜: {{$value}}/{{$max}}"
    
  # è·¨åˆ†ç‰‡æŸ¥è¯¢å‘Šè­¦
  - name: cross_shard_alert
    condition: cross_shard_ratio > 30%
    duration: 15m
    message: "è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹è¿‡é«˜: {{$value}}%"
```

**ğŸ“§ å‘Šè­¦å¤„ç†æµç¨‹**
```java
public class AlertHandler {
    
    @EventListener
    public void handleSlowQueryAlert(SlowQueryAlert alert) {
        // 1. è®°å½•å‘Šè­¦æ—¥å¿—
        log.warn("æ…¢æŸ¥è¯¢å‘Šè­¦: shard={}, time={}ms", 
                 alert.getShardName(), alert.getResponseTime());
        
        // 2. å‘é€é€šçŸ¥
        notificationService.sendAlert(alert);
        
        // 3. è‡ªåŠ¨ä¼˜åŒ–æªæ–½
        if (alert.getResponseTime() > 5000) {
            // å“åº”æ—¶é—´è¶…è¿‡5ç§’ï¼Œè‡ªåŠ¨å¢åŠ ç¼“å­˜
            cacheService.increaseCache(alert.getShardName());
        }
        
        // 4. æ”¶é›†è¯Šæ–­ä¿¡æ¯
        diagnosticService.collectSlowQueryInfo(alert);
    }
    
    @EventListener 
    public void handleDataSkewAlert(DataSkewAlert alert) {
        // æ•°æ®å€¾æ–œå‘Šè­¦å¤„ç†
        log.warn("æ•°æ®å€¾æ–œå‘Šè­¦: ratio={}", alert.getSkewRatio());
        
        // å»ºè®®è¿›è¡Œæ•°æ®é‡å¹³è¡¡
        rebalanceService.suggestRebalance(alert.getShardInfo());
    }
}
```

### 9.3 æ€§èƒ½åˆ†æå·¥å…·


**ğŸ” æ…¢æŸ¥è¯¢åˆ†æ**
```java
public class SlowQueryAnalyzer {
    
    public SlowQueryReport analyzeSlowQueries(String shardName, 
                                             Date startTime, Date endTime) {
        List<SlowQuery> slowQueries = collectSlowQueries(shardName, 
                                                        startTime, endTime);
        
        SlowQueryReport report = new SlowQueryReport();
        
        // æŒ‰SQLæ¨¡å¼åˆ†ç»„ç»Ÿè®¡
        Map<String, List<SlowQuery>> groupedQueries = slowQueries.stream()
            .collect(Collectors.groupingBy(this::extractSQLPattern));
        
        for (Map.Entry<String, List<SlowQuery>> entry : groupedQueries.entrySet()) {
            String pattern = entry.getKey();
            List<SlowQuery> queries = entry.getValue();
            
            SlowQueryStats stats = new SlowQueryStats();
            stats.setPattern(pattern);
            stats.setCount(queries.size());
            stats.setAvgTime(calculateAvgTime(queries));
            stats.setMaxTime(calculateMaxTime(queries));
            
            report.addStats(stats);
        }
        
        // ç”Ÿæˆä¼˜åŒ–å»ºè®®
        List<OptimizationSuggestion> suggestions = generateSuggestions(report);
        report.setSuggestions(suggestions);
        
        return report;
    }
    
    private List<OptimizationSuggestion> generateSuggestions(SlowQueryReport report) {
        List<OptimizationSuggestion> suggestions = new ArrayList<>();
        
        for (SlowQueryStats stats : report.getStats()) {
            if (stats.getPattern().contains("WHERE") && 
                !stats.getPattern().contains("INDEX")) {
                suggestions.add(new OptimizationSuggestion(
                    "å»ºè®®ä¸ºæŸ¥è¯¢æ¡ä»¶æ·»åŠ ç´¢å¼•: " + extractWhereCondition(stats.getPattern())
                ));
            }
            
            if (stats.getAvgTime() > 1000 && stats.getCount() > 100) {
                suggestions.add(new OptimizationSuggestion(
                    "é«˜é¢‘æ…¢æŸ¥è¯¢ï¼Œå»ºè®®å¢åŠ ç¼“å­˜: " + stats.getPattern()
                ));
            }
        }
        
        return suggestions;
    }
}
```

### 9.4 ç›‘æ§æŠ¥è¡¨ç³»ç»Ÿ


**ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿åˆ†æ**
```java
public class PerformanceDashboard {
    
    // ç”Ÿæˆåˆ†ç‰‡æ€§èƒ½æŠ¥è¡¨
    public ShardingPerformanceReport generateReport(Date startDate, Date endDate) {
        ShardingPerformanceReport report = new ShardingPerformanceReport();
        
        // 1. æŸ¥è¯¢é‡è¶‹åŠ¿
        List<QueryVolumeData> queryTrend = collectQueryVolumeTrend(startDate, endDate);
        report.setQueryVolumeTrend(queryTrend);
        
        // 2. å“åº”æ—¶é—´è¶‹åŠ¿
        List<ResponseTimeData> responseTrend = collectResponseTimeTrend(startDate, endDate);
        report.setResponseTimeTrend(responseTrend);
        
        // 3. åˆ†ç‰‡è´Ÿè½½åˆ†å¸ƒ
        Map<String, ShardLoadData> shardLoads = collectShardLoads(startDate, endDate);
        report.setShardLoads(shardLoads);
        
        // 4. è·¨åˆ†ç‰‡æŸ¥è¯¢åˆ†æ
        CrossShardAnalysis crossShardAnalysis = analyzeCrossShardQueries(startDate, endDate);
        report.setCrossShardAnalysis(crossShardAnalysis);
        
        // 5. ç”Ÿæˆä¼˜åŒ–å»ºè®®
        List<String> recommendations = generateOptimizationRecommendations(report);
        report.setRecommendations(recommendations);
        
        return report;
    }
    
    private List<String> generateOptimizationRecommendations(ShardingPerformanceReport report) {
        List<String> recommendations = new ArrayList<>();
        
        // åˆ†ææ•°æ®å€¾æ–œ
        double maxLoad = report.getShardLoads().values().stream()
            .mapToDouble(ShardLoadData::getLoadValue)
            .max().orElse(0);
        double minLoad = report.getShardLoads().values().stream()
            .mapToDouble(ShardLoadData::getLoadValue)
            .min().orElse(0);
            
        if (maxLoad / minLoad > 2.0) {
            recommendations.add("å­˜åœ¨æ•°æ®å€¾æ–œé—®é¢˜ï¼Œå»ºè®®è¿›è¡Œåˆ†ç‰‡é‡å¹³è¡¡");
        }
        
        // åˆ†æè·¨åˆ†ç‰‡æŸ¥è¯¢
        if (report.getCrossShardAnalysis().getCrossShardRatio() > 0.3) {
            recommendations.add("è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹è¿‡é«˜ï¼Œå»ºè®®ä¼˜åŒ–åˆ†ç‰‡é”®æˆ–ä¸šåŠ¡é€»è¾‘");
        }
        
        // åˆ†æå“åº”æ—¶é—´
        double avgResponseTime = report.getResponseTimeTrend().stream()
            .mapToDouble(ResponseTimeData::getAvgTime)
            .average().orElse(0);
            
        if (avgResponseTime > 500) {
            recommendations.add("å¹³å‡å“åº”æ—¶é—´è¿‡é•¿ï¼Œå»ºè®®æ·»åŠ ç´¢å¼•æˆ–å¢åŠ ç¼“å­˜");
        }
        
        return recommendations;
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 åˆ†åº“åˆ†è¡¨æ ¸å¿ƒæ¦‚å¿µ

```
ğŸ”¸ æœ¬è´¨ç†è§£ï¼šåˆ†åº“åˆ†è¡¨æ˜¯æŠŠå¤§è¡¨æ‹†åˆ†æˆå°è¡¨ï¼Œæå‡æ€§èƒ½
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šå•è¡¨æ•°æ®é‡è¶…è¿‡500ä¸‡-2000ä¸‡æ—¶è€ƒè™‘
ğŸ”¸ æ‹†åˆ†æ–¹å¼ï¼šå‚ç›´æ‹†åˆ†ï¼ˆæŒ‰ä¸šåŠ¡ï¼‰+ æ°´å¹³æ‹†åˆ†ï¼ˆæŒ‰æ•°æ®é‡ï¼‰
ğŸ”¸ æ ¸å¿ƒæŒ‘æˆ˜ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æ•°æ®ä¸€è‡´æ€§
```

### 10.2 åˆ†ç‰‡ç­–ç•¥è®¾è®¡è¦ç‚¹


**ğŸ¯ åˆ†ç‰‡é”®é€‰æ‹©é»„é‡‘æ³•åˆ™**
```
ä¼˜å…ˆçº§1ï¼šæ•°æ®åˆ†å¸ƒå‡åŒ€ï¼ˆé¿å…çƒ­ç‚¹ï¼‰
ä¼˜å…ˆçº§2ï¼šæŸ¥è¯¢è·¯ç”±ç®€å•ï¼ˆå‡å°‘è·¨åˆ†ç‰‡ï¼‰  
ä¼˜å…ˆçº§3ï¼šä¸šåŠ¡é€»è¾‘æ¸…æ™°ï¼ˆä¾¿äºç»´æŠ¤ï¼‰

âœ… æ¨èçš„åˆ†ç‰‡é”®ï¼š
- ç”¨æˆ·IDï¼šåˆ†å¸ƒå‡åŒ€ï¼Œç”¨æˆ·ç›¸å…³æŸ¥è¯¢å±…å¤š
- è®¢å•IDï¼šåˆ†å¸ƒéšæœºï¼Œé¿å…æ—¶é—´çƒ­ç‚¹
- å“ˆå¸Œå€¼ï¼šäººå·¥è®¡ç®—ï¼Œä¿è¯åˆ†å¸ƒå‡åŒ€

âŒ é¿å…çš„åˆ†ç‰‡é”®ï¼š
- æ—¶é—´å­—æ®µï¼šæ–°æ•°æ®é›†ä¸­ï¼Œå½¢æˆçƒ­ç‚¹
- åœ°åŸŸå­—æ®µï¼šåˆ†å¸ƒä¸å‡ï¼Œä¸€çº¿åŸå¸‚æ•°æ®å¤š
- çŠ¶æ€å­—æ®µï¼šæŸäº›çŠ¶æ€æ•°æ®ç‰¹åˆ«å¤š
```

### 10.3 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


**âš¡ æŸ¥è¯¢ä¼˜åŒ–**
```
å•åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š
- ç¡®ä¿åˆ†ç‰‡é”®åœ¨WHEREæ¡ä»¶ä¸­
- é¿å…å…¨è¡¨æ‰«æå’Œå¤æ‚JOIN
- åˆç†ä½¿ç”¨ç´¢å¼•

è·¨åˆ†ç‰‡æŸ¥è¯¢ä¼˜åŒ–ï¼š
- å°½é‡åœ¨åº”ç”¨å±‚åˆå¹¶ç»“æœ
- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿LIMIT OFFSET
- é€‚å½“çš„æ•°æ®å†—ä½™å‡å°‘å…³è”æŸ¥è¯¢

èšåˆæŸ¥è¯¢ä¼˜åŒ–ï¼š
- å¹¶è¡Œæ‰§è¡Œå„åˆ†ç‰‡æŸ¥è¯¢
- åœ¨åº”ç”¨å±‚è¿›è¡Œç»“æœæ±‡æ€»
- ä½¿ç”¨é¢„èšåˆè¡¨å¤„ç†å¤æ‚ç»Ÿè®¡
```

**ğŸ”„ äº‹åŠ¡å¤„ç†ç­–ç•¥**
```
ç®€å•åœºæ™¯ï¼š
- å•åˆ†ç‰‡äº‹åŠ¡ï¼šä½¿ç”¨æ•°æ®åº“æœ¬åœ°äº‹åŠ¡
- å¼‚æ­¥è¡¥å¿ï¼šéæ ¸å¿ƒæ“ä½œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—

å¤æ‚åœºæ™¯ï¼š
- TCCæ¨¡å¼ï¼šé«˜æ€§èƒ½è¦æ±‚çš„åˆ†å¸ƒå¼äº‹åŠ¡
- Sagaæ¨¡å¼ï¼šé•¿æµç¨‹çš„ä¸šåŠ¡äº‹åŠ¡
- æœ¬åœ°æ¶ˆæ¯è¡¨ï¼šä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

### 10.4 è¿ç»´ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“Š ç›‘æ§ä½“ç³»**
```
å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡ï¼š
- å„åˆ†ç‰‡QPSå’Œå“åº”æ—¶é—´
- æ•°æ®åˆ†å¸ƒå‡åŒ€åº¦
- è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹
- æ…¢æŸ¥è¯¢ç»Ÿè®¡

å‘Šè­¦æœºåˆ¶ï¼š
- å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼
- æ•°æ®å€¾æ–œè¶…è¿‡æ¯”ä¾‹
- è¿æ¥æ•°æ¥è¿‘ä¸Šé™
- å¼‚å¸¸é”™è¯¯ç‡å‡é«˜
```

**ğŸš€ æ‰©å®¹ç­–ç•¥**
```
é¢„æ¡ˆå‡†å¤‡ï¼š
- ç›‘æ§æ•°æ®å¢é•¿è¶‹åŠ¿
- æå‰è§„åˆ’æ‰©å®¹æ–¹æ¡ˆ
- å‡†å¤‡æ•°æ®è¿ç§»å·¥å…·

æ‰©å®¹æ‰§è¡Œï¼š
- ä½¿ç”¨åŒå†™æ¨¡å¼å‡å°‘åœæœºæ—¶é—´
- åˆ†æ‰¹è¿ç§»é™ä½å½±å“
- å……åˆ†éªŒè¯æ•°æ®ä¸€è‡´æ€§

æ‰©å®¹éªŒè¯ï¼š
- åŠŸèƒ½æµ‹è¯•ç¡®ä¿ä¸šåŠ¡æ­£å¸¸
- æ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœ
- å›æ»šæ–¹æ¡ˆåº”å¯¹çªå‘é—®é¢˜
```

### 10.5 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ


**ğŸ› å…¸å‹é—®é¢˜åŠå¯¹ç­–**
```
é—®é¢˜1ï¼šæ•°æ®å€¾æ–œçƒ­ç‚¹
è§£å†³ï¼šé‡æ–°é€‰æ‹©åˆ†ç‰‡é”®ï¼Œä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ

é—®é¢˜2ï¼šè·¨åˆ†ç‰‡æŸ¥è¯¢æ…¢
è§£å†³ï¼šä¸šåŠ¡å±‚ä¼˜åŒ–ï¼Œæ•°æ®å†—ä½™ï¼Œåˆ†é¡µä¼˜åŒ–

é—®é¢˜3ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¤æ‚
è§£å†³ï¼šä¸šåŠ¡æ‹†åˆ†ï¼Œå¼‚æ­¥åŒ–ï¼Œæœ€ç»ˆä¸€è‡´æ€§

é—®é¢˜4ï¼šæ•°æ®è¿ç§»é£é™©
è§£å†³ï¼šåŒå†™æ¨¡å¼ï¼Œåˆ†æ‰¹è¿ç§»ï¼Œå……åˆ†éªŒè¯

é—®é¢˜5ï¼šè¿ç»´å¤æ‚åº¦é«˜  
è§£å†³ï¼šè‡ªåŠ¨åŒ–å·¥å…·ï¼Œç›‘æ§å‘Šè­¦ï¼Œæ ‡å‡†åŒ–æµç¨‹
```

### 10.6 é€‰æ‹©å»ºè®®


**ğŸšï¸ æŠ€æœ¯é€‰å‹æŒ‡å—**
```
æ•°æ®é‡çº§ï¼š
< 500ä¸‡ï¼šä¸éœ€è¦åˆ†åº“åˆ†è¡¨
500ä¸‡-2000ä¸‡ï¼šè€ƒè™‘åˆ†è¡¨
> 5000ä¸‡ï¼šè€ƒè™‘åˆ†åº“åˆ†è¡¨

ä¸šåŠ¡ç‰¹ç‚¹ï¼š
è¯»å¤šå†™å°‘ï¼šè¯»å†™åˆ†ç¦» + åˆ†è¡¨
å†™å¤šè¯»å°‘ï¼šåˆ†åº“åˆ†è¡¨ + ç¼“å­˜
å¤æ‚æŸ¥è¯¢ï¼šé€‚å½“å†—ä½™ + æœç´¢å¼•æ“

å›¢é˜Ÿèƒ½åŠ›ï¼š
æŠ€æœ¯å®åŠ›å¼ºï¼šè‡ªç ”åˆ†ç‰‡ä¸­é—´ä»¶
æŠ€æœ¯å®åŠ›ä¸€èˆ¬ï¼šä½¿ç”¨æˆç†Ÿäº§å“(ShardingSphereç­‰)
åˆåˆ›å›¢é˜Ÿï¼šäº‘æ•°æ®åº“åˆ†ç‰‡æœåŠ¡
```

**ğŸ’¡ æ ¸å¿ƒè®°å¿†**
- åˆ†åº“åˆ†è¡¨æ˜¯æ€§èƒ½é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œä¸æ˜¯ä¸‡èƒ½é’¥åŒ™
- åˆ†ç‰‡é”®é€‰æ‹©å†³å®š90%çš„åç»­é—®é¢˜å’Œæ€§èƒ½
- é¿å…åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯è®¾è®¡çš„æœ€é«˜åŸåˆ™
- ç›‘æ§å’Œè¿ç»´èƒ½åŠ›æ˜¯æˆåŠŸå®æ–½çš„å…³é”®
- ä¸šåŠ¡å‘å±•å’ŒæŠ€æœ¯æ¼”è¿›è¦ç»Ÿç­¹è§„åˆ’