---
title: 25ã€åº”ç”¨SQLæ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [ORMæ¡†æ¶æ€§èƒ½ä¼˜åŒ–](#1-ormæ¡†æ¶æ€§èƒ½ä¼˜åŒ–)
2. [æ‰¹é‡æ“ä½œä¼˜åŒ–](#2-æ‰¹é‡æ“ä½œä¼˜åŒ–)
3. [N+1æŸ¥è¯¢é—®é¢˜è§£å†³](#3-n1æŸ¥è¯¢é—®é¢˜è§£å†³)
4. [æ‡’åŠ è½½ç­–ç•¥ä¼˜åŒ–](#4-æ‡’åŠ è½½ç­–ç•¥ä¼˜åŒ–)
5. [ç¼“å­˜ç­–ç•¥é›†æˆ](#5-ç¼“å­˜ç­–ç•¥é›†æˆ)
6. [SQLæ¨¡æ¿ä¼˜åŒ–](#6-sqlæ¨¡æ¿ä¼˜åŒ–)
7. [å‚æ•°åŒ–æŸ¥è¯¢æ€§èƒ½](#7-å‚æ•°åŒ–æŸ¥è¯¢æ€§èƒ½)
8. [åº”ç”¨å±‚SQLç›‘æ§](#8-åº”ç”¨å±‚sqlç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ› ï¸ ORMæ¡†æ¶æ€§èƒ½ä¼˜åŒ–


### 1.1 ORMæ¡†æ¶çš„æœ¬è´¨ç†è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯ORMæ¡†æ¶ï¼Ÿ**
```
ORM = Object-Relational Mappingï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰
ç®€å•ç†è§£ï¼šæŠŠæ•°æ®åº“è¡¨å˜æˆç¨‹åºé‡Œçš„å¯¹è±¡

ä¼ ç»Ÿæ–¹å¼ï¼š
å†™SQL â†’ æ‰§è¡Œ â†’ å¤„ç†ç»“æœé›† â†’ è½¬æ¢æˆå¯¹è±¡

ORMæ–¹å¼ï¼š  
user.getName() â†’ è‡ªåŠ¨ç”ŸæˆSQL â†’ è‡ªåŠ¨æ‰§è¡Œ â†’ è‡ªåŠ¨å°è£…
```

**ğŸ’¡ ORMçš„ä¼˜ç¼ºç‚¹**
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ å¼€å‘æ•ˆç‡é«˜ï¼šä¸ç”¨å†™SQL
â€¢ ä»£ç ç®€æ´ï¼šé¢å‘å¯¹è±¡æ“ä½œ
â€¢ æ•°æ®åº“æ— å…³ï¼šåˆ‡æ¢æ•°æ®åº“æ–¹ä¾¿

âŒ ç¼ºç‚¹ï¼š
â€¢ æ€§èƒ½æŸè€—ï¼šè‡ªåŠ¨ç”Ÿæˆçš„SQLå¯èƒ½ä¸å¤Ÿä¼˜åŒ–
â€¢ çµæ´»æ€§å·®ï¼šå¤æ‚æŸ¥è¯¢éš¾ä»¥å®ç°
â€¢ å­¦ä¹ æˆæœ¬ï¼šéœ€è¦å­¦ä¹ æ¡†æ¶è¯­æ³•
```

### 1.2 ä¸»æµORMæ¡†æ¶æ€§èƒ½å¯¹æ¯”


| **æ¡†æ¶** | **æ€§èƒ½ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŒ–é‡ç‚¹** |
|---------|-------------|-------------|-------------|
| **Hibernate** | `é‡é‡çº§ï¼ŒåŠŸèƒ½å¼ºå¤§` | `å¤æ‚ä¸šåŠ¡ç³»ç»Ÿ` | `æŸ¥è¯¢ç¼“å­˜ã€å»¶è¿ŸåŠ è½½` |
| **MyBatis** | `è½»é‡çº§ï¼ŒSQLå¯æ§` | `éœ€è¦SQLå®šåˆ¶åŒ–` | `SQLä¼˜åŒ–ã€ç»“æœæ˜ å°„` |
| **JPA** | `æ ‡å‡†åŒ–ï¼Œé€šç”¨æ€§å¥½` | `ä¼ä¸šçº§åº”ç”¨` | `æŸ¥è¯¢ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥` |
| **Django ORM** | `ç®€å•æ˜“ç”¨` | `å¿«é€Ÿå¼€å‘` | `æŸ¥è¯¢é›†ä¼˜åŒ–` |

### 1.3 ORMæ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


**ğŸ¯ æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šN+1æŸ¥è¯¢
List<User> users = userRepository.findAll();
for(User user : users) {
    user.getOrders(); // æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šé¢„åŠ è½½å…³è”æ•°æ®
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders")
List<User> findAllWithOrders();
```

**ğŸ“Š æ‰¹é‡æ“ä½œä¼˜åŒ–**
```java
// âŒ é€æ¡æ’å…¥ï¼š1000æ¬¡æ•°æ®åº“äº¤äº’
for(User user : users) {
    userRepository.save(user);
}

// âœ… æ‰¹é‡æ’å…¥ï¼š1æ¬¡æ•°æ®åº“äº¤äº’
userRepository.saveAll(users);
```

---

## 2. ğŸ“¦ æ‰¹é‡æ“ä½œä¼˜åŒ–


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ“ä½œ


**ğŸ”¸ å•æ¡æ“ä½œçš„é—®é¢˜**
```
ç½‘ç»œå»¶è¿Ÿç¤ºæ„å›¾ï¼š

åº”ç”¨æœåŠ¡å™¨ â†--20ms--â†’ æ•°æ®åº“æœåŠ¡å™¨

å•æ¡æ“ä½œï¼š
æ’å…¥1000æ¡æ•°æ® = 1000æ¬¡ Ã— 20ms = 20ç§’

æ‰¹é‡æ“ä½œï¼š  
æ’å…¥1000æ¡æ•°æ® = 1æ¬¡ Ã— 20ms = 0.02ç§’

æ€§èƒ½æå‡ï¼š1000å€ï¼
```

### 2.2 æ‰¹é‡æ’å…¥ä¼˜åŒ–æŠ€æœ¯


**ğŸ’¡ JDBCæ‰¹é‡æ’å…¥**
```java
// âœ… JDBCåŸç”Ÿæ‰¹é‡æ’å…¥
public void batchInsert(List<User> users) {
    String sql = "INSERT INTO user(name, email) VALUES(?, ?)";
    
    try(PreparedStatement ps = conn.prepareStatement(sql)) {
        for(User user : users) {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
            ps.addBatch(); // æ·»åŠ åˆ°æ‰¹æ¬¡
        }
        ps.executeBatch(); // æ‰¹é‡æ‰§è¡Œ
    }
}
```

**ğŸ”§ MyBatisæ‰¹é‡æ“ä½œ**
```xml
<!-- æ‰¹é‡æ’å…¥ -->
<insert id="batchInsert">
    INSERT INTO user(name, email) VALUES
    <foreach collection="users" item="user" separator=",">
        (#{user.name}, #{user.email})
    </foreach>
</insert>

<!-- æ‰¹é‡æ›´æ–° -->
<update id="batchUpdate">
    <foreach collection="users" item="user" separator=";">
        UPDATE user SET name=#{user.name} WHERE id=#{user.id}
    </foreach>
</update>
```

### 2.3 æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ


**âš¡ æ‰¹é‡å¤§å°æ§åˆ¶**
```java
// ğŸ¯ åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é‡
public void batchProcess(List<User> users) {
    int batchSize = 1000; // æ¯æ‰¹1000æ¡
    
    for(int i = 0; i < users.size(); i += batchSize) {
        int end = Math.min(i + batchSize, users.size());
        List<User> batch = users.subList(i, end);
        
        userRepository.saveAll(batch); // æ‰¹é‡ä¿å­˜
        entityManager.flush();         // å¼ºåˆ¶åˆ·æ–°
        entityManager.clear();         // æ¸…ç†ç¼“å­˜
    }
}
```

> **ğŸ§  è®°å¿†è¦ç‚¹**ï¼šæ‰¹é‡æ“ä½œ = å‡å°‘ç½‘ç»œäº¤äº’ = æ€§èƒ½æå‡

---

## 3. âš ï¸ N+1æŸ¥è¯¢é—®é¢˜è§£å†³


### 3.1 ä»€ä¹ˆæ˜¯N+1æŸ¥è¯¢é—®é¢˜


**ğŸ”¸ N+1é—®é¢˜çš„æœ¬è´¨**
```
å‡è®¾æŸ¥è¯¢10ä¸ªç”¨æˆ·åŠå…¶è®¢å•ä¿¡æ¯ï¼š

âŒ N+1æŸ¥è¯¢ï¼š
1. SELECT * FROM user LIMIT 10           (1æ¬¡æŸ¥è¯¢)
2. SELECT * FROM order WHERE user_id = 1 (ç¬¬1ä¸ªç”¨æˆ·)
3. SELECT * FROM order WHERE user_id = 2 (ç¬¬2ä¸ªç”¨æˆ·)
4. ...
11. SELECT * FROM order WHERE user_id = 10 (ç¬¬10ä¸ªç”¨æˆ·)

æ€»å…±ï¼š1 + 10 = 11æ¬¡æ•°æ®åº“æŸ¥è¯¢

âœ… æ­£ç¡®æ–¹å¼ï¼š
1. SELECT u.*, o.* FROM user u 
   LEFT JOIN order o ON u.id = o.user_id LIMIT 10

æ€»å…±ï¼š1æ¬¡æ•°æ®åº“æŸ¥è¯¢
```

### 3.2 N+1é—®é¢˜çš„è¯†åˆ«


**ğŸ” å¦‚ä½•å‘ç°N+1é—®é¢˜**
```java
// è¿™æ®µä»£ç çœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†éšè—äº†N+1é—®é¢˜
@GetMapping("/users")  
public List<UserDTO> getUsers() {
    List<User> users = userService.findAll(); // 1æ¬¡æŸ¥è¯¢
    
    return users.stream()
        .map(user -> {
            UserDTO dto = new UserDTO();
            dto.setName(user.getName());
            dto.setOrderCount(user.getOrders().size()); // Næ¬¡æŸ¥è¯¢ï¼
            return dto;
        })
        .collect(toList());
}
```

**ğŸ“Š SQLç›‘æ§æ—¥å¿—ç¤ºä¾‹**
```
2025-01-15 10:30:01 - SELECT * FROM user
2025-01-15 10:30:01 - SELECT * FROM order WHERE user_id = 1
2025-01-15 10:30:01 - SELECT * FROM order WHERE user_id = 2
2025-01-15 10:30:01 - SELECT * FROM order WHERE user_id = 3
...

ğŸš¨ è­¦å‘Šï¼šå¦‚æœçœ‹åˆ°è¿™ç§é‡å¤çš„SELECTï¼Œå°±æ˜¯N+1é—®é¢˜ï¼
```

### 3.3 N+1é—®é¢˜è§£å†³æ–¹æ¡ˆ


**âœ… æ–¹æ¡ˆ1ï¼šé¢„åŠ è½½ï¼ˆEager Loadingï¼‰**
```java
// JPAæ–¹å¼
@Query("SELECT u FROM User u LEFT JOIN FETCH u.orders")
List<User> findAllWithOrders();

// MyBatisæ–¹å¼
<select id="findAllWithOrders" resultMap="userWithOrders">
    SELECT u.*, o.* FROM user u 
    LEFT JOIN order o ON u.id = o.user_id
</select>
```

**âœ… æ–¹æ¡ˆ2ï¼šåˆ†æ­¥æŸ¥è¯¢ä¼˜åŒ–**
```java
// å…ˆæŸ¥ä¸»è¡¨
List<User> users = userRepository.findAll();
List<Long> userIds = users.stream()
    .map(User::getId).collect(toList());

// æ‰¹é‡æŸ¥è¯¢å…³è”æ•°æ®
Map<Long, List<Order>> orderMap = orderRepository
    .findByUserIdIn(userIds)
    .stream()
    .collect(groupingBy(Order::getUserId));

// æ‰‹åŠ¨ç»„è£…æ•°æ®
users.forEach(user -> 
    user.setOrders(orderMap.get(user.getId())));
```

**ğŸ“ˆ æ€§èƒ½å¯¹æ¯”**
```
æ•°æ®é‡ï¼š100ä¸ªç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·5ä¸ªè®¢å•

N+1æŸ¥è¯¢ï¼š101æ¬¡SQLï¼Œè€—æ—¶ï¼š101 Ã— 10ms = 1010ms
é¢„åŠ è½½ï¼š  1æ¬¡SQLï¼Œè€—æ—¶ï¼š1 Ã— 50ms = 50ms
æ€§èƒ½æå‡ï¼š20å€ï¼
```

---

## 4. ğŸ˜´ æ‡’åŠ è½½ç­–ç•¥ä¼˜åŒ–


### 4.1 æ‡’åŠ è½½çš„å·¥ä½œåŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ‡’åŠ è½½ï¼Ÿ**
```
æ‡’åŠ è½½ = ç”¨åˆ°çš„æ—¶å€™æ‰å»æŸ¥è¯¢

æ¯”å¦‚ï¼š
User user = userRepository.findById(1); // åªæŸ¥userè¡¨
user.getName(); // ç›´æ¥è¿”å›ï¼Œå·²ç»æœ‰æ•°æ®

user.getOrders(); // è¿™æ—¶æ‰å»æŸ¥orderè¡¨
```

**ğŸ’¡ æ‡’åŠ è½½çš„è§¦å‘æ—¶æœº**
```java
@Entity
public class User {
    @OneToMany(fetch = FetchType.LAZY) // æ‡’åŠ è½½
    private List<Order> orders;
    
    // è®¿é—®ordersæ—¶æ‰ä¼šæŸ¥è¯¢æ•°æ®åº“
    public List<Order> getOrders() {
        return orders; // è§¦å‘SQLæŸ¥è¯¢
    }
}
```

### 4.2 æ‡’åŠ è½½çš„é™·é˜±ä¸è§£å†³


**âš ï¸ å¸¸è§é™·é˜±ï¼šLazyInitializationException**
```java
// âŒ ä¼šå‡ºé”™çš„ä»£ç 
@Transactional
public User getUser(Long id) {
    return userRepository.findById(id);
} // äº‹åŠ¡ç»“æŸï¼ŒSessionå…³é—­

public void printOrders(User user) {
    user.getOrders().forEach(System.out::println); 
    // æŠ¥é”™ï¼šLazyInitializationException
}
```

**âœ… è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

| **è§£å†³æ–¹æ¡ˆ** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|-------------|-------------|-----------|
| **äº‹åŠ¡å†…è®¿é—®** | `ç¡®å®šéœ€è¦å…³è”æ•°æ®` | `ç®€å•ï¼Œä½†å¢åŠ äº‹åŠ¡æ—¶é—´` |
| **é¢„åŠ è½½** | `æ€»æ˜¯éœ€è¦å…³è”æ•°æ®` | `ä¸€æ¬¡æ€§è·å–ï¼Œé¿å…æ‡’åŠ è½½` |
| **DTOæ¨¡å¼** | `åªéœ€è¦éƒ¨åˆ†å­—æ®µ` | `æ˜ç¡®æ•°æ®ä¼ è¾“ï¼Œæ€§èƒ½å¥½` |

### 4.3 æ‡’åŠ è½½ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ æ™ºèƒ½æ‡’åŠ è½½é…ç½®**
```java
// é…ç½®åˆç†çš„æ‡’åŠ è½½ç­–ç•¥
@Entity
public class User {
    // å¸¸ç”¨å­—æ®µï¼šç«‹å³åŠ è½½
    @OneToOne(fetch = FetchType.EAGER)
    private UserProfile profile;
    
    // å¤§æ•°æ®é‡ï¼šæ‡’åŠ è½½
    @OneToMany(fetch = FetchType.LAZY)
    private List<Order> orders;
    
    // å¾ˆå°‘ç”¨ï¼šæ‡’åŠ è½½
    @OneToMany(fetch = FetchType.LAZY)
    private List<LoginLog> loginLogs;
}
```

---

## 5. ğŸ’¾ ç¼“å­˜ç­–ç•¥é›†æˆ


### 5.1 ç¼“å­˜åœ¨åº”ç”¨ä¸­çš„ä½ç½®


**ğŸ“Š å¤šçº§ç¼“å­˜æ¶æ„å›¾**
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
åº”ç”¨æœåŠ¡å™¨
    â†“
[ä¸€çº§ç¼“å­˜] â† æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚Caffeineï¼‰
    â†“
[äºŒçº§ç¼“å­˜] â† åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚Redisï¼‰
    â†“
æ•°æ®åº“
```

### 5.2 ORMä¸­çš„ç¼“å­˜æœºåˆ¶


**ğŸ”¸ Hibernateç¼“å­˜å±‚çº§**
```
ä¸€çº§ç¼“å­˜ï¼ˆSessionçº§åˆ«ï¼‰ï¼š
â€¢ è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€é…ç½®
â€¢ ç”Ÿå‘½å‘¨æœŸä¸Sessionç›¸åŒ
â€¢ åŒä¸€Sessionå†…ç›¸åŒIDçš„å¯¹è±¡åªæŸ¥è¯¢ä¸€æ¬¡

äºŒçº§ç¼“å­˜ï¼ˆSessionFactoryçº§åˆ«ï¼‰ï¼š
â€¢ éœ€è¦æ‰‹åŠ¨é…ç½®
â€¢ è·¨Sessionå…±äº«
â€¢ é€‚åˆåªè¯»æˆ–å¾ˆå°‘ä¿®æ”¹çš„æ•°æ®
```

**âš¡ ç¼“å­˜é…ç½®ç¤ºä¾‹**
```java
// å®ä½“ç¼“å­˜é…ç½®
@Entity
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_ONLY)
public class Category {
    // åˆ†ç±»ä¿¡æ¯å¾ˆå°‘å˜æ›´ï¼Œé€‚åˆç¼“å­˜
}

// æŸ¥è¯¢ç¼“å­˜é…ç½®
@Query(value = "SELECT u FROM User u WHERE u.status = :status")
@QueryHints(@QueryHint(name = "org.hibernate.cacheable", value = "true"))
List<User> findActiveUsers(@Param("status") String status);
```

### 5.3 åº”ç”¨å±‚ç¼“å­˜ç­–ç•¥


**ğŸ¯ ç¼“å­˜ä½¿ç”¨åœºæ™¯åˆ¤æ–­**

```
âœ… é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
â€¢ è¯»å¤šå†™å°‘ï¼šå•†å“åˆ†ç±»ã€é…ç½®ä¿¡æ¯
â€¢ è®¡ç®—å¤æ‚ï¼šç»Ÿè®¡æŠ¥è¡¨ã€æ’è¡Œæ¦œ
â€¢ å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šç”¨æˆ·åŸºç¡€ä¿¡æ¯

âŒ ä¸é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
â€¢ é¢‘ç¹å˜åŒ–ï¼šåº“å­˜æ•°é‡ã€å®æ—¶ä»·æ ¼
â€¢ å®æ—¶æ€§è¦æ±‚é«˜ï¼šæ”¯ä»˜çŠ¶æ€ã€è®¢å•çŠ¶æ€
â€¢ æ•°æ®é‡å·¨å¤§ï¼šè¯¦ç»†æ—¥å¿—ã€å†å²è®°å½•
```

**ğŸ’¡ Spring Cacheé›†æˆ**
```java
@Service
public class UserService {
    
    // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) {
        return userRepository.findById(id);
    }
    
    // æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "users", key = "#user.id")
    public User updateUser(User user) {
        return userRepository.save(user);
    }
    
    // ç¼“å­˜æŸ¥è¯¢ç»“æœ
    @Cacheable(value = "userList", key = "#status")
    public List<User> findByStatus(String status) {
        return userRepository.findByStatus(status);
    }
}
```

---

## 6. ğŸ“ SQLæ¨¡æ¿ä¼˜åŒ–


### 6.1 ä»€ä¹ˆæ˜¯SQLæ¨¡æ¿


**ğŸ”¸ SQLæ¨¡æ¿çš„æ¦‚å¿µ**
```
SQLæ¨¡æ¿ = å¯é‡ç”¨çš„SQLè¯­å¥æ¨¡å¼

æ™®é€šSQLï¼š
SELECT * FROM user WHERE name = 'å¼ ä¸‰'
SELECT * FROM user WHERE name = 'æå››'

SQLæ¨¡æ¿ï¼š
SELECT * FROM user WHERE name = ?

ä¼˜åŠ¿ï¼š
â€¢ é¢„ç¼–è¯‘ä¼˜åŒ–
â€¢ é˜²æ­¢SQLæ³¨å…¥
â€¢ ä»£ç å¤ç”¨
```

### 6.2 MyBatis SQLæ¨¡æ¿ä¼˜åŒ–


**ğŸ› ï¸ åŠ¨æ€SQLä¼˜åŒ–**
```xml
<!-- âŒ ä½æ•ˆçš„åŠ¨æ€SQL -->
<select id="findUsers" resultType="User">
    SELECT * FROM user WHERE 1=1
    <if test="name != null">
        AND name = #{name}
    </if>
    <if test="email != null">  
        AND email = #{email}
    </if>
</select>

<!-- âœ… ä¼˜åŒ–çš„åŠ¨æ€SQL -->
<select id="findUsers" resultType="User">
    SELECT * FROM user
    <where>
        <if test="name != null and name != ''">
            name = #{name}
        </if>
        <if test="email != null and email != ''">
            AND email = #{email}
        </if>
    </where>
</select>
```

**ğŸ“Š SQLæ¨¡æ¿å¤ç”¨ç­–ç•¥**
```xml
<!-- å®šä¹‰å¯å¤ç”¨çš„SQLç‰‡æ®µ -->
<sql id="userColumns">
    id, name, email, create_time, update_time
</sql>

<sql id="userConditions">
    <where>
        <if test="name != null">name = #{name}</if>
        <if test="status != null">AND status = #{status}</if>
    </where>
</sql>

<!-- ä½¿ç”¨SQLç‰‡æ®µ -->
<select id="findUsers" resultType="User">
    SELECT <include refid="userColumns"/> 
    FROM user 
    <include refid="userConditions"/>
</select>

<select id="countUsers" resultType="int">
    SELECT COUNT(*) FROM user 
    <include refid="userConditions"/>
</select>
```

---

## 7. ğŸ¯ å‚æ•°åŒ–æŸ¥è¯¢æ€§èƒ½


### 7.1 å‚æ•°åŒ–æŸ¥è¯¢çš„é‡è¦æ€§


**ğŸ”¸ é¢„ç¼–è¯‘å¸¦æ¥çš„æ€§èƒ½æå‡**
```
SQLæ‰§è¡Œæµç¨‹ï¼š

éå‚æ•°åŒ–æŸ¥è¯¢ï¼š
è§£æSQL â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ â†’ æ‰§è¡Œ â†’ è¿”å›ç»“æœ
æ¯æ¬¡éƒ½è¦é‡æ–°è§£æå’Œç”Ÿæˆæ‰§è¡Œè®¡åˆ’

å‚æ•°åŒ–æŸ¥è¯¢ï¼š
é¦–æ¬¡ï¼šè§£æSQL â†’ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ â†’ ç¼“å­˜è®¡åˆ’ â†’ æ‰§è¡Œ
åç»­ï¼šå¤ç”¨æ‰§è¡Œè®¡åˆ’ â†’ æ‰§è¡Œ â†’ è¿”å›ç»“æœ

æ€§èƒ½æå‡ï¼šçœç•¥è§£æå’Œè®¡åˆ’ç”Ÿæˆæ­¥éª¤
```

### 7.2 å‚æ•°åŒ–æŸ¥è¯¢æœ€ä½³å®è·µ


**ğŸ’¡ JDBCå‚æ•°åŒ–æŸ¥è¯¢**
```java
// âœ… æ­£ç¡®çš„å‚æ•°åŒ–æŸ¥è¯¢
public User findByEmail(String email) {
    String sql = "SELECT * FROM user WHERE email = ?";
    return jdbcTemplate.queryForObject(sql, User.class, email);
}

// âŒ é”™è¯¯çš„å­—ç¬¦ä¸²æ‹¼æ¥
public User findByEmailWrong(String email) {
    String sql = "SELECT * FROM user WHERE email = '" + email + "'";
    return jdbcTemplate.queryForObject(sql, User.class);
    // 1. æ€§èƒ½å·®ï¼šæ¯æ¬¡é‡æ–°è§£æ
    // 2. å®‰å…¨é£é™©ï¼šSQLæ³¨å…¥
}
```

**ğŸ¯ æ‰¹é‡å‚æ•°ä¼˜åŒ–**
```java
// âœ… æ‰¹é‡å‚æ•°åŒ–æŸ¥è¯¢
public List<User> findByIds(List<Long> ids) {
    String sql = "SELECT * FROM user WHERE id IN (" + 
        ids.stream().map(id -> "?").collect(joining(",")) + ")";
    return jdbcTemplate.query(sql, User.class, ids.toArray());
}

// ğŸ“Š æ€§èƒ½å¯¹æ¯”
// å•æ¬¡æŸ¥è¯¢100ä¸ªIDï¼š
// é€ä¸ªæŸ¥è¯¢ï¼š100æ¬¡æ•°æ®åº“äº¤äº’
// æ‰¹é‡æŸ¥è¯¢ï¼š1æ¬¡æ•°æ®åº“äº¤äº’
```

---

## 8. ğŸ“ˆ åº”ç”¨å±‚SQLç›‘æ§


### 8.1 SQLç›‘æ§çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦SQLç›‘æ§ï¼Ÿ**
```
åº”ç”¨æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š

80% çš„æ€§èƒ½é—®é¢˜æ¥è‡ªæ•°æ®åº“
å…¶ä¸­ï¼š
â€¢ 50% æ˜¯æ…¢SQLå¯¼è‡´
â€¢ 30% æ˜¯ä¸åˆç†çš„æ•°æ®åº“è°ƒç”¨
â€¢ 20% æ˜¯æ•°æ®åº“é…ç½®é—®é¢˜

ç»“è®ºï¼šç›‘æ§SQL = æŠ“ä½æ€§èƒ½ä¼˜åŒ–çš„ç‰›é¼»å­
```

### 8.2 SQLç›‘æ§å·¥å…·ä¸æ–¹æ³•


**ğŸ› ï¸ ç›‘æ§å·¥å…·é€‰æ‹©**

| **å·¥å…·** | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-------------|
| **Druidç›‘æ§** | `SQLæ‰§è¡Œç»Ÿè®¡ï¼Œæ…¢SQLåˆ†æ` | `Javaåº”ç”¨ï¼Œè¯¦ç»†ç›‘æ§` |
| **P6Spy** | `SQLæ—¥å¿—è®°å½•ï¼Œæ ¼å¼åŒ–è¾“å‡º` | `å¼€å‘è°ƒè¯•ï¼ŒSQLè·Ÿè¸ª` |
| **MySQLæ…¢æŸ¥è¯¢æ—¥å¿—** | `æ•°æ®åº“çº§åˆ«ç›‘æ§` | `ç”Ÿäº§ç¯å¢ƒï¼Œæ•°æ®åº“ä¼˜åŒ–` |
| **APMå·¥å…·** | `å…¨é“¾è·¯ç›‘æ§` | `ä¼ä¸šçº§åº”ç”¨ï¼Œæ€§èƒ½åˆ†æ` |

**âš¡ Druidç›‘æ§é…ç½®**
```java
// application.yml
spring:
  datasource:
    druid:
      # å¼€å¯SQLç›‘æ§
      web-stat-filter:
        enabled: true
        url-pattern: /*
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
      # æ…¢SQLé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
      filter:
        stat:
          slow-sql-millis: 1000
          log-slow-sql: true
```

### 8.3 SQLæ€§èƒ½ç›‘æ§å…³é”®æŒ‡æ ‡


**ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```java
// è‡ªå®šä¹‰SQLç›‘æ§
@Component
public class SqlMonitor {
    
    private final MeterRegistry meterRegistry;
    
    // ç›‘æ§SQLæ‰§è¡Œæ—¶é—´
    public void recordSqlExecution(String sql, long executionTime) {
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("sql.execution.time")
            .tag("sql.type", getSqlType(sql))
            .register(meterRegistry));
    }
    
    // ç›‘æ§æ…¢SQL
    public void recordSlowSql(String sql, long executionTime) {
        if (executionTime > 1000) { // è¶…è¿‡1ç§’
            Counter.builder("sql.slow.count")
                .tag("sql", sql)
                .register(meterRegistry)
                .increment();
        }
    }
}
```

**ğŸ¯ ç›‘æ§å‘Šè­¦ç­–ç•¥**
```
å‘Šè­¦çº§åˆ«è®¾ç½®ï¼š

ğŸ”´ ä¸¥é‡å‘Šè­¦ï¼ˆç«‹å³å¤„ç†ï¼‰ï¼š
â€¢ æ…¢SQLæ‰§è¡Œæ—¶é—´ > 5ç§’
â€¢ SQLé”™è¯¯ç‡ > 1%
â€¢ æ•°æ®åº“è¿æ¥æ± å ç”¨ > 90%

ğŸŸ¡ è­¦å‘Šå‘Šè­¦ï¼ˆå…³æ³¨å¤„ç†ï¼‰ï¼š
â€¢ æ…¢SQLæ‰§è¡Œæ—¶é—´ > 1ç§’  
â€¢ å•ä¸ªSQL QPS > 1000
â€¢ å¹³å‡å“åº”æ—¶é—´å¢é•¿ > 50%

ğŸŸ¢ ä¿¡æ¯å‘Šè­¦ï¼ˆæ—¥å¸¸å…³æ³¨ï¼‰ï¼š
â€¢ æ–°å¢æ…¢SQL
â€¢ SQLæ‰§è¡Œè®¡åˆ’å˜æ›´
â€¢ ç´¢å¼•ä½¿ç”¨ç‡ä¸‹é™
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”´ ç»å¯¹è¦æŒæ¡ï¼š
â€¢ N+1æŸ¥è¯¢é—®é¢˜ï¼šæœ€å¸¸è§çš„ORMæ€§èƒ½æ€æ‰‹
â€¢ æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
â€¢ å‚æ•°åŒ–æŸ¥è¯¢ï¼šæ€§èƒ½å’Œå®‰å…¨çš„åŒé‡ä¿éšœ
â€¢ ç¼“å­˜ç­–ç•¥ï¼šåˆç†ä½¿ç”¨å¤šçº§ç¼“å­˜

ğŸŸ¡ é‡è¦ç†è§£ï¼š
â€¢ ORMæ¡†æ¶é€‰æ‹©ï¼šæ ¹æ®é¡¹ç›®ç‰¹ç‚¹é€‰æ‹©åˆé€‚æ¡†æ¶
â€¢ æ‡’åŠ è½½ç­–ç•¥ï¼šå¹³è¡¡å†…å­˜ä½¿ç”¨å’ŒæŸ¥è¯¢æ¬¡æ•°
â€¢ SQLæ¨¡æ¿å¤ç”¨ï¼šæé«˜ä»£ç ç»´æŠ¤æ€§å’Œæ‰§è¡Œæ•ˆç‡
â€¢ SQLç›‘æ§ï¼šæŒç»­ä¼˜åŒ–çš„æ•°æ®æ”¯æ’‘
```

### 9.2 ä¼˜åŒ–ç­–ç•¥è®°å¿†å£è¯€


**ğŸ§  æ ¸å¿ƒè®°å¿†**ï¼š
```
æ‰¹é‡ä»£æ›¿å•æ¡ï¼Œé¢„åŠ è½½è§£N+1
ç¼“å­˜å‡å°‘æŸ¥è¯¢ï¼Œç›‘æ§æ‰¾å‡ºé—®é¢˜
å‚æ•°åŒ–é˜²æ³¨å…¥ï¼Œæ¨¡æ¿æå¤ç”¨æ€§
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… å¼€å‘é˜¶æ®µæ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ˜¯å¦å­˜åœ¨N+1æŸ¥è¯¢é—®é¢˜
- [ ] æ‰¹é‡æ“ä½œæ˜¯å¦å·²ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥æ˜¯å¦åˆç†
- [ ] SQLæ˜¯å¦éƒ½ä½¿ç”¨å‚æ•°åŒ–
- [ ] æ˜¯å¦é…ç½®SQLç›‘æ§

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–ROIæ’åº**ï¼š
1. **è§£å†³N+1é—®é¢˜** - æŠ•å…¥å°ï¼Œæ•ˆæœæ˜¾è‘—
2. **æ‰¹é‡æ“ä½œä¼˜åŒ–** - ç«‹ç«¿è§å½±çš„æ€§èƒ½æå‡  
3. **åˆç†ä½¿ç”¨ç¼“å­˜** - å‡å°‘æ•°æ®åº“å‹åŠ›
4. **SQLç›‘æ§å»ºè®¾** - æŒç»­ä¼˜åŒ–çš„åŸºç¡€

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå…³æ³¨ç‚¹**ï¼š
- ç›‘æ§æ…¢SQLï¼ŒåŠæ—¶ä¼˜åŒ–
- å…³æ³¨ç¼“å­˜å‘½ä¸­ç‡
- å®šæœŸåˆ†æSQLæ‰§è¡Œç»Ÿè®¡
- å»ºç«‹æ€§èƒ½åŸºçº¿ï¼Œå¯¹æ¯”åˆ†æ

**è®°ä½**ï¼šåº”ç”¨å±‚SQLä¼˜åŒ–ä¸æ˜¯ä¸€æ¬¡æ€§å·¥ä½œï¼Œéœ€è¦æŒç»­ç›‘æ§å’Œæ”¹è¿›ï¼