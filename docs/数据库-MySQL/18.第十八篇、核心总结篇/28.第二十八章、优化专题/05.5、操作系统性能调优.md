---
title: 5、操作系统性能调优
---
## 📚 目录

1. [操作系统调优概述](#1-操作系统调优概述)
2. [内核参数调优](#2-内核参数调优)
3. [文件系统选择与配置](#3-文件系统选择与配置)
4. [IO调度策略优化](#4-IO调度策略优化)
5. [内存管理参数优化](#5-内存管理参数优化)
6. [网络参数调优](#6-网络参数调优)
7. [NUMA架构优化](#7-NUMA架构优化)
8. [透明大页设置](#8-透明大页设置)
9. [系统资源监控](#9-系统资源监控)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔧 操作系统调优概述


### 1.1 为什么要做操作系统调优


**🎯 核心理念**：MySQL数据库的性能不仅仅取决于数据库配置，操作系统作为底层基础平台，其性能直接影响MySQL的运行效率。

```
数据库性能金字塔：
┌─────────────────────┐
│     MySQL配置       │  ← 上层优化
├─────────────────────┤
│   操作系统调优      │  ← 基础优化（本文重点）
├─────────────────────┤
│     硬件性能        │  ← 底层基础
└─────────────────────┘
```

**调优的本质**：
- **资源合理分配**：让MySQL能够充分利用系统资源
- **减少系统开销**：降低不必要的系统调用和上下文切换
- **提升IO效率**：优化磁盘读写性能
- **优化内存使用**：避免内存碎片和不必要的交换

### 1.2 调优的基本思路


**🔸 问题导向**：先发现性能瓶颈，再针对性调优
**🔸 渐进式优化**：一次调整一个参数，观察效果
**🔸 监控验证**：每次调优都要有数据支撑
**🔸 回滚机制**：保留原始配置，确保可以快速回滚

---

## 2. ⚙️ 内核参数调优


### 2.1 什么是内核参数


**内核参数**就像是操作系统的"设置选项"，控制着系统如何管理内存、处理网络连接、调度进程等核心功能。

```
内核参数的作用范围：
应用程序 ←→ 内核参数 ←→ 硬件资源
   MySQL        ↑           CPU/内存/磁盘
              系统行为控制
```

### 2.2 关键内核参数详解


#### 📁 文件描述符相关参数


**`fs.file-max`** - 系统级最大文件句柄数
```bash
# 查看当前值
cat /proc/sys/fs/file-max

# 设置为更大值（推荐100万以上）
echo 'fs.file-max = 1000000' >> /etc/sysctl.conf
```

**含义解释**：每个数据库连接、每个打开的表文件都需要一个文件句柄。MySQL在高并发时会同时打开很多文件，如果系统限制太小，就会出现"Too many open files"错误。

**`fs.nr_open`** - 单个进程最大文件句柄数
```bash
# 设置单进程最大文件句柄数
echo 'fs.nr_open = 1000000' >> /etc/sysctl.conf
```

#### 🌐 网络连接相关参数


**`net.core.somaxconn`** - 监听队列最大长度
```bash
# MySQL高并发连接优化
echo 'net.core.somaxconn = 32768' >> /etc/sysctl.conf
```

**通俗解释**：这就像餐厅的排队区域大小。如果排队区域太小，后来的客人就进不来了。MySQL需要足够大的连接队列来处理突发的大量连接请求。

**`net.ipv4.tcp_max_syn_backlog`** - SYN队列大小
```bash
echo 'net.ipv4.tcp_max_syn_backlog = 32768' >> /etc/sysctl.conf
```

#### 💾 虚拟内存相关参数


**`vm.swappiness`** - 交换倾向控制
```bash
# 减少swap使用，MySQL更偏向使用物理内存
echo 'vm.swappiness = 1' >> /etc/sysctl.conf
```

**重要性**：数据库最怕数据被换出到磁盘，因为磁盘比内存慢几千倍。设置为1意味着只有在内存极度不足时才会使用swap。

**`vm.dirty_ratio`** - 脏页比例控制
```bash
# 控制脏页占总内存的比例
echo 'vm.dirty_ratio = 15' >> /etc/sysctl.conf
echo 'vm.dirty_background_ratio = 5' >> /etc/sysctl.conf
```

**通俗理解**：脏页就是内存中被修改但还没写入磁盘的数据。比例太高会导致突然的大量磁盘写入，影响性能。

### 2.3 内核参数配置实战


**完整配置示例**：
```bash
# 编辑系统配置文件
vim /etc/sysctl.conf

# 添加以下MySQL优化参数
# 文件系统优化
fs.file-max = 1000000
fs.nr_open = 1000000

# 网络优化
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 32768
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300

# 内存管理优化
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 500

# 应用配置
sysctl -p
```

**🔍 验证配置是否生效**：
```bash
# 检查具体参数
sysctl fs.file-max
sysctl vm.swappiness
```

---

## 3. 💽 文件系统选择与配置


### 3.1 文件系统对MySQL的影响


**文件系统**就是操作系统管理磁盘文件的方式，不同的文件系统在性能、可靠性、功能特性上差别很大。

```
MySQL数据存储层次：
MySQL数据 → 文件系统 → 磁盘硬件
    ↓          ↓          ↓
  数据表    文件管理    物理存储
```

### 3.2 主流文件系统对比


| 文件系统 | **MySQL适用性** | **性能特点** | **推荐场景** |
|---------|----------------|-------------|-------------|
| **ext4** | `⭐⭐⭐⭐` | `稳定可靠，兼容性好` | `一般生产环境` |
| **XFS** | `⭐⭐⭐⭐⭐` | `大文件性能优秀` | `大数据库，高IO` |
| **Btrfs** | `⭐⭐⭐` | `快照功能强大` | `开发测试环境` |
| **ZFS** | `⭐⭐⭐⭐` | `数据完整性最佳` | `对数据安全要求极高` |

### 3.3 XFS文件系统优化配置


**为什么选择XFS**：
- **大文件处理能力强**：MySQL的数据文件通常很大
- **并发性能好**：支持多线程并发写入
- **元数据处理效率高**：减少文件操作开销

**XFS挂载优化参数**：
```bash
# 编辑fstab文件
vim /etc/fstab

# 添加优化挂载参数
/dev/sdb1 /var/lib/mysql xfs defaults,noatime,nodiratime,nobarrier,logbufs=8,logbsize=256k 0 0
```

**参数详解**：
- **`noatime`**：不更新文件访问时间，减少磁盘写入
- **`nodiratime`**：不更新目录访问时间
- **`nobarrier`**：禁用写屏障（有电池保护的RAID可用）
- **`logbufs=8`**：增加日志缓冲区数量
- **`logbsize=256k`**：增大日志缓冲区大小

### 3.4 文件系统调优实战


**🔧 ext4文件系统优化**：
```bash
# 调整ext4参数
tune2fs -o journal_data_writeback /dev/sdb1
tune2fs -O ^has_journal /dev/sdb1  # 高性能场景可考虑
```

**⚠️ 注意事项**：
- **备份重要**：文件系统调优前务必备份数据
- **测试验证**：在测试环境先验证效果
- **监控观察**：调优后持续监控系统性能

---

## 4. 🚀 IO调度策略优化


### 4.1 什么是IO调度器


**IO调度器**就像交通指挥员，决定磁盘读写请求的执行顺序。不同的调度策略适合不同的应用场景。

```
应用请求 → IO调度器 → 磁盘控制器 → 磁盘
    ↓         ↓          ↓         ↓
读写操作   排序优化   硬件队列   物理IO
```

### 4.2 主流IO调度器特点


**🔸 CFQ（Completely Fair Queuing）**
```bash
# 查看当前调度器
cat /sys/block/sda/queue/scheduler
# 输出：noop deadline [cfq]  # []内为当前使用的
```

**特点**：每个进程分配独立队列，公平调度
**适用场景**：桌面环境，多用户系统
**MySQL适用性**：❌ 不适合，会限制MySQL的IO性能

**🔸 Deadline**
```bash
# 设置为deadline调度器
echo deadline > /sys/block/sda/queue/scheduler
```

**特点**：保证请求在截止时间内完成，避免饿死
**适用场景**：数据库服务器，实时性要求高
**MySQL适用性**：✅ 推荐，平衡了性能和响应时间

**🔸 NOOP（No Operation）**
```bash
echo noop > /sys/block/sda/queue/scheduler
```

**特点**：简单的FIFO队列，不做复杂调度
**适用场景**：SSD硬盘，硬件RAID
**MySQL适用性**：✅ SSD环境首选

### 4.3 针对存储类型的调度器选择


**🔸 机械硬盘（HDD）环境**：
```bash
# 推荐使用deadline
echo deadline > /sys/block/sda/queue/scheduler

# 调整deadline参数
echo 50 > /sys/block/sda/queue/iosched/read_expire
echo 500 > /sys/block/sda/queue/iosched/write_expire
```

**🔸 固态硬盘（SSD）环境**：
```bash
# 推荐使用noop
echo noop > /sys/block/sda/queue/scheduler
```

**🔸 NVMe SSD环境**：
```bash
# 使用多队列调度器
echo none > /sys/block/nvme0n1/queue/scheduler
```

### 4.4 永久配置IO调度器


**方法一：通过GRUB配置**
```bash
# 编辑GRUB配置
vim /etc/default/grub

# 修改启动参数
GRUB_CMDLINE_LINUX="elevator=deadline"

# 更新GRUB
grub2-mkconfig -o /boot/grub2/grub.cfg
```

**方法二：通过udev规则**
```bash
# 创建udev规则文件
vim /etc/udev/rules.d/60-schedulers.rules

# 根据设备类型设置调度器
# SSD设备使用noop
ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="0", ATTR{queue/scheduler}="noop"
# HDD设备使用deadline
ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", ATTR{queue/scheduler}="deadline"
```

---

## 5. 🧠 内存管理参数优化


### 5.1 Linux内存管理机制


**内存管理的基本概念**：
Linux将内存分为不同的区域和缓存，合理配置这些参数可以大幅提升MySQL性能。

```
Linux内存布局：
┌──────────────────┐
│   应用程序内存    │ ← MySQL进程空间
├──────────────────┤
│   页面缓存       │ ← 文件系统缓存
├──────────────────┤
│   内核空间       │ ← 系统内核
└──────────────────┘
```

### 5.2 关键内存参数详解


#### 💧 Swap相关参数


**`vm.swappiness`** - 控制交换分区使用倾向
```bash
# 查看当前值
cat /proc/sys/vm/swappiness

# 设置为1（几乎不使用swap）
echo 'vm.swappiness = 1' >> /etc/sysctl.conf
```

**为什么设置为1而不是0**：
- 设置为0在某些内核版本可能导致OOM杀死进程
- 设置为1既避免了swap，又保留了紧急情况的后路

#### 📄 脏页管理参数


**脏页**就是内存中已修改但未写入磁盘的数据页面。

**`vm.dirty_ratio`** - 脏页占总内存的最大比例
```bash
echo 'vm.dirty_ratio = 15' >> /etc/sysctl.conf
```

**通俗解释**：假如你有16GB内存，15%就是2.4GB。当脏页达到2.4GB时，系统会暂停所有写操作，强制刷新脏页到磁盘。

**`vm.dirty_background_ratio`** - 后台刷新脏页的触发比例
```bash
echo 'vm.dirty_background_ratio = 5' >> /etc/sysctl.conf
```

**工作原理**：当脏页达到5%时，内核开始在后台慢慢刷新数据到磁盘，避免到达15%时的强制刷新。

**`vm.dirty_expire_centisecs`** - 脏页过期时间
```bash
echo 'vm.dirty_expire_centisecs = 500' >> /etc/sysctl.conf  # 5秒
```

### 5.3 大页内存配置


**什么是大页内存**：
普通内存页大小是4KB，大页内存可以是2MB或1GB。使用大页可以减少页表开销，提高内存访问效率。

**透明大页 vs 传统大页**：
```
透明大页（THP）：
✅ 自动管理，无需手动配置
❌ 可能导致MySQL性能抖动

传统大页：
✅ 性能稳定可预测
❌ 需要手动管理和预分配
```

**MySQL推荐配置**：
```bash
# 禁用透明大页（推荐）
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag

# 永久配置
echo 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' >> /etc/rc.local
echo 'echo never > /sys/kernel/mm/transparent_hugepage/defrag' >> /etc/rc.local
```

### 5.4 内存监控和调试


**查看内存使用情况**：
```bash
# 详细内存信息
cat /proc/meminfo | grep -E "(Dirty|Writeback|Mapped)"

# 实时监控内存
watch -n 1 'cat /proc/meminfo | head -20'
```

**监控MySQL内存使用**：
```bash
# 查看MySQL进程内存使用
ps aux | grep mysql
pmap -x `pidof mysqld`
```

---

## 6. 🌐 网络参数调优


### 6.1 MySQL网络连接特点


**MySQL的网络使用模式**：
- **短连接频繁**：Web应用经常建立和关闭连接
- **长连接持久**：连接池保持长期连接
- **数据包小而多**：查询和结果通常分多个小包传输

```
网络连接生命周期：
客户端 ←→ TCP连接建立 ←→ MySQL服务器
  ↓           ↓              ↓
请求发送   网络传输        处理响应
```

### 6.2 TCP连接相关参数


#### 🔗 连接队列参数


**`net.core.somaxconn`** - 监听队列最大长度
```bash
# MySQL默认监听队列通常是50，高并发时不够用
echo 'net.core.somaxconn = 32768' >> /etc/sysctl.conf
```

**实际影响**：当同时有大量客户端连接MySQL时，如果队列太小，后续连接会被拒绝，出现"Connection refused"错误。

**`net.core.netdev_max_backlog`** - 网络接口接收队列长度
```bash
echo 'net.core.netdev_max_backlog = 32768' >> /etc/sysctl.conf
```

#### ⏱️ 连接超时参数


**`net.ipv4.tcp_fin_timeout`** - FIN_WAIT_2状态超时时间
```bash
echo 'net.ipv4.tcp_fin_timeout = 30' >> /etc/sysctl.conf
```

**为什么要调小**：MySQL应用经常创建和关闭连接，如果FIN_WAIT状态时间太长，会占用大量端口资源。

**`net.ipv4.tcp_keepalive_time`** - TCP保活检测时间间隔
```bash
echo 'net.ipv4.tcp_keepalive_time = 300' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_probes = 3' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_keepalive_intvl = 15' >> /etc/sysctl.conf
```

**作用**：及时发现断开的连接，避免MySQL维护无效连接。

### 6.3 端口范围和缓冲区优化


#### 🔢 端口范围扩大


**`net.ipv4.ip_local_port_range`** - 本地端口范围
```bash
echo 'net.ipv4.ip_local_port_range = 10000 65535' >> /etc/sysctl.conf
```

**实际需求**：高并发MySQL服务器可能同时维护数千个连接，需要足够的端口资源。

#### 📦 网络缓冲区优化


**`net.core.rmem_default`** / **`net.core.wmem_default`** - 默认缓冲区大小
```bash
echo 'net.core.rmem_default = 262144' >> /etc/sysctl.conf    # 256KB
echo 'net.core.wmem_default = 262144' >> /etc/sysctl.conf
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf      # 16MB
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf
```

### 6.4 网络参数配置实战


**完整网络优化配置**：
```bash
# 编辑系统配置
vim /etc/sysctl.conf

# TCP连接优化
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 32768
net.ipv4.tcp_max_syn_backlog = 32768

# 连接状态优化
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0

# 保活参数优化
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 15

# 端口和缓冲区
net.ipv4.ip_local_port_range = 10000 65535
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# 应用配置
sysctl -p
```

---

## 7. 🏗️ NUMA架构优化


### 7.1 什么是NUMA架构


**NUMA**（Non-Uniform Memory Access）是现代多核服务器的内存架构。

**传统SMP vs NUMA架构对比**：
```
SMP架构（对称多处理）：
CPU1 ─┐    ┌─ CPU2
      │    │
   ┌──┴────┴──┐
   │   内存    │
   └──────────┘

NUMA架构：
┌─────────────────┬─────────────────┐
│  Node 0         │  Node 1         │
│  CPU1-4         │  CPU5-8         │
│  本地内存       │  本地内存       │
└─────────────────┴─────────────────┘
      ↑ 快速访问     ↑ 跨节点访问（较慢）
```

**NUMA的特点**：
- **本地内存访问快**：CPU访问同节点内存速度快
- **远程内存访问慢**：跨节点访问内存有延迟
- **内存分配不当影响性能**：进程在一个节点，内存在另一个节点

### 7.2 检查NUMA配置


**查看NUMA拓扑**：
```bash
# 查看NUMA节点信息
numactl --hardware

# 输出示例：
# available: 2 nodes (0-1)
# node 0 cpus: 0 1 2 3 8 9 10 11
# node 0 size: 32768 MB
# node 1 cpus: 4 5 6 7 12 13 14 15  
# node 1 size: 32768 MB
```

**查看当前进程NUMA状态**：
```bash
# 查看MySQL进程的NUMA绑定情况
numactl --show
pid=`pidof mysqld`
cat /proc/$pid/numa_maps | head
```

### 7.3 NUMA优化策略


#### 🎯 策略1：绑定MySQL到单一NUMA节点


**适用场景**：MySQL实例内存使用量不超过单个NUMA节点

```bash
# 启动时绑定到NUMA节点0
numactl --cpunodebind=0 --membind=0 mysqld_safe &

# 或者修改MySQL启动脚本
vim /etc/systemd/system/mysql.service
# 在ExecStart前添加：
# ExecStart=/usr/bin/numactl --cpunodebind=0 --membind=0 /usr/sbin/mysqld
```

#### 🎯 策略2：禁用NUMA（适用于大内存MySQL）


**适用场景**：MySQL需要使用超过单个NUMA节点的内存

```bash
# 方法1：内核启动参数禁用NUMA
vim /etc/default/grub
GRUB_CMDLINE_LINUX="numa=off"
grub2-mkconfig -o /boot/grub2/grub.cfg

# 方法2：使用交替内存策略
numactl --interleave=all mysqld_safe &
```

#### 🎯 策略3：优化内存分配策略


**`vm.zone_reclaim_mode`** - 内存回收模式
```bash
# 禁用NUMA本地回收，允许使用远程内存
echo 'vm.zone_reclaim_mode = 0' >> /etc/sysctl.conf
```

**含义**：当本地节点内存不足时，优先使用其他节点的空闲内存，而不是回收本地缓存。

### 7.4 NUMA监控和调试


**监控NUMA内存使用**：
```bash
# 实时查看各节点内存使用
watch -n 1 'numastat'

# 查看MySQL进程的内存分布
numastat -p `pidof mysqld`
```

**NUMA性能测试**：
```bash
# 测试内存访问延迟
numactl --cpunodebind=0 --membind=0 stream_benchmark
numactl --cpunodebind=0 --membind=1 stream_benchmark
# 对比两次测试结果的差异
```

---

## 8. 📄 透明大页设置


### 8.1 什么是透明大页


**透明大页**（Transparent Huge Pages，THP）是Linux内核的一个功能，自动将小的4KB内存页合并成2MB的大页。

**工作原理**：
```
普通页面管理：
┌─4KB─┬─4KB─┬─4KB─┬─4KB─┐
│页面1│页面2│页面3│页面4│ = 16KB数据，4个页表项
└─────┴─────┴─────┴─────┘

透明大页：
┌────────2MB────────┐
│     合并大页      │ = 2MB数据，1个页表项
└───────────────────┘
```

### 8.2 透明大页对MySQL的影响


#### ✅ 透明大页的优势

- **减少TLB miss**：页表项减少，CPU缓存命中率提高
- **减少页表开销**：内存管理效率提升
- **提高内存访问性能**：大块内存访问更高效

#### ❌ 透明大页的问题

- **内存碎片**：难以找到连续的2MB内存块
- **延迟不可预测**：合并和分割大页需要时间
- **内存回收延迟**：大页回收比小页慢

**MySQL特殊情况**：
```bash
# MySQL的内存使用模式不规律
缓冲池     ←  需要大量连续内存（适合大页）
临时表     ←  频繁分配释放（不适合大页）
连接缓冲   ←  小块内存（不适合大页）
```

### 8.3 透明大页配置策略


#### 🔧 完全禁用透明大页（推荐）


**为什么推荐禁用**：
- MySQL性能更稳定可预测
- 避免内存碎片问题
- 减少不必要的CPU开销

```bash
# 临时禁用
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag

# 查看当前状态
cat /sys/kernel/mm/transparent_hugepage/enabled
# 输出：always madvise [never]  # []内为当前设置

# 永久禁用
echo 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' >> /etc/rc.local
echo 'echo never > /sys/kernel/mm/transparent_hugepage/defrag' >> /etc/rc.local
chmod +x /etc/rc.local
```

#### 🔧 通过内核参数禁用


```bash
# 编辑GRUB配置
vim /etc/default/grub

# 添加内核参数
GRUB_CMDLINE_LINUX="transparent_hugepage=never"

# 更新GRUB配置
grub2-mkconfig -o /boot/grub2/grub.cfg

# 重启生效
reboot
```

### 8.4 验证透明大页设置


**检查设置是否生效**：
```bash
# 查看THP状态
cat /sys/kernel/mm/transparent_hugepage/enabled
cat /sys/kernel/mm/transparent_hugepage/defrag

# 查看大页使用情况
grep -i hugepage /proc/meminfo

# 输出示例：
# AnonHugePages:    102400 kB  # 匿名大页使用量
# HugePages_Total:        0    # 传统大页总数
# HugePages_Free:         0    # 传统大页空闲数
```

**监控大页使用对MySQL的影响**：
```bash
# MySQL运行前后对比
# 查看内存分配情况
cat /proc/`pidof mysqld`/smaps | grep -A 1 "Size:\|Rss:"
```

---

## 9. 📊 系统资源监控


### 9.1 为什么需要监控


**监控的重要性**：
- **及时发现问题**：在性能恶化前发现瓶颈
- **验证优化效果**：量化调优带来的改善
- **建立基线**：了解系统正常运行状态
- **容量规划**：预测未来资源需求

### 9.2 关键监控指标


#### 💻 CPU监控


**核心指标**：
```bash
# 查看CPU使用率
top -p `pidof mysqld`

# 详细CPU使用情况
iostat -c 1

# 关键指标解读：
%user   - MySQL进程CPU使用率（应该是主要消耗）
%system - 系统调用CPU使用率（过高说明IO等待多）
%iowait - IO等待时间（高值表示磁盘瓶颈）
%idle   - CPU空闲率
```

**实用监控脚本**：
```bash
#!/bin/bash
# mysql-cpu-monitor.sh
while true; do
    echo "=== $(date) ==="
    echo "MySQL CPU使用率："
    top -p `pidof mysqld` -n 1 | grep mysqld
    echo "系统整体CPU："
    iostat -c 1 1 | tail -1
    sleep 5
done
```

#### 💾 内存监控


**内存使用核心指标**：
```bash
# 查看内存详细信息
cat /proc/meminfo | grep -E "(MemTotal|MemFree|Buffers|Cached|Dirty|Writeback)"

# MySQL进程内存使用
pmap -x `pidof mysqld` | tail -1

# 关键指标：
MemTotal  - 总内存
MemFree   - 空闲内存  
Buffers   - 文件系统缓冲
Cached    - 页面缓存
Dirty     - 脏页内存
```

**内存监控脚本**：
```bash
#!/bin/bash
# mysql-memory-monitor.sh
pid=`pidof mysqld`
echo "MySQL进程内存使用："
echo "RSS内存: $(cat /proc/$pid/status | grep VmRSS)"
echo "虚拟内存: $(cat /proc/$pid/status | grep VmSize)"
echo "系统内存状态："
free -h
echo "脏页情况："
cat /proc/meminfo | grep -E "(Dirty|Writeback)"
```

#### 💽 磁盘IO监控


**IO性能关键指标**：
```bash
# 查看磁盘IO统计
iostat -x 1

# 关键指标解读：
%util     - 磁盘繁忙度（>80%表示磁盘瓶颈）
avgqu-sz  - 平均队列长度
await     - 平均等待时间（ms）
r/s, w/s  - 每秒读写次数
rkB/s, wkB/s - 每秒读写KB数
```

**MySQL专用IO监控**：
```bash
# 监控MySQL数据目录IO
iotop -p `pidof mysqld`

# 监控特定设备IO
iostat -x /dev/sda 1
```

#### 🌐 网络监控


**网络连接监控**：
```bash
# 查看MySQL连接数
netstat -an | grep :3306 | wc -l

# 查看连接状态分布
netstat -an | grep :3306 | awk '{print $6}' | sort | uniq -c

# 网络流量监控
iftop -i eth0
```

### 9.3 综合监控脚本


**一体化MySQL系统监控**：
```bash
#!/bin/bash
# mysql-system-monitor.sh

LOG_FILE="/var/log/mysql-system-monitor.log"
MYSQL_PID=`pidof mysqld`

monitor_system() {
    echo "=== $(date '+%Y-%m-%d %H:%M:%S') ===" >> $LOG_FILE
    
    # CPU监控
    echo "CPU使用率:" >> $LOG_FILE
    top -p $MYSQL_PID -n 1 -b | grep mysqld >> $LOG_FILE
    
    # 内存监控
    echo "内存使用情况:" >> $LOG_FILE
    cat /proc/$MYSQL_PID/status | grep -E "(VmRSS|VmSize)" >> $LOG_FILE
    
    # IO监控
    echo "IO统计:" >> $LOG_FILE
    iostat -x 1 1 | grep -E "(Device|sda)" >> $LOG_FILE
    
    # 网络连接
    echo "MySQL连接数: $(netstat -an | grep :3306 | wc -l)" >> $LOG_FILE
    
    echo "" >> $LOG_FILE
}

# 每5秒监控一次
while true; do
    monitor_system
    sleep 5
done
```

### 9.4 监控告警设置


**基础告警阈值**：
```bash
# CPU使用率告警
if [ $(top -p $MYSQL_PID -n 1 -b | grep mysqld | awk '{print $9}' | cut -d'.' -f1) -gt 80 ]; then
    echo "警告: MySQL CPU使用率超过80%" | mail -s "MySQL性能告警" admin@company.com
fi

# 内存使用告警
mem_usage=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}')
if [ $mem_usage -gt 90 ]; then
    echo "警告: 系统内存使用率超过90%" | mail -s "内存告警" admin@company.com
fi

# 磁盘IO告警
disk_util=$(iostat -x 1 1 | grep sda | awk '{print $10}' | cut -d'.' -f1)
if [ $disk_util -gt 85 ]; then
    echo "警告: 磁盘IO使用率超过85%" | mail -s "磁盘IO告警" admin@company.com
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的优化要点


```
🔸 系统调优是MySQL性能优化的基础，影响整体性能表现
🔸 内核参数调优重点关注文件描述符、网络连接、内存管理
🔸 文件系统选择XFS，配置合适的挂载参数优化IO性能
🔸 IO调度器根据存储类型选择：SSD用noop，HDD用deadline  
🔸 内存管理避免swap使用，控制脏页比例，禁用透明大页
🔸 网络参数优化连接队列、超时时间、端口范围、缓冲区大小
🔸 NUMA架构需要合理配置CPU和内存绑定策略
🔸 持续监控系统资源使用情况，建立告警机制
```

### 10.2 关键配置总结


**🔹 核心内核参数配置**
```bash
# /etc/sysctl.conf 关键配置
fs.file-max = 1000000                    # 最大文件句柄数
vm.swappiness = 1                        # 避免使用swap
vm.dirty_ratio = 15                      # 脏页控制
net.core.somaxconn = 32768              # 连接队列大小
net.ipv4.tcp_fin_timeout = 30           # 连接超时控制
```

**🔹 文件系统推荐配置**
```bash
# XFS挂载参数优化
/dev/sdb1 /var/lib/mysql xfs defaults,noatime,nodiratime,logbufs=8,logbsize=256k 0 0
```

**🔹 透明大页禁用**
```bash
echo never > /sys/kernel/mm/transparent_hugepage/enabled
echo never > /sys/kernel/mm/transparent_hugepage/defrag  
```

### 10.3 优化效果预期


**🎯 性能提升预期**：
- **IO性能**：通过文件系统和调度器优化，提升20-40%
- **网络性能**：连接处理能力提升30-50%  
- **内存效率**：减少swap使用，响应时间更稳定
- **整体性能**：系统级优化通常带来15-30%的综合性能提升

### 10.4 实施建议


**🔧 实施步骤**：
1. **建立基线**：优化前完整记录当前性能指标
2. **分步实施**：一次调整一类参数，逐步验证效果
3. **测试验证**：在测试环境充分验证后再应用到生产环境
4. **持续监控**：建立完善的监控体系，及时发现问题
5. **文档记录**：详细记录所有配置变更和效果

**⚠️ 注意事项**：
- **备份配置**：修改前备份所有配置文件
- **渐进调优**：避免一次性大幅调整参数
- **环境差异**：不同硬件环境需要针对性调整
- **版本兼容**：注意内核版本和MySQL版本的兼容性

**💡 最佳实践**：
- 定期review和更新系统配置
- 建立标准化的服务器配置模板
- 自动化部署优化配置脚本
- 定期进行性能基准测试

**🚀 进阶方向**：
- 容器环境下的系统优化
- 云环境中的资源调优
- 结合硬件特性的深度优化
- 与MySQL配置参数的协同优化