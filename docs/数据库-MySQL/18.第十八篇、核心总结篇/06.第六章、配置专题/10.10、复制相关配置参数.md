---
title: 10、复制相关配置参数
---
## 📚 目录

1. [MySQL复制基础概念](#1-MySQL复制基础概念)
2. [服务器标识配置](#2-服务器标识配置)
3. [二进制日志与中继日志](#3-二进制日志与中继日志)
4. [从库复制参数](#4-从库复制参数)
5. [GTID全局事务标识](#5-GTID全局事务标识)
6. [复制性能优化](#6-复制性能优化)
7. [复制安全与一致性](#7-复制安全与一致性)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔄 MySQL复制基础概念


### 1.1 什么是MySQL复制


**简单理解**：MySQL复制就像是**自动抄写员**，主库（Master）写什么，从库（Slave）就跟着抄什么，保持数据同步。

```
主库写入数据 → 记录到二进制日志 → 从库读取日志 → 从库执行相同操作
```

**复制的本质**：
- **主库**：原始数据的写入点，所有写操作都在这里
- **从库**：数据的副本，通过读取主库日志来同步数据
- **二进制日志**：记录主库所有数据变更的"账本"
- **中继日志**：从库的"临时账本"，先把主库日志抄到这里

### 1.2 复制架构图示


```
主库（Master）                     从库（Slave）
┌─────────────────┐               ┌─────────────────┐
│  应用写入数据    │               │                 │
│       ↓         │               │                 │
│  Binary Log     │    网络传输    │   Relay Log     │
│  (二进制日志)    │ ============> │  (中继日志)      │
│                 │               │       ↓         │
│                 │               │  SQL Thread     │
│                 │               │  (执行SQL)      │
└─────────────────┘               └─────────────────┘
```

### 1.3 复制的作用


**🎯 主要用途**：
- **📈 读写分离**：主库负责写，从库负责读，分担压力
- **🔒 数据备份**：从库作为实时备份，防止数据丢失
- **⚡ 负载均衡**：多个从库分担读取压力
- **🌍 异地容灾**：不同地区部署从库，防止单点故障

---

## 2. 🏷️ 服务器标识配置


### 2.1 server_id - 服务器身份证


**核心概念**：每个MySQL服务器都需要一个**唯一的身份证号**，就像人的身份证一样，不能重复。

**🔸 基本配置**
```ini
# 主库配置
server_id = 1

# 从库配置  
server_id = 2
```

**💡 为什么需要server_id**：
- **防止循环复制**：避免数据在主从之间无限循环
- **识别数据来源**：知道这条数据是从哪个服务器来的
- **复制过滤**：可以根据server_id过滤特定服务器的数据

**⚠️ 重要注意事项**：
```ini
# ❌ 错误：两个服务器使用相同ID
server_id = 1  # 主库
server_id = 1  # 从库 - 这样会导致复制异常

# ✅ 正确：每个服务器使用不同ID
server_id = 100  # 主库
server_id = 101  # 从库1
server_id = 102  # 从库2
```

**🎯 最佳实践**：
- **主库使用较小数字**：如1、10、100
- **从库递增编号**：如101、102、103
- **预留编号空间**：为将来扩展留出编号

---

## 3. 📝 二进制日志与中继日志


### 3.1 log_slave_updates - 从库日志更新


**简单理解**：这个参数决定从库是否也要记录"日记"（二进制日志）。

**🔸 参数说明**
```ini
# 从库也记录二进制日志
log_slave_updates = ON

# 从库不记录二进制日志  
log_slave_updates = OFF
```

**💭 什么时候需要开启**：
- **级联复制**：A → B → C，B既是A的从库，又是C的主库
- **双主架构**：两个服务器互为主从
- **备份策略**：需要从从库进行增量备份

**架构示例**：
```
主库A (server_id=1)
   ↓
从库B (server_id=2, log_slave_updates=ON)
   ↓  
从库C (server_id=3)
```

### 3.2 relay_log - 中继日志配置


**核心概念**：中继日志是从库的**临时存储**，就像快递中转站，先把主库的数据存这里，再慢慢处理。

**🔸 基本配置**
```ini
# 中继日志文件名前缀
relay_log = mysql-relay-bin

# 中继日志存储路径
relay_log = /var/lib/mysql/relay-logs/mysql-relay-bin
```

**📁 文件结构示例**：
```
/var/lib/mysql/
├── mysql-relay-bin.000001  ← 中继日志文件
├── mysql-relay-bin.000002
├── mysql-relay-bin.index   ← 索引文件
└── relay-log.info          ← 位置信息文件
```

### 3.3 relay_log_index - 中继日志索引


**作用说明**：这是中继日志的**目录清单**，记录所有中继日志文件的名称。

```ini
# 指定索引文件位置
relay_log_index = /var/lib/mysql/mysql-relay-bin.index
```

**索引文件内容示例**：
```
/var/lib/mysql/mysql-relay-bin.000001
/var/lib/mysql/mysql-relay-bin.000002
/var/lib/mysql/mysql-relay-bin.000003
```

---

## 4. ⚡ 从库复制参数


### 4.1 slave_net_timeout - 网络超时设置


**简单理解**：从库等待主库回应的**耐心时间**，超过这个时间就认为网络断了。

```ini
# 默认60秒，网络不稳定可以适当增大
slave_net_timeout = 60
```

**🔧 调优建议**：
- **网络稳定**：保持默认60秒
- **网络不稳定**：增加到120-300秒
- **跨地域复制**：建议300秒以上

### 4.2 slave_parallel_workers - 并行复制


**核心概念**：让从库**多个工人**同时干活，而不是一个人慢慢干。

```ini
# 单线程复制（默认）
slave_parallel_workers = 0

# 4个线程并行复制
slave_parallel_workers = 4
```

**📊 性能对比**：
| 并行度 | **复制速度** | **CPU使用** | **适用场景** |
|--------|-------------|------------|-------------|
| `0（单线程）` | `较慢` | `低` | `小并发，简单场景` |
| `2-4线程` | `明显提升` | `中等` | `中等并发场景` |
| `8+线程` | `显著提升` | `较高` | `高并发，多表操作` |

**⚠️ 注意事项**：
- **单表大事务**：并行复制效果不明显
- **多表小事务**：并行复制效果显著
- **CPU核心数**：建议不超过CPU核心数

### 4.3 slave_preserve_commit_order - 提交顺序保证


**作用说明**：确保从库的事务**提交顺序**与主库完全一致。

```ini
# 保证提交顺序一致
slave_preserve_commit_order = ON
```

**🎯 为什么重要**：
- **数据一致性**：避免并行复制导致的数据不一致
- **主从切换**：确保切换后数据状态正确
- **应用兼容**：某些应用依赖事务顺序

---

## 5. 🗂️ 复制信息存储


### 5.1 master_info_repository - 主库信息存储


**简单理解**：记录**主库在哪里**、**用户名密码**等连接信息的地方。

```ini
# 存储在表中（推荐）
master_info_repository = TABLE

# 存储在文件中（传统方式）
master_info_repository = FILE
```

**📋 存储对比**：
| 存储方式 | **优点** | **缺点** | **推荐度** |
|---------|---------|---------|-----------|
| `TABLE` | `崩溃安全，事务保护` | `占用表空间` | `⭐⭐⭐⭐⭐` |
| `FILE` | `简单直观` | `可能丢失，不安全` | `⭐⭐` |

### 5.2 relay_log_info_repository - 中继日志信息


**作用说明**：记录从库**读到哪里了**的进度信息。

```ini
# 存储在表中（推荐）
relay_log_info_repository = TABLE
```

**💾 存储内容**：
- **读取位置**：当前读取到主库日志的哪个位置
- **执行位置**：当前执行到中继日志的哪个位置
- **文件信息**：当前使用的日志文件名称

---

## 6. 🎯 GTID全局事务标识


### 6.1 什么是GTID


**通俗理解**：GTID就像给每个数据库操作贴上**全球唯一的标签**，不管在哪个服务器上，这个标签都能准确识别这个操作。

**GTID格式**：
```
server_uuid:transaction_id
例如：3E11FA47-71CA-11E1-9E33-C80AA9429562:23
```

### 6.2 gtid_mode - GTID模式配置


**🔸 配置选项**
```ini
# 完全启用GTID
gtid_mode = ON

# 完全禁用GTID  
gtid_mode = OFF

# 兼容模式（升级时使用）
gtid_mode = ON_PERMISSIVE
gtid_mode = OFF_PERMISSIVE
```

**📈 GTID升级步骤**：
```
OFF → OFF_PERMISSIVE → ON_PERMISSIVE → ON
```

### 6.3 enforce_gtid_consistency - GTID一致性


**作用说明**：确保所有操作都**符合GTID规范**，不允许可能破坏一致性的操作。

```ini
# 强制GTID一致性
enforce_gtid_consistency = ON
```

**🚫 被限制的操作**：
- **非事务引擎的事务内操作**
- **CREATE TABLE ... SELECT语句**
- **事务内的CREATE/DROP TEMPORARY TABLE**

### 6.4 GTID的优势


**🎯 主要好处**：
- **🔧 故障恢复简单**：不需要手动计算日志位置
- **⚡ 主从切换快速**：自动找到同步点
- **🛡️ 数据一致性强**：防止重复执行和遗漏
- **📊 监控更直观**：可以直观看到复制进度

**架构对比**：
```
传统复制方式：
主库 --[file:position]--> 从库
需要手动指定日志文件名和位置

GTID复制方式：  
主库 --[GTID:auto]--> 从库
自动识别，无需手动指定
```

---

## 7. 🔐 复制安全与一致性


### 7.1 log_bin_trust_function_creators - 函数复制安全


**问题背景**：自定义函数可能包含**不确定性操作**（如随机数、时间函数），在主从复制时可能导致数据不一致。

```ini
# 允许创建非确定性函数（需谨慎）
log_bin_trust_function_creators = ON
```

**⚠️ 安全考虑**：
- **确定性函数**：相同输入总是产生相同输出 ✅
- **非确定性函数**：可能产生不同结果 ⚠️

**🔧 安全实践**：
```sql
-- ✅ 安全的函数
CREATE FUNCTION safe_add(a INT, b INT) 
RETURNS INT DETERMINISTIC
RETURN a + b;

-- ⚠️ 需要注意的函数
CREATE FUNCTION current_time_func() 
RETURNS DATETIME
RETURN NOW();  -- NOW()在主从执行时间不同
```

### 7.2 复制延迟监控


**关键指标**：
- **Seconds_Behind_Master**：从库落后主库的秒数
- **Exec_Master_Log_Pos**：执行到主库日志的位置
- **Read_Master_Log_Pos**：读取到主库日志的位置

**🔍 监控命令**：
```sql
-- 查看复制状态
SHOW SLAVE STATUS\G

-- 关注这些关键字段
Seconds_Behind_Master: 0      -- 延迟时间
Slave_IO_Running: Yes         -- IO线程状态  
Slave_SQL_Running: Yes        -- SQL线程状态
Last_Error:                   -- 最后错误信息
```

---

## 8. 📖 完整配置示例


### 8.1 主库配置模板


```ini
[mysqld]
# 基础配置
server_id = 1
log_bin = mysql-bin
binlog_format = ROW

# GTID配置
gtid_mode = ON
enforce_gtid_consistency = ON

# 安全配置
log_bin_trust_function_creators = ON
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1
```

### 8.2 从库配置模板


```ini
[mysqld]
# 基础配置
server_id = 2
relay_log = mysql-relay-bin
log_slave_updates = ON

# GTID配置
gtid_mode = ON
enforce_gtid_consistency = ON

# 复制优化
slave_parallel_workers = 4
slave_preserve_commit_order = ON
slave_net_timeout = 120

# 信息存储
master_info_repository = TABLE
relay_log_info_repository = TABLE
```

### 8.3 复制建立步骤


**① 主库准备**：
```sql
-- 创建复制用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';

-- 查看主库状态
SHOW MASTER STATUS;
```

**② 从库配置**：
```sql
-- 配置主库信息（GTID模式）
CHANGE MASTER TO
  MASTER_HOST='主库IP',
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_AUTO_POSITION=1;

-- 启动复制
START SLAVE;

-- 检查状态
SHOW SLAVE STATUS\G
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 server_id：每个MySQL服务器的唯一标识，防止循环复制
🔸 二进制日志：主库记录所有数据变更的"账本"
🔸 中继日志：从库的临时存储，先存储后执行
🔸 GTID：全局事务标识，简化复制管理
🔸 并行复制：多线程提升复制性能
```

### 9.2 关键配置清单


**🔹 基础必配参数**：
```ini
server_id                    # 服务器唯一标识
log_bin                      # 主库二进制日志
relay_log                    # 从库中继日志
gtid_mode                    # GTID模式
enforce_gtid_consistency     # GTID一致性
```

**🔹 性能优化参数**：
```ini
slave_parallel_workers       # 并行复制线程数
slave_preserve_commit_order  # 保证提交顺序
slave_net_timeout           # 网络超时时间
```

**🔹 安全保障参数**：
```ini
master_info_repository      # 主库信息存储方式
relay_log_info_repository   # 中继日志信息存储
log_bin_trust_function_creators  # 函数复制安全
```

### 9.3 实际应用建议


**🎯 架构选择**：
- **读写分离**：1主多从，读请求分发到从库
- **高可用**：主从+故障切换，快速恢复服务
- **异地备份**：跨地域从库，灾难恢复保障

**⚡ 性能调优**：
- **并行度设置**：根据CPU核心数和业务特点调整
- **网络优化**：跨地域复制适当增加超时时间
- **存储优化**：使用TABLE方式存储复制信息

**🔒 安全实践**：
- **独立复制账号**：只授予REPLICATION SLAVE权限
- **加密传输**：生产环境建议使用SSL连接
- **定期监控**：关注复制延迟和错误状态

**核心记忆**：
- MySQL复制是数据同步的基础，理解原理比记住参数更重要
- GTID模式大大简化了复制管理，是现代MySQL的标准配置
- 并行复制可以显著提升性能，但要注意数据一致性
- 安全配置和监控同样重要，不能只关注性能忽视稳定性