---
title: 4ã€ç‰ˆæœ¬ç®¡ç†è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [ç‰ˆæœ¬ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ](#1-ç‰ˆæœ¬ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ)
2. [å†…å®¹ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ](#2-å†…å®¹ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ)
3. [ç‰ˆæœ¬å­˜å‚¨ç­–ç•¥](#3-ç‰ˆæœ¬å­˜å‚¨ç­–ç•¥)
4. [ç‰ˆæœ¬æ¯”è¾ƒä¸å›æ»š](#4-ç‰ˆæœ¬æ¯”è¾ƒä¸å›æ»š)
5. [åˆ†æ”¯ç®¡ç†ä¸åˆå¹¶](#5-åˆ†æ”¯ç®¡ç†ä¸åˆå¹¶)
6. [ç‰ˆæœ¬æƒé™ä¸å®‰å…¨](#6-ç‰ˆæœ¬æƒé™ä¸å®‰å…¨)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [å¤§æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†](#8-å¤§æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ ç‰ˆæœ¬ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç‰ˆæœ¬ç®¡ç†


**ğŸ“Œ æ ¸å¿ƒå®šä¹‰**
```
ç‰ˆæœ¬ç®¡ç† = å†…å®¹å˜æ›´è¿½è¸ª + å†å²è®°å½•ä¿å­˜ + å›æ»šæ¢å¤èƒ½åŠ›

ç®€å•ç†è§£ï¼š
å°±åƒæ–‡æ¡£çš„"å†å²è®°å½•"åŠŸèƒ½ï¼Œå¯ä»¥ï¼š
â€¢ çœ‹åˆ°æ¯æ¬¡ä¿®æ”¹çš„å†…å®¹
â€¢ çŸ¥é“è°åœ¨ä»€ä¹ˆæ—¶å€™æ”¹äº†ä»€ä¹ˆ  
â€¢ éœ€è¦æ—¶æ¢å¤åˆ°ä¹‹å‰çš„ä»»ä½•ç‰ˆæœ¬
```

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†**
```
ç°å®åœºæ™¯ï¼š
â€¢ ç¼–è¾‘è¯¯åˆ äº†é‡è¦å†…å®¹ â†’ éœ€è¦å›æ»š
â€¢ å¤šäººåŒæ—¶ç¼–è¾‘äº§ç”Ÿå†²çª â†’ éœ€è¦åˆå¹¶
â€¢ æƒ³çœ‹å†…å®¹çš„ä¿®æ”¹å†å² â†’ éœ€è¦ç‰ˆæœ¬è®°å½•
â€¢ å‘å¸ƒå‰éœ€è¦å®¡æ ¸ â†’ éœ€è¦ç‰ˆæœ¬æ§åˆ¶

æ ¸å¿ƒä»·å€¼ï¼š
âœ… å†…å®¹å®‰å…¨ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
âœ… åä½œç®¡ç†ï¼šå¤šäººç¼–è¾‘ä¸å†²çª  
âœ… å®¡è®¡è¿½è¸ªï¼šçŸ¥é“è°æ”¹äº†ä»€ä¹ˆ
âœ… çµæ´»å‘å¸ƒï¼šå¯ä»¥éšæ—¶å›é€€
```

### 1.2 ç‰ˆæœ¬ç®¡ç†çš„åŸºæœ¬è¦ç´ 


**ğŸ“Š æ ¸å¿ƒç»„æˆ**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç‰ˆæœ¬è®°å½•       â”‚ â† æ¯æ¬¡ä¿®æ”¹éƒ½ç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰ˆæœ¬å¯¹æ¯”       â”‚ â† çœ‹å‡ºä¸åŒç‰ˆæœ¬é—´çš„å·®å¼‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰ˆæœ¬å›æ»š       â”‚ â† æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åˆ†æ”¯ç®¡ç†       â”‚ â† æ”¯æŒå¹¶è¡Œå¼€å‘
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ ç‰ˆæœ¬ç®¡ç†æ¨¡å¼å¯¹æ¯”**

| æ¨¡å¼ç±»å‹ | **å·¥ä½œæ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-----------|
| ğŸ”„ **å¿«ç…§æ¨¡å¼** | å®Œæ•´ä¿å­˜æ¯ä¸ªç‰ˆæœ¬ | å°æ–‡ä»¶ï¼Œç‰ˆæœ¬å°‘ | ç®€å•ç›´è§‚ï¼Œä½†å ç”¨ç©ºé—´å¤§ |
| ğŸ“Š **å¢é‡æ¨¡å¼** | åªä¿å­˜å·®å¼‚éƒ¨åˆ† | å¤§æ–‡ä»¶ï¼Œç‰ˆæœ¬å¤š | èŠ‚çœç©ºé—´ï¼Œä½†è®¡ç®—å¤æ‚ |
| ğŸŒ³ **Gitæ¨¡å¼** | åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ | å¤æ‚åä½œåœºæ™¯ | åŠŸèƒ½å¼ºå¤§ï¼Œä½†å­¦ä¹ æˆæœ¬é«˜ |

---

## 2. ğŸ—‚ï¸ å†…å®¹ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ


### 2.1 æ•°æ®åº“è¡¨è®¾è®¡


**ğŸ“‹ æ ¸å¿ƒè¡¨ç»“æ„**
```sql
-- å†…å®¹ä¸»è¡¨
CREATE TABLE content_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    content_type ENUM('article', 'page', 'product') DEFAULT 'article',
    current_version_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_slug (slug),
    INDEX idx_type_updated (content_type, updated_at)
);

-- ç‰ˆæœ¬è®°å½•è¡¨  
CREATE TABLE content_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    version_number INT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    summary VARCHAR(500),
    author_id BIGINT NOT NULL,
    change_type ENUM('create', 'update', 'delete', 'restore') DEFAULT 'update',
    change_description VARCHAR(500),
    status ENUM('draft', 'review', 'published', 'archived') DEFAULT 'draft',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES content_items(id) ON DELETE CASCADE,
    UNIQUE KEY uk_content_version (content_id, version_number),
    INDEX idx_author_time (author_id, created_at),
    INDEX idx_status (status)
);
```

### 2.2 ç‰ˆæœ¬åˆ›å»ºæœºåˆ¶


**ğŸ”§ è‡ªåŠ¨ç‰ˆæœ¬åˆ›å»º**
```sql
DELIMITER $$
CREATE TRIGGER tr_content_version_create 
AFTER UPDATE ON content_items
FOR EACH ROW
BEGIN
    DECLARE next_version INT DEFAULT 1;
    
    -- è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
    SELECT IFNULL(MAX(version_number), 0) + 1 
    INTO next_version 
    FROM content_versions 
    WHERE content_id = NEW.id;
    
    -- åˆ›å»ºæ–°ç‰ˆæœ¬è®°å½•
    INSERT INTO content_versions (
        content_id, version_number, title, content, 
        author_id, change_type, created_at
    ) VALUES (
        NEW.id, next_version, NEW.title, NEW.content,
        @current_user_id, 'update', NOW()
    );
    
    -- æ›´æ–°å½“å‰ç‰ˆæœ¬æŒ‡é’ˆ
    UPDATE content_items 
    SET current_version_id = LAST_INSERT_ID()
    WHERE id = NEW.id;
END$$
DELIMITER ;
```

**ğŸ’» åº”ç”¨å±‚ç‰ˆæœ¬ç®¡ç†**
```php
class ContentVersionManager {
    
    // åˆ›å»ºæ–°ç‰ˆæœ¬
    public function createVersion($contentId, $data, $userId) {
        $this->db->beginTransaction();
        try {
            // è·å–ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
            $nextVersion = $this->getNextVersionNumber($contentId);
            
            // æ’å…¥ç‰ˆæœ¬è®°å½•
            $versionId = $this->db->insert('content_versions', [
                'content_id' => $contentId,
                'version_number' => $nextVersion,
                'title' => $data['title'],
                'content' => $data['content'],
                'author_id' => $userId,
                'change_description' => $data['change_description'] ?? '',
                'status' => $data['status'] ?? 'draft'
            ]);
            
            // æ›´æ–°ä¸»è¡¨å½“å‰ç‰ˆæœ¬
            $this->db->update('content_items', 
                ['current_version_id' => $versionId], 
                ['id' => $contentId]
            );
            
            $this->db->commit();
            return $versionId;
            
        } catch (Exception $e) {
            $this->db->rollback();
            throw $e;
        }
    }
}
```

### 2.3 ç‰ˆæœ¬æŸ¥è¯¢ä¸å±•ç¤º


**ğŸ“Š ç‰ˆæœ¬å†å²æŸ¥è¯¢**
```sql
-- è·å–å†…å®¹çš„ç‰ˆæœ¬å†å²
SELECT 
    v.id,
    v.version_number,
    v.title,
    v.change_type,
    v.change_description,
    v.status,
    v.created_at,
    u.username as author_name,
    CASE 
        WHEN c.current_version_id = v.id THEN 'å½“å‰ç‰ˆæœ¬'
        ELSE ''
    END as is_current
FROM content_versions v
JOIN users u ON v.author_id = u.id  
JOIN content_items c ON v.content_id = c.id
WHERE v.content_id = ?
ORDER BY v.version_number DESC
LIMIT 20;
```

**ğŸ¨ ç‰ˆæœ¬å†å²å±•ç¤ºç»„ä»¶**
```php
public function getVersionHistory($contentId, $page = 1, $limit = 10) {
    $offset = ($page - 1) * $limit;
    
    $versions = $this->db->query("
        SELECT 
            v.*,
            u.username,
            u.avatar,
            (v.id = c.current_version_id) as is_current
        FROM content_versions v
        JOIN users u ON v.author_id = u.id
        JOIN content_items c ON v.content_id = c.id  
        WHERE v.content_id = ?
        ORDER BY v.version_number DESC
        LIMIT ? OFFSET ?
    ", [$contentId, $limit, $offset]);
    
    return [
        'versions' => $versions,
        'total' => $this->getTotalVersions($contentId),
        'current_page' => $page
    ];
}
```

---

## 3. ğŸ’¾ ç‰ˆæœ¬å­˜å‚¨ç­–ç•¥


### 3.1 å¿«ç…§å­˜å‚¨ vs å¢é‡å­˜å‚¨


**ğŸ“Š å­˜å‚¨æ–¹å¼å¯¹æ¯”**

```
å¿«ç…§å­˜å‚¨ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰ï¼š
ç‰ˆæœ¬1: "Hello World"           â†’ 11å­—èŠ‚
ç‰ˆæœ¬2: "Hello Beautiful World" â†’ 21å­—èŠ‚  
ç‰ˆæœ¬3: "Hi Beautiful World"    â†’ 18å­—èŠ‚
æ€»å ç”¨: 50å­—èŠ‚

å¢é‡å­˜å‚¨ï¼ˆå·®å¼‚ç‰ˆæœ¬ï¼‰ï¼š
åŸºç¡€ç‰ˆæœ¬: "Hello World"        â†’ 11å­—èŠ‚
ç‰ˆæœ¬2å·®å¼‚: +Beautiful (pos:6)   â†’ è®°å½•ä½ç½®å’Œå†…å®¹
ç‰ˆæœ¬3å·®å¼‚: Helloâ†’Hi (pos:0)     â†’ è®°å½•æ›¿æ¢æ“ä½œ  
æ€»å ç”¨: çº¦15å­—èŠ‚
```

**ğŸ”§ å¢é‡å­˜å‚¨å®ç°**
```sql
-- å¢é‡ç‰ˆæœ¬è¡¨
CREATE TABLE content_version_diffs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    base_version_id BIGINT NOT NULL,
    version_id BIGINT NOT NULL,
    diff_type ENUM('add', 'delete', 'modify') NOT NULL,
    position INT NOT NULL,
    old_content TEXT,
    new_content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    FOREIGN KEY (base_version_id) REFERENCES content_versions(id),
    FOREIGN KEY (version_id) REFERENCES content_versions(id),
    INDEX idx_version (version_id)
);
```

```php
class DiffVersionManager {
    
    // è®¡ç®—æ–‡æœ¬å·®å¼‚
    public function calculateDiff($oldText, $newText) {
        // ä½¿ç”¨ç®€åŒ–çš„diffç®—æ³•
        $oldLines = explode("\n", $oldText);
        $newLines = explode("\n", $newText);
        
        $diffs = [];
        $maxLines = max(count($oldLines), count($newLines));
        
        for ($i = 0; $i < $maxLines; $i++) {
            $oldLine = $oldLines[$i] ?? '';
            $newLine = $newLines[$i] ?? '';
            
            if ($oldLine !== $newLine) {
                if (empty($oldLine)) {
                    $diffs[] = ['type' => 'add', 'line' => $i, 'content' => $newLine];
                } elseif (empty($newLine)) {
                    $diffs[] = ['type' => 'delete', 'line' => $i, 'content' => $oldLine];
                } else {
                    $diffs[] = ['type' => 'modify', 'line' => $i, 'old' => $oldLine, 'new' => $newLine];
                }
            }
        }
        
        return $diffs;
    }
    
    // å­˜å‚¨å·®å¼‚ç‰ˆæœ¬
    public function storeDiffVersion($contentId, $baseVersionId, $newContent, $userId) {
        // è·å–åŸºç¡€ç‰ˆæœ¬å†…å®¹
        $baseContent = $this->getVersionContent($baseVersionId);
        
        // è®¡ç®—å·®å¼‚
        $diffs = $this->calculateDiff($baseContent, $newContent);
        
        // åˆ›å»ºæ–°ç‰ˆæœ¬è®°å½•ï¼ˆåªå­˜å‚¨å…ƒæ•°æ®ï¼‰
        $versionId = $this->createVersionRecord($contentId, $userId, count($diffs));
        
        // å­˜å‚¨å·®å¼‚æ•°æ®
        foreach ($diffs as $diff) {
            $this->db->insert('content_version_diffs', [
                'content_id' => $contentId,
                'base_version_id' => $baseVersionId,
                'version_id' => $versionId,
                'diff_type' => $diff['type'],
                'position' => $diff['line'],
                'old_content' => $diff['old'] ?? null,
                'new_content' => $diff['new'] ?? $diff['content']
            ]);
        }
        
        return $versionId;
    }
}
```

### 3.2 ç‰ˆæœ¬å­˜å‚¨ä¼˜åŒ–


**ğŸ’¡ å­˜å‚¨ç©ºé—´ä¼˜åŒ–ç­–ç•¥**

```
ğŸ”¸ å®šæœŸå‹ç¼©ç­–ç•¥
â€¢ æ¯Nä¸ªç‰ˆæœ¬åˆ›å»ºä¸€ä¸ªå®Œæ•´å¿«ç…§
â€¢ åˆ é™¤è¿‡äºä¹…è¿œçš„å¢é‡è®°å½•
â€¢ å‹ç¼©è¿ç»­å°ä¿®æ”¹ä¸ºå•ä¸ªå·®å¼‚

ğŸ”¸ æ™ºèƒ½å­˜å‚¨é€‰æ‹©  
â€¢ å°æ”¹åŠ¨ç”¨å¢é‡å­˜å‚¨
â€¢ å¤§æ”¹åŠ¨ç›´æ¥å¿«ç…§å­˜å‚¨
â€¢ æ ¹æ®æ”¹åŠ¨æ¯”ä¾‹è‡ªåŠ¨é€‰æ‹©
```

**ğŸ”§ è‡ªåŠ¨å‹ç¼©å®ç°**
```sql
-- ç‰ˆæœ¬å‹ç¼©å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE CompressVersionHistory(IN content_id_param BIGINT)
BEGIN
    DECLARE base_version_id BIGINT;
    DECLARE compressed_content TEXT;
    
    -- æ¯10ä¸ªç‰ˆæœ¬åšä¸€æ¬¡å‹ç¼©
    SELECT id INTO base_version_id 
    FROM content_versions 
    WHERE content_id = content_id_param 
        AND version_number % 10 = 0
    ORDER BY version_number DESC 
    LIMIT 1;
    
    IF base_version_id IS NOT NULL THEN
        -- é‡å»ºå®Œæ•´å†…å®¹å¹¶ä¿å­˜ä¸ºå¿«ç…§
        SET compressed_content = fn_rebuild_content_from_diffs(base_version_id);
        
        UPDATE content_versions 
        SET content = compressed_content,
            is_compressed = 1
        WHERE id = base_version_id;
        
        -- åˆ é™¤è¯¥åŸºç¡€ç‰ˆæœ¬ä¹‹å‰çš„å·®å¼‚è®°å½•
        DELETE FROM content_version_diffs 
        WHERE content_id = content_id_param 
            AND version_id < base_version_id;
    END IF;
END$$
DELIMITER ;
```

---

## 4. ğŸ” ç‰ˆæœ¬æ¯”è¾ƒä¸å›æ»š


### 4.1 ç‰ˆæœ¬æ¯”è¾ƒåŠŸèƒ½


**ğŸ“Š æ–‡æœ¬å·®å¼‚å¯¹æ¯”**
```php
class VersionComparer {
    
    public function compareVersions($versionId1, $versionId2) {
        $version1 = $this->getVersionById($versionId1);
        $version2 = $this->getVersionById($versionId2);
        
        return [
            'old_version' => $version1,
            'new_version' => $version2,
            'differences' => $this->generateDiffHtml($version1['content'], $version2['content']),
            'stats' => $this->calculateDiffStats($version1['content'], $version2['content'])
        ];
    }
    
    private function generateDiffHtml($oldText, $newText) {
        $oldLines = explode("\n", $oldText);
        $newLines = explode("\n", $newText);
        
        $diff = new Diff($oldLines, $newLines);
        $renderer = new Diff_Renderer_Html_SideBySide();
        
        return $diff->render($renderer);
    }
    
    private function calculateDiffStats($oldText, $newText) {
        return [
            'lines_added' => substr_count($newText, "\n") - substr_count($oldText, "\n"),
            'chars_added' => strlen($newText) - strlen($oldText),
            'similarity' => $this->calculateSimilarity($oldText, $newText)
        ];
    }
}
```

**ğŸ¨ å¯è§†åŒ–å·®å¼‚å±•ç¤º**
```html
<!-- ç‰ˆæœ¬å¯¹æ¯”ç•Œé¢ -->
<div class="version-compare">
    <div class="compare-header">
        <div class="version-info old">
            <h4>ç‰ˆæœ¬ #{old_version.version_number}</h4>
            <p>ğŸ‘¤ {old_version.author} â€¢ ğŸ“… {old_version.created_at}</p>
        </div>
        <div class="compare-arrow">â¡ï¸</div>
        <div class="version-info new">
            <h4>ç‰ˆæœ¬ #{new_version.version_number}</h4>
            <p>ğŸ‘¤ {new_version.author} â€¢ ğŸ“… {new_version.created_at}</p>
        </div>
    </div>
    
    <div class="diff-stats">
        <span class="stat-item">ğŸ“Š ç›¸ä¼¼åº¦: {stats.similarity}%</span>
        <span class="stat-item">â• æ–°å¢: {stats.lines_added} è¡Œ</span>
        <span class="stat-item">ğŸ”¤ å­—ç¬¦å˜åŒ–: {stats.chars_added}</span>
    </div>
    
    <div class="diff-content">
        {differences}  <!-- æ¸²æŸ“çš„HTMLå·®å¼‚å†…å®¹ -->
    </div>
</div>
```

### 4.2 ç‰ˆæœ¬å›æ»šæœºåˆ¶


**ğŸ”„ å›æ»šæ“ä½œå®ç°**
```php
class VersionRollback {
    
    // å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
    public function rollbackToVersion($contentId, $targetVersionId, $userId) {
        $this->db->beginTransaction();
        
        try {
            // è·å–ç›®æ ‡ç‰ˆæœ¬å†…å®¹
            $targetVersion = $this->getVersionById($targetVersionId);
            if (!$targetVersion) {
                throw new Exception("ç›®æ ‡ç‰ˆæœ¬ä¸å­˜åœ¨");
            }
            
            // é‡å»ºç›®æ ‡ç‰ˆæœ¬çš„å®Œæ•´å†…å®¹
            $rollbackContent = $this->rebuildVersionContent($targetVersionId);
            
            // åˆ›å»ºå›æ»šç‰ˆæœ¬è®°å½•
            $rollbackVersionId = $this->createVersion($contentId, [
                'title' => $targetVersion['title'],
                'content' => $rollbackContent,
                'change_description' => "å›æ»šåˆ°ç‰ˆæœ¬ #{$targetVersion['version_number']}",
                'status' => 'draft'
            ], $userId, 'restore');
            
            // è®°å½•å›æ»šæ“ä½œ
            $this->logRollbackAction($contentId, $targetVersionId, $rollbackVersionId, $userId);
            
            $this->db->commit();
            return $rollbackVersionId;
            
        } catch (Exception $e) {
            $this->db->rollback();
            throw $e;
        }
    }
    
    // é‡å»ºç‰ˆæœ¬å†…å®¹ï¼ˆå¤„ç†å¢é‡å­˜å‚¨ï¼‰
    private function rebuildVersionContent($versionId) {
        $version = $this->getVersionById($versionId);
        
        // å¦‚æœæ˜¯å®Œæ•´å¿«ç…§ï¼Œç›´æ¥è¿”å›
        if (!empty($version['content'])) {
            return $version['content'];
        }
        
        // å¦‚æœæ˜¯å¢é‡ç‰ˆæœ¬ï¼Œéœ€è¦é‡å»º
        return $this->rebuildFromDiffs($versionId);
    }
}
```

**ğŸ“‹ å›æ»šè®°å½•ç®¡ç†**
```sql
-- å›æ»šæ“ä½œè®°å½•è¡¨
CREATE TABLE version_rollbacks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    from_version_id BIGINT NOT NULL,
    to_version_id BIGINT NOT NULL,
    rollback_version_id BIGINT NOT NULL,
    operator_id BIGINT NOT NULL,
    reason VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    INDEX idx_content_time (content_id, created_at)
);

-- æŸ¥è¯¢å›æ»šå†å²
SELECT 
    r.*,
    v_from.version_number as from_version,
    v_to.version_number as to_version,
    u.username as operator_name
FROM version_rollbacks r
JOIN content_versions v_from ON r.from_version_id = v_from.id
JOIN content_versions v_to ON r.to_version_id = v_to.id  
JOIN users u ON r.operator_id = u.id
WHERE r.content_id = ?
ORDER BY r.created_at DESC;
```

---

## 5. ğŸŒ³ åˆ†æ”¯ç®¡ç†ä¸åˆå¹¶


### 5.1 åˆ†æ”¯ç®¡ç†ç­–ç•¥


**ğŸ“Š åˆ†æ”¯æ¨¡å‹è®¾è®¡**
```
ä¸»åˆ†æ”¯ç®¡ç†æ¨¡å¼ï¼š

master (ä¸»åˆ†æ”¯)     â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—
                    â”‚     â”‚     â”‚     â”‚
develop (å¼€å‘åˆ†æ”¯)  â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—
                          â”‚           â”‚
feature (åŠŸèƒ½åˆ†æ”¯)        â—â”€â”€â”€â—â”€â”€â”€â—   â”‚
                                      â”‚  
release (å‘å¸ƒåˆ†æ”¯)                    â—â”€â—â”€â—
```

**ğŸ”§ åˆ†æ”¯è¡¨ç»“æ„**
```sql
CREATE TABLE content_branches (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    branch_name VARCHAR(100) NOT NULL,
    parent_branch_id BIGINT,
    base_version_id BIGINT NOT NULL,
    head_version_id BIGINT NOT NULL,
    branch_type ENUM('master', 'develop', 'feature', 'release', 'hotfix') DEFAULT 'feature',
    status ENUM('active', 'merged', 'abandoned') DEFAULT 'active',
    creator_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    merged_at TIMESTAMP NULL,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    FOREIGN KEY (parent_branch_id) REFERENCES content_branches(id),
    UNIQUE KEY uk_content_branch (content_id, branch_name),
    INDEX idx_status_type (status, branch_type)
);

-- åˆ†æ”¯ç‰ˆæœ¬å…³è”è¡¨
CREATE TABLE branch_versions (
    branch_id BIGINT NOT NULL,
    version_id BIGINT NOT NULL,
    version_order INT NOT NULL,
    PRIMARY KEY (branch_id, version_id),
    FOREIGN KEY (branch_id) REFERENCES content_branches(id),
    FOREIGN KEY (version_id) REFERENCES content_versions(id)
);
```

### 5.2 åˆ†æ”¯åˆ›å»ºä¸ç®¡ç†


**ğŸ”§ åˆ†æ”¯æ“ä½œå®ç°**
```php
class BranchManager {
    
    // åˆ›å»ºæ–°åˆ†æ”¯
    public function createBranch($contentId, $branchName, $baseVersionId, $userId, $branchType = 'feature') {
        // éªŒè¯åˆ†æ”¯åæ˜¯å¦å­˜åœ¨
        if ($this->branchExists($contentId, $branchName)) {
            throw new Exception("åˆ†æ”¯åå·²å­˜åœ¨: {$branchName}");
        }
        
        // è·å–çˆ¶åˆ†æ”¯ä¿¡æ¯
        $parentBranch = $this->getCurrentBranch($contentId);
        
        // åˆ›å»ºåˆ†æ”¯è®°å½•
        $branchId = $this->db->insert('content_branches', [
            'content_id' => $contentId,
            'branch_name' => $branchName,
            'parent_branch_id' => $parentBranch ? $parentBranch['id'] : null,
            'base_version_id' => $baseVersionId,
            'head_version_id' => $baseVersionId,
            'branch_type' => $branchType,
            'creator_id' => $userId
        ]);
        
        // å°†åŸºç¡€ç‰ˆæœ¬å…³è”åˆ°æ–°åˆ†æ”¯
        $this->addVersionToBranch($branchId, $baseVersionId, 1);
        
        return $branchId;
    }
    
    // åˆ‡æ¢åˆ†æ”¯
    public function switchBranch($contentId, $branchName) {
        $branch = $this->getBranchByName($contentId, $branchName);
        if (!$branch) {
            throw new Exception("åˆ†æ”¯ä¸å­˜åœ¨: {$branchName}");
        }
        
        // æ›´æ–°å†…å®¹è¡¨çš„å½“å‰åˆ†æ”¯
        $this->db->update('content_items', [
            'current_branch_id' => $branch['id'],
            'current_version_id' => $branch['head_version_id']
        ], ['id' => $contentId]);
        
        return $branch;
    }
}
```

### 5.3 ç‰ˆæœ¬åˆå¹¶ä¸å†²çªå¤„ç†


**ğŸ”€ åˆå¹¶ç­–ç•¥å®ç°**
```php
class BranchMerger {
    
    // åˆå¹¶åˆ†æ”¯
    public function mergeBranch($sourceBranchId, $targetBranchId, $userId) {
        $this->db->beginTransaction();
        
        try {
            $sourceBranch = $this->getBranchById($sourceBranchId);
            $targetBranch = $this->getBranchById($targetBranchId);
            
            // æ£€æŸ¥åˆå¹¶å†²çª
            $conflicts = $this->detectMergeConflicts($sourceBranchId, $targetBranchId);
            
            if (!empty($conflicts)) {
                return [
                    'status' => 'conflict',
                    'conflicts' => $conflicts,
                    'merge_id' => $this->createMergeRequest($sourceBranchId, $targetBranchId, $userId)
                ];
            }
            
            // æ‰§è¡Œè‡ªåŠ¨åˆå¹¶
            $mergedVersionId = $this->performAutoMerge($sourceBranchId, $targetBranchId, $userId);
            
            // æ›´æ–°åˆ†æ”¯çŠ¶æ€
            $this->db->update('content_branches', [
                'status' => 'merged',
                'merged_at' => date('Y-m-d H:i:s')
            ], ['id' => $sourceBranchId]);
            
            $this->db->commit();
            
            return [
                'status' => 'success',
                'merged_version_id' => $mergedVersionId
            ];
            
        } catch (Exception $e) {
            $this->db->rollback();
            throw $e;
        }
    }
    
    // æ£€æµ‹åˆå¹¶å†²çª
    private function detectMergeConflicts($sourceBranchId, $targetBranchId) {
        // è·å–ä¸¤ä¸ªåˆ†æ”¯çš„æœ€æ–°ç‰ˆæœ¬
        $sourceVersion = $this->getBranchHeadVersion($sourceBranchId);
        $targetVersion = $this->getBranchHeadVersion($targetBranchId);
        
        // æŸ¥æ‰¾å…±åŒç¥–å…ˆç‰ˆæœ¬
        $baseVersion = $this->findCommonAncestor($sourceBranchId, $targetBranchId);
        
        // åˆ†æå†²çª
        return $this->analyzeConflicts($baseVersion, $sourceVersion, $targetVersion);
    }
}
```

**ğŸ¯ å†²çªè§£å†³ç•Œé¢**
```html
<!-- åˆå¹¶å†²çªè§£å†³ç•Œé¢ -->
<div class="merge-conflict-resolver">
    <div class="conflict-header">
        <h3>ğŸ”„ åˆå¹¶å†²çªè§£å†³</h3>
        <p>åˆ†æ”¯ <code>{source_branch}</code> â†’ <code>{target_branch}</code></p>
    </div>
    
    <div class="conflict-summary">
        <div class="stat-box">
            <span class="number">{conflict_count}</span>
            <span class="label">ä¸ªå†²çª</span>
        </div>
        <div class="stat-box">
            <span class="number">{auto_merged}</span>
            <span class="label">è‡ªåŠ¨åˆå¹¶</span>
        </div>
    </div>
    
    <div class="conflict-list">
        {#each conflicts as conflict}
        <div class="conflict-item">
            <h4>ğŸ“ å†²çªä½ç½®: ç¬¬ {conflict.line_number} è¡Œ</h4>
            
            <div class="conflict-content">
                <div class="version-content source">
                    <h5>ğŸŸ¢ ä½ çš„æ›´æ”¹</h5>
                    <pre>{conflict.source_content}</pre>
                    <button onclick="selectVersion('source', {conflict.id})">ä½¿ç”¨æ­¤ç‰ˆæœ¬</button>
                </div>
                
                <div class="version-content target">
                    <h5>ğŸ”µ ç›®æ ‡åˆ†æ”¯</h5>
                    <pre>{conflict.target_content}</pre>
                    <button onclick="selectVersion('target', {conflict.id})">ä½¿ç”¨æ­¤ç‰ˆæœ¬</button>
                </div>
                
                <div class="manual-edit">
                    <h5>âœï¸ æ‰‹åŠ¨ç¼–è¾‘</h5>
                    <textarea id="manual_edit_{conflict.id}">{conflict.merged_suggestion}</textarea>
                    <button onclick="selectVersion('manual', {conflict.id})">ä½¿ç”¨æ‰‹åŠ¨ç¼–è¾‘</button>
                </div>
            </div>
        </div>
        {/each}
    </div>
    
    <div class="merge-actions">
        <button class="btn-primary" onclick="completeMerge()">ğŸ¯ å®Œæˆåˆå¹¶</button>
        <button class="btn-secondary" onclick="cancelMerge()">âŒ å–æ¶ˆåˆå¹¶</button>
    </div>
</div>
```

---

## 6. ğŸ” ç‰ˆæœ¬æƒé™ä¸å®‰å…¨


### 6.1 ç‰ˆæœ¬æƒé™æ§åˆ¶


**ğŸ“‹ æƒé™ä½“ç³»è®¾è®¡**
```
ç‰ˆæœ¬æƒé™å±‚çº§ï¼š

ğŸ”¸ ç‰ˆæœ¬æŸ¥çœ‹æƒé™
â€¢ è°å¯ä»¥çœ‹åˆ°ç‰ˆæœ¬å†å²
â€¢ è°å¯ä»¥æŸ¥çœ‹ç‰ˆæœ¬å†…å®¹

ğŸ”¸ ç‰ˆæœ¬åˆ›å»ºæƒé™  
â€¢ è°å¯ä»¥åˆ›å»ºæ–°ç‰ˆæœ¬
â€¢ å“ªäº›çŠ¶æ€å¯ä»¥ç¼–è¾‘

ğŸ”¸ ç‰ˆæœ¬ç®¡ç†æƒé™
â€¢ è°å¯ä»¥åˆ é™¤ç‰ˆæœ¬
â€¢ è°å¯ä»¥å›æ»šç‰ˆæœ¬

ğŸ”¸ åˆ†æ”¯ç®¡ç†æƒé™
â€¢ è°å¯ä»¥åˆ›å»ºåˆ†æ”¯
â€¢ è°å¯ä»¥åˆå¹¶åˆ†æ”¯
```

**ğŸ”§ æƒé™è¡¨è®¾è®¡**
```sql
CREATE TABLE version_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    user_id BIGINT,
    role_id BIGINT,
    permission_type ENUM('view', 'edit', 'delete', 'rollback', 'branch', 'merge') NOT NULL,
    granted_by BIGINT NOT NULL,
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id),
    FOREIGN KEY (granted_by) REFERENCES users(id),
    INDEX idx_content_user (content_id, user_id),
    INDEX idx_content_role (content_id, role_id)
);

-- æƒé™æ£€æŸ¥å‡½æ•°
DELIMITER $$
CREATE FUNCTION check_version_permission(
    p_content_id BIGINT,
    p_user_id BIGINT, 
    p_permission VARCHAR(20)
) RETURNS BOOLEAN
READS SQL DATA
BEGIN
    DECLARE has_permission BOOLEAN DEFAULT FALSE;
    
    -- æ£€æŸ¥ç›´æ¥ç”¨æˆ·æƒé™
    SELECT COUNT(*) > 0 INTO has_permission
    FROM version_permissions
    WHERE content_id = p_content_id 
        AND user_id = p_user_id
        AND permission_type = p_permission
        AND (expires_at IS NULL OR expires_at > NOW());
    
    -- å¦‚æœæ²¡æœ‰ç›´æ¥æƒé™ï¼Œæ£€æŸ¥è§’è‰²æƒé™
    IF NOT has_permission THEN
        SELECT COUNT(*) > 0 INTO has_permission
        FROM version_permissions vp
        JOIN user_roles ur ON vp.role_id = ur.role_id
        WHERE vp.content_id = p_content_id 
            AND ur.user_id = p_user_id
            AND vp.permission_type = p_permission
            AND (vp.expires_at IS NULL OR vp.expires_at > NOW());
    END IF;
    
    RETURN has_permission;
END$$
DELIMITER ;
```

### 6.2 ç‰ˆæœ¬å®¡è®¡æ—¥å¿—


**ğŸ“Š æ“ä½œå®¡è®¡è®°å½•**
```sql
CREATE TABLE version_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    version_id BIGINT,
    branch_id BIGINT,
    user_id BIGINT NOT NULL,
    action_type ENUM('create', 'update', 'delete', 'rollback', 'merge', 'view') NOT NULL,
    action_details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    FOREIGN KEY (version_id) REFERENCES content_versions(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_content_time (content_id, created_at),
    INDEX idx_user_time (user_id, created_at),
    INDEX idx_action (action_type, created_at)
);
```

**ğŸ”§ å®¡è®¡æ—¥å¿—è®°å½•**
```php
class VersionAuditor {
    
    public function logVersionAction($contentId, $versionId, $userId, $action, $details = []) {
        $this->db->insert('version_audit_logs', [
            'content_id' => $contentId,
            'version_id' => $versionId,
            'user_id' => $userId,
            'action_type' => $action,
            'action_details' => json_encode(array_merge($details, [
                'timestamp' => time(),
                'request_id' => $this->getRequestId()
            ])),
            'ip_address' => $this->getClientIP(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? ''
        ]);
    }
    
    // è·å–å®¡è®¡æŠ¥å‘Š
    public function getAuditReport($contentId, $dateFrom, $dateTo) {
        return $this->db->query("
            SELECT 
                DATE(created_at) as date,
                action_type,
                COUNT(*) as action_count,
                COUNT(DISTINCT user_id) as unique_users
            FROM version_audit_logs
            WHERE content_id = ? 
                AND created_at BETWEEN ? AND ?
            GROUP BY DATE(created_at), action_type
            ORDER BY date DESC, action_type
        ", [$contentId, $dateFrom, $dateTo]);
    }
}
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 ç‰ˆæœ¬æŸ¥è¯¢ä¼˜åŒ–


**ğŸ“Š ç´¢å¼•ä¼˜åŒ–ç­–ç•¥**
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–ç‰ˆæœ¬æŸ¥è¯¢
CREATE INDEX idx_content_version_status ON content_versions (content_id, status, version_number DESC);
CREATE INDEX idx_author_content_time ON content_versions (author_id, content_id, created_at);

-- åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
ALTER TABLE content_versions 
PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

**ğŸ”§ æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**
```php
class OptimizedVersionQuery {
    
    // ä½¿ç”¨ç¼“å­˜çš„ç‰ˆæœ¬æŸ¥è¯¢
    public function getVersionHistory($contentId, $limit = 20) {
        $cacheKey = "version_history_{$contentId}_{$limit}";
        
        return $this->cache->remember($cacheKey, 300, function() use ($contentId, $limit) {
            return $this->db->query("
                SELECT 
                    v.id,
                    v.version_number,
                    v.title,
                    v.change_description,
                    v.status,
                    v.created_at,
                    u.username,
                    (v.id = c.current_version_id) as is_current
                FROM content_versions v
                INNER JOIN users u ON v.author_id = u.id
                INNER JOIN content_items c ON v.content_id = c.id
                WHERE v.content_id = ?
                ORDER BY v.version_number DESC
                LIMIT ?
            ", [$contentId, $limit]);
        });
    }
    
    // å»¶è¿ŸåŠ è½½ç‰ˆæœ¬å†…å®¹
    public function getVersionContent($versionId) {
        $cacheKey = "version_content_{$versionId}";
        
        return $this->cache->remember($cacheKey, 600, function() use ($versionId) {
            $version = $this->db->queryOne("
                SELECT content, is_compressed
                FROM content_versions 
                WHERE id = ?
            ", [$versionId]);
            
            if ($version['is_compressed']) {
                return $this->rebuildFromDiffs($versionId);
            }
            
            return $version['content'];
        });
    }
}
```

### 7.2 å­˜å‚¨ç©ºé—´ä¼˜åŒ–


**ğŸ’¾ æ•°æ®å‹ç¼©ç­–ç•¥**
```php
class VersionCompressor {
    
    // å†…å®¹å‹ç¼©å­˜å‚¨
    public function compressVersionContent($content) {
        // ä½¿ç”¨gzipå‹ç¼©å¤§å†…å®¹
        if (strlen($content) > 1024) {
            return [
                'content' => base64_encode(gzcompress($content, 9)),
                'compressed' => true,
                'original_size' => strlen($content),
                'compressed_size' => strlen(gzcompress($content, 9))
            ];
        }
        
        return [
            'content' => $content,
            'compressed' => false,
            'original_size' => strlen($content)
        ];
    }
    
    // å†…å®¹è§£å‹ç¼©
    public function decompressVersionContent($data) {
        if ($data['compressed']) {
            return gzuncompress(base64_decode($data['content']));
        }
        
        return $data['content'];
    }
    
    // æ‰¹é‡å‹ç¼©æ—§ç‰ˆæœ¬
    public function compressOldVersions($olderThanDays = 30) {
        $cutoffDate = date('Y-m-d', strtotime("-{$olderThanDays} days"));
        
        $versions = $this->db->query("
            SELECT id, content 
            FROM content_versions 
            WHERE created_at < ? 
                AND is_compressed = 0
                AND LENGTH(content) > 1024
            LIMIT 1000
        ", [$cutoffDate]);
        
        foreach ($versions as $version) {
            $compressed = $this->compressVersionContent($version['content']);
            
            $this->db->update('content_versions', [
                'content' => $compressed['content'],
                'is_compressed' => $compressed['compressed'] ? 1 : 0,
                'original_size' => $compressed['original_size'],
                'compressed_size' => $compressed['compressed_size'] ?? null
            ], ['id' => $version['id']]);
        }
    }
}
```

### 7.3 ç‰ˆæœ¬æ¸…ç†ç­–ç•¥


**ğŸ—‘ï¸ è‡ªåŠ¨æ¸…ç†æœºåˆ¶**
```php
class VersionCleaner {
    
    // ç‰ˆæœ¬æ¸…ç†ç­–ç•¥é…ç½®
    private $cleanupRules = [
        'keep_versions' => 50,           // ä¿ç•™æœ€è¿‘50ä¸ªç‰ˆæœ¬
        'keep_days' => 365,              // ä¿ç•™ä¸€å¹´å†…çš„ç‰ˆæœ¬
        'keep_milestones' => true,       // ä¿ç•™é‡Œç¨‹ç¢‘ç‰ˆæœ¬
        'compress_after_days' => 30,     // 30å¤©åå‹ç¼©
        'cleanup_batch_size' => 1000     // æ‰¹å¤„ç†å¤§å°
    ];
    
    public function cleanupOldVersions($contentId = null) {
        $whereClause = $contentId ? "WHERE content_id = {$contentId}" : "";
        
        // è·å–éœ€è¦æ¸…ç†çš„ç‰ˆæœ¬
        $versionsToClean = $this->db->query("
            SELECT 
                id,
                content_id,
                version_number,
                created_at,
                status
            FROM content_versions 
            {$whereClause}
            AND created_at < DATE_SUB(NOW(), INTERVAL {$this->cleanupRules['keep_days']} DAY)
            AND status NOT IN ('published', 'milestone')
            ORDER BY content_id, version_number
        ");
        
        $processed = 0;
        foreach ($versionsToClean as $version) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿ç•™
            if ($this->shouldKeepVersion($version)) {
                continue;
            }
            
            // è½¯åˆ é™¤ç‰ˆæœ¬
            $this->archiveVersion($version['id']);
            $processed++;
            
            if ($processed >= $this->cleanupRules['cleanup_batch_size']) {
                break;
            }
        }
        
        return $processed;
    }
    
    private function shouldKeepVersion($version) {
        // æ£€æŸ¥æ˜¯å¦ä¸ºé‡Œç¨‹ç¢‘ç‰ˆæœ¬
        if ($this->cleanupRules['keep_milestones'] && $version['status'] === 'milestone') {
            return true;
        }
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ä¿ç•™çš„ç‰ˆæœ¬æ•°é‡å†…
        $recentVersions = $this->getRecentVersionCount($version['content_id']);
        if ($recentVersions <= $this->cleanupRules['keep_versions']) {
            return true;
        }
        
        return false;
    }
}
```

---

## 8. ğŸ“ å¤§æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†


### 8.1 å¤§æ–‡ä»¶å¤„ç†ç­–ç•¥


**ğŸ“Š æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†è®¾è®¡**
```
å¤§æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–‡ä»¶å…ƒæ•°æ®     â”‚ â†â†’ â”‚   ç‰ˆæœ¬è®°å½•       â”‚ â†â†’ â”‚   å—å­˜å‚¨        â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚  
â”‚ â€¢ æ–‡ä»¶å        â”‚    â”‚ â€¢ ç‰ˆæœ¬å·        â”‚    â”‚ â€¢ æ–‡ä»¶å—        â”‚
â”‚ â€¢ æ–‡ä»¶å¤§å°      â”‚    â”‚ â€¢ ä¿®æ”¹æ—¶é—´      â”‚    â”‚ â€¢ å—å“ˆå¸Œ        â”‚
â”‚ â€¢ MIMEç±»å‹      â”‚    â”‚ â€¢ ä½œè€…ä¿¡æ¯      â”‚    â”‚ â€¢ å—ä½ç½®        â”‚
â”‚ â€¢ å“ˆå¸Œå€¼        â”‚    â”‚ â€¢ å˜æ›´è¯´æ˜      â”‚    â”‚ â€¢ é‡å¤æ£€æµ‹      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ å¤§æ–‡ä»¶ç‰ˆæœ¬è¡¨è®¾è®¡**
```sql
-- æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†è¡¨
CREATE TABLE file_versions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    content_id BIGINT NOT NULL,
    version_number INT NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_size BIGINT NOT NULL,
    file_hash VARCHAR(64) NOT NULL,  -- SHA256å“ˆå¸Œ
    mime_type VARCHAR(100),
    storage_path VARCHAR(500),
    chunk_count INT DEFAULT 1,
    author_id BIGINT NOT NULL,
    change_description VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (content_id) REFERENCES content_items(id),
    INDEX idx_content_version (content_id, version_number),
    INDEX idx_file_hash (file_hash)
);

-- æ–‡ä»¶å—å­˜å‚¨è¡¨
CREATE TABLE file_chunks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    file_version_id BIGINT NOT NULL,
    chunk_index INT NOT NULL,
    chunk_hash VARCHAR(64) NOT NULL,
    chunk_size INT NOT NULL,
    storage_path VARCHAR(500) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (file_version_id) REFERENCES file_versions(id),
    UNIQUE KEY uk_version_chunk (file_version_id, chunk_index),
    INDEX idx_chunk_hash (chunk_hash)
);
```

### 8.2 æ–‡ä»¶å—åŒ–å­˜å‚¨


**ğŸ”§ æ–‡ä»¶åˆ†å—ä¸Šä¼ å®ç°**
```php
class LargeFileVersionManager {
    
    private $chunkSize = 1024 * 1024; // 1MBå—å¤§å°
    
    // åˆ†å—ä¸Šä¼ å¤„ç†
    public function handleChunkedUpload($contentId, $fileData, $userId) {
        $tempDir = sys_get_temp_dir() . '/file_upload_' . uniqid();
        mkdir($tempDir);
        
        try {
            // åˆ†ææ–‡ä»¶å¹¶åˆ›å»ºå—
            $chunks = $this->splitFileIntoChunks($fileData['tmp_name'], $tempDir);
            
            // æ£€æŸ¥é‡å¤å—ï¼ˆå»é‡ä¼˜åŒ–ï¼‰
            $deduplicatedChunks = $this->deduplicateChunks($chunks);
            
            // åˆ›å»ºæ–‡ä»¶ç‰ˆæœ¬è®°å½•
            $versionId = $this->createFileVersion($contentId, $fileData, $userId, count($chunks));
            
            // å­˜å‚¨æ–‡ä»¶å—
            foreach ($deduplicatedChunks as $index => $chunk) {
                $this->storeFileChunk($versionId, $index, $chunk);
            }
            
            return $versionId;
            
        } finally {
            $this->cleanupTempDir($tempDir);
        }
    }
    
    private function splitFileIntoChunks($filePath, $tempDir) {
        $file = fopen($filePath, 'rb');
        $chunks = [];
        $chunkIndex = 0;
        
        while (!feof($file)) {
            $chunkData = fread($file, $this->chunkSize);
            $chunkHash = hash('sha256', $chunkData);
            $chunkPath = $tempDir . '/chunk_' . $chunkIndex;
            
            file_put_contents($chunkPath, $chunkData);
            
            $chunks[] = [
                'index' => $chunkIndex,
                'hash' => $chunkHash,
                'size' => strlen($chunkData),
                'path' => $chunkPath
            ];
            
            $chunkIndex++;
        }
        
        fclose($file);
        return $chunks;
    }
    
    // é‡å¤å—å»é‡
    private function deduplicateChunks($chunks) {
        $existingChunks = [];
        
        // æŸ¥è¯¢å·²å­˜åœ¨çš„å—
        $hashes = array_column($chunks, 'hash');
        $existing = $this->db->query("
            SELECT chunk_hash, storage_path 
            FROM file_chunks 
            WHERE chunk_hash IN ('" . implode("','", $hashes) . "')
        ");
        
        foreach ($existing as $row) {
            $existingChunks[$row['chunk_hash']] = $row['storage_path'];
        }
        
        // æ ‡è®°é‡å¤çš„å—
        foreach ($chunks as &$chunk) {
            if (isset($existingChunks[$chunk['hash']])) {
                $chunk['duplicate'] = true;
                $chunk['existing_path'] = $existingChunks[$chunk['hash']];
            }
        }
        
        return $chunks;
    }
}
```

### 8.3 å¢é‡åŒæ­¥æœºåˆ¶


**ğŸ”„ æ–‡ä»¶å·®å¼‚æ£€æµ‹**
```php
class FileDiffManager {
    
    // è®¡ç®—æ–‡ä»¶å·®å¼‚
    public function calculateFileDiff($oldVersionId, $newVersionId) {
        $oldChunks = $this->getVersionChunks($oldVersionId);
        $newChunks = $this->getVersionChunks($newVersionId);
        
        $diff = [
            'added' => [],      // æ–°å¢çš„å—
            'removed' => [],    // åˆ é™¤çš„å—
            'modified' => [],   // ä¿®æ”¹çš„å—
            'unchanged' => []   // æœªå˜åŒ–çš„å—
        ];
        
        $oldHashes = array_column($oldChunks, 'chunk_hash', 'chunk_index');
        $newHashes = array_column($newChunks, 'chunk_hash', 'chunk_index');
        
        // æ‰¾å‡ºå˜åŒ–çš„å—
        foreach ($newHashes as $index => $hash) {
            if (!isset($oldHashes[$index])) {
                $diff['added'][] = $index;
            } elseif ($oldHashes[$index] !== $hash) {
                $diff['modified'][] = $index;
            } else {
                $diff['unchanged'][] = $index;
            }
        }
        
        // æ‰¾å‡ºåˆ é™¤çš„å—
        foreach ($oldHashes as $index => $hash) {
            if (!isset($newHashes[$index])) {
                $diff['removed'][] = $index;
            }
        }
        
        return $diff;
    }
    
    // ç”ŸæˆåŒæ­¥æŒ‡ä»¤
    public function generateSyncInstructions($diff) {
        return [
            'operations' => [
                'download_chunks' => $diff['added'] + $diff['modified'],
                'delete_chunks' => $diff['removed'],
                'keep_chunks' => $diff['unchanged']
            ],
            'stats' => [
                'total_chunks' => count($diff['added']) + count($diff['modified']) + count($diff['unchanged']),
                'changed_chunks' => count($diff['added']) + count($diff['modified']) + count($diff['removed']),
                'efficiency' => count($diff['unchanged']) / (count($diff['added']) + count($diff['modified']) + count($diff['unchanged']))
            ]
        ];
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç‰ˆæœ¬ç®¡ç†æœ¬è´¨ï¼šå†…å®¹å˜æ›´çš„å®Œæ•´è®°å½•å’Œè¿½è¸ªä½“ç³»
ğŸ”¸ å­˜å‚¨ç­–ç•¥ï¼šå¿«ç…§ vs å¢é‡ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ  
ğŸ”¸ åˆ†æ”¯æ¨¡å‹ï¼šæ”¯æŒå¹¶è¡Œå¼€å‘ï¼Œç±»ä¼¼Gitçš„åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶
ğŸ”¸ æƒé™æ§åˆ¶ï¼šç²¾ç»†åŒ–çš„ç‰ˆæœ¬æ“ä½œæƒé™ç®¡ç†
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ã€ç´¢å¼•ã€å‹ç¼©ã€åˆ†ç‰‡ç­‰å¤šç»´åº¦ä¼˜åŒ–
```

### 9.2 è®¾è®¡å…³é”®è¦ç‚¹


**ğŸ”¹ æ•°æ®åº“è®¾è®¡åŸåˆ™**
```
è¡¨ç»“æ„è®¾è®¡ï¼š
â€¢ ä¸»è¡¨å­˜å‚¨å½“å‰ç‰ˆæœ¬æŒ‡é’ˆ
â€¢ ç‰ˆæœ¬è¡¨è®°å½•æ‰€æœ‰å†å²ç‰ˆæœ¬  
â€¢ åˆ†æ”¯è¡¨æ”¯æŒå¹¶è¡Œå¼€å‘
â€¢ æƒé™è¡¨æ§åˆ¶æ“ä½œæƒé™

ç´¢å¼•ç­–ç•¥ï¼š
â€¢ (content_id, version_number) å¤åˆç´¢å¼•
â€¢ (author_id, created_at) æ—¶é—´æŸ¥è¯¢ç´¢å¼•
â€¢ status çŠ¶æ€æŸ¥è¯¢ç´¢å¼•
```

**ğŸ”¹ å­˜å‚¨ä¼˜åŒ–ç­–ç•¥**
```
å°æ–‡ä»¶åœºæ™¯ï¼š
â€¢ ä½¿ç”¨å®Œæ•´å¿«ç…§å­˜å‚¨
â€¢ ç®€å•ç›´è§‚ï¼ŒæŸ¥è¯¢å¿«é€Ÿ

å¤§æ–‡ä»¶åœºæ™¯ï¼š  
â€¢ é‡‡ç”¨å¢é‡å·®å¼‚å­˜å‚¨
â€¢ åˆ†å—å­˜å‚¨ï¼Œæ”¯æŒå»é‡

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ å®šæœŸå‹ç¼©å†å²ç‰ˆæœ¬
â€¢ ç¼“å­˜çƒ­ç‚¹ç‰ˆæœ¬å†…å®¹
â€¢ å¼‚æ­¥å¤„ç†é‡é‡çº§æ“ä½œ
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯**
- **å†…å®¹ç®¡ç†ç³»ç»Ÿ**ï¼šæ–‡ç« ã€é¡µé¢ç‰ˆæœ¬ç®¡ç†
- **åä½œæ–‡æ¡£**ï¼šå¤šäººç¼–è¾‘ï¼Œç‰ˆæœ¬è¿½è¸ª  
- **ä»£ç ç®¡ç†**ï¼šé…ç½®æ–‡ä»¶ç‰ˆæœ¬æ§åˆ¶
- **æ•°æ®å¤‡ä»½**ï¼šé‡è¦æ•°æ®çš„ç‰ˆæœ¬å¤‡ä»½

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
æ€§èƒ½è€ƒè™‘ï¼š
â€¢ ç‰ˆæœ¬æ•°é‡è¿‡å¤šå½±å“æŸ¥è¯¢æ€§èƒ½
â€¢ å¤§æ–‡ä»¶ç‰ˆæœ¬å ç”¨å­˜å‚¨ç©ºé—´
â€¢ é¢‘ç¹ç‰ˆæœ¬æ“ä½œå½±å“æ•°æ®åº“æ€§èƒ½

è§£å†³æ–¹æ¡ˆï¼š
â€¢ åˆç†çš„ç‰ˆæœ¬æ¸…ç†ç­–ç•¥
â€¢ ä½¿ç”¨ç¼“å­˜æå‡æŸ¥è¯¢é€Ÿåº¦
â€¢ å¼‚æ­¥å¤„ç†é‡å‹æ“ä½œ
```

### 9.4 æœ€ä½³å®è·µ


**ğŸ¯ ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ**
```
ğŸ”¸ è®¾è®¡é˜¶æ®µ
â€¢ æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©å­˜å‚¨ç­–ç•¥
â€¢ é¢„ç•™è¶³å¤Ÿçš„æ‰©å±•æ€§
â€¢ è€ƒè™‘æ•°æ®è¿ç§»å’Œå¤‡ä»½

ğŸ”¸ å¼€å‘é˜¶æ®µ  
â€¢ ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
â€¢ å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†
â€¢ æ·»åŠ è¯¦ç»†çš„å®¡è®¡æ—¥å¿—

ğŸ”¸ è¿ç»´é˜¶æ®µ
â€¢ å®šæœŸæ¸…ç†å†å²ç‰ˆæœ¬
â€¢ ç›‘æ§å­˜å‚¨ç©ºé—´ä½¿ç”¨
â€¢ ä¼˜åŒ–æ…¢æŸ¥è¯¢æ€§èƒ½
```

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**
```
Q: ç‰ˆæœ¬è¿‡å¤šå¯¼è‡´æŸ¥è¯¢æ…¢ï¼Ÿ
A: ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ + ç¼“å­˜çƒ­ç‚¹æ•°æ® + å®šæœŸå½’æ¡£

Q: å­˜å‚¨ç©ºé—´å ç”¨å¤§ï¼Ÿ  
A: å¢é‡å­˜å‚¨ + å†…å®¹å‹ç¼© + é‡å¤å—å»é‡

Q: å¹¶å‘ç¼–è¾‘å†²çªï¼Ÿ
A: ä¹è§‚é” + åˆ†æ”¯åˆå¹¶ + å†²çªè§£å†³æœºåˆ¶

Q: æƒé™æ§åˆ¶å¤æ‚ï¼Ÿ
A: åŸºäºè§’è‰²çš„æƒé™æ¨¡å‹ + ç»†ç²’åº¦æƒé™æ§åˆ¶
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç‰ˆæœ¬ç®¡ç†æ˜¯å†…å®¹å®‰å…¨å’Œåä½œçš„åŸºç¡€ä¿éšœ
- å­˜å‚¨ç­–ç•¥éœ€è¦å¹³è¡¡ç©ºé—´å ç”¨å’ŒæŸ¥è¯¢æ€§èƒ½  
- åˆ†æ”¯æ¨¡å‹æ”¯æŒå¤æ‚çš„åä½œå¼€å‘åœºæ™¯
- æƒé™æ§åˆ¶ç¡®ä¿ç‰ˆæœ¬æ“ä½œçš„å®‰å…¨æ€§
- æ€§èƒ½ä¼˜åŒ–æ˜¯å¤§è§„æ¨¡åº”ç”¨çš„å…³é”®