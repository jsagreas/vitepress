---
title: 2ã€æƒé™ä½“ç³»è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [æƒé™ä½“ç³»è®¾è®¡æ¦‚è¿°](#1-æƒé™ä½“ç³»è®¾è®¡æ¦‚è¿°)
2. [RBACæƒé™æ¨¡å‹è¯¦è§£](#2-RBACæƒé™æ¨¡å‹è¯¦è§£)
3. [æƒé™ç²’åº¦æ§åˆ¶è®¾è®¡](#3-æƒé™ç²’åº¦æ§åˆ¶è®¾è®¡)
4. [å†…å®¹ç®¡ç†æƒé™å®ç°](#4-å†…å®¹ç®¡ç†æƒé™å®ç°)
5. [åŠ¨æ€æƒé™åˆ†é…æœºåˆ¶](#5-åŠ¨æ€æƒé™åˆ†é…æœºåˆ¶)
6. [æƒé™ç¼“å­˜ä¼˜åŒ–ç­–ç•¥](#6-æƒé™ç¼“å­˜ä¼˜åŒ–ç­–ç•¥)
7. [æƒé™å®¡è®¡ä¸è¿½è¸ª](#7-æƒé™å®¡è®¡ä¸è¿½è¸ª)
8. [å¤šç§Ÿæˆ·æƒé™éš”ç¦»](#8-å¤šç§Ÿæˆ·æƒé™éš”ç¦»)
9. [æƒé™æ€§èƒ½ä¼˜åŒ–](#9-æƒé™æ€§èƒ½ä¼˜åŒ–)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ æƒé™ä½“ç³»è®¾è®¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æƒé™ä½“ç³»


**æƒé™ä½“ç³»**å°±æ˜¯ç”¨æ¥æ§åˆ¶"è°èƒ½åšä»€ä¹ˆäº‹æƒ…"çš„ç®¡ç†ç³»ç»Ÿã€‚ç®€å•è¯´å°±æ˜¯ï¼š
- **è°**ï¼šç”¨æˆ·èº«ä»½è¯†åˆ«
- **åšä»€ä¹ˆ**ï¼šå…·ä½“çš„æ“ä½œè¡Œä¸º
- **åœ¨å“ªé‡Œ**ï¼šæ“ä½œçš„èµ„æºèŒƒå›´

```
ç”Ÿæ´»ä¸­çš„æƒé™ä½“ç³»ï¼š
å®¶åº­ï¼šçˆ¶æ¯èƒ½ç®¡ç†æ‰€æœ‰ï¼Œå­©å­åªèƒ½ä½¿ç”¨éƒ¨åˆ†ç‰©å“
å…¬å¸ï¼šè€æ¿èƒ½çœ‹æ‰€æœ‰æ•°æ®ï¼Œå‘˜å·¥åªèƒ½çœ‹è‡ªå·±è´Ÿè´£çš„
é“¶è¡Œï¼šæŸœå‘˜èƒ½æŸ¥è´¦æˆ·ï¼Œä½†åªæœ‰ä¸»ç®¡èƒ½æ‰¹å‡†å¤§é¢è½¬è´¦
```

### 1.2 å†…å®¹ç®¡ç†ç³»ç»Ÿçš„æƒé™éœ€æ±‚


**å†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰**çš„æƒé™æ¯”ä¸€èˆ¬ç³»ç»Ÿæ›´å¤æ‚ï¼Œå› ä¸ºå†…å®¹æœ‰**ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
å†…å®¹ç”Ÿå‘½å‘¨æœŸï¼š
è‰ç¨¿ â†’ å®¡æ ¸ä¸­ â†’ å·²å‘å¸ƒ â†’ å·²ä¸‹çº¿

ä¸åŒé˜¶æ®µéœ€è¦ä¸åŒæƒé™ï¼š
- ç¼–è¾‘ï¼šèƒ½åˆ›å»ºå’Œä¿®æ”¹è‰ç¨¿
- å®¡æ ¸å‘˜ï¼šèƒ½å®¡æ ¸å†…å®¹
- å‘å¸ƒå‘˜ï¼šèƒ½å‘å¸ƒå†…å®¹
- ç®¡ç†å‘˜ï¼šèƒ½æ‰§è¡Œæ‰€æœ‰æ“ä½œ
```

### 1.3 æƒé™ä½“ç³»æ¶æ„å›¾


```
æƒé™ä½“ç³»æ•´ä½“æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·å±‚      â”‚    â”‚     è§’è‰²å±‚      â”‚    â”‚     æƒé™å±‚      â”‚
â”‚   (User)       â”‚â”€â”€â”€â”€â”‚    (Role)       â”‚â”€â”€â”€â”€â”‚ (Permission)    â”‚
â”‚ Â·ç®¡ç†å‘˜         â”‚    â”‚ Â·å†…å®¹ç®¡ç†å‘˜     â”‚    â”‚ Â·åˆ›å»ºæ–‡ç«        â”‚
â”‚ Â·ç¼–è¾‘          â”‚    â”‚ Â·å®¡æ ¸å‘˜         â”‚    â”‚ Â·å®¡æ ¸å†…å®¹       â”‚
â”‚ Â·ä½œè€…          â”‚    â”‚ Â·å‘å¸ƒå‘˜         â”‚    â”‚ Â·å‘å¸ƒå†…å®¹       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     èµ„æºå±‚      â”‚
                    â”‚  (Resource)     â”‚
                    â”‚ Â·æ–‡ç« å†…å®¹       â”‚
                    â”‚ Â·ç”¨æˆ·æ•°æ®       â”‚
                    â”‚ Â·ç³»ç»Ÿé…ç½®       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ” RBACæƒé™æ¨¡å‹è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯RBACæ¨¡å‹


**RBAC**ï¼ˆRole-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰æ˜¯æœ€å¸¸ç”¨çš„æƒé™ç®¡ç†æ¨¡å‹ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸ç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™ï¼Œè€Œæ˜¯ï¼š
1. **å®šä¹‰è§’è‰²**ï¼šæ¯”å¦‚"ç¼–è¾‘"ã€"å®¡æ ¸å‘˜"
2. **ç»™è§’è‰²åˆ†é…æƒé™**ï¼šæ¯”å¦‚"ç¼–è¾‘"è§’è‰²æœ‰"åˆ›å»ºæ–‡ç« "æƒé™
3. **ç»™ç”¨æˆ·åˆ†é…è§’è‰²**ï¼šæ¯”å¦‚å¼ ä¸‰æ˜¯"ç¼–è¾‘"è§’è‰²

**ä¼˜åŠ¿**ï¼š
- ç®¡ç†ç®€å•ï¼šæ‰¹é‡ç®¡ç†æƒé™
- èŒè´£æ¸…æ™°ï¼šè§’è‰²å¯¹åº”å²—ä½
- ä¾¿äºç»´æŠ¤ï¼šä¿®æ”¹è§’è‰²æƒé™å³å¯

### 2.2 RBACæ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡


```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    status ENUM('active', 'inactive', 'locked') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) COMMENT='ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨';

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_name VARCHAR(50) UNIQUE NOT NULL,
    role_desc VARCHAR(200),
    is_system BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç³»ç»Ÿå†…ç½®è§’è‰²',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_role_name (role_name)
) COMMENT='è§’è‰²å®šä¹‰è¡¨';

-- æƒé™è¡¨
CREATE TABLE permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) UNIQUE NOT NULL,
    permission_name VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50) NOT NULL COMMENT 'èµ„æºç±»å‹ï¼šarticle,user,system',
    action_type VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹ï¼šcreate,read,update,delete',
    description VARCHAR(200),
    INDEX idx_permission_code (permission_code),
    INDEX idx_resource_action (resource_type, action_type)
) COMMENT='æƒé™å®šä¹‰è¡¨';
```

### 2.3 å…³è”å…³ç³»è¡¨è®¾è®¡


```sql
-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    role_id INT NOT NULL,
    assigned_by INT COMMENT 'åˆ†é…äººID',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ŒNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ',
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_role (user_id, role_id)
) COMMENT='ç”¨æˆ·è§’è‰²å…³è”è¡¨';

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    permission_id INT NOT NULL,
    granted_by INT COMMENT 'æˆæƒäººID',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE KEY uk_role_permission (role_id, permission_id)
) COMMENT='è§’è‰²æƒé™å…³è”è¡¨';
```

### 2.4 åŸºç¡€æƒé™æ•°æ®åˆå§‹åŒ–


```sql
-- æ’å…¥åŸºç¡€æƒé™
INSERT INTO permissions (permission_code, permission_name, resource_type, action_type, description) VALUES
('article:create', 'åˆ›å»ºæ–‡ç« ', 'article', 'create', 'å¯ä»¥åˆ›å»ºæ–°æ–‡ç« '),
('article:read', 'æŸ¥çœ‹æ–‡ç« ', 'article', 'read', 'å¯ä»¥æŸ¥çœ‹æ–‡ç« å†…å®¹'),
('article:update', 'ç¼–è¾‘æ–‡ç« ', 'article', 'update', 'å¯ä»¥ä¿®æ”¹æ–‡ç« å†…å®¹'),
('article:delete', 'åˆ é™¤æ–‡ç« ', 'article', 'delete', 'å¯ä»¥åˆ é™¤æ–‡ç« '),
('article:publish', 'å‘å¸ƒæ–‡ç« ', 'article', 'publish', 'å¯ä»¥å‘å¸ƒæ–‡ç« '),
('article:audit', 'å®¡æ ¸æ–‡ç« ', 'article', 'audit', 'å¯ä»¥å®¡æ ¸æ–‡ç« '),
('user:manage', 'ç”¨æˆ·ç®¡ç†', 'user', 'manage', 'å¯ä»¥ç®¡ç†ç”¨æˆ·è´¦æˆ·'),
('system:config', 'ç³»ç»Ÿé…ç½®', 'system', 'config', 'å¯ä»¥ä¿®æ”¹ç³»ç»Ÿé…ç½®');

-- æ’å…¥åŸºç¡€è§’è‰²
INSERT INTO roles (role_name, role_desc, is_system) VALUES
('super_admin', 'è¶…çº§ç®¡ç†å‘˜', TRUE),
('content_admin', 'å†…å®¹ç®¡ç†å‘˜', TRUE),
('editor', 'ç¼–è¾‘', TRUE),
('author', 'ä½œè€…', TRUE),
('auditor', 'å®¡æ ¸å‘˜', TRUE);
```

---

## 3. ğŸ¯ æƒé™ç²’åº¦æ§åˆ¶è®¾è®¡


### 3.1 ä»€ä¹ˆæ˜¯æƒé™ç²’åº¦


**æƒé™ç²’åº¦**æŒ‡çš„æ˜¯æƒé™æ§åˆ¶çš„ç²¾ç»†ç¨‹åº¦ï¼Œå°±åƒç­›å­çš„ç½‘çœ¼å¤§å°ï¼š

```
ç²—ç²’åº¦æƒé™ï¼šèƒ½å¦è®¿é—®æ–‡ç« æ¨¡å—
ä¸­ç²’åº¦æƒé™ï¼šèƒ½å¦ç¼–è¾‘æ–‡ç« 
ç»†ç²’åº¦æƒé™ï¼šèƒ½å¦ç¼–è¾‘æ–‡ç« çš„æ ‡é¢˜å­—æ®µ

ç²’åº¦è¶Šç»†ï¼Œæ§åˆ¶è¶Šç²¾ç¡®ï¼Œä½†å¤æ‚åº¦ä¹Ÿè¶Šé«˜
```

### 3.2 å­—æ®µçº§æƒé™æ§åˆ¶å®ç°


æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ§åˆ¶ç”¨æˆ·åªèƒ½ä¿®æ”¹æŸäº›å­—æ®µï¼Œæ¯”å¦‚ä½œè€…åªèƒ½æ”¹æ ‡é¢˜å’Œå†…å®¹ï¼Œä½†ä¸èƒ½æ”¹å‘å¸ƒçŠ¶æ€ã€‚

```sql
-- å­—æ®µçº§æƒé™è¡¨
CREATE TABLE field_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    table_name VARCHAR(50) NOT NULL,
    field_name VARCHAR(50) NOT NULL,
    permission_type ENUM('read', 'write', 'none') DEFAULT 'none',
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY uk_role_table_field (role_id, table_name, field_name),
    INDEX idx_table_field (table_name, field_name)
) COMMENT='å­—æ®µçº§æƒé™æ§åˆ¶è¡¨';

-- ç¤ºä¾‹ï¼šé…ç½®ä½œè€…è§’è‰²çš„å­—æ®µæƒé™
INSERT INTO field_permissions (role_id, table_name, field_name, permission_type) VALUES
((SELECT id FROM roles WHERE role_name = 'author'), 'articles', 'title', 'write'),
((SELECT id FROM roles WHERE role_name = 'author'), 'articles', 'content', 'write'),
((SELECT id FROM roles WHERE role_name = 'author'), 'articles', 'status', 'read');
```

### 3.3 æ¡ä»¶æƒé™æ§åˆ¶


**æ¡ä»¶æƒé™**å°±æ˜¯æ ¹æ®æ•°æ®çš„å…·ä½“æƒ…å†µæ¥åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œæ¯”å¦‚"åªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„æ–‡ç« "ã€‚

```sql
-- æ¡ä»¶æƒé™è¡¨
CREATE TABLE conditional_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    permission_id INT NOT NULL,
    condition_type ENUM('owner', 'department', 'time_range', 'custom') NOT NULL,
    condition_value JSON COMMENT 'æ¡ä»¶å‚æ•°ï¼Œä½¿ç”¨JSONå­˜å‚¨',
    description VARCHAR(200),
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    INDEX idx_permission_condition (permission_id, condition_type)
) COMMENT='æ¡ä»¶æƒé™é…ç½®è¡¨';

-- ç¤ºä¾‹ï¼šé…ç½®"åªèƒ½ç¼–è¾‘è‡ªå·±çš„æ–‡ç« "æ¡ä»¶
INSERT INTO conditional_permissions (permission_id, condition_type, condition_value, description) VALUES
((SELECT id FROM permissions WHERE permission_code = 'article:update'), 
 'owner', 
 '{"field": "created_by", "operator": "equals", "value": "@current_user_id"}',
 'åªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„æ–‡ç« ');
```

### 3.4 æƒé™æ£€æŸ¥å®ç°å‡½æ•°


```sql
-- åˆ›å»ºæƒé™æ£€æŸ¥å‡½æ•°
DELIMITER $$

CREATE FUNCTION check_user_permission(
    p_user_id INT,
    p_permission_code VARCHAR(100),
    p_resource_id INT DEFAULT NULL
) RETURNS BOOLEAN
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE v_has_permission BOOLEAN DEFAULT FALSE;
    DECLARE v_permission_id INT;
    
    -- è·å–æƒé™ID
    SELECT id INTO v_permission_id 
    FROM permissions 
    WHERE permission_code = p_permission_code;
    
    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€šè¿‡è§’è‰²æ‹¥æœ‰æ­¤æƒé™
    SELECT COUNT(*) > 0 INTO v_has_permission
    FROM user_roles ur
    JOIN role_permissions rp ON ur.role_id = rp.role_id
    WHERE ur.user_id = p_user_id 
    AND rp.permission_id = v_permission_id
    AND (ur.expires_at IS NULL OR ur.expires_at > NOW());
    
    -- å¦‚æœæœ‰åŸºç¡€æƒé™ï¼Œå†æ£€æŸ¥æ¡ä»¶æƒé™
    IF v_has_permission AND p_resource_id IS NOT NULL THEN
        -- è¿™é‡Œå¯ä»¥åŠ å…¥æ¡ä»¶æƒé™çš„æ£€æŸ¥é€»è¾‘
        -- ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹
        SET v_has_permission = TRUE;
    END IF;
    
    RETURN v_has_permission;
END$$

DELIMITER ;
```

---

## 4. ğŸ“ å†…å®¹ç®¡ç†æƒé™å®ç°


### 4.1 å†…å®¹ç”Ÿå‘½å‘¨æœŸæƒé™è®¾è®¡


å†…å®¹ç®¡ç†ç³»ç»Ÿçš„æ–‡ç« æœ‰ä¸åŒçš„çŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€ä¸‹çš„æƒé™è¦æ±‚ä¸åŒï¼š

```sql
-- æ–‡ç« è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
CREATE TABLE articles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    status ENUM('draft', 'pending', 'published', 'archived') DEFAULT 'draft',
    created_by INT NOT NULL,
    updated_by INT,
    published_by INT,
    published_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_created_by (created_by)
) COMMENT='æ–‡ç« å†…å®¹è¡¨';

-- æ–‡ç« æ“ä½œæƒé™è¡¨
CREATE TABLE article_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    role_id INT NOT NULL,
    article_status ENUM('draft', 'pending', 'published', 'archived') NOT NULL,
    allowed_actions JSON NOT NULL COMMENT 'å…è®¸çš„æ“ä½œåˆ—è¡¨',
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY uk_role_status (role_id, article_status)
) COMMENT='æ–‡ç« çŠ¶æ€æƒé™é…ç½®è¡¨';
```

### 4.2 å‘å¸ƒæƒé™æ§åˆ¶å®ç°


**å‘å¸ƒæƒé™æ§åˆ¶**æ˜¯å†…å®¹ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œéœ€è¦ç¡®ä¿å†…å®¹è´¨é‡å’Œåˆè§„æ€§ï¼š

```sql
-- å‘å¸ƒå®¡æ ¸æµç¨‹è¡¨
CREATE TABLE publish_workflows (
    id INT PRIMARY KEY AUTO_INCREMENT,
    workflow_name VARCHAR(100) NOT NULL,
    steps JSON NOT NULL COMMENT 'å®¡æ ¸æ­¥éª¤é…ç½®',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_workflow_name (workflow_name)
) COMMENT='å‘å¸ƒå®¡æ ¸æµç¨‹é…ç½®è¡¨';

-- æ–‡ç« å®¡æ ¸è®°å½•è¡¨
CREATE TABLE article_audit_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    article_id INT NOT NULL,
    workflow_id INT NOT NULL,
    step_name VARCHAR(50) NOT NULL,
    auditor_id INT NOT NULL,
    action ENUM('approve', 'reject', 'request_change') NOT NULL,
    comments TEXT,
    audit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE,
    FOREIGN KEY (workflow_id) REFERENCES publish_workflows(id),
    FOREIGN KEY (auditor_id) REFERENCES users(id),
    INDEX idx_article_workflow (article_id, workflow_id)
) COMMENT='æ–‡ç« å®¡æ ¸è®°å½•è¡¨';
```

### 4.3 ç”¨æˆ·ç»„æƒé™ç®¡ç†


**ç”¨æˆ·ç»„**æ˜¯æ¯”è§’è‰²æ›´çµæ´»çš„æƒé™ç®¡ç†æ–¹å¼ï¼Œå¯ä»¥æŒ‰éƒ¨é—¨ã€é¡¹ç›®ç­‰ç»´åº¦ç»„ç»‡ç”¨æˆ·ï¼š

```sql
-- ç”¨æˆ·ç»„è¡¨
CREATE TABLE user_groups (
    id INT PRIMARY KEY AUTO_INCREMENT,
    group_name VARCHAR(100) NOT NULL,
    group_type ENUM('department', 'project', 'custom') NOT NULL,
    parent_group_id INT NULL COMMENT 'çˆ¶çº§ç”¨æˆ·ç»„IDï¼Œæ”¯æŒå±‚çº§ç»“æ„',
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_group_id) REFERENCES user_groups(id),
    INDEX idx_group_name (group_name),
    INDEX idx_parent_group (parent_group_id)
) COMMENT='ç”¨æˆ·ç»„è¡¨';

-- ç”¨æˆ·ç»„æˆå‘˜è¡¨
CREATE TABLE user_group_members (
    id INT PRIMARY KEY AUTO_INCREMENT,
    group_id INT NOT NULL,
    user_id INT NOT NULL,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_group_user (group_id, user_id)
) COMMENT='ç”¨æˆ·ç»„æˆå‘˜å…³è”è¡¨';

-- ç”¨æˆ·ç»„æƒé™è¡¨
CREATE TABLE group_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    group_id INT NOT NULL,
    permission_id INT NOT NULL,
    resource_scope JSON COMMENT 'æƒé™é€‚ç”¨çš„èµ„æºèŒƒå›´',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES user_groups(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE KEY uk_group_permission (group_id, permission_id)
) COMMENT='ç”¨æˆ·ç»„æƒé™è¡¨';
```

### 4.4 æƒé™ç»§æ‰¿æœºåˆ¶


**æƒé™ç»§æ‰¿**è®©æƒé™ç®¡ç†æ›´ç®€å•ï¼Œå­çº§è‡ªåŠ¨ç»§æ‰¿ä¸Šçº§çš„æƒé™ï¼š

```sql
-- æƒé™ç»§æ‰¿è§„åˆ™è¡¨
CREATE TABLE permission_inheritance (
    id INT PRIMARY KEY AUTO_INCREMENT,
    parent_type ENUM('role', 'group') NOT NULL,
    parent_id INT NOT NULL,
    child_type ENUM('role', 'group', 'user') NOT NULL,
    child_id INT NOT NULL,
    inheritance_type ENUM('full', 'partial', 'none') DEFAULT 'full',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_parent (parent_type, parent_id),
    INDEX idx_child (child_type, child_id)
) COMMENT='æƒé™ç»§æ‰¿å…³ç³»è¡¨';

-- è·å–ç”¨æˆ·å®Œæ•´æƒé™çš„è§†å›¾
CREATE VIEW user_full_permissions AS
SELECT DISTINCT 
    u.id as user_id,
    u.username,
    p.permission_code,
    p.permission_name,
    'direct_role' as permission_source
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN role_permissions rp ON ur.role_id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE (ur.expires_at IS NULL OR ur.expires_at > NOW())

UNION

SELECT DISTINCT
    u.id as user_id,
    u.username,
    p.permission_code,
    p.permission_name,
    'group_permission' as permission_source
FROM users u
JOIN user_group_members ugm ON u.id = ugm.user_id
JOIN group_permissions gp ON ugm.group_id = gp.group_id
JOIN permissions p ON gp.permission_id = p.id;
```

---

## 5. âš¡ åŠ¨æ€æƒé™åˆ†é…æœºåˆ¶


### 5.1 åŸºäºæ¡ä»¶çš„æƒé™åˆ†é…


**åŠ¨æ€æƒé™åˆ†é…**å°±æ˜¯æ ¹æ®å®æ—¶æ¡ä»¶è‡ªåŠ¨è°ƒæ•´ç”¨æˆ·æƒé™ï¼Œæ¯”å¦‚ï¼š
- å·¥ä½œæ—¶é—´å†…æ‰æœ‰æŸäº›æƒé™
- æ–‡ç« è¾¾åˆ°ä¸€å®šé˜…è¯»é‡åï¼Œä½œè€…è·å¾—é¢å¤–æƒé™
- æ ¹æ®ç”¨æˆ·è¡Œä¸ºè¡¨ç°åŠ¨æ€è°ƒæ•´æƒé™ç­‰çº§

```sql
-- åŠ¨æ€æƒé™è§„åˆ™è¡¨
CREATE TABLE dynamic_permission_rules (
    id INT PRIMARY KEY AUTO_INCREMENT,
    rule_name VARCHAR(100) NOT NULL,
    trigger_condition JSON NOT NULL COMMENT 'è§¦å‘æ¡ä»¶',
    action_type ENUM('grant', 'revoke', 'upgrade', 'downgrade') NOT NULL,
    target_permission JSON NOT NULL COMMENT 'ç›®æ ‡æƒé™é…ç½®',
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0 COMMENT 'è§„åˆ™ä¼˜å…ˆçº§',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_rule_name (rule_name),
    INDEX idx_active_priority (is_active, priority)
) COMMENT='åŠ¨æ€æƒé™è§„åˆ™è¡¨';

-- åŠ¨æ€æƒé™æ‰§è¡Œè®°å½•è¡¨
CREATE TABLE dynamic_permission_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    rule_id INT NOT NULL,
    user_id INT NOT NULL,
    action_taken VARCHAR(100) NOT NULL,
    condition_data JSON COMMENT 'è§¦å‘æ—¶çš„æ¡ä»¶æ•°æ®',
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (rule_id) REFERENCES dynamic_permission_rules(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_rule_user (rule_id, user_id),
    INDEX idx_executed_at (executed_at)
) COMMENT='åŠ¨æ€æƒé™æ‰§è¡Œè®°å½•è¡¨';
```

### 5.2 æƒé™è¡¨è¾¾å¼å¼•æ“


**æƒé™è¡¨è¾¾å¼**å°±æ˜¯ç”¨ç±»ä¼¼ç¼–ç¨‹è¯­è¨€çš„è¡¨è¾¾å¼æ¥å®šä¹‰å¤æ‚çš„æƒé™æ¡ä»¶ï¼š

```sql
-- æƒé™è¡¨è¾¾å¼è¡¨
CREATE TABLE permission_expressions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    expression_name VARCHAR(100) NOT NULL,
    expression_code TEXT NOT NULL COMMENT 'è¡¨è¾¾å¼ä»£ç ',
    expression_type ENUM('condition', 'filter', 'transform') NOT NULL,
    variables JSON COMMENT 'è¡¨è¾¾å¼å˜é‡å®šä¹‰',
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_expression_name (expression_name),
    INDEX idx_expression_type (expression_type)
) COMMENT='æƒé™è¡¨è¾¾å¼å®šä¹‰è¡¨';

-- ç¤ºä¾‹æƒé™è¡¨è¾¾å¼æ•°æ®
INSERT INTO permission_expressions (expression_name, expression_code, expression_type, variables, description) VALUES
('å·¥ä½œæ—¶é—´æƒé™', 
 'HOUR(NOW()) >= 9 AND HOUR(NOW()) <= 18 AND WEEKDAY(NOW()) < 5', 
 'condition',
 '{}',
 'å·¥ä½œæ—¥9ç‚¹åˆ°18ç‚¹æ‰èƒ½æ‰§è¡ŒæŸäº›æ“ä½œ'),
 
('é«˜è´¨é‡ä½œè€…æƒé™',
 'user.articles_count >= 10 AND user.avg_rating >= 4.0',
 'condition',
 '{"user.articles_count": "ç”¨æˆ·æ–‡ç« æ•°é‡", "user.avg_rating": "ç”¨æˆ·æ–‡ç« å¹³å‡è¯„åˆ†"}',
 'å‘è¡¨10ç¯‡ä»¥ä¸Šæ–‡ç« ä¸”å¹³å‡è¯„åˆ†4åˆ†ä»¥ä¸Šçš„ä½œè€…è·å¾—ç‰¹æ®Šæƒé™');
```

### 5.3 æƒé™å˜æ›´é€šçŸ¥æœºåˆ¶


å½“ç”¨æˆ·æƒé™å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦åŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜ï¼š

```sql
-- æƒé™å˜æ›´é€šçŸ¥è¡¨
CREATE TABLE permission_change_notifications (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    change_type ENUM('granted', 'revoked', 'modified', 'expired') NOT NULL,
    permission_info JSON NOT NULL COMMENT 'æƒé™å˜æ›´è¯¦æƒ…',
    changed_by INT NOT NULL COMMENT 'æ“ä½œäººID',
    change_reason TEXT COMMENT 'å˜æ›´åŸå› ',
    notification_status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (changed_by) REFERENCES users(id),
    INDEX idx_user_change (user_id, change_type),
    INDEX idx_notification_status (notification_status)
) COMMENT='æƒé™å˜æ›´é€šçŸ¥è¡¨';

-- æƒé™å˜æ›´è§¦å‘å™¨
DELIMITER $$

CREATE TRIGGER tr_user_roles_change
AFTER INSERT ON user_roles
FOR EACH ROW
BEGIN
    INSERT INTO permission_change_notifications (
        user_id, change_type, permission_info, changed_by, change_reason
    ) VALUES (
        NEW.user_id,
        'granted',
        JSON_OBJECT('role_id', NEW.role_id, 'role_name', 
            (SELECT role_name FROM roles WHERE id = NEW.role_id)),
        NEW.assigned_by,
        'è§’è‰²åˆ†é…'
    );
END$$

DELIMITER ;
```

---

## 6. ğŸš€ æƒé™ç¼“å­˜ä¼˜åŒ–ç­–ç•¥


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æƒé™ç¼“å­˜


æƒé™æ£€æŸ¥åœ¨ç³»ç»Ÿä¸­éå¸¸é¢‘ç¹ï¼Œæ¯ä¸ªé¡µé¢ã€æ¯ä¸ªæŒ‰é’®éƒ½å¯èƒ½éœ€è¦æ£€æŸ¥æƒé™ã€‚å¦‚æœæ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼Œä¼šå¯¼è‡´ï¼š
- **æ€§èƒ½é—®é¢˜**ï¼šå¤§é‡SQLæŸ¥è¯¢å½±å“å“åº”é€Ÿåº¦
- **æ•°æ®åº“å‹åŠ›**ï¼šæƒé™è¡¨è¢«é¢‘ç¹è®¿é—®
- **ç”¨æˆ·ä½“éªŒå·®**ï¼šé¡µé¢åŠ è½½ç¼“æ…¢

### 6.2 æƒé™ç¼“å­˜è¡¨è®¾è®¡


```sql
-- æƒé™ç¼“å­˜è¡¨
CREATE TABLE permission_cache (
    id INT PRIMARY KEY AUTO_INCREMENT,
    cache_key VARCHAR(255) NOT NULL COMMENT 'ç¼“å­˜é”®ï¼Œæ ¼å¼ï¼šuser_id:permission_code:resource_id',
    user_id INT NOT NULL,
    permission_result BOOLEAN NOT NULL COMMENT 'æƒé™æ£€æŸ¥ç»“æœ',
    cache_data JSON COMMENT 'ç¼“å­˜çš„æƒé™ç›¸å…³æ•°æ®',
    cache_version INT DEFAULT 1 COMMENT 'ç¼“å­˜ç‰ˆæœ¬ï¼Œç”¨äºå¤±æ•ˆæ§åˆ¶',
    expires_at TIMESTAMP NOT NULL COMMENT 'ç¼“å­˜è¿‡æœŸæ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_cache_key (cache_key),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at)
) COMMENT='æƒé™æ£€æŸ¥ç»“æœç¼“å­˜è¡¨';

-- æƒé™ç¼“å­˜å¤±æ•ˆè®°å½•è¡¨
CREATE TABLE permission_cache_invalidation (
    id INT PRIMARY KEY AUTO_INCREMENT,
    invalidation_type ENUM('user', 'role', 'permission', 'global') NOT NULL,
    target_id INT COMMENT 'ç›®æ ‡IDï¼šç”¨æˆ·IDã€è§’è‰²IDæˆ–æƒé™ID',
    reason VARCHAR(200) COMMENT 'å¤±æ•ˆåŸå› ',
    invalidated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_type_target (invalidation_type, target_id),
    INDEX idx_invalidated_at (invalidated_at)
) COMMENT='æƒé™ç¼“å­˜å¤±æ•ˆè®°å½•è¡¨';
```

### 6.3 æƒé™ç¼“å­˜ç®¡ç†å‡½æ•°


```sql
-- æƒé™ç¼“å­˜æŸ¥è¯¢å‡½æ•°
DELIMITER $$

CREATE FUNCTION get_cached_permission(
    p_user_id INT,
    p_permission_code VARCHAR(100),
    p_resource_id INT DEFAULT NULL
) RETURNS BOOLEAN
READS SQL DATA
BEGIN
    DECLARE v_cache_key VARCHAR(255);
    DECLARE v_result BOOLEAN DEFAULT FALSE;
    DECLARE v_cache_count INT DEFAULT 0;
    
    -- æ„é€ ç¼“å­˜é”®
    SET v_cache_key = CONCAT(p_user_id, ':', p_permission_code, ':', IFNULL(p_resource_id, 'null'));
    
    -- æŸ¥è¯¢ç¼“å­˜
    SELECT permission_result, 1 INTO v_result, v_cache_count
    FROM permission_cache
    WHERE cache_key = v_cache_key
    AND expires_at > NOW()
    LIMIT 1;
    
    -- å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œè¿›è¡Œå®é™…æƒé™æ£€æŸ¥å¹¶ç¼“å­˜ç»“æœ
    IF v_cache_count = 0 THEN
        SET v_result = check_user_permission(p_user_id, p_permission_code, p_resource_id);
        
        -- æ’å…¥ç¼“å­˜
        INSERT INTO permission_cache (
            cache_key, user_id, permission_result, expires_at
        ) VALUES (
            v_cache_key, p_user_id, v_result, DATE_ADD(NOW(), INTERVAL 1 HOUR)
        ) ON DUPLICATE KEY UPDATE
            permission_result = v_result,
            expires_at = DATE_ADD(NOW(), INTERVAL 1 HOUR),
            updated_at = NOW();
    END IF;
    
    RETURN v_result;
END$$

DELIMITER ;
```

### 6.4 ç¼“å­˜è‡ªåŠ¨æ¸…ç†æœºåˆ¶


```sql
-- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜çš„äº‹ä»¶
CREATE EVENT ev_clean_expired_permission_cache
ON SCHEDULE EVERY 1 HOUR
DO
  DELETE FROM permission_cache WHERE expires_at < NOW();

-- æƒé™å˜æ›´æ—¶è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜çš„è§¦å‘å™¨
DELIMITER $$

CREATE TRIGGER tr_invalidate_user_permission_cache
AFTER DELETE ON user_roles
FOR EACH ROW
BEGIN
    -- åˆ é™¤ç”¨æˆ·ç›¸å…³çš„æƒé™ç¼“å­˜
    DELETE FROM permission_cache WHERE user_id = OLD.user_id;
    
    -- è®°å½•ç¼“å­˜å¤±æ•ˆæ—¥å¿—
    INSERT INTO permission_cache_invalidation (
        invalidation_type, target_id, reason
    ) VALUES (
        'user', OLD.user_id, 'ç”¨æˆ·è§’è‰²è¢«åˆ é™¤'
    );
END$$

DELIMITER ;
```

---

## 7. ğŸ“Š æƒé™å®¡è®¡ä¸è¿½è¸ª


### 7.1 æƒé™å®¡è®¡çš„é‡è¦æ€§


**æƒé™å®¡è®¡**å°±æ˜¯è®°å½•å’Œè¿½è¸ªæƒé™ç›¸å…³çš„æ‰€æœ‰æ“ä½œï¼Œä¸»è¦ç”¨äºï¼š
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚
- **å®‰å…¨ç›‘æ§**ï¼šå‘ç°å¼‚å¸¸çš„æƒé™ä½¿ç”¨
- **é—®é¢˜æ’æŸ¥**ï¼šå®šä½æƒé™ç›¸å…³çš„é—®é¢˜
- **è´£ä»»è¿½æº¯**ï¼šæ˜ç¡®æ“ä½œè´£ä»»äºº

### 7.2 æƒé™æ“ä½œå®¡è®¡è¡¨è®¾è®¡


```sql
-- æƒé™æ“ä½œå®¡è®¡è¡¨
CREATE TABLE permission_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    operation_type ENUM('check', 'grant', 'revoke', 'modify') NOT NULL,
    operator_id INT NOT NULL COMMENT 'æ“ä½œäººID',
    target_user_id INT COMMENT 'ç›®æ ‡ç”¨æˆ·ID',
    target_role_id INT COMMENT 'ç›®æ ‡è§’è‰²ID',
    permission_code VARCHAR(100) COMMENT 'æƒé™ä»£ç ',
    resource_type VARCHAR(50) COMMENT 'èµ„æºç±»å‹',
    resource_id INT COMMENT 'èµ„æºID',
    operation_result ENUM('success', 'denied', 'error') NOT NULL,
    ip_address VARCHAR(45) COMMENT 'æ“ä½œIPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†ä¿¡æ¯',
    operation_context JSON COMMENT 'æ“ä½œä¸Šä¸‹æ–‡ä¿¡æ¯',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰',
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (operator_id) REFERENCES users(id),
    FOREIGN KEY (target_user_id) REFERENCES users(id),
    FOREIGN KEY (target_role_id) REFERENCES roles(id),
    INDEX idx_operator_time (operator_id, operation_time),
    INDEX idx_target_user_time (target_user_id, operation_time),
    INDEX idx_permission_time (permission_code, operation_time),
    INDEX idx_operation_type_time (operation_type, operation_time)
) COMMENT='æƒé™æ“ä½œå®¡è®¡æ—¥å¿—è¡¨';

-- æ•æ„Ÿæƒé™æ“ä½œè¡¨
CREATE TABLE sensitive_permission_operations (
    id INT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) NOT NULL,
    sensitivity_level ENUM('low', 'medium', 'high', 'critical') DEFAULT 'medium',
    requires_approval BOOLEAN DEFAULT FALSE,
    alert_threshold INT DEFAULT 10 COMMENT 'å¼‚å¸¸é˜ˆå€¼ï¼šå•ä½æ—¶é—´å†…æ“ä½œæ¬¡æ•°',
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_permission_code (permission_code)
) COMMENT='æ•æ„Ÿæƒé™æ“ä½œé…ç½®è¡¨';
```

### 7.3 æƒé™ä½¿ç”¨ç»Ÿè®¡è§†å›¾


```sql
-- æƒé™ä½¿ç”¨ç»Ÿè®¡è§†å›¾
CREATE VIEW permission_usage_stats AS
SELECT 
    p.permission_code,
    p.permission_name,
    COUNT(pal.id) as total_checks,
    COUNT(CASE WHEN pal.operation_result = 'success' THEN 1 END) as successful_checks,
    COUNT(CASE WHEN pal.operation_result = 'denied' THEN 1 END) as denied_checks,
    COUNT(DISTINCT pal.operator_id) as unique_users,
    MAX(pal.operation_time) as last_used_time,
    AVG(CASE WHEN pal.operation_result = 'success' THEN 1 ELSE 0 END) * 100 as success_rate
FROM permissions p
LEFT JOIN permission_audit_logs pal ON p.permission_code = pal.permission_code
WHERE pal.operation_type = 'check'
GROUP BY p.id, p.permission_code, p.permission_name;

-- ç”¨æˆ·æƒé™ä½¿ç”¨ç»Ÿè®¡è§†å›¾
CREATE VIEW user_permission_usage AS
SELECT 
    u.id as user_id,
    u.username,
    COUNT(pal.id) as total_operations,
    COUNT(CASE WHEN pal.operation_result = 'denied' THEN 1 END) as denied_operations,
    COUNT(DISTINCT pal.permission_code) as unique_permissions_used,
    MAX(pal.operation_time) as last_operation_time
FROM users u
LEFT JOIN permission_audit_logs pal ON u.id = pal.operator_id
GROUP BY u.id, u.username;
```

### 7.4 å¼‚å¸¸æƒé™è¡Œä¸ºæ£€æµ‹


```sql
-- å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å‡½æ•°
DELIMITER $$

CREATE PROCEDURE detect_abnormal_permission_behavior()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_user_id INT;
    DECLARE v_denied_count INT;
    DECLARE v_threshold INT DEFAULT 10;
    
    -- æ¸¸æ ‡ï¼šæŸ¥æ‰¾æœ€è¿‘1å°æ—¶å†…æƒé™è¢«æ‹’ç»æ¬¡æ•°è¿‡å¤šçš„ç”¨æˆ·
    DECLARE user_cursor CURSOR FOR
        SELECT operator_id, COUNT(*) as denied_count
        FROM permission_audit_logs
        WHERE operation_result = 'denied'
        AND operation_time > DATE_SUB(NOW(), INTERVAL 1 HOUR)
        GROUP BY operator_id
        HAVING denied_count > v_threshold;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- ä¸´æ—¶è¡¨å­˜å‚¨å¼‚å¸¸ç”¨æˆ·
    CREATE TEMPORARY TABLE IF NOT EXISTS temp_abnormal_users (
        user_id INT,
        denied_count INT,
        detected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    OPEN user_cursor;
    
    read_loop: LOOP
        FETCH user_cursor INTO v_user_id, v_denied_count;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- æ’å…¥å¼‚å¸¸ç”¨æˆ·è®°å½•
        INSERT INTO temp_abnormal_users (user_id, denied_count) 
        VALUES (v_user_id, v_denied_count);
        
    END LOOP;
    
    CLOSE user_cursor;
    
    -- è¿”å›å¼‚å¸¸ç”¨æˆ·åˆ—è¡¨
    SELECT 
        tau.user_id,
        u.username,
        tau.denied_count,
        tau.detected_at
    FROM temp_abnormal_users tau
    JOIN users u ON tau.user_id = u.id;
    
    DROP TEMPORARY TABLE temp_abnormal_users;
END$$

DELIMITER ;
```

---

## 8. ğŸ¢ å¤šç§Ÿæˆ·æƒé™éš”ç¦»


### 8.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·æƒé™éš”ç¦»


**å¤šç§Ÿæˆ·ç³»ç»Ÿ**å°±æ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡å¤šä¸ªå®¢æˆ·ï¼ˆç§Ÿæˆ·ï¼‰ï¼Œæ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å’Œæƒé™å¿…é¡»ä¸¥æ ¼éš”ç¦»ï¼Œå°±åƒå…¬å¯“æ¥¼é‡Œæ¯æˆ·éƒ½æœ‰è‡ªå·±çš„æˆ¿é—´å’Œé’¥åŒ™ã€‚

### 8.2 ç§Ÿæˆ·éš”ç¦»è¡¨è®¾è®¡


```sql
-- ç§Ÿæˆ·è¡¨
CREATE TABLE tenants (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tenant_code VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç§Ÿæˆ·ç¼–ç ',
    tenant_name VARCHAR(100) NOT NULL COMMENT 'ç§Ÿæˆ·åç§°',
    tenant_type ENUM('enterprise', 'individual', 'trial') DEFAULT 'enterprise',
    status ENUM('active', 'suspended', 'expired') DEFAULT 'active',
    max_users INT DEFAULT 100 COMMENT 'æœ€å¤§ç”¨æˆ·æ•°é™åˆ¶',
    max_storage_gb INT DEFAULT 10 COMMENT 'æœ€å¤§å­˜å‚¨ç©ºé—´GB',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL COMMENT 'åˆ°æœŸæ—¶é—´',
    INDEX idx_tenant_code (tenant_code),
    INDEX idx_status (status)
) COMMENT='ç§Ÿæˆ·ä¿¡æ¯è¡¨';

-- ä¿®æ”¹ç”¨æˆ·è¡¨ï¼Œå¢åŠ ç§Ÿæˆ·ID
ALTER TABLE users ADD COLUMN tenant_id INT NOT NULL AFTER id;
ALTER TABLE users ADD FOREIGN KEY (tenant_id) REFERENCES tenants(id);
ALTER TABLE users ADD INDEX idx_tenant_user (tenant_id, id);

-- ç§Ÿæˆ·æƒé™æ¨¡æ¿è¡¨
CREATE TABLE tenant_permission_templates (
    id INT PRIMARY KEY AUTO_INCREMENT,
    template_name VARCHAR(100) NOT NULL,
    tenant_type ENUM('enterprise', 'individual', 'trial') NOT NULL,
    permissions JSON NOT NULL COMMENT 'æƒé™é…ç½®',
    description TEXT,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_template_type (template_name, tenant_type)
) COMMENT='ç§Ÿæˆ·æƒé™æ¨¡æ¿è¡¨';
```

### 8.3 ç§Ÿæˆ·æ•°æ®éš”ç¦»å®ç°


```sql
-- ç§Ÿæˆ·èµ„æºéš”ç¦»è¡¨
CREATE TABLE tenant_resource_isolation (
    id INT PRIMARY KEY AUTO_INCREMENT,
    tenant_id INT NOT NULL,
    resource_type VARCHAR(50) NOT NULL COMMENT 'èµ„æºç±»å‹ï¼šdatabase,table,directory',
    resource_identifier VARCHAR(200) NOT NULL COMMENT 'èµ„æºæ ‡è¯†ç¬¦',
    isolation_config JSON COMMENT 'éš”ç¦»é…ç½®',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (tenant_id) REFERENCES tenants(id) ON DELETE CASCADE,
    UNIQUE KEY uk_tenant_resource (tenant_id, resource_type, resource_identifier)
) COMMENT='ç§Ÿæˆ·èµ„æºéš”ç¦»é…ç½®è¡¨';

-- ä¿®æ”¹æ–‡ç« è¡¨ï¼Œå¢åŠ ç§Ÿæˆ·éš”ç¦»
ALTER TABLE articles ADD COLUMN tenant_id INT NOT NULL AFTER id;
ALTER TABLE articles ADD FOREIGN KEY (tenant_id) REFERENCES tenants(id);
ALTER TABLE articles ADD INDEX idx_tenant_article (tenant_id, id);

-- ç§Ÿæˆ·éš”ç¦»æŸ¥è¯¢å‡½æ•°
DELIMITER $$

CREATE FUNCTION check_tenant_permission(
    p_user_id INT,
    p_resource_type VARCHAR(50),
    p_resource_id INT
) RETURNS BOOLEAN
READS SQL DATA
BEGIN
    DECLARE v_user_tenant_id INT;
    DECLARE v_resource_tenant_id INT;
    DECLARE v_has_permission BOOLEAN DEFAULT FALSE;
    
    -- è·å–ç”¨æˆ·çš„ç§Ÿæˆ·ID
    SELECT tenant_id INTO v_user_tenant_id FROM users WHERE id = p_user_id;
    
    -- æ ¹æ®èµ„æºç±»å‹è·å–èµ„æºçš„ç§Ÿæˆ·ID
    CASE p_resource_type
        WHEN 'article' THEN
            SELECT tenant_id INTO v_resource_tenant_id FROM articles WHERE id = p_resource_id;
        -- å¯ä»¥æ·»åŠ æ›´å¤šèµ„æºç±»å‹çš„å¤„ç†
    END CASE;
    
    -- æ£€æŸ¥ç§Ÿæˆ·æ˜¯å¦åŒ¹é…
    IF v_user_tenant_id = v_resource_tenant_id THEN
        SET v_has_permission = TRUE;
    END IF;
    
    RETURN v_has_permission;
END$$

DELIMITER ;
```

### 8.4 è·¨ç§Ÿæˆ·æƒé™ç®¡ç†


æœ‰æ—¶å€™éœ€è¦æŸäº›ç‰¹æ®Šç”¨æˆ·èƒ½å¤Ÿè·¨ç§Ÿæˆ·æ“ä½œï¼Œæ¯”å¦‚ç³»ç»Ÿç®¡ç†å‘˜ï¼š

```sql
-- è·¨ç§Ÿæˆ·æƒé™è¡¨
CREATE TABLE cross_tenant_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    source_tenant_id INT NOT NULL COMMENT 'ç”¨æˆ·æ‰€å±ç§Ÿæˆ·',
    target_tenant_id INT NOT NULL COMMENT 'ç›®æ ‡ç§Ÿæˆ·',
    permission_scope JSON NOT NULL COMMENT 'è·¨ç§Ÿæˆ·æƒé™èŒƒå›´',
    granted_by INT NOT NULL COMMENT 'æˆæƒäºº',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL COMMENT 'æƒé™åˆ°æœŸæ—¶é—´',
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (source_tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (target_tenant_id) REFERENCES tenants(id),
    FOREIGN KEY (granted_by) REFERENCES users(id),
    INDEX idx_user_tenant (user_id, target_tenant_id)
) COMMENT='è·¨ç§Ÿæˆ·æƒé™è¡¨';

-- ç³»ç»Ÿçº§è¶…çº§æƒé™è¡¨
CREATE TABLE system_super_permissions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    permission_level ENUM('read_all', 'write_all', 'admin_all') NOT NULL,
    granted_by INT NOT NULL,
    reason TEXT COMMENT 'æˆæƒåŸå› ',
    granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (granted_by) REFERENCES users(id),
    UNIQUE KEY uk_user_level (user_id, permission_level)
) COMMENT='ç³»ç»Ÿçº§è¶…çº§æƒé™è¡¨';
```

---

## 9. âš¡ æƒé™æ€§èƒ½ä¼˜åŒ–


### 9.1 æƒé™æŸ¥è¯¢æ€§èƒ½åˆ†æ


æƒé™ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆé€šå¸¸åœ¨äºï¼š
- **å¤šè¡¨å…³è”æŸ¥è¯¢**ï¼šç”¨æˆ·â†’è§’è‰²â†’æƒé™çš„å¤šå±‚æŸ¥è¯¢
- **é¢‘ç¹æƒé™æ£€æŸ¥**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½è¦æ£€æŸ¥æƒé™
- **å¤æ‚æƒé™é€»è¾‘**ï¼šæ¡ä»¶æƒé™ã€ç»§æ‰¿æƒé™çš„è®¡ç®—

### 9.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


```sql
-- ä¼˜åŒ–æƒé™æŸ¥è¯¢çš„å¤åˆç´¢å¼•
ALTER TABLE user_roles ADD INDEX idx_user_role_expires (user_id, role_id, expires_at);
ALTER TABLE role_permissions ADD INDEX idx_role_permission (role_id, permission_id);
ALTER TABLE permissions ADD INDEX idx_resource_action_code (resource_type, action_type, permission_code);

-- æƒé™å®¡è®¡æ—¥å¿—çš„åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
ALTER TABLE permission_audit_logs 
PARTITION BY RANGE (YEAR(operation_time) * 100 + MONTH(operation_time)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504),
    PARTITION p202504 VALUES LESS THAN (202505),
    PARTITION p202505 VALUES LESS THAN (202506),
    PARTITION p202506 VALUES LESS THAN (202507),
    PARTITION pfuture VALUES LESS THAN MAXVALUE
);
```

### 9.3 æƒé™é¢„è®¡ç®—ä¼˜åŒ–


```sql
-- ç”¨æˆ·æƒé™é¢„è®¡ç®—è¡¨
CREATE TABLE user_permission_cache_v2 (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    tenant_id INT NOT NULL,
    permissions_bitmap VARBINARY(1000) COMMENT 'æƒé™ä½å›¾ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºæ‹¥æœ‰çš„æƒé™',
    permissions_hash VARCHAR(32) COMMENT 'æƒé™ç»„åˆçš„MD5å“ˆå¸Œ',
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    version INT DEFAULT 1,
    UNIQUE KEY uk_user_tenant (user_id, tenant_id),
    INDEX idx_tenant_hash (tenant_id, permissions_hash)
) COMMENT='ç”¨æˆ·æƒé™é¢„è®¡ç®—ç¼“å­˜è¡¨';

-- æƒé™ä½å›¾ç®¡ç†
CREATE TABLE permission_bitmap_mapping (
    permission_id INT PRIMARY KEY,
    bit_position INT NOT NULL COMMENT 'åœ¨ä½å›¾ä¸­çš„ä½ç½®',
    permission_code VARCHAR(100) NOT NULL,
    FOREIGN KEY (permission_id) REFERENCES permissions(id),
    UNIQUE KEY uk_bit_position (bit_position)
) COMMENT='æƒé™ä½å›¾ä½ç½®æ˜ å°„è¡¨';
```

### 9.4 æ‰¹é‡æƒé™æ£€æŸ¥ä¼˜åŒ–


```sql
-- æ‰¹é‡æƒé™æ£€æŸ¥å‡½æ•°
DELIMITER $$

CREATE FUNCTION batch_check_permissions(
    p_user_id INT,
    p_permission_codes JSON
) RETURNS JSON
READS SQL DATA
BEGIN
    DECLARE v_result JSON DEFAULT JSON_OBJECT();
    DECLARE v_code VARCHAR(100);
    DECLARE v_has_permission BOOLEAN;
    DECLARE i INT DEFAULT 0;
    DECLARE codes_length INT;
    
    SET codes_length = JSON_LENGTH(p_permission_codes);
    
    WHILE i < codes_length DO
        SET v_code = JSON_UNQUOTE(JSON_EXTRACT(p_permission_codes, CONCAT('$[', i, ']')));
        SET v_has_permission = get_cached_permission(p_user_id, v_code);
        SET v_result = JSON_SET(v_result, CONCAT('$.', v_code), v_has_permission);
        SET i = i + 1;
    END WHILE;
    
    RETURN v_result;
END$$

DELIMITER ;
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 æƒé™ä½“ç³»è®¾è®¡æ ¸å¿ƒåŸåˆ™


```
ğŸ”¸ RBACæ¨¡å‹ï¼šç”¨æˆ·â†’è§’è‰²â†’æƒé™çš„ä¸‰å±‚ç»“æ„
ğŸ”¸ æƒé™ç²’åº¦ï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦é€‰æ‹©åˆé€‚çš„æ§åˆ¶ç²¾åº¦
ğŸ”¸ åŠ¨æ€åˆ†é…ï¼šæ”¯æŒåŸºäºæ¡ä»¶çš„æƒé™è‡ªåŠ¨è°ƒæ•´
ğŸ”¸ ç¼“å­˜ä¼˜åŒ–ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡å“åº”é€Ÿåº¦
ğŸ”¸ å®¡è®¡è¿½è¸ªï¼šå®Œæ•´è®°å½•æƒé™æ“ä½œï¼Œç¡®ä¿åˆè§„æ€§
ğŸ”¸ ç§Ÿæˆ·éš”ç¦»ï¼šå¤šç§Ÿæˆ·ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨éš”ç¦»
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡ç´¢å¼•ã€é¢„è®¡ç®—ç­‰æ‰‹æ®µæå‡æ€§èƒ½
```

### 10.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ è¡¨ç»“æ„è®¾è®¡**
```
æ ¸å¿ƒè¡¨ï¼šusersã€rolesã€permissionsã€user_rolesã€role_permissions
æ‰©å±•è¡¨ï¼šæ¡ä»¶æƒé™ã€å­—æ®µæƒé™ã€ç”¨æˆ·ç»„ã€æƒé™ç¼“å­˜
å®¡è®¡è¡¨ï¼šæ“ä½œæ—¥å¿—ã€å˜æ›´é€šçŸ¥ã€å¼‚å¸¸æ£€æµ‹
```

**ğŸ”¹ æƒé™æ£€æŸ¥æµç¨‹**
```
1. è·å–ç”¨æˆ·åŸºç¡€è§’è‰²æƒé™
2. æ£€æŸ¥æ¡ä»¶æƒé™æ˜¯å¦æ»¡è¶³
3. éªŒè¯èµ„æºçº§åˆ«æƒé™
4. ç¼“å­˜æ£€æŸ¥ç»“æœ
5. è®°å½•å®¡è®¡æ—¥å¿—
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ç´¢å¼•ä¼˜åŒ–ï¼šå¤šè¡¨å…³è”æŸ¥è¯¢çš„å¤åˆç´¢å¼•
ç¼“å­˜æœºåˆ¶ï¼šçƒ­ç‚¹æƒé™çš„å†…å­˜ç¼“å­˜
æ‰¹é‡å¤„ç†ï¼šä¸€æ¬¡æ£€æŸ¥å¤šä¸ªæƒé™
é¢„è®¡ç®—ï¼šç”¨æˆ·æƒé™çš„é¢„å…ˆè®¡ç®—
åˆ†åŒºè¡¨ï¼šå¤§è¡¨çš„åˆ†åŒºå­˜å‚¨
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**æƒé™è®¾è®¡åŸåˆ™**ï¼š
- æœ€å°æƒé™åŸåˆ™ï¼šç”¨æˆ·åªè·å¾—å¿…éœ€çš„æƒé™
- èŒè´£åˆ†ç¦»ï¼šä¸åŒèŒèƒ½ä½¿ç”¨ä¸åŒè§’è‰²
- å®šæœŸå®¡æŸ¥ï¼šå®šæœŸæ¸…ç†æ— ç”¨æƒé™
- æƒé™ç»§æ‰¿ï¼šåˆç†ä½¿ç”¨ç»§æ‰¿å‡å°‘ç®¡ç†å¤æ‚åº¦

**å®‰å…¨è€ƒè™‘**ï¼š
- æ•æ„Ÿæƒé™åŒé‡ç¡®è®¤
- æƒé™å˜æ›´å®¡æ‰¹æµç¨‹
- å¼‚å¸¸è¡Œä¸ºå®æ—¶ç›‘æ§
- æƒé™è¿‡æœŸè‡ªåŠ¨å›æ”¶

**æ€§èƒ½è€ƒè™‘**ï¼š
- æƒé™æ£€æŸ¥ç»“æœç¼“å­˜
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- æ‰¹é‡æƒé™æ“ä½œ
- å¼‚æ­¥æƒé™è®¡ç®—

**æ ¸å¿ƒè®°å¿†**ï¼š
- RBACæ˜¯æƒé™ç®¡ç†çš„åŸºç¡€æ¨¡å‹
- ç¼“å­˜å’Œç´¢å¼•æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®
- å®¡è®¡æ—¥å¿—æ˜¯åˆè§„æ€§çš„é‡è¦ä¿éšœ
- çµæ´»æ€§å’Œå®‰å…¨æ€§éœ€è¦å¹³è¡¡è€ƒè™‘