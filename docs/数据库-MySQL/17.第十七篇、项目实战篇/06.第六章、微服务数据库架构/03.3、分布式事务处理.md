---
title: 3ã€åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ)
2. [2PCä¸¤é˜¶æ®µæäº¤åè®®](#2-2PCä¸¤é˜¶æ®µæäº¤åè®®)
3. [TCCäº‹åŠ¡è¡¥å¿æ¨¡å¼](#3-TCCäº‹åŠ¡è¡¥å¿æ¨¡å¼)
4. [Sagaé•¿äº‹åŠ¡å¤„ç†](#4-Sagaé•¿äº‹åŠ¡å¤„ç†)
5. [æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ](#5-æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ)
6. [äº‹åŠ¡æ¶ˆæ¯æ¨¡å¼](#6-äº‹åŠ¡æ¶ˆæ¯æ¨¡å¼)
7. [Seataåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ](#7-Seataåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ)
8. [åˆ†å¸ƒå¼é”ä¸äº‹åŠ¡åè°ƒ](#8-åˆ†å¸ƒå¼é”ä¸äº‹åŠ¡åè°ƒ)
9. [äº‹åŠ¡ç›‘æ§ä¸æ€§èƒ½ä¼˜åŒ–](#9-äº‹åŠ¡ç›‘æ§ä¸æ€§èƒ½ä¼˜åŒ–)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”ç†è§£**
```
æƒ³è±¡ä½ è¦ç½‘è´­ä¸€éƒ¨æ‰‹æœºï¼š
1. ä»ä½ çš„é“¶è¡Œè´¦æˆ·æ‰£é’±
2. å•†å®¶åº“å­˜å‡å°‘ä¸€å°æ‰‹æœº
3. ç‰©æµç³»ç»Ÿç”Ÿæˆé…é€å•

è¿™ä¸‰ä¸ªæ“ä½œåœ¨ä¸åŒçš„ç³»ç»Ÿä¸­ï¼Œä½†å¿…é¡»åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥
è¿™å°±æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ¬è´¨
```

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
åˆ†å¸ƒå¼äº‹åŠ¡ï¼šè·¨è¶Šå¤šä¸ªæ•°æ®åº“ã€å¤šä¸ªæœåŠ¡çš„äº‹åŠ¡æ“ä½œ
ç›®æ ‡ï¼šä¿è¯å¤šä¸ªç‹¬ç«‹ç³»ç»Ÿä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
æŒ‘æˆ˜ï¼šç½‘ç»œå»¶è¿Ÿã€ç³»ç»Ÿæ•…éšœã€æ•°æ®ä¸€è‡´æ€§
```

### 1.2 ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒçš„æŒ‘æˆ˜


**ğŸ¯ ä¼ ç»ŸACID vs åˆ†å¸ƒå¼æŒ‘æˆ˜**

| ç‰¹æ€§ | **å•æœºç¯å¢ƒ** | **åˆ†å¸ƒå¼æŒ‘æˆ˜** | **è§£å†³æ€è·¯** |
|------|-------------|---------------|-------------|
| **åŸå­æ€§(A)** | `äº‹åŠ¡å†…æ“ä½œå…¨æˆåŠŸæˆ–å…¨å¤±è´¥` | `è·¨ç³»ç»Ÿæ“ä½œéš¾ä»¥ç»Ÿä¸€æ§åˆ¶` | `ä¸¤é˜¶æ®µæäº¤ã€è¡¥å¿æœºåˆ¶` |
| **ä¸€è‡´æ€§(C)** | `æ•°æ®å®Œæ•´æ€§çº¦æŸ` | `è·¨åº“æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å›°éš¾` | `æœ€ç»ˆä¸€è‡´æ€§ã€æ•°æ®æ ¡éªŒ` |
| **éš”ç¦»æ€§(I)** | `å¹¶å‘äº‹åŠ¡ä¸ç›¸äº’å¹²æ‰°` | `è·¨ç³»ç»Ÿé”ç®¡ç†å¤æ‚` | `åˆ†å¸ƒå¼é”ã€æ—¶é—´æˆ³æ’åº` |
| **æŒä¹…æ€§(D)** | `æäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜` | `éƒ¨åˆ†ç³»ç»Ÿæ•…éšœæ•°æ®ä¸¢å¤±` | `å¤šå‰¯æœ¬ã€æ—¥å¿—åŒæ­¥` |

### 1.3 åˆ†å¸ƒå¼äº‹åŠ¡çš„åº”ç”¨åœºæ™¯


**ğŸ¢ å…¸å‹ä¸šåŠ¡åœºæ™¯**
```
ç”µå•†ä¸‹å•æµç¨‹ï¼š
è®¢å•ç³»ç»Ÿ â†’ åˆ›å»ºè®¢å•è®°å½•
åº“å­˜ç³»ç»Ÿ â†’ æ‰£å‡å•†å“åº“å­˜  
æ”¯ä»˜ç³»ç»Ÿ â†’ æ‰£é™¤ç”¨æˆ·ä½™é¢
ç§¯åˆ†ç³»ç»Ÿ â†’ å¢åŠ ç”¨æˆ·ç§¯åˆ†
ç‰©æµç³»ç»Ÿ â†’ ç”Ÿæˆé…é€ä»»åŠ¡

é“¶è¡Œè½¬è´¦ä¸šåŠ¡ï¼š
è´¦æˆ·A â†’ æ‰£é™¤è½¬è´¦é‡‘é¢
è´¦æˆ·B â†’ å¢åŠ è½¬è´¦é‡‘é¢
æµæ°´ç³»ç»Ÿ â†’ è®°å½•è½¬è´¦æ—¥å¿—
é£æ§ç³»ç»Ÿ â†’ æ›´æ–°é£é™©è¯„åˆ†
```

---

## 2. ğŸ”„ 2PCä¸¤é˜¶æ®µæäº¤åè®®


### 2.1 2PCå·¥ä½œåŸç†


**ğŸ“‹ æ ¸å¿ƒæ€æƒ³**
```
å°±åƒå›¢é˜Ÿå†³ç­–ï¼š
é˜¶æ®µ1ï¼šåè°ƒè€…é—®æ‰€æœ‰äºº"èƒ½å¦æ‰§è¡Œï¼Ÿ"
é˜¶æ®µ2ï¼šå¦‚æœéƒ½è¯´"å¯ä»¥"ï¼Œåè°ƒè€…è¯´"å¼€å§‹æ‰§è¡Œ"
       å¦‚æœæœ‰äººè¯´"ä¸è¡Œ"ï¼Œåè°ƒè€…è¯´"å…¨éƒ¨å–æ¶ˆ"
```

**ğŸ”§ æ‰§è¡Œæµç¨‹å›¾ç¤º**
```
åè°ƒè€…(Transaction Manager)
    |
    |-- [å‡†å¤‡é˜¶æ®µ] --------> å‚ä¸è€…1 (DB1)
    |                         |
    |-- [å‡†å¤‡é˜¶æ®µ] --------> å‚ä¸è€…2 (DB2)  
    |                         |
    |-- [å‡†å¤‡é˜¶æ®µ] --------> å‚ä¸è€…3 (DB3)
    |                         |
    |<-- [æŠ•ç¥¨ç»“æœ] ----------|
    |
    |-- [æäº¤/å›æ»š] -------> æ‰€æœ‰å‚ä¸è€…
```

### 2.2 MySQL XAäº‹åŠ¡å®ç°


**ğŸ’» XAäº‹åŠ¡åŸºæœ¬è¯­æ³•**
```sql
-- å¯åŠ¨XAäº‹åŠ¡
XA START 'transaction_id';

-- æ‰§è¡Œä¸šåŠ¡SQL
UPDATE account SET balance = balance - 100 WHERE id = 1;

-- ç»“æŸäº‹åŠ¡å‡†å¤‡
XA END 'transaction_id';

-- å‡†å¤‡æäº¤(ç¬¬ä¸€é˜¶æ®µ)
XA PREPARE 'transaction_id';

-- æ­£å¼æäº¤(ç¬¬äºŒé˜¶æ®µ)
XA COMMIT 'transaction_id';

-- æˆ–è€…å›æ»š
XA ROLLBACK 'transaction_id';
```

**ğŸ”¨ Javaä¸­çš„XAäº‹åŠ¡å®ç°**
```java
@Service
public class TransferService {
    
    @Resource
    private DataSource dataSource1; // è´¦æˆ·Aæ•°æ®æº
    @Resource  
    private DataSource dataSource2; // è´¦æˆ·Bæ•°æ®æº
    
    public void transfer(Long fromAccount, Long toAccount, BigDecimal amount) {
        String xid1 = "xa_" + System.currentTimeMillis() + "_1";
        String xid2 = "xa_" + System.currentTimeMillis() + "_2";
        
        Connection conn1 = null;
        Connection conn2 = null;
        
        try {
            // è·å–è¿æ¥
            conn1 = dataSource1.getConnection();
            conn2 = dataSource2.getConnection();
            
            // å¼€å¯XAäº‹åŠ¡
            conn1.prepareStatement("XA START '" + xid1 + "'").execute();
            conn2.prepareStatement("XA START '" + xid2 + "'").execute();
            
            // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            PreparedStatement ps1 = conn1.prepareStatement(
                "UPDATE account SET balance = balance - ? WHERE id = ?");
            ps1.setBigDecimal(1, amount);
            ps1.setLong(2, fromAccount);
            ps1.executeUpdate();
            
            PreparedStatement ps2 = conn2.prepareStatement(
                "UPDATE account SET balance = balance + ? WHERE id = ?");
            ps2.setBigDecimal(1, amount);
            ps2.setLong(2, toAccount);
            ps2.executeUpdate();
            
            // ç»“æŸäº‹åŠ¡
            conn1.prepareStatement("XA END '" + xid1 + "'").execute();
            conn2.prepareStatement("XA END '" + xid2 + "'").execute();
            
            // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡æäº¤
            conn1.prepareStatement("XA PREPARE '" + xid1 + "'").execute();
            conn2.prepareStatement("XA PREPARE '" + xid2 + "'").execute();
            
            // ç¬¬äºŒé˜¶æ®µï¼šæ­£å¼æäº¤
            conn1.prepareStatement("XA COMMIT '" + xid1 + "'").execute();
            conn2.prepareStatement("XA COMMIT '" + xid2 + "'").execute();
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸æ—¶å›æ»šæ‰€æœ‰äº‹åŠ¡
            rollbackXA(conn1, xid1);
            rollbackXA(conn2, xid2);
            throw new RuntimeException("è½¬è´¦å¤±è´¥", e);
        }
    }
}
```

### 2.3 2PCçš„ä¼˜ç¼ºç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**
- **å¼ºä¸€è‡´æ€§**ï¼šä¿è¯æ‰€æœ‰å‚ä¸è€…æ•°æ®å®Œå…¨ä¸€è‡´
- **æ ‡å‡†åè®®**ï¼šæœ‰æˆç†Ÿçš„XAè§„èŒƒæ”¯æŒ
- **äº‹åŠ¡è¯­ä¹‰æ¸…æ™°**ï¼šç¬¦åˆä¼ ç»ŸACIDç‰¹æ€§

**âŒ ç¼ºç‚¹**
```
ğŸ”¸ æ€§èƒ½é—®é¢˜ï¼š
- éœ€è¦ä¸¤è½®ç½‘ç»œé€šä¿¡
- èµ„æºé”å®šæ—¶é—´é•¿
- ååé‡è¾ƒä½

ğŸ”¸ å¯ç”¨æ€§é—®é¢˜ï¼š
- åè°ƒè€…å•ç‚¹æ•…éšœ
- å‚ä¸è€…é˜»å¡é£é™©
- ç½‘ç»œåˆ†åŒºæ•æ„Ÿ

ğŸ”¸ ä¸€è‡´æ€§é—®é¢˜ï¼š
- ç¬¬äºŒé˜¶æ®µéƒ¨åˆ†å¤±è´¥é£é™©
- æ•°æ®ä¸ä¸€è‡´çª—å£æœŸå­˜åœ¨
```

---

## 3. ğŸ’° TCCäº‹åŠ¡è¡¥å¿æ¨¡å¼


### 3.1 TCCæ¨¡å¼æ ¸å¿ƒæ€æƒ³


**ğŸ¯ TCCä¸‰ä¸ªé˜¶æ®µ**
```
Tryï¼ˆå°è¯•ï¼‰ï¼šæ£€æŸ¥å¹¶é¢„ç•™èµ„æº
Confirmï¼ˆç¡®è®¤ï¼‰ï¼šçœŸæ­£æ‰§è¡Œä¸šåŠ¡æ“ä½œ  
Cancelï¼ˆå–æ¶ˆï¼‰ï¼šé‡Šæ”¾é¢„ç•™èµ„æºï¼Œå›æ»šæ“ä½œ

ğŸ’¡ ç”Ÿæ´»ç±»æ¯”ï¼š
Try - åœ¨é¤å…é¢„å®šåº§ä½ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰ç©ºä½ï¼Œå…ˆå ä½ï¼‰
Confirm - çœŸæ­£åˆ°é¤å…å°±é¤ï¼ˆæ­£å¼ä½¿ç”¨åº§ä½ï¼‰
Cancel - å–æ¶ˆé¢„å®šï¼ˆé‡Šæ”¾åº§ä½ç»™åˆ«äººï¼‰
```

### 3.2 TCCè½¬è´¦å®ç°ç¤ºä¾‹


**ğŸ“Š è´¦æˆ·æœåŠ¡TCCå®ç°**
```java
@Component
public class AccountTccService {
    
    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private FrozenAmountMapper frozenMapper;
    
    /**
     * Tryé˜¶æ®µï¼šå†»ç»“è½¬è´¦é‡‘é¢
     */
    @Compensable
    public boolean tryTransfer(TransferRequest request) {
        // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
        Account account = accountMapper.selectById(request.getFromAccount());
        if (account.getBalance().compareTo(request.getAmount()) < 0) {
            return false; // ä½™é¢ä¸è¶³
        }
        
        // å†»ç»“é‡‘é¢ï¼ˆä¸çœŸæ­£æ‰£æ¬¾ï¼‰
        FrozenAmount frozen = new FrozenAmount();
        frozen.setAccountId(request.getFromAccount());
        frozen.setTransactionId(request.getTransactionId());
        frozen.setAmount(request.getAmount());
        frozen.setStatus("FROZEN");
        
        frozenMapper.insert(frozen);
        
        // æ›´æ–°å¯ç”¨ä½™é¢
        accountMapper.updateBalance(
            request.getFromAccount(), 
            account.getBalance().subtract(request.getAmount())
        );
        
        return true;
    }
    
    /**
     * Confirmé˜¶æ®µï¼šçœŸæ­£æ‰§è¡Œè½¬è´¦
     */
    public boolean confirmTransfer(TransferRequest request) {
        // å°†å†»ç»“é‡‘é¢è½¬ä¸ºçœŸæ­£çš„è½¬è´¦
        frozenMapper.updateStatus(request.getTransactionId(), "CONFIRMED");
        
        // ç»™ç›®æ ‡è´¦æˆ·å¢åŠ é‡‘é¢
        accountMapper.addBalance(request.getToAccount(), request.getAmount());
        
        return true;
    }
    
    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆè½¬è´¦ï¼Œæ¢å¤ä½™é¢
     */
    public boolean cancelTransfer(TransferRequest request) {
        // æ¢å¤è´¦æˆ·ä½™é¢
        accountMapper.addBalance(request.getFromAccount(), request.getAmount());
        
        // åˆ é™¤å†»ç»“è®°å½•
        frozenMapper.deleteByTransactionId(request.getTransactionId());
        
        return true;
    }
}
```

### 3.3 TCCäº‹åŠ¡ç®¡ç†å™¨å®ç°


**ğŸ”§ ç®€åŒ–ç‰ˆTCCåè°ƒå™¨**
```java
@Service
public class TccTransactionManager {
    
    private Map<String, List<TccParticipant>> participantMap = new ConcurrentHashMap<>();
    
    /**
     * å¼€å¯TCCäº‹åŠ¡
     */
    public void begin(String transactionId) {
        participantMap.put(transactionId, new ArrayList<>());
    }
    
    /**
     * æ³¨å†Œå‚ä¸è€…
     */
    public void enlist(String transactionId, TccParticipant participant) {
        participantMap.get(transactionId).add(participant);
    }
    
    /**
     * æäº¤äº‹åŠ¡
     */
    public boolean commit(String transactionId) {
        List<TccParticipant> participants = participantMap.get(transactionId);
        
        // ç¬¬ä¸€é˜¶æ®µï¼šTryæ‰€æœ‰å‚ä¸è€…
        for (TccParticipant participant : participants) {
            if (!participant.tryExecute()) {
                // æœ‰å‚ä¸è€…Tryå¤±è´¥ï¼Œå–æ¶ˆæ‰€æœ‰æ“ä½œ
                rollback(transactionId);
                return false;
            }
        }
        
        // ç¬¬äºŒé˜¶æ®µï¼šConfirmæ‰€æœ‰å‚ä¸è€…
        boolean allSuccess = true;
        for (TccParticipant participant : participants) {
            if (!participant.confirmExecute()) {
                allSuccess = false;
                // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œåç»­è¡¥å¿å¤„ç†
            }
        }
        
        return allSuccess;
    }
    
    /**
     * å›æ»šäº‹åŠ¡
     */
    public void rollback(String transactionId) {
        List<TccParticipant> participants = participantMap.get(transactionId);
        
        // Cancelæ‰€æœ‰å·²Tryçš„å‚ä¸è€…
        for (TccParticipant participant : participants) {
            participant.cancelExecute();
        }
        
        participantMap.remove(transactionId);
    }
}
```

### 3.4 TCCæ¨¡å¼ç‰¹ç‚¹åˆ†æ


**âœ… ä¼˜åŠ¿**
```
ğŸ”¸ æ€§èƒ½è¾ƒå¥½ï¼šæ²¡æœ‰é”ç­‰å¾…ï¼Œä¸šåŠ¡æ§åˆ¶äº‹åŠ¡
ğŸ”¸ å¯ç”¨æ€§é«˜ï¼šä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡æœºåˆ¶
ğŸ”¸ çµæ´»æ€§å¼ºï¼šå¯ä»¥è‡ªå®šä¹‰è¡¥å¿é€»è¾‘
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
```
ğŸ”¸ å¹‚ç­‰æ€§è¦æ±‚ï¼šConfirmå’ŒCancelæ“ä½œå¿…é¡»å¹‚ç­‰
ğŸ”¸ ç©ºå›æ»šå¤„ç†ï¼šTryé˜¶æ®µå¤±è´¥åçš„Cancelå¤„ç†  
ğŸ”¸ æ‚¬æŒ‚é—®é¢˜ï¼šç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„æ“ä½œé¡ºåºé—®é¢˜
```

---

## 4. ğŸ“– Sagaé•¿äº‹åŠ¡å¤„ç†


### 4.1 Sagaæ¨¡å¼æ ¸å¿ƒç†å¿µ


**ğŸ’¡ Sagaæ¨¡å¼æ€æƒ³**
```
å°†é•¿äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡
æ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
å¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œæ‰§è¡Œå‰é¢æ‰€æœ‰æ­¥éª¤çš„è¡¥å¿æ“ä½œ

å°±åƒèµ°æ¥¼æ¢¯ï¼š
- æ­£å¸¸æƒ…å†µï¼šä¸€æ­¥æ­¥å¾€ä¸Šèµ°
- å‡ºç°é—®é¢˜ï¼šä¸€æ­¥æ­¥å¾€ä¸‹é€€å›åŸç‚¹
```

### 4.2 Sagaå®ç°æ–¹å¼


**ğŸ”„ ç¼–æ’å¼Sagaï¼ˆOrchestrationï¼‰**
```java
@Component
public class OrderSagaOrchestrator {
    
    @Autowired
    private OrderService orderService;
    @Autowired
    private PaymentService paymentService; 
    @Autowired
    private InventoryService inventoryService;
    
    public void processOrder(OrderRequest request) {
        String sagaId = UUID.randomUUID().toString();
        SagaTransaction saga = new SagaTransaction(sagaId);
        
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            Long orderId = orderService.createOrder(request);
            saga.addCompensation(() -> orderService.cancelOrder(orderId));
            
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            inventoryService.deductInventory(request.getProductId(), request.getQuantity());
            saga.addCompensation(() -> 
                inventoryService.addInventory(request.getProductId(), request.getQuantity()));
            
            // æ­¥éª¤3ï¼šå¤„ç†æ”¯ä»˜
            paymentService.processPayment(request.getUserId(), request.getAmount());
            saga.addCompensation(() -> 
                paymentService.refund(request.getUserId(), request.getAmount()));
            
            // æ‰€æœ‰æ­¥éª¤æˆåŠŸ
            saga.markComplete();
            
        } catch (Exception e) {
            // æ‰§è¡Œè¡¥å¿æ“ä½œ
            saga.compensate();
            throw new OrderProcessException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
}

/**
 * Sagaäº‹åŠ¡çŠ¶æ€ç®¡ç†
 */
class SagaTransaction {
    private String sagaId;
    private List<Runnable> compensations = new ArrayList<>();
    private boolean completed = false;
    
    public void addCompensation(Runnable compensation) {
        compensations.add(compensation);
    }
    
    public void compensate() {
        // æŒ‰ç›¸åé¡ºåºæ‰§è¡Œè¡¥å¿
        Collections.reverse(compensations);
        compensations.forEach(compensation -> {
            try {
                compensation.run();
            } catch (Exception e) {
                // è®°å½•è¡¥å¿å¤±è´¥æ—¥å¿—
                log.error("è¡¥å¿æ“ä½œå¤±è´¥: {}", e.getMessage());
            }
        });
    }
}
```

**ğŸ­ åä½œå¼Sagaï¼ˆChoreographyï¼‰**
```java
// åŸºäºäº‹ä»¶çš„Sagaå®ç°
@EventHandler
public class OrderSagaEventHandler {
    
    @Autowired
    private EventPublisher eventPublisher;
    
    // è®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // å‘å¸ƒåº“å­˜æ‰£å‡äº‹ä»¶
            InventoryDeductEvent deductEvent = new InventoryDeductEvent(
                event.getOrderId(), 
                event.getProductId(), 
                event.getQuantity()
            );
            eventPublisher.publish(deductEvent);
            
        } catch (Exception e) {
            // å‘å¸ƒè®¢å•å–æ¶ˆäº‹ä»¶
            eventPublisher.publish(new OrderCancelEvent(event.getOrderId()));
        }
    }
    
    // åº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
    @EventListener  
    public void handleInventoryDeducted(InventoryDeductedEvent event) {
        try {
            // å‘å¸ƒæ”¯ä»˜äº‹ä»¶
            PaymentProcessEvent paymentEvent = new PaymentProcessEvent(
                event.getOrderId(),
                event.getAmount()
            );
            eventPublisher.publish(paymentEvent);
            
        } catch (Exception e) {
            // å‘å¸ƒåº“å­˜å›æ»šäº‹ä»¶
            eventPublisher.publish(new InventoryRollbackEvent(
                event.getProductId(), event.getQuantity()));
        }
    }
}
```

### 4.3 SagaçŠ¶æ€æœºå®ç°


**âš™ï¸ äº‹åŠ¡çŠ¶æ€æœºè®¾è®¡**
```
è®¢å•å¤„ç†çŠ¶æ€æœºï¼š

[å¼€å§‹] 
   â†“
[åˆ›å»ºè®¢å•] â†â†’ [å–æ¶ˆè®¢å•]
   â†“              â†‘
[æ‰£å‡åº“å­˜] â†â†’ [æ¢å¤åº“å­˜]
   â†“              â†‘  
[å¤„ç†æ”¯ä»˜] â†â†’ [é€€æ¬¾å¤„ç†]
   â†“              
[è®¢å•å®Œæˆ]

çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š
- æ­£å‘æµç¨‹ï¼šé¡ºåºæ‰§è¡Œå„æ­¥éª¤
- è¡¥å¿æµç¨‹ï¼šåå‘æ‰§è¡Œè¡¥å¿æ“ä½œ
- å¤±è´¥å¤„ç†ï¼šè®°å½•çŠ¶æ€ï¼Œæ”¯æŒé‡è¯•
```

---

## 5. ğŸ“ æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ


### 5.1 æœ¬åœ°æ¶ˆæ¯è¡¨æ ¸å¿ƒæ€æƒ³


**ğŸ’¡ è§£å†³æ€è·¯**
```
åˆ©ç”¨æœ¬åœ°äº‹åŠ¡ä¿è¯æ¶ˆæ¯ä¸ä¸šåŠ¡æ“ä½œçš„åŸå­æ€§ï¼š

1. åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ï¼š
   - æ‰§è¡Œä¸šåŠ¡æ“ä½œ
   - æ’å…¥æ¶ˆæ¯è®°å½•
   
2. å¼‚æ­¥ä»»åŠ¡æ‰«ææ¶ˆæ¯è¡¨ï¼š
   - å‘é€æœªå¤„ç†çš„æ¶ˆæ¯
   - æ›´æ–°æ¶ˆæ¯çŠ¶æ€

è¿™æ ·ç¡®ä¿ä¸šåŠ¡æ“ä½œå’Œæ¶ˆæ¯å‘é€çš„æœ€ç»ˆä¸€è‡´æ€§
```

### 5.2 æ¶ˆæ¯è¡¨è®¾è®¡


**ğŸ—ƒï¸ æœ¬åœ°æ¶ˆæ¯è¡¨ç»“æ„**
```sql
CREATE TABLE local_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'æ¶ˆæ¯å”¯ä¸€æ ‡è¯†',
    topic VARCHAR(100) NOT NULL COMMENT 'æ¶ˆæ¯ä¸»é¢˜',
    content TEXT NOT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
    status TINYINT DEFAULT 0 COMMENT 'çŠ¶æ€ï¼š0å¾…å‘é€ 1å·²å‘é€ 2å‘é€å¤±è´¥',
    retry_count INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    max_retry INT DEFAULT 5 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
    next_retry_time DATETIME COMMENT 'ä¸‹æ¬¡é‡è¯•æ—¶é—´',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_status_next_retry (status, next_retry_time),
    INDEX idx_create_time (create_time)
);
```

### 5.3 æœ¬åœ°æ¶ˆæ¯è¡¨å®ç°


**ğŸ“¤ æ¶ˆæ¯å‘é€æœåŠ¡**
```java
@Service
@Transactional
public class OrderMessageService {
    
    @Autowired
    private OrderMapper orderMapper;
    @Autowired
    private LocalMessageMapper messageMapper;
    
    /**
     * åˆ›å»ºè®¢å•å¹¶è®°å½•æ¶ˆæ¯ï¼ˆæœ¬åœ°äº‹åŠ¡ä¿è¯åŸå­æ€§ï¼‰
     */
    public void createOrderWithMessage(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setAmount(request.getAmount());
        order.setStatus("CREATED");
        
        orderMapper.insert(order);
        
        // 2. è®°å½•æ¶ˆæ¯ï¼ˆä¸è®¢å•åˆ›å»ºåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼‰
        LocalMessage message = new LocalMessage();
        message.setMessageId("ORDER_" + order.getId() + "_" + System.currentTimeMillis());
        message.setTopic("order.created");
        message.setContent(JSON.toJSONString(order));
        message.setStatus(0); // å¾…å‘é€
        message.setNextRetryTime(new Date());
        
        messageMapper.insert(message);
        
        // æœ¬åœ°äº‹åŠ¡æäº¤åï¼Œè®¢å•å’Œæ¶ˆæ¯éƒ½ä¼šæŒä¹…åŒ–
    }
}

/**
 * æ¶ˆæ¯å‘é€ä»»åŠ¡
 */
@Component
public class MessageSendTask {
    
    @Autowired
    private LocalMessageMapper messageMapper;
    @Autowired
    private MessagePublisher publisher;
    
    /**
     * å®šæ—¶æ‰«æå¾…å‘é€æ¶ˆæ¯
     */
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void sendPendingMessages() {
        // æŸ¥è¯¢å¾…å‘é€çš„æ¶ˆæ¯
        List<LocalMessage> pendingMessages = messageMapper.selectPendingMessages(100);
        
        for (LocalMessage message : pendingMessages) {
            try {
                // å‘é€æ¶ˆæ¯åˆ°MQ
                publisher.send(message.getTopic(), message.getContent());
                
                // æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºå·²å‘é€
                message.setStatus(1);
                message.setUpdateTime(new Date());
                messageMapper.updateById(message);
                
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œæ›´æ–°é‡è¯•ä¿¡æ¯
                handleSendFailure(message, e);
            }
        }
    }
    
    private void handleSendFailure(LocalMessage message, Exception e) {
        message.setRetryCount(message.getRetryCount() + 1);
        
        if (message.getRetryCount() >= message.getMaxRetry()) {
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
            message.setStatus(2);
        } else {
            // è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            long delay = (long) Math.pow(2, message.getRetryCount()) * 1000;
            message.setNextRetryTime(new Date(System.currentTimeMillis() + delay));
        }
        
        messageMapper.updateById(message);
    }
}
```

### 5.4 æ¶ˆæ¯æ¶ˆè´¹ç«¯å¤„ç†


**ğŸ“¥ æ¶ˆæ¯æ¶ˆè´¹å¹‚ç­‰å¤„ç†**
```java
@Component
public class OrderMessageConsumer {
    
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private MessageProcessLogMapper logMapper;
    
    @RabbitListener(queues = "order.created.queue")
    public void handleOrderCreated(String messageContent) {
        OrderMessage orderMsg = JSON.parseObject(messageContent, OrderMessage.class);
        String messageId = orderMsg.getMessageId();
        
        // å¹‚ç­‰æ€§æ£€æŸ¥
        if (logMapper.existsByMessageId(messageId)) {
            return; // æ¶ˆæ¯å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        try {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼šæ‰£å‡åº“å­˜
            inventoryService.deductInventory(
                orderMsg.getProductId(), 
                orderMsg.getQuantity()
            );
            
            // è®°å½•å¤„ç†æ—¥å¿—
            MessageProcessLog log = new MessageProcessLog();
            log.setMessageId(messageId);
            log.setStatus("SUCCESS");
            log.setProcessTime(new Date());
            
            logMapper.insert(log);
            
        } catch (Exception e) {
            // è®°å½•å¤„ç†å¤±è´¥
            MessageProcessLog log = new MessageProcessLog();
            log.setMessageId(messageId);
            log.setStatus("FAILED");
            log.setErrorMessage(e.getMessage());
            
            logMapper.insert(log);
            
            // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘æ¶ˆæ¯é‡è¯•
            throw new RuntimeException("åº“å­˜æ‰£å‡å¤±è´¥", e);
        }
    }
}
```

---

## 6. ğŸš€ äº‹åŠ¡æ¶ˆæ¯æ¨¡å¼


### 6.1 äº‹åŠ¡æ¶ˆæ¯å·¥ä½œåŸç†


**ğŸ”„ RocketMQäº‹åŠ¡æ¶ˆæ¯æµç¨‹**
```
ç”Ÿäº§è€…                   MQ Broker               æ¶ˆè´¹è€…
   |                        |                      |
   |--[1]å‘é€åŠäº‹åŠ¡æ¶ˆæ¯----->|                      |
   |<--[2]è¿”å›å‘é€ç»“æœ-------|                      |
   |                        |                      |
   |--[3]æ‰§è¡Œæœ¬åœ°äº‹åŠ¡------->|                      |
   |                        |                      |  
   |--[4]æäº¤/å›æ»šæ¶ˆæ¯----->|                      |
   |                        |--[5]æŠ•é€’æ¶ˆæ¯-------->|
   |                        |<--[6]æ¶ˆè´¹ç¡®è®¤-------|
   |                        |                      |
   |<--[7]å›æŸ¥æœ¬åœ°äº‹åŠ¡-------|ï¼ˆå¦‚æœ4æ­¥éª¤è¶…æ—¶ï¼‰      |
   |--[8]è¿”å›äº‹åŠ¡çŠ¶æ€------>|                      |

æ ¸å¿ƒæ€æƒ³ï¼šå…ˆå‘é€æ¶ˆæ¯ä½†ä¸æŠ•é€’ï¼Œç­‰æœ¬åœ°äº‹åŠ¡æˆåŠŸåå†çœŸæ­£æŠ•é€’
```

### 6.2 RocketMQäº‹åŠ¡æ¶ˆæ¯å®ç°


**ğŸ“¨ äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…**
```java
@Component
public class TransactionMessageProducer {
    
    private TransactionMQProducer producer;
    
    @Autowired
    private OrderService orderService;
    
    @PostConstruct
    public void init() {
        producer = new TransactionMQProducer("order_producer_group");
        producer.setNamesrvAddr("localhost:9876");
        
        // è®¾ç½®äº‹åŠ¡ç›‘å¬å™¨
        producer.setTransactionListener(new OrderTransactionListener());
        
        try {
            producer.start();
        } catch (MQClientException e) {
            throw new RuntimeException("å¯åŠ¨äº‹åŠ¡æ¶ˆæ¯ç”Ÿäº§è€…å¤±è´¥", e);
        }
    }
    
    /**
     * å‘é€äº‹åŠ¡æ¶ˆæ¯
     */
    public void sendTransactionMessage(CreateOrderRequest request) {
        Message msg = new Message(
            "order_topic", 
            "order_created",
            JSON.toJSONString(request).getBytes()
        );
        
        try {
            // å‘é€äº‹åŠ¡æ¶ˆæ¯ï¼ˆåŠäº‹åŠ¡æ¶ˆæ¯ï¼‰
            TransactionSendResult result = producer.sendMessageInTransaction(
                msg, 
                request // ä¼ é€’ç»™äº‹åŠ¡ç›‘å¬å™¨çš„å‚æ•°
            );
            
            System.out.println("äº‹åŠ¡æ¶ˆæ¯å‘é€ç»“æœï¼š" + result.getSendStatus());
            
        } catch (Exception e) {
            throw new RuntimeException("å‘é€äº‹åŠ¡æ¶ˆæ¯å¤±è´¥", e);
        }
    }
    
    /**
     * äº‹åŠ¡ç›‘å¬å™¨
     */
    class OrderTransactionListener implements TransactionListener {
        
        @Override
        public LocalTransactionState executeLocalTransaction(Message msg, Object arg) {
            CreateOrderRequest request = (CreateOrderRequest) arg;
            
            try {
                // æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼šåˆ›å»ºè®¢å•
                orderService.createOrder(request);
                
                // æœ¬åœ°äº‹åŠ¡æˆåŠŸï¼Œæäº¤æ¶ˆæ¯
                return LocalTransactionState.COMMIT_MESSAGE;
                
            } catch (Exception e) {
                // æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œå›æ»šæ¶ˆæ¯
                return LocalTransactionState.ROLLBACK_MESSAGE;
            }
        }
        
        @Override
        public LocalTransactionState checkLocalTransaction(MessageExt msg) {
            // MQå›æŸ¥æœ¬åœ°äº‹åŠ¡çŠ¶æ€
            String orderId = msg.getKeys(); // ä»æ¶ˆæ¯ä¸­è·å–è®¢å•ID
            
            try {
                Order order = orderService.getOrderById(orderId);
                if (order != null && "CREATED".equals(order.getStatus())) {
                    return LocalTransactionState.COMMIT_MESSAGE;
                } else {
                    return LocalTransactionState.ROLLBACK_MESSAGE;
                }
            } catch (Exception e) {
                // çŠ¶æ€ä¸ç¡®å®šï¼Œè®©MQç¨åå†æ¬¡å›æŸ¥
                return LocalTransactionState.UNKNOW;
            }
        }
    }
}
```

### 6.3 äº‹åŠ¡æ¶ˆæ¯æ¶ˆè´¹è€…


**ğŸ“¥ æ¶ˆè´¹è€…å¹‚ç­‰å¤„ç†**
```java
@Component
public class OrderCreatedConsumer {
    
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private PaymentService paymentService;
    
    @RocketMQMessageListener(
        topic = "order_topic",
        consumerGroup = "inventory_consumer_group"
    )
    public class InventoryConsumer implements RocketMQListener<String> {
        
        @Override
        public void onMessage(String message) {
            CreateOrderRequest request = JSON.parseObject(message, CreateOrderRequest.class);
            
            try {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼šæ‰£å‡åº“å­˜
                inventoryService.deductInventory(
                    request.getProductId(), 
                    request.getQuantity()
                );
                
                // æ¶ˆè´¹æˆåŠŸï¼Œè‡ªåŠ¨ACK
                
            } catch (Exception e) {
                // æ¶ˆè´¹å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
                throw new RuntimeException("åº“å­˜æ‰£å‡å¤±è´¥", e);
            }
        }
    }
}
```

---

## 7. ğŸ¢ Seataåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


### 7.1 Seataæ¶æ„ç»„æˆ


**ğŸ—ï¸ Seataæ ¸å¿ƒç»„ä»¶**
```
TC (Transaction Coordinator) - äº‹åŠ¡åè°ƒè€…
    â†“ ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œé©±åŠ¨å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š
    
TM (Transaction Manager) - äº‹åŠ¡ç®¡ç†å™¨  
    â†“ å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´ï¼Œè´Ÿè´£å¼€å¯å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»š
    
RM (Resource Manager) - èµ„æºç®¡ç†å™¨
    â†“ ç®¡ç†åˆ†æ”¯äº‹åŠ¡ï¼Œä¸TCäº¤äº’è¿›è¡Œåˆ†æ”¯äº‹åŠ¡çš„æ³¨å†Œã€çŠ¶æ€æ±‡æŠ¥ç­‰

åº”ç”¨ç¨‹åº
    â†“ ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨@GlobalTransactionalæ³¨è§£
```

### 7.2 Seataé…ç½®ä¸ä½¿ç”¨


**âš™ï¸ SeataæœåŠ¡ç«¯é…ç½®**
```yaml
# application.yml
server:
  port: 7091

spring:
  application:
    name: seata-server

seata:
  config:
    type: nacos
    nacos:
      server-addr: localhost:8848
      namespace: seata
      group: SEATA_GROUP
      
  registry:
    type: nacos
    nacos:
      server-addr: localhost:8848
      namespace: seata
      cluster: default
```

**ğŸ”§ å®¢æˆ·ç«¯Seataé…ç½®**
```yaml
# è®¢å•æœåŠ¡é…ç½®
seata:
  enabled: true
  application-id: order-service
  tx-service-group: order-service-group
  
  registry:
    type: nacos
    nacos:
      server-addr: localhost:8848
      namespace: seata
      
  config:
    type: nacos
    nacos:
      server-addr: localhost:8848
      namespace: seata
```

### 7.3 Seata ATæ¨¡å¼å®ç°


**ğŸ¯ ATæ¨¡å¼ä¸šåŠ¡ä»£ç **
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private AccountService accountService;
    
    /**
     * å…¨å±€äº‹åŠ¡ï¼šåˆ›å»ºè®¢å•
     */
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(CreateOrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setAmount(request.getAmount());
        order.setStatus("CREATED");
        
        orderMapper.insert(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        inventoryService.deduct(request.getProductId(), request.getQuantity());
        
        // 3. æ‰£å‡è´¦æˆ·ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        accountService.debit(request.getUserId(), request.getAmount());
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ŒSeataä¼šè‡ªåŠ¨å›æ»šæ‰€æœ‰æ“ä½œ
    }
}

@Service
public class InventoryService {
    
    @Autowired
    private InventoryMapper inventoryMapper;
    
    /**
     * åº“å­˜æ‰£å‡ï¼ˆåˆ†æ”¯äº‹åŠ¡ï¼‰
     */
    @Transactional
    public void deduct(Long productId, Integer quantity) {
        Inventory inventory = inventoryMapper.selectByProductId(productId);
        
        if (inventory.getStock() < quantity) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // Seataä¼šè‡ªåŠ¨è®°å½•before imageå’Œafter image
        inventory.setStock(inventory.getStock() - quantity);
        inventoryMapper.updateById(inventory);
    }
}
```

### 7.4 Seata TCCæ¨¡å¼å®ç°


**ğŸ’¼ TCCæ¥å£å®šä¹‰**
```java
@LocalTCC
public interface AccountTccService {
    
    /**
     * Tryé˜¶æ®µï¼šé¢„æ‰£è´¹ç”¨
     */
    @TwoPhaseBusinessAction(name = "debit", commitMethod = "commit", rollbackMethod = "rollback")
    boolean debit(@BusinessActionContextParameter(paramName = "userId") Long userId,
                  @BusinessActionContextParameter(paramName = "amount") BigDecimal amount);
    
    /**
     * Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£è´¹
     */
    boolean commit(BusinessActionContext context);
    
    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰£è´¹
     */
    boolean rollback(BusinessActionContext context);
}

@Component
public class AccountTccServiceImpl implements AccountTccService {
    
    @Autowired
    private AccountMapper accountMapper;
    @Autowired
    private FrozenAmountMapper frozenMapper;
    
    @Override
    public boolean debit(Long userId, BigDecimal amount) {
        Account account = accountMapper.selectById(userId);
        if (account.getBalance().compareTo(amount) < 0) {
            throw new RuntimeException("ä½™é¢ä¸è¶³");
        }
        
        // å†»ç»“é‡‘é¢
        FrozenAmount frozen = new FrozenAmount();
        frozen.setUserId(userId);
        frozen.setAmount(amount);
        frozen.setTransactionId(RootContext.getXID());
        
        frozenMapper.insert(frozen);
        
        // å‡å°‘å¯ç”¨ä½™é¢
        account.setBalance(account.getBalance().subtract(amount));
        accountMapper.updateById(account);
        
        return true;
    }
    
    @Override
    public boolean commit(BusinessActionContext context) {
        Long userId = (Long) context.getActionContext("userId");
        String xid = context.getXid();
        
        // åˆ é™¤å†»ç»“è®°å½•ï¼Œç¡®è®¤æ‰£è´¹
        frozenMapper.deleteByTransactionId(xid);
        return true;
    }
    
    @Override
    public boolean rollback(BusinessActionContext context) {
        Long userId = (Long) context.getActionContext("userId");
        BigDecimal amount = (BigDecimal) context.getActionContext("amount");
        String xid = context.getXid();
        
        // æ¢å¤ä½™é¢
        Account account = accountMapper.selectById(userId);
        account.setBalance(account.getBalance().add(amount));
        accountMapper.updateById(account);
        
        // åˆ é™¤å†»ç»“è®°å½•
        frozenMapper.deleteByTransactionId(xid);
        return true;
    }
}
```

---

## 8. ğŸ” åˆ†å¸ƒå¼é”ä¸äº‹åŠ¡åè°ƒ


### 8.1 åˆ†å¸ƒå¼é”åŸºæœ¬æ¦‚å¿µ


**ğŸ”’ åˆ†å¸ƒå¼é”çš„ä½œç”¨**
```
åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹éœ€è¦åè°ƒè®¿é—®å…±äº«èµ„æºæ—¶ï¼š
- é˜²æ­¢é‡å¤æ“ä½œï¼ˆå¦‚é‡å¤æ‰£æ¬¾ï¼‰
- ä¿è¯æ“ä½œåºåˆ—æ€§ï¼ˆå¦‚åº“å­˜æ›´æ–°ï¼‰
- å®ç°äº’æ–¥è®¿é—®ï¼ˆå¦‚ç§’æ€å•†å“ï¼‰

ğŸ’¡ ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒå•æ‰€é—¨é”ï¼Œç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªäººä½¿ç”¨
```

### 8.2 Redisåˆ†å¸ƒå¼é”å®ç°


**ğŸ”§ Redisé”åŸºæœ¬å®ç°**
```java
@Component
public class RedisDistributedLock {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    private static final String LOCK_PREFIX = "distributed_lock:";
    private static final String UNLOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('del', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    /**
     * å°è¯•è·å–é”
     */
    public boolean tryLock(String lockKey, String requestId, long expireTime) {
        String key = LOCK_PREFIX + lockKey;
        
        // ä½¿ç”¨SETå‘½ä»¤çš„NXå’ŒEXå‚æ•°å®ç°åŸå­æ“ä½œ
        Boolean result = redisTemplate.opsForValue().setIfAbsent(
            key, requestId, Duration.ofMillis(expireTime)
        );
        
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é‡Šæ”¾é”
     */
    public boolean releaseLock(String lockKey, String requestId) {
        String key = LOCK_PREFIX + lockKey;
        
        // ä½¿ç”¨Luaè„šæœ¬ç¡®ä¿åŸå­æ€§
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(UNLOCK_SCRIPT, Long.class),
            Collections.singletonList(key),
            requestId
        );
        
        return Long.valueOf(1L).equals(result);
    }
    
    /**
     * è‡ªåŠ¨ç»­æœŸé”
     */
    public void renewLock(String lockKey, String requestId, long expireTime) {
        String key = LOCK_PREFIX + lockKey;
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æŒæœ‰é”
        String currentId = redisTemplate.opsForValue().get(key);
        if (requestId.equals(currentId)) {
            // ç»­æœŸ
            redisTemplate.expire(key, Duration.ofMillis(expireTime));
        }
    }
}
```

### 8.3 åˆ†å¸ƒå¼é”åœ¨äº‹åŠ¡ä¸­çš„åº”ç”¨


**ğŸ›’ ç§’æ€åœºæ™¯çš„åˆ†å¸ƒå¼äº‹åŠ¡**
```java
@Service
public class SeckillService {
    
    @Autowired
    private RedisDistributedLock distributedLock;
    @Autowired
    private ProductService productService;
    @Autowired
    private OrderService orderService;
    
    /**
     * ç§’æ€å•†å“
     */
    @GlobalTransactional(name = "seckill", rollbackFor = Exception.class)
    public SeckillResult seckill(Long productId, Long userId) {
        String lockKey = "seckill_" + productId;
        String requestId = Thread.currentThread().getId() + "_" + System.currentTimeMillis();
        
        // å°è¯•è·å–åˆ†å¸ƒå¼é”
        if (!distributedLock.tryLock(lockKey, requestId, 30000)) {
            return SeckillResult.failed("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        try {
            // æ£€æŸ¥å•†å“åº“å­˜
            Product product = productService.getById(productId);
            if (product.getStock() <= 0) {
                return SeckillResult.failed("å•†å“å·²å”®å®Œ");
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»è´­ä¹°è¿‡
            if (orderService.hasUserBought(productId, userId)) {
                return SeckillResult.failed("æ‚¨å·²ç»è´­ä¹°è¿‡è¯¥å•†å“");
            }
            
            // æ‰£å‡åº“å­˜
            productService.decreaseStock(productId, 1);
            
            // åˆ›å»ºè®¢å•
            Order order = orderService.createSeckillOrder(productId, userId);
            
            return SeckillResult.success(order.getId());
            
        } catch (Exception e) {
            // Seataä¼šè‡ªåŠ¨å›æ»šäº‹åŠ¡
            throw new RuntimeException("ç§’æ€å¤±è´¥", e);
            
        } finally {
            // é‡Šæ”¾åˆ†å¸ƒå¼é”
            distributedLock.releaseLock(lockKey, requestId);
        }
    }
}
```

### 8.4 åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”


**ğŸ“Š æ•°æ®åº“é”è¡¨è®¾è®¡**
```sql
CREATE TABLE distributed_lock (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lock_key VARCHAR(255) NOT NULL UNIQUE COMMENT 'é”æ ‡è¯†',
    holder VARCHAR(255) NOT NULL COMMENT 'é”æŒæœ‰è€…',
    expire_time BIGINT NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´æˆ³',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_lock_key (lock_key)
);
```

**ğŸ”§ æ•°æ®åº“é”å®ç°**
```java
@Component
public class DatabaseDistributedLock {
    
    @Autowired
    private DistributedLockMapper lockMapper;
    
    /**
     * å°è¯•è·å–é”
     */
    @Transactional
    public boolean tryLock(String lockKey, String holder, long expireMs) {
        long expireTime = System.currentTimeMillis() + expireMs;
        
        try {
            // å°è¯•æ’å…¥é”è®°å½•
            DistributedLockEntity lock = new DistributedLockEntity();
            lock.setLockKey(lockKey);
            lock.setHolder(holder);
            lock.setExpireTime(expireTime);
            
            lockMapper.insert(lock);
            return true;
            
        } catch (DuplicateKeyException e) {
            // é”å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            DistributedLockEntity existLock = lockMapper.selectByLockKey(lockKey);
            if (existLock != null && existLock.getExpireTime() < System.currentTimeMillis()) {
                // é”å·²è¿‡æœŸï¼Œå°è¯•æ›´æ–°
                int updated = lockMapper.updateExpiredLock(lockKey, holder, expireTime);
                return updated > 0;
            }
            return false;
        }
    }
    
    /**
     * é‡Šæ”¾é”
     */
    @Transactional
    public boolean releaseLock(String lockKey, String holder) {
        int deleted = lockMapper.deleteByKeyAndHolder(lockKey, holder);
        return deleted > 0;
    }
}
```

---

## 9. ğŸ“Š äº‹åŠ¡ç›‘æ§ä¸æ€§èƒ½ä¼˜åŒ–


### 9.1 äº‹åŠ¡ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**
```
äº‹åŠ¡æˆåŠŸç‡ = æˆåŠŸäº‹åŠ¡æ•° / æ€»äº‹åŠ¡æ•°
äº‹åŠ¡å¹³å‡å“åº”æ—¶é—´ = æ€»å“åº”æ—¶é—´ / äº‹åŠ¡æ•°
äº‹åŠ¡å¹¶å‘æ•° = å½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡æ•°é‡
äº‹åŠ¡å›æ»šç‡ = å›æ»šäº‹åŠ¡æ•° / æ€»äº‹åŠ¡æ•°

åˆ†æ”¯äº‹åŠ¡æŒ‡æ ‡ï¼š
- åˆ†æ”¯äº‹åŠ¡æˆåŠŸç‡
- åˆ†æ”¯äº‹åŠ¡å¹³å‡æ‰§è¡Œæ—¶é—´
- åˆ†æ”¯äº‹åŠ¡å¼‚å¸¸åˆ†å¸ƒ

èµ„æºé”å®šæŒ‡æ ‡ï¼š
- å¹³å‡é”æŒæœ‰æ—¶é—´
- é”ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
- æ­»é”å‘ç”Ÿé¢‘ç‡
```

### 9.2 Seataç›‘æ§å®ç°


**ğŸ–¥ï¸ è‡ªå®šä¹‰ç›‘æ§åŸ‹ç‚¹**
```java
@Component
public class TransactionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer transactionTimer;
    private final Counter successCounter;
    private final Counter failureCounter;
    
    public TransactionMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.transactionTimer = Timer.builder("seata.transaction.duration")
            .description("Transaction execution time")
            .register(meterRegistry);
        this.successCounter = Counter.builder("seata.transaction.success")
            .description("Successful transactions")
            .register(meterRegistry);
        this.failureCounter = Counter.builder("seata.transaction.failure")
            .description("Failed transactions")  
            .register(meterRegistry);
    }
    
    @EventListener
    public void handleGlobalTransactionEvent(GlobalTransactionEvent event) {
        String xid = event.getId();
        
        switch (event.getStatus()) {
            case GlobalStatus.Committed:
                successCounter.increment();
                recordTransactionTime(xid);
                break;
                
            case GlobalStatus.Rollbacked:
                failureCounter.increment();
                recordTransactionTime(xid);
                break;
                
            case GlobalStatus.TimeoutRollbacked:
                failureCounter.increment();
                // è®°å½•è¶…æ—¶äº‹åŠ¡
                meterRegistry.counter("seata.transaction.timeout").increment();
                break;
        }
    }
    
    private void recordTransactionTime(String xid) {
        // ä»ç¼“å­˜ä¸­è·å–äº‹åŠ¡å¼€å§‹æ—¶é—´
        Long startTime = transactionStartTimes.remove(xid);
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            transactionTimer.record(duration, TimeUnit.MILLISECONDS);
        }
    }
}
```

### 9.3 äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**

> ğŸ’¡ **å‡å°‘äº‹åŠ¡èŒƒå›´**  
> å°†éæ ¸å¿ƒæ“ä½œç§»å‡ºäº‹åŠ¡è¾¹ç•Œï¼Œåªä¿ç•™å¿…é¡»çš„åŸå­æ“ä½œ

> â±ï¸ **ä¼˜åŒ–äº‹åŠ¡è¶…æ—¶**  
> æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…è¿‡é•¿é˜»å¡

> ğŸ”„ **å¼‚æ­¥åŒ–å¤„ç†**  
> éå…³é”®æ­¥éª¤é‡‡ç”¨å¼‚æ­¥å¤„ç†ï¼Œå‡å°‘äº‹åŠ¡æ‰§è¡Œæ—¶é—´

> ğŸ“Š **æ‰¹é‡æ“ä½œä¼˜åŒ–**  
> åˆå¹¶å¤šä¸ªå°äº‹åŠ¡ä¸ºæ‰¹é‡æ“ä½œï¼Œå‡å°‘ç½‘ç»œå¼€é”€

```java
@Component
public class TransactionOptimizer {
    
    /**
     * ä¼˜åŒ–å‰ï¼šå¤šä¸ªå°äº‹åŠ¡
     */
    @GlobalTransactional
    public void createOrdersBefore(List<OrderRequest> requests) {
        for (OrderRequest request : requests) {
            // æ¯ä¸ªè®¢å•ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œç½‘ç»œå¼€é”€å¤§
            orderService.createOrder(request);
            inventoryService.deduct(request.getProductId(), 1);
            accountService.debit(request.getUserId(), request.getAmount());
        }
    }
    
    /**
     * ä¼˜åŒ–åï¼šæ‰¹é‡æ“ä½œ
     */
    @GlobalTransactional
    public void createOrdersAfter(List<OrderRequest> requests) {
        // æ‰¹é‡åˆ›å»ºè®¢å•
        List<Order> orders = orderService.batchCreateOrders(requests);
        
        // æ‰¹é‡æ‰£å‡åº“å­˜
        Map<Long, Integer> stockDeductions = requests.stream()
            .collect(Collectors.groupingBy(
                OrderRequest::getProductId,
                Collectors.summingInt(OrderRequest::getQuantity)
            ));
        inventoryService.batchDeduct(stockDeductions);
        
        // æ‰¹é‡æ‰£è´¹
        Map<Long, BigDecimal> userDebits = requests.stream()
            .collect(Collectors.groupingBy(
                OrderRequest::getUserId,
                Collectors.reducing(BigDecimal.ZERO, 
                    OrderRequest::getAmount, 
                    BigDecimal::add)
            ));
        accountService.batchDebit(userDebits);
    }
}
```

### 9.4 äº‹åŠ¡æ•…éšœå¤„ç†ä¸é™çº§


**ğŸ›¡ï¸ é™çº§ç­–ç•¥å®ç°**
```java
@Component
public class TransactionFallbackHandler {
    
    @Autowired
    private CircuitBreaker circuitBreaker;
    
    /**
     * å¸¦é™çº§çš„åˆ†å¸ƒå¼äº‹åŠ¡
     */
    public OrderResult createOrderWithFallback(CreateOrderRequest request) {
        // æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
        if (circuitBreaker.getState() == CircuitBreaker.State.OPEN) {
            return handleFallback(request);
        }
        
        try {
            // å°è¯•æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡
            return executeDistributedTransaction(request);
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥
            circuitBreaker.onError(Duration.ofMillis(System.currentTimeMillis()), e);
            
            // æ‰§è¡Œé™çº§é€»è¾‘
            return handleFallback(request);
        }
    }
    
    /**
     * é™çº§å¤„ç†ï¼šæ”¹ä¸ºå¼‚æ­¥æœ€ç»ˆä¸€è‡´æ€§
     */
    private OrderResult handleFallback(CreateOrderRequest request) {
        try {
            // å…ˆåˆ›å»ºè®¢å•ï¼ŒçŠ¶æ€ä¸º"å¾…å¤„ç†"
            Order order = orderService.createPendingOrder(request);
            
            // å‘é€å¼‚æ­¥æ¶ˆæ¯è¿›è¡Œåç»­å¤„ç†
            messageProducer.sendAsyncProcessMessage(order);
            
            return OrderResult.success(order.getId(), "è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨å¤„ç†ä¸­");
            
        } catch (Exception e) {
            return OrderResult.failed("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | **ä¸€è‡´æ€§** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|---------|-----------|------------|
| **2PC/XA** | `å¼ºä¸€è‡´` | `ä½` | `ä½` | `å°è§„æ¨¡ã€å¼ºä¸€è‡´æ€§è¦æ±‚` |
| **TCC** | `æœ€ç»ˆä¸€è‡´` | `ä¸­` | `é«˜` | `ä¸šåŠ¡å¯æ§ã€è¡¥å¿é€»è¾‘æ¸…æ™°` |
| **Saga** | `æœ€ç»ˆä¸€è‡´` | `é«˜` | `ä¸­` | `é•¿æµç¨‹ã€å¯åˆ†è§£ä¸šåŠ¡` |
| **æœ¬åœ°æ¶ˆæ¯è¡¨** | `æœ€ç»ˆä¸€è‡´` | `é«˜` | `ä¸­` | `å¼‚æ­¥å¤„ç†ã€é«˜å¹¶å‘` |
| **äº‹åŠ¡æ¶ˆæ¯** | `æœ€ç»ˆä¸€è‡´` | `é«˜` | `ä½` | `æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€è®¾æ–½å®Œå–„` |

### 10.2 æŠ€æœ¯é€‰æ‹©å»ºè®®


**ğŸ¯ é€‰æ‹©å†³ç­–æ ‘**
```
ä¸šåŠ¡å¯¹ä¸€è‡´æ€§è¦æ±‚ â†’ å¼ºä¸€è‡´æ€§ â†’ 2PC/XAæ–¹æ¡ˆ
                â†“
              æœ€ç»ˆä¸€è‡´æ€§ â†’ ä¸šåŠ¡å¤æ‚åº¦é«˜ â†’ TCCæ–¹æ¡ˆ  
                        â†“
                      ä¸šåŠ¡å¤æ‚åº¦ä¸­ â†’ Sagaæ–¹æ¡ˆ
                        â†“  
                      ä¸šåŠ¡å¤æ‚åº¦ä½ â†’ æ¶ˆæ¯æ–¹æ¡ˆ
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- **é‡‘èæ”¯ä»˜åœºæ™¯**ï¼šä¼˜å…ˆè€ƒè™‘TCCï¼Œä¿è¯èµ„é‡‘å®‰å…¨
- **ç”µå•†è®¢å•åœºæ™¯**ï¼šæ¨èSaga + æ¶ˆæ¯ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
- **æ•°æ®åŒæ­¥åœºæ™¯**ï¼šé€‰æ‹©æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œç®€å•å¯é 
- **ç§’æ€æŠ¢è´­åœºæ™¯**ï¼šç»“åˆåˆ†å¸ƒå¼é” + æ¶ˆæ¯å¼‚æ­¥å¤„ç†

### 10.3 å®æ–½è¦ç‚¹æé†’


**âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹**

> ğŸ”¸ **å¹‚ç­‰æ€§è®¾è®¡**ï¼šæ‰€æœ‰æ“ä½œéƒ½å¿…é¡»æ”¯æŒé‡è¯•ï¼Œç¡®ä¿å¹‚ç­‰
> 
> ğŸ”¸ **è¶…æ—¶å¤„ç†**ï¼šåˆç†è®¾ç½®å„é˜¶æ®µè¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡
> 
> ğŸ”¸ **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„äº‹åŠ¡ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
> 
> ğŸ”¸ **å®¹é”™é™çº§**ï¼šè®¾è®¡é™çº§æ–¹æ¡ˆï¼Œä¿è¯ç³»ç»Ÿå¯ç”¨æ€§
> 
> ğŸ”¸ **æ•°æ®æ ¡éªŒ**ï¼šå®šæœŸæ ¡éªŒæ•°æ®ä¸€è‡´æ€§ï¼Œå‘ç°å¹¶ä¿®å¤é—®é¢˜

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
- åˆ†å¸ƒå¼äº‹åŠ¡é€‰æ‹©çœ‹åœºæ™¯ï¼Œå¼ºä¸€è‡´ç”¨2PCè¦å°å¿ƒ
- æœ€ç»ˆä¸€è‡´ç”¨æ¶ˆæ¯ï¼ŒTCCè¡¥å¿è¦ä»”ç»†  
- Sagaæ‹†åˆ†é•¿æµç¨‹ï¼Œç›‘æ§é™çº§ä¸å¯å°‘
- å¹‚ç­‰è¶…æ—¶æ˜¯åŸºç¡€ï¼Œæ€§èƒ½ä¸€è‡´è¦å¹³è¡¡

**ğŸ“ å­¦ä¹ å»ºè®®**
- å…ˆæŒæ¡ç†è®ºæ¦‚å¿µï¼Œå†åŠ¨æ‰‹å®è·µå„ç§æ–¹æ¡ˆ
- ä»ç®€å•çš„æœ¬åœ°æ¶ˆæ¯è¡¨å¼€å§‹ï¼Œé€æ­¥å­¦ä¹ å¤æ‚æ–¹æ¡ˆ
- é‡ç‚¹ç†è§£æ¯ç§æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯å’Œæƒè¡¡è€ƒé‡
- ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆ