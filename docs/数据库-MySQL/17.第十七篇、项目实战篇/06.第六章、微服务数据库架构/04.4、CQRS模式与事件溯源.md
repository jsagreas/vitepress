---
title: 4ã€CQRSæ¨¡å¼ä¸äº‹ä»¶æº¯æº
---
## ğŸ“š ç›®å½•

1. [CQRSæ¨¡å¼åŸºç¡€æ¦‚å¿µ](#1-CQRSæ¨¡å¼åŸºç¡€æ¦‚å¿µ)
2. [å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»åŸç†](#2-å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»åŸç†)
3. [äº‹ä»¶æº¯æºæ ¸å¿ƒæœºåˆ¶](#3-äº‹ä»¶æº¯æºæ ¸å¿ƒæœºåˆ¶)
4. [Event Storeè®¾è®¡ä¸å®ç°](#4-Event-Storeè®¾è®¡ä¸å®ç°)
5. [è¯»æ¨¡å‹æŠ•å½±æœºåˆ¶](#5-è¯»æ¨¡å‹æŠ•å½±æœºåˆ¶)
6. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CQRSæ¨¡å¼åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯CQRS


**CQRSå…¨ç§°**ï¼šCommand Query Responsibility Segregationï¼ˆå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰

> **ğŸ’¡ é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…ä¸€æ ·ï¼Œç‚¹é¤ï¼ˆå†™æ“ä½œï¼‰å’ŒæŸ¥çœ‹èœå•ï¼ˆè¯»æ“ä½œï¼‰æ˜¯å®Œå…¨ä¸åŒçš„çª—å£å’Œæµç¨‹

**æ ¸å¿ƒæ€æƒ³**ï¼š
```
ä¼ ç»Ÿæ¶æ„ï¼š
ç”¨æˆ·è¯·æ±‚ â€”â€”â†’ åŒä¸€ä¸ªæ¨¡å‹ â€”â€”â†’ åŒä¸€ä¸ªæ•°æ®åº“
         è¯»å†™éƒ½ç”¨è¿™ä¸€å¥—

CQRSæ¶æ„ï¼š
å†™è¯·æ±‚ â€”â€”â†’ å‘½ä»¤æ¨¡å‹ â€”â€”â†’ å†™æ•°æ®åº“
è¯»è¯·æ±‚ â€”â€”â†’ æŸ¥è¯¢æ¨¡å‹ â€”â€”â†’ è¯»æ•°æ®åº“
       å®Œå…¨åˆ†ç¦»çš„ä¸¤å¥—ç³»ç»Ÿ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦CQRS


**ä¼ ç»Ÿæ¶æ„çš„ç—›ç‚¹**ï¼š
- **è¯»å†™å†²çª**ï¼šå¤æ‚æŸ¥è¯¢å½±å“å†™æ“ä½œæ€§èƒ½
- **æ¨¡å‹å¤æ‚**ï¼šä¸€ä¸ªæ¨¡å‹è¦æ»¡è¶³è¯»å†™ä¸¤ç§éœ€æ±‚
- **æ‰©å±•å›°éš¾**ï¼šè¯»å†™éœ€æ±‚ä¸åŒï¼Œéš¾ä»¥é’ˆå¯¹æ€§ä¼˜åŒ–

```
ğŸ¢ å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š
ç”µå•†è®¢å•ç³»ç»Ÿ
- å†™æ“ä½œï¼šåˆ›å»ºè®¢å•ï¼ˆç®€å•ï¼Œä½†è¦æ±‚å¼ºä¸€è‡´æ€§ï¼‰
- è¯»æ“ä½œï¼šè®¢å•æŠ¥è¡¨ï¼ˆå¤æ‚æŸ¥è¯¢ï¼Œå¯ä»¥å»¶è¿Ÿå‡ ç§’ï¼‰

ä¼ ç»Ÿåšæ³•ï¼šä¸€ä¸ªæ•°æ®æ¨¡å‹æå®šæ‰€æœ‰
CQRSåšæ³•ï¼šå†™æ¨¡å‹å­˜è®¢å•ï¼Œè¯»æ¨¡å‹å­˜æŠ¥è¡¨æ•°æ®
```

### 1.3 CQRSé€‚ç”¨åœºæ™¯


**ğŸ“Š é€‚åˆä½¿ç”¨CQRSçš„æƒ…å†µ**ï¼š
- **è¯»å†™æ¯”ä¾‹å¤±è¡¡**ï¼šè¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œ
- **å¤æ‚æŸ¥è¯¢éœ€æ±‚**ï¼šéœ€è¦å¤æ‚çš„æ•°æ®ç»Ÿè®¡å’Œåˆ†æ
- **é«˜å¹¶å‘è¦æ±‚**ï¼šè¯»å†™æ“ä½œéœ€è¦ç‹¬ç«‹æ‰©å±•
- **ä¸šåŠ¡é€»è¾‘å¤æ‚**ï¼šå†™æ“ä½œæœ‰å¤æ‚çš„ä¸šåŠ¡è§„åˆ™

**ğŸš« ä¸é€‚åˆCQRSçš„æƒ…å†µ**ï¼š
- **ç®€å•CRUDåº”ç”¨**ï¼šå¢åˆ æ”¹æŸ¥éƒ½å¾ˆç®€å•
- **è¯»å†™æ¯”ä¾‹å‡è¡¡**ï¼šæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆ
- **å›¢é˜Ÿç»éªŒä¸è¶³**ï¼šå¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦

---

## 2. âš–ï¸ å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»åŸç†


### 2.1 å‘½ä»¤ç«¯è®¾è®¡


**å‘½ä»¤ï¼ˆCommandï¼‰çš„ç‰¹ç‚¹**ï¼š
```
â€¢ æ”¹å˜ç³»ç»ŸçŠ¶æ€
â€¢ é€šå¸¸ä¸è¿”å›æ•°æ®
â€¢ éœ€è¦éªŒè¯ä¸šåŠ¡è§„åˆ™
â€¢ è¦æ±‚å¼ºä¸€è‡´æ€§
```

**å‘½ä»¤å¤„ç†æ¨¡å¼**ï¼š
```java
// å‘½ä»¤å¯¹è±¡ - åŒ…å«æ“ä½œæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯
public class CreateOrderCommand {
    private String customerId;
    private List<OrderItem> items;
    private String deliveryAddress;
    
    // å‘½ä»¤åªåŒ…å«æ•°æ®ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
}

// å‘½ä»¤å¤„ç†å™¨ - å¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
public class CreateOrderHandler {
    
    public void handle(CreateOrderCommand command) {
        // 1. éªŒè¯ä¸šåŠ¡è§„åˆ™
        validateOrder(command);
        
        // 2. åˆ›å»ºé¢†åŸŸå¯¹è±¡
        Order order = new Order(command);
        
        // 3. ä¿å­˜åˆ°å†™æ¨¡å‹
        orderRepository.save(order);
        
        // 4. å‘å¸ƒäº‹ä»¶ï¼ˆç”¨äºè¯»æ¨¡å‹æ›´æ–°ï¼‰
        eventPublisher.publish(new OrderCreatedEvent(order));
    }
}
```

### 2.2 æŸ¥è¯¢ç«¯è®¾è®¡


**æŸ¥è¯¢ï¼ˆQueryï¼‰çš„ç‰¹ç‚¹**ï¼š
```
â€¢ ä¸æ”¹å˜ç³»ç»ŸçŠ¶æ€
â€¢ åªè¿”å›æ•°æ®
â€¢ å¯ä»¥æœ€ç»ˆä¸€è‡´æ€§
â€¢ é’ˆå¯¹æŸ¥è¯¢ä¼˜åŒ–
```

**æŸ¥è¯¢æ¨¡å¼å®ç°**ï¼š
```java
// æŸ¥è¯¢å¯¹è±¡ - æè¿°æŸ¥è¯¢æ¡ä»¶
public class OrderSummaryQuery {
    private String customerId;
    private LocalDate startDate;
    private LocalDate endDate;
}

// æŸ¥è¯¢å¤„ç†å™¨ - ç›´æ¥ä»è¯»æ¨¡å‹è·å–æ•°æ®
public class OrderSummaryHandler {
    
    public OrderSummaryView handle(OrderSummaryQuery query) {
        // ç›´æ¥æŸ¥è¯¢ä¼˜åŒ–åçš„è¯»æ¨¡å‹
        return readModelRepository.getOrderSummary(
            query.getCustomerId(),
            query.getStartDate(), 
            query.getEndDate()
        );
    }
}
```

### 2.3 è¯»å†™æ¨¡å‹å¯¹æ¯”


| ç‰¹å¾ | **å†™æ¨¡å‹ï¼ˆCommand Modelï¼‰** | **è¯»æ¨¡å‹ï¼ˆQuery Modelï¼‰** |
|------|---------------------------|-------------------------|
| **ä¸»è¦ç›®çš„** | `ç»´æŠ¤ä¸šåŠ¡è§„åˆ™ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§` | `æä¾›é«˜æ•ˆæŸ¥è¯¢ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ` |
| **æ•°æ®ç»“æ„** | `è§„èŒƒåŒ–ï¼Œé¢å‘ä¸šåŠ¡é¢†åŸŸ` | `åè§„èŒƒåŒ–ï¼Œé¢å‘æŸ¥è¯¢éœ€æ±‚` |
| **ä¸€è‡´æ€§** | `å¼ºä¸€è‡´æ€§` | `æœ€ç»ˆä¸€è‡´æ€§` |
| **æ€§èƒ½è¦æ±‚** | `å†™å…¥æ€§èƒ½ï¼Œäº‹åŠ¡å®Œæ•´æ€§` | `æŸ¥è¯¢æ€§èƒ½ï¼Œå“åº”é€Ÿåº¦` |
| **æ‰©å±•æ–¹å¼** | `å‚ç›´æ‰©å±•` | `æ°´å¹³æ‰©å±•` |

---

## 3. ğŸ”„ äº‹ä»¶æº¯æºæ ¸å¿ƒæœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æº¯æº


> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**ï¼šäº‹ä»¶æº¯æºå°±åƒé“¶è¡Œæµæ°´è´¦ï¼Œä¸è®°å½•è´¦æˆ·ä½™é¢ï¼Œåªè®°å½•æ¯ç¬”äº¤æ˜“ï¼Œä½™é¢é€šè¿‡å›æ”¾æ‰€æœ‰äº¤æ˜“è®¡ç®—å¾—å‡º

**äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰å®šä¹‰**ï¼š
- **ä¸å­˜å‚¨å½“å‰çŠ¶æ€**ï¼Œåªå­˜å‚¨å¯¼è‡´çŠ¶æ€å˜åŒ–çš„äº‹ä»¶
- **é€šè¿‡é‡æ”¾äº‹ä»¶**æ¥é‡å»ºå¯¹è±¡çš„å½“å‰çŠ¶æ€
- **äº‹ä»¶æ˜¯ä¸å¯å˜çš„**ï¼Œåªèƒ½è¿½åŠ ï¼Œä¸èƒ½ä¿®æ”¹

### 3.2 äº‹ä»¶è®¾è®¡åŸåˆ™


**å¥½çš„äº‹ä»¶åº”è¯¥å…·å¤‡**ï¼š
```
ğŸ”¸ è¿‡å»å¼å‘½åï¼šOrderCreatedï¼ˆä¸æ˜¯CreateOrderï¼‰
ğŸ”¸ åŒ…å«å®Œæ•´ä¿¡æ¯ï¼šé‡å»ºçŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰æ•°æ®
ğŸ”¸ ä¸šåŠ¡å«ä¹‰æ˜ç¡®ï¼šåæ˜ çœŸå®ä¸šåŠ¡æ´»åŠ¨
ğŸ”¸ ç‰ˆæœ¬å…¼å®¹ï¼šè€ƒè™‘äº‹ä»¶ç»“æ„çš„æ¼”è¿›
```

**äº‹ä»¶ç¤ºä¾‹**ï¼š
```java
// äº‹ä»¶åŸºç±»
public abstract class DomainEvent {
    private String eventId;
    private String aggregateId;
    private long version;
    private LocalDateTime occurredOn;
}

// å…·ä½“ä¸šåŠ¡äº‹ä»¶
public class OrderCreatedEvent extends DomainEvent {
    private String customerId;
    private List<OrderItem> items;
    private BigDecimal totalAmount;
    private String deliveryAddress;
    
    // äº‹ä»¶åŒ…å«é‡å»ºçŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯
}

public class OrderStatusChangedEvent extends DomainEvent {
    private String orderId;
    private OrderStatus fromStatus;
    private OrderStatus toStatus;
    private String reason;
}
```

### 3.3 äº‹ä»¶é‡æ”¾æœºåˆ¶


**çŠ¶æ€é‡å»ºè¿‡ç¨‹**ï¼š
```
äº‹ä»¶åºåˆ—ï¼š
1. OrderCreatedEvent
2. PaymentProcessedEvent  
3. OrderShippedEvent
4. OrderDeliveredEvent

é‡æ”¾è¿‡ç¨‹ï¼š
åˆå§‹çŠ¶æ€ â†’ åº”ç”¨äº‹ä»¶1 â†’ åº”ç”¨äº‹ä»¶2 â†’ åº”ç”¨äº‹ä»¶3 â†’ åº”ç”¨äº‹ä»¶4 â†’ å½“å‰çŠ¶æ€
```

**é‡æ”¾å®ç°ç¤ºä¾‹**ï¼š
```java
public class Order {
    private String id;
    private OrderStatus status;
    private List<OrderItem> items;
    private BigDecimal totalAmount;
    
    // é€šè¿‡äº‹ä»¶é‡å»ºå¯¹è±¡çŠ¶æ€
    public static Order fromEvents(List<DomainEvent> events) {
        Order order = new Order();
        for (DomainEvent event : events) {
            order.apply(event);
        }
        return order;
    }
    
    // åº”ç”¨äº‹ä»¶æ”¹å˜çŠ¶æ€
    private void apply(DomainEvent event) {
        if (event instanceof OrderCreatedEvent) {
            apply((OrderCreatedEvent) event);
        } else if (event instanceof OrderStatusChangedEvent) {
            apply((OrderStatusChangedEvent) event);
        }
        // å…¶ä»–äº‹ä»¶å¤„ç†...
    }
    
    private void apply(OrderCreatedEvent event) {
        this.id = event.getAggregateId();
        this.items = event.getItems();
        this.totalAmount = event.getTotalAmount();
        this.status = OrderStatus.CREATED;
    }
}
```

---

## 4. ğŸ—„ï¸ Event Storeè®¾è®¡ä¸å®ç°


### 4.1 Event Storeæ ¸å¿ƒæ¦‚å¿µ


**Event Store**ï¼šä¸“é—¨å­˜å‚¨äº‹ä»¶çš„æ•°æ®åº“ï¼Œæ˜¯äº‹ä»¶æº¯æºæ¶æ„çš„æ ¸å¿ƒ

> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šæŠŠEvent Storeæƒ³è±¡æˆä¸€ä¸ªåªèƒ½è¿½åŠ çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ¯ä¸ªä¸šåŠ¡æ“ä½œéƒ½ä¼šåœ¨æœ«å°¾å†™å…¥ä¸€æ¡äº‹ä»¶è®°å½•

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **ä»…è¿½åŠ **ï¼šäº‹ä»¶ä¸€æ—¦å†™å…¥å°±ä¸å¯ä¿®æ”¹
- **æœ‰åºå­˜å‚¨**ï¼šäº‹ä»¶æŒ‰æ—¶é—´é¡ºåºå­˜å‚¨
- **å¿«é€ŸæŸ¥è¯¢**ï¼šæ”¯æŒæŒ‰èšåˆæ ¹IDå¿«é€ŸæŸ¥è¯¢äº‹ä»¶æµ

### 4.2 Event Storeæ•°æ®æ¨¡å‹


**åŸºç¡€è¡¨ç»“æ„**ï¼š
```sql
-- äº‹ä»¶å­˜å‚¨ä¸»è¡¨
CREATE TABLE event_store (
    event_id VARCHAR(36) PRIMARY KEY,
    aggregate_id VARCHAR(36) NOT NULL,
    aggregate_type VARCHAR(100) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_version BIGINT NOT NULL,
    event_data JSON NOT NULL,
    event_metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ç¡®ä¿åŒä¸€èšåˆçš„ç‰ˆæœ¬å·è¿ç»­
    UNIQUE KEY uk_aggregate_version (aggregate_id, event_version),
    -- æŒ‰èšåˆIDæŸ¥è¯¢çš„ç´¢å¼•
    INDEX idx_aggregate_id (aggregate_id),
    -- æŒ‰æ—¶é—´æŸ¥è¯¢çš„ç´¢å¼•
    INDEX idx_created_at (created_at)
);
```

**äº‹ä»¶æ•°æ®ç¤ºä¾‹**ï¼š
```json
{
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "aggregate_id": "order-12345",
  "aggregate_type": "Order",
  "event_type": "OrderCreatedEvent",
  "event_version": 1,
  "event_data": {
    "customerId": "customer-678",
    "items": [
      {"productId": "prod-001", "quantity": 2, "price": 29.99}
    ],
    "totalAmount": 59.98,
    "deliveryAddress": "åŒ—äº¬å¸‚æœé˜³åŒº..."
  },
  "event_metadata": {
    "userId": "user-123",
    "userAgent": "Chrome/91.0",
    "correlationId": "req-456"
  },
  "created_at": "2025-09-10T14:30:00Z"
}
```

### 4.3 äº‹ä»¶å­˜å‚¨å®ç°


**ç®€åŒ–çš„Event Storeå®ç°**ï¼š
```java
@Repository
public class EventStore {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // ä¿å­˜äº‹ä»¶æµ
    public void saveEvents(String aggregateId, List<DomainEvent> events, long expectedVersion) {
        
        // ä¹è§‚é”æ£€æŸ¥
        validateVersion(aggregateId, expectedVersion);
        
        // æ‰¹é‡æ’å…¥äº‹ä»¶
        for (int i = 0; i < events.size(); i++) {
            DomainEvent event = events.get(i);
            long newVersion = expectedVersion + i + 1;
            
            jdbcTemplate.update(
                "INSERT INTO event_store (event_id, aggregate_id, aggregate_type, " +
                "event_type, event_version, event_data, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
                event.getEventId(),
                aggregateId,
                event.getClass().getSimpleName(),
                event.getClass().getSimpleName(),
                newVersion,
                serializeEvent(event),
                event.getOccurredOn()
            );
        }
    }
    
    // åŠ è½½äº‹ä»¶æµ
    public List<DomainEvent> getEventsForAggregate(String aggregateId) {
        return jdbcTemplate.query(
            "SELECT * FROM event_store WHERE aggregate_id = ? ORDER BY event_version",
            new Object[]{aggregateId},
            (rs, rowNum) -> deserializeEvent(rs.getString("event_data"), rs.getString("event_type"))
        );
    }
}
```

### 4.4 å¿«ç…§ç­–ç•¥


**ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§**ï¼š
- å½“äº‹ä»¶è¿‡å¤šæ—¶ï¼Œé‡æ”¾æ‰€æœ‰äº‹ä»¶ä¼šå¾ˆæ…¢
- å¿«ç…§ä¿å­˜æŸä¸ªæ—¶é—´ç‚¹çš„çŠ¶æ€ï¼Œå‡å°‘é‡æ”¾äº‹ä»¶æ•°é‡

> **ğŸ“Œ ç±»æ¯”è¯´æ˜**ï¼šå°±åƒæ¸¸æˆå­˜æ¡£ï¼Œä¸ç”¨æ¯æ¬¡éƒ½ä»ç¬¬ä¸€å…³å¼€å§‹ï¼Œå¯ä»¥ä»å­˜æ¡£ç‚¹ç»§ç»­

**å¿«ç…§å®ç°**ï¼š
```java
// å¿«ç…§è¡¨
CREATE TABLE aggregate_snapshots (
    aggregate_id VARCHAR(36) PRIMARY KEY,
    aggregate_type VARCHAR(100) NOT NULL,
    snapshot_version BIGINT NOT NULL,
    snapshot_data JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

// å¿«ç…§ç®¡ç†
public class SnapshotStore {
    
    // ä¿å­˜å¿«ç…§ï¼ˆæ¯100ä¸ªäº‹ä»¶ä¿å­˜ä¸€æ¬¡ï¼‰
    public void saveSnapshotIfNeeded(String aggregateId, Object aggregate, long version) {
        if (version % 100 == 0) {
            saveSnapshot(aggregateId, aggregate, version);
        }
    }
    
    // ä»å¿«ç…§+å¢é‡äº‹ä»¶é‡å»ºå¯¹è±¡
    public Order rebuildFromSnapshot(String orderId) {
        // 1. åŠ è½½æœ€è¿‘çš„å¿«ç…§
        Snapshot snapshot = getSnapshot(orderId);
        
        // 2. åŠ è½½å¿«ç…§ä¹‹åçš„äº‹ä»¶
        List<DomainEvent> incrementalEvents = eventStore.getEventsAfterVersion(
            orderId, snapshot.getVersion()
        );
        
        // 3. åº”ç”¨å¢é‡äº‹ä»¶
        Order order = (Order) snapshot.getData();
        incrementalEvents.forEach(order::apply);
        
        return order;
    }
}
```

---

## 5. ğŸ“Š è¯»æ¨¡å‹æŠ•å½±æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯æŠ•å½±


**æŠ•å½±ï¼ˆProjectionï¼‰**ï¼šå°†äº‹ä»¶æµè½¬æ¢ä¸ºé€‚åˆæŸ¥è¯¢çš„æ•°æ®æ¨¡å‹

> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šæŠ•å½±å°±åƒæŠŠç”µå½±èƒ¶ç‰‡ï¼ˆäº‹ä»¶æµï¼‰æŠ•å°„åˆ°å±å¹•ä¸Šï¼ˆè¯»æ¨¡å‹ï¼‰ï¼Œå½¢æˆè§‚ä¼—èƒ½çœ‹æ‡‚çš„ç”»é¢

**æŠ•å½±çš„ä½œç”¨**ï¼š
- **æ•°æ®è½¬æ¢**ï¼šå°†ä¸šåŠ¡äº‹ä»¶è½¬æ¢ä¸ºæŸ¥è¯¢ä¼˜åŒ–çš„æ•°æ®æ ¼å¼
- **è§†å›¾æ„å»º**ï¼šä¸ºä¸åŒçš„æŸ¥è¯¢éœ€æ±‚æ„å»ºä¸“é—¨çš„è§†å›¾
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé¢„è®¡ç®—å¤æ‚æŸ¥è¯¢ç»“æœ

### 5.2 æŠ•å½±æ›´æ–°ç­–ç•¥


**å®æ—¶æŠ•å½± vs æ‰¹é‡æŠ•å½±**ï¼š

| ç­–ç•¥ | **å®æ—¶æŠ•å½±** | **æ‰¹é‡æŠ•å½±** |
|------|-------------|-------------|
| **æ›´æ–°æ—¶æœº** | `äº‹ä»¶å‘ç”Ÿæ—¶ç«‹å³æ›´æ–°` | `å®šæ—¶æ‰¹é‡æ›´æ–°` |
| **ä¸€è‡´æ€§** | `å‡†å®æ—¶ä¸€è‡´` | `æœ€ç»ˆä¸€è‡´` |
| **æ€§èƒ½å½±å“** | `å†™æ“ä½œç¨æ…¢` | `å¯¹å†™æ“ä½œæ— å½±å“` |
| **é€‚ç”¨åœºæ™¯** | `å®æ—¶æŠ¥è¡¨ï¼Œç”¨æˆ·ç•Œé¢` | `æ•°æ®åˆ†æï¼Œå†å²æŠ¥å‘Š` |

**æŠ•å½±æ›´æ–°å®ç°**ï¼š
```java
// äº‹ä»¶ç›‘å¬å™¨ - å®æ—¶æ›´æ–°æŠ•å½±
@EventHandler
public class OrderProjectionUpdater {
    
    @Autowired
    private OrderSummaryRepository summaryRepo;
    
    // è®¢å•åˆ›å»ºäº‹ä»¶å¤„ç†
    public void on(OrderCreatedEvent event) {
        // æ›´æ–°å®¢æˆ·è®¢å•ç»Ÿè®¡
        CustomerOrderSummary summary = summaryRepo.findByCustomerId(event.getCustomerId());
        if (summary == null) {
            summary = new CustomerOrderSummary(event.getCustomerId());
        }
        
        summary.incrementOrderCount();
        summary.addToTotalAmount(event.getTotalAmount());
        summaryRepo.save(summary);
        
        // æ›´æ–°å•†å“é”€å”®ç»Ÿè®¡
        for (OrderItem item : event.getItems()) {
            updateProductSales(item.getProductId(), item.getQuantity());
        }
    }
    
    // è®¢å•çŠ¶æ€å˜æ›´äº‹ä»¶å¤„ç†
    public void on(OrderStatusChangedEvent event) {
        if (event.getToStatus() == OrderStatus.CANCELLED) {
            // æ›´æ–°å–æ¶ˆè®¢å•ç»Ÿè®¡
            updateCancellationStats(event.getAggregateId());
        }
    }
}
```

### 5.3 å¤šè§†å›¾æŠ•å½±


**ä¸ºä¸åŒéœ€æ±‚æ„å»ºä¸åŒè§†å›¾**ï¼š
```sql
-- å®¢æˆ·è®¢å•æ±‡æ€»è§†å›¾ï¼ˆå®¢æœæŸ¥è¯¢ï¼‰
CREATE TABLE customer_order_summary (
    customer_id VARCHAR(36) PRIMARY KEY,
    total_orders INT DEFAULT 0,
    total_amount DECIMAL(10,2) DEFAULT 0,
    last_order_date TIMESTAMP,
    average_order_value DECIMAL(10,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- å•†å“é”€å”®ç»Ÿè®¡è§†å›¾ï¼ˆè¿è¥åˆ†æï¼‰
CREATE TABLE product_sales_stats (
    product_id VARCHAR(36) PRIMARY KEY,
    total_sold INT DEFAULT 0,
    total_revenue DECIMAL(10,2) DEFAULT 0,
    last_sale_date TIMESTAMP,
    average_sale_price DECIMAL(8,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ¯æ—¥è®¢å•æŠ¥è¡¨è§†å›¾ï¼ˆç®¡ç†å†³ç­–ï¼‰
CREATE TABLE daily_order_report (
    report_date DATE PRIMARY KEY,
    order_count INT DEFAULT 0,
    total_revenue DECIMAL(12,2) DEFAULT 0,
    cancelled_count INT DEFAULT 0,
    average_order_value DECIMAL(10,2),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 5.4 æŠ•å½±å®¹é”™å¤„ç†


**å¤„ç†æŠ•å½±æ›´æ–°å¤±è´¥**ï¼š
```java
@Component
public class ProjectionErrorHandler {
    
    // å¤±è´¥é‡è¯•æœºåˆ¶
    @Retryable(value = {Exception.class}, maxAttempts = 3)
    public void updateProjection(DomainEvent event) {
        try {
            projectionUpdater.handle(event);
        } catch (Exception e) {
            log.error("æŠ•å½±æ›´æ–°å¤±è´¥ï¼Œäº‹ä»¶ID: {}, é”™è¯¯: {}", event.getEventId(), e.getMessage());
            
            // è®°å½•å¤±è´¥äº‹ä»¶ï¼Œåç»­è¡¥å¿å¤„ç†
            failedEventRepo.save(new FailedProjectionUpdate(event.getEventId(), e.getMessage()));
            throw e;
        }
    }
    
    // è¡¥å¿å¤„ç† - å®šæ—¶é‡è¯•å¤±è´¥çš„æŠ•å½±æ›´æ–°
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void retryFailedProjections() {
        List<FailedProjectionUpdate> failedUpdates = failedEventRepo.findPendingRetries();
        
        for (FailedProjectionUpdate failedUpdate : failedUpdates) {
            try {
                DomainEvent event = eventStore.getEvent(failedUpdate.getEventId());
                updateProjection(event);
                failedEventRepo.markAsResolved(failedUpdate.getId());
            } catch (Exception e) {
                failedUpdate.incrementRetryCount();
                if (failedUpdate.getRetryCount() > 10) {
                    // è¶…è¿‡é‡è¯•é™åˆ¶ï¼Œæ ‡è®°ä¸ºéœ€è¦äººå·¥å¤„ç†
                    failedUpdate.markAsRequireManualIntervention();
                }
                failedEventRepo.save(failedUpdate);
            }
        }
    }
}
```

---

## 6. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 äº‹ä»¶å­˜å‚¨ä¼˜åŒ–


**åˆ†ç‰‡ç­–ç•¥**ï¼š
```sql
-- æŒ‰èšåˆIDå“ˆå¸Œåˆ†ç‰‡
CREATE TABLE event_store_shard_1 LIKE event_store;
CREATE TABLE event_store_shard_2 LIKE event_store;
CREATE TABLE event_store_shard_3 LIKE event_store;

-- åˆ†ç‰‡è·¯ç”±é€»è¾‘
public class ShardedEventStore {
    
    private int getShardIndex(String aggregateId) {
        return Math.abs(aggregateId.hashCode()) % SHARD_COUNT;
    }
    
    public void saveEvents(String aggregateId, List<DomainEvent> events) {
        int shardIndex = getShardIndex(aggregateId);
        EventStoreRepository shard = getShardRepository(shardIndex);
        shard.saveEvents(aggregateId, events);
    }
}
```

**ç´¢å¼•ä¼˜åŒ–**ï¼š
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_aggregate_id_version ON event_store (aggregate_id, event_version);
CREATE INDEX idx_event_type_created_at ON event_store (event_type, created_at);

-- åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰
CREATE TABLE event_store_2025_09 PARTITION OF event_store
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');
```

### 6.2 è¯»æ¨¡å‹ä¼˜åŒ–


**ç¼“å­˜ç­–ç•¥**ï¼š
```java
@Service
public class OrderQueryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // çƒ­ç‚¹æ•°æ®ç¼“å­˜
    @Cacheable(value = "orderSummary", key = "#customerId")
    public CustomerOrderSummary getCustomerSummary(String customerId) {
        return summaryRepository.findByCustomerId(customerId);
    }
    
    // é¢„çƒ­ç¼“å­˜
    @PostConstruct
    public void preloadCache() {
        List<String> topCustomers = getTopCustomers(1000);
        for (String customerId : topCustomers) {
            CustomerOrderSummary summary = summaryRepository.findByCustomerId(customerId);
            redisTemplate.opsForValue().set("orderSummary::" + customerId, summary, Duration.ofHours(1));
        }
    }
}
```

### 6.3 äº‹ä»¶æµå¤„ç†ä¼˜åŒ–


**æ‰¹å¤„ç†ä¼˜åŒ–**ï¼š
```java
// æ‰¹é‡å¤„ç†äº‹ä»¶ï¼Œæé«˜ååé‡
@Component
public class BatchEventProcessor {
    
    private final BlockingQueue<DomainEvent> eventQueue = new ArrayBlockingQueue<>(10000);
    
    @EventListener
    public void handleEvent(DomainEvent event) {
        eventQueue.offer(event);
    }
    
    @Scheduled(fixedDelay = 1000) // æ¯ç§’å¤„ç†ä¸€æ¬¡
    public void processBatch() {
        List<DomainEvent> batch = new ArrayList<>();
        eventQueue.drainTo(batch, 100); // æ¯æ¬¡æœ€å¤šå¤„ç†100ä¸ªäº‹ä»¶
        
        if (!batch.isEmpty()) {
            processBatchEvents(batch);
        }
    }
    
    private void processBatchEvents(List<DomainEvent> events) {
        // æŒ‰äº‹ä»¶ç±»å‹åˆ†ç»„æ‰¹é‡å¤„ç†
        Map<String, List<DomainEvent>> eventsByType = events.stream()
            .collect(Collectors.groupingBy(e -> e.getClass().getSimpleName()));
            
        for (Map.Entry<String, List<DomainEvent>> entry : eventsByType.entrySet()) {
            batchUpdateProjection(entry.getKey(), entry.getValue());
        }
    }
}
```

### 6.4 æŸ¥è¯¢åŠ é€ŸæŠ€æœ¯


**æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ä¼˜åŒ–**ï¼š
```java
// æ—¶é—´æ—…è¡ŒæŸ¥è¯¢ - æŸ¥çœ‹å†å²çŠ¶æ€
public class TimeTrialQueryService {
    
    // æŸ¥è¯¢æŒ‡å®šæ—¶é—´ç‚¹çš„çŠ¶æ€
    public Order getOrderStateAt(String orderId, LocalDateTime pointInTime) {
        
        // 1. å…ˆæŸ¥æ‰¾æ—¶é—´ç‚¹å‰æœ€è¿‘çš„å¿«ç…§
        Snapshot snapshot = snapshotStore.getLatestSnapshotBefore(orderId, pointInTime);
        
        // 2. è·å–å¿«ç…§ååˆ°æŒ‡å®šæ—¶é—´çš„äº‹ä»¶
        List<DomainEvent> events = eventStore.getEventsBetween(
            orderId, 
            snapshot != null ? snapshot.getVersion() : 0,
            pointInTime
        );
        
        // 3. é‡å»ºçŠ¶æ€
        Order order = snapshot != null ? 
            (Order) snapshot.getData() : 
            new Order();
            
        events.forEach(order::apply);
        return order;
    }
}
```

**äº‹ä»¶å‹ç¼©ç­–ç•¥**ï¼š
```java
// å®šæœŸå‹ç¼©å†å²äº‹ä»¶ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´
@Service
public class EventCompactionService {
    
    // å‹ç¼©ç­–ç•¥ï¼šä¿ç•™å…³é”®äº‹ä»¶ï¼Œåˆå¹¶ä¸­é—´çŠ¶æ€
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void compactOldEvents() {
        LocalDateTime cutoffDate = LocalDateTime.now().minusMonths(6);
        
        List<String> aggregateIds = eventStore.getAggregateIdsOlderThan(cutoffDate);
        
        for (String aggregateId : aggregateIds) {
            compactAggregateEvents(aggregateId, cutoffDate);
        }
    }
    
    private void compactAggregateEvents(String aggregateId, LocalDateTime cutoffDate) {
        // 1. è·å–æˆªæ­¢æ—¥æœŸå‰çš„æ‰€æœ‰äº‹ä»¶
        List<DomainEvent> oldEvents = eventStore.getEventsBeforeDate(aggregateId, cutoffDate);
        
        // 2. é‡å»ºçŠ¶æ€å¹¶åˆ›å»ºå¿«ç…§
        Order finalState = Order.fromEvents(oldEvents);
        snapshotStore.saveSnapshot(aggregateId, finalState, oldEvents.size());
        
        // 3. åˆ é™¤å·²å‹ç¼©çš„äº‹ä»¶ï¼ˆä¿ç•™æœ€è¿‘çš„å…³é”®äº‹ä»¶ï¼‰
        eventStore.deleteEventsBeforeVersion(aggregateId, oldEvents.size() - 10);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ CQRSï¼šå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼Œè¯»å†™ç”¨ä¸åŒçš„æ¨¡å‹å’Œæ•°æ®åº“
ğŸ”¸ äº‹ä»¶æº¯æºï¼šä¸å­˜å½“å‰çŠ¶æ€ï¼Œå­˜äº‹ä»¶æµï¼Œé€šè¿‡é‡æ”¾äº‹ä»¶é‡å»ºçŠ¶æ€  
ğŸ”¸ Event Storeï¼šä¸“é—¨å­˜å‚¨äº‹ä»¶çš„æ•°æ®åº“ï¼Œåªè¿½åŠ ä¸ä¿®æ”¹
ğŸ”¸ æŠ•å½±ï¼šå°†äº‹ä»¶æµè½¬æ¢ä¸ºæŸ¥è¯¢ä¼˜åŒ–çš„è¯»æ¨¡å‹
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå†™æ“ä½œå®Œæˆåï¼Œè¯»æ¨¡å‹å»¶è¿Ÿæ›´æ–°
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CQRSè§£å†³ä»€ä¹ˆé—®é¢˜**ï¼š
```
ä¼ ç»Ÿé—®é¢˜ï¼š
â€¢ ä¸€ä¸ªæ¨¡å‹æ—¢è¦æ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œåˆè¦æ”¯æŒå¤æ‚æŸ¥è¯¢
â€¢ è¯»å†™æ“ä½œç›¸äº’å½±å“ï¼Œéš¾ä»¥ç‹¬ç«‹ä¼˜åŒ–
â€¢ æ‰©å±•å›°éš¾ï¼Œæ— æ³•é’ˆå¯¹æ€§æå‡æ€§èƒ½

CQRSä¼˜åŠ¿ï¼š
â€¢ è¯»å†™åˆ†ç¦»ï¼Œå„è‡ªä¼˜åŒ–
â€¢ å†™æ¨¡å‹ä¸“æ³¨ä¸šåŠ¡è§„åˆ™ï¼Œè¯»æ¨¡å‹ä¸“æ³¨æŸ¥è¯¢æ€§èƒ½
â€¢ å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œè¯»å†™æ•°æ®åº“å¯ä»¥ä¸åŒæŠ€æœ¯
```

**ğŸ”¹ äº‹ä»¶æº¯æºçš„æ ¸å¿ƒä»·å€¼**ï¼š
```
ä¸šåŠ¡ä»·å€¼ï¼š
â€¢ å®Œæ•´çš„å®¡è®¡æ—¥å¿—ï¼Œæ‰€æœ‰æ“ä½œéƒ½å¯è¿½æº¯
â€¢ æ”¯æŒæ—¶é—´æ—…è¡ŒæŸ¥è¯¢ï¼Œå¯ä»¥æŸ¥çœ‹ä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€
â€¢ ä¸šåŠ¡åˆ†æï¼Œå¯ä»¥é‡æ–°åˆ†æå†å²æ•°æ®

æŠ€æœ¯ä»·å€¼ï¼š  
â€¢ é«˜æ€§èƒ½å†™å…¥ï¼Œåªéœ€è¦è¿½åŠ äº‹ä»¶
â€¢ æ•°æ®æ¢å¤ï¼Œå¯ä»¥é‡æ–°è®¡ç®—ä»»ä½•æ—¶é—´ç‚¹çš„çŠ¶æ€
â€¢ ç³»ç»Ÿæ¼”è¿›ï¼Œå¯ä»¥ç”¨æ–°é€»è¾‘å¤„ç†å†å²äº‹ä»¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç‚¹**ï¼š
```
å­˜å‚¨ä¼˜åŒ–ï¼š
â€¢ äº‹ä»¶åˆ†ç‰‡ï¼Œé¿å…å•è¡¨è¿‡å¤§
â€¢ å¿«ç…§æœºåˆ¶ï¼Œé¿å…é‡æ”¾è¿‡å¤šäº‹ä»¶
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼ŒåŠ é€Ÿäº‹ä»¶æŸ¥è¯¢

å¤„ç†ä¼˜åŒ–ï¼š
â€¢ æ‰¹é‡å¤„ç†ï¼Œæé«˜äº‹ä»¶å¤„ç†ååé‡
â€¢ å¼‚æ­¥æŠ•å½±ï¼Œä¸é˜»å¡å†™æ“ä½œ
â€¢ ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼ŒåŠ é€ŸæŸ¥è¯¢å“åº”
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“‹ é€‚ç”¨åœºæ™¯åˆ¤æ–­**ï¼š
```
âœ… é€‚åˆCQRS+äº‹ä»¶æº¯æºï¼š
â€¢ å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œéœ€è¦ä¸¥æ ¼å®¡è®¡
â€¢ è¯»å†™æ¯”ä¾‹å¤±è¡¡ï¼ˆè¯»å¤šå†™å°‘ï¼‰
â€¢ é«˜å¹¶å‘è¦æ±‚ï¼Œéœ€è¦ç‹¬ç«‹æ‰©å±•
â€¢ æ•°æ®åˆ†æéœ€æ±‚ï¼Œéœ€è¦å†å²æ•°æ®æŒ–æ˜

âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š
â€¢ ç®€å•CRUDåº”ç”¨
â€¢ è¯»å†™æ¯”ä¾‹å‡è¡¡  
â€¢ å›¢é˜Ÿç»éªŒä¸è¶³
â€¢ å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„å®æ—¶ç³»ç»Ÿ
```

**ğŸ› ï¸ å®æ–½å»ºè®®**ï¼š
```
æ¸è¿›å¼æ¼”è¿›ï¼š
1. å…ˆå¼•å…¥CQRSï¼Œè¯»å†™åˆ†ç¦»
2. é€æ­¥å¼•å…¥äº‹ä»¶æº¯æºï¼Œæ›¿æ¢éƒ¨åˆ†æ ¸å¿ƒä¸šåŠ¡
3. å®Œå–„ç›‘æ§å’Œè¿ç»´å·¥å…·
4. å›¢é˜ŸæŠ€èƒ½å»ºè®¾ï¼ŒåŸ¹è®­ç›¸å…³æŠ€æœ¯

æŠ€æœ¯é€‰å‹ï¼š
â€¢ äº‹ä»¶å­˜å‚¨ï¼šMySQLã€PostgreSQLã€EventStore
â€¢ æ¶ˆæ¯ä¸­é—´ä»¶ï¼šRabbitMQã€Apache Kafka  
â€¢ è¯»æ¨¡å‹å­˜å‚¨ï¼šRedisã€Elasticsearchã€MongoDB
â€¢ ç¼“å­˜å±‚ï¼šRedisã€Memcached
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- CQRSè¯»å†™åˆ†ä¸¤è¾¹ï¼Œå„è‡ªä¼˜åŒ–ä¸ç›¸å¹²
- äº‹ä»¶æº¯æºå­˜æµæ°´ï¼Œé‡æ”¾å†å²è§çœŸç«   
- æŠ•å½±æ„å»ºè¯»æ¨¡å‹ï¼Œæœ€ç»ˆä¸€è‡´æ€§èƒ½å¥½
- å¿«ç…§å‹ç¼©æ§å­˜å‚¨ï¼Œæ‰¹é‡å¤„ç†ææ€§èƒ½

**å…³é”®æˆåŠŸå› ç´ **ï¼š
- **å›¢é˜ŸæŠ€èƒ½**ï¼šéœ€è¦å¯¹DDDã€å¼‚æ­¥å¤„ç†æœ‰æ·±å…¥ç†è§£
- **ç›‘æ§è¿ç»´**ï¼šäº‹ä»¶æº¯æºç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å¾ˆé‡è¦
- **æ•°æ®æ²»ç†**ï¼šäº‹ä»¶ç‰ˆæœ¬ç®¡ç†å’Œæ•°æ®è¿ç§»ç­–ç•¥
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹æŒç»­ä¼˜åŒ–å­˜å‚¨å’ŒæŸ¥è¯¢