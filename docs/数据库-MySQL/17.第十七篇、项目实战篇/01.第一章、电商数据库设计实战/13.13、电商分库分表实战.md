---
title: 13ã€ç”µå•†åˆ†åº“åˆ†è¡¨å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [åˆ†åº“åˆ†è¡¨ç­–ç•¥æ¦‚è¿°](#1-åˆ†åº“åˆ†è¡¨ç­–ç•¥æ¦‚è¿°)
2. [åˆ†ç‰‡é”®é€‰æ‹©ä¸ç­–ç•¥](#2-åˆ†ç‰‡é”®é€‰æ‹©ä¸ç­–ç•¥)
3. [åˆ†ç‰‡è·¯ç”±ç®—æ³•è®¾è®¡](#3-åˆ†ç‰‡è·¯ç”±ç®—æ³•è®¾è®¡)
4. [è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†](#4-è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†)
5. [åœ¨çº¿æ‰©å®¹ä¸æ•°æ®è¿ç§»](#5-åœ¨çº¿æ‰©å®¹ä¸æ•°æ®è¿ç§»)
6. [åˆ†å¸ƒå¼äº‹åŠ¡ä¸ä¸€è‡´æ€§](#6-åˆ†å¸ƒå¼äº‹åŠ¡ä¸ä¸€è‡´æ€§)
7. [æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§](#7-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åˆ†åº“åˆ†è¡¨ç­–ç•¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åˆ†åº“åˆ†è¡¨


**ç®€å•ç†è§£**ï¼šæŠŠä¸€ä¸ªå¤§æ•°æ®åº“æ‹†åˆ†æˆå¤šä¸ªå°æ•°æ®åº“ï¼ŒæŠŠä¸€å¼ å¤§è¡¨æ‹†åˆ†æˆå¤šå¼ å°è¡¨

```
å•åº“å•è¡¨ï¼ˆä¼ ç»Ÿï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”µå•†æ•°æ®åº“     â”‚
â”‚  â”œâ”€ usersè¡¨     â”‚ â† 1000ä¸‡ç”¨æˆ·
â”‚  â”œâ”€ ordersè¡¨    â”‚ â† 5000ä¸‡è®¢å•
â”‚  â””â”€ productsè¡¨  â”‚ â† 100ä¸‡å•†å“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†åº“åˆ†è¡¨ï¼ˆæ‹†åˆ†åï¼‰ï¼š
åº“1: ecommerce_db_0    åº“2: ecommerce_db_1    åº“3: ecommerce_db_2
â”œâ”€ users_0            â”œâ”€ users_1            â”œâ”€ users_2
â”œâ”€ orders_0           â”œâ”€ orders_1           â”œâ”€ orders_2
â””â”€ products_0         â””â”€ products_1         â””â”€ products_2
```

**ä¸ºä»€ä¹ˆè¦åˆ†åº“åˆ†è¡¨**ï¼š
- ğŸ“Š **æ•°æ®é‡é—®é¢˜**ï¼šå•è¡¨è¶…è¿‡1000ä¸‡è®°å½•æ€§èƒ½ä¸‹é™æ˜æ˜¾
- âš¡ **å¹¶å‘é—®é¢˜**ï¼šå•åº“è¿æ¥æ•°é™åˆ¶ï¼Œæ— æ³•æ”¯æ’‘é«˜å¹¶å‘
- ğŸ’¾ **å­˜å‚¨é—®é¢˜**ï¼šå•æœºç£ç›˜å®¹é‡æœ‰é™
- ğŸ”§ **ç»´æŠ¤é—®é¢˜**ï¼šå¤‡ä»½æ¢å¤æ—¶é—´è¿‡é•¿

### 1.2 åˆ†åº“åˆ†è¡¨åŸºæœ¬ç±»å‹


**ğŸ”¸ å‚ç›´æ‹†åˆ†**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—æ‹†åˆ†
```
åŸå§‹æ•°æ®åº“ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”µå•†æ•°æ®åº“     â”‚
â”‚  â”œâ”€ usersè¡¨     â”‚
â”‚  â”œâ”€ ordersè¡¨    â”‚
â”‚  â”œâ”€ productsè¡¨  â”‚
â”‚  â””â”€ paymentsè¡¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å‚ç›´æ‹†åˆ†åï¼š
ç”¨æˆ·åº“          è®¢å•åº“          å•†å“åº“
â”œâ”€ users       â”œâ”€ orders       â”œâ”€ products
â””â”€ profiles    â”œâ”€ order_items  â””â”€ categories
               â””â”€ payments
```

**ğŸ”¸ æ°´å¹³æ‹†åˆ†**ï¼šæŒ‰æ•°æ®é‡æ‹†åˆ†
```
æ°´å¹³åˆ†è¡¨ï¼š
usersè¡¨ â†’ users_0, users_1, users_2, users_3

åˆ†ç‰‡è§„åˆ™ï¼š
user_id % 4 = 0 â†’ users_0
user_id % 4 = 1 â†’ users_1  
user_id % 4 = 2 â†’ users_2
user_id % 4 = 3 â†’ users_3
```

### 1.3 ç”µå•†å…¸å‹åˆ†ç‰‡æ¶æ„


```
åº”ç”¨å±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ†ç‰‡ä»£ç†å±‚     â”‚ â† ShardingSphereã€Mycat
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è·¯ç”±è§£æ       â”‚ â† SQLè§£æã€åˆ†ç‰‡è·¯ç”±
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç»“æœåˆå¹¶       â”‚ â† è·¨åˆ†ç‰‡ç»“æœèšåˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åˆ†ç‰‡æ•°æ®åº“é›†ç¾¤
â”œâ”€ åˆ†ç‰‡1ï¼šç”¨æˆ·0-249ä¸‡
â”œâ”€ åˆ†ç‰‡2ï¼šç”¨æˆ·250-499ä¸‡  
â”œâ”€ åˆ†ç‰‡3ï¼šç”¨æˆ·500-749ä¸‡
â””â”€ åˆ†ç‰‡4ï¼šç”¨æˆ·750-999ä¸‡
```

---

## 2. ğŸ”‘ åˆ†ç‰‡é”®é€‰æ‹©ä¸ç­–ç•¥


### 2.1 åˆ†ç‰‡é”®é€‰æ‹©åŸåˆ™


**ä»€ä¹ˆæ˜¯åˆ†ç‰‡é”®**ï¼šå†³å®šæ•°æ®å­˜å‚¨åœ¨å“ªä¸ªåˆ†ç‰‡çš„å…³é”®å­—æ®µ

**é€‰æ‹©åŸåˆ™**ï¼š
- âœ… **æŸ¥è¯¢é¢‘ç‡é«˜**ï¼šå¤§éƒ¨åˆ†æŸ¥è¯¢éƒ½åŒ…å«åˆ†ç‰‡é”®
- âœ… **åˆ†å¸ƒå‡åŒ€**ï¼šæ•°æ®èƒ½å‡åŒ€åˆ†å¸ƒåˆ°å„åˆ†ç‰‡
- âœ… **ç›¸å…³æ€§å¼º**ï¼šç›¸å…³æ•°æ®å­˜å‚¨åœ¨åŒä¸€åˆ†ç‰‡
- âŒ **é¿å…çƒ­ç‚¹**ï¼šé¿å…æŸäº›åˆ†ç‰‡è¿‡çƒ­

### 2.2 ç”¨æˆ·ç»´åº¦åˆ†ç‰‡ç­–ç•¥


**æŒ‰ç”¨æˆ·IDåˆ†ç‰‡**ï¼š
```sql
-- åˆ†ç‰‡é”®ï¼šuser_id
-- åˆ†ç‰‡è§„åˆ™ï¼šuser_id % 8

-- ç”¨æˆ·è¡¨åˆ†ç‰‡
CREATE TABLE users_0 (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    created_at TIMESTAMP
);

-- è®¢å•è¡¨åˆ†ç‰‡ï¼ˆæŒ‰ç”¨æˆ·ç»´åº¦ï¼‰
CREATE TABLE orders_0 (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,           -- åˆ†ç‰‡é”®
    order_status INT,
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

**ç”¨æˆ·ç»´åº¦åˆ†ç‰‡ä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·ç›¸å…³æ•°æ®èšåˆåœ¨ä¸€èµ·
- âœ… æŸ¥è¯¢ç”¨æˆ·è®¢å•æ— éœ€è·¨åˆ†ç‰‡
- âœ… ç”¨æˆ·ç»´åº¦ç»Ÿè®¡æŸ¥è¯¢é«˜æ•ˆ

**ç”¨æˆ·ç»´åº¦åˆ†ç‰‡åŠ£åŠ¿**ï¼š
- âŒ æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢éœ€è¦è·¨åˆ†ç‰‡
- âŒ å…¨å±€ç»Ÿè®¡æŸ¥è¯¢å¤æ‚
- âŒ å¯èƒ½å­˜åœ¨ç”¨æˆ·æ´»è·ƒåº¦å·®å¼‚å¯¼è‡´çš„æ•°æ®å€¾æ–œ

### 2.3 è®¢å•ç»´åº¦åˆ†ç‰‡ç­–ç•¥


**æŒ‰è®¢å•åˆ›å»ºæ—¶é—´åˆ†ç‰‡**ï¼š
```sql
-- åˆ†ç‰‡é”®ï¼šcreated_at
-- åˆ†ç‰‡è§„åˆ™ï¼šæŒ‰å¹´æœˆåˆ†ç‰‡

-- 2024å¹´1æœˆè®¢å•è¡¨
CREATE TABLE orders_202401 (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,
    order_status INT,
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP
);

-- 2024å¹´2æœˆè®¢å•è¡¨  
CREATE TABLE orders_202402 (
    -- ç›¸åŒç»“æ„
);
```

**è®¢å•ç»´åº¦åˆ†ç‰‡ä¼˜åŠ¿**ï¼š
- âœ… æ—¶é—´èŒƒå›´æŸ¥è¯¢é«˜æ•ˆ
- âœ… å†å²æ•°æ®å½’æ¡£ç®€å•
- âœ… çƒ­ç‚¹æ•°æ®åˆ†ç¦»æ˜ç¡®

**è®¢å•ç»´åº¦åˆ†ç‰‡åŠ£åŠ¿**ï¼š
- âŒ æŸ¥è¯¢ç”¨æˆ·è®¢å•éœ€è¦è·¨åˆ†ç‰‡
- âŒ ä¸åŒæ—¶é—´æ®µæ•°æ®é‡å·®å¼‚å¤§
- âŒ èŠ‚å‡æ—¥å¯èƒ½äº§ç”Ÿçƒ­ç‚¹

### 2.4 æ··åˆåˆ†ç‰‡ç­–ç•¥


**å¤åˆåˆ†ç‰‡é”®è®¾è®¡**ï¼š
```sql
-- å…ˆæŒ‰ç”¨æˆ·åˆ†åº“ï¼Œå†æŒ‰æ—¶é—´åˆ†è¡¨
åº“è·¯ç”±ï¼šuser_id % 4
è¡¨è·¯ç”±ï¼šDATE_FORMAT(created_at, '%Y%m')

-- åˆ†ç‰‡ç¤ºä¾‹ï¼š
ç”¨æˆ·123456çš„2024å¹´3æœˆè®¢å• â†’
åº“ï¼š123456 % 4 = 0 â†’ db_0
è¡¨ï¼š202403 â†’ orders_202403

å®Œæ•´è¡¨åï¼šdb_0.orders_202403
```

---

## 3. ğŸ”„ åˆ†ç‰‡è·¯ç”±ç®—æ³•è®¾è®¡


### 3.1 ä¸€è‡´æ€§Hashç®—æ³•


**ç®—æ³•åŸç†**ï¼š
```
Hashç¯ï¼ˆ0 - 2^32-1ï¼‰ï¼š
     èŠ‚ç‚¹A(100)
         â†‘
    2^32-1 â†â”€â”€â”€â”€â”€â†’ 0
         â†“         â†“
   èŠ‚ç‚¹D(300)    èŠ‚ç‚¹B(800)
         â†‘
     èŠ‚ç‚¹C(200)

æ•°æ®è·¯ç”±ï¼š
user_id=12345 â†’ hash(12345)=150 â†’ é¡ºæ—¶é’ˆæ‰¾åˆ°èŠ‚ç‚¹B
user_id=67890 â†’ hash(67890)=350 â†’ é¡ºæ—¶é’ˆæ‰¾åˆ°èŠ‚ç‚¹A
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
public class ConsistentHashRouter {
    private TreeMap<Long, String> hashRing = new TreeMap<>();
    private int virtualNodes = 100; // è™šæ‹ŸèŠ‚ç‚¹æ•°
    
    public void addNode(String node) {
        for (int i = 0; i < virtualNodes; i++) {
            String virtualNode = node + "#" + i;
            long hash = hash(virtualNode);
            hashRing.put(hash, node);
        }
    }
    
    public String route(String key) {
        long hash = hash(key);
        Map.Entry<Long, String> entry = hashRing.ceilingEntry(hash);
        return entry != null ? entry.getValue() : hashRing.firstEntry().getValue();
    }
}
```

**ä¸€è‡´æ€§Hashä¼˜åŠ¿**ï¼š
- âœ… èŠ‚ç‚¹å¢å‡æ—¶æ•°æ®è¿ç§»é‡æœ€å°
- âœ… åˆ†å¸ƒç›¸å¯¹å‡åŒ€
- âœ… æ‰©å®¹ç¼©å®¹å‹å¥½

### 3.2 èŒƒå›´åˆ†ç‰‡ç®—æ³•


**æŒ‰èŒƒå›´åˆ’åˆ†**ï¼š
```sql
-- ç”¨æˆ·IDèŒƒå›´åˆ†ç‰‡
åˆ†ç‰‡1ï¼šuser_id 1-1000000
åˆ†ç‰‡2ï¼šuser_id 1000001-2000000  
åˆ†ç‰‡3ï¼šuser_id 2000001-3000000
åˆ†ç‰‡4ï¼šuser_id 3000001-4000000

-- è·¯ç”±é€»è¾‘
SELECT shard_id FROM shard_config 
WHERE min_value <= 12345 AND max_value >= 12345;
```

**èŒƒå›´åˆ†ç‰‡é…ç½®è¡¨**ï¼š
```sql
CREATE TABLE shard_config (
    shard_id INT,
    table_name VARCHAR(50),
    min_value BIGINT,
    max_value BIGINT,
    db_name VARCHAR(50)
);

INSERT INTO shard_config VALUES
(1, 'users', 1, 1000000, 'ecommerce_db_0'),
(2, 'users', 1000001, 2000000, 'ecommerce_db_1');
```

### 3.3 è·¯ç”±ç®—æ³•ä¼˜åŒ–


**é¢„è®¡ç®—è·¯ç”±è¡¨**ï¼š
```java
public class OptimizedRouter {
    // é¢„è®¡ç®—è·¯ç”±æ˜ å°„
    private Map<Integer, String> routeMap = new HashMap<>();
    
    public void initRouteMap() {
        // é¢„è®¡ç®—æ‰€æœ‰å¯èƒ½çš„è·¯ç”±ç»“æœ
        for (int i = 0; i < 1000000; i++) {
            int shardId = i % 8;
            routeMap.put(i, "db_" + shardId);
        }
    }
    
    public String fastRoute(int userId) {
        return routeMap.get(userId % 1000000);
    }
}
```

**è·¯ç”±ç¼“å­˜æœºåˆ¶**ï¼š
```java
@Service
public class ShardingService {
    @Cacheable(value = "shardRoute", key = "#userId")
    public String getShardInfo(Long userId) {
        // å¤æ‚è·¯ç”±è®¡ç®—é€»è¾‘
        return calculateShard(userId);
    }
}
```

---

## 4. ğŸ” è·¨åˆ†ç‰‡æŸ¥è¯¢å¤„ç†


### 4.1 è·¨åˆ†ç‰‡èšåˆæŸ¥è¯¢


**åˆ†å¸ƒå¼èšåˆæµç¨‹**ï¼š
```
æŸ¥è¯¢ï¼šSELECT COUNT(*), AVG(amount) FROM orders WHERE status = 1

æ‰§è¡Œæµç¨‹ï¼š
åº”ç”¨å±‚
  â†“ è§£æSQLï¼Œè¯†åˆ«éœ€è¦æŸ¥è¯¢çš„åˆ†ç‰‡
åˆ†ç‰‡1: SELECT COUNT(*) as cnt1, SUM(amount) as sum1, COUNT(amount) as count1
åˆ†ç‰‡2: SELECT COUNT(*) as cnt2, SUM(amount) as sum2, COUNT(amount) as count2  
åˆ†ç‰‡3: SELECT COUNT(*) as cnt3, SUM(amount) as sum3, COUNT(amount) as count3
  â†“ æ”¶é›†å„åˆ†ç‰‡ç»“æœ
åº”ç”¨å±‚åˆå¹¶ï¼š
total_count = cnt1 + cnt2 + cnt3
avg_amount = (sum1 + sum2 + sum3) / (count1 + count2 + count3)
```

**èšåˆæŸ¥è¯¢ä¼˜åŒ–å®ç°**ï¼š
```java
public class DistributedAggregator {
    public AggregateResult aggregateCount(String sql, List<String> shards) {
        List<Future<Long>> futures = new ArrayList<>();
        
        for (String shard : shards) {
            futures.add(executor.submit(() -> {
                return jdbcTemplate.queryForObject(sql, Long.class, shard);
            }));
        }
        
        return futures.stream()
            .mapToLong(f -> f.get())
            .sum();
    }
    
    public AggregateResult aggregateAvg(String sql, List<String> shards) {
        // SUMå’ŒCOUNTåˆ†åˆ«èšåˆï¼Œæœ€åè®¡ç®—å¹³å‡å€¼
        long totalSum = 0, totalCount = 0;
        
        for (String shard : shards) {
            Result result = executeSumCount(sql, shard);
            totalSum += result.getSum();
            totalCount += result.getCount();
        }
        
        return totalCount > 0 ? totalSum / totalCount : 0;
    }
}
```

### 4.2 è·¨åˆ†ç‰‡JOINä¼˜åŒ–


**é—®é¢˜åœºæ™¯**ï¼šç”¨æˆ·è¡¨å’Œè®¢å•è¡¨åœ¨ä¸åŒåˆ†ç‰‡
```sql
-- åŸå§‹æŸ¥è¯¢
SELECT u.username, o.order_id, o.total_amount
FROM users u JOIN orders o ON u.user_id = o.user_id
WHERE u.city = 'Beijing' AND o.created_at > '2024-01-01';
```

**ä¼˜åŒ–ç­–ç•¥1ï¼šåº”ç”¨å±‚JOIN**
```java
public class ApplicationJoinProcessor {
    public List<UserOrderResult> joinUserOrders(String city, Date date) {
        // 1. å…ˆæŸ¥è¯¢ç”¨æˆ·
        List<User> users = queryUsers("SELECT * FROM users WHERE city = ?", city);
        
        // 2. æ‰¹é‡æŸ¥è¯¢è®¢å•
        List<Long> userIds = users.stream().map(User::getId).collect(toList());
        List<Order> orders = batchQueryOrders(userIds, date);
        
        // 3. å†…å­˜ä¸­JOIN
        return joinInMemory(users, orders);
    }
}
```

**ä¼˜åŒ–ç­–ç•¥2ï¼šæ•°æ®å†—ä½™**
```sql
-- è®¢å•è¡¨å†—ä½™ç”¨æˆ·ä¿¡æ¯
CREATE TABLE orders_0 (
    order_id BIGINT PRIMARY KEY,
    user_id BIGINT,
    username VARCHAR(50),    -- å†—ä½™ç”¨æˆ·å
    user_city VARCHAR(50),   -- å†—ä½™åŸå¸‚
    total_amount DECIMAL(10,2)
);

-- å•è¡¨æŸ¥è¯¢
SELECT username, order_id, total_amount 
FROM orders_0 
WHERE user_city = 'Beijing' AND created_at > '2024-01-01';
```

### 4.3 åˆ†é¡µæŸ¥è¯¢å¤„ç†


**è·¨åˆ†ç‰‡åˆ†é¡µéš¾ç‚¹**ï¼š
```
æŸ¥è¯¢ï¼šSELECT * FROM orders ORDER BY created_at DESC LIMIT 20 OFFSET 100

é—®é¢˜ï¼š
- æ¯ä¸ªåˆ†ç‰‡éƒ½æœ‰è‡ªå·±çš„æ’åº
- æ— æ³•ç¡®å®šå…¨å±€ç¬¬101-120æ¡è®°å½•åœ¨å“ªä¸ªåˆ†ç‰‡
- ç®€å•çš„OFFSETåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¸é€‚ç”¨
```

**è§£å†³æ–¹æ¡ˆï¼šæ¸¸æ ‡åˆ†é¡µ**
```java
public class DistributedPagination {
    public PageResult<Order> getOrdersAfterCursor(String cursor, int limit) {
        List<Order> allResults = new ArrayList<>();
        
        // ä»æ¯ä¸ªåˆ†ç‰‡è·å–æ•°æ®
        for (String shard : shards) {
            String sql = "SELECT * FROM orders WHERE created_at < ? " +
                        "ORDER BY created_at DESC LIMIT ?";
            List<Order> shardResults = query(shard, sql, cursor, limit);
            allResults.addAll(shardResults);
        }
        
        // å…¨å±€æ’åºå¹¶å–å‰limitæ¡
        return allResults.stream()
            .sorted((o1, o2) -> o2.getCreatedAt().compareTo(o1.getCreatedAt()))
            .limit(limit)
            .collect(toList());
    }
}
```

---

## 5. ğŸ“ˆ åœ¨çº¿æ‰©å®¹ä¸æ•°æ®è¿ç§»


### 5.1 åŠ¨æ€åˆ†ç‰‡æ‰©å®¹


**æ‰©å®¹åœºæ™¯**ï¼š4ä¸ªåˆ†ç‰‡æ‰©å®¹åˆ°8ä¸ªåˆ†ç‰‡
```
æ‰©å®¹å‰ï¼š
åˆ†ç‰‡0: user_id % 4 = 0  (0, 4, 8, 12...)
åˆ†ç‰‡1: user_id % 4 = 1  (1, 5, 9, 13...)
åˆ†ç‰‡2: user_id % 4 = 2  (2, 6, 10, 14...)
åˆ†ç‰‡3: user_id % 4 = 3  (3, 7, 11, 15...)

æ‰©å®¹åï¼š
åˆ†ç‰‡0: user_id % 8 = 0  (0, 8, 16, 24...)
åˆ†ç‰‡1: user_id % 8 = 1  (1, 9, 17, 25...)
...
åˆ†ç‰‡7: user_id % 8 = 7  (7, 15, 23, 31...)
```

**æ•°æ®è¿ç§»ç­–ç•¥**ï¼š
```java
public class OnlineExpansion {
    public void expandShards(int oldShardCount, int newShardCount) {
        // 1. åˆ›å»ºæ–°åˆ†ç‰‡
        createNewShards(newShardCount - oldShardCount);
        
        // 2. æ•°æ®è¿ç§»
        for (int oldShard = 0; oldShard < oldShardCount; oldShard++) {
            migrateShardData(oldShard, oldShardCount, newShardCount);
        }
        
        // 3. åˆ‡æ¢è·¯ç”±é…ç½®
        updateRoutingConfig(newShardCount);
    }
    
    private void migrateShardData(int shardId, int oldCount, int newCount) {
        String sql = "SELECT * FROM users_" + shardId;
        List<User> users = queryUsers(sql);
        
        for (User user : users) {
            int newShardId = (int)(user.getId() % newCount);
            if (newShardId != shardId) {
                // éœ€è¦è¿ç§»åˆ°æ–°åˆ†ç‰‡
                insertUser(newShardId, user);
                deleteUser(shardId, user.getId());
            }
        }
    }
}
```

### 5.2 é›¶åœæœºè¿ç§»æ–¹æ¡ˆ


**åŒå†™æ–¹æ¡ˆ**ï¼š
```
è¿ç§»æ­¥éª¤ï¼š
1. æ­å»ºæ–°åˆ†ç‰‡ç¯å¢ƒ
2. å¼€å¯åŒå†™æ¨¡å¼ï¼ˆå†™å…¥æ—§åˆ†ç‰‡+æ–°åˆ†ç‰‡ï¼‰  
3. æ•°æ®å…¨é‡åŒæ­¥ï¼ˆæ—§â†’æ–°ï¼‰
4. æ•°æ®å¢é‡åŒæ­¥ï¼ˆbinlogï¼‰
5. åˆ‡æ¢è¯»å–åˆ°æ–°åˆ†ç‰‡
6. åœæ­¢åŒå†™ï¼Œä¸‹çº¿æ—§åˆ†ç‰‡

åŒå†™å®ç°ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å†™å…¥   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—§åˆ†ç‰‡ï¼ˆä¸»å†™ï¼‰
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ–°åˆ†ç‰‡ï¼ˆåŒæ­¥å†™ï¼‰
```

**åŒå†™å®ç°ä»£ç **ï¼š
```java
@Service
public class DualWriteService {
    @Autowired
    private OldShardDataSource oldDataSource;
    @Autowired  
    private NewShardDataSource newDataSource;
    
    @Transactional
    public void saveUser(User user) {
        try {
            // ä¸»åº“å†™å…¥
            oldDataSource.save(user);
            
            // æ–°åº“åŒæ­¥å†™å…¥  
            newDataSource.save(user);
        } catch (Exception e) {
            // å¦‚æœæ–°åº“å†™å…¥å¤±è´¥ï¼Œè®°å½•åˆ°è¡¥å¿é˜Ÿåˆ—
            compensationQueue.add(new CompensationTask(user));
            throw e;
        }
    }
}
```

### 5.3 åˆ†ç‰‡é‡å¹³è¡¡


**æ•°æ®å€¾æ–œæ£€æµ‹**ï¼š
```java
public class ShardBalanceMonitor {
    public ShardStats analyzeShardBalance() {
        Map<Integer, Long> shardSizes = new HashMap<>();
        
        for (int i = 0; i < shardCount; i++) {
            String sql = "SELECT COUNT(*) FROM users_" + i;
            long count = jdbcTemplate.queryForObject(sql, Long.class);
            shardSizes.put(i, count);
        }
        
        return calculateBalance(shardSizes);
    }
    
    private ShardStats calculateBalance(Map<Integer, Long> sizes) {
        long total = sizes.values().stream().mapToLong(Long::longValue).sum();
        long avg = total / sizes.size();
        
        // è®¡ç®—æ–¹å·®
        double variance = sizes.values().stream()
            .mapToDouble(size -> Math.pow(size - avg, 2))
            .average().orElse(0);
            
        return new ShardStats(avg, Math.sqrt(variance));
    }
}
```

**é‡å¹³è¡¡ç­–ç•¥**ï¼š
```java
public class RebalanceStrategy {
    public RebalancePlan createRebalancePlan(ShardStats stats) {
        if (stats.getStandardDeviation() / stats.getAverage() < 0.2) {
            return RebalancePlan.NO_REBALANCE;
        }
        
        // è¯†åˆ«çƒ­ç‚¹åˆ†ç‰‡å’Œå†·åˆ†ç‰‡
        List<Integer> hotShards = findHotShards(stats);
        List<Integer> coldShards = findColdShards(stats);
        
        // åˆ¶å®šè¿ç§»è®¡åˆ’
        return createMigrationPlan(hotShards, coldShards);
    }
}
```

---

## 6. ğŸ” åˆ†å¸ƒå¼äº‹åŠ¡ä¸ä¸€è‡´æ€§


### 6.1 å…¨å±€äº‹åŠ¡å¤„ç†


**åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯**ï¼šç”¨æˆ·ä¸‹å•æ¶‰åŠå¤šä¸ªåˆ†ç‰‡
```
ä¸‹å•æµç¨‹ï¼š
1. ç”¨æˆ·è¡¨æ›´æ–°ç§¯åˆ†ï¼ˆåˆ†ç‰‡Aï¼‰
2. è®¢å•è¡¨æ’å…¥è®¢å•ï¼ˆåˆ†ç‰‡Bï¼‰  
3. åº“å­˜è¡¨æ‰£å‡åº“å­˜ï¼ˆåˆ†ç‰‡Cï¼‰
4. æ”¯ä»˜è¡¨è®°å½•æ”¯ä»˜ï¼ˆåˆ†ç‰‡Dï¼‰

é—®é¢˜ï¼šå¦‚ä½•ä¿è¯æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼Ÿ
```

**2PCä¸¤é˜¶æ®µæäº¤**ï¼š
```
åè°ƒè€…                å‚ä¸è€…A         å‚ä¸è€…B         å‚ä¸è€…C
   |                    |              |              |
   |----å‡†å¤‡é˜¶æ®µ-------->|              |              |
   |                   OK              |              |
   |<-------------------|              |              |
   |----å‡†å¤‡é˜¶æ®µ---------------------->|              |
   |                                  OK              |
   |<---------------------------------|              |
   |----å‡†å¤‡é˜¶æ®µ-------------------------------------->|
   |                                                  OK
   |<--------------------------------------------------|
   |----æäº¤é˜¶æ®µ-------->|              |              |
   |                 COMMIT            |              |
   |----æäº¤é˜¶æ®µ---------------------->|              |
   |                                 COMMIT           |
   |----æäº¤é˜¶æ®µ-------------------------------------->|
   |                                                COMMIT
```

**XAäº‹åŠ¡å®ç°**ï¼š
```java
@Service
public class DistributedTransactionService {
    @Autowired
    private List<XADataSource> xaDataSources;
    
    @GlobalTransactional
    public void placeOrder(OrderRequest request) {
        try {
            // å¼€å¯åˆ†å¸ƒå¼äº‹åŠ¡
            TransactionManager tm = TransactionManagerServices.getTransactionManager();
            tm.begin();
            
            // å„åˆ†ç‰‡æ“ä½œ
            updateUserPoints(request.getUserId(), request.getPoints());
            createOrder(request);
            deductInventory(request.getProductId(), request.getQuantity());
            recordPayment(request.getPaymentInfo());
            
            // æäº¤äº‹åŠ¡
            tm.commit();
        } catch (Exception e) {
            tm.rollback();
            throw e;
        }
    }
}
```

### 6.2 åˆ†å¸ƒå¼IDç”Ÿæˆ


**é›ªèŠ±ç®—æ³•**ï¼š
```
é›ªèŠ±IDç»“æ„ï¼ˆ64ä½ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ä½ç¬¦å·  â”‚ 41ä½æ—¶é—´æˆ³â”‚ 10ä½æœºå™¨IDâ”‚ 12ä½åºåˆ—å·  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
- è¶‹åŠ¿é€’å¢ï¼šæ—¶é—´æˆ³ä¿è¯å¤§è‡´æœ‰åº
- å…¨å±€å”¯ä¸€ï¼šæœºå™¨ID+åºåˆ—å·ä¿è¯ä¸é‡å¤
- é«˜æ€§èƒ½ï¼šæœ¬åœ°ç”Ÿæˆï¼Œæ— éœ€ç½‘ç»œè°ƒç”¨
```

**é›ªèŠ±ç®—æ³•å®ç°**ï¼š
```java
public class SnowflakeIdGenerator {
    private long machineId;
    private long lastTimestamp = -1L;
    private long sequence = 0L;
    
    private static final long MACHINE_ID_BITS = 10L;
    private static final long SEQUENCE_BITS = 12L;
    private static final long MAX_SEQUENCE = (1L << SEQUENCE_BITS) - 1;
    
    public synchronized long generateId() {
        long timestamp = System.currentTimeMillis();
        
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨å¼‚å¸¸");
        }
        
        if (timestamp == lastTimestamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                timestamp = waitNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        return ((timestamp - EPOCH) << (MACHINE_ID_BITS + SEQUENCE_BITS)) 
               | (machineId << SEQUENCE_BITS) 
               | sequence;
    }
}
```

### 6.3 æœ€ç»ˆä¸€è‡´æ€§ä¿è¯


**Sagaæ¨¡å¼**ï¼š
```java
public class OrderSaga {
    public void executeOrderSaga(OrderRequest request) {
        SagaTransaction saga = SagaTransaction.builder()
            .step("updateUserPoints")
                .action(() -> updateUserPoints(request))
                .compensation(() -> revertUserPoints(request))
            .step("createOrder")  
                .action(() -> createOrder(request))
                .compensation(() -> cancelOrder(request))
            .step("deductInventory")
                .action(() -> deductInventory(request))
                .compensation(() -> restoreInventory(request))
            .build();
            
        saga.execute();
    }
}
```

**TCCæ¨¡å¼**ï¼š
```java
public interface PaymentTccService {
    // Try: é¢„ç•™èµ„æº
    boolean tryPay(Long userId, BigDecimal amount);
    
    // Confirm: ç¡®è®¤æäº¤  
    boolean confirmPay(Long transactionId);
    
    // Cancel: å–æ¶ˆå›æ»š
    boolean cancelPay(Long transactionId);
}
```

---

## 7. ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§


### 7.1 çƒ­ç‚¹æ•°æ®è¯†åˆ«


**çƒ­ç‚¹æ£€æµ‹ç®—æ³•**ï¼š
```java
public class HotDataDetector {
    private Map<String, LongAdder> accessCount = new ConcurrentHashMap<>();
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    
    public void recordAccess(String key) {
        accessCount.computeIfAbsent(key, k -> new LongAdder()).increment();
    }
    
    public List<HotKey> detectHotKeys() {
        return accessCount.entrySet().stream()
            .filter(entry -> entry.getValue().sum() > HOT_THRESHOLD)
            .map(entry -> new HotKey(entry.getKey(), entry.getValue().sum()))
            .sorted((h1, h2) -> Long.compare(h2.getCount(), h1.getCount()))
            .collect(toList());
    }
    
    // å®šæœŸæ¸…ç©ºç»Ÿè®¡ï¼Œé¿å…å†…å­˜æ³„éœ²
    @PostConstruct
    public void startClearTask() {
        scheduler.scheduleWithFixedDelay(() -> {
            accessCount.clear();
        }, 1, 1, TimeUnit.HOURS);
    }
}
```

**çƒ­ç‚¹å¤„ç†ç­–ç•¥**ï¼š
```java
@Service
public class HotDataHandler {
    @Cacheable(value = "hotUserCache", key = "#userId")
    public User getHotUser(Long userId) {
        return userRepository.findById(userId);
    }
    
    // è¯»å†™åˆ†ç¦»ï¼šçƒ­ç‚¹æ•°æ®è¯»ä»åº“
    public User getUserWithReadSlave(Long userId) {
        if (isHotUser(userId)) {
            return slaveDataSource.findUser(userId);
        }
        return masterDataSource.findUser(userId);
    }
}
```

### 7.2 åˆ†ç‰‡ç›‘æ§å‘Šè­¦


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š
```java
public class ShardingMetrics {
    // åˆ†ç‰‡è´Ÿè½½å‡è¡¡åº¦
    @Gauge
    public double getShardBalance() {
        return calculateShardVariance();
    }
    
    // è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹  
    @Gauge
    public double getCrossShardQueryRatio() {
        return crossShardQueries / totalQueries;
    }
    
    // å¹³å‡æŸ¥è¯¢å“åº”æ—¶é—´
    @Timer
    public void recordQueryTime(String shardId, long time) {
        // è®°å½•å„åˆ†ç‰‡æŸ¥è¯¢æ—¶é—´
    }
    
    // è¿æ¥æ± ä½¿ç”¨ç‡
    @Gauge
    public double getConnectionPoolUsage(String shardId) {
        return connectionPools.get(shardId).getActiveConnections() 
               / connectionPools.get(shardId).getMaxConnections();
    }
}
```

**å‘Šè­¦é…ç½®**ï¼š
```yaml
alerts:
  - name: shard_imbalance
    condition: shard_balance > 0.3
    message: "åˆ†ç‰‡æ•°æ®ä¸å‡è¡¡ï¼Œæ–¹å·®ç³»æ•°è¶…è¿‡30%"
    
  - name: high_cross_shard_query
    condition: cross_shard_query_ratio > 0.2  
    message: "è·¨åˆ†ç‰‡æŸ¥è¯¢æ¯”ä¾‹è¿‡é«˜ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´åˆ†ç‰‡ç­–ç•¥"
    
  - name: connection_pool_exhausted
    condition: connection_pool_usage > 0.8
    message: "è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå¯èƒ½éœ€è¦æ‰©å®¹"
```

### 7.3 åˆ†ç‰‡è·¯ç”±æ€§èƒ½ä¼˜åŒ–


**è·¯ç”±ç¼“å­˜ä¼˜åŒ–**ï¼š
```java
@Component
public class OptimizedShardRouter {
    @Cacheable(value = "shardRoute", key = "#shardKey")
    public ShardInfo getShardInfo(String shardKey) {
        return calculateShard(shardKey);
    }
    
    // é¢„çƒ­è·¯ç”±ç¼“å­˜
    @EventListener(ApplicationReadyEvent.class)
    public void warmupCache() {
        CompletableFuture.runAsync(() -> {
            // é¢„çƒ­å¸¸ç”¨è·¯ç”±
            for (int i = 0; i < COMMON_USER_RANGE; i++) {
                getShardInfo("user_" + i);
            }
        });
    }
}
```

**æ‰¹é‡è·¯ç”±ä¼˜åŒ–**ï¼š
```java
public class BatchShardRouter {
    public Map<String, List<String>> batchRoute(List<String> keys) {
        return keys.stream()
            .collect(groupingBy(this::getShardInfo));
    }
    
    public <T> Map<String, List<T>> batchRouteWithData(
            Map<String, T> keyDataMap) {
        Map<String, List<T>> result = new HashMap<>();
        
        keyDataMap.entrySet().stream().forEach(entry -> {
            String shard = getShardInfo(entry.getKey());
            result.computeIfAbsent(shard, k -> new ArrayList<>())
                  .add(entry.getValue());
        });
        
        return result;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†ç‰‡ç­–ç•¥ï¼šå‚ç›´åˆ†ç‰‡ï¼ˆæŒ‰ä¸šåŠ¡ï¼‰+ æ°´å¹³åˆ†ç‰‡ï¼ˆæŒ‰æ•°æ®é‡ï¼‰
ğŸ”¸ åˆ†ç‰‡é”®é€‰æ‹©ï¼šæŸ¥è¯¢é¢‘ç‡é«˜ã€åˆ†å¸ƒå‡åŒ€ã€ç›¸å…³æ€§å¼ºã€é¿å…çƒ­ç‚¹
ğŸ”¸ è·¯ç”±ç®—æ³•ï¼šä¸€è‡´æ€§Hashï¼ˆæ‰©å®¹å‹å¥½ï¼‰+ èŒƒå›´åˆ†ç‰‡ï¼ˆæŸ¥è¯¢é«˜æ•ˆï¼‰
ğŸ”¸ è·¨åˆ†ç‰‡æŸ¥è¯¢ï¼šåˆ†å¸ƒå¼èšåˆã€åº”ç”¨å±‚JOINã€æ¸¸æ ‡åˆ†é¡µ
ğŸ”¸ åœ¨çº¿æ‰©å®¹ï¼šåŒå†™è¿ç§»ã€æ•°æ®é‡å¹³è¡¡ã€é›¶åœæœºæ–¹æ¡ˆ
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼šXAä¸¤é˜¶æ®µæäº¤ã€Sagaè¡¥å¿æ¨¡å¼ã€TCCç¡®è®¤æ¨¡å¼
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åˆ†åº“åˆ†è¡¨çš„æ ¸å¿ƒæƒè¡¡**
```
æ€§èƒ½ vs å¤æ‚åº¦ï¼š
âœ… è§£å†³å•åº“æ€§èƒ½ç“¶é¢ˆ
âŒ å¢åŠ ç³»ç»Ÿå¤æ‚åº¦

ä¸€è‡´æ€§ vs å¯ç”¨æ€§ï¼š  
âœ… åˆ†åŒºå®¹é”™èƒ½åŠ›å¼º
âŒ å¼ºä¸€è‡´æ€§å®ç°å›°éš¾

æŸ¥è¯¢çµæ´»æ€§ vs æ€§èƒ½ï¼š
âœ… å•åˆ†ç‰‡æŸ¥è¯¢æ€§èƒ½å¥½  
âŒ è·¨åˆ†ç‰‡æŸ¥è¯¢å¤æ‚
```

**ğŸ”¹ åˆ†ç‰‡é”®é€‰æ‹©çš„é‡è¦æ€§**
```
å¥½çš„åˆ†ç‰‡é”®ï¼š
â”œâ”€ 80%æŸ¥è¯¢åªæ¶‰åŠå•åˆ†ç‰‡
â”œâ”€ æ•°æ®åˆ†å¸ƒåŸºæœ¬å‡åŒ€  
â”œâ”€ ä¸šåŠ¡ç›¸å…³æ•°æ®èšåˆ
â””â”€ æ‰©å®¹æ—¶è¿ç§»é‡å¯æ§

å·®çš„åˆ†ç‰‡é”®ï¼š
â”œâ”€ å¤§é‡è·¨åˆ†ç‰‡æŸ¥è¯¢
â”œâ”€ æ•°æ®ä¸¥é‡å€¾æ–œ
â”œâ”€ çƒ­ç‚¹åˆ†ç‰‡é—®é¢˜
â””â”€ æ‰©å®¹è¿ç§»å›°éš¾
```

**ğŸ”¹ ä¸€è‡´æ€§ä¿è¯çš„ç­–ç•¥é€‰æ‹©**
```
å¼ºä¸€è‡´æ€§åœºæ™¯ï¼š
â””â”€ é€‰æ‹©XAä¸¤é˜¶æ®µæäº¤ï¼ˆæ€§èƒ½å·®ä½†ä¸€è‡´æ€§å¼ºï¼‰

æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ï¼š
â”œâ”€ é€‰æ‹©Sagaæ¨¡å¼ï¼ˆå¤æ‚åº¦é€‚ä¸­ï¼‰
â””â”€ é€‰æ‹©TCCæ¨¡å¼ï¼ˆæ€§èƒ½å¥½ä½†å®ç°å¤æ‚ï¼‰

è¯»å†™åˆ†ç¦»åœºæ™¯ï¼š
â””â”€ å¯æ¥å—è¯»å»¶è¿Ÿçš„æœ€ç»ˆä¸€è‡´æ€§
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ åˆ†ç‰‡è§„æ¨¡è§„åˆ’**
```
æ•°æ®é‡è¯„ä¼°ï¼š
â”œâ”€ å•è¡¨å»ºè®®ä¸è¶…è¿‡1000ä¸‡è¡Œ
â”œâ”€ å•åº“å»ºè®®ä¸è¶…è¿‡50GB
â”œâ”€ é¢„ç•™3-5å¹´å¢é•¿ç©ºé—´
â””â”€ è€ƒè™‘å†å²æ•°æ®å½’æ¡£ç­–ç•¥

åˆ†ç‰‡æ•°é‡é€‰æ‹©ï¼š
â”œâ”€ åˆå§‹åˆ†ç‰‡æ•° = æ•°æ®é‡é¢„ä¼° / å•ç‰‡å®¹é‡
â”œâ”€ é€‰æ‹©2çš„å¹‚æ¬¡æ•°ä¾¿äºæ‰©å®¹
â”œâ”€ å•ä¸ªåˆ†ç‰‡å»ºè®®ä¸è¶…è¿‡500ä¸‡è¡Œ
â””â”€ æ€»åˆ†ç‰‡æ•°å»ºè®®ä¸è¶…è¿‡1024ä¸ª
```

**ğŸ”¸ ç›‘æ§å…³é”®æŒ‡æ ‡**
```sql
-- æ¯æ—¥ç›‘æ§SQLç¤ºä¾‹
-- 1. åˆ†ç‰‡æ•°æ®å‡è¡¡åº¦æ£€æŸ¥
SELECT shard_name, table_rows, 
       (table_rows / total_rows * 100) as percentage
FROM (
    SELECT shard_name, table_rows,
           SUM(table_rows) OVER() as total_rows
    FROM shard_statistics
) t;

-- 2. è·¨åˆ†ç‰‡æŸ¥è¯¢ç»Ÿè®¡  
SELECT DATE(query_time), 
       COUNT(*) as total_queries,
       SUM(CASE WHEN cross_shard = 1 THEN 1 ELSE 0 END) as cross_queries,
       ROUND(SUM(CASE WHEN cross_shard = 1 THEN 1 ELSE 0 END) / COUNT(*) * 100, 2) as cross_ratio
FROM query_log 
GROUP BY DATE(query_time);
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åˆ†åº“åˆ†è¡¨æ˜¯è§£å†³æ•°æ®é‡å’Œå¹¶å‘é—®é¢˜çš„æœ‰æ•ˆæ‰‹æ®µ
- åˆ†ç‰‡é”®é€‰æ‹©å†³å®šäº†åˆ†ç‰‡æ–¹æ¡ˆçš„æˆè´¥
- è·¨åˆ†ç‰‡æ“ä½œæ˜¯åˆ†åº“åˆ†è¡¨çš„ä¸»è¦å¤æ‚åº¦æ¥æº  
- æœ€ç»ˆä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¸¸è§é€‰æ‹©
- å®Œå–„çš„ç›‘æ§ä½“ç³»æ˜¯åˆ†ç‰‡é›†ç¾¤ç¨³å®šè¿è¡Œçš„ä¿éšœ