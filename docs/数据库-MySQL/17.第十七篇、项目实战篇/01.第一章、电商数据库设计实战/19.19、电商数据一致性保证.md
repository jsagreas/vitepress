---
title: 19ã€ç”µå•†æ•°æ®ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [æ•°æ®ä¸€è‡´æ€§æ¦‚è¿°](#1-æ•°æ®ä¸€è‡´æ€§æ¦‚è¿°)
2. [åˆ†å¸ƒå¼äº‹åŠ¡æœºåˆ¶](#2-åˆ†å¸ƒå¼äº‹åŠ¡æœºåˆ¶)
3. [æœ€ç»ˆä¸€è‡´æ€§å®ç°](#3-æœ€ç»ˆä¸€è‡´æ€§å®ç°)
4. [è¡¥å¿äº‹åŠ¡æœºåˆ¶](#4-è¡¥å¿äº‹åŠ¡æœºåˆ¶)
5. [æ•°æ®æ ¡éªŒä¸ä¿®å¤](#5-æ•°æ®æ ¡éªŒä¸ä¿®å¤)
6. [ä¸€è‡´æ€§ç›‘æ§ä½“ç³»](#6-ä¸€è‡´æ€§ç›‘æ§ä½“ç³»)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ•°æ®ä¸€è‡´æ€§æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸€è‡´æ€§


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
æ•°æ®ä¸€è‡´æ€§å°±åƒæ˜¯è®©æ‰€æœ‰ç›¸å…³çš„æ•°æ®"ä¿æŒåŒæ­¥"
æ¯”å¦‚ï¼š
- ç”¨æˆ·ä¸‹å•åï¼Œåº“å­˜è¦ç›¸åº”å‡å°‘
- æ”¯ä»˜æˆåŠŸåï¼Œè®¢å•çŠ¶æ€è¦æ›´æ–°
- ç§¯åˆ†å¢åŠ æ—¶ï¼Œç”¨æˆ·ä½™é¢ä¹Ÿè¦æ­£ç¡®æ˜¾ç¤º

ç®€å•ç†è§£ï¼šè®©æ‰€æœ‰ç›¸å…³æ•°æ®åœ¨åŒä¸€æ—¶åˆ»ä¿æŒé€»è¾‘ä¸Šçš„æ­£ç¡®å…³ç³»
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®ä¸€è‡´æ€§**
```
ç”µå•†ç³»ç»Ÿä¸­çš„å…¸å‹åœºæ™¯ï¼š
1. ä¸‹å•æ‰£åº“å­˜ï¼šè®¢å•åˆ›å»ºäº†ï¼Œä½†åº“å­˜æ²¡æ‰£å‡ âŒ
2. æ”¯ä»˜æ‰£æ¬¾ï¼šé’±æ‰£äº†ï¼Œä½†è®¢å•çŠ¶æ€æ²¡æ›´æ–° âŒ  
3. é€€æ¬¾æ“ä½œï¼šè®¢å•é€€äº†ï¼Œä½†åº“å­˜æ²¡å›è¡¥ âŒ

è¿™äº›éƒ½æ˜¯æ•°æ®ä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜
```

### 1.2 ä¸€è‡´æ€§çº§åˆ«


**ğŸ“Š ä¸€è‡´æ€§å¼ºåº¦å¯¹æ¯”**

| ä¸€è‡´æ€§çº§åˆ« | **ç‰¹ç‚¹** | **åº”ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|-----------|----------|-------------|-----------|
| ğŸ” **å¼ºä¸€è‡´æ€§** | `æ•°æ®å®æ—¶åŒæ­¥ï¼Œæ— å»¶è¿Ÿ` | `é“¶è¡Œè½¬è´¦ã€åº“å­˜æ‰£å‡` | `å¯é ä½†æ€§èƒ½ä½` |
| â° **æœ€ç»ˆä¸€è‡´æ€§** | `çŸ­æ—¶é—´å†…ä¼šåŒæ­¥` | `ç”¨æˆ·ä¿¡æ¯æ›´æ–°ã€æ—¥å¿—è®°å½•` | `æ€§èƒ½å¥½ä½†æœ‰å»¶è¿Ÿ` |
| ğŸ”„ **å¼±ä¸€è‡´æ€§** | `ä¸ä¿è¯ä½•æ—¶åŒæ­¥` | `æµè§ˆè®°å½•ã€æ¨èæ•°æ®` | `æ€§èƒ½æœ€å¥½ä½†å¯èƒ½ä¸åŒæ­¥` |

### 1.3 ç”µå•†åœºæ™¯çš„ä¸€è‡´æ€§éœ€æ±‚


**ğŸ›’ æ ¸å¿ƒä¸šåŠ¡åœºæ™¯**
```
è®¢å•å¤„ç†æµç¨‹ï¼š
ç”¨æˆ·ä¸‹å• â†’ æ£€æŸ¥åº“å­˜ â†’ é”å®šåº“å­˜ â†’ ç”Ÿæˆè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ é€šçŸ¥æ”¯ä»˜

æ¯ä¸ªç¯èŠ‚éƒ½éœ€è¦æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼š
- åº“å­˜æ•°æ®å¿…é¡»å‡†ç¡®ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
- è®¢å•çŠ¶æ€å¿…é¡»åŠæ—¶æ›´æ–°ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
- ç”¨æˆ·ç§¯åˆ†å¯ä»¥å»¶è¿Ÿæ›´æ–°ï¼ˆå¼±ä¸€è‡´æ€§ï¼‰
```

---

## 2. âš–ï¸ åˆ†å¸ƒå¼äº‹åŠ¡æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ”¸ åŸºæœ¬ç†è§£**
```
ä¼ ç»Ÿäº‹åŠ¡ï¼šä¸€ä¸ªæ•°æ®åº“å†…çš„å¤šä¸ªæ“ä½œï¼Œè¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥
åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¤šä¸ªæ•°æ®åº“/æœåŠ¡é—´çš„æ“ä½œï¼Œä¹Ÿè¦ä¿æŒè¿™ä¸ªç‰¹æ€§

ä¸¾ä¾‹è¯´æ˜ï¼š
ä¸‹å•æµç¨‹æ¶‰åŠï¼š
- è®¢å•æ•°æ®åº“ï¼šåˆ›å»ºè®¢å•è®°å½•
- åº“å­˜æ•°æ®åº“ï¼šæ‰£å‡å•†å“åº“å­˜  
- ç”¨æˆ·æ•°æ®åº“ï¼šæ‰£å‡è´¦æˆ·ä½™é¢

è¿™ä¸‰ä¸ªæ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥
```

### 2.2 TCCäº‹åŠ¡æ¨¡å¼


**ğŸ”§ TCCå·¥ä½œåŸç†**
```
TCC = Try-Confirm-Cancelï¼ˆå°è¯•-ç¡®è®¤-å–æ¶ˆï¼‰

å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼š
1ï¸âƒ£ Tryé˜¶æ®µï¼šé¢„ç•™èµ„æºï¼Œä¸å®é™…æ‰§è¡Œ
2ï¸âƒ£ Confirmé˜¶æ®µï¼šæ­£å¼æäº¤ï¼Œæ‰§è¡Œä¸šåŠ¡æ“ä½œ
3ï¸âƒ£ Cancelé˜¶æ®µï¼šé‡Šæ”¾èµ„æºï¼Œå›æ»šæ“ä½œ
```

**ğŸ’» TCCå®ç°ç¤ºä¾‹**
```sql
-- Tryé˜¶æ®µï¼šé¢„ç•™åº“å­˜
UPDATE product_stock 
SET reserved_stock = reserved_stock + 1,
    available_stock = available_stock - 1
WHERE product_id = 1001 AND available_stock >= 1;

-- Confirmé˜¶æ®µï¼šç¡®è®¤æ‰£å‡
UPDATE product_stock 
SET reserved_stock = reserved_stock - 1
WHERE product_id = 1001;

-- Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„ç•™
UPDATE product_stock 
SET reserved_stock = reserved_stock - 1,
    available_stock = available_stock + 1  
WHERE product_id = 1001;
```

**âœ… TCCé€‚ç”¨åœºæ™¯**
```
é€‚åˆï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„æ ¸å¿ƒä¸šåŠ¡
- è®¢å•æ”¯ä»˜æµç¨‹
- åº“å­˜æ‰£å‡æ“ä½œ
- èµ„é‡‘è½¬è´¦ä¸šåŠ¡

ä¸é€‚åˆï¼šå¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯
- æ—¥å¿—è®°å½•
- ç»Ÿè®¡æ•°æ®æ›´æ–°
```

### 2.3 Sagaäº‹åŠ¡æ¨¡å¼


**ğŸ”¸ SagaåŸºæœ¬æ¦‚å¿µ**
```
Sagaæ˜¯å¤„ç†é•¿äº‹åŠ¡çš„æ¨¡å¼
å°†å¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°çš„æœ¬åœ°äº‹åŠ¡
æ¯ä¸ªå°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ

é€‚åˆï¼šä¸šåŠ¡æµç¨‹é•¿ã€æ¶‰åŠå¤šä¸ªç³»ç»Ÿçš„åœºæ™¯
```

**ğŸ”„ Sagaæ‰§è¡Œæµç¨‹**
```
æ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3 â†’ T4
è¡¥å¿æµç¨‹ï¼šC4 â† C3 â† C2 â† C1

ç¤ºä¾‹ï¼šè®¢å•å¤„ç†Saga
T1: åˆ›å»ºè®¢å•         C1: åˆ é™¤è®¢å•
T2: æ‰£å‡åº“å­˜         C2: æ¢å¤åº“å­˜  
T3: æ‰£å‡ä½™é¢         C3: æ¢å¤ä½™é¢
T4: å‘é€é€šçŸ¥         C4: å‘é€å–æ¶ˆé€šçŸ¥
```

**ğŸ’» Sagaå®ç°æ¡†æ¶**
```java
// ç®€åŒ–çš„Sagaäº‹åŠ¡ç®¡ç†
public class OrderSaga {
    
    @SagaStep(compensation = "cancelOrder")
    public void createOrder(OrderInfo order) {
        // åˆ›å»ºè®¢å•é€»è¾‘
    }
    
    @SagaStep(compensation = "restoreStock") 
    public void deductStock(Long productId, Integer count) {
        // æ‰£å‡åº“å­˜é€»è¾‘
    }
    
    // è¡¥å¿æ–¹æ³•
    public void cancelOrder(OrderInfo order) {
        // å–æ¶ˆè®¢å•é€»è¾‘
    }
    
    public void restoreStock(Long productId, Integer count) {
        // æ¢å¤åº“å­˜é€»è¾‘  
    }
}
```

---

## 3. â° æœ€ç»ˆä¸€è‡´æ€§å®ç°


### 3.1 æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ


**ğŸ”¸ å·¥ä½œåŸç†**
```
æœ¬åœ°æ¶ˆæ¯è¡¨å°±åƒæ˜¯ä¸€ä¸ª"å¤‡å¿˜å½•"
æŠŠéœ€è¦é€šçŸ¥å…¶ä»–ç³»ç»Ÿçš„æ¶ˆæ¯å…ˆè®°å½•åœ¨æœ¬åœ°æ•°æ®åº“ä¸­
ç„¶åå®šæ—¶æ‰«æè¿™äº›æ¶ˆæ¯ï¼Œå‘é€ç»™å…¶ä»–ç³»ç»Ÿ

è¿™æ ·ä¿è¯ï¼šå³ä½¿ç½‘ç»œæ•…éšœï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±
```

**ğŸ’¾ æ¶ˆæ¯è¡¨è®¾è®¡**
```sql
-- æœ¬åœ°æ¶ˆæ¯è¡¨
CREATE TABLE local_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) UNIQUE NOT NULL,  -- æ¶ˆæ¯å”¯ä¸€ID
    business_type VARCHAR(32) NOT NULL,      -- ä¸šåŠ¡ç±»å‹
    business_id VARCHAR(64) NOT NULL,        -- ä¸šåŠ¡ID
    message_content JSON NOT NULL,           -- æ¶ˆæ¯å†…å®¹
    status TINYINT DEFAULT 0,                -- 0:å¾…å‘é€ 1:å·²å‘é€ 2:å‘é€å¤±è´¥
    retry_count INT DEFAULT 0,               -- é‡è¯•æ¬¡æ•°
    create_time DATETIME DEFAULT NOW(),
    update_time DATETIME DEFAULT NOW(),
    INDEX idx_status_create_time (status, create_time)
);
```

**ğŸ”„ æ¶ˆæ¯å‘é€é€»è¾‘**
```java
// è®¢å•åˆ›å»ºæ—¶ï¼ŒåŒæ—¶è®°å½•æ¶ˆæ¯
@Transactional
public void createOrder(OrderInfo order) {
    // 1. åˆ›å»ºè®¢å•
    orderDao.insert(order);
    
    // 2. è®°å½•æœ¬åœ°æ¶ˆæ¯ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
    LocalMessage message = new LocalMessage();
    message.setBusinessType("ORDER_CREATED");
    message.setBusinessId(order.getOrderId());
    message.setMessageContent(JSON.toJSONString(order));
    messageDao.insert(message);
}

// å®šæ—¶ä»»åŠ¡æ‰«æå¹¶å‘é€æ¶ˆæ¯
@Scheduled(fixedDelay = 5000)
public void sendPendingMessages() {
    List<LocalMessage> messages = messageDao.findPendingMessages();
    
    for (LocalMessage msg : messages) {
        try {
            // å‘é€åˆ°MQæˆ–è°ƒç”¨å…¶ä»–æœåŠ¡
            messageQueue.send(msg.getMessageContent());
            
            // æ ‡è®°ä¸ºå·²å‘é€
            msg.setStatus(1);
            messageDao.update(msg);
            
        } catch (Exception e) {
            // å¢åŠ é‡è¯•æ¬¡æ•°
            msg.setRetryCount(msg.getRetryCount() + 1);
            if (msg.getRetryCount() >= 3) {
                msg.setStatus(2); // æ ‡è®°å¤±è´¥
            }
            messageDao.update(msg);
        }
    }
}
```

### 3.2 ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**
```
å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œï¼Œç»“æœéƒ½ä¸€æ ·

ä¸¾ä¾‹è¯´æ˜ï¼š
- å¹‚ç­‰ï¼šSET balance = 100ï¼ˆè®¾ç½®ä½™é¢ä¸º100ï¼‰
- éå¹‚ç­‰ï¼šSET balance = balance + 10ï¼ˆä½™é¢å¢åŠ 10ï¼‰

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯å¯èƒ½é‡å¤å‘é€
æ‰€ä»¥æ¯ä¸ªæ“ä½œéƒ½è¦è®¾è®¡æˆå¹‚ç­‰çš„
```

**ğŸ”‘ å¹‚ç­‰æ€§å®ç°æ–¹æ¡ˆ**
```sql
-- å¹‚ç­‰æ€§æ§åˆ¶è¡¨
CREATE TABLE idempotent_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    business_key VARCHAR(128) UNIQUE NOT NULL,  -- ä¸šåŠ¡å”¯ä¸€é”®
    business_type VARCHAR(32) NOT NULL,         -- ä¸šåŠ¡ç±»å‹
    status TINYINT DEFAULT 1,                   -- 1:å·²å¤„ç†
    result JSON,                                -- å¤„ç†ç»“æœ
    create_time DATETIME DEFAULT NOW(),
    UNIQUE KEY uk_business_key (business_key)
);
```

**ğŸ’» å¹‚ç­‰æ€§æ£€æŸ¥ä»£ç **
```java
// å¹‚ç­‰æ€§å¤„ç†æ¨¡æ¿
public class IdempotentService {
    
    public <T> T executeWithIdempotent(String businessKey, 
                                       String businessType,
                                       Supplier<T> operation) {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        IdempotentRecord record = recordDao.findByBusinessKey(businessKey);
        if (record != null) {
            // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›ä¹‹å‰çš„ç»“æœ
            return JSON.parseObject(record.getResult(), (Type) null);
        }
        
        // 2. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        T result = operation.get();
        
        // 3. è®°å½•å¤„ç†ç»“æœ
        record = new IdempotentRecord();
        record.setBusinessKey(businessKey);
        record.setBusinessType(businessType);
        record.setResult(JSON.toJSONString(result));
        recordDao.insert(record);
        
        return result;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public void processOrderPayment(String orderId, BigDecimal amount) {
    String businessKey = "ORDER_PAY_" + orderId;
    
    idempotentService.executeWithIdempotent(businessKey, "ORDER_PAYMENT", () -> {
        // å®é™…çš„æ”¯ä»˜å¤„ç†é€»è¾‘
        return paymentService.processPayment(orderId, amount);
    });
}
```

---

## 4. ğŸ”„ è¡¥å¿äº‹åŠ¡æœºåˆ¶


### 4.1 è¡¥å¿äº‹åŠ¡åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¡¥å¿äº‹åŠ¡**
```
è¡¥å¿äº‹åŠ¡å°±åƒæ˜¯"åæ‚”è¯"
å½“åˆ†å¸ƒå¼æ“ä½œæ‰§è¡Œä¸€åŠå¤±è´¥æ—¶ï¼Œéœ€è¦æŠŠå·²ç»æ‰§è¡Œçš„éƒ¨åˆ†æ’¤é”€æ‰

ä¸¾ä¾‹ï¼š
1. åˆ›å»ºè®¢å• âœ…
2. æ‰£å‡åº“å­˜ âœ…  
3. æ‰£å‡ä½™é¢ âŒ (å¤±è´¥)

éœ€è¦è¡¥å¿æ“ä½œï¼š
1. æ¢å¤åº“å­˜
2. åˆ é™¤è®¢å•
```

### 4.2 è¡¥å¿ç­–ç•¥è®¾è®¡


**ğŸ“‹ è¡¥å¿æ“ä½œè®¾è®¡åŸåˆ™**
```
ğŸ”¸ å¯é€†æ€§ï¼šæ¯ä¸ªæ“ä½œéƒ½è¦æœ‰å¯¹åº”çš„é€†å‘æ“ä½œ
ğŸ”¸ å¹‚ç­‰æ€§ï¼šè¡¥å¿æ“ä½œå¯ä»¥é‡å¤æ‰§è¡Œ
ğŸ”¸ å¯è§‚æµ‹ï¼šè¡¥å¿è¿‡ç¨‹è¦æœ‰è¯¦ç»†æ—¥å¿—
ğŸ”¸ å¯ç›‘æ§ï¼šè¡¥å¿å¤±è´¥è¦æœ‰å‘Šè­¦æœºåˆ¶
```

**ğŸ’» è¡¥å¿äº‹åŠ¡å®ç°**
```java
// è¡¥å¿äº‹åŠ¡ç®¡ç†å™¨
public class CompensationManager {
    
    private List<CompensationAction> compensationStack = new ArrayList<>();
    
    // æ³¨å†Œè¡¥å¿æ“ä½œ
    public void addCompensation(CompensationAction action) {
        compensationStack.add(action);
    }
    
    // æ‰§è¡Œè¡¥å¿ï¼ˆå€’åºæ‰§è¡Œï¼‰
    public void executeCompensation() {
        Collections.reverse(compensationStack);
        
        for (CompensationAction action : compensationStack) {
            try {
                action.compensate();
                log.info("è¡¥å¿æ“ä½œæˆåŠŸ: {}", action.getActionName());
            } catch (Exception e) {
                log.error("è¡¥å¿æ“ä½œå¤±è´¥: {}", action.getActionName(), e);
                // è¡¥å¿å¤±è´¥éœ€è¦äººå·¥ä»‹å…¥
                alertService.sendAlert("è¡¥å¿å¤±è´¥", action.getActionName());
            }
        }
    }
}

// è®¢å•å¤„ç†ç¤ºä¾‹
public void processOrderWithCompensation(OrderInfo order) {
    CompensationManager compensationManager = new CompensationManager();
    
    try {
        // 1. åˆ›å»ºè®¢å•
        orderService.createOrder(order);
        compensationManager.addCompensation(() -> {
            orderService.cancelOrder(order.getOrderId());
        });
        
        // 2. æ‰£å‡åº“å­˜
        stockService.deductStock(order.getProductId(), order.getQuantity());
        compensationManager.addCompensation(() -> {
            stockService.restoreStock(order.getProductId(), order.getQuantity());
        });
        
        // 3. æ‰£å‡ä½™é¢
        accountService.deductBalance(order.getUserId(), order.getAmount());
        compensationManager.addCompensation(() -> {
            accountService.restoreBalance(order.getUserId(), order.getAmount());
        });
        
    } catch (Exception e) {
        // å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰§è¡Œè¡¥å¿
        compensationManager.executeCompensation();
        throw e;
    }
}
```

### 4.3 è¶…æ—¶å¤„ç†æœºåˆ¶


**â° äº‹åŠ¡è¶…æ—¶æ§åˆ¶**
```sql
-- äº‹åŠ¡æ‰§è¡Œè®°å½•è¡¨
CREATE TABLE transaction_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    transaction_id VARCHAR(64) UNIQUE NOT NULL,
    business_type VARCHAR(32) NOT NULL,
    status TINYINT DEFAULT 0,    -- 0:æ‰§è¡Œä¸­ 1:æˆåŠŸ 2:å¤±è´¥ 3:è¶…æ—¶
    start_time DATETIME NOT NULL,
    timeout_seconds INT DEFAULT 300,  -- é»˜è®¤5åˆ†é’Ÿè¶…æ—¶
    update_time DATETIME DEFAULT NOW(),
    INDEX idx_status_start_time (status, start_time)
);
```

**ğŸ”§ è¶…æ—¶å¤„ç†é€»è¾‘**
```java
// è¶…æ—¶æ£€æŸ¥å®šæ—¶ä»»åŠ¡
@Scheduled(fixedDelay = 30000) // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
public void checkTimeoutTransactions() {
    // æŸ¥æ‰¾è¶…æ—¶çš„äº‹åŠ¡
    List<TransactionRecord> timeoutTxns = transactionDao.findTimeoutTransactions();
    
    for (TransactionRecord txn : timeoutTxns) {
        try {
            // æ ‡è®°ä¸ºè¶…æ—¶çŠ¶æ€
            txn.setStatus(3);
            transactionDao.update(txn);
            
            // æ‰§è¡Œè¡¥å¿é€»è¾‘
            compensationService.compensateTransaction(txn.getTransactionId());
            
            // å‘é€å‘Šè­¦
            alertService.sendTimeoutAlert(txn);
            
        } catch (Exception e) {
            log.error("å¤„ç†è¶…æ—¶äº‹åŠ¡å¤±è´¥: {}", txn.getTransactionId(), e);
        }
    }
}
```

---

## 5. ğŸ” æ•°æ®æ ¡éªŒä¸ä¿®å¤


### 5.1 æ•°æ®å¯¹è´¦ç³»ç»Ÿ


**ğŸ”¸ å¯¹è´¦çš„æ„ä¹‰**
```
æ•°æ®å¯¹è´¦å°±åƒæ˜¯"æŸ¥è´¦"
å®šæœŸæ£€æŸ¥å„ä¸ªç³»ç»Ÿé—´çš„æ•°æ®æ˜¯å¦ä¸€è‡´
å‘ç°ä¸ä¸€è‡´æ—¶åŠæ—¶ä¿®å¤

å¸¸è§å¯¹è´¦åœºæ™¯ï¼š
- è®¢å•ç³»ç»Ÿ vs åº“å­˜ç³»ç»Ÿï¼šè®¢å•æ•°é‡ä¸åº“å­˜æ‰£å‡æ˜¯å¦åŒ¹é…
- æ”¯ä»˜ç³»ç»Ÿ vs è®¢å•ç³»ç»Ÿï¼šæ”¯ä»˜é‡‘é¢ä¸è®¢å•é‡‘é¢æ˜¯å¦ä¸€è‡´  
- ç§¯åˆ†ç³»ç»Ÿ vs è®¢å•ç³»ç»Ÿï¼šç§¯åˆ†å¢åŠ ä¸è®¢å•å®Œæˆæ˜¯å¦åŒæ­¥
```

**ğŸ’¾ å¯¹è´¦æ•°æ®è®¾è®¡**
```sql
-- å¯¹è´¦ä»»åŠ¡è¡¨
CREATE TABLE reconciliation_task (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_name VARCHAR(64) NOT NULL,
    source_system VARCHAR(32) NOT NULL,      -- æºç³»ç»Ÿ
    target_system VARCHAR(32) NOT NULL,      -- ç›®æ ‡ç³»ç»Ÿ  
    check_date DATE NOT NULL,                -- å¯¹è´¦æ—¥æœŸ
    status TINYINT DEFAULT 0,                -- 0:å¾…æ‰§è¡Œ 1:æ‰§è¡Œä¸­ 2:å®Œæˆ 3:å¼‚å¸¸
    total_records INT DEFAULT 0,             -- æ€»è®°å½•æ•°
    diff_records INT DEFAULT 0,              -- å·®å¼‚è®°å½•æ•°
    create_time DATETIME DEFAULT NOW(),
    INDEX idx_check_date_status (check_date, status)
);

-- å·®å¼‚è®°å½•è¡¨
CREATE TABLE reconciliation_diff (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    task_id BIGINT NOT NULL,
    business_key VARCHAR(128) NOT NULL,      -- ä¸šåŠ¡ä¸»é”®
    source_value JSON,                       -- æºç³»ç»Ÿæ•°æ®
    target_value JSON,                       -- ç›®æ ‡ç³»ç»Ÿæ•°æ®
    diff_type VARCHAR(32) NOT NULL,          -- å·®å¼‚ç±»å‹
    status TINYINT DEFAULT 0,                -- 0:å¾…å¤„ç† 1:å·²ä¿®å¤ 2:å¿½ç•¥
    create_time DATETIME DEFAULT NOW()
);
```

**ğŸ”§ å¯¹è´¦é€»è¾‘å®ç°**
```java
// è®¢å•-åº“å­˜å¯¹è´¦æœåŠ¡
public class OrderStockReconciliation {
    
    // æ‰§è¡Œå¯¹è´¦
    public void executeReconciliation(Date checkDate) {
        // 1. åˆ›å»ºå¯¹è´¦ä»»åŠ¡
        ReconciliationTask task = createTask("ORDER_STOCK", checkDate);
        
        try {
            // 2. è·å–è®¢å•æ•°æ®
            List<OrderStockData> orderData = getOrderStockData(checkDate);
            
            // 3. è·å–åº“å­˜å˜åŒ–æ•°æ®  
            List<StockChangeData> stockData = getStockChangeData(checkDate);
            
            // 4. æ•°æ®æ¯”å¯¹
            List<ReconciliationDiff> diffs = compareData(orderData, stockData);
            
            // 5. ä¿å­˜å·®å¼‚è®°å½•
            saveDifferences(task.getId(), diffs);
            
            // 6. æ›´æ–°ä»»åŠ¡çŠ¶æ€
            task.setStatus(2);
            task.setTotalRecords(orderData.size());
            task.setDiffRecords(diffs.size());
            taskDao.update(task);
            
        } catch (Exception e) {
            task.setStatus(3);
            taskDao.update(task);
            throw e;
        }
    }
    
    // æ•°æ®æ¯”å¯¹é€»è¾‘
    private List<ReconciliationDiff> compareData(List<OrderStockData> orderData, 
                                                List<StockChangeData> stockData) {
        List<ReconciliationDiff> diffs = new ArrayList<>();
        
        // æŒ‰å•†å“IDåˆ†ç»„æ¯”å¯¹
        Map<Long, Integer> orderStockMap = orderData.stream()
            .collect(Collectors.groupingBy(
                OrderStockData::getProductId,
                Collectors.summingInt(OrderStockData::getQuantity)
            ));
            
        Map<Long, Integer> stockChangeMap = stockData.stream()
            .collect(Collectors.groupingBy(
                StockChangeData::getProductId, 
                Collectors.summingInt(StockChangeData::getQuantity)
            ));
        
        // æ‰¾å‡ºå·®å¼‚
        for (Map.Entry<Long, Integer> entry : orderStockMap.entrySet()) {
            Long productId = entry.getKey();
            Integer orderQty = entry.getValue();
            Integer stockQty = stockChangeMap.getOrDefault(productId, 0);
            
            if (!orderQty.equals(stockQty)) {
                ReconciliationDiff diff = new ReconciliationDiff();
                diff.setBusinessKey("PRODUCT_" + productId);
                diff.setSourceValue(JSON.toJSONString(Map.of("quantity", orderQty)));
                diff.setTargetValue(JSON.toJSONString(Map.of("quantity", stockQty)));
                diff.setDiffType("QUANTITY_MISMATCH");
                diffs.add(diff);
            }
        }
        
        return diffs;
    }
}
```

### 5.2 æ•°æ®ä¸€è‡´æ€§å·¡æ£€


**ğŸ” è‡ªåŠ¨å·¡æ£€æœºåˆ¶**
```java
// æ•°æ®ä¸€è‡´æ€§å·¡æ£€æœåŠ¡
@Component
public class DataConsistencyChecker {
    
    // æ£€æŸ¥è®¢å•çŠ¶æ€ä¸€è‡´æ€§
    @Scheduled(cron = "0 */10 * * * *") // æ¯10åˆ†é’Ÿæ‰§è¡Œ
    public void checkOrderConsistency() {
        // æŸ¥æ‰¾çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´çš„è®¢å•
        List<Order> suspiciousOrders = orderDao.findSuspiciousOrders();
        
        for (Order order : suspiciousOrders) {
            try {
                checkSingleOrderConsistency(order);
            } catch (Exception e) {
                log.error("æ£€æŸ¥è®¢å•ä¸€è‡´æ€§å¤±è´¥: orderId={}", order.getId(), e);
            }
        }
    }
    
    private void checkSingleOrderConsistency(Order order) {
        // 1. æ£€æŸ¥è®¢å•ä¸æ”¯ä»˜çŠ¶æ€ä¸€è‡´æ€§
        PaymentRecord payment = paymentDao.findByOrderId(order.getId());
        if (order.getStatus() == OrderStatus.PAID && 
            (payment == null || payment.getStatus() != PaymentStatus.SUCCESS)) {
            
            // å‘ç°ä¸ä¸€è‡´ï¼Œè®°å½•å¼‚å¸¸
            recordInconsistency("ORDER_PAYMENT_MISMATCH", order.getId());
        }
        
        // 2. æ£€æŸ¥è®¢å•ä¸åº“å­˜ä¸€è‡´æ€§
        StockRecord stockRecord = stockDao.findByOrderId(order.getId());
        if (order.getStatus() == OrderStatus.CONFIRMED && stockRecord == null) {
            recordInconsistency("ORDER_STOCK_MISMATCH", order.getId());
        }
    }
    
    private void recordInconsistency(String type, Long businessId) {
        // è®°å½•ä¸ä¸€è‡´é—®é¢˜
        ConsistencyIssue issue = new ConsistencyIssue();
        issue.setIssueType(type);
        issue.setBusinessId(businessId);
        issue.setStatus(0); // å¾…å¤„ç†
        issueDao.insert(issue);
        
        // å‘é€å‘Šè­¦
        alertService.sendConsistencyAlert(issue);
    }
}
```

### 5.3 è‡ªåŠ¨ä¿®å¤æœºåˆ¶


**ğŸ”§ æ•°æ®ä¿®å¤ç­–ç•¥**
```java
// æ•°æ®è‡ªåŠ¨ä¿®å¤æœåŠ¡
public class DataRepairService {
    
    // ä¿®å¤è®¢å•çŠ¶æ€ä¸ä¸€è‡´
    public void repairOrderStatusInconsistency(Long orderId) {
        Order order = orderDao.findById(orderId);
        PaymentRecord payment = paymentDao.findByOrderId(orderId);
        
        // æ ¹æ®æ”¯ä»˜çŠ¶æ€ä¿®å¤è®¢å•çŠ¶æ€
        if (payment != null && payment.getStatus() == PaymentStatus.SUCCESS) {
            if (order.getStatus() != OrderStatus.PAID) {
                order.setStatus(OrderStatus.PAID);
                order.setPaidTime(payment.getPayTime());
                orderDao.update(order);
                
                log.info("è‡ªåŠ¨ä¿®å¤è®¢å•çŠ¶æ€: orderId={}, çŠ¶æ€æ›´æ–°ä¸ºå·²æ”¯ä»˜", orderId);
            }
        }
    }
    
    // ä¿®å¤åº“å­˜æ•°æ®ä¸ä¸€è‡´
    public void repairStockInconsistency(Long productId) {
        // 1. è®¡ç®—ç†è®ºåº“å­˜ï¼ˆåŸºäºè®¢å•ï¼‰
        Integer theoreticalStock = calculateTheoreticalStock(productId);
        
        // 2. è·å–å®é™…åº“å­˜
        ProductStock currentStock = stockDao.findByProductId(productId);
        
        // 3. å¦‚æœä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®å¤
        if (!theoreticalStock.equals(currentStock.getAvailableStock())) {
            
            // åˆ›å»ºåº“å­˜è°ƒæ•´è®°å½•
            StockAdjustment adjustment = new StockAdjustment();
            adjustment.setProductId(productId);
            adjustment.setBeforeStock(currentStock.getAvailableStock());
            adjustment.setAfterStock(theoreticalStock);
            adjustment.setReason("è‡ªåŠ¨ä¿®å¤æ•°æ®ä¸ä¸€è‡´");
            adjustmentDao.insert(adjustment);
            
            // æ›´æ–°åº“å­˜
            currentStock.setAvailableStock(theoreticalStock);
            stockDao.update(currentStock);
            
            log.info("è‡ªåŠ¨ä¿®å¤åº“å­˜æ•°æ®: productId={}, {} -> {}", 
                    productId, adjustment.getBeforeStock(), theoreticalStock);
        }
    }
    
    private Integer calculateTheoreticalStock(Long productId) {
        // åŸºäºè®¢å•è®¡ç®—ç†è®ºåº“å­˜
        Integer initialStock = getInitialStock(productId);
        Integer soldQuantity = orderDao.getTotalSoldQuantity(productId);
        return initialStock - soldQuantity;
    }
}
```

---

## 6. ğŸ“Š ä¸€è‡´æ€§ç›‘æ§ä½“ç³»


### 6.1 ç›‘æ§æŒ‡æ ‡è®¾è®¡


**ğŸ“ˆ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
æ•°æ®ä¸€è‡´æ€§ç›¸å…³æŒ‡æ ‡ï¼š

ğŸ”¸ äº‹åŠ¡æˆåŠŸç‡
- åˆ†å¸ƒå¼äº‹åŠ¡æˆåŠŸç‡
- TCCäº‹åŠ¡å„é˜¶æ®µæˆåŠŸç‡  
- Sagaäº‹åŠ¡è¡¥å¿æ‰§è¡Œç‡

ğŸ”¸ æ•°æ®å»¶è¿ŸæŒ‡æ ‡
- æœ€ç»ˆä¸€è‡´æ€§è¾¾æˆæ—¶é—´
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
- æ•°æ®åŒæ­¥å»¶è¿Ÿ

ğŸ”¸ å¼‚å¸¸æŒ‡æ ‡
- æ•°æ®ä¸ä¸€è‡´å‘ç°æ•°é‡
- è¡¥å¿äº‹åŠ¡å¤±è´¥æ¬¡æ•°
- è¶…æ—¶äº‹åŠ¡æ•°é‡
```

**ğŸ’» ç›‘æ§æ•°æ®æ”¶é›†**
```java
// ä¸€è‡´æ€§ç›‘æ§æŒ‡æ ‡æ”¶é›†
@Component
public class ConsistencyMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    // è®°å½•äº‹åŠ¡æˆåŠŸç‡
    public void recordTransactionSuccess(String transactionType, boolean success) {
        Counter.builder("transaction.count")
            .tag("type", transactionType)
            .tag("status", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
    }
    
    // è®°å½•æ•°æ®åŒæ­¥å»¶è¿Ÿ
    public void recordSyncLatency(String businessType, Duration latency) {
        Timer.builder("data.sync.latency")
            .tag("business_type", businessType)
            .register(meterRegistry)
            .record(latency);
    }
    
    // è®°å½•ä¸ä¸€è‡´é—®é¢˜
    public void recordInconsistencyIssue(String issueType) {
        Counter.builder("consistency.issue.count")
            .tag("type", issueType)
            .register(meterRegistry)
            .increment();
    }
}
```

### 6.2 å‘Šè­¦æœºåˆ¶


**ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®**
```yaml
# ä¸€è‡´æ€§å‘Šè­¦é…ç½®
consistency_alerts:
  - name: "äº‹åŠ¡æˆåŠŸç‡è¿‡ä½"
    condition: "transaction_success_rate < 0.95"
    severity: "HIGH"
    notification: ["email", "sms"]
    
  - name: "æ•°æ®ä¸ä¸€è‡´é—®é¢˜å¢å¤š" 
    condition: "consistency_issue_count > 10 in 5m"
    severity: "MEDIUM"
    notification: ["email"]
    
  - name: "è¡¥å¿äº‹åŠ¡å¤±è´¥"
    condition: "compensation_failure_count > 0"
    severity: "CRITICAL"
    notification: ["email", "sms", "phone"]
```

**ğŸ“± å‘Šè­¦å¤„ç†æµç¨‹**
```java
// å‘Šè­¦å¤„ç†æœåŠ¡
public class AlertService {
    
    public void sendConsistencyAlert(ConsistencyIssue issue) {
        AlertMessage alert = new AlertMessage();
        alert.setTitle("æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸");
        alert.setContent(formatAlertContent(issue));
        alert.setSeverity(determineSeverity(issue));
        
        // æ ¹æ®ä¸¥é‡ç¨‹åº¦é€‰æ‹©é€šçŸ¥æ–¹å¼
        if (alert.getSeverity() == Severity.CRITICAL) {
            sendSMS(alert);
            sendEmail(alert);
            makePhoneCall(alert);
        } else if (alert.getSeverity() == Severity.HIGH) {
            sendEmail(alert);
            sendSMS(alert);
        } else {
            sendEmail(alert);
        }
        
        // è®°å½•å‘Šè­¦å†å²
        alertHistoryDao.insert(alert);
    }
    
    private String formatAlertContent(ConsistencyIssue issue) {
        return String.format(
            "å‘ç°æ•°æ®ä¸€è‡´æ€§é—®é¢˜:\n" +
            "é—®é¢˜ç±»å‹: %s\n" +
            "ä¸šåŠ¡ID: %s\n" + 
            "å‘ç°æ—¶é—´: %s\n" +
            "è¯·åŠæ—¶å¤„ç†!",
            issue.getIssueType(),
            issue.getBusinessId(), 
            issue.getCreateTime()
        );
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼šè®©ç›¸å…³æ•°æ®ä¿æŒé€»è¾‘ä¸Šçš„æ­£ç¡®å…³ç³»
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¤šä¸ªç³»ç»Ÿé—´æ“ä½œçš„åŸå­æ€§ä¿è¯
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æ—¶é—´ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¾¾æˆä¸€è‡´
ğŸ”¸ è¡¥å¿äº‹åŠ¡ï¼šé€šè¿‡é€†å‘æ“ä½œæ¥æ’¤é”€å·²æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘
ğŸ”¸ å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œç»“æœç›¸åŒ
ğŸ”¸ æ•°æ®å¯¹è´¦ï¼šå®šæœŸæ£€æŸ¥ç³»ç»Ÿé—´æ•°æ®ä¸€è‡´æ€§
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸€è‡´æ€§çº§åˆ«çš„é€‰æ‹©**
```
å¼ºä¸€è‡´æ€§é€‚ç”¨åœºæ™¯ï¼š
âœ… é‡‘èäº¤æ˜“ï¼ˆè½¬è´¦ã€æ”¯ä»˜ï¼‰
âœ… åº“å­˜æ‰£å‡ï¼ˆé˜²æ­¢è¶…å–ï¼‰
âœ… è®¢å•æ ¸å¿ƒçŠ¶æ€å˜æ›´

æœ€ç»ˆä¸€è‡´æ€§é€‚ç”¨åœºæ™¯ï¼š  
âœ… ç”¨æˆ·ä¿¡æ¯åŒæ­¥
âœ… æ—¥å¿—æ•°æ®è®°å½•
âœ… ç»Ÿè®¡æ•°æ®æ›´æ–°
```

**ğŸ”¹ äº‹åŠ¡æ¨¡å¼çš„å¯¹æ¯”**
```
TCCäº‹åŠ¡ï¼š
- é€‚åˆï¼šçŸ­æµç¨‹ã€å¼ºä¸€è‡´æ€§è¦æ±‚
- ä¼˜ç‚¹ï¼šä¸€è‡´æ€§å¼ºï¼Œæ€§èƒ½ç›¸å¯¹å¥½
- ç¼ºç‚¹ï¼šå®ç°å¤æ‚ï¼Œéœ€è¦é¢„ç•™èµ„æº

Sagaäº‹åŠ¡ï¼š
- é€‚åˆï¼šé•¿æµç¨‹ã€å¤šç³»ç»Ÿå‚ä¸
- ä¼˜ç‚¹ï¼šå®ç°ç›¸å¯¹ç®€å•ï¼Œæ€§èƒ½å¥½
- ç¼ºç‚¹ï¼šåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ è¡¥å¿æœºåˆ¶çš„è®¾è®¡è¦ç‚¹**
```
è®¾è®¡åŸåˆ™ï¼š
1ï¸âƒ£ æ¯ä¸ªæ“ä½œéƒ½è¦æœ‰è¡¥å¿æ–¹æ³•
2ï¸âƒ£ è¡¥å¿æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„
3ï¸âƒ£ è¡¥å¿å¤±è´¥è¦æœ‰äººå·¥ä»‹å…¥æœºåˆ¶
4ï¸âƒ£ è¡¥å¿è¿‡ç¨‹è¦æœ‰è¯¦ç»†æ—¥å¿—
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è®¢å•å¤„ç†**ï¼šç¡®ä¿è®¢å•ã€åº“å­˜ã€æ”¯ä»˜æ•°æ®ä¸€è‡´
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šä¿è¯ç§¯åˆ†å˜åŠ¨ä¸ä¸šåŠ¡æ“ä½œåŒæ­¥  
- **åº“å­˜ç®¡ç†**ï¼šé˜²æ­¢è¶…å–å’Œåº“å­˜æ•°æ®é”™ä¹±
- **è´¢åŠ¡å¯¹è´¦**ï¼šç¡®ä¿å„ç³»ç»Ÿé‡‘é¢æ•°æ®ä¸€è‡´

**ğŸ”§ æŠ€æœ¯å®è·µè¦ç‚¹**
- **é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«**ï¼šæ ¹æ®ä¸šåŠ¡é‡è¦æ€§å†³å®š
- **è®¾è®¡å®Œå–„çš„è¡¥å¿æœºåˆ¶**ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ
- **å»ºç«‹ç›‘æ§å‘Šè­¦ä½“ç³»**ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
- **å®šæœŸæ•°æ®å¯¹è´¦**ï¼šä¸»åŠ¨å‘ç°æ½œåœ¨ä¸ä¸€è‡´é—®é¢˜

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¸€è‡´æ€§ä¸æ˜¯éé»‘å³ç™½ï¼Œè¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çº§åˆ«
- åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å®Œç¾ä¸€è‡´æ€§å¾ˆéš¾ï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯ç°å®é€‰æ‹©  
- è¡¥å¿æœºåˆ¶æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„é‡è¦ä¿éšœ
- ç›‘æ§å’Œå¯¹è´¦æ˜¯ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„é‡è¦æ‰‹æ®µ