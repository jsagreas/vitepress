---
title: 3ã€è®¢å•ä¸­å¿ƒå®Œæ•´è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [è®¢å•ä¸­å¿ƒæ¶æ„æ¦‚è¿°](#1-è®¢å•ä¸­å¿ƒæ¶æ„æ¦‚è¿°)
2. [è®¢å•çŠ¶æ€æœºè®¾è®¡](#2-è®¢å•çŠ¶æ€æœºè®¾è®¡)
3. [è®¢å•æ ¸å¿ƒæ•°æ®ç»“æ„](#3-è®¢å•æ ¸å¿ƒæ•°æ®ç»“æ„)
4. [è®¢å•é‡‘é¢è®¡ç®—è§„åˆ™](#4-è®¢å•é‡‘é¢è®¡ç®—è§„åˆ™)
5. [è®¢å•å¹‚ç­‰æ€§ä¿è¯](#5-è®¢å•å¹‚ç­‰æ€§ä¿è¯)
6. [è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†](#6-è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†)
7. [è®¢å•å¼‚å¸¸å¤„ç†æœºåˆ¶](#7-è®¢å•å¼‚å¸¸å¤„ç†æœºåˆ¶)
8. [è®¢å•åˆ†åº“åˆ†è¡¨ç­–ç•¥](#8-è®¢å•åˆ†åº“åˆ†è¡¨ç­–ç•¥)
9. [è®¢å•æ€§èƒ½ä¼˜åŒ–](#9-è®¢å•æ€§èƒ½ä¼˜åŒ–)
10. [å¤§ä¿ƒæœŸé—´ç‰¹æ®Šå¤„ç†](#10-å¤§ä¿ƒæœŸé—´ç‰¹æ®Šå¤„ç†)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ è®¢å•ä¸­å¿ƒæ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è®¢å•ä¸­å¿ƒ


**è®¢å•ä¸­å¿ƒ**å°±æ˜¯ç”µå•†ç³»ç»Ÿçš„"å¤§ç®¡å®¶"ï¼Œä¸“é—¨è´Ÿè´£ç®¡ç†æ‰€æœ‰è®¢å•ä»åˆ›å»ºåˆ°å®Œæˆçš„å…¨è¿‡ç¨‹ã€‚

```
ç”¨æˆ·è´­ä¹°æµç¨‹ä¸­çš„è®¢å•ä¸­å¿ƒä½œç”¨ï¼š

ç”¨æˆ·ä¸‹å• â†’ è®¢å•ä¸­å¿ƒæ¥æ”¶ â†’ åº“å­˜æ£€æŸ¥ â†’ ä»·æ ¼è®¡ç®—
     â†“                â†“           â†“          â†“
  ç”Ÿæˆè®¢å•  â†’     çŠ¶æ€æ›´æ–°  â†’   æ‰£å‡åº“å­˜  â†’  æ”¯ä»˜å¤„ç†
     â†“                â†“           â†“          â†“
  è®¢å•ç¡®è®¤  â†’     ç‰©æµå‘è´§  â†’   è®¢å•å®Œæˆ  â†’  å”®åæœåŠ¡
```

**æ ¸å¿ƒèŒè´£**ï¼š
- ğŸ¯ **è®¢å•åˆ›å»º**ï¼šæ¥æ”¶ç”¨æˆ·ä¸‹å•è¯·æ±‚ï¼Œç”Ÿæˆè®¢å•
- âš–ï¸ **çŠ¶æ€ç®¡ç†**ï¼šæ§åˆ¶è®¢å•å„ç§çŠ¶æ€çš„æµè½¬
- ğŸ’° **é‡‘é¢è®¡ç®—**ï¼šå¤„ç†å•†å“ä»·æ ¼ã€ä¼˜æƒ åˆ¸ã€è¿è´¹ç­‰å¤æ‚è®¡ç®—
- ğŸ”’ **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è®¢å•æ•°æ®å‡†ç¡®æ— è¯¯
- ğŸ“Š **ä¸šåŠ¡åè°ƒ**ï¼šä¸åº“å­˜ã€æ”¯ä»˜ã€ç‰©æµç­‰ç³»ç»Ÿåä½œ

### 1.2 è®¢å•ä¸­å¿ƒæ•´ä½“æ¶æ„


```
                     è®¢å•ä¸­å¿ƒæ¶æ„å›¾
                         
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç”¨æˆ·ç«¯    â”‚    â”‚   å•†å®¶ç«¯    â”‚    â”‚   ç®¡ç†ç«¯    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚                è®¢å•ç½‘å…³å±‚                        â”‚
    â”‚           (è´Ÿè½½å‡è¡¡ã€é™æµã€é‰´æƒ)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                è®¢å•æœåŠ¡å±‚                        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚è®¢å•åˆ›å»º â”‚ â”‚çŠ¶æ€ç®¡ç† â”‚ â”‚é‡‘é¢è®¡ç®— â”‚ â”‚å¼‚å¸¸å¤„ç† â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                æ•°æ®è®¿é—®å±‚                        â”‚
    â”‚     è®¢å•åº“      å¿«ç…§åº“     æ—¥å¿—åº“     ç¼“å­˜å±‚     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ğŸ”„ è®¢å•çŠ¶æ€æœºè®¾è®¡


### 2.1 è®¢å•çŠ¶æ€æœºåŸç†


**çŠ¶æ€æœº**å°±åƒä¸€ä¸ª"äº¤é€šä¿¡å·ç¯ç³»ç»Ÿ"ï¼Œè®¢å•åªèƒ½æŒ‰ç…§é¢„è®¾çš„è§„åˆ™ä»ä¸€ä¸ªçŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€æœºï¼Ÿ**
- ğŸš¦ **çŠ¶æ€æ§åˆ¶**ï¼šé˜²æ­¢è®¢å•çŠ¶æ€ä¹±è·³ï¼Œæ¯”å¦‚å·²å‘è´§çš„è®¢å•ä¸èƒ½å›åˆ°å¾…æ”¯ä»˜
- ğŸ”’ **ä¸šåŠ¡å®‰å…¨**ï¼šç¡®ä¿æ¯ä¸ªçŠ¶æ€å˜æ›´éƒ½æ˜¯åˆæ³•çš„
- ğŸ“ **æ“ä½œæ—¥å¿—**ï¼šè®°å½•æ¯æ¬¡çŠ¶æ€å˜åŒ–çš„åŸå› å’Œæ—¶é—´

### 2.2 æ ¸å¿ƒè®¢å•çŠ¶æ€è®¾è®¡


```
è®¢å•çŠ¶æ€æµè½¬å›¾ï¼š

    [å¾…æ”¯ä»˜] â”€â”€æ”¯ä»˜æˆåŠŸâ”€â”€â†’ [å¾…å‘è´§] â”€â”€å‘è´§â”€â”€â†’ [å¾…æ”¶è´§] â”€â”€ç¡®è®¤æ”¶è´§â”€â”€â†’ [å·²å®Œæˆ]
        â”‚                      â”‚              â”‚                â”‚
        â”‚                      â”‚              â”‚                â”‚
     è¶…æ—¶å–æ¶ˆ                å–æ¶ˆè®¢å•        æ‹’æ”¶é€€å›          ç”³è¯·å”®å
        â”‚                      â”‚              â”‚                â”‚
        â–¼                      â–¼              â–¼                â–¼
    [å·²å–æ¶ˆ] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [å·²å–æ¶ˆ]    [é€€è´§ä¸­] â”€â”€â†’ [å·²é€€è´§]
```

**ä¸»è¦çŠ¶æ€è¯´æ˜**ï¼š

| çŠ¶æ€ä»£ç  | çŠ¶æ€åç§° | å«ä¹‰è§£é‡Š | å¯è¿›å…¥çš„ä¸‹ä¸€çŠ¶æ€ |
|---------|----------|----------|------------------|
| `PENDING_PAYMENT` | å¾…æ”¯ä»˜ | è®¢å•å·²åˆ›å»ºä½†æœªæ”¯ä»˜ | å¾…å‘è´§ã€å·²å–æ¶ˆ |
| `PENDING_DELIVERY` | å¾…å‘è´§ | å·²æ”¯ä»˜ç­‰å¾…å‘è´§ | å¾…æ”¶è´§ã€å·²å–æ¶ˆ |
| `PENDING_RECEIVE` | å¾…æ”¶è´§ | å·²å‘è´§ç”¨æˆ·æœªç¡®è®¤æ”¶è´§ | å·²å®Œæˆã€é€€è´§ä¸­ |
| `COMPLETED` | å·²å®Œæˆ | æ­£å¸¸å®Œæˆçš„è®¢å• | ç”³è¯·å”®å |
| `CANCELLED` | å·²å–æ¶ˆ | å–æ¶ˆçš„è®¢å• | æ—  |

### 2.3 çŠ¶æ€æœºå®ç°ä»£ç 


```java
public class OrderStateMachine {
    
    // çŠ¶æ€è½¬æ¢è§„åˆ™å®šä¹‰
    private static final Map<OrderStatus, Set<OrderStatus>> STATE_TRANSITIONS = Map.of(
        PENDING_PAYMENT, Set.of(PENDING_DELIVERY, CANCELLED),
        PENDING_DELIVERY, Set.of(PENDING_RECEIVE, CANCELLED),
        PENDING_RECEIVE, Set.of(COMPLETED, RETURN_PROCESSING),
        COMPLETED, Set.of(AFTER_SALE)
    );
    
    // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
    public boolean canTransition(OrderStatus from, OrderStatus to) {
        Set<OrderStatus> allowedStates = STATE_TRANSITIONS.get(from);
        return allowedStates != null && allowedStates.contains(to);
    }
    
    // æ‰§è¡ŒçŠ¶æ€è½¬æ¢
    public void changeOrderStatus(String orderId, OrderStatus newStatus, String reason) {
        Order order = orderRepository.findById(orderId);
        
        if (!canTransition(order.getStatus(), newStatus)) {
            throw new IllegalStateException("è®¢å•çŠ¶æ€è½¬æ¢ä¸åˆæ³•");
        }
        
        order.setStatus(newStatus);
        order.setUpdateTime(new Date());
        
        // è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—
        orderStatusLogService.log(orderId, order.getStatus(), newStatus, reason);
        
        orderRepository.save(order);
    }
}
```

## 3. ğŸ’¾ è®¢å•æ ¸å¿ƒæ•°æ®ç»“æ„


### 3.1 è®¢å•ä¸»è¡¨è®¾è®¡


è®¢å•ä¸»è¡¨å­˜å‚¨è®¢å•çš„**æ ¸å¿ƒä¿¡æ¯**ï¼Œå°±åƒèº«ä»½è¯ä¸€æ ·è®°å½•è®¢å•çš„åŸºæœ¬æƒ…å†µã€‚

```sql
CREATE TABLE `order_main` (
  `order_id` varchar(32) NOT NULL COMMENT 'è®¢å•ID(åˆ†å¸ƒå¼ç”Ÿæˆ)',
  `order_no` varchar(32) NOT NULL COMMENT 'è®¢å•ç¼–å·(ç”¨æˆ·å¯è§)',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `shop_id` bigint NOT NULL COMMENT 'åº—é“ºID',
  
  -- é‡‘é¢ç›¸å…³
  `total_amount` decimal(10,2) NOT NULL COMMENT 'è®¢å•æ€»é‡‘é¢',
  `pay_amount` decimal(10,2) NOT NULL COMMENT 'å®ä»˜é‡‘é¢',
  `discount_amount` decimal(10,2) DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢',
  `freight_amount` decimal(10,2) DEFAULT 0 COMMENT 'è¿è´¹',
  
  -- çŠ¶æ€ç›¸å…³
  `order_status` tinyint NOT NULL COMMENT 'è®¢å•çŠ¶æ€',
  `pay_status` tinyint NOT NULL COMMENT 'æ”¯ä»˜çŠ¶æ€', 
  `delivery_status` tinyint NOT NULL COMMENT 'ç‰©æµçŠ¶æ€',
  
  -- æ—¶é—´ç›¸å…³
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `pay_time` datetime NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
  `delivery_time` datetime NULL COMMENT 'å‘è´§æ—¶é—´',
  `complete_time` datetime NULL COMMENT 'å®Œæˆæ—¶é—´',
  `cancel_time` datetime NULL COMMENT 'å–æ¶ˆæ—¶é—´',
  
  PRIMARY KEY (`order_id`),
  KEY `idx_user_create_time` (`user_id`, `create_time`),
  KEY `idx_order_no` (`order_no`)
) COMMENT='è®¢å•ä¸»è¡¨';
```

### 3.2 è®¢å•å•†å“è¡¨è®¾è®¡


è®°å½•è®¢å•ä¸­**æ¯ä¸ªå•†å“çš„è¯¦ç»†ä¿¡æ¯**ï¼Œå°±åƒè´­ç‰©å°ç¥¨ä¸Šçš„å•†å“æ¸…å•ã€‚

```sql
CREATE TABLE `order_item` (
  `item_id` bigint AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `order_id` varchar(32) NOT NULL COMMENT 'è®¢å•ID',
  `product_id` bigint NOT NULL COMMENT 'å•†å“ID',
  `sku_id` bigint NOT NULL COMMENT 'SKU ID',
  
  -- å•†å“ä¿¡æ¯å¿«ç…§
  `product_name` varchar(200) NOT NULL COMMENT 'å•†å“åç§°',
  `sku_name` varchar(200) NOT NULL COMMENT 'SKUåç§°',
  `product_image` varchar(500) COMMENT 'å•†å“å›¾ç‰‡',
  
  -- ä»·æ ¼æ•°é‡
  `unit_price` decimal(10,2) NOT NULL COMMENT 'å•ä»·',
  `quantity` int NOT NULL COMMENT 'è´­ä¹°æ•°é‡',
  `total_price` decimal(10,2) NOT NULL COMMENT 'å°è®¡é‡‘é¢',
  
  PRIMARY KEY (`item_id`),
  KEY `idx_order_id` (`order_id`)
) COMMENT='è®¢å•å•†å“è¡¨';
```

### 3.3 è®¢å•å¿«ç…§æ•°æ®è®¾è®¡


**ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§æ•°æ®ï¼Ÿ**
- ğŸ“¸ **å†å²è®°å½•**ï¼šå•†å“ä¿¡æ¯ä¼šå˜åŒ–ï¼Œä½†è®¢å•è¦ä¿ç•™ä¸‹å•æ—¶çš„ä¿¡æ¯
- âš–ï¸ **æ³•å¾‹ä¾æ®**ï¼šå‘ç”Ÿçº çº·æ—¶ï¼Œä»¥ä¸‹å•æ—¶çš„ä¿¡æ¯ä¸ºå‡†
- ğŸ” **é—®é¢˜æ’æŸ¥**ï¼šå¸®åŠ©å®¢æœäº†è§£ç”¨æˆ·ä¸‹å•æ—¶çœ‹åˆ°çš„å†…å®¹

```sql
CREATE TABLE `order_snapshot` (
  `snapshot_id` bigint AUTO_INCREMENT COMMENT 'å¿«ç…§ID',
  `order_id` varchar(32) NOT NULL COMMENT 'è®¢å•ID',
  `snapshot_type` tinyint NOT NULL COMMENT 'å¿«ç…§ç±»å‹(1å•†å“2ä¼˜æƒ 3åœ°å€)',
  `snapshot_data` json NOT NULL COMMENT 'å¿«ç…§æ•°æ®',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  
  PRIMARY KEY (`snapshot_id`),
  KEY `idx_order_id` (`order_id`)
) COMMENT='è®¢å•å¿«ç…§è¡¨';
```

## 4. ğŸ’° è®¢å•é‡‘é¢è®¡ç®—è§„åˆ™


### 4.1 é‡‘é¢è®¡ç®—æ ¸å¿ƒé€»è¾‘


è®¢å•é‡‘é¢è®¡ç®—å°±åƒè¶…å¸‚ç»“è´¦ï¼Œéœ€è¦è€ƒè™‘**å•†å“ä»·æ ¼**ã€**ä¼˜æƒ åˆ¸**ã€**è¿è´¹**ç­‰å¤šä¸ªå› ç´ ã€‚

```
é‡‘é¢è®¡ç®—æµç¨‹ï¼š

å•†å“åŸä»· Ã— æ•°é‡ = å•†å“å°è®¡
       â†“
æ‰€æœ‰å•†å“å°è®¡ç›¸åŠ  = è®¢å•åŸä»·
       â†“
è®¢å•åŸä»· - ä¼˜æƒ åˆ¸å‡å… = ä¼˜æƒ åä»·æ ¼
       â†“  
ä¼˜æƒ åä»·æ ¼ + è¿è´¹ = æœ€ç»ˆåº”ä»˜é‡‘é¢
```

### 4.2 é‡‘é¢è®¡ç®—å®ç°ä»£ç 


```java
@Service
public class OrderAmountCalculator {
    
    public OrderAmount calculateAmount(OrderRequest request) {
        OrderAmount amount = new OrderAmount();
        
        // 1. è®¡ç®—å•†å“æ€»ä»·
        BigDecimal productAmount = calculateProductAmount(request.getItems());
        amount.setProductAmount(productAmount);
        
        // 2. è®¡ç®—ä¼˜æƒ é‡‘é¢
        BigDecimal discountAmount = calculateDiscount(request);
        amount.setDiscountAmount(discountAmount);
        
        // 3. è®¡ç®—è¿è´¹
        BigDecimal freightAmount = calculateFreight(request);
        amount.setFreightAmount(freightAmount);
        
        // 4. è®¡ç®—æœ€ç»ˆåº”ä»˜é‡‘é¢
        BigDecimal payAmount = productAmount.subtract(discountAmount).add(freightAmount);
        amount.setPayAmount(payAmount);
        
        return amount;
    }
    
    // è®¡ç®—å•†å“æ€»ä»·
    private BigDecimal calculateProductAmount(List<OrderItem> items) {
        return items.stream()
                   .map(item -> item.getUnitPrice().multiply(new BigDecimal(item.getQuantity())))
                   .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    // è®¡ç®—ä¼˜æƒ é‡‘é¢
    private BigDecimal calculateDiscount(OrderRequest request) {
        // ä¼˜æƒ åˆ¸ã€æ»¡å‡ã€æŠ˜æ‰£ç­‰è®¡ç®—é€»è¾‘
        return couponService.calculateDiscount(request);
    }
}
```

### 4.3 é‡‘é¢ç²¾åº¦å¤„ç†


**å…³é”®åŸåˆ™**ï¼š
- ğŸ’° **åˆ†ä¸ºå•ä½**ï¼šæ‰€æœ‰é‡‘é¢ä»¥åˆ†ä¸ºå•ä½å­˜å‚¨ï¼Œé¿å…å°æ•°ç²¾åº¦é—®é¢˜
- ğŸ¯ **å››èˆäº”å…¥**ï¼šç»Ÿä¸€ä½¿ç”¨é“¶è¡Œå®¶èˆå…¥æ³•
- ğŸ“Š **å¯¹è´¦æœºåˆ¶**ï¼šå®šæœŸå¯¹è´¦ç¡®ä¿é‡‘é¢å‡†ç¡®

```java
// é‡‘é¢å·¥å…·ç±»
public class MoneyUtils {
    
    // å…ƒè½¬åˆ†
    public static Long yuanToFen(BigDecimal yuan) {
        return yuan.multiply(new BigDecimal("100")).longValue();
    }
    
    // åˆ†è½¬å…ƒ
    public static BigDecimal fenToYuan(Long fen) {
        return new BigDecimal(fen).divide(new BigDecimal("100"), 2, RoundingMode.HALF_EVEN);
    }
}
```

## 5. ğŸ”’ è®¢å•å¹‚ç­‰æ€§ä¿è¯


### 5.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**å¹‚ç­‰æ€§**å°±æ˜¯"é‡å¤æ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œç»“æœéƒ½ä¸€æ ·"ã€‚æ¯”å¦‚ä½ æŒ‰ç”µæ¢¯æŒ‰é’®ï¼ŒæŒ‰ä¸€æ¬¡å’ŒæŒ‰åæ¬¡æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚

**ä¸ºä»€ä¹ˆè®¢å•éœ€è¦å¹‚ç­‰æ€§ï¼Ÿ**
- ğŸ”„ **ç½‘ç»œé‡è¯•**ï¼šç½‘ç»œä¸ç¨³å®šæ—¶ç”¨æˆ·å¯èƒ½é‡å¤ç‚¹å‡»ä¸‹å•æŒ‰é’®
- ğŸ”§ **ç³»ç»Ÿé‡è¯•**ï¼šæ”¯ä»˜å›è°ƒå¯èƒ½é‡å¤å‘é€
- ğŸ› **å¼‚å¸¸æ¢å¤**ï¼šç³»ç»Ÿå¼‚å¸¸æ¢å¤æ—¶å¯èƒ½é‡å¤å¤„ç†

### 5.2 è®¢å•å¹‚ç­‰æ€§å®ç°æ–¹æ¡ˆ


#### æ–¹æ¡ˆä¸€ï¼šåŸºäºè®¢å•å·é˜²é‡


```java
@Service
public class OrderService {
    
    @Transactional
    public OrderResult createOrder(OrderRequest request) {
        // ç”Ÿæˆå”¯ä¸€è®¢å•å·
        String orderNo = generateOrderNo(request);
        
        // å°è¯•æ’å…¥è®¢å•ï¼Œå¦‚æœè®¢å•å·å·²å­˜åœ¨ä¼šæŠ›å¼‚å¸¸
        try {
            Order order = buildOrder(request, orderNo);
            orderRepository.save(order);
            return OrderResult.success(order);
        } catch (DuplicateKeyException e) {
            // è®¢å•å·²å­˜åœ¨ï¼Œè¿”å›å·²æœ‰è®¢å•
            Order existOrder = orderRepository.findByOrderNo(orderNo);
            return OrderResult.success(existOrder);
        }
    }
    
    private String generateOrderNo(OrderRequest request) {
        // åŸºäºç”¨æˆ·IDã€å•†å“IDã€æ—¶é—´æˆ³ç­‰ç”Ÿæˆå”¯ä¸€è®¢å•å·
        String source = request.getUserId() + "_" + 
                       request.getItemsHash() + "_" + 
                       System.currentTimeMillis();
        return "ORD" + DigestUtils.md5Hex(source).substring(0, 16);
    }
}
```

#### æ–¹æ¡ˆäºŒï¼šåˆ†å¸ƒå¼é”é˜²é‡


```java
@Service  
public class OrderService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public OrderResult createOrder(OrderRequest request) {
        String lockKey = "order_lock:" + request.getUserId();
        
        // è·å–åˆ†å¸ƒå¼é”
        Boolean lockResult = redisTemplate.opsForValue()
                           .setIfAbsent(lockKey, "1", Duration.ofSeconds(10));
        
        if (!lockResult) {
            return OrderResult.fail("è®¢å•åˆ›å»ºä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }
        
        try {
            // åˆ›å»ºè®¢å•é€»è¾‘
            return doCreateOrder(request);
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    }
}
```

## 6. ğŸ”„ è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 6.1 è®¢å•ç”Ÿå‘½å‘¨æœŸæ¦‚è¿°


è®¢å•ç”Ÿå‘½å‘¨æœŸå°±åƒäººçš„ä¸€ç”Ÿï¼Œä»å‡ºç”Ÿåˆ°æ¶ˆäº¡æœ‰å›ºå®šçš„é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‰¹å®šçš„ä»»åŠ¡ã€‚

```
è®¢å•ç”Ÿå‘½å‘¨æœŸæ—¶é—´è½´ï¼š

åˆ›å»ºé˜¶æ®µ â”€â”€â”€â”€â†’ æ”¯ä»˜é˜¶æ®µ â”€â”€â”€â”€â†’ å±¥çº¦é˜¶æ®µ â”€â”€â”€â”€â†’ å®Œæˆé˜¶æ®µ
  |              |              |              |
 åº“å­˜é”å®š      æ”¯ä»˜å¤„ç†        ç‰©æµè·Ÿè¸ª      è®¢å•å½’æ¡£
 é£æ§æ£€æŸ¥      æ”¯ä»˜å›è°ƒ        çŠ¶æ€åŒæ­¥      æ•°æ®æ¸…ç†
 ä»·æ ¼è®¡ç®—      è¶…æ—¶å–æ¶ˆ        å¼‚å¸¸å¤„ç†      å”®åå¤„ç†
```

### 6.2 è®¢å•çŠ¶æ€æµè½¬æ§åˆ¶


```java
@Component
public class OrderLifecycleManager {
    
    // è®¢å•åˆ›å»ºåçš„åˆå§‹åŒ–å¤„ç†
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        String orderId = event.getOrderId();
        
        // 1. é”å®šåº“å­˜
        inventoryService.lockStock(orderId);
        
        // 2. è®¾ç½®æ”¯ä»˜è¶…æ—¶ä»»åŠ¡
        delayTaskService.addTask(orderId, "PAYMENT_TIMEOUT", 30 * 60 * 1000);
        
        // 3. å‘é€åˆ›å»ºé€šçŸ¥
        messageService.sendOrderCreatedMessage(orderId);
    }
    
    // è®¢å•æ”¯ä»˜æˆåŠŸå¤„ç†
    @EventListener  
    public void handleOrderPaid(OrderPaidEvent event) {
        String orderId = event.getOrderId();
        
        // 1. å–æ¶ˆæ”¯ä»˜è¶…æ—¶ä»»åŠ¡
        delayTaskService.cancelTask(orderId, "PAYMENT_TIMEOUT");
        
        // 2. é€šçŸ¥å‘è´§
        fulfillmentService.notifyShipment(orderId);
        
        // 3. è®¾ç½®å‘è´§è¶…æ—¶ä»»åŠ¡
        delayTaskService.addTask(orderId, "SHIPMENT_TIMEOUT", 24 * 60 * 60 * 1000);
    }
}
```

### 6.3 è®¢å•è¶…æ—¶å¤„ç†æœºåˆ¶


**è¶…æ—¶åœºæ™¯**ï¼š
- â° **æ”¯ä»˜è¶…æ—¶**ï¼š30åˆ†é’Ÿå†…æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
- ğŸ“¦ **å‘è´§è¶…æ—¶**ï¼š24å°æ—¶å†…æœªå‘è´§è‡ªåŠ¨å¤„ç†
- âœ… **ç¡®è®¤è¶…æ—¶**ï¼š7å¤©å†…æœªç¡®è®¤æ”¶è´§è‡ªåŠ¨å®Œæˆ

```java
@Component
public class OrderTimeoutHandler {
    
    // æ”¯ä»˜è¶…æ—¶å¤„ç†
    public void handlePaymentTimeout(String orderId) {
        Order order = orderService.getById(orderId);
        
        if (order.getStatus() == OrderStatus.PENDING_PAYMENT) {
            // å–æ¶ˆè®¢å•
            orderService.cancelOrder(orderId, "æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ");
            
            // é‡Šæ”¾åº“å­˜
            inventoryService.releaseStock(orderId);
            
            // å‘é€å–æ¶ˆé€šçŸ¥
            messageService.sendOrderCancelledMessage(orderId);
        }
    }
    
    // è‡ªåŠ¨ç¡®è®¤æ”¶è´§
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void autoConfirmReceive() {
        // æŸ¥è¯¢7å¤©å‰å‘è´§ä¸”æœªç¡®è®¤çš„è®¢å•
        List<Order> orders = orderService.findAutoConfirmOrders();
        
        for (Order order : orders) {
            orderService.confirmReceive(order.getOrderId(), "ç³»ç»Ÿè‡ªåŠ¨ç¡®è®¤");
        }
    }
}
```

## 7. ğŸš¨ è®¢å•å¼‚å¸¸å¤„ç†æœºåˆ¶


### 7.1 å¼‚å¸¸å¤„ç†ç­–ç•¥


è®¢å•ç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†å°±åƒåŒ»é™¢çš„æ€¥è¯Šç§‘ï¼Œéœ€è¦**å¿«é€Ÿè¯Šæ–­**ã€**åˆ†ç±»å¤„ç†**ã€**åŠæ—¶æ²»ç–—**ã€‚

```
å¼‚å¸¸å¤„ç†æµç¨‹å›¾ï¼š

å¼‚å¸¸å‘ç”Ÿ â†’ å¼‚å¸¸æ•è· â†’ å¼‚å¸¸åˆ†ç±» â†’ å¤„ç†ç­–ç•¥é€‰æ‹©
    â†“         â†“          â†“           â†“
 è®°å½•æ—¥å¿—   é”™è¯¯ä¸ŠæŠ¥   è‡ªåŠ¨æ¢å¤    äººå·¥ä»‹å…¥
    â†“         â†“          â†“           â†“
 å‘Šè­¦é€šçŸ¥   ç›‘æ§ç»Ÿè®¡   é‡è¯•æœºåˆ¶    è¡¥å¿æœºåˆ¶
```

### 7.2 è®¢å•å¼‚å¸¸åˆ†ç±»å¤„ç†


```java
@Component
public class OrderExceptionHandler {
    
    // åº“å­˜ä¸è¶³å¼‚å¸¸å¤„ç†
    @ExceptionHandler(InsufficientStockException.class)
    public void handleStockException(String orderId, InsufficientStockException e) {
        // 1. è®°å½•å¼‚å¸¸æ—¥å¿—
        logService.error("è®¢å•åº“å­˜ä¸è¶³", orderId, e);
        
        // 2. å–æ¶ˆè®¢å•
        orderService.cancelOrder(orderId, "åº“å­˜ä¸è¶³");
        
        // 3. é€šçŸ¥ç”¨æˆ·
        messageService.sendStockShortageMessage(orderId);
        
        // 4. é‡Šæ”¾å·²é”å®šçš„å…¶ä»–èµ„æº
        resourceService.releaseResources(orderId);
    }
    
    // æ”¯ä»˜å¼‚å¸¸å¤„ç†
    @ExceptionHandler(PaymentException.class) 
    public void handlePaymentException(String orderId, PaymentException e) {
        PaymentExceptionType type = e.getType();
        
        switch (type) {
            case NETWORK_ERROR:
                // ç½‘ç»œå¼‚å¸¸ï¼Œå»¶è¿Ÿé‡è¯•
                retryService.scheduleRetry(orderId, "payment", 60);
                break;
            case BALANCE_INSUFFICIENT:
                // ä½™é¢ä¸è¶³ï¼Œé€šçŸ¥ç”¨æˆ·å……å€¼
                messageService.sendBalanceInsufficientMessage(orderId);
                break;
            case ACCOUNT_FROZEN:
                // è´¦æˆ·å†»ç»“ï¼Œæš‚åœè®¢å•å¤„ç†
                orderService.suspendOrder(orderId, "è´¦æˆ·å¼‚å¸¸");
                break;
        }
    }
}
```

### 7.3 å¼‚å¸¸è‡ªåŠ¨ä¿®å¤æœºåˆ¶


```java
@Component
public class OrderAutoRepairService {
    
    // æ•°æ®ä¸€è‡´æ€§ä¿®å¤
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void repairDataConsistency() {
        // æŸ¥æ‰¾çŠ¶æ€ä¸ä¸€è‡´çš„è®¢å•
        List<String> inconsistentOrders = findInconsistentOrders();
        
        for (String orderId : inconsistentOrders) {
            try {
                repairOrderData(orderId);
            } catch (Exception e) {
                // ä¿®å¤å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ç­‰å¾…äººå·¥å¤„ç†
                alertService.sendRepairFailedAlert(orderId, e.getMessage());
            }
        }
    }
    
    private void repairOrderData(String orderId) {
        Order order = orderService.getById(orderId);
        
        // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ä¸è®¢å•çŠ¶æ€æ˜¯å¦ä¸€è‡´
        if (order.getOrderStatus() == OrderStatus.PENDING_PAYMENT 
            && paymentService.isPaid(orderId)) {
            // æ”¯ä»˜å·²å®Œæˆä½†è®¢å•çŠ¶æ€æœªæ›´æ–°ï¼Œä¿®å¤çŠ¶æ€
            orderService.updateOrderStatus(orderId, OrderStatus.PENDING_DELIVERY);
        }
        
        // æ£€æŸ¥åº“å­˜é”å®šçŠ¶æ€
        if (order.getOrderStatus() == OrderStatus.CANCELLED 
            && inventoryService.isStockLocked(orderId)) {
            // è®¢å•å·²å–æ¶ˆä½†åº“å­˜æœªé‡Šæ”¾ï¼Œé‡Šæ”¾åº“å­˜
            inventoryService.releaseStock(orderId);
        }
    }
}
```

## 8. ğŸ—‚ï¸ è®¢å•åˆ†åº“åˆ†è¡¨ç­–ç•¥


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨


éšç€ä¸šåŠ¡å‘å±•ï¼Œè®¢å•æ•°æ®ä¼š**è¶Šæ¥è¶Šå¤š**ï¼Œå•åº“å•è¡¨å°±åƒä¸€ä¸ªäººè¦æ¬ä¸€æ ‹æ¥¼ï¼ŒåŠ›ä¸ä»å¿ƒã€‚

**åˆ†åº“åˆ†è¡¨çš„å¥½å¤„**ï¼š
- âš¡ **æŸ¥è¯¢é€Ÿåº¦å¿«**ï¼šæ•°æ®åˆ†æ•£ï¼Œæ¯æ¬¡æŸ¥è¯¢çš„æ•°æ®é‡å°
- ğŸ’ª **å¹¶å‘èƒ½åŠ›å¼º**ï¼šå¤šä¸ªæ•°æ®åº“åŒæ—¶å·¥ä½œï¼Œå¤„ç†èƒ½åŠ›ç¿»å€
- ğŸ›¡ï¸ **é£é™©åˆ†æ•£**ï¼šä¸€ä¸ªåº“å‡ºé—®é¢˜ä¸å½±å“å…¶ä»–åº“

### 8.2 è®¢å•åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ


```
åˆ†åº“åˆ†è¡¨ç­–ç•¥å›¾ï¼š

æŒ‰ç”¨æˆ·IDåˆ†åº“(4ä¸ªåº“)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   order_0   â”‚  â”‚   order_1   â”‚  â”‚   order_2   â”‚  â”‚   order_3   â”‚  
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ user_id%4=0 â”‚  â”‚ user_id%4=1 â”‚  â”‚ user_id%4=2 â”‚  â”‚ user_id%4=3 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªåº“å†…æŒ‰æ—¶é—´åˆ†è¡¨(12ä¸ªè¡¨)ï¼š
order_main_202401, order_main_202402, ..., order_main_202412
```

### 8.3 åˆ†åº“åˆ†è¡¨å®ç°


```java
@Component
public class OrderShardingStrategy {
    
    private static final int DATABASE_COUNT = 4;
    private static final int TABLE_COUNT = 12;
    
    // æ ¹æ®ç”¨æˆ·IDç¡®å®šæ•°æ®åº“
    public String determineDatabase(Long userId) {
        int dbIndex = (int) (userId % DATABASE_COUNT);
        return "order_" + dbIndex;
    }
    
    // æ ¹æ®åˆ›å»ºæ—¶é—´ç¡®å®šè¡¨å
    public String determineTable(Date createTime) {
        String month = DateFormatUtils.format(createTime, "yyyyMM");
        return "order_main_" + month;
    }
    
    // è·å–å®Œæ•´çš„è¡¨å
    public String getTableName(Long userId, Date createTime) {
        String database = determineDatabase(userId);
        String table = determineTable(createTime);
        return database + "." + table;
    }
}
```

### 8.4 è·¨åº“æŸ¥è¯¢è§£å†³æ–¹æ¡ˆ


**é—®é¢˜**ï¼šåˆ†åº“åæŒ‰è®¢å•å·æŸ¥è¯¢éœ€è¦æŸ¥æ‰€æœ‰åº“ï¼Œæ•ˆç‡ä½ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå»ºç«‹**è®¢å•è·¯ç”±è¡¨**

```sql
CREATE TABLE `order_route` (
  `order_id` varchar(32) NOT NULL COMMENT 'è®¢å•ID',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID', 
  `database_name` varchar(20) NOT NULL COMMENT 'æ•°æ®åº“å',
  `table_name` varchar(50) NOT NULL COMMENT 'è¡¨å',
  `create_time` datetime NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  
  PRIMARY KEY (`order_id`),
  KEY `idx_user_id` (`user_id`)
) COMMENT='è®¢å•è·¯ç”±è¡¨';
```

```java
@Service
public class OrderQueryService {
    
    // æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å•
    public Order getByOrderId(String orderId) {
        // 1. ä»è·¯ç”±è¡¨è·å–æ•°æ®ä½ç½®
        OrderRoute route = routeService.getRoute(orderId);
        
        // 2. ä»å¯¹åº”çš„åº“è¡¨æŸ¥è¯¢æ•°æ®
        return orderMapper.selectByOrderId(
            route.getDatabaseName(), 
            route.getTableName(), 
            orderId
        );
    }
}
```

## 9. âš¡ è®¢å•æ€§èƒ½ä¼˜åŒ–


### 9.1 çƒ­ç‚¹è®¢å•æŸ¥è¯¢ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯çƒ­ç‚¹è®¢å•ï¼Ÿ**
æŸäº›è®¢å•è¢«**é¢‘ç¹æŸ¥è¯¢**ï¼Œæ¯”å¦‚ç½‘çº¢å•†å“çš„è®¢å•ã€VIPç”¨æˆ·çš„è®¢å•ç­‰ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

```java
@Service
public class OrderQueryOptimization {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // å¤šçº§ç¼“å­˜æŸ¥è¯¢
    public Order getOrder(String orderId) {
        // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜(1åˆ†é’Ÿ)
        Order order = localCache.get(orderId);
        if (order != null) {
            return order;
        }
        
        // L2ç¼“å­˜ï¼šRedisç¼“å­˜(10åˆ†é’Ÿ)  
        order = (Order) redisTemplate.opsForValue().get("order:" + orderId);
        if (order != null) {
            localCache.put(orderId, order, 60);
            return order;
        }
        
        // L3ç¼“å­˜ï¼šæ•°æ®åº“æŸ¥è¯¢
        order = orderMapper.selectById(orderId);
        if (order != null) {
            redisTemplate.opsForValue().set("order:" + orderId, order, Duration.ofMinutes(10));
            localCache.put(orderId, order, 60);
        }
        
        return order;
    }
}
```

### 9.2 è®¢å•åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–


**ç”¨æˆ·è®¢å•åˆ—è¡¨**æ˜¯é«˜é¢‘æŸ¥è¯¢åœºæ™¯ï¼Œéœ€è¦ç‰¹åˆ«ä¼˜åŒ–ã€‚

```java
@Service
public class OrderListOptimization {
    
    // åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
    public PageResult<Order> getUserOrders(Long userId, int page, int size) {
        String cacheKey = "user_orders:" + userId + ":" + page;
        
        // å…ˆä»ç¼“å­˜è·å–
        PageResult<Order> result = (PageResult) redisTemplate.opsForValue().get(cacheKey);
        if (result != null) {
            return result;
        }
        
        // æ•°æ®åº“æŸ¥è¯¢ï¼ŒåªæŸ¥è¯¢å¿…è¦å­—æ®µ
        List<OrderListVO> orders = orderMapper.selectUserOrderList(userId, page * size, size);
        
        // æ„å»ºè¿”å›ç»“æœå¹¶ç¼“å­˜
        result = PageResult.of(orders, getTotalCount(userId));
        redisTemplate.opsForValue().set(cacheKey, result, Duration.ofMinutes(5));
        
        return result;
    }
    
    // åªæŸ¥è¯¢åˆ—è¡¨éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
    private static final String ORDER_LIST_COLUMNS = """
        order_id, order_no, total_amount, pay_amount, 
        order_status, create_time, pay_time
        """;
}
```

### 9.3 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–


```sql
-- ç”¨æˆ·è®¢å•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_user_status_time ON order_main(user_id, order_status, create_time DESC);

-- è®¢å•å·æŸ¥è¯¢ç´¢å¼•  
CREATE UNIQUE INDEX uk_order_no ON order_main(order_no);

-- æ”¯ä»˜æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_pay_time ON order_main(pay_time) WHERE pay_time IS NOT NULL;

-- å•†å®¶è®¢å•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_shop_status_time ON order_main(shop_id, order_status, create_time DESC);
```

## 10. ğŸ‰ å¤§ä¿ƒæœŸé—´ç‰¹æ®Šå¤„ç†


### 10.1 å¤§ä¿ƒæœŸé—´çš„æŒ‘æˆ˜


å¤§ä¿ƒå°±åƒ"æ˜¥è¿"ï¼Œå¹³æ—¶èƒ½æ­£å¸¸è¿è¡Œçš„ç³»ç»Ÿåœ¨æµé‡æš´å¢æ—¶å¯èƒ½**æ‰›ä¸ä½**ã€‚

**ä¸»è¦æŒ‘æˆ˜**ï¼š
- ğŸ”¥ **æµé‡æš´å¢**ï¼šå¹³æ—¶100å€çš„è®¿é—®é‡
- âš¡ **å“åº”è¦æ±‚**ï¼šç”¨æˆ·æœŸæœ›æ›´å¿«çš„ä¸‹å•é€Ÿåº¦  
- ğŸ’° **èµ„æºé™åˆ¶**ï¼šä¸èƒ½æ— é™å¢åŠ æœåŠ¡å™¨
- ğŸ›¡ï¸ **ç³»ç»Ÿç¨³å®š**ï¼šç»å¯¹ä¸èƒ½å®•æœº

### 10.2 å‰Šå³°å¡«è°·æ–¹æ¡ˆ


**å‰Šå³°å¡«è°·**å°±åƒæ°´åº“è°ƒèŠ‚æ°´æµï¼Œ**é«˜å³°æ—¶æš‚å­˜ï¼Œä½å³°æ—¶é‡Šæ”¾**ã€‚

```
å‰Šå³°å¡«è°·æµç¨‹å›¾ï¼š

ç”¨æˆ·ä¸‹å•è¯·æ±‚ â†’ è¯·æ±‚é˜Ÿåˆ— â†’ è®¢å•åˆ›å»ºæœåŠ¡ â†’ æ•°æ®åº“
      â†“            â†“            â†“            â†“
   æµé‡é«˜å³°      æš‚å­˜é˜Ÿåˆ—      å¹³ç¨³å¤„ç†      ç¨³å®šå†™å…¥
   (10000/s)   (å¼‚æ­¥å¤„ç†)    (1000/s)    (ä¸è¶…è½½)
```

```java
@Service
public class PeakShavingService {
    
    @Autowired
    private RabbitMQ rabbitMQ;
    
    // è®¢å•åˆ›å»ºè¯·æ±‚æ”¾å…¥é˜Ÿåˆ—
    public OrderResult submitOrder(OrderRequest request) {
        // 1. å¿«é€Ÿæ ¡éªŒ
        if (!basicValidate(request)) {
            return OrderResult.fail("å‚æ•°æ ¡éªŒå¤±è´¥");
        }
        
        // 2. ç”Ÿæˆä¸´æ—¶è®¢å•ID
        String tempOrderId = generateTempOrderId();
        
        // 3. æ”¾å…¥å¤„ç†é˜Ÿåˆ—
        OrderMessage message = new OrderMessage(tempOrderId, request);
        rabbitMQ.send("order.create.queue", message);
        
        // 4. ç«‹å³è¿”å›ç»“æœ
        return OrderResult.success("è®¢å•æäº¤æˆåŠŸï¼Œæ­£åœ¨å¤„ç†ä¸­", tempOrderId);
    }
    
    // å¼‚æ­¥å¤„ç†è®¢å•åˆ›å»º
    @RabbitListener(queues = "order.create.queue")
    public void processOrderCreate(OrderMessage message) {
        try {
            // çœŸæ­£çš„è®¢å•åˆ›å»ºé€»è¾‘
            Order order = orderService.createOrder(message.getRequest());
            
            // æ›´æ–°ä¸´æ—¶è®¢å•IDæ˜ å°„
            mappingService.updateTempOrderId(message.getTempOrderId(), order.getOrderId());
            
            // é€šçŸ¥ç”¨æˆ·å¤„ç†å®Œæˆ
            messageService.sendOrderCreatedNotify(order.getOrderId());
            
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œé€šçŸ¥ç”¨æˆ·é‡è¯•
            messageService.sendOrderFailedNotify(message.getTempOrderId());
        }
    }
}
```

### 10.3 é™æµç†”æ–­æœºåˆ¶


```java
@Component
public class OrderRateLimiter {
    
    // åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ
    @Autowired
    private RedisTemplate redisTemplate;
    
    public boolean allowRequest(Long userId) {
        String key = "rate_limit:user:" + userId;
        String script = """
            local key = KEYS[1]
            local limit = tonumber(ARGV[1])
            local window = tonumber(ARGV[2])
            
            local current = redis.call('GET', key)
            if current == false then
                redis.call('SETEX', key, window, 1)
                return 1
            end
            
            if tonumber(current) < limit then
                redis.call('INCR', key)
                return 1
            else
                return 0
            end
            """;
        
        // æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡ä¸‹å•è¯·æ±‚
        Long result = (Long) redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Collections.singletonList(key),
            "10", "60"
        );
        
        return result == 1;
    }
    
    // ç³»ç»Ÿçº§ç†”æ–­å™¨
    @CircuitBreaker(name = "order-create", fallbackMethod = "createOrderFallback")
    public OrderResult createOrder(OrderRequest request) {
        return orderService.doCreateOrder(request);
    }
    
    public OrderResult createOrderFallback(OrderRequest request, Exception e) {
        return OrderResult.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 10.4 æ•°æ®é¢„çƒ­ç­–ç•¥


**æ•°æ®é¢„çƒ­**å°±æ˜¯æå‰æŠŠ**çƒ­é—¨æ•°æ®**åŠ è½½åˆ°ç¼“å­˜ï¼Œé¿å…å¤§ä¿ƒæ—¶ä¸´æ—¶æŸ¥è¯¢ã€‚

```java
@Component
public class DataWarmUpService {
    
    // å¤§ä¿ƒå‰æ•°æ®é¢„çƒ­
    @Scheduled(cron = "0 0 10 * * ?") // æ¯å¤©ä¸Šåˆ10ç‚¹æ‰§è¡Œ
    public void warmUpData() {
        // 1. é¢„çƒ­çƒ­é—¨å•†å“ä¿¡æ¯
        List<Long> hotProducts = getHotProducts();
        for (Long productId : hotProducts) {
            productService.loadToCache(productId);
        }
        
        // 2. é¢„çƒ­ç”¨æˆ·ä¿¡æ¯
        List<Long> vipUsers = getVipUsers();
        for (Long userId : vipUsers) {
            userService.loadToCache(userId);
        }
        
        // 3. é¢„çƒ­åº“å­˜ä¿¡æ¯
        List<Long> stockItems = getStockItems();
        for (Long itemId : stockItems) {
            inventoryService.loadToCache(itemId);
        }
        
        log.info("æ•°æ®é¢„çƒ­å®Œæˆï¼šå•†å“{}ä¸ªï¼Œç”¨æˆ·{}ä¸ªï¼Œåº“å­˜{}ä¸ª", 
                hotProducts.size(), vipUsers.size(), stockItems.size());
    }
}
```

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¢å•ä¸­å¿ƒï¼šç”µå•†ç³»ç»Ÿçš„è®¢å•ç®¡ç†æ ¸å¿ƒï¼Œè´Ÿè´£è®¢å•å…¨ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ çŠ¶æ€æœºï¼šæ§åˆ¶è®¢å•çŠ¶æ€åˆæ³•è½¬æ¢ï¼Œç¡®ä¿ä¸šåŠ¡æµç¨‹æ­£ç¡®æ€§  
ğŸ”¸ æ•°æ®å¿«ç…§ï¼šä¿ç•™ä¸‹å•æ—¶çš„ä¿¡æ¯ï¼Œç”¨äºçº çº·å¤„ç†å’Œå†å²æŸ¥è¯¢
ğŸ”¸ é‡‘é¢è®¡ç®—ï¼šå¤„ç†å¤æ‚çš„ä»·æ ¼ã€ä¼˜æƒ ã€è¿è´¹è®¡ç®—é€»è¾‘
ğŸ”¸ å¹‚ç­‰æ€§ï¼šç¡®ä¿é‡å¤æ“ä½œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šè‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼Œæé«˜ç³»ç»Ÿå¯ç”¨æ€§
```

### 11.2 å…³é”®è®¾è®¡åŸåˆ™


**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§ä¼˜å…ˆ**
```
è®¾è®¡åŸåˆ™ï¼š
- è®¢å•çŠ¶æ€å˜æ›´å¿…é¡»åŸå­æ€§æ“ä½œ
- æ¶‰åŠèµ„é‡‘çš„æ“ä½œå¿…é¡»æœ‰äº‹åŠ¡ä¿æŠ¤
- å¼‚å¸¸æƒ…å†µä¸‹ä¼˜å…ˆä¿è¯æ•°æ®å‡†ç¡®æ€§
```

**ğŸ”¹ ç”¨æˆ·ä½“éªŒå¹³è¡¡**
```
å¹³è¡¡ç­–ç•¥ï¼š
- å“åº”é€Ÿåº¦ vs æ•°æ®å‡†ç¡®æ€§ï¼šä¼˜å…ˆå‡†ç¡®æ€§
- åŠŸèƒ½å®Œæ•´ vs ç³»ç»Ÿç¨³å®šï¼šä¼˜å…ˆç¨³å®šæ€§  
- å®æ—¶å¤„ç† vs ç³»ç»Ÿè´Ÿè½½ï¼šé‡‡ç”¨å¼‚æ­¥å¤„ç†
```

**ğŸ”¹ å¯æ‰©å±•æ¶æ„è®¾è®¡**
```
æ‰©å±•è€ƒè™‘ï¼š
- åˆ†åº“åˆ†è¡¨æ”¯æŒæ•°æ®é‡å¢é•¿
- æ¶ˆæ¯é˜Ÿåˆ—æ”¯æŒæµé‡å‰Šå³°
- ç¼“å­˜æœºåˆ¶æ”¯æŒå¹¶å‘æŸ¥è¯¢
- ç›‘æ§å‘Šè­¦æ”¯æŒè¿ç»´ç®¡ç†
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†å¹³å°**ï¼šå®Œæ•´çš„è®¢å•ç®¡ç†ä½“ç³»
- **O2OæœåŠ¡**ï¼šæœ¬åœ°æœåŠ¡è®¢å•å¤„ç†
- **æ•°å­—å•†å“**ï¼šè™šæ‹Ÿå•†å“äº¤æ˜“ç®¡ç†
- **B2Bå¹³å°**ï¼šä¼ä¸šé—´è®¢å•åè°ƒ

**ğŸ”§ æŠ€æœ¯å®è·µæ”¶è·**
- **åˆ†å¸ƒå¼æ¶æ„**ï¼šæŒæ¡å¤§è§„æ¨¡ç³»ç»Ÿè®¾è®¡æ€è·¯
- **æ•°æ®åº“è®¾è®¡**ï¼šå­¦ä¼šå¤æ‚ä¸šåŠ¡çš„æ•°æ®å»ºæ¨¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šäº†è§£é«˜å¹¶å‘åœºæ™¯çš„ä¼˜åŒ–æ–¹æ³•
- **å¼‚å¸¸å¤„ç†**ï¼šå»ºç«‹å®Œå–„çš„å®¹é”™æœºåˆ¶

### 11.4 è¿›é˜¶å­¦ä¹ å»ºè®®


```
æ·±å…¥å­¦ä¹ è·¯å¾„ï¼š
ğŸ“š ç†è®ºåŸºç¡€ â†’ ğŸ—ï¸ æ¶æ„è®¾è®¡ â†’ ğŸ’» ä»£ç å®ç° â†’ ğŸš€ æ€§èƒ½ä¼˜åŒ–

å…·ä½“å»ºè®®ï¼š
1. æ·±å…¥ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡ç†è®º
2. å­¦ä¹ æ¶ˆæ¯é˜Ÿåˆ—çš„é«˜çº§ç”¨æ³•  
3. æŒæ¡ç¼“å­˜æ¶æ„çš„è®¾è®¡æ¨¡å¼
4. äº†è§£ç›‘æ§å’Œè¿ç»´çš„æœ€ä½³å®è·µ
5. ç ”ç©¶å¤§å‚çš„è®¢å•ç³»ç»Ÿæ¶æ„æ¡ˆä¾‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- *è®¢å•ä¸­å¿ƒç®¡å…¨ç¨‹ï¼ŒçŠ¶æ€æœºåˆ¶ä¿æµç¨‹*
- *æ•°æ®å¿«ç…§é˜²çº çº·ï¼Œé‡‘é¢è®¡ç®—è¦ç²¾å‡†*  
- *å¹‚ç­‰è®¾è®¡é˜²é‡å¤ï¼Œå¼‚å¸¸å¤„ç†è¦å®Œå¤‡*
- *åˆ†åº“åˆ†è¡¨æ’‘å¤§é‡ï¼Œç¼“å­˜ä¼˜åŒ–æé€Ÿåº¦*
- *å¤§ä¿ƒå‰Šå³°ç”¨é˜Ÿåˆ—ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š*