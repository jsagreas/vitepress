---
title: 2ã€äº¤æ˜“ç³»ç»Ÿè®¾è®¡
---
## ğŸ“š ç›®å½•

1. [äº¤æ˜“ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-äº¤æ˜“ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [äº¤æ˜“æµæ°´è®°å½•è®¾è®¡](#2-äº¤æ˜“æµæ°´è®°å½•è®¾è®¡)
3. [äº¤æ˜“çŠ¶æ€æœºç®¡ç†](#3-äº¤æ˜“çŠ¶æ€æœºç®¡ç†)
4. [äº¤æ˜“è·¯ç”±ä¸é™é¢æ§åˆ¶](#4-äº¤æ˜“è·¯ç”±ä¸é™é¢æ§åˆ¶)
5. [äº¤æ˜“è´¹ç”¨è®¡ç®—æœºåˆ¶](#5-äº¤æ˜“è´¹ç”¨è®¡ç®—æœºåˆ¶)
6. [äº¤æ˜“å¹‚ç­‰æ€§ä¿è¯](#6-äº¤æ˜“å¹‚ç­‰æ€§ä¿è¯)
7. [äº¤æ˜“æ—¶åºä¸æ‰¹å¤„ç†](#7-äº¤æ˜“æ—¶åºä¸æ‰¹å¤„ç†)
8. [äº¤æ˜“å¼‚å¸¸å¤„ç†æœºåˆ¶](#8-äº¤æ˜“å¼‚å¸¸å¤„ç†æœºåˆ¶)
9. [äº¤æ˜“å¯¹è´¦ä¸ç›‘æ§](#9-äº¤æ˜“å¯¹è´¦ä¸ç›‘æ§)
10. [é«˜å¹¶å‘äº¤æ˜“ä¼˜åŒ–](#10-é«˜å¹¶å‘äº¤æ˜“ä¼˜åŒ–)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’° äº¤æ˜“ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯äº¤æ˜“ç³»ç»Ÿ


**ğŸ”¸ ç®€å•ç†è§£**
```
äº¤æ˜“ç³»ç»Ÿå°±åƒé“¶è¡Œçš„"æ”¶é“¶å°"ï¼š
- å¤„ç†æ‰€æœ‰çš„è½¬è´¦ã€æ”¯ä»˜ã€å……å€¼ç­‰æ“ä½œ
- ç¡®ä¿æ¯ç¬”é’±éƒ½èƒ½å‡†ç¡®è®°å½•å’Œå¤„ç†
- ä¿è¯äº¤æ˜“å®‰å…¨å¯é ï¼Œä¸ä¼šå‡ºç°é’±ä¸¢å¤±çš„æƒ…å†µ
```

**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
- **è®°å½•äº¤æ˜“**ï¼šæ¯ç¬”é’±çš„è¿›å‡ºéƒ½è¦è¯¦ç»†è®°å½•
- **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªäº¤æ˜“æ˜¯å¦æˆåŠŸã€å¤±è´¥æˆ–è¿›è¡Œä¸­
- **é£é™©æ§åˆ¶**ï¼šé˜²æ­¢è¶…é¢äº¤æ˜“ã€é‡å¤æ‰£æ¬¾ç­‰é—®é¢˜
- **æ•°æ®ä¸€è‡´**ï¼šç¡®ä¿è´¦æˆ·ä½™é¢å’Œäº¤æ˜“è®°å½•å®Œå…¨åŒ¹é…

### 1.2 äº¤æ˜“ç³»ç»Ÿæ ¸å¿ƒç»„ä»¶


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¯·æ±‚      â”‚â”€â”€â”€â†’â”‚   äº¤æ˜“å¤„ç†      â”‚â”€â”€â”€â†’â”‚   è´¦æˆ·æ›´æ–°      â”‚
â”‚  (å‘èµ·äº¤æ˜“)     â”‚    â”‚  (éªŒè¯+æ‰§è¡Œ)    â”‚    â”‚  (ä½™é¢å˜æ›´)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â–¼                       â”‚
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
         â”‚              â”‚   äº¤æ˜“è®°å½•      â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  (æµæ°´æ—¥å¿—)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“‹ äº¤æ˜“æµæ°´è®°å½•è®¾è®¡


### 2.1 äº¤æ˜“æµæ°´çš„ä½œç”¨


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦äº¤æ˜“æµæ°´ï¼Ÿ**
```
å°±åƒè´­ç‰©å°ç¥¨ä¸€æ ·ï¼š
âœ… è®°å½•æ¯ä¸€ç¬”äº¤æ˜“çš„è¯¦ç»†ä¿¡æ¯
âœ… å‡ºé—®é¢˜æ—¶å¯ä»¥è¿½æŸ¥å’Œæ ¸å¯¹
âœ… æœˆåº•å¯¹è´¦æ—¶æœ‰ä¾æ®
âœ… ç›‘ç®¡éƒ¨é—¨æ£€æŸ¥æ—¶æœ‰è¯æ®
```

### 2.2 äº¤æ˜“æµæ°´è¡¨è®¾è®¡


**ğŸ’¾ æ ¸å¿ƒå­—æ®µè¯´æ˜**
```sql
CREATE TABLE trade_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'æµæ°´ID',
    trade_no VARCHAR(32) UNIQUE NOT NULL COMMENT 'äº¤æ˜“æµæ°´å·',
    business_no VARCHAR(32) COMMENT 'ä¸šåŠ¡è®¢å•å·',
    trade_type TINYINT NOT NULL COMMENT 'äº¤æ˜“ç±»å‹(1å……å€¼2æç°3è½¬è´¦4æ”¯ä»˜)',
    
    -- äº¤æ˜“é‡‘é¢ä¿¡æ¯
    amount DECIMAL(15,2) NOT NULL COMMENT 'äº¤æ˜“é‡‘é¢',
    currency VARCHAR(3) DEFAULT 'CNY' COMMENT 'å¸ç§',
    fee DECIMAL(10,2) DEFAULT 0 COMMENT 'æ‰‹ç»­è´¹',
    
    -- äº¤æ˜“è´¦æˆ·ä¿¡æ¯  
    from_account VARCHAR(20) COMMENT 'å‡ºè´¦è´¦æˆ·',
    to_account VARCHAR(20) COMMENT 'å…¥è´¦è´¦æˆ·',
    
    -- äº¤æ˜“çŠ¶æ€å’Œæ—¶é—´
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(1å¤„ç†ä¸­2æˆåŠŸ3å¤±è´¥4å·²æ’¤é”€)',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    finish_time DATETIME COMMENT 'å®Œæˆæ—¶é—´',
    
    -- æ‰©å±•ä¿¡æ¯
    remark VARCHAR(200) COMMENT 'äº¤æ˜“å¤‡æ³¨',
    channel VARCHAR(20) COMMENT 'äº¤æ˜“æ¸ é“',
    
    INDEX idx_trade_no(trade_no),
    INDEX idx_account_time(from_account, create_time),
    INDEX idx_status_time(status, create_time)
) COMMENT='äº¤æ˜“æµæ°´è¡¨';
```

**ğŸ¯ å­—æ®µè®¾è®¡è¦ç‚¹**
- **trade_no**ï¼šå…¨å±€å”¯ä¸€çš„äº¤æ˜“æµæ°´å·ï¼Œæ–¹ä¾¿è·Ÿè¸ª
- **business_no**ï¼šä¸šåŠ¡è®¢å•å·ï¼Œå…³è”å…·ä½“ä¸šåŠ¡
- **é‡‘é¢å­—æ®µ**ï¼šä½¿ç”¨DECIMALé¿å…ç²¾åº¦ä¸¢å¤±
- **è´¦æˆ·ä¿¡æ¯**ï¼šè®°å½•èµ„é‡‘æµå‘ï¼Œä¾¿äºå¯¹è´¦
- **æ—¶é—´å­—æ®µ**ï¼šåˆ›å»ºæ—¶é—´å’Œå®Œæˆæ—¶é—´åˆ†å¼€è®°å½•

### 2.3 äº¤æ˜“æµæ°´å·ç”Ÿæˆè§„åˆ™


**ğŸ”¢ æµæ°´å·è®¾è®¡**
```java
/**
 * äº¤æ˜“æµæ°´å·ç”Ÿæˆå™¨
 * æ ¼å¼ï¼šTXN + å¹´æœˆæ—¥ + 6ä½åºåˆ—å·
 * ç¤ºä¾‹ï¼šTXN202509100000001
 */
@Component
public class TradeNoGenerator {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    public String generateTradeNo() {
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String key = "trade:seq:" + dateStr;
        
        // ä½¿ç”¨Redisç”Ÿæˆè‡ªå¢åºåˆ—å·
        Long seq = redisTemplate.opsForValue().increment(key);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…Rediså†…å­˜ç§¯ç´¯
        redisTemplate.expire(key, Duration.ofDays(1));
        
        return String.format("TXN%s%06d", dateStr, seq);
    }
}
```

---

## 3. ğŸ”„ äº¤æ˜“çŠ¶æ€æœºç®¡ç†


### 3.1 äº¤æ˜“çŠ¶æ€è®¾è®¡


**ğŸ“Š çŠ¶æ€æµè½¬å›¾**
```
    [åˆå§‹åŒ–] â”€â”€â”€â”€â”€â”€â†’ [å¤„ç†ä¸­] â”€â”€â”€â”€â”€â”€â†’ [æˆåŠŸ]
        â”‚              â”‚               â–²
        â”‚              â”‚               â”‚
        â”‚              â–¼               â”‚
        â”‚           [å¤±è´¥] â”€â”€â”€â”€â”€â”€â†’ [é‡è¯•] â”€â”€â”˜
        â”‚              â”‚
        â”‚              â–¼
        â””â”€â”€â”€â”€â”€â”€â†’ [å·²æ’¤é”€/å†²æ­£]
```

**ğŸ”¸ çŠ¶æ€å«ä¹‰è¯´æ˜**
```java
public enum TradeStatus {
    PROCESSING(1, "å¤„ç†ä¸­"),    // äº¤æ˜“æ­£åœ¨æ‰§è¡Œ
    SUCCESS(2, "æˆåŠŸ"),        // äº¤æ˜“å®Œæˆ
    FAILED(3, "å¤±è´¥"),         // äº¤æ˜“å¤±è´¥  
    CANCELLED(4, "å·²æ’¤é”€"),    // äº¤æ˜“è¢«æ’¤é”€
    TIMEOUT(5, "è¶…æ—¶");        // äº¤æ˜“è¶…æ—¶
    
    private final int code;
    private final String desc;
}
```

### 3.2 çŠ¶æ€æœºå®ç°


**âš™ï¸ çŠ¶æ€è½¬æ¢æ§åˆ¶**
```java
@Service
public class TradeStateMachine {
    
    /**
     * çŠ¶æ€è½¬æ¢è§„åˆ™éªŒè¯
     */
    private static final Map<TradeStatus, Set<TradeStatus>> ALLOWED_TRANSITIONS = 
        Map.of(
            TradeStatus.PROCESSING, Set.of(TradeStatus.SUCCESS, TradeStatus.FAILED, TradeStatus.TIMEOUT),
            TradeStatus.FAILED, Set.of(TradeStatus.PROCESSING), // å…è®¸é‡è¯•
            TradeStatus.SUCCESS, Set.of(TradeStatus.CANCELLED)   // å…è®¸æ’¤é”€
        );
    
    /**
     * æ›´æ–°äº¤æ˜“çŠ¶æ€
     */
    public boolean updateTradeStatus(String tradeNo, TradeStatus newStatus, String reason) {
        TradeRecord trade = tradeMapper.selectByTradeNo(tradeNo);
        TradeStatus currentStatus = TradeStatus.fromCode(trade.getStatus());
        
        // æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
        if (!isValidTransition(currentStatus, newStatus)) {
            log.warn("éæ³•çŠ¶æ€è½¬æ¢: {} -> {}, äº¤æ˜“å·: {}", currentStatus, newStatus, tradeNo);
            return false;
        }
        
        // æ›´æ–°çŠ¶æ€å’Œå®Œæˆæ—¶é—´
        trade.setStatus(newStatus.getCode());
        trade.setRemark(reason);
        
        if (newStatus == TradeStatus.SUCCESS || newStatus == TradeStatus.FAILED) {
            trade.setFinishTime(new Date());
        }
        
        return tradeMapper.updateById(trade) > 0;
    }
    
    private boolean isValidTransition(TradeStatus from, TradeStatus to) {
        return ALLOWED_TRANSITIONS.getOrDefault(from, Collections.emptySet()).contains(to);
    }
}
```

---

## 4. ğŸ¯ äº¤æ˜“è·¯ç”±ä¸é™é¢æ§åˆ¶


### 4.1 äº¤æ˜“è·¯ç”±è§„åˆ™


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº¤æ˜“è·¯ç”±ï¼Ÿ**
```
å°±åƒå¿«é€’åˆ†æ‹£ä¸­å¿ƒï¼š
- ä¸åŒç±»å‹çš„äº¤æ˜“èµ°ä¸åŒçš„å¤„ç†é€šé“
- å°é¢äº¤æ˜“èµ°å¿«é€Ÿé€šé“
- å¤§é¢äº¤æ˜“èµ°ä¸¥æ ¼å®¡æ ¸é€šé“
- è·¨å¢ƒäº¤æ˜“èµ°ä¸“é—¨çš„å›½é™…é€šé“
```

### 4.2 è·¯ç”±è§„åˆ™é…ç½®


**ğŸ“‹ è·¯ç”±é…ç½®è¡¨**
```sql
CREATE TABLE trade_route_rule (
    id INT PRIMARY KEY AUTO_INCREMENT,
    rule_name VARCHAR(50) NOT NULL COMMENT 'è§„åˆ™åç§°',
    trade_type TINYINT COMMENT 'äº¤æ˜“ç±»å‹',
    min_amount DECIMAL(15,2) COMMENT 'æœ€å°é‡‘é¢',
    max_amount DECIMAL(15,2) COMMENT 'æœ€å¤§é‡‘é¢',
    channel VARCHAR(20) NOT NULL COMMENT 'å¤„ç†é€šé“',
    priority INT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€(1å¯ç”¨0åœç”¨)',
    
    INDEX idx_type_amount(trade_type, min_amount, max_amount)
) COMMENT='äº¤æ˜“è·¯ç”±è§„åˆ™è¡¨';
```

**ğŸ¯ è·¯ç”±å™¨å®ç°**
```java
@Service
public class TradeRouter {
    
    /**
     * æ ¹æ®äº¤æ˜“ä¿¡æ¯é€‰æ‹©å¤„ç†é€šé“
     */
    public String routeTrade(TradeRequest request) {
        List<TradeRouteRule> rules = routeRuleMapper.selectEnabledRules();
        
        for (TradeRouteRule rule : rules) {
            if (matchRule(request, rule)) {
                log.info("äº¤æ˜“è·¯ç”±: {} -> {}", request.getTradeNo(), rule.getChannel());
                return rule.getChannel();
            }
        }
        
        return "default"; // é»˜è®¤é€šé“
    }
    
    private boolean matchRule(TradeRequest request, TradeRouteRule rule) {
        // æ£€æŸ¥äº¤æ˜“ç±»å‹
        if (rule.getTradeType() != null && !rule.getTradeType().equals(request.getTradeType())) {
            return false;
        }
        
        // æ£€æŸ¥é‡‘é¢èŒƒå›´
        BigDecimal amount = request.getAmount();
        if (rule.getMinAmount() != null && amount.compareTo(rule.getMinAmount()) < 0) {
            return false;
        }
        if (rule.getMaxAmount() != null && amount.compareTo(rule.getMaxAmount()) > 0) {
            return false;
        }
        
        return true;
    }
}
```

### 4.3 äº¤æ˜“é™é¢æ§åˆ¶


**ğŸ’¡ é™é¢æ§åˆ¶åŸç†**
```
å°±åƒé“¶è¡Œå¡çš„æ¯æ—¥é™é¢ï¼š
- é˜²æ­¢è´¦æˆ·è¢«ç›—ç”¨åå¤§é¢æŸå¤±
- æ§åˆ¶é£é™©åœ¨å¯æ¥å—èŒƒå›´å†…
- ä¸åŒç­‰çº§ç”¨æˆ·æœ‰ä¸åŒé™é¢
- å¯ä»¥è®¾ç½®å•ç¬”ã€æ—¥ç´¯è®¡ã€æœˆç´¯è®¡é™é¢
```

**ğŸ›¡ï¸ é™é¢æ£€æŸ¥å®ç°**
```java
@Service
public class TradeLimitChecker {
    
    /**
     * æ£€æŸ¥äº¤æ˜“æ˜¯å¦è¶…è¿‡é™é¢
     */
    public LimitCheckResult checkLimit(String accountId, BigDecimal amount, int tradeType) {
        // è·å–è´¦æˆ·é™é¢é…ç½®
        AccountLimit limit = limitMapper.selectByAccount(accountId);
        
        // æ£€æŸ¥å•ç¬”é™é¢
        if (amount.compareTo(limit.getSingleLimit()) > 0) {
            return LimitCheckResult.fail("è¶…è¿‡å•ç¬”é™é¢: " + limit.getSingleLimit());
        }
        
        // æ£€æŸ¥æ—¥ç´¯è®¡é™é¢
        BigDecimal todayTotal = getTodayTradeAmount(accountId, tradeType);
        if (todayTotal.add(amount).compareTo(limit.getDailyLimit()) > 0) {
            return LimitCheckResult.fail("è¶…è¿‡æ—¥ç´¯è®¡é™é¢: " + limit.getDailyLimit());
        }
        
        return LimitCheckResult.success();
    }
    
    private BigDecimal getTodayTradeAmount(String accountId, int tradeType) {
        LocalDate today = LocalDate.now();
        return tradeMapper.sumAmountByAccountAndDate(accountId, tradeType, today);
    }
}
```

---

## 5. ğŸ’° äº¤æ˜“è´¹ç”¨è®¡ç®—æœºåˆ¶


### 5.1 æ‰‹ç»­è´¹è®¡ç®—è§„åˆ™


**ğŸ”¸ è´¹ç”¨è®¡ç®—é€»è¾‘**
```
æ‰‹ç»­è´¹è®¡ç®—å°±åƒå•†åº—æ”¶å–æœåŠ¡è´¹ï¼š
- æŒ‰æ¯”ä¾‹æ”¶è´¹ï¼šäº¤æ˜“é‡‘é¢ Ã— è´¹ç‡
- é˜¶æ¢¯æ”¶è´¹ï¼šä¸åŒé‡‘é¢åŒºé—´ä¸åŒè´¹ç‡  
- å°é¡¶æ”¶è´¹ï¼šæœ€é«˜ä¸è¶…è¿‡æŸä¸ªé‡‘é¢
- å…è´¹é¢åº¦ï¼šVIPç”¨æˆ·æˆ–å°é¢äº¤æ˜“å…è´¹
```

### 5.2 è´¹ç‡é…ç½®è¡¨è®¾è®¡


**ğŸ“Š è´¹ç‡é…ç½®**
```sql
CREATE TABLE fee_config (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_type TINYINT NOT NULL COMMENT 'äº¤æ˜“ç±»å‹',
    user_level TINYINT COMMENT 'ç”¨æˆ·ç­‰çº§',
    min_amount DECIMAL(15,2) COMMENT 'æœ€å°é‡‘é¢',
    max_amount DECIMAL(15,2) COMMENT 'æœ€å¤§é‡‘é¢',
    fee_rate DECIMAL(6,4) COMMENT 'è´¹ç‡(å¦‚0.0050è¡¨ç¤º0.5%)',
    min_fee DECIMAL(10,2) DEFAULT 0 COMMENT 'æœ€ä½æ”¶è´¹',
    max_fee DECIMAL(10,2) COMMENT 'æœ€é«˜æ”¶è´¹',
    
    INDEX idx_type_level(trade_type, user_level)
) COMMENT='æ‰‹ç»­è´¹é…ç½®è¡¨';
```

### 5.3 è´¹ç”¨è®¡ç®—å™¨å®ç°


**âš™ï¸ è®¡ç®—é€»è¾‘**
```java
@Service
public class FeeCalculator {
    
    /**
     * è®¡ç®—äº¤æ˜“æ‰‹ç»­è´¹
     */
    public BigDecimal calculateFee(BigDecimal amount, int tradeType, int userLevel) {
        FeeConfig config = feeConfigMapper.selectByTypeAndLevel(tradeType, userLevel);
        
        if (config == null) {
            return BigDecimal.ZERO; // æ— é…ç½®é»˜è®¤å…è´¹
        }
        
        // æŒ‰æ¯”ä¾‹è®¡ç®—è´¹ç”¨
        BigDecimal fee = amount.multiply(config.getFeeRate());
        
        // åº”ç”¨æœ€ä½è´¹ç”¨é™åˆ¶
        if (config.getMinFee() != null && fee.compareTo(config.getMinFee()) < 0) {
            fee = config.getMinFee();
        }
        
        // åº”ç”¨æœ€é«˜è´¹ç”¨é™åˆ¶
        if (config.getMaxFee() != null && fee.compareTo(config.getMaxFee()) > 0) {
            fee = config.getMaxFee();
        }
        
        return fee;
    }
    
    /**
     * è´¹ç”¨æ˜ç»†è®¡ç®—
     */
    public FeeDetail calculateFeeDetail(TradeRequest request) {
        BigDecimal baseFee = calculateFee(request.getAmount(), request.getTradeType(), request.getUserLevel());
        
        FeeDetail detail = new FeeDetail();
        detail.setBaseFee(baseFee);
        detail.setDiscountFee(calculateDiscount(request, baseFee));
        detail.setTotalFee(baseFee.subtract(detail.getDiscountFee()));
        
        return detail;
    }
}
```

---

## 6. ğŸ”’ äº¤æ˜“å¹‚ç­‰æ€§ä¿è¯


### 6.1 ä»€ä¹ˆæ˜¯äº¤æ˜“å¹‚ç­‰æ€§


**ğŸ’¡ é€šä¿—ç†è§£**
```
å¹‚ç­‰æ€§å°±åƒç”µæ¢¯æŒ‰é”®ï¼š
- æ— è®ºæŒ‰å¤šå°‘æ¬¡"3æ¥¼"ï¼Œç”µæ¢¯åªä¼šå»ä¸€æ¬¡3æ¥¼
- æ— è®ºæäº¤å¤šå°‘æ¬¡åŒä¸€ä¸ªè½¬è´¦è¯·æ±‚ï¼Œåªä¼šè½¬è´¦ä¸€æ¬¡
- é˜²æ­¢ç½‘ç»œé‡è¯•ã€ç”¨æˆ·é‡å¤ç‚¹å‡»é€ æˆé‡å¤æ‰£æ¬¾
```

### 6.2 å¹‚ç­‰æ€§å®ç°æ–¹æ¡ˆ


**ğŸ”¸ åŸºäºå”¯ä¸€ä¸šåŠ¡å·**
```java
@Service
@Transactional
public class TradeService {
    
    /**
     * åˆ›å»ºäº¤æ˜“(å¹‚ç­‰å¤„ç†)
     */
    public TradeResult createTrade(TradeRequest request) {
        String businessNo = request.getBusinessNo();
        
        // å…ˆæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨
        TradeRecord existTrade = tradeMapper.selectByBusinessNo(businessNo);
        if (existTrade != null) {
            log.info("äº¤æ˜“å·²å­˜åœ¨ï¼Œè¿”å›åŸç»“æœ: {}", businessNo);
            return TradeResult.fromRecord(existTrade);
        }
        
        // ä½¿ç”¨æ•°æ®åº“å”¯ä¸€çº¦æŸé˜²æ­¢å¹¶å‘é‡å¤åˆ›å»º
        try {
            TradeRecord trade = buildTradeRecord(request);
            trade.setTradeNo(tradeNoGenerator.generateTradeNo());
            
            tradeMapper.insert(trade);
            return processTradeAsync(trade);
            
        } catch (DuplicateKeyException e) {
            // å¹¶å‘æƒ…å†µä¸‹é‡å¤æ’å…¥ï¼ŒæŸ¥è¯¢å·²å­˜åœ¨çš„è®°å½•è¿”å›
            existTrade = tradeMapper.selectByBusinessNo(businessNo);
            return TradeResult.fromRecord(existTrade);
        }
    }
}
```

### 6.3 åˆ†å¸ƒå¼å¹‚ç­‰æ€§æ§åˆ¶


**âš¡ Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆ**
```java
@Component
public class TradeIdempotentHandler {
    
    private final RedisTemplate<String, String> redisTemplate;
    private static final String LOCK_PREFIX = "trade:lock:";
    private static final int LOCK_EXPIRE_SECONDS = 10;
    
    /**
     * è·å–å¹‚ç­‰é”
     */
    public boolean tryLock(String businessNo) {
        String lockKey = LOCK_PREFIX + businessNo;
        String lockValue = UUID.randomUUID().toString();
        
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(LOCK_EXPIRE_SECONDS));
            
        return Boolean.TRUE.equals(success);
    }
    
    /**
     * é‡Šæ”¾å¹‚ç­‰é”
     */
    public void releaseLock(String businessNo, String lockValue) {
        String lockKey = LOCK_PREFIX + businessNo;
        
        // Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script = """
            if redis.call('GET', KEYS[1]) == ARGV[1] then
                return redis.call('DEL', KEYS[1])
            else
                return 0
            end
            """;
            
        redisTemplate.execute(new DefaultRedisScript<>(script, Long.class), 
                            List.of(lockKey), lockValue);
    }
}
```

---

## 7. â° äº¤æ˜“æ—¶åºä¸æ‰¹å¤„ç†


### 7.1 äº¤æ˜“æ—¶åºæ§åˆ¶


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦æ—¶åºæ§åˆ¶ï¼Ÿ**
```
å°±åƒæ’é˜Ÿä¹°ç¥¨ï¼š
- åŒä¸€ä¸ªè´¦æˆ·çš„äº¤æ˜“è¦æŒ‰é¡ºåºå¤„ç†
- é¿å…ä½™é¢è®¡ç®—é”™ä¹±
- ä¿è¯è´¦æˆ·çŠ¶æ€çš„ä¸€è‡´æ€§
- é˜²æ­¢è¶…æ”¯ç­‰å¼‚å¸¸æƒ…å†µ
```

### 7.2 äº¤æ˜“é˜Ÿåˆ—è®¾è®¡


**ğŸ“‹ é˜Ÿåˆ—æ¨¡å‹**
```
è´¦æˆ·Açš„äº¤æ˜“é˜Ÿåˆ—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è½¬è´¦100 â”‚â”€â”€â”€â†’â”‚ å……å€¼50  â”‚â”€â”€â”€â†’â”‚ æ”¯ä»˜80  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–¼              â–¼              â–¼
  [å¤„ç†ä¸­]       [ç­‰å¾…]        [ç­‰å¾…]

æ¯ä¸ªè´¦æˆ·ç»´æŠ¤ç‹¬ç«‹é˜Ÿåˆ—ï¼Œä¿è¯æ—¶åº
```

**âš™ï¸ é˜Ÿåˆ—å¤„ç†å™¨**
```java
@Service
public class TradeQueueProcessor {
    
    private final Map<String, BlockingQueue<TradeTask>> accountQueues = new ConcurrentHashMap<>();
    private final ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 50, 60L, TimeUnit.SECONDS, 
                                                                      new LinkedBlockingQueue<>());
    
    /**
     * æäº¤äº¤æ˜“åˆ°é˜Ÿåˆ—
     */
    public void submitTrade(TradeRequest request) {
        String accountId = request.getFromAccount();
        
        // ä¸ºæ¯ä¸ªè´¦æˆ·åˆ›å»ºç‹¬ç«‹é˜Ÿåˆ—
        BlockingQueue<TradeTask> queue = accountQueues.computeIfAbsent(accountId, 
                                                k -> new LinkedBlockingQueue<>());
        
        TradeTask task = new TradeTask(request);
        queue.offer(task);
        
        // ç¡®ä¿æœ‰çº¿ç¨‹å¤„ç†è¿™ä¸ªè´¦æˆ·çš„é˜Ÿåˆ—
        ensureAccountProcessor(accountId);
    }
    
    /**
     * å¤„ç†è´¦æˆ·äº¤æ˜“é˜Ÿåˆ—
     */
    private void processAccountQueue(String accountId) {
        BlockingQueue<TradeTask> queue = accountQueues.get(accountId);
        
        while (!queue.isEmpty()) {
            try {
                TradeTask task = queue.take();
                processTradeTask(task);
                
                // çŸ­æš‚å»¶æ—¶ï¼Œé¿å…è¿‡å¿«å¤„ç†
                Thread.sleep(10);
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
}
```

### 7.3 äº¤æ˜“æ‰¹é‡å¤„ç†


**ğŸš€ æ‰¹å¤„ç†ä¼˜åŒ–**
```java
@Service
public class TradeBatchProcessor {
    
    private static final int BATCH_SIZE = 100;
    
    /**
     * æ‰¹é‡å¤„ç†äº¤æ˜“
     */
    @Scheduled(fixedDelay = 1000) // æ¯ç§’æ‰§è¡Œä¸€æ¬¡
    public void processBatch() {
        List<TradeRecord> pendingTrades = tradeMapper.selectPendingTrades(BATCH_SIZE);
        
        if (pendingTrades.isEmpty()) {
            return;
        }
        
        log.info("å¼€å§‹æ‰¹å¤„ç† {} ç¬”äº¤æ˜“", pendingTrades.size());
        
        // æŒ‰è´¦æˆ·åˆ†ç»„ï¼Œä¿è¯åŒè´¦æˆ·äº¤æ˜“çš„é¡ºåº
        Map<String, List<TradeRecord>> groupedTrades = pendingTrades.stream()
            .collect(Collectors.groupingBy(TradeRecord::getFromAccount));
        
        // å¹¶è¡Œå¤„ç†ä¸åŒè´¦æˆ·çš„äº¤æ˜“
        groupedTrades.values().parallelStream().forEach(this::processAccountTrades);
    }
    
    private void processAccountTrades(List<TradeRecord> trades) {
        for (TradeRecord trade : trades) {
            try {
                processTradeRecord(trade);
            } catch (Exception e) {
                log.error("äº¤æ˜“å¤„ç†å¤±è´¥: {}", trade.getTradeNo(), e);
                markTradeFailed(trade, e.getMessage());
            }
        }
    }
}
```

---

## 8. ğŸš¨ äº¤æ˜“å¼‚å¸¸å¤„ç†æœºåˆ¶


### 8.1 äº¤æ˜“è¶…æ—¶å¤„ç†


**â±ï¸ è¶…æ—¶æ£€æµ‹æœºåˆ¶**
```java
@Component
public class TradeTimeoutHandler {
    
    private static final int TIMEOUT_MINUTES = 30;
    
    /**
     * å®šæ—¶æ£€æŸ¥è¶…æ—¶äº¤æ˜“
     */
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkTimeoutTrades() {
        LocalDateTime timeoutThreshold = LocalDateTime.now().minusMinutes(TIMEOUT_MINUTES);
        
        List<TradeRecord> timeoutTrades = tradeMapper.selectTimeoutTrades(timeoutThreshold);
        
        for (TradeRecord trade : timeoutTrades) {
            handleTimeoutTrade(trade);
        }
    }
    
    private void handleTimeoutTrade(TradeRecord trade) {
        log.warn("äº¤æ˜“è¶…æ—¶ï¼Œå¼€å§‹å¤„ç†: {}", trade.getTradeNo());
        
        try {
            // æŸ¥è¯¢ç¬¬ä¸‰æ–¹æ”¯ä»˜çŠ¶æ€
            String realStatus = queryThirdPartyStatus(trade.getTradeNo());
            
            if ("SUCCESS".equals(realStatus)) {
                // ç¬¬ä¸‰æ–¹å·²æˆåŠŸï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
                updateTradeStatus(trade.getTradeNo(), TradeStatus.SUCCESS, "è¶…æ—¶åæŸ¥è¯¢ç¡®è®¤æˆåŠŸ");
            } else if ("FAILED".equals(realStatus)) {
                // ç¬¬ä¸‰æ–¹å·²å¤±è´¥ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€
                updateTradeStatus(trade.getTradeNo(), TradeStatus.FAILED, "è¶…æ—¶åæŸ¥è¯¢ç¡®è®¤å¤±è´¥");
            } else {
                // çŠ¶æ€ä¸æ˜ï¼Œæ ‡è®°è¶…æ—¶
                updateTradeStatus(trade.getTradeNo(), TradeStatus.TIMEOUT, "å¤„ç†è¶…æ—¶");
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†è¶…æ—¶äº¤æ˜“å¼‚å¸¸: {}", trade.getTradeNo(), e);
            updateTradeStatus(trade.getTradeNo(), TradeStatus.TIMEOUT, "è¶…æ—¶å¤„ç†å¼‚å¸¸: " + e.getMessage());
        }
    }
}
```

### 8.2 äº¤æ˜“æ’¤é”€å†²æ­£


**ğŸ”„ æ’¤é”€å†²æ­£æœºåˆ¶**
```java
@Service
public class TradeReversalService {
    
    /**
     * äº¤æ˜“æ’¤é”€
     */
    @Transactional
    public boolean reverseTrade(String tradeNo, String reason) {
        TradeRecord originalTrade = tradeMapper.selectByTradeNo(tradeNo);
        
        if (originalTrade == null) {
            throw new BusinessException("åŸäº¤æ˜“ä¸å­˜åœ¨");
        }
        
        if (originalTrade.getStatus() != TradeStatus.SUCCESS.getCode()) {
            throw new BusinessException("åªèƒ½æ’¤é”€æˆåŠŸçš„äº¤æ˜“");
        }
        
        // åˆ›å»ºå†²æ­£äº¤æ˜“è®°å½•
        TradeRecord reversalTrade = createReversalTrade(originalTrade, reason);
        tradeMapper.insert(reversalTrade);
        
        try {
            // æ‰§è¡Œèµ„é‡‘å†²æ­£
            executeReversal(originalTrade, reversalTrade);
            
            // æ›´æ–°åŸäº¤æ˜“çŠ¶æ€ä¸ºå·²æ’¤é”€
            updateTradeStatus(tradeNo, TradeStatus.CANCELLED, "äº¤æ˜“å·²æ’¤é”€: " + reason);
            
            // æ›´æ–°å†²æ­£äº¤æ˜“çŠ¶æ€ä¸ºæˆåŠŸ
            updateTradeStatus(reversalTrade.getTradeNo(), TradeStatus.SUCCESS, "å†²æ­£æˆåŠŸ");
            
            return true;
            
        } catch (Exception e) {
            log.error("äº¤æ˜“å†²æ­£å¤±è´¥: {}", tradeNo, e);
            updateTradeStatus(reversalTrade.getTradeNo(), TradeStatus.FAILED, "å†²æ­£å¤±è´¥: " + e.getMessage());
            throw e;
        }
    }
    
    private TradeRecord createReversalTrade(TradeRecord original, String reason) {
        TradeRecord reversal = new TradeRecord();
        reversal.setTradeNo(tradeNoGenerator.generateTradeNo());
        reversal.setBusinessNo(original.getBusinessNo() + "_REV");
        reversal.setTradeType(getReversalType(original.getTradeType()));
        reversal.setAmount(original.getAmount());
        
        // äº¤æ¢å‡ºå…¥è´¦è´¦æˆ·
        reversal.setFromAccount(original.getToAccount());
        reversal.setToAccount(original.getFromAccount());
        
        reversal.setStatus(TradeStatus.PROCESSING.getCode());
        reversal.setRemark("å†²æ­£äº¤æ˜“:" + reason);
        
        return reversal;
    }
}
```

### 8.3 äº¤æ˜“å¼‚å¸¸è‡ªåŠ¨æ¢å¤


**ğŸ”§ è‡ªåŠ¨æ¢å¤æœºåˆ¶**
```java
@Service
public class TradeRecoveryService {
    
    /**
     * äº¤æ˜“å¼‚å¸¸æ¢å¤
     */
    @Scheduled(fixedDelay = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void recoverFailedTrades() {
        List<TradeRecord> failedTrades = tradeMapper.selectRecoverableTrades();
        
        for (TradeRecord trade : failedTrades) {
            if (canRecover(trade)) {
                recoverTrade(trade);
            }
        }
    }
    
    private boolean canRecover(TradeRecord trade) {
        // æ£€æŸ¥æ¢å¤æ¡ä»¶
        return trade.getRetryCount() < 3 && // é‡è¯•æ¬¡æ•°ä¸è¶…è¿‡3æ¬¡
               Duration.between(trade.getUpdateTime().toInstant(), Instant.now())
                       .toMinutes() >= 10; // è·ç¦»ä¸Šæ¬¡å¤±è´¥è¶…è¿‡10åˆ†é’Ÿ
    }
    
    private void recoverTrade(TradeRecord trade) {
        try {
            log.info("å°è¯•æ¢å¤äº¤æ˜“: {}", trade.getTradeNo());
            
            // é‡æ–°æ‰§è¡Œäº¤æ˜“
            TradeResult result = reprocessTrade(trade);
            
            if (result.isSuccess()) {
                updateTradeStatus(trade.getTradeNo(), TradeStatus.SUCCESS, "è‡ªåŠ¨æ¢å¤æˆåŠŸ");
            } else {
                incrementRetryCount(trade.getTradeNo());
            }
            
        } catch (Exception e) {
            log.error("äº¤æ˜“æ¢å¤å¤±è´¥: {}", trade.getTradeNo(), e);
            incrementRetryCount(trade.getTradeNo());
        }
    }
}
```

---

## 9. ğŸ“Š äº¤æ˜“å¯¹è´¦ä¸ç›‘æ§


### 9.1 äº¤æ˜“å¯¹è´¦æœºåˆ¶


**ğŸ’¡ å¯¹è´¦çš„é‡è¦æ€§**
```
å¯¹è´¦å°±åƒæ£€æŸ¥è´¦æœ¬ï¼š
- ç¡®ä¿ç³»ç»Ÿè®°å½•çš„é’±å’Œå®é™…çš„é’±ä¸€è‡´
- å‘ç°æ•°æ®å¼‚å¸¸å’Œç³»ç»ŸBug
- æ»¡è¶³è´¢åŠ¡å’Œç›‘ç®¡è¦æ±‚
- åŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
```

### 9.2 æ—¥åˆ‡å¤„ç†æµç¨‹


**ğŸŒ… æ—¥ç»ˆæ‰¹å¤„ç†**
```java
@Service
public class DailySettlementService {
    
    /**
     * æ—¥ç»ˆå¯¹è´¦å¤„ç†
     */
    @Scheduled(cron = "0 1 0 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void dailySettlement() {
        LocalDate settleDate = LocalDate.now().minusDays(1);
        
        log.info("å¼€å§‹æ—¥ç»ˆå¯¹è´¦ï¼Œæ—¥æœŸ: {}", settleDate);
        
        try {
            // 1. ç”Ÿæˆäº¤æ˜“æ±‡æ€»
            generateTradeSummary(settleDate);
            
            // 2. ç”Ÿæˆè´¦æˆ·ä½™é¢å¿«ç…§
            generateAccountSnapshot(settleDate);
            
            // 3. æ‰§è¡Œå¯¹è´¦æ£€æŸ¥
            performReconciliation(settleDate);
            
            // 4. ç”Ÿæˆå¯¹è´¦æŠ¥å‘Š
            generateReconciliationReport(settleDate);
            
            // 5. æ•°æ®å½’æ¡£
            archiveTradeData(settleDate);
            
        } catch (Exception e) {
            log.error("æ—¥ç»ˆå¯¹è´¦å¤±è´¥: {}", settleDate, e);
            sendAlertNotification("æ—¥ç»ˆå¯¹è´¦å¤±è´¥", e.getMessage());
        }
    }
    
    private void generateTradeSummary(LocalDate date) {
        TradeSummary summary = new TradeSummary();
        summary.setSettleDate(date);
        summary.setTradeCount(tradeMapper.countByDate(date));
        summary.setTotalAmount(tradeMapper.sumAmountByDate(date));
        summary.setSuccessCount(tradeMapper.countSuccessTradesByDate(date));
        summary.setFailedCount(tradeMapper.countFailedTradesByDate(date));
        
        tradeSummaryMapper.insert(summary);
    }
}
```

### 9.3 äº¤æ˜“é“¾è·¯è¿½è¸ª


**ğŸ” é“¾è·¯è¿½è¸ªå®ç°**
```java
@Component
public class TradeTraceService {
    
    /**
     * è®°å½•äº¤æ˜“é“¾è·¯æ—¥å¿—
     */
    public void recordTraceLog(String tradeNo, String step, String detail) {
        TradeTrace trace = new TradeTrace();
        trace.setTradeNo(tradeNo);
        trace.setStep(step);
        trace.setDetail(detail);
        trace.setTimestamp(System.currentTimeMillis());
        trace.setThreadName(Thread.currentThread().getName());
        
        tradeTraceMapper.insert(trace);
    }
    
    /**
     * æŸ¥è¯¢äº¤æ˜“å®Œæ•´é“¾è·¯
     */
    public List<TradeTrace> getTradeTrace(String tradeNo) {
        return tradeTraceMapper.selectByTradeNo(tradeNo);
    }
    
    /**
     * ç”Ÿæˆäº¤æ˜“é“¾è·¯å›¾
     */
    public String generateTraceTimeline(String tradeNo) {
        List<TradeTrace> traces = getTradeTrace(tradeNo);
        
        StringBuilder timeline = new StringBuilder();
        timeline.append("äº¤æ˜“é“¾è·¯è¿½è¸ª: ").append(tradeNo).append("\n");
        timeline.append("=" .repeat(50)).append("\n");
        
        for (TradeTrace trace : traces) {
            timeline.append(String.format("%s [%s] %s: %s\n", 
                formatTimestamp(trace.getTimestamp()),
                trace.getThreadName(),
                trace.getStep(),
                trace.getDetail()));
        }
        
        return timeline.toString();
    }
}
```

---

## 10. âš¡ é«˜å¹¶å‘äº¤æ˜“ä¼˜åŒ–


### 10.1 æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥


**ğŸ“Š åˆ†åº“åˆ†è¡¨æ–¹æ¡ˆ**
```
äº¤æ˜“è¡¨åˆ†ç‰‡ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   trade_2024_01 â”‚    â”‚   trade_2024_02 â”‚    â”‚   trade_2024_03 â”‚
â”‚   (1æœˆäº¤æ˜“æ•°æ®)  â”‚    â”‚   (2æœˆäº¤æ˜“æ•°æ®)  â”‚    â”‚   (3æœˆäº¤æ˜“æ•°æ®)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŒ‰æœˆåˆ†è¡¨ + æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†åº“
å‡å°‘å•è¡¨å‹åŠ›ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡
```

**ğŸš€ è¯»å†™åˆ†ç¦»é…ç½®**
```java
@Configuration
public class DataSourceConfig {
    
    @Primary
    @Bean
    public DataSource writeDataSource() {
        // ä¸»åº“é…ç½®ï¼Œå¤„ç†å†™æ“ä½œ
        return DataSourceBuilder.create()
                .driverClassName("com.mysql.cj.jdbc.Driver")
                .url("jdbc:mysql://master-db:3306/trade_db")
                .username("writer")
                .password("password")
                .build();
    }
    
    @Bean
    public DataSource readDataSource() {
        // ä»åº“é…ç½®ï¼Œå¤„ç†è¯»æ“ä½œ
        return DataSourceBuilder.create()
                .driverClassName("com.mysql.cj.jdbc.Driver")
                .url("jdbc:mysql://slave-db:3306/trade_db")
                .username("reader")
                .password("password")
                .build();
    }
}
```

### 10.2 ç¼“å­˜ä¼˜åŒ–ç­–ç•¥


**ğŸ’¾ å¤šçº§ç¼“å­˜è®¾è®¡**
```java
@Service
public class TradeCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private final Cache<String, TradeRecord> localCache = 
        Caffeine.newBuilder()
                .maximumSize(10000)
                .expireAfterWrite(5, TimeUnit.MINUTES)
                .build();
    
    /**
     * å¤šçº§ç¼“å­˜æŸ¥è¯¢äº¤æ˜“
     */
    public TradeRecord getTrade(String tradeNo) {
        // L1: æœ¬åœ°ç¼“å­˜
        TradeRecord trade = localCache.getIfPresent(tradeNo);
        if (trade != null) {
            return trade;
        }
        
        // L2: Redisç¼“å­˜
        String cacheKey = "trade:" + tradeNo;
        trade = (TradeRecord) redisTemplate.opsForValue().get(cacheKey);
        if (trade != null) {
            localCache.put(tradeNo, trade);
            return trade;
        }
        
        // L3: æ•°æ®åº“æŸ¥è¯¢
        trade = tradeMapper.selectByTradeNo(tradeNo);
        if (trade != null) {
            // å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, trade, Duration.ofMinutes(30));
            localCache.put(tradeNo, trade);
        }
        
        return trade;
    }
}
```

### 10.3 å¼‚æ­¥å¤„ç†ä¼˜åŒ–


**ğŸ”„ å¼‚æ­¥å¤„ç†æ¶æ„**
```java
@Service
public class AsyncTradeProcessor {
    
    @Async("tradeExecutor")
    public CompletableFuture<TradeResult> processTradeAsync(TradeRequest request) {
        try {
            // å¿«é€Ÿå“åº”ç”¨æˆ·
            TradeRecord trade = createTradeRecord(request);
            
            // å¼‚æ­¥æ‰§è¡Œå®é™…äº¤æ˜“é€»è¾‘
            CompletableFuture.runAsync(() -> {
                try {
                    executeTradeLogic(trade);
                    updateTradeStatus(trade.getTradeNo(), TradeStatus.SUCCESS, "å¤„ç†æˆåŠŸ");
                } catch (Exception e) {
                    updateTradeStatus(trade.getTradeNo(), TradeStatus.FAILED, e.getMessage());
                    log.error("å¼‚æ­¥äº¤æ˜“å¤„ç†å¤±è´¥: {}", trade.getTradeNo(), e);
                }
            });
            
            return CompletableFuture.completedFuture(TradeResult.processing(trade.getTradeNo()));
            
        } catch (Exception e) {
            return CompletableFuture.completedFuture(TradeResult.failed(e.getMessage()));
        }
    }
}

@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean("tradeExecutor")
    public ThreadPoolTaskExecutor tradeExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(20);
        executor.setMaxPoolSize(100);
        executor.setQueueCapacity(500);
        executor.setThreadNamePrefix("Trade-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº¤æ˜“æµæ°´è®°å½•ï¼šæ¯ç¬”äº¤æ˜“çš„å®Œæ•´è®°å½•ï¼ŒåŒ…å«çŠ¶æ€ã€é‡‘é¢ã€è´¦æˆ·ç­‰ä¿¡æ¯
ğŸ”¸ äº¤æ˜“çŠ¶æ€æœºï¼šç®¡ç†äº¤æ˜“ä»åˆ›å»ºåˆ°å®Œæˆçš„çŠ¶æ€æµè½¬
ğŸ”¸ äº¤æ˜“è·¯ç”±è§„åˆ™ï¼šæ ¹æ®äº¤æ˜“ç±»å‹å’Œé‡‘é¢é€‰æ‹©åˆé€‚çš„å¤„ç†é€šé“
ğŸ”¸ äº¤æ˜“é™é¢æ§åˆ¶ï¼šé˜²æ­¢è¶…é¢äº¤æ˜“çš„é£é™©æ§åˆ¶æœºåˆ¶
ğŸ”¸ æ‰‹ç»­è´¹è®¡ç®—ï¼šçµæ´»çš„è´¹ç”¨è®¡ç®—è§„åˆ™å’Œé…ç½®
ğŸ”¸ äº¤æ˜“å¹‚ç­‰æ€§ï¼šé˜²æ­¢é‡å¤äº¤æ˜“çš„ä¿æŠ¤æœºåˆ¶
ğŸ”¸ äº¤æ˜“æ—¶åºæ§åˆ¶ï¼šä¿è¯åŒè´¦æˆ·äº¤æ˜“çš„å¤„ç†é¡ºåº
ğŸ”¸ å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼šè¶…æ—¶ã€æ’¤é”€ã€è‡ªåŠ¨æ¢å¤ç­‰å¼‚å¸¸åœºæ™¯å¤„ç†
ğŸ”¸ å¯¹è´¦ç›‘æ§ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§çš„å¯¹è´¦å’Œç›‘æ§æœºåˆ¶
ğŸ”¸ é«˜å¹¶å‘ä¼˜åŒ–ï¼šæ•°æ®åº“åˆ†ç‰‡ã€ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ç­‰æ€§èƒ½ä¼˜åŒ–
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº¤æ˜“ç³»ç»Ÿè®¾è®¡åŸåˆ™**
```
ACIDåŸåˆ™ï¼š
- åŸå­æ€§ï¼šäº¤æ˜“è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- ä¸€è‡´æ€§ï¼šè´¦æˆ·ä½™é¢å’Œäº¤æ˜“è®°å½•å¿…é¡»ä¸€è‡´
- éš”ç¦»æ€§ï¼šå¹¶å‘äº¤æ˜“ä¸èƒ½ç›¸äº’å½±å“
- æŒä¹…æ€§ï¼šäº¤æ˜“ç»“æœå¿…é¡»æŒä¹…ä¿å­˜

å¯é æ€§ä¿è¯ï¼š
- çŠ¶æ€æœºç¡®ä¿äº¤æ˜“çŠ¶æ€çš„æ­£ç¡®æµè½¬
- å¹‚ç­‰æ€§é˜²æ­¢é‡å¤æ‰£æ¬¾
- å¼‚å¸¸æ¢å¤ä¿è¯ç³»ç»Ÿçš„è‡ªæ„ˆèƒ½åŠ›
- å¯¹è´¦æœºåˆ¶ç¡®ä¿æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
æ•°æ®å±‚ä¼˜åŒ–ï¼š
- åˆ†åº“åˆ†è¡¨é™ä½å•åº“å‹åŠ›
- è¯»å†™åˆ†ç¦»æå‡å¹¶å‘èƒ½åŠ›
- åˆç†ç´¢å¼•è®¾è®¡æå‡æŸ¥è¯¢æ•ˆç‡

åº”ç”¨å±‚ä¼˜åŒ–ï¼š
- å¼‚æ­¥å¤„ç†æå‡å“åº”é€Ÿåº¦
- å¤šçº§ç¼“å­˜å‡å°‘æ•°æ®åº“è®¿é—®
- æ‰¹é‡å¤„ç†æå‡ååé‡
- é˜Ÿåˆ—æ§åˆ¶ä¿è¯å¤„ç†é¡ºåº
```

**ğŸ”¹ é£é™©æ§åˆ¶è¦ç‚¹**
```
èµ„é‡‘å®‰å…¨ï¼š
- é™é¢æ§åˆ¶é˜²æ­¢å¤§é¢é£é™©
- çŠ¶æ€æœºé˜²æ­¢å¼‚å¸¸çŠ¶æ€
- å¯¹è´¦æœºåˆ¶åŠæ—¶å‘ç°é—®é¢˜
- å®¡è®¡æ—¥å¿—è¿½è¸ªå®Œæ•´é“¾è·¯

ç³»ç»Ÿå®‰å…¨ï¼š
- å¹‚ç­‰æ€§é˜²æ­¢é‡å¤å¤„ç†
- è¶…æ—¶æœºåˆ¶é˜²æ­¢é•¿æœŸæŒ‚èµ·
- å¼‚å¸¸æ¢å¤ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§
- ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼š
> - äº¤æ˜“ç³»ç»Ÿæ˜¯é‡‘èç³»ç»Ÿçš„æ ¸å¿ƒï¼Œéœ€è¦ä¿è¯èµ„é‡‘å®‰å…¨å’Œç³»ç»Ÿç¨³å®š
> - çŠ¶æ€æœºå’Œå¹‚ç­‰æ€§æ˜¯é˜²æ­¢æ•°æ®å¼‚å¸¸çš„å…³é”®æœºåˆ¶  
> - é«˜å¹¶å‘ä¼˜åŒ–éœ€è¦ä»æ•°æ®åº“åˆ°åº”ç”¨å±‚çš„å…¨é¢è®¾è®¡
> - å¼‚å¸¸å¤„ç†å’Œç›‘æ§æ˜¯ä¿è¯ç³»ç»Ÿå¯é è¿è¡Œçš„é‡è¦ä¿éšœ

**æ ¸å¿ƒå®è·µå»ºè®®**ï¼š
- **å…ˆä¿è¯æ­£ç¡®æ€§ï¼Œå†ä¼˜åŒ–æ€§èƒ½**ï¼šèµ„é‡‘å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½
- **å®Œå–„çš„æ—¥å¿—è®°å½•**ï¼šä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡è¦æ±‚
- **åˆ†æ­¥éª¤å®æ–½**ï¼šä»å•æœºç‰ˆåˆ°åˆ†å¸ƒå¼ï¼Œé€æ­¥æ¼”è¿›
- **å……åˆ†æµ‹è¯•**ï¼šç‰¹åˆ«æ˜¯å¼‚å¸¸åœºæ™¯å’Œå¹¶å‘åœºæ™¯çš„æµ‹è¯•