---
title: 7ã€æ”¯ä»˜ç½‘å…³è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [æ”¯ä»˜ç½‘å…³åŸºç¡€æ¦‚å¿µ](#1-æ”¯ä»˜ç½‘å…³åŸºç¡€æ¦‚å¿µ)
2. [æ”¯ä»˜æ¸ é“ç®¡ç†](#2-æ”¯ä»˜æ¸ é“ç®¡ç†)
3. [æ”¯ä»˜è·¯ç”±ç­–ç•¥è®¾è®¡](#3-æ”¯ä»˜è·¯ç”±ç­–ç•¥è®¾è®¡)
4. [æ”¯ä»˜åè®®é€‚é…å±‚](#4-æ”¯ä»˜åè®®é€‚é…å±‚)
5. [æ”¯ä»˜ç»“æœé€šçŸ¥æœºåˆ¶](#5-æ”¯ä»˜ç»“æœé€šçŸ¥æœºåˆ¶)
6. [æ”¯ä»˜é‡è¯•ä¸å®¹é”™æœºåˆ¶](#6-æ”¯ä»˜é‡è¯•ä¸å®¹é”™æœºåˆ¶)
7. [æ”¯ä»˜å®‰å…¨è®¤è¯ä½“ç³»](#7-æ”¯ä»˜å®‰å…¨è®¤è¯ä½“ç³»)
8. [æ”¯ä»˜æ€§èƒ½ç›‘æ§](#8-æ”¯ä»˜æ€§èƒ½ç›‘æ§)
9. [æ”¯ä»˜æ™ºèƒ½ä¼˜åŒ–ç­–ç•¥](#9-æ”¯ä»˜æ™ºèƒ½ä¼˜åŒ–ç­–ç•¥)
10. [æ”¯ä»˜åˆè§„ä¸é£æ§](#10-æ”¯ä»˜åˆè§„ä¸é£æ§)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¦ æ”¯ä»˜ç½‘å…³åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ”¯ä»˜ç½‘å…³


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
æ”¯ä»˜ç½‘å…³å°±åƒä¸€ä¸ª"ä¸‡èƒ½æ’å¤´è½¬æ¢å™¨"ï¼Œå®ƒè¿æ¥ç€ä½ çš„ä¸šåŠ¡ç³»ç»Ÿå’Œå„ç§æ”¯ä»˜æ¸ é“ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è¡Œç­‰ï¼‰ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿé€‰æ‹©ä¸åŒçš„æ”¯ä»˜æ–¹å¼å®Œæˆäº¤æ˜“ã€‚

```
ç®€å•ç±»æ¯”ï¼š
æ”¯ä»˜ç½‘å…³ = å•†åœºæ”¶é“¶å°çš„å¤šç§æ”¯ä»˜æ–¹å¼
- ç°é‡‘æ”¯ä»˜ â†’ é“¶è¡Œå¡æ”¯ä»˜
- æ‰«ç æ”¯ä»˜ â†’ å¾®ä¿¡/æ”¯ä»˜å®
- æ‰‹æœºæ”¯ä»˜ â†’ Apple Pay/åä¸ºé’±åŒ…
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**
```
ç»Ÿä¸€æ¥å…¥ï¼šä¸€å¥—æ¥å£å¯¹æ¥å¤šå®¶æ”¯ä»˜æ¸ é“
è·¯ç”±é€‰æ‹©ï¼šæ™ºèƒ½é€‰æ‹©æœ€ä¼˜æ”¯ä»˜é€šé“
åè®®è½¬æ¢ï¼šç»Ÿä¸€ä¸šåŠ¡æ¥å£ï¼Œå±è”½æ¸ é“å·®å¼‚
å®‰å…¨ä¿éšœï¼šåŠ å¯†ä¼ è¾“ï¼Œé£é™©æ§åˆ¶
ç›‘æ§ç®¡ç†ï¼šå®æ—¶ç›‘æ§ï¼Œå¼‚å¸¸å‘Šè­¦
```

### 1.2 æ”¯ä»˜ç½‘å…³æ¶æ„å…¨è²Œ


**ğŸ—ï¸ æ•´ä½“æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ä¸šåŠ¡ç³»ç»Ÿ      â”‚ â† ç”µå•†ã€O2Oã€é‡‘èAPPç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ”¯ä»˜ç½‘å…³      â”‚ â† æ ¸å¿ƒè·¯ç”±å’Œé€‚é…å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ”¯ä»˜æ¸ é“å±‚     â”‚ â† å¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è”ç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     é“¶è¡Œ        â”‚ â† æœ€ç»ˆèµ„é‡‘æ¸…ç®—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”„ æ”¯ä»˜æµç¨‹æ¦‚è§ˆ**
```
ç”¨æˆ·å‘èµ·æ”¯ä»˜ â†’ ç½‘å…³æ¥æ”¶è¯·æ±‚ â†’ è·¯ç”±é€‰æ‹© â†’ æ¸ é“è°ƒç”¨ 
     â†“              â†“             â†“         â†“
å¼‚æ­¥é€šçŸ¥å¤„ç† â† ç»“æœå›è°ƒ â† æ”¯ä»˜å¤„ç† â† æ¸ é“å“åº”
```

---

## 2. ğŸ”Œ æ”¯ä»˜æ¸ é“ç®¡ç†


### 2.1 æ¸ é“æŠ½è±¡è®¾è®¡


æ”¯ä»˜æ¸ é“ç®¡ç†çš„æ ¸å¿ƒæ˜¯æŠŠä¸åŒçš„æ”¯ä»˜æ–¹å¼"æ ‡å‡†åŒ–"ï¼Œå°±åƒç»™æ‰€æœ‰ç”µå™¨è®¾è®¡ç»Ÿä¸€çš„æ’å¤´æ¥å£ã€‚

**ğŸ“‹ æ¸ é“é…ç½®è¡¨è®¾è®¡**
```sql
CREATE TABLE payment_channel (
    channel_id VARCHAR(50) PRIMARY KEY,
    channel_name VARCHAR(100) NOT NULL,
    channel_type ENUM('ALIPAY','WECHAT','UNION','BANK') NOT NULL,
    status ENUM('ACTIVE','INACTIVE','MAINTENANCE') DEFAULT 'ACTIVE',
    priority INT DEFAULT 100,          -- ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
    fee_rate DECIMAL(6,4) DEFAULT 0,   -- æ‰‹ç»­è´¹ç‡
    daily_limit BIGINT DEFAULT 0,      -- æ—¥é™é¢ï¼ˆåˆ†ï¼‰
    config JSON,                       -- æ¸ é“ç‰¹æ®Šé…ç½®
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ğŸ’¡ é…ç½®ç¤ºä¾‹**
```sql
-- æ”¯ä»˜å®æ¸ é“é…ç½®
INSERT INTO payment_channel VALUES (
    'alipay_app', 
    'æ”¯ä»˜å®APPæ”¯ä»˜', 
    'ALIPAY', 
    'ACTIVE', 
    10, 
    0.0060,  -- 0.6%æ‰‹ç»­è´¹
    50000000, -- æ—¥é™é¢500ä¸‡åˆ†
    JSON_OBJECT(
        'app_id', '2021001234567890',
        'private_key_path', '/keys/alipay_private.pem',
        'notify_url', 'https://api.example.com/notify/alipay'
    ),
    NOW()
);
```

### 2.2 æ¸ é“èƒ½åŠ›æŠ½è±¡


**ğŸ”§ æ¸ é“æ¥å£ç»Ÿä¸€åŒ–**
```java
// æ”¯ä»˜æ¸ é“ç»Ÿä¸€æ¥å£
public interface PaymentChannel {
    // å‘èµ·æ”¯ä»˜
    PaymentResponse pay(PaymentRequest request);
    
    // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
    PaymentStatus query(String orderId);
    
    // é€€æ¬¾æ“ä½œ
    RefundResponse refund(RefundRequest request);
    
    // æ¸ é“å¥åº·æ£€æŸ¥
    boolean healthCheck();
}
```

**ğŸ¯ æ¸ é“èƒ½åŠ›é…ç½®**
```json
{
  "channel_capabilities": {
    "alipay": {
      "æ”¯æŒåœºæ™¯": ["APP", "WEB", "H5", "æ‰«ç "],
      "å•ç¬”é™é¢": 50000000,
      "æ”¯æŒé€€æ¬¾": true,
      "å¼‚æ­¥é€šçŸ¥": true,
      "æŸ¥è¯¢æ¥å£": true
    },
    "wechat": {
      "æ”¯æŒåœºæ™¯": ["APP", "å°ç¨‹åº", "H5", "æ‰«ç "],
      "å•ç¬”é™é¢": 50000000,
      "æ”¯æŒé€€æ¬¾": true,
      "å¼‚æ­¥é€šçŸ¥": true,
      "æŸ¥è¯¢æ¥å£": true
    }
  }
}
```

### 2.3 æ¸ é“çŠ¶æ€ç®¡ç†


**ğŸ“Š æ¸ é“å¥åº·ç›‘æ§**
```java
@Component
public class ChannelHealthMonitor {
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorChannelHealth() {
        List<PaymentChannel> channels = channelService.getActiveChannels();
        
        for (PaymentChannel channel : channels) {
            try {
                boolean isHealthy = channel.healthCheck();
                updateChannelStatus(channel.getId(), isHealthy);
            } catch (Exception e) {
                // æ ‡è®°æ¸ é“å¼‚å¸¸
                markChannelAbnormal(channel.getId(), e.getMessage());
            }
        }
    }
}
```

---

## 3. ğŸ§­ æ”¯ä»˜è·¯ç”±ç­–ç•¥è®¾è®¡


### 3.1 è·¯ç”±å†³ç­–æ ¸å¿ƒé€»è¾‘


æ”¯ä»˜è·¯ç”±å°±åƒå¯¼èˆªç³»ç»Ÿï¼Œéœ€è¦æ ¹æ®å®æ—¶è·¯å†µï¼ˆæ¸ é“çŠ¶æ€ï¼‰ã€ç”¨æˆ·åå¥½ã€æˆæœ¬ç­‰å› ç´ é€‰æ‹©æœ€ä½³è·¯å¾„ã€‚

**ğŸ¯ è·¯ç”±å†³ç­–å› å­**
```
æˆåŠŸç‡æƒé‡ (40%) + æˆæœ¬æƒé‡ (30%) + é€Ÿåº¦æƒé‡ (20%) + ç”¨æˆ·åå¥½ (10%) = è·¯ç”±åˆ†æ•°
```

**ğŸ“Š è·¯ç”±ç­–ç•¥è¡¨è®¾è®¡**
```sql
CREATE TABLE payment_route_strategy (
    strategy_id VARCHAR(50) PRIMARY KEY,
    merchant_id VARCHAR(50) NOT NULL,
    payment_scene VARCHAR(50), -- APP/WEB/H5
    amount_min BIGINT DEFAULT 0,
    amount_max BIGINT DEFAULT 999999999,
    channel_rules JSON, -- æ¸ é“é€‰æ‹©è§„åˆ™
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 æ™ºèƒ½è·¯ç”±ç®—æ³•


**ğŸ§  è·¯ç”±é€‰æ‹©æ ¸å¿ƒç®—æ³•**
```java
@Service
public class PaymentRoutingService {
    
    public PaymentChannel selectBestChannel(PaymentRoutingRequest request) {
        // 1. è·å–å¯ç”¨æ¸ é“åˆ—è¡¨
        List<PaymentChannel> availableChannels = getAvailableChannels(request);
        
        // 2. è®¡ç®—æ¯ä¸ªæ¸ é“çš„ç»¼åˆè¯„åˆ†
        Map<PaymentChannel, Double> channelScores = new HashMap<>();
        
        for (PaymentChannel channel : availableChannels) {
            double score = calculateChannelScore(channel, request);
            channelScores.put(channel, score);
        }
        
        // 3. é€‰æ‹©è¯„åˆ†æœ€é«˜çš„æ¸ é“
        return channelScores.entrySet().stream()
            .max(Map.Entry.comparingByValue())
            .map(Map.Entry::getKey)
            .orElseThrow(() -> new NoAvailableChannelException());
    }
    
    private double calculateChannelScore(PaymentChannel channel, PaymentRoutingRequest request) {
        // æˆåŠŸç‡è¯„åˆ† (0-1)
        double successRate = getChannelSuccessRate(channel.getId());
        
        // æˆæœ¬è¯„åˆ† (è´¹ç‡è¶Šä½åˆ†æ•°è¶Šé«˜)
        double costScore = 1.0 - (channel.getFeeRate() / 0.01); // å‡è®¾æœ€é«˜è´¹ç‡1%
        
        // é€Ÿåº¦è¯„åˆ†
        double speedScore = getChannelSpeedScore(channel.getId());
        
        // ç”¨æˆ·åå¥½è¯„åˆ†
        double preferenceScore = getUserPreferenceScore(request.getUserId(), channel.getType());
        
        // åŠ æƒè®¡ç®—
        return successRate * 0.4 + costScore * 0.3 + speedScore * 0.2 + preferenceScore * 0.1;
    }
}
```

### 3.3 è·¯ç”±è§„åˆ™é…ç½®


**âš™ï¸ åŠ¨æ€è·¯ç”±è§„åˆ™**
```json
{
  "routing_rules": [
    {
      "rule_name": "å¤§é¢æ”¯ä»˜ä¼˜å…ˆé“¶è”",
      "conditions": {
        "amount_min": 100000, 
        "amount_max": 5000000
      },
      "channel_priority": ["union_pay", "alipay", "wechat"],
      "fallback_enabled": true
    },
    {
      "rule_name": "å°é¢æ”¯ä»˜ä¼˜å…ˆç¬¬ä¸‰æ–¹",
      "conditions": {
        "amount_min": 1,
        "amount_max": 99999
      },
      "channel_priority": ["alipay", "wechat", "union_pay"],
      "cost_optimization": true
    }
  ]
}
```

---

## 4. ğŸ”„ æ”¯ä»˜åè®®é€‚é…å±‚


### 4.1 åè®®é€‚é…å™¨è®¾è®¡


ä¸åŒæ”¯ä»˜æ¸ é“çš„æ¥å£æ ¼å¼éƒ½ä¸ä¸€æ ·ï¼Œé€‚é…å™¨å°±åƒ"ç¿»è¯‘å®˜"ï¼ŒæŠŠç»Ÿä¸€çš„ä¸šåŠ¡è¯·æ±‚ç¿»è¯‘æˆå„ä¸ªæ¸ é“èƒ½ç†è§£çš„æ ¼å¼ã€‚

**ğŸ”§ é€‚é…å™¨å·¥å‚æ¨¡å¼**
```java
@Component
public class PaymentAdapterFactory {
    
    private final Map<String, PaymentAdapter> adapters = new HashMap<>();
    
    @PostConstruct
    public void initAdapters() {
        adapters.put("ALIPAY", new AlipayAdapter());
        adapters.put("WECHAT", new WechatAdapter());
        adapters.put("UNION", new UnionPayAdapter());
    }
    
    public PaymentAdapter getAdapter(String channelType) {
        PaymentAdapter adapter = adapters.get(channelType);
        if (adapter == null) {
            throw new UnsupportedChannelException("ä¸æ”¯æŒçš„æ”¯ä»˜æ¸ é“: " + channelType);
        }
        return adapter;
    }
}
```

### 4.2 æ”¯ä»˜å®é€‚é…å™¨ç¤ºä¾‹


**ğŸ’° æ”¯ä»˜å®æ¥å£é€‚é…**
```java
@Component
public class AlipayAdapter implements PaymentAdapter {
    
    @Override
    public PaymentResponse pay(UnifiedPaymentRequest request) {
        // 1. è½¬æ¢è¯·æ±‚å‚æ•°
        AlipayTradeAppPayRequest alipayRequest = new AlipayTradeAppPayRequest();
        
        // æ„å»ºä¸šåŠ¡å‚æ•°
        AlipayTradeAppPayModel model = new AlipayTradeAppPayModel();
        model.setOutTradeNo(request.getOrderId());
        model.setTotalAmount(formatAmount(request.getAmount())); // åˆ†è½¬å…ƒ
        model.setSubject(request.getTitle());
        model.setBody(request.getDescription());
        
        alipayRequest.setBizModel(model);
        alipayRequest.setNotifyUrl(request.getNotifyUrl());
        
        try {
            // 2. è°ƒç”¨æ”¯ä»˜å®æ¥å£
            AlipayTradeAppPayResponse response = alipayClient.execute(alipayRequest);
            
            // 3. è½¬æ¢å“åº”ç»“æœ
            return convertToUnifiedResponse(response);
            
        } catch (AlipayApiException e) {
            throw new PaymentException("æ”¯ä»˜å®æ”¯ä»˜å¤±è´¥", e);
        }
    }
    
    private String formatAmount(Long amountInCents) {
        // æ”¯ä»˜å®æ¥å£éœ€è¦å…ƒï¼Œå†…éƒ¨å­˜å‚¨æ˜¯åˆ†
        return new BigDecimal(amountInCents).divide(new BigDecimal(100), 2, RoundingMode.HALF_UP).toString();
    }
}
```

### 4.3 è¯·æ±‚å“åº”æ ‡å‡†åŒ–


**ğŸ“‹ ç»Ÿä¸€æ•°æ®æ¨¡å‹**
```java
// ç»Ÿä¸€æ”¯ä»˜è¯·æ±‚
@Data
public class UnifiedPaymentRequest {
    private String orderId;        // å•†æˆ·è®¢å•å·
    private Long amount;           // æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼‰
    private String title;          // æ”¯ä»˜æ ‡é¢˜
    private String description;    // æ”¯ä»˜æè¿°
    private String userId;         // ç”¨æˆ·ID
    private String clientIp;       // å®¢æˆ·ç«¯IP
    private String notifyUrl;      // å›è°ƒåœ°å€
    private String returnUrl;      // è·³è½¬åœ°å€
    private Map<String, String> extraParams; // æ‰©å±•å‚æ•°
}

// ç»Ÿä¸€æ”¯ä»˜å“åº”
@Data
public class UnifiedPaymentResponse {
    private boolean success;       // æ˜¯å¦æˆåŠŸ
    private String code;           // å“åº”ç 
    private String message;        // å“åº”æ¶ˆæ¯
    private String paymentId;      // æ”¯ä»˜æµæ°´å·
    private String channelOrderId; // æ¸ é“è®¢å•å·
    private String payInfo;        // æ”¯ä»˜å‡­æ®
    private Long expireTime;       // è¿‡æœŸæ—¶é—´
}
```

---

## 5. ğŸ“¢ æ”¯ä»˜ç»“æœé€šçŸ¥æœºåˆ¶


### 5.1 é€šçŸ¥æœºåˆ¶è®¾è®¡


æ”¯ä»˜å®Œæˆåï¼Œæ”¯ä»˜æ¸ é“ä¼š"æ‰“ç”µè¯"é€šçŸ¥ç½‘å…³ï¼Œç½‘å…³å†é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿã€‚ä½†"ç”µè¯"å¯èƒ½æ‰“ä¸é€šï¼Œæ‰€ä»¥éœ€è¦é‡è¯•æœºåˆ¶ã€‚

**ğŸ”„ é€šçŸ¥æµç¨‹è®¾è®¡**
```
æ”¯ä»˜æ¸ é“ â”€â”€å¼‚æ­¥é€šçŸ¥â”€â”€> æ”¯ä»˜ç½‘å…³ â”€â”€éªŒç­¾æˆåŠŸâ”€â”€> æ›´æ–°è®¢å•çŠ¶æ€ â”€â”€é€šçŸ¥â”€â”€> ä¸šåŠ¡ç³»ç»Ÿ
    â”‚                     â”‚                              â”‚
    â””â”€â”€â”€ é‡è¯•æœºåˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€ é‡è¯•æœºåˆ¶
```

**ğŸ“Š é€šçŸ¥è®°å½•è¡¨**
```sql
CREATE TABLE payment_notification (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id VARCHAR(64) NOT NULL,
    channel VARCHAR(50) NOT NULL,
    notification_type ENUM('PAY_SUCCESS','PAY_FAIL','REFUND_SUCCESS') NOT NULL,
    raw_content TEXT, -- åŸå§‹é€šçŸ¥å†…å®¹
    verify_status ENUM('SUCCESS','FAILED','PENDING') DEFAULT 'PENDING',
    retry_count INT DEFAULT 0,
    next_retry_time TIMESTAMP,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_channel (order_id, channel)
);
```

### 5.2 é€šçŸ¥éªŒç­¾å¤„ç†


**ğŸ” æ”¯ä»˜å®é€šçŸ¥éªŒç­¾**
```java
@RestController
@RequestMapping("/notify")
public class PaymentNotificationController {
    
    @PostMapping("/alipay")
    public String handleAlipayNotification(@RequestParam Map<String, String> params) {
        try {
            // 1. éªŒç­¾
            boolean verified = AlipaySignature.rsaCheckV1(params, 
                alipayConfig.getPublicKey(), 
                "UTF-8", 
                "RSA2");
                
            if (!verified) {
                log.warn("æ”¯ä»˜å®é€šçŸ¥éªŒç­¾å¤±è´¥: {}", params);
                return "fail";
            }
            
            // 2. è§£æé€šçŸ¥å†…å®¹
            PaymentNotification notification = parseAlipayNotification(params);
            
            // 3. ä¸šåŠ¡å¤„ç†
            notificationService.processNotification(notification);
            
            return "success"; // è¿”å›successå‘Šè¯‰æ”¯ä»˜å®æ”¶åˆ°äº†
            
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜å®é€šçŸ¥å¼‚å¸¸", e);
            return "fail";
        }
    }
}
```

### 5.3 ä¸šåŠ¡é€šçŸ¥é‡è¯•


**ğŸ”„ é€šçŸ¥é‡è¯•ç­–ç•¥**
```java
@Service
public class BusinessNotificationService {
    
    @Async
    public void notifyBusiness(PaymentOrder order) {
        NotificationTask task = new NotificationTask();
        task.setOrderId(order.getOrderId());
        task.setMaxRetries(5); // æœ€å¤šé‡è¯•5æ¬¡
        task.setRetryIntervals(Arrays.asList(30, 60, 300, 600, 1800)); // é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
        
        executeNotification(task, 0);
    }
    
    private void executeNotification(NotificationTask task, int attempt) {
        try {
            // è°ƒç”¨ä¸šåŠ¡ç³»ç»Ÿæ¥å£
            NotificationResponse response = businessClient.notifyPaymentResult(
                buildNotificationRequest(task.getOrderId())
            );
            
            if (response.isSuccess()) {
                markNotificationSuccess(task.getOrderId());
            } else {
                scheduleRetry(task, attempt + 1);
            }
            
        } catch (Exception e) {
            log.warn("é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿå¤±è´¥ï¼Œè®¢å•: {}, å°è¯•: {}", task.getOrderId(), attempt + 1);
            scheduleRetry(task, attempt + 1);
        }
    }
    
    private void scheduleRetry(NotificationTask task, int nextAttempt) {
        if (nextAttempt >= task.getMaxRetries()) {
            markNotificationFailed(task.getOrderId());
            return;
        }
        
        // å»¶è¿Ÿé‡è¯•
        int delaySeconds = task.getRetryIntervals().get(nextAttempt);
        scheduleService.schedule(
            () -> executeNotification(task, nextAttempt),
            delaySeconds,
            TimeUnit.SECONDS
        );
    }
}
```

---

## 6. ğŸ”§ æ”¯ä»˜é‡è¯•ä¸å®¹é”™æœºåˆ¶


### 6.1 é‡è¯•ç­–ç•¥è®¾è®¡


æ”¯ä»˜å¤±è´¥æ—¶ä¸è¦ç«‹å³å‘Šè¯‰ç”¨æˆ·"æ”¯ä»˜å¤±è´¥"ï¼Œå…ˆæ™ºèƒ½é‡è¯•å‡ æ¬¡ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„ä¸´æ—¶å¤±è´¥ã€‚

**â° æŒ‡æ•°é€€é¿é‡è¯•**
```java
@Component
public class PaymentRetryService {
    
    public PaymentResponse payWithRetry(PaymentRequest request) {
        int maxRetries = 3;
        long baseDelayMs = 1000; // 1ç§’åŸºç¡€å»¶è¿Ÿ
        
        for (int attempt = 0; attempt <= maxRetries; attempt++) {
            try {
                PaymentResponse response = paymentService.pay(request);
                
                // æˆåŠŸæˆ–æ˜ç¡®å¤±è´¥ï¼Œä¸é‡è¯•
                if (response.isSuccess() || !isRetryableError(response.getErrorCode())) {
                    return response;
                }
                
                // æœ€åä¸€æ¬¡å°è¯•ï¼Œä¸å†é‡è¯•
                if (attempt == maxRetries) {
                    return response;
                }
                
                // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
                long delayMs = baseDelayMs * (1L << attempt); // 1s, 2s, 4s
                Thread.sleep(delayMs + random.nextInt(1000)); // æ·»åŠ éšæœºæŠ–åŠ¨
                
            } catch (Exception e) {
                if (attempt == maxRetries) {
                    throw new PaymentException("æ”¯ä»˜é‡è¯•å¤±è´¥", e);
                }
            }
        }
        
        throw new PaymentException("æ”¯ä»˜é‡è¯•è€—å°½");
    }
    
    private boolean isRetryableError(String errorCode) {
        // å¯é‡è¯•çš„é”™è¯¯ç 
        Set<String> retryableErrors = Set.of(
            "NETWORK_ERROR",    // ç½‘ç»œé”™è¯¯
            "TIMEOUT",          // è¶…æ—¶
            "SYSTEM_BUSY",      // ç³»ç»Ÿç¹å¿™
            "UNKNOWN_ERROR"     // æœªçŸ¥é”™è¯¯
        );
        return retryableErrors.contains(errorCode);
    }
}
```

### 6.2 ç†”æ–­å™¨ä¿æŠ¤


**âš¡ æ¸ é“ç†”æ–­æœºåˆ¶**
```java
@Component
public class PaymentCircuitBreaker {
    
    private final Map<String, CircuitBreakerStats> channelStats = new ConcurrentHashMap<>();
    
    public boolean isChannelAvailable(String channelId) {
        CircuitBreakerStats stats = channelStats.get(channelId);
        if (stats == null) {
            return true;
        }
        
        // ç†”æ–­çŠ¶æ€åˆ¤æ–­
        if (stats.getState() == CircuitState.OPEN) {
            // ç†”æ–­å¼€å¯ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥å°è¯•æ¢å¤
            if (System.currentTimeMillis() - stats.getLastFailTime() > 60000) { // 1åˆ†é’Ÿåå°è¯•æ¢å¤
                stats.setState(CircuitState.HALF_OPEN);
            } else {
                return false;
            }
        }
        
        return stats.getState() != CircuitState.OPEN;
    }
    
    public void recordSuccess(String channelId) {
        CircuitBreakerStats stats = channelStats.computeIfAbsent(channelId, k -> new CircuitBreakerStats());
        stats.recordSuccess();
        
        // åŠå¼€çŠ¶æ€æˆåŠŸï¼Œæ¢å¤åˆ°å…³é—­çŠ¶æ€
        if (stats.getState() == CircuitState.HALF_OPEN) {
            stats.setState(CircuitState.CLOSED);
        }
    }
    
    public void recordFailure(String channelId) {
        CircuitBreakerStats stats = channelStats.computeIfAbsent(channelId, k -> new CircuitBreakerStats());
        stats.recordFailure();
        
        // å¤±è´¥ç‡è¶…è¿‡50%ï¼Œå¼€å¯ç†”æ–­
        if (stats.getFailureRate() > 0.5 && stats.getTotalCount() >= 10) {
            stats.setState(CircuitState.OPEN);
            stats.setLastFailTime(System.currentTimeMillis());
        }
    }
}
```

### 6.3 é™æµä¿æŠ¤


**ğŸš¦ æ¸ é“é™æµé…ç½®**
```java
@Component
public class PaymentRateLimiter {
    
    // ä½¿ç”¨Guavaçš„RateLimiter
    private final Map<String, RateLimiter> channelLimiters = new ConcurrentHashMap<>();
    
    @PostConstruct
    public void initLimiters() {
        // æ”¯ä»˜å®ï¼šæ¯ç§’100ä¸ªè¯·æ±‚
        channelLimiters.put("alipay", RateLimiter.create(100.0));
        // å¾®ä¿¡æ”¯ä»˜ï¼šæ¯ç§’80ä¸ªè¯·æ±‚  
        channelLimiters.put("wechat", RateLimiter.create(80.0));
        // é“¶è”ï¼šæ¯ç§’50ä¸ªè¯·æ±‚
        channelLimiters.put("union", RateLimiter.create(50.0));
    }
    
    public boolean tryAcquire(String channelType) {
        RateLimiter limiter = channelLimiters.get(channelType);
        if (limiter == null) {
            return true; // æ²¡æœ‰é…ç½®é™æµï¼Œç›´æ¥é€šè¿‡
        }
        
        // å°è¯•è·å–ä»¤ç‰Œï¼Œæœ€å¤šç­‰å¾…100ms
        return limiter.tryAcquire(100, TimeUnit.MILLISECONDS);
    }
}
```

---

## 7. ğŸ” æ”¯ä»˜å®‰å…¨è®¤è¯ä½“ç³»


### 7.1 ç«¯åˆ°ç«¯åŠ å¯†


æ”¯ä»˜æ•°æ®ä¼ è¾“å°±åƒè¿é’è½¦ï¼Œå¿…é¡»å…¨ç¨‹åŠ å¯†ä¿æŠ¤ï¼Œç¡®ä¿æ•°æ®ä¸è¢«æˆªè·æˆ–ç¯¡æ”¹ã€‚

**ğŸ”’ æ•°æ®åŠ å¯†æµç¨‹**
```
æ˜æ–‡æ•°æ® â†’ AESåŠ å¯† â†’ Base64ç¼–ç  â†’ ä¼ è¾“ â†’ Base64è§£ç  â†’ AESè§£å¯† â†’ æ˜æ–‡æ•°æ®
```

**ğŸ” åŠ å¯†å·¥å…·ç±»**
```java
@Component
public class PaymentEncryption {
    
    // æ•æ„Ÿå­—æ®µåŠ å¯†
    public String encryptSensitiveData(String plainText) {
        try {
            Cipher cipher = Cipher.getInstance("AES/GCB/PKCS5Padding");
            cipher.init(Cipher.ENCRYPT_MODE, getSecretKey());
            
            byte[] encrypted = cipher.doFinal(plainText.getBytes(StandardCharsets.UTF_8));
            return Base64.getEncoder().encodeToString(encrypted);
            
        } catch (Exception e) {
            throw new SecurityException("æ•°æ®åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // ç­¾åç”Ÿæˆ
    public String generateSignature(Map<String, String> params, String privateKey) {
        // 1. å‚æ•°æ’åº
        String sortedParams = params.entrySet().stream()
            .filter(entry -> StringUtils.isNotBlank(entry.getValue()))
            .sorted(Map.Entry.comparingByKey())
            .map(entry -> entry.getKey() + "=" + entry.getValue())
            .collect(Collectors.joining("&"));
            
        // 2. RSAç­¾å
        try {
            Signature signature = Signature.getInstance("SHA256withRSA");
            signature.initSign(loadPrivateKey(privateKey));
            signature.update(sortedParams.getBytes(StandardCharsets.UTF_8));
            
            byte[] signed = signature.sign();
            return Base64.getEncoder().encodeToString(signed);
            
        } catch (Exception e) {
            throw new SecurityException("ç­¾åç”Ÿæˆå¤±è´¥", e);
        }
    }
}
```

### 7.2 æ¥å£é˜²é‡æ”¾


**ğŸ›¡ï¸ é˜²é‡æ”¾æœºåˆ¶**
```java
@Component
public class ReplayAttackProtection {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean isValidRequest(String requestId, String timestamp, String nonce) {
        // 1. æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
        long requestTime = Long.parseLong(timestamp);
        if (System.currentTimeMillis() - requestTime > 300000) {
            return false;
        }
        
        // 2. æ£€æŸ¥éšæœºæ•°æ˜¯å¦é‡å¤
        String nonceKey = "payment:nonce:" + nonce;
        Boolean exists = redisTemplate.hasKey(nonceKey);
        
        if (Boolean.TRUE.equals(exists)) {
            return false; // éšæœºæ•°å·²å­˜åœ¨ï¼Œå¯èƒ½æ˜¯é‡æ”¾æ”»å‡»
        }
        
        // 3. è®°å½•éšæœºæ•°ï¼Œ5åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(nonceKey, requestId, Duration.ofMinutes(5));
        
        return true;
    }
}
```

### 7.3 æ•æ„Ÿä¿¡æ¯è„±æ•


**ğŸ­ æ•°æ®è„±æ•å¤„ç†**
```java
@Component
public class DataMasking {
    
    public String maskBankCard(String cardNo) {
        if (StringUtils.isBlank(cardNo) || cardNo.length() < 8) {
            return cardNo;
        }
        
        // é“¶è¡Œå¡å·ï¼šä¿ç•™å‰4ä½å’Œå4ä½
        return cardNo.substring(0, 4) + "****" + cardNo.substring(cardNo.length() - 4);
    }
    
    public String maskPhoneNumber(String phone) {
        if (StringUtils.isBlank(phone) || phone.length() != 11) {
            return phone;
        }
        
        // æ‰‹æœºå·ï¼šä¿ç•™å‰3ä½å’Œå4ä½
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // æ—¥å¿—è¾“å‡ºæ—¶è‡ªåŠ¨è„±æ•
    @EventListener
    public void handlePaymentLog(PaymentLogEvent event) {
        PaymentLog log = event.getPaymentLog();
        
        // è„±æ•å¤„ç†
        if (log.getBankCard() != null) {
            log.setBankCard(maskBankCard(log.getBankCard()));
        }
        if (log.getPhoneNumber() != null) {
            log.setPhoneNumber(maskPhoneNumber(log.getPhoneNumber()));
        }
        
        // è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶
        logService.writePaymentLog(log);
    }
}
```

---

## 8. ğŸ“Š æ”¯ä»˜æ€§èƒ½ç›‘æ§


### 8.1 æ ¸å¿ƒæŒ‡æ ‡ç›‘æ§


æ”¯ä»˜ç³»ç»Ÿçš„ç›‘æ§å°±åƒæ±½è½¦çš„ä»ªè¡¨ç›˜ï¼Œéœ€è¦å®æ—¶æ˜¾ç¤ºå„é¡¹å…³é”®æŒ‡æ ‡ï¼Œä¸€æ—¦å¼‚å¸¸ç«‹å³å‘Šè­¦ã€‚

**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class PaymentMetrics {
    
    private final MeterRegistry meterRegistry;
    
    public PaymentMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    // æ”¯ä»˜æˆåŠŸç‡
    public void recordPaymentResult(String channel, boolean success) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        meterRegistry.counter("payment.result",
            "channel", channel,
            "status", success ? "success" : "failed"
        ).increment();
        
        sample.stop(Timer.builder("payment.duration")
            .tag("channel", channel)
            .register(meterRegistry));
    }
    
    // æ”¯ä»˜é‡‘é¢ç»Ÿè®¡
    public void recordPaymentAmount(String channel, long amount) {
        meterRegistry.gauge("payment.amount", 
            Tags.of("channel", channel), 
            amount);
    }
    
    // æ¸ é“å“åº”æ—¶é—´
    public void recordChannelResponseTime(String channel, long responseTimeMs) {
        meterRegistry.timer("channel.response.time", 
            "channel", channel)
            .record(responseTimeMs, TimeUnit.MILLISECONDS);
    }
}
```

### 8.2 å®æ—¶å‘Šè­¦æœºåˆ¶


**ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®**
```java
@Component
public class PaymentAlertService {
    
    @EventListener
    @Async
    public void handlePaymentFailure(PaymentFailureEvent event) {
        PaymentOrder order = event.getPaymentOrder();
        
        // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
        if (shouldAlert(order)) {
            AlertMessage alert = AlertMessage.builder()
                .level(AlertLevel.HIGH)
                .title("æ”¯ä»˜å¤±è´¥å‘Šè­¦")
                .content(String.format(
                    "è®¢å•å·: %s\n" +
                    "æ”¯ä»˜æ¸ é“: %s\n" +
                    "å¤±è´¥åŸå› : %s\n" +
                    "ç”¨æˆ·ID: %s\n" +
                    "æ”¯ä»˜é‡‘é¢: %.2få…ƒ",
                    order.getOrderId(),
                    order.getChannel(),
                    order.getFailureReason(),
                    order.getUserId(),
                    order.getAmount() / 100.0
                ))
                .timestamp(System.currentTimeMillis())
                .build();
                
            // å‘é€å‘Šè­¦ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
            alertSender.sendAlert(alert);
        }
    }
    
    private boolean shouldAlert(PaymentOrder order) {
        // å¤§é¢è®¢å•å¤±è´¥å¿…é¡»å‘Šè­¦
        if (order.getAmount() > 100000) { // 1000å…ƒä»¥ä¸Š
            return true;
        }
        
        // åŒä¸€ç”¨æˆ·è¿ç»­å¤±è´¥å‘Šè­¦
        int recentFailures = getRecentFailureCount(order.getUserId());
        return recentFailures >= 3;
    }
}
```

### 8.3 æ€§èƒ½å¤§ç›˜å±•ç¤º


**ğŸ“Š ç›‘æ§æ•°æ®æŸ¥è¯¢**
```java
@RestController
@RequestMapping("/admin/monitor")
public class PaymentMonitorController {
    
    @GetMapping("/dashboard")
    public PaymentDashboard getDashboard(@RequestParam String timeRange) {
        LocalDateTime endTime = LocalDateTime.now();
        LocalDateTime startTime = endTime.minus(parseTimeRange(timeRange));
        
        return PaymentDashboard.builder()
            .totalTransactions(getTotalTransactions(startTime, endTime))
            .successRate(getSuccessRate(startTime, endTime))
            .totalAmount(getTotalAmount(startTime, endTime))
            .avgResponseTime(getAvgResponseTime(startTime, endTime))
            .channelStats(getChannelStats(startTime, endTime))
            .hourlyTrends(getHourlyTrends(startTime, endTime))
            .build();
    }
    
    @GetMapping("/channels/{channelId}/health")
    public ChannelHealthStatus getChannelHealth(@PathVariable String channelId) {
        return ChannelHealthStatus.builder()
            .channelId(channelId)
            .status(channelHealthService.getStatus(channelId))
            .successRate(channelStatsService.getSuccessRate(channelId))
            .avgResponseTime(channelStatsService.getAvgResponseTime(channelId))
            .lastFailureTime(channelStatsService.getLastFailureTime(channelId))
            .build();
    }
}
```

---

## 9. ğŸ§  æ”¯ä»˜æ™ºèƒ½ä¼˜åŒ–ç­–ç•¥


### 9.1 æˆæœ¬ä¼˜åŒ–ç®—æ³•


æ™ºèƒ½æˆæœ¬ä¼˜åŒ–å°±åƒè´­ç‰©æ—¶æ¯”ä»·ï¼Œç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©æ‰‹ç»­è´¹æœ€ä½ä½†æˆåŠŸç‡åˆé«˜çš„æ”¯ä»˜æ¸ é“ã€‚

**ğŸ’° æˆæœ¬æ•ˆç›Šåˆ†æ**
```java
@Service
public class PaymentCostOptimizer {
    
    public OptimalChannelResult findOptimalChannel(PaymentRequest request) {
        List<PaymentChannel> channels = getAvailableChannels(request);
        
        OptimalChannelResult bestChoice = null;
        double bestScore = Double.MIN_VALUE;
        
        for (PaymentChannel channel : channels) {
            // è®¡ç®—ç»¼åˆæˆæœ¬æ•ˆç›Šåˆ†æ•°
            double score = calculateCostBenefitScore(channel, request);
            
            if (score > bestScore) {
                bestScore = score;
                bestChoice = new OptimalChannelResult(channel, score);
            }
        }
        
        return bestChoice;
    }
    
    private double calculateCostBenefitScore(PaymentChannel channel, PaymentRequest request) {
        // è·å–æ¸ é“å†å²æ•°æ®
        ChannelStats stats = channelStatsService.getStats(channel.getId());
        
        // æˆåŠŸç‡æƒé‡ (è¶Šé«˜è¶Šå¥½)
        double successRate = stats.getSuccessRate();
        
        // æˆæœ¬æƒé‡ (è¶Šä½è¶Šå¥½)
        double cost = channel.getFeeRate() * request.getAmount();
        double costScore = 1.0 / (1.0 + cost / request.getAmount()); // å½’ä¸€åŒ–
        
        // å“åº”æ—¶é—´æƒé‡ (è¶Šå¿«è¶Šå¥½)
        double speedScore = 1.0 / (1.0 + stats.getAvgResponseTime() / 1000.0); // ç§’è½¬æ¢
        
        // ç»¼åˆè¯„åˆ†ï¼šæˆåŠŸç‡50% + æˆæœ¬30% + é€Ÿåº¦20%
        return successRate * 0.5 + costScore * 0.3 + speedScore * 0.2;
    }
}
```

### 9.2 æˆåŠŸç‡ä¼˜åŒ–


**ğŸ“ˆ æœºå™¨å­¦ä¹ é¢„æµ‹æ¨¡å‹**
```java
@Component
public class PaymentSuccessRatePredictor {
    
    public double predictSuccessRate(PaymentPredictionInput input) {
        // ç‰¹å¾å·¥ç¨‹
        Map<String, Double> features = extractFeatures(input);
        
        // ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹é¢„æµ‹
        return paymentMLModel.predict(features);
    }
    
    private Map<String, Double> extractFeatures(PaymentPredictionInput input) {
        Map<String, Double> features = new HashMap<>();
        
        // ç”¨æˆ·ç‰¹å¾
        UserProfile user = userService.getUserProfile(input.getUserId());
        features.put("user_age", (double) user.getAge());
        features.put("user_payment_count", (double) user.getHistoryPaymentCount());
        features.put("user_success_rate", user.getHistorySuccessRate());
        
        // è®¢å•ç‰¹å¾
        features.put("amount", (double) input.getAmount());
        features.put("hour_of_day", (double) LocalTime.now().getHour());
        features.put("day_of_week", (double) LocalDate.now().getDayOfWeek().getValue());
        
        // æ¸ é“ç‰¹å¾
        ChannelStats channelStats = channelStatsService.getStats(input.getChannelId());
        features.put("channel_recent_success_rate", channelStats.getRecentSuccessRate());
        features.put("channel_avg_response_time", (double) channelStats.getAvgResponseTime());
        
        return features;
    }
}
```

### 9.3 æ™ºèƒ½è·¯ç”±å†³ç­–


**ğŸ¯ åŠ¨æ€è·¯ç”±æƒé‡è°ƒæ•´**
```java
@Service
public class DynamicRoutingService {
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿè°ƒæ•´ä¸€æ¬¡
    public void adjustRoutingWeights() {
        List<PaymentChannel> channels = channelService.getAllChannels();
        
        for (PaymentChannel channel : channels) {
            // è·å–æœ€è¿‘çš„æ€§èƒ½æ•°æ®
            ChannelPerformance performance = getRecentPerformance(channel.getId());
            
            // è®¡ç®—æ–°çš„è·¯ç”±æƒé‡
            int newWeight = calculateDynamicWeight(performance);
            
            // æ›´æ–°è·¯ç”±æƒé‡
            routingConfigService.updateChannelWeight(channel.getId(), newWeight);
            
            log.info("æ¸ é“{}è·¯ç”±æƒé‡è°ƒæ•´ä¸º: {}", channel.getName(), newWeight);
        }
    }
    
    private int calculateDynamicWeight(ChannelPerformance performance) {
        // åŸºç¡€æƒé‡
        int baseWeight = 100;
        
        // æˆåŠŸç‡è°ƒæ•´ (æˆåŠŸç‡90%ä»¥ä¸Šä¸ºæ­£å¸¸)
        double successRate = performance.getSuccessRate();
        if (successRate >= 0.95) {
            baseWeight += 20; // è¶…é«˜æˆåŠŸç‡ï¼Œå¢åŠ æƒé‡
        } else if (successRate < 0.80) {
            baseWeight -= 50; // ä½æˆåŠŸç‡ï¼Œå¤§å¹…é™æƒ
        }
        
        // å“åº”æ—¶é—´è°ƒæ•´ (2ç§’ä»¥å†…ä¸ºæ­£å¸¸)
        long avgResponseTime = performance.getAvgResponseTime();
        if (avgResponseTime < 1000) {
            baseWeight += 10; // å“åº”å¿«ï¼Œå¢åŠ æƒé‡
        } else if (avgResponseTime > 5000) {
            baseWeight -= 30; // å“åº”æ…¢ï¼Œé™ä½æƒé‡
        }
        
        // ç¡®ä¿æƒé‡åœ¨åˆç†èŒƒå›´å†…
        return Math.max(10, Math.min(200, baseWeight));
    }
}
```

---

## 10. âš–ï¸ æ”¯ä»˜åˆè§„ä¸é£æ§


### 10.1 åæ´—é’±AMLæ£€æŸ¥


åæ´—é’±å°±åƒé“¶è¡Œçš„"é£é™©é›·è¾¾"ï¼Œé€šè¿‡åˆ†æäº¤æ˜“æ¨¡å¼å‘ç°å¯ç–‘è¡Œä¸ºã€‚

**ğŸ” AMLè§„åˆ™å¼•æ“**
```java
@Service
public class AMLRiskEngine {
    
    public AMLCheckResult checkAMLRisk(PaymentOrder order) {
        AMLCheckResult result = new AMLCheckResult();
        result.setOrderId(order.getOrderId());
        
        List<AMLRule> violations = new ArrayList<>();
        
        // 1. å¤§é¢äº¤æ˜“æ£€æŸ¥
        if (order.getAmount() >= 1000000) { // 1ä¸‡å…ƒä»¥ä¸Š
            violations.add(new AMLRule("LARGE_AMOUNT", "å¤§é¢äº¤æ˜“", order.getAmount()));
        }
        
        // 2. é¢‘ç¹äº¤æ˜“æ£€æŸ¥
        int dailyCount = getDailyTransactionCount(order.getUserId());
        if (dailyCount > 20) {
            violations.add(new AMLRule("FREQUENT_TRANSACTION", "é¢‘ç¹äº¤æ˜“", dailyCount));
        }
        
        // 3. å¼‚å¸¸æ—¶é—´äº¤æ˜“æ£€æŸ¥
        int hour = LocalTime.now().getHour();
        if (hour >= 2 && hour <= 5) { // å‡Œæ™¨2-5ç‚¹äº¤æ˜“
            violations.add(new AMLRule("UNUSUAL_TIME", "å¼‚å¸¸æ—¶é—´äº¤æ˜“", hour));
        }
        
        // 4. è·¨åœ°åŒºäº¤æ˜“æ£€æŸ¥
        if (isAbnormalLocation(order.getUserId(), order.getClientIp())) {
            violations.add(new AMLRule("ABNORMAL_LOCATION", "å¼‚å¸¸åœ°åŒºäº¤æ˜“", order.getClientIp()));
        }
        
        result.setViolations(violations);
        result.setRiskLevel(calculateRiskLevel(violations));
        
        return result;
    }
    
    private RiskLevel calculateRiskLevel(List<AMLRule> violations) {
        if (violations.isEmpty()) {
            return RiskLevel.LOW;
        }
        
        // æ ¹æ®è¿è§„è§„åˆ™çš„ä¸¥é‡ç¨‹åº¦è®¡ç®—é£é™©ç­‰çº§
        int totalScore = violations.stream()
            .mapToInt(rule -> rule.getSeverity())
            .sum();
            
        if (totalScore >= 80) return RiskLevel.HIGH;
        if (totalScore >= 50) return RiskLevel.MEDIUM;
        return RiskLevel.LOW;
    }
}
```

### 10.2 é™é¢é£æ§ç®¡ç†


**ğŸ’³ å¤šç»´åº¦é™é¢æ§åˆ¶**
```java
@Component
public class PaymentLimitController {
    
    public LimitCheckResult checkPaymentLimit(PaymentOrder order) {
        LimitCheckResult result = new LimitCheckResult();
        
        // 1. ç”¨æˆ·çº§é™é¢æ£€æŸ¥
        UserLimitStatus userLimit = checkUserLimit(order.getUserId(), order.getAmount());
        result.addLimitCheck("USER", userLimit);
        
        // 2. å•†æˆ·çº§é™é¢æ£€æŸ¥  
        MerchantLimitStatus merchantLimit = checkMerchantLimit(order.getMerchantId(), order.getAmount());
        result.addLimitCheck("MERCHANT", merchantLimit);
        
        // 3. æ¸ é“çº§é™é¢æ£€æŸ¥
        ChannelLimitStatus channelLimit = checkChannelLimit(order.getChannel(), order.getAmount());
        result.addLimitCheck("CHANNEL", channelLimit);
        
        // ç»¼åˆåˆ¤æ–­
        result.setAllowed(userLimit.isAllowed() && merchantLimit.isAllowed() && channelLimit.isAllowed());
        
        return result;
    }
    
    private UserLimitStatus checkUserLimit(String userId, long amount) {
        UserLimitConfig config = userLimitService.getUserLimitConfig(userId);
        
        // å•ç¬”é™é¢æ£€æŸ¥
        if (amount > config.getSingleLimit()) {
            return UserLimitStatus.rejected("å•ç¬”é‡‘é¢è¶…é™", amount, config.getSingleLimit());
        }
        
        // æ—¥ç´¯è®¡é™é¢æ£€æŸ¥
        long todayTotal = paymentStatsService.getUserTodayAmount(userId);
        if (todayTotal + amount > config.getDailyLimit()) {
            return UserLimitStatus.rejected("æ—¥ç´¯è®¡é‡‘é¢è¶…é™", 
                todayTotal + amount, config.getDailyLimit());
        }
        
        return UserLimitStatus.allowed();
    }
}
```

### 10.3 åˆè§„æŠ¥å‘Šç”Ÿæˆ


**ğŸ“Š è‡ªåŠ¨åˆè§„æŠ¥å‘Š**
```java
@Service
public class ComplianceReportService {
    
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹ç”Ÿæˆ
    public void generateDailyComplianceReport() {
        LocalDate reportDate = LocalDate.now().minusDays(1);
        
        ComplianceReport report = ComplianceReport.builder()
            .reportDate(reportDate)
            .totalTransactions(getTotalTransactions(reportDate))
            .totalAmount(getTotalAmount(reportDate))
            .largeAmountTransactions(getLargeAmountTransactions(reportDate))
            .suspiciousTransactions(getSuspiciousTransactions(reportDate))
            .amlAlerts(getAMLAlerts(reportDate))
            .build();
            
        // ä¿å­˜æŠ¥å‘Š
        complianceReportRepository.save(report);
        
        // å¦‚æœæœ‰é«˜é£é™©äº¤æ˜“ï¼Œç«‹å³é€šçŸ¥ç›¸å…³äººå‘˜
        if (report.getHighRiskTransactionCount() > 0) {
            notifyComplianceTeam(report);
        }
    }
    
    private List<SuspiciousTransaction> getSuspiciousTransactions(LocalDate date) {
        return transactionRepository.findByDateAndRiskLevel(date, RiskLevel.HIGH)
            .stream()
            .map(this::convertToSuspiciousTransaction)
            .collect(Collectors.toList());
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ”¯ä»˜ç½‘å…³æœ¬è´¨ï¼šç»Ÿä¸€æ¥å…¥å¤šæ¸ é“çš„"ä¸‡èƒ½é€‚é…å™¨"
ğŸ”¸ æ¸ é“ç®¡ç†ï¼šæŠ½è±¡ç»Ÿä¸€æ¥å£ï¼Œå±è”½å·®å¼‚åŒ–å®ç°
ğŸ”¸ è·¯ç”±ç­–ç•¥ï¼šåŸºäºæˆæœ¬ã€æˆåŠŸç‡ã€é€Ÿåº¦çš„æ™ºèƒ½é€‰æ‹©
ğŸ”¸ åè®®é€‚é…ï¼šä¸åŒæ”¯ä»˜æ¸ é“APIçš„æ ‡å‡†åŒ–å°è£…
ğŸ”¸ é€šçŸ¥æœºåˆ¶ï¼šå¼‚æ­¥å›è°ƒ + é‡è¯•ä¿éšœ + ä¸šåŠ¡é€šçŸ¥
ğŸ”¸ å®‰å…¨ä½“ç³»ï¼šåŠ å¯†ä¼ è¾“ + ç­¾åéªŒè¯ + é˜²é‡æ”¾æ”»å‡»
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šå®æ—¶æŒ‡æ ‡ + æ™ºèƒ½å‘Šè­¦ + å¯è§†åŒ–å¤§ç›˜
ğŸ”¸ åˆè§„é£æ§ï¼šAMLæ£€æŸ¥ + é™é¢ç®¡ç† + è‡ªåŠ¨æŠ¥å‘Š
```

### 11.2 å…³é”®æ¶æ„è®¾è®¡è¦ç‚¹


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„åŸåˆ™**
```
é«˜å¯ç”¨ï¼šå¤šæ¸ é“å†—ä½™ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢
é«˜æ€§èƒ½ï¼šæ™ºèƒ½è·¯ç”±ï¼Œç¼“å­˜ä¼˜åŒ–ï¼Œå¼‚æ­¥å¤„ç†
é«˜å®‰å…¨ï¼šç«¯åˆ°ç«¯åŠ å¯†ï¼Œå¤šé‡éªŒè¯ï¼Œå®¡è®¡æ—¥å¿—
å¯æ‰©å±•ï¼šæ’ä»¶åŒ–è®¾è®¡ï¼Œé…ç½®åŒ–ç®¡ç†ï¼Œå¼¹æ€§ä¼¸ç¼©
å¯ç›‘æ§ï¼šå…¨é“¾è·¯è¿½è¸ªï¼Œå®æ—¶æŒ‡æ ‡ï¼Œæ™ºèƒ½å‘Šè­¦
```

**ğŸ¯ å…³é”®æŠ€æœ¯é€‰å‹**
```
æ•°æ®åº“è®¾è®¡ï¼š
- è®¢å•è¡¨ï¼šåˆ†åº“åˆ†è¡¨ï¼ŒæŒ‰å•†æˆ·IDåˆ†ç‰‡
- é€šçŸ¥è¡¨ï¼šæŒ‰æ—¶é—´åˆ†ç‰‡ï¼Œå¼‚æ­¥å¤„ç†
- é…ç½®è¡¨ï¼šRedisç¼“å­˜ï¼ŒåŠ¨æ€æ›´æ–°

æ¶ˆæ¯é˜Ÿåˆ—ï¼š
- æ”¯ä»˜é€šçŸ¥ï¼šRocketMQäº‹åŠ¡æ¶ˆæ¯
- å¼‚æ­¥å¤„ç†ï¼šKafkaé«˜å¹¶å‘å¤„ç†
- é‡è¯•é˜Ÿåˆ—ï¼šRediså»¶æ—¶é˜Ÿåˆ—

ç¼“å­˜ç­–ç•¥ï¼š
- æ¸ é“é…ç½®ï¼šRedisé›†ç¾¤ç¼“å­˜
- ç”¨æˆ·é™é¢ï¼šæœ¬åœ°ç¼“å­˜+Redis
- è·¯ç”±æƒé‡ï¼šå®šæ—¶åˆ·æ–°ç¼“å­˜
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯é€‚é…**
```
ç”µå•†å¹³å°ï¼š
- é‡ç‚¹ï¼šæˆæœ¬ä¼˜åŒ–ï¼Œç”¨æˆ·ä½“éªŒ
- ç­–ç•¥ï¼šå°é¢ä¼˜å…ˆç¬¬ä¸‰æ–¹ï¼Œå¤§é¢èµ°é“¶è”
- ç‰¹è‰²ï¼šè´­ç‰©è½¦åˆå¹¶æ”¯ä»˜ï¼Œåˆ†æœŸæ”¯ä»˜

é‡‘èæœåŠ¡ï¼š
- é‡ç‚¹ï¼šå®‰å…¨åˆè§„ï¼Œèµ„é‡‘å®‰å…¨
- ç­–ç•¥ï¼šä¸¥æ ¼é£æ§ï¼Œå®åè®¤è¯
- ç‰¹è‰²ï¼šå¤§é¢åˆ†ç¬”ï¼ŒT+0å®æ—¶åˆ°è´¦

O2OæœåŠ¡ï¼š
- é‡ç‚¹ï¼šæ”¯ä»˜é€Ÿåº¦ï¼Œç§»åŠ¨ä¼˜å…ˆ
- ç­–ç•¥ï¼šç§»åŠ¨ç«¯ä¼˜å…ˆï¼Œçº¿ä¸‹æ‰«ç 
- ç‰¹è‰²ï¼šåœ°ç†ä½ç½®éªŒè¯ï¼Œå•†å®¶åˆ†è´¦
```

**ğŸ”§ è¿ç»´æœ€ä½³å®è·µ**
```
ç›‘æ§å‘Šè­¦ï¼š
- æˆåŠŸç‡ä½äº95%ç«‹å³å‘Šè­¦
- å“åº”æ—¶é—´è¶…è¿‡3ç§’å‘Šè­¦
- å•æ¸ é“æ•…éšœè‡ªåŠ¨åˆ‡æ¢

å®¹é‡è§„åˆ’ï¼š
- æŒ‰å³°å€¼3å€å®¹é‡å‡†å¤‡
- æ¸ é“é™æµä¿æŠ¤è®¾ç½®
- æ•°æ®åº“è¯»å†™åˆ†ç¦»

å®‰å…¨å®¡è®¡ï¼š
- æ”¯ä»˜æ—¥å¿—æ°¸ä¹…ä¿å­˜
- æ•æ„Ÿæ“ä½œå®æ—¶å‘Šè­¦
- å®šæœŸå®‰å…¨æ¼æ´æ‰«æ
```

### 11.4 å‘å±•è¶‹åŠ¿å±•æœ›


**ğŸš€ æŠ€æœ¯æ¼”è¿›æ–¹å‘**
```
äººå·¥æ™ºèƒ½ï¼š
- æ™ºèƒ½é£æ§ï¼šæœºå™¨å­¦ä¹ è¯†åˆ«æ¬ºè¯ˆ
- æ™ºèƒ½è·¯ç”±ï¼šAIä¼˜åŒ–æ¸ é“é€‰æ‹©
- æ™ºèƒ½å®¢æœï¼šè‡ªåŠ¨å¤„ç†æ”¯ä»˜é—®é¢˜

åŒºå—é“¾æŠ€æœ¯ï¼š
- æ•°å­—è´§å¸ï¼šå¤®è¡Œæ•°å­—è´§å¸æ¥å…¥
- è·¨å¢ƒæ”¯ä»˜ï¼šåŒºå—é“¾é™ä½æˆæœ¬
- æ™ºèƒ½åˆçº¦ï¼šè‡ªåŠ¨æ‰§è¡Œæ”¯ä»˜æ¡ä»¶

è¾¹ç¼˜è®¡ç®—ï¼š
- å°±è¿‘å¤„ç†ï¼šå‡å°‘æ”¯ä»˜å»¶è¿Ÿ
- ç¦»çº¿æ”¯ä»˜ï¼šæ–­ç½‘ç¯å¢ƒæ”¯æŒ
- å®æ—¶é£æ§ï¼šæ¯«ç§’çº§é£é™©è¯†åˆ«
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ”¯ä»˜ç½‘å…³æ¶æ„è®¾è®¡ï¼Œç»Ÿä¸€æ¥å…¥æ˜¯æ ¸å¿ƒ
è·¯ç”±ç­–ç•¥æ™ºèƒ½é€‰æ‹©ï¼Œæˆæœ¬æˆåŠŸç‡å¹¶é‡  
å®‰å…¨åˆè§„ä¸å¯å°‘ï¼ŒåŠ å¯†éªŒè¯é˜²æ”»å‡»
ç›‘æ§å‘Šè­¦è¦åŠæ—¶ï¼Œå¼‚å¸¸å¤„ç†è¦å®Œå–„
```

**å®æˆ˜å…³é”®ç‚¹**ï¼š
- æ”¯ä»˜ç½‘å…³æ˜¯é‡‘èç³»ç»Ÿçš„"å¿ƒè„"ï¼Œç¨³å®šæ€§å’Œå®‰å…¨æ€§æ˜¯é¦–è¦è€ƒè™‘
- æ¸ é“ç®¡ç†è¦åšåˆ°"æ´»çš„æ¶æ„"ï¼Œæ”¯æŒåŠ¨æ€é…ç½®å’Œçƒ­æ›´æ–°
- è·¯ç”±ç­–ç•¥è¦å¹³è¡¡å¤šä¸ªç›®æ ‡ï¼Œä¸èƒ½åªçœ‹å•ä¸€æŒ‡æ ‡
- å¼‚å¸¸å¤„ç†è¦è€ƒè™‘ç”¨æˆ·ä½“éªŒï¼Œæ™ºèƒ½é‡è¯•æ¯”ç›´æ¥å¤±è´¥æ›´å¥½
- ç›‘æ§ä½“ç³»è¦åšåˆ°"æœªåœå…ˆçŸ¥"ï¼Œé—®é¢˜å‘ç”Ÿå‰å°±èƒ½é¢„è­¦