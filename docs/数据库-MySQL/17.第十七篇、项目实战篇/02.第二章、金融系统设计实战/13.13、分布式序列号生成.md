---
title: 13ã€åˆ†å¸ƒå¼åºåˆ—å·ç”Ÿæˆ
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼åºåˆ—å·åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼åºåˆ—å·åŸºç¡€æ¦‚å¿µ)
2. [é›ªèŠ±ç®—æ³•æ ¸å¿ƒå®ç°](#2-é›ªèŠ±ç®—æ³•æ ¸å¿ƒå®ç°)
3. [æ•°æ®åº“åºåˆ—å·æ–¹æ¡ˆ](#3-æ•°æ®åº“åºåˆ—å·æ–¹æ¡ˆ)
4. [Redisåˆ†å¸ƒå¼è®¡æ•°å™¨](#4-Redisåˆ†å¸ƒå¼è®¡æ•°å™¨)
5. [å·æ®µæ¨¡å¼æ‰¹é‡åˆ†é…](#5-å·æ®µæ¨¡å¼æ‰¹é‡åˆ†é…)
6. [åºåˆ—å·å®‰å…¨ä¸æ€§èƒ½](#6-åºåˆ—å·å®‰å…¨ä¸æ€§èƒ½)
7. [é«˜å¯ç”¨ä¸å®¹é”™æœºåˆ¶](#7-é«˜å¯ç”¨ä¸å®¹é”™æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åˆ†å¸ƒå¼åºåˆ—å·åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼åºåˆ—å·


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
åˆ†å¸ƒå¼åºåˆ—å·ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦çš„æœºåˆ¶
ç›®çš„ï¼šä¿è¯å¤šä¸ªèŠ‚ç‚¹åŒæ—¶ç”Ÿæˆçš„IDä¸ä¼šé‡å¤
åº”ç”¨ï¼šè®¢å•å·ã€ç”¨æˆ·IDã€äº¤æ˜“æµæ°´å·ç­‰ä¸šåŠ¡åœºæ™¯
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ID**
```
ä¼ ç»Ÿå•æœºé—®é¢˜ï¼š
â€¢ æ•°æ®åº“è‡ªå¢IDï¼šåˆ†åº“åˆ†è¡¨åä¼šé‡å¤
â€¢ UUIDï¼šé•¿åº¦å¤ªé•¿ï¼Œæ— åºæ€§å½±å“æ€§èƒ½
â€¢ æ—¶é—´æˆ³ï¼šé«˜å¹¶å‘ä¸‹å®¹æ˜“é‡å¤

åˆ†å¸ƒå¼ç¯å¢ƒæŒ‘æˆ˜ï¼š
â€¢ å¤šä¸ªæœåŠ¡å™¨åŒæ—¶ç”ŸæˆID
â€¢ ç½‘ç»œå»¶è¿Ÿå’Œæ—¶é’Ÿåå·®
â€¢ ç³»ç»Ÿæ•…éšœå’Œæ¢å¤é—®é¢˜
```

### 1.2 åˆ†å¸ƒå¼IDçš„æ ¸å¿ƒè¦æ±‚


**ğŸ¯ åŸºæœ¬è¦æ±‚**
```
å…¨å±€å”¯ä¸€æ€§ï¼š
â€¢ ä»»ä½•æ—¶å€™ç”Ÿæˆçš„IDéƒ½ä¸èƒ½é‡å¤
â€¢ è·¨æœºå™¨ã€è·¨è¿›ç¨‹ã€è·¨æ—¶é—´çš„å”¯ä¸€æ€§

é«˜æ€§èƒ½ï¼š
â€¢ ç”Ÿæˆé€Ÿåº¦å¿«ï¼Œæ”¯æŒé«˜å¹¶å‘
â€¢ å»¶è¿Ÿä½ï¼Œä¸æˆä¸ºç³»ç»Ÿç“¶é¢ˆ

é«˜å¯ç”¨ï¼š
â€¢ æœåŠ¡ç¨³å®šï¼Œæ•…éšœæ—¶èƒ½å¿«é€Ÿæ¢å¤
â€¢ ä¸ä¾èµ–å•ç‚¹ï¼Œå…·å¤‡å®¹é”™èƒ½åŠ›
```

**ğŸ” ä¸šåŠ¡ç‰¹æ€§è¦æ±‚**
```
æœ‰åºæ€§ï¼š
â€¢ è¶‹åŠ¿é€’å¢ï¼ˆä¾¿äºæ•°æ®åº“ç´¢å¼•ï¼‰
â€¢ æ—¶é—´ç›¸å…³æ€§ï¼ˆä¾¿äºæ’åºæŸ¥è¯¢ï¼‰

å¯è¯»æ€§ï¼š
â€¢ åŒ…å«ä¸šåŠ¡å«ä¹‰ï¼ˆå¦‚æ—¶é—´ã€æœºå™¨æ ‡è¯†ï¼‰
â€¢ ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ•°æ®åˆ†æ

å®‰å…¨æ€§ï¼š
â€¢ ä¸æ˜“è¢«çŒœæµ‹ï¼ˆé˜²æ­¢çˆ¬è™«å’Œæ”»å‡»ï¼‰
â€¢ ä¸æš´éœ²ä¸šåŠ¡ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·æ•°é‡ï¼‰
```

---

## 2. â„ï¸ é›ªèŠ±ç®—æ³•æ ¸å¿ƒå®ç°


### 2.1 é›ªèŠ±ç®—æ³•åŸç†è§£æ


**ğŸ”¸ ç®—æ³•ç»“æ„**
```
64ä½é•¿æ•´å‹IDç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1bit â”‚    41bit     â”‚  10bit  â”‚      12bit      â”‚
â”‚ ç¬¦å·ä½ â”‚   æ—¶é—´æˆ³     â”‚ æœºå™¨ID   â”‚    åºåˆ—å·       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…·ä½“å«ä¹‰ï¼š
â€¢ ç¬¦å·ä½ï¼šå›ºå®šä¸º0ï¼Œä¿è¯ç”Ÿæˆçš„IDä¸ºæ­£æ•°
â€¢ æ—¶é—´æˆ³ï¼šç›¸å¯¹äºèµ·å§‹æ—¶é—´çš„æ¯«ç§’æ•°ï¼ˆå¯ç”¨69å¹´ï¼‰
â€¢ æœºå™¨IDï¼šæœºå™¨æ ‡è¯†ï¼ˆæ”¯æŒ1024å°æœºå™¨ï¼‰
â€¢ åºåˆ—å·ï¼šåŒä¸€æ¯«ç§’å†…çš„è®¡æ•°å™¨ï¼ˆæ”¯æŒ4096ä¸ªID/æ¯«ç§’ï¼‰
```

**ğŸ’¡ ç®—æ³•ä¼˜åŠ¿**
```
æ€§èƒ½ä¼˜å¼‚ï¼š
â€¢ æœ¬åœ°ç”Ÿæˆï¼Œæ— ç½‘ç»œå¼€é”€
â€¢ ç†è®ºQPSå¯è¾¾400ä¸‡ï¼ˆ4096 * 1000ï¼‰

è¶‹åŠ¿é€’å¢ï¼š
â€¢ æ—¶é—´æˆ³é€’å¢ä¿è¯å¤§è‡´æœ‰åº
â€¢ ä¾¿äºæ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

ä¿¡æ¯ä¸°å¯Œï¼š
â€¢ åŒ…å«ç”Ÿæˆæ—¶é—´ä¿¡æ¯
â€¢ åŒ…å«æœºå™¨æ ‡è¯†ä¿¡æ¯
```

### 2.2 é›ªèŠ±ç®—æ³•Javaå®ç°


**ğŸ”§ æ ¸å¿ƒå®ç°ä»£ç **
```java
public class SnowflakeIdGenerator {
    // èµ·å§‹æ—¶é—´æˆ³ (2024-01-01)
    private static final long START_TIMESTAMP = 1704067200000L;
    
    // å„éƒ¨åˆ†å ç”¨ä½æ•°
    private static final long SEQUENCE_BITS = 12;
    private static final long MACHINE_BITS = 10;
    private static final long TIMESTAMP_BITS = 41;
    
    // æœ€å¤§å€¼
    private static final long MAX_SEQUENCE = ~(-1L << SEQUENCE_BITS);
    private static final long MAX_MACHINE_NUM = ~(-1L << MACHINE_BITS);
    
    // ä½ç§»é‡
    private static final long MACHINE_SHIFT = SEQUENCE_BITS;
    private static final long TIMESTAMP_SHIFT = SEQUENCE_BITS + MACHINE_BITS;
    
    private long machineId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdGenerator(long machineId) {
        if (machineId > MAX_MACHINE_NUM || machineId < 0) {
            throw new IllegalArgumentException("æœºå™¨IDè¶…å‡ºèŒƒå›´");
        }
        this.machineId = machineId;
    }
    
    public synchronized long nextId() {
        long currentTime = getCurrentTime();
        
        // å¤„ç†æ—¶é’Ÿå›æ‹¨
        if (currentTime < lastTimestamp) {
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨å¼‚å¸¸");
        }
        
        if (currentTime == lastTimestamp) {
            // åŒä¸€æ¯«ç§’å†…ï¼Œåºåˆ—å·é€’å¢
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                // åºåˆ—å·è€—å°½ï¼Œç­‰å¾…ä¸‹ä¸€æ¯«ç§’
                currentTime = waitNextMillis(currentTime);
            }
        } else {
            // æ–°çš„æ¯«ç§’ï¼Œåºåˆ—å·é‡ç½®ä¸º0
            sequence = 0L;
        }
        
        lastTimestamp = currentTime;
        
        // ç»„è£…64ä½ID
        return ((currentTime - START_TIMESTAMP) << TIMESTAMP_SHIFT)
                | (machineId << MACHINE_SHIFT)
                | sequence;
    }
    
    private long getCurrentTime() {
        return System.currentTimeMillis();
    }
    
    private long waitNextMillis(long currentTime) {
        while (currentTime <= lastTimestamp) {
            currentTime = getCurrentTime();
        }
        return currentTime;
    }
}
```

### 2.3 é›ªèŠ±ç®—æ³•ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–**
```java
// 1. æœºå™¨IDè‡ªåŠ¨è·å–
public class MachineIdProvider {
    public static long getMachineId() {
        try {
            InetAddress ip = InetAddress.getLocalHost();
            NetworkInterface network = NetworkInterface.getByInetAddress(ip);
            byte[] mac = network.getHardwareAddress();
            
            long id = 0;
            for (byte b : mac) {
                id = (id << 8) | (b & 0xFF);
            }
            return id & 0x3FF; // å–ä½10ä½ä½œä¸ºæœºå™¨ID
        } catch (Exception e) {
            // fallback to random
            return new Random().nextInt(1024);
        }
    }
}

// 2. æ—¶é’Ÿå›æ‹¨å¤„ç†
public class ClockBackwardHandler {
    private static final long TOLERANCE_MS = 5; // 5mså®¹å¿åº¦
    
    public long handleClockBackward(long lastTime, long currentTime) {
        long offset = lastTime - currentTime;
        
        if (offset <= TOLERANCE_MS) {
            // å°åç§»ï¼Œç­‰å¾…è¿½ä¸Š
            try {
                Thread.sleep(offset + 1);
                return System.currentTimeMillis();
            } catch (InterruptedException e) {
                throw new RuntimeException("ç­‰å¾…æ—¶é’Ÿè¿½ä¸Šè¢«ä¸­æ–­");
            }
        } else {
            // å¤§åç§»ï¼ŒæŠ›å¼‚å¸¸
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨è¿‡å¤§: " + offset + "ms");
        }
    }
}
```

---

## 3. ğŸ’¾ æ•°æ®åº“åºåˆ—å·æ–¹æ¡ˆ


### 3.1 MySQLåºåˆ—å·è¡¨è®¾è®¡


**ğŸ”¸ åŸºç¡€è¡¨ç»“æ„**
```sql
-- åºåˆ—å·ç”Ÿæˆè¡¨
CREATE TABLE sequence_generator (
    seq_name VARCHAR(50) PRIMARY KEY COMMENT 'åºåˆ—åç§°',
    current_value BIGINT NOT NULL DEFAULT 0 COMMENT 'å½“å‰å€¼',
    increment_step INT NOT NULL DEFAULT 1 COMMENT 'æ­¥é•¿',
    max_value BIGINT DEFAULT NULL COMMENT 'æœ€å¤§å€¼',
    cache_size INT NOT NULL DEFAULT 1000 COMMENT 'ç¼“å­˜å¤§å°',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT 'åºåˆ—å·ç”Ÿæˆå™¨';

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO sequence_generator (seq_name, current_value, increment_step, cache_size)
VALUES 
    ('order_id', 100000, 1, 1000),
    ('user_id', 10000, 1, 500),
    ('transaction_id', 1000000, 1, 2000);
```

**ğŸ’¡ Javaå®ç°ç±»**
```java
@Component
public class DatabaseSequenceGenerator {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private final Map<String, SequenceCache> cacheMap = new ConcurrentHashMap<>();
    
    public Long nextId(String sequenceName) {
        SequenceCache cache = cacheMap.computeIfAbsent(sequenceName, 
            k -> new SequenceCache(k));
        
        return cache.nextValue();
    }
    
    private class SequenceCache {
        private final String sequenceName;
        private long currentValue;
        private long maxValue;
        private final Object lock = new Object();
        
        public SequenceCache(String sequenceName) {
            this.sequenceName = sequenceName;
            loadNextBatch();
        }
        
        public long nextValue() {
            synchronized (lock) {
                if (currentValue >= maxValue) {
                    loadNextBatch();
                }
                return ++currentValue;
            }
        }
        
        private void loadNextBatch() {
            String sql = """
                UPDATE sequence_generator 
                SET current_value = current_value + cache_size,
                    update_time = CURRENT_TIMESTAMP
                WHERE seq_name = ?
                """;
            
            jdbcTemplate.update(sql, sequenceName);
            
            // è·å–æ›´æ–°åçš„å€¼
            String querySql = """
                SELECT current_value, cache_size 
                FROM sequence_generator 
                WHERE seq_name = ?
                """;
            
            Map<String, Object> result = jdbcTemplate.queryForMap(querySql, sequenceName);
            long dbValue = (Long) result.get("current_value");
            int cacheSize = (Integer) result.get("cache_size");
            
            this.maxValue = dbValue;
            this.currentValue = dbValue - cacheSize;
        }
    }
}
```

### 3.2 Oracleåºåˆ—å·æ–¹æ¡ˆ


**ğŸ”§ Oracle Sequenceåˆ›å»º**
```sql
-- åˆ›å»ºåºåˆ—
CREATE SEQUENCE order_id_seq
    START WITH 100000
    INCREMENT BY 1
    CACHE 1000
    NOCYCLE
    NOORDER;

-- ä½¿ç”¨åºåˆ—
SELECT order_id_seq.NEXTVAL FROM dual;

-- æ‰¹é‡è·å–åºåˆ—å·çš„å­˜å‚¨è¿‡ç¨‹
CREATE OR REPLACE PROCEDURE get_batch_sequence(
    p_seq_name VARCHAR2,
    p_batch_size NUMBER,
    p_start_value OUT NUMBER,
    p_end_value OUT NUMBER
) AS
    v_sql VARCHAR2(200);
BEGIN
    -- åŠ¨æ€SQLè·å–åºåˆ—å€¼
    v_sql := 'SELECT ' || p_seq_name || '.NEXTVAL FROM dual';
    
    EXECUTE IMMEDIATE v_sql INTO p_start_value;
    p_end_value := p_start_value + p_batch_size - 1;
    
    -- æ¨è¿›åºåˆ—åˆ°ç»“æŸä½ç½®
    v_sql := 'ALTER SEQUENCE ' || p_seq_name || ' INCREMENT BY ' || (p_batch_size - 1);
    EXECUTE IMMEDIATE v_sql;
    
    EXECUTE IMMEDIATE 'SELECT ' || p_seq_name || '.NEXTVAL FROM dual' INTO p_end_value;
    
    -- æ¢å¤åºåˆ—æ­¥é•¿
    v_sql := 'ALTER SEQUENCE ' || p_seq_name || ' INCREMENT BY 1';
    EXECUTE IMMEDIATE v_sql;
END;
```

---

## 4. ğŸ”´ Redisåˆ†å¸ƒå¼è®¡æ•°å™¨


### 4.1 RedisåŸå­é€’å¢æ–¹æ¡ˆ


**ğŸ”¸ åŸºç¡€å®ç°**
```java
@Component
public class RedisSequenceGenerator {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // å•ä¸ªåºåˆ—å·ç”Ÿæˆ
    public Long nextId(String key) {
        return redisTemplate.opsForValue().increment(key);
    }
    
    // å¸¦è¿‡æœŸæ—¶é—´çš„åºåˆ—å·
    public Long nextIdWithExpire(String key, Duration expire) {
        Long value = redisTemplate.opsForValue().increment(key);
        if (value == 1) {
            // é¦–æ¬¡åˆ›å»ºæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.expire(key, expire);
        }
        return value;
    }
    
    // æ‰¹é‡è·å–åºåˆ—å·
    public List<Long> batchNextId(String key, int count) {
        Long startValue = redisTemplate.opsForValue().increment(key, count);
        
        List<Long> result = new ArrayList<>();
        for (int i = count - 1; i >= 0; i--) {
            result.add(startValue - i);
        }
        return result;
    }
}
```

### 4.2 åŸºäºæ—¶é—´çš„åºåˆ—å·


**ğŸ’¡ æ—¥æœŸå‰ç¼€åºåˆ—å·**
```java
@Component
public class DatePrefixSequenceGenerator {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // ç”Ÿæˆæ ¼å¼ï¼š20240115001001 (æ—¥æœŸ + 6ä½åºå·)
    public String nextOrderId() {
        String datePrefix = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String redisKey = "order_seq:" + datePrefix;
        
        Long sequence = redisTemplate.opsForValue().increment(redisKey);
        
        // è®¾ç½®å½“å¤©ç»“æŸæ—¶è¿‡æœŸ
        if (sequence == 1) {
            LocalDateTime endOfDay = LocalDate.now().atTime(23, 59, 59);
            Duration expire = Duration.between(LocalDateTime.now(), endOfDay);
            redisTemplate.expire(redisKey, expire);
        }
        
        return datePrefix + String.format("%06d", sequence);
    }
    
    // ç”Ÿæˆå¸¦ä¸šåŠ¡å‰ç¼€çš„åºåˆ—å·
    public String nextBusinessId(String businessType) {
        String timePrefix = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmm"));
        String redisKey = businessType + "_seq:" + timePrefix;
        
        Long sequence = redisTemplate.opsForValue().increment(redisKey);
        
        // è®¾ç½®1å°æ—¶åè¿‡æœŸ
        if (sequence == 1) {
            redisTemplate.expire(redisKey, Duration.ofHours(1));
        }
        
        return businessType.toUpperCase() + timePrefix + String.format("%04d", sequence);
    }
}
```

### 4.3 Redis Luaè„šæœ¬ä¼˜åŒ–


**âš¡ åŸå­æ€§æ“ä½œè„šæœ¬**
```java
@Component
public class RedisLuaSequenceGenerator {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // Luaè„šæœ¬ï¼šå¸¦æœ€å¤§å€¼é™åˆ¶çš„é€’å¢
    private static final String INCREMENT_WITH_MAX_SCRIPT = """
        local key = KEYS[1]
        local max_val = tonumber(ARGV[1])
        local current = redis.call('GET', key)
        
        if current == false then
            current = 0
        else
            current = tonumber(current)
        end
        
        if current >= max_val then
            return -1
        end
        
        local next_val = redis.call('INCR', key)
        return next_val
        """;
    
    private final RedisScript<Long> incrementScript;
    
    public RedisLuaSequenceGenerator() {
        incrementScript = RedisScript.of(INCREMENT_WITH_MAX_SCRIPT, Long.class);
    }
    
    public Long nextIdWithMax(String key, long maxValue) {
        Long result = redisTemplate.execute(incrementScript, 
                                          Collections.singletonList(key), 
                                          String.valueOf(maxValue));
        if (result == -1) {
            throw new RuntimeException("åºåˆ—å·å·²è¾¾ä¸Šé™: " + maxValue);
        }
        return result;
    }
}
```

---

## 5. ğŸ“¦ å·æ®µæ¨¡å¼æ‰¹é‡åˆ†é…


### 5.1 å·æ®µæ¨¡å¼æ ¸å¿ƒåŸç†


**ğŸ”¸ å·¥ä½œæœºåˆ¶**
```
å·æ®µåˆ†é…æµç¨‹ï¼š
1. åº”ç”¨å¯åŠ¨æ—¶å‘æ•°æ®åº“ç”³è¯·ä¸€ä¸ªå·æ®µèŒƒå›´
2. åœ¨æœ¬åœ°å†…å­˜ä¸­ä½¿ç”¨è¿™ä¸ªå·æ®µç”ŸæˆID
3. å·æ®µç”¨å®Œæ—¶ï¼Œå†æ¬¡å‘æ•°æ®åº“ç”³è¯·æ–°å·æ®µ
4. æ”¯æŒé¢„åˆ†é…ï¼Œé¿å…å·æ®µç”¨å®Œæ—¶çš„ç­‰å¾…

ä¼˜åŠ¿ç‰¹ç‚¹ï¼š
â€¢ å‡å°‘æ•°æ®åº“è®¿é—®é¢‘ç‡
â€¢ æé«˜IDç”Ÿæˆæ€§èƒ½
â€¢ æ”¯æŒå¹³æ»‘æ‰©å®¹
â€¢ å…·å¤‡å®¹ç¾æ¢å¤èƒ½åŠ›
```

### 5.2 å·æ®µæ¨¡å¼å®ç°


**ğŸ”§ æ•°æ®åº“è¡¨è®¾è®¡**
```sql
-- å·æ®µåˆ†é…è¡¨
CREATE TABLE id_segment (
    business_type VARCHAR(50) PRIMARY KEY COMMENT 'ä¸šåŠ¡ç±»å‹',
    max_id BIGINT NOT NULL DEFAULT 0 COMMENT 'å½“å‰æœ€å¤§ID',
    step INT NOT NULL DEFAULT 1000 COMMENT 'æ­¥é•¿',
    description VARCHAR(200) COMMENT 'æè¿°',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT 'IDå·æ®µåˆ†é…è¡¨';

-- åˆå§‹æ•°æ®
INSERT INTO id_segment (business_type, max_id, step, description)
VALUES 
    ('order', 100000, 1000, 'è®¢å•ID'),
    ('user', 10000, 500, 'ç”¨æˆ·ID'),
    ('payment', 1000000, 2000, 'æ”¯ä»˜ID');
```

**ğŸ’¡ å·æ®µåˆ†é…å™¨å®ç°**
```java
@Component
public class SegmentIdGenerator {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    private final Map<String, Segment> segmentMap = new ConcurrentHashMap<>();
    private final Map<String, Object> lockMap = new ConcurrentHashMap<>();
    
    public Long nextId(String businessType) {
        Segment segment = segmentMap.computeIfAbsent(businessType, 
            k -> new Segment(k));
        
        return segment.nextId();
    }
    
    private class Segment {
        private final String businessType;
        private volatile long currentId;
        private volatile long maxId;
        private volatile boolean isLoadingNext = false;
        private Segment nextSegment; // é¢„åŠ è½½çš„ä¸‹ä¸ªå·æ®µ
        
        public Segment(String businessType) {
            this.businessType = businessType;
            loadSegment();
        }
        
        public synchronized long nextId() {
            // å½“å‰å·æ®µè¿˜æœ‰ä½™é‡
            if (currentId < maxId) {
                return ++currentId;
            }
            
            // å½“å‰å·æ®µç”¨å®Œï¼Œåˆ‡æ¢åˆ°é¢„åŠ è½½çš„å·æ®µ
            if (nextSegment != null) {
                this.currentId = nextSegment.currentId;
                this.maxId = nextSegment.maxId;
                this.nextSegment = null;
                
                // å¼‚æ­¥åŠ è½½ä¸‹ä¸€ä¸ªå·æ®µ
                loadNextSegmentAsync();
                
                return ++currentId;
            }
            
            // æ²¡æœ‰é¢„åŠ è½½å·æ®µï¼ŒåŒæ­¥åŠ è½½
            loadSegment();
            return ++currentId;
        }
        
        private void loadSegment() {
            String sql = """
                UPDATE id_segment 
                SET max_id = max_id + step,
                    update_time = CURRENT_TIMESTAMP
                WHERE business_type = ?
                """;
            
            jdbcTemplate.update(sql, businessType);
            
            // è·å–åˆ†é…çš„å·æ®µ
            String querySql = """
                SELECT max_id, step FROM id_segment 
                WHERE business_type = ?
                """;
            
            Map<String, Object> result = jdbcTemplate.queryForMap(querySql, businessType);
            long maxIdFromDb = (Long) result.get("max_id");
            int step = (Integer) result.get("step");
            
            this.maxId = maxIdFromDb;
            this.currentId = maxIdFromDb - step;
            
            // å½“ä½¿ç”¨äº†50%æ—¶ï¼Œé¢„åŠ è½½ä¸‹ä¸ªå·æ®µ
            schedulePreLoad();
        }
        
        private void schedulePreLoad() {
            long threshold = currentId + (maxId - currentId) / 2;
            
            new Thread(() -> {
                while (currentId < threshold) {
                    try {
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        break;
                    }
                }
                loadNextSegmentAsync();
            }).start();
        }
        
        private void loadNextSegmentAsync() {
            if (isLoadingNext) {
                return;
            }
            
            synchronized (lockMap.computeIfAbsent(businessType, k -> new Object())) {
                if (isLoadingNext || nextSegment != null) {
                    return;
                }
                
                isLoadingNext = true;
                
                try {
                    Segment next = new Segment(businessType + "_next");
                    next.businessType = this.businessType;
                    next.loadSegment();
                    this.nextSegment = next;
                } finally {
                    isLoadingNext = false;
                }
            }
        }
    }
}
```

---

## 6. ğŸ”’ åºåˆ—å·å®‰å…¨ä¸æ€§èƒ½


### 6.1 åºåˆ—å·å®‰å…¨æ€§ä¿è¯


**ğŸ”¸ é˜²æ­¢åºåˆ—å·æ³„éœ²**
```java
@Component
public class SecureSequenceGenerator {
    
    private final SnowflakeIdGenerator snowflake;
    private final AESUtil aesUtil; // AESåŠ å¯†å·¥å…·
    
    public SecureSequenceGenerator() {
        this.snowflake = new SnowflakeIdGenerator(getMachineId());
        this.aesUtil = new AESUtil("your-secret-key-16");
    }
    
    // ç”ŸæˆåŠ å¯†åºåˆ—å·
    public String generateSecureId() {
        long rawId = snowflake.nextId();
        
        // æ·»åŠ éšæœºç›å€¼
        String plainText = rawId + "_" + System.nanoTime();
        
        // AESåŠ å¯†
        String encrypted = aesUtil.encrypt(plainText);
        
        // Base64ç¼–ç ï¼ˆURLå®‰å…¨ï¼‰
        return Base64.getUrlEncoder().encodeToString(encrypted.getBytes());
    }
    
    // è§£å¯†åºåˆ—å·
    public long decryptId(String secureId) {
        try {
            byte[] encryptedBytes = Base64.getUrlDecoder().decode(secureId);
            String plainText = aesUtil.decrypt(new String(encryptedBytes));
            
            // æå–åŸå§‹ID
            String[] parts = plainText.split("_");
            return Long.parseLong(parts[0]);
        } catch (Exception e) {
            throw new IllegalArgumentException("æ— æ•ˆçš„åºåˆ—å·", e);
        }
    }
}
```

**âš ï¸ åºåˆ—å·å†²çªæ£€æµ‹**
```java
@Component
public class ConflictDetectionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String CONFLICT_KEY_PREFIX = "id_conflict:";
    private static final Duration CONFLICT_EXPIRE = Duration.ofHours(24);
    
    // æ£€æµ‹å¹¶è®°å½•åºåˆ—å·
    public boolean checkAndRecord(String businessType, long sequenceId) {
        String key = CONFLICT_KEY_PREFIX + businessType + ":" + sequenceId;
        
        Boolean isNew = redisTemplate.opsForValue().setIfAbsent(key, 
                                                              System.currentTimeMillis(), 
                                                              CONFLICT_EXPIRE);
        
        if (!Boolean.TRUE.equals(isNew)) {
            // å‘ç°å†²çªï¼Œè®°å½•æ—¥å¿—å¹¶å‘Šè­¦
            logger.error("åºåˆ—å·å†²çªæ£€æµ‹åˆ°: {} - {}", businessType, sequenceId);
            sendConflictAlert(businessType, sequenceId);
            return false;
        }
        
        return true;
    }
    
    private void sendConflictAlert(String businessType, long sequenceId) {
        // å‘é€å‘Šè­¦é€šçŸ¥
        AlertMessage alert = AlertMessage.builder()
            .level(AlertLevel.HIGH)
            .title("åºåˆ—å·å†²çªå‘Šè­¦")
            .content(String.format("ä¸šåŠ¡ç±»å‹: %s, å†²çªID: %d", businessType, sequenceId))
            .timestamp(LocalDateTime.now())
            .build();
        
        alertService.sendAlert(alert);
    }
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ æœ¬åœ°ç¼“å­˜ä¼˜åŒ–**
```java
@Component
public class CachedSequenceGenerator {
    
    private final LoadingCache<String, AtomicLong> localCache;
    private final SegmentIdGenerator segmentGenerator;
    
    public CachedSequenceGenerator(SegmentIdGenerator segmentGenerator) {
        this.segmentGenerator = segmentGenerator;
        this.localCache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(Duration.ofMinutes(30))
            .build(this::loadSequence);
    }
    
    public Long nextId(String businessType) {
        try {
            AtomicLong counter = localCache.get(businessType);
            return counter.incrementAndGet();
        } catch (Exception e) {
            // ç¼“å­˜å¤±è´¥ï¼Œé™çº§åˆ°ç›´æ¥ç”Ÿæˆ
            return segmentGenerator.nextId(businessType);
        }
    }
    
    private AtomicLong loadSequence(String businessType) {
        // ä»æ®µæ¨¡å¼ç”Ÿæˆå™¨è·å–èµ·å§‹å€¼
        Long startValue = segmentGenerator.nextId(businessType);
        return new AtomicLong(startValue);
    }
}
```

**ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class SequenceMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Timer generateTimer;
    private final Counter conflictCounter;
    
    public SequenceMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.generateTimer = Timer.builder("sequence.generate.time")
            .description("åºåˆ—å·ç”Ÿæˆè€—æ—¶")
            .register(meterRegistry);
        this.conflictCounter = Counter.builder("sequence.conflict.count")
            .description("åºåˆ—å·å†²çªæ¬¡æ•°")
            .register(meterRegistry);
    }
    
    public Long timedGenerate(String businessType, Supplier<Long> generator) {
        return generateTimer.recordCallable(() -> {
            Long id = generator.get();
            
            // è®°å½•ç”ŸæˆQPS
            meterRegistry.counter("sequence.generate.qps", 
                               "business_type", businessType)
                         .increment();
            
            return id;
        });
    }
    
    public void recordConflict(String businessType) {
        conflictCounter.increment(Tags.of("business_type", businessType));
    }
}
```

---

## 7. ğŸ›¡ï¸ é«˜å¯ç”¨ä¸å®¹é”™æœºåˆ¶


### 7.1 å¤šæ•°æ®ä¸­å¿ƒå®¹ç¾


**ğŸ”¸ è·¨æœºæˆ¿éƒ¨ç½²æ–¹æ¡ˆ**
```java
@Configuration
public class MultiDataCenterConfig {
    
    @Bean
    @Primary
    public SequenceGenerator primarySequenceGenerator() {
        // ä¸»æœºæˆ¿é›ªèŠ±ç®—æ³•é…ç½®
        return new SnowflakeIdGenerator(getDataCenterId() * 32 + getMachineId());
    }
    
    @Bean
    public SequenceGenerator backupSequenceGenerator() {
        // å¤‡ä»½æœºæˆ¿ä½¿ç”¨ä¸åŒçš„æœºå™¨IDèŒƒå›´
        return new SnowflakeIdGenerator(512 + getDataCenterId() * 32 + getMachineId());
    }
    
    private int getDataCenterId() {
        // ä»é…ç½®ä¸­è·å–æ•°æ®ä¸­å¿ƒID
        return Integer.parseInt(System.getProperty("datacenter.id", "0"));
    }
    
    private int getMachineId() {
        // ä»MACåœ°å€æˆ–é…ç½®è·å–æœºå™¨ID
        return MachineIdProvider.getMachineId();
    }
}
```

**ğŸ”„ æ•…éšœåˆ‡æ¢æœºåˆ¶**
```java
@Component
public class FailoverSequenceGenerator {
    
    private final List<SequenceGenerator> generators;
    private volatile int currentIndex = 0;
    private final CircuitBreaker circuitBreaker;
    
    public FailoverSequenceGenerator(List<SequenceGenerator> generators) {
        this.generators = generators;
        this.circuitBreaker = CircuitBreaker.ofDefaults("sequence-generator");
    }
    
    public Long nextId(String businessType) {
        return circuitBreaker.executeSupplier(() -> {
            int attempts = 0;
            int maxAttempts = generators.size();
            
            while (attempts < maxAttempts) {
                try {
                    SequenceGenerator generator = getCurrentGenerator();
                    return generator.nextId(businessType);
                } catch (Exception e) {
                    logger.warn("åºåˆ—å·ç”Ÿæˆå™¨æ•…éšœï¼Œå°è¯•åˆ‡æ¢: {}", e.getMessage());
                    switchToNext();
                    attempts++;
                }
            }
            
            throw new RuntimeException("æ‰€æœ‰åºåˆ—å·ç”Ÿæˆå™¨å‡ä¸å¯ç”¨");
        });
    }
    
    private SequenceGenerator getCurrentGenerator() {
        return generators.get(currentIndex);
    }
    
    private synchronized void switchToNext() {
        currentIndex = (currentIndex + 1) % generators.size();
        logger.info("åˆ‡æ¢åˆ°åºåˆ—å·ç”Ÿæˆå™¨: {}", currentIndex);
    }
}
```

### 7.2 åºåˆ—å·æ¢å¤ä¸é‡å»º


**ğŸ”§ æ•…éšœæ¢å¤ç­–ç•¥**
```java
@Component
public class SequenceRecoveryService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ä»æ•°æ®åº“æ¢å¤åºåˆ—å·çŠ¶æ€
    public void recoverFromDatabase(String businessType) {
        logger.info("å¼€å§‹æ¢å¤åºåˆ—å·çŠ¶æ€: {}", businessType);
        
        try {
            // æŸ¥è¯¢å½“å‰æœ€å¤§åºåˆ—å·
            String sql = """
                SELECT COALESCE(MAX(id), 0) as max_id 
                FROM business_table 
                WHERE business_type = ?
                """;
            
            Long maxId = jdbcTemplate.queryForObject(sql, Long.class, businessType);
            
            // æ›´æ–°åºåˆ—å·ç”Ÿæˆå™¨çš„èµ·å§‹å€¼
            String updateSql = """
                UPDATE id_segment 
                SET max_id = GREATEST(max_id, ?),
                    update_time = CURRENT_TIMESTAMP
                WHERE business_type = ?
                """;
            
            jdbcTemplate.update(updateSql, maxId + 1000, businessType);
            
            // æ¸…ç†Redisç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½
            String cacheKey = "sequence:" + businessType;
            redisTemplate.delete(cacheKey);
            
            logger.info("åºåˆ—å·æ¢å¤å®Œæˆ: {} -> {}", businessType, maxId);
            
        } catch (Exception e) {
            logger.error("åºåˆ—å·æ¢å¤å¤±è´¥: {}", businessType, e);
            throw new RuntimeException("åºåˆ—å·æ¢å¤å¤±è´¥", e);
        }
    }
    
    // å¤‡ä»½åºåˆ—å·çŠ¶æ€
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œ
    public void backupSequenceState() {
        try {
            String sql = """
                INSERT INTO sequence_backup (business_type, current_value, backup_time)
                SELECT business_type, max_id, CURRENT_TIMESTAMP
                FROM id_segment
                ON DUPLICATE KEY UPDATE
                current_value = VALUES(current_value),
                backup_time = VALUES(backup_time)
                """;
            
            int count = jdbcTemplate.update(sql);
            logger.debug("å¤‡ä»½åºåˆ—å·çŠ¶æ€å®Œæˆï¼Œå½±å“è¡Œæ•°: {}", count);
        } catch (Exception e) {
            logger.error("å¤‡ä»½åºåˆ—å·çŠ¶æ€å¤±è´¥", e);
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼åºåˆ—å·ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç”Ÿæˆå…¨å±€å”¯ä¸€æ ‡è¯†ç¬¦çš„æŠ€æœ¯
ğŸ”¸ é›ªèŠ±ç®—æ³•ï¼šåŸºäºæ—¶é—´æˆ³+æœºå™¨ID+åºåˆ—å·çš„64ä½IDç”Ÿæˆç®—æ³•
ğŸ”¸ å·æ®µæ¨¡å¼ï¼šæ‰¹é‡ç”³è¯·IDæ®µï¼Œåœ¨æœ¬åœ°å†…å­˜ä¸­åˆ†é…ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
ğŸ”¸ åºåˆ—å·å®‰å…¨ï¼šé˜²æ­¢åºåˆ—å·è¢«çŒœæµ‹ï¼Œä¿æŠ¤ä¸šåŠ¡ä¿¡æ¯ä¸æ³„éœ²
ğŸ”¸ é«˜å¯ç”¨è®¾è®¡ï¼šå¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
```

### 8.2 å…³é”®æŠ€æœ¯é€‰æ‹©


**ğŸ”¹ ç®—æ³•é€‰æ‹©æ ‡å‡†**
```
é›ªèŠ±ç®—æ³•ï¼š
âœ… é«˜æ€§èƒ½åœºæ™¯ï¼ˆQPS > 10ä¸‡ï¼‰
âœ… å¯¹æœ‰åºæ€§æœ‰ä¸€å®šè¦æ±‚
âœ… å¯ä»¥æ¥å—ä¾èµ–ç³»ç»Ÿæ—¶é—´

æ•°æ®åº“åºåˆ—å·ï¼š
âœ… å¼ºä¸€è‡´æ€§è¦æ±‚
âœ… å¹¶å‘é‡ä¸­ç­‰ï¼ˆQPS < 1ä¸‡ï¼‰
âœ… éœ€è¦è¿ç»­æ— é—´éš”çš„åºåˆ—å·

å·æ®µæ¨¡å¼ï¼š
âœ… é«˜å¹¶å‘åœºæ™¯
âœ… å¯ä»¥æ¥å—å°‘é‡åºåˆ—å·æµªè´¹
âœ… éœ€è¦æ•°æ®åº“æ”¯æŒ

Redisè®¡æ•°å™¨ï¼š
âœ… éœ€è¦æŒ‰æ—¶é—´é‡ç½®çš„åœºæ™¯
âœ… å¯ä»¥æ¥å—Redisæ•…éšœæ—¶çš„æœåŠ¡ä¸­æ–­
âœ… å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ æœ¬åœ°ç¼“å­˜ + é¢„åˆ†é…å‡å°‘ç½‘ç»œå¼€é”€
â€¢ æ‰¹é‡è·å–åºåˆ—å·æé«˜ååé‡
â€¢ å¼‚æ­¥é¢„åŠ è½½é¿å…é˜»å¡ç­‰å¾…

å®‰å…¨ä¿éšœï¼š
â€¢ åºåˆ—å·åŠ å¯†é˜²æ­¢ä¿¡æ¯æ³„éœ²
â€¢ å†²çªæ£€æµ‹æœºåˆ¶åŠæ—¶å‘ç°é—®é¢˜
â€¢ è®¿é—®æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥

å®¹ç¾è®¾è®¡ï¼š
â€¢ å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²é¿å…å•ç‚¹æ•…éšœ
â€¢ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ä¿è¯æœåŠ¡è¿ç»­æ€§
â€¢ å®šæœŸå¤‡ä»½å’Œæ¢å¤éªŒè¯
```

### 8.4 ç›‘æ§ä¸è¿ç»´è¦ç‚¹


```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
ğŸ“Š åºåˆ—å·ç”ŸæˆQPSå’Œå»¶è¿Ÿ
ğŸ“Š åºåˆ—å·å†²çªç‡å’Œé”™è¯¯ç‡
ğŸ“Š å„ä¸ªç”Ÿæˆå™¨çš„å¯ç”¨æ€§çŠ¶æ€
ğŸ“Š æ•°æ®åº“å’ŒRedisçš„è¿æ¥çŠ¶æ€

å‘Šè­¦ç­–ç•¥ï¼š
âš ï¸ åºåˆ—å·ç”Ÿæˆå»¶è¿Ÿè¶…è¿‡é˜ˆå€¼
âš ï¸ æ£€æµ‹åˆ°åºåˆ—å·å†²çª
âš ï¸ åºåˆ—å·ç”Ÿæˆå™¨æ•…éšœ
âš ï¸ å·æ®µå³å°†è€—å°½

è¿ç»´æ“ä½œï¼š
ğŸ”§ åºåˆ—å·çŠ¶æ€æ¢å¤å’Œé‡å»º
ğŸ”§ ç”Ÿæˆå™¨é…ç½®åŠ¨æ€è°ƒæ•´
ğŸ”§ æ•…éšœæ—¶çš„æ‰‹åŠ¨åˆ‡æ¢
ğŸ”§ æ€§èƒ½å‹æµ‹å’Œå®¹é‡è§„åˆ’
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼åºåˆ—å·ä¿è¯å…¨å±€å”¯ä¸€ï¼Œé€‰æ‹©æ–¹æ¡ˆéœ€è€ƒè™‘æ€§èƒ½ã€ä¸€è‡´æ€§å’Œå®‰å…¨æ€§
- é›ªèŠ±ç®—æ³•é€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼Œå·æ®µæ¨¡å¼å¹³è¡¡æ€§èƒ½å’Œæ•°æ®åº“å‹åŠ›
- å®‰å…¨æ€§å’Œé«˜å¯ç”¨æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡è¦æ±‚
- ç›‘æ§å‘Šè­¦å’Œæ•…éšœæ¢å¤æœºåˆ¶ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ