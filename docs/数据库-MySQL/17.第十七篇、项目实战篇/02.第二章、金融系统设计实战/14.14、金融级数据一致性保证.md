---
title: 14ã€é‡‘èçº§æ•°æ®ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [é‡‘èæ•°æ®ä¸€è‡´æ€§æ¦‚è¿°](#1-é‡‘èæ•°æ®ä¸€è‡´æ€§æ¦‚è¿°)
2. [ACIDäº‹åŠ¡ä¿è¯æœºåˆ¶](#2-ACIDäº‹åŠ¡ä¿è¯æœºåˆ¶)
3. [åˆ†å¸ƒå¼äº‹åŠ¡åè®®](#3-åˆ†å¸ƒå¼äº‹åŠ¡åè®®)
4. [åˆ†å¸ƒå¼å…±è¯†ç®—æ³•](#4-åˆ†å¸ƒå¼å…±è¯†ç®—æ³•)
5. [äº‹åŠ¡è¡¥å¿ä¸å¼‚å¸¸å¤„ç†](#5-äº‹åŠ¡è¡¥å¿ä¸å¼‚å¸¸å¤„ç†)
6. [æ•°æ®ä¸€è‡´æ€§ç›‘æ§ä¸ä¼˜åŒ–](#6-æ•°æ®ä¸€è‡´æ€§ç›‘æ§ä¸ä¼˜åŒ–)
7. [é‡‘èçº§å®¹é”™è®¾è®¡å®æˆ˜](#7-é‡‘èçº§å®¹é”™è®¾è®¡å®æˆ˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’° é‡‘èæ•°æ®ä¸€è‡´æ€§æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é‡‘èæ•°æ®ä¸€è‡´æ€§


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
é‡‘èæ•°æ®ä¸€è‡´æ€§ï¼šç¡®ä¿é‡‘èäº¤æ˜“åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¿æŒæ•°æ®çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
ç›®æ ‡ï¼šè´¦æˆ·ä½™é¢å‡†ç¡®ã€äº¤æ˜“è®°å½•å®Œæ•´ã€ç³»ç»ŸçŠ¶æ€ä¸€è‡´
åŸåˆ™ï¼šå®å¯ç³»ç»Ÿæš‚åœï¼Œä¹Ÿä¸èƒ½å‡ºç°æ•°æ®é”™è¯¯
```

**ğŸ’¡ ä¸ºä»€ä¹ˆé‡‘èç³»ç»Ÿå¯¹ä¸€è‡´æ€§è¦æ±‚å¦‚æ­¤ä¸¥æ ¼ï¼Ÿ**

æƒ³è±¡ä¸€ä¸ªç®€å•çš„è½¬è´¦åœºæ™¯ï¼š
```
å¼ ä¸‰è´¦æˆ·ï¼š1000å…ƒ â†’ è½¬ç»™æå››100å…ƒ â†’ å¼ ä¸‰å‰©ä½™900å…ƒ
æå››è´¦æˆ·ï¼š500å…ƒ  â†’ æ”¶åˆ°å¼ ä¸‰100å…ƒ â†’ æå››å˜æˆ600å…ƒ

å¦‚æœæ•°æ®ä¸ä¸€è‡´ä¼šæ€æ ·ï¼Ÿ
âŒ å¼ ä¸‰æ‰£äº†é’±ï¼Œæå››æ²¡æ”¶åˆ° â†’ é’±å‡­ç©ºæ¶ˆå¤±
âŒ å¼ ä¸‰æ²¡æ‰£é’±ï¼Œæå››æ”¶åˆ°äº† â†’ é“¶è¡ŒæŸå¤±
âŒ ç³»ç»Ÿæ˜¾ç¤ºè½¬è´¦æˆåŠŸï¼Œå®é™…å¤±è´¥ â†’ å®¢æˆ·çº çº·
```

### 1.2 å¼ºä¸€è‡´æ€§è¦æ±‚çš„ç‰¹ç‚¹


**ğŸ¯ é‡‘èç³»ç»Ÿçš„ä¸€è‡´æ€§çº§åˆ«**
```
å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰ï¼š
- æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶çœ‹åˆ°ç›¸åŒæ•°æ®
- ä¸€æ—¦æ›´æ–°å®Œæˆï¼Œæ‰€æœ‰è¯»å–éƒ½æ˜¯æœ€æ–°å€¼
- é€‚ç”¨ï¼šè´¦æˆ·ä½™é¢ã€äº¤æ˜“è®°å½•

æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰ï¼š
- æš‚æ—¶å…è®¸æ•°æ®ä¸ä¸€è‡´
- æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
- é€‚ç”¨ï¼šæ—¥å¿—è®°å½•ã€ç»Ÿè®¡æŠ¥è¡¨
```

### 1.3 æ•°æ®å®Œæ•´æ€§æ ¡éªŒæœºåˆ¶


**ğŸ“Š å¤šå±‚æ ¡éªŒä½“ç³»**
```
ä¸šåŠ¡å±‚æ ¡éªŒï¼š
â”œâ”€â”€ è´¦æˆ·ä½™é¢æ£€æŸ¥
â”œâ”€â”€ äº¤æ˜“é™é¢éªŒè¯
â”œâ”€â”€ ä¸šåŠ¡è§„åˆ™æ ¡éªŒ
â””â”€â”€ é‡å¤äº¤æ˜“æ£€æµ‹

æ•°æ®åº“å±‚æ ¡éªŒï¼š
â”œâ”€â”€ ä¸»é”®çº¦æŸ
â”œâ”€â”€ å¤–é”®çº¦æŸ
â”œâ”€â”€ æ£€æŸ¥çº¦æŸ
â””â”€â”€ è§¦å‘å™¨æ ¡éªŒ

ç³»ç»Ÿå±‚æ ¡éªŒï¼š
â”œâ”€â”€ æ•°æ®æ ¡éªŒå’Œ
â”œâ”€â”€ å¤‡ä»½ä¸€è‡´æ€§æ£€æŸ¥
â”œâ”€â”€ è·¨åº“æ•°æ®æ ¡éªŒ
â””â”€â”€ å®æ—¶ç›‘æ§å‘Šè­¦
```

---

## 2. ğŸ”’ ACIDäº‹åŠ¡ä¿è¯æœºåˆ¶


### 2.1 ACIDå››å¤§ç‰¹æ€§è¯¦è§£


**ğŸ”¸ åŸå­æ€§ï¼ˆAtomicityï¼‰**

åŸå­æ€§å°±åƒ"è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš"çš„åŸåˆ™ï¼š

```sql
-- è½¬è´¦äº‹åŠ¡ç¤ºä¾‹
START TRANSACTION;
    -- ä»å¼ ä¸‰è´¦æˆ·æ‰£æ¬¾
    UPDATE accounts SET balance = balance - 100 
    WHERE account_id = 'zhang_san';
    
    -- ç»™æå››è´¦æˆ·åŠ é’±
    UPDATE accounts SET balance = balance + 100 
    WHERE account_id = 'li_si';
    
    -- è®°å½•äº¤æ˜“æµæ°´
    INSERT INTO transactions (from_account, to_account, amount) 
    VALUES ('zhang_san', 'li_si', 100);
COMMIT;

-- å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»š
-- ä¿è¯è¦ä¹ˆä¸‰æ­¥å…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€
```

**ğŸ”¸ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**

ä¸€è‡´æ€§ç¡®ä¿æ•°æ®åº“å§‹ç»ˆå¤„äºæœ‰æ•ˆçŠ¶æ€ï¼š

```sql
-- è®¾ç½®çº¦æŸä¿è¯ä¸€è‡´æ€§
ALTER TABLE accounts 
ADD CONSTRAINT check_balance 
CHECK (balance >= 0);  -- ä½™é¢ä¸èƒ½ä¸ºè´Ÿ

-- è§¦å‘å™¨ä¿è¯ä¸šåŠ¡ä¸€è‡´æ€§
CREATE TRIGGER check_daily_limit
BEFORE UPDATE ON accounts
FOR EACH ROW
BEGIN
    DECLARE daily_total DECIMAL(10,2);
    SELECT SUM(amount) INTO daily_total 
    FROM transactions 
    WHERE from_account = NEW.account_id 
    AND DATE(created_at) = CURDATE();
    
    IF daily_total > 50000 THEN
        SIGNAL SQLSTATE '45000' 
        SET MESSAGE_TEXT = 'è¶…è¿‡æ—¥é™é¢';
    END IF;
END;
```

**ğŸ”¸ éš”ç¦»æ€§ï¼ˆIsolationï¼‰**

éš”ç¦»æ€§é˜²æ­¢å¹¶å‘äº‹åŠ¡ç›¸äº’å¹²æ‰°ï¼š

```
éš”ç¦»çº§åˆ«å¯¹æ¯”ï¼š

è¯»æœªæäº¤ï¼ˆREAD UNCOMMITTEDï¼‰ï¼š
é—®é¢˜ï¼šè„è¯» - è¯»åˆ°åˆ«äººæœªæäº¤çš„æ•°æ®
åœºæ™¯ï¼šå¼ ä¸‰è½¬è´¦ä¸­ï¼Œæå››çœ‹åˆ°ä¸´æ—¶ä½™é¢

è¯»å·²æäº¤ï¼ˆREAD COMMITTEDï¼‰ï¼š
é—®é¢˜ï¼šä¸å¯é‡å¤è¯» - åŒä¸€äº‹åŠ¡ä¸¤æ¬¡è¯»å–ç»“æœä¸åŒ
åœºæ™¯ï¼šæŸ¥è¯¢ä½™é¢æ—¶ï¼Œåˆ«äººæ­£åœ¨è½¬è´¦

å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ï¼š
é—®é¢˜ï¼šå¹»è¯» - èŒƒå›´æŸ¥è¯¢æ—¶å‡ºç°æ–°è®°å½•
åœºæ™¯ï¼šç»Ÿè®¡è´¦æˆ·æ•°é‡æ—¶ï¼Œæœ‰äººå¼€æ–°æˆ·

ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰ï¼š
ä¼˜ç‚¹ï¼šå®Œå…¨éš”ç¦»ï¼Œæ— å¹¶å‘é—®é¢˜
ç¼ºç‚¹ï¼šæ€§èƒ½æœ€å·®ï¼Œé€‚åˆå…³é”®äº¤æ˜“
```

**ğŸ”¸ æŒä¹…æ€§ï¼ˆDurabilityï¼‰**

æŒä¹…æ€§ç¡®ä¿æäº¤çš„æ•°æ®æ°¸ä¹…ä¿å­˜ï¼š

```sql
-- MySQLé…ç½®æŒä¹…æ€§ä¿è¯
SET innodb_flush_log_at_trx_commit = 1;  -- æ¯æ¬¡æäº¤éƒ½å†™ç£ç›˜
SET sync_binlog = 1;                     -- äºŒè¿›åˆ¶æ—¥å¿—åŒæ­¥å†™å…¥

-- äº‹åŠ¡æäº¤æµç¨‹
1. å†™å…¥é‡åšæ—¥å¿—ï¼ˆRedo Logï¼‰
2. å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinlogï¼‰
3. æäº¤æ ‡è®°å†™å…¥ç£ç›˜
4. è¿”å›å®¢æˆ·ç«¯æˆåŠŸç¡®è®¤
```

### 2.2 äº‹åŠ¡éš”ç¦»çº§åˆ«é€‰æ‹©


**ğŸ“‹ é‡‘èç³»ç»Ÿéš”ç¦»çº§åˆ«é€‰æ‹©æŒ‡å¯¼**

| ä¸šåŠ¡åœºæ™¯ | æ¨èéš”ç¦»çº§åˆ« | åŸå› è¯´æ˜ |
|---------|-------------|---------|
| **èµ„é‡‘è½¬è´¦** | `SERIALIZABLE` | ç»å¯¹ä¸èƒ½å‡ºé”™ï¼Œæ€§èƒ½å…¶æ¬¡ |
| **ä½™é¢æŸ¥è¯¢** | `REPEATABLE READ` | ä¿è¯æŸ¥è¯¢æœŸé—´æ•°æ®ä¸å˜ |
| **äº¤æ˜“æµæ°´** | `READ COMMITTED` | å¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½ |
| **æŠ¥è¡¨ç»Ÿè®¡** | `READ UNCOMMITTED` | å…è®¸è¯»åˆ°æœ€æ–°æ•°æ® |

```sql
-- å…³é”®äº¤æ˜“ä½¿ç”¨æœ€é«˜éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
    -- æ‰§è¡Œè½¬è´¦æ“ä½œ
COMMIT;

-- æŸ¥è¯¢æ“ä½œä½¿ç”¨é€‚ä¸­éš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT balance FROM accounts WHERE account_id = 'user001';
```

---

## 3. ğŸŒ åˆ†å¸ƒå¼äº‹åŠ¡åè®®


### 3.1 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰åè®®


**ğŸ”¸ 2PCå·¥ä½œåŸç†**

ä¸¤é˜¶æ®µæäº¤å°±åƒ"ç»Ÿä¸€è¡ŒåŠ¨"çš„åè°ƒæœºåˆ¶ï¼š

```
é˜¶æ®µä¸€ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepare Phaseï¼‰
åè°ƒè€…                     å‚ä¸è€…A              å‚ä¸è€…B
    |                         |                    |
    |--[å‡†å¤‡æäº¤è¯·æ±‚]--------->|                    |
    |                         |                    |
    |                         |--[å‡†å¤‡å®Œæˆ]------->|
    |<--[åŒæ„æäº¤]-------------|                    |
    |                         |                    |
    |--[å‡†å¤‡æäº¤è¯·æ±‚]------------------------->|
    |                         |                    |
    |<--[åŒæ„æäº¤]------------------------------|
    
é˜¶æ®µäºŒï¼šæäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰
    |                         |                    |
    |--[æ­£å¼æäº¤]------------>|                    |
    |--[æ­£å¼æäº¤]------------------------->|
    |                         |                    |
    |<--[æäº¤å®Œæˆ]-------------|                    |
    |<--[æäº¤å®Œæˆ]------------------------------|
```

**ğŸ’» 2PCå®ç°ç¤ºä¾‹**

```java
public class TwoPhaseCommit {
    
    // åè°ƒè€…ï¼šé“¶è¡Œæ ¸å¿ƒç³»ç»Ÿ
    public boolean transferMoney(String fromBank, String toBank, 
                               BigDecimal amount) {
        List<Participant> participants = Arrays.asList(
            new BankParticipant(fromBank),
            new BankParticipant(toBank)
        );
        
        // é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
        for (Participant p : participants) {
            if (!p.prepare()) {
                // ä»»ä½•ä¸€ä¸ªå‡†å¤‡å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
                abortAll(participants);
                return false;
            }
        }
        
        // é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ
        for (Participant p : participants) {
            p.commit();
        }
        return true;
    }
}

// å‚ä¸è€…ï¼šå…·ä½“é“¶è¡Œç³»ç»Ÿ
class BankParticipant implements Participant {
    public boolean prepare() {
        try {
            // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
            if (checkBalance() && lockAccount()) {
                writeLog("PREPARED");
                return true;
            }
        } catch (Exception e) {
            return false;
        }
        return false;
    }
    
    public void commit() {
        // å®é™…æ‰§è¡Œè½¬è´¦
        updateBalance();
        writeLog("COMMITTED");
        unlockAccount();
    }
}
```

**âš ï¸ 2PCçš„é—®é¢˜ä¸è§£å†³**

```
ä¸»è¦é—®é¢˜ï¼š

1. é˜»å¡é—®é¢˜ï¼š
   é—®é¢˜ï¼šå‚ä¸è€…åœ¨å‡†å¤‡é˜¶æ®µåå¿…é¡»ç­‰å¾…åè°ƒè€…å†³å®š
   å½±å“ï¼šç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œèµ„æºé•¿æ—¶é—´å ç”¨
   
2. å•ç‚¹æ•…éšœï¼š
   é—®é¢˜ï¼šåè°ƒè€…å´©æºƒå¯¼è‡´å‚ä¸è€…æ— æ³•å†³å®š
   è§£å†³ï¼šå¤‡ä»½åè°ƒè€…ï¼Œæ•…éšœè½¬ç§»æœºåˆ¶

3. æ•°æ®ä¸ä¸€è‡´ï¼š
   é—®é¢˜ï¼šç¬¬äºŒé˜¶æ®µåè°ƒè€…å´©æºƒï¼Œéƒ¨åˆ†æäº¤éƒ¨åˆ†å›æ»š
   è§£å†³ï¼šå‚ä¸è€…è¶…æ—¶æœºåˆ¶ï¼Œè‡ªåŠ¨å†³ç­–
```

### 3.2 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰åè®®


**ğŸ”¸ 3PCæ”¹è¿›æœºåˆ¶**

ä¸‰é˜¶æ®µæäº¤è§£å†³äº†2PCçš„é˜»å¡é—®é¢˜ï¼š

```
é˜¶æ®µä¸€ï¼šCanCommité˜¶æ®µ
åè°ƒè€…è¯¢é—®ï¼š"ä½ ä»¬èƒ½æ‰§è¡Œè¿™ä¸ªäº‹åŠ¡å—ï¼Ÿ"
å‚ä¸è€…å›ç­”ï¼š"å¯ä»¥"æˆ–"ä¸å¯ä»¥"

é˜¶æ®µäºŒï¼šPreCommité˜¶æ®µ  
åè°ƒè€…å‘å‡ºï¼š"å‡†å¤‡æäº¤"
å‚ä¸è€…æ‰§è¡Œå‡†å¤‡æ“ä½œï¼Œå†™æ—¥å¿—

é˜¶æ®µä¸‰ï¼šDoCommité˜¶æ®µ
åè°ƒè€…å‘å‡ºï¼š"æ­£å¼æäº¤"
å‚ä¸è€…æ‰§è¡Œå®é™…æäº¤æ“ä½œ
```

**ğŸ’¡ 3PCçš„è¶…æ—¶æœºåˆ¶**

```java
public class ThreePhaseCommit {
    private static final int TIMEOUT = 30000; // 30ç§’è¶…æ—¶
    
    public boolean doCommit() {
        // é˜¶æ®µ1ï¼šè¯¢é—®é˜¶æ®µ
        if (!canCommitPhase()) return false;
        
        // é˜¶æ®µ2ï¼šé¢„æäº¤é˜¶æ®µ
        if (!preCommitPhase()) {
            abort();
            return false;
        }
        
        // é˜¶æ®µ3ï¼šæ­£å¼æäº¤é˜¶æ®µ
        return doCommitPhase();
    }
    
    private boolean preCommitPhase() {
        for (Participant p : participants) {
            try {
                // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
                boolean result = p.preCommit(TIMEOUT);
                if (!result) return false;
            } catch (TimeoutException e) {
                // è¶…æ—¶è‡ªåŠ¨å›æ»š
                return false;
            }
        }
        return true;
    }
}
```

### 3.3 åˆ†å¸ƒå¼äº‹åŠ¡æœ€ä½³å®è·µ


**ğŸ¯ é‡‘èç³»ç»Ÿåˆ†å¸ƒå¼äº‹åŠ¡é€‰æ‹©**

```
åœºæ™¯é€‰æ‹©æŒ‡å¯¼ï¼š

å®æ—¶è½¬è´¦ç³»ç»Ÿï¼š
- é€‰æ‹©ï¼š2PC + å¼ºä¸€è‡´æ€§
- åŸå› ï¼šç»å¯¹ä¸èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´
- ä»£ä»·ï¼šæ€§èƒ½è¾ƒä½ï¼Œä½†æ•°æ®å®‰å…¨

è·¨è¡Œæ¸…ç®—ç³»ç»Ÿï¼š
- é€‰æ‹©ï¼š3PC + è¡¥å¿æœºåˆ¶
- åŸå› ï¼šå‡å°‘é˜»å¡ï¼Œæé«˜å¯ç”¨æ€§
- ä»£ä»·ï¼šå¤æ‚åº¦å¢åŠ 

æ‰¹é‡å¤„ç†ç³»ç»Ÿï¼š
- é€‰æ‹©ï¼šæœ€ç»ˆä¸€è‡´æ€§ + å¼‚æ­¥è¡¥å¿
- åŸå› ï¼šé«˜ååé‡ï¼Œå…è®¸çŸ­æš‚ä¸ä¸€è‡´
- ä»£ä»·ï¼šéœ€è¦å®Œå–„çš„è¡¥å¿æœºåˆ¶
```

---

## 4. âš–ï¸ åˆ†å¸ƒå¼å…±è¯†ç®—æ³•


### 4.1 Raftå…±è¯†ç®—æ³•


**ğŸ”¸ Raftç®—æ³•åŸºæœ¬åŸç†**

Raftç®—æ³•å°±åƒ"æ°‘ä¸»é€‰ä¸¾+ç»Ÿä¸€æŒ‡æŒ¥"çš„æœºåˆ¶ï¼š

```
è§’è‰²åˆ’åˆ†ï¼š
Leaderï¼ˆé¢†å¯¼è€…ï¼‰ï¼š
- å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
- å‘å…¶ä»–èŠ‚ç‚¹å¤åˆ¶æ—¥å¿—
- å‘é€å¿ƒè·³ç»´æŒæƒå¨

Followerï¼ˆè·Ÿéšè€…ï¼‰ï¼š
- è¢«åŠ¨æ¥æ”¶Leaderçš„æ—¥å¿—
- å‚ä¸Leaderé€‰ä¸¾æŠ•ç¥¨
- å“åº”å®¢æˆ·ç«¯æŸ¥è¯¢è¯·æ±‚

Candidateï¼ˆå€™é€‰äººï¼‰ï¼š
- ç«é€‰Leaderçš„èŠ‚ç‚¹
- å‘å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚
- è·å¾—å¤šæ•°ç¥¨æˆä¸ºLeader
```

**ğŸ“Š Rafté€‰ä¸¾è¿‡ç¨‹**

```
æ­£å¸¸æƒ…å†µï¼š
èŠ‚ç‚¹A(Leader)  èŠ‚ç‚¹B(Follower)  èŠ‚ç‚¹C(Follower)
    |               |               |
    |--[å¿ƒè·³]------->|               |
    |--[å¿ƒè·³]--------------------->|
    |               |               |

Leaderæ•…éšœæ—¶ï¼š
èŠ‚ç‚¹A(Down)    èŠ‚ç‚¹B(Candidate)  èŠ‚ç‚¹C(Follower)
    |               |               |
    X               |--[è¯·æ±‚æŠ•ç¥¨]--->|
                    |<--[åŒæ„]-------|
                    |               |
                èŠ‚ç‚¹Bæˆä¸ºæ–°Leader
```

**ğŸ’» Raftå®ç°æ ¸å¿ƒä»£ç **

```java
public class RaftNode {
    private NodeState state = NodeState.FOLLOWER;
    private int currentTerm = 0;
    private String votedFor = null;
    private long lastHeartbeat = System.currentTimeMillis();
    
    // å¿ƒè·³è¶…æ—¶æ£€æµ‹
    public void checkHeartbeatTimeout() {
        long now = System.currentTimeMillis();
        if (now - lastHeartbeat > HEARTBEAT_TIMEOUT) {
            // å¼€å§‹é€‰ä¸¾
            startElection();
        }
    }
    
    private void startElection() {
        state = NodeState.CANDIDATE;
        currentTerm++;
        votedFor = nodeId;
        
        int votes = 1; // æŠ•ç»™è‡ªå·±
        for (String peer : peers) {
            if (requestVote(peer)) {
                votes++;
            }
        }
        
        // è·å¾—å¤šæ•°ç¥¨æˆä¸ºLeader
        if (votes > peers.size() / 2) {
            state = NodeState.LEADER;
            sendHeartbeats();
        }
    }
    
    // æ—¥å¿—å¤åˆ¶
    public boolean appendEntries(LogEntry entry) {
        if (state != NodeState.LEADER) {
            return false;
        }
        
        // å…ˆå†™å…¥æœ¬åœ°æ—¥å¿—
        log.append(entry);
        
        // å¤åˆ¶åˆ°å¤šæ•°èŠ‚ç‚¹
        int replicas = 1;
        for (String peer : peers) {
            if (replicateEntry(peer, entry)) {
                replicas++;
            }
        }
        
        // å¤šæ•°èŠ‚ç‚¹ç¡®è®¤åæäº¤
        if (replicas > peers.size() / 2) {
            entry.commit();
            return true;
        }
        return false;
    }
}
```

### 4.2 æ‹œå åº­å®¹é”™ï¼ˆBFTï¼‰ç®—æ³•


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ‹œå åº­å®¹é”™ï¼Ÿ**

æ‹œå åº­å®¹é”™å°±åƒ"é˜²æ­¢å†…å¥¸"çš„æœºåˆ¶ï¼š

```
æ‹œå åº­é—®é¢˜åœºæ™¯ï¼š
- å°†å†›ä»¬è¦åè°ƒæ”»åŸæ—¶é—´
- æœ‰äº›å°†å†›å¯èƒ½æ˜¯å›å¾’ï¼ˆæ¶æ„èŠ‚ç‚¹ï¼‰
- å›å¾’ä¼šå‘é€é”™è¯¯ä¿¡æ¯è¯¯å¯¼ä»–äºº
- ç›®æ ‡ï¼šè¯šå®çš„å°†å†›è¾¾æˆä¸€è‡´å†³å®š

é‡‘èç³»ç»Ÿå¯¹åº”ï¼š
- å¤šä¸ªé“¶è¡Œç³»ç»Ÿåè°ƒäº¤æ˜“
- æŸäº›ç³»ç»Ÿå¯èƒ½æ•…éšœæˆ–è¢«æ”»å‡»
- æ¶æ„ç³»ç»Ÿå‘é€é”™è¯¯æ•°æ®
- ç›®æ ‡ï¼šè¯šå®ç³»ç»Ÿè¾¾æˆæ­£ç¡®äº¤æ˜“ç»“æœ
```

**ğŸ’¡ PBFTï¼ˆå®ç”¨æ‹œå åº­å®¹é”™ï¼‰ç®—æ³•**

```
ä¸‰é˜¶æ®µå…±è¯†ï¼š
1. Pre-prepareï¼šä¸»èŠ‚ç‚¹æè®®
2. Prepareï¼šèŠ‚ç‚¹é—´ç›¸äº’ç¡®è®¤
3. Commitï¼šæœ€ç»ˆæäº¤å†³å®š

å®¹é”™èƒ½åŠ›ï¼š
- ç½‘ç»œä¸­æœ€å¤šå®¹å¿ f ä¸ªæ‹œå åº­èŠ‚ç‚¹
- éœ€è¦è‡³å°‘ 3f+1 ä¸ªèŠ‚ç‚¹æ‰èƒ½æ­£å¸¸å·¥ä½œ
- ä¾‹ï¼šå®¹å¿1ä¸ªæ¶æ„èŠ‚ç‚¹ï¼Œéœ€è¦4ä¸ªèŠ‚ç‚¹
```

```java
public class PBFTNode {
    private int f; // æœ€å¤§æ•…éšœèŠ‚ç‚¹æ•°
    private int nodeCount = 3 * f + 1;
    
    public boolean processRequest(Request request) {
        // é˜¶æ®µ1ï¼šPre-prepare
        if (isPrimary()) {
            broadcastPrePrepare(request);
        }
        
        // é˜¶æ®µ2ï¼šPrepare
        int prepareCount = 0;
        for (PrepareMessage msg : receivePrepares()) {
            if (validatePrepare(msg)) {
                prepareCount++;
            }
        }
        
        // éœ€è¦2fä¸ªprepareæ¶ˆæ¯æ‰èƒ½è¿›å…¥commité˜¶æ®µ
        if (prepareCount >= 2 * f) {
            broadcastCommit(request);
            
            // é˜¶æ®µ3ï¼šCommit
            int commitCount = 0;
            for (CommitMessage msg : receiveCommits()) {
                if (validateCommit(msg)) {
                    commitCount++;
                }
            }
            
            // éœ€è¦2fä¸ªcommitæ¶ˆæ¯æ‰èƒ½æ‰§è¡Œ
            if (commitCount >= 2 * f) {
                executeRequest(request);
                return true;
            }
        }
        return false;
    }
}
```

### 4.3 å…±è¯†ç®—æ³•é€‰æ‹©æŒ‡å¯¼


**ğŸ“‹ ä¸åŒåœºæ™¯çš„ç®—æ³•é€‰æ‹©**

| åº”ç”¨åœºæ™¯ | æ¨èç®—æ³• | ä¼˜åŠ¿ | é€‚ç”¨æƒ…å†µ |
|---------|---------|------|---------|
| **é“¶è¡Œå†…éƒ¨ç³»ç»Ÿ** | `Raft` | æ€§èƒ½é«˜ï¼Œå®ç°ç®€å• | ä¿¡ä»»ç¯å¢ƒï¼Œæ•…éšœå®¹é”™ |
| **è·¨è¡Œè”ç›Ÿé“¾** | `PBFT` | æ‹œå åº­å®¹é”™ï¼Œå®‰å…¨æ€§é«˜ | ä¸å®Œå…¨ä¿¡ä»»ç¯å¢ƒ |
| **é«˜é¢‘äº¤æ˜“** | `Fast-BFT` | ä½å»¶è¿Ÿï¼Œé«˜åå | å¯¹æ€§èƒ½è¦æ±‚æé«˜ |
| **ç›‘ç®¡åˆè§„** | `PoA` | æƒå¨èŠ‚ç‚¹ï¼Œåˆè§„æ€§å¥½ | ç›‘ç®¡æœºæ„å‚ä¸ |

---

## 5. ğŸ”§ äº‹åŠ¡è¡¥å¿ä¸å¼‚å¸¸å¤„ç†


### 5.1 äº‹åŠ¡è¡¥å¿æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº‹åŠ¡è¡¥å¿ï¼Ÿ**

äº‹åŠ¡è¡¥å¿å°±åƒ"æ’¤é”€æ“ä½œ"çš„æœºåˆ¶ï¼š

```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·ä¸‹å• â†’ æ‰£å‡åº“å­˜ â†’ æ‰£æ¬¾ â†’ å‘è´§

å¼‚å¸¸æƒ…å†µï¼š
ç”¨æˆ·ä¸‹å• â†’ æ‰£å‡åº“å­˜ â†’ æ‰£æ¬¾å¤±è´¥ â†’ éœ€è¦æ¢å¤åº“å­˜

è¡¥å¿æœºåˆ¶ï¼š
ä¸ºæ¯ä¸ªæ“ä½œè®¾è®¡å¯¹åº”çš„æ’¤é”€æ“ä½œ
- æ‰£å‡åº“å­˜ â†” æ¢å¤åº“å­˜  
- æ‰£æ¬¾ â†” é€€æ¬¾
- å‘è´§ â†” å–æ¶ˆå‘è´§
```

**ğŸ’» Sagaäº‹åŠ¡æ¨¡å¼å®ç°**

```java
public class SagaTransaction {
    private List<TransactionStep> steps = new ArrayList<>();
    private List<CompensationStep> compensations = new ArrayList<>();
    
    public void addStep(TransactionStep step, CompensationStep compensation) {
        steps.add(step);
        compensations.add(0, compensation); // é€†åºå­˜å‚¨è¡¥å¿æ“ä½œ
    }
    
    public boolean execute() {
        int executedSteps = 0;
        
        try {
            // é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
            for (TransactionStep step : steps) {
                step.execute();
                executedSteps++;
            }
            return true;
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰§è¡Œè¡¥å¿
            compensate(executedSteps);
            return false;
        }
    }
    
    private void compensate(int executedSteps) {
        // é€†åºæ‰§è¡Œè¡¥å¿æ“ä½œ
        for (int i = 0; i < executedSteps; i++) {
            try {
                compensations.get(i).compensate();
            } catch (Exception e) {
                // è¡¥å¿å¤±è´¥éœ€è¦äººå·¥ä»‹å…¥
                logCompensationFailure(i, e);
            }
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šè½¬è´¦Sagaäº‹åŠ¡
public class TransferSaga {
    public boolean transfer(String from, String to, BigDecimal amount) {
        SagaTransaction saga = new SagaTransaction();
        
        // æ­¥éª¤1ï¼šæ‰£æ¬¾
        saga.addStep(
            () -> debitAccount(from, amount),
            () -> creditAccount(from, amount)  // è¡¥å¿ï¼šé€€æ¬¾
        );
        
        // æ­¥éª¤2ï¼šå…¥è´¦
        saga.addStep(
            () -> creditAccount(to, amount),
            () -> debitAccount(to, amount)     // è¡¥å¿ï¼šæ‰£æ¬¾
        );
        
        // æ­¥éª¤3ï¼šè®°å½•æµæ°´
        saga.addStep(
            () -> recordTransaction(from, to, amount),
            () -> deleteTransaction(from, to, amount) // è¡¥å¿ï¼šåˆ é™¤è®°å½•
        );
        
        return saga.execute();
    }
}
```

### 5.2 å¼‚å¸¸æ•°æ®æ¢å¤ç­–ç•¥


**ğŸ”¸ æ•°æ®å¼‚å¸¸åˆ†ç±»ä¸å¤„ç†**

```
æ•°æ®å¼‚å¸¸ç±»å‹ï¼š

1. æš‚æ—¶æ€§å¼‚å¸¸ï¼š
   - ç½‘ç»œè¶…æ—¶ã€æ•°æ®åº“è¿æ¥å¤±è´¥
   - å¤„ç†ï¼šé‡è¯•æœºåˆ¶ + æŒ‡æ•°é€€é¿
   
2. æ°¸ä¹…æ€§å¼‚å¸¸ï¼š
   - æ•°æ®æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡è§„åˆ™è¿å
   - å¤„ç†ï¼šå›æ»šäº‹åŠ¡ + å‘Šè­¦é€šçŸ¥
   
3. éƒ¨åˆ†æˆåŠŸå¼‚å¸¸ï¼š
   - åˆ†å¸ƒå¼äº‹åŠ¡éƒ¨åˆ†æäº¤
   - å¤„ç†ï¼šè¡¥å¿æ“ä½œ + æ•°æ®æ ¡å¯¹
```

**ğŸ’» å¼‚å¸¸æ¢å¤å®ç°**

```java
public class DataRecoveryManager {
    
    // é‡è¯•æœºåˆ¶
    @Retryable(maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public void processTransaction(Transaction tx) throws TransactionException {
        try {
            // æ‰§è¡Œäº‹åŠ¡
            executeTransaction(tx);
        } catch (TemporaryException e) {
            // ä¸´æ—¶å¼‚å¸¸ï¼Œä¼šè‡ªåŠ¨é‡è¯•
            throw e;
        } catch (PermanentException e) {
            // æ°¸ä¹…å¼‚å¸¸ï¼Œè®°å½•å¹¶å‘Šè­¦
            logError(tx, e);
            sendAlert(tx, e);
            throw e;
        }
    }
    
    // æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkDataConsistency() {
        List<Account> accounts = accountService.getAllAccounts();
        
        for (Account account : accounts) {
            // æ£€æŸ¥è´¦æˆ·ä½™é¢æ˜¯å¦ä¸äº¤æ˜“è®°å½•åŒ¹é…
            BigDecimal calculatedBalance = calculateBalanceFromTransactions(account.getId());
            BigDecimal actualBalance = account.getBalance();
            
            if (!calculatedBalance.equals(actualBalance)) {
                // å‘ç°æ•°æ®ä¸ä¸€è‡´
                DataInconsistency issue = new DataInconsistency(
                    account.getId(), actualBalance, calculatedBalance
                );
                
                // å°è¯•è‡ªåŠ¨ä¿®å¤
                if (autoFixEnabled) {
                    autoFixBalance(account, calculatedBalance);
                } else {
                    // äººå·¥å¤„ç†é˜Ÿåˆ—
                    addToManualQueue(issue);
                }
            }
        }
    }
    
    // è‡ªåŠ¨ä¿®å¤
    private void autoFixBalance(Account account, BigDecimal correctBalance) {
        try {
            // åˆ›å»ºè°ƒæ•´è®°å½•
            AdjustmentRecord adjustment = new AdjustmentRecord(
                account.getId(),
                account.getBalance(),
                correctBalance,
                "Auto fix data inconsistency"
            );
            
            // æ›´æ–°ä½™é¢
            account.setBalance(correctBalance);
            accountService.updateAccount(account);
            
            // è®°å½•è°ƒæ•´æ—¥å¿—
            adjustmentService.saveAdjustment(adjustment);
            
        } catch (Exception e) {
            // è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè½¬äººå·¥å¤„ç†
            addToManualQueue(new DataInconsistency(account.getId(), 
                account.getBalance(), correctBalance));
        }
    }
}
```

### 5.3 ä¸€è‡´æ€§å¼‚å¸¸å¤„ç†æµç¨‹


**ğŸ“Š å¼‚å¸¸å¤„ç†å†³ç­–æ ‘**

```
æ•°æ®å¼‚å¸¸æ£€æµ‹
        |
        â†“
   [å¼‚å¸¸ç±»å‹åˆ¤æ–­]
        |
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    |       |
æš‚æ—¶å¼‚å¸¸   æ°¸ä¹…å¼‚å¸¸
    |       |
    â†“       â†“
è‡ªåŠ¨é‡è¯•   ç«‹å³å›æ»š
    |       |
    â†“       â†“
 é‡è¯•æˆåŠŸ   è®°å½•æ—¥å¿—
    |       |
    â†“       â†“
  æ­£å¸¸ç»“æŸ  äººå·¥ä»‹å…¥
```

**âš ï¸ å…³é”®å¼‚å¸¸å¤„ç†åŸåˆ™**

```
é‡‘èç³»ç»Ÿå¼‚å¸¸å¤„ç†å‡†åˆ™ï¼š

1. å¿«é€Ÿå¤±è´¥åŸåˆ™ï¼š
   - å‘ç°å¼‚å¸¸ç«‹å³åœæ­¢å¤„ç†
   - é¿å…é”™è¯¯æ•°æ®è¿›ä¸€æ­¥æ‰©æ•£
   
2. æ•°æ®ä¼˜å…ˆåŸåˆ™ï¼š
   - å®å¯æœåŠ¡æš‚åœï¼Œä¸å¯æ•°æ®é”™è¯¯
   - å¯ç”¨æ€§æœä»ä¸€è‡´æ€§

3. å¯è¿½è¸ªåŸåˆ™ï¼š
   - æ‰€æœ‰å¼‚å¸¸éƒ½è¦è®°å½•è¯¦ç»†æ—¥å¿—
   - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œè´£ä»»è¿½æº¯
   
4. è¡¥å¿å®Œæ•´åŸåˆ™ï¼š
   - æ¯ä¸ªæ“ä½œéƒ½è¦æœ‰å¯¹åº”è¡¥å¿
   - è¡¥å¿æ“ä½œå¿…é¡»å¹‚ç­‰
```

---

## 6. ğŸ“Š æ•°æ®ä¸€è‡´æ€§ç›‘æ§ä¸ä¼˜åŒ–


### 6.1 å®æ—¶ç›‘æ§ä½“ç³»


**ğŸ”¸ ç›‘æ§æŒ‡æ ‡è®¾è®¡**

```
ä¸€è‡´æ€§ç›‘æ§æŒ‡æ ‡ï¼š

ä¸šåŠ¡å±‚æŒ‡æ ‡ï¼š
â”œâ”€â”€ è´¦æˆ·ä½™é¢ä¸€è‡´æ€§ç‡ (>99.99%)
â”œâ”€â”€ äº¤æ˜“æˆåŠŸç‡ (>99.95%)  
â”œâ”€â”€ æ•°æ®æ ¡éªŒé€šè¿‡ç‡ (100%)
â””â”€â”€ å¼‚å¸¸æ¢å¤æ—¶é—´ (<5åˆ†é’Ÿ)

ç³»ç»Ÿå±‚æŒ‡æ ‡ï¼š
â”œâ”€â”€ äº‹åŠ¡æäº¤å»¶è¿Ÿ (<100ms)
â”œâ”€â”€ åˆ†å¸ƒå¼äº‹åŠ¡æˆåŠŸç‡ (>99.9%)
â”œâ”€â”€ æ•°æ®åº“å¤åˆ¶å»¶è¿Ÿ (<10ms)
â””â”€â”€ ä¸€è‡´æ€§æ£€æŸ¥é¢‘ç‡ (æ¯åˆ†é’Ÿ)

å‘Šè­¦é˜ˆå€¼ï¼š
â”œâ”€â”€ æ•°æ®ä¸ä¸€è‡´ â†’ ç«‹å³å‘Šè­¦
â”œâ”€â”€ äº‹åŠ¡å»¶è¿Ÿ >1ç§’ â†’ è­¦å‘Š
â”œâ”€â”€ æˆåŠŸç‡ <99% â†’ ä¸¥é‡å‘Šè­¦
â””â”€â”€ ç³»ç»Ÿæ•…éšœ â†’ ç´§æ€¥å‘Šè­¦
```

**ğŸ’» ç›‘æ§ç³»ç»Ÿå®ç°**

```java
@Component
public class ConsistencyMonitor {
    
    private final MeterRegistry meterRegistry;
    private final AlertService alertService;
    
    // ç›‘æ§äº‹åŠ¡æ‰§è¡Œ
    public void monitorTransaction(TransactionContext ctx) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            // æ‰§è¡Œäº‹åŠ¡
            ctx.execute();
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            meterRegistry.counter("transaction.success").increment();
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            meterRegistry.counter("transaction.failure").increment();
            
            // è§¦å‘å‘Šè­¦
            if (isDataConsistencyError(e)) {
                alertService.sendUrgentAlert("æ•°æ®ä¸€è‡´æ€§å¼‚å¸¸", e);
            }
        } finally {
            // è®°å½•æ‰§è¡Œæ—¶é—´
            sample.stop(Timer.builder("transaction.duration").register(meterRegistry));
        }
    }
    
    // å®šæœŸä¸€è‡´æ€§æ£€æŸ¥
    @Scheduled(fixedRate = 60000)
    public void performConsistencyCheck() {
        long startTime = System.currentTimeMillis();
        
        try {
            ConsistencyReport report = runConsistencyCheck();
            
            // æ›´æ–°ç›‘æ§æŒ‡æ ‡
            meterRegistry.gauge("consistency.check.accounts", report.getTotalAccounts());
            meterRegistry.gauge("consistency.check.errors", report.getErrorCount());
            meterRegistry.gauge("consistency.check.success.rate", report.getSuccessRate());
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸
            if (report.getErrorCount() > 0) {
                alertService.sendAlert("å‘ç°æ•°æ®ä¸ä¸€è‡´", report);
            }
            
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            meterRegistry.gauge("consistency.check.duration", duration);
        }
    }
    
    private ConsistencyReport runConsistencyCheck() {
        ConsistencyReport report = new ConsistencyReport();
        List<Account> accounts = accountService.getAllAccounts();
        
        for (Account account : accounts) {
            // è®¡ç®—ç†è®ºä½™é¢
            BigDecimal theoretical = calculateTheoreticalBalance(account.getId());
            BigDecimal actual = account.getBalance();
            
            report.incrementTotal();
            
            if (!theoretical.equals(actual)) {
                // è®°å½•ä¸ä¸€è‡´æƒ…å†µ
                report.addError(new ConsistencyError(
                    account.getId(), actual, theoretical
                ));
            }
        }
        
        return report;
    }
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ä¸€è‡´æ€§ä¸æ€§èƒ½çš„å¹³è¡¡**

```
ä¼˜åŒ–ç­–ç•¥åˆ†å±‚ï¼š

æ•°æ®åº“å±‚ä¼˜åŒ–ï¼š
â”œâ”€â”€ è¯»å†™åˆ†ç¦»ï¼šè¯»æ“ä½œåˆ†æ•£åˆ°ä»åº“
â”œâ”€â”€ åˆ†åº“åˆ†è¡¨ï¼šå‡å°‘å•åº“å‹åŠ›
â”œâ”€â”€ ç´¢å¼•ä¼˜åŒ–ï¼šåŠ é€Ÿä¸€è‡´æ€§æ£€æŸ¥æŸ¥è¯¢
â””â”€â”€ è¿æ¥æ± è°ƒä¼˜ï¼šå‡å°‘è¿æ¥å¼€é”€

åº”ç”¨å±‚ä¼˜åŒ–ï¼š
â”œâ”€â”€ æ‰¹é‡å¤„ç†ï¼šåˆå¹¶å¤šä¸ªå°äº‹åŠ¡
â”œâ”€â”€ å¼‚æ­¥å¤„ç†ï¼šéå…³é”®æ“ä½œå¼‚æ­¥åŒ–
â”œâ”€â”€ ç¼“å­˜ç­–ç•¥ï¼šå‡å°‘æ•°æ®åº“è®¿é—®
â””â”€â”€ äº‹åŠ¡èŒƒå›´æœ€å°åŒ–ï¼šå‡å°‘é”å®šæ—¶é—´

æ¶æ„å±‚ä¼˜åŒ–ï¼š
â”œâ”€â”€ å¾®æœåŠ¡æ‹†åˆ†ï¼šå‡å°‘åˆ†å¸ƒå¼äº‹åŠ¡èŒƒå›´
â”œâ”€â”€ äº‹ä»¶é©±åŠ¨ï¼šæœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼
â”œâ”€â”€ CQRSæ¨¡å¼ï¼šè¯»å†™æ“ä½œåˆ†ç¦»
â””â”€â”€ æ•°æ®å‰¯æœ¬ï¼šå°±è¿‘è®¿é—®å‡å°‘å»¶è¿Ÿ
```

**ğŸ’» æ€§èƒ½ä¼˜åŒ–å®ç°**

```java
@Service
public class OptimizedTransactionService {
    
    // æ‰¹é‡äº‹åŠ¡å¤„ç†
    @Transactional
    public BatchResult processBatchTransactions(List<Transaction> transactions) {
        // æŒ‰è´¦æˆ·åˆ†ç»„ï¼Œå‡å°‘é”ç«äº‰
        Map<String, List<Transaction>> groupedTx = transactions.stream()
            .collect(Collectors.groupingBy(Transaction::getAccountId));
        
        BatchResult result = new BatchResult();
        
        for (Map.Entry<String, List<Transaction>> entry : groupedTx.entrySet()) {
            String accountId = entry.getKey();
            List<Transaction> accountTxs = entry.getValue();
            
            // é”å®šè´¦æˆ·ï¼Œæ‰¹é‡å¤„ç†
            Account account = accountService.lockAccount(accountId);
            try {
                for (Transaction tx : accountTxs) {
                    if (processTransaction(account, tx)) {
                        result.incrementSuccess();
                    } else {
                        result.incrementFailure();
                    }
                }
                // ä¸€æ¬¡æ€§æ›´æ–°è´¦æˆ·ä½™é¢
                accountService.updateAccount(account);
                
            } finally {
                accountService.unlockAccount(accountId);
            }
        }
        
        return result;
    }
    
    // å¼‚æ­¥ä¸€è‡´æ€§æ£€æŸ¥
    @Async("consistencyExecutor")
    public CompletableFuture<Void> asyncConsistencyCheck(String accountId) {
        return CompletableFuture.runAsync(() -> {
            // éé˜»å¡çš„ä¸€è‡´æ€§æ£€æŸ¥
            checkAccountConsistency(accountId);
        });
    }
    
    // ç¼“å­˜ä¼˜åŒ–çš„ä½™é¢æŸ¥è¯¢
    @Cacheable(value = "accountBalance", key = "#accountId", unless = "#result == null")
    public BigDecimal getCachedBalance(String accountId) {
        Account account = accountService.getAccount(accountId);
        return account != null ? account.getBalance() : null;
    }
    
    // ç¼“å­˜å¤±æ•ˆç­–ç•¥
    @CacheEvict(value = "accountBalance", key = "#accountId")
    public void evictBalanceCache(String accountId) {
        // è´¦æˆ·æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    }
}
```

### 6.3 ä¸€è‡´æ€§çº§åˆ«åŠ¨æ€è°ƒæ•´


**ğŸ”¸ æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´ä¸€è‡´æ€§è¦æ±‚**

```
åŠ¨æ€ä¸€è‡´æ€§ç­–ç•¥ï¼š

é«˜å³°æœŸï¼ˆäº¤æ˜“é‡å¤§ï¼‰ï¼š
â”œâ”€â”€ é™ä½ä¸€è‡´æ€§æ£€æŸ¥é¢‘ç‡
â”œâ”€â”€ ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§æ¨¡å¼
â”œâ”€â”€ å»¶è¿Ÿéå…³é”®æ“ä½œ
â””â”€â”€ å¢åŠ å¼‚æ­¥å¤„ç†æ¯”ä¾‹

éé«˜å³°æœŸï¼ˆäº¤æ˜“é‡å°ï¼‰ï¼š
â”œâ”€â”€ æé«˜ä¸€è‡´æ€§æ£€æŸ¥é¢‘ç‡
â”œâ”€â”€ æ‰§è¡Œæ•°æ®æ ¡éªŒå’Œä¿®å¤
â”œâ”€â”€ è¿›è¡Œç³»ç»Ÿç»´æŠ¤æ“ä½œ
â””â”€â”€ é¢„åŠ è½½å¸¸ç”¨æ•°æ®

ç´§æ€¥æƒ…å†µï¼ˆç³»ç»Ÿå¼‚å¸¸ï¼‰ï¼š
â”œâ”€â”€ åˆ‡æ¢åˆ°æœ€ä¸¥æ ¼æ¨¡å¼
â”œâ”€â”€ åœæ­¢éå¿…è¦æ“ä½œ
â”œâ”€â”€ åŠ å¼ºç›‘æ§å’Œå‘Šè­¦
â””â”€â”€ äººå·¥å®¡æ ¸æ‰€æœ‰æ“ä½œ
```

---

## 7. ğŸ›¡ï¸ é‡‘èçº§å®¹é”™è®¾è®¡å®æˆ˜


### 7.1 å¤šæ´»æ•°æ®ä¸€è‡´æ€§


**ğŸ”¸ å¤šæ´»æ¶æ„è®¾è®¡**

å¤šæ´»å°±åƒ"å¤šä¸ªé“¶è¡Œç½‘ç‚¹åŒæ—¶è¥ä¸š"ï¼š

```
å¤šæ´»æ¶æ„ç¤ºä¾‹ï¼š

        ç”¨æˆ·è¯·æ±‚
           |
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    |      |      |
   ååŒ—   åä¸œ   åå—
  æ•°æ®ä¸­å¿ƒ æ•°æ®ä¸­å¿ƒ æ•°æ®ä¸­å¿ƒ
    |      |      |
å®æ—¶åŒæ­¥ <â”€â”¼â”€> å®æ—¶åŒæ­¥
    |      |      |
   æœ¬åœ°   æœ¬åœ°   æœ¬åœ°
   ç¼“å­˜   ç¼“å­˜   ç¼“å­˜
```

**ğŸ’» å¤šæ´»ä¸€è‡´æ€§å®ç°**

```java
@Service
public class MultiActiveConsistency {
    
    private final List<DataCenter> dataCenters;
    private final ConsensusProtocol consensus;
    
    // è·¨ä¸­å¿ƒäº‹åŠ¡å¤„ç†
    public boolean processGlobalTransaction(Transaction tx) {
        // 1. é€‰æ‹©ä¸»å¤„ç†ä¸­å¿ƒï¼ˆå°±è¿‘åŸåˆ™ï¼‰
        DataCenter primary = selectPrimaryDataCenter(tx);
        
        // 2. åœ¨ä¸»ä¸­å¿ƒæ‰§è¡Œäº‹åŠ¡
        TransactionResult result = primary.executeTransaction(tx);
        if (!result.isSuccess()) {
            return false;
        }
        
        // 3. åŒæ­¥åˆ°å…¶ä»–ä¸­å¿ƒ
        List<CompletableFuture<Boolean>> syncFutures = new ArrayList<>();
        for (DataCenter dc : dataCenters) {
            if (dc != primary) {
                CompletableFuture<Boolean> future = dc.asyncReplicateTransaction(tx);
                syncFutures.add(future);
            }
        }
        
        // 4. ç­‰å¾…å¤šæ•°ç¡®è®¤
        long successCount = syncFutures.stream()
            .map(CompletableFuture::join)
            .mapToLong(success -> success ? 1 : 0)
            .sum() + 1; // åŠ ä¸Šä¸»ä¸­å¿ƒ
            
        if (successCount > dataCenters.size() / 2) {
            // å¤šæ•°ç¡®è®¤ï¼Œæäº¤äº‹åŠ¡
            commitGlobalTransaction(tx);
            return true;
        } else {
            // åŒæ­¥å¤±è´¥ï¼Œå›æ»šäº‹åŠ¡
            rollbackGlobalTransaction(tx);
            return false;
        }
    }
    
    // æ•°æ®ä¸­å¿ƒæ•…éšœåˆ‡æ¢
    public void handleDataCenterFailure(DataCenter failedDC) {
        // 1. åœæ­¢å‘æ•…éšœä¸­å¿ƒå‘é€è¯·æ±‚
        removeFromActiveList(failedDC);
        
        // 2. é‡æ–°åˆ†é…è¯¥ä¸­å¿ƒçš„è¯·æ±‚
        redistributeTraffic(failedDC);
        
        // 3. å¯åŠ¨æ•°æ®æ¢å¤
        scheduleDataRecovery(failedDC);
        
        // 4. å‘Šè­¦é€šçŸ¥
        alertService.sendCriticalAlert("æ•°æ®ä¸­å¿ƒæ•…éšœ", failedDC);
    }
}
```

### 7.2 å®¹é”™æœºåˆ¶è®¾è®¡


**ğŸ”¸ å¤šå±‚å®¹é”™ä½“ç³»**

```
å®¹é”™å±‚æ¬¡è®¾è®¡ï¼š

åº”ç”¨å±‚å®¹é”™ï¼š
â”œâ”€â”€ ç†”æ–­å™¨ï¼šé˜²æ­¢æ•…éšœæ‰©æ•£
â”œâ”€â”€ é‡è¯•æœºåˆ¶ï¼šå¤„ç†ä¸´æ—¶æ•…éšœ
â”œâ”€â”€ é™çº§ç­–ç•¥ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½
â””â”€â”€ è¶…æ—¶æ§åˆ¶ï¼šé¿å…èµ„æºè€—å°½

ä¸­é—´ä»¶å±‚å®¹é”™ï¼š
â”œâ”€â”€ æ¶ˆæ¯é˜Ÿåˆ—ï¼šå¼‚æ­¥è§£è€¦
â”œâ”€â”€ ç¼“å­˜å±‚ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›
â”œâ”€â”€ è´Ÿè½½å‡è¡¡ï¼šåˆ†æ•£è¯·æ±‚å‹åŠ›  
â””â”€â”€ è¿æ¥æ± ï¼šå¤ç”¨è¿æ¥èµ„æº

æ•°æ®å±‚å®¹é”™ï¼š
â”œâ”€â”€ ä¸»ä»å¤åˆ¶ï¼šæ•°æ®å†—ä½™
â”œâ”€â”€ åˆ†åŒºå®¹é”™ï¼šéƒ¨åˆ†å¯ç”¨
â”œâ”€â”€ å¤‡ä»½æ¢å¤ï¼šç¾éš¾æ¢å¤
â””â”€â”€ ä¸€è‡´æ€§æ ¡éªŒï¼šæ•°æ®å®Œæ•´æ€§
```

**ğŸ’» ç†”æ–­å™¨å®ç°**

```java
@Component
public class TransactionCircuitBreaker {
    
    private final AtomicInteger failureCount = new AtomicInteger(0);
    private final AtomicReference<CircuitState> state = 
        new AtomicReference<>(CircuitState.CLOSED);
    private volatile long lastFailureTime;
    
    private static final int FAILURE_THRESHOLD = 5;
    private static final long RECOVERY_TIMEOUT = 60000; // 1åˆ†é’Ÿ
    
    public boolean allowTransaction() {
        CircuitState currentState = state.get();
        
        switch (currentState) {
            case CLOSED:
                return true;
                
            case OPEN:
                if (System.currentTimeMillis() - lastFailureTime > RECOVERY_TIMEOUT) {
                    // å°è¯•æ¢å¤
                    state.compareAndSet(CircuitState.OPEN, CircuitState.HALF_OPEN);
                    return true;
                }
                return false;
                
            case HALF_OPEN:
                return true;
                
            default:
                return false;
        }
    }
    
    public void onTransactionSuccess() {
        failureCount.set(0);
        state.set(CircuitState.CLOSED);
    }
    
    public void onTransactionFailure() {
        int failures = failureCount.incrementAndGet();
        lastFailureTime = System.currentTimeMillis();
        
        if (failures >= FAILURE_THRESHOLD) {
            state.set(CircuitState.OPEN);
            // è§¦å‘å‘Šè­¦
            alertService.sendAlert("äº¤æ˜“ç†”æ–­å™¨å¼€å¯", 
                "è¿ç»­å¤±è´¥" + failures + "æ¬¡");
        }
    }
    
    enum CircuitState {
        CLOSED,    // æ­£å¸¸çŠ¶æ€
        OPEN,      // ç†”æ–­çŠ¶æ€
        HALF_OPEN  // åŠå¼€çŠ¶æ€ï¼ˆå°è¯•æ¢å¤ï¼‰
    }
}
```

### 7.3 ç¾éš¾æ¢å¤ç­–ç•¥


**ğŸ”¸ RTOå’ŒRPOç›®æ ‡è®¾å®š**

```
ç¾éš¾æ¢å¤æŒ‡æ ‡ï¼š

RTOï¼ˆRecovery Time Objectiveï¼‰- æ¢å¤æ—¶é—´ç›®æ ‡ï¼š
â”œâ”€â”€ æ ¸å¿ƒäº¤æ˜“ç³»ç»Ÿï¼š< 15åˆ†é’Ÿ
â”œâ”€â”€ è´¦åŠ¡ç³»ç»Ÿï¼š< 30åˆ†é’Ÿ
â”œâ”€â”€ æŸ¥è¯¢ç³»ç»Ÿï¼š< 1å°æ—¶
â””â”€â”€ æŠ¥è¡¨ç³»ç»Ÿï¼š< 4å°æ—¶

RPOï¼ˆRecovery Point Objectiveï¼‰- æ•°æ®æ¢å¤ç‚¹ç›®æ ‡ï¼š
â”œâ”€â”€ æ ¸å¿ƒè´¦æˆ·æ•°æ®ï¼š0ç§’ï¼ˆå®æ—¶åŒæ­¥ï¼‰
â”œâ”€â”€ äº¤æ˜“æµæ°´ï¼š< 1åˆ†é’Ÿ
â”œâ”€â”€ æ—¥å¿—æ•°æ®ï¼š< 5åˆ†é’Ÿ
â””â”€â”€ ç»Ÿè®¡æ•°æ®ï¼š< 1å°æ—¶
```

**ğŸ’» ç¾éš¾æ¢å¤å®ç°**

```java
@Service
public class DisasterRecoveryService {
    
    // å®šæœŸå¤‡ä»½
    @Scheduled(cron = "0 0 */4 * * *") // æ¯4å°æ—¶å¤‡ä»½ä¸€æ¬¡
    public void performFullBackup() {
        try {
            BackupTask task = new BackupTask()
                .includeDatabase("core_accounts")
                .includeDatabase("transactions") 
                .includeDatabase("user_profiles")
                .setBackupLocation("s3://disaster-recovery-bucket/")
                .setEncryption(true)
                .setCompression(true);
                
            BackupResult result = backupService.execute(task);
            
            if (result.isSuccess()) {
                // éªŒè¯å¤‡ä»½å®Œæ•´æ€§
                validateBackup(result.getBackupLocation());
                
                // æ›´æ–°æ¢å¤è®¡åˆ’
                updateRecoveryPlan(result);
            } else {
                alertService.sendCriticalAlert("å¤‡ä»½å¤±è´¥", result.getError());
            }
            
        } catch (Exception e) {
            logger.error("å¤‡ä»½è¿‡ç¨‹å‡ºç°å¼‚å¸¸", e);
            alertService.sendCriticalAlert("å¤‡ä»½å¼‚å¸¸", e.getMessage());
        }
    }
    
    // ç¾éš¾æ¢å¤æ‰§è¡Œ
    public RecoveryResult executeDisasterRecovery(DisasterScenario scenario) {
        RecoveryPlan plan = getRecoveryPlan(scenario);
        RecoveryResult result = new RecoveryResult();
        
        try {
            // 1. è¯„ä¼°æŸå¤±èŒƒå›´
            DamageAssessment assessment = assessDamage(scenario);
            result.setAssessment(assessment);
            
            // 2. æ¿€æ´»å¤‡ç”¨ç³»ç»Ÿ
            if (plan.requiresFailover()) {
                activateBackupSystems();
                result.setBackupSystemsActivated(true);
            }
            
            // 3. æ¢å¤æ•°æ®
            for (RecoveryStep step : plan.getSteps()) {
                StepResult stepResult = executeRecoveryStep(step);
                result.addStepResult(stepResult);
                
                if (!stepResult.isSuccess() && step.isCritical()) {
                    throw new RecoveryException("å…³é”®æ­¥éª¤å¤±è´¥: " + step.getName());
                }
            }
            
            // 4. éªŒè¯æ¢å¤ç»“æœ
            ValidationResult validation = validateRecovery();
            result.setValidation(validation);
            
            if (validation.isDataConsistent()) {
                // 5. åˆ‡æ¢ä¸šåŠ¡æµé‡
                switchTrafficToRecoveredSystems();
                result.setSuccess(true);
            }
            
        } catch (Exception e) {
            result.setSuccess(false);
            result.setError(e.getMessage());
            
            // ç¾éš¾æ¢å¤å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥
            escalateToManualRecovery(scenario, result);
        }
        
        return result;
    }
    
    // å®æ—¶æ•°æ®åŒæ­¥ç›‘æ§
    @EventListener
    public void handleDataReplicationEvent(ReplicationEvent event) {
        if (event.getDelayMillis() > 1000) { // å»¶è¿Ÿè¶…è¿‡1ç§’
            alertService.sendWarning("æ•°æ®åŒæ­¥å»¶è¿Ÿ", 
                "å»¶è¿Ÿ: " + event.getDelayMillis() + "ms");
        }
        
        if (event.hasError()) {
            // åŒæ­¥å‡ºé”™ï¼Œå°è¯•é‡æ–°åŒæ­¥
            retryReplication(event.getSourceLocation(), event.getTargetLocation());
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é‡‘èæ•°æ®ä¸€è‡´æ€§ï¼šç»å¯¹ä¸èƒ½å‡ºé”™çš„æ•°æ®å‡†ç¡®æ€§ä¿è¯
ğŸ”¸ ACIDç‰¹æ€§ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§ã€æŒä¹…æ€§å››å¤§æ”¯æŸ±
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼š2PCã€3PCç¡®ä¿å¤šç³»ç»Ÿé—´æ•°æ®åŒæ­¥
ğŸ”¸ å…±è¯†ç®—æ³•ï¼šRaftã€PBFTä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´
ğŸ”¸ äº‹åŠ¡è¡¥å¿ï¼šSagaæ¨¡å¼å¤„ç†é•¿äº‹åŠ¡çš„å¼‚å¸¸å›æ»š
ğŸ”¸ å¤šæ´»æ¶æ„ï¼šè·¨åœ°åŸŸå®¹ç¾çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
```

### 8.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ ä¸€è‡´æ€§ä¼˜å…ˆåŸåˆ™**
```
é‡‘èç³»ç»Ÿæ ¸å¿ƒå‡†åˆ™ï¼š
- æ•°æ®å‡†ç¡®æ€§ > ç³»ç»Ÿå¯ç”¨æ€§
- å®å¯æœåŠ¡æš‚åœï¼Œä¸å¯æ•°æ®é”™è¯¯  
- æ‰€æœ‰æ“ä½œéƒ½è¦æœ‰å›æ»šæœºåˆ¶
- å¼‚å¸¸æƒ…å†µä¼˜å…ˆä¿è¯æ•°æ®å®Œæ•´æ€§
```

**ğŸ”¹ åˆ†å±‚é˜²æŠ¤ä½“ç³»**
```
å¤šå±‚ä¿æŠ¤æœºåˆ¶ï¼š
- åº”ç”¨å±‚ï¼šä¸šåŠ¡è§„åˆ™æ ¡éªŒ
- ä¸­é—´ä»¶å±‚ï¼šäº‹åŠ¡ç®¡ç†å™¨
- æ•°æ®åº“å±‚ï¼šACIDçº¦æŸ
- ç›‘æ§å±‚ï¼šå®æ—¶å¼‚å¸¸æ£€æµ‹
```

**ğŸ”¹ æ€§èƒ½ä¸ä¸€è‡´æ€§å¹³è¡¡**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
- æ ¸å¿ƒä¸šåŠ¡ï¼šå¼ºä¸€è‡´æ€§
- éæ ¸å¿ƒä¸šåŠ¡ï¼šæœ€ç»ˆä¸€è‡´æ€§
- è¯»æ“ä½œï¼šå…è®¸ä¸€å®šå»¶è¿Ÿ
- å†™æ“ä½œï¼šä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ æŠ€æœ¯é€‰å‹å»ºè®®**
- **å•æœºäº‹åŠ¡**ï¼šä¾èµ–æ•°æ®åº“ACIDç‰¹æ€§
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šä¼˜å…ˆé€‰æ‹©2PCï¼Œè€ƒè™‘æ€§èƒ½æ—¶ç”¨3PC
- **å¾®æœåŠ¡æ¶æ„**ï¼šé‡‡ç”¨Sagaæ¨¡å¼ + äº‹ä»¶é©±åŠ¨
- **å¤šæ´»éƒ¨ç½²**ï¼šä½¿ç”¨Raftå…±è¯† + å¼‚æ­¥å¤åˆ¶

**âš ï¸ å…³é”®æ³¨æ„äº‹é¡¹**
- æ‰€æœ‰é‡‘èæ“ä½œéƒ½è¦æœ‰è¯¦ç»†å®¡è®¡æ—¥å¿—
- å®šæœŸè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ ¡éªŒå’Œä¿®å¤
- å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦æœºåˆ¶
- åˆ¶å®šæ˜ç¡®çš„ç¾éš¾æ¢å¤é¢„æ¡ˆ

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **ACIDä¿åŸºç¡€ï¼Œåˆ†å¸ƒäº‹åŠ¡è¦åè°ƒ**
- **å…±è¯†ç®—æ³•é˜²åˆ†æ­§ï¼Œè¡¥å¿æœºåˆ¶å…œåº•çº¿**
- **ç›‘æ§é¢„è­¦ä¸å¯å°‘ï¼Œå¤šæ´»å®¹ç¾ä¿å®‰å…¨**
- **ä¸€è‡´ä¼˜å…ˆæ€§èƒ½åï¼Œå®åœå‹¿é”™æ˜¯é“å¾‹**