---
title: 6ã€æŠ¥è¡¨ç³»ç»Ÿè®¾è®¡
---
## ğŸ“š ç›®å½•

1. [æŠ¥è¡¨ç³»ç»Ÿæ¦‚è¿°ä¸æ¶æ„](#1-æŠ¥è¡¨ç³»ç»Ÿæ¦‚è¿°ä¸æ¶æ„)
2. [æŠ¥è¡¨æ•°æ®å»ºæ¨¡](#2-æŠ¥è¡¨æ•°æ®å»ºæ¨¡)
3. [å®æ—¶æŠ¥è¡¨ç”Ÿæˆæœºåˆ¶](#3-å®æ—¶æŠ¥è¡¨ç”Ÿæˆæœºåˆ¶)
4. [ç›‘ç®¡æŠ¥è¡¨è‡ªåŠ¨åŒ–](#4-ç›‘ç®¡æŠ¥è¡¨è‡ªåŠ¨åŒ–)
5. [æŠ¥è¡¨æ•°æ®ä»“åº“è®¾è®¡](#5-æŠ¥è¡¨æ•°æ®ä»“åº“è®¾è®¡)
6. [æŠ¥è¡¨ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–](#6-æŠ¥è¡¨ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–)
7. [æŠ¥è¡¨æ¨¡æ¿ä¸ç‰ˆæœ¬ç®¡ç†](#7-æŠ¥è¡¨æ¨¡æ¿ä¸ç‰ˆæœ¬ç®¡ç†)
8. [æŠ¥è¡¨æƒé™æ§åˆ¶ä¸å®¡æ ¸æµç¨‹](#8-æŠ¥è¡¨æƒé™æ§åˆ¶ä¸å®¡æ ¸æµç¨‹)
9. [æŠ¥è¡¨æ•°æ®è¡€ç¼˜ä¸è´¨é‡ç›‘æ§](#9-æŠ¥è¡¨æ•°æ®è¡€ç¼˜ä¸è´¨é‡ç›‘æ§)
10. [æŠ¥è¡¨è‡ªåŠ¨åŒ–è°ƒåº¦ä¸ç›‘æ§](#10-æŠ¥è¡¨è‡ªåŠ¨åŒ–è°ƒåº¦ä¸ç›‘æ§)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ æŠ¥è¡¨ç³»ç»Ÿæ¦‚è¿°ä¸æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯é‡‘èæŠ¥è¡¨ç³»ç»Ÿ


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
é‡‘èæŠ¥è¡¨ç³»ç»Ÿå°±åƒæ˜¯é“¶è¡Œçš„"è´¢åŠ¡ç®¡å®¶"ï¼Œè´Ÿè´£æŠŠå¤æ‚çš„ä¸šåŠ¡æ•°æ®å˜æˆå„ç§æ ¼å¼çš„æŠ¥è¡¨ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæ¯å¤©é“¶è¡Œæœ‰æˆåƒä¸Šä¸‡ç¬”äº¤æ˜“ï¼Œç›‘ç®¡æœºæ„ã€ç®¡ç†å±‚ã€å®¢æˆ·éƒ½éœ€è¦ä¸åŒçš„æŠ¥è¡¨æ¥äº†è§£æƒ…å†µã€‚

```
é‡‘èæŠ¥è¡¨ç³»ç»Ÿçš„æœ¬è´¨ï¼š
æ•°æ®æ”¶é›† â†’ æ•°æ®å¤„ç† â†’ æŠ¥è¡¨ç”Ÿæˆ â†’ æŠ¥è¡¨å±•ç¤º â†’ æŠ¥è¡¨æäº¤
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æŠ¥è¡¨ç³»ç»Ÿ**
- **ç›‘ç®¡åˆè§„**ï¼šå¤®è¡Œã€é“¶ç›‘ä¼šç­‰è¦æ±‚å®šæœŸæäº¤å„ç§ç›‘ç®¡æŠ¥è¡¨
- **ç»è¥ç®¡ç†**ï¼šç®¡ç†å±‚éœ€è¦çœ‹ä¸šåŠ¡æŒ‡æ ‡ã€é£é™©çŠ¶å†µ
- **å®¢æˆ·æœåŠ¡**ï¼šå®¢æˆ·éœ€è¦å¯¹è´¦å•ã€äº¤æ˜“æ˜ç»†ç­‰
- **å†…éƒ¨åˆ†æ**ï¼šå„éƒ¨é—¨éœ€è¦ä¸šåŠ¡åˆ†ææŠ¥è¡¨

### 1.2 é‡‘èæŠ¥è¡¨ç³»ç»Ÿæ•´ä½“æ¶æ„


**ğŸ¢ ç³»ç»Ÿæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±•ç¤ºå±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æŠ¥è¡¨é—¨æˆ·  â”‚  ç§»åŠ¨ç«¯  â”‚  APIæ¥å£  â”‚  ç›‘ç®¡ä¸ŠæŠ¥å¹³å°      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    åº”ç”¨æœåŠ¡å±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŠ¥è¡¨ç”Ÿæˆå¼•æ“ â”‚ æ¨¡æ¿ç®¡ç† â”‚ æƒé™æ§åˆ¶ â”‚ å®¡æ ¸æµç¨‹ â”‚ è°ƒåº¦æœåŠ¡ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®å¤„ç†å±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ETLå¤„ç†  â”‚  æ•°æ®æ¸…æ´—  â”‚  æ•°æ®èšåˆ  â”‚  ç¼“å­˜æœåŠ¡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®å­˜å‚¨å±‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸šåŠ¡æ•°æ®åº“ â”‚ æ•°æ®ä»“åº“ â”‚ æŠ¥è¡¨æ•°æ®åº“ â”‚ ç¼“å­˜æ•°æ®åº“      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 é‡‘èæŠ¥è¡¨çš„åˆ†ç±»


**ğŸ“Š æŒ‰ç”¨é€”åˆ†ç±»**
```
å†…éƒ¨æŠ¥è¡¨ï¼š
â”œâ”€â”€ ç»è¥ç®¡ç†æŠ¥è¡¨ï¼ˆåˆ©æ¶¦è¡¨ã€èµ„äº§è´Ÿå€ºè¡¨ï¼‰
â”œâ”€â”€ é£é™©ç®¡ç†æŠ¥è¡¨ï¼ˆä¿¡è´·é£é™©ã€å¸‚åœºé£é™©ï¼‰
â”œâ”€â”€ è´¢åŠ¡åˆ†ææŠ¥è¡¨ï¼ˆæˆæœ¬åˆ†æã€æ”¶å…¥åˆ†æï¼‰
â””â”€â”€ ä¸šåŠ¡ç»Ÿè®¡æŠ¥è¡¨ï¼ˆå®¢æˆ·ç»Ÿè®¡ã€äº§å“ç»Ÿè®¡ï¼‰

å¤–éƒ¨æŠ¥è¡¨ï¼š
â”œâ”€â”€ ç›‘ç®¡æŠ¥è¡¨ï¼ˆäººæ°‘é“¶è¡Œã€é“¶ç›‘ä¼šè¦æ±‚ï¼‰
â”œâ”€â”€ ç¨åŠ¡æŠ¥è¡¨ï¼ˆç¨åŠ¡å±€è¦æ±‚ï¼‰
â”œâ”€â”€ å®¡è®¡æŠ¥è¡¨ï¼ˆä¼šè®¡å¸ˆäº‹åŠ¡æ‰€è¦æ±‚ï¼‰
â””â”€â”€ å®¢æˆ·æŠ¥è¡¨ï¼ˆå¯¹è´¦å•ã€äº¤æ˜“æ¸…å•ï¼‰
```

**â° æŒ‰æ—¶é—´é¢‘ç‡åˆ†ç±»**
- **å®æ—¶æŠ¥è¡¨**ï¼šè´¦æˆ·ä½™é¢æŸ¥è¯¢ã€äº¤æ˜“æµæ°´
- **æ—¥æŠ¥è¡¨**ï¼šæ—¥ç»ˆå¯¹è´¦ã€å½“æ—¥ä¸šåŠ¡ç»Ÿè®¡
- **æœˆæŠ¥è¡¨**ï¼šæœˆåº¦ç»è¥æƒ…å†µã€é£é™©çŠ¶å†µ
- **å¹´æŠ¥è¡¨**ï¼šå¹´åº¦è´¢åŠ¡æŠ¥è¡¨ã€ç›‘ç®¡å¹´æŠ¥

---

## 2. ğŸ“Š æŠ¥è¡¨æ•°æ®å»ºæ¨¡


### 2.1 æŠ¥è¡¨æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡æ ¸å¿ƒæ€æƒ³**
æŠ¥è¡¨æ•°æ®å»ºæ¨¡å°±åƒæ­ç§¯æœ¨ï¼Œè¦æŠŠå¤æ‚çš„ä¸šåŠ¡æ•°æ®æŒ‰ç…§æŠ¥è¡¨éœ€æ±‚é‡æ–°ç»„ç»‡ã€‚å…³é”®æ˜¯è¦è®©æ•°æ®"å¥½ç”¨ã€å¥½ç®—ã€å¥½ç»´æŠ¤"ã€‚

**ğŸ”¸ æ ¸å¿ƒè®¾è®¡åŸåˆ™**
```
ä¸€è‡´æ€§åŸåˆ™ï¼š
â€¢ åŒä¸€ä¸ªæŒ‡æ ‡åœ¨ä¸åŒæŠ¥è¡¨ä¸­è®¡ç®—æ–¹æ³•è¦ä¸€è‡´
â€¢ æ•°æ®å£å¾„ç»Ÿä¸€ï¼Œé¿å…"æ•°æ®æ‰“æ¶"

å¯æ‰©å±•æ€§åŸåˆ™ï¼š
â€¢ æ–°å¢å­—æ®µä¸å½±å“ç°æœ‰ç»“æ„
â€¢ æ”¯æŒå†å²æ•°æ®å…¼å®¹

æ€§èƒ½ä¼˜åŒ–åŸåˆ™ï¼š
â€¢ é¢„å…ˆèšåˆå¸¸ç”¨æŒ‡æ ‡
â€¢ åˆç†è®¾è®¡ç´¢å¼•å’Œåˆ†åŒº
```

### 2.2 æŠ¥è¡¨ä¸»é¢˜åŸŸå»ºæ¨¡


**ğŸ“ˆ å®¢æˆ·ä¸»é¢˜åŸŸå»ºæ¨¡**
```sql
-- å®¢æˆ·ç»´åº¦è¡¨
CREATE TABLE dim_customer (
    customer_id VARCHAR(32) PRIMARY KEY,
    customer_name VARCHAR(100),
    customer_type VARCHAR(20), -- ä¸ªäºº/ä¼ä¸š
    risk_level VARCHAR(10),    -- é£é™©ç­‰çº§
    open_date DATE,           -- å¼€æˆ·æ—¥æœŸ
    customer_manager VARCHAR(50),
    valid_flag CHAR(1) DEFAULT '1'
);

-- äº§å“ç»´åº¦è¡¨  
CREATE TABLE dim_product (
    product_id VARCHAR(32) PRIMARY KEY,
    product_name VARCHAR(100),
    product_type VARCHAR(20), -- å­˜æ¬¾/è´·æ¬¾/ç†è´¢
    risk_level VARCHAR(10),
    create_date DATE,
    valid_flag CHAR(1) DEFAULT '1'
);

-- äº¤æ˜“äº‹å®è¡¨
CREATE TABLE fact_transaction (
    trans_id VARCHAR(32) PRIMARY KEY,
    customer_id VARCHAR(32),
    product_id VARCHAR(32),
    trans_date DATE,
    trans_amount DECIMAL(18,2),
    trans_type VARCHAR(20),   -- å­˜å…¥/æ”¯å‡º/è½¬è´¦
    channel VARCHAR(20),      -- ç½‘é“¶/æŸœå°/ATM
    branch_id VARCHAR(20)
);
```

### 2.3 æŠ¥è¡¨æ±‡æ€»è¡¨è®¾è®¡


**ğŸ’° æ—¥åº¦ä¸šåŠ¡æ±‡æ€»è¡¨**
```sql
-- æ¯æ—¥ä¸šåŠ¡æ±‡æ€»è¡¨
CREATE TABLE rpt_daily_business (
    report_date DATE,
    branch_id VARCHAR(20),
    product_type VARCHAR(20),
    customer_type VARCHAR(20),
    -- æ ¸å¿ƒæŒ‡æ ‡
    new_customer_count INT DEFAULT 0,     -- æ–°å¢å®¢æˆ·æ•°
    total_deposit DECIMAL(18,2) DEFAULT 0, -- å­˜æ¬¾ä½™é¢
    total_loan DECIMAL(18,2) DEFAULT 0,    -- è´·æ¬¾ä½™é¢
    trans_count INT DEFAULT 0,             -- äº¤æ˜“ç¬”æ•°
    trans_amount DECIMAL(18,2) DEFAULT 0,  -- äº¤æ˜“é‡‘é¢
    -- å…ƒæ•°æ®
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (report_date, branch_id, product_type, customer_type)
);

-- åˆ›å»ºåˆ†åŒºï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
ALTER TABLE rpt_daily_business 
PARTITION BY RANGE (TO_DAYS(report_date)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01'))
);
```

**ğŸ“Š æœˆåº¦æ±‡æ€»è¡¨è®¾è®¡**
```sql
-- æœˆåº¦ç»¼åˆæŠ¥è¡¨
CREATE TABLE rpt_monthly_summary (
    report_month VARCHAR(6),  -- 202501
    branch_id VARCHAR(20),
    -- èµ„äº§è´Ÿå€ºæŒ‡æ ‡
    total_assets DECIMAL(18,2),      -- æ€»èµ„äº§
    total_liabilities DECIMAL(18,2), -- æ€»è´Ÿå€º
    net_assets DECIMAL(18,2),        -- å‡€èµ„äº§
    -- ç»è¥æŒ‡æ ‡
    operating_income DECIMAL(18,2),   -- è¥ä¸šæ”¶å…¥
    operating_expense DECIMAL(18,2),  -- è¥ä¸šæ”¯å‡º
    net_profit DECIMAL(18,2),         -- å‡€åˆ©æ¶¦
    -- é£é™©æŒ‡æ ‡
    overdue_loan DECIMAL(18,2),       -- é€¾æœŸè´·æ¬¾
    provision_balance DECIMAL(18,2),  -- æ‹¨å¤‡ä½™é¢
    npl_ratio DECIMAL(5,4),          -- ä¸è‰¯ç‡
    
    PRIMARY KEY (report_month, branch_id)
);
```

### 2.4 æŠ¥è¡¨æ•°æ®è¡€ç¼˜è®¾è®¡


**ğŸ” æ•°æ®è¡€ç¼˜è¿½è¸ª**
æ•°æ®è¡€ç¼˜å°±åƒå®¶è°±ä¸€æ ·ï¼Œè®°å½•æ¯ä¸ªæŠ¥è¡¨æ•°æ®æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œç»è¿‡äº†ä»€ä¹ˆå¤„ç†ã€‚

```sql
-- æ•°æ®è¡€ç¼˜å…³ç³»è¡¨
CREATE TABLE data_lineage (
    lineage_id VARCHAR(32) PRIMARY KEY,
    source_table VARCHAR(100),    -- æºè¡¨
    source_field VARCHAR(100),    -- æºå­—æ®µ
    target_table VARCHAR(100),    -- ç›®æ ‡è¡¨
    target_field VARCHAR(100),    -- ç›®æ ‡å­—æ®µ
    transform_rule TEXT,          -- è½¬æ¢è§„åˆ™
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥è¡€ç¼˜å…³ç³»ç¤ºä¾‹
INSERT INTO data_lineage VALUES 
('LN001', 'fact_transaction', 'trans_amount', 'rpt_daily_business', 'trans_amount', 'SUM(trans_amount) GROUP BY report_date', NOW()),
('LN002', 'dim_customer', 'customer_id', 'rpt_daily_business', 'new_customer_count', 'COUNT(DISTINCT customer_id) WHERE open_date = report_date', NOW());
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æ•°æ®è¡€ç¼˜å°±åƒåšèœçš„é£Ÿè°±ï¼Œè®°å½•äº†è¿™é“èœï¼ˆæŠ¥è¡¨ï¼‰ç”¨äº†ä»€ä¹ˆåŸææ–™ï¼ˆæºæ•°æ®ï¼‰ï¼Œç»è¿‡äº†ä»€ä¹ˆåŠ å·¥æ­¥éª¤ï¼ˆæ•°æ®å¤„ç†ï¼‰ã€‚è¿™æ ·å‡ºäº†é—®é¢˜å°±èƒ½å¿«é€Ÿæ‰¾åˆ°æ˜¯å“ªä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚

---

## 3. âš¡ å®æ—¶æŠ¥è¡¨ç”Ÿæˆæœºåˆ¶


### 3.1 å®æ—¶æŠ¥è¡¨çš„æŒ‘æˆ˜


**ğŸ¤” ä¸ºä»€ä¹ˆå®æ—¶æŠ¥è¡¨å¾ˆéš¾åšï¼Ÿ**
æƒ³è±¡ä¸€ä¸‹ï¼Œé“¶è¡Œæ¯ç§’é’Ÿå¯èƒ½æœ‰å‡ åƒç¬”äº¤æ˜“ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦é‡æ–°è®¡ç®—æ‰€æœ‰æŠ¥è¡¨ï¼Œç³»ç»Ÿè‚¯å®šæ’‘ä¸ä½ã€‚å°±åƒé¤å…åšèœï¼Œä¸å¯èƒ½å®¢äººä¸€ç‚¹èœå°±ä»ä¹°èœå¼€å§‹ï¼Œè€Œæ˜¯è¦æå‰å‡†å¤‡åŠæˆå“ã€‚

**âš ï¸ å¸¸è§é—®é¢˜**
- **æ€§èƒ½é—®é¢˜**ï¼šå¤§é‡å®æ—¶è®¡ç®—å½±å“ç³»ç»Ÿæ€§èƒ½
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå¤šä¸ªæ•°æ®æºæ›´æ–°æ—¶é—´ä¸åŒæ­¥  
- **èµ„æºæ¶ˆè€—**ï¼šå®æ—¶æŸ¥è¯¢å ç”¨å¤§é‡CPUå’Œå†…å­˜
- **å¹¶å‘å†²çª**ï¼šå¤šç”¨æˆ·åŒæ—¶æŸ¥è¯¢ç›¸åŒæŠ¥è¡¨

### 3.2 å®æ—¶æŠ¥è¡¨æ¶æ„è®¾è®¡


**ğŸ—ï¸ åˆ†å±‚æ¶æ„**
```
å®æ—¶æŠ¥è¡¨æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å±•ç¤ºå±‚        â”‚ â† ç”¨æˆ·ç•Œé¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç¼“å­˜å±‚        â”‚ â† Redis/Memcached
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   è®¡ç®—å±‚        â”‚ â† å®æ—¶è®¡ç®—å¼•æ“
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¶ˆæ¯é˜Ÿåˆ—      â”‚ â† Kafka/RabbitMQ  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®æº        â”‚ â† ä¸šåŠ¡æ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å®æ—¶è®¡ç®—å¼•æ“å®ç°


**ğŸ”§ åŸºäºè§¦å‘å™¨çš„å®æ—¶æ›´æ–°**
```sql
-- åˆ›å»ºå®æ—¶æ±‡æ€»è¡¨
CREATE TABLE realtime_balance (
    account_id VARCHAR(32) PRIMARY KEY,
    current_balance DECIMAL(18,2),
    last_update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- åˆ›å»ºè§¦å‘å™¨ï¼šè´¦æˆ·å˜åŠ¨æ—¶è‡ªåŠ¨æ›´æ–°æ±‡æ€»
DELIMITER //
CREATE TRIGGER update_realtime_balance 
AFTER INSERT ON transaction_log
FOR EACH ROW
BEGIN
    -- æ›´æ–°è´¦æˆ·ä½™é¢
    INSERT INTO realtime_balance (account_id, current_balance)
    VALUES (NEW.account_id, NEW.trans_amount)
    ON DUPLICATE KEY UPDATE 
        current_balance = current_balance + NEW.trans_amount,
        last_update_time = NOW();
END //
DELIMITER ;
```

**âš¡ åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥å¤„ç†**
```java
@Component
public class RealtimeReportProcessor {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // ç›‘å¬è´¦æˆ·å˜åŠ¨æ¶ˆæ¯
    @RabbitListener(queues = "account.balance.queue")
    public void processBalanceChange(AccountChangeMessage message) {
        try {
            // 1. æ›´æ–°Redisç¼“å­˜
            String key = "balance:" + message.getAccountId();
            redisTemplate.opsForHash().increment(key, "amount", message.getAmount());
            
            // 2. å¼‚æ­¥æ›´æ–°æŠ¥è¡¨æ•°æ®
            updateRealtimeReport(message);
            
        } catch (Exception e) {
            log.error("å¤„ç†å®æ—¶æŠ¥è¡¨æ›´æ–°å¤±è´¥", e);
            // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—é‡è¯•
        }
    }
    
    private void updateRealtimeReport(AccountChangeMessage message) {
        // æ›´æ–°å®æ—¶æ±‡æ€»æ•°æ®
        String sql = """
            INSERT INTO realtime_daily_summary (report_date, branch_id, total_amount, trans_count)
            VALUES (CURDATE(), ?, ?, 1)
            ON DUPLICATE KEY UPDATE 
                total_amount = total_amount + ?,
                trans_count = trans_count + 1
            """;
        
        jdbcTemplate.update(sql, 
            message.getBranchId(), 
            message.getAmount(), 
            message.getAmount());
    }
}
```

### 3.4 å®æ—¶æŠ¥è¡¨ç¼“å­˜ç­–ç•¥


**ğŸ“¦ å¤šçº§ç¼“å­˜è®¾è®¡**
```java
@Service
public class RealtimeReportService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // è·å–å®æ—¶æŠ¥è¡¨æ•°æ®
    public RealtimeReportDTO getRealtimeReport(String branchId, String reportType) {
        
        // L1ç¼“å­˜ï¼šRedisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
        String cacheKey = "realtime_report:" + branchId + ":" + reportType;
        RealtimeReportDTO cachedReport = (RealtimeReportDTO) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedReport != null) {
            return cachedReport;
        }
        
        // L2ç¼“å­˜ï¼šæ•°æ®åº“å®æ—¶æ±‡æ€»è¡¨
        RealtimeReportDTO report = buildReportFromSummaryTable(branchId, reportType);
        
        if (report == null) {
            // L3ï¼šå®æ—¶è®¡ç®—ï¼ˆæœ€è€—æ—¶ï¼‰
            report = calculateReportRealtime(branchId, reportType);
        }
        
        // ç¼“å­˜ç»“æœ
        redisTemplate.opsForValue().set(cacheKey, report, Duration.ofMinutes(5));
        
        return report;
    }
}
```

**ğŸ’¡ ç¼“å­˜ç­–ç•¥è¯´æ˜**
- **L1ç¼“å­˜ï¼ˆRedisï¼‰**ï¼šæœ€å¿«ï¼Œå­˜æ”¾æœ€ç»ˆç»“æœï¼Œ5åˆ†é’Ÿè¿‡æœŸ
- **L2ç¼“å­˜ï¼ˆæ±‡æ€»è¡¨ï¼‰**ï¼šä¸­ç­‰é€Ÿåº¦ï¼Œé¢„è®¡ç®—çš„æ±‡æ€»æ•°æ®ï¼Œ1å°æ—¶æ›´æ–°
- **L3å®æ—¶è®¡ç®—**ï¼šæœ€æ…¢ä½†æœ€å‡†ç¡®ï¼Œç›´æ¥ä»æ˜ç»†æ•°æ®è®¡ç®—

---

## 4. ğŸ“‹ ç›‘ç®¡æŠ¥è¡¨è‡ªåŠ¨åŒ–


### 4.1 ç›‘ç®¡æŠ¥è¡¨åŸºç¡€çŸ¥è¯†


**ğŸ›ï¸ ä»€ä¹ˆæ˜¯ç›‘ç®¡æŠ¥è¡¨ï¼Ÿ**
ç›‘ç®¡æŠ¥è¡¨å°±åƒå­¦ç”Ÿè¦äº¤ç»™è€å¸ˆçš„ä½œä¸šï¼Œé“¶è¡Œå¿…é¡»å®šæœŸå‘å¤®è¡Œã€é“¶ä¿ç›‘ä¼šç­‰æœºæ„æäº¤å„ç§æŠ¥è¡¨ï¼Œè¯´æ˜è‡ªå·±çš„ç»è¥çŠ¶å†µã€é£é™©æƒ…å†µç­‰ã€‚

**ğŸ“Š ä¸»è¦ç›‘ç®¡æŠ¥è¡¨ç±»å‹**
```
äººæ°‘é“¶è¡ŒæŠ¥è¡¨ï¼š
â”œâ”€â”€ èµ„äº§è´Ÿå€ºè¡¨ï¼ˆæœˆæŠ¥ï¼‰
â”œâ”€â”€ æŸç›Šè¡¨ï¼ˆæœˆæŠ¥ï¼‰  
â”œâ”€â”€ ç°é‡‘æµé‡è¡¨ï¼ˆå­£æŠ¥ï¼‰
â””â”€â”€ é£é™©ç›‘ç®¡æŒ‡æ ‡è¡¨ï¼ˆæœˆæŠ¥ï¼‰

é“¶ä¿ç›‘ä¼šæŠ¥è¡¨ï¼š
â”œâ”€â”€ å¿ä»˜èƒ½åŠ›æŠ¥è¡¨ï¼ˆå­£æŠ¥ï¼‰
â”œâ”€â”€ é£é™©ç®¡ç†æŠ¥è¡¨ï¼ˆæœˆæŠ¥ï¼‰
â”œâ”€â”€ æµåŠ¨æ€§é£é™©ç›‘ç®¡æŠ¥è¡¨ï¼ˆæœˆæŠ¥ï¼‰
â””â”€â”€ ä¿¡è´·æŠ•æ”¾ç»Ÿè®¡è¡¨ï¼ˆæœˆæŠ¥ï¼‰
```

### 4.2 XBRLæŠ¥è¡¨è‡ªåŠ¨åŒ–


**ğŸ”¸ XBRLæ˜¯ä»€ä¹ˆï¼Ÿ**
XBRLå°±åƒç»™æŠ¥è¡¨æ•°æ®æ‰“"æ ‡ç­¾"ï¼Œè®©è®¡ç®—æœºèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«è¿™ä¸ªæ•°æ®æ˜¯ä»€ä¹ˆæ„æ€ã€‚æ¯”å¦‚æŠŠ"è¥ä¸šæ”¶å…¥"è¿™ä¸ªæ•°æ®æ‰“ä¸Šæ ‡å‡†åŒ–çš„æ ‡ç­¾ï¼Œå…¨ä¸–ç•Œçš„ç³»ç»Ÿéƒ½èƒ½è®¤è¯†ã€‚

```xml
<!-- XBRLæŠ¥è¡¨ç¤ºä¾‹ -->
<xbrl xmlns="http://www.xbrl.org/2003/instance">
    <!-- èµ„äº§æ€»é¢ -->
    <assets contextRef="current" unitRef="CNY" decimals="0">
        1250000000
    </assets>
    
    <!-- è´Ÿå€ºæ€»é¢ -->
    <liabilities contextRef="current" unitRef="CNY" decimals="0">
        1100000000  
    </liabilities>
    
    <!-- æ‰€æœ‰è€…æƒç›Š -->
    <equity contextRef="current" unitRef="CNY" decimals="0">
        150000000
    </equity>
</xbrl>
```

**ğŸ¤– XBRLè‡ªåŠ¨ç”Ÿæˆå®ç°**
```java
@Service
public class XBRLReportGenerator {
    
    // ç”ŸæˆXBRLæ ¼å¼çš„ç›‘ç®¡æŠ¥è¡¨
    public String generateXBRLReport(String reportType, String reportPeriod) {
        
        // 1. è·å–æŠ¥è¡¨æ•°æ®
        Map<String, Object> reportData = getReportData(reportType, reportPeriod);
        
        // 2. åŠ è½½XBRLæ¨¡æ¿
        XBRLTemplate template = loadXBRLTemplate(reportType);
        
        // 3. æ•°æ®æ˜ å°„å’Œè½¬æ¢
        XBRLDocument document = new XBRLDocument();
        
        for (XBRLElement element : template.getElements()) {
            String value = convertDataValue(reportData.get(element.getSourceField()));
            document.addElement(element.getTagName(), value, element.getContext());
        }
        
        // 4. ç”ŸæˆXML
        return document.toXML();
    }
    
    // æ•°æ®è½¬æ¢ï¼ˆå¤„ç†ç²¾åº¦ã€å•ä½ç­‰ï¼‰
    private String convertDataValue(Object value) {
        if (value instanceof BigDecimal) {
            // é‡‘é¢è½¬æ¢ä¸ºå…ƒï¼Œä¿ç•™2ä½å°æ•°
            return ((BigDecimal) value).setScale(2, RoundingMode.HALF_UP).toString();
        }
        return String.valueOf(value);
    }
}
```

### 4.3 FIXåè®®æŠ¥è¡¨å¤„ç†


**ğŸ”¸ FIXåè®®ç®€ä»‹**
FIXåè®®æ˜¯é‡‘èè¡Œä¸šçš„é€šä¿¡åè®®ï¼Œå°±åƒä¸åŒé“¶è¡Œä¹‹é—´çš„"é€šç”¨è¯­è¨€"ï¼Œè®©ç³»ç»Ÿèƒ½å¤Ÿäº’ç›¸ç†è§£å¯¹æ–¹å‘é€çš„äº¤æ˜“å’ŒæŠ¥è¡¨ä¿¡æ¯ã€‚

```java
@Component
public class FIXReportProcessor {
    
    // ç”ŸæˆFIXæ ¼å¼çš„äº¤æ˜“æŠ¥è¡¨
    public String generateFIXTradeReport(List<Trade> trades) {
        StringBuilder fixMessage = new StringBuilder();
        
        // FIXæ¶ˆæ¯å¤´
        fixMessage.append("35=AE|"); // æ¶ˆæ¯ç±»å‹ï¼šäº¤æ˜“æŠ¥å‘Š
        fixMessage.append("49=BANK001|"); // å‘é€æ–¹ID
        fixMessage.append("56=PBOC|"); // æ¥æ”¶æ–¹IDï¼ˆäººæ°‘é“¶è¡Œï¼‰
        
        // äº¤æ˜“æ˜ç»†
        for (Trade trade : trades) {
            fixMessage.append("55=").append(trade.getSymbol()).append("|"); // è¯åˆ¸ä»£ç 
            fixMessage.append("54=").append(trade.getSide()).append("|");   // ä¹°å–æ–¹å‘
            fixMessage.append("38=").append(trade.getQuantity()).append("|"); // æ•°é‡
            fixMessage.append("44=").append(trade.getPrice()).append("|");   // ä»·æ ¼
        }
        
        return fixMessage.toString();
    }
}
```

### 4.4 ç›‘ç®¡æŠ¥è¡¨è‡ªåŠ¨åŒ–è°ƒåº¦


**â° è‡ªåŠ¨åŒ–è°ƒåº¦è®¾è®¡**
```java
@Component
public class RegulatoryReportScheduler {
    
    @Autowired
    private ReportGenerationService reportService;
    
    // æ¯æœˆ1æ—¥å‡Œæ™¨2ç‚¹ç”Ÿæˆæœˆåº¦ç›‘ç®¡æŠ¥è¡¨
    @Scheduled(cron = "0 0 2 1 * ?")
    public void generateMonthlyRegulatoryReports() {
        
        String reportPeriod = getLastMonthPeriod();
        
        try {
            // 1. ç”Ÿæˆäººæ°‘é“¶è¡ŒæœˆæŠ¥
            generatePBOCMonthlyReport(reportPeriod);
            
            // 2. ç”Ÿæˆé“¶ä¿ç›‘ä¼šæœˆæŠ¥  
            generateCBIRCMonthlyReport(reportPeriod);
            
            // 3. å‘é€é‚®ä»¶é€šçŸ¥
            sendReportNotification("æœˆåº¦ç›‘ç®¡æŠ¥è¡¨ç”Ÿæˆå®Œæˆ", reportPeriod);
            
        } catch (Exception e) {
            log.error("ç›‘ç®¡æŠ¥è¡¨ç”Ÿæˆå¤±è´¥", e);
            sendErrorNotification(e.getMessage());
        }
    }
    
    private void generatePBOCMonthlyReport(String period) {
        // èµ„äº§è´Ÿå€ºè¡¨
        String balanceSheet = reportService.generateXBRLReport("BALANCE_SHEET", period);
        saveReportFile("PBOC_BALANCE_SHEET_" + period + ".xml", balanceSheet);
        
        // æŸç›Šè¡¨
        String incomeStatement = reportService.generateXBRLReport("INCOME_STATEMENT", period);
        saveReportFile("PBOC_INCOME_STATEMENT_" + period + ".xml", incomeStatement);
    }
}
```

---

## 5. ğŸ¢ æŠ¥è¡¨æ•°æ®ä»“åº“è®¾è®¡


### 5.1 æ•°æ®ä»“åº“åŸºç¡€æ¦‚å¿µ


**ğŸ  ä»€ä¹ˆæ˜¯æŠ¥è¡¨æ•°æ®ä»“åº“ï¼Ÿ**
æŠ¥è¡¨æ•°æ®ä»“åº“å°±åƒä¸€ä¸ªä¸“é—¨çš„"å›¾ä¹¦é¦†"ï¼ŒæŠŠå„ä¸ªä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®æ”¶é›†èµ·æ¥ï¼Œæ•´ç†åˆ†ç±»ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾å’Œåˆ†æã€‚å°±åƒå›¾ä¹¦é¦†æŠŠä¹¦æŒ‰ä¸»é¢˜åˆ†ç±»æ‘†æ”¾ï¼ŒæŸ¥èµ„æ–™æ—¶èƒ½å¿«é€Ÿæ‰¾åˆ°ã€‚

**ğŸ”¸ æ•°æ®ä»“åº“ vs ä¸šåŠ¡æ•°æ®åº“**
```
ä¸šåŠ¡æ•°æ®åº“ï¼ˆOLTPï¼‰ï¼š
âœ“ ç”¨é€”ï¼šå¤„ç†æ—¥å¸¸äº¤æ˜“
âœ“ ç‰¹ç‚¹ï¼šè¯»å†™é¢‘ç¹ï¼Œå®æ—¶æ€§å¼º
âœ“ ç»“æ„ï¼šèŒƒå¼åŒ–è®¾è®¡
âœ“ ä¸¾ä¾‹ï¼šè´¦æˆ·è½¬è´¦ã€å­˜å–æ¬¾

æŠ¥è¡¨æ•°æ®ä»“åº“ï¼ˆOLAPï¼‰ï¼š
âœ“ ç”¨é€”ï¼šæ•°æ®åˆ†æå’ŒæŠ¥è¡¨
âœ“ ç‰¹ç‚¹ï¼šä¸»è¦è¯»å–ï¼Œå†å²æ•°æ®å¤š
âœ“ ç»“æ„ï¼šç»´åº¦å»ºæ¨¡ï¼ˆæ˜Ÿå‹/é›ªèŠ±ï¼‰
âœ“ ä¸¾ä¾‹ï¼šæœˆåº¦ç»è¥åˆ†æã€å¹´åº¦ç»Ÿè®¡
```

### 5.2 å¤šç»´æ•°æ®æ¨¡å‹è®¾è®¡


**â­ æ˜Ÿå‹æ¨¡å‹è®¾è®¡**
```
æ˜Ÿå‹æ¨¡å‹ç»“æ„ï¼š
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  æ—¶é—´ç»´åº¦    â”‚
                   â”‚ dim_date    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å®¢æˆ·ç»´åº¦    â”‚   â”‚   â”‚  äº§å“ç»´åº¦    â”‚
        â”‚dim_customer â”‚â”€â”€â”€â”¼â”€â”€â”€â”‚ dim_product â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  äº¤æ˜“äº‹å®è¡¨  â”‚
                   â”‚fact_trading â”‚ â† ä¸­å¿ƒäº‹å®è¡¨
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ¸ é“ç»´åº¦    â”‚   â”‚   â”‚  æœºæ„ç»´åº¦    â”‚
        â”‚ dim_channel â”‚â”€â”€â”€â”¼â”€â”€â”€â”‚ dim_branch  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  è´¦æˆ·ç»´åº¦    â”‚
                   â”‚ dim_account â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š ç»´åº¦è¡¨è®¾è®¡ç¤ºä¾‹**
```sql
-- æ—¶é—´ç»´åº¦è¡¨ï¼ˆæ”¯æŒå¤šç§æ—¶é—´åˆ†æï¼‰
CREATE TABLE dim_date (
    date_key INT PRIMARY KEY,           -- 20250110
    full_date DATE,                     -- 2025-01-10
    year INT,                          -- 2025
    quarter INT,                       -- 1
    month INT,                         -- 1  
    week INT,                          -- 2
    day_of_month INT,                  -- 10
    day_of_week INT,                   -- 5ï¼ˆå‘¨äº”ï¼‰
    day_name VARCHAR(10),              -- 'Friday'
    month_name VARCHAR(10),            -- 'January'
    is_weekend CHAR(1),                -- 'Y'/'N'
    is_holiday CHAR(1),                -- 'Y'/'N'
    fiscal_year INT,                   -- è´¢å¹´
    fiscal_quarter INT                 -- è´¢å­£
);

-- å®¢æˆ·ç»´åº¦è¡¨ï¼ˆæ…¢å˜ç»´åº¦SCD2å¤„ç†ï¼‰
CREATE TABLE dim_customer (
    customer_key INT AUTO_INCREMENT PRIMARY KEY, -- ä»£ç†é”®
    customer_id VARCHAR(32),                     -- ä¸šåŠ¡é”®
    customer_name VARCHAR(100),
    customer_type VARCHAR(20),                   -- ä¸ªäºº/ä¼ä¸š
    age_group VARCHAR(20),                       -- å¹´é¾„æ®µ
    income_level VARCHAR(20),                    -- æ”¶å…¥æ°´å¹³
    risk_level VARCHAR(10),                      -- é£é™©ç­‰çº§
    customer_manager VARCHAR(50),
    -- SCD2å­—æ®µ
    effective_date DATE,                         -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                           -- å¤±æ•ˆæ—¥æœŸ  
    is_current CHAR(1) DEFAULT 'Y',             -- æ˜¯å¦å½“å‰ç‰ˆæœ¬
    version INT DEFAULT 1                       -- ç‰ˆæœ¬å·
);
```

**ğŸ“ˆ äº‹å®è¡¨è®¾è®¡**
```sql
-- äº¤æ˜“äº‹å®è¡¨
CREATE TABLE fact_daily_transaction (
    -- ç»´åº¦é”®ï¼ˆå¤–é”®ï¼‰
    date_key INT,
    customer_key INT,
    product_key INT,
    account_key INT,
    branch_key INT,
    channel_key INT,
    
    -- åº¦é‡å€¼ï¼ˆå¯èšåˆçš„æ•°å€¼ï¼‰
    transaction_count INT,              -- äº¤æ˜“ç¬”æ•°
    transaction_amount DECIMAL(18,2),   -- äº¤æ˜“é‡‘é¢
    fee_amount DECIMAL(18,2),          -- æ‰‹ç»­è´¹
    balance_after DECIMAL(18,2),       -- äº¤æ˜“åä½™é¢
    
    -- é€€åŒ–ç»´åº¦ï¼ˆä¸éœ€è¦å•ç‹¬ç»´åº¦è¡¨çš„å±æ€§ï¼‰
    transaction_id VARCHAR(32),
    transaction_type VARCHAR(20),
    
    -- å…ƒæ•°æ®
    etl_date DATE,                     -- ETLå¤„ç†æ—¥æœŸ
    
    PRIMARY KEY (date_key, customer_key, product_key, account_key)
);

-- åˆ›å»ºåˆ†åŒºæå‡æŸ¥è¯¢æ€§èƒ½
ALTER TABLE fact_daily_transaction 
PARTITION BY RANGE (date_key) (
    PARTITION p202501 VALUES LESS THAN (20250201),
    PARTITION p202502 VALUES LESS THAN (20250301),
    PARTITION p202503 VALUES LESS THAN (20250401)
);
```

### 5.3 æ•°æ®ä»“åº“ETLå¤„ç†


**ğŸ”„ ETLå¤„ç†æµç¨‹**
```
ETLæµç¨‹ï¼š
ä¸šåŠ¡ç³»ç»Ÿ â†’ æŠ½å–(Extract) â†’ è½¬æ¢(Transform) â†’ åŠ è½½(Load) â†’ æ•°æ®ä»“åº“

æŠ½å–ï¼šä»å„ä¸šåŠ¡ç³»ç»Ÿè·å–æ•°æ®
è½¬æ¢ï¼šæ•°æ®æ¸…æ´—ã€æ ¼å¼ç»Ÿä¸€ã€ä¸šåŠ¡è§„åˆ™è®¡ç®—
åŠ è½½ï¼šå†™å…¥æ•°æ®ä»“åº“ï¼Œæ›´æ–°ç»´åº¦å’Œäº‹å®è¡¨
```

**âš™ï¸ ETLå¤„ç†å®ç°**
```java
@Component
public class ReportETLProcessor {
    
    // æ¯æ—¥ETLä½œä¸š
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹
    public void dailyETLProcess() {
        
        String processDate = LocalDate.now().minusDays(1).toString();
        
        try {
            // 1. æŠ½å–æ˜¨æ—¥äº¤æ˜“æ•°æ®
            List<TransactionData> transactions = extractDailyTransactions(processDate);
            
            // 2. è½¬æ¢æ•°æ®
            List<FactTransaction> factData = transformTransactionData(transactions);
            
            // 3. åŠ è½½åˆ°äº‹å®è¡¨
            loadFactTable(factData);
            
            // 4. æ›´æ–°æ±‡æ€»è¡¨
            updateSummaryTables(processDate);
            
            log.info("ETLå¤„ç†å®Œæˆï¼Œæ—¥æœŸï¼š{}", processDate);
            
        } catch (Exception e) {
            log.error("ETLå¤„ç†å¤±è´¥", e);
            sendETLFailureAlert(processDate, e.getMessage());
        }
    }
    
    private List<FactTransaction> transformTransactionData(List<TransactionData> transactions) {
        
        return transactions.stream().map(trans -> {
            FactTransaction fact = new FactTransaction();
            
            // ç»´åº¦é”®æŸ¥æ‰¾
            fact.setDateKey(getDateKey(trans.getTransDate()));
            fact.setCustomerKey(getCustomerKey(trans.getCustomerId()));
            fact.setProductKey(getProductKey(trans.getProductId()));
            
            // åº¦é‡å€¼è®¡ç®—
            fact.setTransactionAmount(trans.getAmount());
            fact.setFeeAmount(calculateFee(trans.getAmount(), trans.getTransType()));
            
            return fact;
        }).collect(Collectors.toList());
    }
}
```

---

## 6. ğŸš€ æŠ¥è¡¨ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–


### 6.1 æŠ¥è¡¨æŸ¥è¯¢æ€§èƒ½æŒ‘æˆ˜


**ğŸŒ ä¸ºä»€ä¹ˆæŠ¥è¡¨æŸ¥è¯¢æ…¢ï¼Ÿ**
æƒ³è±¡ä¸€ä¸ªå¤§å‹å›¾ä¹¦é¦†ï¼Œå¦‚æœæ²¡æœ‰åˆ†ç±»å’Œç´¢å¼•ï¼Œæ¯æ¬¡æ‰¾ä¹¦éƒ½è¦ä¸€æœ¬æœ¬ç¿»ï¼Œè‚¯å®šå¾ˆæ…¢ã€‚æŠ¥è¡¨æŸ¥è¯¢ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ•°æ®é‡å¤§ã€è®¡ç®—å¤æ‚ï¼Œå¦‚æœæ²¡æœ‰ä¼˜åŒ–ç­–ç•¥ï¼Œç”¨æˆ·ç­‰åŠå¤©æ‰èƒ½çœ‹åˆ°ç»“æœã€‚

**âš ï¸ æ€§èƒ½ç“¶é¢ˆåˆ†æ**
```
å¸¸è§æ€§èƒ½é—®é¢˜ï¼š
â”œâ”€â”€ æ•°æ®é‡å¤§ï¼šå‡ åƒä¸‡æ¡äº¤æ˜“è®°å½•
â”œâ”€â”€ è®¡ç®—å¤æ‚ï¼šå¤šç»´åº¦èšåˆã€å¤æ‚å…¬å¼
â”œâ”€â”€ å¹¶å‘é«˜ï¼šå¤šç”¨æˆ·åŒæ—¶æŸ¥è¯¢æŠ¥è¡¨
â”œâ”€â”€ å®æ—¶æ€§è¦æ±‚ï¼šå¸Œæœ›çœ‹åˆ°æœ€æ–°æ•°æ®
â””â”€â”€ è·¨è¡¨æŸ¥è¯¢ï¼šéœ€è¦å…³è”å¤šä¸ªå¤§è¡¨
```

### 6.2 å¤šçº§ç¼“å­˜æ¶æ„


**ğŸ“¦ ç¼“å­˜å±‚æ¬¡è®¾è®¡**
```
å¤šçº§ç¼“å­˜æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨ç¼“å­˜     â”‚ â† L1ï¼šé™æ€èµ„æºã€é¡µé¢ç¼“å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CDNç¼“å­˜       â”‚ â† L2ï¼šé™æ€æŠ¥è¡¨ã€å›¾ç‰‡æ–‡ä»¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨ç¼“å­˜       â”‚ â† L3ï¼šå†…å­˜ç¼“å­˜ï¼ˆCaffeineï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åˆ†å¸ƒå¼ç¼“å­˜     â”‚ â† L4ï¼šRedisé›†ç¾¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åº“ç¼“å­˜     â”‚ â† L5ï¼šMySQLæŸ¥è¯¢ç¼“å­˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 Redisç¼“å­˜ç­–ç•¥å®ç°


**ğŸ”§ æŠ¥è¡¨æ•°æ®ç¼“å­˜è®¾è®¡**
```java
@Service
public class ReportCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // è·å–æŠ¥è¡¨æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
    public ReportData getReportWithCache(ReportQuery query) {
        
        // 1. ç”Ÿæˆç¼“å­˜é”®
        String cacheKey = generateCacheKey(query);
        
        // 2. ä»Redisè·å–ç¼“å­˜
        ReportData cachedData = (ReportData) redisTemplate.opsForValue().get(cacheKey);
        if (cachedData != null) {
            log.info("å‘½ä¸­ç¼“å­˜ï¼š{}", cacheKey);
            return cachedData;
        }
        
        // 3. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        ReportData reportData = queryReportFromDB(query);
        
        // 4. å†™å…¥ç¼“å­˜ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
        Duration expireTime = calculateExpireTime(query.getReportType());
        redisTemplate.opsForValue().set(cacheKey, reportData, expireTime);
        
        return reportData;
    }
    
    // ç”Ÿæˆç¼“å­˜é”®ï¼ˆåŒ…å«æ‰€æœ‰æŸ¥è¯¢æ¡ä»¶ï¼‰
    private String generateCacheKey(ReportQuery query) {
        return String.format("report:%s:%s:%s:%s", 
            query.getReportType(),
            query.getDateRange(),
            query.getBranchId(),
            DigestUtils.md5Hex(query.getFilterConditions())
        );
    }
    
    // æ ¹æ®æŠ¥è¡¨ç±»å‹è®¾ç½®ç¼“å­˜æ—¶é—´
    private Duration calculateExpireTime(String reportType) {
        switch (reportType) {
            case "REALTIME": return Duration.ofMinutes(5);    // å®æ—¶æŠ¥è¡¨5åˆ†é’Ÿ
            case "DAILY": return Duration.ofHours(2);         // æ—¥æŠ¥2å°æ—¶
            case "MONTHLY": return Duration.ofDays(1);        // æœˆæŠ¥1å¤©
            default: return Duration.ofMinutes(30);           // é»˜è®¤30åˆ†é’Ÿ
        }
    }
}
```

### 6.4 æŠ¥è¡¨æŸ¥è¯¢ä¼˜åŒ–æŠ€æœ¯


**ğŸ“Š é¢„èšåˆæ±‡æ€»è¡¨**
```sql
-- åˆ›å»ºé¢„èšåˆè¡¨ï¼Œæå‰è®¡ç®—å¸¸ç”¨æŒ‡æ ‡
CREATE TABLE pre_agg_daily_summary (
    summary_date DATE,
    branch_id VARCHAR(20),
    product_type VARCHAR(20),
    
    -- é¢„è®¡ç®—çš„æŒ‡æ ‡
    total_customers INT,
    total_accounts INT,
    total_deposits DECIMAL(18,2),
    total_loans DECIMAL(18,2),
    avg_deposit_amount DECIMAL(18,2),
    max_transaction_amount DECIMAL(18,2),
    
    -- æ”¯æŒé’»å–çš„æ˜ç»†
    deposit_customers JSON,  -- å­˜å‚¨å®¢æˆ·IDåˆ—è¡¨
    loan_customers JSON,
    
    PRIMARY KEY (summary_date, branch_id, product_type),
    INDEX idx_date_branch (summary_date, branch_id)
);

-- å®šæ—¶æ›´æ–°é¢„èšåˆè¡¨
INSERT INTO pre_agg_daily_summary
SELECT 
    DATE(trans_date) as summary_date,
    branch_id,
    product_type,
    COUNT(DISTINCT customer_id) as total_customers,
    COUNT(DISTINCT account_id) as total_accounts,
    SUM(CASE WHEN trans_type='DEPOSIT' THEN amount ELSE 0 END) as total_deposits,
    SUM(CASE WHEN trans_type='LOAN' THEN amount ELSE 0 END) as total_loans,
    AVG(CASE WHEN trans_type='DEPOSIT' THEN amount END) as avg_deposit_amount,
    MAX(amount) as max_transaction_amount,
    JSON_ARRAYAGG(CASE WHEN trans_type='DEPOSIT' THEN customer_id END) as deposit_customers,
    JSON_ARRAYAGG(CASE WHEN trans_type='LOAN' THEN customer_id END) as loan_customers
FROM fact_daily_transaction
WHERE DATE(trans_date) = CURDATE() - INTERVAL 1 DAY
GROUP BY DATE(trans_date), branch_id, product_type;
```

**âš¡ æŸ¥è¯¢ä¼˜åŒ–å®ç°**
```java
@Repository
public class OptimizedReportRepository {
    
    // ä½¿ç”¨é¢„èšåˆè¡¨æŸ¥è¯¢ï¼ˆå¿«ï¼‰
    public ReportSummary getReportSummary(String dateRange, String branchId) {
        
        String sql = """
            SELECT 
                summary_date,
                branch_id,
                SUM(total_customers) as total_customers,
                SUM(total_deposits) as total_deposits,
                AVG(avg_deposit_amount) as avg_deposit_amount
            FROM pre_agg_daily_summary
            WHERE summary_date BETWEEN ? AND ?
              AND branch_id = ?
            GROUP BY summary_date, branch_id
            ORDER BY summary_date
        """;
        
        return jdbcTemplate.query(sql, new ReportSummaryRowMapper(), 
                                  parseDate(dateRange.split(",")[0]), 
                                  parseDate(dateRange.split(",")[1]), 
                                  branchId);
    }
    
    // æ˜ç»†æŸ¥è¯¢æ—¶ä½¿ç”¨åˆ†é¡µå’Œç´¢å¼•ä¼˜åŒ–
    public List<TransactionDetail> getTransactionDetails(DetailQuery query) {
        
        StringBuilder sql = new StringBuilder("""
            SELECT t.*, c.customer_name, p.product_name
            FROM fact_daily_transaction t
            INNER JOIN dim_customer c ON t.customer_key = c.customer_key
            INNER JOIN dim_product p ON t.product_key = p.product_key
            WHERE t.date_key BETWEEN ? AND ?
        """);
        
        List<Object> params = new ArrayList<>();
        params.add(query.getStartDateKey());
        params.add(query.getEndDateKey());
        
        // åŠ¨æ€æ·»åŠ è¿‡æ»¤æ¡ä»¶
        if (query.getBranchId() != null) {
            sql.append(" AND t.branch_key = ?");
            params.add(getBranchKey(query.getBranchId()));
        }
        
        // åˆ†é¡µæŸ¥è¯¢
        sql.append(" ORDER BY t.date_key DESC");
        sql.append(" LIMIT ?, ?");
        params.add(query.getOffset());
        params.add(query.getPageSize());
        
        return jdbcTemplate.query(sql.toString(), new TransactionDetailRowMapper(), params.toArray());
    }
}
```

### 6.5 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ä¿è¯**
```java
@Service
public class ReportCacheManager {
    
    // æ•°æ®æ›´æ–°æ—¶ä¸»åŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
    @EventListener
    public void handleDataUpdateEvent(DataUpdateEvent event) {
        
        String dataType = event.getDataType();
        String affectedDate = event.getAffectedDate();
        
        // æ ¹æ®æ•°æ®ç±»å‹æ¸…é™¤ç›¸å…³ç¼“å­˜
        switch (dataType) {
            case "TRANSACTION":
                clearTransactionRelatedCache(affectedDate);
                break;
            case "CUSTOMER":
                clearCustomerRelatedCache(event.getCustomerId());
                break;
        }
    }
    
    private void clearTransactionRelatedCache(String affectedDate) {
        // æ¸…é™¤ç›¸å…³æ—¥æœŸçš„æ‰€æœ‰æŠ¥è¡¨ç¼“å­˜
        String pattern = "report:*:" + affectedDate + ":*";
        Set<String> keys = redisTemplate.keys(pattern);
        
        if (!keys.isEmpty()) {
            redisTemplate.delete(keys);
            log.info("æ¸…é™¤äº¤æ˜“ç›¸å…³ç¼“å­˜ï¼Œå½±å“æ—¥æœŸï¼š{}ï¼Œæ¸…é™¤é”®æ•°é‡ï¼š{}", affectedDate, keys.size());
        }
    }
    
    // å®šæ—¶æ¸…ç†è¿‡æœŸçš„é¢„èšåˆæ•°æ®
    @Scheduled(cron = "0 0 3 * * ?") // æ¯å¤©å‡Œæ™¨3ç‚¹
    public void cleanupExpiredAggregation() {
        
        // æ¸…ç†3ä¸ªæœˆå‰çš„è¯¦ç»†æ•°æ®é¢„èšåˆ
        String sql = """
            DELETE FROM pre_agg_daily_summary 
            WHERE summary_date < DATE_SUB(CURDATE(), INTERVAL 3 MONTH)
        """;
        
        int deletedRows = jdbcTemplate.update(sql);
        log.info("æ¸…ç†è¿‡æœŸé¢„èšåˆæ•°æ®ï¼Œåˆ é™¤è¡Œæ•°ï¼š{}", deletedRows);
    }
}
```

---

## 7. ğŸ“„ æŠ¥è¡¨æ¨¡æ¿ä¸ç‰ˆæœ¬ç®¡ç†


### 7.1 æŠ¥è¡¨æ¨¡æ¿è®¾è®¡ç†å¿µ


**ğŸ¨ ä»€ä¹ˆæ˜¯æŠ¥è¡¨æ¨¡æ¿ï¼Ÿ**
æŠ¥è¡¨æ¨¡æ¿å°±åƒåšPPTçš„æ¯ç‰ˆï¼Œå®šä¹‰äº†æŠ¥è¡¨çš„æ ¼å¼ã€æ ·å¼ã€æ•°æ®æ¥æºç­‰ã€‚æœ‰äº†æ¨¡æ¿ï¼Œå°±å¯ä»¥ç”¨ç›¸åŒçš„æ ¼å¼ç”Ÿæˆä¸åŒæ—¶é—´çš„æŠ¥è¡¨ï¼Œå°±åƒç”¨åŒä¸€ä¸ªæ¨¡å­åšå‡ºå½¢çŠ¶ç›¸åŒçš„é¥¼å¹²ã€‚

**ğŸ”¸ æ¨¡æ¿çš„æ ¸å¿ƒä»·å€¼**
```
ç»Ÿä¸€æ ‡å‡†ï¼š
â€¢ æ‰€æœ‰æŠ¥è¡¨æ ¼å¼ä¿æŒä¸€è‡´
â€¢ é¿å…äººå·¥åˆ¶ä½œå‡ºç°å·®å¼‚

æé«˜æ•ˆç‡ï¼š
â€¢ ä¸€æ¬¡è®¾è®¡ï¼Œå¤šæ¬¡å¤ç”¨
â€¢ è‡ªåŠ¨å¡«å……æ•°æ®ï¼Œæ— éœ€æ‰‹å·¥

ä¾¿äºç»´æŠ¤ï¼š
â€¢ æ ¼å¼è°ƒæ•´åªéœ€ä¿®æ”¹æ¨¡æ¿
â€¢ ç‰ˆæœ¬æ§åˆ¶é¿å…æ··ä¹±
```

### 7.2 æŠ¥è¡¨æ¨¡æ¿æ•°æ®æ¨¡å‹


**ğŸ“‹ æ¨¡æ¿å…ƒæ•°æ®è®¾è®¡**
```sql
-- æŠ¥è¡¨æ¨¡æ¿ä¸»è¡¨
CREATE TABLE report_template (
    template_id VARCHAR(32) PRIMARY KEY,
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(20) NOT NULL,     -- REGULATORY/INTERNAL/CUSTOMER
    report_category VARCHAR(50),            -- èµ„äº§è´Ÿå€ºè¡¨/æŸç›Šè¡¨ç­‰
    template_format VARCHAR(20),            -- EXCEL/PDF/HTML/XBRL
    template_content TEXT,                  -- æ¨¡æ¿å†…å®¹/å¸ƒå±€å®šä¹‰
    data_source_config JSON,               -- æ•°æ®æºé…ç½®
    is_active CHAR(1) DEFAULT '1',
    version VARCHAR(10) DEFAULT '1.0',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    create_user VARCHAR(50),
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    update_user VARCHAR(50),
    
    INDEX idx_type_category (template_type, report_category),
    INDEX idx_active_version (is_active, version)
);

-- æ¨¡æ¿å­—æ®µé…ç½®è¡¨
CREATE TABLE template_field_config (
    config_id VARCHAR(32) PRIMARY KEY,
    template_id VARCHAR(32) NOT NULL,
    field_name VARCHAR(100) NOT NULL,       -- å­—æ®µåç§°
    field_label VARCHAR(100),               -- æ˜¾ç¤ºæ ‡ç­¾
    field_type VARCHAR(20) NOT NULL,        -- NUMBER/STRING/DATE/FORMULA
    data_source VARCHAR(100),               -- æ•°æ®æ¥æºSQL/è®¡ç®—å…¬å¼
    field_position VARCHAR(20),             -- åœ¨æ¨¡æ¿ä¸­çš„ä½ç½®ï¼ˆå¦‚Excelçš„A1ï¼‰
    format_rule VARCHAR(100),               -- æ ¼å¼åŒ–è§„åˆ™ï¼ˆå¦‚åƒåˆ†ä½ã€å°æ•°ä½ï¼‰
    is_required CHAR(1) DEFAULT '1',
    sort_order INT,
    
    FOREIGN KEY (template_id) REFERENCES report_template(template_id)
);
```

**ğŸ¯ æ¨¡æ¿é…ç½®ç¤ºä¾‹**
```json
{
  "template_id": "RPT_BALANCE_SHEET_001",
  "template_name": "èµ„äº§è´Ÿå€ºè¡¨æ¨¡æ¿",
  "data_source_config": {
    "primary_table": "fact_daily_balance",
    "date_field": "report_date",
    "filters": {
      "report_type": "BALANCE_SHEET"
    }
  },
  "fields": [
    {
      "field_name": "total_assets",
      "field_label": "èµ„äº§æ€»è®¡",
      "field_type": "NUMBER",
      "data_source": "SELECT SUM(asset_amount) FROM fact_daily_balance WHERE report_date = ?",
      "field_position": "B10",
      "format_rule": "#,##0.00"
    },
    {
      "field_name": "total_liabilities", 
      "field_label": "è´Ÿå€ºæ€»è®¡",
      "field_type": "NUMBER",
      "data_source": "SELECT SUM(liability_amount) FROM fact_daily_balance WHERE report_date = ?",
      "field_position": "B20",
      "format_rule": "#,##0.00"
    },
    {
      "field_name": "net_assets",
      "field_label": "å‡€èµ„äº§",
      "field_type": "FORMULA",
      "data_source": "=B10-B20",
      "field_position": "B30",
      "format_rule": "#,##0.00"
    }
  ]
}
```

### 7.3 æŠ¥è¡¨æ¨¡æ¿å¼•æ“å®ç°


**âš™ï¸ æ¨¡æ¿è§£æå¼•æ“**
```java
@Service
public class ReportTemplateEngine {
    
    @Autowired
    private ReportTemplateRepository templateRepository;
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    // æ ¹æ®æ¨¡æ¿ç”ŸæˆæŠ¥è¡¨
    public ReportResult generateReportByTemplate(String templateId, Map<String, Object> parameters) {
        
        // 1. åŠ è½½æ¨¡æ¿é…ç½®
        ReportTemplate template = templateRepository.findByIdAndActive(templateId, "1");
        if (template == null) {
            throw new BusinessException("æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²åœç”¨ï¼š" + templateId);
        }
        
        // 2. è§£ææ¨¡æ¿å­—æ®µé…ç½®
        List<TemplateFieldConfig> fieldConfigs = templateRepository.findFieldConfigs(templateId);
        
        // 3. æ‰§è¡Œæ•°æ®æŸ¥è¯¢
        Map<String, Object> reportData = new HashMap<>();
        for (TemplateFieldConfig fieldConfig : fieldConfigs) {
            Object fieldValue = calculateFieldValue(fieldConfig, parameters);
            reportData.put(fieldConfig.getFieldName(), fieldValue);
        }
        
        // 4. ç”ŸæˆæŠ¥è¡¨å†…å®¹
        return generateReportContent(template, reportData);
    }
    
    // è®¡ç®—å­—æ®µå€¼
    private Object calculateFieldValue(TemplateFieldConfig fieldConfig, Map<String, Object> parameters) {
        
        String fieldType = fieldConfig.getFieldType();
        String dataSource = fieldConfig.getDataSource();
        
        switch (fieldType) {
            case "NUMBER":
            case "STRING":
            case "DATE":
                // æ‰§è¡ŒSQLæŸ¥è¯¢
                return executeDataSourceQuery(dataSource, parameters);
                
            case "FORMULA":
                // æ‰§è¡Œå…¬å¼è®¡ç®—
                return calculateFormula(dataSource, parameters);
                
            case "CONSTANT":
                // è¿”å›å¸¸é‡å€¼
                return dataSource;
                
            default:
                throw new BusinessException("ä¸æ”¯æŒçš„å­—æ®µç±»å‹ï¼š" + fieldType);
        }
    }
    
    private Object executeDataSourceQuery(String sql, Map<String, Object> parameters) {
        try {
            // æ›¿æ¢SQLä¸­çš„å‚æ•°å ä½ç¬¦
            String processedSql = processSQL(sql, parameters);
            
            // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆå‡è®¾è¿”å›å•ä¸ªå€¼ï¼‰
            return jdbcTemplate.queryForObject(processedSql, Object.class);
            
        } catch (Exception e) {
            log.error("æ‰§è¡Œæ•°æ®æºæŸ¥è¯¢å¤±è´¥ï¼ŒSQLï¼š{}", sql, e);
            return null;
        }
    }
}
```

### 7.4 æŠ¥è¡¨ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ


**ğŸ“š ç‰ˆæœ¬ç®¡ç†ç­–ç•¥**
```java
@Service
public class ReportVersionManager {
    
    // åˆ›å»ºæ–°ç‰ˆæœ¬æ¨¡æ¿
    public String createNewVersion(String baseTemplateId, String versionDesc) {
        
        // 1. è·å–åŸºç¡€æ¨¡æ¿
        ReportTemplate baseTemplate = getTemplate(baseTemplateId);
        
        // 2. ç”Ÿæˆæ–°ç‰ˆæœ¬å·
        String newVersion = generateNextVersion(baseTemplate.getVersion());
        
        // 3. å¤åˆ¶æ¨¡æ¿å†…å®¹
        ReportTemplate newTemplate = copyTemplate(baseTemplate);
        newTemplate.setTemplateId(generateNewTemplateId());
        newTemplate.setVersion(newVersion);
        newTemplate.setVersionDesc(versionDesc);
        
        // 4. ä¿å­˜æ–°ç‰ˆæœ¬
        templateRepository.save(newTemplate);
        
        // 5. å¤åˆ¶å­—æ®µé…ç½®
        copyFieldConfigs(baseTemplateId, newTemplate.getTemplateId());
        
        log.info("åˆ›å»ºæ¨¡æ¿æ–°ç‰ˆæœ¬æˆåŠŸï¼ŒåŸºç¡€ç‰ˆæœ¬ï¼š{}ï¼Œæ–°ç‰ˆæœ¬ï¼š{}", baseTemplate.getVersion(), newVersion);
        
        return newTemplate.getTemplateId();
    }
    
    // ç‰ˆæœ¬æ¯”è¾ƒ
    public TemplateVersionDiff compareVersions(String templateId1, String templateId2) {
        
        ReportTemplate template1 = getTemplate(templateId1);
        ReportTemplate template2 = getTemplate(templateId2);
        
        TemplateVersionDiff diff = new TemplateVersionDiff();
        diff.setFromVersion(template1.getVersion());
        diff.setToVersion(template2.getVersion());
        
        // æ¯”è¾ƒå­—æ®µé…ç½®å·®å¼‚
        List<TemplateFieldConfig> fields1 = getFieldConfigs(templateId1);
        List<TemplateFieldConfig> fields2 = getFieldConfigs(templateId2);
        
        diff.setAddedFields(findAddedFields(fields1, fields2));
        diff.setRemovedFields(findRemovedFields(fields1, fields2));
        diff.setModifiedFields(findModifiedFields(fields1, fields2));
        
        return diff;
    }
    
    // ç‰ˆæœ¬å›æ»š
    public void rollbackToVersion(String currentTemplateId, String targetVersion) {
        
        // 1. æŸ¥æ‰¾ç›®æ ‡ç‰ˆæœ¬æ¨¡æ¿
        ReportTemplate targetTemplate = findTemplateByVersion(currentTemplateId, targetVersion);
        if (targetTemplate == null) {
            throw new BusinessException("ç›®æ ‡ç‰ˆæœ¬ä¸å­˜åœ¨ï¼š" + targetVersion);
        }
        
        // 2. åœç”¨å½“å‰ç‰ˆæœ¬
        ReportTemplate currentTemplate = getTemplate(currentTemplateId);
        currentTemplate.setIsActive("0");
        templateRepository.update(currentTemplate);
        
        // 3. æ¿€æ´»ç›®æ ‡ç‰ˆæœ¬
        targetTemplate.setIsActive("1");
        templateRepository.update(targetTemplate);
        
        // 4. è®°å½•å›æ»šæ—¥å¿—
        recordVersionChange(currentTemplateId, currentTemplate.getVersion(), targetVersion, "ROLLBACK");
        
        log.info("æ¨¡æ¿ç‰ˆæœ¬å›æ»šæˆåŠŸï¼Œä»{}å›æ»šåˆ°{}", currentTemplate.getVersion(), targetVersion);
    }
}
```

### 7.5 æ¨¡æ¿æƒé™æ§åˆ¶


**ğŸ”’ æ¨¡æ¿è®¿é—®æƒé™è®¾è®¡**
```sql
-- æ¨¡æ¿æƒé™è¡¨
CREATE TABLE template_permission (
    permission_id VARCHAR(32) PRIMARY KEY,
    template_id VARCHAR(32) NOT NULL,
    user_id VARCHAR(32),                    -- ç”¨æˆ·IDï¼ˆå¦‚æœæ˜¯ç”¨æˆ·æƒé™ï¼‰
    role_id VARCHAR(32),                    -- è§’è‰²IDï¼ˆå¦‚æœæ˜¯è§’è‰²æƒé™ï¼‰  
    permission_type VARCHAR(20) NOT NULL,   -- READ/WRITE/EXECUTE/ADMIN
    granted_by VARCHAR(32),                 -- æˆæƒäºº
    granted_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expire_time TIMESTAMP NULL,             -- æƒé™è¿‡æœŸæ—¶é—´
    is_active CHAR(1) DEFAULT '1',
    
    FOREIGN KEY (template_id) REFERENCES report_template(template_id),
    INDEX idx_template_user (template_id, user_id),
    INDEX idx_template_role (template_id, role_id)
);
```

**ğŸ›¡ï¸ æƒé™éªŒè¯å®ç°**
```java
@Component
public class TemplatePermissionChecker {
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¨¡æ¿è®¿é—®æƒé™
    public boolean hasTemplatePermission(String userId, String templateId, String permissionType) {
        
        // 1. æ£€æŸ¥ç›´æ¥ç”¨æˆ·æƒé™
        if (hasDirectUserPermission(userId, templateId, permissionType)) {
            return true;
        }
        
        // 2. æ£€æŸ¥è§’è‰²æƒé™
        List<String> userRoles = getUserRoles(userId);
        for (String roleId : userRoles) {
            if (hasRolePermission(roleId, templateId, permissionType)) {
                return true;
            }
        }
        
        // 3. æ£€æŸ¥æ¨¡æ¿æ˜¯å¦ä¸ºå…¬å¼€æ¨¡æ¿
        return isPublicTemplate(templateId);
    }
    
    // æƒé™éªŒè¯æ³¨è§£
    @Target(ElementType.METHOD)
    @Retention(RetentionPolicy.RUNTIME)
    public @interface RequireTemplatePermission {
        String permission() default "READ";
    }
    
    // AOPæƒé™éªŒè¯åˆ‡é¢
    @Aspect
    @Component
    public class TemplatePermissionAspect {
        
        @Around("@annotation(requirePermission)")
        public Object checkPermission(ProceedingJoinPoint joinPoint, RequireTemplatePermission requirePermission) throws Throwable {
            
            // è·å–å½“å‰ç”¨æˆ·
            String currentUserId = getCurrentUserId();
            
            // è·å–æ¨¡æ¿IDï¼ˆä»æ–¹æ³•å‚æ•°ä¸­æå–ï¼‰
            String templateId = extractTemplateId(joinPoint.getArgs());
            
            // æ£€æŸ¥æƒé™
            if (!hasTemplatePermission(currentUserId, templateId, requirePermission.permission())) {
                throw new AccessDeniedException("æ²¡æœ‰æƒé™è®¿é—®æ¨¡æ¿ï¼š" + templateId);
            }
            
            return joinPoint.proceed();
        }
    }
}
```

---

## 8. ğŸ” æŠ¥è¡¨æƒé™æ§åˆ¶ä¸å®¡æ ¸æµç¨‹


### 8.1 æŠ¥è¡¨æƒé™æ§åˆ¶ä½“ç³»


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
æŠ¥è¡¨æƒé™æ§åˆ¶å°±åƒå…¬å¸çš„æ–‡ä»¶æŸœç®¡ç†ï¼Œä¸åŒçº§åˆ«çš„å‘˜å·¥èƒ½çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ã€‚è´¢åŠ¡æ€»ç›‘èƒ½çœ‹æ‰€æœ‰è´¢åŠ¡æŠ¥è¡¨ï¼Œéƒ¨é—¨ç»ç†åªèƒ½çœ‹è‡ªå·±éƒ¨é—¨çš„ï¼Œæ™®é€šå‘˜å·¥åªèƒ½çœ‹åŸºç¡€ç»Ÿè®¡ã€‚

**ğŸ¯ æƒé™æ§åˆ¶ç»´åº¦**
```
æƒé™æ§åˆ¶çŸ©é˜µï¼š
                â”‚ æŸ¥çœ‹ â”‚ å¯¼å‡º â”‚ ä¿®æ”¹ â”‚ å®¡æ ¸ â”‚ åˆ é™¤ â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
è¶…çº§ç®¡ç†å‘˜      â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚
è´¢åŠ¡æ€»ç›‘        â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚
éƒ¨é—¨ç»ç†        â”‚  âœ“   â”‚  âœ“   â”‚  âœ—   â”‚  âœ—   â”‚  âœ—   â”‚
ä¸šåŠ¡äººå‘˜        â”‚  âœ“   â”‚  âœ—   â”‚  âœ—   â”‚  âœ—   â”‚  âœ—   â”‚
```

### 8.2 åŸºäºRBACçš„æƒé™æ¨¡å‹


**ğŸ‘¥ è§’è‰²æƒé™è®¾è®¡**
```sql
-- è§’è‰²è¡¨
CREATE TABLE sys_role (
    role_id VARCHAR(32) PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL,
    role_code VARCHAR(30) NOT NULL UNIQUE,
    role_desc VARCHAR(200),
    role_level INT DEFAULT 0,              -- è§’è‰²çº§åˆ«ï¼Œæ•°å­—è¶Šå¤§æƒé™è¶Šé«˜
    is_active CHAR(1) DEFAULT '1',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æƒé™è¡¨  
CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY,
    permission_name VARCHAR(50) NOT NULL,
    permission_code VARCHAR(50) NOT NULL UNIQUE,  -- REPORT_VIEW, REPORT_EXPORTç­‰
    resource_type VARCHAR(20),             -- REPORT, TEMPLATE, DATA
    permission_desc VARCHAR(200)
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permission (
    role_id VARCHAR(32),
    permission_id VARCHAR(32),
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id),
    FOREIGN KEY (permission_id) REFERENCES sys_permission(permission_id)
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    user_id VARCHAR(32),
    role_id VARCHAR(32),
    effective_date DATE DEFAULT (CURDATE()),
    expire_date DATE,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id)
);
```

**ğŸ”§ æƒé™éªŒè¯æœåŠ¡å®ç°**
```java
@Service
public class ReportPermissionService {
    
    @Autowired
    private UserRoleRepository userRoleRepository;
    
    // æ£€æŸ¥ç”¨æˆ·æŠ¥è¡¨æƒé™
    public boolean hasReportPermission(String userId, String reportId, String action) {
        
        // 1. è·å–ç”¨æˆ·æ‰€æœ‰æœ‰æ•ˆè§’è‰²
        List<UserRole> userRoles = userRoleRepository.findActiveRolesByUserId(userId);
        
        // 2. è·å–æŠ¥è¡¨æ‰€éœ€æƒé™
        List<String> requiredPermissions = getRequiredPermissions(reportId, action);
        
        // 3. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        for (UserRole userRole : userRoles) {
            if (roleHasPermissions(userRole.getRoleId(), requiredPermissions)) {
                return true;
            }
        }
        
        return false;
    }
    
    // è·å–ç”¨æˆ·å¯è®¿é—®çš„æŠ¥è¡¨åˆ—è¡¨
    public List<ReportInfo> getAccessibleReports(String userId) {
        
        // 1. è·å–ç”¨æˆ·æ‰€æœ‰æƒé™
        Set<String> userPermissions = getUserAllPermissions(userId);
        
        // 2. æŸ¥è¯¢æ‰€æœ‰æŠ¥è¡¨
        List<ReportInfo> allReports = reportRepository.findAllActiveReports();
        
        // 3. è¿‡æ»¤ç”¨æˆ·å¯è®¿é—®çš„æŠ¥è¡¨
        return allReports.stream()
            .filter(report -> hasPermissionForReport(userPermissions, report))
            .collect(Collectors.toList());
    }
    
    private Set<String> getUserAllPermissions(String userId) {
        String sql = """
            SELECT DISTINCT p.permission_code
            FROM sys_permission p
            INNER JOIN role_permission rp ON p.permission_id = rp.permission_id
            INNER JOIN user_role ur ON rp.role_id = ur.role_id
            WHERE ur.user_id = ?
              AND ur.effective_date <= CURDATE()
              AND (ur.expire_date IS NULL OR ur.expire_date >= CURDATE())
        """;
        
        List<String> permissions = jdbcTemplate.queryForList(sql, String.class, userId);
        return new HashSet<>(permissions);
    }
}
```

### 8.3 æŠ¥è¡¨å®¡æ ¸æµç¨‹è®¾è®¡


**ğŸ“‹ å®¡æ ¸æµç¨‹æ¨¡å‹**
```sql
-- æŠ¥è¡¨å®¡æ ¸æµç¨‹è¡¨
CREATE TABLE report_audit_flow (
    flow_id VARCHAR(32) PRIMARY KEY,
    report_id VARCHAR(32) NOT NULL,
    report_type VARCHAR(50),
    report_period VARCHAR(20),              -- æŠ¥è¡¨æœŸé—´
    flow_status VARCHAR(20) DEFAULT 'PENDING', -- PENDING/IN_PROGRESS/APPROVED/REJECTED
    priority_level INT DEFAULT 3,          -- ä¼˜å…ˆçº§ 1-5
    submit_user VARCHAR(32),               -- æäº¤äºº
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    current_step INT DEFAULT 1,           -- å½“å‰å®¡æ ¸æ­¥éª¤
    total_steps INT,                       -- æ€»æ­¥éª¤æ•°
    expected_complete_time TIMESTAMP,      -- æœŸæœ›å®Œæˆæ—¶é—´
    actual_complete_time TIMESTAMP,       -- å®é™…å®Œæˆæ—¶é—´
    
    INDEX idx_status_type (flow_status, report_type),
    INDEX idx_submit_user (submit_user),
    INDEX idx_expected_time (expected_complete_time)
);

-- å®¡æ ¸æ­¥éª¤è¡¨
CREATE TABLE audit_step (
    step_id VARCHAR(32) PRIMARY KEY,
    flow_id VARCHAR(32) NOT NULL,
    step_order INT NOT NULL,               -- æ­¥éª¤é¡ºåº
    step_name VARCHAR(100),                -- æ­¥éª¤åç§°
    auditor_role VARCHAR(50),              -- å®¡æ ¸äººè§’è‰²
    auditor_user VARCHAR(32),              -- å…·ä½“å®¡æ ¸äºº
    audit_result VARCHAR(20),              -- PENDING/PASSED/REJECTED
    audit_comment TEXT,                    -- å®¡æ ¸æ„è§
    audit_time TIMESTAMP,                  -- å®¡æ ¸å®Œæˆæ—¶é—´
    
    FOREIGN KEY (flow_id) REFERENCES report_audit_flow(flow_id),
    INDEX idx_flow_order (flow_id, step_order)
);
```

**ğŸ”„ å®¡æ ¸æµç¨‹å®ç°**
```java
@Service
public class ReportAuditService {
    
    @Autowired
    private AuditFlowRepository auditFlowRepository;
    
    // æäº¤æŠ¥è¡¨å®¡æ ¸
    public String submitReportForAudit(ReportAuditRequest request) {
        
        // 1. åˆ›å»ºå®¡æ ¸æµç¨‹
        ReportAuditFlow auditFlow = new ReportAuditFlow();
        auditFlow.setFlowId(generateFlowId());
        auditFlow.setReportId(request.getReportId());
        auditFlow.setReportType(request.getReportType());
        auditFlow.setSubmitUser(request.getSubmitUserId());
        auditFlow.setFlowStatus("PENDING");
        
        // 2. æ ¹æ®æŠ¥è¡¨ç±»å‹è®¾ç½®å®¡æ ¸æ­¥éª¤
        List<AuditStep> auditSteps = createAuditSteps(request.getReportType());
        auditFlow.setTotalSteps(auditSteps.size());
        
        // 3. ä¿å­˜å®¡æ ¸æµç¨‹
        auditFlowRepository.save(auditFlow);
        
        // 4. ä¿å­˜å®¡æ ¸æ­¥éª¤
        for (AuditStep step : auditSteps) {
            step.setFlowId(auditFlow.getFlowId());
            auditFlowRepository.saveAuditStep(step);
        }
        
        // 5. å‘é€å®¡æ ¸é€šçŸ¥
        sendAuditNotification(auditFlow, auditSteps.get(0));
        
        log.info("æŠ¥è¡¨æäº¤å®¡æ ¸æˆåŠŸï¼Œæµç¨‹IDï¼š{}", auditFlow.getFlowId());
        return auditFlow.getFlowId();
    }
    
    // å¤„ç†å®¡æ ¸ç»“æœ
    public void processAuditResult(String flowId, AuditDecision decision) {
        
        // 1. è·å–å½“å‰å®¡æ ¸æµç¨‹
        ReportAuditFlow auditFlow = auditFlowRepository.findById(flowId);
        if (auditFlow == null) {
            throw new BusinessException("å®¡æ ¸æµç¨‹ä¸å­˜åœ¨ï¼š" + flowId);
        }
        
        // 2. æ›´æ–°å½“å‰æ­¥éª¤ç»“æœ
        AuditStep currentStep = getCurrentAuditStep(flowId);
        currentStep.setAuditResult(decision.getResult());
        currentStep.setAuditComment(decision.getComment());
        currentStep.setAuditUser(decision.getAuditorId());
        currentStep.setAuditTime(new Timestamp(System.currentTimeMillis()));
        auditFlowRepository.updateAuditStep(currentStep);
        
        // 3. æ ¹æ®å®¡æ ¸ç»“æœå†³å®šä¸‹ä¸€æ­¥
        if ("REJECTED".equals(decision.getResult())) {
            // æ‹’ç»ï¼šç»“æŸæµç¨‹
            auditFlow.setFlowStatus("REJECTED");
            auditFlow.setActualCompleteTime(new Timestamp(System.currentTimeMillis()));
            sendRejectNotification(auditFlow, decision.getComment());
            
        } else if ("PASSED".equals(decision.getResult())) {
            // é€šè¿‡ï¼šè¿›å…¥ä¸‹ä¸€æ­¥æˆ–å®Œæˆ
            if (auditFlow.getCurrentStep() < auditFlow.getTotalSteps()) {
                // è¿˜æœ‰ä¸‹ä¸€æ­¥å®¡æ ¸
                auditFlow.setCurrentStep(auditFlow.getCurrentStep() + 1);
                auditFlow.setFlowStatus("IN_PROGRESS");
                
                AuditStep nextStep = getNextAuditStep(flowId, auditFlow.getCurrentStep());
                sendAuditNotification(auditFlow, nextStep);
                
            } else {
                // å®¡æ ¸å®Œæˆ
                auditFlow.setFlowStatus("APPROVED");
                auditFlow.setActualCompleteTime(new Timestamp(System.currentTimeMillis()));
                handleReportApproved(auditFlow);
            }
        }
        
        auditFlowRepository.updateAuditFlow(auditFlow);
    }
}
```

### 8.4 æ•°æ®è¡Œçº§æƒé™æ§åˆ¶


**ğŸ” æ•°æ®æƒé™è¿‡æ»¤**
```java
@Component  
public class DataPermissionFilter {
    
    // æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤æŸ¥è¯¢ç»“æœ
    @Around("@annotation(dataPermission)")
    public Object filterDataByPermission(ProceedingJoinPoint joinPoint, DataPermission dataPermission) throws Throwable {
        
        String currentUserId = getCurrentUserId();
        
        // 1. è·å–ç”¨æˆ·æ•°æ®æƒé™èŒƒå›´
        DataScope dataScope = getUserDataScope(currentUserId);
        
        // 2. ä¿®æ”¹SQLæŸ¥è¯¢æ¡ä»¶
        Object[] args = joinPoint.getArgs();
        for (int i = 0; i < args.length; i++) {
            if (args[i] instanceof QueryCondition) {
                QueryCondition condition = (QueryCondition) args[i];
                applyDataScopeFilter(condition, dataScope);
                break;
            }
        }
        
        return joinPoint.proceed(args);
    }
    
    private void applyDataScopeFilter(QueryCondition condition, DataScope dataScope) {
        
        switch (dataScope.getScopeType()) {
            case "ALL":
                // æ— é™åˆ¶
                break;
                
            case "BRANCH":
                // åªèƒ½çœ‹æœ¬æœºæ„æ•°æ®
                condition.addFilter("branch_id", "IN", dataScope.getBranchIds());
                break;
                
            case "DEPT":
                // åªèƒ½çœ‹æœ¬éƒ¨é—¨æ•°æ®  
                condition.addFilter("dept_id", "IN", dataScope.getDeptIds());
                break;
                
            case "USER":
                // åªèƒ½çœ‹è‡ªå·±åˆ›å»ºçš„æ•°æ®
                condition.addFilter("create_user", "=", dataScope.getUserId());
                break;
        }
    }
}
```

---

## 9. ğŸ” æŠ¥è¡¨æ•°æ®è¡€ç¼˜ä¸è´¨é‡ç›‘æ§


### 9.1 æ•°æ®è¡€ç¼˜å…³ç³»è¿½è¸ª


**ğŸ§¬ ä»€ä¹ˆæ˜¯æ•°æ®è¡€ç¼˜ï¼Ÿ**
æ•°æ®è¡€ç¼˜å°±åƒå®¶æ—æ—è°±ï¼Œè®°å½•æ¯ä¸ªæ•°æ®çš„"çˆ¶æ¯"å’Œ"å­å¥³"å…³ç³»ã€‚æ¯”å¦‚æœˆåº¦åˆ©æ¶¦è¡¨ä¸­çš„"è¥ä¸šæ”¶å…¥"æ¥è‡ªæ—¥äº¤æ˜“æµæ°´è¡¨ï¼Œç»è¿‡äº†å“ªäº›è®¡ç®—æ­¥éª¤ï¼Œæœ€ç»ˆå˜æˆäº†å“ªäº›å…¶ä»–æŠ¥è¡¨çš„è¾“å…¥ã€‚

**ğŸ”¸ è¡€ç¼˜å…³ç³»çš„ä»·å€¼**
```
é—®é¢˜è¿½æº¯ï¼š
â€¢ æŠ¥è¡¨æ•°æ®æœ‰é—®é¢˜æ—¶ï¼Œèƒ½å¿«é€Ÿå®šä½æºå¤´
â€¢ äº†è§£æ•°æ®ä»å“ªæ¥ï¼Œç»è¿‡ä»€ä¹ˆå¤„ç†

å½±å“åˆ†æï¼š
â€¢ ä¿®æ”¹æºè¡¨ç»“æ„å‰ï¼ŒçŸ¥é“ä¼šå½±å“å“ªäº›æŠ¥è¡¨
â€¢ è¯„ä¼°å˜æ›´çš„é£é™©èŒƒå›´

æ•°æ®æ²»ç†ï¼š
â€¢ æ¢³ç†æ•°æ®æµå‘ï¼Œä¼˜åŒ–å¤„ç†é“¾è·¯
â€¢ è¯†åˆ«é‡å¤è®¡ç®—ï¼Œæå‡æ•ˆç‡
```

### 9.2 è¡€ç¼˜å…³ç³»æ•°æ®æ¨¡å‹


**ğŸ“Š è¡€ç¼˜å…ƒæ•°æ®è®¾è®¡**
```sql
-- æ•°æ®èµ„äº§è¡¨ï¼ˆè¡€ç¼˜èŠ‚ç‚¹ï¼‰
CREATE TABLE data_asset (
    asset_id VARCHAR(32) PRIMARY KEY,
    asset_name VARCHAR(100) NOT NULL,
    asset_type VARCHAR(20) NOT NULL,       -- TABLE/VIEW/REPORT/FIELD
    asset_path VARCHAR(500),               -- å®Œæ•´è·¯å¾„ï¼Œå¦‚ db.schema.table.field
    asset_desc VARCHAR(500),
    owner_user VARCHAR(32),                -- æ•°æ®èµ„äº§è´Ÿè´£äºº
    business_domain VARCHAR(50),           -- ä¸šåŠ¡åŸŸ
    technical_domain VARCHAR(50),          -- æŠ€æœ¯åŸŸ
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_type_domain (asset_type, business_domain),
    INDEX idx_path (asset_path)
);

-- è¡€ç¼˜å…³ç³»è¡¨
CREATE TABLE data_lineage (
    lineage_id VARCHAR(32) PRIMARY KEY,
    source_asset_id VARCHAR(32) NOT NULL,     -- æºæ•°æ®èµ„äº§
    target_asset_id VARCHAR(32) NOT NULL,     -- ç›®æ ‡æ•°æ®èµ„äº§  
    relation_type VARCHAR(20) NOT NULL,       -- DERIVE/COPY/AGGREGATE/JOIN
    transform_logic TEXT,                     -- è½¬æ¢é€»è¾‘SQL/ä»£ç 
    confidence_score DECIMAL(3,2) DEFAULT 1.0, -- ç½®ä¿¡åº¦åˆ†æ•°
    create_method VARCHAR(20),                -- åˆ›å»ºæ–¹å¼ï¼šAUTO/MANUAL
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (source_asset_id) REFERENCES data_asset(asset_id),
    FOREIGN KEY (target_asset_id) REFERENCES data_asset(asset_id),
    INDEX idx_source (source_asset_id),
    INDEX idx_target (target_asset_id)
);

-- è¡€ç¼˜å˜æ›´å†å²è¡¨
CREATE TABLE lineage_change_history (
    history_id VARCHAR(32) PRIMARY KEY,
    lineage_id VARCHAR(32) NOT NULL,
    change_type VARCHAR(20) NOT NULL,        -- CREATE/UPDATE/DELETE
    old_transform_logic TEXT,
    new_transform_logic TEXT,
    change_reason VARCHAR(500),
    change_user VARCHAR(32),
    change_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (lineage_id) REFERENCES data_lineage(lineage_id)
);
```

### 9.3 è‡ªåŠ¨åŒ–è¡€ç¼˜è§£æå®ç°


**ğŸ¤– SQLè§£æè¡€ç¼˜å…³ç³»**
```java
@Component
public class LineageAnalyzer {
    
    @Autowired
    private DataAssetRepository assetRepository;
    
    // è§£æSQLè·å–è¡€ç¼˜å…³ç³»
    public List<DataLineage> analyzeSQLLineage(String sql, String targetAssetId) {
        
        try {
            // 1. ä½¿ç”¨SQLè§£æå™¨è§£æSQL
            Statement stmt = CCJSqlParserUtil.parse(sql);
            
            // 2. æå–æºè¡¨å’Œå­—æ®µ
            LineageVisitor visitor = new LineageVisitor();
            stmt.accept(visitor);
            
            // 3. æ„å»ºè¡€ç¼˜å…³ç³»
            List<DataLineage> lineages = new ArrayList<>();
            
            for (TableInfo table : visitor.getSourceTables()) {
                DataAsset sourceAsset = findOrCreateAsset(table.getTableName(), "TABLE");
                
                DataLineage lineage = new DataLineage();
                lineage.setLineageId(generateLineageId());
                lineage.setSourceAssetId(sourceAsset.getAssetId());
                lineage.setTargetAssetId(targetAssetId);
                lineage.setRelationType(determineRelationType(sql));
                lineage.setTransformLogic(sql);
                lineage.setCreateMethod("AUTO");
                
                lineages.add(lineage);
            }
            
            return lineages;
            
        } catch (JSQLParserException e) {
            log.error("SQLè§£æå¤±è´¥ï¼š{}", sql, e);
            return Collections.emptyList();
        }
    }
    
    // è‡ªå®šä¹‰SQLè®¿é—®å™¨ï¼Œæå–è¡¨å’Œå­—æ®µä¿¡æ¯
    private static class LineageVisitor implements SelectVisitor, FromItemVisitor {
        private List<TableInfo> sourceTables = new ArrayList<>();
        private Map<String, List<String>> tableFields = new HashMap<>();
        
        @Override
        public void visit(PlainSelect plainSelect) {
            // è®¿é—®FROMå­å¥
            plainSelect.getFromItem().accept(this);
            
            // è®¿é—®JOINå­å¥
            if (plainSelect.getJoins() != null) {
                for (Join join : plainSelect.getJoins()) {
                    join.getRightItem().accept(this);
                }
            }
            
            // è®¿é—®SELECTå­—æ®µ
            for (SelectItem selectItem : plainSelect.getSelectItems()) {
                if (selectItem instanceof SelectExpressionItem) {
                    SelectExpressionItem item = (SelectExpressionItem) selectItem;
                    extractFieldsFromExpression(item.getExpression());
                }
            }
        }
        
        @Override
        public void visit(Table table) {
            String tableName = table.getName();
            sourceTables.add(new TableInfo(tableName, table.getSchemaName()));
        }
        
        // æå–å­—æ®µä¿¡æ¯çš„è¾…åŠ©æ–¹æ³•
        private void extractFieldsFromExpression(Expression expr) {
            if (expr instanceof Column) {
                Column column = (Column) expr;
                String tableName = column.getTable() != null ? column.getTable().getName() : "";
                String fieldName = column.getColumnName();
                
                tableFields.computeIfAbsent(tableName, k -> new ArrayList<>()).add(fieldName);
            }
        }
        
        public List<TableInfo> getSourceTables() { return sourceTables; }
        public Map<String, List<String>> getTableFields() { return tableFields; }
    }
}
```

### 9.4 æŠ¥è¡¨è´¨é‡ç›‘æ§ä½“ç³»


**ğŸ“ è´¨é‡ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class ReportQualityMonitor {
    
    // æ•°æ®è´¨é‡æ£€æŸ¥è§„åˆ™
    public class QualityRule {
        private String ruleName;
        private String ruleType;        // NOT_NULL/RANGE/FORMAT/CONSISTENCY
        private String checkSQL;
        private String expectedResult;
        private int severityLevel;      // 1-ä¸¥é‡ 2-è­¦å‘Š 3-æç¤º
    }
    
    // æ‰§è¡ŒæŠ¥è¡¨è´¨é‡æ£€æŸ¥
    @Scheduled(cron = "0 30 2 * * ?") // æ¯å¤©å‡Œæ™¨2:30æ‰§è¡Œ
    public void executeQualityCheck() {
        
        List<String> reportIds = getActiveReportIds();
        
        for (String reportId : reportIds) {
            try {
                QualityCheckResult result = checkReportQuality(reportId);
                saveQualityCheckResult(result);
                
                // è´¨é‡é—®é¢˜å‘Šè­¦
                if (result.hasHighSeverityIssues()) {
                    sendQualityAlert(reportId, result);
                }
                
            } catch (Exception e) {
                log.error("æŠ¥è¡¨è´¨é‡æ£€æŸ¥å¤±è´¥ï¼ŒæŠ¥è¡¨IDï¼š{}", reportId, e);
            }
        }
    }
    
    private QualityCheckResult checkReportQuality(String reportId) {
        
        QualityCheckResult result = new QualityCheckResult(reportId);
        
        // 1. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
        checkDataCompleteness(reportId, result);
        
        // 2. æ•°æ®å‡†ç¡®æ€§æ£€æŸ¥
        checkDataAccuracy(reportId, result);
        
        // 3. æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
        checkDataConsistency(reportId, result);
        
        // 4. æ—¶æ•ˆæ€§æ£€æŸ¥
        checkDataTimeliness(reportId, result);
        
        return result;
    }
    
    // æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    private void checkDataCompleteness(String reportId, QualityCheckResult result) {
        
        // æ£€æŸ¥å¿…å¡«å­—æ®µæ˜¯å¦æœ‰ç©ºå€¼
        String sql = """
            SELECT 
                COUNT(*) as total_rows,
                COUNT(CASE WHEN customer_name IS NULL THEN 1 END) as null_customer_name,
                COUNT(CASE WHEN trans_amount IS NULL THEN 1 END) as null_amount,
                COUNT(CASE WHEN trans_date IS NULL THEN 1 END) as null_date
            FROM report_data 
            WHERE report_id = ?
        """;
        
        Map<String, Object> checkResult = jdbcTemplate.queryForMap(sql, reportId);
        
        int totalRows = (Integer) checkResult.get("total_rows");
        int nullCustomerName = (Integer) checkResult.get("null_customer_name");
        int nullAmount = (Integer) checkResult.get("null_amount");
        int nullDate = (Integer) checkResult.get("null_date");
        
        // è®°å½•é—®é¢˜
        if (nullCustomerName > 0) {
            result.addIssue(new QualityIssue("DATA_COMPLETENESS", 
                "å®¢æˆ·åç§°å­—æ®µå­˜åœ¨ç©ºå€¼", nullCustomerName + "/" + totalRows, 2));
        }
        
        if (nullAmount > 0) {
            result.addIssue(new QualityIssue("DATA_COMPLETENESS", 
                "äº¤æ˜“é‡‘é¢å­—æ®µå­˜åœ¨ç©ºå€¼", nullAmount + "/" + totalRows, 1)); // ä¸¥é‡é—®é¢˜
        }
    }
}
```

### 9.5 æ•°æ®è´¨é‡è¯„åˆ†æœºåˆ¶


**â­ è´¨é‡è¯„åˆ†ç®—æ³•**
```java
@Service
public class DataQualityScoreCalculator {
    
    // è®¡ç®—æŠ¥è¡¨è´¨é‡ç»¼åˆå¾—åˆ†
    public QualityScore calculateQualityScore(String reportId, String checkPeriod) {
        
        // 1. è·å–è´¨é‡æ£€æŸ¥ç»“æœ
        List<QualityCheckResult> checkResults = getQualityCheckResults(reportId, checkPeriod);
        
        // 2. è®¡ç®—å„ç»´åº¦å¾—åˆ†
        double completenessScore = calculateCompletenessScore(checkResults);
        double accuracyScore = calculateAccuracyScore(checkResults);
        double consistencyScore = calculateConsistencyScore(checkResults);
        double timelinessScore = calculateTimelinessScore(checkResults);
        
        // 3. åŠ æƒè®¡ç®—ç»¼åˆå¾—åˆ†
        double totalScore = 
            completenessScore * 0.3 +  // å®Œæ•´æ€§æƒé‡30%
            accuracyScore * 0.4 +      // å‡†ç¡®æ€§æƒé‡40%
            consistencyScore * 0.2 +   // ä¸€è‡´æ€§æƒé‡20%
            timelinessScore * 0.1;     // æ—¶æ•ˆæ€§æƒé‡10%
        
        // 4. ç¡®å®šè´¨é‡ç­‰çº§
        String qualityLevel = getQualityLevel(totalScore);
        
        QualityScore score = new QualityScore();
        score.setReportId(reportId);
        score.setCheckPeriod(checkPeriod);
        score.setTotalScore(totalScore);
        score.setQualityLevel(qualityLevel);
        score.setCompletenessScore(completenessScore);
        score.setAccuracyScore(accuracyScore);
        score.setConsistencyScore(consistencyScore);
        score.setTimelinessScore(timelinessScore);
        
        return score;
    }
    
    private String getQualityLevel(double score) {
        if (score >= 95) return "ä¼˜ç§€";
        else if (score >= 85) return "è‰¯å¥½";
        else if (score >= 75) return "ä¸€èˆ¬";
        else if (score >= 60) return "è¾ƒå·®";
        else return "å¾ˆå·®";
    }
    
    // æ•°æ®å®Œæ•´æ€§å¾—åˆ†è®¡ç®—
    private double calculateCompletenessScore(List<QualityCheckResult> results) {
        
        int totalChecks = 0;
        int passedChecks = 0;
        
        for (QualityCheckResult result : results) {
            for (QualityIssue issue : result.getIssues()) {
                if ("DATA_COMPLETENESS".equals(issue.getIssueType())) {
                    totalChecks++;
                    if (issue.getSeverityLevel() >= 3) { // è½»å¾®é—®é¢˜ä¹Ÿç®—é€šè¿‡
                        passedChecks++;
                    }
                }
            }
        }
        
        return totalChecks == 0 ? 100.0 : (double) passedChecks / totalChecks * 100;
    }
}
```

---

## 10. â° æŠ¥è¡¨è‡ªåŠ¨åŒ–è°ƒåº¦ä¸ç›‘æ§


### 10.1 æŠ¥è¡¨è°ƒåº¦ç³»ç»Ÿè®¾è®¡


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
æŠ¥è¡¨è°ƒåº¦å°±åƒå®¶é‡Œçš„å®šæ—¶å™¨ï¼Œè®¾å®šå¥½æ—¶é—´å’Œä»»åŠ¡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨æŒ‡å®šæ—¶é—´ç”Ÿæˆå„ç§æŠ¥è¡¨ã€‚å°±åƒå®šæ—¶ç…®é¥­çš„ç”µé¥­ç…²ï¼Œåˆ°ç‚¹å°±è‡ªåŠ¨å¼€å§‹å·¥ä½œï¼Œä¸éœ€è¦äººå·¥å¹²é¢„ã€‚

**ğŸ“… è°ƒåº¦ç­–ç•¥è®¾è®¡**
```sql
-- æŠ¥è¡¨è°ƒåº¦ä»»åŠ¡è¡¨
CREATE TABLE report_schedule_job (
    job_id VARCHAR(32) PRIMARY KEY,
    job_name VARCHAR(100) NOT NULL,
    report_template_id VARCHAR(32),         -- å…³è”æŠ¥è¡¨æ¨¡æ¿
    cron_expression VARCHAR(50),            -- Cronè¡¨è¾¾å¼
    time_zone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    job_status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE/PAUSED/STOPPED
    job_type VARCHAR(20),                   -- DAILY/WEEKLY/MONTHLY/YEARLY
    priority INT DEFAULT 5,                 -- ä¼˜å…ˆçº§1-10
    max_retry_count INT DEFAULT 3,          -- æœ€å¤§é‡è¯•æ¬¡æ•°
    retry_interval INT DEFAULT 300,         -- é‡è¯•é—´éš”(ç§’)
    timeout_seconds INT DEFAULT 3600,       -- ä»»åŠ¡è¶…æ—¶æ—¶é—´
    
    -- ä¸šåŠ¡å‚æ•°
    business_date_offset INT DEFAULT -1,    -- ä¸šåŠ¡æ—¥æœŸåç§»(å¤©)
    auto_email CHAR(1) DEFAULT 'N',        -- æ˜¯å¦è‡ªåŠ¨å‘é‚®ä»¶
    email_recipients TEXT,                  -- é‚®ä»¶æ¥æ”¶äºº
    
    -- å…ƒæ•°æ®
    create_user VARCHAR(32),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_user VARCHAR(32),
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_status_priority (job_status, priority),
    INDEX idx_cron_expr (cron_expression)
);

-- è°ƒåº¦æ‰§è¡Œå†å²è¡¨
CREATE TABLE schedule_execution_history (
    execution_id VARCHAR(32) PRIMARY KEY,
    job_id VARCHAR(32) NOT NULL,
    execution_time TIMESTAMP NOT NULL,      -- æ‰§è¡Œæ—¶é—´
    business_date DATE,                     -- ä¸šåŠ¡æ—¥æœŸ
    execution_status VARCHAR(20),           -- SUCCESS/FAILED/RUNNING/TIMEOUT
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    duration_seconds INT,                   -- æ‰§è¡Œè€—æ—¶
    retry_count INT DEFAULT 0,
    error_message TEXT,                     -- é”™è¯¯ä¿¡æ¯
    execution_result JSON,                  -- æ‰§è¡Œç»“æœè¯¦æƒ…
    
    FOREIGN KEY (job_id) REFERENCES report_schedule_job(job_id),
    INDEX idx_job_time (job_id, execution_time),
    INDEX idx_status_date (execution_status, business_date)
);
```

### 10.2 è°ƒåº¦å¼•æ“å®ç°


**âš™ï¸ Springè°ƒåº¦å™¨é›†æˆ**
```java
@Component
public class ReportScheduleManager {
    
    @Autowired
    private TaskScheduler taskScheduler;
    
    @Autowired
    private ReportJobRepository jobRepository;
    
    private final Map<String, ScheduledFuture<?>> scheduledTasks = new ConcurrentHashMap<>();
    
    // ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰è°ƒåº¦ä»»åŠ¡
    @PostConstruct
    public void initializeScheduledJobs() {
        
        List<ReportScheduleJob> activeJobs = jobRepository.findByStatus("ACTIVE");
        
        for (ReportScheduleJob job : activeJobs) {
            try {
                scheduleReportJob(job);
                log.info("è°ƒåº¦ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼š{}", job.getJobName());
            } catch (Exception e) {
                log.error("è°ƒåº¦ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼š{}", job.getJobName(), e);
            }
        }
        
        log.info("è°ƒåº¦ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå…±å¯åŠ¨{}ä¸ªä»»åŠ¡", activeJobs.size());
    }
    
    // è°ƒåº¦å•ä¸ªæŠ¥è¡¨ä»»åŠ¡
    public void scheduleReportJob(ReportScheduleJob job) {
        
        // åœæ­¢å·²å­˜åœ¨çš„ä»»åŠ¡
        stopScheduledJob(job.getJobId());
        
        // åˆ›å»ºæ–°çš„è°ƒåº¦ä»»åŠ¡
        Runnable task = () -> executeReportJob(job);
        
        CronTrigger cronTrigger = new CronTrigger(
            job.getCronExpression(), 
            TimeZone.getTimeZone(job.getTimeZone())
        );
        
        ScheduledFuture<?> scheduledTask = taskScheduler.schedule(task, cronTrigger);
        scheduledTasks.put(job.getJobId(), scheduledTask);
        
        log.info("æŠ¥è¡¨ä»»åŠ¡å·²è°ƒåº¦ï¼š{}, Cron: {}", job.getJobName(), job.getCronExpression());
    }
    
    // æ‰§è¡ŒæŠ¥è¡¨ä»»åŠ¡
    private void executeReportJob(ReportScheduleJob job) {
        
        String executionId = generateExecutionId();
        LocalDate businessDate = calculateBusinessDate(job.getBusinessDateOffset());
        
        // è®°å½•æ‰§è¡Œå¼€å§‹
        ScheduleExecutionHistory execution = new ScheduleExecutionHistory();
        execution.setExecutionId(executionId);
        execution.setJobId(job.getJobId());
        execution.setBusinessDate(businessDate);
        execution.setExecutionStatus("RUNNING");
        execution.setStartTime(new Timestamp(System.currentTimeMillis()));
        execution.setExecutionTime(new Timestamp(System.currentTimeMillis()));
        
        try {
            // æ‰§è¡ŒæŠ¥è¡¨ç”Ÿæˆ
            ReportExecutionContext context = new ReportExecutionContext();
            context.setJobId(job.getJobId());
            context.setBusinessDate(businessDate);
            context.setExecutionId(executionId);
            
            ReportResult result = executeReportGeneration(job, context);
            
            // æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºæˆåŠŸ
            execution.setExecutionStatus("SUCCESS");
            execution.setEndTime(new Timestamp(System.currentTimeMillis()));
            execution.setDurationSeconds((int) (execution.getEndTime().getTime() - execution.getStartTime().getTime()) / 1000);
            execution.setExecutionResult(JsonUtil.toJson(result));
            
            // å‘é€æˆåŠŸé€šçŸ¥
            if ("Y".equals(job.getAutoEmail())) {
                sendReportCompletionEmail(job, result);
            }
            
            log.info("æŠ¥è¡¨ä»»åŠ¡æ‰§è¡ŒæˆåŠŸï¼š{}, ä¸šåŠ¡æ—¥æœŸï¼š{}, è€—æ—¶ï¼š{}ç§’", 
                job.getJobName(), businessDate, execution.getDurationSeconds());
                
        } catch (Exception e) {
            // æ›´æ–°æ‰§è¡ŒçŠ¶æ€ä¸ºå¤±è´¥
            execution.setExecutionStatus("FAILED");
            execution.setEndTime(new Timestamp(System.currentTimeMillis()));
            execution.setErrorMessage(e.getMessage());
            
            // é‡è¯•é€»è¾‘
            handleJobFailure(job, execution, e);
            
            log.error("æŠ¥è¡¨ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š{}, ä¸šåŠ¡æ—¥æœŸï¼š{}", job.getJobName(), businessDate, e);
        } finally {
            // ä¿å­˜æ‰§è¡Œå†å²
            jobRepository.saveExecutionHistory(execution);
        }
    }
}
```

### 10.3 æ™ºèƒ½é‡è¯•ä¸å®¹é”™æœºåˆ¶


**ğŸ”„ é‡è¯•ç­–ç•¥å®ç°**
```java
@Component
public class ReportJobRetryHandler {
    
    // å¤„ç†ä»»åŠ¡å¤±è´¥å’Œé‡è¯•
    public void handleJobFailure(ReportScheduleJob job, ScheduleExecutionHistory execution, Exception error) {
        
        int currentRetryCount = execution.getRetryCount();
        int maxRetryCount = job.getMaxRetryCount();
        
        if (currentRetryCount < maxRetryCount) {
            // è¿˜å¯ä»¥é‡è¯•
            scheduleRetry(job, execution, currentRetryCount + 1);
        } else {
            // é‡è¯•æ¬¡æ•°è€—å°½ï¼Œå‘é€å‘Šè­¦
            sendJobFailureAlert(job, execution, error);
            
            // æ ¹æ®ä»»åŠ¡é‡è¦æ€§å†³å®šæ˜¯å¦æš‚åœ
            if (job.getPriority() <= 3) { // é«˜ä¼˜å…ˆçº§ä»»åŠ¡
                // æš‚åœä»»åŠ¡ï¼Œé¿å…æŒç»­å¤±è´¥
                pauseJob(job.getJobId());
            }
        }
    }
    
    // å®‰æ’é‡è¯•æ‰§è¡Œ
    private void scheduleRetry(ReportScheduleJob job, ScheduleExecutionHistory execution, int retryCount) {
        
        // è®¡ç®—é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
        int baseInterval = job.getRetryInterval();
        int retryDelay = baseInterval * (int) Math.pow(2, retryCount - 1);
        
        log.info("å®‰æ’ä»»åŠ¡é‡è¯•ï¼š{}, ç¬¬{}æ¬¡é‡è¯•ï¼Œå»¶è¿Ÿ{}ç§’", job.getJobName(), retryCount, retryDelay);
        
        // å¼‚æ­¥è°ƒåº¦é‡è¯•
        CompletableFuture.delayedExecutor(retryDelay, TimeUnit.SECONDS)
            .execute(() -> retryJobExecution(job, execution, retryCount));
    }
    
    private void retryJobExecution(ReportScheduleJob job, ScheduleExecutionHistory originalExecution, int retryCount) {
        
        try {
            // åˆ›å»ºé‡è¯•æ‰§è¡Œè®°å½•
            ScheduleExecutionHistory retryExecution = createRetryExecution(originalExecution, retryCount);
            
            // æ‰§è¡ŒæŠ¥è¡¨ç”Ÿæˆ
            ReportExecutionContext context = new ReportExecutionContext();
            context.setJobId(job.getJobId());
            context.setBusinessDate(originalExecution.getBusinessDate());
            context.setExecutionId(retryExecution.getExecutionId());
            context.setRetryCount(retryCount);
            
            ReportResult result = executeReportGeneration(job, context);
            
            // é‡è¯•æˆåŠŸ
            retryExecution.setExecutionStatus("SUCCESS");
            retryExecution.setEndTime(new Timestamp(System.currentTimeMillis()));
            retryExecution.setExecutionResult(JsonUtil.toJson(result));
            
            log.info("æŠ¥è¡¨ä»»åŠ¡é‡è¯•æˆåŠŸï¼š{}, é‡è¯•æ¬¡æ•°ï¼š{}", job.getJobName(), retryCount);
            
        } catch (Exception e) {
            // é‡è¯•è¿˜æ˜¯å¤±è´¥
            retryExecution.setExecutionStatus("FAILED");
            retryExecution.setErrorMessage(e.getMessage());
            
            // ç»§ç»­é‡è¯•æµç¨‹
            handleJobFailure(job, retryExecution, e);
            
            log.error("æŠ¥è¡¨ä»»åŠ¡é‡è¯•å¤±è´¥ï¼š{}, é‡è¯•æ¬¡æ•°ï¼š{}", job.getJobName(), retryCount, e);
        } finally {
            jobRepository.saveExecutionHistory(retryExecution);
        }
    }
}
```

### 10.4 æŠ¥è¡¨ç›‘æ§ä»ªè¡¨æ¿


**ğŸ“Š ç›‘æ§æŒ‡æ ‡è®¾è®¡**
```java
@RestController
@RequestMapping("/api/report/monitor")
public class ReportMonitorController {
    
    @Autowired
    private ReportMonitorService monitorService;
    
    // è·å–æŠ¥è¡¨æ‰§è¡Œæ¦‚è§ˆ
    @GetMapping("/dashboard")
    public ReportMonitorDashboard getDashboard(@RequestParam(defaultValue = "7") int days) {
        
        ReportMonitorDashboard dashboard = new ReportMonitorDashboard();
        
        // 1. æ‰§è¡Œç»Ÿè®¡
        ExecutionStatistics stats = monitorService.getExecutionStatistics(days);
        dashboard.setExecutionStats(stats);
        
        // 2. æˆåŠŸç‡è¶‹åŠ¿
        List<SuccessRateTrend> successTrends = monitorService.getSuccessRateTrend(days);
        dashboard.setSuccessRateTrends(successTrends);
        
        // 3. å¹³å‡æ‰§è¡Œæ—¶é—´
        List<PerformanceTrend> performanceTrends = monitorService.getPerformanceTrend(days);
        dashboard.setPerformanceTrends(performanceTrends);
        
        // 4. å¤±è´¥ä»»åŠ¡Top10
        List<FailedJobSummary> failedJobs = monitorService.getTopFailedJobs(days, 10);
        dashboard.setTopFailedJobs(failedJobs);
        
        // 5. èµ„æºä½¿ç”¨æƒ…å†µ
        ResourceUsage resourceUsage = monitorService.getResourceUsage();
        dashboard.setResourceUsage(resourceUsage);
        
        return dashboard;
    }
    
    // è·å–ä»»åŠ¡å¥åº·åº¦è¯„åˆ†
    @GetMapping("/health-score/{jobId}")
    public JobHealthScore getJobHealthScore(@PathVariable String jobId, @RequestParam(defaultValue = "30") int days) {
        
        return monitorService.calculateJobHealthScore(jobId, days);
    }
}

@Service
public class ReportMonitorService {
    
    // è®¡ç®—ä»»åŠ¡å¥åº·åº¦è¯„åˆ†
    public JobHealthScore calculateJobHealthScore(String jobId, int days) {
        
        // è·å–æ‰§è¡Œå†å²æ•°æ®
        List<ScheduleExecutionHistory> executions = getExecutionHistory(jobId, days);
        
        if (executions.isEmpty()) {
            return new JobHealthScore(jobId, 0, "æ— æ‰§è¡Œè®°å½•");
        }
        
        // 1. æˆåŠŸç‡å¾—åˆ†ï¼ˆ40%æƒé‡ï¼‰
        double successRate = calculateSuccessRate(executions);
        double successScore = successRate * 0.4;
        
        // 2. ç¨³å®šæ€§å¾—åˆ†ï¼ˆ30%æƒé‡ï¼‰
        double stabilityScore = calculateStabilityScore(executions) * 0.3;
        
        // 3. æ€§èƒ½å¾—åˆ†ï¼ˆ20%æƒé‡ï¼‰
        double performanceScore = calculatePerformanceScore(executions) * 0.2;
        
        // 4. åŠæ—¶æ€§å¾—åˆ†ï¼ˆ10%æƒé‡ï¼‰
        double timelinessScore = calculateTimelinessScore(executions) * 0.1;
        
        // ç»¼åˆå¾—åˆ†
        double totalScore = successScore + stabilityScore + performanceScore + timelinessScore;
        
        JobHealthScore healthScore = new JobHealthScore();
        healthScore.setJobId(jobId);
        healthScore.setHealthScore(Math.round(totalScore));
        healthScore.setSuccessRate(successRate);
        healthScore.setAvgDuration(calculateAvgDuration(executions));
        healthScore.setLastExecutionTime(getLastExecutionTime(executions));
        healthScore.setHealthLevel(getHealthLevel(totalScore));
        
        return healthScore;
    }
    
    private String getHealthLevel(double score) {
        if (score >= 90) return "ä¼˜ç§€";
        else if (score >= 80) return "è‰¯å¥½";
        else if (score >= 70) return "ä¸€èˆ¬";
        else if (score >= 60) return "è¾ƒå·®";
        else return "å¾ˆå·®";
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æŠ¥è¡¨ç³»ç»Ÿæ¶æ„ï¼šåˆ†å±‚è®¾è®¡ï¼Œå‰ç«¯å±•ç¤ºâ†’åº”ç”¨æœåŠ¡â†’æ•°æ®å¤„ç†â†’å­˜å‚¨
ğŸ”¸ æ•°æ®å»ºæ¨¡ï¼šç»´åº¦å»ºæ¨¡ï¼ˆæ˜Ÿå‹/é›ªèŠ±ï¼‰ï¼Œäº‹å®è¡¨+ç»´åº¦è¡¨è®¾è®¡
ğŸ”¸ å®æ—¶æŠ¥è¡¨ï¼šç¼“å­˜ç­–ç•¥ï¼Œè§¦å‘å™¨æ›´æ–°ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
ğŸ”¸ ç›‘ç®¡æŠ¥è¡¨ï¼šXBRL/FIXåè®®ï¼Œè‡ªåŠ¨åŒ–ç”Ÿæˆï¼Œåˆè§„æ£€æŸ¥
ğŸ”¸ æ•°æ®ä»“åº“ï¼šOLAP vs OLTPï¼ŒETLå¤„ç†ï¼Œå¤šç»´åˆ†æ
ğŸ”¸ ç¼“å­˜ä¼˜åŒ–ï¼šå¤šçº§ç¼“å­˜ï¼Œé¢„èšåˆè¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½è°ƒä¼˜
ğŸ”¸ æ¨¡æ¿ç®¡ç†ï¼šç‰ˆæœ¬æ§åˆ¶ï¼Œæƒé™ç®¡ç†ï¼Œé…ç½®åŒ–ç”Ÿæˆ
ğŸ”¸ æ•°æ®è¡€ç¼˜ï¼šå…³ç³»è¿½è¸ªï¼Œå½±å“åˆ†æï¼Œè´¨é‡ç›‘æ§
ğŸ”¸ è°ƒåº¦ç›‘æ§ï¼šè‡ªåŠ¨åŒ–æ‰§è¡Œï¼Œæ™ºèƒ½é‡è¯•ï¼Œå¥åº·åº¦è¯„åˆ†
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æŠ¥è¡¨ç³»ç»Ÿçš„æœ¬è´¨**
```
æ ¸å¿ƒä»·å€¼ï¼š
â€¢ å°†ä¸šåŠ¡æ•°æ®è½¬æ¢ä¸ºå†³ç­–ä¿¡æ¯
â€¢ æ»¡è¶³ç›‘ç®¡åˆè§„è¦æ±‚
â€¢ æå‡æ•°æ®åˆ†ææ•ˆç‡

è®¾è®¡åŸåˆ™ï¼š
â€¢ æ•°æ®å‡†ç¡®æ€§ç¬¬ä¸€
â€¢ ç³»ç»Ÿç¨³å®šæ€§ä¿éšœ  
â€¢ ç”¨æˆ·ä½“éªŒå‹å¥½
â€¢ ç»´æŠ¤æˆæœ¬å¯æ§
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç‚¹**
```
æ•°æ®å±‚é¢ï¼š
â€¢ åˆç†çš„åˆ†åŒºå’Œç´¢å¼•è®¾è®¡
â€¢ é¢„èšåˆå’Œç‰©åŒ–è§†å›¾
â€¢ å†å²æ•°æ®å½’æ¡£ç­–ç•¥

ç¼“å­˜å±‚é¢ï¼š
â€¢ å¤šçº§ç¼“å­˜æ¶æ„
â€¢ æ™ºèƒ½ç¼“å­˜æ›´æ–°
â€¢ ç¼“å­˜ä¸€è‡´æ€§ä¿è¯

è®¡ç®—å±‚é¢ï¼š
â€¢ å¼‚æ­¥å¤„ç†æœºåˆ¶
â€¢ å¹¶è¡Œè®¡ç®—ä¼˜åŒ–
â€¢ èµ„æºæ± åŒ–ç®¡ç†
```

**ğŸ”¹ é‡‘èè¡Œä¸šç‰¹æ®Šè¦æ±‚**
```
åˆè§„æ€§ï¼š
â€¢ ä¸¥æ ¼çš„ç›‘ç®¡æŠ¥è¡¨è¦æ±‚
â€¢ æ•°æ®ä¸å¯ç¯¡æ”¹
â€¢ å®Œæ•´çš„å®¡è®¡è½¨è¿¹

å®‰å…¨æ€§ï¼š
â€¢ ç»†ç²’åº¦æƒé™æ§åˆ¶
â€¢ æ•°æ®è„±æ•ä¿æŠ¤
â€¢ ä¼ è¾“åŠ å¯†å­˜å‚¨

å¯é æ€§ï¼š
â€¢ 7x24å°æ—¶è¿è¡Œ
â€¢ æ•°æ®é›¶ä¸¢å¤±
â€¢ å¿«é€Ÿæ•…éšœæ¢å¤
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**
- **ç›‘ç®¡åˆè§„**ï¼šè‡ªåŠ¨ç”Ÿæˆå„ç±»ç›‘ç®¡æŠ¥è¡¨ï¼Œé™ä½åˆè§„é£é™©
- **å†³ç­–æ”¯æŒ**ï¼šæä¾›å‡†ç¡®åŠæ—¶çš„ç»è¥åˆ†ææ•°æ®
- **æ•ˆç‡æå‡**ï¼šä»æ‰‹å·¥åˆ¶è¡¨åˆ°è‡ªåŠ¨åŒ–ç”Ÿæˆï¼Œæ•ˆç‡æå‡80%ä»¥ä¸Š
- **æˆæœ¬æ§åˆ¶**ï¼šå‡å°‘äººå·¥æŠ•å…¥ï¼Œé™ä½æ“ä½œé£é™©

**âš™ï¸ æŠ€æœ¯ä»·å€¼**
- **æ¶æ„è®¾è®¡**ï¼šåˆ†å±‚è§£è€¦ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜+é¢„èšåˆï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´ä»åˆ†é’Ÿçº§åˆ°ç§’çº§
- **æ•°æ®æ²»ç†**ï¼šè¡€ç¼˜å…³ç³»ç®¡ç†ï¼Œæ•°æ®è´¨é‡ç›‘æ§
- **è¿ç»´ä¿éšœ**ï¼šè‡ªåŠ¨åŒ–è°ƒåº¦ï¼Œæ™ºèƒ½ç›‘æ§å‘Šè­¦

### 11.4 å¼€å‘å®è·µè¦ç‚¹


**ğŸ¯ è®¾è®¡é˜¶æ®µ**
- [ ] å……åˆ†äº†è§£ä¸šåŠ¡éœ€æ±‚å’Œç›‘ç®¡è¦æ±‚
- [ ] è®¾è®¡åˆç†çš„æ•°æ®æ¨¡å‹å’Œæ¶æ„
- [ ] è€ƒè™‘ç³»ç»Ÿæ‰©å±•æ€§å’Œç»´æŠ¤æ€§
- [ ] åˆ¶å®šè¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡

**ğŸ’» å¼€å‘é˜¶æ®µ** 
- [ ] éµå¾ªåˆ†å±‚æ¶æ„å’Œè®¾è®¡æ¨¡å¼
- [ ] é‡è§†å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- [ ] ç¼–å†™å®Œå–„çš„å•å…ƒæµ‹è¯•
- [ ] æ³¨é‡ä»£ç è´¨é‡å’Œæ–‡æ¡£

**ğŸš€ ä¸Šçº¿é˜¶æ®µ**
- [ ] å……åˆ†çš„åŠŸèƒ½æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•
- [ ] åˆ¶å®šè¯¦ç»†çš„ä¸Šçº¿å’Œå›æ»šæ–¹æ¡ˆ
- [ ] å‡†å¤‡ç›‘æ§å‘Šè­¦å’Œåº”æ€¥é¢„æ¡ˆ
- [ ] åšå¥½ç”¨æˆ·åŸ¹è®­å’Œæ”¯æŒ

**ğŸ”§ è¿ç»´é˜¶æ®µ**
- [ ] å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
- [ ] å®šæœŸçš„æ€§èƒ½è°ƒä¼˜å’Œå®¹é‡è§„åˆ’
- [ ] æŒç»­çš„ç³»ç»Ÿä¼˜åŒ–å’ŒåŠŸèƒ½è¿­ä»£
- [ ] åŠæ—¶çš„é—®é¢˜å“åº”å’Œå¤„ç†

### 11.5 å­¦ä¹ è¿›é˜¶å»ºè®®


**ğŸ“š åŸºç¡€çŸ¥è¯†å·©å›º**
- æ·±å…¥ç†è§£æ•°æ®ä»“åº“ç†è®ºå’Œå®è·µ
- æŒæ¡SQLä¼˜åŒ–å’Œæ•°æ®åº“è°ƒä¼˜
- å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿå’Œå¾®æœåŠ¡æ¶æ„
- äº†è§£é‡‘èä¸šåŠ¡å’Œç›‘ç®¡è¦æ±‚

**ğŸ› ï¸ æŠ€æœ¯æŠ€èƒ½æå‡**
- ç†Ÿç»ƒä½¿ç”¨ä¸»æµæŠ¥è¡¨å·¥å…·ï¼ˆå¦‚Tableauã€PowerBIï¼‰
- æŒæ¡å¤§æ•°æ®å¤„ç†æŠ€æœ¯ï¼ˆSparkã€Flinkç­‰ï¼‰
- å­¦ä¹ äº‘è®¡ç®—å’Œå®¹å™¨åŒ–éƒ¨ç½²
- æå‡ç³»ç»Ÿè®¾è®¡å’Œæ¶æ„èƒ½åŠ›

**ğŸ’¡ å®è·µé¡¹ç›®å»ºè®®**
- æ­å»ºä¸ªäººæ•°æ®åˆ†æç¯å¢ƒ
- å‚ä¸å¼€æºæŠ¥è¡¨é¡¹ç›®å¼€å‘
- è®¾è®¡å’Œå®ç°å°å‹æŠ¥è¡¨ç³»ç»Ÿ
- å…³æ³¨è¡Œä¸šæœ€ä½³å®è·µæ¡ˆä¾‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ•°æ®å»ºæ¨¡æ˜Ÿå‹å¥½ï¼Œç»´åº¦äº‹å®è¦åˆ†æ¸…
- å®æ—¶æŠ¥è¡¨ç¼“å­˜å¦™ï¼Œå¤šçº§è®¾è®¡æ€§èƒ½é«˜  
- ç›‘ç®¡åˆè§„è¦åšåˆ°ï¼ŒXBRLåè®®ä¸èƒ½å°‘
- è¡€ç¼˜è¿½è¸ªè´¨é‡ä¿ï¼Œè°ƒåº¦ç›‘æ§è¿ç»´å¥½
- é‡‘èæŠ¥è¡¨è´£ä»»é‡ï¼Œå‡†ç¡®åŠæ—¶æ˜¯æ ¹æœ¬