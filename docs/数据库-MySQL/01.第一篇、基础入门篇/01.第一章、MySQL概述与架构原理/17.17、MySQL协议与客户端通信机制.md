---
title: 17ã€MySQLåè®®ä¸å®¢æˆ·ç«¯é€šä¿¡æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [MySQLç½‘ç»œåè®®åŸºç¡€æ¦‚å¿µ](#1-MySQLç½‘ç»œåè®®åŸºç¡€æ¦‚å¿µ)
2. [å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šä¿¡æµç¨‹](#2-å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šä¿¡æµç¨‹)
3. [åè®®åŒ…ç»“æ„æ·±åº¦åˆ†æ](#3-åè®®åŒ…ç»“æ„æ·±åº¦åˆ†æ)
4. [å‘½ä»¤ç±»å‹ä¸å“åº”æœºåˆ¶](#4-å‘½ä»¤ç±»å‹ä¸å“åº”æœºåˆ¶)
5. [åè®®ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†](#5-åè®®ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†)
6. [ç½‘ç»œä¼˜åŒ–é…ç½®ç­–ç•¥](#6-ç½‘ç»œä¼˜åŒ–é…ç½®ç­–ç•¥)
7. [åè®®å®‰å…¨æ€§ä¿éšœæœºåˆ¶](#7-åè®®å®‰å…¨æ€§ä¿éšœæœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ MySQLç½‘ç»œåè®®åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯MySQLåè®®


**ğŸ”¸ MySQLåè®®çš„æœ¬è´¨**
```
MySQLåè®®æ˜¯ä»€ä¹ˆï¼š
â€¢ åº”ç”¨å±‚åè®®ï¼Œè¿è¡Œåœ¨TCPä¹‹ä¸Š
â€¢ å®šä¹‰å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´çš„é€šä¿¡è§„èŒƒ
â€¢ åŒ…æ‹¬è¿æ¥å»ºç«‹ã€è®¤è¯ã€æŸ¥è¯¢æ‰§è¡Œã€ç»“æœè¿”å›ç­‰æµç¨‹
â€¢ æ˜¯æ‰€æœ‰MySQLå®¢æˆ·ç«¯å¿…é¡»éµå¾ªçš„é€šä¿¡æ ‡å‡†

é€šä¿¡æ¨¡å¼ï¼š
å®¢æˆ·ç«¯å‘èµ·è¿æ¥ â†’ æœåŠ¡å™¨æ¡æ‰‹ â†’ è®¤è¯éªŒè¯ â†’ å‘½ä»¤æ‰§è¡Œ â†’ ç»“æœè¿”å›
```

**ğŸ’¡ åè®®ç‰¹ç‚¹è§£æ**
```
äºŒè¿›åˆ¶åè®®ï¼š
â€¢ æ•°æ®ä»¥äºŒè¿›åˆ¶æ ¼å¼ä¼ è¾“ï¼Œæ•ˆç‡é«˜
â€¢ æ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„åŸç”Ÿç¼–ç 
â€¢ æ¯”æ–‡æœ¬åè®®æ›´èŠ‚çœå¸¦å®½

è¯·æ±‚-å“åº”æ¨¡å¼ï¼š
â€¢ å®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼ŒæœåŠ¡å™¨è¿”å›ç»“æœ
â€¢ æ”¯æŒç®¡é“åŒ–ï¼Œå¯ä»¥è¿ç»­å‘é€å¤šä¸ªå‘½ä»¤
â€¢ å¼‚æ­¥å¤„ç†ï¼Œæ”¯æŒå¹¶å‘æ“ä½œ

çŠ¶æ€ä¿æŒï¼š
â€¢ è¿æ¥æœŸé—´ç»´æŠ¤ä¼šè¯çŠ¶æ€
â€¢ äº‹åŠ¡çŠ¶æ€ã€å˜é‡è®¾ç½®ç­‰åœ¨è¿æ¥ä¸­ä¿æŒ
â€¢ æ”¯æŒå‡†å¤‡è¯­å¥çš„çŠ¶æ€ç®¡ç†
```

### 1.2 åè®®æ¶æ„å±‚æ¬¡


**ğŸ—ï¸ ç½‘ç»œé€šä¿¡æ ˆç»“æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åº”ç”¨ç¨‹åº                 â”‚ â† Java/PHP/Pythonç­‰åº”ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     MySQLé©±åŠ¨ç¨‹åº            â”‚ â† JDBC/PDO/PyMySQLç­‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     MySQLåè®®å±‚             â”‚ â† æœ¬ç« é‡ç‚¹è®²è§£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     TCPä¼ è¾“å±‚               â”‚ â† å¯é ä¼ è¾“ä¿è¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     IPç½‘ç»œå±‚                â”‚ â† è·¯ç”±å¯»å€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     ä»¥å¤ªç½‘æ•°æ®é“¾è·¯å±‚          â”‚ â† ç‰©ç†ä¼ è¾“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 åè®®çš„é‡è¦ä½œç”¨


**ğŸ¯ ä¸ºä»€ä¹ˆè¦äº†è§£MySQLåè®®**
```
å¼€å‘è§’åº¦ï¼š
â€¢ ç†è§£è¿æ¥æ± çš„å·¥ä½œåŸç†
â€¢ ä¼˜åŒ–æ•°æ®åº“è¿æ¥å‚æ•°
â€¢ æ’æŸ¥ç½‘ç»œé€šä¿¡é—®é¢˜
â€¢ å®ç°è‡ªå®šä¹‰MySQLå®¢æˆ·ç«¯

è¿ç»´è§’åº¦ï¼š
â€¢ ç›‘æ§ç½‘ç»œæµé‡å’Œè¿æ¥çŠ¶æ€
â€¢ é…ç½®ç½‘ç»œè¶…æ—¶å‚æ•°
â€¢ è¯Šæ–­è¿æ¥ä¸­æ–­é—®é¢˜
â€¢ å®ç°æ•°æ®åº“ä»£ç†å’Œè´Ÿè½½å‡è¡¡

å®‰å…¨è§’åº¦ï¼š
â€¢ ç†è§£è®¤è¯æœºåˆ¶
â€¢ é…ç½®SSLåŠ å¯†ä¼ è¾“
â€¢ é˜²èŒƒåè®®å±‚æ”»å‡»
â€¢ å®ç°è®¿é—®æ§åˆ¶ç­–ç•¥
```

---

## 2. ğŸ¤ å®¢æˆ·ç«¯æœåŠ¡ç«¯é€šä¿¡æµç¨‹


### 2.1 è¿æ¥å»ºç«‹å®Œæ•´æµç¨‹


**ğŸ”„ è¿æ¥å»ºç«‹æ—¶åºå›¾**
```
å®¢æˆ·ç«¯                          MySQLæœåŠ¡å™¨
   |                               |
   |----[1] TCPè¿æ¥å»ºç«‹----------->|
   |<---[2] æ¡æ‰‹åˆå§‹åŒ–åŒ…-----------|
   |                               |
   |----[3] è®¤è¯å“åº”åŒ…------------>|
   |<---[4] è®¤è¯ç»“æœåŒ…-------------|
   |                               |
   |----[5] SQLå‘½ä»¤åŒ…------------->|
   |<---[6] ç»“æœé›†åŒ…---------------|
   |                               |
   |----[7] è¿æ¥å…³é—­è¯·æ±‚---------->|
   |<---[8] è¿æ¥å…³é—­ç¡®è®¤-----------|
```

**ğŸ“‹ è¯¦ç»†æ­¥éª¤è§£æ**
```bash
# æ­¥éª¤1ï¼šTCPè¿æ¥å»ºç«‹
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šSYN
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼šSYN-ACK  
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼šACK
# TCPä¸‰æ¬¡æ¡æ‰‹å®Œæˆ

# æ­¥éª¤2ï¼šæœåŠ¡å™¨æ¡æ‰‹åŒ…
æœåŠ¡å™¨ä¸»åŠ¨å‘é€æ¡æ‰‹åˆå§‹åŒ–åŒ…ï¼ŒåŒ…å«ï¼š
â€¢ åè®®ç‰ˆæœ¬å·
â€¢ æœåŠ¡å™¨ç‰ˆæœ¬å­—ç¬¦ä¸²
â€¢ è¿æ¥IDï¼ˆçº¿ç¨‹IDï¼‰
â€¢ è®¤è¯æ’ä»¶ä¿¡æ¯
â€¢ æœåŠ¡å™¨èƒ½åŠ›æ ‡å¿—
â€¢ å­—ç¬¦é›†ä¿¡æ¯
â€¢ æœåŠ¡å™¨çŠ¶æ€æ ‡å¿—

# æ­¥éª¤3ï¼šå®¢æˆ·ç«¯è®¤è¯åŒ…
å®¢æˆ·ç«¯å‘é€è®¤è¯å“åº”åŒ…ï¼ŒåŒ…å«ï¼š
â€¢ å®¢æˆ·ç«¯èƒ½åŠ›æ ‡å¿—
â€¢ æœ€å¤§åŒ…å¤§å°
â€¢ å­—ç¬¦é›†ç¼–å·
â€¢ ç”¨æˆ·å
â€¢ å¯†ç ï¼ˆåŠ å¯†åï¼‰
â€¢ è¿æ¥çš„æ•°æ®åº“å

# æ­¥éª¤4ï¼šè®¤è¯ç»“æœ
æœåŠ¡å™¨è¿”å›è®¤è¯ç»“æœï¼š
â€¢ OKåŒ…ï¼šè®¤è¯æˆåŠŸ
â€¢ ERRåŒ…ï¼šè®¤è¯å¤±è´¥ï¼ŒåŒ…å«é”™è¯¯ä¿¡æ¯
```

### 2.2 è®¤è¯æœºåˆ¶è¯¦è§£


**ğŸ” è®¤è¯è¿‡ç¨‹æ·±åº¦åˆ†æ**
```
MySQL 8.0 è®¤è¯æ’ä»¶ï¼š
â€¢ caching_sha2_passwordï¼ˆé»˜è®¤ï¼‰
â€¢ mysql_native_passwordï¼ˆå…¼å®¹ï¼‰
â€¢ sha256_passwordï¼ˆå®‰å…¨ï¼‰

è®¤è¯æ•°æ®ç”Ÿæˆè¿‡ç¨‹ï¼š
1. æœåŠ¡å™¨ç”Ÿæˆ20å­—èŠ‚éšæœºæ•°ï¼ˆsaltï¼‰
2. å®¢æˆ·ç«¯ä½¿ç”¨å¯†ç +saltç”Ÿæˆhash
3. æœåŠ¡å™¨éªŒè¯hashæ˜¯å¦åŒ¹é…
4. è¿”å›è®¤è¯ç»“æœ
```

**ğŸ”§ è®¤è¯è¿‡ç¨‹ç¤ºä¾‹ä»£ç **
```python
# ç®€åŒ–çš„è®¤è¯è¿‡ç¨‹ä¼ªä»£ç 
def mysql_authenticate(username, password, salt):
    # 1. å¯¹å¯†ç è¿›è¡ŒSHA1å“ˆå¸Œ
    password_hash1 = sha1(password.encode())
    
    # 2. å¯¹å“ˆå¸Œç»“æœå†æ¬¡å“ˆå¸Œ
    password_hash2 = sha1(password_hash1)
    
    # 3. å°†saltå’Œç¬¬äºŒæ¬¡å“ˆå¸Œç»“æœæ‹¼æ¥åå“ˆå¸Œ
    salted_hash = sha1(salt + password_hash2)
    
    # 4. ç¬¬ä¸€æ¬¡å“ˆå¸Œä¸saltå“ˆå¸Œå¼‚æˆ–
    auth_response = bytes(a ^ b for a, b in zip(password_hash1, salted_hash))
    
    return auth_response

# å®é™…ä½¿ç”¨ç¤ºä¾‹
salt = b'\x12\x34\x56...'  # æœåŠ¡å™¨æä¾›çš„salt
auth_data = mysql_authenticate('user', 'password123', salt)
```

### 2.3 ä¼šè¯çŠ¶æ€ç®¡ç†


**ğŸ“Š è¿æ¥çŠ¶æ€ç»´æŠ¤**
```
è¿æ¥çŠ¶æ€ä¿¡æ¯ï¼š
â€¢ å½“å‰æ•°æ®åº“ï¼ˆUSE databaseï¼‰
â€¢ å­—ç¬¦é›†è®¾ç½®ï¼ˆSET NAMESï¼‰
â€¢ ä¼šè¯å˜é‡ï¼ˆSET @var = valueï¼‰
â€¢ äº‹åŠ¡çŠ¶æ€ï¼ˆBEGIN/COMMIT/ROLLBACKï¼‰
â€¢ ä¸´æ—¶è¡¨å®šä¹‰
â€¢ å‡†å¤‡è¯­å¥ç¼“å­˜

çŠ¶æ€åŒæ­¥æœºåˆ¶ï¼š
æœåŠ¡å™¨åœ¨æ¯ä¸ªå“åº”åŒ…ä¸­éƒ½ä¼šåŒ…å«å½“å‰çŠ¶æ€æ ‡å¿—
å®¢æˆ·ç«¯æ ¹æ®çŠ¶æ€æ ‡å¿—æ›´æ–°æœ¬åœ°çŠ¶æ€ä¿¡æ¯
```

**ğŸ’¡ ä¼šè¯å˜é‡ç¤ºä¾‹**
```sql
-- è®¾ç½®ä¼šè¯å˜é‡
SET @user_id = 12345;
SET SESSION sql_mode = 'STRICT_TRANS_TABLES';

-- æŸ¥çœ‹å½“å‰è¿æ¥çŠ¶æ€
SHOW STATUS LIKE 'Threads_connected';
SELECT CONNECTION_ID();

-- äº‹åŠ¡çŠ¶æ€ç®¡ç†
BEGIN;
INSERT INTO users (name) VALUES ('å¼ ä¸‰');
-- è¿æ¥ä¸­æ–­é‡è¿åï¼Œäº‹åŠ¡çŠ¶æ€ä¸¢å¤±
-- éœ€è¦é‡æ–°å¼€å§‹äº‹åŠ¡
```

---

## 3. ğŸ“¦ åè®®åŒ…ç»“æ„æ·±åº¦åˆ†æ


### 3.1 åŸºç¡€åŒ…æ ¼å¼


**ğŸ”¸ MySQLåè®®åŒ…é€šç”¨ç»“æ„**
```
åè®®åŒ…æ ¼å¼ï¼ˆæ‰€æœ‰åŒ…éƒ½éµå¾ªï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è½½è·é•¿åº¦   â”‚   åºåˆ—å·    â”‚    è½½è·æ•°æ®   â”‚             â”‚
â”‚   (3å­—èŠ‚)   â”‚   (1å­—èŠ‚)   â”‚   (å˜é•¿)     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å­—æ®µè¯¦è§£ï¼š
â€¢ è½½è·é•¿åº¦ï¼šåé¢æ•°æ®çš„å­—èŠ‚æ•°ï¼ˆä¸åŒ…æ‹¬å¤´éƒ¨4å­—èŠ‚ï¼‰
â€¢ åºåˆ—å·ï¼šåŒ…çš„åºåˆ—ç¼–å·ï¼Œä»0å¼€å§‹é€’å¢
â€¢ è½½è·æ•°æ®ï¼šå…·ä½“çš„å‘½ä»¤æˆ–å“åº”æ•°æ®
```

**ğŸ’» åŒ…å¤´è§£æä»£ç ç¤ºä¾‹**
```python
def parse_packet_header(data):
    """è§£æMySQLåè®®åŒ…å¤´"""
    if len(data) < 4:
        raise ValueError("æ•°æ®åŒ…å¤´ä¸å®Œæ•´")
    
    # è½½è·é•¿åº¦ï¼šå°ç«¯åº3å­—èŠ‚
    payload_length = int.from_bytes(data[0:3], byteorder='little')
    
    # åºåˆ—å·ï¼š1å­—èŠ‚
    sequence_id = data[3]
    
    return {
        'payload_length': payload_length,
        'sequence_id': sequence_id,
        'total_length': payload_length + 4
    }

# ä½¿ç”¨ç¤ºä¾‹
packet_data = b'\x1a\x00\x00\x00...'  # å®é™…ç½‘ç»œæ•°æ®
header_info = parse_packet_header(packet_data)
print(f"è½½è·é•¿åº¦: {header_info['payload_length']}")
print(f"åºåˆ—å·: {header_info['sequence_id']}")
```

### 3.2 æ¡æ‰‹åˆå§‹åŒ–åŒ…ç»“æ„


**ğŸ¤ æœåŠ¡å™¨æ¡æ‰‹åŒ…è¯¦ç»†åˆ†æ**
```
æ¡æ‰‹åˆå§‹åŒ–åŒ…ï¼ˆServer Greetingï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åè®®ç‰ˆæœ¬(1)  â”‚ æœåŠ¡å™¨ç‰ˆæœ¬   â”‚  è¿æ¥ID(4)   â”‚ auth-plugin- â”‚
â”‚              â”‚    (nullç»“å°¾) â”‚              â”‚ data-part-1  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¿‡æ»¤å™¨(1)    â”‚ èƒ½åŠ›æ ‡å¿—(2)  â”‚  å­—ç¬¦é›†(1)   â”‚ çŠ¶æ€æ ‡å¿—(2)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èƒ½åŠ›æ ‡å¿—æ‰©å±• â”‚ è®¤è¯æ’ä»¶é•¿åº¦ â”‚ ä¿ç•™å­—æ®µ(10) â”‚ auth-plugin- â”‚
â”‚    (2)      â”‚     (1)      â”‚              â”‚ data-part-2  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚              â”‚              â”‚ è®¤è¯æ’ä»¶åç§°  â”‚
â”‚              â”‚              â”‚              â”‚  (nullç»“å°¾)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®å­—æ®µå«ä¹‰ï¼š
â€¢ åè®®ç‰ˆæœ¬ï¼šé€šå¸¸æ˜¯10
â€¢ æœåŠ¡å™¨ç‰ˆæœ¬ï¼šå¦‚"8.0.28-MySQL Community Server"
â€¢ è¿æ¥IDï¼šæ­¤è¿æ¥çš„å”¯ä¸€æ ‡è¯†
â€¢ èƒ½åŠ›æ ‡å¿—ï¼šæœåŠ¡å™¨æ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§
â€¢ å­—ç¬¦é›†ï¼šæœåŠ¡å™¨é»˜è®¤å­—ç¬¦é›†
â€¢ è®¤è¯æ’ä»¶ï¼šä½¿ç”¨çš„è®¤è¯æ–¹æ³•
```

### 3.3 å‘½ä»¤åŒ…ä¸å“åº”åŒ…


**ğŸ“ å‘½ä»¤åŒ…ç»“æ„åˆ†æ**
```
å®¢æˆ·ç«¯å‘½ä»¤åŒ…æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒ…å¤´(4)    â”‚  å‘½ä»¤ç±»å‹   â”‚   å‘½ä»¤æ•°æ®   â”‚
â”‚             â”‚   (1å­—èŠ‚)   â”‚   (å˜é•¿)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¸¸ç”¨å‘½ä»¤ç±»å‹ï¼š
â€¢ 0x03ï¼šCOM_QUERYï¼ˆæ‰§è¡ŒSQLæŸ¥è¯¢ï¼‰
â€¢ 0x01ï¼šCOM_QUITï¼ˆå…³é—­è¿æ¥ï¼‰
â€¢ 0x02ï¼šCOM_INIT_DBï¼ˆé€‰æ‹©æ•°æ®åº“ï¼‰
â€¢ 0x16ï¼šCOM_STMT_PREPAREï¼ˆå‡†å¤‡è¯­å¥ï¼‰
â€¢ 0x17ï¼šCOM_STMT_EXECUTEï¼ˆæ‰§è¡Œå‡†å¤‡è¯­å¥ï¼‰
```

**ğŸ“Š å“åº”åŒ…ç±»å‹è¯¦è§£**
```
æœåŠ¡å™¨å“åº”åŒ…ç±»å‹ï¼š

1. OKåŒ…ï¼ˆæˆåŠŸå“åº”ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0x00(1)   â”‚ å½±å“è¡Œæ•°    â”‚  æ’å…¥ID     â”‚  çŠ¶æ€æ ‡å¿—   â”‚
â”‚            â”‚   (å˜é•¿)    â”‚   (å˜é•¿)    â”‚    (2)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. ERRåŒ…ï¼ˆé”™è¯¯å“åº”ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0xFF(1)   â”‚  é”™è¯¯ç      â”‚  çŠ¶æ€æ ‡è®°   â”‚  é”™è¯¯æ¶ˆæ¯   â”‚
â”‚            â”‚    (2)      â”‚    (6)     â”‚   (å˜é•¿)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. ç»“æœé›†åŒ…ï¼ˆæŸ¥è¯¢ç»“æœï¼‰
â€¢ åˆ—æ•°åŒ…ï¼šåŒ…å«åˆ—çš„æ•°é‡
â€¢ åˆ—å®šä¹‰åŒ…ï¼šæ¯ä¸€åˆ—çš„è¯¦ç»†ä¿¡æ¯
â€¢ EOFåŒ…ï¼šåˆ—å®šä¹‰ç»“æŸæ ‡è®°
â€¢ è¡Œæ•°æ®åŒ…ï¼šå®é™…çš„æ•°æ®è¡Œ
â€¢ EOFåŒ…ï¼šæ•°æ®ç»“æŸæ ‡è®°
```

### 3.4 æ•°æ®ç±»å‹ç¼–ç 


**ğŸ”¢ MySQLæ•°æ®ç±»å‹åœ¨åè®®ä¸­çš„ç¼–ç **
```
é•¿åº¦ç¼–ç æ•´æ•°ï¼ˆLength Encoded Integerï¼‰ï¼š
â€¢ < 251ï¼š1å­—èŠ‚ç›´æ¥å­˜å‚¨
â€¢ 251ï¼šNULLå€¼æ ‡è®°
â€¢ 252ï¼šåç»­2å­—èŠ‚å­˜å‚¨æ•°å€¼
â€¢ 253ï¼šåç»­3å­—èŠ‚å­˜å‚¨æ•°å€¼
â€¢ 254ï¼šåç»­8å­—èŠ‚å­˜å‚¨æ•°å€¼

å­—ç¬¦ä¸²ç¼–ç ï¼š
â€¢ å›ºå®šé•¿åº¦å­—ç¬¦ä¸²ï¼šç›´æ¥å­˜å‚¨å­—èŠ‚
â€¢ é•¿åº¦ç¼–ç å­—ç¬¦ä¸²ï¼šå…ˆå­˜é•¿åº¦ï¼Œå†å­˜å†…å®¹
â€¢ NULLç»“å°¾å­—ç¬¦ä¸²ï¼šä»¥0x00ç»“å°¾

æ—¥æœŸæ—¶é—´ç¼–ç ï¼š
â€¢ DATEï¼š3å­—èŠ‚ï¼ˆå¹´æœˆæ—¥ï¼‰
â€¢ TIMEï¼š3æˆ–8æˆ–12å­—èŠ‚ï¼ˆæ—¶åˆ†ç§’.å¾®ç§’ï¼‰
â€¢ DATETIMEï¼š4æˆ–7æˆ–11å­—èŠ‚
â€¢ TIMESTAMPï¼š4æˆ–7æˆ–11å­—èŠ‚
```

**ğŸ”§ ç¼–ç è§£æå®ç°**
```python
def decode_length_encoded_int(data, offset=0):
    """è§£ç é•¿åº¦ç¼–ç æ•´æ•°"""
    if offset >= len(data):
        raise ValueError("æ•°æ®ä¸è¶³")
    
    first_byte = data[offset]
    
    if first_byte < 251:
        return first_byte, offset + 1
    elif first_byte == 251:
        return None, offset + 1  # NULLå€¼
    elif first_byte == 252:
        if offset + 2 >= len(data):
            raise ValueError("æ•°æ®ä¸è¶³")
        value = int.from_bytes(data[offset+1:offset+3], 'little')
        return value, offset + 3
    elif first_byte == 253:
        if offset + 3 >= len(data):
            raise ValueError("æ•°æ®ä¸è¶³")
        value = int.from_bytes(data[offset+1:offset+4], 'little')
        return value, offset + 4
    elif first_byte == 254:
        if offset + 8 >= len(data):
            raise ValueError("æ•°æ®ä¸è¶³")
        value = int.from_bytes(data[offset+1:offset+9], 'little')
        return value, offset + 9
    else:
        raise ValueError(f"æ— æ•ˆçš„é•¿åº¦ç¼–ç : {first_byte}")

# ä½¿ç”¨ç¤ºä¾‹
data = b'\xfc\x00\x01'  # è¡¨ç¤º256è¿™ä¸ªæ•°å€¼
value, new_offset = decode_length_encoded_int(data)
print(f"è§£ç ç»“æœ: {value}")  # è¾“å‡º: 256
```

---

## 4. âš¡ å‘½ä»¤ç±»å‹ä¸å“åº”æœºåˆ¶


### 4.1 æ ¸å¿ƒå‘½ä»¤ç±»å‹è¯¦è§£


**ğŸ“‹ MySQLåè®®å‘½ä»¤åˆ†ç±»**
```
è¿æ¥ç®¡ç†å‘½ä»¤ï¼š
â€¢ COM_QUIT (0x01)ï¼šæ­£å¸¸å…³é—­è¿æ¥
â€¢ COM_INIT_DB (0x02)ï¼šé€‰æ‹©é»˜è®¤æ•°æ®åº“
â€¢ COM_PING (0x0E)ï¼šæµ‹è¯•è¿æ¥æ˜¯å¦å­˜æ´»

æŸ¥è¯¢æ‰§è¡Œå‘½ä»¤ï¼š
â€¢ COM_QUERY (0x03)ï¼šæ‰§è¡ŒSQLè¯­å¥
â€¢ COM_FIELD_LIST (0x04)ï¼šè·å–è¡¨å­—æ®µä¿¡æ¯
â€¢ COM_REFRESH (0x07)ï¼šåˆ·æ–°ç¼“å­˜

å‡†å¤‡è¯­å¥å‘½ä»¤ï¼š
â€¢ COM_STMT_PREPARE (0x16)ï¼šå‡†å¤‡SQLè¯­å¥
â€¢ COM_STMT_EXECUTE (0x17)ï¼šæ‰§è¡Œå‡†å¤‡è¯­å¥
â€¢ COM_STMT_CLOSE (0x19)ï¼šå…³é—­å‡†å¤‡è¯­å¥

ç®¡ç†å‘½ä»¤ï¼š
â€¢ COM_STATISTICS (0x09)ï¼šè·å–æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯
â€¢ COM_PROCESS_INFO (0x0A)ï¼šè·å–è¿›ç¨‹åˆ—è¡¨
â€¢ COM_DEBUG (0x0D)ï¼šè½¬å‚¨è°ƒè¯•ä¿¡æ¯
```

### 4.2 COM_QUERYå‘½ä»¤è¯¦è§£


**ğŸ” æŸ¥è¯¢å‘½ä»¤å¤„ç†æµç¨‹**
```
å®¢æˆ·ç«¯æŸ¥è¯¢æµç¨‹ï¼š
1. å‘é€COM_QUERYåŒ…
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åŒ…å¤´(4) â”‚ 0x03(1) â”‚ SQLè¯­å¥(ä¸å«null)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. æœåŠ¡å™¨å“åº”ç±»å‹ï¼š
   â€¢ SELECTæŸ¥è¯¢ â†’ ç»“æœé›†
   â€¢ INSERT/UPDATE/DELETE â†’ OKåŒ…
   â€¢ é”™è¯¯SQL â†’ ERRåŒ…
```

**ğŸ’» æŸ¥è¯¢å“åº”è§£æç¤ºä¾‹**
```python
class MySQLQueryResponse:
    def __init__(self):
        self.command_type = None
        self.result_type = None
        self.columns = []
        self.rows = []
        self.affected_rows = 0
        self.insert_id = 0
        self.error_code = 0
        self.error_message = ""
    
    def parse_response(self, data):
        """è§£ææŸ¥è¯¢å“åº”"""
        offset = 4  # è·³è¿‡åŒ…å¤´
        first_byte = data[offset]
        
        if first_byte == 0x00:
            # OKåŒ…
            self.result_type = "OK"
            offset += 1
            self.affected_rows, offset = decode_length_encoded_int(data, offset)
            self.insert_id, offset = decode_length_encoded_int(data, offset)
            
        elif first_byte == 0xFF:
            # ERRåŒ…
            self.result_type = "ERROR"
            offset += 1
            self.error_code = int.from_bytes(data[offset:offset+2], 'little')
            offset += 2
            # è·³è¿‡SQLçŠ¶æ€æ ‡è®°
            offset += 1 + 5
            self.error_message = data[offset:].decode('utf-8')
            
        else:
            # ç»“æœé›†åŒ…
            self.result_type = "RESULTSET"
            column_count, offset = decode_length_encoded_int(data, offset)
            self.parse_resultset(data, offset, column_count)
    
    def parse_resultset(self, data, offset, column_count):
        """è§£æç»“æœé›†"""
        # è§£æåˆ—å®šä¹‰
        for i in range(column_count):
            # è¿™é‡Œç®€åŒ–äº†åˆ—å®šä¹‰è§£æè¿‡ç¨‹
            column_info = self.parse_column_definition(data, offset)
            self.columns.append(column_info)
        
        # è§£ææ•°æ®è¡Œ
        while offset < len(data):
            row_data = self.parse_row_data(data, offset)
            if row_data:
                self.rows.append(row_data)
```

### 4.3 å‡†å¤‡è¯­å¥æœºåˆ¶


**ğŸ¯ å‡†å¤‡è¯­å¥çš„ä¼˜åŠ¿**
```
ä¸ºä»€ä¹ˆä½¿ç”¨å‡†å¤‡è¯­å¥ï¼š
â€¢ SQLè§£æå’Œä¼˜åŒ–åªè¿›è¡Œä¸€æ¬¡
â€¢ é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
â€¢ æ”¯æŒäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“
â€¢ å‡å°‘ç½‘ç»œä¼ è¾“é‡

å·¥ä½œæµç¨‹ï¼š
1. COM_STMT_PREPAREï¼šå‘é€SQLæ¨¡æ¿
2. æœåŠ¡å™¨è¿”å›ï¼šè¯­å¥IDå’Œå‚æ•°ä¿¡æ¯
3. COM_STMT_EXECUTEï¼šä¼ é€’å‚æ•°å¹¶æ‰§è¡Œ
4. COM_STMT_CLOSEï¼šå…³é—­è¯­å¥é‡Šæ”¾èµ„æº
```

**ğŸ”§ å‡†å¤‡è¯­å¥ç¤ºä¾‹**
```python
class PreparedStatement:
    def __init__(self, connection):
        self.connection = connection
        self.statement_id = None
        self.param_count = 0
        self.column_count = 0
    
    def prepare(self, sql):
        """å‡†å¤‡SQLè¯­å¥"""
        # æ„é€ COM_STMT_PREPAREåŒ…
        packet = bytearray()
        packet.extend((0, 0, 0, 0))  # åŒ…å¤´å ä½ç¬¦
        packet.append(0x16)  # COM_STMT_PREPARE
        packet.extend(sql.encode('utf-8'))
        
        # è®¾ç½®æ­£ç¡®çš„åŒ…é•¿åº¦
        payload_length = len(packet) - 4
        packet[0:3] = payload_length.to_bytes(3, 'little')
        packet[3] = 0  # åºåˆ—å·
        
        # å‘é€åŒ…
        self.connection.send(packet)
        
        # æ¥æ”¶å“åº”
        response = self.connection.receive()
        self.parse_prepare_response(response)
    
    def execute(self, params=None):
        """æ‰§è¡Œå‡†å¤‡è¯­å¥"""
        if self.statement_id is None:
            raise RuntimeError("è¯­å¥æœªå‡†å¤‡")
        
        # æ„é€ COM_STMT_EXECUTEåŒ…
        packet = bytearray()
        packet.extend((0, 0, 0, 1))  # åŒ…å¤´
        packet.append(0x17)  # COM_STMT_EXECUTE
        packet.extend(self.statement_id.to_bytes(4, 'little'))
        packet.append(0)  # flags
        packet.extend((1, 0, 0, 0))  # iteration-count
        
        if params:
            # ç¼–ç å‚æ•°æ•°æ®
            self.encode_parameters(packet, params)
        
        # å‘é€å¹¶æ¥æ”¶å“åº”
        self.connection.send(packet)
        return self.connection.receive()
    
    def close(self):
        """å…³é—­å‡†å¤‡è¯­å¥"""
        if self.statement_id:
            packet = bytearray()
            packet.extend((5, 0, 0, 0))  # åŒ…å¤´
            packet.append(0x19)  # COM_STMT_CLOSE
            packet.extend(self.statement_id.to_bytes(4, 'little'))
            
            self.connection.send(packet)
            self.statement_id = None
```

### 4.4 é”™è¯¯å¤„ç†æœºåˆ¶


**âŒ é”™è¯¯å“åº”åˆ†æ**
```
MySQLé”™è¯¯åˆ†ç±»ï¼š
â€¢ è¯­æ³•é”™è¯¯ï¼šSQLè¯­æ³•ä¸æ­£ç¡®
â€¢ æƒé™é”™è¯¯ï¼šè®¿é—®è¢«æ‹’ç»
â€¢ çº¦æŸé”™è¯¯ï¼šè¿åå”¯ä¸€çº¦æŸç­‰
â€¢ è¿æ¥é”™è¯¯ï¼šç½‘ç»œä¸­æ–­ã€è¶…æ—¶ç­‰
â€¢ èµ„æºé”™è¯¯ï¼šå†…å­˜ä¸è¶³ã€ç£ç›˜æ»¡ç­‰

é”™è¯¯åŒ…ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  0xFF(1)   â”‚  é”™è¯¯ç (2)  â”‚  '#'(1)     â”‚  SQLçŠ¶æ€(5) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  é”™è¯¯æ¶ˆæ¯æ–‡æœ¬                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ é”™è¯¯å¤„ç†å®ç°**
```python
class MySQLError(Exception):
    def __init__(self, error_code, sql_state, message):
        self.error_code = error_code
        self.sql_state = sql_state
        self.message = message
        super().__init__(f"MySQL Error {error_code} ({sql_state}): {message}")

def parse_error_packet(data):
    """è§£æé”™è¯¯åŒ…"""
    if data[4] != 0xFF:
        raise ValueError("ä¸æ˜¯é”™è¯¯åŒ…")
    
    offset = 5
    error_code = int.from_bytes(data[offset:offset+2], 'little')
    offset += 2
    
    # æ£€æŸ¥æ˜¯å¦æœ‰SQLçŠ¶æ€æ ‡è®°
    if data[offset] == ord('#'):
        offset += 1
        sql_state = data[offset:offset+5].decode('ascii')
        offset += 5
    else:
        sql_state = 'HY000'  # é»˜è®¤çŠ¶æ€
    
    message = data[offset:].decode('utf-8')
    
    return MySQLError(error_code, sql_state, message)

# å¸¸è§é”™è¯¯ç 
MYSQL_ERRORS = {
    1045: "Access denied for user",
    1146: "Table doesn't exist",
    1062: "Duplicate entry for key",
    2006: "MySQL server has gone away",
    2013: "Lost connection to MySQL server"
}
```

---

## 5. ğŸ”„ åè®®ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†


### 5.1 åè®®ç‰ˆæœ¬æ¼”è¿›å†å²


**ğŸ“š MySQLåè®®ç‰ˆæœ¬å‘å±•**
```
åè®®ç‰ˆæœ¬å†å²ï¼š
â€¢ ç‰ˆæœ¬ 9ï¼šMySQL 3.20åŠæ›´æ—©ç‰ˆæœ¬
â€¢ ç‰ˆæœ¬10ï¼šMySQL 3.21 - å½“å‰ç‰ˆæœ¬
â€¢ ç‰ˆæœ¬11+ï¼šé¢„ç•™ç»™æœªæ¥ç‰ˆæœ¬

ç‰ˆæœ¬10çš„ç‰¹æ€§ï¼š
â€¢ æ”¯æŒæ›´å¤§çš„åŒ…å¤§å°
â€¢ æ”¹è¿›çš„è®¤è¯æœºåˆ¶
â€¢ å‹ç¼©åè®®æ”¯æŒ
â€¢ SSLåŠ å¯†è¿æ¥
â€¢ å‡†å¤‡è¯­å¥æ”¯æŒ
â€¢ å¤šè¯­å¥æŸ¥è¯¢
â€¢ å¤šç»“æœé›†è¿”å›
```

### 5.2 å®¢æˆ·ç«¯æœåŠ¡å™¨èƒ½åŠ›åå•†


**ğŸ¤ èƒ½åŠ›æ ‡å¿—è¯¦è§£**
```
èƒ½åŠ›æ ‡å¿—ä½ï¼ˆCapability Flagsï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ â”‚ åç§°                    â”‚ å«ä¹‰                  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0  â”‚ CLIENT_LONG_PASSWORD    â”‚ æ”¯æŒæ–°å¯†ç å“ˆå¸Œ        â”‚
â”‚ 1  â”‚ CLIENT_FOUND_ROWS       â”‚ è¿”å›åŒ¹é…è¡Œæ•°          â”‚
â”‚ 2  â”‚ CLIENT_LONG_FLAG        â”‚ æ”¯æŒé•¿æ ‡å¿—            â”‚
â”‚ 3  â”‚ CLIENT_CONNECT_WITH_DB  â”‚ è¿æ¥æ—¶å¯æŒ‡å®šæ•°æ®åº“     â”‚
â”‚ 11 â”‚ CLIENT_PROTOCOL_41      â”‚ æ”¯æŒ4.1åè®®ç‰¹æ€§       â”‚
â”‚ 13 â”‚ CLIENT_COMPRESS         â”‚ æ”¯æŒå‹ç¼©åè®®          â”‚
â”‚ 14 â”‚ CLIENT_SSL              â”‚ æ”¯æŒSSLåŠ å¯†           â”‚
â”‚ 16 â”‚ CLIENT_MULTI_STATEMENTS â”‚ æ”¯æŒå¤šè¯­å¥            â”‚
â”‚ 17 â”‚ CLIENT_MULTI_RESULTS    â”‚ æ”¯æŒå¤šç»“æœé›†          â”‚
â”‚ 19 â”‚ CLIENT_PS_MULTI_RESULTS â”‚ å‡†å¤‡è¯­å¥å¤šç»“æœé›†      â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ èƒ½åŠ›åå•†ä»£ç å®ç°**
```python
class CapabilityFlags:
    CLIENT_LONG_PASSWORD = 1 << 0
    CLIENT_FOUND_ROWS = 1 << 1
    CLIENT_LONG_FLAG = 1 << 2
    CLIENT_CONNECT_WITH_DB = 1 << 3
    CLIENT_NO_SCHEMA = 1 << 4
    CLIENT_COMPRESS = 1 << 5
    CLIENT_ODBC = 1 << 6
    CLIENT_LOCAL_FILES = 1 << 7
    CLIENT_IGNORE_SPACE = 1 << 8
    CLIENT_PROTOCOL_41 = 1 << 9
    CLIENT_INTERACTIVE = 1 << 10
    CLIENT_SSL = 1 << 11
    CLIENT_IGNORE_SIGPIPE = 1 << 12
    CLIENT_TRANSACTIONS = 1 << 13
    CLIENT_RESERVED = 1 << 14
    CLIENT_SECURE_CONNECTION = 1 << 15
    CLIENT_MULTI_STATEMENTS = 1 << 16
    CLIENT_MULTI_RESULTS = 1 << 17
    CLIENT_PS_MULTI_RESULTS = 1 << 18

def negotiate_capabilities(server_caps, client_caps):
    """åå•†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„èƒ½åŠ›"""
    # å–äº¤é›†ï¼Œåªå¯ç”¨åŒæ–¹éƒ½æ”¯æŒçš„åŠŸèƒ½
    common_caps = server_caps & client_caps
    
    # åŸºç¡€èƒ½åŠ›æ£€æŸ¥
    if not (common_caps & CapabilityFlags.CLIENT_PROTOCOL_41):
        raise RuntimeError("æœåŠ¡å™¨ä¸æ”¯æŒåè®®4.1")
    
    return common_caps

def build_capability_flags():
    """æ„å»ºå®¢æˆ·ç«¯èƒ½åŠ›æ ‡å¿—"""
    caps = 0
    caps |= CapabilityFlags.CLIENT_LONG_PASSWORD
    caps |= CapabilityFlags.CLIENT_LONG_FLAG
    caps |= CapabilityFlags.CLIENT_CONNECT_WITH_DB
    caps |= CapabilityFlags.CLIENT_PROTOCOL_41
    caps |= CapabilityFlags.CLIENT_TRANSACTIONS
    caps |= CapabilityFlags.CLIENT_SECURE_CONNECTION
    caps |= CapabilityFlags.CLIENT_MULTI_STATEMENTS
    caps |= CapabilityFlags.CLIENT_MULTI_RESULTS
    
    # æ ¹æ®éœ€è¦å¯ç”¨å…¶ä»–èƒ½åŠ›
    # caps |= CapabilityFlags.CLIENT_SSL
    # caps |= CapabilityFlags.CLIENT_COMPRESS
    
    return caps
```

### 5.3 å‘åå…¼å®¹æ€§å¤„ç†


**ğŸ”„ å…¼å®¹æ€§ç­–ç•¥**
```
æ–°ç‰ˆæœ¬å®¢æˆ·ç«¯è¿æ¥è€ç‰ˆæœ¬æœåŠ¡å™¨ï¼š
â€¢ å®¢æˆ·ç«¯é™çº§ä½¿ç”¨è€åè®®ç‰¹æ€§
â€¢ ç¦ç”¨ä¸æ”¯æŒçš„åŠŸèƒ½
â€¢ ä½¿ç”¨å…¼å®¹çš„æ•°æ®æ ¼å¼

è€ç‰ˆæœ¬å®¢æˆ·ç«¯è¿æ¥æ–°ç‰ˆæœ¬æœåŠ¡å™¨ï¼š
â€¢ æœåŠ¡å™¨è‡ªåŠ¨é€‚é…è€åè®®
â€¢ æä¾›å‘åå…¼å®¹çš„å“åº”æ ¼å¼
â€¢ ä¿æŒAPIæ¥å£ç¨³å®šæ€§

å®é™…å¤„ç†ï¼š
1. æ£€æŸ¥åè®®ç‰ˆæœ¬å·
2. æ ¹æ®èƒ½åŠ›æ ‡å¿—è°ƒæ•´è¡Œä¸º
3. ä½¿ç”¨æœ€å¤§å…¬çº¦æ•°åŠŸèƒ½é›†
4. è®°å½•å…¼å®¹æ€§è­¦å‘Šæ—¥å¿—
```

**ğŸ’¡ ç‰ˆæœ¬æ£€æµ‹å®ç°**
```python
def check_protocol_compatibility(server_version, client_version):
    """æ£€æŸ¥åè®®å…¼å®¹æ€§"""
    compatibility_matrix = {
        (10, 10): "å®Œå…¨å…¼å®¹",
        (10, 9): "å®¢æˆ·ç«¯éœ€è¦å‡çº§",
        (9, 10): "æœåŠ¡å™¨åè®®é™çº§",
    }
    
    key = (server_version, client_version)
    if key in compatibility_matrix:
        return compatibility_matrix[key]
    
    if server_version > client_version:
        return "å»ºè®®å‡çº§å®¢æˆ·ç«¯"
    elif server_version < client_version:
        return "å®¢æˆ·ç«¯è‡ªåŠ¨é™çº§"
    else:
        return "ç‰ˆæœ¬åŒ¹é…"

def handle_version_mismatch(server_info, client_info):
    """å¤„ç†ç‰ˆæœ¬ä¸åŒ¹é…"""
    server_version = parse_version(server_info['version'])
    client_version = parse_version(client_info['version'])
    
    if server_version['major'] != client_version['major']:
        raise RuntimeError(f"ä¸»ç‰ˆæœ¬ä¸å…¼å®¹: æœåŠ¡å™¨{server_version['major']}, å®¢æˆ·ç«¯{client_version['major']}")
    
    # é€‰æ‹©è¾ƒä½çš„æ¬¡ç‰ˆæœ¬ä½œä¸ºé€šä¿¡åè®®ç‰ˆæœ¬
    protocol_version = min(server_version['minor'], client_version['minor'])
    
    return {
        'protocol_version': protocol_version,
        'features': get_supported_features(protocol_version),
        'warnings': generate_compatibility_warnings(server_version, client_version)
    }
```

---

## 6. ğŸš€ ç½‘ç»œä¼˜åŒ–é…ç½®ç­–ç•¥


### 6.1 è¿æ¥å‚æ•°ä¼˜åŒ–


**âš™ï¸ å…³é”®ç½‘ç»œå‚æ•°é…ç½®**
```sql
-- æœåŠ¡å™¨ç«¯ç½‘ç»œé…ç½®
-- è¿æ¥ç›¸å…³å‚æ•°
SET GLOBAL max_connections = 1000;           -- æœ€å¤§è¿æ¥æ•°
SET GLOBAL max_connect_errors = 100;         -- æœ€å¤§è¿æ¥é”™è¯¯æ•°
SET GLOBAL connect_timeout = 10;             -- è¿æ¥è¶…æ—¶æ—¶é—´
SET GLOBAL interactive_timeout = 28800;      -- äº¤äº’å¼è¿æ¥è¶…æ—¶
SET GLOBAL wait_timeout = 28800;             -- éäº¤äº’è¿æ¥è¶…æ—¶

-- ç½‘ç»œç¼“å†²åŒºé…ç½®
SET GLOBAL max_allowed_packet = 64*1024*1024; -- æœ€å¤§åŒ…å¤§å°64MB
SET GLOBAL net_buffer_length = 32768;         -- ç½‘ç»œç¼“å†²åŒºåˆå§‹å¤§å°
SET GLOBAL net_read_timeout = 30;             -- è¯»å–è¶…æ—¶
SET GLOBAL net_write_timeout = 60;            -- å†™å…¥è¶…æ—¶

-- æŸ¥çœ‹å½“å‰é…ç½®
SHOW VARIABLES LIKE '%timeout%';
SHOW VARIABLES LIKE '%connection%';
SHOW VARIABLES LIKE 'max_allowed_packet';
```

**ğŸ”§ å®¢æˆ·ç«¯è¿æ¥æ± é…ç½®**
```python
# ä½¿ç”¨PyMySQLçš„è¿æ¥æ± é…ç½®ç¤ºä¾‹
import pymysql
from pymysqlpool import ConnectionPool

# è¿æ¥æ± é…ç½®
pool_config = {
    'pool_name': 'mysql_pool',
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'password',
    'database': 'test',
    
    # è¿æ¥æ± å‚æ•°
    'pool_size': 20,                    # è¿æ¥æ± å¤§å°
    'pool_reset_session': True,         # é‡ç½®ä¼šè¯çŠ¶æ€
    'pool_recycle': 3600,              # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
    
    # ç½‘ç»œä¼˜åŒ–å‚æ•°
    'connect_timeout': 10,              # è¿æ¥è¶…æ—¶
    'read_timeout': 30,                 # è¯»å–è¶…æ—¶
    'write_timeout': 30,                # å†™å…¥è¶…æ—¶
    'max_allowed_packet': 64*1024*1024, # æœ€å¤§åŒ…å¤§å°
    'charset': 'utf8mb4',               # å­—ç¬¦é›†
    'autocommit': True,                 # è‡ªåŠ¨æäº¤
    
    # TCPå‚æ•°
    'use_unicode': True,
    'sql_mode': 'STRICT_TRANS_TABLES',
}

# åˆ›å»ºè¿æ¥æ± 
pool = ConnectionPool(**pool_config)

# ä½¿ç”¨è¿æ¥
with pool.get_connection() as conn:
    with conn.cursor() as cursor:
        cursor.execute("SELECT * FROM users LIMIT 10")
        results = cursor.fetchall()
```

### 6.2 åè®®å‹ç¼©é…ç½®


**ğŸ“¦ å¯ç”¨åè®®å‹ç¼©**
```
å‹ç¼©çš„å·¥ä½œåŸç†ï¼š
â€¢ å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åå•†å¯ç”¨å‹ç¼©
â€¢ æ‰€æœ‰å¤§äºä¸€å®šå¤§å°çš„åŒ…è‡ªåŠ¨å‹ç¼©
â€¢ ä½¿ç”¨zlibç®—æ³•è¿›è¡Œæ•°æ®å‹ç¼©
â€¢ é€‚åˆç½‘ç»œå¸¦å®½æœ‰é™çš„ç¯å¢ƒ

å‹ç¼©é€‚ç”¨åœºæ™¯ï¼š
âœ… å¹¿åŸŸç½‘è¿æ¥
âœ… å¤§é‡æ–‡æœ¬æ•°æ®ä¼ è¾“
âœ… ç½‘ç»œå¸¦å®½æˆæœ¬é«˜
âŒ æœ¬åœ°ç½‘ç»œè¿æ¥
âŒ CPUèµ„æºç´§å¼ 
âŒ å°æ•°æ®é‡é¢‘ç¹æŸ¥è¯¢
```

**ğŸ”§ å‹ç¼©é…ç½®ç¤ºä¾‹**
```python
# å¯ç”¨å‹ç¼©çš„è¿æ¥é…ç½®
compression_config = {
    'host': 'remote-mysql-server',
    'port': 3306,
    'user': 'app_user',
    'password': 'secure_password',
    'database': 'production_db',
    
    # å¯ç”¨å‹ç¼©
    'compress': True,              # å¯ç”¨åè®®å‹ç¼©
    'compression_level': 6,        # å‹ç¼©çº§åˆ«ï¼ˆ1-9ï¼‰
    
    # å‹ç¼©é˜ˆå€¼é…ç½®
    'min_compress_length': 1024,   # æœ€å°å‹ç¼©åŒ…å¤§å°
    
    # å…¶ä»–ç½‘ç»œä¼˜åŒ–
    'use_unicode': True,
    'charset': 'utf8mb4',
    'connect_timeout': 30,
    'read_timeout': 300,           # å¤§æ•°æ®ä¼ è¾“éœ€è¦æ›´é•¿è¶…æ—¶
    'write_timeout': 300,
}

# æµ‹é‡å‹ç¼©æ•ˆæœ
import time
import pymysql

def benchmark_compression():
    # ä¸ä½¿ç”¨å‹ç¼©
    start_time = time.time()
    conn_no_compress = pymysql.connect(
        host='remote-server',
        user='test_user',
        password='test_pass',
        compress=False
    )
    
    cursor = conn_no_compress.cursor()
    cursor.execute("SELECT * FROM large_table LIMIT 10000")
    results_no_compress = cursor.fetchall()
    no_compress_time = time.time() - start_time
    conn_no_compress.close()
    
    # ä½¿ç”¨å‹ç¼©
    start_time = time.time()
    conn_compress = pymysql.connect(
        host='remote-server',
        user='test_user',
        password='test_pass',
        compress=True
    )
    
    cursor = conn_compress.cursor()
    cursor.execute("SELECT * FROM large_table LIMIT 10000")
    results_compress = cursor.fetchall()
    compress_time = time.time() - start_time
    conn_compress.close()
    
    print(f"ä¸å‹ç¼©è€—æ—¶: {no_compress_time:.2f}ç§’")
    print(f"å‹ç¼©è€—æ—¶: {compress_time:.2f}ç§’")
    print(f"æ€§èƒ½æå‡: {((no_compress_time - compress_time) / no_compress_time * 100):.1f}%")
```

### 6.3 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ“Š æ‰¹å¤„ç†ç­–ç•¥**
```
æ‰¹é‡æ’å…¥ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨LOAD DATA INFILE
â€¢ å¤šå€¼INSERTè¯­å¥
â€¢ å‡†å¤‡è¯­å¥æ‰¹é‡æ‰§è¡Œ
â€¢ äº‹åŠ¡æ‰¹é‡æäº¤

æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ INå­å¥ä»£æ›¿å¤šæ¬¡æŸ¥è¯¢
â€¢ JOINä»£æ›¿å­æŸ¥è¯¢
â€¢ åˆ†é¡µæŸ¥è¯¢å¤§ç»“æœé›†
â€¢ æ¸¸æ ‡å¤„ç†è¶…å¤§æ•°æ®
```

**ğŸ”§ æ‰¹é‡æ“ä½œå®ç°**
```python
class BatchOperations:
    def __init__(self, connection):
        self.conn = connection
        self.batch_size = 1000
    
    def batch_insert(self, table, columns, data_rows):
        """æ‰¹é‡æ’å…¥æ•°æ®"""
        if not data_rows:
            return
        
        # æ„å»ºSQLè¯­å¥
        placeholders = ', '.join(['%s'] * len(columns))
        sql = f"INSERT INTO {table} ({', '.join(columns)}) VALUES ({placeholders})"
        
        # åˆ†æ‰¹æ‰§è¡Œ
        cursor = self.conn.cursor()
        try:
            for i in range(0, len(data_rows), self.batch_size):
                batch = data_rows[i:i + self.batch_size]
                cursor.executemany(sql, batch)
                
                # æ¯æ‰¹æäº¤ä¸€æ¬¡äº‹åŠ¡
                self.conn.commit()
                print(f"æ’å…¥æ‰¹æ¬¡ {i//self.batch_size + 1}, è®°å½•æ•°: {len(batch)}")
                
        except Exception as e:
            self.conn.rollback()
            raise e
        finally:
            cursor.close()
    
    def batch_update_prepared(self, sql_template, params_list):
        """ä½¿ç”¨å‡†å¤‡è¯­å¥æ‰¹é‡æ›´æ–°"""
        cursor = self.conn.cursor()
        
        try:
            # å‡†å¤‡è¯­å¥
            cursor.execute(f"PREPARE stmt FROM '{sql_template}'")
            
            # æ‰¹é‡æ‰§è¡Œ
            for i, params in enumerate(params_list):
                # è®¾ç½®å‚æ•°
                for j, param in enumerate(params):
                    cursor.execute(f"SET @param{j} = %s", (param,))
                
                # æ‰§è¡Œå‡†å¤‡è¯­å¥
                param_vars = ', '.join([f'@param{j}' for j in range(len(params))])
                cursor.execute(f"EXECUTE stmt USING {param_vars}")
                
                if (i + 1) % self.batch_size == 0:
                    self.conn.commit()
                    print(f"å®Œæˆæ‰¹æ¬¡: {(i + 1) // self.batch_size}")
            
            # æäº¤å‰©ä½™äº‹åŠ¡
            self.conn.commit()
            
            # é‡Šæ”¾å‡†å¤‡è¯­å¥
            cursor.execute("DEALLOCATE PREPARE stmt")
            
        except Exception as e:
            self.conn.rollback()
            raise e
        finally:
            cursor.close()

# ä½¿ç”¨ç¤ºä¾‹
def demo_batch_operations():
    import pymysql
    
    conn = pymysql.connect(
        host='localhost',
        user='root',
        password='password',
        database='test',
        autocommit=False  # æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡
    )
    
    batch_ops = BatchOperations(conn)
    
    # æ‰¹é‡æ’å…¥ç¤ºä¾‹
    test_data = [
        ('å¼ ä¸‰', 25, 'engineer'),
        ('æå››', 30, 'manager'),
        ('ç‹äº”', 28, 'developer'),
        # ... æ›´å¤šæ•°æ®
    ]
    
    batch_ops.batch_insert('employees', ['name', 'age', 'position'], test_data)
    
    conn.close()
```

---

## 7. ğŸ” åè®®å®‰å…¨æ€§ä¿éšœæœºåˆ¶


### 7.1 SSL/TLSåŠ å¯†ä¼ è¾“


**ğŸ”’ SSLåŠ å¯†çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦SSLåŠ å¯†ï¼š
â€¢ é˜²æ­¢æ•°æ®åŒ…å—…æ¢
â€¢ é¿å…ä¸­é—´äººæ”»å‡»
â€¢ ä¿æŠ¤æ•æ„Ÿæ•°æ®ä¼ è¾“
â€¢ æ»¡è¶³åˆè§„æ€§è¦æ±‚

SSLæ¡æ‰‹è¿‡ç¨‹ï¼š
1. å®¢æˆ·ç«¯å‘é€CLIENT_SSLèƒ½åŠ›æ ‡å¿—
2. æœåŠ¡å™¨ç¡®è®¤æ”¯æŒSSL
3. å»ºç«‹SSLè¿æ¥
4. åœ¨SSLé€šé“å†…è¿›è¡ŒMySQLè®¤è¯
5. åç»­æ‰€æœ‰é€šä¿¡éƒ½åŠ å¯†ä¼ è¾“
```

**ğŸ”§ SSLé…ç½®å®ç°**
```sql
-- æœåŠ¡å™¨ç«¯SSLé…ç½®
-- my.cnfé…ç½®æ–‡ä»¶
[mysqld]
# å¯ç”¨SSL
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-cert = /etc/mysql/ssl/server-cert.pem  
ssl-key = /etc/mysql/ssl/server-key.pem

# SSLé€‰é¡¹
ssl-cipher = HIGH:!aNULL:!MD5
require-secure-transport = ON

# æ£€æŸ¥SSLçŠ¶æ€
SHOW VARIABLES LIKE '%ssl%';
SHOW STATUS LIKE 'Ssl%';

-- åˆ›å»ºéœ€è¦SSLçš„ç”¨æˆ·
CREATE USER 'secure_user'@'%' IDENTIFIED BY 'password' REQUIRE SSL;
GRANT SELECT ON mydb.* TO 'secure_user'@'%';
```

**ğŸ”§ å®¢æˆ·ç«¯SSLè¿æ¥**
```python
import pymysql
import ssl

# SSLè¿æ¥é…ç½®
ssl_config = {
    'host': 'mysql-server.example.com',
    'port': 3306,
    'user': 'secure_user',
    'password': 'secure_password',
    'database': 'secure_db',
    
    # SSLé…ç½®
    'ssl': {
        'ca': '/path/to/ca-cert.pem',           # CAè¯ä¹¦
        'cert': '/path/to/client-cert.pem',     # å®¢æˆ·ç«¯è¯ä¹¦
        'key': '/path/to/client-key.pem',       # å®¢æˆ·ç«¯ç§é’¥
        'verify_cert': True,                    # éªŒè¯æœåŠ¡å™¨è¯ä¹¦
        'verify_identity': True,                # éªŒè¯æœåŠ¡å™¨èº«ä»½
    },
    
    # æˆ–è€…ç®€å•çš„SSLé…ç½®
    'ssl_disabled': False,                      # å¯ç”¨SSL
    'ssl_verify_cert': True,                    # éªŒè¯è¯ä¹¦
    'ssl_verify_identity': True,                # éªŒè¯èº«ä»½
}

# å»ºç«‹SSLè¿æ¥
try:
    conn = pymysql.connect(**ssl_config)
    
    # éªŒè¯SSLè¿æ¥çŠ¶æ€
    cursor = conn.cursor()
    cursor.execute("SHOW STATUS LIKE 'Ssl_cipher'")
    ssl_status = cursor.fetchone()
    
    if ssl_status and ssl_status[1]:
        print(f"SSLè¿æ¥æˆåŠŸï¼ŒåŠ å¯†å¥—ä»¶: {ssl_status[1]}")
    else:
        print("è­¦å‘Šï¼šè¿æ¥æœªä½¿ç”¨SSLåŠ å¯†")
    
    cursor.close()
    conn.close()
    
except pymysql.MySQLError as e:
    print(f"SSLè¿æ¥å¤±è´¥: {e}")
```

### 7.2 è®¤è¯æ’ä»¶å®‰å…¨


**ğŸ” è®¤è¯æ’ä»¶å¯¹æ¯”åˆ†æ**
```
MySQLè®¤è¯æ’ä»¶æ¼”è¿›ï¼š
â€¢ mysql_old_passwordï¼šå·²åºŸå¼ƒï¼Œå­˜åœ¨å®‰å…¨æ¼æ´
â€¢ mysql_native_passwordï¼šMySQL 5.7é»˜è®¤ï¼ŒSHA1å“ˆå¸Œ
â€¢ sha256_passwordï¼šMySQL 8.0æ”¯æŒï¼ŒSHA256å“ˆå¸Œ
â€¢ caching_sha2_passwordï¼šMySQL 8.0é»˜è®¤ï¼Œæ›´å®‰å…¨

å®‰å…¨æ€§åˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¤è¯æ’ä»¶            â”‚ å“ˆå¸Œç®—æ³•  â”‚ ç›å€¼é•¿åº¦  â”‚ å®‰å…¨ç­‰çº§  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ mysql_old_password  â”‚ å¼±å“ˆå¸Œ    â”‚ 8å­—èŠ‚    â”‚ ä½       â”‚
â”‚ mysql_native_passwordâ”‚ SHA1     â”‚ 20å­—èŠ‚   â”‚ ä¸­       â”‚
â”‚ sha256_password     â”‚ SHA256    â”‚ 20å­—èŠ‚   â”‚ é«˜       â”‚
â”‚ caching_sha2_passwordâ”‚ SHA256+ç¼“å­˜â”‚ 20å­—èŠ‚   â”‚ å¾ˆé«˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ è®¤è¯æ’ä»¶é…ç½®**
```sql
-- æŸ¥çœ‹å½“å‰è®¤è¯æ’ä»¶
SELECT user, host, plugin FROM mysql.user;

-- ä¿®æ”¹ç”¨æˆ·è®¤è¯æ’ä»¶
ALTER USER 'username'@'host' IDENTIFIED WITH caching_sha2_password BY 'new_password';

-- åˆ›å»ºä½¿ç”¨ç‰¹å®šè®¤è¯æ’ä»¶çš„ç”¨æˆ·
CREATE USER 'secure_user'@'%' IDENTIFIED WITH sha256_password BY 'strong_password';

-- å…¨å±€é…ç½®é»˜è®¤è®¤è¯æ’ä»¶
SET GLOBAL default_authentication_plugin = 'caching_sha2_password';

-- æŸ¥çœ‹è®¤è¯æ’ä»¶ç›¸å…³å˜é‡
SHOW VARIABLES LIKE '%auth%';
```

### 7.3 è®¿é—®æ§åˆ¶ä¸æƒé™ç®¡ç†


**ğŸ‘® åŸºäºåè®®çš„è®¿é—®æ§åˆ¶**
```sql
-- IPåœ°å€é™åˆ¶
CREATE USER 'api_user'@'192.168.1.%' IDENTIFIED BY 'password';
CREATE USER 'web_user'@'10.0.0.0/255.255.0.0' IDENTIFIED BY 'password';

-- æ—¶é—´é™åˆ¶ï¼ˆéœ€è¦æ’ä»¶æ”¯æŒï¼‰
-- è¿æ¥æ•°é™åˆ¶
ALTER USER 'limited_user'@'%' WITH MAX_CONNECTIONS_PER_HOUR 100;
ALTER USER 'limited_user'@'%' WITH MAX_QUERIES_PER_HOUR 1000;
ALTER USER 'limited_user'@'%' WITH MAX_USER_CONNECTIONS 5;

-- èµ„æºé™åˆ¶
ALTER USER 'resource_user'@'%' WITH MAX_UPDATES_PER_HOUR 500;

-- æŸ¥çœ‹å½“å‰è¿æ¥
SELECT 
    ID,
    USER,
    HOST,
    DB,
    COMMAND,
    TIME,
    STATE,
    INFO
FROM INFORMATION_SCHEMA.PROCESSLIST;

-- å¼ºåˆ¶æ–­å¼€è¿æ¥
KILL CONNECTION 123456;
```

**ğŸ›¡ï¸ å®‰å…¨è¿æ¥æ£€æŸ¥**
```python
class MySQLSecurityChecker:
    def __init__(self, connection):
        self.conn = connection
    
    def check_ssl_status(self):
        """æ£€æŸ¥SSLè¿æ¥çŠ¶æ€"""
        cursor = self.conn.cursor(pymysql.cursors.DictCursor)
        cursor.execute("SHOW STATUS LIKE 'Ssl%'")
        ssl_status = cursor.fetchall()
        cursor.close()
        
        ssl_info = {}
        for item in ssl_status:
            ssl_info[item['Variable_name']] = item['Value']
        
        return {
            'ssl_enabled': ssl_info.get('Ssl_cipher', '') != '',
            'ssl_cipher': ssl_info.get('Ssl_cipher', 'None'),
            'ssl_version': ssl_info.get('Ssl_version', 'None'),
            'ssl_verify_mode': ssl_info.get('Ssl_verify_mode', 'None'),
            'ssl_verify_depth': ssl_info.get('Ssl_verify_depth', '0'),
        }
    
    def check_user_privileges(self):
        """æ£€æŸ¥å½“å‰ç”¨æˆ·æƒé™"""
        cursor = self.conn.cursor()
        cursor.execute("SHOW GRANTS")
        grants = cursor.fetchall()
        cursor.close()
        
        privileges = []
        for grant in grants:
            privileges.append(grant[0])
        
        return privileges
    
    def check_connection_security(self):
        """å…¨é¢å®‰å…¨æ£€æŸ¥"""
        cursor = self.conn.cursor(pymysql.cursors.DictCursor)
        
        # æ£€æŸ¥è¿æ¥ä¿¡æ¯
        cursor.execute("""
            SELECT 
                CONNECTION_ID() as connection_id,
                USER() as current_user,
                $$hostname as server_host,
                $$version as server_version,
                $$version_compile_os as server_os
        """)
        connection_info = cursor.fetchone()
        
        cursor.close()
        
        return {
            'connection_info': connection_info,
            'ssl_status': self.check_ssl_status(),
            'user_privileges': self.check_user_privileges(),
            'security_recommendations': self.generate_security_recommendations()
        }
    
    def generate_security_recommendations(self):
        """ç”Ÿæˆå®‰å…¨å»ºè®®"""
        recommendations = []
        
        ssl_status = self.check_ssl_status()
        if not ssl_status['ssl_enabled']:
            recommendations.append("å»ºè®®å¯ç”¨SSLåŠ å¯†è¿æ¥")
        
        privileges = self.check_user_privileges()
        if any('ALL PRIVILEGES' in grant for grant in privileges):
            recommendations.append("é¿å…ä½¿ç”¨è¿‡é«˜æƒé™çš„ç”¨æˆ·è¿æ¥")
        
        if len(recommendations) == 0:
            recommendations.append("å½“å‰è¿æ¥å®‰å…¨é…ç½®è‰¯å¥½")
        
        return recommendations

# ä½¿ç”¨ç¤ºä¾‹
def security_audit():
    conn = pymysql.connect(
        host='localhost',
        user='audit_user',
        password='audit_pass',
        ssl_verify_cert=True
    )
    
    checker = MySQLSecurityChecker(conn)
    security_report = checker.check_connection_security()
    
    print("=== MySQLè¿æ¥å®‰å…¨å®¡è®¡æŠ¥å‘Š ===")
    print(f"è¿æ¥ID: {security_report['connection_info']['connection_id']}")
    print(f"å½“å‰ç”¨æˆ·: {security_report['connection_info']['current_user']}")
    print(f"SSLçŠ¶æ€: {security_report['ssl_status']['ssl_enabled']}")
    print(f"åŠ å¯†å¥—ä»¶: {security_report['ssl_status']['ssl_cipher']}")
    
    print("\nç”¨æˆ·æƒé™:")
    for privilege in security_report['user_privileges']:
        print(f"  {privilege}")
    
    print("\nå®‰å…¨å»ºè®®:")
    for recommendation in security_report['security_recommendations']:
        print(f"  â€¢ {recommendation}")
    
    conn.close()
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ MySQLåè®®çš„æœ¬è´¨ç†è§£**
```
åè®®æ˜¯ä»€ä¹ˆï¼š
â€¢ MySQLç‰¹æœ‰çš„åº”ç”¨å±‚é€šä¿¡åè®®
â€¢ åŸºäºTCPçš„äºŒè¿›åˆ¶åè®®
â€¢ å®šä¹‰äº†å®Œæ•´çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨äº¤äº’è§„èŒƒ
â€¢ æ‰€æœ‰MySQLå®¢æˆ·ç«¯éƒ½å¿…é¡»éµå¾ªæ­¤åè®®

åè®®çš„ä½œç”¨ï¼š
â€¢ æ ‡å‡†åŒ–é€šä¿¡æµç¨‹
â€¢ ç¡®ä¿æ•°æ®ä¼ è¾“æ­£ç¡®æ€§
â€¢ æ”¯æŒå„ç§é«˜çº§ç‰¹æ€§
â€¢ ä¿éšœé€šä¿¡å®‰å…¨æ€§
```

**ğŸ”¸ é€šä¿¡æµç¨‹çš„å…³é”®ç¯èŠ‚**
```
è¿æ¥å»ºç«‹ â†’ èƒ½åŠ›åå•† â†’ èº«ä»½è®¤è¯ â†’ å‘½ä»¤æ‰§è¡Œ â†’ è¿æ¥å…³é—­

æ¯ä¸ªç¯èŠ‚éƒ½æœ‰ç‰¹å®šçš„åŒ…æ ¼å¼å’Œå¤„ç†é€»è¾‘
ç†è§£æµç¨‹æœ‰åŠ©äºæ’æŸ¥è¿æ¥é—®é¢˜
æŒæ¡åŒ…ç»“æ„æœ‰åŠ©äºä¼˜åŒ–æ€§èƒ½
```

**ğŸ”¸ æ•°æ®åŒ…ç»“æ„çš„é‡è¦æ€§**
```
åŒ…å¤´æ ¼å¼ï¼šè½½è·é•¿åº¦(3) + åºåˆ—å·(1) + è½½è·æ•°æ®
å‘½ä»¤åŒ…ï¼šåŒ…å¤´ + å‘½ä»¤ç±»å‹ + å‘½ä»¤æ•°æ®
å“åº”åŒ…ï¼šOKåŒ…/ERRåŒ…/ç»“æœé›†åŒ…
æ•°æ®ç¼–ç ï¼šé•¿åº¦ç¼–ç æ•´æ•°ã€å­—ç¬¦ä¸²ã€æ—¥æœŸæ—¶é—´ç­‰
```

### 8.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
è¿æ¥å±‚é¢ï¼š
â€¢ åˆç†é…ç½®è¿æ¥æ± å‚æ•°
â€¢ å¯ç”¨è¿æ¥å¤ç”¨å’ŒæŒä¹…è¿æ¥
â€¢ è®¾ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´
â€¢ ä½¿ç”¨å‹ç¼©åè®®ï¼ˆè¿œç¨‹è¿æ¥ï¼‰

ä¼ è¾“å±‚é¢ï¼š
â€¢ æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”
â€¢ ä½¿ç”¨å‡†å¤‡è¯­å¥é¿å…é‡å¤è§£æ
â€¢ åˆç†è®¾ç½®max_allowed_packet
â€¢ å¯ç”¨å¤šè¯­å¥æŸ¥è¯¢ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
```

**ğŸ”¹ å®‰å…¨é˜²æŠ¤é‡ç‚¹**
```
ä¼ è¾“å®‰å…¨ï¼š
â€¢ å¼ºåˆ¶ä½¿ç”¨SSLåŠ å¯†è¿æ¥
â€¢ éªŒè¯æœåŠ¡å™¨è¯ä¹¦æœ‰æ•ˆæ€§
â€¢ ä½¿ç”¨å¼ºåŠ å¯†å¥—ä»¶

è®¤è¯å®‰å…¨ï¼š
â€¢ ä½¿ç”¨caching_sha2_passwordæ’ä»¶
â€¢ è®¾ç½®å¼ºå¯†ç ç­–ç•¥
â€¢ é™åˆ¶è¿æ¥æ¥æºIP
â€¢ å®šæœŸæ›´æ–°è®¤è¯å‡­æ®

è®¿é—®æ§åˆ¶ï¼š
â€¢ æœ€å°æƒé™åŸåˆ™
â€¢ é™åˆ¶è¿æ¥æ•°å’ŒæŸ¥è¯¢é¢‘ç‡
â€¢ ç›‘æ§å¼‚å¸¸è¿æ¥è¡Œä¸º
â€¢ åŠæ—¶æ’¤é”€ä¸éœ€è¦çš„æƒé™
```

**ğŸ”¹ æ•…éšœæ’æŸ¥æ€è·¯**
```
è¿æ¥é—®é¢˜æ’æŸ¥é¡ºåºï¼š
1. ç½‘ç»œè¿é€šæ€§ï¼ˆpingã€telnetï¼‰
2. æœåŠ¡å™¨çŠ¶æ€ï¼ˆè¿›ç¨‹ã€ç«¯å£ç›‘å¬ï¼‰
3. è®¤è¯é…ç½®ï¼ˆç”¨æˆ·åå¯†ç ã€æƒé™ï¼‰
4. åè®®å…¼å®¹æ€§ï¼ˆå®¢æˆ·ç«¯ç‰ˆæœ¬ï¼‰
5. é˜²ç«å¢™å’Œä»£ç†è®¾ç½®

å¸¸ç”¨è¯Šæ–­å‘½ä»¤ï¼š
â€¢ SHOW PROCESSLISTï¼šæŸ¥çœ‹å½“å‰è¿æ¥
â€¢ SHOW STATUSï¼šæŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€
â€¢ SHOW VARIABLESï¼šæŸ¥çœ‹é…ç½®å‚æ•°
â€¢ SHOW GRANTSï¼šæŸ¥çœ‹ç”¨æˆ·æƒé™
```

### 8.3 é«˜çº§ç‰¹æ€§åº”ç”¨


**ğŸ¯ åè®®é«˜çº§åŠŸèƒ½**
```
å‡†å¤‡è¯­å¥ï¼š
â€¢ æé«˜é‡å¤æŸ¥è¯¢æ€§èƒ½
â€¢ é˜²æ­¢SQLæ³¨å…¥æ”»å‡»
â€¢ æ”¯æŒäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“
â€¢ å‡å°‘ç½‘ç»œä¼ è¾“é‡

å¤šè¯­å¥æŸ¥è¯¢ï¼š
â€¢ ä¸€æ¬¡å‘é€å¤šæ¡SQL
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
â€¢ éœ€è¦è°¨æ…å¤„ç†é”™è¯¯æƒ…å†µ
â€¢ æ³¨æ„äº‹åŠ¡è¾¹ç•Œæ§åˆ¶

ç»“æœé›†å¤„ç†ï¼š
â€¢ æµå¼å¤„ç†å¤§ç»“æœé›†
â€¢ åˆ†é¡µè·å–é¿å…å†…å­˜æº¢å‡º
â€¢ æ¸¸æ ‡æ“ä½œæ”¯æŒ
â€¢ å…ƒæ•°æ®ä¿¡æ¯è·å–
```

**ğŸ”„ åè®®æ‰©å±•æ€§**
```
æ’ä»¶åŒ–æ¶æ„ï¼š
â€¢ è®¤è¯æ’ä»¶å¯æ‰©å±•
â€¢ å­˜å‚¨å¼•æ“æ’ä»¶æ”¯æŒ
â€¢ è‡ªå®šä¹‰å‡½æ•°æ‰©å±•
â€¢ åè®®ä¸­é—´ä»¶å¼€å‘

ç‰ˆæœ¬å…¼å®¹æ€§ï¼š
â€¢ å‘åå…¼å®¹ä¿è¯
â€¢ èƒ½åŠ›æ ‡å¿—åå•†æœºåˆ¶
â€¢ æ¸è¿›å¼ç‰¹æ€§å¯ç”¨
â€¢ å¹³æ»‘å‡çº§æ”¯æŒ
```

### 8.4 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“š å¼€å‘å®è·µå»ºè®®**
```
è¿æ¥ç®¡ç†ï¼š
â€¢ ä½¿ç”¨æˆç†Ÿçš„è¿æ¥æ± ç»„ä»¶
â€¢ åˆç†è®¾ç½®æ± å¤§å°å’Œè¶…æ—¶å‚æ•°
â€¢ å®ç°è¿æ¥å¥åº·æ£€æŸ¥
â€¢ ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ

é”™è¯¯å¤„ç†ï¼š
â€¢ åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
â€¢ å®ç°é‡è¯•æœºåˆ¶ï¼ˆè¿æ¥æ–­å¼€ï¼‰
â€¢ è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
â€¢ æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯

æ€§èƒ½ç›‘æ§ï¼š
â€¢ ç›‘æ§è¿æ¥æ•°å’ŒæŸ¥è¯¢å“åº”æ—¶é—´
â€¢ è·Ÿè¸ªç½‘ç»œä¼ è¾“é‡
â€¢ åˆ†ææ…¢æŸ¥è¯¢å’Œé•¿è¿æ¥
â€¢ å®šæœŸæ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæœŸ
```

**ğŸš€ æœªæ¥å‘å±•è¶‹åŠ¿**
```
æŠ€æœ¯æ¼”è¿›æ–¹å‘ï¼š
â€¢ HTTP/2åè®®æ”¯æŒ
â€¢ æ›´å¼ºçš„åŠ å¯†ç®—æ³•
â€¢ æ›´å¥½çš„å‹ç¼©ç®—æ³•
â€¢ äº‘åŸç”Ÿåè®®ä¼˜åŒ–

æ–°ç‰¹æ€§æ”¯æŒï¼š
â€¢ å¼‚æ­¥æŸ¥è¯¢å¤„ç†
â€¢ æµå¼æ•°æ®å¤„ç†
â€¢ å¤šç§Ÿæˆ·æ”¯æŒ
â€¢ è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–
```

**ğŸ’¡ å­¦ä¹ å»ºè®®**
- **ç†è®ºç»“åˆå®è·µ**ï¼šä¸ä»…è¦ç†è§£åè®®åŸç†ï¼Œè¿˜è¦åŠ¨æ‰‹å®ç°ç®€å•çš„å®¢æˆ·ç«¯
- **å·¥å…·è¾…åŠ©å­¦ä¹ **ï¼šä½¿ç”¨Wiresharkç­‰å·¥å…·è§‚å¯Ÿå®é™…çš„ç½‘ç»œåŒ…
- **æºç é˜…è¯»**ï¼šç ”ç©¶å¼€æºMySQLå®¢æˆ·ç«¯é©±åŠ¨çš„å®ç°ä»£ç 
- **æ€§èƒ½æµ‹è¯•**ï¼šåœ¨ä¸åŒç½‘ç»œç¯å¢ƒä¸‹æµ‹è¯•å„ç§é…ç½®çš„æ€§èƒ½è¡¨ç°
- **å®‰å…¨æ„è¯†**ï¼šå§‹ç»ˆå°†å®‰å…¨æ€§æ”¾åœ¨é‡è¦ä½ç½®è€ƒè™‘

**æ ¸å¿ƒè®°å¿†**ï¼š
- MySQLåè®®æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é€šä¿¡çš„æ¡¥æ¢ï¼Œç†è§£åè®®æœ‰åŠ©äºä¼˜åŒ–æ€§èƒ½å’Œæ’æŸ¥é—®é¢˜
- åè®®åŒ…ç»“æ„è§„èŒƒç»Ÿä¸€ï¼ŒæŒæ¡åŸºæœ¬æ ¼å¼å°±èƒ½ç†è§£æ‰€æœ‰ç±»å‹çš„åŒ…
- å®‰å…¨æ€§é…ç½®ä¸å¯å¿½è§†ï¼ŒSSLåŠ å¯†å’Œå¼ºè®¤è¯æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…è¦æªæ–½
- æ€§èƒ½ä¼˜åŒ–éœ€è¦ä»è¿æ¥ç®¡ç†ã€æ•°æ®ä¼ è¾“ã€æ‰¹é‡æ“ä½œç­‰å¤šä¸ªå±‚é¢ç»¼åˆè€ƒè™‘
- åè®®çš„å‘åå…¼å®¹æ€§ä¿è¯äº†MySQLç”Ÿæ€çš„ç¨³å®šå‘å±•