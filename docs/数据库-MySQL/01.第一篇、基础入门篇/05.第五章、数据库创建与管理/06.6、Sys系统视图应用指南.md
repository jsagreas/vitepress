---
title: 6、Sys系统视图应用指南
---
## 📚 目录

1. [Sys库概述与作用](#1-sys库概述与作用)
2. [Sys视图分类体系](#2-sys视图分类体系)
3. [用户与主机统计视图](#3-用户与主机统计视图)
4. [性能分析与诊断视图](#4-性能分析与诊断视图)
5. [资源使用监控视图](#5-资源使用监控视图)
6. [实用查询与运维脚本](#6-实用查询与运维脚本)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 Sys库概述与作用


### 1.1 什么是Sys库


**🔸 核心定义**
```
Sys库：MySQL 5.7+自带的系统视图库
本质：基于performance_schema的友好视图封装
目标：简化数据库性能监控和问题诊断
位置：MySQL安装后自动创建的系统库
```

**💡 为什么需要Sys库**
```
传统问题：
• performance_schema表结构复杂
• 查询语句冗长难写
• 数据格式不够友好
• 需要深度SQL知识才能使用

Sys库解决方案：
• 预定义的友好视图
• 简化的查询接口
• 格式化的输出结果
• 开箱即用的监控工具
```

### 1.2 Sys库的核心价值


**⭐ 运维价值体现**
```
快速诊断：
├── 一条SQL找出慢查询
├── 快速定位资源瓶颈
├── 实时监控系统状态
└── 问题根因快速分析

简化运维：
├── 降低性能分析门槛
├── 标准化监控方法
├── 减少手工查询编写
└── 提供最佳实践模板
```

**🎯 适用人群**
- **DBA**：日常监控和性能调优
- **开发人员**：SQL性能分析和优化
- **运维工程师**：系统健康检查
- **技术管理者**：资源使用情况了解

---

## 2. 🗂️ Sys视图分类体系


### 2.1 Sys视图功能分类


**📋 核心视图分类**
```
用户与主机分析：
├── user_summary：用户活动统计
├── host_summary：主机连接统计  
├── user_summary_by_file_io：用户IO统计
└── host_summary_by_file_io：主机IO统计

性能与语句分析：
├── statement_analysis：语句执行分析
├── statements_with_runtimes_in_95th_percentile：慢查询分析
├── statements_with_full_table_scans：全表扫描查询
└── statements_with_errors_or_warnings：异常语句统计

资源使用监控：
├── memory_global_by_current_bytes：内存使用统计
├── io_global_by_file_by_bytes：文件IO统计
├── io_global_by_wait_by_bytes：IO等待统计
└── disk_usage：磁盘空间使用
```

### 2.2 视图命名规律


**🔤 命名约定理解**
```
前缀含义：
• user_* ：用户相关统计
• host_* ：主机相关统计  
• statement_* ：SQL语句分析
• io_* ：IO相关统计
• memory_* ：内存相关统计
• wait_* ：等待事件统计

后缀含义：
• *_summary ：汇总统计信息
• *_by_* ：按某个维度分组
• *_with_* ：包含特定条件的查询
• *_global_* ：全局级别统计
```

---

## 3. 👥 用户与主机统计视图


### 3.1 user_summary用户统计 🔥


**🔸 视图作用**
```
功能：统计每个用户的数据库使用情况
用途：用户行为分析、资源使用监控
适用：多用户系统的管理和优化
```

**📊 关键字段说明**
```sql
SELECT 
    user,                    -- 用户名
    statements,              -- 执行的语句总数
    statement_latency,       -- 语句总执行时间
    statement_avg_latency,   -- 平均执行时间
    table_scans,            -- 全表扫描次数
    file_ios,               -- 文件IO操作次数
    file_io_latency,        -- IO总等待时间
    current_connections,     -- 当前连接数
    total_connections       -- 历史总连接数
FROM sys.user_summary;
```

**💡 实际应用示例**
```sql
-- 查找最活跃的用户
SELECT user, statements, statement_latency
FROM sys.user_summary 
WHERE user != 'background'
ORDER BY statements DESC 
LIMIT 10;

-- 查找IO消耗最大的用户
SELECT user, file_ios, file_io_latency
FROM sys.user_summary 
WHERE user != 'background'
ORDER BY file_ios DESC 
LIMIT 5;
```

### 3.2 host_summary主机统计 🔥


**🔸 视图功能**
```
作用：按客户端IP统计数据库访问情况
价值：识别访问热点、异常连接、安全分析
场景：多应用服务器环境的监控分析
```

**📈 典型查询场景**
```sql
-- 查看各主机的连接情况
SELECT 
    host,
    current_connections AS 当前连接,
    total_connections AS 总连接数,
    statements AS 执行语句数,
    statement_avg_latency AS 平均响应时间
FROM sys.host_summary 
WHERE host NOT LIKE '%localhost%'
ORDER BY current_connections DESC;

-- 识别异常高频访问的主机
SELECT host, statements, statement_latency
FROM sys.host_summary 
WHERE statements > 10000  -- 执行超过1万条语句
ORDER BY statements DESC;
```

**🔍 安全监控应用**
```sql
-- 检查可疑的连接模式
SELECT 
    host,
    total_connections AS 总连接,
    statements AS 语句数,
    ROUND(statements/total_connections, 2) AS 平均语句数
FROM sys.host_summary 
WHERE statements/total_connections < 5  -- 连接多但查询少
ORDER BY total_connections DESC;
```

---

## 4. 📊 性能分析与诊断视图


### 4.1 statement_analysis语句分析 🔥


**🔸 语句性能分析的重要性**
```
为什么要分析SQL语句：
• SQL性能是数据库性能的核心
• 慢查询是系统瓶颈的主要原因
• 优化SQL比升级硬件更有效
• 预防性监控避免性能问题
```

**📋 核心分析字段**
```sql
SELECT 
    query,                   -- SQL语句内容(脱敏)
    exec_count,             -- 执行次数
    total_latency,          -- 总执行时间
    avg_latency,            -- 平均执行时间
    lock_latency,           -- 锁等待时间
    rows_sent,              -- 返回行数
    rows_examined,          -- 扫描行数
    tmp_tables,             -- 临时表使用次数
    full_scan               -- 全表扫描标识
FROM sys.statement_analysis;
```

**⚡ 性能问题快速诊断**
```sql
-- 找出最耗时的TOP 10查询
SELECT 
    LEFT(query, 60) AS 查询语句,
    exec_count AS 执行次数,
    avg_latency AS 平均耗时,
    total_latency AS 总耗时
FROM sys.statement_analysis 
ORDER BY total_latency DESC 
LIMIT 10;

-- 找出全表扫描的查询
SELECT 
    LEFT(query, 50) AS 查询语句,
    exec_count AS 执行次数,
    full_scan AS 全表扫描次数
FROM sys.statement_analysis 
WHERE full_scan > 0
ORDER BY full_scan DESC;
```

### 4.2 慢查询专项分析


**🐌 慢查询分析视图组合**
```
主要视图：
├── statements_with_runtimes_in_95th_percentile
│   └── 执行时间在95%分位数以上的语句
├── statements_with_full_table_scans  
│   └── 包含全表扫描的语句
├── statements_with_sorting
│   └── 需要排序操作的语句
└── statements_with_temp_tables
    └── 使用临时表的语句
```

**🔍 慢查询诊断实例**
```sql
-- 查看最慢的查询（95分位数）
SELECT 
    LEFT(query, 80) AS SQL语句,
    total_latency AS 总耗时,
    exec_count AS 执行次数,
    avg_latency AS 平均耗时
FROM sys.statements_with_runtimes_in_95th_percentile
LIMIT 5;

-- 检查全表扫描问题
SELECT 
    LEFT(query, 60) AS 问题SQL,
    exec_count AS 执行次数,
    total_latency AS 总耗时,
    no_index_used_count AS 未用索引次数
FROM sys.statements_with_full_table_scans
WHERE exec_count > 100;
```

---

## 5. 💾 资源使用监控视图


### 5.1 memory_global_by_current_bytes内存使用 🔥


**🧠 内存使用分析的重要性**
```
内存监控价值：
• 识别内存泄漏问题
• 优化内存配置参数
• 预防OOM(内存不足)问题
• 合理分配缓冲池大小
```

**📊 内存使用统计查询**
```sql
-- 查看当前内存使用情况
SELECT 
    event_name AS 内存类型,
    FORMAT_BYTES(current_alloc) AS 当前使用,
    FORMAT_BYTES(high_alloc) AS 历史峰值,
    current_count_used AS 使用计数
FROM sys.memory_global_by_current_bytes
WHERE current_alloc > 0
ORDER BY current_alloc DESC
LIMIT 10;
```

**🔍 内存问题诊断技巧**
```sql
-- 查找内存使用异常的组件
SELECT 
    event_name,
    FORMAT_BYTES(current_alloc) AS 当前使用,
    FORMAT_BYTES(high_alloc) AS 峰值使用,
    ROUND(current_alloc/high_alloc*100, 2) AS 使用率百分比
FROM sys.memory_global_by_current_bytes
WHERE current_alloc > 1024*1024*100  -- 超过100MB
ORDER BY current_alloc DESC;
```

### 5.2 io_global_by_file_by_bytes文件IO 🔥


**💿 文件IO监控价值**
```
IO性能影响：
• 磁盘IO是数据库性能瓶颈
• 不同文件类型有不同IO模式
• IO等待直接影响查询响应时间
• 监控IO有助于容量规划
```

**📁 文件IO统计分析**
```sql
-- 查看各类文件的IO情况
SELECT 
    file,                           -- 文件路径
    FORMAT_BYTES(total) AS 总IO量,
    FORMAT_BYTES(total_read) AS 读取量,
    FORMAT_BYTES(total_written) AS 写入量,
    FORMAT_PICO_TIME(total_latency) AS 总等待时间
FROM sys.io_global_by_file_by_bytes
WHERE total > 0
ORDER BY total DESC 
LIMIT 10;
```

**⚡ IO性能优化指导**
```sql
-- 识别IO瓶颈文件
SELECT 
    LEFT(file, 50) AS 文件名,
    FORMAT_BYTES(total) AS IO总量,
    FORMAT_PICO_TIME(total_latency) AS 等待时间,
    ROUND(total_latency/total*1000, 2) AS 平均延迟ms
FROM sys.io_global_by_file_by_bytes
WHERE total_latency > 0
ORDER BY total_latency DESC
LIMIT 15;

-- 查看表空间IO情况
SELECT 
    file,
    FORMAT_BYTES(total_read) AS 读取,
    FORMAT_BYTES(total_written) AS 写入
FROM sys.io_global_by_file_by_bytes
WHERE file LIKE '%.ibd'  -- InnoDB表文件
ORDER BY total DESC;
```

---

## 6. 🛠️ 实用查询与运维脚本


### 6.1 系统健康检查脚本


**🔍 一键健康检查**
```sql
-- 系统整体健康状况检查
SELECT '=== MySQL系统健康检查报告 ===' AS 检查项目;

-- 1. 连接数检查
SELECT 
    '当前连接' AS 检查项,
    variable_value AS 当前值,
    CASE 
        WHEN variable_value::int > 80 THEN '⚠️ 警告：连接数过高'
        ELSE '✅ 正常'
    END AS 状态
FROM sys.metrics 
WHERE variable_name = 'current_connections';

-- 2. 慢查询检查
SELECT 
    '慢查询数量' AS 检查项,
    COUNT(*) AS 当前值,
    CASE 
        WHEN COUNT(*) > 10 THEN '⚠️ 警告：慢查询较多'
        ELSE '✅ 正常'
    END AS 状态
FROM sys.statements_with_runtimes_in_95th_percentile;

-- 3. 内存使用检查
SELECT 
    '内存使用' AS 检查项,
    FORMAT_BYTES(SUM(current_alloc)) AS 当前值,
    '✅ 查看详细内存分布' AS 状态
FROM sys.memory_global_by_current_bytes;
```

### 6.2 性能调优辅助查询


**⚡ 性能热点识别**
```sql
-- 综合性能问题诊断
-- 找出需要优化的TOP问题
SELECT 
    '问题类型' AS 分类,
    '查询语句' AS SQL,
    '影响程度' AS 评级;

-- 最耗时的查询
SELECT 
    '⏱️ 执行时间问题' AS 分类,
    LEFT(query, 60) AS SQL,
    CONCAT('总耗时:', total_latency, ' 次数:', exec_count) AS 评级
FROM sys.statement_analysis 
ORDER BY total_latency DESC 
LIMIT 3;

-- 全表扫描问题
SELECT 
    '🔍 索引缺失问题' AS 分类,
    LEFT(query, 60) AS SQL,  
    CONCAT('扫描次数:', full_scan, ' 执行次数:', exec_count) AS 评级
FROM sys.statement_analysis
WHERE full_scan > 0
ORDER BY full_scan DESC
LIMIT 3;
```

### 6.3 运维自动化脚本


**🤖 自动化监控查询**
```sql
-- 创建性能监控视图
CREATE OR REPLACE VIEW daily_performance_summary AS
SELECT 
    NOW() AS 检查时间,
    (SELECT COUNT(*) FROM sys.processlist WHERE command != 'Sleep') AS 活跃连接数,
    (SELECT COUNT(*) FROM sys.statements_with_runtimes_in_95th_percentile) AS 慢查询数量,
    (SELECT FORMAT_BYTES(SUM(current_alloc)) FROM sys.memory_global_by_current_bytes) AS 内存使用,
    (SELECT COUNT(*) FROM sys.innodb_lock_waits) AS 锁等待数;

-- 使用监控视图
SELECT * FROM daily_performance_summary;
```

**📊 定期报告生成**
```sql
-- 周度性能报告
SELECT 
    '=== 本周数据库性能报告 ===' AS 报告标题;

-- 用户活跃度统计
SELECT 
    '👥 用户活跃度' AS 统计类型,
    user AS 用户名,
    statements AS 执行语句数,
    FORMAT_PICO_TIME(statement_latency) AS 总耗时
FROM sys.user_summary 
WHERE user NOT IN ('background', 'root')
ORDER BY statements DESC 
LIMIT 5;

-- 资源使用TOP统计
SELECT 
    '💾 内存使用TOP5' AS 统计类型,
    event_name AS 组件名称,
    FORMAT_BYTES(current_alloc) AS 当前使用
FROM sys.memory_global_by_current_bytes
ORDER BY current_alloc DESC 
LIMIT 5;
```

---

## 7. 🎯 系统诊断实用技巧


### 7.1 常见问题快速定位


**🔍 问题诊断方法图**
```
性能问题排查流程：

数据库响应慢
      │
      ▼
┌─────────────┐    YES   ┌─────────────────────┐
│连接数过多？  ├─────────→│查看host_summary     │
└─────────────┘          │检查连接来源         │
      │ NO               └─────────────────────┘
      ▼
┌─────────────┐    YES   ┌─────────────────────┐
│存在慢查询？  ├─────────→│查看statement_analysis│
└─────────────┘          │优化SQL语句          │
      │ NO               └─────────────────────┘
      ▼
┌─────────────┐    YES   ┌─────────────────────┐
│内存不足？   ├─────────→│查看memory_global    │
└─────────────┘          │调整内存配置         │
      │ NO               └─────────────────────┘
      ▼
┌─────────────┐
│检查IO问题   │
└─────────────┘
```

### 7.2 Sys视图最佳实践


**💡 使用建议**
```
定期检查项目：
✅ 每日：连接数、慢查询、错误日志
✅ 每周：用户活动、资源使用趋势
✅ 每月：存储空间、性能基线对比
✅ 季度：容量规划、配置优化评估

监控告警设置：
⚠️ 连接数 > 80%最大值
⚠️ 慢查询增长异常
⚠️ 内存使用 > 90%
⚠️ IO等待时间过长
```

**🔧 查询优化建议**
```sql
-- 建议的性能检查模板
-- 每日基础检查
SELECT 
    '每日健康检查' AS 检查类型,
    NOW() AS 检查时间;

-- 检查1：连接状态
SELECT COUNT(*) AS 当前连接数 FROM sys.processlist WHERE command != 'Sleep';

-- 检查2：慢查询统计  
SELECT COUNT(*) AS 慢查询数量 FROM sys.statements_with_runtimes_in_95th_percentile;

-- 检查3：锁等待情况
SELECT COUNT(*) AS 锁等待数量 FROM sys.innodb_lock_waits;
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的Sys库知识


```
🔸 Sys库本质：performance_schema的友好封装，简化性能监控
🔸 核心价值：快速诊断、简化运维、标准化监控
🔸 主要分类：用户统计、性能分析、资源监控、诊断工具
🔸 常用视图：user_summary、statement_analysis、memory_global等
🔸 实践应用：健康检查、性能调优、问题诊断、运维自动化
```

### 8.2 关键应用要点


**🔹 视图使用原则**
```
选择合适的视图：
• 用户问题 → user_summary、host_summary
• 性能问题 → statement_analysis相关视图
• 资源问题 → memory_global、io_global等
• 系统问题 → 综合多个视图分析

查询优化技巧：
• 使用LIMIT限制结果集大小
• 过滤background用户的统计
• 结合时间范围进行分析
• 格式化函数美化输出结果
```

**🔹 运维实践建议**
```
监控策略：
├── 建立基线：记录正常情况下的各项指标
├── 设置阈值：根据业务特点设定告警阈值
├── 定期巡检：制定标准的检查流程
└── 趋势分析：关注指标变化趋势而非绝对值

故障处理：
├── 快速定位：使用sys视图快速缩小问题范围
├── 深入分析：结合其他工具进行详细分析
├── 根因分析：找出问题的根本原因
└── 预防措施：制定预防类似问题的措施
```

### 8.3 学习进阶路径


**📈 学习建议**
```
基础阶段：⭐
• 熟悉sys库的基本概念和作用
• 掌握常用视图的基本查询方法
• 理解各个字段的含义

进阶阶段：⭐⭐  
• 能够组合多个视图进行问题诊断
• 编写自动化监控脚本
• 建立性能基线和告警机制

高级阶段：⭐⭐⭐
• 深度定制化监控方案
• 结合其他工具建立完整监控体系
• 性能调优和容量规划专家级应用
```

**🎓 实践练习建议**
1. **动手练习**：在测试环境中执行各种查询
2. **模拟场景**：创建不同的负载模式观察变化
3. **对比分析**：优化前后的性能指标对比
4. **文档记录**：建立自己的监控查询库

**核心记忆**：
- Sys库是MySQL性能监控的利器，把复杂的性能数据变简单
- 用户统计看访问模式，语句分析找性能瓶颈，资源监控防问题
- 定期检查建基线，异常告警快响应，运维自动化省人力
- 工具虽好需理解，结合业务做分析，持续优化保性能