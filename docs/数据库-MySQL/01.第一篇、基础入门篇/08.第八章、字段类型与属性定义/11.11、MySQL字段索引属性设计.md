---
title: 11ã€MySQLå­—æ®µç´¢å¼•å±æ€§è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [ç´¢å¼•åŸºç¡€æ¦‚å¿µä¸ä½œç”¨](#1-ç´¢å¼•åŸºç¡€æ¦‚å¿µä¸ä½œç”¨)
2. [å•åˆ—ç´¢å¼•è®¾è®¡ç­–ç•¥](#2-å•åˆ—ç´¢å¼•è®¾è®¡ç­–ç•¥)
3. [å¤åˆç´¢å¼•è®¾è®¡åŸç†](#3-å¤åˆç´¢å¼•è®¾è®¡åŸç†)
4. [é«˜çº§ç´¢å¼•ç±»å‹åº”ç”¨](#4-é«˜çº§ç´¢å¼•ç±»å‹åº”ç”¨)
5. [ç´¢å¼•æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#5-ç´¢å¼•æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
6. [ç´¢å¼•ç­–ç•¥é€‰æ‹©æ–¹æ³•](#6-ç´¢å¼•ç­–ç•¥é€‰æ‹©æ–¹æ³•)
7. [å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ](#7-å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç´¢å¼•åŸºç¡€æ¦‚å¿µä¸ä½œç”¨


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“ç´¢å¼•


**ğŸ”¸ ç´¢å¼•çš„æœ¬è´¨ç†è§£**
```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ä¹¦ç±ç›®å½• â†’ å¿«é€Ÿæ‰¾åˆ°ç« èŠ‚å†…å®¹
å­—å…¸æ‹¼éŸ³è¡¨ â†’ å¿«é€Ÿæ‰¾åˆ°æ±‰å­—ä½ç½®
å›¾ä¹¦é¦†ç´¢å¼•å¡ â†’ å¿«é€Ÿæ‰¾åˆ°ä¹¦ç±ä½ç½®

æ•°æ®åº“ç´¢å¼•ï¼š
è¡¨æ•°æ® â†’ ç´¢å¼•ç»“æ„ â†’ å¿«é€Ÿå®šä½æ•°æ®è¡Œ
åŸç†ï¼šç”¨é¢å¤–çš„æ•°æ®ç»“æ„åŠ é€Ÿæ•°æ®æŸ¥æ‰¾
ä»£ä»·ï¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œå½±å“å†™å…¥æ€§èƒ½
```

**ğŸ’¡ ç´¢å¼•å·¥ä½œæœºåˆ¶**
```
æ— ç´¢å¼•æŸ¥è¯¢ï¼š
SELECT * FROM users WHERE age = 25;
æ‰§è¡Œè¿‡ç¨‹ï¼šæ‰«ææ•´å¼ è¡¨ï¼Œé€è¡Œæ£€æŸ¥ageå­—æ®µ

æœ‰ç´¢å¼•æŸ¥è¯¢ï¼š
CREATE INDEX idx_age ON users(age);
SELECT * FROM users WHERE age = 25;
æ‰§è¡Œè¿‡ç¨‹ï¼šé€šè¿‡ç´¢å¼•ç›´æ¥å®šä½åˆ°ç¬¦åˆæ¡ä»¶çš„è¡Œ

æ€§èƒ½å¯¹æ¯”ï¼š
æ— ç´¢å¼•ï¼šO(n) - æ‰«ææ‰€æœ‰è¡Œ
æœ‰ç´¢å¼•ï¼šO(log n) - æ ‘å½¢ç»“æ„æŸ¥æ‰¾
```

### 1.2 ç´¢å¼•çš„åŒåˆƒå‰‘ç‰¹æ€§


**âœ… ç´¢å¼•çš„å¥½å¤„**
```
æŸ¥è¯¢åŠ é€Ÿï¼š
â€¢ SELECTæŸ¥è¯¢ï¼šå¤§å¹…æå‡æ£€ç´¢é€Ÿåº¦
â€¢ WHEREæ¡ä»¶ï¼šå¿«é€Ÿè¿‡æ»¤æ•°æ®
â€¢ ORDER BYæ’åºï¼šåˆ©ç”¨ç´¢å¼•æœ‰åºæ€§
â€¢ GROUP BYåˆ†ç»„ï¼šåŠ é€Ÿåˆ†ç»„æ“ä½œ
â€¢ JOINè¿æ¥ï¼šæå‡è¡¨è¿æ¥æ•ˆç‡

å”¯ä¸€æ€§çº¦æŸï¼š
â€¢ PRIMARY KEYï¼šä¸»é”®çº¦æŸ
â€¢ UNIQUE INDEXï¼šå”¯ä¸€æ€§ä¿è¯
â€¢ æ•°æ®å®Œæ•´æ€§ï¼šé˜²æ­¢é‡å¤æ•°æ®
```

**âŒ ç´¢å¼•çš„ä»£ä»·**
```
å­˜å‚¨å¼€é”€ï¼š
â€¢ æ¯ä¸ªç´¢å¼•éƒ½éœ€è¦é¢å¤–çš„ç£ç›˜ç©ºé—´
â€¢ å¤åˆç´¢å¼•ç©ºé—´å ç”¨æ›´å¤§
â€¢ B+æ ‘ç»“æ„éœ€è¦ç»´æŠ¤æŒ‡é’ˆå…³ç³»

å†™å…¥æ€§èƒ½å½±å“ï¼š
â€¢ INSERTï¼šéœ€è¦ç»´æŠ¤æ‰€æœ‰ç›¸å…³ç´¢å¼•
â€¢ UPDATEï¼šå¯èƒ½è§¦å‘ç´¢å¼•é‡å»º
â€¢ DELETEï¼šéœ€è¦æ¸…ç†ç´¢å¼•æ¡ç›®
â€¢ ç»´æŠ¤æˆæœ¬ï¼šç´¢å¼•è¶Šå¤šï¼Œå†™å…¥è¶Šæ…¢

å†…å­˜æ¶ˆè€—ï¼š
â€¢ ç´¢å¼•æ•°æ®éœ€è¦ç¼“å­˜åœ¨å†…å­˜ä¸­
â€¢ è¿‡å¤šç´¢å¼•å½±å“ç¼“å†²æ± æ•ˆç‡
```

### 1.3 MySQLç´¢å¼•ç±»å‹æ¦‚è§ˆ


**ğŸ“Š MySQLæ”¯æŒçš„ç´¢å¼•ç±»å‹**

| ç´¢å¼•ç±»å‹ | **å­˜å‚¨å¼•æ“æ”¯æŒ** | **æ•°æ®ç»“æ„** | **é€‚ç”¨åœºæ™¯** | **ç‰¹ç‚¹** |
|---------|----------------|-------------|-------------|---------|
| **B+Tree** | `InnoDB, MyISAM` | `B+æ ‘` | `èŒƒå›´æŸ¥è¯¢ï¼Œæ’åº` | `æœ€å¸¸ç”¨ï¼Œå¹³è¡¡æ ‘` |
| **Hash** | `Memory` | `å“ˆå¸Œè¡¨` | `ç­‰å€¼æŸ¥è¯¢` | `O(1)æŸ¥æ‰¾ï¼Œä¸æ”¯æŒèŒƒå›´` |
| **Fulltext** | `InnoDB, MyISAM` | `å€’æ’ç´¢å¼•` | `å…¨æ–‡æœç´¢` | `é€‚åˆæ–‡æœ¬æ£€ç´¢` |
| **Spatial** | `InnoDB, MyISAM` | `R-Tree` | `åœ°ç†ç©ºé—´æ•°æ®` | `äºŒç»´ç©ºé—´ç´¢å¼•` |

---

## 2. ğŸ¯ å•åˆ—ç´¢å¼•è®¾è®¡ç­–ç•¥


### 2.1 å•åˆ—ç´¢å¼•åŸºæœ¬åŸç†


**ğŸ”¸ ä»€ä¹ˆæ—¶å€™éœ€è¦å•åˆ—ç´¢å¼•**
```
å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ä¸»é”®å­—æ®µï¼šidå­—æ®µï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â€¢ å¤–é”®å­—æ®µï¼šuser_id, order_idç­‰å…³è”å­—æ®µ
â€¢ å”¯ä¸€å­—æ®µï¼šemail, phoneç­‰ä¸šåŠ¡å”¯ä¸€æ ‡è¯†
â€¢ é¢‘ç¹æŸ¥è¯¢å­—æ®µï¼šstatus, created_atç­‰å¸¸ç”¨è¿‡æ»¤æ¡ä»¶

ä¸éœ€è¦ç´¢å¼•çš„æƒ…å†µï¼š
â€¢ æ•°æ®é‡å¤åº¦å¾ˆé«˜ï¼šæ€§åˆ«å­—æ®µï¼ˆåªæœ‰ç”·/å¥³ä¸¤ä¸ªå€¼ï¼‰
â€¢ å¾ˆå°‘æŸ¥è¯¢çš„å­—æ®µï¼šdescriptionç­‰å¤§æ–‡æœ¬
â€¢ é¢‘ç¹æ›´æ–°çš„å­—æ®µï¼šlast_login_timeç­‰
```

**ğŸ’¡ å•åˆ—ç´¢å¼•åˆ›å»ºç¤ºä¾‹**
```sql
-- åŸºç¡€å•åˆ—ç´¢å¼•
CREATE INDEX idx_email ON users(email);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX uk_phone ON users(phone);

-- æŒ‡å®šç´¢å¼•æ–¹æ³•ï¼ˆé€šå¸¸MySQLè‡ªåŠ¨é€‰æ‹©ï¼‰
CREATE INDEX idx_age ON users(age) USING BTREE;

-- é™åºç´¢å¼•ï¼ˆMySQL 8.0æ”¯æŒï¼‰
CREATE INDEX idx_created_desc ON orders(created_at DESC);
```

### 2.2 å­—æ®µç´¢å¼•ç­–ç•¥


**ğŸ”§ ä¸åŒæ•°æ®ç±»å‹çš„ç´¢å¼•ç­–ç•¥**

**æ•°å€¼ç±»å‹å­—æ®µ**
```sql
-- æ•´æ•°å­—æ®µç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);        -- æ•ˆç‡æœ€é«˜
CREATE INDEX idx_amount ON orders(amount);          -- é‡‘é¢èŒƒå›´æŸ¥è¯¢
CREATE INDEX idx_status ON orders(status);          -- çŠ¶æ€è¿‡æ»¤

-- ä¼˜åŒ–å»ºè®®
ALTER TABLE orders ADD INDEX idx_price_range(price);  -- å•†å“ä»·æ ¼èŒƒå›´æŸ¥è¯¢

å®é™…åº”ç”¨ï¼š
SELECT * FROM orders WHERE user_id = 12345;         -- ç›´æ¥å®šä½
SELECT * FROM orders WHERE amount BETWEEN 100 AND 500; -- èŒƒå›´æŸ¥è¯¢
SELECT * FROM orders WHERE status IN (1, 2, 3);     -- å¤šå€¼æŸ¥è¯¢
```

**å­—ç¬¦ä¸²ç±»å‹å­—æ®µ**
```sql
-- å®Œæ•´å­—ç¬¦ä¸²ç´¢å¼•
CREATE INDEX idx_username ON users(username);        -- ç™»å½•æŸ¥è¯¢

-- å‰ç¼€ç´¢å¼•ï¼ˆé•¿å­—ç¬¦ä¸²ä¼˜åŒ–ï¼‰
CREATE INDEX idx_email_prefix ON users(email(20));   -- åªç´¢å¼•å‰20ä¸ªå­—ç¬¦
CREATE INDEX idx_title_prefix ON articles(title(50)); -- æ–‡ç« æ ‡é¢˜å‰ç¼€

-- å¤§å°å†™æ•æ„Ÿç´¢å¼•
CREATE INDEX idx_code_binary ON products(code) COLLATE utf8mb4_bin;

å‰ç¼€ç´¢å¼•é€‰æ‹©ï¼š
-- åˆ†æå­—ç¬¦ä¸²å‰ç¼€çš„é€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT email) / COUNT(*) as full_selectivity,
    COUNT(DISTINCT LEFT(email, 10)) / COUNT(*) as prefix_10_selectivity,
    COUNT(DISTINCT LEFT(email, 20)) / COUNT(*) as prefix_20_selectivity
FROM users;

é€‰æ‹©åŸåˆ™ï¼šå‰ç¼€é€‰æ‹©æ€§ > 0.8 æ—¶æ¯”è¾ƒåˆé€‚
```

**æ—¶é—´æ—¥æœŸç±»å‹å­—æ®µ**
```sql
-- æ—¶é—´æˆ³ç´¢å¼•
CREATE INDEX idx_created_at ON orders(created_at);
CREATE INDEX idx_updated_at ON users(updated_at);

-- æ—¥æœŸèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_order_date ON orders(DATE(created_at));

å®é™…æŸ¥è¯¢åœºæ™¯ï¼š
-- ä»Šæ—¥è®¢å•
SELECT * FROM orders WHERE DATE(created_at) = CURDATE();

-- æœ€è¿‘ä¸€å‘¨
SELECT * FROM orders WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY);

-- æŒ‡å®šæœˆä»½
SELECT * FROM orders WHERE YEAR(created_at) = 2024 AND MONTH(created_at) = 12;
```

### 2.3 ç´¢å¼•é€‰æ‹©æ€§åˆ†æ


**ğŸ“Š ä»€ä¹ˆæ˜¯ç´¢å¼•é€‰æ‹©æ€§**
```
ç´¢å¼•é€‰æ‹©æ€§ = ä¸åŒå€¼çš„æ•°é‡ / æ€»è®°å½•æ•°

é«˜é€‰æ‹©æ€§ï¼ˆæ¥è¿‘1ï¼‰ï¼š
â€¢ ä¸»é”®IDï¼šæ¯è¡Œéƒ½ä¸åŒï¼Œé€‰æ‹©æ€§=1.0
â€¢ é‚®ç®±åœ°å€ï¼šåŸºæœ¬ä¸é‡å¤ï¼Œé€‰æ‹©æ€§â‰ˆ0.99
â€¢ æ‰‹æœºå·ç ï¼šåŸºæœ¬ä¸é‡å¤ï¼Œé€‰æ‹©æ€§â‰ˆ0.98

ä½é€‰æ‹©æ€§ï¼ˆæ¥è¿‘0ï¼‰ï¼š
â€¢ æ€§åˆ«å­—æ®µï¼šåªæœ‰ç”·/å¥³ï¼Œé€‰æ‹©æ€§â‰ˆ0.5
â€¢ çŠ¶æ€å­—æ®µï¼šæœ‰é™å‡ ä¸ªçŠ¶æ€ï¼Œé€‰æ‹©æ€§â‰ˆ0.1
â€¢ å¸ƒå°”å­—æ®µï¼šåªæœ‰true/falseï¼Œé€‰æ‹©æ€§=0.5

å»ºè®®é˜ˆå€¼ï¼šé€‰æ‹©æ€§ > 0.8 æ—¶å»ºè®®åˆ›å»ºç´¢å¼•
```

**ğŸ”§ é€‰æ‹©æ€§åˆ†æSQL**
```sql
-- åˆ†æå­—æ®µé€‰æ‹©æ€§
SELECT 
    'email' AS field_name,
    COUNT(DISTINCT email) AS distinct_values,
    COUNT(*) AS total_rows,
    COUNT(DISTINCT email) / COUNT(*) AS selectivity
FROM users

UNION ALL

SELECT 
    'status' AS field_name,
    COUNT(DISTINCT status) AS distinct_values,
    COUNT(*) AS total_rows,
    COUNT(DISTINCT status) / COUNT(*) AS selectivity
FROM users

UNION ALL

SELECT 
    'gender' AS field_name,
    COUNT(DISTINCT gender) AS distinct_values,
    COUNT(*) AS total_rows,
    COUNT(DISTINCT gender) / COUNT(*) AS selectivity
FROM users;

-- ç»“æœç¤ºä¾‹
+------------+----------------+------------+-------------+
| field_name | distinct_values| total_rows | selectivity |
+------------+----------------+------------+-------------+
| email      | 9950           | 10000      | 0.9950      | â† é«˜é€‰æ‹©æ€§ï¼Œé€‚åˆç´¢å¼•
| status     | 5              | 10000      | 0.0005      | â† ä½é€‰æ‹©æ€§ï¼Œä¸é€‚åˆç´¢å¼•
| gender     | 2              | 10000      | 0.0002      | â† æä½é€‰æ‹©æ€§ï¼Œä¸å»ºè®®ç´¢å¼•
+------------+----------------+------------+-------------+
```

---

## 3. ğŸ”— å¤åˆç´¢å¼•è®¾è®¡åŸç†


### 3.1 å¤åˆç´¢å¼•åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤åˆç´¢å¼•**
```
å¤åˆç´¢å¼•ï¼šå¯¹å¤šä¸ªå­—æ®µç»„åˆå»ºç«‹çš„ç´¢å¼•
åˆ«åï¼šç»„åˆç´¢å¼•ã€è”åˆç´¢å¼•ã€å¤šåˆ—ç´¢å¼•

ç”Ÿæ´»ä¾‹å­ï¼š
ç”µè¯å·ç ç°¿æŒ‰"å§“æ°+åå­—"æ’åº
å…ˆæŒ‰å§“æ°æ’åºï¼Œå§“æ°ç›¸åŒå†æŒ‰åå­—æ’åº

æ•°æ®åº“ä¸­ï¼š
CREATE INDEX idx_name_age ON users(last_name, first_name, age);
ç´¢å¼•ç»“æ„ï¼šå…ˆæŒ‰last_nameæ’åºï¼Œç›¸åŒæ—¶æŒ‰first_nameæ’åºï¼Œå†ç›¸åŒæ—¶æŒ‰ageæ’åº
```

### 3.2 å¤åˆç´¢å¼•å­—æ®µé¡ºåºçš„å…³é”®æ€§


**ğŸ¯ å­—æ®µé¡ºåºä¸ºä»€ä¹ˆé‡è¦**
```
ç´¢å¼• idx_name_age(last_name, first_name, age) çš„å†…éƒ¨ç»“æ„ï¼š

(å¼ , ä¸‰, 25) â†’ Row1
(å¼ , ä¸‰, 30) â†’ Row2  
(å¼ , å››, 22) â†’ Row3
(æ, æ˜, 28) â†’ Row4
(æ, å, 35) â†’ Row5

æŸ¥è¯¢åŒ¹é…æƒ…å†µï¼š
âœ… WHERE last_name = 'å¼ '                    -- å¯ä»¥ä½¿ç”¨ç´¢å¼•
âœ… WHERE last_name = 'å¼ ' AND first_name = 'ä¸‰' -- å¯ä»¥ä½¿ç”¨ç´¢å¼•
âœ… WHERE last_name = 'å¼ ' AND first_name = 'ä¸‰' AND age = 25 -- å¯ä»¥ä½¿ç”¨ç´¢å¼•
âŒ WHERE first_name = 'ä¸‰'                   -- æ— æ³•ä½¿ç”¨ç´¢å¼•
âŒ WHERE age = 25                           -- æ— æ³•ä½¿ç”¨ç´¢å¼•
âš¡ WHERE last_name = 'å¼ ' AND age = 25       -- éƒ¨åˆ†ä½¿ç”¨ç´¢å¼•
```

**ğŸ“‹ å­—æ®µé¡ºåºè®¾è®¡åŸåˆ™**

**åŸåˆ™1ï¼šæœ€å·¦å‰ç¼€åŒ¹é…**
```sql
-- ç´¢å¼•ï¼šidx_compound(a, b, c)
-- å¯ä»¥åŒ¹é…çš„æŸ¥è¯¢æ¨¡å¼ï¼š
WHERE a = ?                     -- ä½¿ç”¨ a
WHERE a = ? AND b = ?           -- ä½¿ç”¨ a, b  
WHERE a = ? AND b = ? AND c = ? -- ä½¿ç”¨ a, b, c
WHERE a = ? AND c = ?           -- åªä½¿ç”¨ a

-- æ— æ³•åŒ¹é…çš„æŸ¥è¯¢æ¨¡å¼ï¼š
WHERE b = ?                     -- è·³è¿‡äº†a
WHERE c = ?                     -- è·³è¿‡äº†aå’Œb
WHERE b = ? AND c = ?           -- è·³è¿‡äº†a
```

**åŸåˆ™2ï¼šé€‰æ‹©æ€§é€’å‡æ’åº**
```sql
-- å­—æ®µé€‰æ‹©æ€§åˆ†æ
SELECT 
    COUNT(DISTINCT status) / COUNT(*) as status_selectivity,    -- 0.01
    COUNT(DISTINCT city) / COUNT(*) as city_selectivity,        -- 0.1
    COUNT(DISTINCT user_id) / COUNT(*) as user_id_selectivity   -- 0.9
FROM orders;

-- æ­£ç¡®çš„å­—æ®µé¡ºåºï¼ˆé€‰æ‹©æ€§ä»é«˜åˆ°ä½ï¼‰
CREATE INDEX idx_orders_optimal ON orders(user_id, city, status);

-- é”™è¯¯çš„å­—æ®µé¡ºåºï¼ˆé€‰æ‹©æ€§ä»ä½åˆ°é«˜ï¼‰
CREATE INDEX idx_orders_poor ON orders(status, city, user_id);
```

**åŸåˆ™3ï¼šæŸ¥è¯¢é¢‘ç‡ä¼˜å…ˆ**
```sql
-- åˆ†ææŸ¥è¯¢æ¨¡å¼
-- æŸ¥è¯¢1ï¼š90% é¢‘ç‡
SELECT * FROM orders WHERE user_id = ? AND status = ?;

-- æŸ¥è¯¢2ï¼š10% é¢‘ç‡  
SELECT * FROM orders WHERE city = ? AND status = ?;

-- æ¨èç´¢å¼•è®¾è®¡
CREATE INDEX idx_user_status ON orders(user_id, status);  -- è¦†ç›–90%æŸ¥è¯¢
CREATE INDEX idx_city_status ON orders(city, status);     -- è¦†ç›–10%æŸ¥è¯¢
```

### 3.3 å¤åˆç´¢å¼•é•¿åº¦æ§åˆ¶


**ğŸ“ ç´¢å¼•é•¿åº¦çš„å½±å“**
```
ç´¢å¼•é•¿åº¦å½±å“ï¼š
â€¢ å†…å­˜å ç”¨ï¼šç´¢å¼•è¶Šé•¿ï¼Œç¼“å­˜æ•ˆç‡è¶Šä½
â€¢ ç£ç›˜IOï¼šç´¢å¼•é¡µå­˜å‚¨çš„æ¡ç›®è¶Šå°‘
â€¢ æ¯”è¾ƒæˆæœ¬ï¼šå­—ç¬¦ä¸²æ¯”è¾ƒè€—æ—¶å¢åŠ 

é•¿åº¦æ§åˆ¶ç­–ç•¥ï¼š
â€¢ æ•°å€¼å­—æ®µï¼šé€šå¸¸ä¸éœ€è¦é™åˆ¶é•¿åº¦
â€¢ å­—ç¬¦ä¸²å­—æ®µï¼šæ ¹æ®å®é™…éœ€è¦æˆªå–å‰ç¼€
â€¢ å¤åˆç´¢å¼•ï¼šæ€»é•¿åº¦ä¸è¶…è¿‡767å­—èŠ‚ï¼ˆInnoDBé™åˆ¶ï¼‰
```

**ğŸ”§ å‰ç¼€ç´¢å¼•çš„è®¾è®¡**
```sql
-- åˆ†æå­—ç¬¦ä¸²å­—æ®µçš„æœ€ä½³å‰ç¼€é•¿åº¦
SELECT 
    LEFT(email, 5) as prefix_5, COUNT(*) as count_5,
    LEFT(email, 10) as prefix_10, COUNT(*) as count_10,
    LEFT(email, 15) as prefix_15, COUNT(*) as count_15,
    LEFT(email, 20) as prefix_20, COUNT(*) as count_20
FROM users 
GROUP BY LEFT(email, 5), LEFT(email, 10), LEFT(email, 15), LEFT(email, 20);

-- é€‰æ‹©æ€§åˆ†æ
SELECT 
    ROUND(COUNT(DISTINCT LEFT(email, 5))/COUNT(*), 4) AS selectivity_5,
    ROUND(COUNT(DISTINCT LEFT(email, 10))/COUNT(*), 4) AS selectivity_10,
    ROUND(COUNT(DISTINCT LEFT(email, 15))/COUNT(*), 4) AS selectivity_15,
    ROUND(COUNT(DISTINCT LEFT(email, 20))/COUNT(*), 4) AS selectivity_20
FROM users;

-- åˆ›å»ºåˆé€‚é•¿åº¦çš„å‰ç¼€ç´¢å¼•
CREATE INDEX idx_email_prefix ON users(email(15));  -- é€‰æ‹©æ€§è¾¾åˆ°0.95ä»¥ä¸Š
```

---

## 4. ğŸš€ é«˜çº§ç´¢å¼•ç±»å‹åº”ç”¨


### 4.1 å‡½æ•°ç´¢å¼•å­—æ®µåº”ç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯å‡½æ•°ç´¢å¼•**
```
å‡½æ•°ç´¢å¼•ï¼šåŸºäºå­—æ®µç»è¿‡å‡½æ•°è®¡ç®—åçš„å€¼å»ºç«‹ç´¢å¼•
ç”¨é€”ï¼šä¼˜åŒ–æ¶‰åŠå‡½æ•°è®¡ç®—çš„æŸ¥è¯¢æ¡ä»¶

ä¼ ç»ŸæŸ¥è¯¢é—®é¢˜ï¼š
SELECT * FROM orders WHERE YEAR(created_at) = 2024;
é—®é¢˜ï¼šæ— æ³•ä½¿ç”¨created_atå­—æ®µçš„æ™®é€šç´¢å¼•ï¼Œå› ä¸ºç”¨äº†YEARå‡½æ•°

å‡½æ•°ç´¢å¼•è§£å†³ï¼š
CREATE INDEX idx_created_year ON orders((YEAR(created_at)));
ç°åœ¨å¯ä»¥é«˜æ•ˆæ‰§è¡Œä¸Šè¿°æŸ¥è¯¢
```

**ğŸ’» MySQL 8.0å‡½æ•°ç´¢å¼•ç¤ºä¾‹**
```sql
-- æ—¥æœŸå‡½æ•°ç´¢å¼•
CREATE INDEX idx_order_year ON orders((YEAR(created_at)));
CREATE INDEX idx_order_month ON orders((DATE_FORMAT(created_at, '%Y-%m')));

-- å­—ç¬¦ä¸²å‡½æ•°ç´¢å¼•
CREATE INDEX idx_email_domain ON users((SUBSTRING_INDEX(email, '@', -1)));
CREATE INDEX idx_name_upper ON users((UPPER(first_name)));

-- JSONå‡½æ•°ç´¢å¼•
CREATE INDEX idx_json_age ON users((JSON_EXTRACT(profile, '$.age')));

-- æ•°å­¦å‡½æ•°ç´¢å¼•
CREATE INDEX idx_total_amount ON order_items((price * quantity));

-- å®é™…æŸ¥è¯¢ç¤ºä¾‹
-- æŒ‰å¹´ä»½æŸ¥è¯¢è®¢å•
SELECT * FROM orders WHERE YEAR(created_at) = 2024;  -- ä½¿ç”¨ idx_order_year

-- æŒ‰é‚®ç®±åŸŸåæŸ¥è¯¢ç”¨æˆ·
SELECT * FROM users WHERE SUBSTRING_INDEX(email, '@', -1) = 'gmail.com';  -- ä½¿ç”¨ idx_email_domain

-- æŒ‰JSONå­—æ®µæŸ¥è¯¢
SELECT * FROM users WHERE JSON_EXTRACT(profile, '$.age') > 25;  -- ä½¿ç”¨ idx_json_age
```

### 4.2 è¡¨è¾¾å¼ç´¢å¼•Expression Index


**ğŸ”¸ è¡¨è¾¾å¼ç´¢å¼•çš„é«˜çº§åº”ç”¨**
```sql
-- å¤æ‚è®¡ç®—è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_profit_margin ON products(((sale_price - cost_price) / cost_price * 100));

-- å­—ç¬¦ä¸²å¤„ç†è¡¨è¾¾å¼
CREATE INDEX idx_search_name ON users((CONCAT(first_name, ' ', last_name)));

-- æ¡ä»¶è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_vip_status ON users(((
    CASE 
        WHEN total_spent > 10000 THEN 'VIP'
        WHEN total_spent > 1000 THEN 'PREMIUM'
        ELSE 'NORMAL'
    END
)));

-- ä½¿ç”¨ç¤ºä¾‹
-- æŸ¥è¯¢åˆ©æ¶¦ç‡é«˜çš„å•†å“
SELECT * FROM products 
WHERE (sale_price - cost_price) / cost_price * 100 > 20;

-- æœç´¢å…¨å
SELECT * FROM users 
WHERE CONCAT(first_name, ' ', last_name) LIKE '%John Smith%';

-- æŸ¥è¯¢VIPç”¨æˆ·
SELECT * FROM users 
WHERE (CASE 
    WHEN total_spent > 10000 THEN 'VIP'
    WHEN total_spent > 1000 THEN 'PREMIUM'
    ELSE 'NORMAL'
END) = 'VIP';
```

### 4.3 éƒ¨åˆ†ç´¢å¼•Partial Index


**ğŸ”¸ éƒ¨åˆ†ç´¢å¼•çš„æ¦‚å¿µ**
```
éƒ¨åˆ†ç´¢å¼•ï¼ˆPartial Indexï¼‰ï¼šåªå¯¹æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„è¡Œå»ºç«‹ç´¢å¼•
MySQLå®ç°ï¼šé€šè¿‡WHEREå­å¥è¿‡æ»¤æ¡ä»¶ï¼ˆMySQL 8.0.13+ï¼‰

ä¼˜åŠ¿ï¼š
â€¢ å‡å°‘ç´¢å¼•å¤§å°ï¼šåªç´¢å¼•æœ‰ç”¨çš„æ•°æ®
â€¢ æé«˜æ€§èƒ½ï¼šæ›´å°çš„ç´¢å¼•ï¼Œæ›´å¿«çš„æŸ¥è¯¢
â€¢ èŠ‚çœç©ºé—´ï¼šé¿å…ç´¢å¼•æ— ç”¨æ•°æ®

å…¸å‹åœºæ™¯ï¼š
â€¢ åªç´¢å¼•æœ‰æ•ˆè®°å½•ï¼šWHERE deleted = 0
â€¢ åªç´¢å¼•æœ€è¿‘æ•°æ®ï¼šWHERE created_at > '2024-01-01'
â€¢ åªç´¢å¼•ç‰¹å®šçŠ¶æ€ï¼šWHERE status = 'active'
```

**ğŸ’» MySQLéƒ¨åˆ†ç´¢å¼•å®ç°**
```sql
-- MySQLæš‚ä¸ç›´æ¥æ”¯æŒWHEREæ¡ä»¶çš„éƒ¨åˆ†ç´¢å¼•
-- ä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ç±»ä¼¼æ•ˆæœï¼š

-- æ–¹æ³•1ï¼šä½¿ç”¨å‡½æ•°ç´¢å¼•å®ç°éƒ¨åˆ†ç´¢å¼•æ•ˆæœ
CREATE INDEX idx_active_users ON users((
    CASE WHEN status = 'active' THEN id ELSE NULL END
));

-- æ–¹æ³•2ï¼šåˆ›å»ºè¿‡æ»¤è§†å›¾ + ç´¢å¼•
CREATE VIEW active_users AS 
SELECT * FROM users WHERE status = 'active';

CREATE INDEX idx_active_email ON active_users(email);

-- æ–¹æ³•3ï¼šè™šæ‹Ÿåˆ— + ç´¢å¼•
ALTER TABLE users ADD COLUMN active_id INT GENERATED ALWAYS AS (
    CASE WHEN status = 'active' THEN id ELSE NULL END
) VIRTUAL;

CREATE INDEX idx_active_virtual ON users(active_id);

-- æŸ¥è¯¢ä¼˜åŒ–
SELECT * FROM users WHERE status = 'active' AND email = 'user@example.com';
-- å¯ä»¥ä½¿ç”¨idx_active_virtualå¿«é€Ÿè¿‡æ»¤activeç”¨æˆ·ï¼Œç„¶ååŒ¹é…email
```

### 4.4 å¤šå€¼ç´¢å¼•Multi-valued Index


**ğŸ”¸ MySQL 8.0.17+å¤šå€¼ç´¢å¼•**
```sql
-- JSONæ•°ç»„å­—æ®µçš„å¤šå€¼ç´¢å¼•
CREATE TABLE products (
    id INT PRIMARY KEY,
    name VARCHAR(100),
    tags JSON,
    categories JSON
);

-- ä¸ºJSONæ•°ç»„åˆ›å»ºå¤šå€¼ç´¢å¼•
CREATE INDEX idx_tags ON products((CAST(tags->'$[*]' AS CHAR(50) ARRAY)));
CREATE INDEX idx_categories ON products((CAST(categories->'$[*]' AS UNSIGNED ARRAY)));

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO products VALUES 
(1, 'iPhone', '["ç”µå­äº§å“", "æ‰‹æœº", "è‹¹æœ"]', '[1, 5, 8]'),
(2, 'MacBook', '["ç”µå­äº§å“", "ç¬”è®°æœ¬", "è‹¹æœ"]', '[1, 3, 8]'),
(3, 'AirPods', '["ç”µå­äº§å“", "è€³æœº", "è‹¹æœ"]', '[1, 6, 8]');

-- é«˜æ•ˆæŸ¥è¯¢JSONæ•°ç»„ä¸­çš„å€¼
SELECT * FROM products 
WHERE JSON_OVERLAPS(tags, '["æ‰‹æœº"]');              -- ä½¿ç”¨å¤šå€¼ç´¢å¼•

SELECT * FROM products 
WHERE JSON_CONTAINS(categories, '8');              -- ä½¿ç”¨å¤šå€¼ç´¢å¼•

-- ä¼ ç»Ÿæ–¹æ³•å¯¹æ¯”ï¼ˆæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM products 
WHERE JSON_SEARCH(tags, 'one', 'æ‰‹æœº') IS NOT NULL;  -- å…¨è¡¨æ‰«æ
```

### 4.5 ä¸å¯è§ç´¢å¼•Invisible Index


**ğŸ”¸ ä¸å¯è§ç´¢å¼•çš„ä½œç”¨**
```
ä¸å¯è§ç´¢å¼•ï¼šå­˜åœ¨ä½†ä¸è¢«ä¼˜åŒ–å™¨ä½¿ç”¨çš„ç´¢å¼•
ç”¨é€”ï¼š
â€¢ æµ‹è¯•ç´¢å¼•æ•ˆæœï¼šåˆ›å»ºåè§‚å¯Ÿæ˜¯å¦æœ‰æ€§èƒ½æå‡
â€¢ æ¸è¿›å¼åˆ é™¤ï¼šå…ˆè®¾ä¸ºä¸å¯è§ï¼Œç¡®è®¤æ— å½±å“ååˆ é™¤
â€¢ A/Bæµ‹è¯•ï¼šå¯¹æ¯”æœ‰æ— æŸä¸ªç´¢å¼•çš„æ€§èƒ½å·®å¼‚

çŠ¶æ€è½¬æ¢ï¼š
VISIBLEï¼ˆå¯è§ï¼‰ â†” INVISIBLEï¼ˆä¸å¯è§ï¼‰
```

**ğŸ”§ ä¸å¯è§ç´¢å¼•æ“ä½œ**
```sql
-- åˆ›å»ºä¸å¯è§ç´¢å¼•
CREATE INDEX idx_test_invisible ON users(last_login) INVISIBLE;

-- å°†ç°æœ‰ç´¢å¼•è®¾ä¸ºä¸å¯è§
ALTER TABLE users ALTER INDEX idx_email INVISIBLE;

-- å°†ç´¢å¼•æ¢å¤ä¸ºå¯è§
ALTER TABLE users ALTER INDEX idx_email VISIBLE;

-- æŸ¥çœ‹ç´¢å¼•å¯è§æ€§çŠ¶æ€
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    IS_VISIBLE
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'mydb' 
  AND TABLE_NAME = 'users';

-- å¼ºåˆ¶ä½¿ç”¨ä¸å¯è§ç´¢å¼•ï¼ˆæµ‹è¯•ç”¨ï¼‰
SET SESSION optimizer_use_invisible_indexes = ON;
SELECT * FROM users WHERE last_login > '2024-01-01';
SET SESSION optimizer_use_invisible_indexes = OFF;

-- æµ‹è¯•æµç¨‹ç¤ºä¾‹
-- 1. åˆ›å»ºä¸å¯è§ç´¢å¼•
CREATE INDEX idx_test ON orders(status) INVISIBLE;

-- 2. æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
EXPLAIN SELECT * FROM orders WHERE status = 'pending';  -- ä¸ä½¿ç”¨ç´¢å¼•

-- 3. ä¸´æ—¶å¯ç”¨æµ‹è¯•
SET SESSION optimizer_use_invisible_indexes = ON;
EXPLAIN SELECT * FROM orders WHERE status = 'pending';  -- ä½¿ç”¨ç´¢å¼•
SET SESSION optimizer_use_invisible_indexes = OFF;

-- 4. å¦‚æœæœ‰æ€§èƒ½æå‡ï¼Œè®¾ä¸ºå¯è§
ALTER TABLE orders ALTER INDEX idx_test VISIBLE;
```

### 4.6 æ¡ä»¶ç´¢å¼•Conditional Index


**ğŸ”¸ æ¡ä»¶ç´¢å¼•çš„å®ç°æ€è·¯**
```
MySQLæ²¡æœ‰ç›´æ¥çš„æ¡ä»¶ç´¢å¼•ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š

æ–¹æ³•1ï¼šè™šæ‹Ÿåˆ— + ç´¢å¼•
æ–¹æ³•2ï¼šå‡½æ•°ç´¢å¼• + CASEè¡¨è¾¾å¼
æ–¹æ³•3ï¼šåˆ†åŒºè¡¨ + å±€éƒ¨ç´¢å¼•

æ ¸å¿ƒæ€æƒ³ï¼šåªä¸ºæ»¡è¶³æ¡ä»¶çš„è®°å½•å»ºç«‹ç´¢å¼•æ¡ç›®
```

**ğŸ’» æ¡ä»¶ç´¢å¼•å®ç°ç¤ºä¾‹**
```sql
-- æ–¹æ³•1ï¼šè™šæ‹Ÿåˆ—å®ç°æ¡ä»¶ç´¢å¼•
-- åªä¸ºactiveçŠ¶æ€çš„ç”¨æˆ·å»ºç«‹emailç´¢å¼•
ALTER TABLE users ADD COLUMN active_email VARCHAR(255) 
GENERATED ALWAYS AS (
    CASE WHEN status = 'active' THEN email ELSE NULL END
) VIRTUAL;

CREATE INDEX idx_active_email ON users(active_email);

-- æŸ¥è¯¢æ—¶ä½¿ç”¨æ¡ä»¶
SELECT * FROM users 
WHERE status = 'active' AND active_email = 'user@example.com';

-- æ–¹æ³•2ï¼šå‡½æ•°ç´¢å¼•å®ç°
CREATE INDEX idx_conditional_order ON orders((
    CASE WHEN status IN ('pending', 'processing') THEN user_id ELSE NULL END
));

-- æŸ¥è¯¢æœ‰æ•ˆè®¢å•
SELECT * FROM orders 
WHERE status IN ('pending', 'processing') AND user_id = 12345;

-- æ–¹æ³•3ï¼šåˆ†åŒºè¡¨å®ç°
CREATE TABLE orders_partitioned (
    id INT PRIMARY KEY,
    user_id INT,
    status VARCHAR(20),
    created_at DATETIME,
    amount DECIMAL(10,2)
) PARTITION BY LIST (status) (
    PARTITION p_active VALUES IN ('pending', 'processing', 'shipped'),
    PARTITION p_inactive VALUES IN ('completed', 'cancelled', 'refunded')
);

-- åœ¨æ´»è·ƒåˆ†åŒºåˆ›å»ºç´¢å¼•
CREATE INDEX idx_active_user ON orders_partitioned(user_id);
-- åªå½±å“æ´»è·ƒè®¢å•åˆ†åŒºï¼Œä¸ç´¢å¼•å·²å®Œæˆçš„è®¢å•
```

---

## 5. âš¡ ç´¢å¼•æ€§èƒ½ä¼˜åŒ–æŠ€å·§


### 5.1 ç´¢å¼•é•¿åº¦æ§åˆ¶ç­–ç•¥


**ğŸ“ ä¸ºä»€ä¹ˆè¦æ§åˆ¶ç´¢å¼•é•¿åº¦**
```
ç´¢å¼•é•¿åº¦çš„å½±å“ï¼š
â€¢ å†…å­˜ä½¿ç”¨ï¼šé•¿ç´¢å¼•å ç”¨æ›´å¤šbuffer pool
â€¢ IOæ•ˆç‡ï¼šä¸€ä¸ªé¡µé¢å­˜å‚¨çš„ç´¢å¼•æ¡ç›®æ›´å°‘
â€¢ æ¯”è¾ƒæˆæœ¬ï¼šé•¿å­—ç¬¦ä¸²æ¯”è¾ƒæ›´è€—æ—¶
â€¢ ç¼“å­˜æ•ˆç‡ï¼šCPUç¼“å­˜å‘½ä¸­ç‡é™ä½

MySQLç´¢å¼•é•¿åº¦é™åˆ¶ï¼š
â€¢ InnoDBï¼šå•ä¸ªç´¢å¼•é”®æœ€å¤§767å­—èŠ‚ï¼ˆrow_format=COMPACTï¼‰
â€¢ InnoDBï¼šå•ä¸ªç´¢å¼•é”®æœ€å¤§3072å­—èŠ‚ï¼ˆrow_format=DYNAMIC/COMPRESSEDï¼‰
â€¢ MyISAMï¼šå•ä¸ªç´¢å¼•é”®æœ€å¤§1000å­—èŠ‚
```

**ğŸ”§ é•¿åº¦ä¼˜åŒ–å®è·µ**
```sql
-- åŸå§‹è¡¨ç»“æ„
CREATE TABLE articles (
    id INT PRIMARY KEY,
    title VARCHAR(500),      -- æ ‡é¢˜å¯èƒ½å¾ˆé•¿
    content TEXT,            -- å†…å®¹å¾ˆé•¿
    author_email VARCHAR(255),
    url VARCHAR(1000),       -- URLå¯èƒ½å¾ˆé•¿
    created_at DATETIME
);

-- é”™è¯¯çš„ç´¢å¼•è®¾è®¡ï¼ˆå ç”¨ç©ºé—´å¤ªå¤§ï¼‰
CREATE INDEX idx_bad_long ON articles(title, content(100), url);  -- å¤ªé•¿

-- ä¼˜åŒ–çš„ç´¢å¼•è®¾è®¡
-- 1. æ ‡é¢˜å‰ç¼€ç´¢å¼•
CREATE INDEX idx_title_prefix ON articles(title(50));

-- 2. é‚®ç®±å‰ç¼€ç´¢å¼•ï¼ˆé€šå¸¸@å‰é¢çš„éƒ¨åˆ†è¶³å¤ŸåŒºåˆ†ï¼‰
CREATE INDEX idx_email_prefix ON articles(author_email(20));

-- 3. URLè·¯å¾„ç´¢å¼•ï¼ˆå»æ‰åŸŸåéƒ¨åˆ†ï¼‰
CREATE INDEX idx_url_path ON articles((SUBSTRING_INDEX(url, '/', -1)));

-- 4. å¤åˆç´¢å¼•é•¿åº¦æ§åˆ¶
CREATE INDEX idx_author_title ON articles(
    author_email(15),    -- é‚®ç®±å‰15å­—ç¬¦
    title(30)           -- æ ‡é¢˜å‰30å­—ç¬¦
);

-- éªŒè¯ç´¢å¼•æ•ˆæœ
EXPLAIN SELECT * FROM articles 
WHERE author_email LIKE 'john.doe@%' 
  AND title LIKE 'MySQLç´¢å¼•%';
```

### 5.2 ç´¢å¼•æ€§èƒ½ç›‘æ§


**ğŸ“Š ç´¢å¼•ä½¿ç”¨æƒ…å†µåˆ†æ**
```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    OBJECT_SCHEMA as 'æ•°æ®åº“',
    OBJECT_NAME as 'è¡¨å', 
    INDEX_NAME as 'ç´¢å¼•å',
    COUNT_FETCH as 'ä½¿ç”¨æ¬¡æ•°',
    COUNT_INSERT as 'æ’å…¥æ¬¡æ•°',
    COUNT_UPDATE as 'æ›´æ–°æ¬¡æ•°',
    COUNT_DELETE as 'åˆ é™¤æ¬¡æ•°'
FROM performance_schema.table_io_waits_summary_by_index_usage 
WHERE OBJECT_SCHEMA = 'mydb'
ORDER BY COUNT_FETCH DESC;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    OBJECT_SCHEMA as 'æ•°æ®åº“',
    OBJECT_NAME as 'è¡¨å',
    INDEX_NAME as 'ç´¢å¼•å'
FROM performance_schema.table_io_waits_summary_by_index_usage 
WHERE OBJECT_SCHEMA = 'mydb'
  AND INDEX_NAME IS NOT NULL 
  AND COUNT_FETCH = 0 
  AND INDEX_NAME != 'PRIMARY';

-- æŸ¥çœ‹ç´¢å¼•å¤§å°
SELECT 
    TABLE_SCHEMA as 'æ•°æ®åº“',
    TABLE_NAME as 'è¡¨å',
    INDEX_NAME as 'ç´¢å¼•å',
    ROUND(stat_value * $$innodb_page_size / 1024 / 1024, 2) as 'å¤§å°MB'
FROM mysql.innodb_index_stats 
WHERE TABLE_SCHEMA = 'mydb' 
  AND stat_name = 'size'
ORDER BY stat_value DESC;
```

**ğŸ“ˆ ç´¢å¼•æ•ˆç‡åˆ†æå·¥å…·**
```sql
-- åˆ›å»ºç´¢å¼•æ€§èƒ½åˆ†æå­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE AnalyzeIndexPerformance(IN db_name VARCHAR(64))
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE table_name VARCHAR(64);
    DECLARE cur CURSOR FOR 
        SELECT TABLE_NAME FROM information_schema.TABLES 
        WHERE TABLE_SCHEMA = db_name AND TABLE_TYPE = 'BASE TABLE';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    -- åˆ›å»ºä¸´æ—¶ç»“æœè¡¨
    DROP TEMPORARY TABLE IF EXISTS index_analysis_result;
    CREATE TEMPORARY TABLE index_analysis_result (
        table_name VARCHAR(64),
        index_name VARCHAR(64),
        cardinality BIGINT,
        selectivity DECIMAL(10,4),
        size_mb DECIMAL(10,2),
        usage_count BIGINT,
        recommendation VARCHAR(200)
    );
    
    OPEN cur;
    read_loop: LOOP
        FETCH cur INTO table_name;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- åˆ†ææ¯ä¸ªè¡¨çš„ç´¢å¼•
        SET @sql = CONCAT('
            INSERT INTO index_analysis_result
            SELECT 
                "', table_name, '" as table_name,
                s.INDEX_NAME,
                s.CARDINALITY,
                ROUND(s.CARDINALITY / t.TABLE_ROWS, 4) as selectivity,
                ROUND(IFNULL(ist.stat_value * $$innodb_page_size / 1024 / 1024, 0), 2) as size_mb,
                IFNULL(iu.COUNT_FETCH, 0) as usage_count,
                CASE 
                    WHEN IFNULL(iu.COUNT_FETCH, 0) = 0 THEN "å¯è€ƒè™‘åˆ é™¤"
                    WHEN ROUND(s.CARDINALITY / t.TABLE_ROWS, 4) < 0.1 THEN "é€‰æ‹©æ€§è¾ƒä½"
                    WHEN ROUND(IFNULL(ist.stat_value * $$innodb_page_size / 1024 / 1024, 0), 2) > 100 THEN "å ç”¨ç©ºé—´è¾ƒå¤§"
                    ELSE "æ­£å¸¸"
                END as recommendation
            FROM information_schema.STATISTICS s
            JOIN information_schema.TABLES t ON s.TABLE_NAME = t.TABLE_NAME
            LEFT JOIN mysql.innodb_index_stats ist ON s.TABLE_NAME = ist.TABLE_NAME 
                AND s.INDEX_NAME = ist.INDEX_NAME AND ist.stat_name = "size"
            LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage iu 
                ON s.TABLE_SCHEMA = iu.OBJECT_SCHEMA 
                AND s.TABLE_NAME = iu.OBJECT_NAME 
                AND s.INDEX_NAME = iu.INDEX_NAME
            WHERE s.TABLE_SCHEMA = "', db_name, '"
              AND s.TABLE_NAME = "', table_name, '"
              AND s.INDEX_NAME != "PRIMARY"');
        
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
    END LOOP;
    CLOSE cur;
    
    -- æ˜¾ç¤ºåˆ†æç»“æœ
    SELECT * FROM index_analysis_result ORDER BY size_mb DESC;
END$$
DELIMITER ;

-- ä½¿ç”¨åˆ†æå·¥å…·
CALL AnalyzeIndexPerformance('mydb');
```

### 5.3 ç´¢å¼•ç»´æŠ¤ä¸ä¼˜åŒ–


**ğŸ”§ ç´¢å¼•ç»´æŠ¤æœ€ä½³å®è·µ**
```sql
-- 1. å®šæœŸåˆ†æè¡¨ç»“æ„
ANALYZE TABLE users;

-- 2. æ£€æŸ¥ç´¢å¼•ç¢ç‰‡åŒ–
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    DATA_FREE / 1024 / 1024 as 'ç¢ç‰‡ç©ºé—´MB'
FROM information_schema.TABLES 
WHERE TABLE_SCHEMA = 'mydb' 
  AND DATA_FREE > 0;

-- 3. é‡å»ºç¢ç‰‡åŒ–ä¸¥é‡çš„ç´¢å¼•
ALTER TABLE users ENGINE = InnoDB;  -- é‡å»ºæ•´ä¸ªè¡¨
-- æˆ–è€…
OPTIMIZE TABLE users;                -- ä¼˜åŒ–è¡¨ç»“æ„

-- 4. åœ¨çº¿æ·»åŠ ç´¢å¼•ï¼ˆMySQL 5.6+ï¼‰
-- å¤§è¡¨åœ¨çº¿æ·»åŠ ç´¢å¼•ï¼Œä¸é˜»å¡è¯»å†™
ALTER TABLE large_table ADD INDEX idx_new_field(field_name), ALGORITHM=INPLACE, LOCK=NONE;

-- 5. åˆ é™¤é‡å¤å’Œå†—ä½™ç´¢å¼•
-- æŸ¥æ‰¾é‡å¤ç´¢å¼•
SELECT 
    GROUP_CONCAT(INDEX_NAME) as duplicate_indexes,
    GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX) as columns
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'mydb'
GROUP BY TABLE_NAME, GROUP_CONCAT(COLUMN_NAME ORDER BY SEQ_IN_INDEX)
HAVING COUNT(*) > 1;
```

---

## 6. ğŸ“‹ ç´¢å¼•ç­–ç•¥é€‰æ‹©æ–¹æ³•


### 6.1 ä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼åˆ†æ


**ğŸ” æŸ¥è¯¢æ¨¡å¼åˆ†ç±»**
```
å¸¸è§æŸ¥è¯¢æ¨¡å¼è¯†åˆ«ï¼š

1. ç‚¹æŸ¥è¯¢ï¼ˆPoint Queryï¼‰
SELECT * FROM users WHERE id = 123;
ç´¢å¼•ç­–ç•¥ï¼šå•åˆ—ç´¢å¼•ï¼Œä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•

2. èŒƒå›´æŸ¥è¯¢ï¼ˆRange Queryï¼‰  
SELECT * FROM orders WHERE created_at BETWEEN '2024-01-01' AND '2024-12-31';
ç´¢å¼•ç­–ç•¥ï¼šå•åˆ—B+Treeç´¢å¼•ï¼Œæ”¯æŒèŒƒå›´æ‰«æ

3. å¤åˆæ¡ä»¶æŸ¥è¯¢ï¼ˆMulti-condition Queryï¼‰
SELECT * FROM orders WHERE user_id = 123 AND status = 'pending';
ç´¢å¼•ç­–ç•¥ï¼šå¤åˆç´¢å¼•ï¼Œæ³¨æ„å­—æ®µé¡ºåº

4. æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆPattern Queryï¼‰
SELECT * FROM products WHERE name LIKE 'iPhone%';
ç´¢å¼•ç­–ç•¥ï¼šå‰ç¼€ç´¢å¼•æˆ–å…¨æ–‡ç´¢å¼•

5. æ’åºæŸ¥è¯¢ï¼ˆOrder Queryï¼‰
SELECT * FROM users ORDER BY created_at DESC LIMIT 10;
ç´¢å¼•ç­–ç•¥ï¼šè¦†ç›–ç´¢å¼•ï¼Œé¿å…é¢å¤–æ’åº

6. åˆ†ç»„ç»Ÿè®¡æŸ¥è¯¢ï¼ˆGroup Queryï¼‰
SELECT status, COUNT(*) FROM orders GROUP BY status;
ç´¢å¼•ç­–ç•¥ï¼šå¤åˆç´¢å¼•æ”¯æŒåˆ†ç»„
```

**ğŸ“Š æŸ¥è¯¢é¢‘ç‡åˆ†ææ–¹æ³•**
```sql
-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ
SET GLOBAL slow_query_log = 1;
SET GLOBAL long_query_time = 0.1;  -- è®°å½•è¶…è¿‡0.1ç§’çš„æŸ¥è¯¢

-- åˆ†ææŸ¥è¯¢æ¨¡å¼çš„è„šæœ¬ï¼ˆä¼ªä»£ç ï¼‰
-- é€šè¿‡åº”ç”¨æ—¥å¿—æˆ–æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ
/*
æŸ¥è¯¢ç±»å‹ç»Ÿè®¡ï¼š
- ç”¨æˆ·ç™»å½•æŸ¥è¯¢ï¼ˆWHERE email = ?ï¼‰ï¼š45%
- è®¢å•åˆ—è¡¨æŸ¥è¯¢ï¼ˆWHERE user_id = ? ORDER BY created_at DESCï¼‰ï¼š25%
- å•†å“æœç´¢æŸ¥è¯¢ï¼ˆWHERE name LIKE ? AND category = ?ï¼‰ï¼š15%
- ç»Ÿè®¡æŠ¥è¡¨æŸ¥è¯¢ï¼ˆGROUP BY date, statusï¼‰ï¼š10%
- å…¶ä»–æŸ¥è¯¢ï¼š5%

åŸºäºé¢‘ç‡è®¾è®¡ç´¢å¼•ä¼˜å…ˆçº§ï¼š
1. é«˜é¢‘æŸ¥è¯¢ä¼˜å…ˆå»ºç«‹ç´¢å¼•
2. å¤åˆæŸ¥è¯¢è€ƒè™‘å¤åˆç´¢å¼•
3. ä½é¢‘æŸ¥è¯¢æƒè¡¡æ˜¯å¦å»ºç´¢å¼•
*/
```

### 6.2 å­—æ®µç´¢å¼•è®¾è®¡åŸåˆ™


**â­ æ ¸å¿ƒè®¾è®¡åŸåˆ™**

**åŸåˆ™1ï¼šé€‰æ‹©æ€§ä¼˜å…ˆ**
```sql
-- è®¡ç®—å­—æ®µé€‰æ‹©æ€§ï¼ŒæŒ‡å¯¼ç´¢å¼•è®¾è®¡
SELECT 
    'user_id' as field,
    COUNT(DISTINCT user_id) / COUNT(*) as selectivity
FROM orders
UNION
SELECT 
    'status' as field,
    COUNT(DISTINCT status) / COUNT(*) as selectivity  
FROM orders
UNION
SELECT 
    'created_date' as field,
    COUNT(DISTINCT DATE(created_at)) / COUNT(*) as selectivity
FROM orders;

-- ç»“æœç¤ºä¾‹
+------------+-------------+
| field      | selectivity |
+------------+-------------+
| user_id    | 0.8500      | â† é«˜é€‰æ‹©æ€§ï¼Œä¼˜å…ˆå»ºç´¢å¼•
| created_date| 0.0250     | â† ä¸­ç­‰é€‰æ‹©æ€§ï¼Œå¯ä»¥å»ºç´¢å¼•
| status     | 0.0050      | â† ä½é€‰æ‹©æ€§ï¼Œè°¨æ…å»ºç´¢å¼•
+------------+-------------+

ç´¢å¼•å»ºè®®ï¼š
CREATE INDEX idx_user_date ON orders(user_id, DATE(created_at));  -- é«˜é€‰æ‹©æ€§åœ¨å‰
```

**åŸåˆ™2ï¼šæŸ¥è¯¢è¦†ç›–ä¼˜åŒ–**
```sql
-- åˆ†ææŸ¥è¯¢æ˜¯å¦å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•
-- é¢‘ç¹æŸ¥è¯¢ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯
SELECT id, name, email, status FROM users WHERE email = ?;

-- è¦†ç›–ç´¢å¼•è®¾è®¡
CREATE INDEX idx_email_covering ON users(email, id, name, status);
-- æŸ¥è¯¢å¯ä»¥å®Œå…¨é€šè¿‡ç´¢å¼•è¿”å›ï¼Œæ— éœ€å›è¡¨

-- éªŒè¯è¦†ç›–ç´¢å¼•æ•ˆæœ
EXPLAIN SELECT id, name, email, status FROM users WHERE email = 'user@example.com';
-- Extraåˆ—æ˜¾ç¤º"Using index"è¡¨ç¤ºä½¿ç”¨äº†è¦†ç›–ç´¢å¼•
```

**åŸåˆ™3ï¼šå†™å…¥æ€§èƒ½å¹³è¡¡**
```sql
-- è¯„ä¼°ç´¢å¼•å¯¹å†™å…¥æ€§èƒ½çš„å½±å“
-- æµ‹è¯•è¡¨
CREATE TABLE test_users (
    id INT PRIMARY KEY,
    email VARCHAR(255),
    name VARCHAR(100),
    age INT,
    status VARCHAR(20),
    created_at DATETIME
);

-- åœºæ™¯1ï¼šæ— é¢å¤–ç´¢å¼•
INSERT INTO test_users VALUES (1, 'user1@example.com', 'User1', 25, 'active', NOW());
-- å†™å…¥é€Ÿåº¦ï¼šæœ€å¿«

-- åœºæ™¯2ï¼šæ·»åŠ å¿…è¦ç´¢å¼•
CREATE INDEX idx_email ON test_users(email);
CREATE INDEX idx_status_created ON test_users(status, created_at);
-- å†™å…¥é€Ÿåº¦ï¼šç•¥æœ‰ä¸‹é™ï¼Œä½†æŸ¥è¯¢å¤§å¹…æå‡

-- åœºæ™¯3ï¼šè¿‡åº¦ç´¢å¼•
CREATE INDEX idx_name ON test_users(name);
CREATE INDEX idx_age ON test_users(age);  
CREATE INDEX idx_created ON test_users(created_at);
-- å†™å…¥é€Ÿåº¦ï¼šæ˜æ˜¾ä¸‹é™ï¼Œå¤§éƒ¨åˆ†ç´¢å¼•å¯èƒ½ç”¨ä¸åˆ°

å¹³è¡¡ç­–ç•¥ï¼š
â€¢ åªä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•
â€¢ é¿å…è¿‡åº¦ç´¢å¼•ï¼Œç›‘æ§å†™å…¥æ€§èƒ½
â€¢ å®šæœŸæ¸…ç†æ— ç”¨ç´¢å¼•
```

### 6.3 å¤åˆç´¢å¼•å­—æ®µé¡ºåºä¼˜åŒ–


**ğŸ¯ å­—æ®µé¡ºåºçš„é»„é‡‘æ³•åˆ™**

**æ³•åˆ™1ï¼šç­‰å€¼åœ¨å‰ï¼ŒèŒƒå›´åœ¨å**
```sql
-- æŸ¥è¯¢æ¨¡å¼
SELECT * FROM orders 
WHERE user_id = 123              -- ç­‰å€¼æ¡ä»¶
  AND status = 'pending'         -- ç­‰å€¼æ¡ä»¶  
  AND created_at > '2024-01-01'; -- èŒƒå›´æ¡ä»¶

-- æ­£ç¡®çš„ç´¢å¼•é¡ºåº
CREATE INDEX idx_optimal ON orders(user_id, status, created_at);

-- é”™è¯¯çš„ç´¢å¼•é¡ºåº
CREATE INDEX idx_poor ON orders(created_at, user_id, status);  -- èŒƒå›´æ¡ä»¶åœ¨å‰

åŸç†è§£é‡Šï¼š
B+Treeç´¢å¼•ä¸­ï¼ŒèŒƒå›´æ¡ä»¶åé¢çš„å­—æ®µæ— æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•æ’åº
ç­‰å€¼æ¡ä»¶å¯ä»¥ç²¾ç¡®å®šä½ï¼ŒèŒƒå›´æ¡ä»¶åªèƒ½æ‰«æä¸€ä¸ªåŒºé—´
```

**æ³•åˆ™2ï¼šé«˜é¢‘æŸ¥è¯¢å­—æ®µåœ¨å‰**
```sql
-- æŸ¥è¯¢é¢‘ç‡åˆ†æ
/*
æŸ¥è¯¢Aï¼šWHERE user_id = ? AND status = ?           (80%é¢‘ç‡)
æŸ¥è¯¢Bï¼šWHERE user_id = ? AND created_at > ?       (15%é¢‘ç‡)  
æŸ¥è¯¢Cï¼šWHERE status = ? AND created_at > ?        (5%é¢‘ç‡)
*/

-- ç´¢å¼•è®¾è®¡ç­–ç•¥
CREATE INDEX idx_primary ON orders(user_id, status);     -- è¦†ç›–80%+15%=95%æŸ¥è¯¢
CREATE INDEX idx_secondary ON orders(status, created_at); -- è¦†ç›–5%æŸ¥è¯¢

-- æˆ–è€…é€‰æ‹©ä¸€ä¸ªé€šç”¨ç´¢å¼•
CREATE INDEX idx_universal ON orders(user_id, status, created_at); -- è¦†ç›–æ‰€æœ‰æŸ¥è¯¢
```

**æ³•åˆ™3ï¼šé€‰æ‹©æ€§é«˜çš„å­—æ®µåœ¨å‰**
```sql
-- è®¡ç®—å¤åˆå­—æ®µçš„ç»„åˆé€‰æ‹©æ€§
SELECT 
    COUNT(DISTINCT user_id) / COUNT(*) as user_selectivity,
    COUNT(DISTINCT status) / COUNT(*) as status_selectivity,
    COUNT(DISTINCT CONCAT(user_id, status)) / COUNT(*) as combined_selectivity
FROM orders;

-- ç»“æœç¤ºä¾‹
+------------------+-------------------+---------------------+
| user_selectivity | status_selectivity| combined_selectivity|
+------------------+-------------------+---------------------+
| 0.8500          | 0.0050           | 0.8600             |
+------------------+-------------------+---------------------+

-- åŸºäºé€‰æ‹©æ€§çš„ç´¢å¼•è®¾è®¡
CREATE INDEX idx_user_status ON orders(user_id, status);  -- user_idé€‰æ‹©æ€§æ›´é«˜ï¼Œæ”¾åœ¨å‰é¢
```

### 6.4 ç´¢å¼•ç­–ç•¥å†³ç­–æµç¨‹


**ğŸ”„ ç´¢å¼•å†³ç­–æµç¨‹å›¾**
```
æ–°æŸ¥è¯¢éœ€æ±‚
    â†“
åˆ†ææŸ¥è¯¢æ¡ä»¶
    â†“
æ˜¯å¦å·²æœ‰åˆé€‚ç´¢å¼•? â€”â€”â€” æ˜¯ â€”â€”â†’ éªŒè¯æŸ¥è¯¢è®¡åˆ’ â€”â€”â†’ ä¼˜åŒ–å®Œæˆ
    â†“ å¦
    â†“
åˆ†æå­—æ®µç‰¹å¾
â”œâ”€ å•å­—æ®µæŸ¥è¯¢ â€”â€”â†’ åˆ›å»ºå•åˆ—ç´¢å¼•
â”œâ”€ å¤šå­—æ®µANDæŸ¥è¯¢ â€”â€”â†’ åˆ›å»ºå¤åˆç´¢å¼•
â”œâ”€ å¤šå­—æ®µORæŸ¥è¯¢ â€”â€”â†’ åˆ›å»ºå¤šä¸ªå•åˆ—ç´¢å¼•
â””â”€ å‡½æ•°è®¡ç®—æŸ¥è¯¢ â€”â€”â†’ åˆ›å»ºå‡½æ•°ç´¢å¼•
    â†“
è¯„ä¼°æ€§èƒ½å½±å“
â”œâ”€ æŸ¥è¯¢æå‡ > å†™å…¥æŸå¤± â€”â€”â†’ åˆ›å»ºç´¢å¼•
â””â”€ å†™å…¥æŸå¤± > æŸ¥è¯¢æå‡ â€”â€”â†’ é‡æ–°è®¾è®¡
    â†“
ç›‘æ§ç´¢å¼•æ•ˆæœ
â”œâ”€ æ•ˆæœè‰¯å¥½ â€”â€”â†’ ä¿ç•™ç´¢å¼•
â””â”€ æ•ˆæœä¸ä½³ â€”â€”â†’ è°ƒæ•´æˆ–åˆ é™¤
```

---

## 7. ğŸ¢ å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ


### 7.1 ç”µå•†ç³»ç»Ÿç´¢å¼•è®¾è®¡æ¡ˆä¾‹


**ğŸ›’ ç”µå•†æ ¸å¿ƒè¡¨ç»“æ„**
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20),
    name VARCHAR(100),
    gender ENUM('M', 'F', 'U'),
    birthday DATE,
    status ENUM('active', 'inactive', 'banned'),
    vip_level TINYINT DEFAULT 0,
    total_spent DECIMAL(12,2) DEFAULT 0,
    last_login_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- å•†å“è¡¨  
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(500),
    category_id INT,
    brand_id INT,
    price DECIMAL(10,2),
    stock INT,
    status ENUM('active', 'inactive', 'deleted'),
    tags JSON,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- è®¢å•è¡¨
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    total_amount DECIMAL(12,2),
    status ENUM('pending', 'paid', 'shipped', 'completed', 'cancelled'),
    payment_method VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**ğŸ“Š æŸ¥è¯¢éœ€æ±‚åˆ†æ**
```sql
-- é«˜é¢‘æŸ¥è¯¢åœºæ™¯åˆ†æï¼ˆ80/20æ³•åˆ™ï¼‰

-- 1. ç”¨æˆ·ç™»å½•ï¼ˆæœ€é«˜é¢‘ - 40%ï¼‰
SELECT id, name, email, status FROM users WHERE email = ?;
-- ç´¢å¼•è®¾è®¡ï¼šé‚®ç®±å”¯ä¸€ç´¢å¼•ï¼ˆå·²æœ‰ï¼‰+ è¦†ç›–ç´¢å¼•

-- 2. ç”¨æˆ·è®¢å•åˆ—è¡¨ï¼ˆé«˜é¢‘ - 25%ï¼‰
SELECT * FROM orders WHERE user_id = ? ORDER BY created_at DESC LIMIT 20;
-- ç´¢å¼•è®¾è®¡ï¼šå¤åˆç´¢å¼•æ”¯æŒè¿‡æ»¤+æ’åº

-- 3. å•†å“æœç´¢ï¼ˆé«˜é¢‘ - 20%ï¼‰
SELECT * FROM products WHERE category_id = ? AND status = 'active' AND price BETWEEN ? AND ?;
-- ç´¢å¼•è®¾è®¡ï¼šå¤åˆç´¢å¼•è¦†ç›–å¤šæ¡ä»¶æŸ¥è¯¢

-- 4. è®¢å•çŠ¶æ€æŸ¥è¯¢ï¼ˆä¸­é¢‘ - 10%ï¼‰  
SELECT * FROM orders WHERE status = ? AND created_at > ?;
-- ç´¢å¼•è®¾è®¡ï¼šçŠ¶æ€+æ—¶é—´å¤åˆç´¢å¼•

-- 5. å…¶ä»–æŸ¥è¯¢ï¼ˆä½é¢‘ - 5%ï¼‰
-- æ ¹æ®å®é™…éœ€è¦å†³å®šæ˜¯å¦å»ºç´¢å¼•
```

**ğŸ”§ ç´¢å¼•è®¾è®¡å®æ–½**
```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE UNIQUE INDEX uk_email ON users(email);                    -- ç™»å½•æŸ¥è¯¢
CREATE INDEX idx_phone ON users(phone);                          -- æ‰‹æœºå·æŸ¥è¯¢
CREATE INDEX idx_status_vip ON users(status, vip_level);         -- VIPç”¨æˆ·ç­›é€‰
CREATE INDEX idx_spent_level ON users(total_spent DESC);         -- æ¶ˆè´¹æ’å

-- å•†å“è¡¨ç´¢å¼•  
CREATE INDEX idx_category_status_price ON products(category_id, status, price);  -- å•†å“æœç´¢
CREATE INDEX idx_brand_status ON products(brand_id, status);                     -- å“ç‰Œå•†å“
CREATE INDEX idx_name_fulltext ON products(name) USING FULLTEXT;                -- å…¨æ–‡æœç´¢
CREATE INDEX idx_tags_multi ON products((CAST(tags->'$[*]' AS CHAR(50) ARRAY))); -- æ ‡ç­¾æœç´¢

-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_user_created ON orders(user_id, created_at DESC);         -- ç”¨æˆ·è®¢å•åˆ—è¡¨
CREATE INDEX idx_status_created ON orders(status, created_at);             -- çŠ¶æ€æ—¶é—´æŸ¥è¯¢
CREATE INDEX idx_created_amount ON orders(created_at, total_amount);       -- æ—¶é—´é‡‘é¢ç»Ÿè®¡
```

### 7.2 ç´¢å¼•æ€§èƒ½éªŒè¯


**ğŸ“ˆ æ€§èƒ½æµ‹è¯•å¯¹æ¯”**
```sql
-- æµ‹è¯•æ•°æ®å‡†å¤‡
-- æ’å…¥100ä¸‡ç”¨æˆ·æ•°æ®
INSERT INTO users (email, name, status, total_spent, created_at)
SELECT 
    CONCAT('user', n, '@example.com'),
    CONCAT('User', n),
    CASE WHEN n % 10 = 0 THEN 'inactive' ELSE 'active' END,
    ROUND(RAND() * 10000, 2),
    DATE_ADD('2020-01-01', INTERVAL FLOOR(RAND() * 1460) DAY)
FROM (SELECT @row := @row + 1 as n FROM 
     (SELECT 0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3) t1,
     (SELECT 0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3) t2,
     (SELECT 0 UNION SELECT 1 UNION SELECT 2 UNION SELECT 3) t3,
     /* ... ç”Ÿæˆè¶³å¤Ÿå¤šçš„è¡Œ */
     (SELECT @row:=0) r) numbers
WHERE n <= 1000000;

-- æ€§èƒ½æµ‹è¯•å¯¹æ¯”
-- æ— ç´¢å¼•æŸ¥è¯¢
DROP INDEX idx_status_spent ON users;
SELECT SQL_NO_CACHE * FROM users WHERE status = 'active' AND total_spent > 5000;
-- æŸ¥è¯¢æ—¶é—´ï¼š~2.5ç§’ï¼Œå…¨è¡¨æ‰«æ

-- æœ‰ç´¢å¼•æŸ¥è¯¢
CREATE INDEX idx_status_spent ON users(status, total_spent);
SELECT SQL_NO_CACHE * FROM users WHERE status = 'active' AND total_spent > 5000;  
-- æŸ¥è¯¢æ—¶é—´ï¼š~0.05ç§’ï¼Œç´¢å¼•èŒƒå›´æ‰«æ

-- æ‰§è¡Œè®¡åˆ’å¯¹æ¯”
EXPLAIN FORMAT=JSON SELECT * FROM users WHERE status = 'active' AND total_spent > 5000;

{
  "query_block": {
    "select_id": 1,
    "cost_info": {
      "query_cost": "12.35"     -- æœ‰ç´¢å¼•æ—¶çš„æˆæœ¬
    },
    "table": {
      "table_name": "users",
      "access_type": "range",   -- èŒƒå›´æ‰«æ
      "possible_keys": ["idx_status_spent"],
      "key": "idx_status_spent",
      "used_key_parts": ["status", "total_spent"],
      "rows_examined_per_scan": 85,
      "rows_produced_per_join": 85,
      "cost_info": {
        "read_cost": "10.50",
        "eval_cost": "1.85"
      }
    }
  }
}
```

### 7.3 å¤æ‚ä¸šåŠ¡åœºæ™¯ç´¢å¼•è®¾è®¡


**ğŸ“± ç¤¾äº¤åª’ä½“ç³»ç»Ÿæ¡ˆä¾‹**
```sql
-- å¸–å­è¡¨ç»“æ„
CREATE TABLE posts (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    content TEXT,
    topic_id INT,
    status ENUM('draft', 'published', 'deleted') DEFAULT 'draft',
    visibility ENUM('public', 'friends', 'private') DEFAULT 'public',
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    published_at DATETIME NULL
);

-- å¤æ‚æŸ¥è¯¢éœ€æ±‚åˆ†æ
/*
æŸ¥è¯¢1ï¼šç”¨æˆ·ä¸ªäººåŠ¨æ€ (35%é¢‘ç‡)
SELECT * FROM posts WHERE user_id = ? AND status = 'published' 
ORDER BY published_at DESC LIMIT 20;

æŸ¥è¯¢2ï¼šè¯é¢˜çƒ­é—¨å¸–å­ (25%é¢‘ç‡)  
SELECT * FROM posts WHERE topic_id = ? AND status = 'published' AND visibility = 'public'
ORDER BY like_count DESC LIMIT 10;

æŸ¥è¯¢3ï¼šé¦–é¡µæ¨èfeed (25%é¢‘ç‡)
SELECT * FROM posts WHERE user_id IN (å…³æ³¨çš„ç”¨æˆ·IDåˆ—è¡¨) AND status = 'published' 
AND visibility IN ('public', 'friends') ORDER BY published_at DESC LIMIT 50;

æŸ¥è¯¢4ï¼šæœç´¢ç›¸å…³å¸–å­ (10%é¢‘ç‡)
SELECT * FROM posts WHERE MATCH(content) AGAINST('å…³é”®è¯' IN NATURAL LANGUAGE MODE)
AND status = 'published' ORDER BY published_at DESC;

æŸ¥è¯¢5ï¼šæ•°æ®ç»Ÿè®¡æŸ¥è¯¢ (5%é¢‘ç‡)
SELECT DATE(published_at), COUNT(*) FROM posts 
WHERE status = 'published' GROUP BY DATE(published_at);
*/

-- ç´¢å¼•è®¾è®¡æ–¹æ¡ˆ
-- ä¸»è¦ç´¢å¼•ï¼šè¦†ç›–é«˜é¢‘æŸ¥è¯¢
CREATE INDEX idx_user_status_published ON posts(user_id, status, published_at DESC);
CREATE INDEX idx_topic_status_visibility_likes ON posts(topic_id, status, visibility, like_count DESC);
CREATE INDEX idx_status_visibility_published ON posts(status, visibility, published_at DESC);

-- è¾…åŠ©ç´¢å¼•ï¼šè¦†ç›–ç‰¹å®šæŸ¥è¯¢
CREATE FULLTEXT INDEX idx_content_fulltext ON posts(content);
CREATE INDEX idx_published_date ON posts(DATE(published_at)) WHERE status = 'published';
```

### 7.4 ç´¢å¼•ç›‘æ§ä¸è°ƒä¼˜å®æˆ˜


**ğŸ“Š ç´¢å¼•æ•ˆæœç›‘æ§ä»ªè¡¨æ¿**
```sql
-- åˆ›å»ºç´¢å¼•ç›‘æ§è§†å›¾
CREATE VIEW v_index_performance AS
SELECT 
    t.TABLE_SCHEMA as 'æ•°æ®åº“',
    t.TABLE_NAME as 'è¡¨å',
    s.INDEX_NAME as 'ç´¢å¼•å',
    s.CARDINALITY as 'åŸºæ•°',
    ROUND(s.CARDINALITY / t.TABLE_ROWS * 100, 2) as 'é€‰æ‹©æ€§%',
    ROUND(IFNULL(ist.stat_value * $$innodb_page_size / 1024 / 1024, 0), 2) as 'å¤§å°MB',
    IFNULL(iu.COUNT_FETCH, 0) as 'æŸ¥è¯¢æ¬¡æ•°',
    IFNULL(iu.COUNT_INSERT, 0) as 'æ’å…¥æ¬¡æ•°',
    IFNULL(iu.COUNT_UPDATE, 0) as 'æ›´æ–°æ¬¡æ•°',
    IFNULL(iu.COUNT_DELETE, 0) as 'åˆ é™¤æ¬¡æ•°',
    CASE 
        WHEN IFNULL(iu.COUNT_FETCH, 0) = 0 THEN 'ğŸ”´ æœªä½¿ç”¨'
        WHEN ROUND(s.CARDINALITY / t.TABLE_ROWS * 100, 2) < 10 THEN 'ğŸŸ¡ é€‰æ‹©æ€§ä½'
        WHEN ROUND(IFNULL(ist.stat_value * $$innodb_page_size / 1024 / 1024, 0), 2) > 500 THEN 'ğŸŸ¡ å ç”¨ç©ºé—´å¤§'
        ELSE 'ğŸŸ¢ æ­£å¸¸'
    END as 'çŠ¶æ€'
FROM information_schema.STATISTICS s
JOIN information_schema.TABLES t ON s.TABLE_SCHEMA = t.TABLE_SCHEMA AND s.TABLE_NAME = t.TABLE_NAME
LEFT JOIN mysql.innodb_index_stats ist ON s.TABLE_SCHEMA = ist.database_name 
    AND s.TABLE_NAME = ist.table_name AND s.INDEX_NAME = ist.index_name AND ist.stat_name = 'size'
LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage iu 
    ON s.TABLE_SCHEMA = iu.OBJECT_SCHEMA AND s.TABLE_NAME = iu.OBJECT_NAME AND s.INDEX_NAME = iu.INDEX_NAME
WHERE s.TABLE_SCHEMA NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys')
  AND s.INDEX_NAME != 'PRIMARY'
ORDER BY iu.COUNT_FETCH DESC;

-- æŸ¥çœ‹ç›‘æ§ç»“æœ
SELECT * FROM v_index_performance WHERE æ•°æ®åº“ = 'mydb';
```

**ğŸ”§ è‡ªåŠ¨åŒ–ç´¢å¼•å»ºè®®ç³»ç»Ÿ**
```sql
-- åˆ›å»ºç´¢å¼•å»ºè®®åˆ†æå‡½æ•°
DELIMITER $$
CREATE FUNCTION get_index_recommendation(
    table_schema VARCHAR(64), 
    table_name VARCHAR(64)
) RETURNS TEXT
READS SQL DATA
DETERMINISTIC
BEGIN
    DECLARE result TEXT DEFAULT '';
    DECLARE selectivity DECIMAL(10,4);
    DECLARE usage_count BIGINT;
    DECLARE size_mb DECIMAL(10,2);
    
    -- è·å–ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
    SELECT 
        ROUND(s.CARDINALITY / t.TABLE_ROWS, 4),
        IFNULL(iu.COUNT_FETCH, 0),
        ROUND(IFNULL(ist.stat_value * $$innodb_page_size / 1024 / 1024, 0), 2)
    INTO selectivity, usage_count, size_mb
    FROM information_schema.STATISTICS s
    JOIN information_schema.TABLES t ON s.TABLE_SCHEMA = t.TABLE_SCHEMA 
        AND s.TABLE_NAME = t.TABLE_NAME
    LEFT JOIN mysql.innodb_index_stats ist ON s.TABLE_NAME = ist.table_name
    LEFT JOIN performance_schema.table_io_waits_summary_by_index_usage iu 
        ON s.TABLE_SCHEMA = iu.OBJECT_SCHEMA 
        AND s.TABLE_NAME = iu.OBJECT_NAME
    WHERE s.TABLE_SCHEMA = table_schema 
      AND s.TABLE_NAME = table_name
    LIMIT 1;
    
    -- ç”Ÿæˆå»ºè®®
    IF usage_count = 0 THEN
        SET result = 'å»ºè®®åˆ é™¤ï¼šç´¢å¼•æœªè¢«ä½¿ç”¨';
    ELSEIF selectivity < 0.1 THEN
        SET result = 'å»ºè®®ä¼˜åŒ–ï¼šé€‰æ‹©æ€§è¿‡ä½ï¼Œè€ƒè™‘å¤åˆç´¢å¼•';
    ELSEIF size_mb > 100 THEN
        SET result = 'å»ºè®®ä¼˜åŒ–ï¼šç´¢å¼•è¿‡å¤§ï¼Œè€ƒè™‘å‰ç¼€ç´¢å¼•';
    ELSE
        SET result = 'ç´¢å¼•çŠ¶æ€è‰¯å¥½';
    END IF;
    
    RETURN result;
END$$
DELIMITER ;

-- ä½¿ç”¨ç´¢å¼•å»ºè®®ç³»ç»Ÿ
SELECT 
    TABLE_NAME,
    INDEX_NAME,
    get_index_recommendation(TABLE_SCHEMA, TABLE_NAME) as recommendation
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'ecommerce' 
  AND INDEX_NAME != 'PRIMARY';
```

### 7.5 é«˜å¹¶å‘åœºæ™¯ç´¢å¼•ä¼˜åŒ–


**âš¡ ç§’æ€ç³»ç»Ÿç´¢å¼•è®¾è®¡**
```sql
-- ç§’æ€å•†å“è¡¨
CREATE TABLE seckill_products (
    id INT PRIMARY KEY,
    product_id INT,
    seckill_price DECIMAL(10,2),
    stock_count INT,
    start_time DATETIME,
    end_time DATETIME,
    status ENUM('waiting', 'active', 'ended'),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ç§’æ€è®¢å•è¡¨
CREATE TABLE seckill_orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    product_id INT,
    seckill_product_id INT,
    status ENUM('pending', 'paid', 'cancelled'),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- é«˜å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•
-- 1. å½“å‰æ´»è·ƒç§’æ€å•†å“ï¼ˆæ¯ç§’æ•°ä¸‡æ¬¡æŸ¥è¯¢ï¼‰
CREATE INDEX idx_active_seckill ON seckill_products(status, start_time, end_time) 
WHERE status = 'active';  -- æ¨¡æ‹Ÿéƒ¨åˆ†ç´¢å¼•

-- å®é™…MySQLå®ç°ï¼ˆä½¿ç”¨è™šæ‹Ÿåˆ—ï¼‰
ALTER TABLE seckill_products ADD COLUMN active_marker TINYINT 
GENERATED ALWAYS AS (CASE WHEN status = 'active' THEN 1 ELSE NULL END) VIRTUAL;
CREATE INDEX idx_active_time ON seckill_products(active_marker, start_time, end_time);

-- 2. ç”¨æˆ·å‚ä¸è®°å½•æŸ¥è¯¢ï¼ˆé˜²æ­¢é‡å¤å‚ä¸ï¼‰
CREATE UNIQUE INDEX uk_user_seckill ON seckill_orders(user_id, seckill_product_id);

-- 3. å•†å“åº“å­˜æ‰£å‡æŸ¥è¯¢ï¼ˆè¯»å†™çƒ­ç‚¹ï¼‰
CREATE INDEX idx_product_stock ON seckill_products(id, stock_count) 
WHERE stock_count > 0;  -- åªç´¢å¼•æœ‰åº“å­˜çš„å•†å“

-- æŸ¥è¯¢ç¤ºä¾‹
-- è·å–å½“å‰å¯å‚ä¸çš„ç§’æ€
SELECT sp.*, p.name 
FROM seckill_products sp
JOIN products p ON sp.product_id = p.id
WHERE sp.active_marker = 1 
  AND sp.start_time <= NOW() 
  AND sp.end_time > NOW()
  AND sp.stock_count > 0;

-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å‚ä¸
SELECT 1 FROM seckill_orders 
WHERE user_id = 12345 AND seckill_product_id = 888;
```

**ğŸ“Š é«˜å¹¶å‘ç´¢å¼•æ€§èƒ½æµ‹è¯•**
```bash
#!/bin/bash
# ç§’æ€ç³»ç»Ÿç´¢å¼•æ€§èƒ½æµ‹è¯•è„šæœ¬

# æµ‹è¯•å‚æ•°
CONCURRENT_USERS=1000
TEST_DURATION=60
MYSQL_HOST="localhost"
MYSQL_USER="test"
MYSQL_PASSWORD="test123"
DATABASE="seckill_db"

# æµ‹è¯•1ï¼šæ— ç´¢å¼•åŸºçº¿æµ‹è¯•
echo "=== åŸºçº¿æµ‹è¯•ï¼ˆæ— ç´¢å¼•ï¼‰==="
mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWORD $DATABASE -e "
DROP INDEX idx_active_time ON seckill_products;
DROP INDEX uk_user_seckill ON seckill_orders;
"

# ä½¿ç”¨sysbenchæµ‹è¯•å¹¶å‘æŸ¥è¯¢
sysbench /usr/share/sysbench/oltp_read_only.lua \
    --mysql-host=$MYSQL_HOST \
    --mysql-user=$MYSQL_USER \
    --mysql-password=$MYSQL_PASSWORD \
    --mysql-db=$DATABASE \
    --threads=$CONCURRENT_USERS \
    --time=$TEST_DURATION \
    --report-interval=10 \
    run

# æµ‹è¯•2ï¼šæœ‰ç´¢å¼•ä¼˜åŒ–æµ‹è¯•
echo "=== ä¼˜åŒ–æµ‹è¯•ï¼ˆæœ‰ç´¢å¼•ï¼‰==="
mysql -h$MYSQL_HOST -u$MYSQL_USER -p$MYSQL_PASSWORD $DATABASE -e "
CREATE INDEX idx_active_time ON seckill_products(active_marker, start_time, end_time);
CREATE UNIQUE INDEX uk_user_seckill ON seckill_orders(user_id, seckill_product_id);
"

sysbench /usr/share/sysbench/oltp_read_only.lua \
    --mysql-host=$MYSQL_HOST \
    --mysql-user=$MYSQL_USER \
    --mysql-password=$MYSQL_PASSWORD \
    --mysql-db=$DATABASE \
    --threads=$CONCURRENT_USERS \
    --time=$TEST_DURATION \
    --report-interval=10 \
    run
```

---

## 8. ğŸ”§ ç´¢å¼•ç­–ç•¥é€‰æ‹©æ–¹æ³•


### 8.1 ä¸åŒä¸šåŠ¡åœºæ™¯çš„ç´¢å¼•ç­–ç•¥


**ğŸ“‹ ä¸šåŠ¡åœºæ™¯ç´¢å¼•ç­–ç•¥å¯¹ç…§è¡¨**

| ä¸šåŠ¡åœºæ™¯ | **æŸ¥è¯¢ç‰¹ç‚¹** | **æ¨èç´¢å¼•ç­–ç•¥** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|----------------|-------------|
| **OLTPäº‹åŠ¡ç³»ç»Ÿ** | `é«˜é¢‘ç‚¹æŸ¥è¯¢` | `ç²¾ç¡®å•åˆ—+å¤åˆç´¢å¼•` | `æ§åˆ¶ç´¢å¼•æ•°é‡ï¼Œä¼˜åŒ–å†™å…¥` |
| **OLAPåˆ†æç³»ç»Ÿ** | `å¤æ‚èšåˆæŸ¥è¯¢` | `å®½è¡¨è¦†ç›–ç´¢å¼•` | `å¯ä»¥é€‚å½“å¤šå»ºç´¢å¼•` |
| **æ—¥å¿—ç³»ç»Ÿ** | `æ—¶é—´èŒƒå›´æŸ¥è¯¢` | `æ—¶é—´æˆ³+åˆ†åŒºç´¢å¼•` | `å®šæœŸæ¸…ç†å†å²ç´¢å¼•` |
| **æœç´¢ç³»ç»Ÿ** | `æ¨¡ç³Šæ–‡æœ¬æŸ¥è¯¢` | `å…¨æ–‡ç´¢å¼•+å‰ç¼€ç´¢å¼•` | `è€ƒè™‘å¤–éƒ¨æœç´¢å¼•æ“` |
| **å®æ—¶ç³»ç»Ÿ** | `çŠ¶æ€é¢‘ç¹å˜æ›´` | `å°‘é‡æ ¸å¿ƒç´¢å¼•` | `é¿å…è¿‡åº¦ç´¢å¼•å½±å“å†™å…¥` |
| **å¤§æ•°æ®ç³»ç»Ÿ** | `æ‰¹é‡æ•°æ®å¤„ç†` | `åˆ†åŒº+å±€éƒ¨ç´¢å¼•` | `è€ƒè™‘åˆ—å¼å­˜å‚¨` |

### 8.2 K8séƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©æŒ‡å—


**ğŸ“Š ç´¢å¼•è®¾è®¡å†³ç­–çŸ©é˜µ**
```
æŸ¥è¯¢é¢‘ç‡åˆ†æ
    â†“
é«˜é¢‘æŸ¥è¯¢(>50%) â†’ å¿…é¡»å»ºç´¢å¼• â†’ é€‰æ‹©æœ€ä¼˜ç´¢å¼•ç±»å‹
    â†“                          â†“
ä¸­é¢‘æŸ¥è¯¢(10-50%) â†’ æƒè¡¡å»ºç´¢å¼• â†’ å¤åˆç´¢å¼•è¦†ç›–å¤šæŸ¥è¯¢
    â†“                          â†“  
ä½é¢‘æŸ¥è¯¢(<10%) â†’ è°¨æ…å»ºç´¢å¼• â†’ è€ƒè™‘æŸ¥è¯¢ä¼˜åŒ–æ›¿ä»£
    â†“
è¯„ä¼°å­˜å‚¨å’Œç»´æŠ¤æˆæœ¬
    â†“
æœ€ç»ˆç´¢å¼•æ–¹æ¡ˆ
```

**ğŸ¯ ç´¢å¼•ç­–ç•¥é€‰æ‹©å®ç”¨æ–¹æ³•**
```sql
-- ç´¢å¼•ROIåˆ†æï¼ˆæŠ•èµ„å›æŠ¥ç‡ï¼‰
-- åˆ›å»ºåˆ†æè¡¨
CREATE TABLE index_roi_analysis (
    table_name VARCHAR(64),
    index_name VARCHAR(64),
    query_improvement_factor DECIMAL(10,2),  -- æŸ¥è¯¢æ€§èƒ½æå‡å€æ•°
    storage_cost_mb DECIMAL(10,2),           -- å­˜å‚¨æˆæœ¬
    maintenance_cost_score INT,              -- ç»´æŠ¤æˆæœ¬è¯„åˆ†(1-10)
    usage_frequency_score INT,               -- ä½¿ç”¨é¢‘ç‡è¯„åˆ†(1-10)
    roi_score DECIMAL(10,2)                  -- ROIè¯„åˆ†
);

-- ROIè®¡ç®—å…¬å¼
/*
ROIè¯„åˆ† = (æŸ¥è¯¢æ€§èƒ½æå‡ Ã— ä½¿ç”¨é¢‘ç‡ - ç»´æŠ¤æˆæœ¬ Ã— 2) / å­˜å‚¨æˆæœ¬

è¯„åˆ†è§£é‡Šï¼š
> 5.0ï¼šå¼ºçƒˆæ¨èå»ºç«‹ç´¢å¼•
2.0-5.0ï¼šæ¨èå»ºç«‹ç´¢å¼•  
0-2.0ï¼šå¯é€‰å»ºç«‹ç´¢å¼•
< 0ï¼šä¸æ¨èå»ºç«‹ç´¢å¼•
*/

-- ç¤ºä¾‹æ•°æ®
INSERT INTO index_roi_analysis VALUES
('users', 'idx_email', 50.0, 5.2, 2, 9, 86.5),     -- é«˜ROI
('users', 'idx_gender', 1.2, 2.1, 3, 2, -0.86),    -- ä½ROIï¼Œä¸å»ºè®®
('orders', 'idx_user_created', 25.0, 15.5, 4, 8, 11.2); -- ä¸­ç­‰ROI

-- æŸ¥çœ‹ROIåˆ†æç»“æœ
SELECT 
    table_name,
    index_name,
    CASE 
        WHEN roi_score > 5.0 THEN 'ğŸ”¥ å¼ºçƒˆæ¨è'
        WHEN roi_score > 2.0 THEN 'âœ… æ¨è'
        WHEN roi_score > 0 THEN 'âš¡ å¯é€‰'
        ELSE 'âŒ ä¸æ¨è'
    END as recommendation,
    roi_score
FROM index_roi_analysis
ORDER BY roi_score DESC;
```

### 8.3 ç´¢å¼•ç»´æŠ¤ç­–ç•¥


**ğŸ”„ ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```sql
-- 1. ç´¢å¼•åˆ›å»ºé˜¶æ®µ
-- åœ¨çº¿åˆ›å»ºç´¢å¼•ï¼Œé¿å…é˜»å¡ä¸šåŠ¡
ALTER TABLE large_table 
ADD INDEX idx_new_field(field_name), 
ALGORITHM=INPLACE, 
LOCK=NONE;

-- 2. ç´¢å¼•ç›‘æ§é˜¶æ®µ  
-- å®šæœŸæ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
CREATE EVENT check_index_usage
ON SCHEDULE EVERY 1 WEEK
DO
BEGIN
    -- è®°å½•ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
    INSERT INTO index_usage_history 
    SELECT 
        NOW() as check_time,
        OBJECT_SCHEMA,
        OBJECT_NAME,
        INDEX_NAME,
        COUNT_FETCH,
        COUNT_INSERT,
        COUNT_UPDATE,
        COUNT_DELETE
    FROM performance_schema.table_io_waits_summary_by_index_usage
    WHERE OBJECT_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys');
END;

-- 3. ç´¢å¼•ä¼˜åŒ–é˜¶æ®µ
-- åŸºäºä½¿ç”¨ç»Ÿè®¡ä¼˜åŒ–ç´¢å¼•
CREATE PROCEDURE optimize_indexes()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE table_name VARCHAR(64);
    DECLARE index_name VARCHAR(64);
    DECLARE usage_count BIGINT;
    
    DECLARE cur CURSOR FOR 
        SELECT OBJECT_NAME, INDEX_NAME, COUNT_FETCH
        FROM performance_schema.table_io_waits_summary_by_index_usage
        WHERE OBJECT_SCHEMA = 'mydb' 
          AND INDEX_NAME IS NOT NULL
          AND INDEX_NAME != 'PRIMARY'
          AND COUNT_FETCH = 0;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN cur;
    
    read_loop: LOOP
        FETCH cur INTO table_name, index_name, usage_count;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        -- æ ‡è®°æœªä½¿ç”¨çš„ç´¢å¼•ä¸ºä¸å¯è§
        SET @sql = CONCAT('ALTER TABLE ', table_name, 
                         ' ALTER INDEX ', index_name, ' INVISIBLE');
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
    END LOOP;
    
    CLOSE cur;
END;

-- 4. ç´¢å¼•æ¸…ç†é˜¶æ®µ
-- åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ä¸å¯è§ç´¢å¼•
CREATE PROCEDURE cleanup_unused_indexes()
BEGIN
    -- åˆ é™¤ä¸å¯è§ä¸”30å¤©æœªä½¿ç”¨çš„ç´¢å¼•
    -- å®é™…å®ç°éœ€è¦ç»“åˆä¸šåŠ¡é€»è¾‘åˆ¤æ–­
    SELECT 'Index cleanup completed' as result;
END;
```

---

## 9. ğŸ“ˆ å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ


### 9.1 ç”µå•†è®¢å•ç³»ç»Ÿå®Œæ•´ç´¢å¼•æ–¹æ¡ˆ


**ğŸ›ï¸ çœŸå®ç”µå•†åœºæ™¯ç´¢å¼•è®¾è®¡**
```sql
-- è®¢å•ä¸»è¡¨
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(32) UNIQUE,              -- è®¢å•å·
    user_id INT NOT NULL,                     -- ç”¨æˆ·ID
    shop_id INT,                              -- åº—é“ºID
    total_amount DECIMAL(12,2),               -- æ€»é‡‘é¢
    discount_amount DECIMAL(12,2) DEFAULT 0, -- ä¼˜æƒ é‡‘é¢
    payment_amount DECIMAL(12,2),             -- å®ä»˜é‡‘é¢
    payment_method ENUM('alipay', 'wechat', 'card', 'balance'),
    status ENUM('pending', 'paid', 'shipped', 'completed', 'cancelled', 'refunded'),
    province VARCHAR(20),                     -- çœä»½
    city VARCHAR(50),                         -- åŸå¸‚
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    paid_at DATETIME NULL,
    shipped_at DATETIME NULL,
    completed_at DATETIME NULL,
    INDEX idx_user_status_created(user_id, status, created_at DESC),    -- ç”¨æˆ·è®¢å•åˆ—è¡¨
    INDEX idx_status_created(status, created_at),                      -- çŠ¶æ€æ—¶é—´æŸ¥è¯¢
    INDEX idx_shop_status_created(shop_id, status, created_at DESC),   -- å•†å®¶è®¢å•ç®¡ç†
    INDEX idx_payment_method_paid(payment_method, paid_at),           -- æ”¯ä»˜ç»Ÿè®¡
    INDEX idx_province_city_created(province, city, created_at),      -- åœ°åŸŸåˆ†æ
    UNIQUE INDEX uk_order_no(order_no)                               -- è®¢å•å·å”¯ä¸€
);

-- è®¢å•å•†å“æ˜ç»†è¡¨
CREATE TABLE order_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id INT NOT NULL,
    sku_id INT NOT NULL,
    product_name VARCHAR(255),
    sku_attrs JSON,                           -- SKUå±æ€§JSON
    price DECIMAL(10,2),
    quantity INT,
    total_amount DECIMAL(12,2),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_order_id(order_id),                                     -- è®¢å•è¯¦æƒ…æŸ¥è¯¢
    INDEX idx_product_created(product_id, created_at),               -- å•†å“é”€å”®ç»Ÿè®¡
    INDEX idx_sku_created(sku_id, created_at),                       -- SKUé”€å”®åˆ†æ
    INDEX idx_price_quantity ON order_items((price * quantity)),     -- é‡‘é¢è®¡ç®—ç´¢å¼•
    FOREIGN KEY (order_id) REFERENCES orders(id)
);
```

**ğŸ“Š æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–éªŒè¯**
```sql
-- æŸ¥è¯¢1ï¼šç”¨æˆ·è®¢å•åˆ—è¡¨ï¼ˆæœ€é«˜é¢‘ï¼‰
-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ
EXPLAIN SELECT * FROM orders WHERE user_id = 12345 ORDER BY created_at DESC LIMIT 20;
/*
+----+-------------+--------+------+---------------+------+---------+------+-------+----------------+
| id | select_type | table  | type | possible_keys | key  | key_len | ref  | rows  | Extra          |
+----+-------------+--------+------+---------------+------+---------+------+-------+----------------+
|  1 | SIMPLE      | orders | ALL  | NULL          | NULL | NULL    | NULL | 50000 | Using filesort |
+----+-------------+--------+------+---------------+------+---------+------+-------+----------------+
*/

-- ä¼˜åŒ–åï¼šä½¿ç”¨å¤åˆç´¢å¼•
EXPLAIN SELECT * FROM orders WHERE user_id = 12345 ORDER BY created_at DESC LIMIT 20;
/*
+----+-------------+--------+-------+------------------------+------------------------+---------+-------+------+-------+
| id | select_type | table  | type  | possible_keys          | key                    | key_len | ref   | rows | Extra |
+----+-------------+--------+-------+------------------------+------------------------+---------+-------+------+-------+
|  1 | SIMPLE      | orders | ref   | idx_user_status_created| idx_user_status_created| 4       | const | 85   | NULL  |
+----+-------------+--------+-------+------------------------+------------------------+---------+-------+------+-------+
*/

-- æŸ¥è¯¢2ï¼šå•†å®¶è®¢å•ç»Ÿè®¡ï¼ˆé«˜é¢‘ï¼‰
EXPLAIN SELECT 
    DATE(created_at) as order_date,
    status,
    COUNT(*) as order_count,
    SUM(payment_amount) as total_revenue
FROM orders 
WHERE shop_id = 888 
  AND created_at >= '2024-01-01'
GROUP BY DATE(created_at), status;

-- ä½¿ç”¨ç´¢å¼•ï¼šidx_shop_status_created
-- æ€§èƒ½æå‡ï¼šä»2.5ç§’é™ä½åˆ°0.12ç§’
```

### 9.2 å†…å®¹ç®¡ç†ç³»ç»Ÿç´¢å¼•æ¡ˆä¾‹


**ğŸ“ åšå®¢ç³»ç»Ÿç´¢å¼•è®¾è®¡**
```sql
-- æ–‡ç« è¡¨
CREATE TABLE articles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(500) NOT NULL,
    slug VARCHAR(255) UNIQUE,                 -- URLå‹å¥½æ ‡è¯†
    author_id INT NOT NULL,
    category_id INT,
    content LONGTEXT,
    excerpt TEXT,
    status ENUM('draft', 'published', 'archived') DEFAULT 'draft',
    visibility ENUM('public', 'private', 'password') DEFAULT 'public',
    view_count INT DEFAULT 0,
    like_count INT DEFAULT 0,
    comment_count INT DEFAULT 0,
    featured BOOLEAN DEFAULT FALSE,
    published_at DATETIME NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- ç´¢å¼•è®¾è®¡
    INDEX idx_slug(slug),                                              -- URLè®¿é—®
    INDEX idx_author_status_published(author_id, status, published_at DESC), -- ä½œè€…æ–‡ç« ç®¡ç†
    INDEX idx_category_status_published(category_id, status, published_at DESC), -- åˆ†ç±»æ–‡ç« åˆ—è¡¨
    INDEX idx_status_featured_published(status, featured, published_at DESC),    -- é¦–é¡µæ¨è
    INDEX idx_published_views(published_at DESC, view_count DESC),     -- çƒ­é—¨æ–‡ç« 
    FULLTEXT INDEX idx_title_content(title, excerpt)                  -- å…¨æ–‡æœç´¢
);

-- æ ‡ç­¾å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šï¼‰
CREATE TABLE article_tags (
    article_id BIGINT,
    tag_id INT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (article_id, tag_id),
    INDEX idx_tag_article(tag_id, article_id),          -- æ ‡ç­¾æ–‡ç« åˆ—è¡¨
    INDEX idx_article_tag(article_id, tag_id)           -- æ–‡ç« æ ‡ç­¾åˆ—è¡¨
);

-- å¤æ‚æŸ¥è¯¢åœºæ™¯
-- 1. é¦–é¡µæ–‡ç« åˆ—è¡¨
SELECT a.id, a.title, a.excerpt, a.published_at, u.name as author_name
FROM articles a
JOIN users u ON a.author_id = u.id  
WHERE a.status = 'published' 
  AND a.visibility = 'public'
ORDER BY a.featured DESC, a.published_at DESC 
LIMIT 20;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_status_featured_published

-- 2. åˆ†ç±»æ–‡ç« +æ ‡ç­¾æŸ¥è¯¢
SELECT DISTINCT a.*
FROM articles a
JOIN article_tags at ON a.id = at.article_id
WHERE a.category_id = 5 
  AND a.status = 'published'
  AND at.tag_id IN (10, 15, 20)
ORDER BY a.published_at DESC
LIMIT 10;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_category_status_published + idx_tag_article

-- 3. å…¨æ–‡æœç´¢
SELECT *, MATCH(title, excerpt) AGAINST('MySQL ç´¢å¼•ä¼˜åŒ–' IN NATURAL LANGUAGE MODE) as relevance
FROM articles 
WHERE MATCH(title, excerpt) AGAINST('MySQL ç´¢å¼•ä¼˜åŒ–' IN NATURAL LANGUAGE MODE)
  AND status = 'published'
ORDER BY relevance DESC, published_at DESC
LIMIT 10;
-- ä½¿ç”¨ç´¢å¼•ï¼šidx_title_contentï¼ˆå…¨æ–‡ç´¢å¼•ï¼‰
```

### 9.3 ç´¢å¼•æ€§èƒ½ä¼˜åŒ–æŠ€å·§æ€»ç»“


**âš¡ é«˜çº§ä¼˜åŒ–æŠ€å·§**

**æŠ€å·§1ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•é¿å…å›è¡¨**
```sql
-- ä¼˜åŒ–å‰ï¼šéœ€è¦å›è¡¨æŸ¥è¯¢
CREATE INDEX idx_user_status ON orders(user_id, status);
SELECT id, user_id, status, total_amount FROM orders WHERE user_id = 123 AND status = 'paid';
-- æ‰§è¡Œè®¡åˆ’ï¼šUsing index conditionï¼ˆéœ€è¦å›è¡¨è·å–total_amountï¼‰

-- ä¼˜åŒ–åï¼šè¦†ç›–ç´¢å¼•
CREATE INDEX idx_user_status_covering ON orders(user_id, status, id, total_amount);
SELECT id, user_id, status, total_amount FROM orders WHERE user_id = 123 AND status = 'paid';
-- æ‰§è¡Œè®¡åˆ’ï¼šUsing indexï¼ˆå®Œå…¨é€šè¿‡ç´¢å¼•è¿”å›ç»“æœï¼‰

æ€§èƒ½æå‡ï¼š
â€¢ å‡å°‘ç£ç›˜I/Oï¼šä¸éœ€è¦è®¿é—®æ•°æ®é¡µ
â€¢ æå‡æŸ¥è¯¢é€Ÿåº¦ï¼šç´¢å¼•é€šå¸¸åœ¨å†…å­˜ä¸­
â€¢ é™ä½ç³»ç»Ÿè´Ÿè½½ï¼šå‡å°‘éšæœºI/Oæ“ä½œ
```

**æŠ€å·§2ï¼šç´¢å¼•æ¡ä»¶ä¸‹æ¨ä¼˜åŒ–**
```sql
-- MySQL 5.6+ ç´¢å¼•æ¡ä»¶ä¸‹æ¨ï¼ˆIndex Condition Pushdown, ICPï¼‰
-- å¤åˆç´¢å¼•ï¼šidx_user_age_city(user_id, age, city)

-- æŸ¥è¯¢ï¼šéƒ¨åˆ†ä½¿ç”¨ç´¢å¼•
SELECT * FROM users 
WHERE user_id > 1000 AND user_id < 2000   -- ä½¿ç”¨ç´¢å¼•èŒƒå›´æ‰«æ
  AND age > 25;                           -- åœ¨ç´¢å¼•å±‚é¢è¿‡æ»¤ï¼Œä¸å›è¡¨

-- æ²¡æœ‰ICPï¼šå…ˆé€šè¿‡user_idç´¢å¼•æ‰¾åˆ°è¡Œï¼Œå†å›è¡¨æ£€æŸ¥ageæ¡ä»¶
-- æœ‰ICPï¼šåœ¨ç´¢å¼•æ‰«æè¿‡ç¨‹ä¸­ç›´æ¥è¿‡æ»¤ageæ¡ä»¶ï¼Œå‡å°‘å›è¡¨æ¬¡æ•°

-- éªŒè¯ICPæ•ˆæœ
EXPLAIN SELECT * FROM users WHERE user_id > 1000 AND user_id < 2000 AND age > 25;
-- Extraåˆ—æ˜¾ç¤º"Using index condition"è¡¨ç¤ºå¯ç”¨äº†ICP
```

**æŠ€å·§3ï¼šå¤šèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–**
```sql
-- ä¼˜åŒ–å¤šä¸ªèŒƒå›´æ¡ä»¶çš„æŸ¥è¯¢
-- éœ€æ±‚ï¼šæŸ¥è¯¢ç‰¹å®šä»·æ ¼åŒºé—´å’Œæ—¶é—´åŒºé—´çš„å•†å“
SELECT * FROM products 
WHERE price BETWEEN 100 AND 500 
  AND created_at BETWEEN '2024-01-01' AND '2024-12-31';

-- æ–¹æ¡ˆ1ï¼šå•ç‹¬ç´¢å¼•ï¼ˆæ•ˆæœä¸€èˆ¬ï¼‰
CREATE INDEX idx_price ON products(price);
CREATE INDEX idx_created ON products(created_at);
-- MySQLä¼šé€‰æ‹©å…¶ä¸­ä¸€ä¸ªç´¢å¼•ï¼Œå¦ä¸€ä¸ªæ¡ä»¶éœ€è¦è¿‡æ»¤

-- æ–¹æ¡ˆ2ï¼šå¤åˆç´¢å¼•ï¼ˆæ¨èï¼‰
CREATE INDEX idx_price_created ON products(price, created_at);
-- å¯ä»¥åŒæ—¶åˆ©ç”¨ä¸¤ä¸ªèŒƒå›´æ¡ä»¶

-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨Index Mergeï¼ˆMySQLè‡ªåŠ¨ä¼˜åŒ–ï¼‰
-- MySQLå¯èƒ½ä¼šåˆå¹¶å¤šä¸ªå•åˆ—ç´¢å¼•çš„ç»“æœ
-- ä½†æ€§èƒ½é€šå¸¸ä¸å¦‚å¤åˆç´¢å¼•
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ç´¢å¼•è®¾è®¡çš„æœ¬è´¨ç†è§£**
```
ç´¢å¼• = ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ•°æ®ç»“æ„
â€¢ æœ¬è´¨ï¼šåˆ›å»ºé¢å¤–çš„æ•°æ®ç»“æ„åŠ é€ŸæŸ¥æ‰¾
â€¢ ä»£ä»·ï¼šå­˜å‚¨ç©ºé—´ + ç»´æŠ¤æˆæœ¬
â€¢ æ”¶ç›Šï¼šæŸ¥è¯¢æ€§èƒ½å¤§å¹…æå‡
â€¢ å…³é”®ï¼šæ‰¾åˆ°æœ€ä½³çš„æŠ•å…¥äº§å‡ºæ¯”
```

**ğŸ”¸ å¤åˆç´¢å¼•å­—æ®µé¡ºåºçš„æ ¸å¿ƒåŸç†**
```
æœ€å·¦å‰ç¼€åŒ¹é…åŸåˆ™ï¼š
ç´¢å¼•(A, B, C)å¯ä»¥æ”¯æŒçš„æŸ¥è¯¢ï¼š
âœ… WHERE A = ?
âœ… WHERE A = ? AND B = ?  
âœ… WHERE A = ? AND B = ? AND C = ?
âŒ WHERE B = ?ï¼ˆè·³è¿‡äº†Aï¼‰
âŒ WHERE C = ?ï¼ˆè·³è¿‡äº†Aå’ŒBï¼‰

å­—æ®µé¡ºåºå†³ç­–ï¼š
1. ç­‰å€¼æ¡ä»¶åœ¨å‰ï¼ŒèŒƒå›´æ¡ä»¶åœ¨å
2. é€‰æ‹©æ€§é«˜çš„å­—æ®µåœ¨å‰
3. æŸ¥è¯¢é¢‘ç‡é«˜çš„å­—æ®µç»„åˆåœ¨å‰
```

**ğŸ”¸ ç´¢å¼•ç±»å‹é€‰æ‹©çš„å®ç”¨æŒ‡å—**
```
B+Treeç´¢å¼•ï¼šé»˜è®¤é€‰æ‹©ï¼Œé€‚åˆ99%åœºæ™¯
å…¨æ–‡ç´¢å¼•ï¼šæ–‡æœ¬æœç´¢ï¼ŒLIKE '%å…³é”®è¯%'æŸ¥è¯¢
å‡½æ•°ç´¢å¼•ï¼šæ¶‰åŠå‡½æ•°è®¡ç®—çš„WHEREæ¡ä»¶
å¤šå€¼ç´¢å¼•ï¼šJSONæ•°ç»„å­—æ®µæŸ¥è¯¢
ç©ºé—´ç´¢å¼•ï¼šåœ°ç†ä½ç½®ç›¸å…³æŸ¥è¯¢
```

### 10.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ ç´¢å¼•è®¾è®¡çš„é»„é‡‘åŸåˆ™**
```
åŸåˆ™1ï¼šä¸šåŠ¡é©±åŠ¨ç´¢å¼•è®¾è®¡
â€¢ å…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼ï¼Œå†è®¾è®¡ç´¢å¼•
â€¢ 80%çš„æŸ¥è¯¢ç”¨20%çš„ç´¢å¼•è¦†ç›–
â€¢ é¿å…ä¸ºäº†ç´¢å¼•è€Œç´¢å¼•

åŸåˆ™2ï¼šæ€§èƒ½ä¸æˆæœ¬å¹³è¡¡
â€¢ æŸ¥è¯¢æ€§èƒ½æå‡ vs å†™å…¥æ€§èƒ½å½±å“
â€¢ å­˜å‚¨ç©ºé—´å ç”¨ vs æŸ¥è¯¢é€Ÿåº¦æ”¶ç›Š
â€¢ ç»´æŠ¤å¤æ‚åº¦ vs ä½¿ç”¨é¢‘ç‡

åŸåˆ™3ï¼šæŒç»­ç›‘æ§ä¸ä¼˜åŒ–
â€¢ å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
â€¢ æ¸…ç†æ— ç”¨å’Œé‡å¤ç´¢å¼•
â€¢ æ ¹æ®ä¸šåŠ¡å˜åŒ–è°ƒæ•´ç´¢å¼•ç­–ç•¥
```

**ğŸ”¹ å¸¸è§ç´¢å¼•è®¾è®¡è¯¯åŒº**
```
è¯¯åŒº1ï¼šç»™æ¯ä¸ªå­—æ®µéƒ½å»ºç´¢å¼•
æ­£ç¡®åšæ³•ï¼šåªä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç´¢å¼•

è¯¯åŒº2ï¼šå¤åˆç´¢å¼•å­—æ®µé¡ºåºéšæ„
æ­£ç¡®åšæ³•ï¼šéµå¾ªæœ€å·¦å‰ç¼€å’Œé€‰æ‹©æ€§åŸåˆ™

è¯¯åŒº3ï¼šå¿½ç•¥ç´¢å¼•ç»´æŠ¤æˆæœ¬
æ­£ç¡®åšæ³•ï¼šè¯„ä¼°å†™å…¥æ€§èƒ½å½±å“ï¼Œå®šæœŸæ¸…ç†

è¯¯åŒº4ï¼šç›²ç›®ä½¿ç”¨å¤åˆç´¢å¼•
æ­£ç¡®åšæ³•ï¼šåˆ†ææ˜¯å¦çœŸçš„éœ€è¦å¤šå­—æ®µç»„åˆ

è¯¯åŒº5ï¼šä¸è€ƒè™‘è¦†ç›–ç´¢å¼•ä¼˜åŒ–
æ­£ç¡®åšæ³•ï¼šä¸ºé«˜é¢‘æŸ¥è¯¢è®¾è®¡è¦†ç›–ç´¢å¼•
```

### 10.3 ç´¢å¼•ç›‘æ§ä¸è¿ç»´


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```
ç´¢å¼•æ•ˆæœç›‘æ§ï¼š
â€¢ ç´¢å¼•ä½¿ç”¨æ¬¡æ•°ï¼šperformance_schemaç»Ÿè®¡
â€¢ æŸ¥è¯¢å“åº”æ—¶é—´ï¼šæ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ
â€¢ ç´¢å¼•é€‰æ‹©æ€§ï¼šå®šæœŸé‡æ–°è®¡ç®—
â€¢ å­˜å‚¨ç©ºé—´å ç”¨ï¼šç´¢å¼•å¤§å°ç›‘æ§

ç´¢å¼•å¥åº·åº¦è¯„ä¼°ï¼š
â€¢ ä½¿ç”¨é¢‘ç‡ï¼šé«˜é¢‘ä½¿ç”¨çš„ç´¢å¼•ä¿ç•™
â€¢ ç»´æŠ¤æˆæœ¬ï¼šè¯„ä¼°å¯¹å†™å…¥æ€§èƒ½çš„å½±å“
â€¢ ç©ºé—´æ•ˆç‡ï¼šå¤§ç´¢å¼•çš„æŠ•å…¥äº§å‡ºæ¯”
â€¢ æŸ¥è¯¢è¦†ç›–ï¼šä¸€ä¸ªç´¢å¼•è¦†ç›–å¤šç§æŸ¥è¯¢æ¨¡å¼
```

**ğŸ”§ è‡ªåŠ¨åŒ–è¿ç»´å»ºè®®**
```sql
-- å»ºç«‹ç´¢å¼•ç›‘æ§å‘Šè­¦
-- 1. ç›‘æ§æ…¢æŸ¥è¯¢ä¸­çš„å…¨è¡¨æ‰«æ
SELECT 
    sql_text,
    exec_count,
    avg_timer_wait/1000000000 as avg_duration_seconds
FROM performance_schema.events_statements_summary_by_digest
WHERE sql_text LIKE '%SELECT%'
  AND avg_timer_wait/1000000000 > 1  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
ORDER BY avg_timer_wait DESC
LIMIT 10;

-- 2. ç›‘æ§æœªä½¿ç”¨çš„ç´¢å¼•
CREATE EVENT alert_unused_indexes
ON SCHEDULE EVERY 1 DAY
DO
BEGIN
    DECLARE unused_count INT;
    
    SELECT COUNT(*) INTO unused_count
    FROM performance_schema.table_io_waits_summary_by_index_usage
    WHERE OBJECT_SCHEMA = 'production_db'
      AND INDEX_NAME IS NOT NULL
      AND INDEX_NAME != 'PRIMARY'  
      AND COUNT_FETCH = 0;
    
    IF unused_count > 0 THEN
        -- å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆå®é™…éœ€è¦é…ç½®å‘Šè­¦ç³»ç»Ÿï¼‰
        INSERT INTO system_alerts(alert_type, message, created_at)
        VALUES('INDEX_UNUSED', CONCAT('å‘ç° ', unused_count, ' ä¸ªæœªä½¿ç”¨ç´¢å¼•'), NOW());
    END IF;
END;

-- 3. è‡ªåŠ¨ç´¢å¼•å»ºè®®ç³»ç»Ÿ
DELIMITER $
CREATE PROCEDURE generate_index_recommendations()
BEGIN
    -- åˆ†ææ…¢æŸ¥è¯¢ï¼Œç”Ÿæˆç´¢å¼•å»ºè®®
    CREATE TEMPORARY TABLE temp_recommendations AS
    SELECT 
        SUBSTRING_INDEX(SUBSTRING_INDEX(sql_text, 'FROM ', -1), ' ', 1) as table_name,
        sql_text,
        exec_count,
        avg_timer_wait/1000000000 as avg_duration,
        'Consider adding index based on WHERE conditions' as recommendation
    FROM performance_schema.events_statements_summary_by_digest
    WHERE sql_text LIKE '%SELECT%'
      AND sql_text LIKE '%WHERE%'
      AND avg_timer_wait/1000000000 > 0.5
      AND exec_count > 100;
    
    SELECT * FROM temp_recommendations;
    DROP TEMPORARY TABLE temp_recommendations;
END$
DELIMITER ;
```

### 10.4 å­¦ä¹ å»ºè®®å’Œå‘å±•è¶‹åŠ¿


**ğŸ“š ç´¢å¼•å­¦ä¹ è¿›é˜¶è·¯å¾„**
```
åˆçº§é˜¶æ®µï¼šæŒæ¡åŸºç¡€æ¦‚å¿µ
â€¢ ç†è§£ç´¢å¼•çš„ä½œç”¨å’Œä»£ä»·
â€¢ å­¦ä¼šåˆ›å»ºå•åˆ—å’Œå¤åˆç´¢å¼•
â€¢ æŒæ¡EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’

ä¸­çº§é˜¶æ®µï¼šä¼˜åŒ–è®¾è®¡èƒ½åŠ›  
â€¢ åˆ†æä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼
â€¢ è®¾è®¡é«˜æ•ˆçš„å¤åˆç´¢å¼•
â€¢ ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–æ€§èƒ½

é«˜çº§é˜¶æ®µï¼šç³»ç»ŸåŒ–è¿ç»´
â€¢ å»ºç«‹ç´¢å¼•ç›‘æ§ä½“ç³»
â€¢ è‡ªåŠ¨åŒ–ç´¢å¼•ä¼˜åŒ–æµç¨‹
â€¢ å¤„ç†å¤æ‚åœºæ™¯çš„ç´¢å¼•è®¾è®¡
```

**ğŸš€ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
```
æ™ºèƒ½ç´¢å¼•ä¼˜åŒ–ï¼š
â€¢ AIé©±åŠ¨çš„ç´¢å¼•æ¨èç³»ç»Ÿ
â€¢ è‡ªé€‚åº”ç´¢å¼•è‡ªåŠ¨è°ƒæ•´
â€¢ åŸºäºæœºå™¨å­¦ä¹ çš„æŸ¥è¯¢ä¼˜åŒ–

æ–°å‹ç´¢å¼•æŠ€æœ¯ï¼š
â€¢ åˆ—å¼å­˜å‚¨ç´¢å¼•ä¼˜åŒ–
â€¢ å†…å­˜æ•°æ®åº“ç´¢å¼•ç»“æ„
â€¢ åˆ†å¸ƒå¼ç´¢å¼•æŠ€æœ¯

äº‘åŸç”Ÿä¼˜åŒ–ï¼š
â€¢ äº‘æ•°æ®åº“è‡ªåŠ¨ç´¢å¼•ç®¡ç†
â€¢ å¼¹æ€§æ‰©ç¼©å®¹åœºæ™¯ä¸‹çš„ç´¢å¼•ç­–ç•¥
â€¢ å¤šäº‘ç¯å¢ƒä¸‹çš„ç´¢å¼•åŒæ­¥
```

**ğŸ’¡ å®è·µå»ºè®®**
- **ä»åˆ†æå¼€å§‹**ï¼šå…ˆåˆ†ææŸ¥è¯¢æ¨¡å¼ï¼Œå†è®¾è®¡ç´¢å¼•
- **å°æ­¥å¿«è·‘**ï¼šé€æ­¥æ·»åŠ ç´¢å¼•ï¼Œè§‚å¯Ÿæ•ˆæœ
- **æŒç»­ç›‘æ§**ï¼šå»ºç«‹ç´¢å¼•æ•ˆæœç›‘æ§æœºåˆ¶
- **å®šæœŸæ¸…ç†**ï¼šåˆ é™¤æ— ç”¨ç´¢å¼•ï¼Œä¿æŒç³»ç»Ÿæ•´æ´
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•ç´¢å¼•è®¾è®¡çš„ä¸šåŠ¡é€»è¾‘å’Œå†³ç­–è¿‡ç¨‹

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç´¢å¼•è®¾è®¡è¦ä»¥ä¸šåŠ¡æŸ¥è¯¢ä¸ºå¯¼å‘ï¼Œä¸èƒ½ç›²ç›®åˆ›å»º
- å¤åˆç´¢å¼•å­—æ®µé¡ºåºå†³å®šäº†æŸ¥è¯¢åŒ¹é…æ•ˆæœ
- ç´¢å¼•æ˜¯åŒåˆƒå‰‘ï¼Œè¦åœ¨æŸ¥è¯¢æ€§èƒ½å’Œå†™å…¥æˆæœ¬é—´æ‰¾å¹³è¡¡
- é«˜çº§ç´¢å¼•ç±»å‹èƒ½è§£å†³ç‰¹æ®Šåœºæ™¯çš„æ€§èƒ½é—®é¢˜
- ç›‘æ§å’Œç»´æŠ¤æ˜¯ç´¢å¼•é•¿æœŸæœ‰æ•ˆçš„å…³é”®ä¿éšœ