---
title: 6ã€MySQLå®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•


1. [å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€æ¦‚å¿µ](#1-å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€æ¦‚å¿µ)
2. [Dockerå•æœºéƒ¨ç½²æ–¹æ¡ˆ](#2-Dockerå•æœºéƒ¨ç½²æ–¹æ¡ˆ)
3. [å®¹å™¨æ•°æ®æŒä¹…åŒ–ç­–ç•¥](#3-å®¹å™¨æ•°æ®æŒä¹…åŒ–ç­–ç•¥)
4. [å®¹å™¨ç¼–æ’ä¸é›†ç¾¤éƒ¨ç½²](#4-å®¹å™¨ç¼–æ’ä¸é›†ç¾¤éƒ¨ç½²)
5. [Kubernetesç”Ÿäº§çº§éƒ¨ç½²](#5-Kubernetesç”Ÿäº§çº§éƒ¨ç½²)
6. [å®¹å™¨å®‰å…¨ä¸ç›‘æ§](#6-å®¹å™¨å®‰å…¨ä¸ç›‘æ§)
7. [æœ€ä½³å®è·µä¸æ•…éšœæ’æŸ¥](#7-æœ€ä½³å®è·µä¸æ•…éšœæ’æŸ¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²åŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯MySQLå®¹å™¨åŒ–



**ğŸ”¸ å®¹å™¨åŒ–çš„æœ¬è´¨**
```
ä¼ ç»Ÿéƒ¨ç½²ï¼š
ä¸»æœº â†’ æ“ä½œç³»ç»Ÿ â†’ MySQLå®‰è£…åŒ… â†’ é…ç½®æ–‡ä»¶ â†’ å¯åŠ¨æœåŠ¡

å®¹å™¨åŒ–éƒ¨ç½²ï¼š
ä¸»æœº â†’ Dockerå¼•æ“ â†’ MySQLå®¹å™¨ â†’ é•œåƒè¿è¡Œ â†’ æœåŠ¡å°±ç»ª

æ ¸å¿ƒä¼˜åŠ¿ï¼š
â€¢ ç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´
â€¢ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œæ— éœ€å¤æ‚å®‰è£…è¿‡ç¨‹
â€¢ èµ„æºéš”ç¦»ï¼šæ¯ä¸ªå®¹å™¨ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°
â€¢ ç‰ˆæœ¬ç®¡ç†ï¼šé•œåƒç‰ˆæœ¬åŒ–ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
```

### 1.2 å®¹å™¨åŒ–éƒ¨ç½²çš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜



**âœ… å®¹å™¨åŒ–ä¼˜åŠ¿**
```
éƒ¨ç½²æ•ˆç‡ï¼š
â€¢ ä¸€é”®éƒ¨ç½²ï¼šdocker runå³å¯å¯åŠ¨MySQL
â€¢ ç¯å¢ƒéš”ç¦»ï¼šä¸åŒç‰ˆæœ¬MySQLå¯åŒæ—¶è¿è¡Œ
â€¢ èµ„æºæ§åˆ¶ï¼šç²¾ç¡®æ§åˆ¶CPUã€å†…å­˜ä½¿ç”¨

è¿ç»´ä¾¿åˆ©ï¼š
â€¢ ç»Ÿä¸€ç®¡ç†ï¼šæ ‡å‡†åŒ–çš„å®¹å™¨ç®¡ç†æ–¹å¼
â€¢ å¿«é€Ÿæ‰©å®¹ï¼šæ°´å¹³æ‰©å±•å˜å¾—ç®€å•
â€¢ æ•…éšœæ¢å¤ï¼šå®¹å™¨é‡å¯æ¯”ç³»ç»Ÿé‡å¯å¿«å¾—å¤š
```

**âš ï¸ ä¸»è¦æŒ‘æˆ˜**
```
æ•°æ®æŒä¹…åŒ–ï¼š
å®¹å™¨åˆ é™¤åæ•°æ®ä¼šä¸¢å¤±ï¼Œéœ€è¦å¤–éƒ¨å­˜å‚¨

ç½‘ç»œå¤æ‚æ€§ï¼š
å®¹å™¨é—´é€šä¿¡ã€ç«¯å£æ˜ å°„éœ€è¦ç²¾å¿ƒè®¾è®¡

æ€§èƒ½è€ƒè™‘ï¼š
å®¹å™¨åŒ–å¯èƒ½å¸¦æ¥è½»å¾®çš„æ€§èƒ½å¼€é”€

è¿ç»´å¤æ‚åº¦ï¼š
éœ€è¦æŒæ¡å®¹å™¨ç¼–æ’ã€å­˜å‚¨ç®¡ç†ç­‰æ–°æŠ€èƒ½
```

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ



**ğŸ¯ æœ€é€‚åˆå®¹å™¨åŒ–çš„åœºæ™¯**
```
å¼€å‘æµ‹è¯•ç¯å¢ƒï¼š
â€¢ éœ€è¦å¿«é€Ÿåˆ›å»ºå’Œé”€æ¯æ•°æ®åº“
â€¢ å¤šä¸ªå¼€å‘è€…éœ€è¦éš”ç¦»çš„æ•°æ®åº“ç¯å¢ƒ
â€¢ CI/CDæµæ°´çº¿ä¸­çš„è‡ªåŠ¨åŒ–æµ‹è¯•

äº‘åŸç”Ÿåº”ç”¨ï¼š
â€¢ å¾®æœåŠ¡æ¶æ„ä¸­çš„æ•°æ®åº“ç»„ä»¶
â€¢ éœ€è¦å¼¹æ€§ä¼¸ç¼©çš„åº”ç”¨åœºæ™¯
â€¢ å¤šç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/é¢„ç”Ÿäº§ï¼‰ç®¡ç†
```

---

## 2. ğŸš€ Dockerå•æœºéƒ¨ç½²æ–¹æ¡ˆ



### 2.1 MySQLå®˜æ–¹Dockeré•œåƒé€‰æ‹©



**ğŸ“¦ å®˜æ–¹é•œåƒç‰ˆæœ¬å¯¹æ¯”**

| é•œåƒæ ‡ç­¾ | **MySQLç‰ˆæœ¬** | **é•œåƒå¤§å°** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|
| `mysql:8.0` | `æœ€æ–°8.0ç‰ˆæœ¬` | `çº¦500MB` | `ç”Ÿäº§ç¯å¢ƒæ¨è` |
| `mysql:5.7` | `MySQL 5.7æœ€æ–°` | `çº¦400MB` | `å…¼å®¹æ€§è€ƒè™‘` |
| `mysql:8.0-debian` | `åŸºäºDebian` | `çº¦600MB` | `éœ€è¦é¢å¤–å·¥å…·` |
| `mysql/mysql-server:8.0` | `Oracleå®˜æ–¹` | `çº¦350MB` | `æœ€å°åŒ–éƒ¨ç½²` |

**ğŸ”§ é•œåƒé€‰æ‹©å»ºè®®**
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨è - æŒ‡å®šå…·ä½“ç‰ˆæœ¬

docker pull mysql:8.0.35

# å¼€å‘ç¯å¢ƒ - ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬

docker pull mysql:8.0

# ç‰¹æ®Šéœ€æ±‚ - Oracleå®˜æ–¹ç²¾ç®€ç‰ˆ

docker pull mysql/mysql-server:8.0
```

### 2.2 åŸºç¡€å•å®¹å™¨éƒ¨ç½²



**ğŸ¯ æ ‡å‡†éƒ¨ç½²æµç¨‹**

```bash
# 1. åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆé‡è¦ï¼ï¼‰

mkdir -p /opt/mysql/data
mkdir -p /opt/mysql/logs
mkdir -p /opt/mysql/conf

# 2. å‡†å¤‡é…ç½®æ–‡ä»¶

cat > /opt/mysql/conf/my.cnf << EOF
[mysqld]
# åŸºç¡€é…ç½®

server-id = 1
port = 3306
datadir = /var/lib/mysql

# å­—ç¬¦é›†é…ç½®

character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# è¿æ¥é…ç½®

max_connections = 200
max_connect_errors = 1000

# InnoDBé…ç½®

innodb_buffer_pool_size = 256M
innodb_log_file_size = 128M
innodb_flush_log_at_trx_commit = 1

# æ—¥å¿—é…ç½®

log-error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
EOF

# 3. å¯åŠ¨MySQLå®¹å™¨

docker run -d \
  --name mysql-server \
  --restart unless-stopped \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=your_strong_password \
  -e MYSQL_DATABASE=myapp \
  -e MYSQL_USER=appuser \
  -e MYSQL_PASSWORD=appuser_password \
  -v /opt/mysql/data:/var/lib/mysql \
  -v /opt/mysql/logs:/var/log/mysql \
  -v /opt/mysql/conf/my.cnf:/etc/mysql/conf.d/my.cnf \
  mysql:8.0
```

### 2.3 ç¯å¢ƒå˜é‡é…ç½®è¯¦è§£



**ğŸ”‘ å…³é”®ç¯å¢ƒå˜é‡è¯´æ˜**
```bash
# å¿…éœ€å˜é‡

MYSQL_ROOT_PASSWORD=root123        # rootç”¨æˆ·å¯†ç ï¼ˆå¿…å¡«ï¼‰
MYSQL_RANDOM_ROOT_PASSWORD=yes     # éšæœºrootå¯†ç ï¼ˆäºŒé€‰ä¸€ï¼‰

# åº”ç”¨æ•°æ®åº“é…ç½®

MYSQL_DATABASE=myapp               # è‡ªåŠ¨åˆ›å»ºçš„æ•°æ®åº“
MYSQL_USER=appuser                 # åº”ç”¨ç”¨æˆ·å
MYSQL_PASSWORD=appuser_pass        # åº”ç”¨ç”¨æˆ·å¯†ç 

# é«˜çº§é…ç½®

MYSQL_ALLOW_EMPTY_PASSWORD=yes     # å…è®¸ç©ºå¯†ç ï¼ˆä»…å¼€å‘ï¼‰
MYSQL_ONETIME_PASSWORD=yes         # é¦–æ¬¡ç™»å½•å¼ºåˆ¶æ”¹å¯†ç 
```

**ğŸ’¡ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```bash
# å¼€å‘ç¯å¢ƒ - ç®€å•é…ç½®

docker run -d \
  --name dev-mysql \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -e MYSQL_DATABASE=testdb \
  -v mysql_data:/var/lib/mysql \
  mysql:8.0

# ç”Ÿäº§ç¯å¢ƒ - å®Œæ•´é…ç½®

docker run -d \
  --name prod-mysql \
  --restart always \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PWD} \
  -e MYSQL_DATABASE=${APP_DB_NAME} \
  -e MYSQL_USER=${APP_DB_USER} \
  -e MYSQL_PASSWORD=${APP_DB_PWD} \
  -v /data/mysql:/var/lib/mysql \
  -v /opt/mysql/conf:/etc/mysql/conf.d \
  -v /var/log/mysql:/var/log/mysql \
  --memory=1g \
  --cpus=0.5 \
  mysql:8.0
```

### 2.4 å®¹å™¨èµ„æºé™åˆ¶é…ç½®



**ğŸ“Š èµ„æºæ§åˆ¶æœ€ä½³å®è·µ**
```bash
# åŸºç¡€èµ„æºé™åˆ¶

docker run -d \
  --name mysql-limited \
  --memory=1g \              # å†…å­˜é™åˆ¶1GB
  --memory-swap=1g \         # ç¦ç”¨swap
  --cpus=0.5 \              # CPUé™åˆ¶0.5æ ¸
  --oom-kill-disable=false \ # å…è®¸OOMç»ˆæ­¢
  -p 3306:3306 \
  mysql:8.0

# é«˜çº§èµ„æºæ§åˆ¶

docker run -d \
  --name mysql-advanced \
  --memory=2g \
  --memory-reservation=1g \  # è½¯é™åˆ¶
  --cpus=1.5 \
  --cpu-shares=1024 \        # CPUæƒé‡
  --ulimit nofile=65536:65536 \  # æ–‡ä»¶æè¿°ç¬¦
  --ulimit memlock=8192:8192 \   # å†…å­˜é”å®š
  mysql:8.0
```

---

## 3. ğŸ’¾ å®¹å™¨æ•°æ®æŒä¹…åŒ–ç­–ç•¥



### 3.1 æ•°æ®æŒä¹…åŒ–çš„é‡è¦æ€§



**ğŸš¨ ä¸ºä»€ä¹ˆå¿…é¡»è¦æ•°æ®æŒä¹…åŒ–**
```
å®¹å™¨çš„ç‰¹æ€§ï¼š
å®¹å™¨æœ¬èº«æ˜¯ä¸´æ—¶çš„ï¼Œåˆ é™¤åæ‰€æœ‰æ•°æ®ä¸¢å¤±

ä¸æŒä¹…åŒ–çš„åæœï¼š
â€¢ å®¹å™¨é‡å¯ â†’ æ•°æ®ä¸¢å¤±
â€¢ å®¹å™¨å‡çº§ â†’ æ•°æ®ä¸¢å¤±  
â€¢ ä¸»æœºé‡å¯ â†’ æ•°æ®ä¸¢å¤±
â€¢ è¯¯åˆ å®¹å™¨ â†’ æ•°æ®æ°¸ä¹…ä¸¢å¤±

æŒä¹…åŒ–æ–¹æ¡ˆï¼š
å°†æ•°æ®å­˜å‚¨åœ¨å®¹å™¨å¤–éƒ¨ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
```

### 3.2 Dockeræ•°æ®å·æŒ‚è½½æ–¹æ¡ˆ



**ğŸ“ ä¸‰ç§æŒ‚è½½æ–¹å¼å¯¹æ¯”**

```
1. Bind Mountï¼ˆç»‘å®šæŒ‚è½½ï¼‰
ä¸»æœºè·¯å¾„ â†’ å®¹å™¨è·¯å¾„
/opt/mysql/data â†’ /var/lib/mysql

2. Named Volumeï¼ˆå‘½åå·ï¼‰
Dockerç®¡ç†çš„å· â†’ å®¹å™¨è·¯å¾„
mysql_data â†’ /var/lib/mysql

3. tmpfs Mountï¼ˆå†…å­˜æŒ‚è½½ï¼‰
å†…å­˜æ–‡ä»¶ç³»ç»Ÿ â†’ å®¹å™¨è·¯å¾„ï¼ˆä¸´æ—¶æ•°æ®ï¼‰
```

**ğŸ”§ å…·ä½“å®ç°æ–¹å¼**
```bash
# æ–¹å¼1ï¼šç»‘å®šæŒ‚è½½ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

docker run -d \
  --name mysql-bind \
  -v /opt/mysql/data:/var/lib/mysql \
  -v /opt/mysql/logs:/var/log/mysql \
  -v /opt/mysql/conf:/etc/mysql/conf.d \
  mysql:8.0

# æ–¹å¼2ï¼šå‘½åå·ï¼ˆæ¨èå¼€å‘ç¯å¢ƒï¼‰

docker volume create mysql-data
docker volume create mysql-logs

docker run -d \
  --name mysql-volume \
  -v mysql-data:/var/lib/mysql \
  -v mysql-logs:/var/log/mysql \
  mysql:8.0

# æ–¹å¼3ï¼šæ··åˆä½¿ç”¨

docker run -d \
  --name mysql-hybrid \
  -v /data/mysql:/var/lib/mysql \     # æ•°æ®ç”¨ç»‘å®šæŒ‚è½½
  -v mysql-logs:/var/log/mysql \      # æ—¥å¿—ç”¨å‘½åå·
  --tmpfs /tmp:noexec,nosuid,size=100m \  # ä¸´æ—¶æ–‡ä»¶ç”¨tmpfs
  mysql:8.0
```

### 3.3 æ•°æ®å¤‡ä»½ä¸æ¢å¤ç­–ç•¥



**ğŸ’¾ å®¹å™¨åŒ–ç¯å¢ƒä¸‹çš„å¤‡ä»½æ–¹æ¡ˆ**
```bash
# 1. é€»è¾‘å¤‡ä»½ - mysqldump

docker exec mysql-server \
  mysqldump -u root -p${MYSQL_ROOT_PASSWORD} \
  --all-databases --routines --triggers \
  > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. ç‰©ç†å¤‡ä»½ - æ•°æ®ç›®å½•å¤åˆ¶

docker stop mysql-server
tar -czf mysql_data_backup_$(date +%Y%m%d).tar.gz \
  /opt/mysql/data/
docker start mysql-server

# 3. å¿«ç…§å¤‡ä»½ï¼ˆå¦‚æœä½¿ç”¨LVMï¼‰

lvcreate -L1G -s -n mysql-snapshot /dev/vg0/mysql-lv
```

**ğŸ”„ æ•°æ®æ¢å¤æµç¨‹**
```bash
# é€»è¾‘æ¢å¤

docker exec -i mysql-server \
  mysql -u root -p${MYSQL_ROOT_PASSWORD} \
  < backup_20250901_120000.sql

# ç‰©ç†æ¢å¤

docker stop mysql-server
rm -rf /opt/mysql/data/*
tar -xzf mysql_data_backup_20250901.tar.gz -C /
docker start mysql-server
```

---

## 4. ğŸ­ å®¹å™¨ç¼–æ’ä¸é›†ç¾¤éƒ¨ç½²



### 4.1 Docker Composeå•æœºç¼–æ’



**ğŸ“‹ ä¸ºä»€ä¹ˆä½¿ç”¨Docker Compose**
```
å•å‘½ä»¤å¯åŠ¨çš„é—®é¢˜ï¼š
â€¢ å‘½ä»¤è¡Œå¤ªé•¿ï¼Œå®¹æ˜“å‡ºé”™
â€¢ å¤šå®¹å™¨ä¾èµ–å…³ç³»å¤æ‚
â€¢ ç¯å¢ƒå˜é‡ç®¡ç†å›°éš¾
â€¢ ç½‘ç»œé…ç½®ä¸ä¾¿

Docker Composeçš„ä¼˜åŠ¿ï¼š
â€¢ YAMLæ–‡ä»¶æè¿°æ•´ä¸ªåº”ç”¨æ ˆ
â€¢ ä¸€é”®å¯åŠ¨æ‰€æœ‰ç›¸å…³æœåŠ¡
â€¢ ç¯å¢ƒå˜é‡é›†ä¸­ç®¡ç†
â€¢ è‡ªåŠ¨åˆ›å»ºç½‘ç»œå’Œå·
```

**ğŸ”§ MySQL + åº”ç”¨çš„å®Œæ•´ç¼–æ’**
```yaml
# docker-compose.yml

version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: app-mysql
    restart: unless-stopped
    
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/logs:/var/log/mysql
      - ./mysql/conf:/etc/mysql/conf.d
      
    networks:
      - app-network
      
    ports:
      - "3306:3306"
      
#    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          
#    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      start_period: 40s
      interval: 30s

#  # åº”ç”¨æœåŠ¡
  app:
    image: myapp:latest
    container_name: app-server
    restart: unless-stopped
    
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE}
      DB_USER: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      
    ports:
      - "8080:8080"
      
    networks:
      - app-network
      
    depends_on:
      mysql:
        condition: service_healthy
        
volumes:
  mysql_data:
    driver: local

networks:
  app-network:
    driver: bridge
```

**ğŸ”§ ç¯å¢ƒå˜é‡æ–‡ä»¶**
```bash
# .env

MYSQL_ROOT_PASSWORD=secure_root_password
MYSQL_DATABASE=myapp
MYSQL_USER=appuser
MYSQL_PASSWORD=app_secure_password
```

**ğŸš€ å¯åŠ¨å‘½ä»¤**
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡

docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€

docker-compose ps

# æŸ¥çœ‹æ—¥å¿—

docker-compose logs mysql

# åœæ­¢æ‰€æœ‰æœåŠ¡

docker-compose down

# åœæ­¢å¹¶åˆ é™¤å·

docker-compose down -v
```

### 4.2 Docker Swarmé›†ç¾¤éƒ¨ç½²



**ğŸŒ Docker Swarmé›†ç¾¤æ¶æ„**
```
é›†ç¾¤ç»“æ„ï¼š
ManagerèŠ‚ç‚¹1 (ä¸»)    WorkerèŠ‚ç‚¹1
    |                   |
ManagerèŠ‚ç‚¹2         WorkerèŠ‚ç‚¹2
    |                   |  
ManagerèŠ‚ç‚¹3         WorkerèŠ‚ç‚¹3

æœåŠ¡åˆ†å¸ƒï¼š
MySQLæœåŠ¡å¯ä»¥è¿è¡Œåœ¨ä»»æ„èŠ‚ç‚¹ä¸Š
é€šè¿‡æœåŠ¡å‘ç°è‡ªåŠ¨è´Ÿè½½å‡è¡¡
```

**ğŸ”§ Swarm MySQLæœåŠ¡éƒ¨ç½²**
```yaml
# mysql-swarm.yml

version: '3.8'

services:
  mysql:
    image: mysql:8.0
    
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/mysql_root_password
      MYSQL_DATABASE: myapp
      MYSQL_USER: appuser
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_user_password
      
    volumes:
      - mysql_data:/var/lib/mysql
      
    networks:
      - mysql-network
      
    ports:
      - target: 3306
        published: 3306
        protocol: tcp
        mode: host
        
    secrets:
      - mysql_root_password
      - mysql_user_password
      
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.mysql==true
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

volumes:
  mysql_data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=nfs-server,rw
      device: ":/data/mysql"

networks:
  mysql-network:
    driver: overlay
    attachable: true

secrets:
  mysql_root_password:
    external: true
  mysql_user_password:
    external: true
```

**ğŸ”§ éƒ¨ç½²å‘½ä»¤**
```bash
# åˆå§‹åŒ–Swarmé›†ç¾¤

docker swarm init

# åˆ›å»ºå¯†é’¥

echo "secure_root_password" | docker secret create mysql_root_password -
echo "secure_user_password" | docker secret create mysql_user_password -

# æ ‡è®°MySQLä¸“ç”¨èŠ‚ç‚¹

docker node update --label-add mysql=true node1

# éƒ¨ç½²MySQLæœåŠ¡

docker stack deploy -c mysql-swarm.yml mysql-stack

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€

docker service ls
docker service ps mysql-stack_mysql
```

### 4.3 å®¹å™¨å¥åº·æ£€æŸ¥æœºåˆ¶



**ğŸ¥ å¥åº·æ£€æŸ¥çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼š
â€¢ å®¹å™¨å¯åŠ¨ä¸ä»£è¡¨æœåŠ¡å¯ç”¨
â€¢ MySQLåˆå§‹åŒ–éœ€è¦æ—¶é—´
â€¢ æ£€æµ‹æœåŠ¡æ˜¯å¦çœŸæ­£å¯ç”¨
â€¢ è‡ªåŠ¨é‡å¯ä¸å¥åº·çš„å®¹å™¨

å¥åº·æ£€æŸ¥å†…å®¹ï¼š
â€¢ ç«¯å£æ˜¯å¦ç›‘å¬
â€¢ æ•°æ®åº“æ˜¯å¦å¯è¿æ¥
â€¢ åŸºç¡€æŸ¥è¯¢æ˜¯å¦æ­£å¸¸
```

**ğŸ”§ å¤šç§å¥åº·æ£€æŸ¥æ–¹å¼**
```bash
# 1. åŸºç¡€è¿æ¥æ£€æŸ¥

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD mysqladmin ping -h localhost || exit 1

# 2. å®Œæ•´åŠŸèƒ½æ£€æŸ¥

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" || exit 1

# 3. è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬

```

**ğŸ“‹ å¥åº·æ£€æŸ¥è„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash

# healthcheck.sh


set -e

# æ£€æŸ¥MySQLè¿›ç¨‹

if ! pgrep mysqld > /dev/null; then
    echo "MySQL process not running"
    exit 1
fi

# æ£€æŸ¥ç«¯å£ç›‘å¬

if ! netstat -tlnp | grep :3306 > /dev/null; then
    echo "MySQL port 3306 not listening"
    exit 1
fi

# æ£€æŸ¥æ•°æ®åº“è¿æ¥

if ! mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1" > /dev/null 2>&1; then
    echo "Cannot connect to MySQL"
    exit 1
fi

echo "MySQL is healthy"
exit 0
```

---

## 5. â˜¸ï¸ Kubernetesç”Ÿäº§çº§éƒ¨ç½²



### 5.1 StatefulSet vs Deploymenté€‰æ‹©



**ğŸ¤” ä¸ºä»€ä¹ˆMySQLéœ€è¦StatefulSet**
```
Deploymentçš„é—®é¢˜ï¼š
â€¢ Podåç§°éšæœºï¼Œé‡å¯åå˜åŒ–
â€¢ å­˜å‚¨å·æ— æ³•ä¸Podç»‘å®š
â€¢ æ— æ³•ä¿è¯å¯åŠ¨é¡ºåº
â€¢ ä¸é€‚åˆæœ‰çŠ¶æ€æœåŠ¡

StatefulSetçš„ä¼˜åŠ¿ï¼š
â€¢ Podåç§°å›ºå®šä¸”æœ‰åº
â€¢ å­˜å‚¨å·è‡ªåŠ¨ç»‘å®šåˆ°ç‰¹å®šPod
â€¢ æŒ‰é¡ºåºå¯åŠ¨å’Œåœæ­¢
â€¢ ä¸“ä¸ºæœ‰çŠ¶æ€æœåŠ¡è®¾è®¡
```

**ğŸ“Š å¯¹æ¯”åˆ†æè¡¨**

| ç‰¹æ€§ | **Deployment** | **StatefulSet** | **MySQLæ¨è** |
|------|----------------|-----------------|---------------|
| **Podå‘½å** | `éšæœºåç¼€` | `æœ‰åºæ•°å­—åç¼€` | `âœ… StatefulSet` |
| **å­˜å‚¨ç»‘å®š** | `å…±äº«å­˜å‚¨` | `ç‹¬ç«‹PVC` | `âœ… StatefulSet` |
| **å¯åŠ¨é¡ºåº** | `å¹¶è¡Œå¯åŠ¨` | `é¡ºåºå¯åŠ¨` | `âœ… StatefulSet` |
| **ç½‘ç»œæ ‡è¯†** | `ä¸ç¨³å®š` | `ç¨³å®šDNSå` | `âœ… StatefulSet` |
| **æ‰©ç¼©å®¹** | `å¿«é€Ÿ` | `é¡ºåºè¿›è¡Œ` | `âœ… StatefulSet` |

### 5.2 å•å®ä¾‹MySQLéƒ¨ç½²



**ğŸ”§ å®Œæ•´çš„StatefulSeté…ç½®**
```yaml
# mysql-statefulset.yaml

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: database
spec:
  serviceName: mysql-service
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
          name: mysql
          
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: MYSQL_DATABASE
          value: "myapp"
        - name: MYSQL_USER
          value: "appuser"
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: user-password
              
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
          
#        # èµ„æºé™åˆ¶
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
            
#        # å¥åº·æ£€æŸ¥
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 30
          timeoutSeconds: 5
          periodSeconds: 10
          failureThreshold: 3
          
        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - localhost
            - -u
            - root
            - -p${MYSQL_ROOT_PASSWORD}
            - -e
            - SELECT 1
          initialDelaySeconds: 15
          timeoutSeconds: 5
          periodSeconds: 5
          failureThreshold: 3
          
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-config
          
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 20Gi
```

**ğŸ”§ é…å¥—èµ„æºæ–‡ä»¶**
```yaml
# mysql-service.yaml

apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: database
spec:
  clusterIP: None  # Headless service
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
    name: mysql

---
# mysql-secret.yaml

apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: database
type: Opaque
data:
  root-password: c2VjdXJlX3Jvb3RfcGFzc3dvcmQ=  # base64ç¼–ç 
  user-password: c2VjdXJlX3VzZXJfcGFzc3dvcmQ=   # base64ç¼–ç 

---
# mysql-configmap.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: database
data:
  my.cnf: |
    [mysqld]
    server-id = 1
    character-set-server = utf8mb4
    collation-server = utf8mb4_unicode_ci
    max_connections = 200
    innodb_buffer_pool_size = 512M
    innodb_log_file_size = 128M
    slow_query_log = 1
    slow_query_log_file = /var/log/mysql/slow.log
    long_query_time = 2
```

### 5.3 PersistentVolumeå­˜å‚¨ç±»é…ç½®



**ğŸ’¾ å­˜å‚¨ç±»çš„ä½œç”¨**
```
StorageClassçš„ç”¨é€”ï¼š
â€¢ å®šä¹‰å­˜å‚¨çš„æ€§èƒ½ç‰¹æ€§
â€¢ è‡ªåŠ¨åˆ›å»ºPersistentVolume
â€¢ æ”¯æŒåŠ¨æ€å­˜å‚¨åˆ†é…
â€¢ ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒå­˜å‚¨ç±»å‹

å¸¸è§å­˜å‚¨ç±»å‹ï¼š
â€¢ fast-ssdï¼šé«˜æ€§èƒ½SSDå­˜å‚¨
â€¢ standardï¼šæ ‡å‡†æœºæ¢°ç¡¬ç›˜
â€¢ network-storageï¼šç½‘ç»œå­˜å‚¨
```

**ğŸ”§ å­˜å‚¨ç±»é…ç½®ç¤ºä¾‹**
```yaml
# storageclass.yaml

apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
provisioner: kubernetes.io/aws-ebs  # æˆ–å…¶ä»–å­˜å‚¨æä¾›è€…
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  fsType: ext4
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
reclaimPolicy: Retain

---
# MySQLä¸“ç”¨å­˜å‚¨ç±»

apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: mysql-storage
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "4000"      # é«˜IOPSé€‚åˆæ•°æ®åº“
  throughput: "250" # é«˜ååé‡
  fsType: ext4
  encrypted: "true" # åŠ å¯†å­˜å‚¨
allowVolumeExpansion: true
reclaimPolicy: Retain  # ä¿ç•™æ•°æ®ï¼Œé˜²æ­¢è¯¯åˆ 
```

### 5.4 å®¹å™¨èµ„æºé…é¢é™åˆ¶



**ğŸ“Š èµ„æºç®¡ç†ç­–ç•¥**
```yaml
# namespace-quota.yaml

apiVersion: v1
kind: ResourceQuota
metadata:
  name: database-quota
  namespace: database
spec:
  hard:
#    # è®¡ç®—èµ„æºé™åˆ¶
    requests.cpu: "2"
    requests.memory: 4Gi
    limits.cpu: "4"
    limits.memory: 8Gi
    
#    # å­˜å‚¨èµ„æºé™åˆ¶
    persistentvolumeclaims: "5"
    requests.storage: 100Gi
    
#    # å¯¹è±¡æ•°é‡é™åˆ¶
    pods: "10"
    services: "5"
    secrets: "10"
    configmaps: "10"

---
# limit-range.yaml

apiVersion: v1
kind: LimitRange
metadata:
  name: database-limits
  namespace: database
spec:
  limits:
  - default:
      cpu: "500m"
      memory: "1Gi"
    defaultRequest:
      cpu: "250m"
      memory: "512Mi"
    type: Container
  - max:
      storage: "50Gi"
    min:
      storage: "10Gi"
    type: PersistentVolumeClaim
```

### 5.5 Podåäº²å’Œæ€§é…ç½®



**ğŸ¯ åäº²å’Œæ€§çš„ä½œç”¨**
```
ä¸ºä»€ä¹ˆéœ€è¦åäº²å’Œæ€§ï¼š
â€¢ é¿å…æ‰€æœ‰MySQL Podåœ¨åŒä¸€èŠ‚ç‚¹
â€¢ æé«˜å¯ç”¨æ€§å’Œå®¹é”™èƒ½åŠ›
â€¢ å‡åŒ€åˆ†å¸ƒå·¥ä½œè´Ÿè½½
â€¢ é¿å…å•ç‚¹æ•…éšœ

åäº²å’Œæ€§ç±»å‹ï¼š
â€¢ requiredDuringSchedulingIgnoredDuringExecutionï¼šç¡¬è¦æ±‚
â€¢ preferredDuringSchedulingIgnoredDuringExecutionï¼šè½¯è¦æ±‚
```

**ğŸ”§ åäº²å’Œæ€§é…ç½®ç¤ºä¾‹**
```yaml
# åœ¨StatefulSetä¸­æ·»åŠ åäº²å’Œæ€§

spec:
  template:
    spec:
      affinity:
        podAntiAffinity:
#          # ç¡¬åäº²å’Œæ€§ - MySQL Podä¸èƒ½åœ¨åŒä¸€èŠ‚ç‚¹
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - mysql
            topologyKey: kubernetes.io/hostname
            
#        # èŠ‚ç‚¹äº²å’Œæ€§ - ä¼˜å…ˆé€‰æ‹©æ ‡è®°ä¸ºæ•°æ®åº“èŠ‚ç‚¹
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-type
                operator: In
                values:
                - database
              - key: storage-type
                operator: In
                values:
                - ssd
```

---

## 6. ğŸ” å®¹å™¨å®‰å…¨ä¸ç›‘æ§



### 6.1 å®¹å™¨é•œåƒå®‰å…¨æ‰«æ



**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦é•œåƒå®‰å…¨æ‰«æ**
```
é•œåƒå®‰å…¨é£é™©ï¼š
â€¢ åŸºç¡€é•œåƒåŒ…å«å·²çŸ¥æ¼æ´
â€¢ åº”ç”¨ä¾èµ–å­˜åœ¨å®‰å…¨é—®é¢˜
â€¢ æ¶æ„ä»£ç æ³¨å…¥
â€¢ é…ç½®é”™è¯¯æš´éœ²æ•æ„Ÿä¿¡æ¯

æ‰«æå·¥å…·ï¼š
â€¢ Docker Scoutï¼šDockerå®˜æ–¹å·¥å…·
â€¢ Trivyï¼šå¼€æºæ¼æ´æ‰«æå™¨
â€¢ Snykï¼šå•†ä¸šå®‰å…¨å¹³å°
â€¢ Clairï¼šCoreOSå¼€æºé¡¹ç›®
```

**ğŸ”§ ä½¿ç”¨Trivyè¿›è¡Œé•œåƒæ‰«æ**
```bash
# å®‰è£…Trivy

curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

# æ‰«æMySQLå®˜æ–¹é•œåƒ

trivy image mysql:8.0

# æ‰«æå¹¶è¾“å‡ºæŠ¥å‘Š

trivy image --format json --output mysql-scan-result.json mysql:8.0

# åªæ˜¾ç¤ºé«˜å±å’Œä¸¥é‡æ¼æ´

trivy image --severity HIGH,CRITICAL mysql:8.0

# æ‰«æè‡ªå®šä¹‰MySQLé•œåƒ

trivy image --input mysql-custom.tar
```

**ğŸ“‹ æ‰«æç»“æœåˆ†æ**
```bash
# å…¸å‹æ‰«æè¾“å‡º

mysql:8.0 (debian 11.7)
=======================
Total: 45 (UNKNOWN: 0, LOW: 12, MEDIUM: 18, HIGH: 12, CRITICAL: 3)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Library         â”‚    Vulnerability     â”‚ Severity â”‚    Installed Ver   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ apt                 â”‚ CVE-2023-5678        â”‚ HIGH     â”‚ 2.2.4              â”‚
â”‚ openssl             â”‚ CVE-2023-1234        â”‚ CRITICAL â”‚ 1.1.1n-0+deb11u4  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å»ºè®®å¤„ç†æ–¹å¼ï¼š
â€¢ CRITICAL: ç«‹å³æ›´æ–°é•œåƒ
â€¢ HIGH: ä¼˜å…ˆçº§é«˜ï¼Œå°½å¿«å¤„ç†
â€¢ MEDIUM: å®šæœŸç»´æŠ¤æ—¶å¤„ç†
â€¢ LOW: å¯æ¥å—çš„é£é™©çº§åˆ«
```

### 6.2 å®¹å™¨è¿è¡Œæ—¶å®‰å…¨



**ğŸ›¡ï¸ è¿è¡Œæ—¶å®‰å…¨æœ€ä½³å®è·µ**

```yaml
# å®‰å…¨çš„Podé…ç½®

apiVersion: v1
kind: Pod
metadata:
  name: secure-mysql
spec:
  securityContext:
#    # Podçº§åˆ«å®‰å…¨é…ç½®
    runAsNonRoot: true
    runAsUser: 999        # mysqlç”¨æˆ·ID
    runAsGroup: 999       # mysqlç»„ID
    fsGroup: 999          # æ–‡ä»¶ç³»ç»Ÿç»„
    
  containers:
  - name: mysql
    image: mysql:8.0
    
    securityContext:
#      # å®¹å™¨çº§åˆ«å®‰å…¨é…ç½®
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false  # MySQLéœ€è¦å†™å…¥
      runAsNonRoot: true
      runAsUser: 999
      
      capabilities:
        drop:
        - ALL
        add:
        - CHOWN
        - DAC_OVERRIDE
        - SETGID
        - SETUID
        
#    # èµ„æºé™åˆ¶
    resources:
      limits:
        memory: "1Gi"
        cpu: "500m"
      requests:
        memory: "512Mi"
        cpu: "250m"
```

**ğŸ”§ ç½‘ç»œå®‰å…¨ç­–ç•¥**
```yaml
# network-policy.yaml

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-network-policy
  namespace: database
spec:
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
#  # åªå…è®¸åº”ç”¨Podè®¿é—®MySQL
  - from:
    - namespaceSelector:
        matchLabels:
          name: application
    - podSelector:
        matchLabels:
          app: web-app
    ports:
    - protocol: TCP
      port: 3306
      
#  # å…è®¸åŒnamespaceå†…çš„è®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 3306
      
  egress:
#  # å…è®¸DNSè§£æ
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
```

### 6.3 å®¹å™¨ç›‘æ§Prometheusé›†æˆ



**ğŸ“Š ç›‘æ§ä½“ç³»æ¶æ„**
```
ç›‘æ§æ•°æ®æµå‘ï¼š
MySQLå®¹å™¨ â†’ MySQL Exporter â†’ Prometheus â†’ Grafana

å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ è¿æ¥æ•°ï¼šcurrent_connections, max_connections
â€¢ æŸ¥è¯¢æ€§èƒ½ï¼šqueries_per_second, slow_queries
â€¢ ç¼“å†²æ± ï¼šinnodb_buffer_pool_utilization
â€¢ å¤åˆ¶çŠ¶æ€ï¼šslave_lag, slave_running
â€¢ èµ„æºä½¿ç”¨ï¼šcpu_usage, memory_usage, disk_io
```

**ğŸ”§ MySQL Exporteréƒ¨ç½²**
```yaml
# mysql-exporter.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-exporter
  namespace: database
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-exporter
  template:
    metadata:
      labels:
        app: mysql-exporter
    spec:
      containers:
      - name: mysql-exporter
        image: prom/mysqld-exporter:v0.14.0
        ports:
        - containerPort: 9104
          name: metrics
        env:
        - name: DATA_SOURCE_NAME
          valueFrom:
            secretKeyRef:
              name: mysql-exporter-secret
              key: datasource
#        # ç›‘æ§é…ç½®
        args:
        - --collect.info_schema.innodb_metrics
        - --collect.info_schema.innodb_cmp
        - --collect.info_schema.query_response_time
        - --collect.engine_innodb_status
        
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"

---
# mysql-exporter-service.yaml

apiVersion: v1
kind: Service
metadata:
  name: mysql-exporter-service
  namespace: database
  labels:
    app: mysql-exporter
spec:
  ports:
  - port: 9104
    targetPort: 9104
    name: metrics
  selector:
    app: mysql-exporter

---
# ServiceMonitor for Prometheus Operator

apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: mysql-exporter
  namespace: database
spec:
  selector:
    matchLabels:
      app: mysql-exporter
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

**ğŸ”§ ç›‘æ§å¯†é’¥é…ç½®**
```yaml
# mysql-exporter-secret.yaml

apiVersion: v1
kind: Secret
metadata:
  name: mysql-exporter-secret
  namespace: database
type: Opaque
stringData:
  datasource: "exporter:exporter_password@(mysql-service:3306)/"
```

**ğŸ“Š Grafanaä»ªè¡¨æ¿é…ç½®**
```json
{
  "dashboard": {
    "title": "MySQLå®¹å™¨ç›‘æ§",
    "panels": [
      {
        "title": "MySQLè¿æ¥æ•°",
        "type": "graph",
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected",
            "legendFormat": "å½“å‰è¿æ¥æ•°"
          },
          {
            "expr": "mysql_global_variables_max_connections",
            "legendFormat": "æœ€å¤§è¿æ¥æ•°"
          }
        ]
      },
      {
        "title": "æŸ¥è¯¢QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mysql_global_status_queries[5m])",
            "legendFormat": "æ¯ç§’æŸ¥è¯¢æ•°"
          }
        ]
      },
      {
        "title": "InnoDBç¼“å†²æ± ä½¿ç”¨ç‡",
        "type": "singlestat",
        "targets": [
          {
            "expr": "(mysql_global_status_innodb_buffer_pool_pages_data + mysql_global_status_innodb_buffer_pool_pages_dirty) / mysql_global_status_innodb_buffer_pool_pages_total * 100"
          }
        ]
      }
    ]
  }
}
```

### 6.4 å®¹å™¨æ—¥å¿—ç®¡ç†ç­–ç•¥



**ğŸ“ æ—¥å¿—æ”¶é›†æ¶æ„**
```
æ—¥å¿—æµå‘ï¼š
MySQLå®¹å™¨ â†’ Dockeræ—¥å¿—é©±åŠ¨ â†’ Fluentd/Filebeat â†’ Elasticsearch â†’ Kibana

æ—¥å¿—ç±»å‹ï¼š
â€¢ é”™è¯¯æ—¥å¿—ï¼š/var/log/mysql/error.log
â€¢ æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š/var/log/mysql/slow.log  
â€¢ äºŒè¿›åˆ¶æ—¥å¿—ï¼š/var/lib/mysql/mysql-bin.*
â€¢ å®¹å™¨æ ‡å‡†è¾“å‡ºï¼šdocker logs
```

**ğŸ”§ Fluentdæ—¥å¿—æ”¶é›†é…ç½®**
```yaml
# fluentd-mysql.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-mysql-config
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/mysql/error.log
      pos_file /var/log/fluentd-mysql-error.log.pos
      tag mysql.error
      format multiline
      format_firstline /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/
      format1 /^(?<time>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{6}Z) (?<thread>\d+) \[(?<level>\w+)\] (?<message>.*)/
      time_format %Y-%m-%dT%H:%M:%S.%LZ
    </source>
    
    <source>
      @type tail
      path /var/log/mysql/slow.log
      pos_file /var/log/fluentd-mysql-slow.log.pos
      tag mysql.slow
      format multiline
      format_firstline /^# Time:/
      format1 /^# Time: (?<time>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{6}Z)/
    </source>
    
    <match mysql.**>
      @type elasticsearch
      host elasticsearch-service
      port 9200
      index_name mysql-logs
      type_name _doc
    </match>

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-mysql
spec:
  selector:
    matchLabels:
      app: fluentd-mysql
  template:
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1.14-debian-elasticsearch7-1
        volumeMounts:
        - name: mysql-logs
          mountPath: /var/log/mysql
          readOnly: true
        - name: fluentd-config
          mountPath: /fluentd/etc/fluent.conf
          subPath: fluent.conf
      volumes:
      - name: mysql-logs
        hostPath:
          path: /opt/mysql/logs
      - name: fluentd-config
        configMap:
          name: fluentd-mysql-config
```

---

## 7. ğŸ› ï¸ æœ€ä½³å®è·µä¸æ•…éšœæ’æŸ¥



### 7.1 å®¹å™¨åŒ–é…ç½®æœ€ä½³å®è·µ



**â­ Dockeréƒ¨ç½²æ ‡å‡†æµç¨‹**
```bash
#!/bin/bash

# mysql-deploy.sh - MySQLå®¹å™¨æ ‡å‡†åŒ–éƒ¨ç½²è„šæœ¬


set -e

# é…ç½®å˜é‡

MYSQL_VERSION="8.0"
CONTAINER_NAME="mysql-prod"
DATA_DIR="/opt/mysql/data"
LOG_DIR="/opt/mysql/logs"
CONF_DIR="/opt/mysql/conf"
BACKUP_DIR="/opt/mysql/backups"

# é¢œè‰²è¾“å‡º

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 1. ç¯å¢ƒæ£€æŸ¥

check_environment() {
    log_info "æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
    
#    # æ£€æŸ¥Docker
    if ! command -v docker &> /dev/null; then
        log_error "Dockeræœªå®‰è£…"
        exit 1
    fi
    
#    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    AVAILABLE_SPACE=$(df -BG /opt | awk 'NR==2 {print $4}' | sed 's/G//')
    if [ "$AVAILABLE_SPACE" -lt 20 ]; then
        log_error "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘20GB"
        exit 1
    fi
    
    log_info "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# 2. åˆ›å»ºç›®å½•ç»“æ„

create_directories() {
    log_info "åˆ›å»ºç›®å½•ç»“æ„..."
    
    sudo mkdir -p "$DATA_DIR" "$LOG_DIR" "$CONF_DIR" "$BACKUP_DIR"
    sudo chown -R 999:999 "$DATA_DIR" "$LOG_DIR"
    
    log_info "ç›®å½•åˆ›å»ºå®Œæˆ"
}

# 3. ç”Ÿæˆé…ç½®æ–‡ä»¶

generate_config() {
    log_info "ç”ŸæˆMySQLé…ç½®æ–‡ä»¶..."
    
    cat > "$CONF_DIR/my.cnf" << EOF
[mysqld]
# åŸºç¡€é…ç½®

server-id = 1
port = 3306
datadir = /var/lib/mysql
socket = /var/run/mysqld/mysqld.sock

# å­—ç¬¦é›†é…ç½®

character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# è¿æ¥é…ç½®

max_connections = 500
max_connect_errors = 1000
connect_timeout = 10
wait_timeout = 28800

# å†…å­˜é…ç½®

innodb_buffer_pool_size = 1G
innodb_log_buffer_size = 16M
query_cache_size = 0
tmp_table_size = 64M
max_heap_table_size = 64M

# InnoDBé…ç½®

innodb_file_per_table = ON
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 1
innodb_flush_method = O_DIRECT

# æ—¥å¿—é…ç½®

log-error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log-bin = /var/lib/mysql/mysql-bin
binlog_format = ROW
expire_logs_days = 7

# å®‰å…¨é…ç½®

sql_mode = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
EOF
    
    log_info "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
}

# 4. éƒ¨ç½²å®¹å™¨

deploy_container() {
    log_info "éƒ¨ç½²MySQLå®¹å™¨..."
    
#    # åœæ­¢å·²å­˜åœ¨çš„å®¹å™¨
    if docker ps -a --format 'table {{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        log_warn "å‘ç°å·²å­˜åœ¨çš„å®¹å™¨ï¼Œæ­£åœ¨åœæ­¢..."
        docker stop "$CONTAINER_NAME" || true
        docker rm "$CONTAINER_NAME" || true
    fi
    
#    # æ‹‰å–é•œåƒ
    docker pull "mysql:${MYSQL_VERSION}"
    
#    # å¯åŠ¨å®¹å™¨
    docker run -d \
        --name "$CONTAINER_NAME" \
        --restart unless-stopped \
        -p 3306:3306 \
        -e MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD:-$(openssl rand -base64 32)}" \
        -e MYSQL_DATABASE="${MYSQL_DATABASE:-myapp}" \
        -e MYSQL_USER="${MYSQL_USER:-appuser}" \
        -e MYSQL_PASSWORD="${MYSQL_PASSWORD:-$(openssl rand -base64 16)}" \
        -v "$DATA_DIR:/var/lib/mysql" \
        -v "$LOG_DIR:/var/log/mysql" \
        -v "$CONF_DIR/my.cnf:/etc/mysql/conf.d/my.cnf" \
        --memory=2g \
        --cpus=1.0 \
        --health-cmd='mysqladmin ping --silent' \
        --health-interval=30s \
        --health-timeout=10s \
        --health-retries=3 \
        "mysql:${MYSQL_VERSION}"
    
    log_info "å®¹å™¨éƒ¨ç½²å®Œæˆ"
}

# 5. éªŒè¯éƒ¨ç½²

verify_deployment() {
    log_info "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
    
#    # ç­‰å¾…å®¹å™¨å¯åŠ¨
    log_info "ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨..."
    for i in {1..30}; do
        if docker exec "$CONTAINER_NAME" mysqladmin ping --silent 2>/dev/null; then
            log_info "MySQLæœåŠ¡å¯åŠ¨æˆåŠŸ"
            break
        fi
        if [ $i -eq 30 ]; then
            log_error "MySQLæœåŠ¡å¯åŠ¨è¶…æ—¶"
            docker logs "$CONTAINER_NAME"
            exit 1
        fi
        sleep 2
    done
    
#    # æ£€æŸ¥å¥åº·çŠ¶æ€
    HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_NAME")
    if [ "$HEALTH_STATUS" = "healthy" ]; then
        log_info "å¥åº·æ£€æŸ¥ï¼šé€šè¿‡"
    else
        log_warn "å¥åº·æ£€æŸ¥ï¼š$HEALTH_STATUS"
    fi
    
#    # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
    log_info "éƒ¨ç½²ä¿¡æ¯ï¼š"
    echo "  å®¹å™¨åç§°: $CONTAINER_NAME"
    echo "  MySQLç‰ˆæœ¬: $MYSQL_VERSION"
    echo "  æ•°æ®ç›®å½•: $DATA_DIR"
    echo "  è¿æ¥ç«¯å£: 3306"
}

# ä¸»æµç¨‹

main() {
    log_info "å¼€å§‹MySQLå®¹å™¨åŒ–éƒ¨ç½²..."
    
    check_environment
    create_directories
    generate_config
    deploy_container
    verify_deployment
    
    log_info "éƒ¨ç½²å®Œæˆï¼"
}

# æ‰§è¡Œä¸»æµç¨‹

main "$@"
```

### 7.2 å®¹å™¨ç¼–æ’æœ€ä½³å®è·µ



**ğŸ“‹ Kubernetesç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**

```yaml
# production-checklist.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-production-checklist
data:
  checklist.md: |
#    # MySQLå®¹å™¨åŒ–ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•
    
#    ## ğŸ” å®‰å…¨æ€§æ£€æŸ¥
    - [ ] ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
    - [ ] å¯ç”¨åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆé€‚ç”¨éƒ¨åˆ†ï¼‰
    - [ ] é…ç½®ç½‘ç»œç­–ç•¥é™åˆ¶è®¿é—®
    - [ ] ä½¿ç”¨Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
    - [ ] å®šæœŸæ‰«æé•œåƒå®‰å…¨æ¼æ´
    - [ ] å¯ç”¨å®¡è®¡æ—¥å¿—
    
#    ## ğŸš€ æ€§èƒ½ä¼˜åŒ–
    - [ ] åˆç†è®¾ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶
    - [ ] ä½¿ç”¨é«˜æ€§èƒ½å­˜å‚¨ç±»
    - [ ] é…ç½®åäº²å’Œæ€§è§„åˆ™
    - [ ] å¯ç”¨ç¼“å†²æ± é¢„çƒ­
    - [ ] ä¼˜åŒ–æ…¢æŸ¥è¯¢é…ç½®
    
#    ## ğŸ“Š ç›‘æ§å‘Šè­¦
    - [ ] éƒ¨ç½²MySQL Exporter
    - [ ] é…ç½®Prometheusç›‘æ§
    - [ ] è®¾ç½®Grafanaä»ªè¡¨æ¿
    - [ ] é…ç½®å‘Šè­¦è§„åˆ™
    - [ ] è®¾ç½®æ—¥å¿—æ”¶é›†
    
#    ## ğŸ’¾ æ•°æ®ä¿æŠ¤
    - [ ] é…ç½®æŒä¹…åŒ–å­˜å‚¨
    - [ ] è®¾ç½®è‡ªåŠ¨å¤‡ä»½ç­–ç•¥
    - [ ] éªŒè¯æ¢å¤æµç¨‹
    - [ ] é…ç½®å­˜å‚¨ç±»å›æ”¶ç­–ç•¥
    - [ ] æµ‹è¯•æ•°æ®æ¢å¤
    
#    ## ğŸ”„ é«˜å¯ç”¨æ€§
    - [ ] éƒ¨ç½²ä¸»ä»å¤åˆ¶
    - [ ] é…ç½®æ•…éšœåˆ‡æ¢
    - [ ] è®¾ç½®å¥åº·æ£€æŸ¥
    - [ ] é…ç½®æœåŠ¡å‘ç°
    - [ ] æµ‹è¯•ç¾éš¾æ¢å¤
```

**ğŸ”§ ç”Ÿäº§çº§MySQLé›†ç¾¤é…ç½®**
```yaml
# mysql-cluster.yaml

apiVersion: v1
kind: Service
metadata:
  name: mysql-primary
  labels:
    app: mysql
    role: primary
spec:
  ports:
  - port: 3306
  clusterIP: None
  selector:
    app: mysql
    role: primary

---
apiVersion: v1
kind: Service
metadata:
  name: mysql-replica
  labels:
    app: mysql
    role: replica
spec:
  ports:
  - port: 3306
  clusterIP: None
  selector:
    app: mysql
    role: replica

---
# ä¸»æ•°æ®åº“StatefulSet

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-primary
spec:
  serviceName: mysql-primary
  replicas: 1
  selector:
    matchLabels:
      app: mysql
      role: primary
  template:
    metadata:
      labels:
        app: mysql
        role: primary
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: MYSQL_REPLICATION_USER
          value: replicator
        - name: MYSQL_REPLICATION_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: replication-password
              
        ports:
        - containerPort: 3306
          name: mysql
          
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
          
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          
        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - 127.0.0.1
            - -e
            - SELECT 1
          initialDelaySeconds: 15
          periodSeconds: 2
          
      volumes:
      - name: mysql-config
        configMap:
          name: mysql-primary-config
          
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 50Gi

---
# ä»æ•°æ®åº“StatefulSet

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-replica
spec:
  serviceName: mysql-replica
  replicas: 2
  selector:
    matchLabels:
      app: mysql
      role: replica
  template:
    metadata:
      labels:
        app: mysql
        role: replica
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
        - name: MYSQL_MASTER_SERVICE
          value: mysql-primary
          
        command:
        - bash
        - "-c"
        - |
          set -ex
#          # é…ç½®ä»æ•°æ®åº“
          echo '[mysqld]' > /tmp/mysql.cnf
          echo 'server-id='$((100 + ${HOSTNAME##*-})) >> /tmp/mysql.cnf
          echo 'read-only=1' >> /tmp/mysql.cnf
          cp /tmp/mysql.cnf /etc/mysql/conf.d/
          exec docker-entrypoint.sh mysqld
          
        ports:
        - containerPort: 3306
          name: mysql
          
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
          
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "fast-ssd"
      resources:
        requests:
          storage: 50Gi
```

### 7.3 å¸¸è§æ•…éšœæ’æŸ¥æŒ‡å—



**ğŸ” æ•…éšœæ’æŸ¥æµç¨‹å›¾**
```
æ•…éšœå‘ç°
    â†“
æ£€æŸ¥å®¹å™¨çŠ¶æ€ â†’ å®¹å™¨å¼‚å¸¸ â†’ æŸ¥çœ‹å®¹å™¨æ—¥å¿— â†’ åˆ†æé”™è¯¯åŸå› 
    â†“                          â†“
å®¹å™¨æ­£å¸¸                    ä¿®å¤é—®é¢˜
    â†“                          â†“
æ£€æŸ¥ç½‘ç»œè¿æ¥ â†’ ç½‘ç»œå¼‚å¸¸ â†’ æ£€æŸ¥ç«¯å£æ˜ å°„ â†’ ä¿®å¤ç½‘ç»œé…ç½®
    â†“                          â†“
ç½‘ç»œæ­£å¸¸                    é‡å¯å®¹å™¨
    â†“                          â†“
æ£€æŸ¥MySQLæœåŠ¡ â†’ æœåŠ¡å¼‚å¸¸ â†’ æŸ¥çœ‹MySQLæ—¥å¿— â†’ åˆ†æSQLé”™è¯¯
    â†“                          â†“
æœåŠ¡æ­£å¸¸                    ä¼˜åŒ–é…ç½®
    â†“
é—®é¢˜è§£å†³
```

**ğŸ› ï¸ æ•…éšœæ’æŸ¥å‘½ä»¤é›†**
```bash
#!/bin/bash

# mysql-troubleshoot.sh - MySQLå®¹å™¨æ•…éšœæ’æŸ¥å·¥å…·


# å®¹å™¨åŸºç¡€æ£€æŸ¥

container_basic_check() {
    echo "=== å®¹å™¨åŸºç¡€çŠ¶æ€æ£€æŸ¥ ==="
    
#    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
    docker ps -a --filter name=mysql --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
    
#    # æ£€æŸ¥å®¹å™¨èµ„æºä½¿ç”¨
    docker stats mysql-server --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"
    
#    # æ£€æŸ¥å¥åº·çŠ¶æ€
    docker inspect mysql-server --format='å¥åº·çŠ¶æ€: {{.State.Health.Status}}'
}

# MySQLæœåŠ¡æ£€æŸ¥

mysql_service_check() {
    echo "=== MySQLæœåŠ¡çŠ¶æ€æ£€æŸ¥ ==="
    
#    # æ£€æŸ¥MySQLè¿›ç¨‹
    docker exec mysql-server ps aux | grep mysqld || echo "MySQLè¿›ç¨‹æœªæ‰¾åˆ°"
    
#    # æ£€æŸ¥ç«¯å£ç›‘å¬
    docker exec mysql-server netstat -tlnp | grep :3306 || echo "3306ç«¯å£æœªç›‘å¬"
    
#    # æµ‹è¯•è¿æ¥
    docker exec mysql-server mysqladmin ping || echo "MySQLè¿æ¥å¤±è´¥"
    
#    # æ£€æŸ¥MySQLçŠ¶æ€
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW STATUS LIKE 'Uptime';" || echo "æ— æ³•è·å–MySQLçŠ¶æ€"
}

# æ—¥å¿—åˆ†æ

log_analysis() {
    echo "=== æ—¥å¿—åˆ†æ ==="
    
#    # å®¹å™¨æ—¥å¿—
    echo "--- å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘50è¡Œï¼‰---"
    docker logs --tail 50 mysql-server
    
#    # MySQLé”™è¯¯æ—¥å¿—
    echo "--- MySQLé”™è¯¯æ—¥å¿— ---"
    docker exec mysql-server tail -n 20 /var/log/mysql/error.log || echo "é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
    
#    # æ…¢æŸ¥è¯¢æ—¥å¿—
    echo "--- æ…¢æŸ¥è¯¢æ—¥å¿— ---"
    docker exec mysql-server tail -n 10 /var/log/mysql/slow.log || echo "æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
}

# æ€§èƒ½æ£€æŸ¥

performance_check() {
    echo "=== æ€§èƒ½æ£€æŸ¥ ==="
    
#    # è¿æ¥æ•°æ£€æŸ¥
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "
        SELECT 
            VARIABLE_NAME as 'æŒ‡æ ‡',
            VARIABLE_VALUE as 'å½“å‰å€¼'
        FROM information_schema.GLOBAL_STATUS 
        WHERE VARIABLE_NAME IN (
            'Threads_connected',
            'Max_used_connections',
            'Queries',
            'Slow_queries'
        );"
    
#    # InnoDBçŠ¶æ€æ£€æŸ¥
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "
        SELECT 
            VARIABLE_NAME as 'æŒ‡æ ‡',
            VARIABLE_VALUE as 'å½“å‰å€¼'
        FROM information_schema.GLOBAL_STATUS 
        WHERE VARIABLE_NAME LIKE 'Innodb_buffer_pool%'
        LIMIT 5;"
}

# å­˜å‚¨æ£€æŸ¥

storage_check() {
    echo "=== å­˜å‚¨æ£€æŸ¥ ==="
    
#    # æ£€æŸ¥ç£ç›˜ä½¿ç”¨
    df -h | grep mysql || echo "æœªæ‰¾åˆ°MySQLç›¸å…³æŒ‚è½½ç‚¹"
    
#    # æ£€æŸ¥æ•°æ®ç›®å½•
    docker exec mysql-server du -sh /var/lib/mysql || echo "æ— æ³•è®¿é—®æ•°æ®ç›®å½•"
    
#    # æ£€æŸ¥äºŒè¿›åˆ¶æ—¥å¿—
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW BINARY LOGS;" || echo "æ— æ³•è·å–äºŒè¿›åˆ¶æ—¥å¿—ä¿¡æ¯"
}

# ç½‘ç»œè¿é€šæ€§æ£€æŸ¥

network_check() {
    echo "=== ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ ==="
    
#    # æ£€æŸ¥ç«¯å£æ˜ å°„
    docker port mysql-server
    
#    # ä»å®¹å™¨å¤–éƒ¨æµ‹è¯•è¿æ¥
    timeout 5 bash -c "</dev/tcp/localhost/3306" && echo "ç«¯å£3306å¯è®¿é—®" || echo "ç«¯å£3306ä¸å¯è®¿é—®"
    
#    # æ£€æŸ¥å®¹å™¨ç½‘ç»œ
    docker exec mysql-server netstat -tuln | grep :3306
}

# é…ç½®æ£€æŸ¥

config_check() {
    echo "=== é…ç½®æ£€æŸ¥ ==="
    
#    # æ£€æŸ¥MySQLé…ç½®
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "
        SELECT 
            VARIABLE_NAME as 'é…ç½®é¡¹',
            VARIABLE_VALUE as 'å€¼'
        FROM information_schema.GLOBAL_VARIABLES 
        WHERE VARIABLE_NAME IN (
            'max_connections',
            'innodb_buffer_pool_size',
            'slow_query_log',
            'log_bin'
        );"
    
#    # æ£€æŸ¥å­—ç¬¦é›†
    docker exec mysql-server mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "
        SHOW VARIABLES LIKE 'character_set%';"
}

# å®Œæ•´æ•…éšœæ’æŸ¥æ‰§è¡Œ

full_check() {
    echo "å¼€å§‹å®Œæ•´çš„MySQLå®¹å™¨æ•…éšœæ’æŸ¥..."
    echo "=============================================="
    
    container_basic_check
    echo
    mysql_service_check
    echo
    network_check
    echo
    storage_check
    echo
    performance_check
    echo
    config_check
    echo
    log_analysis
    
    echo "=============================================="
    echo "æ•…éšœæ’æŸ¥å®Œæˆï¼"
}

# ä¸»èœå•

main_menu() {
    echo "MySQLå®¹å™¨æ•…éšœæ’æŸ¥å·¥å…·"
    echo "1. å®¹å™¨åŸºç¡€æ£€æŸ¥"
    echo "2. MySQLæœåŠ¡æ£€æŸ¥"
    echo "3. ç½‘ç»œè¿é€šæ€§æ£€æŸ¥"
    echo "4. å­˜å‚¨æ£€æŸ¥"
    echo "5. æ€§èƒ½æ£€æŸ¥"
    echo "6. é…ç½®æ£€æŸ¥"
    echo "7. æ—¥å¿—åˆ†æ"
    echo "8. å®Œæ•´æ£€æŸ¥"
    echo "9. é€€å‡º"
    
    read -p "è¯·é€‰æ‹©æ£€æŸ¥é¡¹ç›® (1-9): " choice
    
    case $choice in
        1) container_basic_check ;;
        2) mysql_service_check ;;
        3) network_check ;;
        4) storage_check ;;
        5) performance_check ;;
        6) config_check ;;
        7) log_analysis ;;
        8) full_check ;;
        9) exit 0 ;;
        *) echo "æ— æ•ˆé€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥" ;;
    esac
}

# æ‰§è¡Œä¸»èœå•

if [ "$1" = "--menu" ]; then
    while true; do
        main_menu
        echo
        read -p "æŒ‰å›è½¦é”®ç»§ç»­..."
        echo
    done
else
    full_check
fi
```

### 7.4 K8séƒ¨ç½²æ–¹æ¡ˆé€‰æ‹©æŒ‡å—



**ğŸ“‹ éƒ¨ç½²æ–¹æ¡ˆå†³ç­–æ ‘**
```
ä¸šåŠ¡åœºæ™¯åˆ†æ
    â†“
å•å®ä¾‹ç®€å•åº”ç”¨? 
â”œâ”€ æ˜¯ â†’ ä½¿ç”¨StatefulSetå•å‰¯æœ¬
â””â”€ å¦ â†’ éœ€è¦é«˜å¯ç”¨?
           â”œâ”€ æ˜¯ â†’ ä¸»ä»å¤åˆ¶æ¶æ„
           â””â”€ å¦ â†’ è€ƒè™‘è¯»å†™åˆ†ç¦»éœ€æ±‚?
                   â”œâ”€ æ˜¯ â†’ ä¸€ä¸»å¤šä»æ¶æ„  
                   â””â”€ å¦ â†’ é›†ç¾¤æ¶æ„(MySQL Cluster)
```

**â­ æ–¹æ¡ˆé€‰æ‹©å¯¹æ¯”è¡¨**

| éƒ¨ç½²æ–¹æ¡ˆ | **é€‚ç”¨åœºæ™¯** | **å¤æ‚åº¦** | **å¯ç”¨æ€§** | **æ€§èƒ½** | **æˆæœ¬** |
|---------|-------------|-----------|-----------|---------|---------|
| **å•å®ä¾‹StatefulSet** | `å¼€å‘æµ‹è¯•` | `ä½` | `ä¸€èˆ¬` | `é«˜` | `ä½` |
| **ä¸»ä»å¤åˆ¶** | `ä¸­å°å‹åº”ç”¨` | `ä¸­` | `é«˜` | `ä¸­` | `ä¸­` |
| **è¯»å†™åˆ†ç¦»é›†ç¾¤** | `è¯»å¤šå†™å°‘åº”ç”¨` | `é«˜` | `é«˜` | `é«˜` | `é«˜` |
| **MySQL Cluster** | `å¤§å‹ä¼ä¸šåº”ç”¨` | `å¾ˆé«˜` | `å¾ˆé«˜` | `å¾ˆé«˜` | `å¾ˆé«˜` |
| **äº‘æ•°æ®åº“RDS** | `å¿«é€Ÿä¸Šçº¿` | `ä½` | `å¾ˆé«˜` | `é«˜` | `å¾ˆé«˜` |

**ğŸ”§ å…·ä½“é€‰æ‹©å»ºè®®**
```bash
# 1. å¼€å‘æµ‹è¯•ç¯å¢ƒ

kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-dev
spec:
  serviceName: mysql-dev
  replicas: 1
  selector:
    matchLabels:
      app: mysql-dev
  template:
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "dev123"
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
EOF

# 2. ç”Ÿäº§ç¯å¢ƒå•å®ä¾‹

kubectl apply -f mysql-production-single.yaml

# 3. ç”Ÿäº§ç¯å¢ƒä¸»ä»

kubectl apply -f mysql-master-slave-cluster.yaml
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



**ğŸ”¸ å®¹å™¨åŒ–éƒ¨ç½²çš„æœ¬è´¨ç†è§£**
```
å®¹å™¨åŒ– = æ ‡å‡†åŒ– + éš”ç¦» + å¯ç§»æ¤
â€¢ ç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§å®Œå…¨ç›¸åŒ
â€¢ å¿«é€Ÿéƒ¨ç½²ï¼šç§’çº§å¯åŠ¨ï¼Œæ— éœ€å¤æ‚å®‰è£…
â€¢ èµ„æºéš”ç¦»ï¼šCPUã€å†…å­˜ã€ç½‘ç»œç‹¬ç«‹æ§åˆ¶
â€¢ ç‰ˆæœ¬ç®¡ç†ï¼šé•œåƒåŒ–çš„ç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š
```

**ğŸ”¸ æ•°æ®æŒä¹…åŒ–çš„å…³é”®è®¤çŸ¥**
```
å®¹å™¨ â‰  æ•°æ®å®‰å…¨
â€¢ å®¹å™¨æ˜¯ä¸´æ—¶çš„ï¼Œæ•°æ®å¿…é¡»å¤–éƒ¨å­˜å‚¨
â€¢ ä¸‰ç§æŒ‚è½½æ–¹å¼å„æœ‰é€‚ç”¨åœºæ™¯
â€¢ ç»‘å®šæŒ‚è½½ï¼šç”Ÿäº§ç¯å¢ƒï¼Œå®Œå…¨æ§åˆ¶
â€¢ å‘½åå·ï¼šå¼€å‘ç¯å¢ƒï¼ŒDockerç®¡ç†
â€¢ tmpfsï¼šä¸´æ—¶æ•°æ®ï¼Œæ€§èƒ½ä¼˜å…ˆ
```

**ğŸ”¸ ç¼–æ’å·¥å…·çš„é€‰æ‹©é€»è¾‘**
```
å•æœº â†’ Docker Compose
é›†ç¾¤ â†’ Kubernetes
â€¢ Composeï¼šç®€å•æ˜“ç”¨ï¼Œé€‚åˆä¸­å°å‹åº”ç”¨
â€¢ Swarmï¼šDockeråŸç”Ÿï¼Œå­¦ä¹ æˆæœ¬ä½
â€¢ K8sï¼šåŠŸèƒ½å¼ºå¤§ï¼Œé€‚åˆå¤æ‚åœºæ™¯
```

### 8.2 å…³é”®å®è·µè¦ç‚¹



**ğŸ”¹ å®‰å…¨æ€§æ˜¯é‡ä¸­ä¹‹é‡**
```
é•œåƒå®‰å…¨ï¼š
â€¢ é€‰æ‹©å®˜æ–¹é•œåƒ
â€¢ å®šæœŸå®‰å…¨æ‰«æ
â€¢ åŠæ—¶æ›´æ–°ç‰ˆæœ¬

è¿è¡Œæ—¶å®‰å…¨ï¼š
â€¢ érootç”¨æˆ·è¿è¡Œ
â€¢ ç½‘ç»œç­–ç•¥é™åˆ¶
â€¢ å¯†é’¥ç®¡ç†è§„èŒƒ

é…ç½®å®‰å…¨ï¼š
â€¢ å¼ºå¯†ç ç­–ç•¥
â€¢ æœ€å°æƒé™åŸåˆ™
â€¢ å®¡è®¡æ—¥å¿—å¼€å¯
```

**ğŸ”¹ ç›‘æ§å’Œæ—¥å¿—ä¸å¯æˆ–ç¼º**
```
ç›‘æ§ä½“ç³»ï¼š
å®¹å™¨ç›‘æ§ + åº”ç”¨ç›‘æ§ + ä¸šåŠ¡ç›‘æ§

æ—¥å¿—ç®¡ç†ï¼š
ç»“æ„åŒ–æ—¥å¿— + é›†ä¸­æ”¶é›† + æ™ºèƒ½åˆ†æ

å‘Šè­¦æœºåˆ¶ï¼š
å¤šå±‚æ¬¡å‘Šè­¦ + è‡ªåŠ¨åŒ–å¤„ç† + äººå·¥ä»‹å…¥
```

**ğŸ”¹ æ•…éšœæ’æŸ¥çš„ç³»ç»ŸåŒ–æ€ç»´**
```
æ’æŸ¥é¡ºåºï¼š
å®¹å™¨çŠ¶æ€ â†’ ç½‘ç»œè¿æ¥ â†’ æœåŠ¡çŠ¶æ€ â†’ é…ç½®æ£€æŸ¥ â†’ æ—¥å¿—åˆ†æ

å¸¸ç”¨å‘½ä»¤ï¼š
â€¢ docker ps/logsï¼šå®¹å™¨åŸºç¡€ä¿¡æ¯
â€¢ docker execï¼šè¿›å…¥å®¹å™¨è°ƒè¯•
â€¢ kubectl describeï¼šK8sèµ„æºè¯¦æƒ…
â€¢ mysqladmin pingï¼šæœåŠ¡è¿é€šæ€§
```

### 8.3 ç”Ÿäº§ç¯å¢ƒå…³é”®è€ƒé‡



**ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
èµ„æºé…ç½®ï¼š
â€¢ åˆç†çš„CPUå’Œå†…å­˜é™åˆ¶
â€¢ é«˜æ€§èƒ½å­˜å‚¨é€‰æ‹©
â€¢ ç½‘ç»œä¼˜åŒ–é…ç½®

MySQLè°ƒä¼˜ï¼š
â€¢ ç¼“å†²æ± å¤§å°ä¼˜åŒ–
â€¢ è¿æ¥æ•°åˆç†è®¾ç½®
â€¢ æ…¢æŸ¥è¯¢ç›‘æ§ä¼˜åŒ–
```

**ğŸ”„ é«˜å¯ç”¨æ¶æ„è®¾è®¡**
```
æ•°æ®å±‚é¢ï¼š
â€¢ ä¸»ä»å¤åˆ¶é…ç½®
â€¢ æ•°æ®å¤‡ä»½ç­–ç•¥
â€¢ æ•…éšœè‡ªåŠ¨åˆ‡æ¢

æœåŠ¡å±‚é¢ï¼š
â€¢ å¥åº·æ£€æŸ¥æœºåˆ¶
â€¢ æœåŠ¡å‘ç°é…ç½®
â€¢ è´Ÿè½½å‡è¡¡ç­–ç•¥
```

**ğŸ“Š è¿ç»´è‡ªåŠ¨åŒ–**
```
éƒ¨ç½²è‡ªåŠ¨åŒ–ï¼š
â€¢ CI/CDæµæ°´çº¿é›†æˆ
â€¢ é…ç½®ç®¡ç†è‡ªåŠ¨åŒ–
â€¢ ç¯å¢ƒä¸€é”®åˆ›å»º

è¿ç»´è‡ªåŠ¨åŒ–ï¼š
â€¢ ç›‘æ§å‘Šè­¦è‡ªåŠ¨åŒ–
â€¢ å¤‡ä»½æ¢å¤è‡ªåŠ¨åŒ–
â€¢ æ‰©å®¹ç¼©å®¹è‡ªåŠ¨åŒ–
```

### 8.4 å­¦ä¹ å»ºè®®å’Œå‘å±•æ–¹å‘



**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**
```
åˆçº§é˜¶æ®µï¼š
1. æŒæ¡DockeråŸºç¡€æ“ä½œ
2. ç†è§£æ•°æ®æŒä¹…åŒ–æ¦‚å¿µ
3. ç†Ÿç»ƒä½¿ç”¨Docker Compose

ä¸­çº§é˜¶æ®µï¼š
1. å­¦ä¹ KubernetesåŸºç¡€
2. æŒæ¡StatefulSetéƒ¨ç½²
3. ç†è§£æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†

é«˜çº§é˜¶æ®µï¼š
1. è®¾è®¡é«˜å¯ç”¨æ¶æ„
2. å®ç°ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
3. æŒæ¡æ€§èƒ½è°ƒä¼˜æŠ€å·§
```

**ğŸš€ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
```
äº‘åŸç”Ÿè¶‹åŠ¿ï¼š
â€¢ Serverlessæ•°æ®åº“
â€¢ å¤šäº‘éƒ¨ç½²ç­–ç•¥
â€¢ è¾¹ç¼˜è®¡ç®—æ•°æ®åº“

è‡ªåŠ¨åŒ–è¿ç»´ï¼š
â€¢ AIOpsæ™ºèƒ½è¿ç»´
â€¢ è‡ªæ„ˆç³»ç»Ÿè®¾è®¡
â€¢ é¢„æµ‹æ€§ç»´æŠ¤

å®‰å…¨å¼ºåŒ–ï¼š
â€¢ é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„
â€¢ æ•°æ®åŠ å¯†ä¼ è¾“å­˜å‚¨
â€¢ åˆè§„æ€§è‡ªåŠ¨æ£€æŸ¥
```

**ğŸ’¡ å®è·µå»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆåœ¨å¼€å‘ç¯å¢ƒç»ƒæ‰‹ï¼Œé€æ­¥åº”ç”¨åˆ°ç”Ÿäº§
- **é‡è§†å®‰å…¨**ï¼šå®‰å…¨é…ç½®ä»é¡¹ç›®åˆæœŸå°±è¦è€ƒè™‘
- **ç›‘æ§å…ˆè¡Œ**ï¼šç›‘æ§ç³»ç»Ÿè¦æ¯”ä¸šåŠ¡ç³»ç»Ÿå…ˆéƒ¨ç½²
- **æ–‡æ¡£åŒ–**ï¼šæ‰€æœ‰é…ç½®å’Œæµç¨‹éƒ½è¦æœ‰æ¸…æ™°æ–‡æ¡£
- **å›¢é˜Ÿåä½œ**ï¼šå»ºç«‹æ ‡å‡†åŒ–çš„å®¹å™¨åŒ–æµç¨‹å’Œè§„èŒƒ

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®¹å™¨åŒ–è®©MySQLéƒ¨ç½²æ ‡å‡†åŒ–ï¼Œä½†æ•°æ®å®‰å…¨éœ€è¦å¤–éƒ¨å­˜å‚¨
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘é«˜å¯ç”¨ã€å®‰å…¨ã€ç›‘æ§ä¸‰å¤§è¦ç´ 
- é€‰æ‹©åˆé€‚çš„ç¼–æ’å·¥å…·ï¼Œä»ç®€å•åˆ°å¤æ‚é€æ­¥æ¼”è¿›
- æ•…éšœæ’æŸ¥è¦ç³»ç»ŸåŒ–ï¼Œç›‘æ§å‘Šè­¦è¦è‡ªåŠ¨åŒ–
- æŒç»­å­¦ä¹ äº‘åŸç”ŸæŠ€æœ¯ï¼Œè·Ÿä¸ŠæŠ€æœ¯å‘å±•è¶‹åŠ¿