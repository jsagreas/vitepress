---
title: 20、字符集默认设置
---
## 📚 目录

1. [字符集默认变更概述](#1-字符集默认变更概述)
2. [utf8mb4成为默认字符集](#2-utf8mb4成为默认字符集)
3. [排序规则的重要变更](#3-排序规则的重要变更)
4. [字符集兼容性处理](#4-字符集兼容性处理)
5. [表情符号与多字节字符支持](#5-表情符号与多字节字符支持)
6. [字符集升级的影响分析](#6-字符集升级的影响分析)
7. [迁移策略与最佳实践](#7-迁移策略与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔄 字符集默认变更概述


### 1.1 什么是字符集变更


**简单理解**：MySQL 8.0最大的变化之一就是把默认字符集从`utf8`改成了`utf8mb4`。

```
MySQL 5.7及之前：
默认字符集 = utf8 (实际是utf8mb3，最多3字节)
默认排序规则 = utf8_general_ci

MySQL 8.0开始：
默认字符集 = utf8mb4 (真正的UTF-8，最多4字节)  
默认排序规则 = utf8mb4_0900_ai_ci
```

### 1.2 为什么要改变


**历史遗留问题**：
- MySQL的`utf8`实际上不是真正的UTF-8
- 只支持最多3个字节，无法存储某些字符
- `utf8mb4`才是真正完整的UTF-8实现

**现实需求**：
- 🚀 **表情符号时代**：用户大量使用emoji表情
- 🌍 **国际化需求**：支持更多语言和特殊字符  
- 📱 **移动互联网**：手机输入各种特殊字符成为常态

### 1.3 影响范围


```
影响的对象：
┌─────────────────┐
│   新建数据库     │ ← 自动使用utf8mb4
├─────────────────┤  
│   新建表        │ ← 继承数据库字符集
├─────────────────┤
│   新建字段      │ ← 继承表字符集
├─────────────────┤
│   连接字符集     │ ← 客户端连接默认设置
└─────────────────┘
```

---

## 2. 📝 utf8mb4成为默认字符集


### 2.1 utf8 vs utf8mb4 详解


**关键区别对比**：

| **特性** | **utf8 (utf8mb3)** | **utf8mb4** |
|---------|-------------------|-------------|
| **字节长度** | `1-3字节` | `1-4字节` |
| **emoji支持** | `❌ 不支持` | `✅ 完全支持` |
| **存储空间** | `较小` | `稍大一些` |
| **兼容性** | `向后兼容` | `向前兼容` |
| **是否标准UTF-8** | `❌ 不完整` | `✅ 完整实现` |

### 2.2 实际存储示例


**文本存储对比**：
```sql
-- 普通英文文本 (两者相同)
'Hello World' → utf8: 11字节, utf8mb4: 11字节

-- 中文文本 (两者相同) 
'你好世界' → utf8: 12字节, utf8mb4: 12字节

-- emoji表情 (关键差异)
'你好😊' → utf8: 报错！无法存储
          → utf8mb4: 10字节 (6+4)
```

### 2.3 如何查看当前字符集


```sql
-- 查看服务器默认字符集
SHOW VARIABLES LIKE 'character_set_server';

-- 查看数据库字符集
SHOW CREATE DATABASE your_database;

-- 查看表字符集
SHOW CREATE TABLE your_table;

-- 查看连接字符集
SHOW VARIABLES LIKE 'character_set_connection';
```

**结果示例**：
```sql
-- MySQL 8.0 默认结果
character_set_server: utf8mb4
character_set_database: utf8mb4  
character_set_connection: utf8mb4
```

### 2.4 手动指定字符集


```sql
-- 创建数据库时指定
CREATE DATABASE myapp 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 创建表时指定
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(50)
) CHARACTER SET utf8mb4 
  COLLATE utf8mb4_unicode_ci;

-- 修改已有表的字符集
ALTER TABLE users 
CONVERT TO CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

---

## 3. ⚖️ 排序规则的重要变更


### 3.1 什么是排序规则


**通俗解释**：排序规则（Collation）就是告诉MySQL如何比较和排序字符的规则。

```
简单类比：
就像汉语拼音排序 vs 笔画排序
- 拼音排序：按a,b,c...顺序
- 笔画排序：按笔画多少排序
- 不同规则，排序结果不同
```

### 3.2 新的默认排序规则


**MySQL 8.0 新默认**：`utf8mb4_0900_ai_ci`

**规则名称解析**：
```
utf8mb4_0900_ai_ci 分解：
├─ utf8mb4     ← 字符集名
├─ 0900        ← Unicode 9.0.0 版本
├─ ai          ← Accent Insensitive (忽略重音)
└─ ci          ← Case Insensitive (忽略大小写)
```

### 3.3 常用排序规则对比


| **排序规则** | **特点** | **使用场景** |
|-------------|---------|-------------|
| `utf8mb4_0900_ai_ci` | `忽略大小写和重音` | **默认，通用场景** |
| `utf8mb4_unicode_ci` | `Unicode标准，忽略大小写` | **国际化应用** |
| `utf8mb4_bin` | `严格按字节比较` | **区分大小写的场景** |
| `utf8mb4_general_ci` | `快速比较，忽略大小写` | **性能优先场景** |

### 3.4 排序规则实际效果


```sql
-- 创建测试表
CREATE TABLE test_sort (
    id INT PRIMARY KEY,
    name VARCHAR(20)
) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;

-- 插入测试数据
INSERT INTO test_sort VALUES 
(1, 'Apple'), (2, 'apple'), (3, 'APPLE');

-- 查询结果 (忽略大小写)
SELECT * FROM test_sort WHERE name = 'apple';
-- 结果：返回所有3行记录

-- 如果使用 utf8mb4_bin
ALTER TABLE test_sort COLLATE utf8mb4_bin;
SELECT * FROM test_sort WHERE name = 'apple';
-- 结果：只返回 'apple' 这1行
```

---

## 4. 🔗 字符集兼容性处理


### 4.1 兼容性问题概述


**主要问题**：从MySQL 5.7升级到8.0时可能遇到的字符集兼容问题。

```
升级场景问题：
旧系统(MySQL 5.7) ──升级──> 新系统(MySQL 8.0)
     │                          │
   utf8                    utf8mb4
utf8_general_ci        utf8mb4_0900_ai_ci
```

### 4.2 连接字符集兼容


**问题现象**：旧应用连接MySQL 8.0时可能出现字符集不匹配。

```sql
-- 查看连接字符集设置
SHOW VARIABLES LIKE 'character_set_%';

-- 常见问题结果
character_set_client: latin1      -- 客户端字符集
character_set_connection: utf8mb4 -- 连接字符集  
character_set_server: utf8mb4     -- 服务器字符集
```

**解决方案**：
```sql
-- 方案1：连接时指定字符集
SET NAMES utf8mb4;

-- 方案2：修改客户端连接
mysql -h localhost -u user -p --default-character-set=utf8mb4

-- 方案3：应用程序连接字符串
jdbc:mysql://localhost:3306/db?characterEncoding=utf8&useUnicode=true
```

### 4.3 数据迁移兼容


**安全迁移步骤**：
```sql
-- 步骤1：备份原数据
mysqldump -u root -p --default-character-set=utf8 
          --single-transaction database_name > backup.sql

-- 步骤2：检查是否有4字节字符
SELECT * FROM table_name 
WHERE CHAR_LENGTH(column_name) != LENGTH(column_name);

-- 步骤3：转换字符集
ALTER DATABASE database_name 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 步骤4：转换表
ALTER TABLE table_name 
CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

## 5. 😊 表情符号与多字节字符支持


### 5.1 表情符号存储原理


**为什么需要4字节**：
```
表情符号编码示例：
😊 → Unicode: U+1F60A → UTF-8: F0 9F 98 8A (4字节)
❤️  → Unicode: U+2764  → UTF-8: E2 9D A4 (3字节) 
🎉 → Unicode: U+1F389 → UTF-8: F0 9F 8E 89 (4字节)

utf8 (3字节限制) → 无法存储4字节的emoji
utf8mb4 (4字节支持) → 可以完整存储所有emoji
```

### 5.2 实际应用场景


**社交媒体应用**：
```sql
-- 用户评论表
CREATE TABLE comments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    content TEXT CHARACTER SET utf8mb4,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 插入包含emoji的评论
INSERT INTO comments (user_id, content) VALUES 
(1, '这个产品真不错！👍😊'),
(2, '五星好评⭐⭐⭐⭐⭐'),
(3, '超级喜欢❤️❤️❤️');
```

### 5.3 多字节字符处理注意事项


**VARCHAR长度计算**：
```sql
-- 注意：VARCHAR(50) 表示50个字符，不是50个字节
CREATE TABLE test (
    content VARCHAR(50) CHARACTER SET utf8mb4
);

-- 可以存储的内容
INSERT INTO test VALUES ('😊😊😊😊😊'); -- 5个emoji字符 = 20字节
INSERT INTO test VALUES ('你好你好你好'); -- 6个中文字符 = 18字节
```

**索引长度限制**：
```sql
-- InnoDB单列索引最大767字节 (MySQL 5.6)
-- utf8mb4: 767÷4 = 191个字符
CREATE INDEX idx_name ON users(name(191));

-- MySQL 5.7+ 支持更长索引 (3072字节)
-- utf8mb4: 3072÷4 = 768个字符  
CREATE INDEX idx_content ON posts(content(768));
```

---

## 6. ⚡ 字符集升级的影响分析


### 6.1 存储空间影响


**存储开销对比**：

```
实际测试数据：
┌─────────────┬──────────┬──────────┬────────┐
│ 内容类型     │   utf8   │ utf8mb4  │ 差异   │
├─────────────┼──────────┼──────────┼────────┤
│ 纯英文      │   1字节   │   1字节   │  无差异 │
│ 纯中文      │   3字节   │   3字节   │  无差异 │  
│ 含emoji     │   报错    │   4字节   │  新增  │
│ 索引空间    │   更小    │   稍大    │ 10-20% │
└─────────────┴──────────┴──────────┴────────┘
```

### 6.2 性能影响分析


**查询性能**：
- **相同内容**：utf8和utf8mb4性能基本一致
- **索引效率**：utf8mb4略低，但差异很小(< 5%)
- **排序性能**：新的排序规则更准确，性能相近

**实际测试**：
```sql
-- 百万级数据查询测试
SELECT COUNT(*) FROM users WHERE name LIKE '张%';
-- utf8: 0.23秒
-- utf8mb4: 0.25秒  (差异可忽略)
```

### 6.3 应用程序影响


**需要修改的地方**：

> **🚨 注意事项**
> 
> 以下情况需要修改应用程序代码：
> - 硬编码字符集设置
> - 字符串长度计算逻辑  
> - 数据库连接参数
> - ORM框架配置

**代码修改示例**：
```java
// 修改前 (可能有问题)
String url = "jdbc:mysql://localhost:3306/db?characterEncoding=utf8";

// 修改后 (推荐)
String url = "jdbc:mysql://localhost:3306/db?characterEncoding=utf8mb4";
```

---

## 7. 🚀 迁移策略与最佳实践


### 7.1 迁移前的准备工作


**评估检查清单**：
- ✅ **数据备份**：完整备份现有数据
- ✅ **字符检测**：检查是否有特殊字符
- ✅ **应用测试**：在测试环境验证
- ✅ **性能测试**：确认性能影响可接受
- ✅ **回滚计划**：准备回滚方案

```sql
-- 检测数据中的4字节字符
SELECT table_name, column_name, 
       COUNT(*) as count_4byte_chars
FROM information_schema.columns c
JOIN (
    SELECT 'your_table' as table_name, 'your_column' as column_name
    -- 添加需要检查的表和列
) t ON c.table_name = t.table_name 
   AND c.column_name = t.column_name
WHERE c.data_type IN ('varchar', 'text', 'char')
GROUP BY table_name, column_name;
```

### 7.2 渐进式迁移策略


**分阶段迁移**：
```
阶段1: 新建对象使用utf8mb4
  ├─ 新数据库 → utf8mb4
  ├─ 新表 → utf8mb4  
  └─ 新字段 → utf8mb4

阶段2: 转换非关键表
  ├─ 日志表 → utf8mb4
  ├─ 临时表 → utf8mb4
  └─ 测试表 → utf8mb4

阶段3: 转换业务表
  ├─ 用户表 → utf8mb4
  ├─ 订单表 → utf8mb4
  └─ 核心业务表 → utf8mb4
```

### 7.3 迁移脚本模板


```sql
-- 安全迁移脚本模板
-- 第1步：修改数据库默认字符集
ALTER DATABASE your_db_name 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 第2步：批量转换表 (逐个执行)
SET SESSION innodb_lock_wait_timeout = 300;
ALTER TABLE table_name 
CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 第3步：验证转换结果
SELECT 
    table_schema,
    table_name,
    table_collation
FROM information_schema.tables 
WHERE table_schema = 'your_db_name'
  AND table_collation NOT LIKE 'utf8mb4%';
```

### 7.4 应用程序配置调整


**Spring Boot 配置**：
```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/db?characterEncoding=utf8mb4&useUnicode=true
    driver-class-name: com.mysql.cj.jdbc.Driver

  jpa:
    properties:
      hibernate:
        connection:
          characterEncoding: utf8mb4
          CharSet: utf8mb4
```

**PHP 配置**：
```php
// PDO连接
$pdo = new PDO(
    'mysql:host=localhost;dbname=test;charset=utf8mb4',
    $username, 
    $password,
    [PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4"]
);
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 默认变更：MySQL 8.0默认字符集从utf8改为utf8mb4
🔸 核心区别：utf8mb4支持4字节字符，可存储emoji表情  
🔸 排序规则：新增utf8mb4_0900_ai_ci，更准确的Unicode支持
🔸 兼容处理：需要注意连接字符集和应用程序配置
🔸 迁移策略：分阶段渐进式迁移，确保数据安全
```

### 8.2 关键理解要点


**🔹 为什么要升级到utf8mb4**：
```
现实需求：
- 表情符号已成为日常交流必需
- 国际化应用需要支持更多字符
- utf8mb4是真正完整的UTF-8实现

技术优势：
- 向前兼容：utf8数据可直接在utf8mb4中使用
- 标准合规：符合Unicode和UTF-8标准
- 功能完整：支持所有Unicode字符
```

**🔹 迁移的核心考虑**：
```
安全性：
- 数据备份是前提
- 渐进式迁移降低风险
- 测试环境先验证

兼容性：
- 应用程序连接参数需要调整
- ORM框架配置需要更新
- 客户端工具需要支持

性能：
- 存储空间略有增加
- 查询性能基本无差异
- 索引空间会有小幅增长
```

### 8.3 实际应用指导


**适用场景判断**：
- ✅ **新项目**：直接使用utf8mb4
- ✅ **有emoji需求**：必须升级到utf8mb4
- ✅ **国际化应用**：推荐使用utf8mb4
- ⚠️ **legacy系统**：需要谨慎评估迁移成本

**最佳实践建议**：
```
设计阶段：
- 新项目默认使用utf8mb4
- 选择合适的排序规则
- 考虑字符集对索引长度的影响

开发阶段：
- 应用程序统一使用utf8mb4连接
- 注意VARCHAR长度是字符数不是字节数
- 测试各种特殊字符的存储和显示

运维阶段：
- 监控存储空间使用情况
- 定期检查字符集一致性
- 建立字符集相关的故障处理流程
```

### 8.4 常见问题解决


| **问题** | **现象** | **解决方案** |
|---------|---------|-------------|
| **emoji存储失败** | `数据截断或报错` | `升级到utf8mb4字符集` |
| **连接字符集不匹配** | `乱码显示` | `SET NAMES utf8mb4` |
| **索引长度超限** | `索引创建失败` | `限制索引长度或升级MySQL` |
| **应用程序报错** | `字符集相关异常` | `更新连接字符串配置` |

**核心记忆**：
- utf8mb4是真正的UTF-8，支持emoji和国际字符
- MySQL 8.0默认使用utf8mb4，向前兼容utf8
- 迁移需要谨慎规划，应用程序配置需要相应调整
- 新项目建议直接使用utf8mb4避免后续迁移成本