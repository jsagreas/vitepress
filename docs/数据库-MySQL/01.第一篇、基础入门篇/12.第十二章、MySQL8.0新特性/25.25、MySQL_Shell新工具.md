---
title: 25、MySQL_Shell新工具
---
## 📚 目录

1. [MySQL Shell基础概念](#1-mysql-shell基础概念)
2. [交互式工具核心功能](#2-交互式工具核心功能)
3. [JavaScript和Python脚本模式](#3-javascript和python脚本模式)
4. [InnoDB Cluster管理](#4-innodb-cluster管理)
5. [Document Store文档存储](#5-document-store文档存储)
6. [X DevAPI开发接口](#6-x-devapi开发接口)
7. [数据导入导出工具](#7-数据导入导出工具)
8. [实用工具集合](#8-实用工具集合)
9. [Shell插件扩展机制](#9-shell插件扩展机制)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🚀 MySQL Shell基础概念


### 1.1 什么是MySQL Shell


**🔸 简单理解**
```
MySQL Shell = MySQL的"超级终端"
就像手机有命令行模式，MySQL Shell是MySQL的高级命令行工具
比传统的mysql客户端更强大、更智能、更现代化
```

**💡 核心作用**
- **多语言支持**：不只是SQL，还支持JavaScript和Python
- **现代化接口**：提供更友好的操作体验  
- **集群管理**：专门为MySQL集群设计的管理工具
- **开发友好**：为应用开发者提供便捷的API

### 1.2 与传统mysql客户端的区别


```
传统mysql客户端：
mysql -u root -p
mysql> SELECT * FROM users;

MySQL Shell：
mysqlsh --uri root@localhost:3306
MySQL JS> db.users.find()              ← JavaScript语法
MySQL PY> db.users.find()              ← Python语法  
MySQL SQL> SELECT * FROM users;       ← 传统SQL语法
```

**🔹 主要优势对比**

| 特性 | **传统mysql客户端** | **MySQL Shell** |
|------|-------------------|----------------|
| 🔤 **语言支持** | `仅SQL` | `SQL + JavaScript + Python` |
| 🔧 **功能** | `基本查询操作` | `集群管理 + 开发工具 + 运维工具` |
| 📊 **文档存储** | `不支持` | `完整支持JSON文档操作` |
| 🏗️ **集群管理** | `需要额外工具` | `内置InnoDB Cluster管理` |
| 💻 **开发体验** | `传统SQL` | `现代化API + 脚本自动化` |

---

## 2. ⚡ 交互式工具核心功能


### 2.1 三种交互模式


**🔸 模式切换机制**
```
启动MySQL Shell后，可以在三种模式间自由切换：

SQL模式：  \sql      ← 传统SQL查询
JS模式：   \js       ← JavaScript脚本  
Python模式：\py      ← Python脚本

实际操作：
MySQL JS> \sql                    ← 切换到SQL模式
MySQL SQL> SELECT VERSION();     ← 执行SQL
MySQL SQL> \js                   ← 切换回JavaScript模式
```

### 2.2 智能命令补全


**💡 自动补全特性**
```
智能提示功能：
- 数据库名补全
- 表名字段名补全  
- 函数名补全
- 语法错误提示

示例：
MySQL JS> session.getSchema('test').getTable('us  ← 按Tab键
MySQL JS> session.getSchema('test').getTable('users')  ← 自动补全
```

### 2.3 连接管理


**🔗 连接字符串格式**
```bash
# 基本连接
mysqlsh root@localhost:3306

# 完整URI连接
mysqlsh mysql://root:password@localhost:3306/database

# SSL连接
mysqlsh mysqlx://root@localhost:33060 --ssl-mode=REQUIRED

# 集群连接
mysqlsh root@cluster-node1:3306 --cluster
```

**🔹 连接会话管理**
```javascript
// 创建会话
var session = mysql.getSession('root@localhost:3306');

// 检查连接状态
session.isOpen();

// 关闭会话
session.close();
```

---

## 3. 💻 JavaScript和Python脚本模式


### 3.1 JavaScript模式核心操作


**🔸 基础语法**
```javascript
// 获取数据库架构
var db = session.getSchema('testdb');

// 创建表
db.createCollection('users');

// 插入数据
var users = db.getTable('users');
users.insert('name', 'age').values('张三', 25);

// 查询数据  
users.select().where('age > 20').execute();
```

**💡 实用脚本示例**
```javascript
// 批量数据处理脚本
function batchInsertUsers(userList) {
    var db = session.getSchema('company');
    var users = db.getTable('employees');
    
    for (var user of userList) {
        users.insert('name', 'department', 'salary')
             .values(user.name, user.dept, user.salary)
             .execute();
    }
    print('批量插入完成，共处理：' + userList.length + ' 条记录');
}
```

### 3.2 Python模式核心操作


**🔸 基础语法**
```python
# 获取数据库架构
db = session.get_schema('testdb')

# 创建集合
users_collection = db.create_collection('users')

# 插入文档
users_collection.add({
    'name': '李四', 
    'age': 30, 
    'skills': ['Python', 'MySQL', 'Linux']
}).execute()

# 查询文档
result = users_collection.find('age > 25').execute()
for doc in result.fetch_all():
    print(doc)
```

**💡 数据分析脚本**
```python
# 数据统计分析
def analyze_user_data():
    db = session.get_schema('analytics')
    users = db.get_collection('users')
    
    # 年龄分布统计
    age_stats = users.find().fields('age').execute()
    ages = [doc['age'] for doc in age_stats.fetch_all()]
    
    print(f"用户总数: {len(ages)}")
    print(f"平均年龄: {sum(ages)/len(ages):.1f}")
    print(f"最大年龄: {max(ages)}")
    print(f"最小年龄: {min(ages)}")
```

### 3.3 脚本文件执行


**📁 脚本文件执行**
```bash
# 执行JavaScript脚本文件
mysqlsh --file=/path/to/script.js

# 执行Python脚本文件  
mysqlsh --file=/path/to/script.py

# 在交互模式中加载脚本
MySQL JS> \source /path/to/script.js
```

---

## 4. 🏗️ InnoDB Cluster管理


### 4.1 InnoDB Cluster概念


**🔸 什么是InnoDB Cluster**
```
InnoDB Cluster = MySQL高可用集群解决方案
包含三个核心组件：
┌─────────────────────────────┐
│     MySQL Router            │  ← 负载均衡和故障转移
├─────────────────────────────┤
│     MySQL Group Replication │  ← 数据同步复制
├─────────────────────────────┤  
│     MySQL Shell             │  ← 集群管理工具
└─────────────────────────────┘

简单理解：多台MySQL服务器组成一个"团队"，数据自动同步，某台挂了其他的继续工作
```

### 4.2 集群部署和配置


**🔧 集群创建步骤**
```javascript
// 1. 检查实例配置
dba.checkInstanceConfiguration('root@node1:3306');

// 2. 配置实例（如果需要）
dba.configureInstance('root@node1:3306');

// 3. 创建集群
var cluster = dba.createCluster('myCluster');

// 4. 添加实例到集群
cluster.addInstance('root@node2:3306');
cluster.addInstance('root@node3:3306');
```

**💡 集群状态管理**
```javascript
// 查看集群状态
cluster.status();

// 检查集群健康状态
cluster.describe();

// 重新扫描集群
cluster.rescan();

// 从集群移除实例
cluster.removeInstance('root@node2:3306');
```

### 4.3 故障处理


**⚠️ 常见故障处理**
```javascript
// 强制重新配置集群（谨慎使用）
cluster.forceQuorumUsingPartitionOf('root@node1:3306');

// 重启集群复制
cluster.rejoinInstance('root@node2:3306');

// 集群dissolve（解散集群）
cluster.dissolve();
```

---

## 5. 📄 Document Store文档存储


### 5.1 文档存储概念


**🔸 什么是Document Store**
```
Document Store = MySQL中的NoSQL功能
可以像MongoDB一样存储JSON文档
同时保留关系型数据库的ACID特性

对比理解：
关系型表：     用户表有 ID、姓名、年龄 等固定列
文档集合：     存储灵活的JSON文档，结构可以不同

用户文档1: {"name": "张三", "age": 25, "skills": ["Java"]}
用户文档2: {"name": "李四", "age": 30, "city": "北京", "married": true}
```

### 5.2 集合操作


**🔸 创建和管理集合**
```javascript
// 获取数据库
var db = session.getSchema('testdb');

// 创建集合
var users = db.createCollection('users');

// 获取已存在的集合
var products = db.getCollection('products');

// 删除集合
db.dropCollection('old_collection');
```

### 5.3 文档CRUD操作


**✅ 增加文档**
```javascript
// 插入单个文档
users.add({
    name: "王五",
    age: 28,
    email: "wangwu@email.com",
    hobbies: ["读书", "游泳"]
}).execute();

// 批量插入文档
users.add([
    {name: "赵六", age: 32, city: "上海"},
    {name: "孙七", age: 26, city: "深圳"}
]).execute();
```

**🔍 查询文档**
```javascript
// 查询所有文档
users.find().execute();

// 条件查询
users.find('age > 25').execute();

// 复杂查询条件
users.find('age BETWEEN 25 AND 35 AND city = "北京"').execute();

// 排序和限制
users.find().sort('age DESC').limit(10).execute();
```

**✏️ 更新文档**
```javascript
// 更新文档
users.modify('name = "王五"')
     .set('age', 29)
     .set('city', '北京')
     .execute();

// 数组字段操作
users.modify('name = "王五"')
     .arrayAppend('hobbies', '跑步')
     .execute();
```

**🗑️ 删除文档**
```javascript
// 删除符合条件的文档
users.remove('age < 18').execute();

// 删除指定文档
users.remove('name = "测试用户"').execute();
```

---

## 6. 🔌 X DevAPI开发接口


### 6.1 X DevAPI概念


**🔸 什么是X DevAPI**
```
X DevAPI = 现代化的MySQL开发接口
统一了关系型数据和文档存储的操作方式
支持多种编程语言：JavaScript、Python、Java、C++、.NET

传统方式：写SQL语句操作数据库
X DevAPI：用编程语言的方式操作数据库
```

### 6.2 连接和会话管理


**🔗 连接配置**
```javascript
// X Protocol连接（默认端口33060）
var session = mysqlx.getSession({
    host: 'localhost',
    port: 33060,
    user: 'root',
    password: 'password'
});

// 连接池配置
var client = mysqlx.getClient({
    host: 'localhost',
    port: 33060,
    user: 'root',
    password: 'password'
});
```

### 6.3 关系型表操作


**🔸 表操作示例**
```javascript
// 获取表对象
var db = session.getSchema('company');
var employees = db.getTable('employees');

// 插入数据
employees.insert('name', 'department', 'salary')
         .values('张经理', '销售部', 8000)
         .values('李工程师', '技术部', 12000)
         .execute();

// 查询数据
var result = employees.select(['name', 'salary'])
                     .where('salary > 10000')
                     .orderBy('salary DESC')
                     .execute();

// 处理结果
var rows = result.fetchAll();
for (var row of rows) {
    print(row[0] + ': ' + row[1]);
}
```

### 6.4 事务处理


**🔄 事务管理**
```javascript
// 开始事务
session.startTransaction();

try {
    // 执行多个操作
    employees.insert('name', 'salary').values('新员工', 5000).execute();
    
    var result = employees.update().set('salary', 5500)
                          .where('name = "新员工"').execute();
    
    // 提交事务
    session.commit();
    print('事务提交成功');
} catch (error) {
    // 回滚事务
    session.rollback();
    print('事务回滚：' + error.message);
}
```

---

## 7. 📦 数据导入导出工具


### 7.1 数据导出功能


**🔸 导出到多种格式**
```javascript
// 导出表数据为JSON
util.exportTable('test.users', 'file:///tmp/users.json', {
    format: 'json'
});

// 导出为CSV格式
util.exportTable('test.products', 'file:///tmp/products.csv', {
    format: 'csv',
    fieldsTerminatedBy: ',',
    fieldsEnclosedBy: '"'
});

// 导出集合数据
util.exportCollection('test.orders', 'file:///tmp/orders.json');
```

**💡 批量导出**
```javascript
// 导出整个数据库
util.exportSchemas(['company', 'analytics'], 'file:///backup/', {
    format: 'json',
    compression: 'gzip'
});
```

### 7.2 数据导入功能


**🔸 从文件导入**
```javascript
// 导入JSON数据到表
util.importTable('file:///tmp/users.json', {
    schema: 'test',
    table: 'users',
    format: 'json'
});

// 导入CSV数据
util.importTable('file:///tmp/products.csv', {
    schema: 'test', 
    table: 'products',
    format: 'csv',
    fieldsTerminatedBy: ',',
    skipRows: 1  // 跳过标题行
});

// 导入到集合
util.importCollection('file:///tmp/orders.json', {
    schema: 'test',
    collection: 'orders'
});
```

### 7.3 并行处理和性能优化


**⚡ 性能优化选项**
```javascript
// 并行导入提升性能
util.importTable('file:///tmp/big_data.csv', {
    schema: 'analytics',
    table: 'big_table',
    threads: 8,        // 使用8个线程
    bytesPerChunk: 50M // 每块50MB
});

// 批量插入优化
util.importTable('file:///tmp/users.json', {
    schema: 'test',
    table: 'users',
    maxRate: '100K',   // 限制导入速率
    showProgress: true // 显示进度条
});
```

---

## 8. 🛠️ 实用工具集合


### 8.1 数据库检查工具


**🔍 实例配置检查**
```javascript
// 检查实例是否满足集群要求
dba.checkInstanceConfiguration('root@localhost:3306');

// 配置建议和自动修复
dba.configureInstance('root@localhost:3306', {
    interactive: true,  // 交互式配置
    restart: true       // 自动重启应用配置
});
```

**📊 性能分析**
```javascript
// 查看实例状态
\show status like 'Threads_connected';

// 查看配置参数
\show variables like 'innodb_buffer_pool_size';

// 执行计划分析
\explain SELECT * FROM users WHERE age > 25;
```

### 8.2 备份和恢复工具


**💾 逻辑备份**
```bash
# 使用MySQL Shell进行备份
mysqlsh root@localhost:3306 -- util dump-schemas testdb \
    --outputUrl=/backup/testdb_backup

# 恢复数据
mysqlsh root@localhost:3306 -- util load-dump /backup/testdb_backup \
    --schema=testdb_restored
```

### 8.3 升级和迁移工具


**🔄 版本升级检查**
```javascript
// 检查升级兼容性
util.checkForServerUpgrade('root@localhost:3306');

// 迁移到InnoDB Cluster
dba.upgradeMetadata();
```

---

## 9. 🔧 Shell插件扩展机制


### 9.1 插件系统概述


**🔸 插件机制作用**
```
MySQL Shell插件系统 = 可扩展的工具平台
允许开发者创建自定义的功能模块
内置插件提供额外的管理和开发功能

插件类型：
• 全局插件：所有会话都可使用  
• 会话插件：特定会话使用
• 对象插件：扩展特定对象功能
```

### 9.2 常用内置插件


**🔸 审计插件**
```javascript
// 启用审计插件
\plugin audit

// 查看SQL执行历史
audit.sqlLog();

// 监控慢查询
audit.slowQueries();
```

**📈 监控插件**
```javascript
// 启用监控插件
\plugin monitor

// 实时性能监控
monitor.show();

// 查看连接状态
monitor.connections();
```

### 9.3 自定义插件开发


**🔸 简单插件示例**
```javascript
// 创建自定义插件文件：my_plugin.js
var myPlugin = {
    // 插件信息
    name: "MyPlugin",
    version: "1.0.0",
    
    // 自定义函数
    showDatabaseSize: function(schemaName) {
        var db = session.getSchema(schemaName);
        var tables = db.getTables();
        
        print("数据库 " + schemaName + " 包含表：");
        for (var table of tables) {
            var count = table.count();
            print("  " + table.name + ": " + count + " 行");
        }
    }
};

// 注册插件
plugins.register_plugin(myPlugin);
```

**💡 加载和使用自定义插件**
```javascript
// 加载插件
\source my_plugin.js

// 使用插件功能
myPlugin.showDatabaseSize('testdb');
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 MySQL Shell本质：MySQL的现代化多语言客户端工具
🔸 三种模式：SQL、JavaScript、Python可随时切换
🔸 X DevAPI：统一关系型和文档存储的现代化接口
🔸 InnoDB Cluster：MySQL官方高可用集群解决方案
🔸 Document Store：MySQL中的NoSQL文档存储功能
```

### 10.2 关键功能理解


**🔹 为什么要用MySQL Shell**
```
传统痛点：
• 只能用SQL操作，脚本化困难
• 集群管理需要额外工具
• 缺乏现代化开发体验

MySQL Shell解决：
• 多语言支持，脚本自动化
• 内置集群管理功能
• 现代化API和工具集成
```

**🔹 实际应用价值**
```
开发场景：
• 快速原型开发：JavaScript/Python快速操作数据
• 数据分析：灵活的脚本化查询和处理  
• API开发：X DevAPI提供现代化接口

运维场景：
• 集群部署：一键创建InnoDB Cluster
• 数据迁移：高效的导入导出工具
• 监控管理：丰富的检查和分析功能
```

### 10.3 学习重点指导


**🎯 新手学习路径**
```
1. 基础操作：掌握三种模式切换和基本命令
2. 脚本编程：学会用JavaScript/Python操作数据库
3. 文档存储：理解Document Store的NoSQL功能
4. 集群管理：了解InnoDB Cluster的部署和管理
5. 工具应用：熟练使用导入导出和实用工具
```

**⚠️ 注意事项**
```
• X Protocol端口：33060（不是传统的3306）
• 权限要求：集群操作需要相应的管理权限
• 版本兼容：确保MySQL 8.0+才完整支持所有功能
• 学习成本：需要熟悉JavaScript或Python语法
```

### 10.4 实践应用建议


**🔧 最佳实践**
```
• 开发环境：用MySQL Shell进行快速测试和原型开发
• 生产部署：用于InnoDB Cluster的部署和管理
• 数据处理：利用脚本模式进行批量数据操作
• 监控运维：结合插件系统进行数据库监控
```

**核心记忆口诀**：
- MySQL Shell三模式，SQL脚本样样行
- 文档集群一体化，现代开发更轻松
- X DevAPI统天下，关系文档都不怕
- 导入导出插件多，运维开发好帮手