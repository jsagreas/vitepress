---
title: 11、直方图统计信息
---
## 📚 目录

1. [直方图统计信息概述](#1-直方图统计信息概述)
2. [直方图的工作原理](#2-直方图的工作原理)
3. [ANALYZE TABLE增强功能](#3-ANALYZE-TABLE增强功能)
4. [直方图类型与结构](#4-直方图类型与结构)
5. [查询优化器的使用](#5-查询优化器的使用)
6. [直方图管理与维护](#6-直方图管理与维护)
7. [性能影响与最佳实践](#7-性能影响与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📊 直方图统计信息概述


### 1.1 什么是直方图统计信息


**🔸 基本概念**
```
直方图（Histogram）：一种统计数据分布的图表工具
作用：记录表中列数据的值分布情况
目标：帮助查询优化器做出更准确的执行计划
```

**💡 通俗理解**
```
想象一下班级成绩分布：
90-100分：5个学生
80-89分：15个学生  
70-79分：20个学生
60-69分：8个学生
不及格：2个学生

直方图就是这样记录数据在不同区间的分布情况
```

### 1.2 为什么需要直方图


**🔸 传统统计信息的局限**
```
MySQL 8.0之前只有基础统计：
• 总行数
• 唯一值数量  
• 最小值/最大值
• 空值数量

问题：无法了解数据的具体分布
```

**📈 直方图解决的问题**
```
数据倾斜问题：
表：user_orders (用户订单表)
列：order_count (订单数量)

传统统计：总共10万用户，order_count范围1-1000
直方图揭示：
• 95%用户：1-10个订单
• 4%用户：11-50个订单  
• 1%用户：51-1000个订单

优化器现在知道大部分用户订单很少！
```

### 1.3 直方图的核心价值


**🎯 提升查询优化精度**
```
场景：SELECT * FROM users WHERE age BETWEEN 25 AND 35;

没有直方图：
优化器假设年龄均匀分布，估算返回33%的数据

有了直方图：
优化器知道25-35岁用户占60%，更准确的估算
选择更合适的执行计划（索引扫描 vs 全表扫描）
```

---

## 2. ⚙️ 直方图的工作原理


### 2.1 数据分布分析过程


**🔸 分析步骤**
```
步骤1：扫描列数据
步骤2：统计值的频率
步骤3：将数据分组到桶（bucket）中
步骤4：记录每个桶的统计信息
步骤5：存储到系统表中
```

**💻 实际示例**
```sql
-- 创建示例表
CREATE TABLE products (
    id INT PRIMARY KEY,
    price DECIMAL(10,2),
    category_id INT,
    stock_quantity INT
);

-- 插入测试数据
INSERT INTO products VALUES 
(1, 10.50, 1, 100),
(2, 15.80, 1, 50),
(3, 299.99, 2, 10),
(4, 899.00, 2, 5),
(5, 25.30, 1, 80);
```

### 2.2 桶（Bucket）的概念


**🔸 桶的作用**
```
桶：将相似的值归类到一个区间
目的：用有限的空间描述大量数据的分布

价格分布示例：
桶1：0-50元     → 包含70%的商品
桶2：50-100元   → 包含20%的商品
桶3：100-500元  → 包含8%的商品
桶4：500元以上  → 包含2%的商品
```

### 2.3 频率统计机制


**📊 频率计算方式**
```
等宽直方图（Equi-Width）：
• 每个桶覆盖相同的值范围
• 适合数值类型的列

等深直方图（Equi-Depth）：
• 每个桶包含大致相同数量的行
• 适合倾斜分布的数据
```

**🔍 分布分析图解**
```
原始数据分布：
值区间     频率    百分比
1-10      1000    50%
11-20     600     30%
21-30     300     15%
31-40     80      4%  
41-50     20      1%

直方图桶划分：
桶1: 1-10    (50%)
桶2: 11-20   (30%)  
桶3: 21-30   (15%)
桶4: 31-50   (5%)
```

---

## 3. 🔧 ANALYZE TABLE增强功能


### 3.1 基本语法格式


**🔸 创建直方图**
```sql
-- 为单列创建直方图
ANALYZE TABLE table_name 
UPDATE HISTOGRAM ON column_name WITH 100 BUCKETS;

-- 为多列创建直方图
ANALYZE TABLE products 
UPDATE HISTOGRAM ON price, stock_quantity WITH 50 BUCKETS;
```

### 3.2 实际操作示例


**💻 完整操作流程**
```sql
-- 1. 查看当前统计信息
SELECT TABLE_NAME, COLUMN_NAME, HISTOGRAM
FROM information_schema.COLUMN_STATISTICS
WHERE TABLE_NAME = 'products';

-- 2. 创建直方图
ANALYZE TABLE products 
UPDATE HISTOGRAM ON price WITH 100 BUCKETS;

-- 3. 验证创建结果
SELECT 
    COLUMN_NAME,
    JSON_EXTRACT(HISTOGRAM, '$.buckets') as buckets,
    JSON_EXTRACT(HISTOGRAM, '$.data-type') as data_type
FROM information_schema.COLUMN_STATISTICS 
WHERE TABLE_NAME = 'products';
```

### 3.3 删除直方图


**🔸 删除操作**
```sql
-- 删除指定列的直方图
ANALYZE TABLE products 
DROP HISTOGRAM ON price;

-- 删除多列直方图
ANALYZE TABLE products 
DROP HISTOGRAM ON price, stock_quantity;
```

### 3.4 桶数量选择建议


**📊 桶数量对照表**

| **数据量级** | **建议桶数** | **说明** |
|-------------|------------|----------|
| `< 10万行` | `50-100桶` | `基础精度足够` |
| `10万-100万行` | `100-200桶` | `平衡精度与开销` |
| `> 100万行` | `200-1000桶` | `高精度要求` |
| `倾斜分布` | `更多桶` | `捕获分布细节` |

---

## 4. 📋 直方图类型与结构


### 4.1 单例直方图（Singleton）


**🔸 适用场景**
```
特点：唯一值数量较少的列
存储：每个唯一值单独记录频率
优势：精确记录每个值的分布

示例场景：
• 性别字段（男/女）
• 状态字段（待处理/处理中/已完成）
• 等级字段（1-5星评级）
```

**💻 查看单例直方图**
```sql
-- 创建状态列的直方图
ANALYZE TABLE orders 
UPDATE HISTOGRAM ON status WITH 10 BUCKETS;

-- 查看直方图结构
SELECT 
    COLUMN_NAME,
    JSON_PRETTY(HISTOGRAM) as histogram_info
FROM information_schema.COLUMN_STATISTICS 
WHERE TABLE_NAME = 'orders' AND COLUMN_NAME = 'status';
```

### 4.2 等宽直方图（Equi-Width）


**🔸 工作原理**
```
桶划分方式：按值的范围等分
每个桶：覆盖相同的数值范围
记录信息：每个桶内的行数

适用数据：连续数值，分布相对均匀
```

**📊 等宽示例**
```
价格范围：0-1000元
桶划分：
桶1: 0-250元     → 1500行
桶2: 250-500元   → 800行  
桶3: 500-750元   → 200行
桶4: 750-1000元  → 100行

每个桶宽度相同（250元），但行数不同
```

### 4.3 等深直方图（Equi-Depth）


**🔸 工作原理**
```
桶划分方式：按行数等分
每个桶：包含大致相同数量的行
记录信息：每个桶的值范围

适用数据：数据分布严重倾斜
```

**📊 等深示例**
```
目标：每桶650行（总2600行÷4桶）
桶划分结果：
桶1: 0-15元      → 650行
桶2: 15-25元     → 650行
桶3: 25-80元     → 650行  
桶4: 80-1000元   → 650行

每个桶行数相同，但值范围差异很大
```

### 4.4 直方图存储结构


**🔸 JSON格式存储**
```json
{
  "buckets": [
    [0, 25, 0.25, 1500],     // [下界, 上界, 累积频率, 行数]
    [1, 50, 0.45, 800],
    [2, 75, 0.65, 500],
    [3, 100, 1.0, 1200]
  ],
  "data-type": "int",
  "null-values": 0.01,       // 空值比例
  "collation-id": 8,
  "sampling-rate": 1.0,      // 采样率
  "histogram-type": "equi-height"
}
```

---

## 5. 🎯 查询优化器的使用


### 5.1 成本估算改进


**🔸 传统估算 vs 直方图估算**
```sql
-- 查询示例
SELECT * FROM products WHERE price BETWEEN 100 AND 200;
```

**📊 估算对比**
```
传统方式（无直方图）：
假设数据均匀分布
估算：(200-100)/(max_price-min_price) × total_rows
结果：可能严重偏差

直方图方式：
查询价格100-200区间对应的桶
精确计算：桶内行数的累计
结果：更准确的行数估算
```

### 5.2 执行计划选择优化


**💻 实际测试对比**
```sql
-- 创建测试表和数据
CREATE TABLE sales_data (
    id INT PRIMARY KEY,
    amount DECIMAL(10,2),
    region_id INT,
    sale_date DATE,
    INDEX idx_amount (amount),
    INDEX idx_region (region_id)
);

-- 插入倾斜分布的数据（大部分金额在100-500之间）

-- 查看执行计划（无直方图）
EXPLAIN SELECT * FROM sales_data WHERE amount > 1000;
-- 可能选择全表扫描

-- 创建直方图
ANALYZE TABLE sales_data 
UPDATE HISTOGRAM ON amount WITH 100 BUCKETS;

-- 再次查看执行计划（有直方图）
EXPLAIN SELECT * FROM sales_data WHERE amount > 1000;
-- 可能选择索引扫描，因为知道高金额数据很少
```

### 5.3 JOIN操作优化


**🔸 表连接顺序优化**
```sql
-- 多表连接查询
SELECT u.name, o.total_amount 
FROM users u 
JOIN orders o ON u.id = o.user_id 
WHERE u.age BETWEEN 25 AND 35 
  AND o.total_amount > 500;
```

**🎯 优化器决策**
```
有直方图的情况：
1. 分析age列直方图 → 25-35岁用户占40%
2. 分析total_amount列直方图 → >500的订单占5%
3. 选择更优的连接顺序和方法

无直方图的情况：
优化器可能做出次优选择，影响查询性能
```

### 5.4 查询计划验证


**💻 验证直方图效果**
```sql
-- 使用EXPLAIN FORMAT=JSON查看详细信息
EXPLAIN FORMAT=JSON 
SELECT * FROM products 
WHERE price BETWEEN 100 AND 300;

-- 关注cost_info部分的估算精度
-- 对比创建直方图前后的差异
```

---

## 6. 🛠️ 直方图管理与维护


### 6.1 直方图状态查询


**🔸 系统表查询**
```sql
-- 查看所有表的直方图信息
SELECT 
    SCHEMA_NAME,
    TABLE_NAME,
    COLUMN_NAME,
    JSON_EXTRACT(HISTOGRAM, '$.histogram-type') as hist_type,
    JSON_EXTRACT(HISTOGRAM, '$.number-of-buckets-specified') as bucket_count
FROM information_schema.COLUMN_STATISTICS
ORDER BY SCHEMA_NAME, TABLE_NAME;

-- 查看特定表的直方图详情
SELECT 
    COLUMN_NAME,
    JSON_PRETTY(HISTOGRAM) as histogram_detail
FROM information_schema.COLUMN_STATISTICS 
WHERE SCHEMA_NAME = 'mydb' AND TABLE_NAME = 'products';
```

### 6.2 直方图更新策略


**🔸 更新时机**
```
自动更新：MySQL不会自动更新直方图
手动更新：需要定期执行ANALYZE TABLE

建议更新场景：
• 数据分布发生显著变化
• 表数据量增长超过50%
• 查询性能出现明显下降
• 新增大量数据后
```

**💻 更新操作示例**
```sql
-- 定期更新脚本示例
-- 可以放在定时任务中执行

-- 更新核心业务表的直方图
ANALYZE TABLE orders 
UPDATE HISTOGRAM ON order_amount, customer_id WITH 100 BUCKETS;

ANALYZE TABLE products 
UPDATE HISTOGRAM ON price, category_id WITH 50 BUCKETS;

ANALYZE TABLE users 
UPDATE HISTOGRAM ON age, registration_date WITH 80 BUCKETS;
```

### 6.3 存储空间管理


**📊 空间消耗分析**
```sql
-- 评估直方图占用的空间
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    LENGTH(HISTOGRAM) as histogram_size_bytes,
    ROUND(LENGTH(HISTOGRAM)/1024, 2) as histogram_size_kb
FROM information_schema.COLUMN_STATISTICS
ORDER BY LENGTH(HISTOGRAM) DESC;
```

**🔸 空间优化建议**
```
桶数量平衡：
• 太少桶：精度不够
• 太多桶：占用空间大，更新成本高
• 建议：根据数据量和查询需求调整

清理无用直方图：
• 删除不再使用的列的直方图
• 删除临时表的直方图
```

### 6.4 维护最佳实践


**🎯 维护建议**
```
1. 监控数据变化：
   • 跟踪表的INSERT/UPDATE/DELETE操作
   • 评估数据分布变化程度

2. 定期评估效果：
   • 对比查询执行计划
   • 监控查询性能指标

3. 建立更新计划：
   • 高频变化表：每周更新
   • 稳定表：每月更新  
   • 归档表：可不创建直方图
```

---

## 7. ⚡ 性能影响与最佳实践


### 7.1 性能开销分析


**🔸 创建直方图的开销**
```
CPU开销：需要扫描列数据进行统计
内存开销：临时存储统计信息
磁盘I/O：读取表数据
时间开销：与表大小和桶数量相关

实测数据（100万行表）：
• 50桶：约2-5秒
• 100桶：约3-8秒  
• 1000桶：约10-30秒
```

**📊 开销对比表**

| **表大小** | **桶数量** | **创建时间** | **存储空间** | **更新频率建议** |
|-----------|-----------|-------------|-------------|----------------|
| `< 10万行` | `50桶` | `< 1秒` | `< 10KB` | `每周` |
| `10万-100万行` | `100桶` | `2-10秒` | `10-50KB` | `每月` |
| `> 100万行` | `200桶` | `10-60秒` | `50-200KB` | `季度` |

### 7.2 适用场景分析


**✅ 推荐使用场景**
```
高选择性查询：
• WHERE条件过滤大量数据
• 范围查询（BETWEEN, >, <）
• 复杂JOIN操作

数据分布不均：
• 热点数据明显
• 倾斜分布严重
• 传统统计信息不准确
```

**❌ 不建议使用场景**
```
数据分布均匀：
• 传统统计信息已足够准确
• 额外开销得不偿失

高频更新表：
• 数据分布变化快
• 直方图很快过时
• 维护成本过高

小表（< 1万行）：
• 全表扫描已经很快
• 优化收益微小
```

### 7.3 最佳实践指南


**🎯 列选择策略**
```sql
-- 优先为这些列创建直方图：
-- 1. WHERE条件常用列
ANALYZE TABLE orders 
UPDATE HISTOGRAM ON order_date, status WITH 100 BUCKETS;

-- 2. JOIN连接列  
ANALYZE TABLE order_items 
UPDATE HISTOGRAM ON product_id WITH 50 BUCKETS;

-- 3. GROUP BY聚合列
ANALYZE TABLE sales 
UPDATE HISTOGRAM ON region_id WITH 80 BUCKETS;
```

**💡 配置建议**
```sql
-- 根据业务特点调整桶数量

-- 时间列（覆盖足够的时间段）
ANALYZE TABLE logs 
UPDATE HISTOGRAM ON created_at WITH 200 BUCKETS;

-- 金额列（捕获价格分布）
ANALYZE TABLE transactions 
UPDATE HISTOGRAM ON amount WITH 150 BUCKETS;

-- 分类列（离散值较少）
ANALYZE TABLE products 
UPDATE HISTOGRAM ON category_id WITH 30 BUCKETS;
```

### 7.4 监控与调优


**📊 效果监控**
```sql
-- 监控查询执行计划变化
-- 对比使用直方图前后的estimated_rows

-- 查看优化器统计信息使用情况
SHOW STATUS LIKE 'Handler_read%';

-- 监控慢查询日志
-- 关注rows_examined和rows_sent的比例
```

**🔍 问题诊断**
```sql
-- 检查直方图是否被使用
EXPLAIN FORMAT=JSON SELECT ... ;
-- 查看cost_info.read_cost等信息

-- 验证估算精度
SELECT COUNT(*) FROM table WHERE condition;
-- 对比实际行数和EXPLAIN的估算行数
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 直方图本质：记录列数据分布的统计工具
🔸 主要目的：帮助查询优化器做出更准确的执行计划
🔸 解决问题：数据分布不均导致的优化器估算偏差
🔸 存储方式：JSON格式存储在系统表中
🔸 维护方式：手动创建和更新，不会自动维护
```

### 8.2 关键操作要点


**🔹 创建和管理**
```
基本语法：ANALYZE TABLE table_name UPDATE HISTOGRAM ON column_name WITH n BUCKETS
桶数选择：根据数据量选择50-1000桶
适用列：WHERE条件常用、JOIN连接、数据倾斜的列
维护频率：根据数据变化频率定期更新
```

**🔹 性能考量**
```
创建成本：需要扫描全表数据，有一定开销
存储开销：JSON格式存储，占用系统表空间
更新成本：数据变化后需要手动重新分析
查询收益：提升复杂查询的执行计划准确性
```

### 8.3 实际应用指导


**适用场景判断**：
- ✅ 大表且数据分布不均匀
- ✅ 复杂范围查询和JOIN操作
- ✅ 传统统计信息导致执行计划不准确
- ❌ 小表或数据分布均匀
- ❌ 高频更新且分布变化快的表

**最佳实践要点**：
- 🎯 重点关注业务核心查询涉及的列
- 📊 定期评估直方图效果和更新需求  
- ⚡ 平衡精度需求和维护成本
- 🔍 持续监控查询性能变化

### 8.4 核心价值


**🔹 查询优化提升**
- 更准确的行数估算
- 更合理的执行计划选择
- 更高效的JOIN顺序决策
- 更精确的成本计算

**🔹 业务价值实现**
- 复杂查询性能提升
- 数据仓库查询优化
- 报表系统响应加速
- 整体数据库性能改善

**核心记忆**：
- 直方图是MySQL 8.0的智能统计工具
- 通过桶记录数据分布，指导查询优化
- 需要手动维护，重点关注核心业务列
- 适用于大表和分布不均的数据场景