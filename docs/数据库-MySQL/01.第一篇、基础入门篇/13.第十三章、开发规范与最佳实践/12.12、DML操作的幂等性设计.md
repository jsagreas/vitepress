---
title: 12ã€DMLæ“ä½œçš„å¹‚ç­‰æ€§è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å¹‚ç­‰æ€§åŸºç¡€æ¦‚å¿µ](#1-å¹‚ç­‰æ€§åŸºç¡€æ¦‚å¿µ)
2. [INSERTæ“ä½œå¹‚ç­‰æ€§å®ç°](#2-INSERTæ“ä½œå¹‚ç­‰æ€§å®ç°)
3. [UPDATEæ“ä½œå¹‚ç­‰æ€§ä¿è¯](#3-UPDATEæ“ä½œå¹‚ç­‰æ€§ä¿è¯)
4. [DELETEæ“ä½œå¹‚ç­‰æ€§æ§åˆ¶](#4-DELETEæ“ä½œå¹‚ç­‰æ€§æ§åˆ¶)
5. [ä¸šåŠ¡ä¸»é”®è®¾è®¡ç­–ç•¥](#5-ä¸šåŠ¡ä¸»é”®è®¾è®¡ç­–ç•¥)
6. [é‡å¤æ“ä½œæ£€æµ‹æœºåˆ¶](#6-é‡å¤æ“ä½œæ£€æµ‹æœºåˆ¶)
7. [å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯](#7-å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¹‚ç­‰æ€§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**ğŸ’¡ å¹‚ç­‰æ€§å®šä¹‰**
```
å¹‚ç­‰æ€§ï¼ˆIdempotenceï¼‰ï¼šå¯¹åŒä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒ

æ•°å­¦è¡¨è¾¾ï¼šf(f(x)) = f(x)
æ•°æ®åº“è¯­å¢ƒï¼šé‡å¤æ‰§è¡Œç›¸åŒçš„SQLæ“ä½œï¼Œæ•°æ®çŠ¶æ€ä¿æŒä¸€è‡´

ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
âœ… å¼€ç¯ï¼šæ— è®ºæŒ‰å¤šå°‘æ¬¡å¼€å…³ï¼Œç¯éƒ½æ˜¯äº®çš„ï¼ˆå¹‚ç­‰ï¼‰
âŒ å­˜é’±ï¼šæ¯æ¬¡å­˜100å…ƒï¼Œä½™é¢ä¼šä¸æ–­å¢åŠ ï¼ˆéå¹‚ç­‰ï¼‰
```

**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§**
```
åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¸¸è§é—®é¢˜ï¼š
1ï¸âƒ£ ç½‘ç»œé‡è¯•ï¼šè¯·æ±‚è¶…æ—¶åè‡ªåŠ¨é‡è¯•
2ï¸âƒ£ æ¶ˆæ¯é‡å¤ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯èƒ½é‡å¤æŠ•é€’
3ï¸âƒ£ ç”¨æˆ·é‡å¤æ“ä½œï¼šç”¨æˆ·å¤šæ¬¡ç‚¹å‡»æäº¤æŒ‰é’®
4ï¸âƒ£ ç³»ç»Ÿæ•…éšœæ¢å¤ï¼šæ•…éšœæ¢å¤æ—¶å¯èƒ½é‡å¤æ‰§è¡Œ

åæœå¦‚æœä¸å¤„ç†ï¼š
- é‡å¤æ‰£æ¬¾ï¼šç”¨æˆ·è¢«å¤šæ¬¡æ”¶è´¹
- é‡å¤åˆ›å»ºï¼šäº§ç”Ÿå¤§é‡é‡å¤æ•°æ®
- æ•°æ®ä¸ä¸€è‡´ï¼šä¸šåŠ¡çŠ¶æ€æ··ä¹±
- ç³»ç»Ÿä¸ç¨³å®šï¼šèµ„æºæµªè´¹ï¼Œæ€§èƒ½ä¸‹é™
```

### 1.2 æ•°æ®åº“æ“ä½œçš„å¹‚ç­‰æ€§åˆ†ç±»


**ğŸ” DMLæ“ä½œå¹‚ç­‰æ€§ç‰¹ç‚¹**
```
å¤©ç„¶å¹‚ç­‰çš„æ“ä½œï¼š
SELECTï¼šæŸ¥è¯¢æ“ä½œå¤©ç„¶å¹‚ç­‰ï¼Œå¤šæ¬¡æŸ¥è¯¢ç»“æœç›¸åŒ
DELETE WHERE conditionï¼šåˆ é™¤ç‰¹å®šæ¡ä»¶çš„æ•°æ®ï¼Œé‡å¤æ‰§è¡Œæ— å½±å“

éœ€è¦è®¾è®¡æ‰å¹‚ç­‰çš„æ“ä½œï¼š
INSERTï¼šé‡å¤æ’å…¥ä¼šåˆ›å»ºé‡å¤æ•°æ®
UPDATEï¼šæŸäº›æ›´æ–°æ“ä½œå¯èƒ½äº§ç”Ÿç´¯ç§¯æ•ˆåº”

å¤æ‚æƒ…å†µï¼š
æ‰¹é‡æ“ä½œï¼šéœ€è¦æ•´ä½“è€ƒè™‘å¹‚ç­‰æ€§
äº‹åŠ¡æ“ä½œï¼šéœ€è¦ä¿è¯äº‹åŠ¡çº§åˆ«çš„å¹‚ç­‰æ€§
```

### 1.3 å¹‚ç­‰æ€§è®¾è®¡åŸåˆ™


**ğŸ“‹ æ ¸å¿ƒè®¾è®¡åŸåˆ™**
```
1ï¸âƒ£ é¢„é˜²èƒœäºæ²»ç–—
   - åœ¨è®¾è®¡é˜¶æ®µå°±è€ƒè™‘å¹‚ç­‰æ€§
   - ä½¿ç”¨åˆé€‚çš„çº¦æŸå’Œç´¢å¼•
   - é¿å…ä¾èµ–å¤–éƒ¨çŠ¶æ€

2ï¸âƒ£ æ˜ç¡®çš„æ ‡è¯†æœºåˆ¶
   - æ¯ä¸ªæ“ä½œéƒ½æœ‰å”¯ä¸€æ ‡è¯†
   - å¯ä»¥é€šè¿‡æ ‡è¯†åˆ¤æ–­æ“ä½œæ˜¯å¦å·²æ‰§è¡Œ
   - æ ‡è¯†çš„ç”Ÿæˆè¦ç¨³å®šå¯é 

3ï¸âƒ£ åŸå­æ€§ä¿è¯
   - æ£€æŸ¥å’Œæ‰§è¡Œè¦åœ¨åŒä¸€äº‹åŠ¡ä¸­
   - é¿å…æ£€æŸ¥æ—¶å­˜åœ¨ä½†æ‰§è¡Œæ—¶ä¸å­˜åœ¨çš„é—®é¢˜
   - ä½¿ç”¨æ•°æ®åº“çº¦æŸä¿è¯ä¸€è‡´æ€§

4ï¸âƒ£ å¯éªŒè¯æ€§
   - æ“ä½œç»“æœå¯ä»¥è¢«éªŒè¯
   - æä¾›æŸ¥è¯¢æ¥å£æ£€æŸ¥æ“ä½œçŠ¶æ€
   - è®°å½•æ“ä½œæ—¥å¿—ä¾¿äºè¿½è¸ª
```

---

## 2. â• INSERTæ“ä½œå¹‚ç­‰æ€§å®ç°


### 2.1 INSERTå¹‚ç­‰æ€§çš„æŒ‘æˆ˜


**âš ï¸ INSERTæ“ä½œçš„é—®é¢˜**
```
å…¸å‹åœºæ™¯ï¼š
ç”¨æˆ·æ³¨å†Œã€è®¢å•åˆ›å»ºã€æ”¯ä»˜è®°å½•ç­‰ä¸€æ¬¡æ€§æ“ä½œ

é—®é¢˜è¡¨ç°ï¼š
- é‡å¤æäº¤è¡¨å•å¯¼è‡´å¤šä¸ªè´¦æˆ·
- ç½‘ç»œè¶…æ—¶é‡è¯•åˆ›å»ºå¤šä¸ªè®¢å•
- æ¶ˆæ¯é‡å¤æ¶ˆè´¹äº§ç”Ÿé‡å¤è®°å½•

æ ¸å¿ƒå›°éš¾ï¼š
INSERTæ“ä½œæœ¬èº«ä¸æ˜¯å¹‚ç­‰çš„ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½ä¼šæ–°å¢æ•°æ®
```

### 2.2 åŸºäºå”¯ä¸€çº¦æŸçš„å¹‚ç­‰æ€§


**ğŸ” ä¸»é”®çº¦æŸæ³•**
```sql
-- æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸šåŠ¡ä¸»é”®
CREATE TABLE users (
    user_id VARCHAR(32) PRIMARY KEY,  -- ä½¿ç”¨ä¸šåŠ¡IDä½œä¸ºä¸»é”®
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email)
);

-- å¹‚ç­‰çš„INSERTæ“ä½œ
-- æ–¹æ³•1ï¼šINSERT IGNOREï¼ˆMySQLï¼‰
INSERT IGNORE INTO users (user_id, username, email) 
VALUES ('USER_001', 'john_doe', 'john@example.com');

-- æ–¹æ³•2ï¼šINSERT ON DUPLICATE KEY UPDATE
INSERT INTO users (user_id, username, email) 
VALUES ('USER_001', 'john_doe', 'john@example.com')
ON DUPLICATE KEY UPDATE 
    updated_at = CURRENT_TIMESTAMP;  -- åªæ›´æ–°æ—¶é—´æˆ³ï¼Œå…¶ä»–ä¿æŒä¸å˜
```

**ğŸ’» ä»£ç å±‚é¢çš„å®ç°**
```java
// Javaå®ç°INSERTå¹‚ç­‰æ€§
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    /**
     * å¹‚ç­‰çš„ç”¨æˆ·åˆ›å»ºæ–¹æ³•
     */
    @Transactional
    public User createUser(String userId, String username, String email) {
        try {
            // å°è¯•æ’å…¥ç”¨æˆ·
            User user = new User(userId, username, email);
            return userRepository.save(user);
            
        } catch (DuplicateKeyException e) {
            // å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ç°æœ‰ç”¨æˆ·
            return userRepository.findByUserId(userId);
        }
    }
    
    /**
     * ä½¿ç”¨ä¸šåŠ¡é€»è¾‘ä¿è¯å¹‚ç­‰æ€§
     */
    @Transactional
    public User createUserSafely(String userId, String username, String email) {
        // å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨
        User existingUser = userRepository.findByUserId(userId);
        if (existingUser != null) {
            return existingUser;  // å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        }
        
        // ä¸å­˜åœ¨åˆ™åˆ›å»º
        User newUser = new User(userId, username, email);
        return userRepository.save(newUser);
    }
}
```

### 2.3 åŸºäºçŠ¶æ€è¡¨çš„å¹‚ç­‰æ€§


**ğŸ“Š æ“ä½œè®°å½•è¡¨è®¾è®¡**
```sql
-- æ“ä½œå¹‚ç­‰æ€§æ§åˆ¶è¡¨
CREATE TABLE operation_log (
    operation_id VARCHAR(64) PRIMARY KEY,     -- æ“ä½œå”¯ä¸€æ ‡è¯†
    operation_type VARCHAR(20) NOT NULL,     -- æ“ä½œç±»å‹
    business_key VARCHAR(100),               -- ä¸šåŠ¡ä¸»é”®
    status ENUM('PROCESSING', 'SUCCESS', 'FAILED') DEFAULT 'PROCESSING',
    request_data JSON,                       -- è¯·æ±‚å‚æ•°
    response_data JSON,                      -- å“åº”æ•°æ®
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_business_key (business_key),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- ç”¨æˆ·è¡¨ï¼ˆç®€åŒ–ï¼‰
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(32) UNIQUE NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**ğŸ”„ åŸºäºçŠ¶æ€è¡¨çš„å¹‚ç­‰å®ç°**
```java
@Service 
@Transactional
public class IdempotentUserService {
    
    @Autowired
    private OperationLogRepository operationLogRepo;
    
    @Autowired  
    private UserRepository userRepo;
    
    public ApiResponse<User> createUser(String operationId, CreateUserRequest request) {
        // 1. æ£€æŸ¥æ“ä½œæ˜¯å¦å·²ç»å¤„ç†è¿‡
        OperationLog existingOp = operationLogRepo.findByOperationId(operationId);
        
        if (existingOp != null) {
            if ("SUCCESS".equals(existingOp.getStatus())) {
                // æ“ä½œå·²æˆåŠŸï¼Œè¿”å›ä¹‹å‰çš„ç»“æœ
                return ApiResponse.success(
                    gson.fromJson(existingOp.getResponseData(), User.class)
                );
            } else if ("PROCESSING".equals(existingOp.getStatus())) {
                // æ“ä½œæ­£åœ¨å¤„ç†ä¸­ï¼Œè¿”å›å¤„ç†ä¸­çŠ¶æ€
                return ApiResponse.processing("æ“ä½œæ­£åœ¨å¤„ç†ä¸­");
            } else {
                // ä¹‹å‰æ“ä½œå¤±è´¥ï¼Œå¯ä»¥é‡è¯•
                return retryCreateUser(existingOp, request);
            }
        }
        
        // 2. è®°å½•æ“ä½œå¼€å§‹
        OperationLog opLog = new OperationLog();
        opLog.setOperationId(operationId);
        opLog.setOperationType("CREATE_USER");
        opLog.setBusinessKey(request.getUserId());
        opLog.setRequestData(gson.toJson(request));
        opLog.setStatus("PROCESSING");
        operationLogRepo.save(opLog);
        
        try {
            // 3. æ‰§è¡Œå®é™…ä¸šåŠ¡æ“ä½œ
            User user = new User();
            user.setUserId(request.getUserId());
            user.setUsername(request.getUsername());
            user.setEmail(request.getEmail());
            
            User savedUser = userRepo.save(user);
            
            // 4. æ›´æ–°æ“ä½œçŠ¶æ€ä¸ºæˆåŠŸ
            opLog.setStatus("SUCCESS");
            opLog.setResponseData(gson.toJson(savedUser));
            operationLogRepo.save(opLog);
            
            return ApiResponse.success(savedUser);
            
        } catch (Exception e) {
            // 5. æ“ä½œå¤±è´¥ï¼Œè®°å½•å¤±è´¥çŠ¶æ€
            opLog.setStatus("FAILED");
            opLog.setResponseData(gson.toJson(Map.of("error", e.getMessage())));
            operationLogRepo.save(opLog);
            
            throw e;
        }
    }
}
```

### 2.4 åŸºäºåˆ†å¸ƒå¼é”çš„å¹‚ç­‰æ€§


**ğŸ”’ Redisåˆ†å¸ƒå¼é”å®ç°**
```java
@Component
public class RedisIdempotentService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    private static final String LOCK_PREFIX = "idempotent_lock:";
    private static final String RESULT_PREFIX = "idempotent_result:";
    private static final int LOCK_EXPIRE_TIME = 300; // 5åˆ†é’Ÿ
    private static final int RESULT_EXPIRE_TIME = 3600; // 1å°æ—¶
    
    /**
     * å¹‚ç­‰æ€§æ“ä½œæ¨¡æ¿æ–¹æ³•
     */
    public <T> T executeIdempotent(String operationId, Supplier<T> operation) {
        String lockKey = LOCK_PREFIX + operationId;
        String resultKey = RESULT_PREFIX + operationId;
        
        // 1. å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æœ
        String existingResult = redisTemplate.opsForValue().get(resultKey);
        if (existingResult != null) {
            return gson.fromJson(existingResult, new TypeToken<T>(){}.getType());
        }
        
        // 2. å°è¯•è·å–åˆ†å¸ƒå¼é”
        String lockValue = UUID.randomUUID().toString();
        Boolean lockAcquired = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(LOCK_EXPIRE_TIME));
            
        if (!lockAcquired) {
            // è·å–é”å¤±è´¥ï¼Œå¯èƒ½å…¶ä»–å®ä¾‹æ­£åœ¨æ‰§è¡Œ
            throw new IdempotentException("æ“ä½œæ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•");
        }
        
        try {
            // 3. å†æ¬¡æ£€æŸ¥ç»“æœï¼ˆåŒé‡æ£€æŸ¥ï¼‰
            existingResult = redisTemplate.opsForValue().get(resultKey);
            if (existingResult != null) {
                return gson.fromJson(existingResult, new TypeToken<T>(){}.getType());
            }
            
            // 4. æ‰§è¡Œå®é™…æ“ä½œ
            T result = operation.get();
            
            // 5. ä¿å­˜ç»“æœ
            redisTemplate.opsForValue().set(
                resultKey, 
                gson.toJson(result), 
                Duration.ofSeconds(RESULT_EXPIRE_TIME)
            );
            
            return result;
            
        } finally {
            // 6. é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "  return redis.call('del', KEYS[1]) " +
            "else " +
            "  return 0 " +
            "end";
            
        redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Collections.singletonList(lockKey),
            lockValue
        );
    }
}
```

---

## 3. ğŸ”„ UPDATEæ“ä½œå¹‚ç­‰æ€§ä¿è¯


### 3.1 UPDATEå¹‚ç­‰æ€§çš„å¤æ‚æ€§


**ğŸ¤¹ UPDATEæ“ä½œçš„åˆ†ç±»**
```
å¹‚ç­‰çš„UPDATEæ“ä½œï¼š
âœ… è®¾ç½®ç»å¯¹å€¼ï¼šSET status = 'COMPLETED'
âœ… åŸºäºæ¡ä»¶çš„ç»å¯¹æ›´æ–°ï¼šSET price = 100 WHERE id = 1

éå¹‚ç­‰çš„UPDATEæ“ä½œï¼š  
âŒ ç´¯åŠ æ“ä½œï¼šSET balance = balance + 100
âŒ è®¡æ•°å™¨æ›´æ–°ï¼šSET view_count = view_count + 1
âŒ çŠ¶æ€é€’å¢ï¼šSET version = version + 1
```

### 3.2 ç‰ˆæœ¬å·æ§åˆ¶çš„å¹‚ç­‰UPDATE


**ğŸ”¢ ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶**
```sql
-- å¸¦ç‰ˆæœ¬å·çš„è¡¨è®¾è®¡
CREATE TABLE accounts (
    account_id VARCHAR(32) PRIMARY KEY,
    balance DECIMAL(15,2) NOT NULL DEFAULT 0.00,
    version INT NOT NULL DEFAULT 1,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_version (version)
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO accounts (account_id, balance, version) 
VALUES ('ACC_001', 1000.00, 1);
```

**ğŸ’° å¹‚ç­‰çš„ä½™é¢æ›´æ–°å®ç°**
```java
@Service
public class AccountService {
    
    @Autowired
    private AccountRepository accountRepo;
    
    /**
     * å¹‚ç­‰çš„è½¬è´¦æ“ä½œ
     */
    @Transactional
    public TransferResult transfer(String transferId, String fromAccount, 
                                 String toAccount, BigDecimal amount) {
        
        // 1. æ£€æŸ¥è½¬è´¦è®°å½•æ˜¯å¦å·²å­˜åœ¨
        TransferRecord existing = transferRepo.findByTransferId(transferId);
        if (existing != null) {
            if ("SUCCESS".equals(existing.getStatus())) {
                return TransferResult.success(existing);
            } else if ("PROCESSING".equals(existing.getStatus())) {
                throw new BusinessException("è½¬è´¦æ­£åœ¨å¤„ç†ä¸­");
            }
            // FAILEDçŠ¶æ€å¯ä»¥é‡è¯•
        }
        
        // 2. è®°å½•è½¬è´¦å¼€å§‹
        TransferRecord record = new TransferRecord();
        record.setTransferId(transferId);
        record.setFromAccount(fromAccount);
        record.setToAccount(toAccount);
        record.setAmount(amount);
        record.setStatus("PROCESSING");
        transferRepo.save(record);
        
        try {
            // 3. æ‰§è¡Œè½¬è´¦ï¼ˆä½¿ç”¨ç‰ˆæœ¬å·ä¿è¯å¹‚ç­‰ï¼‰
            Account fromAcc = accountRepo.findByAccountId(fromAccount);
            Account toAcc = accountRepo.findByAccountId(toAccount);
            
            // æ£€æŸ¥ä½™é¢
            if (fromAcc.getBalance().compareTo(amount) < 0) {
                throw new InsufficientBalanceException("ä½™é¢ä¸è¶³");
            }
            
            // æ›´æ–°è´¦æˆ·ï¼ˆç‰ˆæœ¬å·æ§åˆ¶ï¼‰
            int fromUpdated = accountRepo.updateBalance(
                fromAccount, 
                fromAcc.getBalance().subtract(amount),
                fromAcc.getVersion()
            );
            
            int toUpdated = accountRepo.updateBalance(
                toAccount,
                toAcc.getBalance().add(amount), 
                toAcc.getVersion()
            );
            
            if (fromUpdated == 0 || toUpdated == 0) {
                throw new ConcurrentUpdateException("å¹¶å‘æ›´æ–°å†²çªï¼Œè¯·é‡è¯•");
            }
            
            // 4. æ›´æ–°è½¬è´¦çŠ¶æ€
            record.setStatus("SUCCESS");
            transferRepo.save(record);
            
            return TransferResult.success(record);
            
        } catch (Exception e) {
            record.setStatus("FAILED");
            record.setErrorMsg(e.getMessage());
            transferRepo.save(record);
            throw e;
        }
    }
}

// Repositoryä¸­çš„ç‰ˆæœ¬å·æ›´æ–°
@Repository
public interface AccountRepository extends JpaRepository<Account, Long> {
    
    @Modifying
    @Query("UPDATE Account a SET a.balance = :balance, a.version = a.version + 1, " +
           "a.updatedAt = CURRENT_TIMESTAMP " +
           "WHERE a.accountId = :accountId AND a.version = :version")
    int updateBalance(@Param("accountId") String accountId, 
                     @Param("balance") BigDecimal balance,
                     @Param("version") Integer version);
}
```

### 3.3 çŠ¶æ€æœºæ¨¡å¼çš„UPDATEå¹‚ç­‰æ€§


**ğŸ° è®¢å•çŠ¶æ€ç®¡ç†**
```sql
-- è®¢å•çŠ¶æ€è¡¨
CREATE TABLE orders (
    order_id VARCHAR(32) PRIMARY KEY,
    user_id VARCHAR(32) NOT NULL,
    status ENUM('CREATED', 'PAID', 'SHIPPED', 'DELIVERED', 'CANCELLED') 
           DEFAULT 'CREATED',
    total_amount DECIMAL(10,2) NOT NULL,
    version INT NOT NULL DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
);

-- çŠ¶æ€å˜æ›´è®°å½•è¡¨
CREATE TABLE order_status_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    order_id VARCHAR(32) NOT NULL,
    from_status VARCHAR(20),
    to_status VARCHAR(20) NOT NULL,
    operation_id VARCHAR(64),  -- æ“ä½œå¹‚ç­‰æ€§æ ‡è¯†
    operator VARCHAR(50),
    reason VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id),
    INDEX idx_operation_id (operation_id),
    UNIQUE KEY uk_operation (operation_id)  -- é˜²é‡å¤æ“ä½œ
);
```

**ğŸ”„ çŠ¶æ€æœºUPDATEå®ç°**
```java
@Service
public class OrderStatusService {
    
    // å®šä¹‰çŠ¶æ€è½¬æ¢è§„åˆ™
    private static final Map<String, Set<String>> STATUS_TRANSITIONS = Map.of(
        "CREATED", Set.of("PAID", "CANCELLED"),
        "PAID", Set.of("SHIPPED", "CANCELLED"), 
        "SHIPPED", Set.of("DELIVERED"),
        "DELIVERED", Set.of(),  // ç»ˆæ€
        "CANCELLED", Set.of()   // ç»ˆæ€
    );
    
    @Transactional
    public void updateOrderStatus(String operationId, String orderId, 
                                String targetStatus, String operator, String reason) {
        
        // 1. æ£€æŸ¥æ“ä½œæ˜¯å¦å·²æ‰§è¡Œ
        OrderStatusLog existing = statusLogRepo.findByOperationId(operationId);
        if (existing != null) {
            // æ“ä½œå·²æ‰§è¡Œï¼Œç›´æ¥è¿”å›
            return;
        }
        
        // 2. è·å–å½“å‰è®¢å•çŠ¶æ€
        Order order = orderRepo.findByOrderId(orderId);
        if (order == null) {
            throw new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨");
        }
        
        String currentStatus = order.getStatus();
        
        // 3. æ£€æŸ¥çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³•
        if (!isValidTransition(currentStatus, targetStatus)) {
            throw new InvalidStatusTransitionException(
                String.format("ä¸èƒ½ä» %s è½¬æ¢åˆ° %s", currentStatus, targetStatus)
            );
        }
        
        // 4. å¦‚æœç›®æ ‡çŠ¶æ€ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼Œè®°å½•æ—¥å¿—ä½†ä¸æ›´æ–°
        if (currentStatus.equals(targetStatus)) {
            recordStatusLog(orderId, currentStatus, targetStatus, operationId, operator, reason);
            return;  // å¹‚ç­‰æ€§ï¼šå·²ç»æ˜¯ç›®æ ‡çŠ¶æ€
        }
        
        // 5. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆä½¿ç”¨ç‰ˆæœ¬å·ï¼‰
        int updated = orderRepo.updateStatus(orderId, targetStatus, order.getVersion());
        if (updated == 0) {
            throw new ConcurrentUpdateException("è®¢å•çŠ¶æ€å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·é‡è¯•");
        }
        
        // 6. è®°å½•çŠ¶æ€å˜æ›´æ—¥å¿—
        recordStatusLog(orderId, currentStatus, targetStatus, operationId, operator, reason);
    }
    
    private boolean isValidTransition(String fromStatus, String toStatus) {
        Set<String> validTargets = STATUS_TRANSITIONS.get(fromStatus);
        return validTargets != null && validTargets.contains(toStatus);
    }
    
    private void recordStatusLog(String orderId, String fromStatus, String toStatus,
                               String operationId, String operator, String reason) {
        OrderStatusLog log = new OrderStatusLog();
        log.setOrderId(orderId);
        log.setFromStatus(fromStatus);
        log.setToStatus(toStatus); 
        log.setOperationId(operationId);
        log.setOperator(operator);
        log.setReason(reason);
        statusLogRepo.save(log);
    }
}
```

### 3.4 å·®å€¼UPDATEçš„å¹‚ç­‰æ€§å¤„ç†


**ğŸ“Š ç§¯åˆ†ç³»ç»Ÿçš„å¹‚ç­‰æ›´æ–°**
```java
@Service
public class PointsService {
    
    /**
     * å¹‚ç­‰çš„ç§¯åˆ†å˜æ›´æ“ä½œ
     */
    @Transactional
    public void changePoints(String operationId, String userId, int pointsChange, String reason) {
        
        // 1. æ£€æŸ¥æ“ä½œè®°å½•
        PointsChangeRecord existing = pointsChangeRepo.findByOperationId(operationId);
        if (existing != null) {
            if ("SUCCESS".equals(existing.getStatus())) {
                return;  // å·²æˆåŠŸæ‰§è¡Œ
            } else if ("PROCESSING".equals(existing.getStatus())) {
                throw new BusinessException("ç§¯åˆ†æ“ä½œæ­£åœ¨å¤„ç†ä¸­");
            }
            // FAILEDçŠ¶æ€å…è®¸é‡è¯•
        }
        
        // 2. è®°å½•æ“ä½œå¼€å§‹
        PointsChangeRecord record = new PointsChangeRecord();
        record.setOperationId(operationId);
        record.setUserId(userId);
        record.setPointsChange(pointsChange);
        record.setReason(reason);
        record.setStatus("PROCESSING");
        pointsChangeRepo.save(record);
        
        try {
            // 3. è·å–ç”¨æˆ·å½“å‰ç§¯åˆ†
            UserPoints userPoints = userPointsRepo.findByUserId(userId);
            if (userPoints == null) {
                userPoints = new UserPoints(userId, 0);
                userPointsRepo.save(userPoints);
            }
            
            // 4. è®¡ç®—æ–°ç§¯åˆ†å€¼
            int newPoints = userPoints.getPoints() + pointsChange;
            if (newPoints < 0) {
                throw new InsufficientPointsException("ç§¯åˆ†ä¸è¶³");
            }
            
            // 5. ä½¿ç”¨ç‰ˆæœ¬å·æ›´æ–°ç§¯åˆ†
            int updated = userPointsRepo.updatePoints(
                userId, newPoints, userPoints.getVersion()
            );
            
            if (updated == 0) {
                throw new ConcurrentUpdateException("ç§¯åˆ†æ›´æ–°å†²çªï¼Œè¯·é‡è¯•");
            }
            
            // 6. æ›´æ–°æ“ä½œçŠ¶æ€
            record.setStatus("SUCCESS");
            record.setNewPoints(newPoints);
            pointsChangeRepo.save(record);
            
        } catch (Exception e) {
            record.setStatus("FAILED");
            record.setErrorMsg(e.getMessage());
            pointsChangeRepo.save(record);
            throw e;
        }
    }
}
```

---

## 4. â– DELETEæ“ä½œå¹‚ç­‰æ€§æ§åˆ¶


### 4.1 DELETEæ“ä½œçš„å¹‚ç­‰ç‰¹æ€§


**ğŸ—‘ï¸ DELETEå¤©ç„¶çš„å¹‚ç­‰æ€§**
```sql
-- è¿™äº›DELETEæ“ä½œæ˜¯å¤©ç„¶å¹‚ç­‰çš„
DELETE FROM users WHERE user_id = 'USER_001';
-- æ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯è¯¥ç”¨æˆ·è¢«åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰

DELETE FROM orders WHERE status = 'EXPIRED';
-- é‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨

-- ä½†æ˜¯éœ€è¦è€ƒè™‘çš„æƒ…å†µï¼š
-- 1. åˆ é™¤æ“ä½œçš„è¿”å›ç»“æœï¼ˆå½±å“è¡Œæ•°ï¼‰
-- 2. çº§è”åˆ é™¤çš„å½±å“
-- 3. è½¯åˆ é™¤çš„çŠ¶æ€ç®¡ç†
```

### 4.2 è½¯åˆ é™¤çš„å¹‚ç­‰æ€§è®¾è®¡


**ğŸ“ è½¯åˆ é™¤è¡¨è®¾è®¡**
```sql
-- æ”¯æŒè½¯åˆ é™¤çš„ç”¨æˆ·è¡¨
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(32) UNIQUE NOT NULL,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    is_deleted TINYINT(1) DEFAULT 0,  -- 0:æœªåˆ é™¤ 1:å·²åˆ é™¤
    deleted_at DATETIME NULL,         -- åˆ é™¤æ—¶é—´
    deleted_by VARCHAR(50) NULL,      -- åˆ é™¤æ“ä½œè€…
    version INT DEFAULT 1,            -- ç‰ˆæœ¬å·
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id_deleted (user_id, is_deleted),
    INDEX idx_deleted (is_deleted)
);

-- åˆ é™¤æ“ä½œè®°å½•è¡¨
CREATE TABLE delete_operations (
    operation_id VARCHAR(64) PRIMARY KEY,
    table_name VARCHAR(50) NOT NULL,
    record_id VARCHAR(100) NOT NULL,   -- è¢«åˆ é™¤è®°å½•çš„ID
    operation_type ENUM('SOFT_DELETE', 'HARD_DELETE') NOT NULL,
    status ENUM('PROCESSING', 'SUCCESS', 'FAILED') DEFAULT 'PROCESSING',
    operator VARCHAR(50),
    reason VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_record (table_name, record_id),
    INDEX idx_status (status)
);
```

**ğŸ”„ è½¯åˆ é™¤å¹‚ç­‰å®ç°**
```java
@Service
public class UserDeletionService {
    
    @Transactional
    public DeletionResult softDeleteUser(String operationId, String userId, 
                                       String operator, String reason) {
        
        // 1. æ£€æŸ¥åˆ é™¤æ“ä½œæ˜¯å¦å·²æ‰§è¡Œ
        DeleteOperation existing = deleteOperationRepo.findByOperationId(operationId);
        if (existing != null) {
            if ("SUCCESS".equals(existing.getStatus())) {
                return DeletionResult.alreadyDeleted(existing);
            } else if ("PROCESSING".equals(existing.getStatus())) {
                throw new BusinessException("åˆ é™¤æ“ä½œæ­£åœ¨å¤„ç†ä¸­");
            }
            // FAILEDçŠ¶æ€å…è®¸é‡è¯•
        }
        
        // 2. è®°å½•åˆ é™¤æ“ä½œå¼€å§‹
        DeleteOperation operation = new DeleteOperation();
        operation.setOperationId(operationId);
        operation.setTableName("users");
        operation.setRecordId(userId);
        operation.setOperationType("SOFT_DELETE");
        operation.setOperator(operator);
        operation.setReason(reason);
        operation.setStatus("PROCESSING");
        deleteOperationRepo.save(operation);
        
        try {
            // 3. æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
            User user = userRepo.findByUserIdAndIsDeleted(userId, false);
            if (user == null) {
                // ç”¨æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ï¼Œè¿™æ˜¯å¹‚ç­‰çš„æƒ…å†µ
                operation.setStatus("SUCCESS");
                deleteOperationRepo.save(operation);
                return DeletionResult.notFound(operationId);
            }
            
            // 4. æ‰§è¡Œè½¯åˆ é™¤ï¼ˆä½¿ç”¨ç‰ˆæœ¬å·é˜²æ­¢å¹¶å‘ï¼‰
            int updated = userRepo.softDelete(userId, operator, user.getVersion());
            if (updated == 0) {
                throw new ConcurrentUpdateException("ç”¨æˆ·çŠ¶æ€å·²è¢«ä¿®æ”¹ï¼Œè¯·é‡è¯•");
            }
            
            // 5. æ›´æ–°æ“ä½œçŠ¶æ€
            operation.setStatus("SUCCESS");
            deleteOperationRepo.save(operation);
            
            return DeletionResult.success(operationId, userId);
            
        } catch (Exception e) {
            operation.setStatus("FAILED");
            operation.setErrorMsg(e.getMessage());
            deleteOperationRepo.save(operation);
            throw e;
        }
    }
    
    /**
     * æ£€æŸ¥åˆ é™¤çŠ¶æ€çš„æŸ¥è¯¢æ–¹æ³•
     */
    public boolean isUserDeleted(String userId) {
        User user = userRepo.findByUserId(userId);
        return user == null || user.getIsDeleted() == 1;
    }
}

// Repositoryå®ç°
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    User findByUserIdAndIsDeleted(String userId, boolean isDeleted);
    
    @Modifying
    @Query("UPDATE User u SET u.isDeleted = 1, u.deletedAt = CURRENT_TIMESTAMP, " +
           "u.deletedBy = :operator, u.version = u.version + 1 " +
           "WHERE u.userId = :userId AND u.isDeleted = 0 AND u.version = :version")
    int softDelete(@Param("userId") String userId, 
                  @Param("operator") String operator,
                  @Param("version") Integer version);
}
```

### 4.3 çº§è”åˆ é™¤çš„å¹‚ç­‰æ€§æ§åˆ¶


**ğŸ”— çº§è”åˆ é™¤æ“ä½œè®¾è®¡**
```java
@Service
public class OrderDeletionService {
    
    /**
     * çº§è”åˆ é™¤è®¢å•åŠå…¶ç›¸å…³æ•°æ®
     */
    @Transactional
    public void cascadeDeleteOrder(String operationId, String orderId, String operator) {
        
        // 1. æ£€æŸ¥æ“ä½œå¹‚ç­‰æ€§
        if (isOperationCompleted(operationId)) {
            return;  // æ“ä½œå·²å®Œæˆ
        }
        
        // 2. è®°å½•çº§è”åˆ é™¤å¼€å§‹
        CascadeDeleteOperation operation = recordCascadeDeleteStart(
            operationId, "ORDER", orderId, operator
        );
        
        try {
            // 3. æŒ‰é¡ºåºåˆ é™¤ç›¸å…³æ•°æ®ï¼ˆè€ƒè™‘å¤–é”®çº¦æŸï¼‰
            List<CascadeStep> steps = Arrays.asList(
                new CascadeStep("order_items", "order_id", orderId),
                new CascadeStep("order_payments", "order_id", orderId),
                new CascadeStep("order_logs", "order_id", orderId),
                new CascadeStep("orders", "order_id", orderId)
            );
            
            for (CascadeStep step : steps) {
                executeDeleteStep(operation.getId(), step);
            }
            
            // 4. æ ‡è®°æ“ä½œæˆåŠŸ
            operation.setStatus("SUCCESS");
            operation.setCompletedAt(LocalDateTime.now());
            cascadeDeleteRepo.save(operation);
            
        } catch (Exception e) {
            // 5. è®°å½•å¤±è´¥çŠ¶æ€
            operation.setStatus("FAILED");
            operation.setErrorMsg(e.getMessage());
            cascadeDeleteRepo.save(operation);
            
            // è€ƒè™‘æ˜¯å¦éœ€è¦å›æ»šå·²åˆ é™¤çš„æ•°æ®
            rollbackIfNecessary(operation);
            throw e;
        }
    }
    
    private void executeDeleteStep(Long operationId, CascadeStep step) {
        // è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œ
        CascadeDeleteStep stepRecord = new CascadeDeleteStep();
        stepRecord.setOperationId(operationId);
        stepRecord.setTableName(step.getTableName());
        stepRecord.setWhereClause(step.getColumnName() + " = '" + step.getValue() + "'");
        stepRecord.setStatus("PROCESSING");
        deleteStepRepo.save(stepRecord);
        
        try {
            // æ‰§è¡Œåˆ é™¤SQL
            String sql = String.format("DELETE FROM %s WHERE %s = ?", 
                step.getTableName(), step.getColumnName());
            
            int deletedRows = jdbcTemplate.update(sql, step.getValue());
            
            // è®°å½•æ­¥éª¤å®Œæˆ
            stepRecord.setDeletedRows(deletedRows);
            stepRecord.setStatus("SUCCESS");
            stepRecord.setCompletedAt(LocalDateTime.now());
            deleteStepRepo.save(stepRecord);
            
        } catch (Exception e) {
            stepRecord.setStatus("FAILED");
            stepRecord.setErrorMsg(e.getMessage());
            deleteStepRepo.save(stepRecord);
            throw e;
        }
    }
}
```

---

## 5. ğŸ”‘ ä¸šåŠ¡ä¸»é”®è®¾è®¡ç­–ç•¥


### 5.1 ä¸šåŠ¡ä¸»é”®è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡æ ¸å¿ƒåŸåˆ™**
```
ä¸šåŠ¡ä¸»é”®ç‰¹å¾ï¼š
1ï¸âƒ£ å”¯ä¸€æ€§ï¼šåœ¨ä¸šåŠ¡ä¸Šå…·æœ‰å”¯ä¸€æ ‡è¯†æ„ä¹‰
2ï¸âƒ£ ç¨³å®šæ€§ï¼šä¸€æ—¦ç¡®å®šä¸åº”æ”¹å˜  
3ï¸âƒ£ å¯è¯»æ€§ï¼šèƒ½å¤Ÿè¡¨è¾¾ä¸šåŠ¡å«ä¹‰
4ï¸âƒ£ å¯é¢„æµ‹ï¼šç”Ÿæˆè§„åˆ™æ˜ç¡®ï¼Œä¾¿äºå¹‚ç­‰æ§åˆ¶

å¸¸è§ä¸šåŠ¡ä¸»é”®æ¨¡å¼ï¼š
ğŸ”¸ æ—¶é—´æˆ³ + ä¸šåŠ¡æ ‡è¯†ï¼šORDER_20241201_001
ğŸ”¸ ä¸šåŠ¡ç¼–ç  + åºåˆ—å·ï¼šUSER_000001  
ğŸ”¸ å¤åˆä¸»é”®ï¼šç”¨æˆ·ID + æ—¥æœŸ + åºå·
ğŸ”¸ UUIDå˜ç§ï¼šç»“åˆä¸šåŠ¡ä¿¡æ¯çš„UUID
```

### 5.2 è®¢å•ä¸šåŠ¡ä¸»é”®è®¾è®¡å®ä¾‹


**ğŸ“‹ è®¢å•IDç”Ÿæˆç­–ç•¥**
```java
@Component
public class OrderIdGenerator {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String ORDER_SEQUENCE_KEY = "order_id_sequence:";
    
    /**
     * ç”Ÿæˆè®¢å•IDï¼šORDER + æ—¥æœŸ + 6ä½åºåˆ—å·
     * æ ¼å¼ï¼šORDER20241201000001
     */
    public String generateOrderId() {
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String sequenceKey = ORDER_SEQUENCE_KEY + dateStr;
        
        // ä½¿ç”¨RedisåŸå­é€’å¢è·å–åºåˆ—å·
        Long sequence = redisTemplate.opsForValue().increment(sequenceKey);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç¬¬äºŒå¤©å‡Œæ™¨è¿‡æœŸï¼‰
        if (sequence == 1) {
            LocalDateTime tomorrow = LocalDate.now().plusDays(1).atStartOfDay();
            Duration ttl = Duration.between(LocalDateTime.now(), tomorrow);
            redisTemplate.expire(sequenceKey, ttl);
        }
        
        return String.format("ORDER%s%06d", dateStr, sequence);
    }
    
    /**
     * åŸºäºç”¨æˆ·å’Œæ—¶é—´ç”Ÿæˆç¡®å®šæ€§è®¢å•IDï¼ˆå¹‚ç­‰å‹å¥½ï¼‰
     */
    public String generateDeterministicOrderId(String userId, String businessId) {
        // ä½¿ç”¨ç”¨æˆ·ID + ä¸šåŠ¡IDç”Ÿæˆç¡®å®šçš„è®¢å•ID
        String combined = userId + ":" + businessId;
        String hash = DigestUtils.md5DigestAsHex(combined.getBytes());
        
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        return String.format("ORDER%s%s", dateStr, hash.substring(0, 8).toUpperCase());
    }
}
```

### 5.3 ç”¨æˆ·ä¸šåŠ¡ä¸»é”®è®¾è®¡


**ğŸ‘¤ ç”¨æˆ·IDç­–ç•¥**
```java
@Component
public class UserIdGenerator {
    
    /**
     * åŸºäºæ‰‹æœºå·ç”Ÿæˆç”¨æˆ·IDï¼ˆé€‚åˆæ‰‹æœºå·æ³¨å†Œåœºæ™¯ï¼‰
     */
    public String generateUserIdByPhone(String phone) {
        // å»æ‰æ‰‹æœºå·å‰ç¼€ï¼Œä¿ç•™å8ä½ + éšæœº2ä½
        String phoneSuffix = phone.replaceAll("\\+86|0086", "").substring(3);
        String randomSuffix = String.format("%02d", new Random().nextInt(100));
        return "U" + phoneSuffix + randomSuffix;
    }
    
    /**
     * åŸºäºé‚®ç®±ç”Ÿæˆç¡®å®šæ€§ç”¨æˆ·ID  
     */
    public String generateUserIdByEmail(String email) {
        String hash = DigestUtils.sha256Hex(email.toLowerCase());
        return "USER_" + hash.substring(0, 16).toUpperCase();
    }
    
    /**
     * UUIDå¼ç”¨æˆ·IDï¼ˆå®Œå…¨éšæœºï¼‰
     */
    public String generateUUIDUserId() {
        return "U_" + UUID.randomUUID().toString().replace("-", "").substring(0, 16);
    }
}
```

### 5.4 å¤åˆä¸šåŠ¡ä¸»é”®è®¾è®¡


**ğŸ”— ç”¨æˆ·ç­¾åˆ°è®°å½•ç¤ºä¾‹**
```sql
-- ç”¨æˆ·ç­¾åˆ°è¡¨ï¼ˆå¤åˆä¸»é”®ï¼‰
CREATE TABLE user_checkins (
    user_id VARCHAR(32) NOT NULL,
    checkin_date DATE NOT NULL,
    checkin_time DATETIME NOT NULL,
    points_earned INT DEFAULT 0,
    consecutive_days INT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (user_id, checkin_date),  -- å¤åˆä¸»é”®ä¿è¯å”¯ä¸€æ€§
    INDEX idx_checkin_date (checkin_date),
    INDEX idx_consecutive (user_id, consecutive_days)
);
```

**âœ… åŸºäºå¤åˆä¸»é”®çš„å¹‚ç­‰ç­¾åˆ°**
```java
@Service
public class CheckinService {
    
    /**
     * ç”¨æˆ·ç­¾åˆ°ï¼ˆå¤©ç„¶å¹‚ç­‰ï¼‰
     */
    @Transactional
    public CheckinResult checkin(String userId) {
        LocalDate today = LocalDate.now();
        
        // 1. æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°ï¼ˆåŸºäºå¤åˆä¸»é”®ï¼‰
        UserCheckin existingCheckin = checkinRepo.findByUserIdAndCheckinDate(userId, today);
        if (existingCheckin != null) {
            // å·²ç­¾åˆ°ï¼Œè¿”å›ç°æœ‰è®°å½•ï¼ˆå¹‚ç­‰ï¼‰
            return CheckinResult.alreadyChecked(existingCheckin);
        }
        
        // 2. è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
        int consecutiveDays = calculateConsecutiveDays(userId, today);
        
        // 3. è®¡ç®—ç§¯åˆ†å¥–åŠ±
        int pointsEarned = calculatePoints(consecutiveDays);
        
        // 4. åˆ›å»ºç­¾åˆ°è®°å½•
        UserCheckin checkin = new UserCheckin();
        checkin.setUserId(userId);
        checkin.setCheckinDate(today);
        checkin.setCheckinTime(LocalDateTime.now());
        checkin.setPointsEarned(pointsEarned);
        checkin.setConsecutiveDays(consecutiveDays);
        
        try {
            checkinRepo.save(checkin);
            
            // 5. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
            userPointsService.addPoints(userId, pointsEarned, "ç­¾åˆ°å¥–åŠ±");
            
            return CheckinResult.success(checkin);
            
        } catch (DuplicateKeyException e) {
            // å¹¶å‘æƒ…å†µä¸‹å¯èƒ½æ’å…¥é‡å¤ï¼ŒæŸ¥è¯¢ç°æœ‰è®°å½•è¿”å›
            existingCheckin = checkinRepo.findByUserIdAndCheckinDate(userId, today);
            return CheckinResult.alreadyChecked(existingCheckin);
        }
    }
    
    private int calculateConsecutiveDays(String userId, LocalDate today) {
        LocalDate yesterday = today.minusDays(1);
        UserCheckin yesterdayCheckin = checkinRepo.findByUserIdAndCheckinDate(userId, yesterday);
        
        if (yesterdayCheckin == null) {
            return 1;  // æ²¡æœ‰è¿ç»­ç­¾åˆ°
        } else {
            return yesterdayCheckin.getConsecutiveDays() + 1;
        }
    }
}
```

---

## 6. ğŸ” é‡å¤æ“ä½œæ£€æµ‹æœºåˆ¶


### 6.1 è¯·æ±‚å”¯ä¸€æ ‡è¯†ç”Ÿæˆ


**ğŸ·ï¸ å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ç­–ç•¥**
```javascript
// å‰ç«¯ç”Ÿæˆè¯·æ±‚å”¯ä¸€æ ‡è¯†
class RequestIdGenerator {
    
    /**
     * åŸºäºç”¨æˆ·æ“ä½œç”Ÿæˆç¡®å®šæ€§ID
     */
    static generateDeterministicId(userId, action, params) {
        const content = `${userId}:${action}:${JSON.stringify(params)}`;
        return `REQ_${this.sha256(content).substring(0, 16)}`;
    }
    
    /**
     * æ—¶é—´çª—å£å†…çš„æ“ä½œIDï¼ˆé˜²æ­¢çŸ­æ—¶é—´é‡å¤ï¼‰
     */
    static generateTimeWindowId(userId, action) {
        const timeWindow = Math.floor(Date.now() / (5 * 60 * 1000)); // 5åˆ†é’Ÿçª—å£
        const content = `${userId}:${action}:${timeWindow}`;
        return `REQ_${this.sha256(content).substring(0, 16)}`;
    }
    
    /**
     * å®Œå…¨éšæœºID + å®¢æˆ·ç«¯ç¼“å­˜
     */
    static generateUniqueId(userId, action) {
        const requestId = `REQ_${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        // å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜ï¼Œé˜²æ­¢é‡å¤æäº¤
        const cacheKey = `pending_request:${action}`;
        if (localStorage.getItem(cacheKey)) {
            throw new Error('è¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™');
        }
        
        localStorage.setItem(cacheKey, requestId);
        setTimeout(() => {
            localStorage.removeItem(cacheKey);
        }, 30000); // 30ç§’åæ¸…é™¤
        
        return requestId;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const requestId = RequestIdGenerator.generateTimeWindowId(
    currentUser.id, 
    'create_order'
);

// å‘é€è¯·æ±‚æ—¶æºå¸¦å”¯ä¸€æ ‡è¯†
fetch('/api/orders', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-Request-Id': requestId  // è¯·æ±‚å”¯ä¸€æ ‡è¯†
    },
    body: JSON.stringify(orderData)
});
```

### 6.2 æœåŠ¡ç«¯é‡å¤æ£€æµ‹å®ç°


**ğŸ›¡ï¸ åŸºäºRedisçš„é‡å¤æ£€æµ‹**
```java
@Component
public class DuplicationDetector {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    private static final String REQUEST_CACHE_PREFIX = "request_cache:";
    private static final int DEFAULT_EXPIRE_SECONDS = 300; // 5åˆ†é’Ÿ
    
    /**
     * æ£€æŸ¥å¹¶æ ‡è®°è¯·æ±‚
     */
    public boolean checkAndMarkRequest(String requestId, int expireSeconds) {
        String key = REQUEST_CACHE_PREFIX + requestId;
        
        // ä½¿ç”¨SET NXå‘½ä»¤ï¼ŒåŸå­æ€§åœ°æ£€æŸ¥å’Œè®¾ç½®
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, "processing", Duration.ofSeconds(expireSeconds));
            
        return success != null && success;
    }
    
    /**
     * æ ‡è®°è¯·æ±‚å®Œæˆ
     */
    public void markRequestCompleted(String requestId, Object result) {
        String key = REQUEST_CACHE_PREFIX + requestId;
        String resultJson = gson.toJson(result);
        
        // æ›´æ–°ä¸ºå®ŒæˆçŠ¶æ€ï¼Œå»¶é•¿è¿‡æœŸæ—¶é—´ç”¨äºè¿”å›ç»“æœ
        redisTemplate.opsForValue().set(
            key, 
            "completed:" + resultJson, 
            Duration.ofSeconds(DEFAULT_EXPIRE_SECONDS * 2)
        );
    }
    
    /**
     * è·å–è¯·æ±‚ç»“æœï¼ˆå¦‚æœå·²å®Œæˆï¼‰
     */
    public Optional<String> getCompletedResult(String requestId) {
        String key = REQUEST_CACHE_PREFIX + requestId;
        String value = redisTemplate.opsForValue().get(key);
        
        if (value != null && value.startsWith("completed:")) {
            return Optional.of(value.substring("completed:".length()));
        }
        
        return Optional.empty();
    }
    
    /**
     * æ¸…ç†è¯·æ±‚è®°å½•
     */
    public void clearRequest(String requestId) {
        String key = REQUEST_CACHE_PREFIX + requestId;
        redisTemplate.delete(key);
    }
}
```

### 6.3 åŸºäºAOPçš„å¹‚ç­‰æ§åˆ¶


**ğŸ­ æ³¨è§£å¼å¹‚ç­‰æ§åˆ¶**
```java
// å¹‚ç­‰æ“ä½œæ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface IdempotentOperation {
    
    /**
     * å¹‚ç­‰é”®è¡¨è¾¾å¼ï¼ˆSpELï¼‰
     */
    String key() default "";
    
    /**
     * è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     */
    int expireSeconds() default 300;
    
    /**
     * æ˜¯å¦è¿”å›ä¹‹å‰çš„ç»“æœ
     */
    boolean returnPreviousResult() default true;
    
    /**
     * è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
     */
    String message() default "æ“ä½œæ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åå†è¯•";
}

// AOPå¹‚ç­‰åˆ‡é¢
@Aspect
@Component
public class IdempotentAspect {
    
    @Autowired
    private DuplicationDetector duplicationDetector;
    
    @Autowired
    private SpelExpressionParser parser = new SpelExpressionParser();
    
    @Around("@annotation(idempotent)")
    public Object handleIdempotent(ProceedingJoinPoint joinPoint, 
                                 IdempotentOperation idempotent) throws Throwable {
        
        // 1. è§£æå¹‚ç­‰é”®
        String idempotentKey = parseIdempotentKey(joinPoint, idempotent.key());
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»“æœ
        if (idempotent.returnPreviousResult()) {
            Optional<String> previousResult = duplicationDetector.getCompletedResult(idempotentKey);
            if (previousResult.isPresent()) {
                return gson.fromJson(previousResult.get(), 
                    ((MethodSignature) joinPoint.getSignature()).getReturnType());
            }
        }
        
        // 3. æ£€æŸ¥å¹¶æ ‡è®°è¯·æ±‚
        boolean acquired = duplicationDetector.checkAndMarkRequest(
            idempotentKey, idempotent.expireSeconds()
        );
        
        if (!acquired) {
            throw new DuplicateOperationException(idempotent.message());
        }
        
        try {
            // 4. æ‰§è¡Œå®é™…æ“ä½œ
            Object result = joinPoint.proceed();
            
            // 5. æ ‡è®°å®Œæˆå¹¶ä¿å­˜ç»“æœ
            duplicationDetector.markRequestCompleted(idempotentKey, result);
            
            return result;
            
        } catch (Exception e) {
            // 6. æ“ä½œå¤±è´¥ï¼Œæ¸…ç†æ ‡è®°
            duplicationDetector.clearRequest(idempotentKey);
            throw e;
        }
    }
    
    private String parseIdempotentKey(ProceedingJoinPoint joinPoint, String keyExpression) {
        if (StringUtils.isBlank(keyExpression)) {
            // é»˜è®¤ä½¿ç”¨æ–¹æ³•ç­¾å + å‚æ•°hash
            String methodSignature = joinPoint.getSignature().toLongString();
            String argsHash = DigestUtils.md5DigestAsHex(
                gson.toJson(joinPoint.getArgs()).getBytes()
            );
            return DigestUtils.md5DigestAsHex((methodSignature + argsHash).getBytes());
        }
        
        // è§£æSpELè¡¨è¾¾å¼
        EvaluationContext context = new StandardEvaluationContext();
        Object[] args = joinPoint.getArgs();
        String[] paramNames = getParameterNames(joinPoint);
        
        for (int i = 0; i < args.length; i++) {
            context.setVariable(paramNames[i], args[i]);
        }
        
        Expression expression = parser.parseExpression(keyExpression);
        return expression.getValue(context, String.class);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class OrderController {
    
    @PostMapping("/orders")
    @IdempotentOperation(
        key = "#request.userId + ':create_order:' + #request.productId",
        expireSeconds = 600,
        message = "è®¢å•åˆ›å»ºä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤"
    )
    public ApiResponse<Order> createOrder(@RequestBody CreateOrderRequest request,
                                        @RequestHeader("X-Request-Id") String requestId) {
        // ä¸šåŠ¡é€»è¾‘...
        Order order = orderService.createOrder(request);
        return ApiResponse.success(order);
    }
}
```

---

## 7. âœ… å¹‚ç­‰æ€§æµ‹è¯•éªŒè¯


### 7.1 å•å…ƒæµ‹è¯•è®¾è®¡


**ğŸ§ª åŸºç¡€å¹‚ç­‰æ€§æµ‹è¯•**
```java
@SpringBootTest
@Transactional
class IdempotentOperationTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    @DisplayName("ç”¨æˆ·åˆ›å»ºæ“ä½œå¹‚ç­‰æ€§æµ‹è¯•")
    void testCreateUserIdempotent() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String userId = "TEST_USER_001";
        String username = "testuser";
        String email = "test@example.com";
        
        // ç¬¬ä¸€æ¬¡åˆ›å»º
        User user1 = userService.createUser(userId, username, email);
        assertNotNull(user1);
        assertEquals(userId, user1.getUserId());
        
        // ç¬¬äºŒæ¬¡åˆ›å»ºï¼ˆå¹‚ç­‰ï¼‰
        User user2 = userService.createUser(userId, username, email);
        assertNotNull(user2);
        assertEquals(user1.getId(), user2.getId());
        assertEquals(user1.getCreatedAt(), user2.getCreatedAt());
        
        // éªŒè¯æ•°æ®åº“ä¸­åªæœ‰ä¸€æ¡è®°å½•
        long count = userRepository.countByUserId(userId);
        assertEquals(1, count);
    }
    
    @Test
    @DisplayName("ç§¯åˆ†å˜æ›´æ“ä½œå¹‚ç­‰æ€§æµ‹è¯•")
    void testPointsChangeIdempotent() {
        // å‡†å¤‡ç”¨æˆ·
        String userId = "TEST_USER_002";
        userService.createUser(userId, "testuser2", "test2@example.com");
        
        String operationId = "POINTS_OP_001";
        int pointsChange = 100;
        
        // ç¬¬ä¸€æ¬¡ç§¯åˆ†å˜æ›´
        pointsService.changePoints(operationId, userId, pointsChange, "æµ‹è¯•å¥–åŠ±");
        
        UserPoints points1 = userPointsRepository.findByUserId(userId);
        assertEquals(100, points1.getPoints().intValue());
        
        // ç¬¬äºŒæ¬¡ç›¸åŒæ“ä½œï¼ˆå¹‚ç­‰ï¼‰
        pointsService.changePoints(operationId, userId, pointsChange, "æµ‹è¯•å¥–åŠ±");
        
        UserPoints points2 = userPointsRepository.findByUserId(userId);
        assertEquals(100, points2.getPoints().intValue()); // ç§¯åˆ†ä¸åº”å¢åŠ 
        
        // éªŒè¯æ“ä½œè®°å½•åªæœ‰ä¸€æ¡æˆåŠŸè®°å½•
        List<PointsChangeRecord> records = pointsChangeRepository.findByOperationId(operationId);
        assertEquals(1, records.size());
        assertEquals("SUCCESS", records.get(0).getStatus());
    }
}
```

### 7.2 å¹¶å‘æµ‹è¯•


**âš¡ å¤šçº¿ç¨‹å¹¶å‘æµ‹è¯•**
```java
@Test
@DisplayName("å¹¶å‘åˆ›å»ºç”¨æˆ·å¹‚ç­‰æ€§æµ‹è¯•")
void testConcurrentUserCreation() throws InterruptedException {
    String userId = "CONCURRENT_USER_001";
    String username = "concurrentuser";
    String email = "concurrent@example.com";
    
    int threadCount = 10;
    CountDownLatch startLatch = new CountDownLatch(1);
    CountDownLatch finishLatch = new CountDownLatch(threadCount);
    AtomicInteger successCount = new AtomicInteger(0);
    AtomicInteger duplicateCount = new AtomicInteger(0);
    
    // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œç”¨æˆ·åˆ›å»º
    for (int i = 0; i < threadCount; i++) {
        new Thread(() -> {
            try {
                startLatch.await(); // ç­‰å¾…ç»Ÿä¸€å¼€å§‹
                
                User user = userService.createUser(userId, username, email);
                if (user != null) {
                    successCount.incrementAndGet();
                }
                
            } catch (DuplicateKeyException e) {
                duplicateCount.incrementAndGet();
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                finishLatch.countDown();
            }
        }).start();
    }
    
    // ç»Ÿä¸€å¼€å§‹æ‰§è¡Œ
    startLatch.countDown();
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    finishLatch.await(10, TimeUnit.SECONDS);
    
    // éªŒè¯ç»“æœ
    assertEquals(1, successCount.get() + duplicateCount.get()); // åªæœ‰ä¸€ä¸ªæˆåŠŸæˆ–å…¶ä»–éƒ½æ˜¯é‡å¤
    
    // éªŒè¯æ•°æ®åº“ä¸­åªæœ‰ä¸€æ¡è®°å½•
    long count = userRepository.countByUserId(userId);
    assertEquals(1, count);
    
    System.out.printf("æˆåŠŸ: %d, é‡å¤æ£€æµ‹: %d%n", 
                     successCount.get(), duplicateCount.get());
}
```

### 7.3 æ¥å£çº§å¹‚ç­‰æµ‹è¯•


**ğŸŒ HTTPæ¥å£å¹‚ç­‰æµ‹è¯•**
```java
@Test
@DisplayName("REST APIå¹‚ç­‰æ€§æµ‹è¯•")
void testRestApiIdempotent() {
    String requestId = "API_TEST_REQUEST_001";
    
    CreateOrderRequest orderRequest = new CreateOrderRequest();
    orderRequest.setUserId("USER_001");
    orderRequest.setProductId("PRODUCT_001");
    orderRequest.setQuantity(2);
    orderRequest.setTotalAmount(new BigDecimal("199.00"));
    
    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_JSON);
    headers.set("X-Request-Id", requestId);
    
    HttpEntity<CreateOrderRequest> request = new HttpEntity<>(orderRequest, headers);
    
    // ç¬¬ä¸€æ¬¡è¯·æ±‚
    ResponseEntity<ApiResponse> response1 = restTemplate.postForEntity(
        "/api/orders", request, ApiResponse.class
    );
    
    assertEquals(HttpStatus.OK, response1.getStatusCode());
    assertTrue(response1.getBody().isSuccess());
    
    String orderId1 = (String) ((Map) response1.getBody().getData()).get("orderId");
    
    // ç¬¬äºŒæ¬¡ç›¸åŒè¯·æ±‚ï¼ˆå¹‚ç­‰ï¼‰
    ResponseEntity<ApiResponse> response2 = restTemplate.postForEntity(
        "/api/orders", request, ApiResponse.class
    );
    
    assertEquals(HttpStatus.OK, response2.getStatusCode());
    assertTrue(response2.getBody().isSuccess());
    
    String orderId2 = (String) ((Map) response2.getBody().getData()).get("orderId");
    
    // éªŒè¯è¿”å›ç›¸åŒçš„è®¢å•ID
    assertEquals(orderId1, orderId2);
    
    // éªŒè¯æ•°æ®åº“ä¸­åªæœ‰ä¸€ä¸ªè®¢å•
    long orderCount = orderRepository.countByOrderId(orderId1);
    assertEquals(1, orderCount);
}
```

### 7.4 æ€§èƒ½æµ‹è¯•


**ğŸ“Š å¹‚ç­‰æ€§èƒ½å½±å“æµ‹è¯•**
```java
@Test
@DisplayName("å¹‚ç­‰æ€§èƒ½å½±å“æµ‹è¯•")
void testIdempotentPerformance() {
    int testCount = 1000;
    String baseUserId = "PERF_TEST_USER_";
    
    // æµ‹è¯•ä¸å¸¦å¹‚ç­‰æ§åˆ¶çš„æ€§èƒ½
    long startTime1 = System.currentTimeMillis();
    for (int i = 0; i < testCount; i++) {
        try {
            userService.createUserWithoutIdempotent(
                baseUserId + i, "user" + i, "user" + i + "@test.com"
            );
        } catch (Exception e) {
            // å¿½ç•¥å¼‚å¸¸
        }
    }
    long duration1 = System.currentTimeMillis() - startTime1;
    
    // æµ‹è¯•å¸¦å¹‚ç­‰æ§åˆ¶çš„æ€§èƒ½
    long startTime2 = System.currentTimeMillis();
    for (int i = 0; i < testCount; i++) {
        try {
            userService.createUser(
                baseUserId + "IDEMPOTENT_" + i, "user" + i, "user" + i + "@test.com"
            );
        } catch (Exception e) {
            // å¿½ç•¥å¼‚å¸¸
        }
    }
    long duration2 = System.currentTimeMillis() - startTime2;
    
    System.out.printf("æ— å¹‚ç­‰æ§åˆ¶: %d ms%n", duration1);
    System.out.printf("æœ‰å¹‚ç­‰æ§åˆ¶: %d ms%n", duration2);
    System.out.printf("æ€§èƒ½å¼€é”€: %.2f%%%n", 
                     ((double)(duration2 - duration1) / duration1) * 100);
    
    // éªŒè¯æ€§èƒ½å¼€é”€åœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆæ¯”å¦‚ä¸è¶…è¿‡50%ï¼‰
    assertTrue(duration2 < duration1 * 1.5, "å¹‚ç­‰æ§åˆ¶æ€§èƒ½å¼€é”€è¿‡å¤§");
}
```

### 7.5 è‡ªåŠ¨åŒ–å¹‚ç­‰æµ‹è¯•æ¡†æ¶


**ğŸ¤– å¹‚ç­‰æµ‹è¯•æ¡†æ¶è®¾è®¡**
```java
@Component
public class IdempotentTestFramework {
    
    /**
     * é€šç”¨å¹‚ç­‰æµ‹è¯•æ¨¡æ¿
     */
    public <T> IdempotentTestResult testIdempotent(
            IdempotentTestCase<T> testCase, 
            int repeatTimes) {
        
        List<T> results = new ArrayList<>();
        List<Exception> exceptions = new ArrayList<>();
        
        // æ‰§è¡Œå¤šæ¬¡ç›¸åŒæ“ä½œ
        for (int i = 0; i < repeatTimes; i++) {
            try {
                T result = testCase.execute();
                results.add(result);
            } catch (Exception e) {
                exceptions.add(e);
            }
        }
        
        // åˆ†æç»“æœ
        IdempotentTestResult analysis = new IdempotentTestResult();
        analysis.setTotalExecutions(repeatTimes);
        analysis.setSuccessCount(results.size());
        analysis.setExceptionCount(exceptions.size());
        analysis.setResults(results);
        analysis.setExceptions(exceptions);
        
        // éªŒè¯å¹‚ç­‰æ€§
        if (!results.isEmpty()) {
            T firstResult = results.get(0);
            boolean isIdempotent = results.stream()
                .allMatch(result -> testCase.areResultsEqual(firstResult, result));
            analysis.setIdempotent(isIdempotent);
        }
        
        // éªŒè¯æ•°æ®ä¸€è‡´æ€§
        analysis.setDataConsistent(testCase.verifyDataConsistency());
        
        return analysis;
    }
}

// æµ‹è¯•ç”¨ä¾‹æ¥å£
@FunctionalInterface
public interface IdempotentTestCase<T> {
    T execute() throws Exception;
    
    default boolean areResultsEqual(T result1, T result2) {
        return Objects.equals(result1, result2);
    }
    
    default boolean verifyDataConsistency() {
        return true;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Test
void testFrameworkUsage() {
    IdempotentTestCase<User> createUserTest = new IdempotentTestCase<User>() {
        @Override
        public User execute() throws Exception {
            return userService.createUser("FRAMEWORK_TEST_USER", "testuser", "test@framework.com");
        }
        
        @Override
        public boolean areResultsEqual(User user1, User user2) {
            return Objects.equals(user1.getUserId(), user2.getUserId()) &&
                   Objects.equals(user1.getUsername(), user2.getUsername()) &&
                   Objects.equals(user1.getEmail(), user2.getEmail());
        }
        
        @Override
        public boolean verifyDataConsistency() {
            // éªŒè¯æ•°æ®åº“ä¸­ç¡®å®åªæœ‰ä¸€æ¡è®°å½•
            long count = userRepository.countByUserId("FRAMEWORK_TEST_USER");
            return count == 1;
        }
    };
    
    // æ‰§è¡Œå¹‚ç­‰æ€§æµ‹è¯•ï¼ˆé‡å¤10æ¬¡ï¼‰
    IdempotentTestResult result = idempotentTestFramework.testIdempotent(createUserTest, 10);
    
    // æ–­è¨€éªŒè¯
    assertTrue(result.isIdempotent(), "æ“ä½œä¸æ»¡è¶³å¹‚ç­‰æ€§");
    assertTrue(result.isDataConsistent(), "æ•°æ®ä¸€è‡´æ€§éªŒè¯å¤±è´¥");
    assertEquals(10, result.getTotalExecutions());
    assertTrue(result.getSuccessCount() > 0, "æ²¡æœ‰æˆåŠŸçš„æ“ä½œ");
}
```

---

## 8. ğŸ¯ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹‚ç­‰æ€§æœ¬è´¨ï¼šé‡å¤æ‰§è¡Œç›¸åŒæ“ä½œï¼Œç»“æœä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒ
ğŸ”¸ è®¾è®¡åŸåˆ™ï¼šé¢„é˜²èƒœäºæ²»ç–—ï¼Œæ˜ç¡®æ ‡è¯†ï¼ŒåŸå­æ€§ä¿è¯ï¼Œå¯éªŒè¯æ€§
ğŸ”¸ å®ç°ç­–ç•¥ï¼šå”¯ä¸€çº¦æŸã€çŠ¶æ€è¡¨è®°å½•ã€åˆ†å¸ƒå¼é”ã€ç‰ˆæœ¬å·æ§åˆ¶
ğŸ”¸ ä¸šåŠ¡ä¸»é”®ï¼šç¨³å®šå”¯ä¸€çš„ä¸šåŠ¡æ ‡è¯†ï¼Œæ˜¯å¹‚ç­‰æ€§çš„åŸºç¡€
ğŸ”¸ æ£€æµ‹æœºåˆ¶ï¼šå®¢æˆ·ç«¯ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ŒæœåŠ¡ç«¯æ£€æµ‹é‡å¤æ“ä½œ
ğŸ”¸ æµ‹è¯•éªŒè¯ï¼šå•å…ƒæµ‹è¯•ã€å¹¶å‘æµ‹è¯•ã€æ¥å£æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
```

### 8.2 å„æ“ä½œç±»å‹çš„å¹‚ç­‰å®ç°è¦ç‚¹


**ğŸ”¹ INSERTæ“ä½œå¹‚ç­‰æ€§**
```
æ ¸å¿ƒç­–ç•¥ï¼š
ğŸ“Œ ä¸»é”®çº¦æŸï¼šä½¿ç”¨ä¸šåŠ¡ä¸»é”®é˜²æ­¢é‡å¤æ’å…¥
ğŸ“Œ INSERT IGNOREï¼šMySQLçš„å¹‚ç­‰æ’å…¥è¯­å¥
ğŸ“Œ INSERT ON DUPLICATE KEY UPDATEï¼šæ’å…¥æˆ–æ›´æ–°
ğŸ“Œ çŠ¶æ€è¡¨è®°å½•ï¼šè®°å½•æ“ä½œè¿‡ç¨‹å’Œç»“æœ
ğŸ“Œ åˆ†å¸ƒå¼é”ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­é˜²å¹¶å‘

è®°å¿†è¦ç‚¹ï¼š
æ’å…¥å¹‚ç­‰é çº¦æŸï¼Œä¸»é”®å”¯ä¸€æ˜¯å…³é”®
çŠ¶æ€è®°å½•é˜²é‡å¤ï¼Œåˆ†å¸ƒå¼é”ä¿å®‰å…¨
```

**ğŸ”¹ UPDATEæ“ä½œå¹‚ç­‰æ€§**
```
åˆ†ç±»å¤„ç†ï¼š
âœ… ç»å¯¹å€¼æ›´æ–°ï¼šå¤©ç„¶å¹‚ç­‰ï¼ŒSET status = 'COMPLETED'
âŒ ç´¯åŠ æ›´æ–°ï¼šéœ€è¦ç‰¹æ®Šå¤„ç†ï¼ŒSET balance = balance + amount

è§£å†³æ–¹æ¡ˆï¼š
ğŸ“Œ ç‰ˆæœ¬å·æ§åˆ¶ï¼šä¹è§‚é”é˜²æ­¢å¹¶å‘é—®é¢˜
ğŸ“Œ çŠ¶æ€æœºæ¨¡å¼ï¼šåˆæ³•çš„çŠ¶æ€è½¬æ¢è·¯å¾„
ğŸ“Œ æ“ä½œè®°å½•ï¼šè®°å½•æ¯æ¬¡æ›´æ–°æ“ä½œ
ğŸ“Œ æ¡ä»¶æ£€æŸ¥ï¼šWHEREå­å¥ç¡®ä¿æ›´æ–°æ¡ä»¶

è®°å¿†å£è¯€ï¼š
æ›´æ–°å¹‚ç­‰çœ‹ç±»å‹ï¼Œç»å¯¹èµ‹å€¼å¤©ç„¶æˆ
ç´¯åŠ æ“ä½œè¦å°å¿ƒï¼Œç‰ˆæœ¬æ§åˆ¶æ˜¯æ³•å®
```

**ğŸ”¹ DELETEæ“ä½œå¹‚ç­‰æ€§**
```
å¤©ç„¶ç‰¹æ€§ï¼š
DELETEæ“ä½œé€šå¸¸æ˜¯å¤©ç„¶å¹‚ç­‰çš„

æ³¨æ„äº‹é¡¹ï¼š
ğŸ“Œ è½¯åˆ é™¤ï¼šéœ€è¦çŠ¶æ€ç®¡ç†ï¼Œé˜²æ­¢é‡å¤æ ‡è®°
ğŸ“Œ çº§è”åˆ é™¤ï¼šéœ€è¦è®°å½•åˆ é™¤æ­¥éª¤ï¼Œæ”¯æŒå›æ»š
ğŸ“Œ è¿”å›ç»“æœï¼šå½±å“è¡Œæ•°å¯èƒ½ä¸åŒï¼Œä½†çŠ¶æ€ä¸€è‡´

å®ç°è¦ç‚¹ï¼š
è½¯åˆ é™¤ç”¨çŠ¶æ€ä½ï¼Œçº§è”åˆ é™¤åˆ†æ­¥éª¤
æ“ä½œè®°å½•è¦è¯¦ç»†ï¼Œå¼‚å¸¸å¤„ç†è€ƒè™‘å…¨
```

### 8.3 è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ


**ğŸ—ï¸ å¹‚ç­‰æ€§è®¾è®¡æ¨¡å¼**
```
1ï¸âƒ£ å”¯ä¸€çº¦æŸæ¨¡å¼ï¼š
   - æ•°æ®åº“å±‚é¢çš„å¤©ç„¶å¹‚ç­‰ä¿éšœ
   - é€‚ç”¨äºç®€å•çš„é˜²é‡å¤åœºæ™¯
   - å®ç°æˆæœ¬æœ€ä½ï¼Œæ•ˆæœæœ€å¥½

2ï¸âƒ£ çŠ¶æ€è®°å½•æ¨¡å¼ï¼š
   - è®°å½•æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸ
   - æ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
   - å¯ä»¥è¿½æº¯æ“ä½œå†å²

3ï¸âƒ£ åˆ†å¸ƒå¼é”æ¨¡å¼ï¼š
   - é€‚ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒ
   - é˜²æ­¢å¹¶å‘æ“ä½œå†²çª
   - éœ€è¦è€ƒè™‘é”çš„é‡Šæ”¾å’Œè¶…æ—¶

4ï¸âƒ£ ç‰ˆæœ¬æ§åˆ¶æ¨¡å¼ï¼š
   - é€‚ç”¨äºéœ€è¦ä¹è§‚é”çš„åœºæ™¯
   - é˜²æ­¢å¹¶å‘æ›´æ–°ä¸¢å¤±
   - æ•°æ®ä¸€è‡´æ€§ä¿éšœå¼º
```

**ğŸ“‹ æœ€ä½³å®è·µæ¸…å•**
```
è®¾è®¡é˜¶æ®µï¼š
â˜‘ï¸ è¯†åˆ«éœ€è¦å¹‚ç­‰æ€§çš„æ“ä½œ
â˜‘ï¸ è®¾è®¡åˆé€‚çš„ä¸šåŠ¡ä¸»é”®
â˜‘ï¸ é€‰æ‹©åˆé€‚çš„å¹‚ç­‰å®ç°ç­–ç•¥
â˜‘ï¸ è€ƒè™‘å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶

å¼€å‘é˜¶æ®µï¼š
â˜‘ï¸ ä½¿ç”¨æ•°æ®åº“çº¦æŸä¿è¯å”¯ä¸€æ€§
â˜‘ï¸ å®ç°æ“ä½œçŠ¶æ€è®°å½•æœºåˆ¶
â˜‘ï¸ æ·»åŠ å¹¶å‘æ§åˆ¶ï¼ˆç‰ˆæœ¬å·/é”ï¼‰
â˜‘ï¸ æä¾›æŸ¥è¯¢æ¥å£éªŒè¯çŠ¶æ€

æµ‹è¯•é˜¶æ®µï¼š
â˜‘ï¸ å•å…ƒæµ‹è¯•è¦†ç›–å¹‚ç­‰é€»è¾‘
â˜‘ï¸ å¹¶å‘æµ‹è¯•éªŒè¯çº¿ç¨‹å®‰å…¨
â˜‘ï¸ æ¥å£æµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯å¹‚ç­‰
â˜‘ï¸ æ€§èƒ½æµ‹è¯•è¯„ä¼°å¼€é”€

è¿ç»´é˜¶æ®µï¼š
â˜‘ï¸ ç›‘æ§é‡å¤æ“ä½œé¢‘ç‡
â˜‘ï¸ å®šæœŸæ¸…ç†è¿‡æœŸæ“ä½œè®°å½•
â˜‘ï¸ å»ºç«‹å¼‚å¸¸æ“ä½œå‘Šè­¦æœºåˆ¶
â˜‘ï¸ å‡†å¤‡æ•°æ®ä¿®å¤é¢„æ¡ˆ
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â— å¸¸è§è¯¯åŒº**
```
âŒ è¯¯åŒº1ï¼šè®¤ä¸ºå¹‚ç­‰æ€§åªæ˜¯é˜²æ­¢é‡å¤æ•°æ®
âœ… æ­£ç¡®ï¼šå¹‚ç­‰æ€§æ˜¯ä¿è¯ç³»ç»ŸçŠ¶æ€ä¸€è‡´æ€§çš„é‡è¦æœºåˆ¶

âŒ è¯¯åŒº2ï¼šåªåœ¨æ•°æ®åº“å±‚é¢è€ƒè™‘å¹‚ç­‰æ€§
âœ… æ­£ç¡®ï¼šéœ€è¦ä»æ¥å£ã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®åº“å¤šå±‚é¢è®¾è®¡

âŒ è¯¯åŒº3ï¼šè®¤ä¸ºGETæ“ä½œä¸éœ€è¦è€ƒè™‘å¹‚ç­‰æ€§
âœ… æ­£ç¡®ï¼šè™½ç„¶GETå¤©ç„¶å¹‚ç­‰ï¼Œä½†è¦æ³¨æ„å‰¯ä½œç”¨ï¼ˆå¦‚è®¿é—®è®¡æ•°ï¼‰

âŒ è¯¯åŒº4ï¼šå¿½ç•¥åˆ†å¸ƒå¼ç¯å¢ƒçš„å¤æ‚æ€§
âœ… æ­£ç¡®ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¹‚ç­‰æ€§è®¾è®¡æ›´åŠ é‡è¦å’Œå¤æ‚
```

**ğŸ”§ é—®é¢˜è§£å†³æŒ‡å—**
```
é—®é¢˜ï¼šæ€§èƒ½å¼€é”€å¤ªå¤§
è§£å†³ï¼š
- ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- å¼‚æ­¥å¤„ç†éå…³é”®æ“ä½œè®°å½•
- åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- æ‰¹é‡æ¸…ç†è¿‡æœŸè®°å½•

é—®é¢˜ï¼šå¹¶å‘å†²çªé¢‘ç¹
è§£å†³ï¼š
- ç»†åŒ–é”çš„ç²’åº¦
- ä½¿ç”¨ä¹è§‚é”æ›¿ä»£æ‚²è§‚é”
- å®ç°é‡è¯•æœºåˆ¶
- ä¼˜åŒ–ä¸šåŠ¡æµç¨‹

é—®é¢˜ï¼šå†å²æ•°æ®æ¸…ç†
è§£å†³ï¼š
- è®¾è®¡åˆç†çš„æ•°æ®ä¿ç•™ç­–ç•¥
- å®ç°è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- æä¾›æ‰‹åŠ¨æ¸…ç†å·¥å…·
- è€ƒè™‘æ•°æ®å½’æ¡£æ–¹æ¡ˆ
```

### 8.5 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ—ºï¸ å®æ–½è·¯çº¿å›¾**
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½å»ºè®¾
â”œâ”€ å»ºç«‹æ“ä½œè®°å½•è¡¨
â”œâ”€ å®ç°åŸºç¡€çš„é‡å¤æ£€æµ‹æœºåˆ¶
â”œâ”€ é…ç½®æ•°æ®åº“çº¦æŸ
â””â”€ æ­å»ºç›‘æ§å‘Šè­¦

ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¸šåŠ¡æ”¹é€ 
â”œâ”€ è¯†åˆ«å…³é”®å¹‚ç­‰åœºæ™¯
â”œâ”€ å®ç°ä¸šåŠ¡å±‚å¹‚ç­‰é€»è¾‘
â”œâ”€ æ·»åŠ æ¥å£å±‚å¹‚ç­‰æ§åˆ¶
â””â”€ å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶

ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•éªŒè¯
â”œâ”€ ç¼–å†™å¹‚ç­‰æ€§æµ‹è¯•ç”¨ä¾‹
â”œâ”€ æ‰§è¡Œå¹¶å‘æµ‹è¯•éªŒè¯
â”œâ”€ è¿›è¡Œæ€§èƒ½å½±å“è¯„ä¼°
â””â”€ ç”Ÿäº§ç¯å¢ƒç°åº¦éªŒè¯

ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å®Œå–„
â”œâ”€ æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–
â”œâ”€ æ¸…ç†å†—ä½™æ“ä½œè®°å½•
â”œâ”€ å®Œå–„æ–‡æ¡£å’ŒåŸ¹è®­
â””â”€ å»ºç«‹æœ€ä½³å®è·µè§„èŒƒ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> å¹‚ç­‰è®¾è®¡ä¸‰è¦ç´ ï¼šå”¯ä¸€æ ‡è¯†ã€çŠ¶æ€è®°å½•ã€åŸå­æ“ä½œ  
> æ’å…¥é˜²é‡é çº¦æŸï¼Œæ›´æ–°å¹‚ç­‰ç”¨ç‰ˆæœ¬  
> åˆ é™¤å¤©ç„¶å·²å¹‚ç­‰ï¼Œè½¯åˆ çŠ¶æ€è¦ç®¡ç†  
> æµ‹è¯•éªŒè¯ä¸å¯å°‘ï¼Œå¹¶å‘åœºæ™¯é‡ç‚¹è€ƒ