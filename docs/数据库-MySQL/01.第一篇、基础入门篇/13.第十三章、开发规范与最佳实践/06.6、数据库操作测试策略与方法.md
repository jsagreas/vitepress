---
title: 6ã€æ•°æ®åº“æ“ä½œæµ‹è¯•ç­–ç•¥ä¸æ–¹æ³•
---
## ğŸ“š ç›®å½•

1. [æ•°æ®åº“æµ‹è¯•æ¦‚è¿°](#1-æ•°æ®åº“æµ‹è¯•æ¦‚è¿°)
2. [å•å…ƒæµ‹è¯•è®¾è®¡](#2-å•å…ƒæµ‹è¯•è®¾è®¡)
3. [é›†æˆæµ‹è¯•æ–¹æ³•](#3-é›†æˆæµ‹è¯•æ–¹æ³•)
4. [æ€§èƒ½æµ‹è¯•ç­–ç•¥](#4-æ€§èƒ½æµ‹è¯•ç­–ç•¥)
5. [å‹åŠ›æµ‹è¯•è®¾è®¡](#5-å‹åŠ›æµ‹è¯•è®¾è®¡)
6. [æ•°æ®åº“MockæŠ€æœ¯](#6-æ•°æ®åº“MockæŠ€æœ¯)
7. [æµ‹è¯•æ•°æ®ç®¡ç†](#7-æµ‹è¯•æ•°æ®ç®¡ç†)
8. [æµ‹è¯•è‡ªåŠ¨åŒ–å®ç°](#8-æµ‹è¯•è‡ªåŠ¨åŒ–å®ç°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š æ•°æ®åº“æµ‹è¯•æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“æµ‹è¯•


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡æ•°æ®åº“æ˜¯ä¸€ä¸ªå›¾ä¹¦ç®¡ç†ç³»ç»Ÿï¼š
- åŠŸèƒ½æµ‹è¯•ï¼šæ£€æŸ¥èƒ½å¦æ­£ç¡®å€Ÿä¹¦ã€è¿˜ä¹¦ã€æŸ¥æ‰¾ä¹¦ç±
- æ€§èƒ½æµ‹è¯•ï¼šæ£€æŸ¥åŒæ—¶100äººå€Ÿä¹¦ä¼šä¸ä¼šå˜æ…¢
- æ•°æ®æµ‹è¯•ï¼šæ£€æŸ¥ä¹¦ç±ä¿¡æ¯æ˜¯å¦å‡†ç¡®ã€å®Œæ•´
- å®‰å…¨æµ‹è¯•ï¼šæ£€æŸ¥æ˜¯å¦æœ‰äººèƒ½å·çœ‹åˆ«äººçš„å€Ÿé˜…è®°å½•

æ•°æ®åº“æµ‹è¯•å°±æ˜¯å…¨æ–¹ä½æ£€æŸ¥æ•°æ®åº“ç³»ç»Ÿæ˜¯å¦å·¥ä½œæ­£å¸¸ï¼
```

**ğŸ“‹ æ•°æ®åº“æµ‹è¯•çš„æ ¸å¿ƒç›®æ ‡**
```
æ•°æ®æ­£ç¡®æ€§ï¼šç¡®ä¿æ•°æ®å­˜å‚¨ã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤éƒ½æ­£ç¡®
æ€§èƒ½è¡¨ç°ï¼šç¡®ä¿åœ¨é¢„æœŸè´Ÿè½½ä¸‹å“åº”é€Ÿåº¦æ»¡è¶³è¦æ±‚
æ•°æ®å®Œæ•´æ€§ï¼šç¡®ä¿æ•°æ®çº¦æŸã€å…³ç³»ã€äº‹åŠ¡éƒ½æ­£ç¡®æ‰§è¡Œ
å®‰å…¨æ€§ï¼šç¡®ä¿æ•°æ®è®¿é—®æƒé™ã€SQLæ³¨å…¥é˜²æŠ¤éƒ½æœ‰æ•ˆ
å¯é æ€§ï¼šç¡®ä¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹æ•°æ®ä¸ä¼šä¸¢å¤±æˆ–æŸå
```

### 1.2 æ•°æ®åº“æµ‹è¯•çš„æŒ‘æˆ˜


**ğŸ¤” ä¸ºä»€ä¹ˆæ•°æ®åº“æµ‹è¯•å¾ˆå›°éš¾**
```
çŠ¶æ€ä¾èµ–ï¼šæ•°æ®åº“æœ‰çŠ¶æ€ï¼Œä¸€ä¸ªæ“ä½œä¼šå½±å“åç»­æ“ä½œ
æ•°æ®å¤æ‚ï¼šçœŸå®æ•°æ®é‡å¤§ã€å…³ç³»å¤æ‚ã€è¾¹ç•Œæƒ…å†µå¤š
å¹¶å‘é—®é¢˜ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œå¯èƒ½äº§ç”Ÿæ„æƒ³ä¸åˆ°çš„é—®é¢˜
ç¯å¢ƒå·®å¼‚ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå¯èƒ½æœ‰å·®å¼‚
æ—¶é—´å› ç´ ï¼šæœ‰äº›é—®é¢˜åªæœ‰åœ¨é•¿æ—¶é—´è¿è¡Œåæ‰ä¼šå‡ºç°
```

### 1.3 æ•°æ®åº“æµ‹è¯•åˆ†ç±»


**ğŸ“Š æŒ‰æµ‹è¯•å±‚æ¬¡åˆ†ç±»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“æµ‹è¯•å±‚æ¬¡å›¾              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å•å…ƒæµ‹è¯•   â”‚   é›†æˆæµ‹è¯•   â”‚   ç³»ç»Ÿæµ‹è¯•   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å•ä¸ªSQLè¯­å¥  â”‚ æ¨¡å—é—´äº¤äº’   â”‚ ç«¯åˆ°ç«¯åœºæ™¯   â”‚
â”‚ å­˜å‚¨è¿‡ç¨‹    â”‚ æ•°æ®åº“è¿æ¥   â”‚ ç”¨æˆ·æµç¨‹    â”‚
â”‚ è§¦å‘å™¨      â”‚ äº‹åŠ¡å¤„ç†    â”‚ æ€§èƒ½æŒ‡æ ‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ æŒ‰æµ‹è¯•å†…å®¹åˆ†ç±»**
```
åŠŸèƒ½æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“æ“ä½œåŠŸèƒ½æ˜¯å¦æ­£ç¡®
æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“åœ¨ä¸åŒè´Ÿè½½ä¸‹çš„è¡¨ç°
å®‰å…¨æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“çš„å®‰å…¨é˜²æŠ¤æœºåˆ¶
å…¼å®¹æ€§æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“åœ¨ä¸åŒç¯å¢ƒä¸‹çš„å…¼å®¹æ€§
å¯é æ€§æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“çš„ç¨³å®šæ€§å’Œå®¹é”™èƒ½åŠ›
```

---

## 2. ğŸ”§ å•å…ƒæµ‹è¯•è®¾è®¡


### 2.1 æ•°æ®åº“å•å…ƒæµ‹è¯•åŸºç¡€


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ•°æ®åº“å•å…ƒæµ‹è¯•**
```
å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•æ•°æ®åº“ä¸­æœ€å°çš„å¯æµ‹è¯•éƒ¨åˆ†
åŒ…æ‹¬ï¼šå•ä¸ªSQLè¯­å¥ã€å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€è§¦å‘å™¨

å°±åƒæµ‹è¯•æ±½è½¦çš„æ¯ä¸ªé›¶ä»¶ä¸€æ ·ï¼š
- æµ‹è¯•å‘åŠ¨æœºæ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨
- æµ‹è¯•åˆ¹è½¦æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
- æµ‹è¯•ç¯å…‰æ˜¯å¦èƒ½æ­£å¸¸ç‚¹äº®
```

**ğŸ’¡ æ•°æ®åº“å•å…ƒæµ‹è¯•çš„ç‰¹ç‚¹**
```
éš”ç¦»æ€§ï¼šæ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹ï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
å¯é‡å¤ï¼šåŒæ ·çš„æµ‹è¯•å¯ä»¥åå¤æ‰§è¡Œï¼Œç»“æœä¸€è‡´
å¿«é€Ÿæ‰§è¡Œï¼šå•å…ƒæµ‹è¯•åº”è¯¥å¿«é€Ÿæ‰§è¡Œï¼Œä¾¿äºé¢‘ç¹è¿è¡Œ
è‡ªåŠ¨éªŒè¯ï¼šæµ‹è¯•ç»“æœåº”è¯¥è‡ªåŠ¨åˆ¤æ–­ï¼Œæ— éœ€äººå·¥æ£€æŸ¥
```

### 2.2 SQLè¯­å¥å•å…ƒæµ‹è¯•


**ğŸ› ï¸ åŸºæœ¬çš„SQLæµ‹è¯•æ¡†æ¶**
```java
public class UserDaoTest {
    
    private UserDao userDao;
    private JdbcTemplate jdbcTemplate;
    
    @BeforeEach
    void setUp() {
        // åˆå§‹åŒ–æµ‹è¯•æ•°æ®æº
        DataSource testDataSource = createTestDataSource();
        jdbcTemplate = new JdbcTemplate(testDataSource);
        userDao = new UserDao(testDataSource);
        
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        prepareTestData();
    }
    
    @Test
    void testInsertUser() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        User user = User.builder()
            .name("å¼ ä¸‰")
            .email("zhangsan@example.com")
            .age(25)
            .build();
        
        // æ‰§è¡Œæ’å…¥æ“ä½œ
        Long userId = userDao.insertUser(user);
        
        // éªŒè¯ç»“æœ
        assertThat(userId).isNotNull();
        assertThat(userId).isGreaterThan(0L);
        
        // éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®æ’å…¥
        User insertedUser = userDao.findById(userId);
        assertThat(insertedUser.getName()).isEqualTo("å¼ ä¸‰");
        assertThat(insertedUser.getEmail()).isEqualTo("zhangsan@example.com");
        assertThat(insertedUser.getAge()).isEqualTo(25);
    }
    
    @Test
    void testUpdateUser() {
        // å‡†å¤‡å·²å­˜åœ¨çš„æµ‹è¯•ç”¨æˆ·
        Long userId = createTestUser("æå››", "lisi@example.com", 30);
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        User updateUser = User.builder()
            .id(userId)
            .name("æå››å››")
            .email("lisi44@example.com")
            .age(31)
            .build();
        
        int updatedRows = userDao.updateUser(updateUser);
        
        // éªŒè¯æ›´æ–°ç»“æœ
        assertThat(updatedRows).isEqualTo(1);
        
        // éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®æ›´æ–°
        User updatedUser = userDao.findById(userId);
        assertThat(updatedUser.getName()).isEqualTo("æå››å››");
        assertThat(updatedUser.getEmail()).isEqualTo("lisi44@example.com");
        assertThat(updatedUser.getAge()).isEqualTo(31);
    }
    
    @AfterEach
    void tearDown() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        cleanupTestData();
    }
}
```

### 2.3 å­˜å‚¨è¿‡ç¨‹å•å…ƒæµ‹è¯•


**ğŸ“ å­˜å‚¨è¿‡ç¨‹æµ‹è¯•ç¤ºä¾‹**
```sql
-- è¢«æµ‹è¯•çš„å­˜å‚¨è¿‡ç¨‹
DELIMITER $$
CREATE PROCEDURE GetUserStatistics(
    IN department_id INT,
    OUT total_users INT,
    OUT avg_age DECIMAL(5,2),
    OUT max_salary DECIMAL(10,2)
)
BEGIN
    SELECT 
        COUNT(*) as total,
        AVG(age) as average_age,
        MAX(salary) as maximum_salary
    INTO total_users, avg_age, max_salary
    FROM users 
    WHERE department_id = department_id AND deleted_at IS NULL;
END$$
DELIMITER ;
```

**ğŸ§ª å­˜å‚¨è¿‡ç¨‹æµ‹è¯•ä»£ç **
```java
@Test
void testGetUserStatistics() {
    // å‡†å¤‡æµ‹è¯•æ•°æ®ï¼šåˆ›å»ºä¸€ä¸ªéƒ¨é—¨å’Œå‡ ä¸ªç”¨æˆ·
    Integer deptId = createTestDepartment("ç ”å‘éƒ¨");
    createTestUser("å¼ ä¸‰", 25, 8000.00, deptId);
    createTestUser("æå››", 30, 12000.00, deptId);
    createTestUser("ç‹äº”", 28, 10000.00, deptId);
    
    // è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
    SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
        .withProcedureName("GetUserStatistics");
    
    MapSqlParameterSource params = new MapSqlParameterSource()
        .addValue("department_id", deptId);
    
    Map<String, Object> result = jdbcCall.execute(params);
    
    // éªŒè¯ç»“æœ
    assertThat(result.get("total_users")).isEqualTo(3);
    assertThat((BigDecimal) result.get("avg_age")).isEqualTo(new BigDecimal("27.67"));
    assertThat((BigDecimal) result.get("max_salary")).isEqualTo(new BigDecimal("12000.00"));
}

@Test  
void testGetUserStatisticsEmptyDepartment() {
    // æµ‹è¯•ç©ºéƒ¨é—¨çš„æƒ…å†µ
    Integer emptyDeptId = createTestDepartment("ç©ºéƒ¨é—¨");
    
    MapSqlParameterSource params = new MapSqlParameterSource()
        .addValue("department_id", emptyDeptId);
    
    Map<String, Object> result = jdbcCall.execute(params);
    
    // éªŒè¯ç©ºç»“æœ
    assertThat(result.get("total_users")).isEqualTo(0);
    assertThat(result.get("avg_age")).isNull();
    assertThat(result.get("max_salary")).isNull();
}
```

### 2.4 è§¦å‘å™¨å•å…ƒæµ‹è¯•


**âš¡ è§¦å‘å™¨æµ‹è¯•ç­–ç•¥**
```java
@Test
void testUserAuditTrigger() {
    // æµ‹è¯•ç”¨æˆ·æ›´æ–°æ—¶æ˜¯å¦æ­£ç¡®è®°å½•å®¡è®¡æ—¥å¿—
    
    // 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    Long userId = createTestUser("æµ‹è¯•ç”¨æˆ·", "test@example.com", 25);
    
    // 2. æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆåº”è¯¥è§¦å‘å®¡è®¡è§¦å‘å™¨ï¼‰
    jdbcTemplate.update(
        "UPDATE users SET name = ?, updated_at = NOW() WHERE id = ?",
        "æ–°åç§°", userId
    );
    
    // 3. éªŒè¯å®¡è®¡æ—¥å¿—æ˜¯å¦æ­£ç¡®è®°å½•
    List<Map<String, Object>> auditLogs = jdbcTemplate.queryForList(
        "SELECT * FROM user_audit_log WHERE user_id = ? ORDER BY created_at DESC",
        userId
    );
    
    assertThat(auditLogs).hasSize(1);
    
    Map<String, Object> latestLog = auditLogs.get(0);
    assertThat(latestLog.get("operation_type")).isEqualTo("UPDATE");
    assertThat(latestLog.get("old_name")).isEqualTo("æµ‹è¯•ç”¨æˆ·");
    assertThat(latestLog.get("new_name")).isEqualTo("æ–°åç§°");
    assertThat(latestLog.get("created_at")).isNotNull();
}
```

> **ğŸ’¡ æ ¸å¿ƒè¦ç‚¹ï¼š** æ•°æ®åº“å•å…ƒæµ‹è¯•è¦å…³æ³¨æ•°æ®çš„å‡†ç¡®æ€§ã€è¾¹ç•Œæ¡ä»¶çš„å¤„ç†ã€å¼‚å¸¸æƒ…å†µçš„å“åº”ã€‚

---

## 3. ğŸ”— é›†æˆæµ‹è¯•æ–¹æ³•


### 3.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“é›†æˆæµ‹è¯•


**ğŸ”¸ é›†æˆæµ‹è¯•çš„æ¦‚å¿µ**
```
é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å¤šä¸ªæ¨¡å—æˆ–ç»„ä»¶ä¸€èµ·å·¥ä½œæ—¶çš„è¡¨ç°
æ•°æ®åº“é›†æˆæµ‹è¯•ï¼šæµ‹è¯•åº”ç”¨ç¨‹åºä¸æ•°æ®åº“äº¤äº’çš„å®Œæ•´æµç¨‹

å°±åƒæµ‹è¯•æ±½è½¦æ•´ä½“æ€§èƒ½ï¼š
- ä¸åªæµ‹è¯•å‘åŠ¨æœºï¼Œè¿˜è¦æµ‹è¯•å‘åŠ¨æœº+ä¼ åŠ¨ç³»ç»Ÿ
- ä¸åªæµ‹è¯•åˆ¹è½¦ï¼Œè¿˜è¦æµ‹è¯•åˆ¹è½¦+ABSç³»ç»Ÿ
- æµ‹è¯•å„ä¸ªç³»ç»ŸååŒå·¥ä½œçš„æ•ˆæœ
```

**ğŸ“Š æ•°æ®åº“é›†æˆæµ‹è¯•å±‚æ¬¡**
```
åº”ç”¨å±‚ â†• æ•°æ®è®¿é—®å±‚ â†• æ•°æ®åº“å±‚
    â†“           â†“          â†“
Service     DAO/Repository  Database
 å±‚æµ‹è¯•      å±‚æµ‹è¯•        è¿æ¥æµ‹è¯•
```

### 3.2 DAOå±‚é›†æˆæµ‹è¯•


**ğŸ› ï¸ DAOå±‚æµ‹è¯•å®ç°**
```java
@SpringBootTest
@Transactional
@Rollback
public class UserDaoIntegrationTest {
    
    @Autowired
    private UserDao userDao;
    
    @Autowired
    private DepartmentDao departmentDao;
    
    @Test
    void testUserDepartmentRelationship() {
        // æµ‹è¯•ç”¨æˆ·å’Œéƒ¨é—¨çš„å…³è”å…³ç³»
        
        // 1. åˆ›å»ºéƒ¨é—¨
        Department dept = Department.builder()
            .name("ç ”å‘éƒ¨")
            .description("æŠ€æœ¯ç ”å‘éƒ¨é—¨")
            .build();
        Long deptId = departmentDao.save(dept);
        
        // 2. åˆ›å»ºç”¨æˆ·å¹¶å…³è”éƒ¨é—¨
        User user = User.builder()
            .name("å¼ ä¸‰")
            .email("zhangsan@example.com")
            .departmentId(deptId)
            .build();
        Long userId = userDao.save(user);
        
        // 3. æµ‹è¯•å…³è”æŸ¥è¯¢
        User userWithDept = userDao.findUserWithDepartment(userId);
        
        assertThat(userWithDept).isNotNull();
        assertThat(userWithDept.getName()).isEqualTo("å¼ ä¸‰");
        assertThat(userWithDept.getDepartment()).isNotNull();
        assertThat(userWithDept.getDepartment().getName()).isEqualTo("ç ”å‘éƒ¨");
        
        // 4. æµ‹è¯•çº§è”æŸ¥è¯¢
        List<User> deptUsers = userDao.findUsersByDepartment(deptId);
        assertThat(deptUsers).hasSize(1);
        assertThat(deptUsers.get(0).getName()).isEqualTo("å¼ ä¸‰");
    }
    
    @Test
    void testTransactionRollback() {
        // æµ‹è¯•äº‹åŠ¡å›æ»šæ˜¯å¦æ­£ç¡®
        
        Long initialUserCount = userDao.count();
        
        try {
            userDao.batchInsertWithError(Arrays.asList(
                User.builder().name("ç”¨æˆ·1").email("user1@example.com").build(),
                User.builder().name("ç”¨æˆ·2").email("user2@example.com").build(),
                User.builder().name("é‡å¤é‚®ç®±").email("user1@example.com").build()  // è¿™ä¼šå¯¼è‡´é”™è¯¯
            ));
            
            fail("åº”è¯¥æŠ›å‡ºå¼‚å¸¸");
        } catch (DataIntegrityViolationException e) {
            // é¢„æœŸçš„å¼‚å¸¸
        }
        
        // éªŒè¯äº‹åŠ¡æ˜¯å¦æ­£ç¡®å›æ»š
        Long finalUserCount = userDao.count();
        assertThat(finalUserCount).isEqualTo(initialUserCount);
    }
}
```

### 3.3 Serviceå±‚é›†æˆæµ‹è¯•


**ğŸ¯ ä¸šåŠ¡é€»è¾‘é›†æˆæµ‹è¯•**
```java
@SpringBootTest
@Transactional
public class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @MockBean
    private EmailService emailService;  // æ¨¡æ‹Ÿå¤–éƒ¨æœåŠ¡
    
    @Test
    void testCreateUserWithNotification() {
        // æµ‹è¯•åˆ›å»ºç”¨æˆ·å¹¶å‘é€é€šçŸ¥çš„å®Œæ•´æµç¨‹
        
        CreateUserRequest request = CreateUserRequest.builder()
            .name("æ–°ç”¨æˆ·")
            .email("newuser@example.com")
            .departmentId(1L)
            .build();
        
        // æ¨¡æ‹Ÿé‚®ä»¶æœåŠ¡
        when(emailService.sendWelcomeEmail(anyString()))
            .thenReturn(true);
        
        // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        UserResponse response = userService.createUser(request);
        
        // éªŒè¯ç”¨æˆ·åˆ›å»º
        assertThat(response.getId()).isNotNull();
        assertThat(response.getName()).isEqualTo("æ–°ç”¨æˆ·");
        
        // éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®
        User savedUser = userService.findById(response.getId());
        assertThat(savedUser.getName()).isEqualTo("æ–°ç”¨æˆ·");
        assertThat(savedUser.getStatus()).isEqualTo(UserStatus.ACTIVE);
        
        // éªŒè¯å¤–éƒ¨æœåŠ¡è°ƒç”¨
        verify(emailService).sendWelcomeEmail("newuser@example.com");
    }
    
    @Test
    void testUserWorkflow() {
        // æµ‹è¯•ç”¨æˆ·å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ
        
        // 1. åˆ›å»ºç”¨æˆ·
        Long userId = userService.createUser(
            CreateUserRequest.builder()
                .name("å·¥ä½œæµç”¨æˆ·")
                .email("workflow@example.com")
                .build()
        ).getId();
        
        // 2. æ¿€æ´»ç”¨æˆ·
        userService.activateUser(userId);
        User activatedUser = userService.findById(userId);
        assertThat(activatedUser.getStatus()).isEqualTo(UserStatus.ACTIVE);
        
        // 3. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        userService.updateUser(userId, 
            UpdateUserRequest.builder()
                .name("æ›´æ–°åçš„ç”¨æˆ·")
                .build()
        );
        User updatedUser = userService.findById(userId);
        assertThat(updatedUser.getName()).isEqualTo("æ›´æ–°åçš„ç”¨æˆ·");
        
        // 4. åœç”¨ç”¨æˆ·
        userService.deactivateUser(userId);
        User deactivatedUser = userService.findById(userId);
        assertThat(deactivatedUser.getStatus()).isEqualTo(UserStatus.INACTIVE);
        
        // 5. åˆ é™¤ç”¨æˆ·
        userService.deleteUser(userId);
        assertThat(userService.existsById(userId)).isFalse();
    }
}
```

### 3.4 æ•°æ®åº“è¿æ¥æ± æµ‹è¯•


**ğŸ”Œ è¿æ¥æ± é›†æˆæµ‹è¯•**
```java
@Test
void testConnectionPoolUnderLoad() throws InterruptedException {
    // æµ‹è¯•è¿æ¥æ± åœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°
    
    int threadCount = 20;
    int operationsPerThread = 50;
    CountDownLatch latch = new CountDownLatch(threadCount);
    List<Exception> exceptions = Collections.synchronizedList(new ArrayList<>());
    
    ExecutorService executor = Executors.newFixedThreadPool(threadCount);
    
    for (int i = 0; i < threadCount; i++) {
        executor.submit(() -> {
            try {
                for (int j = 0; j < operationsPerThread; j++) {
                    // æ‰§è¡Œæ•°æ®åº“æ“ä½œ
                    Long userId = userDao.save(User.builder()
                        .name("æµ‹è¯•ç”¨æˆ·" + Thread.currentThread().getId() + "_" + j)
                        .email("test" + System.nanoTime() + "@example.com")
                        .build());
                    
                    User user = userDao.findById(userId);
                    assertThat(user).isNotNull();
                    
                    userDao.delete(userId);
                }
            } catch (Exception e) {
                exceptions.add(e);
            } finally {
                latch.countDown();
            }
        });
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    latch.await(30, TimeUnit.SECONDS);
    
    // éªŒè¯æ²¡æœ‰å¼‚å¸¸
    assertThat(exceptions).isEmpty();
    
    executor.shutdown();
}
```

---

## 4. âš¡ æ€§èƒ½æµ‹è¯•ç­–ç•¥


### 4.1 æ•°æ®åº“æ€§èƒ½æµ‹è¯•åŸºç¡€


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ€§èƒ½æµ‹è¯•**
```
æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æ•°æ®åº“åœ¨ç‰¹å®šæ¡ä»¶ä¸‹çš„æ€§èƒ½è¡¨ç°
å…³æ³¨æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€ååé‡ã€èµ„æºä½¿ç”¨ç‡ã€å¹¶å‘èƒ½åŠ›

å°±åƒæµ‹è¯•æ±½è½¦çš„æ€§èƒ½ï¼š
- 0-100å…¬é‡ŒåŠ é€Ÿæ—¶é—´ï¼ˆå“åº”æ—¶é—´ï¼‰
- æœ€é«˜æ—¶é€Ÿï¼ˆå³°å€¼ååé‡ï¼‰
- æ²¹è€—è¡¨ç°ï¼ˆèµ„æºä½¿ç”¨ç‡ï¼‰
- è½½å®¢èƒ½åŠ›ï¼ˆå¹¶å‘å¤„ç†èƒ½åŠ›ï¼‰
```

**ğŸ“Š æ€§èƒ½æµ‹è¯•å…³é”®æŒ‡æ ‡**
```
å“åº”æ—¶é—´ï¼ˆResponse Timeï¼‰ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´ï¼šæ‰€æœ‰è¯·æ±‚çš„å¹³å‡å¤„ç†æ—¶é—´
â€¢ 95%å“åº”æ—¶é—´ï¼š95%çš„è¯·æ±‚åœ¨æ­¤æ—¶é—´å†…å®Œæˆ
â€¢ æœ€å¤§å“åº”æ—¶é—´ï¼šæœ€æ…¢è¯·æ±‚çš„å¤„ç†æ—¶é—´

ååé‡ï¼ˆThroughputï¼‰ï¼š
â€¢ QPSï¼šæ¯ç§’å¤„ç†çš„æŸ¥è¯¢æ•°é‡
â€¢ TPSï¼šæ¯ç§’å¤„ç†çš„äº‹åŠ¡æ•°é‡

èµ„æºä½¿ç”¨ç‡ï¼š
â€¢ CPUä½¿ç”¨ç‡ï¼šæ•°æ®åº“æœåŠ¡å™¨çš„CPUå ç”¨
â€¢ å†…å­˜ä½¿ç”¨ç‡ï¼šæ•°æ®åº“ç¼“å­˜å’Œç¼“å†²åŒºä½¿ç”¨æƒ…å†µ
â€¢ IOä½¿ç”¨ç‡ï¼šç£ç›˜è¯»å†™çš„ç¹å¿™ç¨‹åº¦
```

### 4.2 å•SQLæ€§èƒ½æµ‹è¯•


**ğŸ”§ SQLæ€§èƒ½æµ‹è¯•å®ç°**
```java
public class SqlPerformanceTest {
    
    @Test
    void testQueryPerformance() {
        // æµ‹è¯•æŸ¥è¯¢è¯­å¥çš„æ€§èƒ½
        
        String sql = """
            SELECT u.*, d.name as department_name
            FROM users u
            LEFT JOIN departments d ON u.department_id = d.id
            WHERE u.age BETWEEN ? AND ?
            AND u.created_at >= ?
            ORDER BY u.created_at DESC
            LIMIT 100
            """;
        
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        prepareTestData(10000);  // åˆ›å»º1ä¸‡æ¡æµ‹è¯•æ•°æ®
        
        // é¢„çƒ­æ•°æ®åº“ï¼ˆè®©ç¼“å­˜ç”Ÿæ•ˆï¼‰
        for (int i = 0; i < 10; i++) {
            executeQuery(sql, 25, 35, LocalDateTime.now().minusDays(30));
        }
        
        // æ€§èƒ½æµ‹è¯•
        List<Long> executionTimes = new ArrayList<>();
        int testCount = 100;
        
        for (int i = 0; i < testCount; i++) {
            long startTime = System.nanoTime();
            
            List<Map<String, Object>> results = executeQuery(sql, 
                25, 35, LocalDateTime.now().minusDays(30));
            
            long endTime = System.nanoTime();
            long executionTime = (endTime - startTime) / 1_000_000;  // è½¬æ¢ä¸ºæ¯«ç§’
            
            executionTimes.add(executionTime);
            
            // éªŒè¯ç»“æœæ­£ç¡®æ€§
            assertThat(results).isNotEmpty();
            assertThat(results.size()).isLessThanOrEqualTo(100);
        }
        
        // åˆ†ææ€§èƒ½æŒ‡æ ‡
        double avgTime = executionTimes.stream()
            .mapToLong(Long::longValue)
            .average()
            .orElse(0.0);
        
        long maxTime = executionTimes.stream()
            .mapToLong(Long::longValue)
            .max()
            .orElse(0L);
        
        long percentile95 = executionTimes.stream()
            .sorted()
            .skip((int) (testCount * 0.95))
            .findFirst()
            .orElse(0L);
        
        // æ€§èƒ½æ–­è¨€
        assertThat(avgTime).isLessThan(100.0);  // å¹³å‡å“åº”æ—¶é—´å°äº100ms
        assertThat(percentile95).isLessThan(200L);  // 95%è¯·æ±‚å°äº200ms
        assertThat(maxTime).isLessThan(500L);  // æœ€å¤§å“åº”æ—¶é—´å°äº500ms
        
        System.out.printf("æ€§èƒ½æµ‹è¯•ç»“æœ:%nå¹³å‡æ—¶é—´: %.2fms%n95%%æ—¶é—´: %dms%næœ€å¤§æ—¶é—´: %dms%n",
            avgTime, percentile95, maxTime);
    }
}
```

### 4.3 æ‰¹é‡æ“ä½œæ€§èƒ½æµ‹è¯•


**ğŸ“ˆ æ‰¹é‡æ“ä½œä¼˜åŒ–æµ‹è¯•**
```java
@Test
void testBatchInsertPerformance() {
    // å¯¹æ¯”å•æ¡æ’å…¥å’Œæ‰¹é‡æ’å…¥çš„æ€§èƒ½å·®å¼‚
    
    int recordCount = 1000;
    List<User> testUsers = createTestUsers(recordCount);
    
    // æµ‹è¯•å•æ¡æ’å…¥æ€§èƒ½
    long singleInsertStart = System.currentTimeMillis();
    for (User user : testUsers) {
        userDao.save(user);
    }
    long singleInsertTime = System.currentTimeMillis() - singleInsertStart;
    
    // æ¸…ç†æ•°æ®
    userDao.deleteAll();
    
    // æµ‹è¯•æ‰¹é‡æ’å…¥æ€§èƒ½
    long batchInsertStart = System.currentTimeMillis();
    userDao.batchSave(testUsers);
    long batchInsertTime = System.currentTimeMillis() - batchInsertStart;
    
    // éªŒè¯æ•°æ®æ­£ç¡®æ€§
    assertThat(userDao.count()).isEqualTo(recordCount);
    
    // æ€§èƒ½å¯¹æ¯”åˆ†æ
    double performanceImprovement = (double) singleInsertTime / batchInsertTime;
    
    System.out.printf("æ€§èƒ½å¯¹æ¯”:%nå•æ¡æ’å…¥: %dms%næ‰¹é‡æ’å…¥: %dms%næ€§èƒ½æå‡: %.2fx%n",
        singleInsertTime, batchInsertTime, performanceImprovement);
    
    // æ‰¹é‡æ’å…¥åº”è¯¥æ˜æ˜¾æ›´å¿«
    assertThat(batchInsertTime).isLessThan(singleInsertTime / 2);
}
```

### 4.4 ç´¢å¼•æ€§èƒ½æµ‹è¯•


**ğŸ” ç´¢å¼•æ•ˆæœéªŒè¯æµ‹è¯•**
```java
@Test
void testIndexPerformance() {
    // æµ‹è¯•ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“
    
    // å‡†å¤‡å¤§é‡æµ‹è¯•æ•°æ®
    int dataSize = 100000;
    prepareTestData(dataSize);
    
    String queryWithoutIndex = "SELECT * FROM users WHERE email = ?";
    String testEmail = "test50000@example.com";
    
    // 1. æµ‹è¯•æ— ç´¢å¼•æƒ…å†µä¸‹çš„æŸ¥è¯¢æ€§èƒ½
    dropEmailIndex();  // åˆ é™¤emailå­—æ®µçš„ç´¢å¼•
    
    long noIndexTime = measureQueryTime(queryWithoutIndex, testEmail, 10);
    
    // 2. åˆ›å»ºç´¢å¼•
    createEmailIndex();  // åœ¨emailå­—æ®µä¸Šåˆ›å»ºç´¢å¼•
    
    // 3. æµ‹è¯•æœ‰ç´¢å¼•æƒ…å†µä¸‹çš„æŸ¥è¯¢æ€§èƒ½
    long withIndexTime = measureQueryTime(queryWithoutIndex, testEmail, 10);
    
    // 4. åˆ†ææ€§èƒ½æå‡
    double improvement = (double) noIndexTime / withIndexTime;
    
    System.out.printf("ç´¢å¼•æ€§èƒ½æµ‹è¯•:%næ— ç´¢å¼•æŸ¥è¯¢æ—¶é—´: %dms%næœ‰ç´¢å¼•æŸ¥è¯¢æ—¶é—´: %dms%næ€§èƒ½æå‡: %.2fx%n",
        noIndexTime, withIndexTime, improvement);
    
    // æœ‰ç´¢å¼•çš„æŸ¥è¯¢åº”è¯¥æ˜æ˜¾æ›´å¿«
    assertThat(improvement).isGreaterThan(5.0);  // è‡³å°‘5å€çš„æ€§èƒ½æå‡
}

private long measureQueryTime(String sql, Object param, int iterations) {
    List<Long> times = new ArrayList<>();
    
    for (int i = 0; i < iterations; i++) {
        long start = System.nanoTime();
        jdbcTemplate.queryForList(sql, param);
        long end = System.nanoTime();
        times.add((end - start) / 1_000_000);  // è½¬æ¢ä¸ºæ¯«ç§’
    }
    
    return times.stream().mapToLong(Long::longValue).sum() / iterations;
}
```

---

## 5. ğŸ’ª å‹åŠ›æµ‹è¯•è®¾è®¡


### 5.1 ä»€ä¹ˆæ˜¯å‹åŠ›æµ‹è¯•


**ğŸ”¸ å‹åŠ›æµ‹è¯•çš„æ¦‚å¿µ**
```
å‹åŠ›æµ‹è¯•ï¼šé€šè¿‡æŒç»­å¢åŠ è´Ÿè½½ï¼Œæ‰¾åˆ°ç³»ç»Ÿçš„æ€§èƒ½æé™
ç›®æ ‡ï¼šç¡®å®šç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—çš„æœ€å¤§è´Ÿè½½

å°±åƒæµ‹è¯•æ¡¥æ¢çš„æ‰¿é‡èƒ½åŠ›ï¼š
- é€æ¸å¢åŠ é‡é‡ï¼Œçœ‹æ¡¥æ¢ä»€ä¹ˆæ—¶å€™å¼€å§‹å˜å½¢
- æ‰¾åˆ°æ¡¥æ¢çš„æœ€å¤§å®‰å…¨æ‰¿é‡
- ç¡®å®šè¶…è½½æ—¶çš„è¡¨ç°ï¼ˆæ˜¯æ…¢æ…¢å¼¯æ›²è¿˜æ˜¯çªç„¶æ–­è£‚ï¼‰
```

**ğŸ“Š å‹åŠ›æµ‹è¯•å…³é”®æ¦‚å¿µ**
```
è´Ÿè½½æ¨¡å¼ï¼š
â€¢ æ’å®šè´Ÿè½½ï¼šå›ºå®šæ•°é‡çš„å¹¶å‘ç”¨æˆ·
â€¢ é€’å¢è´Ÿè½½ï¼šé€æ­¥å¢åŠ å¹¶å‘æ•°é‡
â€¢ çªå‘è´Ÿè½½ï¼šçŸ­æ—¶é—´å†…å¤§é‡è¯·æ±‚
â€¢ æ³¢åŠ¨è´Ÿè½½ï¼šè´Ÿè½½é‡å‘¨æœŸæ€§å˜åŒ–

å…³é”®æŒ‡æ ‡ï¼š
â€¢ æœ€å¤§å¹¶å‘æ•°ï¼šç³»ç»Ÿèƒ½åŒæ—¶å¤„ç†çš„æœ€å¤§ç”¨æˆ·æ•°
â€¢ å´©æºƒç‚¹ï¼šç³»ç»Ÿå¼€å§‹å‡ºç°é”™è¯¯çš„è´Ÿè½½ç‚¹
â€¢ æ¢å¤èƒ½åŠ›ï¼šè´Ÿè½½å‡å°‘åç³»ç»Ÿçš„æ¢å¤é€Ÿåº¦
```

### 5.2 å¹¶å‘è®¿é—®å‹åŠ›æµ‹è¯•


**ğŸš€ é«˜å¹¶å‘æµ‹è¯•å®ç°**
```java
public class DatabaseStressTest {
    
    @Test
    void testConcurrentUserOperations() throws InterruptedException {
        // æµ‹è¯•å¹¶å‘ç”¨æˆ·æ“ä½œçš„å‹åŠ›
        
        int maxConcurrentUsers = 100;
        int operationsPerUser = 20;
        CountDownLatch startLatch = new CountDownLatch(1);
        CountDownLatch endLatch = new CountDownLatch(maxConcurrentUsers);
        
        List<TestResult> results = Collections.synchronizedList(new ArrayList<>());
        ExecutorService executor = Executors.newFixedThreadPool(maxConcurrentUsers);
        
        // åˆ›å»ºå¹¶å‘ç”¨æˆ·
        for (int userId = 0; userId < maxConcurrentUsers; userId++) {
            final int currentUserId = userId;
            
            executor.submit(() -> {
                try {
                    // ç­‰å¾…ç»Ÿä¸€å¼€å§‹ä¿¡å·
                    startLatch.await();
                    
                    TestResult userResult = executeUserOperations(currentUserId, operationsPerUser);
                    results.add(userResult);
                    
                } catch (Exception e) {
                    results.add(TestResult.error(currentUserId, e));
                } finally {
                    endLatch.countDown();
                }
            });
        }
        
        // ç»Ÿä¸€å¼€å§‹æµ‹è¯•
        long testStartTime = System.currentTimeMillis();
        startLatch.countDown();
        
        // ç­‰å¾…æ‰€æœ‰ç”¨æˆ·å®Œæˆ
        boolean finished = endLatch.await(300, TimeUnit.SECONDS);  // 5åˆ†é’Ÿè¶…æ—¶
        long testEndTime = System.currentTimeMillis();
        
        assertThat(finished).isTrue();  // ç¡®ä¿æµ‹è¯•åœ¨è¶…æ—¶å‰å®Œæˆ
        
        // åˆ†ææµ‹è¯•ç»“æœ
        analyzeStressTestResults(results, testEndTime - testStartTime);
        
        executor.shutdown();
    }
    
    private TestResult executeUserOperations(int userId, int operationCount) {
        List<Long> operationTimes = new ArrayList<>();
        List<String> errors = new ArrayList<>();
        
        for (int i = 0; i < operationCount; i++) {
            try {
                long startTime = System.nanoTime();
                
                // æ‰§è¡Œæ··åˆæ“ä½œï¼šæŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤
                switch (i % 4) {
                    case 0:
                        // æŸ¥è¯¢æ“ä½œ
                        userDao.findByEmail("user" + userId + "@example.com");
                        break;
                    case 1:
                        // æ’å…¥æ“ä½œ
                        User newUser = User.builder()
                            .name("ç”¨æˆ·" + userId + "_" + i)
                            .email("user" + userId + "_" + i + "@example.com")
                            .build();
                        userDao.save(newUser);
                        break;
                    case 2:
                        // æ›´æ–°æ“ä½œ
                        userDao.updateEmailByName("æ–°é‚®ç®±" + i + "@example.com", 
                                                 "ç”¨æˆ·" + userId + "_" + (i-1));
                        break;
                    case 3:
                        // åˆ é™¤æ“ä½œ
                        userDao.deleteByEmail("user" + userId + "_" + (i-2) + "@example.com");
                        break;
                }
                
                long endTime = System.nanoTime();
                operationTimes.add((endTime - startTime) / 1_000_000);  // è½¬æ¢ä¸ºæ¯«ç§’
                
            } catch (Exception e) {
                errors.add("æ“ä½œ" + i + "å¤±è´¥: " + e.getMessage());
            }
        }
        
        return TestResult.success(userId, operationTimes, errors);
    }
    
    private void analyzeStressTestResults(List<TestResult> results, long totalTestTime) {
        // è®¡ç®—æˆåŠŸç‡
        long successfulUsers = results.stream()
            .filter(TestResult::isSuccessful)
            .count();
        
        double successRate = (double) successfulUsers / results.size() * 100;
        
        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        double avgResponseTime = results.stream()
            .filter(TestResult::isSuccessful)
            .flatMap(r -> r.getOperationTimes().stream())
            .mapToLong(Long::longValue)
            .average()
            .orElse(0.0);
        
        // è®¡ç®—æ€»æ“ä½œæ•°
        long totalOperations = results.stream()
            .filter(TestResult::isSuccessful)
            .mapToLong(r -> r.getOperationTimes().size())
            .sum();
        
        // è®¡ç®—QPS
        double qps = (double) totalOperations / (totalTestTime / 1000.0);
        
        System.out.printf("å‹åŠ›æµ‹è¯•ç»“æœ:%n" +
            "å¹¶å‘ç”¨æˆ·æ•°: %d%n" +
            "æˆåŠŸç‡: %.2f%%%n" +
            "å¹³å‡å“åº”æ—¶é—´: %.2fms%n" +
            "æ€»æ“ä½œæ•°: %d%n" +
            "QPS: %.2f%n" +
            "æµ‹è¯•æ—¶é•¿: %dç§’%n",
            results.size(), successRate, avgResponseTime, 
            totalOperations, qps, totalTestTime / 1000);
        
        // æ€§èƒ½æ–­è¨€
        assertThat(successRate).isGreaterThan(95.0);  // æˆåŠŸç‡åº”è¯¥å¤§äº95%
        assertThat(avgResponseTime).isLessThan(200.0);  // å¹³å‡å“åº”æ—¶é—´å°äº200ms
        assertThat(qps).isGreaterThan(100.0);  // QPSå¤§äº100
    }
}
```

### 5.3 é•¿æ—¶é—´è¿è¡Œå‹åŠ›æµ‹è¯•


**â° ç¨³å®šæ€§å‹åŠ›æµ‹è¯•**
```java
@Test
void testLongRunningStability() throws InterruptedException {
    // é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼Œæ£€æŸ¥å†…å­˜æ³„æ¼å’Œæ€§èƒ½é€€åŒ–
    
    int testDurationMinutes = 30;  // è¿è¡Œ30åˆ†é’Ÿ
    int concurrentUsers = 10;
    long testEndTime = System.currentTimeMillis() + (testDurationMinutes * 60 * 1000);
    
    List<PerformanceSnapshot> snapshots = Collections.synchronizedList(new ArrayList<>());
    CountDownLatch endLatch = new CountDownLatch(concurrentUsers + 1);  // +1 for monitor thread
    ExecutorService executor = Executors.newFixedThreadPool(concurrentUsers + 1);
    
    // å¯åŠ¨æ€§èƒ½ç›‘æ§çº¿ç¨‹
    executor.submit(() -> {
        try {
            while (System.currentTimeMillis() < testEndTime) {
                PerformanceSnapshot snapshot = capturePerformanceSnapshot();
                snapshots.add(snapshot);
                Thread.sleep(30000);  // æ¯30ç§’è®°å½•ä¸€æ¬¡
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            endLatch.countDown();
        }
    });
    
    // å¯åŠ¨å·¥ä½œçº¿ç¨‹
    for (int i = 0; i < concurrentUsers; i++) {
        final int userId = i;
        executor.submit(() -> {
            try {
                while (System.currentTimeMillis() < testEndTime) {
                    // æ‰§è¡Œå¸¸è§„æ•°æ®åº“æ“ä½œ
                    performRegularOperations(userId);
                    Thread.sleep(1000);  // æ¯ç§’ä¸€æ¬¡æ“ä½œ
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            } finally {
                endLatch.countDown();
            }
        });
    }
    
    // ç­‰å¾…æµ‹è¯•å®Œæˆ
    endLatch.await();
    
    // åˆ†æé•¿æœŸæ€§èƒ½è¶‹åŠ¿
    analyzeLongTermPerformance(snapshots);
    
    executor.shutdown();
}

private PerformanceSnapshot capturePerformanceSnapshot() {
    // æ•è·å½“å‰æ€§èƒ½å¿«ç…§
    
    // æµ‹è¯•åŸºæœ¬æ“ä½œçš„å“åº”æ—¶é—´
    long queryTime = measureOperationTime(() -> 
        userDao.findByEmail("test@example.com"));
    
    long insertTime = measureOperationTime(() -> 
        userDao.save(User.builder()
            .name("æ€§èƒ½æµ‹è¯•ç”¨æˆ·" + System.currentTimeMillis())
            .email("perf" + System.currentTimeMillis() + "@example.com")
            .build()));
    
    // è·å–ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼ˆç®€åŒ–ç‰ˆï¼‰
    Runtime runtime = Runtime.getRuntime();
    long usedMemory = runtime.totalMemory() - runtime.freeMemory();
    
    return PerformanceSnapshot.builder()
        .timestamp(System.currentTimeMillis())
        .queryResponseTime(queryTime)
        .insertResponseTime(insertTime)
        .memoryUsage(usedMemory)
        .activeConnections(getActiveConnectionCount())
        .build();
}
```

### 5.4 èµ„æºé™åˆ¶å‹åŠ›æµ‹è¯•


**ğŸ’¾ èµ„æºè€—å°½æµ‹è¯•**
```java
@Test
void testResourceExhaustionHandling() {
    // æµ‹è¯•èµ„æºè€—å°½æ—¶ç³»ç»Ÿçš„è¡¨ç°
    
    try {
        // é€æ¸å¢åŠ è¿æ¥æ•°ï¼Œç›´åˆ°è¾¾åˆ°è¿æ¥æ± ä¸Šé™
        List<Connection> connections = new ArrayList<>();
        
        for (int i = 0; i < 200; i++) {  // å‡è®¾è¿æ¥æ± ä¸Šé™æ˜¯100
            try {
                Connection conn = dataSource.getConnection();
                connections.add(conn);
                
                // æ¯è·å–10ä¸ªè¿æ¥ï¼Œæµ‹è¯•ä¸€ä¸‹ç³»ç»Ÿå“åº”
                if (i % 10 == 0) {
                    testBasicOperations();
                }
                
            } catch (SQLException e) {
                System.out.println("åœ¨ç¬¬" + i + "ä¸ªè¿æ¥æ—¶è¾¾åˆ°é™åˆ¶: " + e.getMessage());
                break;
            }
        }
        
        // æµ‹è¯•è¿æ¥è€—å°½æ—¶çš„é”™è¯¯å¤„ç†
        assertThatThrownBy(() -> userDao.findAll())
            .isInstanceOf(DataAccessResourceFailureException.class);
        
        // é‡Šæ”¾éƒ¨åˆ†è¿æ¥ï¼Œæµ‹è¯•ç³»ç»Ÿæ¢å¤
        for (int i = 0; i < connections.size() / 2; i++) {
            connections.get(i).close();
        }
        
        // ç³»ç»Ÿåº”è¯¥èƒ½å¤Ÿæ¢å¤æ­£å¸¸
        assertThatCode(() -> userDao.findAll()).doesNotThrowAnyException();
        
    } catch (Exception e) {
        fail("èµ„æºè€—å°½æµ‹è¯•å¤±è´¥: " + e.getMessage());
    }
}
```

---

## 6. ğŸ­ æ•°æ®åº“MockæŠ€æœ¯


### 6.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“Mock


**ğŸ”¸ MockæŠ€æœ¯çš„æ¦‚å¿µ**
```
Mockï¼ˆæ¨¡æ‹Ÿï¼‰ï¼šç”¨è™šæ‹Ÿçš„å¯¹è±¡ä»£æ›¿çœŸå®çš„æ•°æ®åº“
ç›®çš„ï¼šè®©æµ‹è¯•æ›´å¿«é€Ÿã€æ›´å¯æ§ã€æ›´ç¨³å®š

å°±åƒç”µå½±æ‹æ‘„ä¸­çš„é“å…·ï¼š
- ä¸ç”¨çœŸæªå®å¼¹ï¼Œç”¨ç©ºåŒ…å¼¹ï¼ˆä¸ä¼¤äººï¼Œæ›´å®‰å…¨ï¼‰
- ä¸ç”¨çœŸçˆ†ç‚¸ï¼Œç”¨ç‰¹æ•ˆï¼ˆå¯æ§åˆ¶ï¼Œå¯é‡å¤ï¼‰
- ä¸ç”¨çœŸçš„å¤å»ºç­‘ï¼Œç”¨æ­å»ºçš„åœºæ™¯ï¼ˆæˆæœ¬ä½ï¼Œæ•ˆæœå¥½ï¼‰
```

**ğŸ’¡ Mockçš„ä¼˜åŠ¿å’Œå±€é™**
```
ä¼˜åŠ¿ï¼š
â€¢ é€Ÿåº¦å¿«ï¼šä¸éœ€è¦çœŸå®çš„æ•°æ®åº“IOæ“ä½œ
â€¢ å¯æ§æ€§ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶è¿”å›çš„æ•°æ®
â€¢ éš”ç¦»æ€§ï¼šä¸ä¾èµ–å¤–éƒ¨æ•°æ®åº“ç¯å¢ƒ
â€¢ å¯é‡å¤ï¼šæ¯æ¬¡æµ‹è¯•ç»“æœä¸€è‡´

å±€é™ï¼š
â€¢ ä¸èƒ½æµ‹è¯•çœŸå®çš„SQLè¯­å¥
â€¢ ä¸èƒ½å‘ç°æ•°æ®åº“çº§åˆ«çš„é—®é¢˜
â€¢ éœ€è¦é¢å¤–ç¼–å†™Mockä»£ç 
â€¢ å¯èƒ½ä¸çœŸå®æ•°æ®åº“è¡Œä¸ºä¸ä¸€è‡´
```

### 6.2 åŸºäºMockitoçš„DAO Mock


**ğŸ”§ DAOå±‚Mockå®ç°**
```java
public class UserServiceMockTest {
    
    @Mock
    private UserDao userDao;
    
    @Mock
    private EmailService emailService;
    
    @InjectMocks
    private UserService userService;
    
    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }
    
    @Test
    void testCreateUserSuccess() {
        // å‡†å¤‡Mockæ•°æ®
        CreateUserRequest request = CreateUserRequest.builder()
            .name("å¼ ä¸‰")
            .email("zhangsan@example.com")
            .age(25)
            .build();
        
        User savedUser = User.builder()
            .id(1L)
            .name("å¼ ä¸‰")
            .email("zhangsan@example.com")
            .age(25)
            .status(UserStatus.ACTIVE)
            .createdAt(LocalDateTime.now())
            .build();
        
        // é…ç½®Mockè¡Œä¸º
        when(userDao.findByEmail("zhangsan@example.com"))
            .thenReturn(null);  // é‚®ç®±ä¸å­˜åœ¨
        
        when(userDao.save(any(User.class)))
            .thenReturn(savedUser);
        
        when(emailService.sendWelcomeEmail("zhangsan@example.com"))
            .thenReturn(true);
        
        // æ‰§è¡Œæµ‹è¯•
        UserResponse response = userService.createUser(request);
        
        // éªŒè¯ç»“æœ
        assertThat(response.getId()).isEqualTo(1L);
        assertThat(response.getName()).isEqualTo("å¼ ä¸‰");
        assertThat(response.getEmail()).isEqualTo("zhangsan@example.com");
        
        // éªŒè¯Mockè°ƒç”¨
        verify(userDao).findByEmail("zhangsan@example.com");
        verify(userDao).save(argThat(user -> 
            user.getName().equals("å¼ ä¸‰") && 
            user.getEmail().equals("zhangsan@example.com")
        ));
        verify(emailService).sendWelcomeEmail("zhangsan@example.com");
    }
    
    @Test
    void testCreateUserWithDuplicateEmail() {
        // æµ‹è¯•é‚®ç®±é‡å¤çš„åœºæ™¯
        
        CreateUserRequest request = CreateUserRequest.builder()
            .name("æå››")
            .email("existing@example.com")
            .build();
        
        User existingUser = User.builder()
            .id(999L)
            .name("å·²å­˜åœ¨ç”¨æˆ·")
            .email("existing@example.com")
            .build();
        
        // é…ç½®Mockï¼šé‚®ç®±å·²å­˜åœ¨
        when(userDao.findByEmail("existing@example.com"))
            .thenReturn(existingUser);
        
        // æ‰§è¡Œæµ‹è¯•ï¼Œåº”è¯¥æŠ›å‡ºå¼‚å¸¸
        assertThatThrownBy(() -> userService.createUser(request))
            .isInstanceOf(DuplicateEmailException.class)
            .hasMessage("é‚®ç®±already exists");
        
        // éªŒè¯ä¸ä¼šè°ƒç”¨saveæ–¹æ³•
        verify(userDao, never()).save(any(User.class));
        verify(emailService, never()).sendWelcomeEmail(anyString());
    }
}
```

### 6.3 å†…å­˜æ•°æ®åº“Mock


**ğŸ—„ï¸ H2å†…å­˜æ•°æ®åº“æµ‹è¯•**
```java
@TestConfiguration
public class TestDatabaseConfig {
    
    @Bean
    @Primary
    public DataSource testDataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .addScript("classpath:test-schema.sql")
            .addScript("classpath:test-data.sql")
            .build();
    }
}

@SpringBootTest
@Import(TestDatabaseConfig.class)
public class UserServiceWithH2Test {
    
    @Autowired
    private UserService userService;
    
    @Test
    void testUserOperationsWithRealDatabase() {
        // ä½¿ç”¨å†…å­˜æ•°æ®åº“è¿›è¡ŒçœŸå®çš„SQLæµ‹è¯•
        
        // 1. åˆ›å»ºç”¨æˆ·
        CreateUserRequest request = CreateUserRequest.builder()
            .name("å†…å­˜æµ‹è¯•ç”¨æˆ·")
            .email("h2test@example.com")
            .departmentId(1L)  // test-data.sqlä¸­çš„æµ‹è¯•éƒ¨é—¨
            .build();
        
        UserResponse created = userService.createUser(request);
        assertThat(created.getId()).isNotNull();
        
        // 2. æŸ¥è¯¢ç”¨æˆ·
        User found = userService.findById(created.getId());
        assertThat(found.getName()).isEqualTo("å†…å­˜æµ‹è¯•ç”¨æˆ·");
        
        // 3. æ›´æ–°ç”¨æˆ·
        UpdateUserRequest updateRequest = UpdateUserRequest.builder()
            .name("æ›´æ–°åçš„ç”¨æˆ·")
            .build();
        
        userService.updateUser(created.getId(), updateRequest);
        User updated = userService.findById(created.getId());
        assertThat(updated.getName()).isEqualTo("æ›´æ–°åçš„ç”¨æˆ·");
        
        // 4. åˆ é™¤ç”¨æˆ·
        userService.deleteUser(created.getId());
        assertThat(userService.existsById(created.getId())).isFalse();
    }
}
```

**ğŸ“ æµ‹è¯•SQLè„šæœ¬ç¤ºä¾‹**
```sql
-- test-schema.sql
CREATE TABLE departments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(200) UNIQUE NOT NULL,
    age INT,
    department_id BIGINT,
    status VARCHAR(20) DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL,
    
    FOREIGN KEY (department_id) REFERENCES departments(id)
);

-- test-data.sql
INSERT INTO departments (id, name, description) VALUES 
(1, 'ç ”å‘éƒ¨', 'æŠ€æœ¯å¼€å‘éƒ¨é—¨'),
(2, 'å¸‚åœºéƒ¨', 'å¸‚åœºæ¨å¹¿éƒ¨é—¨');

INSERT INTO users (id, name, email, age, department_id, status) VALUES
(1, 'æµ‹è¯•ç”¨æˆ·1', 'test1@example.com', 25, 1, 'ACTIVE'),
(2, 'æµ‹è¯•ç”¨æˆ·2', 'test2@example.com', 30, 2, 'ACTIVE');
```

### 6.4 å¤æ‚ä¸šåŠ¡é€»è¾‘Mock


**ğŸ¯ é«˜çº§Mockåœºæ™¯**
```java
@Test
void testComplexBusinessLogicWithMock() {
    // æµ‹è¯•å¤æ‚çš„ä¸šåŠ¡æµç¨‹
    
    Long userId = 1L;
    Long orderId = 100L;
    BigDecimal orderAmount = new BigDecimal("299.99");
    
    User user = User.builder()
        .id(userId)
        .name("VIPç”¨æˆ·")
        .email("vip@example.com")
        .vipLevel(VipLevel.GOLD)
        .balance(new BigDecimal("1000.00"))
        .build();
    
    Order order = Order.builder()
        .id(orderId)
        .userId(userId)
        .amount(orderAmount)
        .status(OrderStatus.PENDING)
        .build();
    
    // é…ç½®å¤æ‚çš„Mocké“¾
    when(userDao.findById(userId)).thenReturn(user);
    when(orderDao.findById(orderId)).thenReturn(order);
    
    // æ¨¡æ‹ŸVIPæŠ˜æ‰£è®¡ç®—
    when(discountService.calculateDiscount(user.getVipLevel(), orderAmount))
        .thenReturn(new BigDecimal("29.99"));  // 10%æŠ˜æ‰£
    
    // æ¨¡æ‹Ÿä½™é¢å……è¶³çš„åœºæ™¯
    when(userDao.updateBalance(eq(userId), any(BigDecimal.class)))
        .thenReturn(true);
    
    when(orderDao.updateStatus(orderId, OrderStatus.PAID))
        .thenReturn(true);
    
    // æ¨¡æ‹Ÿç§¯åˆ†ç³»ç»Ÿ
    when(pointService.addPoints(eq(userId), any(Integer.class)))
        .thenReturn(299);  // æ¶ˆè´¹299.99å¾—299ç§¯åˆ†
    
    // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
    PaymentResult result = orderService.payOrder(userId, orderId);
    
    // éªŒè¯ç»“æœ
    assertThat(result.isSuccess()).isTrue();
    assertThat(result.getFinalAmount()).isEqualTo(new BigDecimal("269.99"));
    assertThat(result.getDiscountAmount()).isEqualTo(new BigDecimal("29.99"));
    assertThat(result.getEarnedPoints()).isEqualTo(299);
    
    // éªŒè¯è°ƒç”¨é¡ºåºå’Œå‚æ•°
    InOrder inOrder = inOrder(userDao, discountService, orderDao, pointService);
    inOrder.verify(userDao).findById(userId);
    inOrder.verify(discountService).calculateDiscount(VipLevel.GOLD, orderAmount);
    inOrder.verify(userDao).updateBalance(userId, new BigDecimal("730.01"));  // 1000 - 269.99
    inOrder.verify(orderDao).updateStatus(orderId, OrderStatus.PAID);
    inOrder.verify(pointService).addPoints(userId, 299);
}
```

---

## 7. ğŸ“ æµ‹è¯•æ•°æ®ç®¡ç†


### 7.1 æµ‹è¯•æ•°æ®ç®¡ç†ç­–ç•¥


**ğŸ”¸ æµ‹è¯•æ•°æ®ç®¡ç†çš„é‡è¦æ€§**
```
æµ‹è¯•æ•°æ®é—®é¢˜ï¼š
â€¢ æ•°æ®ä¸ä¸€è‡´ï¼šæ¯æ¬¡æµ‹è¯•çš„æ•°æ®ç¯å¢ƒä¸åŒ
â€¢ æ•°æ®æ±¡æŸ“ï¼šæµ‹è¯•ä¹‹é—´ç›¸äº’å½±å“
â€¢ æ•°æ®ç»´æŠ¤ï¼šæ‰‹å·¥ç»´æŠ¤æµ‹è¯•æ•°æ®å·¥ä½œé‡å¤§
â€¢ æ•°æ®çœŸå®æ€§ï¼šæµ‹è¯•æ•°æ®ä¸ç”Ÿäº§æ•°æ®å·®å¼‚å¤§

ç®¡ç†åŸåˆ™ï¼š
â€¢ éš”ç¦»æ€§ï¼šæµ‹è¯•æ•°æ®äº’ä¸å½±å“
â€¢ å¯é‡å¤æ€§ï¼šæ¯æ¬¡æµ‹è¯•ä½¿ç”¨ç›¸åŒçš„åˆå§‹æ•°æ®
â€¢ è‡ªåŠ¨åŒ–ï¼šæ•°æ®å‡†å¤‡å’Œæ¸…ç†è‡ªåŠ¨åŒ–
â€¢ çœŸå®æ€§ï¼šæµ‹è¯•æ•°æ®å°½é‡æ¥è¿‘ç”Ÿäº§æ•°æ®
```

### 7.2 æµ‹è¯•æ•°æ®å‡†å¤‡ç­–ç•¥


**ğŸ› ï¸ æ•°æ®å·¥å‚æ¨¡å¼**
```java
public class TestDataFactory {
    
    private static final Random RANDOM = new Random();
    
    public static User createUser() {
        return User.builder()
            .name("æµ‹è¯•ç”¨æˆ·" + RANDOM.nextInt(10000))
            .email("test" + RANDOM.nextInt(10000) + "@example.com")
            .age(20 + RANDOM.nextInt(40))
            .status(UserStatus.ACTIVE)
            .createdAt(LocalDateTime.now())
            .build();
    }
    
    public static User createUserWithEmail(String email) {
        return User.builder()
            .name("ç”¨æˆ·_" + email.split("@")[0])
            .email(email)
            .age(25)
            .status(UserStatus.ACTIVE)
            .createdAt(LocalDateTime.now())
            .build();
    }
    
    public static List<User> createUsers(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> createUser())
            .collect(Collectors.toList());
    }
    
    public static Department createDepartment(String name) {
        return Department.builder()
            .name(name)
            .description(name + "çš„æè¿°ä¿¡æ¯")
            .createdAt(LocalDateTime.now())
            .build();
    }
    
    public static Order createOrder(Long userId, BigDecimal amount) {
        return Order.builder()
            .userId(userId)
            .orderNumber("ORD" + System.currentTimeMillis())
            .amount(amount)
            .status(OrderStatus.PENDING)
            .createdAt(LocalDateTime.now())
            .build();
    }
}

// ä½¿ç”¨æ•°æ®å·¥å‚
@Test
void testUserOperations() {
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    User user1 = TestDataFactory.createUser();
    User user2 = TestDataFactory.createUserWithEmail("specific@example.com");
    List<User> batchUsers = TestDataFactory.createUsers(10);
    
    // æ‰§è¡Œæµ‹è¯•
    userDao.save(user1);
    userDao.save(user2);
    userDao.batchSave(batchUsers);
    
    // éªŒè¯ç»“æœ
    assertThat(userDao.count()).isEqualTo(12);
}
```

### 7.3 æ•°æ®åº“çŠ¶æ€ç®¡ç†


**ğŸ”„ æµ‹è¯•äº‹åŠ¡å’Œæ•°æ®éš”ç¦»**
```java
@TestMethodOrder(OrderAnnotation.class)
public class UserServiceTransactionTest {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Test
    @Order(1)
    @Transactional
    @Rollback(false)  // ä¸å›æ»šï¼Œä¸ºåç»­æµ‹è¯•å‡†å¤‡æ•°æ®
    void prepareTestData() {
        // å‡†å¤‡åŸºç¡€æµ‹è¯•æ•°æ®
        Department dept = TestDataFactory.createDepartment("æµ‹è¯•éƒ¨é—¨");
        entityManager.persistAndFlush(dept);
        
        User user1 = TestDataFactory.createUserWithEmail("user1@test.com");
        user1.setDepartmentId(dept.getId());
        entityManager.persistAndFlush(user1);
        
        User user2 = TestDataFactory.createUserWithEmail("user2@test.com");
        user2.setDepartmentId(dept.getId());
        entityManager.persistAndFlush(user2);
    }
    
    @Test
    @Order(2)
    @Transactional
    @Rollback  // æµ‹è¯•åå›æ»š
    void testUserUpdate() {
        // æŸ¥æ‰¾é¢„è®¾çš„æµ‹è¯•ç”¨æˆ·
        User user = userService.findByEmail("user1@test.com");
        assertThat(user).isNotNull();
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        UpdateUserRequest request = UpdateUserRequest.builder()
            .name("æ›´æ–°åçš„å§“å")
            .build();
        
        userService.updateUser(user.getId(), request);
        
        // éªŒè¯æ›´æ–°ç»“æœ
        User updated = userService.findById(user.getId());
        assertThat(updated.getName()).isEqualTo("æ›´æ–°åçš„å§“å");
    }
    
    @Test
    @Order(3)
    @Transactional
    @Rollback
    void testUserDelete() {
        // ç”±äºä¸Šä¸ªæµ‹è¯•å›æ»šäº†ï¼Œç”¨æˆ·æ•°æ®åº”è¯¥è¿˜æ˜¯åŸæ ·
        User user = userService.findByEmail("user2@test.com");
        assertThat(user).isNotNull();
        
        userService.deleteUser(user.getId());
        
        assertThat(userService.existsById(user.getId())).isFalse();
    }
}
```

### 7.4 æµ‹è¯•æ•°æ®ç‰ˆæœ¬ç®¡ç†


**ğŸ“‹ æ•°æ®è„šæœ¬ç®¡ç†**
```java
@Component
public class TestDataManager {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public void loadTestDataSet(String dataSetName) {
        try {
            // æ¸…ç†ç°æœ‰æ•°æ®
            cleanupAllTables();
            
            // åŠ è½½æŒ‡å®šæ•°æ®é›†
            String scriptPath = "testdata/" + dataSetName + ".sql";
            Resource resource = new ClassPathResource(scriptPath);
            
            if (resource.exists()) {
                String script = new String(resource.getInputStream().readAllBytes());
                executeScript(script);
            }
            
        } catch (Exception e) {
            throw new RuntimeException("åŠ è½½æµ‹è¯•æ•°æ®å¤±è´¥: " + dataSetName, e);
        }
    }
    
    private void cleanupAllTables() {
        // æŒ‰ä¾èµ–å…³ç³»é¡ºåºæ¸…ç†è¡¨
        String[] tables = {"orders", "users", "departments"};
        
        // ç¦ç”¨å¤–é”®çº¦æŸ
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 0");
        
        for (String table : tables) {
            jdbcTemplate.execute("DELETE FROM " + table);
            jdbcTemplate.execute("ALTER TABLE " + table + " AUTO_INCREMENT = 1");
        }
        
        // æ¢å¤å¤–é”®çº¦æŸ
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 1");
    }
    
    private void executeScript(String script) {
        // æŒ‰åˆ†å·åˆ†å‰²SQLè¯­å¥å¹¶æ‰§è¡Œ
        String[] statements = script.split(";");
        
        for (String statement : statements) {
            String trimmed = statement.trim();
            if (!trimmed.isEmpty() && !trimmed.startsWith("--")) {
                jdbcTemplate.execute(trimmed);
            }
        }
    }
}

// æ•°æ®é›†ç¤ºä¾‹æ–‡ä»¶ï¼štestdata/basic-users.sql
-- åŸºç¡€ç”¨æˆ·æ•°æ®é›†
INSERT INTO departments (id, name, description) VALUES
(1, 'æŠ€æœ¯éƒ¨', 'è´Ÿè´£äº§å“æŠ€æœ¯å¼€å‘'),
(2, 'å¸‚åœºéƒ¨', 'è´Ÿè´£äº§å“æ¨å¹¿è¥é”€');

INSERT INTO users (id, name, email, age, department_id, status) VALUES
(1, 'å¼ ä¸‰', 'zhangsan@example.com', 25, 1, 'ACTIVE'),
(2, 'æå››', 'lisi@example.com', 30, 1, 'ACTIVE'),
(3, 'ç‹äº”', 'wangwu@example.com', 28, 2, 'ACTIVE'),
(4, 'èµµå…­', 'zhaoliu@example.com', 35, 2, 'INACTIVE');
```

**ğŸ§ª ä½¿ç”¨ä¸åŒæ•°æ®é›†çš„æµ‹è¯•**
```java
public class UserServiceDataSetTest {
    
    @Autowired
    private TestDataManager testDataManager;
    
    @Test
    void testWithBasicUserData() {
        // åŠ è½½åŸºç¡€ç”¨æˆ·æ•°æ®
        testDataManager.loadTestDataSet("basic-users");
        
        List<User> activeUsers = userService.findActiveUsers();
        assertThat(activeUsers).hasSize(3);
    }
    
    @Test
    void testWithLargeUserData() {
        // åŠ è½½å¤§é‡ç”¨æˆ·æ•°æ®
        testDataManager.loadTestDataSet("large-users");
        
        // æµ‹è¯•åˆ†é¡µåŠŸèƒ½
        PageRequest pageRequest = PageRequest.of(0, 10);
        Page<User> userPage = userService.findUsers(pageRequest);
        
        assertThat(userPage.getTotalElements()).isGreaterThan(1000);
        assertThat(userPage.getContent()).hasSize(10);
    }
    
    @Test
    void testWithEmptyData() {
        // æµ‹è¯•ç©ºæ•°æ®æƒ…å†µ
        testDataManager.loadTestDataSet("empty");
        
        List<User> users = userService.findAll();
        assertThat(users).isEmpty();
    }
}
```

---

## 8. ğŸ¤– æµ‹è¯•è‡ªåŠ¨åŒ–å®ç°


### 8.1 æµ‹è¯•è‡ªåŠ¨åŒ–æ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯æµ‹è¯•è‡ªåŠ¨åŒ–**
```
æµ‹è¯•è‡ªåŠ¨åŒ–ï¼šä½¿ç”¨å·¥å…·å’Œè„šæœ¬è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•ï¼Œæ— éœ€äººå·¥å¹²é¢„
ç›®æ ‡ï¼šæé«˜æµ‹è¯•æ•ˆç‡ã€å‡†ç¡®æ€§å’Œè¦†ç›–ç‡ï¼Œå‡å°‘é‡å¤åŠ³åŠ¨

å°±åƒå·¥å‚çš„è‡ªåŠ¨åŒ–ç”Ÿäº§çº¿ï¼š
- äººå·¥æ£€æŸ¥ï¼šä¸€ä¸ªä¸ªäº§å“æ‰‹å·¥æ£€éªŒï¼ˆæ…¢ã€æ˜“å‡ºé”™ã€æˆæœ¬é«˜ï¼‰
- è‡ªåŠ¨æ£€æŸ¥ï¼šæœºå™¨æ‰¹é‡æ£€éªŒï¼ˆå¿«ã€å‡†ç¡®ã€æˆæœ¬ä½ï¼‰
- æŒç»­æ£€æŸ¥ï¼šç”Ÿäº§è¿‡ç¨‹ä¸­å®æ—¶æ£€éªŒï¼ˆåŠæ—¶å‘ç°é—®é¢˜ï¼‰
```

**ğŸ“Š æ•°æ®åº“æµ‹è¯•è‡ªåŠ¨åŒ–æ¶æ„**
```
ä»£ç æäº¤ â†’ è§¦å‘CI/CD â†’ è‡ªåŠ¨æ„å»º â†’ è¿è¡Œæµ‹è¯•å¥—ä»¶ â†’ ç”ŸæˆæŠ¥å‘Š
    â†“             â†“           â†“          â†“           â†“
Git Push     Jenkins    Maven Build   JUnit Tests   HTML Report
             GitHub     Docker        TestNG        Email Alert
             GitLab     Gradle        Pytest        Slacké€šçŸ¥
```

### 8.2 CI/CDé›†æˆæµ‹è¯•


**ğŸ”§ Jenkinsè‡ªåŠ¨åŒ–é…ç½®**
```groovy
// Jenkinsfile - æ•°æ®åº“æµ‹è¯•æµæ°´çº¿
pipeline {
    agent any
    
    environment {
        MYSQL_ROOT_PASSWORD = credentials('mysql-root-password')
        TEST_DATABASE_URL = 'jdbc:mysql://localhost:3306/test_db'
    }
    
    stages {
        stage('å‡†å¤‡ç¯å¢ƒ') {
            steps {
                script {
                    // å¯åŠ¨æµ‹è¯•æ•°æ®åº“å®¹å™¨
                    sh '''
                        docker run -d --name test-mysql \
                        -e MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD} \
                        -e MYSQL_DATABASE=test_db \
                        -p 3306:3306 \
                        mysql:8.0
                    '''
                    
                    // ç­‰å¾…æ•°æ®åº“å¯åŠ¨
                    sh 'sleep 30'
                }
            }
        }
        
        stage('æ•°æ®åº“åˆå§‹åŒ–') {
            steps {
                script {
                    // æ‰§è¡Œæ•°æ®åº“schemaåˆ›å»º
                    sh '''
                        mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} test_db < src/main/resources/schema.sql
                        mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} test_db < src/test/resources/test-data.sql
                    '''
                }
            }
        }
        
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                sh './gradlew test --tests "*UnitTest"'
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•ç»“æœ
                    publishTestResults testResultsPattern: 'build/test-results/test/*.xml'
                }
            }
        }
        
        stage('é›†æˆæµ‹è¯•') {
            steps {
                sh './gradlew test --tests "*IntegrationTest"'
            }
        }
        
        stage('æ€§èƒ½æµ‹è¯•') {
            steps {
                script {
                    // è¿è¡Œæ€§èƒ½æµ‹è¯•
                    sh './gradlew test --tests "*PerformanceTest"'
                    
                    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
                    sh 'python scripts/generate_performance_report.py'
                }
            }
            post {
                always {
                    // å­˜æ¡£æ€§èƒ½æŠ¥å‘Š
                    archiveArtifacts artifacts: 'reports/performance/*.html', fingerprint: true
                }
            }
        }
        
        stage('æ•°æ®åº“è¿ç§»æµ‹è¯•') {
            steps {
                script {
                    // æµ‹è¯•æ•°æ®åº“ç‰ˆæœ¬å‡çº§
                    sh '''
                        # æ¨¡æ‹Ÿä»æ—§ç‰ˆæœ¬å‡çº§
                        mysql -h localhost -u root -p${MYSQL_ROOT_PASSWORD} test_db < migrations/v1.0.sql
                        ./gradlew flywayMigrate
                        ./gradlew test --tests "*MigrationTest"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
                sh 'docker stop test-mysql && docker rm test-mysql'
                
                // ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'build/reports/tests/test',
                    reportFiles: 'index.html',
                    reportName: 'æ•°æ®åº“æµ‹è¯•æŠ¥å‘Š'
                ])
            }
        }
        
        success {
            // æˆåŠŸæ—¶å‘é€é€šçŸ¥
            slackSend(
                channel: '#dev-team',
                color: 'good',
                message: "æ•°æ®åº“æµ‹è¯•é€šè¿‡ âœ… - ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
        
        failure {
            // å¤±è´¥æ—¶å‘é€å‘Šè­¦
            emailext(
                to: '${DEFAULT_RECIPIENTS}',
                subject: "æ•°æ®åº“æµ‹è¯•å¤±è´¥ - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: '''
                    æ•°æ®åº“æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
                    
                    æ„å»ºæ—¥å¿—: ${BUILD_URL}console
                    æµ‹è¯•æŠ¥å‘Š: ${BUILD_URL}testReport
                    
                    è¯·åŠæ—¶å¤„ç†ï¼
                '''
            )
        }
    }
}
```

### 8.3 DockeråŒ–æµ‹è¯•ç¯å¢ƒ


**ğŸ³ å®¹å™¨åŒ–æµ‹è¯•é…ç½®**
```yaml
# docker-compose.test.yml
version: '3.8'

services:
  test-database:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: testpass123
      MYSQL_DATABASE: test_db
      MYSQL_USER: testuser
      MYSQL_PASSWORD: testpass
    ports:
      - "3306:3306"
    volumes:
      - ./src/test/resources/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  test-redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  test-app:
    build: .
    depends_on:
      test-database:
        condition: service_healthy
      test-redis:
        condition: service_started
    environment:
      SPRING_PROFILES_ACTIVE: test
      DATABASE_URL: jdbc:mysql://test-database:3306/test_db
      REDIS_URL: redis://test-redis:6379
    volumes:
      - ./build/test-results:/app/test-results
    command: ["./gradlew", "test"]
```

**ğŸš€ è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬**
```bash
#!/bin/bash
# run-database-tests.sh

set -e

echo "ğŸš€ å¼€å§‹æ•°æ®åº“æµ‹è¯•è‡ªåŠ¨åŒ–æµç¨‹"

# æ¸…ç†ä¹‹å‰çš„ç¯å¢ƒ
echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
docker-compose -f docker-compose.test.yml down -v

# æ„å»ºæµ‹è¯•é•œåƒ
echo "ğŸ”¨ æ„å»ºæµ‹è¯•é•œåƒ"
docker build -t app-test .

# å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
echo "ğŸƒ å¯åŠ¨æµ‹è¯•ç¯å¢ƒ"
docker-compose -f docker-compose.test.yml up -d test-database test-redis

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª"
while ! docker-compose -f docker-compose.test.yml exec -T test-database mysqladmin ping -h localhost --silent; do
    echo "ç­‰å¾…MySQLå¯åŠ¨..."
    sleep 2
done

# è¿è¡Œæµ‹è¯•å¥—ä»¶
echo "ğŸ§ª æ‰§è¡Œæµ‹è¯•å¥—ä»¶"

# 1. å•å…ƒæµ‹è¯•
echo "  â†’ å•å…ƒæµ‹è¯•"
docker-compose -f docker-compose.test.yml run --rm test-app ./gradlew test --tests "*UnitTest"

# 2. é›†æˆæµ‹è¯•
echo "  â†’ é›†æˆæµ‹è¯•"  
docker-compose -f docker-compose.test.yml run --rm test-app ./gradlew test --tests "*IntegrationTest"

# 3. æ€§èƒ½æµ‹è¯•
echo "  â†’ æ€§èƒ½æµ‹è¯•"
docker-compose -f docker-compose.test.yml run --rm test-app ./gradlew test --tests "*PerformanceTest"

# 4. æ•°æ®åº“è¿ç§»æµ‹è¯•
echo "  â†’ è¿ç§»æµ‹è¯•"
docker-compose -f docker-compose.test.yml run --rm test-app ./gradlew test --tests "*MigrationTest"

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š"
docker-compose -f docker-compose.test.yml run --rm test-app python scripts/generate_report.py

# æ¸…ç†ç¯å¢ƒ
echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
docker-compose -f docker-compose.test.yml down -v

echo "âœ… æ•°æ®åº“æµ‹è¯•å®Œæˆ"
```

### 8.4 æµ‹è¯•æ•°æ®è‡ªåŠ¨åŒ–ç®¡ç†


**ğŸ“‹ è‡ªåŠ¨åŒ–æ•°æ®ç®¡ç†å·¥å…·**
```java
@Component
public class AutomatedTestDataManager {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @EventListener
    public void onTestMethodStart(TestMethodStartEvent event) {
        String testClassName = event.getTestClass().getSimpleName();
        String testMethodName = event.getTestMethod().getName();
        
        // æ ¹æ®æµ‹è¯•æ–¹æ³•åè‡ªåŠ¨é€‰æ‹©æ•°æ®é›†
        String dataSet = determineDataSet(testClassName, testMethodName);
        if (dataSet != null) {
            loadTestDataSet(dataSet);
        }
    }
    
    @EventListener  
    public void onTestMethodEnd(TestMethodEndEvent event) {
        // æµ‹è¯•ç»“æŸåè‡ªåŠ¨æ¸…ç†æ•°æ®
        if (shouldCleanupAfterTest(event)) {
            cleanupTestData();
        }
    }
    
    private String determineDataSet(String testClass, String testMethod) {
        // åŸºäºå‘½åçº¦å®šè‡ªåŠ¨é€‰æ‹©æ•°æ®é›†
        if (testMethod.contains("EmptyData")) {
            return "empty-dataset";
        } else if (testMethod.contains("LargeData")) {
            return "large-dataset";
        } else if (testClass.contains("User")) {
            return "basic-users";
        } else if (testClass.contains("Order")) {
            return "orders-with-users";
        }
        return "default-dataset";
    }
    
    public void loadTestDataSet(String dataSetName) {
        try {
            // æ¸…ç†ç°æœ‰æ•°æ®
            executeScript("cleanup-all-tables.sql");
            
            // åŠ è½½æ•°æ®é›†
            executeScript("datasets/" + dataSetName + ".sql");
            
            // è®°å½•æ•°æ®åŠ è½½æ—¥å¿—
            log.info("å·²åŠ è½½æµ‹è¯•æ•°æ®é›†: {}", dataSetName);
            
        } catch (Exception e) {
            throw new TestDataException("åŠ è½½æ•°æ®é›†å¤±è´¥: " + dataSetName, e);
        }
    }
    
    @Async
    public CompletableFuture<Void> prepareDataAsync(String dataSet) {
        return CompletableFuture.runAsync(() -> {
            loadTestDataSet(dataSet);
        });
    }
}

// æµ‹è¯•åŸºç±»ï¼Œè‡ªåŠ¨å¤„ç†æ•°æ®ç®¡ç†
@TestExecutionListeners({
    DependencyInjectionTestExecutionListener.class,
    TransactionTestExecutionListener.class,
    AutomatedTestDataListener.class  // è‡ªå®šä¹‰ç›‘å¬å™¨
})
public abstract class BaseDataTest {
    
    @Autowired
    protected AutomatedTestDataManager dataManager;
    
    // å­ç±»å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æŒ‡å®šæ•°æ®é›†
    protected String getRequiredDataSet() {
        return null;  // é»˜è®¤ä½¿ç”¨è‡ªåŠ¨æ£€æµ‹
    }
    
    // å­ç±»å¯ä»¥è¦†ç›–æ­¤æ–¹æ³•æ§åˆ¶æ¸…ç†è¡Œä¸º
    protected boolean shouldCleanupAfterTest() {
        return true;  // é»˜è®¤æµ‹è¯•åæ¸…ç†
    }
}
```

### 8.5 æµ‹è¯•æŠ¥å‘Šè‡ªåŠ¨åŒ–


**ğŸ“ˆ è‡ªåŠ¨åŒ–æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ**
```java
@Component
public class AutomatedTestReporter {
    
    public void generateTestReport(TestExecutionSummary summary) {
        // ç”ŸæˆHTMLæµ‹è¯•æŠ¥å‘Š
        TestReport report = TestReport.builder()
            .timestamp(LocalDateTime.now())
            .totalTests(summary.getTestsSucceededCount() + summary.getTestsFailedCount())
            .successfulTests(summary.getTestsSucceededCount())
            .failedTests(summary.getTestsFailedCount())
            .executionTime(summary.getTotalTime())
            .testDetails(collectTestDetails(summary))
            .performanceMetrics(collectPerformanceMetrics())
            .coverageReport(generateCoverageReport())
            .build();
        
        // ç”Ÿæˆå¤šç§æ ¼å¼æŠ¥å‘Š
        generateHtmlReport(report);
        generateJsonReport(report);
        generateSlackReport(report);
        
        // å‘é€é‚®ä»¶æŠ¥å‘Š
        if (hasFailures(report)) {
            sendFailureNotification(report);
        }
    }
    
    private void generateHtmlReport(TestReport report) {
        String template = """
            <!DOCTYPE html>
            <html>
            <head>
                <title>æ•°æ®åº“æµ‹è¯•æŠ¥å‘Š</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .summary { background: #f5f5f5; padding: 15px; border-radius: 5px; }
                    .success { color: #28a745; }
                    .failure { color: #dc3545; }
                    .metrics table { border-collapse: collapse; width: 100%; }
                    .metrics th, .metrics td { border: 1px solid #ddd; padding: 8px; }
                </style>
            </head>
            <body>
                <h1>æ•°æ®åº“æµ‹è¯•æŠ¥å‘Š</h1>
                
                <div class="summary">
                    <h2>æµ‹è¯•æ¦‚è¦</h2>
                    <p>æµ‹è¯•æ—¶é—´: {{timestamp}}</p>
                    <p>æ€»æµ‹è¯•æ•°: {{totalTests}}</p>
                    <p class="success">æˆåŠŸ: {{successfulTests}}</p>
                    <p class="failure">å¤±è´¥: {{failedTests}}</p>
                    <p>æ‰§è¡Œæ—¶é—´: {{executionTime}}</p>
                    <p>æˆåŠŸç‡: {{successRate}}%</p>
                </div>
                
                <div class="metrics">
                    <h2>æ€§èƒ½æŒ‡æ ‡</h2>
                    <table>
                        <tr><th>æŒ‡æ ‡</th><th>å€¼</th><th>çŠ¶æ€</th></tr>
                        <tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>{{avgResponseTime}}ms</td><td>{{responseTimeStatus}}</td></tr>
                        <tr><td>QPS</td><td>{{qps}}</td><td>{{qpsStatus}}</td></tr>
                        <tr><td>æ•°æ®åº“è¿æ¥æ•°</td><td>{{connectionCount}}</td><td>{{connectionStatus}}</td></tr>
                    </table>
                </div>
                
                <div class="details">
                    <h2>æµ‹è¯•è¯¦æƒ…</h2>
                    {{testDetails}}
                </div>
            </body>
            </html>
            """;
        
        String html = replaceTemplateVariables(template, report);
        writeReportFile("test-report.html", html);
    }
    
    private void sendSlackReport(TestReport report) {
        String message = String.format("""
            ğŸ“Š æ•°æ®åº“æµ‹è¯•æŠ¥å‘Š
            
            âœ… æˆåŠŸ: %d
            âŒ å¤±è´¥: %d  
            ğŸ•’ æ‰§è¡Œæ—¶é—´: %s
            ğŸ“ˆ æˆåŠŸç‡: %.1f%%
            
            %s
            """,
            report.getSuccessfulTests(),
            report.getFailedTests(),
            formatDuration(report.getExecutionTime()),
            report.getSuccessRate(),
            report.getFailedTests() > 0 ? "âš ï¸ æœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Š" : "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡"
        );
        
        slackService.sendMessage("#dev-team", message);
    }
}
```

### 8.6 æŒç»­ç›‘æ§å’Œå‘Šè­¦


**ğŸ”” è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿ**
```java
@Component
@Scheduled(fixedRate = 300000)  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
public class DatabaseHealthMonitor {
    
    @Autowired
    private DataSource dataSource;
    
    @Autowired
    private AlertService alertService;
    
    @Scheduled(fixedRate = 300000)
    public void monitorDatabaseHealth() {
        HealthCheckResult result = performHealthCheck();
        
        if (!result.isHealthy()) {
            alertService.sendCriticalAlert(
                "æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥",
                result.getErrorDetails()
            );
        }
        
        // è®°å½•ç›‘æ§æŒ‡æ ‡
        recordMetrics(result);
    }
    
    private HealthCheckResult performHealthCheck() {
        HealthCheckResult.Builder builder = HealthCheckResult.builder();
        
        try {
            // 1. è¿æ¥æµ‹è¯•
            long connectTime = measureConnectionTime();
            builder.connectionTime(connectTime);
            
            if (connectTime > 5000) {  // 5ç§’è¶…æ—¶
                builder.addError("æ•°æ®åº“è¿æ¥æ—¶é—´è¿‡é•¿: " + connectTime + "ms");
            }
            
            // 2. æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
            long queryTime = measureSimpleQueryTime();
            builder.queryTime(queryTime);
            
            if (queryTime > 1000) {  // 1ç§’è¶…æ—¶
                builder.addError("æŸ¥è¯¢å“åº”æ—¶é—´è¿‡é•¿: " + queryTime + "ms");
            }
            
            // 3. è¿æ¥æ± çŠ¶æ€æ£€æŸ¥
            if (dataSource instanceof HikariDataSource) {
                HikariDataSource hikari = (HikariDataSource) dataSource;
                HikariPoolMXBean pool = hikari.getHikariPoolMXBean();
                
                int activeConnections = pool.getActiveConnections();
                int totalConnections = pool.getTotalConnections();
                
                builder.activeConnections(activeConnections);
                builder.totalConnections(totalConnections);
                
                // è¿æ¥æ± ä½¿ç”¨ç‡æ£€æŸ¥
                double usage = (double) activeConnections / totalConnections;
                if (usage > 0.8) {  // 80%ä½¿ç”¨ç‡å‘Šè­¦
                    builder.addWarning("è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: " + String.format("%.1f%%", usage * 100));
                }
            }
            
            // 4. ç£ç›˜ç©ºé—´æ£€æŸ¥
            checkDiskSpace(builder);
            
            // 5. æ…¢æŸ¥è¯¢æ£€æŸ¥
            checkSlowQueries(builder);
            
        } catch (Exception e) {
            builder.addError("å¥åº·æ£€æŸ¥æ‰§è¡Œå¼‚å¸¸: " + e.getMessage());
        }
        
        return builder.build();
    }
    
    @EventListener
    public void handleTestFailure(TestFailureEvent event) {
        // æµ‹è¯•å¤±è´¥æ—¶è‡ªåŠ¨è§¦å‘è¯¦ç»†è¯Šæ–­
        
        DiagnosticReport diagnostic = performDetailedDiagnostic();
        
        String report = String.format("""
            ğŸš¨ æ•°æ®åº“æµ‹è¯•å¤±è´¥è‡ªåŠ¨è¯Šæ–­æŠ¥å‘Š
            
            å¤±è´¥æµ‹è¯•: %s
            å¤±è´¥åŸå› : %s
            
            ç³»ç»Ÿè¯Šæ–­:
            - æ•°æ®åº“è¿æ¥: %s
            - æŸ¥è¯¢æ€§èƒ½: %s  
            - è¿æ¥æ± çŠ¶æ€: %s
            - ç£ç›˜ç©ºé—´: %s
            
            å»ºè®®æ“ä½œ:
            %s
            """,
            event.getTestName(),
            event.getFailureReason(),
            diagnostic.getConnectionStatus(),
            diagnostic.getPerformanceStatus(),
            diagnostic.getPoolStatus(),
            diagnostic.getDiskStatus(),
            diagnostic.getRecommendations()
        );
        
        alertService.sendDetailedAlert("æ•°æ®åº“æµ‹è¯•å¤±è´¥è¯Šæ–­", report);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æµ‹è¯•åˆ†å±‚ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç³»ç»Ÿæµ‹è¯•å„æœ‰ä¾§é‡
ğŸ”¸ æ€§èƒ½æµ‹è¯•ï¼šå…³æ³¨å“åº”æ—¶é—´ã€ååé‡ã€èµ„æºä½¿ç”¨ç‡
ğŸ”¸ å‹åŠ›æµ‹è¯•ï¼šæ‰¾åˆ°ç³»ç»Ÿæé™ï¼ŒéªŒè¯ç¨³å®šæ€§å’Œæ¢å¤èƒ½åŠ›
ğŸ”¸ MockæŠ€æœ¯ï¼šç”¨è™šæ‹Ÿå¯¹è±¡æ›¿ä»£çœŸå®ä¾èµ–ï¼Œæé«˜æµ‹è¯•æ•ˆç‡
ğŸ”¸ æ•°æ®ç®¡ç†ï¼šæµ‹è¯•æ•°æ®çš„å‡†å¤‡ã€éš”ç¦»ã€æ¸…ç†å’Œç‰ˆæœ¬ç®¡ç†
ğŸ”¸ è‡ªåŠ¨åŒ–ï¼šCI/CDé›†æˆï¼Œè‡ªåŠ¨æ‰§è¡Œæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šæŒç»­ç›‘æ§æ•°æ®åº“å¥åº·çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
```

### 9.2 æµ‹è¯•ç­–ç•¥é€‰æ‹©æŒ‡å—


**ğŸ“Š ä¸åŒæµ‹è¯•æ–¹æ³•çš„é€‚ç”¨åœºæ™¯**

| æµ‹è¯•ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **æ¨èå·¥å…·** |
|----------|-------------|---------|---------|-------------|
| **å•å…ƒæµ‹è¯•** | `å•ä¸ªSQLã€å­˜å‚¨è¿‡ç¨‹` | å¿«é€Ÿã€éš”ç¦»ã€ç²¾ç¡® | è¦†ç›–é¢çª„ | JUnit + Mockito |
| **é›†æˆæµ‹è¯•** | `æ¨¡å—é—´äº¤äº’` | çœŸå®ç¯å¢ƒã€ç«¯åˆ°ç«¯ | æ‰§è¡Œæ…¢ã€ä¾èµ–å¤š | Spring Test |
| **æ€§èƒ½æµ‹è¯•** | `å“åº”æ—¶é—´è¦æ±‚` | é‡åŒ–æ€§èƒ½æŒ‡æ ‡ | ç¯å¢ƒä¾èµ–å¤§ | JMeter + è‡ªå®šä¹‰ |
| **å‹åŠ›æµ‹è¯•** | `å®¹é‡è§„åˆ’` | æ‰¾åˆ°ç³»ç»Ÿæé™ | èµ„æºæ¶ˆè€—å¤§ | å¤šçº¿ç¨‹ + ç›‘æ§ |
| **Mockæµ‹è¯•** | `å¤–éƒ¨ä¾èµ–éš”ç¦»` | å¿«é€Ÿã€å¯æ§ | ä¸å¤ŸçœŸå® | Mockito + H2 |

### 9.3 æµ‹è¯•æ•°æ®ç®¡ç†æœ€ä½³å®è·µ


**ğŸ¯ æ•°æ®ç®¡ç†ç­–ç•¥**
```
æ•°æ®éš”ç¦»åŸåˆ™ï¼š
â€¢ æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®é›†
â€¢ æµ‹è¯•ä¹‹é—´ä¸å…±äº«å¯å˜æ•°æ®
â€¢ ä½¿ç”¨äº‹åŠ¡å›æ»šç¡®ä¿æ•°æ®æ¸…æ´

æ•°æ®çœŸå®æ€§ï¼š
â€¢ æµ‹è¯•æ•°æ®å°½é‡æ¥è¿‘ç”Ÿäº§æ•°æ®
â€¢ åŒ…å«è¾¹ç•Œå€¼å’Œå¼‚å¸¸æƒ…å†µ
â€¢ å®šæœŸæ›´æ–°æµ‹è¯•æ•°æ®é›†

è‡ªåŠ¨åŒ–ç®¡ç†ï¼š
â€¢ ä½¿ç”¨æ•°æ®å·¥å‚æ¨¡å¼ç”Ÿæˆæµ‹è¯•æ•°æ®
â€¢ è„šæœ¬åŒ–æ•°æ®å‡†å¤‡å’Œæ¸…ç†è¿‡ç¨‹
â€¢ ç‰ˆæœ¬åŒ–ç®¡ç†æµ‹è¯•æ•°æ®é›†
```

**ğŸ’¡ æµ‹è¯•ç¯å¢ƒé…ç½®è¦ç‚¹**
```java
// æ¨èçš„æµ‹è¯•é…ç½®ç»“æ„
@TestConfiguration
public class DatabaseTestConfig {
    
    @Bean
    @Primary
    @Profile("test")
    public DataSource testDataSource() {
        // ä½¿ç”¨å†…å­˜æ•°æ®åº“æˆ–ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .setName("testdb")
            .addScript("classpath:schema.sql")
            .build();
    }
    
    @Bean
    @Profile("test")
    public TestDataManager testDataManager() {
        return new TestDataManager();
    }
}
```

### 9.4 è‡ªåŠ¨åŒ–æµ‹è¯•å®æ–½è·¯å¾„


**ğŸ“ˆ è‡ªåŠ¨åŒ–æˆç†Ÿåº¦æ¨¡å‹**
```
Level 1 - æ‰‹å·¥æµ‹è¯•ï¼š
â€¢ äººå·¥æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
â€¢ æ‰‹å·¥éªŒè¯ç»“æœ
â€¢ é€‚åˆæ¢ç´¢æ€§æµ‹è¯•

Level 2 - è„šæœ¬åŒ–æµ‹è¯•ï¼š
â€¢ ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
â€¢ æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ
â€¢ è‡ªåŠ¨ç»“æœéªŒè¯

Level 3 - æŒç»­é›†æˆï¼š
â€¢ CI/CDç®¡é“é›†æˆ
â€¢ ä»£ç æäº¤è‡ªåŠ¨è§¦å‘
â€¢ è‡ªåŠ¨æŠ¥å‘Šç”Ÿæˆ

Level 4 - æ™ºèƒ½åŒ–æµ‹è¯•ï¼š
â€¢ åŸºäºAIçš„æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ
â€¢ è‡ªé€‚åº”æµ‹è¯•æ‰§è¡Œ
â€¢ é¢„æµ‹æ€§æ•…éšœåˆ†æ
```

**ğŸ”„ å®æ–½æ­¥éª¤å»ºè®®**
```
ç¬¬1å‘¨ï¼šæ­å»ºåŸºç¡€æ¡†æ¶
â€¢ é…ç½®æµ‹è¯•æ•°æ®æº
â€¢ ç¼–å†™ç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•
â€¢ è®¾ç½®åŸºæœ¬çš„CIæµæ°´çº¿

ç¬¬2-3å‘¨ï¼šæ‰©å±•æµ‹è¯•è¦†ç›–
â€¢ å¢åŠ é›†æˆæµ‹è¯•
â€¢ å®ç°æ€§èƒ½åŸºå‡†æµ‹è¯•
â€¢ é…ç½®æµ‹è¯•æ•°æ®ç®¡ç†

ç¬¬4-6å‘¨ï¼šå®Œå–„è‡ªåŠ¨åŒ–
â€¢ é›†æˆDockerå®¹å™¨åŒ–
â€¢ å®ç°æµ‹è¯•æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆ
â€¢ é…ç½®ç›‘æ§å’Œå‘Šè­¦

æŒç»­æ”¹è¿›ï¼š
â€¢ å®šæœŸreviewæµ‹è¯•è¦†ç›–ç‡
â€¢ ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œæ•ˆç‡
â€¢ æ›´æ–°æµ‹è¯•ç­–ç•¥å’Œå·¥å…·
```

### 9.5 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ æµ‹è¯•é—®é¢˜é€ŸæŸ¥è¡¨**

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** | **é¢„é˜²æªæ–½** |
|----------|-------------|-------------|-------------|
| **æµ‹è¯•ä¸ç¨³å®š** | æ•°æ®ä¾èµ–ã€æ—¶åºé—®é¢˜ | æ•°æ®éš”ç¦»ã€Mockå¤–éƒ¨ä¾èµ– | æ— çŠ¶æ€æµ‹è¯•è®¾è®¡ |
| **æ‰§è¡Œæ—¶é—´é•¿** | æ•°æ®é‡å¤§ã€ç½‘ç»œæ…¢ | å¹¶è¡Œæ‰§è¡Œã€å†…å­˜æ•°æ®åº“ | åˆ†å±‚æµ‹è¯•ç­–ç•¥ |
| **ç¯å¢ƒä¸ä¸€è‡´** | é…ç½®å·®å¼‚ã€ç‰ˆæœ¬ä¸åŒ | å®¹å™¨åŒ–ã€é…ç½®ç®¡ç† | åŸºç¡€è®¾æ–½å³ä»£ç  |
| **ç»´æŠ¤æˆæœ¬é«˜** | æµ‹è¯•ä»£ç å¤æ‚ã€é‡å¤ | æå–å…¬å…±æ–¹æ³•ã€æ•°æ®å·¥å‚ | æµ‹è¯•ä»£ç review |

**ğŸ› ï¸ è°ƒè¯•æŠ€å·§**
```java
// æµ‹è¯•è°ƒè¯•è¾…åŠ©å·¥å…·
@TestConfiguration
public class TestDebugConfig {
    
    @Bean
    @ConditionalOnProperty("test.debug.enabled")
    public TestExecutionListener debugListener() {
        return new TestExecutionListener() {
            @Override
            public void beforeTestMethod(TestContext testContext) {
                System.out.println("ğŸ§ª å¼€å§‹æµ‹è¯•: " + testContext.getTestMethod().getName());
                logDatabaseState();
            }
            
            @Override
            public void afterTestMethod(TestContext testContext) {
                System.out.println("âœ… æµ‹è¯•å®Œæˆ: " + testContext.getTestMethod().getName());
                if (testContext.getTestException() != null) {
                    dumpFailureContext(testContext);
                }
            }
        };
    }
    
    private void dumpFailureContext(TestContext context) {
        // å¤±è´¥æ—¶dumpç›¸å…³ä¸Šä¸‹æ–‡ä¿¡æ¯
        System.out.println("ğŸ’¥ æµ‹è¯•å¤±è´¥ä¸Šä¸‹æ–‡:");
        System.out.println("æ•°æ®åº“è¿æ¥çŠ¶æ€: " + checkDatabaseConnection());
        System.out.println("æ´»è·ƒäº‹åŠ¡: " + getActiveTransactions());
        System.out.println("æµ‹è¯•æ•°æ®: " + dumpTestData());
    }
}
```

### 9.6 æ€§èƒ½åŸºå‡†å’ŒæŒ‡æ ‡


**ğŸ“Š æ¨èçš„æ€§èƒ½åŸºå‡†**
```
å“åº”æ—¶é—´åŸºå‡†ï¼š
â€¢ ç®€å•æŸ¥è¯¢ï¼š< 50ms
â€¢ å¤æ‚æŸ¥è¯¢ï¼š< 200ms
â€¢ æ’å…¥æ“ä½œï¼š< 100ms
â€¢ æ‰¹é‡æ“ä½œï¼š< 500ms

ååé‡åŸºå‡†ï¼š
â€¢ ç®€å•æŸ¥è¯¢ï¼š> 1000 QPS
â€¢ å†™å…¥æ“ä½œï¼š> 500 TPS
â€¢ æ‰¹é‡æ“ä½œï¼š> 100 batch/s

èµ„æºä½¿ç”¨åŸºå‡†ï¼š
â€¢ æ•°æ®åº“CPUï¼š< 70%
â€¢ å†…å­˜ä½¿ç”¨ï¼š< 80%
â€¢ è¿æ¥æ± ä½¿ç”¨ç‡ï¼š< 70%
```

**ğŸ¯ ç›‘æ§æŒ‡æ ‡è®¾ç½®**
```java
// æ¨èçš„ç›‘æ§æŒ‡æ ‡é…ç½®
@Component
public class DatabaseMetricsConfig {
    
    @Bean
    public MeterBinder databaseMetrics(DataSource dataSource) {
        return (registry) -> {
            // è¿æ¥æ± æŒ‡æ ‡
            if (dataSource instanceof HikariDataSource) {
                HikariDataSource hikari = (HikariDataSource) dataSource;
                Gauge.builder("db.connections.active")
                    .register(registry, () -> hikari.getHikariPoolMXBean().getActiveConnections());
                
                Gauge.builder("db.connections.total")
                    .register(registry, () -> hikari.getHikariPoolMXBean().getTotalConnections());
            }
            
            // æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡
            Timer.builder("db.query.duration")
                .description("æ•°æ®åº“æŸ¥è¯¢å“åº”æ—¶é—´")
                .register(registry);
        };
    }
}
```

### 9.7 å›¢é˜Ÿåä½œå’Œè§„èŒƒ


**ğŸ‘¥ æµ‹è¯•å›¢é˜Ÿæœ€ä½³å®è·µ**
```
ä»£ç è§„èŒƒï¼š
â€¢ æµ‹è¯•æ–¹æ³•å‘½åæ¸…æ™°ï¼ˆgiven_when_thenï¼‰
â€¢ æµ‹è¯•æ•°æ®ä½¿ç”¨Builderæ¨¡å¼
â€¢ æ–­è¨€ä¿¡æ¯è¦æœ‰æ„ä¹‰
â€¢ æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹

å›¢é˜Ÿåä½œï¼š
â€¢ æµ‹è¯•ç”¨ä¾‹è¦æœ‰æ–‡æ¡£è¯´æ˜
â€¢ å¤±è´¥çš„æµ‹è¯•è¦åŠæ—¶ä¿®å¤
â€¢ å®šæœŸreviewæµ‹è¯•è¦†ç›–ç‡
â€¢ å…±äº«æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

æŒç»­æ”¹è¿›ï¼š
â€¢ å®šæœŸæ€»ç»“æµ‹è¯•ç»éªŒ
â€¢ è·Ÿè¿›æ–°çš„æµ‹è¯•æŠ€æœ¯
â€¢ ä¼˜åŒ–æµ‹è¯•æ‰§è¡Œæ•ˆç‡
â€¢ å®Œå–„æµ‹è¯•è‡ªåŠ¨åŒ–ç¨‹åº¦
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ•°æ®åº“æµ‹è¯•ä¸åªæ˜¯åŠŸèƒ½æµ‹è¯•ï¼Œè¿˜è¦å…³æ³¨æ€§èƒ½ã€ç¨³å®šæ€§ã€å®‰å…¨æ€§
- åˆé€‚çš„æµ‹è¯•ç­–ç•¥æ¯”å®Œç¾çš„æµ‹è¯•å·¥å…·æ›´é‡è¦
- è‡ªåŠ¨åŒ–æ˜¯æé«˜æµ‹è¯•æ•ˆç‡çš„å…³é”®ï¼Œä½†è¦å¾ªåºæ¸è¿›
- æµ‹è¯•æ•°æ®ç®¡ç†æ˜¯æ•°æ®åº“æµ‹è¯•æˆåŠŸçš„åŸºç¡€
- æŒç»­ç›‘æ§å’Œå¿«é€Ÿåé¦ˆæ˜¯ä¿è¯è´¨é‡çš„é‡è¦æ‰‹æ®µ