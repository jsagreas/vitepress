---
title: 11ã€DMLæ“ä½œæ—¥å¿—è§„èŒƒä¸åˆ†æ
---
## ğŸ“š ç›®å½•

1. [åº”ç”¨æ—¥å¿—è®°å½•è§„èŒƒ](#1-åº”ç”¨æ—¥å¿—è®°å½•è§„èŒƒ)
2. [æ•°æ®åº“æ“ä½œæ—¥å¿—æ ¼å¼](#2-æ•°æ®åº“æ“ä½œæ—¥å¿—æ ¼å¼)
3. [æ—¥å¿—çº§åˆ«è®¾ç½®ç­–ç•¥](#3-æ—¥å¿—çº§åˆ«è®¾ç½®ç­–ç•¥)
4. [æ—¥å¿—åˆ†æå·¥å…·ä½¿ç”¨](#4-æ—¥å¿—åˆ†æå·¥å…·ä½¿ç”¨)
5. [æ—¥å¿—å­˜å‚¨ä¸å½’æ¡£](#5-æ—¥å¿—å­˜å‚¨ä¸å½’æ¡£)
6. [æ—¥å¿—å®‰å…¨ä¸è„±æ•](#6-æ—¥å¿—å®‰å…¨ä¸è„±æ•)
7. [æ—¥å¿—ç›‘æ§ä¸å‘Šè­¦](#7-æ—¥å¿—ç›‘æ§ä¸å‘Šè­¦)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ åº”ç”¨æ—¥å¿—è®°å½•è§„èŒƒ


### 1.1 æ—¥å¿—è®°å½•çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦è®°å½•DMLæ“ä½œæ—¥å¿—**
```
ä¸šåŠ¡ä»·å€¼ï¼š
â€¢ é—®é¢˜æ’æŸ¥ï¼šå¿«é€Ÿå®šä½æ•°æ®å¼‚å¸¸çš„æ ¹æœ¬åŸå› 
â€¢ å®¡è®¡åˆè§„ï¼šæ»¡è¶³æ³•å¾‹æ³•è§„å¯¹æ•°æ®æ“ä½œçš„å®¡è®¡è¦æ±‚
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šåˆ†ææ…¢SQLï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
â€¢ è¿è¥åˆ†æï¼šäº†è§£ç”¨æˆ·è¡Œä¸ºå’Œç³»ç»Ÿä½¿ç”¨æƒ…å†µ
```

**ğŸ’¡ é€šä¿—ç†è§£**
DMLæ—¥å¿—å°±åƒæ˜¯ä¸€ä¸ª**è¯¦ç»†çš„è´¦æœ¬**ï¼Œè®°å½•äº†ç³»ç»Ÿä¸­æ¯ä¸€ç¬”æ•°æ®"äº¤æ˜“"ï¼š
- è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆæ“ä½œ
- æ“ä½œæ˜¯å¦æˆåŠŸ
- è€—æ—¶å¤šé•¿
- å½±å“äº†å¤šå°‘æ¡æ•°æ®

è¿™æ ·å½“å‡ºç°é—®é¢˜æ—¶ï¼Œæˆ‘ä»¬å°±èƒ½åƒæŸ¥è´¦æœ¬ä¸€æ ·ï¼Œå¿«é€Ÿæ‰¾åˆ°é—®é¢˜çš„æºå¤´ã€‚

### 1.2 æ—¥å¿—è®°å½•åŸºæœ¬åŸåˆ™


**ğŸ“‹ æ ¸å¿ƒè®¾è®¡åŸåˆ™**
```
å®Œæ•´æ€§åŸåˆ™ï¼š
â€¢ è®°å½•æ‰€æœ‰å…³é”®çš„DMLæ“ä½œ
â€¢ åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ ä¸é—æ¼é‡è¦çš„æ“ä½œç»†èŠ‚

å¯è¯»æ€§åŸåˆ™ï¼š
â€¢ ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
â€¢ é‡‡ç”¨æ¸…æ™°çš„å­—æ®µå‘½å
â€¢ ä¾¿äºäººå·¥é˜…è¯»å’Œæœºå™¨è§£æ

æ€§èƒ½åŸåˆ™ï¼š
â€¢ å¼‚æ­¥è®°å½•ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
â€¢ æ§åˆ¶æ—¥å¿—é‡ï¼Œé¿å…å½±å“ç³»ç»Ÿæ€§èƒ½
â€¢ åˆç†è®¾ç½®æ—¥å¿—çº§åˆ«

å®‰å…¨åŸåˆ™ï¼š
â€¢ æ•æ„Ÿä¿¡æ¯å¿…é¡»è„±æ•å¤„ç†
â€¢ æ§åˆ¶æ—¥å¿—è®¿é—®æƒé™
â€¢ é˜²æ­¢æ—¥å¿—æ³„éœ²ä¸šåŠ¡æ•°æ®
```

### 1.3 éœ€è¦è®°å½•çš„DMLæ“ä½œ


**ğŸ¯ å¿…é¡»è®°å½•çš„æ“ä½œ**
```
æ•°æ®ä¿®æ”¹æ“ä½œï¼š
â€¢ INSERTï¼šæ–°å¢æ•°æ®è®°å½•
â€¢ UPDATEï¼šä¿®æ”¹æ•°æ®è®°å½•  
â€¢ DELETEï¼šåˆ é™¤æ•°æ®è®°å½•
â€¢ REPLACEï¼šæ›¿æ¢æ•°æ®è®°å½•

æ‰¹é‡æ“ä½œï¼š
â€¢ æ‰¹é‡æ’å…¥ï¼šBATCH INSERT
â€¢ æ‰¹é‡æ›´æ–°ï¼šBATCH UPDATE
â€¢ æ‰¹é‡åˆ é™¤ï¼šBATCH DELETE

äº‹åŠ¡æ“ä½œï¼š
â€¢ äº‹åŠ¡å¼€å§‹ï¼šBEGIN TRANSACTION
â€¢ äº‹åŠ¡æäº¤ï¼šCOMMIT
â€¢ äº‹åŠ¡å›æ»šï¼šROLLBACK
```

**âš ï¸ ç‰¹åˆ«å…³æ³¨çš„æ“ä½œ**
```
é«˜é£é™©æ“ä½œï¼š
â€¢ æ— WHEREæ¡ä»¶çš„UPDATE/DELETE
â€¢ å¤§æ‰¹é‡æ•°æ®æ“ä½œï¼ˆå½±å“è¡Œæ•°>1000ï¼‰
â€¢ é‡è¦ä¸šåŠ¡è¡¨çš„æ“ä½œï¼ˆç”¨æˆ·ã€è®¢å•ã€æ”¯ä»˜ç­‰ï¼‰
â€¢ ç”Ÿäº§ç¯å¢ƒçš„ç›´æ¥æ“ä½œ

æ€§èƒ½æ•æ„Ÿæ“ä½œï¼š
â€¢ æ‰§è¡Œæ—¶é—´è¶…è¿‡é˜ˆå€¼çš„SQLï¼ˆå¦‚>1ç§’ï¼‰
â€¢ å½±å“è¡Œæ•°è¾ƒå¤šçš„æ“ä½œ
â€¢ å…¨è¡¨æ‰«æçš„æ“ä½œ
â€¢ é”ç­‰å¾…æ—¶é—´è¾ƒé•¿çš„æ“ä½œ
```

### 1.4 æ—¥å¿—è®°å½•å®ç°æ–¹å¼


**ğŸ’» ä»£ç å±‚é¢çš„æ—¥å¿—è®°å½•**
```java
@Service
public class UserService {
    
    private static final Logger logger = LoggerFactory.getLogger(UserService.class);
    
    public void updateUser(Long userId, User userInfo) {
        // è®°å½•æ“ä½œå¼€å§‹
        logger.info("å¼€å§‹æ›´æ–°ç”¨æˆ·ä¿¡æ¯, userId={}, operator={}", 
                   userId, getCurrentOperator());
        
        long startTime = System.currentTimeMillis();
        int affectedRows = 0;
        
        try {
            affectedRows = userMapper.updateUser(userId, userInfo);
            
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•æ“ä½œæˆåŠŸ
            logger.info("ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ, userId={}, affectedRows={}, duration={}ms", 
                       userId, affectedRows, duration);
                       
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•æ“ä½œå¤±è´¥
            logger.error("ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥, userId={}, duration={}ms, error={}", 
                        userId, duration, e.getMessage(), e);
            throw e;
        }
    }
}
```

**ğŸ”§ AOPæ–¹å¼ç»Ÿä¸€è®°å½•**
```java
@Aspect
@Component
public class DMLLoggingAspect {
    
    private static final Logger logger = LoggerFactory.getLogger("DML_OPERATION");
    
    @Around("@annotation(DMLLogging)")
    public Object logDMLOperation(ProceedingJoinPoint joinPoint) throws Throwable {
        DMLLogging annotation = getAnnotation(joinPoint);
        String operation = annotation.operation();
        String table = annotation.table();
        
        // æ„å»ºæ—¥å¿—ä¸Šä¸‹æ–‡
        MDC.put("operation", operation);
        MDC.put("table", table);
        MDC.put("operator", getCurrentOperator());
        MDC.put("requestId", getCurrentRequestId());
        
        long startTime = System.currentTimeMillis();
        Object result = null;
        String status = "SUCCESS";
        String errorMsg = null;
        
        try {
            result = joinPoint.proceed();
            return result;
            
        } catch (Exception e) {
            status = "FAILED";
            errorMsg = e.getMessage();
            throw e;
            
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•æ“ä½œæ—¥å¿—
            logger.info("DMLæ“ä½œå®Œæˆ, operation={}, table={}, status={}, " +
                       "duration={}ms, affectedRows={}, error={}", 
                       operation, table, status, duration, 
                       getAffectedRows(result), errorMsg);
            
            // æ¸…ç†MDC
            MDC.clear();
        }
    }
}
```

---

## 2. ğŸ—‚ï¸ æ•°æ®åº“æ“ä½œæ—¥å¿—æ ¼å¼


### 2.1 æ ‡å‡†æ—¥å¿—æ ¼å¼è®¾è®¡


**ğŸ“Š æ¨èçš„JSONæ ¼å¼**
```json
{
    "timestamp": "2025-09-02T15:30:15.123Z",
    "requestId": "req_20250902_001",
    "operator": {
        "userId": "user_1001",
        "username": "zhangsan", 
        "userType": "ADMIN",
        "clientIp": "192.168.1.100"
    },
    "database": {
        "instance": "prod-mysql-01",
        "schema": "ecommerce", 
        "table": "orders"
    },
    "operation": {
        "type": "UPDATE",
        "sql": "UPDATE orders SET status = ? WHERE order_id = ?",
        "parameters": ["PAID", "ORD20250902001"],
        "affectedRows": 1,
        "duration": 45,
        "status": "SUCCESS"
    },
    "business": {
        "module": "OrderService",
        "method": "updateOrderStatus", 
        "businessId": "ORD20250902001",
        "businessType": "ORDER_PAYMENT"
    },
    "performance": {
        "executionTime": 45,
        "lockWaitTime": 0,
        "rowsExamined": 1,
        "indexUsed": "idx_order_id"
    }
}
```

**ğŸ”¤ ç®€åŒ–çš„æ–‡æœ¬æ ¼å¼**
```
[2025-09-02 15:30:15.123] [INFO] [DML] 
requestId=req_20250902_001 | 
operator=zhangsan(user_1001) | 
operation=UPDATE | 
table=ecommerce.orders | 
sql=UPDATE orders SET status = ? WHERE order_id = ? | 
params=[PAID,ORD20250902001] | 
affectedRows=1 | 
duration=45ms | 
status=SUCCESS
```

### 2.2 æ—¥å¿—å­—æ®µè¯¦ç»†è¯´æ˜


**ğŸ“‹ æ ¸å¿ƒå­—æ®µå®šä¹‰**
```
åŸºç¡€ä¿¡æ¯å­—æ®µï¼š
â€¢ timestamp: æ“ä½œæ—¶é—´æˆ³ï¼ˆISO8601æ ¼å¼ï¼‰
â€¢ requestId: è¯·æ±‚å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºé“¾è·¯è¿½è¸ªï¼‰
â€¢ level: æ—¥å¿—çº§åˆ«ï¼ˆINFO/WARN/ERRORï¼‰

æ“ä½œè€…ä¿¡æ¯ï¼š
â€¢ userId: ç”¨æˆ·å”¯ä¸€æ ‡è¯†
â€¢ username: ç”¨æˆ·åç§°
â€¢ userType: ç”¨æˆ·ç±»å‹ï¼ˆADMIN/USER/SYSTEMï¼‰
â€¢ clientIp: å®¢æˆ·ç«¯IPåœ°å€
â€¢ userAgent: ç”¨æˆ·ä»£ç†ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

æ•°æ®åº“ä¿¡æ¯ï¼š
â€¢ instance: æ•°æ®åº“å®ä¾‹åç§°
â€¢ schema: æ•°æ®åº“åç§°
â€¢ table: è¡¨åç§°
â€¢ operation: æ“ä½œç±»å‹ï¼ˆINSERT/UPDATE/DELETEï¼‰

SQLä¿¡æ¯ï¼š
â€¢ sql: æ‰§è¡Œçš„SQLè¯­å¥ï¼ˆè„±æ•åï¼‰
â€¢ parameters: SQLå‚æ•°ï¼ˆè„±æ•åï¼‰
â€¢ affectedRows: å½±å“çš„è¡Œæ•°
â€¢ duration: æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
â€¢ status: æ‰§è¡ŒçŠ¶æ€ï¼ˆSUCCESS/FAILEDï¼‰
```

### 2.3 ä¸åŒæ“ä½œç±»å‹çš„æ—¥å¿—æ ¼å¼


**ğŸ“ INSERTæ“ä½œæ—¥å¿—**
```json
{
    "timestamp": "2025-09-02T15:30:15.123Z",
    "operation": {
        "type": "INSERT",
        "sql": "INSERT INTO users (username, email, phone) VALUES (?, ?, ?)",
        "parameters": ["zhangsan", "zs***@example.com", "138****1234"],
        "affectedRows": 1,
        "duration": 23,
        "status": "SUCCESS",
        "generatedKeys": ["user_1002"]
    },
    "business": {
        "businessType": "USER_REGISTER",
        "businessId": "user_1002"
    }
}
```

**ğŸ”„ UPDATEæ“ä½œæ—¥å¿—**
```json
{
    "timestamp": "2025-09-02T15:30:16.456Z", 
    "operation": {
        "type": "UPDATE",
        "sql": "UPDATE orders SET status = ?, updated_at = ? WHERE order_id = ?",
        "parameters": ["SHIPPED", "2025-09-02 15:30:16", "ORD20250902001"],
        "affectedRows": 1,
        "duration": 34,
        "status": "SUCCESS",
        "whereCondition": "order_id = 'ORD20250902001'"
    },
    "dataChange": {
        "before": {"status": "PAID"},
        "after": {"status": "SHIPPED"}
    }
}
```

**ğŸ—‘ï¸ DELETEæ“ä½œæ—¥å¿—**
```json
{
    "timestamp": "2025-09-02T15:30:17.789Z",
    "operation": {
        "type": "DELETE", 
        "sql": "DELETE FROM user_sessions WHERE user_id = ? AND expired_at < ?",
        "parameters": ["user_1001", "2025-09-01 15:30:17"],
        "affectedRows": 3,
        "duration": 67,
        "status": "SUCCESS"
    },
    "business": {
        "businessType": "SESSION_CLEANUP",
        "businessId": "user_1001"
    }
}
```

### 2.4 æ‰¹é‡æ“ä½œæ—¥å¿—å¤„ç†


**ğŸ“¦ æ‰¹é‡æ“ä½œæ—¥å¿—æ ¼å¼**
```json
{
    "timestamp": "2025-09-02T15:30:18.123Z",
    "operation": {
        "type": "BATCH_INSERT",
        "sql": "INSERT INTO order_items (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)",
        "batchSize": 50,
        "totalAffectedRows": 50,
        "duration": 234,
        "status": "SUCCESS"
    },
    "performance": {
        "avgTimePerRow": 4.68,
        "maxTimePerBatch": 45,
        "memoryUsed": "2.3MB"
    },
    "business": {
        "businessType": "ORDER_CREATE",
        "businessId": "ORD20250902002"
    }
}
```

---

## 3. ğŸ“Š æ—¥å¿—çº§åˆ«è®¾ç½®ç­–ç•¥


### 3.1 æ—¥å¿—çº§åˆ«å®šä¹‰


**ğŸ¯ æ ‡å‡†æ—¥å¿—çº§åˆ«**
```
DEBUGçº§åˆ«ï¼šå¼€å‘è°ƒè¯•ä¿¡æ¯
â€¢ SQLå‚æ•°è¯¦ç»†ä¿¡æ¯
â€¢ æ–¹æ³•è°ƒç”¨å †æ ˆ
â€¢ è¯¦ç»†çš„æ‰§è¡Œæ­¥éª¤
â€¢ ä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨

INFOçº§åˆ«ï¼šæ­£å¸¸ä¸šåŠ¡æ“ä½œ
â€¢ æˆåŠŸçš„DMLæ“ä½œ
â€¢ é‡è¦çš„ä¸šåŠ¡æµç¨‹èŠ‚ç‚¹
â€¢ ç³»ç»ŸçŠ¶æ€å˜åŒ–
â€¢ ç”Ÿäº§ç¯å¢ƒé»˜è®¤çº§åˆ«

WARNçº§åˆ«ï¼šéœ€è¦æ³¨æ„çš„æƒ…å†µ  
â€¢ æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„æ“ä½œï¼ˆ>500msï¼‰
â€¢ å½±å“è¡Œæ•°è¾ƒå¤šçš„æ“ä½œï¼ˆ>100è¡Œï¼‰
â€¢ é‡è¯•æˆåŠŸçš„æ“ä½œ
â€¢ é™çº§å¤„ç†çš„æ“ä½œ

ERRORçº§åˆ«ï¼šæ“ä½œå¤±è´¥æˆ–å¼‚å¸¸
â€¢ SQLæ‰§è¡Œå¤±è´¥
â€¢ äº‹åŠ¡å›æ»š
â€¢ æ•°æ®çº¦æŸè¿å
â€¢ ç³»ç»Ÿå¼‚å¸¸é”™è¯¯
```

### 3.2 ä¸åŒç¯å¢ƒçš„çº§åˆ«é…ç½®


**ğŸ—ï¸ ç¯å¢ƒçº§åˆ«é…ç½®ç­–ç•¥**
```xml
<!-- å¼€å‘ç¯å¢ƒ (application-dev.yml) -->
logging:
  level:
    com.company.dao: DEBUG      # DAOå±‚æ˜¾ç¤ºè¯¦ç»†SQL
    DML_OPERATION: DEBUG        # DMLæ“ä½œè¯¦ç»†æ—¥å¿—
    root: INFO

<!-- æµ‹è¯•ç¯å¢ƒ (application-test.yml) -->
logging:
  level:
    com.company.dao: INFO       # DAOå±‚æ­£å¸¸æ—¥å¿—
    DML_OPERATION: INFO         # DMLæ“ä½œåŸºæœ¬æ—¥å¿—
    root: INFO

<!-- ç”Ÿäº§ç¯å¢ƒ (application-prod.yml) -->
logging:
  level:
    com.company.dao: WARN       # åªè®°å½•æ…¢SQLå’Œå¼‚å¸¸
    DML_OPERATION: INFO         # DMLæ“ä½œåŸºæœ¬æ—¥å¿—
    root: WARN
```

### 3.3 åŠ¨æ€æ—¥å¿—çº§åˆ«è°ƒæ•´


**ğŸ”§ åŸºäºæ¡ä»¶çš„æ—¥å¿—çº§åˆ«**
```java
@Component
public class DynamicLoggingConfig {
    
    public LogLevel determineLogLevel(DMLOperation operation) {
        // é«˜é£é™©æ“ä½œï¼šå¼ºåˆ¶DEBUGçº§åˆ«
        if (isHighRiskOperation(operation)) {
            return LogLevel.DEBUG;
        }
        
        // æ…¢æ“ä½œï¼šWARNçº§åˆ«
        if (operation.getDuration() > 1000) {
            return LogLevel.WARN;
        }
        
        // å¤§æ‰¹é‡æ“ä½œï¼šINFOçº§åˆ«  
        if (operation.getAffectedRows() > 100) {
            return LogLevel.INFO;
        }
        
        // æ™®é€šæ“ä½œï¼šæ ¹æ®ç¯å¢ƒé…ç½®
        return getDefaultLogLevel();
    }
    
    private boolean isHighRiskOperation(DMLOperation operation) {
        // æ— WHEREæ¡ä»¶çš„UPDATE/DELETE
        if (operation.getType().matches("UPDATE|DELETE") 
            && !operation.getSql().contains("WHERE")) {
            return true;
        }
        
        // é‡è¦è¡¨çš„æ“ä½œ
        if (isImportantTable(operation.getTable())) {
            return true;
        }
        
        // ç”Ÿäº§ç¯å¢ƒçš„ç›´æ¥æ“ä½œ
        if (isProdEnvironment() && operation.getOperator().isAdmin()) {
            return true;
        }
        
        return false;
    }
}
```

### 3.4 ä¸šåŠ¡åœºæ™¯çº§åˆ«ç­–ç•¥


**ğŸª ä¸åŒä¸šåŠ¡åœºæ™¯çš„æ—¥å¿—ç­–ç•¥**
```
ç”¨æˆ·æ³¨å†Œç™»å½•ï¼šINFOçº§åˆ«
â€¢ è®°å½•å…³é”®æ­¥éª¤å’Œç»“æœ
â€¢ ä¾¿äºç”¨æˆ·é—®é¢˜æ’æŸ¥
â€¢ ä¸è®°å½•æ•æ„Ÿä¿¡æ¯ç»†èŠ‚

è®¢å•æ”¯ä»˜æµç¨‹ï¼šDEBUGçº§åˆ«  
â€¢ è¯¦ç»†è®°å½•æ¯ä¸ªæ­¥éª¤
â€¢ åŒ…å«å®Œæ•´çš„çŠ¶æ€å˜åŒ–
â€¢ ä¾¿äºèµ„é‡‘å®‰å…¨å®¡è®¡

æ•°æ®ä¿®å¤æ“ä½œï¼šDEBUGçº§åˆ«
â€¢ è¯¦ç»†è®°å½•ä¿®å¤è¿‡ç¨‹
â€¢ è®°å½•ä¿®æ”¹å‰åçš„æ•°æ®å¯¹æ¯”
â€¢ ä¾¿äºå›æ»šå’ŒéªŒè¯

æ—¥å¸¸æŸ¥è¯¢æ“ä½œï¼šWARNçº§åˆ«
â€¢ åªè®°å½•å¼‚å¸¸å’Œæ…¢æŸ¥è¯¢
â€¢ å‡å°‘æ—¥å¿—é‡
â€¢ é¿å…å½±å“æ€§èƒ½
```

---

## 4. ğŸ” æ—¥å¿—åˆ†æå·¥å…·ä½¿ç”¨


### 4.1 ELK Stackæ—¥å¿—åˆ†æ


**ğŸ—ï¸ ELKæ¶æ„æ­å»º**
```
æ—¥å¿—æµè½¬é“¾è·¯ï¼š
åº”ç”¨ç¨‹åº â†’ Logstash â†’ Elasticsearch â†’ Kibana

ç»„ä»¶èŒè´£ï¼š
â€¢ Logstash: æ—¥å¿—æ”¶é›†ã€è§£æã€è¿‡æ»¤
â€¢ Elasticsearch: æ—¥å¿—å­˜å‚¨ã€ç´¢å¼•ã€æœç´¢  
â€¢ Kibana: æ—¥å¿—å¯è§†åŒ–ã€ä»ªè¡¨æ¿ã€å‘Šè­¦
```

**âš™ï¸ Logstashé…ç½®ç¤ºä¾‹**
```ruby
# logstash.conf
input {
  file {
    path => "/var/log/app/dml.log"
    start_position => "beginning"
    codec => json
  }
}

filter {
  # è§£ææ—¶é—´æˆ³
  date {
    match => [ "timestamp", "ISO8601" ]
  }
  
  # æå–å…³é”®å­—æ®µ
  mutate {
    add_field => { "log_type" => "dml_operation" }
  }
  
  # è„±æ•å¤„ç†
  if [operation][sql] {
    mutate {
      gsub => [
        "[operation][sql]", "VALUES\s*\([^)]+\)", "VALUES (?)"
      ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "dml-logs-%{+YYYY.MM.dd}"
  }
}
```

### 4.2 å¸¸ç”¨æŸ¥è¯¢å’Œåˆ†æ


**ğŸ” åŸºç¡€æŸ¥è¯¢è¯­å¥**
```json
// æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ“ä½œè®°å½•
GET dml-logs-*/_search
{
  "query": {
    "bool": {
      "must": [
        {"term": {"operator.userId": "user_1001"}},
        {"range": {"timestamp": {"gte": "2025-09-02T00:00:00Z"}}}
      ]
    }
  },
  "sort": [{"timestamp": {"order": "desc"}}]
}

// æŸ¥è¯¢æ…¢SQLæ“ä½œ
GET dml-logs-*/_search  
{
  "query": {
    "range": {
      "operation.duration": {"gte": 1000}
    }
  },
  "aggs": {
    "slow_tables": {
      "terms": {"field": "database.table"}
    }
  }
}

// æŸ¥è¯¢å¤±è´¥çš„æ“ä½œ
GET dml-logs-*/_search
{
  "query": {
    "term": {"operation.status": "FAILED"}
  },
  "aggs": {
    "error_distribution": {
      "date_histogram": {
        "field": "timestamp",
        "interval": "1h"
      }
    }
  }
}
```

### 4.3 Kibanaä»ªè¡¨æ¿é…ç½®


**ğŸ“Š æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
```
æ“ä½œç»Ÿè®¡é¢æ¿ï¼š
â€¢ æ€»æ“ä½œæ•°ï¼šæŒ‰æ—¶é—´åˆ†å¸ƒçš„æŸ±çŠ¶å›¾
â€¢ æ“ä½œç±»å‹åˆ†å¸ƒï¼šINSERT/UPDATE/DELETEé¥¼å›¾  
â€¢ æˆåŠŸç‡ï¼šæˆåŠŸvså¤±è´¥çš„æ¯”ä¾‹

æ€§èƒ½ç›‘æ§é¢æ¿ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´ï¼šæŒ‰æ—¶é—´çš„æŠ˜çº¿å›¾
â€¢ æ…¢SQL Top10ï¼šè¡¨æ ¼å±•ç¤º
â€¢ æ•°æ®åº“è´Ÿè½½ï¼šå„å®ä¾‹çš„æ“ä½œé‡å¯¹æ¯”

å¼‚å¸¸ç›‘æ§é¢æ¿ï¼š
â€¢ é”™è¯¯ç‡è¶‹åŠ¿ï¼šæŒ‰æ—¶é—´çš„é¢ç§¯å›¾
â€¢ é”™è¯¯ç±»å‹åˆ†å¸ƒï¼šé¥¼å›¾
â€¢ é”™è¯¯è¯¦æƒ…ï¼šè¡¨æ ¼å±•ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯

ç”¨æˆ·æ´»åŠ¨é¢æ¿ï¼š
â€¢ æ´»è·ƒç”¨æˆ·æ•°ï¼šå»é‡ç»Ÿè®¡
â€¢ ç”¨æˆ·æ“ä½œçƒ­åŠ›å›¾ï¼šæŒ‰ç”¨æˆ·å’Œæ—¶é—´
â€¢ é«˜é¢‘æ“ä½œç”¨æˆ·ï¼šTop10æ’è¡Œ
```

### 4.4 è‡ªå®šä¹‰æ—¥å¿—åˆ†æè„šæœ¬


**ğŸ Pythonåˆ†æè„šæœ¬ç¤ºä¾‹**
```python
import json
import pandas as pd
from datetime import datetime, timedelta

class DMLLogAnalyzer:
    
    def __init__(self, log_file_path):
        self.logs = self.load_logs(log_file_path)
        
    def load_logs(self, file_path):
        """åŠ è½½æ—¥å¿—æ–‡ä»¶"""
        logs = []
        with open(file_path, 'r') as f:
            for line in f:
                try:
                    log = json.loads(line.strip())
                    logs.append(log)
                except:
                    continue
        return logs
    
    def analyze_performance(self):
        """æ€§èƒ½åˆ†æ"""
        df = pd.DataFrame([{
            'timestamp': log['timestamp'],
            'table': log['database']['table'],
            'operation': log['operation']['type'],
            'duration': log['operation']['duration'],
            'affected_rows': log['operation']['affectedRows']
        } for log in self.logs])
        
        # æ…¢SQLåˆ†æ
        slow_operations = df[df['duration'] > 1000]
        
        # æŒ‰è¡¨ç»Ÿè®¡å¹³å‡å“åº”æ—¶é—´
        table_performance = df.groupby('table')['duration'].agg([
            'count', 'mean', 'max', 'std'
        ]).round(2)
        
        return {
            'slow_operations_count': len(slow_operations),
            'table_performance': table_performance.to_dict(),
            'avg_duration': df['duration'].mean()
        }
    
    def analyze_user_behavior(self):
        """ç”¨æˆ·è¡Œä¸ºåˆ†æ"""
        df = pd.DataFrame([{
            'user_id': log['operator']['userId'],
            'operation': log['operation']['type'],
            'timestamp': log['timestamp'],
            'table': log['database']['table']
        } for log in self.logs])
        
        # ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
        user_stats = df.groupby('user_id').agg({
            'operation': 'count',
            'table': lambda x: len(x.unique())
        }).rename(columns={
            'operation': 'total_operations',
            'table': 'unique_tables'
        })
        
        return user_stats.to_dict()

# ä½¿ç”¨ç¤ºä¾‹
analyzer = DMLLogAnalyzer('/var/log/app/dml.log')
performance_report = analyzer.analyze_performance()
user_report = analyzer.analyze_user_behavior()

print("æ€§èƒ½åˆ†ææŠ¥å‘Š:", performance_report)
print("ç”¨æˆ·è¡Œä¸ºæŠ¥å‘Š:", user_report)
```

---

## 5. ğŸ’¾ æ—¥å¿—å­˜å‚¨ä¸å½’æ¡£


### 5.1 æ—¥å¿—å­˜å‚¨ç­–ç•¥


**ğŸ—‚ï¸ åˆ†çº§å­˜å‚¨æ–¹æ¡ˆ**
```
çƒ­æ•°æ®å­˜å‚¨ï¼ˆè¿‘7å¤©ï¼‰ï¼š
â€¢ å­˜å‚¨ä½ç½®ï¼šSSDé«˜é€Ÿå­˜å‚¨
â€¢ ç´¢å¼•ç­–ç•¥ï¼šå…¨å­—æ®µç´¢å¼•
â€¢ æŸ¥è¯¢æ€§èƒ½ï¼šæ¯«ç§’çº§å“åº”
â€¢ ä¸»è¦ç”¨é€”ï¼šå®æ—¶ç›‘æ§ã€å¿«é€Ÿæ’æŸ¥

æ¸©æ•°æ®å­˜å‚¨ï¼ˆ7-90å¤©ï¼‰ï¼š
â€¢ å­˜å‚¨ä½ç½®ï¼šSATAæœºæ¢°ç¡¬ç›˜
â€¢ ç´¢å¼•ç­–ç•¥ï¼šå…³é”®å­—æ®µç´¢å¼•
â€¢ æŸ¥è¯¢æ€§èƒ½ï¼šç§’çº§å“åº”  
â€¢ ä¸»è¦ç”¨é€”ï¼šå†å²åˆ†æã€å®¡è®¡æŸ¥è¯¢

å†·æ•°æ®å­˜å‚¨ï¼ˆ90å¤©ä»¥ä¸Šï¼‰ï¼š
â€¢ å­˜å‚¨ä½ç½®ï¼šå¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰
â€¢ å‹ç¼©æ ¼å¼ï¼šgzipå‹ç¼©
â€¢ æŸ¥è¯¢æ–¹å¼ï¼šç¦»çº¿åˆ†æ
â€¢ ä¸»è¦ç”¨é€”ï¼šåˆè§„å®¡è®¡ã€æ•°æ®æŒ–æ˜
```

### 5.2 æ—¥å¿—è½®è½¬é…ç½®


**ğŸ”„ Logbackè½®è½¬é…ç½®**
```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="DML_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>/var/log/app/dml.log</file>
        
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- æ—¥å¿—æ–‡ä»¶åæ¨¡å¼ -->
            <fileNamePattern>/var/log/app/dml.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            
            <!-- å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å° -->
            <maxFileSize>100MB</maxFileSize>
            
            <!-- ä¿ç•™å¤©æ•° -->
            <maxHistory>30</maxHistory>
            
            <!-- æ€»å¤§å°é™åˆ¶ -->
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>
    
    <logger name="DML_OPERATION" level="INFO" additivity="false">
        <appender-ref ref="DML_FILE"/>
    </logger>
</configuration>
```

### 5.3 æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ


**ğŸ’¾ MySQLå­˜å‚¨è¡¨ç»“æ„**
```sql
CREATE TABLE dml_operation_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    request_id VARCHAR(64) NOT NULL,
    timestamp DATETIME(3) NOT NULL,
    
    -- æ“ä½œè€…ä¿¡æ¯
    user_id VARCHAR(32),
    username VARCHAR(64),
    user_type VARCHAR(16),
    client_ip VARCHAR(45),
    
    -- æ•°æ®åº“ä¿¡æ¯  
    db_instance VARCHAR(32),
    schema_name VARCHAR(64),
    table_name VARCHAR(64),
    
    -- æ“ä½œä¿¡æ¯
    operation_type VARCHAR(16) NOT NULL,
    sql_statement TEXT,
    sql_parameters JSON,
    affected_rows INT DEFAULT 0,
    duration_ms INT DEFAULT 0,
    status VARCHAR(16) NOT NULL,
    error_message TEXT,
    
    -- ä¸šåŠ¡ä¿¡æ¯
    business_module VARCHAR(64),
    business_type VARCHAR(32),
    business_id VARCHAR(64),
    
    -- ç´¢å¼•å­—æ®µ
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_timestamp (timestamp),
    INDEX idx_user_id (user_id),
    INDEX idx_table_name (table_name),
    INDEX idx_operation_type (operation_type),
    INDEX idx_business_id (business_id),
    INDEX idx_status_duration (status, duration_ms)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5.4 è‡ªåŠ¨å½’æ¡£è„šæœ¬


**ğŸ¤– å®šæ—¶å½’æ¡£ä»»åŠ¡**
```bash
#!/bin/bash
# auto_archive_logs.sh

# é…ç½®å‚æ•°
LOG_DIR="/var/log/app"
ARCHIVE_DIR="/data/archive/logs" 
RETENTION_DAYS=90
S3_BUCKET="company-log-archive"

# åˆ›å»ºå½’æ¡£ç›®å½•
mkdir -p ${ARCHIVE_DIR}/$(date +%Y/%m)

# å½’æ¡£7å¤©å‰çš„æ—¥å¿—æ–‡ä»¶
find ${LOG_DIR} -name "dml.*.log.gz" -mtime +7 -type f | while read file; do
    echo "å½’æ¡£æ–‡ä»¶: $file"
    
    # ç§»åŠ¨åˆ°æœ¬åœ°å½’æ¡£ç›®å½•
    mv "$file" "${ARCHIVE_DIR}/$(date +%Y/%m)/"
    
    # ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
    aws s3 cp "${ARCHIVE_DIR}/$(date +%Y/%m)/$(basename $file)" \
              "s3://${S3_BUCKET}/dml-logs/$(date +%Y/%m)/"
done

# æ¸…ç†è¶…è¿‡ä¿ç•™æœŸçš„æœ¬åœ°å½’æ¡£æ–‡ä»¶
find ${ARCHIVE_DIR} -name "*.log.gz" -mtime +${RETENTION_DAYS} -delete

# æ•°æ®åº“å½’æ¡£ï¼ˆå°†è€æ•°æ®è¿ç§»åˆ°å½’æ¡£è¡¨ï¼‰
mysql -u ${DB_USER} -p${DB_PASSWORD} ${DB_NAME} << EOF
-- åˆ›å»ºå½’æ¡£è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
CREATE TABLE IF NOT EXISTS dml_operation_logs_archive LIKE dml_operation_logs;

-- å½’æ¡£90å¤©å‰çš„æ•°æ®
INSERT INTO dml_operation_logs_archive 
SELECT * FROM dml_operation_logs 
WHERE timestamp < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- åˆ é™¤å·²å½’æ¡£çš„æ•°æ®
DELETE FROM dml_operation_logs 
WHERE timestamp < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- ä¼˜åŒ–è¡¨
OPTIMIZE TABLE dml_operation_logs;
EOF

echo "æ—¥å¿—å½’æ¡£å®Œæˆ: $(date)"
```

---

## 6. ğŸ”’ æ—¥å¿—å®‰å…¨ä¸è„±æ•


### 6.1 æ•æ„Ÿä¿¡æ¯è¯†åˆ«


**ğŸ” æ•æ„Ÿæ•°æ®ç±»å‹**
```
ä¸ªäººèº«ä»½ä¿¡æ¯ï¼ˆPIIï¼‰ï¼š
â€¢ èº«ä»½è¯å·ï¼š18ä½æ•°å­—
â€¢ æ‰‹æœºå·ç ï¼š11ä½æ•°å­—  
â€¢ é‚®ç®±åœ°å€ï¼šåŒ…å«@ç¬¦å·çš„é‚®ç®±æ ¼å¼
â€¢ é“¶è¡Œå¡å·ï¼š15-19ä½æ•°å­—
â€¢ å§“åï¼šä¸­æ–‡å§“åæˆ–è‹±æ–‡å§“å

ä¸šåŠ¡æ•æ„Ÿä¿¡æ¯ï¼š
â€¢ å¯†ç ï¼špasswordã€pwdç›¸å…³å­—æ®µ
â€¢ ä»¤ç‰Œï¼štokenã€secretã€keyç›¸å…³å­—æ®µ
â€¢ é‡‘é¢ï¼šæ¶‰åŠé‡‘é’±çš„æ•°å€¼
â€¢ åœ°å€ï¼šè¯¦ç»†åœ°å€ä¿¡æ¯

æŠ€æœ¯æ•æ„Ÿä¿¡æ¯ï¼š
â€¢ æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
â€¢ APIå¯†é’¥å’Œè®¤è¯ä¿¡æ¯
â€¢ å†…éƒ¨ç³»ç»Ÿé…ç½®å‚æ•°
```

### 6.2 æ•°æ®è„±æ•è§„åˆ™


**ğŸ­ è„±æ•ç­–ç•¥è®¾è®¡**
```java
@Component
public class DataMaskingService {
    
    // æ‰‹æœºå·è„±æ•ï¼šä¿ç•™å‰3ä½å’Œå4ä½
    public String maskPhoneNumber(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // èº«ä»½è¯è„±æ•ï¼šä¿ç•™å‰6ä½å’Œå4ä½
    public String maskIdCard(String idCard) {
        if (idCard == null || idCard.length() != 18) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }
    
    // é‚®ç®±è„±æ•ï¼šç”¨æˆ·åä¿ç•™å‰2ä½ï¼ŒåŸŸåå®Œæ•´æ˜¾ç¤º
    public String maskEmail(String email) {
        if (email == null || !email.contains("@")) {
            return email;
        }
        String[] parts = email.split("@");
        String username = parts[0];
        String domain = parts[1];
        
        if (username.length() <= 2) {
            return "**@" + domain;
        }
        return username.substring(0, 2) + "***@" + domain;
    }
    
    // é“¶è¡Œå¡å·è„±æ•ï¼šåªæ˜¾ç¤ºå4ä½
    public String maskBankCard(String cardNo) {
        if (cardNo == null || cardNo.length() < 8) {
            return cardNo;
        }
        return "**** **** **** " + cardNo.substring(cardNo.length() - 4);
    }
    
    // SQLå‚æ•°è„±æ•
    public List<String> maskSqlParameters(List<String> params) {
        return params.stream()
                     .map(this::maskParameter)
                     .collect(Collectors.toList());
    }
    
    private String maskParameter(String param) {
        // æ‰‹æœºå·åŒ¹é…
        if (param.matches("^1[3-9]\\d{9}$")) {
            return maskPhoneNumber(param);
        }
        
        // èº«ä»½è¯å·åŒ¹é…  
        if (param.matches("^[1-9]\\d{17}$")) {
            return maskIdCard(param);
        }
        
        // é‚®ç®±åŒ¹é…
        if (param.matches("^[\\w.-]+@[\\w.-]+\\.[a-zA-Z]{2,}$")) {
            return maskEmail(param);
        }
        
        // é“¶è¡Œå¡å·åŒ¹é…
        if (param.matches("^\\d{15,19}$")) {
            return maskBankCard(param);
        }
        
        return param;
    }
}
```

### 6.3 æ—¥å¿—è®¿é—®æ§åˆ¶


**ğŸ” æƒé™æ§åˆ¶ç­–ç•¥**
```java
@RestController
@RequestMapping("/api/logs")
@PreAuthorize("hasRole('LOG_VIEWER')")
public class LogViewController {
    
    @GetMapping("/dml")
    @PreAuthorize("hasPermission('DML_LOGS', 'READ')")
    public PageResult<DMLLog> getDMLLogs(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) String userId,
            @RequestParam(required = false) String table,
            Authentication authentication) {
        
        // è·å–å½“å‰ç”¨æˆ·æƒé™
        UserPrincipal user = (UserPrincipal) authentication.getPrincipal();
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        QueryCondition condition = new QueryCondition();
        
        // æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ“ä½œæ—¥å¿—
        if (!user.hasRole("ADMIN")) {
            condition.setUserId(user.getUserId());
        }
        
        // æ•æ„Ÿè¡¨éœ€è¦ç‰¹æ®Šæƒé™
        if (table != null && isSensitiveTable(table)) {
            if (!user.hasPermission("SENSITIVE_TABLE_LOGS", "READ")) {
                throw new AccessDeniedException("æ— æƒé™æŸ¥çœ‹æ•æ„Ÿè¡¨æ—¥å¿—");
            }
        }
        
        // æŸ¥è¯¢å¹¶è„±æ•
        PageResult<DMLLog> result = logService.queryLogs(condition, page, size);
        
        // æ ¹æ®ç”¨æˆ·æƒé™å†³å®šè„±æ•çº§åˆ«
        if (!user.hasRole("ADMIN")) {
            result.getData().forEach(this::maskSensitiveFields);
        }
        
        return result;
    }
    
    private void maskSensitiveFields(DMLLog log) {
        // è„±æ•SQLå‚æ•°
        if (log.getSqlParameters() != null) {
            log.setSqlParameters(maskingService.maskSqlParameters(
                log.getSqlParameters()));
        }
        
        // éšè—è¯¦ç»†é”™è¯¯ä¿¡æ¯
        if (log.getErrorMessage() != null) {
            log.setErrorMessage("æ“ä½œå¤±è´¥");
        }
    }
}
```

### 6.4 åŠ å¯†å­˜å‚¨æ–¹æ¡ˆ


**ğŸ” æ•æ„Ÿæ—¥å¿—åŠ å¯†å­˜å‚¨**
```java
@Service
public class SecureLogService {
    
    @Autowired
    private AESEncryptionService encryptionService;
    
    public void saveDMLLog(DMLLogEvent event) {
        DMLLog log = new DMLLog();
        
        // åŸºç¡€å­—æ®µä¸åŠ å¯†
        log.setRequestId(event.getRequestId());
        log.setTimestamp(event.getTimestamp());
        log.setOperationType(event.getOperationType());
        
        // æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
        if (containsSensitiveData(event.getSqlParameters())) {
            log.setSqlParameters(encryptionService.encrypt(
                JSON.toJSONString(event.getSqlParameters())));
            log.setEncrypted(true);
        } else {
            log.setSqlParameters(JSON.toJSONString(event.getSqlParameters()));
            log.setEncrypted(false);
        }
        
        // ä¸šåŠ¡IDå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œé€‰æ‹©æ€§åŠ å¯†
        if (isSensitiveBusinessId(event.getBusinessId())) {
            log.setBusinessId(encryptionService.encrypt(event.getBusinessId()));
        } else {
            log.setBusinessId(event.getBusinessId());
        }
        
        logRepository.save(log);
    }
    
    public DMLLog getDecryptedLog(Long logId) {
        DMLLog log = logRepository.findById(logId);
        
        if (log != null && log.isEncrypted()) {
            // è§£å¯†æ•æ„Ÿå­—æ®µ
            String decryptedParams = encryptionService.decrypt(log.getSqlParameters());
            log.setSqlParameters(decryptedParams);
            
            if (isBusinessIdEncrypted(log.getBusinessId())) {
                String decryptedBusinessId = encryptionService.decrypt(log.getBusinessId());
                log.setBusinessId(decryptedBusinessId);
            }
        }
        
        return log;
    }
}
```

---

## 7. ğŸ“Š æ—¥å¿—ç›‘æ§ä¸å‘Šè­¦


### 7.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ¯ æ ¸å¿ƒç›‘æ§ç»´åº¦**
```
æ“ä½œé‡ç›‘æ§ï¼š
â€¢ QPSæŒ‡æ ‡ï¼šæ¯ç§’æ“ä½œæ•°é‡
â€¢ æ“ä½œç±»å‹åˆ†å¸ƒï¼šINSERT/UPDATE/DELETEæ¯”ä¾‹
â€¢ è¡¨æ“ä½œçƒ­åº¦ï¼šä¸åŒè¡¨çš„æ“ä½œé¢‘ç‡
â€¢ ç”¨æˆ·æ´»è·ƒåº¦ï¼šæ´»è·ƒç”¨æˆ·æ•°å˜åŒ–è¶‹åŠ¿

æ€§èƒ½ç›‘æ§ï¼š
â€¢ å¹³å‡å“åº”æ—¶é—´ï¼šæ“ä½œæ‰§è¡Œæ—¶é—´ç»Ÿè®¡
â€¢ æ…¢æ“ä½œæ¯”ä¾‹ï¼šè¶…è¿‡é˜ˆå€¼çš„æ“ä½œå æ¯”
â€¢ æ•°æ®åº“è¿æ¥æ± ï¼šè¿æ¥æ•°ä½¿ç”¨æƒ…å†µ
â€¢ é”ç­‰å¾…æ—¶é—´ï¼šäº‹åŠ¡é”ç­‰å¾…ç»Ÿè®¡

å¼‚å¸¸ç›‘æ§ï¼š
â€¢ é”™è¯¯ç‡ï¼šæ“ä½œå¤±è´¥çš„æ¯”ä¾‹
â€¢ é”™è¯¯ç±»å‹åˆ†å¸ƒï¼šä¸åŒé”™è¯¯çš„å æ¯”
â€¢ é‡è¯•æˆåŠŸç‡ï¼šé‡è¯•æœºåˆ¶çš„æ•ˆæœ
â€¢ äº‹åŠ¡å›æ»šç‡ï¼šå›æ»šæ“ä½œçš„é¢‘ç‡
```

### 7.2 å‘Šè­¦è§„åˆ™é…ç½®


**âš ï¸ å‘Šè­¦è§„åˆ™è®¾è®¡**
```yaml
# prometheuså‘Šè­¦è§„åˆ™
groups:
- name: dml_operation_alerts
  rules:
  
  # é”™è¯¯ç‡å‘Šè­¦
  - alert: HighDMLErrorRate
    expr: (
      rate(dml_operation_failed_total[5m]) / 
      rate(dml_operation_total[5m])
    ) * 100 > 5
    for: 2m
    labels:
      severity: warning
      service: database
    annotations:
      summary: "DMLæ“ä½œé”™è¯¯ç‡è¿‡é«˜"
      description: "è¿‡å»5åˆ†é’ŸDMLæ“ä½œé”™è¯¯ç‡ä¸º{{ $value }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"
  
  # æ…¢æ“ä½œå‘Šè­¦  
  - alert: SlowDMLOperation
    expr: histogram_quantile(0.95, rate(dml_operation_duration_seconds_bucket[5m])) > 2
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "DMLæ“ä½œå“åº”æ—¶é—´è¿‡æ…¢"
      description: "95%çš„DMLæ“ä½œå“åº”æ—¶é—´è¶…è¿‡2ç§’"
  
  # æ“ä½œé‡å¼‚å¸¸å‘Šè­¦
  - alert: AbnormalDMLVolume
    expr: |
      (
        rate(dml_operation_total[10m]) > 
        avg_over_time(rate(dml_operation_total[10m])[1h:5m]) * 3
      ) or (
        rate(dml_operation_total[10m]) < 
        avg_over_time(rate(dml_operation_total[10m])[1h:5m]) * 0.3
      )
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "DMLæ“ä½œé‡å¼‚å¸¸"
      description: "å½“å‰æ“ä½œé‡ä¸å†å²å¹³å‡å€¼ç›¸æ¯”å¼‚å¸¸ï¼š{{ $value }}"
```

### 7.3 å®æ—¶ç›‘æ§ä»ªè¡¨æ¿


**ğŸ“Š Grafanaä»ªè¡¨æ¿é…ç½®**
```json
{
  "dashboard": {
    "title": "DMLæ“ä½œç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "DMLæ“ä½œQPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(dml_operation_total[1m])",
            "legend": "æ€»QPS"
          },
          {
            "expr": "rate(dml_operation_total{operation_type='INSERT'}[1m])",
            "legend": "INSERT QPS"
          },
          {
            "expr": "rate(dml_operation_total{operation_type='UPDATE'}[1m])",
            "legend": "UPDATE QPS"
          },
          {
            "expr": "rate(dml_operation_total{operation_type='DELETE'}[1m])",
            "legend": "DELETE QPS"
          }
        ]
      },
      {
        "title": "æ“ä½œæˆåŠŸç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "(rate(dml_operation_success_total[5m]) / rate(dml_operation_total[5m])) * 100"
          }
        ],
        "thresholds": [
          {"color": "red", "value": 95},
          {"color": "yellow", "value": 98},
          {"color": "green", "value": 99}
        ]
      },
      {
        "title": "å¹³å‡å“åº”æ—¶é—´",
        "type": "graph", 
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(dml_operation_duration_seconds_bucket[5m]))",
            "legend": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(dml_operation_duration_seconds_bucket[5m]))",
            "legend": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(dml_operation_duration_seconds_bucket[5m]))", 
            "legend": "P99"
          }
        ]
      }
    ]
  }
}
```

### 7.4 æ™ºèƒ½å¼‚å¸¸æ£€æµ‹


**ğŸ¤– åŸºäºæœºå™¨å­¦ä¹ çš„å¼‚å¸¸æ£€æµ‹**
```python
import numpy as np
from sklearn.ensemble import IsolationForest
import pandas as pd

class DMLAnomalyDetector:
    
    def __init__(self):
        self.models = {
            'operation_volume': IsolationForest(contamination=0.1),
            'response_time': IsolationForest(contamination=0.05),
            'error_rate': IsolationForest(contamination=0.05)
        }
        self.is_trained = False
    
    def train(self, historical_data):
        """ä½¿ç”¨å†å²æ•°æ®è®­ç»ƒå¼‚å¸¸æ£€æµ‹æ¨¡å‹"""
        df = pd.DataFrame(historical_data)
        
        # ç‰¹å¾å·¥ç¨‹
        features = self.extract_features(df)
        
        # è®­ç»ƒå„ä¸ªæ¨¡å‹
        for metric, model in self.models.items():
            model.fit(features[metric].values.reshape(-1, 1))
        
        self.is_trained = True
    
    def detect_anomalies(self, current_metrics):
        """æ£€æµ‹å½“å‰æŒ‡æ ‡æ˜¯å¦å¼‚å¸¸"""
        if not self.is_trained:
            raise Exception("æ¨¡å‹å°šæœªè®­ç»ƒ")
        
        anomalies = {}
        
        for metric, value in current_metrics.items():
            if metric in self.models:
                # é¢„æµ‹æ˜¯å¦å¼‚å¸¸ (-1è¡¨ç¤ºå¼‚å¸¸ï¼Œ1è¡¨ç¤ºæ­£å¸¸)
                prediction = self.models[metric].predict([[value]])
                anomaly_score = self.models[metric].decision_function([[value]])
                
                anomalies[metric] = {
                    'is_anomaly': prediction[0] == -1,
                    'score': anomaly_score[0],
                    'value': value
                }
        
        return anomalies
    
    def extract_features(self, df):
        """æå–ç‰¹å¾"""
        features = {}
        
        # æ“ä½œé‡ç‰¹å¾
        features['operation_volume'] = df.groupby('timestamp')['operation_count'].sum()
        
        # å“åº”æ—¶é—´ç‰¹å¾
        features['response_time'] = df.groupby('timestamp')['avg_duration'].mean()
        
        # é”™è¯¯ç‡ç‰¹å¾  
        features['error_rate'] = df.groupby('timestamp').apply(
            lambda x: (x['failed_count'] / x['total_count']).mean()
        )
        
        return features

# ä½¿ç”¨ç¤ºä¾‹
detector = DMLAnomalyDetector()

# è®­ç»ƒæ¨¡å‹ï¼ˆä½¿ç”¨è¿‡å»30å¤©çš„æ•°æ®ï¼‰
historical_data = load_historical_metrics(days=30)
detector.train(historical_data)

# å®æ—¶æ£€æµ‹
current_metrics = {
    'operation_volume': 1500,  # å½“å‰QPS
    'response_time': 250,      # å¹³å‡å“åº”æ—¶é—´ms
    'error_rate': 0.02         # é”™è¯¯ç‡2%
}

anomalies = detector.detect_anomalies(current_metrics)

for metric, result in anomalies.items():
    if result['is_anomaly']:
        print(f"æ£€æµ‹åˆ°å¼‚å¸¸: {metric} = {result['value']}, å¼‚å¸¸åˆ†æ•°: {result['score']}")
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—è®°å½•è§„èŒƒï¼šå®Œæ•´æ€§ã€å¯è¯»æ€§ã€æ€§èƒ½ã€å®‰å…¨å››é¡¹åŸºæœ¬åŸåˆ™
ğŸ”¸ æ—¥å¿—æ ¼å¼è®¾è®¡ï¼šJSONç»“æ„åŒ–æ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
ğŸ”¸ æ—¥å¿—çº§åˆ«ç­–ç•¥ï¼šæ ¹æ®ç¯å¢ƒå’Œä¸šåŠ¡åœºæ™¯çµæ´»è®¾ç½®æ—¥å¿—çº§åˆ«
ğŸ”¸ æ—¥å¿—åˆ†æå·¥å…·ï¼šELK Stackæ˜¯ä¸»æµé€‰æ‹©ï¼Œæ”¯æŒå®æ—¶åˆ†æ
ğŸ”¸ å­˜å‚¨å½’æ¡£æ–¹æ¡ˆï¼šåˆ†çº§å­˜å‚¨ï¼Œå®šæœŸå½’æ¡£ï¼Œä¼˜åŒ–æˆæœ¬
ğŸ”¸ å®‰å…¨è„±æ•å¤„ç†ï¼šæ•æ„Ÿä¿¡æ¯å¿…é¡»è„±æ•ï¼Œè®¿é—®æƒé™ä¸¥æ ¼æ§åˆ¶
ğŸ”¸ ç›‘æ§å‘Šè­¦ä½“ç³»ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ï¼Œæ™ºèƒ½å¼‚å¸¸æ£€æµ‹
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆDMLæ—¥å¿—å¦‚æ­¤é‡è¦**
```
ä¸šåŠ¡è§’åº¦ï¼š
â€¢ æ•°æ®æ˜¯ä¼ä¸šæœ€é‡è¦çš„èµ„äº§
â€¢ æ¯ä¸€æ¬¡æ•°æ®å˜æ›´éƒ½å¯èƒ½å½±å“ä¸šåŠ¡
â€¢ å®Œæ•´çš„æ“ä½œè®°å½•æ˜¯é—®é¢˜æ’æŸ¥çš„åŸºç¡€
â€¢ å®¡è®¡åˆè§„çš„å¿…è¦è¦æ±‚

æŠ€æœ¯è§’åº¦ï¼š
â€¢ åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹çš„å¯è§‚æµ‹æ€§éœ€æ±‚
â€¢ æ€§èƒ½é—®é¢˜è¯Šæ–­çš„æ•°æ®åŸºç¡€
â€¢ ç³»ç»Ÿæ•…éšœæ¢å¤çš„é‡è¦ä¾æ®
â€¢ å®¹é‡è§„åˆ’å’Œä¼˜åŒ–çš„æ•°æ®æ¥æº
```

**ğŸ”¹ å¦‚ä½•å¹³è¡¡æ—¥å¿—çš„å®Œæ•´æ€§ä¸æ€§èƒ½**
```
ç­–ç•¥é€‰æ‹©ï¼š
â€¢ å¼‚æ­¥è®°å½•ï¼šä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
â€¢ åˆ†çº§å­˜å‚¨ï¼šçƒ­æ•°æ®å¿«é€Ÿè®¿é—®ï¼Œå†·æ•°æ®å½’æ¡£
â€¢ é‡‡æ ·è®°å½•ï¼šé«˜é¢‘æ“ä½œå¯ä»¥é‡‡æ ·è®°å½•
â€¢ æ‰¹é‡å¤„ç†ï¼šæ‰¹é‡å†™å…¥æé«˜æ•ˆç‡

æŠ€æœ¯å®ç°ï¼š
â€¢ å†…å­˜ç¼“å†²ï¼šå…ˆå†™å†…å­˜ï¼Œå®šæœŸåˆ·ç›˜
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šè§£è€¦æ—¥å¿—è®°å½•ä¸ä¸šåŠ¡é€»è¾‘
â€¢ å‹ç¼©å­˜å‚¨ï¼šå‡å°‘å­˜å‚¨ç©ºé—´å ç”¨
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼šå…³é”®å­—æ®µå»ºç«‹ç´¢å¼•
```

**ğŸ”¹ æ—¥å¿—å®‰å…¨çš„é‡è¦æ€§**
```
æ•°æ®å®‰å…¨é£é™©ï¼š
â€¢ æ—¥å¿—å¯èƒ½åŒ…å«ç”¨æˆ·æ•æ„Ÿä¿¡æ¯
â€¢ ä¸å½“çš„æ—¥å¿—è®¿é—®å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²
â€¢ æ—¥å¿—æœ¬èº«ä¹Ÿæ˜¯é‡è¦çš„æ•°æ®èµ„äº§

é˜²æŠ¤æªæ–½ï¼š
â€¢ æ•°æ®è„±æ•ï¼šåœ¨è®°å½•æ—¶å°±è„±æ•å¤„ç†
â€¢ è®¿é—®æ§åˆ¶ï¼šä¸¥æ ¼çš„æƒé™ç®¡ç†
â€¢ åŠ å¯†å­˜å‚¨ï¼šæ•æ„Ÿæ—¥å¿—åŠ å¯†ä¿å­˜
â€¢ å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ—¥å¿—çš„è®¿é—®è¡Œä¸º
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡ä»·å€¼**
- **é—®é¢˜å¿«é€Ÿå®šä½**ï¼šè¯¦ç»†çš„æ“ä½œæ—¥å¿—å¸®åŠ©å¿«é€Ÿæ‰¾åˆ°é—®é¢˜æ ¹å› 
- **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šé€šè¿‡æ—¥å¿—åˆ†æä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
- **åˆè§„å®¡è®¡æ”¯æŒ**ï¼šæ»¡è¶³å„ç§æ³•è§„å¯¹æ•°æ®æ“ä½œå®¡è®¡çš„è¦æ±‚
- **ä¸šåŠ¡æ´å¯Ÿè·å–**ï¼šä»æ“ä½œæ—¥å¿—ä¸­å‘ç°ä¸šåŠ¡è§„å¾‹å’Œä¼˜åŒ–ç‚¹

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- **ç³»ç»Ÿå¯è§‚æµ‹æ€§**ï¼šå…¨é¢äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
- **æ€§èƒ½è°ƒä¼˜ä¾æ®**ï¼šåŸºäºçœŸå®æ•°æ®è¿›è¡Œæ€§èƒ½ä¼˜åŒ–
- **æ•…éšœé¢„é˜²èƒ½åŠ›**ï¼šé€šè¿‡å¼‚å¸¸æ£€æµ‹æå‰å‘ç°é—®é¢˜
- **æ¶æ„æ¼”è¿›æ”¯æ’‘**ï¼šä¸ºç³»ç»Ÿæ¶æ„å‡çº§æä¾›æ•°æ®æ”¯æ’‘

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“š å®æ–½è·¯å¾„**
```
é˜¶æ®µä¸€ï¼šåŸºç¡€å»ºè®¾
â€¢ ç¡®å®šæ—¥å¿—è®°å½•è§„èŒƒå’Œæ ¼å¼
â€¢ å®ç°ç»Ÿä¸€çš„æ—¥å¿—è®°å½•ç»„ä»¶
â€¢ é…ç½®æ—¥å¿—è½®è½¬å’ŒåŸºç¡€å­˜å‚¨

é˜¶æ®µäºŒï¼šåˆ†æèƒ½åŠ›
â€¢ æ­å»ºæ—¥å¿—åˆ†æå¹³å°ï¼ˆELK Stackï¼‰
â€¢ å»ºç«‹æ ¸å¿ƒç›‘æ§æŒ‡æ ‡å’Œä»ªè¡¨æ¿
â€¢ å®ç°åŸºæœ¬çš„å‘Šè­¦æœºåˆ¶

é˜¶æ®µä¸‰ï¼šå®‰å…¨åˆè§„
â€¢ å®æ–½æ•°æ®è„±æ•å’Œæƒé™æ§åˆ¶
â€¢ å»ºç«‹æ—¥å¿—å½’æ¡£å’Œå¤‡ä»½æœºåˆ¶
â€¢ å®Œå–„å®¡è®¡å’Œåˆè§„æµç¨‹

é˜¶æ®µå››ï¼šæ™ºèƒ½åŒ–
â€¢ å¼•å…¥å¼‚å¸¸æ£€æµ‹å’Œé¢„è­¦
â€¢ å»ºç«‹è‡ªåŠ¨åŒ–è¿ç»´èƒ½åŠ›
â€¢ æŒç»­ä¼˜åŒ–å’Œæ”¹è¿›
```

**ğŸ› ï¸ æ³¨æ„äº‹é¡¹**
- **å¾ªåºæ¸è¿›**ï¼šä¸è¦ä¸€æ¬¡æ€§å»ºè®¾å¤ªå¤æ‚çš„ç³»ç»Ÿ
- **ä¸šåŠ¡ä¼˜å…ˆ**ï¼šä¼˜å…ˆä¿éšœæ ¸å¿ƒä¸šåŠ¡çš„æ—¥å¿—è®°å½•
- **æ€§èƒ½è€ƒè™‘**ï¼šå§‹ç»ˆå…³æ³¨æ—¥å¿—å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
- **æŒç»­æ”¹è¿›**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µä¸æ–­ä¼˜åŒ–è°ƒæ•´

**æ ¸å¿ƒè®°å¿†**ï¼š
- DMLæ—¥å¿—æ˜¯æ•°æ®å®‰å…¨å’Œç³»ç»Ÿå¯è§‚æµ‹æ€§çš„åŸºç¡€
- å®Œæ•´æ€§ã€å®‰å…¨æ€§ã€æ€§èƒ½ä¸‰è€…éœ€è¦åˆç†å¹³è¡¡
- å·¥å…·å’ŒæŠ€æœ¯æ˜¯æ‰‹æ®µï¼Œè§„èŒƒå’Œæµç¨‹æ›´é‡è¦
- æ—¥å¿—ä¸ä»…æ˜¯è®°å½•ï¼Œæ›´æ˜¯ä¸šåŠ¡å’ŒæŠ€æœ¯æ´å¯Ÿçš„æ•°æ®æº
- å»ºè®¾è¦å¾ªåºæ¸è¿›ï¼ŒæŒç»­ä¼˜åŒ–æ”¹è¿›