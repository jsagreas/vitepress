---
title: 8ã€æ•°æ®åº“è¿æ¥ç®¡ç†ä¸æ± åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†](#2-è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†)
3. [è¿æ¥æ± æ ¸å¿ƒæœºåˆ¶](#3-è¿æ¥æ± æ ¸å¿ƒæœºåˆ¶)
4. [è¿æ¥æ± é…ç½®å‚æ•°è¯¦è§£](#4-è¿æ¥æ± é…ç½®å‚æ•°è¯¦è§£)
5. [è¿æ¥è·å–è¶…æ—¶æ§åˆ¶](#5-è¿æ¥è·å–è¶…æ—¶æ§åˆ¶)
6. [è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹](#6-è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹)
7. [è¿æ¥æ± é¢„çƒ­æœºåˆ¶](#7-è¿æ¥æ± é¢„çƒ­æœºåˆ¶)
8. [è¿æ¥æ± æ‰©ç¼©å®¹ç­–ç•¥](#8-è¿æ¥æ± æ‰©ç¼©å®¹ç­–ç•¥)
9. [è¿æ¥æ± æ•…éšœåˆ‡æ¢](#9-è¿æ¥æ± æ•…éšœåˆ‡æ¢)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“è¿æ¥


**ğŸ”¸ è¿æ¥çš„æœ¬è´¨**
æ•°æ®åº“è¿æ¥å°±åƒæ‰“ç”µè¯ä¸€æ ·ï¼Œåº”ç”¨ç¨‹åºéœ€è¦å’Œæ•°æ®åº“"é€šè¯"æ¥äº¤æ¢æ•°æ®ã€‚å»ºç«‹è¿æ¥å°±æ˜¯æ‹¨å·è¿‡ç¨‹ï¼Œéœ€è¦éªŒè¯èº«ä»½ã€åå•†é€šä¿¡æ–¹å¼ï¼Œç„¶åæ‰èƒ½æ­£å¸¸"å¯¹è¯"ã€‚

```
è¿æ¥å»ºç«‹è¿‡ç¨‹ç¤ºæ„ï¼š
åº”ç”¨ç¨‹åº                        æ•°æ®åº“æœåŠ¡å™¨
   |                               |
   |----[1]è¯·æ±‚è¿æ¥---------------->|
   |    (IPã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç )      |
   |                               |
   |<---[2]èº«ä»½éªŒè¯-----------------|
   |                               |  
   |----[3]åè®®åå•†---------------->|
   |    (å­—ç¬¦é›†ã€äº‹åŠ¡çº§åˆ«ç­‰)          |
   |                               |
   |<---[4]è¿æ¥ç¡®è®¤-----------------|
   |                               |
   |=====[5]å¯ä»¥å¼€å§‹æ•°æ®äº¤äº’========|
```

**ğŸ’¡ è¿æ¥çš„æˆæœ¬**
- **æ—¶é—´æˆæœ¬**ï¼šå»ºç«‹è¿æ¥é€šå¸¸éœ€è¦å‡ æ¯«ç§’åˆ°å‡ ç™¾æ¯«ç§’
- **èµ„æºæˆæœ¬**ï¼šæ¯ä¸ªè¿æ¥å ç”¨å†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰ç³»ç»Ÿèµ„æº
- **ç½‘ç»œæˆæœ¬**ï¼šéœ€è¦TCPä¸‰æ¬¡æ¡æ‰‹ã€SSLåŠ å¯†åå•†ç­‰ç½‘ç»œå¼€é”€

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥ç®¡ç†


**âš ï¸ ä¸ç®¡ç†è¿æ¥çš„é—®é¢˜**

```
ä¼ ç»Ÿç›´è¿æ–¹å¼çš„é—®é¢˜ï¼š
æ¯æ¬¡æŸ¥è¯¢éƒ½æ–°å»ºè¿æ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ–°å»ºè¿æ¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨è¯·æ±‚1  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ–°å»ºè¿æ¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚  åº”ç”¨è¯·æ±‚2  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   æ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ–°å»ºè¿æ¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨è¯·æ±‚3  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   æ•°æ®åº“    â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜åˆ†æï¼š
ğŸš¨ æ€§èƒ½é—®é¢˜ï¼šæ¯æ¬¡éƒ½è¦é‡æ–°å»ºè¿ï¼Œå“åº”æ—¶é—´é•¿
ğŸš¨ èµ„æºæµªè´¹ï¼šé¢‘ç¹åˆ›å»ºé”€æ¯è¿æ¥ï¼ŒCPUå’Œå†…å­˜å¼€é”€å¤§
ğŸš¨ è¿æ¥æ•°æš´å¢ï¼šé«˜å¹¶å‘æ—¶å¯èƒ½è¶…å‡ºæ•°æ®åº“è¿æ¥æ•°é™åˆ¶
ğŸš¨ ç¨³å®šæ€§å·®ï¼šè¿æ¥å»ºç«‹å¤±è´¥ä¼šç›´æ¥å½±å“ä¸šåŠ¡
```

**âœ… è¿æ¥æ± çš„ä»·å€¼**
```
è¿æ¥æ± å¤ç”¨æ–¹å¼ï¼š
é¢„å…ˆåˆ›å»ºè¿æ¥ï¼Œå¾ªç¯ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨è¯·æ±‚1  â”‚ â†â”€â”€ç§Ÿå€Ÿâ”€â”€â”€â”€ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  è¿æ¥æ±      â”‚ â†â”€â”€â†’ æ•°æ®åº“
â”‚  åº”ç”¨è¯·æ±‚2  â”‚ â†â”€â”€ç§Ÿå€Ÿâ”€â”€â”€â”€ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚             â”‚  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚             â”‚
â”‚  åº”ç”¨è¯·æ±‚3  â”‚ â†â”€â”€ç§Ÿå€Ÿâ”€â”€â”€â”€ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿å¯¹æ¯”ï¼š
âœ… æ€§èƒ½æå‡ï¼šå¤ç”¨è¿æ¥ï¼Œå‡å°‘å»ºè¿æ—¶é—´
âœ… èµ„æºå¯æ§ï¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé¿å…èµ„æºè€—å°½  
âœ… é«˜å¯ç”¨ï¼šè¿æ¥å¤±è´¥æ—¶æœ‰é‡è¯•å’Œæ•…éšœè½¬ç§»æœºåˆ¶
âœ… ç›‘æ§å‹å¥½ï¼šç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºç›‘æ§å’Œè°ƒä¼˜
```

### 1.3 è¿æ¥æ± çš„å·¥ä½œåŸç†


**ğŸ”„ è¿æ¥æ± åŸºæœ¬æœºåˆ¶**

```
è¿æ¥æ± å†…éƒ¨ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è¿æ¥æ± ç®¡ç†å™¨              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç©ºé—²è¿æ¥é˜Ÿåˆ—                        â”‚
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”          â”‚
â”‚  â”‚ C1â”‚ â”‚ C2â”‚ â”‚ C3â”‚ â”‚ C4â”‚ â†â”€ å¯ç”¨è¿æ¥  â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ´»è·ƒè¿æ¥é˜Ÿåˆ—                        â”‚  
â”‚  â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”                       â”‚
â”‚  â”‚ C5â”‚ â”‚ C6â”‚ â†â”€ æ­£åœ¨ä½¿ç”¨çš„è¿æ¥        â”‚
â”‚  â””â”€â”€â”€â”˜ â””â”€â”€â”€â”˜                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…ç½®å‚æ•°                            â”‚
â”‚  â€¢ æœ€å°è¿æ¥æ•°ï¼š2                     â”‚
â”‚  â€¢ æœ€å¤§è¿æ¥æ•°ï¼š10                    â”‚
â”‚  â€¢ è·å–è¶…æ—¶ï¼š5ç§’                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ“ä½œæµç¨‹ï¼š
1ï¸âƒ£ åº”ç”¨è¯·æ±‚è¿æ¥
2ï¸âƒ£ æ£€æŸ¥ç©ºé—²è¿æ¥é˜Ÿåˆ—
3ï¸âƒ£ æœ‰ç©ºé—²è¿æ¥ â†’ ç›´æ¥åˆ†é…
4ï¸âƒ£ æ— ç©ºé—²è¿æ¥ â†’ æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ›å»ºæ–°è¿æ¥
5ï¸âƒ£ å¯ä»¥åˆ›å»º â†’ æ–°å»ºè¿æ¥å¹¶åˆ†é…
6ï¸âƒ£ ä¸èƒ½åˆ›å»º â†’ ç­‰å¾…æˆ–è¿”å›è¶…æ—¶é”™è¯¯
7ï¸âƒ£ åº”ç”¨ä½¿ç”¨å®Œæ¯•åå½’è¿˜è¿æ¥
```

---

## 2. â™»ï¸ è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 2.1 è¿æ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ


**ğŸ“Š è¿æ¥çŠ¶æ€è½¬æ¢å›¾**

```
è¿æ¥ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœºï¼š
                    [åˆå§‹åŒ–]
                        â”‚
                   åˆ›å»ºè¿æ¥è¯·æ±‚
                        â”‚
                        â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”Œâ”€â”€â”€â–¶â”‚  ç©ºé—²   â”‚â—€â”€â”€â”
              â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
            å½’è¿˜è¿æ¥      â”‚        â”‚ 
              â”‚      åˆ†é…è¿æ¥      â”‚ è¿æ¥éªŒè¯é€šè¿‡
              â”‚          â”‚        â”‚
              â”‚          â–¼        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” æ‰§è¡ŒSQL â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  æ´»è·ƒ   â”‚â—€â”€â”€â”€â”€â”€â”€â–¶â”‚  éªŒè¯   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                  â”‚
        è¿æ¥å¼‚å¸¸/è¶…æ—¶      è¿æ¥éªŒè¯å¤±è´¥
              â”‚                  â”‚
              â–¼                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å…³é—­   â”‚        â”‚  ç§»é™¤   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¿æ¥åˆ›å»ºé˜¶æ®µ


**ğŸ”§ è¿æ¥åˆå§‹åŒ–è¿‡ç¨‹**

```java
// è¿æ¥åˆ›å»ºçš„å…¸å‹å®ç°
public class ConnectionFactory {
    
    public Connection createConnection() throws SQLException {
        try {
            // ç¬¬1æ­¥ï¼šåŠ è½½é©±åŠ¨ï¼ˆç°ä»£JDBCä¼šè‡ªåŠ¨åŠ è½½ï¼‰
            // Class.forName("com.mysql.cj.jdbc.Driver");
            
            // ç¬¬2æ­¥ï¼šå»ºç«‹ç‰©ç†è¿æ¥
            String url = "jdbc:mysql://localhost:3306/testdb";
            Properties props = new Properties();
            props.setProperty("user", "root");
            props.setProperty("password", "password");
            
            // ç¬¬3æ­¥ï¼šè®¾ç½®è¿æ¥å‚æ•°
            props.setProperty("useSSL", "true");
            props.setProperty("serverTimezone", "UTC");
            props.setProperty("characterEncoding", "utf8mb4");
            props.setProperty("autoReconnect", "true");
            
            Connection conn = DriverManager.getConnection(url, props);
            
            // ç¬¬4æ­¥ï¼šè¿æ¥ååˆå§‹åŒ–è®¾ç½®
            conn.setAutoCommit(true);  // è®¾ç½®è‡ªåŠ¨æäº¤
            conn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
            
            // ç¬¬5æ­¥ï¼šè¿æ¥æœ‰æ•ˆæ€§éªŒè¯
            if (!conn.isValid(5)) {  // 5ç§’è¶…æ—¶éªŒè¯
                throw new SQLException("è¿æ¥æ— æ•ˆ");
            }
            
            return conn;
            
        } catch (SQLException e) {
            throw new SQLException("è¿æ¥åˆ›å»ºå¤±è´¥: " + e.getMessage(), e);
        }
    }
}
```

**âš™ï¸ è¿æ¥å‚æ•°ä¼˜åŒ–**

| å‚æ•°å | **ä½œç”¨** | **æ¨èå€¼** | **å½±å“** |
|--------|---------|-----------|---------|
| `connectTimeout` | `è¿æ¥å»ºç«‹è¶…æ—¶` | `5-10ç§’` | `é˜²æ­¢é•¿æ—¶é—´ç­‰å¾…` |
| `socketTimeout` | `æ•°æ®ä¼ è¾“è¶…æ—¶` | `30-60ç§’` | `é˜²æ­¢ç½‘ç»œå¡æ­»` |
| `autoReconnect` | `è‡ªåŠ¨é‡è¿æœºåˆ¶` | `true` | `æé«˜è¿æ¥ç¨³å®šæ€§` |
| `failoverReadOnly` | `æ•…éšœè½¬ç§»åªè¯»` | `false` | `ä¿æŒè¯»å†™èƒ½åŠ›` |
| `maxReconnects` | `æœ€å¤§é‡è¿æ¬¡æ•°` | `3-5æ¬¡` | `å¹³è¡¡é‡è¯•å’Œæ€§èƒ½` |

### 2.3 è¿æ¥ä½¿ç”¨é˜¶æ®µ


**ğŸ¯ è¿æ¥ä½¿ç”¨æœ€ä½³å®è·µ**

```java
// æ¨èçš„è¿æ¥ä½¿ç”¨æ¨¡å¼
public class DatabaseService {
    private DataSource dataSource;
    
    public List<User> getUsers() {
        // ä½¿ç”¨try-with-resourcesç¡®ä¿è¿æ¥é‡Šæ”¾
        String sql = "SELECT id, name, email FROM users";
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {
            
            List<User> users = new ArrayList<>();
            while (rs.next()) {
                User user = new User();
                user.setId(rs.getLong("id"));
                user.setName(rs.getString("name"));
                user.setEmail(rs.getString("email"));
                users.add(user);
            }
            return users;
            
        } catch (SQLException e) {
            throw new RuntimeException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        }
        // è¿æ¥ä¼šè‡ªåŠ¨å½’è¿˜åˆ°æ± ä¸­
    }
}
```

**âš ï¸ è¿æ¥ä½¿ç”¨çš„å¸¸è§é”™è¯¯**

```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šè¿æ¥æ³„éœ²
public List<User> getBadUsers() {
    Connection conn = null;
    try {
        conn = dataSource.getConnection();
        // ... æŸ¥è¯¢é€»è¾‘
        return users;
    } catch (SQLException e) {
        // å¼‚å¸¸æ—¶è¿æ¥æ²¡æœ‰å…³é—­ï¼
        throw new RuntimeException(e);
    } finally {
        // è¿™é‡Œåº”è¯¥å…³é—­è¿æ¥ï¼Œä½†å®¹æ˜“è¢«é—å¿˜
        if (conn != null) {
            try {
                conn.close();
            } catch (SQLException e) {
                // åæ‰å¼‚å¸¸ï¼Œå¯èƒ½éšè—é—®é¢˜
            }
        }
    }
}

// âŒ é”™è¯¯ç¤ºä¾‹ï¼šé•¿æ—¶é—´å ç”¨è¿æ¥  
public void processLargeDataset() {
    try (Connection conn = dataSource.getConnection()) {
        // é”™è¯¯ï¼šé•¿æ—¶é—´å ç”¨è¿æ¥
        for (int i = 0; i < 1000000; i++) {
            // æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡ŒSQLï¼Œå ç”¨è¿æ¥è¿‡ä¹…
            executeQuery(conn, "SELECT * FROM large_table WHERE id = " + i);
            // è¿˜å¯èƒ½åŒ…å«å…¶ä»–è€—æ—¶æ“ä½œ
            Thread.sleep(100);  // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†æ—¶é—´
        }
    }
    // è¿æ¥è¢«å ç”¨äº†å¾ˆé•¿æ—¶é—´ï¼Œå½±å“å…¶ä»–è¯·æ±‚
}
```

### 2.4 è¿æ¥å›æ”¶é˜¶æ®µ


**ğŸ”„ è¿æ¥å½’è¿˜æœºåˆ¶**

```
è¿æ¥å½’è¿˜å¤„ç†æµç¨‹ï¼š
åº”ç”¨è°ƒç”¨ conn.close()
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿æ¥æ˜¯å¦å¥åº·ï¼Ÿâ”‚ â”€â”€Noâ”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
         â”‚Yes             â”‚
         â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é‡ç½®è¿æ¥çŠ¶æ€  â”‚  â”‚   é”€æ¯è¿æ¥   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                
         â–¼                
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        
    â”‚ æ”¾å›ç©ºé—²é˜Ÿåˆ—  â”‚        
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        

è¿æ¥çŠ¶æ€é‡ç½®åŒ…æ‹¬ï¼š
â€¢ å›æ»šæœªæäº¤çš„äº‹åŠ¡
â€¢ æ¸…é™¤ä¸´æ—¶è¡¨å’Œå˜é‡
â€¢ é‡ç½®è‡ªåŠ¨æäº¤æ¨¡å¼
â€¢ æ¸…ç†é¢„å¤„ç†è¯­å¥ç¼“å­˜
```

---

## 3. ğŸŠ è¿æ¥æ± æ ¸å¿ƒæœºåˆ¶


### 3.1 è¿æ¥æ± çš„è®¾è®¡åŸç†


**ğŸ”¸ è¿æ¥æ± è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
è¿æ¥æ± å°±åƒåœè½¦åœºç®¡ç†ç³»ç»Ÿï¼Œé¢„å…ˆå‡†å¤‡ä¸€å®šæ•°é‡çš„"åœè½¦ä½"ï¼ˆè¿æ¥ï¼‰ï¼Œè½¦è¾†ï¼ˆåº”ç”¨è¯·æ±‚ï¼‰æ¥äº†å°±åˆ†é…åœè½¦ä½ï¼Œç”¨å®Œåå½’è¿˜ï¼Œå®ç°èµ„æºçš„é«˜æ•ˆå¤ç”¨ã€‚

```
è¿æ¥æ± vsåœè½¦åœºç±»æ¯”ï¼š
                è¿æ¥æ±                      åœè½¦åœº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ± åŒ–ç®¡ç†             â”‚  â”‚          è½¦ä½ç®¡ç†             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸš— ç©ºé—²è¿æ¥ (Available)      â”‚  â”‚ ğŸ…¿ï¸  ç©ºé—²è½¦ä½ (Available)      â”‚
â”‚ ğŸš™ æ´»è·ƒè¿æ¥ (InUse)          â”‚  â”‚ ğŸš— å ç”¨è½¦ä½ (Occupied)       â”‚
â”‚ â³ ç­‰å¾…é˜Ÿåˆ— (Waiting)        â”‚  â”‚ â³ ç­‰å¾…é˜Ÿåˆ— (Queue)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“Š ç›‘æ§æŒ‡æ ‡                  â”‚  â”‚ ğŸ“Š ä½¿ç”¨ç»Ÿè®¡                  â”‚
â”‚   â€¢ æ€»è¿æ¥æ•°                 â”‚  â”‚   â€¢ æ€»è½¦ä½æ•°                 â”‚
â”‚   â€¢ æ´»è·ƒè¿æ¥æ•°               â”‚  â”‚   â€¢ å·²å ç”¨è½¦ä½               â”‚
â”‚   â€¢ ç­‰å¾…è¯·æ±‚æ•°               â”‚  â”‚   â€¢ æ’é˜Ÿè½¦è¾†æ•°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¿æ¥æ± çš„å†…éƒ¨ç»“æ„


**ğŸ—ï¸ è¿æ¥æ± ç»„ä»¶æ¶æ„**

```
è¿æ¥æ± å†…éƒ¨æ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                è¿æ¥æ± ç®¡ç†å™¨                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¿æ¥å·¥å‚     â”‚  â”‚ è¿æ¥éªŒè¯å™¨   â”‚  â”‚ è¿æ¥å›æ”¶å™¨   â”‚   â”‚
â”‚  â”‚ Factory     â”‚  â”‚ Validator   â”‚  â”‚ Cleaner     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              è¿æ¥å­˜å‚¨å®¹å™¨                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ IDLE    â”‚ â”‚ IDLE    â”‚ â”‚ IDLE    â”‚ â”‚ IDLE    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ Conn-1  â”‚ â”‚ Conn-2  â”‚ â”‚ Conn-3  â”‚ â”‚ Conn-4  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚  â”‚ ACTIVE  â”‚ â”‚ ACTIVE  â”‚  â†â”€â”€ ä½¿ç”¨ä¸­çš„è¿æ¥        â”‚ â”‚
â”‚  â”‚  â”‚ Conn-5  â”‚ â”‚ Conn-6  â”‚                         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              ç­‰å¾…é˜Ÿåˆ—ç®¡ç†                        â”‚ â”‚
â”‚  â”‚  ç­‰å¾…çº¿ç¨‹1 â†’ ç­‰å¾…çº¿ç¨‹2 â†’ ç­‰å¾…çº¿ç¨‹3 â†’ ...           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ä¸»æµè¿æ¥æ± å®ç°å¯¹æ¯”


**ğŸ” è¿æ¥æ± äº§å“ç‰¹ç‚¹åˆ†æ**

| è¿æ¥æ±  | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **é…ç½®å¤æ‚åº¦** | **æ€§èƒ½** |
|--------|---------|-------------|---------------|---------|
| ğŸš€ **HikariCP** | `è½»é‡çº§ï¼Œæ€§èƒ½æœ€ä¼˜` | `å¾®æœåŠ¡ï¼Œé«˜å¹¶å‘åº”ç”¨` | `ç®€å•` | `æé«˜` |
| ğŸ”§ **Druid** | `åŠŸèƒ½ä¸°å¯Œï¼Œç›‘æ§å¼ºå¤§` | `ä¼ä¸šåº”ç”¨ï¼Œéœ€è¦è¯¦ç»†ç›‘æ§` | `å¤æ‚` | `é«˜` |
| âš–ï¸ **DBCP2** | `ç¨³å®šæˆç†Ÿï¼ŒApacheå‡ºå“` | `ä¼ ç»Ÿä¼ä¸šåº”ç”¨` | `ä¸­ç­‰` | `ä¸­é«˜` |
| ğŸ¯ **C3P0** | `å†å²æ‚ ä¹…ï¼ŒåŠŸèƒ½å…¨é¢` | `è€æ—§ç³»ç»Ÿç»´æŠ¤` | `å¤æ‚` | `ä¸­ç­‰` |

**ğŸ’¡ HikariCPæ¨èé…ç½®**
```java
// HikariCP - ç°ä»£åº”ç”¨é¦–é€‰
@Configuration
public class DatabaseConfig {
    
    @Bean
    @ConfigurationProperties("app.datasource")
    public HikariConfig hikariConfig() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€è¿æ¥é…ç½®
        config.setJdbcUrl("jdbc:mysql://localhost:3306/testdb");
        config.setUsername("root");
        config.setPassword("password");
        config.setDriverClassName("com.mysql.cj.jdbc.Driver");
        
        // è¿æ¥æ± å¤§å°é…ç½®
        config.setMinimumIdle(5);          // æœ€å°ç©ºé—²è¿æ¥
        config.setMaximumPoolSize(20);     // æœ€å¤§è¿æ¥æ•°
        
        // è¶…æ—¶é…ç½®
        config.setConnectionTimeout(20000);    // 20ç§’è·å–è¿æ¥è¶…æ—¶
        config.setIdleTimeout(300000);         // 5åˆ†é’Ÿç©ºé—²è¶…æ—¶
        config.setMaxLifetime(1200000);        // 20åˆ†é’Ÿæœ€å¤§ç”Ÿå­˜æ—¶é—´
        
        // è¿æ¥éªŒè¯
        config.setConnectionTestQuery("SELECT 1");
        config.setValidationTimeout(5000);     // 5ç§’éªŒè¯è¶…æ—¶
        
        // æ€§èƒ½ä¼˜åŒ–
        config.setLeakDetectionThreshold(60000);  // 1åˆ†é’Ÿè¿æ¥æ³„æ¼æ£€æµ‹
        config.setPoolName("HikariCP-Pool");
        
        return config;
    }
    
    @Bean
    public DataSource dataSource(HikariConfig hikariConfig) {
        return new HikariDataSource(hikariConfig);
    }
}
```

**ğŸ› ï¸ Druidç›‘æ§é…ç½®**
```java
// Druid - éœ€è¦è¯¦ç»†ç›‘æ§æ—¶ä½¿ç”¨
@Bean
public DataSource druidDataSource() {
    DruidDataSource datasource = new DruidDataSource();
    
    // åŸºç¡€é…ç½®
    datasource.setUrl("jdbc:mysql://localhost:3306/testdb");
    datasource.setUsername("root");
    datasource.setPassword("password");
    datasource.setDriverClassName("com.mysql.cj.jdbc.Driver");
    
    // è¿æ¥æ± é…ç½®
    datasource.setInitialSize(5);
    datasource.setMinIdle(5);
    datasource.setMaxActive(20);
    datasource.setMaxWait(60000);
    
    // éªŒè¯é…ç½®
    datasource.setTestWhileIdle(true);
    datasource.setTestOnBorrow(false);
    datasource.setTestOnReturn(false);
    datasource.setValidationQuery("SELECT 1");
    datasource.setValidationQueryTimeout(5);
    
    // ç›‘æ§é…ç½®
    datasource.setTimeBetweenEvictionRunsMillis(60000);
    datasource.setMinEvictableIdleTimeMillis(300000);
    
    // é˜²SQLæ³¨å…¥
    try {
        datasource.setFilters("stat,wall,slf4j");
    } catch (SQLException e) {
        throw new RuntimeException("druidé…ç½®åˆå§‹åŒ–è¿‡æ»¤å™¨å¤±è´¥", e);
    }
    
    return datasource;
}
```

---

## 4. âš™ï¸ è¿æ¥æ± é…ç½®å‚æ•°è¯¦è§£


### 4.1 æ ¸å¿ƒé…ç½®å‚æ•°åˆ†ç±»


**ğŸ“Š å‚æ•°åˆ†ç±»æ¦‚è§ˆ**

```
è¿æ¥æ± é…ç½®å‚æ•°æ ‘çŠ¶å›¾ï¼š
è¿æ¥æ± é…ç½®å‚æ•°
â”œâ”€â”€ è¿æ¥æ•°é‡æ§åˆ¶
â”‚   â”œâ”€â”€ minimumIdle (æœ€å°ç©ºé—²è¿æ¥)
â”‚   â”œâ”€â”€ maximumPoolSize (æœ€å¤§è¿æ¥æ•°)
â”‚   â””â”€â”€ initialSize (åˆå§‹è¿æ¥æ•°)
â”œâ”€â”€ è¶…æ—¶æ—¶é—´æ§åˆ¶  
â”‚   â”œâ”€â”€ connectionTimeout (è·å–è¿æ¥è¶…æ—¶)
â”‚   â”œâ”€â”€ idleTimeout (ç©ºé—²è¿æ¥è¶…æ—¶)
â”‚   â”œâ”€â”€ maxLifetime (è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´)
â”‚   â””â”€â”€ validationTimeout (éªŒè¯è¶…æ—¶æ—¶é—´)
â”œâ”€â”€ è¿æ¥éªŒè¯é…ç½®
â”‚   â”œâ”€â”€ connectionTestQuery (éªŒè¯SQL)
â”‚   â”œâ”€â”€ testWhileIdle (ç©ºé—²æ—¶éªŒè¯)
â”‚   â”œâ”€â”€ testOnBorrow (è·å–æ—¶éªŒè¯)
â”‚   â””â”€â”€ testOnReturn (å½’è¿˜æ—¶éªŒè¯)
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–é…ç½®
â”‚   â”œâ”€â”€ leakDetectionThreshold (è¿æ¥æ³„æ¼æ£€æµ‹)
â”‚   â”œâ”€â”€ prepStmtCacheSize (é¢„å¤„ç†è¯­å¥ç¼“å­˜)
â”‚   â””â”€â”€ cachePrepStmts (å¯ç”¨é¢„å¤„ç†ç¼“å­˜)
â””â”€â”€ ç›‘æ§å‘Šè­¦é…ç½®
    â”œâ”€â”€ poolName (è¿æ¥æ± åç§°)
    â”œâ”€â”€ registerMbeans (JMXç›‘æ§)
    â””â”€â”€ metricRegistry (æŒ‡æ ‡æ³¨å†Œå™¨)
```

### 4.2 è¿æ¥æ•°é‡å‚æ•°è¯¦è§£


**ğŸ”¢ è¿æ¥æ•°é‡é…ç½®ç­–ç•¥**

```java
// è¿æ¥æ•°é…ç½®çš„ä¸šåŠ¡è€ƒé‡
public class PoolSizeCalculator {
    
    /**
     * è®¡ç®—æ¨èçš„è¿æ¥æ± å¤§å°
     * å…¬å¼ï¼šconnections = ((core_count * 2) + effective_spindle_count)
     * 
     * @param coreCount CPUæ ¸å¿ƒæ•°
     * @param diskCount ç£ç›˜æ•°é‡ï¼ˆæœºæ¢°ç¡¬ç›˜ä¸ºä¸»è¦è€ƒé‡ï¼‰
     * @param avgQueryTime å¹³å‡æŸ¥è¯¢æ—¶é—´(ms)
     * @param peakTPS å³°å€¼TPS
     * @return æ¨èè¿æ¥æ•°
     */
    public static int calculatePoolSize(int coreCount, int diskCount, 
                                      int avgQueryTime, int peakTPS) {
        
        // åŸºç¡€å…¬å¼è®¡ç®—
        int basicSize = (coreCount * 2) + diskCount;
        
        // æ ¹æ®ä¸šåŠ¡è´Ÿè½½è°ƒæ•´
        int businessSize = (int) Math.ceil((double) peakTPS * avgQueryTime / 1000);
        
        // å–ä¸¤è€…è¾ƒå¤§å€¼ï¼Œå¹¶åŠ ä¸Šä¸€å®šbuffer
        int recommendedSize = Math.max(basicSize, businessSize) + 2;
        
        return Math.min(recommendedSize, 50); // é€šå¸¸ä¸è¶…è¿‡50ä¸ªè¿æ¥
    }
}
```

**âš–ï¸ è¿æ¥æ•°é…ç½®å¯¹æ¯”**

| åœºæ™¯ç±»å‹ | **CPUæ ¸å¿ƒ** | **å¹¶å‘TPS** | **æœ€å°è¿æ¥** | **æœ€å¤§è¿æ¥** | **è¯´æ˜** |
|---------|-----------|-----------|------------|------------|---------|
| `å°å‹Webåº”ç”¨` | `4æ ¸` | `<100` | `2-5` | `10-15` | `å¤Ÿç”¨å³å¯ï¼Œé¿å…æµªè´¹èµ„æº` |
| `ä¸­å‹ä¸šåŠ¡ç³»ç»Ÿ` | `8æ ¸` | `100-500` | `5-10` | `20-30` | `é¢„ç•™bufferåº”å¯¹å³°å€¼` |
| `é«˜å¹¶å‘æœåŠ¡` | `16æ ¸` | `500-2000` | `10-20` | `30-50` | `ä¿è¯å³°å€¼æœŸé—´ç¨³å®šæœåŠ¡` |
| `å¤§å‹ä¼ä¸šåº”ç”¨` | `32æ ¸` | `>2000` | `20-30` | `50-100` | `åˆ†åº“åˆ†è¡¨ï¼Œå¤šè¿æ¥æ± ` |

**ğŸ’¡ é…ç½®åŸåˆ™è§£é‡Š**
```
ä¸ºä»€ä¹ˆä¸æ˜¯è¿æ¥æ•°è¶Šå¤šè¶Šå¥½ï¼Ÿ

æ•°æ®åº“è§’åº¦ï¼š
â€¢ æ¯ä¸ªè¿æ¥å ç”¨å†…å­˜ï¼ˆé€šå¸¸8-16KBï¼‰
â€¢ è¿æ¥æ•°è¿‡å¤šå¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
â€¢ MySQLé»˜è®¤æœ€å¤§è¿æ¥æ•°151ï¼ŒPostgreSQLé€šå¸¸100
â€¢ è¶…å‡ºæ•°æ®åº“é™åˆ¶ä¼šæ‹’ç»è¿æ¥

åº”ç”¨è§’åº¦ï¼š  
â€¢ è¿æ¥æ± ç»´æŠ¤æˆæœ¬éšè¿æ¥æ•°å¢åŠ 
â€¢ ç©ºé—²è¿æ¥å®šæœŸéªŒè¯æ¶ˆè€—èµ„æº
â€¢ è¿æ¥æ³„æ¼çš„å½±å“æ›´ä¸¥é‡

ç½‘ç»œè§’åº¦ï¼š
â€¢ æ¯ä¸ªè¿æ¥å ç”¨TCPç«¯å£å’Œsocket
â€¢ æ“ä½œç³»ç»Ÿæ–‡ä»¶å¥æŸ„æœ‰é™åˆ¶
â€¢ ç½‘ç»œæ•…éšœæ—¶é‡è¿é£æš´é£é™©
```

### 4.3 è¶…æ—¶å‚æ•°é…ç½®


**â° è¶…æ—¶å‚æ•°çš„ä¸šåŠ¡å«ä¹‰**

```java
// å„ç§è¶…æ—¶å‚æ•°çš„å®é™…æ„ä¹‰
public class TimeoutConfiguration {
    
    // è¿æ¥è·å–è¶…æ—¶ï¼šåº”ç”¨ç­‰å¾…è·å–è¿æ¥çš„æœ€é•¿æ—¶é—´
    // ä¸šåŠ¡å«ä¹‰ï¼šç”¨æˆ·ç­‰å¾…å“åº”çš„è€å¿ƒæ—¶é—´
    private int connectionTimeout = 30000; // 30ç§’
    
    // ç©ºé—²è¶…æ—¶ï¼šè¿æ¥åœ¨æ± ä¸­é—²ç½®å¤šä¹…åè¢«å›æ”¶
    // ä¸šåŠ¡å«ä¹‰ï¼šèµ„æºåˆ©ç”¨æ•ˆç‡ vs è¿æ¥å»ºç«‹æˆæœ¬
    private int idleTimeout = 600000;     // 10åˆ†é’Ÿ
    
    // æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼šè¿æ¥ä»åˆ›å»ºåˆ°å¼ºåˆ¶å›æ”¶çš„æ—¶é—´
    // ä¸šåŠ¡å«ä¹‰ï¼šé˜²æ­¢è¿æ¥é•¿æœŸå­˜åœ¨å¯¼è‡´çš„é—®é¢˜ï¼ˆå†…å­˜æ³„æ¼ã€æƒé™è¿‡æœŸç­‰ï¼‰
    private int maxLifetime = 1800000;    // 30åˆ†é’Ÿ
    
    // éªŒè¯è¶…æ—¶ï¼šæ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§çš„æœ€é•¿ç­‰å¾…æ—¶é—´
    // ä¸šåŠ¡å«ä¹‰ï¼šå¿«é€Ÿæ£€æµ‹åè¿æ¥ï¼Œé¿å…é˜»å¡ä¸šåŠ¡
    private int validationTimeout = 5000;  // 5ç§’
}
```

**âš ï¸ è¶…æ—¶é…ç½®çš„å¸¸è§é™·é˜±**

```
é™·é˜±1ï¼šconnectionTimeoutè®¾ç½®è¿‡å°
âŒ connectionTimeout = 1000 (1ç§’)
âœ… connectionTimeout = 30000 (30ç§’)

é—®é¢˜åˆ†æï¼š
â€¢ ç½‘ç»œæŠ–åŠ¨æˆ–æ•°æ®åº“è´Ÿè½½é«˜æ—¶ï¼Œ1ç§’å†…æ— æ³•è·å–è¿æ¥
â€¢ å¯¼è‡´å¤§é‡è¶…æ—¶é”™è¯¯ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
â€¢ æ¨èè®¾ç½®ä¸ºå¹³å‡å“åº”æ—¶é—´çš„3-5å€

é™·é˜±2ï¼šidleTimeoutä¸maxLifetimeå…³ç³»é”™è¯¯
âŒ idleTimeout = 1800000, maxLifetime = 600000
âœ… idleTimeout = 600000, maxLifetime = 1800000  

é—®é¢˜åˆ†æï¼š
â€¢ maxLifetimeå¿…é¡»å¤§äºidleTimeout
â€¢ å¦åˆ™è¿æ¥è¿˜æ²¡é—²ç½®å°±è¢«å¼ºåˆ¶å›æ”¶
â€¢ è¿åäº†è¿æ¥å¤ç”¨çš„åˆè¡·

é™·é˜±3ï¼švalidationTimeoutè®¾ç½®è¿‡é•¿
âŒ validationTimeout = 30000 (30ç§’)
âœ… validationTimeout = 5000 (5ç§’)

é—®é¢˜åˆ†æï¼š
â€¢ éªŒè¯æœ¬èº«æ˜¯å¿«é€Ÿæ“ä½œï¼Œä¸åº”è¯¥ç­‰å¾…å¤ªä¹…
â€¢ é•¿æ—¶é—´éªŒè¯ä¼šé˜»å¡è¿æ¥è·å–
â€¢ é€šå¸¸ç½‘ç»œé—®é¢˜åœ¨å‡ ç§’å†…å°±èƒ½ç¡®å®š
```

### 4.4 è¿æ¥éªŒè¯å‚æ•°


**ğŸ” è¿æ¥éªŒè¯ç­–ç•¥**

```java
// è¿æ¥éªŒè¯çš„ä¸åŒæ—¶æœºå’Œç­–ç•¥
public class ValidationStrategy {
    
    // ç­–ç•¥1ï¼šè·å–æ—¶éªŒè¯ï¼ˆtestOnBorrowï¼‰
    // ä¼˜ç‚¹ï¼šç¡®ä¿ç»™åº”ç”¨çš„è¿æ¥ä¸€å®šå¯ç”¨
    // ç¼ºç‚¹ï¼šæ¯æ¬¡è·å–éƒ½è¦éªŒè¯ï¼Œæ€§èƒ½å¼€é”€å¤§
    private boolean testOnBorrow = false;  // é€šå¸¸å…³é—­
    
    // ç­–ç•¥2ï¼šå½’è¿˜æ—¶éªŒè¯ï¼ˆtestOnReturnï¼‰  
    // ä¼˜ç‚¹ï¼šé˜²æ­¢åè¿æ¥å›åˆ°æ± ä¸­
    // ç¼ºç‚¹ï¼šå½’è¿˜æ—¶éªŒè¯æ„ä¹‰ä¸å¤§ï¼Œå¼€é”€å¢åŠ 
    private boolean testOnReturn = false;  // é€šå¸¸å…³é—­
    
    // ç­–ç•¥3ï¼šç©ºé—²æ—¶éªŒè¯ï¼ˆtestWhileIdleï¼‰- æ¨è
    // ä¼˜ç‚¹ï¼šåå°å®šæœŸæ¸…ç†åè¿æ¥ï¼Œå¯¹æ€§èƒ½å½±å“å°
    // ç¼ºç‚¹ï¼šå¯èƒ½è·å–åˆ°åˆšåæ‰ä½†è¿˜æ²¡éªŒè¯çš„è¿æ¥
    private boolean testWhileIdle = true;   // æ¨èå¼€å¯
    
    // éªŒè¯æŸ¥è¯¢SQL
    private String validationQuery = "SELECT 1";
    
    // ç°ä»£JDBCçš„isValidæ–¹æ³•ï¼ˆæ¨èï¼‰
    // æ¯”æ‰§è¡ŒSQLæ›´é«˜æ•ˆï¼Œä½†éœ€è¦JDBC 4.0+æ”¯æŒ
    private boolean useIsValid = true;
}
```

**âš¡ é«˜æ•ˆéªŒè¯æŸ¥è¯¢è®¾è®¡**

| æ•°æ®åº“ | **æ¨èéªŒè¯SQL** | **æ‰§è¡Œæ—¶é—´** | **è¯´æ˜** |
|-------|----------------|-------------|---------|
| `MySQL` | `SELECT 1` | `<1ms` | `æœ€ç®€å•æœ‰æ•ˆçš„éªŒè¯` |
| `PostgreSQL` | `SELECT 1` | `<1ms` | `æ ‡å‡†SQLï¼Œé€šç”¨æ€§å¥½` |  
| `Oracle` | `SELECT 1 FROM DUAL` | `<1ms` | `Oracleç‰¹æœ‰çš„DUALè¡¨` |
| `SQL Server` | `SELECT 1` | `<1ms` | `æ”¯æŒæ ‡å‡†è¯­æ³•` |
| `æ‰€æœ‰æ•°æ®åº“` | `Connection.isValid()` | `<1ms` | `JDBC 4.0+æ¨èæ–¹å¼` |

```java
// éªŒè¯æŸ¥è¯¢çš„æ€§èƒ½å¯¹æ¯”
public class ValidationPerformance {
    
    // âŒ å¤æ‚éªŒè¯æŸ¥è¯¢ - ä¸æ¨è
    String badValidation = """
        SELECT COUNT(*) FROM information_schema.tables 
        WHERE table_schema = DATABASE()
        """;
    // é—®é¢˜ï¼šæŸ¥è¯¢å¤æ‚ï¼Œæ‰§è¡Œæ—¶é—´é•¿ï¼Œå¯èƒ½å› æƒé™é—®é¢˜å¤±è´¥
    
    // âœ… ç®€å•éªŒè¯æŸ¥è¯¢ - æ¨è
    String goodValidation = "SELECT 1";
    // ä¼˜ç‚¹ï¼šæ‰§è¡Œæå¿«ï¼Œä¸æ¶‰åŠä¸šåŠ¡è¡¨ï¼Œæƒé™è¦æ±‚æœ€ä½
    
    // âœ… JDBC 4.0æ–¹å¼ - æœ€æ¨è
    public boolean isConnectionValid(Connection conn) {
        try {
            return conn.isValid(5); // 5ç§’è¶…æ—¶
        } catch (SQLException e) {
            return false;
        }
    }
}
```

---

## 5. â±ï¸ è¿æ¥è·å–è¶…æ—¶æ§åˆ¶


### 5.1 è¶…æ—¶æ§åˆ¶çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶**
è¶…æ—¶æ§åˆ¶å°±åƒæ’é˜Ÿä¹°ç¥¨æ—¶çš„"æœ€é•¿ç­‰å¾…æ—¶é—´"ï¼Œå¦‚æœæ’é˜Ÿæ—¶é—´è¶…è¿‡é¢„æœŸï¼Œå°±æ”¾å¼ƒæ’é˜Ÿå»åšå…¶ä»–äº‹æƒ…ï¼Œé¿å…æ— é™ç­‰å¾…ã€‚

```
æ— è¶…æ—¶æ§åˆ¶çš„é—®é¢˜åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¯·æ±‚è¿æ¥     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  è¿æ¥æ±      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ (å·²æ»¡ï¼Œæ— ç©ºé—²) â”‚
      â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                            â”‚
      â–¼                            â–¼
   ä¸€ç›´ç­‰å¾…...                  å…¶ä»–è¯·æ±‚ä¹Ÿåœ¨æ’é˜Ÿ...
      â”‚                            â”‚
      â–¼                            â–¼
   ç”¨æˆ·è¶…æ—¶                     ç³»ç»Ÿé›ªå´©
   æµè§ˆå™¨ç™½å±                    æœåŠ¡å™¨å®•æœº

æœ‰è¶…æ—¶æ§åˆ¶çš„æ”¹è¿›ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¯·æ±‚è¿æ¥     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  è¿æ¥æ±      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ (å·²æ»¡ï¼Œæ— ç©ºé—²) â”‚
      â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                            â”‚
      â–¼                            â”‚
  ç­‰å¾…3ç§’å                        â”‚ 
      â”‚                            â”‚
      â–¼                            â–¼
   è¿”å›é”™è¯¯                      å¿«é€Ÿå¤±è´¥
   æç¤ºç”¨æˆ·é‡è¯•                   ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
```

### 5.2 è¶…æ—¶æ§åˆ¶å®ç°æœºåˆ¶


**âš™ï¸ ä¸åŒå±‚æ¬¡çš„è¶…æ—¶æ§åˆ¶**

```java
// å¤šå±‚è¶…æ—¶æ§åˆ¶ç¤ºä¾‹
public class TimeoutControlDemo {
    
    // ç¬¬1å±‚ï¼šè¿æ¥æ± è·å–è¶…æ—¶
    @Bean
    public HikariConfig hikariConfig() {
        HikariConfig config = new HikariConfig();
        
        // è¿æ¥æ± å±‚é¢è¶…æ—¶ï¼šè·å–è¿æ¥çš„ç­‰å¾…æ—¶é—´
        config.setConnectionTimeout(30000); // 30ç§’
        
        // è¿™ä¸ªè¶…æ—¶æ§åˆ¶çš„æ˜¯ï¼š
        // å½“è¿æ¥æ± æ— å¯ç”¨è¿æ¥æ—¶ï¼Œæ–°è¯·æ±‚ç­‰å¾…çš„æœ€é•¿æ—¶é—´
        return config;
    }
    
    // ç¬¬2å±‚ï¼šæ•°æ®åº“æ“ä½œè¶…æ—¶
    public List<User> getUsersWithTimeout() {
        try (Connection conn = dataSource.getConnection()) {
            
            // è¯­å¥æ‰§è¡Œè¶…æ—¶ï¼šå•ä¸ªSQLçš„æœ€é•¿æ‰§è¡Œæ—¶é—´
            String sql = "SELECT * FROM users";
            try (PreparedStatement stmt = conn.prepareStatement(sql)) {
                stmt.setQueryTimeout(15); // 15ç§’æŸ¥è¯¢è¶…æ—¶
                
                try (ResultSet rs = stmt.executeQuery()) {
                    return processResultSet(rs);
                }
            }
        } catch (SQLException e) {
            if (e instanceof SQLTimeoutException) {
                // æŸ¥è¯¢è¶…æ—¶ï¼Œå¯èƒ½æ˜¯æ…¢SQLæˆ–æ•°æ®åº“è´Ÿè½½é«˜
                throw new BusinessException("æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
            }
            throw new RuntimeException("æ•°æ®åº“æ“ä½œå¤±è´¥", e);
        }
    }
    
    // ç¬¬3å±‚ï¼šHTTPè¯·æ±‚è¶…æ—¶ï¼ˆSpring Bootï¼‰
    @RequestMapping("/users")
    @ResponseBody
    public ResponseEntity<List<User>> getUsers() {
        try {
            List<User> users = getUsersWithTimeout();
            return ResponseEntity.ok(users);
        } catch (BusinessException e) {
            return ResponseEntity.status(HttpStatus.REQUEST_TIMEOUT)
                               .body(null);
        }
    }
}
```

### 5.3 è¶…æ—¶å‚æ•°è°ƒä¼˜ç­–ç•¥


**ğŸ“Š è¶…æ—¶æ—¶é—´è®¾è®¡åŸåˆ™**

```
è¶…æ—¶æ—¶é—´å±‚çº§å…³ç³»ï¼š
HTTPè¯·æ±‚è¶…æ—¶ > æ•°æ®åº“æ“ä½œè¶…æ—¶ > è¿æ¥è·å–è¶…æ—¶ > è¿æ¥éªŒè¯è¶…æ—¶

ç¤ºä¾‹é…ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTPè¯·æ±‚è¶…æ—¶: 60ç§’                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚ æ•°æ®åº“æ“ä½œè¶…æ—¶: 45ç§’                  â”‚  â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚ â”‚ â”‚ è¿æ¥è·å–è¶…æ—¶: 30ç§’                â”‚  â”‚  â”‚
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚ â”‚ â”‚ â”‚ è¿æ¥éªŒè¯è¶…æ—¶: 5ç§’             â”‚  â”‚  â”‚  â”‚
â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾è®¡ç†ç”±ï¼š
â€¢ å†…å±‚è¶…æ—¶è¦ç»™å¤–å±‚ç•™å‡ºå¤„ç†æ—¶é—´
â€¢ éªŒè¯è¶…æ—¶æœ€çŸ­ï¼Œå¿«é€Ÿæ£€æµ‹è¿æ¥çŠ¶æ€
â€¢ è¿æ¥è·å–è¶…æ—¶é€‚ä¸­ï¼Œå¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿä¿æŠ¤
â€¢ ä¸šåŠ¡æ“ä½œè¶…æ—¶è¾ƒé•¿ï¼Œå…è®¸å¤æ‚æŸ¥è¯¢å®Œæˆ
â€¢ HTTPè¶…æ—¶æœ€é•¿ï¼Œç»™å®Œæ•´è¯·æ±‚æµç¨‹é¢„ç•™æ—¶é—´
```

**ğŸ¯ ä¸åŒä¸šåŠ¡åœºæ™¯çš„è¶…æ—¶é…ç½®**

| ä¸šåŠ¡åœºæ™¯ | **è¿æ¥è·å–è¶…æ—¶** | **æŸ¥è¯¢è¶…æ—¶** | **HTTPè¶…æ—¶** | **ç†ç”±** |
|---------|----------------|------------|-------------|---------|
| `ç”¨æˆ·ç™»å½•` | `5ç§’` | `3ç§’` | `10ç§’` | `å¿«é€Ÿå“åº”ï¼Œé¿å…ç”¨æˆ·ç­‰å¾…` |
| `å•†å“æŸ¥è¯¢` | `10ç§’` | `8ç§’` | `15ç§’` | `å…è®¸ç´¢å¼•æŸ¥è¯¢æ—¶é—´` |
| `è®¢å•å¤„ç†` | `15ç§’` | `10ç§’` | `30ç§’` | `æ¶‰åŠå¤šè¡¨æ“ä½œï¼Œéœ€è¦æ›´å¤šæ—¶é—´` |
| `æŠ¥è¡¨ç”Ÿæˆ` | `30ç§’` | `120ç§’` | `180ç§’` | `å¤æ‚èšåˆæŸ¥è¯¢ï¼Œå…è®¸è¾ƒé•¿æ—¶é—´` |
| `æ•°æ®å¯¼å…¥` | `60ç§’` | `300ç§’` | `600ç§’` | `æ‰¹é‡æ“ä½œï¼Œéœ€è¦å……åˆ†æ—¶é—´` |

### 5.4 è¶…æ—¶å¼‚å¸¸å¤„ç†ç­–ç•¥


**ğŸš¨ è¶…æ—¶å¼‚å¸¸çš„åˆ†ç±»å¤„ç†**

```java
public class TimeoutExceptionHandler {
    
    public void handleDatabaseTimeout(Exception e) {
        if (e instanceof SQLTimeoutException) {
            // SQLæ‰§è¡Œè¶…æ—¶
            handleSQLTimeout((SQLTimeoutException) e);
        } else if (e.getCause() instanceof SocketTimeoutException) {
            // ç½‘ç»œè¶…æ—¶
            handleNetworkTimeout(e);
        } else if (e.getMessage().contains("timeout")) {
            // è¿æ¥æ± è·å–è¶…æ—¶
            handlePoolTimeout(e);
        } else {
            // å…¶ä»–å¼‚å¸¸
            handleGenericException(e);
        }
    }
    
    private void handleSQLTimeout(SQLTimeoutException e) {
        // SQLè¶…æ—¶é€šå¸¸æ˜¯æ…¢æŸ¥è¯¢å¯¼è‡´
        // è®°å½•æ…¢SQLï¼Œç”¨äºåç»­ä¼˜åŒ–
        logSlowQuery(getCurrentSQL(), e);
        
        // ç»™ç”¨æˆ·å‹å¥½æç¤º
        throw new BusinessException("æŸ¥è¯¢æ•°æ®è¾ƒå¤šï¼Œè¯·ç¨åé‡è¯•æˆ–ç¼©å°æŸ¥è¯¢èŒƒå›´");
    }
    
    private void handlePoolTimeout(Exception e) {
        // è¿æ¥æ± è¶…æ—¶é€šå¸¸æ˜¯å¹¶å‘è¿‡é«˜
        // è®°å½•é«˜å¹¶å‘å‘Šè­¦
        alertHighConcurrency();
        
        // å»ºè®®ç”¨æˆ·ç¨åé‡è¯•
        throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    private void handleNetworkTimeout(Exception e) {
        // ç½‘ç»œè¶…æ—¶å¯èƒ½æ˜¯æ•°æ®åº“å®•æœºæˆ–ç½‘ç»œé—®é¢˜
        // è§¦å‘æ•°æ®åº“å¥åº·æ£€æŸ¥
        triggerHealthCheck();
        
        // å¯ç”¨é™çº§æœåŠ¡
        throw new BusinessException("ç½‘ç»œå¼‚å¸¸ï¼Œå·²å¯ç”¨ç¼“å­˜æœåŠ¡");
    }
}
```

**ğŸ’¡ è¶…æ—¶é‡è¯•ç­–ç•¥**

```java
// æ™ºèƒ½é‡è¯•æœºåˆ¶
@Component  
public class SmartRetryService {
    
    @Retryable(
        value = {SQLTimeoutException.class, SocketTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2) // 1s, 2s, 4s
    )
    public List<User> getUsersWithRetry() {
        return userRepository.findAll();
    }
    
    @Recover
    public List<User> recover(Exception e) {
        // é‡è¯•å¤±è´¥åçš„é™çº§å¤„ç†
        logger.error("æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå¯ç”¨ç¼“å­˜æ•°æ®", e);
        return getCachedUsers();
    }
    
    private List<User> getCachedUsers() {
        // ä»ç¼“å­˜è·å–æ•°æ®
        return cacheService.getUsers();
    }
}
```

---

## 6. âœ… è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹


**ğŸ”¸ è¿æ¥å¤±æ•ˆçš„å¸¸è§åœºæ™¯**
æ•°æ®åº“è¿æ¥å°±åƒç”µè¯çº¿è·¯ï¼Œçœ‹èµ·æ¥è¿ç€ä½†å¯èƒ½å·²ç»"æ–­çº¿"äº†ã€‚åº”ç”¨ä»¥ä¸ºè¿æ¥æ­£å¸¸ï¼Œå®é™…ä¸Šæ•°æ®åº“é‚£è¾¹æ—©å°±æŒ‚æ–­äº†ç”µè¯ã€‚

```
è¿æ¥å¤±æ•ˆçš„å…¸å‹åœºæ™¯ï¼š
åœºæ™¯1ï¼šæ•°æ®åº“é‡å¯
åº”ç”¨è¿æ¥æ±  â”€â”€â”€â”€â”€â”€â”€â”€Xâ”€â”€â”€â”€â”€â”€ æ•°æ®åº“æœåŠ¡
              â”‚
            è¿æ¥æ–­å¼€ï¼Œä½†åº”ç”¨ä¸çŸ¥é“

åœºæ™¯2ï¼šç½‘ç»œæŠ–åŠ¨  
åº”ç”¨ â”€â”€â”      â”Œâ”€â”€ æ•°æ®åº“
      â”‚ ç½‘ç»œè®¾å¤‡ â”‚
      â””â”€Xâ”€â”€é‡å¯â”€â”€â”˜
        â”‚
    è¿æ¥é‡ç½®ï¼ŒTCPè¿æ¥æ–­å¼€

åœºæ™¯3ï¼šç©ºé—²è¶…æ—¶
åº”ç”¨è¿æ¥ â”€â”€â”€â”€ é•¿æ—¶é—´æ— æ•°æ® â”€â”€â”€â”€ æ•°æ®åº“
        â”‚                    â”‚
      ç©ºé—²è¿æ¥             è‡ªåŠ¨æ–­å¼€
                          (wait_timeout)

åœºæ™¯4ï¼šé˜²ç«å¢™å¹²é¢„
åº”ç”¨ â”€â”€â”€â”€â”€â”€ é˜²ç«å¢™ â”€â”€â”€â”€â”€â”€ æ•°æ®åº“  
         â”‚            â”‚
    NATè¡¨æ¸…ç†      è¿æ¥çŠ¶æ€ä¸¢å¤±
```

**âš ï¸ ä½¿ç”¨æ— æ•ˆè¿æ¥çš„åæœ**

```java
// æ— æ•ˆè¿æ¥å¯¼è‡´çš„å…¸å‹é—®é¢˜
public class InvalidConnectionProblems {
    
    public void demonstrateProblems() {
        Connection conn = null;
        try {
            // ä»è¿æ¥æ± è·å–è¿æ¥
            conn = dataSource.getConnection();
            
            // è¿æ¥çœ‹èµ·æ¥æ­£å¸¸ï¼Œå®é™…å·²å¤±æ•ˆ
            if (!conn.isClosed()) {  // è¿™ä¸ªæ£€æŸ¥æ˜¯ä¸å¤Ÿçš„ï¼
                // æ‰§è¡ŒSQLæ—¶æ‰å‘ç°è¿æ¥å·²æ–­å¼€
                PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users");
                ResultSet rs = stmt.executeQuery();  // è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼
            }
            
        } catch (SQLException e) {
            // å…¸å‹çš„å¼‚å¸¸ä¿¡æ¯ï¼š
            // "Communications link failure"
            // "Connection is closed"
            // "No operations allowed after connection closed"
            
            throw new RuntimeException("è¿æ¥å¼‚å¸¸ï¼š" + e.getMessage(), e);
        }
    }
}
```

### 6.2 è¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹æ–¹æ³•


**ğŸ” ä¸åŒçš„æ£€æµ‹æ–¹æ³•å¯¹æ¯”**

```java
public class ConnectionValidationMethods {
    
    // æ–¹æ³•1ï¼šisClosed()æ£€æŸ¥ - ä¸å¯é 
    public boolean method1_isClosed(Connection conn) {
        try {
            return !conn.isClosed();
        } catch (SQLException e) {
            return false;
        }
        // é—®é¢˜ï¼šåªæ£€æŸ¥æœ¬åœ°çŠ¶æ€ï¼Œæ— æ³•æ£€æµ‹ç½‘ç»œä¸­æ–­
    }
    
    // æ–¹æ³•2ï¼šæ‰§è¡ŒéªŒè¯SQL - ä¼ ç»Ÿæ–¹æ³•
    public boolean method2_validationQuery(Connection conn) {
        try (PreparedStatement stmt = conn.prepareStatement("SELECT 1");
             ResultSet rs = stmt.executeQuery()) {
            return rs.next();
        } catch (SQLException e) {
            return false;
        }
        // ä¼˜ç‚¹ï¼šçœŸæ­£æµ‹è¯•æ•°æ®åº“è¿é€šæ€§
        // ç¼ºç‚¹ï¼šéœ€è¦ç½‘ç»œå¾€è¿”ï¼Œæœ‰æ€§èƒ½å¼€é”€
    }
    
    // æ–¹æ³•3ï¼šJDBC 4.0 isValid() - æ¨èæ–¹æ³•
    public boolean method3_isValid(Connection conn, int timeoutSeconds) {
        try {
            return conn.isValid(timeoutSeconds);
        } catch (SQLException e) {
            return false;
        }
        // ä¼˜ç‚¹ï¼šJDBCæ ‡å‡†æ–¹æ³•ï¼Œæ€§èƒ½é€šå¸¸æ¯”SQLæŸ¥è¯¢å¥½
        // æ”¯æŒè¶…æ—¶æ§åˆ¶ï¼Œé˜²æ­¢éªŒè¯è¿‡ç¨‹é˜»å¡
    }
    
    // æ–¹æ³•4ï¼šç»¼åˆæ£€æµ‹ - æœ€å…¨é¢
    public boolean method4_comprehensive(Connection conn) {
        try {
            // ç¬¬ä¸€æ­¥ï¼šåŸºç¡€æ£€æŸ¥
            if (conn == null || conn.isClosed()) {
                return false;
            }
            
            // ç¬¬äºŒæ­¥ï¼šç½‘ç»œè¿é€šæ€§æ£€æŸ¥
            if (!conn.isValid(3)) {  // 3ç§’è¶…æ—¶
                return false;
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šäº‹åŠ¡çŠ¶æ€æ£€æŸ¥
            if (conn.getAutoCommit() == false && !conn.getMetaData().supportsTransactions()) {
                return false;
            }
            
            return true;
        } catch (SQLException e) {
            return false;
        }
    }
}
```

### 6.3 æ£€æµ‹æ—¶æœºçš„é€‰æ‹©


**â° ä¸åŒæ£€æµ‹æ—¶æœºçš„ä¼˜ç¼ºç‚¹**

```
è¿æ¥éªŒè¯æ—¶æœºå¯¹æ¯”å›¾ï¼š
                è·å–è¿æ¥
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     
         â”Œâ”€â–¶â”‚ è·å–æ—¶éªŒè¯   â”‚ â† testOnBorrow
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     
         â”‚         â”‚            
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â–¼            
   â”‚ è¿æ¥æ±   â”‚  åº”ç”¨ä½¿ç”¨è¿æ¥        
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚            
         â”‚         â–¼            
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     
         â””â”€â–¶â”‚ å½’è¿˜æ—¶éªŒè¯   â”‚ â† testOnReturn
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     
                   â”‚            
                   â–¼            
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     
            â”‚ ç©ºé—²æ—¶éªŒè¯   â”‚ â† testWhileIdle (æ¨è)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     
```

**ğŸ¯ æ¨èçš„æ£€æµ‹ç­–ç•¥é…ç½®**

```java
// æœ€ä½³å®è·µé…ç½®
@Configuration
public class OptimalValidationConfig {
    
    @Bean
    public HikariConfig hikariConfig() {
        HikariConfig config = new HikariConfig();
        
        // âœ… æ¨èï¼šå…³é—­è·å–æ—¶éªŒè¯
        // åŸå› ï¼šå½±å“æ€§èƒ½ï¼Œç°ä»£è¿æ¥æ± æœ‰æ›´å¥½çš„ç­–ç•¥
        // config.setConnectionTestQuery(null);
        
        // âœ… æ¨èï¼šä½¿ç”¨isValidæ–¹æ³•
        // åŸå› ï¼šæ¯”SQLæŸ¥è¯¢æ›´é«˜æ•ˆï¼ŒJDBC 4.0æ ‡å‡†
        config.setValidationTimeout(5000);  // 5ç§’éªŒè¯è¶…æ—¶
        
        // âœ… æ¨èï¼šåˆç†çš„ç”Ÿå­˜æ—¶é—´
        // åŸå› ï¼šå®šæœŸæ›´æ–°è¿æ¥ï¼Œé˜²æ­¢é•¿æœŸè¿æ¥çš„é—®é¢˜
        config.setMaxLifetime(1800000);     // 30åˆ†é’Ÿ
        config.setIdleTimeout(600000);      // 10åˆ†é’Ÿç©ºé—²è¶…æ—¶
        
        // âœ… æ¨èï¼šå¯ç”¨è¿æ¥æ³„æ¼æ£€æµ‹
        config.setLeakDetectionThreshold(60000); // 1åˆ†é’Ÿ
        
        return config;
    }
}

// å¯¹äºéœ€è¦æ›´ä¸¥æ ¼éªŒè¯çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰
@Configuration
@Profile("production")
public class StrictValidationConfig {
    
    @Bean
    public DruidDataSource strictDataSource() {
        DruidDataSource ds = new DruidDataSource();
        
        // ä¸¥æ ¼æ¨¡å¼ï¼šå¼€å¯å¤šé‡éªŒè¯
        ds.setTestWhileIdle(true);          // ç©ºé—²æ—¶éªŒè¯
        ds.setTestOnBorrow(true);           // è·å–æ—¶éªŒè¯ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
        ds.setValidationQuery("SELECT 1");
        ds.setValidationQueryTimeout(3);
        
        // æ›´é¢‘ç¹çš„æ£€æµ‹
        ds.setTimeBetweenEvictionRunsMillis(30000); // 30ç§’æ£€æµ‹ä¸€æ¬¡
        ds.setMinEvictableIdleTimeMillis(180000);   // 3åˆ†é’Ÿç©ºé—²å›æ”¶
        
        return ds;
    }
}
```

### 6.4 æ£€æµ‹å¤±è´¥çš„å¤„ç†ç­–ç•¥


**ğŸš¨ è¿æ¥æ£€æµ‹å¤±è´¥çš„åº”å¯¹æ–¹æ¡ˆ**

```java
public class ValidationFailureHandler {
    
    // æ£€æµ‹å¤±è´¥åçš„å¤„ç†æµç¨‹
    public Connection handleValidationFailure(Connection invalidConn) {
        // ç¬¬1æ­¥ï¼šè®°å½•å¤±è´¥ä¿¡æ¯
        logValidationFailure(invalidConn);
        
        // ç¬¬2æ­¥ï¼šå…³é—­æ— æ•ˆè¿æ¥
        closeInvalidConnection(invalidConn);
        
        // ç¬¬3æ­¥ï¼šå°è¯•è·å–æ–°è¿æ¥
        return attemptNewConnection();
    }
    
    private void logValidationFailure(Connection conn) {
        try {
            String url = conn.getMetaData().getURL();
            logger.warn("è¿æ¥éªŒè¯å¤±è´¥ï¼ŒURL: {}, è¿æ¥ä¿¡æ¯: {}", url, conn.toString());
            
            // è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
            meterRegistry.counter("db.connection.validation.failure").increment();
            
        } catch (SQLException e) {
            logger.error("è®°å½•è¿æ¥éªŒè¯å¤±è´¥ä¿¡æ¯æ—¶å‡ºé”™", e);
        }
    }
    
    private Connection attemptNewConnection() {
        int maxAttempts = 3;
        int attempt = 0;
        
        while (attempt < maxAttempts) {
            try {
                Connection newConn = dataSource.getConnection();
                
                // éªŒè¯æ–°è¿æ¥
                if (newConn.isValid(5)) {
                    logger.info("æˆåŠŸè·å–æ–°çš„æœ‰æ•ˆè¿æ¥ï¼Œå°è¯•æ¬¡æ•°: {}", attempt + 1);
                    return newConn;
                } else {
                    logger.warn("æ–°è¿æ¥éªŒè¯å¤±è´¥ï¼Œç»§ç»­é‡è¯•");
                    newConn.close();
                }
                
            } catch (SQLException e) {
                logger.error("è·å–æ–°è¿æ¥å¤±è´¥ï¼Œå°è¯•æ¬¡æ•°: {}", attempt + 1, e);
            }
            
            attempt++;
            
            // é‡è¯•å»¶è¿Ÿ
            try {
                Thread.sleep(1000 * attempt); // é€’å¢å»¶è¿Ÿ
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("è¿æ¥é‡è¯•è¢«ä¸­æ–­", e);
            }
        }
        
        throw new RuntimeException("è¿æ¥éªŒè¯å¤±è´¥åæ— æ³•è·å–æœ‰æ•ˆè¿æ¥");
    }
}
```

**ğŸ“Š éªŒè¯å¤±è´¥ç»Ÿè®¡å’Œå‘Šè­¦**

```java
// è¿æ¥å¥åº·åº¦ç›‘æ§
@Component
public class ConnectionHealthMonitor {
    
    private final MeterRegistry meterRegistry;
    private final AtomicLong validationFailureCount = new AtomicLong(0);
    
    @EventListener
    public void onValidationFailure(ConnectionValidationFailureEvent event) {
        long failureCount = validationFailureCount.incrementAndGet();
        
        // æ›´æ–°æŒ‡æ ‡
        Gauge.builder("db.connection.validation.failure.count")
             .register(meterRegistry, () -> failureCount);
        
        // è¾¾åˆ°å‘Šè­¦é˜ˆå€¼
        if (failureCount > 10) {  // è¿ç»­10æ¬¡å¤±è´¥
            sendAlert("æ•°æ®åº“è¿æ¥éªŒè¯å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼š" + failureCount);
            
            // é‡ç½®è®¡æ•°å™¨
            validationFailureCount.set(0);
        }
    }
    
    private void sendAlert(String message) {
        // å‘é€å‘Šè­¦åˆ°ç›‘æ§ç³»ç»Ÿ
        alertService.sendAlert(AlertLevel.HIGH, "æ•°æ®åº“è¿æ¥", message);
    }
    
    // å®šæœŸé‡ç½®å¤±è´¥è®¡æ•°ï¼ˆé¿å…å¶å‘å¤±è´¥å½±å“å‘Šè­¦ï¼‰
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿ
    public void resetFailureCount() {
        if (validationFailureCount.get() < 5) {
            validationFailureCount.set(0);
        }
    }
}
```

---

## 7. ğŸ”¥ è¿æ¥æ± é¢„çƒ­æœºåˆ¶


### 7.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± é¢„çƒ­


**ğŸ”¸ é¢„çƒ­çš„æ¦‚å¿µ**
è¿æ¥æ± é¢„çƒ­å°±åƒå†¬å¤©æå‰å¼€æš–æ°”ä¸€æ ·ï¼Œåœ¨çœŸæ­£éœ€è¦ä¹‹å‰ï¼Œå…ˆæŠŠè¿æ¥å‡†å¤‡å¥½ï¼Œé¿å…ç¬¬ä¸€æ‰¹ç”¨æˆ·ç­‰å¾…è¿æ¥å»ºç«‹çš„æ—¶é—´ã€‚

```
é¢„çƒ­å‰åå¯¹æ¯”ï¼š
ä¸é¢„çƒ­çš„æƒ…å†µï¼š                    é¢„çƒ­åçš„æƒ…å†µï¼š
åº”ç”¨å¯åŠ¨                        åº”ç”¨å¯åŠ¨
   â”‚                              â”‚
   â–¼                              â–¼
è¿æ¥æ± åˆå§‹åŒ–                    è¿æ¥æ± åˆå§‹åŒ– + é¢„åˆ›å»ºè¿æ¥
(è¿æ¥æ•° = 0)                    (è¿æ¥æ•° = minimumIdle)
   â”‚                              â”‚
   â–¼                              â–¼
ç¬¬1ä¸ªç”¨æˆ·è¯·æ±‚ â”€â”€â”                 ç¬¬1ä¸ªç”¨æˆ·è¯·æ±‚
              â”‚                     â”‚
              â–¼                     â–¼
         éœ€è¦ç­‰å¾…å»ºè¿                ç›´æ¥è·å–è¿æ¥
         (200-500ms)                (1-5ms)
              â”‚                     â”‚
              â–¼                     â–¼
         ç”¨æˆ·æ„Ÿè§‰å¡é¡¿                å“åº”è¿…é€Ÿ
```

### 7.2 é¢„çƒ­ç­–ç•¥å®ç°


**ğŸš€ é¢„çƒ­å®ç°æ–¹æ³•**

```java
// æ–¹æ³•1ï¼šè¿æ¥æ± è‡ªå¸¦çš„é¢„çƒ­é…ç½®
@Configuration
public class WarmupConfig {
    
    @Bean
    public HikariConfig hikariConfig() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€é…ç½®
        config.setJdbcUrl("jdbc:mysql://localhost:3306/testdb");
        config.setUsername("root");
        config.setPassword("password");
        
        // é¢„çƒ­é…ç½®
        config.setMinimumIdle(5);           // æœ€å°è¿æ¥æ•°ï¼Œå¯åŠ¨æ—¶åˆ›å»º
        config.setMaximumPoolSize(20);      // æœ€å¤§è¿æ¥æ•°
        config.setInitializationFailTimeout(30000); // åˆå§‹åŒ–è¶…æ—¶30ç§’
        
        return config;
    }
}

// æ–¹æ³•2ï¼šåº”ç”¨å¯åŠ¨æ—¶æ‰‹åŠ¨é¢„çƒ­
@Component
public class ConnectionPoolWarmup {
    
    private final DataSource dataSource;
    
    public ConnectionPoolWarmup(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    @EventListener(ApplicationReadyEvent.class)
    public void warmupConnectionPool() {
        logger.info("å¼€å§‹è¿æ¥æ± é¢„çƒ­...");
        
        int warmupConnections = 5;
        List<Connection> connections = new ArrayList<>();
        
        try {
            // é¢„å…ˆè·å–è¿æ¥
            for (int i = 0; i < warmupConnections; i++) {
                Connection conn = dataSource.getConnection();
                connections.add(conn);
                
                // éªŒè¯è¿æ¥æœ‰æ•ˆæ€§
                if (conn.isValid(5)) {
                    logger.debug("é¢„çƒ­è¿æ¥ {} åˆ›å»ºæˆåŠŸ", i + 1);
                } else {
                    logger.warn("é¢„çƒ­è¿æ¥ {} éªŒè¯å¤±è´¥", i + 1);
                }
            }
            
            logger.info("è¿æ¥æ± é¢„çƒ­å®Œæˆï¼Œé¢„çƒ­è¿æ¥æ•°ï¼š{}", connections.size());
            
        } catch (SQLException e) {
            logger.error("è¿æ¥æ± é¢„çƒ­å¤±è´¥", e);
        } finally {
            // å½’è¿˜æ‰€æœ‰è¿æ¥
            for (Connection conn : connections) {
                try {
                    if (conn != null && !conn.isClosed()) {
                        conn.close(); // å½’è¿˜åˆ°æ± ä¸­
                    }
                } catch (SQLException e) {
                    logger.error("å½’è¿˜é¢„çƒ­è¿æ¥å¤±è´¥", e);
                }
            }
        }
    }
}
```

### 7.3 é«˜çº§é¢„çƒ­ç­–ç•¥


**âš¡ æ¸è¿›å¼é¢„çƒ­**

```java
// æ¸è¿›å¼é¢„çƒ­ï¼šé¿å…å¯åŠ¨æ—¶ç¬é—´å‹åŠ›è¿‡å¤§
@Component
public class GradualWarmupService {
    
    private final DataSource dataSource;
    private final ScheduledExecutorService warmupExecutor;
    
    public GradualWarmupService(DataSource dataSource) {
        this.dataSource = dataSource;
        this.warmupExecutor = Executors.newSingleThreadScheduledExecutor(
            r -> new Thread(r, "connection-warmup"));
    }
    
    @PostConstruct
    public void startGradualWarmup() {
        // å¯åŠ¨å2ç§’å¼€å§‹é¢„çƒ­ï¼Œé¿å…ä¸å…¶ä»–åˆå§‹åŒ–å†²çª
        warmupExecutor.schedule(this::executeGradualWarmup, 2, TimeUnit.SECONDS);
    }
    
    private void executeGradualWarmup() {
        logger.info("å¼€å§‹æ¸è¿›å¼è¿æ¥æ± é¢„çƒ­");
        
        // é˜¶æ®µ1ï¼šåˆ›å»ºæ ¸å¿ƒè¿æ¥ï¼ˆå³æ—¶åˆ›å»ºï¼‰
        warmupConnections(3, 0, "æ ¸å¿ƒè¿æ¥");
        
        // é˜¶æ®µ2ï¼šåˆ›å»ºç¼“å†²è¿æ¥ï¼ˆ5ç§’åï¼‰
        warmupExecutor.schedule(
            () -> warmupConnections(2, 100, "ç¼“å†²è¿æ¥"), 
            5, TimeUnit.SECONDS);
        
        // é˜¶æ®µ3ï¼šåˆ›å»ºå¤‡ç”¨è¿æ¥ï¼ˆ10ç§’åï¼‰
        warmupExecutor.schedule(
            () -> warmupConnections(3, 200, "å¤‡ç”¨è¿æ¥"), 
            10, TimeUnit.SECONDS);
    }
    
    private void warmupConnections(int count, long delayBetweenConnections, String phase) {
        logger.info("é¢„çƒ­é˜¶æ®µï¼š{}ï¼Œç›®æ ‡è¿æ¥æ•°ï¼š{}", phase, count);
        
        for (int i = 0; i < count; i++) {
            try {
                // è¿æ¥é—´çš„å»¶è¿Ÿï¼Œé¿å…ç¬é—´å‹åŠ›
                if (delayBetweenConnections > 0 && i > 0) {
                    Thread.sleep(delayBetweenConnections);
                }
                
                Connection conn = dataSource.getConnection();
                
                // æ‰§è¡Œç®€å•æŸ¥è¯¢ï¼Œç¡®ä¿è¿æ¥å®Œå…¨å¯ç”¨
                try (PreparedStatement stmt = conn.prepareStatement("SELECT 1")) {
                    stmt.executeQuery();
                }
                
                conn.close(); // å½’è¿˜è¿æ¥
                
                logger.debug("{}ç¬¬{}ä¸ªè¿æ¥é¢„çƒ­æˆåŠŸ", phase, i + 1);
                
            } catch (Exception e) {
                logger.error("{}ç¬¬{}ä¸ªè¿æ¥é¢„çƒ­å¤±è´¥", phase, i + 1, e);
            }
        }
        
        logger.info("{}é¢„çƒ­å®Œæˆ", phase);
    }
    
    @PreDestroy
    public void shutdown() {
        warmupExecutor.shutdown();
    }
}
```

### 7.4 ä¸šåŠ¡æ„ŸçŸ¥çš„é¢„çƒ­


**ğŸ¯ åŸºäºä¸šåŠ¡æ¨¡å¼çš„æ™ºèƒ½é¢„çƒ­**

```java
// æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è¿›è¡Œæœ‰é’ˆå¯¹æ€§çš„é¢„çƒ­
@Component
public class BusinessAwareWarmup {
    
    private final DataSource dataSource;
    private final ApplicationProperties appProperties;
    
    @EventListener(ApplicationReadyEvent.class)
    public void businessSpecificWarmup() {
        String businessType = appProperties.getBusinessType();
        
        switch (businessType) {
            case "e-commerce":
                ecommerceWarmup();
                break;
            case "financial":
                financialWarmup();
                break;
            case "content":
                contentWarmup();
                break;
            default:
                standardWarmup();
        }
    }
    
    private void ecommerceWarmup() {
        logger.info("æ‰§è¡Œç”µå•†ä¸šåŠ¡é¢„çƒ­ç­–ç•¥");
        
        // ç”µå•†ç‰¹ç‚¹ï¼šç”¨æˆ·æŸ¥è¯¢ã€å•†å“æœç´¢é¢‘ç¹
        List<String> commonQueries = Arrays.asList(
            "SELECT COUNT(*) FROM products WHERE status = 'active'",
            "SELECT * FROM categories ORDER BY sort_order LIMIT 10",
            "SELECT COUNT(*) FROM users WHERE last_login_date > DATE_SUB(NOW(), INTERVAL 7 DAY)"
        );
        
        warmupWithQueries(commonQueries, 3);
    }
    
    private void financialWarmup() {
        logger.info("æ‰§è¡Œé‡‘èä¸šåŠ¡é¢„çƒ­ç­–ç•¥");
        
        // é‡‘èç‰¹ç‚¹ï¼šäº‹åŠ¡æ€§å¼ºï¼Œå¯¹è¿æ¥ç¨³å®šæ€§è¦æ±‚é«˜
        List<String> transactionQueries = Arrays.asList(
            "SELECT 1 FROM accounts WHERE id = 1 FOR UPDATE",
            "SELECT COUNT(*) FROM transactions WHERE created_date >= CURDATE()",
            "SELECT balance FROM accounts WHERE account_no = '000000001'"
        );
        
        // é‡‘èç³»ç»Ÿéœ€è¦æ›´å¤šè¿æ¥é¢„çƒ­
        warmupWithQueries(transactionQueries, 8);
    }
    
    private void warmupWithQueries(List<String> queries, int connectionCount) {
        List<Connection> connections = new ArrayList<>();
        
        try {
            // åˆ›å»ºè¿æ¥å¹¶æ‰§è¡Œä¸šåŠ¡ç›¸å…³æŸ¥è¯¢
            for (int i = 0; i < connectionCount; i++) {
                Connection conn = dataSource.getConnection();
                connections.add(conn);
                
                // æ‰§è¡Œé¢„çƒ­æŸ¥è¯¢
                for (String query : queries) {
                    try (PreparedStatement stmt = conn.prepareStatement(query)) {
                        stmt.executeQuery();
                    }
                }
                
                logger.debug("ä¸šåŠ¡é¢„çƒ­è¿æ¥ {} å®Œæˆ", i + 1);
            }
            
        } catch (SQLException e) {
            logger.error("ä¸šåŠ¡é¢„çƒ­å¤±è´¥", e);
        } finally {
            // å½’è¿˜è¿æ¥
            connections.forEach(this::closeQuietly);
        }
    }
    
    private void closeQuietly(Connection conn) {
        try {
            if (conn != null && !conn.isClosed()) {
                conn.close();
            }
        } catch (SQLException e) {
            logger.warn("å…³é—­é¢„çƒ­è¿æ¥å¤±è´¥", e);
        }
    }
}
```

**ğŸ“Š é¢„çƒ­æ•ˆæœç›‘æ§**

```java
// é¢„çƒ­æ•ˆæœçš„ç›‘æ§å’ŒéªŒè¯
@Component
public class WarmupEffectMonitor {
    
    private final MeterRegistry meterRegistry;
    private long warmupStartTime;
    private long warmupEndTime;
    
    @EventListener
    public void onWarmupStart(WarmupStartEvent event) {
        warmupStartTime = System.currentTimeMillis();
        logger.info("è¿æ¥æ± é¢„çƒ­å¼€å§‹");
    }
    
    @EventListener  
    public void onWarmupComplete(WarmupCompleteEvent event) {
        warmupEndTime = System.currentTimeMillis();
        long warmupDuration = warmupEndTime - warmupStartTime;
        
        // è®°å½•é¢„çƒ­è€—æ—¶
        Timer.Sample.start(meterRegistry)
             .stop(Timer.builder("connection.pool.warmup.duration")
                        .register(meterRegistry));
        
        logger.info("è¿æ¥æ± é¢„çƒ­å®Œæˆï¼Œè€—æ—¶ï¼š{}ms", warmupDuration);
        
        // éªŒè¯é¢„çƒ­æ•ˆæœ
        validateWarmupEffect();
    }
    
    private void validateWarmupEffect() {
        // æµ‹è¯•è¿æ¥è·å–é€Ÿåº¦
        long startTime = System.nanoTime();
        
        try (Connection conn = dataSource.getConnection()) {
            long duration = System.nanoTime() - startTime;
            double durationMs = duration / 1_000_000.0;
            
            // è®°å½•è¿æ¥è·å–æ—¶é—´
            Timer.builder("connection.acquisition.time.after.warmup")
                 .register(meterRegistry)
                 .record(duration, TimeUnit.NANOSECONDS);
            
            if (durationMs < 10) {  // å°‘äº10msè¡¨ç¤ºé¢„çƒ­æ•ˆæœå¥½
                logger.info("é¢„çƒ­æ•ˆæœè‰¯å¥½ï¼Œè¿æ¥è·å–æ—¶é—´ï¼š{:.2f}ms", durationMs);
            } else {
                logger.warn("é¢„çƒ­æ•ˆæœä¸€èˆ¬ï¼Œè¿æ¥è·å–æ—¶é—´ï¼š{:.2f}ms", durationMs);
            }
            
        } catch (SQLException e) {
            logger.error("é¢„çƒ­æ•ˆæœéªŒè¯å¤±è´¥", e);
        }
    }
}
```

---

## 8. ğŸ“ˆ è¿æ¥æ± æ‰©ç¼©å®¹ç­–ç•¥


### 8.1 æ‰©ç¼©å®¹çš„åŸºæœ¬åŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¿æ¥æ± æ‰©ç¼©å®¹**
è¿æ¥æ± æ‰©ç¼©å®¹å°±åƒé¤å…æ ¹æ®å®¢æµé‡è°ƒæ•´æœåŠ¡å‘˜æ•°é‡ä¸€æ ·ï¼Œå®¢äººå¤šæ—¶å¢åŠ æœåŠ¡å‘˜ï¼Œå®¢äººå°‘æ—¶å‡å°‘æœåŠ¡å‘˜ï¼Œæ—¢ä¿è¯æœåŠ¡è´¨é‡ï¼Œåˆæ§åˆ¶æˆæœ¬ã€‚

```
æ‰©ç¼©å®¹ç¤ºæ„å›¾ï¼š
ä½è´Ÿè½½æœŸé—´ï¼š              é«˜è´Ÿè½½æœŸé—´ï¼š              è´Ÿè½½æ¢å¤åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿æ¥æ±       â”‚          â”‚ è¿æ¥æ±       â”‚          â”‚ è¿æ¥æ±       â”‚
â”‚ â”Œâ”€â” â”Œâ”€â”    â”‚   æ‰©å®¹    â”‚ â”Œâ”€â” â”Œâ”€â” â”Œâ”€â” â”‚   ç¼©å®¹    â”‚ â”Œâ”€â” â”Œâ”€â”    â”‚
â”‚ â”‚1â”‚ â”‚2â”‚ â–¡â–¡ â”‚  â”€â”€â”€â”€â–º   â”‚ â”‚1â”‚ â”‚2â”‚ â”‚3â”‚ â”‚  â”€â”€â”€â”€â–º   â”‚ â”‚1â”‚ â”‚2â”‚ â–¡â–¡ â”‚
â”‚ â””â”€â”˜ â””â”€â”˜    â”‚          â”‚ â””â”€â”˜ â””â”€â”˜ â””â”€â”˜ â”‚          â”‚ â””â”€â”˜ â””â”€â”˜    â”‚
â”‚ æœ€å°ï¼š2     â”‚          â”‚ â”Œâ”€â” â”Œâ”€â” â”Œâ”€â” â”‚          â”‚ æœ€å°ï¼š2     â”‚
â”‚ å½“å‰ï¼š2     â”‚          â”‚ â”‚4â”‚ â”‚5â”‚ â”‚6â”‚ â”‚          â”‚ å½“å‰ï¼š2     â”‚
â”‚ æœ€å¤§ï¼š8     â”‚          â”‚ â””â”€â”˜ â””â”€â”˜ â””â”€â”˜ â”‚          â”‚ æœ€å¤§ï¼š8     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ å½“å‰ï¼š6     â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ æœ€å¤§ï¼š8     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§¦å‘æ¡ä»¶ï¼š
æ‰©å®¹ï¼šç­‰å¾…é˜Ÿåˆ—é•¿åº¦ > 5 æˆ– æ´»è·ƒè¿æ¥ç‡ > 80%
ç¼©å®¹ï¼šç©ºé—²è¿æ¥æ•° > æœ€å°å€¼ ä¸” ç©ºé—²æ—¶é—´ > é˜ˆå€¼
```

### 8.2 åŠ¨æ€æ‰©å®¹ç­–ç•¥


**â¬†ï¸ æ‰©å®¹è§¦å‘æœºåˆ¶**

```java
// æ™ºèƒ½æ‰©å®¹å†³ç­–å™¨
@Component
public class ConnectionPoolScaler {
    
    private final HikariDataSource dataSource;
    private final MeterRegistry meterRegistry;
    
    // æ‰©å®¹å†³ç­–å‚æ•°
    private static final double HIGH_LOAD_THRESHOLD = 0.8;  // 80%æ´»è·ƒç‡
    private static final int WAIT_QUEUE_THRESHOLD = 5;      // ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
    private static final long SCALE_UP_COOLDOWN = 30000;    // æ‰©å®¹å†·å´æœŸ30ç§’
    
    private volatile long lastScaleUpTime = 0;
    
    @Scheduled(fixedRate = 10000) // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkAndScale() {
        PoolMetrics metrics = getCurrentMetrics();
        
        if (shouldScaleUp(metrics)) {
            scaleUp(metrics);
        } else if (shouldScaleDown(metrics)) {
            scaleDown(metrics);
        }
    }
    
    private boolean shouldScaleUp(PoolMetrics metrics) {
        long currentTime = System.currentTimeMillis();
        
        // å†·å´æœŸæ£€æŸ¥
        if (currentTime - lastScaleUpTime < SCALE_UP_COOLDOWN) {
            return false;
        }
        
        // æ¡ä»¶1ï¼šæ´»è·ƒè¿æ¥ç‡è¿‡é«˜
        double activeRate = (double) metrics.getActiveConnections() / metrics.getTotalConnections();
        boolean highActiveRate = activeRate > HIGH_LOAD_THRESHOLD;
        
        // æ¡ä»¶2ï¼šç­‰å¾…é˜Ÿåˆ—è¿‡é•¿
        boolean longWaitQueue = metrics.getWaitingThreads() > WAIT_QUEUE_THRESHOLD;
        
        // æ¡ä»¶3ï¼šæœªè¾¾åˆ°æœ€å¤§è¿æ¥æ•°
        boolean canExpand = metrics.getTotalConnections() < dataSource.getMaximumPoolSize();
        
        return (highActiveRate || longWaitQueue) && canExpand;
    }
    
    private void scaleUp(PoolMetrics metrics) {
        int currentSize = metrics.getTotalConnections();
        int maxSize = dataSource.getMaximumPoolSize();
        
        // è®¡ç®—æ‰©å®¹æ•°é‡ï¼šå½“å‰å¤§å°çš„25%ï¼Œè‡³å°‘1ä¸ªï¼Œä¸è¶…è¿‡å‰©ä½™å®¹é‡
        int expandCount = Math.max(1, currentSize / 4);
        int targetSize = Math.min(currentSize + expandCount, maxSize);
        
        logger.info("è§¦å‘è¿æ¥æ± æ‰©å®¹ï¼šå½“å‰{}ä¸ªè¿æ¥ï¼Œç›®æ ‡{}ä¸ªè¿æ¥ï¼Œæ´»è·ƒç‡{:.1f}%ï¼Œç­‰å¾…çº¿ç¨‹{}ä¸ª",
                   currentSize, targetSize, 
                   metrics.getActiveConnections() * 100.0 / currentSize,
                   metrics.getWaitingThreads());
        
        // HikariCPé€šè¿‡è°ƒæ•´å‚æ•°é—´æ¥å®ç°æ‰©å®¹
        // å®é™…æ‰©å®¹ç”±è¿æ¥æ± å†…éƒ¨æŒ‰éœ€åˆ›å»º
        triggerConnectionCreation(expandCount);
        
        lastScaleUpTime = System.currentTimeMillis();
        
        // è®°å½•æ‰©å®¹äº‹ä»¶
        meterRegistry.counter("connection.pool.scale.up").increment();
    }
    
    private void triggerConnectionCreation(int count) {
        // é€šè¿‡ä¸»åŠ¨è·å–å’Œå½’è¿˜è¿æ¥æ¥è§¦å‘è¿æ¥åˆ›å»º
        List<Connection> tempConnections = new ArrayList<>();
        
        try {
            for (int i = 0; i < count; i++) {
                Connection conn = dataSource.getConnection();
                tempConnections.add(conn);
            }
        } catch (SQLException e) {
            logger.error("è§¦å‘è¿æ¥åˆ›å»ºå¤±è´¥", e);
        } finally {
            // ç«‹å³å½’è¿˜è¿æ¥ï¼Œè®©å®ƒä»¬è¿›å…¥ç©ºé—²çŠ¶æ€
            for (Connection conn : tempConnections) {
                try {
                    if (conn != null) {
                        conn.close();
                    }
                } catch (SQLException e) {
                    logger.warn("å½’è¿˜ä¸´æ—¶è¿æ¥å¤±è´¥", e);
                }
            }
        }
    }
}
```

### 8.3 åŠ¨æ€ç¼©å®¹ç­–ç•¥


**â¬‡ï¸ ç¼©å®¹è§¦å‘æœºåˆ¶**

```java
// æ™ºèƒ½ç¼©å®¹å†³ç­–
public class ConnectionPoolDownscaler {
    
    // ç¼©å®¹å†³ç­–å‚æ•°
    private static final double LOW_LOAD_THRESHOLD = 0.3;   // 30%æ´»è·ƒç‡
    private static final long IDLE_TIME_THRESHOLD = 300000; // 5åˆ†é’Ÿç©ºé—²æ—¶é—´
    private static final long SCALE_DOWN_COOLDOWN = 60000;  // ç¼©å®¹å†·å´æœŸ60ç§’
    
    private volatile long lastScaleDownTime = 0;
    
    private boolean shouldScaleDown(PoolMetrics metrics) {
        long currentTime = System.currentTimeMillis();
        
        // å†·å´æœŸæ£€æŸ¥
        if (currentTime - lastScaleDownTime < SCALE_DOWN_COOLDOWN) {
            return false;
        }
        
        // æ¡ä»¶1ï¼šæ´»è·ƒè¿æ¥ç‡è¾ƒä½
        double activeRate = (double) metrics.getActiveConnections() / metrics.getTotalConnections();
        boolean lowActiveRate = activeRate < LOW_LOAD_THRESHOLD;
        
        // æ¡ä»¶2ï¼šæœ‰å¤šä½™çš„ç©ºé—²è¿æ¥
        int minIdle = dataSource.getMinimumIdle();
        boolean hasExcessIdle = metrics.getIdleConnections() > minIdle;
        
        // æ¡ä»¶3ï¼šç©ºé—²æ—¶é—´è¶³å¤Ÿé•¿ï¼ˆé¿å…é¢‘ç¹ç¼©å®¹ï¼‰
        boolean longIdleTime = metrics.getAvgIdleTime() > IDLE_TIME_THRESHOLD;
        
        // æ¡ä»¶4ï¼šæ²¡æœ‰ç­‰å¾…çš„è¯·æ±‚
        boolean noWaitingThreads = metrics.getWaitingThreads() == 0;
        
        return lowActiveRate && hasExcessIdle && longIdleTime && noWaitingThreads;
    }
    
    private void scaleDown(PoolMetrics metrics) {
        int currentSize = metrics.getTotalConnections();
        int minSize = dataSource.getMinimumIdle();
        
        // è®¡ç®—ç¼©å®¹æ•°é‡ï¼šå¤šä½™è¿æ¥çš„50%ï¼Œè‡³å°‘ä¿ç•™æœ€å°è¿æ¥æ•°
        int excessConnections = currentSize - minSize;
        int shrinkCount = Math.max(0, excessConnections / 2);
        int targetSize = Math.max(minSize, currentSize - shrinkCount);
        
        logger.info("è§¦å‘è¿æ¥æ± ç¼©å®¹ï¼šå½“å‰{}ä¸ªè¿æ¥ï¼Œç›®æ ‡{}ä¸ªè¿æ¥ï¼Œæ´»è·ƒç‡{:.1f}%",
                   currentSize, targetSize,
                   metrics.getActiveConnections() * 100.0 / currentSize);
        
        // HikariCPè‡ªåŠ¨å¤„ç†è¿æ¥å›æ”¶
        // æˆ‘ä»¬ä¸»è¦æ˜¯è°ƒæ•´ç©ºé—²è¶…æ—¶æ—¶é—´æ¥åŠ é€Ÿå›æ”¶
        temporarilyReduceIdleTimeout();
        
        lastScaleDownTime = System.currentTimeMillis();
        
        // è®°å½•ç¼©å®¹äº‹ä»¶
        meterRegistry.counter("connection.pool.scale.down").increment();
    }
    
    private void temporarilyReduceIdleTimeout() {
        // ä¸´æ—¶é™ä½ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ŒåŠ é€Ÿè¿æ¥å›æ”¶
        long originalTimeout = dataSource.getIdleTimeout();
        long temporaryTimeout = 60000; // ä¸´æ—¶è®¾ä¸º1åˆ†é’Ÿ
        
        dataSource.setIdleTimeout(temporaryTimeout);
        
        // 1åˆ†é’Ÿåæ¢å¤åŸè®¾ç½®
        ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();
        executor.schedule(() -> {
            dataSource.setIdleTimeout(originalTimeout);
            logger.debug("æ¢å¤è¿æ¥æ± ç©ºé—²è¶…æ—¶è®¾ç½®ï¼š{}ms", originalTimeout);
        }, 60, TimeUnit.SECONDS);
        
        executor.shutdown();
    }
}
```

### 8.4 æ‰©ç¼©å®¹ç›‘æ§å’Œè°ƒä¼˜


**ğŸ“Š æ‰©ç¼©å®¹æ•ˆæœç›‘æ§**

```java
@Component
public class ScalingMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    // æ”¶é›†è¿æ¥æ± æŒ‡æ ‡
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ”¶é›†ä¸€æ¬¡
    public void collectMetrics() {
        if (dataSource instanceof HikariDataSource) {
            HikariDataSource hikari = (HikariDataSource) dataSource;
            HikariPoolMXBean pool = hikari.getHikariPoolMXBean();
            
            // åŸºç¡€æŒ‡æ ‡
            Gauge.builder("connection.pool.active")
                 .register(meterRegistry, pool::getActiveConnections);
            
            Gauge.builder("connection.pool.idle")
                 .register(meterRegistry, pool::getIdleConnections);
            
            Gauge.builder("connection.pool.total")
                 .register(meterRegistry, pool::getTotalConnections);
            
            Gauge.builder("connection.pool.waiting")
                 .register(meterRegistry, pool::getThreadsAwaitingConnection);
            
            // æ‰©ç¼©å®¹å†³ç­–æŒ‡æ ‡
            double utilizationRate = (double) pool.getActiveConnections() / pool.getTotalConnections();
            Gauge.builder("connection.pool.utilization.rate")
                 .register(meterRegistry, () -> utilizationRate);
            
            // æ€§èƒ½æŒ‡æ ‡
            Timer connectionObtainTimer = Timer.builder("connection.obtain.time")
                                               .register(meterRegistry);
            
            // è®°å½•è¿æ¥è·å–æ—¶é—´
            recordConnectionObtainTime(connectionObtainTimer);
        }
    }
    
    private void recordConnectionObtainTime(Timer timer) {
        Timer.Sample sample = Timer.start();
        
        try (Connection conn = dataSource.getConnection()) {
            sample.stop(timer);
        } catch (SQLException e) {
            logger.error("è¿æ¥è·å–æ—¶é—´æµ‹é‡å¤±è´¥", e);
        }
    }
}
```

**âš™ï¸ æ‰©ç¼©å®¹å‚æ•°è°ƒä¼˜å»ºè®®**

| ä¸šåŠ¡åœºæ™¯ | **æ‰©å®¹è§¦å‘** | **ç¼©å®¹è§¦å‘** | **æ‰©å®¹å¹…åº¦** | **ç¼©å®¹å¹…åº¦** | **å†·å´æ—¶é—´** |
|---------|------------|------------|------------|------------|------------|
| `Webåº”ç”¨` | `æ´»è·ƒç‡>70%` | `æ´»è·ƒç‡<20%` | `+25%` | `-50%` | `æ‰©å®¹30sï¼Œç¼©å®¹60s` |
| `APIæœåŠ¡` | `æ´»è·ƒç‡>80%` | `æ´»è·ƒç‡<30%` | `+50%` | `-30%` | `æ‰©å®¹20sï¼Œç¼©å®¹90s` |
| `æ‰¹å¤„ç†` | `ç­‰å¾…>10ä¸ª` | `ç©ºé—²>10åˆ†é’Ÿ` | `+100%` | `-70%` | `æ‰©å®¹60sï¼Œç¼©å®¹300s` |
| `æŠ¥è¡¨ç³»ç»Ÿ` | `æ´»è·ƒç‡>60%` | `æ´»è·ƒç‡<10%` | `+30%` | `-60%` | `æ‰©å®¹45sï¼Œç¼©å®¹120s` |

---

## 9. ğŸ”„ è¿æ¥æ± æ•…éšœåˆ‡æ¢


### 9.1 æ•…éšœåˆ‡æ¢çš„å¿…è¦æ€§


**ğŸ”¸ æ•°æ®åº“æ•…éšœçš„å¸¸è§åœºæ™¯**
æ•°æ®åº“æ•…éšœå°±åƒåœç”µä¸€æ ·ï¼Œè™½ç„¶ä¸å¸¸å‘ç”Ÿï¼Œä½†ä¸€æ—¦å‘ç”Ÿå°±ä¼šä¸¥é‡å½±å“ä¸šåŠ¡ã€‚è¿æ¥æ± çš„æ•…éšœåˆ‡æ¢æœºåˆ¶å°±åƒå¤‡ç”¨å‘ç”µæœºï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§ã€‚

```
æ•…éšœåœºæ™¯åˆ†ç±»ï¼š
ä¸»æ•°æ®åº“æ•…éšœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     âŒ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  ä¸»æ•°æ®åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   (æ•…éšœ)    â”‚
       â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ åˆ‡æ¢åˆ°å¤‡åº“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     âœ…     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  å¤‡æ•°æ®åº“   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   (æ­£å¸¸)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç»œåˆ†åŒºæ•…éšœï¼š
åº”ç”¨ â”€â”€â”€â”€ ç½‘ç»œè®¾å¤‡(æ•…éšœ) â”€â”€â”€â”€ æ•°æ®åº“A
  â”‚                          
  â””â”€â”€â”€â”€ å¤‡ç”¨ç½‘ç»œ â”€â”€â”€â”€ æ•°æ®åº“B

æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼š
åº”ç”¨è¯·æ±‚ â†’ ä¸»åº“(CPU 100%) â†’ å“åº”è¶…æ—¶
         â†“
      è‡ªåŠ¨åˆ‡æ¢åˆ°è¯»åº“
         â†“
       æ­£å¸¸å“åº”
```

### 9.2 æ•…éšœæ£€æµ‹æœºåˆ¶


**ğŸ” å¤šå±‚æ¬¡æ•…éšœæ£€æµ‹**

```java
// è¿æ¥æ± çº§åˆ«çš„æ•…éšœæ£€æµ‹
@Component
public class DatabaseFailureDetector {
    
    private final List<DataSource> dataSources;
    private final ApplicationEventPublisher eventPublisher;
    
    // æ•…éšœæ£€æµ‹å‚æ•°
    private static final int FAILURE_THRESHOLD = 3;        // è¿ç»­å¤±è´¥3æ¬¡
    private static final long DETECTION_INTERVAL = 10000;  // 10ç§’æ£€æµ‹é—´éš”
    private static final int DETECTION_TIMEOUT = 5000;     // 5ç§’æ£€æµ‹è¶…æ—¶
    
    private final Map<DataSource, FailureCounter> failureCounters = new ConcurrentHashMap<>();
    
    @Scheduled(fixedRate = DETECTION_INTERVAL)
    public void detectDatabaseHealth() {
        for (DataSource dataSource : dataSources) {
            boolean healthy = checkDatabaseHealth(dataSource);
            updateFailureCounter(dataSource, healthy);
        }
    }
    
    private boolean checkDatabaseHealth(DataSource dataSource) {
        try (Connection conn = dataSource.getConnection()) {
            
            // æ£€æŸ¥1ï¼šè¿æ¥æœ‰æ•ˆæ€§
            if (!conn.isValid(DETECTION_TIMEOUT / 1000)) {
                logger.warn("æ•°æ®åº“è¿æ¥æ— æ•ˆï¼š{}", getDataSourceInfo(dataSource));
                return false;
            }
            
            // æ£€æŸ¥2ï¼šæ‰§è¡Œç®€å•æŸ¥è¯¢
            try (PreparedStatement stmt = conn.prepareStatement("SELECT 1")) {
                stmt.setQueryTimeout(DETECTION_TIMEOUT / 1000);
                
                long startTime = System.currentTimeMillis();
                stmt.executeQuery();
                long responseTime = System.currentTimeMillis() - startTime;
                
                // æ£€æŸ¥3ï¼šå“åº”æ—¶é—´
                if (responseTime > DETECTION_TIMEOUT) {
                    logger.warn("æ•°æ®åº“å“åº”è¶…æ—¶ï¼š{}msï¼Œæ•°æ®æºï¼š{}", 
                               responseTime, getDataSourceInfo(dataSource));
                    return false;
                }
            }
            
            // æ£€æŸ¥4ï¼šè¿æ¥æ± çŠ¶æ€ï¼ˆå¦‚æœæ˜¯HikariCPï¼‰
            if (dataSource instanceof HikariDataSource) {
                HikariDataSource hikari = (HikariDataSource) dataSource;
                HikariPoolMXBean pool = hikari.getHikariPoolMXBean();
                
                // æ£€æŸ¥è¿æ¥æ± æ˜¯å¦å¥åº·
                if (pool.getActiveConnections() >= hikari.getMaximumPoolSize()) {
                    logger.warn("è¿æ¥æ± å·²æ»¡ï¼šæ´»è·ƒè¿æ¥{}/{}ï¼Œæ•°æ®æºï¼š{}", 
                               pool.getActiveConnections(), 
                               hikari.getMaximumPoolSize(),
                               getDataSourceInfo(dataSource));
                    return false;
                }
            }
            
            return true;
            
        } catch (SQLException e) {
            logger.error("æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥ï¼š{}ï¼Œé”™è¯¯ï¼š{}", 
                        getDataSourceInfo(dataSource), e.getMessage());
            return false;
        }
    }
    
    private void updateFailureCounter(DataSource dataSource, boolean healthy) {
        FailureCounter counter = failureCounters.computeIfAbsent(
            dataSource, k -> new FailureCounter());
        
        if (healthy) {
            // å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œé‡ç½®è®¡æ•°å™¨
            if (counter.reset()) {
                // å¦‚æœä¹‹å‰æ˜¯æ•…éšœçŠ¶æ€ï¼Œå‘å¸ƒæ¢å¤äº‹ä»¶
                eventPublisher.publishEvent(
                    new DatabaseRecoveredEvent(dataSource));
            }
        } else {
            // å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¢åŠ è®¡æ•°
            if (counter.incrementAndCheck(FAILURE_THRESHOLD)) {
                // è¾¾åˆ°æ•…éšœé˜ˆå€¼ï¼Œå‘å¸ƒæ•…éšœäº‹ä»¶
                eventPublisher.publishEvent(
                    new DatabaseFailureEvent(dataSource));
            }
        }
    }
    
    // æ•…éšœè®¡æ•°å™¨
    private static class FailureCounter {
        private volatile int count = 0;
        private volatile boolean failed = false;
        
        boolean incrementAndCheck(int threshold) {
            count++;
            if (count >= threshold && !failed) {
                failed = true;
                return true; // é¦–æ¬¡è¾¾åˆ°æ•…éšœé˜ˆå€¼
            }
            return false;
        }
        
        boolean reset() {
            boolean wasFailed = failed;
            count = 0;
            failed = false;
            return wasFailed; // è¿”å›æ˜¯å¦ä»æ•…éšœçŠ¶æ€æ¢å¤
        }
    }
}
```

### 9.3 æ•…éšœåˆ‡æ¢å®ç°


**ğŸ”„ ä¸»å¤‡åˆ‡æ¢æœºåˆ¶**

```java
// ä¸»å¤‡æ•°æ®æºç®¡ç†å™¨
@Component
public class FailoverDataSourceManager {
    
    private final DataSource primaryDataSource;
    private final DataSource secondaryDataSource;
    private final AtomicReference<DataSource> currentDataSource;
    
    private volatile boolean primaryAvailable = true;
    private volatile long lastFailoverTime = 0;
    
    // æ•…éšœåˆ‡æ¢å†·å´æ—¶é—´ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢
    private static final long FAILOVER_COOLDOWN = 30000; // 30ç§’
    
    public FailoverDataSourceManager(
            @Qualifier("primary") DataSource primaryDataSource,
            @Qualifier("secondary") DataSource secondaryDataSource) {
        
        this.primaryDataSource = primaryDataSource;
        this.secondaryDataSource = secondaryDataSource;
        this.currentDataSource = new AtomicReference<>(primaryDataSource);
    }
    
    // è·å–å½“å‰å¯ç”¨çš„æ•°æ®æº
    public Connection getConnection() throws SQLException {
        DataSource dataSource = currentDataSource.get();
        
        try {
            Connection conn = dataSource.getConnection();
            
            // è¿æ¥æˆåŠŸï¼ŒéªŒè¯æœ‰æ•ˆæ€§
            if (conn.isValid(5)) {
                return conn;
            } else {
                conn.close();
                throw new SQLException("è·å–çš„è¿æ¥æ— æ•ˆ");
            }
            
        } catch (SQLException e) {
            // è¿æ¥è·å–å¤±è´¥ï¼Œå°è¯•æ•…éšœåˆ‡æ¢
            logger.warn("ä»æ•°æ®æºè·å–è¿æ¥å¤±è´¥ï¼š{}ï¼Œå°è¯•åˆ‡æ¢", 
                       getDataSourceName(dataSource), e);
            
            if (attemptFailover()) {
                // åˆ‡æ¢æˆåŠŸï¼Œä»æ–°æ•°æ®æºè·å–è¿æ¥
                return currentDataSource.get().getConnection();
            } else {
                throw new SQLException("ä¸»å¤‡æ•°æ®æºéƒ½æ— æ³•è¿æ¥", e);
            }
        }
    }
    
    private boolean attemptFailover() {
        long currentTime = System.currentTimeMillis();
        
        // å†·å´æœŸæ£€æŸ¥
        if (currentTime - lastFailoverTime < FAILOVER_COOLDOWN) {
            logger.debug("æ•…éšœåˆ‡æ¢åœ¨å†·å´æœŸå†…ï¼Œè·³è¿‡åˆ‡æ¢");
            return false;
        }
        
        DataSource current = currentDataSource.get();
        DataSource target;
        
        if (current == primaryDataSource) {
            target = secondaryDataSource;
            primaryAvailable = false;
        } else {
            target = primaryDataSource;
            primaryAvailable = true;
        }
        
        // éªŒè¯ç›®æ ‡æ•°æ®æº
        if (testDataSource(target)) {
            // åˆ‡æ¢æ•°æ®æº
            currentDataSource.set(target);
            lastFailoverTime = currentTime;
            
            logger.info("æ•…éšœåˆ‡æ¢æˆåŠŸï¼š{} â†’ {}", 
                       getDataSourceName(current),
                       getDataSourceName(target));
            
            // å‘å¸ƒåˆ‡æ¢äº‹ä»¶
            applicationEventPublisher.publishEvent(
                new FailoverEvent(current, target));
            
            return true;
        } else {
            logger.error("ç›®æ ‡æ•°æ®æºä¹Ÿæ— æ³•è¿æ¥ï¼š{}", getDataSourceName(target));
            return false;
        }
    }
    
    private boolean testDataSource(DataSource dataSource) {
        try (Connection conn = dataSource.getConnection()) {
            return conn.isValid(3);
        } catch (SQLException e) {
            logger.debug("æ•°æ®æºæµ‹è¯•å¤±è´¥ï¼š{}", getDataSourceName(dataSource));
            return false;
        }
    }
    
    // å®šæœŸå°è¯•å›åˆ‡åˆ°ä¸»æ•°æ®æº
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void attemptFailback() {
        if (!primaryAvailable && currentDataSource.get() != primaryDataSource) {
            if (testDataSource(primaryDataSource)) {
                logger.info("ä¸»æ•°æ®æºå·²æ¢å¤ï¼Œæ‰§è¡Œå›åˆ‡");
                currentDataSource.set(primaryDataSource);
                primaryAvailable = true;
                
                applicationEventPublisher.publishEvent(
                    new FailbackEvent(secondaryDataSource, primaryDataSource));
            }
        }
    }
}
```

### 9.4 è¯»å†™åˆ†ç¦»çš„æ•…éšœå¤„ç†


**ğŸ“– è¯»å†™åˆ†ç¦»ç¯å¢ƒä¸‹çš„æ•…éšœåˆ‡æ¢**

```java
// è¯»å†™åˆ†ç¦»æ•°æ®æºç®¡ç†å™¨
@Component
public class ReadWriteDataSourceManager {
    
    private final DataSource writeDataSource;
    private final List<DataSource> readDataSources;
    private final AtomicInteger readSourceIndex = new AtomicInteger(0);
    
    private final Set<DataSource> failedReadSources = ConcurrentHashMap.newKeySet();
    
    // å†™æ“ä½œï¼šå›ºå®šä½¿ç”¨ä¸»åº“
    public Connection getWriteConnection() throws SQLException {
        try {
            return writeDataSource.getConnection();
        } catch (SQLException e) {
            logger.error("è·å–å†™è¿æ¥å¤±è´¥", e);
            
            // å†™åº“æ•…éšœæ˜¯ä¸¥é‡é—®é¢˜ï¼Œå¯èƒ½éœ€è¦äººå·¥ä»‹å…¥
            alertService.sendCriticalAlert("ä¸»æ•°æ®åº“å†™è¿æ¥å¤±è´¥", e);
            throw e;
        }
    }
    
    // è¯»æ“ä½œï¼šè´Ÿè½½å‡è¡¡ + æ•…éšœè½¬ç§»
    public Connection getReadConnection() throws SQLException {
        List<DataSource> availableReadSources = readDataSources.stream()
            .filter(ds -> !failedReadSources.contains(ds))
            .collect(Collectors.toList());
        
        if (availableReadSources.isEmpty()) {
            // æ‰€æœ‰è¯»åº“éƒ½æ•…éšœï¼Œé™çº§åˆ°ä¸»åº“
            logger.warn("æ‰€æœ‰è¯»åº“éƒ½ä¸å¯ç”¨ï¼Œé™çº§åˆ°ä¸»åº“");
            return writeDataSource.getConnection();
        }
        
        // è½®è¯¢é€‰æ‹©å¯ç”¨çš„è¯»åº“
        int attempts = availableReadSources.size();
        
        for (int i = 0; i < attempts; i++) {
            DataSource readSource = selectReadDataSource(availableReadSources);
            
            try {
                Connection conn = readSource.getConnection();
                
                if (conn.isValid(3)) {
                    return conn;
                } else {
                    conn.close();
                    markReadSourceFailed(readSource);
                }
                
            } catch (SQLException e) {
                logger.warn("è¯»åº“è¿æ¥å¤±è´¥ï¼š{}ï¼Œå°è¯•ä¸‹ä¸€ä¸ª", 
                           getDataSourceName(readSource));
                markReadSourceFailed(readSource);
            }
        }
        
        // æ‰€æœ‰è¯»åº“å°è¯•å¤±è´¥ï¼Œé™çº§åˆ°ä¸»åº“
        logger.warn("æ‰€æœ‰è¯»åº“è¿æ¥å°è¯•å¤±è´¥ï¼Œé™çº§åˆ°ä¸»åº“");
        return writeDataSource.getConnection();
    }
    
    private DataSource selectReadDataSource(List<DataSource> availableSources) {
        int index = readSourceIndex.getAndIncrement();
        return availableSources.get(index % availableSources.size());
    }
    
    private void markReadSourceFailed(DataSource dataSource) {
        failedReadSources.add(dataSource);
        logger.warn("æ ‡è®°è¯»åº“ä¸ºæ•…éšœçŠ¶æ€ï¼š{}", getDataSourceName(dataSource));
    }
    
    // å®šæœŸæ£€æŸ¥æ•…éšœçš„è¯»åº“æ˜¯å¦æ¢å¤
    @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkFailedReadSources() {
        Iterator<DataSource> iterator = failedReadSources.iterator();
        
        while (iterator.hasNext()) {
            DataSource dataSource = iterator.next();
            
            if (testDataSource(dataSource)) {
                iterator.remove();
                logger.info("è¯»åº“å·²æ¢å¤ï¼š{}", getDataSourceName(dataSource));
            }
        }
    }
}

// æ•°æ®æºè·¯ç”±å™¨ï¼ˆä¸@Transactionalé›†æˆï¼‰
@Component
public class DataSourceRouter {
    
    private final ReadWriteDataSourceManager dataSourceManager;
    
    public Connection getConnection() throws SQLException {
        // æ ¹æ®äº‹åŠ¡çŠ¶æ€å†³å®šä½¿ç”¨è¯»åº“è¿˜æ˜¯å†™åº“
        if (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) {
            return dataSourceManager.getReadConnection();
        } else {
            return dataSourceManager.getWriteConnection();
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿æ¥æ± æœ¬è´¨ï¼šèµ„æºå¤ç”¨æœºåˆ¶ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯è¿æ¥çš„å¼€é”€
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šåˆ›å»ºâ†’ä½¿ç”¨â†’éªŒè¯â†’å›æ”¶çš„å®Œæ•´æµç¨‹æ§åˆ¶
ğŸ”¸ é…ç½®å‚æ•°ï¼šæœ€å°/æœ€å¤§è¿æ¥æ•°ã€è¶…æ—¶æ—¶é—´ã€éªŒè¯ç­–ç•¥çš„åˆç†é…ç½®
ğŸ”¸ è¶…æ—¶æ§åˆ¶ï¼šå¤šå±‚æ¬¡è¶…æ—¶æœºåˆ¶ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
ğŸ”¸ è¿æ¥éªŒè¯ï¼šç¡®ä¿åˆ†é…ç»™åº”ç”¨çš„è¿æ¥éƒ½æ˜¯æœ‰æ•ˆå¯ç”¨çš„
ğŸ”¸ é¢„çƒ­æœºåˆ¶ï¼šåº”ç”¨å¯åŠ¨æ—¶æå‰å‡†å¤‡è¿æ¥ï¼Œæå‡é¦–æ¬¡å“åº”é€Ÿåº¦
ğŸ”¸ æ‰©ç¼©å®¹ç­–ç•¥ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´è¿æ¥æ•°é‡ï¼Œå¹³è¡¡æ€§èƒ½å’Œèµ„æºæ¶ˆè€—
ğŸ”¸ æ•…éšœåˆ‡æ¢ï¼šä¸»å¤‡åˆ‡æ¢å’Œè¯»å†™åˆ†ç¦»çš„é«˜å¯ç”¨ä¿éšœæœºåˆ¶
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿æ¥æ± ä¸æ˜¯é“¶å¼¹ï¼Œéœ€è¦åˆç†é…ç½®**
```
å¸¸è§è¯¯åŒºï¼š
âŒ è¿æ¥æ•°è¶Šå¤šæ€§èƒ½è¶Šå¥½
âœ… é€‚åˆçš„è¿æ¥æ•°æ‰èƒ½å‘æŒ¥æœ€ä½³æ€§èƒ½

âŒ è®¾ç½®å¾ˆé•¿çš„è¶…æ—¶æ—¶é—´
âœ… æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

âŒ è¿‡åº¦éªŒè¯è¿æ¥æœ‰æ•ˆæ€§
âœ… åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œå¿…è¦çš„éªŒè¯

æ­£ç¡®ç†è§£ï¼š
â€¢ è¿æ¥æ± æ˜¯æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œä¸æ˜¯åŠŸèƒ½å¿…éœ€
â€¢ é…ç½®éœ€è¦æ ¹æ®å®é™…è´Ÿè½½æƒ…å†µè°ƒä¼˜
â€¢ ç›‘æ§æŒ‡æ ‡æ¯”ç»éªŒå€¼æ›´å¯é 
```

**ğŸ”¹ è¶…æ—¶æ§åˆ¶çš„å±‚æ¬¡æ€§å¾ˆé‡è¦**
```
ä¸ºä»€ä¹ˆéœ€è¦å¤šå±‚è¶…æ—¶ï¼š
â€¢ HTTPå±‚è¶…æ—¶ï¼šä¿æŠ¤ç”¨æˆ·ä½“éªŒ
â€¢ åº”ç”¨å±‚è¶…æ—¶ï¼šé˜²æ­¢èµ„æºé•¿æœŸå ç”¨
â€¢ è¿æ¥è·å–è¶…æ—¶ï¼šé¿å…æ— é™ç­‰å¾…
â€¢ SQLæ‰§è¡Œè¶…æ—¶ï¼šé˜²æ­¢æ…¢æŸ¥è¯¢é˜»å¡
â€¢ è¿æ¥éªŒè¯è¶…æ—¶ï¼šå¿«é€Ÿæ£€æµ‹å¤±æ•ˆè¿æ¥

å±‚æ¬¡å…³ç³»ï¼š
å¤–å±‚è¶…æ—¶ > å†…å±‚è¶…æ—¶ï¼Œç»™æ¯å±‚ç•™å‡ºå¤„ç†æ—¶é—´
```

**ğŸ”¹ é¢„çƒ­å’Œæ‰©ç¼©å®¹éƒ½éœ€è¦ä¸šåŠ¡æ„ŸçŸ¥**
```
é¢„çƒ­ç­–ç•¥ï¼š
â€¢ ä¸æ˜¯æ‰€æœ‰åº”ç”¨éƒ½éœ€è¦é¢„çƒ­
â€¢ é¢„çƒ­å†…å®¹åº”è¯¥è´´è¿‘å®é™…ä¸šåŠ¡åœºæ™¯
â€¢ é¢„çƒ­æ—¶æœºè¦é¿å¼€å…¶ä»–ç³»ç»Ÿåˆå§‹åŒ–

æ‰©ç¼©å®¹å†³ç­–ï¼š
â€¢ åŸºäºçœŸå®çš„è´Ÿè½½æŒ‡æ ‡
â€¢ è€ƒè™‘ä¸šåŠ¡çš„å‘¨æœŸæ€§ç‰¹ç‚¹
â€¢ è®¾ç½®åˆç†çš„å†·å´æ—¶é—´
â€¢ é¿å…é¢‘ç¹çš„æŠ–åŠ¨
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒåœºæ™¯çš„æœ€ä½³å®è·µ**
- **å°å‹Webåº”ç”¨**ï¼šä½¿ç”¨HikariCPé»˜è®¤é…ç½®ï¼Œå…³æ³¨è¿æ¥æ³„æ¼æ£€æµ‹
- **é«˜å¹¶å‘API**ï¼šé‡ç‚¹è°ƒä¼˜è¿æ¥æ•°å’Œè¶…æ—¶å‚æ•°ï¼Œå¯ç”¨ç›‘æ§
- **ä¼ä¸šåº”ç”¨**ï¼šä½¿ç”¨Druidè·å¾—è¯¦ç»†ç›‘æ§ï¼Œé…ç½®è¯»å†™åˆ†ç¦»
- **å¾®æœåŠ¡æ¶æ„**ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹é…ç½®è¿æ¥æ± ï¼Œé¿å…ç›¸äº’å½±å“

**ğŸ› ï¸ è°ƒä¼˜çš„åŸºæœ¬æµç¨‹**
1. **å»ºç«‹åŸºå‡†**ï¼šè®°å½•é»˜è®¤é…ç½®ä¸‹çš„æ€§èƒ½æŒ‡æ ‡
2. **è¯†åˆ«ç“¶é¢ˆ**ï¼šé€šè¿‡ç›‘æ§æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆç‚¹
3. **é€æ­¥è°ƒä¼˜**ï¼šä¸€æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœ
4. **éªŒè¯æ”¹è¿›**ï¼šå¯¹æ¯”è°ƒä¼˜å‰åçš„æ€§èƒ½æ•°æ®
5. **æŒç»­ç›‘æ§**ï¼šå»ºç«‹é•¿æœŸçš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**ğŸ’¡ æ•…éšœé¢„é˜²å»ºè®®**
- **è¿æ¥æ³„æ¼**ï¼šå§‹ç»ˆä½¿ç”¨try-with-resourcesè¯­æ³•
- **é…ç½®å¤±å½“**ï¼šå‚è€ƒå®˜æ–¹å»ºè®®å’Œç¤¾åŒºæœ€ä½³å®è·µ
- **ç›‘æ§ç›²åŒº**ï¼šå»ºç«‹å…¨é¢çš„è¿æ¥æ± ç›‘æ§ä½“ç³»
- **æ•…éšœé¢„æ¡ˆ**ï¼šå‡†å¤‡ä¸»å¤‡åˆ‡æ¢å’Œé™çº§æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è¿æ¥æ± æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é‡è¦æ‰‹æ®µï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µåˆç†é…ç½®
- è¶…æ—¶æ§åˆ¶è¦åˆ†å±‚è®¾è®¡ï¼Œå†…å±‚è¶…æ—¶å°äºå¤–å±‚è¶…æ—¶
- è¿æ¥éªŒè¯åœ¨åˆé€‚çš„æ—¶æœºè¿›è¡Œï¼Œé¿å…è¿‡åº¦éªŒè¯å½±å“æ€§èƒ½
- é¢„çƒ­æœºåˆ¶å¯ä»¥æå‡ç”¨æˆ·ä½“éªŒï¼Œä½†è¦é¿å…å¯åŠ¨æ—¶çš„èµ„æºç«äº‰
- æ‰©ç¼©å®¹ç­–ç•¥è¦åŸºäºçœŸå®è´Ÿè½½ï¼Œè®¾ç½®åˆç†çš„è§¦å‘æ¡ä»¶å’Œå†·å´æ—¶é—´
- æ•…éšœåˆ‡æ¢æœºåˆ¶æ˜¯é«˜å¯ç”¨çš„åŸºç¡€ï¼Œéœ€è¦å®šæœŸæµ‹è¯•å’ŒéªŒè¯