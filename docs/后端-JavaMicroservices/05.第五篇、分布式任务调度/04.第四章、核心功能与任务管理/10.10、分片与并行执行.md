---
title: 10ã€åˆ†ç‰‡ä¸å¹¶è¡Œæ‰§è¡Œ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯åˆ†ç‰‡æ‰§è¡Œ](#1-ä»€ä¹ˆæ˜¯åˆ†ç‰‡æ‰§è¡Œ)
2. [åˆ†ç‰‡å¹¿æ’­æ¨¡å¼è¯¦è§£](#2-åˆ†ç‰‡å¹¿æ’­æ¨¡å¼è¯¦è§£)
3. [åˆ†ç‰‡å‚æ•°çš„è·å–ä¸ä½¿ç”¨](#3-åˆ†ç‰‡å‚æ•°çš„è·å–ä¸ä½¿ç”¨)
4. [æ•°æ®åˆ†ç‰‡å¤„ç†ç­–ç•¥](#4-æ•°æ®åˆ†ç‰‡å¤„ç†ç­–ç•¥)
5. [åˆ†å¸ƒå¼å¹¶è¡Œæ‰§è¡Œå®ç°](#5-åˆ†å¸ƒå¼å¹¶è¡Œæ‰§è¡Œå®ç°)
6. [åˆ†ç‰‡ä»»åŠ¡åè°ƒæœºåˆ¶](#6-åˆ†ç‰‡ä»»åŠ¡åè°ƒæœºåˆ¶)
7. [æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#7-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯åˆ†ç‰‡æ‰§è¡Œ


### 1.1 åˆ†ç‰‡æ‰§è¡Œçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯åˆ†ç‰‡ï¼Ÿ**
```
ç®€å•ç†è§£ï¼šæŠŠä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œè®©å¤šå°æœºå™¨åŒæ—¶å¤„ç†

ç”Ÿæ´»ä¾‹å­ï¼š
æ¬å®¶æ—¶æœ‰100ä¸ªç®±å­è¦æ¬è¿
- ä¸€ä¸ªäººæ¬ï¼šéœ€è¦æ¬100æ¬¡ï¼Œè€—æ—¶å¾ˆé•¿
- 5ä¸ªäººä¸€èµ·æ¬ï¼šæ¯äººæ¬20ä¸ªç®±å­ï¼ŒåŒæ—¶è¿›è¡Œï¼Œé€Ÿåº¦å¿«5å€

æ•°æ®å¤„ç†ä¾‹å­ï¼š
å¤„ç†100ä¸‡æ¡ç”¨æˆ·æ•°æ®
- å•æœºå¤„ç†ï¼šä¸€å°æœºå™¨å¤„ç†100ä¸‡æ¡ï¼Œè€—æ—¶2å°æ—¶
- åˆ†ç‰‡å¤„ç†ï¼š5å°æœºå™¨å„å¤„ç†20ä¸‡æ¡ï¼ŒåŒæ—¶è¿›è¡Œï¼Œè€—æ—¶çº¦24åˆ†é’Ÿ
```

**ğŸ’¡ åˆ†ç‰‡çš„æ ¸å¿ƒä»·å€¼**
```
ğŸš€ æå‡å¤„ç†é€Ÿåº¦ï¼šå¤šæœºå™¨å¹¶è¡Œæ‰§è¡Œï¼Œå¤§å¤§ç¼©çŸ­ä»»åŠ¡è€—æ—¶
âš¡ æé«˜ç³»ç»Ÿååï¼šå……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼Œå¤„ç†æ›´å¤šä¸šåŠ¡é‡
ğŸ”„ å¢å¼ºå®¹é”™èƒ½åŠ›ï¼šå•ä¸ªèŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä¸ªä»»åŠ¡æ‰§è¡Œ
ğŸ“ˆ æ”¯æŒå¼¹æ€§æ‰©å±•ï¼šå¯æ ¹æ®æ•°æ®é‡åŠ¨æ€è°ƒæ•´æ‰§è¡ŒèŠ‚ç‚¹æ•°
```

### 1.2 XXL-JOBåˆ†ç‰‡æ‰§è¡Œçš„å·¥ä½œåŸç†


**ğŸ—ï¸ æ•´ä½“æ¶æ„**
```
è°ƒåº¦ä¸­å¿ƒ                     æ‰§è¡Œå™¨é›†ç¾¤
    |                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    |                       â”‚æ‰§è¡Œå™¨1  â”‚ â† å¤„ç†åˆ†ç‰‡0çš„æ•°æ®
    |â”€â”€â”€ ä»»åŠ¡è§¦å‘ â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    |                       â”‚æ‰§è¡Œå™¨2  â”‚ â† å¤„ç†åˆ†ç‰‡1çš„æ•°æ®  
    |                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    |                       â”‚æ‰§è¡Œå™¨3  â”‚ â† å¤„ç†åˆ†ç‰‡2çš„æ•°æ®
    |                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªæ‰§è¡Œå™¨éƒ½æ”¶åˆ°ç›¸åŒçš„ä»»åŠ¡ï¼Œä½†å¤„ç†ä¸åŒçš„æ•°æ®åˆ†ç‰‡
```

**ğŸ”„ æ‰§è¡Œæµç¨‹**
```
æ­¥éª¤1ï¼šè°ƒåº¦ä¸­å¿ƒå‘ç°æœ‰3å°æ‰§è¡Œå™¨åœ¨çº¿
æ­¥éª¤2ï¼šè°ƒåº¦ä¸­å¿ƒç»™æ¯å°æ‰§è¡Œå™¨å‘é€ä»»åŠ¡ä¿¡å·
æ­¥éª¤3ï¼šæ¯å°æ‰§è¡Œå™¨è·å–è‡ªå·±çš„åˆ†ç‰‡ä¿¡æ¯
       - æ‰§è¡Œå™¨1ï¼šæˆ‘æ˜¯ç¬¬0ä¸ªï¼Œæ€»å…±3ä¸ª
       - æ‰§è¡Œå™¨2ï¼šæˆ‘æ˜¯ç¬¬1ä¸ªï¼Œæ€»å…±3ä¸ª  
       - æ‰§è¡Œå™¨3ï¼šæˆ‘æ˜¯ç¬¬2ä¸ªï¼Œæ€»å…±3ä¸ª
æ­¥éª¤4ï¼šæ ¹æ®åˆ†ç‰‡ä¿¡æ¯ï¼Œå„è‡ªå¤„ç†å¯¹åº”çš„æ•°æ®
æ­¥éª¤5ï¼šæ‰€æœ‰åˆ†ç‰‡æ‰§è¡Œå®Œæˆï¼Œä»»åŠ¡ç»“æŸ
```

---

## 2. ğŸ“¡ åˆ†ç‰‡å¹¿æ’­æ¨¡å¼è¯¦è§£


### 2.1 åˆ†ç‰‡å¹¿æ’­æ¨¡å¼æ˜¯ä»€ä¹ˆ


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
åˆ†ç‰‡å¹¿æ’­ = å¹¿æ’­æ¨¡å¼ + åˆ†ç‰‡å¤„ç†

å¹¿æ’­ï¼šè°ƒåº¦ä¸­å¿ƒåŒæ—¶ç»™æ‰€æœ‰åœ¨çº¿æ‰§è¡Œå™¨å‘é€ä»»åŠ¡
åˆ†ç‰‡ï¼šæ¯ä¸ªæ‰§è¡Œå™¨åªå¤„ç†å±äºè‡ªå·±çš„é‚£éƒ¨åˆ†æ•°æ®

ç±»æ¯”ç†è§£ï¼š
å°±åƒè€å¸ˆç»™å…¨ç­åŒå­¦å¸ƒç½®ä½œä¸š
- å¹¿æ’­ï¼šæ¯ä¸ªåŒå­¦éƒ½æ”¶åˆ°äº†ä½œä¸šè¦æ±‚  
- åˆ†ç‰‡ï¼šä½†æ¯ä¸ªåŒå­¦åªåšå…¶ä¸­çš„å‡ é“é¢˜
```

**âš™ï¸ é…ç½®æ–¹å¼**
```
åœ¨XXL-JOBç®¡ç†åå°é…ç½®ä»»åŠ¡æ—¶ï¼š
è·¯ç”±ç­–ç•¥ â†’ é€‰æ‹©"åˆ†ç‰‡å¹¿æ’­"

é…ç½®å®Œæˆåï¼š
âœ… ç³»ç»Ÿä¼šè‡ªåŠ¨å¹¿æ’­ç»™æ‰€æœ‰æ‰§è¡Œå™¨
âœ… æ¯ä¸ªæ‰§è¡Œå™¨è‡ªåŠ¨è·å–åˆ†ç‰‡å‚æ•°
âœ… æ— éœ€æ‰‹åŠ¨æŒ‡å®šå“ªå°æœºå™¨å¤„ç†å“ªäº›æ•°æ®
```

### 2.2 åˆ†ç‰‡å¹¿æ’­çš„æ‰§è¡Œæœºåˆ¶


**ğŸ“‹ æ‰§è¡Œå™¨æ³¨å†Œä¸å‘ç°**
```
æ‰§è¡Œå™¨å¯åŠ¨æµç¨‹ï¼š
1. æ‰§è¡Œå™¨Aå¯åŠ¨ â†’ å‘è°ƒåº¦ä¸­å¿ƒæ³¨å†Œ
2. æ‰§è¡Œå™¨Bå¯åŠ¨ â†’ å‘è°ƒåº¦ä¸­å¿ƒæ³¨å†Œ  
3. æ‰§è¡Œå™¨Cå¯åŠ¨ â†’ å‘è°ƒåº¦ä¸­å¿ƒæ³¨å†Œ

è°ƒåº¦ä¸­å¿ƒè®°å½•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œå™¨   â”‚ IPåœ°å€     â”‚ çŠ¶æ€     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ app1     â”‚ 10.0.0.1   â”‚ åœ¨çº¿     â”‚
â”‚ app2     â”‚ 10.0.0.2   â”‚ åœ¨çº¿     â”‚  
â”‚ app3     â”‚ 10.0.0.3   â”‚ åœ¨çº¿     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ åˆ†ç‰‡å‚æ•°åˆ†é…**
```
å½“ä»»åŠ¡è§¦å‘æ—¶ï¼Œè°ƒåº¦ä¸­å¿ƒçš„åˆ†é…é€»è¾‘ï¼š

æ€»æ‰§è¡Œå™¨æ•°ï¼š3å°
åˆ†ç‰‡ç´¢å¼•åˆ†é…ï¼š
- æ‰§è¡Œå™¨1ï¼šåˆ†ç‰‡ç´¢å¼• = 0ï¼Œæ€»åˆ†ç‰‡æ•° = 3
- æ‰§è¡Œå™¨2ï¼šåˆ†ç‰‡ç´¢å¼• = 1ï¼Œæ€»åˆ†ç‰‡æ•° = 3
- æ‰§è¡Œå™¨3ï¼šåˆ†ç‰‡ç´¢å¼• = 2ï¼Œæ€»åˆ†ç‰‡æ•° = 3

æ¯å°æœºå™¨éƒ½çŸ¥é“ï¼š
æˆ‘åœ¨æ‰€æœ‰æœºå™¨ä¸­æ’ç¬¬å‡ ä¸ª + æ€»å…±æœ‰å‡ å°æœºå™¨
```

### 2.3 åˆ†ç‰‡å¹¿æ’­çš„ä¼˜åŠ¿


| ç‰¹æ€§ | **è¯´æ˜** | **å®é™…æ•ˆæœ** |
|------|----------|-------------|
| ğŸ”„ **è‡ªåŠ¨è´Ÿè½½å‡è¡¡** | `ç³»ç»Ÿè‡ªåŠ¨åˆ†é…åˆ†ç‰‡` | `æ— éœ€äººå·¥å¹²é¢„ï¼Œæœºå™¨è¶Šå¤šå¤„ç†è¶Šå¿«` |
| ğŸ¯ **æ•…éšœè‡ªæ„ˆ** | `æœºå™¨ä¸‹çº¿è‡ªåŠ¨é‡æ–°åˆ†ç‰‡` | `å•æœºæ•…éšœä¸å½±å“æ•´ä½“ä»»åŠ¡` |
| ğŸ“ˆ **å¼¹æ€§æ‰©å±•** | `æ–°å¢æœºå™¨è‡ªåŠ¨å‚ä¸åˆ†ç‰‡` | `å¤„ç†èƒ½åŠ›éšé›†ç¾¤è§„æ¨¡çº¿æ€§å¢é•¿` |
| âš¡ **ç®€åŒ–å¼€å‘** | `å¼€å‘è€…åªéœ€å…³æ³¨ä¸šåŠ¡é€»è¾‘` | `ä¸ç”¨è€ƒè™‘ä»»åŠ¡åˆ†å‘å’Œåè°ƒ` |

---

## 3. ğŸ”§ åˆ†ç‰‡å‚æ•°çš„è·å–ä¸ä½¿ç”¨


### 3.1 åˆ†ç‰‡å‚æ•°è·å–æ–¹æ³•


**ğŸ“– æ ¸å¿ƒAPIä»‹ç»**
```java
// XXL-JOBæä¾›çš„åˆ†ç‰‡å‚æ•°è·å–å·¥å…·
XxlJobHelper.getShardIndex()  // è·å–å½“å‰åˆ†ç‰‡ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
XxlJobHelper.getShardTotal()  // è·å–æ€»åˆ†ç‰‡æ•°
```

**ğŸ’¡ å‚æ•°å«ä¹‰è¯¦è§£**
```
åˆ†ç‰‡ç´¢å¼•ï¼ˆShardIndexï¼‰ï¼š
- å½“å‰æ‰§è¡Œå™¨åœ¨æ‰€æœ‰æ‰§è¡Œå™¨ä¸­çš„ç¼–å·
- ä»0å¼€å§‹è®¡æ•°
- ä¾‹å¦‚ï¼š3å°æœºå™¨ï¼Œç¼–å·åˆ†åˆ«æ˜¯0ã€1ã€2

æ€»åˆ†ç‰‡æ•°ï¼ˆShardTotalï¼‰ï¼š
- å‚ä¸ä»»åŠ¡æ‰§è¡Œçš„æ‰§è¡Œå™¨æ€»æ•°é‡
- ç­‰äºå½“å‰åœ¨çº¿ä¸”æ³¨å†Œçš„æ‰§è¡Œå™¨æ•°é‡
- ä¾‹å¦‚ï¼š3å°æœºå™¨åœ¨çº¿ï¼Œæ€»åˆ†ç‰‡æ•°å°±æ˜¯3
```

### 3.2 åˆ†ç‰‡å‚æ•°ä½¿ç”¨ç¤ºä¾‹


**ğŸ”¸ åŸºç¡€ä½¿ç”¨æ–¹å¼**
```java
@XxlJob("dataProcessJob")
public void processData() {
    // è·å–åˆ†ç‰‡å‚æ•°
    int shardIndex = XxlJobHelper.getShardIndex(); // å½“å‰æ˜¯ç¬¬å‡ ä¸ªåˆ†ç‰‡
    int shardTotal = XxlJobHelper.getShardTotal(); // æ€»å…±å‡ ä¸ªåˆ†ç‰‡
    
    // æ‰“å°åˆ†ç‰‡ä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
    XxlJobHelper.log("å½“å‰åˆ†ç‰‡ç´¢å¼•: {}, æ€»åˆ†ç‰‡æ•°: {}", shardIndex, shardTotal);
    
    // æ ¹æ®åˆ†ç‰‡å‚æ•°å¤„ç†å¯¹åº”çš„æ•°æ®
    processDataByShard(shardIndex, shardTotal);
}
```

**ğŸ¯ å®é™…ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹**
```java
@XxlJob("userDataSyncJob")
public void syncUserData() {
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();
    
    // æŸ¥è¯¢å±äºå½“å‰åˆ†ç‰‡çš„ç”¨æˆ·æ•°æ®
    List<User> users = userService.findUsersBySharding(shardIndex, shardTotal);
    
    // å¤„ç†è¿™éƒ¨åˆ†ç”¨æˆ·çš„æ•°æ®åŒæ­¥
    for (User user : users) {
        syncService.syncUserToExternalSystem(user);
    }
    
    XxlJobHelper.log("åˆ†ç‰‡{}å¤„ç†äº†{}ä¸ªç”¨æˆ·", shardIndex, users.size());
}
```

### 3.3 åˆ†ç‰‡å‚æ•°çš„å®é™…åº”ç”¨æ¨¡å¼


**ğŸ”„ å–æ¨¡åˆ†ç‰‡æ³•**
```java
// æœ€å¸¸ç”¨çš„åˆ†ç‰‡æ–¹å¼ï¼šæ ¹æ®IDå–æ¨¡
public List<Order> getOrdersByShard(int shardIndex, int shardTotal) {
    return orderMapper.selectList(
        new QueryWrapper<Order>()
            .apply("id % {0} = {1}", shardTotal, shardIndex)
    );
}

å®ä¾‹è¯´æ˜ï¼š
å‡è®¾æœ‰è®¢å•ID: 1,2,3,4,5,6,7,8,9,10
3å°æœºå™¨åˆ†ç‰‡å¤„ç†ï¼š
- æœºå™¨0(ç´¢å¼•0)ï¼šå¤„ç†ID % 3 = 0çš„è®¢å• â†’ 3,6,9
- æœºå™¨1(ç´¢å¼•1)ï¼šå¤„ç†ID % 3 = 1çš„è®¢å• â†’ 1,4,7,10  
- æœºå™¨2(ç´¢å¼•2)ï¼šå¤„ç†ID % 3 = 2çš„è®¢å• â†’ 2,5,8
```

**ğŸ“Š èŒƒå›´åˆ†ç‰‡æ³•**
```java
// æŒ‰æ•°æ®èŒƒå›´åˆ†ç‰‡
public List<Product> getProductsByShard(int shardIndex, int shardTotal) {
    long totalCount = productMapper.selectCount(null);
    long pageSize = totalCount / shardTotal;
    long offset = shardIndex * pageSize;
    
    return productMapper.selectByRange(offset, pageSize);
}

å®ä¾‹è¯´æ˜ï¼š
å‡è®¾æœ‰1000ä¸ªå•†å“ï¼Œ3å°æœºå™¨åˆ†ç‰‡ï¼š
- æœºå™¨0ï¼šå¤„ç†ç¬¬1-333ä¸ªå•†å“
- æœºå™¨1ï¼šå¤„ç†ç¬¬334-666ä¸ªå•†å“
- æœºå™¨2ï¼šå¤„ç†ç¬¬667-1000ä¸ªå•†å“
```

---

## 4. ğŸ“ˆ æ•°æ®åˆ†ç‰‡å¤„ç†ç­–ç•¥


### 4.1 åˆ†ç‰‡ç­–ç•¥é€‰æ‹©æŒ‡å—


**ğŸ¯ ç­–ç•¥å¯¹æ¯”åˆ†æ**

| åˆ†ç‰‡ç­–ç•¥ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **æ¨èæŒ‡æ•°** |
|---------|------------|---------|---------|-------------|
| ğŸ”¢ **å–æ¨¡åˆ†ç‰‡** | `æ•°æ®æœ‰å”¯ä¸€IDï¼Œåˆ†å¸ƒå‡åŒ€` | `ç®€å•é«˜æ•ˆï¼Œè´Ÿè½½å‡è¡¡å¥½` | `éœ€è¦æ”¯æŒå–æ¨¡æŸ¥è¯¢` | `â­â­â­â­â­` |
| ğŸ“Š **èŒƒå›´åˆ†ç‰‡** | `æ•°æ®æŒ‰æ—¶é—´æˆ–IDè¿ç»­` | `æŸ¥è¯¢ç®€å•ï¼Œæ‰¹é‡å¤„ç†å¿«` | `å¯èƒ½è´Ÿè½½ä¸å‡è¡¡` | `â­â­â­â­` |
| ğŸ·ï¸ **æ ‡ç­¾åˆ†ç‰‡** | `æ•°æ®æœ‰æ˜ç¡®åˆ†ç±»æ ‡è¯†` | `ä¸šåŠ¡æ„ä¹‰æ¸…æ™°` | `éœ€è¦é¢„è®¾åˆ†ç±»é€»è¾‘` | `â­â­â­` |

### 4.2 å–æ¨¡åˆ†ç‰‡è¯¦ç»†å®ç°


**ğŸ”¸ æ•°æ®åº“å±‚é¢å®ç°**
```sql
-- MySQLå–æ¨¡åˆ†ç‰‡æŸ¥è¯¢ç¤ºä¾‹
SELECT * FROM orders 
WHERE MOD(order_id, #{shardTotal}) = #{shardIndex}
ORDER BY order_id;

-- å®é™…æ‰§è¡Œæ•ˆæœï¼š
-- åˆ†ç‰‡0ï¼šSELECT * FROM orders WHERE MOD(order_id, 3) = 0
-- åˆ†ç‰‡1ï¼šSELECT * FROM orders WHERE MOD(order_id, 3) = 1  
-- åˆ†ç‰‡2ï¼šSELECT * FROM orders WHERE MOD(order_id, 3) = 2
```

**ğŸ’» Javaä»£ç å®ç°**
```java
@Service
public class OrderShardingService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * æ ¹æ®åˆ†ç‰‡å‚æ•°è·å–è®¢å•æ•°æ®
     */
    public List<Order> getOrdersByShard(int shardIndex, int shardTotal) {
        // ä½¿ç”¨MyBatis-Plusçš„æ¡ä»¶æ„é€ å™¨
        QueryWrapper<Order> queryWrapper = new QueryWrapper<>();
        queryWrapper.apply("order_id % {0} = {1}", shardTotal, shardIndex);
        queryWrapper.orderByAsc("order_id");
        
        List<Order> orders = orderMapper.selectList(queryWrapper);
        
        // è®°å½•å¤„ç†æ—¥å¿—
        log.info("åˆ†ç‰‡[{}/{}]æŸ¥è¯¢åˆ°{}æ¡è®¢å•", shardIndex, shardTotal, orders.size());
        
        return orders;
    }
}
```

### 4.3 èŒƒå›´åˆ†ç‰‡è¯¦ç»†å®ç°


**ğŸ“Š åˆ†é¡µèŒƒå›´è®¡ç®—**
```java
@Service  
public class ProductRangeShardingService {
    
    /**
     * è®¡ç®—å½“å‰åˆ†ç‰‡åº”å¤„ç†çš„æ•°æ®èŒƒå›´
     */
    public PageInfo calculateShardRange(int shardIndex, int shardTotal) {
        // 1. è·å–æ€»æ•°æ®é‡
        long totalCount = productMapper.selectCount(null);
        
        // 2. è®¡ç®—æ¯ä¸ªåˆ†ç‰‡çš„æ•°æ®é‡ï¼ˆå‘ä¸Šå–æ•´ï¼‰
        long shardSize = (totalCount + shardTotal - 1) / shardTotal;
        
        // 3. è®¡ç®—å½“å‰åˆ†ç‰‡çš„èµ·å§‹ä½ç½®
        long offset = shardIndex * shardSize;
        
        // 4. å¤„ç†æœ€åä¸€ä¸ªåˆ†ç‰‡çš„è¾¹ç•Œæƒ…å†µ
        long limit = Math.min(shardSize, totalCount - offset);
        
        return new PageInfo(offset, limit);
    }
    
    /**
     * åˆ†é¡µä¿¡æ¯ç±»
     */
    @Data
    public static class PageInfo {
        private long offset;  // èµ·å§‹ä½ç½®
        private long limit;   // æ•°æ®æ¡æ•°
        
        public PageInfo(long offset, long limit) {
            this.offset = offset;
            this.limit = limit;
        }
    }
}
```

### 4.4 å¤åˆåˆ†ç‰‡ç­–ç•¥


**ğŸ”„ æ—¶é—´+å–æ¨¡æ··åˆåˆ†ç‰‡**
```java
@XxlJob("orderProcessWithDateShard")
public void processOrdersWithDateShard() {
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();
    
    // å…ˆæŒ‰æ—¥æœŸèŒƒå›´åˆ†ç‰‡ï¼ˆæ¯”å¦‚å¤„ç†æ˜¨å¤©çš„æ•°æ®ï¼‰
    LocalDate yesterday = LocalDate.now().minusDays(1);
    LocalDateTime startTime = yesterday.atStartOfDay();
    LocalDateTime endTime = yesterday.plusDays(1).atStartOfDay();
    
    // å†åœ¨æ—¥æœŸèŒƒå›´å†…æŒ‰IDå–æ¨¡åˆ†ç‰‡
    List<Order> orders = orderMapper.selectList(
        new QueryWrapper<Order>()
            .between("create_time", startTime, endTime)
            .apply("order_id % {0} = {1}", shardTotal, shardIndex)
    );
    
    // å¤„ç†è®¢å•
    processOrders(orders);
    
    XxlJobHelper.log("å¤„ç†äº†{}å¹´{}æœˆ{}æ—¥çš„{}æ¡è®¢å•", 
        yesterday.getYear(), yesterday.getMonthValue(), 
        yesterday.getDayOfMonth(), orders.size());
}
```

---

## 5. âš¡ åˆ†å¸ƒå¼å¹¶è¡Œæ‰§è¡Œå®ç°


### 5.1 å¹¶è¡Œæ‰§è¡Œçš„å®ç°åŸç†


**ğŸ”„ æ‰§è¡Œæ—¶åºå›¾**
```
æ—¶é—´è½´    è°ƒåº¦ä¸­å¿ƒ         æ‰§è¡Œå™¨1         æ‰§è¡Œå™¨2         æ‰§è¡Œå™¨3
  |         |              |              |              |
  |    è§¦å‘ä»»åŠ¡å¹¿æ’­         |              |              |
  |         |â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”>|              |              |
  |         |â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”>|              |
  |         |â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”>|
  |         |              |              |              |
  |    å„æ‰§è¡Œå™¨åŒæ—¶å¼€å§‹æ‰§è¡Œ  |              |              |
  |         |              |==å¤„ç†åˆ†ç‰‡0===|              |
  |         |              |              |==å¤„ç†åˆ†ç‰‡1===|
  |         |              |              |              |==å¤„ç†åˆ†ç‰‡2==|
  |         |              |              |              |
  |    æ‰§è¡Œå®Œæˆè¿”å›ç»“æœ     |              |              |
  |         |<â”â”â”â”â”â”â”â”â”â”â”â”â”â”|              |              |
  |         |<â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”|              |
  |         |<â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”|
  |         |              |              |              |
  |      ä»»åŠ¡æ‰§è¡Œå®Œæˆ       |              |              |
  â–¼         â–¼              â–¼              â–¼              â–¼
```

**ğŸ’¡ å¹¶è¡Œæ‰§è¡Œçš„æ ¸å¿ƒè¦ç´ **
```
ğŸ¯ ä»»åŠ¡éš”ç¦»ï¼šæ¯ä¸ªæ‰§è¡Œå™¨å¤„ç†ä¸åŒçš„æ•°æ®ï¼Œé¿å…é‡å¤å¤„ç†
âš¡ åŒæ—¶æ‰§è¡Œï¼šæ‰€æœ‰æ‰§è¡Œå™¨åœ¨åŒä¸€æ—¶é—´å¼€å§‹å·¥ä½œï¼Œæœ€å¤§åŒ–å¹¶è¡Œåº¦
ğŸ”„ çŠ¶æ€åŒæ­¥ï¼šè°ƒåº¦ä¸­å¿ƒç»Ÿä¸€ç®¡ç†ä»»åŠ¡çŠ¶æ€å’Œæ‰§è¡Œç»“æœ
ğŸ“Š ç»“æœæ±‡æ€»ï¼šæ”¶é›†å„ä¸ªåˆ†ç‰‡çš„æ‰§è¡Œç»“æœï¼Œå½¢æˆå®Œæ•´çš„ä»»åŠ¡æŠ¥å‘Š
```

### 5.2 å¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½ä¼˜åŒ–


**ğŸ“ˆ æ€§èƒ½æå‡è®¡ç®—**
```
ç†æƒ³æƒ…å†µä¸‹çš„æ€§èƒ½æå‡ï¼š

å•æœºå¤„ç†æ—¶é—´ï¼šT
åˆ†ç‰‡æ‰§è¡Œå™¨æ•°é‡ï¼šN
ç†è®ºå¹¶è¡Œæ—¶é—´ï¼šT/N

å®é™…ç¤ºä¾‹ï¼š
- å•æœºå¤„ç†100ä¸‡æ¡æ•°æ®ï¼š60åˆ†é’Ÿ
- 3å°æœºå™¨å¹¶è¡Œå¤„ç†ï¼šçº¦20åˆ†é’Ÿ
- 5å°æœºå™¨å¹¶è¡Œå¤„ç†ï¼šçº¦12åˆ†é’Ÿ

æ³¨æ„ï¼šå®é™…æ€§èƒ½å—é™äºï¼š
âš ï¸ æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
âš ï¸ ç½‘ç»œä¼ è¾“å»¶è¿Ÿ  
âš ï¸ å„æœºå™¨å¤„ç†èƒ½åŠ›å·®å¼‚
âš ï¸ æ•°æ®åˆ†å¸ƒæ˜¯å¦å‡åŒ€
```

**ğŸ”§ æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜**
```java
@XxlJob("performanceMonitorJob")
public void monitorJobPerformance() {
    long startTime = System.currentTimeMillis();
    
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();
    
    // å¤„ç†ä¸šåŠ¡æ•°æ®
    List<DataRecord> records = processDataByShard(shardIndex, shardTotal);
    
    long endTime = System.currentTimeMillis();
    long executionTime = endTime - startTime;
    
    // è®°å½•æ€§èƒ½æŒ‡æ ‡
    XxlJobHelper.log("åˆ†ç‰‡{}æ‰§è¡Œå®Œæˆ: å¤„ç†{}æ¡è®°å½•, è€—æ—¶{}ms, å¹³å‡{}ms/æ¡", 
        shardIndex, records.size(), executionTime, 
        records.isEmpty() ? 0 : executionTime / records.size());
    
    // å¯ä»¥å°†æ€§èƒ½æ•°æ®å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    sendPerformanceMetrics(shardIndex, records.size(), executionTime);
}
```

### 5.3 å¤„ç†æ•°æ®å€¾æ–œé—®é¢˜


**âš ï¸ æ•°æ®å€¾æ–œçš„è¯†åˆ«**
```
ä»€ä¹ˆæ˜¯æ•°æ®å€¾æ–œï¼š
æŸäº›åˆ†ç‰‡å¤„ç†çš„æ•°æ®é‡æ˜æ˜¾å¤šäºå…¶ä»–åˆ†ç‰‡ï¼Œå¯¼è‡´æ•´ä½“ä»»åŠ¡å®Œæˆæ—¶é—´è¢«æœ€æ…¢çš„åˆ†ç‰‡æ‹–ç´¯

å¸¸è§åŸå› ï¼š
ğŸ”¸ æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼ˆå¦‚æŸäº›IDèŒƒå›´çš„æ•°æ®ç‰¹åˆ«å¤šï¼‰
ğŸ”¸ ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦ä¸åŒï¼ˆæŸäº›æ•°æ®å¤„ç†æ›´è€—æ—¶ï¼‰
ğŸ”¸ æœºå™¨æ€§èƒ½å·®å¼‚ï¼ˆæŸå°æœºå™¨é…ç½®è¾ƒä½ï¼‰

è¯†åˆ«æ–¹æ³•ï¼š
ğŸ“Š ç›‘æ§å„åˆ†ç‰‡çš„æ‰§è¡Œæ—¶é—´å·®å¼‚
ğŸ“Š ç»Ÿè®¡å„åˆ†ç‰‡å¤„ç†çš„æ•°æ®é‡
ğŸ“Š è§‚å¯Ÿä»»åŠ¡å®Œæˆçš„æ—¶é—´åˆ†å¸ƒ
```

**ğŸ”„ æ•°æ®å€¾æ–œçš„è§£å†³æ–¹æ¡ˆ**
```java
/**
 * åŠ¨æ€åˆ†ç‰‡å¤§å°è°ƒæ•´ç­–ç•¥
 */
@Service
public class DynamicShardingService {
    
    /**
     * æ ¹æ®å†å²æ‰§è¡Œæƒ…å†µåŠ¨æ€è°ƒæ•´åˆ†ç‰‡ç­–ç•¥
     */
    public List<DataRecord> getDataWithDynamicSharding(int shardIndex, int shardTotal) {
        // è·å–å†å²æ‰§è¡Œç»Ÿè®¡
        ShardExecutionStats stats = getHistoricalStats();
        
        if (stats.hasDataSkew()) {
            // å­˜åœ¨æ•°æ®å€¾æ–œï¼Œä½¿ç”¨åŠ¨æ€åˆ†ç‰‡
            return getDataWithBalancedSharding(shardIndex, shardTotal, stats);
        } else {
            // æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œä½¿ç”¨æ ‡å‡†å–æ¨¡åˆ†ç‰‡
            return getDataWithStandardSharding(shardIndex, shardTotal);
        }
    }
    
    private List<DataRecord> getDataWithBalancedSharding(
            int shardIndex, int shardTotal, ShardExecutionStats stats) {
        
        // æ ¹æ®å†å²æ€§èƒ½è°ƒæ•´åˆ†ç‰‡æƒé‡
        double weight = stats.getShardWeight(shardIndex);
        
        // è®¡ç®—è°ƒæ•´åçš„æ•°æ®èŒƒå›´
        int adjustedStart = (int) (shardIndex * weight * 1000);
        int adjustedEnd = (int) ((shardIndex + 1) * weight * 1000);
        
        return dataMapper.selectByIdRange(adjustedStart, adjustedEnd);
    }
}
```

---

## 6. ğŸ¤ åˆ†ç‰‡ä»»åŠ¡åè°ƒæœºåˆ¶


### 6.1 åˆ†ç‰‡ä»»åŠ¡çš„åè°ƒåŸç†


**ğŸ¯ åè°ƒæœºåˆ¶æ¦‚è¿°**
```
åˆ†ç‰‡ä»»åŠ¡åè°ƒ = ä»»åŠ¡åˆ†å‘ + çŠ¶æ€ç®¡ç† + ç»“æœæ±‡æ€»

æ ¸å¿ƒèŒè´£ï¼š
ğŸ“‹ ä»»åŠ¡åˆ†å‘ï¼šç¡®ä¿æ¯ä¸ªæ‰§è¡Œå™¨çŸ¥é“è‡ªå·±è¦å¤„ç†ä»€ä¹ˆ
ğŸ“Š çŠ¶æ€è·Ÿè¸ªï¼šå®æ—¶ç›‘æ§å„åˆ†ç‰‡çš„æ‰§è¡ŒçŠ¶æ€
ğŸ”„ æ•…éšœå¤„ç†ï¼šå¤„ç†åˆ†ç‰‡æ‰§è¡Œå¤±è´¥çš„æƒ…å†µ
ğŸ“ˆ ç»“æœæ±‡æ€»ï¼šæ”¶é›†å¹¶æ•´åˆå„åˆ†ç‰‡çš„æ‰§è¡Œç»“æœ
```

**ğŸ—ï¸ åè°ƒæ¶æ„å›¾**
```
                    è°ƒåº¦ä¸­å¿ƒï¼ˆåè°ƒè€…ï¼‰
                         |
                    ä»»åŠ¡çŠ¶æ€ç®¡ç†
                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    |     |     |
               åˆ†ç‰‡çŠ¶æ€è¡¨ æ—¥å¿—è¡¨ ç»Ÿè®¡è¡¨
                    |     |     |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |           |           |           |
   æ‰§è¡Œå™¨1      æ‰§è¡Œå™¨2      æ‰§è¡Œå™¨3      æ‰§è¡Œå™¨N
  (åˆ†ç‰‡0)      (åˆ†ç‰‡1)      (åˆ†ç‰‡2)      (åˆ†ç‰‡N-1)
     |           |           |           |
  å¤„ç†æ•°æ®A    å¤„ç†æ•°æ®B    å¤„ç†æ•°æ®C    å¤„ç†æ•°æ®X
```

### 6.2 ä»»åŠ¡çŠ¶æ€ç®¡ç†


**ğŸ“‹ åˆ†ç‰‡çŠ¶æ€è¿½è¸ª**
```java
/**
 * åˆ†ç‰‡æ‰§è¡ŒçŠ¶æ€æšä¸¾
 */
public enum ShardExecutionStatus {
    WAITING("ç­‰å¾…æ‰§è¡Œ"),
    RUNNING("æ­£åœ¨æ‰§è¡Œ"), 
    SUCCESS("æ‰§è¡ŒæˆåŠŸ"),
    FAILED("æ‰§è¡Œå¤±è´¥"),
    TIMEOUT("æ‰§è¡Œè¶…æ—¶");
    
    private final String description;
    
    ShardExecutionStatus(String description) {
        this.description = description;
    }
}

/**
 * åˆ†ç‰‡æ‰§è¡ŒçŠ¶æ€ç®¡ç†æœåŠ¡
 */
@Service
public class ShardExecutionManager {
    
    /**
     * æ›´æ–°åˆ†ç‰‡æ‰§è¡ŒçŠ¶æ€
     */
    public void updateShardStatus(String jobId, int shardIndex, 
                                 ShardExecutionStatus status, String message) {
        ShardExecution execution = ShardExecution.builder()
            .jobId(jobId)
            .shardIndex(shardIndex)
            .status(status)
            .updateTime(new Date())
            .message(message)
            .build();
            
        shardExecutionMapper.updateById(execution);
        
        // å¦‚æœæ‰€æœ‰åˆ†ç‰‡éƒ½å®Œæˆäº†ï¼Œæ›´æ–°æ•´ä¸ªä»»åŠ¡çŠ¶æ€
        checkAndUpdateJobStatus(jobId);
    }
    
    /**
     * æ£€æŸ¥å¹¶æ›´æ–°ä»»åŠ¡æ•´ä½“çŠ¶æ€
     */
    private void checkAndUpdateJobStatus(String jobId) {
        List<ShardExecution> allShards = shardExecutionMapper
            .selectByJobId(jobId);
            
        boolean allCompleted = allShards.stream()
            .allMatch(shard -> shard.getStatus() == ShardExecutionStatus.SUCCESS 
                           || shard.getStatus() == ShardExecutionStatus.FAILED);
                           
        if (allCompleted) {
            // æ‰€æœ‰åˆ†ç‰‡å®Œæˆï¼Œæ›´æ–°ä»»åŠ¡çŠ¶æ€
            updateJobFinalStatus(jobId, allShards);
        }
    }
}
```

### 6.3 åˆ†ç‰‡æ•…éšœå¤„ç†


**ğŸ”§ æ•…éšœæ£€æµ‹ä¸å¤„ç†**
```java
@Component
public class ShardFailureHandler {
    
    /**
     * å¤„ç†åˆ†ç‰‡æ‰§è¡Œå¤±è´¥
     */
    @XxlJob("handleShardFailure") 
    public void handleFailedShards() {
        // æŸ¥æ‰¾æ‰§è¡Œå¤±è´¥çš„åˆ†ç‰‡
        List<ShardExecution> failedShards = findFailedShards();
        
        for (ShardExecution failedShard : failedShards) {
            if (shouldRetry(failedShard)) {
                // é‡æ–°æ‰§è¡Œå¤±è´¥çš„åˆ†ç‰‡
                retryFailedShard(failedShard);
            } else {
                // æ ‡è®°ä¸ºæœ€ç»ˆå¤±è´¥
                markAsFinalFailure(failedShard);
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦åº”è¯¥é‡è¯•
     */
    private boolean shouldRetry(ShardExecution shard) {
        return shard.getRetryCount() < MAX_RETRY_COUNT 
            && !isUnrecoverableError(shard.getErrorMessage());
    }
    
    /**
     * é‡è¯•å¤±è´¥çš„åˆ†ç‰‡
     */
    private void retryFailedShard(ShardExecution shard) {
        try {
            // æ‰¾åˆ°å¯ç”¨çš„æ‰§è¡Œå™¨é‡æ–°æ‰§è¡Œ
            String availableExecutor = findAvailableExecutor();
            
            // å‘é€é‡è¯•ä»»åŠ¡
            xxlJobService.triggerShardRetry(shard.getJobId(), 
                shard.getShardIndex(), availableExecutor);
                
            // æ›´æ–°é‡è¯•æ¬¡æ•°
            shard.setRetryCount(shard.getRetryCount() + 1);
            shard.setStatus(ShardExecutionStatus.WAITING);
            shardExecutionMapper.updateById(shard);
            
        } catch (Exception e) {
            log.error("é‡è¯•åˆ†ç‰‡å¤±è´¥: {}", e.getMessage(), e);
        }
    }
}
```

### 6.4 åˆ†ç‰‡ç»“æœæ±‡æ€»


**ğŸ“Š ç»“æœæ”¶é›†ä¸ç»Ÿè®¡**
```java
@Service
public class ShardResultAggregator {
    
    /**
     * æ±‡æ€»åˆ†ç‰‡æ‰§è¡Œç»“æœ
     */
    public JobExecutionSummary aggregateShardResults(String jobId) {
        List<ShardExecution> shards = shardExecutionMapper.selectByJobId(jobId);
        
        JobExecutionSummary summary = new JobExecutionSummary();
        summary.setJobId(jobId);
        summary.setTotalShards(shards.size());
        
        long totalProcessed = 0;
        long totalDuration = 0;
        int successCount = 0;
        int failedCount = 0;
        
        for (ShardExecution shard : shards) {
            totalProcessed += shard.getProcessedCount();
            totalDuration += shard.getDuration();
            
            if (shard.getStatus() == ShardExecutionStatus.SUCCESS) {
                successCount++;
            } else if (shard.getStatus() == ShardExecutionStatus.FAILED) {
                failedCount++;
            }
        }
        
        summary.setTotalProcessedRecords(totalProcessed);
        summary.setAverageDuration(totalDuration / shards.size());
        summary.setSuccessShards(successCount);
        summary.setFailedShards(failedCount);
        summary.setSuccessRate((double) successCount / shards.size() * 100);
        
        return summary;
    }
    
    /**
     * ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
     */
    public String generateExecutionReport(String jobId) {
        JobExecutionSummary summary = aggregateShardResults(jobId);
        
        StringBuilder report = new StringBuilder();
        report.append("===== åˆ†ç‰‡ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š =====\n");
        report.append("ä»»åŠ¡ID: ").append(jobId).append("\n");
        report.append("æ€»åˆ†ç‰‡æ•°: ").append(summary.getTotalShards()).append("\n");
        report.append("æˆåŠŸåˆ†ç‰‡: ").append(summary.getSuccessShards()).append("\n");
        report.append("å¤±è´¥åˆ†ç‰‡: ").append(summary.getFailedShards()).append("\n");
        report.append("æˆåŠŸç‡: ").append(String.format("%.2f%%", summary.getSuccessRate())).append("\n");
        report.append("å¤„ç†è®°å½•æ•°: ").append(summary.getTotalProcessedRecords()).append("\n");
        report.append("å¹³å‡è€—æ—¶: ").append(summary.getAverageDuration()).append("ms\n");
        
        return report.toString();
    }
}
```

---

## 7. ğŸ’¼ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹


### 7.1 åˆ†ç‰‡ä»»åŠ¡è®¾è®¡æœ€ä½³å®è·µ


**âœ… è®¾è®¡åŸåˆ™**
```
ğŸ¯ æ•°æ®æ— å…³æ€§åŸåˆ™ï¼š
- å„åˆ†ç‰‡å¤„ç†çš„æ•°æ®ä¹‹é—´ä¸èƒ½æœ‰ä¾èµ–å…³ç³»
- åˆ†ç‰‡Açš„ç»“æœä¸èƒ½å½±å“åˆ†ç‰‡Bçš„æ‰§è¡Œ
- ç¡®ä¿å¯ä»¥ç‹¬ç«‹å¹¶è¡Œæ‰§è¡Œ

ğŸ’¡ å®ä¾‹è¯´æ˜ï¼š
æ­£ç¡®ç¤ºä¾‹ï¼šç”¨æˆ·æ•°æ®åŒæ­¥
- æ¯ä¸ªåˆ†ç‰‡åŒæ­¥ä¸åŒçš„ç”¨æˆ·
- ç”¨æˆ·ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œå¯ä»¥å¹¶è¡Œå¤„ç†

é”™è¯¯ç¤ºä¾‹ï¼šè®¢å•çŠ¶æ€æµè½¬
- è®¢å•æœ‰çŠ¶æ€ä¾èµ–ï¼šå¾…ä»˜æ¬¾â†’å·²ä»˜æ¬¾â†’å·²å‘è´§â†’å·²å®Œæˆ
- ä¸èƒ½å¹¶è¡Œå¤„ç†åŒä¸€è®¢å•çš„ä¸åŒçŠ¶æ€
```

**âš–ï¸ æ•°æ®åˆ†ç‰‡å‡åŒ€æ€§**
```java
/**
 * ç¡®ä¿æ•°æ®åˆ†ç‰‡å‡åŒ€çš„æ£€æŸ¥æ–¹æ³•
 */
@Service
public class DataDistributionChecker {
    
    /**
     * æ£€æŸ¥æ•°æ®åˆ†å¸ƒæ˜¯å¦å‡åŒ€
     */
    public void checkDataDistribution(int shardTotal) {
        Map<Integer, Long> shardCounts = new HashMap<>();
        
        // ç»Ÿè®¡å„åˆ†ç‰‡çš„æ•°æ®é‡
        for (int i = 0; i < shardTotal; i++) {
            long count = countDataBySharding(i, shardTotal);
            shardCounts.put(i, count);
        }
        
        // è®¡ç®—æ•°æ®åˆ†å¸ƒçš„æ ‡å‡†å·®
        double variance = calculateVariance(shardCounts.values());
        double standardDeviation = Math.sqrt(variance);
        
        // å¦‚æœæ ‡å‡†å·®è¿‡å¤§ï¼Œè¯´æ˜æ•°æ®åˆ†å¸ƒä¸å‡åŒ€
        if (standardDeviation > ACCEPTABLE_DEVIATION) {
            log.warn("æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼Œæ ‡å‡†å·®: {}", standardDeviation);
            log.warn("å„åˆ†ç‰‡æ•°æ®é‡: {}", shardCounts);
        } else {
            log.info("æ•°æ®åˆ†å¸ƒè‰¯å¥½ï¼Œå„åˆ†ç‰‡æ•°æ®é‡ç›¸å¯¹å‡åŒ€");
        }
    }
}
```

### 7.2 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ é—®é¢˜1ï¼šåˆ†ç‰‡æ•°æ®é‡å¤å¤„ç†**
```
é—®é¢˜ç°è±¡ï¼š
- åŒä¸€æ¡æ•°æ®è¢«å¤šä¸ªåˆ†ç‰‡å¤„ç†
- å¯¼è‡´ä¸šåŠ¡æ•°æ®å¼‚å¸¸æˆ–é‡å¤

æ ¹æœ¬åŸå› ï¼š
- åˆ†ç‰‡é€»è¾‘æœ‰é”™è¯¯ï¼Œæ•°æ®åˆ†é…é‡å 
- ä»»åŠ¡é‡å¤æ‰§è¡Œï¼Œä½†æ²¡æœ‰åšå¹‚ç­‰å¤„ç†

è§£å†³æ–¹æ¡ˆï¼š
```

```java
/**
 * æ·»åŠ åˆ†ç‰‡æ•°æ®å”¯ä¸€æ€§æ ¡éªŒ
 */
public List<Order> getOrdersWithValidation(int shardIndex, int shardTotal) {
    List<Order> orders = getOrdersByShard(shardIndex, shardTotal);
    
    // æ ¡éªŒæ•°æ®æ˜¯å¦å±äºå½“å‰åˆ†ç‰‡
    orders = orders.stream()
        .filter(order -> order.getId() % shardTotal == shardIndex)
        .collect(Collectors.toList());
        
    return orders;
}

/**
 * æ·»åŠ å¹‚ç­‰æ€§å¤„ç†
 */
@XxlJob("idempotentDataProcess")
public void processDataWithIdempotent() {
    String executionId = XxlJobHelper.getJobId() + "-" + System.currentTimeMillis();
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
    if (isAlreadyProcessed(executionId)) {
        XxlJobHelper.log("ä»»åŠ¡å·²å¤„ç†è¿‡ï¼Œè·³è¿‡æ‰§è¡Œ");
        return;
    }
    
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        processBusinessData();
        
        // æ ‡è®°ä¸ºå·²å¤„ç†
        markAsProcessed(executionId);
        
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥æ—¶æ¸…é™¤æ ‡è®°ï¼Œå…è®¸é‡è¯•
        clearProcessedMark(executionId);
        throw e;
    }
}
```

**âš ï¸ é—®é¢˜2ï¼šå•ä¸ªåˆ†ç‰‡æ‰§è¡Œæ—¶é—´è¿‡é•¿**
```
é—®é¢˜ç°è±¡ï¼š
- å…¶ä»–åˆ†ç‰‡éƒ½å®Œæˆäº†ï¼Œåªæœ‰ä¸€ä¸ªåˆ†ç‰‡è¿˜åœ¨æ‰§è¡Œ
- æ•´ä½“ä»»åŠ¡è¢«æœ€æ…¢çš„åˆ†ç‰‡æ‹–ç´¯

è§£å†³æ–¹æ¡ˆï¼š
```

```java
/**
 * åˆ†ç‰‡æ‰§è¡Œè¶…æ—¶å¤„ç†
 */
@XxlJob("timeoutControlJob")
public void processWithTimeout() {
    long startTime = System.currentTimeMillis();
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();
    
    List<DataRecord> records = getDataByShard(shardIndex, shardTotal);
    
    for (DataRecord record : records) {
        // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
        if (System.currentTimeMillis() - startTime > MAX_EXECUTION_TIME) {
            XxlJobHelper.log("åˆ†ç‰‡{}æ‰§è¡Œè¶…æ—¶ï¼Œå·²å¤„ç†{}æ¡ï¼Œå‰©ä½™{}æ¡", 
                shardIndex, processedCount, records.size() - processedCount);
            
            // å°†æœªå¤„ç†çš„æ•°æ®è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡ç»§ç»­å¤„ç†
            saveUnprocessedRecords(records.subList(processedCount, records.size()));
            break;
        }
        
        processRecord(record);
        processedCount++;
    }
}
```

### 7.3 æ€§èƒ½è°ƒä¼˜å»ºè®®


**ğŸ“ˆ æ‰§è¡Œå™¨æ•°é‡ä¼˜åŒ–**
```
æ‰§è¡Œå™¨æ•°é‡ vs æ€§èƒ½å…³ç³»ï¼š

æ‰§è¡Œå™¨è¿‡å°‘ï¼š
âŒ å¹¶è¡Œåº¦ä¸å¤Ÿï¼Œæ— æ³•å……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æº
âŒ å•ä¸ªåˆ†ç‰‡æ•°æ®é‡è¿‡å¤§ï¼Œæ‰§è¡Œæ—¶é—´é•¿

æ‰§è¡Œå™¨è¿‡å¤šï¼š
âŒ åˆ†ç‰‡ç²’åº¦å¤ªç»†ï¼Œç®¡ç†å¼€é”€å¢å¤§
âŒ æ•°æ®åº“è¿æ¥å‹åŠ›å¢å¤§
âŒ ç½‘ç»œé€šä¿¡å¼€é”€å¢åŠ 

æœ€ä½³å®è·µï¼š
âœ… æ ¹æ®æ•°æ®é‡å’Œå¤„ç†å¤æ‚åº¦ç¡®å®šåˆ†ç‰‡æ•°
âœ… ä¸€èˆ¬å»ºè®®ï¼šæ•°æ®é‡ / åˆ†ç‰‡æ•° = 1ä¸‡~10ä¸‡æ¡
âœ… å¯ä»¥ä»å°‘åˆ°å¤šé€æ­¥è°ƒæ•´ï¼Œæ‰¾åˆ°æœ€ä½³ç‚¹
```

**ğŸ’¾ èµ„æºä½¿ç”¨ä¼˜åŒ–**
```java
/**
 * å†…å­˜ä½¿ç”¨ä¼˜åŒ–
 */
@XxlJob("memoryOptimizedJob")
public void processDataWithMemoryOptimization() {
    int shardIndex = XxlJobHelper.getShardIndex();
    int shardTotal = XxlJobHelper.getShardTotal();
    
    // åˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®
    int batchSize = 1000;
    int offset = 0;
    
    while (true) {
        List<DataRecord> batch = getDataBatch(shardIndex, shardTotal, offset, batchSize);
        
        if (batch.isEmpty()) {
            break; // æ²¡æœ‰æ›´å¤šæ•°æ®
        }
        
        // å¤„ç†è¿™ä¸€æ‰¹æ•°æ®
        processBatch(batch);
        
        // åŠæ—¶é‡Šæ”¾å†…å­˜
        batch.clear();
        batch = null;
        
        // å»ºè®®GCå›æ”¶
        System.gc();
        
        offset += batchSize;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 åˆ†ç‰‡æ‰§è¡Œæ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ åˆ†ç‰‡æ‰§è¡Œ = å¤§ä»»åŠ¡æ‹†åˆ† + å¤šæœºå¹¶è¡Œå¤„ç†
ğŸ”§ åˆ†ç‰‡å¹¿æ’­ = åŒæ—¶é€šçŸ¥æ‰€æœ‰æ‰§è¡Œå™¨ + å„è‡ªå¤„ç†ä¸åŒæ•°æ®
ğŸ“Š åˆ†ç‰‡å‚æ•° = å½“å‰åˆ†ç‰‡ç´¢å¼• + æ€»åˆ†ç‰‡æ•°
âš¡ å¹¶è¡Œæ‰§è¡Œ = å¤šä¸ªåˆ†ç‰‡åŒæ—¶å·¥ä½œ + æå‡æ•´ä½“æ€§èƒ½
```

### 8.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¸ åˆ†ç‰‡å‚æ•°è·å–**
```java
// æ ¸å¿ƒAPIï¼Œå¿…é¡»æŒæ¡
int shardIndex = XxlJobHelper.getShardIndex(); // æˆ‘æ˜¯ç¬¬å‡ ä¸ª
int shardTotal = XxlJobHelper.getShardTotal(); // æ€»å…±å‡ ä¸ª
```

**ğŸ”¸ æ•°æ®åˆ†ç‰‡ç­–ç•¥**
```
å–æ¨¡åˆ†ç‰‡ï¼šID % æ€»æ•° = åˆ†ç‰‡ç´¢å¼•ï¼ˆæœ€å¸¸ç”¨ï¼‰
èŒƒå›´åˆ†ç‰‡ï¼šæŒ‰æ•°æ®èŒƒå›´å¹³å‡åˆ†é…
æ··åˆåˆ†ç‰‡ï¼šç»“åˆæ—¶é—´ã€IDç­‰å¤šç»´åº¦åˆ†ç‰‡
```

**ğŸ”¸ æ•…éšœå¤„ç†æœºåˆ¶**
```
âœ… å•ä¸ªåˆ†ç‰‡å¤±è´¥ä¸å½±å“å…¶ä»–åˆ†ç‰‡
âœ… æ”¯æŒå¤±è´¥é‡è¯•å’Œæ•…éšœè½¬ç§»
âœ… æä¾›è¯¦ç»†çš„æ‰§è¡ŒçŠ¶æ€ç›‘æ§
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ é€‚ç”¨çš„ä¸šåŠ¡åœºæ™¯**
- ğŸ¢ **å¤§æ•°æ®å¤„ç†**ï¼šç”¨æˆ·æ•°æ®åŒæ­¥ã€è®¢å•æ‰¹å¤„ç†ã€æ—¥å¿—åˆ†æ
- ğŸ“Š **å®šæ—¶ç»Ÿè®¡**ï¼šæ—¥æŠ¥ç”Ÿæˆã€æ•°æ®æ±‡æ€»ã€æŒ‡æ ‡è®¡ç®—  
- ğŸ”„ **æ•°æ®è¿ç§»**ï¼šåº“è¡¨è¿ç§»ã€æ•°æ®æ¸…æ´—ã€æ ¼å¼è½¬æ¢
- ğŸ“¤ **æ‰¹é‡é€šçŸ¥**ï¼šé‚®ä»¶å‘é€ã€çŸ­ä¿¡ç¾¤å‘ã€æ¶ˆæ¯æ¨é€

**ğŸš€ æ€§èƒ½æå‡æ•ˆæœ**
- âš¡ å¤„ç†é€Ÿåº¦ï¼šç†è®ºä¸Šå¯æå‡Nå€ï¼ˆNä¸ºæ‰§è¡Œå™¨æ•°é‡ï¼‰
- ğŸ“ˆ ç³»ç»Ÿååï¼šå……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼Œå¤„ç†æ›´å¤šä»»åŠ¡
- ğŸ”„ å®¹é”™èƒ½åŠ›ï¼šå•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“ä»»åŠ¡æ‰§è¡Œ

### 8.4 å¼€å‘æ³¨æ„äº‹é¡¹


**âœ… å¿…é¡»éµå¾ªçš„åŸåˆ™**
```
æ•°æ®ç‹¬ç«‹æ€§ï¼šå„åˆ†ç‰‡å¤„ç†çš„æ•°æ®å¿…é¡»ç›¸äº’ç‹¬ç«‹
å¹‚ç­‰æ€§è®¾è®¡ï¼šé‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
å‡åŒ€åˆ†å¸ƒï¼šç¡®ä¿å„åˆ†ç‰‡çš„å·¥ä½œé‡ç›¸å¯¹å¹³è¡¡
å¼‚å¸¸å¤„ç†ï¼šå¦¥å–„å¤„ç†åˆ†ç‰‡æ‰§è¡Œå¤±è´¥çš„æƒ…å†µ
```

**âš ï¸ å¸¸è§é¿å‘æŒ‡å—**
```
âŒ é¿å…æ•°æ®ä¾èµ–ï¼šåˆ†ç‰‡é—´ä¸èƒ½æœ‰å…ˆåé¡ºåºè¦æ±‚
âŒ é¿å…çŠ¶æ€å…±äº«ï¼šä¸è¦åœ¨åˆ†ç‰‡é—´å…±äº«å¯å˜çŠ¶æ€
âŒ é¿å…èµ„æºç«äº‰ï¼šé¿å…å¤šä¸ªåˆ†ç‰‡æ“ä½œåŒä¸€èµ„æº
âŒ é¿å…å¿½ç•¥ç›‘æ§ï¼šè¦æœ‰å®Œå–„çš„æ‰§è¡ŒçŠ¶æ€ç›‘æ§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- åˆ†ç‰‡æ‰§è¡Œæé€Ÿåº¦ï¼Œå¹¿æ’­æ¨¡å¼æ¥åˆ†å¸ƒ
- å–æ¨¡èŒƒå›´ä¸¤ç­–ç•¥ï¼Œå‚æ•°è·å–è¦æ¸…æ¥š
- æ•°æ®ç‹¬ç«‹æ˜¯å…³é”®ï¼Œå¹¶è¡Œå¤„ç†æ•ˆç‡é«˜
- æ•…éšœé‡è¯•æœ‰ä¿éšœï¼Œç›‘æ§çŠ¶æ€ä¸å¯å°‘