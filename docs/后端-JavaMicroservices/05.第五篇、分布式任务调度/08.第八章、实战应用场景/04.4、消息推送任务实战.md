---
title: 4ã€æ¶ˆæ¯æ¨é€ä»»åŠ¡å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯æ¨é€åœºæ™¯æ¦‚è¿°](#1-æ¶ˆæ¯æ¨é€åœºæ™¯æ¦‚è¿°)
2. [å®šæ—¶æ¶ˆæ¯æ¨é€å®ç°](#2-å®šæ—¶æ¶ˆæ¯æ¨é€å®ç°)
3. [æ‰¹é‡æ¶ˆæ¯æ¨é€æ–¹æ¡ˆ](#3-æ‰¹é‡æ¶ˆæ¯æ¨é€æ–¹æ¡ˆ)
4. [æ¶ˆæ¯æ¨¡æ¿ç®¡ç†](#4-æ¶ˆæ¯æ¨¡æ¿ç®¡ç†)
5. [å¤šæ¸ é“æ¨é€ç­–ç•¥](#5-å¤šæ¸ é“æ¨é€ç­–ç•¥)
6. [æ¨é€å¤±è´¥é‡è¯•æœºåˆ¶](#6-æ¨é€å¤±è´¥é‡è¯•æœºåˆ¶)
7. [æ¨é€æ•ˆæœç»Ÿè®¡](#7-æ¨é€æ•ˆæœç»Ÿè®¡)
8. [ç”¨æˆ·åˆ†ç»„æ¨é€](#8-ç”¨æˆ·åˆ†ç»„æ¨é€)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“± æ¶ˆæ¯æ¨é€åœºæ™¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯æ¨é€ä»»åŠ¡


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ è®¾ç½®çš„é—¹é’Ÿä¸€æ ·ï¼Œåˆ°äº†æŒ‡å®šæ—¶é—´å°±ä¼šå“ã€‚æ¶ˆæ¯æ¨é€ä»»åŠ¡å°±æ˜¯è®©ç³»ç»Ÿåœ¨ç‰¹å®šæ—¶é—´è‡ªåŠ¨ç»™ç”¨æˆ·å‘é€æ¶ˆæ¯é€šçŸ¥ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
â€¢ æ—©ä¸Š8ç‚¹æ¨é€å¤©æ°”é¢„æŠ¥
â€¢ æ¯å‘¨äº”æ™šä¸Šæ¨é€å‘¨æœ«æ´»åŠ¨
â€¢ æ¯æœˆ1å·æ¨é€è´¦å•é€šçŸ¥
â€¢ é‡è¦æ´»åŠ¨å‰1å°æ—¶æé†’

è¿™äº›éƒ½æ˜¯å…¸å‹çš„å®šæ—¶æ¶ˆæ¯æ¨é€åœºæ™¯
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦XXL-JOBæ¥åšæ¶ˆæ¯æ¨é€


**æ ¸å¿ƒä¼˜åŠ¿**ï¼š

ğŸ”¸ **å‡†æ—¶å¯é **
- ä¸ç”¨æ‹…å¿ƒæ¶ˆæ¯å‘ä¸å‡ºå»
- å®šæ—¶ä»»åŠ¡åˆ°ç‚¹å°±æ‰§è¡Œ
- æ¯”æ‰‹åŠ¨å‘é€æ›´å¯é 

ğŸ”¸ **è‡ªåŠ¨åŒ–è¿è¡Œ**  
- è®¾ç½®ä¸€æ¬¡ï¼Œè‡ªåŠ¨é‡å¤æ‰§è¡Œ
- ä¸éœ€è¦äººå·¥å¹²é¢„
- èŠ‚çœäººåŠ›æˆæœ¬

ğŸ”¸ **æ˜“äºç®¡ç†**
- å¯è§†åŒ–ç•Œé¢é…ç½®
- éšæ—¶å¯åœä»»åŠ¡
- æ‰§è¡Œè®°å½•å¯æŸ¥è¯¢

### 1.3 æ¶ˆæ¯æ¨é€çš„ä¸šåŠ¡æµç¨‹


```
ç”¨æˆ·ç«¯                     XXL-JOBè°ƒåº¦ä¸­å¿ƒ              æ‰§è¡Œå™¨                æ¶ˆæ¯æœåŠ¡
  |                              |                        |                      |
  |                              |--[1]è§¦å‘å®šæ—¶ä»»åŠ¡]------->|                      |
  |                              |                        |--[2]æŸ¥è¯¢æ¨é€åˆ—è¡¨]--->|æ•°æ®åº“
  |                              |                        |<--[3]è¿”å›ç”¨æˆ·æ•°æ®]---|
  |                              |                        |                      |
  |                              |                        |--[4]è°ƒç”¨æ¨é€æ¥å£]---->|
  |                              |                        |                      |-->[5]å‘é€çŸ­ä¿¡/é‚®ä»¶/APPæ¨é€
  |<----------------------[6]æ”¶åˆ°æ¶ˆæ¯é€šçŸ¥]-------------------|                      |
  |                              |                        |                      |
  |                              |<--[7]è¿”å›æ‰§è¡Œç»“æœ]------|                      |
```

### 1.4 å¸¸è§çš„æ¨é€åœºæ™¯åˆ†ç±»


| åœºæ™¯ç±»å‹ | **å…·ä½“ä¾‹å­** | **æ¨é€æ—¶æœº** | **æ¨é€å¯¹è±¡** |
|---------|------------|-------------|-------------|
| ğŸ“… **å®šæœŸé€šçŸ¥** | `è´¦å•é€šçŸ¥ã€æŠ¥è¡¨æ¨é€` | `å›ºå®šæ—¶é—´å‘¨æœŸ` | `æ‰€æœ‰ç”¨æˆ·/ç‰¹å®šç”¨æˆ·` |
| â° **æ´»åŠ¨æé†’** | `è¯¾ç¨‹å¼€è¯¾æé†’ã€ä¼šè®®é€šçŸ¥` | `æ´»åŠ¨å‰Nå°æ—¶/åˆ†é’Ÿ` | `æŠ¥åç”¨æˆ·` |
| ğŸ **è¥é”€æ¨å¹¿** | `ä¼˜æƒ åˆ¸åˆ°æœŸæé†’ã€æ–°å“æ¨è` | `è¥é”€æ—¶æ®µ` | `ç›®æ ‡ç”¨æˆ·ç¾¤` |
| ğŸ“Š **æ•°æ®æŠ¥å‘Š** | `æ—¥æŠ¥ã€å‘¨æŠ¥ã€æœˆæŠ¥` | `å›ºå®šæ—¶é—´ç‚¹` | `ç®¡ç†å‘˜/è®¢é˜…ç”¨æˆ·` |
| ğŸ”” **çŠ¶æ€å˜æ›´** | `è®¢å•å‘è´§é€šçŸ¥ã€å®¡æ‰¹ç»“æœ` | `çŠ¶æ€æ”¹å˜æ—¶` | `å…³è”ç”¨æˆ·` |

---

## 2. â° å®šæ—¶æ¶ˆæ¯æ¨é€å®ç°


### 2.1 åŸºç¡€å®šæ—¶æ¨é€ä»»åŠ¡


**ä¸šåŠ¡åœºæ™¯**ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹ç»™æ‰€æœ‰ç”¨æˆ·æ¨é€å¤©æ°”é¢„æŠ¥

**å®ç°æ­¥éª¤**ï¼š

**â‘  åˆ›å»ºæ¨é€ä»»åŠ¡ç±»**

```java
@Component
public class WeatherPushJob {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private MessageService messageService;
    
    @XxlJob("weatherPushHandler")
    public void execute() {
        // 1. è·å–éœ€è¦æ¨é€çš„ç”¨æˆ·åˆ—è¡¨
        List<User> users = userService.getActiveUsers();
        
        // 2. è·å–å¤©æ°”ä¿¡æ¯
        String weather = getWeatherInfo();
        
        // 3. å¾ªç¯æ¨é€
        for (User user : users) {
            String message = String.format("æ—©ä¸Šå¥½ï¼ä»Šæ—¥å¤©æ°”ï¼š%s", weather);
            messageService.sendMessage(user.getId(), message);
        }
        
        XxlJobHelper.log("å¤©æ°”æ¨é€å®Œæˆï¼Œå…±æ¨é€ {} äºº", users.size());
    }
}
```

**â‘¡ åœ¨è°ƒåº¦ä¸­å¿ƒé…ç½®ä»»åŠ¡**

```
ä»»åŠ¡åç§°ï¼šæ¯æ—¥å¤©æ°”æ¨é€
Cronè¡¨è¾¾å¼ï¼š0 0 8 * * ?     # æ¯å¤©æ—©ä¸Š8ç‚¹
JobHandlerï¼šweatherPushHandler
æ‰§è¡Œå™¨ï¼šmessage-executor
```

**å…³é”®çŸ¥è¯†ç‚¹**ï¼š

ğŸ”¸ **Cronè¡¨è¾¾å¼å«ä¹‰**
```
0    0    8    *    *    ?
ç§’   åˆ†   æ—¶   æ—¥   æœˆ   å‘¨

0 0 8 * * ?  â†’ æ¯å¤©8ç‚¹æ•´
0 30 9 * * ? â†’ æ¯å¤©9ç‚¹30åˆ†
0 0 12 * * 1 â†’ æ¯å‘¨ä¸€ä¸­åˆ12ç‚¹
```

### 2.2 å¸¦å‚æ•°çš„å®šæ—¶æ¨é€


**ä¸šåŠ¡åœºæ™¯**ï¼šæ ¹æ®ä¸åŒåŸå¸‚æ¨é€ä¸åŒçš„å¤©æ°”ä¿¡æ¯

```java
@XxlJob("weatherPushByCityHandler")
public void pushByCity() {
    // è·å–ä»»åŠ¡å‚æ•°ï¼ˆåœ¨è°ƒåº¦ä¸­å¿ƒé…ç½®ï¼‰
    String city = XxlJobHelper.getJobParam();
    
    // æ ¹æ®åŸå¸‚è·å–å¤©æ°”
    String weather = weatherService.getWeather(city);
    
    // è·å–è¯¥åŸå¸‚çš„ç”¨æˆ·
    List<User> cityUsers = userService.getUsersByCity(city);
    
    // æ¨é€æ¶ˆæ¯
    for (User user : cityUsers) {
        String msg = String.format("%sç”¨æˆ·æ‚¨å¥½ï¼Œ%sä»Šæ—¥å¤©æ°”ï¼š%s", 
                                   user.getName(), city, weather);
        messageService.send(user.getId(), msg);
    }
}
```

**è°ƒåº¦ä¸­å¿ƒé…ç½®**ï¼š
```
ä»»åŠ¡å‚æ•°ï¼šåŒ—äº¬        # å¯ä»¥é…ç½®ä¸åŒåŸå¸‚ï¼Œåˆ›å»ºå¤šä¸ªä»»åŠ¡
Cronï¼š0 0 8 * * ?    # æ¯å¤©8ç‚¹æ¨é€åŒ—äº¬å¤©æ°”
```

### 2.3 åŠ¨æ€æ—¶é—´æ¨é€


**ä¸šåŠ¡åœºæ™¯**ï¼šä¼šè®®å‰30åˆ†é’Ÿæé†’

```java
@XxlJob("meetingReminderHandler")
public void meetingReminder() {
    // è·å–30åˆ†é’Ÿåè¦å¼€å§‹çš„ä¼šè®®
    LocalDateTime reminderTime = LocalDateTime.now().plusMinutes(30);
    
    List<Meeting> upcomingMeetings = meetingService.getMeetingsByTime(reminderTime);
    
    for (Meeting meeting : upcomingMeetings) {
        // è·å–å‚ä¼šäººå‘˜
        List<User> participants = meeting.getParticipants();
        
        for (User user : participants) {
            String msg = String.format("æé†’ï¼šæ‚¨çš„ä¼šè®®ã€%sã€‘å°†åœ¨30åˆ†é’Ÿåå¼€å§‹", 
                                       meeting.getTitle());
            messageService.send(user.getId(), msg);
        }
    }
}
```

**è°ƒåº¦é…ç½®**ï¼š
```
Cronï¼š0 */10 * * * ?    # æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
è¯´æ˜ï¼šå®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æé†’çš„ä¼šè®®
```

---

## 3. ğŸ“¦ æ‰¹é‡æ¶ˆæ¯æ¨é€æ–¹æ¡ˆ


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ¨é€


**é—®é¢˜åœºæ™¯**ï¼šå¦‚æœæœ‰10ä¸‡ç”¨æˆ·è¦æ¨é€æ¶ˆæ¯ï¼Œä¸€ä¸ªä¸ªå‘é€ä¼šå¾ˆæ…¢

```
é€ä¸ªæ¨é€çš„é—®é¢˜ï¼š
â€¢ é€Ÿåº¦æ…¢ï¼š10ä¸‡ç”¨æˆ·å¯èƒ½è¦å‡ å°æ—¶
â€¢ èµ„æºå ç”¨é«˜ï¼šé•¿æ—¶é—´å ç”¨çº¿ç¨‹
â€¢ å®¹æ˜“è¶…æ—¶ï¼šä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿

æ‰¹é‡æ¨é€çš„ä¼˜åŠ¿ï¼š
â€¢ é€Ÿåº¦å¿«ï¼šåˆ†æ‰¹å¹¶å‘å¤„ç†
â€¢ èµ„æºåˆ©ç”¨å¥½ï¼šæ‰¹æ¬¡é—´éš”ä¼‘æ¯
â€¢ ä¸æ˜“è¶…æ—¶ï¼šå•æ‰¹å¤„ç†æ—¶é—´å¯æ§
```

### 3.2 åˆ†ç‰‡å¹¿æ’­æ‰¹é‡æ¨é€


**XXL-JOBçš„åˆ†ç‰‡æœºåˆ¶**ï¼šæŠŠå¤§ä»»åŠ¡æ‹†åˆ†ç»™å¤šä¸ªæ‰§è¡Œå™¨åŒæ—¶å¤„ç†

```
å‡è®¾10ä¸‡ç”¨æˆ·ï¼Œé…ç½®2ä¸ªåˆ†ç‰‡ï¼š

åˆ†ç‰‡0å¤„ç†ï¼šç”¨æˆ·IDå°¾å· 0,2,4,6,8 â†’ 5ä¸‡ç”¨æˆ·
åˆ†ç‰‡1å¤„ç†ï¼šç”¨æˆ·IDå°¾å· 1,3,5,7,9 â†’ 5ä¸‡ç”¨æˆ·

ä¸¤ä¸ªæ‰§è¡Œå™¨åŒæ—¶å·¥ä½œï¼Œé€Ÿåº¦ç¿»å€ï¼
```

**ä»£ç å®ç°**ï¼š

```java
@XxlJob("batchPushHandler")
public void batchPush() {
    // è·å–åˆ†ç‰‡å‚æ•°
    int shardIndex = XxlJobHelper.getShardIndex();  // å½“å‰åˆ†ç‰‡åºå·
    int shardTotal = XxlJobHelper.getShardTotal();  // æ€»åˆ†ç‰‡æ•°
    
    XxlJobHelper.log("åˆ†ç‰‡ä»»åŠ¡å¼€å§‹ï¼Œå½“å‰åˆ†ç‰‡ï¼š{}/{}", shardIndex, shardTotal);
    
    // æ¯æ‰¹å¤„ç†1000ä¸ªç”¨æˆ·
    int batchSize = 1000;
    int pageNum = 0;
    
    while (true) {
        // è·å–å½“å‰åˆ†ç‰‡çš„ç”¨æˆ·ï¼ˆæ ¹æ®IDå–æ¨¡åˆ†ç‰‡ï¼‰
        List<User> users = userService.getUsersByMod(
            pageNum, batchSize, shardIndex, shardTotal
        );
        
        if (users.isEmpty()) {
            break;  // æ²¡æœ‰æ›´å¤šç”¨æˆ·äº†
        }
        
        // æ‰¹é‡æ¨é€
        pushBatch(users);
        
        pageNum++;
        
        // é¿å…è¿‡å¿«ï¼Œä¼‘æ¯100æ¯«ç§’
        Thread.sleep(100);
    }
    
    XxlJobHelper.log("åˆ†ç‰‡ {} æ¨é€å®Œæˆ", shardIndex);
}

private void pushBatch(List<User> users) {
    for (User user : users) {
        try {
            messageService.send(user.getId(), "è¥é”€æ¶ˆæ¯å†…å®¹");
        } catch (Exception e) {
            XxlJobHelper.log("æ¨é€å¤±è´¥ï¼šuserId={}, error={}", user.getId(), e.getMessage());
        }
    }
}
```

**SQLæŸ¥è¯¢ç¤ºä¾‹**ï¼ˆåˆ†ç‰‡æŸ¥è¯¢ç”¨æˆ·ï¼‰ï¼š

```sql
-- è·å–å½“å‰åˆ†ç‰‡çš„ç”¨æˆ·
SELECT * FROM user 
WHERE user_id % #{shardTotal} = #{shardIndex}
  AND status = 'active'
LIMIT #{offset}, #{batchSize}
```

**è°ƒåº¦é…ç½®**ï¼š
```
æ‰§è¡Œæ¨¡å¼ï¼šåˆ†ç‰‡å¹¿æ’­
åˆ†ç‰‡å‚æ•°ï¼š2ï¼ˆé…ç½®2ä¸ªåˆ†ç‰‡ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·é‡è°ƒæ•´ï¼‰
Cronï¼š0 0 20 * * ?   # æ¯å¤©æ™šä¸Š8ç‚¹æ¨é€
```

### 3.3 é™æµæ‰¹é‡æ¨é€


**ä¸šåŠ¡åœºæ™¯**ï¼šé¿å…çŸ­æ—¶é—´å†…å‘é€å¤ªå¤šæ¶ˆæ¯ï¼Œå¯¹ç¬¬ä¸‰æ–¹æœåŠ¡é€ æˆå‹åŠ›

```java
@XxlJob("rateLimitPushHandler")
public void rateLimitPush() {
    // æ¯ç§’æœ€å¤šæ¨é€100æ¡
    RateLimiter limiter = RateLimiter.create(100);
    
    List<User> users = userService.getAllActiveUsers();
    
    for (User user : users) {
        // è·å–ä»¤ç‰Œï¼Œå¦‚æœè¶…è¿‡é€Ÿç‡ä¼šç­‰å¾…
        limiter.acquire();
        
        messageService.send(user.getId(), "é™æµæ¨é€æ¶ˆæ¯");
    }
}
```

**å…³é”®çŸ¥è¯†ç‚¹**ï¼š

ğŸ”¸ **é™æµçš„ä½œç”¨**
```
ä¸é™æµï¼šç¬é—´å‘é€10ä¸‡æ¡ â†’ æ¶ˆæ¯å¹³å°å´©æºƒ
é™æµï¼šæ¯ç§’100æ¡ â†’ å¹³ç¨³æ¨é€ï¼Œä¸å½±å“ç³»ç»Ÿ
```

ğŸ”¸ **é™æµç­–ç•¥é€‰æ‹©**

| ç­–ç•¥ | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|-----|---------|-------------|
| ğŸ”„ **å›ºå®šé€Ÿç‡** | `æ¯ç§’å›ºå®šNæ¡` | `ç¬¬ä¸‰æ–¹æ¥å£æœ‰æ˜ç¡®é™åˆ¶` |
| ğŸ“Š **åŠ¨æ€è°ƒæ•´** | `æ ¹æ®å“åº”æ—¶é—´è°ƒæ•´` | `éœ€è¦è‡ªé€‚åº”çš„åœºæ™¯` |
| â° **æ—¶æ®µé™æµ** | `é«˜å³°æœŸé™é€Ÿ` | `é¿å¼€ä¸šåŠ¡é«˜å³°` |

---

## 4. ğŸ“ æ¶ˆæ¯æ¨¡æ¿ç®¡ç†


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯æ¨¡æ¿


**é—®é¢˜åœºæ™¯**ï¼š
```
ç¡¬ç¼–ç é—®é¢˜ï¼š
String msg = "æ‚¨å¥½ï¼Œæ‚¨çš„è®¢å•å·²å‘è´§";  âŒ ä»£ç å†™æ­»ï¼Œä¿®æ”¹è¦é‡æ–°å‘å¸ƒ

æ¨¡æ¿åŒ–ç®¡ç†ï¼š
String template = messageTemplateService.get("ORDER_SHIP");
String msg = formatTemplate(template, order);  âœ… é…ç½®ç®¡ç†ï¼Œéšæ—¶ä¿®æ”¹
```

**ä¼˜åŠ¿**ï¼š
- ğŸ“ å†…å®¹ç»Ÿä¸€ç®¡ç†
- ğŸ”„ æ”¯æŒå¤šè¯­è¨€
- ğŸ¨ æ”¯æŒå˜é‡æ›¿æ¢
- ğŸ“Š ç‰ˆæœ¬æ§åˆ¶

### 4.2 æ¨¡æ¿æ•°æ®åº“è®¾è®¡


```sql
-- æ¶ˆæ¯æ¨¡æ¿è¡¨
CREATE TABLE message_template (
    id BIGINT PRIMARY KEY,
    template_code VARCHAR(50) NOT NULL COMMENT 'æ¨¡æ¿ç¼–ç ',
    template_name VARCHAR(100) COMMENT 'æ¨¡æ¿åç§°',
    template_content TEXT COMMENT 'æ¨¡æ¿å†…å®¹ï¼Œæ”¯æŒå ä½ç¬¦',
    channel VARCHAR(20) COMMENT 'æ¨é€æ¸ é“ï¼šSMS/EMAIL/APP',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1å¯ç”¨ 0ç¦ç”¨',
    create_time DATETIME,
    update_time DATETIME,
    UNIQUE KEY uk_code (template_code)
);

-- æ’å…¥ç¤ºä¾‹æ•°æ®
INSERT INTO message_template VALUES 
(1, 'ORDER_SHIP', 'è®¢å•å‘è´§é€šçŸ¥', 
 'å°Šæ•¬çš„{userName}ï¼Œæ‚¨çš„è®¢å•{orderNo}å·²å‘è´§ï¼Œå¿«é€’å•å·ï¼š{trackNo}', 
 'SMS', 1, NOW(), NOW()),
 
(2, 'COUPON_EXPIRE', 'ä¼˜æƒ åˆ¸åˆ°æœŸæé†’',
 '{userName}æ‚¨å¥½ï¼Œæ‚¨æœ‰{count}å¼ ä¼˜æƒ åˆ¸å°†åœ¨{expireDate}è¿‡æœŸï¼Œè¯·å°½å¿«ä½¿ç”¨',
 'APP', 1, NOW(), NOW());
```

### 4.3 æ¨¡æ¿ä½¿ç”¨å®ç°


```java
@Service
public class MessageTemplateService {
    
    @Autowired
    private MessageTemplateMapper templateMapper;
    
    /**
     * æ ¹æ®æ¨¡æ¿å‘é€æ¶ˆæ¯
     */
    public void sendByTemplate(String templateCode, Long userId, Map<String, Object> params) {
        // 1. è·å–æ¨¡æ¿
        MessageTemplate template = templateMapper.selectByCode(templateCode);
        if (template == null || template.getStatus() == 0) {
            throw new RuntimeException("æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²ç¦ç”¨");
        }
        
        // 2. æ›¿æ¢æ¨¡æ¿å˜é‡
        String content = replaceParams(template.getContent(), params);
        
        // 3. å‘é€æ¶ˆæ¯
        String channel = template.getChannel();
        if ("SMS".equals(channel)) {
            smsService.send(userId, content);
        } else if ("EMAIL".equals(channel)) {
            emailService.send(userId, content);
        } else if ("APP".equals(channel)) {
            appPushService.send(userId, content);
        }
    }
    
    /**
     * æ›¿æ¢æ¨¡æ¿ä¸­çš„å ä½ç¬¦
     */
    private String replaceParams(String template, Map<String, Object> params) {
        String result = template;
        for (Map.Entry<String, Object> entry : params.entrySet()) {
            String key = "{" + entry.getKey() + "}";
            String value = String.valueOf(entry.getValue());
            result = result.replace(key, value);
        }
        return result;
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@XxlJob("orderShipPushHandler")
public void orderShipPush() {
    // æŸ¥è¯¢ä»Šæ—¥å·²å‘è´§è®¢å•
    List<Order> shippedOrders = orderService.getTodayShippedOrders();
    
    for (Order order : shippedOrders) {
        // å‡†å¤‡æ¨¡æ¿å‚æ•°
        Map<String, Object> params = new HashMap<>();
        params.put("userName", order.getUserName());
        params.put("orderNo", order.getOrderNo());
        params.put("trackNo", order.getTrackNo());
        
        // ä½¿ç”¨æ¨¡æ¿å‘é€
        messageTemplateService.sendByTemplate(
            "ORDER_SHIP",      // æ¨¡æ¿ç¼–ç 
            order.getUserId(), // ç”¨æˆ·ID
            params             // å‚æ•°
        );
    }
}
```

### 4.4 æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†


**åœºæ™¯**ï¼šè¥é”€æ´»åŠ¨æœŸé—´ä¸´æ—¶ä¿®æ”¹æ¨¡æ¿ï¼Œæ´»åŠ¨ç»“æŸæ¢å¤åŸæ ·

```java
// æ¨¡æ¿å†å²è¡¨
CREATE TABLE message_template_history (
    id BIGINT PRIMARY KEY,
    template_id BIGINT,
    version INT COMMENT 'ç‰ˆæœ¬å·',
    template_content TEXT,
    start_time DATETIME COMMENT 'ç”Ÿæ•ˆæ—¶é—´',
    end_time DATETIME COMMENT 'å¤±æ•ˆæ—¶é—´',
    status TINYINT COMMENT '1ç”Ÿæ•ˆ 0å¤±æ•ˆ'
);

// æŸ¥è¯¢å½“å‰ç”Ÿæ•ˆçš„æ¨¡æ¿ç‰ˆæœ¬
SELECT * FROM message_template_history
WHERE template_id = #{templateId}
  AND status = 1
  AND NOW() BETWEEN start_time AND end_time
ORDER BY version DESC
LIMIT 1
```

---

## 5. ğŸ“¢ å¤šæ¸ é“æ¨é€ç­–ç•¥


### 5.1 æ”¯æŒçš„æ¨é€æ¸ é“


```
å¸¸è§æ¨é€æ¸ é“å¯¹æ¯”ï¼š

çŸ­ä¿¡ï¼ˆSMSï¼‰
  ä¼˜ç‚¹ï¼šåˆ°è¾¾ç‡é«˜ã€æ— éœ€ç½‘ç»œ
  ç¼ºç‚¹ï¼šæœ‰å­—æ•°é™åˆ¶ã€æœ‰æˆæœ¬
  é€‚åˆï¼šé‡è¦é€šçŸ¥ã€éªŒè¯ç 

é‚®ä»¶ï¼ˆEmailï¼‰  
  ä¼˜ç‚¹ï¼šå†…å®¹ä¸°å¯Œã€å¯å¸¦é™„ä»¶
  ç¼ºç‚¹ï¼šæŸ¥çœ‹ä¸åŠæ—¶
  é€‚åˆï¼šæŠ¥è¡¨ã€è¯¦ç»†é€šçŸ¥

APPæ¨é€ï¼ˆPushï¼‰
  ä¼˜ç‚¹ï¼šå®æ—¶æ€§å¥½ã€æˆæœ¬ä½
  ç¼ºç‚¹ï¼šéœ€è¦å®‰è£…APPã€å¯èƒ½è¢«å±è”½
  é€‚åˆï¼šè¥é”€æ´»åŠ¨ã€å³æ—¶æ¶ˆæ¯

ç«™å†…ä¿¡
  ä¼˜ç‚¹ï¼šæ— é™åˆ¶ã€æ°¸ä¹…ä¿å­˜
  ç¼ºç‚¹ï¼šéœ€è¦ç™»å½•æ‰èƒ½çœ‹
  é€‚åˆï¼šç³»ç»Ÿé€šçŸ¥ã€å†å²è®°å½•
```

### 5.2 æ¸ é“é€‰æ‹©ç­–ç•¥


```java
@Service
public class ChannelSelector {
    
    /**
     * æ ¹æ®æ¶ˆæ¯ç±»å‹å’Œä¼˜å…ˆçº§é€‰æ‹©æ¸ é“
     */
    public List<String> selectChannels(String msgType, int priority) {
        List<String> channels = new ArrayList<>();
        
        // é«˜ä¼˜å…ˆçº§ï¼šå¤šæ¸ é“æ¨é€
        if (priority >= 8) {
            channels.add("SMS");      // çŸ­ä¿¡å¿…è¾¾
            channels.add("APP");      // APPæ¨é€
            channels.add("EMAIL");    // é‚®ä»¶å¤‡ä»½
        } 
        // ä¸­ä¼˜å…ˆçº§ï¼šåŒæ¸ é“
        else if (priority >= 5) {
            channels.add("APP");      // APPä¸»æ¨
            channels.add("INBOX");    // ç«™å†…ä¿¡
        } 
        // ä½ä¼˜å…ˆçº§ï¼šå•æ¸ é“
        else {
            channels.add("INBOX");    // ä»…ç«™å†…ä¿¡
        }
        
        return channels;
    }
}
```

### 5.3 å¤šæ¸ é“æ¨é€å®ç°


```java
@XxlJob("multiChannelPushHandler")
public void multiChannelPush() {
    List<Message> messages = messageService.getPendingMessages();
    
    for (Message msg : messages) {
        // é€‰æ‹©æ¨é€æ¸ é“
        List<String> channels = channelSelector.selectChannels(
            msg.getType(), 
            msg.getPriority()
        );
        
        // å¤šæ¸ é“æ¨é€
        for (String channel : channels) {
            try {
                pushByChannel(channel, msg);
                XxlJobHelper.log("æ¨é€æˆåŠŸï¼šchannel={}, userId={}", 
                                 channel, msg.getUserId());
            } catch (Exception e) {
                XxlJobHelper.log("æ¨é€å¤±è´¥ï¼šchannel={}, error={}", 
                                 channel, e.getMessage());
            }
        }
    }
}

private void pushByChannel(String channel, Message msg) {
    switch (channel) {
        case "SMS":
            smsService.send(msg.getUserId(), msg.getContent());
            break;
        case "EMAIL":
            emailService.send(msg.getUserId(), msg.getContent());
            break;
        case "APP":
            appPushService.send(msg.getUserId(), msg.getContent());
            break;
        case "INBOX":
            inboxService.send(msg.getUserId(), msg.getContent());
            break;
    }
}
```

### 5.4 æ¸ é“é™çº§ç­–ç•¥


**åœºæ™¯**ï¼šä¸»æ¸ é“å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æ¸ é“

```java
@XxlJob("channelFallbackPushHandler")
public void channelFallbackPush() {
    List<Message> messages = messageService.getPendingMessages();
    
    for (Message msg : messages) {
        boolean success = false;
        
        // æŒ‰ä¼˜å…ˆçº§å°è¯•æ¸ é“
        String[] channels = {"APP", "SMS", "EMAIL", "INBOX"};
        
        for (String channel : channels) {
            try {
                pushByChannel(channel, msg);
                success = true;
                XxlJobHelper.log("æ¨é€æˆåŠŸï¼šä½¿ç”¨æ¸ é“ {}", channel);
                break;  // æˆåŠŸåè·³å‡º
            } catch (Exception e) {
                XxlJobHelper.log("æ¸ é“ {} å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª", channel);
                continue;  // å¤±è´¥ç»§ç»­ä¸‹ä¸€ä¸ª
            }
        }
        
        if (!success) {
            XxlJobHelper.log("æ‰€æœ‰æ¸ é“éƒ½å¤±è´¥ï¼šuserId={}", msg.getUserId());
        }
    }
}
```

---

## 6. ğŸ”„ æ¨é€å¤±è´¥é‡è¯•æœºåˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•


**å¸¸è§å¤±è´¥åŸå› **ï¼š
```
ç½‘ç»œé—®é¢˜ï¼š
  â€¢ ç¬¬ä¸‰æ–¹æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
  â€¢ ç½‘ç»œè¶…æ—¶
  â€¢ è¿æ¥ä¸­æ–­

ä¸šåŠ¡é—®é¢˜ï¼š
  â€¢ ç”¨æˆ·æ‰‹æœºå·å¤±æ•ˆ
  â€¢ é‚®ç®±åœ°å€é”™è¯¯  
  â€¢ APPæœªå®‰è£…

ç³»ç»Ÿé—®é¢˜ï¼š
  â€¢ æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜
  â€¢ è¾¾åˆ°æ¨é€é™é¢
  â€¢ æ¥å£é™æµ
```

### 6.2 æ¨é€è®°å½•è¡¨è®¾è®¡


```sql
CREATE TABLE message_push_record (
    id BIGINT PRIMARY KEY,
    message_id BIGINT COMMENT 'æ¶ˆæ¯ID',
    user_id BIGINT COMMENT 'ç”¨æˆ·ID',
    channel VARCHAR(20) COMMENT 'æ¨é€æ¸ é“',
    content TEXT COMMENT 'æ¶ˆæ¯å†…å®¹',
    status TINYINT COMMENT 'çŠ¶æ€ï¼š0å¾…æ¨é€ 1æˆåŠŸ 2å¤±è´¥',
    retry_count INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',
    max_retry INT DEFAULT 3 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°',
    error_msg TEXT COMMENT 'å¤±è´¥åŸå› ',
    next_retry_time DATETIME COMMENT 'ä¸‹æ¬¡é‡è¯•æ—¶é—´',
    push_time DATETIME COMMENT 'æ¨é€æ—¶é—´',
    create_time DATETIME
);
```

### 6.3 é‡è¯•ä»»åŠ¡å®ç°


```java
@XxlJob("retryFailedPushHandler")
public void retryFailedPush() {
    // æŸ¥è¯¢éœ€è¦é‡è¯•çš„æ¶ˆæ¯ï¼ˆçŠ¶æ€=å¤±è´¥ ä¸” æœªè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼‰
    List<MessagePushRecord> failedRecords = 
        messageMapper.selectRetryRecords(LocalDateTime.now());
    
    XxlJobHelper.log("æœ¬æ¬¡é‡è¯•æ•°é‡ï¼š{}", failedRecords.size());
    
    for (MessagePushRecord record : failedRecords) {
        try {
            // æ‰§è¡Œæ¨é€
            pushByChannel(record.getChannel(), record);
            
            // æ›´æ–°ä¸ºæˆåŠŸ
            record.setStatus(1);
            record.setPushTime(LocalDateTime.now());
            messageMapper.updateById(record);
            
            XxlJobHelper.log("é‡è¯•æˆåŠŸï¼šrecordId={}", record.getId());
            
        } catch (Exception e) {
            // é‡è¯•å¤±è´¥ï¼Œæ›´æ–°é‡è¯•æ¬¡æ•°
            record.setRetryCount(record.getRetryCount() + 1);
            record.setErrorMsg(e.getMessage());
            
            // è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            int delayMinutes = (int) Math.pow(2, record.getRetryCount());
            record.setNextRetryTime(
                LocalDateTime.now().plusMinutes(delayMinutes)
            );
            
            // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºæœ€ç»ˆå¤±è´¥
            if (record.getRetryCount() >= record.getMaxRetry()) {
                record.setStatus(3);  // 3è¡¨ç¤ºæœ€ç»ˆå¤±è´¥
            }
            
            messageMapper.updateById(record);
            
            XxlJobHelper.log("é‡è¯•å¤±è´¥ï¼šrecordId={}, é‡è¯•æ¬¡æ•°={}/{}", 
                             record.getId(), 
                             record.getRetryCount(), 
                             record.getMaxRetry());
        }
    }
}
```

**SQLæŸ¥è¯¢é‡è¯•è®°å½•**ï¼š

```sql
-- æŸ¥è¯¢éœ€è¦é‡è¯•çš„è®°å½•
SELECT * FROM message_push_record
WHERE status = 2                          -- å¤±è´¥çŠ¶æ€
  AND retry_count < max_retry            -- æœªè¾¾åˆ°æœ€å¤§é‡è¯•
  AND next_retry_time <= #{currentTime}  -- åˆ°äº†é‡è¯•æ—¶é—´
ORDER BY create_time
LIMIT 1000                                -- æ¯æ¬¡æœ€å¤š1000æ¡
```

### 6.4 æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥


**é‡è¯•æ—¶é—´é—´éš”**ï¼š

```
ç¬¬1æ¬¡å¤±è´¥ï¼šç«‹å³é‡è¯•ï¼ˆ0åˆ†é’Ÿï¼‰
ç¬¬2æ¬¡å¤±è´¥ï¼š2åˆ†é’Ÿåé‡è¯•ï¼ˆ2^1ï¼‰
ç¬¬3æ¬¡å¤±è´¥ï¼š4åˆ†é’Ÿåé‡è¯•ï¼ˆ2^2ï¼‰
ç¬¬4æ¬¡å¤±è´¥ï¼š8åˆ†é’Ÿåé‡è¯•ï¼ˆ2^3ï¼‰
ç¬¬5æ¬¡å¤±è´¥ï¼š16åˆ†é’Ÿåé‡è¯•ï¼ˆ2^4ï¼‰

å¥½å¤„ï¼š
â€¢ é¿å…é¢‘ç¹é‡è¯•åŠ é‡ç³»ç»Ÿè´Ÿæ‹…
â€¢ ç»™ç¬¬ä¸‰æ–¹æœåŠ¡æ¢å¤æ—¶é—´
â€¢ æé«˜é‡è¯•æˆåŠŸç‡
```

**å¯è§†åŒ–å±•ç¤º**ï¼š

```
æ—¶é—´è½´ï¼š
0min        2min     6min      14min     30min
 |           |        |         |         |
æ¨é€ â†’ å¤±è´¥ â†’ é‡è¯•1 â†’ é‡è¯•2 â†’ é‡è¯•3 â†’ æœ€ç»ˆå¤±è´¥
       â†“
     è®°å½•å¤±è´¥åŸå› 
```

---

## 7. ğŸ“Š æ¨é€æ•ˆæœç»Ÿè®¡


### 7.1 ç»Ÿè®¡æŒ‡æ ‡è®¾è®¡


**æ ¸å¿ƒæŒ‡æ ‡**ï¼š

```
å‘é€æŒ‡æ ‡ï¼š
  â€¢ å‘é€æ€»é‡ï¼šæ€»å…±æ¨é€å¤šå°‘æ¡
  â€¢ æˆåŠŸæ•°é‡ï¼šæˆåŠŸæ¨é€å¤šå°‘æ¡
  â€¢ å¤±è´¥æ•°é‡ï¼šå¤±è´¥å¤šå°‘æ¡
  â€¢ æˆåŠŸç‡ï¼šæˆåŠŸæ•° / æ€»æ•° Ã— 100%

ç”¨æˆ·åé¦ˆï¼š
  â€¢ ç‚¹å‡»ç‡ï¼šç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹çš„æ¯”ä¾‹
  â€¢ è½¬åŒ–ç‡ï¼šå®Œæˆç›®æ ‡è¡Œä¸ºçš„æ¯”ä¾‹
  â€¢ é€€è®¢ç‡ï¼šç”¨æˆ·å–æ¶ˆè®¢é˜…çš„æ¯”ä¾‹

æ¸ é“å¯¹æ¯”ï¼š
  â€¢ å„æ¸ é“æˆåŠŸç‡
  â€¢ å„æ¸ é“å“åº”æ—¶é—´
  â€¢ å„æ¸ é“æˆæœ¬
```

### 7.2 ç»Ÿè®¡è¡¨è®¾è®¡


```sql
-- æ¨é€æ•ˆæœç»Ÿè®¡è¡¨ï¼ˆæŒ‰å¤©ç»Ÿè®¡ï¼‰
CREATE TABLE message_push_statistics (
    id BIGINT PRIMARY KEY,
    stat_date DATE COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    channel VARCHAR(20) COMMENT 'æ¨é€æ¸ é“',
    template_code VARCHAR(50) COMMENT 'æ¨¡æ¿ç¼–ç ',
    total_count INT COMMENT 'å‘é€æ€»é‡',
    success_count INT COMMENT 'æˆåŠŸæ•°é‡',
    fail_count INT COMMENT 'å¤±è´¥æ•°é‡',
    click_count INT COMMENT 'ç‚¹å‡»æ•°é‡',
    conversion_count INT COMMENT 'è½¬åŒ–æ•°é‡',
    success_rate DECIMAL(5,2) COMMENT 'æˆåŠŸç‡%',
    click_rate DECIMAL(5,2) COMMENT 'ç‚¹å‡»ç‡%',
    conversion_rate DECIMAL(5,2) COMMENT 'è½¬åŒ–ç‡%',
    avg_cost DECIMAL(10,2) COMMENT 'å¹³å‡æˆæœ¬',
    create_time DATETIME,
    UNIQUE KEY uk_date_channel (stat_date, channel, template_code)
);
```

### 7.3 ç»Ÿè®¡ä»»åŠ¡å®ç°


```java
@XxlJob("pushStatisticsHandler")
public void calculateStatistics() {
    // ç»Ÿè®¡æ˜¨å¤©çš„æ•°æ®
    LocalDate yesterday = LocalDate.now().minusDays(1);
    
    XxlJobHelper.log("å¼€å§‹ç»Ÿè®¡æ—¥æœŸï¼š{}", yesterday);
    
    // æŒ‰æ¸ é“å’Œæ¨¡æ¿åˆ†ç»„ç»Ÿè®¡
    List<MessagePushStatistics> stats = 
        messageMapper.statisticsByDate(yesterday);
    
    for (MessagePushStatistics stat : stats) {
        // è®¡ç®—æˆåŠŸç‡
        stat.setSuccessRate(
            stat.getSuccessCount() * 100.0 / stat.getTotalCount()
        );
        
        // è®¡ç®—ç‚¹å‡»ç‡
        stat.setClickRate(
            stat.getClickCount() * 100.0 / stat.getSuccessCount()
        );
        
        // è®¡ç®—è½¬åŒ–ç‡
        stat.setConversionRate(
            stat.getConversionCount() * 100.0 / stat.getClickCount()
        );
        
        // ä¿å­˜ç»Ÿè®¡ç»“æœ
        statisticsMapper.insert(stat);
    }
    
    XxlJobHelper.log("ç»Ÿè®¡å®Œæˆï¼Œå…± {} æ¡æ•°æ®", stats.size());
}
```

**ç»Ÿè®¡SQL**ï¼š

```sql
-- æŒ‰æ—¥æœŸã€æ¸ é“ã€æ¨¡æ¿ç»Ÿè®¡
SELECT 
    #{statDate} as stat_date,
    channel,
    template_code,
    COUNT(*) as total_count,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as success_count,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) as fail_count,
    SUM(CASE WHEN click_time IS NOT NULL THEN 1 ELSE 0 END) as click_count,
    SUM(CASE WHEN conversion_time IS NOT NULL THEN 1 ELSE 0 END) as conversion_count
FROM message_push_record
WHERE DATE(create_time) = #{statDate}
GROUP BY channel, template_code
```

### 7.4 å®æ—¶ç›‘æ§çœ‹æ¿


```java
@XxlJob("realtimeMonitorHandler")
public void realtimeMonitor() {
    // ç»Ÿè®¡æœ€è¿‘1å°æ—¶çš„æ¨é€æƒ…å†µ
    PushMonitorVO monitor = new PushMonitorVO();
    
    // æ€»å‘é€é‡
    monitor.setTotalSent(
        messageMapper.countByTimeRange(LocalDateTime.now().minusHours(1))
    );
    
    // æˆåŠŸæ•°
    monitor.setSuccessCount(
        messageMapper.countSuccessByTimeRange(LocalDateTime.now().minusHours(1))
    );
    
    // å¤±è´¥æ•°
    monitor.setFailCount(
        monitor.getTotalSent() - monitor.getSuccessCount()
    );
    
    // æˆåŠŸç‡
    monitor.setSuccessRate(
        monitor.getSuccessCount() * 100.0 / monitor.getTotalSent()
    );
    
    // ä¿å­˜åˆ°Redisä¾›å‰ç«¯å±•ç¤º
    redisTemplate.opsForValue().set(
        "push:monitor:realtime", 
        monitor, 
        5, 
        TimeUnit.MINUTES
    );
    
    // å‘Šè­¦æ£€æŸ¥ï¼šæˆåŠŸç‡ä½äº90%å‘é€å‘Šè­¦
    if (monitor.getSuccessRate() < 90) {
        alertService.sendAlert("æ¨é€æˆåŠŸç‡è¿‡ä½ï¼š" + monitor.getSuccessRate() + "%");
    }
}
```

**ç›‘æ§é¢æ¿æ•°æ®ç»“æ„**ï¼š

```
å®æ—¶ç›‘æ§æ•°æ®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ€è¿‘1å°æ—¶æ¨é€æƒ…å†µ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¤ æ€»å‘é€é‡ï¼š12,580            â”‚
â”‚  âœ… æˆåŠŸæ•°é‡ï¼š11,892            â”‚
â”‚  âŒ å¤±è´¥æ•°é‡ï¼š688               â”‚
â”‚  ğŸ“Š æˆåŠŸç‡ï¼š94.5%               â”‚
â”‚                                 â”‚
â”‚  å„æ¸ é“åˆ†å¸ƒï¼š                   â”‚
â”‚  â€¢ APPæ¨é€ï¼š7,234 (57.5%)      â”‚
â”‚  â€¢ çŸ­ä¿¡ï¼š3,156 (25.1%)         â”‚
â”‚  â€¢ é‚®ä»¶ï¼š2,190 (17.4%)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸ‘¥ ç”¨æˆ·åˆ†ç»„æ¨é€


### 8.1 ç”¨æˆ·åˆ†ç»„çš„æ„ä¹‰


**ä¸šåŠ¡åœºæ™¯**ï¼š

```
ä¸åŒç”¨æˆ·ç¾¤ä½“éœ€è¦ä¸åŒçš„æ¶ˆæ¯ï¼š

VIPç”¨æˆ·ï¼š
  â€¢ ä¸“å±ä¼˜æƒ é€šçŸ¥
  â€¢ æ–°å“é¦–å‘é¢„å‘Š
  â€¢ ç”Ÿæ—¥ç¥ç¦

æ™®é€šç”¨æˆ·ï¼š
  â€¢ å¸¸è§„è¥é”€æ´»åŠ¨
  â€¢ ä½¿ç”¨æé†’
  â€¢ åŠŸèƒ½ä»‹ç»

æ²‰ç¡ç”¨æˆ·ï¼š
  â€¢ å”¤é†’æ´»åŠ¨
  â€¢ ä¼˜æƒ åˆ¸èµ é€
  â€¢ æ–°åŠŸèƒ½ä»‹ç»
```

### 8.2 ç”¨æˆ·åˆ†ç»„è¡¨è®¾è®¡


```sql
-- ç”¨æˆ·åˆ†ç»„è¡¨
CREATE TABLE user_group (
    id BIGINT PRIMARY KEY,
    group_code VARCHAR(50) COMMENT 'åˆ†ç»„ç¼–ç ',
    group_name VARCHAR(100) COMMENT 'åˆ†ç»„åç§°',
    group_rule TEXT COMMENT 'åˆ†ç»„è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰',
    status TINYINT DEFAULT 1,
    create_time DATETIME
);

-- ç”¨æˆ·åˆ†ç»„å…³ç³»è¡¨
CREATE TABLE user_group_relation (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    group_id BIGINT,
    join_time DATETIME,
    KEY idx_user_id (user_id),
    KEY idx_group_id (group_id)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO user_group VALUES
(1, 'VIP_USER', 'VIPç”¨æˆ·', '{"level":">=5","totalAmount":">=10000"}', 1, NOW()),
(2, 'NEW_USER', 'æ–°ç”¨æˆ·', '{"registerDays":"<=7"}', 1, NOW()),
(3, 'SLEEP_USER', 'æ²‰ç¡ç”¨æˆ·', '{"lastLoginDays":">=30"}', 1, NOW());
```

### 8.3 åŸºäºåˆ†ç»„çš„æ¨é€


```java
@XxlJob("groupPushHandler")
public void groupPush() {
    // è·å–ä»»åŠ¡å‚æ•°ï¼šåˆ†ç»„ç¼–ç 
    String groupCode = XxlJobHelper.getJobParam();
    
    // è·å–åˆ†ç»„ä¿¡æ¯
    UserGroup group = userGroupService.getByCode(groupCode);
    if (group == null) {
        XxlJobHelper.log("åˆ†ç»„ä¸å­˜åœ¨ï¼š{}", groupCode);
        return;
    }
    
    // è·å–åˆ†ç»„å†…çš„ç”¨æˆ·
    List<Long> userIds = userGroupService.getUserIdsByGroup(group.getId());
    
    XxlJobHelper.log("åˆ†ç»„ {} ç”¨æˆ·æ•°é‡ï¼š{}", group.getGroupName(), userIds.size());
    
    // è·å–è¯¥åˆ†ç»„çš„æ¶ˆæ¯æ¨¡æ¿
    String templateCode = getTemplateByGroup(groupCode);
    
    // æ‰¹é‡æ¨é€
    int successCount = 0;
    for (Long userId : userIds) {
        try {
            messageTemplateService.sendByTemplate(
                templateCode, 
                userId, 
                buildParams(userId)
            );
            successCount++;
        } catch (Exception e) {
            XxlJobHelper.log("æ¨é€å¤±è´¥ï¼šuserId={}, error={}", userId, e.getMessage());
        }
    }
    
    XxlJobHelper.log("æ¨é€å®Œæˆï¼šæˆåŠŸ {}/{}", successCount, userIds.size());
}
```

**è°ƒåº¦é…ç½®ç¤ºä¾‹**ï¼š

```
ä»»åŠ¡1ï¼šVIPç”¨æˆ·æ¨é€
  å‚æ•°ï¼šVIP_USER
  Cronï¼š0 0 10 * * ?   # æ¯å¤©10ç‚¹

ä»»åŠ¡2ï¼šæ–°ç”¨æˆ·æ¨é€  
  å‚æ•°ï¼šNEW_USER
  Cronï¼š0 0 20 * * ?   # æ¯å¤©20ç‚¹

ä»»åŠ¡3ï¼šæ²‰ç¡ç”¨æˆ·å”¤é†’
  å‚æ•°ï¼šSLEEP_USER
  Cronï¼š0 0 9 * * 1    # æ¯å‘¨ä¸€9ç‚¹
```

### 8.4 åŠ¨æ€åˆ†ç»„è§„åˆ™


**åœºæ™¯**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºå®æ—¶æ›´æ–°åˆ†ç»„

```java
@XxlJob("updateUserGroupHandler")
public void updateUserGroup() {
    // æ›´æ–°VIPç”¨æˆ·åˆ†ç»„
    updateVipGroup();
    
    // æ›´æ–°æ–°ç”¨æˆ·åˆ†ç»„
    updateNewUserGroup();
    
    // æ›´æ–°æ²‰ç¡ç”¨æˆ·åˆ†ç»„
    updateSleepUserGroup();
}

private void updateVipGroup() {
    // æŸ¥è¯¢ç¬¦åˆVIPæ¡ä»¶çš„ç”¨æˆ·
    String sql = """
        SELECT user_id FROM user
        WHERE level >= 5 
          AND total_amount >= 10000
          AND status = 1
        """;
    
    List<Long> vipUserIds = userMapper.selectUserIdsBySql(sql);
    
    // è·å–VIPåˆ†ç»„ID
    Long groupId = userGroupService.getByCode("VIP_USER").getId();
    
    // åˆ é™¤æ—§å…³ç³»
    userGroupRelationMapper.deleteByGroupId(groupId);
    
    // æ‰¹é‡æ’å…¥æ–°å…³ç³»
    List<UserGroupRelation> relations = vipUserIds.stream()
        .map(userId -> {
            UserGroupRelation relation = new UserGroupRelation();
            relation.setUserId(userId);
            relation.setGroupId(groupId);
            relation.setJoinTime(LocalDateTime.now());
            return relation;
        })
        .collect(Collectors.toList());
    
    userGroupRelationMapper.batchInsert(relations);
    
    XxlJobHelper.log("VIPåˆ†ç»„æ›´æ–°å®Œæˆï¼Œç”¨æˆ·æ•°ï¼š{}", vipUserIds.size());
}
```

### 8.5 ç²¾å‡†äººç¾¤æ¨é€


**ABæµ‹è¯•åœºæ™¯**ï¼šå¯¹ä¸åŒåˆ†ç»„æ¨é€ä¸åŒå†…å®¹ï¼Œå¯¹æ¯”æ•ˆæœ

```java
@XxlJob("abTestPushHandler")
public void abTestPush() {
    // éšæœºåˆ†ä¸ºAã€Bä¸¤ç»„
    List<User> allUsers = userService.getActiveUsers();
    
    // æ´—ç‰Œ
    Collections.shuffle(allUsers);
    
    int mid = allUsers.size() / 2;
    List<User> groupA = allUsers.subList(0, mid);
    List<User> groupB = allUsers.subList(mid, allUsers.size());
    
    // Aç»„ï¼šæ¨é€æ–‡æ¡ˆ1
    for (User user : groupA) {
        messageTemplateService.sendByTemplate(
            "PROMO_TEMPLATE_A",  // æ–‡æ¡ˆA
            user.getId(),
            Map.of("userName", user.getName())
        );
        
        // æ ‡è®°ä¸ºAç»„
        abTestService.markUser(user.getId(), "A", "æ´»åŠ¨1");
    }
    
    // Bç»„ï¼šæ¨é€æ–‡æ¡ˆ2
    for (User user : groupB) {
        messageTemplateService.sendByTemplate(
            "PROMO_TEMPLATE_B",  // æ–‡æ¡ˆB
            user.getId(),
            Map.of("userName", user.getName())
        );
        
        // æ ‡è®°ä¸ºBç»„
        abTestService.markUser(user.getId(), "B", "æ´»åŠ¨1");
    }
    
    XxlJobHelper.log("ABæµ‹è¯•æ¨é€å®Œæˆï¼šAç»„ {} äººï¼ŒBç»„ {} äºº", 
                     groupA.size(), groupB.size());
}
```

**ABæµ‹è¯•æ•ˆæœåˆ†æ**ï¼š

```
æµ‹è¯•ç»“æœå¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†ç»„   â”‚ äººæ•° â”‚ ç‚¹å‡» â”‚ è½¬åŒ– â”‚ è½¬åŒ–ç‡â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚ Aç»„    â”‚ 5000 â”‚ 1200 â”‚  380 â”‚ 7.6% â”‚
â”‚ Bç»„    â”‚ 5000 â”‚ 1580 â”‚  520 â”‚ 10.4%â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

ç»“è®ºï¼šæ–‡æ¡ˆBæ•ˆæœæ›´å¥½ï¼Œè½¬åŒ–ç‡é«˜2.8%
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†


```
ğŸ”¸ å®šæ—¶æ¨é€ï¼šä½¿ç”¨Cronè¡¨è¾¾å¼é…ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ”¯æŒå‚æ•°åŒ–é…ç½®
ğŸ”¸ æ‰¹é‡æ¨é€ï¼šåˆ©ç”¨åˆ†ç‰‡å¹¿æ’­æå‡æ€§èƒ½ï¼Œé…åˆé™æµé¿å…ç³»ç»Ÿå‹åŠ›
ğŸ”¸ æ¨¡æ¿ç®¡ç†ï¼šç»Ÿä¸€ç®¡ç†æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒå˜é‡æ›¿æ¢å’Œç‰ˆæœ¬æ§åˆ¶
ğŸ”¸ å¤šæ¸ é“æ¨é€ï¼šæ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©æ¸ é“ï¼Œæ”¯æŒé™çº§å’Œå¤‡ç”¨æ–¹æ¡ˆ
ğŸ”¸ å¤±è´¥é‡è¯•ï¼šæŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œè®°å½•å¤±è´¥åŸå› ï¼Œæ§åˆ¶é‡è¯•æ¬¡æ•°
ğŸ”¸ æ•ˆæœç»Ÿè®¡ï¼šå¤šç»´åº¦ç»Ÿè®¡æ¨é€æ•ˆæœï¼Œå®æ—¶ç›‘æ§å’Œå‘Šè­¦
ğŸ”¸ åˆ†ç»„æ¨é€ï¼šåŸºäºç”¨æˆ·ç‰¹å¾åˆ†ç»„ï¼Œå®ç°ç²¾å‡†è¥é”€
```

### 9.2 å®æˆ˜å¼€å‘è¦ç‚¹


**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
æ‰¹é‡å¤„ç†ï¼š
  â€¢ åˆ†ç‰‡å¹¿æ’­ï¼šå¤šæ‰§è¡Œå™¨å¹¶è¡Œå¤„ç†
  â€¢ æ‰¹æ¬¡æ§åˆ¶ï¼šæ¯æ‰¹1000-5000æ¡
  â€¢ é™æµä¿æŠ¤ï¼šé¿å…ç¬æ—¶å‹åŠ›è¿‡å¤§

èµ„æºç®¡ç†ï¼š
  â€¢ è¿æ¥æ± ï¼šå¤ç”¨æ•°æ®åº“å’Œç¬¬ä¸‰æ–¹è¿æ¥
  â€¢ å¼‚æ­¥å¤„ç†ï¼šä¸é˜»å¡ä¸»æµç¨‹
  â€¢ è¶…æ—¶æ§åˆ¶ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
```

**ğŸ”’ å¯é æ€§ä¿éšœ**
```
æ•°æ®å®‰å…¨ï¼š
  â€¢ æ¨é€è®°å½•ï¼šå®Œæ•´è®°å½•æ¨é€è¿‡ç¨‹
  â€¢ é‡è¯•æœºåˆ¶ï¼šå¤±è´¥è‡ªåŠ¨é‡è¯•
  â€¢ é™çº§ç­–ç•¥ï¼šä¸»æ¸ é“å¤±è´¥åˆ‡æ¢å¤‡ç”¨

ç›‘æ§å‘Šè­¦ï¼š
  â€¢ å®æ—¶ç›‘æ§ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§
  â€¢ å¼‚å¸¸å‘Šè­¦ï¼šæˆåŠŸç‡ä½äºé˜ˆå€¼å‘Šè­¦
  â€¢ æ—¥å¿—è®°å½•ï¼šè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
```

**ğŸ’¡ ä¸šåŠ¡å®è·µ**
```
æ¨¡æ¿ä½¿ç”¨ï¼š
  âœ… å†…å®¹ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºä¿®æ”¹
  âœ… æ”¯æŒå¤šè¯­è¨€å’Œä¸ªæ€§åŒ–
  âœ… ç‰ˆæœ¬æ§åˆ¶ï¼Œæ”¯æŒABæµ‹è¯•

åˆ†ç»„ç­–ç•¥ï¼š
  âœ… åŸºäºç”¨æˆ·ç‰¹å¾åˆ†ç»„
  âœ… å®šæœŸæ›´æ–°åˆ†ç»„å…³ç³»
  âœ… ç²¾å‡†æ¨é€æå‡æ•ˆæœ
```

### 9.3 å¸¸è§é—®é¢˜è§£å†³


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| ğŸŒ **æ¨é€å¤ªæ…¢** | `é€ä¸ªæ¨é€æ•ˆç‡ä½` | `ä½¿ç”¨åˆ†ç‰‡å¹¿æ’­+æ‰¹é‡å¤„ç†` |
| âŒ **æ¨é€å¤±è´¥ç‡é«˜** | `ç½‘ç»œæˆ–ç¬¬ä¸‰æ–¹é—®é¢˜` | `é‡è¯•æœºåˆ¶+æ¸ é“é™çº§` |
| ğŸ’¸ **æˆæœ¬è¿‡é«˜** | `çŸ­ä¿¡ä½¿ç”¨è¿‡å¤š` | `ä¼˜å…ˆä½¿ç”¨APP/ç«™å†…ä¿¡` |
| ğŸ“Š **ç»Ÿè®¡ä¸å‡†** | `æ•°æ®è®°å½•ä¸å®Œæ•´` | `å®Œå–„æ¨é€è®°å½•è¡¨` |
| ğŸ‘¥ **æ¨é€ä¸ç²¾å‡†** | `ç”¨æˆ·åˆ†ç»„ä¸åˆç†` | `ä¼˜åŒ–åˆ†ç»„è§„åˆ™å’Œæ›´æ–°æœºåˆ¶` |

### 9.4 æœ€ä½³å®è·µå»ºè®®


```
å¼€å‘é˜¶æ®µï¼š
  â‘  è®¾è®¡å¥½æ•°æ®è¡¨ç»“æ„ï¼ˆæ¨é€è®°å½•ã€æ¨¡æ¿ã€åˆ†ç»„ï¼‰
  â‘¡ å°è£…æ¨é€æœåŠ¡ï¼Œç»Ÿä¸€è°ƒç”¨æ¥å£
  â‘¢ å®ç°å®Œå–„çš„æ—¥å¿—è®°å½•
  â‘£ è€ƒè™‘å¼‚å¸¸æƒ…å†µçš„å¤„ç†

æµ‹è¯•é˜¶æ®µï¼š
  â‘  å°èŒƒå›´æµ‹è¯•æ¨é€åŠŸèƒ½
  â‘¡ éªŒè¯é‡è¯•æœºåˆ¶æ˜¯å¦æ­£å¸¸
  â‘¢ å‹æµ‹æ‰¹é‡æ¨é€æ€§èƒ½
  â‘£ æ£€æŸ¥ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§

ä¸Šçº¿é˜¶æ®µï¼š
  â‘  é…ç½®ç›‘æ§å‘Šè­¦
  â‘¡ è®¾ç½®åˆç†çš„é™æµé˜ˆå€¼
  â‘¢ å‡†å¤‡åº”æ€¥é¢„æ¡ˆ
  â‘£ å®šæœŸreviewæ¨é€æ•ˆæœ

ä¼˜åŒ–é˜¶æ®µï¼š
  â‘  æ ¹æ®ç»Ÿè®¡æ•°æ®ä¼˜åŒ–ç­–ç•¥
  â‘¡ ABæµ‹è¯•ä¸åŒæ¨é€æ–¹æ¡ˆ
  â‘¢ æŒç»­æ”¹è¿›æ¨¡æ¿å†…å®¹
  â‘£ è°ƒæ•´åˆ†ç»„è§„åˆ™
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å®šæ—¶ä»»åŠ¡é…Cronï¼Œæ‰¹é‡åˆ†ç‰‡ææ€§èƒ½
æ¨¡æ¿ç®¡ç†å†…å®¹ç»Ÿï¼Œå¤šæ¸ é“æ¨æ›´ç¨³å®š
å¤±è´¥é‡è¯•è¦æŒ‡æ•°ï¼Œæ•ˆæœç»Ÿè®¡åŠ©å†³ç­–
ç”¨æˆ·åˆ†ç»„ç²¾å‡†æ¨ï¼Œç›‘æ§å‘Šè­¦ä¿è¿è¡Œ
```