---
title: 4ã€åˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [äº‹åŠ¡èŒƒå›´æœ€å°åŒ–](#2-äº‹åŠ¡èŒƒå›´æœ€å°åŒ–)
3. [å¼‚æ­¥å¤„ç†ä¼˜åŒ–](#3-å¼‚æ­¥å¤„ç†ä¼˜åŒ–)
4. [æ‰¹é‡æ“ä½œä¼˜åŒ–](#4-æ‰¹é‡æ“ä½œä¼˜åŒ–)
5. [è¿æ¥æ± ä¼˜åŒ–](#5-è¿æ¥æ± ä¼˜åŒ–)
6. [ç¼“å­˜ç­–ç•¥](#6-ç¼“å­˜ç­–ç•¥)
7. [è¯»å†™åˆ†ç¦»é…åˆ](#7-è¯»å†™åˆ†ç¦»é…åˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡æ€§èƒ½æ˜¯ä¸ªé—®é¢˜


**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä½ è¦ä¹°ä¸€ä¸ªå¥—é¤ï¼ŒåŒ…å«æ±‰å ¡ã€è–¯æ¡ã€å¯ä¹ï¼Œå¿…é¡»ä¸‰æ ·éƒ½æœ‰æ‰ç®—æˆåŠŸã€‚

```
æ™®é€šè´­ä¹°ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰ï¼š
ä½  â†’ ä¸€ä¸ªåº—å‘˜ â†’ æ‹¿é½ä¸‰æ · âœ…

åˆ†å¸ƒå¼è´­ä¹°ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰ï¼š
ä½  â†’ æ±‰å ¡åº—å‘˜ â†’ ç¡®è®¤æœ‰æ±‰å ¡
ä½  â†’ è–¯æ¡åº—å‘˜ â†’ ç¡®è®¤æœ‰è–¯æ¡  
ä½  â†’ é¥®æ–™åº—å‘˜ â†’ ç¡®è®¤æœ‰å¯ä¹
æ‰€æœ‰åº—å‘˜éƒ½ç¡®è®¤ â†’ åŒæ—¶å‡ºè´§ âœ…

é—®é¢˜ï¼šéœ€è¦åè°ƒå¤šä¸ªåº—å‘˜ï¼Œæ—¶é—´æ›´é•¿ï¼Œå‡ºé”™æ¦‚ç‡æ›´å¤§
```

### 1.2 åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€§èƒ½æŒ‘æˆ˜


**æ ¸å¿ƒé—®é¢˜**ï¼š
- â±ï¸ **å“åº”æ—¶é—´é•¿** - éœ€è¦ç­‰å¾…å¤šä¸ªæœåŠ¡å“åº”
- ğŸ”’ **èµ„æºé”å®š** - äº‹åŠ¡æœŸé—´èµ„æºè¢«å ç”¨
- ğŸŒ **ç½‘ç»œå»¶è¿Ÿ** - è·¨ç½‘ç»œé€šä¿¡å¼€é”€
- ğŸ’¾ **çŠ¶æ€ç»´æŠ¤** - éœ€è¦è®°å½•äº‹åŠ¡çŠ¶æ€ä¿¡æ¯

**æ€§èƒ½å½±å“å¯¹æ¯”**ï¼š

| äº‹åŠ¡ç±»å‹ | **å“åº”æ—¶é—´** | **å¹¶å‘èƒ½åŠ›** | **èµ„æºå ç”¨** | **å¤æ‚åº¦** |
|---------|-------------|-------------|-------------|-----------|
| æœ¬åœ°äº‹åŠ¡ | `10-50ms` | `é«˜` | `ä½` | `ç®€å•` |
| åˆ†å¸ƒå¼äº‹åŠ¡ | `100-1000ms` | `ä¸­ç­‰` | `é«˜` | `å¤æ‚` |

### 1.3 ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ


```
æ€§èƒ½ä¼˜åŒ–ç­–ç•¥é‡‘å­—å¡”ï¼š

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ é¿å…ä½¿ç”¨äº‹åŠ¡ â”‚ â† æœ€é«˜ä¼˜å…ˆçº§
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ å‡å°‘äº‹åŠ¡èŒƒå›´     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ æé«˜æ‰§è¡Œæ•ˆç‡         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ä¼˜åŒ–åŸºç¡€è®¾æ–½             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸåˆ™ï¼šèƒ½ä¸ç”¨å°±ä¸ç”¨ï¼Œå¿…é¡»ç”¨å°±ä¼˜åŒ–
```

---

## 2. ğŸ“ äº‹åŠ¡èŒƒå›´æœ€å°åŒ–


### 2.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡èŒƒå›´æœ€å°åŒ–


**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ¬å®¶ä¸€æ ·ï¼Œä½ å¯ä»¥ä¸€æ¬¡æ€§æ¬å®Œæ‰€æœ‰ä¸œè¥¿ï¼Œä¹Ÿå¯ä»¥åˆ†æ‰¹æ¬é‡è¦çš„ä¸œè¥¿ã€‚

```
âŒ å¤§äº‹åŠ¡èŒƒå›´ï¼ˆä¸€æ¬¡æ¬å®Œï¼‰ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ¬å®¶å…· â†’ æ¬ç”µå™¨ â†’ æ¬è¡£æœ â†’ æ¬æ‚ç‰© â†’ æäº¤äº‹åŠ¡
é—®é¢˜ï¼šæ—¶é—´é•¿ï¼Œä¸­é—´ä»»ä½•ç¯èŠ‚å‡ºé”™éƒ½è¦é‡æ¥

âœ… å°äº‹åŠ¡èŒƒå›´ï¼ˆåˆ†æ‰¹å¤„ç†ï¼‰ï¼š
äº‹åŠ¡1ï¼šæ¬è´µé‡ç‰©å“ â†’ æäº¤
äº‹åŠ¡2ï¼šæ¬å¤§ä»¶å®¶å…· â†’ æäº¤  
äº‹åŠ¡3ï¼šæ¬æ—¥ç”¨å“ â†’ æäº¤
ä¼˜åŠ¿ï¼šæ¯æ‰¹æˆåŠŸå°±ç¡®å®šäº†ï¼Œé£é™©å°
```

### 2.2 ç¼©å°äº‹åŠ¡èŒƒå›´çš„æ–¹æ³•


#### ğŸ”¸ æŒ‰ä¸šåŠ¡è¾¹ç•Œæ‹†åˆ†


**åœºæ™¯ç¤ºä¾‹**ï¼šç”¨æˆ·ä¸‹å•è´­ä¹°å•†å“

```java
// âŒ é”™è¯¯åšæ³•ï¼šä¸€ä¸ªå¤§äº‹åŠ¡
@Transactional
public OrderResult createOrder(OrderRequest request) {
    // äº‹åŠ¡èŒƒå›´å¤ªå¤§ï¼ŒåŒ…å«äº†å¾ˆå¤šä¸å¿…è¦çš„æ“ä½œ
    
    // 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸éœ€è¦åœ¨äº‹åŠ¡ä¸­ï¼‰
    User user = userService.getUser(request.getUserId());
    
    // 2. æ£€æŸ¥å•†å“åº“å­˜ï¼ˆéœ€è¦åœ¨äº‹åŠ¡ä¸­ï¼‰
    productService.checkStock(request.getProductId());
    
    // 3. è®¡ç®—ä»·æ ¼ï¼ˆä¸éœ€è¦åœ¨äº‹åŠ¡ä¸­ï¼‰
    BigDecimal price = priceService.calculatePrice(request);
    
    // 4. å‘é€é€šçŸ¥é‚®ä»¶ï¼ˆä¸éœ€è¦åœ¨äº‹åŠ¡ä¸­ï¼‰
    emailService.sendConfirmEmail(user.getEmail());
    
    // 5. åˆ›å»ºè®¢å•ï¼ˆéœ€è¦åœ¨äº‹åŠ¡ä¸­ï¼‰
    Order order = orderService.createOrder(request);
    
    return new OrderResult(order);
}
```

```java
// âœ… æ­£ç¡®åšæ³•ï¼šæ‹†åˆ†äº‹åŠ¡èŒƒå›´
public OrderResult createOrder(OrderRequest request) {
    // éäº‹åŠ¡æ“ä½œï¼šæ•°æ®å‡†å¤‡
    User user = userService.getUser(request.getUserId());
    BigDecimal price = priceService.calculatePrice(request);
    
    // äº‹åŠ¡æ“ä½œï¼šæ ¸å¿ƒä¸šåŠ¡
    Order order = executeOrderTransaction(request, price);
    
    // éäº‹åŠ¡æ“ä½œï¼šåç»­å¤„ç†
    emailService.sendConfirmEmail(user.getEmail());
    
    return new OrderResult(order);
}

@Transactional
private Order executeOrderTransaction(OrderRequest request, BigDecimal price) {
    // åªåŒ…å«å¿…é¡»åœ¨äº‹åŠ¡ä¸­çš„æ ¸å¿ƒæ“ä½œ
    productService.reduceStock(request.getProductId(), request.getQuantity());
    return orderService.createOrder(request, price);
}
```

#### ğŸ”¸ æ—¶é—´ç»´åº¦æ‹†åˆ†


**ç†è§£è¦ç‚¹**ï¼šæŠŠä¸€ä¸ªé•¿æ—¶é—´çš„äº‹åŠ¡ï¼Œæ‹†æˆå¤šä¸ªçŸ­æ—¶é—´çš„äº‹åŠ¡ã€‚

```java
// âŒ é•¿äº‹åŠ¡ï¼šå¤„ç†1000ä¸ªè®¢å•
@Transactional
public void processBatchOrders(List<Order> orders) {
    for (Order order : orders) {  // 1000ä¸ªè®¢å•
        processOrder(order);      // æ¯ä¸ªå¤„ç†100ms
    }
    // æ€»æ—¶é—´ï¼š1000 * 100ms = 100ç§’ï¼ï¼ï¼
}
```

```java
// âœ… çŸ­äº‹åŠ¡ï¼šåˆ†æ‰¹å¤„ç†
public void processBatchOrders(List<Order> orders) {
    int batchSize = 10;  // æ¯æ‰¹å¤„ç†10ä¸ª
    
    for (int i = 0; i < orders.size(); i += batchSize) {
        List<Order> batch = orders.subList(i, 
            Math.min(i + batchSize, orders.size()));
        
        processBatchTransaction(batch);  // æ¯æ‰¹1ç§’
    }
}

@Transactional
private void processBatchTransaction(List<Order> batch) {
    for (Order order : batch) {
        processOrder(order);
    }
    // æ¯æ‰¹æ—¶é—´ï¼š10 * 100ms = 1ç§’
}
```

### 2.3 äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸåˆ™


**æ ¸å¿ƒåŸåˆ™**ï¼š

```
ğŸ¯ åªåŒ…å«å¿…é¡»ä¿è¯ä¸€è‡´æ€§çš„æ“ä½œ
ğŸ“ æ§åˆ¶äº‹åŠ¡æ‰§è¡Œæ—¶é—´åœ¨åˆç†èŒƒå›´å†…
ğŸ”„ é¿å…é•¿æ—¶é—´å ç”¨èµ„æº
âš¡ å‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°

å®é™…å»ºè®®ï¼š
â€¢ å•ä¸ªäº‹åŠ¡æ—¶é—´ < 5ç§’
â€¢ æ¶‰åŠçš„è¡¨æ•°é‡ < 5ä¸ª
â€¢ ç½‘ç»œè°ƒç”¨æ¬¡æ•° < 3æ¬¡
â€¢ äº‹åŠ¡å†…é¿å…æ–‡ä»¶IOæ“ä½œ
```

---

## 3. âš¡ å¼‚æ­¥å¤„ç†ä¼˜åŒ–


### 3.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥å¤„ç†


**ç”Ÿæ´»ç±»æ¯”**ï¼šä½ å»é¤å…ç‚¹é¤æœ‰ä¸¤ç§æ–¹å¼ï¼š

```
åŒæ­¥æ–¹å¼ï¼ˆæ’é˜Ÿç­‰å¾…ï¼‰ï¼š
ä½ ç‚¹é¤ â†’ å¨å¸ˆåšèœ â†’ ç­‰å¾…30åˆ†é’Ÿ â†’ æ‹¿åˆ°èœ â†’ ç¦»å¼€

å¼‚æ­¥æ–¹å¼ï¼ˆå–å·ç­‰å¾…ï¼‰ï¼š
ä½ ç‚¹é¤ â†’ æ‹¿å·ç ç‰Œ â†’ å»åº§ä½ç­‰å¾… â†’ å«å·æ—¶å–é¤
ä¼˜åŠ¿ï¼šä½ å¯ä»¥åœ¨ç­‰å¾…æœŸé—´åšå…¶ä»–äº‹æƒ…
```

### 3.2 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„å¼‚æ­¥ä¼˜åŒ–


#### ğŸ”¸ äº‹åŠ¡æäº¤åå¼‚æ­¥å¤„ç†


**åº”ç”¨åœºæ™¯**ï¼šè®¢å•æ”¯ä»˜æˆåŠŸåçš„åç»­å¤„ç†

```java
// âŒ åŒæ­¥å¤„ç†ï¼šç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿
@Transactional
public PaymentResult processPayment(PaymentRequest request) {
    // æ ¸å¿ƒäº‹åŠ¡ï¼šæ‰£æ¬¾å’Œåˆ›å»ºè®¢å•
    Payment payment = paymentService.deductMoney(request);
    Order order = orderService.createOrder(request);
    
    // è¿™äº›æ“ä½œè®©ç”¨æˆ·ç­‰å¾…å¾ˆä¹…
    inventoryService.updateStock(request.getProductId());  // 500ms
    emailService.sendConfirmation(request.getUserEmail()); // 1000ms
    smsService.sendNotification(request.getPhone());       // 800ms
    logService.recordPayment(payment);                     // 300ms
    
    return new PaymentResult(payment, order);
    // ç”¨æˆ·æ€»ç­‰å¾…æ—¶é—´ï¼š2.6ç§’+
}
```

```java
// âœ… å¼‚æ­¥å¤„ç†ï¼šç”¨æˆ·å¿«é€Ÿå¾—åˆ°åé¦ˆ
@Transactional
public PaymentResult processPayment(PaymentRequest request) {
    // æ ¸å¿ƒäº‹åŠ¡ï¼šåªåšå¿…é¡»åŒæ­¥çš„æ“ä½œ
    Payment payment = paymentService.deductMoney(request);
    Order order = orderService.createOrder(request);
    
    // å¼‚æ­¥å¤„ç†åç»­æ“ä½œ
    asyncTaskService.executeAfterCommit(() -> {
        inventoryService.updateStock(request.getProductId());
        emailService.sendConfirmation(request.getUserEmail());
        smsService.sendNotification(request.getPhone());
        logService.recordPayment(payment);
    });
    
    return new PaymentResult(payment, order);
    // ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼šåªæœ‰æ ¸å¿ƒäº‹åŠ¡æ—¶é—´ï¼Œå¤§çº¦200ms
}
```

#### ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è§£è€¦


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠç´§æ€¥çš„äº‹æƒ…å…ˆåšå®Œï¼Œä¸ç´§æ€¥çš„äº‹æƒ…æ”¾åˆ°é˜Ÿåˆ—é‡Œæ…¢æ…¢åšã€‚

```
åŒæ­¥æµç¨‹ï¼š
è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ ç§¯åˆ†æœåŠ¡ â†’ è¥é”€æœåŠ¡
   â†“         â†“         â†“         â†“
 100ms     200ms     300ms     400ms
æ€»æ—¶é—´ï¼š1000ms

å¼‚æ­¥æµç¨‹ï¼š
è®¢å•æœåŠ¡ â†’ å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ— â†’ ç«‹å³è¿”å›
   â†“           â†“
 100ms       10ms
æ€»æ—¶é—´ï¼š110ms

åå°å¤„ç†ï¼š
æ¶ˆæ¯é˜Ÿåˆ— â†’ åº“å­˜æœåŠ¡ï¼ˆ200msï¼‰
         â†’ ç§¯åˆ†æœåŠ¡ï¼ˆ300msï¼‰
         â†’ è¥é”€æœåŠ¡ï¼ˆ400msï¼‰
å¹¶è¡Œå¤„ç†ï¼Œç”¨æˆ·æ— éœ€ç­‰å¾…
```

**ä»£ç å®ç°**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Transactional
    public OrderResult createOrder(OrderRequest request) {
        // æ ¸å¿ƒäº‹åŠ¡ï¼šåˆ›å»ºè®¢å•
        Order order = doCreateOrder(request);
        
        // å‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œè§¦å‘åç»­å¤„ç†
        OrderEvent event = new OrderEvent(order.getId(), 
                                          order.getUserId(), 
                                          order.getProductId());
        
        rabbitTemplate.convertAndSend("order.exchange", 
                                    "order.created", 
                                    event);
        
        return new OrderResult(order);
        // ç”¨æˆ·ç«‹å³å¾—åˆ°è®¢å•ç»“æœ
    }
}

// å¼‚æ­¥æ¶ˆæ¯å¤„ç†å™¨
@RabbitListener(queues = "inventory.update.queue")
public void handleInventoryUpdate(OrderEvent event) {
    inventoryService.reduceStock(event.getProductId());
}

@RabbitListener(queues = "points.reward.queue") 
public void handlePointsReward(OrderEvent event) {
    pointsService.rewardUser(event.getUserId());
}
```

### 3.3 å¼‚æ­¥å¤„ç†çš„æ³¨æ„äº‹é¡¹


**âš ï¸ éœ€è¦è€ƒè™‘çš„é—®é¢˜**ï¼š

```
æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ å¼‚æ­¥æ“ä½œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
â€¢ å¦‚ä½•ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ
â€¢ éœ€è¦è¡¥å¿æœºåˆ¶

ç”¨æˆ·ä½“éªŒï¼š
â€¢ ç”¨æˆ·å¦‚ä½•çŸ¥é“åå°å¤„ç†ç»“æœï¼Ÿ
â€¢ éœ€è¦æä¾›å¤„ç†çŠ¶æ€æŸ¥è¯¢

ç³»ç»Ÿè®¾è®¡ï¼š
â€¢ æ¶ˆæ¯é˜Ÿåˆ—çš„å¯é æ€§
â€¢ æ¶ˆæ¯é‡å¤å¤„ç†çš„å¹‚ç­‰æ€§
â€¢ å¼‚æ­¥ä»»åŠ¡çš„ç›‘æ§å’Œå‘Šè­¦
```

---

## 4. ğŸ“¦ æ‰¹é‡æ“ä½œä¼˜åŒ–


### 4.1 æ‰¹é‡æ“ä½œçš„å¨åŠ›


**ç”Ÿæ´»ä¾‹å­**ï¼šæ¬ç –å·¥ä½œçš„ä¸¤ç§æ–¹å¼ï¼š

```
é€ä¸ªæ¬ç –ï¼š
ä¸€æ¬¡æ‹¿1å—ç – â†’ èµ°åˆ°ç›®çš„åœ° â†’ æ”¾ä¸‹ â†’ å›æ¥æ‹¿ä¸‹ä¸€å—
é‡å¤100æ¬¡ï¼Œèµ°äº†200æ¬¡è·¯ç¨‹

æ‰¹é‡æ¬ç –ï¼š
ä¸€æ¬¡æ‹¿10å—ç – â†’ èµ°åˆ°ç›®çš„åœ° â†’ æ”¾ä¸‹ â†’ å›æ¥æ‹¿ä¸‹ä¸€æ‰¹
é‡å¤10æ¬¡ï¼Œèµ°äº†20æ¬¡è·¯ç¨‹

æ•ˆç‡æå‡ï¼š10å€ï¼
```

### 4.2 æ•°æ®åº“æ‰¹é‡æ“ä½œ


**åœºæ™¯**ï¼šæ›´æ–°1000ä¸ªç”¨æˆ·çš„ç§¯åˆ†

```java
// âŒ é€æ¡å¤„ç†ï¼šæ€§èƒ½æå·®
@Transactional
public void updateUserPoints(List<UserPoints> userPointsList) {
    for (UserPoints userPoints : userPointsList) {
        // æ¯æ¬¡ä¸€æ¡SQLï¼Œæ‰§è¡Œ1000æ¬¡
        userPointsRepository.updatePoints(userPoints.getUserId(), 
                                        userPoints.getPoints());
    }
    // æ€»æ—¶é—´ï¼š1000 * 5ms = 5ç§’
}
```

```java
// âœ… æ‰¹é‡å¤„ç†ï¼šæ€§èƒ½ä¼˜å¼‚
@Transactional
public void updateUserPointsBatch(List<UserPoints> userPointsList) {
    int batchSize = 100;
    
    for (int i = 0; i < userPointsList.size(); i += batchSize) {
        List<UserPoints> batch = userPointsList.subList(i, 
            Math.min(i + batchSize, userPointsList.size()));
        
        // æ‰¹é‡SQLï¼Œæ¯æ‰¹100æ¡è®°å½•
        userPointsRepository.batchUpdatePoints(batch);
    }
    // æ€»æ—¶é—´ï¼š10 * 50ms = 500msï¼ˆæå‡10å€ï¼‰
}
```

**æ‰¹é‡SQLç¤ºä¾‹**ï¼š

```sql
-- å•æ¡æ›´æ–°SQL
UPDATE user_points SET points = points + ? WHERE user_id = ?

-- æ‰¹é‡æ›´æ–°SQLï¼ˆä½¿ç”¨CASE WHENï¼‰
UPDATE user_points 
SET points = points + 
    CASE user_id
        WHEN 1001 THEN 100
        WHEN 1002 THEN 200
        WHEN 1003 THEN 150
        -- ... æ›´å¤šæ¡ä»¶
    END
WHERE user_id IN (1001, 1002, 1003, ...)
```

### 4.3 åˆ†å¸ƒå¼æœåŠ¡æ‰¹é‡è°ƒç”¨


**åœºæ™¯**ï¼šéœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡è·å–æ•°æ®

```java
// âŒ é€ä¸ªè°ƒç”¨ï¼šç½‘ç»œå¼€é”€å¤§
public List<ProductInfo> getProductDetails(List<Long> productIds) {
    List<ProductInfo> results = new ArrayList<>();
    
    for (Long productId : productIds) {
        // æ¯ä¸ªå•†å“å•ç‹¬è°ƒç”¨ä¸€æ¬¡å¾®æœåŠ¡
        ProductInfo info = productService.getProductById(productId);
        results.add(info);
    }
    // ç½‘ç»œè°ƒç”¨æ¬¡æ•°ï¼š100æ¬¡
    // æ€»æ—¶é—´ï¼š100 * 50ms = 5ç§’
    
    return results;
}
```

```java
// âœ… æ‰¹é‡è°ƒç”¨ï¼šå¤§å¹…å‡å°‘ç½‘ç»œå¼€é”€
public List<ProductInfo> getProductDetailsBatch(List<Long> productIds) {
    int batchSize = 20;
    List<ProductInfo> allResults = new ArrayList<>();
    
    for (int i = 0; i < productIds.size(); i += batchSize) {
        List<Long> batch = productIds.subList(i, 
            Math.min(i + batchSize, productIds.size()));
        
        // æ‰¹é‡è°ƒç”¨å¾®æœåŠ¡
        List<ProductInfo> batchResults = 
            productService.getProductsByIds(batch);
        allResults.addAll(batchResults);
    }
    // ç½‘ç»œè°ƒç”¨æ¬¡æ•°ï¼š5æ¬¡
    // æ€»æ—¶é—´ï¼š5 * 100ms = 500msï¼ˆæå‡10å€ï¼‰
    
    return allResults;
}
```

### 4.4 æ‰¹é‡æ“ä½œçš„æœ€ä½³å®è·µ


**ğŸ”§ æ‰¹é‡å¤§å°é€‰æ‹©**ï¼š

```
æ‰¹é‡å¤§å°å»ºè®®ï¼š

æ•°æ®åº“æ“ä½œï¼š
â€¢ INSERTï¼šæ¯æ‰¹ 500-1000 æ¡
â€¢ UPDATEï¼šæ¯æ‰¹ 100-500 æ¡  
â€¢ DELETEï¼šæ¯æ‰¹ 100-200 æ¡

å¾®æœåŠ¡è°ƒç”¨ï¼š
â€¢ æ ¹æ®å“åº”å¤§å°ï¼š10-50 ä¸ªID
â€¢ æ ¹æ®å¤„ç†æ—¶é—´ï¼šå•æ¬¡è°ƒç”¨ < 2ç§’

å†…å­˜é™åˆ¶ï¼š
â€¢ é¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®åˆ°å†…å­˜
â€¢ è€ƒè™‘JVMå †å†…å­˜å¤§å°
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š

```
é”™è¯¯å¤„ç†ï¼š
â€¢ æ‰¹é‡æ“ä½œä¸­æŸæ¡è®°å½•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
â€¢ æ˜¯å¦æ”¯æŒéƒ¨åˆ†æˆåŠŸï¼Ÿ
â€¢ å¦‚ä½•è®°å½•å…·ä½“çš„å¤±è´¥ä¿¡æ¯ï¼Ÿ

äº‹åŠ¡æ§åˆ¶ï¼š
â€¢ æ‰¹é‡æ“ä½œæ˜¯å¦éœ€è¦äº‹åŠ¡ï¼Ÿ
â€¢ å¤§æ‰¹é‡æ“ä½œä¼šé•¿æ—¶é—´å ç”¨è¿æ¥
â€¢ è€ƒè™‘åˆ†æ‰¹æäº¤äº‹åŠ¡

æ€§èƒ½ç›‘æ§ï¼š
â€¢ ç›‘æ§æ‰¹é‡æ“ä½œçš„æ‰§è¡Œæ—¶é—´
â€¢ è§‚å¯Ÿæ•°æ®åº“è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
â€¢ å…³æ³¨å†…å­˜ä½¿ç”¨æƒ…å†µ
```

---

## 5. ğŸŠ è¿æ¥æ± ä¼˜åŒ–


### 5.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± 


**ç”Ÿæ´»ç±»æ¯”**ï¼šè¿æ¥æ± å°±åƒé“¶è¡Œçš„çª—å£ç®¡ç†ï¼š

```
æ²¡æœ‰è¿æ¥æ± ï¼ˆæ¯æ¬¡éƒ½å¼€æ–°çª—å£ï¼‰ï¼š
å®¢æˆ·æ¥äº† â†’ ä¸´æ—¶å¼€çª—å£ â†’ åŠä¸šåŠ¡ â†’ å…³çª—å£ â†’ ä¸‹ä¸€ä¸ªå®¢æˆ·é‡å¤

æœ‰è¿æ¥æ± ï¼ˆå›ºå®šçª—å£æ•°é‡ï¼‰ï¼š
æå‰å¼€å¥½10ä¸ªçª—å£ â†’ å®¢æˆ·æ¥äº†ç›´æ¥åŠä¸šåŠ¡ â†’ åŠå®Œçª—å£ç»§ç»­æœåŠ¡ä¸‹ä¸€ä¸ª

ä¼˜åŠ¿ï¼š
â€¢ ä¸ç”¨é‡å¤å¼€å…³çª—å£ï¼ˆå»ºç«‹è¿æ¥ï¼‰
â€¢ çª—å£æ•°é‡å¯æ§ï¼ˆè¿æ¥æ•°å¯æ§ï¼‰
â€¢ å®¢æˆ·ç­‰å¾…æ—¶é—´çŸ­ï¼ˆå“åº”å¿«ï¼‰
```

### 5.2 è¿æ¥æ± é…ç½®ä¼˜åŒ–


**æ ¸å¿ƒå‚æ•°è§£é‡Š**ï¼š

```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource.hikari")
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // ğŸ”§ æ ¸å¿ƒå‚æ•°é…ç½®
        
        // è¿æ¥æ± å¤§å°ï¼ˆé“¶è¡Œçª—å£æ•°é‡ï¼‰
        config.setMinimumIdle(5);        // æœ€å°‘ä¿æŒ5ä¸ªè¿æ¥
        config.setMaximumPoolSize(20);   // æœ€å¤š20ä¸ªè¿æ¥
        
        // è¿æ¥è·å–ç­‰å¾…æ—¶é—´
        config.setConnectionTimeout(30000);  // 30ç§’è¶…æ—¶
        
        // è¿æ¥ç©ºé—²æ—¶é—´ï¼ˆçª—å£ç©ºé—²å¤šä¹…å…³é—­ï¼‰
        config.setIdleTimeout(600000);      // 10åˆ†é’Ÿ
        
        // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        config.setMaxLifetime(1800000);     // 30åˆ†é’Ÿ
        
        // è¿æ¥éªŒè¯æŸ¥è¯¢
        config.setConnectionTestQuery("SELECT 1");
        
        return new HikariDataSource(config);
    }
}
```

**å‚æ•°é…ç½®å»ºè®®**ï¼š

| åº”ç”¨ç±»å‹ | **æœ€å°è¿æ¥** | **æœ€å¤§è¿æ¥** | **é€‚ç”¨åœºæ™¯** |
|----------|-------------|-------------|-------------|
| `å°å‹åº”ç”¨` | `2-5` | `10-15` | `å¹¶å‘ç”¨æˆ· < 100` |
| `ä¸­å‹åº”ç”¨` | `5-10` | `20-30` | `å¹¶å‘ç”¨æˆ· 100-500` |
| `å¤§å‹åº”ç”¨` | `10-20` | `50-100` | `å¹¶å‘ç”¨æˆ· > 500` |

### 5.3 åˆ†å¸ƒå¼äº‹åŠ¡è¿æ¥æ± ç‰¹æ®Šè€ƒè™‘


**ğŸ” åˆ†å¸ƒå¼äº‹åŠ¡çš„ç‰¹æ®Šéœ€æ±‚**ï¼š

```
é—®é¢˜åˆ†æï¼š
åˆ†å¸ƒå¼äº‹åŠ¡æ—¶é—´é•¿ â†’ è¿æ¥å ç”¨æ—¶é—´é•¿ â†’ è¿æ¥æ± å®¹æ˜“è€—å°½

ä¸¾ä¾‹è¯´æ˜ï¼š
æ­£å¸¸ä¸šåŠ¡ï¼šè¿æ¥ä½¿ç”¨50mså°±é‡Šæ”¾
åˆ†å¸ƒå¼äº‹åŠ¡ï¼šè¿æ¥ä½¿ç”¨2000msæ‰é‡Šæ”¾ï¼ˆ40å€å·®è·ï¼ï¼‰

å¦‚æœè¿æ¥æ± åªæœ‰20ä¸ªè¿æ¥ï¼š
æ­£å¸¸æƒ…å†µï¼šæ¯ç§’å¯å¤„ç† 20 Ã— (1000ms Ã· 50ms) = 400ä¸ªè¯·æ±‚
åˆ†å¸ƒå¼äº‹åŠ¡ï¼šæ¯ç§’åªèƒ½å¤„ç† 20 Ã— (1000ms Ã· 2000ms) = 10ä¸ªè¯·æ±‚
```

**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**ï¼š

```java
// åˆ†å¸ƒå¼äº‹åŠ¡ä¸“ç”¨æ•°æ®æºé…ç½®
@Bean("distributedTransactionDataSource")
public DataSource distributedTransactionDataSource() {
    HikariConfig config = new HikariConfig();
    
    // å¢å¤§è¿æ¥æ± ï¼ˆå› ä¸ºè¿æ¥å ç”¨æ—¶é—´é•¿ï¼‰
    config.setMaximumPoolSize(50);  // æ¯”æ™®é€šè¿æ¥æ± å¤§ä¸€äº›
    
    // å¢å¤§è¶…æ—¶æ—¶é—´ï¼ˆå› ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡è€—æ—¶é•¿ï¼‰
    config.setConnectionTimeout(60000);  // 60ç§’
    
    // è®¾ç½®è¿æ¥æ³„æ¼æ£€æµ‹
    config.setLeakDetectionThreshold(10000);  // 10ç§’æ£€æµ‹è¿æ¥æ³„æ¼
    
    return new HikariDataSource(config);
}

// æ™®é€šä¸šåŠ¡æ•°æ®æº
@Bean("normalDataSource")
public DataSource normalDataSource() {
    HikariConfig config = new HikariConfig();
    
    // æ­£å¸¸å¤§å°çš„è¿æ¥æ± 
    config.setMaximumPoolSize(20);
    config.setConnectionTimeout(30000);
    
    return new HikariDataSource(config);
}
```

### 5.4 è¿æ¥æ± ç›‘æ§å’Œè°ƒä¼˜


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```java
// è¿æ¥æ± çŠ¶æ€ç›‘æ§
@Component
public class ConnectionPoolMonitor {
    
    @Autowired
    private DataSource dataSource;
    
    @Scheduled(fixedRate = 30000)  // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorConnectionPool() {
        if (dataSource instanceof HikariDataSource) {
            HikariDataSource hikariDS = (HikariDataSource) dataSource;
            HikariPoolMXBean poolBean = hikariDS.getHikariPoolMXBean();
            
            // å…³é”®æŒ‡æ ‡
            int activeConnections = poolBean.getActiveConnections();
            int idleConnections = poolBean.getIdleConnections();
            int totalConnections = poolBean.getTotalConnections();
            int threadsWaiting = poolBean.getThreadsAwaitingConnection();
            
            // å‘Šè­¦åˆ¤æ–­
            if (activeConnections > totalConnections * 0.8) {
                log.warn("è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: {}/{}", activeConnections, totalConnections);
            }
            
            if (threadsWaiting > 0) {
                log.warn("æœ‰ {} ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…è¿æ¥", threadsWaiting);
            }
        }
    }
}
```

**è°ƒä¼˜ç»éªŒ**ï¼š

```
è¿æ¥æ± è¿‡å°çš„ç—‡çŠ¶ï¼š
â€¢ é¢‘ç¹å‡ºç°"è·å–è¿æ¥è¶…æ—¶"é”™è¯¯
â€¢ åº”ç”¨å“åº”æ—¶é—´æ³¢åŠ¨å¤§
â€¢ çº¿ç¨‹ç­‰å¾…è¿æ¥çš„æ•°é‡å¤š

è¿æ¥æ± è¿‡å¤§çš„ç—‡çŠ¶ï¼š
â€¢ æ•°æ®åº“è¿æ¥æ•°å‘Šè­¦
â€¢ å†…å­˜ä½¿ç”¨è¿‡é«˜
â€¢ å¾ˆå¤šè¿æ¥é•¿æœŸç©ºé—²

æœ€ä½³å®è·µï¼š
â€¢ æ ¹æ®å®é™…å¹¶å‘é‡è°ƒæ•´
â€¢ ç›‘æ§è¿æ¥ä½¿ç”¨æƒ…å†µ
â€¢ å®šæœŸè°ƒæ•´å‚æ•°
â€¢ ä½¿ç”¨è¿æ¥æ± ç›‘æ§å·¥å…·
```

---

## 6. ğŸ’¾ ç¼“å­˜ç­–ç•¥


### 6.1 ç¼“å­˜åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ä½œç”¨


**ç†è§£ç¼“å­˜çš„ä»·å€¼**ï¼šå°±åƒåœ¨å®¶é‡Œå­˜ç‚¹å¸¸ç”¨çš„ä¸œè¥¿ï¼Œé¿å…æ¯æ¬¡éƒ½è·‘è¶…å¸‚ã€‚

```
æ— ç¼“å­˜åœºæ™¯ï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ è¿”å›ç»“æœï¼ˆæ¯æ¬¡éƒ½è¦æŸ¥æ•°æ®åº“ï¼‰
å“åº”æ—¶é—´ï¼š100-500ms

æœ‰ç¼“å­˜åœºæ™¯ï¼š
ç”¨æˆ·æŸ¥è¯¢ â†’ å…ˆæŸ¥ç¼“å­˜ â†’ æœ‰å°±ç›´æ¥è¿”å›ï¼ˆ90%æƒ…å†µï¼‰
                  â†’ æ²¡æœ‰å†æŸ¥æ•°æ®åº“ï¼ˆ10%æƒ…å†µï¼‰
å“åº”æ—¶é—´ï¼š5-20msï¼ˆæå‡10-50å€ï¼‰
```

### 6.2 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ç¼“å­˜æŒ‘æˆ˜


**æ ¸å¿ƒé—®é¢˜**ï¼šç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§

```
é—®é¢˜åœºæ™¯ï¼š
1. æ•°æ®åº“ï¼šç”¨æˆ·ä½™é¢ = 1000å…ƒ
2. ç¼“å­˜ï¼šç”¨æˆ·ä½™é¢ = 1000å…ƒ

åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œï¼š
1. æ‰£æ¬¾500å…ƒ â†’ æ•°æ®åº“ä½™é¢ = 500å…ƒ
2. ä½†ç¼“å­˜è¿˜æ˜¯ 1000å…ƒï¼
3. ç”¨æˆ·æŸ¥è¯¢çœ‹åˆ°çš„æ˜¯é”™è¯¯çš„1000å…ƒ

è¿™å°±æ˜¯ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜
```

### 6.3 ç¼“å­˜æ›´æ–°ç­–ç•¥


#### ğŸ”¸ æ—è·¯æ¨¡å¼ï¼ˆCache Asideï¼‰


**æœ€å¸¸ç”¨çš„æ¨¡å¼**ï¼šåº”ç”¨ç¨‹åºè‡ªå·±ç®¡ç†ç¼“å­˜

```java
@Service
public class UserAccountService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private UserAccountRepository repository;
    
    // æŸ¥è¯¢ï¼šå…ˆæŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰å†æŸ¥æ•°æ®åº“
    public UserAccount getAccount(Long userId) {
        String cacheKey = "user:account:" + userId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        String cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return JSON.parseObject(cached, UserAccount.class);
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
        UserAccount account = repository.findById(userId);
        if (account != null) {
            // 3. æŸ¥åˆ°äº†ï¼Œæ”¾å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(account), 30, TimeUnit.MINUTES);
        }
        
        return account;
    }
    
    // æ›´æ–°ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
    @Transactional
    public void updateBalance(Long userId, BigDecimal amount) {
        // 1. æ›´æ–°æ•°æ®åº“
        repository.updateBalance(userId, amount);
        
        // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°åŠ è½½ï¼‰
        String cacheKey = "user:account:" + userId;
        redisTemplate.delete(cacheKey);
    }
}
```

#### ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ç¼“å­˜ç­–ç•¥


**å»¶è¿ŸåŒåˆ æ¨¡å¼**ï¼šè§£å†³å¹¶å‘æƒ…å†µä¸‹çš„ç¼“å­˜ä¸ä¸€è‡´

```java
@Transactional
public void updateBalanceWithCache(Long userId, BigDecimal amount) {
    String cacheKey = "user:account:" + userId;
    
    // 1. å…ˆåˆ é™¤ç¼“å­˜
    redisTemplate.delete(cacheKey);
    
    // 2. æ›´æ–°æ•°æ®åº“
    repository.updateBalance(userId, amount);
    
    // 3. å»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ˆé˜²æ­¢å¹¶å‘è¯»å–åˆ°æ—§æ•°æ®ï¼‰
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(1000);  // å»¶è¿Ÿ1ç§’
            redisTemplate.delete(cacheKey);
        } catch (Exception e) {
            log.error("å»¶è¿Ÿåˆ é™¤ç¼“å­˜å¤±è´¥", e);
        }
    });
}
```

**ä¸ºä»€ä¹ˆè¦å»¶è¿ŸåŒåˆ ï¼Ÿ**

```
æ—¶é—´çº¿åˆ†æï¼š

T1: äº‹åŠ¡Aåˆ é™¤ç¼“å­˜
T2: äº‹åŠ¡BæŸ¥è¯¢ï¼ˆç¼“å­˜ç©ºï¼‰ â†’ æŸ¥æ•°æ®åº“ï¼ˆæ—§æ•°æ®ï¼‰ â†’ å†™å…¥ç¼“å­˜ï¼ˆæ—§æ•°æ®ï¼‰
T3: äº‹åŠ¡Aæ›´æ–°æ•°æ®åº“
T4: äº‹åŠ¡Aå»¶è¿Ÿåˆ é™¤ç¼“å­˜ â†’ æ¸…é™¤äº‹åŠ¡Bå†™å…¥çš„æ—§æ•°æ®

å¦‚æœæ²¡æœ‰å»¶è¿ŸåŒåˆ ï¼š
T4ä¹‹åç¼“å­˜ä¸­è¿˜æ˜¯æ—§æ•°æ®ï¼Œé€ æˆä¸ä¸€è‡´
```

### 6.4 ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©é˜²æŠ¤


#### ğŸ”¸ ç¼“å­˜ç©¿é€é˜²æŠ¤


**é—®é¢˜**ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œæ¯æ¬¡éƒ½ä¼šæŸ¥æ•°æ®åº“

```java
// è§£å†³æ–¹æ¡ˆï¼šå¸ƒéš†è¿‡æ»¤å™¨ + ç©ºå€¼ç¼“å­˜
@Service
public class ProductService {
    
    @Autowired
    private BloomFilter bloomFilter;  // å¸ƒéš†è¿‡æ»¤å™¨
    
    public Product getProduct(Long productId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥
        if (!bloomFilter.mightContain(productId)) {
            return null;  // ç¡®å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        }
        
        String cacheKey = "product:" + productId;
        
        // 2. æŸ¥ç¼“å­˜
        String cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            if ("NULL".equals(cached)) {
                return null;  // ç©ºå€¼ç¼“å­˜
            }
            return JSON.parseObject(cached, Product.class);
        }
        
        // 3. æŸ¥æ•°æ®åº“
        Product product = productRepository.findById(productId);
        if (product != null) {
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(product), 30, TimeUnit.MINUTES);
        } else {
            // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€
            redisTemplate.opsForValue().set(cacheKey, "NULL", 
                5, TimeUnit.MINUTES);
        }
        
        return product;
    }
}
```

#### ğŸ”¸ ç¼“å­˜å‡»ç©¿é˜²æŠ¤


**é—®é¢˜**ï¼šçƒ­ç‚¹æ•°æ®ç¼“å­˜è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“

```java
// è§£å†³æ–¹æ¡ˆï¼šåˆ†å¸ƒå¼é”
public Product getProductWithLock(Long productId) {
    String cacheKey = "product:" + productId;
    String lockKey = "lock:product:" + productId;
    
    // 1. æŸ¥ç¼“å­˜
    String cached = redisTemplate.opsForValue().get(cacheKey);
    if (cached != null) {
        return JSON.parseObject(cached, Product.class);
    }
    
    // 2. è·å–åˆ†å¸ƒå¼é”
    Boolean lockAcquired = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
    
    if (lockAcquired) {
        try {
            // 3. åŒé‡æ£€æŸ¥ï¼ˆè·å–é”æœŸé—´å¯èƒ½å·²è¢«å…¶ä»–çº¿ç¨‹æ›´æ–°ï¼‰
            cached = redisTemplate.opsForValue().get(cacheKey);
            if (cached != null) {
                return JSON.parseObject(cached, Product.class);
            }
            
            // 4. æŸ¥æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜
            Product product = productRepository.findById(productId);
            if (product != null) {
                redisTemplate.opsForValue().set(cacheKey, 
                    JSON.toJSONString(product), 30, TimeUnit.MINUTES);
            }
            return product;
            
        } finally {
            // 5. é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    } else {
        // æ²¡è·åˆ°é”ï¼Œç­‰å¾…ä¸€ä¸‹å†æŸ¥ç¼“å­˜
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return getProductWithLock(productId);  // é€’å½’è°ƒç”¨
    }
}
```

---

## 7. ğŸ“– è¯»å†™åˆ†ç¦»é…åˆ


### 7.1 è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ


**ç®€å•ç†è§£**ï¼šå°±åƒå›¾ä¹¦é¦†çš„ç®¡ç†æ–¹å¼

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸€ä¸ªç®¡ç†å‘˜ï¼‰ï¼š
å€Ÿä¹¦ã€è¿˜ä¹¦ã€æŸ¥è¯¢éƒ½æ‰¾åŒä¸€ä¸ªç®¡ç†å‘˜ â†’ ç®¡ç†å‘˜å¾ˆå¿™ï¼Œæ•ˆç‡ä½

è¯»å†™åˆ†ç¦»ï¼ˆä¸“ä¸šåˆ†å·¥ï¼‰ï¼š
å€Ÿä¹¦ã€è¿˜ä¹¦ â†’ æ‰¾ç®¡ç†å‘˜Aï¼ˆå†™æ“ä½œï¼Œä¸»åº“ï¼‰
æŸ¥è¯¢ä¹¦ç± â†’ æ‰¾ç®¡ç†å‘˜Bã€Cã€Dï¼ˆè¯»æ“ä½œï¼Œä»åº“ï¼‰

ä¼˜åŠ¿ï¼š
â€¢ å†™æ“ä½œä¸å½±å“è¯»æ“ä½œ
â€¢ å¤šä¸ªä»åº“åˆ†æ‹…è¯»å–å‹åŠ›
â€¢ æ•´ä½“æ€§èƒ½å¤§å¹…æå‡
```

### 7.2 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„è¯»å†™åˆ†ç¦»æŒ‘æˆ˜


**æ ¸å¿ƒé—®é¢˜**ï¼šä¸»ä»å»¶è¿Ÿå¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´

```
æ—¶é—´çº¿é—®é¢˜ï¼š
T1: åˆ†å¸ƒå¼äº‹åŠ¡æ›´æ–°ä¸»åº“ï¼ˆç”¨æˆ·ä½™é¢ï¼š1000â†’500ï¼‰
T2: ä¸»åº“æ•°æ®åŒæ­¥åˆ°ä»åº“ï¼ˆéœ€è¦10-100msï¼‰
T3: ç”¨æˆ·æŸ¥è¯¢ä½™é¢ï¼Œè¯»åˆ°ä»åº“æ—§æ•°æ®ï¼ˆè¿˜æ˜¯1000ï¼‰

ç”¨æˆ·çœ‹åˆ°ï¼šæ˜æ˜æ‰£æ¬¾äº†ï¼Œä½™é¢æ€ä¹ˆæ²¡å˜ï¼Ÿ
```

### 7.3 è¯»å†™åˆ†ç¦»é…ç½®


**Spring Booté…ç½®ç¤ºä¾‹**ï¼š

```java
@Configuration
public class DataSourceConfig {
    
    // ä¸»æ•°æ®æºï¼ˆå†™ï¼‰
    @Bean
    @Primary
    public DataSource masterDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://master-db:3306/mydb");
        config.setUsername("root");
        config.setPassword("password");
        return new HikariDataSource(config);
    }
    
    // ä»æ•°æ®æºï¼ˆè¯»ï¼‰
    @Bean
    public DataSource slaveDataSource() {
        HikariConfig config = new HikariConfig();
        config.setJdbcUrl("jdbc:mysql://slave-db:3306/mydb");
        config.setUsername("readonly");
        config.setPassword("password");
        return new HikariDataSource(config);
    }
    
    // åŠ¨æ€æ•°æ®æºè·¯ç”±
    @Bean
    public DataSource routingDataSource() {
        RoutingDataSource routing = new RoutingDataSource();
        
        Map<Object, Object> dataSources = new HashMap<>();
        dataSources.put("master", masterDataSource());
        dataSources.put("slave", slaveDataSource());
        
        routing.setTargetDataSources(dataSources);
        routing.setDefaultTargetDataSource(masterDataSource());
        
        return routing;
    }
}
```

**åŠ¨æ€æ•°æ®æºåˆ‡æ¢**ï¼š

```java
// æ•°æ®æºåˆ‡æ¢å·¥å…·
public class DataSourceHolder {
    private static final ThreadLocal<String> contextHolder = 
        new ThreadLocal<>();
    
    public static void setMaster() {
        contextHolder.set("master");
    }
    
    public static void setSlave() {
        contextHolder.set("slave");
    }
    
    public static String getDataSource() {
        return contextHolder.get();
    }
    
    public static void clear() {
        contextHolder.remove();
    }
}

// åŠ¨æ€æ•°æ®æºè·¯ç”±å®ç°
public class RoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceHolder.getDataSource();
    }
}
```

### 7.4 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„è¯»å†™åˆ†ç¦»ç­–ç•¥


#### ğŸ”¸ å¼ºä¸€è‡´æ€§è¦æ±‚çš„åœºæ™¯


**ç­–ç•¥**ï¼šäº‹åŠ¡ä¸­çš„è¯»æ“ä½œéƒ½èµ°ä¸»åº“

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private UserAccountRepository accountRepository;
    
    public OrderResult createOrder(OrderRequest request) {
        // åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œå¼ºåˆ¶èµ°ä¸»åº“
        DataSourceHolder.setMaster();
        
        try {
            // æŸ¥è¯¢ç”¨æˆ·ä½™é¢ï¼ˆå¿…é¡»æ˜¯æœ€æ–°çš„ï¼‰
            UserAccount account = accountRepository
                .findById(request.getUserId());
            
            if (account.getBalance().compareTo(request.getAmount()) < 0) {
                throw new InsufficientBalanceException();
            }
            
            // æ‰£å‡ä½™é¢
            account.setBalance(account.getBalance().subtract(request.getAmount()));
            accountRepository.save(account);
            
            // åˆ›å»ºè®¢å•
            Order order = new Order(request);
            return orderRepository.save(order);
            
        } finally {
            DataSourceHolder.clear();
        }
    }
}
```

#### ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§å¯æ¥å—çš„åœºæ™¯


**ç­–ç•¥**ï¼šè¯»æ“ä½œèµ°ä»åº“ï¼Œä½†æœ‰fallbackæœºåˆ¶

```java
@Service
public class UserInfoService {
    
    public UserInfo getUserInfo(Long userId) {
        // ä¼˜å…ˆä»ä»åº“è¯»å–
        DataSourceHolder.setSlave();
        
        try {
            UserInfo userInfo = userRepository.findById(userId);
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦è¶³å¤Ÿæ–°ï¼ˆæ ¹æ®ä¸šåŠ¡åˆ¤æ–­ï¼‰
            if (isDataTooOld(userInfo)) {
                // æ•°æ®å¤ªæ—§ï¼Œåˆ‡æ¢åˆ°ä¸»åº“
                DataSourceHolder.setMaster();
                userInfo = userRepository.findById(userId);
            }
            
            return userInfo;
            
        } finally {
            DataSourceHolder.clear();
        }
    }
    
    private boolean isDataTooOld(UserInfo userInfo) {
        // ä¸šåŠ¡é€»è¾‘åˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸ
        // æ¯”å¦‚ï¼šæœ€åæ›´æ–°æ—¶é—´è¶…è¿‡1åˆ†é’Ÿ
        return System.currentTimeMillis() - userInfo.getLastUpdateTime() 
               > 60000;
    }
}
```

#### ğŸ”¸ æ³¨è§£é©±åŠ¨çš„è‡ªåŠ¨åˆ‡æ¢


```java
// è‡ªå®šä¹‰æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "master";
}

// AOPåˆ‡é¢å®ç°
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(dataSource)")
    public Object around(ProceedingJoinPoint point, DataSource dataSource) 
            throws Throwable {
        
        // è®¾ç½®æ•°æ®æº
        DataSourceHolder.contextHolder.set(dataSource.value());
        
        try {
            return point.proceed();
        } finally {
            DataSourceHolder.clear();
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class ProductService {
    
    @DataSource("slave")  // è¯»æ“ä½œèµ°ä»åº“
    public Product getProduct(Long id) {
        return productRepository.findById(id);
    }
    
    @DataSource("master")  // å†™æ“ä½œèµ°ä¸»åº“
    @Transactional
    public Product saveProduct(Product product) {
        return productRepository.save(product);
    }
}
```

### 7.5 è¯»å†™åˆ†ç¦»ç›‘æ§å’Œè°ƒä¼˜


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```java
@Component
public class ReadWriteSplitMonitor {
    
    private final AtomicLong masterReadCount = new AtomicLong();
    private final AtomicLong slaveReadCount = new AtomicLong();
    private final AtomicLong writeCount = new AtomicLong();
    
    @EventListener
    public void handleDataSourceSwitch(DataSourceSwitchEvent event) {
        switch (event.getDataSource()) {
            case "master":
                if (event.isRead()) {
                    masterReadCount.incrementAndGet();
                } else {
                    writeCount.incrementAndGet();
                }
                break;
            case "slave":
                slaveReadCount.incrementAndGet();
                break;
        }
    }
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡
    public void reportStatistics() {
        long master = masterReadCount.getAndSet(0);
        long slave = slaveReadCount.getAndSet(0);
        long write = writeCount.getAndSet(0);
        
        double readSplitRatio = slave / (double)(master + slave) * 100;
        
        log.info("è¯»å†™åˆ†ç¦»ç»Ÿè®¡ - ä¸»åº“è¯»:{}, ä»åº“è¯»:{}, å†™:{}, è¯»åˆ†ç¦»ç‡:{}%", 
                master, slave, write, readSplitRatio);
        
        // å‘Šè­¦åˆ¤æ–­
        if (readSplitRatio < 70) {
            log.warn("è¯»åˆ†ç¦»ç‡è¿‡ä½ï¼Œå¯èƒ½å­˜åœ¨é…ç½®é—®é¢˜");
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ äº‹åŠ¡èŒƒå›´æœ€å°åŒ–ï¼šåªåœ¨äº‹åŠ¡ä¸­åŒ…å«å¿…é¡»ä¿è¯ä¸€è‡´æ€§çš„æ“ä½œ
ğŸ”¸ å¼‚æ­¥å¤„ç†ä¼˜åŒ–ï¼šæŠŠä¸ç´§æ€¥çš„æ“ä½œæ”¾åˆ°äº‹åŠ¡å¤–å¼‚æ­¥å¤„ç†
ğŸ”¸ æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼šå‡å°‘ç½‘ç»œå’Œæ•°æ®åº“äº¤äº’æ¬¡æ•°
ğŸ”¸ è¿æ¥æ± ä¼˜åŒ–ï¼šåˆç†é…ç½®è¿æ¥æ± å‚æ•°ï¼Œé¿å…è¿æ¥è€—å°½
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šå¤„ç†å¥½ç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§é—®é¢˜
ğŸ”¸ è¯»å†™åˆ†ç¦»é…åˆï¼šåœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§å‰æä¸‹æå‡è¯»æ€§èƒ½
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¼˜åŒ–çš„æœ¬è´¨æ˜¯æƒè¡¡**
```
æ€§èƒ½ vs ä¸€è‡´æ€§ï¼š
â€¢ å¼ºä¸€è‡´æ€§è¦æ±‚ â†’ ç‰ºç‰²ä¸€äº›æ€§èƒ½
â€¢ æ€§èƒ½è¦æ±‚æé«˜ â†’ æ¥å—æœ€ç»ˆä¸€è‡´æ€§

ç®€å• vs é«˜æ•ˆï¼š
â€¢ ç®€å•æ–¹æ¡ˆæ˜“ç»´æŠ¤ï¼Œä½†æ€§èƒ½ä¸€èˆ¬
â€¢ å¤æ‚ä¼˜åŒ–æå‡æ€§èƒ½ï¼Œä½†å¢åŠ ç»´æŠ¤æˆæœ¬

å®æ—¶ vs å¼‚æ­¥ï¼š
â€¢ å®æ—¶å¤„ç†ç”¨æˆ·ä½“éªŒå¥½ï¼Œä½†ç³»ç»Ÿå‹åŠ›å¤§
â€¢ å¼‚æ­¥å¤„ç†ç³»ç»Ÿå‹åŠ›å°ï¼Œä½†éœ€è¦å¤„ç†æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ ä¼˜åŒ–éœ€è¦å¾ªåºæ¸è¿›**
```
ä¼˜åŒ–é¡ºåºå»ºè®®ï¼š
1. å…ˆä¼˜åŒ–å•ç‚¹æ€§èƒ½ï¼ˆæ•°æ®åº“ç´¢å¼•ã€SQLä¼˜åŒ–ï¼‰
2. å†ä¼˜åŒ–æ¶æ„è®¾è®¡ï¼ˆäº‹åŠ¡èŒƒå›´ã€å¼‚æ­¥å¤„ç†ï¼‰
3. æœ€åä¼˜åŒ–åŸºç¡€è®¾æ–½ï¼ˆè¿æ¥æ± ã€ç¼“å­˜ã€è¯»å†™åˆ†ç¦»ï¼‰

é¿å…è¿‡åº¦ä¼˜åŒ–ï¼š
â€¢ ä¸è¦ä¸€å¼€å§‹å°±ä½¿ç”¨å¤æ‚æ–¹æ¡ˆ
â€¢ æ ¹æ®å®é™…å‹åŠ›å’Œä¸šåŠ¡éœ€æ±‚é€‰æ‹©
â€¢ æŒç»­ç›‘æ§ï¼Œæ ¹æ®æ•°æ®è°ƒæ•´ç­–ç•¥
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•å¤„ç†ä¸­çš„åº“å­˜æ‰£å‡ã€æ”¯ä»˜ã€ç§¯åˆ†å¥–åŠ±ç­‰æ“ä½œçš„ä¼˜åŒ–
- **é‡‘èç³»ç»Ÿ**ï¼šè´¦æˆ·èµ„é‡‘å˜åŠ¨çš„é«˜æ€§èƒ½å¤„ç†
- **ç‰©æµç³»ç»Ÿ**ï¼šåŒ…è£¹çŠ¶æ€æ›´æ–°çš„æ‰¹é‡å¤„ç†
- **ç”¨æˆ·ç³»ç»Ÿ**ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°çš„ç¼“å­˜ä¸€è‡´æ€§å¤„ç†

**ğŸ”§ æŠ€æœ¯é€‰å‹æŒ‡å¯¼**
- **å°å‹ç³»ç»Ÿ**ï¼šé‡ç‚¹å…³æ³¨äº‹åŠ¡èŒƒå›´å’Œå¼‚æ­¥å¤„ç†
- **ä¸­å‹ç³»ç»Ÿ**ï¼šåŠ å…¥æ‰¹é‡æ“ä½œå’Œè¿æ¥æ± ä¼˜åŒ–
- **å¤§å‹ç³»ç»Ÿ**ï¼šå…¨é¢åº”ç”¨ç¼“å­˜å’Œè¯»å†™åˆ†ç¦»ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
äº‹åŠ¡èŒƒå›´è¦æœ€å°ï¼Œå¼‚æ­¥å¤„ç†å“åº”å¿«
æ‰¹é‡æ“ä½œæ•ˆç‡é«˜ï¼Œè¿æ¥æ± é…ç½®è¦åˆç†  
ç¼“å­˜ä¸€è‡´æ˜¯å…³é”®ï¼Œè¯»å†™åˆ†ç¦»ææ€§èƒ½
ä¼˜åŒ–éœ€è¦è®²ç­–ç•¥ï¼Œç›‘æ§è°ƒä¼˜ä¸å¯å°‘
```