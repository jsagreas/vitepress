---
title: 1ã€åˆ†å¸ƒå¼äº‹åŠ¡å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œæŠ–åŠ¨é—®é¢˜](#1-ç½‘ç»œæŠ–åŠ¨é—®é¢˜)
2. [è¶…æ—¶é‡è¯•æœºåˆ¶](#2-è¶…æ—¶é‡è¯•æœºåˆ¶)
3. [å¹‚ç­‰æ€§è®¾è®¡](#3-å¹‚ç­‰æ€§è®¾è®¡)
4. [é˜²æ‚¬æŒ‚æœºåˆ¶](#4-é˜²æ‚¬æŒ‚æœºåˆ¶)
5. [è¡¥å¿å¤±è´¥å¤„ç†](#5-è¡¥å¿å¤±è´¥å¤„ç†)
6. [äº‹åŠ¡å›æ»šå¤±è´¥](#6-äº‹åŠ¡å›æ»šå¤±è´¥)
7. [è„è¯»é—®é¢˜](#7-è„è¯»é—®é¢˜)
8. [èµ„æºæ³„éœ²é˜²æŠ¤](#8-èµ„æºæ³„éœ²é˜²æŠ¤)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ç½‘ç»œæŠ–åŠ¨é—®é¢˜


### 1.1 ä»€ä¹ˆæ˜¯ç½‘ç»œæŠ–åŠ¨


**é€šä¿—ç†è§£**ï¼šç½‘ç»œæŠ–åŠ¨å°±åƒæ‰‹æœºä¿¡å·æ—¶å¥½æ—¶åï¼Œå¾®æœåŠ¡ä¹‹é—´é€šä¿¡æ—¶ä¼šå‡ºç°å»¶è¿Ÿçªç„¶å˜é«˜ã€å¶å°”æ–­è¿çš„æƒ…å†µã€‚

```
æ­£å¸¸ç½‘ç»œé€šä¿¡ï¼š
æœåŠ¡A â€”â€”â€”â€”â€”â€”> æœåŠ¡B (100mså“åº”)
æœåŠ¡A â€”â€”â€”â€”â€”â€”> æœåŠ¡B (120mså“åº”)

ç½‘ç»œæŠ–åŠ¨æ—¶ï¼š
æœåŠ¡A â€”â€”â€”â€”â€”X  æœåŠ¡B (è¶…æ—¶æ— å“åº”)
æœåŠ¡A â€”â€”â€”â€”â€”â€”> æœåŠ¡B (3000mså“åº”)
```

> ğŸ’¡ **ç®€å•ç†è§£**ï¼šå°±åƒæ‰“ç”µè¯æ—¶ä¿¡å·ä¸å¥½ï¼Œæœ‰æ—¶é€šè¯æ¸…æ™°ï¼Œæœ‰æ—¶å¬ä¸æ¸…ç”šè‡³æ–­çº¿

### 1.2 ç½‘ç»œæŠ–åŠ¨å¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„å½±å“


**æ ¸å¿ƒé—®é¢˜**ï¼š
- **äº‹åŠ¡çŠ¶æ€ä¸ç¡®å®š**ï¼šä¸çŸ¥é“è¿œç¨‹æœåŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
- **é‡å¤æ‰§è¡Œé£é™©**ï¼šç½‘ç»œæ¢å¤åå¯èƒ½é‡å¤å‘é€è¯·æ±‚
- **äº‹åŠ¡ä¸€è‡´æ€§ç ´å**ï¼šéƒ¨åˆ†æœåŠ¡æˆåŠŸï¼Œéƒ¨åˆ†å¤±è´¥

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
ç”µå•†ä¸‹å•æµç¨‹ï¼š
1. åº“å­˜æœåŠ¡ - å‡åº“å­˜ âœ…
2. è®¢å•æœåŠ¡ - åˆ›å»ºè®¢å• âœ…  
3. æ”¯ä»˜æœåŠ¡ - æ‰£æ¬¾ âŒ (ç½‘ç»œæŠ–åŠ¨è¶…æ—¶)

ç»“æœï¼šåº“å­˜å‡äº†ï¼Œè®¢å•åˆ›å»ºäº†ï¼Œä½†é’±æ²¡æ‰£
```

### 1.3 ç½‘ç»œæŠ–åŠ¨è§£å†³æ–¹æ¡ˆ


**ğŸ”§ è§£å†³ç­–ç•¥ä¸€ï¼šè¶…æ—¶é‡è¯•æœºåˆ¶**
```java
@Component
public class PaymentService {
    
    // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•ç­–ç•¥
    @Retryable(
        value = {ConnectTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public PaymentResult processPayment(PaymentRequest request) {
        // æ”¯ä»˜é€»è¾‘
        return callPaymentGateway(request);
    }
}
```

**ğŸ”§ è§£å†³ç­–ç•¥äºŒï¼šæ–­è·¯å™¨æ¨¡å¼**
```java
@Component
public class OrderService {
    
    @CircuitBreaker(name = "payment-service", 
                   fallbackMethod = "paymentFallback")
    public void createOrder(OrderRequest request) {
        // è°ƒç”¨æ”¯ä»˜æœåŠ¡
        paymentService.processPayment(request);
    }
    
    // é™çº§å¤„ç†ï¼šåˆ›å»ºå¾…æ”¯ä»˜è®¢å•
    public void paymentFallback(OrderRequest request, Exception ex) {
        // åˆ›å»ºå¾…æ”¯ä»˜çŠ¶æ€çš„è®¢å•
        createPendingOrder(request);
    }
}
```

**ğŸ”§ è§£å†³ç­–ç•¥ä¸‰ï¼šå¼‚æ­¥æ¶ˆæ¯ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§**
```java
// ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
public void handleOrderCreation(OrderEvent event) {
    try {
        // å°è¯•æ‰§è¡Œä¸šåŠ¡
        processOrder(event);
        // å‘é€æˆåŠŸæ¶ˆæ¯
        messageProducer.sendSuccess(event);
    } catch (NetworkException e) {
        // ç½‘ç»œé—®é¢˜ï¼Œç¨åé‡è¯•
        messageProducer.sendRetry(event, 5000); // 5ç§’åé‡è¯•
    }
}
```

---

## 2. â° è¶…æ—¶é‡è¯•æœºåˆ¶


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶é‡è¯•


**æ ¸å¿ƒåŸå› **ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç½‘ç»œä¸å¯é æ˜¯å¸¸æ€ï¼Œéœ€è¦æœ‰å®¹é”™æœºåˆ¶

```
æ²¡æœ‰é‡è¯•çš„é—®é¢˜ï¼š
è¯·æ±‚ â€”â€”â€”â€”â€”â€”X (ç½‘ç»œé—®é¢˜ï¼Œç›´æ¥å¤±è´¥)

æœ‰é‡è¯•çš„æ•ˆæœï¼š
è¯·æ±‚1 â€”â€”â€”â€”â€”X (å¤±è´¥)
è¯·æ±‚2 â€”â€”â€”â€”â€”X (å¤±è´¥) 
è¯·æ±‚3 â€”â€”â€”â€”> âœ… (æˆåŠŸ)
```

> âš ï¸ **æ³¨æ„**ï¼šé‡è¯•ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå¿…é¡»é…åˆå¹‚ç­‰æ€§è®¾è®¡

### 2.2 é‡è¯•ç­–ç•¥è®¾è®¡


**ğŸ¯ ç­–ç•¥ä¸€ï¼šå›ºå®šé—´éš”é‡è¯•**
```java
@Component
public class OrderServiceImpl {
    
    // å›ºå®šæ¯éš”2ç§’é‡è¯•ï¼Œæœ€å¤š3æ¬¡
    @Retryable(
        value = {ConnectTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 2000)
    )
    public void createOrder(OrderDTO order) {
        // åˆ›å»ºè®¢å•é€»è¾‘
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•æ˜“ç†è§£
**ç¼ºç‚¹**ï¼šå¯èƒ½é€ æˆæœåŠ¡å™¨å‹åŠ›é›†ä¸­

**ğŸ¯ ç­–ç•¥äºŒï¼šæŒ‡æ•°é€€é¿é‡è¯•**
```java
// é‡è¯•é—´éš”ï¼š1s -> 2s -> 4s -> 8s
@Retryable(
    maxAttempts = 4,
    backoff = @Backoff(
        delay = 1000, 
        multiplier = 2, 
        maxDelay = 10000
    )
)
public PaymentResult processPayment(PaymentRequest request) {
    return remotePaymentService.pay(request);
}
```

**ä¼˜ç‚¹**ï¼šç»™æœåŠ¡æ¢å¤æ—¶é—´ï¼Œå‡è½»æœåŠ¡å‹åŠ›
**æ¨èä½¿ç”¨**ï¼šå¤§å¤šæ•°åœºæ™¯ä¸‹çš„æœ€ä½³é€‰æ‹©

### 2.3 é‡è¯•çš„è¾¹ç•Œæ¡ä»¶


**ğŸš« ä¸åº”è¯¥é‡è¯•çš„æƒ…å†µ**ï¼š
```java
public enum ErrorType {
    NETWORK_ERROR,     // âœ… å¯ä»¥é‡è¯•
    TIMEOUT_ERROR,     // âœ… å¯ä»¥é‡è¯•  
    BUSINESS_ERROR,    // âŒ ä¸åº”é‡è¯• (å¦‚ä½™é¢ä¸è¶³)
    AUTH_ERROR,        // âŒ ä¸åº”é‡è¯• (å¦‚æƒé™ä¸å¤Ÿ)
    PARAM_ERROR        // âŒ ä¸åº”é‡è¯• (å¦‚å‚æ•°é”™è¯¯)
}

// æ™ºèƒ½é‡è¯•åˆ¤æ–­
@Retryable(
    retryFor = {NetworkException.class, TimeoutException.class},
    noRetryFor = {BusinessException.class, AuthException.class}
)
public void processBusinessLogic() {
    // ä¸šåŠ¡é€»è¾‘
}
```

> ğŸ’¡ **é‡è¦åŸåˆ™**ï¼šåªå¯¹ä¸´æ—¶æ€§ã€å¯æ¢å¤çš„é”™è¯¯è¿›è¡Œé‡è¯•

---

## 3. ğŸ”„ å¹‚ç­‰æ€§è®¾è®¡


### 3.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**é€šä¿—è§£é‡Š**ï¼šå¹‚ç­‰æ€§å°±æ˜¯"åšå¤šå°‘æ¬¡éƒ½æ˜¯åŒæ ·çš„ç»“æœ"ï¼Œå°±åƒæŒ‰ç”µæ¢¯æŒ‰é’®ï¼ŒæŒ‰1æ¬¡å’ŒæŒ‰10æ¬¡æ•ˆæœä¸€æ ·ã€‚

```
æ•°å­¦ä¸­çš„å¹‚ç­‰æ€§ï¼š
f(x) = f(f(x)) = f(f(f(x)))

ä¸šåŠ¡ä¸­çš„å¹‚ç­‰æ€§ï¼š
è½¬è´¦100å…ƒ = é‡å¤è½¬è´¦100å…ƒè¯·æ±‚ = æœ€ç»ˆåªè½¬è´¦100å…ƒ
```

### 3.2 ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦å¹‚ç­‰æ€§


**æ ¸å¿ƒé—®é¢˜**ï¼šç½‘ç»œé‡è¯•å¯èƒ½å¯¼è‡´é‡å¤æ‰§è¡Œ

```
é—®é¢˜åœºæ™¯ï¼š
1. ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜æŒ‰é’®
2. è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨
3. ç½‘ç»œè¶…æ—¶ï¼Œå‰ç«¯é‡å‘è¯·æ±‚
4. ç¬¬ä¸€ä¸ªè¯·æ±‚å…¶å®å·²ç»æˆåŠŸäº†
5. ç»“æœï¼šç”¨æˆ·è¢«æ‰£äº†ä¸¤æ¬¡é’± ğŸ’¸
```

> âš ï¸ **é£é™©**ï¼šæ²¡æœ‰å¹‚ç­‰æ€§è®¾è®¡ï¼Œé‡è¯•æœºåˆ¶åè€Œä¼šé€ æˆæ•°æ®é—®é¢˜

### 3.3 å¹‚ç­‰æ€§å®ç°æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šå”¯ä¸€æ€§çº¦æŸ**
```java
@Entity
@Table(uniqueConstraints = {
    @UniqueConstraint(columnNames = {"user_id", "order_no"})
})
public class Payment {
    private String userId;
    private String orderNo;  // è®¢å•å·ä½œä¸ºä¸šåŠ¡å”¯ä¸€æ ‡è¯†
    private BigDecimal amount;
    
    // æ•°æ®åº“å±‚é¢ä¿è¯å”¯ä¸€æ€§
}

@Service
public class PaymentService {
    
    public PaymentResult pay(PaymentRequest request) {
        try {
            // å°è¯•æ’å…¥æ”¯ä»˜è®°å½•
            Payment payment = new Payment(request.getUserId(), 
                                        request.getOrderNo(), 
                                        request.getAmount());
            paymentRepository.save(payment);
            return PaymentResult.success();
        } catch (DataIntegrityViolationException e) {
            // é‡å¤è¯·æ±‚ï¼Œè¿”å›ä¹‹å‰çš„ç»“æœ
            return getExistingPaymentResult(request.getOrderNo());
        }
    }
}
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šRedisåˆ†å¸ƒå¼é”**
```java
@Component
public class IdempotentService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean tryLock(String idempotentKey, int expireSeconds) {
        String lockKey = "idempotent:lock:" + idempotentKey;
        Boolean result = redisTemplate.opsForValue()
                                    .setIfAbsent(lockKey, "1", 
                                               Duration.ofSeconds(expireSeconds));
        return Boolean.TRUE.equals(result);
    }
    
    public void releaseLock(String idempotentKey) {
        String lockKey = "idempotent:lock:" + idempotentKey;
        redisTemplate.delete(lockKey);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public PaymentResult processPayment(PaymentRequest request) {
    String idempotentKey = request.getUserId() + ":" + request.getOrderNo();
    
    if (!idempotentService.tryLock(idempotentKey, 300)) {
        // é‡å¤è¯·æ±‚ï¼Œè¿”å›å¤„ç†ä¸­çŠ¶æ€
        return PaymentResult.processing();
    }
    
    try {
        // æ‰§è¡Œæ”¯ä»˜é€»è¾‘
        return doPayment(request);
    } finally {
        idempotentService.releaseLock(idempotentKey);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šçŠ¶æ€æœºæ¨¡å¼**
```java
public enum OrderStatus {
    PENDING,    // å¾…å¤„ç†
    PROCESSING, // å¤„ç†ä¸­  
    COMPLETED,  // å·²å®Œæˆ
    FAILED      // å¤±è´¥
}

@Service
public class OrderService {
    
    public OrderResult processOrder(OrderRequest request) {
        Order order = orderRepository.findByOrderNo(request.getOrderNo());
        
        if (order == null) {
            // é¦–æ¬¡è¯·æ±‚ï¼Œåˆ›å»ºè®¢å•
            order = createNewOrder(request);
        }
        
        // æ ¹æ®çŠ¶æ€å†³å®šå¤„ç†é€»è¾‘
        switch (order.getStatus()) {
            case PENDING:
                return processNewOrder(order);
            case PROCESSING:
                return OrderResult.processing(); // é‡å¤è¯·æ±‚ï¼Œè¿”å›å¤„ç†ä¸­
            case COMPLETED:
                return OrderResult.success(order); // é‡å¤è¯·æ±‚ï¼Œè¿”å›æˆåŠŸç»“æœ
            case FAILED:
                return retryFailedOrder(order); // å¤±è´¥è®¢å•å¯ä»¥é‡è¯•
            default:
                throw new IllegalStateException("æœªçŸ¥è®¢å•çŠ¶æ€");
        }
    }
}
```

---

## 4. ğŸš« é˜²æ‚¬æŒ‚æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯æ‚¬æŒ‚é—®é¢˜


**é€šä¿—è§£é‡Š**ï¼šæ‚¬æŒ‚é—®é¢˜å°±åƒ"å¹½çµäº‹åŠ¡"ï¼ŒTCCäº‹åŠ¡çš„Tryé˜¶æ®µå› ä¸ºç½‘ç»œé—®é¢˜æ²¡æ‰§è¡Œï¼Œä½†åé¢çš„Cancelé˜¶æ®µå´æ‰§è¡Œäº†ã€‚

```
æ­£å¸¸TCCæµç¨‹ï¼š
Try â†’ Confirm/Cancel

æ‚¬æŒ‚é—®é¢˜ï¼š
Try (ç½‘ç»œè¶…æ—¶,æœªæ‰§è¡Œ) â†’ Cancel (æ‰§è¡Œäº†) âŒ

ç»“æœï¼šèµ„æºè¢«é”™è¯¯é‡Šæ”¾æˆ–é”å®š
```

> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šå°±åƒé¢„å®šé¤å…ï¼Œé¢„å®šè¯·æ±‚æ²¡å‘å‡ºå»ï¼Œä½†å–æ¶ˆè¯·æ±‚å´å‘å‡ºå»äº†ï¼Œé¤å…ä»¥ä¸ºä½ å–æ¶ˆäº†ä¸€ä¸ªä¸å­˜åœ¨çš„é¢„å®š

### 4.2 æ‚¬æŒ‚é—®é¢˜çš„å±å®³


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
åº“å­˜æ‰£å‡åœºæ™¯ï¼š
1. Tryé˜¶æ®µï¼šé¢„æ‰£åº“å­˜ (ç½‘ç»œé—®é¢˜ï¼Œæœªæ‰§è¡Œ)
2. Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„æ‰£åº“å­˜ (æ‰§è¡Œäº†)
3. å®é™…åº“å­˜ï¼šæ²¡æœ‰å˜åŒ–
4. ç³»ç»Ÿè®°å½•ï¼šä»¥ä¸ºæ‰§è¡Œäº†æ‰£å‡åˆé‡Šæ”¾

é—®é¢˜ï¼šç³»ç»ŸçŠ¶æ€ä¸å®é™…ä¸ä¸€è‡´
```

### 4.3 é˜²æ‚¬æŒ‚è§£å†³æ–¹æ¡ˆ


**ğŸ”§ æ ¸å¿ƒæ€è·¯ï¼šè®°å½•äº‹åŠ¡çŠ¶æ€**
```java
@Component
public class InventoryTccService {
    
    @Autowired
    private TccTransactionRepository tccRepository;
    
    // Tryé˜¶æ®µï¼šé¢„æ‰£åº“å­˜
    public boolean tryReduceInventory(String xid, String productId, int quantity) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡Cancel
        if (tccRepository.isCancelled(xid)) {
            log.warn("äº‹åŠ¡{}å·²è¢«å–æ¶ˆï¼Œæ‹’ç»æ‰§è¡ŒTryæ“ä½œ", xid);
            return false; // é˜²æ‚¬æŒ‚ï¼šæ‹’ç»æ‰§è¡Œ
        }
        
        // è®°å½•TryçŠ¶æ€
        TccTransaction tcc = new TccTransaction();
        tcc.setXid(xid);
        tcc.setStatus(TccStatus.TRYING);
        tcc.setCreateTime(new Date());
        tccRepository.save(tcc);
        
        // æ‰§è¡Œé¢„æ‰£åº“å­˜
        return inventoryService.reserveInventory(productId, quantity);
    }
    
    // Cancelé˜¶æ®µï¼šé‡Šæ”¾é¢„æ‰£åº“å­˜
    public boolean cancelReduceInventory(String xid, String productId, int quantity) {
        TccTransaction tcc = tccRepository.findByXid(xid);
        
        if (tcc == null) {
            // Tryé˜¶æ®µæœªæ‰§è¡Œï¼Œè®°å½•CancelçŠ¶æ€ï¼Œé˜²æ­¢åç»­Tryæ‰§è¡Œ
            tcc = new TccTransaction();
            tcc.setXid(xid);
            tcc.setStatus(TccStatus.CANCELLED);
            tccRepository.save(tcc);
            return true; // ç©ºCancelï¼Œç›´æ¥æˆåŠŸ
        }
        
        if (tcc.getStatus() == TccStatus.TRYING) {
            // æ­£å¸¸æƒ…å†µï¼šTryæ‰§è¡Œäº†ï¼Œç°åœ¨æ‰§è¡ŒCancel
            inventoryService.releaseReservedInventory(productId, quantity);
            tcc.setStatus(TccStatus.CANCELLED);
            tccRepository.save(tcc);
            return true;
        }
        
        // å…¶ä»–æƒ…å†µï¼šå·²ç»å¤„ç†è¿‡
        return true;
    }
}
```

**ğŸ¯ çŠ¶æ€æœºé˜²æ‚¬æŒ‚**ï¼š
```
äº‹åŠ¡çŠ¶æ€æµè½¬ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Initial   â”‚ (åˆå§‹çŠ¶æ€)
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”Œâ”€â”€â”€â”€â”€â”€â”‚    Trying    â”‚â—„â”€â”€â”€â”€â”€â”
            â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
            â”‚             â”‚             â”‚
            â”‚      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”      â”‚
            â”‚      â”‚  Confirmed  â”‚      â”‚ Tryè¯·æ±‚
            â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
            â”‚                           â”‚
    Cancel  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
    è¯·æ±‚    â””â”€â”€â”€â”€â”€â–ºâ”‚  Cancelled  â”‚â”€â”€â”€â”€â”€â”€â”˜
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ ç®€åŒ–ç‰ˆé˜²æ‚¬æŒ‚å®ç°**ï¼š
```java
@Service
public class TccService {
    
    private final Map<String, String> tccStatus = new ConcurrentHashMap<>();
    
    public boolean tryOperation(String xid) {
        // æ£€æŸ¥æ˜¯å¦å·²è¢«å–æ¶ˆ
        if ("CANCELLED".equals(tccStatus.get(xid))) {
            return false; // é˜²æ‚¬æŒ‚
        }
        
        // è®°å½•TryçŠ¶æ€
        tccStatus.put(xid, "TRYING");
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        return true;
    }
    
    public boolean cancelOperation(String xid) {
        String status = tccStatus.get(xid);
        
        if (status == null) {
            // Tryæœªæ‰§è¡Œï¼Œè®°å½•CancelçŠ¶æ€
            tccStatus.put(xid, "CANCELLED");
            return true; // ç©ºCancel
        }
        
        if ("TRYING".equals(status)) {
            // æ­£å¸¸Cancel
            tccStatus.put(xid, "CANCELLED");
            // æ‰§è¡Œè¡¥å¿é€»è¾‘
            return true;
        }
        
        return true; // é‡å¤Cancel
    }
}
```

---

## 5. ğŸ”„ è¡¥å¿å¤±è´¥å¤„ç†


### 5.1 ä»€ä¹ˆæ˜¯è¡¥å¿å¤±è´¥


**é€šä¿—è§£é‡Š**ï¼šè¡¥å¿å¤±è´¥å°±æ˜¯"æƒ³è¦æ’¤é”€æ“ä½œï¼Œä½†æ’¤é”€ä¹Ÿå¤±è´¥äº†"ï¼Œå°±åƒæƒ³è¦é€€è´§ï¼Œä½†é€€è´§è¿‡ç¨‹ä¸­åˆå‡ºé—®é¢˜äº†ã€‚

```
æ­£å¸¸è¡¥å¿æµç¨‹ï¼š
æ“ä½œæ‰§è¡Œ â†’ å‡ºç°é—®é¢˜ â†’ æ‰§è¡Œè¡¥å¿ â†’ æ¢å¤åŸçŠ¶ âœ…

è¡¥å¿å¤±è´¥åœºæ™¯ï¼š
æ“ä½œæ‰§è¡Œ â†’ å‡ºç°é—®é¢˜ â†’ æ‰§è¡Œè¡¥å¿ â†’ è¡¥å¿ä¹Ÿå¤±è´¥ âŒ
```

> âš ï¸ **ä¸¥é‡æ€§**ï¼šè¡¥å¿å¤±è´¥æ„å‘³ç€ç³»ç»ŸçŠ¶æ€æ— æ³•è‡ªåŠ¨æ¢å¤ï¼Œéœ€è¦äººå·¥å¹²é¢„

### 5.2 è¡¥å¿å¤±è´¥çš„å¸¸è§åŸå› 


**ğŸ” åŸå› åˆ†æ**ï¼š

| å¤±è´¥åŸå›  | å…·ä½“åœºæ™¯ | è§£å†³æ€è·¯ |
|---------|----------|----------|
| **ç½‘ç»œæ•…éšœ** | `è°ƒç”¨è¡¥å¿æœåŠ¡è¶…æ—¶` | é‡è¯•æœºåˆ¶ |
| **èµ„æºä¸è¶³** | `æ•°æ®åº“è¿æ¥æ± æ»¡äº†` | èµ„æºéš”ç¦» |
| **æ•°æ®å†²çª** | `è¡¥å¿æ—¶æ•°æ®å·²è¢«ä¿®æ”¹` | ç‰ˆæœ¬æ§åˆ¶ |
| **ä¸šåŠ¡å¼‚å¸¸** | `è¡¥å¿é€»è¾‘æœ¬èº«æœ‰bug` | å®Œå–„æµ‹è¯• |

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
ç”µå•†é€€æ¬¾åœºæ™¯ï¼š
1. ç”¨æˆ·ç”³è¯·é€€æ¬¾
2. ç³»ç»Ÿæ‰§è¡Œé€€æ¬¾è¡¥å¿
3. é“¶è¡Œæ¥å£è°ƒç”¨å¤±è´¥ âŒ
4. è®¢å•çŠ¶æ€ï¼šå·²é€€æ¬¾
5. å®é™…çŠ¶æ€ï¼šé’±æ²¡åˆ°è´¦

ç»“æœï¼šæ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦äººå·¥å¤„ç†
```

### 5.3 è¡¥å¿å¤±è´¥è§£å†³æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šè¡¥å¿é‡è¯•æœºåˆ¶**
```java
@Component
public class CompensationService {
    
    private static final int MAX_RETRY_TIMES = 5;
    
    @Async
    public void executeCompensation(CompensationTask task) {
        int retryCount = 0;
        
        while (retryCount < MAX_RETRY_TIMES) {
            try {
                // æ‰§è¡Œè¡¥å¿é€»è¾‘
                doCompensation(task);
                // è¡¥å¿æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
                updateCompensationStatus(task.getId(), "SUCCESS");
                return;
            } catch (Exception e) {
                retryCount++;
                log.warn("è¡¥å¿å¤±è´¥ï¼Œç¬¬{}æ¬¡é‡è¯•: {}", retryCount, e.getMessage());
                
                if (retryCount >= MAX_RETRY_TIMES) {
                    // è¡¥å¿æœ€ç»ˆå¤±è´¥ï¼Œè®°å½•å¼‚å¸¸
                    handleCompensationFailure(task, e);
                } else {
                    // ç­‰å¾…åé‡è¯•ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
                    sleepBeforeRetry(retryCount);
                }
            }
        }
    }
    
    private void handleCompensationFailure(CompensationTask task, Exception e) {
        // æ›´æ–°è¡¥å¿çŠ¶æ€ä¸ºå¤±è´¥
        updateCompensationStatus(task.getId(), "FAILED");
        
        // å‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendCompensationFailureAlert(task, e);
        
        // è®°å½•åˆ°äººå·¥å¤„ç†é˜Ÿåˆ—
        manualProcessingQueue.add(task);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šè¡¥å¿é™çº§ç­–ç•¥**
```java
@Service
public class OrderCompensationService {
    
    public void compensateOrder(OrderCompensationRequest request) {
        try {
            // ä¸»è¡¥å¿é€»è¾‘ï¼šç›´æ¥é€€æ¬¾åˆ°åŸæ”¯ä»˜æ–¹å¼
            refundToOriginalPayment(request);
        } catch (RefundException e) {
            try {
                // é™çº§è¡¥å¿ï¼šé€€æ¬¾åˆ°ç”¨æˆ·ä½™é¢
                refundToBalance(request);
            } catch (BalanceException e2) {
                // æœ€ç»ˆé™çº§ï¼šåˆ›å»ºé€€æ¬¾å·¥å•ï¼Œäººå·¥å¤„ç†
                createRefundTicket(request, e2);
            }
        }
    }
    
    private void createRefundTicket(OrderCompensationRequest request, Exception e) {
        RefundTicket ticket = new RefundTicket();
        ticket.setOrderId(request.getOrderId());
        ticket.setUserId(request.getUserId());
        ticket.setAmount(request.getAmount());
        ticket.setFailureReason(e.getMessage());
        ticket.setStatus("PENDING_MANUAL_PROCESS");
        ticket.setPriority("HIGH");
        
        ticketRepository.save(ticket);
        
        // å‘é€é€šçŸ¥ç»™è¿è¥äººå‘˜
        notificationService.notifyManualProcessing(ticket);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šåˆ†æ®µè¡¥å¿ç­–ç•¥**
```java
@Service
public class InventoryCompensationService {
    
    public void compensateInventoryReduction(String orderId, List<OrderItem> items) {
        for (OrderItem item : items) {
            try {
                // å•ä¸ªå•†å“è¡¥å¿
                compensateSingleItem(orderId, item);
            } catch (Exception e) {
                log.error("å•†å“{}è¡¥å¿å¤±è´¥: {}", item.getProductId(), e.getMessage());
                
                // å•ä¸ªå•†å“è¡¥å¿å¤±è´¥ï¼Œè®°å½•åˆ°è¡¥å¿å¤±è´¥è¡¨
                recordCompensationFailure(orderId, item, e);
                
                // ç»§ç»­å¤„ç†å…¶ä»–å•†å“ï¼Œä¸å½±å“æ•´ä½“è¡¥å¿
                continue;
            }
        }
    }
    
    private void compensateSingleItem(String orderId, OrderItem item) {
        // æ¢å¤åº“å­˜
        inventoryService.restoreInventory(item.getProductId(), item.getQuantity());
        
        // è®°å½•è¡¥å¿æ—¥å¿—
        compensationLogService.recordSuccess(orderId, item.getProductId());
    }
}
```

---

## 6. â†©ï¸ äº‹åŠ¡å›æ»šå¤±è´¥


### 6.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡å›æ»šå¤±è´¥


**é€šä¿—è§£é‡Š**ï¼šäº‹åŠ¡å›æ»šå¤±è´¥å°±åƒ"åæ‚”è¯å¤±æ•ˆäº†"ï¼Œæƒ³è¦æ’¤é”€ä¹‹å‰çš„æ“ä½œï¼Œä½†æ’¤é”€è¿‡ç¨‹æœ¬èº«å‡ºé—®é¢˜äº†ã€‚

```
æ­£å¸¸äº‹åŠ¡å›æ»šï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ‰§è¡Œæ“ä½œ â†’ å‡ºé”™ â†’ å›æ»š â†’ æ¢å¤åˆ°åˆå§‹çŠ¶æ€ âœ…

å›æ»šå¤±è´¥ï¼š
å¼€å§‹äº‹åŠ¡ â†’ æ‰§è¡Œæ“ä½œ â†’ å‡ºé”™ â†’ å›æ»šå¤±è´¥ â†’ æ•°æ®å¤„äºä¸­é—´çŠ¶æ€ âŒ
```

> ğŸ’¥ **å±é™©æ€§**ï¼šå›æ»šå¤±è´¥æ¯”ä¸šåŠ¡å¤±è´¥æ›´ä¸¥é‡ï¼Œå› ä¸ºç³»ç»Ÿæ— æ³•è‡ªåŠ¨æ¢å¤

### 6.2 å›æ»šå¤±è´¥çš„å¸¸è§åœºæ™¯


**ğŸ” å…¸å‹åœºæ™¯åˆ†æ**ï¼š

```
åœºæ™¯ä¸€ï¼šæ•°æ®åº“è¿æ¥æ–­å¼€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¼€å§‹äº‹åŠ¡          â”‚
â”‚ 2. æ‰§è¡ŒAæ“ä½œ âœ…      â”‚ 
â”‚ 3. æ‰§è¡ŒBæ“ä½œ âŒ      â”‚
â”‚ 4. å‡†å¤‡å›æ»š          â”‚
â”‚ 5. æ•°æ®åº“è¿æ¥æ–­å¼€     â”‚
â”‚ 6. å›æ»šå¤±è´¥ âŒ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœï¼šAæ“ä½œå·²æäº¤ï¼ŒBæ“ä½œæœªæ‰§è¡Œï¼Œæ•°æ®ä¸ä¸€è‡´
```

**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š
```java
@Transactional
public void transferMoney(String fromAccount, String toAccount, BigDecimal amount) {
    try {
        // 1. æ‰£æ¬¾
        accountService.deduct(fromAccount, amount); // âœ… æˆåŠŸ
        
        // 2. åŠ æ¬¾  
        accountService.add(toAccount, amount); // âŒ å¤±è´¥
        
    } catch (Exception e) {
        // è¿™é‡Œåº”è¯¥è‡ªåŠ¨å›æ»šï¼Œä½†å¦‚æœå›æ»šå¤±è´¥...
        // fromAccountçš„é’±å·²ç»æ‰£äº†ï¼Œä½†toAccountæ²¡æ”¶åˆ°
        throw e; // ğŸ’¥ æ•°æ®ä¸ä¸€è‡´
    }
}
```

### 6.3 å›æ»šå¤±è´¥è§£å†³æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šäº‹åŠ¡çŠ¶æ€ç›‘æ§**
```java
@Component
public class TransactionMonitor {
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    public void executeWithMonitoring(Runnable business) {
        TransactionStatus status = null;
        try {
            status = transactionTemplate.getTransactionManager()
                                      .getTransaction(new DefaultTransactionDefinition());
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            business.run();
            
            // æäº¤äº‹åŠ¡
            transactionTemplate.getTransactionManager().commit(status);
            
        } catch (Exception e) {
            if (status != null && !status.isCompleted()) {
                try {
                    // å°è¯•å›æ»š
                    transactionTemplate.getTransactionManager().rollback(status);
                } catch (Exception rollbackException) {
                    // å›æ»šå¤±è´¥ï¼Œè®°å½•ä¸¥é‡é”™è¯¯
                    handleRollbackFailure(status, e, rollbackException);
                    throw new SystemException("äº‹åŠ¡å›æ»šå¤±è´¥ï¼Œç³»ç»ŸçŠ¶æ€å¼‚å¸¸", rollbackException);
                }
            }
            throw e;
        }
    }
    
    private void handleRollbackFailure(TransactionStatus status, 
                                     Exception originalEx, 
                                     Exception rollbackEx) {
        // è®°å½•äº‹åŠ¡çŠ¶æ€
        TransactionFailureRecord record = new TransactionFailureRecord();
        record.setTransactionId(status.toString());
        record.setOriginalException(originalEx.getMessage());
        record.setRollbackException(rollbackEx.getMessage());
        record.setTimestamp(new Date());
        record.setStatus("ROLLBACK_FAILED");
        
        // ä¿å­˜åˆ°ä¸“é—¨çš„æ•…éšœè¡¨
        failureRecordRepository.save(record);
        
        // å‘é€ç´§æ€¥å‘Šè­¦
        alertService.sendCriticalAlert("äº‹åŠ¡å›æ»šå¤±è´¥", record);
        
        // è§¦å‘äººå·¥å¹²é¢„æµç¨‹
        manualInterventionService.triggerIntervention(record);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šé¢„æ£€æŸ¥æœºåˆ¶**
```java
@Service
public class SafeTransactionService {
    
    public void safeTransfer(TransferRequest request) {
        // é¢„æ£€æŸ¥ï¼šéªŒè¯æ‰€æœ‰æ¡ä»¶
        validateTransferConditions(request);
        
        // é¢„åˆ†é…èµ„æº
        TransactionResource resource = allocateTransactionResource();
        
        try {
            executeTransferWithResource(request, resource);
        } catch (Exception e) {
            // ä½¿ç”¨é¢„åˆ†é…çš„èµ„æºè¿›è¡Œå®‰å…¨å›æ»š
            safeRollbackWithResource(resource, e);
            throw e;
        } finally {
            // é‡Šæ”¾èµ„æº
            releaseTransactionResource(resource);
        }
    }
    
    private void validateTransferConditions(TransferRequest request) {
        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
        if (!accountExists(request.getFromAccount())) {
            throw new BusinessException("æºè´¦æˆ·ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
        if (!hasEnoughBalance(request.getFromAccount(), request.getAmount())) {
            throw new BusinessException("ä½™é¢ä¸è¶³");
        }
        
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        if (!isDatabaseHealthy()) {
            throw new SystemException("æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œæ‹’ç»æ‰§è¡Œäº‹åŠ¡");
        }
    }
}
```

**ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šåˆ†é˜¶æ®µæäº¤**
```java
@Service
public class PhaseCommitService {
    
    public void executeBusinessWithPhaseCommit(BusinessRequest request) {
        String transactionId = UUID.randomUUID().toString();
        
        try {
            // é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
            preparePhase(transactionId, request);
            
            // é˜¶æ®µ2ï¼šæ‰§è¡Œé˜¶æ®µ
            executePhase(transactionId, request);
            
            // é˜¶æ®µ3ï¼šç¡®è®¤é˜¶æ®µ
            confirmPhase(transactionId);
            
        } catch (Exception e) {
            // åˆ†é˜¶æ®µå›æ»š
            rollbackByPhase(transactionId, e);
            throw e;
        }
    }
    
    private void rollbackByPhase(String transactionId, Exception originalException) {
        PhaseRecord record = getPhaseRecord(transactionId);
        
        try {
            switch (record.getCurrentPhase()) {
                case CONFIRMED:
                    rollbackConfirmPhase(transactionId);
                    // ç»§ç»­å›æ»šæ‰§è¡Œé˜¶æ®µ
                case EXECUTED:
                    rollbackExecutePhase(transactionId);
                    // ç»§ç»­å›æ»šå‡†å¤‡é˜¶æ®µ  
                case PREPARED:
                    rollbackPreparePhase(transactionId);
                    break;
                default:
                    // åˆå§‹çŠ¶æ€ï¼Œæ— éœ€å›æ»š
                    break;
            }
        } catch (Exception rollbackException) {
            // åˆ†é˜¶æ®µå›æ»šä¹Ÿå¤±è´¥ï¼Œè®°å½•è¯¦ç»†ä¿¡æ¯
            recordPhaseRollbackFailure(transactionId, record.getCurrentPhase(), 
                                     originalException, rollbackException);
        }
    }
}
```

---

## 7. ğŸ‘» è„è¯»é—®é¢˜


### 7.1 ä»€ä¹ˆæ˜¯è„è¯»


**é€šä¿—è§£é‡Š**ï¼šè„è¯»å°±æ˜¯"è¯»åˆ°äº†ä¸åº”è¯¥è¯»åˆ°çš„æ•°æ®"ï¼Œå°±åƒå·çœ‹äº†åˆ«äººè¿˜æ²¡å†™å®Œçš„æ—¥è®°ã€‚

```
è„è¯»åœºæ™¯ï¼š
äº‹åŠ¡A: å¼€å§‹ â†’ ä¿®æ”¹æ•°æ®X=100 â†’ (æœªæäº¤)
äº‹åŠ¡B: è¯»å–æ•°æ®X=100 â†’ åŸºäºX=100åšå†³ç­–
äº‹åŠ¡A: å›æ»š â†’ æ•°æ®Xæ¢å¤ä¸ºåŸå€¼50
ç»“æœ: äº‹åŠ¡BåŸºäºé”™è¯¯æ•°æ®åšäº†å†³ç­–
```

> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šå°±åƒçœ‹åˆ°æœ‹å‹åœ¨ATMæœºä¸Šè¾“å…¥å¯†ç ï¼Œä½†ä»–è¾“é”™äº†åˆé‡æ–°è¾“å…¥ï¼Œä½ è®°ä½çš„æ˜¯é”™è¯¯çš„å¯†ç 

### 7.2 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„è„è¯»é—®é¢˜


**æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸åŒæœåŠ¡çš„æ•°æ®çŠ¶æ€å¯èƒ½ä¸åŒæ­¥

**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š
```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @GlobalTransactional // Seataå…¨å±€äº‹åŠ¡
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order(request);
        orderRepository.save(order); // æœ¬åœ°äº‹åŠ¡å·²æäº¤
        
        // 2. æ‰£å‡åº“å­˜
        inventoryService.reduceStock(request.getProductId(), request.getQuantity());
        // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œè®¢å•å·²ç»åˆ›å»ºï¼Œä½†åº“å­˜æœåŠ¡è¿˜æ²¡æ‰£å‡
        
        // 3. æ‰£æ¬¾
        paymentService.deductBalance(request.getUserId(), request.getAmount());
    }
}

// é—®é¢˜ï¼šå…¶ä»–æœåŠ¡å¯èƒ½è¯»åˆ°"å·²åˆ›å»ºä½†æœªæ‰£åº“å­˜"çš„ä¸­é—´çŠ¶æ€
```

### 7.3 è„è¯»é—®é¢˜è§£å†³æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šè¯»å†™åˆ†ç¦» + æœ€ç»ˆä¸€è‡´æ€§**
```java
@Service
public class OrderQueryService {
    
    // å†™æ“ä½œï¼šå†™å…¥ä¸»åº“
    public void createOrder(Order order) {
        masterDataSource.save(order);
        
        // å¼‚æ­¥åŒæ­¥åˆ°ä»åº“
        asyncSyncToSlave(order);
    }
    
    // è¯»æ“ä½œï¼šä»ä»åº“è¯»å–
    @ReadOnly
    public Order getOrder(String orderId) {
        // ä»ä»åº“è¯»å–ï¼Œé¿å…è¯»åˆ°æœªæäº¤çš„æ•°æ®
        return slaveDataSource.findById(orderId);
    }
    
    // å¼ºä¸€è‡´æ€§è¯»å–ï¼šå¿…è¦æ—¶ä»ä¸»åº“è¯»
    public Order getOrderConsistently(String orderId) {
        return masterDataSource.findById(orderId);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šçŠ¶æ€æ ‡è®°æœºåˆ¶**
```java
public enum OrderStatus {
    CREATING,    // åˆ›å»ºä¸­ï¼ˆä¸­é—´çŠ¶æ€ï¼‰
    CREATED,     // å·²åˆ›å»ºï¼ˆæœ€ç»ˆçŠ¶æ€ï¼‰
    CANCELLED    // å·²å–æ¶ˆ
}

@Service
public class OrderService {
    
    @GlobalTransactional
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»º"åˆ›å»ºä¸­"çŠ¶æ€çš„è®¢å•
        Order order = new Order(request);
        order.setStatus(OrderStatus.CREATING); // æ ‡è®°ä¸ºä¸­é—´çŠ¶æ€
        orderRepository.save(order);
        
        try {
            // 2. æ‰§è¡Œå…¶ä»–æ“ä½œ
            inventoryService.reduceStock(request.getProductId(), request.getQuantity());
            paymentService.deductBalance(request.getUserId(), request.getAmount());
            
            // 3. æ‰€æœ‰æ“ä½œæˆåŠŸï¼Œæ›´æ–°ä¸ºæœ€ç»ˆçŠ¶æ€
            order.setStatus(OrderStatus.CREATED);
            orderRepository.save(order);
            
        } catch (Exception e) {
            // å¤±è´¥æ—¶æ ‡è®°ä¸ºå–æ¶ˆçŠ¶æ€
            order.setStatus(OrderStatus.CANCELLED);
            orderRepository.save(order);
            throw e;
        }
    }
    
    // æŸ¥è¯¢æ—¶è¿‡æ»¤ä¸­é—´çŠ¶æ€
    public List<Order> getUserOrders(String userId) {
        return orderRepository.findByUserIdAndStatusNot(userId, OrderStatus.CREATING);
    }
}
```

**ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šç‰ˆæœ¬æ§åˆ¶æœºåˆ¶**
```java
@Entity
public class Account {
    private String id;
    private BigDecimal balance;
    private Long version; // ç‰ˆæœ¬å·
    private String transactionId; // å½“å‰äº‹åŠ¡ID
    
    // getters and setters
}

@Service
public class AccountService {
    
    public void updateBalance(String accountId, BigDecimal amount, String txId) {
        Account account = accountRepository.findById(accountId);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–äº‹åŠ¡åœ¨ä¿®æ”¹
        if (account.getTransactionId() != null && 
            !account.getTransactionId().equals(txId)) {
            throw new ConcurrentModificationException("è´¦æˆ·æ­£åœ¨è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹");
        }
        
        // é”å®šè´¦æˆ·åˆ°å½“å‰äº‹åŠ¡
        account.setTransactionId(txId);
        account.setBalance(account.getBalance().add(amount));
        account.setVersion(account.getVersion() + 1);
        
        try {
            accountRepository.save(account);
        } catch (OptimisticLockException e) {
            throw new ConcurrentModificationException("è´¦æˆ·æ•°æ®å·²è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹", e);
        }
    }
    
    // è¯»å–æ—¶æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
    public Account getAccount(String accountId) {
        Account account = accountRepository.findById(accountId);
        
        // å¦‚æœè´¦æˆ·è¢«äº‹åŠ¡é”å®šï¼Œè¿”å›é”å®šå‰çš„ç‰ˆæœ¬æˆ–æŠ›å‡ºå¼‚å¸¸
        if (account.getTransactionId() != null) {
            if (isTransactionActive(account.getTransactionId())) {
                throw new DataNotAvailableException("è´¦æˆ·æ•°æ®æ­£åœ¨äº‹åŠ¡å¤„ç†ä¸­");
            } else {
                // äº‹åŠ¡å·²å®Œæˆä½†æœªæ¸…ç†ï¼Œæ¸…ç†æ ‡è®°
                account.setTransactionId(null);
                accountRepository.save(account);
            }
        }
        
        return account;
    }
}
```

---

## 8. ğŸ’§ èµ„æºæ³„éœ²é˜²æŠ¤


### 8.1 ä»€ä¹ˆæ˜¯èµ„æºæ³„éœ²


**é€šä¿—è§£é‡Š**ï¼šèµ„æºæ³„éœ²å°±åƒ"å€Ÿäº†ä¸œè¥¿ä¸è¿˜"ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¸­ç”³è¯·çš„èµ„æºï¼ˆè¿æ¥ã€é”ã€å†…å­˜ç­‰ï¼‰æ²¡æœ‰æ­£ç¡®é‡Šæ”¾ã€‚

```
æ­£å¸¸èµ„æºä½¿ç”¨ï¼š
ç”³è¯·èµ„æº â†’ ä½¿ç”¨èµ„æº â†’ é‡Šæ”¾èµ„æº âœ…

èµ„æºæ³„éœ²ï¼š
ç”³è¯·èµ„æº â†’ ä½¿ç”¨èµ„æº â†’ ç¨‹åºå¼‚å¸¸ â†’ èµ„æºæœªé‡Šæ”¾ âŒ

ç»“æœï¼šèµ„æºè¶Šæ¥è¶Šå°‘ï¼Œæœ€ç»ˆè€—å°½
```

> âš ï¸ **ä¸¥é‡åæœ**ï¼šèµ„æºæ³„éœ²ä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´æœåŠ¡ä¸å¯ç”¨

### 8.2 åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„èµ„æºæ³„éœ²åœºæ™¯


**ğŸ” å¸¸è§æ³„éœ²åœºæ™¯**ï¼š

| èµ„æºç±»å‹ | æ³„éœ²åœºæ™¯ | å½±å“ |
|---------|---------|------|
| **æ•°æ®åº“è¿æ¥** | `äº‹åŠ¡è¶…æ—¶æœªæäº¤` | è¿æ¥æ± è€—å°½ |
| **åˆ†å¸ƒå¼é”** | `è·é”åè¿›ç¨‹crash` | æ­»é” |
| **æ¶ˆæ¯é˜Ÿåˆ—** | `æ¶ˆæ¯æœªç¡®è®¤` | æ¶ˆæ¯å †ç§¯ |
| **å†…å­˜å¯¹è±¡** | `å¤§å¯¹è±¡æœªæ¸…ç†` | å†…å­˜æº¢å‡º |

**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```java
// å±é™©çš„ä»£ç ç¤ºä¾‹
public void processOrder(OrderRequest request) {
    Connection conn = dataSource.getConnection(); // è·å–è¿æ¥
    String lockKey = "order:" + request.getOrderId();
    
    try {
        // è·å–åˆ†å¸ƒå¼é”
        distributedLock.lock(lockKey);
        
        // å¼€å§‹äº‹åŠ¡
        conn.setAutoCommit(false);
        
        // ä¸šåŠ¡å¤„ç†
        processOrderBusiness(request, conn);
        
        // å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸...
        if (someCondition) {
            throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
        }
        
        conn.commit();
        
    } catch (Exception e) {
        conn.rollback();
        throw e;
    }
    // âŒ é—®é¢˜ï¼šconnå’Œlockéƒ½æ²¡æœ‰åœ¨finallyä¸­é‡Šæ”¾ï¼
}
```

### 8.3 èµ„æºæ³„éœ²é˜²æŠ¤æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šèµ„æºç®¡ç†æ¨¡æ¿**
```java
@Component
public class ResourceManager {
    
    // èµ„æºç®¡ç†æ¨¡æ¿
    public <T> T executeWithResource(ResourceCallback<T> callback) {
        TransactionResource resource = null;
        try {
            // ç”³è¯·èµ„æº
            resource = allocateResource();
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            return callback.doInTransaction(resource);
            
        } catch (Exception e) {
            // å¼‚å¸¸å¤„ç†
            handleException(resource, e);
            throw e;
        } finally {
            // ç¡®ä¿èµ„æºé‡Šæ”¾
            safeReleaseResource(resource);
        }
    }
    
    private void safeReleaseResource(TransactionResource resource) {
        if (resource != null) {
            try {
                // é‡Šæ”¾æ•°æ®åº“è¿æ¥
                if (resource.getConnection() != null && !resource.getConnection().isClosed()) {
                    resource.getConnection().close();
                }
                
                // é‡Šæ”¾åˆ†å¸ƒå¼é”
                if (resource.getLockKey() != null) {
                    distributedLock.unlock(resource.getLockKey());
                }
                
                // æ¸…ç†å…¶ä»–èµ„æº
                resource.cleanup();
                
            } catch (Exception e) {
                log.error("èµ„æºé‡Šæ”¾å¤±è´¥: {}", e.getMessage(), e);
                // è®°å½•èµ„æºæ³„éœ²
                recordResourceLeak(resource, e);
            }
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class OrderService {
    
    @Autowired
    private ResourceManager resourceManager;
    
    public void createOrder(OrderRequest request) {
        resourceManager.executeWithResource(resource -> {
            // åœ¨èµ„æºä¿æŠ¤ä¸‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doCreateOrder(request, resource);
            return null;
        });
    }
}
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šè¶…æ—¶è‡ªåŠ¨æ¸…ç†**
```java
@Component
public class ResourceTimeoutManager {
    
    private final Map<String, ResourceInfo> activeResources = new ConcurrentHashMap<>();
    private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(2);
    
    @PostConstruct
    public void startCleanupTask() {
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶èµ„æº
        scheduler.scheduleWithFixedDelay(this::cleanupTimeoutResources, 30, 30, TimeUnit.SECONDS);
    }
    
    public String allocateResourceWithTimeout(String resourceType, long timeoutMillis) {
        String resourceId = UUID.randomUUID().toString();
        
        ResourceInfo info = new ResourceInfo();
        info.setResourceId(resourceId);
        info.setResourceType(resourceType);
        info.setAllocateTime(System.currentTimeMillis());
        info.setTimeoutMillis(timeoutMillis);
        
        activeResources.put(resourceId, info);
        
        // è®¾ç½®è¶…æ—¶æ¸…ç†ä»»åŠ¡
        scheduler.schedule(() -> forceReleaseResource(resourceId), timeoutMillis, TimeUnit.MILLISECONDS);
        
        return resourceId;
    }
    
    private void cleanupTimeoutResources() {
        long currentTime = System.currentTimeMillis();
        
        activeResources.entrySet().removeIf(entry -> {
            ResourceInfo info = entry.getValue();
            if (currentTime - info.getAllocateTime() > info.getTimeoutMillis()) {
                log.warn("æ£€æµ‹åˆ°è¶…æ—¶èµ„æºï¼Œå¼ºåˆ¶é‡Šæ”¾: {}", info.getResourceId());
                forceReleaseResource(info.getResourceId());
                return true;
            }
            return false;
        });
    }
    
    private void forceReleaseResource(String resourceId) {
        ResourceInfo info = activeResources.remove(resourceId);
        if (info != null) {
            try {
                // å¼ºåˆ¶é‡Šæ”¾å„ç§èµ„æº
                releaseByResourceType(info);
            } catch (Exception e) {
                log.error("å¼ºåˆ¶é‡Šæ”¾èµ„æºå¤±è´¥: {}", e.getMessage());
            }
        }
    }
}
```

**ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šèµ„æºç›‘æ§å‘Šè­¦**
```java
@Component
public class ResourceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter resourceLeakCounter;
    private final Gauge activeConnectionsGauge;
    
    public ResourceMonitor(MeterRegistry meterRegistry, DataSource dataSource) {
        this.meterRegistry = meterRegistry;
        this.resourceLeakCounter = Counter.builder("resource.leak")
                                        .description("èµ„æºæ³„éœ²è®¡æ•°")
                                        .register(meterRegistry);
        
        this.activeConnectionsGauge = Gauge.builder("db.connections.active")
                                          .description("æ´»è·ƒæ•°æ®åº“è¿æ¥æ•°")
                                          .register(meterRegistry, dataSource, this::getActiveConnections);
    }
    
    @EventListener
    public void handleResourceLeak(ResourceLeakEvent event) {
        // è®°å½•æ³„éœ²æŒ‡æ ‡
        resourceLeakCounter.increment(Tags.of(
            "resource.type", event.getResourceType(),
            "leak.reason", event.getReason()
        ));
        
        // å‘é€å‘Šè­¦
        if (resourceLeakCounter.count() > 10) { // æ³„éœ²è¶…è¿‡10æ¬¡
            alertService.sendResourceLeakAlert(
                "èµ„æºæ³„éœ²ä¸¥é‡", 
                String.format("èµ„æºç±»å‹: %s, æ³„éœ²æ¬¡æ•°: %.0f", 
                            event.getResourceType(), 
                            resourceLeakCounter.count())
            );
        }
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkResourceHealth() {
        double activeConnections = getActiveConnections(dataSource);
        
        // è¿æ¥æ•°è¿‡é«˜å‘Šè­¦
        if (activeConnections > MAX_SAFE_CONNECTIONS * 0.8) {
            alertService.sendAlert(
                "æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜", 
                String.format("å½“å‰è¿æ¥æ•°: %.0f, å®‰å…¨é˜ˆå€¼: %d", 
                            activeConnections, 
                            (int)(MAX_SAFE_CONNECTIONS * 0.8))
            );
        }
    }
    
    private double getActiveConnections(DataSource dataSource) {
        if (dataSource instanceof HikariDataSource) {
            HikariDataSource hikariDS = (HikariDataSource) dataSource;
            return hikariDS.getHikariPoolMXBean().getActiveConnections();
        }
        return 0;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç½‘ç»œæŠ–åŠ¨ï¼šåˆ†å¸ƒå¼ç¯å¢ƒçš„å¸¸æ€ï¼Œéœ€è¦å®¹é”™æœºåˆ¶
ğŸ”¸ è¶…æ—¶é‡è¯•ï¼šä¸´æ—¶æ•…éšœçš„åº”å¯¹ç­–ç•¥ï¼Œä½†éœ€è¦é…åˆå¹‚ç­‰æ€§
ğŸ”¸ å¹‚ç­‰æ€§è®¾è®¡ï¼šé‡è¯•å®‰å…¨çš„åŸºç¡€ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
ğŸ”¸ é˜²æ‚¬æŒ‚ï¼šTCCæ¨¡å¼ç‰¹æœ‰é—®é¢˜ï¼Œé€šè¿‡çŠ¶æ€è®°å½•è§£å†³
ğŸ”¸ è¡¥å¿å¤±è´¥ï¼šè¡¥å¿æœºåˆ¶æœ¬èº«çš„å®¹é”™ï¼Œéœ€è¦é™çº§å’Œå‘Šè­¦
ğŸ”¸ å›æ»šå¤±è´¥ï¼šæ¯”ä¸šåŠ¡å¤±è´¥æ›´ä¸¥é‡ï¼Œéœ€è¦ç›‘æ§å’Œäººå·¥å¹²é¢„
ğŸ”¸ è„è¯»é—®é¢˜ï¼šä¸­é—´çŠ¶æ€çš„å¯è§æ€§é—®é¢˜ï¼Œéœ€è¦çŠ¶æ€éš”ç¦»
ğŸ”¸ èµ„æºæ³„éœ²ï¼šç³»ç»Ÿç¨³å®šæ€§æ€æ‰‹ï¼Œéœ€è¦ä¸»åŠ¨é˜²æŠ¤
```

### 9.2 é—®é¢˜è§£å†³æ€è·¯æ€»ç»“


**ğŸ”¹ é¢„é˜²èƒœäºæ²»ç–—**ï¼š
```
è®¾è®¡é˜¶æ®µè€ƒè™‘å¼‚å¸¸æƒ…å†µï¼š
- ç½‘ç»œä¼šæ–­å¼€ï¼ŒæœåŠ¡ä¼šå®•æœº
- æ•°æ®åº“ä¼šè¶…æ—¶ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±
- ç”¨æˆ·ä¼šé‡å¤ç‚¹å‡»ï¼Œç³»ç»Ÿä¼šå¹¶å‘å†²çª

é˜²æŠ¤æœºåˆ¶ï¼š
- å¹‚ç­‰æ€§è®¾è®¡
- è¶…æ—¶é…ç½®
- é‡è¯•ç­–ç•¥
- èµ„æºç®¡ç†
```

**ğŸ”¹ ç›‘æ§ä¸å‘Šè­¦**ï¼š
```
å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š
- äº‹åŠ¡æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- èµ„æºä½¿ç”¨æƒ…å†µ
- é”™è¯¯é¢‘ç‡

å‘Šè­¦ç­–ç•¥ï¼š
- å®æ—¶å‘Šè­¦ï¼šä¸¥é‡æ•…éšœç«‹å³é€šçŸ¥
- è¶‹åŠ¿å‘Šè­¦ï¼šæŒ‡æ ‡å¼‚å¸¸è¶‹åŠ¿é¢„è­¦
- æ‰¹é‡å‘Šè­¦ï¼šé¿å…å‘Šè­¦é£æš´
```

**ğŸ”¹ é™çº§ä¸å…œåº•**ï¼š
```
å¤šå±‚é™çº§ç­–ç•¥ï¼š
1. ä¸»é€»è¾‘å¤±è´¥ â†’ é‡è¯•
2. é‡è¯•å¤±è´¥ â†’ è¡¥å¿
3. è¡¥å¿å¤±è´¥ â†’ é™çº§å¤„ç†
4. é™çº§å¤±è´¥ â†’ äººå·¥å¤„ç†

å…œåº•æœºåˆ¶ï¼š
- æœ€ç»ˆä¸€è‡´æ€§ä¿è¯
- äººå·¥å¹²é¢„æµç¨‹
- æ•°æ®ä¿®å¤å·¥å…·
```

### 9.3 å®è·µå»ºè®®


**ğŸ’¡ å¼€å‘é˜¶æ®µ**ï¼š
- **ä»£ç å®¡æŸ¥**ï¼šé‡ç‚¹å…³æ³¨èµ„æºé‡Šæ”¾å’Œå¼‚å¸¸å¤„ç†
- **å•å…ƒæµ‹è¯•**ï¼šè¦†ç›–å„ç§å¼‚å¸¸åœºæ™¯
- **é›†æˆæµ‹è¯•**ï¼šæ¨¡æ‹Ÿç½‘ç»œæ•…éšœå’Œè¶…æ—¶

**ğŸ”§ è¿ç»´é˜¶æ®µ**ï¼š
- **ç›‘æ§å¤§ç›˜**ï¼šå®æ—¶å±•ç¤ºç³»ç»Ÿå¥åº·çŠ¶å†µ
- **å‘Šè­¦é…ç½®**ï¼šåˆç†è®¾ç½®å‘Šè­¦é˜ˆå€¼
- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šæ•…éšœå¤„ç†æµç¨‹

**ğŸ“Š ä¼˜åŒ–é˜¶æ®µ**ï¼š
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–å‚æ•°
- **å®¹é‡è§„åˆ’**ï¼šé¢„ä¼°èµ„æºéœ€æ±‚
- **æ¶æ„æ¼”è¿›**ï¼šé€æ­¥æ”¹è¿›ç³»ç»Ÿè®¾è®¡

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜æœ¬è´¨æ˜¯"ä¸ç¡®å®šæ€§"ç®¡ç†
- é¢„é˜²æ¯”æ²»ç–—æ›´é‡è¦ï¼Œç›‘æ§æ¯”çŒœæµ‹æ›´å¯é 
- è‡ªåŠ¨åŒ–å¤„ç†ä¸ºä¸»ï¼Œäººå·¥å¹²é¢„ä¸ºè¾…
- æœ€ç»ˆä¸€è‡´æ€§èƒœè¿‡å¼ºä¸€è‡´æ€§çš„å¤æ‚åº¦