---
title: 6ã€ç§’æ€ç³»ç»Ÿåº“å­˜ä¸€è‡´æ€§ä¿è¯
---
## ğŸ“š ç›®å½•

1. [ç§’æ€ç³»ç»ŸæŒ‘æˆ˜ä¸èƒŒæ™¯](#1-ç§’æ€ç³»ç»ŸæŒ‘æˆ˜ä¸èƒŒæ™¯)
2. [é«˜å¹¶å‘åœºæ™¯æ ¸å¿ƒé—®é¢˜](#2-é«˜å¹¶å‘åœºæ™¯æ ¸å¿ƒé—®é¢˜)
3. [åˆ†å¸ƒå¼é”é…åˆç­–ç•¥](#3-åˆ†å¸ƒå¼é”é…åˆç­–ç•¥)
4. [å¼‚æ­¥å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆ](#4-å¼‚æ­¥å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆ)
5. [æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡](#5-æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡)
6. [é™æµé™çº§ç­–ç•¥](#6-é™æµé™çº§ç­–ç•¥)
7. [ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ](#7-ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ)
8. [ç»¼åˆæ¶æ„å®æˆ˜](#8-ç»¼åˆæ¶æ„å®æˆ˜)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç§’æ€ç³»ç»ŸæŒ‘æˆ˜ä¸èƒŒæ™¯


### 1.1 ä»€ä¹ˆæ˜¯ç§’æ€ç³»ç»Ÿ


**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸‹åŒ11æŠ¢è´­åœºæ™¯ï¼Œæˆåƒä¸Šä¸‡äººåŒæ—¶æŠ¢è´­ä¸€ä¸ªåªæœ‰100ä»¶åº“å­˜çš„å•†å“ã€‚

```
æ™®é€šè´­ç‰©ï¼š              ç§’æ€åœºæ™¯ï¼š
  ç”¨æˆ·1 â†’ å•†å“A(åº“å­˜å……è¶³)    ç”¨æˆ·1ã€2ã€3...10000 â†’ å•†å“A(åº“å­˜100)
  è´­ä¹°æˆåŠŸ                  åªæœ‰100äººèƒ½æˆåŠŸï¼Œå…¶ä»–äººéƒ½ä¼šå¤±è´¥
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **é«˜å¹¶å‘**ï¼šç¬é—´å¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®
- **åº“å­˜æœ‰é™**ï¼šå•†å“æ•°é‡è¿œå°‘äºç”¨æˆ·æ•°é‡  
- **æ—¶é—´é›†ä¸­**ï¼šåœ¨å›ºå®šæ—¶é—´ç‚¹å¼€å§‹æŠ¢è´­
- **è¦æ±‚å‡†ç¡®**ï¼šä¸èƒ½è¶…å–ï¼Œä¹Ÿä¸èƒ½å°‘å–

### 1.2 ç§’æ€ç³»ç»Ÿé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ”¥ å¹¶å‘å†²çªé—®é¢˜**
```
åœºæ™¯è¯´æ˜ï¼š
æ—¶é—´ç‚¹ 10:00:00.001ç§’
- ç”¨æˆ·Aæ£€æŸ¥åº“å­˜ï¼š100ä»¶ âœ“ å¯ä»¥è´­ä¹°
- ç”¨æˆ·Bæ£€æŸ¥åº“å­˜ï¼š100ä»¶ âœ“ å¯ä»¥è´­ä¹°  
- ç”¨æˆ·Cæ£€æŸ¥åº“å­˜ï¼š100ä»¶ âœ“ å¯ä»¥è´­ä¹°
...åŒæ—¶1000ä¸ªç”¨æˆ·éƒ½çœ‹åˆ°åº“å­˜100ä»¶

ç»“æœï¼šå¯èƒ½å–å‡º1000ä»¶å•†å“ï¼Œä½†å®é™…åªæœ‰100ä»¶åº“å­˜ï¼
```

**âš¡ ç³»ç»Ÿæ€§èƒ½å‹åŠ›**
- **æ•°æ®åº“å‹åŠ›**ï¼šå¤§é‡è¯»å†™è¯·æ±‚ç¬é—´æ¶Œå…¥
- **ç¼“å­˜å‡»ç©¿**ï¼šçƒ­ç‚¹æ•°æ®ç¼“å­˜å¤±æ•ˆ
- **ç½‘ç»œå¸¦å®½**ï¼šå¤§é‡è¯·æ±‚å æ»¡ç½‘ç»œèµ„æº
- **æœåŠ¡å™¨è´Ÿè½½**ï¼šCPUã€å†…å­˜ä½¿ç”¨ç‡é£™å‡

**ğŸ¯ ä¸šåŠ¡å‡†ç¡®æ€§è¦æ±‚**
- **ä¸èƒ½è¶…å–**ï¼šå–å‡ºçš„æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜
- **ä¸èƒ½å°‘å–**ï¼šæœ‰åº“å­˜å°±ä¸èƒ½æ‹’ç»æ­£å¸¸è®¢å•
- **æ•°æ®ä¸€è‡´**ï¼šå„ä¸ªç³»ç»Ÿé—´æ•°æ®è¦ä¿æŒåŒæ­¥

### 1.3 ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆçš„å±€é™


**å•æœºé”æ–¹æ¡ˆ**ï¼š
```java
// ä¼ ç»Ÿå•æœºè§£å†³æ–¹æ¡ˆ
public synchronized boolean buyProduct(Long productId) {
    // æ£€æŸ¥åº“å­˜
    int stock = getStock(productId);
    if (stock > 0) {
        // å‡åº“å­˜
        updateStock(productId, stock - 1);
        // åˆ›å»ºè®¢å•
        createOrder(productId);
        return true;
    }
    return false;
}
```

**âŒ é—®é¢˜**ï¼š
- åªèƒ½è§£å†³å•ä¸ªæœåŠ¡å™¨çš„å¹¶å‘é—®é¢˜
- å¾®æœåŠ¡æ¶æ„ä¸‹æœ‰å¤šå°æœåŠ¡å™¨ï¼Œå•æœºé”æ— æ•ˆ
- æ€§èƒ½ç“¶é¢ˆï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä¸²è¡Œå¤„ç†

---

## 2. âš¡ é«˜å¹¶å‘åœºæ™¯æ ¸å¿ƒé—®é¢˜


### 2.1 è¶…å–é—®é¢˜æ·±åº¦è§£æ


**ä»€ä¹ˆæ˜¯è¶…å–**ï¼š
> ğŸ’¡ **è¶…å–å®šä¹‰**ï¼šç³»ç»Ÿå–å‡ºçš„å•†å“æ•°é‡è¶…è¿‡äº†å®é™…åº“å­˜æ•°é‡
> 
> æ¯”å¦‚ï¼šåº“å­˜åªæœ‰100ä»¶iPhoneï¼Œä½†æ˜¯ç³»ç»Ÿå´å–å‡ºäº†150ä»¶

**è¶…å–äº§ç”ŸåŸå› **ï¼š

```
å¹¶å‘è®¿é—®æ—¶åºå›¾ï¼š

æ—¶åˆ»T1ï¼š  ç”¨æˆ·A    ç”¨æˆ·B    ç”¨æˆ·C    æ•°æ®åº“åº“å­˜
         |        |        |         100
         |        |        |          |
æ—¶åˆ»T2ï¼š  |--æŸ¥è¯¢åº“å­˜100----|----------|
         |        |--æŸ¥è¯¢åº“å­˜100-----|
         |        |        |--æŸ¥è¯¢åº“å­˜100
         |        |        |          |
æ—¶åˆ»T3ï¼š  |--å‡åº“å­˜åˆ°99-----|----------|  
         |        |--å‡åº“å­˜åˆ°98-----|   â† åŸºäºæ—§æ•°æ®
         |        |        |--å‡åº“å­˜åˆ°97 â† åŸºäºæ—§æ•°æ®
         |        |        |          |
ç»“æœï¼š    æˆåŠŸ     æˆåŠŸ     æˆåŠŸ      97(å®é™…å–äº†3ä»¶)
```

**ğŸ”¸ æ ¹æœ¬åŸå› **ï¼š
- **è¯»å†™åˆ†ç¦»**ï¼šæŸ¥è¯¢å’Œæ›´æ–°ä¸æ˜¯åŸå­æ“ä½œ
- **å¹¶å‘ç«äº‰**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è¯»å–ç›¸åŒæ•°æ®
- **çŠ¶æ€ä¸ä¸€è‡´**ï¼šå†³ç­–åŸºäºè¿‡æœŸçš„åº“å­˜ä¿¡æ¯

### 2.2 æ•°æ®åº“å±‚é¢çš„æŒ‘æˆ˜


**ğŸ”¸ æ•°æ®åº“é”æœºåˆ¶**

**è¡Œé”ç¤ºä¾‹**ï¼š
```sql
-- æ‚²è§‚é”æ–¹å¼
SELECT stock FROM product WHERE id = 1001 FOR UPDATE;
-- åœ¨äº‹åŠ¡ç»“æŸå‰ï¼Œå…¶ä»–è¯·æ±‚å¿…é¡»ç­‰å¾…

UPDATE product SET stock = stock - 1 WHERE id = 1001;
COMMIT;
```

**é—®é¢˜åˆ†æ**ï¼š
- **æ€§èƒ½ä½**ï¼šæ‰€æœ‰è¯·æ±‚ä¸²è¡Œæ‰§è¡Œ
- **æ­»é”é£é™©**ï¼šå¤šä¸ªèµ„æºäº¤å‰é”å®š
- **è¿æ¥å ç”¨**ï¼šé•¿æ—¶é—´å ç”¨æ•°æ®åº“è¿æ¥

### 2.3 ç¼“å­˜ä¸€è‡´æ€§æŒ‘æˆ˜


**ç¼“å­˜ä½¿ç”¨åœºæ™¯**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥ç¼“å­˜(åº“å­˜:100) â†’ æœ‰åº“å­˜ â†’ è´­ä¹°æˆåŠŸ â†’ æ›´æ–°æ•°æ®åº“

é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·A: æŸ¥ç¼“å­˜(åº“å­˜:100) â†’ è´­ä¹° â†’ æ›´æ–°DB(åº“å­˜:99) â†’ æ›´æ–°ç¼“å­˜
ç”¨æˆ·B: æŸ¥ç¼“å­˜(åº“å­˜:100) â† ç¼“å­˜è¿˜æ²¡æ›´æ–°ï¼ â†’ è´­ä¹° â†’ è¶…å–ï¼
```

**ğŸ”¸ ç¼“å­˜æ›´æ–°æ—¶æœºé—®é¢˜**ï¼š
- **å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜**ï¼šä¸­é—´æœ‰æ—¶å·®ï¼Œå¯èƒ½è¯»åˆ°æ—§æ•°æ®
- **å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“**ï¼šæ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œç¼“å­˜æ˜¯é”™è¯¯çš„
- **åŒå†™ä¸€è‡´æ€§**ï¼šå¦‚ä½•ä¿è¯ä¸¤ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥

### 2.4 å¾®æœåŠ¡åˆ†å¸ƒå¼é—®é¢˜


**æœåŠ¡é—´è°ƒç”¨å¤æ‚æ€§**ï¼š

```
ç§’æ€ä¸šåŠ¡è°ƒç”¨é“¾ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ â†’ ç§’æ€æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡
           â†“         â†“         â†“         â†“         â†“
        é™æµæ£€æŸ¥   æ‰£å‡åº“å­˜   åˆ›å»ºè®¢å•   æ‰£å‡ä½™é¢   æ›´æ–°çŠ¶æ€

ä»»ä½•ä¸€ä¸ªç¯èŠ‚å¤±è´¥éƒ½å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼
```

**ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡éš¾é¢˜**ï¼š
- **æœåŠ¡A**æ‰£å‡äº†åº“å­˜ï¼Œ**æœåŠ¡B**åˆ›å»ºè®¢å•å¤±è´¥ â†’ åº“å­˜è¢«æ‰£ä½†æ²¡æœ‰è®¢å•
- **æœåŠ¡C**æ‰£å‡äº†ä½™é¢ï¼Œ**æœåŠ¡D**æ›´æ–°çŠ¶æ€å¤±è´¥ â†’ é’±è¢«æ‰£ä½†è®¢å•æœªå®Œæˆ
- ç½‘ç»œå»¶è¿Ÿã€æœåŠ¡å®•æœºéƒ½å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

---

## 3. ğŸ”’ åˆ†å¸ƒå¼é”é…åˆç­–ç•¥


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**å•æœºé” vs åˆ†å¸ƒå¼é”å¯¹æ¯”**ï¼š

```
å•æœºç¯å¢ƒï¼š                    åˆ†å¸ƒå¼ç¯å¢ƒï¼š
     
    åº”ç”¨æœåŠ¡                    åº”ç”¨æœåŠ¡A    åº”ç”¨æœåŠ¡B    åº”ç”¨æœåŠ¡C
       |                           |           |           |
   synchronized                synchronized synchronized synchronized
       |                           |           |           |
    æ•°æ®åº“å­˜å‚¨                      å…±äº«æ•°æ®åº“å­˜å‚¨

å•æœºé”åªèƒ½é”ä½ä¸€ä¸ªæœåŠ¡å®ä¾‹      åˆ†å¸ƒå¼é”éœ€è¦è·¨æœåŠ¡å®ä¾‹åè°ƒ
```

**ğŸ¯ åˆ†å¸ƒå¼é”ä½œç”¨**ï¼š
- **äº’æ–¥è®¿é—®**ï¼šç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæœåŠ¡å®ä¾‹èƒ½æ“ä½œåº“å­˜
- **é¿å…è¶…å–**ï¼šä¸²è¡ŒåŒ–åº“å­˜æ‰£å‡æ“ä½œ
- **ä¿è¯ä¸€è‡´æ€§**ï¼šç¡®ä¿å¹¶å‘æ“ä½œçš„åŸå­æ€§

### 3.2 Redisåˆ†å¸ƒå¼é”å®ç°


**ğŸ”¸ åŸºç¡€Redisé”æœºåˆ¶**

```java
@Service
public class RedisDistributedLock {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     * @param key é”çš„å”¯ä¸€æ ‡è¯†
     * @param value é”çš„å€¼ï¼ˆé€šå¸¸ç”¨UUIDï¼‰
     * @param expireTime è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     */
    public boolean tryLock(String key, String value, long expireTime) {
        // ä½¿ç”¨SETå‘½ä»¤ï¼ŒNXè¡¨ç¤ºä¸å­˜åœ¨æ‰è®¾ç½®ï¼ŒEXè¡¨ç¤ºè®¾ç½®è¿‡æœŸæ—¶é—´
        String result = redisTemplate.opsForValue().setIfAbsent(key, value, 
                                     Duration.ofSeconds(expireTime)) ? "OK" : null;
        return "OK".equals(result);
    }
    
    /**
     * é‡Šæ”¾é” - ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
     */
    public boolean releaseLock(String key, String value) {
        String luaScript = 
            "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('DEL', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class), 
            Collections.singletonList(key), 
            value
        );
        return result != null && result == 1;
    }
}
```

### 3.3 ç§’æ€åœºæ™¯é”è®¾è®¡


**ğŸ”¸ é”ç²’åº¦è®¾è®¡**

```java
@Service
public class SecKillService {
    
    @Autowired
    private RedisDistributedLock distributedLock;
    
    /**
     * å•†å“çº§åˆ«é” - ç²—ç²’åº¦
     * ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»å¯¹ä¸ä¼šè¶…å–
     * ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œæ‰€æœ‰ç”¨æˆ·ä¸²è¡Œæ‰§è¡Œ
     */
    public boolean secKillWithProductLock(Long productId, Long userId) {
        String lockKey = "seckill:product:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            if (distributedLock.tryLock(lockKey, lockValue, 10)) {
                return doSecKill(productId, userId);
            }
            return false; // è·å–é”å¤±è´¥
        } finally {
            distributedLock.releaseLock(lockKey, lockValue);
        }
    }
    
    /**
     * åº“å­˜åˆ†ç‰‡é” - ç»†ç²’åº¦
     * å°†åº“å­˜åˆ†æˆå¤šä¸ªç‰‡æ®µï¼Œå‡å°‘é”ç«äº‰
     */
    public boolean secKillWithShardLock(Long productId, Long userId) {
        // æ ¹æ®ç”¨æˆ·IDè¿›è¡Œåˆ†ç‰‡ï¼Œå‡å°‘é”å†²çª
        int shardCount = 10; // åˆ†æˆ10ä¸ªç‰‡æ®µ
        int shardIndex = (int)(userId % shardCount);
        String lockKey = "seckill:product:" + productId + ":shard:" + shardIndex;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            if (distributedLock.tryLock(lockKey, lockValue, 10)) {
                return doSecKillWithShard(productId, userId, shardIndex);
            }
            return false;
        } finally {
            distributedLock.releaseLock(lockKey, lockValue);
        }
    }
}
```

**ğŸ”¸ é”ä¼˜åŒ–ç­–ç•¥**

| ç­–ç•¥ç±»å‹ | **å®ç°æ–¹å¼** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|---------|-------------|
| ğŸ”’ **å•†å“çº§é”** | `é”æ•´ä¸ªå•†å“` | `ç»å¯¹å‡†ç¡®ï¼Œä¸ä¼šè¶…å–` | `æ€§èƒ½å¾ˆå·®ï¼Œç”¨æˆ·ä½“éªŒå·®` | `åº“å­˜æå°‘çš„å•†å“` |
| ğŸ¯ **åˆ†ç‰‡é”** | `åº“å­˜åˆ†ç‰‡åŠ é”` | `æ€§èƒ½è¾ƒå¥½ï¼Œå‡å°‘ç«äº‰` | `å®ç°å¤æ‚ï¼Œå¯èƒ½è¶…å–` | `å¤§éƒ¨åˆ†ç§’æ€åœºæ™¯` |
| â° **æ—¶é—´åˆ†ç‰‡** | `æŒ‰æ—¶é—´æ®µåŠ é”` | `å‰Šå³°å¡«è°·ï¼Œå¹³æ»‘å¤„ç†` | `ç”¨æˆ·éœ€è¦ç­‰å¾…` | `éå³æ—¶ç§’æ€` |

### 3.4 é”çš„æ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ é”è¶…æ—¶å¤„ç†**

```java
public class OptimizedSecKillService {
    
    private static final int LOCK_EXPIRE_TIME = 10; // 10ç§’è¶…æ—¶
    private static final int MAX_RETRY_TIMES = 3;   // æœ€å¤šé‡è¯•3æ¬¡
    
    public boolean secKillWithRetry(Long productId, Long userId) {
        String lockKey = "seckill:product:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        // é‡è¯•æœºåˆ¶
        for (int i = 0; i < MAX_RETRY_TIMES; i++) {
            try {
                if (distributedLock.tryLock(lockKey, lockValue, LOCK_EXPIRE_TIME)) {
                    return doSecKill(productId, userId);
                }
                
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾…éšæœºæ—¶é—´åé‡è¯•
                Thread.sleep(50 + new Random().nextInt(100));
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            } finally {
                distributedLock.releaseLock(lockKey, lockValue);
            }
        }
        
        return false; // é‡è¯•åä»ç„¶å¤±è´¥
    }
}
```

**ğŸ”¸ é”é™çº§ç­–ç•¥**

```java
/**
 * å½“Redisä¸å¯ç”¨æ—¶çš„é™çº§æ–¹æ¡ˆ
 */
@Component
public class LockFallbackHandler {
    
    public boolean secKillWithFallback(Long productId, Long userId) {
        try {
            // ä¼˜å…ˆä½¿ç”¨Redisåˆ†å¸ƒå¼é”
            return secKillWithRedisLock(productId, userId);
            
        } catch (RedisConnectionException e) {
            // Redisä¸å¯ç”¨æ—¶ï¼Œé™çº§åˆ°æ•°æ®åº“é”
            log.warn("Redisä¸å¯ç”¨ï¼Œé™çº§åˆ°æ•°æ®åº“é”", e);
            return secKillWithDatabaseLock(productId, userId);
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸ï¼Œç›´æ¥æ‹’ç»
            log.error("ç§’æ€å¤„ç†å¼‚å¸¸", e);
            return false;
        }
    }
    
    private boolean secKillWithDatabaseLock(Long productId, Long userId) {
        // ä½¿ç”¨æ•°æ®åº“æ‚²è§‚é”
        return secKillMapper.updateStockWithLock(productId, userId) > 0;
    }
}
```

---

## 4. ğŸš€ å¼‚æ­¥å¤„ç†ä¼˜åŒ–æ–¹æ¡ˆ


### 4.1 å¼‚æ­¥å¤„ç†çš„å¿…è¦æ€§


**åŒæ­¥å¤„ç†é—®é¢˜**ï¼š

```
åŒæ­¥ç§’æ€æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ éªŒè¯ç”¨æˆ· â†’ æ£€æŸ¥åº“å­˜ â†’ æ‰£å‡åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ æ‰£å‡ä½™é¢ â†’ è¿”å›ç»“æœ
  100ms     50ms      100ms     100ms     200ms     150ms     æ€»è®¡:700ms

é—®é¢˜ï¼šç”¨æˆ·éœ€è¦ç­‰å¾…700msæ‰èƒ½çœ‹åˆ°ç»“æœï¼Œä½“éªŒå¾ˆå·®ï¼
```

**å¼‚æ­¥å¤„ç†ä¼˜åŠ¿**ï¼š

```
å¼‚æ­¥ç§’æ€æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å¿«é€Ÿæ ¡éªŒ â†’ æ”¾å…¥é˜Ÿåˆ— â†’ ç«‹å³è¿”å›"æ­£åœ¨å¤„ç†"
  100ms     10ms      5ms       æ€»è®¡:115ms ç«‹å³å“åº”ï¼

åå°å¼‚æ­¥ï¼šé˜Ÿåˆ—æ¶ˆè´¹ â†’ çœŸæ­£çš„ç§’æ€é€»è¾‘ â†’ ç»“æœé€šçŸ¥
```

**ğŸ¯ å¼‚æ­¥åŒ–æ”¶ç›Š**ï¼š
- **å“åº”é€Ÿåº¦å¿«**ï¼šç”¨æˆ·ç«‹å³å¾—åˆ°å“åº”
- **ç³»ç»Ÿååé‡é«˜**ï¼šå¯ä»¥å¤„ç†æ›´å¤šå¹¶å‘è¯·æ±‚
- **å‰Šå³°å¡«è°·**ï¼šå¹³æ»‘å¤„ç†çªå‘æµé‡
- **ç”¨æˆ·ä½“éªŒå¥½**ï¼šä¸ç”¨é•¿æ—¶é—´ç­‰å¾…

### 4.2 æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥ç§’æ€


**ğŸ”¸ RabbitMQå®ç°æ–¹æ¡ˆ**

```java
@Configuration
public class SecKillQueueConfig {
    
    // ç§’æ€è¯·æ±‚é˜Ÿåˆ—
    public static final String SECKILL_QUEUE = "seckill.request.queue";
    // ç§’æ€ç»“æœé˜Ÿåˆ—  
    public static final String SECKILL_RESULT_QUEUE = "seckill.result.queue";
    
    @Bean
    public Queue secKillQueue() {
        return QueueBuilder.durable(SECKILL_QUEUE)
                .withArgument("x-max-length", 10000) // é˜Ÿåˆ—æœ€å¤§é•¿åº¦
                .withArgument("x-message-ttl", 60000) // æ¶ˆæ¯TTL 60ç§’
                .build();
    }
    
    @Bean
    public Queue secKillResultQueue() {
        return QueueBuilder.durable(SECKILL_RESULT_QUEUE).build();
    }
}
```

**ğŸ”¸ å¼‚æ­¥ç§’æ€æœåŠ¡**

```java
@Service
public class AsyncSecKillService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * æ¥æ”¶ç”¨æˆ·ç§’æ€è¯·æ±‚
     */
    public SecKillResponse submitSecKillRequest(SecKillRequest request) {
        try {
            // 1. åŸºç¡€æ ¡éªŒ
            if (!validateBasicRequest(request)) {
                return SecKillResponse.fail("è¯·æ±‚å‚æ•°æ— æ•ˆ");
            }
            
            // 2. å¿«é€Ÿæ£€æŸ¥åº“å­˜ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼Œä½†é¿å…æ˜æ˜¾æ— æ„ä¹‰çš„è¯·æ±‚ï¼‰
            if (getApproximateStock(request.getProductId()) <= 0) {
                return SecKillResponse.fail("å•†å“å·²å”®ç½„");
            }
            
            // 3. ç”Ÿæˆè¯·æ±‚IDï¼Œç”¨äºåç»­æŸ¥è¯¢ç»“æœ
            String requestId = generateRequestId(request);
            request.setRequestId(requestId);
            
            // 4. å‘é€åˆ°å¼‚æ­¥é˜Ÿåˆ—
            rabbitTemplate.convertAndSend(SECKILL_QUEUE, request);
            
            // 5. ç«‹å³è¿”å›å¤„ç†ä¸­çŠ¶æ€
            return SecKillResponse.processing(requestId, "è¯·æ±‚å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...");
            
        } catch (Exception e) {
            log.error("æäº¤ç§’æ€è¯·æ±‚å¤±è´¥", e);
            return SecKillResponse.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

### 4.3 é˜Ÿåˆ—æ¶ˆè´¹å’Œå¤„ç†


**ğŸ”¸ ç§’æ€è¯·æ±‚æ¶ˆè´¹è€…**

```java
@RabbitListener(queues = SECKILL_QUEUE)
@Service
public class SecKillRequestConsumer {
    
    @Autowired
    private SecKillService secKillService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ¶ˆè´¹ç§’æ€è¯·æ±‚
     */
    @RabbitHandler
    public void handleSecKillRequest(SecKillRequest request) {
        String requestId = request.getRequestId();
        
        try {
            // 1. æ‰§è¡ŒçœŸæ­£çš„ç§’æ€é€»è¾‘
            boolean success = secKillService.processSecKill(request);
            
            // 2. æ„å»ºç»“æœ
            SecKillResult result = new SecKillResult();
            result.setRequestId(requestId);
            result.setSuccess(success);
            result.setMessage(success ? "ç§’æ€æˆåŠŸï¼" : "å•†å“å·²å”®ç½„");
            result.setProcessTime(System.currentTimeMillis());
            
            // 3. å°†ç»“æœå­˜å…¥Redisï¼Œä¾›ç”¨æˆ·æŸ¥è¯¢
            String resultKey = "seckill:result:" + requestId;
            redisTemplate.opsForValue().set(resultKey, result, Duration.ofMinutes(10));
            
            // 4. å¯é€‰ï¼šé€šè¿‡WebSocketå®æ—¶é€šçŸ¥ç”¨æˆ·
            notifyUserResult(request.getUserId(), result);
            
        } catch (Exception e) {
            log.error("å¤„ç†ç§’æ€è¯·æ±‚å¤±è´¥: {}", requestId, e);
            // å¤„ç†å¤±è´¥ä¹Ÿè¦è®°å½•ç»“æœ
            SecKillResult errorResult = SecKillResult.error(requestId, "ç³»ç»Ÿå¼‚å¸¸");
            redisTemplate.opsForValue().set("seckill:result:" + requestId, 
                                           errorResult, Duration.ofMinutes(10));
        }
    }
}
```

**ğŸ”¸ ç»“æœæŸ¥è¯¢æ¥å£**

```java
@RestController
public class SecKillQueryController {
    
    @GetMapping("/seckill/result/{requestId}")
    public SecKillResult queryResult(@PathVariable String requestId) {
        String resultKey = "seckill:result:" + requestId;
        SecKillResult result = (SecKillResult) redisTemplate.opsForValue().get(resultKey);
        
        if (result == null) {
            // å¯èƒ½è¿˜åœ¨å¤„ç†ä¸­ï¼Œæˆ–è€…è¯·æ±‚IDæ— æ•ˆ
            return SecKillResult.processing(requestId, "æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢");
        }
        
        return result;
    }
}
```

### 4.4 å¼‚æ­¥å¤„ç†çš„ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ é˜Ÿåˆ—ç›‘æ§å’Œæµæ§**

```java
@Component
public class SecKillQueueMonitor {
    
    @Autowired
    private RabbitAdmin rabbitAdmin;
    
    /**
     * ç›‘æ§é˜Ÿåˆ—é•¿åº¦ï¼Œè¿›è¡Œæµé‡æ§åˆ¶
     */
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorQueueLength() {
        Properties properties = rabbitAdmin.getQueueProperties(SECKILL_QUEUE);
        if (properties != null) {
            Integer messageCount = (Integer) properties.get("QUEUE_MESSAGE_COUNT");
            
            if (messageCount != null && messageCount > 5000) {
                // é˜Ÿåˆ—ç§¯å‹å¤ªå¤šï¼Œå¼€å¯é™æµ
                enableRateLimit();
                log.warn("é˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼Œå½“å‰æ¶ˆæ¯æ•°: {}", messageCount);
                
            } else if (messageCount != null && messageCount < 1000) {
                // é˜Ÿåˆ—æ­£å¸¸ï¼Œå¯ä»¥å…³é—­é™æµ
                disableRateLimit();
            }
        }
    }
    
    private void enableRateLimit() {
        // é€šè¿‡Redisè®¾ç½®é™æµæ ‡å¿—
        redisTemplate.opsForValue().set("seckill:rate:limit", true, Duration.ofMinutes(5));
    }
    
    private void disableRateLimit() {
        redisTemplate.delete("seckill:rate:limit");
    }
}
```

---

## 5. âš–ï¸ æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡


### 5.1 æœ€ç»ˆä¸€è‡´æ€§çš„å«ä¹‰


**ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§**ï¼š
> ğŸ’¡ **æœ€ç»ˆä¸€è‡´æ€§å®šä¹‰**ï¼šç³»ç»Ÿåœ¨ä¸€æ®µæ—¶é—´å†…æ•°æ®å¯èƒ½ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
> 
> å°±åƒé“¶è¡Œè½¬è´¦ï¼šè½¬å‡ºæ–¹ç«‹å³æ‰£æ¬¾ï¼Œè½¬å…¥æ–¹å¯èƒ½å‡ åˆ†é’Ÿåæ‰æ”¶åˆ°ï¼Œä½†æœ€ç»ˆä¸¤è¾¹è´¦ç›®æ˜¯å¹³è¡¡çš„

**ä¸ºä»€ä¹ˆéœ€è¦æœ€ç»ˆä¸€è‡´æ€§**ï¼š

```
å¼ºä¸€è‡´æ€§è¦æ±‚ï¼š              æœ€ç»ˆä¸€è‡´æ€§å…è®¸ï¼š
æ‰€æœ‰æ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸ          éƒ¨åˆ†æ“ä½œå¯ä»¥å»¶è¿ŸæˆåŠŸ
  |                          |
åº“å­˜æ‰£å‡ â† å¿…é¡»åŒæ—¶ â†’ è®¢å•åˆ›å»º    åº“å­˜æ‰£å‡ â†’ ç«‹å³æ‰§è¡Œ
è®¢å•åˆ›å»º â† å¿…é¡»åŒæ—¶ â†’ æ”¯ä»˜æ‰£è´¹    è®¢å•åˆ›å»º â†’ ç¨åå¼‚æ­¥æ‰§è¡Œ  
æ”¯ä»˜æ‰£è´¹ â† å¿…é¡»åŒæ—¶ â†’ çŠ¶æ€æ›´æ–°    æ”¯ä»˜æ‰£è´¹ â†’ ç¨åå¼‚æ­¥æ‰§è¡Œ

é—®é¢˜ï¼šä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½å›æ»š        å¥½å¤„ï¼šæ€§èƒ½é«˜ï¼Œç”¨æˆ·ä½“éªŒå¥½
     æ€§èƒ½å·®ï¼Œç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿          åå¤„ï¼šä¸­é—´çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´
```

### 5.2 åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§


**ğŸ”¸ Sagaæ¨¡å¼å®ç°**

Sagaæ¨¡å¼æ˜¯ä¸€ç§ç®¡ç†é•¿äº‹åŠ¡çš„æ–¹æ³•ï¼Œå°†å¤§äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°çš„æœ¬åœ°äº‹åŠ¡ã€‚

```java
@Service
public class SecKillSagaService {
    
    /**
     * ç§’æ€ä¸šåŠ¡çš„Sagaæµç¨‹
     */
    public void executeSecKillSaga(SecKillRequest request) {
        SagaManager sagaManager = new SagaManager();
        
        sagaManager
            // æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜
            .step("decreaseStock")
            .localTransaction(() -> stockService.decreaseStock(request))
            .compensationTransaction(() -> stockService.increaseStock(request))
            
            // æ­¥éª¤2ï¼šåˆ›å»ºè®¢å•  
            .step("createOrder")
            .localTransaction(() -> orderService.createOrder(request))
            .compensationTransaction(() -> orderService.cancelOrder(request))
            
            // æ­¥éª¤3ï¼šæ‰£å‡ä½™é¢
            .step("deductBalance")
            .localTransaction(() -> paymentService.deductBalance(request))
            .compensationTransaction(() -> paymentService.refundBalance(request))
            
            // æ­¥éª¤4ï¼šå‘é€é€šçŸ¥
            .step("sendNotification")
            .localTransaction(() -> notificationService.sendSuccessNotify(request))
            .compensationTransaction(() -> notificationService.sendFailNotify(request))
            
            // æ‰§è¡ŒSagaæµç¨‹
            .execute();
    }
}
```

**ğŸ”¸ æ¶ˆæ¯é©±åŠ¨çš„ä¸€è‡´æ€§ä¿è¯**

```java
@Service
public class EventDrivenConsistency {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    /**
     * åº“å­˜æ‰£å‡æˆåŠŸåå‘å¸ƒäº‹ä»¶
     */
    @Transactional
    public boolean decreaseStock(Long productId, Integer quantity) {
        // 1. æ‰£å‡åº“å­˜ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        boolean success = stockMapper.decreaseStock(productId, quantity);
        
        if (success) {
            // 2. å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            StockDecreasedEvent event = new StockDecreasedEvent();
            event.setProductId(productId);
            event.setQuantity(quantity);
            event.setTimestamp(System.currentTimeMillis());
            
            eventPublisher.publishEvent(event);
        }
        
        return success;
    }
    
    /**
     * ç›‘å¬åº“å­˜æ‰£å‡äº‹ä»¶ï¼Œåˆ›å»ºè®¢å•
     */
    @EventListener
    @Async
    public void handleStockDecreased(StockDecreasedEvent event) {
        try {
            // å¼‚æ­¥åˆ›å»ºè®¢å•
            orderService.createOrderAsync(event.getProductId(), event.getQuantity());
            
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè§¦å‘åº“å­˜è¡¥å¿", e);
            // å‘å¸ƒè¡¥å¿äº‹ä»¶
            StockCompensationEvent compensation = new StockCompensationEvent();
            compensation.setProductId(event.getProductId());
            compensation.setQuantity(event.getQuantity());
            eventPublisher.publishEvent(compensation);
        }
    }
}
```

### 5.3 åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼šSeata


**ğŸ”¸ Seata ATæ¨¡å¼**

Seataæ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼ŒATæ¨¡å¼å¯ä»¥å®ç°å¯¹ä¸šåŠ¡ä»£ç æ— ä¾µå…¥çš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

```java
@Service
public class SeataSecKillService {
    
    @Autowired
    private StockService stockService;
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private PaymentService paymentService;
    
    /**
     * ä½¿ç”¨Seataå…¨å±€äº‹åŠ¡
     */
    @GlobalTransactional(rollbackFor = Exception.class)
    public boolean secKillWithSeata(SecKillRequest request) {
        try {
            // 1. æ‰£å‡åº“å­˜ - æœ¬åœ°äº‹åŠ¡
            boolean stockResult = stockService.decreaseStock(
                request.getProductId(), 1);
            if (!stockResult) {
                throw new BusinessException("åº“å­˜ä¸è¶³");
            }
            
            // 2. åˆ›å»ºè®¢å• - å¯èƒ½æ˜¯è¿œç¨‹è°ƒç”¨
            Long orderId = orderService.createOrder(
                request.getUserId(), request.getProductId());
            if (orderId == null) {
                throw new BusinessException("åˆ›å»ºè®¢å•å¤±è´¥");
            }
            
            // 3. æ‰£å‡ä½™é¢ - å¯èƒ½æ˜¯è¿œç¨‹è°ƒç”¨
            boolean payResult = paymentService.deductBalance(
                request.getUserId(), request.getAmount());
            if (!payResult) {
                throw new BusinessException("ä½™é¢ä¸è¶³");
            }
            
            return true;
            
        } catch (Exception e) {
            log.error("ç§’æ€äº‹åŠ¡å¤±è´¥", e);
            // Seataä¼šè‡ªåŠ¨å›æ»šæ‰€æœ‰å‚ä¸çš„æœ¬åœ°äº‹åŠ¡
            throw e;
        }
    }
}
```

### 5.4 å¹‚ç­‰æ€§ä¿è¯


**ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§**ï¼š
åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç”±äºç½‘ç»œé—®é¢˜ï¼ŒåŒä¸€ä¸ªè¯·æ±‚å¯èƒ½è¢«æ‰§è¡Œå¤šæ¬¡ã€‚

```java
@Service
public class IdempotentSecKillService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * å¹‚ç­‰æ€§æ£€æŸ¥
     */
    public boolean secKillWithIdempotent(SecKillRequest request) {
        String idempotentKey = "seckill:idempotent:" + 
                              request.getUserId() + ":" + request.getProductId();
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        if (redisTemplate.hasKey(idempotentKey)) {
            log.info("é‡å¤è¯·æ±‚ï¼Œç›´æ¥è¿”å›æˆåŠŸ: {}", idempotentKey);
            return true; // å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ
        }
        
        // 2. è®¾ç½®å¤„ç†æ ‡è®°ï¼ˆ24å°æ—¶è¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(idempotentKey, "processing", 
                                       Duration.ofHours(24));
        
        try {
            // 3. æ‰§è¡Œç§’æ€é€»è¾‘
            boolean result = doActualSecKill(request);
            
            // 4. æ›´æ–°å¤„ç†ç»“æœ
            redisTemplate.opsForValue().set(idempotentKey, 
                                          result ? "success" : "failed", 
                                          Duration.ofHours(24));
            return result;
            
        } catch (Exception e) {
            // 5. å¤„ç†å¼‚å¸¸ï¼Œç§»é™¤æ ‡è®°å…è®¸é‡è¯•
            redisTemplate.delete(idempotentKey);
            throw e;
        }
    }
}
```

---

## 6. ğŸš¦ é™æµé™çº§ç­–ç•¥


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦é™æµé™çº§


**ç³»ç»Ÿä¿æŠ¤çš„å¿…è¦æ€§**ï¼š
æƒ³è±¡é«˜é€Ÿå…¬è·¯åœ¨èŠ‚å‡æ—¥çš„æƒ…å†µï¼Œå¦‚æœä¸é™æµï¼Œæ‰€æœ‰è½¦è¾†ä¸€èµ·æ¶Œå…¥ï¼Œç»“æœå°±æ˜¯å¤§å µè½¦ï¼Œè°éƒ½èµ°ä¸äº†ã€‚

```
æ— é™æµæƒ…å†µï¼š                 é™æµåæƒ…å†µï¼š
10ä¸‡ç”¨æˆ·åŒæ—¶è®¿é—®              åªå…è®¸1ä¸‡ç”¨æˆ·åŒæ—¶è®¿é—®
    â†“                           â†“
ç³»ç»Ÿå´©æºƒï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½æ— æ³•è®¿é—®      éƒ¨åˆ†ç”¨æˆ·æ­£å¸¸ä½¿ç”¨ï¼Œå…¶ä»–ç”¨æˆ·æ’é˜Ÿç­‰å¾…
```

**ğŸ¯ é™æµé™çº§ç›®æ ‡**ï¼š
- **ä¿æŠ¤ç³»ç»Ÿ**ï¼šé¿å…ç³»ç»Ÿå› è¿‡è½½è€Œå´©æºƒ
- **ä¿è¯æœåŠ¡**ï¼šç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ
- **æå‡ä½“éªŒ**ï¼šè®©éƒ¨åˆ†ç”¨æˆ·æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å…¨éƒ¨ç”¨æˆ·éƒ½æ— æ³•ä½¿ç”¨è¦å¥½

### 6.2 å¤šå±‚é™æµç­–ç•¥


**ğŸ”¸ ç½‘å…³å±‚é™æµ**

```java
@Component
public class GatewayRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµç®—æ³•
     */
    public boolean allowRequest(String apiKey, int maxRequests, int windowSeconds) {
        String key = "rate_limit:" + apiKey;
        String luaScript = 
            "local key = KEYS[1]\n" +
            "local max_requests = tonumber(ARGV[1])\n" +
            "local window = tonumber(ARGV[2])\n" +
            "local current = redis.call('GET', key)\n" +
            "if current == false then\n" +
            "    redis.call('SET', key, 1)\n" +
            "    redis.call('EXPIRE', key, window)\n" +
            "    return 1\n" +
            "elseif tonumber(current) < max_requests then\n" +
            "    return redis.call('INCR', key)\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key),
            String.valueOf(maxRequests),
            String.valueOf(windowSeconds)
        );
        
        return result != null && result > 0;
    }
}
```

**ğŸ”¸ æœåŠ¡å±‚é™æµ**

```java
@Service
public class SecKillRateLimitService {
    
    // æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š5æ¬¡ç§’æ€è¯·æ±‚
    private final Cache<Long, Integer> userRequestCount = 
        CacheBuilder.newBuilder()
            .maximumSize(100000)
            .expireAfterWrite(1, TimeUnit.MINUTES)
            .build();
    
    /**
     * ç”¨æˆ·ç»´åº¦é™æµ
     */
    public boolean checkUserRateLimit(Long userId) {
        try {
            Integer count = userRequestCount.get(userId, () -> 0);
            if (count >= 5) {
                log.warn("ç”¨æˆ·è¯·æ±‚è¿‡äºé¢‘ç¹: {}", userId);
                return false;
            }
            
            userRequestCount.put(userId, count + 1);
            return true;
            
        } catch (Exception e) {
            log.error("é™æµæ£€æŸ¥å¼‚å¸¸", e);
            return true; // å¼‚å¸¸æ—¶ä¸é™æµï¼Œä¿è¯å¯ç”¨æ€§
        }
    }
    
    /**
     * å•†å“ç»´åº¦é™æµ
     */
    @RateLimiter(value = "seckill", fallbackMethod = "secKillFallback")
    public boolean secKillWithLimit(Long productId, Long userId) {
        return doSecKill(productId, userId);
    }
    
    /**
     * é™æµåçš„é™çº§å¤„ç†
     */
    public boolean secKillFallback(Long productId, Long userId) {
        log.info("ç§’æ€è¯·æ±‚è¢«é™æµ: productId={}, userId={}", productId, userId);
        return false;
    }
}
```

### 6.3 ç†”æ–­é™çº§æœºåˆ¶


**ğŸ”¸ Hystrixç†”æ–­å™¨**

```java
@Component
public class SecKillCircuitBreaker {
    
    /**
     * ä½¿ç”¨Hystrixå®ç°ç†”æ–­
     */
    @HystrixCommand(
        commandProperties = {
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
        },
        fallbackMethod = "secKillFallback"
    )
    public boolean secKillWithCircuitBreaker(Long productId, Long userId) {
        // çœŸæ­£çš„ç§’æ€é€»è¾‘
        return stockService.decreaseStockAndCreateOrder(productId, userId);
    }
    
    /**
     * ç†”æ–­æ—¶çš„é™çº§æ–¹æ³•
     */
    public boolean secKillFallback(Long productId, Long userId) {
        log.warn("ç§’æ€æœåŠ¡ç†”æ–­é™çº§: productId={}, userId={}", productId, userId);
        
        // å¯ä»¥è¿”å›é¢„è®¾çš„ç»“æœï¼Œæˆ–è€…ä»ç¼“å­˜è·å–
        return false;
    }
}
```

### 6.4 åŠ¨æ€é™æµç­–ç•¥


**ğŸ”¸ æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´**

```java
@Component
@Slf4j
public class DynamicRateLimitAdjuster {
    
    private volatile int currentRateLimit = 1000; // å½“å‰é™æµå€¼
    private final int maxRateLimit = 2000;        // æœ€å¤§é™æµå€¼
    private final int minRateLimit = 100;         // æœ€å°é™æµå€¼
    
    /**
     * å®šæœŸè°ƒæ•´é™æµå‚æ•°
     */
    @Scheduled(fixedRate = 30000) // æ¯30ç§’è°ƒæ•´ä¸€æ¬¡
    public void adjustRateLimit() {
        try {
            // è·å–ç³»ç»ŸæŒ‡æ ‡
            SystemMetrics metrics = getSystemMetrics();
            
            if (metrics.getCpuUsage() > 80 || metrics.getMemoryUsage() > 85) {
                // ç³»ç»Ÿè´Ÿè½½é«˜ï¼Œé™ä½é™æµå€¼
                currentRateLimit = Math.max(minRateLimit, 
                                          (int)(currentRateLimit * 0.8));
                log.info("ç³»ç»Ÿè´Ÿè½½é«˜ï¼Œé™ä½é™æµè‡³: {}", currentRateLimit);
                
            } else if (metrics.getCpuUsage() < 50 && metrics.getMemoryUsage() < 60) {
                // ç³»ç»Ÿè´Ÿè½½ä½ï¼Œé€‚å½“æé«˜é™æµå€¼
                currentRateLimit = Math.min(maxRateLimit, 
                                          (int)(currentRateLimit * 1.2));
                log.info("ç³»ç»Ÿè´Ÿè½½æ­£å¸¸ï¼Œæé«˜é™æµè‡³: {}", currentRateLimit);
            }
            
            // æ›´æ–°Redisä¸­çš„é™æµé…ç½®
            updateRateLimitConfig(currentRateLimit);
            
        } catch (Exception e) {
            log.error("åŠ¨æ€è°ƒæ•´é™æµå¤±è´¥", e);
        }
    }
    
    private SystemMetrics getSystemMetrics() {
        // è·å–CPUã€å†…å­˜ä½¿ç”¨ç‡
        double cpuUsage = ManagementFactory.getPlatformMXBean(
            com.sun.management.OperatingSystemMXBean.class).getProcessCpuLoad() * 100;
        
        Runtime runtime = Runtime.getRuntime();
        double memoryUsage = ((double)(runtime.totalMemory() - runtime.freeMemory()) 
                             / runtime.maxMemory()) * 100;
        
        return new SystemMetrics(cpuUsage, memoryUsage);
    }
}
```

---

## 7. ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ


### 7.1 ç¼“å­˜ä¸€è‡´æ€§çš„æŒ‘æˆ˜


**ç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥é—®é¢˜**ï¼š

```
ç†æƒ³æƒ…å†µï¼š                   å®é™…æƒ…å†µï¼š
æ•°æ®åº“åº“å­˜: 100              æ•°æ®åº“åº“å­˜: 100 â†’ 99 â†’ 98
ç¼“å­˜åº“å­˜:   100              ç¼“å­˜åº“å­˜:   100 â†’ 100 â†’ 99 â† å»¶è¿Ÿæ›´æ–°ï¼
                           
ç”¨æˆ·çœ‹åˆ°çš„: å‡†ç¡®çš„åº“å­˜          ç”¨æˆ·çœ‹åˆ°çš„: å¯èƒ½æ˜¯æ—§çš„åº“å­˜æ•°æ®
```

**ğŸ”¸ ä¸€è‡´æ€§é—®é¢˜çš„æ ¹æº**ï¼š
- **æ›´æ–°å»¶è¿Ÿ**ï¼šæ•°æ®åº“æ›´æ–°åï¼Œç¼“å­˜æ›´æ–°éœ€è¦æ—¶é—´
- **æ›´æ–°å¤±è´¥**ï¼šç½‘ç»œé—®é¢˜å¯¼è‡´ç¼“å­˜æ›´æ–°å¤±è´¥
- **å¹¶å‘å†²çª**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶æ›´æ–°ï¼Œé¡ºåºé”™ä¹±

### 7.2 Cache-Asideæ¨¡å¼


**ğŸ”¸ è¯»å†™åˆ†ç¦»çš„ç¼“å­˜ç­–ç•¥**

```java
@Service
public class CacheAsideStockService {
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    @Autowired
    private StockMapper stockMapper;
    
    /**
     * è¯»å–åº“å­˜ - Cache Asideè¯»æ¨¡å¼
     */
    public Integer getStock(Long productId) {
        String cacheKey = "stock:" + productId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        Integer stock = redisTemplate.opsForValue().get(cacheKey);
        if (stock != null) {
            return stock;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        stock = stockMapper.getStock(productId);
        if (stock != null) {
            // 3. å°†æ•°æ®å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, stock, Duration.ofMinutes(10));
        }
        
        return stock;
    }
    
    /**
     * æ›´æ–°åº“å­˜ - Cache Asideå†™æ¨¡å¼
     */
    @Transactional
    public boolean updateStock(Long productId, Integer newStock) {
        try {
            // 1. å…ˆæ›´æ–°æ•°æ®åº“
            boolean dbResult = stockMapper.updateStock(productId, newStock);
            if (!dbResult) {
                return false;
            }
            
            // 2. åˆ é™¤ç¼“å­˜ï¼ˆè€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼‰
            String cacheKey = "stock:" + productId;
            redisTemplate.delete(cacheKey);
            
            return true;
            
        } catch (Exception e) {
            log.error("æ›´æ–°åº“å­˜å¤±è´¥", e);
            return false;
        }
    }
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆåˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ**
- **é¿å…å¹¶å‘é—®é¢˜**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°å¯èƒ½å¯¼è‡´æ•°æ®é”™ä¹±
- **å»¶è¿ŸåŠ è½½**ï¼šä¸‹æ¬¡è¯»å–æ—¶å†åŠ è½½æœ€æ–°æ•°æ®
- **å‡å°‘æ— æ•ˆæ›´æ–°**ï¼šå¦‚æœæ•°æ®å¾ˆå°‘è¢«è¯»å–ï¼Œæ›´æ–°ç¼“å­˜æ˜¯æµªè´¹

### 7.3 åŒå†™ä¸€è‡´æ€§ä¿è¯


**ğŸ”¸ åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„æœ€ç»ˆä¸€è‡´æ€§**

```java
@Service
public class EventualConsistencyStockService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * æ›´æ–°åº“å­˜å¹¶å‘é€æ¶ˆæ¯
     */
    @Transactional
    public boolean decreaseStockWithEvent(Long productId, Integer quantity) {
        try {
            // 1. æ›´æ–°æ•°æ®åº“åº“å­˜
            boolean success = stockMapper.decreaseStock(productId, quantity);
            if (!success) {
                return false;
            }
            
            // 2. å‘é€ç¼“å­˜æ›´æ–°æ¶ˆæ¯
            StockChangeEvent event = new StockChangeEvent();
            event.setProductId(productId);
            event.setChangeType("DECREASE");
            event.setQuantity(quantity);
            event.setTimestamp(System.currentTimeMillis());
            
            rabbitTemplate.convertAndSend("stock.change.queue", event);
            
            return true;
            
        } catch (Exception e) {
            log.error("æ‰£å‡åº“å­˜å¤±è´¥", e);
            throw e; // äº‹åŠ¡å›æ»š
        }
    }
    
    /**
     * ç›‘å¬åº“å­˜å˜æ›´äº‹ä»¶ï¼Œæ›´æ–°ç¼“å­˜
     */
    @RabbitListener(queues = "stock.change.queue")
    public void handleStockChangeEvent(StockChangeEvent event) {
        try {
            String cacheKey = "stock:" + event.getProductId();
            
            if ("DECREASE".equals(event.getChangeType())) {
                // æ–¹å¼1ï¼šç›´æ¥åˆ é™¤ç¼“å­˜ï¼Œè®©ä¸‹æ¬¡è¯»å–æ—¶ä»DBåŠ è½½
                redisTemplate.delete(cacheKey);
                
                // æ–¹å¼2ï¼šä¹Ÿå¯ä»¥é€‰æ‹©æ›´æ–°ç¼“å­˜å€¼
                // Integer currentStock = redisTemplate.opsForValue().get(cacheKey);
                // if (currentStock != null) {
                //     redisTemplate.opsForValue().set(cacheKey, 
                //         currentStock - event.getQuantity());
                // }
            }
            
            log.info("ç¼“å­˜æ›´æ–°æˆåŠŸ: {}", event);
            
        } catch (Exception e) {
            log.error("æ›´æ–°ç¼“å­˜å¤±è´¥", e);
            // å¯ä»¥é‡è¯•æˆ–è€…è®°å½•å¤±è´¥æ—¥å¿—
        }
    }
}
```

### 7.4 åˆ†å¸ƒå¼ç¼“å­˜æ›´æ–°


**ğŸ”¸ Redisé›†ç¾¤ç¯å¢ƒçš„ä¸€è‡´æ€§**

```java
@Component
public class DistributedCacheUpdater {
    
    @Autowired
    private List<RedisTemplate<String, Object>> redisTemplates; // å¤šä¸ªRediså®ä¾‹
    
    /**
     * æ›´æ–°æ‰€æœ‰ç¼“å­˜èŠ‚ç‚¹
     */
    public void updateAllCacheNodes(String key, Object value) {
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        for (RedisTemplate<String, Object> template : redisTemplates) {
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                try {
                    template.opsForValue().set(key, value, Duration.ofMinutes(10));
                } catch (Exception e) {
                    log.error("æ›´æ–°RedisèŠ‚ç‚¹å¤±è´¥: {}", template, e);
                }
            });
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰æ›´æ–°å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
                         .orTimeout(5, TimeUnit.SECONDS)
                         .whenComplete((result, ex) -> {
                             if (ex != null) {
                                 log.error("æ‰¹é‡æ›´æ–°ç¼“å­˜è¶…æ—¶", ex);
                             }
                         });
    }
    
    /**
     * ä½¿ç”¨Rediså‘å¸ƒè®¢é˜…é€šçŸ¥å…¶ä»–èŠ‚ç‚¹
     */
    public void notifyCacheUpdate(String key, Object value) {
        CacheUpdateMessage message = new CacheUpdateMessage();
        message.setKey(key);
        message.setValue(value);
        message.setTimestamp(System.currentTimeMillis());
        
        // å‘å¸ƒæ¶ˆæ¯åˆ°Redisé¢‘é“
        redisTemplate.convertAndSend("cache.update.channel", message);
    }
    
    /**
     * è®¢é˜…ç¼“å­˜æ›´æ–°æ¶ˆæ¯
     */
    @RedisMessageListener(topic = "cache.update.channel")
    public void handleCacheUpdateMessage(CacheUpdateMessage message) {
        try {
            // æ›´æ–°æœ¬åœ°ç¼“å­˜
            redisTemplate.opsForValue().set(message.getKey(), 
                                           message.getValue(), 
                                           Duration.ofMinutes(10));
            
        } catch (Exception e) {
            log.error("å¤„ç†ç¼“å­˜æ›´æ–°æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

---

## 8. ğŸ—ï¸ ç»¼åˆæ¶æ„å®æˆ˜


### 8.1 æ•´ä½“æ¶æ„è®¾è®¡


**ç§’æ€ç³»ç»Ÿå®Œæ•´æ¶æ„å›¾**ï¼š

```
                              ç”¨æˆ·è¯·æ±‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Nginxç½‘å…³å±‚                           â”‚
â”‚  â”œâ”€ é™æµæ§åˆ¶(1ä¸‡QPS)                                        â”‚
â”‚  â”œâ”€ è´Ÿè½½å‡è¡¡                                               â”‚ 
â”‚  â””â”€ é™æ€èµ„æºç¼“å­˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Spring Gateway                         â”‚
â”‚  â”œâ”€ è·¯ç”±è§„åˆ™                                              â”‚
â”‚  â”œâ”€ è®¤è¯æˆæƒ                                              â”‚
â”‚  â””â”€ ç†”æ–­é™çº§                                              â”‚ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç§’æ€ä¸šåŠ¡æœåŠ¡é›†ç¾¤                        â”‚
â”‚                                                            â”‚
â”‚  ç§’æ€æœåŠ¡A    ç§’æ€æœåŠ¡B    ç§’æ€æœåŠ¡C                          â”‚
â”‚     â”‚           â”‚           â”‚                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                 â†“                                         â”‚
â”‚            Redisåˆ†å¸ƒå¼é”                                   â”‚
â”‚                 â†“                                         â”‚
â”‚            æ¶ˆæ¯é˜Ÿåˆ—(å¼‚æ­¥å¤„ç†)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åº“å­˜æœåŠ¡        â”‚     è®¢å•æœåŠ¡     â”‚      æ”¯ä»˜æœåŠ¡        â”‚
â”‚                    â”‚                â”‚                    â”‚  
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Redisç¼“å­˜   â”‚    â”‚ â”‚ è®¢å•DB      â”‚ â”‚ â”‚ è´¦æˆ·DB      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                â”‚                    â”‚
â”‚ â”‚ åº“å­˜DB      â”‚    â”‚                â”‚                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ ¸å¿ƒä»£ç å®ç°


**ğŸ”¸ ç§’æ€ä¸»æœåŠ¡**

```java
@RestController
@RequestMapping("/seckill")
@Slf4j
public class SecKillController {
    
    @Autowired
    private SecKillService secKillService;
    
    @Autowired
    private RateLimiter rateLimiter;
    
    /**
     * ç§’æ€æ¥å£
     */
    @PostMapping("/buy")
    public ApiResponse<SecKillResult> secKill(@RequestBody SecKillRequest request) {
        try {
            // 1. å‚æ•°æ ¡éªŒ
            if (request.getProductId() == null || request.getUserId() == null) {
                return ApiResponse.fail("å‚æ•°é”™è¯¯");
            }
            
            // 2. é™æµæ£€æŸ¥
            if (!rateLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
                return ApiResponse.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // 3. ç”¨æˆ·æƒé™æ ¡éªŒ
            if (!secKillService.checkUserPermission(request)) {
                return ApiResponse.fail("ç”¨æˆ·ä¸ç¬¦åˆå‚ä¸æ¡ä»¶");
            }
            
            // 4. å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚
            SecKillResponse response = secKillService.submitSecKillRequest(request);
            
            return ApiResponse.success(response);
            
        } catch (Exception e) {
            log.error("ç§’æ€å¤„ç†å¼‚å¸¸", e);
            return ApiResponse.fail("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    /**
     * æŸ¥è¯¢ç§’æ€ç»“æœ
     */
    @GetMapping("/result/{requestId}")
    public ApiResponse<SecKillResult> getResult(@PathVariable String requestId) {
        SecKillResult result = secKillService.getSecKillResult(requestId);
        return ApiResponse.success(result);
    }
}
```

**ğŸ”¸ åº“å­˜æœåŠ¡å®ç°**

```java
@Service
@Transactional
public class StockService {
    
    @Autowired
    private RedisDistributedLock distributedLock;
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    @Autowired
    private StockMapper stockMapper;
    
    /**
     * æ‰£å‡åº“å­˜çš„æ ¸å¿ƒé€»è¾‘
     */
    public boolean decreaseStock(Long productId, Integer quantity) {
        String lockKey = "stock_lock:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // 1. è·å–åˆ†å¸ƒå¼é”
            if (!distributedLock.tryLock(lockKey, lockValue, 10)) {
                log.info("è·å–åº“å­˜é”å¤±è´¥: {}", productId);
                return false;
            }
            
            // 2. æ£€æŸ¥ç¼“å­˜åº“å­˜
            String cacheKey = "stock:" + productId;
            Integer cacheStock = redisTemplate.opsForValue().get(cacheKey);
            
            if (cacheStock != null && cacheStock < quantity) {
                log.info("ç¼“å­˜æ˜¾ç¤ºåº“å­˜ä¸è¶³: product={}, stock={}, need={}", 
                        productId, cacheStock, quantity);
                return false;
            }
            
            // 3. æ•°æ®åº“æ‰£å‡åº“å­˜ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
            int affected = stockMapper.decreaseStockOptimistic(productId, quantity);
            if (affected == 0) {
                log.info("æ•°æ®åº“æ‰£å‡åº“å­˜å¤±è´¥: {}", productId);
                return false;
            }
            
            // 4. æ›´æ–°ç¼“å­˜
            if (cacheStock != null) {
                redisTemplate.opsForValue().set(cacheKey, cacheStock - quantity);
            } else {
                // ç¼“å­˜ä¸å­˜åœ¨ï¼Œåˆ é™¤è®©å…¶é‡æ–°åŠ è½½
                redisTemplate.delete(cacheKey);
            }
            
            return true;
            
        } finally {
            distributedLock.releaseLock(lockKey, lockValue);
        }
    }
    
    /**
     * é¢„çƒ­åº“å­˜åˆ°ç¼“å­˜
     */
    public void preloadStockToCache(Long productId) {
        String cacheKey = "stock:" + productId;
        Integer stock = stockMapper.getStock(productId);
        if (stock != null) {
            redisTemplate.opsForValue().set(cacheKey, stock, Duration.ofHours(1));
            log.info("åº“å­˜é¢„çƒ­å®Œæˆ: product={}, stock={}", productId, stock);
        }
    }
}
```

### 8.3 ç›‘æ§å’Œè¿ç»´


**ğŸ”¸ å…³é”®æŒ‡æ ‡ç›‘æ§**

```java
@Component
public class SecKillMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter successCounter;
    private final Counter failureCounter;
    private final Timer processTimer;
    
    public SecKillMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.successCounter = Counter.builder("seckill.success")
                                    .description("ç§’æ€æˆåŠŸæ¬¡æ•°")
                                    .register(meterRegistry);
        this.failureCounter = Counter.builder("seckill.failure")
                                    .description("ç§’æ€å¤±è´¥æ¬¡æ•°") 
                                    .register(meterRegistry);
        this.processTimer = Timer.builder("seckill.process.time")
                                 .description("ç§’æ€å¤„ç†æ—¶é—´")
                                 .register(meterRegistry);
    }
    
    /**
     * è®°å½•ç§’æ€æˆåŠŸ
     */
    public void recordSuccess() {
        successCounter.increment();
    }
    
    /**
     * è®°å½•ç§’æ€å¤±è´¥
     */
    public void recordFailure(String reason) {
        failureCounter.increment(Tags.of("reason", reason));
    }
    
    /**
     * è®°å½•å¤„ç†æ—¶é—´
     */
    public void recordProcessTime(Duration duration) {
        processTimer.record(duration);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ¯ ç§’æ€ç³»ç»Ÿæ ¸å¿ƒæŒ‘æˆ˜ï¼š
â€¢ é«˜å¹¶å‘ï¼šç¬é—´å¤§é‡è¯·æ±‚æ¶Œå…¥
â€¢ åº“å­˜é™åˆ¶ï¼šå•†å“æ•°é‡æœ‰é™ï¼Œéœ€è¦å‡†ç¡®æ§åˆ¶
â€¢ æ•°æ®ä¸€è‡´æ€§ï¼šå¤šä¸ªæœåŠ¡é—´æ•°æ®è¦ä¿æŒåŒæ­¥
â€¢ ç³»ç»Ÿç¨³å®šæ€§ï¼šé¿å…å› æµé‡æ¿€å¢å¯¼è‡´ç³»ç»Ÿå´©æºƒ
```

### 9.2 æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆæ€»ç»“


| æŠ€æœ¯æ–¹æ¡ˆ | **è§£å†³é—®é¢˜** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|---------|-------------|
| ğŸ”’ **åˆ†å¸ƒå¼é”** | `å¹¶å‘å†²çªï¼Œè¶…å–é—®é¢˜` | `å¼ºä¸€è‡´æ€§ï¼Œç»å¯¹å‡†ç¡®` | `æ€§èƒ½è¾ƒä½ï¼Œä¸²è¡ŒåŒ–` | `åº“å­˜æå°‘ï¼Œå‡†ç¡®æ€§è¦æ±‚æé«˜` |
| ğŸš€ **å¼‚æ­¥å¤„ç†** | `å“åº”é€Ÿåº¦ï¼Œç”¨æˆ·ä½“éªŒ` | `é«˜ååï¼Œå¿«é€Ÿå“åº”` | `æœ€ç»ˆä¸€è‡´ï¼Œå¤æ‚æ€§é«˜` | `å¤§éƒ¨åˆ†ç§’æ€åœºæ™¯` |
| ğŸ“Š **é™æµé™çº§** | `ç³»ç»Ÿä¿æŠ¤ï¼Œé¿å…å´©æºƒ` | `ä¿è¯ç¨³å®šæ€§` | `æ‹’ç»éƒ¨åˆ†è¯·æ±‚` | `æ‰€æœ‰é«˜å¹¶å‘åœºæ™¯` |
| ğŸ’¾ **ç¼“å­˜ä¼˜åŒ–** | `æ•°æ®åº“å‹åŠ›ï¼Œè¯»æ€§èƒ½` | `æå¿«å“åº”` | `ä¸€è‡´æ€§å¤æ‚` | `è¯»å¤šå†™å°‘åœºæ™¯` |

### 9.3 æ¶æ„è®¾è®¡åŸåˆ™


**ğŸ”¹ åˆ†å±‚è®¾è®¡æ€æƒ³**ï¼š
```
æ¥å…¥å±‚ï¼šç½‘å…³é™æµï¼Œè´Ÿè½½å‡è¡¡
ä¸šåŠ¡å±‚ï¼šå¼‚æ­¥å¤„ç†ï¼Œåˆ†å¸ƒå¼é”
æ•°æ®å±‚ï¼šç¼“å­˜åŠ é€Ÿï¼Œåˆ†åº“åˆ†è¡¨
```

**ğŸ”¹ å¯ç”¨æ€§ä¿éšœ**ï¼š
- **å†—ä½™å¤‡ä»½**ï¼šå¤šå®ä¾‹éƒ¨ç½²ï¼Œé¿å…å•ç‚¹æ•…éšœ
- **ç†”æ–­é™çº§**ï¼šå¼‚å¸¸æ—¶å¿«é€Ÿå¤±è´¥ï¼Œä¿æŠ¤ç³»ç»Ÿ
- **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§ï¼Œå¿«é€Ÿå“åº”é—®é¢˜

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–æ€è·¯**ï¼š
- **å‡å°‘IO**ï¼šç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“è®¿é—®
- **å¼‚æ­¥åŒ–**ï¼šè€—æ—¶æ“ä½œå¼‚æ­¥å¤„ç†ï¼Œæå‡å“åº”é€Ÿåº¦
- **æ‰¹é‡å¤„ç†**ï¼šåˆå¹¶è¯·æ±‚ï¼Œæé«˜å¤„ç†æ•ˆç‡

### 9.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ å¼€å‘é˜¶æ®µ**ï¼š
- âœ… **é¢„ä¼°å®¹é‡**ï¼šæ ¹æ®ä¸šåŠ¡é‡è®¾è®¡ç³»ç»Ÿå®¹é‡
- âœ… **å‹åŠ›æµ‹è¯•**ï¼šæ¨¡æ‹ŸçœŸå®åœºæ™¯è¿›è¡Œæ€§èƒ½æµ‹è¯•  
- âœ… **ç›‘æ§åŸ‹ç‚¹**ï¼šæ·»åŠ å…³é”®ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§
- âœ… **é™çº§é¢„æ¡ˆ**ï¼šå‡†å¤‡ç³»ç»Ÿå¼‚å¸¸æ—¶çš„é™çº§æ–¹æ¡ˆ

**ğŸ”§ è¿ç»´é˜¶æ®µ**ï¼š
- âœ… **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®å†å²æ•°æ®é¢„æµ‹èµ„æºéœ€æ±‚
- âœ… **å®æ—¶ç›‘æ§**ï¼šç›‘æ§ç³»ç»Ÿå„é¡¹å…³é”®æŒ‡æ ‡
- âœ… **å¿«é€Ÿå“åº”**ï¼šå¼‚å¸¸æƒ…å†µä¸‹å¿«é€Ÿå®šä½å’Œå¤„ç†
- âœ… **å¤ç›˜æ”¹è¿›**ï¼šæ´»åŠ¨ç»“æŸåæ€»ç»“æ”¹è¿›ç‚¹

### 9.5 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**â“ è¶…å–é—®é¢˜**ï¼š
- **åŸå› **ï¼šå¹¶å‘è¯·æ±‚åŒæ—¶è¯»å–åº“å­˜ï¼ŒåŸºäºè¿‡æœŸæ•°æ®åšå†³ç­–
- **è§£å†³**ï¼šåˆ†å¸ƒå¼é” + æ•°æ®åº“ä¹è§‚é” + ç¼“å­˜ä¸€è‡´æ€§ä¿è¯

**â“ ç³»ç»Ÿå´©æºƒ**ï¼š
- **åŸå› **ï¼šç¬é—´æµé‡è¿‡å¤§ï¼Œç³»ç»Ÿæ— æ³•æ‰¿å—
- **è§£å†³**ï¼šå¤šå±‚é™æµ + ç†”æ–­é™çº§ + æ°´å¹³æ‰©å±•

**â“ ç”¨æˆ·ä½“éªŒå·®**ï¼š
- **åŸå› **ï¼šåŒæ­¥å¤„ç†å¯¼è‡´å“åº”æ…¢ï¼Œå¤§é‡ç”¨æˆ·ç­‰å¾…
- **è§£å†³**ï¼šå¼‚æ­¥å¤„ç† + ç»“æœé€šçŸ¥ + è¿›åº¦æ˜¾ç¤º

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **åˆ†å¸ƒå¼é”ä¿å‡†ç¡®**ï¼šRedisé”é˜²è¶…å–ï¼Œæ€§èƒ½ä¸å‡†ç¡®æ€§è¦å¹³è¡¡
- **å¼‚æ­¥å¤„ç†æä½“éªŒ**ï¼šé˜Ÿåˆ—å‰Šå³°å¡«è°·ï¼Œç”¨æˆ·å¿«é€Ÿå¾—å“åº”  
- **æœ€ç»ˆä¸€è‡´å¯æ¥å—**ï¼šçŸ­æš‚ä¸ä¸€è‡´æ¢é«˜æ€§èƒ½ï¼Œä¸šåŠ¡åœºæ™¯è¦æƒè¡¡
- **é™æµé™çº§æŠ¤ç³»ç»Ÿ**ï¼šå®å¯æ‹’ç»éƒ¨åˆ†è¯·æ±‚ï¼Œä¸è®©æ•´ä¸ªç³»ç»Ÿå´©æºƒ
- **ç¼“å­˜ä¸€è‡´æ˜¯éš¾ç‚¹**ï¼šå…ˆåˆ ç¼“å­˜åæ›´æ–°åº“ï¼Œæˆ–ç”¨æ¶ˆæ¯ä¿è¯ä¸€è‡´æ€§
- **ç›‘æ§è¿ç»´ä¸å¯å°‘**ï¼šå®æ—¶æŒæ¡ç³»ç»ŸçŠ¶æ€ï¼Œé—®é¢˜å‡ºç°å¿«å¤„ç†

### 9.6 å­¦ä¹ è¿›é˜¶è·¯çº¿


**é˜¶æ®µä¸€ï¼šåŸºç¡€ç†è§£** â­
- ç†è§£ç§’æ€ä¸šåŠ¡ç‰¹ç‚¹å’ŒæŒ‘æˆ˜
- æŒæ¡åˆ†å¸ƒå¼é”çš„åŸºæœ¬æ¦‚å¿µ
- äº†è§£ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬æ–¹å¼

**é˜¶æ®µäºŒï¼šæŠ€æœ¯æ·±å…¥** â­â­
- æ·±å…¥å­¦ä¹ Redisåˆ†å¸ƒå¼é”å®ç°
- æŒæ¡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†æ–¹æ¡ˆ
- ç†è§£é™æµé™çº§çš„å„ç§ç­–ç•¥

**é˜¶æ®µä¸‰ï¼šç³»ç»Ÿè®¾è®¡** â­â­â­  
- èƒ½å¤Ÿè®¾è®¡å®Œæ•´çš„ç§’æ€ç³»ç»Ÿæ¶æ„
- å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µå’Œè¾¹ç•Œæ¡ä»¶
- å…·å¤‡ç³»ç»Ÿä¼˜åŒ–å’Œæ€§èƒ½è°ƒä¼˜èƒ½åŠ›

**é˜¶æ®µå››ï¼šç”Ÿäº§å®æˆ˜** â­â­â­â­
- åœ¨çœŸå®ç¯å¢ƒä¸­éƒ¨ç½²å’Œè¿ç»´ç³»ç»Ÿ
- å¤„ç†ç”Ÿäº§ç¯å¢ƒçš„å„ç§å¤æ‚é—®é¢˜
- æŒç»­æ”¹è¿›ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼š
> ç§’æ€ç³»ç»Ÿæ¶‰åŠçš„æŠ€æœ¯ç‚¹å¾ˆå¤šï¼Œå»ºè®®å…ˆæŒæ¡åŸºç¡€æ¦‚å¿µï¼Œç„¶åé€šè¿‡å®é™…é¡¹ç›®æ¥åŠ æ·±ç†è§£ã€‚ç†è®ºå­¦ä¹ å’ŒåŠ¨æ‰‹å®è·µè¦ç»“åˆèµ·æ¥ï¼Œè¿™æ ·æ‰èƒ½çœŸæ­£æŒæ¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç²¾é«“ã€‚

---

## ğŸ¯ æ¨èå­¦ä¹ èµ„æº


**ğŸ“š ç›¸å…³æŠ€æœ¯æ ˆ**ï¼š
- **Redis**ï¼šåˆ†å¸ƒå¼é”ã€ç¼“å­˜ç­–ç•¥
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRabbitMQã€RocketMQã€Kafka
- **é™æµç»„ä»¶**ï¼šSentinelã€Hystrixã€Guava RateLimiter  
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šSeataã€TCC-Transaction
- **ç›‘æ§å·¥å…·**ï¼šPrometheusã€Grafanaã€SkyWalking

**ğŸ”— å»¶ä¼¸é˜…è¯»**ï¼š
- ã€Šå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡å®æˆ˜ã€‹
- ã€ŠRedisè®¾è®¡ä¸å®ç°ã€‹
- ã€Šæ¶ˆæ¯é˜Ÿåˆ—é«˜æ‰‹è¯¾ã€‹
- å„å¤§äº’è”ç½‘å…¬å¸çš„æŠ€æœ¯åšå®¢åˆ†äº«