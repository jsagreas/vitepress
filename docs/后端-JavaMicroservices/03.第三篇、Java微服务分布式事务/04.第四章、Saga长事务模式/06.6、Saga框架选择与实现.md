---
title: 6ã€Sagaæ¡†æ¶é€‰æ‹©ä¸å®ç°
---
## ğŸ“š ç›®å½•

1. [Sagaæ¡†æ¶æ¦‚è¿°ä¸é€‰æ‹©](#1-sagaæ¡†æ¶æ¦‚è¿°ä¸é€‰æ‹©)
2. [Axonæ¡†æ¶æ·±å…¥è§£æ](#2-axonæ¡†æ¶æ·±å…¥è§£æ)
3. [Apache Camel Sagaå®ç°](#3-apache-camel-sagaå®ç°)
4. [æ¡†æ¶å¯¹æ¯”ä¸æœ€ä½³å®è·µ](#4-æ¡†æ¶å¯¹æ¯”ä¸æœ€ä½³å®è·µ)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Sagaæ¡†æ¶æ¦‚è¿°ä¸é€‰æ‹©


### 1.1 ä»€ä¹ˆæ˜¯Sagaæ¡†æ¶


> **ğŸ’¡ é€šä¿—ç†è§£**  
> æƒ³è±¡ä½ è¦ç»„ç»‡ä¸€åœºå¤šäººèšé¤ï¼Œéœ€è¦è®¢é¤å…ã€è®¢è›‹ç³•ã€ä¹°ç¤¼ç‰©ç­‰å¤šä¸ªæ­¥éª¤ã€‚å¦‚æœä¸­é€”æŸä¸ªç¯èŠ‚å‡ºé—®é¢˜ï¼ˆæ¯”å¦‚é¤å…æ»¡äº†ï¼‰ï¼Œä½ éœ€è¦å–æ¶ˆä¹‹å‰çš„æ‰€æœ‰é¢„è®¢ã€‚Sagaæ¡†æ¶å°±æ˜¯å¸®ä½ è‡ªåŠ¨ç®¡ç†è¿™ç§å¤æ‚æµç¨‹çš„å·¥å…·ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
- **æµç¨‹ç¼–æ’**ï¼šæŠŠå¤æ‚çš„ä¸šåŠ¡æµç¨‹åˆ†è§£æˆå¤šä¸ªæ­¥éª¤
- **è‡ªåŠ¨è¡¥å¿**ï¼šæŸæ­¥éª¤å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨æ’¤é”€ä¹‹å‰çš„æ“ä½œ  
- **çŠ¶æ€ç®¡ç†**ï¼šè·Ÿè¸ªæ•´ä¸ªæµç¨‹çš„æ‰§è¡ŒçŠ¶æ€
- **é”™è¯¯å¤„ç†**ï¼šæä¾›ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

### 1.2 ä¸»æµSagaæ¡†æ¶å¯¹æ¯”


| æ¡†æ¶ç‰¹æ€§ | **Axon Framework** | **Apache Camel** | **Netflix Conductor** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------------|-------------------|----------------------|------------|
| **å­¦ä¹ éš¾åº¦** | `â­â­â­â­â˜†` è¾ƒéš¾ | `â­â­â­â˜†â˜†` ä¸­ç­‰ | `â­â­â˜†â˜†â˜†` ç®€å• | **å¤æ‚åº¦é€‰æ‹©** |
| **åŠŸèƒ½å®Œæ•´æ€§** | `ğŸ”¥ æœ€å…¨é¢` | `âœ… ä¸°å¯Œ` | `ğŸ“Œ åŸºç¡€` | **åŠŸèƒ½éœ€æ±‚** |
| **ç¤¾åŒºæ´»è·ƒåº¦** | `ğŸŒŸ æ´»è·ƒ` | `ğŸš€ éå¸¸æ´»è·ƒ` | `ğŸ“Š ä¸­ç­‰` | **æŠ€æœ¯æ”¯æŒ** |
| **ä¼ä¸šé‡‡ç”¨ç‡** | `ğŸ’¼ é‡‘èä¸šå¤š` | `ğŸ¢ å„è¡Œä¸š` | `ğŸ¬ Netflixç³»` | **è¡Œä¸šé€‰æ‹©** |

### 1.3 æ¡†æ¶é€‰æ‹©å†³ç­–æ ‘


```
ä¸šåŠ¡å¤æ‚åº¦åˆ†æ
        â”‚
        â–¼
    æ˜¯å¦éœ€è¦äº‹ä»¶æº¯æºï¼Ÿ
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   æ˜¯          å¦
   â”‚          â”‚
   â–¼          â–¼
é€‰æ‹©Axon   ä¸šåŠ¡æµç¨‹å¤æ‚å—ï¼Ÿ
          â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          æ˜¯          å¦
          â”‚          â”‚
          â–¼          â–¼
      é€‰æ‹©Camel   é€‰æ‹©è½»é‡çº§æ–¹æ¡ˆ
```

> **ğŸ” é€‰æ‹©å»ºè®®**  
> - **é‡‘èã€ç”µå•†**ç­‰å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜ï¼šé€‰æ‹© **Axon**
> - **ä¸€èˆ¬ä¼ä¸šåº”ç”¨**éœ€è¦çµæ´»çš„æµç¨‹ç¼–æ’ï¼šé€‰æ‹© **Camel** 
> - **ç®€å•åœºæ™¯**åªéœ€åŸºç¡€åŠŸèƒ½ï¼šè€ƒè™‘è‡ªå®ç°æˆ–è½»é‡çº§æ–¹æ¡ˆ

---

## 2. ğŸ—ï¸ Axonæ¡†æ¶æ·±å…¥è§£æ


### 2.1 Axonæ ¸å¿ƒæ¦‚å¿µè¯¦è§£


**ä»€ä¹ˆæ˜¯Axonï¼Ÿ**
> Axonä¸åªæ˜¯ä¸€ä¸ªSagaæ¡†æ¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„**äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Driven Architectureï¼‰**è§£å†³æ–¹æ¡ˆã€‚å°±åƒç›–æˆ¿å­ï¼ŒAxonæä¾›äº†å®Œæ•´çš„å»ºç­‘å·¥å…·å’Œæ–½å·¥è§„èŒƒã€‚

#### ğŸ§© æ ¸å¿ƒç»„ä»¶æ¶æ„


```
Axonæ¡†æ¶æ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Axon Framework                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Command Side   â”‚   Query Side    â”‚    Saga Manager     â”‚
â”‚                 â”‚                 â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Command     â”‚ â”‚ â”‚ Event       â”‚ â”‚ â”‚ Saga Instance   â”‚ â”‚
â”‚  â”‚ Handler     â”‚ â”‚ â”‚ Handler     â”‚ â”‚ â”‚                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Aggregate   â”‚ â”‚ â”‚ Projection  â”‚ â”‚ â”‚ Compensation    â”‚ â”‚
â”‚  â”‚ Root        â”‚ â”‚ â”‚             â”‚ â”‚ â”‚ Handler         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–²
                         â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   Event Store   â”‚ â† æ‰€æœ‰äº‹ä»¶çš„å­˜å‚¨ä¸­å¿ƒ
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**ğŸ¯ èšåˆæ ¹ï¼ˆAggregate Rootï¼‰**
```java
// å°±åƒä¸€ä¸ªä¸šåŠ¡å¯¹è±¡çš„"ç®¡å®¶"ï¼Œè´Ÿè´£ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§
@Aggregate
public class OrderAggregate {
    @AggregateIdentifier
    private String orderId;
    
    private OrderStatus status;
    private BigDecimal amount;
    
    // æ„é€ å‡½æ•° - åˆ›å»ºè®¢å•æ—¶è°ƒç”¨
    public OrderAggregate() {} // Axonè¦æ±‚çš„é»˜è®¤æ„é€ å‡½æ•°
    
    // å‘½ä»¤å¤„ç† - å¤„ç†åˆ›å»ºè®¢å•è¯·æ±‚
    @CommandHandler
    public OrderAggregate(CreateOrderCommand command) {
        // ä¸šåŠ¡é€»è¾‘éªŒè¯
        if (command.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        // å‘å¸ƒäº‹ä»¶ - "æˆ‘åˆ›å»ºäº†ä¸€ä¸ªè®¢å•"
        AggregateLifecycle.apply(new OrderCreatedEvent(
            command.getOrderId(),
            command.getAmount()
        ));
    }
    
    // äº‹ä»¶å¤„ç† - å“åº”è‡ªå·±å‘å¸ƒçš„äº‹ä»¶
    @EventSourcingHandler
    public void on(OrderCreatedEvent event) {
        this.orderId = event.getOrderId();
        this.amount = event.getAmount();
        this.status = OrderStatus.CREATED;
    }
}
```

**âš¡ äº‹ä»¶å¤„ç†å™¨ï¼ˆEvent Handlerï¼‰**  
```java
// è´Ÿè´£ç›‘å¬äº‹ä»¶ï¼Œæ›´æ–°æŸ¥è¯¢æ¨¡å‹
@Component
public class OrderProjection {
    
    @EventHandler
    public void on(OrderCreatedEvent event) {
        // æ›´æ–°æŸ¥è¯¢æ•°æ®åº“
        // å°±åƒå¬åˆ°å¹¿æ’­åï¼Œæ›´æ–°è‡ªå·±çš„è®°å½•æœ¬
        OrderView orderView = new OrderView();
        orderView.setOrderId(event.getOrderId());
        orderView.setAmount(event.getAmount());
        orderView.setStatus("å·²åˆ›å»º");
        
        orderViewRepository.save(orderView);
    }
}
```

### 2.2 Sagaç”Ÿå‘½å‘¨æœŸè¯¦è§£


**Sagaçš„ä¸€ç”Ÿ**ï¼š
```
Sagaç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼š
å¼€å§‹è§¦å‘äº‹ä»¶ â†’ åˆ›å»ºSagaå®ä¾‹ â†’ æ‰§è¡Œä¸šåŠ¡æ­¥éª¤ â†’ ç›‘å¬å“åº”äº‹ä»¶ â†’ å†³å®šä¸‹ä¸€æ­¥
     â–²                                                         â”‚
     â”‚                                                         â–¼
   é‡è¯•å¤„ç† â†â”€â”€â”€ æ‰§è¡Œè¡¥å¿æ“ä½œ â†â”€â”€â”€ æŸæ­¥éª¤å¤±è´¥ â†â”€â”€â”€ ç»§ç»­æˆ–å®ŒæˆSaga
```

**å®é™…ä»£ç ç¤ºä¾‹**ï¼š
```java
@Saga
public class OrderProcessingSaga {
    
    private String orderId;
    private boolean paymentCompleted = false;
    private boolean inventoryReserved = false;
    
    // 1. Sagaå¯åŠ¨ - ç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶
    @SagaOrchestrationStart
    @StartSaga
    @SagaAssociationProperty("orderId")
    public void handle(OrderCreatedEvent event) {
        this.orderId = event.getOrderId();
        
        // å¼€å§‹ç¬¬ä¸€ä¸ªæ­¥éª¤ï¼šé¢„æ‰£åº“å­˜
        commandGateway.send(new ReserveInventoryCommand(
            event.getOrderId(),
            event.getProductId(),
            event.getQuantity()
        ));
    }
    
    // 2. ç›‘å¬åº“å­˜é¢„æ‰£ç»“æœ
    @SagaAssociationProperty("orderId")
    public void handle(InventoryReservedEvent event) {
        this.inventoryReserved = true;
        
        // åº“å­˜é¢„æ‰£æˆåŠŸï¼Œå¼€å§‹æ”¯ä»˜
        commandGateway.send(new ProcessPaymentCommand(
            event.getOrderId(),
            event.getAmount()
        ));
    }
    
    // 3. ç›‘å¬æ”¯ä»˜ç»“æœ  
    @SagaAssociationProperty("orderId")
    public void handle(PaymentProcessedEvent event) {
        this.paymentCompleted = true;
        
        // æ”¯ä»˜æˆåŠŸï¼Œç¡®è®¤è®¢å•
        commandGateway.send(new ConfirmOrderCommand(event.getOrderId()));
        
        // ç»“æŸSaga
        SagaLifecycle.end();
    }
    
    // 4. è¡¥å¿å¤„ç† - æ”¯ä»˜å¤±è´¥
    @SagaAssociationProperty("orderId")
    public void handle(PaymentFailedEvent event) {
        // æ”¯ä»˜å¤±è´¥ï¼Œéœ€è¦é‡Šæ”¾åº“å­˜
        if (inventoryReserved) {
            commandGateway.send(new ReleaseInventoryCommand(event.getOrderId()));
        }
        
        // å–æ¶ˆè®¢å•
        commandGateway.send(new CancelOrderCommand(event.getOrderId()));
        
        SagaLifecycle.end();
    }
}
```

> **ğŸ’­ ç†è§£è¦ç‚¹**  
> Sagaå°±åƒä¸€ä¸ª**æ™ºèƒ½çš„æµç¨‹ç®¡ç†å‘˜**ï¼š
> - çŸ¥é“æ¯ä¸ªæ­¥éª¤è¯¥åšä»€ä¹ˆ
> - ç›‘å¬æ¯ä¸ªæ­¥éª¤çš„ç»“æœ  
> - å‡ºé—®é¢˜æ—¶çŸ¥é“å¦‚ä½•è¡¥æ•‘
> - å®Œæˆåä¼šè‡ªåŠ¨é€€åœº

### 2.3 èšåˆæ ¹è®¾è®¡æœ€ä½³å®è·µ


**è®¾è®¡åŸåˆ™**ï¼š

> **ğŸ¯ å•ä¸€èŒè´£åŸåˆ™**  
> ä¸€ä¸ªèšåˆæ ¹åªç®¡ç†ä¸€å—ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ï¼Œå°±åƒä¸€ä¸ªéƒ¨é—¨åªç®¡è‡ªå·±çš„äº‹æƒ…ã€‚

**è‰¯å¥½çš„èšåˆæ ¹è®¾è®¡**ï¼š
```java
@Aggregate
public class PaymentAggregate {
    @AggregateIdentifier
    private String paymentId;
    
    private String orderId;
    private BigDecimal amount;
    private PaymentStatus status;
    private int retryCount;
    
    @CommandHandler
    public PaymentAggregate(ProcessPaymentCommand command) {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        validatePaymentAmount(command.getAmount());
        
        // å‘å¸ƒäº‹ä»¶
        AggregateLifecycle.apply(new PaymentInitiatedEvent(
            command.getPaymentId(),
            command.getOrderId(),
            command.getAmount()
        ));
    }
    
    @CommandHandler  
    public void handle(RetryPaymentCommand command) {
        // é‡è¯•é™åˆ¶
        if (retryCount >= 3) {
            AggregateLifecycle.apply(new PaymentFailedEvent(
                paymentId, "è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°"
            ));
            return;
        }
        
        // æ‰§è¡Œé‡è¯•
        AggregateLifecycle.apply(new PaymentRetryEvent(paymentId, ++retryCount));
    }
    
    // éªŒè¯ä¸šåŠ¡è§„åˆ™çš„ç§æœ‰æ–¹æ³•
    private void validatePaymentAmount(BigDecimal amount) {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("æ”¯ä»˜é‡‘é¢å¿…é¡»å¤§äº0");
        }
        if (amount.compareTo(new BigDecimal("100000")) > 0) {
            throw new IllegalArgumentException("å•ç¬”æ”¯ä»˜é‡‘é¢ä¸èƒ½è¶…è¿‡10ä¸‡");
        }
    }
}
```

---

## 3. ğŸš€ Apache Camel Sagaå®ç°


### 3.1 Apache Camelç®€ä»‹


> **ğŸ’¡ ä»€ä¹ˆæ˜¯Apache Camelï¼Ÿ**  
> Camelå°±åƒä¸€ä¸ª**ä¸‡èƒ½çš„æ•°æ®æ¬è¿å·¥**å’Œ**æµç¨‹åè°ƒå‘˜**ã€‚å®ƒèƒ½è¿æ¥å„ç§ä¸åŒçš„ç³»ç»Ÿï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€WebæœåŠ¡ç­‰ï¼‰ï¼Œå¹¶ä¸”èƒ½å®šä¹‰å¤æ‚çš„æ•°æ®æµè½¬è§„åˆ™ã€‚

**Camelçš„æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **è¿æ¥å™¨ä¸°å¯Œ**ï¼šæ”¯æŒ300+ç§ç³»ç»Ÿè¿æ¥
- **è·¯ç”±çµæ´»**ï¼šå¯ä»¥å®šä¹‰å¤æ‚çš„æ•°æ®æµè½¬é€»è¾‘
- **EIPæ¨¡å¼**ï¼šå®ç°ä¼ä¸šé›†æˆæ¨¡å¼
- **è½»é‡çº§**ï¼šç›¸æ¯”Axonæ›´å®¹æ˜“ä¸Šæ‰‹

### 3.2 Camelè·¯ç”±å®šä¹‰è¯¦è§£


**åŸºç¡€è·¯ç”±æ¦‚å¿µ**ï¼š
```java
// è·¯ç”±å°±åƒå®šä¹‰ä¸€æ¡æ•°æ®çš„"æ—…è¡Œè·¯çº¿"
@Component
public class OrderProcessingRoute extends RouteBuilder {
    
    @Override
    public void configure() throws Exception {
        
        // Sagaé…ç½® - å®šä¹‰è¡¥å¿æœºåˆ¶
        SagaDefinition saga = saga()
            .timeout(30000) // 30ç§’è¶…æ—¶
            .compensation("direct:cancelOrder") // å¤±è´¥æ—¶çš„è¡¥å¿è·¯ç”±
            .completion("direct:completeOrder"); // æˆåŠŸæ—¶çš„å®Œæˆè·¯ç”±
            
        // ä¸»è¦ä¸šåŠ¡æµç¨‹è·¯ç”±
        from("direct:processOrder")
            .saga(saga)
            .log("å¼€å§‹å¤„ç†è®¢å•: ${body}")
            
            // æ­¥éª¤1ï¼šåº“å­˜æ£€æŸ¥å’Œé¢„æ‰£  
            .to("direct:checkInventory")
            .choice()
                .when(header("inventoryAvailable").isEqualTo(false))
                    .throwException(new RuntimeException("åº“å­˜ä¸è¶³"))
                .otherwise()
                    .to("direct:reserveInventory")
            .end()
            
            // æ­¥éª¤2ï¼šå¤„ç†æ”¯ä»˜
            .to("direct:processPayment")
            .choice()
                .when(header("paymentSuccess").isEqualTo(false))
                    .throwException(new RuntimeException("æ”¯ä»˜å¤±è´¥"))
            .end()
            
            // æ­¥éª¤3ï¼šç¡®è®¤è®¢å•
            .to("direct:confirmOrder")
            .log("è®¢å•å¤„ç†å®Œæˆ: ${body}");
    }
}
```

### 3.3 è¡¥å¿å¤„ç†é…ç½®


**è¡¥å¿æœºåˆ¶è®¾è®¡**ï¼š
```java
@Component  
public class CompensationRoutes extends RouteBuilder {
    
    @Override
    public void configure() throws Exception {
        
        // è®¢å•å–æ¶ˆè¡¥å¿è·¯ç”±
        from("direct:cancelOrder")
            .log("å¼€å§‹æ‰§è¡Œè®¢å•å–æ¶ˆè¡¥å¿...")
            .multicast().parallelProcessing() // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªè¡¥å¿
            .to("direct:releaseInventory")
            .to("direct:refundPayment")
            .to("direct:notifyCustomer")
            .end()
            .log("è®¢å•è¡¥å¿å®Œæˆ");
            
        // é‡Šæ”¾åº“å­˜è¡¥å¿
        from("direct:releaseInventory")
            .choice()
                .when(header("inventoryReserved").isEqualTo(true))
                    .to("sql:UPDATE inventory SET reserved_qty = reserved_qty - #{quantity} WHERE product_id = #{productId}")
                    .log("å·²é‡Šæ”¾åº“å­˜: äº§å“ID=${header.productId}, æ•°é‡=${header.quantity}")
                .otherwise()
                    .log("æ— éœ€é‡Šæ”¾åº“å­˜")
            .end();
            
        // é€€æ¬¾è¡¥å¿
        from("direct:refundPayment")
            .choice()
                .when(header("paymentCompleted").isEqualTo(true))
                    .setHeader("refundAmount", simple("${header.paymentAmount}"))
                    .to("http://payment-service/refund")
                    .log("å·²å‘èµ·é€€æ¬¾: é‡‘é¢=${header.refundAmount}")
                .otherwise()
                    .log("æ— éœ€é€€æ¬¾")
            .end();
    }
}
```

### 3.4 é”™è¯¯å¤„ç†ç­–ç•¥


**å¤šå±‚æ¬¡é”™è¯¯å¤„ç†**ï¼š
```java
@Component
public class ErrorHandlingRoute extends RouteBuilder {
    
    @Override
    public void configure() throws Exception {
        
        // å…¨å±€å¼‚å¸¸å¤„ç†
        onException(Exception.class)
            .maximumRedeliveries(3) // æœ€å¤šé‡è¯•3æ¬¡
            .redeliveryDelay(2000)  // é‡è¯•é—´éš”2ç§’
            .backOffMultiplier(2)   // é‡è¯•é—´éš”é€’å¢
            .retryAttemptedLogLevel(LoggingLevel.WARN)
            .handled(true)
            .log("å¤„ç†å¼‚å¸¸: ${exception.message}")
            .to("direct:handleError");
            
        // ç‰¹å®šå¼‚å¸¸å¤„ç†
        onException(PaymentException.class)
            .maximumRedeliveries(1)
            .handled(true)
            .log("æ”¯ä»˜å¼‚å¸¸ï¼Œæ‰§è¡Œæ”¯ä»˜è¡¥å¿")
            .to("direct:handlePaymentError");
            
        // é”™è¯¯å¤„ç†è·¯ç”±
        from("direct:handleError")
            .choice()
                .when(header("sagaId").isNotNull())
                    .log("Sagaå¼‚å¸¸ï¼Œè§¦å‘è¡¥å¿: SagaID=${header.sagaId}")
                    .to("direct:triggerCompensation")
                .otherwise()
                    .log("æ™®é€šå¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—")
                    .to("direct:logError")
            .end();
    }
}
```

### 3.5 ç›‘æ§ä¸è¿½è¸ª


**ç›‘æ§é…ç½®**ï¼š
```java
@Configuration
public class SagaMonitoringConfig {
    
    // JMXç›‘æ§é…ç½®
    @Bean
    public ManagementAgent managementAgent() {
        ManagementAgent agent = new ManagementAgent();
        agent.setCreateConnector(true);
        agent.setRegistryPort(1099);
        return agent;
    }
    
    // æŒ‡æ ‡æ”¶é›†
    @Bean
    public MicrometerMessageHistoryFactory messageHistoryFactory() {
        MicrometerMessageHistoryFactory factory = new MicrometerMessageHistoryFactory();
        factory.setPrettyPrint(true);
        return factory;
    }
}

// è‡ªå®šä¹‰ç›‘æ§è·¯ç”±
@Component
public class MonitoringRoute extends RouteBuilder {
    
    @Override
    public void configure() throws Exception {
        
        // SagaçŠ¶æ€ç›‘æ§
        from("timer:sagaMonitor?period=30000") // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            .to("sql:SELECT saga_id, status, created_time FROM saga_instances WHERE status = 'RUNNING'")
            .split(body())
            .choice()
                .when(simple("${body[created_time]} < ${date:now-300000}")) // è¶…è¿‡5åˆ†é’Ÿçš„è¿è¡Œä¸­Saga
                    .log("å‘ç°é•¿æ—¶é—´è¿è¡Œçš„Saga: ${body[saga_id]}")
                    .to("direct:alertLongRunningSaga")
            .end();
            
        // å¼‚å¸¸å‘Šè­¦
        from("direct:alertLongRunningSaga")  
            .setBody(simple("Saga ${body[saga_id]} è¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œè¯·æ£€æŸ¥"))
            .to("log:ALERT?level=WARN")
            // å¯ä»¥å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
            .to("http://monitoring-service/alert");
    }
}
```

> **ğŸ“Š ç›‘æ§è¦ç‚¹**  
> - **Sagaæ‰§è¡Œæ—¶é—´**ï¼šè¯†åˆ«é•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡
> - **è¡¥å¿æ‰§è¡Œæƒ…å†µ**ï¼šç¡®ä¿è¡¥å¿æ“ä½œæˆåŠŸ
> - **é‡è¯•æ¬¡æ•°ç»Ÿè®¡**ï¼šå‘ç°ç³»ç»Ÿç“¶é¢ˆ
> - **ä¸šåŠ¡æŒ‡æ ‡**ï¼šè®¢å•æˆåŠŸç‡ã€æ”¯ä»˜æˆåŠŸç‡ç­‰

---

## 4. ğŸ”„ æ¡†æ¶å¯¹æ¯”ä¸æœ€ä½³å®è·µ


### 4.1 è¯¦ç»†å¯¹æ¯”åˆ†æ


| å¯¹æ¯”ç»´åº¦ | **Axon Framework** | **Apache Camel Saga** | **é€‰æ‹©å»ºè®®** |
|---------|-------------------|----------------------|------------|
| **ğŸ’° æˆæœ¬** | å­¦ä¹ æˆæœ¬é«˜ï¼Œå¼€å‘æ•ˆç‡ä½ | å­¦ä¹ æˆæœ¬ä¸­ç­‰ï¼Œå¼€å‘æ•ˆç‡é«˜ | `é¢„ç®—ç´§å¼ é€‰Camel` |
| **ğŸ—ï¸ æ¶æ„** | å®Œæ•´CQRS+ESæ¶æ„ | çµæ´»çš„é›†æˆæ¶æ„ | `å¤æ‚ä¸šåŠ¡é€‰Axon` |
| **ğŸ”§ æ‰©å±•æ€§** | æ¡†æ¶çº¦æŸå¼ºï¼Œæ‰©å±•æœ‰é™ | é«˜åº¦å¯å®šåˆ¶å’Œæ‰©å±• | `å®šåˆ¶éœ€æ±‚é€‰Camel` |
| **ğŸ“ˆ æ€§èƒ½** | äº‹ä»¶å­˜å‚¨å¼€é”€å¤§ | è½»é‡çº§ï¼Œæ€§èƒ½æ›´å¥½ | `é«˜å¹¶å‘é€‰Camel` |
| **ğŸ› ï¸ è¿ç»´** | éœ€è¦ä¸“é—¨çš„äº‹ä»¶å­˜å‚¨ | ä¾èµ–æ¶ˆæ¯ä¸­é—´ä»¶ | `è¿ç»´å¤æ‚åº¦è€ƒè™‘` |

### 4.2 ä½¿ç”¨åœºæ™¯æŒ‡å¯¼


**ğŸ¦ é‡‘èè¡Œä¸š - æ¨èAxon**
```
é€‚ç”¨åŸå› ï¼š
âœ… å¼ºå®¡è®¡è¦æ±‚ â†’ äº‹ä»¶æº¯æºå¤©ç„¶æ”¯æŒ
âœ… æ•°æ®ä¸€è‡´æ€§ â†’ CQRSæ¨¡å¼ä¿éšœ  
âœ… ç›‘ç®¡åˆè§„ â†’ å®Œæ•´çš„äº‹ä»¶å†å²
âœ… ä¸šåŠ¡å¤æ‚ â†’ é¢†åŸŸé©±åŠ¨è®¾è®¡

å®æ–½å»ºè®®ï¼š
â€¢ æŠ•å…¥è¶³å¤Ÿçš„å­¦ä¹ æ—¶é—´
â€¢ é…ç½®ä¸“ä¸šçš„DBAå›¢é˜Ÿ
â€¢ å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
```

**ğŸ›’ ç”µå•†å¹³å° - æ¨èCamel**
```
é€‚ç”¨åŸå› ï¼š  
âœ… å¿«é€Ÿè¿­ä»£ â†’ ç®€å•æ˜“ç”¨ï¼Œå¼€å‘æ•ˆç‡é«˜
âœ… ç³»ç»Ÿé›†æˆ â†’ ä¸°å¯Œçš„è¿æ¥å™¨æ”¯æŒ
âœ… å¼¹æ€§æ‰©å±• â†’ è½»é‡çº§ï¼Œæ˜“äºæ‰©å®¹
âœ… æˆæœ¬æ§åˆ¶ â†’ å­¦ä¹ å’Œç»´æŠ¤æˆæœ¬ä½

å®æ–½å»ºè®®ï¼š
â€¢ é€‰æ‹©åˆé€‚çš„æ¶ˆæ¯ä¸­é—´ä»¶
â€¢ è®¾è®¡å¥½è¡¥å¿é€»è¾‘
â€¢ åšå¥½ç›‘æ§å’Œå‘Šè­¦
```

### 4.3 å®æ–½æœ€ä½³å®è·µ


**ğŸ“‹ é€šç”¨å®æ–½æ¸…å•**ï¼š

> **ğŸ¯ é¡¹ç›®å‡†å¤‡é˜¶æ®µ**
> - [ ] **å›¢é˜ŸæŠ€èƒ½è¯„ä¼°**ï¼šæ˜¯å¦æœ‰è¶³å¤Ÿçš„å­¦ä¹ æ—¶é—´ï¼Ÿ
> - [ ] **ä¸šåŠ¡å¤æ‚åº¦åˆ†æ**ï¼šäº‹åŠ¡æ­¥éª¤å¤šå—ï¼Ÿè¡¥å¿é€»è¾‘å¤æ‚å—ï¼Ÿ
> - [ ] **æ€§èƒ½è¦æ±‚ç¡®è®¤**ï¼šå¹¶å‘é‡å’Œå“åº”æ—¶é—´è¦æ±‚å¦‚ä½•ï¼Ÿ
> - [ ] **è¿ç»´èƒ½åŠ›æ£€æŸ¥**ï¼šæ˜¯å¦æœ‰ä¸“ä¸šçš„è¿ç»´å›¢é˜Ÿï¼Ÿ

> **âš ï¸ å¸¸è§é™·é˜±é¿å…**
> ```
> é™·é˜±1ï¼šè¿‡åº¦è®¾è®¡
> âŒ ç®€å•ä¸šåŠ¡ä½¿ç”¨å¤æ‚æ¡†æ¶
> âœ… æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚å·¥å…·
> 
> é™·é˜±2ï¼šè¡¥å¿é€»è¾‘ä¸å®Œå–„  
> âŒ åªè€ƒè™‘æ­£å¸¸æµç¨‹ï¼Œå¿½ç•¥å¼‚å¸¸æƒ…å†µ
> âœ… ä¸ºæ¯ä¸ªæ­¥éª¤è®¾è®¡å¯¹åº”çš„è¡¥å¿æ“ä½œ
> 
> é™·é˜±3ï¼šç›‘æ§ä¸åˆ°ä½
> âŒ éƒ¨ç½²åç¼ºä¹æœ‰æ•ˆç›‘æ§
> âœ… å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
> ```

**ğŸ”§ æŠ€æœ¯å®æ–½å»ºè®®**ï¼š

```java
// æ— è®ºé€‰æ‹©å“ªä¸ªæ¡†æ¶ï¼Œéƒ½è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

// 1. å¹‚ç­‰æ€§è®¾è®¡
@Service
public class PaymentService {
    
    public void processPayment(String orderId, BigDecimal amount) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        if (paymentRepository.existsByOrderId(orderId)) {
            log.info("è®¢å•{}å·²ç»å¤„ç†è¿‡æ”¯ä»˜ï¼Œè·³è¿‡", orderId);
            return; // å¹‚ç­‰æ€§ä¿æŠ¤
        }
        
        // æ‰§è¡Œæ”¯ä»˜é€»è¾‘...
    }
}

// 2. è¶…æ—¶å¤„ç†
@SagaOrchestrationStart
public void handle(OrderCreatedEvent event) {
    // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
    SagaLifecycle.associateWith("orderId", event.getOrderId());
    
    // å¯åŠ¨è¶…æ—¶æ£€æŸ¥
    commandGateway.sendAndWait(
        new ReserveInventoryCommand(event.getOrderId()),
        Duration.ofSeconds(30) // 30ç§’è¶…æ—¶
    );
}

// 3. çŠ¶æ€æŒä¹…åŒ–
@Entity
public class SagaState {
    private String sagaId;
    private String orderId; 
    private String status;
    private LocalDateTime createdTime;
    private String currentStep;
    // æŒä¹…åŒ–SagaçŠ¶æ€ï¼Œä¾¿äºæ¢å¤å’Œç›‘æ§
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Sagaæ¨¡å¼æœ¬è´¨ï¼šåˆ†å¸ƒå¼äº‹åŠ¡çš„ç¼–æ’å’Œè¡¥å¿æœºåˆ¶
ğŸ”¸ Axonç‰¹ç‚¹ï¼šå®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡
ğŸ”¸ Camelç‰¹ç‚¹ï¼šçµæ´»çš„é›†æˆæ¡†æ¶ï¼Œç®€å•æ˜“ç”¨
ğŸ”¸ å…³é”®è®¾è®¡ï¼šå¹‚ç­‰æ€§ã€è¶…æ—¶å¤„ç†ã€çŠ¶æ€æŒä¹…åŒ–
ğŸ”¸ ç›‘æ§é‡ç‚¹ï¼šæ‰§è¡Œæ—¶é—´ã€è¡¥å¿æƒ…å†µã€ä¸šåŠ¡æŒ‡æ ‡
```

### 5.2 æ¡†æ¶é€‰æ‹©å†³ç­–è¦ç‚¹


> **ğŸ’¡ é€‰æ‹©Axonçš„æƒ…å†µ**
> - é‡‘èã€åŒ»ç–—ç­‰å¼ºç›‘ç®¡è¡Œä¸š
> - ä¸šåŠ¡é€»è¾‘æå…¶å¤æ‚
> - éœ€è¦å®Œæ•´çš„äº‹ä»¶å†å²
> - å›¢é˜Ÿæœ‰è¶³å¤Ÿçš„æŠ€æœ¯å®åŠ›

> **ğŸ’¡ é€‰æ‹©Camelçš„æƒ…å†µ**  
> - äº’è”ç½‘ã€ç”µå•†ç­‰å¿«é€Ÿè¿­ä»£è¡Œä¸š
> - éœ€è¦é›†æˆå¤šç§ç³»ç»Ÿ
> - å¼€å‘æ•ˆç‡ä¼˜å…ˆ
> - å›¢é˜ŸæŠ€æœ¯å®åŠ›ä¸€èˆ¬

> **ğŸš¨ ä¸¤ä¸ªéƒ½ä¸é€‰çš„æƒ…å†µ**
> - ä¸šåŠ¡é€»è¾‘éå¸¸ç®€å•ï¼ˆ2-3ä¸ªæ­¥éª¤ï¼‰
> - å›¢é˜ŸæŠ€æœ¯å®åŠ›ä¸è¶³
> - é¡¹ç›®æ—¶é—´ç´§è¿«
> - è€ƒè™‘è‡ªå·±å®ç°ç®€å•çš„è¡¥å¿æœºåˆ¶

### 5.3 å®è·µæŒ‡å¯¼åŸåˆ™


**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼š
- **ç®€å•ä¼˜å…ˆ**ï¼šèƒ½ç”¨ç®€å•æ–¹æ¡ˆå°±ä¸ç”¨å¤æ‚æ¡†æ¶
- **æ¸è¿›å¼**ï¼šä»ç®€å•å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚æ€§  
- **ç›‘æ§ä¸ºç‹**ï¼šæ²¡æœ‰ç›‘æ§çš„åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å±é™©çš„
- **æµ‹è¯•å……åˆ†**ï¼šè¡¥å¿é€»è¾‘å¿…é¡»ç»è¿‡å……åˆ†æµ‹è¯•

**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š
```
å­¦ä¹ é˜¶æ®µè§„åˆ’ï¼š
ç¬¬1å‘¨ï¼šç†è§£SagaåŸºæœ¬æ¦‚å¿µ
     â†“
ç¬¬2-3å‘¨ï¼šé€‰æ‹©ä¸€ä¸ªæ¡†æ¶æ·±å…¥å­¦ä¹   
     â†“
ç¬¬4å‘¨ï¼šåŠ¨æ‰‹å®ç°ç®€å•Demo
     â†“
ç¬¬5-6å‘¨ï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨
     â†“  
æŒç»­å­¦ä¹ ï¼šå…³æ³¨æœ€ä½³å®è·µå’Œæ–°å‘å±•
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> ğŸµ **Sagaæ¡†æ¶é€‰æ‹©æ­Œ**  
> *å¤æ‚ä¸šåŠ¡ç”¨Axonï¼Œç®€å•é›†æˆé€‰Camel*  
> *ç›‘æ§æµ‹è¯•ä¸èƒ½å°‘ï¼Œè¡¥å¿é€»è¾‘è¦åšå¥½*  
> *å¹‚ç­‰è¶…æ—¶çŠ¶æ€å­˜ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡æ‰å®‰å¿ƒ*

---

> **ğŸ“ æ€»ç»“æ„Ÿæ‚Ÿ**  
> Sagaæ¡†æ¶è™½ç„¶èƒ½å¾ˆå¥½åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œä½†é€‰æ‹©å’Œä½¿ç”¨éƒ½éœ€è¦è°¨æ…ã€‚è®°ä½ï¼š**æŠ€æœ¯æ˜¯ä¸ºä¸šåŠ¡æœåŠ¡çš„**ï¼Œä¸è¦ä¸ºäº†æŠ€æœ¯è€ŒæŠ€æœ¯ã€‚å…ˆç†è§£ä¸šåŠ¡éœ€æ±‚ï¼Œå†é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œæœ€ååšå¥½ç›‘æ§å’Œè¿ç»´ï¼Œè¿™æ ·æ‰èƒ½çœŸæ­£å‘æŒ¥Sagaæ¡†æ¶çš„ä»·å€¼ã€‚