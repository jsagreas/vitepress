---
title: 6ã€2PCåœ¨æ•°æ®åº“ä¸­çš„å®ç°
---
## ğŸ“š ç›®å½•

1. [2PCåè®®åŸºç¡€ç†è§£](#1-2PCåè®®åŸºç¡€ç†è§£)
2. [ä¸»è¦æ•°æ®åº“çš„2PCå®ç°](#2-ä¸»è¦æ•°æ®åº“çš„2PCå®ç°)
3. [äº‹åŠ¡ç®¡ç†å™¨è¯¦è§£](#3-äº‹åŠ¡ç®¡ç†å™¨è¯¦è§£)
4. [Spring Booté›†æˆ2PCå®æˆ˜](#4-Spring-Booté›†æˆ2PCå®æˆ˜)
5. [æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜](#5-æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ 2PCåè®®åŸºç¡€ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µæäº¤åè®®


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> æƒ³è±¡ä½ å’Œæœ‹å‹ä»¬ä¸€èµ·è®¢é¤å…ï¼Œéœ€è¦æ‰€æœ‰äººéƒ½åŒæ„æ‰èƒ½ç¡®å®šã€‚ç¬¬ä¸€æ­¥ï¼šé—®æ¯ä¸ªäºº"èƒ½å»å—ï¼Ÿ"ï¼Œç¬¬äºŒæ­¥ï¼šæ”¶åˆ°æ‰€æœ‰ç¡®è®¤åç»Ÿä¸€é€šçŸ¥"é‚£å°±è¿™æ ·å®šäº†ï¼"

**2PCæ ¸å¿ƒæ€æƒ³**ï¼š
```
åˆ†å¸ƒå¼äº‹åŠ¡ = å¤šä¸ªæ•°æ®åº“ + ç»Ÿä¸€åè°ƒ
ç›®æ ‡ï¼šè¦ä¹ˆæ‰€æœ‰æ•°æ®åº“éƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
æ–¹æ³•ï¼šåˆ†ä¸¤ä¸ªé˜¶æ®µæ¥ç¡®ä¿ä¸€è‡´æ€§
```

**ğŸ”¸ ä¸¤ä¸ªå…³é”®è§’è‰²**
```
åè°ƒè€…(Coordinator)ï¼š
â€¢ å°±åƒèšé¤çš„ç»„ç»‡è€…
â€¢ è´Ÿè´£ç»Ÿä¸€åè°ƒæ‰€æœ‰å‚ä¸è€…
â€¢ åšæœ€ç»ˆçš„æäº¤æˆ–å›æ»šå†³å®š

å‚ä¸è€…(Participant)ï¼š  
â€¢ å°±åƒæ¯ä¸ªè¦å»èšé¤çš„æœ‹å‹
â€¢ å„ä¸ªæ•°æ®åº“èŠ‚ç‚¹
â€¢ æ ¹æ®åè°ƒè€…æŒ‡ä»¤æ‰§è¡Œæ“ä½œ
```

### 1.2 2PCçš„ä¸¤ä¸ªé˜¶æ®µè¯¦è§£


**ğŸ“‹ é˜¶æ®µä¸€ï¼šå‡†å¤‡é˜¶æ®µ(Prepare Phase)**
```
åè°ƒè€…çš„å·¥ä½œï¼š
1. å‘æ‰€æœ‰å‚ä¸è€…å‘é€"å‡†å¤‡æäº¤"è¯·æ±‚
2. ç­‰å¾…æ‰€æœ‰å‚ä¸è€…çš„å›åº”

å‚ä¸è€…çš„å·¥ä½œï¼š
1. æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤
2. å°†äº‹åŠ¡ç»“æœå†™å…¥æ—¥å¿—
3. å›å¤åè°ƒè€…ï¼šå¯ä»¥æäº¤ or ä¸èƒ½æäº¤

ç”Ÿæ´»ç±»æ¯”ï¼š
"å¤§å®¶æ˜å¤©æ™šä¸Š7ç‚¹èƒ½æ¥å—ï¼Ÿè¯·å›å¤æˆ‘"
```

**âœ… é˜¶æ®µäºŒï¼šæäº¤é˜¶æ®µ(Commit Phase)**
```
å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½è¯´"å¯ä»¥"ï¼š
åè°ƒè€… â†’ æ‰€æœ‰å‚ä¸è€…ï¼šæ‰§è¡Œæäº¤
å‚ä¸è€… â†’ çœŸæ­£æäº¤äº‹åŠ¡
å‚ä¸è€… â†’ åè°ƒè€…ï¼šæäº¤å®Œæˆ

å¦‚æœæœ‰å‚ä¸è€…è¯´"ä¸è¡Œ"ï¼š
åè°ƒè€… â†’ æ‰€æœ‰å‚ä¸è€…ï¼šæ‰§è¡Œå›æ»š
å‚ä¸è€… â†’ å›æ»šäº‹åŠ¡
å‚ä¸è€… â†’ åè°ƒè€…ï¼šå›æ»šå®Œæˆ

ç”Ÿæ´»ç±»æ¯”ï¼š
"æ‰€æœ‰äººéƒ½ç¡®è®¤äº†ï¼Œé‚£å°±æ˜å¤©7ç‚¹è§ï¼"
æˆ–è€…"å°ç‹è¯´æœ‰äº‹ï¼Œé‚£è¿™æ¬¡èšé¤å–æ¶ˆ"
```

### 1.3 2PCçš„ä¼˜åŠ¿ä¸é—®é¢˜


**âœ… ä¼˜åŠ¿ç‰¹ç‚¹**
```
ğŸ¯ å¼ºä¸€è‡´æ€§ï¼šä¿è¯æ‰€æœ‰æ•°æ®åº“çŠ¶æ€ä¸€è‡´
ğŸ›¡ï¸ æ•°æ®å®‰å…¨ï¼šä¸ä¼šå‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥
ğŸ“Š å®ç°ç›¸å¯¹ç®€å•ï¼šé€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£
ğŸ”§ æ ‡å‡†åŒ–ï¼šXAè§„èŒƒï¼Œå„å¤§æ•°æ®åº“éƒ½æ”¯æŒ
```

**âš ï¸ å­˜åœ¨é—®é¢˜**
```
ğŸŒ æ€§èƒ½é—®é¢˜ï¼š
â€¢ éœ€è¦ç­‰å¾…æ‰€æœ‰å‚ä¸è€…å“åº”
â€¢ é˜»å¡æœŸé—´èµ„æºè¢«é”å®š
â€¢ ç½‘ç»œé€šä¿¡å¼€é”€å¤§

ğŸ” é˜»å¡é—®é¢˜ï¼š
â€¢ å‡†å¤‡é˜¶æ®µåå‚ä¸è€…å¿…é¡»ç­‰å¾…
â€¢ åè°ƒè€…æ•…éšœæ—¶æ•´ä¸ªç³»ç»Ÿé˜»å¡

ğŸ’€ å•ç‚¹é—®é¢˜ï¼š
â€¢ åè°ƒè€…æ˜¯å…³é”®èŠ‚ç‚¹
â€¢ åè°ƒè€…æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ
```

---

## 2. ğŸ—„ï¸ ä¸»è¦æ•°æ®åº“çš„2PCå®ç°


### 2.1 MySQL XAäº‹åŠ¡


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> MySQL XAæ˜¯MySQLå®ç°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†ï¼ŒXAä»£è¡¨"eXtended Architecture"ï¼Œæ˜¯X/Openç»„ç»‡å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡æ ‡å‡†

**ğŸ”§ MySQL XAåŸºæœ¬è¯­æ³•**
```sql
-- å¼€å¯XAäº‹åŠ¡
XA START 'transaction_id';

-- æ‰§è¡Œä¸šåŠ¡SQL
INSERT INTO users (name, email) VALUES ('å¼ ä¸‰', 'zhang@example.com');
UPDATE accounts SET balance = balance - 100 WHERE user_id = 1;

-- ç»“æŸXAäº‹åŠ¡(è¿›å…¥å‡†å¤‡çŠ¶æ€)
XA END 'transaction_id';

-- å‡†å¤‡æäº¤
XA PREPARE 'transaction_id';

-- æœ€ç»ˆæäº¤æˆ–å›æ»š
XA COMMIT 'transaction_id';
-- æˆ–è€…
XA ROLLBACK 'transaction_id';
```

**ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```sql
-- æ¨¡æ‹Ÿè½¬è´¦ä¸šåŠ¡ï¼šAè´¦æˆ·è½¬è´¦ç»™Bè´¦æˆ·

-- æ•°æ®åº“1ï¼šæ‰£å‡Aè´¦æˆ·ä½™é¢
XA START 'transfer_001_db1';
UPDATE accounts SET balance = balance - 500 WHERE account_id = 'A001';
XA END 'transfer_001_db1';
XA PREPARE 'transfer_001_db1';

-- æ•°æ®åº“2ï¼šå¢åŠ Bè´¦æˆ·ä½™é¢  
XA START 'transfer_001_db2';
UPDATE accounts SET balance = balance + 500 WHERE account_id = 'B001';
XA END 'transfer_001_db2';
XA PREPARE 'transfer_001_db2';

-- å¦‚æœä¸¤ä¸ªæ•°æ®åº“éƒ½å‡†å¤‡æˆåŠŸï¼Œåˆ™æäº¤
XA COMMIT 'transfer_001_db1';
XA COMMIT 'transfer_001_db2';
```

**ğŸ” MySQL XAçŠ¶æ€æŸ¥è¯¢**
```sql
-- æŸ¥çœ‹å½“å‰XAäº‹åŠ¡çŠ¶æ€
XA RECOVER;

-- ç»“æœç¤ºä¾‹ï¼š
-- formatID | gtrid_length | bqual_length | data
-- 1        | 12          | 0           | transfer_001
```

### 2.2 Oracleåˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ¢ Oracleçš„2PCå®ç°ç‰¹ç‚¹**
```
åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†å™¨ï¼šOracleå†…ç½®å¼ºå¤§çš„äº‹åŠ¡åè°ƒå™¨
æ•°æ®åº“é“¾æ¥ï¼šé€šè¿‡Database Linkè¿æ¥å¤šä¸ªæ•°æ®åº“
è‡ªåŠ¨åè°ƒï¼šOracleè‡ªåŠ¨å¤„ç†2PCåè®®ç»†èŠ‚
```

**ğŸ”§ Oracleåˆ†å¸ƒå¼äº‹åŠ¡ç¤ºä¾‹**
```sql
-- åˆ›å»ºæ•°æ®åº“é“¾æ¥
CREATE DATABASE LINK remote_db 
CONNECT TO username IDENTIFIED BY password 
USING 'remote_host:1521/ORCL';

-- æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡
BEGIN
    -- æœ¬åœ°æ•°æ®åº“æ“ä½œ
    UPDATE local_accounts SET balance = balance - 1000 WHERE id = 1;
    
    -- è¿œç¨‹æ•°æ®åº“æ“ä½œ(é€šè¿‡database link)
    UPDATE remote_accounts@remote_db SET balance = balance + 1000 WHERE id = 2;
    
    -- Oracleè‡ªåŠ¨åè°ƒä¸¤é˜¶æ®µæäº¤
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
END;
```

### 2.3 PostgreSQLåˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ˜ PostgreSQLçš„2PCæ”¯æŒ**
```
å‡†å¤‡äº‹åŠ¡ï¼šPREPARE TRANSACTIONå‘½ä»¤
æäº¤å‡†å¤‡ï¼šCOMMIT PREPAREDå‘½ä»¤  
å›æ»šå‡†å¤‡ï¼šROLLBACK PREPAREDå‘½ä»¤
```

**ğŸ’» PostgreSQL 2PCç¤ºä¾‹**
```sql
-- ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡äº‹åŠ¡
BEGIN;
INSERT INTO orders (user_id, amount) VALUES (1, 299);
UPDATE inventory SET quantity = quantity - 1 WHERE product_id = 101;
PREPARE TRANSACTION 'order_tx_001';

-- ç¬¬äºŒé˜¶æ®µï¼šæäº¤æˆ–å›æ»š
-- æˆåŠŸæƒ…å†µ
COMMIT PREPARED 'order_tx_001';

-- å¤±è´¥æƒ…å†µ
ROLLBACK PREPARED 'order_tx_001';
```

---

## 3. âš™ï¸ äº‹åŠ¡ç®¡ç†å™¨è¯¦è§£


### 3.1 Atomikosäº‹åŠ¡ç®¡ç†å™¨


> ğŸ¯ **ç®€å•ç†è§£**  
> Atomikoså°±åƒä¸€ä¸ªä¸“ä¸šçš„é¡¹ç›®ç»ç†ï¼Œä¸“é—¨è´Ÿè´£åè°ƒå¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡æ“ä½œï¼Œç¡®ä¿è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥

**ğŸ“¦ Mavenä¾èµ–é…ç½®**
```xml
<dependency>
    <groupId>com.atomikos</groupId>
    <artifactId>transactions-spring-boot-starter</artifactId>
    <version>5.0.8</version>
</dependency>
```

**ğŸ”§ AtomikosåŸºç¡€é…ç½®**
```properties
# atomikosé…ç½®æ–‡ä»¶
spring.jta.atomikos.properties.service=com.atomikos.icatch.standalone.UserTransactionServiceFactory
spring.jta.atomikos.properties.max-timeout=300000
spring.jta.atomikos.properties.default-jta-timeout=10000
spring.jta.atomikos.properties.max-actives=50
spring.jta.atomikos.properties.enable-logging=true
```

**ğŸ’¡ Atomikoså®é™…ä½¿ç”¨**
```java
@Service
@Transactional
public class TransferService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private AccountService accountService;
    
    // è½¬è´¦ä¸šåŠ¡ï¼šæ¶‰åŠç”¨æˆ·è¡¨å’Œè´¦æˆ·è¡¨ï¼ˆå¯èƒ½åœ¨ä¸åŒæ•°æ®åº“ï¼‰
    public void transfer(String fromUser, String toUser, BigDecimal amount) {
        // æ“ä½œ1ï¼šæ‰£å‡è½¬å‡ºæ–¹ä½™é¢
        accountService.deductBalance(fromUser, amount);
        
        // æ“ä½œ2ï¼šå¢åŠ è½¬å…¥æ–¹ä½™é¢
        accountService.addBalance(toUser, amount);
        
        // æ“ä½œ3ï¼šè®°å½•è½¬è´¦è®°å½•
        userService.addTransferRecord(fromUser, toUser, amount);
        
        // Atomikosè‡ªåŠ¨åè°ƒæ‰€æœ‰æ•°æ®æºçš„ä¸¤é˜¶æ®µæäº¤
    }
}
```

### 3.2 Bitronixäº‹åŠ¡ç®¡ç†å™¨


**ğŸ”§ Bitronixé…ç½®è¯´æ˜**
```properties
# Bitronixé…ç½®
bitronix.tm.configuration=/bitronix-config.properties
bitronix.tm.serverId=spring-boot-bitronix
bitronix.tm.disableJmx=false
bitronix.tm.transactionTimeout=60
bitronix.tm.backgroundRecoveryInterval=10
```

**ğŸ“Š Bitronix vs Atomikos å¯¹æ¯”**

| ç‰¹æ€§ | **Atomikos** | **Bitronix** |
|------|-------------|-------------|
| ğŸ¢ **å…¬å¸èƒŒæ™¯** | `å•†ä¸šå…¬å¸å¼€å‘` | `å¼€æºé¡¹ç›®` |
| ğŸ’° **æˆæƒæ–¹å¼** | `å…è´¹ç‰ˆ+å•†ä¸šç‰ˆ` | `å®Œå…¨å…è´¹` |
| âš¡ **æ€§èƒ½è¡¨ç°** | `è¾ƒå¥½` | `ä¸€èˆ¬` |
| ğŸ”§ **é…ç½®å¤æ‚åº¦** | `ç®€å•` | `ä¸­ç­‰` |
| ğŸ“š **æ–‡æ¡£è´¨é‡** | `è¯¦ç»†` | `ä¸€èˆ¬` |
| ğŸ› ï¸ **ç»´æŠ¤çŠ¶æ€** | `æŒç»­æ›´æ–°` | `æ›´æ–°è¾ƒæ…¢` |

---

## 4. ğŸƒ Spring Booté›†æˆ2PCå®æˆ˜


### 4.1 å¤šæ•°æ®æºé…ç½®


**ğŸ—‚ï¸ é¡¹ç›®ç»“æ„**
```
src/main/java/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ DataSourceConfig.java     # æ•°æ®æºé…ç½®
â”‚   â””â”€â”€ TransactionConfig.java    # äº‹åŠ¡é…ç½®
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ UserService.java         # ç”¨æˆ·æœåŠ¡
â”‚   â””â”€â”€ OrderService.java        # è®¢å•æœåŠ¡
```

**ğŸ’¾ æ•°æ®æºé…ç½®ä»£ç **
```java
@Configuration
public class DataSourceConfig {
    
    // ç¬¬ä¸€ä¸ªæ•°æ®æºï¼šç”¨æˆ·æ•°æ®åº“
    @Bean("userDataSource")
    @Primary
    public DataSource userDataSource() {
        AtomikosDataSourceBean dataSource = new AtomikosDataSourceBean();
        dataSource.setUniqueResourceName("userDB");
        dataSource.setXaDataSourceClassName("com.mysql.cj.jdbc.MysqlXADataSource");
        dataSource.setXaProperties(getUserDbProperties());
        dataSource.setMinPoolSize(5);
        dataSource.setMaxPoolSize(20);
        return dataSource;
    }
    
    // ç¬¬äºŒä¸ªæ•°æ®æºï¼šè®¢å•æ•°æ®åº“  
    @Bean("orderDataSource")
    public DataSource orderDataSource() {
        AtomikosDataSourceBean dataSource = new AtomikosDataSourceBean();
        dataSource.setUniqueResourceName("orderDB");
        dataSource.setXaDataSourceClassName("com.mysql.cj.jdbc.MysqlXADataSource");
        dataSource.setXaProperties(getOrderDbProperties());
        dataSource.setMinPoolSize(5);
        dataSource.setMaxPoolSize(20);
        return dataSource;
    }
    
    private Properties getUserDbProperties() {
        Properties props = new Properties();
        props.setProperty("URL", "jdbc:mysql://localhost:3306/user_db");
        props.setProperty("user", "root");
        props.setProperty("password", "password");
        return props;
    }
}
```

### 4.2 ä¸šåŠ¡æœåŠ¡å®ç°


**ğŸ‘¤ ç”¨æˆ·æœåŠ¡**
```java
@Service
public class UserService {
    
    @Autowired
    @Qualifier("userJdbcTemplate")
    private JdbcTemplate userJdbcTemplate;
    
    public void updateUserBalance(Long userId, BigDecimal amount) {
        String sql = "UPDATE users SET balance = balance + ? WHERE id = ?";
        userJdbcTemplate.update(sql, amount, userId);
        
        System.out.println("ç”¨æˆ·" + userId + "ä½™é¢å˜æ›´ï¼š" + amount);
    }
    
    public User getUserById(Long userId) {
        String sql = "SELECT * FROM users WHERE id = ?";
        return userJdbcTemplate.queryForObject(sql, new BeanPropertyRowMapper<>(User.class), userId);
    }
}
```

**ğŸ“¦ è®¢å•æœåŠ¡**
```java
@Service  
public class OrderService {
    
    @Autowired
    @Qualifier("orderJdbcTemplate")
    private JdbcTemplate orderJdbcTemplate;
    
    public void createOrder(Long userId, String productName, BigDecimal amount) {
        String sql = "INSERT INTO orders (user_id, product_name, amount, status) VALUES (?, ?, ?, ?)";
        orderJdbcTemplate.update(sql, userId, productName, amount, "CREATED");
        
        System.out.println("åˆ›å»ºè®¢å•ï¼šç”¨æˆ·" + userId + "è´­ä¹°" + productName + "ï¼Œé‡‘é¢" + amount);
    }
}
```

**ğŸ¯ ä¸šåŠ¡åè°ƒæœåŠ¡**
```java
@Service
public class BusinessService {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private OrderService orderService;
    
    @Transactional  // è¿™é‡Œçš„@Transactionalä¼šè§¦å‘2PC
    public void purchaseProduct(Long userId, String productName, BigDecimal price) {
        try {
            // æ­¥éª¤1ï¼šæ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆç”¨æˆ·æ•°æ®åº“ï¼‰
            userService.updateUserBalance(userId, price.negate());
            
            // æ­¥éª¤2ï¼šåˆ›å»ºè®¢å•è®°å½•ï¼ˆè®¢å•æ•°æ®åº“ï¼‰
            orderService.createOrder(userId, productName, price);
            
            System.out.println("è´­ä¹°æˆåŠŸï¼äº‹åŠ¡å°†é€šè¿‡2PCåè®®æäº¤");
            
        } catch (Exception e) {
            System.out.println("è´­ä¹°å¤±è´¥ï¼äº‹åŠ¡å°†å›æ»š");
            throw e;
        }
    }
}
```

### 4.3 æµ‹è¯•éªŒè¯


**ğŸ§ª å•å…ƒæµ‹è¯•ä»£ç **
```java
@SpringBootTest
@Transactional
@Rollback(false)  // ä¸å›æ»šï¼Œä¾¿äºè§‚å¯Ÿç»“æœ
class DistributedTransactionTest {
    
    @Autowired
    private BusinessService businessService;
    
    @Test
    void testSuccessfulPurchase() {
        // æµ‹è¯•æˆåŠŸåœºæ™¯ï¼šç”¨æˆ·ä½™é¢å……è¶³
        Long userId = 1L;
        String productName = "iPhone 15";
        BigDecimal price = new BigDecimal("5999.00");
        
        businessService.purchaseProduct(userId, productName, price);
        
        // éªŒè¯ï¼šä¸¤ä¸ªæ•°æ®åº“çš„æ•°æ®éƒ½åº”è¯¥æ­£ç¡®æ›´æ–°
    }
    
    @Test
    void testFailedPurchase() {
        // æµ‹è¯•å¤±è´¥åœºæ™¯ï¼šç”¨æˆ·ä½™é¢ä¸è¶³
        Long userId = 2L;
        String productName = "MacBook Pro";  
        BigDecimal price = new BigDecimal("15999.00");
        
        assertThrows(Exception.class, () -> {
            businessService.purchaseProduct(userId, productName, price);
        });
        
        // éªŒè¯ï¼šä¸¤ä¸ªæ•°æ®åº“çš„æ•°æ®éƒ½ä¸åº”è¯¥æ”¹å˜
    }
}
```

---

## 5. ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜


### 5.1 å…³é”®æ€§èƒ½å‚æ•°


**âš¡ Atomikosæ ¸å¿ƒå‚æ•°è°ƒä¼˜**
```properties
# è¿æ¥æ± å¤§å°è®¾ç½®
atomikos.datasource.minPoolSize=5          # æœ€å°è¿æ¥æ•°
atomikos.datasource.maxPoolSize=50         # æœ€å¤§è¿æ¥æ•°  
atomikos.datasource.borrowConnectionTimeout=30000  # è·å–è¿æ¥è¶…æ—¶

# äº‹åŠ¡è¶…æ—¶è®¾ç½®
com.atomikos.icatch.default_jta_timeout=30000      # é»˜è®¤äº‹åŠ¡è¶…æ—¶
com.atomikos.icatch.max_timeout=300000             # æœ€å¤§äº‹åŠ¡è¶…æ—¶

# æ—¥å¿—å’Œæ¢å¤è®¾ç½®  
com.atomikos.icatch.enable_logging=true            # å¯ç”¨äº‹åŠ¡æ—¥å¿—
com.atomikos.icatch.output_dir=./transaction-logs  # æ—¥å¿—ç›®å½•
com.atomikos.icatch.log_base_name=tmlog            # æ—¥å¿—æ–‡ä»¶å
```

**ğŸ“Š MySQL XAå‚æ•°ä¼˜åŒ–**
```sql
-- MySQL XAç›¸å…³é…ç½®ä¼˜åŒ–
SET GLOBAL innodb_lock_wait_timeout = 120;          -- XAé”ç­‰å¾…è¶…æ—¶
SET GLOBAL innodb_rollback_on_timeout = ON;         -- è¶…æ—¶æ—¶å›æ»šäº‹åŠ¡
SET GLOBAL max_connections = 1000;                  -- æœ€å¤§è¿æ¥æ•°
SET GLOBAL innodb_thread_concurrency = 16;          -- InnoDBçº¿ç¨‹å¹¶å‘æ•°
```

### 5.2 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**
```
ğŸ¯ äº‹åŠ¡æˆåŠŸç‡ï¼š
â€¢ 2PCäº‹åŠ¡æäº¤æˆåŠŸæ•° / æ€»äº‹åŠ¡æ•°
â€¢ ç›®æ ‡ï¼š> 99.5%

â±ï¸ äº‹åŠ¡å“åº”æ—¶é—´ï¼š
â€¢ å¹³å‡äº‹åŠ¡æ‰§è¡Œæ—¶é—´
â€¢ P95äº‹åŠ¡æ‰§è¡Œæ—¶é—´  
â€¢ ç›®æ ‡ï¼š< 500ms (P95)

ğŸ” èµ„æºé”å®šæ—¶é—´ï¼š
â€¢ å¹³å‡é”å®šæ—¶é—´
â€¢ æœ€å¤§é”å®šæ—¶é—´
â€¢ ç›®æ ‡ï¼š< 100ms (å¹³å‡)

ğŸ“Š è¿æ¥æ± ä½¿ç”¨ç‡ï¼š
â€¢ æ´»è·ƒè¿æ¥æ•° / æœ€å¤§è¿æ¥æ•°
â€¢ ç›®æ ‡ï¼š< 80%
```

**ğŸ” ç›‘æ§å®ç°ç¤ºä¾‹**
```java
@Component
public class TransactionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter successCounter;
    private final Counter failCounter;
    private final Timer transactionTimer;
    
    public TransactionMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.successCounter = Counter.builder("transaction.success")
                .description("Successful 2PC transactions")
                .register(meterRegistry);
        this.failCounter = Counter.builder("transaction.fail")
                .description("Failed 2PC transactions")
                .register(meterRegistry);
        this.transactionTimer = Timer.builder("transaction.duration")
                .description("2PC transaction duration")
                .register(meterRegistry);
    }
    
    public void recordSuccess() {
        successCounter.increment();
    }
    
    public void recordFailure() {
        failCounter.increment();
    }
    
    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ¯ ä¼˜åŒ–ç­–ç•¥æ¸…å•**

âœ… **è¿æ¥æ± ä¼˜åŒ–**
```
åˆç†è®¾ç½®è¿æ¥æ± å¤§å°ï¼š
â€¢ æœ€å°è¿æ¥æ•° = æ ¸å¿ƒä¸šåŠ¡å¹¶å‘æ•°
â€¢ æœ€å¤§è¿æ¥æ•° = 2-3å€å³°å€¼å¹¶å‘æ•°
â€¢ é¿å…è¿æ¥æ•°è¿‡å¤šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§
```

âœ… **äº‹åŠ¡è¶…æ—¶ä¼˜åŒ–**  
```
è®¾ç½®åˆç†è¶…æ—¶æ—¶é—´ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦è®¾ç½®äº‹åŠ¡è¶…æ—¶
â€¢ ç®€å•æ“ä½œï¼š5-10ç§’
â€¢ å¤æ‚æ“ä½œï¼š30-60ç§’
â€¢ é¿å…è¶…æ—¶æ—¶é—´è¿‡é•¿å½±å“ç³»ç»Ÿå¯ç”¨æ€§
```

âœ… **æ‰¹å¤„ç†ä¼˜åŒ–**
```
å‡å°‘2PCäº‹åŠ¡æ¬¡æ•°ï¼š
â€¢ å°†å¤šä¸ªå°äº‹åŠ¡åˆå¹¶ä¸ºä¸€ä¸ªå¤§äº‹åŠ¡
â€¢ ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
â€¢ æ³¨æ„å¹³è¡¡äº‹åŠ¡å¤§å°å’Œé”å®šæ—¶é—´
```

> âš ï¸ **é‡è¦æé†’**  
> 2PCé€‚ç”¨äºå¼ºä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œå¦‚æœå¯¹æ€§èƒ½è¦æ±‚æé«˜ï¼Œå¯ä»¥è€ƒè™‘æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼ˆå¦‚Sagaæ¨¡å¼ï¼‰

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ 2PCæœ¬è´¨ï¼šåˆ†å¸ƒå¼äº‹åŠ¡çš„å¼ºä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ
ğŸ”¸ ä¸¤ä¸ªé˜¶æ®µï¼šå‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨ï¼‰+ æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œï¼‰
ğŸ”¸ ä¸¤ç§è§’è‰²ï¼šåè°ƒè€…ï¼ˆå†³ç­–è€…ï¼‰+ å‚ä¸è€…ï¼ˆæ‰§è¡Œè€…ï¼‰
ğŸ”¸ XAæ ‡å‡†ï¼šåˆ†å¸ƒå¼äº‹åŠ¡çš„å·¥ä¸šæ ‡å‡†å®ç°
ğŸ”¸ äº‹åŠ¡ç®¡ç†å™¨ï¼šAtomikosã€Bitronixç­‰ç¬¬ä¸‰æ–¹æ¡†æ¶
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦2PC**
```
å•æœºäº‹åŠ¡ï¼šACIDç‰¹æ€§åœ¨å•ä¸ªæ•°æ®åº“å†…ä¿è¯
åˆ†å¸ƒå¼ç¯å¢ƒï¼šå¤šä¸ªæ•°æ®åº“éœ€è¦åè°ƒä¸€è‡´æ€§
2PCä½œç”¨ï¼šå°†å•æœºäº‹åŠ¡çš„ACIDæ‰©å±•åˆ°åˆ†å¸ƒå¼ç¯å¢ƒ
å®é™…æ„ä¹‰ï¼šä¿è¯"è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥"
```

**ğŸ”¹ 2PCçš„é€‚ç”¨åœºæ™¯**
```
âœ… é€‚ç”¨æƒ…å†µï¼š
â€¢ é‡‘èè½¬è´¦ã€æ”¯ä»˜ä¸šåŠ¡
â€¢ æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜
â€¢ äº‹åŠ¡é¢‘ç‡ä¸æ˜¯ç‰¹åˆ«é«˜
â€¢ å¯ä»¥å®¹å¿ä¸€å®šçš„æ€§èƒ½æŸå¤±

âŒ ä¸é€‚ç”¨æƒ…å†µï¼š
â€¢ é«˜å¹¶å‘ã€é«˜æ€§èƒ½è¦æ±‚
â€¢ ç½‘ç»œç¯å¢ƒä¸ç¨³å®š
â€¢ å‚ä¸èŠ‚ç‚¹å¾ˆå¤šçš„æƒ…å†µ
â€¢ å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜
```

**ğŸ”¹ å®æ–½æ³¨æ„äº‹é¡¹**
```
æ•°æ®åº“æ”¯æŒï¼šç¡®ä¿æ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒXA
ç½‘ç»œç¨³å®šï¼šç½‘ç»œä¸ç¨³å®šä¼šå¯¼è‡´åè°ƒå¤±è´¥
èµ„æºè§„åˆ’ï¼šåˆç†é…ç½®è¿æ¥æ± å’Œè¶…æ—¶å‚æ•°
ç›‘æ§å‘Šè­¦ï¼šå»ºç«‹å®Œå–„çš„äº‹åŠ¡ç›‘æ§ä½“ç³»
å®¹é”™å¤„ç†ï¼šè€ƒè™‘åè°ƒè€…æ•…éšœçš„æ¢å¤æ–¹æ¡ˆ
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- **åœºæ™¯é€‰æ‹©**ï¼šä¼˜å…ˆåœ¨å¼ºä¸€è‡´æ€§è¦æ±‚çš„æ ¸å¿ƒä¸šåŠ¡ä¸­ä½¿ç”¨
- **å‚ä¸è€…æ•°é‡**ï¼šå»ºè®®æ§åˆ¶åœ¨2-4ä¸ªæ•°æ®åº“ä»¥å†…
- **äº‹åŠ¡å¤§å°**ï¼šå•ä¸ª2PCäº‹åŠ¡ä¸è¦åŒ…å«è¿‡å¤šæ“ä½œ
- **è¶…æ—¶è®¾ç½®**ï¼šæ ¹æ®ä¸šåŠ¡å¤æ‚åº¦åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- **ç›‘æ§è¿ç»´**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œæ•…éšœæ¢å¤æœºåˆ¶

**ğŸ¯ å­¦ä¹ è·¯å¾„å»ºè®®**
```
ç¬¬ä¸€æ­¥ï¼šç†è§£2PCåŸºæœ¬åŸç†å’Œæµç¨‹
ç¬¬äºŒæ­¥ï¼šæŒæ¡MySQL XAçš„åŸºæœ¬ä½¿ç”¨
ç¬¬ä¸‰æ­¥ï¼šå­¦ä¼šAtomikosçš„é…ç½®å’Œé›†æˆ
ç¬¬å››æ­¥ï¼šåœ¨Spring Bootä¸­å®ç°å®Œæ•´ç¤ºä¾‹
ç¬¬äº”æ­¥ï¼šå­¦ä¹ æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§æ–¹æ³•
ç¬¬å…­æ­¥ï¼šäº†è§£2PCçš„å±€é™æ€§å’Œæ›¿ä»£æ–¹æ¡ˆ
```

**ğŸ§  è®°å¿†å£è¯€**
```
ä¸¤é˜¶æ®µæäº¤ä¿ä¸€è‡´ï¼Œåè°ƒå‚ä¸å…±é…åˆ
å‡†å¤‡é˜¶æ®µå…ˆæŠ•ç¥¨ï¼Œæäº¤é˜¶æ®µå†æ‰§è¡Œ
XAæ ‡å‡†æ˜¯åŸºç¡€ï¼ŒAtomikosæ¥ç®¡ç†
å¼ºä¸€è‡´æ€§æœ‰ä¿éšœï¼Œæ€§èƒ½ä»£ä»·è¦è€ƒè™‘
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- 2PCæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ç»å…¸è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡ä¸¤é˜¶æ®µåè°ƒä¿è¯å¼ºä¸€è‡´æ€§
- é€‚ç”¨äºå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„ä¸šåŠ¡åœºæ™¯
- éœ€è¦åœ¨ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€æ€§èƒ½ä¹‹é—´åšæƒè¡¡
- å®æ–½æ—¶è¦å……åˆ†è€ƒè™‘ç½‘ç»œã€è¶…æ—¶ã€ç›‘æ§ç­‰å·¥ç¨‹é—®é¢˜