---
title: 4ã€TCCå¼‚å¸¸å¤„ç†ä¸é—®é¢˜è§£å†³
---
## ğŸ“š ç›®å½•

1. [TCCå¼‚å¸¸å¤„ç†æ¦‚è¿°](#1-TCCå¼‚å¸¸å¤„ç†æ¦‚è¿°)
2. [Tryé˜¶æ®µå¤±è´¥å¤„ç†](#2-Tryé˜¶æ®µå¤±è´¥å¤„ç†)
3. [Confirmé˜¶æ®µå¤±è´¥å¤„ç†](#3-Confirmé˜¶æ®µå¤±è´¥å¤„ç†)
4. [Cancelé˜¶æ®µå¤±è´¥å¤„ç†](#4-Cancelé˜¶æ®µå¤±è´¥å¤„ç†)
5. [æ‚¬æŒ‚é—®é¢˜è§£å†³](#5-æ‚¬æŒ‚é—®é¢˜è§£å†³)
6. [ç©ºå›æ»šé—®é¢˜](#6-ç©ºå›æ»šé—®é¢˜)
7. [è¡¥å¿é€»è¾‘è®¾è®¡](#7-è¡¥å¿é€»è¾‘è®¾è®¡)
8. [è¡¥å¿æ¥å£å®ç°](#8-è¡¥å¿æ¥å£å®ç°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ TCCå¼‚å¸¸å¤„ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯TCCå¼‚å¸¸å¤„ç†


**ğŸ’¡ ç®€å•ç†è§£**ï¼šå°±åƒåšèœæ—¶çš„åº”æ€¥å¤„ç†æ–¹æ¡ˆ
```
æ­£å¸¸æµç¨‹ï¼šå‡†å¤‡é£Ÿæ â†’ å¼€å§‹ç‚’èœ â†’ å®Œæˆå‡ºèœ
å¼‚å¸¸æƒ…å†µï¼šé£Ÿæä¸å¤Ÿ â†’ æ¢ä¸ªèœè°± â†’ é‡æ–°å¼€å§‹
```

**TCCå¼‚å¸¸å¤„ç†çš„æœ¬è´¨**ï¼š
- **é¢„é˜²é—®é¢˜**ï¼šåœ¨æ¯ä¸ªé˜¶æ®µéƒ½åšå¥½å‡†å¤‡å·¥ä½œ
- **å¿«é€Ÿæ¢å¤**ï¼šå‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿè¿…é€Ÿå¤„ç†
- **ä¿æŒä¸€è‡´**ï¼šç¡®ä¿æœ€ç»ˆæ•°æ®çŠ¶æ€æ­£ç¡®

### 1.2 å¸¸è§å¼‚å¸¸åœºæ™¯


**ğŸ”¸ ç½‘ç»œå¼‚å¸¸**
```
åœºæ™¯ï¼šè°ƒç”¨å…¶ä»–æœåŠ¡æ—¶ç½‘ç»œè¶…æ—¶
å½±å“ï¼šä¸çŸ¥é“æ“ä½œæ˜¯å¦æˆåŠŸ
å¤„ç†ï¼šé‡è¯•æœºåˆ¶ + å¹‚ç­‰æ€§ä¿è¯
```

**ğŸ”¸ æœåŠ¡å¼‚å¸¸** 
```
åœºæ™¯ï¼šç›®æ ‡æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
å½±å“ï¼šæ— æ³•å®Œæˆä¸šåŠ¡æ“ä½œ
å¤„ç†ï¼šç†”æ–­é™çº§ + å¼‚æ­¥è¡¥å¿
```

**ğŸ”¸ æ•°æ®å¼‚å¸¸**
```
åœºæ™¯ï¼šæ•°æ®çŠ¶æ€ä¸ä¸€è‡´
å½±å“ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯
å¤„ç†ï¼šçŠ¶æ€æ£€æŸ¥ + æ•°æ®ä¿®å¤
```

### 1.3 å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§


> âš ï¸ **å…³é”®è®¤çŸ¥**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¼‚å¸¸æ˜¯å¸¸æ€ï¼Œæ­£å¸¸æ˜¯æ„å¤–

**ä¸ºä»€ä¹ˆå¿…é¡»å¤„ç†å¼‚å¸¸ï¼Ÿ**
- **ğŸ¦ é‡‘èçº§è¦æ±‚**ï¼šé’±çš„é—®é¢˜ä¸èƒ½å‡ºé”™
- **ğŸ”„ ç³»ç»Ÿç¨³å®šæ€§**ï¼šä¸€ä¸ªç¯èŠ‚å‡ºé”™ä¸èƒ½å½±å“æ•´ä½“
- **ğŸ‘¥ ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·ä¸åº”è¯¥æ„Ÿå—åˆ°ç³»ç»Ÿå†…éƒ¨é—®é¢˜

---

## 2. ğŸ”§ Tryé˜¶æ®µå¤±è´¥å¤„ç†


### 2.1 Tryé˜¶æ®µå¤±è´¥çš„å«ä¹‰


**ç®€å•ç±»æ¯”**ï¼šåƒç½‘è´­ä¸‹å•æ—¶å‘ç°å•†å“åº“å­˜ä¸è¶³
```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»è´­ä¹°æŒ‰é’®
ç³»ç»Ÿæ£€æŸ¥ï¼šåº“å­˜æ˜¯å¦å……è¶³ã€ä½™é¢æ˜¯å¦å¤Ÿç”¨
å¤±è´¥æƒ…å†µï¼šåº“å­˜ä¸è¶³ or ä½™é¢ä¸å¤Ÿ
å¤„ç†æ–¹å¼ï¼šç›´æ¥å‘Šè¯‰ç”¨æˆ·å¤±è´¥åŸå› 
```

**ğŸ”¸ Tryå¤±è´¥çš„ç‰¹ç‚¹**
- **å½±å“èŒƒå›´å°**ï¼šè¿˜æ²¡å¼€å§‹çœŸæ­£çš„ä¸šåŠ¡æ“ä½œ
- **å¤„ç†ç®€å•**ï¼šç›´æ¥è¿”å›å¤±è´¥å³å¯
- **æ— éœ€è¡¥å¿**ï¼šå› ä¸ºä»€ä¹ˆéƒ½æ²¡åš

### 2.2 Tryé˜¶æ®µå¤±è´¥å¤„ç†ç­–ç•¥


**ğŸ“‹ å¤„ç†æ­¥éª¤**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tryæ“ä½œå¤±è´¥    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è®°å½•å¤±è´¥æ—¥å¿—  â”‚
â”‚ 2. é‡Šæ”¾é¢„å èµ„æº  â”‚
â”‚ 3. è¿”å›å¤±è´¥çŠ¶æ€  â”‚
â”‚ 4. é€šçŸ¥è°ƒç”¨æ–¹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
@TccTransaction
public class AccountTccService {
    
    @Try
    public boolean tryDeduct(String userId, BigDecimal amount) {
        try {
            // 1. æ£€æŸ¥è´¦æˆ·ä½™é¢
            if (!checkBalance(userId, amount)) {
                log.warn("ä½™é¢ä¸è¶³: userId={}, amount={}", userId, amount);
                return false;
            }
            
            // 2. é¢„æ‰£æ¬¾ï¼ˆå†»ç»“èµ„é‡‘ï¼‰
            freezeAmount(userId, amount);
            return true;
            
        } catch (Exception e) {
            log.error("Tryé˜¶æ®µå¤±è´¥", e);
            // 3. æ¸…ç†å¯èƒ½çš„ä¸­é—´çŠ¶æ€
            cleanupTryState(userId);
            return false;
        }
    }
}
```

### 2.3 Tryå¤±è´¥çš„æœ€ä½³å®è·µ


**ğŸ¯ æ ¸å¿ƒåŸåˆ™**
- **å¿«é€Ÿå¤±è´¥**ï¼šå‘ç°é—®é¢˜ç«‹å³è¿”å›ï¼Œä¸è¦å¼ºè¡Œç»§ç»­
- **çŠ¶æ€æ¸…ç†**ï¼šæ¸…é™¤Tryè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸­é—´çŠ¶æ€
- **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•å¤±è´¥åŸå› ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

---

## 3. âœ… Confirmé˜¶æ®µå¤±è´¥å¤„ç†


### 3.1 Confirmå¤±è´¥çš„ä¸¥é‡æ€§


**âš ï¸ ä¸ºä»€ä¹ˆConfirmå¤±è´¥å¾ˆéº»çƒ¦ï¼Ÿ**

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š
```
ä½ åœ¨é“¶è¡Œè½¬è´¦ï¼š
1. Tryé˜¶æ®µï¼šé’±å·²ç»ä»ä½ è´¦æˆ·å†»ç»“äº† âœ“
2. Confirmé˜¶æ®µï¼šè¦æŠŠé’±è½¬åˆ°å¯¹æ–¹è´¦æˆ· âŒ (å¤±è´¥)
ç»“æœï¼šä½ çš„é’±è¢«å†»ç»“ï¼Œä½†å¯¹æ–¹æ²¡æ”¶åˆ°é’±
```

**ğŸ”¸ Confirmå¤±è´¥çš„ç‰¹ç‚¹**
- **èµ„æºå·²é¢„å **ï¼šTryé˜¶æ®µå·²ç»é”å®šäº†èµ„æº
- **å¿…é¡»é‡è¯•**ï¼šä¸èƒ½ç®€å•æ”¾å¼ƒï¼Œå¦åˆ™æ•°æ®ä¸ä¸€è‡´
- **å½±å“é¢å¤§**ï¼šå¯èƒ½å½±å“å¤šä¸ªæœåŠ¡çš„çŠ¶æ€

### 3.2 Confirmå¤±è´¥å¤„ç†ç­–ç•¥


**ğŸ“Š å¤„ç†æµç¨‹å›¾**
```
Confirmå¤±è´¥
     â†“
æ£€æŸ¥å¤±è´¥åŸå› 
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç½‘ç»œè¶…æ—¶ â”‚ æœåŠ¡å¼‚å¸¸â”‚ æ•°æ®å¼‚å¸¸â”‚
â”‚         â”‚         â”‚         â”‚
â”‚ é‡è¯•æœºåˆ¶â”‚ å»¶è¿Ÿé‡è¯•â”‚ äººå·¥ä»‹å…¥â”‚
â”‚         â”‚         â”‚         â”‚
â”‚ æœ€ç»ˆä¸€è‡´â”‚ æœ€ç»ˆä¸€è‡´â”‚ æ‰‹åŠ¨ä¿®å¤â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”„ é‡è¯•æœºåˆ¶è®¾è®¡**
```java
@Component
public class ConfirmRetryHandler {
    
    // æŒ‡æ•°é€€é¿é‡è¯•
    private final int[] RETRY_DELAYS = {1, 2, 4, 8, 16, 30}; // ç§’
    
    @Retryable(maxAttempts = 6)
    public boolean confirmWithRetry(String transactionId) {
        try {
            return doConfirm(transactionId);
        } catch (NetworkException e) {
            // ç½‘ç»œå¼‚å¸¸ï¼Œå¯ä»¥é‡è¯•
            log.warn("ç½‘ç»œå¼‚å¸¸ï¼Œå‡†å¤‡é‡è¯•: {}", e.getMessage());
            throw e;
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œä¸é‡è¯•
            log.error("ä¸šåŠ¡å¼‚å¸¸ï¼Œåœæ­¢é‡è¯•: {}", e.getMessage());
            return false;
        }
    }
}
```

### 3.3 Confirmå¤±è´¥çš„è¡¥æ•‘æªæ–½


**ğŸš¨ å…œåº•æ–¹æ¡ˆ**
```
é‡è¯•å¤šæ¬¡ä»å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

æ–¹æ¡ˆ1ï¼šå¼‚æ­¥è¡¥å¿
- æ”¾å…¥è¡¥å¿é˜Ÿåˆ—
- åå°å®šæ—¶å¤„ç†
- äººå·¥ä»‹å…¥ç¡®è®¤

æ–¹æ¡ˆ2ï¼šæœ€ç»ˆä¸€è‡´æ€§
- æ ‡è®°ä¸º"å¾…ç¡®è®¤"çŠ¶æ€
- å®šæœŸå¯¹è´¦æ£€æŸ¥
- è‡ªåŠ¨æˆ–æ‰‹åŠ¨ä¿®å¤

æ–¹æ¡ˆ3ï¼šä¸šåŠ¡é™çº§
- æš‚æ—¶å…è®¸ä¸ä¸€è‡´
- åç»­æ‰¹é‡å¤„ç†
- ç”¨æˆ·æ— æ„ŸçŸ¥
```

---

## 4. âŒ Cancelé˜¶æ®µå¤±è´¥å¤„ç†


### 4.1 Cancelå¤±è´¥çš„å½±å“


**ğŸ¤” Cancelä¸ºä»€ä¹ˆä¼šå¤±è´¥ï¼Ÿ**

ç»§ç»­é“¶è¡Œè½¬è´¦çš„ä¾‹å­ï¼š
```
è½¬è´¦è¿‡ç¨‹ä¸­æŸä¸ªæœåŠ¡å‡ºé”™äº†ï¼š
1. Tryé˜¶æ®µï¼šä½ çš„é’±è¢«å†»ç»“ âœ“
2. å…¶ä»–æœåŠ¡å‡ºé”™ï¼Œéœ€è¦å–æ¶ˆæ•´ä¸ªäº‹åŠ¡
3. Cancelé˜¶æ®µï¼šè¦è§£å†»ä½ çš„é’± âŒ (å¤±è´¥)
ç»“æœï¼šä½ çš„é’±ä¸€ç›´è¢«å†»ç»“ï¼Œæ— æ³•ä½¿ç”¨
```

**ğŸ”¸ Cancelå¤±è´¥çš„å±å®³**
- **èµ„æºæ³„éœ²**ï¼šé¢„å çš„èµ„æºæ— æ³•é‡Šæ”¾
- **ç”¨æˆ·ä½“éªŒå·®**ï¼šé’±è¢«è«åå†»ç»“
- **æ•°æ®ä¸ä¸€è‡´**ï¼šç³»ç»ŸçŠ¶æ€æ··ä¹±

### 4.2 Cancelå¤±è´¥å¤„ç†ç­–ç•¥


**ğŸ“ˆ å¤„ç†ä¼˜å…ˆçº§**
```
Cancelå¤±è´¥å¤„ç†ç­–ç•¥ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰ï¼š

ğŸ”´ P0ï¼šèµ„é‡‘ç›¸å…³
- ç«‹å³äººå·¥ä»‹å…¥
- å®æ—¶ç›‘æ§æŠ¥è­¦
- ç´§æ€¥å¤„ç†æµç¨‹

ğŸŸ¡ P1ï¼šä¸šåŠ¡èµ„æº
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- å¼‚æ­¥è¡¥å¿å¤„ç†
- å®šæ—¶æ£€æŸ¥ä¿®å¤

ğŸŸ¢ P2ï¼šä¸´æ—¶çŠ¶æ€
- åå°æ‰¹é‡å¤„ç†
- å®šæœŸæ¸…ç†è„šæœ¬
- ç”¨æˆ·æ— æ„ŸçŸ¥
```

**ğŸ’» å®ç°ç¤ºä¾‹**
```java
@Service
public class CancelFailureHandler {
    
    @Async("cancelExecutor")
    public void handleCancelFailure(String transactionId, Exception error) {
        
        CancelTask task = CancelTask.builder()
            .transactionId(transactionId)
            .failureReason(error.getMessage())
            .retryCount(0)
            .maxRetries(10)
            .nextRetryTime(LocalDateTime.now().plusMinutes(1))
            .build();
            
        // ä¿å­˜åˆ°é‡è¯•é˜Ÿåˆ—
        cancelRetryQueue.save(task);
        
        // æ ¹æ®é”™è¯¯ç±»å‹åˆ†ç±»å¤„ç†
        if (error instanceof CriticalException) {
            // å…³é”®å¼‚å¸¸ï¼Œç«‹å³æŠ¥è­¦
            alertService.sendUrgentAlert("Cancelå¤±è´¥", transactionId);
        }
    }
    
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void retryFailedCancels() {
        List<CancelTask> tasks = cancelRetryQueue.findReadyTasks();
        
        for (CancelTask task : tasks) {
            try {
                boolean success = doCancel(task.getTransactionId());
                if (success) {
                    cancelRetryQueue.remove(task);
                } else {
                    task.incrementRetryCount();
                    if (task.getRetryCount() >= task.getMaxRetries()) {
                        // è½¬äººå·¥å¤„ç†
                        manualProcessQueue.add(task);
                    }
                }
            } catch (Exception e) {
                log.error("é‡è¯•Cancelå¤±è´¥", e);
            }
        }
    }
}
```

---

## 5. ğŸª æ‚¬æŒ‚é—®é¢˜è§£å†³


### 5.1 ä»€ä¹ˆæ˜¯æ‚¬æŒ‚é—®é¢˜


**ğŸ­ ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
ä½ æ‰“ç”µè¯è®¢å¤–å–ï¼š
1. æ‹¨æ‰“ç”µè¯ â†’ ç½‘ç»œä¸å¥½ï¼Œä»¥ä¸ºæ²¡æ¥é€š
2. é‡æ–°æ‹¨æ‰“ â†’ è¿™æ¬¡æ¥é€šäº†ï¼ŒæˆåŠŸä¸‹å•
3. ç»“æœï¼šç¬¬ä¸€ä¸ªç”µè¯å…¶å®æ¥é€šäº†ï¼Œå•†å®¶æ¥äº†ä¸¤ä¸ªç›¸åŒçš„è®¢å•
```

**ğŸ’¡ æ‚¬æŒ‚é—®é¢˜çš„æœ¬è´¨**
- **ç½‘ç»œå»¶è¿Ÿ**ï¼šä»¥ä¸ºæ“ä½œå¤±è´¥ï¼Œå…¶å®æˆåŠŸäº†
- **é‡å¤æ“ä½œ**ï¼šé‡æ–°å‘èµ·äº†ç›¸åŒçš„æ“ä½œ
- **çŠ¶æ€æ··ä¹±**ï¼šç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªç›¸åŒçš„äº‹åŠ¡

### 5.2 æ‚¬æŒ‚é—®é¢˜çš„åœºæ™¯


**ğŸ“± å…¸å‹åœºæ™¯åˆ†æ**
```
æ—¶é—´è½´ï¼š
T1: å‘èµ·Tryè¯·æ±‚ â†’ ç½‘ç»œè¶…æ—¶
T2: åˆ¤æ–­Tryå¤±è´¥ â†’ å‘èµ·Cancel
T3: CancelæˆåŠŸæ‰§è¡Œ
T4: å»¶è¿Ÿçš„Tryè¯·æ±‚åˆ°è¾¾ â†’ æ‰§è¡ŒæˆåŠŸï¼ˆæ‚¬æŒ‚ï¼‰

ç»“æœçŠ¶æ€ï¼š
- äº‹åŠ¡ç®¡ç†å™¨è®¤ä¸ºï¼šå·²å–æ¶ˆ âŒ
- ä¸šåŠ¡æœåŠ¡è®¤ä¸ºï¼šå·²é¢„ç•™ âœ…
- å®é™…çŠ¶æ€ï¼šä¸ä¸€è‡´ï¼
```

### 5.3 æ‚¬æŒ‚é—®é¢˜è§£å†³æ–¹æ¡ˆ


**ğŸ” é˜²æ‚¬æŒ‚æœºåˆ¶**
```java
@Service
public class HangingPreventionService {
    
    // äº‹åŠ¡çŠ¶æ€è¡¨
    @Autowired
    private TransactionLogRepository logRepo;
    
    @Try
    public boolean tryWithHangingPrevention(String transactionId) {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»Cancelè¿‡
        TransactionLog log = logRepo.findByTransactionId(transactionId);
        if (log != null && log.getStatus() == TransactionStatus.CANCELED) {
            log.warn("é˜²æ‚¬æŒ‚ï¼šäº‹åŠ¡å·²è¢«å–æ¶ˆï¼Œæ‹’ç»Tryæ“ä½œ transactionId={}", transactionId);
            return false; // æ‹’ç»æ‰§è¡Œ
        }
        
        // 2. è®°å½•Tryæ“ä½œ
        logRepo.save(TransactionLog.builder()
            .transactionId(transactionId)
            .status(TransactionStatus.TRYING)
            .operationType("TRY")
            .timestamp(System.currentTimeMillis())
            .build());
            
        // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        return doBusiness();
    }
    
    @Cancel
    public boolean cancelWithHangingPrevention(String transactionId) {
        
        // è®°å½•Cancelæ“ä½œï¼ˆå³ä½¿Tryè¿˜æ²¡æ‰§è¡Œä¹Ÿè¦è®°å½•ï¼‰
        logRepo.save(TransactionLog.builder()
            .transactionId(transactionId)
            .status(TransactionStatus.CANCELED)
            .operationType("CANCEL")
            .timestamp(System.currentTimeMillis())
            .build());
            
        // æ‰§è¡Œå–æ¶ˆé€»è¾‘
        return doCancel();
    }
}
```

**ğŸ“Š é˜²æ‚¬æŒ‚çŠ¶æ€æœº**
```
çŠ¶æ€è½¬æ¢å›¾ï¼š
        åˆå§‹çŠ¶æ€
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç©ºçŠ¶æ€    â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚     â”‚
    Tryâ”‚     â”‚Cancel
       â†“     â†“
   â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚TRYINGâ”‚ â”‚CANCELEDâ”‚
   â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â†‘
    Confirm/    â”‚
    Cancel      â”‚
       â†“        â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚CONFIRMEDâ”‚  â”‚
   â”‚   æˆ–    â”‚â”€â”€â”˜
   â”‚CANCELED â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§„åˆ™ï¼šä¸€æ—¦è¿›å…¥CANCELEDçŠ¶æ€ï¼Œå°±ä¸èƒ½å†Try
```

---

## 6. ğŸ•³ï¸ ç©ºå›æ»šé—®é¢˜


### 6.1 ä»€ä¹ˆæ˜¯ç©ºå›æ»š


**ğŸª é­”æœ¯è¡¨æ¼”çš„æ¯”å–»**ï¼š
```
é­”æœ¯å¸ˆè¦å˜å…”å­ï¼š
1. å‡†å¤‡é˜¶æ®µï¼šæ‰“å¼€ç©ºå¸½å­ (Tryå¤±è´¥)
2. è§‚ä¼—è¯´ï¼šç®—äº†ï¼Œä¸çœ‹äº† (è¦æ±‚Cancel)
3. é­”æœ¯å¸ˆï¼šæˆ‘è¦æŠŠå…”å­æ”¶å›å»... (ä½†å¸½å­æœ¬æ¥å°±æ˜¯ç©ºçš„ï¼)
```

**ğŸ”¸ ç©ºå›æ»šçš„å®šä¹‰**
- **Tryé˜¶æ®µå¤±è´¥**ï¼šæ²¡æœ‰é¢„å ä»»ä½•èµ„æº
- **Cancelè¢«è°ƒç”¨**ï¼šäº‹åŠ¡ç®¡ç†å™¨è¦æ±‚å›æ»š
- **æ— æ³•å›æ»š**ï¼šå› ä¸ºæ²¡æœ‰ä¸œè¥¿å¯ä»¥å›æ»š

### 6.2 ç©ºå›æ»šçš„å±å®³


**âŒ ä¸ºä»€ä¹ˆç©ºå›æ»šæ˜¯é—®é¢˜ï¼Ÿ**
```
åœºæ™¯ï¼šè½¬è´¦æ“ä½œ
1. Tryæ‰£æ¬¾ï¼šå› ä¸ºç½‘ç»œé—®é¢˜å¤±è´¥ï¼Œå®é™…æ²¡æ‰£åˆ°é’±
2. TMå‘ç°å¤±è´¥ï¼šè°ƒç”¨Cancelè¦æ±‚å›æ»š
3. Cancelæ‰§è¡Œï¼šå°è¯•é€€é’±ç»™ç”¨æˆ·
4. ç»“æœï¼šç”¨æˆ·è«åå…¶å¦™å¤šäº†ä¸€ç¬”é’±ï¼
```

**ğŸš¨ å®é™…å½±å“**
- **èµ„é‡‘æŸå¤±**ï¼šå¯èƒ½é€ æˆèµ„é‡‘é”™è¯¯å¢åŠ 
- **æ•°æ®é”™ä¹±**ï¼šç³»ç»ŸçŠ¶æ€ä¸ä¸€è‡´
- **å®¡è®¡é—®é¢˜**ï¼šè´¢åŠ¡å¯¹è´¦å›°éš¾

### 6.3 ç©ºå›æ»šè§£å†³æ–¹æ¡ˆ


**âœ… ç©ºå›æ»šæ£€æŸ¥æœºåˆ¶**
```java
@Service
public class EmptyRollbackPreventionService {
    
    @Cancel
    public boolean cancelWithEmptyCheck(String transactionId) {
        
        // 1. æ£€æŸ¥Tryæ˜¯å¦çœŸæ­£æ‰§è¡ŒæˆåŠŸè¿‡
        TransactionLog tryLog = logRepo.findByTransactionIdAndType(
            transactionId, "TRY");
            
        if (tryLog == null || tryLog.getStatus() != TransactionStatus.SUCCESS) {
            log.info("ç©ºå›æ»šæ£€æŸ¥ï¼šTryæœªæˆåŠŸæ‰§è¡Œï¼Œæ— éœ€Cancel transactionId={}", 
                transactionId);
            
            // è®°å½•ç©ºå›æ»šæ—¥å¿—ä½†ä¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            logRepo.save(TransactionLog.builder()
                .transactionId(transactionId)
                .status(TransactionStatus.CANCELED)
                .operationType("EMPTY_CANCEL")
                .remark("ç©ºå›æ»šï¼Œæ— å®é™…æ“ä½œ")
                .build());
                
            return true; // è¿”å›æˆåŠŸï¼Œä½†å®é™…æ²¡åšä»»ä½•äº‹
        }
        
        // 2. TryæˆåŠŸè¿‡ï¼Œæ­£å¸¸æ‰§è¡ŒCancel
        return doRealCancel(transactionId);
    }
}
```

**ğŸ“‹ ç©ºå›æ»šåˆ¤æ–­é€»è¾‘**
```
ç©ºå›æ»šåˆ¤æ–­æµç¨‹ï¼š

æ¥æ”¶Cancelè¯·æ±‚
       â†“
æŸ¥è¯¢Tryæ‰§è¡Œè®°å½•
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Tryè®°å½•æ˜¯å¦å­˜åœ¨ï¼Ÿâ”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
   â”‚NO      â”‚YES
   â†“        â†“
è®°å½•ç©ºå›æ»š   æ£€æŸ¥TryçŠ¶æ€
è¿”å›æˆåŠŸ     â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚TryæˆåŠŸï¼Ÿ â”‚
          â””â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
           â”‚NO  â”‚YES
           â†“    â†“
        è®°å½•ç©ºå›æ»š æ‰§è¡ŒçœŸå®Cancel
        è¿”å›æˆåŠŸ   å®Œæˆå›æ»š
```

---

## 7. ğŸ”§ è¡¥å¿é€»è¾‘è®¾è®¡


### 7.1 è¡¥å¿é€»è¾‘çš„æ ¸å¿ƒæ€æƒ³


**ğŸ¥ åŒ»ç–—æ€¥æ•‘çš„ç±»æ¯”**ï¼š
```
ç—…äººæƒ…å†µæ¶åŒ–ï¼š
1. ä¸»æ²»ç–—æ–¹æ¡ˆå¤±æ•ˆ
2. å¯åŠ¨åº”æ€¥é¢„æ¡ˆ
3. ç¨³å®šç—…äººçŠ¶æ€
4. å¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆ
```

**ğŸ’¡ è¡¥å¿é€»è¾‘å°±æ˜¯ä¸šåŠ¡ç³»ç»Ÿçš„"åº”æ€¥é¢„æ¡ˆ"**
- **ç›®æ ‡**ï¼šè®©ç³»ç»Ÿå›åˆ°ä¸€è‡´çŠ¶æ€
- **åŸåˆ™**ï¼šå®å¯å¤šåšï¼Œä¸å¯å°‘åš
- **ç­–ç•¥**ï¼šä»ä¸šåŠ¡è§’åº¦è§£å†³æŠ€æœ¯é—®é¢˜

### 7.2 è¡¥å¿ç­–ç•¥åˆ†ç±»


**ğŸ“Š è¡¥å¿ç­–ç•¥çŸ©é˜µ**

| åœºæ™¯ç±»å‹ | **è¡¥å¿ç­–ç•¥** | **å®ç°æ–¹å¼** | **é€‚ç”¨æƒ…å†µ** |
|---------|-------------|-------------|-------------|
| ğŸŸ¢ **ç®€å•è¡¥å¿** | `ç›´æ¥å›æ»š` | `é€†å‘æ“ä½œ` | `å•ä¸€æœåŠ¡ï¼Œæ“ä½œå¯é€†` |
| ğŸŸ¡ **å¤æ‚è¡¥å¿** | `çŠ¶æ€ä¿®å¤` | `å¤šæ­¥éª¤å¤„ç†` | `å¤šæœåŠ¡è°ƒç”¨ï¼Œæœ‰ä¾èµ–` |
| ğŸ”´ **ä¸šåŠ¡è¡¥å¿** | `æ›¿ä»£æ–¹æ¡ˆ` | `ä¸šåŠ¡æµç¨‹è¡¥æ•‘` | `æ“ä½œä¸å¯é€†ï¼Œéœ€ä¸šåŠ¡è§£å†³` |

### 7.3 è¡¥å¿é€»è¾‘è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡æ ¸å¿ƒåŸåˆ™**

**1. å¹‚ç­‰æ€§**
```java
// âŒ é”™è¯¯çš„è¡¥å¿é€»è¾‘
public void compensateRefund(String orderId) {
    Account account = getAccount(userId);
    account.setBalance(account.getBalance() + refundAmount); // å¤šæ¬¡æ‰§è¡Œä¼šé‡å¤é€€æ¬¾
}

// âœ… æ­£ç¡®çš„è¡¥å¿é€»è¾‘  
public void compensateRefund(String orderId) {
    RefundRecord record = refundRecordRepo.findByOrderId(orderId);
    if (record != null && record.getStatus() == RefundStatus.SUCCESS) {
        log.info("è®¢å•{}å·²é€€æ¬¾ï¼Œè·³è¿‡é‡å¤æ“ä½œ", orderId);
        return;
    }
    
    // æ‰§è¡Œé€€æ¬¾å¹¶è®°å½•
    doRefund(orderId);
    saveRefundRecord(orderId, RefundStatus.SUCCESS);
}
```

**2. å¯è§‚æµ‹æ€§**
```java
@Component
public class CompensationMonitor {
    
    public void executeCompensation(String transactionId, Runnable compensation) {
        
        CompensationLog log = CompensationLog.builder()
            .transactionId(transactionId)
            .startTime(LocalDateTime.now())
            .status(CompensationStatus.RUNNING)
            .build();
            
        compensationLogRepo.save(log);
        
        try {
            compensation.run();
            log.setStatus(CompensationStatus.SUCCESS);
            log.setEndTime(LocalDateTime.now());
        } catch (Exception e) {
            log.setStatus(CompensationStatus.FAILED);
            log.setErrorMessage(e.getMessage());
            log.setEndTime(LocalDateTime.now());
            
            // å‘é€æŠ¥è­¦
            alertService.sendAlert("è¡¥å¿é€»è¾‘æ‰§è¡Œå¤±è´¥", transactionId);
        } finally {
            compensationLogRepo.save(log);
        }
    }
}
```

---

## 8. ğŸ”Œ è¡¥å¿æ¥å£å®ç°


### 8.1 è¡¥å¿æ¥å£è®¾è®¡è§„èŒƒ


**ğŸ“ æ¥å£è®¾è®¡æ ‡å‡†**
```java
public interface CompensationService {
    
    /**
     * è¡¥å¿æ“ä½œæ¥å£
     * @param transactionId äº‹åŠ¡ID  
     * @param context è¡¥å¿ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«åŸå§‹æ“ä½œä¿¡æ¯ï¼‰
     * @return è¡¥å¿ç»“æœ
     */
    CompensationResult compensate(String transactionId, CompensationContext context);
    
    /**
     * æ£€æŸ¥è¡¥å¿çŠ¶æ€
     * @param transactionId äº‹åŠ¡ID
     * @return è¡¥å¿çŠ¶æ€
     */
    CompensationStatus getCompensationStatus(String transactionId);
    
    /**
     * é‡è¯•è¡¥å¿æ“ä½œ
     * @param transactionId äº‹åŠ¡ID
     * @return é‡è¯•ç»“æœ  
     */
    CompensationResult retryCompensation(String transactionId);
}
```

### 8.2 å®é™…è¡¥å¿æ¥å£å®ç°


**ğŸ’» è®¢å•è¡¥å¿æœåŠ¡å®ç°**
```java
@Service
@Slf4j
public class OrderCompensationService implements CompensationService {
    
    @Override
    public CompensationResult compensate(String transactionId, CompensationContext context) {
        
        try {
            // 1. è·å–åŸå§‹è®¢å•ä¿¡æ¯
            OrderInfo originalOrder = context.getOriginalOrder();
            
            // 2. æ ¹æ®è®¢å•çŠ¶æ€å†³å®šè¡¥å¿ç­–ç•¥
            switch (originalOrder.getStatus()) {
                case PAID:
                    return compensatePaidOrder(originalOrder);
                case SHIPPED:  
                    return compensateShippedOrder(originalOrder);
                case DELIVERED:
                    return compensateDeliveredOrder(originalOrder);
                default:
                    return CompensationResult.success("æ— éœ€è¡¥å¿");
            }
            
        } catch (Exception e) {
            log.error("è®¢å•è¡¥å¿å¤±è´¥ transactionId={}", transactionId, e);
            return CompensationResult.failure(e.getMessage());
        }
    }
    
    private CompensationResult compensatePaidOrder(OrderInfo order) {
        // å·²æ”¯ä»˜è®¢å•ï¼šé€€æ¬¾ + å–æ¶ˆè®¢å•
        
        // 1. è°ƒç”¨æ”¯ä»˜ç³»ç»Ÿé€€æ¬¾
        RefundResult refundResult = paymentService.refund(
            order.getPaymentId(), order.getTotalAmount());
            
        if (!refundResult.isSuccess()) {
            return CompensationResult.failure("é€€æ¬¾å¤±è´¥: " + refundResult.getMessage());
        }
        
        // 2. æ›´æ–°è®¢å•çŠ¶æ€
        orderService.updateStatus(order.getOrderId(), OrderStatus.REFUNDED);
        
        // 3. æ¢å¤åº“å­˜
        inventoryService.restoreStock(order.getItems());
        
        return CompensationResult.success("å·²é€€æ¬¾å¹¶å–æ¶ˆè®¢å•");
    }
    
    private CompensationResult compensateShippedOrder(OrderInfo order) {
        // å·²å‘è´§è®¢å•ï¼šè”ç³»ç‰©æµæ‹¦æˆª + å®‰æ’é€€æ¬¾
        
        // 1. å°è¯•æ‹¦æˆªç‰©æµ
        InterceptResult interceptResult = logisticsService.interceptPackage(order.getTrackingNumber());
        
        if (interceptResult.isSuccess()) {
            // æ‹¦æˆªæˆåŠŸï¼ŒæŒ‰å·²æ”¯ä»˜è®¢å•å¤„ç†
            return compensatePaidOrder(order);
        } else {
            // æ‹¦æˆªå¤±è´¥ï¼Œè®°å½•å¾…å¤„ç†ä»»åŠ¡
            manualTaskService.createTask(ManualTask.builder()
                .orderId(order.getOrderId())
                .taskType(TaskType.PACKAGE_RETURN)
                .description("åŒ…è£¹å·²å‘è´§æ— æ³•æ‹¦æˆªï¼Œéœ€å®‰æ’é€€è´§é€€æ¬¾")
                .priority(TaskPriority.HIGH)
                .build());
                
            return CompensationResult.success("å·²åˆ›å»ºäººå·¥å¤„ç†ä»»åŠ¡");
        }
    }
}
```

### 8.3 è¡¥å¿æ¥å£çš„é«˜çº§ç‰¹æ€§


**ğŸ”„ è‡ªåŠ¨é‡è¯•æœºåˆ¶**
```java
@Component
public class RetryableCompensationService {
    
    @Retryable(
        value = {RetryableException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public CompensationResult compensateWithRetry(String transactionId, CompensationContext context) {
        
        try {
            return doCompensation(transactionId, context);
        } catch (NetworkException | TimeoutException e) {
            // ç½‘ç»œç›¸å…³å¼‚å¸¸ï¼Œå¯é‡è¯•
            throw new RetryableException("ç½‘ç»œå¼‚å¸¸ï¼Œé‡è¯•ä¸­: " + e.getMessage(), e);
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œä¸é‡è¯•  
            return CompensationResult.failure("ä¸šåŠ¡å¼‚å¸¸: " + e.getMessage());
        }
    }
    
    @Recover
    public CompensationResult recover(RetryableException e, String transactionId, CompensationContext context) {
        // é‡è¯•å¤±è´¥åçš„é™çº§å¤„ç†
        log.error("è¡¥å¿é‡è¯•å¤±è´¥ï¼Œè½¬å…¥äººå·¥å¤„ç† transactionId={}", transactionId, e);
        
        // åˆ›å»ºäººå·¥å¤„ç†ä»»åŠ¡
        createManualTask(transactionId, context, e.getMessage());
        
        return CompensationResult.failure("é‡è¯•å¤±è´¥ï¼Œå·²è½¬äººå·¥å¤„ç†");
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¼‚å¸¸å¤„ç†ä¸‰åŸåˆ™ï¼šé¢„é˜²ä¸ºä¸»ã€å¿«é€Ÿæ¢å¤ã€ä¿æŒä¸€è‡´
ğŸ”¸ ä¸‰é˜¶æ®µå¤±è´¥ç‰¹ç‚¹ï¼šTryå¤±è´¥å½±å“å°ã€Confirmå¤±è´¥å¿…é¡»å¤„ç†ã€Cancelå¤±è´¥å¾ˆå±é™©  
ğŸ”¸ ä¸¤å¤§ç»å…¸é—®é¢˜ï¼šæ‚¬æŒ‚é—®é¢˜(ç½‘ç»œå»¶è¿Ÿå¯¼è‡´)ã€ç©ºå›æ»šé—®é¢˜(Tryå¤±è´¥ä½†Cancelæ‰§è¡Œ)
ğŸ”¸ è¡¥å¿é€»è¾‘è®¾è®¡ï¼šå¹‚ç­‰æ€§ã€å¯è§‚æµ‹æ€§ã€ä¸šåŠ¡å¯¼å‘
ğŸ”¸ è¡¥å¿æ¥å£è§„èŒƒï¼šæ ‡å‡†åŒ–æ¥å£ã€é‡è¯•æœºåˆ¶ã€é™çº§å¤„ç†
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„æœ¬è´¨**
```
ä¸æ˜¯ä¸ºäº†é¿å…å¼‚å¸¸ï¼Œè€Œæ˜¯ï¼š
- è®©å¼‚å¸¸å¯é¢„æœŸ
- è®©å¼‚å¸¸å¯å¤„ç†  
- è®©å¼‚å¸¸ä¸å½±å“æ•´ä½“ä¸šåŠ¡
```

**ğŸ”¹ è¡¥å¿vså›æ»šçš„åŒºåˆ«**
```
å›æ»šï¼šæŠ€æœ¯æ‰‹æ®µï¼Œæ¢å¤åˆ°ä¹‹å‰çŠ¶æ€
è¡¥å¿ï¼šä¸šåŠ¡æ‰‹æ®µï¼Œè¾¾åˆ°æœŸæœ›æ•ˆæœ

ä¾‹å­ï¼š
- å›æ»šï¼šæŠŠæ‰£æ‰çš„é’±åŠ å›æ¥
- è¡¥å¿ï¼šç”¨å…¶ä»–æ–¹å¼è®©ç”¨æˆ·æ»¡æ„(å¦‚ç§¯åˆ†ã€ä¼˜æƒ åˆ¸)
```

**ğŸ”¹ ä¸ºä»€ä¹ˆTCCå¼‚å¸¸å¤„ç†å¤æ‚**
```
æ ¹æœ¬åŸå› ï¼šåˆ†å¸ƒå¼ç¯å¢ƒçš„ä¸ç¡®å®šæ€§
- ç½‘ç»œå¯èƒ½å»¶è¿Ÿã€ä¸­æ–­
- æœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨
- æ•°æ®çŠ¶æ€å¯èƒ½ä¸åŒæ­¥
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ å¼€å‘å»ºè®®**
- **å¼‚å¸¸ä¼˜å…ˆ**ï¼šå…ˆè€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œå†å†™æ­£å¸¸é€»è¾‘
- **çŠ¶æ€æœºé©±åŠ¨**ï¼šç”¨çŠ¶æ€æœºç®¡ç†å¤æ‚çš„å¼‚å¸¸å¤„ç†æµç¨‹
- **ç›‘æ§å‘Šè­¦**ï¼šå…³é”®å¼‚å¸¸å¿…é¡»æœ‰å®æ—¶ç›‘æ§
- **äººå·¥å…œåº•**ï¼šæŠ€æœ¯æ— æ³•è§£å†³çš„é—®é¢˜è¦æœ‰äººå·¥å¤„ç†æœºåˆ¶

**âš ï¸ å¸¸è§è¯¯åŒº**
```
âŒ è®¤ä¸ºç½‘ç»œè°ƒç”¨ä¸€å®šä¼šæˆåŠŸ
âŒ å¿½ç•¥å¹‚ç­‰æ€§è®¾è®¡
âŒ å¼‚å¸¸å¤„ç†é€»è¾‘è¿‡äºå¤æ‚
âŒ ç¼ºä¹ç›‘æ§å’Œå¯è§‚æµ‹æ€§
```

**âœ… æœ€ä½³å®è·µ**
```
âœ“ å‡è®¾ä¸€åˆ‡è°ƒç”¨éƒ½å¯èƒ½å¤±è´¥
âœ“ æ¯ä¸ªæ“ä½œéƒ½è€ƒè™‘å¹‚ç­‰æ€§
âœ“ å¼‚å¸¸å¤„ç†é€»è¾‘è¦ç®€å•æ˜ç¡®
âœ“ å®Œå–„çš„æ—¥å¿—å’Œç›‘æ§ä½“ç³»
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- TCCå¼‚å¸¸ä¸‰æ­¥èµ°ï¼šé¢„é˜²é—®é¢˜ã€å¿«é€Ÿæ¢å¤ã€ä¿æŒä¸€è‡´
- æ‚¬æŒ‚ç©ºå›æ»šï¼šç½‘ç»œå»¶è¿Ÿè¦é˜²æ‚¬æŒ‚ã€Tryå¤±è´¥é˜²ç©ºæ»š  
- è¡¥å¿é€»è¾‘é‡‘ä¸‰è§’ï¼šå¹‚ç­‰æ€§ã€å¯è§‚æµ‹ã€ä¸šåŠ¡å¯¼å‘
- å¼‚å¸¸å¤„ç†ä¸å¯æ€•ï¼šç›‘æ§åˆ°ä½ã€å…œåº•æ–¹æ¡ˆã€äººå·¥ä»‹å…¥