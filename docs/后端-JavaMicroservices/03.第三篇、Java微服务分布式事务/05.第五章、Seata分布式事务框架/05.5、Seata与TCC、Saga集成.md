---
title: 5ã€Seataä¸TCCã€Sagaé›†æˆ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯TCCå’ŒSagaæ¨¡å¼](#1-ä»€ä¹ˆæ˜¯TCCå’ŒSagaæ¨¡å¼)
2. [Seataå¦‚ä½•æ”¯æŒTCCæ¨¡å¼](#2-Seataå¦‚ä½•æ”¯æŒTCCæ¨¡å¼)
3. [Seataå¦‚ä½•æ”¯æŒSagaæ¨¡å¼](#3-Seataå¦‚ä½•æ”¯æŒSagaæ¨¡å¼)
4. [æ¥å£å®šä¹‰ä¸å®ç°](#4-æ¥å£å®šä¹‰ä¸å®ç°)
5. [è¡¥å¿é€»è¾‘è®¾è®¡](#5-è¡¥å¿é€»è¾‘è®¾è®¡)
6. [çŠ¶æ€æœºé©±åŠ¨æœºåˆ¶](#6-çŠ¶æ€æœºé©±åŠ¨æœºåˆ¶)
7. [å¤šæ¨¡å¼é€‚é…ç­–ç•¥](#7-å¤šæ¨¡å¼é€‚é…ç­–ç•¥)
8. [ä¸šåŠ¡è§£è€¦æœ€ä½³å®è·µ](#8-ä¸šåŠ¡è§£è€¦æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯TCCå’ŒSagaæ¨¡å¼


### 1.1 TCCæ¨¡å¼é€šä¿—ç†è§£


**ğŸ”¸ TCCå°±åƒé¢„çº¦å’Œç¡®è®¤**
```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
ä½ è¦ä¹°æ¼”å”±ä¼šé—¨ç¥¨ï¼Œæµç¨‹æ˜¯ï¼š
1ï¸âƒ£ Tryï¼ˆå°è¯•ï¼‰ï¼šå…ˆé¢„è®¢åº§ä½ï¼Œé’±æš‚æ—¶å†»ç»“
2ï¸âƒ£ Confirmï¼ˆç¡®è®¤ï¼‰ï¼šç¡®å®šè´­ä¹°ï¼Œé’±çœŸæ­£æ‰£é™¤
3ï¸âƒ£ Cancelï¼ˆå–æ¶ˆï¼‰ï¼šå–æ¶ˆè®¢å•ï¼Œé’±é€€å›è´¦æˆ·

æŠ€æœ¯å¯¹åº”ï¼š
1ï¸âƒ£ Tryï¼šé¢„ç•™èµ„æºï¼Œæ£€æŸ¥ä¸šåŠ¡è§„åˆ™
2ï¸âƒ£ Confirmï¼šçœŸæ­£æ‰§è¡Œä¸šåŠ¡æ“ä½œ
3ï¸âƒ£ Cancelï¼šé‡Šæ”¾èµ„æºï¼Œå›æ»šæ“ä½œ
```

**ğŸ’¡ TCCæ¨¡å¼ç‰¹ç‚¹**
- **å¼ºä¸€è‡´æ€§**ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- **èµ„æºé¢„ç•™**ï¼šå…ˆé”å®šèµ„æºï¼Œå†å†³å®šæ˜¯å¦ä½¿ç”¨
- **ä¸šåŠ¡ä¾µå…¥**ï¼šéœ€è¦ä¸šåŠ¡æ–¹å®ç°ä¸‰ä¸ªæ¥å£

### 1.2 Sagaæ¨¡å¼é€šä¿—ç†è§£


**ğŸ”¸ Sagaå°±åƒæ—…è¡Œè®¡åˆ’**
```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
ä½ è®¡åˆ’ä¸€æ¬¡æ—…è¡Œï¼šè®¢æœºç¥¨â†’è®¢é…’åº—â†’è®¢é—¨ç¥¨
å¦‚æœæœ€åå‘ç°é—¨ç¥¨æ²¡äº†ï¼Œéœ€è¦ï¼š
âŒ å–æ¶ˆé…’åº—é¢„è®¢
âŒ å–æ¶ˆæœºç¥¨é¢„è®¢
âœ… æŒ‰ç›¸åé¡ºåºä¸€æ­¥æ­¥æ’¤é”€

æŠ€æœ¯å¯¹åº”ï¼š
æ­£å‘æ“ä½œï¼šAâ†’Bâ†’Câ†’D
è¡¥å¿æ“ä½œï¼šD'â†’C'â†’B'â†’A'
```

**ğŸ’¡ Sagaæ¨¡å¼ç‰¹ç‚¹**
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šå…è®¸ä¸­é—´çŠ¶æ€ä¸ä¸€è‡´
- **è¡¥å¿æœºåˆ¶**ï¼šé€šè¿‡åå‘æ“ä½œå›æ»š
- **ä¸šåŠ¡å‹å¥½**ï¼šæ›´ç¬¦åˆå®é™…ä¸šåŠ¡æµç¨‹

### 1.3 æ¨¡å¼é€‰æ‹©æŒ‡å—


| **é€‰æ‹©ç»´åº¦** | **TCCæ¨¡å¼** | **Sagaæ¨¡å¼** |
|-------------|-------------|--------------|
| ğŸ¯ **ä¸€è‡´æ€§è¦æ±‚** | å¼ºä¸€è‡´æ€§ | æœ€ç»ˆä¸€è‡´æ€§ |
| â±ï¸ **å“åº”æ—¶é—´** | è¾ƒå¿« | ç¨æ…¢ |
| ğŸ”§ **å¼€å‘å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦ä¸‰ä¸ªæ¥å£ï¼‰ | ä¸­ç­‰ï¼ˆéœ€è¦è¡¥å¿æ¥å£ï¼‰ |
| ğŸ¢ **é€‚ç”¨åœºæ™¯** | é‡‘èæ”¯ä»˜ | ç”µå•†è®¢å• |

---

## 2. ğŸ”§ Seataå¦‚ä½•æ”¯æŒTCCæ¨¡å¼


### 2.1 TCCæ¶æ„å›¾


```
                    Seata TCC æ‰§è¡Œæµç¨‹
                           
    ä¸šåŠ¡åº”ç”¨              Seata TC              èµ„æºç®¡ç†å™¨
       |                     |                     |
   [1] å¼€å¯å…¨å±€äº‹åŠ¡           |                     |
       |-------------------->|                     |
       |                     |                     |
   [2] æ³¨å†Œåˆ†æ”¯äº‹åŠ¡           |                     |
       |-------------------->|                     |
       |                     |                     |
   [3] æ‰§è¡Œ Try æ–¹æ³•         |                     |
       |------------------------------------>|
       |<------------------------------------|
       |                     |                     |
   [4] æäº¤/å›æ»šå†³ç­–         |                     |
       |-------------------->|                     |
       |                     |                     |
   [5] æ‰§è¡Œ Confirm/Cancel   |                     |
       |                     |-------------------->|
       |                     |<--------------------|
```

### 2.2 TCCæ¥å£å®šä¹‰è§„èŒƒ


**ğŸ”¸ æ ‡å‡†TCCæ¥å£ç»“æ„**
```java
@LocalTCC
public interface AccountService {
    
    /**
     * Tryé˜¶æ®µï¼šå°è¯•æ‰§è¡Œä¸šåŠ¡
     * - æ£€æŸ¥ä¸šåŠ¡æ¡ä»¶
     * - é¢„ç•™å¿…è¦èµ„æº  
     * - è®°å½•æ“ä½œæ—¥å¿—
     */
    @TwoPhaseBusinessAction(
        name = "deduct",
        commitMethod = "confirm", 
        rollbackMethod = "cancel"
    )
    boolean deduct(BusinessActionContext context, 
                  @BusinessActionContextParameter("userId") String userId,
                  @BusinessActionContextParameter("amount") BigDecimal amount);
    
    /**
     * Confirmé˜¶æ®µï¼šç¡®è®¤æ‰§è¡Œ
     * - çœŸæ­£æ‰£é™¤ä½™é¢
     * - æ¸…ç†ä¸´æ—¶æ•°æ®
     */
    boolean confirm(BusinessActionContext context);
    
    /**
     * Cancelé˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œ
     * - é‡Šæ”¾é¢„ç•™èµ„æº
     * - æ¸…ç†æ“ä½œè®°å½•
     */
    boolean cancel(BusinessActionContext context);
}
```

### 2.3 TCCå®ç°ç¤ºä¾‹


**ğŸ”¸ è´¦æˆ·æ‰£æ¬¾TCCå®ç°**
```java
@Service
public class AccountServiceImpl implements AccountService {
    
    @Override
    public boolean deduct(BusinessActionContext context, 
                         String userId, BigDecimal amount) {
        // Tryé˜¶æ®µï¼šé¢„ç•™èµ„é‡‘
        System.out.println("Tryé˜¶æ®µï¼šé¢„ç•™ç”¨æˆ·" + userId + "çš„" + amount + "å…ƒ");
        
        // 1. æ£€æŸ¥è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³
        if (!checkBalance(userId, amount)) {
            return false;
        }
        
        // 2. å†»ç»“ç›¸åº”é‡‘é¢ï¼ˆä¸æ˜¯çœŸæ­£æ‰£é™¤ï¼‰
        return freezeAmount(userId, amount, context.getXid());
    }
    
    @Override
    public boolean confirm(BusinessActionContext context) {
        // Confirmé˜¶æ®µï¼šçœŸæ­£æ‰£æ¬¾
        String userId = (String) context.getActionContext("userId");
        BigDecimal amount = (BigDecimal) context.getActionContext("amount");
        
        System.out.println("Confirmé˜¶æ®µï¼šçœŸæ­£æ‰£é™¤ç”¨æˆ·" + userId + "çš„" + amount + "å…ƒ");
        
        // å°†å†»ç»“é‡‘é¢è½¬ä¸ºçœŸæ­£æ‰£é™¤
        return deductFrozenAmount(userId, context.getXid());
    }
    
    @Override
    public boolean cancel(BusinessActionContext context) {
        // Cancelé˜¶æ®µï¼šè§£å†»èµ„é‡‘
        String userId = (String) context.getActionContext("userId");
        
        System.out.println("Cancelé˜¶æ®µï¼šè§£å†»ç”¨æˆ·" + userId + "çš„èµ„é‡‘");
        
        // é‡Šæ”¾å†»ç»“çš„é‡‘é¢
        return unfreezeeAmount(userId, context.getXid());
    }
}
```

---

## 3. ğŸ­ Seataå¦‚ä½•æ”¯æŒSagaæ¨¡å¼


### 3.1 SagaçŠ¶æ€æœºæ¦‚å¿µ


**ğŸ”¸ çŠ¶æ€æœºå°±åƒæ¸¸æˆå…³å¡**
```
æ¸¸æˆé€šå…³æµç¨‹ï¼š
ç¬¬1å…³ â†’ ç¬¬2å…³ â†’ ç¬¬3å…³ â†’ é€šå…³
  â†“       â†“       â†“
å¤±è´¥æ—¶çš„å›é€€è·¯å¾„ï¼š
é‡ç½®3å…³ â† é‡ç½®2å…³ â† é‡ç½®1å…³

Sagaå¯¹åº”ï¼š
æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C â†’ æˆåŠŸ
  â†“       â†“       â†“  
è¡¥å¿C â† è¡¥å¿B â† è¡¥å¿A â† å¤±è´¥å›æ»š
```

### 3.2 SagaçŠ¶æ€æœºå®šä¹‰


**ğŸ”¸ JSONæ ¼å¼çš„çŠ¶æ€æœºé…ç½®**
```json
{
  "Name": "è®¢å•å¤„ç†æµç¨‹",
  "Comment": "ç”µå•†è®¢å•çš„å®Œæ•´å¤„ç†æµç¨‹",
  "StartAt": "åˆ›å»ºè®¢å•",
  "Version": "0.0.1",
  "States": {
    "åˆ›å»ºè®¢å•": {
      "Type": "ServiceTask",
      "ServiceName": "orderService",
      "ServiceMethod": "createOrder",
      "CompensateState": "å–æ¶ˆè®¢å•",
      "Next": "æ‰£å‡åº“å­˜"
    },
    "æ‰£å‡åº“å­˜": {
      "Type": "ServiceTask", 
      "ServiceName": "inventoryService",
      "ServiceMethod": "deductInventory",
      "CompensateState": "æ¢å¤åº“å­˜",
      "Next": "æ‰£å‡ä½™é¢"
    },
    "æ‰£å‡ä½™é¢": {
      "Type": "ServiceTask",
      "ServiceName": "accountService", 
      "ServiceMethod": "deductBalance",
      "CompensateState": "æ¢å¤ä½™é¢",
      "End": true
    }
  }
}
```

### 3.3 SagaæœåŠ¡å®ç°


**ğŸ”¸ è®¢å•æœåŠ¡å®ç°**
```java
@Service
public class OrderService {
    
    /**
     * æ­£å‘æ“ä½œï¼šåˆ›å»ºè®¢å•
     */
    public boolean createOrder(String userId, String productId, int quantity) {
        System.out.println("åˆ›å»ºè®¢å•ï¼šç”¨æˆ·" + userId + "è´­ä¹°å•†å“" + productId);
        
        // åˆ›å»ºè®¢å•è®°å½•
        Order order = new Order();
        order.setUserId(userId);
        order.setProductId(productId);
        order.setQuantity(quantity);
        order.setStatus("CREATED");
        
        return orderRepository.save(order) != null;
    }
    
    /**
     * è¡¥å¿æ“ä½œï¼šå–æ¶ˆè®¢å•
     */
    public boolean cancelOrder(String userId, String productId, int quantity) {
        System.out.println("è¡¥å¿æ“ä½œï¼šå–æ¶ˆç”¨æˆ·" + userId + "çš„è®¢å•");
        
        // å°†è®¢å•çŠ¶æ€æ”¹ä¸ºå·²å–æ¶ˆ
        Order order = orderRepository.findByUserIdAndProductId(userId, productId);
        if (order != null) {
            order.setStatus("CANCELLED");
            orderRepository.save(order);
            return true;
        }
        return false;
    }
}
```

---

## 4. ğŸ“‹ æ¥å£å®šä¹‰ä¸å®ç°


### 4.1 æ¥å£å®šä¹‰åŸåˆ™


**ğŸ”¸ è®¾è®¡æ¥å£çš„æ ¸å¿ƒåŸåˆ™**

```
ğŸ¯ å¹‚ç­‰æ€§åŸåˆ™ï¼š
åŒä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥ç›¸åŒ
ä¾‹å¦‚ï¼šé‡å¤æ‰£æ¬¾100å…ƒï¼Œåªèƒ½æ‰£ä¸€æ¬¡

ğŸ¯ å¯è¡¥å¿åŸåˆ™ï¼š  
æ¯ä¸ªæ­£å‘æ“ä½œéƒ½è¦æœ‰å¯¹åº”çš„åå‘æ“ä½œ
ä¾‹å¦‚ï¼šæ‰£æ¬¾ â†â†’ é€€æ¬¾

ğŸ¯ èµ„æºéš”ç¦»åŸåˆ™ï¼š
ä¸åŒäº‹åŠ¡æ“ä½œçš„èµ„æºè¦èƒ½å¤ŸåŒºåˆ†
ä¾‹å¦‚ï¼šé€šè¿‡äº‹åŠ¡IDåŒºåˆ†ä¸åŒçš„å†»ç»“èµ„é‡‘
```

### 4.2 TCCæ¥å£æœ€ä½³å®è·µ


**ğŸ”¸ æ¥å£è®¾è®¡æ¨¡æ¿**
```java
public interface PaymentTCCService {
    
    /**
     * Tryé˜¶æ®µæ¥å£è®¾è®¡è¦ç‚¹ï¼š
     * 1. æ£€æŸ¥æ‰€æœ‰å‰ç½®æ¡ä»¶
     * 2. é¢„ç•™æˆ–é”å®šèµ„æº
     * 3. è®°å½•æ“ä½œä¸Šä¸‹æ–‡
     * 4. å¿«é€Ÿè¿”å›ï¼Œé¿å…é•¿æ—¶é—´å ç”¨
     */
    @TwoPhaseBusinessAction(name = "payment")
    boolean tryPay(BusinessActionContext context,
                   @BusinessActionContextParameter("orderId") String orderId,
                   @BusinessActionContextParameter("amount") BigDecimal amount);
    
    /**
     * Confirmé˜¶æ®µæ¥å£è®¾è®¡è¦ç‚¹ï¼š
     * 1. æ‰§è¡Œå®é™…çš„ä¸šåŠ¡æ“ä½œ
     * 2. æ¸…ç†ä¸´æ—¶æ•°æ®å’Œæ ‡è®°
     * 3. å¿…é¡»å¹‚ç­‰ï¼Œå¯é‡å¤æ‰§è¡Œ
     * 4. åªèƒ½æˆåŠŸä¸èƒ½å¤±è´¥
     */
    boolean confirmPay(BusinessActionContext context);
    
    /**
     * Cancelé˜¶æ®µæ¥å£è®¾è®¡è¦ç‚¹ï¼š
     * 1. é‡Šæ”¾Tryé˜¶æ®µé”å®šçš„èµ„æº
     * 2. æ¸…ç†æ“ä½œç—•è¿¹
     * 3. å¿…é¡»å¹‚ç­‰ï¼Œå¯é‡å¤æ‰§è¡Œ  
     * 4. åªèƒ½æˆåŠŸä¸èƒ½å¤±è´¥
     */
    boolean cancelPay(BusinessActionContext context);
}
```

### 4.3 Sagaæ¥å£æœ€ä½³å®è·µ


**ğŸ”¸ SagaæœåŠ¡æ¥å£è§„èŒƒ**
```java
public interface InventoryService {
    
    /**
     * æ­£å‘æ“ä½œï¼šæ‰£å‡åº“å­˜
     * æ³¨æ„ï¼šç›´æ¥æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œä¸éœ€è¦é¢„ç•™
     */
    boolean deductInventory(String productId, int quantity, String txId);
    
    /**
     * è¡¥å¿æ“ä½œï¼šæ¢å¤åº“å­˜
     * é‡ç‚¹ï¼šå¿…é¡»èƒ½å¤Ÿæ’¤é”€æ­£å‘æ“ä½œçš„æ•ˆæœ
     */
    boolean restoreInventory(String productId, int quantity, String txId);
}

// å®ç°ç¤ºä¾‹
@Service  
public class InventoryServiceImpl implements InventoryService {
    
    @Override
    public boolean deductInventory(String productId, int quantity, String txId) {
        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        if (!checkStock(productId, quantity)) {
            return false;
        }
        
        // ç›´æ¥æ‰£å‡åº“å­˜
        updateStock(productId, -quantity);
        
        // è®°å½•æ“ä½œæ—¥å¿—ï¼Œç”¨äºåç»­è¡¥å¿
        logOperation(productId, quantity, txId, "DEDUCT");
        
        return true;
    }
    
    @Override  
    public boolean restoreInventory(String productId, int quantity, String txId) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»è¡¥å¿è¿‡ï¼ˆå¹‚ç­‰æ€§ï¼‰
        if (isAlreadyCompensated(txId)) {
            return true;
        }
        
        // æ¢å¤åº“å­˜
        updateStock(productId, quantity);
        
        // æ ‡è®°å·²è¡¥å¿
        markCompensated(txId);
        
        return true;
    }
}
```

---

## 5. ğŸ”„ è¡¥å¿é€»è¾‘è®¾è®¡


### 5.1 è¡¥å¿è®¾è®¡åŸåˆ™


**ğŸ”¸ è¡¥å¿çš„æ ¸å¿ƒæ€æƒ³**

```
ğŸ“ æ­£å‘ä¸åå‘å¯¹åº”å…³ç³»ï¼š
æ­£å‘æ“ä½œ          åå‘è¡¥å¿
â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€
åˆ›å»ºè®¢å•    â†’     å–æ¶ˆè®¢å•
æ‰£å‡åº“å­˜    â†’     å¢åŠ åº“å­˜  
æ‰£å‡ä½™é¢    â†’     é€€è¿˜ä½™é¢
å‘é€é€šçŸ¥    â†’     æ’¤å›é€šçŸ¥
```

**ğŸ’¡ è¡¥å¿è®¾è®¡çš„å…³é”®ç‚¹**

| **è®¾è®¡è¦ç‚¹** | **è¯´æ˜** | **ä¸¾ä¾‹** |
|-------------|----------|----------|
| ğŸ” **å¹‚ç­‰æ€§** | é‡å¤æ‰§è¡Œç»“æœç›¸åŒ | é‡å¤é€€æ¬¾100å…ƒï¼Œåªé€€ä¸€æ¬¡ |
| ğŸ¯ **ç²¾ç¡®æ€§** | è¡¥å¿æ•ˆæœä¸æ­£å‘æ“ä½œå®Œå…¨ç›¸å | æ‰£äº†50åº“å­˜ï¼Œå°±è¦åŠ å›50åº“å­˜ |
| ğŸ“ **å¯è¿½è¸ª** | è®°å½•è¡¥å¿æ“ä½œçš„æ‰§è¡ŒçŠ¶æ€ | è¡¥å¿æˆåŠŸ/å¤±è´¥éƒ½è¦è®°å½•æ—¥å¿— |

### 5.2 TCCè¡¥å¿å®ç°


**ğŸ”¸ è´¦æˆ·æœåŠ¡çš„è¡¥å¿é€»è¾‘**
```java
@Service
public class AccountTCCService {
    
    // ç”¨äºè®°å½•å†»ç»“çš„èµ„é‡‘ä¿¡æ¯
    private Map<String, FrozenRecord> frozenRecords = new ConcurrentHashMap<>();
    
    @Override
    public boolean deduct(BusinessActionContext context, String userId, BigDecimal amount) {
        String xid = context.getXid();
        
        // Tryé˜¶æ®µï¼šæ£€æŸ¥å¹¶å†»ç»“èµ„é‡‘
        Account account = getAccount(userId);
        if (account.getBalance().compareTo(amount) < 0) {
            return false; // ä½™é¢ä¸è¶³
        }
        
        // è®°å½•å†»ç»“ä¿¡æ¯
        FrozenRecord record = new FrozenRecord();
        record.setUserId(userId);
        record.setAmount(amount);
        record.setStatus("FROZEN");
        frozenRecords.put(xid, record);
        
        System.out.println("Tryé˜¶æ®µï¼šå†»ç»“ç”¨æˆ·" + userId + "çš„" + amount + "å…ƒ");
        return true;
    }
    
    @Override
    public boolean confirm(BusinessActionContext context) {
        String xid = context.getXid();
        FrozenRecord record = frozenRecords.get(xid);
        
        if (record == null) {
            return true; // å·²ç»å¤„ç†è¿‡äº†
        }
        
        // Confirmé˜¶æ®µï¼šçœŸæ­£æ‰£é™¤ä½™é¢
        Account account = getAccount(record.getUserId());
        account.setBalance(account.getBalance().subtract(record.getAmount()));
        updateAccount(account);
        
        // æ¸…ç†å†»ç»“è®°å½•
        frozenRecords.remove(xid);
        
        System.out.println("Confirmé˜¶æ®µï¼šçœŸæ­£æ‰£é™¤" + record.getAmount() + "å…ƒ");
        return true;
    }
    
    @Override
    public boolean cancel(BusinessActionContext context) {
        String xid = context.getXid();
        FrozenRecord record = frozenRecords.get(xid);
        
        if (record == null) {
            return true; // å·²ç»å¤„ç†è¿‡äº†
        }
        
        // Cancelé˜¶æ®µï¼šè§£é™¤å†»ç»“
        frozenRecords.remove(xid);
        
        System.out.println("Cancelé˜¶æ®µï¼šè§£é™¤å†»ç»“" + record.getAmount() + "å…ƒ");
        return true;
    }
}
```

### 5.3 Sagaè¡¥å¿å®ç°


**ğŸ”¸ åº“å­˜æœåŠ¡çš„è¡¥å¿é€»è¾‘**
```java
@Service
public class InventoryService {
    
    public boolean deductInventory(String productId, int quantity, String sagaId) {
        // æ­£å‘æ“ä½œï¼šæ‰£å‡åº“å­˜
        Product product = getProduct(productId);
        if (product.getStock() < quantity) {
            return false; // åº“å­˜ä¸è¶³
        }
        
        // æ‰£å‡åº“å­˜
        product.setStock(product.getStock() - quantity);
        updateProduct(product);
        
        // è®°å½•æ“ä½œç”¨äºè¡¥å¿
        InventoryLog log = new InventoryLog();
        log.setSagaId(sagaId);
        log.setProductId(productId);
        log.setQuantity(quantity);
        log.setOperation("DEDUCT");
        log.setStatus("SUCCESS");
        saveLog(log);
        
        System.out.println("æ‰£å‡åº“å­˜ï¼šå•†å“" + productId + "å‡å°‘" + quantity + "ä»¶");
        return true;
    }
    
    public boolean restoreInventory(String productId, int quantity, String sagaId) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»è¡¥å¿è¿‡
        if (isCompensated(sagaId)) {
            return true;
        }
        
        // è¡¥å¿æ“ä½œï¼šæ¢å¤åº“å­˜
        Product product = getProduct(productId);
        product.setStock(product.getStock() + quantity);
        updateProduct(product);
        
        // è®°å½•è¡¥å¿æ“ä½œ
        InventoryLog log = new InventoryLog();
        log.setSagaId(sagaId);
        log.setProductId(productId);
        log.setQuantity(quantity);
        log.setOperation("COMPENSATE");
        log.setStatus("SUCCESS");
        saveLog(log);
        
        System.out.println("è¡¥å¿åº“å­˜ï¼šå•†å“" + productId + "æ¢å¤" + quantity + "ä»¶");
        return true;
    }
}
```

---

## 6. ğŸ° çŠ¶æ€æœºé©±åŠ¨æœºåˆ¶


### 6.1 çŠ¶æ€æœºåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ çŠ¶æ€æœºå°±åƒè‡ªåŠ¨å”®è´§æœº**

```
è‡ªåŠ¨å”®è´§æœºçš„å·¥ä½œæµç¨‹ï¼š
æŠ•å¸ â†’ é€‰æ‹©å•†å“ â†’ ç¡®è®¤è´­ä¹° â†’ å‡ºè´§ â†’ æ‰¾é›¶

å¯¹åº”çš„çŠ¶æ€å˜åŒ–ï¼š
[ç­‰å¾…æŠ•å¸] â†’ [é€‰æ‹©ä¸­] â†’ [æ”¯ä»˜ä¸­] â†’ [å‡ºè´§ä¸­] â†’ [å®Œæˆ]
     â†“          â†“         â†“         â†“
   [é€€å¸]    [å–æ¶ˆ]    [é€€æ¬¾]    [æ•…éšœå¤„ç†]
```

**ğŸ’¡ SagaçŠ¶æ€æœºç‰¹ç‚¹**
- **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰ç…§é¢„å®šä¹‰çš„é¡ºåºæ‰§è¡Œå„ä¸ªæ­¥éª¤
- **è‡ªåŠ¨è¡¥å¿**ï¼šå‡ºç°é”™è¯¯æ—¶è‡ªåŠ¨æ‰§è¡Œè¡¥å¿é€»è¾‘
- **çŠ¶æ€æŒä¹…åŒ–**ï¼šçŠ¶æ€ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ”¯æŒæ•…éšœæ¢å¤

### 6.2 çŠ¶æ€æœºé…ç½®è¯¦è§£


**ğŸ”¸ å®Œæ•´çš„çŠ¶æ€æœºå®šä¹‰**
```json
{
  "Name": "ç”µå•†ä¸‹å•æµç¨‹",
  "Comment": "ç”¨æˆ·ä¸‹å•çš„å®Œæ•´ä¸šåŠ¡æµç¨‹",
  "StartAt": "å‚æ•°æ ¡éªŒ",
  "Version": "1.0.0",
  "States": {
    "å‚æ•°æ ¡éªŒ": {
      "Type": "ServiceTask",
      "ServiceName": "orderService",
      "ServiceMethod": "validateOrder",
      "Next": "åˆ›å»ºè®¢å•",
      "Catch": [
        {
          "Exceptions": ["java.lang.IllegalArgumentException"],
          "Next": "å‚æ•°é”™è¯¯å¤„ç†"
        }
      ]
    },
    "åˆ›å»ºè®¢å•": {
      "Type": "ServiceTask",
      "ServiceName": "orderService", 
      "ServiceMethod": "createOrder",
      "CompensateState": "å–æ¶ˆè®¢å•",
      "Next": "æ‰£å‡åº“å­˜",
      "Retry": [
        {
          "Exceptions": ["java.sql.SQLException"],
          "IntervalMs": 1000,
          "MaxAttempts": 3,
          "BackoffRate": 2.0
        }
      ]
    },
    "æ‰£å‡åº“å­˜": {
      "Type": "ServiceTask",
      "ServiceName": "inventoryService",
      "ServiceMethod": "deductInventory", 
      "CompensateState": "æ¢å¤åº“å­˜",
      "Next": "æ‰£å‡ä½™é¢"
    },
    "æ‰£å‡ä½™é¢": {
      "Type": "ServiceTask",
      "ServiceName": "accountService",
      "ServiceMethod": "deductBalance",
      "CompensateState": "æ¢å¤ä½™é¢", 
      "End": true
    }
  }
}
```

### 6.3 çŠ¶æ€æœºæ‰§è¡Œæµç¨‹


**ğŸ”¸ æ­£å¸¸æ‰§è¡Œæµç¨‹**
```
å¼€å§‹
  â†“
å‚æ•°æ ¡éªŒ âœ…
  â†“
åˆ›å»ºè®¢å• âœ…
  â†“  
æ‰£å‡åº“å­˜ âœ…
  â†“
æ‰£å‡ä½™é¢ âœ…
  â†“
ç»“æŸï¼ˆæˆåŠŸï¼‰
```

**ğŸ”¸ å¼‚å¸¸è¡¥å¿æµç¨‹**
```
å¼€å§‹
  â†“
å‚æ•°æ ¡éªŒ âœ…
  â†“
åˆ›å»ºè®¢å• âœ…
  â†“
æ‰£å‡åº“å­˜ âœ…  
  â†“
æ‰£å‡ä½™é¢ âŒ ï¼ˆä½™é¢ä¸è¶³ï¼‰
  â†“
è§¦å‘è¡¥å¿æµç¨‹ï¼š
  â†“
æ¢å¤åº“å­˜ âœ…
  â†“
å–æ¶ˆè®¢å• âœ…
  â†“
ç»“æŸï¼ˆè¡¥å¿å®Œæˆï¼‰
```

### 6.4 çŠ¶æ€æœºæ‰§è¡Œå¼•æ“


**ğŸ”¸ SeataçŠ¶æ€æœºå¼•æ“å·¥ä½œåŸç†**
```java
@Component
public class SagaTransactionManager {
    
    /**
     * æ‰§è¡ŒSagaçŠ¶æ€æœº
     */
    public void executeStateMachine(String stateMachineName, Map<String, Object> params) {
        
        // 1. åŠ è½½çŠ¶æ€æœºå®šä¹‰
        StateMachine stateMachine = loadStateMachine(stateMachineName);
        
        // 2. åˆ›å»ºæ‰§è¡Œå®ä¾‹
        StateMachineInstance instance = createInstance(stateMachine, params);
        
        // 3. å¼€å§‹æ‰§è¡Œ
        try {
            executeStates(instance);
            System.out.println("Sagaäº‹åŠ¡æ‰§è¡ŒæˆåŠŸ");
        } catch (Exception e) {
            System.out.println("Sagaäº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œå¼€å§‹è¡¥å¿");
            compensateStates(instance);
        }
    }
    
    /**
     * æ‰§è¡ŒçŠ¶æ€æœºçš„å„ä¸ªçŠ¶æ€
     */
    private void executeStates(StateMachineInstance instance) {
        State currentState = instance.getCurrentState();
        
        while (currentState != null && !currentState.isEnd()) {
            // æ‰§è¡Œå½“å‰çŠ¶æ€
            Object result = invokeService(currentState, instance.getContext());
            
            // è®°å½•æ‰§è¡Œç»“æœ
            instance.recordStateExecution(currentState, result);
            
            // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€
            currentState = getNextState(currentState, result);
            instance.setCurrentState(currentState);
        }
    }
    
    /**
     * æ‰§è¡Œè¡¥å¿æ“ä½œ
     */
    private void compensateStates(StateMachineInstance instance) {
        // æŒ‰ç…§æ‰§è¡Œçš„ç›¸åé¡ºåºè¿›è¡Œè¡¥å¿
        List<State> executedStates = instance.getExecutedStates();
        Collections.reverse(executedStates);
        
        for (State state : executedStates) {
            if (state.getCompensateState() != null) {
                try {
                    invokeService(state.getCompensateState(), instance.getContext());
                    System.out.println("è¡¥å¿çŠ¶æ€ï¼š" + state.getName());
                } catch (Exception e) {
                    System.out.println("è¡¥å¿å¤±è´¥ï¼š" + state.getName() + "ï¼ŒåŸå› ï¼š" + e.getMessage());
                    // è¡¥å¿å¤±è´¥çš„å¤„ç†é€»è¾‘
                }
            }
        }
    }
}
```

---

## 7. ğŸ”€ å¤šæ¨¡å¼é€‚é…ç­–ç•¥


### 7.1 æ¨¡å¼é€‰æ‹©å†³ç­–æ ‘


```
                    é€‰æ‹©åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼
                           |
                    ä¸€è‡´æ€§è¦æ±‚å¼ºå—ï¼Ÿ
                       /        \
                   æ˜¯/           \å¦
                    /              \
            é€‰æ‹©TCCæ¨¡å¼         ä¸šåŠ¡å¤æ‚å—ï¼Ÿ
                              /        \
                          æ˜¯/           \å¦  
                          /              \
                   é€‰æ‹©Sagaæ¨¡å¼      é€‰æ‹©ATæ¨¡å¼
```

### 7.2 æ··åˆæ¨¡å¼åº”ç”¨


**ğŸ”¸ ç”µå•†ç³»ç»Ÿçš„æ··åˆäº‹åŠ¡æ¨¡å¼**

```
ç”µå•†ä¸‹å•ä¸šåŠ¡åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ä¸šåŠ¡ç¯èŠ‚     â”‚   äº‹åŠ¡æ¨¡å¼   â”‚    é€‰æ‹©ç†ç”±   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”¨æˆ·æ”¯ä»˜     â”‚   TCCæ¨¡å¼    â”‚ å¼ºä¸€è‡´æ€§è¦æ±‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è®¢å•åˆ›å»º     â”‚   ATæ¨¡å¼     â”‚ ç®€å•ä¸šåŠ¡æ“ä½œ  â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº“å­˜æ‰£å‡     â”‚   TCCæ¨¡å¼    â”‚ é˜²æ­¢è¶…å–      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç§¯åˆ†å¢åŠ      â”‚   Sagaæ¨¡å¼   â”‚ æœ€ç»ˆä¸€è‡´æ€§    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å‘é€é€šçŸ¥     â”‚   Sagaæ¨¡å¼   â”‚ å…è®¸å¼‚æ­¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 æ¨¡å¼åˆ‡æ¢é…ç½®


**ğŸ”¸ åŸºäºæ³¨è§£çš„æ¨¡å¼é€‰æ‹©**
```java
@Service
public class OrderService {
    
    /**
     * ä½¿ç”¨ATæ¨¡å¼å¤„ç†ç®€å•çš„æ•°æ®åº“æ“ä½œ
     */
    @GlobalTransactional
    public void createSimpleOrder(OrderDTO order) {
        // ç›´æ¥æ“ä½œæ•°æ®åº“ï¼ŒSeataè‡ªåŠ¨ç®¡ç†äº‹åŠ¡
        orderRepository.save(order);
        userRepository.updateUserLevel(order.getUserId());
    }
    
    /**
     * ä½¿ç”¨TCCæ¨¡å¼å¤„ç†éœ€è¦å¼ºä¸€è‡´æ€§çš„ä¸šåŠ¡
     */
    @GlobalTransactional  
    public void createPaymentOrder(OrderDTO order) {
        // è°ƒç”¨TCCæ¥å£
        paymentTCCService.deduct(order.getUserId(), order.getAmount());
        inventoryTCCService.reserve(order.getProductId(), order.getQuantity());
    }
    
    /**
     * ä½¿ç”¨Sagaæ¨¡å¼å¤„ç†å¤æ‚çš„ä¸šåŠ¡æµç¨‹
     */
    public void createComplexOrder(OrderDTO order) {
        // å¯åŠ¨SagaçŠ¶æ€æœº
        Map<String, Object> params = new HashMap<>();
        params.put("order", order);
        
        sagaTransactionManager.executeStateMachine("ComplexOrderFlow", params);
    }
}
```

### 7.4 æ¨¡å¼é€‚é…å™¨å®ç°


**ğŸ”¸ ç»Ÿä¸€çš„äº‹åŠ¡ç®¡ç†å™¨**
```java
@Component
public class UnifiedTransactionManager {
    
    @Autowired
    private ATTransactionManager atManager;
    
    @Autowired  
    private TCCTransactionManager tccManager;
    
    @Autowired
    private SagaTransactionManager sagaManager;
    
    /**
     * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„äº‹åŠ¡æ¨¡å¼
     */
    public void executeTransaction(TransactionContext context) {
        
        TransactionMode mode = decideTransactionMode(context);
        
        switch (mode) {
            case AT:
                atManager.execute(context);
                break;
            case TCC: 
                tccManager.execute(context);
                break;
            case SAGA:
                sagaManager.execute(context);
                break;
            default:
                throw new UnsupportedOperationException("ä¸æ”¯æŒçš„äº‹åŠ¡æ¨¡å¼ï¼š" + mode);
        }
    }
    
    /**
     * äº‹åŠ¡æ¨¡å¼å†³ç­–é€»è¾‘
     */
    private TransactionMode decideTransactionMode(TransactionContext context) {
        
        // æ ¹æ®ä¸šåŠ¡ç‰¹å¾å†³ç­–
        if (context.requiresStrongConsistency()) {
            return TransactionMode.TCC;
        }
        
        if (context.isComplexWorkflow()) {
            return TransactionMode.SAGA;
        }
        
        return TransactionMode.AT; // é»˜è®¤ä½¿ç”¨ATæ¨¡å¼
    }
}
```

---

## 8. ğŸ—ï¸ ä¸šåŠ¡è§£è€¦æœ€ä½³å®è·µ


### 8.1 æ¥å£ä¸ä¸šåŠ¡åˆ†ç¦»


**ğŸ”¸ åˆ†å±‚æ¶æ„è®¾è®¡**

```
                    ä¸šåŠ¡è§£è€¦åˆ†å±‚æ¶æ„
                    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ä¸šåŠ¡æœåŠ¡å±‚                â”‚  â† å¤„ç†å…·ä½“ä¸šåŠ¡é€»è¾‘
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚           äº‹åŠ¡åè°ƒå±‚                â”‚  â† TCC/Sagaæ¥å£å®šä¹‰
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
    â”‚           èµ„æºç®¡ç†å±‚                â”‚  â† æ•°æ®åº“ã€ç¼“å­˜ç­‰èµ„æº
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚           åŸºç¡€è®¾æ–½å±‚                â”‚  â† Seataæ¡†æ¶ã€ç½‘ç»œé€šä¿¡
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 äº‹åŠ¡æ¥å£æŠ½è±¡


**ğŸ”¸ äº‹åŠ¡æ“ä½œç»Ÿä¸€æ¥å£**
```java
/**
 * ç»Ÿä¸€çš„åˆ†å¸ƒå¼äº‹åŠ¡æ“ä½œæ¥å£
 * ä¸šåŠ¡å±‚ä¸éœ€è¦å…³å¿ƒå…·ä½“æ˜¯TCCè¿˜æ˜¯Saga
 */
public interface DistributedTransaction {
    
    /**
     * æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡
     * @param context äº‹åŠ¡ä¸Šä¸‹æ–‡
     * @return æ‰§è¡Œç»“æœ
     */
    TransactionResult execute(TransactionContext context);
    
    /**
     * æ£€æŸ¥äº‹åŠ¡çŠ¶æ€
     * @param txId äº‹åŠ¡ID
     * @return äº‹åŠ¡çŠ¶æ€
     */
    TransactionStatus getStatus(String txId);
    
    /**
     * æ‰‹åŠ¨è§¦å‘è¡¥å¿ï¼ˆä»…é™Sagaæ¨¡å¼ï¼‰
     * @param txId äº‹åŠ¡ID
     */
    void compensate(String txId);
}

// TCCæ¨¡å¼å®ç°
@Service("tccTransaction")
public class TCCTransactionImpl implements DistributedTransaction {
    
    @Override
    public TransactionResult execute(TransactionContext context) {
        // TCCä¸‰é˜¶æ®µæ‰§è¡Œé€»è¾‘
        try {
            // Tryé˜¶æ®µ
            boolean tryResult = executeTryPhase(context);
            if (!tryResult) {
                return TransactionResult.failure("Tryé˜¶æ®µå¤±è´¥");
            }
            
            // Confirmé˜¶æ®µ  
            boolean confirmResult = executeConfirmPhase(context);
            return confirmResult ? 
                   TransactionResult.success("TCCäº‹åŠ¡æ‰§è¡ŒæˆåŠŸ") :
                   TransactionResult.failure("Confirmé˜¶æ®µå¤±è´¥");
                   
        } catch (Exception e) {
            // Cancelé˜¶æ®µ
            executeCancelPhase(context);
            return TransactionResult.failure("TCCäº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼š" + e.getMessage());
        }
    }
}

// Sagaæ¨¡å¼å®ç°  
@Service("sagaTransaction")
public class SagaTransactionImpl implements DistributedTransaction {
    
    @Override
    public TransactionResult execute(TransactionContext context) {
        // SagaçŠ¶æ€æœºæ‰§è¡Œé€»è¾‘
        try {
            String stateMachineName = context.getStateMachineName();
            Map<String, Object> params = context.getParameters();
            
            stateMachineEngine.execute(stateMachineName, params);
            return TransactionResult.success("Sagaäº‹åŠ¡æ‰§è¡ŒæˆåŠŸ");
            
        } catch (Exception e) {
            return TransactionResult.failure("Sagaäº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

### 8.3 ä¸šåŠ¡æœåŠ¡è§£è€¦


**ğŸ”¸ ä¸šåŠ¡æœåŠ¡åªå…³æ³¨ä¸šåŠ¡é€»è¾‘**
```java
@Service
public class OrderBusinessService {
    
    // ä¸ç›´æ¥ä¾èµ–å…·ä½“çš„äº‹åŠ¡å®ç°
    @Autowired
    @Qualifier("tccTransaction")  // å¯ä»¥é€šè¿‡é…ç½®åˆ‡æ¢
    private DistributedTransaction transactionManager;
    
    /**
     * å¤„ç†è®¢å•ä¸šåŠ¡ï¼Œä¸å…³å¿ƒäº‹åŠ¡å®ç°ç»†èŠ‚
     */
    public OrderResult processOrder(CreateOrderRequest request) {
        
        // 1. ä¸šåŠ¡å‚æ•°æ ¡éªŒ
        if (!validateOrderRequest(request)) {
            return OrderResult.failure("è®¢å•å‚æ•°æ ¡éªŒå¤±è´¥");
        }
        
        // 2. æ„å»ºäº‹åŠ¡ä¸Šä¸‹æ–‡
        TransactionContext context = TransactionContext.builder()
            .businessType("CREATE_ORDER")
            .userId(request.getUserId()) 
            .orderId(request.getOrderId())
            .amount(request.getAmount())
            .build();
        
        // 3. æ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå…·ä½“ç”¨TCCè¿˜æ˜¯Sagaç”±é…ç½®å†³å®šï¼‰
        TransactionResult result = transactionManager.execute(context);
        
        // 4. è¿”å›ä¸šåŠ¡ç»“æœ
        if (result.isSuccess()) {
            return OrderResult.success("è®¢å•åˆ›å»ºæˆåŠŸ", result.getData());
        } else {
            return OrderResult.failure("è®¢å•åˆ›å»ºå¤±è´¥ï¼š" + result.getMessage());
        }
    }
}
```

### 8.4 é…ç½®åŒ–äº‹åŠ¡é€‰æ‹©


**ğŸ”¸ é€šè¿‡é…ç½®æ–‡ä»¶é€‰æ‹©äº‹åŠ¡æ¨¡å¼**
```yaml
# application.yml
seata:
  transaction:
    # é»˜è®¤äº‹åŠ¡æ¨¡å¼
    default-mode: TCC
    
    # ä¸šåŠ¡åœºæ™¯ä¸äº‹åŠ¡æ¨¡å¼æ˜ å°„
    business-mode-mapping:
      CREATE_ORDER: TCC        # åˆ›å»ºè®¢å•ä½¿ç”¨TCC
      UPDATE_INVENTORY: TCC    # åº“å­˜æ›´æ–°ä½¿ç”¨TCC  
      SEND_NOTIFICATION: SAGA  # å‘é€é€šçŸ¥ä½¿ç”¨Saga
      UPDATE_USER_PROFILE: AT  # ç”¨æˆ·ä¿¡æ¯æ›´æ–°ä½¿ç”¨AT
    
    # TCCé…ç½®
    tcc:
      timeout: 30000
      retry-times: 3
      
    # Sagaé…ç½®  
    saga:
      state-machine-path: classpath:saga/
      compensation-timeout: 60000
```

**ğŸ”¸ é…ç½®é©±åŠ¨çš„äº‹åŠ¡é€‰æ‹©å™¨**
```java
@Component
public class TransactionModeSelector {
    
    @Value("${seata.transaction.default-mode:AT}")
    private String defaultMode;
    
    @Value("#{${seata.transaction.business-mode-mapping:{}}}")
    private Map<String, String> businessModeMapping;
    
    /**
     * æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©äº‹åŠ¡æ¨¡å¼
     */
    public String selectTransactionMode(String businessType) {
        return businessModeMapping.getOrDefault(businessType, defaultMode);
    }
    
    /**
     * è·å–å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨
     */
    public DistributedTransaction getTransactionManager(String businessType) {
        String mode = selectTransactionMode(businessType);
        
        switch (mode.toUpperCase()) {
            case "TCC":
                return applicationContext.getBean("tccTransaction", DistributedTransaction.class);
            case "SAGA":
                return applicationContext.getBean("sagaTransaction", DistributedTransaction.class);
            case "AT":
                return applicationContext.getBean("atTransaction", DistributedTransaction.class);
            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„äº‹åŠ¡æ¨¡å¼ï¼š" + mode);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ TCCæ¨¡å¼ï¼šä¸‰é˜¶æ®µæäº¤ï¼Œå¼ºä¸€è‡´æ€§ï¼Œéœ€è¦ä¸šåŠ¡å®ç°ä¸‰ä¸ªæ¥å£
ğŸ”¸ Sagaæ¨¡å¼ï¼šè¡¥å¿æ¨¡å¼ï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼Œé€šè¿‡çŠ¶æ€æœºé©±åŠ¨
ğŸ”¸ æ¥å£è®¾è®¡ï¼šå¹‚ç­‰æ€§ã€å¯è¡¥å¿æ€§ã€èµ„æºéš”ç¦»æ˜¯å…³é”®åŸåˆ™  
ğŸ”¸ è¡¥å¿é€»è¾‘ï¼šæ­£å‘æ“ä½œä¸åå‘è¡¥å¿ä¸€ä¸€å¯¹åº”
ğŸ”¸ çŠ¶æ€æœºï¼šè‡ªåŠ¨åŒ–çš„æµç¨‹æ§åˆ¶å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
ğŸ”¸ æ¨¡å¼é€‚é…ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„äº‹åŠ¡æ¨¡å¼
ğŸ”¸ ä¸šåŠ¡è§£è€¦ï¼šé€šè¿‡æŠ½è±¡æ¥å£éš”ç¦»ä¸šåŠ¡é€»è¾‘ä¸äº‹åŠ¡å®ç°
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ TCC vs Sagaçš„æœ¬è´¨åŒºåˆ«**
```
TCCæ¨¡å¼ç‰¹ç‚¹ï¼š
âœ… å¼ºä¸€è‡´æ€§ä¿è¯
âœ… èµ„æºé¢„ç•™æœºåˆ¶
âŒ å¼€å‘å¤æ‚åº¦é«˜
âŒ æ€§èƒ½ç›¸å¯¹è¾ƒä½

Sagaæ¨¡å¼ç‰¹ç‚¹ï¼š
âœ… å¼€å‘ç›¸å¯¹ç®€å•
âœ… æ€§èƒ½è¾ƒå¥½
âœ… æ”¯æŒé•¿æµç¨‹
âŒ åªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

**ğŸ”¹ æ¥å£è®¾è®¡çš„æ ¸å¿ƒè¦æ±‚**
```
å¹‚ç­‰æ€§ï¼šé‡å¤è°ƒç”¨ç»“æœç›¸åŒ
è¡¥å¿æ€§ï¼šæ¯ä¸ªæ“ä½œéƒ½è¦æœ‰åå‘æ“ä½œ  
éš”ç¦»æ€§ï¼šä¸åŒäº‹åŠ¡çš„èµ„æºè¦èƒ½åŒºåˆ†
å¯é æ€§ï¼šè¡¥å¿æ“ä½œå¿…é¡»èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ
```

**ğŸ”¹ ä¸šåŠ¡è§£è€¦çš„ä»·å€¼**
```
ä»£ç ç»´æŠ¤ï¼šä¸šåŠ¡é€»è¾‘ä¸äº‹åŠ¡é€»è¾‘åˆ†ç¦»
æŠ€æœ¯æ¼”è¿›ï¼šå¯ä»¥è½»æ¾åˆ‡æ¢äº‹åŠ¡æ¨¡å¼
æµ‹è¯•å‹å¥½ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•ä¸šåŠ¡é€»è¾‘
å›¢é˜Ÿåä½œï¼šå‰ç«¯å¼€å‘ä¸éœ€è¦å…³å¿ƒäº‹åŠ¡ç»†èŠ‚
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ¨¡å¼é€‰æ‹©å»ºè®®**

| **ä¸šåŠ¡åœºæ™¯** | **æ¨èæ¨¡å¼** | **ç†ç”±è¯´æ˜** |
|-------------|-------------|-------------|
| ğŸ’³ **æ”¯ä»˜æ‰£æ¬¾** | TCC | å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œä¸å…è®¸é‡å¤æ‰£æ¬¾ |
| ğŸ“¦ **åº“å­˜æ‰£å‡** | TCC | é˜²æ­¢è¶…å–ï¼Œéœ€è¦é¢„ç•™æœºåˆ¶ |
| ğŸ“ **è®¢å•åˆ›å»º** | AT | ç®€å•æ•°æ®åº“æ“ä½œï¼Œè‡ªåŠ¨ç®¡ç† |
| ğŸ“§ **å‘é€é€šçŸ¥** | Saga | å…è®¸å¼‚æ­¥ï¼Œæœ€ç»ˆä¸€è‡´æ€§å³å¯ |
| ğŸ **ç§¯åˆ†èµ é€** | Saga | å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ |

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
1. å…ˆç¡®å®šä¸šåŠ¡çš„ä¸€è‡´æ€§è¦æ±‚
2. è¯„ä¼°å¼€å‘å’Œç»´æŠ¤æˆæœ¬  
3. è€ƒè™‘ç³»ç»Ÿçš„æ€§èƒ½è¦æ±‚
4. è®¾è®¡ç»Ÿä¸€çš„äº‹åŠ¡æ¥å£
5. é€šè¿‡é…ç½®æ”¯æŒæ¨¡å¼åˆ‡æ¢
6. å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦
7. å‡†å¤‡è¯¦ç»†çš„è¡¥å¿ç­–ç•¥
```

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å­¦ä¹ è·¯å¾„**
```
ç¬¬1é˜¶æ®µï¼šç†è§£TCCå’ŒSagaçš„åŸºæœ¬æ¦‚å¿µ
ç¬¬2é˜¶æ®µï¼šåŠ¨æ‰‹å®ç°ç®€å•çš„TCCæ¥å£
ç¬¬3é˜¶æ®µï¼šç¼–å†™SagaçŠ¶æ€æœºé…ç½®
ç¬¬4é˜¶æ®µï¼šè®¾è®¡ä¸šåŠ¡è§£è€¦æ¶æ„
ç¬¬5é˜¶æ®µï¼šåœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨å®è·µ
```

**ğŸ” æ·±å…¥å­¦ä¹ æ–¹å‘**
- Seataæºç åˆ†æï¼Œäº†è§£å†…éƒ¨å®ç°æœºåˆ¶
- åˆ†å¸ƒå¼äº‹åŠ¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- å¾®æœåŠ¡æ¶æ„ä¸‹çš„äº‹åŠ¡æ¨¡å¼è®¾è®¡
- äº‹åŠ¡ç›‘æ§å’Œæ•…éšœæ’æŸ¥æŠ€å·§

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- TCCä¸‰é˜¶æ®µï¼Œå¼ºä¸€è‡´ä¿è¯
- Sagaè¡¥å¿é“¾ï¼Œæœ€ç»ˆä¸€è‡´å¯é   
- æ¥å£è¦å¹‚ç­‰ï¼Œè¡¥å¿è¦ç²¾ç¡®
- ä¸šåŠ¡è¦è§£è€¦ï¼Œé…ç½®æ¥åˆ‡æ¢