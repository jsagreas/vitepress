---
title: 4ã€æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ](#1-æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ)
2. [Kafkaæ·±å…¥åº”ç”¨](#2-Kafkaæ·±å…¥åº”ç”¨)
3. [RabbitMQå®æˆ˜ä½¿ç”¨](#3-RabbitMQå®æˆ˜ä½¿ç”¨)
4. [æ¶ˆæ¯è·¯ç”±ä¸åˆ†å‘](#4-æ¶ˆæ¯è·¯ç”±ä¸åˆ†å‘)
5. [æŒä¹…åŒ–ä¸å¯é æ€§æœºåˆ¶](#5-æŒä¹…åŒ–ä¸å¯é æ€§æœºåˆ¶)
6. [æ¶ˆè´¹è€…ç»„ç®¡ç†](#6-æ¶ˆè´¹è€…ç»„ç®¡ç†)
7. [æ­»ä¿¡é˜Ÿåˆ—å¤„ç†](#7-æ­»ä¿¡é˜Ÿåˆ—å¤„ç†)
8. [æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ](#8-æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¬ æ¶ˆæ¯é˜Ÿåˆ—åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**
> 
> æƒ³è±¡ä¸€ä¸‹é‚®å±€çš„å·¥ä½œæ–¹å¼ï¼š
> - ä½ å†™å¥½ä¿¡ä»¶æŠ•å…¥é‚®ç®±ï¼ˆå‘é€æ¶ˆæ¯ï¼‰
> - é‚®å±€æ”¶é›†ã€åˆ†æ‹£ã€å­˜å‚¨ä¿¡ä»¶ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
> - é‚®é€’å‘˜æŒ‰åœ°å€æ´¾é€ï¼ˆæ¶ˆæ¯æ¶ˆè´¹ï¼‰
> - å³ä½¿æ”¶ä¿¡äººæš‚æ—¶ä¸åœ¨å®¶ï¼Œä¿¡ä»¶ä¹Ÿä¼šä¿å­˜ç­‰å¾…ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼šä¸€ç§å¼‚æ­¥é€šä¿¡æ–¹å¼
ä½œç”¨ï¼šè®©ä¸åŒçš„æœåŠ¡ä¹‹é—´å¯ä»¥"å†™ä¿¡"äº¤æµï¼Œè€Œä¸ç”¨é¢å¯¹é¢"æ‰“ç”µè¯"
å¥½å¤„ï¼šå‘é€æ–¹ä¸ç”¨ç­‰æ¥æ”¶æ–¹ç«‹å³å›å¤ï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡
```

### 1.2 ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**

```
é—®é¢˜åœºæ™¯ï¼šè®¢å•æœåŠ¡éœ€è¦é€šçŸ¥åº“å­˜æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€ç‰©æµæœåŠ¡

ä¼ ç»ŸåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š
è®¢å•æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€â–¶ åº“å­˜æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€â–¶ æ”¯ä»˜æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€â–¶ ç‰©æµæœåŠ¡
   â¬‡ï¸                â¬‡ï¸                â¬‡ï¸                â¬‡ï¸
 ç­‰å¾…å“åº”           ç­‰å¾…å“åº”           ç­‰å¾…å“åº”          å¤„ç†å®Œæˆ

å¦‚æœä»»ä½•ä¸€ä¸ªæœåŠ¡æ…¢æˆ–è€…æŒ‚äº†ï¼Œæ•´ä¸ªæµç¨‹éƒ½ä¼šå¡ä½ï¼
```

**âœ… æ¶ˆæ¯é˜Ÿåˆ—çš„è§£å†³æ–¹æ¡ˆ**

```
å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼š
è®¢å•æœåŠ¡ â”€â”€å‘æ¶ˆæ¯â”€â”€â–¶ æ¶ˆæ¯é˜Ÿåˆ— â”€â”€â–¶ åº“å­˜æœåŠ¡
                           â”œâ”€â”€â–¶ æ”¯ä»˜æœåŠ¡  
                           â””â”€â”€â–¶ ç‰©æµæœåŠ¡

è®¢å•æœåŠ¡å‘å®Œæ¶ˆæ¯å°±ç»§ç»­å¹²åˆ«çš„äº‹ï¼Œå…¶ä»–æœåŠ¡å„è‡ªå¤„ç†ï¼Œäº’ä¸å½±å“
```

### 1.3 æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒç»„ä»¶


**ğŸ“‹ åŸºæœ¬è§’è‰²**

| è§’è‰² | è¯´æ˜ | ç”Ÿæ´»ç±»æ¯” |
|------|------|----------|
| **ç”Ÿäº§è€…ï¼ˆProducerï¼‰** | å‘é€æ¶ˆæ¯çš„æœåŠ¡ | å†™ä¿¡çš„äºº |
| **é˜Ÿåˆ—ï¼ˆQueueï¼‰** | å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ | é‚®ç®± |
| **æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰** | æ¥æ”¶å¤„ç†æ¶ˆæ¯çš„æœåŠ¡ | æ”¶ä¿¡çš„äºº |
| **æ¶ˆæ¯ä»£ç†ï¼ˆBrokerï¼‰** | ç®¡ç†é˜Ÿåˆ—çš„ä¸­é—´ä»¶ | é‚®å±€ |

**ğŸ”„ å·¥ä½œæµç¨‹å›¾**

```
ç”Ÿäº§è€…         æ¶ˆæ¯ä»£ç†         æ¶ˆè´¹è€…
  |              |              |
  |â”€â”€[1]å‘é€æ¶ˆæ¯â”€â”€â–¶|              |
  |              |â”€â”€[2]å­˜å‚¨æ¶ˆæ¯   |
  |              |              |
  |              |â—€â”€[3]æ‹‰å–æ¶ˆæ¯â”€â”¤|
  |              |              |
  |              |â”€â”€[4]åˆ é™¤æ¶ˆæ¯â”€â”€â–¶|
```

---

## 2. ğŸŒŠ Kafkaæ·±å…¥åº”ç”¨


### 2.1 Kafkaæ˜¯ä»€ä¹ˆï¼Ÿ


> **ğŸ’¡ ç®€å•ç†è§£**
> 
> Kafkaå°±åƒä¸€ä¸ª**è¶…å¤§å®¹é‡çš„ä¼ é€å¸¦**ï¼š
> - æ¶ˆæ¯åƒè´§ç‰©ä¸€æ ·æ”¾åœ¨ä¼ é€å¸¦ä¸Š
> - å¯ä»¥åŒæ—¶æœ‰å¾ˆå¤šæ¡ä¼ é€å¸¦ï¼ˆTopicï¼‰
> - æ¯æ¡ä¼ é€å¸¦å¯ä»¥åˆ†æˆå¤šæ®µï¼ˆPartitionï¼‰
> - å¤šä¸ªå·¥äººå¯ä»¥åŒæ—¶ä»ä¸åŒä½ç½®å–è´§ï¼ˆConsumer Groupï¼‰

**ğŸ”¸ Kafkaç‰¹ç‚¹**
```
é«˜ååé‡ï¼šæ¯ç§’å¤„ç†æ•°ç™¾ä¸‡æ¡æ¶ˆæ¯
æŒä¹…åŒ–ï¼šæ¶ˆæ¯å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä¸ä¼šä¸¢å¤±
åˆ†å¸ƒå¼ï¼šå¯ä»¥éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Š
å¯æ‰©å±•ï¼šå¯ä»¥åŠ¨æ€å¢åŠ æœåŠ¡å™¨å’Œåˆ†åŒº
```

### 2.2 Kafkaæ ¸å¿ƒæ¦‚å¿µè¯¦è§£


**ğŸ“Š Kafkaæ¶æ„å›¾**

```
Topic: ç”¨æˆ·è¡Œä¸ºæ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Partition 0: [æ¶ˆæ¯1][æ¶ˆæ¯4][æ¶ˆæ¯7]...                    â”‚
â”‚ Partition 1: [æ¶ˆæ¯2][æ¶ˆæ¯5][æ¶ˆæ¯8]...                    â”‚  
â”‚ Partition 2: [æ¶ˆæ¯3][æ¶ˆæ¯6][æ¶ˆæ¯9]...                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†‘
         æ¶ˆæ¯æŒ‰keyåˆ†é…åˆ°ä¸åŒåˆ†åŒº
```

**ğŸ”‘ é‡è¦æ¦‚å¿µè¯´æ˜**

- **Topicï¼ˆä¸»é¢˜ï¼‰**ï¼šå°±åƒæ˜¯ä¸€ä¸ª**é¢‘é“**ï¼Œæ¯”å¦‚"è®¢å•äº‹ä»¶é¢‘é“"ã€"ç”¨æˆ·è¡Œä¸ºé¢‘é“"
- **Partitionï¼ˆåˆ†åŒºï¼‰**ï¼šæŠŠä¸€ä¸ªé¢‘é“**åˆ†æˆå¤šä¸ªå°é˜Ÿåˆ—**ï¼Œæé«˜å¤„ç†é€Ÿåº¦
- **Offsetï¼ˆåç§»é‡ï¼‰**ï¼šæ¯æ¡æ¶ˆæ¯çš„**ç¼–å·**ï¼Œæ¶ˆè´¹è€…è®°ä½è¯»åˆ°å“ªé‡Œäº†
- **Consumer Groupï¼ˆæ¶ˆè´¹è€…ç»„ï¼‰**ï¼š**ä¸€ç¾¤æ¶ˆè´¹è€…åä½œ**ï¼Œç¡®ä¿æ¯æ¡æ¶ˆæ¯åªè¢«å¤„ç†ä¸€æ¬¡

### 2.3 Javaä¸­ä½¿ç”¨Kafka


**ğŸ› ï¸ åŸºç¡€ä¾èµ–é…ç½®**

```xml
<dependency>
    <groupId>org.springframework.kafka</groupId>
    <artifactId>spring-kafka</artifactId>
</dependency>
```

**ğŸ“¤ æ¶ˆæ¯ç”Ÿäº§è€…ç¤ºä¾‹**

```java
@Component
public class OrderEventProducer {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    // å‘é€è®¢å•åˆ›å»ºäº‹ä»¶
    public void sendOrderCreated(String orderId, String orderData) {
        String topic = "order-events";
        String key = orderId; // ç”¨è®¢å•IDä½œä¸ºkeyï¼Œç¡®ä¿åŒä¸€è®¢å•çš„æ¶ˆæ¯è¿›å…¥åŒä¸€åˆ†åŒº
        
        kafkaTemplate.send(topic, key, orderData);
        System.out.println("è®¢å•äº‹ä»¶å·²å‘é€ï¼š" + orderId);
    }
}
```

**ğŸ“¥ æ¶ˆæ¯æ¶ˆè´¹è€…ç¤ºä¾‹**

```java
@Component
public class InventoryEventConsumer {
    
    @KafkaListener(topics = "order-events", groupId = "inventory-group")
    public void handleOrderEvent(String orderData) {
        System.out.println("åº“å­˜æœåŠ¡æ”¶åˆ°è®¢å•äº‹ä»¶ï¼š" + orderData);
        
        // å¤„ç†åº“å­˜æ‰£å‡é€»è¾‘
        processInventoryUpdate(orderData);
    }
    
    private void processInventoryUpdate(String orderData) {
        // å…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
    }
}
```

### 2.4 Kafkaé…ç½®æœ€ä½³å®è·µ


**âš™ï¸ ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**

```yaml
spring:
  kafka:
    producer:
      # æ¶ˆæ¯å‘é€ç¡®è®¤æœºåˆ¶
      acks: all  # ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤ï¼Œä¿è¯ä¸ä¸¢æ¶ˆæ¯
      retries: 3 # é‡è¯•3æ¬¡
      batch-size: 16384 # æ‰¹é‡å‘é€å¤§å°
    consumer:
      group-id: ${spring.application.name}
      auto-offset-reset: latest # ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹
      enable-auto-commit: false # æ‰‹åŠ¨æäº¤åç§»é‡ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
```

---

## 3. ğŸ° RabbitMQå®æˆ˜ä½¿ç”¨


### 3.1 RabbitMQ vs Kafka


> **ğŸ’­ å½¢è±¡å¯¹æ¯”**
> 
> **RabbitMQ**åƒ**é‚®å±€ç³»ç»Ÿ**ï¼š
> - æœ‰å„ç§é‚®ç®±ç±»å‹ï¼ˆç›´æŠ•ã€è½¬å‘ã€å¹¿æ’­ï¼‰
> - é‚®ä»¶è·¯ç”±è§„åˆ™å¤æ‚ä½†çµæ´»
> - é€‚åˆå¤æ‚çš„æ¶ˆæ¯åˆ†å‘åœºæ™¯
> 
> **Kafka**åƒ**å·¥å‚ä¼ é€å¸¦**ï¼š
> - é«˜é€Ÿå¤§é‡å¤„ç†
> - è·¯ç”±ç›¸å¯¹ç®€å•
> - é€‚åˆå¤§æ•°æ®æµå¤„ç†

**ğŸ“Š ç‰¹æ€§å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | RabbitMQ | Kafka |
|------|----------|-------|
| **æ¶ˆæ¯è·¯ç”±** | âœ… éå¸¸çµæ´» | âš¡ ç›¸å¯¹ç®€å• |
| **ååé‡** | âš¡ ä¸­ç­‰ | âœ… éå¸¸é«˜ |
| **æ¶ˆæ¯æŒä¹…åŒ–** | âœ… æ”¯æŒ | âœ… é»˜è®¤æŒä¹…åŒ– |
| **å­¦ä¹ éš¾åº¦** | ğŸ“š ä¸­ç­‰ | ğŸ“š è¾ƒé«˜ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚ä¸šåŠ¡æµç¨‹ | å¤§æ•°æ®å¤„ç† |

### 3.2 RabbitMQæ ¸å¿ƒæ¦‚å¿µ


**ğŸ—ï¸ RabbitMQæ¶æ„**

```
ç”Ÿäº§è€… â”€â”€æ¶ˆæ¯â”€â”€â–¶ Exchange â”€â”€è·¯ç”±è§„åˆ™â”€â”€â–¶ Queue â”€â”€â–¶ æ¶ˆè´¹è€…
              (äº¤æ¢æœº)              (é˜Ÿåˆ—)
                 â”‚
                 â–¼
            Binding + Routing Key
            (ç»‘å®šå…³ç³» + è·¯ç”±é”®)
```

**ğŸ”‘ æ ¸å¿ƒç»„ä»¶è¯´æ˜**

- **Exchangeï¼ˆäº¤æ¢æœºï¼‰**ï¼šæ¶ˆæ¯çš„**"åˆ†æ‹£ä¸­å¿ƒ"**ï¼Œå†³å®šæ¶ˆæ¯å»å“ªä¸ªé˜Ÿåˆ—
- **Queueï¼ˆé˜Ÿåˆ—ï¼‰**ï¼šæ¶ˆæ¯çš„**"å­˜å‚¨ç®±"**ï¼Œç­‰å¾…æ¶ˆè´¹è€…æ¥å–
- **Bindingï¼ˆç»‘å®šï¼‰**ï¼šäº¤æ¢æœºå’Œé˜Ÿåˆ—ä¹‹é—´çš„**"è¿æ¥çº¿"**
- **Routing Keyï¼ˆè·¯ç”±é”®ï¼‰**ï¼šæ¶ˆæ¯çš„**"åœ°å€æ ‡ç­¾"**

### 3.3 RabbitMQäº¤æ¢æœºç±»å‹


**ğŸ“® Direct Exchangeï¼ˆç›´æ¥äº¤æ¢æœºï¼‰**

```
åœºæ™¯ï¼šè®¢å•çŠ¶æ€æ›´æ–°ï¼Œä¸åŒçŠ¶æ€å‘ç»™ä¸åŒæœåŠ¡

Exchange: order-status
    â”‚
    â”œâ”€[routing key: "created"]â”€â”€â–¶ Queue: order-created â”€â”€â–¶ åº“å­˜æœåŠ¡
    â”œâ”€[routing key: "paid"]â”€â”€â”€â”€â–¶ Queue: order-paid â”€â”€â”€â”€â–¶ æ”¯ä»˜æœåŠ¡  
    â””â”€[routing key: "shipped"]â”€â–¶ Queue: order-shipped â”€â–¶ ç‰©æµæœåŠ¡
```

**ğŸ“¢ Fanout Exchangeï¼ˆå¹¿æ’­äº¤æ¢æœºï¼‰**

```
åœºæ™¯ï¼šç”¨æˆ·æ³¨å†ŒæˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰ç›¸å…³æœåŠ¡

Exchange: user-registered
    â”‚
    â”œâ”€â”€â–¶ Queue: send-welcome-email â”€â”€â–¶ é‚®ä»¶æœåŠ¡
    â”œâ”€â”€â–¶ Queue: create-user-profile â”€â–¶ ç”¨æˆ·ä¸­å¿ƒ
    â””â”€â”€â–¶ Queue: init-user-wallet â”€â”€â”€â”€â–¶ é’±åŒ…æœåŠ¡

æ‰€æœ‰é˜Ÿåˆ—éƒ½ä¼šæ”¶åˆ°åŒæ ·çš„æ¶ˆæ¯
```

**ğŸ¯ Topic Exchangeï¼ˆä¸»é¢˜äº¤æ¢æœºï¼‰**

```
åœºæ™¯ï¼šæ—¥å¿—æ”¶é›†ï¼Œæ ¹æ®çº§åˆ«å’Œæ¨¡å—åˆ†å‘

Exchange: logs
    â”‚
    â”œâ”€[pattern: "error.*"]â”€â”€â”€â”€â–¶ Queue: error-logs â”€â”€â–¶ ç›‘æ§æœåŠ¡
    â”œâ”€[pattern: "*.payment.*"]â”€â–¶ Queue: payment-logs â”€â–¶ æ”¯ä»˜å›¢é˜Ÿ
    â””â”€[pattern: "info.order.*"]â–¶ Queue: order-logs â”€â”€â–¶ è®¢å•å›¢é˜Ÿ

æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼š
- * åŒ¹é…ä¸€ä¸ªå•è¯
- # åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå•è¯
```

### 3.4 Spring Booté›†æˆRabbitMQ


**ğŸ› ï¸ ä¾èµ–é…ç½®**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

**âš™ï¸ é…ç½®æ–‡ä»¶**

```yaml
spring:
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest
    virtual-host: /
```

**ğŸ“¤ ç”Ÿäº§è€…é…ç½®**

```java
@Configuration
public class RabbitMQConfig {
    
    // å®šä¹‰äº¤æ¢æœº
    @Bean
    public DirectExchange orderExchange() {
        return new DirectExchange("order.exchange");
    }
    
    // å®šä¹‰é˜Ÿåˆ—
    @Bean
    public Queue inventoryQueue() {
        return QueueBuilder.durable("inventory.queue").build();
    }
    
    // ç»‘å®šå…³ç³»
    @Bean
    public Binding inventoryBinding() {
        return BindingBuilder
            .bind(inventoryQueue())
            .to(orderExchange())
            .with("order.created");
    }
}
```

**ğŸ“¥ æ¶ˆæ¯å‘é€å’Œæ¥æ”¶**

```java
@Service
public class OrderMessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // å‘é€æ¶ˆæ¯
    public void sendOrderCreated(Order order) {
        rabbitTemplate.convertAndSend(
            "order.exchange", 
            "order.created", 
            order
        );
    }
    
    // æ¥æ”¶æ¶ˆæ¯
    @RabbitListener(queues = "inventory.queue")
    public void handleOrderCreated(Order order) {
        System.out.println("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶ï¼š" + order.getId());
        // å…·ä½“ä¸šåŠ¡é€»è¾‘
    }
}
```

---

## 4. ğŸ›¤ï¸ æ¶ˆæ¯è·¯ç”±ä¸åˆ†å‘


### 4.1 è·¯ç”±ç­–ç•¥é€‰æ‹©


> **ğŸ“Œ æ ¸å¿ƒç†è§£**
> 
> æ¶ˆæ¯è·¯ç”±å°±æ˜¯å†³å®š"è¿™æ¡æ¶ˆæ¯åº”è¯¥å‘ç»™è°"çš„è§„åˆ™ã€‚
> å°±åƒå¿«é€’åˆ†æ‹£ï¼šçœ‹åœ°å€æ ‡ç­¾ï¼Œå†³å®šæ”¾åˆ°å“ªä¸ªé…é€è½¦ä¸Šã€‚

**ğŸ¯ å¸¸è§è·¯ç”±åœºæ™¯**

| åœºæ™¯ | è·¯ç”±æ–¹å¼ | ç¤ºä¾‹ |
|------|----------|------|
| **ä¸€å¯¹ä¸€é€šçŸ¥** | Directè·¯ç”± | è®¢å•æ”¯ä»˜æˆåŠŸ â†’ å‘è´§æœåŠ¡ |
| **ä¸€å¯¹å¤šå¹¿æ’­** | Fanoutè·¯ç”± | ç”¨æˆ·æ³¨å†Œ â†’ æ‰€æœ‰ç›¸å…³æœåŠ¡ |
| **æ¡ä»¶åˆ†å‘** | Topicè·¯ç”± | æ—¥å¿—çº§åˆ« â†’ ä¸åŒå¤„ç†æœåŠ¡ |
| **è´Ÿè½½å‡è¡¡** | è½®è¯¢åˆ†å‘ | å¤šä¸ªç›¸åŒæœåŠ¡å®ä¾‹ |

### 4.2 åŠ¨æ€è·¯ç”±å®ç°


**ğŸ”„ åŸºäºå†…å®¹çš„æ™ºèƒ½è·¯ç”±**

```java
@Service
public class SmartMessageRouter {
    
    public void routeOrderMessage(OrderEvent event) {
        String routingKey = determineRoutingKey(event);
        
        rabbitTemplate.convertAndSend(
            "smart.exchange", 
            routingKey, 
            event
        );
    }
    
    private String determineRoutingKey(OrderEvent event) {
        // æ ¹æ®è®¢å•ç±»å‹å’ŒçŠ¶æ€å†³å®šè·¯ç”±
        if (event.getType().equals("VIP_ORDER")) {
            return "vip.order." + event.getStatus();
        } else if (event.getAmount() > 1000) {
            return "big.order." + event.getStatus();
        } else {
            return "normal.order." + event.getStatus();
        }
    }
}
```

### 4.3 æ¶ˆæ¯åˆ†å‘ç­–ç•¥


**âš–ï¸ è´Ÿè½½å‡è¡¡åˆ†å‘**

```
å¤šä¸ªç›¸åŒæœåŠ¡å®ä¾‹æ¶ˆè´¹åŒä¸€ä¸ªé˜Ÿåˆ—ï¼š

Queue: order-processing
    â”‚
    â”œâ”€â”€â–¶ è®¢å•æœåŠ¡å®ä¾‹1 (å¤„ç†ä¸­ï¼šè®¢å•001)
    â”œâ”€â”€â–¶ è®¢å•æœåŠ¡å®ä¾‹2 (å¤„ç†ä¸­ï¼šè®¢å•002)
    â””â”€â”€â–¶ è®¢å•æœåŠ¡å®ä¾‹3 (ç©ºé—²çŠ¶æ€)

RabbitMQè‡ªåŠ¨è½®è¯¢åˆ†å‘ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡
```

**ğŸ¯ ä¼˜å…ˆçº§åˆ†å‘**

```java
@Configuration
public class PriorityQueueConfig {
    
    @Bean
    public Queue priorityQueue() {
        return QueueBuilder
            .durable("priority.queue")
            .withArgument("x-max-priority", 10) // è®¾ç½®æœ€å¤§ä¼˜å…ˆçº§
            .build();
    }
}

// å‘é€é«˜ä¼˜å…ˆçº§æ¶ˆæ¯
rabbitTemplate.convertAndSend("priority.queue", message, msg -> {
    msg.getMessageProperties().setPriority(9); // è®¾ç½®ä¼˜å…ˆçº§
    return msg;
});
```

---

## 5. ğŸ’¾ æŒä¹…åŒ–ä¸å¯é æ€§æœºåˆ¶


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯æŒä¹…åŒ–ï¼Ÿ


> **âš ï¸ é—®é¢˜åœºæ™¯**
> 
> å¦‚æœæ¶ˆæ¯åªå­˜åœ¨å†…å­˜ä¸­ï¼š
> - æœåŠ¡å™¨é‡å¯ â†’ æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±
> - ç³»ç»Ÿå´©æºƒ â†’ æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯ä¸¢å¤±
> - ç½‘ç»œæ–­å¼€ â†’ ä¼ è¾“ä¸­çš„æ¶ˆæ¯ä¸¢å¤±

**ğŸ”’ æŒä¹…åŒ–ä¿éšœæœºåˆ¶**

```
æ¶ˆæ¯æŒä¹…åŒ–çš„ä¸‰ä¸ªå±‚æ¬¡ï¼š

1. äº¤æ¢æœºæŒä¹…åŒ–ï¼šæœåŠ¡å™¨é‡å¯åäº¤æ¢æœºè¿˜åœ¨
2. é˜Ÿåˆ—æŒä¹…åŒ–ï¼šæœåŠ¡å™¨é‡å¯åé˜Ÿåˆ—è¿˜åœ¨  
3. æ¶ˆæ¯æŒä¹…åŒ–ï¼šæœåŠ¡å™¨é‡å¯åæ¶ˆæ¯è¿˜åœ¨

åªæœ‰ä¸‰ä¸ªéƒ½å¼€å¯ï¼Œæ¶ˆæ¯æ‰çœŸæ­£å®‰å…¨ï¼
```

### 5.2 RabbitMQæŒä¹…åŒ–é…ç½®


**ğŸ› ï¸ å®Œæ•´æŒä¹…åŒ–è®¾ç½®**

```java
@Configuration
public class DurableConfig {
    
    // æŒä¹…åŒ–äº¤æ¢æœº
    @Bean
    public DirectExchange durableExchange() {
        return ExchangeBuilder
            .directExchange("durable.exchange")
            .durable(true) // äº¤æ¢æœºæŒä¹…åŒ–
            .build();
    }
    
    // æŒä¹…åŒ–é˜Ÿåˆ—
    @Bean
    public Queue durableQueue() {
        return QueueBuilder
            .durable("durable.queue") // é˜Ÿåˆ—æŒä¹…åŒ–
            .build();
    }
}

// å‘é€æŒä¹…åŒ–æ¶ˆæ¯
public void sendDurableMessage(String message) {
    rabbitTemplate.convertAndSend("durable.exchange", "key", message, msg -> {
        msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT); // æ¶ˆæ¯æŒä¹…åŒ–
        return msg;
    });
}
```

### 5.3 KafkaæŒä¹…åŒ–æœºåˆ¶


**ğŸ“Š KafkaæŒä¹…åŒ–ç­–ç•¥**

```
Kafkaçš„æŒä¹…åŒ–æ˜¯é»˜è®¤çš„ï¼š

æ¶ˆæ¯å†™å…¥æµç¨‹ï¼š
ç”Ÿäº§è€… â”€â”€â–¶ Leaderåˆ†åŒº â”€â”€â–¶ ç£ç›˜æ–‡ä»¶
            â”‚
            â–¼
        Followeråˆ†åŒº â”€â”€â–¶ ç£ç›˜æ–‡ä»¶

é…ç½®å‰¯æœ¬æ•°é‡ä¿è¯å¯é æ€§ï¼š
replication-factor: 3  # æ¯ä¸ªåˆ†åŒº3ä¸ªå‰¯æœ¬
min.insync.replicas: 2 # è‡³å°‘2ä¸ªå‰¯æœ¬ç¡®è®¤å†™å…¥æˆåŠŸ
```

### 5.4 æ¶ˆæ¯ç¡®è®¤æœºåˆ¶


**âœ… ç”Ÿäº§è€…ç¡®è®¤**

```java
// RabbitMQç”Ÿäº§è€…ç¡®è®¤
@Configuration
public class ConfirmConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate() {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯ç”Ÿäº§è€…ç¡®è®¤
        template.setMandatory(true);
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.out.println("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š" + cause);
            }
        });
        
        return template;
    }
}
```

**âœ… æ¶ˆè´¹è€…ç¡®è®¤**

```java
// æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼
@RabbitListener(queues = "important.queue")
public void handleImportantMessage(String message, Channel channel, 
                                 @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
    try {
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        processMessage(message);
        
        // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
        channel.basicAck(tag, false);
        
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œæ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
        channel.basicNack(tag, false, true);
    }
}
```

---

## 6. ğŸ‘¥ æ¶ˆè´¹è€…ç»„ç®¡ç†


### 6.1 ä»€ä¹ˆæ˜¯æ¶ˆè´¹è€…ç»„ï¼Ÿ


> **ğŸ¢ å›¢é˜Ÿåä½œç±»æ¯”**
> 
> æ¶ˆè´¹è€…ç»„å°±åƒä¸€ä¸ª**å·¥ä½œå›¢é˜Ÿ**ï¼š
> - ä¸€ä¸ªå›¢é˜Ÿå¤„ç†ä¸€ç±»ä»»åŠ¡ï¼ˆTopicï¼‰
> - å›¢é˜Ÿæˆå‘˜åˆ†å·¥åˆä½œï¼Œä¸é‡å¤åŠ³åŠ¨
> - æœ‰äººè¯·å‡ï¼Œå…¶ä»–äººé¡¶ä¸Š
> - æ–°äººåŠ å…¥ï¼Œè‡ªåŠ¨åˆ†é…å·¥ä½œ

**ğŸ”¸ æ¶ˆè´¹è€…ç»„æ ¸å¿ƒç‰¹ç‚¹**
```
åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„å†…ï¼š
âœ… æ¯æ¡æ¶ˆæ¯åªè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ï¼ˆé¿å…é‡å¤ï¼‰
âœ… æ¶ˆè´¹è€…å¯ä»¥åŠ¨æ€åŠ å…¥å’Œé€€å‡º
âœ… è‡ªåŠ¨è´Ÿè½½å‡è¡¡

ä¸åŒæ¶ˆè´¹è€…ç»„é—´ï¼š
âœ… æ¯ä¸ªç»„éƒ½èƒ½æ”¶åˆ°å®Œæ•´çš„æ¶ˆæ¯
âœ… å®ç°æ¶ˆæ¯çš„å¤šé‡å¤„ç†
```

### 6.2 Kafkaæ¶ˆè´¹è€…ç»„å®æˆ˜


**ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æ¶ˆè´¹è€…ç»„æ¶æ„å›¾**

```
Topic: order-events (3ä¸ªåˆ†åŒº)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Partition 0  â”‚ Partition 1  â”‚ Partition 2               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
   Consumer 1     Consumer 2     Consumer 3
   (è®¢å•ç»„)       (è®¢å•ç»„)       (è®¢å•ç»„)
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
            Consumer Group: order-group

åŒæ—¶ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¹Ÿåœ¨æ¶ˆè´¹ï¼š
   Consumer A     Consumer B
   (åº“å­˜ç»„)       (åº“å­˜ç»„)  
        â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            Consumer Group: inventory-group
```

**ğŸ› ï¸ Javaå®ç°æ¶ˆè´¹è€…ç»„**

```java
// è®¢å•å¤„ç†æ¶ˆè´¹è€…ç»„
@Component
public class OrderConsumerGroup {
    
    @KafkaListener(
        topics = "order-events",
        groupId = "order-processing-group",
        concurrency = "3" // 3ä¸ªå¹¶å‘æ¶ˆè´¹è€…
    )
    public void processOrder(ConsumerRecord<String, String> record) {
        String partition = "åˆ†åŒº" + record.partition();
        String offset = "åç§»é‡" + record.offset();
        
        System.out.println("è®¢å•ç»„å¤„ç†æ¶ˆæ¯ï¼š" + partition + ", " + offset);
        // å¤„ç†è®¢å•é€»è¾‘
    }
}

// åº“å­˜å¤„ç†æ¶ˆè´¹è€…ç»„  
@Component
public class InventoryConsumerGroup {
    
    @KafkaListener(
        topics = "order-events", 
        groupId = "inventory-processing-group"
    )
    public void updateInventory(String orderData) {
        System.out.println("åº“å­˜ç»„å¤„ç†æ¶ˆæ¯ï¼š" + orderData);
        // å¤„ç†åº“å­˜é€»è¾‘
    }
}
```

### 6.3 æ¶ˆè´¹è€…ç»„ç®¡ç†æœ€ä½³å®è·µ


**âš™ï¸ é…ç½®ä¼˜åŒ–**

```yaml
spring:
  kafka:
    consumer:
      # æ¶ˆè´¹è€…ç»„é…ç½®
      group-id: ${spring.application.name}-group
      max-poll-records: 100  # å•æ¬¡æ‹‰å–æ¶ˆæ¯æ•°é‡
      session-timeout-ms: 30000  # ä¼šè¯è¶…æ—¶æ—¶é—´
      heartbeat-interval-ms: 3000  # å¿ƒè·³é—´éš”
      auto-offset-reset: latest  # åç§»é‡é‡ç½®ç­–ç•¥
```

**ğŸ“Š åŠ¨æ€æ‰©ç¼©å®¹ç­–ç•¥**

| åœºæ™¯ | æ“ä½œ | æ•ˆæœ |
|------|------|------|
| **æ¶ˆæ¯ç§¯å‹** | å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ | æé«˜å¤„ç†é€Ÿåº¦ |
| **è´Ÿè½½è¾ƒè½»** | å‡å°‘æ¶ˆè´¹è€…å®ä¾‹ | èŠ‚çœèµ„æº |
| **æ¶ˆè´¹è€…æ•…éšœ** | è‡ªåŠ¨é‡æ–°åˆ†é… | ä¿è¯å¯ç”¨æ€§ |

**ğŸ” ç›‘æ§æŒ‡æ ‡**

```java
@Component
public class ConsumerGroupMonitor {
    
    @EventListener
    public void handleRebalance(ConsumerRebalanceEvent event) {
        System.out.println("æ¶ˆè´¹è€…ç»„é‡æ–°å¹³è¡¡ï¼š" + event.getPartitions());
        // è®°å½•é‡å¹³è¡¡äº‹ä»¶
    }
    
    @Scheduled(fixedRate = 30000)
    public void monitorLag() {
        // ç›‘æ§æ¶ˆè´¹å»¶è¿Ÿ
        // å¦‚æœå»¶è¿Ÿè¿‡å¤§ï¼Œå‘Šè­¦å¹¶è€ƒè™‘æ‰©å®¹
    }
}
```

---

## 7. ğŸ’€ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†


### 7.1 ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼Ÿ


> **ğŸ¥ åŒ»é™¢ç±»æ¯”**
> 
> æ­»ä¿¡é˜Ÿåˆ—å°±åƒåŒ»é™¢çš„**é‡ç—‡ç›‘æŠ¤å®¤**ï¼š
> - æ™®é€šç—…äººåœ¨æ™®é€šç—…æˆ¿æ²»ç–—ï¼ˆæ­£å¸¸æ¶ˆæ¯å¤„ç†ï¼‰
> - ç—…æƒ…ä¸¥é‡çš„è½¬å…¥ICUï¼ˆæ¶ˆæ¯å¤„ç†å¤±è´¥å¤šæ¬¡ï¼‰
> - ICUæœ‰ä¸“é—¨çš„åŒ»ç”Ÿå’Œè®¾å¤‡ï¼ˆç‰¹æ®Šçš„å¤„ç†é€»è¾‘ï¼‰
> - æœ€ç»ˆè¦ä¹ˆåº·å¤å‡ºé™¢ï¼Œè¦ä¹ˆè®°å½•å¤‡æ¡ˆï¼ˆæˆåŠŸå¤„ç†æˆ–è®°å½•æ—¥å¿—ï¼‰

**ğŸ”¸ ä»€ä¹ˆæƒ…å†µä¸‹æ¶ˆæ¯ä¼š"æ­»æ‰"ï¼Ÿ**

```
æ¶ˆæ¯å˜æˆæ­»ä¿¡çš„å¸¸è§åŸå› ï¼š

1. æ¶ˆæ¯è¢«æ‹’ç» (basic.reject/basic.nack) ä¸”ä¸é‡æ–°å…¥é˜Ÿ
2. æ¶ˆæ¯è¿‡æœŸ (TTLè¶…æ—¶)
3. é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼Œæ—§æ¶ˆæ¯è¢«æŒ¤å‡º
4. æ¶ˆæ¯å¤„ç†å¼‚å¸¸æ¬¡æ•°è¶…è¿‡é™åˆ¶
```

### 7.2 RabbitMQæ­»ä¿¡é˜Ÿåˆ—é…ç½®


**ğŸ› ï¸ æ­»ä¿¡é˜Ÿåˆ—æ¶æ„è®¾è®¡**

```
æ­£å¸¸å¤„ç†æµç¨‹ï¼š
ç”Ÿäº§è€… â”€â”€â–¶ æ™®é€šé˜Ÿåˆ— â”€â”€â–¶ æ¶ˆè´¹è€… â”€â”€â–¶ å¤„ç†æˆåŠŸ

å¼‚å¸¸å¤„ç†æµç¨‹ï¼š
ç”Ÿäº§è€… â”€â”€â–¶ æ™®é€šé˜Ÿåˆ— â”€â”€â–¶ æ¶ˆè´¹è€… â”€â”€â–¶ å¤„ç†å¤±è´¥
                â”‚                      â”‚
                â–¼                      â–¼
            æ­»ä¿¡äº¤æ¢æœº â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¶…è¿‡é‡è¯•æ¬¡æ•°
                â”‚
                â–¼
            æ­»ä¿¡é˜Ÿåˆ— â”€â”€â–¶ ç‰¹æ®Šå¤„ç†é€»è¾‘
```

**âš™ï¸ å®Œæ•´é…ç½®ä»£ç **

```java
@Configuration
public class DeadLetterConfig {
    
    // æ™®é€šé˜Ÿåˆ—é…ç½®
    @Bean
    public Queue normalQueue() {
        return QueueBuilder
            .durable("normal.queue")
            // é…ç½®æ­»ä¿¡äº¤æ¢æœº
            .withArgument("x-dead-letter-exchange", "dlx.exchange")
            .withArgument("x-dead-letter-routing-key", "dead.message")
            // è®¾ç½®æ¶ˆæ¯TTLï¼ˆå¯é€‰ï¼‰
            .withArgument("x-message-ttl", 60000) // 60ç§’è¿‡æœŸ
            .build();
    }
    
    // æ­»ä¿¡äº¤æ¢æœº
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("dlx.exchange");
    }
    
    // æ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("dead.letter.queue").build();
    }
    
    // ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder
            .bind(deadLetterQueue())
            .to(deadLetterExchange())
            .with("dead.message");
    }
}
```

### 7.3 æ­»ä¿¡å¤„ç†ç­–ç•¥


**ğŸ”„ æ™ºèƒ½é‡è¯•æœºåˆ¶**

```java
@Service
public class MessageProcessor {
    
    private static final int MAX_RETRY = 3;
    
    @RabbitListener(queues = "normal.queue")
    public void processMessage(String message, 
                              @Header Map<String, Object> headers,
                              Channel channel,
                              @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
        
        try {
            // è·å–é‡è¯•æ¬¡æ•°
            Integer retryCount = (Integer) headers.get("x-retry-count");
            if (retryCount == null) retryCount = 0;
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            doBusinessLogic(message);
            
            // å¤„ç†æˆåŠŸï¼Œç¡®è®¤æ¶ˆæ¯
            channel.basicAck(tag, false);
            
        } catch (Exception e) {
            handleProcessingError(message, headers, channel, tag, e);
        }
    }
    
    private void handleProcessingError(String message, Map<String, Object> headers,
                                     Channel channel, long tag, Exception e) {
        try {
            Integer retryCount = (Integer) headers.get("x-retry-count");
            if (retryCount == null) retryCount = 0;
            
            if (retryCount < MAX_RETRY) {
                // è¿˜å¯ä»¥é‡è¯•ï¼Œå»¶è¿Ÿåé‡æ–°å…¥é˜Ÿ
                retryCount++;
                headers.put("x-retry-count", retryCount);
                
                rabbitTemplate.convertAndSend("retry.exchange", "retry.key", message, msg -> {
                    msg.getMessageProperties().getHeaders().putAll(headers);
                    return msg;
                });
                
                channel.basicAck(tag, false); // ç¡®è®¤åŸæ¶ˆæ¯
                
            } else {
                // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œæ‹’ç»æ¶ˆæ¯ï¼ˆä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼‰
                channel.basicNack(tag, false, false);
            }
            
        } catch (IOException ioException) {
            // å¤„ç†IOå¼‚å¸¸
        }
    }
}
```

**ğŸš¨ æ­»ä¿¡ç›‘æ§å’Œå‘Šè­¦**

```java
@Component
public class DeadLetterHandler {
    
    @RabbitListener(queues = "dead.letter.queue")
    public void handleDeadLetter(String message, 
                                @Header Map<String, Object> headers) {
        
        // è®°å½•æ­»ä¿¡æ—¥å¿—
        logDeadLetter(message, headers);
        
        // å‘é€å‘Šè­¦
        sendAlert(message, headers);
        
        // å°è¯•äººå·¥å¤„ç†æˆ–è®°å½•åˆ°æ•°æ®åº“
        saveForManualProcessing(message, headers);
    }
    
    private void sendAlert(String message, Map<String, Object> headers) {
        String alertMessage = String.format(
            "æ­»ä¿¡å‘Šè­¦ï¼šæ¶ˆæ¯ %s å¤„ç†å¤±è´¥ï¼ŒåŸå› ï¼š%s", 
            message, 
            headers.get("x-first-death-reason")
        );
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        alertService.send(alertMessage);
    }
}
```

---

## 8. ğŸ”„ æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ


### 8.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯å¹‚ç­‰æ€§ï¼Ÿ


> **ğŸ’³ é“¶è¡Œè½¬è´¦ç±»æ¯”**
> 
> å¹‚ç­‰æ€§å°±åƒé“¶è¡Œçš„**é‡å¤è½¬è´¦ä¿æŠ¤**ï¼š
> - ä½ ç‚¹å‡»"è½¬è´¦"æŒ‰é’®å¤šæ¬¡
> - é“¶è¡Œç³»ç»Ÿè¯†åˆ«å‡ºæ˜¯é‡å¤æ“ä½œ
> - åªæ‰§è¡Œä¸€æ¬¡è½¬è´¦ï¼Œä¸ä¼šé‡å¤æ‰£é’±
> - æœ€ç»ˆç»“æœå’Œç‚¹å‡»ä¸€æ¬¡å®Œå…¨ä¸€æ ·

**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§ï¼Ÿ**

```
æ¶ˆæ¯é‡å¤çš„å¸¸è§åœºæ™¯ï¼š

1. ç½‘ç»œé‡ä¼ ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´æ¶ˆæ¯é‡å¤å‘é€
2. æ¶ˆè´¹è€…é‡å¯ï¼šæ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯ä½†è¿˜æ²¡ç¡®è®¤å°±é‡å¯äº†
3. é‡å¹³è¡¡ï¼šKafkaæ¶ˆè´¹è€…ç»„é‡å¹³è¡¡å¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹
4. äººå·¥é‡è¯•ï¼šè¿ç»´äººå‘˜æ‰‹åŠ¨é‡æ–°å‘é€æ¶ˆæ¯

å¦‚æœæ²¡æœ‰å¹‚ç­‰æ€§ä¿æŠ¤ï¼š
è®¢å•å¯èƒ½è¢«é‡å¤åˆ›å»º âŒ
åº“å­˜å¯èƒ½è¢«é‡å¤æ‰£å‡ âŒ  
é‚®ä»¶å¯èƒ½è¢«é‡å¤å‘é€ âŒ
```

### 8.2 å¹‚ç­‰æ€§å®ç°ç­–ç•¥


**ğŸ†” å”¯ä¸€IDç­–ç•¥**

```java
@Service
public class IdempotentOrderService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public void processOrder(OrderMessage orderMsg) {
        String idempotentKey = "order:" + orderMsg.getOrderId() + ":" + orderMsg.getVersion();
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        if (redisTemplate.hasKey(idempotentKey)) {
            System.out.println("è®¢å•å·²å¤„ç†ï¼Œè·³è¿‡ï¼š" + orderMsg.getOrderId());
            return;
        }
        
        try {
            // å¤„ç†è®¢å•ä¸šåŠ¡é€»è¾‘
            createOrder(orderMsg);
            
            // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
            redisTemplate.opsForValue().set(idempotentKey, "processed", Duration.ofHours(24));
            
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ä¸æ ‡è®°ï¼Œå…è®¸é‡è¯•
            throw e;
        }
    }
}
```

**ğŸ—„ï¸ æ•°æ®åº“å”¯ä¸€çº¦æŸç­–ç•¥**

```sql
-- åˆ›å»ºå¹‚ç­‰æ€§è¡¨
CREATE TABLE message_idempotent (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(255) UNIQUE NOT NULL,  -- æ¶ˆæ¯å”¯ä¸€ID
    consumer_group VARCHAR(255) NOT NULL,     -- æ¶ˆè´¹è€…ç»„
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_msg_consumer (message_id, consumer_group)
);
```

```java
@Service 
public class DatabaseIdempotentService {
    
    @Transactional
    public void processMessage(String messageId, String consumerGroup, 
                              Runnable businessLogic) {
        
        try {
            // å°è¯•æ’å…¥å¹‚ç­‰æ€§è®°å½•
            messageIdempotentDao.insert(messageId, consumerGroup);
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            businessLogic.run();
            
        } catch (DuplicateKeyException e) {
            // é‡å¤æ¶ˆæ¯ï¼Œç›´æ¥å¿½ç•¥
            System.out.println("é‡å¤æ¶ˆæ¯ï¼Œå·²è·³è¿‡ï¼š" + messageId);
        }
    }
}
```

### 8.3 ä¸šåŠ¡å±‚é¢çš„å¹‚ç­‰è®¾è®¡


**ğŸ’° è´¦æˆ·ä½™é¢å¹‚ç­‰ç¤ºä¾‹**

```java
@Service
public class AccountService {
    
    // âŒ ä¸å¹‚ç­‰çš„è®¾è®¡
    public void addBalance_Wrong(String userId, BigDecimal amount) {
        Account account = accountDao.findByUserId(userId);
        account.setBalance(account.getBalance().add(amount));
        accountDao.update(account);
        // é‡å¤æ‰§è¡Œä¼šå¯¼è‡´ä½™é¢é‡å¤å¢åŠ 
    }
    
    // âœ… å¹‚ç­‰çš„è®¾è®¡
    @Transactional
    public void addBalance_Correct(String transactionId, String userId, BigDecimal amount) {
        
        // æ£€æŸ¥äº‹åŠ¡æ˜¯å¦å·²å¤„ç†
        if (transactionDao.exists(transactionId)) {
            return; // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        Account account = accountDao.findByUserId(userId);
        account.setBalance(account.getBalance().add(amount));
        accountDao.update(account);
        
        // è®°å½•äº‹åŠ¡
        Transaction transaction = new Transaction(transactionId, userId, amount);
        transactionDao.insert(transaction);
    }
}
```

**ğŸ“¦ åº“å­˜å¹‚ç­‰è®¾è®¡**

```java
@Service
public class InventoryService {
    
    // ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚é”å¹‚ç­‰
    @Retryable(maxAttempts = 3)
    public void reduceStock(String productId, Integer quantity, String orderId) {
        
        // æ£€æŸ¥è®¢å•æ˜¯å¦å·²ç»æ‰£å‡åº“å­˜
        if (stockLogDao.existsByOrderId(orderId)) {
            return;
        }
        
        // ä¹è§‚é”æ›´æ–°åº“å­˜
        int updated = inventoryDao.reduceStockWithVersion(productId, quantity);
        
        if (updated == 0) {
            throw new OptimisticLockException("åº“å­˜æ›´æ–°å†²çªï¼Œé‡è¯•");
        }
        
        // è®°å½•æ‰£å‡æ—¥å¿—
        StockLog log = new StockLog(orderId, productId, quantity);
        stockLogDao.insert(log);
    }
}
```

### 8.4 æ¶ˆæ¯å¹‚ç­‰æ€§æœ€ä½³å®è·µ


**ğŸ“‹ å¹‚ç­‰æ€§è®¾è®¡æ£€æŸ¥æ¸…å•**

```
âœ… æ¶ˆæ¯IDè®¾è®¡
   - ä½¿ç”¨ä¸šåŠ¡å”¯ä¸€æ ‡è¯†ï¼ˆè®¢å•å·+æ“ä½œç±»å‹ï¼‰
   - é¿å…ä½¿ç”¨æ—¶é—´æˆ³ç­‰å¯èƒ½é‡å¤çš„ID

âœ… å¹‚ç­‰æ€§å­˜å‚¨
   - Redisï¼šé€‚åˆä¸´æ—¶å¹‚ç­‰æ€§æ£€æŸ¥
   - æ•°æ®åº“ï¼šé€‚åˆéœ€è¦æŒä¹…åŒ–çš„åœºæ™¯
   - å†…å­˜ï¼šé€‚åˆå•æœºåº”ç”¨

âœ… è¶…æ—¶è®¾ç½®
   - è®¾ç½®åˆç†çš„å¹‚ç­‰æ€§è®°å½•è¿‡æœŸæ—¶é—´
   - å¹³è¡¡å­˜å‚¨æˆæœ¬å’Œé‡å¤é£é™©

âœ… å¼‚å¸¸å¤„ç†
   - å¤„ç†æˆåŠŸæ‰æ ‡è®°ä¸ºå·²å¤„ç†
   - å¤„ç†å¤±è´¥å…è®¸é‡è¯•

âœ… ç›‘æ§å‘Šè­¦
   - ç›‘æ§é‡å¤æ¶ˆæ¯æ¯”ä¾‹
   - å¹‚ç­‰æ€§ç¼“å­˜å‘½ä¸­ç‡
```

**âš™ï¸ é…ç½®ç¤ºä¾‹**

```yaml
# åº”ç”¨é…ç½®
app:
  message:
    idempotent:
      storage: redis  # redis/database/memory
      expire-hours: 24  # å¹‚ç­‰æ€§è®°å½•è¿‡æœŸæ—¶é—´
      key-prefix: "msg:idem:"  # Redis keyå‰ç¼€
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> **ğŸ¯ ä¸€å¥è¯æ€»ç»“**
> 
> æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¾®æœåŠ¡ä¹‹é—´å¼‚æ­¥é€šä¿¡çš„æ¡¥æ¢ï¼Œè®©æœåŠ¡è§£è€¦ã€æé«˜æ€§èƒ½ï¼Œä½†éœ€è¦å¤„ç†å¥½å¯é æ€§å’Œå¹‚ç­‰æ€§é—®é¢˜ã€‚

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µç†è§£**
```
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šå¼‚æ­¥é€šä¿¡å·¥å…·ï¼Œåƒé‚®å±€ä¸€æ ·ä¼ é€’æ¶ˆæ¯
â€¢ Kafkaï¼šé«˜ååé‡çš„æ¶ˆæ¯æµå¹³å°ï¼Œé€‚åˆå¤§æ•°æ®åœºæ™¯  
â€¢ RabbitMQï¼šåŠŸèƒ½ä¸°å¯Œçš„æ¶ˆæ¯ä»£ç†ï¼Œé€‚åˆå¤æ‚ä¸šåŠ¡
â€¢ æ¶ˆè´¹è€…ç»„ï¼šå›¢é˜Ÿåä½œæ¨¡å¼ï¼Œé¿å…é‡å¤å¤„ç†
â€¢ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¼‚å¸¸æ¶ˆæ¯çš„æ•‘æŠ¤ç«™
â€¢ å¹‚ç­‰æ€§ï¼šé‡å¤æ“ä½œçš„é˜²æŠ¤ç›¾
```

### 9.2 æŠ€æœ¯é€‰å‹æŒ‡å¯¼


**ğŸ“Š Kafka vs RabbitMQ é€‰æ‹©æŒ‡å—**

| åœºæ™¯ | æ¨èé€‰æ‹© | ç†ç”± |
|------|----------|------|
| **å¤§æ•°æ®å¤„ç†** | Kafka | é«˜ååé‡ï¼Œå¤©ç„¶æ”¯æŒæµå¤„ç† |
| **å¤æ‚ä¸šåŠ¡æµç¨‹** | RabbitMQ | çµæ´»çš„è·¯ç”±è§„åˆ™ |
| **å®æ—¶æ€§è¦æ±‚é«˜** | RabbitMQ | æ›´ä½çš„å»¶è¿Ÿ |
| **æ•°æ®æŒä¹…åŒ–é‡è¦** | Kafka | é»˜è®¤æŒä¹…åŒ–ï¼Œæ”¯æŒå›æ”¾ |
| **å›¢é˜ŸæŠ€æœ¯æ ˆ** | çœ‹æƒ…å†µ | è€ƒè™‘å­¦ä¹ æˆæœ¬å’Œç»´æŠ¤èƒ½åŠ› |

### 9.3 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸ”§ å¯é æ€§ä¿éšœ**
```
1. æ¶ˆæ¯æŒä¹…åŒ–ï¼šäº¤æ¢æœºã€é˜Ÿåˆ—ã€æ¶ˆæ¯ä¸‰å±‚æŒä¹…åŒ–
2. ç”Ÿäº§è€…ç¡®è®¤ï¼šç¡®ä¿æ¶ˆæ¯æˆåŠŸæŠ•é€’
3. æ¶ˆè´¹è€…ç¡®è®¤ï¼šæ‰‹åŠ¨ç¡®è®¤ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
4. æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¼‚å¸¸æ¶ˆæ¯ï¼Œé¿å…é˜»å¡
5. ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
1. æ‰¹é‡å¤„ç†ï¼šæé«˜æ¶ˆæ¯å¤„ç†æ•ˆç‡
2. å¼‚æ­¥ç¡®è®¤ï¼šå‡å°‘é˜»å¡æ—¶é—´
3. åˆ†åŒºç­–ç•¥ï¼šåˆç†åˆ†å¸ƒæ¶ˆæ¯è´Ÿè½½
4. æ¶ˆè´¹è€…è°ƒä¼˜ï¼šåˆç†è®¾ç½®å¹¶å‘æ•°å’Œæ‰¹æ¬¡å¤§å°
5. ç½‘ç»œä¼˜åŒ–ï¼šå‡å°‘åºåˆ—åŒ–å¼€é”€
```

**ğŸ›¡ï¸ å®‰å…¨è€ƒè™‘**
```
1. è®¿é—®æ§åˆ¶ï¼šé…ç½®ç”¨æˆ·æƒé™å’Œè™šæ‹Ÿä¸»æœº
2. æ¶ˆæ¯åŠ å¯†ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“
3. ç½‘ç»œå®‰å…¨ï¼šä½¿ç”¨SSL/TLSåŠ å¯†è¿æ¥
4. å®¡è®¡æ—¥å¿—ï¼šè®°å½•é‡è¦æ“ä½œ
```

### 9.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**ğŸ” é—®é¢˜è¯Šæ–­æŒ‡å—**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| **æ¶ˆæ¯ä¸¢å¤±** | æ²¡æœ‰æŒä¹…åŒ–/ç¡®è®¤æœºåˆ¶ | å¼€å¯æŒä¹…åŒ–å’Œç¡®è®¤ |
| **é‡å¤æ¶ˆè´¹** | ç½‘ç»œé‡ä¼ /é‡å¹³è¡¡ | å®ç°å¹‚ç­‰æ€§å¤„ç† |
| **æ¶ˆæ¯ç§¯å‹** | æ¶ˆè´¹è€…å¤„ç†æ…¢ | å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ |
| **å†…å­˜å ç”¨é«˜** | æ¶ˆæ¯å †ç§¯åœ¨é˜Ÿåˆ— | ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘ |
| **è¿æ¥è¶…æ—¶** | ç½‘ç»œé—®é¢˜/é…ç½®ä¸å½“ | è°ƒæ•´è¶…æ—¶å‚æ•° |

**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**

```
åˆå­¦é˜¶æ®µï¼š
1. ç†è§£æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ
2. åŠ¨æ‰‹å®è·µç®€å•çš„å‘é€æ¥æ”¶
3. å­¦ä¹ Spring Booté›†æˆ

è¿›é˜¶é˜¶æ®µï¼š  
4. æŒæ¡ä¸åŒæ¶ˆæ¯æ¨¡å¼
5. ç†è§£å¯é æ€§æœºåˆ¶
6. å®ç°å¹‚ç­‰æ€§å¤„ç†

é«˜çº§é˜¶æ®µï¼š
7. æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§
8. åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
9. å¤§è§„æ¨¡éƒ¨ç½²å®è·µ
```

### 9.5 å®é™…å¼€å‘å»ºè®®


**ğŸ’¡ å¼€å‘è§„èŒƒ**
```
1. æ¶ˆæ¯æ ¼å¼ï¼šä½¿ç”¨JSONï¼Œä¿æŒå‘åå…¼å®¹
2. å‘½åè§„èŒƒï¼šé˜Ÿåˆ—å’Œäº¤æ¢æœºå‘½åæ¸…æ™°
3. é”™è¯¯å¤„ç†ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
4. æ—¥å¿—è®°å½•ï¼šå…³é”®æ“ä½œè¦æœ‰æ—¥å¿—
5. æµ‹è¯•è¦†ç›–ï¼šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
```

**ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™**
```
1. è§£è€¦ä¼˜å…ˆï¼šå‡å°‘æœåŠ¡é—´ç›´æ¥ä¾èµ–
2. å¹‚ç­‰è®¾è®¡ï¼šæ‰€æœ‰æ“ä½œéƒ½è¦å¹‚ç­‰
3. ç›‘æ§å®Œå–„ï¼šå…³é”®æŒ‡æ ‡å…¨é¢ç›‘æ§
4. æ¸è¿›å¼ï¼šä»ç®€å•å¼€å§‹ï¼Œé€æ­¥å®Œå–„
5. æ–‡æ¡£é½å…¨ï¼šAPIå’Œé…ç½®è¦æœ‰æ–‡æ¡£
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¼‚æ­¥é€šä¿¡æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè§£è€¦æé€Ÿæ˜¯ç‹é“
- æŒä¹…ç¡®è®¤é˜²ä¸¢å¤±ï¼Œå¹‚ç­‰è®¾è®¡é¿é‡å¤  
- Kafkaé«˜ååé‡å¼ºï¼ŒRabbitMQè·¯ç”±çµæ´»
- æ­»ä¿¡é˜Ÿåˆ—å…œåº•çº¿ï¼Œç›‘æ§å‘Šè­¦ä¿ç¨³å®š