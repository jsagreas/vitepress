---
title: 6ã€è¿½è¸ªæŠ€æœ¯å®ç°
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª](#1-ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª)
2. [Spring Cloud SleuthåŸºç¡€](#2-spring-cloud-sleuthåŸºç¡€)
3. [Zipkinè¿½è¸ªç³»ç»Ÿ](#3-zipkinè¿½è¸ªç³»ç»Ÿ)
4. [Jaegeråˆ†å¸ƒå¼è¿½è¸ª](#4-jaegeråˆ†å¸ƒå¼è¿½è¸ª)
5. [SkyWalking APMç›‘æ§](#5-skywalking-apmç›‘æ§)
6. [OpenTracingæ ‡å‡†è§„èŒƒ](#6-opentracingæ ‡å‡†è§„èŒƒ)
7. [ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶](#7-ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶)
8. [å¼‚æ­¥åœºæ™¯è¿½è¸ª](#8-å¼‚æ­¥åœºæ™¯è¿½è¸ª)
9. [æ€§èƒ½å½±å“ä¸ä¼˜åŒ–](#9-æ€§èƒ½å½±å“ä¸ä¼˜åŒ–)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ª


### 1.1 é“¾è·¯è¿½è¸ªçš„æœ¬è´¨


**é€šä¿—ç†è§£**ï¼šé“¾è·¯è¿½è¸ªå°±åƒç»™æ¯ä¸ªè¯·æ±‚é…ä¸€ä¸ª"è·Ÿè¸ªå™¨"ï¼Œè®°å½•å®ƒåœ¨å„ä¸ªæœåŠ¡é—´çš„å®Œæ•´æ—…ç¨‹ã€‚

```
æƒ³è±¡ä¸€ä¸‹å¿«é€’åŒ…è£¹ï¼š
ç”¨æˆ·ä¸‹å• â†’ ä»“åº“å‘è´§ â†’ è¿è¾“ä¸­è½¬ â†’ æ´¾é€ç­¾æ”¶
   â†“         â†“         â†“         â†“
 æœåŠ¡A â†’ è°ƒç”¨æœåŠ¡B â†’ è°ƒç”¨æœåŠ¡C â†’ è¿”å›ç»“æœ

é“¾è·¯è¿½è¸ªå°±æ˜¯è®°å½•è¿™ä¸ªå®Œæ•´è¿‡ç¨‹çš„"ç‰©æµå•å·"
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é“¾è·¯è¿½è¸ª


**ç°å®é—®é¢˜**ï¼šå¾®æœåŠ¡ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·æ“ä½œå¯èƒ½æ¶‰åŠåå‡ ä¸ªæœåŠ¡

```
ç”µå•†ä¸‹å•æµç¨‹ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚â”€â”€â”€â†’â”‚ è®¢å•æœåŠ¡ â”‚â”€â”€â”€â†’â”‚ åº“å­˜æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚             â”‚
      â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§¯åˆ†æœåŠ¡ â”‚    â”‚ æ”¯ä»˜æœåŠ¡ â”‚    â”‚ ç‰©æµæœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šå“ªä¸ªç¯èŠ‚å‡ºé”™äº†ï¼Ÿå“ªé‡Œæ€§èƒ½æ…¢ï¼Ÿ
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- **æ•…éšœå®šä½**ï¼šå¿«é€Ÿæ‰¾åˆ°å‡ºé—®é¢˜çš„æœåŠ¡
- **æ€§èƒ½åˆ†æ**ï¼šè¯†åˆ«æ…¢æŸ¥è¯¢å’Œç“¶é¢ˆç‚¹
- **ä¾èµ–æ¢³ç†**ï¼šäº†è§£æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºçœŸå®è°ƒç”¨æ•°æ®åšå†³ç­–

### 1.3 é“¾è·¯è¿½è¸ªæ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ Traceï¼ˆè°ƒç”¨é“¾ï¼‰**
```
å®šä¹‰ï¼šä¸€æ¬¡å®Œæ•´çš„ç”¨æˆ·è¯·æ±‚ä»å¼€å§‹åˆ°ç»“æŸçš„æ•´ä¸ªè¿‡ç¨‹
ç‰¹ç‚¹ï¼šæœ‰å”¯ä¸€æ ‡è¯†ï¼ˆTraceIdï¼‰

ç¤ºä¾‹ï¼šç”¨æˆ·ç™»å½•è¿™ä¸€æ¬¡æ“ä½œ = ä¸€ä¸ªå®Œæ•´çš„Trace
```

**ğŸ”¸ Spanï¼ˆè°ƒç”¨æ®µï¼‰**
```
å®šä¹‰ï¼šTraceä¸­çš„ä¸€ä¸ªæ“ä½œå•å…ƒï¼Œæ¯”å¦‚ä¸€æ¬¡æœåŠ¡è°ƒç”¨
ç‰¹ç‚¹ï¼šæœ‰å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æ“ä½œåç§°

ç¤ºä¾‹ï¼šè°ƒç”¨ç”¨æˆ·æœåŠ¡éªŒè¯å¯†ç  = ä¸€ä¸ªSpan
```

**ğŸ”¸ SpanContextï¼ˆä¸Šä¸‹æ–‡ï¼‰**
```
å®šä¹‰ï¼šåœ¨æœåŠ¡é—´ä¼ é€’çš„è¿½è¸ªä¿¡æ¯
å†…å®¹ï¼šTraceIdã€SpanIdã€é‡‡æ ·æ ‡å¿—ç­‰

ä½œç”¨ï¼šè®©ä¸åŒæœåŠ¡çŸ¥é“"è¿™äº›æ“ä½œå±äºåŒä¸€ä¸ªè¯·æ±‚"
```

---

## 2. ğŸŒ¿ Spring Cloud SleuthåŸºç¡€


### 2.1 Sleuthæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šSleuthæ˜¯Spring Cloudæä¾›çš„é“¾è·¯è¿½è¸ªå·¥å…·ï¼Œå°±åƒç»™ä½ çš„å¾®æœåŠ¡è£…ä¸Šäº†"è¡Œè½¦è®°å½•ä»ª"ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**
```
è‡ªåŠ¨åŒ–ï¼šæ— éœ€æ‰‹åŠ¨ç¼–ç ï¼Œè‡ªåŠ¨è®°å½•è°ƒç”¨é“¾è·¯
è½»é‡çº§ï¼šå¯¹åº”ç”¨æ€§èƒ½å½±å“å¾ˆå°
é›†æˆæ€§ï¼šä¸Springç”Ÿæ€æ— ç¼é›†æˆ
æ ‡å‡†åŒ–ï¼šéµå¾ªOpenTracingè§„èŒƒ
```

### 2.2 å¿«é€Ÿä¸Šæ‰‹é…ç½®


**æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

**åŸºç¡€é…ç½®**ï¼š
```yaml
spring:
  sleuth:
    sampler:
      probability: 1.0  # é‡‡æ ·ç‡100%ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    zipkin:
      base-url: http://localhost:9411  # ZipkinæœåŠ¡åœ°å€
```

**ğŸ”¸ æ—¥å¿—ä¸­çš„è¿½è¸ªä¿¡æ¯**
```
æ™®é€šæ—¥å¿—ï¼š
2024-01-15 10:30:15 INFO  UserService - ç”¨æˆ·ç™»å½•æˆåŠŸ

åŠ å…¥Sleuthåï¼š
2024-01-15 10:30:15 INFO [user-service,a1b2c3d4,e5f6g7h8,true] UserService - ç”¨æˆ·ç™»å½•æˆåŠŸ
                            â†‘        â†‘       â†‘       â†‘
                        æœåŠ¡å   TraceId SpanId  æ˜¯å¦è¾“å‡ºåˆ°Zipkin
```

### 2.3 è‡ªå®šä¹‰Spanæ“ä½œ


**æ‰‹åŠ¨åˆ›å»ºSpan**ï¼š
```java
@Service
public class UserService {
    
    @Autowired
    private Tracer tracer;
    
    public User getUserInfo(Long userId) {
        // åˆ›å»ºè‡ªå®šä¹‰Span
        Span span = tracer.nextSpan()
            .name("get-user-detail")
            .tag("user.id", String.valueOf(userId))
            .start();
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            // ä¸šåŠ¡é€»è¾‘
            User user = userRepository.findById(userId);
            span.tag("user.name", user.getName());
            return user;
        } finally {
            span.end();
        }
    }
}
```

**æ³¨è§£æ–¹å¼**ï¼š
```java
@NewSpan("user-validation")
public boolean validateUser(@SpanTag("userId") Long userId) {
    return userRepository.existsById(userId);
}
```

---

## 3. ğŸ“Š Zipkinè¿½è¸ªç³»ç»Ÿ


### 3.1 Zipkinç®€ä»‹


**é€šä¿—ç†è§£**ï¼šZipkinå°±åƒä¸€ä¸ª"ç›‘æ§ä¸­å¿ƒ"ï¼Œæ”¶é›†æ‰€æœ‰æœåŠ¡çš„è¿½è¸ªæ•°æ®ï¼Œå¹¶ç”¨å¯è§†åŒ–ç•Œé¢å±•ç¤ºè°ƒç”¨é“¾è·¯ã€‚

```
æœåŠ¡è°ƒç”¨é“¾è·¯ï¼š
æœåŠ¡A â”€â”€è°ƒç”¨â”€â”€â†’ æœåŠ¡B â”€â”€è°ƒç”¨â”€â”€â†’ æœåŠ¡C
  â†“              â†“              â†“
å‘é€è¿½è¸ªæ•°æ®  å‘é€è¿½è¸ªæ•°æ®  å‘é€è¿½è¸ªæ•°æ®
  â†“              â†“              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ZipkinæœåŠ¡    â”‚ â†â”€â”€ æ”¶é›†ã€å­˜å‚¨ã€å±•ç¤º
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ZipkinæœåŠ¡æ­å»º


**Dockeræ–¹å¼å¯åŠ¨**ï¼š
```bash
# å¿«é€Ÿå¯åŠ¨Zipkin
docker run -d -p 9411:9411 openzipkin/zipkin
```

**è®¿é—®ç•Œé¢**ï¼šæµè§ˆå™¨æ‰“å¼€ `http://localhost:9411`

### 3.3 ä¸Sleuthé›†æˆ


**æ·»åŠ Zipkinä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>
```

**é…ç½®Zipkinä¸ŠæŠ¥**ï¼š
```yaml
spring:
  sleuth:
    zipkin:
      base-url: http://localhost:9411
      sender:
        type: web  # HTTPæ–¹å¼å‘é€
    sampler:
      probability: 0.1  # ç”Ÿäº§ç¯å¢ƒé‡‡æ ·ç‡10%
```

### 3.4 Zipkinç•Œé¢ä½¿ç”¨


**ğŸ”¸ æŸ¥çœ‹è°ƒç”¨é“¾è·¯**
```
ç•Œé¢åŠŸèƒ½è¯´æ˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœç´¢æ¡ä»¶ï¼šæœåŠ¡åã€æ—¶é—´èŒƒå›´ç­‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è°ƒç”¨é“¾åˆ—è¡¨ï¼šæ˜¾ç¤ºæ‰€æœ‰Trace        â”‚ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯¦æƒ…è§†å›¾ï¼šå…·ä½“çš„Spanä¿¡æ¯         â”‚
â”‚   - æ—¶é—´è½´å±•ç¤º                  â”‚
â”‚   - æœåŠ¡ä¾èµ–å›¾                  â”‚
â”‚   - æ€§èƒ½åˆ†æ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ æ€§èƒ½åˆ†æè¦ç‚¹**
- **æ€»è€—æ—¶**ï¼šæ•´ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´
- **å„æ®µè€—æ—¶**ï¼šæ¯ä¸ªæœåŠ¡è°ƒç”¨çš„æ—¶é—´
- **å¹¶è¡Œè°ƒç”¨**ï¼šå“ªäº›è°ƒç”¨æ˜¯å¹¶è¡Œçš„
- **å¼‚å¸¸æ ‡è®°**ï¼šå“ªä¸ªç¯èŠ‚å‡ºç°äº†é”™è¯¯

---

## 4. ğŸš€ Jaegeråˆ†å¸ƒå¼è¿½è¸ª


### 4.1 Jaegerä¸Zipkinçš„åŒºåˆ«


**ç®€å•å¯¹æ¯”**ï¼š
```
Zipkinï¼š
âœ“ è½»é‡çº§ï¼Œéƒ¨ç½²ç®€å•
âœ“ ç¤¾åŒºæˆç†Ÿï¼Œæ–‡æ¡£ä¸°å¯Œ
âœ— åŠŸèƒ½ç›¸å¯¹åŸºç¡€

Jaegerï¼š
âœ“ åŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ€§èƒ½æ›´å¥½
âœ“ æ”¯æŒæ›´å¤šå­˜å‚¨åç«¯
âœ“ æ›´å¥½çš„æŸ¥è¯¢å’Œåˆ†æèƒ½åŠ›
âœ— éƒ¨ç½²ç¨å¤æ‚
```

### 4.2 Jaegerç¯å¢ƒæ­å»º


**Docker Composeéƒ¨ç½²**ï¼š
```yaml
version: '3'
services:
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"    # Jaeger UI
      - "14268:14268"    # HTTPæ”¶é›†ç«¯å£
    environment:
      - COLLECTOR_ZIPKIN_HTTP_PORT=9411
```

### 4.3 Spring Booté›†æˆJaeger


**æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>io.jaegertracing</groupId>
    <artifactId>jaeger-client</artifactId>
    <version>1.8.1</version>
</dependency>
```

**é…ç½®ç±»**ï¼š
```java
@Configuration
public class JaegerConfig {
    
    @Bean
    public JaegerTracer jaegerTracer() {
        return new io.jaegertracing.Configuration("order-service")
            .withSampler(io.jaegertracing.Configuration.SamplerConfiguration
                .fromEnv().withType("const").withParam(1))
            .withReporter(io.jaegertracing.Configuration.ReporterConfiguration
                .fromEnv().withLogSpans(true)
                .withSender(io.jaegertracing.Configuration.SenderConfiguration
                    .fromEnv().withEndpoint("http://localhost:14268/api/traces")))
            .getTracer();
    }
}
```

### 4.4 Jaegeré«˜çº§ç‰¹æ€§


**ğŸ”¸ é‡‡æ ·ç­–ç•¥**
```
const: å›ºå®šé‡‡æ ·ç‡
probabilistic: æ¦‚ç‡é‡‡æ ·
ratelimiting: é™æµé‡‡æ ·
adaptive: è‡ªé€‚åº”é‡‡æ ·ï¼ˆæ ¹æ®æµé‡åŠ¨æ€è°ƒæ•´ï¼‰
```

**ğŸ”¸ æ€§èƒ½ç›‘æ§**
- **æœåŠ¡åœ°å›¾**ï¼šå¯è§†åŒ–æœåŠ¡ä¾èµ–å…³ç³»
- **æ€§èƒ½å¯¹æ¯”**ï¼šä¸åŒæ—¶é—´æ®µçš„æ€§èƒ½å¯¹æ¯”
- **é”™è¯¯åˆ†æ**ï¼šè‡ªåŠ¨æ ‡è®°å’Œåˆ†æé”™è¯¯

---

## 5. ğŸ”§ SkyWalking APMç›‘æ§


### 5.1 SkyWalkingå…¨æ™¯ä»‹ç»


**é€šä¿—ç†è§£**ï¼šSkyWalkingæ˜¯ä¸€ä¸ª"å…¨èƒ½å‹ç›‘æ§ä¸“å®¶"ï¼Œä¸ä»…èƒ½è¿½è¸ªé“¾è·¯ï¼Œè¿˜èƒ½ç›‘æ§å„ç§æ€§èƒ½æŒ‡æ ‡ã€‚

```
SkyWalkingç›‘æ§èŒƒå›´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨æ€§èƒ½ç›‘æ§    â”‚ â† JVMã€CPUã€å†…å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é“¾è·¯è¿½è¸ª       â”‚ â† è°ƒç”¨é“¾ã€è€—æ—¶åˆ†æ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   æœåŠ¡æ‹“æ‰‘       â”‚ â† æœåŠ¡ä¾èµ–å…³ç³»å›¾
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åº“ç›‘æ§     â”‚ â† SQLæ€§èƒ½ã€æ…¢æŸ¥è¯¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ—¥å¿—å…³è”       â”‚ â† é“¾è·¯å’Œæ—¥å¿—å…³è”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 SkyWalkingç¯å¢ƒæ­å»º


**ä¸‹è½½å¹¶å¯åŠ¨**ï¼š
```bash
# ä¸‹è½½SkyWalking
wget https://downloads.apache.org/skywalking/9.4.0/apache-skywalking-apm-9.4.0.tar.gz

# è§£å‹å¹¶å¯åŠ¨
tar -zxf apache-skywalking-apm-9.4.0.tar.gz
cd apache-skywalking-apm-bin
./bin/startup.sh
```

**è®¿é—®ç•Œé¢**ï¼š`http://localhost:8080`

### 5.3 Java Agenté›†æˆ


**æ·»åŠ Agentå‚æ•°**ï¼š
```bash
java -javaagent:/path/to/skywalking-agent.jar 
     -Dskywalking.agent.service_name=user-service 
     -Dskywalking.collector.backend_service=localhost:11800 
     -jar your-application.jar
```

**Spring Booté…ç½®**ï¼š
```yaml
# application.yml
skywalking:
  agent:
    service_name: user-service
    collector:
      backend_service: localhost:11800
    sampling:
      rate: 1000  # é‡‡æ ·ç‡ï¼šæ¯1000ä¸ªè¯·æ±‚é‡‡æ ·1ä¸ª
```

### 5.4 SkyWalkingæ ¸å¿ƒåŠŸèƒ½


**ğŸ”¸ æœåŠ¡æ‹“æ‰‘å›¾**
```
è‡ªåŠ¨ç”ŸæˆæœåŠ¡ä¾èµ–å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯åº”ç”¨  â”‚â”€â”€â”€â†’â”‚ APIç½‘å…³   â”‚â”€â”€â”€â†’â”‚ ç”¨æˆ·æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚             â”‚
                      â–¼             â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ è®¢å•æœåŠ¡  â”‚    â”‚ MySQL    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ˜¾ç¤ºä¿¡æ¯ï¼š
- è°ƒç”¨æ¬¡æ•°ã€æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡ç»Ÿè®¡
```

**ğŸ”¸ æ€§èƒ½åˆ†æé¢æ¿**
- **æ¦‚è§ˆ**ï¼šæ•´ä½“å¥åº·çŠ¶å†µ
- **æœåŠ¡**ï¼šå•ä¸ªæœåŠ¡çš„è¯¦ç»†æŒ‡æ ‡
- **æ•°æ®åº“**ï¼šSQLæ‰§è¡Œæƒ…å†µ
- **å‘Šè­¦**ï¼šå¼‚å¸¸æƒ…å†µæé†’

---

## 6. ğŸ“‹ OpenTracingæ ‡å‡†è§„èŒƒ


### 6.1 OpenTracingæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šOpenTracingå°±åƒæ˜¯"é“¾è·¯è¿½è¸ªçš„æ ‡å‡†åè®®"ï¼Œå®šä¹‰äº†å¤§å®¶éƒ½è¦éµå®ˆçš„è§„åˆ™ã€‚

```
ä¸ºä»€ä¹ˆéœ€è¦æ ‡å‡†ï¼Ÿ

é—®é¢˜ï¼šæ¯ä¸ªè¿½è¸ªç³»ç»Ÿéƒ½æœ‰è‡ªå·±çš„API
Zipkin: zipkin.api.span()
Jaeger: jaeger.span.create()
SkyWalking: sw.span.new()

OpenTracingè§£å†³ï¼š
ç»Ÿä¸€API: tracer.startSpan()
åº”ç”¨ä»£ç ä¸å…·ä½“å®ç°è§£è€¦
```

### 6.2 æ ¸å¿ƒæ¦‚å¿µè¯¦è§£


**ğŸ”¸ Tracerï¼ˆè¿½è¸ªå™¨ï¼‰**
```java
// åˆ›å»ºè¿½è¸ªå™¨
Tracer tracer = GlobalTracer.get();

// å¯åŠ¨æ–°çš„Span
Span span = tracer.buildSpan("operation-name")
    .withTag("component", "user-service")
    .start();
```

**ğŸ”¸ Spanï¼ˆæ“ä½œå•å…ƒï¼‰**
```java
// Spançš„ç”Ÿå‘½å‘¨æœŸ
Span span = tracer.buildSpan("database-query")
    .withTag("db.statement", "SELECT * FROM users")
    .withTag("db.type", "mysql")
    .start();

// è®¾ç½®çˆ¶å­å…³ç³»
Span childSpan = tracer.buildSpan("cache-lookup")
    .asChildOf(span)  // è®¾ç½®çˆ¶Span
    .start();

// è®°å½•äº‹ä»¶
span.log("ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“");

// ç»“æŸSpan
span.finish();
```

### 6.3 å®é™…åº”ç”¨ç¤ºä¾‹


**æ‰‹åŠ¨åŸ‹ç‚¹ç¤ºä¾‹**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired 
    private Tracer tracer;
    
    public Order createOrder(OrderRequest request) {
        Span span = tracer.buildSpan("create-order")
            .withTag("order.user_id", request.getUserId())
            .withTag("order.amount", request.getAmount())
            .start();
            
        try (Scope scope = tracer.activateSpan(span)) {
            // éªŒè¯åº“å­˜
            checkInventory(request.getProductId());
            
            // åˆ›å»ºè®¢å•
            Order order = saveOrder(request);
            
            span.setTag("order.id", order.getId());
            return order;
        } catch (Exception e) {
            span.setTag("error", true);
            span.log(Map.of("error.message", e.getMessage()));
            throw e;
        } finally {
            span.finish();
        }
    }
}
```

---

## 7. ğŸ”„ ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶


### 7.1 ä¸Šä¸‹æ–‡ä¼ é€’çš„é‡è¦æ€§


**é—®é¢˜åœºæ™¯**ï¼š
```
ç”¨æˆ·è¯·æ±‚ï¼šæœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C

é—®é¢˜ï¼šæœåŠ¡Bè°ƒç”¨æœåŠ¡Cæ—¶ï¼Œæ€ä¹ˆçŸ¥é“è¿™æ¬¡è°ƒç”¨å±äºå“ªä¸ªTraceï¼Ÿ
è§£å†³ï¼šé€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’TraceIdå’ŒSpanId
```

### 7.2 HTTPè¯·æ±‚ä¸­çš„ä¼ é€’


**è‡ªåŠ¨ä¼ é€’ï¼ˆSleuthå®ç°ï¼‰**ï¼š
```
HTTPè¯·æ±‚å¤´è‡ªåŠ¨æ·»åŠ ï¼š
X-Trace-Id: a1b2c3d4e5f6g7h8
X-Span-Id: e5f6g7h8i9j0k1l2
X-B3-Sampled: 1
```

**æ‰‹åŠ¨ä¼ é€’ç¤ºä¾‹**ï¼š
```java
@Component
public class TraceContextPropagator {
    
    public void propagateContext(HttpHeaders headers) {
        SpanContext spanContext = tracer.activeSpan().context();
        
        // æ‰‹åŠ¨è®¾ç½®è¯·æ±‚å¤´
        headers.set("X-Trace-Id", spanContext.toTraceId());
        headers.set("X-Span-Id", spanContext.toSpanId());
    }
    
    public void extractContext(HttpServletRequest request) {
        String traceId = request.getHeader("X-Trace-Id");
        String spanId = request.getHeader("X-Span-Id");
        
        // æ¢å¤ä¸Šä¸‹æ–‡
        if (traceId != null && spanId != null) {
            SpanContext context = SpanContext.create(traceId, spanId);
            tracer.withSpanInScope(tracer.buildSpan("http-request")
                .asChildOf(context).start());
        }
    }
}
```

### 7.3 æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¼ é€’


**RabbitMQç¤ºä¾‹**ï¼š
```java
@RabbitListener(queues = "order.queue")
public void handleOrderMessage(
    @Payload OrderMessage message,
    @Header Map<String, Object> headers) {
    
    // ä»æ¶ˆæ¯å¤´ä¸­æå–è¿½è¸ªä¿¡æ¯
    String traceId = (String) headers.get("X-Trace-Id");
    
    if (traceId != null) {
        // æ¢å¤è¿½è¸ªä¸Šä¸‹æ–‡
        SpanBuilder spanBuilder = tracer.buildSpan("process-order-message")
            .withTag("mq.queue", "order.queue");
            
        // ç»§ç»­è¿½è¸ªé“¾è·¯
        try (Scope scope = tracer.activateSpan(spanBuilder.start())) {
            processOrder(message);
        }
    }
}
```

---

## 8. âš¡ å¼‚æ­¥åœºæ™¯è¿½è¸ª


### 8.1 å¼‚æ­¥è°ƒç”¨çš„æŒ‘æˆ˜


**é—®é¢˜è¯´æ˜**ï¼š
```
åŒæ­¥è°ƒç”¨ï¼šçº¿ç¨‹Aæ‰§è¡Œå®Œæ•´æµç¨‹ï¼Œä¸Šä¸‹æ–‡è‡ªç„¶ä¼ é€’
å¼‚æ­¥è°ƒç”¨ï¼šåˆ‡æ¢åˆ°çº¿ç¨‹Bï¼Œä¸Šä¸‹æ–‡å¯èƒ½ä¸¢å¤±

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”å¼‚æ­¥ä»»åŠ¡â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹A   â”‚â”€â”€â”€â”€â”€â”€â†’â”‚ çº¿ç¨‹B   â”‚
â”‚TraceId=1â”‚       â”‚TraceId=?â”‚ â† ä¸Šä¸‹æ–‡ä¸¢å¤±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Springå¼‚æ­¥æ–¹æ³•è¿½è¸ª


**é…ç½®å¼‚æ­¥è¿½è¸ª**ï¼š
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        
        // ä½¿ç”¨TraceableExecutorServiceåŒ…è£…
        return new TraceableExecutorService(
            new BoundedTaskExecutor(executor));
    }
}
```

**å¼‚æ­¥æ–¹æ³•ç¤ºä¾‹**ï¼š
```java
@Service
public class NotificationService {
    
    @Async
    @NewSpan("send-notification")
    public CompletableFuture<Void> sendNotification(
        @SpanTag("userId") Long userId, 
        String message) {
        
        // å¼‚æ­¥å‘é€é€šçŸ¥
        emailService.send(userId, message);
        return CompletableFuture.completedFuture(null);
    }
}
```

### 8.3 æ‰‹åŠ¨ä¸Šä¸‹æ–‡ä¼ é€’


**CompletableFutureç¤ºä¾‹**ï¼š
```java
public class AsyncOrderProcessor {
    
    public void processOrderAsync(Order order) {
        Span currentSpan = tracer.activeSpan();
        SpanContext context = currentSpan.context();
        
        CompletableFuture
            .supplyAsync(() -> {
                // åœ¨æ–°çº¿ç¨‹ä¸­æ¢å¤ä¸Šä¸‹æ–‡
                try (Scope scope = tracer.activateSpan(
                    tracer.buildSpan("async-validation")
                        .asChildOf(context).start())) {
                    
                    return validateOrder(order);
                }
            })
            .thenApplyAsync(validationResult -> {
                // ç»§ç»­ä¼ é€’ä¸Šä¸‹æ–‡
                try (Scope scope = tracer.activateSpan(
                    tracer.buildSpan("async-processing")
                        .asChildOf(context).start())) {
                    
                    return processValidatedOrder(order, validationResult);
                }
            });
    }
}
```

---

## 9. ğŸ“ˆ æ€§èƒ½å½±å“ä¸ä¼˜åŒ–


### 9.1 æ€§èƒ½å½±å“åˆ†æ


**å¼€é”€æ¥æº**ï¼š
```
CPUå¼€é”€ï¼š
â”œâ”€â”€ Spanåˆ›å»ºå’Œç®¡ç†        ~5%
â”œâ”€â”€ ä¸Šä¸‹æ–‡ä¼ é€’           ~2%
â”œâ”€â”€ æ ‡ç­¾å’Œæ—¥å¿—è®°å½•        ~3%
â””â”€â”€ æ•°æ®åºåˆ—åŒ–å’Œå‘é€      ~10%

å†…å­˜å¼€é”€ï¼š
â”œâ”€â”€ Spanå¯¹è±¡å­˜å‚¨         ~æ¯ä¸ªSpan 1KB
â”œâ”€â”€ ä¸Šä¸‹æ–‡ä¼ é€’ç¼“å­˜        ~æ¯ä¸ªçº¿ç¨‹ 500B
â””â”€â”€ å‘é€ç¼“å†²åŒº          ~é…ç½®ç›¸å…³

ç½‘ç»œå¼€é”€ï¼š
â””â”€â”€ å‘è¿½è¸ªç³»ç»Ÿå‘é€æ•°æ®    ~æ¯ä¸ªSpan 2KB
```

### 9.2 é‡‡æ ·ç­–ç•¥ä¼˜åŒ–


**ç”Ÿäº§ç¯å¢ƒé‡‡æ ·é…ç½®**ï¼š
```yaml
spring:
  sleuth:
    sampler:
      probability: 0.01  # 1%é‡‡æ ·ç‡ï¼Œå¹³è¡¡æ€§èƒ½å’Œç›‘æ§éœ€æ±‚
    
    # é’ˆå¯¹ç‰¹å®šè¯·æ±‚å¢åŠ é‡‡æ ·
    web:
      skip-pattern: "/health|/metrics"  # è·³è¿‡å¥åº·æ£€æŸ¥
    
    # å¼‚æ­¥ä»»åŠ¡é‡‡æ ·
    async:
      enabled: true
      configurer:
        core-pool-size: 1
        max-pool-size: 5
```

**åŠ¨æ€é‡‡æ ·ç­–ç•¥**ï¼š
```java
@Component
public class DynamicSampler implements Sampler {
    
    @Override
    public Decision sample(TraceContext traceContext) {
        // æ ¹æ®ä¸šåŠ¡è§„åˆ™åŠ¨æ€å†³å®šæ˜¯å¦é‡‡æ ·
        if (isImportantRequest()) {
            return Decision.SAMPLE;  // é‡è¦è¯·æ±‚å¿…é¡»é‡‡æ ·
        }
        
        if (isHighTrafficPeriod()) {
            return Decision.NOT_SAMPLE;  // é«˜å³°æœŸé™ä½é‡‡æ ·
        }
        
        return Decision.SAMPLE;
    }
    
    private boolean isImportantRequest() {
        // åˆ¤æ–­æ˜¯å¦ä¸ºé‡è¦è¯·æ±‚ï¼ˆæ”¯ä»˜ã€ç™»å½•ç­‰ï¼‰
        return getCurrentSpanName().contains("payment") ||
               getCurrentSpanName().contains("login");
    }
}
```

### 9.3 æ‰¹é‡å‘é€ä¼˜åŒ–


**æ‰¹é‡å‘é€é…ç½®**ï¼š
```yaml
spring:
  zipkin:
    sender:
      type: rabbit  # ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å‘é€
    
    # HTTPå‘é€ä¼˜åŒ–
    base-url: http://zipkin-server:9411
    compression:
      enabled: true  # å¯ç”¨å‹ç¼©
    
    # æ‰¹é‡é…ç½®
    service:
      span-buffer-size: 1000     # ç¼“å†²åŒºå¤§å°
      span-flush-interval: 5000  # 5ç§’åˆ·æ–°ä¸€æ¬¡
```

### 9.4 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸ”¸ æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
```
å…³é”®æŒ‡æ ‡ï¼š
- è¿½è¸ªå¼€é”€å æ€»CPUçš„æ¯”ä¾‹ < 5%
- å¹³å‡å“åº”æ—¶é—´å¢åŠ  < 5ms
- å†…å­˜ä½¿ç”¨å¢åŠ  < 50MB
- é‡‡æ ·æ•°æ®çš„å®Œæ•´æ€§ > 95%
```

**ğŸ”¸ å‘Šè­¦é…ç½®**
```yaml
# ç›‘æ§é…ç½®ç¤ºä¾‹
monitoring:
  tracing:
    alerts:
      - name: "è¿½è¸ªç³»ç»Ÿå»¶è¿Ÿè¿‡é«˜"
        condition: "avg_latency > 100ms"
        action: "é™ä½é‡‡æ ·ç‡"
      
      - name: "è¿½è¸ªæ•°æ®ä¸¢å¤±"
        condition: "success_rate < 95%"
        action: "æ£€æŸ¥ç½‘ç»œå’Œå­˜å‚¨"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é“¾è·¯è¿½è¸ªæœ¬è´¨ï¼šç»™æ¯ä¸ªè¯·æ±‚åˆ†é…å”¯ä¸€æ ‡è¯†ï¼Œè¿½è¸ªå®Œæ•´è°ƒç”¨è·¯å¾„
ğŸ”¸ Traceå’ŒSpanï¼šTraceæ˜¯å®Œæ•´è¯·æ±‚ï¼ŒSpanæ˜¯å•ä¸ªæ“ä½œ
ğŸ”¸ ä¸Šä¸‹æ–‡ä¼ é€’ï¼šç¡®ä¿ä¸åŒæœåŠ¡çŸ¥é“å±äºåŒä¸€ä¸ªè¯·æ±‚
ğŸ”¸ é‡‡æ ·ç­–ç•¥ï¼šå¹³è¡¡ç›‘æ§éœ€æ±‚å’Œæ€§èƒ½å¼€é”€
ğŸ”¸ å¼‚æ­¥è¿½è¸ªï¼šå¤„ç†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„ä¸Šä¸‹æ–‡ä¼ é€’
```

### 10.2 æŠ€æœ¯é€‰å‹æŒ‡å¯¼


| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **ç†ç”±** |
|------|------------|---------|
| **å°å‹é¡¹ç›®** | `Spring Cloud Sleuth + Zipkin` | `è½»é‡ç®€å•ï¼Œå¿«é€Ÿä¸Šæ‰‹` |
| **ä¸­å¤§å‹é¡¹ç›®** | `Sleuth + Jaeger` | `åŠŸèƒ½å¼ºå¤§ï¼Œæ€§èƒ½æ›´å¥½` |
| **ä¼ä¸šçº§ç›‘æ§** | `SkyWalking` | `å…¨æ–¹ä½ç›‘æ§ï¼ŒåŠŸèƒ½æœ€å…¨` |
| **å¤šè¯­è¨€ç¯å¢ƒ** | `OpenTracingæ ‡å‡†` | `è·¨è¯­è¨€å…¼å®¹æ€§å¥½` |

### 10.3 å®æ–½å»ºè®®


**ğŸ”¹ åˆ†é˜¶æ®µå®æ–½**
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é“¾è·¯è¿½è¸ª
- é›†æˆSleuthï¼Œå®ç°åŸºæœ¬è¿½è¸ª
- éƒ¨ç½²Zipkinï¼Œå¯è§†åŒ–è°ƒç”¨é“¾è·¯
- é…ç½®åˆç†çš„é‡‡æ ·ç‡

ç¬¬äºŒé˜¶æ®µï¼šæ·±åº¦ç›‘æ§
- æ·»åŠ è‡ªå®šä¹‰Spanå’Œæ ‡ç­¾
- é›†æˆæ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ
- å»ºç«‹å‘Šè­¦æœºåˆ¶

ç¬¬ä¸‰é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–
- ä¼˜åŒ–é‡‡æ ·ç­–ç•¥
- è°ƒæ•´å‘é€å‚æ•°
- ç›‘æ§æ€§èƒ½å½±å“
```

**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**
```
ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼š
- æ£€æŸ¥å¼‚æ­¥æ–¹æ³•é…ç½®
- ç¡®è®¤HTTPå¤´ä¼ é€’æ­£ç¡®
- éªŒè¯æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ

æ€§èƒ½é—®é¢˜ï¼š
- é™ä½é‡‡æ ·ç‡
- å¯ç”¨æ‰¹é‡å‘é€
- ä½¿ç”¨å¼‚æ­¥å‘é€æ–¹å¼

æ•°æ®æŸ¥è¯¢æ…¢ï¼š
- ä¼˜åŒ–å­˜å‚¨é…ç½®
- å»ºç«‹åˆé€‚çš„ç´¢å¼•
- æ¸…ç†å†å²æ•°æ®
```

### 10.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


```
ğŸ“š åŸºç¡€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰ï¼š
- ç†è§£é“¾è·¯è¿½è¸ªæ¦‚å¿µ
- æŒæ¡SleuthåŸºæœ¬ä½¿ç”¨
- ä¼šçœ‹Zipkinç•Œé¢

ğŸ“ˆ è¿›é˜¶é˜¶æ®µï¼ˆ2-3å‘¨ï¼‰ï¼š
- è‡ªå®šä¹‰Spanå’Œæ ‡ç­¾
- å¤„ç†å¼‚æ­¥åœºæ™¯
- é›†æˆä¸åŒè¿½è¸ªç³»ç»Ÿ

ğŸš€ é«˜çº§é˜¶æ®µï¼ˆ1ä¸ªæœˆä»¥ä¸Šï¼‰ï¼š
- æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§
- å¤§è§„æ¨¡éƒ¨ç½²å®è·µ
- ä¸DevOpsæµç¨‹é›†æˆ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é“¾è·¯è¿½è¸ªåƒç‰©æµï¼Œå…¨ç¨‹è·Ÿè¸ªä¸è¿·è·¯
- Traceæ˜¯æ—…ç¨‹ï¼ŒSpanæ˜¯æ¯ä¸€æ­¥
- ä¸Šä¸‹æ–‡ä¼ é€’å¾ˆå…³é”®ï¼Œå¼‚æ­¥åœºæ™¯è¦å°å¿ƒ
- é‡‡æ ·å¹³è¡¡æ€§èƒ½ç›‘æ§ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è°¨æ…