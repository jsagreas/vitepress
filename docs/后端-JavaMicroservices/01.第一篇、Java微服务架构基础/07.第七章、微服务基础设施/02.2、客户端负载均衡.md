---
title: 2ã€å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡](#1-ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡)
2. [Ribbonè´Ÿè½½å‡è¡¡è¯¦è§£](#2-Ribbonè´Ÿè½½å‡è¡¡è¯¦è§£)
3. [è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥è§£æ](#3-è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥è§£æ)
4. [æœåŠ¡å®ä¾‹é€‰æ‹©ç­–ç•¥](#4-æœåŠ¡å®ä¾‹é€‰æ‹©ç­–ç•¥)
5. [æ•…éšœæ£€æµ‹ä¸é‡è¯•æœºåˆ¶](#5-æ•…éšœæ£€æµ‹ä¸é‡è¯•æœºåˆ¶)
6. [æ–­è·¯å™¨é›†æˆåº”ç”¨](#6-æ–­è·¯å™¨é›†æˆåº”ç”¨)
7. [æœåŠ¡æƒé‡ä¸åŒºåŸŸæ„ŸçŸ¥](#7-æœåŠ¡æƒé‡ä¸åŒºåŸŸæ„ŸçŸ¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡


### 1.1 è´Ÿè½½å‡è¡¡çš„åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ å¼€äº†ä¸€å®¶å¾ˆç«çš„å¥¶èŒ¶åº—ï¼Œç”Ÿæ„å¥½åˆ°é¡¾å®¢æ’å¤§é˜Ÿã€‚è¿™æ—¶å€™ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š
- åªå¼€ä¸€ä¸ªçª—å£ï¼Œé¡¾å®¢æ’é•¿é˜Ÿç­‰å¾… âŒ
- å¼€å¤šä¸ªçª—å£ï¼ŒæŠŠé¡¾å®¢åˆ†é…åˆ°ä¸åŒçª—å£ âœ…

**è´Ÿè½½å‡è¡¡å°±åƒå¥¶èŒ¶åº—çš„åˆ†æµç­–ç•¥**ï¼ŒæŠŠå¤§é‡çš„è¯·æ±‚åˆç†åˆ†é…ç»™å¤šä¸ªæœåŠ¡å™¨ï¼Œé¿å…æŸå°æœåŠ¡å™¨ç´¯æ­»ï¼Œå…¶ä»–æœåŠ¡å™¨é—²ç€ã€‚

```
å•ä½“åº”ç”¨æ—¶ä»£ï¼š
å®¢æˆ·ç«¯ ---------> ä¸€å°æœåŠ¡å™¨ (å‹åŠ›å±±å¤§ï¼)

å¾®æœåŠ¡æ—¶ä»£ï¼š
å®¢æˆ·ç«¯ ---------> è´Ÿè½½å‡è¡¡å™¨ ---------> å¤šå°æœåŠ¡å™¨
                     |
                 æ™ºèƒ½åˆ†é…è¯·æ±‚
```

### 1.2 å®¢æˆ·ç«¯ vs æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡


**ğŸ”¸ æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰**
```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Nginx/ç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨ â†’ åç«¯æœåŠ¡å™¨ç¾¤

ç‰¹ç‚¹ï¼š
âœ… å®¢æˆ·ç«¯ç®€å•ï¼Œä¸éœ€è¦çŸ¥é“åç«¯æœ‰å¤šå°‘æœåŠ¡å™¨
âŒ è´Ÿè½½å‡è¡¡å™¨æˆä¸ºå•ç‚¹æ•…éšœ
âŒ æ‰€æœ‰è¯·æ±‚éƒ½è¦ç»è¿‡è´Ÿè½½å‡è¡¡å™¨ï¼Œå¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
```

**ğŸ”¸ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆå¾®æœåŠ¡æ¨èï¼‰**
```
å®¢æˆ·ç«¯å†…ç½®è´Ÿè½½å‡è¡¡é€»è¾‘ â†’ ç›´æ¥è°ƒç”¨åç«¯æœåŠ¡å™¨

ç‰¹ç‚¹ï¼š
âœ… æ²¡æœ‰å•ç‚¹æ•…éšœ
âœ… å‡å°‘ç½‘ç»œè·³è½¬ï¼Œæ€§èƒ½æ›´å¥½
âœ… å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µé€‰æ‹©ç®—æ³•
âŒ å®¢æˆ·ç«¯é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›
```

### 1.3 å¾®æœåŠ¡ä¸­ä¸ºä»€ä¹ˆé€‰æ‹©å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡


**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

```
ç”µå•†ç³»ç»Ÿç¤ºä¾‹ï¼š

æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡ï¼š
ç”¨æˆ·ä¸‹å• â†’ APIç½‘å…³ â†’ è®¢å•æœåŠ¡è´Ÿè½½å‡è¡¡å™¨ â†’ è®¢å•æœåŠ¡å®ä¾‹
                 â†“
              åº“å­˜æœåŠ¡è´Ÿè½½å‡è¡¡å™¨ â†’ åº“å­˜æœåŠ¡å®ä¾‹
                 â†“  
              æ”¯ä»˜æœåŠ¡è´Ÿè½½å‡è¡¡å™¨ â†’ æ”¯ä»˜æœåŠ¡å®ä¾‹

å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼š
ç”¨æˆ·ä¸‹å• â†’ APIç½‘å…³ï¼ˆå†…ç½®Ribbonï¼‰ â†’ ç›´æ¥é€‰æ‹©è®¢å•æœåŠ¡å®ä¾‹
                 â†“
              ç›´æ¥é€‰æ‹©åº“å­˜æœåŠ¡å®ä¾‹
                 â†“
              ç›´æ¥é€‰æ‹©æ”¯ä»˜æœåŠ¡å®ä¾‹
```

**ä¸ºä»€ä¹ˆå¾®æœåŠ¡æ›´é€‚åˆå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Ÿ**

1. **æœåŠ¡æ•°é‡å¤š**ï¼šå¾®æœåŠ¡æ¶æ„ä¸‹å¯èƒ½æœ‰å‡ åä¸Šç™¾ä¸ªæœåŠ¡ï¼Œæ¯ä¸ªéƒ½é…è´Ÿè½½å‡è¡¡å™¨å¤ªæµªè´¹
2. **è°ƒç”¨é“¾è·¯é•¿**ï¼šå‡å°‘ä¸­é—´ç¯èŠ‚ï¼Œæé«˜æ€§èƒ½
3. **åŠ¨æ€æ‰©ç¼©å®¹**ï¼šæœåŠ¡å®ä¾‹éšæ—¶å¢å‡ï¼Œå®¢æˆ·ç«¯èƒ½å¿«é€Ÿæ„ŸçŸ¥
4. **å®šåˆ¶åŒ–éœ€æ±‚**ï¼šä¸åŒæœåŠ¡å¯èƒ½éœ€è¦ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥

---

## 2. âš–ï¸ Ribbonè´Ÿè½½å‡è¡¡è¯¦è§£


### 2.1 Ribbonæ˜¯ä»€ä¹ˆ


**Ribbonç®€ä»‹**

Ribbonæ˜¯Netflixå¼€æºçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å·¥å…·ï¼Œå°±åƒç»™ä½ çš„Javaåº”ç”¨è£…äº†ä¸€ä¸ª"æ™ºèƒ½é€‰æ‹©å™¨"ã€‚

> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šRibbonå°±åƒä½ æ‰‹æœºé‡Œçš„å¯¼èˆªAPPï¼Œå½“ä½ è¦å»æŸä¸ªåœ°æ–¹æ—¶ï¼Œå®ƒä¼šæ ¹æ®å®æ—¶è·¯å†µé€‰æ‹©æœ€ä½³è·¯çº¿ã€‚åŒæ ·ï¼ŒRibbonä¼šæ ¹æ®æœåŠ¡å™¨çŠ¶æ€é€‰æ‹©æœ€ä½³çš„æœåŠ¡å®ä¾‹ã€‚

```
æ²¡æœ‰Ribbonçš„è°ƒç”¨ï¼š
orderService.call("http://192.168.1.100:8080/api/product")  // ç¡¬ç¼–ç IP

æœ‰äº†Ribbonçš„è°ƒç”¨ï¼š
orderService.call("http://PRODUCT-SERVICE/api/product")     // æœåŠ¡åè°ƒç”¨
                        â†‘
                    Ribbonè‡ªåŠ¨é€‰æ‹©æœ€ä½³å®ä¾‹
```

### 2.2 Ribbonçš„æ ¸å¿ƒç»„ä»¶


**ğŸ”§ æ ¸å¿ƒç»„ä»¶æ¶æ„å›¾**
```
Ribbonè´Ÿè½½å‡è¡¡å™¨
â”œâ”€â”€ ILoadBalancer (è´Ÿè½½å‡è¡¡å™¨æ¥å£)
â”‚   â”œâ”€â”€ ç®¡ç†æœåŠ¡å®ä¾‹åˆ—è¡¨
â”‚   â””â”€â”€ é€‰æ‹©æœåŠ¡å®ä¾‹
â”œâ”€â”€ IRule (è´Ÿè½½å‡è¡¡è§„åˆ™)
â”‚   â”œâ”€â”€ RoundRobinRule (è½®è¯¢)
â”‚   â”œâ”€â”€ RandomRule (éšæœº)
â”‚   â””â”€â”€ WeightedResponseTimeRule (æƒé‡)
â”œâ”€â”€ IPing (å¥åº·æ£€æŸ¥)
â”‚   â”œâ”€â”€ æ£€æµ‹æœåŠ¡å®ä¾‹æ˜¯å¦å¯ç”¨
â”‚   â””â”€â”€ å®šæœŸå¿ƒè·³æ£€æµ‹
â””â”€â”€ ServerList (æœåŠ¡åˆ—è¡¨)
    â”œâ”€â”€ è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
    â””â”€â”€ åŠ¨æ€æ›´æ–°åˆ—è¡¨
```

### 2.3 Ribbonåœ¨Spring Cloudä¸­çš„ä½¿ç”¨


**åŸºç¡€é…ç½®ç¤ºä¾‹**

```java
// 1. æ·»åŠ ä¾èµ–ï¼ˆSpring Cloudè‡ªåŠ¨åŒ…å«ï¼‰
@SpringBootApplication
@EnableEurekaClient
public class OrderServiceApplication {
    
    // 2. é…ç½®RestTemplateæ”¯æŒè´Ÿè½½å‡è¡¡
    @Bean
    @LoadBalanced  // è¿™ä¸ªæ³¨è§£æ˜¯å…³é”®ï¼
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}

// 3. ä½¿ç”¨æœåŠ¡åè°ƒç”¨
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public Product getProduct(Long productId) {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åï¼ŒRibbonè‡ªåŠ¨è´Ÿè½½å‡è¡¡
        String url = "http://PRODUCT-SERVICE/api/products/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
}
```

**é…ç½®æ–‡ä»¶è®¾ç½®**

```yaml
# application.yml
PRODUCT-SERVICE:  # æœåŠ¡å
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule
    ConnectTimeout: 3000        # è¿æ¥è¶…æ—¶æ—¶é—´
    ReadTimeout: 60000         # è¯»å–è¶…æ—¶æ—¶é—´
    MaxAutoRetries: 1          # åŒä¸€æœåŠ¡å™¨é‡è¯•æ¬¡æ•°
    MaxAutoRetriesNextServer: 2 # åˆ‡æ¢æœåŠ¡å™¨é‡è¯•æ¬¡æ•°
```

### 2.4 Ribbonå·¥ä½œæµç¨‹


**ğŸ“Š Ribbonè°ƒç”¨æµç¨‹å›¾**
```
å®¢æˆ·ç«¯å‘èµ·è°ƒç”¨
    â†“
è§£ææœåŠ¡å (PRODUCT-SERVICE)
    â†“
ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
    â†“
[192.168.1.10:8080, 192.168.1.11:8080, 192.168.1.12:8080]
    â†“
åº”ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©å®ä¾‹
    â†“
é€‰ä¸­å®ä¾‹ï¼š192.168.1.11:8080
    â†“
å‘èµ·HTTPè°ƒç”¨
    â†“
è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
```

---

## 3. ğŸ§® è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥è§£æ


### 3.1 è½®è¯¢ç®—æ³• (RoundRobinRule)


**å·¥ä½œåŸç†**ï¼šå°±åƒæ’é˜Ÿç‚¹é¤ï¼ŒæŒ‰é¡ºåºä¸€ä¸ªæ¥ä¸€ä¸ªæ¥ã€‚

```java
// è½®è¯¢ç®—æ³•æ¼”ç¤º
public class RoundRobinDemo {
    private List<String> servers = Arrays.asList(
        "192.168.1.10:8080",
        "192.168.1.11:8080", 
        "192.168.1.12:8080"
    );
    
    private int currentIndex = 0;
    
    public String selectServer() {
        String server = servers.get(currentIndex);
        currentIndex = (currentIndex + 1) % servers.size(); // å¾ªç¯é€‰æ‹©
        return server;
    }
}
```

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```
ç¬¬1æ¬¡è°ƒç”¨ â†’ 192.168.1.10:8080
ç¬¬2æ¬¡è°ƒç”¨ â†’ 192.168.1.11:8080  
ç¬¬3æ¬¡è°ƒç”¨ â†’ 192.168.1.12:8080
ç¬¬4æ¬¡è°ƒç”¨ â†’ 192.168.1.10:8080  (é‡æ–°å¼€å§‹å¾ªç¯)
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æ‰€æœ‰æœåŠ¡å™¨é…ç½®ç›¸åŒ
- âœ… è¯·æ±‚å¤„ç†æ—¶é—´å·®ä¸å¤š
- âŒ ä¸é€‚åˆæœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§çš„æƒ…å†µ

### 3.2 éšæœºç®—æ³• (RandomRule)


**å·¥ä½œåŸç†**ï¼šéšæœºé€‰æ‹©ä¸€å°æœåŠ¡å™¨ï¼Œå°±åƒæŠ½å¥–ä¸€æ ·ã€‚

```java
public class RandomDemo {
    private List<String> servers = Arrays.asList(
        "192.168.1.10:8080",
        "192.168.1.11:8080", 
        "192.168.1.12:8080"
    );
    
    private Random random = new Random();
    
    public String selectServer() {
        int index = random.nextInt(servers.size());
        return servers.get(index);
    }
}
```

**ç‰¹ç‚¹å¯¹æ¯”**ï¼š
```
è½®è¯¢ï¼šA â†’ B â†’ C â†’ A â†’ B â†’ C (æœ‰è§„å¾‹)
éšæœºï¼šA â†’ A â†’ C â†’ B â†’ A â†’ C (æ— è§„å¾‹)
```

### 3.3 åŠ æƒå“åº”æ—¶é—´ç®—æ³• (WeightedResponseTimeRule)


**å·¥ä½œåŸç†**ï¼šå“åº”è¶Šå¿«çš„æœåŠ¡å™¨ï¼Œè¢«é€‰ä¸­çš„æ¦‚ç‡è¶Šé«˜ã€‚

> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒå¤–å–APPä¼šä¼˜å…ˆæ¨èé€é¤å¿«çš„åº—é“ºä¸€æ ·ï¼ŒRibbonä¼šä¼˜å…ˆé€‰æ‹©å“åº”å¿«çš„æœåŠ¡å™¨ã€‚

**æƒé‡è®¡ç®—ç¤ºä¾‹**ï¼š
```
æœåŠ¡å™¨Aï¼šå¹³å‡å“åº”æ—¶é—´ 100ms â†’ æƒé‡é«˜
æœåŠ¡å™¨Bï¼šå¹³å‡å“åº”æ—¶é—´ 200ms â†’ æƒé‡ä¸­
æœåŠ¡å™¨Cï¼šå¹³å‡å“åº”æ—¶é—´ 500ms â†’ æƒé‡ä½

é€‰æ‹©æ¦‚ç‡ï¼šA(50%) > B(30%) > C(20%)
```

### 3.4 å¯ç”¨æ€§è¿‡æ»¤ç®—æ³• (AvailabilityFilteringRule)


**å·¥ä½œåŸç†**ï¼šè¿‡æ»¤æ‰ä¸å¯ç”¨çš„æœåŠ¡å™¨ï¼Œç„¶åè½®è¯¢é€‰æ‹©ã€‚

```
è¿‡æ»¤æ¡ä»¶ï¼š
1. æ ‡è®°ä¸ºæ•…éšœçš„æœåŠ¡å™¨
2. è¿æ¥æ•°è¿‡å¤šçš„æœåŠ¡å™¨
3. å“åº”è¶…æ—¶çš„æœåŠ¡å™¨

è¿‡æ»¤å‰ï¼š[A(æ•…éšœ), B(æ­£å¸¸), C(æ­£å¸¸), D(è¿æ¥æ»¡)]
è¿‡æ»¤åï¼š[B(æ­£å¸¸), C(æ­£å¸¸)]
åœ¨æ­£å¸¸æœåŠ¡å™¨ä¸­è½®è¯¢é€‰æ‹©
```

### 3.5 é‡è¯•ç®—æ³• (RetryRule)


**å·¥ä½œåŸç†**ï¼šåœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œé‡å¤ä½¿ç”¨å…¶ä»–ç®—æ³•é€‰æ‹©æœåŠ¡å™¨ï¼Œç›´åˆ°é€‰æ‹©æˆåŠŸã€‚

```java
// é…ç½®é‡è¯•è§„åˆ™
@Configuration
public class RibbonConfig {
    
    @Bean
    public IRule ribbonRule() {
        return new RetryRule(new RoundRobinRule(), 500); // 500mså†…é‡è¯•
    }
}
```

### 3.6 ç®—æ³•é€‰æ‹©å¯¹æ¯”è¡¨


| ç®—æ³•ç±»å‹ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| è½®è¯¢ | `ç®€å•ç¨³å®šï¼Œåˆ†å¸ƒå‡åŒ€` | `ä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½å·®å¼‚` | `æœåŠ¡å™¨é…ç½®ç›¸åŒ` |
| éšæœº | `å®ç°ç®€å•ï¼Œé¿å…çƒ­ç‚¹` | `çŸ­æœŸå†…åˆ†å¸ƒå¯èƒ½ä¸å‡` | `å¤§é‡è¯·æ±‚çš„åœºæ™¯` |
| åŠ æƒå“åº”æ—¶é—´ | `æ€§èƒ½å¥½çš„æœåŠ¡å™¨æ‰¿æ‹…æ›´å¤š` | `éœ€è¦ç»Ÿè®¡å“åº”æ—¶é—´` | `æœåŠ¡å™¨æ€§èƒ½æœ‰å·®å¼‚` |
| å¯ç”¨æ€§è¿‡æ»¤ | `è‡ªåŠ¨é¿å¼€æ•…éšœæœåŠ¡å™¨` | `é€»è¾‘ç›¸å¯¹å¤æ‚` | `æœåŠ¡å™¨ç¨³å®šæ€§æœ‰å·®å¼‚` |
| é‡è¯• | `æé«˜è°ƒç”¨æˆåŠŸç‡` | `å¢åŠ è°ƒç”¨å»¶è¿Ÿ` | `ç½‘ç»œä¸ç¨³å®šç¯å¢ƒ` |

---

## 4. ğŸ¯ æœåŠ¡å®ä¾‹é€‰æ‹©ç­–ç•¥


### 4.1 æœåŠ¡å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ


**æœåŠ¡å®ä¾‹çŠ¶æ€å›¾**
```
æœåŠ¡å¯åŠ¨
    â†“
æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ â†’ [STARTING]
    â†“
å¥åº·æ£€æŸ¥é€šè¿‡ â†’ [UP] â†â†’ [DOWN] (æ•…éšœæ—¶)
    â†“                     â†“
æœåŠ¡ä¸‹çº¿ â†’ [OUT_OF_SERVICE] â†’ ä»æ³¨å†Œä¸­å¿ƒç§»é™¤
```

### 4.2 å®ä¾‹è¿‡æ»¤ç­–ç•¥


**ğŸ”¸ åŸºäºå¥åº·çŠ¶æ€è¿‡æ»¤**

```java
@Component
public class HealthyInstanceFilter {
    
    public List<ServiceInstance> filterHealthyInstances(
            List<ServiceInstance> instances) {
        
        return instances.stream()
            .filter(instance -> "UP".equals(instance.getMetadata().get("status")))
            .collect(Collectors.toList());
    }
}
```

**ğŸ”¸ åŸºäºç‰ˆæœ¬è¿‡æ»¤**

åœ¨ç°åº¦å‘å¸ƒåœºæ™¯ä¸­ï¼Œå¯èƒ½éœ€è¦æ ¹æ®ç‰ˆæœ¬é€‰æ‹©æœåŠ¡å®ä¾‹ï¼š

```yaml
# æœåŠ¡å®ä¾‹å…ƒæ•°æ®
eureka:
  instance:
    metadata-map:
      version: "v1.2.0"
      zone: "beijing"
      weight: "100"
```

```java
// ç‰ˆæœ¬è¿‡æ»¤å™¨
public class VersionFilter {
    
    public List<ServiceInstance> filterByVersion(
            List<ServiceInstance> instances, String targetVersion) {
        
        return instances.stream()
            .filter(instance -> {
                String version = instance.getMetadata().get("version");
                return targetVersion.equals(version);
            })
            .collect(Collectors.toList());
    }
}
```

### 4.3 è‡ªå®šä¹‰é€‰æ‹©ç­–ç•¥


**åœºæ™¯ï¼šæ ¹æ®ç”¨æˆ·åœ°ç†ä½ç½®é€‰æ‹©æœ€è¿‘çš„æœåŠ¡å®ä¾‹**

```java
@Component
public class GeoLocationRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        List<Server> servers = getLoadBalancer().getReachableServers();
        
        // è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        String userZone = getCurrentUserZone();
        
        // ä¼˜å…ˆé€‰æ‹©åŒåœ°åŒºçš„æœåŠ¡å™¨
        Optional<Server> sameZoneServer = servers.stream()
            .filter(server -> userZone.equals(getServerZone(server)))
            .findFirst();
            
        return sameZoneServer.orElse(servers.get(0)); // æ‰¾ä¸åˆ°åˆ™è¿”å›ç¬¬ä¸€ä¸ª
    }
    
    private String getCurrentUserZone() {
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥ä»è¯·æ±‚å¤´æˆ–ç”¨æˆ·ä¿¡æ¯ä¸­è·å–
        return "beijing";
    }
    
    private String getServerZone(Server server) {
        // ä»æœåŠ¡å™¨å…ƒæ•°æ®ä¸­è·å–åœ°åŒºä¿¡æ¯
        return ((DiscoveryEnabledServer) server)
            .getInstanceInfo()
            .getMetadata()
            .get("zone");
    }
}
```

---

## 5. ğŸ”§ æ•…éšœæ£€æµ‹ä¸é‡è¯•æœºåˆ¶


### 5.1 æ•…éšœæ£€æµ‹æœºåˆ¶


**ä»€ä¹ˆæ˜¯æ•…éšœæ£€æµ‹ï¼Ÿ**

å°±åƒä½“æ£€ä¸€æ ·ï¼Œå®šæœŸæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿˜"å¥åº·"ã€‚å¦‚æœå‘ç°æœåŠ¡å™¨å“åº”æ…¢æˆ–è€…ä¸å“åº”äº†ï¼Œå°±æŠŠå®ƒæ ‡è®°ä¸º"ç”Ÿç—…"ï¼Œæš‚æ—¶ä¸æ´¾ä»»åŠ¡ç»™å®ƒã€‚

**ğŸ”¸ Pingæ£€æµ‹ç­–ç•¥**

```java
// è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
@Component
public class CustomPingStrategy implements IPing {
    
    @Override
    public boolean isAlive(Server server) {
        try {
            // å‘é€ç®€å•çš„å¥åº·æ£€æŸ¥è¯·æ±‚
            String healthUrl = "http://" + server.getId() + "/health";
            RestTemplate restTemplate = new RestTemplate();
            
            // è®¾ç½®è¶…æ—¶æ—¶é—´
            ResponseEntity<String> response = restTemplate
                .getForEntity(healthUrl, String.class);
                
            return response.getStatusCode().is2xxSuccessful();
            
        } catch (Exception e) {
            return false; // è¯·æ±‚å¤±è´¥ï¼Œè®¤ä¸ºæœåŠ¡ä¸å¯ç”¨
        }
    }
}
```

**ğŸ”¸ å¥åº·æ£€æŸ¥é…ç½®**

```yaml
# å¥åº·æ£€æŸ¥é…ç½®
ribbon:
  ServerListRefreshInterval: 30000    # 30ç§’åˆ·æ–°ä¸€æ¬¡æœåŠ¡åˆ—è¡¨
  NFLoadBalancerPingInterval: 10000   # 10ç§’pingä¸€æ¬¡æœåŠ¡å™¨
  NFLoadBalancerPingTimeout: 3000     # pingè¶…æ—¶æ—¶é—´3ç§’
```

### 5.2 é‡è¯•æœºåˆ¶è¯¦è§£


**ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•ï¼Ÿ**

ç½‘ç»œä¸–ç•Œä¸å¯é ï¼Œå°±åƒå¿«é€’æœ‰æ—¶ä¼šä¸¢åŒ…è£¹ã€‚é‡è¯•æœºåˆ¶å°±æ˜¯"å¤šè¯•å‡ æ¬¡"çš„ç­–ç•¥ï¼Œæé«˜æˆåŠŸç‡ã€‚

**ğŸ”¸ é‡è¯•ç­–ç•¥é…ç½®**

```yaml
# é‡è¯•é…ç½®
PRODUCT-SERVICE:
  ribbon:
    MaxAutoRetries: 1              # åŒä¸€ä¸ªæœåŠ¡å™¨é‡è¯•1æ¬¡
    MaxAutoRetriesNextServer: 2    # æ¢æœåŠ¡å™¨é‡è¯•2æ¬¡
    OkToRetryOnAllOperations: false # åªå¯¹GETè¯·æ±‚é‡è¯•
    ConnectTimeout: 3000           # è¿æ¥è¶…æ—¶3ç§’
    ReadTimeout: 5000              # è¯»å–è¶…æ—¶5ç§’
```

**ğŸ”¸ é‡è¯•æµç¨‹å›¾**

```
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
    â†“
é€‰æ‹©æœåŠ¡å™¨A (192.168.1.10)
    â†“
è¯·æ±‚å¤±è´¥ (è¿æ¥è¶…æ—¶)
    â†“
åœ¨åŒä¸€æœåŠ¡å™¨é‡è¯•1æ¬¡ (MaxAutoRetries=1)
    â†“
ä»ç„¶å¤±è´¥
    â†“
åˆ‡æ¢åˆ°æœåŠ¡å™¨B (192.168.1.11)
    â†“
é‡è¯•æˆåŠŸ âœ…
```

**ğŸ”¸ æ™ºèƒ½é‡è¯•ç­–ç•¥**

```java
@Component
public class SmartRetryHandler {
    
    // ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼Œé‡è¯•ç­–ç•¥ä¸åŒ
    public boolean shouldRetry(Exception exception, int retryCount) {
        
        // è¿æ¥è¶…æ—¶ï¼šå¯ä»¥é‡è¯•
        if (exception instanceof ConnectTimeoutException) {
            return retryCount < 3;
        }
        
        // è¯»å–è¶…æ—¶ï¼šå¯ä»¥é‡è¯•ï¼Œä½†æ¬¡æ•°å°‘ä¸€äº›
        if (exception instanceof SocketTimeoutException) {
            return retryCount < 2;
        }
        
        // 404é”™è¯¯ï¼šä¸éœ€è¦é‡è¯•
        if (exception instanceof HttpClientErrorException) {
            HttpClientErrorException httpError = (HttpClientErrorException) exception;
            return httpError.getStatusCode() != HttpStatus.NOT_FOUND;
        }
        
        return false; // å…¶ä»–å¼‚å¸¸ä¸é‡è¯•
    }
}
```

### 5.3 ç†”æ–­é™çº§é›†æˆ


**é‡è¯• + ç†”æ–­çš„ç»„åˆä½¿ç”¨**

```java
@Service
public class ProductService {
    
    @HystrixCommand(
        fallbackMethod = "getProductFromCache",
        commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", 
                           value = "3000"),
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", 
                           value = "10")
        }
    )
    public Product getProduct(Long productId) {
        // Ribbonè´Ÿè½½å‡è¡¡ + é‡è¯•
        String url = "http://PRODUCT-SERVICE/api/products/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
    
    // é™çº§æ–¹æ³•ï¼šä»ç¼“å­˜è·å–æ•°æ®
    public Product getProductFromCache(Long productId) {
        return cacheService.getProduct(productId);
    }
}
```

---

## 6. ğŸ”„ æ–­è·¯å™¨é›†æˆåº”ç”¨


### 6.1 æ–­è·¯å™¨æ¨¡å¼åŸºç¡€


**ä»€ä¹ˆæ˜¯æ–­è·¯å™¨ï¼Ÿ**

æ–­è·¯å™¨å°±åƒå®¶é‡Œçš„ç©ºæ°”å¼€å…³ï¼Œå½“ç”µæµè¿‡å¤§æ—¶è‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤æ•´ä¸ªç”µè·¯ä¸è¢«çƒ§åã€‚åœ¨å¾®æœåŠ¡ä¸­ï¼Œå½“æŸä¸ªæœåŠ¡æ•…éšœæ—¶ï¼Œæ–­è·¯å™¨ä¼š"æ–­å¼€"å¯¹å®ƒçš„è°ƒç”¨ï¼Œé˜²æ­¢æ•…éšœè”“å»¶ã€‚

**ğŸ”¸ æ–­è·¯å™¨çŠ¶æ€å›¾**

```
æ–­è·¯å™¨çŠ¶æ€è½¬æ¢ï¼š

[CLOSED] æ­£å¸¸çŠ¶æ€
    â†“ (å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼)
[OPEN] æ–­å¼€çŠ¶æ€ (ç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡)
    â†“ (ç­‰å¾…ä¸€æ®µæ—¶é—´)
[HALF_OPEN] åŠå¼€çŠ¶æ€ (å°è¯•è°ƒç”¨)
    â†“
æˆåŠŸ â†’ [CLOSED]
å¤±è´¥ â†’ [OPEN]
```

### 6.2 Hystrixä¸Ribboné›†æˆ


**åŸºç¡€é…ç½®**

```java
@SpringBootApplication
@EnableCircuitBreaker  // å¯ç”¨æ–­è·¯å™¨
@EnableEurekaClient
public class OrderServiceApplication {
    
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

**æœåŠ¡è°ƒç”¨ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @HystrixCommand(
        commandKey = "getProduct",
        groupKey = "productService",
        fallbackMethod = "getProductFallback",
        commandProperties = {
            // è¶…æ—¶æ—¶é—´
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", 
                           value = "2000"),
            // ç†”æ–­é˜ˆå€¼
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", 
                           value = "20"),
            // é”™è¯¯ç™¾åˆ†æ¯”
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", 
                           value = "50")
        }
    )
    public Product getProduct(Long productId) {
        String url = "http://PRODUCT-SERVICE/api/products/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
    
    // é™çº§æ–¹æ³•
    public Product getProductFallback(Long productId) {
        return Product.builder()
            .id(productId)
            .name("å•†å“æš‚æ—¶ä¸å¯ç”¨")
            .price(BigDecimal.ZERO)
            .build();
    }
}
```

### 6.3 æ–­è·¯å™¨é…ç½®è¯¦è§£


**æ ¸å¿ƒé…ç½®å‚æ•°**

```yaml
hystrix:
  command:
    default:  # å…¨å±€é…ç½®
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 3000  # è¶…æ—¶æ—¶é—´
      circuitBreaker:
        requestVolumeThreshold: 20       # è¯·æ±‚é‡é˜ˆå€¼
        errorThresholdPercentage: 50     # é”™è¯¯ç™¾åˆ†æ¯”
        sleepWindowInMilliseconds: 5000  # æ–­è·¯å™¨æ‰“å¼€åçš„ä¼‘çœ æ—¶é—´
    getProduct:  # ç‰¹å®šå‘½ä»¤é…ç½®
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 1000  # è·å–å•†å“ä¿¡æ¯è¶…æ—¶æ—¶é—´çŸ­ä¸€äº›
```

**é…ç½®å‚æ•°è¯´æ˜**

| å‚æ•° | **å«ä¹‰** | **å»ºè®®å€¼** |
|------|---------|-----------|
| `timeoutInMilliseconds` | `æ–¹æ³•æ‰§è¡Œè¶…æ—¶æ—¶é—´` | `æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦è®¾ç½®ï¼Œä¸€èˆ¬1-5ç§’` |
| `requestVolumeThreshold` | `è§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚æ•°é‡` | `20-50ï¼Œè¯·æ±‚é‡å¤§çš„å¯ä»¥è®¾é«˜ä¸€äº›` |
| `errorThresholdPercentage` | `è§¦å‘ç†”æ–­çš„é”™è¯¯ç™¾åˆ†æ¯”` | `50%-60%ï¼Œä¸è¦å¤ªæ•æ„Ÿ` |
| `sleepWindowInMilliseconds` | `ç†”æ–­åçš„æ¢å¤ç­‰å¾…æ—¶é—´` | `5-10ç§’ï¼Œç»™æœåŠ¡æ¢å¤çš„æ—¶é—´` |

---

## 7. âš–ï¸ æœåŠ¡æƒé‡ä¸åŒºåŸŸæ„ŸçŸ¥


### 7.1 æœåŠ¡æƒé‡æœºåˆ¶


**ä»€ä¹ˆæ˜¯æœåŠ¡æƒé‡ï¼Ÿ**

å°±åƒé¤å…é‡Œæœ‰å¤§å¨å’Œå°å·¥ï¼Œå¤§å¨åšèœå¿«è´¨é‡å¥½ï¼Œæ‰€ä»¥ä¼šåˆ†é…æ›´å¤šçš„è®¢å•ã€‚æœåŠ¡æƒé‡å°±æ˜¯å‘Šè¯‰è´Ÿè½½å‡è¡¡å™¨ï¼Œå“ªäº›æœåŠ¡å™¨"èƒ½åŠ›å¼º"ï¼Œå¯ä»¥æ‰¿æ‹…æ›´å¤šè¯·æ±‚ã€‚

**ğŸ”¸ æƒé‡é…ç½®ç¤ºä¾‹**

```yaml
# åœ¨æœåŠ¡å®ä¾‹ä¸­é…ç½®æƒé‡
eureka:
  instance:
    metadata-map:
      weight: "200"  # æƒé‡å€¼ï¼Œæ•°å€¼è¶Šå¤§æ‰¿æ‹…çš„æµé‡è¶Šå¤š
      zone: "beijing"
      version: "v1.0"
```

**ğŸ”¸ åŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡ç®—æ³•**

```java
@Component
public class WeightedRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        List<Server> servers = getLoadBalancer().getReachableServers();
        return chooseByWeight(servers);
    }
    
    private Server chooseByWeight(List<Server> servers) {
        // è®¡ç®—æ€»æƒé‡
        int totalWeight = servers.stream()
            .mapToInt(this::getServerWeight)
            .sum();
            
        // ç”Ÿæˆéšæœºæ•°
        Random random = new Random();
        int randomWeight = random.nextInt(totalWeight);
        
        // æ ¹æ®æƒé‡é€‰æ‹©æœåŠ¡å™¨
        int currentWeight = 0;
        for (Server server : servers) {
            currentWeight += getServerWeight(server);
            if (randomWeight < currentWeight) {
                return server;
            }
        }
        
        return servers.get(0); // å…œåº•è¿”å›ç¬¬ä¸€ä¸ª
    }
    
    private int getServerWeight(Server server) {
        if (server instanceof DiscoveryEnabledServer) {
            DiscoveryEnabledServer discoveryServer = (DiscoveryEnabledServer) server;
            String weight = discoveryServer.getInstanceInfo()
                .getMetadata().get("weight");
            return weight != null ? Integer.parseInt(weight) : 100; // é»˜è®¤æƒé‡100
        }
        return 100;
    }
}
```

**æƒé‡åˆ†é…ç¤ºä¾‹**ï¼š
```
æœåŠ¡å™¨Aï¼šæƒé‡200ï¼Œé…ç½®é«˜ï¼ŒSSDç¡¬ç›˜
æœåŠ¡å™¨Bï¼šæƒé‡100ï¼Œé…ç½®ä¸­ç­‰  
æœåŠ¡å™¨Cï¼šæƒé‡50ï¼Œé…ç½®è¾ƒä½

æ€»æƒé‡ï¼š350
é€‰æ‹©æ¦‚ç‡ï¼šA(57%) > B(29%) > C(14%)
```

### 7.2 åŒºåŸŸæ„ŸçŸ¥è´Ÿè½½å‡è¡¡


**ä»€ä¹ˆæ˜¯åŒºåŸŸæ„ŸçŸ¥ï¼Ÿ**

å°±åƒå¤–å–APPä¼šä¼˜å…ˆæ¨èç¦»ä½ è¿‘çš„é¤å…ä¸€æ ·ï¼ŒåŒºåŸŸæ„ŸçŸ¥è´Ÿè½½å‡è¡¡ä¼šä¼˜å…ˆé€‰æ‹©åŒä¸€åŒºåŸŸï¼ˆæœºæˆ¿ï¼‰çš„æœåŠ¡ï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿã€‚

**ğŸ”¸ åŒºåŸŸé…ç½®**

```yaml
# å®¢æˆ·ç«¯é…ç½®
eureka:
  client:
    region: china
    availability-zones:
      china: beijing,shanghai,guangzhou
  instance:
    metadata-map:
      zone: beijing    # å½“å‰å®ä¾‹æ‰€åœ¨åŒºåŸŸ
```

**ğŸ”¸ åŒºåŸŸæ„ŸçŸ¥ç®—æ³•**

```java
@Component  
public class ZoneAwareRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        List<Server> servers = getLoadBalancer().getReachableServers();
        String currentZone = getCurrentZone();
        
        // ä¼˜å…ˆé€‰æ‹©åŒåŒºåŸŸçš„æœåŠ¡å™¨
        List<Server> sameZoneServers = servers.stream()
            .filter(server -> currentZone.equals(getServerZone(server)))
            .collect(Collectors.toList());
            
        if (!sameZoneServers.isEmpty()) {
            // åœ¨åŒåŒºåŸŸæœåŠ¡å™¨ä¸­è½®è¯¢é€‰æ‹©
            return roundRobinChoose(sameZoneServers);
        } else {
            // åŒåŒºåŸŸæ²¡æœ‰å¯ç”¨æœåŠ¡å™¨ï¼Œä»å…¶ä»–åŒºåŸŸé€‰æ‹©
            return roundRobinChoose(servers);
        }
    }
    
    private String getCurrentZone() {
        // è·å–å½“å‰å®¢æˆ·ç«¯æ‰€åœ¨åŒºåŸŸ
        return "beijing";
    }
    
    private String getServerZone(Server server) {
        if (server instanceof DiscoveryEnabledServer) {
            return ((DiscoveryEnabledServer) server)
                .getInstanceInfo()
                .getMetadata()
                .get("zone");
        }
        return "unknown";
    }
}
```

### 7.3 å¤šç»´åº¦é€‰æ‹©ç­–ç•¥


**ç»¼åˆè€ƒè™‘å¤šä¸ªå› ç´ çš„é€‰æ‹©ç­–ç•¥**

```java
@Component
public class SmartLoadBalancerRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        List<Server> servers = getLoadBalancer().getReachableServers();
        
        // 1. è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨
        List<Server> healthyServers = filterHealthyServers(servers);
        
        // 2. æŒ‰åŒºåŸŸåˆ†ç»„
        Map<String, List<Server>> zoneGroups = groupByZone(healthyServers);
        
        // 3. ä¼˜å…ˆé€‰æ‹©åŒåŒºåŸŸ
        String currentZone = getCurrentZone();
        List<Server> candidates = zoneGroups.get(currentZone);
        if (candidates == null || candidates.isEmpty()) {
            candidates = healthyServers; // åŒåŒºåŸŸæ²¡æœ‰ï¼Œé€‰æ‹©å…¶ä»–åŒºåŸŸ
        }
        
        // 4. åœ¨å€™é€‰æœåŠ¡å™¨ä¸­æŒ‰æƒé‡é€‰æ‹©
        return chooseByWeight(candidates);
    }
    
    private List<Server> filterHealthyServers(List<Server> servers) {
        // è¿‡æ»¤å¥åº·çš„æœåŠ¡å™¨
        return servers.stream()
            .filter(this::isServerHealthy)
            .collect(Collectors.toList());
    }
    
    private Map<String, List<Server>> groupByZone(List<Server> servers) {
        // æŒ‰åŒºåŸŸåˆ†ç»„
        return servers.stream()
            .collect(Collectors.groupingBy(this::getServerZone));
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼šåœ¨è°ƒç”¨æ–¹å®ç°è´Ÿè½½å‡è¡¡ï¼Œæ— å•ç‚¹æ•…éšœ
ğŸ”¸ Ribbonç»„ä»¶ï¼šNetflixå¼€æºçš„è´Ÿè½½å‡è¡¡åº“ï¼ŒSpring Cloudé»˜è®¤é›†æˆ
ğŸ”¸ è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šè½®è¯¢ã€éšæœºã€æƒé‡ã€å¯ç”¨æ€§è¿‡æ»¤ç­‰å¤šç§ç­–ç•¥
ğŸ”¸ æ•…éšœæ£€æµ‹ï¼šé€šè¿‡Pingæœºåˆ¶æ£€æµ‹æœåŠ¡å™¨å¥åº·çŠ¶æ€
ğŸ”¸ é‡è¯•æœºåˆ¶ï¼šå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæé«˜è°ƒç”¨æˆåŠŸç‡
ğŸ”¸ æ–­è·¯å™¨æ¨¡å¼ï¼šé˜²æ­¢æ•…éšœè”“å»¶ï¼Œæä¾›é™çº§èƒ½åŠ›
ğŸ”¸ æƒé‡æœºåˆ¶ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…ä¸åŒçš„æµé‡æ¯”ä¾‹
ğŸ”¸ åŒºåŸŸæ„ŸçŸ¥ï¼šä¼˜å…ˆé€‰æ‹©åŒåŒºåŸŸæœåŠ¡ï¼Œå‡å°‘ç½‘ç»œå»¶è¿Ÿ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡**

```
ä¼ ç»Ÿè´Ÿè½½å‡è¡¡é—®é¢˜ï¼š
- å•ç‚¹æ•…éšœé£é™©
- æ€§èƒ½ç“¶é¢ˆ
- é…ç½®å¤æ‚

å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ä¼˜åŠ¿ï¼š
- æ— å•ç‚¹æ•…éšœ
- æ€§èƒ½æ›´å¥½  
- é…ç½®çµæ´»
- ä¸æœåŠ¡å‘ç°å¤©ç„¶é›†æˆ
```

**ğŸ”¹ å¦‚ä½•é€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç®—æ³•**

```
åœºæ™¯åˆ†æï¼š
æœåŠ¡å™¨é…ç½®ç›¸åŒ â†’ è½®è¯¢ç®—æ³•
æœåŠ¡å™¨æ€§èƒ½æœ‰å·®å¼‚ â†’ åŠ æƒå“åº”æ—¶é—´ç®—æ³•  
ç½‘ç»œç¯å¢ƒä¸ç¨³å®š â†’ å¯ç”¨æ€§è¿‡æ»¤ + é‡è¯•ç®—æ³•
éœ€è¦ä¼šè¯ä¿æŒ â†’ ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
```

**ğŸ”¹ é‡è¯•å’Œç†”æ–­çš„é…åˆä½¿ç”¨**

```
é‡è¯•ï¼šè§£å†³ä¸´æ—¶æ€§æ•…éšœï¼Œæé«˜æˆåŠŸç‡
ç†”æ–­ï¼šå¤„ç†æŒç»­æ€§æ•…éšœï¼Œé˜²æ­¢èµ„æºè€—å°½

æœ€ä½³å®è·µï¼š
å…ˆé‡è¯•å‡ æ¬¡ï¼Œå¦‚æœæŒç»­å¤±è´¥å°±è§¦å‘ç†”æ–­
ç†”æ–­æœŸé—´ç›´æ¥è¿”å›é™çº§å“åº”ï¼Œä¸æ¶ˆè€—èµ„æº
```

### 8.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ¯ é…ç½®å»ºè®®**

```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
ribbon:
  # è¿æ¥å’Œè¯»å–è¶…æ—¶
  ConnectTimeout: 3000
  ReadTimeout: 10000
  
  # é‡è¯•é…ç½®
  MaxAutoRetries: 1
  MaxAutoRetriesNextServer: 2
  OkToRetryOnAllOperations: false  # åªå¯¹GETé‡è¯•
  
  # å¥åº·æ£€æŸ¥
  NFLoadBalancerPingInterval: 30000
  ServerListRefreshInterval: 30000

# ç†”æ–­å™¨é…ç½®  
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 5000
      circuitBreaker:
        requestVolumeThreshold: 20
        errorThresholdPercentage: 50
        sleepWindowInMilliseconds: 5000
```

**ğŸ”§ ç›‘æ§æŒ‡æ ‡**

```
é‡è¦ç›‘æ§æŒ‡æ ‡ï¼š
- è¯·æ±‚æˆåŠŸç‡
- å¹³å‡å“åº”æ—¶é—´  
- å„æœåŠ¡å™¨çš„è¯·æ±‚åˆ†å¸ƒ
- é‡è¯•æ¬¡æ•°ç»Ÿè®¡
- ç†”æ–­å™¨çŠ¶æ€
- ä¸åŒåŒºåŸŸçš„è°ƒç”¨å»¶è¿Ÿ
```

**ğŸš¨ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**

| é—®é¢˜ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|-------------|-------------|
| `è´Ÿè½½åˆ†å¸ƒä¸å‡` | `æœåŠ¡å™¨æ€§èƒ½å·®å¼‚` | `ä½¿ç”¨åŠ æƒå“åº”æ—¶é—´ç®—æ³•` |
| `è°ƒç”¨ç»å¸¸å¤±è´¥` | `è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­` | `é€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´` |
| `æœåŠ¡é›ªå´©` | `æ²¡æœ‰ç†”æ–­ä¿æŠ¤` | `é…ç½®Hystrixæ–­è·¯å™¨` |
| `è·¨åŒºåŸŸè°ƒç”¨å»¶è¿Ÿé«˜` | `æ²¡æœ‰å¼€å¯åŒºåŸŸæ„ŸçŸ¥` | `é…ç½®zone-awareè´Ÿè½½å‡è¡¡` |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼Œæ€§èƒ½å¥½æ— å•ç‚¹
- Ribbonç®—æ³•å¤šæ ·åŒ–ï¼Œåœºæ™¯é€‰æ‹©è¦åˆé€‚  
- æ•…éšœæ£€æµ‹åŠ é‡è¯•ï¼ŒæœåŠ¡ç¨³å®šæœ‰ä¿éšœ
- ç†”æ–­é™çº§é˜²é›ªå´©ï¼Œæƒé‡åŒºåŸŸä¼˜æ€§èƒ½