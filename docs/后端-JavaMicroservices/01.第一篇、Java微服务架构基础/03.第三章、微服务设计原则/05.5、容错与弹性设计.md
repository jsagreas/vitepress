---
title: 5ã€å®¹é”™ä¸å¼¹æ€§è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å®¹é”™ä¸å¼¹æ€§è®¾è®¡æ¦‚è¿°](#1-å®¹é”™ä¸å¼¹æ€§è®¾è®¡æ¦‚è¿°)
2. [æ•…éšœéš”ç¦»æœºåˆ¶](#2-æ•…éšœéš”ç¦»æœºåˆ¶)
3. [ç†”æ–­å™¨æ¨¡å¼](#3-ç†”æ–­å™¨æ¨¡å¼)
4. [é™æµç­–ç•¥](#4-é™æµç­–ç•¥)
5. [é™çº§å¤„ç†](#5-é™çº§å¤„ç†)
6. [è¶…æ—¶è®¾ç½®](#6-è¶…æ—¶è®¾ç½®)
7. [é‡è¯•ç­–ç•¥](#7-é‡è¯•ç­–ç•¥)
8. [å¹‚ç­‰æ€§è®¾è®¡](#8-å¹‚ç­‰æ€§è®¾è®¡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹é”™ä¸å¼¹æ€§è®¾è®¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®¹é”™ä¸å¼¹æ€§


**é€šä¿—ç†è§£**ï¼šå°±åƒç»™ä½ çš„æˆ¿å­è£…ä¿é™©ä¸ä¸€æ ·ï¼Œå½“æŸä¸ªç”µå™¨çŸ­è·¯æ—¶ï¼Œä¸ä¼šçƒ§æ‰æ•´ä¸ªæˆ¿å­

```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
ğŸ  [æ•´ä¸ªåº”ç”¨] â†’ ä¸€ä¸ªåœ°æ–¹å‡ºé”™ï¼Œæ•´ä¸ªç³»ç»Ÿå´©æºƒ

å¾®æœåŠ¡æ¶æ„ï¼š
ğŸ˜ï¸ [æœåŠ¡A] [æœåŠ¡B] [æœåŠ¡C] â†’ ä¸€ä¸ªæœåŠ¡å‡ºé”™ï¼Œå…¶ä»–æœåŠ¡ç»§ç»­å·¥ä½œ
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
- **å®¹é”™ï¼ˆFault Toleranceï¼‰**ï¼šç³»ç»Ÿåœ¨å‡ºç°é”™è¯¯æ—¶ï¼Œèƒ½å¤Ÿç»§ç»­è¿è¡Œè€Œä¸æ˜¯å®Œå…¨å´©æºƒ
- **å¼¹æ€§ï¼ˆResilienceï¼‰**ï¼šç³»ç»Ÿèƒ½å¤Ÿä»æ•…éšœä¸­å¿«é€Ÿæ¢å¤ï¼Œå¹¶ä¸”é€‚åº”å„ç§å¼‚å¸¸æƒ…å†µ

### 1.2 ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦å®¹é”™è®¾è®¡


**é—®é¢˜åœºæ™¯**ï¼šæƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¿é”é¤å…

```
ä¼ ç»Ÿæ–¹å¼é—®é¢˜ï¼š
å¨å¸ˆç”Ÿç—… â†’ æ•´ä¸ªé¤å…å…³é—¨ â†’ é¡¾å®¢å…¨éƒ¨æµå¤±

å¾®æœåŠ¡æ–¹å¼è§£å†³ï¼š
å¨å¸ˆç”Ÿç—… â†’ åªå½±å“çƒ­èœ â†’ å‡‰èœå’Œé¥®å“ç…§å¸¸ä¾›åº” â†’ é¡¾å®¢éƒ¨åˆ†éœ€æ±‚å¾—åˆ°æ»¡è¶³
```

**å¾®æœåŠ¡ç‰¹æœ‰æŒ‘æˆ˜**ï¼š
- **ç½‘ç»œè°ƒç”¨**ï¼šæœåŠ¡é—´é€šè¿‡ç½‘ç»œé€šä¿¡ï¼Œç½‘ç»œå¯èƒ½ä¸ç¨³å®š
- **ä¾èµ–å¤æ‚**ï¼šä¸€ä¸ªè¯·æ±‚å¯èƒ½è°ƒç”¨å¤šä¸ªæœåŠ¡
- **æ•…éšœä¼ æ’­**ï¼šä¸€ä¸ªæœåŠ¡çš„é—®é¢˜å¯èƒ½å½±å“å…¶ä»–æœåŠ¡

### 1.3 å®¹é”™è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³


**è®¾è®¡ç†å¿µ**ï¼š
```
ğŸ”¸ å‡è®¾å¤±è´¥ä¼šå‘ç”Ÿï¼šä¸æ˜¯"å¦‚æœå¤±è´¥"ï¼Œè€Œæ˜¯"å½“å¤±è´¥å‘ç”Ÿæ—¶"
ğŸ”¸ å¿«é€Ÿå¤±è´¥ï¼šä¸å…¶æ…¢æ…¢ç­‰å¾…ï¼Œä¸å¦‚å¿«é€ŸæŠ¥é”™å¹¶å¤„ç†
ğŸ”¸ ä¼˜é›…é™çº§ï¼šæä¾›åŸºæœ¬åŠŸèƒ½ï¼Œè€Œä¸æ˜¯å®Œå…¨ä¸å¯ç”¨
ğŸ”¸ è‡ªæˆ‘æ¢å¤ï¼šç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å°è¯•æ¢å¤
```

---

## 2. ğŸš§ æ•…éšœéš”ç¦»æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯æ•…éšœéš”ç¦»


**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒèˆ¹èˆ±çš„æ°´å¯†éš”é—´ï¼Œä¸€ä¸ªèˆ±è¿›æ°´äº†ï¼Œä¸ä¼šå½±å“å…¶ä»–èˆ±å®¤

```
æ— éš”ç¦»çš„æƒ…å†µï¼š
[ç”¨æˆ·æœåŠ¡] â†’ [è®¢å•æœåŠ¡] â†’ [æ”¯ä»˜æœåŠ¡] â†’ [åº“å­˜æœåŠ¡]
    â†“           â†“           âŒ           â†“
  æ­£å¸¸        æ­£å¸¸      æ”¯ä»˜æœåŠ¡æŒ‚äº†    æ— æ³•è®¿é—®
                         â†“
                    æ•´ä¸ªé“¾è·¯éƒ½å—å½±å“

æœ‰éš”ç¦»çš„æƒ…å†µï¼š
[ç”¨æˆ·æœåŠ¡] â†’ [è®¢å•æœåŠ¡] â†’ [æ”¯ä»˜æœåŠ¡] â†’ [åº“å­˜æœåŠ¡]
    â†“           â†“           âŒ           â†“
  æ­£å¸¸        æ­£å¸¸      æ”¯ä»˜æœåŠ¡æŒ‚äº†    æ­£å¸¸å·¥ä½œ
                         â†“
                    åªå½±å“æ”¯ä»˜åŠŸèƒ½
```

### 2.2 éš”ç¦»çš„ç»´åº¦


**ğŸ”¸ çº¿ç¨‹çº§éš”ç¦»**
```java
// ä¸ºä¸åŒçš„æœåŠ¡è°ƒç”¨åˆ†é…ç‹¬ç«‹çš„çº¿ç¨‹æ± 
@Service
public class OrderService {
    
    // æ”¯ä»˜æœåŠ¡ä¸“ç”¨çº¿ç¨‹æ± 
    private ExecutorService paymentExecutor = 
        Executors.newFixedThreadPool(10);
    
    // åº“å­˜æœåŠ¡ä¸“ç”¨çº¿ç¨‹æ±   
    private ExecutorService inventoryExecutor = 
        Executors.newFixedThreadPool(5);
    
    public void createOrder() {
        // æ”¯ä»˜è°ƒç”¨ç”¨ä¸“é—¨çš„çº¿ç¨‹æ± 
        paymentExecutor.submit(() -> paymentService.process());
        // åº“å­˜è°ƒç”¨ç”¨å¦ä¸€ä¸ªçº¿ç¨‹æ± 
        inventoryExecutor.submit(() -> inventoryService.reserve());
    }
}
```

**ğŸ”¸ è¿›ç¨‹çº§éš”ç¦»**
```
æœåŠ¡éƒ¨ç½²éš”ç¦»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡     â”‚  â”‚ è®¢å•æœåŠ¡     â”‚  â”‚ æ”¯ä»˜æœåŠ¡     â”‚
â”‚ (ç‹¬ç«‹è¿›ç¨‹)   â”‚  â”‚ (ç‹¬ç«‹è¿›ç¨‹)   â”‚  â”‚ (ç‹¬ç«‹è¿›ç¨‹)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ èµ„æºçº§éš”ç¦»**
```yaml
# Dockerèµ„æºé™åˆ¶ç¤ºä¾‹
services:
  user-service:
    image: user-service:latest
    deploy:
      resources:
        limits:
          cpus: '1.0'      # CPUé™åˆ¶
          memory: 512M     # å†…å­˜é™åˆ¶
        reservations:
          cpus: '0.5'
          memory: 256M
```

### 2.3 èˆ±å£æ¨¡å¼å®ç°


**èˆ±å£æ¨¡å¼**ï¼šæŠŠä¸åŒçš„åŠŸèƒ½æ”¾åœ¨ä¸åŒçš„"èˆ±å®¤"é‡Œ

```java
@Component
public class ServiceBulkhead {
    
    // æ ¸å¿ƒä¸šåŠ¡çº¿ç¨‹æ±  - é«˜ä¼˜å…ˆçº§
    private final ExecutorService coreBusinessPool = 
        Executors.newFixedThreadPool(20);
    
    // æŠ¥è¡¨ä¸šåŠ¡çº¿ç¨‹æ±  - ä½ä¼˜å…ˆçº§    
    private final ExecutorService reportPool = 
        Executors.newFixedThreadPool(5);
    
    // æ‰¹å¤„ç†çº¿ç¨‹æ±  - ç‹¬ç«‹éš”ç¦»
    private final ExecutorService batchPool = 
        Executors.newFixedThreadPool(10);
    
    public CompletableFuture<String> handleCoreRequest() {
        return CompletableFuture.supplyAsync(() -> {
            // æ ¸å¿ƒä¸šåŠ¡å¤„ç†
            return "æ ¸å¿ƒä¸šåŠ¡å¤„ç†å®Œæˆ";
        }, coreBusinessPool);
    }
    
    public CompletableFuture<String> generateReport() {
        return CompletableFuture.supplyAsync(() -> {
            // æŠ¥è¡¨ç”Ÿæˆ - å³ä½¿å¾ˆæ…¢ä¹Ÿä¸å½±å“æ ¸å¿ƒä¸šåŠ¡
            return "æŠ¥è¡¨ç”Ÿæˆå®Œæˆ";
        }, reportPool);
    }
}
```

---

## 3. âš¡ ç†”æ–­å™¨æ¨¡å¼


### 3.1 ç†”æ–­å™¨çš„å·¥ä½œåŸç†


**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒå®¶é‡Œçš„ä¿é™©ä¸ï¼Œå½“ç”µæµè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤ç”µå™¨è®¾å¤‡

```
ç†”æ–­å™¨çŠ¶æ€å˜åŒ–ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¤±è´¥ç‡è¿‡é«˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¶…æ—¶å    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…³é—­çŠ¶æ€ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ å¼€å¯çŠ¶æ€ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ åŠå¼€çŠ¶æ€ â”‚
â”‚ (æ­£å¸¸)  â”‚                â”‚ (æ‹’ç»)  â”‚             â”‚ (æµ‹è¯•)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                                                   â”‚
     â”‚                     æˆåŠŸæ¢å¤                        â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç†”æ–­å™¨çŠ¶æ€è¯¦è§£


**ğŸŸ¢ å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰**ï¼š
- **å«ä¹‰**ï¼šæ­£å¸¸å·¥ä½œçŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šé€šè¿‡
- **ç›‘æ§**ï¼šç»Ÿè®¡å¤±è´¥ç‡ï¼Œå½“å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶åˆ‡æ¢åˆ°å¼€å¯çŠ¶æ€

**ğŸ”´ å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰**ï¼š
- **å«ä¹‰**ï¼šç†”æ–­çŠ¶æ€ï¼Œç›´æ¥æ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œç«‹å³è¿”å›å¤±è´¥
- **ç›®çš„**ï¼šä¿æŠ¤ä¸‹æ¸¸æœåŠ¡ï¼Œç»™å®ƒæ¢å¤çš„æ—¶é—´

**ğŸŸ¡ åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰**ï¼š
- **å«ä¹‰**ï¼šæµ‹è¯•çŠ¶æ€ï¼Œå…è®¸å°‘é‡è¯·æ±‚é€šè¿‡æ¥æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤
- **åˆ¤æ–­**ï¼šå¦‚æœæµ‹è¯•æˆåŠŸå°±å›åˆ°å…³é—­çŠ¶æ€ï¼Œå¤±è´¥å°±å›åˆ°å¼€å¯çŠ¶æ€

### 3.3 ä½¿ç”¨Hystrixå®ç°ç†”æ–­å™¨


```java
@Component
public class PaymentService {
    
    @HystrixCommand(
        fallbackMethod = "paymentFallback",    // é™çº§æ–¹æ³•
        commandProperties = {
            @HystrixProperty(name = "circuitBreaker.enabled", value = "true"),
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "5000")
        }
    )
    public String processPayment(String orderId) {
        // è°ƒç”¨æ”¯ä»˜æœåŠ¡
        if (Math.random() > 0.5) {
            throw new RuntimeException("æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        }
        return "æ”¯ä»˜æˆåŠŸï¼š" + orderId;
    }
    
    // é™çº§æ–¹æ³• - å½“ç†”æ–­å™¨å¼€å¯æ—¶è°ƒç”¨
    public String paymentFallback(String orderId) {
        return "æ”¯ä»˜æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•ã€‚è®¢å•å·ï¼š" + orderId;
    }
}
```

**å‚æ•°è§£é‡Š**ï¼š
- `requestVolumeThreshold = 10`ï¼šè‡³å°‘10ä¸ªè¯·æ±‚æ‰å¼€å§‹ç»Ÿè®¡
- `errorThresholdPercentage = 50`ï¼šé”™è¯¯ç‡è¶…è¿‡50%è§¦å‘ç†”æ–­
- `sleepWindowInMilliseconds = 5000`ï¼šç†”æ–­å5ç§’è¿›å…¥åŠå¼€çŠ¶æ€

### 3.4 ç°ä»£åŒ–ç†”æ–­å™¨ - Resilience4j


```java
@Service
public class ModernPaymentService {
    
    private final CircuitBreaker circuitBreaker;
    
    public ModernPaymentService() {
        // åˆ›å»ºç†”æ–­å™¨é…ç½®
        CircuitBreakerConfig config = CircuitBreakerConfig.custom()
            .slidingWindowSize(10)                    // æ»‘åŠ¨çª—å£å¤§å°
            .failureRateThreshold(50.0f)             // å¤±è´¥ç‡é˜ˆå€¼50%
            .waitDurationInOpenState(Duration.ofSeconds(5))  // å¼€å¯çŠ¶æ€ç­‰å¾…æ—¶é—´
            .build();
            
        this.circuitBreaker = CircuitBreaker.of("payment", config);
    }
    
    public String processPayment(String orderId) {
        Supplier<String> decoratedSupplier = CircuitBreaker
            .decorateSupplier(circuitBreaker, () -> {
                // å®é™…çš„ä¸šåŠ¡é€»è¾‘
                return callPaymentAPI(orderId);
            });
            
        return Try.ofSupplier(decoratedSupplier)
            .recover(throwable -> "æ”¯ä»˜æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•")
            .get();
    }
    
    private String callPaymentAPI(String orderId) {
        // æ¨¡æ‹Ÿæ”¯ä»˜APIè°ƒç”¨
        if (Math.random() > 0.6) {
            throw new RuntimeException("æ”¯ä»˜APIå¼‚å¸¸");
        }
        return "æ”¯ä»˜æˆåŠŸï¼š" + orderId;
    }
}
```

---

## 4. ğŸš¦ é™æµç­–ç•¥


### 4.1 ä»€ä¹ˆæ˜¯é™æµ


**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒæ™¯åŒºçš„å…¥å›­é™åˆ¶ï¼ŒåŒæ—¶åªå…è®¸ä¸€å®šæ•°é‡çš„æ¸¸å®¢è¿›å…¥ï¼Œé˜²æ­¢è¿‡åº¦æ‹¥æŒ¤

```
æ— é™æµçš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¯·æ±‚1â”‚  â”‚è¯·æ±‚2â”‚  â”‚è¯·æ±‚3â”‚  â”‚...  â”‚ â”€â”€â†’ â”‚ æœåŠ¡å´©æºƒ  â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  åŒæ—¶æ¶Œå…¥å¤§é‡è¯·æ±‚

æœ‰é™æµä¿æŠ¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¯·æ±‚1â”‚  â”‚è¯·æ±‚2â”‚  â”‚è¯·æ±‚3â”‚  â”€â”€â”€é€šè¿‡â”€â”€â†’  â”‚ æœåŠ¡æ­£å¸¸  â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
                   â”‚è¯·æ±‚4â”‚  â”‚è¯·æ±‚5â”‚  â”€â”€è¢«æ‹’ç»
                   â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
```

### 4.2 é™æµç®—æ³•


**ğŸ”¸ ä»¤ç‰Œæ¡¶ç®—æ³•**
```
å·¥ä½œåŸç†ï¼šåƒä¸€ä¸ªå›ºå®šå®¹é‡çš„æ¡¶ï¼Œä»¥å›ºå®šé€Ÿç‡æ”¾å…¥ä»¤ç‰Œ

        ä»¤ç‰Œæ¡¶ (å®¹é‡5ä¸ªä»¤ç‰Œ)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸª™ ğŸª™ ğŸª™ ğŸª™ ğŸª™  â”‚  â† æ¡¶ä¸­å½“å‰ä»¤ç‰Œæ•°
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†‘
        æ¯ç§’æ”¾å…¥2ä¸ªä»¤ç‰Œ

è¯·æ±‚å¤„ç†ï¼š
- æœ‰ä»¤ç‰Œ â†’ å–èµ°ä»¤ç‰Œï¼Œå¤„ç†è¯·æ±‚
- æ— ä»¤ç‰Œ â†’ æ‹’ç»è¯·æ±‚æˆ–æ’é˜Ÿç­‰å¾…
```

```java
@Component
public class TokenBucketLimiter {
    
    private final RateLimiter rateLimiter;
    
    public TokenBucketLimiter() {
        // æ¯ç§’å…è®¸2ä¸ªè¯·æ±‚
        this.rateLimiter = RateLimiter.create(2.0);
    }
    
    public String handleRequest(String requestId) {
        // å°è¯•è·å–ä»¤ç‰Œï¼Œæœ€å¤šç­‰å¾…1ç§’
        if (rateLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
            return "è¯·æ±‚å¤„ç†æˆåŠŸï¼š" + requestId;
        } else {
            return "æœåŠ¡ç¹å¿™ï¼Œè¯·æ±‚è¢«é™æµï¼š" + requestId;
        }
    }
}
```

**ğŸ”¸ æ»‘åŠ¨çª—å£ç®—æ³•**
```
æ»‘åŠ¨çª—å£ç¤ºä¾‹ (çª—å£å¤§å°10ç§’ï¼Œé™åˆ¶100ä¸ªè¯·æ±‚)ï¼š

æ—¶é—´è½´ï¼š  |----10ç§’çª—å£----|
         0  1  2  3  4  5  6  7  8  9  10
è¯·æ±‚æ•°ï¼š  10 15 12 8  20 18 15 2  0  5   105ä¸ª â† è¶…è¿‡é™åˆ¶

çª—å£æ»‘åŠ¨ï¼š     |----10ç§’çª—å£----|  
              1  2  3  4  5  6  7  8  9  10 11
æ–°è¯·æ±‚æ•°ï¼š     15 12 8  20 18 15 2  0  5  10  95ä¸ª â† å…è®¸é€šè¿‡
```

### 4.3 åˆ†å¸ƒå¼é™æµ


**ğŸ”¸ åŸºäºRedisçš„åˆ†å¸ƒå¼é™æµ**
```java
@Component
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    public boolean isAllowed(String key, int limit, int windowSize) {
        String script = 
            "local key = KEYS[1] " +
            "local window = ARGV[1] " +
            "local limit = tonumber(ARGV[2]) " +
            "local now = tonumber(ARGV[3]) " +
            
            // åˆ é™¤è¿‡æœŸçš„è¯·æ±‚è®°å½•
            "redis.call('zremrangebyscore', key, 0, now - window) " +
            
            // è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
            "local current = redis.call('zcard', key) " +
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
            "if current < limit then " +
                "redis.call('zadd', key, now, now) " +
                "redis.call('expire', key, window) " +
                "return 1 " +
            "else " +
                "return 0 " +
            "end";
            
        Long result = redisTemplate.execute(
            RedisScript.of(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowSize * 1000),
            String.valueOf(limit),
            String.valueOf(System.currentTimeMillis())
        );
        
        return result != null && result == 1;
    }
}
```

### 4.4 å¤šçº§é™æµç­–ç•¥


```java
@RestController
public class OrderController {
    
    @Autowired
    private TokenBucketLimiter globalLimiter;     // å…¨å±€é™æµ
    
    @Autowired  
    private RedisRateLimiter userLimiter;         // ç”¨æˆ·çº§é™æµ
    
    @PostMapping("/order")
    public ResponseEntity<String> createOrder(@RequestParam String userId) {
        
        // ç¬¬ä¸€å±‚ï¼šå…¨å±€é™æµ
        if (!globalLimiter.handleRequest("global").contains("æˆåŠŸ")) {
            return ResponseEntity.status(429).body("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // ç¬¬äºŒå±‚ï¼šç”¨æˆ·é™æµ (æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š10ä¸ªè®¢å•)
        if (!userLimiter.isAllowed("user:" + userId, 10, 60)) {
            return ResponseEntity.status(429).body("æ‚¨çš„è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // å¤„ç†è®¢å•
        return ResponseEntity.ok("è®¢å•åˆ›å»ºæˆåŠŸ");
    }
}
```

---

## 5. ğŸ“‰ é™çº§å¤„ç†


### 5.1 ä»€ä¹ˆæ˜¯æœåŠ¡é™çº§


**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒç”µæ¢¯åäº†æ—¶èµ°æ¥¼æ¢¯ï¼Œè™½ç„¶æ…¢ä¸€ç‚¹ä½†è¿˜èƒ½åˆ°è¾¾ç›®çš„åœ°

```
é™çº§ç­–ç•¥ç¤ºä¾‹ï¼š
æ­£å¸¸æƒ…å†µï¼šç”¨æˆ·æŸ¥è¯¢ â†’ å®æ—¶æ•°æ®åº“æŸ¥è¯¢ â†’ è¿”å›æœ€æ–°æ•°æ®
é™çº§æƒ…å†µï¼šç”¨æˆ·æŸ¥è¯¢ â†’ ç¼“å­˜æ•°æ® â†’ è¿”å›ç¨æ—§ä½†å¯ç”¨çš„æ•°æ®

å®Œå…¨é™çº§ï¼šç”¨æˆ·æŸ¥è¯¢ â†’ é™æ€é¡µé¢ â†’ è¿”å›"ç³»ç»Ÿç»´æŠ¤ä¸­"æç¤º
```

### 5.2 é™çº§çš„ç±»å‹


**ğŸ”¸ åŠŸèƒ½é™çº§**
```java
@Service
public class ProductService {
    
    @Autowired
    private RecommendationService recommendationService;
    
    @Autowired
    private RedisTemplate<String, Object> redis;
    
    public ProductInfo getProductDetail(String productId) {
        ProductInfo product = getBasicProductInfo(productId);
        
        try {
            // å°è¯•è·å–æ¨èä¿¡æ¯ (éæ ¸å¿ƒåŠŸèƒ½)
            List<String> recommendations = recommendationService
                .getRecommendations(productId);
            product.setRecommendations(recommendations);
        } catch (Exception e) {
            // æ¨èæœåŠ¡å¼‚å¸¸æ—¶é™çº§ - ä½¿ç”¨é»˜è®¤æ¨è
            product.setRecommendations(Arrays.asList("çƒ­é—¨å•†å“1", "çƒ­é—¨å•†å“2"));
            log.warn("æ¨èæœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ¨è: {}", e.getMessage());
        }
        
        return product;
    }
}
```

**ğŸ”¸ æ€§èƒ½é™çº§**
```java
@Service
public class SearchService {
    
    public SearchResult search(String keyword) {
        // æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
        if (getSystemLoad() > 0.8) {
            // é«˜è´Ÿè½½æ—¶é™çº§ï¼šåªæœç´¢æ ‡é¢˜ï¼Œä¸æœç´¢å†…å®¹
            return searchTitleOnly(keyword);
        } else {
            // æ­£å¸¸è´Ÿè½½ï¼šå…¨æ–‡æœç´¢
            return fullTextSearch(keyword);
        }
    }
    
    private SearchResult searchTitleOnly(String keyword) {
        // ç®€åŒ–çš„æœç´¢é€»è¾‘ï¼Œå“åº”æ›´å¿«
        return new SearchResult("ç®€åŒ–æœç´¢ç»“æœ");
    }
    
    private SearchResult fullTextSearch(String keyword) {
        // å®Œæ•´çš„æœç´¢é€»è¾‘ï¼ŒåŠŸèƒ½æ›´å…¨ä½†è€—æ—¶æ›´é•¿
        return new SearchResult("å®Œæ•´æœç´¢ç»“æœ");
    }
}
```

### 5.3 è‡ªåŠ¨é™çº§æœºåˆ¶


```java
@Component
public class AutoDegradationManager {
    
    private volatile boolean isOrderServiceDegraded = false;
    private volatile boolean isPaymentServiceDegraded = false;
    
    // å®šæœŸæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
    @Scheduled(fixedRate = 30000)  // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkServiceHealth() {
        
        // æ£€æŸ¥è®¢å•æœåŠ¡
        try {
            orderService.healthCheck();
            isOrderServiceDegraded = false;
        } catch (Exception e) {
            isOrderServiceDegraded = true;
            log.warn("è®¢å•æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¯åŠ¨é™çº§æ¨¡å¼");
        }
        
        // æ£€æŸ¥æ”¯ä»˜æœåŠ¡  
        try {
            paymentService.healthCheck();
            isPaymentServiceDegraded = false;
        } catch (Exception e) {
            isPaymentServiceDegraded = true;
            log.warn("æ”¯ä»˜æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¯åŠ¨é™çº§æ¨¡å¼");
        }
    }
    
    public boolean isServiceDegraded(String serviceName) {
        switch (serviceName) {
            case "order":
                return isOrderServiceDegraded;
            case "payment":
                return isPaymentServiceDegraded;
            default:
                return false;
        }
    }
}
```

---

## 6. â° è¶…æ—¶è®¾ç½®


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶è®¾ç½®


**é—®é¢˜åœºæ™¯**ï¼š
```
æ— è¶…æ—¶è®¾ç½®çš„é—®é¢˜ï¼š
å®¢æˆ·ç«¯ â”€â”€è¯·æ±‚â”€â”€â†’ æœåŠ¡A â”€â”€è¯·æ±‚â”€â”€â†’ æœåŠ¡B (å“åº”å¾ˆæ…¢)
   â†“              â†“              â†“
  ç­‰å¾…...         ç­‰å¾…...         å¤„ç†ä¸­...
   â†“              â†“              â†“
  ä¸€ç›´ç­‰å¾…         ä¸€ç›´ç­‰å¾…         å¯èƒ½æ°¸è¿œä¸å“åº”

æœ‰è¶…æ—¶è®¾ç½®çš„è§£å†³ï¼š
å®¢æˆ·ç«¯ â”€â”€è¯·æ±‚â”€â”€â†’ æœåŠ¡A â”€â”€è¯·æ±‚â”€â”€â†’ æœåŠ¡B
   â†“              â†“              â†“
  ç­‰å¾…3ç§’         ç­‰å¾…2ç§’         å¤„ç†ä¸­...
   â†“              â†“              â†“
  æ”¶åˆ°å“åº”æˆ–è¶…æ—¶    æ”¶åˆ°å“åº”æˆ–è¶…æ—¶    è¶…æ—¶ååœæ­¢
```

### 6.2 è¶…æ—¶è®¾ç½®çš„å±‚æ¬¡


**ğŸ”¸ è¿æ¥è¶…æ—¶ vs è¯»å–è¶…æ—¶**
```java
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
            
        // è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æœ€å¤§æ—¶é—´
        factory.setConnectTimeout(3000);  // 3ç§’
        
        // è¯»å–è¶…æ—¶ï¼šç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´  
        factory.setReadTimeout(5000);     // 5ç§’
        
        return new RestTemplate(factory);
    }
}
```

**è¶…æ—¶ç±»å‹è§£é‡Š**ï¼š
- **è¿æ¥è¶…æ—¶**ï¼šå°±åƒæ‹¨ç”µè¯ç­‰å¾…æ¥é€šçš„æ—¶é—´
- **è¯»å–è¶…æ—¶**ï¼šå°±åƒç”µè¯æ¥é€šåç­‰å¾…å¯¹æ–¹å›è¯çš„æ—¶é—´

### 6.3 åˆ†å±‚è¶…æ—¶ç­–ç•¥


```java
@Service
public class OrderService {
    
    public OrderResult createOrder(OrderRequest request) {
        // è®¾ç½®ä¸åŒæ“ä½œçš„è¶…æ—¶æ—¶é—´
        
        try {
            // 1. éªŒè¯ç”¨æˆ· (å¿«é€Ÿæ“ä½œï¼ŒçŸ­è¶…æ—¶)
            CompletableFuture<Boolean> userValidation = CompletableFuture
                .supplyAsync(() -> userService.validateUser(request.getUserId()))
                .orTimeout(1, TimeUnit.SECONDS);  // 1ç§’è¶…æ—¶
            
            // 2. æ£€æŸ¥åº“å­˜ (ä¸­ç­‰æ“ä½œï¼Œä¸­ç­‰è¶…æ—¶)
            CompletableFuture<Boolean> inventoryCheck = CompletableFuture
                .supplyAsync(() -> inventoryService.checkStock(request.getProductId()))
                .orTimeout(3, TimeUnit.SECONDS);  // 3ç§’è¶…æ—¶
                
            // 3. å¤„ç†æ”¯ä»˜ (å¤æ‚æ“ä½œï¼Œé•¿è¶…æ—¶)
            CompletableFuture<String> payment = CompletableFuture
                .supplyAsync(() -> paymentService.processPayment(request))
                .orTimeout(10, TimeUnit.SECONDS); // 10ç§’è¶…æ—¶
            
            // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
            CompletableFuture.allOf(userValidation, inventoryCheck, payment)
                .get(15, TimeUnit.SECONDS);  // æ€»ä½“è¶…æ—¶15ç§’
                
            return new OrderResult("è®¢å•åˆ›å»ºæˆåŠŸ");
            
        } catch (TimeoutException e) {
            log.error("è®¢å•åˆ›å»ºè¶…æ—¶: {}", e.getMessage());
            return new OrderResult("è®¢å•åˆ›å»ºè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

### 6.4 è¶…æ—¶é…ç½®æœ€ä½³å®è·µ


```yaml
# application.yml è¶…æ—¶é…ç½®ç¤ºä¾‹
feign:
  client:
    config:
      default:
        connect-timeout: 3000      # é»˜è®¤è¿æ¥è¶…æ—¶
        read-timeout: 5000         # é»˜è®¤è¯»å–è¶…æ—¶
      user-service:               # ç‰¹å®šæœåŠ¡é…ç½®
        connect-timeout: 2000      # ç”¨æˆ·æœåŠ¡è¿æ¥è¶…æ—¶
        read-timeout: 3000         # ç”¨æˆ·æœåŠ¡è¯»å–è¶…æ—¶
      payment-service:
        connect-timeout: 5000      # æ”¯ä»˜æœåŠ¡è¿æ¥è¶…æ—¶  
        read-timeout: 15000        # æ”¯ä»˜æœåŠ¡è¯»å–è¶…æ—¶

hystrix:
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 10000  # Hystrixé»˜è®¤è¶…æ—¶
```

---

## 7. ğŸ”„ é‡è¯•ç­–ç•¥


### 7.1 ä»€ä¹ˆæ˜¯é‡è¯•ç­–ç•¥


**ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒæ‰“ç”µè¯æ²¡æ¥é€šæ—¶ï¼Œè¿‡ä¸€ä¼šå„¿å†æ‹¨ä¸€æ¬¡

```
é‡è¯•ç­–ç•¥ç¤ºä¾‹ï¼š
ç¬¬1æ¬¡è°ƒç”¨ â†’ å¤±è´¥ â†’ ç­‰å¾…1ç§’ â†’ ç¬¬2æ¬¡è°ƒç”¨ â†’ å¤±è´¥ â†’ ç­‰å¾…2ç§’ â†’ ç¬¬3æ¬¡è°ƒç”¨ â†’ æˆåŠŸ
```

### 7.2 é‡è¯•çš„ç±»å‹


**ğŸ”¸ ç«‹å³é‡è¯•**
```java
@Service
public class SimpleRetryService {
    
    private static final int MAX_RETRIES = 3;
    
    public String callExternalService(String data) {
        int attempts = 0;
        
        while (attempts < MAX_RETRIES) {
            try {
                return externalService.process(data);
            } catch (Exception e) {
                attempts++;
                if (attempts >= MAX_RETRIES) {
                    throw new RuntimeException("é‡è¯•" + MAX_RETRIES + "æ¬¡åä»ç„¶å¤±è´¥", e);
                }
                log.warn("ç¬¬{}æ¬¡è°ƒç”¨å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: {}", attempts, e.getMessage());
            }
        }
        return null;
    }
}
```

**ğŸ”¸ å»¶è¿Ÿé‡è¯•ï¼ˆé€€é¿ç­–ç•¥ï¼‰**
```java
@Service
public class BackoffRetryService {
    
    public String callWithBackoff(String data) {
        int attempts = 0;
        long delay = 1000; // åˆå§‹å»¶è¿Ÿ1ç§’
        
        while (attempts < 3) {
            try {
                return externalService.process(data);
            } catch (Exception e) {
                attempts++;
                if (attempts >= 3) {
                    throw new RuntimeException("é‡è¯•å¤±è´¥", e);
                }
                
                try {
                    Thread.sleep(delay);
                    delay *= 2; // æŒ‡æ•°é€€é¿ï¼š1ç§’ â†’ 2ç§’ â†’ 4ç§’
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException("é‡è¯•è¢«ä¸­æ–­", ie);
                }
            }
        }
        return null;
    }
}
```

### 7.3 ä½¿ç”¨Spring Retry


```java
@Service
@EnableRetry  // å¯ç”¨é‡è¯•åŠŸèƒ½
public class SpringRetryService {
    
    @Retryable(
        value = {Exception.class},           // å“ªäº›å¼‚å¸¸è§¦å‘é‡è¯•
        maxAttempts = 3,                     // æœ€å¤§é‡è¯•æ¬¡æ•°
        backoff = @Backoff(
            delay = 1000,                    // åˆå§‹å»¶è¿Ÿ1ç§’
            multiplier = 2,                  // å»¶è¿Ÿå€æ•°
            maxDelay = 10000                 // æœ€å¤§å»¶è¿Ÿ10ç§’
        )
    )
    public String processWithRetry(String data) {
        log.info("æ­£åœ¨å¤„ç†æ•°æ®: {}", data);
        
        // æ¨¡æ‹Ÿå¯èƒ½å¤±è´¥çš„æ“ä½œ
        if (Math.random() > 0.7) {
            throw new RuntimeException("å¤„ç†å¤±è´¥ï¼Œéœ€è¦é‡è¯•");
        }
        
        return "å¤„ç†æˆåŠŸ: " + data;
    }
    
    @Recover  // é‡è¯•å¤±è´¥åçš„å…œåº•æ–¹æ³•
    public String recover(Exception ex, String data) {
        log.error("é‡è¯•æœ€ç»ˆå¤±è´¥ï¼Œæ‰§è¡Œå…œåº•é€»è¾‘: {}", ex.getMessage());
        return "å¤„ç†å¤±è´¥ï¼Œè¿”å›é»˜è®¤ç»“æœ: " + data;
    }
}
```

### 7.4 é‡è¯•ç­–ç•¥çš„æ³¨æ„äº‹é¡¹


**âš ï¸ é¿å…é‡è¯•é£æš´**
```java
@Component
public class SafeRetryService {
    
    // ä½¿ç”¨æ–­è·¯å™¨é…åˆé‡è¯•
    @CircuitBreaker(name = "external-service")
    @Retryable(
        value = {Exception.class},
        maxAttempts = 2,  // é™ä½é‡è¯•æ¬¡æ•°
        backoff = @Backoff(delay = 2000)
    )
    public String safeCall(String data) {
        return externalService.process(data);
    }
    
    // åªå¯¹ç‰¹å®šé”™è¯¯é‡è¯•
    @Retryable(
        value = {ConnectException.class, SocketTimeoutException.class},
        notValue = {IllegalArgumentException.class}  // å‚æ•°é”™è¯¯ä¸é‡è¯•
    )
    public String smartRetry(String data) {
        return externalService.process(data);
    }
}
```

---

## 8. ğŸ” å¹‚ç­‰æ€§è®¾è®¡


### 8.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**é€šä¿—è§£é‡Š**ï¼šæ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½æ˜¯ä¸€æ ·çš„

```
å¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š
æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šæŸ¥1æ¬¡å’ŒæŸ¥100æ¬¡ï¼Œç»“æœä¸€æ ·
åˆ é™¤ç”¨æˆ·ï¼šåˆ 1æ¬¡å’Œåˆ 100æ¬¡ï¼Œç”¨æˆ·éƒ½ä¸å­˜åœ¨äº†

éå¹‚ç­‰æ“ä½œç¤ºä¾‹ï¼š
æ‰£å‡ä½™é¢ï¼šæ¯æ‰§è¡Œä¸€æ¬¡å°±æ‰£ä¸€æ¬¡é’±
å‘é€çŸ­ä¿¡ï¼šæ¯æ‰§è¡Œä¸€æ¬¡å°±å‘ä¸€æ¡çŸ­ä¿¡
```

### 8.2 ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§


**åœºæ™¯é—®é¢˜**ï¼š
```
ç”¨æˆ·æ”¯ä»˜åœºæ™¯ï¼š
ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜ â†’ ç½‘ç»œè¶…æ—¶ â†’ ç”¨æˆ·å†æ¬¡ç‚¹å‡» â†’ é‡å¤æ‰£æ¬¾

è§£å†³åï¼š
ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜ â†’ ç½‘ç»œè¶…æ—¶ â†’ ç”¨æˆ·å†æ¬¡ç‚¹å‡» â†’ ç³»ç»Ÿè¯†åˆ«é‡å¤ï¼Œä¸é‡å¤æ‰£æ¬¾
```

### 8.3 å¹‚ç­‰æ€§å®ç°æ–¹æ¡ˆ


**ğŸ”¸ å”¯ä¸€æ ‡è¯†ç¬¦æ–¹æ¡ˆ**
```java
@Service
public class PaymentService {
    
    @Autowired
    private RedisTemplate<String, String> redis;
    
    public PaymentResult processPayment(PaymentRequest request) {
        String idempotentKey = request.getIdempotentKey();
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        String existingResult = redis.opsForValue().get("payment:" + idempotentKey);
        if (existingResult != null) {
            log.info("æ£€æµ‹åˆ°é‡å¤æ”¯ä»˜è¯·æ±‚ï¼Œè¿”å›å·²æœ‰ç»“æœ: {}", idempotentKey);
            return JSON.parseObject(existingResult, PaymentResult.class);
        }
        
        // å¤„ç†æ”¯ä»˜
        PaymentResult result = doPayment(request);
        
        // ä¿å­˜ç»“æœï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
        redis.opsForValue().set(
            "payment:" + idempotentKey, 
            JSON.toJSONString(result),
            Duration.ofHours(24)  // 24å°æ—¶è¿‡æœŸ
        );
        
        return result;
    }
    
    private PaymentResult doPayment(PaymentRequest request) {
        // å®é™…çš„æ”¯ä»˜å¤„ç†é€»è¾‘
        return new PaymentResult("æ”¯ä»˜æˆåŠŸ", request.getAmount());
    }
}
```

**ğŸ”¸ æ•°æ®åº“å”¯ä¸€çº¦æŸæ–¹æ¡ˆ**
```java
@Entity
@Table(name = "orders")
public class Order {
    
    @Id
    private String id;
    
    @Column(unique = true)  // å”¯ä¸€çº¦æŸ
    private String clientOrderId;  // å®¢æˆ·ç«¯è®¢å•ID
    
    private BigDecimal amount;
    private String status;
    
    // getters and setters
}

@Service
public class OrderService {
    
    public OrderResult createOrder(OrderRequest request) {
        try {
            Order order = new Order();
            order.setClientOrderId(request.getClientOrderId());
            order.setAmount(request.getAmount());
            order.setStatus("CREATED");
            
            orderRepository.save(order);
            return new OrderResult("è®¢å•åˆ›å»ºæˆåŠŸ", order.getId());
            
        } catch (DataIntegrityViolationException e) {
            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜è®¢å•å·²å­˜åœ¨
            Order existingOrder = orderRepository
                .findByClientOrderId(request.getClientOrderId());
            return new OrderResult("è®¢å•å·²å­˜åœ¨", existingOrder.getId());
        }
    }
}
```

### 8.4 åˆ†å¸ƒå¼å¹‚ç­‰æ€§


**ğŸ”¸ åŸºäºåˆ†å¸ƒå¼é”çš„å¹‚ç­‰æ€§**
```java
@Service
public class DistributedIdempotentService {
    
    @Autowired
    private RedissonClient redisson;
    
    public String processRequest(String requestId, String data) {
        String lockKey = "idempotent_lock:" + requestId;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…3ç§’ï¼Œé”æŒæœ‰æœ€é•¿10ç§’
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                
                // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
                String resultKey = "idempotent_result:" + requestId;
                String existingResult = redisson.getBucket(resultKey).get();
                
                if (existingResult != null) {
                    return existingResult;
                }
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                String result = processBusinessLogic(data);
                
                // ä¿å­˜ç»“æœ
                redisson.getBucket(resultKey).set(result, Duration.ofHours(1));
                
                return result;
            } else {
                throw new RuntimeException("è·å–é”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("æ“ä½œè¢«ä¸­æ–­", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    private String processBusinessLogic(String data) {
        // å®é™…çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
        return "å¤„ç†ç»“æœ: " + data;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹é”™è®¾è®¡ï¼šç³»ç»Ÿåœ¨æ•…éšœæ—¶ä¾ç„¶èƒ½æä¾›åŸºæœ¬æœåŠ¡
ğŸ”¸ æ•…éšœéš”ç¦»ï¼šé˜²æ­¢å•ä¸ªç»„ä»¶æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ
ğŸ”¸ ç†”æ–­å™¨ï¼šè‡ªåŠ¨æ£€æµ‹æ•…éšœå¹¶ä¸´æ—¶é˜»æ–­è¯·æ±‚ï¼Œä¿æŠ¤ç³»ç»Ÿ
ğŸ”¸ é™æµç­–ç•¥ï¼šæ§åˆ¶è¯·æ±‚æµé‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
ğŸ”¸ é™çº§å¤„ç†ï¼šåœ¨å¼‚å¸¸æƒ…å†µä¸‹æä¾›ç®€åŒ–ä½†å¯ç”¨çš„æœåŠ¡
ğŸ”¸ è¶…æ—¶è®¾ç½®ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…ï¼Œå¿«é€Ÿå¤±è´¥
ğŸ”¸ é‡è¯•ç­–ç•¥ï¼šè‡ªåŠ¨é‡è¯•ç¬æ—¶æ•…éšœï¼Œæé«˜æˆåŠŸç‡
ğŸ”¸ å¹‚ç­‰æ€§ï¼šç¡®ä¿é‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¾è®¡æ€ç»´è½¬æ¢**
```
ä¼ ç»Ÿæ€ç»´ï¼šå‡è®¾ä¸€åˆ‡éƒ½ä¼šæ­£å¸¸å·¥ä½œ
å¾®æœåŠ¡æ€ç»´ï¼šå‡è®¾æ•…éšœä¸€å®šä¼šå‘ç”Ÿï¼Œæå‰å‡†å¤‡åº”å¯¹æ–¹æ¡ˆ

æ ¸å¿ƒåŸåˆ™ï¼š
- å¿«é€Ÿå¤±è´¥ > æ…¢æ…¢ç­‰å¾…
- éƒ¨åˆ†å¯ç”¨ > å®Œå…¨ä¸å¯ç”¨  
- è‡ªåŠ¨æ¢å¤ > äººå·¥å¹²é¢„
```

**ğŸ”¹ ç­–ç•¥ç»„åˆä½¿ç”¨**
```
å®é™…åº”ç”¨ä¸­ï¼Œè¿™äº›ç­–ç•¥é€šå¸¸ç»„åˆä½¿ç”¨ï¼š

è¯·æ±‚ â†’ é™æµæ£€æŸ¥ â†’ ç†”æ–­å™¨æ£€æŸ¥ â†’ è¶…æ—¶æ§åˆ¶ â†’ é‡è¯•æœºåˆ¶ â†’ é™çº§å¤„ç†
 â†“        â†“          â†“           â†“         â†“         â†“
é€šè¿‡     é€šè¿‡       é€šè¿‡        å¤±è´¥      é‡è¯•      è¿”å›é»˜è®¤å€¼
```

### 9.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ é€‰æ‹©åˆé€‚çš„ç­–ç•¥**
- **é«˜é¢‘ç®€å•æ“ä½œ**ï¼šé‡ç‚¹å…³æ³¨é™æµå’Œè¶…æ—¶
- **é‡è¦ä¸šåŠ¡æ“ä½œ**ï¼šé‡ç‚¹å…³æ³¨å¹‚ç­‰æ€§å’Œé‡è¯•
- **å¤–éƒ¨æœåŠ¡è°ƒç”¨**ï¼šé‡ç‚¹å…³æ³¨ç†”æ–­å™¨å’Œé™çº§
- **èµ„æºå¯†é›†æ“ä½œ**ï¼šé‡ç‚¹å…³æ³¨éš”ç¦»å’Œé™æµ

**âš ï¸ é¿å…è¿‡åº¦è®¾è®¡**
- ä¸æ˜¯æ‰€æœ‰æ“ä½œéƒ½éœ€è¦é‡è¯•
- ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦é™çº§
- æ ¹æ®ä¸šåŠ¡é‡è¦æ€§å’Œæ•…éšœå½±å“èŒƒå›´æ¥å†³å®š

**ğŸ“Š ç›‘æ§å’Œè°ƒä¼˜**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- é”™è¯¯ç‡ï¼šå„æœåŠ¡çš„å¤±è´¥ç‡
- å“åº”æ—¶é—´ï¼šè¯·æ±‚å¤„ç†æ—¶é—´åˆ†å¸ƒ
- é™æµæ¬¡æ•°ï¼šè¢«é™æµçš„è¯·æ±‚ç»Ÿè®¡
- ç†”æ–­çŠ¶æ€ï¼šç†”æ–­å™¨å¼€å¯/å…³é—­çŠ¶æ€
- é‡è¯•æ¬¡æ•°ï¼šé‡è¯•æ“ä½œçš„é¢‘ç‡
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®¹é”™è®¾è®¡ä¿ç¨³å®šï¼Œæ•…éšœéš”ç¦»é˜²æ‰©æ•£
- ç†”æ–­é™æµæ§æµé‡ï¼Œé™çº§è¶…æ—¶å¿«å“åº”
- é‡è¯•å¹‚ç­‰ä¿æ­£ç¡®ï¼Œç›‘æ§è°ƒä¼˜ä¸å¯å°‘