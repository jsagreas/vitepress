---
title: 5ã€ä¼˜é›…åœæœºæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ä¼˜é›…åœæœºæ¦‚å¿µç†è§£](#1-ä¼˜é›…åœæœºæ¦‚å¿µç†è§£)
2. [åº”ç”¨ä¼˜é›…å…³é—­å®ç°](#2-åº”ç”¨ä¼˜é›…å…³é—­å®ç°)
3. [è¿æ¥æ± ä¼˜é›…å…³é—­](#3-è¿æ¥æ± ä¼˜é›…å…³é—­)
4. [æœåŠ¡æ³¨å†Œæ³¨é”€æœºåˆ¶](#4-æœåŠ¡æ³¨å†Œæ³¨é”€æœºåˆ¶)
5. [è¯·æ±‚å¤„ç†å®Œæˆç­‰å¾…](#5-è¯·æ±‚å¤„ç†å®Œæˆç­‰å¾…)
6. [Hooké’©å­å‡½æ•°åº”ç”¨](#6-Hooké’©å­å‡½æ•°åº”ç”¨)
7. [å¥åº·æ£€æŸ¥é…åˆæœºåˆ¶](#7-å¥åº·æ£€æŸ¥é…åˆæœºåˆ¶)
8. [è´Ÿè½½å‡è¡¡æ‘˜é™¤ç­–ç•¥](#8-è´Ÿè½½å‡è¡¡æ‘˜é™¤ç­–ç•¥)
9. [åœæœºè„šæœ¬ç¼–å†™å®è·µ](#9-åœæœºè„šæœ¬ç¼–å†™å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä¼˜é›…åœæœºæ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯ä¼˜é›…åœæœº


**ğŸ”¸ ç”Ÿæ´»ä¸­çš„ç±»æ¯”**
ä¼˜é›…åœæœºå°±åƒæ˜¯é¤å…æ‰“çƒŠæ—¶çš„æµç¨‹ï¼š
- **ç²—æš´å…³é—­**ï¼šç›´æ¥æŠŠå®¢äººèµ¶èµ°ï¼Œæ–­ç”µå…³é—¨
- **ä¼˜é›…åœæœº**ï¼šä¸å†æ¥å¾…æ–°å®¢äººï¼Œè®©æ­£åœ¨ç”¨é¤çš„å®¢äººåƒå®Œï¼Œæ”¶æ‹¾å¥½æ¡Œå­å†å…³é—¨

```
ä¼ ç»Ÿåœæœºæ–¹å¼ï¼š               ä¼˜é›…åœæœºæ–¹å¼ï¼š
åº”ç”¨ç¨‹åº â”€â”€[å¼ºåˆ¶ç»ˆæ­¢]â”€â”€â–¶ åœæ­¢   åº”ç”¨ç¨‹åº â”€â”€[é€šçŸ¥å‡†å¤‡]â”€â”€â–¶ ç­‰å¾…å¤„ç†å®Œæ¯• â”€â”€â–¶ åœæ­¢
    â†“                              â†“                    â†“
æ•°æ®ä¸¢å¤±                        ä¿æŠ¤æ•°æ®               å®‰å…¨åœæ­¢
è¿æ¥æ–­å¼€                        å®Œæˆå¤„ç†               ç”¨æˆ·æ— æ„ŸçŸ¥
ç”¨æˆ·æ„ŸçŸ¥                        ä¼˜é›…å¤„ç†               æœåŠ¡ç¨³å®š
```

**ğŸ”¸ æ ¸å¿ƒç†å¿µ**
- **ç”¨æˆ·å‹å¥½**ï¼šè®©ç”¨æˆ·æ— æ„ŸçŸ¥åœ°å®Œæˆæ­£åœ¨è¿›è¡Œçš„æ“ä½œ
- **æ•°æ®å®‰å…¨**ï¼šç¡®ä¿æ‰€æœ‰å¤„ç†ä¸­çš„æ•°æ®éƒ½èƒ½æ­£ç¡®ä¿å­˜
- **èµ„æºé‡Šæ”¾**ï¼šæœ‰åºé‡Šæ”¾ç³»ç»Ÿèµ„æºï¼Œé¿å…èµ„æºæ³„æ¼
- **æœåŠ¡è¿ç»­**ï¼šé…åˆè´Ÿè½½å‡è¡¡ï¼Œç¡®ä¿æ•´ä½“æœåŠ¡ä¸ä¸­æ–­

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜é›…åœæœº


**ğŸš¨ ä¸ä¼˜é›…åœæœºçš„é—®é¢˜**
```
åœºæ™¯1ï¼šç”¨æˆ·æ­£åœ¨æäº¤è®¢å•
[ç”¨æˆ·] â”€â”€æäº¤è®¢å•â”€â”€â–¶ [æœåŠ¡å™¨] â”€â”€çªç„¶å…³é—­â”€â”€â–¶ âŒ è®¢å•ä¸¢å¤±

åœºæ™¯2ï¼šæ•°æ®åº“æ­£åœ¨å†™å…¥æ•°æ®  
[åº”ç”¨] â”€â”€å†™å…¥æ•°æ®â”€â”€â–¶ [æ•°æ®åº“] â”€â”€è¿æ¥æ–­å¼€â”€â”€â–¶ âŒ æ•°æ®ä¸å®Œæ•´

åœºæ™¯3ï¼šæ¶ˆæ¯é˜Ÿåˆ—æ­£åœ¨å¤„ç†
[é˜Ÿåˆ—] â”€â”€å¤„ç†æ¶ˆæ¯â”€â”€â–¶ [æœåŠ¡] â”€â”€å¼ºåˆ¶åœæ­¢â”€â”€â–¶ âŒ æ¶ˆæ¯ä¸¢å¤±
```

**âœ… ä¼˜é›…åœæœºçš„å¥½å¤„**
- **é›¶æ•°æ®ä¸¢å¤±**ï¼šæ‰€æœ‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚éƒ½èƒ½å®Œæˆ
- **ç”¨æˆ·æ— æ„ŸçŸ¥**ï¼šç”¨æˆ·æ“ä½œä¸ä¼šè¢«ä¸­æ–­
- **ç³»ç»Ÿç¨³å®š**ï¼šé¿å…å› çªç„¶åœæœºå¯¼è‡´çš„ç³»ç»Ÿå¼‚å¸¸
- **è¿ç»´å‹å¥½**ï¼šå¯æ§çš„åœæœºè¿‡ç¨‹ï¼Œä¾¿äºç›‘æ§å’Œç®¡ç†

### 1.3 ä¼˜é›…åœæœºçš„æ ¸å¿ƒæ­¥éª¤


```
æ­¥éª¤1ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚
   â†“
æ­¥éª¤2ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
   â†“  
æ­¥éª¤3ï¼šé‡Šæ”¾ç³»ç»Ÿèµ„æº
   â†“
æ­¥éª¤4ï¼šæ³¨é”€æœåŠ¡æ³¨å†Œ
   â†“
æ­¥éª¤5ï¼šåº”ç”¨å½»åº•åœæ­¢
```

**â±ï¸ é¢„è®¡å­¦ä¹ æ—¶é—´**: 25åˆ†é’Ÿ  
**ğŸ“– å‰ç½®çŸ¥è¯†**: Spring BootåŸºç¡€ã€å¾®æœåŠ¡æ¦‚å¿µ
**ğŸ¯ å­¦ä¹ ç›®æ ‡**: æŒæ¡å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„ä¼˜é›…åœæœºå®ç°æ–¹æ¡ˆ

---

## 2. ğŸ› ï¸ åº”ç”¨ä¼˜é›…å…³é—­å®ç°


### 2.1 Spring Bootå†…ç½®ä¼˜é›…åœæœº


Spring Boot 2.3ç‰ˆæœ¬å¼€å§‹æä¾›äº†å†…ç½®çš„ä¼˜é›…åœæœºæ”¯æŒï¼Œä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼š

```yaml
# application.yml
server:
  shutdown: graceful  # å¯ç”¨ä¼˜é›…åœæœº

spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s  # æ¯ä¸ªåœæœºé˜¶æ®µçš„è¶…æ—¶æ—¶é—´
```

**ğŸ”¸ å·¥ä½œåŸç†è§£é‡Š**
å½“æ”¶åˆ°åœæœºä¿¡å·æ—¶ï¼ŒSpring Bootä¼šï¼š
1. **åœæ­¢æ¥æ”¶æ–°è¯·æ±‚** - WebæœåŠ¡å™¨ä¸å†æ¥å—æ–°çš„HTTPè¯·æ±‚
2. **ç­‰å¾…ç°æœ‰è¯·æ±‚** - ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆ
3. **è¶…æ—¶ä¿æŠ¤** - å¦‚æœè¶…è¿‡è®¾å®šæ—¶é—´ï¼Œå¼ºåˆ¶åœæ­¢

### 2.2 æ‰‹åŠ¨å®ç°ä¼˜é›…åœæœºæ§åˆ¶


```java
@RestController
@SpringBootApplication
public class GracefulShutdownDemo {
    
    // åº”ç”¨çŠ¶æ€æ ‡è®°
    private volatile boolean isShuttingDown = false;
    
    // æ­£åœ¨å¤„ç†çš„è¯·æ±‚è®¡æ•°å™¨
    private final AtomicInteger activeRequests = new AtomicInteger(0);
    
    /**
     * ğŸ¯ ä¸šåŠ¡æ¥å£ - æ¨¡æ‹Ÿå¤„ç†è¯·æ±‚
     */
    @GetMapping("/api/process")
    public ResponseEntity<String> processRequest() {
        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åœæœº
        if (isShuttingDown) {
            return ResponseEntity.status(503)
                .body("æœåŠ¡æ­£åœ¨åœæœºä¸­ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // å¢åŠ æ´»è·ƒè¯·æ±‚è®¡æ•°
        activeRequests.incrementAndGet();
        
        try {
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            Thread.sleep(2000);
            return ResponseEntity.ok("è¯·æ±‚å¤„ç†å®Œæˆ");
        } catch (Exception e) {
            return ResponseEntity.status(500).body("å¤„ç†å¼‚å¸¸");
        } finally {
            // å‡å°‘æ´»è·ƒè¯·æ±‚è®¡æ•°
            activeRequests.decrementAndGet();
        }
    }
    
    /**
     * ğŸ›‘ è§¦å‘ä¼˜é›…åœæœº
     */
    @PostMapping("/admin/shutdown")
    public String initiateGracefulShutdown() {
        isShuttingDown = true;
        
        // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
        while (activeRequests.get() > 0) {
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        
        // æ‰§è¡Œåº”ç”¨å…³é—­
        System.exit(0);
        return "ä¼˜é›…åœæœºå®Œæˆ";
    }
}
```

### 2.3 ä½¿ç”¨ApplicationListenerç›‘å¬åœæœºäº‹ä»¶


```java
@Component
public class GracefulShutdownListener {
    
    private static final Logger logger = LoggerFactory.getLogger(GracefulShutdownListener.class);
    
    /**
     * ğŸ“¡ ç›‘å¬åº”ç”¨å…³é—­äº‹ä»¶
     */
    @EventListener
    public void handleContextClose(ContextClosedEvent event) {
        logger.info("ğŸ›‘ æ”¶åˆ°åº”ç”¨å…³é—­ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…åœæœº...");
        
        // æ‰§è¡Œæ¸…ç†å·¥ä½œ
        cleanupResources();
        
        logger.info("âœ… ä¼˜é›…åœæœºå®Œæˆ");
    }
    
    private void cleanupResources() {
        // æ¸…ç†ç¼“å­˜
        // å…³é—­è¿æ¥æ± 
        // ä¿å­˜ä¸´æ—¶æ•°æ®
    }
}
```

**ğŸ§  è®°å¿†è¦ç‚¹**: 
- `server.shutdown=graceful` å¼€å¯å†…ç½®ä¼˜é›…åœæœº
- ç”¨è®¡æ•°å™¨è·Ÿè¸ªæ´»è·ƒè¯·æ±‚æ•°é‡
- ç›‘å¬ `ContextClosedEvent` æ‰§è¡Œæ¸…ç†å·¥ä½œ

---

## 3. ğŸ’¾ è¿æ¥æ± ä¼˜é›…å…³é—­


### 3.1 æ•°æ®åº“è¿æ¥æ± ä¼˜é›…å…³é—­


è¿æ¥æ± å°±åƒæ˜¯åœè½¦åœºï¼Œä¼˜é›…å…³é—­å°±æ˜¯è®©æ‰€æœ‰æ­£åœ¨ä½¿ç”¨è½¦ä½çš„è½¦ä¸»å…ˆå¼€èµ°è½¦ï¼Œç„¶åå†å…³é—­åœè½¦åœºã€‚

```java
@Configuration
public class DatabaseConfig {
    
    /**
     * ğŸŠâ€â™‚ï¸ é…ç½®HikariCPè¿æ¥æ± 
     */
    @Bean
    @ConfigurationProperties("spring.datasource.hikari")
    public HikariDataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // è¿æ¥æ± åŸºæœ¬é…ç½®
        config.setMaximumPoolSize(20);           // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);                // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);      // è¿æ¥è¶…æ—¶æ—¶é—´
        
        // ä¼˜é›…å…³é—­ç›¸å…³é…ç½®
        config.setLeakDetectionThreshold(60000); // è¿æ¥æ³„æ¼æ£€æµ‹
        config.setMaxLifetime(1800000);          // è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
        
        return new HikariDataSource(config);
    }
    
    /**
     * ğŸ›‘ åº”ç”¨å…³é—­æ—¶ä¼˜é›…å…³é—­è¿æ¥æ± 
     */
    @PreDestroy
    public void closeDataSource() {
        HikariDataSource dataSource = (HikariDataSource) this.dataSource();
        if (dataSource != null && !dataSource.isClosed()) {
            logger.info("ğŸ”Œ å¼€å§‹å…³é—­æ•°æ®åº“è¿æ¥æ± ...");
            dataSource.close();  // ç­‰å¾…æ‰€æœ‰è¿æ¥å½’è¿˜åå…³é—­
            logger.info("âœ… æ•°æ®åº“è¿æ¥æ± å·²ä¼˜é›…å…³é—­");
        }
    }
}
```

### 3.2 Redisè¿æ¥æ± ä¼˜é›…å…³é—­


```java
@Configuration
public class RedisConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // Redisè¿æ¥æ± é…ç½®
        GenericObjectPoolConfig<StatefulRedisConnection<String, String>> poolConfig = 
            new GenericObjectPoolConfig<>();
        poolConfig.setMaxTotal(20);
        poolConfig.setMaxIdle(10);
        poolConfig.setMinIdle(2);
        
        // åˆ›å»ºè¿æ¥å·¥å‚
        LettuceConnectionFactory factory = new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("localhost", 6379));
        
        return factory;
    }
    
    /**
     * ğŸ”Œ Redisè¿æ¥ä¼˜é›…å…³é—­
     */
    @PreDestroy
    public void closeRedisConnection() {
        LettuceConnectionFactory factory = redisConnectionFactory();
        if (factory != null) {
            logger.info("ğŸ“¡ å¼€å§‹å…³é—­Redisè¿æ¥...");
            factory.destroy();  // ä¼˜é›…å…³é—­æ‰€æœ‰Redisè¿æ¥
            logger.info("âœ… Redisè¿æ¥å·²ä¼˜é›…å…³é—­");
        }
    }
}
```

### 3.3 HTTPå®¢æˆ·ç«¯è¿æ¥æ± å…³é—­


```java
@Component
public class HttpClientManager {
    
    private final RestTemplate restTemplate;
    private final CloseableHttpClient httpClient;
    
    public HttpClientManager() {
        // é…ç½®HTTPè¿æ¥æ± 
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(200);        // æ€»è¿æ¥æ•°
        connectionManager.setDefaultMaxPerRoute(20); // æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°
        
        this.httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .build();
            
        this.restTemplate = new RestTemplate(
            new HttpComponentsClientHttpRequestFactory(httpClient));
    }
    
    /**
     * ğŸŒ ä¼˜é›…å…³é—­HTTPå®¢æˆ·ç«¯
     */
    @PreDestroy
    public void closeHttpClient() {
        try {
            logger.info("ğŸŒ å¼€å§‹å…³é—­HTTPå®¢æˆ·ç«¯è¿æ¥æ± ...");
            httpClient.close();  // ç­‰å¾…æ‰€æœ‰HTTPè¯·æ±‚å®Œæˆåå…³é—­
            logger.info("âœ… HTTPå®¢æˆ·ç«¯è¿æ¥æ± å·²ä¼˜é›…å…³é—­");
        } catch (IOException e) {
            logger.error("âŒ å…³é—­HTTPå®¢æˆ·ç«¯æ—¶å‘ç”Ÿå¼‚å¸¸", e);
        }
    }
}
```

**ğŸ’¡ æ ¸å¿ƒç†å¿µ**: è¿æ¥æ± ä¼˜é›…å…³é—­çš„æœ¬è´¨æ˜¯"ç­‰å¾…å½’è¿˜ï¼Œç„¶åå…³é—¨"ï¼Œç¡®ä¿æ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„è¿æ¥éƒ½èƒ½æ­£å¸¸é‡Šæ”¾ã€‚

---

## 4. ğŸ“‹ æœåŠ¡æ³¨å†Œæ³¨é”€æœºåˆ¶


### 4.1 EurekaæœåŠ¡æ³¨é”€


åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡åœæœºæ—¶å¿…é¡»ä»æ³¨å†Œä¸­å¿ƒæ³¨é”€ï¼Œå°±åƒå‘˜å·¥ç¦»èŒæ—¶è¦ä»å…¬å¸èŠ±åå†Œä¸Šåˆ é™¤ä¸€æ ·ã€‚

```java
@Component
public class EurekaServiceManager {
    
    @Autowired
    private EurekaClient eurekaClient;
    
    /**
     * ğŸ¢ åº”ç”¨å…³é—­æ—¶ä»Eurekaæ³¨é”€æœåŠ¡
     */
    @PreDestroy
    public void unregisterFromEureka() {
        logger.info("ğŸ“¤ å¼€å§‹ä»Eurekaæ³¨é”€æœåŠ¡...");
        
        try {
            // ä»EurekaæœåŠ¡å™¨æ³¨é”€å½“å‰å®ä¾‹
            eurekaClient.shutdown();
            logger.info("âœ… å·²æˆåŠŸä»Eurekaæ³¨é”€æœåŠ¡");
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿å…¶ä»–æœåŠ¡æ›´æ–°æœåŠ¡åˆ—è¡¨
            Thread.sleep(2000);
            
        } catch (Exception e) {
            logger.error("âŒ ä»Eurekaæ³¨é”€æœåŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸", e);
        }
    }
}
```

**ğŸ”¸ Eurekaæ³¨é”€é…ç½®**
```yaml
eureka:
  instance:
    lease-expiration-duration-in-seconds: 10  # æœåŠ¡å¤±æ•ˆæ—¶é—´
    lease-renewal-interval-in-seconds: 5      # å¿ƒè·³é—´éš”
  client:
    initial-instance-info-replication-interval-seconds: 10
    instance-info-replication-interval-seconds: 10
```

### 4.2 NacosæœåŠ¡æ³¨é”€


```java
@Component  
public class NacosServiceManager {
    
    @Autowired
    private NacosDiscoveryProperties nacosDiscoveryProperties;
    
    @Autowired
    private NamingService namingService;
    
    /**
     * ğŸŒŸ ä»Nacosæ³¨é”€æœåŠ¡å®ä¾‹
     */
    @PreDestroy
    public void unregisterFromNacos() {
        try {
            logger.info("ğŸŒŸ å¼€å§‹ä»Nacosæ³¨é”€æœåŠ¡...");
            
            String serviceName = nacosDiscoveryProperties.getService();
            String groupName = nacosDiscoveryProperties.getGroup();
            
            // æ³¨é”€æœåŠ¡å®ä¾‹
            namingService.deregisterInstance(serviceName, groupName, 
                nacosDiscoveryProperties.getIp(), 
                nacosDiscoveryProperties.getPort());
                
            logger.info("âœ… å·²æˆåŠŸä»Nacosæ³¨é”€æœåŠ¡");
            
        } catch (Exception e) {
            logger.error("âŒ ä»Nacosæ³¨é”€æœåŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸", e);
        }
    }
}
```

### 4.3 é€šç”¨æœåŠ¡æ³¨é”€æ¥å£


```java
/**
 * ğŸ”„ é€šç”¨æœåŠ¡æ³¨å†Œæ³¨é”€æ¥å£
 */
public interface ServiceRegistryManager {
    
    /**
     * æ³¨å†ŒæœåŠ¡åˆ°æ³¨å†Œä¸­å¿ƒ
     */
    void registerService();
    
    /**
     * ä»æ³¨å†Œä¸­å¿ƒæ³¨é”€æœåŠ¡
     */
    void unregisterService();
    
    /**
     * æ£€æŸ¥æœåŠ¡æ³¨å†ŒçŠ¶æ€
     */
    boolean isServiceRegistered();
}

@Service
public class ServiceRegistryManagerImpl implements ServiceRegistryManager {
    
    @Override
    public void unregisterService() {
        logger.info("ğŸ”„ å¼€å§‹æ‰§è¡ŒæœåŠ¡æ³¨é”€æµç¨‹...");
        
        // 1. æ ‡è®°æœåŠ¡ä¸ºä¸‹çº¿çŠ¶æ€
        markServiceAsDown();
        
        // 2. ç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ›´æ–°
        waitForLoadBalancerUpdate();
        
        // 3. ä»æ³¨å†Œä¸­å¿ƒæ³¨é”€
        performUnregistration();
        
        logger.info("âœ… æœåŠ¡æ³¨é”€æµç¨‹å®Œæˆ");
    }
    
    private void markServiceAsDown() {
        // å°†å¥åº·æ£€æŸ¥çŠ¶æ€è®¾ä¸ºDOWN
    }
    
    private void waitForLoadBalancerUpdate() {
        try {
            Thread.sleep(5000);  // ç­‰å¾…5ç§’è®©è´Ÿè½½å‡è¡¡å™¨æ›´æ–°
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private void performUnregistration() {
        // æ‰§è¡Œå…·ä½“çš„æ³¨é”€é€»è¾‘
    }
}
```

**ğŸ¯ å…³é”®æ—¶åº**ï¼š
```
1. æ ‡è®°æœåŠ¡ä¸‹çº¿çŠ¶æ€
   â†“
2. ç­‰å¾…è´Ÿè½½å‡è¡¡æ›´æ–°ï¼ˆé¿å…æ–°è¯·æ±‚è¿›å…¥ï¼‰
   â†“  
3. æ‰§è¡Œæ³¨å†Œä¸­å¿ƒæ³¨é”€
   â†“
4. ç¡®è®¤æ³¨é”€å®Œæˆ
```

---

## 5. â³ è¯·æ±‚å¤„ç†å®Œæˆç­‰å¾…


### 5.1 è¯·æ±‚è·Ÿè¸ªæœºåˆ¶


å°±åƒé¤å…è¦ç­‰æ‰€æœ‰å®¢äººç”¨é¤å®Œæ¯•æ‰èƒ½å…³é—¨ï¼Œåº”ç”¨ä¹Ÿè¦ç­‰æ‰€æœ‰è¯·æ±‚å¤„ç†å®Œæ‰èƒ½åœæœºã€‚

```java
@Component
public class RequestTracker {
    
    // ä½¿ç”¨åŸå­æ•´æ•°è·Ÿè¸ªæ´»è·ƒè¯·æ±‚æ•°
    private final AtomicInteger activeRequestCount = new AtomicInteger(0);
    
    // æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    private final long maxWaitTime = 30000;
    
    /**
     * ğŸ“Š è¯·æ±‚å¼€å§‹å¤„ç†
     */
    public void requestStarted() {
        int current = activeRequestCount.incrementAndGet();
        logger.debug("ğŸ“ˆ æ–°è¯·æ±‚å¼€å§‹ï¼Œå½“å‰æ´»è·ƒè¯·æ±‚æ•°: {}", current);
    }
    
    /**
     * ğŸ“‰ è¯·æ±‚å¤„ç†å®Œæˆ
     */
    public void requestCompleted() {
        int current = activeRequestCount.decrementAndGet();
        logger.debug("ğŸ“‰ è¯·æ±‚å®Œæˆï¼Œå‰©ä½™æ´»è·ƒè¯·æ±‚æ•°: {}", current);
    }
    
    /**
     * â³ ç­‰å¾…æ‰€æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
     */
    public boolean waitForRequestsToComplete() {
        logger.info("â³ ç­‰å¾… {} ä¸ªè¯·æ±‚å¤„ç†å®Œæˆ...", activeRequestCount.get());
        
        long startTime = System.currentTimeMillis();
        
        while (activeRequestCount.get() > 0) {
            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if (System.currentTimeMillis() - startTime > maxWaitTime) {
                logger.warn("âš ï¸ ç­‰å¾…è¯·æ±‚å®Œæˆè¶…æ—¶ï¼Œå¼ºåˆ¶åœæœºã€‚å‰©ä½™è¯·æ±‚æ•°: {}", 
                    activeRequestCount.get());
                return false;
            }
            
            try {
                Thread.sleep(100);  // æ¯100msæ£€æŸ¥ä¸€æ¬¡
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return false;
            }
        }
        
        logger.info("âœ… æ‰€æœ‰è¯·æ±‚å·²å¤„ç†å®Œæˆ");
        return true;
    }
    
    /**
     * ğŸ“Š è·å–å½“å‰æ´»è·ƒè¯·æ±‚æ•°
     */
    public int getActiveRequestCount() {
        return activeRequestCount.get();
    }
}
```

### 5.2 åŸºäºFilterçš„è¯·æ±‚æ‹¦æˆª


```java
@Component
@Order(1)  // ç¡®ä¿è¿™ä¸ªFilteræœ€å…ˆæ‰§è¡Œ
public class GracefulShutdownFilter implements Filter {
    
    @Autowired
    private RequestTracker requestTracker;
    
    // æ˜¯å¦æ­£åœ¨åœæœº
    private volatile boolean isShuttingDown = false;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        // å¦‚æœæ­£åœ¨åœæœºï¼Œæ‹’ç»æ–°è¯·æ±‚
        if (isShuttingDown) {
            HttpServletResponse httpResponse = (HttpServletResponse) response;
            httpResponse.setStatus(503);  // Service Unavailable
            httpResponse.getWriter().write("æœåŠ¡æ­£åœ¨ç»´æŠ¤ä¸­ï¼Œè¯·ç¨åé‡è¯•");
            return;
        }
        
        // è®°å½•è¯·æ±‚å¼€å§‹
        requestTracker.requestStarted();
        
        try {
            // ç»§ç»­å¤„ç†è¯·æ±‚
            chain.doFilter(request, response);
        } finally {
            // è®°å½•è¯·æ±‚å®Œæˆ
            requestTracker.requestCompleted();
        }
    }
    
    /**
     * ğŸ›‘ è®¾ç½®åœæœºçŠ¶æ€
     */
    public void setShuttingDown(boolean shuttingDown) {
        this.isShuttingDown = shuttingDown;
        logger.info("ğŸ”„ åœæœºçŠ¶æ€å·²è®¾ç½®ä¸º: {}", shuttingDown);
    }
}
```

### 5.3 åŸºäºçº¿ç¨‹æ± çš„ç­‰å¾…æœºåˆ¶


```java
@Component
public class ThreadPoolManager {
    
    @Autowired
    private TaskExecutor taskExecutor;
    
    /**
     * ğŸŠâ€â™‚ï¸ ä¼˜é›…å…³é—­çº¿ç¨‹æ± 
     */
    @PreDestroy
    public void shutdownThreadPool() {
        logger.info("ğŸŠâ€â™‚ï¸ å¼€å§‹å…³é—­çº¿ç¨‹æ± ...");
        
        if (taskExecutor instanceof ThreadPoolTaskExecutor) {
            ThreadPoolTaskExecutor executor = (ThreadPoolTaskExecutor) taskExecutor;
            
            // åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
            executor.shutdown();
            
            try {
                // ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆï¼Œæœ€å¤šç­‰å¾…30ç§’
                if (!executor.getThreadPoolExecutor().awaitTermination(30, TimeUnit.SECONDS)) {
                    logger.warn("âš ï¸ çº¿ç¨‹æ± åœ¨30ç§’å†…æœªèƒ½æ­£å¸¸å…³é—­ï¼Œæ‰§è¡Œå¼ºåˆ¶å…³é—­");
                    executor.getThreadPoolExecutor().shutdownNow();
                    
                    // å†æ¬¡ç­‰å¾…ä»»åŠ¡ç»ˆæ­¢
                    if (!executor.getThreadPoolExecutor().awaitTermination(10, TimeUnit.SECONDS)) {
                        logger.error("âŒ çº¿ç¨‹æ± æ— æ³•å®Œå…¨å…³é—­");
                    }
                }
                
                logger.info("âœ… çº¿ç¨‹æ± å·²ä¼˜é›…å…³é—­");
                
            } catch (InterruptedException e) {
                logger.error("âŒ ç­‰å¾…çº¿ç¨‹æ± å…³é—­æ—¶è¢«ä¸­æ–­", e);
                executor.getThreadPoolExecutor().shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
    }
}
```

**ğŸ¯ ç­‰å¾…ç­–ç•¥æ€»ç»“**ï¼š

| ç­‰å¾…ç±»å‹ | **å®ç°æ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **è¶…æ—¶å¤„ç†** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **HTTPè¯·æ±‚** | `è®¡æ•°å™¨+è½®è¯¢` | `WebæœåŠ¡` | `å¼ºåˆ¶åœæœº` |
| ğŸ”¸ **å¼‚æ­¥ä»»åŠ¡** | `çº¿ç¨‹æ± awaitTermination` | `åå°ä»»åŠ¡` | `shutdownNow` |
| ğŸ”¸ **æ¶ˆæ¯å¤„ç†** | `æ¶ˆè´¹è€…æš‚åœ+ç­‰å¾…` | `æ¶ˆæ¯é˜Ÿåˆ—` | `ä¸¢å¼ƒæœªå¤„ç†` |

---

## 6. ğŸª Hooké’©å­å‡½æ•°åº”ç”¨


### 6.1 JVMå…³é—­é’©å­


Hooké’©å­å‡½æ•°å°±åƒæ˜¯"ä¸´ç»ˆé—è¨€"ï¼Œåœ¨ç¨‹åºå³å°†ç»“æŸæ—¶æ‰§è¡Œæœ€åçš„æ¸…ç†å·¥ä½œã€‚

```java
@Component
public class JvmShutdownHook {
    
    private static final Logger logger = LoggerFactory.getLogger(JvmShutdownHook.class);
    
    @PostConstruct
    public void registerShutdownHook() {
        // æ³¨å†ŒJVMå…³é—­é’©å­
        Runtime.getRuntime().addShutdownHook(new Thread(this::performCleanup, "shutdown-hook"));
        logger.info("ğŸª JVMå…³é—­é’©å­å·²æ³¨å†Œ");
    }
    
    /**
     * ğŸ§¹ æ‰§è¡Œæ¸…ç†å·¥ä½œ
     */
    private void performCleanup() {
        logger.info("ğŸª JVMå…³é—­é’©å­è¢«è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œæ¸…ç†å·¥ä½œ...");
        
        try {
            // 1. ä¿å­˜ä¸´æ—¶æ•°æ®
            saveTemporaryData();
            
            // 2. å…³é—­å¤–éƒ¨è¿æ¥
            closeExternalConnections();
            
            // 3. æ¸…ç†ç¼“å­˜
            clearCache();
            
            // 4. è®°å½•å…³é—­æ—¥å¿—
            logShutdownEvent();
            
            logger.info("âœ… æ¸…ç†å·¥ä½œå®Œæˆ");
            
        } catch (Exception e) {
            logger.error("âŒ æ¸…ç†å·¥ä½œæ‰§è¡Œå¼‚å¸¸", e);
        }
    }
    
    private void saveTemporaryData() {
        // ä¿å­˜å†…å­˜ä¸­çš„ä¸´æ—¶æ•°æ®åˆ°æŒä¹…åŒ–å­˜å‚¨
        logger.info("ğŸ’¾ ä¿å­˜ä¸´æ—¶æ•°æ®...");
    }
    
    private void closeExternalConnections() {
        // å…³é—­åˆ°å¤–éƒ¨ç³»ç»Ÿçš„è¿æ¥
        logger.info("ğŸ”Œ å…³é—­å¤–éƒ¨è¿æ¥...");
    }
    
    private void clearCache() {
        // æ¸…ç†ç¼“å­˜æ•°æ®
        logger.info("ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜...");
    }
    
    private void logShutdownEvent() {
        logger.info("ğŸ“ è®°å½•åº”ç”¨å…³é—­äº‹ä»¶ï¼Œæ—¶é—´: {}", LocalDateTime.now());
    }
}
```

### 6.2 Springå®¹å™¨é”€æ¯é’©å­


```java
@Component
public class SpringDestroyHook {
    
    @Autowired
    private RequestTracker requestTracker;
    
    @Autowired
    private GracefulShutdownFilter shutdownFilter;
    
    /**
     * ğŸ  Springå®¹å™¨é”€æ¯æ—¶çš„é’©å­æ–¹æ³•
     */
    @PreDestroy
    public void onDestroy() {
        logger.info("ğŸ  Springå®¹å™¨å¼€å§‹é”€æ¯ï¼Œæ‰§è¡Œä¼˜é›…åœæœº...");
        
        // æ­¥éª¤1ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚
        shutdownFilter.setShuttingDown(true);
        logger.info("ğŸš« å·²åœæ­¢æ¥æ”¶æ–°è¯·æ±‚");
        
        // æ­¥éª¤2ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
        boolean completed = requestTracker.waitForRequestsToComplete();
        if (!completed) {
            logger.warn("âš ï¸ éƒ¨åˆ†è¯·æ±‚æœªèƒ½åœ¨è¶…æ—¶æ—¶é—´å†…å®Œæˆ");
        }
        
        // æ­¥éª¤3ï¼šæ‰§è¡Œè‡ªå®šä¹‰æ¸…ç†é€»è¾‘
        performCustomCleanup();
        
        logger.info("âœ… Springå®¹å™¨é”€æ¯é’©å­æ‰§è¡Œå®Œæˆ");
    }
    
    private void performCustomCleanup() {
        // æ‰§è¡Œä¸šåŠ¡ç›¸å…³çš„æ¸…ç†å·¥ä½œ
        logger.info("ğŸ§½ æ‰§è¡Œè‡ªå®šä¹‰æ¸…ç†é€»è¾‘...");
    }
}
```

### 6.3 å¤šä¸ªé’©å­çš„æ‰§è¡Œé¡ºåºç®¡ç†


```java
@Component
public class OrderedShutdownManager {
    
    /**
     * ğŸ¥‡ ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚
     */
    @PreDestroy
    @Order(1)
    public void stopAcceptingRequests() {
        logger.info("ğŸ¥‡ [ä¼˜å…ˆçº§1] åœæ­¢æ¥æ”¶æ–°è¯·æ±‚");
    }
    
    /**
     * ğŸ¥ˆ ç¬¬äºŒä¼˜å…ˆçº§ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ
     */
    @PreDestroy
    @Order(2)
    public void waitForActiveRequests() {
        logger.info("ğŸ¥ˆ [ä¼˜å…ˆçº§2] ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ");
    }
    
    /**
     * ğŸ¥‰ ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šé‡Šæ”¾èµ„æº
     */
    @PreDestroy
    @Order(3)
    public void releaseResources() {
        logger.info("ğŸ¥‰ [ä¼˜å…ˆçº§3] é‡Šæ”¾ç³»ç»Ÿèµ„æº");
    }
}
```

**ğŸ’¡ Hooké’©å­æœ€ä½³å®è·µ**ï¼š

```
è®¾è®¡åŸåˆ™ï¼š
1. å¿«é€Ÿæ‰§è¡Œ - Hookå‡½æ•°ä¸åº”è¯¥æ‰§è¡Œè€—æ—¶å¤ªé•¿çš„æ“ä½œ
2. å¼‚å¸¸å®‰å…¨ - å¿…é¡»æ•è·å¹¶å¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
3. å¹‚ç­‰æ€§ - é‡å¤æ‰§è¡Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
4. æ—¥å¿—å®Œæ•´ - è®°å½•è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥
```

---

## 7. ğŸ¥ å¥åº·æ£€æŸ¥é…åˆæœºåˆ¶


### 7.1 Spring Bootå¥åº·æ£€æŸ¥ç«¯ç‚¹


å¥åº·æ£€æŸ¥å°±åƒæ˜¯åŒ»ç”Ÿä½“æ£€ï¼Œå®šæœŸæ£€æŸ¥åº”ç”¨çš„"èº«ä½“çŠ¶å†µ"ï¼Œåœ¨åœæœºæ—¶è¦ä¸»åŠ¨æŠ¥å‘Š"ç”Ÿç—…äº†"ã€‚

```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    // åº”ç”¨å¥åº·çŠ¶æ€æ ‡è®°
    private volatile boolean isHealthy = true;
    
    /**
     * ğŸ¥ è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘
     */
    @Override
    public Health health() {
        if (isHealthy) {
            return Health.up()
                .withDetail("status", "åº”ç”¨è¿è¡Œæ­£å¸¸")
                .withDetail("timestamp", LocalDateTime.now())
                .build();
        } else {
            return Health.down()
                .withDetail("status", "åº”ç”¨æ­£åœ¨åœæœºä¸­")
                .withDetail("reason", "ä¼˜é›…åœæœºè¿›è¡Œä¸­")
                .withDetail("timestamp", LocalDateTime.now())
                .build();
        }
    }
    
    /**
     * ğŸ”„ è®¾ç½®åº”ç”¨å¥åº·çŠ¶æ€
     */
    public void setHealthy(boolean healthy) {
        this.isHealthy = healthy;
        logger.info("ğŸ¥ åº”ç”¨å¥åº·çŠ¶æ€å·²æ›´æ–°ä¸º: {}", healthy ? "å¥åº·" : "ä¸å¥åº·");
    }
    
    public boolean isHealthy() {
        return isHealthy;
    }
}
```

**ğŸ”¸ å¥åº·æ£€æŸ¥é…ç½®**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
      
  health:
    defaults:
      enabled: true
```

### 7.2 ä¸è´Ÿè½½å‡è¡¡é…åˆçš„å¥åº·æ£€æŸ¥


```java
@RestController
public class LoadBalancerHealthController {
    
    @Autowired
    private CustomHealthIndicator healthIndicator;
    
    /**
     * ğŸ¯ ä¸“é—¨ç»™è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹
     */
    @GetMapping("/health/lb")
    public ResponseEntity<Map<String, Object>> loadBalancerHealth() {
        Map<String, Object> response = new HashMap<>();
        
        if (healthIndicator.isHealthy()) {
            response.put("status", "UP");
            response.put("message", "æœåŠ¡å¥åº·ï¼Œå¯ä»¥æ¥æ”¶è¯·æ±‚");
            return ResponseEntity.ok(response);
        } else {
            response.put("status", "DOWN"); 
            response.put("message", "æœåŠ¡æ­£åœ¨åœæœºï¼Œè¯·å‹¿è½¬å‘è¯·æ±‚");
            return ResponseEntity.status(503).body(response);
        }
    }
    
    /**
     * ğŸ”„ æ‰‹åŠ¨è§¦å‘å¥åº·çŠ¶æ€åˆ‡æ¢ï¼ˆç”¨äºæµ‹è¯•ï¼‰
     */
    @PostMapping("/admin/health/{status}")
    public String setHealthStatus(@PathVariable boolean status) {
        healthIndicator.setHealthy(status);
        return "å¥åº·çŠ¶æ€å·²è®¾ç½®ä¸º: " + (status ? "å¥åº·" : "ä¸å¥åº·");
    }
}
```

### 7.3 å¥åº·æ£€æŸ¥ä¸ä¼˜é›…åœæœºé›†æˆ


```java
@Component
public class HealthAwareShutdownManager {
    
    @Autowired
    private CustomHealthIndicator healthIndicator;
    
    @Autowired  
    private RequestTracker requestTracker;
    
    /**
     * ğŸ¯ å¸¦å¥åº·æ£€æŸ¥çš„ä¼˜é›…åœæœºæµç¨‹
     */
    public void performGracefulShutdown() {
        logger.info("ğŸ¥ å¼€å§‹æ‰§è¡Œå¥åº·æ£€æŸ¥é…åˆçš„ä¼˜é›…åœæœºæµç¨‹...");
        
        // ç¬¬1æ­¥ï¼šå°†å¥åº·æ£€æŸ¥çŠ¶æ€è®¾ä¸ºDOWN
        healthIndicator.setHealthy(false);
        logger.info("ğŸ”´ å¥åº·æ£€æŸ¥çŠ¶æ€å·²è®¾ä¸ºDOWN");
        
        // ç¬¬2æ­¥ï¼šç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ„ŸçŸ¥åˆ°çŠ¶æ€å˜åŒ–
        waitForLoadBalancerUpdate();
        
        // ç¬¬3æ­¥ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
        boolean requestsCompleted = requestTracker.waitForRequestsToComplete();
        
        if (requestsCompleted) {
            logger.info("âœ… æ‰€æœ‰è¯·æ±‚å·²å¤„ç†å®Œæˆï¼Œå¯ä»¥å®‰å…¨åœæœº");
        } else {
            logger.warn("âš ï¸ éƒ¨åˆ†è¯·æ±‚æœªèƒ½åŠæ—¶å®Œæˆï¼Œä½†ä»å°†ç»§ç»­åœæœºæµç¨‹");
        }
        
        logger.info("ğŸ¥ å¥åº·æ£€æŸ¥é…åˆçš„ä¼˜é›…åœæœºæµç¨‹å®Œæˆ");
    }
    
    /**
     * â³ ç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ›´æ–°
     */
    private void waitForLoadBalancerUpdate() {
        logger.info("â³ ç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ›´æ–°æœåŠ¡çŠ¶æ€...");
        
        try {
            // é€šå¸¸éœ€è¦ç­‰å¾…2-3ä¸ªå¥åº·æ£€æŸ¥å‘¨æœŸ
            Thread.sleep(6000);  // å‡è®¾å¥åº·æ£€æŸ¥é—´éš”æ˜¯2ç§’ï¼Œç­‰å¾…3ä¸ªå‘¨æœŸ
            logger.info("âœ… è´Ÿè½½å‡è¡¡å™¨åº”è¯¥å·²ç»æ›´æ–°äº†æœåŠ¡çŠ¶æ€");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            logger.warn("âš ï¸ ç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ›´æ–°æ—¶è¢«ä¸­æ–­");
        }
    }
}
```

**ğŸ¯ å¥åº·æ£€æŸ¥æ—¶åºå›¾**ï¼š
```
è´Ÿè½½å‡è¡¡å™¨              åº”ç”¨æœåŠ¡              æ³¨å†Œä¸­å¿ƒ
     |                     |                    |
     |--[1]å¥åº·æ£€æŸ¥-------->|                    |
     |<-[2]è¿”å›UP----------|                    |
     |                     |                    |
     |                     |--[3]å¼€å§‹åœæœº------>|
     |                     |                    |
     |--[4]å¥åº·æ£€æŸ¥-------->|                    |
     |<-[5]è¿”å›DOWN--------|                    |
     |                     |                    |
     |  (åœæ­¢è½¬å‘è¯·æ±‚)       |  (ç­‰å¾…è¯·æ±‚å®Œæˆ)      |
```

---

## 8. âš–ï¸ è´Ÿè½½å‡è¡¡æ‘˜é™¤ç­–ç•¥


### 8.1 Nginxè´Ÿè½½å‡è¡¡æ‘˜é™¤


åœ¨Nginxä¸­æ‘˜é™¤æœåŠ¡å°±åƒæŠŠæ•…éšœçš„æ”¶é“¶å°æš‚æ—¶å…³é—­ï¼Œè®©é¡¾å®¢å»å…¶ä»–æ­£å¸¸çš„æ”¶é“¶å°æ’é˜Ÿã€‚

**ğŸ”¸ æ‰‹åŠ¨æ‘˜é™¤é…ç½®**
```nginx
# nginx.conf
upstream backend_servers {
    server 192.168.1.100:8080 weight=3;
    server 192.168.1.101:8080 weight=3;
    server 192.168.1.102:8080 down;    # æ‰‹åŠ¨æ ‡è®°ä¸ºä¸‹çº¿
    server 192.168.1.103:8080 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}

location /api {
    proxy_pass http://backend_servers;
    
    # å¥åº·æ£€æŸ¥é…ç½®
    proxy_connect_timeout 3s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
}
```

### 8.2 Spring Cloud LoadBalanceræ‘˜é™¤


```java
@Component
public class CustomLoadBalancerConfiguration {
    
    /**
     * ğŸ¯ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨ï¼Œæ”¯æŒæ‰‹åŠ¨æ‘˜é™¤
     */
    @Bean
    public ReactorServiceInstanceLoadBalancer reactorServiceInstanceLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        return new GracefulRoundRobinLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name);
    }
}

/**
 * ğŸ”„ æ”¯æŒä¼˜é›…æ‘˜é™¤çš„è´Ÿè½½å‡è¡¡å™¨
 */
public class GracefulRoundRobinLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    // è¢«æ‘˜é™¤çš„æœåŠ¡å®ä¾‹åˆ—è¡¨
    private final Set<String> removedInstances = ConcurrentHashMap.newKeySet();
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next().map(serviceInstances -> {
            // è¿‡æ»¤æ‰è¢«æ‘˜é™¤çš„å®ä¾‹
            List<ServiceInstance> availableInstances = serviceInstances.stream()
                .filter(instance -> !isInstanceRemoved(instance))
                .filter(instance -> isInstanceHealthy(instance))
                .collect(Collectors.toList());
            
            if (availableInstances.isEmpty()) {
                return new EmptyResponse();
            }
            
            // è½®è¯¢é€‰æ‹©å¯ç”¨å®ä¾‹
            ServiceInstance selectedInstance = getNextInstance(availableInstances);
            return new DefaultResponse(selectedInstance);
        });
    }
    
    /**
     * ğŸš« æ‰‹åŠ¨æ‘˜é™¤æœåŠ¡å®ä¾‹
     */
    public void removeInstance(String instanceId) {
        removedInstances.add(instanceId);
        logger.info("ğŸš« æœåŠ¡å®ä¾‹å·²ä»è´Ÿè½½å‡è¡¡ä¸­æ‘˜é™¤: {}", instanceId);
    }
    
    /**
     * âœ… æ¢å¤æœåŠ¡å®ä¾‹
     */
    public void restoreInstance(String instanceId) {
        removedInstances.remove(instanceId);
        logger.info("âœ… æœåŠ¡å®ä¾‹å·²æ¢å¤åˆ°è´Ÿè½½å‡è¡¡: {}", instanceId);
    }
    
    private boolean isInstanceRemoved(ServiceInstance instance) {
        String instanceId = instance.getHost() + ":" + instance.getPort();
        return removedInstances.contains(instanceId);
    }
    
    private boolean isInstanceHealthy(ServiceInstance instance) {
        // æ£€æŸ¥å®ä¾‹å¥åº·çŠ¶æ€çš„é€»è¾‘
        return true;  // ç®€åŒ–å®ç°
    }
}
```

### 8.3 åŸºäºå¥åº·æ£€æŸ¥çš„è‡ªåŠ¨æ‘˜é™¤


```java
@Component
public class AutomaticInstanceRemoval {
    
    @Autowired
    private GracefulRoundRobinLoadBalancer loadBalancer;
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    /**
     * ğŸ” å®šæœŸæ£€æŸ¥æœåŠ¡å®ä¾‹å¥åº·çŠ¶æ€
     */
    @Scheduled(fixedDelay = 10000)  // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkInstanceHealth() {
        List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
        
        for (ServiceInstance instance : instances) {
            if (!checkInstanceHealth(instance)) {
                String instanceId = instance.getHost() + ":" + instance.getPort();
                loadBalancer.removeInstance(instanceId);
            }
        }
    }
    
    /**
     * ğŸ¥ æ£€æŸ¥å•ä¸ªå®ä¾‹çš„å¥åº·çŠ¶æ€
     */
    private boolean checkInstanceHealth(ServiceInstance instance) {
        try {
            String healthUrl = "http://" + instance.getHost() + ":" + instance.getPort() + "/health/lb";
            
            RestTemplate restTemplate = new RestTemplate();
            ResponseEntity<Map> response = restTemplate.getForEntity(healthUrl, Map.class);
            
            return response.getStatusCode().is2xxSuccessful() && 
                   "UP".equals(response.getBody().get("status"));
                   
        } catch (Exception e) {
            logger.warn("âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå®ä¾‹: {}:{}", 
                instance.getHost(), instance.getPort());
            return false;
        }
    }
}
```

### 8.4 æ‘˜é™¤ç­–ç•¥é…ç½®ç®¡ç†


```java
@Component
@ConfigurationProperties(prefix = "loadbalancer.removal")
public class RemovalStrategy {
    
    // æ‘˜é™¤ç­–ç•¥ç±»å‹
    private StrategyType strategy = StrategyType.GRADUAL;
    
    // é€æ­¥æ‘˜é™¤çš„å®ä¾‹æ¯”ä¾‹
    private double gradualRemovalRatio = 0.5;
    
    // å¥åº·æ£€æŸ¥å¤±è´¥æ¬¡æ•°é˜ˆå€¼
    private int healthCheckFailureThreshold = 3;
    
    // æ‘˜é™¤åçš„ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
    private int waitTimeAfterRemoval = 30;
    
    /**
     * ğŸ“‹ æ‘˜é™¤ç­–ç•¥æšä¸¾
     */
    public enum StrategyType {
        IMMEDIATE,    // ç«‹å³æ‘˜é™¤
        GRADUAL,      // é€æ­¥æ‘˜é™¤  
        DELAYED       // å»¶è¿Ÿæ‘˜é™¤
    }
    
    // getterå’Œsetteræ–¹æ³•...
}
```

**ğŸ¯ æ‘˜é™¤ç­–ç•¥å¯¹æ¯”**ï¼š

| æ‘˜é™¤ç­–ç•¥ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| ğŸ”¸ **ç«‹å³æ‘˜é™¤** | `ç´§æ€¥æ•…éšœ` | `å¿«é€Ÿå“åº”` | `å¯èƒ½å½±å“æ­£åœ¨å¤„ç†çš„è¯·æ±‚` |
| ğŸ”¸ **é€æ­¥æ‘˜é™¤** | `è®¡åˆ’ç»´æŠ¤` | `å¹³æ»‘è¿‡æ¸¡` | `æ‘˜é™¤è¿‡ç¨‹è¾ƒæ…¢` |
| ğŸ”¸ **å»¶è¿Ÿæ‘˜é™¤** | `ä¸´æ—¶é—®é¢˜` | `ç»™å®ä¾‹æ¢å¤æœºä¼š` | `å¯èƒ½å»¶é•¿é—®é¢˜æ—¶é—´` |

---

## 9. ğŸ“œ åœæœºè„šæœ¬ç¼–å†™å®è·µ


### 9.1 Linux Shellåœæœºè„šæœ¬


ä¸€ä¸ªå¥½çš„åœæœºè„šæœ¬å°±åƒæ˜¯é£è¡Œå‘˜çš„ç€é™†æ£€æŸ¥æ¸…å•ï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½ä¸é—æ¼ã€‚

```bash
#!/bin/bash
# graceful-shutdown.sh - Spring Bootåº”ç”¨ä¼˜é›…åœæœºè„šæœ¬

# è„šæœ¬é…ç½®
APP_NAME="user-service"
APP_PID_FILE="/var/run/${APP_NAME}.pid"
APP_LOG_FILE="/var/log/${APP_NAME}/shutdown.log"
MAX_WAIT_TIME=30
HEALTH_CHECK_URL="http://localhost:8080/health/lb"

# é¢œè‰²è¾“å‡ºé…ç½®
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1${NC}" | tee -a $APP_LOG_FILE
}

log_warn() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARN: $1${NC}" | tee -a $APP_LOG_FILE
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1${NC}" | tee -a $APP_LOG_FILE
}

# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
check_app_running() {
    if [ ! -f "$APP_PID_FILE" ]; then
        log_info "åº”ç”¨PIDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåº”ç”¨å¯èƒ½æœªè¿è¡Œ"
        return 1
    fi
    
    local pid=$(cat $APP_PID_FILE)
    if ! kill -0 $pid 2>/dev/null; then
        log_info "è¿›ç¨‹$pidä¸å­˜åœ¨ï¼Œæ¸…ç†PIDæ–‡ä»¶"
        rm -f $APP_PID_FILE
        return 1
    fi
    
    log_info "åº”ç”¨æ­£åœ¨è¿è¡Œï¼ŒPID: $pid"
    return 0
}

# è§¦å‘ä¼˜é›…åœæœº
trigger_graceful_shutdown() {
    log_info "ğŸ›‘ å¼€å§‹æ‰§è¡Œä¼˜é›…åœæœº..."
    
    # æ–¹å¼1: é€šè¿‡HTTPæ¥å£è§¦å‘åœæœº
    local response=$(curl -s -w "%{http_code}" -X POST \
        http://localhost:8080/actuator/shutdown \
        -H "Content-Type: application/json" \
        -o /dev/null)
    
    if [ "$response" = "200" ]; then
        log_info "âœ… ä¼˜é›…åœæœºä¿¡å·å‘é€æˆåŠŸ"
        return 0
    fi
    
    # æ–¹å¼2: å‘é€SIGTERMä¿¡å·
    local pid=$(cat $APP_PID_FILE)
    log_info "é€šè¿‡SIGTERMä¿¡å·è§¦å‘ä¼˜é›…åœæœº"
    kill -TERM $pid
    return 0
}

# ç­‰å¾…åº”ç”¨åœæ­¢
wait_for_shutdown() {
    log_info "â³ ç­‰å¾…åº”ç”¨åœæ­¢ï¼Œæœ€å¤šç­‰å¾…${MAX_WAIT_TIME}ç§’..."
    
    local count=0
    local pid=$(cat $APP_PID_FILE 2>/dev/null)
    
    while [ $count -lt $MAX_WAIT_TIME ]; do
        if ! kill -0 $pid 2>/dev/null; then
            log_info "âœ… åº”ç”¨å·²ä¼˜é›…åœæ­¢"
            rm -f $APP_PID_FILE
            return 0
        fi
        
        sleep 1
        count=$((count + 1))
        
        # æ¯5ç§’æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        if [ $((count % 5)) -eq 0 ]; then
            log_info "â³ ç­‰å¾…ä¸­... ${count}/${MAX_WAIT_TIME}ç§’"
        fi
    done
    
    log_warn "âš ï¸ åº”ç”¨åœ¨${MAX_WAIT_TIME}ç§’å†…æœªèƒ½ä¼˜é›…åœæ­¢"
    return 1
}

# å¼ºåˆ¶åœæ­¢åº”ç”¨
force_shutdown() {
    log_warn "ğŸ”¨ æ‰§è¡Œå¼ºåˆ¶åœæœº..."
    
    local pid=$(cat $APP_PID_FILE 2>/dev/null)
    if kill -0 $pid 2>/dev/null; then
        kill -KILL $pid
        log_info "âœ… åº”ç”¨å·²å¼ºåˆ¶åœæ­¢"
        rm -f $APP_PID_FILE
    fi
}

# å¥åº·æ£€æŸ¥
check_health_status() {
    local response=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_CHECK_URL)
    
    if [ "$response" = "200" ]; then
        log_info "ğŸŸ¢ åº”ç”¨å¥åº·çŠ¶æ€: UP"
        return 0
    elif [ "$response" = "503" ]; then
        log_info "ğŸŸ¡ åº”ç”¨å¥åº·çŠ¶æ€: DOWN (æ­£åœ¨åœæœº)"
        return 1
    else
        log_warn "ğŸ”´ æ— æ³•è·å–åº”ç”¨å¥åº·çŠ¶æ€"
        return 2
    fi
}

# ä¸»å‡½æ•°
main() {
    log_info "ğŸš€ å¼€å§‹æ‰§è¡Œ${APP_NAME}ä¼˜é›…åœæœºè„šæœ¬"
    
    # æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
    if ! check_app_running; then
        log_info "åº”ç”¨æœªè¿è¡Œï¼Œåœæœºè„šæœ¬ç»“æŸ"
        exit 0
    fi
    
    # è§¦å‘ä¼˜é›…åœæœº
    if ! trigger_graceful_shutdown; then
        log_error "âŒ è§¦å‘ä¼˜é›…åœæœºå¤±è´¥"
        exit 1
    fi
    
    # ç­‰å¾…åº”ç”¨åœæ­¢
    if wait_for_shutdown; then
        log_info "ğŸ‰ åº”ç”¨ä¼˜é›…åœæœºæˆåŠŸ"
        exit 0
    else
        # ä¼˜é›…åœæœºè¶…æ—¶ï¼Œæ‰§è¡Œå¼ºåˆ¶åœæœº
        force_shutdown
        log_info "ğŸ‰ åº”ç”¨å¼ºåˆ¶åœæœºå®Œæˆ"
        exit 0
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

### 9.2 Windows PowerShellåœæœºè„šæœ¬


```powershell
# graceful-shutdown.ps1 - Windowsç¯å¢ƒä¸‹çš„ä¼˜é›…åœæœºè„šæœ¬

param(
    [Parameter(Mandatory=$false)]
    [string]$AppName = "user-service",
    
    [Parameter(Mandatory=$false)]
    [int]$MaxWaitTime = 30,
    
    [Parameter(Mandatory=$false)]
    [string]$HealthCheckUrl = "http://localhost:8080/health/lb"
)

# é…ç½®å˜é‡
$LogFile = "C:\logs\$AppName\shutdown.log"
$PidFile = "C:\temp\$AppName.pid"

# æ—¥å¿—å‡½æ•°
function Write-Log {
    param([string]$Level, [string]$Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] $Level`: $Message"
    Write-Host $logEntry
    Add-Content -Path $LogFile -Value $logEntry
}

# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
function Test-AppRunning {
    if (-not (Test-Path $PidFile)) {
        Write-Log "INFO" "PIDæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåº”ç”¨å¯èƒ½æœªè¿è¡Œ"
        return $false
    }
    
    $pid = Get-Content $PidFile
    $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
    
    if ($null -eq $process) {
        Write-Log "INFO" "è¿›ç¨‹$pidä¸å­˜åœ¨ï¼Œæ¸…ç†PIDæ–‡ä»¶"
        Remove-Item $PidFile -Force
        return $false
    }
    
    Write-Log "INFO" "åº”ç”¨æ­£åœ¨è¿è¡Œï¼ŒPID: $pid"
    return $true
}

# è§¦å‘ä¼˜é›…åœæœº
function Start-GracefulShutdown {
    Write-Log "INFO" "ğŸ›‘ å¼€å§‹æ‰§è¡Œä¼˜é›…åœæœº..."
    
    try {
        # é€šè¿‡HTTPæ¥å£è§¦å‘åœæœº
        $response = Invoke-RestMethod -Uri "http://localhost:8080/actuator/shutdown" -Method POST
        Write-Log "INFO" "âœ… ä¼˜é›…åœæœºä¿¡å·å‘é€æˆåŠŸ"
        return $true
    }
    catch {
        Write-Log "WARN" "HTTPåœæœºæ¥å£è°ƒç”¨å¤±è´¥ï¼Œå°è¯•å‘é€ç»ˆæ­¢ä¿¡å·"
        
        # è·å–è¿›ç¨‹å¹¶å‘é€ç»ˆæ­¢ä¿¡å·
        $pid = Get-Content $PidFile
        $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
        if ($process) {
            $process.CloseMainWindow()
            Write-Log "INFO" "å·²å‘é€ç»ˆæ­¢ä¿¡å·åˆ°è¿›ç¨‹$pid"
            return $true
        }
    }
    
    return $false
}

# ç­‰å¾…åº”ç”¨åœæ­¢
function Wait-ForShutdown {
    Write-Log "INFO" "â³ ç­‰å¾…åº”ç”¨åœæ­¢ï¼Œæœ€å¤šç­‰å¾…$MaxWaitTimeç§’..."
    
    $count = 0
    $pid = Get-Content $PidFile -ErrorAction SilentlyContinue
    
    while ($count -lt $MaxWaitTime) {
        $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
        if ($null -eq $process) {
            Write-Log "INFO" "âœ… åº”ç”¨å·²ä¼˜é›…åœæ­¢"
            Remove-Item $PidFile -Force -ErrorAction SilentlyContinue
            return $true
        }
        
        Start-Sleep -Seconds 1
        $count++
        
        if ($count % 5 -eq 0) {
            Write-Log "INFO" "â³ ç­‰å¾…ä¸­... $count/$MaxWaitTimeç§’"
        }
    }
    
    Write-Log "WARN" "âš ï¸ åº”ç”¨åœ¨$MaxWaitTimeç§’å†…æœªèƒ½ä¼˜é›…åœæ­¢"
    return $false
}

# å¼ºåˆ¶åœæ­¢åº”ç”¨
function Stop-AppForcefully {
    Write-Log "WARN" "ğŸ”¨ æ‰§è¡Œå¼ºåˆ¶åœæœº..."
    
    $pid = Get-Content $PidFile -ErrorAction SilentlyContinue
    if ($pid) {
        $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
        if ($process) {
            $process.Kill()
            Write-Log "INFO" "âœ… åº”ç”¨å·²å¼ºåˆ¶åœæ­¢"
            Remove-Item $PidFile -Force -ErrorAction SilentlyContinue
        }
    }
}

# ä¸»æ‰§è¡Œé€»è¾‘
Write-Log "INFO" "ğŸš€ å¼€å§‹æ‰§è¡Œ$AppNameä¼˜é›…åœæœºè„šæœ¬"

if (-not (Test-AppRunning)) {
    Write-Log "INFO" "åº”ç”¨æœªè¿è¡Œï¼Œåœæœºè„šæœ¬ç»“æŸ"
    exit 0
}

if (Start-GracefulShutdown) {
    if (Wait-ForShutdown) {
        Write-Log "INFO" "ğŸ‰ åº”ç”¨ä¼˜é›…åœæœºæˆåŠŸ"
        exit 0
    } else {
        Stop-AppForcefully
        Write-Log "INFO" "ğŸ‰ åº”ç”¨å¼ºåˆ¶åœæœºå®Œæˆ"
        exit 0
    }
} else {
    Write-Log "ERROR" "âŒ è§¦å‘ä¼˜é›…åœæœºå¤±è´¥"
    exit 1
}
```

### 9.3 Dockerå®¹å™¨ä¼˜é›…åœæœº


```dockerfile
# Dockerfile
FROM openjdk:11-jre-slim

# æ·»åŠ ä¼˜é›…åœæœºè„šæœ¬
COPY graceful-shutdown.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/graceful-shutdown.sh

# åº”ç”¨jaråŒ…
COPY target/user-service.jar /app/app.jar

# è®¾ç½®åœæœºä¿¡å·å¤„ç†
STOPSIGNAL SIGTERM

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  user-service:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    # è®¾ç½®åœæœºè¶…æ—¶æ—¶é—´
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
```

**ğŸ¯ è„šæœ¬ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# Linuxç¯å¢ƒ
./graceful-shutdown.sh

# Windowsç¯å¢ƒ  
PowerShell -ExecutionPolicy Bypass -File .\graceful-shutdown.ps1

# Dockerç¯å¢ƒ
docker-compose down --timeout 30
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä¼˜é›…åœæœºä¸‰è¦ç´ **
- **ç”¨æˆ·å‹å¥½** - ä¸ä¸­æ–­ç”¨æˆ·æ­£åœ¨è¿›è¡Œçš„æ“ä½œ
- **æ•°æ®å®‰å…¨** - ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œä¸€è‡´æ€§  
- **èµ„æºé‡Šæ”¾** - æœ‰åºé‡Šæ”¾ç³»ç»Ÿèµ„æºé¿å…æ³„æ¼

**ğŸ”¸ å®ç°æœºåˆ¶äº”æ­¥éª¤**
1. **åœæ­¢æ¥æ”¶æ–°è¯·æ±‚** - è®¾ç½®åœæœºæ ‡è¯†ï¼Œæ‹’ç»æ–°è¯·æ±‚
2. **ç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆ** - ä½¿ç”¨è®¡æ•°å™¨è·Ÿè¸ªæ´»è·ƒè¯·æ±‚
3. **é‡Šæ”¾ç³»ç»Ÿèµ„æº** - å…³é—­è¿æ¥æ± ã€æ¸…ç†ç¼“å­˜
4. **æ³¨é”€æœåŠ¡æ³¨å†Œ** - ä»æ³¨å†Œä¸­å¿ƒç§»é™¤æœåŠ¡å®ä¾‹
5. **åº”ç”¨å½»åº•åœæ­¢** - æ‰§è¡Œæœ€ç»ˆçš„æ¸…ç†å’Œå…³é—­

### 10.2 å…³é”®æŠ€æœ¯å®ç°


**ğŸ”¹ Spring Bootå†…ç½®æ”¯æŒ**
```yaml
server:
  shutdown: graceful          # å¯ç”¨ä¼˜é›…åœæœº
spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s  # è¶…æ—¶æ—¶é—´
```

**ğŸ”¹ è‡ªå®šä¹‰å®ç°è¦ç‚¹**
- ä½¿ç”¨ `AtomicInteger` è·Ÿè¸ªæ´»è·ƒè¯·æ±‚
- å®ç° `Filter` æ‹¦æˆªæ–°è¯·æ±‚
- ä½¿ç”¨ `@PreDestroy` æ‰§è¡Œæ¸…ç†é€»è¾‘
- æ³¨å†Œ `JVM ShutdownHook` å¤„ç†å¼‚å¸¸åœæœº

**ğŸ”¹ å¾®æœåŠ¡ç¯å¢ƒç‰¹æ®Šè€ƒè™‘**
- å¥åº·æ£€æŸ¥çŠ¶æ€è¦åŠæ—¶æ›´æ–°ä¸ºDOWN
- ç­‰å¾…è´Ÿè½½å‡è¡¡å™¨æ„ŸçŸ¥çŠ¶æ€å˜åŒ–
- ä»æœåŠ¡æ³¨å†Œä¸­å¿ƒæ³¨é”€å®ä¾‹
- å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æœ€ä½³å®è·µæ¸…å•**
- [ ] é…ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´ï¼ˆé€šå¸¸15-30ç§’ï¼‰
- [ ] å®ç°è¯·æ±‚è®¡æ•°å’Œè·Ÿè¸ªæœºåˆ¶  
- [ ] è®¾è®¡å®Œå–„çš„æ¸…ç†èµ„æºæµç¨‹
- [ ] ç¼–å†™è‡ªåŠ¨åŒ–çš„åœæœºè„šæœ¬
- [ ] é…ç½®å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] æµ‹è¯•å„ç§åœæœºåœºæ™¯

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
- ä¸è¦å¿½ç•¥æ­£åœ¨å¤„ç†çš„å¼‚æ­¥ä»»åŠ¡
- ä¸è¦å¿˜è®°æ¸…ç†çº¿ç¨‹æ± å’Œè¿æ¥æ± 
- ä¸è¦è®¾ç½®è¿‡çŸ­çš„è¶…æ—¶æ—¶é—´
- ä¸è¦åœ¨Hookå‡½æ•°ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

### 10.4 ç›‘æ§å’Œè¿ç»´


**ğŸ” å…³é”®ç›‘æ§æŒ‡æ ‡**
- åœæœºè€—æ—¶ç»Ÿè®¡
- æœªå®Œæˆè¯·æ±‚æ•°é‡
- èµ„æºé‡Šæ”¾æ˜¯å¦å®Œæ•´
- æœåŠ¡æ³¨é”€æ˜¯å¦æˆåŠŸ

**ğŸ“Š æ•…éšœæ’æŸ¥è¦ç‚¹**
- æ£€æŸ¥åº”ç”¨æ—¥å¿—ä¸­çš„åœæœºæµç¨‹è®°å½•
- ç¡®è®¤å¥åº·æ£€æŸ¥çŠ¶æ€å˜åŒ–æ—¶é—´çº¿
- éªŒè¯è´Ÿè½½å‡è¡¡å™¨æ˜¯å¦åŠæ—¶æ‘˜é™¤å®ä¾‹
- åˆ†ææ˜¯å¦å­˜åœ¨èµ„æºæ³„æ¼

### 10.5 è¿›é˜¶æ‰©å±•æ–¹å‘


**ğŸš€ é«˜çº§ç‰¹æ€§**
- åˆ†é˜¶æ®µåœæœºï¼šä¼˜å…ˆçº§é˜Ÿåˆ—å¤„ç†é‡è¦è¯·æ±‚
- ç°åº¦åœæœºï¼šé€æ­¥å‡å°‘æµé‡è€Œä¸æ˜¯ç«‹å³åœæ­¢
- æ™ºèƒ½ç­‰å¾…ï¼šæ ¹æ®è¯·æ±‚ç±»å‹åŠ¨æ€è°ƒæ•´ç­‰å¾…æ—¶é—´
- é›†ç¾¤åè°ƒï¼šå¤šå®ä¾‹ç¯å¢ƒä¸‹çš„åè°ƒåœæœº

**ğŸ”§ å·¥å…·å’Œæ¡†æ¶æ”¯æŒ**
- Spring Boot Actuatoråœæœºç«¯ç‚¹
- Kubernetes Graceful Shutdown
- Service Meshä¼˜é›…åœæœº
- APMå·¥å…·ç›‘æ§åœæœºè¿‡ç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- åœæœºä¹‹å‰å…ˆè®¾æ ‡ï¼Œæ‹’ç»æ–°å®¢ç­‰æ—§äº†
- èµ„æºæ¸…ç†åˆ«å¿˜æ‰ï¼Œæ³¨å†Œä¸­å¿ƒè¦æ³¨é”€  
- è¶…æ—¶ä¿æŠ¤å¾ˆé‡è¦ï¼Œç›‘æ§æ—¥å¿—ä¸èƒ½å°‘
- è„šæœ¬è‡ªåŠ¨æ›´å¯é ï¼Œæµ‹è¯•éªŒè¯ç¼ºä¸äº†

**ğŸ¯ å­¦ä¹ æ£€éªŒ**
- [ ] èƒ½å¤Ÿè§£é‡Šä¼˜é›…åœæœºçš„åŸºæœ¬åŸç†å’Œé‡è¦æ€§
- [ ] èƒ½å¤Ÿé…ç½®Spring Bootçš„å†…ç½®ä¼˜é›…åœæœºåŠŸèƒ½  
- [ ] èƒ½å¤Ÿå®ç°è‡ªå®šä¹‰çš„è¯·æ±‚è·Ÿè¸ªå’Œèµ„æºæ¸…ç†
- [ ] èƒ½å¤Ÿç¼–å†™å®Œæ•´çš„è‡ªåŠ¨åŒ–åœæœºè„šæœ¬
- [ ] èƒ½å¤Ÿå¤„ç†å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„ç‰¹æ®Šè¦æ±‚