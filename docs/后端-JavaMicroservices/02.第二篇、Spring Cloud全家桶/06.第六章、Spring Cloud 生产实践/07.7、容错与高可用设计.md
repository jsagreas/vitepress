---
title: 7ã€å®¹é”™ä¸é«˜å¯ç”¨è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å®¹é”™è®¾è®¡æ¨¡å¼](#1-å®¹é”™è®¾è®¡æ¨¡å¼)
2. [è¶…æ—¶æœºåˆ¶è®¾è®¡](#2-è¶…æ—¶æœºåˆ¶è®¾è®¡)
3. [é‡è¯•ç­–ç•¥è®¾è®¡](#3-é‡è¯•ç­–ç•¥è®¾è®¡)
4. [é™æµé™çº§æ–¹æ¡ˆ](#4-é™æµé™çº§æ–¹æ¡ˆ)
5. [æ•…éšœéš”ç¦»æœºåˆ¶](#5-æ•…éšœéš”ç¦»æœºåˆ¶)
6. [ä¼˜é›…åœæœº](#6-ä¼˜é›…åœæœº)
7. [ç¾å¤‡æ¢å¤ç­–ç•¥](#7-ç¾å¤‡æ¢å¤ç­–ç•¥)
8. [å¤šæ´»æ¶æ„](#8-å¤šæ´»æ¶æ„)
9. [å®¹é‡è§„åˆ’](#9-å®¹é‡è§„åˆ’)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹é”™è®¾è®¡æ¨¡å¼


### 1.1 ä»€ä¹ˆæ˜¯å®¹é”™è®¾è®¡


**ğŸ”¸ å®¹é”™çš„æœ¬è´¨å«ä¹‰**

ç®€å•ç†è§£ï¼Œå®¹é”™å°±æ˜¯**"ç³»ç»Ÿèƒ½å¤Ÿå®¹å¿é”™è¯¯ï¼Œä¸ä¼šå› ä¸ºæŸä¸ªåœ°æ–¹å‡ºé—®é¢˜å°±æ•´ä½“ç˜«ç—ª"**ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
æ±½è½¦è½®èƒçˆ†èƒ â†’ å¤‡èƒé¡¶ä¸Šï¼Œç»§ç»­è¡Œé©¶
ç”µè·¯çŸ­è·¯ â†’ ä¿é™©ä¸ç†”æ–­ï¼Œä¿æŠ¤å…¶ä»–è®¾å¤‡
é“¶è¡ŒæŸœå°æ•…éšœ â†’ ATMæœºç»§ç»­å·¥ä½œ

å¾®æœåŠ¡ä¸­çš„å®¹é”™ï¼š
ç”¨æˆ·æœåŠ¡å®•æœº â†’ ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯
æ”¯ä»˜æ¥å£è¶…æ—¶ â†’ åˆ‡æ¢åˆ°å¤‡ç”¨æ”¯ä»˜æ¸ é“
æ•°æ®åº“è¿æ¥å¤±è´¥ â†’ é™çº§è¿”å›é»˜è®¤æ•°æ®
```

**ğŸ’¡ ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦å®¹é”™**

```
å•ä½“åº”ç”¨æ—¶ä»£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å•ä½“åº”ç”¨      â”‚  ä¸€ä¸ªåœ°æ–¹å‡ºé”™ï¼Œæ•´ä¸ªç³»ç»Ÿå´©æºƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡æ—¶ä»£ï¼š
ç”¨æˆ·æœåŠ¡ â†â†’ è®¢å•æœåŠ¡ â†â†’ æ”¯ä»˜æœåŠ¡ â†â†’ åº“å­˜æœåŠ¡
   â†•         â†•         â†•         â†•
é€šçŸ¥æœåŠ¡   è¥é”€æœåŠ¡    ç‰©æµæœåŠ¡   å®¡è®¡æœåŠ¡

é—®é¢˜ï¼šä»»ä½•ä¸€ä¸ªæœåŠ¡å‡ºé”™ï¼Œéƒ½å¯èƒ½å½±å“æ•´ä¸ªä¸šåŠ¡æµç¨‹
```

### 1.2 æ ¸å¿ƒå®¹é”™æ¨¡å¼


#### ğŸ¯ **ç†”æ–­å™¨æ¨¡å¼**


**å«ä¹‰è§£é‡Š**ï¼šå°±åƒå®¶é‡Œçš„ç”µè·¯ä¿é™©ä¸ï¼Œç”µæµè¿‡å¤§å°±è‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤æ•´ä¸ªç”µè·¯ç³»ç»Ÿã€‚

```
æ­£å¸¸çŠ¶æ€ï¼ˆå…³é—­ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ ç†”æ–­å™¨ â†’ æœåŠ¡A â†’ è¿”å›ç»“æœ

æ•…éšœçŠ¶æ€ï¼ˆå¼€å¯ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ ç†”æ–­å™¨ â†’ âŒç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡A

æ¢å¤çŠ¶æ€ï¼ˆåŠå¼€ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ ç†”æ–­å™¨ â†’ å°è¯•è°ƒç”¨æœåŠ¡A â†’ æˆåŠŸåˆ™å…³é—­ï¼Œå¤±è´¥åˆ™å¼€å¯
```

**ğŸ”§ Spring Cloudå®ç°**

```java
// ä½¿ç”¨Resilience4jç†”æ–­å™¨
@Component
public class UserService {
    
    @CircuitBreaker(name = "userService", fallbackMethod = "getUserFallback")
    public User getUser(Long id) {
        // è°ƒç”¨è¿œç¨‹æœåŠ¡
        return restTemplate.getForObject("/user/" + id, User.class);
    }
    
    // ç†”æ–­é™çº§æ–¹æ³•
    public User getUserFallback(Long id, Exception ex) {
        return User.builder()
                .id(id)
                .name("é»˜è®¤ç”¨æˆ·")
                .status("æœåŠ¡æš‚ä¸å¯ç”¨")
                .build();
    }
}
```

#### ğŸ¯ **èˆ±å£æ¨¡å¼**


**å«ä¹‰è§£é‡Š**ï¼šèˆ¹èˆ±åˆ†éš”è®¾è®¡ï¼Œä¸€ä¸ªèˆ±è¿›æ°´ä¸ä¼šå½±å“å…¶ä»–èˆ±ã€‚åœ¨å¾®æœåŠ¡ä¸­å°±æ˜¯**èµ„æºéš”ç¦»**ã€‚

```
ä¼ ç»Ÿè®¾è®¡ï¼ˆå…±äº«èµ„æºæ± ï¼‰ï¼š
     çº¿ç¨‹æ± (100ä¸ªçº¿ç¨‹)
        /    |    \
   ç”¨æˆ·æœåŠ¡ è®¢å•æœåŠ¡ æ”¯ä»˜æœåŠ¡
   
é—®é¢˜ï¼šæ”¯ä»˜æœåŠ¡å“åº”æ…¢ï¼Œå ç”¨æ‰€æœ‰çº¿ç¨‹ï¼Œå¯¼è‡´ç”¨æˆ·å’Œè®¢å•æœåŠ¡ä¹Ÿæ— æ³•å“åº”

èˆ±å£è®¾è®¡ï¼ˆèµ„æºéš”ç¦»ï¼‰ï¼š
ç”¨æˆ·æœåŠ¡      è®¢å•æœåŠ¡      æ”¯ä»˜æœåŠ¡
çº¿ç¨‹æ± A       çº¿ç¨‹æ± B       çº¿ç¨‹æ± C
(30çº¿ç¨‹)      (30çº¿ç¨‹)      (40çº¿ç¨‹)

ç»“æœï¼šæ”¯ä»˜æœåŠ¡å“åº”æ…¢åªå½±å“è‡ªå·±ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
```

**ğŸ”§ å®ç°æ–¹å¼**

```java
// é…ç½®ä¸åŒçš„çº¿ç¨‹æ± 
@Configuration
public class ThreadPoolConfig {
    
    @Bean("userServiceExecutor")
    public ThreadPoolTaskExecutor userServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("user-service-");
        return executor;
    }
    
    @Bean("orderServiceExecutor") 
    public ThreadPoolTaskExecutor orderServiceExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(15);
        executor.setMaxPoolSize(30);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("order-service-");
        return executor;
    }
}
```

#### ğŸ¯ **é™æµæ¨¡å¼**


**å«ä¹‰è§£é‡Š**ï¼šæ§åˆ¶è®¿é—®é¢‘ç‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«å‹å®ã€‚å°±åƒæ™¯åŒºé™åˆ¶æ¸¸å®¢æ•°é‡ä¸€æ ·ã€‚

| é™æµç®—æ³• | **å·¥ä½œåŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-----------|
| ğŸª£ **ä»¤ç‰Œæ¡¶** | `å›ºå®šé€Ÿç‡æ”¾å…¥ä»¤ç‰Œï¼Œè¯·æ±‚æ¶ˆè€—ä»¤ç‰Œ` | `å…è®¸çŸ­æ—¶çªå‘æµé‡` | `å®ç°å¤æ‚ï¼Œä½†çµæ´»` |
| ğŸª£ **æ¼æ¡¶** | `å›ºå®šé€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œå¤šä½™è¯·æ±‚æ’é˜Ÿ` | `æµé‡æ•´å½¢ï¼Œå¹³æ»‘è¾“å‡º` | `ä¸å…è®¸çªå‘ï¼Œå»¶è¿Ÿé«˜` |
| ğŸ”¢ **è®¡æ•°å™¨** | `å›ºå®šæ—¶é—´çª—å£å†…é™åˆ¶è¯·æ±‚æ•°é‡` | `ç®€å•åœºæ™¯ï¼Œç²—ç²’åº¦æ§åˆ¶` | `è¾¹ç•Œé—®é¢˜ï¼Œä¸å¤Ÿç²¾ç¡®` |
| ğŸªŸ **æ»‘åŠ¨çª—å£** | `åŠ¨æ€æ—¶é—´çª—å£ï¼Œæ›´ç²¾ç¡®æ§åˆ¶` | `ç²¾ç¡®é™æµï¼Œæ— è¾¹ç•Œé—®é¢˜` | `å†…å­˜å¼€é”€å¤§` |

---

## 2. â° è¶…æ—¶æœºåˆ¶è®¾è®¡


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æœºåˆ¶


**ğŸ”¸ é—®é¢˜åœºæ™¯**

```
æ²¡æœ‰è¶…æ—¶çš„åæœï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æœåŠ¡A â†’ æœåŠ¡Bï¼ˆå¡ä½ä¸å“åº”ï¼‰
            â†“
     å®¢æˆ·ç«¯ä¸€ç›´ç­‰å¾…ï¼Œå ç”¨è¿æ¥èµ„æº
     æœ€ç»ˆå¯¼è‡´è¿æ¥æ± è€—å°½ï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨
     
æœ‰è¶…æ—¶ä¿æŠ¤ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æœåŠ¡A â†’ æœåŠ¡Bï¼ˆ3ç§’åè¶…æ—¶ï¼‰
            â†“
     å¿«é€Ÿè¿”å›é”™è¯¯ï¼Œé‡Šæ”¾èµ„æºï¼Œç³»ç»Ÿç»§ç»­å¯ç”¨
```

### 2.2 è¶…æ—¶å±‚æ¬¡è®¾è®¡


**ğŸ”§ å¤šå±‚è¶…æ—¶é…ç½®**

```yaml
# application.yml - è¶…æ—¶é…ç½®ç¤ºä¾‹
# â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€é…ç½®

# 1. HTTPå®¢æˆ·ç«¯è¶…æ—¶
ribbon:
  ConnectTimeout: 1000        # è¿æ¥è¶…æ—¶1ç§’
  ReadTimeout: 3000          # è¯»å–è¶…æ—¶3ç§’

# 2. Feignè¶…æ—¶é…ç½®
feign:
  client:
    config:
      user-service:
        connectTimeout: 2000   # é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„è¿æ¥è¶…æ—¶
        readTimeout: 5000     # é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„è¯»å–è¶…æ—¶

# 3. ç†”æ–­å™¨è¶…æ—¶
resilience4j:
  circuitbreaker:
    instances:
      userService:
        slowCallDurationThreshold: 2000  # æ…¢è°ƒç”¨é˜ˆå€¼2ç§’
```

**âš ï¸ è¶…æ—¶è®¾ç½®åŸåˆ™**

> **åŸåˆ™1**ï¼šè¶…æ—¶æ—¶é—´è¦**åˆç†é€’å¢**
> - æ•°æ®åº“æŸ¥è¯¢ï¼š100-500ms
> - ç¼“å­˜æŸ¥è¯¢ï¼š10-50ms  
> - ç½‘ç»œè°ƒç”¨ï¼š1-5ç§’
> - æ–‡ä»¶ä¸Šä¼ ï¼š10-30ç§’

> **åŸåˆ™2**ï¼šè¦è€ƒè™‘**è°ƒç”¨é“¾è·¯**
> ```
> ç”¨æˆ·è¯·æ±‚(10s) â†’ è®¢å•æœåŠ¡(8s) â†’ åº“å­˜æœåŠ¡(5s) â†’ æ•°æ®åº“(2s)
> æ¯ä¸€å±‚çš„è¶…æ—¶æ—¶é—´è¦ç•™æœ‰ä½™é‡ï¼Œé¿å…åŒæ—¶è¶…æ—¶
> ```

### 2.3 å®é™…è¶…æ—¶é…ç½®


```java
// â­ éš¾åº¦ï¼šâ­â­ ä¸­çº§åº”ç”¨

@Configuration
public class TimeoutConfig {
    
    // HTTPå®¢æˆ·ç«¯è¶…æ—¶é…ç½®
    @Bean
    public RestTemplate restTemplate() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(2000);     // è¿æ¥è¶…æ—¶2ç§’
        factory.setReadTimeout(5000);        // è¯»å–è¶…æ—¶5ç§’
        return new RestTemplate(factory);
    }
    
    // Feignå®¢æˆ·ç«¯è¶…æ—¶é…ç½®
    @FeignClient(
        name = "user-service",
        configuration = UserServiceFeignConfig.class
    )
    public interface UserServiceClient {
        @GetMapping("/user/{id}")
        User getUser(@PathVariable Long id);
    }
}

// å…·ä½“æœåŠ¡çš„è¶…æ—¶é…ç½®
@Configuration
public class UserServiceFeignConfig {
    
    @Bean
    public Request.Options options() {
        return new Request.Options(
            2000,  // è¿æ¥è¶…æ—¶
            5000   // è¯»å–è¶…æ—¶
        );
    }
}
```

---

## 3. ğŸ”„ é‡è¯•ç­–ç•¥è®¾è®¡


### 3.1 é‡è¯•çš„å¿…è¦æ€§


**ğŸ”¸ ä»€ä¹ˆæƒ…å†µéœ€è¦é‡è¯•**

```
âœ… åº”è¯¥é‡è¯•çš„åœºæ™¯ï¼š
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„è¿æ¥å¤±è´¥
- ä¸´æ—¶æ€§çš„æœåŠ¡ä¸å¯ç”¨ï¼ˆ502ã€503é”™è¯¯ï¼‰
- æ•°æ®åº“è¿æ¥æ± æš‚æ—¶è€—å°½
- è´Ÿè½½å‡è¡¡å™¨ä¸´æ—¶æ•…éšœ

âŒ ä¸åº”è¯¥é‡è¯•çš„åœºæ™¯ï¼š
- ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆ400ã€404é”™è¯¯ï¼‰
- è®¤è¯å¤±è´¥ï¼ˆ401ã€403é”™è¯¯ï¼‰
- æ•°æ®é‡å¤æäº¤çš„åœºæ™¯
- éå¹‚ç­‰æ“ä½œï¼ˆæ‰£æ¬¾ã€å‘é€çŸ­ä¿¡ç­‰ï¼‰
```

### 3.2 é‡è¯•ç­–ç•¥ç±»å‹


**ğŸ“Š é‡è¯•ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ç±»å‹ | **é‡è¯•é—´éš”** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-----------|
| ğŸ”„ **ç«‹å³é‡è¯•** | `0ms` | `å¶å‘ç½‘ç»œæŠ–åŠ¨` | `å¿«é€Ÿæ¢å¤ï¼Œä½†å¯èƒ½åŠ é‡ç³»ç»Ÿè´Ÿæ‹…` |
| â±ï¸ **å›ºå®šé—´éš”** | `å›ºå®šæ—¶é—´ï¼ˆå¦‚1ç§’ï¼‰` | `ä¸€èˆ¬æ€§æ•…éšœ` | `ç®€å•å¯æ§ï¼Œä½†ä¸å¤Ÿæ™ºèƒ½` |
| ğŸ“ˆ **æŒ‡æ•°é€€é¿** | `1s, 2s, 4s, 8s...` | `ç³»ç»Ÿè¿‡è½½æ¢å¤` | `é€æ¸å‡å°‘å‹åŠ›ï¼Œä½†å»¶è¿Ÿè¾ƒé•¿` |
| ğŸ² **éšæœºæŠ–åŠ¨** | `éšæœºæ—¶é—´èŒƒå›´å†…` | `å¤§é‡å®¢æˆ·ç«¯åŒæ—¶é‡è¯•` | `é¿å…é›ªå´©ï¼Œä½†ä¸å¤Ÿç²¾ç¡®` |

### 3.3 é‡è¯•å®ç°


**ğŸ”§ Spring Retryå®ç°**

```java
// â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€é‡è¯•

@Service
public class OrderService {
    
    // åŸºç¡€é‡è¯•é…ç½®
    @Retryable(
        value = {ConnectException.class, SocketTimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000, multiplier = 2)
    )
    public Order createOrder(OrderRequest request) {
        // è°ƒç”¨å¤–éƒ¨æœåŠ¡åˆ›å»ºè®¢å•
        return orderClient.createOrder(request);
    }
    
    // é‡è¯•å¤±è´¥åçš„é™çº§æ–¹æ³•
    @Recover
    public Order createOrderRecover(Exception ex, OrderRequest request) {
        log.error("åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¿›å…¥é™çº§é€»è¾‘", ex);
        return Order.builder()
                .status("PENDING")
                .message("è®¢å•åˆ›å»ºä¸­ï¼Œè¯·ç¨åæŸ¥è¯¢")
                .build();
    }
}
```

**ğŸ”§ Resilience4jé‡è¯•**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ é«˜çº§é…ç½®

@Component
public class PaymentService {
    
    private final Retry retry;
    
    public PaymentService() {
        // è‡ªå®šä¹‰é‡è¯•é…ç½®
        this.retry = Retry.ofDefaults("payment-service");
        RetryConfig config = RetryConfig.custom()
                .maxAttempts(3)
                .waitDuration(Duration.ofSeconds(1))
                .exponentialBackoffMultiplier(2)
                .retryOnException(ex -> 
                    ex instanceof ConnectException || 
                    ex instanceof SocketTimeoutException)
                .build();
        
        this.retry = Retry.of("payment-service", config);
    }
    
    public PaymentResult processPayment(PaymentRequest request) {
        Supplier<PaymentResult> decoratedSupplier = Retry.decorateSupplier(
            retry, () -> paymentClient.pay(request)
        );
        
        return decoratedSupplier.get();
    }
}
```

**âš ï¸ é‡è¯•æœ€ä½³å®è·µ**

> **æœ€ä½³å®è·µ1**ï¼š**å¹‚ç­‰æ€§æ£€æŸ¥**
> ```java
> // ç¡®ä¿é‡è¯•æ“ä½œæ˜¯å¹‚ç­‰çš„
> @Retryable
> public void updateUserStatus(Long userId, String status) {
>     // å…ˆæŸ¥è¯¢å½“å‰çŠ¶æ€ï¼Œé¿å…é‡å¤æ›´æ–°
>     User user = userRepository.findById(userId);
>     if (!status.equals(user.getStatus())) {
>         userRepository.updateStatus(userId, status);
>     }
> }
> ```

> **æœ€ä½³å®è·µ2**ï¼š**è®¾ç½®æœ€å¤§é‡è¯•æ—¶é—´**
> ```java
> @Retryable(
>     maxAttempts = 5,
>     backoff = @Backoff(delay = 1000, multiplier = 2, maxDelay = 10000)
> )
> ```

---

## 4. ğŸš¦ é™æµé™çº§æ–¹æ¡ˆ


### 4.1 é™æµçš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯é™æµ**

é™æµå°±æ˜¯**æ§åˆ¶ç³»ç»Ÿçš„è®¿é—®é€Ÿåº¦**ï¼Œé˜²æ­¢çªå‘æµé‡å‹å®ç³»ç»Ÿã€‚

```
ç”Ÿæ´»ä¸­çš„é™æµï¼š
ğŸš— é«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™ - æ§åˆ¶è½¦è¾†é€šè¿‡é€Ÿåº¦
ğŸª å•†åº—é™åˆ¶è¿›åº—äººæ•° - é˜²æ­¢è¿‡åº¦æ‹¥æŒ¤  
ğŸš° æ°´é¾™å¤´æ§åˆ¶å‡ºæ°´é‡ - èŠ‚çº¦ç”¨æ°´

ç³»ç»Ÿä¸­çš„é™æµï¼š
ğŸ“Š æ¯ç§’è¯·æ±‚æ•°é™åˆ¶ - ä¿æŠ¤æœåŠ¡å™¨æ€§èƒ½
ğŸ‘¥ å¹¶å‘ç”¨æˆ·æ•°é™åˆ¶ - é˜²æ­¢èµ„æºè€—å°½
ğŸ’¾ æ¥å£è°ƒç”¨æ¬¡æ•°é™åˆ¶ - é˜²æ­¢æ¶æ„è°ƒç”¨
```

### 4.2 é™æµç®—æ³•å®ç°


**ğŸ”§ ä»¤ç‰Œæ¡¶ç®—æ³•**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ ä¸­çº§ç®—æ³•ç†è§£

@Component
public class TokenBucketLimiter {
    
    private final long capacity;      // æ¡¶å®¹é‡
    private final long refillRate;    // ä»¤ç‰Œè¡¥å……é€Ÿç‡ï¼ˆæ¯ç§’ï¼‰
    private long tokens;              // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime;      // ä¸Šæ¬¡è¡¥å……æ—¶é—´
    
    public TokenBucketLimiter(long capacity, long refillRate) {
        this.capacity = capacity;
        this.refillRate = refillRate;
        this.tokens = capacity;
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        refillTokens();  // è¡¥å……ä»¤ç‰Œ
        
        if (tokens > 0) {
            tokens--;    // æ¶ˆè€—ä¸€ä¸ªä»¤ç‰Œ
            return true; // å…è®¸è¯·æ±‚
        }
        
        return false;    // é™æµæ‹’ç»
    }
    
    private void refillTokens() {
        long now = System.currentTimeMillis();
        long timePassed = now - lastRefillTime;
        
        // è®¡ç®—åº”è¯¥è¡¥å……çš„ä»¤ç‰Œæ•°
        long tokensToAdd = timePassed * refillRate / 1000;
        
        if (tokensToAdd > 0) {
            tokens = Math.min(capacity, tokens + tokensToAdd);
            lastRefillTime = now;
        }
    }
}
```

### 4.3 é™æµå®é™…åº”ç”¨


**ğŸ”§ Spring Cloud Gatewayé™æµ**

```yaml
# â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€é…ç½®

spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100    # æ¯ç§’è¡¥å……ä»¤ç‰Œæ•°
                redis-rate-limiter.burstCapacity: 200    # ä»¤ç‰Œæ¡¶å®¹é‡
                redis-rate-limiter.requestedTokens: 1    # æ¯ä¸ªè¯·æ±‚æ¶ˆè€—ä»¤ç‰Œæ•°
```

**ğŸ”§ Sentinelé™æµ**

```java
// â­ éš¾åº¦ï¼šâ­â­ æ³¨è§£æ–¹å¼

@RestController
public class UserController {
    
    @SentinelResource(
        value = "getUserInfo",
        blockHandler = "getUserInfoBlocked",  // é™æµé™çº§æ–¹æ³•
        fallback = "getUserInfoFallback"      // å¼‚å¸¸é™çº§æ–¹æ³•
    )
    @GetMapping("/user/{id}")
    public Result<User> getUserInfo(@PathVariable Long id) {
        return Result.success(userService.getUser(id));
    }
    
    // é™æµæ—¶çš„å¤„ç†æ–¹æ³•
    public Result<User> getUserInfoBlocked(Long id, BlockException ex) {
        return Result.error("è®¿é—®é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    // å¼‚å¸¸æ—¶çš„å¤„ç†æ–¹æ³•
    public Result<User> getUserInfoFallback(Long id, Throwable ex) {
        return Result.error("æœåŠ¡æš‚ä¸å¯ç”¨");
    }
}
```

### 4.4 é™çº§ç­–ç•¥


**ğŸ“‹ é™çº§ç­–ç•¥åˆ†ç±»**

> **âœ… æœåŠ¡é™çº§**ï¼šå…³é—­éæ ¸å¿ƒåŠŸèƒ½ï¼Œä¿è¯æ ¸å¿ƒä¸šåŠ¡
> - å•†å“æ¨èæœåŠ¡åœæ­¢ â†’ æ˜¾ç¤ºçƒ­é—¨å•†å“
> - è¯„è®ºåŠŸèƒ½å…³é—­ â†’ æ˜¾ç¤º"è¯„è®ºåŠ è½½ä¸­"
> - å¤æ‚è®¡ç®—ç®€åŒ– â†’ è¿”å›é¢„è®¾ç»“æœ

> **âœ… åŠŸèƒ½é™çº§**ï¼šç®€åŒ–ä¸šåŠ¡æµç¨‹ï¼Œæå‡æ€§èƒ½  
> - å®æ—¶åº“å­˜ â†’ æ˜¾ç¤ºé¢„ä¼°åº“å­˜
> - ä¸ªæ€§åŒ–æ¨è â†’ æ˜¾ç¤ºé€šç”¨æ¨è
> - è¯¦ç»†æ—¥å¿— â†’ åªè®°å½•é”™è¯¯æ—¥å¿—

> **âœ… è¯»å†™é™çº§**ï¼šè¯»å†™åˆ†ç¦»ï¼Œä¿æŠ¤æ ¸å¿ƒæ•°æ®
> - åœæ­¢å†™æ“ä½œ â†’ åªå…è®¸è¯»æ“ä½œ
> - åœæ­¢å¤æ‚æŸ¥è¯¢ â†’ åªå…è®¸ä¸»é”®æŸ¥è¯¢
> - åœæ­¢ç»Ÿè®¡åˆ†æ â†’ è¿”å›ç¼“å­˜æ•°æ®

---

## 5. ğŸ”’ æ•…éšœéš”ç¦»æœºåˆ¶


### 5.1 éš”ç¦»çš„å¿…è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦æ•…éšœéš”ç¦»**

```
æ²¡æœ‰éš”ç¦»çš„é—®é¢˜ï¼š
æœåŠ¡Aæ•…éšœ â†’ å½±å“æœåŠ¡B â†’ å½±å“æœåŠ¡C â†’ æ•´ä¸ªç³»ç»Ÿå´©æºƒ

æ•…éšœéš”ç¦»çš„æ•ˆæœï¼š
æœåŠ¡Aæ•…éšœ â†’ éš”ç¦»æ•…éšœå½±å“ â†’ æœåŠ¡Bã€Cæ­£å¸¸è¿è¡Œ
```

**ç”Ÿæ´»ä¸­çš„éš”ç¦»ä¾‹å­**ï¼š
- ğŸ  æˆ¿å±‹é˜²ç«å¢™ - ç«ç¾ä¸è”“å»¶åˆ°å…¶ä»–æˆ¿é—´
- âš¡ ç”µè·¯æ–­è·¯å™¨ - çŸ­è·¯ä¸å½±å“å…¶ä»–ç”µè·¯  
- ğŸš¢ èˆ¹èˆ±éš”æ¿ - è¿›æ°´ä¸å½±å“å…¶ä»–èˆ±å®¤

### 5.2 éš”ç¦»ç­–ç•¥


#### ğŸ¯ **çº¿ç¨‹éš”ç¦»**


```java
// â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€éš”ç¦»

@Configuration
public class ThreadIsolationConfig {
    
    // ç”¨æˆ·æœåŠ¡ä¸“ç”¨çº¿ç¨‹æ± 
    @Bean("userThreadPool")
    public Executor userThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(50);
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("user-service-");
        
        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…è¿è¡Œ
        executor.setRejectedExecutionHandler(
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
        
        return executor;
    }
    
    // è®¢å•æœåŠ¡ä¸“ç”¨çº¿ç¨‹æ±   
    @Bean("orderThreadPool")
    public Executor orderThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(8);
        executor.setMaxPoolSize(15);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("order-service-");
        return executor;
    }
}

// ä½¿ç”¨çº¿ç¨‹éš”ç¦»
@Service
public class BusinessService {
    
    @Async("userThreadPool")
    public CompletableFuture<User> getUserAsync(Long id) {
        return CompletableFuture.completedFuture(
            userService.getUser(id)
        );
    }
    
    @Async("orderThreadPool") 
    public CompletableFuture<Order> getOrderAsync(Long id) {
        return CompletableFuture.completedFuture(
            orderService.getOrder(id)
        );
    }
}
```

#### ğŸ¯ **è¿›ç¨‹éš”ç¦»**


```
è¿›ç¨‹éš”ç¦»éƒ¨ç½²ï¼š

å•æœºéƒ¨ç½²ï¼ˆå…±äº«èµ„æºï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   JVMè¿›ç¨‹       â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”  â”‚
â”‚  â”‚æœåŠ¡Aâ”‚æœåŠ¡Bâ”‚æœåŠ¡Câ”‚  â”‚
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šæœåŠ¡Aå†…å­˜æ³„æ¼å½±å“æœåŠ¡Bã€C

è¿›ç¨‹éš”ç¦»éƒ¨ç½²ï¼š
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚JVM1 â”‚  â”‚JVM2 â”‚  â”‚JVM3 â”‚
â”‚æœåŠ¡A â”‚  â”‚æœåŠ¡B â”‚  â”‚æœåŠ¡C â”‚
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼šæ•…éšœå½±å“èŒƒå›´å°ï¼Œèµ„æºç‹¬ç«‹
ç¼ºç‚¹ï¼šèµ„æºå¼€é”€å¤§ï¼Œéƒ¨ç½²å¤æ‚
```

#### ğŸ¯ **é›†ç¾¤éš”ç¦»**


```
åœ°ç†ä½ç½®éš”ç¦»ï¼š

æœºæˆ¿A          æœºæˆ¿B          æœºæˆ¿C
â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡â”‚       â”‚ç”¨æˆ·æœåŠ¡â”‚       â”‚ç”¨æˆ·æœåŠ¡â”‚
â”‚è®¢å•æœåŠ¡â”‚       â”‚è®¢å•æœåŠ¡â”‚       â”‚è®¢å•æœåŠ¡â”‚
â”‚æ”¯ä»˜æœåŠ¡â”‚       â”‚æ”¯ä»˜æœåŠ¡â”‚       â”‚æ”¯ä»˜æœåŠ¡â”‚
â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”˜

ç½‘ç»œåˆ†åŒºéš”ç¦»ï¼š

æ ¸å¿ƒä¸šåŠ¡åŒº                 éæ ¸å¿ƒä¸šåŠ¡åŒº
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡    â”‚           â”‚ æ¨èæœåŠ¡    â”‚
â”‚ è®¢å•æœåŠ¡    â”‚           â”‚ ç»Ÿè®¡æœåŠ¡    â”‚
â”‚ æ”¯ä»˜æœåŠ¡    â”‚           â”‚ æœç´¢æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 éš”ç¦»ç›‘æ§


```java
// â­ éš¾åº¦ï¼šâ­â­â­ é«˜çº§ç›‘æ§

@Component
public class IsolationMonitor {
    
    private final MeterRegistry meterRegistry;
    
    // ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€
    @EventListener
    public void monitorThreadPool(ThreadPoolTaskExecutor executor) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        // è®°å½•çº¿ç¨‹æ± å…³é”®æŒ‡æ ‡
        Gauge.builder("thread.pool.active")
            .tag("pool", executor.getThreadNamePrefix())
            .register(meterRegistry, executor, ThreadPoolTaskExecutor::getActiveCount);
            
        Gauge.builder("thread.pool.queue.size")
            .tag("pool", executor.getThreadNamePrefix())
            .register(meterRegistry, executor, e -> e.getQueueSize());
    }
    
    // ç›‘æ§æœåŠ¡è°ƒç”¨éš”ç¦»æƒ…å†µ
    @Around("@annotation(org.springframework.web.bind.annotation.RequestMapping)")
    public Object monitorServiceCall(ProceedingJoinPoint joinPoint) throws Throwable {
        String serviceName = joinPoint.getTarget().getClass().getSimpleName();
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            Object result = joinPoint.proceed();
            sample.stop(Timer.builder("service.call")
                .tag("service", serviceName)
                .tag("result", "success")
                .register(meterRegistry));
            return result;
        } catch (Exception ex) {
            sample.stop(Timer.builder("service.call")
                .tag("service", serviceName) 
                .tag("result", "failure")
                .register(meterRegistry));
            throw ex;
        }
    }
}
```

---

## 6. ğŸ›‘ ä¼˜é›…åœæœº


### 6.1 ä¼˜é›…åœæœºçš„å«ä¹‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¼˜é›…åœæœº**

ä¼˜é›…åœæœºå°±æ˜¯**è®©ç³»ç»Ÿå¹³ç¨³åœ°å…³é—­ï¼Œè€Œä¸æ˜¯çªç„¶æ–­ç”µ**ã€‚

```
éä¼˜é›…åœæœºçš„é—®é¢˜ï¼š
æ­£åœ¨å¤„ç†çš„è¯·æ±‚ â†’ çªç„¶ä¸­æ–­ â†’ æ•°æ®ä¸ä¸€è‡´
æ•°æ®åº“äº‹åŠ¡ â†’ çªç„¶å›æ»š â†’ ä¸šåŠ¡å¼‚å¸¸
æ–‡ä»¶å†™å…¥ â†’ çªç„¶ä¸­æ–­ â†’ æ–‡ä»¶æŸå

ä¼˜é›…åœæœºçš„æ•ˆæœï¼š  
æ­£åœ¨å¤„ç†çš„è¯·æ±‚ â†’ ç­‰å¾…å®Œæˆ â†’ å®‰å…¨å…³é—­
æ•°æ®åº“äº‹åŠ¡ â†’ æ­£å¸¸æäº¤ â†’ æ•°æ®ä¸€è‡´
æ–‡ä»¶å†™å…¥ â†’ æ­£å¸¸å®Œæˆ â†’ æ–‡ä»¶å®Œæ•´
```

### 6.2 ä¼˜é›…åœæœºæµç¨‹


**ğŸ“‹ åœæœºæµç¨‹è®¾è®¡**

```
ç¬¬1æ­¥ï¼šåœæ­¢æ¥æ”¶æ–°è¯·æ±‚
   â†“
ç¬¬2æ­¥ï¼šç­‰å¾…ç°æœ‰è¯·æ±‚å¤„ç†å®Œæˆ
   â†“  
ç¬¬3æ­¥ï¼šå…³é—­æ•°æ®åº“è¿æ¥æ± 
   â†“
ç¬¬4æ­¥ï¼šæ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
   â†“
ç¬¬5æ­¥ï¼šå‘é€åœæœºé€šçŸ¥
   â†“
ç¬¬6æ­¥ï¼šæ­£å¼å…³é—­åº”ç”¨
```

### 6.3 ä¼˜é›…åœæœºå®ç°


**ğŸ”§ Spring Bootä¼˜é›…åœæœº**

```yaml
# â­ éš¾åº¦ï¼šâ­ åŸºç¡€é…ç½®

# application.yml
server:
  shutdown: graceful           # å¯ç”¨ä¼˜é›…åœæœº

spring:
  lifecycle:
    timeout-per-shutdown-phase: 30s    # æ¯ä¸ªé˜¶æ®µæœ€å¤§ç­‰å¾…æ—¶é—´

management:
  endpoint:
    shutdown:
      enabled: true           # å¯ç”¨å…³é—­ç«¯ç‚¹
  endpoints:
    web:
      exposure:
        include: health,info,shutdown
```

**ğŸ”§ è‡ªå®šä¹‰ä¼˜é›…åœæœºå¤„ç†**

```java
// â­ éš¾åº¦ï¼šâ­â­ è‡ªå®šä¹‰å¤„ç†

@Component
public class GracefulShutdownHandler {
    
    private static final Logger log = LoggerFactory.getLogger(GracefulShutdownHandler.class);
    
    @Autowired
    private ThreadPoolTaskExecutor taskExecutor;
    
    @Autowired  
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç›‘å¬å…³é—­äº‹ä»¶
    @EventListener
    public void handleContextClosedEvent(ContextClosedEvent event) {
        log.info("å¼€å§‹æ‰§è¡Œä¼˜é›…åœæœºæµç¨‹...");
        
        // 1. åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
        taskExecutor.setWaitForTasksToCompleteOnShutdown(true);
        taskExecutor.setAwaitTerminationSeconds(30);
        
        // 2. æ¸…ç†ç¼“å­˜æ•°æ®
        cleanupCache();
        
        // 3. å…³é—­å¤–éƒ¨è¿æ¥
        closeExternalConnections();
        
        // 4. å‘é€åœæœºé€šçŸ¥
        sendShutdownNotification();
        
        log.info("ä¼˜é›…åœæœºæµç¨‹æ‰§è¡Œå®Œæˆ");
    }
    
    private void cleanupCache() {
        try {
            // æ¸…ç†Redisç¼“å­˜ä¸­çš„ä¸´æ—¶æ•°æ®
            Set<String> keys = redisTemplate.keys("temp:*");
            if (keys != null && !keys.isEmpty()) {
                redisTemplate.delete(keys);
                log.info("æ¸…ç†ä¸´æ—¶ç¼“å­˜æ•°æ®: {} æ¡", keys.size());
            }
        } catch (Exception e) {
            log.error("æ¸…ç†ç¼“å­˜å¤±è´¥", e);
        }
    }
    
    private void closeExternalConnections() {
        // å…³é—­HTTPè¿æ¥æ± ã€MQè¿æ¥ç­‰
        log.info("å…³é—­å¤–éƒ¨è¿æ¥...");
    }
    
    private void sendShutdownNotification() {
        // é€šçŸ¥å…¶ä»–æœåŠ¡æœ¬æœåŠ¡å³å°†ä¸‹çº¿
        log.info("å‘é€åœæœºé€šçŸ¥...");
    }
}
```

**ğŸ”§ å¥åº·æ£€æŸ¥é…åˆåœæœº**

```java
// â­ éš¾åº¦ï¼šâ­â­ å¥åº·æ£€æŸ¥

@Component
public class GracefulShutdownHealthIndicator implements HealthIndicator {
    
    private volatile boolean shutdownInitiated = false;
    
    @Override
    public Health health() {
        if (shutdownInitiated) {
            return Health.down()
                    .withDetail("status", "shutting-down")
                    .withDetail("message", "åº”ç”¨æ­£åœ¨å…³é—­ï¼Œä¸æ¥æ”¶æ–°è¯·æ±‚")
                    .build();
        }
        
        return Health.up()
                .withDetail("status", "ready")
                .build();
    }
    
    @EventListener
    public void handleShutdownEvent(ContextClosedEvent event) {
        shutdownInitiated = true;
    }
}
```

---

## 7. ğŸ”„ ç¾å¤‡æ¢å¤ç­–ç•¥


### 7.1 ç¾å¤‡çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç¾å¤‡**

ç¾å¤‡å°±æ˜¯**ä¸ºäº†åº”å¯¹å„ç§ç¾éš¾æƒ…å†µè€Œæå‰å‡†å¤‡çš„å¤‡ç”¨æ–¹æ¡ˆ**ã€‚

```
å¸¸è§ç¾éš¾æƒ…å†µï¼š
ğŸ”¥ æœºæˆ¿ç«ç¾ â†’ æ•´ä¸ªæ•°æ®ä¸­å¿ƒä¸å¯ç”¨
âš¡ æ–­ç”µæ•…éšœ â†’ æœåŠ¡å™¨å…¨éƒ¨å…³æœº
ğŸŒŠ è‡ªç„¶ç¾å®³ â†’ æ•´ä¸ªåœ°åŒºç½‘ç»œä¸­æ–­
ğŸ’¾ ç¡¬ç›˜æŸå â†’ æ•°æ®æ°¸ä¹…ä¸¢å¤±
ğŸ› è½¯ä»¶bug â†’ ç³»ç»Ÿé€»è¾‘é”™è¯¯

ç¾å¤‡åº”å¯¹æ–¹æ¡ˆï¼š
ğŸ”¥ å¼‚åœ°æœºæˆ¿ â†’ åˆ‡æ¢åˆ°å…¶ä»–æ•°æ®ä¸­å¿ƒ
âš¡ å¤‡ç”¨ç”µæº â†’ UPSã€æŸ´æ²¹å‘ç”µæœº
ğŸŒŠ å¤šåœ°éƒ¨ç½² â†’ åˆ†æ•£é£é™©
ğŸ’¾ æ•°æ®å¤‡ä»½ â†’ å®šæœŸå¤‡ä»½åˆ°å¤šä¸ªä½ç½®  
ğŸ› ç‰ˆæœ¬å›æ»š â†’ å¿«é€Ÿå›é€€åˆ°ç¨³å®šç‰ˆæœ¬
```

### 7.2 ç¾å¤‡ç­‰çº§åˆ†ç±»


| ç­‰çº§ | **RTO** | **RPO** | **æ–¹æ¡ˆ** | **æˆæœ¬** | **é€‚ç”¨åœºæ™¯** |
|-----|---------|---------|---------|---------|-------------|
| ğŸŸ¢ **å†·å¤‡** | `æ•°å°æ—¶-æ•°å¤©` | `æ•°å°æ—¶` | `å®šæœŸå¤‡ä»½ï¼Œæ‰‹åŠ¨æ¢å¤` | `ä½` | `éå…³é”®ä¸šåŠ¡` |
| ğŸŸ¡ **æ¸©å¤‡** | `æ•°åˆ†é’Ÿ-æ•°å°æ—¶` | `æ•°åˆ†é’Ÿ` | `å®šæœŸåŒæ­¥ï¼ŒåŠè‡ªåŠ¨åˆ‡æ¢` | `ä¸­` | `ä¸€èˆ¬é‡è¦ä¸šåŠ¡` |
| ğŸ”´ **çƒ­å¤‡** | `ç§’çº§-åˆ†é’Ÿçº§` | `ç§’çº§` | `å®æ—¶åŒæ­¥ï¼Œè‡ªåŠ¨åˆ‡æ¢` | `é«˜` | `æ ¸å¿ƒå…³é”®ä¸šåŠ¡` |

> **RTO**ï¼šRecovery Time Objectiveï¼ˆæ¢å¤æ—¶é—´ç›®æ ‡ï¼‰- ç³»ç»Ÿæ¢å¤éœ€è¦å¤šé•¿æ—¶é—´
> **RPO**ï¼šRecovery Point Objectiveï¼ˆæ¢å¤ç‚¹ç›®æ ‡ï¼‰- æœ€å¤šèƒ½ä¸¢å¤±å¤šå°‘æ•°æ®

### 7.3 æ•°æ®å¤‡ä»½ç­–ç•¥


**ğŸ”§ æ•°æ®åº“å¤‡ä»½**

```yaml
# â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€å¤‡ä»½

# æ•°æ®åº“å¤‡ä»½é…ç½®
backup:
  database:
    # å…¨é‡å¤‡ä»½ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
    full-backup:
      schedule: "0 0 2 * * ?"
      retention-days: 30
      backup-path: "/backup/full"
      
    # å¢é‡å¤‡ä»½ï¼ˆæ¯2å°æ—¶ä¸€æ¬¡ï¼‰  
    incremental-backup:
      schedule: "0 0 */2 * * ?"
      retention-days: 7
      backup-path: "/backup/incremental"
      
    # æ—¥å¿—å¤‡ä»½ï¼ˆå®æ—¶ï¼‰
    log-backup:
      enabled: true
      backup-path: "/backup/logs"
```

```java
// â­ éš¾åº¦ï¼šâ­â­â­ å¤‡ä»½æœåŠ¡å®ç°

@Service
public class DatabaseBackupService {
    
    @Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void performFullBackup() {
        String backupFile = String.format("full_backup_%s.sql", 
            LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss")));
        
        try {
            // æ‰§è¡Œæ•°æ®åº“å…¨é‡å¤‡ä»½
            ProcessBuilder pb = new ProcessBuilder(
                "mysqldump",
                "-u", "username",
                "-p", "password", 
                "--all-databases",
                "--single-transaction",
                "--routines",
                "--triggers"
            );
            
            Process process = pb.start();
            
            // å°†è¾“å‡ºå†™å…¥å¤‡ä»½æ–‡ä»¶
            try (FileOutputStream fos = new FileOutputStream("/backup/full/" + backupFile)) {
                process.getInputStream().transferTo(fos);
            }
            
            if (process.waitFor() == 0) {
                log.info("å…¨é‡å¤‡ä»½æˆåŠŸ: {}", backupFile);
                
                // ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨
                uploadToRemoteStorage(backupFile);
                
                // æ¸…ç†æ—§å¤‡ä»½
                cleanupOldBackups(30);
            }
        } catch (Exception e) {
            log.error("å…¨é‡å¤‡ä»½å¤±è´¥", e);
            sendAlertNotification("æ•°æ®åº“å¤‡ä»½å¤±è´¥", e.getMessage());
        }
    }
    
    private void uploadToRemoteStorage(String backupFile) {
        // ä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼ˆå¦‚é˜¿é‡Œäº‘OSSã€AWS S3ç­‰ï¼‰
        log.info("ä¸Šä¼ å¤‡ä»½æ–‡ä»¶åˆ°è¿œç¨‹å­˜å‚¨: {}", backupFile);
    }
}
```

### 7.4 æœåŠ¡å®¹ç¾åˆ‡æ¢


**ğŸ”§ è‡ªåŠ¨æ•…éšœåˆ‡æ¢**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ é«˜çº§å®¹ç¾

@Component
public class DisasterRecoveryManager {
    
    private final List<String> primaryDataCenters = Arrays.asList("dc1", "dc2");
    private final List<String> backupDataCenters = Arrays.asList("dc3", "dc4");
    
    @Autowired
    private EurekaClient eurekaClient;
    
    // ç›‘æ§ä¸»æ•°æ®ä¸­å¿ƒçŠ¶æ€
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorPrimaryDataCenters() {
        for (String dc : primaryDataCenters) {
            if (!isDataCenterHealthy(dc)) {
                log.warn("ä¸»æ•°æ®ä¸­å¿ƒå¼‚å¸¸: {}", dc);
                triggerFailover(dc);
            }
        }
    }
    
    private boolean isDataCenterHealthy(String dataCenterName) {
        try {
            // æ£€æŸ¥æ•°æ®ä¸­å¿ƒå…³é”®æœåŠ¡æ˜¯å¦æ­£å¸¸
            List<InstanceInfo> instances = eurekaClient.getInstancesByVipAddress(
                "core-service", false);
            
            long healthyCount = instances.stream()
                .filter(instance -> dataCenterName.equals(instance.getDataCenterInfo().getName()))
                .filter(instance -> instance.getStatus() == InstanceInfo.InstanceStatus.UP)
                .count();
            
            return healthyCount > 0;
        } catch (Exception e) {
            log.error("æ£€æŸ¥æ•°æ®ä¸­å¿ƒå¥åº·çŠ¶æ€å¤±è´¥: {}", dataCenterName, e);
            return false;
        }
    }
    
    private void triggerFailover(String failedDc) {
        log.info("å¼€å§‹æ‰§è¡Œå®¹ç¾åˆ‡æ¢ï¼Œæ•…éšœæ•°æ®ä¸­å¿ƒ: {}", failedDc);
        
        // 1. åœæ­¢å‘æ•…éšœæ•°æ®ä¸­å¿ƒå‘é€æµé‡
        updateLoadBalancerConfig(failedDc, false);
        
        // 2. æ¿€æ´»å¤‡ç”¨æ•°æ®ä¸­å¿ƒ
        activateBackupDataCenter();
        
        // 3. æ•°æ®åŒæ­¥æ£€æŸ¥
        verifyDataConsistency();
        
        // 4. å‘é€å‘Šè­¦é€šçŸ¥
        sendDisasterRecoveryAlert(failedDc);
        
        log.info("å®¹ç¾åˆ‡æ¢å®Œæˆ");
    }
    
    private void updateLoadBalancerConfig(String dataCenterName, boolean enabled) {
        // æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®ï¼Œåœæ­¢å‘æ•…éšœæ•°æ®ä¸­å¿ƒå‘é€æµé‡
        log.info("æ›´æ–°è´Ÿè½½å‡è¡¡é…ç½®: {} -> {}", dataCenterName, enabled ? "å¯ç”¨" : "ç¦ç”¨");
    }
    
    private void activateBackupDataCenter() {
        // æ¿€æ´»å¤‡ç”¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡
        for (String backupDc : backupDataCenters) {
            log.info("æ¿€æ´»å¤‡ç”¨æ•°æ®ä¸­å¿ƒ: {}", backupDc);
            // å¯åŠ¨å¤‡ç”¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å®ä¾‹
        }
    }
}
```

---

## 8. ğŸŒ å¤šæ´»æ¶æ„


### 8.1 å¤šæ´»æ¶æ„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤šæ´»æ¶æ„**

å¤šæ´»å°±æ˜¯**å¤šä¸ªæ•°æ®ä¸­å¿ƒåŒæ—¶æä¾›æœåŠ¡ï¼Œè€Œä¸æ˜¯ä¸»å¤‡å…³ç³»**ã€‚

```
ä¼ ç»Ÿä¸»å¤‡æ¶æ„ï¼š
ä¸»æœºæˆ¿ï¼ˆå¤„ç†100%æµé‡ï¼‰     å¤‡æœºæˆ¿ï¼ˆå¾…æœºçŠ¶æ€ï¼‰
     â†“                       â†“
   æ­£å¸¸æœåŠ¡              æ•…éšœæ—¶æ‰å¯ç”¨
   
å¤šæ´»æ¶æ„ï¼š
æœºæˆ¿Aï¼ˆå¤„ç†30%æµé‡ï¼‰  æœºæˆ¿Bï¼ˆå¤„ç†40%æµé‡ï¼‰  æœºæˆ¿Cï¼ˆå¤„ç†30%æµé‡ï¼‰
     â†“                   â†“                   â†“
   åŒæ—¶æä¾›æœåŠ¡          åŒæ—¶æä¾›æœåŠ¡          åŒæ—¶æä¾›æœåŠ¡

ä¼˜ç‚¹ï¼šèµ„æºåˆ©ç”¨ç‡é«˜ï¼Œæ•…éšœå½±å“èŒƒå›´å°
ç¼ºç‚¹ï¼šæ•°æ®ä¸€è‡´æ€§å¤æ‚ï¼Œæˆæœ¬è¾ƒé«˜
```

### 8.2 å¤šæ´»æ¶æ„æ¨¡å¼


**ğŸ“‹ å¤šæ´»æ¨¡å¼åˆ†ç±»**

| æ¨¡å¼ç±»å‹ | **æ•°æ®åˆ†å¸ƒ** | **ä¸€è‡´æ€§** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-----------|-----------|-------------|
| ğŸŒ **åŒåŸå¤šæ´»** | `åŒæ­¥å¤åˆ¶` | `å¼ºä¸€è‡´æ€§` | `ä¸­ç­‰` | `é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ` |
| ğŸŒ **å¼‚åœ°å¤šæ´»** | `å¼‚æ­¥å¤åˆ¶` | `æœ€ç»ˆä¸€è‡´æ€§` | `é«˜` | `ç”µå•†ã€ç¤¾äº¤åº”ç”¨` |
| ğŸ—ï¸ **å•å…ƒåŒ–æ¶æ„** | `æ•°æ®åˆ†ç‰‡` | `å•å…ƒå†…å¼ºä¸€è‡´` | `æœ€é«˜` | `è¶…å¤§è§„æ¨¡ç³»ç»Ÿ` |

### 8.3 æ•°æ®ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ


**ğŸ”§ åˆ†å¸ƒå¼äº‹åŠ¡**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ é«˜çº§åˆ†å¸ƒå¼äº‹åŠ¡

@Service
public class MultiActiveTransactionService {
    
    @Autowired
    private List<DataSource> dataSources; // å¤šä¸ªæ•°æ®ä¸­å¿ƒçš„æ•°æ®æº
    
    // ä½¿ç”¨Seataå¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡
    @GlobalTransactional(rollbackFor = Exception.class)
    public void processOrderWithMultiActive(OrderRequest request) {
        try {
            // åœ¨ä¸»æ•°æ®ä¸­å¿ƒåˆ›å»ºè®¢å•
            Order order = createOrderInPrimaryDC(request);
            
            // åœ¨å¤‡æ•°æ®ä¸­å¿ƒåŒæ­¥åˆ›å»º
            syncOrderToBackupDCs(order);
            
            // å¤„ç†æ”¯ä»˜
            processPayment(order);
            
            // æ›´æ–°åº“å­˜ï¼ˆåˆ†å¸ƒåœ¨ä¸åŒæ•°æ®ä¸­å¿ƒï¼‰
            updateInventoryInAllDCs(order);
            
        } catch (Exception e) {
            log.error("å¤šæ´»äº‹åŠ¡å¤„ç†å¤±è´¥", e);
            throw e; // è§¦å‘åˆ†å¸ƒå¼äº‹åŠ¡å›æ»š
        }
    }
    
    private Order createOrderInPrimaryDC(OrderRequest request) {
        // åœ¨ä¸»æ•°æ®ä¸­å¿ƒåˆ›å»ºè®¢å•
        return orderService.createOrder(request);
    }
    
    private void syncOrderToBackupDCs(Order order) {
        // å¼‚æ­¥åŒæ­¥åˆ°å…¶ä»–æ•°æ®ä¸­å¿ƒ
        dataSources.stream()
            .filter(ds -> !isPrimaryDataSource(ds))
            .forEach(ds -> {
                CompletableFuture.runAsync(() -> {
                    syncOrderToDataCenter(order, ds);
                });
            });
    }
}
```

**ğŸ”§ æœ€ç»ˆä¸€è‡´æ€§å®ç°**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ æœ€ç»ˆä¸€è‡´æ€§

@Component
public class EventualConsistencyManager {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æ•°æ®å˜æ›´äº‹ä»¶å‘å¸ƒ
    @EventListener
    public void handleDataChangeEvent(DataChangeEvent event) {
        // å‘å¸ƒæ•°æ®å˜æ›´æ¶ˆæ¯åˆ°æ‰€æœ‰æ•°æ®ä¸­å¿ƒ
        DataSyncMessage message = DataSyncMessage.builder()
                .eventId(UUID.randomUUID().toString())
                .eventType(event.getType())
                .data(event.getData())
                .timestamp(LocalDateTime.now())
                .sourceDataCenter(getCurrentDataCenter())
                .build();
        
        // å‘é€åˆ°å„ä¸ªæ•°æ®ä¸­å¿ƒçš„åŒæ­¥é˜Ÿåˆ—
        publishToAllDataCenters(message);
    }
    
    // æ¥æ”¶å…¶ä»–æ•°æ®ä¸­å¿ƒçš„åŒæ­¥æ¶ˆæ¯
    @RabbitListener(queues = "data.sync.queue")
    public void handleDataSyncMessage(DataSyncMessage message) {
        // é¿å…å¾ªç¯åŒæ­¥
        if (getCurrentDataCenter().equals(message.getSourceDataCenter())) {
            return;
        }
        
        try {
            // åº”ç”¨æ•°æ®å˜æ›´
            applyDataChange(message);
            
            // è®°å½•åŒæ­¥æ—¥å¿—
            recordSyncLog(message);
            
        } catch (Exception e) {
            log.error("æ•°æ®åŒæ­¥å¤±è´¥: {}", message.getEventId(), e);
            
            // åŠ å…¥é‡è¯•é˜Ÿåˆ—
            retryDataSync(message);
        }
    }
    
    private void applyDataChange(DataSyncMessage message) {
        switch (message.getEventType()) {
            case "USER_CREATED":
                userService.syncCreateUser(message.getData());
                break;
            case "ORDER_UPDATED":
                orderService.syncUpdateOrder(message.getData());
                break;
            case "INVENTORY_CHANGED":
                inventoryService.syncUpdateInventory(message.getData());
                break;
            default:
                log.warn("æœªçŸ¥çš„åŒæ­¥äº‹ä»¶ç±»å‹: {}", message.getEventType());
        }
    }
}
```

### 8.4 æµé‡åˆ†å‘ç­–ç•¥


**ğŸ”§ æ™ºèƒ½æµé‡åˆ†å‘**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ æ™ºèƒ½è·¯ç”±

@Component
public class MultiActiveTrafficRouter {
    
    private final Map<String, DataCenterMetrics> dataCenterMetrics = new ConcurrentHashMap<>();
    
    // æ ¹æ®å¤šç§å› ç´ é€‰æ‹©æœ€ä¼˜æ•°æ®ä¸­å¿ƒ
    public String selectOptimalDataCenter(RequestContext context) {
        
        // 1. æ ¹æ®ç”¨æˆ·åœ°ç†ä½ç½®
        String nearestDC = findNearestDataCenter(context.getUserLocation());
        
        // 2. æ£€æŸ¥æ•°æ®ä¸­å¿ƒè´Ÿè½½
        if (isDataCenterOverloaded(nearestDC)) {
            nearestDC = findAlternativeDataCenter(nearestDC, context);
        }
        
        // 3. è€ƒè™‘æ•°æ®äº²å’Œæ€§
        String dataAffinityDC = findDataAffinityDataCenter(context.getUserId());
        if (dataAffinityDC != null && !isDataCenterOverloaded(dataAffinityDC)) {
            nearestDC = dataAffinityDC;
        }
        
        // 4. è®°å½•è·¯ç”±å†³ç­–
        recordRoutingDecision(context, nearestDC);
        
        return nearestDC;
    }
    
    private String findNearestDataCenter(UserLocation location) {
        // æ ¹æ®åœ°ç†ä½ç½®è®¡ç®—æœ€è¿‘çš„æ•°æ®ä¸­å¿ƒ
        return dataCenterMetrics.entrySet().stream()
                .min(Comparator.comparingDouble(entry -> 
                    calculateDistance(location, entry.getValue().getLocation())))
                .map(Map.Entry::getKey)
                .orElse("default-dc");
    }
    
    private boolean isDataCenterOverloaded(String dataCenterName) {
        DataCenterMetrics metrics = dataCenterMetrics.get(dataCenterName);
        if (metrics == null) return true;
        
        // ç»¼åˆè€ƒè™‘CPUã€å†…å­˜ã€ç½‘ç»œç­‰æŒ‡æ ‡
        return metrics.getCpuUsage() > 80 || 
               metrics.getMemoryUsage() > 85 ||
               metrics.getNetworkLatency() > 100;
    }
    
    // å®šæœŸæ”¶é›†æ•°æ®ä¸­å¿ƒæŒ‡æ ‡
    @Scheduled(fixedDelay = 10000) // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
    public void updateDataCenterMetrics() {
        dataCenterMetrics.entrySet().forEach(entry -> {
            String dcName = entry.getKey();
            DataCenterMetrics metrics = collectMetricsFromDataCenter(dcName);
            dataCenterMetrics.put(dcName, metrics);
        });
    }
}
```

---

## 9. ğŸ“Š å®¹é‡è§„åˆ’


### 9.1 å®¹é‡è§„åˆ’çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å®¹é‡è§„åˆ’**

å®¹é‡è§„åˆ’å°±æ˜¯**æå‰è®¡ç®—ç³»ç»Ÿéœ€è¦å¤šå°‘èµ„æº**ï¼Œé¿å…èµ„æºä¸è¶³æˆ–æµªè´¹ã€‚

```
æ²¡æœ‰å®¹é‡è§„åˆ’çš„é—®é¢˜ï¼š
ğŸš¨ åŒ11æµé‡æš´å¢ â†’ ç³»ç»Ÿå´©æºƒ â†’ ä¸šåŠ¡æŸå¤±
ğŸ’° å¹³æ—¶èµ„æºè¿‡å‰© â†’ æˆæœ¬æµªè´¹ â†’ é¢„ç®—è¶…æ”¯
âš¡ çªå‘äº‹ä»¶ â†’ æ‰‹å¿™è„šä¹± â†’ ç”¨æˆ·ä½“éªŒå·®

æœ‰å®¹é‡è§„åˆ’çš„å¥½å¤„ï¼š
ğŸ“ˆ æå‰æ‰©å®¹ â†’ åº”å¯¹æµé‡é«˜å³° â†’ ä¸šåŠ¡ç¨³å®š
ğŸ’¡ åˆç†é…ç½® â†’ æˆæœ¬æœ€ä¼˜ â†’ é¢„ç®—å¯æ§  
âš¡ è‡ªåŠ¨ä¼¸ç¼© â†’ å¼¹æ€§åº”å¯¹ â†’ ç”¨æˆ·æ»¡æ„
```

### 9.2 å®¹é‡è¯„ä¼°æ–¹æ³•


**ğŸ“‹ è¯„ä¼°ç»´åº¦**

| ç»´åº¦ | **è¯„ä¼°æŒ‡æ ‡** | **ç›‘æ§æ–¹å¼** | **æ‰©å®¹é˜ˆå€¼** | **é¢„è­¦ç­‰çº§** |
|-----|-------------|-------------|-------------|-------------|
| ğŸ–¥ï¸ **CPU** | `ä½¿ç”¨ç‡ã€è´Ÿè½½å‡è¡¡` | `ç³»ç»Ÿç›‘æ§` | `>70%` | `ğŸŸ¡ä¸­ç­‰` |
| ğŸ’¾ **å†…å­˜** | `ä½¿ç”¨ç‡ã€GCé¢‘ç‡` | `JVMç›‘æ§` | `>80%` | `ğŸ”´é«˜çº§` |
| ğŸŒ **ç½‘ç»œ** | `å¸¦å®½ã€å»¶è¿Ÿã€ä¸¢åŒ…` | `ç½‘ç»œç›‘æ§` | `>75%` | `ğŸŸ¡ä¸­ç­‰` |
| ğŸ’¿ **å­˜å‚¨** | `IOPSã€å®¹é‡ã€å»¶è¿Ÿ` | `å­˜å‚¨ç›‘æ§` | `>85%` | `ğŸ”´é«˜çº§` |
| ğŸ‘¥ **å¹¶å‘** | `è¿æ¥æ•°ã€TPSã€QPS` | `åº”ç”¨ç›‘æ§` | `>80%è®¾è®¡å€¼` | `ğŸ”´é«˜çº§` |

**ğŸ”§ å®¹é‡è¯„ä¼°å·¥å…·**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ å®¹é‡è¯„ä¼°

@Component
public class CapacityPlanner {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    // ç³»ç»Ÿå®¹é‡è¯„ä¼°
    @Scheduled(fixedDelay = 300000) // æ¯5åˆ†é’Ÿè¯„ä¼°ä¸€æ¬¡
    public void evaluateSystemCapacity() {
        CapacityReport report = CapacityReport.builder()
                .timestamp(LocalDateTime.now())
                .cpuCapacity(evaluateCpuCapacity())
                .memoryCapacity(evaluateMemoryCapacity())
                .networkCapacity(evaluateNetworkCapacity())
                .databaseCapacity(evaluateDatabaseCapacity())
                .build();
        
        // ç”Ÿæˆå®¹é‡å»ºè®®
        List<CapacityRecommendation> recommendations = 
            generateCapacityRecommendations(report);
        
        // å¦‚æœéœ€è¦ç´§æ€¥æ‰©å®¹ï¼Œè§¦å‘å‘Šè­¦
        if (isUrgentScalingRequired(report)) {
            triggerUrgentScalingAlert(report);
        }
        
        // ä¿å­˜è¯„ä¼°ç»“æœ
        saveCapacityReport(report, recommendations);
    }
    
    private CpuCapacityInfo evaluateCpuCapacity() {
        // è·å–CPUä½¿ç”¨æƒ…å†µ
        double currentUsage = getCpuUsage();
        double averageUsage = getAverageCpuUsage(Duration.ofHours(24));
        double peakUsage = getPeakCpuUsage(Duration.ofDays(7));
        
        // é¢„æµ‹æœªæ¥è´Ÿè½½
        double predictedPeakUsage = predictFutureUsage(peakUsage, 1.2); // 20%å¢é•¿
        
        return CpuCapacityInfo.builder()
                .currentUsage(currentUsage)
                .averageUsage(averageUsage)
                .peakUsage(peakUsage)
                .predictedPeakUsage(predictedPeakUsage)
                .recommendedCoreCount(calculateRecommendedCores(predictedPeakUsage))
                .build();
    }
    
    private List<CapacityRecommendation> generateCapacityRecommendations(
            CapacityReport report) {
        List<CapacityRecommendation> recommendations = new ArrayList<>();
        
        // CPUæ‰©å®¹å»ºè®®
        if (report.getCpuCapacity().getPredictedPeakUsage() > 70) {
            recommendations.add(CapacityRecommendation.builder()
                    .type("CPU_SCALING")
                    .priority("HIGH")
                    .description("å»ºè®®å¢åŠ CPUæ ¸å¿ƒæ•°æˆ–æ‰©å®¹æœåŠ¡å™¨")
                    .estimatedCost(calculateScalingCost("CPU", 2))
                    .timeframe("1å‘¨å†…")
                    .build());
        }
        
        // å†…å­˜æ‰©å®¹å»ºè®®
        if (report.getMemoryCapacity().getPredictedPeakUsage() > 80) {
            recommendations.add(CapacityRecommendation.builder()
                    .type("MEMORY_SCALING")
                    .priority("CRITICAL")
                    .description("å»ºè®®å¢åŠ å†…å­˜å®¹é‡")
                    .estimatedCost(calculateScalingCost("MEMORY", 1.5))
                    .timeframe("3å¤©å†…")
                    .build());
        }
        
        return recommendations;
    }
}
```

### 9.3 è‡ªåŠ¨å¼¹æ€§ä¼¸ç¼©


**ğŸ”§ Kubernetes HPAé…ç½®**

```yaml
# â­ éš¾åº¦ï¼šâ­â­ åŸºç¡€è‡ªåŠ¨æ‰©å®¹

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service
  minReplicas: 2              # æœ€å°å®ä¾‹æ•°
  maxReplicas: 20             # æœ€å¤§å®ä¾‹æ•°
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPUä½¿ç”¨ç‡è¶…è¿‡70%æ‰©å®¹
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%æ‰©å®¹
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60   # æ‰©å®¹ç¨³å®šæ—¶é—´
      policies:
      - type: Pods
        value: 2              # æ¯æ¬¡æ‰©å®¹2ä¸ªå®ä¾‹
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 300  # ç¼©å®¹ç¨³å®šæ—¶é—´
      policies:
      - type: Pods
        value: 1              # æ¯æ¬¡ç¼©å®¹1ä¸ªå®ä¾‹  
        periodSeconds: 60
```

**ğŸ”§ è‡ªå®šä¹‰æŒ‡æ ‡æ‰©å®¹**

```java
// â­ éš¾åº¦ï¼šâ­â­â­ é«˜çº§è‡ªå®šä¹‰æ‰©å®¹

@Component
public class CustomAutoScaler {
    
    @Autowired
    private KubernetesClient kubernetesClient;
    
    // åŸºäºä¸šåŠ¡æŒ‡æ ‡çš„è‡ªåŠ¨æ‰©å®¹
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void performCustomScaling() {
        
        // è·å–å½“å‰ä¸šåŠ¡æŒ‡æ ‡
        BusinessMetrics metrics = collectBusinessMetrics();
        
        // è®¡ç®—æ‰€éœ€å®ä¾‹æ•°
        int requiredReplicas = calculateRequiredReplicas(metrics);
        
        // è·å–å½“å‰å®ä¾‹æ•°
        int currentReplicas = getCurrentReplicaCount("user-service");
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©ç¼©å®¹
        if (shouldScale(currentReplicas, requiredReplicas)) {
            performScaling("user-service", requiredReplicas);
        }
    }
    
    private BusinessMetrics collectBusinessMetrics() {
        return BusinessMetrics.builder()
                .qps(getCurrentQPS())                    // æ¯ç§’æŸ¥è¯¢æ•°
                .activeConnections(getActiveConnections()) // æ´»è·ƒè¿æ¥æ•°
                .queueLength(getMessageQueueLength())    // æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦
                .responseTime(getAverageResponseTime())  // å¹³å‡å“åº”æ—¶é—´
                .errorRate(getErrorRate())               // é”™è¯¯ç‡
                .build();
    }
    
    private int calculateRequiredReplicas(BusinessMetrics metrics) {
        // åŸºäºQPSè®¡ç®—æ‰€éœ€å®ä¾‹æ•°ï¼ˆæ¯ä¸ªå®ä¾‹å¤„ç†100QPSï¼‰
        int qpsBasedReplicas = (int) Math.ceil(metrics.getQps() / 100.0);
        
        // åŸºäºå“åº”æ—¶é—´è°ƒæ•´
        if (metrics.getResponseTime() > 500) {
            qpsBasedReplicas = (int) (qpsBasedReplicas * 1.5); // å¢åŠ 50%
        }
        
        // åŸºäºé”™è¯¯ç‡è°ƒæ•´
        if (metrics.getErrorRate() > 0.01) { // é”™è¯¯ç‡è¶…è¿‡1%
            qpsBasedReplicas = (int) (qpsBasedReplicas * 1.3); // å¢åŠ 30%
        }
        
        // é™åˆ¶åœ¨åˆç†èŒƒå›´å†…
        return Math.max(2, Math.min(20, qpsBasedReplicas));
    }
    
    private void performScaling(String serviceName, int targetReplicas) {
        try {
            kubernetesClient.apps().deployments()
                .inNamespace("default")
                .withName(serviceName)
                .scale(targetReplicas);
            
            log.info("æ‰§è¡Œæ‰©ç¼©å®¹: {} -> {} ä¸ªå®ä¾‹", serviceName, targetReplicas);
            
            // è®°å½•æ‰©ç¼©å®¹äº‹ä»¶
            recordScalingEvent(serviceName, targetReplicas);
            
        } catch (Exception e) {
            log.error("æ‰©ç¼©å®¹å¤±è´¥: {}", serviceName, e);
        }
    }
}
```

### 9.4 æˆæœ¬ä¼˜åŒ–ç­–ç•¥


**ğŸ’° æˆæœ¬ä¼˜åŒ–åŸåˆ™**

> **âœ… å³é…åŸåˆ™**ï¼šèµ„æºé…ç½®åˆšå¥½æ»¡è¶³éœ€æ±‚ï¼Œé¿å…è¿‡åº¦é…ç½®
> - CPUï¼šå¹³æ—¶ä½¿ç”¨ç‡60-70%ï¼Œå³°å€¼ä¸è¶…è¿‡85%
> - å†…å­˜ï¼šå¹³æ—¶ä½¿ç”¨ç‡70-80%ï¼Œå³°å€¼ä¸è¶…è¿‡90%
> - å­˜å‚¨ï¼šä½¿ç”¨ç‡ä¸è¶…è¿‡80%ï¼Œä¿ç•™20%ç¼“å†²

> **âœ… æ··åˆéƒ¨ç½²**ï¼šä¸åŒç±»å‹åº”ç”¨æ··åˆéƒ¨ç½²ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
> - CPUå¯†é›†å‹ + IOå¯†é›†å‹åº”ç”¨æ··éƒ¨
> - é«˜å³°é”™å³°çš„ä¸šåŠ¡æ··éƒ¨
> - åœ¨çº¿ä¸šåŠ¡ + ç¦»çº¿ä»»åŠ¡æ··éƒ¨

**ğŸ”§ æˆæœ¬ç›‘æ§**

```java
// â­ éš¾åº¦ï¼šâ­â­ æˆæœ¬åˆ†æ

@Component
public class CostAnalyzer {
    
    // è®¡ç®—æœåŠ¡æˆæœ¬
    public ServiceCostReport calculateServiceCost(String serviceName, 
            LocalDateTime startTime, LocalDateTime endTime) {
        
        // è·å–èµ„æºä½¿ç”¨æ•°æ®
        ResourceUsageData usage = collectResourceUsage(serviceName, startTime, endTime);
        
        // è®¡ç®—å„é¡¹æˆæœ¬
        double cpuCost = calculateCpuCost(usage.getCpuUsage());
        double memoryCost = calculateMemoryCost(usage.getMemoryUsage());
        double networkCost = calculateNetworkCost(usage.getNetworkTraffic());
        double storageCost = calculateStorageCost(usage.getStorageUsage());
        
        double totalCost = cpuCost + memoryCost + networkCost + storageCost;
        
        return ServiceCostReport.builder()
                .serviceName(serviceName)
                .period(Period.between(startTime.toLocalDate(), endTime.toLocalDate()))
                .cpuCost(cpuCost)
                .memoryCost(memoryCost)
                .networkCost(networkCost)
                .storageCost(storageCost)
                .totalCost(totalCost)
                .costOptimizationSuggestions(generateCostOptimizationSuggestions(usage))
                .build();
    }
    
    private List<CostOptimizationSuggestion> generateCostOptimizationSuggestions(
            ResourceUsageData usage) {
        List<CostOptimizationSuggestion> suggestions = new ArrayList<>();
        
        // CPUä½¿ç”¨ç‡è¿‡ä½å»ºè®®
        if (usage.getAverageCpuUsage() < 30) {
            suggestions.add(new CostOptimizationSuggestion(
                "CPU_RIGHT_SIZING",
                "CPUå¹³å‡ä½¿ç”¨ç‡è¾ƒä½ï¼Œå»ºè®®å‡å°‘CPUé…ç½®",
                calculatePotentialSavings("CPU", usage.getAverageCpuUsage())
            ));
        }
        
        // å†…å­˜ä½¿ç”¨ç‡è¿‡ä½å»ºè®®
        if (usage.getAverageMemoryUsage() < 40) {
            suggestions.add(new CostOptimizationSuggestion(
                "MEMORY_RIGHT_SIZING", 
                "å†…å­˜å¹³å‡ä½¿ç”¨ç‡è¾ƒä½ï¼Œå»ºè®®å‡å°‘å†…å­˜é…ç½®",
                calculatePotentialSavings("MEMORY", usage.getAverageMemoryUsage())
            ));
        }
        
        return suggestions;
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> ğŸ”¸ **å®¹é”™è®¾è®¡**ï¼šç†”æ–­å™¨ã€èˆ±å£ã€é™æµä¸‰å¤§æ¨¡å¼æ˜¯å¾®æœåŠ¡å®¹é”™çš„åŸºçŸ³
> 
> ğŸ”¸ **è¶…æ—¶æœºåˆ¶**ï¼šåˆç†è®¾ç½®å¤šå±‚è¶…æ—¶ï¼Œé¿å…èµ„æºè€—å°½å’Œçº§è”æ•…éšœ
> 
> ğŸ”¸ **é‡è¯•ç­–ç•¥**ï¼šæŒ‡æ•°é€€é¿é‡è¯•ï¼Œä½†å¿…é¡»ç¡®ä¿å¹‚ç­‰æ€§
> 
> ğŸ”¸ **é™æµé™çº§**ï¼šä»¤ç‰Œæ¡¶ç®—æ³•é™æµï¼Œåˆ†çº§é™çº§ä¿è¯æ ¸å¿ƒåŠŸèƒ½
> 
> ğŸ”¸ **æ•…éšœéš”ç¦»**ï¼šçº¿ç¨‹éš”ç¦»ã€è¿›ç¨‹éš”ç¦»ã€é›†ç¾¤éš”ç¦»é˜²æ­¢æ•…éšœæ‰©æ•£

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¹é”™ä¸æ˜¯é“¶å¼¹**
```
å®¹é”™åªæ˜¯å‡å°‘æ•…éšœå½±å“ï¼Œä¸èƒ½æ¶ˆé™¤æ•…éšœï¼š
- è®¾è®¡æ—¶è¦è€ƒè™‘æ•…éšœåœºæ™¯
- ç›‘æ§å’Œå‘Šè­¦åŒæ ·é‡è¦  
- äººå·¥å¹²é¢„ä»ç„¶å¿…è¦
```

**ğŸ”¹ æˆæœ¬ä¸å¯é æ€§çš„å¹³è¡¡**
```
é«˜å¯ç”¨çš„ä»£ä»·ï¼š
ğŸ’° ç¡¬ä»¶æˆæœ¬å¢åŠ ï¼ˆå¤šæœºæˆ¿ã€å†—ä½™è®¾å¤‡ï¼‰
ğŸ‘¥ äººåŠ›æˆæœ¬å¢åŠ ï¼ˆè¿ç»´ã€å¼€å‘å¤æ‚åº¦ï¼‰
â±ï¸ å¼€å‘æˆæœ¬å¢åŠ ï¼ˆè®¾è®¡ã€æµ‹è¯•æ—¶é—´ï¼‰

éœ€è¦æ ¹æ®ä¸šåŠ¡é‡è¦æ€§åˆç†é€‰æ‹©å¯ç”¨æ€§ç­‰çº§
```

**ğŸ”¹ å®¹é‡è§„åˆ’çš„é‡è¦æ€§**
```
æå‰è§„åˆ’çš„å¥½å¤„ï¼š
ğŸ“ˆ åº”å¯¹æµé‡å³°å€¼ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ
ğŸ’¡ åˆç†é…ç½®èµ„æºï¼Œæ§åˆ¶è¿è¥æˆæœ¬
âš¡ è‡ªåŠ¨å¼¹æ€§æ‰©ç¼©å®¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å®æ–½å»ºè®®**

> **é˜¶æ®µ1 - åŸºç¡€å®¹é”™**ï¼š
> - é…ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
> - å®ç°åŸºæœ¬çš„ç†”æ–­é™çº§
> - å»ºç«‹ç›‘æ§å‘Šè­¦ä½“ç³»

> **é˜¶æ®µ2 - é«˜å¯ç”¨æ¶æ„**ï¼š  
> - å®ç°å¤šæ´»æ¶æ„è®¾è®¡
> - å»ºç«‹å®Œå–„çš„ç¾å¤‡æµç¨‹
> - ä¼˜åŒ–è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥

> **é˜¶æ®µ3 - æˆæœ¬ä¼˜åŒ–**ï¼š
> - ç²¾ç¡®çš„å®¹é‡è§„åˆ’
> - æ™ºèƒ½çš„èµ„æºè°ƒåº¦
> - æŒç»­çš„æˆæœ¬ä¼˜åŒ–

**âš ï¸ å¸¸è§é™·é˜±**

> **é™·é˜±1**ï¼šè¿‡åº¦è®¾è®¡
> ```
> ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦æœ€é«˜ç­‰çº§çš„å¯ç”¨æ€§
> æ ¹æ®ä¸šåŠ¡é‡è¦æ€§åˆ†çº§è®¾è®¡
> ```

> **é™·é˜±2**ï¼šå¿½è§†ç›‘æ§
> ```
> å®¹é”™æœºåˆ¶ç”Ÿæ•ˆæ—¶æ›´éœ€è¦ç›‘æ§
> åŠæ—¶å‘ç°é—®é¢˜æ‰èƒ½å¿«é€Ÿæ¢å¤
> ```

> **é™·é˜±3**ï¼šæµ‹è¯•ä¸å……åˆ†**
> ```
> å®¹ç¾æ¼”ç»ƒå’Œå‹åŠ›æµ‹è¯•å¿…ä¸å¯å°‘
> çœŸæ­£çš„æ•…éšœå¾€å¾€æ¯”æƒ³è±¡æ›´å¤æ‚
> ```

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“ è¿›é˜¶å­¦ä¹ **

> **ğŸ“š å»¶ä¼¸é˜…è¯»**ï¼š
> - ã€Šå‘å¸ƒï¼è®¾è®¡ä¸éƒ¨ç½²ç”Ÿäº§å°±ç»ªè½¯ä»¶ã€‹
> - ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹  
> - Spring Cloudå®˜æ–¹æ–‡æ¡£

> **ğŸ› ï¸ åŠ¨æ‰‹ç»ƒä¹ **ï¼š
> - æ­å»ºå¤šæœºæˆ¿æµ‹è¯•ç¯å¢ƒ
> - æ¨¡æ‹Ÿå„ç§æ•…éšœåœºæ™¯
> - å®ç°å®Œæ•´çš„ç›‘æ§ä½“ç³»

> **ğŸš€ é¡¹ç›®å®æˆ˜**ï¼š
> - å‚ä¸ç”Ÿäº§ç¯å¢ƒå®¹ç¾æ¼”ç»ƒ
> - ä¼˜åŒ–ç°æœ‰ç³»ç»Ÿçš„å¯ç”¨æ€§
> - è®¾è®¡æ–°é¡¹ç›®çš„é«˜å¯ç”¨æ¶æ„

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å®¹é”™è®¾è®¡ä¸‰æ¿æ–§ï¼šç†”æ–­èˆ±å£åŠ é™æµ
- è¶…æ—¶é‡è¯•è¦åˆç†ï¼šå¹‚ç­‰æ£€æŸ¥ä¸èƒ½å¿˜  
- æ•…éšœéš”ç¦»é˜²æ‰©æ•£ï¼šç›‘æ§å‘Šè­¦è¦è·Ÿä¸Š
- å¤šæ´»æ¶æ„æå¯ç”¨ï¼šå®¹é‡è§„åˆ’æ§æˆæœ¬