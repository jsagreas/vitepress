---
title: 7ã€è¿›é˜¶æŒæ¡
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡æ¶æ„åŸºç¡€æ¦‚å¿µ](#1-å¾®æœåŠ¡æ¶æ„åŸºç¡€æ¦‚å¿µ)
2. [Spring Cloudç”Ÿæ€ç³»ç»Ÿæ¦‚è§ˆ](#2-Spring-Cloudç”Ÿæ€ç³»ç»Ÿæ¦‚è§ˆ)
3. [æœåŠ¡æ³¨å†Œä¸å‘ç°](#3-æœåŠ¡æ³¨å†Œä¸å‘ç°)
4. [é…ç½®ä¸­å¿ƒç®¡ç†](#4-é…ç½®ä¸­å¿ƒç®¡ç†)
5. [æœåŠ¡é—´é€šä¿¡](#5-æœåŠ¡é—´é€šä¿¡)
6. [è´Ÿè½½å‡è¡¡ä¸è·¯ç”±](#6-è´Ÿè½½å‡è¡¡ä¸è·¯ç”±)
7. [æ–­è·¯å™¨ä¸å®¹é”™æœºåˆ¶](#7-æ–­è·¯å™¨ä¸å®¹é”™æœºåˆ¶)
8. [åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª](#8-åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª)
9. [APIç½‘å…³è®¾è®¡](#9-APIç½‘å…³è®¾è®¡)
10. [è¿›é˜¶å®è·µä¸ä¼˜åŒ–](#10-è¿›é˜¶å®è·µä¸ä¼˜åŒ–)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡

ğŸ¯ **é€šä¿—ç†è§£**ï¼šå¾®æœåŠ¡å°±åƒæŠŠä¸€ä¸ªå¤§å‹è¶…å¸‚æ‹†åˆ†æˆä¸“é—¨çš„å°åº—é“º

```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼ˆå¤§è¶…å¸‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç®¡ç†  å•†å“ç®¡ç†  è®¢å•ç®¡ç†    â”‚
â”‚  æ”¯ä»˜å¤„ç†  åº“å­˜æ§åˆ¶  ç‰©æµé…é€    â”‚
â”‚  æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ä¸€ä¸ª"åº—é“º"é‡Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡æ¶æ„ï¼ˆä¸“ä¸šå°åº—ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·åº—é“ºâ”‚ â”‚å•†å“åº—é“ºâ”‚ â”‚è®¢å•åº—é“ºâ”‚ â”‚æ”¯ä»˜åº—é“ºâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
æ¯ä¸ªåº—é“ºä¸“æ³¨åšå¥½ä¸€ä»¶äº‹ï¼Œåº—é“ºé—´å¯ä»¥ç›¸äº’åˆä½œ
```

**ğŸ”¸ å¾®æœåŠ¡çš„æ ¸å¿ƒç‰¹å¾**
```
ç‹¬ç«‹éƒ¨ç½²ï¼šæ¯ä¸ªæœåŠ¡å¯ä»¥å•ç‹¬ä¸Šçº¿ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
æŠ€æœ¯å¤šæ ·ï¼šä¸åŒæœåŠ¡å¯ä»¥ç”¨ä¸åŒæŠ€æœ¯æ ˆå¼€å‘
å›¢é˜Ÿåˆ†å·¥ï¼šæ¯ä¸ªå›¢é˜Ÿè´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡é¢†åŸŸ
æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªæœåŠ¡å‡ºé—®é¢˜ï¼Œä¸ä¼šæ‹–å®æ•´ä¸ªç³»ç»Ÿ
å¼¹æ€§ä¼¸ç¼©ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå•ç‹¬æ‰©å®¹æŸä¸ªæœåŠ¡
```

### 1.2 å¾®æœåŠ¡ vs å•ä½“åº”ç”¨å¯¹æ¯”

**ğŸ“Š æ¶æ„å¯¹æ¯”åˆ†æ**

| å¯¹æ¯”ç»´åº¦ | **å•ä½“åº”ç”¨** | **å¾®æœåŠ¡æ¶æ„** |
|---------|-------------|--------------|
| ğŸ”¸ **å¼€å‘å¤æ‚åº¦** | `ç®€å•ï¼Œä¸€ä¸ªé¡¹ç›®` | `å¤æ‚ï¼Œå¤šä¸ªé¡¹ç›®åè°ƒ` |
| ğŸ”¸ **éƒ¨ç½²æ–¹å¼** | `æ•´ä½“éƒ¨ç½²` | `ç‹¬ç«‹éƒ¨ç½²` |
| ğŸ”¸ **æŠ€æœ¯é€‰å‹** | `ç»Ÿä¸€æŠ€æœ¯æ ˆ` | `æŠ€æœ¯æ ˆå¤šæ ·åŒ–` |
| ğŸ”¸ **å›¢é˜Ÿè§„æ¨¡** | `å°å›¢é˜Ÿé€‚åˆ` | `å¤§å›¢é˜Ÿåä½œ` |
| ğŸ”¸ **æ•…éšœå½±å“** | `å…¨ç³»ç»Ÿå—å½±å“` | `æ•…éšœéš”ç¦»` |
| ğŸ”¸ **æ€§èƒ½å¼€é”€** | `è¿›ç¨‹å†…è°ƒç”¨` | `ç½‘ç»œè°ƒç”¨å¼€é”€` |
| ğŸ”¸ **æ•°æ®ä¸€è‡´æ€§** | `ACIDäº‹åŠ¡` | `æœ€ç»ˆä¸€è‡´æ€§` |

### 1.3 ä»€ä¹ˆæ—¶å€™é€‰æ‹©å¾®æœåŠ¡

**ğŸ¤” å¾®æœåŠ¡é€‰æ‹©çš„åˆ¤æ–­æ ‡å‡†**

```
âœ… é€‚åˆå¾®æœåŠ¡çš„åœºæ™¯ï¼š
â€¢ å›¢é˜Ÿè§„æ¨¡å¤§ï¼ˆè¶…è¿‡20äººï¼‰
â€¢ ä¸šåŠ¡å¤æ‚åº¦é«˜ï¼Œéœ€è¦å¿«é€Ÿè¿­ä»£
â€¢ ä¸åŒæ¨¡å—æœ‰ä¸åŒçš„æ€§èƒ½è¦æ±‚
â€¢ éœ€è¦æŠ€æœ¯æ ˆå¤šæ ·æ€§
â€¢ æœ‰æˆç†Ÿçš„DevOpsèƒ½åŠ›

âŒ ä¸é€‚åˆå¾®æœåŠ¡çš„åœºæ™¯ï¼š
â€¢ å°å›¢é˜Ÿï¼ˆå°‘äº10äººï¼‰
â€¢ ä¸šåŠ¡é€»è¾‘ç®€å•
â€¢ å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜
â€¢ è¿ç»´ç»éªŒä¸è¶³
â€¢ é¡¹ç›®åˆæœŸï¼Œéœ€æ±‚å˜åŒ–é¢‘ç¹
```

**ğŸ’¡ æ¸è¿›å¼æ¼”è¿›ç­–ç•¥**
```
å¾®æœåŠ¡æ¼”è¿›è·¯å¾„ï¼š
ç¬¬ä¸€é˜¶æ®µï¼šå•ä½“åº”ç”¨ â†’ éªŒè¯ä¸šåŠ¡æ¨¡å¼
ç¬¬äºŒé˜¶æ®µï¼šæ¨¡å—åŒ–æ‹†åˆ† â†’ æ˜ç¡®è¾¹ç•Œ
ç¬¬ä¸‰é˜¶æ®µï¼šæœåŠ¡åŒ–æ”¹é€  â†’ é€æ­¥æ‹†åˆ†
ç¬¬å››é˜¶æ®µï¼šå¾®æœåŠ¡æ²»ç† â†’ å®Œå–„å·¥å…·é“¾
```

---

## 2. ğŸŒŸ Spring Cloudç”Ÿæ€ç³»ç»Ÿæ¦‚è§ˆ


### 2.1 Spring Cloudæ˜¯ä»€ä¹ˆ

ğŸ¯ **ç®€å•ç±»æ¯”**ï¼šSpring Cloudå°±åƒå¾®æœåŠ¡çš„"å·¥å…·ç®±"

```
æƒ³è±¡ä½ è¦è£…ä¿®æˆ¿å­ï¼š
å•ç‹¬ä¹°å·¥å…·ï¼šèºä¸åˆ€ã€é”¤å­ã€ç”µé’»... éœ€è¦è‡ªå·±æ­é…
å·¥å…·ç®±å¥—è£…ï¼šæ‰€æœ‰å·¥å…·é…å¥—ï¼Œç›´æ¥ä½¿ç”¨ï¼Œçœå¿ƒçœåŠ›

å¾®æœåŠ¡å¼€å‘ï¼š
è‡ªå·±æ­å»ºï¼šæœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€è´Ÿè½½å‡è¡¡... å„ç§ç»„ä»¶è‡ªå·±é€‰æ‹©æ­é…
Spring Cloudï¼šæä¾›å®Œæ•´çš„å¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œç»„ä»¶é…å¥—ï¼Œå¼€ç®±å³ç”¨
```

### 2.2 Spring Cloudæ ¸å¿ƒç»„ä»¶å®¶æ—

**ğŸ  Spring Cloudå…¨å®¶æ¡¶ç»„ä»¶å›¾**

```
Spring Cloud ç”Ÿæ€ç³»ç»Ÿæ¶æ„ï¼š

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   API Gateway   â”‚  â† ç»Ÿä¸€å…¥å£
              â”‚   (Gateway)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç”¨æˆ·æœåŠ¡  â”‚    â”‚ è®¢å•æœåŠ¡  â”‚    â”‚ å•†å“æœåŠ¡  â”‚
   â”‚(User)   â”‚    â”‚(Order)  â”‚    â”‚(Product)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  æœåŠ¡æ³¨å†Œä¸­å¿ƒ    â”‚  â† æœåŠ¡å‘ç°
              â”‚   (Eureka)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   é…ç½®ä¸­å¿ƒ      â”‚  â† é…ç½®ç®¡ç†
              â”‚  (Config)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ ¸å¿ƒç»„ä»¶åŠŸèƒ½è¯´æ˜**
```
ğŸ”¸ æœåŠ¡æ³¨å†Œä¸å‘ç°
â€¢ Eurekaï¼šæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œç®¡ç†æœåŠ¡å®ä¾‹
â€¢ Consulï¼šåˆ†å¸ƒå¼æœåŠ¡å‘ç°å’Œé…ç½®
â€¢ Zookeeperï¼šåˆ†å¸ƒå¼åè°ƒæœåŠ¡

ğŸ”¸ é…ç½®ç®¡ç†
â€¢ Spring Cloud Configï¼šé›†ä¸­åŒ–é…ç½®ç®¡ç†
â€¢ Apolloï¼šæºç¨‹å¼€æºçš„é…ç½®ä¸­å¿ƒ
â€¢ Nacosï¼šé˜¿é‡Œäº‘çš„é…ç½®å’Œæ³¨å†Œä¸­å¿ƒ

ğŸ”¸ æœåŠ¡è°ƒç”¨
â€¢ Feignï¼šå£°æ˜å¼HTTPå®¢æˆ·ç«¯
â€¢ RestTemplateï¼šSpringçš„HTTPå®¢æˆ·ç«¯
â€¢ OpenFeignï¼šFeignçš„å¢å¼ºç‰ˆæœ¬

ğŸ”¸ è´Ÿè½½å‡è¡¡
â€¢ Ribbonï¼šå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
â€¢ LoadBalancerï¼šæ–°ä¸€ä»£è´Ÿè½½å‡è¡¡å™¨

ğŸ”¸ æ–­è·¯å™¨
â€¢ Hystrixï¼šæ–­è·¯å™¨æ¨¡å¼å®ç°
â€¢ Resilience4jï¼šè½»é‡çº§æ–­è·¯å™¨åº“
â€¢ Sentinelï¼šé˜¿é‡Œäº‘æµé‡æ§åˆ¶ç»„ä»¶
```

### 2.3 ç‰ˆæœ¬å…¼å®¹æ€§é€‰æ‹©

**ğŸ“… Spring Cloudç‰ˆæœ¬å¯¹åº”å…³ç³»**

```
ç‰ˆæœ¬é€‰æ‹©æŒ‡å—ï¼š
Spring Boot 2.6.x â†â†’ Spring Cloud 2021.0.x (æ¨èç”Ÿäº§ç¯å¢ƒ)
Spring Boot 2.7.x â†â†’ Spring Cloud 2021.0.x 
Spring Boot 3.0.x â†â†’ Spring Cloud 2022.0.x (æœ€æ–°ç‰ˆæœ¬)

é€‰æ‹©åŸåˆ™ï¼š
âœ… ç”Ÿäº§ç¯å¢ƒï¼šé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼Œé¿å…æœ€æ–°ç‰ˆ
âœ… å­¦ä¹ ç¯å¢ƒï¼šå¯ä»¥å°è¯•è¾ƒæ–°ç‰ˆæœ¬çš„ç‰¹æ€§
âœ… ç‰ˆæœ¬åŒ¹é…ï¼šä¸¥æ ¼æŒ‰ç…§å®˜æ–¹å…¼å®¹æ€§è¡¨é€‰æ‹©
```

---

## 3. ğŸ“ æœåŠ¡æ³¨å†Œä¸å‘ç°


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡æ³¨å†Œä¸å‘ç°

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒç”µè¯é»„é¡µæˆ–åœ°å›¾å¯¼èˆª

```
ä¼ ç»Ÿåº”ç”¨çš„é—®é¢˜ï¼š
æˆ‘è¦è®¢å¤–å– â†’ æˆ‘å¾—çŸ¥é“é¤å…ç”µè¯å·ç  â†’ ç›´æ¥æ‹¨æ‰“
é—®é¢˜ï¼šå¦‚æœé¤å…æ¢ç”µè¯äº†æ€ä¹ˆåŠï¼Ÿ

å¾®æœåŠ¡çš„æŒ‘æˆ˜ï¼š
è®¢å•æœåŠ¡è¦è°ƒç”¨å•†å“æœåŠ¡ â†’ éœ€è¦çŸ¥é“å•†å“æœåŠ¡çš„IPå’Œç«¯å£
é—®é¢˜ï¼šæœåŠ¡å®ä¾‹ä¼šå˜åŒ–ï¼ˆæ‰©ç¼©å®¹ã€æ•…éšœé‡å¯ï¼‰

æœåŠ¡æ³¨å†Œå‘ç°çš„è§£å†³æ–¹æ¡ˆï¼š
å°±åƒç¾å›¢å¤–å–APP â†’ è‡ªåŠ¨æ‰¾åˆ°é™„è¿‘é¤å… â†’ ä¸ç”¨è®°ä½ç”µè¯å·ç 
æœåŠ¡æ³¨å†Œä¸­å¿ƒ â†’ è‡ªåŠ¨å‘ç°å¯ç”¨æœåŠ¡ â†’ ä¸ç”¨hardcodeåœ°å€
```

### 3.2 EurekaæœåŠ¡æ³¨å†Œä¸­å¿ƒ

**ğŸ¢ Eurekaå·¥ä½œåŸç†**

```
Eurekaæ¶æ„æ¨¡å‹ï¼š

æœåŠ¡æä¾›è€…                     Eureka Server                æœåŠ¡æ¶ˆè´¹è€…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†å“æœåŠ¡A   â”‚â”€â”€æ³¨å†ŒæœåŠ¡â”€â”€â”€â”€â–¶â”‚   æ³¨å†Œä¸­å¿ƒ   â”‚â—€â”€â”€â”€â”€æŸ¥è¯¢æœåŠ¡â”€â”€â”‚   è®¢å•æœåŠ¡   â”‚
â”‚  å•†å“æœåŠ¡B   â”‚              â”‚             â”‚              â”‚             â”‚
â”‚  å•†å“æœåŠ¡C   â”‚â”€â”€å‘é€å¿ƒè·³â”€â”€â”€â”€â–¶â”‚  æœåŠ¡åˆ—è¡¨   â”‚â”€â”€è¿”å›æœåŠ¡åˆ—è¡¨â”€â–¶â”‚  è´Ÿè½½å‡è¡¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¥ä½œæµç¨‹ï¼š
1. å•†å“æœåŠ¡å¯åŠ¨æ—¶ï¼Œå‘Eurekaæ³¨å†Œè‡ªå·±çš„ä¿¡æ¯
2. å•†å“æœåŠ¡å®šæœŸå‘é€å¿ƒè·³ï¼Œè¯æ˜è‡ªå·±è¿˜æ´»ç€
3. è®¢å•æœåŠ¡éœ€è¦è°ƒç”¨å•†å“æœåŠ¡æ—¶ï¼Œå…ˆæŸ¥è¯¢Eureka
4. Eurekaè¿”å›å¯ç”¨çš„å•†å“æœåŠ¡å®ä¾‹åˆ—è¡¨
5. è®¢å•æœåŠ¡ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå®ä¾‹è¿›è¡Œè°ƒç”¨
```

**ğŸ’¡ EurekaåŸºç¡€é…ç½®ç¤ºä¾‹**
```yaml
# Eureka Serveré…ç½® (application.yml)
server:
  port: 8761

eureka:
  instance:
    hostname: localhost
  client:
    registerWithEureka: false    # è‡ªå·±ä¸ç”¨æ³¨å†Œåˆ°è‡ªå·±
    fetchRegistry: false         # è‡ªå·±ä¸ç”¨ä»è‡ªå·±è·å–æœåŠ¡åˆ—è¡¨
  server:
    enableSelfPreservation: false # å¼€å‘ç¯å¢ƒå…³é—­è‡ªæˆ‘ä¿æŠ¤
```

### 3.3 æœåŠ¡æä¾›è€…é…ç½®

**ğŸª æœåŠ¡æ³¨å†Œçš„åŸºæœ¬é…ç½®**

```yaml
# å•†å“æœåŠ¡é…ç½®
spring:
  application:
    name: product-service    # æœåŠ¡åç§°ï¼Œé‡è¦ï¼

eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true  # ä½¿ç”¨IPåœ°å€æ³¨å†Œ
    lease-renewal-interval-in-seconds: 30    # å¿ƒè·³é—´éš”
    lease-expiration-duration-in-seconds: 90 # å¿ƒè·³è¶…æ—¶æ—¶é—´
```

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µè¯´æ˜**
```
æœåŠ¡åç§° (spring.application.name)ï¼š
â€¢ è¿™æ˜¯æœåŠ¡çš„èº«ä»½è¯ï¼Œæ¶ˆè´¹è€…é€šè¿‡è¿™ä¸ªåç§°æ‰¾åˆ°æœåŠ¡
â€¢ åŒä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªå®ä¾‹ä½¿ç”¨ç›¸åŒçš„æœåŠ¡åç§°

å¿ƒè·³æœºåˆ¶ï¼š
â€¢ æœåŠ¡å®ä¾‹å®šæœŸå‘Eurekaå‘é€"æˆ‘è¿˜æ´»ç€"çš„ä¿¡å·
â€¢ å¦‚æœé•¿æ—¶é—´æ²¡æœ‰å¿ƒè·³ï¼ŒEurekaä¼šæŠŠæœåŠ¡æ ‡è®°ä¸ºä¸‹çº¿

IPåœ°å€ä¼˜å…ˆï¼š
â€¢ prefer-ip-address: true ä½¿ç”¨IPè€Œä¸æ˜¯hostname
â€¢ é¿å…DNSè§£æé—®é¢˜ï¼Œåœ¨å®¹å™¨ç¯å¢ƒä¸­ç‰¹åˆ«é‡è¦
```

### 3.4 æœåŠ¡æ¶ˆè´¹è€…é…ç½®

**ğŸ›’ æœåŠ¡å‘ç°ä¸è°ƒç”¨**

```java
// å¯ç”¨Eurekaå®¢æˆ·ç«¯
@SpringBootApplication
@EnableEurekaClient  // æˆ–è€… @EnableDiscoveryClient
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

**ğŸ” æœåŠ¡å‘ç°çš„ä½¿ç”¨æ–¹å¼**
```java
// æ–¹å¼1ï¼šä½¿ç”¨RestTemplate + æœåŠ¡åè°ƒç”¨
@RestController
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @GetMapping("/order/{id}")
    public String getOrder(@PathVariable String id) {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åï¼Œä¸ç”¨å†™IPå’Œç«¯å£
        String result = restTemplate.getForObject(
            "http://product-service/product/" + id, 
            String.class
        );
        return "è®¢å•ä¿¡æ¯ï¼š" + result;
    }
}

// RestTemplateé…ç½®
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // å¯ç”¨è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

---

## 4. âš™ï¸ é…ç½®ä¸­å¿ƒç®¡ç†


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒ

ğŸ¯ **å½¢è±¡æ¯”å–»**ï¼šé…ç½®ä¸­å¿ƒå°±åƒé¥æ§å™¨ï¼Œå¯ä»¥è¿œç¨‹è°ƒæ•´è®¾ç½®

```
ä¼ ç»Ÿé…ç½®ç®¡ç†çš„é—®é¢˜ï¼š
å®¶é‡Œæ¯ä¸ªç”µå™¨éƒ½æœ‰ç‹¬ç«‹å¼€å…³ â†’ è¦è°ƒæ•´å¾—ä¸€ä¸ªä¸ªå»æ”¹
åº”ç”¨é…ç½®å†™åœ¨ä»£ç é‡Œ â†’ ä¿®æ”¹é…ç½®è¦é‡æ–°æ‰“åŒ…éƒ¨ç½²

é…ç½®ä¸­å¿ƒçš„ä»·å€¼ï¼š
ä¸‡èƒ½é¥æ§å™¨ â†’ ç»Ÿä¸€æ§åˆ¶æ‰€æœ‰ç”µå™¨
é…ç½®ä¸­å¿ƒ â†’ ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡é…ç½®

å®é™…å¥½å¤„ï¼š
â€¢ é…ç½®ä¿®æ”¹ä¸ç”¨é‡å¯æœåŠ¡
â€¢ ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
â€¢ æ•æ„Ÿä¿¡æ¯é›†ä¸­åŠ å¯†ç®¡ç†
â€¢ é…ç½®ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š
```

### 4.2 Spring Cloud ConfigåŸºç¡€

**ğŸ“ Config Serveré…ç½®ä¸­å¿ƒæ­å»º**

```
Configæ¶æ„è®¾è®¡ï¼š

Gitä»“åº“                    Config Server                 å¾®æœåŠ¡åº”ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚application- â”‚           â”‚             â”‚               â”‚             â”‚
â”‚dev.yml      â”‚â—€â”€â”€æ‹‰å–â”€â”€â”€â”€â”‚  é…ç½®ä¸­å¿ƒ   â”‚â—€â”€â”€è¯·æ±‚é…ç½®â”€â”€â”€â”€â”‚  å•†å“æœåŠ¡   â”‚
â”‚application- â”‚           â”‚             â”‚               â”‚             â”‚
â”‚prod.yml     â”‚           â”‚  Config     â”‚               â”‚  è®¢å•æœåŠ¡   â”‚
â”‚product.yml  â”‚           â”‚  Server     â”‚               â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®æ–‡ä»¶å‘½åè§„åˆ™ï¼š
{application}-{profile}.yml
ä¾‹å¦‚ï¼šproduct-dev.yml, product-prod.yml
```

**ğŸ”§ Config ServeråŸºæœ¬é…ç½®**
```yaml
# Config Serveré…ç½®
server:
  port: 8888

spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git:
          uri: https://github.com/yourname/config-repo
          username: your-username
          password: your-password
          clone-on-start: true  # å¯åŠ¨æ—¶å…‹éš†ä»“åº“
          
eureka:
  client:
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
```

### 4.3 å®¢æˆ·ç«¯é…ç½®è·å–

**ğŸ“¥ æœåŠ¡å¦‚ä½•è·å–é…ç½®**

```yaml
# bootstrap.yml (ä¼˜å…ˆçº§æ¯”application.ymlé«˜)
spring:
  application:
    name: product-service
  cloud:
    config:
      uri: http://localhost:8888  # Config Serveråœ°å€
      profile: dev                # ç¯å¢ƒæ ‡è¯†
      label: master              # Gitåˆ†æ”¯
      
# ä¹Ÿå¯ä»¥é€šè¿‡æœåŠ¡å‘ç°è·å–Config Server
  cloud:
    config:
      discovery:
        enabled: true
        service-id: config-server
```

**ğŸ’¡ åŠ¨æ€é…ç½®åˆ·æ–°**
```java
// åœ¨éœ€è¦åŠ¨æ€åˆ·æ–°çš„é…ç½®ç±»ä¸Šæ·»åŠ æ³¨è§£
@Component
@RefreshScope  // æ”¯æŒé…ç½®åŠ¨æ€åˆ·æ–°
public class ProductConfig {
    
    @Value("${product.discount.rate:0.1}")
    private Double discountRate;
    
    @Value("${product.max.inventory:1000}")
    private Integer maxInventory;
    
    // getteræ–¹æ³•...
}

// æ‰‹åŠ¨è§¦å‘é…ç½®åˆ·æ–°
// POSTè¯·æ±‚: http://localhost:port/actuator/refresh
```

### 4.4 é…ç½®æ–‡ä»¶ç®¡ç†æœ€ä½³å®è·µ

**ğŸ“‹ é…ç½®ç»„ç»‡ç­–ç•¥**

```
Gitä»“åº“ç›®å½•ç»“æ„å»ºè®®ï¼š
config-repo/
â”œâ”€â”€ application.yml          # å…¨å±€é€šç”¨é…ç½®
â”œâ”€â”€ application-dev.yml      # å¼€å‘ç¯å¢ƒé€šç”¨é…ç½®
â”œâ”€â”€ application-prod.yml     # ç”Ÿäº§ç¯å¢ƒé€šç”¨é…ç½®
â”œâ”€â”€ product-service.yml      # å•†å“æœåŠ¡é€šç”¨é…ç½®
â”œâ”€â”€ product-service-dev.yml  # å•†å“æœåŠ¡å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ product-service-prod.yml # å•†å“æœåŠ¡ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ order-service.yml
â””â”€â”€ order-service-dev.yml

é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. åº”ç”¨ç‰¹å®šç¯å¢ƒé…ç½®ï¼šproduct-service-dev.yml
2. åº”ç”¨é€šç”¨é…ç½®ï¼šproduct-service.yml  
3. å…¨å±€ç¯å¢ƒé…ç½®ï¼šapplication-dev.yml
4. å…¨å±€é€šç”¨é…ç½®ï¼šapplication.yml
```

**ğŸ”’ æ•æ„Ÿä¿¡æ¯åŠ å¯†**
```yaml
# ä½¿ç”¨åŠ å¯†é…ç½®
spring:
  datasource:
    password: '{cipher}AQA1JJ8cjMB...'  # åŠ å¯†åçš„å¯†ç 
    
# é…ç½®åŠ å¯†å¯†é’¥
encrypt:
  key: my-secret-key
```

---

## 5. ğŸ”— æœåŠ¡é—´é€šä¿¡


### 5.1 å¾®æœåŠ¡é€šä¿¡æ–¹å¼æ¦‚è¿°

ğŸ¯ **é€šä¿¡æ–¹å¼ç±»æ¯”**ï¼šå°±åƒäººä¸äººä¹‹é—´çš„ä¸åŒæ²Ÿé€šæ–¹å¼

```
åŒæ­¥é€šä¿¡ vs å¼‚æ­¥é€šä¿¡ï¼š

åŒæ­¥é€šä¿¡ï¼ˆç”µè¯é€šè¯ï¼‰ï¼š
æˆ‘æ‰“ç”µè¯ç»™ä½  â†’ ä½ å¿…é¡»æ¥å¬ â†’ æˆ‘ä»¬å®æ—¶å¯¹è¯ â†’ é€šè¯ç»“æŸ
ç‰¹ç‚¹ï¼šå³æ—¶å“åº”ï¼Œä½†éœ€è¦ç­‰å¾…

å¼‚æ­¥é€šä¿¡ï¼ˆå‘çŸ­ä¿¡ï¼‰ï¼š
æˆ‘å‘çŸ­ä¿¡ç»™ä½  â†’ ä½ æœ‰ç©ºæ—¶æŸ¥çœ‹ â†’ ä¸å½±å“æˆ‘åšå…¶ä»–äº‹
ç‰¹ç‚¹ï¼šä¸ç”¨ç­‰å¾…ï¼Œä½†å“åº”æœ‰å»¶è¿Ÿ

å¾®æœåŠ¡ä¸­çš„åº”ç”¨ï¼š
åŒæ­¥ï¼šHTTPè°ƒç”¨ï¼Œç›´æ¥è·å–ç»“æœ
å¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‘é€æ¶ˆæ¯åç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡
```

### 5.2 Feignå£°æ˜å¼HTTPå®¢æˆ·ç«¯

**ğŸ“ Feignè®©æœåŠ¡è°ƒç”¨å˜å¾—ä¼˜é›…**

```java
// ä¼ ç»ŸRestTemplateè°ƒç”¨ï¼ˆç¹çï¼‰
@RestController
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public Product getProduct(Long productId) {
        String url = "http://product-service/product/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
}

// ä½¿ç”¨Feignè°ƒç”¨ï¼ˆä¼˜é›…ï¼‰
@FeignClient(name = "product-service")  // æŒ‡å®šæœåŠ¡å
public interface ProductClient {
    
    @GetMapping("/product/{id}")
    Product getProduct(@PathVariable("id") Long productId);
    
    @PostMapping("/product")
    Product createProduct(@RequestBody Product product);
}

// åœ¨Controllerä¸­ä½¿ç”¨
@RestController
public class OrderController {
    
    @Autowired
    private ProductClient productClient;  // åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·
    
    @GetMapping("/order/{id}")
    public String getOrder(@PathVariable Long id) {
        Product product = productClient.getProduct(id);  // ç®€å•ï¼
        return "è®¢å•å•†å“ï¼š" + product.getName();
    }
}
```

**ğŸ”§ Feigné…ç½®ä¼˜åŒ–**
```yaml
# Feignå®¢æˆ·ç«¯é…ç½®
feign:
  client:
    config:
      default:
        connectTimeout: 5000     # è¿æ¥è¶…æ—¶
        readTimeout: 10000       # è¯»å–è¶…æ—¶
        loggerLevel: basic       # æ—¥å¿—çº§åˆ«
      product-service:           # é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„é…ç½®
        connectTimeout: 2000
        readTimeout: 5000
```

### 5.3 æœåŠ¡è°ƒç”¨çš„å®¹é”™å¤„ç†

**ğŸ›¡ï¸ æœåŠ¡è°ƒç”¨å¼‚å¸¸å¤„ç†**

```java
// Feigné›†æˆHystrixè¿›è¡Œå®¹é”™
@FeignClient(name = "product-service", fallback = ProductClientFallback.class)
public interface ProductClient {
    
    @GetMapping("/product/{id}")
    Product getProduct(@PathVariable("id") Long productId);
}

// é™çº§å¤„ç†ç±»
@Component
public class ProductClientFallback implements ProductClient {
    
    @Override
    public Product getProduct(Long productId) {
        // å½“product-serviceä¸å¯ç”¨æ—¶ï¼Œè¿”å›é»˜è®¤å•†å“ä¿¡æ¯
        Product defaultProduct = new Product();
        defaultProduct.setId(productId);
        defaultProduct.setName("å•†å“æš‚æ—¶ä¸å¯ç”¨");
        defaultProduct.setPrice(0.0);
        return defaultProduct;
    }
}
```

**â° è¶…æ—¶å’Œé‡è¯•æœºåˆ¶**
```yaml
# è¶…æ—¶é…ç½®
ribbon:
  ReadTimeout: 5000           # è¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é—´
  ConnectTimeout: 2000        # è¿æ¥è¶…æ—¶æ—¶é—´
  MaxAutoRetries: 1           # åŒä¸€å®ä¾‹æœ€å¤§é‡è¯•æ¬¡æ•°
  MaxAutoRetriesNextServer: 2 # ä¸åŒå®ä¾‹æœ€å¤§é‡è¯•æ¬¡æ•°
  
# æˆ–è€…ä½¿ç”¨æ–°çš„é…ç½®æ–¹å¼
spring:
  cloud:
    loadbalancer:
      retry:
        enabled: true
```

---

## 6. âš–ï¸ è´Ÿè½½å‡è¡¡ä¸è·¯ç”±


### 6.1 è´Ÿè½½å‡è¡¡åŸºæœ¬æ¦‚å¿µ

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šè´Ÿè½½å‡è¡¡å°±åƒé“¶è¡Œçš„æ’é˜Ÿå«å·ç³»ç»Ÿ

```
æ²¡æœ‰è´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼š
3ä¸ªé“¶è¡ŒæŸœå°ï¼Œä½†é¡¾å®¢éƒ½æ’åˆ°1å·æŸœå° â†’ 1å·ç´¯æ­»ï¼Œ2ã€3å·é—²ç€

è´Ÿè½½å‡è¡¡çš„è§£å†³æ–¹æ¡ˆï¼š
æ’é˜Ÿæœºè‡ªåŠ¨åˆ†é… â†’ é¡¾å®¢å‡åŒ€åˆ†å¸ƒåˆ°å„ä¸ªæŸœå° â†’ æé«˜æ•ˆç‡

å¾®æœåŠ¡ä¸­çš„åº”ç”¨ï¼š
å•†å“æœåŠ¡æœ‰3ä¸ªå®ä¾‹ï¼Œè®¢å•æœåŠ¡çš„è¯·æ±‚éœ€è¦å‡åŒ€åˆ†é…
é¿å…æŸä¸ªå®ä¾‹è¿‡è½½ï¼Œå…¶ä»–å®ä¾‹é—²ç½®
```

### 6.2 Ribbonå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡

**ğŸ¯ Ribbonè´Ÿè½½å‡è¡¡ç­–ç•¥**

```
Ribbonå†…ç½®è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š

è½®è¯¢ç­–ç•¥ï¼ˆRoundRobinï¼‰ï¼š
è¯·æ±‚1 â†’ æœåŠ¡A â†’ è¯·æ±‚2 â†’ æœåŠ¡B â†’ è¯·æ±‚3 â†’ æœåŠ¡C â†’ å¾ªç¯

éšæœºç­–ç•¥ï¼ˆRandomï¼‰ï¼š
éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡å®ä¾‹

æœ€å°‘æ´»è·ƒè¯·æ±‚ï¼ˆBestAvailableï¼‰ï¼š
é€‰æ‹©å½“å‰å¹¶å‘è¯·æ±‚æ•°æœ€å°‘çš„æœåŠ¡å®ä¾‹

å“åº”æ—¶é—´æƒé‡ï¼ˆWeightedResponseï¼‰ï¼š
å“åº”æ—¶é—´çŸ­çš„å®ä¾‹è·å¾—æ›´å¤šè¯·æ±‚
```

**âš™ï¸ Ribboné…ç½®ç¤ºä¾‹**
```java
// å…¨å±€è´Ÿè½½å‡è¡¡ç­–ç•¥é…ç½®
@Configuration
public class RibbonConfig {
    
    @Bean
    public IRule ribbonRule() {
        return new RandomRule();  // ä½¿ç”¨éšæœºç­–ç•¥
        // return new RoundRobinRule();     // è½®è¯¢ç­–ç•¥
        // return new BestAvailableRule();  // æœ€å°‘æ´»è·ƒè¯·æ±‚
    }
}

// é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„ç­–ç•¥é…ç½®
@Configuration
@RibbonClient(name = "product-service", configuration = ProductRibbonConfig.class)
public class RibbonClientConfig {
}
```

```yaml
# é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥
product-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
```

### 6.3 Spring Cloud LoadBalancer

**âš¡ æ–°ä¸€ä»£è´Ÿè½½å‡è¡¡å™¨**

```java
// LoadBalanceré…ç½®ï¼ˆæ¨èä½¿ç”¨ï¼Œæ›¿ä»£Ribbonï¼‰
@Configuration
@LoadBalancerClient(name = "product-service", configuration = ProductLoadBalancerConfig.class)
public class LoadBalancerConfig {
}

@Configuration
public class ProductLoadBalancerConfig {
    
    @Bean
    ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        return new RandomLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name);
    }
}
```

### 6.4 è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥

**ğŸ¨ å®ç°ä¸šåŠ¡ç›¸å…³çš„è´Ÿè½½å‡è¡¡**

```java
// è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ï¼šæ ¹æ®æœåŠ¡å®ä¾‹ç‰ˆæœ¬è¿›è¡Œè·¯ç”±
@Component
public class VersionBasedLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private final String serviceId;
    private final ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider
                .getIfAvailable(NoopServiceInstanceListSupplier::new);
        
        return supplier.get(request)
                .next()
                .map(serviceInstances -> processInstanceResponse(serviceInstances, request));
    }
    
    private Response<ServiceInstance> processInstanceResponse(
            List<ServiceInstance> instances, Request request) {
        
        if (instances.isEmpty()) {
            return new EmptyResponse();
        }
        
        // æ ¹æ®è¯·æ±‚å¤´é€‰æ‹©å¯¹åº”ç‰ˆæœ¬çš„æœåŠ¡å®ä¾‹
        String preferredVersion = getPreferredVersion(request);
        
        List<ServiceInstance> filteredInstances = instances.stream()
                .filter(instance -> {
                    String version = instance.getMetadata().get("version");
                    return preferredVersion.equals(version);
                })
                .collect(Collectors.toList());
        
        if (filteredInstances.isEmpty()) {
            filteredInstances = instances;  // å¦‚æœæ²¡æœ‰åŒ¹é…ç‰ˆæœ¬ï¼Œä½¿ç”¨æ‰€æœ‰å®ä¾‹
        }
        
        // ä»è¿‡æ»¤åçš„å®ä¾‹ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
        ServiceInstance chosen = filteredInstances.get(
                ThreadLocalRandom.current().nextInt(filteredInstances.size()));
                
        return new DefaultResponse(chosen);
    }
}
```

---

## 7. ğŸ”Œ æ–­è·¯å™¨ä¸å®¹é”™æœºåˆ¶


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦æ–­è·¯å™¨

ğŸ¯ **ç”µè·¯æ–­è·¯å™¨çš„ç±»æ¯”**ï¼šå¾®æœåŠ¡æ–­è·¯å™¨å°±åƒå®¶ç”¨ç”µè·¯ä¿é™©ä¸

```
å®¶ç”¨ç”µè·¯ä¿æŠ¤ï¼š
ç”µå™¨çŸ­è·¯ â†’ ç”µæµè¿‡å¤§ â†’ ä¿é™©ä¸ç†”æ–­ â†’ ä¿æŠ¤æ•´ä¸ªç”µè·¯ä¸è¢«çƒ§å

å¾®æœåŠ¡å®¹é”™ä¿æŠ¤ï¼š
æœåŠ¡æ•…éšœ â†’ è¯·æ±‚å †ç§¯ â†’ æ–­è·¯å™¨è·³é—¸ â†’ ä¿æŠ¤æ•´ä¸ªç³»ç»Ÿä¸è¢«æ‹–å®

æ–­è·¯å™¨ä¸‰ç§çŠ¶æ€ï¼š
å…³é—­ï¼ˆCLOSEDï¼‰ï¼šæ­£å¸¸å·¥ä½œï¼Œè¯·æ±‚æ­£å¸¸é€šè¿‡
æ‰“å¼€ï¼ˆOPENï¼‰ï¼šæ£€æµ‹åˆ°æ•…éšœï¼Œæ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼Œç›´æ¥è¿”å›é”™è¯¯
åŠå¼€ï¼ˆHALF_OPENï¼‰ï¼šå°è¯•æ¢å¤ï¼Œå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤
```

### 7.2 Hystrixæ–­è·¯å™¨å®ç°

**âš¡ Hystrixå·¥ä½œæœºåˆ¶**

```
Hystrixæ–­è·¯å™¨çŠ¶æ€è½¬æ¢ï¼š

æ­£å¸¸çŠ¶æ€ â†’ æ•…éšœæ£€æµ‹ â†’ æ–­è·¯å™¨æ‰“å¼€ â†’ å°è¯•æ¢å¤ â†’ æ¢å¤æˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLOSED  â”‚â”€â”€â”€â–¶â”‚  OPEN   â”‚â”€â”€â”€â–¶â”‚HALF_OPENâ”‚â”€â”€â”€â–¶â”‚ CLOSED  â”‚
â”‚ æ­£å¸¸é€šè¿‡ â”‚    â”‚ å¿«é€Ÿå¤±è´¥ â”‚    â”‚ å°å¿ƒè¯•æ¢ â”‚    â”‚ æ¢å¤æ­£å¸¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                                           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```java
// ä½¿ç”¨Hystrixæ³¨è§£å®ç°æ–­è·¯å™¨
@RestController
public class OrderController {
    
    @Autowired
    private ProductClient productClient;
    
    @GetMapping("/order/{id}")
    @HystrixCommand(
        fallbackMethod = "getOrderFallback",  // é™çº§æ–¹æ³•
        commandProperties = {
            @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"),
            @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50"),
            @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "10000")
        }
    )
    public String getOrder(@PathVariable Long id) {
        Product product = productClient.getProduct(id);
        return "è®¢å•å•†å“ï¼š" + product.getName();
    }
    
    // é™çº§æ–¹æ³•ï¼šå½“æœåŠ¡ä¸å¯ç”¨æ—¶è°ƒç”¨
    public String getOrderFallback(Long id) {
        return "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•ã€‚è®¢å•IDï¼š" + id;
    }
}
```

### 7.3 Resilience4jè½»é‡çº§å®¹é”™åº“

**ğŸ›¡ï¸ ç°ä»£åŒ–çš„å®¹é”™è§£å†³æ–¹æ¡ˆ**

```java
// Resilience4jæ–­è·¯å™¨é…ç½®
@RestController
public class OrderController {
    
    private final CircuitBreaker circuitBreaker;
    private final ProductClient productClient;
    
    public OrderController(ProductClient productClient) {
        this.productClient = productClient;
        this.circuitBreaker = CircuitBreaker.ofDefaults("productService");
    }
    
    @GetMapping("/order/{id}")
    public String getOrder(@PathVariable Long id) {
        
        Supplier<String> decoratedSupplier = CircuitBreaker
                .decorateSupplier(circuitBreaker, () -> {
                    Product product = productClient.getProduct(id);
                    return "è®¢å•å•†å“ï¼š" + product.getName();
                });
        
        return Try.ofSupplier(decoratedSupplier)
                .recover(exception -> "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè®¢å•IDï¼š" + id)
                .get();
    }
}
```

### 7.4 å®¹é”™æ¨¡å¼æœ€ä½³å®è·µ

**ğŸ“‹ å®¹é”™è®¾è®¡ç­–ç•¥**

```
å®¹é”™æ¨¡å¼ç»„åˆä½¿ç”¨ï¼š

1. è¶…æ—¶æ¨¡å¼ï¼ˆTimeoutï¼‰
   è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…

2. é‡è¯•æ¨¡å¼ï¼ˆRetryï¼‰
   å¯¹äºç½‘ç»œæŠ–åŠ¨ç­‰ä¸´æ—¶æ€§æ•…éšœè¿›è¡Œé‡è¯•

3. æ–­è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰
   å¯¹äºæŒç»­æ€§æ•…éšœå¿«é€Ÿå¤±è´¥

4. éš”ç¦»æ¨¡å¼ï¼ˆBulkheadï¼‰
   ä¸åŒçš„æœåŠ¡è°ƒç”¨ä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹æ± 

5. é™çº§æ¨¡å¼ï¼ˆFallbackï¼‰
   æä¾›å¤‡é€‰æ–¹æ¡ˆï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨
```

**âš™ï¸ å®¹é”™é…ç½®ç¤ºä¾‹**
```yaml
# Resilience4jé…ç½®
resilience4j:
  circuitbreaker:
    instances:
      productService:
        registerHealthIndicator: true
        slidingWindowSize: 10                    # æ»‘åŠ¨çª—å£å¤§å°
        permittedNumberOfCallsInHalfOpenState: 3  # åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°
        slidingWindowType: COUNT_BASED           # åŸºäºè¯·æ±‚æ•°çš„æ»‘åŠ¨çª—å£
        minimumNumberOfCalls: 5                  # æœ€å°è¯·æ±‚æ•°
        waitDurationInOpenState: 5s              # æ–­è·¯å™¨æ‰“å¼€ç­‰å¾…æ—¶é—´
        failureRateThreshold: 50                 # å¤±è´¥ç‡é˜ˆå€¼
        
  retry:
    instances:
      productService:
        maxAttempts: 3        # æœ€å¤§é‡è¯•æ¬¡æ•°
        waitDuration: 1000ms  # é‡è¯•é—´éš”
        
  timelimiter:
    instances:
      productService:
        timeoutDuration: 2s   # è¶…æ—¶æ—¶é—´
```

---

## 8. ğŸ” åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦é“¾è·¯è¿½è¸ª

ğŸ¯ **å¿«é€’è¿½è¸ªçš„ç±»æ¯”**ï¼šåˆ†å¸ƒå¼è¿½è¸ªå°±åƒå¿«é€’çš„ç‰©æµè½¨è¿¹

```
å•ä½“åº”ç”¨è°ƒè¯•ï¼š
å‡ºé—®é¢˜äº† â†’ æŸ¥çœ‹æ—¥å¿— â†’ å®šä½é—®é¢˜ â†’ å¾ˆç®€å•

å¾®æœåŠ¡è°ƒè¯•ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç»è¿‡5ä¸ªæœåŠ¡ â†’ ç¬¬3ä¸ªæœåŠ¡å‡ºé—®é¢˜äº† â†’ å“ªé‡Œå‡ºé”™ï¼Ÿæ€ä¹ˆæ‰¾ï¼Ÿ

é“¾è·¯è¿½è¸ªçš„ä»·å€¼ï¼š
å°±åƒå¿«é€’è¿½è¸ªï¼šåŒ—äº¬å‘è´§ â†’ çŸ³å®¶åº„ä¸­è½¬ â†’ å¤©æ´¥ä¸­è½¬ â†’ é€è¾¾
æ¯ä¸ªç¯èŠ‚éƒ½æœ‰è®°å½•ï¼Œå‡ºé—®é¢˜èƒ½å¿«é€Ÿå®šä½
```

### 8.2 Spring Cloud SleuthåŸºç¡€

**ğŸ•µï¸ Sleuthåˆ†å¸ƒå¼è¿½è¸ª**

```
Sleuthè¿½è¸ªæ¦‚å¿µï¼š

Trace IDï¼šæ•´ä¸ªè¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ï¼ˆä¸€æ¬¡å®Œæ•´çš„ç”¨æˆ·è¯·æ±‚ï¼‰
Span IDï¼šæ¯ä¸ªæœåŠ¡è°ƒç”¨çš„å”¯ä¸€æ ‡è¯†ï¼ˆè¯·æ±‚ä¸­çš„ä¸€ä¸ªç¯èŠ‚ï¼‰

è¯·æ±‚è¿½è¸ªç¤ºä¾‹ï¼š
ç”¨æˆ·ä¸‹å• â†’ Trace ID: abc123
â”œâ”€â”€ è°ƒç”¨ç”¨æˆ·æœåŠ¡éªŒè¯ â†’ Span ID: span001
â”œâ”€â”€ è°ƒç”¨å•†å“æœåŠ¡æŸ¥è¯¢ â†’ Span ID: span002  
â”œâ”€â”€ è°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡ â†’ Span ID: span003
â””â”€â”€ è°ƒç”¨æ”¯ä»˜æœåŠ¡å¤„ç† â†’ Span ID: span004

è¿™æ ·å°±èƒ½æ¸…æ¥šçœ‹åˆ°è¯·æ±‚åœ¨å„ä¸ªæœåŠ¡é—´çš„æµè½¬è·¯å¾„
```

**ğŸ“Š Sleuthæ—¥å¿—è¾“å‡ºæ ¼å¼**
```
åŸå§‹æ—¥å¿—ï¼š
2024-01-11 10:30:00 INFO  è®¢å•åˆ›å»ºæˆåŠŸ

åŠ å…¥Sleuthåçš„æ—¥å¿—ï¼š
2024-01-11 10:30:00 INFO [order-service,abc123,span002,true] è®¢å•åˆ›å»ºæˆåŠŸ

æ ¼å¼è¯´æ˜ï¼š
[æœåŠ¡å, TraceID, SpanID, æ˜¯å¦å‘é€åˆ°Zipkin]
```

### 8.3 Zipkinå¯è§†åŒ–è¿½è¸ª

**ğŸ“ˆ å›¾å½¢åŒ–çš„é“¾è·¯è¿½è¸ªç•Œé¢**

```yaml
# Sleuth + Zipkiné…ç½®
spring:
  sleuth:
    sampler:
      probability: 1.0  # é‡‡æ ·ç‡ï¼Œ1.0è¡¨ç¤º100%é‡‡æ ·
    zipkin:
      base-url: http://localhost:9411  # ZipkinæœåŠ¡å™¨åœ°å€
  application:
    name: order-service
```

**ğŸ”§ ZipkinæœåŠ¡ç«¯éƒ¨ç½²**
```bash
# ä½¿ç”¨Dockerå¿«é€Ÿå¯åŠ¨Zipkin
docker run -d -p 9411:9411 openzipkin/zipkin

# è®¿é—®Zipkin Webç•Œé¢
# http://localhost:9411
```

### 8.4 è‡ªå®šä¹‰é“¾è·¯è¿½è¸ª

**ğŸ¨ å¢åŠ ä¸šåŠ¡ç›¸å…³çš„è¿½è¸ªä¿¡æ¯**

```java
// æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å’Œæ—¥å¿—
@RestController
public class OrderController {
    
    private final Tracer tracer;
    
    @Autowired
    public OrderController(Tracer tracer) {
        this.tracer = tracer;
    }
    
    @PostMapping("/order")
    public String createOrder(@RequestBody Order order) {
        
        Span span = tracer.nextSpan().name("create-order");
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span.start())) {
            // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
            span.tag("order.id", order.getId().toString());
            span.tag("order.amount", order.getAmount().toString());
            span.tag("user.id", order.getUserId().toString());
            
            // æ·»åŠ äº‹ä»¶æ—¥å¿—
            span.annotate("å¼€å§‹å¤„ç†è®¢å•");
            
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
            processOrder(order);
            
            span.annotate("è®¢å•å¤„ç†å®Œæˆ");
            
            return "è®¢å•åˆ›å»ºæˆåŠŸ";
            
        } catch (Exception e) {
            span.tag("error", e.getMessage());
            throw e;
        } finally {
            span.end();
        }
    }
}
```

---

## 9. ğŸšª APIç½‘å…³è®¾è®¡


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦APIç½‘å…³

ğŸ¯ **é…’åº—å‰å°çš„ç±»æ¯”**ï¼šAPIç½‘å…³å°±åƒé…’åº—çš„å‰å°æ¥å¾…

```
æ²¡æœ‰ç½‘å…³çš„é—®é¢˜ï¼š
å®¢äººè¦æ‰¾é¤å… â†’ ç›´æ¥æ‰¾é¤å…
å®¢äººè¦æ‰¾å¥èº«æˆ¿ â†’ ç›´æ¥æ‰¾å¥èº«æˆ¿  
å®¢äººè¦æ‰¾ä¼šè®®å®¤ â†’ ç›´æ¥æ‰¾ä¼šè®®å®¤
é—®é¢˜ï¼šå®¢äººéœ€è¦è®°ä½æ‰€æœ‰åœ°æ–¹ï¼Œå¾ˆæ··ä¹±

APIç½‘å…³çš„ä»·å€¼ï¼š
æ‰€æœ‰å®¢äººéƒ½å…ˆåˆ°å‰å° â†’ å‰å°ç»Ÿä¸€æŒ‡å¼• â†’ æ‰¾åˆ°æƒ³å»çš„åœ°æ–¹
å¥½å¤„ï¼šç»Ÿä¸€å…¥å£ã€ç»Ÿä¸€ç®¡ç†ã€ç»Ÿä¸€æœåŠ¡

å¾®æœåŠ¡ä¸­çš„åº”ç”¨ï¼š
å‰ç«¯åº”ç”¨ä¸ç”¨çŸ¥é“åç«¯æœ‰å¤šå°‘ä¸ªæœåŠ¡
æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ç½‘å…³ï¼Œç½‘å…³è´Ÿè´£è·¯ç”±åˆ°æ­£ç¡®çš„æœåŠ¡
```

### 9.2 Spring Cloud GatewayåŸºç¡€

**ğŸŒ‰ Gatewayç½‘å…³æ¶æ„**

```
Gatewayå·¥ä½œæµç¨‹ï¼š

å®¢æˆ·ç«¯è¯·æ±‚ â†’ ç½‘å…³æ¥æ”¶ â†’ è·¯ç”±åŒ¹é… â†’ è¿‡æ»¤å™¨é“¾ â†’ ç›®æ ‡æœåŠ¡
    â†‘                                              â†“
å“åº”è¿”å› â† å“åº”è¿‡æ»¤ â† æœåŠ¡å“åº” â† è¯·æ±‚è½¬å‘ â† è´Ÿè½½å‡è¡¡

ç»„ä»¶è¯´æ˜ï¼š
Routeï¼ˆè·¯ç”±ï¼‰ï¼šå®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ°ç›®æ ‡æœåŠ¡
Predicateï¼ˆæ–­è¨€ï¼‰ï¼šåŒ¹é…è¯·æ±‚çš„æ¡ä»¶
Filterï¼ˆè¿‡æ»¤å™¨ï¼‰ï¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œå¤„ç†
```

**âš™ï¸ GatewayåŸºç¡€é…ç½®**
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: product-route          # è·¯ç”±ID
          uri: lb://product-service  # ç›®æ ‡æœåŠ¡ï¼ˆlbè¡¨ç¤ºè´Ÿè½½å‡è¡¡ï¼‰
          predicates:
            - Path=/product/**       # è·¯å¾„åŒ¹é…æ¡ä»¶
          filters:
            - StripPrefix=1          # å»æ‰è·¯å¾„å‰ç¼€
            
        - id: order-route
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            - AddRequestHeader=X-Gateway, SpringCloudGateway
```

### 9.3 è·¯ç”±é…ç½®è¯¦è§£

**ğŸ—ºï¸ çµæ´»çš„è·¯ç”±è§„åˆ™**

```yaml
spring:
  cloud:
    gateway:
      routes:
        # 1. åŸºäºè·¯å¾„çš„è·¯ç”±
        - id: path-route
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
            
        # 2. åŸºäºè¯·æ±‚å¤´çš„è·¯ç”±  
        - id: header-route
          uri: lb://product-service-v2
          predicates:
            - Header=X-Version, v2
            
        # 3. åŸºäºæ—¶é—´çš„è·¯ç”±ï¼ˆç°åº¦å‘å¸ƒï¼‰
        - id: time-route
          uri: lb://product-service-new
          predicates:
            - After=2024-01-01T00:00:00+08:00[Asia/Shanghai]
            
        # 4. åŸºäºæƒé‡çš„è·¯ç”±ï¼ˆA/Bæµ‹è¯•ï¼‰
        - id: weight-route-1
          uri: lb://product-service-a
          predicates:
            - Weight=group1, 8  # 80%æµé‡
            
        - id: weight-route-2  
          uri: lb://product-service-b
          predicates:
            - Weight=group1, 2  # 20%æµé‡
```

### 9.4 ç½‘å…³è¿‡æ»¤å™¨å¼€å‘

**ğŸ”§ è‡ªå®šä¹‰è¿‡æ»¤å™¨å®ç°**

```java
// å…¨å±€è¿‡æ»¤å™¨ï¼šè®°å½•è¯·æ±‚æ—¥å¿—
@Component
@Order(-1)  // è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº
public class LoggingGlobalFilter implements GlobalFilter {
    
    private static final Logger log = LoggerFactory.getLogger(LoggingGlobalFilter.class);
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getPath().pathWithinApplication().value();
        String method = request.getMethodValue();
        String clientIp = getClientIp(request);
        
        log.info("è¯·æ±‚å¼€å§‹ - æ–¹æ³•: {}, è·¯å¾„: {}, å®¢æˆ·ç«¯IP: {}", method, path, clientIp);
        
        long startTime = System.currentTimeMillis();
        
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                long endTime = System.currentTimeMillis();
                ServerHttpResponse response = exchange.getResponse();
                int statusCode = response.getStatusCode().value();
                
                log.info("è¯·æ±‚ç»“æŸ - çŠ¶æ€ç : {}, è€—æ—¶: {}ms", statusCode, (endTime - startTime));
            })
        );
    }
}

// å±€éƒ¨è¿‡æ»¤å™¨ï¼šç”¨æˆ·è®¤è¯
@Component
public class AuthGatewayFilterFactory extends AbstractGatewayFilterFactory<AuthGatewayFilterFactory.Config> {
    
    public AuthGatewayFilterFactory() {
        super(Config.class);
    }
    
    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            ServerHttpRequest request = exchange.getRequest();
            
            // æ£€æŸ¥è®¤è¯å¤´
            String authHeader = request.getHeaders().getFirst("Authorization");
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return unauthorized(exchange);
            }
            
            // éªŒè¯tokenï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
            String token = authHeader.substring(7);
            if (!isValidToken(token)) {
                return unauthorized(exchange);
            }
            
            return chain.filter(exchange);
        };
    }
    
    private Mono<Void> unauthorized(ServerWebExchange exchange) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        return response.setComplete();
    }
    
    // é…ç½®ç±»
    public static class Config {
        // å¯ä»¥æ·»åŠ é…ç½®å‚æ•°
    }
}
```

**ğŸ”’ ç½‘å…³é›†æˆè®¤è¯æˆæƒ**
```yaml
# ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨
spring:
  cloud:
    gateway:
      routes:
        - id: secure-route
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - name: Auth  # ä½¿ç”¨è®¤è¯è¿‡æ»¤å™¨
            - name: RateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
```

---

## 10. ğŸš€ è¿›é˜¶å®è·µä¸ä¼˜åŒ–


### 10.1 äº‘åŸç”ŸKubernetesé›†æˆ

**â˜ï¸ Spring Cloud + K8sååŒå·¥ä½œ**

```yaml
# Kubernetes Service Discoveryé…ç½®
spring:
  cloud:
    kubernetes:
      discovery:
        enabled: true
        all-namespaces: true
      config:
        enabled: true
        sources:
          - name: product-service
            namespace: default
            
# æ›¿ä»£Eurekaï¼Œç›´æ¥ä½¿ç”¨K8sçš„æœåŠ¡å‘ç°
spring:
  cloud:
    discovery:
      enabled: false  # ç¦ç”¨Eureka
    kubernetes:
      discovery:
        enabled: true   # å¯ç”¨K8så‘ç°
```

**ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²é…ç½®**
```dockerfile
# å¾®æœåŠ¡å®¹å™¨åŒ–æœ€ä½³å®è·µ
FROM openjdk:17-jre-slim

# æ·»åŠ åº”ç”¨ç”¨æˆ·ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
RUN addgroup --system spring && adduser --system spring --ingroup spring
USER spring:spring

# å¤åˆ¶åº”ç”¨jaråŒ…
ARG JAR_FILE=target/*.jar
COPY ${JAR_FILE} app.jar

# JVMä¼˜åŒ–å‚æ•°
ENV JAVA_OPTS="-Xms512m -Xmx1024m -XX:+UseG1GC"

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

ENTRYPOINT exec java $JAVA_OPTS -jar /app.jar
```

### 10.2 å“åº”å¼ç¼–ç¨‹æ”¯æŒ

**âš¡ WebFluxå“åº”å¼å¾®æœåŠ¡**

```java
// å“åº”å¼æœåŠ¡æ¥å£
@RestController
public class ReactiveProductController {
    
    @Autowired
    private ReactiveProductService productService;
    
    // è¿”å›å•ä¸ªå•†å“
    @GetMapping("/product/{id}")
    public Mono<Product> getProduct(@PathVariable String id) {
        return productService.findById(id);
    }
    
    // è¿”å›å•†å“æµ
    @GetMapping(value = "/products/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<Product> getProductStream() {
        return productService.findAll()
                .delayElements(Duration.ofSeconds(1));  // æ¯ç§’å‘é€ä¸€ä¸ª
    }
    
    // å“åº”å¼æœåŠ¡è°ƒç”¨
    @GetMapping("/order/{id}/products")
    public Flux<Product> getOrderProducts(@PathVariable String orderId) {
        return orderService.findById(orderId)
                .flatMapMany(order -> 
                    Flux.fromIterable(order.getProductIds())
                        .flatMap(productService::findById)
                        .onErrorContinue((error, product) -> 
                            log.warn("è·å–å•†å“å¤±è´¥: {}", product, error))
                );
    }
}
```

### 10.3 å¤šæ•°æ®æºåˆ†åº“åˆ†è¡¨

**ğŸ—„ï¸ æ•°æ®å±‚æ¶æ„è®¾è®¡**

```java
// å¤šæ•°æ®æºé…ç½®
@Configuration
public class DataSourceConfig {
    
    @Bean
    @Primary
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource routingDataSource() {
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        
        DynamicRoutingDataSource routingDataSource = new DynamicRoutingDataSource();
        routingDataSource.setDefaultTargetDataSource(masterDataSource());
        routingDataSource.setTargetDataSources(dataSourceMap);
        
        return routingDataSource;
    }
}

// è¯»å†™åˆ†ç¦»æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "master";
}

// AOPå®ç°è¯»å†™åˆ†ç¦»
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(dataSource)")
    public Object around(ProceedingJoinPoint point, DataSource dataSource) throws Throwable {
        String dsKey = dataSource.value();
        DynamicDataSourceContextHolder.setDataSourceKey(dsKey);
        try {
            return point.proceed();
        } finally {
            DynamicDataSourceContextHolder.clearDataSourceKey();
        }
    }
}
```

### 10.4 æ€§èƒ½ä¼˜åŒ–è°ƒä¼˜

**âš¡ å¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

```
JVMè°ƒä¼˜å‚æ•°ï¼š
-Xms2g -Xmx2g                    # å †å†…å­˜è®¾ç½®
-XX:+UseG1GC                     # ä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨  
-XX:MaxGCPauseMillis=200         # GCæš‚åœæ—¶é—´ç›®æ ‡
-XX:+HeapDumpOnOutOfMemoryError  # OOMæ—¶ç”Ÿæˆå †è½¬å‚¨

è¿æ¥æ± ä¼˜åŒ–ï¼š
spring:
  datasource:
    hikari:
      minimum-idle: 10           # æœ€å°è¿æ¥æ•°
      maximum-pool-size: 50      # æœ€å¤§è¿æ¥æ•°
      idle-timeout: 300000       # ç©ºé—²è¶…æ—¶
      connection-timeout: 20000   # è¿æ¥è¶…æ—¶
      
HTTPå®¢æˆ·ç«¯ä¼˜åŒ–ï¼š
feign:
  httpclient:
    enabled: true
    max-connections: 200         # æœ€å¤§è¿æ¥æ•°
    max-connections-per-route: 50 # æ¯ä¸ªè·¯ç”±æœ€å¤§è¿æ¥æ•°
    connection-timeout: 2000     # è¿æ¥è¶…æ—¶
    
ç¼“å­˜ç­–ç•¥ï¼š
@Cacheable(value = "products", key = "#id")
public Product getProduct(Long id) {
    return productRepository.findById(id);
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¾®æœåŠ¡æ¶æ„ï¼šå°†å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å°æœåŠ¡ï¼Œå„å¸å…¶èŒ
ğŸ”¸ æœåŠ¡æ³¨å†Œå‘ç°ï¼šåƒç”µè¯é»„é¡µä¸€æ ·ï¼Œå¸®åŠ©æœåŠ¡æ‰¾åˆ°å½¼æ­¤
ğŸ”¸ é…ç½®ä¸­å¿ƒï¼šç»Ÿä¸€ç®¡ç†é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
ğŸ”¸ æœåŠ¡é€šä¿¡ï¼šFeignå£°æ˜å¼è°ƒç”¨ï¼Œè®©è¿œç¨‹è°ƒç”¨åƒæœ¬åœ°è°ƒç”¨
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šåˆç†åˆ†é…è¯·æ±‚ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½
ğŸ”¸ æ–­è·¯å™¨ï¼šå¿«é€Ÿå¤±è´¥æœºåˆ¶ï¼Œé˜²æ­¢æ•…éšœæ‰©æ•£
ğŸ”¸ é“¾è·¯è¿½è¸ªï¼šè¯·æ±‚åœ¨æœåŠ¡é—´çš„æµè½¬è½¨è¿¹ï¼Œæ–¹ä¾¿é—®é¢˜å®šä½
ğŸ”¸ APIç½‘å…³ï¼šç»Ÿä¸€å…¥å£ï¼Œè·¯ç”±åˆ†å‘ï¼Œå®‰å…¨æ§åˆ¶
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¾®æœåŠ¡æ¶æ„çš„æ ¸å¿ƒä»·å€¼**
```
æŠ€æœ¯ä¼˜åŠ¿ï¼š
- ç‹¬ç«‹å¼€å‘éƒ¨ç½²ï¼Œæé«˜å¼€å‘æ•ˆç‡
- æŠ€æœ¯æ ˆå¤šæ ·åŒ–ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯
- æ•…éšœéš”ç¦»ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“ç¨³å®šæ€§
- å¼¹æ€§ä¼¸ç¼©ï¼ŒæŒ‰éœ€æ‰©å®¹

ç®¡ç†ä¼˜åŠ¿ï¼š
- å›¢é˜Ÿç‹¬ç«‹è´Ÿè´£ï¼Œæƒè´£æ¸…æ™°
- ä¸šåŠ¡è¾¹ç•Œæ˜ç¡®ï¼Œé™ä½è€¦åˆ
- å¿«é€Ÿè¿­ä»£ï¼Œç¼©çŸ­å‘å¸ƒå‘¨æœŸ
```

**ğŸ”¹ Spring Cloudç»„ä»¶ååŒå·¥ä½œ**
```
æœåŠ¡æ²»ç†å±‚é¢ï¼š
Eureka + Ribbon + Feign = å®Œæ•´çš„æœåŠ¡è°ƒç”¨é“¾è·¯
Config + Bus = åˆ†å¸ƒå¼é…ç½®ç®¡ç†
Hystrix + Dashboard = å®Œæ•´çš„å®¹é”™ç›‘æ§

APIç½‘å…³å±‚é¢ï¼š
Gateway + Security = ç»Ÿä¸€çš„å®‰å…¨ç½‘å…³
Gateway + Sleuth = è¯·æ±‚é“¾è·¯è¿½è¸ª
Gateway + Actuator = ç½‘å…³å¥åº·ç›‘æ§

æ•°æ®å¤„ç†å±‚é¢ï¼š
Stream + MQ = äº‹ä»¶é©±åŠ¨æ¶æ„
Sleuth + Zipkin = åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
```

**ğŸ”¹ å¾®æœåŠ¡è®¾è®¡æœ€ä½³å®è·µ**
```
æ¶æ„è®¾è®¡ï¼š
- æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼Œä¸æŒ‰æŠ€æœ¯å±‚æ¬¡æ‹†åˆ†
- æœåŠ¡è‡ªæ²»ï¼Œæ•°æ®ç‹¬ç«‹
- æ¥å£å…ˆè¡Œï¼Œå¥‘çº¦ä¼˜å…ˆ

è¿ç»´ç®¡ç†ï¼š
- è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ŒæŒç»­é›†æˆ
- ç›‘æ§å‘Šè­¦ï¼Œå¯è§‚å¯Ÿæ€§
- å®¹ç¾å¤‡ä»½ï¼Œé«˜å¯ç”¨è®¾è®¡

å›¢é˜Ÿåä½œï¼š
- DevOpsæ–‡åŒ–ï¼Œå¼€å‘è¿ç»´ä¸€ä½“åŒ–
- æ–‡æ¡£å…ˆè¡Œï¼ŒAPIæ–‡æ¡£å®Œå–„
- æµ‹è¯•é©±åŠ¨ï¼Œè´¨é‡ä¿è¯
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **ç”µå•†å¹³å°**ï¼šç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ç‹¬ç«‹éƒ¨ç½²
- **é‡‘èç³»ç»Ÿ**ï¼šè´¦æˆ·æœåŠ¡ã€äº¤æ˜“æœåŠ¡ã€é£æ§æœåŠ¡ã€æŠ¥è¡¨æœåŠ¡åˆ†ç¦»
- **å†…å®¹å¹³å°**ï¼šç”¨æˆ·ç®¡ç†ã€å†…å®¹åˆ›ä½œã€æ¨èç®—æ³•ã€æ•°æ®åˆ†æç‹¬ç«‹æ¼”è¿›
- **ä¼ä¸šåº”ç”¨**ï¼šäººäº‹ç®¡ç†ã€è´¢åŠ¡ç³»ç»Ÿã€å®¢æˆ·å…³ç³»ã€ä¾›åº”é“¾ç®¡ç†æ¨¡å—åŒ–

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**
- **åˆå­¦é˜¶æ®µ**ï¼šä»Spring Bootå•ä½“å¼€å§‹ï¼Œç†è§£ä¸šåŠ¡é€»è¾‘
- **è¿›é˜¶é˜¶æ®µ**ï¼šå¼•å…¥Eurekaã€Configã€Feignç­‰æ ¸å¿ƒç»„ä»¶
- **ç”Ÿäº§é˜¶æ®µ**ï¼šåŠ å…¥Gatewayã€Hystrixã€Sleuthå®Œå–„æ²»ç†
- **ä¼˜åŒ–é˜¶æ®µ**ï¼šé›†æˆK8sã€å¼•å…¥å“åº”å¼ç¼–ç¨‹ã€æ€§èƒ½è°ƒä¼˜

**ğŸ“ˆ å­¦ä¹ è·¯å¾„è§„åˆ’**
```
ğŸŸ¢ åŸºç¡€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼š
- Spring BootåŸºç¡€
- å¾®æœåŠ¡æ¦‚å¿µç†è§£
- EurekaæœåŠ¡æ³¨å†Œå‘ç°
- FeignæœåŠ¡è°ƒç”¨

ğŸŸ¡ è¿›é˜¶é˜¶æ®µï¼ˆ2-3ä¸ªæœˆï¼‰ï¼š
- Spring Cloud Configé…ç½®ä¸­å¿ƒ
- Gateway APIç½‘å…³
- Hystrixæ–­è·¯å™¨
- Sleuthé“¾è·¯è¿½è¸ª

ğŸ”´ é«˜çº§é˜¶æ®µï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š
- Kubernetesé›†æˆ
- å“åº”å¼ç¼–ç¨‹
- æ€§èƒ½ä¼˜åŒ–
- ç”Ÿäº§ç¯å¢ƒå®è·µ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¾®æœåŠ¡æ‹†åˆ†æœ‰è¾¹ç•Œï¼Œç‹¬ç«‹éƒ¨ç½²å„å¸èŒ
- æ³¨å†Œå‘ç°æ‰¾æœåŠ¡ï¼Œé…ç½®ä¸­å¿ƒç»Ÿç®¡ç†
- ç½‘å…³è·¯ç”±æ§æµé‡ï¼Œæ–­è·¯ä¿æŠ¤é˜²æ•…éšœ
- é“¾è·¯è¿½è¸ªæŸ¥é—®é¢˜ï¼Œè´Ÿè½½å‡è¡¡ææ€§èƒ½