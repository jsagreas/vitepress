---
title: 8ã€å®‰å…¨ä¸è®¤è¯
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ](#1-å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [Spring Security å¾®æœåŠ¡é›†æˆ](#2-spring-security-å¾®æœåŠ¡é›†æˆ)
3. [OAuth2.1 è®¤è¯è¯¦è§£](#3-oauth21-è®¤è¯è¯¦è§£)
4. [JWT Token å®Œæ•´æœºåˆ¶](#4-jwt-token-å®Œæ•´æœºåˆ¶)
5. [ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå®ç°](#5-ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå®ç°)
6. [å•ç‚¹ç™»å½• SSO å®æˆ˜](#6-å•ç‚¹ç™»å½•-sso-å®æˆ˜)
7. [æƒé™æ§åˆ¶ä½“ç³»](#7-æƒé™æ§åˆ¶ä½“ç³»)
8. [API å®‰å…¨é˜²æŠ¤](#8-api-å®‰å…¨é˜²æŠ¤)
9. [æœåŠ¡é—´å®‰å…¨é€šä¿¡](#9-æœåŠ¡é—´å®‰å…¨é€šä¿¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å®‰å…¨è®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡å®‰å…¨


ğŸŸ¢ **åŸºç¡€ç†è§£**

æƒ³è±¡ä¸€ä¸‹ä¼ ç»Ÿçš„å•ä½“åº”ç”¨å°±åƒä¸€åº§ç‹¬æ ‹åˆ«å¢…ï¼Œæ‰€æœ‰æˆ¿é—´éƒ½åœ¨ä¸€ä¸ªå±‹å­é‡Œï¼Œåªè¦å®ˆä½å¤§é—¨å°±å¤Ÿäº†ã€‚è€Œå¾®æœåŠ¡æ¶æ„å°±åƒä¸€ä¸ªå°åŒºï¼Œæœ‰å¾ˆå¤šæ ‹æ¥¼ã€å¾ˆå¤šä¸ªæˆ¿é—´ï¼Œæ¯ä¸ªéƒ½éœ€è¦å•ç‹¬çš„å®‰å…¨æªæ–½ã€‚

**ä¼ ç»Ÿå•ä½“ vs å¾®æœåŠ¡å®‰å…¨ï¼š**
```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Webåº”ç”¨ç¨‹åº           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”‚
â”‚  â”‚ç”¨æˆ· â”‚ â”‚ä¸šåŠ¡ â”‚ â”‚æ•°æ®â”‚ â”‚ â† ä¸€é“é˜²çº¿ä¿æŠ¤æ‰€æœ‰
â”‚  â”‚ç•Œé¢â”‚ â”‚é€»è¾‘ â”‚ â”‚åº“  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡æ¶æ„ï¼š
   ç”¨æˆ·æœåŠ¡    è®¢å•æœåŠ¡    æ”¯ä»˜æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”’     â”‚â†â†’â”‚  ğŸ”’     â”‚â†â†’â”‚  ğŸ”’     â”‚ â† æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ä¿æŠ¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†•          â†•          â†•
   ç”¨æˆ·æ•°æ®    è®¢å•æ•°æ®    æ”¯ä»˜æ•°æ®
```

### 1.2 å¾®æœåŠ¡å®‰å…¨çš„æ ¸å¿ƒæŒ‘æˆ˜


ğŸ”¥ **å¿…é¡»æŒæ¡çš„å…³é”®é—®é¢˜**

**é—®é¢˜1ï¼šèº«ä»½è®¤è¯å¤æ‚åŒ–**
- å•ä½“åº”ç”¨ï¼šç”¨æˆ·ç™»å½•ä¸€æ¬¡ï¼Œæ•´ä¸ªåº”ç”¨éƒ½çŸ¥é“ä½ æ˜¯è°
- å¾®æœåŠ¡ï¼šæ¯ä¸ªæœåŠ¡éƒ½ä¸çŸ¥é“ä½ æ˜¯è°ï¼Œéœ€è¦ä¼ é€’èº«ä»½ä¿¡æ¯

**é—®é¢˜2ï¼šæƒé™æ§åˆ¶åˆ†æ•£**
- å•ä½“åº”ç”¨ï¼šæƒé™æ§åˆ¶åœ¨ä¸€ä¸ªåœ°æ–¹ç»Ÿä¸€ç®¡ç†
- å¾®æœåŠ¡ï¼šæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦çŸ¥é“ç”¨æˆ·æœ‰ä»€ä¹ˆæƒé™

**é—®é¢˜3ï¼šæœåŠ¡é—´é€šä¿¡å®‰å…¨**
- å•ä½“åº”ç”¨ï¼šå†…éƒ¨è°ƒç”¨ï¼Œä¸ç»è¿‡ç½‘ç»œ
- å¾®æœåŠ¡ï¼šé€šè¿‡ç½‘ç»œè°ƒç”¨ï¼Œå¯èƒ½è¢«æ‹¦æˆªæˆ–ä¼ªé€ 

### 1.3 å®‰å…¨æ¶æ„è®¾è®¡æ€è·¯


ğŸ’¡ **æ ¸å¿ƒè®¾è®¡åŸåˆ™**

```
å¾®æœåŠ¡å®‰å…¨æ¶æ„å…¨æ™¯ï¼š

              å‰ç«¯åº”ç”¨
                â”‚
              è®¤è¯ç™»å½•
                â”‚
         â”Œâ”€â”€â”€â”€â”€APIç½‘å…³â”€â”€â”€â”€â”€â” â† ç»Ÿä¸€å…¥å£ï¼ŒéªŒè¯èº«ä»½
         â”‚                 â”‚
    ç”¨æˆ·æœåŠ¡          è®¢å•æœåŠ¡          æ”¯ä»˜æœåŠ¡
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚èº«ä»½éªŒè¯ â”‚      â”‚æƒé™æ£€æŸ¥ â”‚      â”‚æ•æ„Ÿæ“ä½œ â”‚
   â”‚Token   â”‚      â”‚ä¸šåŠ¡é€»è¾‘ â”‚      â”‚åŠ å¯†å¤„ç† â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ç”¨æˆ·æ•°æ® â”‚      â”‚è®¢å•æ•°æ® â”‚      â”‚æ”¯ä»˜æ•°æ® â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ è®¾è®¡ç›®æ ‡ï¼š**
- **ç»Ÿä¸€è®¤è¯**ï¼šä¸€ä¸ªåœ°æ–¹ç®¡ç†æ‰€æœ‰ç”¨æˆ·èº«ä»½
- **åˆ†æ•£æˆæƒ**ï¼šæ¯ä¸ªæœåŠ¡æ ¹æ®ä¸šåŠ¡éœ€è¦æ§åˆ¶æƒé™
- **å®‰å…¨ä¼ è¾“**ï¼šä¿è¯æœåŠ¡é—´é€šä¿¡ä¸è¢«çªƒå¬æˆ–ç¯¡æ”¹
- **æœ€å°æƒé™**ï¼šæ¯ä¸ªæœåŠ¡åªèƒ½è®¿é—®å¿…è¦çš„èµ„æº

---

## 2. ğŸ›¡ï¸ Spring Security å¾®æœåŠ¡é›†æˆ


### 2.1 Spring Security æ ¸å¿ƒæ¦‚å¿µ


â­ **å…¥é—¨çº§ç†è§£**

Spring Securityå°±åƒæ˜¯ç»™ä½ çš„å¾®æœåŠ¡è¯·äº†ä¸€ä¸ªä¸“ä¸šçš„ä¿å®‰å›¢é˜Ÿã€‚è¿™ä¸ªä¿å®‰å›¢é˜Ÿæœ‰æ˜ç¡®çš„åˆ†å·¥ï¼š

**æ ¸å¿ƒè§’è‰²è¯´æ˜ï¼š**
```
ğŸšª è®¤è¯ï¼ˆAuthenticationï¼‰ï¼š
   "ä½ æ˜¯è°ï¼Ÿ" - éªŒè¯èº«ä»½
   å°±åƒé—¨å«æ£€æŸ¥èº«ä»½è¯

ğŸ”‘ æˆæƒï¼ˆAuthorizationï¼‰ï¼š
   "ä½ èƒ½å¹²ä»€ä¹ˆï¼Ÿ" - æ£€æŸ¥æƒé™
   å°±åƒæ£€æŸ¥ä½ çš„é—¨ç¦å¡èƒ½è¿›å“ªäº›æ¥¼å±‚

ğŸ›¡ï¸ è¿‡æ»¤å™¨é“¾ï¼ˆFilter Chainï¼‰ï¼š
   å®‰å…¨æ£€æŸ¥æµç¨‹
   å°±åƒè¿‡æœºåœºå®‰æ£€çš„å„ä¸ªæ­¥éª¤
```

### 2.2 å¾®æœåŠ¡ä¸­çš„ Spring Security é…ç½®


ğŸŸ¡ **è¿›é˜¶çº§å®ç°**

åœ¨å¾®æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡å•ç‹¬é…ç½® Spring Securityï¼Œä½†è¦ä¿æŒç»Ÿä¸€çš„è®¤è¯æ ‡å‡†ã€‚

**åŸºç¡€å®‰å…¨é…ç½®ï¼š**
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å…³é—­CSRFï¼ˆå¾®æœåŠ¡é—´é€šä¿¡ä¸éœ€è¦ï¼‰
            .csrf().disable()
            
            // é…ç½®è¯·æ±‚æˆæƒè§„åˆ™
            .authorizeHttpRequests(auth -> auth
                // å¥åº·æ£€æŸ¥æ¥å£ä¸éœ€è¦è®¤è¯
                .requestMatchers("/actuator/health").permitAll()
                // APIæ¥å£éœ€è¦è®¤è¯
                .requestMatchers("/api/**").authenticated()
                // å…¶ä»–è¯·æ±‚å…è®¸è®¿é—®
                .anyRequest().permitAll()
            )
            
            // ä½¿ç”¨JWTè€Œä¸æ˜¯Session
            .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);
                
        return http.build();
    }
}
```

**ğŸ’¡ é…ç½®è¯´æ˜ï¼š**
- `csrf().disable()`ï¼šå¾®æœåŠ¡ä¹‹é—´é€šä¿¡ä¸éœ€è¦CSRFä¿æŠ¤
- `sessionCreationPolicy.STATELESS`ï¼šä¸ä½¿ç”¨Sessionï¼Œæ¯æ¬¡è¯·æ±‚éƒ½éªŒè¯Token

### 2.3 æœåŠ¡çº§åˆ«çš„å®‰å…¨é…ç½®


**ç”¨æˆ·æœåŠ¡å®‰å…¨é…ç½®ç¤ºä¾‹ï¼š**
```java
// ç”¨æˆ·æœåŠ¡ - è´Ÿè´£èº«ä»½éªŒè¯
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    // ç™»å½•æ¥å£ - ä¸éœ€è¦è®¤è¯
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(request);
        if (user != null) {
            // ç”ŸæˆJWT Token
            String token = jwtUtil.generateToken(user);
            return ResponseEntity.ok(new LoginResponse(token, user));
        }
        return ResponseEntity.status(401).body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯ - éœ€è¦è®¤è¯
    @GetMapping("/profile")
    @PreAuthorize("hasRole('USER')")
    public ResponseEntity<User> getProfile() {
        // Spring Securityä¼šè‡ªåŠ¨æ³¨å…¥å½“å‰ç”¨æˆ·ä¿¡æ¯
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        String username = auth.getName();
        User user = userService.findByUsername(username);
        return ResponseEntity.ok(user);
    }
}
```

---

## 3. ğŸ” OAuth2.1 è®¤è¯è¯¦è§£


### 3.1 OAuth2.1 æ˜¯ä»€ä¹ˆ


â­ **å…¥é—¨çº§æ¦‚å¿µ**

OAuth2.1å°±åƒæ˜¯ä¸€ä¸ª"æˆæƒå§”æ‰˜ä¹¦"ç³»ç»Ÿã€‚æƒ³è±¡ä½ è¦è®©æœ‹å‹å¸®ä½ å–å¿«é€’ï¼Œä½ ä¸ä¼šæŠŠèº«ä»½è¯ç»™ä»–ï¼Œè€Œæ˜¯å†™ä¸ªå§”æ‰˜ä¹¦è¯æ˜ä»–æœ‰æƒå¸®ä½ å–ä»¶ã€‚

**ç”Ÿæ´»åŒ–ç†è§£ï¼š**
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
ä½  â†’ æŠŠå¯†ç å‘Šè¯‰æœ‹å‹ â†’ æœ‹å‹ç”¨ä½ çš„å¯†ç ç™»å½•

OAuth2.1æ–¹å¼ï¼ˆå®‰å…¨ï¼‰ï¼š
ä½  â†’ æˆæƒæœ‹å‹è®¿é—®ç‰¹å®šåŠŸèƒ½ â†’ æœ‹å‹æ‹¿ç€æˆæƒç å»æ“ä½œ
```

### 3.2 OAuth2.1 çš„å››ä¸ªè§’è‰²


ğŸ“Š **è§’è‰²å…³ç³»å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ è¯·æ±‚æˆæƒ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚              â”‚
â”‚  èµ„æºæ‹¥æœ‰è€…   â”‚                 â”‚  å®¢æˆ·ç«¯åº”ç”¨   â”‚
â”‚ (Resource   â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  (Client)    â”‚
â”‚  Owner)     â”‚  â‘¡ç”¨æˆ·æˆæƒç¡®è®¤    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                               â”‚
    â‘¢æä¾›æˆæƒ                       â‘£è¯·æ±‚Token
       â”‚                               â”‚
       â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘¤è¿”å›Token    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚              â”‚
â”‚  è®¤è¯æœåŠ¡å™¨   â”‚                 â”‚  èµ„æºæœåŠ¡å™¨   â”‚
â”‚ (Auth       â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (Resource    â”‚
â”‚  Server)    â”‚  â‘¥éªŒè¯Token      â”‚  Server)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ è§’è‰²èŒè´£ï¼š**
- **èµ„æºæ‹¥æœ‰è€…**ï¼šå°±æ˜¯ç”¨æˆ·ï¼Œæ‹¥æœ‰æ•°æ®çš„äºº
- **å®¢æˆ·ç«¯åº”ç”¨**ï¼šæƒ³è¦è®¿é—®ç”¨æˆ·æ•°æ®çš„åº”ç”¨ï¼ˆæ¯”å¦‚ç¬¬ä¸‰æ–¹APPï¼‰
- **è®¤è¯æœåŠ¡å™¨**ï¼šè´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œé¢å‘Token
- **èµ„æºæœåŠ¡å™¨**ï¼šå­˜å‚¨ç”¨æˆ·æ•°æ®çš„æœåŠ¡å™¨

### 3.3 OAuth2.1 æˆæƒæµç¨‹è¯¦è§£


**æˆæƒç æ¨¡å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š**
```
ç”¨æˆ·æµè§ˆå™¨              å®¢æˆ·ç«¯åº”ç”¨              è®¤è¯æœåŠ¡å™¨
     â”‚                      â”‚                      â”‚
     â”‚â”€â”€â‘ è®¿é—®åº”ç”¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
     â”‚                      â”‚                      â”‚
     â”‚â†â”€â‘¡é‡å®šå‘åˆ°è®¤è¯é¡µé¢â”€â”€â”€â”€â”‚â”€â”€â‘¢è¯·æ±‚æˆæƒâ”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                      â”‚                      â”‚
     â”‚â”€â”€â‘£ç”¨æˆ·ç™»å½•æˆæƒâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                      â”‚                      â”‚
     â”‚â†â”€â‘¤è¿”å›æˆæƒç â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                      â”‚
     â”‚â”€â”€â‘¥æäº¤æˆæƒç â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                      â”‚
     â”‚                      â”‚â”€â”€â‘¦ç”¨æˆæƒç æ¢Tokenâ”€â”€â†’â”‚
     â”‚                      â”‚â†â”€â‘§è¿”å›Access Tokenâ”€â”€â”‚
     â”‚â†â”€â‘¨æ­£å¸¸ä½¿ç”¨åº”ç”¨â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
```

### 3.4 Spring Cloud OAuth2 å®ç°


ğŸ”´ **é«˜çº§åº”ç”¨**

**è®¤è¯æœåŠ¡å™¨é…ç½®ï¼š**
```java
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig {
    
    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        // æ³¨å†Œå®¢æˆ·ç«¯åº”ç”¨
        RegisteredClient client = RegisteredClient.withId("user-service")
            .clientId("user-client")
            .clientSecret("{noop}user-secret")
            .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
            .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
            .redirectUri("http://localhost:8081/login/oauth2/code/user-service")
            .scope("read", "write")
            .build();
            
        return new InMemoryRegisteredClientRepository(client);
    }
    
    @Bean
    public JWKSource<SecurityContext> jwkSource() {
        // JWTç­¾åå¯†é’¥
        RSAKey rsaKey = generateRsa();
        JWKSet jwkSet = new JWKSet(rsaKey);
        return (jwkSelector, securityContext) -> jwkSelector.select(jwkSet);
    }
}
```

**ğŸ’¡ é…ç½®è§£é‡Šï¼š**
- `clientId/clientSecret`ï¼šå®¢æˆ·ç«¯åº”ç”¨çš„èº«ä»½å‡­è¯
- `authorizationGrantType`ï¼šæˆæƒç±»å‹ï¼Œè¿™é‡Œç”¨æˆæƒç æ¨¡å¼
- `redirectUri`ï¼šæˆæƒåé‡å®šå‘åœ°å€
- `scope`ï¼šæˆæƒèŒƒå›´ï¼Œé™åˆ¶å®¢æˆ·ç«¯èƒ½åšä»€ä¹ˆ

---

## 4. ğŸ« JWT Token å®Œæ•´æœºåˆ¶


### 4.1 JWT æ˜¯ä»€ä¹ˆ


â­ **å…¥é—¨çº§ç†è§£**

JWTï¼ˆJSON Web Tokenï¼‰å°±åƒæ˜¯ä¸€å¼ "æ™ºèƒ½èº«ä»½è¯"ï¼Œä¸ä»…è¯æ˜ä½ æ˜¯è°ï¼Œè¿˜è®°å½•äº†ä½ çš„æƒé™ä¿¡æ¯ã€‚

**ä¼ ç»ŸSession vs JWTå¯¹æ¯”ï¼š**
```
ä¼ ç»ŸSessionæ–¹å¼ï¼š
å®¢æˆ·ç«¯                    æœåŠ¡å™¨
  â”‚                        â”‚
  â”‚â”€â”€â‘ ç”¨æˆ·ç™»å½•â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
  â”‚                    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
  â”‚â†â”€â‘¡è¿”å›SessionIDâ”€â”€â”€â”€â”‚Sessionâ”‚ â† æœåŠ¡å™¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
  â”‚                    â”‚ å­˜å‚¨  â”‚
  â”‚â”€â”€â‘¢å¸¦SessionIDè®¿é—®â”€â†’â”‚ ç”¨æˆ·1 â”‚
  â”‚                    â”‚ ç”¨æˆ·2 â”‚
  â”‚â†â”€â‘£è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ...  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”˜

JWTæ–¹å¼ï¼š
å®¢æˆ·ç«¯                    æœåŠ¡å™¨
  â”‚                        â”‚
  â”‚â”€â”€â‘ ç”¨æˆ·ç™»å½•â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
  â”‚                        â”‚ â† ä¸å­˜å‚¨ä»»ä½•ç”¨æˆ·ä¿¡æ¯
  â”‚â†â”€â‘¡è¿”å›JWT Tokenâ”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                        â”‚
  â”‚â”€â”€â‘¢å¸¦JWTè®¿é—®â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ â† è§£æTokenå°±çŸ¥é“ç”¨æˆ·ä¿¡æ¯
  â”‚                        â”‚
  â”‚â†â”€â‘£è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 4.2 JWT ç»“æ„è¯¦è§£


JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ç‚¹å·ï¼ˆ.ï¼‰åˆ†éš”ï¼š

```
å®Œæ•´çš„JWT Tokenï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

ç»“æ„åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (å¤´éƒ¨) - ç®—æ³•å’ŒTokenç±»å‹        â”‚
â”‚ eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    .
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payload (è½½è·) - ç”¨æˆ·ä¿¡æ¯å’Œæƒé™        â”‚
â”‚ eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFt... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    .
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Signature (ç­¾å) - é˜²æ­¢ç¯¡æ”¹           â”‚
â”‚ SflKxwRJSMeKKF2QT4fwpMeJf36POk6... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„éƒ¨åˆ†å†…å®¹ï¼š**
```json
// Header (Base64ç¼–ç å‰)
{
  "alg": "HS256",  // ç­¾åç®—æ³•
  "typ": "JWT"     // Tokenç±»å‹
}

// Payload (Base64ç¼–ç å‰)
{
  "sub": "1234567890",        // ç”¨æˆ·ID
  "name": "John Doe",         // ç”¨æˆ·å
  "iat": 1516239022,          // ç­¾å‘æ—¶é—´
  "exp": 1516242622,          // è¿‡æœŸæ—¶é—´
  "roles": ["USER", "ADMIN"]   // ç”¨æˆ·è§’è‰²
}

// Signature (ç­¾åç®—æ³•è®¡ç®—)
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret
)
```

### 4.3 JWT å·¥å…·ç±»å®ç°


```java
@Component
public class JwtUtil {
    
    private String secret = "mySecretKey";
    private int expiration = 3600; // 1å°æ—¶è¿‡æœŸ
    
    // ç”ŸæˆToken
    public String generateToken(User user) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", user.getId());
        claims.put("username", user.getUsername());
        claims.put("roles", user.getRoles());
        
        return Jwts.builder()
                .setClaims(claims)                    // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
                .setSubject(user.getUsername())       // è®¾ç½®ä¸»é¢˜
                .setIssuedAt(new Date())              // è®¾ç½®ç­¾å‘æ—¶é—´
                .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
                .signWith(SignatureAlgorithm.HS512, secret)  // ç­¾å
                .compact();
    }
    
    // è§£æToken
    public Claims parseToken(String token) {
        return Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
    }
    
    // éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
    public boolean validateToken(String token) {
        try {
            Claims claims = parseToken(token);
            return !claims.getExpiration().before(new Date());
        } catch (Exception e) {
            return false;
        }
    }
    
    // ä»Tokenè·å–ç”¨æˆ·å
    public String getUsernameFromToken(String token) {
        Claims claims = parseToken(token);
        return claims.getSubject();
    }
}
```

### 4.4 JWT åœ¨å¾®æœåŠ¡ä¸­çš„ä½¿ç”¨


**APIç½‘å…³TokenéªŒè¯ï¼š**
```java
@Component
public class JwtAuthenticationFilter implements GlobalFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // è·³è¿‡ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
        if (isSkipPath(request.getPath().toString())) {
            return chain.filter(exchange);
        }
        
        // è·å–Token
        String token = getTokenFromRequest(request);
        if (token == null || !jwtUtil.validateToken(token)) {
            // Tokenæ— æ•ˆï¼Œè¿”å›401
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }
        
        // Tokenæœ‰æ•ˆï¼Œæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
        String username = jwtUtil.getUsernameFromToken(token);
        ServerHttpRequest mutatedRequest = request.mutate()
                .header("X-User-Name", username)
                .build();
                
        return chain.filter(exchange.mutate().request(mutatedRequest).build());
    }
    
    private String getTokenFromRequest(ServerHttpRequest request) {
        String bearerToken = request.getHeaders().getFirst("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

---

## 5. ğŸ¢ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå®ç°


### 5.1 è®¤è¯ä¸­å¿ƒçš„ä½œç”¨


â­ **å…¥é—¨çº§ç†è§£**

ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå°±åƒæ˜¯å°åŒºçš„é—¨å«å®¤ï¼Œæ‰€æœ‰äººè¿›å°åŒºéƒ½è¦åœ¨è¿™é‡ŒéªŒè¯èº«ä»½ï¼ŒéªŒè¯é€šè¿‡åç»™ä½ ä¸€å¼ é€šè¡Œè¯ï¼Œå‡­å€Ÿé€šè¡Œè¯å¯ä»¥åœ¨å°åŒºå†…è‡ªç”±æ´»åŠ¨ã€‚

**æ¶æ„å¯¹æ¯”ï¼š**
```
æ²¡æœ‰ç»Ÿä¸€è®¤è¯ä¸­å¿ƒï¼š
ç”¨æˆ· â†’ ç”¨æˆ·æœåŠ¡ï¼ˆéªŒè¯èº«ä»½ï¼‰
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ï¼ˆå†æ¬¡éªŒè¯èº«ä»½ï¼‰
ç”¨æˆ· â†’ æ”¯ä»˜æœåŠ¡ï¼ˆåˆè¦éªŒè¯èº«ä»½ï¼‰
æ¯ä¸ªæœåŠ¡éƒ½è¦é‡å¤åšèº«ä»½éªŒè¯å·¥ä½œ

æœ‰ç»Ÿä¸€è®¤è¯ä¸­å¿ƒï¼š
ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒï¼ˆä¸€æ¬¡éªŒè¯ï¼Œè·å¾—Tokenï¼‰â†’ ç”¨Tokenè®¿é—®æ‰€æœ‰æœåŠ¡
        â†“
   â”Œâ”€ç”¨æˆ·æœåŠ¡â”€â”€è®¢å•æœåŠ¡â”€â”€æ”¯ä»˜æœåŠ¡â”€â”
   â”‚  éªŒè¯Token  éªŒè¯Token éªŒè¯Token â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è®¤è¯ä¸­å¿ƒæ ¸å¿ƒåŠŸèƒ½


ğŸ”¥ **å¿…é¡»æŒæ¡çš„åŠŸèƒ½**

```
è®¤è¯ä¸­å¿ƒåŠŸèƒ½æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¤è¯ä¸­å¿ƒ                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ç”¨æˆ·ç®¡ç†   â”‚  â”‚  ç™»å½•è®¤è¯   â”‚  â”‚  Tokenç®¡ç†  â”‚        â”‚
â”‚  â”‚ æ³¨å†Œ/ä¿®æ”¹   â”‚  â”‚ å¯†ç éªŒè¯   â”‚  â”‚  ç”Ÿæˆ/åˆ·æ–°  â”‚        â”‚
â”‚  â”‚ ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚ å¤šç§æ–¹å¼   â”‚  â”‚  éªŒè¯/å¤±æ•ˆ  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  æƒé™ç®¡ç†   â”‚  â”‚  ä¼šè¯ç®¡ç†   â”‚  â”‚  å®‰å…¨å®¡è®¡   â”‚        â”‚
â”‚  â”‚ è§’è‰²åˆ†é…   â”‚  â”‚ åœ¨çº¿ç”¨æˆ·   â”‚  â”‚  ç™»å½•æ—¥å¿—   â”‚        â”‚
â”‚  â”‚ æƒé™æ§åˆ¶   â”‚  â”‚ å¼ºåˆ¶ä¸‹çº¿   â”‚  â”‚  æ“ä½œè®°å½•   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 è®¤è¯ä¸­å¿ƒå®ç°


**è®¤è¯æœåŠ¡ä¸»è¦æ¥å£ï¼š**
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthService authService;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    // ç”¨æˆ·ç™»å½•
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        try {
            // éªŒè¯ç”¨æˆ·åå¯†ç 
            User user = authService.authenticate(
                request.getUsername(), 
                request.getPassword()
            );
            
            // ç”ŸæˆToken
            String accessToken = jwtUtil.generateToken(user);
            String refreshToken = jwtUtil.generateRefreshToken(user);
            
            // è®°å½•ç™»å½•æ—¥å¿—
            authService.recordLogin(user, request.getClientIp());
            
            LoginResponse response = new LoginResponse();
            response.setAccessToken(accessToken);
            response.setRefreshToken(refreshToken);
            response.setExpiresIn(3600); // 1å°æ—¶
            response.setUserInfo(user);
            
            return ResponseEntity.ok(response);
            
        } catch (AuthenticationException e) {
            return ResponseEntity.status(401)
                    .body(new ErrorResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
    }
    
    // åˆ·æ–°Token
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(@RequestBody RefreshTokenRequest request) {
        try {
            String refreshToken = request.getRefreshToken();
            
            // éªŒè¯refresh token
            if (!jwtUtil.validateRefreshToken(refreshToken)) {
                return ResponseEntity.status(401)
                        .body(new ErrorResponse("Refresh tokenæ— æ•ˆ"));
            }
            
            // ç”Ÿæˆæ–°çš„access token
            String username = jwtUtil.getUsernameFromRefreshToken(refreshToken);
            User user = authService.findByUsername(username);
            String newAccessToken = jwtUtil.generateToken(user);
            
            RefreshTokenResponse response = new RefreshTokenResponse();
            response.setAccessToken(newAccessToken);
            response.setExpiresIn(3600);
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            return ResponseEntity.status(401)
                    .body(new ErrorResponse("Tokenåˆ·æ–°å¤±è´¥"));
        }
    }
    
    // ç”¨æˆ·ç™»å‡º
    @PostMapping("/logout")
    public ResponseEntity<?> logout(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        if (token != null) {
            // å°†tokenåŠ å…¥é»‘åå•
            authService.invalidateToken(token);
        }
        return ResponseEntity.ok(new MessageResponse("ç™»å‡ºæˆåŠŸ"));
    }
    
    // éªŒè¯Tokenæœ‰æ•ˆæ€§
    @PostMapping("/validate")
    public ResponseEntity<?> validateToken(@RequestBody ValidateTokenRequest request) {
        boolean isValid = jwtUtil.validateToken(request.getToken());
        if (isValid) {
            Claims claims = jwtUtil.parseToken(request.getToken());
            UserInfo userInfo = new UserInfo();
            userInfo.setUsername(claims.getSubject());
            userInfo.setRoles((List<String>) claims.get("roles"));
            
            return ResponseEntity.ok(userInfo);
        } else {
            return ResponseEntity.status(401)
                    .body(new ErrorResponse("Tokenæ— æ•ˆ"));
        }
    }
}
```

### 5.4 Token é»‘åå•æœºåˆ¶


å½“ç”¨æˆ·ç™»å‡ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è®©Tokenç«‹å³å¤±æ•ˆï¼Œè¿™å°±éœ€è¦é»‘åå•æœºåˆ¶ï¼š

```java
@Service
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // TokenåŠ å…¥é»‘åå•
    public void addToBlacklist(String token) {
        try {
            Claims claims = jwtUtil.parseToken(token);
            long expirationTime = claims.getExpiration().getTime();
            long currentTime = System.currentTimeMillis();
            
            // åªéœ€è¦å­˜å‚¨åˆ°Tokenè¿‡æœŸæ—¶é—´
            if (expirationTime > currentTime) {
                long ttl = (expirationTime - currentTime) / 1000;
                redisTemplate.opsForValue().set(
                    "blacklist:" + token, 
                    "invalid", 
                    ttl, 
                    TimeUnit.SECONDS
                );
            }
        } catch (Exception e) {
            // Tokenæ ¼å¼é”™è¯¯ï¼Œç›´æ¥å¿½ç•¥
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
    public boolean isBlacklisted(String token) {
        return redisTemplate.hasKey("blacklist:" + token);
    }
}
```

---

## 6. ğŸ”„ å•ç‚¹ç™»å½• SSO å®æˆ˜


### 6.1 SSO åŸºæœ¬æ¦‚å¿µ


â­ **å…¥é—¨çº§ç†è§£**

SSOï¼ˆSingle Sign-Onï¼‰å°±åƒæ˜¯ä¸€å¼ "ä¸‡èƒ½é’¥åŒ™"ï¼Œä¸€æ¬¡ç™»å½•åå¯ä»¥è®¿é—®æ‰€æœ‰ç›¸å…³çš„ç³»ç»Ÿï¼Œä¸éœ€è¦é‡å¤è¾“å…¥ç”¨æˆ·åå¯†ç ã€‚

**SSOä½¿ç”¨åœºæ™¯ï¼š**
```
ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼š
å‘˜å·¥ç™»å½• â†’ ä¸€æ¬¡è®¤è¯ â†’ å¯ä»¥è®¿é—®ï¼š
                      â”œâ”€ é‚®ä»¶ç³»ç»Ÿ
                      â”œâ”€ OAç³»ç»Ÿ  
                      â”œâ”€ è´¢åŠ¡ç³»ç»Ÿ
                      â””â”€ äººäº‹ç³»ç»Ÿ

äº’è”ç½‘åº”ç”¨ï¼š
QQç™»å½• â†’ ä¸€æ¬¡è®¤è¯ â†’ å¯ä»¥è®¿é—®ï¼š
                   â”œâ”€ QQé‚®ç®±
                   â”œâ”€ QQéŸ³ä¹
                   â”œâ”€ è…¾è®¯è§†é¢‘
                   â””â”€ ç‹è€…è£è€€
```

### 6.2 SSO å®ç°æ–¹æ¡ˆ


ğŸŸ¡ **è¿›é˜¶çº§å®ç°**

**åŸºäºè®¤è¯ä¸­å¿ƒçš„SSOæµç¨‹ï¼š**
```
æµè§ˆå™¨            åº”ç”¨A           è®¤è¯ä¸­å¿ƒ           åº”ç”¨B
  â”‚                â”‚                â”‚                â”‚
  â”‚â”€â”€â‘ è®¿é—®åº”ç”¨Aâ”€â”€â”€â”€â†’â”‚                â”‚                â”‚
  â”‚                â”‚â”€â”€â‘¡æ£€æŸ¥ç™»å½•çŠ¶æ€â”€â”€â†’â”‚                â”‚
  â”‚                â”‚â†â”€â‘¢æœªç™»å½•ï¼Œè¿”å›â”€â”€â”€â”‚                â”‚
  â”‚â†â”€â‘£é‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒâ”€â”‚                â”‚                â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â‘¤ç”¨æˆ·ç™»å½•è®¤è¯ä¸­å¿ƒâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
  â”‚â†â”€â”€â”€â”€â‘¥ç™»å½•æˆåŠŸï¼Œè®¾ç½®SSO Cookieâ”€â”€â”€â”€â”€â”‚                â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â”€â”€â”€â”€â”€â‘¦é‡å®šå‘å›åº”ç”¨Aå¸¦Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
  â”‚â†â”€â”€â”€â”€â‘§åº”ç”¨AéªŒè¯TokenæˆåŠŸâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â”€â”€â‘¨è®¿é—®åº”ç”¨Bâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â†â”€â‘©é‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒæ£€æŸ¥SSO Cookieâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â”€â”€â‘ªè®¤è¯ä¸­å¿ƒéªŒè¯Cookieæœ‰æ•ˆâ”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
  â”‚â†â”€â‘«ç›´æ¥è¿”å›Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
  â”‚                â”‚                â”‚                â”‚
  â”‚â†â”€â‘¬åº”ç”¨Bç›´æ¥å…è®¸è®¿é—®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### 6.3 SSO ç½‘å…³å®ç°


```java
@Component
public class SSOFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private AuthServiceClient authServiceClient;
    
    @Value("${sso.auth-server-url}")
    private String authServerUrl;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();
        
        // è·³è¿‡è®¤è¯æ¥å£å’Œé™æ€èµ„æº
        if (isSkipPath(request.getPath().toString())) {
            return chain.filter(exchange);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è®¤è¯Token
        String token = getTokenFromRequest(request);
        if (token != null && validateToken(token)) {
            // Tokenæœ‰æ•ˆï¼Œç»§ç»­å¤„ç†
            return addUserInfoAndContinue(exchange, chain, token);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰SSO Cookie
        String ssoCookie = getSSOCookie(request);
        if (ssoCookie != null) {
            // æœ‰SSO Cookieï¼Œå°è¯•è·å–Token
            return getSSOToken(ssoCookie)
                    .flatMap(ssoToken -> {
                        if (ssoToken != null) {
                            return addUserInfoAndContinue(exchange, chain, ssoToken);
                        } else {
                            return redirectToLogin(exchange, response);
                        }
                    });
        }
        
        // æ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        return redirectToLogin(exchange, response);
    }
    
    private Mono<Void> redirectToLogin(ServerWebExchange exchange, ServerHttpResponse response) {
        String currentUrl = exchange.getRequest().getURI().toString();
        String loginUrl = authServerUrl + "/login?redirect=" + 
                          URLEncoder.encode(currentUrl, StandardCharsets.UTF_8);
                          
        response.setStatusCode(HttpStatus.FOUND);
        response.getHeaders().set("Location", loginUrl);
        return response.setComplete();
    }
    
    private Mono<Void> addUserInfoAndContinue(ServerWebExchange exchange, 
                                             GatewayFilterChain chain, 
                                             String token) {
        try {
            Claims claims = jwtUtil.parseToken(token);
            String username = claims.getSubject();
            List<String> roles = (List<String>) claims.get("roles");
            
            // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
            ServerHttpRequest mutatedRequest = exchange.getRequest().mutate()
                    .header("X-User-Name", username)
                    .header("X-User-Roles", String.join(",", roles))
                    .header("X-Auth-Token", token)
                    .build();
                    
            return chain.filter(exchange.mutate().request(mutatedRequest).build());
        } catch (Exception e) {
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }
    }
}
```

---

## 7. ğŸ”‘ æƒé™æ§åˆ¶ä½“ç³»


### 7.1 RBAC æƒé™æ¨¡å‹


â­ **å…¥é—¨çº§ç†è§£**

RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰å°±åƒå…¬å¸çš„èŒä½ä½“ç³»ï¼Œä¸åŒèŒä½æœ‰ä¸åŒçš„æƒé™ï¼š

```
æƒé™æ¨¡å‹ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æƒé™ç³»ç»Ÿ                          â”‚
â”‚                                                    â”‚
â”‚  ç”¨æˆ· â†â†’ è§’è‰² â†â†’ æƒé™ â†â†’ èµ„æº                      â”‚
â”‚   â”‚      â”‚      â”‚      â”‚                          â”‚
â”‚  å¼ ä¸‰   ç®¡ç†å‘˜   ç”¨æˆ·ç®¡ç†   ç”¨æˆ·åˆ—è¡¨                  â”‚
â”‚  æå››   æ™®é€šç”¨æˆ·  æŸ¥çœ‹è®¢å•  è®¢å•è¯¦æƒ…                  â”‚
â”‚  ç‹äº”   è´¢åŠ¡     è´¢åŠ¡æŠ¥è¡¨   è´¢åŠ¡æ•°æ®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…æ˜ å°„ï¼š
å¼ ä¸‰(ç”¨æˆ·) â†’ ç®¡ç†å‘˜(è§’è‰²) â†’ ç”¨æˆ·ç®¡ç†(æƒé™) â†’ ç”¨æˆ·åˆ—è¡¨(èµ„æº)
æå››(ç”¨æˆ·) â†’ æ™®é€šç”¨æˆ·(è§’è‰²) â†’ æŸ¥çœ‹è®¢å•(æƒé™) â†’ è®¢å•è¯¦æƒ…(èµ„æº)
```

### 7.2 æƒé™æ³¨è§£ä½¿ç”¨


ğŸ”¥ **å¿…é¡»æŒæ¡çš„æ³¨è§£**

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    // åªæœ‰USERè§’è‰²å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„è®¢å•
    @GetMapping("/my")
    @PreAuthorize("hasRole('USER')")
    public List<Order> getMyOrders() {
        String username = SecurityContextHolder.getContext()
                           .getAuthentication().getName();
        return orderService.findByUsername(username);
    }
    
    // åªæœ‰ADMINè§’è‰²å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•
    @GetMapping("/all")
    @PreAuthorize("hasRole('ADMIN')")
    public List<Order> getAllOrders() {
        return orderService.findAll();
    }
    
    // éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½åˆ é™¤è®¢å•
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ORDER_DELETE')")
    public ResponseEntity<?> deleteOrder(@PathVariable Long id) {
        orderService.deleteById(id);
        return ResponseEntity.ok().build();
    }
    
    // å¤æ‚æƒé™æ§åˆ¶ï¼šç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„è®¢å•ï¼Œç®¡ç†å‘˜å¯ä»¥æ“ä½œæ‰€æœ‰è®¢å•
    @PutMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or (@orderService.isOwner(#id, authentication.name))")
    public ResponseEntity<Order> updateOrder(@PathVariable Long id, 
                                           @RequestBody Order order) {
        Order updated = orderService.update(id, order);
        return ResponseEntity.ok(updated);
    }
}
```

**ğŸ’¡ æ³¨è§£è¯´æ˜ï¼š**
- `@PreAuthorize`ï¼šæ–¹æ³•æ‰§è¡Œå‰æ£€æŸ¥æƒé™
- `hasRole('ROLE')`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²
- `hasAuthority('AUTH')`ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
- `#id`ï¼šå¼•ç”¨æ–¹æ³•å‚æ•°
- `authentication.name`ï¼šå½“å‰ç™»å½•ç”¨æˆ·å

### 7.3 åŠ¨æ€æƒé™æ§åˆ¶


å¯¹äºå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åŠ¨æ€åˆ¤æ–­æƒé™ï¼š

```java
@Service
public class PermissionService {
    
    @Autowired
    private UserRoleRepository userRoleRepository;
    
    @Autowired
    private OrderRepository orderRepository;
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æŒ‡å®šè®¢å•
    public boolean canAccessOrder(String username, Long orderId) {
        // ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰è®¢å•
        if (hasRole(username, "ADMIN")) {
            return true;
        }
        
        // æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è®¢å•
        Order order = orderRepository.findById(orderId).orElse(null);
        return order != null && order.getUsername().equals(username);
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²
    public boolean hasRole(String username, String role) {
        List<String> userRoles = userRoleRepository.findRolesByUsername(username);
        return userRoles.contains(role);
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ“ä½œæƒé™ï¼ˆå¯ä»¥åŸºäºä¸šåŠ¡è§„åˆ™ï¼‰
    public boolean canPerformAction(String username, String action, Object resource) {
        // æ ¹æ®ä¸šåŠ¡è§„åˆ™åŠ¨æ€åˆ¤æ–­
        switch (action) {
            case "DELETE_ORDER":
                return canDeleteOrder(username, (Order) resource);
            case "VIEW_FINANCIAL_DATA":
                return hasRole(username, "FINANCE") || hasRole(username, "ADMIN");
            case "MODIFY_USER":
                return hasRole(username, "ADMIN") || username.equals(((User) resource).getUsername());
            default:
                return false;
        }
    }
    
    private boolean canDeleteOrder(String username, Order order) {
        // åªèƒ½åˆ é™¤å¾…æ”¯ä»˜æˆ–å·²å–æ¶ˆçš„è®¢å•
        if (!order.getStatus().equals("PENDING") && !order.getStatus().equals("CANCELLED")) {
            return false;
        }
        
        // ç®¡ç†å‘˜æˆ–è®¢å•æ‰€æœ‰è€…å¯ä»¥åˆ é™¤
        return hasRole(username, "ADMIN") || order.getUsername().equals(username);
    }
}
```

---

## 8. ğŸ›¡ï¸ API å®‰å…¨é˜²æŠ¤


### 8.1 API å®‰å…¨å¨èƒ


âš ï¸ **å¸¸è§å®‰å…¨å¨èƒ**

```
APIå®‰å…¨å¨èƒåˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤–éƒ¨å¨èƒ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  DDoSæ”»å‡»   â”‚  â”‚  SQLæ³¨å…¥    â”‚  â”‚  XSSæ”»å‡»    â”‚      â”‚
â”‚  â”‚ å¤§é‡è¯·æ±‚   â”‚  â”‚ æ¶æ„æŸ¥è¯¢   â”‚  â”‚ è„šæœ¬æ³¨å…¥   â”‚      â”‚
â”‚  â”‚ è€—å°½èµ„æº   â”‚  â”‚ æ•°æ®æ³„éœ²   â”‚  â”‚ åŠ«æŒä¼šè¯   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å†…éƒ¨å¨èƒ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  æƒé™æ»¥ç”¨   â”‚  â”‚  æ•°æ®æ³„éœ²   â”‚  â”‚  é…ç½®é”™è¯¯   â”‚      â”‚
â”‚  â”‚ è¶…å‡ºæƒé™   â”‚  â”‚ å†…éƒ¨äººå‘˜   â”‚  â”‚ æš´éœ²æ•æ„Ÿ   â”‚      â”‚
â”‚  â”‚ æ¶æ„æ“ä½œ   â”‚  â”‚ æ•…æ„æ³„éœ²   â”‚  â”‚ ä¿¡æ¯æ³„éœ²   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 API é™æµé˜²æŠ¤


**åŸºäºRedisçš„é™æµå®ç°ï¼š**
```java
@Component
public class RateLimitFilter implements GlobalFilter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // æ¯ä¸ªAPIæ¯åˆ†é’Ÿæœ€å¤š100æ¬¡è¯·æ±‚
    private static final int MAX_REQUESTS_PER_MINUTE = 100;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String clientIp = getClientIp(request);
        String apiPath = request.getPath().toString();
        
        // æ„é€ é™æµkey
        String rateLimitKey = "rate_limit:" + clientIp + ":" + apiPath;
        
        try {
            // è·å–å½“å‰è®¡æ•°
            String currentStr = redisTemplate.opsForValue().get(rateLimitKey);
            int current = currentStr != null ? Integer.parseInt(currentStr) : 0;
            
            if (current >= MAX_REQUESTS_PER_MINUTE) {
                // è¶…å‡ºé™æµï¼Œè¿”å›429çŠ¶æ€ç 
                ServerHttpResponse response = exchange.getResponse();
                response.setStatusCode(HttpStatus.TOO_MANY_REQUESTS);
                response.getHeaders().set("X-RateLimit-Limit", String.valueOf(MAX_REQUESTS_PER_MINUTE));
                response.getHeaders().set("X-RateLimit-Remaining", "0");
                
                DataBuffer buffer = response.bufferFactory().wrap("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•".getBytes());
                return response.writeWith(Mono.just(buffer));
            }
            
            // å¢åŠ è®¡æ•°
            redisTemplate.opsForValue().increment(rateLimitKey);
            redisTemplate.expire(rateLimitKey, 60, TimeUnit.SECONDS);
            
            // æ·»åŠ é™æµä¿¡æ¯åˆ°å“åº”å¤´
            ServerHttpResponse response = exchange.getResponse();
            response.getHeaders().set("X-RateLimit-Limit", String.valueOf(MAX_REQUESTS_PER_MINUTE));
            response.getHeaders().set("X-RateLimit-Remaining", String.valueOf(MAX_REQUESTS_PER_MINUTE - current - 1));
            
        } catch (Exception e) {
            // é™æµæ£€æŸ¥å¼‚å¸¸ï¼Œå…è®¸é€šè¿‡ï¼ˆé™çº§å¤„ç†ï¼‰
            log.error("Rate limit check failed", e);
        }
        
        return chain.filter(exchange);
    }
}
```

### 8.3 å‚æ•°éªŒè¯å’ŒSQLæ³¨å…¥é˜²æŠ¤


```java
@RestController
@RequestMapping("/api/users")
@Validated  // å¼€å¯å‚æ•°éªŒè¯
public class UserController {
    
    @Autowired
    private UserService userService;
    
    // åˆ›å»ºç”¨æˆ· - å‚æ•°éªŒè¯
    @PostMapping
    public ResponseEntity<User> createUser(@Valid @RequestBody CreateUserRequest request) {
        User user = userService.createUser(request);
        return ResponseEntity.ok(user);
    }
    
    // æŸ¥è¯¢ç”¨æˆ· - é˜²æ­¢SQLæ³¨å…¥
    @GetMapping("/search")
    public ResponseEntity<List<User>> searchUsers(
            @RequestParam @Pattern(regexp = "^[a-zA-Z0-9_]{1,50}$", message = "ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®") String username,
            @RequestParam @Min(1) @Max(100) int limit) {
        
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
        List<User> users = userService.searchByUsername(username, limit);
        return ResponseEntity.ok(users);
    }
}

// è¯·æ±‚å¯¹è±¡éªŒè¯
public class CreateUserRequest {
    
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Size(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¹‹é—´")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 6, max = 20, message = "å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä¹‹é—´")
    private String password;
    
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
    
    // getters and setters...
}
```

### 8.4 HTTPS å’Œæ•°æ®åŠ å¯†


**å¼ºåˆ¶HTTPSé…ç½®ï¼š**
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å¼ºåˆ¶ä½¿ç”¨HTTPS
            .requiresChannel(channel -> 
                channel.anyRequest().requiresSecure())
            
            // å®‰å…¨å¤´é…ç½®
            .headers(headers -> headers
                .frameOptions().deny()  // é˜²æ­¢é¡µé¢è¢«åµŒå…¥frame
                .contentTypeOptions().and()  // é˜²æ­¢MIMEç±»å‹å—…æ¢
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000)  // HSTS 1å¹´
                    .includeSubdomains(true)
                )
            )
            
            // å…¶ä»–å®‰å…¨é…ç½®...
            ;
            
        return http.build();
    }
}
```

**æ•æ„Ÿæ•°æ®åŠ å¯†ï¼š**
```java
@Service
public class EncryptionService {
    
    private static final String ALGORITHM = "AES";
    private static final String TRANSFORMATION = "AES/GCM/NoPadding";
    
    @Value("${app.encryption.key}")
    private String encryptionKey;
    
    // åŠ å¯†æ•æ„Ÿæ•°æ®
    public String encrypt(String plainText) {
        try {
            SecretKeySpec keySpec = new SecretKeySpec(
                encryptionKey.getBytes(), ALGORITHM);
            Cipher cipher = Cipher.getInstance(TRANSFORMATION);
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            
            byte[] encryptedData = cipher.doFinal(plainText.getBytes());
            return Base64.getEncoder().encodeToString(encryptedData);
            
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // è§£å¯†æ•æ„Ÿæ•°æ®
    public String decrypt(String encryptedText) {
        try {
            SecretKeySpec keySpec = new SecretKeySpec(
                encryptionKey.getBytes(), ALGORITHM);
            Cipher cipher = Cipher.getInstance(TRANSFORMATION);
            cipher.init(Cipher.DECRYPT_MODE, keySpec);
            
            byte[] decryptedData = cipher.doFinal(
                Base64.getDecoder().decode(encryptedText));
            return new String(decryptedData);
            
        } catch (Exception e) {
            throw new RuntimeException("è§£å¯†å¤±è´¥", e);
        }
    }
}
```

---

## 9. ğŸ”— æœåŠ¡é—´å®‰å…¨é€šä¿¡


### 9.1 æœåŠ¡é—´è®¤è¯æŒ‘æˆ˜


â­ **å…¥é—¨çº§ç†è§£**

å¾®æœåŠ¡ä¹‹é—´çš„é€šä¿¡å°±åƒå…¬å¸å†…éƒ¨éƒ¨é—¨ä¹‹é—´çš„åä½œï¼Œéœ€è¦ç¡®ä¿ï¼š
1. ç¡®è®¤å¯¹æ–¹æ˜¯åˆæ³•çš„æœåŠ¡ï¼ˆèº«ä»½è®¤è¯ï¼‰
2. ç¡®ä¿é€šä¿¡å†…å®¹ä¸è¢«çªƒå¬ï¼ˆä¼ è¾“å®‰å…¨ï¼‰
3. ç¡®ä¿é€šä¿¡å†…å®¹ä¸è¢«ç¯¡æ”¹ï¼ˆå®Œæ•´æ€§ä¿æŠ¤ï¼‰

```
æœåŠ¡é—´é€šä¿¡å®‰å…¨é—®é¢˜ï¼š
ç”¨æˆ·æœåŠ¡ â†â†’ è®¢å•æœåŠ¡ â†â†’ æ”¯ä»˜æœåŠ¡
   â”‚           â”‚           â”‚
  â“å¦‚ä½•ç¡®è®¤    â“å¦‚ä½•ä¿è¯    â“å¦‚ä½•é˜²æ­¢
  å¯¹æ–¹èº«ä»½     æ•°æ®å®‰å…¨     æ¶æ„è°ƒç”¨
```

### 9.2 æœåŠ¡é—´JWTè®¤è¯


**æœåŠ¡Tokenç”Ÿæˆï¼š**
```java
@Service
public class ServiceTokenService {
    
    @Value("${app.service.secret}")
    private String serviceSecret;
    
    // ç”ŸæˆæœåŠ¡é—´è°ƒç”¨Token
    public String generateServiceToken(String fromService, String toService) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("fromService", fromService);
        claims.put("toService", toService);
        claims.put("type", "service");
        
        return Jwts.builder()
                .setClaims(claims)
                .setSubject("service-communication")
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + 300000)) // 5åˆ†é’Ÿ
                .signWith(SignatureAlgorithm.HS512, serviceSecret)
                .compact();
    }
    
    // éªŒè¯æœåŠ¡Token
    public boolean validateServiceToken(String token, String expectedFromService, String expectedToService) {
        try {
            Claims claims = Jwts.parser()
                    .setSigningKey(serviceSecret)
                    .parseClaimsJws(token)
                    .getBody();
                    
            String fromService = claims.get("fromService", String.class);
            String toService = claims.get("toService", String.class);
            String type = claims.get("type", String.class);
            
            return "service".equals(type) && 
                   expectedFromService.equals(fromService) && 
                   expectedToService.equals(toService);
                   
        } catch (Exception e) {
            return false;
        }
    }
}
```

**Feignå®¢æˆ·ç«¯Tokenä¼ é€’ï¼š**
```java
@Component
public class ServiceTokenInterceptor implements RequestInterceptor {
    
    @Autowired
    private ServiceTokenService serviceTokenService;
    
    @Value("${spring.application.name}")
    private String currentServiceName;
    
    @Override
    public void apply(RequestTemplate template) {
        // ä»URLä¸­æå–ç›®æ ‡æœåŠ¡å
        String targetService = extractServiceFromUrl(template.url());
        
        if (targetService != null) {
            // ç”ŸæˆæœåŠ¡é—´è°ƒç”¨Token
            String serviceToken = serviceTokenService.generateServiceToken(
                currentServiceName, targetService);
                
            // æ·»åŠ åˆ°è¯·æ±‚å¤´
            template.header("X-Service-Token", serviceToken);
        }
        
        // ä¼ é€’ç”¨æˆ·Tokenï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        String userToken = getCurrentUserToken();
        if (userToken != null) {
            template.header("Authorization", "Bearer " + userToken);
        }
    }
    
    private String getCurrentUserToken() {
        // ä»å½“å‰è¯·æ±‚ä¸­è·å–ç”¨æˆ·Token
        RequestAttributes attributes = RequestContextHolder.getRequestAttributes();
        if (attributes instanceof ServletRequestAttributes) {
            HttpServletRequest request = ((ServletRequestAttributes) attributes).getRequest();
            String authHeader = request.getHeader("Authorization");
            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                return authHeader.substring(7);
            }
        }
        return null;
    }
}
```

### 9.3 æœåŠ¡é—´æƒé™éªŒè¯


```java
@Component
public class ServiceAuthFilter implements Filter {
    
    @Autowired
    private ServiceTokenService serviceTokenService;
    
    @Value("${spring.application.name}")
    private String currentServiceName;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // è·³è¿‡å¥åº·æ£€æŸ¥ç­‰å†…éƒ¨æ¥å£
        if (isInternalPath(httpRequest.getRequestURI())) {
            chain.doFilter(request, response);
            return;
        }
        
        // æ£€æŸ¥æœåŠ¡é—´è°ƒç”¨Token
        String serviceToken = httpRequest.getHeader("X-Service-Token");
        if (serviceToken != null) {
            // éªŒè¯æœåŠ¡Token
            String fromService = extractFromServiceFromPath(httpRequest.getRequestURI());
            if (serviceTokenService.validateServiceToken(serviceToken, fromService, currentServiceName)) {
                // æœåŠ¡é—´è°ƒç”¨ï¼Œå…è®¸é€šè¿‡
                chain.doFilter(request, response);
                return;
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·Token
        String userToken = extractUserToken(httpRequest);
        if (userToken != null && validateUserToken(userToken)) {
            // ç”¨æˆ·è°ƒç”¨ï¼Œå…è®¸é€šè¿‡
            chain.doFilter(request, response);
            return;
        }
        
        // æ²¡æœ‰æœ‰æ•ˆè®¤è¯ï¼Œæ‹’ç»è®¿é—®
        httpResponse.setStatus(HttpStatus.UNAUTHORIZED.value());
        httpResponse.getWriter().write("Unauthorized access");
    }
}
```

### 9.4 TLS/SSL æœåŠ¡é—´åŠ å¯†


**é…ç½®æœåŠ¡é—´HTTPSé€šä¿¡ï¼š**
```yaml
# application.yml
feign:
  client:
    config:
      default:
        # å¯ç”¨HTTPS
        url: https://
        connect-timeout: 5000
        read-timeout: 5000
      # ç‰¹å®šæœåŠ¡é…ç½®
      user-service:
        url: https://user-service:8443
      order-service:
        url: https://order-service:8443

# SSLé…ç½®
server:
  port: 8443
  ssl:
    key-store: classpath:keystore.p12
    key-store-password: password
    key-store-type: PKCS12
    key-alias: microservice
```

**è‡ªå®šä¹‰SSLé…ç½®ï¼š**
```java
@Configuration
public class SSLConfig {
    
    @Bean
    public RestTemplate restTemplate() throws Exception {
        TrustStrategy acceptingTrustStrategy = (cert, authType) -> true;
        
        SSLContext sslContext = SSLContexts.custom()
                .loadTrustMaterial(null, acceptingTrustStrategy)
                .build();
                
        SSLConnectionSocketFactory connectionSocketFactory = 
            new SSLConnectionSocketFactory(sslContext, NoopHostnameVerifier.INSTANCE);
        
        HttpClientBuilder httpClientBuilder = HttpClients.custom()
                .setSSLSocketFactory(connectionSocketFactory);
                
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setHttpClient(httpClientBuilder.build());
        
        return new RestTemplate(factory);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


ğŸ”¥ **æœ€é‡è¦çš„å®‰å…¨æ¦‚å¿µ**
```
ğŸ”¸ è®¤è¯ vs æˆæƒï¼šè®¤è¯æ˜¯"ä½ æ˜¯è°"ï¼Œæˆæƒæ˜¯"ä½ èƒ½åšä»€ä¹ˆ"
ğŸ”¸ JWT Tokenï¼šæ— çŠ¶æ€è®¤è¯ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
ğŸ”¸ OAuth2.1ï¼šæ ‡å‡†çš„æˆæƒåè®®ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•
ğŸ”¸ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒï¼šä¸€ä¸ªåœ°æ–¹ç®¡ç†æ‰€æœ‰ç”¨æˆ·èº«ä»½
ğŸ”¸ SSOå•ç‚¹ç™»å½•ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„å¯ç”¨
ğŸ”¸ RBACæƒé™æ¨¡å‹ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
ğŸ”¸ APIå®‰å…¨é˜²æŠ¤ï¼šé™æµã€éªŒè¯ã€åŠ å¯†ä¿æŠ¤æ¥å£
ğŸ”¸ æœåŠ¡é—´å®‰å…¨ï¼šç¡®ä¿å¾®æœåŠ¡ä¹‹é—´é€šä¿¡å®‰å…¨
```

### 10.2 å®é™…åº”ç”¨æŒ‡å¯¼


â­ **æ–°æ‰‹å­¦ä¹ è·¯å¾„**
```
ç¬¬1æ­¥ï¼šç†è§£åŸºç¡€æ¦‚å¿µ
â”œâ”€ è®¤è¯å’Œæˆæƒçš„åŒºåˆ«
â”œâ”€ JWT Tokençš„ä½œç”¨
â””â”€ ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ

ç¬¬2æ­¥ï¼šæŒæ¡æ ¸å¿ƒæŠ€æœ¯
â”œâ”€ Spring Securityé…ç½®
â”œâ”€ JWTç”Ÿæˆå’ŒéªŒè¯
â””â”€ OAuth2.1æµç¨‹

ç¬¬3æ­¥ï¼šå®è·µåº”ç”¨åœºæ™¯
â”œâ”€ å®ç°ç™»å½•æ³¨å†ŒåŠŸèƒ½
â”œâ”€ é…ç½®æƒé™æ§åˆ¶
â””â”€ æœåŠ¡é—´å®‰å…¨é€šä¿¡

ç¬¬4æ­¥ï¼šå®‰å…¨é˜²æŠ¤åŠ å¼º
â”œâ”€ APIé™æµä¿æŠ¤
â”œâ”€ å‚æ•°éªŒè¯é˜²æ³¨å…¥
â””â”€ HTTPSåŠ å¯†ä¼ è¾“
```

### 10.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


ğŸ’¡ **å®ç”¨æŠ€å·§**

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | å®ç°è¦ç‚¹ |
|------|---------|----------|
| **Tokenè¿‡æœŸ** | `åˆ·æ–°Tokenæœºåˆ¶` | `refresh_token + access_tokenåŒToken` |
| **è·¨åŸŸè®¿é—®** | `CORSé…ç½®` | `å…è®¸ç‰¹å®šåŸŸåå’Œè¯·æ±‚å¤´` |
| **æƒé™è¿‡ç»†** | `è§’è‰²èšåˆ` | `å°†ç›¸å…³æƒé™ç»„åˆæˆè§’è‰²` |
| **æ€§èƒ½é—®é¢˜** | `ç¼“å­˜ç”¨æˆ·ä¿¡æ¯` | `Redisç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯` |
| **å®‰å…¨å®¡è®¡** | `æ“ä½œæ—¥å¿—è®°å½•` | `è®°å½•å…³é”®æ“ä½œå’Œå¼‚å¸¸è®¿é—®` |

### 10.4 æœ€ä½³å®è·µå»ºè®®


âœ¨ **æ¨èåšæ³•**
- **å¯†ç å®‰å…¨**ï¼šä½¿ç”¨BCryptåŠ å¯†ï¼Œå¼ºåˆ¶å¤æ‚å¯†ç ç­–ç•¥
- **Tokenæœ‰æ•ˆæœŸ**ï¼šAccess TokençŸ­æœŸï¼ˆ1å°æ—¶ï¼‰ï¼ŒRefresh Tokené•¿æœŸï¼ˆ7å¤©ï¼‰  
- **æƒé™æœ€å°åŒ–**ï¼šåªç»™å¿…è¦çš„æƒé™ï¼Œé¿å…æƒé™è¿‡å¤§
- **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§å¼‚å¸¸ç™»å½•å’Œæƒé™è®¿é—®

ğŸš« **é¿å…åšæ³•**
- ä¸è¦åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- ä¸è¦ä½¿ç”¨å¼±åŠ å¯†ç®—æ³•
- ä¸è¦å¿½ç•¥HTTPSä¼ è¾“åŠ å¯†
- ä¸è¦æŠŠæ‰€æœ‰æƒé™ç»™ä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜è§’è‰²

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
- è®¤è¯é—®èº«ä»½ï¼Œæˆæƒé—®æƒé™
- Tokenæ— çŠ¶æ€ï¼ŒæœåŠ¡å¯æ‰©å±•  
- ç»Ÿä¸€è®¤è¯ä¸­å¿ƒï¼Œå®‰å…¨ä¸€æŠŠæŠ“
- æœ€å°æƒé™åŸåˆ™ï¼Œå®‰å…¨ç¬¬ä¸€ä½