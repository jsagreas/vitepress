---
title: 7ã€æ¶ˆæ¯é©±åŠ¨æ¶æ„
---
## ğŸ“š ç›®å½•


1. [ä»€ä¹ˆæ˜¯æ¶ˆæ¯é©±åŠ¨æ¶æ„](#1-ä»€ä¹ˆæ˜¯æ¶ˆæ¯é©±åŠ¨æ¶æ„)
2. [Spring Cloud Stream æ ¸å¿ƒæ¦‚å¿µ](#2-spring-cloud-stream-æ ¸å¿ƒæ¦‚å¿µ)
3. [æ¶ˆæ¯ä¸­é—´ä»¶é›†æˆ](#3-æ¶ˆæ¯ä¸­é—´ä»¶é›†æˆ)
4. [æ¶ˆæ¯å¯é æ€§ä¿è¯](#4-æ¶ˆæ¯å¯é æ€§ä¿è¯)
5. [äº‹ä»¶é©±åŠ¨æ¶æ„å®æˆ˜](#5-äº‹ä»¶é©±åŠ¨æ¶æ„å®æˆ˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ“š **å‰ç½®çŸ¥è¯†**


å­¦ä¹ æœ¬ç« å‰ï¼Œä½ éœ€è¦äº†è§£ï¼š
- Java åŸºç¡€è¯­æ³•
- Spring Boot åŸºæœ¬ä½¿ç”¨
- å¾®æœåŠ¡åŸºç¡€æ¦‚å¿µ

# ğŸ¯ **å­¦ä¹ ç›®æ ‡**


å­¦å®Œæœ¬ç« ï¼Œä½ å°†æŒæ¡ï¼š
- ç†è§£ä»€ä¹ˆæ˜¯æ¶ˆæ¯é©±åŠ¨æ¶æ„ï¼Œä¸ºä»€ä¹ˆéœ€è¦å®ƒ
- æŒæ¡ Spring Cloud Stream çš„æ ¸å¿ƒä½¿ç”¨æ–¹æ³•
- å­¦ä¼šé›†æˆä¸»æµæ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆRabbitMQã€Kafkaï¼‰
- äº†è§£å¦‚ä½•ä¿è¯æ¶ˆæ¯çš„å¯é ä¼ è¾“

---

## 1. ğŸŒ ä»€ä¹ˆæ˜¯æ¶ˆæ¯é©±åŠ¨æ¶æ„



### 1.1 ä¼ ç»Ÿè°ƒç”¨ vs æ¶ˆæ¯é©±åŠ¨



**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é©±åŠ¨ï¼Ÿ**

æƒ³è±¡ä¸€ä¸ªç”µå•†åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•åéœ€è¦åšå¾ˆå¤šäº‹æƒ…

```
ä¼ ç»ŸåŒæ­¥è°ƒç”¨ï¼ˆä¸²è”ï¼‰ï¼š
ç”¨æˆ·ä¸‹å• â†’ å‡åº“å­˜ â†’ å‘é€çŸ­ä¿¡ â†’ æ¨é€æ¶ˆæ¯ â†’ ç”Ÿæˆå‘ç¥¨ â†’ ç‰©æµé…é€

é—®é¢˜ï¼š
âŒ ä»»ä½•ä¸€ä¸ªç¯èŠ‚å‡ºé”™ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥
âŒ å“åº”æ—¶é—´ = æ‰€æœ‰ç¯èŠ‚æ—¶é—´ä¹‹å’Œï¼ˆå¾ˆæ…¢ï¼‰
âŒ å„ä¸ªç³»ç»Ÿç´§å¯†è€¦åˆï¼Œéš¾ä»¥ç»´æŠ¤
```

```
æ¶ˆæ¯é©±åŠ¨ï¼ˆå¹¶è”ï¼‰ï¼š
ç”¨æˆ·ä¸‹å• â†’ å‘å¸ƒ"è®¢å•åˆ›å»º"äº‹ä»¶
         â†“
    æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆåƒé‚®å±€ï¼‰
         â†“
å¹¶è¡Œå¤„ç†ï¼šå‡åº“å­˜ã€å‘çŸ­ä¿¡ã€æ¨æ¶ˆæ¯ã€ç”Ÿæˆå‘ç¥¨ã€å®‰æ’ç‰©æµ

ä¼˜åŠ¿ï¼š
âœ… è§£è€¦ï¼šå„æœåŠ¡ç‹¬ç«‹å·¥ä½œï¼Œä¸äº’ç›¸å½±å“
âœ… å¼‚æ­¥ï¼šå“åº”é€Ÿåº¦å¿«ï¼Œç”¨æˆ·ä½“éªŒå¥½
âœ… å¯é ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¤±è´¥å¯é‡è¯•
âœ… æ‰©å±•ï¼šæ–°å¢ä¸šåŠ¡é€»è¾‘ä¸å½±å“ç°æœ‰ä»£ç 
```

**ğŸ·ï¸ ä¸“ä¸šæœ¯è¯­è§£é‡Š**
- **`æ¶ˆæ¯é©±åŠ¨`** = é€šè¿‡æ¶ˆæ¯ä¼ é€’æ¥è§¦å‘ä¸šåŠ¡é€»è¾‘çš„æ¶æ„æ¨¡å¼
- **`è§£è€¦`** = ç³»ç»Ÿä¹‹é—´ä¸ç›´æ¥ä¾èµ–ï¼Œé€šè¿‡æ¶ˆæ¯é—´æ¥äº¤äº’
- **`å¼‚æ­¥`** = ä¸éœ€è¦ç­‰å¾…å¤„ç†å®Œæˆï¼Œç«‹å³è¿”å›ç»“æœ

### 1.2 æ¶ˆæ¯é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒç»„ä»¶



```
æ¶ˆæ¯é©±åŠ¨æ¶æ„å…¨æ™¯å›¾ï¼š

ç”Ÿäº§è€…æœåŠ¡          æ¶ˆæ¯ä¸­é—´ä»¶          æ¶ˆè´¹è€…æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â”‚ â”€â”€â”€â†’  â”‚          â”‚  â”€â”€â”€â†’ â”‚ åº“å­˜æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  æ¶ˆæ¯é˜Ÿåˆ—  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚          â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚          â”‚  â”€â”€â”€â†’ â”‚ é€šçŸ¥æœåŠ¡ â”‚
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”€â”€â”€â†’  â”‚          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ æ—¥å¿—æœåŠ¡ â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ æ ¸å¿ƒè§’è‰²è¯´æ˜**

| è§’è‰² | ä½œç”¨ | ç”Ÿæ´»ç±»æ¯” |
|------|------|----------|
| **ç”Ÿäº§è€…** | å‘é€æ¶ˆæ¯çš„æœåŠ¡ | ğŸ“® å¯„ä¿¡äºº |
| **æ¶ˆè´¹è€…** | æ¥æ”¶å¤„ç†æ¶ˆæ¯çš„æœåŠ¡ | ğŸ“¬ æ”¶ä¿¡äºº |
| **æ¶ˆæ¯ä¸­é—´ä»¶** | å­˜å‚¨è½¬å‘æ¶ˆæ¯ | ğŸ¢ é‚®å±€ |
| **é˜Ÿåˆ—/ä¸»é¢˜** | æ¶ˆæ¯å­˜æ”¾çš„åœ°æ–¹ | ğŸ“¦ é‚®ç®± |

### 1.3 æ¶ˆæ¯é©±åŠ¨çš„åº”ç”¨åœºæ™¯



**ğŸ® åœºæ™¯æ¨¡æ‹Ÿ**

**åœºæ™¯1ï¼šç”µå•†è®¢å•å¤„ç†**
```
ç”¨æˆ·ç‚¹å‡»"ä¸‹å•" 
â†“
è®¢å•æœåŠ¡åˆ›å»ºè®¢å•ï¼Œå‘é€æ¶ˆæ¯ï¼š
{
  "eventType": "ORDER_CREATED",
  "orderId": "12345",
  "userId": "user001",
  "amount": 299.00
}
â†“
å¤šä¸ªæœåŠ¡å¹¶è¡Œå¤„ç†ï¼š
â€¢ åº“å­˜æœåŠ¡ï¼šå‡å°‘å•†å“åº“å­˜
â€¢ æ”¯ä»˜æœåŠ¡ï¼šåˆ›å»ºæ”¯ä»˜è®°å½•  
â€¢ ç‰©æµæœåŠ¡ï¼šå®‰æ’å‘è´§
â€¢ é€šçŸ¥æœåŠ¡ï¼šå‘é€è®¢å•ç¡®è®¤çŸ­ä¿¡
```

**åœºæ™¯2ï¼šç”¨æˆ·æ³¨å†Œæµç¨‹**
```
ç”¨æˆ·å®Œæˆæ³¨å†Œ
â†“
ç”¨æˆ·æœåŠ¡å‘é€æ¶ˆæ¯ï¼š
{
  "eventType": "USER_REGISTERED", 
  "userId": "user001",
  "email": "user@example.com"
}
â†“
å¹¶è¡Œå¤„ç†ï¼š
â€¢ é‚®ä»¶æœåŠ¡ï¼šå‘é€æ¬¢è¿é‚®ä»¶
â€¢ ç§¯åˆ†æœåŠ¡ï¼šåˆå§‹åŒ–ç”¨æˆ·ç§¯åˆ†
â€¢ æ¨èæœåŠ¡ï¼šåˆ†æç”¨æˆ·åå¥½
â€¢ ç»Ÿè®¡æœåŠ¡ï¼šæ›´æ–°æ³¨å†Œæ•°æ®
```

**ğŸ’¡ è®°å¿†æŠ€å·§**
æ¶ˆæ¯é©±åŠ¨å°±åƒ**ç¾¤å‘é€šçŸ¥**ï¼š
- ç­é•¿å‘é€šçŸ¥åˆ°ç­çº§ç¾¤ï¼ˆç”Ÿäº§è€…å‘æ¶ˆæ¯ï¼‰
- æ‰€æœ‰åŒå­¦éƒ½æ”¶åˆ°é€šçŸ¥ï¼ˆæ¶ˆè´¹è€…æ¥æ”¶ï¼‰  
- æ¯ä¸ªäººæ ¹æ®é€šçŸ¥åšè‡ªå·±çš„äº‹ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
- ç­é•¿ä¸ç”¨ç­‰æ‰€æœ‰äººå›å¤å°±èƒ½ç»§ç»­å·¥ä½œï¼ˆå¼‚æ­¥ï¼‰

---

## 2. âš¡ Spring Cloud Stream æ ¸å¿ƒæ¦‚å¿µ



### 2.1 ä»€ä¹ˆæ˜¯ Spring Cloud Stream



**ğŸ” æ·±å…¥ç†è§£**

Spring Cloud Stream æ˜¯ä¸€ä¸ª**æ¶ˆæ¯é©±åŠ¨å¾®æœåŠ¡çš„æ¡†æ¶**ï¼Œå°±åƒç»™ä¸åŒçš„æ¶ˆæ¯ä¸­é—´ä»¶ç©¿ä¸Šäº†**ç»Ÿä¸€çš„å¤–å¥—**ã€‚

```
æ²¡æœ‰ Spring Cloud Stream çš„ç—›è‹¦ï¼š
                    
RabbitMQ ä»£ç          Kafka ä»£ç          RocketMQ ä»£ç 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚@RabbitListenerâ”‚      â”‚@KafkaListenerâ”‚    â”‚@RocketMQListenerâ”‚
â”‚ä¸åŒçš„API      â”‚      â”‚ä¸åŒçš„API      â”‚    â”‚ä¸åŒçš„API       â”‚
â”‚ä¸åŒçš„é…ç½®     â”‚      â”‚ä¸åŒçš„é…ç½®     â”‚    â”‚ä¸åŒçš„é…ç½®      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                     â†‘                    â†‘
   å­¦ä¹ æˆæœ¬é«˜           è¿ç§»å›°éš¾              ç»´æŠ¤å¤æ‚
```

```
æœ‰äº† Spring Cloud Stream çš„ä¾¿åˆ©ï¼š

ç»Ÿä¸€çš„ç¼–ç¨‹æ¨¡å‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   @StreamListener   â”‚  â† ç»Ÿä¸€æ³¨è§£
â”‚   @Input/@Output    â”‚  â† ç»Ÿä¸€API
â”‚   ç»Ÿä¸€é…ç½®æ–¹å¼       â”‚  â† ç»Ÿä¸€é…ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    Spring Cloud Stream
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚RabbitMQ â”‚  Kafka  â”‚ RocketMQ â”‚ â† åº•å±‚é€‚é…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼**
- **ä¸€å¥—ä»£ç ï¼Œå¤šç§ä¸­é—´ä»¶**ï¼šå†™ä¸€æ¬¡ä»£ç ï¼Œå¯ä»¥è·‘åœ¨ä¸åŒæ¶ˆæ¯ä¸­é—´ä»¶ä¸Š
- **é™ä½å­¦ä¹ æˆæœ¬**ï¼šåªéœ€è¦å­¦ä¸€å¥—API
- **ä¾¿äºåˆ‡æ¢**ï¼šä»RabbitMQåˆ‡æ¢åˆ°Kafkaåªéœ€è¦æ”¹é…ç½®

### 2.2 æ ¸å¿ƒæ¦‚å¿µè¯¦è§£



**ğŸ“– ä¸“ä¸šæœ¯è¯­é€šä¿—è§£é‡Š**

```
Spring Cloud Stream æ¦‚å¿µå›¾ï¼š

åº”ç”¨ç¨‹åº                    ä¸­é—´ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚           â”‚             â”‚
â”‚  @Input     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  RabbitMQ   â”‚
â”‚  (æ¶ˆæ¯è¾“å…¥)   â”‚   ç»‘å®š     â”‚             â”‚
â”‚             â”‚  Binding   â”‚   Kafka     â”‚
â”‚  @Output    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚  (æ¶ˆæ¯è¾“å‡º)   â”‚           â”‚  RocketMQ   â”‚
â”‚             â”‚           â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                         â†‘
   é€šé“Channel              æ¶ˆæ¯ä¸­é—´ä»¶
```

**ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶è¯¦è§£**

**1. Binderï¼ˆç»‘å®šå™¨ï¼‰**
```
ä»€ä¹ˆæ˜¯ Binderï¼Ÿ
å°±åƒã€Œç¿»è¯‘å®˜ã€ï¼ŒæŠŠç»Ÿä¸€çš„Stream APIç¿»è¯‘æˆå„ç§ä¸­é—´ä»¶èƒ½ç†è§£çš„è¯­è¨€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½ çš„ä¸šåŠ¡ä»£ç    â”‚ â”€â–º â”‚   Binder    â”‚ â”€â–º â”‚  RabbitMQ   â”‚
â”‚ @StreamListenerâ”‚    â”‚  (ç¿»è¯‘å®˜)    â”‚    â”‚   å®é™…æ¶ˆæ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. Channelï¼ˆé€šé“ï¼‰**
```
Input Channelï¼ˆè¾“å…¥é€šé“ï¼‰ï¼šæ¥æ”¶æ¶ˆæ¯çš„ç®¡é“
Output Channelï¼ˆè¾“å‡ºé€šé“ï¼‰ï¼šå‘é€æ¶ˆæ¯çš„ç®¡é“

å°±åƒæ°´ç®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Input    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Output   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆæ¯æ¥æº â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ ä½ çš„åº”ç”¨  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ æ¶ˆæ¯å»å‘ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Bindingï¼ˆç»‘å®šï¼‰**
```
ç»‘å®šå°±æ˜¯ã€Œæ¥çº¿å‘˜ã€ï¼Œè´Ÿè´£æŠŠé€šé“å’Œå…·ä½“çš„é˜Ÿåˆ—/ä¸»é¢˜è¿æ¥èµ·æ¥

é…ç½®ç¤ºä¾‹ï¼š
spring:
  cloud:
    stream:
      bindings:
        input:          # é€šé“å
          destination: user-topic    # å®é™…çš„é˜Ÿåˆ—/ä¸»é¢˜å
          group: user-service-group  # æ¶ˆè´¹è€…ç»„
```

### 2.3 å¿«é€Ÿå…¥é—¨ç¤ºä¾‹



**ğŸª è§’è‰²æ‰®æ¼”**ï¼šæˆ‘ä»¬æ¥å¼€å‘ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯ç³»ç»Ÿ

**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šæ¶ˆæ¯å‘é€è€…**
```java
@RestController
public class MessageSender {
    
    @Autowired
    private MessageChannel output; // è¾“å‡ºé€šé“
    
    @GetMapping("/send")
    public String sendMessage(String content) {
        // åˆ›å»ºæ¶ˆæ¯
        Message<String> message = MessageBuilder
            .withPayload(content)
            .setHeader("timestamp", System.currentTimeMillis())
            .build();
            
        // å‘é€æ¶ˆæ¯ï¼ˆå°±åƒå¯„ä¿¡ï¼‰
        output.send(message);
        return "æ¶ˆæ¯å·²å‘é€ï¼š" + content;
    }
}
```

**æ­¥éª¤3ï¼šæ¶ˆæ¯æ¥æ”¶è€…**
```java
@Component
public class MessageReceiver {
    
    @StreamListener("input") // ç›‘å¬è¾“å…¥é€šé“
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        processBusinessLogic(message);
    }
    
    private void processBusinessLogic(String message) {
        // è¿™é‡Œå†™ä½ çš„ä¸šåŠ¡å¤„ç†ä»£ç 
        System.out.println("æ­£åœ¨å¤„ç†ï¼š" + message);
    }
}
```

**æ­¥éª¤4ï¼šé…ç½®æ–‡ä»¶**
```yaml
spring:
  cloud:
    stream:
      bindings:
        output:  # å‘é€é€šé“
          destination: my-topic
        input:   # æ¥æ”¶é€šé“
          destination: my-topic
          group: my-service-group
```

**ğŸ’­ æ€è€ƒä¸€ä¸‹**ï¼šè¿™ä¸ªä¾‹å­ä¸­ï¼Œå‘é€è€…å’Œæ¥æ”¶è€…é€šè¿‡ `my-topic` è¿™ä¸ªä¸»é¢˜è¿›è¡Œé€šä¿¡ï¼Œå°±åƒä¸¤ä¸ªäººé€šè¿‡åŒä¸€ä¸ªé‚®ç®±æ”¶å‘ä¿¡ä»¶ã€‚

---

## 3. ğŸ”— æ¶ˆæ¯ä¸­é—´ä»¶é›†æˆ



### 3.1 RabbitMQ é›†æˆ



**ğŸŒ° ä¸¾ä¸ªä¾‹å­**ï¼šRabbitMQ å°±åƒä¸€ä¸ª**æ™ºèƒ½é‚®å±€**

```
RabbitMQ å·¥ä½œåŸç†ï¼š

ç”Ÿäº§è€…          äº¤æ¢æœº           é˜Ÿåˆ—          æ¶ˆè´¹è€…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è®¢å•æœåŠ¡  â”‚â”€â”€â”€â–ºâ”‚Exchange â”‚â”€â”€â”€â–ºâ”‚ Queue   â”‚â”€â”€â”€â–ºâ”‚åº“å­˜æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚
  å‘æ¶ˆæ¯        è·¯ç”±åˆ†å‘       æš‚å­˜æ¶ˆæ¯       å¤„ç†æ¶ˆæ¯
```

**ğŸ¯ æœ€ä½³å®è·µé…ç½®**

**ä¾èµ–é…ç½®**
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
</dependency>
```

**è¯¦ç»†é…ç½®è§£é‡Š**
```yaml
spring:
  cloud:
    stream:
      rabbit:
        bindings:
          order-output:
            producer:
              exchange-type: topic    # äº¤æ¢æœºç±»å‹ï¼šæ”¯æŒæ¨¡ç³ŠåŒ¹é…
              routing-key-expression: "'order.created'" # è·¯ç”±é”®
          order-input:
            consumer:
              acknowledge-mode: manual # æ‰‹åŠ¨ç¡®è®¤ï¼ˆä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼‰
              max-attempts: 3         # é‡è¯•æ¬¡æ•°
              back-off-initial-interval: 1000  # é‡è¯•é—´éš”
      bindings:
        order-output:
          destination: order.exchange  # äº¤æ¢æœºåç§°
        order-input:
          destination: order.exchange  # äº¤æ¢æœºåç§°
          group: inventory-service     # æ¶ˆè´¹è€…ç»„ï¼ˆå¾ˆé‡è¦ï¼ï¼‰
```

**âš ï¸ é‡è¦æé†’**ï¼šæ¶ˆè´¹è€…ç»„çš„ä½œç”¨
```
æ²¡æœ‰æ¶ˆè´¹è€…ç»„çš„é—®é¢˜ï¼š
æ¶ˆæ¯å‘é€ç»™3ä¸ªç›¸åŒçš„æœåŠ¡å®ä¾‹ â†’ åŒä¸€æ¡æ¶ˆæ¯è¢«å¤„ç†3æ¬¡ â†’ æ•°æ®é‡å¤

æœ‰æ¶ˆè´¹è€…ç»„çš„å¥½å¤„ï¼š
æ¶ˆæ¯åªä¼šè¢«ç»„å†…ä¸€ä¸ªå®ä¾‹å¤„ç† â†’ é¿å…é‡å¤å¤„ç† â†’ è¿˜èƒ½è´Ÿè½½å‡è¡¡
```

**å®é™…åº”ç”¨ç¤ºä¾‹**
```java
// è®¢å•æœåŠ¡ï¼šå‘é€è®¢å•åˆ›å»ºäº‹ä»¶
@Service
public class OrderService {
    
    @Autowired
    @Qualifier("order-output")
    private MessageChannel orderOutput;
    
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
        orderRepository.save(order);
        
        // 2. å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–æœåŠ¡
        OrderCreatedEvent event = new OrderCreatedEvent(
            order.getId(), 
            order.getUserId(), 
            order.getAmount()
        );
        
        Message<OrderCreatedEvent> message = MessageBuilder
            .withPayload(event)
            .setHeader("eventType", "ORDER_CREATED")
            .build();
            
        orderOutput.send(message);
    }
}
```

```java
// åº“å­˜æœåŠ¡ï¼šå¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶
@Component
public class InventoryService {
    
    @StreamListener("order-input")
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // å‡å°‘åº“å­˜
            inventoryRepository.decreaseStock(
                event.getProductId(), 
                event.getQuantity()
            );
            
            System.out.println("åº“å­˜å¤„ç†å®Œæˆï¼šè®¢å•ID=" + event.getOrderId());
            
        } catch (Exception e) {
            // åº“å­˜ä¸è¶³æˆ–å…¶ä»–å¼‚å¸¸
            System.err.println("åº“å­˜å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
            throw e; // æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        }
    }
}
```

### 3.2 Kafka é›†æˆ



**ğŸ”„ æ¢å¥è¯è¯´**ï¼šKafka å°±åƒä¸€ä¸ª**è¶…å¤§å®¹é‡çš„æ—¥å¿—æœ¬**

```
Kafka ç‰¹ç‚¹å¯¹æ¯”ï¼š

RabbitMQï¼ˆä¼ ç»Ÿé‚®å±€ï¼‰         Kafkaï¼ˆç°ä»£ç‰©æµä¸­å¿ƒï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â€¢ æ¶ˆæ¯å¤„ç†å®Œå°±åˆ é™¤ â”‚        â”‚â€¢ æ¶ˆæ¯é•¿æœŸä¿å­˜       â”‚
â”‚â€¢ é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜ â”‚        â”‚â€¢ é€‚åˆå¤§æ•°æ®é‡       â”‚
â”‚â€¢ åŠŸèƒ½ä¸°å¯Œï¼ˆè·¯ç”±ï¼‰ â”‚        â”‚â€¢ ååé‡è¶…é«˜         â”‚
â”‚â€¢ ä¸­å°å‹åº”ç”¨      â”‚        â”‚â€¢ å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Kafka é…ç½®ç¤ºä¾‹**
```yaml
spring:
  cloud:
    stream:
      kafka:
        binder:
          brokers: localhost:9092  # KafkaæœåŠ¡å™¨åœ°å€
        bindings:
          user-output:
            producer:
              key-serializer: org.apache.kafka.common.serialization.StringSerializer
              value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
          user-input:
            consumer:
              key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
              value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      bindings:
        user-output:
          destination: user-events    # Kafkaä¸»é¢˜å
        user-input:
          destination: user-events
          group: notification-service # æ¶ˆè´¹è€…ç»„
```

**ğŸ› ï¸ å·¥å…·æ¨è**ï¼šåœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ Docker å¿«é€Ÿå¯åŠ¨ Kafka
```bash
# docker-compose.yml

version: '3'
services:
  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
```

### 3.3 RocketMQ é›†æˆ



**ğŸ¢ å®é™…åº”ç”¨**ï¼šRocketMQ æ˜¯é˜¿é‡Œå¼€æºçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œåœ¨å›½å†…ä¼ä¸šä½¿ç”¨è¾ƒå¤š

```
RocketMQ ä¼˜åŠ¿ï¼š
âœ… æ”¯æŒäº‹åŠ¡æ¶ˆæ¯ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
âœ… æ”¯æŒå®šæ—¶æ¶ˆæ¯ï¼ˆå»¶è¿ŸæŠ•é€’ï¼‰  
âœ… æ”¯æŒæ¶ˆæ¯è½¨è¿¹ï¼ˆæ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼‰
âœ… é«˜å¯ç”¨æ€§ï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰
```

**åŸºç¡€é…ç½®**
```yaml
spring:
  cloud:
    stream:
      rocketmq:
        binder:
          name-server: localhost:9876
        bindings:
          payment-output:
            producer:
              group: payment-producer-group
          payment-input:
            consumer:
              group: order-consumer-group
      bindings:
        payment-output:
          destination: payment-topic
        payment-input:
          destination: payment-topic
```

**ğŸ“Š æ•°æ®è¯´è¯**ï¼šé€‰æ‹©æ¶ˆæ¯ä¸­é—´ä»¶çš„å‚è€ƒ

| ç‰¹æ€§ | RabbitMQ | Kafka | RocketMQ |
|------|----------|--------|----------|
| **å­¦ä¹ éš¾åº¦** | â­â­ ç®€å• | â­â­â­ ä¸­ç­‰ | â­â­â­ ä¸­ç­‰ |
| **ååé‡** | 1ä¸‡/ç§’ | 100ä¸‡/ç§’ | 10ä¸‡/ç§’ |
| **æ¶ˆæ¯å­˜å‚¨** | å†…å­˜+ç£ç›˜ | ç£ç›˜æ—¥å¿— | ç£ç›˜æ—¥å¿— |
| **é€‚ç”¨åœºæ™¯** | ä¸­å°é¡¹ç›® | å¤§æ•°æ®/æ—¥å¿— | ä¼ä¸šçº§åº”ç”¨ |
| **ç¤¾åŒºæ”¯æŒ** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |

---

## 4. ğŸ”’ æ¶ˆæ¯å¯é æ€§ä¿è¯



### 4.1 æ¶ˆæ¯ä¸¢å¤±çš„ä¸‰ä¸ªç¯èŠ‚



**ğŸš¨ å®¹æ˜“å‡ºé”™çš„åœ°æ–¹**

```
æ¶ˆæ¯ä¼ é€’çš„å®Œæ•´é“¾è·¯ï¼š

ç”Ÿäº§è€…     â†’     æ¶ˆæ¯ä¸­é—´ä»¶     â†’     æ¶ˆè´¹è€…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å‘é€å¤±è´¥ï¼Ÿâ”‚     â”‚å­˜å‚¨ä¸¢å¤±ï¼Ÿ â”‚     â”‚å¤„ç†å¤±è´¥ï¼Ÿâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“               â†“               â†“
  ç¯èŠ‚1            ç¯èŠ‚2            ç¯èŠ‚3
```

### 4.2 ç¯èŠ‚1ï¼šç”Ÿäº§è€…å¯é æ€§



**é—®é¢˜**ï¼šå‘é€æ¶ˆæ¯æ—¶ç½‘ç»œå¼‚å¸¸ï¼Œæ¶ˆæ¯æ²¡å‘å‡ºå»

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**ï¼šç¡®è®¤æœºåˆ¶ + é‡è¯•æœºåˆ¶

```java
@Service
public class ReliableMessageSender {
    
    @Autowired
    private MessageChannel output;
    
    @Retryable(value = Exception.class, maxAttempts = 3)
    public void sendMessageWithRetry(String content) {
        try {
            Message<String> message = MessageBuilder
                .withPayload(content)
                .setHeader(MessageHeaders.CONTENT_TYPE, "text/plain")
                .build();
            
            // åŒæ­¥å‘é€ï¼Œç­‰å¾…ç¡®è®¤
            boolean success = output.send(message, 5000); // 5ç§’è¶…æ—¶
            
            if (!success) {
                throw new RuntimeException("æ¶ˆæ¯å‘é€å¤±è´¥");
            }
            
            System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸï¼š" + content);
            
        } catch (Exception e) {
            System.err.println("å‘é€å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•ï¼š" + e.getMessage());
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
        }
    }
    
    @Recover
    public void recover(Exception e, String content) {
        // é‡è¯•3æ¬¡åä»ç„¶å¤±è´¥ï¼Œè®°å½•åˆ°æ•°æ®åº“ç­‰å¾…äººå·¥å¤„ç†
        System.err.println("æ¶ˆæ¯æœ€ç»ˆå‘é€å¤±è´¥ï¼Œè®°å½•åˆ°å¤±è´¥è¡¨ï¼š" + content);
        failureLogService.saveFailedMessage(content, e.getMessage());
    }
}
```

**é…ç½®ç”Ÿäº§è€…ç¡®è®¤**
```yaml
spring:
  cloud:
    stream:
      rabbit:
        bindings:
          output:
            producer:
              confirm-type: correlated    # å¼€å¯å‘é€ç¡®è®¤
              mandatory: true            # æ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶è¿”å›
```

### 4.3 ç¯èŠ‚2ï¼šä¸­é—´ä»¶å¯é æ€§



**é—®é¢˜**ï¼šæ¶ˆæ¯ä¸­é—´ä»¶å®•æœºï¼Œå†…å­˜ä¸­çš„æ¶ˆæ¯ä¸¢å¤±

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**ï¼šæ¶ˆæ¯æŒä¹…åŒ– + é›†ç¾¤éƒ¨ç½²

**RabbitMQ æŒä¹…åŒ–é…ç½®**
```yaml
spring:
  cloud:
    stream:
      rabbit:
        bindings:
          output:
            producer:
              delivery-mode: 2  # æŒä¹…åŒ–æ¶ˆæ¯
```

**ğŸ’­ æ€è€ƒä¸€ä¸‹**ï¼šä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ
```
å†…å­˜å­˜å‚¨ï¼ˆå¿«ä½†ä¸å®‰å…¨ï¼‰ï¼š
æ¶ˆæ¯ â†’ å†…å­˜ â†’ æ–­ç”µåä¸¢å¤± âŒ

ç£ç›˜å­˜å‚¨ï¼ˆæ…¢ä½†å®‰å…¨ï¼‰ï¼š
æ¶ˆæ¯ â†’ ç£ç›˜ â†’ æ–­ç”µåæ¢å¤ âœ…

æƒè¡¡ï¼šæ€§èƒ½ vs å¯é æ€§
```

### 4.4 ç¯èŠ‚3ï¼šæ¶ˆè´¹è€…å¯é æ€§



**é—®é¢˜**ï¼šæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶å‡ºç°å¼‚å¸¸

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**ï¼šæ‰‹åŠ¨ç¡®è®¤ + é‡è¯•æœºåˆ¶ + æ­»ä¿¡é˜Ÿåˆ—

**æ‰‹åŠ¨ç¡®è®¤ç¤ºä¾‹**
```java
@Component
public class ReliableMessageConsumer {
    
    @StreamListener("input")
    public void handleMessage(
        String message, 
        @Header Map<String, Object> headers,
        Acknowledgment ack) {
        
        try {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            processBusinessLogic(message);
            
            // å¤„ç†æˆåŠŸï¼Œæ‰‹åŠ¨ç¡®è®¤
            ack.acknowledge();
            System.out.println("æ¶ˆæ¯å¤„ç†æˆåŠŸï¼š" + message);
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œä¸é‡è¯•ï¼Œç›´æ¥ç¡®è®¤ï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
            ack.acknowledge();
            System.err.println("ä¸šåŠ¡å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ï¼š" + e.getMessage());
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ï¼Œè§¦å‘é‡è¯•
            ack.reject(true); // trueè¡¨ç¤ºé‡æ–°å…¥é˜Ÿ
            System.err.println("ç³»ç»Ÿå¼‚å¸¸ï¼Œæ¶ˆæ¯é‡è¯•ï¼š" + e.getMessage());
        }
    }
    
    private void processBusinessLogic(String message) {
        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
        if (message.contains("error")) {
            throw new RuntimeException("å¤„ç†å¼‚å¸¸");
        }
        
        // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
        System.out.println("å¤„ç†æ¶ˆæ¯ï¼š" + message);
    }
}
```

**æ¶ˆè´¹è€…é‡è¯•é…ç½®**
```yaml
spring:
  cloud:
    stream:
      bindings:
        input:
          consumer:
            max-attempts: 3                    # æœ€å¤šé‡è¯•3æ¬¡
            back-off-initial-interval: 1000    # ç¬¬1æ¬¡é‡è¯•é—´éš”1ç§’
            back-off-multiplier: 2.0           # æ¯æ¬¡é‡è¯•é—´éš”ç¿»å€
            back-off-max-interval: 10000       # æœ€å¤§é‡è¯•é—´éš”10ç§’
```

### 4.5 æ­»ä¿¡é˜Ÿåˆ—å¤„ç†



**âŒ å¸¸è§è¯¯è§£**ï¼šé‡è¯•å¤±è´¥çš„æ¶ˆæ¯ä¼šæ¶ˆå¤±
**âœ… æ­£ç¡®ç†è§£**ï¼šé‡è¯•å¤±è´¥çš„æ¶ˆæ¯ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œç­‰å¾…äººå·¥å¤„ç†

```
æ¶ˆæ¯é‡è¯•æµç¨‹ï¼š

æ­£å¸¸æ¶ˆæ¯ â†’ å¤„ç†å¤±è´¥ â†’ é‡è¯•1æ¬¡ â†’ è¿˜æ˜¯å¤±è´¥ â†’ é‡è¯•2æ¬¡ â†’ ç»§ç»­å¤±è´¥ â†’ æ­»ä¿¡é˜Ÿåˆ—
                â†“
            äººå·¥æ’æŸ¥é—®é¢˜
```

**æ­»ä¿¡é˜Ÿåˆ—é…ç½®**
```yaml
spring:
  cloud:
    stream:
      rabbit:
        bindings:
          input:
            consumer:
              auto-bind-dlq: true           # è‡ªåŠ¨åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—
              dlq-ttl: 86400000            # æ­»ä¿¡æ¶ˆæ¯ä¿ç•™24å°æ—¶
              republish-to-dlq: true        # é‡è¯•å¤±è´¥åå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
```

**å¤„ç†æ­»ä¿¡æ¶ˆæ¯**
```java
@Component
public class DeadLetterHandler {
    
    @StreamListener("input.dlq") // ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—
    public void handleDeadLetter(String message, 
                                @Header Map<String, Object> headers) {
        
        System.err.println("æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯ï¼š" + message);
        System.err.println("å¼‚å¸¸ä¿¡æ¯ï¼š" + headers.get("x-exception-message"));
        
        // è®°å½•åˆ°æ•°æ®åº“ï¼Œé€šçŸ¥ç®¡ç†å‘˜
        deadLetterService.saveDeadLetter(message, headers);
        
        // å‘é€å‘Šè­¦é‚®ä»¶
        alertService.sendAlert("å‘ç°æ­»ä¿¡æ¶ˆæ¯", message);
    }
}
```

---

## 5. ğŸš€ äº‹ä»¶é©±åŠ¨æ¶æ„å®æˆ˜



### 5.1 è®¾è®¡äº‹ä»¶é©±åŠ¨ç³»ç»Ÿ



**ğŸ® åœºæ™¯æ¨¡æ‹Ÿ**ï¼šç”µå•†è®¢å•å¤„ç†ç³»ç»Ÿ

```
äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡ï¼š

ç”¨æˆ·ä¸‹å•
   â†“
è®¢å•æœåŠ¡ å‘å¸ƒäº‹ä»¶
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         äº‹ä»¶æ€»çº¿ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“          â†“         â†“          â†“
åº“å­˜æœåŠ¡    æ”¯ä»˜æœåŠ¡    ç‰©æµæœåŠ¡    é€šçŸ¥æœåŠ¡
 å‡åº“å­˜     åˆ›å»ºæ”¯ä»˜     å®‰æ’å‘è´§     å‘é€çŸ­ä¿¡
```

**ğŸ“‹ äº‹ä»¶è®¾è®¡åŸåˆ™**

```
å¥½çš„äº‹ä»¶è®¾è®¡ï¼š
âœ… äº‹ä»¶åç§°æ¸…æ™°ï¼šORDER_CREATEDï¼ˆè®¢å•å·²åˆ›å»ºï¼‰
âœ… åŒ…å«å¿…è¦ä¿¡æ¯ï¼šè®¢å•IDã€ç”¨æˆ·IDã€å•†å“ä¿¡æ¯
âœ… å‘åå…¼å®¹ï¼šæ–°å¢å­—æ®µä¸å½±å“è€ç‰ˆæœ¬æ¶ˆè´¹è€…
âœ… å¹‚ç­‰å¤„ç†ï¼šåŒä¸€äº‹ä»¶å¤šæ¬¡å¤„ç†ç»“æœä¸€è‡´

åçš„äº‹ä»¶è®¾è®¡ï¼š
âŒ äº‹ä»¶åç§°æ¨¡ç³Šï¼šDATA_CHANGEDï¼ˆä»€ä¹ˆæ•°æ®å˜äº†ï¼Ÿï¼‰
âŒ ä¿¡æ¯ä¸è¶³ï¼šåªæœ‰IDï¼Œæ¶ˆè´¹è€…è¿˜è¦æŸ¥åº“
âŒ ç ´åå…¼å®¹æ€§ï¼šåˆ é™¤æˆ–ä¿®æ”¹å·²æœ‰å­—æ®µ
âŒ æ— æ³•å¹‚ç­‰ï¼šé‡å¤å¤„ç†äº§ç”Ÿé”™è¯¯ç»“æœ
```

### 5.2 å®Œæ•´å®æˆ˜æ¡ˆä¾‹



**äº‹ä»¶å®šä¹‰**
```java
// è®¢å•äº‹ä»¶
public class OrderEvent {
    private String eventType;    // äº‹ä»¶ç±»å‹
    private String orderId;      // è®¢å•ID
    private String userId;       // ç”¨æˆ·ID
    private BigDecimal amount;   // è®¢å•é‡‘é¢
    private List<OrderItem> items; // è®¢å•å•†å“
    private LocalDateTime createTime; // åˆ›å»ºæ—¶é—´
    
    // æ„é€ å‡½æ•°ã€getterã€setterçœç•¥...
    
    // å·¥å‚æ–¹æ³•
    public static OrderEvent orderCreated(Order order) {
        OrderEvent event = new OrderEvent();
        event.setEventType("ORDER_CREATED");
        event.setOrderId(order.getId());
        event.setUserId(order.getUserId());
        event.setAmount(order.getAmount());
        event.setItems(order.getItems());
        event.setCreateTime(LocalDateTime.now());
        return event;
    }
}
```

**è®¢å•æœåŠ¡ï¼ˆäº‹ä»¶å‘å¸ƒè€…ï¼‰**
```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private EventPublisher eventPublisher;
    
    public Order createOrder(CreateOrderRequest request) {
        try {
            // 1. æ•°æ®éªŒè¯
            validateOrder(request);
            
            // 2. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setUserId(request.getUserId());
            order.setItems(request.getItems());
            order.setAmount(calculateAmount(request.getItems()));
            order.setStatus("PENDING");
            
            // 3. ä¿å­˜åˆ°æ•°æ®åº“
            Order savedOrder = orderRepository.save(order);
            
            // 4. å‘å¸ƒäº‹ä»¶ï¼ˆåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼‰
            OrderEvent event = OrderEvent.orderCreated(savedOrder);
            eventPublisher.publishEvent(event);
            
            return savedOrder;
            
        } catch (Exception e) {
            System.err.println("åˆ›å»ºè®¢å•å¤±è´¥ï¼š" + e.getMessage());
            throw e;
        }
    }
}
```

**äº‹ä»¶å‘å¸ƒå™¨**
```java
@Component
public class EventPublisher {
    
    @Autowired
    @Qualifier("order-output")
    private MessageChannel orderOutput;
    
    public void publishEvent(OrderEvent event) {
        try {
            Message<OrderEvent> message = MessageBuilder
                .withPayload(event)
                .setHeader("eventType", event.getEventType())
                .setHeader("eventId", UUID.randomUUID().toString())
                .setHeader("timestamp", System.currentTimeMillis())
                .build();
            
            boolean sent = orderOutput.send(message);
            if (!sent) {
                throw new RuntimeException("äº‹ä»¶å‘å¸ƒå¤±è´¥");
            }
            
            System.out.println("äº‹ä»¶å‘å¸ƒæˆåŠŸï¼š" + event.getEventType());
            
        } catch (Exception e) {
            System.err.println("äº‹ä»¶å‘å¸ƒå¼‚å¸¸ï¼š" + e.getMessage());
            throw e;
        }
    }
}
```

**åº“å­˜æœåŠ¡ï¼ˆäº‹ä»¶æ¶ˆè´¹è€…ï¼‰**
```java
@Component
public class InventoryEventHandler {
    
    @Autowired
    private InventoryService inventoryService;
    
    @StreamListener("order-input")
    public void handleOrderEvent(OrderEvent event) {
        
        if (!"ORDER_CREATED".equals(event.getEventType())) {
            return; // åªå¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶
        }
        
        try {
            System.out.println("å¤„ç†è®¢å•åˆ›å»ºäº‹ä»¶ï¼š" + event.getOrderId());
            
            // æ£€æŸ¥å¹¶å‡å°‘åº“å­˜
            for (OrderItem item : event.getItems()) {
                inventoryService.decreaseStock(
                    item.getProductId(), 
                    item.getQuantity()
                );
            }
            
            System.out.println("åº“å­˜å¤„ç†å®Œæˆ");
            
        } catch (InsufficientStockException e) {
            // åº“å­˜ä¸è¶³ï¼Œå‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶
            publishStockInsufficientEvent(event, e);
            
        } catch (Exception e) {
            System.err.println("åº“å­˜å¤„ç†å¼‚å¸¸ï¼š" + e.getMessage());
            throw e; // é‡æ–°æŠ›å‡ºè§¦å‘é‡è¯•
        }
    }
    
    private void publishStockInsufficientEvent(OrderEvent orderEvent, 
                                             InsufficientStockException e) {
        // å‘å¸ƒåº“å­˜ä¸è¶³äº‹ä»¶ï¼Œè®©è®¢å•æœåŠ¡å–æ¶ˆè®¢å•
        StockInsufficientEvent event = new StockInsufficientEvent();
        event.setOrderId(orderEvent.getOrderId());
        event.setReason(e.getMessage());
        
        // å‘å¸ƒäº‹ä»¶çš„ä»£ç ...
    }
}
```

### 5.3 äº‹ä»¶ç‰ˆæœ¬ç®¡ç†



**ğŸ’¥ å®¹æ˜“å‡ºé”™**ï¼šäº‹ä»¶ç»“æ„å˜æ›´å¯¼è‡´æ¶ˆè´¹è€…å¼‚å¸¸

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**ï¼šäº‹ä»¶ç‰ˆæœ¬åŒ–

```java
// V1ç‰ˆæœ¬äº‹ä»¶
public class OrderEventV1 {
    private String orderId;
    private String userId;
    private BigDecimal amount;
    // å…¶ä»–å­—æ®µ...
}

// V2ç‰ˆæœ¬äº‹ä»¶ï¼ˆæ–°å¢å­—æ®µï¼‰
public class OrderEventV2 {
    private String orderId;
    private String userId;
    private BigDecimal amount;
    private String couponId;    // æ–°å¢ï¼šä¼˜æƒ åˆ¸ID
    private String version = "v2"; // ç‰ˆæœ¬æ ‡è¯†
    // å…¶ä»–å­—æ®µ...
}
```

**ç‰ˆæœ¬å…¼å®¹çš„æ¶ˆè´¹è€…**
```java
@StreamListener("order-input")
public void handleOrderEvent(String jsonMessage, 
                           @Header Map<String, Object> headers) {
    
    String version = (String) headers.getOrDefault("version", "v1");
    
    try {
        switch (version) {
            case "v1":
                OrderEventV1 eventV1 = JSON.parseObject(jsonMessage, OrderEventV1.class);
                handleV1Event(eventV1);
                break;
            case "v2":
                OrderEventV2 eventV2 = JSON.parseObject(jsonMessage, OrderEventV2.class);
                handleV2Event(eventV2);
                break;
            default:
                System.err.println("ä¸æ”¯æŒçš„äº‹ä»¶ç‰ˆæœ¬ï¼š" + version);
        }
        
    } catch (Exception e) {
        System.err.println("å¤„ç†äº‹ä»¶å¼‚å¸¸ï¼š" + e.getMessage());
        throw e;
    }
}
```

### 5.4 ç›‘æ§å’Œè°ƒè¯•



**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡**

```java
@Component
public class EventMetrics {
    
    private final Counter eventPublished = Counter.builder("events.published")
        .description("å‘å¸ƒçš„äº‹ä»¶æ•°é‡")
        .register(Metrics.globalRegistry);
    
    private final Counter eventConsumed = Counter.builder("events.consumed")
        .description("æ¶ˆè´¹çš„äº‹ä»¶æ•°é‡")
        .register(Metrics.globalRegistry);
    
    private final Timer eventProcessingTime = Timer.builder("events.processing.time")
        .description("äº‹ä»¶å¤„ç†è€—æ—¶")
        .register(Metrics.globalRegistry);
    
    public void recordEventPublished(String eventType) {
        eventPublished.increment(Tags.of("type", eventType));
    }
    
    public void recordEventConsumed(String eventType, long processingTime) {
        eventConsumed.increment(Tags.of("type", eventType));
        eventProcessingTime.record(processingTime, TimeUnit.MILLISECONDS);
    }
}
```

**ğŸ” äº‹ä»¶è¿½è¸ª**
```java
// ä¸ºæ¯ä¸ªäº‹ä»¶æ·»åŠ è¿½è¸ªID
Message<OrderEvent> message = MessageBuilder
    .withPayload(event)
    .setHeader("traceId", MDC.get("traceId"))  // é“¾è·¯è¿½è¸ªID
    .setHeader("eventId", UUID.randomUUID())   // äº‹ä»¶å”¯ä¸€ID
    .build();
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ¯ æ¶ˆæ¯é©±åŠ¨æ¶æ„æœ¬è´¨ï¼š
â€¢ è§£è€¦ï¼šæœåŠ¡é—´é€šè¿‡æ¶ˆæ¯é€šä¿¡ï¼Œä¸ç›´æ¥è°ƒç”¨
â€¢ å¼‚æ­¥ï¼šå‘é€æ–¹ä¸ç­‰å¾…å¤„ç†å®Œæˆï¼Œæå‡å“åº”é€Ÿåº¦  
â€¢ å¯é ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¤±è´¥å¯é‡è¯•
â€¢ æ‰©å±•ï¼šæ–°å¢ä¸šåŠ¡é€»è¾‘ä¸å½±å“ç°æœ‰ä»£ç 

ğŸ› ï¸ Spring Cloud Stream æ ¸å¿ƒï¼š
â€¢ ç»Ÿä¸€ç¼–ç¨‹æ¨¡å‹ï¼šä¸€å¥—APIé€‚é…å¤šç§æ¶ˆæ¯ä¸­é—´ä»¶
â€¢ Binderï¼šé€‚é…å™¨ï¼Œè¿æ¥åº”ç”¨å’Œæ¶ˆæ¯ä¸­é—´ä»¶
â€¢ Channelï¼šæ¶ˆæ¯é€šé“ï¼Œåˆ†ä¸ºè¾“å…¥å’Œè¾“å‡º
â€¢ Bindingï¼šç»‘å®šé…ç½®ï¼ŒæŒ‡å®šé˜Ÿåˆ—/ä¸»é¢˜åç§°

ğŸ“Š æ¶ˆæ¯ä¸­é—´ä»¶é€‰æ‹©ï¼š
â€¢ RabbitMQï¼šåŠŸèƒ½ä¸°å¯Œï¼Œé€‚åˆä¸­å°é¡¹ç›®
â€¢ Kafkaï¼šé«˜ååé‡ï¼Œé€‚åˆå¤§æ•°æ®åœºæ™¯  
â€¢ RocketMQï¼šä¼ä¸šçº§ç‰¹æ€§ï¼Œé€‚åˆé‡‘èç­‰è¡Œä¸š

ğŸ”’ å¯é æ€§ä¿è¯ï¼š
â€¢ ç”Ÿäº§è€…ï¼šç¡®è®¤æœºåˆ¶ + é‡è¯•
â€¢ ä¸­é—´ä»¶ï¼šæŒä¹…åŒ– + é›†ç¾¤
â€¢ æ¶ˆè´¹è€…ï¼šæ‰‹åŠ¨ç¡®è®¤ + æ­»ä¿¡é˜Ÿåˆ—
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ’¡ è®°å¿†æŠ€å·§**
```
æ¶ˆæ¯é©±åŠ¨ = é¤å…ç‚¹é¤ç³»ç»Ÿ
â€¢ é¡¾å®¢ä¸‹å•ï¼ˆç”Ÿäº§è€…ï¼‰â†’ è®¢å•ç³»ç»Ÿï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰â†’ å¨æˆ¿ï¼ˆæ¶ˆè´¹è€…ï¼‰
â€¢ é¡¾å®¢ä¸ç”¨ç­‰èœåšå¥½æ‰èƒ½ä»˜é’±ï¼ˆå¼‚æ­¥ï¼‰
â€¢ å¤šä¸ªå¨å¸ˆå¯ä»¥åŒæ—¶åšä¸åŒçš„èœï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
â€¢ è®¢å•å†™åœ¨çº¸ä¸Šä¸ä¼šä¸¢ï¼ˆæŒä¹…åŒ–ï¼‰
â€¢ åšåäº†çš„èœæœ‰ä¸“é—¨å¤„ç†æµç¨‹ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰
```

**ğŸ”‘ è®¾è®¡åŸåˆ™**
```
äº‹ä»¶è®¾è®¡ä¸‰åŸåˆ™ï¼š
1. äº‹ä»¶ = å·²å‘ç”Ÿçš„äº‹å®ï¼ˆç”¨è¿‡å»æ—¶æ€å‘½åï¼‰
2. äº‹ä»¶ = ä¸šåŠ¡è¯­è¨€ï¼ˆä¸æ˜¯æŠ€æœ¯æœ¯è¯­ï¼‰
3. äº‹ä»¶ = å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«å¤„ç†éœ€è¦çš„æ‰€æœ‰æ•°æ®ï¼‰

ä¾‹å¦‚ï¼š
âœ… OrderCreatedï¼ˆè®¢å•å·²åˆ›å»ºï¼‰
âœ… UserRegisteredï¼ˆç”¨æˆ·å·²æ³¨å†Œï¼‰  
âœ… PaymentCompletedï¼ˆæ”¯ä»˜å·²å®Œæˆï¼‰

âŒ DataChangedï¼ˆæ•°æ®å˜äº† - å¤ªæ¨¡ç³Šï¼‰
âŒ DatabaseUpdatedï¼ˆæ•°æ®åº“æ›´æ–°äº† - æŠ€æœ¯æœ¯è¯­ï¼‰
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ¢ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•â†’åº“å­˜â†’æ”¯ä»˜â†’ç‰©æµçš„è§£è€¦å¤„ç†
- **ç”¨æˆ·ç³»ç»Ÿ**ï¼šæ³¨å†Œâ†’é‚®ä»¶â†’ç§¯åˆ†â†’æ¨èçš„å¼‚æ­¥å¤„ç†  
- **å†…å®¹å¹³å°**ï¼šå‘å¸ƒâ†’å®¡æ ¸â†’æ¨é€â†’ç»Ÿè®¡çš„æµæ°´çº¿å¤„ç†
- **é‡‘èç³»ç»Ÿ**ï¼šäº¤æ˜“â†’é£æ§â†’æ¸…ç®—â†’é€šçŸ¥çš„å¯é å¤„ç†

**ğŸ“ èƒ½åŠ›ç­‰çº§**
```
å…¥é—¨çº§ï¼š
âœ… ç†è§£æ¶ˆæ¯é©±åŠ¨çš„åŸºæœ¬æ¦‚å¿µ
âœ… èƒ½ä½¿ç”¨ Spring Cloud Stream å‘é€/æ¥æ”¶æ¶ˆæ¯
âœ… ä¼šé…ç½® RabbitMQ æˆ– Kafka

è¿›é˜¶çº§ï¼š  
âœ… æŒæ¡æ¶ˆæ¯å¯é æ€§ä¿è¯æœºåˆ¶
âœ… ä¼šè®¾è®¡åˆç†çš„äº‹ä»¶ç»“æ„
âœ… èƒ½å¤„ç†å¤æ‚çš„ä¸šåŠ¡åœºæ™¯

é«˜çº§çº§ï¼š
âœ… èƒ½è®¾è®¡å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„
âœ… ä¼šå¤„ç†æ¶ˆæ¯é¡ºåºã€å¹‚ç­‰ã€ç‰ˆæœ¬å…¼å®¹ç­‰é—®é¢˜
âœ… èƒ½ç›‘æ§å’Œè°ƒä¼˜æ¶ˆæ¯ç³»ç»Ÿæ€§èƒ½
```

**ğŸ“ˆ å­¦ä¹ è·¯å¾„å»ºè®®**
1. **åŸºç¡€é˜¶æ®µ**ï¼šç†è§£æ¦‚å¿µï¼Œè·‘é€šç¤ºä¾‹ä»£ç 
2. **å®è·µé˜¶æ®µ**ï¼šåœ¨é¡¹ç›®ä¸­åº”ç”¨ï¼Œå¤„ç†å®é™…é—®é¢˜  
3. **ä¼˜åŒ–é˜¶æ®µ**ï¼šå…³æ³¨æ€§èƒ½ã€ç›‘æ§ã€è¿ç»´
4. **æ¶æ„é˜¶æ®µ**ï¼šè®¾è®¡å¤æ‚çš„äº‹ä»¶é©±åŠ¨ç³»ç»Ÿ

### 6.4 å¸¸è§é—®é¢˜ä¸è§£å†³



**â“ æ–°æ‰‹å¸¸è§é—®é¢˜**

**Q1ï¼šæ¶ˆæ¯é‡å¤æ¶ˆè´¹æ€ä¹ˆåŠï¼Ÿ**
```
Aï¼šè®¾è®¡å¹‚ç­‰çš„æ¶ˆè´¹é€»è¾‘
â€¢ ç”¨å”¯ä¸€IDåˆ¤æ–­æ˜¯å¦å·²å¤„ç†
â€¢ ä½¿ç”¨æ•°æ®åº“å”¯ä¸€ç´¢å¼•
â€¢ è®°å½•å¤„ç†çŠ¶æ€é¿å…é‡å¤
```

**Q2ï¼šæ¶ˆæ¯é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ**
```
Aï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ–¹æ¡ˆ
â€¢ å•åˆ†åŒºï¼šä¿è¯å…¨å±€é¡ºåºï¼Œä½†æ€§èƒ½å·®
â€¢ æŒ‰keyåˆ†åŒºï¼šä¿è¯ç›¸åŒkeyçš„æ¶ˆæ¯æœ‰åº
â€¢ ä¸šåŠ¡å±‚å¤„ç†ï¼šè®¾è®¡ç‰ˆæœ¬å·æˆ–çŠ¶æ€æœº
```

**Q3ï¼šæ¶ˆæ¯å †ç§¯æ€ä¹ˆå¤„ç†ï¼Ÿ**
```
Aï¼šä»å¤šä¸ªè§’åº¦è§£å†³
â€¢ å¢åŠ æ¶ˆè´¹è€…å®ä¾‹ï¼ˆæ°´å¹³æ‰©å±•ï¼‰
â€¢ ä¼˜åŒ–æ¶ˆè´¹é€»è¾‘ï¼ˆæå‡å¤„ç†é€Ÿåº¦ï¼‰  
â€¢ æ‰¹é‡å¤„ç†æ¶ˆæ¯ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰
â€¢ ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ”§ æœ€ä½³å®è·µæ€»ç»“**
- äº‹ä»¶è®¾è®¡è¦ç¨³å®šï¼Œé¿å…é¢‘ç¹ä¿®æ”¹
- ç›‘æ§æ¶ˆæ¯ç§¯å‹ã€å¤„ç†è€—æ—¶ç­‰å…³é”®æŒ‡æ ‡
- æµ‹è¯•è¦è¦†ç›–å¼‚å¸¸åœºæ™¯ï¼ˆç½‘ç»œå¼‚å¸¸ã€å¤„ç†å¤±è´¥ç­‰ï¼‰
- ç”Ÿäº§ç¯å¢ƒè¦é…ç½®æ­»ä¿¡é˜Ÿåˆ—å’Œå‘Šè­¦æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
æ¶ˆæ¯é©±åŠ¨æ¶æ„è®©å¾®æœåŠ¡åƒä¹é˜Ÿä¸€æ ·åä½œ - æŒ‡æŒ¥å®¶ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰åè°ƒå„ä¸ªä¹æ‰‹ï¼ˆå¾®æœåŠ¡ï¼‰ï¼Œæ¯ä¸ªäººä¸“æ³¨æ¼”å¥è‡ªå·±çš„éƒ¨åˆ†ï¼Œé€šè¿‡éŸ³ä¹ï¼ˆæ¶ˆæ¯ï¼‰è¿›è¡Œæ²Ÿé€šï¼Œæœ€ç»ˆå¥å‡ºç¾å¦™çš„äº¤å“ä¹ï¼ˆå®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼‰ã€‚