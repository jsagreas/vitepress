---
title: 2ã€æœåŠ¡è°ƒç”¨ä¸è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡é—´è°ƒç”¨çš„æœ¬è´¨](#1-å¾®æœåŠ¡é—´è°ƒç”¨çš„æœ¬è´¨)
2. [RestTemplate åŸºç¡€è°ƒç”¨](#2-RestTemplate-åŸºç¡€è°ƒç”¨)
3. [OpenFeign å£°æ˜å¼è°ƒç”¨](#3-OpenFeign-å£°æ˜å¼è°ƒç”¨)
4. [WebClient å“åº”å¼è°ƒç”¨](#4-WebClient-å“åº”å¼è°ƒç”¨)
5. [è´Ÿè½½å‡è¡¡æ·±åº¦è§£æ](#5-è´Ÿè½½å‡è¡¡æ·±åº¦è§£æ)
6. [è°ƒç”¨ä¼˜åŒ–ä¸ç›‘æ§](#6-è°ƒç”¨ä¼˜åŒ–ä¸ç›‘æ§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¾®æœåŠ¡é—´è°ƒç”¨çš„æœ¬è´¨


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡è°ƒç”¨


**é€šä¿—ç†è§£**ï¼šå°±åƒ**æ‰“ç”µè¯**ä¸€æ ·ï¼Œä¸€ä¸ªæœåŠ¡éœ€è¦å¦ä¸€ä¸ªæœåŠ¡çš„æ•°æ®æˆ–åŠŸèƒ½æ—¶ï¼Œå°±è¦"æ‰“ç”µè¯"ç»™å®ƒ

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
è®¢é¤APP â†’ è°ƒç”¨æ”¯ä»˜æœåŠ¡ â†’ è°ƒç”¨åº“å­˜æœåŠ¡
   |           |            |
 ä¸‹å•è¯·æ±‚    æ‰£æ¬¾æ“ä½œ    å‡å°‘åº“å­˜

å°±åƒï¼šé¡¾å®¢ â†’ æ”¶é“¶å‘˜ â†’ ä»“åº“ç®¡ç†å‘˜
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **æœåŠ¡æä¾›è€…**ï¼šè¢«è°ƒç”¨çš„æœåŠ¡ï¼ˆåƒå•†åº—ï¼‰
- **æœåŠ¡æ¶ˆè´¹è€…**ï¼šå‘èµ·è°ƒç”¨çš„æœåŠ¡ï¼ˆåƒé¡¾å®¢ï¼‰
- **æœåŠ¡è°ƒç”¨**ï¼šä¸¤ä¸ªæœåŠ¡ä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡è°ƒç”¨


**ä¼ ç»Ÿå•ä½“åº”ç”¨**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       å•ä½“åº”ç”¨           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ç”¨æˆ· â”‚è®¢å• â”‚æ”¯ä»˜ â”‚    â”‚
â”‚  â”‚ç®¡ç† â”‚å¤„ç† â”‚å¤„ç† â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ‰€æœ‰åŠŸèƒ½åœ¨ä¸€ä¸ªåº”ç”¨é‡Œï¼Œç›´æ¥è°ƒç”¨æ–¹æ³•
```

**å¾®æœåŠ¡æ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTPè¯·æ±‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTPè¯·æ±‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ è®¢å•æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ æ”¯ä»˜æœåŠ¡ â”‚
â”‚  8001   â”‚               â”‚  8002   â”‚               â”‚  8003   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¯ä¸ªæœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œé€šä¿¡
```

**ä¸ºä»€ä¹ˆè¦æ‹†åˆ†**ï¼š
- ğŸ”§ **ç‹¬ç«‹å¼€å‘**ï¼šä¸åŒå›¢é˜Ÿè´Ÿè´£ä¸åŒæœåŠ¡
- ğŸš€ **ç‹¬ç«‹éƒ¨ç½²**ï¼šä¸€ä¸ªæœåŠ¡æ›´æ–°ä¸å½±å“å…¶ä»–æœåŠ¡
- ğŸ“ˆ **ç‹¬ç«‹æ‰©å±•**ï¼šçƒ­é—¨æœåŠ¡å¯ä»¥å¤šéƒ¨ç½²å‡ ä¸ªå®ä¾‹

### 1.3 æœåŠ¡è°ƒç”¨çš„æŒ‘æˆ˜


**é¢ä¸´çš„é—®é¢˜**ï¼š
```
ğŸ¤” æœåŠ¡åœ¨å“ªé‡Œï¼Ÿ   â†’ éœ€è¦æœåŠ¡å‘ç°
ğŸ¤” è°ƒå“ªä¸ªå®ä¾‹ï¼Ÿ   â†’ éœ€è¦è´Ÿè½½å‡è¡¡  
ğŸ¤” è°ƒç”¨å¤±è´¥äº†ï¼Ÿ   â†’ éœ€è¦é‡è¯•æœºåˆ¶
ğŸ¤” å“åº”å¤ªæ…¢äº†ï¼Ÿ   â†’ éœ€è¦è¶…æ—¶æ§åˆ¶
ğŸ¤” æœåŠ¡æŒ‚äº†ï¼Ÿ     â†’ éœ€è¦å®¹é”™å¤„ç†
```

---

## 2. ğŸ”§ RestTemplate åŸºç¡€è°ƒç”¨


### 2.1 RestTemplate æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šRestTemplate å°±åƒä¸€ä¸ª**ç½‘ç»œè¯·æ±‚å·¥å…·**ï¼Œå¸®ä½ å‘é€ HTTP è¯·æ±‚åˆ°å…¶ä»–æœåŠ¡

**ç±»æ¯”ç†è§£**ï¼š
```
RestTemplate = å¿«é€’å‘˜
ä½ ï¼šæˆ‘è¦ç»™åŒ—äº¬çš„æœ‹å‹å¯„ä¸ªåŒ…è£¹
RestTemplateï¼šå¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ å‘é€ï¼Œå¹¶æŠŠå›å¤å¸¦å›æ¥
```

### 2.2 åŸºç¡€ç”¨æ³•


**ğŸ“¦ æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

**ğŸ”§ é…ç½® RestTemplate**ï¼š
```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### 2.3 å®é™…è°ƒç”¨ç¤ºä¾‹


**åœºæ™¯**ï¼šè®¢å•æœåŠ¡è¦è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯

```java
@RestController
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @GetMapping("/order/{orderId}")
    public OrderInfo getOrderInfo(@PathVariable String orderId) {
        
        // 1. è·å–è®¢å•åŸºæœ¬ä¿¡æ¯ï¼ˆæœ¬åœ°æ•°æ®åº“ï¼‰
        Order order = orderService.getOrder(orderId);
        
        // 2. è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
        String userServiceUrl = "http://user-service/user/" + order.getUserId();
        UserInfo userInfo = restTemplate.getForObject(userServiceUrl, UserInfo.class);
        
        // 3. ç»„åˆè¿”å›ç»“æœ
        OrderInfo orderInfo = new OrderInfo();
        orderInfo.setOrder(order);
        orderInfo.setUserInfo(userInfo);
        
        return orderInfo;
    }
}
```

### 2.4 å¸¸ç”¨è¯·æ±‚æ–¹æ³•


**GET è¯·æ±‚** - è·å–æ•°æ®ï¼š
```java
// æ–¹å¼1ï¼šç›´æ¥è·å–å¯¹è±¡
UserInfo user = restTemplate.getForObject(
    "http://user-service/user/123", 
    UserInfo.class
);

// æ–¹å¼2ï¼šè·å–å®Œæ•´å“åº”
ResponseEntity<UserInfo> response = restTemplate.getForEntity(
    "http://user-service/user/123", 
    UserInfo.class
);
UserInfo user = response.getBody();
int statusCode = response.getStatusCodeValue();
```

**POST è¯·æ±‚** - æäº¤æ•°æ®ï¼š
```java
// åˆ›å»ºæ–°ç”¨æˆ·
UserInfo newUser = new UserInfo();
newUser.setName("å¼ ä¸‰");
newUser.setAge(25);

UserInfo result = restTemplate.postForObject(
    "http://user-service/user", 
    newUser,           // è¯·æ±‚ä½“
    UserInfo.class     // è¿”å›ç±»å‹
);
```

### 2.5 RestTemplate çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹**ï¼š
- ä½¿ç”¨ç®€å•ï¼ŒSpring åŸç”Ÿæ”¯æŒ
- åŠŸèƒ½å®Œæ•´ï¼Œæ”¯æŒå„ç§ HTTP è¯·æ±‚
- é…ç½®çµæ´»ï¼Œå¯ä»¥è‡ªå®šä¹‰å„ç§å‚æ•°

**âŒ ç¼ºç‚¹**ï¼š
- ä»£ç æ¯”è¾ƒç¹çï¼Œéœ€è¦æ‰‹å†™ URL
- æ²¡æœ‰æ¥å£å®šä¹‰ï¼Œå®¹æ˜“å†™é”™
- è´Ÿè½½å‡è¡¡éœ€è¦é¢å¤–é…ç½®

---

## 3. ğŸ¯ OpenFeign å£°æ˜å¼è°ƒç”¨


### 3.1 OpenFeign æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šOpenFeign è®©å¾®æœåŠ¡è°ƒç”¨**åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•**

**ç±»æ¯”ç†è§£**ï¼š
```
RestTemplate æ–¹å¼ï¼š
ä½ ï¼šå¿«é€’å‘˜ï¼Œå¸®æˆ‘æŠŠè¿™ä¸ªåŒ…è£¹å¯„åˆ°"åŒ—äº¬å¸‚æœé˜³åŒºXXè·¯XXå·å¼ ä¸‰æ”¶"
ï¼ˆéœ€è¦å†™è¯¦ç»†åœ°å€å’Œæ”¶ä»¶äººï¼‰

OpenFeign æ–¹å¼ï¼š  
ä½ ï¼šå¿«é€’å‘˜ï¼Œå¸®æˆ‘å¯„ç»™"å¼ ä¸‰"
ï¼ˆåªéœ€è¦è¯´ä¸ªåå­—ï¼Œåœ°å€æœ¬å·²ç»æœ‰äº†ï¼‰
```

### 3.2 åŸºç¡€é…ç½®


**ğŸ“¦ æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**ğŸ”§ å¯ç”¨ Feign**ï¼š
```java
@SpringBootApplication
@EnableFeignClients  // å¼€å¯ Feign åŠŸèƒ½
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

### 3.3 åˆ›å»º Feign æ¥å£


**å®šä¹‰è°ƒç”¨æ¥å£**ï¼š
```java
@FeignClient(name = "user-service")  // æŒ‡å®šè¦è°ƒç”¨çš„æœåŠ¡å
public interface UserServiceFeign {
    
    // å®šä¹‰è°ƒç”¨æ–¹æ³•ï¼Œå°±åƒå®šä¹‰æœ¬åœ°æ¥å£ä¸€æ ·
    @GetMapping("/user/{userId}")
    UserInfo getUserById(@PathVariable("userId") Long userId);
    
    @PostMapping("/user")
    UserInfo createUser(@RequestBody UserInfo user);
    
    @GetMapping("/user/list")
    List<UserInfo> getUserList(@RequestParam("page") int page);
}
```

### 3.4 ä½¿ç”¨ Feign æ¥å£


**åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨**ï¼š
```java
@RestController
public class OrderController {
    
    @Autowired
    private UserServiceFeign userServiceFeign;  // æ³¨å…¥ Feign æ¥å£
    
    @GetMapping("/order/{orderId}")
    public OrderInfo getOrderInfo(@PathVariable String orderId) {
        
        // è·å–è®¢å•ä¿¡æ¯
        Order order = orderService.getOrder(orderId);
        
        // è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼ˆå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ï¼‰
        UserInfo userInfo = userServiceFeign.getUserById(order.getUserId());
        
        // ç»„åˆç»“æœ
        return new OrderInfo(order, userInfo);
    }
}
```

### 3.5 OpenFeign çš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ¯ å£°æ˜å¼è°ƒç”¨**ï¼š
```java
// RestTemplate æ–¹å¼ï¼ˆå‘½ä»¤å¼ï¼‰
String url = "http://user-service/user/" + userId;
UserInfo user = restTemplate.getForObject(url, UserInfo.class);

// OpenFeign æ–¹å¼ï¼ˆå£°æ˜å¼ï¼‰  
UserInfo user = userServiceFeign.getUserById(userId);
```

**ğŸ“ å¯¹æ¯”åˆ†æ**ï¼š

| ç‰¹æ€§ | RestTemplate | OpenFeign |
|------|-------------|-----------|
| **æ˜“ç”¨æ€§** | éœ€è¦æ‰‹å†™URLå’Œå‚æ•° | åƒè°ƒç”¨æœ¬åœ°æ–¹æ³• |
| **ç±»å‹å®‰å…¨** | è¿è¡Œæ—¶æ‰çŸ¥é“é”™è¯¯ | ç¼–è¯‘æ—¶æ£€æŸ¥ |
| **ä»£ç é‡** | è¾ƒå¤š | æå°‘ |
| **ç»´æŠ¤æ€§** | URLå˜æ›´éœ€è¦æ”¹ä»£ç  | åªéœ€è¦æ”¹æ¥å£å®šä¹‰ |

### 3.6 OpenFeign é«˜çº§é…ç½®


**è¶…æ—¶é…ç½®**ï¼š
```yaml
feign:
  client:
    config:
      default:  # å…¨å±€é…ç½®
        connectTimeout: 5000    # è¿æ¥è¶…æ—¶ 5ç§’
        readTimeout: 10000      # è¯»å–è¶…æ—¶ 10ç§’
      user-service:  # ç‰¹å®šæœåŠ¡é…ç½®
        connectTimeout: 3000
        readTimeout: 8000
```

**é‡è¯•é…ç½®**ï¼š
```java
@Configuration
public class FeignConfig {
    
    @Bean
    public Retryer retryer() {
        return new Retryer.Default(
            100,   // é‡è¯•é—´éš” 100ms
            1000,  // æœ€å¤§é‡è¯•é—´éš” 1s  
            3      // æœ€å¤§é‡è¯•æ¬¡æ•° 3æ¬¡
        );
    }
}
```

---

## 4. âš¡ WebClient å“åº”å¼è°ƒç”¨


### 4.1 WebClient æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šWebClient æ˜¯**æ–°ä¸€ä»£**çš„HTTPè°ƒç”¨å·¥å…·ï¼Œæ”¯æŒ**å¼‚æ­¥éé˜»å¡**è°ƒç”¨

**ç±»æ¯”ç†è§£**ï¼š
```
RestTemplate = ä¼ ç»Ÿå¿«é€’
ä½ å¯„åŒ…è£¹åï¼Œå¿…é¡»ç­‰å¿«é€’å‘˜å›æ¥æ‰èƒ½å¯„ä¸‹ä¸€ä¸ªï¼ˆåŒæ­¥é˜»å¡ï¼‰

WebClient = ç°ä»£å¿«é€’  
ä½ å¯ä»¥åŒæ—¶å¯„å¤šä¸ªåŒ…è£¹ï¼Œä¸ç”¨ç­‰ä¸€ä¸ªå›æ¥å†å¯„ä¸‹ä¸€ä¸ªï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰
```

### 4.2 åŒæ­¥ vs å¼‚æ­¥çš„åŒºåˆ«


**åŒæ­¥è°ƒç”¨**ï¼š
```java
// å¿…é¡»ç­‰ç”¨æˆ·æœåŠ¡è¿”å›ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ
UserInfo user = restTemplate.getForObject(url, UserInfo.class);
System.out.println("ç”¨æˆ·ä¿¡æ¯ï¼š" + user.getName());
// è¿™è¡Œä»£ç è¦ç­‰ä¸Šé¢æ‰§è¡Œå®Œæ‰èƒ½è¿è¡Œ
```

**å¼‚æ­¥è°ƒç”¨**ï¼š
```java
// å‘èµ·è¯·æ±‚åç«‹å³ç»§ç»­ï¼Œä¸ç­‰å¾…ç»“æœ
webClient.get().uri("/user/123")
    .retrieve()
    .bodyToMono(UserInfo.class)
    .subscribe(user -> {
        // è¿™é‡Œæ˜¯ç»“æœå›æ¥åæ‰æ‰§è¡Œ
        System.out.println("ç”¨æˆ·ä¿¡æ¯ï¼š" + user.getName());
    });
// è¿™è¡Œä»£ç ä¼šç«‹å³æ‰§è¡Œï¼Œä¸ç­‰ä¸Šé¢çš„ç»“æœ
System.out.println("è¯·æ±‚å·²å‘å‡ºï¼Œç»§ç»­å…¶ä»–å·¥ä½œ...");
```

### 4.3 WebClient åŸºç¡€ç”¨æ³•


**ğŸ“¦ æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

**ğŸ”§ é…ç½® WebClient**ï¼š
```java
@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient webClient() {
        return WebClient.builder()
            .baseUrl("http://user-service")  // åŸºç¡€URL
            .defaultHeader("Content-Type", "application/json")
            .build();
    }
}
```

### 4.4 å®é™…ä½¿ç”¨ç¤ºä¾‹


**GET è¯·æ±‚**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private WebClient webClient;
    
    // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯
    public Mono<UserInfo> getUserAsync(Long userId) {
        return webClient.get()
            .uri("/user/{id}", userId)  // è·¯å¾„å‚æ•°
            .retrieve()  // å‘é€è¯·æ±‚
            .bodyToMono(UserInfo.class);  // è½¬æ¢ä¸ºå¯¹è±¡
    }
    
    // å¦‚æœéœ€è¦åŒæ­¥ç»“æœï¼ˆä¸æ¨èï¼‰
    public UserInfo getUserSync(Long userId) {
        return webClient.get()
            .uri("/user/{id}", userId)
            .retrieve()
            .bodyToMono(UserInfo.class)
            .block();  // é˜»å¡ç­‰å¾…ç»“æœ
    }
}
```

**POST è¯·æ±‚**ï¼š
```java
public Mono<UserInfo> createUser(UserInfo user) {
    return webClient.post()
        .uri("/user")
        .bodyValue(user)  // è¯·æ±‚ä½“
        .retrieve()
        .bodyToMono(UserInfo.class);
}
```

### 4.5 WebClient çš„åº”ç”¨åœºæ™¯


**âœ… é€‚åˆä½¿ç”¨ WebClient çš„åœºæ™¯**ï¼š
- é«˜å¹¶å‘åœºæ™¯ï¼Œéœ€è¦åŒæ—¶è°ƒç”¨å¤šä¸ªæœåŠ¡
- ä¸éœ€è¦ç«‹å³è·å–ç»“æœçš„åœºæ™¯
- ä¸å“åº”å¼æ¡†æ¶ï¼ˆå¦‚ Spring WebFluxï¼‰é…åˆä½¿ç”¨

**âŒ ä¸é€‚åˆçš„åœºæ™¯**ï¼š
- ç®€å•çš„åŒæ­¥è°ƒç”¨
- å›¢é˜Ÿå¯¹å“åº”å¼ç¼–ç¨‹ä¸ç†Ÿæ‚‰
- è°ƒç”¨ç»“æœéœ€è¦ç«‹å³ä½¿ç”¨

---

## 5. âš–ï¸ è´Ÿè½½å‡è¡¡æ·±åº¦è§£æ


### 5.1 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡


**é€šä¿—ç†è§£**ï¼šè´Ÿè½½å‡è¡¡å°±åƒ**äº¤é€šæŒ‡æŒ¥å‘˜**ï¼Œåˆç†åˆ†é…æµé‡åˆ°ä¸åŒçš„æœåŠ¡å®ä¾‹

**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
é“¶è¡Œæ’é˜Ÿåœºæ™¯ï¼š
                    å®¢æˆ·
                     â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ å«å·æœº  â”‚ â† è´Ÿè½½å‡è¡¡å™¨
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“    â†“    â†“
              çª—å£1  çª—å£2  çª—å£3 â† æœåŠ¡å®ä¾‹
```

**ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡**ï¼š
```
å•å®ä¾‹é—®é¢˜ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç”¨æˆ·æœåŠ¡(å•ä¸ª) â†’ ğŸ’¥ å‹åŠ›å¤ªå¤§ï¼Œå¯èƒ½å´©æºƒ

è´Ÿè½½å‡è¡¡è§£å†³æ–¹æ¡ˆï¼š
                    ç”¨æˆ·æœåŠ¡å®ä¾‹1 (å¤„ç†33%è¯·æ±‚)
                   â†—
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ ç”¨æˆ·æœåŠ¡å®ä¾‹2 (å¤„ç†33%è¯·æ±‚)  
                   â†˜
                    ç”¨æˆ·æœåŠ¡å®ä¾‹3 (å¤„ç†34%è¯·æ±‚)
```

### 5.2 Ribbon è´Ÿè½½å‡è¡¡


**ğŸ”§ Ribbon é…ç½®**ï¼š
```java
@Configuration
public class RibbonConfig {
    
    @Bean
    @LoadBalanced  // å¼€å¯è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@RestController
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @GetMapping("/test-balance")
    public String testLoadBalance() {
        // æ³¨æ„ï¼šè¿™é‡Œç”¨çš„æ˜¯æœåŠ¡åï¼Œä¸æ˜¯å…·ä½“IP
        return restTemplate.getForObject(
            "http://user-service/user/info", 
            String.class
        );
    }
}
```

### 5.3 Spring Cloud LoadBalancer


**æ–°ä¸€ä»£è´Ÿè½½å‡è¡¡å™¨**ï¼š
```yaml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false  # ç¦ç”¨ Ribbon
```

**é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
@LoadBalancerClient(name = "user-service", configuration = LoadBalancerConfig.class)
public class LoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        return new RandomLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name
        );
    }
}
```

### 5.4 è´Ÿè½½å‡è¡¡ç­–ç•¥è¯¦è§£


**ğŸ¯ å¸¸ç”¨ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|------|------|---------|--------|
| **è½®è¯¢ (Round Robin)** | ä¾æ¬¡è°ƒç”¨å„ä¸ªå®ä¾‹ | æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ | âœ…ç®€å•å…¬å¹³ âŒä¸è€ƒè™‘è´Ÿè½½ |
| **éšæœº (Random)** | éšæœºé€‰æ‹©å®ä¾‹ | å¤§é‡è¯·æ±‚åœºæ™¯ | âœ…åˆ†å¸ƒå‡åŒ€ âŒå¯èƒ½ä¸å‡è¡¡ |
| **æœ€å°‘æ´»è·ƒ (Least Active)** | é€‰æ‹©æ­£åœ¨å¤„ç†è¯·æ±‚æœ€å°‘çš„ | æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§ | âœ…è€ƒè™‘å®æ—¶è´Ÿè½½ âŒå®ç°å¤æ‚ |
| **åŠ æƒè½®è¯¢ (Weighted)** | æ ¹æ®æƒé‡åˆ†é…è¯·æ±‚ | æœåŠ¡å™¨é…ç½®ä¸åŒ | âœ…è€ƒè™‘æ€§èƒ½å·®å¼‚ âŒéœ€è¦é…ç½®æƒé‡ |

**è½®è¯¢ç­–ç•¥ç¤ºæ„**ï¼š
```
è¯·æ±‚åºå·ï¼š  1  2  3  4  5  6  7  8  9
æœåŠ¡å®ä¾‹ï¼š  A  B  C  A  B  C  A  B  C
          â†‘     â†‘     â†‘     â†‘
         å‡åŒ€åˆ†é…åˆ°ä¸‰ä¸ªå®ä¾‹
```

**åŠ æƒè½®è¯¢ç¤ºæ„**ï¼š
```
å®ä¾‹æƒé‡ï¼šA(æƒé‡3) B(æƒé‡2) C(æƒé‡1)  
åˆ†é…æ¯”ä¾‹ï¼šAå¤„ç†50% Bå¤„ç†33% Cå¤„ç†17%

è¯·æ±‚åºå·ï¼š1 2 3 4 5 6 7 8 9 10 11 12
æœåŠ¡å®ä¾‹ï¼šA A B A B C A A B A  B  C
```

### 5.5 è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥


```java
@Component
public class CustomLoadBalancer {
    
    private final Random random = new Random();
    
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // è‡ªå®šä¹‰é€»è¾‘ï¼šä¼˜å…ˆé€‰æ‹©æœ¬åœ°æœºæˆ¿çš„æœåŠ¡
        List<ServiceInstance> localInstances = instances.stream()
            .filter(instance -> "local".equals(instance.getMetadata().get("zone")))
            .collect(Collectors.toList());
            
        if (!localInstances.isEmpty()) {
            return localInstances.get(random.nextInt(localInstances.size()));
        }
        
        // æ²¡æœ‰æœ¬åœ°å®ä¾‹æ—¶ï¼Œéšæœºé€‰æ‹©
        return instances.get(random.nextInt(instances.size()));
    }
}
```

---

## 6. ğŸ” è°ƒç”¨ä¼˜åŒ–ä¸ç›‘æ§


### 6.1 é‡è¯•æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•**ï¼š
```
ç½‘ç»œæ˜¯ä¸å¯é çš„ï¼š
è¯·æ±‚ â†’ ç½‘ç»œæŠ–åŠ¨ â†’ è°ƒç”¨å¤±è´¥ â†’ ç”¨æˆ·çœ‹åˆ°é”™è¯¯

åŠ ä¸Šé‡è¯•åï¼š
è¯·æ±‚ â†’ ç¬¬1æ¬¡å¤±è´¥ â†’ è‡ªåŠ¨é‡è¯• â†’ ç¬¬2æ¬¡æˆåŠŸ â†’ ç”¨æˆ·æ­£å¸¸ä½¿ç”¨
```

**é‡è¯•é…ç½®**ï¼š
```yaml
feign:
  client:
    config:
      default:
        retryer:
          period: 100        # é‡è¯•é—´éš” 100ms
          maxPeriod: 1000    # æœ€å¤§é‡è¯•é—´éš” 1s
          maxAttempts: 3     # æœ€å¤§é‡è¯•æ¬¡æ•°
```

**é‡è¯•ç­–ç•¥**ï¼š
```java
@Configuration
public class RetryConfig {
    
    @Bean
    public Retryer customRetryer() {
        return new Retryer.Default(
            100,    // åˆå§‹é—´éš”
            1000,   // æœ€å¤§é—´éš”  
            3       // æœ€å¤§æ¬¡æ•°
        ) {
            @Override
            public void continueOrPropagate(RetryableException e) {
                // åªå¯¹ç‰¹å®šå¼‚å¸¸é‡è¯•
                if (e.status() == 503 || e.status() == 502) {
                    super.continueOrPropagate(e);
                } else {
                    throw e;  // ä¸é‡è¯•ï¼Œç›´æ¥æŠ›å¼‚å¸¸
                }
            }
        };
    }
}
```

### 6.2 è¶…æ—¶é…ç½®


**è¶…æ—¶æ—¶é—´è®¾ç½®åŸåˆ™**ï¼š
```
ğŸ• è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æœ€é•¿æ—¶é—´ï¼ˆé€šå¸¸ 2-5 ç§’ï¼‰
ğŸ•‘ è¯»å–è¶…æ—¶ï¼šç­‰å¾…å“åº”çš„æœ€é•¿æ—¶é—´ï¼ˆæ ¹æ®ä¸šåŠ¡è€Œå®šï¼‰

ç»éªŒå€¼å‚è€ƒï¼š
- æŸ¥è¯¢æ¥å£ï¼š3-5ç§’
- è®¡ç®—å¯†é›†ï¼š10-30ç§’  
- æ–‡ä»¶ä¸Šä¼ ï¼š60ç§’+
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
feign:
  client:
    config:
      user-service:
        connectTimeout: 2000    # è¿æ¥è¶…æ—¶ 2ç§’
        readTimeout: 5000       # è¯»å–è¶…æ—¶ 5ç§’
      file-service:
        connectTimeout: 5000    
        readTimeout: 30000      # æ–‡ä»¶æ“ä½œéœ€è¦æ›´é•¿æ—¶é—´
```

### 6.3 è°ƒç”¨ç›‘æ§


**ç›‘æ§æŒ‡æ ‡**ï¼š
```
ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡ï¼š
- æˆåŠŸç‡ï¼šæˆåŠŸè°ƒç”¨ / æ€»è°ƒç”¨
- å“åº”æ—¶é—´ï¼šå¹³å‡ã€P95ã€P99
- QPSï¼šæ¯ç§’æŸ¥è¯¢æ•°
- é”™è¯¯ç‡ï¼šå¤±è´¥è°ƒç”¨ / æ€»è°ƒç”¨

ğŸ“ˆ ç›‘æ§ç»´åº¦ï¼š
- æŒ‰æœåŠ¡ï¼šå“ªä¸ªæœåŠ¡è°ƒç”¨é‡å¤§
- æŒ‰æ¥å£ï¼šå“ªä¸ªæ¥å£æœ€æ…¢
- æŒ‰æ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™æœ€ç¹å¿™
```

**ç®€å•ç›‘æ§å®ç°**ï¼š
```java
@Component
public class CallMonitor {
    
    private final Counter successCalls = Counter.build()
        .name("service_calls_success_total")
        .help("æˆåŠŸè°ƒç”¨æ¬¡æ•°")
        .labelNames("service", "method")
        .register();
        
    private final Counter failedCalls = Counter.build()
        .name("service_calls_failed_total") 
        .help("å¤±è´¥è°ƒç”¨æ¬¡æ•°")
        .labelNames("service", "method")
        .register();
        
    private final Histogram responseTime = Histogram.build()
        .name("service_calls_duration_seconds")
        .help("è°ƒç”¨å“åº”æ—¶é—´")
        .labelNames("service", "method")
        .register();
    
    public void recordSuccess(String service, String method, double duration) {
        successCalls.labels(service, method).inc();
        responseTime.labels(service, method).observe(duration);
    }
    
    public void recordFailure(String service, String method) {
        failedCalls.labels(service, method).inc();
    }
}
```

### 6.4 è°ƒç”¨é“¾è·¯è¿½è¸ª


**ä¸ºä»€ä¹ˆéœ€è¦é“¾è·¯è¿½è¸ª**ï¼š
```
å¤æ‚è°ƒç”¨é“¾ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ â†’ è®¢å•æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡ â†’ ç§¯åˆ†æœåŠ¡
                  â†“
                æ”¯ä»˜æœåŠ¡ â†’ è´¦æˆ·æœåŠ¡

é—®é¢˜ï¼šæŸä¸ªè¯·æ±‚å¾ˆæ…¢ï¼Œæ€ä¹ˆçŸ¥é“æ˜¯å“ªä¸ªç¯èŠ‚æ…¢ï¼Ÿ
è§£å†³ï¼šé“¾è·¯è¿½è¸ªï¼Œç»™æ¯ä¸ªè¯·æ±‚æ‰“æ ‡ç­¾ï¼Œè·Ÿè¸ªæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹
```

**ä½¿ç”¨ Sleuth è¿½è¸ª**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
2024-09-22 14:30:15 [order-service,a1b2c3d4,e5f6g7h8,true] INFO  è®¢å•åˆ›å»ºæˆåŠŸ
2024-09-22 14:30:16 [user-service,a1b2c3d4,i9j0k1l2,true] INFO  è·å–ç”¨æˆ·ä¿¡æ¯
2024-09-22 14:30:17 [pay-service,a1b2c3d4,m3n4o5p6,true] INFO  æ”¯ä»˜å¤„ç†å®Œæˆ
                     â†‘          â†‘         â†‘        â†‘
                 æœåŠ¡å    é“¾è·¯ID   èŠ‚ç‚¹ID   æ˜¯å¦é‡‡æ ·
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æœåŠ¡è°ƒç”¨æ–¹å¼å¯¹æ¯”


| è°ƒç”¨æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|---------|-------------|---------|---------|
| **RestTemplate** | `ç®€å•HTTPè°ƒç”¨ï¼Œå­¦ä¹ é˜¶æ®µ` | `ä½¿ç”¨ç®€å•ï¼ŒSpringåŸç”Ÿ` | `ä»£ç ç¹çï¼Œéœ€æ‰‹å†™URL` |
| **OpenFeign** | `ä¼ä¸šçº§å¾®æœåŠ¡ï¼Œæ¥å£è°ƒç”¨å¤š` | `å£°æ˜å¼ï¼Œä»£ç ç®€æ´` | `å­¦ä¹ æˆæœ¬ï¼Œé…ç½®å¤æ‚` |
| **WebClient** | `é«˜å¹¶å‘ï¼Œå“åº”å¼ç¼–ç¨‹` | `å¼‚æ­¥éé˜»å¡ï¼Œæ€§èƒ½å¥½` | `ç¼–ç¨‹æ¨¡å¼ä¸åŒï¼Œå­¦ä¹ æ›²çº¿é™¡` |

### 7.2 è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©


**ğŸ¯ é€‰æ‹©æŒ‡å—**ï¼š
```
æœåŠ¡å™¨æ€§èƒ½ç›¸åŒ â†’ è½®è¯¢ç­–ç•¥
æœåŠ¡å™¨é…ç½®ä¸åŒ â†’ åŠ æƒè½®è¯¢
å®æ—¶è´Ÿè½½æ•æ„Ÿ   â†’ æœ€å°‘æ´»è·ƒè¿æ¥
ç®€å•å¿«é€Ÿ      â†’ éšæœºç­–ç•¥
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**ï¼š
```
ç­–ç•¥å¤æ‚åº¦ï¼šéšæœº < è½®è¯¢ < åŠ æƒè½®è¯¢ < æœ€å°‘æ´»è·ƒ
å‡è¡¡æ•ˆæœï¼šéšæœº < è½®è¯¢ < æœ€å°‘æ´»è·ƒ < åŠ æƒè½®è¯¢
```

### 7.3 å…³é”®é…ç½®å»ºè®®


**â° è¶…æ—¶æ—¶é—´è®¾ç½®**ï¼š
- **è¿æ¥è¶…æ—¶**ï¼š2-5ç§’ï¼ˆå»ºç«‹è¿æ¥ï¼‰
- **è¯»å–è¶…æ—¶**ï¼šæ ¹æ®æ¥å£å¤æ‚åº¦ï¼Œ3-30ç§’
- **æ€»è¶…æ—¶**ï¼šè¿æ¥è¶…æ—¶ + è¯»å–è¶…æ—¶

**ğŸ”„ é‡è¯•é…ç½®**ï¼š
- **é‡è¯•æ¬¡æ•°**ï¼š2-3æ¬¡ï¼ˆé¿å…è¿‡å¤šé‡è¯•ï¼‰
- **é‡è¯•é—´éš”**ï¼š100msèµ·æ­¥ï¼ŒæŒ‡æ•°é€€é¿
- **é‡è¯•æ¡ä»¶**ï¼šåªé‡è¯•ç½‘ç»œé”™è¯¯ï¼Œä¸é‡è¯•ä¸šåŠ¡é”™è¯¯

**ğŸ“ˆ ç›‘æ§å‘Šè­¦**ï¼š
- **æˆåŠŸç‡**ï¼š< 95% å‘Šè­¦
- **å“åº”æ—¶é—´**ï¼šP99 > 3ç§’å‘Šè­¦  
- **QPSçªå¢**ï¼šè¶…è¿‡å¹³æ—¶2å€å‘Šè­¦

### 7.4 å®è·µç»éªŒæ€»ç»“


**âœ… æœ€ä½³å®è·µ**ï¼š
```
ğŸ”¸ æœåŠ¡è°ƒç”¨è¦æœ‰è¶…æ—¶è®¾ç½®
ğŸ”¸ é‡è¦æ¥å£å¿…é¡»æœ‰é‡è¯•æœºåˆ¶
ğŸ”¸ ä½¿ç”¨ç†”æ–­å™¨é˜²æ­¢é›ªå´©
ğŸ”¸ ç›‘æ§è°ƒç”¨æˆåŠŸç‡å’Œå“åº”æ—¶é—´
ğŸ”¸ æ¥å£è®¾è®¡è¦è€ƒè™‘å¹‚ç­‰æ€§
```

**âš ï¸ å¸¸è§å‘ç‚¹**ï¼š
```
âŒ è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­ï¼Œå¯¼è‡´å¤§é‡é‡è¯•
âŒ é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œæ”¾å¤§æ•…éšœå½±å“  
âŒ æ²¡æœ‰åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
âŒ è°ƒç”¨é“¾è¿‡é•¿ï¼Œæ’æŸ¥é—®é¢˜å›°éš¾
âŒ å¿½ç•¥äº†ç½‘ç»œåˆ†åŒºçš„å½±å“
```

### 7.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸš€ å¾ªåºæ¸è¿›**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šæŒæ¡ RestTemplate åŸºç¡€è°ƒç”¨
ç¬¬äºŒæ­¥ï¼šå­¦ä¹  OpenFeign å£°æ˜å¼è°ƒç”¨  
ç¬¬ä¸‰æ­¥ï¼šç†è§£è´Ÿè½½å‡è¡¡åŸç†å’Œé…ç½®
ç¬¬å››æ­¥ï¼šæŒæ¡è¶…æ—¶ã€é‡è¯•ã€ç›‘æ§
ç¬¬äº”æ­¥ï¼šæ·±å…¥ WebClient å¼‚æ­¥è°ƒç”¨
```

**ğŸ¯ é‡ç‚¹æŒæ¡**ï¼š
- OpenFeign æ˜¯ä¼ä¸šå¼€å‘çš„ä¸»æµé€‰æ‹©
- è´Ÿè½½å‡è¡¡ç­–ç•¥è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©
- è¶…æ—¶å’Œé‡è¯•é…ç½®ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒ
- ç›‘æ§æ˜¯ç”Ÿäº§ç¯å¢ƒå¿…ä¸å¯å°‘çš„èƒ½åŠ›

**ğŸ’¡ è®°å¿†è¦ç‚¹**ï¼š
- **æœåŠ¡è°ƒç”¨**ï¼šåƒæ‰“ç”µè¯ï¼Œéœ€è¦çŸ¥é“å·ç å’Œå†…å®¹
- **è´Ÿè½½å‡è¡¡**ï¼šåƒäº¤é€šæŒ‡æŒ¥ï¼Œåˆç†åˆ†é…æµé‡
- **OpenFeign**ï¼šæŠŠè¿œç¨‹è°ƒç”¨å˜æˆæœ¬åœ°æ–¹æ³•è°ƒç”¨
- **è¶…æ—¶é‡è¯•**ï¼šç½‘ç»œä¸å¯é ï¼Œéœ€è¦å®¹é”™æœºåˆ¶

**æ ¸å¿ƒç†å¿µ**ï¼šå¾®æœåŠ¡è°ƒç”¨è¦**ç®€å•æ˜“ç”¨**ã€**ç¨³å®šå¯é **ã€**å¯ç›‘æ§å¯æ§åˆ¶**