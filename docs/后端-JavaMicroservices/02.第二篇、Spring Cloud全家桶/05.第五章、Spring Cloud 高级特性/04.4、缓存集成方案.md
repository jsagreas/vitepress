---
title: 4ã€ç¼“å­˜é›†æˆæ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [Spring CacheæŠ½è±¡æœºåˆ¶](#1-Spring-CacheæŠ½è±¡æœºåˆ¶)
2. [Redisé›†æˆå®æˆ˜](#2-Redisé›†æˆå®æˆ˜)
3. [å¤šçº§ç¼“å­˜æ¶æ„](#3-å¤šçº§ç¼“å­˜æ¶æ„)
4. [ç¼“å­˜ä¸‰å¤§é—®é¢˜é˜²æŠ¤](#4-ç¼“å­˜ä¸‰å¤§é—®é¢˜é˜²æŠ¤)
5. [ç¼“å­˜ä¸€è‡´æ€§ä¿è¯](#5-ç¼“å­˜ä¸€è‡´æ€§ä¿è¯)
6. [åˆ†å¸ƒå¼é”åº”ç”¨](#6-åˆ†å¸ƒå¼é”åº”ç”¨)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§© Spring CacheæŠ½è±¡æœºåˆ¶


### 1.1 ä»€ä¹ˆæ˜¯Spring CacheæŠ½è±¡


**ğŸ”¸ é€šä¿—ç†è§£**
Spring Cacheå°±åƒæ˜¯ä¸€ä¸ª**ä¸‡èƒ½æ’åº§**ï¼Œä¸ç®¡ä½ ç”¨ä»€ä¹ˆç‰Œå­çš„ç¼“å­˜äº§å“ï¼ˆRedisã€Ehcacheã€Caffeineç­‰ï¼‰ï¼Œéƒ½èƒ½é€šè¿‡åŒæ ·çš„æ–¹å¼æ¥ä½¿ç”¨ã€‚

> **æ¯”å–»è¯´æ˜**ï¼šå°±åƒä½ ä¹°äº†ä¸€ä¸ªä¸‡èƒ½å……ç”µå™¨ï¼Œä¸ç®¡æ˜¯è‹¹æœæ‰‹æœºã€åä¸ºæ‰‹æœºè¿˜æ˜¯å°ç±³æ‰‹æœºï¼Œéƒ½èƒ½ç”¨åŒä¸€ä¸ªå……ç”µå™¨å……ç”µï¼Œåªæ˜¯å†…éƒ¨çš„å……ç”µèŠ¯ç‰‡ä¸åŒè€Œå·²ã€‚

```
ç¼“å­˜æŠ½è±¡å±‚æ¦‚å¿µå›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Cache æŠ½è±¡å±‚                    â”‚
â”‚         (ç»Ÿä¸€çš„ç¼“å­˜æ“ä½œæ¥å£)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Redis    â”‚  Ehcache    â”‚  Caffeine   â”‚    ...    â”‚
â”‚   ç¼“å­˜å®ç°   â”‚   ç¼“å­˜å®ç°   â”‚   ç¼“å­˜å®ç°   â”‚  å…¶ä»–å®ç°  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæ³¨è§£è¯¦è§£


**ğŸ”§ å››å¤§æ ¸å¿ƒæ³¨è§£**

| **æ³¨è§£** | **ä½œç”¨** | **ä½¿ç”¨æ—¶æœº** | **é€šä¿—ç†è§£** |
|---------|---------|-------------|-------------|
| `@Cacheable` | **æŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰å°±å­˜å…¥** | `æŸ¥è¯¢æ–¹æ³•ä¸Š` | `å…ˆçœ‹çœ‹æœ‰æ²¡æœ‰ï¼Œæ²¡æœ‰å°±æŸ¥æ•°æ®åº“å¹¶å­˜èµ·æ¥` |
| `@CachePut` | **æ›´æ–°ç¼“å­˜** | `æ–°å¢/ä¿®æ”¹æ–¹æ³•ä¸Š` | `ä¸ç®¡æœ‰æ²¡æœ‰ï¼Œéƒ½è¦æ›´æ–°ç¼“å­˜` |
| `@CacheEvict` | **åˆ é™¤ç¼“å­˜** | `åˆ é™¤æ–¹æ³•ä¸Š` | `æŠŠç¼“å­˜é‡Œçš„æ•°æ®åˆ æ‰` |
| `@Caching` | **ç»„åˆæ“ä½œ** | `å¤æ‚åœºæ™¯` | `ä¸€æ¬¡æ€§æ‰§è¡Œå¤šä¸ªç¼“å­˜æ“ä½œ` |

**ğŸ’¡ æ³¨è§£ä½¿ç”¨ç¤ºä¾‹**

```java
@Service
public class UserService {
    
    // ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ä¼šæŸ¥æ•°æ®åº“ï¼Œç»“æœå­˜å…¥ç¼“å­˜
    // åç»­æŸ¥è¯¢ç›´æ¥ä»ç¼“å­˜è·å–
    @Cacheable(value = "users", key = "#id")
    public User getUserById(Long id) {
        System.out.println("ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼š" + id);
        return userRepository.findById(id);
    }
    
    // æ›´æ–°ç”¨æˆ·æ—¶ï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜
    @CachePut(value = "users", key = "#user.id")
    public User updateUser(User user) {
        return userRepository.save(user);
    }
    
    // åˆ é™¤ç”¨æˆ·æ—¶ï¼Œæ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "users", key = "#id")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
    
    // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç¼“å­˜
    @CacheEvict(value = "users", allEntries = true)
    public void clearAllUsers() {
        // æ¸…ç†é€»è¾‘
    }
}
```

### 1.3 åŸºç¡€é…ç½®å…¥é—¨


**âš™ï¸ å¼€å¯ç¼“å­˜åŠŸèƒ½**

```java
@SpringBootApplication
@EnableCaching  // å¼€å¯ç¼“å­˜åŠŸèƒ½ï¼Œå°±åƒæ‰“å¼€æ€»å¼€å…³
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

**ğŸ“ é…ç½®æ–‡ä»¶è®¾ç½®**

```yaml
spring:
  cache:
    type: redis  # æŒ‡å®šä½¿ç”¨Redisä½œä¸ºç¼“å­˜
    redis:
      time-to-live: 600000  # ç¼“å­˜è¿‡æœŸæ—¶é—´10åˆ†é’Ÿ
      cache-null-values: false  # ä¸ç¼“å­˜ç©ºå€¼
```

---

## 2. ğŸ”´ Redisé›†æˆå®æˆ˜


### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©Redis


**ğŸ¯ Redisçš„ä¼˜åŠ¿**

```
Redisé€‰æ‹©ç†ç”±ï¼š

æ€§èƒ½ä¼˜åŠ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚
æŒä¹…åŒ–æ”¯æŒ â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Redis â”€â”€â”€â”€â”€ æ•°æ®ç»“æ„ä¸°å¯Œ
                  â”‚
é›†ç¾¤æ”¯æŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| **ç‰¹ç‚¹** | **è¯´æ˜** | **å®é™…ä»·å€¼** |
|---------|---------|-------------|
| **å†…å­˜å­˜å‚¨** | `æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œè¯»å†™æå¿«` | `æ¯«ç§’çº§å“åº”ï¼Œæå‡ç”¨æˆ·ä½“éªŒ` |
| **æ•°æ®æŒä¹…åŒ–** | `æ”¯æŒRDBå’ŒAOFæŒä¹…åŒ–` | `æœåŠ¡é‡å¯æ•°æ®ä¸ä¸¢å¤±` |
| **æ•°æ®ç±»å‹ä¸°å¯Œ** | `Stringã€Hashã€Listã€Setç­‰` | `é€‚åˆä¸åŒä¸šåŠ¡åœºæ™¯` |
| **é›†ç¾¤æ”¯æŒ** | `æ”¯æŒä¸»ä»å¤åˆ¶ã€å“¨å…µã€é›†ç¾¤` | `é«˜å¯ç”¨ã€å¯æ‰©å±•` |

### 2.2 Redisé›†æˆé…ç½®


**ğŸ”§ ä¾èµ–å¼•å…¥**

```xml
<dependencies>
    <!-- Spring Boot Rediså¯åŠ¨å™¨ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>
    
    <!-- ç¼“å­˜å¯åŠ¨å™¨ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-cache</artifactId>
    </dependency>
</dependencies>
```

**âš™ï¸ Redisé…ç½®è¯¦è§£**

```yaml
spring:
  redis:
    host: 127.0.0.1      # RedisæœåŠ¡å™¨åœ°å€
    port: 6379           # Redisç«¯å£
    password: your_password  # å¯†ç 
    timeout: 3000        # è¿æ¥è¶…æ—¶æ—¶é—´
    database: 0          # ä½¿ç”¨çš„æ•°æ®åº“ç¼–å·
    
    # è¿æ¥æ± é…ç½®
    lettuce:
      pool:
        max-active: 20   # æœ€å¤§è¿æ¥æ•°
        max-idle: 10     # æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 5      # æœ€å°ç©ºé—²è¿æ¥
        max-wait: 3000   # è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´
```

### 2.3 è‡ªå®šä¹‰ç¼“å­˜é…ç½®


**ğŸ¨ ä¸ªæ€§åŒ–é…ç½®**

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        // åˆ›å»ºRedisç¼“å­˜ç®¡ç†å™¨
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(factory)
            .cacheDefaults(getCacheConfiguration(Duration.ofMinutes(10))); // é»˜è®¤10åˆ†é’Ÿè¿‡æœŸ
        
        return builder.build();
    }
    
    private RedisCacheConfiguration getCacheConfiguration(Duration duration) {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(duration)  // è®¾ç½®è¿‡æœŸæ—¶é—´
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))  // keyåºåˆ—åŒ–
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer())); // valueåºåˆ—åŒ–
    }
}
```

---

## 3. ğŸ—ï¸ å¤šçº§ç¼“å­˜æ¶æ„


### 3.1 å¤šçº§ç¼“å­˜æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜**

å¤šçº§ç¼“å­˜å°±åƒæ˜¯ä¸€ä¸ª**å¿«é€’é…é€ç³»ç»Ÿ**ï¼š
- **L1ç¼“å­˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰**ï¼šåƒå°åŒºçš„å¿«é€’æŸœï¼Œæœ€è¿‘æœ€å¿«
- **L2ç¼“å­˜ï¼ˆRedisç¼“å­˜ï¼‰**ï¼šåƒåŒºåŸŸé…é€ä¸­å¿ƒï¼Œç¨è¿œä½†å®¹é‡å¤§
- **æ•°æ®åº“**ï¼šåƒæ€»ä»“åº“ï¼Œæœ€è¿œä½†æ˜¯æ•°æ®æœ€å…¨

```
å¤šçº§ç¼“å­˜æ¶æ„å›¾ï¼š

è¯·æ±‚ â†’ L1æœ¬åœ°ç¼“å­˜ â†’ L2åˆ†å¸ƒå¼ç¼“å­˜ â†’ æ•°æ®åº“
     â†‘(å‘½ä¸­)     â†‘(å‘½ä¸­)         â†‘(æŸ¥è¯¢)
     |          |              |
   è¿”å›ç»“æœ    è¿”å›ç»“æœ        è¿”å›ç»“æœ
   (æœ€å¿«)     (è¾ƒå¿«)          (æœ€æ…¢)
```

### 3.2 å®ç°å¤šçº§ç¼“å­˜


**ğŸ”§ Caffeine + Redisç»„åˆ**

```java
@Configuration
public class MultiLevelCacheConfig {
    
    @Bean
    @Primary
    public CacheManager multiLevelCacheManager(
            RedisConnectionFactory redisFactory) {
        
        // L1: æœ¬åœ°ç¼“å­˜é…ç½®
        Caffeine<Object, Object> caffeine = Caffeine.newBuilder()
            .maximumSize(1000)  // æœ€å¤§1000ä¸ªå…ƒç´ 
            .expireAfterWrite(Duration.ofMinutes(5));  // 5åˆ†é’Ÿè¿‡æœŸ
        
        CaffeineCacheManager localManager = new CaffeineCacheManager();
        localManager.setCaffeine(caffeine);
        
        // L2: Redisç¼“å­˜é…ç½®  
        RedisCacheManager redisManager = RedisCacheManager.builder(redisFactory)
            .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30)))  // 30åˆ†é’Ÿè¿‡æœŸ
            .build();
        
        // ç»„åˆå¤šçº§ç¼“å­˜
        return new MultiLevelCacheManager(localManager, redisManager);
    }
}
```

### 3.3 ä½¿ç”¨ç­–ç•¥


**ğŸ“‹ ç¼“å­˜é€‰æ‹©ç­–ç•¥**

| **æ•°æ®ç±»å‹** | **L1ç¼“å­˜(æœ¬åœ°)** | **L2ç¼“å­˜(Redis)** | **è¯´æ˜** |
|-------------|-----------------|-------------------|---------|
| **çƒ­ç‚¹æ•°æ®** | âœ… **é€‚åˆ** | âœ… **é€‚åˆ** | `è®¿é—®é¢‘ç‡é«˜ï¼Œæ”¾åœ¨L1æœ€å¿«` |
| **ç”¨æˆ·Session** | âŒ **ä¸é€‚åˆ** | âœ… **é€‚åˆ** | `éœ€è¦å…±äº«ï¼Œæ”¾åœ¨Redis` |
| **ä¸´æ—¶è®¡ç®—ç»“æœ** | âœ… **é€‚åˆ** | âŒ **ä¸é€‚åˆ** | `åªåœ¨å½“å‰æœåŠ¡ä½¿ç”¨` |
| **é…ç½®ä¿¡æ¯** | âœ… **é€‚åˆ** | âœ… **é€‚åˆ** | `å˜åŒ–å°‘ï¼Œå¯ä»¥å¤šçº§ç¼“å­˜` |

---

## 4. ğŸ›¡ï¸ ç¼“å­˜ä¸‰å¤§é—®é¢˜é˜²æŠ¤


### 4.1 ç¼“å­˜ç©¿é€é˜²æŠ¤


**â“ ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€**

ç¼“å­˜ç©¿é€å°±åƒæ˜¯æœ‰äºº**æ•…æ„è¯¢é—®ä¸å­˜åœ¨çš„å•†å“**ï¼Œæ¯æ¬¡éƒ½è¦è·‘åˆ°ä»“åº“å»æŸ¥ï¼Œä½†ä»“åº“é‡Œæ ¹æœ¬æ²¡æœ‰è¿™ä¸ªå•†å“ã€‚

> **åœºæ™¯ä¸¾ä¾‹**ï¼šç”¨æˆ·æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„ç”¨æˆ·IDï¼ˆæ¯”å¦‚-1ï¼‰ï¼Œç¼“å­˜é‡Œæ²¡æœ‰ï¼Œæ•°æ®åº“é‡Œä¹Ÿæ²¡æœ‰ï¼Œä½†æ¯æ¬¡æŸ¥è¯¢éƒ½è¦è®¿é—®æ•°æ®åº“ã€‚

```
ç¼“å­˜ç©¿é€ç¤ºæ„å›¾ï¼š

æ¶æ„è¯·æ±‚(æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®)
        â†“
     ç¼“å­˜(æœªå‘½ä¸­)
        â†“  
     æ•°æ®åº“(æŸ¥è¯¢æ— ç»“æœ)
        â†“
      è¿”å›ç©ºç»“æœ

è¿™ä¸ªè¿‡ç¨‹ä¼šé‡å¤å‘ç”Ÿï¼Œæ•°æ®åº“å‹åŠ›å·¨å¤§ï¼
```

**ğŸ”’ é˜²æŠ¤æ–¹æ¡ˆ**

```java
@Service
public class UserService {
    
    // æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå¯¹è±¡
    @Cacheable(value = "users", key = "#id", unless = "#result == null")
    public User getUserById(Long id) {
        User user = userRepository.findById(id);
        if (user == null) {
            // ç¼“å­˜ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œé˜²æ­¢é‡å¤æŸ¥è¯¢
            redisTemplate.opsForValue().set("users::" + id, "null", Duration.ofMinutes(5));
        }
        return user;
    }
    
    // æ–¹æ¡ˆ2ï¼šå¸ƒéš†è¿‡æ»¤å™¨é¢„åˆ¤
    @Autowired
    private BloomFilter<Long> userBloomFilter;
    
    public User getUserByIdWithBloom(Long id) {
        // å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!userBloomFilter.mightContain(id)) {
            return null; // è‚¯å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        }
        
        // å¯èƒ½å­˜åœ¨ï¼Œç»§ç»­æ­£å¸¸ç¼“å­˜é€»è¾‘
        return getUserFromCacheOrDB(id);
    }
}
```

### 4.2 ç¼“å­˜é›ªå´©é˜²æŠ¤


**â„ï¸ ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©**

ç¼“å­˜é›ªå´©å°±åƒæ˜¯**å¤§æ¥¼åœç”µ**ï¼Œæ‰€æœ‰ç”µæ¢¯åŒæ—¶åœæ­¢å·¥ä½œï¼Œå¤§å®¶éƒ½æŒ¤æ¥¼æ¢¯ï¼Œæ¥¼æ¢¯æ‰¿å—ä¸äº†è¿™ä¹ˆå¤šäººã€‚

> **åœºæ™¯ä¸¾ä¾‹**ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼ˆæ¯”å¦‚éƒ½è®¾ç½®äº†30åˆ†é’Ÿè¿‡æœŸï¼‰ï¼Œå¯¼è‡´ç¬é—´å¤§é‡è¯·æ±‚æ¶Œå‘æ•°æ®åº“ã€‚

**ğŸ”’ é˜²æŠ¤æ–¹æ¡ˆ**

```java
@Configuration
public class CacheSnowslideConfig {
    
    @Bean
    public CacheManager antiSnowslideCacheManager(RedisConnectionFactory factory) {
        return RedisCacheManager.builder(factory)
            .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                // å…³é”®ï¼šç»™è¿‡æœŸæ—¶é—´åŠ ä¸Šéšæœºå€¼ï¼Œé¿å…åŒæ—¶è¿‡æœŸ
                .entryTtl(Duration.ofMinutes(30).plusSeconds(
                    new Random().nextInt(300)))) // 30åˆ†é’ŸÂ±5åˆ†é’Ÿéšæœº
            .build();
    }
}

@Service
public class UserService {
    
    // å¤šçº§é˜²æŠ¤ï¼šæœ¬åœ°ç¼“å­˜å…œåº•
    public User getUserWithProtection(Long id) {
        try {
            // å…ˆæŸ¥Redisç¼“å­˜
            return getUserFromRedis(id);
        } catch (Exception e) {
            // RedisæŒ‚äº†ï¼Œç”¨æœ¬åœ°ç¼“å­˜å…œåº•
            return getUserFromLocalCache(id);
        }
    }
}
```

### 4.3 ç¼“å­˜å‡»ç©¿é˜²æŠ¤


**ğŸ’¥ ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿**

ç¼“å­˜å‡»ç©¿å°±åƒæ˜¯**ç½‘çº¢å•†å“æ–­è´§**ï¼Œå¤§å®¶éƒ½åœ¨ç­‰è¡¥è´§çš„é‚£ä¸€ç¬é—´ï¼Œç¬é—´æ¶Œå…¥å¤§é‡è¯·æ±‚ã€‚

> **åœºæ™¯ä¸¾ä¾‹**ï¼šçƒ­ç‚¹æ•°æ®çš„ç¼“å­˜è¿‡æœŸäº†ï¼Œç¬é—´å¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ã€‚

**ğŸ”’ é˜²æŠ¤æ–¹æ¡ˆ**

```java
@Service
public class UserService {
    
    private final RedissonClient redissonClient;
    
    // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å‡»ç©¿
    public User getUserWithLock(Long id) {
        // å…ˆæŸ¥ç¼“å­˜
        User user = getUserFromCache(id);
        if (user != null) {
            return user;
        }
        
        // ç¼“å­˜æ²¡æœ‰ï¼Œç”¨é”ä¿æŠ¤æ•°æ®åº“æŸ¥è¯¢
        String lockKey = "user:lock:" + id;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…3ç§’ï¼Œé”10ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                // å†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼ˆå¯èƒ½å…¶ä»–çº¿ç¨‹å·²ç»åŠ è½½äº†ï¼‰
                user = getUserFromCache(id);
                if (user != null) {
                    return user;
                }
                
                // æŸ¥è¯¢æ•°æ®åº“å¹¶æ›´æ–°ç¼“å­˜
                user = userRepository.findById(id);
                if (user != null) {
                    saveToCache(id, user);
                }
                return user;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        
        // è·å–é”å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼æˆ–é‡è¯•
        return null;
    }
}
```

---

## 5. ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ä¿è¯


### 5.1 ä¸€è‡´æ€§é—®é¢˜åˆ†æ


**âš ï¸ ä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´**

ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å°±åƒæ˜¯**é€šè®¯å½•åŒæ­¥é—®é¢˜**ï¼š
- ä½ çš„æ‰‹æœºé€šè®¯å½•æ›´æ–°äº†å¼ ä¸‰çš„ç”µè¯
- ä½†æ˜¯ç”µè„‘ä¸Šçš„é€šè®¯å½•è¿˜æ˜¯æ—§çš„ç”µè¯å·ç 
- é€ æˆäº†æ•°æ®ä¸ä¸€è‡´

```
ä¸ä¸€è‡´åœºæ™¯ï¼š

æ—¶é—´ â†’  æ“ä½œ1      æ“ä½œ2      ç¼“å­˜    æ•°æ®åº“
T1     æ›´æ–°DB      -        æ—§æ•°æ®   æ–°æ•°æ®  â† ä¸ä¸€è‡´ï¼
T2     æ¸…é™¤ç¼“å­˜    æŸ¥è¯¢ç¼“å­˜   ç©º      æ–°æ•°æ®  
T3     -          é‡å»ºç¼“å­˜   æ–°æ•°æ®   æ–°æ•°æ®  â† ä¸€è‡´äº†
```

### 5.2 ä¸€è‡´æ€§ç­–ç•¥


**ğŸ¯ å››ç§ä¸€è‡´æ€§ç­–ç•¥**

| **ç­–ç•¥** | **æ“ä½œé¡ºåº** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| **å…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°DB** | `åˆ ç¼“å­˜â†’æ›´æ–°DB` | `å®ç°ç®€å•` | `å¯èƒ½è¯»åˆ°æ—§æ•°æ®` |
| **å…ˆæ›´æ–°DBï¼Œå†åˆ ç¼“å­˜** | `æ›´æ–°DBâ†’åˆ ç¼“å­˜` | `æ•°æ®ç›¸å¯¹æ–°` | `åˆ ç¼“å­˜å¯èƒ½å¤±è´¥` |
| **åŒåˆ ç­–ç•¥** | `åˆ ç¼“å­˜â†’æ›´æ–°DBâ†’å»¶æ—¶åˆ ç¼“å­˜` | `å®‰å…¨æ€§é«˜` | `æœ‰å»¶æ—¶ï¼Œå¤æ‚` |
| **Canalè®¢é˜…** | `æ›´æ–°DBâ†’Canalæ„ŸçŸ¥â†’åˆ ç¼“å­˜` | `è§£è€¦ï¼Œå¯é ` | `å¼•å…¥ä¸­é—´ä»¶` |

**ğŸ”§ æ¨èå®ç°ï¼šåŒåˆ  + é‡è¯•**

```java
@Service
@Transactional
public class UserService {
    
    public User updateUserWithDoubleDelete(User user) {
        String cacheKey = "users::" + user.getId();
        
        try {
            // ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
            cacheManager.evict("users", user.getId());
            
            // æ›´æ–°æ•°æ®åº“
            User updatedUser = userRepository.save(user);
            
            // å»¶æ—¶åˆ é™¤ç¼“å­˜ï¼ˆé˜²æ­¢è¯»å†™å¹¶å‘é—®é¢˜ï¼‰
            CompletableFuture.runAsync(() -> {
                try {
                    Thread.sleep(1000); // å»¶æ—¶1ç§’
                    cacheManager.evict("users", user.getId());
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            });
            
            return updatedUser;
            
        } catch (Exception e) {
            // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¼‚æ­¥é‡è¯•åˆ é™¤ç¼“å­˜
            sendCacheDeleteMessage(cacheKey);
            throw e;
        }
    }
    
    // å¼‚æ­¥é‡è¯•åˆ é™¤ç¼“å­˜
    @RabbitListener(queues = "cache.delete.queue")
    public void handleCacheDelete(String cacheKey) {
        try {
            redisTemplate.delete(cacheKey);
        } catch (Exception e) {
            // é‡è¯•3æ¬¡åæ”¾å¼ƒ
            log.error("åˆ é™¤ç¼“å­˜å¤±è´¥: {}", cacheKey, e);
        }
    }
}
```

---

## 6. ğŸ” åˆ†å¸ƒå¼é”åº”ç”¨


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**ğŸ¤” åˆ†å¸ƒå¼é”çš„å¿…è¦æ€§**

æƒ³è±¡ä¸€ä¸‹**æŠ¢ç¥¨åœºæ™¯**ï¼š
- ç³»ç»Ÿéƒ¨ç½²äº†3ä¸ªæœåŠ¡å™¨
- æœ€åä¸€å¼ ç¥¨ï¼Œ3ä¸ªç”¨æˆ·åŒæ—¶åœ¨ä¸åŒæœåŠ¡å™¨ä¸ŠæŠ¢ç¥¨
- å¦‚æœæ²¡æœ‰åˆ†å¸ƒå¼é”ï¼Œå¯èƒ½ä¼šå‡ºç°è¶…å–

```
åˆ†å¸ƒå¼é”åœºæ™¯å›¾ï¼š

ç”¨æˆ·A â”€â”€â”€â”€â”€â”€â†’ æœåŠ¡å™¨1 â”€â”€â”€â”€â”
                        â”œâ”€â”€â†’ å…±äº«èµ„æº(åº“å­˜)
ç”¨æˆ·B â”€â”€â”€â”€â”€â”€â†’ æœåŠ¡å™¨2 â”€â”€â”€â”€â”¤
                        â”‚    éœ€è¦åˆ†å¸ƒå¼é”
ç”¨æˆ·C â”€â”€â”€â”€â”€â”€â†’ æœåŠ¡å™¨3 â”€â”€â”€â”€â”˜    ä¿æŠ¤å¹¶å‘è®¿é—®
```

### 6.2 Redissonåˆ†å¸ƒå¼é”


**ğŸ”§ Redissoné…ç½®**

```java
@Configuration
public class RedissonConfig {
    
    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
            .setAddress("redis://127.0.0.1:6379")
            .setPassword("your_password")
            .setConnectionMinimumIdleSize(5)
            .setConnectionPoolSize(10);
        
        return Redisson.create(config);
    }
}
```

**ğŸ¯ åˆ†å¸ƒå¼é”ä½¿ç”¨**

```java
@Service
public class OrderService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    // ç§’æ€å•†å“ï¼Œé˜²æ­¢è¶…å–
    public boolean seckillProduct(Long productId, Long userId) {
        String lockKey = "seckill:product:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼šç­‰å¾…æ—¶é—´3ç§’ï¼ŒæŒæœ‰æ—¶é—´10ç§’
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                
                // æ£€æŸ¥åº“å­˜
                Integer stock = getProductStock(productId);
                if (stock <= 0) {
                    return false; // åº“å­˜ä¸è¶³
                }
                
                // å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•
                decreaseStock(productId, 1);
                createOrder(productId, userId);
                
                return true;
                
            } else {
                return false; // è·å–é”å¤±è´¥ï¼Œè¯´æ˜å¤ªå¤šäººåœ¨æŠ¢
            }
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    // åˆ†å¸ƒå¼é” + ç¼“å­˜çš„ç»„åˆä½¿ç”¨
    @Cacheable(value = "products", key = "#productId")
    public Product getProductWithCache(Long productId) {
        String lockKey = "product:cache:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            if (lock.tryLock(1, 5, TimeUnit.SECONDS)) {
                // å†æ¬¡æ£€æŸ¥ç¼“å­˜
                Product cached = getCachedProduct(productId);
                if (cached != null) {
                    return cached;
                }
                
                // æŸ¥è¯¢æ•°æ®åº“
                Product product = productRepository.findById(productId);
                
                // æ›´æ–°ç¼“å­˜
                updateCache(productId, product);
                
                return product;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        
        // é™çº§å¤„ç†
        return productRepository.findById(productId);
    }
}
```

### 6.3 åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ


**âœ… ä½¿ç”¨è¦ç‚¹**

```java
public class BestPracticeExample {
    
    // âœ… æ­£ç¡®ä½¿ç”¨æ–¹å¼
    public void correctUsage() {
        RLock lock = redissonClient.getLock("business:lock:key");
        
        try {
            // 1. è®¾ç½®åˆç†çš„ç­‰å¾…æ—¶é—´å’ŒæŒæœ‰æ—¶é—´
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                
                // 2. ä¸šåŠ¡é€»è¾‘å°½é‡ç®€æ´ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´
                doQuickBusiness();
                
            } else {
                // 3. è·å–é”å¤±è´¥æ—¶çš„é™çº§å¤„ç†
                handleLockFailure();
            }
            
        } catch (InterruptedException e) {
            // 4. æ­£ç¡®å¤„ç†ä¸­æ–­å¼‚å¸¸
            Thread.currentThread().interrupt();
            handleInterruption();
        } finally {
            // 5. ç¡®ä¿é‡Šæ”¾é”ï¼Œé¿å…æ­»é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    // âŒ é”™è¯¯ä½¿ç”¨æ–¹å¼
    public void wrongUsage() {
        RLock lock = redissonClient.getLock("key");
        
        try {
            lock.lock(); // âŒ æ²¡æœ‰è®¾ç½®è¶…æ—¶ï¼Œå¯èƒ½æ°¸è¿œç­‰å¾…
            
            // âŒ åœ¨é”å†…è¿›è¡Œè€—æ—¶æ“ä½œ
            callExternalService();
            Thread.sleep(30000);
            
        } finally {
            lock.unlock(); // âŒ æ²¡æœ‰æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„é”
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Spring CacheæŠ½è±¡ï¼šç»Ÿä¸€çš„ç¼“å­˜æ“ä½œæ¥å£ï¼Œæ”¯æŒå¤šç§ç¼“å­˜å®ç°
ğŸ”¸ Redisé›†æˆï¼šé«˜æ€§èƒ½åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæ”¯æŒæŒä¹…åŒ–å’Œé›†ç¾¤
ğŸ”¸ å¤šçº§ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜+åˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
ğŸ”¸ ç¼“å­˜ä¸‰å¤§é—®é¢˜ï¼šç©¿é€ã€é›ªå´©ã€å‡»ç©¿çš„åŸç†å’Œé˜²æŠ¤æ–¹æ¡ˆ
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼šç¼“å­˜ä¸æ•°æ®åº“åŒæ­¥çš„ç­–ç•¥é€‰æ‹©
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢å¹¶å‘é—®é¢˜
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç¼“å­˜ä½¿ç”¨çš„æ ¸å¿ƒæ€æƒ³**
```
è¯»å¤šå†™å°‘ â†’ é€‚åˆç¼“å­˜
å®æ—¶æ€§è¦æ±‚ä¸é«˜ â†’ é€‚åˆç¼“å­˜  
çƒ­ç‚¹æ•°æ® â†’ é€‚åˆç¼“å­˜
è®¡ç®—å¤æ‚ â†’ é€‚åˆç¼“å­˜ç»“æœ
```

**ğŸ”¹ ç¼“å­˜å±‚æ¬¡çš„é€‰æ‹©ç­–ç•¥**
```
æœ¬åœ°ç¼“å­˜ï¼šè®¿é—®æœ€å¿«ï¼Œä½†æ•°æ®ä¸å…±äº«
åˆ†å¸ƒå¼ç¼“å­˜ï¼šæ•°æ®å…±äº«ï¼Œä½†æœ‰ç½‘ç»œå¼€é”€
æ•°æ®åº“ï¼šæ•°æ®æœ€å‡†ç¡®ï¼Œä½†æ€§èƒ½æœ€æ…¢
```

**ğŸ”¹ ä¸€è‡´æ€§ä¸æ€§èƒ½çš„æƒè¡¡**
```
å¼ºä¸€è‡´æ€§ â†’ æ€§èƒ½å·®ï¼Œä½†æ•°æ®å‡†ç¡®
æœ€ç»ˆä¸€è‡´æ€§ â†’ æ€§èƒ½å¥½ï¼Œä½†å¯èƒ½æœ‰å»¶è¿Ÿ
é€‰æ‹©æ ‡å‡†ï¼šçœ‹ä¸šåŠ¡å¯¹æ•°æ®å‡†ç¡®æ€§çš„è¦æ±‚
```

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ ç”µå•†ç³»ç»Ÿåº”ç”¨**
- **å•†å“ä¿¡æ¯ç¼“å­˜**ï¼šä½¿ç”¨Redisç¼“å­˜å•†å“è¯¦æƒ…ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
- **åº“å­˜æ§åˆ¶**ï¼šåˆ†å¸ƒå¼é”é˜²æ­¢è¶…å–é—®é¢˜
- **ç”¨æˆ·Session**ï¼šRediså­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€
- **çƒ­ç‚¹æ•°æ®**ï¼šå¤šçº§ç¼“å­˜åº”å¯¹å¤§ä¿ƒæµé‡

**ğŸ¯ åº”ç”¨é€‰å‹æŒ‡å¯¼**

| **åœºæ™¯** | **æ¨èæ–¹æ¡ˆ** | **åŸå› ** |
|---------|-------------|---------|
| **ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢** | `@Cacheable + Redis` | `è¯»å¤šå†™å°‘ï¼Œé€‚åˆç¼“å­˜` |
| **ç§’æ€å•†å“** | `åˆ†å¸ƒå¼é” + ç¼“å­˜` | `é˜²æ­¢è¶…å–ï¼Œä¿è¯ä¸€è‡´æ€§` |
| **é…ç½®ä¿¡æ¯** | `æœ¬åœ°ç¼“å­˜ + Redis` | `å˜åŒ–å°‘ï¼Œå¤šçº§ç¼“å­˜æ•ˆæœå¥½` |
| **å®æ—¶æ’è¡Œæ¦œ** | `Redisæœ‰åºé›†åˆ` | `éœ€è¦æ’åºå’Œå®æ—¶æ›´æ–°` |

### 7.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ ç¼“å­˜ä¼˜åŒ–è¦ç‚¹**
```
åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´ï¼šé¿å…å†…å­˜æµªè´¹
ä½¿ç”¨æ‰¹é‡æ“ä½œï¼šå‡å°‘ç½‘ç»œå¾€è¿”
åºåˆ—åŒ–ä¼˜åŒ–ï¼šé€‰æ‹©é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼
ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼šåŠæ—¶è°ƒæ•´ç¼“å­˜ç­–ç•¥
```

**ğŸ›¡ï¸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹**
```
ç¼“å­˜é¢„çƒ­ï¼šç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
é™çº§æ–¹æ¡ˆï¼šç¼“å­˜æ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
ç›‘æ§å‘Šè­¦ï¼šç¼“å­˜å¼‚å¸¸åŠæ—¶å‘ç°
å®šæœŸæ¸…ç†ï¼šé¿å…ç¼“å­˜æ•°æ®è¿‡åº¦å †ç§¯
```

### 7.5 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘**
- **Redisé«˜çº§ç‰¹æ€§**ï¼šé›†ç¾¤ã€å“¨å…µã€æŒä¹…åŒ–æœºåˆ¶
- **ç¼“å­˜æ¶æ„è®¾è®¡**ï¼šå¤§å‹ç³»ç»Ÿçš„ç¼“å­˜æ¶æ„æ¨¡å¼
- **æ€§èƒ½è°ƒä¼˜**ï¼šJVMç¼“å­˜ã€ç½‘ç»œä¼˜åŒ–ã€åºåˆ—åŒ–ä¼˜åŒ–
- **ç›‘æ§è¿ç»´**ï¼šç¼“å­˜ç›‘æ§æŒ‡æ ‡ã€æ•…éšœå¤„ç†é¢„æ¡ˆ

**ğŸ”§ å®æˆ˜é¡¹ç›®å»ºè®®**
- æ­å»ºRedisé›†ç¾¤ç¯å¢ƒ
- å®ç°å¤šçº§ç¼“å­˜demo
- æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯æµ‹è¯•
- å®è·µä¸åŒä¸€è‡´æ€§ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Spring CacheåšæŠ½è±¡ï¼ŒRedisé›†æˆæ€§èƒ½å¼º
å¤šçº§ç¼“å­˜åˆ†å±‚æ¬¡ï¼Œæœ¬åœ°åˆ†å¸ƒå„æœ‰é•¿
ä¸‰å¤§é—®é¢˜è¦é˜²æŠ¤ï¼Œç©¿é€é›ªå´©åŠ å‡»ç©¿
ä¸€è‡´æ€§ä¸æ€§èƒ½è¡¡ï¼Œä¸šåŠ¡éœ€æ±‚æ˜¯æ ‡å‡†
åˆ†å¸ƒå¼é”ä¿å¹¶å‘ï¼ŒRedissonä½¿ç”¨è¦è§„èŒƒ
```