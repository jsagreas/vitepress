---
title: 3ã€Spring Cloud LoadBalancerä½¿ç”¨
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆè¦æ›¿ä»£Ribbon](#1-ä¸ºä»€ä¹ˆè¦æ›¿ä»£Ribbon)
2. [LoadBalanceræ ¸å¿ƒæ¥å£](#2-LoadBalanceræ ¸å¿ƒæ¥å£)
3. [é»˜è®¤è½®è¯¢ç­–ç•¥](#3-é»˜è®¤è½®è¯¢ç­–ç•¥)
4. [è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨](#4-è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨)
5. [å¥åº·æ£€æŸ¥é›†æˆ](#5-å¥åº·æ£€æŸ¥é›†æˆ)
6. [é…ç½®å±æ€§è¯¦è§£](#6-é…ç½®å±æ€§è¯¦è§£)
7. [Ribbonè¿ç§»æŒ‡å—](#7-Ribbonè¿ç§»æŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ä¸ºä»€ä¹ˆè¦æ›¿ä»£Ribbon


### 1.1 Ribbonçš„å†å²é—®é¢˜


**Ribbonæ˜¯ä»€ä¹ˆ**ï¼šNetflixå¼€å‘çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸­å¹¿æ³›ä½¿ç”¨

```
ä¼ ç»Ÿè°ƒç”¨æ¨¡å¼ï¼š
æœåŠ¡A â†’ ç›´æ¥è°ƒç”¨ â†’ æœåŠ¡Bçš„æŸä¸ªå®ä¾‹

Ribbonæ¨¡å¼ï¼š
æœåŠ¡A â†’ Ribboné€‰æ‹© â†’ æœåŠ¡Bçš„å®ä¾‹1/2/3
              â†“
         è´Ÿè½½å‡è¡¡ç®—æ³•
```

**Ribboné¢ä¸´çš„é—®é¢˜**ï¼š

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ |
|---------|---------|------|
| **ç»´æŠ¤åœæ»** | Netflixå®˜æ–¹å·²åœæ­¢ç»´æŠ¤ | æ— æ–°ç‰¹æ€§ï¼Œbugä¸ä¿®å¤ |
| **æŠ€æœ¯è€æ—§** | åŸºäºä¼ ç»Ÿé˜»å¡å¼API | ä¸æ”¯æŒå“åº”å¼ç¼–ç¨‹ |
| **ä¾èµ–å¤æ‚** | ä¸Eurekaç­‰ç»„ä»¶å¼ºè€¦åˆ | éš¾ä»¥æ›¿æ¢æ³¨å†Œä¸­å¿ƒ |
| **æ€§èƒ½ç“¶é¢ˆ** | åŒæ­¥é˜»å¡è°ƒç”¨ | é«˜å¹¶å‘åœºæ™¯æ•ˆç‡ä½ |

### 1.2 Spring Cloud LoadBalancerçš„ä¼˜åŠ¿


**æ ¸å¿ƒæ”¹è¿›ç‚¹**ï¼š

```
ğŸ”¸ å®˜æ–¹æ”¯æŒ
â€¢ Springå®˜æ–¹å›¢é˜Ÿç»´æŠ¤
â€¢ æŒç»­æ›´æ–°å’Œä¼˜åŒ–
â€¢ ä¸Spring Cloudç”Ÿæ€å®Œç¾èåˆ

ğŸ”¸ ç°ä»£åŒ–è®¾è®¡
â€¢ æ”¯æŒå“åº”å¼ç¼–ç¨‹ï¼ˆWebFluxï¼‰
â€¢ éé˜»å¡å¼‚æ­¥è°ƒç”¨
â€¢ æ›´è½»é‡çº§çš„å®ç°

ğŸ”¸ çµæ´»æ‰©å±•
â€¢ ç®€æ´çš„APIè®¾è®¡
â€¢ æ˜“äºè‡ªå®šä¹‰ç­–ç•¥
â€¢ è§£è€¦æ³¨å†Œä¸­å¿ƒä¾èµ–
```

**é€‚ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

```
é€‰æ‹©Ribbonçš„åœºæ™¯ï¼ˆå·²ä¸æ¨èï¼‰ï¼š
âŒ è€é¡¹ç›®ç»´æŠ¤ï¼ŒçŸ­æœŸå†…ä¸å‡çº§
âŒ å›¢é˜Ÿå¯¹Ribbonéå¸¸ç†Ÿæ‚‰

é€‰æ‹©LoadBalancerçš„åœºæ™¯ï¼ˆæ¨èï¼‰ï¼š
âœ… æ–°é¡¹ç›®å¼€å‘
âœ… éœ€è¦å“åº”å¼ç¼–ç¨‹æ”¯æŒ
âœ… è¿½æ±‚æ›´å¥½çš„æ€§èƒ½
âœ… å¸Œæœ›ä½¿ç”¨Springå®˜æ–¹ç»´æŠ¤çš„ç»„ä»¶
```

---

## 2. ğŸ”Œ LoadBalanceræ ¸å¿ƒæ¥å£


### 2.1 ReactiveLoadBalanceræ¥å£


**æ¥å£å®šä¹‰**ï¼šè´Ÿè½½å‡è¡¡å™¨çš„æ ¸å¿ƒæŠ½è±¡

```java
// å“åº”å¼è´Ÿè½½å‡è¡¡å™¨æ¥å£
public interface ReactiveLoadBalancer<T> {
    
    // é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼ˆå¼‚æ­¥å“åº”å¼ï¼‰
    Mono<Response<T>> choose(Request request);
}
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š

**Responseå¯¹è±¡**ï¼šåŒ…è£…é€‰ä¸­çš„æœåŠ¡å®ä¾‹
```java
public class Response<T> {
    private final T server;        // é€‰ä¸­çš„æœåŠ¡å®ä¾‹
    private final boolean hasServer; // æ˜¯å¦æœ‰å¯ç”¨å®ä¾‹
    
    // åˆ¤æ–­æ˜¯å¦æˆåŠŸé€‰æ‹©åˆ°å®ä¾‹
    public boolean hasServer() {
        return this.hasServer;
    }
    
    // è·å–æœåŠ¡å®ä¾‹
    public T getServer() {
        return this.server;
    }
}
```

**Requestå¯¹è±¡**ï¼šå°è£…è¯·æ±‚ä¸Šä¸‹æ–‡
```java
public interface Request {
    // è·å–è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯
    RequestContext getContext();
}

// é»˜è®¤è¯·æ±‚å®ç°
public class DefaultRequest implements Request {
    private final RequestContext context;
    
    public DefaultRequest(RequestContext context) {
        this.context = context;
    }
}
```

### 2.2 ServiceInstanceListSupplieræ¥å£


**ä½œç”¨**ï¼šæä¾›å¯ç”¨æœåŠ¡å®ä¾‹åˆ—è¡¨

```java
public interface ServiceInstanceListSupplier {
    
    // è·å–æœåŠ¡ID
    String getServiceId();
    
    // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼ˆå“åº”å¼æµï¼‰
    Flux<List<ServiceInstance>> get();
    
    // æ ¹æ®è¯·æ±‚è·å–å®ä¾‹åˆ—è¡¨
    Flux<List<ServiceInstance>> get(Request request);
}
```

**å·¥ä½œåŸç†**ï¼š

```
æ³¨å†Œä¸­å¿ƒï¼ˆNacos/Consul/Eurekaï¼‰
          â†“
ServiceInstanceListSupplierï¼ˆè·å–å®ä¾‹åˆ—è¡¨ï¼‰
          â†“
ReactiveLoadBalancerï¼ˆé€‰æ‹©å…·ä½“å®ä¾‹ï¼‰
          â†“
è¿”å›é€‰ä¸­çš„æœåŠ¡å®ä¾‹
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Configuration
public class LoadBalancerConfig {
    
    @Bean
    public ServiceInstanceListSupplier discoveryClientServiceInstanceListSupplier(
            ConfigurableApplicationContext context) {
        
        // ä»æ³¨å†Œä¸­å¿ƒè·å–å®ä¾‹åˆ—è¡¨
        return ServiceInstanceListSupplier.builder()
                .withDiscoveryClient()  // ä½¿ç”¨æœåŠ¡å‘ç°å®¢æˆ·ç«¯
                .build(context);
    }
}
```

---

## 3. âš–ï¸ é»˜è®¤è½®è¯¢ç­–ç•¥


### 3.1 è½®è¯¢ç­–ç•¥åŸç†


**RoundRobinLoadBalancer**ï¼šSpring Cloud LoadBalancerçš„é»˜è®¤ç­–ç•¥

```
è½®è¯¢å·¥ä½œæ–¹å¼ï¼š
ç¬¬1æ¬¡è¯·æ±‚ â†’ å®ä¾‹1
ç¬¬2æ¬¡è¯·æ±‚ â†’ å®ä¾‹2
ç¬¬3æ¬¡è¯·æ±‚ â†’ å®ä¾‹3
ç¬¬4æ¬¡è¯·æ±‚ â†’ å®ä¾‹1ï¼ˆå¾ªç¯ï¼‰
...
```

**æ ¸å¿ƒå®ç°é€»è¾‘**ï¼š

```java
public class RoundRobinLoadBalancer implements ReactiveLoadBalancer<ServiceInstance> {
    
    // åŸå­è®¡æ•°å™¨ï¼Œè®°å½•å½“å‰ä½ç½®
    private final AtomicInteger position;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        
        // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
        return serviceInstanceListSupplier.get(request)
            .next()
            .map(instances -> {
                if (instances.isEmpty()) {
                    return new EmptyResponse();
                }
                
                // è®¡ç®—ä¸‹ä¸€ä¸ªä½ç½®ï¼ˆåŸå­æ“ä½œï¼‰
                int pos = position.incrementAndGet();
                // å–æ¨¡ç¡®ä¿ä¸è¶Šç•Œ
                ServiceInstance instance = instances.get(pos % instances.size());
                
                return new DefaultResponse(instance);
            });
    }
}
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š

```
ğŸ”¸ AtomicInteger position
â€¢ çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
â€¢ æ¯æ¬¡è¯·æ±‚è‡ªå¢1
â€¢ ä¿è¯å¹¶å‘ç¯å¢ƒä¸‹çš„è½®è¯¢é¡ºåº

ğŸ”¸ å–æ¨¡è¿ç®—ï¼ˆpos % instances.size()ï¼‰
â€¢ ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
â€¢ å®ç°å¾ªç¯è½®è¯¢æ•ˆæœ
â€¢ å®ä¾‹æ•°å˜åŒ–æ—¶è‡ªåŠ¨é€‚é…
```

### 3.2 è½®è¯¢ç­–ç•¥çš„ä¼˜ç¼ºç‚¹


**ä¼˜åŠ¿åˆ†æ**ï¼š

```
âœ… å®ç°ç®€å•
â€¢ æ— éœ€å¤æ‚è®¡ç®—
â€¢ ä»£ç æ˜“äºç†è§£å’Œç»´æŠ¤

âœ… åˆ†é…å‡åŒ€
â€¢ æ¯ä¸ªå®ä¾‹è·å¾—ç›¸åŒè¯·æ±‚æ•°
â€¢ é€‚åˆæ€§èƒ½ç›¸è¿‘çš„æœåŠ¡å®ä¾‹

âœ… æ— çŠ¶æ€
â€¢ ä¸éœ€è¦è®°å½•å†å²ä¿¡æ¯
â€¢ é‡å¯ä¸å½±å“è´Ÿè½½åˆ†é…
```

**å±€é™æ€§**ï¼š

```
âŒ ä¸è€ƒè™‘å®ä¾‹æ€§èƒ½å·®å¼‚
â€¢ é«˜é…å’Œä½é…æœåŠ¡å™¨è·å¾—ç›¸åŒæµé‡
â€¢ å¯èƒ½å¯¼è‡´æ€§èƒ½å¼±çš„å®ä¾‹è¿‡è½½

âŒ ä¸æ„ŸçŸ¥å®æ—¶è´Ÿè½½
â€¢ ä¸çŸ¥é“å®ä¾‹å½“å‰å¤„ç†çš„è¯·æ±‚æ•°
â€¢ ç¹å¿™çš„å®ä¾‹ä»å¯èƒ½è¢«é€‰ä¸­

âŒ æœåŠ¡å¯åŠ¨æ—¶çš„å†·å¯åŠ¨é—®é¢˜
â€¢ åˆšå¯åŠ¨çš„å®ä¾‹ç«‹å³æ¥æ”¶æµé‡
â€¢ å¯èƒ½å¯¼è‡´å¯åŠ¨æœŸé—´å“åº”æ…¢
```

---

## 4. ğŸ› ï¸ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨


### 4.1 å®ç°è‡ªå®šä¹‰ç­–ç•¥


**åœºæ™¯ï¼šåŸºäºæƒé‡çš„è´Ÿè½½å‡è¡¡**

å®é™…ä¸šåŠ¡ä¸­ï¼Œä¸åŒæœåŠ¡å™¨æ€§èƒ½ä¸åŒï¼Œéœ€è¦æŒ‰æƒé‡åˆ†é…æµé‡

```java
// 1. å®šä¹‰æƒé‡é…ç½®
public class WeightedServiceInstance {
    private ServiceInstance instance;
    private int weight;  // æƒé‡å€¼ï¼Œè¶Šå¤§åˆ†é…è¶Šå¤šæµé‡
    
    // getter/setter...
}

// 2. å®ç°åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡å™¨
public class WeightedLoadBalancer implements ReactiveLoadBalancer<ServiceInstance> {
    
    private final ServiceInstanceListSupplier supplier;
    private final AtomicInteger position = new AtomicInteger(0);
    
    public WeightedLoadBalancer(ServiceInstanceListSupplier supplier) {
        this.supplier = supplier;
    }
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        return supplier.get(request).next()
            .map(instances -> {
                if (instances.isEmpty()) {
                    return new EmptyResponse();
                }
                
                // æ„å»ºåŠ æƒå®ä¾‹åˆ—è¡¨
                List<ServiceInstance> weightedList = buildWeightedList(instances);
                
                // è½®è¯¢é€‰æ‹©
                int pos = position.incrementAndGet() % weightedList.size();
                return new DefaultResponse(weightedList.get(pos));
            });
    }
    
    // æ ¹æ®æƒé‡æ„å»ºå®ä¾‹åˆ—è¡¨
    private List<ServiceInstance> buildWeightedList(List<ServiceInstance> instances) {
        List<ServiceInstance> weightedList = new ArrayList<>();
        
        for (ServiceInstance instance : instances) {
            // ä»å®ä¾‹å…ƒæ•°æ®è·å–æƒé‡ï¼ˆé»˜è®¤ä¸º1ï¼‰
            int weight = getWeight(instance);
            
            // æ ¹æ®æƒé‡æ·»åŠ å¤šæ¬¡
            for (int i = 0; i < weight; i++) {
                weightedList.add(instance);
            }
        }
        
        return weightedList;
    }
    
    // è·å–å®ä¾‹æƒé‡
    private int getWeight(ServiceInstance instance) {
        String weight = instance.getMetadata().get("weight");
        return weight != null ? Integer.parseInt(weight) : 1;
    }
}
```

**å·¥ä½œåŸç†å›¾è§£**ï¼š

```
åŸå§‹å®ä¾‹åˆ—è¡¨ï¼š
å®ä¾‹A (æƒé‡=3)
å®ä¾‹B (æƒé‡=1)
å®ä¾‹C (æƒé‡=2)

æ„å»ºåçš„åŠ æƒåˆ—è¡¨ï¼š
[A, A, A, B, C, C]

è½®è¯¢ç»“æœï¼š
è¯·æ±‚1 â†’ A
è¯·æ±‚2 â†’ A  
è¯·æ±‚3 â†’ A
è¯·æ±‚4 â†’ B
è¯·æ±‚5 â†’ C
è¯·æ±‚6 â†’ C
è¯·æ±‚7 â†’ A (å¾ªç¯)
```

### 4.2 é…ç½®è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å™¨


**æ–¹å¼ä¸€ï¼šå…¨å±€é…ç½®**

```java
@Configuration
public class LoadBalancerConfig {
    
    @Bean
    @LoadBalanced  // å¯ç”¨è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    @Bean
    public ReactiveLoadBalancer<ServiceInstance> weightedLoadBalancer(
            ServiceInstanceListSupplier supplier) {
        
        return new WeightedLoadBalancer(supplier);
    }
}
```

**æ–¹å¼äºŒï¼šé’ˆå¯¹ç‰¹å®šæœåŠ¡**

```java
@Configuration
@LoadBalancerClient(
    name = "order-service",  // æœåŠ¡åç§°
    configuration = OrderServiceLoadBalancerConfig.class
)
public class LoadBalancerConfiguration {
}

// ç‰¹å®šæœåŠ¡çš„è´Ÿè½½å‡è¡¡é…ç½®
public class OrderServiceLoadBalancerConfig {
    
    @Bean
    public ReactiveLoadBalancer<ServiceInstance> orderServiceLoadBalancer(
            ServiceInstanceListSupplier supplier) {
        
        return new WeightedLoadBalancer(supplier);
    }
}
```

### 4.3 å…¶ä»–å¸¸è§è‡ªå®šä¹‰ç­–ç•¥


**éšæœºç­–ç•¥**ï¼š

```java
public class RandomLoadBalancer implements ReactiveLoadBalancer<ServiceInstance> {
    
    private final Random random = new Random();
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        return supplier.get(request).next()
            .map(instances -> {
                if (instances.isEmpty()) {
                    return new EmptyResponse();
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªå®ä¾‹
                int index = random.nextInt(instances.size());
                return new DefaultResponse(instances.get(index));
            });
    }
}
```

**åŸºäºå“åº”æ—¶é—´çš„ç­–ç•¥**ï¼š

```java
public class ResponseTimeLoadBalancer implements ReactiveLoadBalancer<ServiceInstance> {
    
    // è®°å½•æ¯ä¸ªå®ä¾‹çš„å¹³å‡å“åº”æ—¶é—´
    private final Map<String, Double> responseTimeMap = new ConcurrentHashMap<>();
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        return supplier.get(request).next()
            .map(instances -> {
                // é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹
                ServiceInstance fastest = instances.stream()
                    .min((i1, i2) -> {
                        double time1 = responseTimeMap.getOrDefault(i1.getInstanceId(), 0.0);
                        double time2 = responseTimeMap.getOrDefault(i2.getInstanceId(), 0.0);
                        return Double.compare(time1, time2);
                    })
                    .orElse(null);
                    
                return new DefaultResponse(fastest);
            });
    }
    
    // æ›´æ–°å“åº”æ—¶é—´ï¼ˆéœ€è¦é…åˆæ‹¦æˆªå™¨ä½¿ç”¨ï¼‰
    public void updateResponseTime(String instanceId, long responseTime) {
        responseTimeMap.compute(instanceId, (k, oldAvg) -> {
            if (oldAvg == null) return (double) responseTime;
            // ä½¿ç”¨ç§»åŠ¨å¹³å‡
            return oldAvg * 0.7 + responseTime * 0.3;
        });
    }
}
```

---

## 5. ğŸ¥ å¥åº·æ£€æŸ¥é›†æˆ


### 5.1 å¥åº·æ£€æŸ¥çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
æœåŠ¡å®ä¾‹åœ¨æ³¨å†Œä¸­å¿ƒæ˜¾ç¤º"UP"
ä½†å®é™…ï¼š
â€¢ æ•°æ®åº“è¿æ¥æ–­å¼€
â€¢ çº¿ç¨‹æ± è€—å°½
â€¢ å†…å­˜æº¢å‡º

ç»“æœï¼š
è´Ÿè½½å‡è¡¡å™¨æŠŠè¯·æ±‚å‘ç»™"å‡å¥åº·"çš„å®ä¾‹
â†’ è¯·æ±‚å¤±è´¥ â†’ ç”¨æˆ·ä½“éªŒå·®
```

**å¥åº·æ£€æŸ¥æœºåˆ¶**ï¼š

```
ä¸»åŠ¨å¥åº·æ£€æŸ¥ï¼š
LoadBalancer â†’ å®šæœŸæ¢æµ‹ â†’ æœåŠ¡å®ä¾‹
              â†“
         æ£€æŸ¥å“åº”çŠ¶æ€
              â†“
         æ›´æ–°å¥åº·çŠ¶æ€

è¢«åŠ¨å¥åº·æ£€æŸ¥ï¼š
è¯·æ±‚å¤±è´¥ â†’ è®°å½•é”™è¯¯ â†’ è¾¾åˆ°é˜ˆå€¼ â†’ æ ‡è®°ä¸å¥åº·
```

### 5.2 é›†æˆå¥åº·æ£€æŸ¥


**é…ç½®å¥åº·æ£€æŸ¥è¿‡æ»¤å™¨**ï¼š

```java
@Configuration
public class HealthCheckConfig {
    
    @Bean
    public ServiceInstanceListSupplier healthCheckServiceInstanceListSupplier(
            ConfigurableApplicationContext context) {
        
        return ServiceInstanceListSupplier.builder()
                .withDiscoveryClient()        // ä»æ³¨å†Œä¸­å¿ƒè·å–å®ä¾‹
                .withHealthChecks()           // å¯ç”¨å¥åº·æ£€æŸ¥
                .build(context);
    }
}
```

**application.ymlé…ç½®**ï¼š

```yaml
spring:
  cloud:
    loadbalancer:
      health-check:
        initial-delay: 0          # åˆå§‹å»¶è¿Ÿï¼ˆmsï¼‰
        interval: 30000           # æ£€æŸ¥é—´éš”30ç§’
        path: /actuator/health    # å¥åº·æ£€æŸ¥è·¯å¾„
```

**å¥åº·æ£€æŸ¥çš„å·¥ä½œæµç¨‹**ï¼š

```
æ—¶åˆ»T0: è·å–å®ä¾‹åˆ—è¡¨ [å®ä¾‹A, å®ä¾‹B, å®ä¾‹C]
        â†“
æ—¶åˆ»T1: å‘èµ·å¥åº·æ£€æŸ¥è¯·æ±‚
        å®ä¾‹A â†’ /actuator/health â†’ 200 OK âœ“
        å®ä¾‹B â†’ /actuator/health â†’ 500 Error âœ—
        å®ä¾‹C â†’ /actuator/health â†’ è¶…æ—¶ âœ—
        â†“
æ—¶åˆ»T2: è¿‡æ»¤ä¸å¥åº·å®ä¾‹
        å¯ç”¨åˆ—è¡¨: [å®ä¾‹A]
        â†“
æ—¶åˆ»T3: è´Ÿè½½å‡è¡¡å™¨åªåœ¨å¥åº·å®ä¾‹ä¸­é€‰æ‹©
        æ‰€æœ‰è¯·æ±‚ â†’ å®ä¾‹A
```

### 5.3 è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘


**å®ç°è‡ªå®šä¹‰å¥åº·æ£€æŸ¥å™¨**ï¼š

```java
public class CustomHealthCheckServiceInstanceListSupplier 
        extends DiscoveryClientServiceInstanceListSupplier {
    
    private final WebClient.Builder webClientBuilder;
    
    @Override
    public Flux<List<ServiceInstance>> get() {
        return super.get()
            .flatMap(this::filterHealthyInstances);
    }
    
    // è¿‡æ»¤å¥åº·å®ä¾‹
    private Flux<List<ServiceInstance>> filterHealthyInstances(
            List<ServiceInstance> instances) {
        
        // å¹¶å‘æ£€æŸ¥æ‰€æœ‰å®ä¾‹
        List<Mono<ServiceInstance>> healthChecks = instances.stream()
            .map(this::checkHealth)
            .collect(Collectors.toList());
        
        // åˆå¹¶ç»“æœï¼Œè¿‡æ»¤æ‰nullï¼ˆä¸å¥åº·çš„å®ä¾‹ï¼‰
        return Flux.merge(healthChecks)
            .filter(Objects::nonNull)
            .collectList()
            .flux();
    }
    
    // æ£€æŸ¥å•ä¸ªå®ä¾‹å¥åº·çŠ¶æ€
    private Mono<ServiceInstance> checkHealth(ServiceInstance instance) {
        String healthUrl = instance.getUri() + "/actuator/health";
        
        return webClientBuilder.build()
            .get()
            .uri(healthUrl)
            .retrieve()
            .bodyToMono(String.class)
            .timeout(Duration.ofSeconds(3))
            .map(response -> instance)  // å¥åº·åˆ™è¿”å›å®ä¾‹
            .onErrorReturn(null);       // å‡ºé”™åˆ™è¿”å›null
    }
}
```

**å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ**ï¼š

```
ğŸ”¸ è®¾ç½®åˆç†çš„æ£€æŸ¥é—´éš”
â€¢ å¤ªé¢‘ç¹ï¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…
â€¢ å¤ªç¨€ç–ï¼šä¸èƒ½åŠæ—¶å‘ç°æ•…éšœ
â€¢ æ¨èï¼š30-60ç§’

ğŸ”¸ é…ç½®è¶…æ—¶æ—¶é—´
â€¢ é¿å…å¥åº·æ£€æŸ¥é˜»å¡
â€¢ æ¨èï¼š3-5ç§’è¶…æ—¶

ğŸ”¸ å¤±è´¥é‡è¯•ç­–ç•¥
â€¢ å•æ¬¡å¤±è´¥ä¸ç«‹å³å‰”é™¤
â€¢ è¿ç»­Næ¬¡å¤±è´¥æ‰æ ‡è®°ä¸å¥åº·
â€¢ é¿å…ç½‘ç»œæŠ–åŠ¨è¯¯åˆ¤
```

---

## 6. âš™ï¸ é…ç½®å±æ€§è¯¦è§£


### 6.1 æ ¸å¿ƒé…ç½®é¡¹


**application.ymlå®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  cloud:
    loadbalancer:
      # è´Ÿè½½å‡è¡¡å™¨é…ç½®
      enabled: true                          # å¯ç”¨LoadBalancerï¼ˆé»˜è®¤trueï¼‰
      
      # é‡è¯•é…ç½®
      retry:
        enabled: true                        # å¯ç”¨é‡è¯•
        max-retries-on-same-service-instance: 0  # åŒå®ä¾‹é‡è¯•æ¬¡æ•°
        max-retries-on-next-service-instance: 1  # ä¸‹ä¸€å®ä¾‹é‡è¯•æ¬¡æ•°
        
      # å¥åº·æ£€æŸ¥é…ç½®
      health-check:
        initial-delay: 0                     # åˆå§‹å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
        interval: 30000                      # æ£€æŸ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        path: /actuator/health               # å¥åº·æ£€æŸ¥è·¯å¾„
        
      # ç¼“å­˜é…ç½®
      cache:
        enabled: true                        # å¯ç”¨å®ä¾‹åˆ—è¡¨ç¼“å­˜
        ttl: 35                             # ç¼“å­˜TTLï¼ˆç§’ï¼‰
        capacity: 256                        # ç¼“å­˜å®¹é‡
```

### 6.2 é…ç½®é¡¹è¯¦ç»†è¯´æ˜


**é‡è¯•é…ç½®è§£é‡Š**ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | æ¨èå€¼ | ä½¿ç”¨åœºæ™¯ |
|--------|------|--------|----------|
| `max-retries-on-same-service-instance` | åŒä¸€å®ä¾‹é‡è¯•æ¬¡æ•° | `0` | å®ä¾‹æ•…éšœåº”ç«‹å³åˆ‡æ¢ |
| `max-retries-on-next-service-instance` | ä¸‹ä¸€å®ä¾‹é‡è¯•æ¬¡æ•° | `1-2` | ç½‘ç»œæŠ–åŠ¨æ—¶çš„å®¹é”™ |
| `retry-on-all-operations` | æ˜¯å¦é‡è¯•æ‰€æœ‰æ“ä½œ | `false` | åªé‡è¯•GETç­‰å¹‚ç­‰æ“ä½œ |

**é‡è¯•æœºåˆ¶å·¥ä½œæµç¨‹**ï¼š

```
è¯·æ±‚å‘é€ â†’ å®ä¾‹A
          â†“
     å‡ºé”™ï¼ˆè¿æ¥è¶…æ—¶ï¼‰
          â†“
max-retries-on-same-service-instance = 0
          â†“
     ç«‹å³åˆ‡æ¢åˆ°å®ä¾‹B
          â†“
     å®ä¾‹Bä¹Ÿå¤±è´¥
          â†“
max-retries-on-next-service-instance = 1
          â†“
     å†å°è¯•å®ä¾‹C
          â†“
     æˆåŠŸæˆ–æœ€ç»ˆå¤±è´¥
```

**ç¼“å­˜é…ç½®è¯´æ˜**ï¼š

```
ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜
â€¢ å‡å°‘é¢‘ç¹è®¿é—®æ³¨å†Œä¸­å¿ƒ
â€¢ é™ä½ç½‘ç»œå¼€é”€
â€¢ æå‡å“åº”é€Ÿåº¦

ğŸ”¸ TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰
â€¢ è¿‡çŸ­ï¼šé¢‘ç¹åˆ·æ–°ï¼Œæ€§èƒ½å·®
â€¢ è¿‡é•¿ï¼šå®ä¾‹å˜åŒ–æ„ŸçŸ¥æ…¢
â€¢ æ¨èï¼š30-60ç§’

ğŸ”¸ ç¼“å­˜å¤±æ•ˆåœºæ™¯
â€¢ TTLåˆ°æœŸè‡ªåŠ¨åˆ·æ–°
â€¢ æ‰‹åŠ¨è§¦å‘åˆ·æ–°
â€¢ å¥åº·æ£€æŸ¥å‘ç°å®ä¾‹å˜åŒ–
```

### 6.3 é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„é…ç½®


**æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶æ–¹å¼**

```yaml
spring:
  cloud:
    loadbalancer:
      configurations: local  # ä½¿ç”¨æœ¬åœ°é…ç½®
      clients:
        order-service:           # ç‰¹å®šæœåŠ¡å
          health-check:
            interval: 10000      # è®¢å•æœåŠ¡10ç§’æ£€æŸ¥ä¸€æ¬¡
        user-service:
          retry:
            max-retries-on-next-service-instance: 2  # ç”¨æˆ·æœåŠ¡é‡è¯•2æ¬¡
```

**æ–¹å¼äºŒï¼šJavaé…ç½®æ–¹å¼**

```java
@Configuration
public class ServiceSpecificConfig {
    
    @Bean
    @LoadBalancerClient(name = "order-service")
    public LoadBalancerClientSpecification orderServiceSpec() {
        return new LoadBalancerClientSpecification(
            "order-service",
            new Class[]{OrderServiceLoadBalancerConfig.class}
        );
    }
}

// è®¢å•æœåŠ¡ä¸“å±é…ç½®
public class OrderServiceLoadBalancerConfig {
    
    @Bean
    public ServiceInstanceListSupplier orderServiceSupplier(
            ConfigurableApplicationContext context) {
        
        return ServiceInstanceListSupplier.builder()
            .withDiscoveryClient()
            .withHealthChecks()
            .withCaching()  // å¯ç”¨ç¼“å­˜
            .build(context);
    }
}
```

---

## 7. ğŸ”„ Ribbonè¿ç§»æŒ‡å—


### 7.1 ä¾èµ–å˜æ›´


**ç§»é™¤Ribbonä¾èµ–**ï¼š

```xml
<!-- æ—§ç‰ˆSpring Cloudä¾èµ–ï¼ˆåŒ…å«Ribbonï¼‰ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>

<!-- éœ€è¦æ’é™¤Ribbon -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    <exclusions>
        <exclusion>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
        </exclusion>
    </exclusions>
</dependency>

<!-- æ·»åŠ LoadBalancerä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

**Spring Cloud 2020ä¹‹åç‰ˆæœ¬**ï¼š

```xml
<!-- æ–°ç‰ˆæœ¬å·²é»˜è®¤ä½¿ç”¨LoadBalancerï¼Œæ— éœ€é¢å¤–é…ç½® -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

### 7.2 é…ç½®è¿ç§»å¯¹ç…§è¡¨


| Ribboné…ç½® | LoadBalanceré…ç½® | è¯´æ˜ |
|-----------|-----------------|------|
| `ribbon.ConnectTimeout` | `spring.cloud.loadbalancer.client.connect-timeout` | è¿æ¥è¶…æ—¶ |
| `ribbon.ReadTimeout` | `spring.cloud.loadbalancer.client.read-timeout` | è¯»å–è¶…æ—¶ |
| `ribbon.MaxAutoRetries` | `spring.cloud.loadbalancer.retry.max-retries-on-same-service-instance` | åŒå®ä¾‹é‡è¯• |
| `ribbon.MaxAutoRetriesNextServer` | `spring.cloud.loadbalancer.retry.max-retries-on-next-service-instance` | ä¸‹ä¸€å®ä¾‹é‡è¯• |
| `ribbon.NFLoadBalancerRuleClassName` | è‡ªå®šä¹‰`ReactiveLoadBalancer` Bean | è´Ÿè½½å‡è¡¡ç­–ç•¥ |

**é…ç½®è¿ç§»ç¤ºä¾‹**ï¼š

```yaml
# Ribboné…ç½®ï¼ˆæ—§ï¼‰
ribbon:
  ConnectTimeout: 3000
  ReadTimeout: 10000
  MaxAutoRetries: 0
  MaxAutoRetriesNextServer: 1

# LoadBalanceré…ç½®ï¼ˆæ–°ï¼‰
spring:
  cloud:
    loadbalancer:
      retry:
        enabled: true
        max-retries-on-same-service-instance: 0
        max-retries-on-next-service-instance: 1
```

### 7.3 ä»£ç è°ƒæ•´


**Ribbonè‡ªå®šä¹‰è§„åˆ™è¿ç§»**ï¼š

```java
// Ribbonæ–¹å¼ï¼ˆæ—§ï¼‰
@Configuration
public class RibbonConfig {
    
    @Bean
    public IRule ribbonRule() {
        return new RandomRule();  // éšæœºç­–ç•¥
    }
}

// LoadBalanceræ–¹å¼ï¼ˆæ–°ï¼‰
@Configuration
public class LoadBalancerConfig {
    
    @Bean
    public ReactiveLoadBalancer<ServiceInstance> randomLoadBalancer(
            ServiceInstanceListSupplier supplier) {
        
        return new RandomLoadBalancer(supplier);
    }
}
```

**@RibbonClientæ³¨è§£æ›¿æ¢**ï¼š

```java
// Ribbonæ–¹å¼ï¼ˆæ—§ï¼‰
@RibbonClient(name = "order-service", configuration = RibbonConfig.class)
public class AppConfig {
}

// LoadBalanceræ–¹å¼ï¼ˆæ–°ï¼‰
@LoadBalancerClient(name = "order-service", configuration = LoadBalancerConfig.class)
public class AppConfig {
}
```

### 7.4 è¿ç§»æ£€æŸ¥æ¸…å•


```
è¿ç§»å‰å‡†å¤‡ï¼š
â˜‘ï¸ ç¡®è®¤Spring Cloudç‰ˆæœ¬ï¼ˆå»ºè®®2020+ï¼‰
â˜‘ï¸ å¤‡ä»½ç°æœ‰é…ç½®æ–‡ä»¶
â˜‘ï¸ è®°å½•è‡ªå®šä¹‰Ribbonè§„åˆ™
â˜‘ï¸ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

è¿ç§»æ­¥éª¤ï¼š
â˜‘ï¸ æ›´æ–°pom.xmlä¾èµ–
â˜‘ï¸ æ›¿æ¢é…ç½®é¡¹
â˜‘ï¸ ä¿®æ”¹è‡ªå®šä¹‰è§„åˆ™ä»£ç 
â˜‘ï¸ æ›¿æ¢æ³¨è§£
â˜‘ï¸ ç¼–è¯‘éªŒè¯

è¿ç§»åéªŒè¯ï¼š
â˜‘ï¸ è´Ÿè½½å‡è¡¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
â˜‘ï¸ é‡è¯•æœºåˆ¶æ˜¯å¦ç”Ÿæ•ˆ
â˜‘ï¸ å¥åº·æ£€æŸ¥æ˜¯å¦æ­£å¸¸
â˜‘ï¸ æ€§èƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸ
```

**å¸¸è§è¿ç§»é—®é¢˜**ï¼š

```
Q: å¯åŠ¨æŠ¥é”™æ‰¾ä¸åˆ°Ribbonç›¸å…³ç±»ï¼Ÿ
A: ç¡®ä¿å·²æ’é™¤Ribbonä¾èµ–ï¼Œæ·»åŠ LoadBalancerä¾èµ–

Q: è´Ÿè½½å‡è¡¡ä¸ç”Ÿæ•ˆï¼Ÿ
A: æ£€æŸ¥@LoadBalancedæ³¨è§£æ˜¯å¦æ·»åŠ åˆ°RestTemplate

Q: è‡ªå®šä¹‰ç­–ç•¥ä¸ç”Ÿæ•ˆï¼Ÿ
A: ç¡®è®¤é…ç½®ç±»æ˜¯å¦æ­£ç¡®æ³¨å†Œä¸ºBean

Q: æ€§èƒ½æ¯”Ribbonå·®ï¼Ÿ
A: æ£€æŸ¥ç¼“å­˜é…ç½®ï¼Œè°ƒæ•´å¥åº·æ£€æŸ¥é—´éš”
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ LoadBalanceræ˜¯ä»€ä¹ˆ
â€¢ Springå®˜æ–¹çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç»„ä»¶
â€¢ æ›¿ä»£Netflix Ribbonçš„ç°ä»£åŒ–æ–¹æ¡ˆ
â€¢ æ”¯æŒå“åº”å¼ç¼–ç¨‹å’Œéé˜»å¡è°ƒç”¨

ğŸ”¸ æ ¸å¿ƒæ¥å£
â€¢ ReactiveLoadBalancerï¼šè´Ÿè½½å‡è¡¡å™¨æ¥å£
â€¢ ServiceInstanceListSupplierï¼šå®ä¾‹åˆ—è¡¨æä¾›è€…
â€¢ Request/Responseï¼šè¯·æ±‚å“åº”å°è£…

ğŸ”¸ é»˜è®¤ç­–ç•¥
â€¢ è½®è¯¢ï¼ˆRoundRobinï¼‰
â€¢ ç®€å•å‡åŒ€åˆ†é…æµé‡
â€¢ é€‚åˆåŒæ€§èƒ½å®ä¾‹é›†ç¾¤
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**è´Ÿè½½å‡è¡¡çš„æœ¬è´¨**ï¼š
```
ä¸æ˜¯ï¼š
â€¢ æœåŠ¡ç«¯çš„åå‘ä»£ç†
â€¢ ç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨

è€Œæ˜¯ï¼š
â€¢ å®¢æˆ·ç«¯çš„æ™ºèƒ½é€‰æ‹©
â€¢ ä»å®ä¾‹åˆ—è¡¨ä¸­æŒ‘é€‰ä¸€ä¸ª
â€¢ åœ¨å‘èµ·è°ƒç”¨å‰å®Œæˆé€‰æ‹©
```

**å¥åº·æ£€æŸ¥çš„æ„ä¹‰**ï¼š
```
æ³¨å†Œä¸­å¿ƒçš„"UP"çŠ¶æ€ â‰  çœŸæ­£å¥åº·

çœŸæ­£å¥åº·éœ€è¦ï¼š
â€¢ åº”ç”¨èƒ½æ­£å¸¸å¤„ç†è¯·æ±‚
â€¢ ä¾èµ–æœåŠ¡å¯ç”¨ï¼ˆæ•°æ®åº“ç­‰ï¼‰
â€¢ ç³»ç»Ÿèµ„æºå……è¶³
```

**è‡ªå®šä¹‰ç­–ç•¥çš„åœºæ™¯**ï¼š
```
ä½¿ç”¨é»˜è®¤è½®è¯¢ï¼š
â€¢ å®ä¾‹æ€§èƒ½ç›¸è¿‘
â€¢ æµé‡å‡åŒ€åˆ†é…
â€¢ ç®€å•åœºæ™¯

éœ€è¦è‡ªå®šä¹‰ï¼š
â€¢ å®ä¾‹æ€§èƒ½å·®å¼‚å¤§ï¼ˆæƒé‡ï¼‰
â€¢ å°±è¿‘è®¿é—®ï¼ˆåŒæœºæˆ¿ä¼˜å…ˆï¼‰
â€¢ å“åº”æ—¶é—´ä¼˜åŒ–
```

### 8.3 å®æˆ˜åº”ç”¨å»ºè®®


**æ–°é¡¹ç›®å¼€å‘**ï¼š
```
âœ… ç›´æ¥ä½¿ç”¨LoadBalancer
âœ… å¯ç”¨å¥åº·æ£€æŸ¥
âœ… é…ç½®åˆç†çš„é‡è¯•ç­–ç•¥
âœ… æ ¹æ®ä¸šåŠ¡é€‰æ‹©è´Ÿè½½å‡è¡¡ç­–ç•¥
```

**è€é¡¹ç›®è¿ç§»**ï¼š
```
1. è¯„ä¼°è¿ç§»æˆæœ¬
2. å‡†å¤‡è¿ç§»è®¡åˆ’
3. ç°åº¦éªŒè¯
4. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
5. å®Œå…¨åˆ‡æ¢
```

**é…ç½®è°ƒä¼˜**ï¼š
```
ğŸ”¸ å¥åº·æ£€æŸ¥é—´éš”
â€¢ å¼€å‘ç¯å¢ƒï¼š60ç§’ï¼ˆå‡å°‘æ—¥å¿—ï¼‰
â€¢ ç”Ÿäº§ç¯å¢ƒï¼š30ç§’ï¼ˆåŠæ—¶å‘ç°æ•…éšœï¼‰

ğŸ”¸ ç¼“å­˜TTL
â€¢ ç¨³å®šç¯å¢ƒï¼š60ç§’
â€¢ åŠ¨æ€æ‰©ç¼©å®¹ï¼š15-30ç§’

ğŸ”¸ é‡è¯•æ¬¡æ•°
â€¢ å¹‚ç­‰æ“ä½œï¼šå¯é‡è¯•
â€¢ éå¹‚ç­‰æ“ä½œï¼šç¦ç”¨é‡è¯•
```

**æ ¸å¿ƒè®°å¿†**ï¼š
```
LoadBalancerå®¢æˆ·ç«¯å‡è¡¡é€‰ï¼Œ
å“åº”å¼è®¾è®¡æ€§èƒ½å¼ºã€‚
è½®è¯¢é»˜è®¤å¤Ÿç”¨åœºæ™¯å¤šï¼Œ
è‡ªå®šä¹‰ç­–ç•¥åº”å¯¹å¤æ‚å†µã€‚
å¥åº·æ£€æŸ¥ä¿å¯ç”¨ï¼Œ
é…ç½®è°ƒä¼˜éœ€è€ƒé‡ã€‚
```