---
title: 4ã€è´Ÿè½½å‡è¡¡å®æˆ˜é…ç½®æ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [RestTemplateé›†æˆè´Ÿè½½å‡è¡¡](#1-RestTemplateé›†æˆè´Ÿè½½å‡è¡¡)
2. [OpenFeigné›†æˆè´Ÿè½½å‡è¡¡](#2-OpenFeigné›†æˆè´Ÿè½½å‡è¡¡)
3. [å¤šç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®](#3-å¤šç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®)
4. [è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©](#4-è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©)
5. [æ€§èƒ½è°ƒä¼˜æŠ€å·§](#5-æ€§èƒ½è°ƒä¼˜æŠ€å·§)
6. [æ•…éšœæ’æŸ¥æ–¹æ³•](#6-æ•…éšœæ’æŸ¥æ–¹æ³•)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ RestTemplateé›†æˆè´Ÿè½½å‡è¡¡


### 1.1 ä»€ä¹ˆæ˜¯RestTemplateè´Ÿè½½å‡è¡¡


**ğŸ’¡ é€šä¿—ç†è§£**

æƒ³è±¡ä½ è¦æ‰“å®¢æœç”µè¯ï¼Œæ‹¨é€šåä¼šè‡ªåŠ¨åˆ†é…ç»™ä¸åŒçš„å®¢æœäººå‘˜ï¼Œä¸éœ€è¦ä½ æŒ‡å®šæ‰¾å“ªä¸ªå®¢æœã€‚RestTemplateé›†æˆè´Ÿè½½å‡è¡¡å°±æ˜¯è¿™ä¸ªé“ç†ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨æŒ‡å®šæœåŠ¡å™¨ï¼‰ï¼š
è°ƒç”¨æ–¹ â†’ æ‰‹åŠ¨å†™æ­»IP â†’ http://192.168.1.100:8080/user/1

è´Ÿè½½å‡è¡¡æ–¹å¼ï¼ˆè‡ªåŠ¨é€‰æ‹©æœåŠ¡å™¨ï¼‰ï¼š
è°ƒç”¨æ–¹ â†’ æœåŠ¡åç§° â†’ http://user-service/user/1
          â†“
     è‡ªåŠ¨é€‰æ‹© â†’ å¯èƒ½æ˜¯192.168.1.100
               å¯èƒ½æ˜¯192.168.1.101
               å¯èƒ½æ˜¯192.168.1.102
```

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
- **æœåŠ¡åè°ƒç”¨**ï¼šä¸ç”¨å†™å…·ä½“IPåœ°å€ï¼Œç”¨æœåŠ¡åä»£æ›¿
- **è‡ªåŠ¨é€‰æ‹©**ï¼šæ¡†æ¶è‡ªåŠ¨ä»å¤šä¸ªæœåŠ¡å™¨ä¸­é€‰ä¸€ä¸ª
- **é€æ˜åˆ‡æ¢**ï¼šä½ æ„Ÿè§‰ä¸åˆ°åé¢æœ‰å¤šå°æœåŠ¡å™¨

### 1.2 å¿«é€Ÿä¸Šæ‰‹é…ç½®


**ğŸ“‹ å‰ç½®å‡†å¤‡æ¸…å•**
- [x] å·²æœ‰æ³¨å†Œä¸­å¿ƒï¼ˆNacos/Eurekaç­‰ï¼‰
- [x] æœåŠ¡å·²æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
- [x] é¡¹ç›®ä¸­å¼•å…¥äº†è´Ÿè½½å‡è¡¡ä¾èµ–

**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<!-- Spring Cloud LoadBalancer ä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®RestTemplate**

```java
@Configuration
public class RestTemplateConfig {
    
    /**
     * åˆ›å»ºå…·æœ‰è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„RestTemplate
     * @LoadBalanced æ³¨è§£æ˜¯å…³é”®ï¼šè®©RestTemplateå…·å¤‡è´Ÿè½½å‡è¡¡èƒ½åŠ›
     */
    @Bean
    @LoadBalanced  // ğŸ”‘ è¿™ä¸ªæ³¨è§£å¾ˆå…³é”®ï¼
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼š`@LoadBalanced` æ³¨è§£çš„ä½œç”¨
- æ™®é€šRestTemplateï¼šåªèƒ½ç”¨IPåœ°å€è°ƒç”¨ `http://192.168.1.100:8080`
- åŠ äº†æ³¨è§£åï¼šå¯ä»¥ç”¨æœåŠ¡åè°ƒç”¨ `http://user-service`ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡

**ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨æœåŠ¡åè°ƒç”¨**

```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    /**
     * è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯
     * å…³é”®ï¼šURLä¸­ä½¿ç”¨çš„æ˜¯æœåŠ¡å user-serviceï¼Œä¸æ˜¯IPåœ°å€
     */
    public User getUserInfo(Long userId) {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨æœåŠ¡å
        String url = "http://user-service/user/" + userId;
        
        // âŒ é”™è¯¯ï¼šä½¿ç”¨IPåœ°å€å°±å¤±å»è´Ÿè½½å‡è¡¡èƒ½åŠ›äº†
        // String url = "http://192.168.1.100:8080/user/" + userId;
        
        return restTemplate.getForObject(url, User.class);
    }
}
```

### 1.3 å·¥ä½œåŸç†è§£æ


**ğŸ” è°ƒç”¨æµç¨‹å›¾**

```
1. å‘èµ·è¯·æ±‚
   OrderService.getUserInfo(1)
   â†“
2. RestTemplateæ¥æ”¶
   URL: http://user-service/user/1
   â†“
3. æ‹¦æˆªå™¨å·¥ä½œ
   å‘ç°æ˜¯æœåŠ¡å â†’ è§¦å‘è´Ÿè½½å‡è¡¡
   â†“
4. ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨
   user-service â†’ [192.168.1.100:8080,
                   192.168.1.101:8080,
                   192.168.1.102:8080]
   â†“
5. è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©
   è½®è¯¢ç­–ç•¥ â†’ é€‰ä¸­ 192.168.1.101:8080
   â†“
6. æ›¿æ¢URLå‘èµ·çœŸå®è°ƒç”¨
   http://192.168.1.101:8080/user/1
   â†“
7. è¿”å›ç»“æœ
```

**âš™ï¸ åº•å±‚æœºåˆ¶**

| ç»„ä»¶ | ä½œç”¨ | é€šä¿—ç†è§£ |
|------|------|----------|
| **LoadBalancerInterceptor** | æ‹¦æˆªè¯·æ±‚ | åƒä¸ªé—¨å«ï¼Œçœ‹åˆ°æœåŠ¡åå°±æ‹¦ä¸‹æ¥å¤„ç† |
| **ServiceInstanceChooser** | é€‰æ‹©æœåŠ¡å®ä¾‹ | åƒä¸ªè°ƒåº¦å‘˜ï¼Œå†³å®šè¯¥æ‰¾å“ªå°æœåŠ¡å™¨ |
| **DiscoveryClient** | è·å–æœåŠ¡åˆ—è¡¨ | åƒä¸ªé€šè®¯å½•ï¼ŒçŸ¥é“æ‰€æœ‰æœåŠ¡å™¨åœ°å€ |

### 1.4 å¸¸è§é…ç½®è°ƒæ•´


**ğŸ”§ è¶…æ—¶æ—¶é—´é…ç½®**

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate() {
        // åˆ›å»ºHTTPå®¢æˆ·ç«¯å·¥å‚ï¼Œé…ç½®è¶…æ—¶æ—¶é—´
        SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
        
        // è¿æ¥è¶…æ—¶ï¼š3ç§’ï¼ˆè¿æ¥æœåŠ¡å™¨çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼‰
        factory.setConnectTimeout(3000);
        
        // è¯»å–è¶…æ—¶ï¼š5ç§’ï¼ˆç­‰å¾…å“åº”æ•°æ®çš„æœ€å¤§æ—¶é—´ï¼‰
        factory.setReadTimeout(5000);
        
        return new RestTemplate(factory);
    }
}
```

ğŸ’¡ **è¶…æ—¶æ—¶é—´è®¾ç½®å»ºè®®**ï¼š
- **è¿æ¥è¶…æ—¶**ï¼šé€šå¸¸è®¾ç½® `2-5ç§’`ï¼Œç½‘ç»œä¸å¥½å¯ä»¥è®¾é•¿ç‚¹
- **è¯»å–è¶…æ—¶**ï¼šæ ¹æ®ä¸šåŠ¡è®¾ç½®ï¼ŒæŸ¥è¯¢å¿«çš„ `3-5ç§’`ï¼Œå¤„ç†æ…¢çš„ `10-30ç§’`

**ğŸ¯ é‡è¯•æœºåˆ¶é…ç½®**

```yml
# application.yml
spring:
  cloud:
    loadbalancer:
      retry:
        enabled: true  # å¼€å¯é‡è¯•
        max-retries-on-same-service-instance: 1  # åŒä¸€æœåŠ¡å™¨é‡è¯•1æ¬¡
        max-retries-on-next-service-instance: 2  # æ¢å…¶ä»–æœåŠ¡å™¨é‡è¯•2æ¬¡
```

âš ï¸ **é‡è¯•æ³¨æ„äº‹é¡¹**ï¼š
- åªå¯¹**å¹‚ç­‰æ¥å£**å¼€å¯é‡è¯•ï¼ˆGETã€æŸ¥è¯¢ç±»æ¥å£ï¼‰
- **éå¹‚ç­‰æ¥å£**ï¼ˆPOSTã€ä¿®æ”¹ç±»ï¼‰æ…ç”¨é‡è¯•ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®é‡å¤

---

## 2. ğŸš€ OpenFeigné›†æˆè´Ÿè½½å‡è¡¡


### 2.1 ä¸ºä»€ä¹ˆç”¨OpenFeign


**ğŸ“Š RestTemplate vs OpenFeign å¯¹æ¯”**

```
RestTemplateæ–¹å¼ï¼ˆåŸå§‹ï¼‰ï¼š
String url = "http://user-service/user/" + userId;
User user = restTemplate.getForObject(url, User.class);
â†“ éœ€è¦æ‰‹åŠ¨æ‹¼æ¥URLï¼Œå®¹æ˜“å‡ºé”™

OpenFeignæ–¹å¼ï¼ˆä¼˜é›…ï¼‰ï¼š
@FeignClient("user-service")
interface UserClient {
    @GetMapping("/user/{id}")
    User getUser(@PathVariable Long id);
}
â†“ åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•
```

**âœ… OpenFeignçš„ä¼˜åŠ¿**
- **å£°æ˜å¼è°ƒç”¨**ï¼šç”¨æ¥å£å®šä¹‰ï¼Œä¸å†™å…·ä½“è°ƒç”¨ä»£ç 
- **è‡ªå¸¦è´Ÿè½½å‡è¡¡**ï¼šå¤©ç”Ÿæ”¯æŒï¼Œä¸éœ€è¦é¢å¤–é…ç½®
- **å‚æ•°ç»‘å®š**ï¼šè‡ªåŠ¨å¤„ç†å‚æ•°å’Œè¿”å›å€¼
- **æ˜“äºç»´æŠ¤**ï¼šæ¥å£å®šä¹‰æ¸…æ™°ï¼Œä¿®æ”¹æ–¹ä¾¿

### 2.2 OpenFeignå¿«é€Ÿé…ç½®


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šå¯ç”¨Feignå®¢æˆ·ç«¯**

```java
@SpringBootApplication
@EnableFeignClients  // ğŸ”‘ å¼€å¯FeignåŠŸèƒ½
public class OrderApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼šå®šä¹‰Feignæ¥å£**

```java
/**
 * ç”¨æˆ·æœåŠ¡è°ƒç”¨æ¥å£
 * @FeignClientï¼šæŒ‡å®šè¦è°ƒç”¨çš„æœåŠ¡å
 */
@FeignClient(value = "user-service")  // valueæ˜¯æœåŠ¡å
public interface UserClient {
    
    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     * æ¥å£å®šä¹‰å’ŒæœåŠ¡æä¾›æ–¹çš„Controllerä¿æŒä¸€è‡´
     */
    @GetMapping("/user/{id}")
    User getUser(@PathVariable("id") Long id);
    
    /**
     * æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·
     */
    @PostMapping("/user/batch")
    List<User> batchGetUsers(@RequestBody List<Long> userIds);
}
```

ğŸ’¡ **æ¥å£å®šä¹‰è¦ç‚¹**ï¼š
- `@FeignClient` çš„ `value` è¦å’Œæ³¨å†Œä¸­å¿ƒçš„æœåŠ¡å**å®Œå…¨ä¸€è‡´**
- æ¥å£æ–¹æ³•çš„è·¯å¾„ã€å‚æ•°è¦å’Œæä¾›æ–¹çš„ Controller **å®Œå…¨ä¸€è‡´**
- å‚æ•°æ³¨è§£è¦å†™å…¨ï¼Œå¦‚ `@PathVariable("id")` ä¸èƒ½çœç•¥å‚æ•°å

**ç¬¬å››æ­¥ï¼šä½¿ç”¨Feignæ¥å£**

```java
@Service
public class OrderService {
    
    @Autowired
    private UserClient userClient;  // ç›´æ¥æ³¨å…¥ä½¿ç”¨
    
    /**
     * åˆ›å»ºè®¢å•æ—¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     */
    public Order createOrder(Long userId, Long productId) {
        // åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•ï¼
        User user = userClient.getUser(userId);
        
        // ä¸šåŠ¡é€»è¾‘...
        Order order = new Order();
        order.setUserId(user.getId());
        order.setUserName(user.getName());
        
        return order;
    }
}
```

### 2.3 OpenFeignè´Ÿè½½å‡è¡¡é…ç½®


**ğŸ¯ é»˜è®¤è´Ÿè½½å‡è¡¡ç­–ç•¥**

OpenFeignå†…ç½®äº†è´Ÿè½½å‡è¡¡ï¼Œé»˜è®¤ä½¿ç”¨**è½®è¯¢ç­–ç•¥**ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚

**è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥**

```yml
# application.yml
user-service:  # æœåŠ¡å
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule  # éšæœºç­–ç•¥
```

**ğŸ“‹ å¸¸ç”¨ç­–ç•¥é€‰æ‹©**

| ç­–ç•¥ç±» | ç­–ç•¥åç§° | ä½¿ç”¨åœºæ™¯ | 
|--------|---------|----------|
| `RoundRobinRule` | è½®è¯¢ï¼ˆé»˜è®¤ï¼‰ | æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘æ—¶ä½¿ç”¨ |
| `RandomRule` | éšæœº | ç®€å•åœºæ™¯ï¼Œä¸è¿½æ±‚ç»å¯¹å‡è¡¡ |
| `WeightedResponseTimeRule` | å“åº”æ—¶é—´åŠ æƒ | æœåŠ¡å™¨æ€§èƒ½æœ‰å·®å¼‚æ—¶ |
| `BestAvailableRule` | æœ€å°‘å¹¶å‘ | å¤„ç†èƒ½åŠ›ä¸åŒæ—¶ |

### 2.4 OpenFeignè¿›é˜¶é…ç½®


**â±ï¸ è¶…æ—¶æ—¶é—´é…ç½®**

```yml
# application.yml
feign:
  client:
    config:
      default:  # å…¨å±€é…ç½®
        connectTimeout: 3000  # è¿æ¥è¶…æ—¶3ç§’
        readTimeout: 5000     # è¯»å–è¶…æ—¶5ç§’
      
      user-service:  # é’ˆå¯¹ç‰¹å®šæœåŠ¡é…ç½®
        connectTimeout: 5000
        readTimeout: 10000
```

**ğŸ”„ é‡è¯•é…ç½®**

```java
@Configuration
public class FeignConfig {
    
    /**
     * è‡ªå®šä¹‰é‡è¯•å™¨
     */
    @Bean
    public Retryer feignRetryer() {
        // å‚æ•°ï¼šåˆå§‹é—´éš”100msï¼Œæœ€å¤§é—´éš”1ç§’ï¼Œæœ€å¤šé‡è¯•3æ¬¡
        return new Retryer.Default(100, 1000, 3);
    }
}
```

**ğŸ“ æ—¥å¿—é…ç½®ï¼ˆè°ƒè¯•ç¥å™¨ï¼‰**

```java
@Configuration
public class FeignConfig {
    
    /**
     * Feignæ—¥å¿—çº§åˆ«
     */
    @Bean
    public Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;  // æ‰“å°å®Œæ•´è¯·æ±‚å“åº”ä¿¡æ¯
    }
}
```

```yml
# application.yml - é…åˆä½¿ç”¨
logging:
  level:
    com.example.client.UserClient: debug  # æŒ‡å®šFeignæ¥å£çš„æ—¥å¿—çº§åˆ«
```

ğŸ’¡ **æ—¥å¿—çº§åˆ«è¯´æ˜**ï¼š
- `NONE`ï¼šä¸è®°å½•ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
- `BASIC`ï¼šè®°å½•è¯·æ±‚æ–¹æ³•ã€URLã€å“åº”çŠ¶æ€
- `HEADERS`ï¼šBASIC + è¯·æ±‚å“åº”å¤´
- `FULL`ï¼šHEADERS + è¯·æ±‚å“åº”ä½“ï¼ˆè°ƒè¯•æ—¶ç”¨ï¼‰

---

## 3. ğŸŒ å¤šç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®


### 3.1 å¤šç¯å¢ƒé…ç½®éœ€æ±‚


**å®é™…ä¸šåŠ¡åœºæ™¯**

```
å…¬å¸é¡¹ç›®éƒ¨ç½²æ¶æ„ï¼š
â”œâ”€â”€ å¼€å‘ç¯å¢ƒï¼ˆdevï¼‰   â†’ å•å°æœåŠ¡å™¨ï¼Œä¸éœ€è¦è´Ÿè½½å‡è¡¡
â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒï¼ˆtestï¼‰  â†’ 2å°æœåŠ¡å™¨ï¼Œè½®è¯¢ç­–ç•¥
â”œâ”€â”€ é¢„å‘ç¯å¢ƒï¼ˆpreï¼‰   â†’ 3å°æœåŠ¡å™¨ï¼Œå“åº”æ—¶é—´åŠ æƒ
â””â”€â”€ ç”Ÿäº§ç¯å¢ƒï¼ˆprodï¼‰  â†’ 5å°æœåŠ¡å™¨ï¼Œæœ€å°‘å¹¶å‘ç­–ç•¥
```

**ğŸ¯ é…ç½®ç›®æ ‡**
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥
- ä¸åŒæœåŠ¡å¯ä»¥æœ‰ä¸åŒçš„é…ç½®
- é…ç½®è¦çµæ´»ï¼Œæ˜“äºåˆ‡æ¢å’Œç»´æŠ¤

### 3.2 é…ç½®æ–‡ä»¶æ‹†åˆ†


**ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„**

```
resources/
â”œâ”€â”€ application.yml              # ä¸»é…ç½®
â”œâ”€â”€ application-dev.yml          # å¼€å‘ç¯å¢ƒ
â”œâ”€â”€ application-test.yml         # æµ‹è¯•ç¯å¢ƒ
â”œâ”€â”€ application-pre.yml          # é¢„å‘ç¯å¢ƒ
â””â”€â”€ application-prod.yml         # ç”Ÿäº§ç¯å¢ƒ
```

**ä¸»é…ç½®æ–‡ä»¶**

```yml
# application.yml
spring:
  application:
    name: order-service
  profiles:
    active: @env@  # Mavenæ‰“åŒ…æ—¶åŠ¨æ€æ›¿æ¢
```

**å¼€å‘ç¯å¢ƒé…ç½®**

```yml
# application-dev.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev

# å¼€å‘ç¯å¢ƒï¼šå•æœºéƒ¨ç½²ï¼Œä¸éœ€è¦ç‰¹æ®Šç­–ç•¥
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**

```yml
# application-prod.yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: nacos-prod.company.com:8848
        namespace: prod

# ç”Ÿäº§ç¯å¢ƒï¼šå¤šæœºéƒ¨ç½²ï¼Œæ€§èƒ½ä¼˜å…ˆ
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule
    MaxAutoRetries: 1                    # åŒä¸€æœåŠ¡å™¨é‡è¯•1æ¬¡
    MaxAutoRetriesNextServer: 2          # æ¢æœåŠ¡å™¨é‡è¯•2æ¬¡
    ReadTimeout: 5000                    # è¯»è¶…æ—¶5ç§’
    ConnectTimeout: 2000                 # è¿æ¥è¶…æ—¶2ç§’
    OkToRetryOnAllOperations: false      # éGETè¯·æ±‚ä¸é‡è¯•

product-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.WeightedResponseTimeRule
```

### 3.3 Javaé…ç½®æ–¹å¼


**ğŸ”§ åŸºäºæ¡ä»¶çš„é…ç½®**

```java
@Configuration
public class LoadBalancerConfig {
    
    /**
     * å¼€å‘ç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®
     */
    @Bean
    @Profile("dev")  // åªåœ¨devç¯å¢ƒç”Ÿæ•ˆ
    public IRule devRule() {
        return new RoundRobinRule();  // è½®è¯¢
    }
    
    /**
     * ç”Ÿäº§ç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®
     */
    @Bean
    @Profile("prod")  // åªåœ¨prodç¯å¢ƒç”Ÿæ•ˆ
    public IRule prodRule() {
        return new BestAvailableRule();  // æœ€å°‘å¹¶å‘
    }
    
    /**
     * æµ‹è¯•ç¯å¢ƒè´Ÿè½½å‡è¡¡é…ç½®
     */
    @Bean
    @Profile("test")
    public IRule testRule() {
        return new RandomRule();  // éšæœº
    }
}
```

**ğŸ¯ é’ˆå¯¹ä¸åŒæœåŠ¡çš„é…ç½®**

```java
/**
 * ç”¨æˆ·æœåŠ¡ä¸“å±é…ç½®
 * @RibbonClient æŒ‡å®šæœåŠ¡åå’Œé…ç½®ç±»
 */
@Configuration
@RibbonClient(name = "user-service", configuration = UserServiceConfig.class)
public class UserServiceConfig {
    
    @Bean
    public IRule userServiceRule() {
        // ç”¨æˆ·æœåŠ¡ä½¿ç”¨å“åº”æ—¶é—´åŠ æƒ
        return new WeightedResponseTimeRule();
    }
}

/**
 * å•†å“æœåŠ¡ä¸“å±é…ç½®
 */
@Configuration
@RibbonClient(name = "product-service", configuration = ProductServiceConfig.class)
public class ProductServiceConfig {
    
    @Bean
    public IRule productServiceRule() {
        // å•†å“æœåŠ¡ä½¿ç”¨æœ€å°‘å¹¶å‘
        return new BestAvailableRule();
    }
}
```

### 3.4 åŠ¨æ€é…ç½®åˆ·æ–°


**ä½¿ç”¨Nacosé…ç½®ä¸­å¿ƒå®ç°åŠ¨æ€åˆ·æ–°**

```yml
# Nacosé…ç½®ä¸­å¿ƒ - load-balance-config.yml
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.WeightedResponseTimeRule

product-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule
```

```java
@Component
@RefreshScope  // ğŸ”‘ æ”¯æŒåŠ¨æ€åˆ·æ–°
public class LoadBalancerProperties {
    
    @Value("${user-service.ribbon.NFLoadBalancerRuleClassName}")
    private String userServiceRule;
    
    @Value("${product-service.ribbon.NFLoadBalancerRuleClassName}")
    private String productServiceRule;
    
    // getter/setter...
}
```

ğŸ’¡ **åŠ¨æ€é…ç½®çš„å¥½å¤„**ï¼š
- ä¸ç”¨é‡å¯æœåŠ¡å°±èƒ½ä¿®æ”¹ç­–ç•¥
- çº¿ä¸Šé—®é¢˜å¿«é€Ÿå“åº”
- ç°åº¦å‘å¸ƒæ—¶çµæ´»è°ƒæ•´

---

## 4. ğŸ¯ è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©


### 4.1 ç­–ç•¥è¯¦è§£å¯¹æ¯”


**ğŸ“Š æ ¸å¿ƒç­–ç•¥å¯¹æ¯”è¡¨**

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èæŒ‡æ•° |
|------|---------|------|------|---------|
| **è½®è¯¢ï¼ˆRoundRobinï¼‰** | æœåŠ¡å™¨æ€§èƒ½ç›¸åŒ | ç®€å•ã€å…¬å¹³ | ä¸è€ƒè™‘å®é™…è´Ÿè½½ | â­â­â­â­ |
| **éšæœºï¼ˆRandomï¼‰** | ç®€å•åœºæ™¯ | å®ç°ç®€å• | åˆ†å¸ƒä¸å‡ | â­â­â­ |
| **å“åº”æ—¶é—´åŠ æƒ** | æœåŠ¡å™¨æ€§èƒ½ä¸åŒ | è‡ªåŠ¨é€‚åº”æ€§èƒ½ | éœ€è¦ç»Ÿè®¡æ—¶é—´ | â­â­â­â­â­ |
| **æœ€å°‘å¹¶å‘** | é•¿è¿æ¥æœåŠ¡ | è´Ÿè½½çœŸå®å‡è¡¡ | è®¡ç®—å¼€é”€å¤§ | â­â­â­â­ |
| **å¯ç”¨æ€§è¿‡æ»¤** | é«˜å¯ç”¨è¦æ±‚ | è‡ªåŠ¨å‰”é™¤æ•…éšœ | åˆ¤æ–­æœºåˆ¶å¤æ‚ | â­â­â­â­ |

### 4.2 è½®è¯¢ç­–ç•¥ï¼ˆRoundRobinRuleï¼‰


**ğŸ”„ å·¥ä½œåŸç†**

```
æœåŠ¡å™¨åˆ—è¡¨ï¼š[Server1, Server2, Server3]

è¯·æ±‚1 â†’ Server1
è¯·æ±‚2 â†’ Server2  
è¯·æ±‚3 â†’ Server3
è¯·æ±‚4 â†’ Server1  â† å¾ªç¯å¼€å§‹
è¯·æ±‚5 â†’ Server2
...
```

**ğŸ“ é…ç½®æ–¹å¼**

```yml
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule
```

**âœ… é€‚ç”¨åœºæ™¯**
- æ‰€æœ‰æœåŠ¡å™¨ç¡¬ä»¶é…ç½®ç›¸åŒ
- å¤„ç†è¯·æ±‚çš„æ—¶é—´å·®ä¸å¤š
- å¼€å‘ã€æµ‹è¯•ç¯å¢ƒ

### 4.3 å“åº”æ—¶é—´åŠ æƒç­–ç•¥ï¼ˆWeightedResponseTimeRuleï¼‰


**âš–ï¸ å·¥ä½œåŸç†**

```
æœåŠ¡å™¨å“åº”æ—¶é—´ç»Ÿè®¡ï¼š
Server1: å¹³å‡ 50ms  â†’ æƒé‡é«˜ â†’ åˆ†é…æ›´å¤šè¯·æ±‚
Server2: å¹³å‡ 200ms â†’ æƒé‡ä¸­ â†’ åˆ†é…ä¸­ç­‰è¯·æ±‚
Server3: å¹³å‡ 500ms â†’ æƒé‡ä½ â†’ åˆ†é…è¾ƒå°‘è¯·æ±‚

æƒé‡è®¡ç®—ï¼š
æƒé‡ = æ€»å“åº”æ—¶é—´ - è¯¥æœåŠ¡å™¨å“åº”æ—¶é—´
```

**ğŸ“ é…ç½®æ–¹å¼**

```yml
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.WeightedResponseTimeRule
```

**âœ… é€‚ç”¨åœºæ™¯**
- æœåŠ¡å™¨ç¡¬ä»¶é…ç½®ä¸åŒ
- å¸Œæœ›è‡ªåŠ¨é€‚åº”æœåŠ¡å™¨æ€§èƒ½
- ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
- å¯åŠ¨åˆæœŸä¼šä½¿ç”¨è½®è¯¢ï¼Œç­‰æ”¶é›†åˆ°å“åº”æ—¶é—´æ•°æ®åè‡ªåŠ¨åˆ‡æ¢
- éœ€è¦ä¸€å®šæ—¶é—´çš„é¢„çƒ­æœŸï¼ˆé€šå¸¸30ç§’ï¼‰

### 4.4 æœ€å°‘å¹¶å‘ç­–ç•¥ï¼ˆBestAvailableRuleï¼‰


**ğŸ“‰ å·¥ä½œåŸç†**

```
å®æ—¶å¹¶å‘ç»Ÿè®¡ï¼š
Server1: å½“å‰5ä¸ªè¯·æ±‚å¤„ç†ä¸­
Server2: å½“å‰2ä¸ªè¯·æ±‚å¤„ç†ä¸­  â† é€‰æ‹©è¿™ä¸ªï¼
Server3: å½“å‰8ä¸ªè¯·æ±‚å¤„ç†ä¸­

é€‰æ‹©é€»è¾‘ï¼š
æ‰¾åˆ°å½“å‰å¹¶å‘æ•°æœ€å°‘çš„æœåŠ¡å™¨
```

**ğŸ“ é…ç½®æ–¹å¼**

```yml
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.BestAvailableRule
```

**âœ… é€‚ç”¨åœºæ™¯**
- è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§çš„æœåŠ¡
- é•¿è¿æ¥æœåŠ¡ï¼ˆWebSocketç­‰ï¼‰
- éœ€è¦ç²¾ç¡®è´Ÿè½½å‡è¡¡çš„åœºæ™¯

### 4.5 å®æˆ˜ç­–ç•¥é€‰æ‹©æŒ‡å—


**ğŸ¯ åœºæ™¯åŒ–é€‰æ‹©å»ºè®®**

```
åœºæ™¯1ï¼šç”µå•†æŸ¥è¯¢æœåŠ¡
æœåŠ¡å™¨é…ç½®ç›¸åŒ + æŸ¥è¯¢è€—æ—¶ç¨³å®š
â†’ æ¨èï¼šè½®è¯¢ç­–ç•¥ï¼ˆRoundRobinRuleï¼‰

åœºæ™¯2ï¼šæ–‡ä»¶ä¸Šä¼ æœåŠ¡
æœåŠ¡å™¨æ€§èƒ½ä¸åŒ + å¤„ç†æ—¶é—´é•¿çŸ­ä¸ä¸€
â†’ æ¨èï¼šå“åº”æ—¶é—´åŠ æƒï¼ˆWeightedResponseTimeRuleï¼‰

åœºæ™¯3ï¼šå®æ—¶èŠå¤©æœåŠ¡
é•¿è¿æ¥ + å¹¶å‘æ•°å·®å¼‚å¤§
â†’ æ¨èï¼šæœ€å°‘å¹¶å‘ï¼ˆBestAvailableRuleï¼‰

åœºæ™¯4ï¼šæ”¯ä»˜æœåŠ¡
é«˜å¯ç”¨è¦æ±‚ + éœ€è¦æ•…éšœè‡ªåŠ¨å‰”é™¤
â†’ æ¨èï¼šå¯ç”¨æ€§è¿‡æ»¤ï¼ˆAvailabilityFilteringRuleï¼‰
```

**ğŸ”§ ç»„åˆç­–ç•¥é…ç½®**

```java
@Configuration
public class CustomLoadBalancerConfig {
    
    /**
     * è‡ªå®šä¹‰ç»„åˆç­–ç•¥
     * å…ˆè¿‡æ»¤æ•…éšœèŠ‚ç‚¹ï¼Œå†ç”¨å“åº”æ—¶é—´åŠ æƒ
     */
    @Bean
    public IRule customRule() {
        // åˆ›å»ºå“åº”æ—¶é—´åŠ æƒè§„åˆ™
        WeightedResponseTimeRule rule = new WeightedResponseTimeRule();
        
        // è®¾ç½®æœåŠ¡å™¨è¿‡æ»¤å™¨
        AvailabilityPredicate predicate = new AvailabilityPredicate(rule, null);
        
        return rule;
    }
}
```

---

## 5. âš¡ æ€§èƒ½è°ƒä¼˜æŠ€å·§


### 5.1 è¿æ¥æ± ä¼˜åŒ–


**ğŸ”Œ ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± **

```
æ²¡æœ‰è¿æ¥æ± ï¼š
æ¯æ¬¡è¯·æ±‚ â†’ åˆ›å»ºè¿æ¥ â†’ å‘é€æ•°æ® â†’ å…³é—­è¿æ¥
         â†‘ è€—æ—¶ï¼      â†‘ è€—æ—¶ï¼

ä½¿ç”¨è¿æ¥æ± ï¼š
è¿æ¥1 â†’ å¤ç”¨ â†’ å¤ç”¨ â†’ å¤ç”¨
è¿æ¥2 â†’ å¤ç”¨ â†’ å¤ç”¨ â†’ å¤ç”¨
è¿æ¥3 â†’ å¤ç”¨ â†’ å¤ç”¨ â†’ å¤ç”¨
```

**Apache HttpClientè¿æ¥æ± é…ç½®**

```java
@Configuration
public class HttpClientConfig {
    
    @Bean
    public HttpClient httpClient() {
        // è¿æ¥æ± ç®¡ç†å™¨
        PoolingHttpClientConnectionManager manager = 
            new PoolingHttpClientConnectionManager();
        
        // æœ€å¤§è¿æ¥æ•°
        manager.setMaxTotal(200);
        
        // æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°
        manager.setDefaultMaxPerRoute(50);
        
        // åˆ›å»ºHttpClient
        return HttpClients.custom()
            .setConnectionManager(manager)
            .setConnectionTimeToLive(30, TimeUnit.SECONDS)  // è¿æ¥å­˜æ´»æ—¶é—´
            .build();
    }
    
    @Bean
    @LoadBalanced
    public RestTemplate restTemplate(HttpClient httpClient) {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        
        factory.setConnectTimeout(3000);  // è¿æ¥è¶…æ—¶
        factory.setReadTimeout(5000);     // è¯»è¶…æ—¶
        
        return new RestTemplate(factory);
    }
}
```

ğŸ’¡ **å‚æ•°è°ƒä¼˜å»ºè®®**ï¼š
- `MaxTotal`ï¼šæ€»è¿æ¥æ•°ï¼Œè®¾ç½®ä¸º QPS Ã— å¹³å‡å“åº”æ—¶é—´(ç§’) Ã— 2
- `MaxPerRoute`ï¼šå•è·¯ç”±è¿æ¥æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸º MaxTotal çš„ 1/4 åˆ° 1/2
- `TimeToLive`ï¼šè¿æ¥å­˜æ´»æ—¶é—´ï¼Œé˜²æ­¢è¿æ¥è¿‡æœŸï¼Œå»ºè®® 30-60ç§’

### 5.2 è¶…æ—¶æ—¶é—´è°ƒä¼˜


**â±ï¸ è¶…æ—¶æ—¶é—´è®¾ç½®ç­–ç•¥**

```yml
feign:
  client:
    config:
      default:
        # è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æœ€å¤§æ—¶é—´
        connectTimeout: 2000  # 2ç§’ï¼Œç½‘ç»œå¥½çš„ç¯å¢ƒ
        
        # è¯»å–è¶…æ—¶ï¼šç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´
        readTimeout: 5000     # 5ç§’ï¼Œæ ¹æ®ä¸šåŠ¡è°ƒæ•´

# å…·ä½“ä¸šåŠ¡åœºæ™¯è°ƒä¼˜
user-service:  # æŸ¥è¯¢ç±»æœåŠ¡
  ribbon:
    ConnectTimeout: 1000   # 1ç§’
    ReadTimeout: 3000      # 3ç§’

order-service:  # å¤æ‚ä¸šåŠ¡æœåŠ¡
  ribbon:
    ConnectTimeout: 2000   # 2ç§’
    ReadTimeout: 10000     # 10ç§’
```

**ğŸ“Š è¶…æ—¶æ—¶é—´è®¾ç½®å‚è€ƒ**

| æœåŠ¡ç±»å‹ | è¿æ¥è¶…æ—¶ | è¯»å–è¶…æ—¶ | è¯´æ˜ |
|---------|---------|---------|------|
| ç¼“å­˜æŸ¥è¯¢ | 500ms | 1s | è¦æ±‚å¿«é€Ÿå“åº” |
| æ•°æ®åº“æŸ¥è¯¢ | 1s | 3s | ä¸€èˆ¬æŸ¥è¯¢ |
| å¤æ‚è®¡ç®— | 2s | 10s | è€—æ—¶æ“ä½œ |
| æ–‡ä»¶å¤„ç† | 3s | 30s | å¤§æ–‡ä»¶ä¼ è¾“ |

### 5.3 çº¿ç¨‹æ± éš”ç¦»


**ğŸ›¡ï¸ ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± éš”ç¦»**

```
æ²¡æœ‰éš”ç¦»çš„é—®é¢˜ï¼š
ç”¨æˆ·æœåŠ¡æ…¢äº† â†’ å æ»¡æ‰€æœ‰çº¿ç¨‹
              â†“
è®¢å•æœåŠ¡æ­£å¸¸ â†’ ä½†æ²¡æœ‰çº¿ç¨‹å¯ç”¨ â†’ æ•´ä¸ªç³»ç»Ÿéƒ½å¡ä½äº†

çº¿ç¨‹æ± éš”ç¦»ï¼š
ç”¨æˆ·æœåŠ¡ â†’ ä¸“ç”¨çº¿ç¨‹æ± ï¼ˆ10ä¸ªï¼‰â†’ æœ€å¤šå½±å“è¿™10ä¸ª
è®¢å•æœåŠ¡ â†’ ä¸“ç”¨çº¿ç¨‹æ± ï¼ˆ10ä¸ªï¼‰â†’ ä¸å—å½±å“
å•†å“æœåŠ¡ â†’ ä¸“ç”¨çº¿ç¨‹æ± ï¼ˆ10ä¸ªï¼‰â†’ ä¸å—å½±å“
```

**é…ç½®Hystrixçº¿ç¨‹æ± ï¼ˆå¦‚ä½¿ç”¨ï¼‰**

```yml
hystrix:
  threadpool:
    user-service:  # ç”¨æˆ·æœåŠ¡çº¿ç¨‹æ± 
      coreSize: 10              # æ ¸å¿ƒçº¿ç¨‹æ•°
      maximumSize: 20           # æœ€å¤§çº¿ç¨‹æ•°
      maxQueueSize: 50          # é˜Ÿåˆ—å¤§å°
      keepAliveTimeMinutes: 1   # ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    
    product-service:  # å•†å“æœåŠ¡çº¿ç¨‹æ± 
      coreSize: 20
      maximumSize: 50
      maxQueueSize: 100
```

ğŸ’¡ **çº¿ç¨‹æ•°è®¡ç®—å…¬å¼**ï¼š
```
æ ¸å¿ƒçº¿ç¨‹æ•° = QPS Ã— å¹³å‡å“åº”æ—¶é—´(ç§’) Ã— (1 + å¤‡ç”¨ç³»æ•°)
å¤‡ç”¨ç³»æ•°é€šå¸¸å– 0.5-1.0
```

### 5.4 ç¼“å­˜ä¼˜åŒ–


**ğŸ“¦ æœåŠ¡åˆ—è¡¨ç¼“å­˜**

```java
@Configuration
public class LoadBalancerCacheConfig {
    
    @Bean
    public ServerListRefreshInterval refreshInterval() {
        // æœåŠ¡åˆ—è¡¨åˆ·æ–°é—´éš”ï¼š30ç§’
        return new ServerListRefreshInterval(30000);
    }
}
```

**æœ¬åœ°å“åº”ç¼“å­˜**

```java
@Service
public class UserService {
    
    // æœ¬åœ°ç¼“å­˜ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
    private LoadingCache<Long, User> userCache = CacheBuilder.newBuilder()
        .maximumSize(1000)                    // æœ€å¤š1000æ¡
        .expireAfterWrite(5, TimeUnit.MINUTES)  // 5åˆ†é’Ÿè¿‡æœŸ
        .build(new CacheLoader<Long, User>() {
            @Override
            public User load(Long userId) {
                return userClient.getUser(userId);  // å®é™…è¿œç¨‹è°ƒç”¨
            }
        });
    
    public User getUserInfo(Long userId) {
        try {
            return userCache.get(userId);  // ä¼˜å…ˆä»ç¼“å­˜è·å–
        } catch (Exception e) {
            return userClient.getUser(userId);  // é™çº§ç›´æ¥è°ƒç”¨
        }
    }
}
```

### 5.5 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**

```
è´Ÿè½½å‡è¡¡å±‚é¢ï¼š
â”œâ”€â”€ è¯·æ±‚åˆ†å¸ƒå‡åŒ€åº¦
â”œâ”€â”€ æœåŠ¡å™¨å“åº”æ—¶é—´
â”œâ”€â”€ å¤±è´¥é‡è¯•æ¬¡æ•°
â””â”€â”€ æœåŠ¡å®ä¾‹å¥åº·åº¦

è°ƒç”¨å±‚é¢ï¼š
â”œâ”€â”€ å¹³å‡å“åº”æ—¶é—´ï¼ˆRTï¼‰
â”œâ”€â”€ æ¯ç§’è¯·æ±‚æ•°ï¼ˆQPSï¼‰
â”œâ”€â”€ é”™è¯¯ç‡
â””â”€â”€ è¶…æ—¶ç‡
```

**ä½¿ç”¨Micrometerç›‘æ§**

```java
@Component
public class LoadBalancerMetrics {
    
    private final MeterRegistry registry;
    
    public LoadBalancerMetrics(MeterRegistry registry) {
        this.registry = registry;
    }
    
    /**
     * è®°å½•è´Ÿè½½å‡è¡¡è°ƒç”¨
     */
    public void recordRequest(String serviceName, String instance, long duration, boolean success) {
        Timer.builder("loadbalancer.request")
            .tag("service", serviceName)
            .tag("instance", instance)
            .tag("success", String.valueOf(success))
            .register(registry)
            .record(duration, TimeUnit.MILLISECONDS);
    }
}
```

---

## 6. ğŸ” æ•…éšœæ’æŸ¥æ–¹æ³•


### 6.1 å¸¸è§é—®é¢˜è¯Šæ–­


**âŒ é—®é¢˜1ï¼šæœåŠ¡è°ƒç”¨å¤±è´¥**

```
é”™è¯¯ä¿¡æ¯ï¼š
java.net.ConnectException: Connection refused

å¯èƒ½åŸå› ï¼š
1. æœåŠ¡æœªå¯åŠ¨æˆ–å·²å…³é—­
2. ç½‘ç»œä¸é€š
3. ç«¯å£å·é”™è¯¯
4. é˜²ç«å¢™æ‹¦æˆª
```

**ğŸ”§ æ’æŸ¥æ­¥éª¤**

```bash
# 1ï¸âƒ£ æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨
curl http://192.168.1.100:8080/actuator/health

# 2ï¸âƒ£ æ£€æŸ¥æ³¨å†Œä¸­å¿ƒæœåŠ¡åˆ—è¡¨
è®¿é—® Nacosæ§åˆ¶å° â†’ æœåŠ¡ç®¡ç† â†’ æŸ¥çœ‹user-serviceå®ä¾‹

# 3ï¸âƒ£ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 192.168.1.100
telnet 192.168.1.100 8080

# 4ï¸âƒ£ æŸ¥çœ‹æ—¥å¿—
tail -f logs/application.log | grep ERROR
```

**âŒ é—®é¢˜2ï¼šè´Ÿè½½ä¸å‡è¡¡**

```
ç°è±¡ï¼š
3å°æœåŠ¡å™¨ï¼šServer1æ”¶åˆ°90%è¯·æ±‚ï¼ŒServer2å’ŒServer3å¾ˆç©ºé—²

å¯èƒ½åŸå› ï¼š
1. æƒé‡é…ç½®ä¸å½“
2. æœåŠ¡å™¨æ—¶é’Ÿä¸åŒæ­¥
3. å“åº”æ—¶é—´å·®å¼‚å¤§ï¼ˆä½¿ç”¨å“åº”æ—¶é—´åŠ æƒç­–ç•¥æ—¶ï¼‰
```

**ğŸ”§ è§£å†³æ–¹æ¡ˆ**

```java
// å¼€å¯è¯·æ±‚æ—¥å¿—ï¼Œè§‚å¯Ÿåˆ†é…æƒ…å†µ
@Slf4j
@Component
public class LoadBalancerLogger {
    
    @Autowired
    private LoadBalancerClient loadBalancer;
    
    public void logServerInstance(String serviceName) {
        ServiceInstance instance = loadBalancer.choose(serviceName);
        log.info("é€‰ä¸­çš„æœåŠ¡å®ä¾‹: {}:{}", 
            instance.getHost(), instance.getPort());
    }
}
```

```yml
# åˆ‡æ¢ä¸ºè½®è¯¢ç­–ç•¥æµ‹è¯•
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RoundRobinRule
```

### 6.2 è¶…æ—¶é—®é¢˜æ’æŸ¥


**âŒ é—®é¢˜ï¼šè¯·æ±‚è¶…æ—¶**

```
é”™è¯¯ä¿¡æ¯ï¼š
java.net.SocketTimeoutException: Read timed out
```

**ğŸ” æ’æŸ¥æ€è·¯å›¾**

```
è¯·æ±‚è¶…æ—¶
    â†“
æ£€æŸ¥è¶…æ—¶é…ç½®æ˜¯å¦åˆç†ï¼Ÿ
    â”œâ”€â”€ å¤ªçŸ­ â†’ è°ƒå¤§è¶…æ—¶æ—¶é—´
    â””â”€â”€ åˆç† â†’ ç»§ç»­æ’æŸ¥
         â†“
    æœåŠ¡ç«¯å“åº”æ…¢ï¼Ÿ
    â”œâ”€â”€ æ•°æ®åº“æ…¢æŸ¥è¯¢ â†’ ä¼˜åŒ–SQL
    â”œâ”€â”€ æ¥å£é€»è¾‘å¤æ‚ â†’ ä¼˜åŒ–ä»£ç 
    â””â”€â”€ èµ„æºä¸è¶³ â†’ æ‰©å®¹æœåŠ¡å™¨
         â†“
    ç½‘ç»œé—®é¢˜ï¼Ÿ
    â”œâ”€â”€ å¸¦å®½ä¸è¶³ â†’ å‡çº§å¸¦å®½
    â””â”€â”€ ç½‘ç»œå»¶è¿Ÿé«˜ â†’ æ£€æŸ¥ç½‘ç»œè®¾å¤‡
```

**ğŸ“Š è¶…æ—¶è¯Šæ–­é…ç½®**

```yml
# å¼€å¯è¯¦ç»†æ—¥å¿—
logging:
  level:
    org.springframework.cloud.loadbalancer: DEBUG
    com.netflix.loadbalancer: DEBUG

# ä¸´æ—¶å¢åŠ è¶…æ—¶æ—¶é—´æµ‹è¯•
feign:
  client:
    config:
      user-service:
        connectTimeout: 10000  # ä¸´æ—¶è°ƒå¤§
        readTimeout: 30000     # ä¸´æ—¶è°ƒå¤§
```

### 6.3 æœåŠ¡å®ä¾‹å¼‚å¸¸æ’æŸ¥


**âŒ é—®é¢˜ï¼šæŸä¸ªå®ä¾‹æ€»æ˜¯å¤±è´¥**

```
æ—¥å¿—æ˜¾ç¤ºï¼š
Server1: 200 OK
Server2: 500 Internal Server Error  â† æœ‰é—®é¢˜
Server3: 200 OK
```

**ğŸ”§ å¿«é€Ÿéš”ç¦»æ•…éšœå®ä¾‹**

```yml
# ä¸´æ—¶ç¦ç”¨ç‰¹å®šå®ä¾‹
user-service:
  ribbon:
    listOfServers: 192.168.1.100:8080,192.168.1.102:8080  # æ‰‹åŠ¨æŒ‡å®šå¯ç”¨å®ä¾‹
    # æˆ–è€…é€šè¿‡Nacosæ§åˆ¶å°ä¸‹çº¿æ•…éšœå®ä¾‹
```

**å¥åº·æ£€æŸ¥é…ç½®**

```yml
# å¼€å¯æœåŠ¡å®ä¾‹å¥åº·æ£€æŸ¥
user-service:
  ribbon:
    # Pingç­–ç•¥ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡å¯ç”¨æ€§
    NFLoadBalancerPingClassName: com.netflix.loadbalancer.PingUrl
    # Pingé—´éš”
    ServerListRefreshInterval: 5000  # 5ç§’æ£€æŸ¥ä¸€æ¬¡
```

### 6.4 è°ƒè¯•å·¥å…·ä½¿ç”¨


**ğŸ› ï¸ å¼€å¯Spring Boot Actuatorç›‘æ§**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

```yml
management:
  endpoints:
    web:
      exposure:
        include: '*'  # å¼€æ”¾æ‰€æœ‰ç«¯ç‚¹
  endpoint:
    health:
      show-details: always
```

**ğŸ“ é‡è¦ç›‘æ§ç«¯ç‚¹**

| ç«¯ç‚¹ | åœ°å€ | ä½œç”¨ |
|------|------|------|
| å¥åº·æ£€æŸ¥ | `/actuator/health` | æŸ¥çœ‹æœåŠ¡å¥åº·çŠ¶æ€ |
| ç¯å¢ƒä¿¡æ¯ | `/actuator/env` | æŸ¥çœ‹é…ç½®ä¿¡æ¯ |
| æ—¥å¿—çº§åˆ« | `/actuator/loggers` | åŠ¨æ€è°ƒæ•´æ—¥å¿—çº§åˆ« |
| çº¿ç¨‹ä¿¡æ¯ | `/actuator/threaddump` | æŸ¥çœ‹çº¿ç¨‹å †æ ˆ |

**ğŸ” ä½¿ç”¨Arthasè¯Šæ–­**

```bash
# 1. ä¸‹è½½å¹¶å¯åŠ¨Arthas
curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar

# 2. ç›‘æ§æ–¹æ³•è°ƒç”¨
watch com.example.service.UserService getUser "{params,returnObj,throwExp}" -x 2

# 3. æŸ¥çœ‹æ–¹æ³•è€—æ—¶
trace com.example.service.UserService getUser

# 4. å®æ—¶æŸ¥çœ‹JVMä¿¡æ¯
dashboard
```

### 6.5 é—®é¢˜å®šä½æµç¨‹


**ğŸ“‹ æ ‡å‡†æ’æŸ¥æµç¨‹**

```
1ï¸âƒ£ ç¡®è®¤é—®é¢˜èŒƒå›´
   â”œâ”€â”€ æ‰€æœ‰å®ä¾‹éƒ½æœ‰é—®é¢˜ï¼Ÿâ†’ æ£€æŸ¥é…ç½®
   â”œâ”€â”€ ä¸ªåˆ«å®ä¾‹æœ‰é—®é¢˜ï¼Ÿâ†’ æ£€æŸ¥å®ä¾‹
   â””â”€â”€ é—´æ­‡æ€§é—®é¢˜ï¼Ÿâ†’ æ£€æŸ¥ç½‘ç»œ

2ï¸âƒ£ æ”¶é›†æ—¥å¿—ä¿¡æ¯
   â”œâ”€â”€ è°ƒç”¨æ–¹æ—¥å¿—
   â”œâ”€â”€ è¢«è°ƒç”¨æ–¹æ—¥å¿—
   â””â”€â”€ æ³¨å†Œä¸­å¿ƒæ—¥å¿—

3ï¸âƒ£ åˆ†æè°ƒç”¨é“¾è·¯
   â”œâ”€â”€ ä½¿ç”¨Sleuthè¿½è¸ª
   â””â”€â”€ æŸ¥çœ‹è°ƒç”¨è€—æ—¶

4ï¸âƒ£ å®šä½é—®é¢˜ç‚¹
   â”œâ”€â”€ é…ç½®é—®é¢˜ â†’ ä¿®æ”¹é…ç½®
   â”œâ”€â”€ ä»£ç é—®é¢˜ â†’ ä¿®å¤ä»£ç 
   â””â”€â”€ ç¯å¢ƒé—®é¢˜ â†’ è°ƒæ•´ç¯å¢ƒ

5ï¸âƒ£ éªŒè¯è§£å†³æ–¹æ¡ˆ
   â””â”€â”€ ç°åº¦å‘å¸ƒéªŒè¯
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ RestTemplateè´Ÿè½½å‡è¡¡
   â””â”€â”€ @LoadBalancedæ³¨è§£ + æœåŠ¡åè°ƒç”¨ = è‡ªåŠ¨è´Ÿè½½å‡è¡¡

ğŸ”¸ OpenFeignè´Ÿè½½å‡è¡¡
   â””â”€â”€ @FeignClient + æ¥å£å®šä¹‰ = å£°æ˜å¼è°ƒç”¨ + å†…ç½®è´Ÿè½½å‡è¡¡

ğŸ”¸ å¤šç¯å¢ƒé…ç½®
   â””â”€â”€ ä¸åŒç¯å¢ƒä¸åŒç­–ç•¥ = çµæ´»é€‚é…ä¸šåŠ¡éœ€æ±‚

ğŸ”¸ ç­–ç•¥é€‰æ‹©
   â””â”€â”€ æ ¹æ®å®é™…åœºæ™¯é€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

ğŸ”¸ æ€§èƒ½è°ƒä¼˜
   â””â”€â”€ è¿æ¥æ±  + è¶…æ—¶é…ç½® + çº¿ç¨‹éš”ç¦» = é«˜æ€§èƒ½ç¨³å®šç³»ç»Ÿ

ğŸ”¸ æ•…éšœæ’æŸ¥
   â””â”€â”€ æ—¥å¿— + ç›‘æ§ + å·¥å…· = å¿«é€Ÿå®šä½é—®é¢˜
```

### 7.2 å¿«é€Ÿé…ç½®æ¸…å•


**âš¡ RestTemplateé…ç½®ä¸‰æ­¥èµ°**

```
1. æ·»åŠ ä¾èµ– â†’ spring-cloud-starter-loadbalancer
2. åˆ›å»ºBean â†’ @Bean @LoadBalanced RestTemplate
3. æœåŠ¡è°ƒç”¨ â†’ restTemplate.getForObject("http://æœåŠ¡å/xxx")
```

**âš¡ OpenFeigné…ç½®ä¸‰æ­¥èµ°**

```
1. æ·»åŠ ä¾èµ– â†’ spring-cloud-starter-openfeign
2. å¯ç”¨åŠŸèƒ½ â†’ @EnableFeignClients
3. å®šä¹‰æ¥å£ â†’ @FeignClient("æœåŠ¡å") + æ¥å£æ–¹æ³•
```

### 7.3 å¸¸è§ç­–ç•¥é€‰æ‹©æŒ‡å—


| ä½ çš„åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|---------|---------|------|
| æœåŠ¡å™¨æ€§èƒ½ç›¸åŒ | è½®è¯¢ | ç®€å•å…¬å¹³ |
| æœåŠ¡å™¨æ€§èƒ½ä¸åŒ | å“åº”æ—¶é—´åŠ æƒ | è‡ªåŠ¨é€‚åº” |
| é•¿è¿æ¥æœåŠ¡ | æœ€å°‘å¹¶å‘ | çœŸå®è´Ÿè½½ |
| é«˜å¯ç”¨è¦æ±‚ | å¯ç”¨æ€§è¿‡æ»¤ | æ•…éšœéš”ç¦» |

### 7.4 å…³é”®å‚æ•°å‚è€ƒå€¼


```yml
# æ ‡å‡†é…ç½®å‚è€ƒ
feign:
  client:
    config:
      default:
        connectTimeout: 2000    # è¿æ¥è¶…æ—¶2ç§’
        readTimeout: 5000       # è¯»å–è¶…æ—¶5ç§’

# è¿æ¥æ± é…ç½®
MaxTotal: 200                   # æ€»è¿æ¥æ•°
MaxPerRoute: 50                 # å•è·¯ç”±è¿æ¥æ•°

# é‡è¯•é…ç½®
MaxAutoRetries: 1               # åŒå®ä¾‹é‡è¯•1æ¬¡
MaxAutoRetriesNextServer: 2     # å…¶ä»–å®ä¾‹é‡è¯•2æ¬¡
```

### 7.5 å­¦ä¹ å»ºè®®


**ğŸ¯ è¿›é˜¶è·¯å¾„**
```
å…¥é—¨ â†’ RestTemplateåŸºç¡€ä½¿ç”¨
     â†“
è¿›é˜¶ â†’ OpenFeignå£°æ˜å¼è°ƒç”¨
     â†“
å®æˆ˜ â†’ å¤šç¯å¢ƒé…ç½®ç®¡ç†
     â†“
ä¼˜åŒ– â†’ æ€§èƒ½è°ƒä¼˜æŠ€å·§
     â†“
æ·±å…¥ â†’ æºç åŸç†åˆ†æ
```

**ğŸ’¡ å®è·µå»ºè®®**
- ä»è½®è¯¢ç­–ç•¥å¼€å§‹ï¼Œé€æ­¥å°è¯•å…¶ä»–ç­–ç•¥
- åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯é…ç½®æ•ˆæœ
- å…³æ³¨çº¿ä¸Šç›‘æ§æŒ‡æ ‡ï¼ŒåŠæ—¶è°ƒä¼˜
- å»ºç«‹æ•…éšœæ’æŸ¥çŸ¥è¯†åº“

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è´Ÿè½½å‡è¡¡å¾ˆé‡è¦ï¼ŒæœåŠ¡è°ƒç”¨ç¦»ä¸äº†
RestTemplateåŠ æ³¨è§£ï¼ŒFeignæ¥å£æ›´ä¼˜é›…
ç­–ç•¥é€‰æ‹©çœ‹åœºæ™¯ï¼Œæ€§èƒ½è°ƒä¼˜é ç›‘æ§
è¶…æ—¶é‡è¯•è¦é…å¥½ï¼Œæ•…éšœæ’æŸ¥æœ‰å¦™æ‹›
```