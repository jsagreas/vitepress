---
title: 4ã€æœåŠ¡è°ƒç”¨å®‰å…¨è®¤è¯
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡è°ƒç”¨å®‰å…¨è®¤è¯æ¦‚è¿°](#1-æœåŠ¡è°ƒç”¨å®‰å…¨è®¤è¯æ¦‚è¿°)
2. [JWT Tokenä¼ é€’æœºåˆ¶](#2-JWT-Tokenä¼ é€’æœºåˆ¶)
3. [OAuth2è®¤è¯é›†æˆ](#3-OAuth2è®¤è¯é›†æˆ)
4. [è¯·æ±‚ç­¾åéªŒè¯](#4-è¯·æ±‚ç­¾åéªŒè¯)
5. [SSLåŒå‘è®¤è¯](#5-SSLåŒå‘è®¤è¯)
6. [APIå¯†é’¥ç®¡ç†](#6-APIå¯†é’¥ç®¡ç†)
7. [æƒé™æ§åˆ¶æœºåˆ¶](#7-æƒé™æ§åˆ¶æœºåˆ¶)
8. [å®‰å…¨å®¡è®¡æ—¥å¿—](#8-å®‰å…¨å®¡è®¡æ—¥å¿—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æœåŠ¡è°ƒç”¨å®‰å…¨è®¤è¯æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦å®‰å…¨è®¤è¯


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
æƒ³è±¡ä¸€ä¸ªå¤§å‹è´­ç‰©ä¸­å¿ƒï¼Œé‡Œé¢æœ‰å¾ˆå¤šå•†é“ºï¼ˆå¾®æœåŠ¡ï¼‰ã€‚ä½ ä¸èƒ½éšä¾¿è¿›å…¥ä»»ä½•ä¸€ä¸ªå•†é“ºçš„åå°ä»“åº“ï¼Œéœ€è¦å…ˆè¯æ˜èº«ä»½ï¼Œè€Œä¸”ä¸åŒèº«ä»½æœ‰ä¸åŒçš„æƒé™ã€‚å¾®æœåŠ¡çš„å®‰å…¨è®¤è¯å°±æ˜¯è¿™ä¸ªé“ç†ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
ğŸ¢ è´­ç‰©ä¸­å¿ƒå®‰å…¨ä½“ç³»ï¼š
   é¡¾å®¢å¡ â†’ åªèƒ½é€›å•†åº—
   å‘˜å·¥å¡ â†’ å¯ä»¥è¿›å‘˜å·¥åŒº
   ç»ç†å¡ â†’ å¯ä»¥è¿›ç®¡ç†åŒº
   ä¿å®‰å¡ â†’ å¯ä»¥å·¡æŸ¥å…¨åœº

ğŸ”„ æ˜ å°„åˆ°å¾®æœåŠ¡ï¼š
   ç”¨æˆ·Token â†’ è°ƒç”¨å‰å°æœåŠ¡
   æœåŠ¡Token â†’ æœåŠ¡é—´äº’ç›¸è°ƒç”¨
   ç®¡ç†å‘˜Token â†’ è°ƒç”¨ç®¡ç†æ¥å£
   ç³»ç»ŸToken â†’ è°ƒç”¨æ‰€æœ‰å†…éƒ¨æœåŠ¡
```

### 1.2 å¾®æœåŠ¡å®‰å…¨çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ¯ ä¼ ç»Ÿå•ä½“åº”ç”¨ vs å¾®æœåŠ¡æ¶æ„**ï¼š

```
å•ä½“åº”ç”¨çš„ç®€å•ä¸–ç•Œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•      â”‚
â”‚       â†“         â”‚
â”‚   SessionéªŒè¯   â”‚ â† æ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ä¸€ä¸ªåº”ç”¨é‡Œ
â”‚       â†“         â”‚
â”‚   ä¸šåŠ¡å¤„ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡çš„å¤æ‚ä¸–ç•Œï¼š
ç”¨æˆ· â†’ ç½‘å…³ â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C
       â†“       â†“       â†“       â†“
     è®¤è¯?   è¦è®¤è¯?  è¦è®¤è¯?  è¦è®¤è¯?
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- â“ **èº«ä»½ä¼ é€’**ï¼šç”¨æˆ·èº«ä»½å¦‚ä½•åœ¨å¤šä¸ªæœåŠ¡é—´ä¼ é€’ï¼Ÿ
- â“ **æƒé™æ§åˆ¶**ï¼šæ¯ä¸ªæœåŠ¡å¦‚ä½•çŸ¥é“è°ƒç”¨è€…æœ‰ä»€ä¹ˆæƒé™ï¼Ÿ
- â“ **å®‰å…¨æ€§**ï¼šå¦‚ä½•é˜²æ­¢Tokenè¢«çªƒå–æˆ–ç¯¡æ”¹ï¼Ÿ
- â“ **æ€§èƒ½**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½éªŒè¯ä¼šä¸ä¼šå¤ªæ…¢ï¼Ÿ

### 1.3 å¸¸ç”¨å®‰å…¨è®¤è¯æ–¹æ¡ˆå¯¹æ¯”


| è®¤è¯æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨çº§åˆ«** | **å®ç°å¤æ‚åº¦** | **æ€§èƒ½å¼€é”€** |
|---------|-------------|-------------|---------------|-------------|
| **JWT Token** | `æœåŠ¡é—´è°ƒç”¨` | â­â­â­â­ | â­â­â­ | â­â­ |
| **OAuth2** | `ç¬¬ä¸‰æ–¹æˆæƒ` | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **APIå¯†é’¥** | `ç³»ç»Ÿçº§è°ƒç”¨` | â­â­â­ | â­â­ | â­ |
| **è¯·æ±‚ç­¾å** | `é‡è¦æ¥å£` | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| **SSLåŒå‘è®¤è¯** | `é‡‘èçº§å®‰å…¨` | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |

---

## 2. ğŸ« JWT Tokenä¼ é€’æœºåˆ¶


### 2.1 JWTæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼š
JWTå°±åƒä¸€å¼ "ç”µå­é€šè¡Œè¯"ï¼Œä¸Šé¢å†™ç€ä½ çš„èº«ä»½ä¿¡æ¯ã€æƒé™ã€æœ‰æ•ˆæœŸç­‰ï¼Œè€Œä¸”æœ‰é˜²ä¼ªæ ‡è®°ã€‚æ¯ä¸ªå¾®æœåŠ¡çœ‹åˆ°è¿™å¼ é€šè¡Œè¯ï¼Œå°±çŸ¥é“ä½ æ˜¯è°ã€èƒ½åšä»€ä¹ˆã€‚

```
JWTç»“æ„å°±åƒä¸€ä¸ªä¸‰æ˜æ²»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Header     â”‚ â† é¡¶å±‚é¢åŒ…ï¼šè¯´æ˜Tokenç±»å‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Payload    â”‚ â† ä¸­é—´å¤¹å¿ƒï¼šå­˜æ”¾ç”¨æˆ·ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Signature  â”‚ â† åº•å±‚é¢åŒ…ï¼šé˜²ä¼ªç­¾å
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…æ ·å­ï¼š
eyJhbGci...ï¼ˆHeaderï¼‰.eyJ1c2VyX2lk...ï¼ˆPayloadï¼‰.SflKxwRJ...ï¼ˆSignatureï¼‰
```

### 2.2 JWTçš„å·¥ä½œæµç¨‹


**ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹**ï¼š

```
æ­¥éª¤è§£æï¼š

ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·ç™»å½•
ç”¨æˆ·(æ‰‹æœº/ç”µè„‘) â†’ è®¤è¯æœåŠ¡
  å‘é€ï¼šç”¨æˆ·å + å¯†ç 
  è¿”å›ï¼šJWT Token

ç¬¬äºŒæ­¥ï¼šæºå¸¦Tokenè®¿é—®
ç”¨æˆ· â†’ ç½‘å…³ â†’ è®¢å•æœåŠ¡
  è¯·æ±‚å¤´ï¼šAuthorization: Bearer eyJhbGci...
  
ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡é—´ä¼ é€’  
è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡
  ä¼ é€’åŒä¸€ä¸ªTokenï¼ˆé€ä¼ ï¼‰
  
ç¬¬å››æ­¥ï¼šTokenéªŒè¯
æ¯ä¸ªæœåŠ¡æ¥æ”¶åˆ°Tokenï¼š
  1. è§£æToken
  2. éªŒè¯ç­¾åï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
  3. æ£€æŸ¥è¿‡æœŸæ—¶é—´
  4. æå–ç”¨æˆ·ä¿¡æ¯
  5. æ£€æŸ¥æƒé™
```

**ğŸ“‹ å®é™…ä»£ç ç¤ºä¾‹**ï¼š

```java
// JWTå·¥å…·ç±» - ç®€åŒ–ç‰ˆç†è§£
public class JwtUtil {
    private static final String SECRET = "your-secret-key";
    
    // ç”ŸæˆToken
    public static String createToken(Long userId, String username) {
        return Jwts.builder()
            .setSubject(username)              // ç”¨æˆ·å
            .claim("userId", userId)           // ç”¨æˆ·ID
            .setIssuedAt(new Date())           // ç­¾å‘æ—¶é—´
            .setExpiration(new Date(System.currentTimeMillis() + 3600000)) // 1å°æ—¶åè¿‡æœŸ
            .signWith(SignatureAlgorithm.HS256, SECRET)  // ç­¾å
            .compact();
    }
    
    // éªŒè¯å¹¶è§£æToken
    public static Claims parseToken(String token) {
        return Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
    }
}
```

### 2.3 JWTåœ¨å¾®æœåŠ¡ä¸­çš„ä¼ é€’


**ğŸ”„ Tokenä¼ é€’çš„ä¸‰ç§æ–¹å¼**ï¼š

**æ–¹å¼ä¸€ï¼šè¯·æ±‚å¤´ä¼ é€’ï¼ˆæœ€å¸¸ç”¨ï¼‰**
```java
// Feignå®¢æˆ·ç«¯è‡ªåŠ¨ä¼ é€’Token
@Component
public class FeignTokenInterceptor implements RequestInterceptor {
    @Override
    public void apply(RequestTemplate template) {
        // ä»å½“å‰è¯·æ±‚ä¸­è·å–Token
        String token = RequestContextHolder.getToken();
        if (token != null) {
            // æ·»åŠ åˆ°ä¸‹æ¸¸æœåŠ¡è¯·æ±‚å¤´
            template.header("Authorization", "Bearer " + token);
        }
    }
}
```

**æ–¹å¼äºŒï¼šç½‘å…³ç»Ÿä¸€å¤„ç†**
```
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³éªŒè¯Token â†’ æå–ç”¨æˆ·ä¿¡æ¯ â†’ æ”¾å…¥è¯·æ±‚å¤´
                              â†“
                    X-User-Id: 123
                    X-User-Name: zhangsan
                    X-User-Roles: admin,user
```

**æ–¹å¼ä¸‰ï¼šå­˜å…¥ThreadLocalï¼ˆçº¿ç¨‹çº§åˆ«ï¼‰**
```java
// å­˜å‚¨ç”¨æˆ·ä¸Šä¸‹æ–‡
public class UserContext {
    private static ThreadLocal<UserInfo> userInfoHolder = new ThreadLocal<>();
    
    public static void set(UserInfo userInfo) {
        userInfoHolder.set(userInfo);
    }
    
    public static UserInfo get() {
        return userInfoHolder.get();
    }
}
```

### 2.4 JWTä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ å…³é”®è¦ç‚¹**ï¼š

```
âœ… è¦åšçš„ï¼š
â€¢ Tokenè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸è¦å¤ªé•¿ï¼‰
â€¢ æ•æ„Ÿä¿¡æ¯ä¸è¦æ”¾åœ¨Payloadï¼ˆä¼šè¢«è§£ç çœ‹åˆ°ï¼‰
â€¢ ä½¿ç”¨HTTPSä¼ è¾“ï¼ˆé˜²æ­¢è¢«çªƒå–ï¼‰
â€¢ å®ç°Tokenåˆ·æ–°æœºåˆ¶ï¼ˆç”¨æˆ·ä½“éªŒå¥½ï¼‰

âŒ ä¸è¦åšçš„ï¼š
â€¢ ä¸è¦åœ¨Tokené‡Œå­˜å¯†ç 
â€¢ ä¸è¦è®©Tokenæ°¸ä¹…æœ‰æ•ˆ
â€¢ ä¸è¦ç”¨å¼±å¯†é’¥ç­¾å
â€¢ ä¸è¦ç›¸ä¿¡å®¢æˆ·ç«¯çš„Tokenï¼ˆè¦éªŒè¯ï¼‰
```

**ğŸ”§ å®ç”¨æŠ€å·§**ï¼š

```
Tokenåˆ·æ–°ç­–ç•¥ï¼š
çŸ­Token + é•¿RefreshToken

è®¿é—®Tokenï¼š1å°æ—¶æœ‰æ•ˆ
  â†“ å¿«è¿‡æœŸæ—¶
åˆ·æ–°Tokenï¼š30å¤©æœ‰æ•ˆ
  â†“ ç”¨å®ƒæ¢å–
æ–°çš„è®¿é—®Tokenï¼šåˆç»­1å°æ—¶

å¥½å¤„ï¼š
â€¢ å®‰å…¨ï¼šè®¿é—®Tokenç»å¸¸æ¢ï¼Œè¢«ç›—å½±å“å°
â€¢ ä½“éªŒï¼šç”¨æˆ·ä¸ç”¨é¢‘ç¹ç™»å½•
```

---

## 3. ğŸ”‘ OAuth2è®¤è¯é›†æˆ


### 3.1 OAuth2æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»åŒ–ç±»æ¯”**ï¼š
OAuth2å°±åƒ"ä»£å®¢æ³Šè½¦"æœåŠ¡ã€‚ä½ æŠŠè½¦é’¥åŒ™ï¼ˆæˆæƒï¼‰ç»™ä»£æ³Šå‘˜ï¼ˆç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰ï¼Œä½†è¿™ä¸ªé’¥åŒ™åªèƒ½åœè½¦ï¼Œä¸èƒ½å¼€èµ°è½¦ï¼ˆé™å®šæƒé™ï¼‰ï¼Œè€Œä¸”æœ‰æ—¶é—´é™åˆ¶ï¼ˆè¿‡æœŸæœºåˆ¶ï¼‰ã€‚

```
ç°å®åœºæ™¯ç†è§£ï¼š
ğŸ¨ é…’åº—é—¨ç¦å¡ï¼š
   å‰å°ç»™ä½ æˆ¿å¡ â†’ ä½ èƒ½è¿›è‡ªå·±æˆ¿é—´
   ä½ æˆæƒæœ‹å‹ â†’ ç»™ä»–ä¸´æ—¶æˆ¿å¡
   æˆ¿å¡æœ‰æœŸé™ â†’ é€€æˆ¿åè‡ªåŠ¨å¤±æ•ˆ

ğŸ”„ OAuth2æµç¨‹ï¼š
   ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹ â†’ ç¬¬ä¸‰æ–¹è·å–è®¿é—®ä»¤ç‰Œ
   ç”¨ä»¤ç‰Œè®¿é—®èµ„æº â†’ åªèƒ½è®¿é—®æˆæƒçš„æ•°æ®
   ä»¤ç‰Œä¼šè¿‡æœŸ â†’ éœ€è¦é‡æ–°æˆæƒ
```

### 3.2 OAuth2çš„å››ç§æˆæƒæ¨¡å¼


**ğŸ“Š æˆæƒæ¨¡å¼å¯¹æ¯”**ï¼š

| æ¨¡å¼ | **ä½¿ç”¨åœºæ™¯** | **å®‰å…¨æ€§** | **é€‚ç”¨å¯¹è±¡** |
|------|-------------|-----------|-------------|
| **æˆæƒç æ¨¡å¼** | `ç¬¬ä¸‰æ–¹ç½‘ç«™ç™»å½•` | â­â­â­â­â­ | `Webåº”ç”¨` |
| **ç®€åŒ–æ¨¡å¼** | `å•é¡µåº”ç”¨` | â­â­â­ | `å‰ç«¯åº”ç”¨` |
| **å¯†ç æ¨¡å¼** | `å¯ä¿¡ä»»åº”ç”¨` | â­â­â­â­ | `å®˜æ–¹APP` |
| **å®¢æˆ·ç«¯æ¨¡å¼** | `æœåŠ¡é—´è°ƒç”¨` | â­â­â­â­ | `åå°æœåŠ¡` |

**ğŸ”„ æˆæƒç æ¨¡å¼è¯¦è§£ï¼ˆæœ€å®‰å…¨ï¼Œæœ€å¸¸ç”¨ï¼‰**ï¼š

```
æ­¥éª¤åˆ†è§£ï¼š

æ­¥éª¤1ï¼šç”¨æˆ·è¯·æ±‚ç™»å½•
   ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•" â†’ è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢

æ­¥éª¤2ï¼šç”¨æˆ·åŒæ„æˆæƒ
   ç”¨æˆ·ç¡®è®¤ â†’ å¾®ä¿¡è¿”å›æˆæƒç ï¼ˆcodeï¼‰
   
æ­¥éª¤3ï¼šæ¢å–è®¿é—®ä»¤ç‰Œ
   ä½ çš„åå° + æˆæƒç  + å¯†é’¥ â†’ è¯·æ±‚å¾®ä¿¡
   å¾®ä¿¡éªŒè¯æˆåŠŸ â†’ è¿”å›è®¿é—®ä»¤ç‰Œï¼ˆaccess_tokenï¼‰
   
æ­¥éª¤4ï¼šè®¿é—®ç”¨æˆ·ä¿¡æ¯
   ç”¨è®¿é—®ä»¤ç‰Œ â†’ è·å–ç”¨æˆ·å¤´åƒã€æ˜µç§°ç­‰

å…³é”®ç‚¹ï¼š
â€¢ æˆæƒç åªç”¨ä¸€æ¬¡ï¼Œç”¨å®Œå°±åºŸ
â€¢ è®¿é—®ä»¤ç‰Œæœ‰è¿‡æœŸæ—¶é—´
â€¢ ç”¨æˆ·å¯†ç å§‹ç»ˆä¸æ³„éœ²ç»™ç¬¬ä¸‰æ–¹
```

### 3.3 å¾®æœåŠ¡ä¸­é›†æˆOAuth2


**ğŸ—ï¸ ç»Ÿä¸€è®¤è¯æ¶æ„**ï¼š

```
è®¤è¯ä¸­å¿ƒæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       OAuth2è®¤è¯ä¸­å¿ƒ             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ç”¨æˆ·ç®¡ç†  â”‚  â”‚å®¢æˆ·ç«¯ç®¡ç†â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Tokenç®¡ç† â”‚  â”‚æƒé™ç®¡ç†  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å„ä¸ªå¾®æœåŠ¡ï¼ˆéªŒè¯Tokenï¼‰
```

**ğŸ’» Spring Security OAuth2é…ç½®ç¤ºä¾‹**ï¼š

```java
// è®¤è¯æœåŠ¡å™¨é…ç½® - æ ¸å¿ƒéƒ¨åˆ†
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig extends AuthorizationServerConfigurerAdapter {
    
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory()
            .withClient("app-client")           // å®¢æˆ·ç«¯ID
            .secret("app-secret")               // å®¢æˆ·ç«¯å¯†é’¥
            .authorizedGrantTypes(
                "authorization_code",           // æˆæƒç æ¨¡å¼
                "refresh_token"                 // åˆ·æ–°ä»¤ç‰Œ
            )
            .scopes("read", "write")            // æƒé™èŒƒå›´
            .accessTokenValiditySeconds(3600);  // Tokenæœ‰æ•ˆæœŸ1å°æ—¶
    }
}

// èµ„æºæœåŠ¡å™¨é…ç½® - å„ä¸ªå¾®æœåŠ¡
@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
    
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
            .antMatchers("/api/**").authenticated()  // APIéœ€è¦è®¤è¯
            .anyRequest().permitAll();               // å…¶ä»–è¯·æ±‚æ”¾è¡Œ
    }
}
```

### 3.4 OAuth2å®æˆ˜åº”ç”¨


**ğŸ¯ åœºæ™¯ä¸€ï¼šç¬¬ä¸‰æ–¹ç™»å½•**
```
ç”¨æˆ·æ•…äº‹ï¼š
å°æ˜åœ¨ä½ çš„ç½‘ç«™ç‚¹å‡»"å¾®ä¿¡ç™»å½•"

å®ç°æ­¥éª¤ï¼š
1. è·³è½¬å¾®ä¿¡æˆæƒé¡µé¢
   URL: https://open.weixin.qq.com/connect/oauth2/authorize?
        appid=ä½ çš„åº”ç”¨ID&
        redirect_uri=å›è°ƒåœ°å€&
        scope=snsapi_userinfo

2. ç”¨æˆ·åŒæ„åè·³å›ä½ çš„ç½‘ç«™
   http://ä½ çš„ç½‘ç«™/callback?code=æˆæƒç 

3. åå°ç”¨æˆæƒç æ¢Token
   POST https://api.weixin.qq.com/sns/oauth2/access_token
   å‚æ•°ï¼šappidã€secretã€code

4. ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
   GET https://api.weixin.qq.com/sns/userinfo?access_token=xxx
   
5. åˆ›å»ºæœ¬åœ°ç”¨æˆ·ä¼šè¯
   ç”Ÿæˆè‡ªå·±ç³»ç»Ÿçš„JWT Token
```

**ğŸ¯ åœºæ™¯äºŒï¼šå¾®æœåŠ¡é—´æˆæƒ**
```
æœåŠ¡è°ƒç”¨é“¾ï¼š
è®¢å•æœåŠ¡ â†’ éœ€è¦è°ƒç”¨ â†’ åº“å­˜æœåŠ¡ï¼ˆå—ä¿æŠ¤ï¼‰

è§£å†³æ–¹æ¡ˆï¼ˆå®¢æˆ·ç«¯æ¨¡å¼ï¼‰ï¼š
1. è®¢å•æœåŠ¡å‘è®¤è¯ä¸­å¿ƒç”³è¯·Token
   POST /oauth/token
   å‚æ•°ï¼šgrant_type=client_credentials
        client_id=order-service
        client_secret=order-secret
        
2. è·å¾—Token
   {
     "access_token": "eyJhbGci...",
     "token_type": "bearer",
     "expires_in": 3600
   }
   
3. æºå¸¦Tokenè°ƒç”¨åº“å­˜æœåŠ¡
   GET http://stock-service/api/check
   Header: Authorization: Bearer eyJhbGci...
```

---

## 4. âœï¸ è¯·æ±‚ç­¾åéªŒè¯


### 4.1 ä»€ä¹ˆæ˜¯è¯·æ±‚ç­¾å


**é€šä¿—ç†è§£**ï¼š
è¯·æ±‚ç­¾åå°±åƒç»™ä¿¡ä»¶ç›–"èœ¡å°"ï¼Œç¡®ä¿ä¿¡åœ¨ä¼ é€’è¿‡ç¨‹ä¸­æ²¡è¢«äººæ‹†å¼€çœ‹è¿‡æˆ–ç¯¡æ”¹è¿‡ã€‚

```
ä¼ ç»Ÿè¯·æ±‚ï¼ˆè£¸å¥”çŠ¶æ€ï¼‰ï¼š
ç”¨æˆ· â†’ è¯·æ±‚(æ˜æ–‡) â†’ æœåŠ¡å™¨
      â†‘ å¯èƒ½è¢«æˆªè·ã€ç¯¡æ”¹

ç­¾åè¯·æ±‚ï¼ˆåŠ å¯†é˜²æŠ¤ï¼‰ï¼š
ç”¨æˆ· â†’ è¯·æ±‚ + ç­¾å â†’ æœåŠ¡å™¨
      â†“           â†“
   æ ¹æ®å‚æ•°      éªŒè¯ç­¾å
   ç”Ÿæˆç­¾å      â†“
               ä¸€è‡´ â†’ é€šè¿‡
               ä¸ä¸€è‡´ â†’ æ‹’ç»
```

### 4.2 ç­¾åéªŒè¯åŸç†


**ğŸ” ç­¾åç”Ÿæˆæµç¨‹**ï¼š

```
æ­¥éª¤è¯¦è§£ï¼š

æ­¥éª¤1ï¼šæ”¶é›†è¯·æ±‚å‚æ•°
   å‚æ•°ï¼šuserId=123, amount=100, timestamp=1632456789

æ­¥éª¤2ï¼šå‚æ•°æ’åº
   amount=100&timestamp=1632456789&userId=123
   
æ­¥éª¤3ï¼šæ‹¼æ¥å¯†é’¥
   amount=100&timestamp=1632456789&userId=123&key=secret123
   
æ­¥éª¤4ï¼šè®¡ç®—ç­¾å
   MD5/SHA256(æ‹¼æ¥åçš„å­—ç¬¦ä¸²) â†’ å¾—åˆ°ç­¾å
   sign=a1b2c3d4e5f6...
   
æ­¥éª¤5ï¼šå‘é€è¯·æ±‚
   åŸå‚æ•° + sign=a1b2c3d4e5f6...
   
æœåŠ¡å™¨éªŒè¯ï¼š
   ç”¨åŒæ ·çš„æ–¹æ³•è®¡ç®—ç­¾å â†’ å¯¹æ¯”å®¢æˆ·ç«¯ä¼ æ¥çš„ç­¾å
```

**ğŸ’» Javaå®ç°ç¤ºä¾‹**ï¼š

```java
public class SignatureUtil {
    
    // ç”Ÿæˆç­¾å
    public static String generateSign(Map<String, String> params, String secret) {
        // 1. å‚æ•°æ’åº
        TreeMap<String, String> sortedParams = new TreeMap<>(params);
        
        // 2. æ‹¼æ¥å‚æ•°
        StringBuilder sb = new StringBuilder();
        sortedParams.forEach((key, value) -> {
            sb.append(key).append("=").append(value).append("&");
        });
        sb.append("key=").append(secret);
        
        // 3. MD5åŠ å¯†
        return MD5(sb.toString());
    }
    
    // éªŒè¯ç­¾å
    public static boolean verifySign(Map<String, String> params, 
                                      String receivedSign, 
                                      String secret) {
        String calculatedSign = generateSign(params, secret);
        return calculatedSign.equals(receivedSign);
    }
}
```

### 4.3 é˜²é‡æ”¾æ”»å‡»


**â° æ—¶é—´æˆ³ + éšæœºæ•°æœºåˆ¶**ï¼š

```
é—®é¢˜ï¼šé»‘å®¢æˆªè·ä½ çš„è¯·æ±‚ï¼Œé‡å¤å‘é€æ€ä¹ˆåŠï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ¡ˆä¸€ï¼šæ—¶é—´æˆ³éªŒè¯
   è¯·æ±‚å‚æ•°åŠ ä¸Šï¼štimestamp=1632456789
   æœåŠ¡å™¨æ£€æŸ¥ï¼šå½“å‰æ—¶é—´ - timestamp < 5åˆ†é’Ÿï¼Ÿ
   è¿‡æœŸæ‹’ç»ï¼šè¶…è¿‡5åˆ†é’Ÿçš„è¯·æ±‚ä¸€å¾‹æ‹’ç»

æ–¹æ¡ˆäºŒï¼šéšæœºæ•°éªŒè¯  
   è¯·æ±‚å‚æ•°åŠ ä¸Šï¼šnonce=éšæœºå­—ç¬¦ä¸²
   æœåŠ¡å™¨è®°å½•ï¼šè¿™ä¸ªnonceæ˜¯å¦ç”¨è¿‡ï¼Ÿ
   é‡å¤æ‹’ç»ï¼šç”¨è¿‡çš„nonceä¸èƒ½å†ç”¨

æœ€ä½³å®è·µï¼šä¸¤è€…ç»“åˆ
   timestamp + nonce + sign
   æ—¢é˜²é‡æ”¾ï¼Œåˆä¿è¯å®‰å…¨
```

**ğŸ›¡ï¸ å®Œæ•´é˜²æŠ¤æ–¹æ¡ˆ**ï¼š

```java
@Component
public class SignatureFilter implements Filter {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) {
        
        // 1. è·å–å‚æ•°
        String timestamp = request.getParameter("timestamp");
        String nonce = request.getParameter("nonce");
        String sign = request.getParameter("sign");
        
        // 2. éªŒè¯æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
        long now = System.currentTimeMillis() / 1000;
        if (Math.abs(now - Long.parseLong(timestamp)) > 300) {
            throw new RuntimeException("è¯·æ±‚å·²è¿‡æœŸ");
        }
        
        // 3. éªŒè¯éšæœºæ•°ï¼ˆé˜²é‡æ”¾ï¼‰
        String nonceKey = "nonce:" + nonce;
        if (redisTemplate.hasKey(nonceKey)) {
            throw new RuntimeException("è¯·æ±‚é‡å¤");
        }
        redisTemplate.opsForValue().set(nonceKey, "1", 5, TimeUnit.MINUTES);
        
        // 4. éªŒè¯ç­¾å
        if (!SignatureUtil.verifySign(params, sign, secret)) {
            throw new RuntimeException("ç­¾åéªŒè¯å¤±è´¥");
        }
        
        chain.doFilter(request, response);
    }
}
```

### 4.4 ç­¾ååº”ç”¨åœºæ™¯


**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š

```
âœ… å¼ºçƒˆæ¨èä½¿ç”¨ï¼š
â€¢ æ”¯ä»˜æ¥å£ï¼ˆé‡‘é¢ç›¸å…³ï¼Œç»å¯¹ä¸èƒ½è¢«ç¯¡æ”¹ï¼‰
â€¢ è®¢å•æ¥å£ï¼ˆé˜²æ­¢æ¶æ„ä¿®æ”¹è®¢å•ï¼‰
â€¢ é‡è¦æ•°æ®ä¿®æ”¹ï¼ˆç”¨æˆ·ä¿¡æ¯ã€æƒé™å˜æ›´ç­‰ï¼‰
â€¢ å¼€æ”¾å¹³å°APIï¼ˆç¬¬ä¸‰æ–¹è°ƒç”¨ï¼‰

âŒ ä¸å¿…è¦ä½¿ç”¨ï¼š
â€¢ æ™®é€šæŸ¥è¯¢æ¥å£ï¼ˆJWT Tokenå·²è¶³å¤Ÿï¼‰
â€¢ å†…ç½‘æœåŠ¡è°ƒç”¨ï¼ˆç½‘ç»œå·²éš”ç¦»ï¼‰
â€¢ é™æ€èµ„æºè¯·æ±‚ï¼ˆæ²¡å¿…è¦ï¼‰
```

---

## 5. ğŸ”’ SSLåŒå‘è®¤è¯


### 5.1 SSL/TLSåŸºç¡€æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼š
SSLå°±åƒç»™é€šä¿¡åŠ ä¸€ä¸ª"ä¿é™©ç®±"ï¼Œæ•°æ®æ”¾è¿›å»åŠ å¯†ä¼ è¾“ï¼Œåªæœ‰åŒæ–¹èƒ½æ‰“å¼€ã€‚

```
æ™®é€šHTTPé€šä¿¡ï¼ˆæ˜æ–‡ï¼‰ï¼š
å®¢æˆ·ç«¯ ---æ•°æ®æ˜æ–‡---> æœåŠ¡å™¨
       å®¹æ˜“è¢«çªƒå¬å’Œç¯¡æ”¹

HTTPSé€šä¿¡ï¼ˆåŠ å¯†ï¼‰ï¼š
å®¢æˆ·ç«¯ ---åŠ å¯†æ•°æ®---> æœåŠ¡å™¨
       ç¬¬ä¸‰æ–¹çœ‹åˆ°çš„æ˜¯ä¹±ç 
```

### 5.2 å•å‘è®¤è¯ vs åŒå‘è®¤è¯


**ğŸ”„ è®¤è¯æ–¹å¼å¯¹æ¯”**ï¼š

```
å•å‘è®¤è¯ï¼ˆå¸¸è§ï¼Œå¦‚HTTPSç½‘ç«™ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ â”‚ â”€â”€éªŒè¯è¯ä¹¦â”€â”€â†’ â”‚ æœåŠ¡å™¨ â”‚
â”‚        â”‚ â†â”€å»ºç«‹è¿æ¥â”€â”€â”€ â”‚(æœ‰è¯ä¹¦)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å®¢æˆ·ç«¯éªŒè¯ï¼šè¿™æ˜¯çœŸçš„æ·˜å®ç½‘å—ï¼Ÿ

åŒå‘è®¤è¯ï¼ˆé‡‘èçº§å®‰å…¨ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ â”‚ â”€â”€éªŒè¯è¯ä¹¦â”€â”€â†’ â”‚ æœåŠ¡å™¨ â”‚
â”‚(æœ‰è¯ä¹¦)â”‚ â†â”€éªŒè¯è¯ä¹¦â”€â”€â”€ â”‚(æœ‰è¯ä¹¦)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
äº’ç›¸éªŒè¯ï¼šåŒæ–¹éƒ½è¦è¯æ˜èº«ä»½
```

**ğŸ“‹ è¯ä¹¦éªŒè¯è¿‡ç¨‹**ï¼š

```
åŒå‘è®¤è¯æµç¨‹ï¼š

ç¬¬ä¸€æ­¥ï¼šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
   å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼š"æˆ‘æƒ³å»ºç«‹å®‰å…¨è¿æ¥"

ç¬¬äºŒæ­¥ï¼šæœåŠ¡å™¨è¿”å›è¯ä¹¦
   æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š"è¿™æ˜¯æˆ‘çš„è¯ä¹¦"
   
ç¬¬ä¸‰æ­¥ï¼šå®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨
   å®¢æˆ·ç«¯æ£€æŸ¥ï¼šè¯ä¹¦æ˜¯å¦è¿‡æœŸï¼Ÿæ˜¯å¦è¢«ç¯¡æ”¹ï¼Ÿ
   
ç¬¬å››æ­¥ï¼šå®¢æˆ·ç«¯å‘é€è¯ä¹¦
   å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼š"è¿™æ˜¯æˆ‘çš„è¯ä¹¦"
   
ç¬¬äº”æ­¥ï¼šæœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯  
   æœåŠ¡å™¨æ£€æŸ¥ï¼šè¿™ä¸ªå®¢æˆ·ç«¯å¯ä¿¡å—ï¼Ÿ
   
ç¬¬å…­æ­¥ï¼šå»ºç«‹åŠ å¯†é€šé“
   åŒæ–¹äº¤æ¢å¯†é’¥ â†’ åç»­é€šä¿¡å…¨éƒ¨åŠ å¯†
```

### 5.3 åŒå‘è®¤è¯é…ç½®å®æˆ˜


**ğŸ”§ è¯ä¹¦ç”Ÿæˆæ­¥éª¤**ï¼š

```bash
# 1. ç”ŸæˆCAæ ¹è¯ä¹¦ï¼ˆè¯ä¹¦é¢å‘æœºæ„ï¼‰
keytool -genkeypair -alias ca -keyalg RSA -keysize 2048 \
        -keystore ca.jks -validity 3650

# 2. å¯¼å‡ºCAè¯ä¹¦
keytool -exportcert -alias ca -keystore ca.jks -file ca.crt

# 3. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
keytool -genkeypair -alias server -keyalg RSA -keysize 2048 \
        -keystore server.jks

# 4. ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
keytool -genkeypair -alias client -keyalg RSA -keysize 2048 \
        -keystore client.jks

# 5. ç”¨CAç­¾åæœåŠ¡å™¨è¯ä¹¦
keytool -certreq -alias server -keystore server.jks -file server.csr
keytool -gencert -alias ca -keystore ca.jks \
        -infile server.csr -outfile server.crt

# 6. å¯¼å…¥ç­¾ååçš„è¯ä¹¦
keytool -importcert -alias ca -keystore server.jks -file ca.crt
keytool -importcert -alias server -keystore server.jks -file server.crt
```

**ğŸ’» Spring Booté…ç½®**ï¼š

```yaml
# application.yml - æœåŠ¡å™¨ç«¯é…ç½®
server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:server.jks
    key-store-password: 123456
    key-store-type: JKS
    # åŒå‘è®¤è¯é…ç½®
    client-auth: need  # éœ€è¦å®¢æˆ·ç«¯è¯ä¹¦
    trust-store: classpath:ca.jks
    trust-store-password: 123456
```

```java
// Feignå®¢æˆ·ç«¯é…ç½® - æºå¸¦å®¢æˆ·ç«¯è¯ä¹¦
@Configuration
public class FeignSslConfig {
    
    @Bean
    public Client feignClient() throws Exception {
        // åŠ è½½å®¢æˆ·ç«¯è¯ä¹¦
        KeyStore keyStore = KeyStore.getInstance("JKS");
        keyStore.load(new FileInputStream("client.jks"), "123456".toCharArray());
        
        // åŠ è½½ä¿¡ä»»è¯ä¹¦
        KeyStore trustStore = KeyStore.getInstance("JKS");
        trustStore.load(new FileInputStream("ca.jks"), "123456".toCharArray());
        
        // åˆ›å»ºSSLä¸Šä¸‹æ–‡
        SSLContext sslContext = SSLContexts.custom()
            .loadKeyMaterial(keyStore, "123456".toCharArray())
            .loadTrustMaterial(trustStore, null)
            .build();
            
        return new Client.Default(
            sslContext.getSocketFactory(),
            new DefaultHostnameVerifier()
        );
    }
}
```

### 5.4 SSLåŒå‘è®¤è¯åº”ç”¨åœºæ™¯


**ğŸ¯ ä½¿ç”¨å»ºè®®**ï¼š

```
âœ… é€‚åˆåŒå‘è®¤è¯çš„åœºæ™¯ï¼š
â€¢ é“¶è¡Œç³»ç»Ÿé—´é€šä¿¡
â€¢ æ”¿åºœå†…ç½‘æœåŠ¡è°ƒç”¨
â€¢ æ”¯ä»˜ç½‘å…³å¯¹æ¥
â€¢ æ ¸å¿ƒæ•°æ®ä¼ è¾“
â€¢ B2Bä¼ä¸šé—´å¯¹æ¥

âŒ ä¸å¿…è¦ä½¿ç”¨åŒå‘è®¤è¯ï¼š
â€¢ æ™®é€šç½‘ç«™ï¼ˆå•å‘HTTPSè¶³å¤Ÿï¼‰
â€¢ å†…ç½‘æœåŠ¡è°ƒç”¨ï¼ˆç½‘ç»œå·²éš”ç¦»ï¼‰
â€¢ å¼€å‘æµ‹è¯•ç¯å¢ƒï¼ˆé…ç½®å¤æ‚ï¼‰
â€¢ é«˜å¹¶å‘åœºæ™¯ï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼‰

æŠ˜ä¸­æ–¹æ¡ˆï¼š
â€¢ ç½‘å…³å±‚ï¼šä½¿ç”¨åŒå‘SSL
â€¢ å†…éƒ¨æœåŠ¡ï¼šä½¿ç”¨JWT Token
â€¢ æ··åˆä½¿ç”¨ï¼šå¤–éƒ¨SSL + å†…éƒ¨Token
```

---

## 6. ğŸ”‘ APIå¯†é’¥ç®¡ç†


### 6.1 ä»€ä¹ˆæ˜¯APIå¯†é’¥


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
APIå¯†é’¥å°±åƒä½ å®¶çš„é’¥åŒ™ï¼Œæ¯ä¸ªæœ‰æƒè¿›å…¥çš„äººéƒ½æœ‰è‡ªå·±çš„é’¥åŒ™ï¼Œè€Œä¸”å¯ä»¥éšæ—¶æ¢é”ï¼ˆæ›´æ¢å¯†é’¥ï¼‰ã€‚

```
APIå¯†é’¥çš„ç»„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Access Key  â”‚ â† å…¬å¼€çš„IDï¼ˆåƒç”¨æˆ·åï¼‰
â”‚  Secret Key  â”‚ â† ç§å¯†çš„å¯†ç ï¼ˆç»ä¸å…¬å¼€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨æ–¹å¼ï¼š
Access Keyï¼šxYz123  ï¼ˆå¯ä»¥å…¬å¼€ï¼Œç”¨äºè¯†åˆ«èº«ä»½ï¼‰
Secret Keyï¼šaBc456  ï¼ˆä¸¥æ ¼ä¿å¯†ï¼Œç”¨äºç­¾åéªŒè¯ï¼‰
```

### 6.2 APIå¯†é’¥çš„ç”Ÿæˆä¸åˆ†å‘


**ğŸ” å¯†é’¥ç”Ÿæˆç­–ç•¥**ï¼š

```java
public class ApiKeyGenerator {
    
    // ç”ŸæˆAPIå¯†é’¥å¯¹
    public static ApiKeyPair generate() {
        // Access Keyï¼šUUIDå½¢å¼ï¼Œä¾¿äºè¯†åˆ«
        String accessKey = "ak_" + UUID.randomUUID().toString().replace("-", "");
        
        // Secret Keyï¼šå¼ºéšæœºå­—ç¬¦ä¸²
        String secretKey = "sk_" + generateRandomString(32);
        
        return new ApiKeyPair(accessKey, secretKey);
    }
    
    private static String generateRandomString(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        SecureRandom random = new SecureRandom();
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; i++) {
            sb.append(chars.charAt(random.nextInt(chars.length())));
        }
        return sb.toString();
    }
}
```

**ğŸ“‹ å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ**ï¼š

```
å¯†é’¥å­˜å‚¨è§„èŒƒï¼š
âœ… Secret KeyåŠ å¯†å­˜å‚¨ï¼ˆä¸è¦æ˜æ–‡ï¼‰
âœ… ä½¿ç”¨ä¸“é—¨çš„å¯†é’¥ç®¡ç†ç³»ç»Ÿ
âœ… å®šæœŸè½®æ¢å¯†é’¥
âœ… ä¸ºä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥

å¯†é’¥åˆ†å‘æµç¨‹ï¼š
1. ç”¨æˆ·ç”³è¯·APIæƒé™
   â†“
2. ç³»ç»Ÿå®¡æ ¸é€šè¿‡
   â†“
3. ç”Ÿæˆå¯†é’¥å¯¹
   â†“
4. å®‰å…¨æ–¹å¼å‘é€ç»™ç”¨æˆ·
   â†“
5. ç”¨æˆ·ä¿å­˜Secret Keyï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰
```

### 6.3 APIå¯†é’¥ä½¿ç”¨æ–¹å¼


**ğŸ”„ å¸¸è§ä½¿ç”¨æ–¹å¼**ï¼š

**æ–¹å¼ä¸€ï¼šè¯·æ±‚å¤´æºå¸¦**
```java
// å®¢æˆ·ç«¯å‘é€è¯·æ±‚
HttpHeaders headers = new HttpHeaders();
headers.set("X-Access-Key", "ak_xxxx");
headers.set("X-Secret-Key", "sk_xxxx");  // ä¸æ¨èæ˜æ–‡ä¼ è¾“
```

**æ–¹å¼äºŒï¼šç­¾åæ–¹å¼ï¼ˆæ¨èï¼‰**
```java
// 1. å®¢æˆ·ç«¯ç”Ÿæˆç­¾å
String timestamp = String.valueOf(System.currentTimeMillis());
String signature = HmacSHA256(accessKey + timestamp, secretKey);

// 2. å‘é€è¯·æ±‚
headers.set("X-Access-Key", "ak_xxxx");
headers.set("X-Timestamp", timestamp);
headers.set("X-Signature", signature);

// 3. æœåŠ¡å™¨éªŒè¯
String serverSignature = HmacSHA256(accessKey + timestamp, storedSecretKey);
if (serverSignature.equals(receivedSignature)) {
    // éªŒè¯é€šè¿‡
}
```

**æ–¹å¼ä¸‰ï¼šåŠ å¯†ä¼ è¾“ï¼ˆæœ€å®‰å…¨ï¼‰**
```java
// ä½¿ç”¨éå¯¹ç§°åŠ å¯†
// 1. ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†Secret Key
String encryptedSecret = RSA.encrypt(secretKey, serverPublicKey);

// 2. å‘é€åŠ å¯†åçš„å¯†é’¥
headers.set("X-Access-Key", "ak_xxxx");
headers.set("X-Encrypted-Secret", encryptedSecret);

// 3. æœåŠ¡å™¨ç”¨ç§é’¥è§£å¯†éªŒè¯
String decryptedSecret = RSA.decrypt(encryptedSecret, serverPrivateKey);
```

### 6.4 å¯†é’¥è½®æ¢ä¸æ’¤é”€


**ğŸ”„ å¯†é’¥ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```
å¯†é’¥è½®æ¢ç­–ç•¥ï¼š

å®šæœŸè½®æ¢ï¼ˆä¸»åŠ¨ï¼‰ï¼š
   æ¯3ä¸ªæœˆè‡ªåŠ¨ç”Ÿæˆæ–°å¯†é’¥
   â†“
   æ—§å¯†é’¥ä¿ç•™1ä¸ªæœˆè¿‡æ¸¡æœŸ
   â†“
   é€šçŸ¥ç”¨æˆ·åˆ‡æ¢åˆ°æ–°å¯†é’¥
   â†“
   è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ

å¼‚å¸¸æ’¤é”€ï¼ˆè¢«åŠ¨ï¼‰ï¼š
   æ£€æµ‹åˆ°å¯†é’¥æ³„éœ²
   â†“
   ç«‹å³æ’¤é”€æ—§å¯†é’¥
   â†“
   ç”Ÿæˆæ–°å¯†é’¥
   â†“
   ç´§æ€¥é€šçŸ¥ç”¨æˆ·æ›´æ¢
```

**ğŸ’» å¯†é’¥ç®¡ç†æ¥å£ç¤ºä¾‹**ï¼š

```java
@RestController
@RequestMapping("/api/keys")
public class ApiKeyController {
    
    // ç”³è¯·æ–°å¯†é’¥
    @PostMapping("/create")
    public ApiKeyPair createKey(@RequestParam String appName) {
        ApiKeyPair keyPair = apiKeyService.generate(appName);
        // æ³¨æ„ï¼šSecret Keyåªè¿”å›ä¸€æ¬¡ï¼Œè¦æç¤ºç”¨æˆ·ä¿å­˜
        return keyPair;
    }
    
    // è½®æ¢å¯†é’¥
    @PostMapping("/rotate")
    public ApiKeyPair rotateKey(@RequestParam String accessKey) {
        // ç”Ÿæˆæ–°å¯†é’¥
        ApiKeyPair newKeyPair = apiKeyService.generate();
        // æ—§å¯†é’¥è®¾ç½®è¿‡æ¸¡æœŸ
        apiKeyService.setDeprecated(accessKey, 30); // 30å¤©åå¤±æ•ˆ
        return newKeyPair;
    }
    
    // æ’¤é”€å¯†é’¥
    @DeleteMapping("/revoke")
    public void revokeKey(@RequestParam String accessKey) {
        apiKeyService.revoke(accessKey);
    }
}
```

---

## 7. ğŸ›¡ï¸ æƒé™æ§åˆ¶æœºåˆ¶


### 7.1 æƒé™æ§åˆ¶åŸºç¡€æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼š
æƒé™æ§åˆ¶å°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼Œä¸åŒçš„å‘˜å·¥å¡èƒ½è¿›ä¸åŒçš„æˆ¿é—´ï¼Œåšä¸åŒçš„äº‹æƒ…ã€‚

```
æƒé™æ§åˆ¶ä¸‰è¦ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Who    â”‚     â”‚  What   â”‚     â”‚  How    â”‚
â”‚ è°æ“ä½œ  â”‚ â†’  â”‚åšä»€ä¹ˆæ“ä½œâ”‚ â†’  â”‚æƒé™å¦‚ä½• â”‚
â”‚(ç”¨æˆ·)   â”‚     â”‚(èµ„æº)   â”‚     â”‚(æ£€æŸ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…ä¾‹å­ï¼š
å¼ ä¸‰(å‘˜å·¥) + åˆ é™¤è®¢å•(æ“ä½œ) â†’ æœ‰æƒé™?
æå››(ç®¡ç†å‘˜) + åˆ é™¤è®¢å•(æ“ä½œ) â†’ æœ‰æƒé™!
```

### 7.2 RBACæƒé™æ¨¡å‹


**ğŸ‘¥ åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶**ï¼š

```
RBACæ¨¡å‹ç»“æ„ï¼š
ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™ â†’ èµ„æº

ç¤ºä¾‹å…³ç³»ï¼š
å¼ ä¸‰ â†’ é”€å”®å‘˜ â†’ æŸ¥çœ‹è®¢å•ã€åˆ›å»ºè®¢å•
æå›› â†’ ç»ç† â†’ æŸ¥çœ‹è®¢å•ã€åˆ›å»ºè®¢å•ã€åˆ é™¤è®¢å•ã€å®¡æ‰¹è®¢å•
ç‹äº” â†’ å®¢æœ â†’ æŸ¥çœ‹è®¢å•

å¥½å¤„ï¼š
âœ… æ‰¹é‡ç®¡ç†ï¼šæ”¹è§’è‰²æƒé™ï¼Œæ‰€æœ‰è¯¥è§’è‰²ç”¨æˆ·ç”Ÿæ•ˆ
âœ… èŒè´£æ¸…æ™°ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
âœ… æ˜“äºç»´æŠ¤ï¼šæ–°å‘˜å·¥åˆ†é…è§’è‰²å³å¯
```

**ğŸ“Š æ•°æ®åº“è®¾è®¡ç¤ºä¾‹**ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(100)
);

-- è§’è‰²è¡¨
CREATE TABLE role (
    id BIGINT PRIMARY KEY,
    role_name VARCHAR(50),  -- admin, manager, user
    description VARCHAR(200)
);

-- æƒé™è¡¨
CREATE TABLE permission (
    id BIGINT PRIMARY KEY,
    permission_name VARCHAR(50),  -- order:create, order:delete
    resource VARCHAR(100)          -- /api/order/*
);

-- ç”¨æˆ·-è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    user_id BIGINT,
    role_id BIGINT
);

-- è§’è‰²-æƒé™å…³è”è¡¨
CREATE TABLE role_permission (
    role_id BIGINT,
    permission_id BIGINT
);
```

### 7.3 Spring Securityæƒé™æ§åˆ¶


**ğŸ”’ æ³¨è§£å¼æƒé™æ§åˆ¶**ï¼š

```java
@RestController
@RequestMapping("/api/order")
public class OrderController {
    
    // éœ€è¦ç™»å½•å³å¯è®¿é—®
    @GetMapping("/list")
    @PreAuthorize("isAuthenticated()")
    public List<Order> listOrders() {
        return orderService.list();
    }
    
    // éœ€è¦ADMINè§’è‰²
    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN')")
    public void deleteOrder(@PathVariable Long id) {
        orderService.delete(id);
    }
    
    // éœ€è¦ç‰¹å®šæƒé™
    @PostMapping("/approve")
    @PreAuthorize("hasAuthority('order:approve')")
    public void approveOrder(@RequestBody Order order) {
        orderService.approve(order);
    }
    
    // è‡ªå®šä¹‰æƒé™åˆ¤æ–­
    @PutMapping("/{id}")
    @PreAuthorize("@orderSecurity.canEdit(#id)")
    public void updateOrder(@PathVariable Long id, @RequestBody Order order) {
        orderService.update(order);
    }
}

// è‡ªå®šä¹‰æƒé™åˆ¤æ–­ç±»
@Component("orderSecurity")
public class OrderSecurityService {
    
    public boolean canEdit(Long orderId) {
        // è·å–å½“å‰ç”¨æˆ·
        UserDetails user = (UserDetails) SecurityContextHolder
            .getContext().getAuthentication().getPrincipal();
            
        // åˆ¤æ–­æ˜¯å¦æ˜¯è®¢å•åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜
        Order order = orderService.getById(orderId);
        return order.getCreatorId().equals(user.getId()) 
            || user.hasRole("ADMIN");
    }
}
```

### 7.4 ç»†ç²’åº¦æƒé™æ§åˆ¶


**ğŸ¯ æ•°æ®æƒé™æ§åˆ¶**ï¼š

```
åœºæ™¯ï¼šé”€å”®åªèƒ½çœ‹è‡ªå·±åˆ›å»ºçš„è®¢å•ï¼Œç»ç†èƒ½çœ‹æ•´ä¸ªéƒ¨é—¨çš„

å®ç°æ–¹å¼1ï¼šSQLè¿‡æ»¤ï¼ˆæ¨èï¼‰
```java
@Component
public class DataScopeInterceptor implements Interceptor {
    
    @Override
    public void beforeQuery(String sql) {
        UserDetails user = getCurrentUser();
        
        if (user.hasRole("SALES")) {
            // æ·»åŠ åˆ›å»ºè€…è¿‡æ»¤æ¡ä»¶
            sql += " AND creator_id = " + user.getId();
        } else if (user.hasRole("MANAGER")) {
            // æ·»åŠ éƒ¨é—¨è¿‡æ»¤æ¡ä»¶
            sql += " AND dept_id = " + user.getDeptId();
        }
        // ADMINä¸æ·»åŠ æ¡ä»¶ï¼Œèƒ½çœ‹æ‰€æœ‰
        
        return sql;
    }
}
```

**å®ç°æ–¹å¼2ï¼šä¸šåŠ¡å±‚è¿‡æ»¤**
```java
@Service
public class OrderService {
    
    public List<Order> list() {
        UserDetails user = getCurrentUser();
        
        if (user.hasRole("ADMIN")) {
            // ç®¡ç†å‘˜æŸ¥æ‰€æœ‰
            return orderMapper.selectAll();
        } else if (user.hasRole("MANAGER")) {
            // ç»ç†æŸ¥éƒ¨é—¨çš„
            return orderMapper.selectByDept(user.getDeptId());
        } else {
            // æ™®é€šå‘˜å·¥æŸ¥è‡ªå·±çš„
            return orderMapper.selectByCreator(user.getId());
        }
    }
}
```

**ğŸ” å­—æ®µçº§æƒé™æ§åˆ¶**ï¼š

```java
// ä¸åŒè§’è‰²è¿”å›ä¸åŒå­—æ®µ
@GetMapping("/detail/{id}")
public OrderVO getOrderDetail(@PathVariable Long id) {
    Order order = orderService.getById(id);
    UserDetails user = getCurrentUser();
    
    OrderVO vo = new OrderVO();
    vo.setId(order.getId());
    vo.setProductName(order.getProductName());
    
    // åªæœ‰ç»ç†ä»¥ä¸Šèƒ½çœ‹ä»·æ ¼
    if (user.hasAnyRole("MANAGER", "ADMIN")) {
        vo.setPrice(order.getPrice());
        vo.setTotalAmount(order.getTotalAmount());
    }
    
    // åªæœ‰ç®¡ç†å‘˜èƒ½çœ‹æˆæœ¬
    if (user.hasRole("ADMIN")) {
        vo.setCost(order.getCost());
        vo.setProfit(order.getProfit());
    }
    
    return vo;
}
```

---

## 8. ğŸ“Š å®‰å…¨å®¡è®¡æ—¥å¿—


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—


**é‡è¦æ€§ç†è§£**ï¼š
å®¡è®¡æ—¥å¿—å°±åƒç›‘æ§å½•åƒï¼Œå‡ºäº†é—®é¢˜å¯ä»¥å›æ”¾ï¼Œçœ‹çœ‹æ˜¯è°ã€ä»€ä¹ˆæ—¶å€™ã€åšäº†ä»€ä¹ˆæ“ä½œã€‚

```
å®¡è®¡æ—¥å¿—çš„ä½œç”¨ï¼š

ğŸ” é—®é¢˜æ’æŸ¥ï¼š
   ç³»ç»Ÿå‡ºé—®é¢˜äº† â†’ æŸ¥æ—¥å¿— â†’ æ‰¾åˆ°è°çš„æ“ä½œå¯¼è‡´çš„

ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤ï¼š
   å‘ç°å¼‚å¸¸è¡Œä¸º â†’ åŠæ—¶é¢„è­¦ â†’ é˜²æ­¢æŸå¤±æ‰©å¤§

ğŸ“ˆ åˆè§„è¦æ±‚ï¼š
   é‡‘èã€åŒ»ç–—ç­‰è¡Œä¸š â†’ å¿…é¡»è®°å½•æ‰€æœ‰æ“ä½œ â†’ æ³•å¾‹è¦æ±‚

ğŸ“Š æ•°æ®åˆ†æï¼š
   åˆ†æç”¨æˆ·è¡Œä¸º â†’ ä¼˜åŒ–ç³»ç»Ÿ â†’ æå‡ä½“éªŒ
```

### 8.2 å®¡è®¡æ—¥å¿—è®°å½•ä»€ä¹ˆ


**ğŸ“‹ æ ¸å¿ƒè®°å½•å†…å®¹**ï¼š

```
å¿…é¡»è®°å½•çš„ä¿¡æ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°(Who)          â”‚ â†’ ç”¨æˆ·IDã€ç”¨æˆ·åã€IPåœ°å€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»€ä¹ˆæ—¶é—´(When)   â”‚ â†’ æ“ä½œæ—¶é—´æˆ³ï¼ˆç²¾ç¡®åˆ°æ¯«ç§’ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åšäº†ä»€ä¹ˆ(What)   â”‚ â†’ æ“ä½œç±»å‹ã€APIè·¯å¾„ã€æ–¹æ³•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ“ä½œå¯¹è±¡(Which)  â”‚ â†’ èµ„æºIDã€èµ„æºç±»å‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»“æœ(Result)     â”‚ â†’ æˆåŠŸ/å¤±è´¥ã€é”™è¯¯ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯¦ç»†ä¿¡æ¯(Detail) â”‚ â†’ è¯·æ±‚å‚æ•°ã€å“åº”ç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¾ å®¡è®¡æ—¥å¿—è¡¨è®¾è®¡**ï¼š

```sql
CREATE TABLE audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT 'æ“ä½œç”¨æˆ·ID',
    username VARCHAR(50) COMMENT 'ç”¨æˆ·å',
    ip_address VARCHAR(50) COMMENT 'IPåœ°å€',
    operation_type VARCHAR(20) COMMENT 'æ“ä½œç±»å‹ï¼šCREATE/UPDATE/DELETE/QUERY',
    api_path VARCHAR(200) COMMENT 'APIè·¯å¾„',
    method VARCHAR(10) COMMENT 'è¯·æ±‚æ–¹æ³•ï¼šGET/POST/PUT/DELETE',
    resource_type VARCHAR(50) COMMENT 'èµ„æºç±»å‹ï¼šorder/user/product',
    resource_id VARCHAR(100) COMMENT 'èµ„æºID',
    request_params TEXT COMMENT 'è¯·æ±‚å‚æ•°',
    response_result TEXT COMMENT 'å“åº”ç»“æœ',
    success BOOLEAN COMMENT 'æ˜¯å¦æˆåŠŸ',
    error_msg VARCHAR(500) COMMENT 'é”™è¯¯ä¿¡æ¯',
    execution_time INT COMMENT 'æ‰§è¡Œæ—¶é•¿(ms)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ“ä½œæ—¶é—´'
);

-- æ·»åŠ ç´¢å¼•æé«˜æŸ¥è¯¢æ•ˆç‡
CREATE INDEX idx_user_id ON audit_log(user_id);
CREATE INDEX idx_created_at ON audit_log(created_at);
CREATE INDEX idx_resource ON audit_log(resource_type, resource_id);
```

### 8.3 å®¡è®¡æ—¥å¿—å®ç°æ–¹å¼


**ğŸ”§ æ–¹å¼ä¸€ï¼šAOPåˆ‡é¢å®ç°ï¼ˆæ¨èï¼‰**ï¼š

```java
@Aspect
@Component
public class AuditLogAspect {
    
    @Autowired
    private AuditLogService auditLogService;
    
    // åˆ‡å…¥æ‰€æœ‰Controlleræ–¹æ³•
    @Around("execution(* com.example.controller..*.*(..))")
    public Object logAudit(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // 1. è·å–è¯·æ±‚ä¿¡æ¯
        HttpServletRequest request = ((ServletRequestAttributes) 
            RequestContextHolder.getRequestAttributes()).getRequest();
            
        // 2. è·å–å½“å‰ç”¨æˆ·
        UserDetails user = getCurrentUser();
        
        // 3. æ„å»ºå®¡è®¡æ—¥å¿—
        AuditLog log = new AuditLog();
        log.setUserId(user.getId());
        log.setUsername(user.getUsername());
        log.setIpAddress(getClientIp(request));
        log.setApiPath(request.getRequestURI());
        log.setMethod(request.getMethod());
        log.setRequestParams(JSON.toJSONString(point.getArgs()));
        
        Object result = null;
        try {
            // 4. æ‰§è¡Œå®é™…æ–¹æ³•
            result = point.proceed();
            log.setSuccess(true);
            log.setResponseResult(JSON.toJSONString(result));
        } catch (Exception e) {
            log.setSuccess(false);
            log.setErrorMsg(e.getMessage());
            throw e;
        } finally {
            // 5. è®°å½•æ‰§è¡Œæ—¶é•¿
            log.setExecutionTime((int)(System.currentTimeMillis() - startTime));
            
            // 6. å¼‚æ­¥ä¿å­˜æ—¥å¿—
            auditLogService.saveAsync(log);
        }
        
        return result;
    }
}
```

**ğŸ”§ æ–¹å¼äºŒï¼šæ³¨è§£å¼å®¡è®¡**ï¼š

```java
// è‡ªå®šä¹‰å®¡è®¡æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface AuditLog {
    String operation();  // æ“ä½œæè¿°
    String resourceType();  // èµ„æºç±»å‹
}

// ä½¿ç”¨æ³¨è§£
@RestController
public class OrderController {
    
    @AuditLog(operation = "åˆ é™¤è®¢å•", resourceType = "ORDER")
    @DeleteMapping("/order/{id}")
    public void deleteOrder(@PathVariable Long id) {
        orderService.delete(id);
    }
}

// åˆ‡é¢å¤„ç†
@Aspect
@Component
public class AuditLogAspect {
    
    @Around("@annotation(auditLog)")
    public Object logAudit(ProceedingJoinPoint point, AuditLog auditLog) {
        // è·å–æ³¨è§£ä¿¡æ¯
        String operation = auditLog.operation();
        String resourceType = auditLog.resourceType();
        
        // ä¿å­˜å®¡è®¡æ—¥å¿—ï¼ˆåŒä¸Šï¼‰
        // ...
    }
}
```

### 8.4 å®¡è®¡æ—¥å¿—æŸ¥è¯¢ä¸åˆ†æ


**ğŸ” æ—¥å¿—æŸ¥è¯¢æ¥å£**ï¼š

```java
@RestController
@RequestMapping("/api/audit")
public class AuditLogController {
    
    // åˆ†é¡µæŸ¥è¯¢å®¡è®¡æ—¥å¿—
    @GetMapping("/logs")
    public PageResult<AuditLog> queryLogs(
            @RequestParam(required = false) Long userId,
            @RequestParam(required = false) String operation,
            @RequestParam(required = false) LocalDateTime startTime,
            @RequestParam(required = false) LocalDateTime endTime,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        return auditLogService.queryLogs(userId, operation, startTime, endTime, page, size);
    }
    
    // ç»Ÿè®¡æŸä¸ªç”¨æˆ·çš„æ“ä½œæ¬¡æ•°
    @GetMapping("/stats/user/{userId}")
    public Map<String, Long> getUserStats(@PathVariable Long userId) {
        return auditLogService.countByUser(userId);
    }
    
    // æŸ¥è¯¢å¼‚å¸¸æ“ä½œè®°å½•
    @GetMapping("/errors")
    public List<AuditLog> queryErrors(
            @RequestParam(required = false) LocalDateTime startTime,
            @RequestParam(required = false) LocalDateTime endTime) {
        
        return auditLogService.queryFailedLogs(startTime, endTime);
    }
}
```

**ğŸ“Š æ—¥å¿—åˆ†æä¸å‘Šè­¦**ï¼š

```java
@Service
public class AuditLogAnalysisService {
    
    @Scheduled(cron = "0 */5 * * * ?")  // æ¯5åˆ†é’Ÿæ‰§è¡Œ
    public void analyzeAndAlert() {
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime fiveMinutesAgo = now.minusMinutes(5);
        
        // 1. æ£€æµ‹é¢‘ç¹å¤±è´¥çš„æ“ä½œ
        List<AuditLog> failedLogs = auditLogService
            .queryFailedLogs(fiveMinutesAgo, now);
            
        if (failedLogs.size() > 10) {
            alertService.send("æ£€æµ‹åˆ°å¼‚å¸¸ï¼š5åˆ†é’Ÿå†…å¤±è´¥æ“ä½œè¶…è¿‡10æ¬¡");
        }
        
        // 2. æ£€æµ‹å¼‚å¸¸IP
        Map<String, Long> ipCounts = failedLogs.stream()
            .collect(Collectors.groupingBy(
                AuditLog::getIpAddress, 
                Collectors.counting()
            ));
            
        ipCounts.forEach((ip, count) -> {
            if (count > 5) {
                alertService.send("è­¦å‘Šï¼šIP " + ip + " åœ¨5åˆ†é’Ÿå†…å¤±è´¥" + count + "æ¬¡");
                // å¯ä»¥è€ƒè™‘å°ç¦IP
                securityService.blockIp(ip, Duration.ofHours(1));
            }
        });
        
        // 3. æ£€æµ‹æ•æ„Ÿæ“ä½œ
        List<AuditLog> sensitiveLogs = auditLogService
            .querySensitiveOperations(fiveMinutesAgo, now);
            
        sensitiveLogs.forEach(log -> {
            alertService.send(String.format(
                "æ•æ„Ÿæ“ä½œï¼šç”¨æˆ· %s åœ¨ %s æ‰§è¡Œäº† %s",
                log.getUsername(),
                log.getCreatedAt(),
                log.getApiPath()
            ));
        });
    }
}
```

**ğŸ’¡ å®¡è®¡æ—¥å¿—æœ€ä½³å®è·µ**ï¼š

```
æ—¥å¿—è®°å½•ç­–ç•¥ï¼š
âœ… å¼‚æ­¥è®°å½•ï¼šä¸å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½
âœ… åˆ†çº§å­˜å‚¨ï¼šé‡è¦æ—¥å¿—å•ç‹¬å­˜å‚¨
âœ… å®šæœŸå½’æ¡£ï¼šå†å²æ—¥å¿—å‹ç¼©å½’æ¡£
âœ… æ•æ„Ÿè„±æ•ï¼šå¯†ç ç­‰æ•æ„Ÿä¿¡æ¯è„±æ•

æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼š
â€¢ æ™®é€šæ—¥å¿—ï¼šä¿ç•™3ä¸ªæœˆ
â€¢ é‡è¦æ“ä½œï¼šä¿ç•™1å¹´
â€¢ åˆè§„è¦æ±‚ï¼šä¿ç•™7å¹´
â€¢ å®æ—¶æ—¥å¿—ï¼šä¿ç•™7å¤©åå½’æ¡£

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å†™å…¥
â€¢ æ‰¹é‡å†™å…¥æ•°æ®åº“
â€¢ ä½¿ç”¨æ—¶åºæ•°æ®åº“ï¼ˆå¦‚InfluxDBï¼‰
â€¢ å†·æ•°æ®å½’æ¡£åˆ°å¯¹è±¡å­˜å‚¨
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å®‰å…¨è®¤è¯æœ¬è´¨ï¼šè¯æ˜"ä½ æ˜¯è°"ã€"èƒ½åšä»€ä¹ˆ"
ğŸ”¸ JWT Tokenï¼šè½»é‡çº§ã€è‡ªåŒ…å«ã€è·¨æœåŠ¡ä¼ é€’èº«ä»½
ğŸ”¸ OAuth2ï¼šæ ‡å‡†æˆæƒåè®®ï¼Œç¬¬ä¸‰æ–¹ç™»å½•æ ¸å¿ƒ
ğŸ”¸ è¯·æ±‚ç­¾åï¼šé˜²ç¯¡æ”¹ã€é˜²é‡æ”¾çš„é‡è¦æ‰‹æ®µ
ğŸ”¸ åŒå‘SSLï¼šæœ€é«˜å®‰å…¨çº§åˆ«ï¼Œé‡‘èåœºæ™¯å¿…å¤‡
ğŸ”¸ APIå¯†é’¥ï¼šç³»ç»Ÿé—´è°ƒç”¨çš„èº«ä»½å‡­è¯
ğŸ”¸ æƒé™æ§åˆ¶ï¼šRBACæ¨¡å‹ï¼Œè§’è‰²æƒé™åˆ†ç¦»
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šå®‰å…¨çš„æœ€åä¸€é“é˜²çº¿
```

### 9.2 å…³é”®æŠ€æœ¯é€‰æ‹©


**ğŸ¯ è®¤è¯æ–¹æ¡ˆé€‰æ‹©æŒ‡å—**ï¼š

```
åœºæ™¯ä¸€ï¼šç”¨æˆ·ç™»å½•è®¤è¯
æ¨èæ–¹æ¡ˆï¼šJWT Token
ç†ç”±ï¼š
â€¢ æ— çŠ¶æ€ï¼ŒæœåŠ¡æ˜“æ‰©å±•
â€¢ å‰åç«¯åˆ†ç¦»å‹å¥½
â€¢ å¾®æœåŠ¡å¤©ç„¶æ”¯æŒ

åœºæ™¯äºŒï¼šç¬¬ä¸‰æ–¹ç™»å½•
æ¨èæ–¹æ¡ˆï¼šOAuth2
ç†ç”±ï¼š
â€¢ æ ‡å‡†åè®®ï¼Œç”Ÿæ€å®Œå–„
â€¢ å®‰å…¨æ€§é«˜
â€¢ ç”¨æˆ·ä½“éªŒå¥½

åœºæ™¯ä¸‰ï¼šæœåŠ¡é—´è°ƒç”¨
æ¨èæ–¹æ¡ˆï¼šJWT + APIå¯†é’¥ç»„åˆ
ç†ç”±ï¼š
â€¢ JWTä¼ é€’ç”¨æˆ·èº«ä»½
â€¢ APIå¯†é’¥éªŒè¯æœåŠ¡èº«ä»½
â€¢ åŒé‡ä¿éšœ

åœºæ™¯å››ï¼šé‡‘èçº§å®‰å…¨
æ¨èæ–¹æ¡ˆï¼šSSLåŒå‘è®¤è¯ + è¯·æ±‚ç­¾å
ç†ç”±ï¼š
â€¢ ä¼ è¾“å±‚åŠ å¯†
â€¢ è¯·æ±‚ä¸å¯ç¯¡æ”¹
â€¢ å¯è¿½æº¯
```

### 9.3 å®‰å…¨å®æ–½å»ºè®®


**ğŸ“ å®‰å…¨checklist**ï¼š

```
åŸºç¡€å®‰å…¨ï¼š
â˜‘ï¸ æ‰€æœ‰å¤–éƒ¨æ¥å£ä½¿ç”¨HTTPS
â˜‘ï¸ Tokenè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
â˜‘ï¸ æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯
â˜‘ï¸ å®ç°Tokenåˆ·æ–°æœºåˆ¶

è¿›é˜¶å®‰å…¨ï¼š
â˜‘ï¸ è¯·æ±‚ç­¾åéªŒè¯ï¼ˆé˜²ç¯¡æ”¹ï¼‰
â˜‘ï¸ æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²é‡æ”¾ï¼‰
â˜‘ï¸ IPç™½åå•ï¼ˆé™åˆ¶è®¿é—®ï¼‰
â˜‘ï¸ é™æµé™çº§ï¼ˆé˜²æ”»å‡»ï¼‰

é«˜çº§å®‰å…¨ï¼š
â˜‘ï¸ SSLåŒå‘è®¤è¯
â˜‘ï¸ å¯†é’¥å®šæœŸè½®æ¢
â˜‘ï¸ å®‰å…¨å®¡è®¡æ—¥å¿—
â˜‘ï¸ å®æ—¶å¼‚å¸¸æ£€æµ‹

ç›‘æ§å‘Šè­¦ï¼š
â˜‘ï¸ ç™»å½•å¤±è´¥å‘Šè­¦
â˜‘ï¸ å¼‚å¸¸IPæ£€æµ‹
â˜‘ï¸ æ•æ„Ÿæ“ä½œé€šçŸ¥
â˜‘ï¸ æ€§èƒ½ç›‘æ§
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ Tokenè¢«ç›—ç”¨æ€ä¹ˆåŠï¼Ÿ**
```
é¢„é˜²æªæ–½ï¼š
â€¢ ä½¿ç”¨HTTPSä¼ è¾“
â€¢ Tokenè®¾ç½®è¾ƒçŸ­è¿‡æœŸæ—¶é—´
â€¢ å®ç°è®¾å¤‡æŒ‡çº¹éªŒè¯
â€¢ å¼‚å¸¸ç™»å½•äºŒæ¬¡éªŒè¯

åº”æ€¥å¤„ç†ï¼š
â€¢ ç«‹å³æ’¤é”€è¢«ç›—Token
â€¢ å¼ºåˆ¶ç”¨æˆ·é‡æ–°ç™»å½•
â€¢ åˆ†ææ”»å‡»æ¥æº
â€¢ åŠ å¼ºé˜²æŠ¤ç­–ç•¥
```

**â“ å¦‚ä½•å¹³è¡¡å®‰å…¨ä¸æ€§èƒ½ï¼Ÿ**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ ç½‘å…³å±‚ç»Ÿä¸€è®¤è¯ï¼Œå‡å°‘é‡å¤éªŒè¯
â€¢ ä½¿ç”¨ç¼“å­˜å­˜å‚¨TokenéªŒè¯ç»“æœ
â€¢ å¼‚æ­¥è®°å½•å®¡è®¡æ—¥å¿—
â€¢ åˆ†çº§éªŒè¯ï¼ˆé‡è¦æ“ä½œä¸¥æ ¼ï¼ŒæŸ¥è¯¢å®½æ¾ï¼‰

æŠ€æœ¯æ‰‹æ®µï¼š
â€¢ Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯
â€¢ ä»¤ç‰Œæ¡¶é™æµç®—æ³•
â€¢ å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æ—¥å¿—
â€¢ CDNåŠ é€Ÿé™æ€èµ„æº
```

**â“ å¾®æœåŠ¡é—´è°ƒç”¨å¦‚ä½•è®¤è¯ï¼Ÿ**
```
æ¨èæ–¹æ¡ˆï¼š
1. ç½‘å…³ç»Ÿä¸€è®¤è¯ç”¨æˆ·Token
2. æå–ç”¨æˆ·ä¿¡æ¯æ”¾å…¥è¯·æ±‚å¤´
3. æœåŠ¡é—´ä½¿ç”¨APIå¯†é’¥éªŒè¯èº«ä»½
4. å†…ç½‘æœåŠ¡å¯ç®€åŒ–è®¤è¯ï¼ˆä¿¡ä»»å†…ç½‘ï¼‰

å®æ–½è¦ç‚¹ï¼š
â€¢ å¤–éƒ¨è¯·æ±‚ä¸¥æ ¼éªŒè¯
â€¢ å†…éƒ¨æœåŠ¡é€‚åº¦ç®€åŒ–
â€¢ å…³é”®é“¾è·¯åŠ å¼ºé˜²æŠ¤
â€¢ å®šæœŸå®¡æŸ¥æƒé™é…ç½®
```

### 9.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å­¦ä¹ è¿›é˜¶è·¯çº¿**ï¼š

```
é˜¶æ®µä¸€ï¼šåŸºç¡€è®¤çŸ¥
â€¢ ç†è§£è®¤è¯ä¸æˆæƒçš„åŒºåˆ«
â€¢ æŒæ¡JWTåŸºæœ¬åŸç†
â€¢ å­¦ä¼šSpring SecurityåŸºç¡€é…ç½®
â€¢ å®è·µç®€å•çš„ç™»å½•è®¤è¯

é˜¶æ®µäºŒï¼šæ·±å…¥åº”ç”¨
â€¢ æŒæ¡OAuth2å››ç§æ¨¡å¼
â€¢ å®ç°è¯·æ±‚ç­¾åéªŒè¯
â€¢ é…ç½®SSLåŒå‘è®¤è¯
â€¢ æ­å»ºæƒé™ç®¡ç†ç³»ç»Ÿ

é˜¶æ®µä¸‰ï¼šç”Ÿäº§å®æˆ˜
â€¢ è®¾è®¡ä¼ä¸šçº§å®‰å…¨æ¶æ„
â€¢ å®ç°é›¶ä¿¡ä»»å®‰å…¨æ¨¡å‹
â€¢ æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§
â€¢ åº”æ€¥å“åº”æ–¹æ¡ˆ

é˜¶æ®µå››ï¼šä¸“å®¶è¿›é˜¶
â€¢ ç ”ç©¶å®‰å…¨æ¼æ´ä¸é˜²æŠ¤
â€¢ å­¦ä¹ å¯†ç å­¦åŸºç¡€
â€¢ äº†è§£åŒºå—é“¾åœ¨è®¤è¯ä¸­çš„åº”ç”¨
â€¢ å…³æ³¨å®‰å…¨æŠ€æœ¯å‘å±•è¶‹åŠ¿
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- å®‰å…¨è®¤è¯æ˜¯å¾®æœåŠ¡çš„ç”Ÿå‘½çº¿ï¼Œå¿…é¡»é‡è§†
- JWTé€‚åˆå¤§éƒ¨åˆ†åœºæ™¯ï¼ŒOAuth2å¤„ç†ç¬¬ä¸‰æ–¹æˆæƒ
- ç­¾åéªŒè¯é˜²ç¯¡æ”¹ï¼ŒåŒå‘SSLé‡‘èçº§å®‰å…¨
- æƒé™æ§åˆ¶è¦ç»†ç²’åº¦ï¼Œå®¡è®¡æ—¥å¿—ä¸èƒ½å°‘
- å®‰å…¨ä¸æ€§èƒ½è¦å¹³è¡¡ï¼Œåˆ†çº§é˜²æŠ¤æ˜¯å…³é”®

**æ ¸å¿ƒç†å¿µ**ï¼šå®‰å…¨æ— å°äº‹ï¼Œé˜²èŒƒäºæœªç„¶ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯æ½œåœ¨çš„æ”»å‡»å…¥å£ï¼Œåªæœ‰å»ºç«‹å®Œå–„çš„å®‰å…¨ä½“ç³»ï¼Œæ‰èƒ½ä¿éšœç³»ç»Ÿç¨³å®šè¿è¡Œã€‚è®°ä½ï¼šå®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œï¼