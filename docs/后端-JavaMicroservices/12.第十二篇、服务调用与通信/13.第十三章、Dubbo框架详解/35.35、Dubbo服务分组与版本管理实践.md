---
title: 35ã€DubboæœåŠ¡åˆ†ç»„ä¸ç‰ˆæœ¬ç®¡ç†å®è·µ
---
## ğŸ“š ç›®å½•


1. [æœåŠ¡åˆ†ç»„ä¸ç‰ˆæœ¬ç®¡ç†åŸºç¡€](#1-æœåŠ¡åˆ†ç»„ä¸ç‰ˆæœ¬ç®¡ç†åŸºç¡€)
2. [Groupåˆ†ç»„ç­–ç•¥è¯¦è§£](#2-Groupåˆ†ç»„ç­–ç•¥è¯¦è§£)
3. [Versionç‰ˆæœ¬æ§åˆ¶å®è·µ](#3-Versionç‰ˆæœ¬æ§åˆ¶å®è·µ)
4. [å¤šç‰ˆæœ¬å¹¶å­˜æ–¹æ¡ˆ](#4-å¤šç‰ˆæœ¬å¹¶å­˜æ–¹æ¡ˆ)
5. [ç°åº¦å‘å¸ƒå®è·µ](#5-ç°åº¦å‘å¸ƒå®è·µ)
6. [è“ç»¿éƒ¨ç½²ç­–ç•¥](#6-è“ç»¿éƒ¨ç½²ç­–ç•¥)
7. [é‡‘ä¸é›€å‘å¸ƒæ–¹æ¡ˆ](#7-é‡‘ä¸é›€å‘å¸ƒæ–¹æ¡ˆ)
8. [åŒç‰ˆæœ¬å…¼å®¹è®¾è®¡](#8-åŒç‰ˆæœ¬å…¼å®¹è®¾è®¡)
9. [å¹³æ»‘å‡çº§å®æˆ˜](#9-å¹³æ»‘å‡çº§å®æˆ˜)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡DubboåŸºç¡€é…ç½®ã€æœåŠ¡æ³¨å†Œä¸å‘ç° â†’ **å½“å‰å†…å®¹**ï¼šæœåŠ¡åˆ†ç»„ä¸ç‰ˆæœ¬ç®¡ç† â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ åˆ†å¸ƒå¼äº‹åŠ¡ã€æœåŠ¡ç›‘æ§

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µç»ƒä¹ 60åˆ†é’Ÿ

**ğŸ·ï¸ çŸ¥è¯†æ ‡ç­¾**ï¼š`#æœåŠ¡æ²»ç†` `#ç‰ˆæœ¬æ§åˆ¶` `#å‘å¸ƒç­–ç•¥` `#æ ¸å¿ƒæŠ€èƒ½`

---

## 1. ğŸŒŸ æœåŠ¡åˆ†ç»„ä¸ç‰ˆæœ¬ç®¡ç†åŸºç¡€



### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç»„å’Œç‰ˆæœ¬ç®¡ç†



**ğŸ¤” ç°å®åœºæ™¯ç†è§£**

æƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¿é”é¤å…ï¼š
- **æ²¡æœ‰åˆ†ç»„ç®¡ç†**ï¼šæ‰€æœ‰åˆ†åº—å…±ç”¨ä¸€ä¸ªèœå•ï¼Œæ— æ³•åŒºåˆ†åœ°åŒºå·®å¼‚
- **æ²¡æœ‰ç‰ˆæœ¬ç®¡ç†**ï¼šèœå“å‡çº§æ—¶ï¼Œæ‰€æœ‰åˆ†åº—å¿…é¡»åŒæ—¶æ›´æ¢ï¼Œé£é™©å·¨å¤§

```
å®é™…å¾®æœåŠ¡åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡ 1.0 ç‰ˆæœ¬ï¼ˆè€ç‰ˆæœ¬ï¼‰         â”‚
â”‚  - åªæ”¯æŒåŸºç¡€åŠŸèƒ½                    â”‚
â”‚  - ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ åŒæ—¶å­˜åœ¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡ 2.0 ç‰ˆæœ¬ï¼ˆæ–°ç‰ˆæœ¬ï¼‰         â”‚
â”‚  - å¢åŠ æ–°åŠŸèƒ½                        â”‚
â”‚  - éœ€è¦é€æ­¥éªŒè¯                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šä¸¤ä¸ªç‰ˆæœ¬å¦‚ä½•åŒºåˆ†ï¼Ÿå¦‚ä½•è®©è°ƒç”¨æ–¹é€‰æ‹©ï¼Ÿ
ç­”æ¡ˆï¼šé€šè¿‡ Group å’Œ Version æœºåˆ¶
```

### 1.2 Group å’Œ Version çš„æ ¸å¿ƒåŒºåˆ«



**ğŸ” æ¦‚å¿µå¯¹æ¯”**

| ç»´åº¦ | **Groupï¼ˆåˆ†ç»„ï¼‰** | **Versionï¼ˆç‰ˆæœ¬ï¼‰** |
|------|------------------|-------------------|
| **ä½œç”¨** | ä¸šåŠ¡éš”ç¦»ã€ç¯å¢ƒéš”ç¦» | ä»£ç è¿­ä»£ã€åŠŸèƒ½å‡çº§ |
| **ä½¿ç”¨åœºæ™¯** | å¤šç§Ÿæˆ·ã€ABæµ‹è¯• | ç°åº¦å‘å¸ƒã€ç‰ˆæœ¬å…±å­˜ |
| **æ˜¯å¦åŒæ—¶å­˜åœ¨** | å¯ä»¥å¤šä¸ªç»„å…±å­˜ | å¯ä»¥å¤šä¸ªç‰ˆæœ¬å…±å­˜ |
| **å…¸å‹æ¡ˆä¾‹** | VIPç”¨æˆ·ç»„ã€æ™®é€šç”¨æˆ·ç»„ | v1.0ã€v2.0ã€v3.0 |

**ğŸ’¡ é€šä¿—ç†è§£**
- **Group**ï¼šå°±åƒç»™æœåŠ¡è´´ä¸Š"æ ‡ç­¾"ï¼Œæ¯”å¦‚"åŒ—äº¬ç»„"ã€"ä¸Šæµ·ç»„"
- **Version**ï¼šå°±åƒè½¯ä»¶çš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚"1.0ç‰ˆ"ã€"2.0ç‰ˆ"

### 1.3 æ ¸å¿ƒåº”ç”¨åœºæ™¯



**ğŸ¯ å¸¸è§ä½¿ç”¨åœºæ™¯**

**åœºæ™¯1ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿ**
```
ç”µå•†å¹³å°çš„å•†å®¶æœåŠ¡ï¼š
- Group: enterpriseï¼ˆä¼ä¸šå•†å®¶ï¼‰
- Group: personalï¼ˆä¸ªäººå•†å®¶ï¼‰

ä¸åŒç»„ä½¿ç”¨ä¸åŒçš„è®¡è´¹ç­–ç•¥ã€æƒé™æ§åˆ¶
```

**åœºæ™¯2ï¼šæ–°åŠŸèƒ½æµ‹è¯•**
```
æ”¯ä»˜æœåŠ¡å‡çº§ï¼š
- Version: 1.0.0ï¼ˆç¨³å®šç‰ˆï¼ŒæœåŠ¡å¤§éƒ¨åˆ†ç”¨æˆ·ï¼‰
- Version: 2.0.0ï¼ˆæµ‹è¯•ç‰ˆï¼ŒåªæœåŠ¡å†…éƒ¨å‘˜å·¥ï¼‰

é€æ­¥éªŒè¯åå†å…¨é‡å‘å¸ƒ
```

---

## 2. ğŸ·ï¸ Groupåˆ†ç»„ç­–ç•¥è¯¦è§£



### 2.1 Group çš„åŸºæœ¬ä½¿ç”¨



**ğŸ“ æœåŠ¡æä¾›æ–¹é…ç½®**

```java
// æ–¹å¼1ï¼šæ³¨è§£é…ç½®
@Service(group = "vip", version = "1.0.0")
public class VipUserServiceImpl implements UserService {
    
    @Override
    public User getUserById(Long id) {
        // VIPç”¨æˆ·ä¸“å±é€»è¾‘
        return queryVipUser(id);
    }
}

@Service(group = "normal", version = "1.0.0")
public class NormalUserServiceImpl implements UserService {
    
    @Override
    public User getUserById(Long id) {
        // æ™®é€šç”¨æˆ·é€»è¾‘
        return queryNormalUser(id);
    }
}
```

**å…³é”®ç†è§£**ï¼š
- åŒä¸€ä¸ªæ¥å£ `UserService`ï¼Œæœ‰ä¸¤ä¸ªå®ç°ç±»
- é€šè¿‡ `group` åŒºåˆ†ï¼Œåˆ†åˆ«æœåŠ¡ä¸åŒç±»å‹çš„ç”¨æˆ·
- ç±»ä¼¼äºç»™æœåŠ¡è´´ä¸Š"VIPä¸“ç”¨"ã€"æ™®é€šä¸“ç”¨"çš„æ ‡ç­¾

**ğŸ“ æœåŠ¡æ¶ˆè´¹æ–¹é…ç½®**

```java
// è°ƒç”¨VIPæœåŠ¡
@Reference(group = "vip", version = "1.0.0")
private UserService vipUserService;

// è°ƒç”¨æ™®é€šæœåŠ¡
@Reference(group = "normal", version = "1.0.0")
private UserService normalUserService;

// ä¸šåŠ¡ä»£ç ä¸­æ ¹æ®ç”¨æˆ·ç±»å‹é€‰æ‹©
public User getUser(Long userId, String userType) {
    if ("VIP".equals(userType)) {
        return vipUserService.getUserById(userId);
    } else {
        return normalUserService.getUserById(userId);
    }
}
```

### 2.2 Group åˆ†ç»„ç­–ç•¥æ¨¡å¼



**ğŸ”¸ ç­–ç•¥1ï¼šç¯å¢ƒéš”ç¦»åˆ†ç»„**

```
å¼€å‘ç¯å¢ƒï¼šgroup = "dev"
æµ‹è¯•ç¯å¢ƒï¼šgroup = "test"  
ç”Ÿäº§ç¯å¢ƒï¼šgroup = "prod"

å¥½å¤„ï¼šä¸åŒç¯å¢ƒçš„æœåŠ¡å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
```

```java
// application.yml é…ç½®
dubbo:
  provider:
    group: ${spring.profiles.active}  # dev/test/prod
```

**ğŸ”¸ ç­–ç•¥2ï¼šä¸šåŠ¡åœºæ™¯åˆ†ç»„**

```
åœºæ™¯ï¼šç”µå•†å¹³å°çš„è®¢å•æœåŠ¡

- group: "seckill"    â†’ ç§’æ€è®¢å•ï¼ˆé«˜å¹¶å‘ä¼˜åŒ–ï¼‰
- group: "normal"     â†’ æ™®é€šè®¢å•ï¼ˆæ ‡å‡†æµç¨‹ï¼‰
- group: "presale"    â†’ é¢„å”®è®¢å•ï¼ˆç‰¹æ®Šè§„åˆ™ï¼‰
```

```java
@Service(group = "seckill")
public class SeckillOrderService implements OrderService {
    // ç§’æ€ä¸“ç”¨é€»è¾‘ï¼šåº“å­˜é¢„æ‰£ã€å¿«é€Ÿå“åº”
}

@Service(group = "normal")  
public class NormalOrderService implements OrderService {
    // æ™®é€šè®¢å•é€»è¾‘ï¼šå®Œæ•´æ ¡éªŒã€è¥é”€è®¡ç®—
}
```

**ğŸ”¸ ç­–ç•¥3ï¼šç§Ÿæˆ·éš”ç¦»åˆ†ç»„**

```
SaaSç³»ç»Ÿçš„å¤šç§Ÿæˆ·åœºæ™¯ï¼š

- group: "tenant_001"  â†’ ç§Ÿæˆ·Aä¸“ç”¨æœåŠ¡
- group: "tenant_002"  â†’ ç§Ÿæˆ·Bä¸“ç”¨æœåŠ¡
- group: "default"     â†’ é€šç”¨æœåŠ¡
```

### 2.3 Group çš„é«˜çº§ç‰¹æ€§



**âš™ï¸ ç‰¹æ€§1ï¼šåˆ†ç»„èšåˆè°ƒç”¨**

å½“ä½ ä¸ç¡®å®šè¦è°ƒç”¨å“ªä¸ªåˆ†ç»„æ—¶ï¼Œå¯ä»¥èšåˆè°ƒç”¨ï¼š

```java
// è°ƒç”¨æ‰€æœ‰åˆ†ç»„ï¼Œå–ç¬¬ä¸€ä¸ªæˆåŠŸçš„ç»“æœ
@Reference(group = "*")
private UserService userService;

// è°ƒç”¨æ‰€æœ‰åˆ†ç»„ï¼Œåˆå¹¶æ‰€æœ‰ç»“æœ
@Reference(group = "*", merger = "true")
private List<User> getAllUsers();
```

**ğŸ’¡ ç†è§£**ï¼š
- `group = "*"` è¡¨ç¤º"ä¸é™åˆ†ç»„"
- å°±åƒæ‰“ç”µè¯æ—¶"ç¾¤å‘¼"ï¼Œè°å…ˆæ¥é€šå°±ç”¨è°çš„

**âš™ï¸ ç‰¹æ€§2ï¼šåŠ¨æ€åˆ†ç»„è·¯ç”±**

```java
// è‡ªå®šä¹‰è·¯ç”±è§„åˆ™
public class UserTypeRouter implements Router {
    
    @Override
    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers, 
                                       URL url, Invocation invocation) {
        // è·å–ç”¨æˆ·ç±»å‹å‚æ•°
        String userType = RpcContext.getContext()
                                    .getAttachment("userType");
        
        // æ ¹æ®ç”¨æˆ·ç±»å‹é€‰æ‹©åˆ†ç»„
        String targetGroup = "VIP".equals(userType) ? "vip" : "normal";
        
        // è¿‡æ»¤å‡ºç›®æ ‡åˆ†ç»„çš„æœåŠ¡
        return invokers.stream()
            .filter(inv -> targetGroup.equals(inv.getUrl().getParameter("group")))
            .collect(Collectors.toList());
    }
}
```

**ä½œç”¨**ï¼šæ ¹æ®è¯·æ±‚å‚æ•°åŠ¨æ€é€‰æ‹©æœåŠ¡åˆ†ç»„

---

## 3. ğŸ”¢ Versionç‰ˆæœ¬æ§åˆ¶å®è·µ



### 3.1 Version çš„åŸºæœ¬åŸç†



**ğŸ” ç‰ˆæœ¬å·è§„åˆ™**

```
è¯­ä¹‰åŒ–ç‰ˆæœ¬å·æ ¼å¼ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢å·
ä¾‹å¦‚ï¼š2.1.3

- ä¸»ç‰ˆæœ¬(2)ï¼šä¸å…¼å®¹çš„APIä¿®æ”¹
- æ¬¡ç‰ˆæœ¬(1)ï¼šå‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ–°å¢
- ä¿®è®¢å·(3)ï¼šå‘ä¸‹å…¼å®¹çš„bugä¿®å¤
```

**ğŸ“‹ Dubbo ç‰ˆæœ¬é…ç½®ç¤ºä¾‹**

```java
// æœåŠ¡æä¾›æ–¹ - æ—§ç‰ˆæœ¬
@Service(version = "1.0.0")
public class UserServiceV1 implements UserService {
    
    @Override
    public User getUser(Long id) {
        // æ—§ç‰ˆé€»è¾‘ï¼šåªè¿”å›åŸºæœ¬ä¿¡æ¯
        return new User(id, "å¼ ä¸‰");
    }
}

// æœåŠ¡æä¾›æ–¹ - æ–°ç‰ˆæœ¬
@Service(version = "2.0.0")
public class UserServiceV2 implements UserService {
    
    @Override
    public User getUser(Long id) {
        // æ–°ç‰ˆé€»è¾‘ï¼šè¿”å›è¯¦ç»†ä¿¡æ¯ + ç§¯åˆ†
        User user = new User(id, "å¼ ä¸‰");
        user.setPoints(loadUserPoints(id));
        return user;
    }
}
```

### 3.2 Version çš„å®é™…åº”ç”¨



**ğŸ¯ åœºæ™¯1ï¼šæ¥å£å‡çº§è¿‡æ¸¡**

```
æŸå…¬å¸ç”¨æˆ·æœåŠ¡æ¥å£å‡çº§ï¼š

æ—§æ¥å£ï¼šgetUserInfo(Long id)
æ–°æ¥å£ï¼šgetUserInfo(Long id, Boolean includePoints)

è§£å†³æ–¹æ¡ˆï¼š
1. æ–°ç‰ˆæœ¬(2.0.0)æä¾›æ–°æ¥å£
2. æ—§ç‰ˆæœ¬(1.0.0)ç»§ç»­æœåŠ¡è€å®¢æˆ·ç«¯
3. è€å®¢æˆ·ç«¯é€æ­¥å‡çº§
```

```java
// æ¶ˆè´¹æ–¹çµæ´»é€‰æ‹©ç‰ˆæœ¬
@Reference(version = "1.0.0")  // è€ç³»ç»Ÿä½¿ç”¨æ—§ç‰ˆ
private UserService userServiceOld;

@Reference(version = "2.0.0")  // æ–°ç³»ç»Ÿä½¿ç”¨æ–°ç‰ˆ
private UserService userServiceNew;
```

**ğŸ¯ åœºæ™¯2ï¼šç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†**

```java
// é…ç½®ï¼šè°ƒç”¨æ–°ç‰ˆæœ¬ï¼Œå¤±è´¥æ—¶é™çº§åˆ°æ—§ç‰ˆæœ¬
@Reference(version = "2.0.0,1.0.0")
private UserService userService;
```

**ğŸ’¡ ç†è§£**ï¼š
- é€—å·åˆ†éš”å¤šä¸ªç‰ˆæœ¬å·
- ä¼˜å…ˆè°ƒç”¨ 2.0.0ï¼Œå¦‚æœä¸å¯ç”¨åˆ™è°ƒç”¨ 1.0.0
- ç±»ä¼¼äº"é¦–é€‰èˆªç­ï¼Œå¤‡é€‰èˆªç­"çš„æ¦‚å¿µ

### 3.3 ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ



**âœ… å®è·µ1ï¼šç‰ˆæœ¬å·å‘½åè§„èŒƒ**

```
æ¨èæ ¼å¼ï¼š
- ç¨³å®šç‰ˆï¼š1.0.0, 2.0.0
- æµ‹è¯•ç‰ˆï¼š1.0.0-SNAPSHOT, 2.0.0-RC1
- ç‰¹æ€§ç‰ˆï¼š2.1.0-feature-payment

ä¸æ¨èï¼š
- v1, v2ï¼ˆå¤ªæ¨¡ç³Šï¼‰
- 20231201ï¼ˆæ—¥æœŸç‰ˆæœ¬ï¼Œä¸ä½“ç°å…¼å®¹æ€§ï¼‰
```

**âœ… å®è·µ2ï¼šç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```
ç‰ˆæœ¬çŠ¶æ€æµè½¬ï¼š
å¼€å‘ä¸­(SNAPSHOT) â†’ æµ‹è¯•ä¸­(RC) â†’ ç¨³å®šç‰ˆ(RELEASE) â†’ åºŸå¼ƒ(DEPRECATED)

ç¤ºä¾‹ï¼š
2.0.0-SNAPSHOT  â†’ 2.0.0-RC1 â†’ 2.0.0 â†’ 1.0.0(å·²åºŸå¼ƒ)
```

**âœ… å®è·µ3ï¼šç‰ˆæœ¬é…ç½®åŒ–**

```yaml
# application.yml

dubbo:
  provider:
    version: ${service.version:1.0.0}  # æ”¯æŒé…ç½®æ–‡ä»¶æŒ‡å®š

# å¯åŠ¨å‚æ•°

java -jar app.jar --service.version=2.0.0
```

---

## 4. ğŸ”„ å¤šç‰ˆæœ¬å¹¶å­˜æ–¹æ¡ˆ



### 4.1 å¤šç‰ˆæœ¬å¹¶å­˜çš„å¿…è¦æ€§



**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å¤šç‰ˆæœ¬å¹¶å­˜ï¼Ÿ**

```
ä¼ ç»Ÿå•ç‰ˆæœ¬å‡çº§çš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.0 æœåŠ¡   â”‚  â† æ‰€æœ‰ç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ å‡çº§ï¼ˆå¼ºåˆ¶åˆ‡æ¢ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v2.0 æœåŠ¡   â”‚  â† æ‰€æœ‰ç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é£é™©ï¼šæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œæ‰€æœ‰ç”¨æˆ·å—å½±å“

å¤šç‰ˆæœ¬å¹¶å­˜æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v1.0 æœåŠ¡   â”‚  â† å¤§éƒ¨åˆ†ç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        +
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  v2.0 æœåŠ¡   â”‚  â† å°éƒ¨åˆ†æµ‹è¯•ç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼šå¯æ§åˆ¶çš„é€æ­¥å‡çº§ï¼Œé™ä½é£é™©
```

### 4.2 å¤šç‰ˆæœ¬éƒ¨ç½²æ¶æ„



**ğŸ—ï¸ æ¶æ„è®¾è®¡ç¤ºä¾‹**

```
                  æ³¨å†Œä¸­å¿ƒ(Nacos/Zookeeper)
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                   â†“
  [v1.0 æä¾›è€…é›†ç¾¤]                  [v2.0 æä¾›è€…é›†ç¾¤]
   - æœåŠ¡å™¨A (v1.0)                  - æœåŠ¡å™¨D (v2.0)
   - æœåŠ¡å™¨B (v1.0)                  - æœåŠ¡å™¨E (v2.0)
   - æœåŠ¡å™¨C (v1.0)
        â†‘                                   â†‘
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                   â†“                 â†“
            [è€ç‰ˆæœ¬æ¶ˆè´¹è€…]      [æ–°ç‰ˆæœ¬æ¶ˆè´¹è€…]
           (version=1.0.0)    (version=2.0.0)
```

**ğŸ“ é…ç½®å®ç°**

```yaml
# æœåŠ¡æä¾›è€…é…ç½®

dubbo:
  application:
    name: order-service
  protocol:
    name: dubbo
    port: 20880
  registry:
    address: nacos://127.0.0.1:8848
  provider:
    version: 2.0.0  # æ–°ç‰ˆæœ¬æ ‡è¯†
    group: default
```

```java
// æä¾›è€…ä»£ç 
@Service(version = "2.0.0", timeout = 5000)
public class OrderServiceV2 implements OrderService {
    
    @Override
    public Order createOrder(OrderRequest request) {
        // æ–°ç‰ˆæœ¬é€»è¾‘ï¼šæ”¯æŒä¼˜æƒ åˆ¸
        return processOrderWithCoupon(request);
    }
}
```

### 4.3 å¤šç‰ˆæœ¬è·¯ç”±ç­–ç•¥



**ğŸ”€ ç­–ç•¥1ï¼šåŸºäºç”¨æˆ·æ ‡è¯†è·¯ç”±**

```java
// è‡ªå®šä¹‰è·¯ç”±å™¨
public class VersionRouter extends AbstractRouter {
    
    @Override
    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers, 
                                       URL url, Invocation invocation) {
        // ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
        String userId = RpcContext.getContext()
                                  .getAttachment("userId");
        
        // ç‰¹å®šç”¨æˆ·ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼ˆç™½åå•æœºåˆ¶ï¼‰
        if (isInWhitelist(userId)) {
            return filterByVersion(invokers, "2.0.0");
        }
        
        // å…¶ä»–ç”¨æˆ·ä½¿ç”¨æ—§ç‰ˆæœ¬
        return filterByVersion(invokers, "1.0.0");
    }
    
    private boolean isInWhitelist(String userId) {
        // ä»é…ç½®ä¸­å¿ƒè·å–ç™½åå•
        return configCenter.getWhitelist().contains(userId);
    }
}
```

**ğŸ”€ ç­–ç•¥2ï¼šæŒ‰æ¯”ä¾‹ç°åº¦**

```java
// é…ç½®10%æµé‡åˆ°æ–°ç‰ˆæœ¬
public class GrayRouter extends AbstractRouter {
    
    private static final int GRAY_PERCENTAGE = 10;
    
    @Override
    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers,
                                       URL url, Invocation invocation) {
        // æ ¹æ®ç”¨æˆ·IDå“ˆå¸Œå€¼å†³å®šç‰ˆæœ¬
        String userId = RpcContext.getContext().getAttachment("userId");
        int hash = Math.abs(userId.hashCode() % 100);
        
        if (hash < GRAY_PERCENTAGE) {
            return filterByVersion(invokers, "2.0.0");  // 10%æµé‡
        } else {
            return filterByVersion(invokers, "1.0.0");  // 90%æµé‡
        }
    }
}
```

---

## 5. ğŸš¦ ç°åº¦å‘å¸ƒå®è·µ



### 5.1 ç°åº¦å‘å¸ƒåŸç†



**ğŸ¯ ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ**

é€šä¿—ç†è§£ï¼šå°±åƒé¤å…è¯•èœ
- **ä¼ ç»Ÿå‘å¸ƒ**ï¼šæ–°èœå“ç›´æ¥ä¸Šæ¶ï¼Œæ‰€æœ‰å®¢äººéƒ½èƒ½ç‚¹
- **ç°åº¦å‘å¸ƒ**ï¼šå…ˆè®©å°‘æ•°å®¢äººè¯•åƒï¼Œå¥½è¯„åå†å…¨é¢æ¨å¹¿

```
ç°åº¦å‘å¸ƒæµç¨‹ï¼š
é˜¶æ®µ1: 5%ç”¨æˆ·  â†’ éªŒè¯åŸºæœ¬åŠŸèƒ½
é˜¶æ®µ2: 20%ç”¨æˆ· â†’ è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡  
é˜¶æ®µ3: 50%ç”¨æˆ· â†’ ç¡®è®¤ç¨³å®šæ€§
é˜¶æ®µ4: 100%ç”¨æˆ· â†’ å…¨é‡å‘å¸ƒ
```

### 5.2 åŸºäº Dubbo çš„ç°åº¦å®ç°



**ğŸ“‹ ç°åº¦é…ç½®æ–¹æ¡ˆ**

```java
// 1. æœåŠ¡æä¾›è€…ï¼šæ ‡è®°ç°åº¦ç‰ˆæœ¬
@Service(version = "2.0.0", 
         parameters = {"gray", "true"})
public class OrderServiceGray implements OrderService {
    // ç°åº¦ç‰ˆæœ¬é€»è¾‘
}

@Service(version = "1.0.0")
public class OrderServiceStable implements OrderService {
    // ç¨³å®šç‰ˆæœ¬é€»è¾‘
}
```

```java
// 2. æ¶ˆè´¹è€…ï¼šç°åº¦è·¯ç”±è§„åˆ™
@Component
public class GrayReleaseRouter implements Router {
    
    @Autowired
    private GrayRuleService grayRuleService;
    
    @Override
    public <T> List<Invoker<T>> route(List<Invoker<T>> invokers,
                                       URL url, Invocation invocation) {
        String userId = RpcContext.getContext().getAttachment("userId");
        
        // æŸ¥è¯¢ç°åº¦è§„åˆ™
        GrayRule rule = grayRuleService.getRule();
        
        if (rule.isGrayUser(userId)) {
            // ç°åº¦ç”¨æˆ· â†’ ä½¿ç”¨æ–°ç‰ˆæœ¬
            return invokers.stream()
                .filter(inv -> "true".equals(
                    inv.getUrl().getParameter("gray")))
                .collect(Collectors.toList());
        } else {
            // æ­£å¸¸ç”¨æˆ· â†’ ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
            return invokers.stream()
                .filter(inv -> !"true".equals(
                    inv.getUrl().getParameter("gray")))
                .collect(Collectors.toList());
        }
    }
}
```

### 5.3 ç°åº¦è§„åˆ™é…ç½®ä¸­å¿ƒ



**âš™ï¸ åŠ¨æ€ç°åº¦è§„åˆ™**

```yaml
# Nacosé…ç½®ç¤ºä¾‹

gray-rules:
  order-service:
    enabled: true
    strategy: percentage  # ç­–ç•¥ï¼šç™¾åˆ†æ¯”
    percentage: 10        # 10%æµé‡
    whitelist:           # ç™½åå•ç”¨æˆ·
      - user_001
      - user_002
    blacklist:           # é»‘åå•ç”¨æˆ·
      - user_999
```

```java
// åŠ¨æ€åŠ è½½ç°åº¦è§„åˆ™
@Component
public class GrayRuleService {
    
    @NacosValue(value = "${gray-rules.order-service.percentage}", 
                autoRefreshed = true)
    private int grayPercentage;
    
    @NacosValue(value = "${gray-rules.order-service.whitelist}", 
                autoRefreshed = true)
    private List<String> whitelist;
    
    public boolean isGrayUser(String userId) {
        // ç™½åå•ç”¨æˆ·ç›´æ¥è¿›å…¥ç°åº¦
        if (whitelist.contains(userId)) {
            return true;
        }
        
        // æŒ‰æ¯”ä¾‹éšæœºç°åº¦
        int hash = Math.abs(userId.hashCode() % 100);
        return hash < grayPercentage;
    }
}
```

**ğŸ’¡ å…³é”®ä¼˜åŠ¿**ï¼š
- è§„åˆ™å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒï¼Œå¯åŠ¨æ€è°ƒæ•´
- æ— éœ€é‡å¯æœåŠ¡ï¼Œå³æ—¶ç”Ÿæ•ˆ
- æ”¯æŒå¤šç»´åº¦ç°åº¦ç­–ç•¥

### 5.4 ç°åº¦ç›‘æ§ä¸å›æ»š



**ğŸ“Š ç›‘æ§æŒ‡æ ‡**

```java
@Component
public class GrayMonitor {
    
    @Autowired
    private MetricsService metrics;
    
    // ç›‘æ§ç°åº¦ç‰ˆæœ¬çš„å…³é”®æŒ‡æ ‡
    public void monitorGrayVersion() {
        // 1. æˆåŠŸç‡å¯¹æ¯”
        double graySuccessRate = metrics.getSuccessRate("2.0.0");
        double stableSuccessRate = metrics.getSuccessRate("1.0.0");
        
        // 2. å“åº”æ—¶é—´å¯¹æ¯”
        long grayAvgTime = metrics.getAvgResponseTime("2.0.0");
        long stableAvgTime = metrics.getAvgResponseTime("1.0.0");
        
        // 3. é”™è¯¯ç‡å¯¹æ¯”
        double grayErrorRate = metrics.getErrorRate("2.0.0");
        double stableErrorRate = metrics.getErrorRate("1.0.0");
        
        // è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ»š
        if (grayErrorRate > stableErrorRate * 1.5) {
            autoRollback("é”™è¯¯ç‡è¿‡é«˜");
        }
    }
    
    private void autoRollback(String reason) {
        log.warn("ç°åº¦å‘å¸ƒè‡ªåŠ¨å›æ»šï¼š{}", reason);
        // å…³é—­ç°åº¦æµé‡
        grayRuleService.disableGray();
        // å‘é€å‘Šè­¦
        alertService.send("ç°åº¦å›æ»š", reason);
    }
}
```

---

## 6. ğŸ”µğŸŸ¢ è“ç»¿éƒ¨ç½²ç­–ç•¥



### 6.1 è“ç»¿éƒ¨ç½²æ¦‚å¿µ



**ğŸ¨ è“ç»¿éƒ¨ç½²æ˜¯ä»€ä¹ˆï¼Ÿ**

å½¢è±¡æ¯”å–»ï¼šå°±åƒèˆå°ä¸Šçš„ä¸¤ç»„æ¼”å‘˜
- **è“è‰²ç¯å¢ƒ**ï¼šå½“å‰æ­£åœ¨è¡¨æ¼”çš„ä¸€ç»„ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **ç»¿è‰²ç¯å¢ƒ**ï¼šåå°å‡†å¤‡çš„ä¸€ç»„ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
- **åˆ‡æ¢**ï¼šç¯å…‰ä¸€è½¬ï¼Œç»¿è‰²ä¸Šå°ï¼Œè“è‰²ä¸‹å°

```
è“ç»¿éƒ¨ç½²æ¶æ„ï¼š
                     è´Ÿè½½å‡è¡¡å™¨
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                 â†“
  [è“è‰²ç¯å¢ƒ v1.0]                   [ç»¿è‰²ç¯å¢ƒ v2.0]
   - æ¥æ”¶100%æµé‡                    - å¾…å‘½çŠ¶æ€
   - ç”Ÿäº§ç¯å¢ƒ                        - å·²éƒ¨ç½²æ–°ç‰ˆæœ¬
        â†“                                 â†“
     (åˆ‡æ¢)                           (å‡†å¤‡æ¥ç®¡)
        â†“                                 â†“
  [è“è‰²ç¯å¢ƒ v1.0]                   [ç»¿è‰²ç¯å¢ƒ v2.0]
   - å¾…å‘½çŠ¶æ€                        - æ¥æ”¶100%æµé‡
   - ä¿ç•™ç”¨äºå›æ»š                    - æˆä¸ºæ–°ç”Ÿäº§ç¯å¢ƒ
```

### 6.2 Dubbo è“ç»¿éƒ¨ç½²å®ç°



**ğŸ“ é…ç½®æ–¹æ¡ˆ**

```java
// è“è‰²ç¯å¢ƒé…ç½®
@Service(version = "1.0.0", 
         group = "blue",
         weight = 100)  // æƒé‡100ï¼Œæ¥æ”¶å…¨éƒ¨æµé‡
public class OrderServiceBlue implements OrderService {
    // å½“å‰ç¨³å®šç‰ˆæœ¬
}

// ç»¿è‰²ç¯å¢ƒé…ç½®
@Service(version = "2.0.0",
         group = "green", 
         weight = 0)    // æƒé‡0ï¼Œä¸æ¥æ”¶æµé‡
public class OrderServiceGreen implements OrderService {
    // æ–°ç‰ˆæœ¬ï¼Œå¾…åˆ‡æ¢
}
```

**ğŸ”„ æµé‡åˆ‡æ¢å®ç°**

```java
@RestController
@RequestMapping("/admin/deploy")
public class BlueGreenController {
    
    @Autowired
    private RegistryService registryService;
    
    // è“ç»¿åˆ‡æ¢
    @PostMapping("/switch")
    public Result switchBlueGreen() {
        try {
            // 1. é¢„æ£€æŸ¥ï¼šç¡®è®¤ç»¿è‰²ç¯å¢ƒå¥åº·
            if (!healthCheck("green")) {
                return Result.error("ç»¿è‰²ç¯å¢ƒä¸å¥åº·ï¼Œåˆ‡æ¢ä¸­æ­¢");
            }
            
            // 2. è°ƒæ•´æƒé‡ï¼šè“è‰²â†’0ï¼Œç»¿è‰²â†’100
            updateWeight("blue", 0);
            updateWeight("green", 100);
            
            // 3. ç­‰å¾…è¿æ¥è¿ç§»
            Thread.sleep(5000);
            
            // 4. éªŒè¯åˆ‡æ¢ç»“æœ
            if (verifyTraffic("green")) {
                return Result.success("åˆ‡æ¢æˆåŠŸ");
            } else {
                // è‡ªåŠ¨å›æ»š
                rollbackSwitch();
                return Result.error("åˆ‡æ¢å¤±è´¥ï¼Œå·²å›æ»š");
            }
            
        } catch (Exception e) {
            rollbackSwitch();
            return Result.error("åˆ‡æ¢å¼‚å¸¸ï¼š" + e.getMessage());
        }
    }
    
    // å¥åº·æ£€æŸ¥
    private boolean healthCheck(String group) {
        List<URL> providers = registryService.lookup(
            "com.example.OrderService", group);
        
        for (URL provider : providers) {
            if (!pingService(provider)) {
                return false;
            }
        }
        return true;
    }
    
    // æ›´æ–°æœåŠ¡æƒé‡
    private void updateWeight(String group, int weight) {
        registryService.updateProviders(
            "com.example.OrderService",
            group,
            params -> params.put("weight", String.valueOf(weight))
        );
    }
}
```

### 6.3 è“ç»¿éƒ¨ç½²çš„ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹



**âœ… ä¸»è¦ä¼˜åŠ¿**
- **å¿«é€Ÿå›æ»š**ï¼šä¸€é”®åˆ‡æ¢å›è“è‰²ç¯å¢ƒ
- **é›¶åœæœº**ï¼šåˆ‡æ¢è¿‡ç¨‹ç”¨æˆ·æ— æ„ŸçŸ¥
- **éªŒè¯å……åˆ†**ï¼šç»¿è‰²ç¯å¢ƒå¯å……åˆ†æµ‹è¯•

**âš ï¸ æ³¨æ„äº‹é¡¹**
- **èµ„æºæˆæœ¬**ï¼šéœ€è¦åŒå€æœåŠ¡å™¨èµ„æº
- **æ•°æ®åŒæ­¥**ï¼šæ•°æ®åº“ç‰ˆæœ¬å…¼å®¹é—®é¢˜
- **ä¼šè¯ä¿æŒ**ï¼šåˆ‡æ¢æ—¶éœ€å¤„ç†ç”¨æˆ·ä¼šè¯

---

## 7. ğŸ¤ é‡‘ä¸é›€å‘å¸ƒæ–¹æ¡ˆ



### 7.1 é‡‘ä¸é›€å‘å¸ƒåŸç†



**ğŸ¦ åå­—ç”±æ¥**

å†å²èƒŒæ™¯ï¼šçŸ¿å·¥ä¸‹äº•å‰ä¼šå¸¦ä¸€åªé‡‘ä¸é›€
- é‡‘ä¸é›€å¯¹æœ‰æ¯’æ°”ä½“æ•æ„Ÿ
- é‡‘ä¸é›€å¼‚å¸¸ â†’ è¯´æ˜æœ‰å±é™©
- åº”ç”¨åˆ°è½¯ä»¶ï¼šå°‘é‡ç”¨æˆ·å…ˆä½“éªŒ â†’ å‘ç°é—®é¢˜ â†’ ä¿æŠ¤å…¶ä»–ç”¨æˆ·

**ğŸ“Š é‡‘ä¸é›€å‘å¸ƒæµç¨‹**

```
é˜¶æ®µåˆ’åˆ†ï¼š
ç¬¬1é˜¶æ®µ: 1%æµé‡  â†’ è§‚å¯Ÿ1å°æ—¶
ç¬¬2é˜¶æ®µ: 5%æµé‡  â†’ è§‚å¯Ÿ2å°æ—¶
ç¬¬3é˜¶æ®µ: 10%æµé‡ â†’ è§‚å¯Ÿ4å°æ—¶
ç¬¬4é˜¶æ®µ: 25%æµé‡ â†’ è§‚å¯Ÿ8å°æ—¶
ç¬¬5é˜¶æ®µ: 50%æµé‡ â†’ è§‚å¯Ÿ12å°æ—¶
ç¬¬6é˜¶æ®µ: 100%æµé‡ â†’ å…¨é‡å‘å¸ƒ

æ¯ä¸ªé˜¶æ®µéƒ½å¯æš‚åœæˆ–å›æ»š
```

### 7.2 é‡‘ä¸é›€å‘å¸ƒå®ç°



**ğŸ“ åŸºäºæƒé‡çš„é‡‘ä¸é›€**

```java
// æœåŠ¡æä¾›æ–¹
@Service(version = "2.0.0", weight = 1)  // é‡‘ä¸é›€ç‰ˆæœ¬ï¼Œåˆå§‹æƒé‡1
public class OrderServiceCanary implements OrderService {
    // æ–°ç‰ˆæœ¬é€»è¾‘
}

@Service(version = "1.0.0", weight = 99) // ç¨³å®šç‰ˆæœ¬ï¼Œæƒé‡99
public class OrderServiceStable implements OrderService {
    // ç¨³å®šç‰ˆæœ¬é€»è¾‘
}
```

**æƒé‡è¯´æ˜**ï¼š
- æ€»æƒé‡ = 1 + 99 = 100
- é‡‘ä¸é›€ç‰ˆæœ¬æµé‡å æ¯” = 1/100 = 1%

**ğŸ”„ è‡ªåŠ¨åŒ–æƒé‡è°ƒæ•´**

```java
@Component
public class CanaryReleaseScheduler {
    
    @Autowired
    private MetricsCollector metrics;
    
    @Autowired
    private RegistryService registry;
    
    // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    @Scheduled(cron = "0 0 * * * ?")
    public void autoAdjustCanary() {
        CanaryMetrics current = metrics.getCanaryMetrics();
        
        // åˆ¤æ–­æŒ‡æ ‡æ˜¯å¦å¥åº·
        if (current.isHealthy()) {
            int currentWeight = getCurrentCanaryWeight();
            
            // é€æ­¥æå‡æƒé‡
            if (currentWeight < 100) {
                int newWeight = Math.min(currentWeight * 2, 100);
                updateCanaryWeight(newWeight);
                
                log.info("é‡‘ä¸é›€æµé‡æå‡ï¼š{}% â†’ {}%", 
                         currentWeight, newWeight);
            } else {
                log.info("é‡‘ä¸é›€å‘å¸ƒå®Œæˆï¼Œè¾¾åˆ°100%æµé‡");
                markReleaseComplete();
            }
        } else {
            // æŒ‡æ ‡å¼‚å¸¸ï¼Œè§¦å‘å›æ»š
            log.error("é‡‘ä¸é›€æŒ‡æ ‡å¼‚å¸¸ï¼Œæ‰§è¡Œå›æ»š");
            rollbackCanary();
        }
    }
    
    private void updateCanaryWeight(int newWeight) {
        // æ›´æ–°é‡‘ä¸é›€ç‰ˆæœ¬æƒé‡
        registry.updateProviders(
            "com.example.OrderService",
            "2.0.0",
            params -> params.put("weight", String.valueOf(newWeight))
        );
        
        // æ›´æ–°ç¨³å®šç‰ˆæœ¬æƒé‡
        int stableWeight = 100 - newWeight;
        registry.updateProviders(
            "com.example.OrderService",
            "1.0.0",
            params -> params.put("weight", String.valueOf(stableWeight))
        );
    }
}
```

### 7.3 é‡‘ä¸é›€ç›‘æ§æŒ‡æ ‡



**ğŸ“ˆ å…³é”®ç›‘æ§ç»´åº¦**

```java
@Data
public class CanaryMetrics {
    
    // 1. é”™è¯¯ç‡å¯¹æ¯”
    private double canaryErrorRate;
    private double stableErrorRate;
    
    // 2. å“åº”æ—¶é—´å¯¹æ¯”
    private long canaryAvgTime;
    private long stableAvgTime;
    
    // 3. æˆåŠŸç‡å¯¹æ¯”
    private double canarySuccessRate;
    private double stableSuccessRate;
    
    // 4. ä¸šåŠ¡æŒ‡æ ‡å¯¹æ¯”
    private double canaryConversionRate;  // è½¬åŒ–ç‡
    private double stableConversionRate;
    
    // å¥åº·åˆ¤æ–­é€»è¾‘
    public boolean isHealthy() {
        // é”™è¯¯ç‡ä¸èƒ½é«˜äºç¨³å®šç‰ˆ1.5å€
        if (canaryErrorRate > stableErrorRate * 1.5) {
            return false;
        }
        
        // å“åº”æ—¶é—´ä¸èƒ½é«˜äºç¨³å®šç‰ˆ1.3å€
        if (canaryAvgTime > stableAvgTime * 1.3) {
            return false;
        }
        
        // æˆåŠŸç‡ä¸èƒ½ä½äº95%
        if (canarySuccessRate < 0.95) {
            return false;
        }
        
        return true;
    }
}
```

---

## 8. ğŸ”— åŒç‰ˆæœ¬å…¼å®¹è®¾è®¡



### 8.1 ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬å…¼å®¹



**ğŸ¤” å…¼å®¹æ€§é—®é¢˜åœºæ™¯**

```
åœºæ™¯ï¼šç”¨æˆ·æœåŠ¡æ¥å£å‡çº§

æ—§æ¥å£ï¼ˆv1.0ï¼‰ï¼š
User getUser(Long id)  // è¿”å›åŸºæœ¬ä¿¡æ¯

æ–°æ¥å£ï¼ˆv2.0ï¼‰ï¼š  
UserDetail getUserDetail(Long id)  // è¿”å›è¯¦ç»†ä¿¡æ¯

é—®é¢˜ï¼š
- è€å®¢æˆ·ç«¯è°ƒç”¨v2.0æœåŠ¡ â†’ æ‰¾ä¸åˆ°æ–¹æ³•
- æ–°å®¢æˆ·ç«¯è°ƒç”¨v1.0æœåŠ¡ â†’ ç¼ºå°‘æ•°æ®

è§£å†³ï¼šåŒç‰ˆæœ¬å…¼å®¹è®¾è®¡
```

### 8.2 æ¥å£å…¼å®¹ç­–ç•¥



**ğŸ”¸ ç­–ç•¥1ï¼šé€‚é…å™¨æ¨¡å¼**

```java
// å®šä¹‰ç»Ÿä¸€æ¥å£
public interface UserService {
    User getUser(Long id);
}

// v1.0 å®ç°
@Service(version = "1.0.0")
public class UserServiceV1 implements UserService {
    @Override
    public User getUser(Long id) {
        return new User(id, "å¼ ä¸‰");
    }
}

// v2.0 å®ç°ï¼ˆå…¼å®¹v1.0ï¼‰
@Service(version = "2.0.0")
public class UserServiceV2 implements UserService {
    
    @Override
    public User getUser(Long id) {
        // è°ƒç”¨å†…éƒ¨è¯¦ç»†æ–¹æ³•
        UserDetail detail = getUserDetail(id);
        // é€‚é…ä¸ºæ—§ç‰ˆæœ¬æ ¼å¼
        return convertToUser(detail);
    }
    
    // æ–°ç‰ˆæœ¬ä¸“å±æ–¹æ³•
    public UserDetail getUserDetail(Long id) {
        return new UserDetail(id, "å¼ ä¸‰", 100, "VIP");
    }
    
    private User convertToUser(UserDetail detail) {
        return new User(detail.getId(), detail.getName());
    }
}
```

**ğŸ”¸ ç­–ç•¥2ï¼šå‚æ•°æ‰©å±•å…¼å®¹**

```java
// ä½¿ç”¨å¯é€‰å‚æ•°ï¼Œä¿æŒæ¥å£å…¼å®¹
public interface OrderService {
    
    // v1.0 æ–¹æ³•
    Order createOrder(Long userId, Long productId);
    
    // v2.0 æ–¹æ³•ï¼ˆæ–°å¢ä¼˜æƒ åˆ¸å‚æ•°ï¼‰
    default Order createOrder(Long userId, Long productId, String couponCode) {
        // é»˜è®¤å®ç°ï¼šä¸ä½¿ç”¨ä¼˜æƒ åˆ¸
        return createOrder(userId, productId);
    }
}

// v1.0 å®ç°
@Service(version = "1.0.0")
public class OrderServiceV1 implements OrderService {
    @Override
    public Order createOrder(Long userId, Long productId) {
        return new Order(userId, productId, 100.0);
    }
}

// v2.0 å®ç°
@Service(version = "2.0.0")
public class OrderServiceV2 implements OrderService {
    
    @Override
    public Order createOrder(Long userId, Long productId) {
        // å…¼å®¹æ—§ç‰ˆè°ƒç”¨
        return createOrder(userId, productId, null);
    }
    
    @Override
    public Order createOrder(Long userId, Long productId, String couponCode) {
        // æ–°ç‰ˆé€»è¾‘ï¼šæ”¯æŒä¼˜æƒ åˆ¸
        double price = calculatePrice(productId, couponCode);
        return new Order(userId, productId, price);
    }
}
```

### 8.3 æ•°æ®ç»“æ„å…¼å®¹



**ğŸ“¦ DTOç‰ˆæœ¬å…¼å®¹è®¾è®¡**

```java
// åŸºç¡€DTOï¼ˆv1.0ï¼‰
@Data
public class UserDTO {
    private Long id;
    private String name;
}

// æ‰©å±•DTOï¼ˆv2.0ï¼‰
@Data
public class UserDetailDTO extends UserDTO {
    private Integer points;     // æ–°å¢å­—æ®µ
    private String memberLevel; // æ–°å¢å­—æ®µ
    
    // æä¾›é™çº§æ–¹æ³•
    public UserDTO toBasicDTO() {
        UserDTO basic = new UserDTO();
        basic.setId(this.getId());
        basic.setName(this.getName());
        return basic;
    }
}
```

```java
// æ¶ˆè´¹æ–¹å…¼å®¹å¤„ç†
@Service
public class UserConsumerService {
    
    @Reference(version = "2.0.0,1.0.0", check = false)
    private UserService userService;
    
    public UserDTO getUser(Long id) {
        Object result = userService.getUser(id);
        
        // åˆ¤æ–­è¿”å›ç±»å‹
        if (result instanceof UserDetailDTO) {
            // v2.0 è¿”å›å€¼ï¼Œä½¿ç”¨è¯¦ç»†ä¿¡æ¯
            UserDetailDTO detail = (UserDetailDTO) result;
            return processDetailUser(detail);
        } else {
            // v1.0 è¿”å›å€¼ï¼Œä½¿ç”¨åŸºæœ¬ä¿¡æ¯
            UserDTO basic = (UserDTO) result;
            return processBasicUser(basic);
        }
    }
}
```

---

## 9. ğŸš€ å¹³æ»‘å‡çº§å®æˆ˜



### 9.1 å¹³æ»‘å‡çº§çš„æ ¸å¿ƒåŸåˆ™



**ğŸ¯ å‡çº§ä¸‰å¤§åŸåˆ™**

```
åŸåˆ™1ï¼šå‘åå…¼å®¹
- æ–°ç‰ˆæœ¬å¿…é¡»æ”¯æŒè€ç‰ˆæœ¬å®¢æˆ·ç«¯
- ä¸èƒ½åˆ é™¤è€ç‰ˆæœ¬çš„æ–¹æ³•
- æ–°å¢å­—æ®µæä¾›é»˜è®¤å€¼

åŸåˆ™2ï¼šåˆ†é˜¶æ®µå‘å¸ƒ
- å…ˆå‡çº§æœåŠ¡æä¾›æ–¹
- å†å‡çº§æœåŠ¡æ¶ˆè´¹æ–¹
- é¿å…"å¤§çˆ†ç‚¸"å¼å‡çº§

åŸåˆ™3ï¼šå¯å›æ»š
- æ¯ä¸ªé˜¶æ®µéƒ½èƒ½å¿«é€Ÿå›æ»š
- ä¿ç•™æ—§ç‰ˆæœ¬ä½œä¸ºå¤‡ä»½
- ç›‘æ§æŒ‡æ ‡å¼‚å¸¸ç«‹å³å›é€€
```

### 9.2 å¹³æ»‘å‡çº§å®Œæ•´æµç¨‹



**ğŸ“‹ å‡çº§æ­¥éª¤è¯¦è§£**

```
æ­¥éª¤1ï¼šåŒç‰ˆæœ¬å¹¶è¡Œï¼ˆWeek 1ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v1.0æœåŠ¡ â”‚ â† 90%æµé‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     +
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v2.0æœåŠ¡ â”‚ â† 10%æµé‡ï¼ˆç°åº¦ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2ï¼šé€æ­¥åˆ‡æµï¼ˆWeek 2-3ï¼‰
- Day 1-3:   20%æµé‡åˆ°v2.0
- Day 4-7:   50%æµé‡åˆ°v2.0
- Day 8-14:  80%æµé‡åˆ°v2.0

æ­¥éª¤3ï¼šå®Œå…¨åˆ‡æ¢ï¼ˆWeek 4ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v1.0æœåŠ¡ â”‚ â† ä¿ç•™å¤‡ä»½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     +
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v2.0æœåŠ¡ â”‚ â† 100%æµé‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤4ï¼šä¸‹çº¿æ—§ç‰ˆï¼ˆWeek 5-6ï¼‰
- è§‚å¯Ÿ2å‘¨æ— é—®é¢˜
- æ­£å¼ä¸‹çº¿v1.0
```

### 9.3 å¹³æ»‘å‡çº§å®æˆ˜æ¡ˆä¾‹



**ğŸ’¼ æ¡ˆä¾‹ï¼šè®¢å•æœåŠ¡å¹³æ»‘å‡çº§**

```java
// ===== ç¬¬1æ­¥ï¼šéƒ¨ç½²v2.0æœåŠ¡ï¼ˆç°åº¦æ¨¡å¼ï¼‰=====
@Service(version = "2.0.0", 
         group = "canary",
         weight = 10)  // 10%æµé‡
public class OrderServiceV2 implements OrderService {
    
    // æ–°åŠŸèƒ½ï¼šæ”¯æŒæ‹†å•
    public List<Order> createOrderWithSplit(OrderRequest request) {
        return splitAndCreate(request);
    }
    
    // å…¼å®¹æ—§æ¥å£
    @Override
    public Order createOrder(OrderRequest request) {
        // å•ä¸ªè®¢å•é€»è¾‘ï¼ˆå…¼å®¹v1.0ï¼‰
        return createSingleOrder(request);
    }
}

// ===== ç¬¬2æ­¥ï¼šç°åº¦æœŸé—´ç›‘æ§ =====
@Component
public class UpgradeMonitor {
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void monitorUpgrade() {
        // å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æŒ‡æ ‡
        Metrics v1 = metricsService.getMetrics("1.0.0");
        Metrics v2 = metricsService.getMetrics("2.0.0");
        
        // å…³é”®æŒ‡æ ‡æ£€æŸ¥
        if (v2.getErrorRate() > v1.getErrorRate() * 1.2) {
            log.error("v2.0é”™è¯¯ç‡å¼‚å¸¸ï¼Œæš‚åœå‡çº§");
            pauseUpgrade();
        }
        
        if (v2.getAvgTime() > v1.getAvgTime() * 1.5) {
            log.error("v2.0å“åº”å˜æ…¢ï¼Œæš‚åœå‡çº§");
            pauseUpgrade();
        }
        
        // æŒ‡æ ‡æ­£å¸¸ï¼Œç»§ç»­æå‡æµé‡
        if (v2.isHealthy()) {
            increaseTraffic();
        }
    }
}

// ===== ç¬¬3æ­¥ï¼šè‡ªåŠ¨æµé‡è°ƒæ•´ =====
@Service
public class TrafficSwitcher {
    
    private int currentPercentage = 10; // å½“å‰v2.0æµé‡å æ¯”
    
    public void increaseTraffic() {
        if (currentPercentage >= 100) {
            log.info("å‡çº§å®Œæˆï¼Œv2.0å·²æ¥ç®¡100%æµé‡");
            return;
        }
        
        // æ¯æ¬¡æå‡10%
        currentPercentage = Math.min(currentPercentage + 10, 100);
        
        // æ›´æ–°æƒé‡é…ç½®
        updateServiceWeight("2.0.0", currentPercentage);
        updateServiceWeight("1.0.0", 100 - currentPercentage);
        
        log.info("æµé‡åˆ‡æ¢ï¼šv2.0={}%, v1.0={}%", 
                 currentPercentage, 100 - currentPercentage);
    }
}

// ===== ç¬¬4æ­¥ï¼šå›æ»šæœºåˆ¶ =====
@RestController
@RequestMapping("/admin/upgrade")
public class UpgradeController {
    
    @PostMapping("/rollback")
    public Result rollbackVersion() {
        log.warn("æ‰§è¡Œç‰ˆæœ¬å›æ»š");
        
        // 1. ç«‹å³åˆ‡æ¢æµé‡åˆ°v1.0
        trafficSwitcher.setPercentage("1.0.0", 100);
        trafficSwitcher.setPercentage("2.0.0", 0);
        
        // 2. ä¸‹çº¿v2.0å®ä¾‹
        registryService.unregisterProviders("2.0.0");
        
        // 3. å‘é€å‘Šè­¦
        alertService.send("ç‰ˆæœ¬å›æ»š", "å·²å›æ»šåˆ°v1.0");
        
        return Result.success("å›æ»šæˆåŠŸ");
    }
}
```

### 9.4 å‡çº§æ£€æŸ¥æ¸…å•



**âœ… å‡çº§å‰æ£€æŸ¥**
- [ ] v2.0ç‰ˆæœ¬é€šè¿‡å®Œæ•´æµ‹è¯•
- [ ] å‡†å¤‡å¥½å›æ»šé¢„æ¡ˆ
- [ ] ç›‘æ§å‘Šè­¦è§„åˆ™å·²é…ç½®
- [ ] æ•°æ®åº“å˜æ›´å·²å…¼å®¹å¤„ç†
- [ ] é…ç½®ä¸­å¿ƒå‚æ•°å·²æ›´æ–°

**âœ… å‡çº§ä¸­ç›‘æ§**
- [ ] å®æ—¶ç›‘æ§é”™è¯¯ç‡
- [ ] å®æ—¶ç›‘æ§å“åº”æ—¶é—´
- [ ] å®æ—¶ç›‘æ§ä¸šåŠ¡æŒ‡æ ‡
- [ ] è§‚å¯Ÿæ—¥å¿—å¼‚å¸¸ä¿¡æ¯
- [ ] æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡å½±å“

**âœ… å‡çº§åéªŒè¯**
- [ ] æ ¸å¿ƒåŠŸèƒ½smoke test
- [ ] æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
- [ ] æ€§èƒ½åŸºå‡†å¯¹æ¯”
- [ ] ç”¨æˆ·åé¦ˆæ”¶é›†
- [ ] æ—§ç‰ˆæœ¬ä¿ç•™2å‘¨å¤‡ä»½

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ Groupåˆ†ç»„ï¼šä¸šåŠ¡éš”ç¦»ã€ç¯å¢ƒéš”ç¦»çš„æ ‡ç­¾æœºåˆ¶
ğŸ”¸ Versionç‰ˆæœ¬ï¼šä»£ç è¿­ä»£ã€åŠŸèƒ½å‡çº§çš„ç‰ˆæœ¬æ§åˆ¶
ğŸ”¸ å¤šç‰ˆæœ¬å¹¶å­˜ï¼šæ–°è€ç‰ˆæœ¬åŒæ—¶è¿è¡Œï¼Œé™ä½é£é™©
ğŸ”¸ ç°åº¦å‘å¸ƒï¼šå°èŒƒå›´éªŒè¯ï¼Œé€æ­¥æ”¾å¤§æµé‡
ğŸ”¸ è“ç»¿éƒ¨ç½²ï¼šä¸¤å¥—ç¯å¢ƒå¿«é€Ÿåˆ‡æ¢ï¼Œé›¶åœæœºå‘å¸ƒ
ğŸ”¸ é‡‘ä¸é›€å‘å¸ƒï¼šè‡ªåŠ¨åŒ–çš„æ¸è¿›å¼å‘å¸ƒç­–ç•¥
ğŸ”¸ ç‰ˆæœ¬å…¼å®¹ï¼šæ¥å£å‘åå…¼å®¹ï¼Œç¡®ä¿å¹³æ»‘å‡çº§
```

### 10.2 å…³é”®æŠ€æœ¯å¯¹æ¯”



| å‘å¸ƒç­–ç•¥ | **åˆ‡æ¢æ–¹å¼** | **é£é™©ç­‰çº§** | **å›æ»šé€Ÿåº¦** | **èµ„æºæˆæœ¬** |
|---------|------------|------------|------------|------------|
| **ç°åº¦å‘å¸ƒ** | é€æ­¥æå‡æµé‡ | â­â­ | â­â­â­ | â­â­ |
| **è“ç»¿éƒ¨ç½²** | ä¸€æ¬¡æ€§åˆ‡æ¢ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| **é‡‘ä¸é›€å‘å¸ƒ** | è‡ªåŠ¨åŒ–æ¸è¿› | â­ | â­â­â­â­ | â­â­ |
| **æ»šåŠ¨å‘å¸ƒ** | é€ä¸ªå®ä¾‹æ›¿æ¢ | â­â­ | â­â­ | â­ |

### 10.3 å®é™…åº”ç”¨å»ºè®®



**ğŸ¯ åœºæ™¯é€‰æ‹©æŒ‡å—**

```
å°å‹é¡¹ç›®ï¼ˆ<10ä¸ªæœåŠ¡ï¼‰ï¼š
æ¨èï¼šç°åº¦å‘å¸ƒ + æ‰‹åŠ¨åˆ‡æ¢
ç†ç”±ï¼šç®€å•å¯æ§ï¼Œèµ„æºæ¶ˆè€—å°

ä¸­å‹é¡¹ç›®ï¼ˆ10-50ä¸ªæœåŠ¡ï¼‰ï¼š
æ¨èï¼šé‡‘ä¸é›€å‘å¸ƒ + è‡ªåŠ¨åŒ–
ç†ç”±ï¼šæ•ˆç‡é«˜ï¼Œé£é™©å¯æ§

å¤§å‹é¡¹ç›®ï¼ˆ>50ä¸ªæœåŠ¡ï¼‰ï¼š
æ¨èï¼šè“ç»¿éƒ¨ç½² + é‡‘ä¸é›€ç»„åˆ
ç†ç”±ï¼šå¿«é€Ÿå›æ»šï¼Œç¨³å®šæ€§é«˜
```

**ğŸ”§ æœ€ä½³å®è·µæ€»ç»“**

```
é…ç½®ç®¡ç†ï¼š
- ç‰ˆæœ¬å·ä½¿ç”¨è¯­ä¹‰åŒ–è§„èŒƒï¼ˆx.y.zï¼‰
- åˆ†ç»„åç§°æ¸…æ™°è¡¨æ„ï¼ˆvip/normal/testï¼‰
- é…ç½®å¤–éƒ¨åŒ–ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´

å‘å¸ƒç­–ç•¥ï¼š
- æ°¸è¿œå‡†å¤‡å›æ»šé¢„æ¡ˆ
- å…³é”®æŒ‡æ ‡å®æ—¶ç›‘æ§
- åˆ†é˜¶æ®µé€æ­¥æ”¾é‡

å…¼å®¹è®¾è®¡ï¼š
- æ¥å£å‘åå…¼å®¹ä¼˜å…ˆ
- æ–°å¢å­—æ®µæä¾›é»˜è®¤å€¼
- æ•°æ®ç»“æ„å¹³æ»‘æ¼”è¿›
```

### 10.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



**ğŸ† æŒæ¡ç¨‹åº¦è‡ªæµ‹**

- [ ] èƒ½è§£é‡ŠGroupå’ŒVersionçš„åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯
- [ ] èƒ½é…ç½®åŸºäºGroupçš„æœåŠ¡åˆ†ç»„
- [ ] èƒ½é…ç½®åŸºäºVersionçš„å¤šç‰ˆæœ¬å¹¶å­˜
- [ ] ç†è§£ç°åº¦å‘å¸ƒçš„æ ¸å¿ƒåŸç†
- [ ] èƒ½å®ç°ç®€å•çš„ç°åº¦è·¯ç”±è§„åˆ™
- [ ] ç†è§£è“ç»¿éƒ¨ç½²çš„åˆ‡æ¢æµç¨‹
- [ ] èƒ½è®¾è®¡é‡‘ä¸é›€å‘å¸ƒçš„ç›‘æ§æŒ‡æ ‡
- [ ] æŒæ¡æ¥å£å…¼å®¹æ€§è®¾è®¡æ–¹æ³•
- [ ] èƒ½ç¼–å†™å¹³æ»‘å‡çº§æ–¹æ¡ˆ
- [ ] èƒ½å¤„ç†ç‰ˆæœ¬å‡çº§çš„å¸¸è§é—®é¢˜

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
> Groupåˆ†ç»„åšéš”ç¦»ï¼ŒVersionç‰ˆæœ¬æ§è¿­ä»£
> ç°åº¦å‘å¸ƒé™é£é™©ï¼Œè“ç»¿åˆ‡æ¢å¿«å›æ»š
> é‡‘ä¸é›€è‡ªåŠ¨åŒ–ï¼Œå…¼å®¹è®¾è®¡ä¿å¹³æ»‘

**ğŸ’¡ å»¶ä¼¸å­¦ä¹ å»ºè®®**
- æ·±å…¥å­¦ä¹ é…ç½®ä¸­å¿ƒçš„åŠ¨æ€è§„åˆ™ç®¡ç†
- ç ”ç©¶æµé‡å½•åˆ¶å›æ”¾æŠ€æœ¯
- äº†è§£æ··æ²Œå·¥ç¨‹åœ¨ç‰ˆæœ¬å‘å¸ƒä¸­çš„åº”ç”¨
- å­¦ä¹ Service Meshçš„æµé‡æ²»ç†èƒ½åŠ›