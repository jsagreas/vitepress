---
title: 33ã€Dubboç”µå•†ç³»ç»Ÿå¾®æœåŠ¡å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [ç”µå•†å¾®æœåŠ¡æ¶æ„æ¦‚è¿°](#1-ç”µå•†å¾®æœåŠ¡æ¶æ„æ¦‚è¿°)
2. [å•†å“æœåŠ¡è®¾è®¡ä¸å®ç°](#2-å•†å“æœåŠ¡è®¾è®¡ä¸å®ç°)
3. [è®¢å•æœåŠ¡æ¶æ„è¯¦è§£](#3-è®¢å•æœåŠ¡æ¶æ„è¯¦è§£)
4. [ç”¨æˆ·æœåŠ¡å®ç°](#4-ç”¨æˆ·æœåŠ¡å®ç°)
5. [æ”¯ä»˜æœåŠ¡é›†æˆ](#5-æ”¯ä»˜æœåŠ¡é›†æˆ)
6. [åº“å­˜æœåŠ¡ç®¡ç†](#6-åº“å­˜æœåŠ¡ç®¡ç†)
7. [æœåŠ¡è°ƒç”¨é“¾è·¯è®¾è®¡](#7-æœåŠ¡è°ƒç”¨é“¾è·¯è®¾è®¡)
8. [æ•°æ®ä¸€è‡´æ€§ä¿éšœ](#8-æ•°æ®ä¸€è‡´æ€§ä¿éšœ)
9. [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](#9-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ç”µå•†å¾®æœåŠ¡æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç”µå•†å¾®æœåŠ¡æ¶æ„


**é€šä¿—ç†è§£**ï¼š
æŠŠä¸€ä¸ªå¤§çš„ç”µå•†ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªå°çš„ç‹¬ç«‹æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä»¶äº‹æƒ…ã€‚å°±åƒä¸€ä¸ªå¤§è¶…å¸‚åˆ†æˆäº†ä¸åŒçš„éƒ¨é—¨ï¼šå•†å“éƒ¨ã€æ”¶é“¶éƒ¨ã€åº“å­˜éƒ¨ã€ä¼šå‘˜éƒ¨ç­‰ï¼Œå„å¸å…¶èŒä½†åˆç›¸äº’é…åˆã€‚

```
ä¼ ç»Ÿå•ä½“æ¶æ„ï¼ˆä¸€ä¸ªå¤§ç³»ç»ŸåŒ…åŠæ‰€æœ‰ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”µå•†ç³»ç»Ÿ                     â”‚
â”‚  å•†å“+è®¢å•+ç”¨æˆ·+æ”¯ä»˜+åº“å­˜...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œä¿®æ”¹ä¸€ä¸ªåŠŸèƒ½å¯èƒ½å½±å“æ•´ä¸ªç³»ç»Ÿ

å¾®æœåŠ¡æ¶æ„ï¼ˆåˆ†å·¥åˆä½œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚å•†å“  â”‚  â”‚è®¢å•  â”‚  â”‚ç”¨æˆ·  â”‚  â”‚æ”¯ä»˜  â”‚  â”‚åº“å­˜  â”‚
â”‚æœåŠ¡  â”‚  â”‚æœåŠ¡  â”‚  â”‚æœåŠ¡  â”‚  â”‚æœåŠ¡  â”‚  â”‚æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼šç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²ã€äº’ä¸å½±å“
```

### 1.2 ç”µå•†æ ¸å¿ƒä¸šåŠ¡æœåŠ¡åˆ’åˆ†


**ğŸ¯ æ ¸å¿ƒæœåŠ¡æ¨¡å—**ï¼š

| æœåŠ¡åç§° | ä¸»è¦èŒè´£ | å…¸å‹åŠŸèƒ½ | ç‹¬ç«‹åŸå›  |
|---------|---------|---------|---------|
| **å•†å“æœåŠ¡** | ç®¡ç†å•†å“ä¿¡æ¯ | å•†å“å±•ç¤ºã€æœç´¢ã€åˆ†ç±» | å•†å“æ•°æ®é‡å¤§ï¼Œéœ€è¦ç‹¬ç«‹ä¼˜åŒ– |
| **è®¢å•æœåŠ¡** | å¤„ç†è®¢å•æµç¨‹ | ä¸‹å•ã€æ”¯ä»˜ã€å‘è´§ | è®¢å•é€»è¾‘å¤æ‚ï¼Œæ˜¯æ ¸å¿ƒä¸šåŠ¡ |
| **ç”¨æˆ·æœåŠ¡** | ç®¡ç†ç”¨æˆ·ä¿¡æ¯ | æ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¸­å¿ƒ | ç”¨æˆ·æ•°æ®å®‰å…¨è¦æ±‚é«˜ |
| **æ”¯ä»˜æœåŠ¡** | å¤„ç†æ”¯ä»˜ä¸šåŠ¡ | æ”¯ä»˜ã€é€€æ¬¾ã€å¯¹è´¦ | æ¶‰åŠé‡‘é’±ï¼Œéœ€è¦é«˜å®‰å…¨æ€§ |
| **åº“å­˜æœåŠ¡** | ç®¡ç†å•†å“åº“å­˜ | åº“å­˜æ‰£å‡ã€åº“å­˜åŒæ­¥ | é«˜å¹¶å‘åœºæ™¯ï¼Œéœ€è¦ç‹¬ç«‹å¤„ç† |

### 1.3 æœåŠ¡é—´åä½œå…³ç³»


```
ç”¨æˆ·ä¸‹å•å®Œæ•´æµç¨‹ï¼š

  ç”¨æˆ·ç«¯
    â†“
  [1] æŸ¥çœ‹å•†å“
    â†“
  å•†å“æœåŠ¡ â†’ è¿”å›å•†å“è¯¦æƒ…
    â†“
  [2] åˆ›å»ºè®¢å•
    â†“
  è®¢å•æœåŠ¡ â†’ è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆæ£€æŸ¥åº“å­˜ï¼‰
    â†“       â†“
    â†“     åº“å­˜æœåŠ¡ â†’ é¢„æ‰£åº“å­˜
    â†“       â†“
    â†“     è¿”å›æˆåŠŸ
    â†“
  [3] å‘èµ·æ”¯ä»˜
    â†“
  æ”¯ä»˜æœåŠ¡ â†’ è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
    â†“
  [4] æ”¯ä»˜æˆåŠŸ
    â†“
  è®¢å•æœåŠ¡ â†’ æ›´æ–°è®¢å•çŠ¶æ€
    â†“       â†“
    â†“     åº“å­˜æœåŠ¡ â†’ ç¡®è®¤æ‰£åº“å­˜
    â†“
  [5] è®¢å•å®Œæˆ
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**  
> å¾®æœåŠ¡ä¹‹é—´é€šè¿‡Dubbo RPCè°ƒç”¨ï¼Œå°±åƒæ‰“ç”µè¯ä¸€æ ·ï¼šè®¢å•æœåŠ¡éœ€è¦æ‰£åº“å­˜æ—¶ï¼Œå°±"æ‰“ç”µè¯"ç»™åº“å­˜æœåŠ¡è¯·æ±‚æ‰£å‡åº“å­˜ã€‚

---

## 2. ğŸ“¦ å•†å“æœåŠ¡è®¾è®¡ä¸å®ç°


### 2.1 å•†å“æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½


**å•†å“æœåŠ¡è¦åšä»€ä¹ˆï¼Ÿ**
- **å•†å“ç®¡ç†**ï¼šæ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å•†å“ä¿¡æ¯
- **å•†å“å±•ç¤º**ï¼šæä¾›å•†å“åˆ—è¡¨ã€è¯¦æƒ…æŸ¥è¯¢
- **åˆ†ç±»ç®¡ç†**ï¼šç®¡ç†å•†å“åˆ†ç±»ä½“ç³»
- **æœç´¢åŠŸèƒ½**ï¼šæ”¯æŒå•†å“æœç´¢å’Œç­›é€‰

### 2.2 å•†å“æœåŠ¡æ¥å£å®šä¹‰


```java
// å•†å“æœåŠ¡æ¥å£ï¼ˆAPIå®šä¹‰ï¼‰
public interface ProductService {
    
    /**
     * æ ¹æ®å•†å“IDæŸ¥è¯¢å•†å“è¯¦æƒ…
     * @param productId å•†å“ID
     * @return å•†å“è¯¦æƒ…ä¿¡æ¯
     */
    ProductDTO getProductById(Long productId);
    
    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨
     * @param categoryId åˆ†ç±»ID
     * @param pageNum é¡µç 
     * @param pageSize æ¯é¡µæ•°é‡
     * @return å•†å“åˆ—è¡¨
     */
    PageResult<ProductDTO> listProducts(Long categoryId, int pageNum, int pageSize);
    
    /**
     * æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆè®¢å•æœåŠ¡ä¼šç”¨åˆ°ï¼‰
     * @param productIds å•†å“IDåˆ—è¡¨
     * @return å•†å“ä¿¡æ¯åˆ—è¡¨
     */
    List<ProductDTO> batchGetProducts(List<Long> productIds);
}
```

> ğŸ“– **æœ¯è¯­è§£é‡Š**  
> **DTO (Data Transfer Object)**ï¼šæ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œå°±åƒå¿«é€’åŒ…è£¹ä¸€æ ·ï¼ŒæŠŠæ•°æ®æ‰“åŒ…ååœ¨æœåŠ¡ä¹‹é—´ä¼ é€’ã€‚

### 2.3 å•†å“æœåŠ¡å®ç°è¦ç‚¹


**ğŸ”¸ å®ç°ç±»ç¤ºä¾‹**ï¼š

```java
@DubboService(version = "1.0.0", timeout = 3000)
public class ProductServiceImpl implements ProductService {
    
    @Autowired
    private ProductMapper productMapper;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Override
    public ProductDTO getProductById(Long productId) {
        // 1. å…ˆæŸ¥ç¼“å­˜ï¼ˆæå‡æ€§èƒ½ï¼‰
        String cacheKey = "product:" + productId;
        ProductDTO cached = (ProductDTO) redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
        Product product = productMapper.selectById(productId);
        if (product == null) {
            throw new BusinessException("å•†å“ä¸å­˜åœ¨");
        }
        
        // 3. è½¬æ¢ä¸ºDTOå¹¶æ”¾å…¥ç¼“å­˜
        ProductDTO dto = convertToDTO(product);
        redisTemplate.opsForValue().set(cacheKey, dto, 30, TimeUnit.MINUTES);
        
        return dto;
    }
}
```

**ğŸ’¡ è®¾è®¡è¦ç‚¹è§£æ**ï¼š

| è®¾è®¡ç‚¹ | ä¸ºä»€ä¹ˆè¿™æ ·åš | æ–°æ‰‹æç¤º |
|-------|-------------|---------|
| **ç¼“å­˜ä¼˜å…ˆ** | å•†å“ä¿¡æ¯å˜åŒ–å°‘ï¼Œå¤§é‡æŸ¥è¯¢ä¼šå‹å®æ•°æ®åº“ | å°±åƒæŠŠå¸¸çœ‹çš„ä¹¦æ”¾åœ¨æ¡Œä¸Šï¼Œä¸ç”¨æ¯æ¬¡å»ä¹¦æ¶æ‹¿ |
| **è¶…æ—¶è®¾ç½®** | `timeout = 3000` è¡¨ç¤º3ç§’è¶…æ—¶ | é˜²æ­¢æœåŠ¡å¡æ­»ï¼Œè¶…æ—¶å°±è¿”å›å¤±è´¥ |
| **ç‰ˆæœ¬æ§åˆ¶** | `version = "1.0.0"` æ ‡è¯†æœåŠ¡ç‰ˆæœ¬ | å‡çº§æ—¶å¯ä»¥æ–°è€ç‰ˆæœ¬å…±å­˜ |
| **å¼‚å¸¸å¤„ç†** | å•†å“ä¸å­˜åœ¨æ—¶æŠ›å‡ºæ˜ç¡®å¼‚å¸¸ | è®©è°ƒç”¨æ–¹çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ |

---

## 3. ğŸ“‹ è®¢å•æœåŠ¡æ¶æ„è¯¦è§£


### 3.1 è®¢å•æœåŠ¡çš„å¤æ‚æ€§


**ä¸ºä»€ä¹ˆè®¢å•æœåŠ¡æœ€å¤æ‚ï¼Ÿ**
è®¢å•æœåŠ¡æ˜¯ç”µå•†çš„æ ¸å¿ƒï¼Œéœ€è¦åè°ƒå¤šä¸ªæœåŠ¡ï¼š

```
è®¢å•åˆ›å»ºæµç¨‹æ¶‰åŠçš„æœåŠ¡ï¼š

ç”¨æˆ·ä¸‹å•
   â†“
è®¢å•æœåŠ¡ï¼ˆä¸»æ§ï¼‰
   â”œâ†’ è°ƒç”¨å•†å“æœåŠ¡ï¼ˆæŸ¥è¯¢å•†å“ä¿¡æ¯ï¼‰
   â”œâ†’ è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆæ£€æŸ¥å¹¶æ‰£å‡åº“å­˜ï¼‰
   â”œâ†’ è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼ˆéªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼‰
   â”œâ†’ è°ƒç”¨ä¼˜æƒ æœåŠ¡ï¼ˆè®¡ç®—ä¼˜æƒ ï¼‰
   â””â†’ åˆ›å»ºè®¢å•è®°å½•

ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½è¦å›æ»šï¼
```

### 3.2 è®¢å•æœåŠ¡æ¥å£è®¾è®¡


```java
public interface OrderService {
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
     * @param orderRequest è®¢å•è¯·æ±‚ä¿¡æ¯
     * @return è®¢å•ID
     */
    Long createOrder(CreateOrderRequest orderRequest);
    
    /**
     * æŸ¥è¯¢è®¢å•è¯¦æƒ…
     * @param orderId è®¢å•ID
     * @return è®¢å•è¯¦æƒ…
     */
    OrderDTO getOrderDetail(Long orderId);
    
    /**
     * å–æ¶ˆè®¢å•
     * @param orderId è®¢å•ID
     */
    void cancelOrder(Long orderId);
}
```

### 3.3 è®¢å•åˆ›å»ºæ ¸å¿ƒé€»è¾‘


```java
@DubboService(version = "1.0.0")
public class OrderServiceImpl implements OrderService {
    
    @DubboReference(version = "1.0.0", check = false)
    private ProductService productService;
    
    @DubboReference(version = "1.0.0", check = false)
    private StockService stockService;
    
    @Override
    public Long createOrder(CreateOrderRequest request) {
        // ç¬¬1æ­¥ï¼šå‚æ•°æ ¡éªŒ
        validateOrderRequest(request);
        
        // ç¬¬2æ­¥ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯
        List<ProductDTO> products = productService
            .batchGetProducts(request.getProductIds());
        
        // ç¬¬3æ­¥ï¼šæ£€æŸ¥åº“å­˜å¹¶é¢„æ‰£
        boolean stockSuccess = stockService
            .deductStock(request.getProductId(), request.getQuantity());
        if (!stockSuccess) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        // ç¬¬4æ­¥ï¼šè®¡ç®—è®¢å•é‡‘é¢
        BigDecimal totalAmount = calculateAmount(products, request);
        
        // ç¬¬5æ­¥ï¼šåˆ›å»ºè®¢å•è®°å½•
        Order order = buildOrder(request, totalAmount);
        orderMapper.insert(order);
        
        return order.getId();
    }
}
```

> âš ï¸ **é‡è¦æé†’**  
> `@DubboReference` ä¸­çš„ `check = false` è¡¨ç¤ºå¯åŠ¨æ—¶ä¸æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨ã€‚é€‚åˆå¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ä¸º `true`ã€‚

**ğŸ” å…³é”®æ­¥éª¤è¯¦è§£**ï¼š

- **å‚æ•°æ ¡éªŒ**ï¼šæ£€æŸ¥ç”¨æˆ·IDã€å•†å“IDã€æ•°é‡ç­‰æ˜¯å¦åˆæ³•
- **æŸ¥è¯¢å•†å“**ï¼šè·å–å•†å“ä»·æ ¼ã€åç§°ç­‰ä¿¡æ¯ï¼ˆç”¨äºè®¢å•æ˜ç»†ï¼‰
- **é¢„æ‰£åº“å­˜**ï¼šå…ˆå†»ç»“åº“å­˜ï¼Œæ”¯ä»˜æˆåŠŸå†ç¡®è®¤æ‰£é™¤
- **è®¡ç®—é‡‘é¢**ï¼šå•†å“ä»·æ ¼ Ã— æ•°é‡ - ä¼˜æƒ é‡‘é¢
- **åˆ›å»ºè®¢å•**ï¼šä¿å­˜è®¢å•ä¸»è¡¨å’Œæ˜ç»†è¡¨

---

## 4. ğŸ‘¤ ç”¨æˆ·æœåŠ¡å®ç°


### 4.1 ç”¨æˆ·æœåŠ¡çš„èŒè´£è¾¹ç•Œ


**ç”¨æˆ·æœåŠ¡ç®¡ä»€ä¹ˆï¼Ÿ**
- âœ… ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€æ‰‹æœºå·ã€åœ°å€ç­‰ï¼‰
- âœ… ç”¨æˆ·è®¤è¯æˆæƒï¼ˆç™»å½•ã€æƒé™ï¼‰
- âœ… ç”¨æˆ·ç§¯åˆ†ã€ç­‰çº§
- âŒ ä¸ç®¡è®¢å•ï¼ˆç”±è®¢å•æœåŠ¡ç®¡ç†ï¼‰
- âŒ ä¸ç®¡è´­ç‰©è½¦ï¼ˆç”±è´­ç‰©è½¦æœåŠ¡ç®¡ç†ï¼‰

> ğŸ’­ **è®¾è®¡ç†å¿µ**  
> æ¯ä¸ªæœåŠ¡åªç®¡è‡ªå·±çš„"ä¸€äº©ä¸‰åˆ†åœ°"ï¼Œè¾¹ç•Œæ¸…æ™°æ‰èƒ½é¿å…æ··ä¹±ã€‚

### 4.2 ç”¨æˆ·æœåŠ¡æ¥å£


```java
public interface UserService {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    UserDTO getUserById(Long userId);
    
    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰æ•ˆï¼ˆè®¢å•æœåŠ¡ä¼šè°ƒç”¨ï¼‰
     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æœ‰æ•ˆ
     */
    boolean validateUser(Long userId);
    
    /**
     * è·å–ç”¨æˆ·æ”¶è´§åœ°å€
     * @param userId ç”¨æˆ·ID
     * @return åœ°å€åˆ—è¡¨
     */
    List<AddressDTO> getUserAddresses(Long userId);
}
```

### 4.3 ç”¨æˆ·æœåŠ¡å®ç°ç¤ºä¾‹


```java
@DubboService(version = "1.0.0", timeout = 2000)
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public boolean validateUser(Long userId) {
        // æŸ¥è¯¢ç”¨æˆ·å¹¶æ£€æŸ¥çŠ¶æ€
        User user = userMapper.selectById(userId);
        if (user == null) {
            return false;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨
        if (user.getStatus() == UserStatus.DISABLED) {
            return false;
        }
        
        return true;
    }
}
```

**ğŸ¯ è®¾è®¡äº®ç‚¹**ï¼š
- **å¿«é€ŸéªŒè¯**ï¼šè®¢å•æœåŠ¡åªéœ€è¦çŸ¥é“ç”¨æˆ·æ˜¯å¦æœ‰æ•ˆï¼Œä¸éœ€è¦å…¨éƒ¨ç”¨æˆ·ä¿¡æ¯
- **çŠ¶æ€ç®¡ç†**ï¼šç”¨æˆ·çŠ¶æ€ç”±ç”¨æˆ·æœåŠ¡ç»Ÿä¸€ç®¡ç†
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè¶…æ—¶è®¾ç½®ä¸º2ç§’ï¼ˆç”¨æˆ·éªŒè¯è¦å¿«é€Ÿå“åº”ï¼‰

---

## 5. ğŸ’° æ”¯ä»˜æœåŠ¡é›†æˆ


### 5.1 æ”¯ä»˜æœåŠ¡çš„ç‰¹æ®Šæ€§


**ä¸ºä»€ä¹ˆæ”¯ä»˜æœåŠ¡è¦ç‹¬ç«‹ï¼Ÿ**

```
æ”¯ä»˜æœåŠ¡çš„ç‰¹ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” å®‰å…¨æ€§è¦æ±‚æé«˜            â”‚
â”‚ ğŸ’µ æ¶‰åŠçœŸå®èµ„é‡‘äº¤æ˜“          â”‚
â”‚ ğŸ”— éœ€è¦å¯¹æ¥å¤šä¸ªæ”¯ä»˜æ¸ é“      â”‚
â”‚ ğŸ“Š éœ€è¦è¯¦ç»†çš„æ”¯ä»˜æ—¥å¿—        â”‚
â”‚ âš¡ å¹¶å‘é‡å¤§ï¼Œæ€§èƒ½è¦æ±‚é«˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ”¯ä»˜æµç¨‹è®¾è®¡


```
å®Œæ•´æ”¯ä»˜æµç¨‹ï¼š

[1] è®¢å•æœåŠ¡è¯·æ±‚æ”¯ä»˜
      â†“
[2] æ”¯ä»˜æœåŠ¡åˆ›å»ºæ”¯ä»˜å•
      â†“
[3] è°ƒç”¨æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜API
      â†“
[4] ç”¨æˆ·å®Œæˆæ”¯ä»˜
      â†“
[5] æ¥æ”¶æ”¯ä»˜å›è°ƒé€šçŸ¥
      â†“
[6] éªŒè¯ç­¾åå’Œé‡‘é¢
      â†“
[7] æ›´æ–°æ”¯ä»˜çŠ¶æ€
      â†“
[8] é€šçŸ¥è®¢å•æœåŠ¡æ”¯ä»˜æˆåŠŸ
      â†“
[9] è®¢å•æœåŠ¡æ›´æ–°è®¢å•çŠ¶æ€
```

### 5.3 æ”¯ä»˜æœåŠ¡æ¥å£


```java
public interface PaymentService {
    
    /**
     * åˆ›å»ºæ”¯ä»˜å•
     * @param payRequest æ”¯ä»˜è¯·æ±‚
     * @return æ”¯ä»˜å•å·
     */
    String createPayment(PaymentRequest payRequest);
    
    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
     * @param paymentNo æ”¯ä»˜å•å·
     * @return æ”¯ä»˜çŠ¶æ€
     */
    PaymentStatus queryPaymentStatus(String paymentNo);
    
    /**
     * å¤„ç†æ”¯ä»˜å›è°ƒ
     * @param callbackData å›è°ƒæ•°æ®
     */
    void handlePaymentCallback(Map<String, String> callbackData);
}
```

### 5.4 æ”¯ä»˜æœåŠ¡å®ç°è¦ç‚¹


```java
@DubboService(version = "1.0.0", timeout = 5000)
public class PaymentServiceImpl implements PaymentService {
    
    @Autowired
    private AlipayClient alipayClient; // æ”¯ä»˜å®å®¢æˆ·ç«¯
    
    @Override
    public String createPayment(PaymentRequest request) {
        // 1. åˆ›å»ºæ”¯ä»˜å•è®°å½•
        Payment payment = new Payment();
        payment.setOrderId(request.getOrderId());
        payment.setAmount(request.getAmount());
        payment.setStatus(PaymentStatus.PENDING);
        paymentMapper.insert(payment);
        
        // 2. è°ƒç”¨æ”¯ä»˜å®æ¥å£
        AlipayTradePagePayRequest alipayRequest = new AlipayTradePagePayRequest();
        alipayRequest.setNotifyUrl("http://api.example.com/payment/callback");
        alipayRequest.setBizContent(buildPayContent(payment));
        
        AlipayTradePagePayResponse response = alipayClient.pageExecute(alipayRequest);
        
        return payment.getPaymentNo();
    }
    
    @Override
    public void handlePaymentCallback(Map<String, String> callbackData) {
        // 1. éªŒè¯ç­¾åï¼ˆéå¸¸é‡è¦ï¼ï¼‰
        boolean signValid = AlipaySignature.rsaCheckV1(
            callbackData, 
            alipayPublicKey, 
            "UTF-8", 
            "RSA2"
        );
        
        if (!signValid) {
            throw new SecurityException("æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥");
        }
        
        // 2. æ›´æ–°æ”¯ä»˜çŠ¶æ€
        String paymentNo = callbackData.get("out_trade_no");
        Payment payment = paymentMapper.selectByPaymentNo(paymentNo);
        payment.setStatus(PaymentStatus.SUCCESS);
        paymentMapper.updateById(payment);
        
        // 3. é€šçŸ¥è®¢å•æœåŠ¡
        orderService.updateOrderPaymentStatus(payment.getOrderId(), true);
    }
}
```

> ğŸ” **å®‰å…¨è¦ç‚¹**  
> - **ç­¾åéªŒè¯**ï¼šå¿…é¡»éªŒè¯æ”¯ä»˜å›è°ƒçš„ç­¾åï¼Œé˜²æ­¢ä¼ªé€ 
> - **é‡‘é¢æ ¡éªŒ**ï¼šå›è°ƒé‡‘é¢å¿…é¡»ä¸è®¢å•é‡‘é¢ä¸€è‡´
> - **å¹‚ç­‰å¤„ç†**ï¼šåŒä¸€ä¸ªæ”¯ä»˜å›è°ƒå¯èƒ½æ”¶åˆ°å¤šæ¬¡ï¼Œè¦ä¿è¯åªå¤„ç†ä¸€æ¬¡

---

## 6. ğŸ“Š åº“å­˜æœåŠ¡ç®¡ç†


### 6.1 åº“å­˜æœåŠ¡çš„æŒ‘æˆ˜


**åº“å­˜æœåŠ¡ä¸ºä»€ä¹ˆéš¾ï¼Ÿ**

| æŒ‘æˆ˜ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| **é«˜å¹¶å‘** | ç§’æ€åœºæ™¯ä¸‹ï¼Œæˆåƒä¸Šä¸‡äººåŒæ—¶æŠ¢è´­ | Redis + æ•°æ®åº“åŒå†™ |
| **è¶…å–é—®é¢˜** | åº“å­˜åªæœ‰1ä¸ªï¼Œå´å–å‡ºäº†10ä¸ª | ä¹è§‚é”æˆ–åˆ†å¸ƒå¼é” |
| **åº“å­˜é¢„ç•™** | ä¸‹å•æœªæ”¯ä»˜ï¼Œåº“å­˜è¦ä¸´æ—¶å†»ç»“ | é¢„æ‰£åº“å­˜æœºåˆ¶ |
| **åº“å­˜åŒæ­¥** | å¤šä¸ªæœåŠ¡åŒæ—¶æ“ä½œåº“å­˜ | æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åŒæ­¥ |

### 6.2 åº“å­˜æœåŠ¡æ¥å£


```java
public interface StockService {
    
    /**
     * æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
     * @param productId å•†å“ID
     * @param quantity éœ€è¦æ•°é‡
     * @return æ˜¯å¦å……è¶³
     */
    boolean checkStock(Long productId, Integer quantity);
    
    /**
     * é¢„æ‰£åº“å­˜ï¼ˆä¸‹å•æ—¶è°ƒç”¨ï¼‰
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean deductStock(Long productId, Integer quantity);
    
    /**
     * é‡Šæ”¾åº“å­˜ï¼ˆå–æ¶ˆè®¢å•æ—¶è°ƒç”¨ï¼‰
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     */
    void releaseStock(Long productId, Integer quantity);
}
```

### 6.3 åº“å­˜æ‰£å‡æ ¸å¿ƒå®ç°


```java
@DubboService(version = "1.0.0", timeout = 2000)
public class StockServiceImpl implements StockService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private StockMapper stockMapper;
    
    @Override
    public boolean deductStock(Long productId, Integer quantity) {
        String stockKey = "stock:" + productId;
        
        // æ–¹æ¡ˆ1ï¼šä½¿ç”¨RedisåŸå­æ“ä½œï¼ˆæ¨èï¼‰
        Long remainStock = redisTemplate.opsForValue()
            .increment(stockKey, -quantity);
        
        if (remainStock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š
            redisTemplate.opsForValue().increment(stockKey, quantity);
            return false;
        }
        
        // æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ•°æ®åº“ä¹è§‚é”ï¼ˆå…œåº•ï¼‰
        int updated = stockMapper.deductStockWithVersion(productId, quantity);
        
        if (updated == 0) {
            // æ•°æ®åº“æ‰£å‡å¤±è´¥ï¼ŒRedisä¹Ÿè¦å›æ»š
            redisTemplate.opsForValue().increment(stockKey, quantity);
            return false;
        }
        
        return true;
    }
}
```

**ğŸ“ SQLä¹è§‚é”å®ç°**ï¼š

```sql
-- ä½¿ç”¨versionå­—æ®µå®ç°ä¹è§‚é”
UPDATE stock 
SET quantity = quantity - #{quantity},
    version = version + 1
WHERE product_id = #{productId} 
  AND quantity >= #{quantity}
  AND version = #{version}
```

> ğŸ’¡ **æ–°æ‰‹é‡ç‚¹ç†è§£**  
> **ä¹è§‚é”åŸç†**ï¼šå°±åƒå¤šäººåŒæ—¶ç¼–è¾‘æ–‡æ¡£ï¼Œæäº¤æ—¶æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å˜åŒ–ã€‚å¦‚æœåˆ«äººå·²ç»æ”¹è¿‡ï¼ˆç‰ˆæœ¬å·å˜äº†ï¼‰ï¼Œä½ çš„ä¿®æ”¹å°±å¤±è´¥ï¼Œéœ€è¦é‡æ–°è¯»å–å†æ”¹ã€‚

**ğŸ”„ åŒå†™ä¸€è‡´æ€§ä¿éšœ**ï¼š

```
Rediså’Œæ•°æ®åº“å¦‚ä½•ä¿æŒä¸€è‡´ï¼Ÿ

æ­£å¸¸æµç¨‹ï¼š
Redisæ‰£å‡ â†’ æˆåŠŸ â†’ æ•°æ®åº“æ‰£å‡ â†’ æˆåŠŸ âœ“

å¼‚å¸¸æƒ…å†µ1ï¼š
Redisæ‰£å‡ â†’ æˆåŠŸ â†’ æ•°æ®åº“æ‰£å‡ â†’ å¤±è´¥ âœ—
å¤„ç†ï¼šå›æ»šRedis

å¼‚å¸¸æƒ…å†µ2ï¼š
Redisæ‰£å‡ â†’ å¤±è´¥ âœ—
å¤„ç†ï¼šç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸æ“ä½œæ•°æ®åº“
```

---

## 7. ğŸ”— æœåŠ¡è°ƒç”¨é“¾è·¯è®¾è®¡


### 7.1 è°ƒç”¨é“¾è·¯çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦å…³æ³¨è°ƒç”¨é“¾è·¯ï¼Ÿ**
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¾åˆ°æœ€æ…¢çš„ç¯èŠ‚
- **é—®é¢˜å®šä½**ï¼šå¿«é€Ÿæ‰¾åˆ°å‡ºé”™çš„æœåŠ¡
- **ä¾èµ–æ¢³ç†**ï¼šæ˜ç¡®æœåŠ¡é—´çš„ä¾èµ–å…³ç³»

### 7.2 ä¸‹å•æµç¨‹å®Œæ•´è°ƒç”¨é“¾


```
ç”¨æˆ·ä¸‹å•å®Œæ•´è°ƒç”¨é“¾è·¯å›¾ï¼š

å‰ç«¯é¡µé¢
    â†“ [HTTP]
è®¢å•æœåŠ¡
    â”œâ†’ [Dubbo] ç”¨æˆ·æœåŠ¡.validateUser()      è€—æ—¶: ~50ms
    â”œâ†’ [Dubbo] å•†å“æœåŠ¡.batchGetProducts()  è€—æ—¶: ~100ms
    â”œâ†’ [Dubbo] åº“å­˜æœåŠ¡.deductStock()       è€—æ—¶: ~80ms
    â”œâ†’ [DB] æ’å…¥è®¢å•è®°å½•                     è€—æ—¶: ~30ms
    â””â†’ [Dubbo] æ”¯ä»˜æœåŠ¡.createPayment()     è€—æ—¶: ~200ms
         â†“
    æ€»è€—æ—¶: ~460ms
```

### 7.3 è°ƒç”¨é“¾è·¯ä¼˜åŒ–ç­–ç•¥


**ğŸš€ å¹¶è¡Œè°ƒç”¨ä¼˜åŒ–**ï¼š

```java
@Override
public Long createOrder(CreateOrderRequest request) {
    // åŸå§‹æ–¹æ¡ˆï¼šä¸²è¡Œè°ƒç”¨ï¼ˆæ…¢ï¼‰
    // æ€»è€—æ—¶ = 50 + 100 + 80 = 230ms
    UserDTO user = userService.getUserById(request.getUserId());
    List<ProductDTO> products = productService.batchGetProducts(request.getProductIds());
    boolean stockOk = stockService.checkStock(request.getProductId(), request.getQuantity());
    
    // ä¼˜åŒ–æ–¹æ¡ˆï¼šå¹¶è¡Œè°ƒç”¨ï¼ˆå¿«ï¼‰
    // æ€»è€—æ—¶ = max(50, 100, 80) = 100ms
    CompletableFuture<UserDTO> userFuture = CompletableFuture.supplyAsync(
        () -> userService.getUserById(request.getUserId())
    );
    
    CompletableFuture<List<ProductDTO>> productFuture = CompletableFuture.supplyAsync(
        () -> productService.batchGetProducts(request.getProductIds())
    );
    
    CompletableFuture<Boolean> stockFuture = CompletableFuture.supplyAsync(
        () -> stockService.checkStock(request.getProductId(), request.getQuantity())
    );
    
    // ç­‰å¾…æ‰€æœ‰è°ƒç”¨å®Œæˆ
    CompletableFuture.allOf(userFuture, productFuture, stockFuture).join();
    
    UserDTO user = userFuture.get();
    List<ProductDTO> products = productFuture.get();
    boolean stockOk = stockFuture.get();
    
    // ç»§ç»­åç»­é€»è¾‘...
}
```

> âš¡ **æ€§èƒ½æå‡**  
> å¹¶è¡Œè°ƒç”¨å¯ä»¥å°†æ€»è€—æ—¶ä»230msé™ä½åˆ°100msï¼Œæ€§èƒ½æå‡50%ä»¥ä¸Šï¼

**ğŸ“Š è°ƒç”¨é“¾è·¯ç›‘æ§**ï¼š

| ç›‘æ§æŒ‡æ ‡ | å«ä¹‰ | å‘Šè­¦é˜ˆå€¼ |
|---------|------|---------|
| **è°ƒç”¨è€—æ—¶** | å•æ¬¡è°ƒç”¨èŠ±è´¹æ—¶é—´ | >1000ms |
| **è°ƒç”¨æˆåŠŸç‡** | æˆåŠŸæ¬¡æ•°/æ€»æ¬¡æ•° | <99% |
| **å¹¶å‘é‡** | åŒæ—¶è¿›è¡Œçš„è°ƒç”¨æ•° | >5000 |
| **è¶…æ—¶æ¬¡æ•°** | è°ƒç”¨è¶…æ—¶çš„æ¬¡æ•° | >10æ¬¡/åˆ†é’Ÿ |

---

## 8. ğŸ”„ æ•°æ®ä¸€è‡´æ€§ä¿éšœ


### 8.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸€è‡´æ€§é—®é¢˜


**é€šä¿—ç†è§£**ï¼š
å°±åƒé“¶è¡Œè½¬è´¦ï¼ŒAè´¦æˆ·æ‰£äº†100å…ƒï¼ŒBè´¦æˆ·å¿…é¡»åŠ 100å…ƒã€‚å¦‚æœAæ‰£äº†ï¼ŒBæ²¡åŠ ï¼Œæ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

**ç”µå•†åœºæ™¯çš„ä¸€è‡´æ€§é—®é¢˜**ï¼š

```
é—®é¢˜åœºæ™¯1ï¼šè®¢å•åˆ›å»ºäº†ï¼Œä½†åº“å­˜æ²¡æ‰£
ç”¨æˆ·Aä¸‹å•ä¹°äº†æ‰‹æœº â†’ è®¢å•æœåŠ¡åˆ›å»ºè®¢å•æˆåŠŸ
                  â†“
                åº“å­˜æœåŠ¡æ‰£åº“å­˜ â†’ ç½‘ç»œè¶…æ—¶å¤±è´¥ âœ—
                  â†“
ç»“æœï¼šè®¢å•å·²ç”Ÿæˆï¼Œä½†åº“å­˜è¿˜åœ¨ï¼Œå¯èƒ½è¶…å–ï¼

é—®é¢˜åœºæ™¯2ï¼šåº“å­˜æ‰£äº†,ä½†è®¢å•æ²¡åˆ›å»º
è®¢å•æœåŠ¡åˆ›å»ºè®¢å• â†’ æ•°æ®åº“å¼‚å¸¸å¤±è´¥ âœ—
      â†“
åº“å­˜æœåŠ¡æ‰£åº“å­˜ â†’ å·²ç»æ‰£å‡æˆåŠŸ
      â†“
ç»“æœï¼šåº“å­˜å‡å°‘äº†ï¼Œä½†æ²¡æœ‰å¯¹åº”è®¢å•ï¼Œåº“å­˜å‡­ç©ºæ¶ˆå¤±ï¼
```

### 8.2 æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼š
å…è®¸çŸ­æ—¶é—´å†…ä¸ä¸€è‡´,ä½†æœ€ç»ˆè¦è¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚å°±åƒç½‘è´­æ—¶ï¼Œæ”¯ä»˜å’Œåˆ°è´¦å¯èƒ½æœ‰å»¶è¿Ÿï¼Œä½†æœ€ç»ˆé’±ä¸€å®šä¼šåˆ°è´¦ã€‚

**å®ç°æ–¹æ¡ˆï¼šæ¶ˆæ¯é˜Ÿåˆ—**

```
ä½¿ç”¨RocketMQä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼š

[1] è®¢å•æœåŠ¡å‘é€æ¶ˆæ¯
      â†“
[2] æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰
      â†“
[3] åº“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯
      â†“
[4] æ‰£å‡åº“å­˜
      â†“
[5] å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨é‡è¯•
```

**ä»£ç å®ç°**ï¼š

```java
// è®¢å•æœåŠ¡ï¼šå‘é€æ¶ˆæ¯
@Override
public Long createOrder(CreateOrderRequest request) {
    // 1. åˆ›å»ºè®¢å•
    Order order = buildOrder(request);
    orderMapper.insert(order);
    
    // 2. å‘é€æ‰£åº“å­˜æ¶ˆæ¯
    DeductStockMessage message = new DeductStockMessage();
    message.setProductId(request.getProductId());
    message.setQuantity(request.getQuantity());
    message.setOrderId(order.getId());
    
    rocketMQTemplate.syncSend("stock-deduct-topic", message);
    
    return order.getId();
}

// åº“å­˜æœåŠ¡ï¼šæ¶ˆè´¹æ¶ˆæ¯
@RocketMQMessageListener(
    topic = "stock-deduct-topic",
    consumerGroup = "stock-consumer-group"
)
public class StockDeductListener implements RocketMQListener<DeductStockMessage> {
    
    @Override
    public void onMessage(DeductStockMessage message) {
        // æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ‰£å‡åº“å­˜
        boolean success = stockService.deductStock(
            message.getProductId(), 
            message.getQuantity()
        );
        
        if (!success) {
            throw new RuntimeException("åº“å­˜æ‰£å‡å¤±è´¥ï¼Œè§¦å‘é‡è¯•");
        }
    }
}
```

> ğŸ“ **é‡è¯•æœºåˆ¶è¯´æ˜**  
> å¦‚æœåº“å­˜æ‰£å‡å¤±è´¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¼šè‡ªåŠ¨é‡è¯•ï¼ˆé»˜è®¤é‡è¯•3æ¬¡ï¼‰ã€‚å¦‚æœ3æ¬¡éƒ½å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œäººå·¥å¤„ç†ã€‚

### 8.3 å¹‚ç­‰æ€§ä¿è¯


**ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§ï¼Ÿ**
å°±æ˜¯æ— è®ºæ“ä½œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½ä¸€æ ·ã€‚å°±åƒç”µç¯å¼€å…³ï¼ŒæŒ‰ä¸€æ¬¡å’ŒæŒ‰ä¸€ç™¾æ¬¡éƒ½æ˜¯å¼€ç€çš„ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰ï¼Ÿ**

```
æ¶ˆæ¯é‡å¤æ¶ˆè´¹åœºæ™¯ï¼š

ç¬¬1æ¬¡æ¶ˆæ¯ï¼šæ‰£å‡åº“å­˜10ä¸ª â†’ æˆåŠŸï¼Œåº“å­˜90
      â†“
ç½‘ç»œæ³¢åŠ¨ï¼Œæ¶ˆæ¯é˜Ÿåˆ—è®¤ä¸ºæ¶ˆè´¹å¤±è´¥
      â†“
ç¬¬2æ¬¡æ¶ˆæ¯ï¼šæ‰£å‡åº“å­˜10ä¸ª â†’ æˆåŠŸï¼Œåº“å­˜80 âœ—

ç»“æœï¼šæœ¬è¯¥æ‰£10ä¸ªï¼Œå®é™…æ‰£äº†20ä¸ªï¼
```

**å¹‚ç­‰å®ç°æ–¹æ¡ˆ**ï¼š

```java
@Override
public void onMessage(DeductStockMessage message) {
    String idempotentKey = "stock_deduct:" + message.getOrderId();
    
    // 1. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
    Boolean processed = redisTemplate.opsForValue()
        .setIfAbsent(idempotentKey, "1", 24, TimeUnit.HOURS);
    
    if (Boolean.FALSE.equals(processed)) {
        // å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
        return;
    }
    
    // 2. æ‰§è¡Œåº“å­˜æ‰£å‡
    stockService.deductStock(message.getProductId(), message.getQuantity());
}
```

> ğŸ’¡ **å¹‚ç­‰å…³é”®**  
> ä½¿ç”¨Redisçš„ `setIfAbsent` æ–¹æ³•ï¼ˆå°±æ˜¯ `setnx`ï¼‰ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ‰èƒ½è®¾ç½®æˆåŠŸï¼Œåç»­è®¾ç½®éƒ½å¤±è´¥ï¼Œä»è€Œä¿è¯åªå¤„ç†ä¸€æ¬¡ã€‚

---

## 9. ğŸ’³ åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†


### 9.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ä¼ ç»Ÿäº‹åŠ¡ vs åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š

```
å•ä½“åº”ç”¨çš„äº‹åŠ¡ï¼ˆç®€å•ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸€ä¸ªæ•°æ®åº“   â”‚
â”‚  BEGIN       â”‚
â”‚  æ‰£åº“å­˜      â”‚
â”‚  åˆ›å»ºè®¢å•    â”‚
â”‚  COMMIT      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç‰¹ç‚¹ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

å¾®æœåŠ¡çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆå¤æ‚ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åº“å­˜æœåŠ¡  â”‚    â”‚è®¢å•æœåŠ¡  â”‚    â”‚æ”¯ä»˜æœåŠ¡  â”‚
â”‚åº“å­˜DB    â”‚    â”‚è®¢å•DB    â”‚    â”‚æ”¯ä»˜DB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šä¸‰ä¸ªç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯ä¸€è‡´ï¼Ÿ
```

### 9.2 Seataåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ


**Seataæ˜¯ä»€ä¹ˆï¼Ÿ**
Seataæ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œå¯ä»¥è®©åˆ†å¸ƒå¼äº‹åŠ¡åƒæœ¬åœ°äº‹åŠ¡ä¸€æ ·ç®€å•ã€‚

**Seataå·¥ä½œåŸç†**ï¼š

```
Seata ATæ¨¡å¼å·¥ä½œæµç¨‹ï¼š

[1] å…¨å±€äº‹åŠ¡å¼€å§‹
      â†“
[2] è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•ï¼ˆè®°å½•å‰åé•œåƒï¼‰
      â†“
[3] åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜ï¼ˆè®°å½•å‰åé•œåƒï¼‰
      â†“
[4] æ”¯ä»˜æœåŠ¡ï¼šåˆ›å»ºæ”¯ä»˜å•ï¼ˆè®°å½•å‰åé•œåƒï¼‰
      â†“
[5] æ‰€æœ‰æœåŠ¡éƒ½æˆåŠŸ â†’ æäº¤å…¨å±€äº‹åŠ¡
      â†“
[6] æŸä¸ªæœåŠ¡å¤±è´¥ â†’ å›æ»šå…¨å±€äº‹åŠ¡
    ï¼ˆæ ¹æ®é•œåƒæ¢å¤æ•°æ®ï¼‰
```

**ä»£ç å®ç°**ï¼š

```java
// 1. å¼•å…¥Seataä¾èµ–
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>1.6.1</version>
</dependency>

// 2. è®¢å•æœåŠ¡ï¼šå¼€å¯å…¨å±€äº‹åŠ¡
@GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
@Override
public Long createOrder(CreateOrderRequest request) {
    // åˆ›å»ºè®¢å•
    Order order = buildOrder(request);
    orderMapper.insert(order);
    
    // è°ƒç”¨åº“å­˜æœåŠ¡æ‰£åº“å­˜ï¼ˆä¼šåŠ å…¥å…¨å±€äº‹åŠ¡ï¼‰
    stockService.deductStock(request.getProductId(), request.getQuantity());
    
    // è°ƒç”¨æ”¯ä»˜æœåŠ¡åˆ›å»ºæ”¯ä»˜å•ï¼ˆä¼šåŠ å…¥å…¨å±€äº‹åŠ¡ï¼‰
    paymentService.createPayment(buildPaymentRequest(order));
    
    // ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œå…¨éƒ¨å›æ»šï¼
    return order.getId();
}

// 3. åº“å­˜æœåŠ¡ï¼šå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡
@Override
public boolean deductStock(Long productId, Integer quantity) {
    // Seataä¼šè‡ªåŠ¨åŠ å…¥å…¨å±€äº‹åŠ¡ï¼Œæ— éœ€é¢å¤–ä»£ç 
    int updated = stockMapper.deductStock(productId, quantity);
    if (updated == 0) {
        throw new StockException("åº“å­˜ä¸è¶³");
    }
    return true;
}
```

> ğŸ¯ **å…³é”®æ³¨è§£è¯´æ˜**  
> - `@GlobalTransactional`ï¼šæ ‡è®°è¿™æ˜¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡çš„å‘èµ·ç‚¹
> - `rollbackFor = Exception.class`ï¼šä»»ä½•å¼‚å¸¸éƒ½å›æ»š
> - Seataä¼šè‡ªåŠ¨ç®¡ç†å…¶ä»–æœåŠ¡çš„äº‹åŠ¡ï¼Œå¼€å‘è€…åªéœ€è¦åŠ æ³¨è§£

### 9.3 åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----|------|------|---------|
| **Seata ATæ¨¡å¼** | å¯¹ä¸šåŠ¡æ— ä¾µå…¥ï¼Œè‡ªåŠ¨å›æ»š | æ€§èƒ½ç¨å·®ï¼Œä¾èµ–æ•°æ®åº“ | å¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯ |
| **TCCæ¨¡å¼** | æ€§èƒ½å¥½ï¼Œå¯é æ€§é«˜ | ä»£ç ä¾µå…¥æ€§å¼ºï¼Œè¦å†™è¡¥å¿é€»è¾‘ | å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | æ€§èƒ½å¥½ï¼Œè§£è€¦ | åªä¿è¯æœ€ç»ˆä¸€è‡´æ€§ | å…è®¸çŸ­æš‚ä¸ä¸€è‡´çš„åœºæ™¯ |
| **æœ¬åœ°æ¶ˆæ¯è¡¨** | ä¸ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶ | å®ç°å¤æ‚ | ç®€å•åœºæ™¯ |

**ğŸ” é€‰æ‹©å»ºè®®**ï¼š
- **æ–°æ‰‹æ¨è**ï¼šSeata ATæ¨¡å¼ï¼ˆç®€å•æ˜“ç”¨ï¼‰
- **é«˜æ€§èƒ½è¦æ±‚**ï¼šæ¶ˆæ¯é˜Ÿåˆ— + æœ€ç»ˆä¸€è‡´æ€§
- **é‡‘èçº§åœºæ™¯**ï¼šTCCæ¨¡å¼ï¼ˆä¸¥æ ¼ä¸€è‡´æ€§ï¼‰

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™ï¼š
- æŒ‰ä¸šåŠ¡åŠŸèƒ½æ‹†åˆ†ï¼ˆå•†å“ã€è®¢å•ã€æ”¯ä»˜ç­‰ï¼‰
- æœåŠ¡èŒè´£å•ä¸€ï¼Œè¾¹ç•Œæ¸…æ™°
- æœåŠ¡é—´é€šè¿‡Dubbo RPCè°ƒç”¨

ğŸ¯ æœåŠ¡è®¾è®¡è¦ç‚¹ï¼š
- æ¥å£å®šä¹‰æ¸…æ™°ï¼Œå‚æ•°åˆç†
- è¶…æ—¶æ—¶é—´åˆç†è®¾ç½®
- ç‰ˆæœ¬ç®¡ç†å’Œå‘ä¸‹å…¼å®¹

ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š
- ç¼“å­˜ä¼˜å…ˆï¼ˆRedisï¼‰
- å¹¶è¡Œè°ƒç”¨å‡å°‘è€—æ—¶
- æ‰¹é‡æ¥å£å‡å°‘è°ƒç”¨æ¬¡æ•°

ğŸ¯ ä¸€è‡´æ€§ä¿éšœï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡ä¿è¯å¼ºä¸€è‡´æ€§
- æ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- å¹‚ç­‰æ€§é˜²æ­¢é‡å¤å¤„ç†
```

### 10.2 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ’¡ æ–°æ‰‹å®¹æ˜“è¸©çš„å‘**ï¼š

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| **è¶…å–** | å¹¶å‘æ‰£åº“å­˜æ²¡æœ‰åŠ é” | ä½¿ç”¨Redisæˆ–æ•°æ®åº“ä¹è§‚é” |
| **é‡å¤æ”¯ä»˜** | å›è°ƒæ²¡æœ‰å¹‚ç­‰å¤„ç† | ç”¨è®¢å•å·åšå¹‚ç­‰é”® |
| **è°ƒç”¨è¶…æ—¶** | è¶…æ—¶æ—¶é—´è®¾ç½®å¤ªçŸ­ | æ ¹æ®å®é™…è€—æ—¶åˆç†è®¾ç½® |
| **æœåŠ¡é›ªå´©** | æ²¡æœ‰é™çº§å’Œç†”æ–­ | ä½¿ç”¨Sentinelé™æµé™çº§ |

**ğŸš€ ç³»ç»Ÿä¼˜åŒ–å»ºè®®**ï¼š

```
æ€§èƒ½ä¼˜åŒ–æ¸…å•ï¼š
âœ… çƒ­ç‚¹æ•°æ®æ”¾Redisç¼“å­˜
âœ… èƒ½å¹¶è¡Œçš„è°ƒç”¨å°±å¹¶è¡Œ
âœ… æ‰¹é‡æ¥å£æ›¿ä»£å¾ªç¯è°ƒç”¨
âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
âœ… å¼‚æ­¥å¤„ç†éå…³é”®æµç¨‹

å¯é æ€§ä¼˜åŒ–æ¸…å•ï¼š
âœ… é‡è¦æ¥å£åŠ å¹‚ç­‰
âœ… é™æµé˜²æ­¢å‹å®æœåŠ¡
âœ… ç†”æ–­é˜²æ­¢é›ªå´©
âœ… é‡è¯•æœºåˆ¶è¦åˆç†
âœ… ç›‘æ§å‘Šè­¦è¦åŠæ—¶
```

### 10.3 å®Œæ•´è°ƒç”¨é“¾è·¯å›é¡¾


```
ç”¨æˆ·ä¸‹å•å®Œæ•´æµç¨‹æ€»ç»“ï¼š

ç”¨æˆ·ç‚¹å‡»ä¸‹å•æŒ‰é’®
    â†“
è®¢å•æœåŠ¡ï¼ˆä¸»æ§ï¼‰
    â”œâ†’ éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·æœåŠ¡ï¼‰
    â”œâ†’ æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆå•†å“æœåŠ¡ï¼‰
    â”œâ†’ æ£€æŸ¥å¹¶æ‰£å‡åº“å­˜ï¼ˆåº“å­˜æœåŠ¡ï¼‰
    â”œâ†’ åˆ›å»ºè®¢å•è®°å½•ï¼ˆæœ¬åœ°æ•°æ®åº“ï¼‰
    â””â†’ åˆ›å»ºæ”¯ä»˜å•ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰
         â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
    â†“
æ”¯ä»˜å›è°ƒé€šçŸ¥
    â†“
è®¢å•çŠ¶æ€æ›´æ–°ä¸ºå·²æ”¯ä»˜
    â†“
è®¢å•å®Œæˆ
```

> ğŸ“š **å­¦ä¹ å»ºè®®**  
> 1. å…ˆç†è§£å•ä¸ªæœåŠ¡çš„å®ç°
> 2. å†ç†è§£æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»
> 3. æœ€åæŒæ¡åˆ†å¸ƒå¼äº‹åŠ¡å’Œä¸€è‡´æ€§
> 4. å¤šåŠ¨æ‰‹å®è·µï¼Œè·‘é€šå®Œæ•´æµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¾®æœåŠ¡èŒè´£è¦å•ä¸€ï¼Œè¾¹ç•Œæ¸…æ™°ä¸æ··ä¹±
- Dubboè°ƒç”¨åƒæ‰“ç”µè¯ï¼Œè¶…æ—¶ç‰ˆæœ¬è¦è®¾å¥½
- åº“å­˜æ‰£å‡è¦åŠ é”ï¼Œé˜²æ­¢è¶…å–å¾ˆé‡è¦
- åˆ†å¸ƒå¼äº‹åŠ¡ç”¨Seataï¼Œæœ€ç»ˆä¸€è‡´é é˜Ÿåˆ—
- å¹‚ç­‰æ€§èƒ½é˜²é‡å¤ï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘