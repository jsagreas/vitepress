---
title: 38ã€Dubboæ‰©å±•å¼€å‘å®æˆ˜æŒ‡å—
---
## ğŸ“š ç›®å½•

1. [Dubboæ‰©å±•æœºåˆ¶æ¦‚è¿°](#1-dubboæ‰©å±•æœºåˆ¶æ¦‚è¿°)
2. [è‡ªå®šä¹‰åè®®å¼€å‘](#2-è‡ªå®šä¹‰åè®®å¼€å‘)
3. [è‡ªå®šä¹‰åºåˆ—åŒ–å™¨](#3-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨)
4. [è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥](#4-è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥)
5. [è‡ªå®šä¹‰é›†ç¾¤å®¹é”™ç­–ç•¥](#5-è‡ªå®šä¹‰é›†ç¾¤å®¹é”™ç­–ç•¥)
6. [è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘](#6-è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘)
7. [è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒ](#7-è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒ)
8. [æ’ä»¶å¼€å‘è§„èŒƒ](#8-æ’ä»¶å¼€å‘è§„èŒƒ)
9. [æ‰©å±•ç‚¹æµ‹è¯•](#9-æ‰©å±•ç‚¹æµ‹è¯•)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Dubboæ‰©å±•æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Dubboæ‰©å±•æœºåˆ¶


> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> Dubboçš„æ‰©å±•æœºåˆ¶å°±åƒæ˜¯"æ’ä»¶ç³»ç»Ÿ"ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆæ‰‹æœºä¸Šçš„åº”ç”¨å•†åº—ã€‚Dubboæ¡†æ¶æœ¬èº«æä¾›äº†åŸºç¡€åŠŸèƒ½ï¼ˆå°±åƒæ‰‹æœºçš„æ“ä½œç³»ç»Ÿï¼‰ï¼Œè€Œæ‰©å±•æœºåˆ¶å…è®¸ä½ å¼€å‘è‡ªå·±çš„"æ’ä»¶"æ¥å¢å¼ºæˆ–æ›¿æ¢é»˜è®¤åŠŸèƒ½ã€‚

**é€šä¿—è§£é‡Š**ï¼š
```
ç”Ÿæ´»ç±»æ¯”ï¼š
ğŸ  æˆ¿å­è£…ä¿® = Dubboæ¡†æ¶
ğŸ”Œ ç”µå™¨æ’åº§ = æ‰©å±•ç‚¹æ¥å£
ğŸ”¦ å…·ä½“ç”µå™¨ = æ‰©å±•å®ç°

æˆ¿å­é¢„ç•™äº†æ’åº§ï¼ˆæ‰©å±•ç‚¹ï¼‰ï¼Œä½ å¯ä»¥æ’å…¥ä¸åŒçš„ç”µå™¨ï¼ˆè‡ªå®šä¹‰å®ç°ï¼‰
ä¸éœ€è¦æ”¹é€ æˆ¿å­ï¼Œåªéœ€è¦æŒ‰è§„èŒƒæ’å…¥ç”µå™¨å°±èƒ½ç”¨
```

**ä¸ºä»€ä¹ˆéœ€è¦æ‰©å±•æœºåˆ¶**ï¼š
- **ä¸æ”¹æºç **ï¼šæ— éœ€ä¿®æ”¹Dubboæ¡†æ¶ä»£ç 
- **çµæ´»æ›¿æ¢**ï¼šåƒæ¢æ’å¤´ä¸€æ ·æ–¹ä¾¿
- **ç»Ÿä¸€è§„èŒƒ**ï¼šæ‰€æœ‰æ‰©å±•éµå¾ªåŒæ ·çš„æ ‡å‡†

### 1.2 SPIæœºåˆ¶è¯¦è§£


**SPIæ˜¯ä»€ä¹ˆ**ï¼Ÿ
- **å…¨ç§°**ï¼šService Provider Interfaceï¼ˆæœåŠ¡æä¾›è€…æ¥å£ï¼‰
- **ä½œç”¨**ï¼šè®©ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å®ç°ç±»

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå†™æ­»äº†ï¼‰ï¼š
ä»£ç ä¸­ç›´æ¥ new å…·ä½“å®ç°ç±» â†’ ä¸çµæ´»

SPIæ–¹å¼ï¼ˆå¯æ›¿æ¢ï¼‰ï¼š
é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šå®ç°ç±» â†’ çµæ´»åˆ‡æ¢
```

**Dubbo SPI vs Java SPI**ï¼š

| å¯¹æ¯”é¡¹ | Java SPI | Dubbo SPI |
|--------|----------|-----------|
| **åŠ è½½æ–¹å¼** | ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å®ç° | æŒ‰éœ€åŠ è½½ï¼ŒèŠ‚çœèµ„æº |
| **ä¾èµ–æ³¨å…¥** | âŒ ä¸æ”¯æŒ | âœ… è‡ªåŠ¨æ³¨å…¥ä¾èµ– |
| **å®ä¾‹ç¼“å­˜** | âŒ æ¯æ¬¡æ–°å»º | âœ… å•ä¾‹ç¼“å­˜ |
| **æ‰©å±•ç‚¹åŒ…è£…** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒAOPåŠŸèƒ½ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•æ‰©å±• | å¤æ‚å¾®æœåŠ¡æ¶æ„ |

> **ğŸ” æ·±å…¥ç†è§£**  
> Dubbo SPIæ˜¯Java SPIçš„å¢å¼ºç‰ˆï¼Œä¸“é—¨ä¸ºå¾®æœåŠ¡è®¾è®¡ã€‚å°±åƒæ™®é€šæ±½è½¦å‡çº§æˆäº†æ™ºèƒ½æ±½è½¦ï¼Œä¸ä»…èƒ½å¼€ï¼Œè¿˜èƒ½è‡ªåŠ¨é©¾é©¶ã€‚

### 1.3 æ‰©å±•ç‚¹é…ç½®è§„èŒƒ


**é…ç½®æ–‡ä»¶ä½ç½®**ï¼š
```
é¡¹ç›®ç»“æ„ï¼š
src/main/resources/
  â””â”€â”€ META-INF/
      â””â”€â”€ dubbo/
          â”œâ”€â”€ org.apache.dubbo.rpc.Protocol        â† åè®®æ‰©å±•ç‚¹
          â”œâ”€â”€ org.apache.dubbo.common.serialize.Serialization  â† åºåˆ—åŒ–æ‰©å±•ç‚¹
          â””â”€â”€ org.apache.dubbo.rpc.cluster.LoadBalance        â† è´Ÿè½½å‡è¡¡æ‰©å±•ç‚¹
```

**é…ç½®æ–‡ä»¶æ ¼å¼**ï¼š
```properties
# æ ¼å¼ï¼šæ‰©å±•å=å®ç°ç±»å…¨è·¯å¾„
myprotocol=com.example.MyProtocol
customserializer=com.example.CustomSerializer
```

> **âš ï¸ å¸¸è§è¯¯åŒº**  
> æ–°æ‰‹å®¹æ˜“æŠŠé…ç½®æ–‡ä»¶æ”¾é”™ä½ç½®ï¼è®°ä½ï¼šå¿…é¡»åœ¨`META-INF/dubbo/`ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åæ˜¯æ‰©å±•ç‚¹æ¥å£çš„å…¨é™å®šåã€‚

---

## 2. ğŸŒ è‡ªå®šä¹‰åè®®å¼€å‘


### 2.1 åè®®æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
åè®® = ä¸¤ä¸ªäººè¯´è¯çš„è§„åˆ™

æ™®é€šè¯åè®®ï¼šä½ å¥½ â†’ å¯¹æ–¹å¬æ‡‚
è‹±è¯­åè®®ï¼šHello â†’ å¯¹æ–¹å¬æ‡‚
ç«æ˜Ÿæ–‡åè®®ï¼š@#$% â†’ å¯¹æ–¹å¬ä¸æ‡‚

Dubboåè®® = æœåŠ¡é—´é€šä¿¡çš„"è¯­è¨€è§„åˆ™"
```

**Dubboé»˜è®¤åè®®**ï¼š
- `dubbo://` - é«˜æ€§èƒ½RPCåè®®ï¼ˆé»˜è®¤ï¼‰
- `http://` - åŸºäºHTTPçš„åè®®
- `rest://` - RESTfulé£æ ¼åè®®

### 2.2 ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰åè®®


**å®é™…åœºæ™¯**ï¼š
- **ç‰¹æ®Šç½‘ç»œç¯å¢ƒ**ï¼šå…¬å¸å†…ç½‘æœ‰ç‰¹æ®ŠåŠ å¯†è¦æ±‚
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹ç‰¹å®šä¸šåŠ¡ä¼˜åŒ–ä¼ è¾“æ•ˆç‡
- **å…¼å®¹è€ç³»ç»Ÿ**ï¼šéœ€è¦å’Œæ—§ç³»ç»Ÿçš„åè®®å¯¹æ¥

### 2.3 è‡ªå®šä¹‰åè®®å®ç°æ­¥éª¤


**ç¬¬ä¸€æ­¥ï¼šå®ç°Protocolæ¥å£**

```java
// 1. åˆ›å»ºè‡ªå®šä¹‰åè®®ç±»
@SPI("myprotocol")  // å£°æ˜è¿™æ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œé»˜è®¤åç§°ä¸ºmyprotocol
public class MyProtocol extends AbstractProtocol {
    
    // æœåŠ¡æš´éœ²ï¼šè®©æœåŠ¡å¯ä»¥è¢«è°ƒç”¨
    @Override
    public <T> Exporter<T> export(Invoker<T> invoker) {
        // å¯åŠ¨æœåŠ¡å™¨ï¼Œç›‘å¬ç«¯å£
        return new MyExporter<>(invoker);
    }
    
    // æœåŠ¡å¼•ç”¨ï¼šè®©å®¢æˆ·ç«¯å¯ä»¥è°ƒç”¨è¿œç¨‹æœåŠ¡
    @Override
    public <T> Invoker<T> refer(Class<T> type, URL url) {
        // åˆ›å»ºå®¢æˆ·ç«¯è¿æ¥
        return new MyInvoker<>(type, url);
    }
}
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> `export`å°±åƒå¼€åº—ï¼šä½ æŠŠåº—å¼€èµ·æ¥ï¼Œç­‰é¡¾å®¢ä¸Šé—¨  
> `refer`å°±åƒå½“é¡¾å®¢ï¼šä½ æ‰¾åˆ°åº—çš„åœ°å€ï¼Œè¿›å»æ¶ˆè´¹

**ç¬¬äºŒæ­¥ï¼šé…ç½®æ‰©å±•ç‚¹**

```properties
# æ–‡ä»¶ï¼šMETA-INF/dubbo/org.apache.dubbo.rpc.Protocol
myprotocol=com.example.protocol.MyProtocol
```

**ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨è‡ªå®šä¹‰åè®®**

```xml
<!-- æœåŠ¡æä¾›è€…é…ç½® -->
<dubbo:protocol name="myprotocol" port="20880" />

<!-- æˆ–è€…åœ¨æ³¨è§£ä¸­ä½¿ç”¨ -->
@DubboService(protocol = "myprotocol")
public class UserServiceImpl implements UserService {
    // ä¸šåŠ¡ä»£ç 
}
```

### 2.4 å®æˆ˜æ¡ˆä¾‹ï¼šåŠ å¯†åè®®


**åœºæ™¯**ï¼šå¼€å‘ä¸€ä¸ªè‡ªåŠ¨åŠ å¯†ä¼ è¾“æ•°æ®çš„åè®®

```java
public class EncryptProtocol extends AbstractProtocol {
    
    @Override
    public <T> Exporter<T> export(Invoker<T> invoker) {
        // åŒ…è£…åŸå§‹Invokerï¼Œæ·»åŠ è§£å¯†åŠŸèƒ½
        Invoker<T> encryptedInvoker = new InvokerWrapper<T>(invoker) {
            @Override
            public Result invoke(Invocation invocation) {
                // 1. æ¥æ”¶åˆ°åŠ å¯†çš„è¯·æ±‚
                Object[] args = invocation.getArguments();
                // 2. è§£å¯†å‚æ•°
                Object[] decryptedArgs = decrypt(args);
                // 3. è°ƒç”¨çœŸå®æœåŠ¡
                invocation.setArguments(decryptedArgs);
                Result result = invoker.invoke(invocation);
                // 4. åŠ å¯†è¿”å›ç»“æœ
                result.setValue(encrypt(result.getValue()));
                return result;
            }
        };
        return new SimpleExporter<>(encryptedInvoker);
    }
    
    private Object[] decrypt(Object[] data) {
        // è§£å¯†é€»è¾‘ï¼ˆç¤ºä¾‹ç®€åŒ–ï¼‰
        return Arrays.stream(data)
            .map(obj -> AES.decrypt(obj))
            .toArray();
    }
    
    private Object encrypt(Object data) {
        // åŠ å¯†é€»è¾‘
        return AES.encrypt(data);
    }
}
```

> **ğŸ”” æ³¨æ„äº‹é¡¹**  
> è‡ªå®šä¹‰åè®®éœ€è¦å¤„ç†ï¼šç½‘ç»œä¼ è¾“ã€ç¼–è§£ç ã€å¼‚å¸¸å¤„ç†ã€è¶…æ—¶æ§åˆ¶ç­‰ã€‚å»ºè®®ç»§æ‰¿`AbstractProtocol`æ¥ç®€åŒ–å¼€å‘ã€‚

---

## 3. ğŸ“¦ è‡ªå®šä¹‰åºåˆ—åŒ–å™¨


### 3.1 åºåˆ—åŒ–æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
åºåˆ—åŒ– = æ‰“åŒ…å¿«é€’
å¯¹è±¡ï¼ˆå•†å“ï¼‰ â†’ å­—èŠ‚æµï¼ˆæ‰“åŒ…å¥½çš„ç®±å­ï¼‰ â†’ ç½‘ç»œä¼ è¾“ï¼ˆç‰©æµè¿è¾“ï¼‰

ååºåˆ—åŒ– = æ‹†å¿«é€’
å­—èŠ‚æµï¼ˆæ”¶åˆ°ç®±å­ï¼‰ â†’ å¯¹è±¡ï¼ˆå–å‡ºå•†å“ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦åºåˆ—åŒ–**ï¼š
- Javaå¯¹è±¡æ— æ³•ç›´æ¥é€šè¿‡ç½‘ç»œä¼ è¾“
- éœ€è¦è½¬æˆå­—èŠ‚æµæ‰èƒ½å‘é€
- æ¥æ”¶æ–¹å†è¿˜åŸæˆå¯¹è±¡

### 3.2 å¸¸è§åºåˆ—åŒ–æ–¹å¼å¯¹æ¯”


| åºåˆ—åŒ–æ–¹å¼ | é€Ÿåº¦ âš¡ | ä½“ç§¯ ğŸ“¦ | è·¨è¯­è¨€ ğŸŒ | é€‚ç”¨åœºæ™¯ |
|-----------|---------|---------|-----------|----------|
| **Hessian** | å¿« | å° | âœ… æ”¯æŒ | Dubboé»˜è®¤ï¼Œé€šç”¨åœºæ™¯ |
| **JSON** | ä¸­ç­‰ | è¾ƒå¤§ | âœ… æ”¯æŒ | å¯è¯»æ€§è¦æ±‚é«˜ |
| **Protobuf** | å¾ˆå¿« | å¾ˆå° | âœ… æ”¯æŒ | é«˜æ€§èƒ½åœºæ™¯ |
| **Kryo** | å¾ˆå¿« | å¾ˆå° | âŒ Javaä¸“ç”¨ | Javaå†…éƒ¨é€šä¿¡ |
| **FST** | å¾ˆå¿« | å° | âŒ Javaä¸“ç”¨ | Javaå†…éƒ¨é€šä¿¡ |

### 3.3 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å®ç°


**ç¬¬ä¸€æ­¥ï¼šå®ç°Serializationæ¥å£**

```java
// è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ä¸»ç±»
@SPI("myserialization")
public class MyCustomSerialization implements Serialization {
    
    @Override
    public byte getContentTypeId() {
        return 100;  // å”¯ä¸€IDï¼Œä¸è¦å’Œå…¶ä»–åºåˆ—åŒ–å™¨å†²çª
    }
    
    @Override
    public String getContentType() {
        return "application/x-my-custom";  // MIMEç±»å‹
    }
    
    @Override
    public ObjectOutput serialize(URL url, OutputStream output) {
        // è¿”å›åºåˆ—åŒ–è¾“å‡ºæµ
        return new MyObjectOutput(output);
    }
    
    @Override
    public ObjectInput deserialize(URL url, InputStream input) {
        // è¿”å›ååºåˆ—åŒ–è¾“å…¥æµ
        return new MyObjectInput(input);
    }
}
```

**ç¬¬äºŒæ­¥ï¼šå®ç°åºåˆ—åŒ–è¾“å‡ºæµ**

```java
public class MyObjectOutput implements ObjectOutput {
    private final OutputStream output;
    
    public MyObjectOutput(OutputStream output) {
        this.output = output;
    }
    
    @Override
    public void writeObject(Object obj) throws IOException {
        // æ ¸å¿ƒï¼šæŠŠå¯¹è±¡è½¬æˆå­—èŠ‚
        byte[] bytes = convertToBytes(obj);
        output.write(bytes);
    }
    
    private byte[] convertToBytes(Object obj) {
        // å®é™…åºåˆ—åŒ–é€»è¾‘ï¼ˆå¯ä½¿ç”¨JSONã€Protobufç­‰ï¼‰
        return JSON.toJSONBytes(obj);
    }
    
    // å…¶ä»–æ–¹æ³•ï¼šwriteIntã€writeStringç­‰
}
```

**ç¬¬ä¸‰æ­¥ï¼šå®ç°ååºåˆ—åŒ–è¾“å…¥æµ**

```java
public class MyObjectInput implements ObjectInput {
    private final InputStream input;
    
    public MyObjectInput(InputStream input) {
        this.input = input;
    }
    
    @Override
    public Object readObject() throws IOException {
        // æ ¸å¿ƒï¼šæŠŠå­—èŠ‚è¿˜åŸæˆå¯¹è±¡
        byte[] bytes = readAllBytes();
        return convertToObject(bytes);
    }
    
    private Object convertToObject(byte[] bytes) {
        return JSON.parseObject(bytes, Object.class);
    }
}
```

**ç¬¬å››æ­¥ï¼šé…ç½®å’Œä½¿ç”¨**

```properties
# META-INF/dubbo/org.apache.dubbo.common.serialize.Serialization
myserialization=com.example.MyCustomSerialization
```

```xml
<!-- æœåŠ¡ç«¯æŒ‡å®šåºåˆ—åŒ–æ–¹å¼ -->
<dubbo:protocol name="dubbo" serialization="myserialization" />
```

> **âš ï¸ æ€§èƒ½è€ƒè™‘**  
> è‡ªå®šä¹‰åºåˆ—åŒ–å™¨è¦æƒè¡¡é€Ÿåº¦å’Œä½“ç§¯ã€‚å¦‚æœåªæ˜¯ä¸ºäº†å­¦ä¹ ï¼Œå¯ä»¥ç”¨JSONç®€åŒ–å¼€å‘ï¼›ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æˆç†Ÿçš„æ–¹æ¡ˆå¦‚Protobufã€‚

---

## 4. âš–ï¸ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥


### 4.1 è´Ÿè½½å‡è¡¡æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
åœºæ™¯ï¼šé¤å…æœ‰3ä¸ªæ”¶é“¶å°

éšæœºç­–ç•¥ï¼šé¡¾å®¢éšä¾¿é€‰ä¸€ä¸ªçª—å£
è½®è¯¢ç­–ç•¥ï¼š1å·â†’2å·â†’3å·â†’1å·å¾ªç¯
æœ€å°‘æ´»è·ƒç­–ç•¥ï¼šå“ªä¸ªçª—å£æ’é˜Ÿäººå°‘å»å“ªä¸ª
```

**Dubboé»˜è®¤ç­–ç•¥**ï¼š
- `random` - éšæœºï¼ˆé»˜è®¤ï¼‰
- `roundrobin` - è½®è¯¢
- `leastactive` - æœ€å°‘æ´»è·ƒè°ƒç”¨
- `consistenthash` - ä¸€è‡´æ€§å“ˆå¸Œ

### 4.2 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡


**å®é™…éœ€æ±‚**ï¼š
- **æŒ‰æœºå™¨æ€§èƒ½åˆ†é…**ï¼šæ€§èƒ½å¥½çš„æœºå™¨å¤šåˆ†é…è¯·æ±‚
- **æŒ‰åœ°åŸŸä¼˜å…ˆ**ï¼šä¼˜å…ˆè°ƒç”¨åŒæœºæˆ¿çš„æœåŠ¡
- **æŒ‰ä¸šåŠ¡è§„åˆ™**ï¼šVIPç”¨æˆ·èµ°é«˜æ€§èƒ½æœåŠ¡å™¨

### 4.3 è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡å®ç°


**ç¬¬ä¸€æ­¥ï¼šç»§æ‰¿AbstractLoadBalance**

```java
public class CustomLoadBalance extends AbstractLoadBalance {
    
    @Override
    protected <T> Invoker<T> doSelect(
        List<Invoker<T>> invokers,  // å¯ç”¨çš„æœåŠ¡æä¾›è€…åˆ—è¡¨
        URL url,                     // è¯·æ±‚URL
        Invocation invocation        // è°ƒç”¨ä¿¡æ¯
    ) {
        // è‡ªå®šä¹‰é€‰æ‹©é€»è¾‘
        return selectByCustomRule(invokers, invocation);
    }
    
    private <T> Invoker<T> selectByCustomRule(
        List<Invoker<T>> invokers, 
        Invocation invocation
    ) {
        // ç¤ºä¾‹ï¼šæ ¹æ®å‚æ•°å€¼é€‰æ‹©
        String userId = (String) invocation.getArguments()[0];
        
        // VIPç”¨æˆ·èµ°ç¬¬ä¸€å°æœåŠ¡å™¨
        if (isVipUser(userId)) {
            return invokers.get(0);
        }
        
        // æ™®é€šç”¨æˆ·éšæœºé€‰æ‹©
        int index = ThreadLocalRandom.current().nextInt(invokers.size());
        return invokers.get(index);
    }
    
    private boolean isVipUser(String userId) {
        // åˆ¤æ–­æ˜¯å¦VIPç”¨æˆ·
        return userId.startsWith("VIP");
    }
}
```

> **ğŸ’¡ è®¾è®¡æ€è·¯**  
> `doSelect`æ–¹æ³•æ¥æ”¶æ‰€æœ‰å¯ç”¨æœåŠ¡å™¨ï¼Œä½ å¯ä»¥åŸºäºä»»ä½•è§„åˆ™é€‰æ‹©ï¼šæ€§èƒ½ã€åœ°åŸŸã€ä¸šåŠ¡å±æ€§ç­‰ã€‚

**å®æˆ˜æ¡ˆä¾‹ï¼šæƒé‡+å“åº”æ—¶é—´ç­–ç•¥**

```java
public class WeightedResponseTimeLoadBalance extends AbstractLoadBalance {
    
    // è®°å½•æ¯ä¸ªæœåŠ¡çš„å“åº”æ—¶é—´
    private Map<String, Long> responseTimeMap = new ConcurrentHashMap<>();
    
    @Override
    protected <T> Invoker<T> doSelect(
        List<Invoker<T>> invokers, 
        URL url, 
        Invocation invocation
    ) {
        // è®¡ç®—æ¯ä¸ªæœåŠ¡çš„ç»¼åˆå¾—åˆ†
        List<ScoredInvoker<T>> scoredInvokers = invokers.stream()
            .map(invoker -> {
                int weight = getWeight(invoker, invocation);  // é…ç½®çš„æƒé‡
                long responseTime = getResponseTime(invoker); // å†å²å“åº”æ—¶é—´
                
                // å¾—åˆ† = æƒé‡ / å“åº”æ—¶é—´ï¼ˆå“åº”è¶Šå¿«å¾—åˆ†è¶Šé«˜ï¼‰
                double score = (double) weight / (responseTime + 1);
                
                return new ScoredInvoker<>(invoker, score);
            })
            .collect(Collectors.toList());
        
        // æŒ‰å¾—åˆ†éšæœºé€‰æ‹©ï¼ˆå¾—åˆ†é«˜çš„æ¦‚ç‡å¤§ï¼‰
        return weightedRandomSelect(scoredInvokers);
    }
    
    private long getResponseTime(Invoker<?> invoker) {
        String key = invoker.getUrl().getAddress();
        return responseTimeMap.getOrDefault(key, 100L);
    }
    
    // åŠ æƒéšæœºé€‰æ‹©
    private <T> Invoker<T> weightedRandomSelect(List<ScoredInvoker<T>> invokers) {
        double totalScore = invokers.stream()
            .mapToDouble(ScoredInvoker::getScore)
            .sum();
        
        double random = ThreadLocalRandom.current().nextDouble(totalScore);
        double cumulative = 0;
        
        for (ScoredInvoker<T> invoker : invokers) {
            cumulative += invoker.getScore();
            if (random <= cumulative) {
                return invoker.getInvoker();
            }
        }
        
        return invokers.get(0).getInvoker();
    }
}
```

**é…ç½®ä½¿ç”¨**ï¼š

```java
@DubboReference(loadbalance = "customloadbalance")
private UserService userService;
```

> **ğŸ” æ‰©å±•æ€è·¯**  
> ä½ å¯ä»¥æ”¶é›†æ›´å¤šæŒ‡æ ‡ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€é”™è¯¯ç‡ç­‰ï¼Œç»¼åˆè®¡ç®—å¾—åˆ†ã€‚å°±åƒé€‰é¤å…ä¸ä»…çœ‹ä»·æ ¼ï¼Œè¿˜è¦çœ‹è¯„åˆ†ã€è·ç¦»ç­‰ã€‚

---

## 5. ğŸ›¡ï¸ è‡ªå®šä¹‰é›†ç¾¤å®¹é”™ç­–ç•¥


### 5.1 é›†ç¾¤å®¹é”™æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
åœºæ™¯ï¼šä½ è¦ä¹°ä¸€ç“¶æ°´

Failoverï¼ˆå¤±è´¥é‡è¯•ï¼‰ï¼š
ç¬¬1å®¶å°å–éƒ¨æ²¡è´§ â†’ å»ç¬¬2å®¶ â†’ è¿˜æ²¡è´§ â†’ å»ç¬¬3å®¶

Failfastï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰ï¼š
ç¬¬1å®¶æ²¡è´§ â†’ ç«‹å³æ”¾å¼ƒï¼Œä¸å†æ‰¾äº†

Failsafeï¼ˆå¤±è´¥å®‰å…¨ï¼‰ï¼š
ç¬¬1å®¶æ²¡è´§ â†’ è®°å½•ä¸€ä¸‹ï¼Œå‡è£…ä¹°åˆ°äº†ï¼ˆä¸å½±å“ä¸»æµç¨‹ï¼‰

Forkingï¼ˆå¹¶å‘è°ƒç”¨ï¼‰ï¼š
åŒæ—¶å»3å®¶å°å–éƒ¨é—®ï¼Œè°å…ˆå›å¤ä¹°è°çš„
```

**Dubboé»˜è®¤ç­–ç•¥**ï¼š

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **Failover** | å¤±è´¥é‡è¯•å…¶ä»–æœåŠ¡å™¨ | æŸ¥è¯¢æ“ä½œï¼ˆå¹‚ç­‰ï¼‰ |
| **Failfast** | å¿«é€Ÿå¤±è´¥ï¼Œä¸é‡è¯• | å†™æ“ä½œï¼ˆéå¹‚ç­‰ï¼‰ |
| **Failsafe** | å¤±è´¥å¿½ç•¥ï¼Œè¿”å›ç©ºç»“æœ | æ—¥å¿—è®°å½•ç­‰ |
| **Failback** | å¤±è´¥åå°é‡è¯• | æ¶ˆæ¯é€šçŸ¥ |
| **Forking** | å¹¶å‘è°ƒç”¨å¤šä¸ªï¼Œå–æœ€å¿« | å®æ—¶æ€§è¦æ±‚é«˜ |

### 5.2 è‡ªå®šä¹‰å®¹é”™ç­–ç•¥å®ç°


**ç¬¬ä¸€æ­¥ï¼šç»§æ‰¿AbstractClusterInvoker**

```java
public class CustomCluster extends AbstractCluster {
    
    @Override
    public <T> Invoker<T> doJoin(Directory<T> directory) {
        return new CustomClusterInvoker<>(directory);
    }
    
    private static class CustomClusterInvoker<T> extends AbstractClusterInvoker<T> {
        
        public CustomClusterInvoker(Directory<T> directory) {
            super(directory);
        }
        
        @Override
        protected Result doInvoke(
            Invocation invocation,
            List<Invoker<T>> invokers,
            LoadBalance loadbalance
        ) {
            // è‡ªå®šä¹‰å®¹é”™é€»è¾‘
            return invokeWithCustomRule(invocation, invokers, loadbalance);
        }
    }
}
```

**å®æˆ˜æ¡ˆä¾‹ï¼šæ™ºèƒ½é™çº§ç­–ç•¥**

```java
// å½“é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨é™çº§
public class SmartDegradeClusterInvoker<T> extends AbstractClusterInvoker<T> {
    
    // é”™è¯¯ç‡ç»Ÿè®¡
    private Map<String, ErrorRateCounter> errorRateMap = new ConcurrentHashMap<>();
    private static final double ERROR_THRESHOLD = 0.5; // 50%é”™è¯¯ç‡é˜ˆå€¼
    
    @Override
    protected Result doInvoke(
        Invocation invocation, 
        List<Invoker<T>> invokers,
        LoadBalance loadbalance
    ) {
        // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦é™çº§
        if (shouldDegrade(invokers)) {
            return executeDegradeLogic(invocation);
        }
        
        // 2. æ­£å¸¸è°ƒç”¨
        Invoker<T> invoker = select(loadbalance, invocation, invokers, null);
        
        try {
            Result result = invoker.invoke(invocation);
            recordSuccess(invoker);
            return result;
            
        } catch (RpcException e) {
            recordFailure(invoker);
            
            // 3. å¤±è´¥åæ£€æŸ¥æ˜¯å¦è¾¾åˆ°é™çº§æ¡ä»¶
            if (getErrorRate(invoker) > ERROR_THRESHOLD) {
                return executeDegradeLogic(invocation);
            }
            
            throw e;
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥é™çº§
    private boolean shouldDegrade(List<Invoker<T>> invokers) {
        long healthyCount = invokers.stream()
            .filter(invoker -> getErrorRate(invoker) < ERROR_THRESHOLD)
            .count();
        
        // å¦‚æœå¥åº·çš„æœåŠ¡å™¨å°‘äº30%ï¼Œè§¦å‘é™çº§
        return healthyCount < invokers.size() * 0.3;
    }
    
    // é™çº§é€»è¾‘ï¼šè¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜æ•°æ®
    private Result executeDegradeLogic(Invocation invocation) {
        String methodName = invocation.getMethodName();
        
        // ä»ç¼“å­˜è·å–æ—§æ•°æ®
        Object cachedResult = getCachedResult(methodName);
        if (cachedResult != null) {
            return AsyncRpcResult.newDefaultAsyncResult(cachedResult, invocation);
        }
        
        // è¿”å›é»˜è®¤å€¼
        return AsyncRpcResult.newDefaultAsyncResult(
            getDefaultValue(invocation.getReturnType()), 
            invocation
        );
    }
    
    private double getErrorRate(Invoker<?> invoker) {
        String key = invoker.getUrl().getAddress();
        ErrorRateCounter counter = errorRateMap.get(key);
        return counter == null ? 0 : counter.getErrorRate();
    }
}
```

> **ğŸ”” è®¾è®¡è¦ç‚¹**  
> å®¹é”™ç­–ç•¥è¦è€ƒè™‘ï¼šé‡è¯•æ¬¡æ•°ã€è¶…æ—¶æ—¶é—´ã€é™çº§é€»è¾‘ã€ç†”æ–­æ¢å¤ã€‚å°±åƒå¼€è½¦å¯¼èˆªï¼Œå µè½¦æ—¶è¦è‡ªåŠ¨è§„åˆ’æ–°è·¯çº¿ã€‚

---

## 6. ğŸ”§ è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘


### 6.1 è¿‡æ»¤å™¨æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
è¿‡æ»¤å™¨ = å®‰æ£€é—¨

è¯·æ±‚è¿›æ¥ â†’ ç»è¿‡å®‰æ£€é—¨ï¼ˆè¿‡æ»¤å™¨ï¼‰ â†’ åˆ°è¾¾æœåŠ¡
                  â†“
              æ£€æŸ¥æƒé™
              è®°å½•æ—¥å¿—
              ç»Ÿè®¡è€—æ—¶
              å‚æ•°æ ¡éªŒ
```

**è¿‡æ»¤å™¨ç‰¹ç‚¹**ï¼š
- **é“¾å¼è°ƒç”¨**ï¼šå¤šä¸ªè¿‡æ»¤å™¨ä¾æ¬¡æ‰§è¡Œ
- **åŒå‘æ‹¦æˆª**ï¼šè¯·æ±‚å’Œå“åº”éƒ½èƒ½æ‹¦æˆª
- **æ— ä¾µå…¥**ï¼šä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç 

### 6.2 è¿‡æ»¤å™¨æ‰§è¡Œæµç¨‹


```
æ¶ˆè´¹è€…                                          æä¾›è€…
  â†“                                              â†“
[è¿‡æ»¤å™¨1] â†’ [è¿‡æ»¤å™¨2] â†’ ç½‘ç»œä¼ è¾“ â†’ [è¿‡æ»¤å™¨3] â†’ [è¿‡æ»¤å™¨4] â†’ ä¸šåŠ¡æ–¹æ³•
  â†‘                                              â†‘
è¯·æ±‚å‰å¤„ç†                                    è¯·æ±‚åå¤„ç†
```

### 6.3 è‡ªå®šä¹‰è¿‡æ»¤å™¨å®ç°


**ç¬¬ä¸€æ­¥ï¼šå®ç°Filteræ¥å£**

```java
// è‡ªå®šä¹‰æ—¥å¿—è¿‡æ»¤å™¨
@Activate(group = {CommonConstants.CONSUMER, CommonConstants.PROVIDER})
public class LogFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) 
        throws RpcException {
        
        long startTime = System.currentTimeMillis();
        String methodName = invocation.getMethodName();
        
        try {
            // å‰ç½®å¤„ç†ï¼šè®°å½•è¯·æ±‚
            System.out.println("è°ƒç”¨æ–¹æ³•ï¼š" + methodName);
            System.out.println("å‚æ•°ï¼š" + Arrays.toString(invocation.getArguments()));
            
            // æ‰§è¡ŒçœŸæ­£çš„è°ƒç”¨
            Result result = invoker.invoke(invocation);
            
            // åç½®å¤„ç†ï¼šè®°å½•å“åº”
            long costTime = System.currentTimeMillis() - startTime;
            System.out.println("æ–¹æ³•è€—æ—¶ï¼š" + costTime + "ms");
            System.out.println("è¿”å›ç»“æœï¼š" + result.getValue());
            
            return result;
            
        } catch (RpcException e) {
            // å¼‚å¸¸å¤„ç†
            System.err.println("è°ƒç”¨å¼‚å¸¸ï¼š" + e.getMessage());
            throw e;
        }
    }
}
```

> **ğŸ’¡ å…³é”®æ³¨è§£**  
> `@Activate`æŒ‡å®šè¿‡æ»¤å™¨ç”Ÿæ•ˆèŒƒå›´ï¼š
> - `CONSUMER`ï¼šæ¶ˆè´¹è€…ç«¯ç”Ÿæ•ˆ
> - `PROVIDER`ï¼šæä¾›è€…ç«¯ç”Ÿæ•ˆ
> - ä¸¤è€…éƒ½å†™ï¼šåŒç«¯éƒ½ç”Ÿæ•ˆ

**å®æˆ˜æ¡ˆä¾‹1ï¼šå‚æ•°æ ¡éªŒè¿‡æ»¤å™¨**

```java
@Activate(group = CommonConstants.PROVIDER)
public class ValidationFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // è·å–æ–¹æ³•å‚æ•°
        Object[] args = invocation.getArguments();
        
        // æ ¡éªŒå‚æ•°
        for (Object arg : args) {
            if (!validate(arg)) {
                throw new RpcException("å‚æ•°æ ¡éªŒå¤±è´¥ï¼š" + arg);
            }
        }
        
        return invoker.invoke(invocation);
    }
    
    private boolean validate(Object param) {
        if (param == null) {
            return false;
        }
        
        // ä½¿ç”¨javax.validationæ ¡éªŒ
        Set<ConstraintViolation<Object>> violations = 
            validator.validate(param);
        
        return violations.isEmpty();
    }
}
```

**å®æˆ˜æ¡ˆä¾‹2ï¼šé™æµè¿‡æ»¤å™¨**

```java
@Activate(group = CommonConstants.PROVIDER)
public class RateLimitFilter implements Filter {
    
    // ä½¿ç”¨Guavaçš„RateLimiter
    private Map<String, RateLimiter> limiters = new ConcurrentHashMap<>();
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        String methodKey = invoker.getInterface().getName() 
            + "." + invocation.getMethodName();
        
        // è·å–æˆ–åˆ›å»ºé™æµå™¨ï¼ˆæ¯ç§’100ä¸ªè¯·æ±‚ï¼‰
        RateLimiter limiter = limiters.computeIfAbsent(
            methodKey, 
            k -> RateLimiter.create(100)
        );
        
        // å°è¯•è·å–ä»¤ç‰Œ
        if (!limiter.tryAcquire()) {
            throw new RpcException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        return invoker.invoke(invocation);
    }
}
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®è¿‡æ»¤å™¨**

```properties
# META-INF/dubbo/org.apache.dubbo.rpc.Filter
logfilter=com.example.filter.LogFilter
validation=com.example.filter.ValidationFilter
ratelimit=com.example.filter.RateLimitFilter
```

**ç¬¬ä¸‰æ­¥ï¼šæ¿€æ´»è¿‡æ»¤å™¨**

```java
// æ–¹å¼1ï¼šæ³¨è§£æ¿€æ´»
@DubboService(filter = {"logfilter", "validation"})
public class UserServiceImpl implements UserService {
    // ä¸šåŠ¡ä»£ç 
}

// æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶æ¿€æ´»
@DubboService(filter = "ratelimit")
public class OrderServiceImpl implements OrderService {
    // ä¸šåŠ¡ä»£ç 
}
```

> **ğŸ” è¿‡æ»¤å™¨é¡ºåº**  
> å¤šä¸ªè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºå¯ä»¥é€šè¿‡`@Activate`çš„`order`å±æ€§æ§åˆ¶ï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œã€‚

---

## 7. ğŸ“¡ è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒ


### 7.1 æ³¨å†Œä¸­å¿ƒæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
æ³¨å†Œä¸­å¿ƒ = ç”µè¯ç°¿/é€šè®¯å½•

æœåŠ¡æä¾›è€… â†’ æ³¨å†Œä¸­å¿ƒï¼šæˆ‘çš„ç”µè¯æ˜¯138xxxxï¼ˆæ³¨å†Œï¼‰
æœåŠ¡æ¶ˆè´¹è€… â†’ æ³¨å†Œä¸­å¿ƒï¼šå¸®æˆ‘æ‰¾138xxxxï¼ˆè®¢é˜…ï¼‰
æ³¨å†Œä¸­å¿ƒ â†’ æœåŠ¡æ¶ˆè´¹è€…ï¼šåœ¨è¿™é‡Œï¼ï¼ˆé€šçŸ¥ï¼‰
```

**æ³¨å†Œä¸­å¿ƒèŒè´£**ï¼š
- **æœåŠ¡æ³¨å†Œ**ï¼šæä¾›è€…å¯åŠ¨æ—¶æ³¨å†Œåœ°å€
- **æœåŠ¡å‘ç°**ï¼šæ¶ˆè´¹è€…æŸ¥è¯¢å¯ç”¨æœåŠ¡
- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜æ´»
- **å˜æ›´é€šçŸ¥**ï¼šæœåŠ¡ä¸Šä¸‹çº¿æ—¶é€šçŸ¥æ¶ˆè´¹è€…

### 7.2 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒ


**å®é™…åœºæ™¯**ï¼š
- **ä½¿ç”¨ç‰¹å®šå­˜å‚¨**ï¼šå…¬å¸ç»Ÿä¸€ç”¨Redis/MySQLåšæ³¨å†Œä¸­å¿ƒ
- **ç§æœ‰åŒ–éƒ¨ç½²**ï¼šä¸èƒ½ä¾èµ–å¤–éƒ¨ç»„ä»¶
- **ç‰¹æ®Šéœ€æ±‚**ï¼šéœ€è¦ç‰¹æ®Šçš„æœåŠ¡ç­›é€‰é€»è¾‘

### 7.3 è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒå®ç°


**ç¬¬ä¸€æ­¥ï¼šå®ç°RegistryFactory**

```java
public class CustomRegistryFactory implements RegistryFactory {
    
    @Override
    public Registry getRegistry(URL url) {
        // æ ¹æ®URLåˆ›å»ºæ³¨å†Œä¸­å¿ƒå®ä¾‹
        return new CustomRegistry(url);
    }
}
```

**ç¬¬äºŒæ­¥ï¼šå®ç°Registryæ¥å£**

```java
public class CustomRegistry extends FailbackRegistry {
    
    // å­˜å‚¨æœåŠ¡ä¿¡æ¯çš„å®¹å™¨ï¼ˆå®é™…åº”è¯¥ç”¨Redis/MySQLï¼‰
    private Map<String, Set<URL>> serviceMap = new ConcurrentHashMap<>();
    
    public CustomRegistry(URL url) {
        super(url);
    }
    
    @Override
    public void doRegister(URL url) {
        // æœåŠ¡æ³¨å†Œï¼šæŠŠæœåŠ¡åœ°å€å­˜èµ·æ¥
        String serviceName = url.getServiceInterface();
        serviceMap.computeIfAbsent(serviceName, k -> new ConcurrentHashSet<>())
                  .add(url);
        
        System.out.println("æœåŠ¡æ³¨å†ŒæˆåŠŸï¼š" + serviceName + " -> " + url);
    }
    
    @Override
    public void doUnregister(URL url) {
        // æœåŠ¡æ³¨é”€ï¼šåˆ é™¤æœåŠ¡åœ°å€
        String serviceName = url.getServiceInterface();
        Set<URL> urls = serviceMap.get(serviceName);
        if (urls != null) {
            urls.remove(url);
        }
    }
    
    @Override
    public void doSubscribe(URL url, NotifyListener listener) {
        // æœåŠ¡è®¢é˜…ï¼šæ¶ˆè´¹è€…è®¢é˜…æœåŠ¡
        String serviceName = url.getServiceInterface();
        Set<URL> urls = serviceMap.get(serviceName);
        
        if (urls != null && !urls.isEmpty()) {
            // é€šçŸ¥æ¶ˆè´¹è€…å¯ç”¨çš„æœåŠ¡åˆ—è¡¨
            listener.notify(new ArrayList<>(urls));
        }
    }
    
    @Override
    public void doUnsubscribe(URL url, NotifyListener listener) {
        // å–æ¶ˆè®¢é˜…
    }
    
    @Override
    public boolean isAvailable() {
        // æ³¨å†Œä¸­å¿ƒæ˜¯å¦å¯ç”¨
        return true;
    }
}
```

> **ğŸ’¡ æ ¸å¿ƒæ–¹æ³•è§£é‡Š**  
> - `doRegister`ï¼šæä¾›è€…è°ƒç”¨ï¼Œè¯´"æˆ‘åœ¨è¿™é‡Œ"
> - `doSubscribe`ï¼šæ¶ˆè´¹è€…è°ƒç”¨ï¼Œè¯´"å‘Šè¯‰æˆ‘æœåŠ¡åœ¨å“ª"
> - `notify`ï¼šæ³¨å†Œä¸­å¿ƒå›è°ƒæ¶ˆè´¹è€…ï¼Œæ¨é€æœåŠ¡åœ°å€

**å®æˆ˜æ¡ˆä¾‹ï¼šåŸºäºRedisçš„æ³¨å†Œä¸­å¿ƒ**

```java
public class RedisRegistry extends FailbackRegistry {
    
    private final RedisTemplate<String, String> redisTemplate;
    private final String ROOT_PATH = "/dubbo";
    
    @Override
    public void doRegister(URL url) {
        String serviceName = url.getServiceInterface();
        String serviceKey = ROOT_PATH + "/" + serviceName + "/providers";
        
        // ç”¨Redisçš„Setå­˜å‚¨æœåŠ¡åœ°å€
        redisTemplate.opsForSet().add(serviceKey, url.toFullString());
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆå¿ƒè·³æœºåˆ¶ï¼‰
        redisTemplate.expire(serviceKey, 60, TimeUnit.SECONDS);
    }
    
    @Override
    public void doSubscribe(URL url, NotifyListener listener) {
        String serviceName = url.getServiceInterface();
        String serviceKey = ROOT_PATH + "/" + serviceName + "/providers";
        
        // ä»Redisè·å–æœåŠ¡åˆ—è¡¨
        Set<String> urlStrings = redisTemplate.opsForSet().members(serviceKey);
        
        if (urlStrings != null && !urlStrings.isEmpty()) {
            List<URL> urls = urlStrings.stream()
                .map(URL::valueOf)
                .collect(Collectors.toList());
            
            listener.notify(urls);
        }
        
        // ç›‘å¬æœåŠ¡å˜åŒ–ï¼ˆä½¿ç”¨Redisçš„Pub/Subï¼‰
        watchServiceChange(serviceKey, listener);
    }
    
    private void watchServiceChange(String serviceKey, NotifyListener listener) {
        redisTemplate.subscribe((message, pattern) -> {
            // æœåŠ¡å˜åŒ–æ—¶é‡æ–°é€šçŸ¥
            Set<String> urls = redisTemplate.opsForSet().members(serviceKey);
            if (urls != null) {
                List<URL> urlList = urls.stream()
                    .map(URL::valueOf)
                    .collect(Collectors.toList());
                listener.notify(urlList);
            }
        }, serviceKey);
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼šé…ç½®ä½¿ç”¨**

```properties
# META-INF/dubbo/org.apache.dubbo.registry.RegistryFactory
customregistry=com.example.registry.CustomRegistryFactory
```

```xml
<!-- ä½¿ç”¨è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒ -->
<dubbo:registry address="customregistry://127.0.0.1:6379" />
```

> **âš ï¸ ç”Ÿäº§æ³¨æ„**  
> è‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒè¦è€ƒè™‘ï¼šé«˜å¯ç”¨ï¼ˆä¸»ä»ï¼‰ã€æ•°æ®ä¸€è‡´æ€§ã€ç½‘ç»œåˆ†åŒºå¤„ç†ã€æ€§èƒ½ä¼˜åŒ–ã€‚å»ºè®®å…ˆç†è§£Zookeeper/Nacosçš„å®ç°åŸç†ã€‚

---

## 8. ğŸ“ æ’ä»¶å¼€å‘è§„èŒƒ


### 8.1 å¼€å‘è§„èŒƒæ€»è§ˆ


**æ ¸å¿ƒåŸåˆ™**ï¼š
```
âœ… å•ä¸€èŒè´£ï¼šä¸€ä¸ªæ‰©å±•åšå¥½ä¸€ä»¶äº‹
âœ… ä¾èµ–å€’ç½®ï¼šä¾èµ–æ¥å£è€Œéå®ç°
âœ… é…ç½®é©±åŠ¨ï¼šé€šè¿‡é…ç½®æ§åˆ¶è¡Œä¸º
âœ… å¼‚å¸¸å‹å¥½ï¼šä¼˜é›…å¤„ç†å¼‚å¸¸æƒ…å†µ
```

### 8.2 æ‰©å±•ç‚¹å‘½åè§„èŒƒ


| è§„èŒƒé¡¹ | è¦æ±‚ | ç¤ºä¾‹ |
|--------|------|------|
| **æ‰©å±•å** | å°å†™å­—æ¯ï¼Œç®€çŸ­æœ‰æ„ä¹‰ | `myprotocol`ã€`redis` |
| **åŒ…å** | æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„ | `com.example.protocol`ã€`com.example.filter` |
| **ç±»å** | é©¼å³°å‘½åï¼Œè§åçŸ¥æ„ | `CustomLoadBalance`ã€`LogFilter` |
| **é…ç½®æ–‡ä»¶** | æ¥å£å…¨é™å®šå | `org.apache.dubbo.rpc.Protocol` |

### 8.3 æ‰©å±•ç‚¹ä¾èµ–æ³¨å…¥


**è‡ªåŠ¨æ³¨å…¥Dubboæ‰©å±•**ï¼š

```java
public class MyProtocol implements Protocol {
    
    // è‡ªåŠ¨æ³¨å…¥å…¶ä»–æ‰©å±•ç‚¹ï¼ˆsetteræ³¨å…¥ï¼‰
    private LoadBalance loadBalance;
    
    public void setLoadBalance(LoadBalance loadBalance) {
        this.loadBalance = loadBalance;
    }
    
    @Override
    public <T> Invoker<T> refer(Class<T> type, URL url) {
        // å¯ä»¥ç›´æ¥ä½¿ç”¨loadBalance
        return new MyInvoker<>(type, url, loadBalance);
    }
}
```

> **ğŸ’¡ æ³¨å…¥åŸç†**  
> Dubboä¼šè‡ªåŠ¨æŸ¥æ‰¾setteræ–¹æ³•ï¼Œå¦‚æœå‚æ•°ç±»å‹æ˜¯æ‰©å±•ç‚¹æ¥å£ï¼Œå°±è‡ªåŠ¨æ³¨å…¥å®ä¾‹ã€‚å°±åƒSpringçš„è‡ªåŠ¨è£…é…ã€‚

### 8.4 æ‰©å±•ç‚¹åŒ…è£…å™¨ï¼ˆAOPï¼‰


**Wrapperæœºåˆ¶**ï¼š

```java
// åŒ…è£…å™¨ï¼šä¸ºæ‰€æœ‰åè®®æ·»åŠ ç›‘æ§åŠŸèƒ½
public class ProtocolMonitorWrapper implements Protocol {
    
    private final Protocol protocol;  // è¢«åŒ…è£…çš„çœŸå®åè®®
    
    // æ„é€ å‡½æ•°æ¥æ”¶è¢«åŒ…è£…å¯¹è±¡
    public ProtocolMonitorWrapper(Protocol protocol) {
        this.protocol = protocol;
    }
    
    @Override
    public <T> Exporter<T> export(Invoker<T> invoker) {
        // å‰ç½®ï¼šå¼€å§‹ç›‘æ§
        MonitorService.start(invoker.getUrl());
        
        try {
            // è°ƒç”¨çœŸå®åè®®
            return protocol.export(invoker);
        } finally {
            // åç½®ï¼šè®°å½•ç›‘æ§æ•°æ®
            MonitorService.record(invoker.getUrl());
        }
    }
    
    // å…¶ä»–æ–¹æ³•åŒæ ·åŒ…è£…
}
```

> **ğŸ” Wrapperç‰¹ç‚¹**  
> Wrapperç±»åå¿…é¡»ä»¥"Wrapper"ç»“å°¾ï¼ŒDubboä¼šè‡ªåŠ¨è¯†åˆ«å¹¶åº”ç”¨AOPå¢å¼ºã€‚å°±åƒSpringçš„åˆ‡é¢ã€‚

### 8.5 æ‰©å±•ç‚¹æ¿€æ´»æ¡ä»¶


**æ¡ä»¶æ¿€æ´»**ï¼š

```java
@Activate(
    group = {CommonConstants.PROVIDER},      // åªåœ¨æä¾›è€…ç«¯ç”Ÿæ•ˆ
    value = {"monitor"},                     // å½“é…ç½®äº†monitorå‚æ•°æ—¶æ¿€æ´»
    order = 1000                             // æ‰§è¡Œé¡ºåº
)
public class MonitorFilter implements Filter {
    // è¿‡æ»¤å™¨å®ç°
}
```

**æ¿€æ´»æ¡ä»¶è¯¦è§£**ï¼š

| å±æ€§ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `group` | ç”Ÿæ•ˆèŒƒå›´ | `PROVIDER`ã€`CONSUMER` |
| `value` | é…ç½®å‚æ•° | `{"cache", "validation"}` |
| `order` | æ‰§è¡Œé¡ºåº | æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ |
| `onClass` | ä¾èµ–ç±»å­˜åœ¨ | `"redis.clients.jedis.Jedis"` |

---

## 9. ğŸ§ª æ‰©å±•ç‚¹æµ‹è¯•


### 9.1 å•å…ƒæµ‹è¯•è§„èŒƒ


**æµ‹è¯•åŸºæœ¬ç»“æ„**ï¼š

```java
public class CustomLoadBalanceTest {
    
    private CustomLoadBalance loadBalance;
    private List<Invoker<DemoService>> invokers;
    
    @Before
    public void setUp() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        loadBalance = new CustomLoadBalance();
        invokers = createMockInvokers();
    }
    
    @Test
    public void testSelect() {
        // 1. å‡†å¤‡
        URL url = URL.valueOf("dubbo://localhost/DemoService");
        Invocation invocation = new RpcInvocation();
        
        // 2. æ‰§è¡Œ
        Invoker<DemoService> selected = loadBalance.select(
            invokers, url, invocation
        );
        
        // 3. éªŒè¯
        assertNotNull(selected);
        assertTrue(invokers.contains(selected));
    }
    
    private List<Invoker<DemoService>> createMockInvokers() {
        // åˆ›å»ºæ¨¡æ‹Ÿçš„Invokeråˆ—è¡¨
        List<Invoker<DemoService>> list = new ArrayList<>();
        
        for (int i = 0; i < 3; i++) {
            Invoker<DemoService> invoker = mock(Invoker.class);
            URL url = URL.valueOf("dubbo://192.168.1." + i + ":20880");
            when(invoker.getUrl()).thenReturn(url);
            when(invoker.isAvailable()).thenReturn(true);
            list.add(invoker);
        }
        
        return list;
    }
}
```

### 9.2 é›†æˆæµ‹è¯•


**æµ‹è¯•æ‰©å±•ç‚¹åŠ è½½**ï¼š

```java
public class ExtensionLoadTest {
    
    @Test
    public void testLoadCustomProtocol() {
        // æµ‹è¯•è‡ªå®šä¹‰åè®®æ˜¯å¦èƒ½æ­£ç¡®åŠ è½½
        ExtensionLoader<Protocol> loader = 
            ExtensionLoader.getExtensionLoader(Protocol.class);
        
        Protocol protocol = loader.getExtension("myprotocol");
        
        assertNotNull(protocol);
        assertTrue(protocol instanceof MyProtocol);
    }
    
    @Test
    public void testProtocolExport() {
        // æµ‹è¯•åè®®æš´éœ²åŠŸèƒ½
        URL url = URL.valueOf("myprotocol://localhost:20880/DemoService");
        Invoker<DemoService> invoker = createMockInvoker(url);
        
        Protocol protocol = ExtensionLoader
            .getExtensionLoader(Protocol.class)
            .getExtension("myprotocol");
        
        Exporter<DemoService> exporter = protocol.export(invoker);
        
        assertNotNull(exporter);
        // éªŒè¯æœåŠ¡å¯è®¿é—®
    }
}
```

### 9.3 æ€§èƒ½æµ‹è¯•


**å‹åŠ›æµ‹è¯•ç¤ºä¾‹**ï¼š

```java
public class LoadBalancePerformanceTest {
    
    @Test
    public void testPerformance() {
        CustomLoadBalance loadBalance = new CustomLoadBalance();
        List<Invoker<DemoService>> invokers = createMockInvokers(10);
        
        int totalCalls = 1000000;
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < totalCalls; i++) {
            loadBalance.select(invokers, null, null);
        }
        
        long costTime = System.currentTimeMillis() - startTime;
        double tps = (double) totalCalls / costTime * 1000;
        
        System.out.println("æ€»è€—æ—¶ï¼š" + costTime + "ms");
        System.out.println("TPSï¼š" + tps);
        
        // éªŒè¯æ€§èƒ½æŒ‡æ ‡
        assertTrue("TPSåº”è¯¥å¤§äº10ä¸‡", tps > 100000);
    }
}
```

> **ğŸ“Š æ€§èƒ½æŒ‡æ ‡**  
> - **TPS**ï¼šæ¯ç§’å¤„ç†è¯·æ±‚æ•°ï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰
> - **å“åº”æ—¶é—´**ï¼šå•æ¬¡è°ƒç”¨è€—æ—¶ï¼ˆè¶Šä½è¶Šå¥½ï¼‰
> - **å†…å­˜å ç”¨**ï¼šè¿è¡Œæ—¶å†…å­˜ä½¿ç”¨ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dubbo SPIæœºåˆ¶ï¼šåŠ¨æ€åŠ è½½æ‰©å±•ç‚¹çš„æ ¸å¿ƒåŸç†
ğŸ”¸ æ‰©å±•ç‚¹åˆ†ç±»ï¼šåè®®ã€åºåˆ—åŒ–ã€è´Ÿè½½å‡è¡¡ã€å®¹é”™ã€è¿‡æ»¤å™¨ã€æ³¨å†Œä¸­å¿ƒ
ğŸ”¸ é…ç½®è§„èŒƒï¼šMETA-INF/dubboç›®å½• + æ¥å£å…¨é™å®šå
ğŸ”¸ ä¾èµ–æ³¨å…¥ï¼šè‡ªåŠ¨æ³¨å…¥å…¶ä»–æ‰©å±•ç‚¹
ğŸ”¸ Wrapperæœºåˆ¶ï¼šä¸ºæ‰©å±•ç‚¹æ·»åŠ AOPå¢å¼º
ğŸ”¸ æ¡ä»¶æ¿€æ´»ï¼š@Activateæ§åˆ¶æ‰©å±•ç‚¹ç”Ÿæ•ˆæ¡ä»¶
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆDubbo SPIè¿™ä¹ˆå¼ºå¤§**
```
å¯¹æ¯”Java SPIï¼š
âŒ Java SPIï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å®ç°ï¼Œæµªè´¹èµ„æº
âœ… Dubbo SPIï¼šæŒ‰éœ€åŠ è½½ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥å’ŒAOP

æ ¸å¿ƒä¼˜åŠ¿ï¼š
â€¢ çµæ´»æ€§ï¼šé…ç½®æ–‡ä»¶éšæ—¶æ›¿æ¢å®ç°
â€¢ æ‰©å±•æ€§ï¼šä¸æ”¹æºç å°±èƒ½å¢å¼ºåŠŸèƒ½
â€¢ è§£è€¦æ€§ï¼šé¢å‘æ¥å£ç¼–ç¨‹ï¼Œå®ç°å¯æ’æ‹”
```

**ğŸ”¹ æ‰©å±•å¼€å‘çš„è®¾è®¡æ€è·¯**
```
ä¸‰æ­¥èµ°ç­–ç•¥ï¼š
1ï¸âƒ£ æ‰¾æ¥å£ï¼šç¡®å®šè¦æ‰©å±•çš„æ¥å£ï¼ˆProtocolã€Filterç­‰ï¼‰
2ï¸âƒ£ å†™å®ç°ï¼šç»§æ‰¿æˆ–å®ç°è¯¥æ¥å£
3ï¸âƒ£ é…ç½®æ¿€æ´»ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­å£°æ˜

å°±åƒæ­ç§¯æœ¨ï¼š
æ¥å£ = ç§¯æœ¨æ¥å£æ ‡å‡†
å®ç° = å…·ä½“çš„ç§¯æœ¨å—
é…ç½® = ç§¯æœ¨æ‹¼æ¥è¯´æ˜ä¹¦
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰æ‰©å±•**
```
å®é™…åœºæ™¯åˆ¤æ–­ï¼š
âœ… éœ€è¦ï¼šç‰¹æ®Šç½‘ç»œåè®®ã€è‡ªæœ‰åºåˆ—åŒ–æ ¼å¼ã€ä¸šåŠ¡å®šåˆ¶è´Ÿè½½å‡è¡¡
âŒ ä¸éœ€è¦ï¼šé»˜è®¤åŠŸèƒ½å·²æ»¡è¶³ï¼Œè¿‡åº¦è®¾è®¡åè€Œå¤æ‚

é€‰æ‹©æ ‡å‡†ï¼š
â€¢ é»˜è®¤å¤Ÿç”¨å—ï¼Ÿâ†’ å¤Ÿç”¨å°±åˆ«æ”¹
â€¢ æœ‰ç°æˆçš„å—ï¼Ÿâ†’ ä¼˜å…ˆç”¨ç¤¾åŒºæ–¹æ¡ˆ
â€¢ çœŸçš„å¾ˆç‰¹æ®Šï¼Ÿâ†’ å†è€ƒè™‘è‡ªå®šä¹‰
```

### 10.3 å®æˆ˜å¼€å‘æ£€æŸ¥æ¸…å•


**å¼€å‘å‰å‡†å¤‡**ï¼š
- [ ] ç¡®è®¤è¦æ‰©å±•çš„æ¥å£
- [ ] äº†è§£é»˜è®¤å®ç°çš„é€»è¾‘
- [ ] è¯„ä¼°æ˜¯å¦çœŸçš„éœ€è¦è‡ªå®šä¹‰

**å¼€å‘ä¸­è§„èŒƒ**ï¼š
- [ ] éµå¾ªå‘½åè§„èŒƒ
- [ ] å®ç°å¿…è¦çš„æ¥å£æ–¹æ³•
- [ ] å¤„ç†å¼‚å¸¸æƒ…å†µ
- [ ] æ·»åŠ æ—¥å¿—è®°å½•

**å¼€å‘åéªŒè¯**ï¼š
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] è¿›è¡Œé›†æˆæµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] æ–‡æ¡£å’Œç¤ºä¾‹

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**é—®é¢˜1ï¼šæ‰©å±•ç‚¹åŠ è½½å¤±è´¥**
```
åŸå› ï¼šé…ç½®æ–‡ä»¶è·¯å¾„æˆ–åç§°é”™è¯¯
è§£å†³ï¼šæ£€æŸ¥META-INF/dubboç›®å½•ï¼Œæ–‡ä»¶åæ˜¯æ¥å£å…¨é™å®šå
```

**é—®é¢˜2ï¼šä¾èµ–æ³¨å…¥ä¸ç”Ÿæ•ˆ**
```
åŸå› ï¼šæ²¡æœ‰æä¾›setteræ–¹æ³•
è§£å†³ï¼šä¸ºéœ€è¦æ³¨å…¥çš„æ‰©å±•ç‚¹æ·»åŠ publicçš„setteræ–¹æ³•
```

**é—®é¢˜3ï¼šè¿‡æ»¤å™¨ä¸æ‰§è¡Œ**
```
åŸå› ï¼š@Activateæ¡ä»¶ä¸æ»¡è¶³
è§£å†³ï¼šæ£€æŸ¥groupã€valueç­‰æ¿€æ´»æ¡ä»¶é…ç½®
```

**é—®é¢˜4ï¼šè‡ªå®šä¹‰åè®®æ— æ³•é€šä¿¡**
```
åŸå› ï¼šç¼–è§£ç ä¸åŒ¹é…
è§£å†³ï¼šç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ç›¸åŒçš„åºåˆ—åŒ–æ–¹å¼
```

### 10.5 å­¦ä¹ è·¯å¾„å»ºè®®


```
å­¦ä¹ è¿›åº¦ï¼š
ğŸŸ¢ å…¥é—¨çº§ï¼šç†è§£SPIåŸç†ï¼Œä¼šç”¨ç®€å•æ‰©å±•ç‚¹
    â†“
ğŸŸ¡ è¿›é˜¶çº§ï¼šå¼€å‘Filterã€LoadBalanceç­‰å¸¸ç”¨æ‰©å±•
    â†“
ğŸŸ  é«˜çº§çº§ï¼šè‡ªå®šä¹‰Protocolã€Registryç­‰æ ¸å¿ƒç»„ä»¶
    â†“
ğŸ”´ ä¸“å®¶çº§ï¼šæ·±å…¥æºç ï¼Œä¼˜åŒ–æ€§èƒ½ï¼Œè´¡çŒ®ç¤¾åŒº
```

**ğŸ“š æ¨èå®è·µ**ï¼š
1. **å…ˆæ¨¡ä»¿**ï¼šé˜…è¯»Dubboè‡ªå¸¦æ‰©å±•çš„æºç 
2. **å†æ”¹é€ **ï¼šåŸºäºé»˜è®¤å®ç°åšå°æ”¹åŠ¨
3. **ååˆ›æ–°**ï¼šå®Œå…¨è‡ªå®šä¹‰æ»¡è¶³ç‰¹æ®Šéœ€æ±‚

**ğŸ”— ç›¸å…³èµ„æº**ï¼š
- Dubboå®˜æ–¹æ–‡æ¡£ï¼šhttps://dubbo.apache.org
- GitHubæºç ï¼šhttps://github.com/apache/dubbo
- ç¤¾åŒºè®¨è®ºï¼šDubboç”¨æˆ·é’‰é’‰ç¾¤

---

**ğŸ¯ æ ¸å¿ƒè®°å¿†**ï¼š
- Dubboæ‰©å±•å°±åƒæ’ä»¶ï¼Œæ‰¾æ¥å£â†’å†™å®ç°â†’é…æ–‡ä»¶
- SPIæœºåˆ¶å®ç°æŒ‰éœ€åŠ è½½ï¼Œæ”¯æŒä¾èµ–æ³¨å…¥å’ŒAOP
- å…«å¤§æ‰©å±•ç‚¹ï¼šåè®®ã€åºåˆ—åŒ–ã€è´Ÿè½½å‡è¡¡ã€å®¹é”™ã€è¿‡æ»¤å™¨ã€æ³¨å†Œä¸­å¿ƒç­‰
- éµå¾ªè§„èŒƒå¼€å‘ï¼Œå……åˆ†æµ‹è¯•éªŒè¯ï¼Œç†è§£åŸç†å†åˆ›æ–°