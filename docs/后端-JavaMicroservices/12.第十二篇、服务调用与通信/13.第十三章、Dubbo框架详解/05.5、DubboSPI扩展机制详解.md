---
title: 5ã€DubboSPIæ‰©å±•æœºåˆ¶è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯SPIæœºåˆ¶](#1-ä»€ä¹ˆæ˜¯SPIæœºåˆ¶)
2. [JavaåŸç”ŸSPIçš„å±€é™](#2-JavaåŸç”ŸSPIçš„å±€é™)
3. [Dubbo SPIæ ¸å¿ƒæœºåˆ¶](#3-Dubbo-SPIæ ¸å¿ƒæœºåˆ¶)
4. [ExtensionLoaderåŠ è½½å™¨åŸç†](#4-ExtensionLoaderåŠ è½½å™¨åŸç†)
5. [Adaptiveè‡ªé€‚åº”æ‰©å±•](#5-Adaptiveè‡ªé€‚åº”æ‰©å±•)
6. [æ‰©å±•ç‚¹æ³¨å…¥ä¸åŒ…è£…](#6-æ‰©å±•ç‚¹æ³¨å…¥ä¸åŒ…è£…)
7. [è‡ªå®šä¹‰æ‰©å±•å¼€å‘å®æˆ˜](#7-è‡ªå®šä¹‰æ‰©å±•å¼€å‘å®æˆ˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”Œ ä»€ä¹ˆæ˜¯SPIæœºåˆ¶


### 1.1 SPIçš„æœ¬è´¨å«ä¹‰


**SPIï¼ˆService Provider Interfaceï¼‰** ç›´è¯‘æ˜¯"æœåŠ¡æä¾›è€…æ¥å£"ï¼Œä½†è¿™ä¸ªç¿»è¯‘å¤ªç”Ÿç¡¬ã€‚**é€šä¿—æ¥è¯´ï¼ŒSPIå°±æ˜¯ä¸€ç§"æ’ä»¶åŒ–"çš„æ€æƒ³**ã€‚

```
ç°å®ç±»æ¯”ï¼š

æ‰‹æœºçš„æ‰©å±•åŠŸèƒ½ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‰‹æœºæœ¬ä½“   â”‚ â† æ ¸å¿ƒåŠŸèƒ½å›ºå®š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  USBæ¥å£    â”‚ â† SPIæœºåˆ¶ï¼ˆæ ‡å‡†æ¥å£ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
å¯ä»¥æ’å…¥ä¸åŒè®¾å¤‡ï¼š
â€¢ è€³æœº â†’ å¬éŸ³ä¹
â€¢ Uç›˜ â†’ å­˜å‚¨æ–‡ä»¶
â€¢ å……ç”µå™¨ â†’ å……ç”µ

å…³é”®ç†è§£ï¼š
æ‰‹æœºä¸éœ€è¦çŸ¥é“æ’å…¥çš„æ˜¯ä»€ä¹ˆè®¾å¤‡ï¼Œ
åªè¦ç¬¦åˆUSBæ¥å£æ ‡å‡†ï¼Œå°±èƒ½å·¥ä½œï¼
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦SPI


**é—®é¢˜åœºæ™¯**ï¼šå‡è®¾ä½ å¼€å‘äº†ä¸€ä¸ªæ¡†æ¶ï¼Œæƒ³è®©ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æŸäº›åŠŸèƒ½ï¼Œä½†åˆä¸æƒ³ä¿®æ”¹æ¡†æ¶æºç ï¼Œæ€ä¹ˆåŠï¼Ÿ

```
ä¼ ç»Ÿç¡¬ç¼–ç æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶ä»£ç         â”‚
â”‚  if(type=="A")   â”‚ â† æ¯å¢åŠ ä¸€ç§ç±»å‹
â”‚    new A();      â”‚   å°±è¦æ”¹æºç 
â”‚  if(type=="B")   â”‚
â”‚    new B();      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šä¸çµæ´»ã€ä¸å¯æ‰©å±•

SPIæ’ä»¶åŒ–æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶ä»£ç         â”‚
â”‚  åŠ è½½é…ç½®æ–‡ä»¶    â”‚ â† åªéœ€è¦åŠ è½½å®ç°ç±»
â”‚  åˆ›å»ºå®ç°å¯¹è±¡    â”‚   æ¡†æ¶ä»£ç ä¸å˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   é…ç½®æ–‡ä»¶å®šä¹‰å®ç°ç±»
   
ä¼˜åŠ¿ï¼šæ¡†æ¶å’Œå®ç°è§£è€¦ï¼Œéšæ—¶å¯æ‰©å±•
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- ğŸ“Œ **æ¥å£å®šä¹‰è€…**ï¼šæ¡†æ¶å®šä¹‰æ¥å£ï¼ˆè§„èŒƒï¼‰
- ğŸ“Œ **æ¥å£å®ç°è€…**ï¼šç”¨æˆ·æä¾›å®ç°ï¼ˆæ’ä»¶ï¼‰
- ğŸ“Œ **åŠ è½½æœºåˆ¶**ï¼šæ¡†æ¶è‡ªåŠ¨å‘ç°å’ŒåŠ è½½å®ç°

### 1.3 SPIçš„å®é™…åº”ç”¨


```
å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š

ğŸ”¸ æ•°æ®åº“é©±åŠ¨ï¼š
   JDBCå®šä¹‰æ¥å£ â†’ MySQL/Oracleæä¾›å®ç°
   åªéœ€è¦æ¢ä¸ªjaråŒ…ï¼Œå°±èƒ½åˆ‡æ¢æ•°æ®åº“

ğŸ”¸ æ—¥å¿—æ¡†æ¶ï¼š
   SLF4Jå®šä¹‰æ¥å£ â†’ Logback/Log4jå®ç°
   éšæ—¶æ›´æ¢æ—¥å¿—å®ç°ï¼Œä»£ç ä¸å˜

ğŸ”¸ Dubboæ¡†æ¶ï¼š
   åè®®ã€è´Ÿè½½å‡è¡¡ã€åºåˆ—åŒ–ç­‰éƒ½æ˜¯SPIæ‰©å±•
   ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ä»»ä½•ç»„ä»¶
```

---

## 2. âš ï¸ JavaåŸç”ŸSPIçš„å±€é™


### 2.1 Java SPIçš„å·¥ä½œæ–¹å¼


Javaæä¾›äº†åŸç”Ÿçš„SPIæœºåˆ¶ï¼Œä½†æœ‰å¾ˆå¤šé—®é¢˜ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹å®ƒæ€ä¹ˆç”¨çš„ï¼š

**â‘  å®šä¹‰æ¥å£**
```java
// å®šä¹‰ä¸€ä¸ªæ•°æ®åº“é©±åŠ¨æ¥å£
public interface DatabaseDriver {
    void connect(String url);
}
```

**â‘¡ æä¾›å®ç°**
```java
// MySQLå®ç°
public class MySQLDriver implements DatabaseDriver {
    public void connect(String url) {
        System.out.println("è¿æ¥MySQL: " + url);
    }
}

// Oracleå®ç°  
public class OracleDriver implements DatabaseDriver {
    public void connect(String url) {
        System.out.println("è¿æ¥Oracle: " + url);
    }
}
```

**â‘¢ é…ç½®æ–‡ä»¶** - æ”¾åœ¨ `META-INF/services/` ç›®å½•ä¸‹
```
æ–‡ä»¶åï¼šcom.example.DatabaseDriver
æ–‡ä»¶å†…å®¹ï¼š
com.example.MySQLDriver
com.example.OracleDriver
```

**â‘£ åŠ è½½ä½¿ç”¨**
```java
// Javaä¼šè‡ªåŠ¨åŠ è½½æ‰€æœ‰å®ç°ç±»
ServiceLoader<DatabaseDriver> drivers = 
    ServiceLoader.load(DatabaseDriver.class);

for (DatabaseDriver driver : drivers) {
    driver.connect("jdbc:xxx");
}
```

### 2.2 Java SPIçš„è‡´å‘½é—®é¢˜


| é—®é¢˜ç±»å‹ | **å…·ä½“è¡¨ç°** | **å½±å“** |
|---------|------------|---------|
| **å…¨éƒ¨åŠ è½½** | `å¿…é¡»åŠ è½½æ‰€æœ‰å®ç°ç±»` | æµªè´¹èµ„æºï¼Œå¯åŠ¨æ…¢ |
| **æ— æ³•æŒ‰éœ€åŠ è½½** | `ä¸èƒ½æŒ‡å®šåŠ è½½æŸä¸€ä¸ª` | ä¸å¤Ÿçµæ´» |
| **ä¸æ”¯æŒä¾èµ–æ³¨å…¥** | `å®ç°ç±»æ— æ³•æ³¨å…¥å…¶ä»–å¯¹è±¡` | åŠŸèƒ½å—é™ |
| **é…ç½®ä¸çµæ´»** | `åªèƒ½å…¨ç±»åé…ç½®` | æ— æ³•ä¼ é€’å‚æ•° |

**é—®é¢˜ç¤ºä¾‹**ï¼š
```
å‡è®¾æœ‰10ä¸ªæ•°æ®åº“é©±åŠ¨å®ç°ï¼š

Java SPIï¼š
â†’ å¿…é¡»å…¨éƒ¨å®ä¾‹åŒ–10ä¸ªå¯¹è±¡
â†’ å³ä½¿ä½ åªç”¨MySQLï¼Œå…¶ä»–9ä¸ªä¹Ÿä¼šåˆ›å»º
â†’ å¯åŠ¨æ—¶å°±è¦åˆ›å»ºï¼Œæ— æ³•å»¶è¿ŸåŠ è½½

é—®é¢˜ï¼š
âœ— å†…å­˜æµªè´¹
âœ— å¯åŠ¨æ—¶é—´é•¿
âœ— æ— æ³•æ§åˆ¶åŠ è½½æ—¶æœº
```

---

## 3. ğŸš€ Dubbo SPIæ ¸å¿ƒæœºåˆ¶


### 3.1 Dubbo SPIçš„æ”¹è¿›æ€è·¯


Dubboé‡æ–°è®¾è®¡äº†SPIæœºåˆ¶ï¼Œè§£å†³äº†Java SPIçš„æ‰€æœ‰é—®é¢˜ï¼š

```
Java SPI vs Dubbo SPIï¼š

Java SPIï¼š
ServiceLoader.load()
    â†“
åŠ è½½æ‰€æœ‰å®ç°ç±»ï¼ˆæ— é€‰æ‹©ï¼‰
    â†“
å…¨éƒ¨å®ä¾‹åŒ–ï¼ˆæµªè´¹èµ„æºï¼‰

Dubbo SPIï¼š
ExtensionLoader.getExtension("mysql")
    â†“
åªåŠ è½½æŒ‡å®šçš„å®ç°ï¼ˆæŒ‰éœ€ï¼‰
    â†“
å»¶è¿Ÿå®ä¾‹åŒ–ï¼ˆç”¨æ—¶åˆ›å»ºï¼‰
```

### 3.2 Dubbo SPIçš„æ ¸å¿ƒç‰¹æ€§


**ğŸ”¸ ç‰¹æ€§1ï¼šæŒ‰éœ€åŠ è½½**
```java
// åªåŠ è½½ä½ éœ€è¦çš„å®ç°
ExtensionLoader<Protocol> loader = 
    ExtensionLoader.getExtensionLoader(Protocol.class);

// æ˜ç¡®æŒ‡å®šè¦å“ªä¸ªå®ç°
Protocol dubbo = loader.getExtension("dubbo");    // åªåŠ è½½dubboåè®®
Protocol http = loader.getExtension("http");      // åªåŠ è½½httpåè®®
```

**ğŸ”¸ ç‰¹æ€§2ï¼šé…ç½®æ›´çµæ´»**
```
Dubboé…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆKVé”®å€¼å¯¹ï¼‰ï¼š

æ–‡ä»¶åï¼šMETA-INF/dubbo/com.alibaba.dubbo.rpc.Protocol
æ–‡ä»¶å†…å®¹ï¼š
dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol
http=com.alibaba.dubbo.rpc.protocol.http.HttpProtocol
rest=com.alibaba.dubbo.rpc.protocol.rest.RestProtocol

ä¼˜åŠ¿ï¼š
âœ“ keyå¯ä»¥ä½œä¸ºç®€çŸ­åç§°
âœ“ æ”¯æŒå¤šä¸ªå®ç°å…±å­˜
âœ“ æ–¹ä¾¿æŒ‰åç§°è·å–
```

**ğŸ”¸ ç‰¹æ€§3ï¼šæ”¯æŒä¾èµ–æ³¨å…¥**
```java
public class MyProtocol implements Protocol {
    
    // Dubboä¼šè‡ªåŠ¨æ³¨å…¥
    private Filter filter;  
    
    // setteræ³¨å…¥
    public void setFilter(Filter filter) {
        this.filter = filter;
    }
}
```

**ğŸ”¸ ç‰¹æ€§4ï¼šè‡ªé€‚åº”æ‰©å±•**
```java
// å¯ä»¥æ ¹æ®URLå‚æ•°åŠ¨æ€é€‰æ‹©å®ç°
@Adaptive
Protocol getProtocol(URL url);

// è°ƒç”¨æ—¶æ ¹æ®URLè‡ªåŠ¨é€‰æ‹©
// urlä¸­protocol=dubbo â†’ ä½¿ç”¨DubboProtocol
// urlä¸­protocol=http  â†’ ä½¿ç”¨HttpProtocol
```

### 3.3 Dubbo SPIçš„ä¸‰ç§é…ç½®ç›®å½•


Dubboä¼šä»ä¸‰ä¸ªç›®å½•åŠ è½½æ‰©å±•é…ç½®ï¼š

```
é…ç½®ç›®å½•ä¼˜å…ˆçº§ï¼š

â‘  META-INF/dubbo/internal/  â† Dubboå†…éƒ¨æ‰©å±•
   â””â”€â”€ æ¡†æ¶è‡ªå¸¦çš„å®ç°
   
â‘¡ META-INF/dubbo/           â† ç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•
   â””â”€â”€ ä½ è‡ªå·±å¼€å‘çš„å®ç°
   
â‘¢ META-INF/services/        â† å…¼å®¹Java SPI
   â””â”€â”€ å…¼å®¹JavaåŸç”ŸSPIæ ¼å¼

æŸ¥æ‰¾é¡ºåºï¼šinternal â†’ dubbo â†’ services
```

---

## 4. ğŸ”§ ExtensionLoaderåŠ è½½å™¨åŸç†


### 4.1 ExtensionLoaderæ˜¯ä»€ä¹ˆ


**ExtensionLoader** æ˜¯Dubbo SPIçš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£**åŠ è½½ã€ç¼“å­˜ã€åˆ›å»º**æ‰©å±•ç‚¹å®ä¾‹ã€‚

```
ExtensionLoaderå·¥ä½œæµç¨‹ï¼š

ç”¨æˆ·è°ƒç”¨
    â†“
ExtensionLoader.getExtension("dubbo")
    â†“
â‘  æ£€æŸ¥ç¼“å­˜ï¼ˆå·²åŠ è½½è¿‡ï¼Ÿï¼‰
    â†“ å¦
â‘¡ è¯»å–é…ç½®æ–‡ä»¶ï¼ˆæ‰¾åˆ°å®ç°ç±»ï¼‰
    â†“
â‘¢ åŠ è½½Classï¼ˆåå°„åŠ è½½ï¼‰
    â†“
â‘£ åˆ›å»ºå®ä¾‹ï¼ˆå®ä¾‹åŒ–å¯¹è±¡ï¼‰
    â†“
â‘¤ ä¾èµ–æ³¨å…¥ï¼ˆæ³¨å…¥å…¶ä»–æ‰©å±•ï¼‰
    â†“
â‘¥ åŒ…è£…å¢å¼ºï¼ˆAOPåŒ…è£…ï¼‰
    â†“
è¿”å›å®ä¾‹
```

### 4.2 ExtensionLoaderçš„æ ¸å¿ƒæ–¹æ³•


```java
// è·å–ExtensionLoaderå®ä¾‹ï¼ˆæ¯ä¸ªæ¥å£ä¸€ä¸ªLoaderï¼‰
ExtensionLoader<Protocol> loader = 
    ExtensionLoader.getExtensionLoader(Protocol.class);

// è·å–æŒ‡å®šåç§°çš„æ‰©å±•å®ä¾‹
Protocol protocol = loader.getExtension("dubbo");

// è·å–é»˜è®¤æ‰©å±•ï¼ˆ@SPIæ³¨è§£æŒ‡å®šï¼‰
Protocol defaultProtocol = loader.getDefaultExtension();

// è·å–è‡ªé€‚åº”æ‰©å±•
Protocol adaptive = loader.getAdaptiveExtension();

// è·å–æ‰€æœ‰æ‰©å±•åç§°
Set<String> names = loader.getSupportedExtensions();
```

### 4.3 ç¼“å­˜æœºåˆ¶è¯¦è§£


ExtensionLoaderä½¿ç”¨äº†**å¤šçº§ç¼“å­˜**æå‡æ€§èƒ½ï¼š

```
ç¼“å­˜å±‚çº§ç»“æ„ï¼š

ä¸€çº§ç¼“å­˜ï¼šExtensionLoaderå®ä¾‹ç¼“å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Protocol.class â†’ Loader1    â”‚
â”‚ Filter.class   â†’ Loader2    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ¯ä¸ªæ¥å£å¯¹åº”ä¸€ä¸ªLoaderå®ä¾‹

äºŒçº§ç¼“å­˜ï¼šæ‰©å±•Classç¼“å­˜  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "dubbo" â†’ DubboProtocol.classâ”‚
â”‚ "http"  â†’ HttpProtocol.class â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åç§°åˆ°Classçš„æ˜ å°„

ä¸‰çº§ç¼“å­˜ï¼šæ‰©å±•å®ä¾‹ç¼“å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ "dubbo" â†’ dubboProtocolObj  â”‚
â”‚ "http"  â†’ httpProtocolObj   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å·²åˆ›å»ºçš„å®ä¾‹å¯¹è±¡

ä¼˜åŠ¿ï¼š
âœ“ é¿å…é‡å¤åŠ è½½é…ç½®æ–‡ä»¶
âœ“ é¿å…é‡å¤åˆ›å»ºå®ä¾‹
âœ“ æå‡æ€§èƒ½
```

### 4.4 åŠ è½½è¿‡ç¨‹æºç é€»è¾‘


```java
// ç®€åŒ–çš„åŠ è½½é€»è¾‘
public T getExtension(String name) {
    
    // â‘  å‚æ•°æ£€æŸ¥
    if (name == null || name.isEmpty()) {
        throw new IllegalArgumentException("åç§°ä¸èƒ½ä¸ºç©º");
    }
    
    // â‘¡ æ£€æŸ¥å®ä¾‹ç¼“å­˜
    Holder<Object> holder = cachedInstances.get(name);
    if (holder == null) {
        cachedInstances.putIfAbsent(name, new Holder<>());
        holder = cachedInstances.get(name);
    }
    
    Object instance = holder.get();
    if (instance == null) {
        synchronized (holder) {
            instance = holder.get();
            if (instance == null) {
                // â‘¢ åˆ›å»ºå®ä¾‹
                instance = createExtension(name);
                holder.set(instance);
            }
        }
    }
    
    return (T) instance;
}

private T createExtension(String name) {
    // â‘  è·å–æ‰©å±•ç±»
    Class<?> clazz = getExtensionClasses().get(name);
    
    // â‘¡ å®ä¾‹åŒ–
    T instance = (T) clazz.newInstance();
    
    // â‘¢ ä¾èµ–æ³¨å…¥
    injectExtension(instance);
    
    // â‘£ åŒ…è£…å¢å¼º
    Set<Class<?>> wrapperClasses = cachedWrapperClasses;
    if (wrapperClasses != null) {
        for (Class<?> wrapperClass : wrapperClasses) {
            instance = injectExtension(
                (T) wrapperClass.getConstructor(type)
                    .newInstance(instance)
            );
        }
    }
    
    return instance;
}
```

---

## 5. ğŸ¯ Adaptiveè‡ªé€‚åº”æ‰©å±•


### 5.1 ä»€ä¹ˆæ˜¯è‡ªé€‚åº”æ‰©å±•


**è‡ªé€‚åº”æ‰©å±•**æ˜¯Dubboæœ€å¼ºå¤§çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒèƒ½**æ ¹æ®è¿è¡Œæ—¶çš„å‚æ•°åŠ¨æ€é€‰æ‹©ä½¿ç”¨å“ªä¸ªæ‰©å±•å®ç°**ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå›ºå®šé€‰æ‹©ï¼‰ï¼š
ä»£ç ä¸­å†™æ­»ï¼š
Protocol protocol = new DubboProtocol();  â† å›ºå®šä½¿ç”¨dubbo

é—®é¢˜ï¼š
â€¢ æƒ³æ¢httpåè®®ï¼Ÿæ”¹ä»£ç é‡æ–°ç¼–è¯‘
â€¢ ä¸åŒåœºæ™¯ç”¨ä¸åŒåè®®ï¼Ÿå†™ä¸€å †if-else

è‡ªé€‚åº”æ–¹å¼ï¼ˆåŠ¨æ€é€‰æ‹©ï¼‰ï¼š
Protocol protocol = loader.getAdaptiveExtension();
protocol.export(url);  â† æ ¹æ®urlå‚æ•°è‡ªåŠ¨é€‰æ‹©

ä¼˜åŠ¿ï¼š
âœ“ æ— éœ€æ”¹ä»£ç 
âœ“ é…ç½®æ–‡ä»¶æˆ–URLå‚æ•°æ§åˆ¶
âœ“ è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢
```

### 5.2 @Adaptiveæ³¨è§£åŸç†


**@Adaptive**æ³¨è§£å¯ä»¥æ ‡æ³¨åœ¨**ç±»**æˆ–**æ–¹æ³•**ä¸Šï¼š

**åœºæ™¯1ï¼šæ ‡æ³¨åœ¨ç±»ä¸Šï¼ˆæ‰‹åŠ¨å®ç°ï¼‰**
```java
@Adaptive
public class AdaptiveProtocol implements Protocol {
    
    public void export(URL url) {
        // æ‰‹åŠ¨æ ¹æ®URLå‚æ•°é€‰æ‹©åè®®
        String protocol = url.getProtocol();
        
        Protocol realProtocol = ExtensionLoader
            .getExtensionLoader(Protocol.class)
            .getExtension(protocol);
            
        realProtocol.export(url);
    }
}
```

**åœºæ™¯2ï¼šæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰**
```java
public interface Protocol {
    
    // æ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼ŒDubboä¼šè‡ªåŠ¨ç”ŸæˆAdaptiveç±»
    @Adaptive
    void export(URL url);
    
    @Adaptive
    void refer(URL url);
}
```

### 5.3 è‡ªé€‚åº”æ‰©å±•çš„å®ç°æœºåˆ¶


å½“`@Adaptive`æ ‡æ³¨åœ¨æ–¹æ³•ä¸Šæ—¶ï¼ŒDubboä¼š**åŠ¨æ€ç”Ÿæˆä»£ç **ï¼š

```java
// åŸå§‹æ¥å£
public interface Protocol {
    @Adaptive
    Exporter export(Invoker invoker);
}

// Dubboè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ï¼ˆç®€åŒ–ç‰ˆï¼‰
public class Protocol$Adaptive implements Protocol {
    
    public Exporter export(Invoker invoker) {
        
        // â‘  è·å–URLå¯¹è±¡
        URL url = invoker.getUrl();
        
        // â‘¡ ä»URLä¸­è·å–åè®®å‚æ•°
        String protocol = url.getProtocol();
        if (protocol == null) {
            throw new IllegalStateException("æ‰¾ä¸åˆ°protocolå‚æ•°");
        }
        
        // â‘¢ æ ¹æ®å‚æ•°å€¼è·å–çœŸæ­£çš„æ‰©å±•
        Protocol realProtocol = ExtensionLoader
            .getExtensionLoader(Protocol.class)
            .getExtension(protocol);
        
        // â‘£ è°ƒç”¨çœŸæ­£çš„æ–¹æ³•
        return realProtocol.export(invoker);
    }
}
```

### 5.4 URLå‚æ•°çš„ä½œç”¨


**URLæ˜¯Dubboçš„æ ¸å¿ƒé…ç½®è½½ä½“**ï¼Œè‡ªé€‚åº”æ‰©å±•å°±æ˜¯ä»URLä¸­è¯»å–å‚æ•°ï¼š

```
URLç¤ºä¾‹ï¼š
dubbo://192.168.1.100:20880/com.example.DemoService?protocol=dubbo

è§£æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ protocol   â†’ dubbo                  â”‚ â† åè®®ç±»å‹
â”‚ host       â†’ 192.168.1.100          â”‚ â† ä¸»æœºåœ°å€
â”‚ port       â†’ 20880                  â”‚ â† ç«¯å£
â”‚ path       â†’ com.example.DemoServiceâ”‚ â† æœåŠ¡æ¥å£
â”‚ parameters â†’ {protocol=dubbo}       â”‚ â† é¢å¤–å‚æ•°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è‡ªé€‚åº”é€‰æ‹©é€»è¾‘ï¼š
url.getParameter("protocol", "dubbo")
                    â†‘         â†‘
                  å‚æ•°å    é»˜è®¤å€¼
```

**æŒ‡å®šå‚æ•°å**ï¼š
```java
// å¯ä»¥é€šè¿‡@Adaptiveæ³¨è§£æŒ‡å®šä»å“ªä¸ªå‚æ•°è¯»å–
public interface Cluster {
    
    // ä»URLçš„clusterå‚æ•°è¯»å–å€¼
    @Adaptive("cluster")
    Invoker join(Directory directory);
}

// è°ƒç”¨æ—¶ï¼š
// urlä¸­cluster=failover â†’ ä½¿ç”¨FailoverCluster
// urlä¸­cluster=failfast â†’ ä½¿ç”¨FailfastCluster
```

---

## 6. ğŸ”— æ‰©å±•ç‚¹æ³¨å…¥ä¸åŒ…è£…


### 6.1 ä¾èµ–æ³¨å…¥ï¼ˆIOCï¼‰


Dubbo SPIæ”¯æŒ**è‡ªåŠ¨æ³¨å…¥å…¶ä»–æ‰©å±•ç‚¹**ï¼Œç±»ä¼¼Springçš„ä¾èµ–æ³¨å…¥ï¼š

```java
public class MyProtocol implements Protocol {
    
    // â‘  å£°æ˜éœ€è¦çš„ä¾èµ–
    private Filter filter;
    private Codec codec;
    
    // â‘¡ æä¾›setteræ–¹æ³•ï¼ˆå¿…é¡»ï¼‰
    public void setFilter(Filter filter) {
        this.filter = filter;
    }
    
    public void setCodec(Codec codec) {
        this.codec = codec;
    }
    
    // â‘¢ Dubboä¼šè‡ªåŠ¨è°ƒç”¨setteræ³¨å…¥
}
```

**æ³¨å…¥è§„åˆ™**ï¼š
```
â‘  æ‰«ææ‰€æœ‰setteræ–¹æ³•
â‘¡ æå–å±æ€§ç±»å‹ï¼ˆFilterã€Codecç­‰ï¼‰
â‘¢ åˆ¤æ–­ç±»å‹æ˜¯å¦æ˜¯æ‰©å±•ç‚¹æ¥å£
â‘£ å¦‚æœæ˜¯ï¼Œè·å–è‡ªé€‚åº”æ‰©å±•
â‘¤ è°ƒç”¨setteræ–¹æ³•æ³¨å…¥
```

**æ³¨å…¥çš„æ˜¯è‡ªé€‚åº”æ‰©å±•**ï¼š
```java
// æ³¨å…¥çš„filteræ˜¯è‡ªé€‚åº”æ‰©å±•
private Filter filter;  // â†’ Filter$Adaptive

// è°ƒç”¨æ—¶æ‰æ ¹æ®URLç¡®å®šå…·ä½“å®ç°
filter.invoke(invoker, invocation);
```

### 6.2 AOPåŒ…è£…æœºåˆ¶


Dubboæ”¯æŒ**åŒ…è£…ç±»ï¼ˆWrapperï¼‰**ï¼Œå®ç°AOPåŠŸèƒ½ï¼š

```
åŒ…è£…ç±»æ¦‚å¿µï¼š

æ™®é€šå®ç°ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DubboProtocolâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŒ…è£…ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProtocolFilterWrapper â”‚ â† åŒ…è£…ç±»
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ DubboProtocolâ”‚    â”‚ â† è¢«åŒ…è£…çš„å¯¹è±¡
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®šä¹‰åŒ…è£…ç±»**ï¼š
```java
// åŒ…è£…ç±»å¿…é¡»æœ‰æ¥å—è¢«åŒ…è£…ç±»å‹çš„æ„é€ æ–¹æ³•
public class ProtocolFilterWrapper implements Protocol {
    
    private final Protocol protocol;  // è¢«åŒ…è£…çš„å¯¹è±¡
    
    // æ„é€ æ–¹æ³•æ¥æ”¶è¢«åŒ…è£…å¯¹è±¡
    public ProtocolFilterWrapper(Protocol protocol) {
        this.protocol = protocol;
    }
    
    @Override
    public void export(Invoker invoker) {
        // å‰ç½®å¢å¼º
        System.out.println("æ‰§è¡Œå‰ç½®è¿‡æ»¤");
        
        // è°ƒç”¨åŸå§‹æ–¹æ³•
        protocol.export(invoker);
        
        // åç½®å¢å¼º
        System.out.println("æ‰§è¡Œåç½®è¿‡æ»¤");
    }
}
```

**åŒ…è£…é¡ºåº**ï¼š
```
é…ç½®æ–‡ä»¶ä¸­çš„åŒ…è£…ç±»ï¼š
filter=com.example.ProtocolFilterWrapper
listener=com.example.ProtocolListenerWrapper

åŒ…è£…é¡ºåºï¼š
DubboProtocol
    â†“ åŒ…è£…1
ProtocolFilterWrapper(DubboProtocol)
    â†“ åŒ…è£…2
ProtocolListenerWrapper(ProtocolFilterWrapper(DubboProtocol))

è°ƒç”¨é“¾ï¼š
å¤–å±‚Wrapper â†’ å†…å±‚Wrapper â†’ çœŸå®å®ç°
```

### 6.3 æ¿€æ´»æœºåˆ¶ï¼ˆ@Activateï¼‰


æŸäº›æ‰©å±•éœ€è¦**åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è‡ªåŠ¨æ¿€æ´»**ï¼Œä½¿ç”¨`@Activate`æ³¨è§£ï¼š

```java
// åªåœ¨æ¶ˆè´¹è€…ç«¯æ¿€æ´»
@Activate(group = "consumer")
public class ConsumerContextFilter implements Filter {
    // æ¶ˆè´¹è€…ç«¯æ‹¦æˆªå™¨
}

// åªåœ¨æä¾›è€…ç«¯æ¿€æ´»
@Activate(group = "provider")
public class ProviderContextFilter implements Filter {
    // æä¾›è€…ç«¯æ‹¦æˆªå™¨
}

// æŒ‡å®šé¡ºåºæ¿€æ´»
@Activate(group = "provider", order = -10000)
public class FirstFilter implements Filter {
    // ä¼˜å…ˆçº§æœ€é«˜çš„è¿‡æ»¤å™¨
}
```

**æ¿€æ´»æ¡ä»¶**ï¼š

| å±æ€§ | **è¯´æ˜** | **ç¤ºä¾‹** |
|-----|---------|---------|
| `group` | `æŒ‡å®šæ¿€æ´»çš„åˆ†ç»„` | consumer/provider |
| `value` | `URLä¸­åŒ…å«æŒ‡å®šå‚æ•°æ‰æ¿€æ´»` | cache/validation |
| `order` | `æ¿€æ´»é¡ºåºï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆï¼‰` | -10000, 0, 10000 |

**å®é™…åº”ç”¨**ï¼š
```java
// åªæœ‰URLä¸­æœ‰cacheå‚æ•°æ‰æ¿€æ´»
@Activate(group = "consumer", value = "cache")
public class CacheFilter implements Filter {
    // ç¼“å­˜è¿‡æ»¤å™¨
}

// URL: dubbo://...?cache=lru
// â†’ CacheFilterä¼šè¢«è‡ªåŠ¨æ¿€æ´»
```

---

## 7. ğŸ› ï¸ è‡ªå®šä¹‰æ‰©å±•å¼€å‘å®æˆ˜


### 7.1 å¼€å‘è‡ªå®šä¹‰åè®®æ‰©å±•


**æ­¥éª¤1ï¼šå®šä¹‰æ‰©å±•ç‚¹æ¥å£**
```java
@SPI("dubbo")  // æŒ‡å®šé»˜è®¤æ‰©å±•å
public interface Protocol {
    
    @Adaptive
    void export(URL url);
    
    @Adaptive  
    void refer(URL url);
}
```

**æ­¥éª¤2ï¼šå®ç°æ‰©å±•**
```java
// è‡ªå®šä¹‰MyRPCåè®®
public class MyRpcProtocol implements Protocol {
    
    @Override
    public void export(URL url) {
        System.out.println("ä½¿ç”¨MyRPCåè®®æš´éœ²æœåŠ¡: " + url);
        // å®ç°æœåŠ¡æš´éœ²é€»è¾‘
    }
    
    @Override
    public void refer(URL url) {
        System.out.println("ä½¿ç”¨MyRPCåè®®å¼•ç”¨æœåŠ¡: " + url);
        // å®ç°æœåŠ¡å¼•ç”¨é€»è¾‘
    }
}
```

**æ­¥éª¤3ï¼šé…ç½®æ‰©å±•**
```
åˆ›å»ºæ–‡ä»¶ï¼šMETA-INF/dubbo/org.apache.dubbo.rpc.Protocol

æ–‡ä»¶å†…å®¹ï¼š
myrpc=com.example.MyRpcProtocol
```

**æ­¥éª¤4ï¼šä½¿ç”¨æ‰©å±•**
```java
// æ–¹å¼1ï¼šä»£ç ä¸­æŒ‡å®š
ExtensionLoader<Protocol> loader = 
    ExtensionLoader.getExtensionLoader(Protocol.class);
Protocol protocol = loader.getExtension("myrpc");

// æ–¹å¼2ï¼šé…ç½®æ–‡ä»¶æŒ‡å®š
// dubbo.protocol.name=myrpc

// æ–¹å¼3ï¼šURLå‚æ•°æŒ‡å®š
// dubbo://...?protocol=myrpc
```

### 7.2 å¼€å‘è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡


**æ­¥éª¤1ï¼šå®ç°LoadBalanceæ¥å£**
```java
public class MyLoadBalance extends AbstractLoadBalance {
    
    @Override
    protected <T> Invoker<T> doSelect(
        List<Invoker<T>> invokers, 
        URL url, 
        Invocation invocation) {
        
        // è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•
        // ä¾‹å¦‚ï¼šæ ¹æ®å“åº”æ—¶é—´é€‰æ‹©
        Invoker<T> fastest = null;
        long minTime = Long.MAX_VALUE;
        
        for (Invoker<T> invoker : invokers) {
            long responseTime = getResponseTime(invoker);
            if (responseTime < minTime) {
                minTime = responseTime;
                fastest = invoker;
            }
        }
        
        return fastest;
    }
    
    private long getResponseTime(Invoker<?> invoker) {
        // è·å–å“åº”æ—¶é—´çš„é€»è¾‘
        return 0L;
    }
}
```

**æ­¥éª¤2ï¼šé…ç½®æ‰©å±•**
```
æ–‡ä»¶ï¼šMETA-INF/dubbo/org.apache.dubbo.rpc.cluster.LoadBalance

å†…å®¹ï¼š
fastest=com.example.MyLoadBalance
```

**æ­¥éª¤3ï¼šä½¿ç”¨**
```xml
<!-- æ¶ˆè´¹è€…é…ç½® -->
<dubbo:reference 
    interface="com.example.DemoService"
    loadbalance="fastest"/>
```

### 7.3 å¼€å‘è‡ªå®šä¹‰è¿‡æ»¤å™¨


**æ­¥éª¤1ï¼šå®ç°Filteræ¥å£**
```java
@Activate(group = "provider", order = -1000)
public class MyTraceFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        
        // å‰ç½®å¤„ç†
        long start = System.currentTimeMillis();
        String method = invocation.getMethodName();
        System.out.println("å¼€å§‹è°ƒç”¨: " + method);
        
        try {
            // æ‰§è¡Œè°ƒç”¨
            Result result = invoker.invoke(invocation);
            
            // åç½®å¤„ç†
            long cost = System.currentTimeMillis() - start;
            System.out.println("è°ƒç”¨å®Œæˆ: " + method + ", è€—æ—¶: " + cost + "ms");
            
            return result;
            
        } catch (Exception e) {
            // å¼‚å¸¸å¤„ç†
            System.out.println("è°ƒç”¨å¼‚å¸¸: " + method);
            throw e;
        }
    }
}
```

**æ­¥éª¤2ï¼šé…ç½®æ¿€æ´»**
```
æ–‡ä»¶ï¼šMETA-INF/dubbo/org.apache.dubbo.rpc.Filter

å†…å®¹ï¼š
mytrace=com.example.MyTraceFilter
```

**æ•ˆæœ**ï¼š
```
æ‰€æœ‰æä¾›è€…ç«¯çš„æ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«æ‹¦æˆªï¼š

å¼€å§‹è°ƒç”¨: sayHello
è°ƒç”¨å®Œæˆ: sayHello, è€—æ—¶: 23ms

å¼€å§‹è°ƒç”¨: getUser  
è°ƒç”¨å®Œæˆ: getUser, è€—æ—¶: 156ms
```

### 7.4 å®Œæ•´çš„æ‰©å±•å¼€å‘è§„èŒƒ


```
å¼€å‘æ£€æŸ¥æ¸…å•ï¼š

âœ“ æ¥å£å®šä¹‰
  â€¢ æ˜¯å¦æ ‡æ³¨@SPI
  â€¢ æ˜¯å¦æŒ‡å®šé»˜è®¤æ‰©å±•
  â€¢ æ–¹æ³•æ˜¯å¦éœ€è¦@Adaptive

âœ“ å®ç°ç±»å¼€å‘
  â€¢ æ— å‚æ„é€ æ–¹æ³•
  â€¢ éœ€è¦æ³¨å…¥çš„ä¾èµ–æä¾›setter
  â€¢ çº¿ç¨‹å®‰å…¨è€ƒè™‘

âœ“ é…ç½®æ–‡ä»¶
  â€¢ æ”¾åœ¨æ­£ç¡®çš„ç›®å½•
  â€¢ KVæ ¼å¼æ­£ç¡®
  â€¢ ç±»å…¨åå®Œæ•´

âœ“ åŒ…è£…ç±»ï¼ˆå¯é€‰ï¼‰
  â€¢ æä¾›æ¥å—è¢«åŒ…è£…ç±»å‹çš„æ„é€ æ–¹æ³•
  â€¢ å®ç°å¢å¼ºé€»è¾‘

âœ“ æ¿€æ´»å™¨ï¼ˆå¯é€‰ï¼‰
  â€¢ @Activateé…ç½®æ­£ç¡®
  â€¢ groupã€valueã€orderè®¾ç½®åˆç†
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SPIæœ¬è´¨ï¼šæ’ä»¶åŒ–æœºåˆ¶ï¼Œæ¥å£ä¸å®ç°è§£è€¦
ğŸ”¸ Dubbo SPIä¼˜åŠ¿ï¼šæŒ‰éœ€åŠ è½½ã€ä¾èµ–æ³¨å…¥ã€AOPåŒ…è£…ã€è‡ªé€‚åº”æ‰©å±•
ğŸ”¸ ExtensionLoaderï¼šæ ¸å¿ƒåŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ã€ç¼“å­˜ã€åˆ›å»ºæ‰©å±•
ğŸ”¸ @Adaptiveï¼šè‡ªé€‚åº”æ‰©å±•ï¼Œæ ¹æ®URLå‚æ•°åŠ¨æ€é€‰æ‹©å®ç°
ğŸ”¸ ä¾èµ–æ³¨å…¥ï¼šè‡ªåŠ¨æ³¨å…¥å…¶ä»–æ‰©å±•ç‚¹ï¼ˆæ³¨å…¥çš„æ˜¯è‡ªé€‚åº”æ‰©å±•ï¼‰
ğŸ”¸ AOPåŒ…è£…ï¼šWrapperç±»å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹
ğŸ”¸ @Activateï¼šæ¡ä»¶æ¿€æ´»æœºåˆ¶
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆDubboè¦é‡å†™SPI**
```
Java SPIé—®é¢˜ï¼š
âœ— å¿…é¡»åŠ è½½æ‰€æœ‰å®ç°
âœ— ä¸æ”¯æŒæŒ‰éœ€è·å–
âœ— é…ç½®ä¸çµæ´»
âœ— æ— ä¾èµ–æ³¨å…¥

Dubbo SPIè§£å†³ï¼š
âœ“ æŒ‰åç§°è·å–æŒ‡å®šå®ç°
âœ“ å»¶è¿ŸåŠ è½½ï¼Œç”¨æ—¶åˆ›å»º
âœ“ KVé…ç½®ï¼Œæ”¯æŒåˆ«å
âœ“ IOCå’ŒAOPæ”¯æŒ
```

**ğŸ”¹ è‡ªé€‚åº”æ‰©å±•çš„ä»·å€¼**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
ä»£ç å†™æ­»å®ç°ç±» â†’ ä¸çµæ´»
é…ç½®å†™æ­»å®ç°ç±» â†’ éœ€è¦é‡å¯

è‡ªé€‚åº”æ‰©å±•ï¼š
è¿è¡Œæ—¶æ ¹æ®URLå‚æ•°åŠ¨æ€é€‰æ‹©
â†’ æ— éœ€æ”¹ä»£ç 
â†’ æ— éœ€é‡å¯
â†’ çµæ´»åˆ‡æ¢
```

**ğŸ”¹ URLçš„æ ¸å¿ƒä½œç”¨**
```
URLæ˜¯Dubboçš„é…ç½®æ€»çº¿ï¼š

â‘  æºå¸¦é…ç½®å‚æ•°
â‘¡ è‡ªé€‚åº”æ‰©å±•çš„ä¾æ®
â‘¢ æœåŠ¡åœ°å€çš„è¡¨ç¤º
â‘£ å„ç»„ä»¶é—´çš„é€šä¿¡å¥‘çº¦

ç†è§£URL = ç†è§£Dubboè¿è¡Œæœºåˆ¶
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**åœºæ™¯1ï¼šåè®®åˆ‡æ¢**
```
å¼€å‘ç¯å¢ƒç”¨dubboåè®®æµ‹è¯•
ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢åˆ°é«˜æ€§èƒ½åè®®

åªéœ€ä¿®æ”¹é…ç½®ï¼š
dubbo.protocol.name=myrpc

æ— éœ€æ”¹ä»£ç ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘
```

**åœºæ™¯2ï¼šç°åº¦å‘å¸ƒ**
```
éƒ¨åˆ†æµé‡ä½¿ç”¨æ–°ç‰ˆæœ¬è´Ÿè½½å‡è¡¡ç®—æ³•

é€šè¿‡URLå‚æ•°æ§åˆ¶ï¼š
loadbalance=newAlgorithm  â† æ–°ç®—æ³•
loadbalance=random        â† æ—§ç®—æ³•

å¹³æ»‘è¿‡æ¸¡ï¼Œé£é™©å¯æ§
```

**åœºæ™¯3ï¼šç›‘æ§å¢å¼º**
```
æ·»åŠ æ€§èƒ½ç›‘æ§è¿‡æ»¤å™¨

å¼€å‘ç›‘æ§Filter â†’ é…ç½®æ¿€æ´»
æ‰€æœ‰æœåŠ¡è‡ªåŠ¨è·å¾—ç›‘æ§èƒ½åŠ›

æ— ä¾µå…¥å¼å¢å¼º
```

### 8.4 å­¦ä¹ å»ºè®®


```
â‘  å…ˆç†è§£SPIæ€æƒ³
   â†’ æ¥å£ä¸å®ç°åˆ†ç¦»
   â†’ æ’ä»¶åŒ–æ¶æ„

â‘¡ æŒæ¡ExtensionLoaderç”¨æ³•
   â†’ getExtension()
   â†’ getAdaptiveExtension()

â‘¢ ç†è§£è‡ªé€‚åº”æ‰©å±•
   â†’ @AdaptiveåŸç†
   â†’ URLå‚æ•°ä¼ é€’

â‘£ å®è·µè‡ªå®šä¹‰æ‰©å±•
   â†’ ä»ç®€å•çš„Filterå¼€å§‹
   â†’ é€æ­¥å®ç°å¤æ‚æ‰©å±•

â‘¤ é˜…è¯»æºç åŠ æ·±ç†è§£
   â†’ ExtensionLoaderæºç 
   â†’ å†…ç½®æ‰©å±•å®ç°
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
SPIæ’ä»¶åŒ–ï¼Œæ¥å£å®ç°åˆ†
ExtensionLoaderï¼ŒæŒ‰éœ€æ¥åŠ è½½
Adaptiveè‡ªé€‚åº”ï¼ŒURLæ¥å†³å®š
ä¾èµ–è‡ªåŠ¨æ³¨å…¥ï¼ŒWrapperæ¥åŒ…è£…
Activateæ¡ä»¶å¯ï¼Œçµæ´»åˆå¼ºå¤§
```