---
title: 32ã€Dubboå®‰å…¨ä¸è®¤è¯æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡å®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-å¾®æœåŠ¡å®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [TLSåŠ å¯†é€šä¿¡æœºåˆ¶](#2-TLSåŠ å¯†é€šä¿¡æœºåˆ¶)
3. [æœåŠ¡é‰´æƒæœºåˆ¶è¯¦è§£](#3-æœåŠ¡é‰´æƒæœºåˆ¶è¯¦è§£)
4. [è®¿é—®æ§åˆ¶ç­–ç•¥é…ç½®](#4-è®¿é—®æ§åˆ¶ç­–ç•¥é…ç½®)
5. [æ¥å£æƒé™ç®¡ç†å®ç°](#5-æ¥å£æƒé™ç®¡ç†å®ç°)
6. [æ•°æ®åŠ å¯†ä¼ è¾“æ–¹æ¡ˆ](#6-æ•°æ®åŠ å¯†ä¼ è¾“æ–¹æ¡ˆ)
7. [å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ](#7-å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ)
8. [é˜²æŠ¤æ”»å‡»ç­–ç•¥å®è·µ](#8-é˜²æŠ¤æ”»å‡»ç­–ç•¥å®è·µ)
9. [èº«ä»½è®¤è¯é›†æˆæ–¹æ¡ˆ](#9-èº«ä»½è®¤è¯é›†æˆæ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å¾®æœåŠ¡å®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦å®‰å…¨é˜²æŠ¤


**ğŸ”¸ ä»å•ä½“åˆ°å¾®æœåŠ¡çš„å®‰å…¨æŒ‘æˆ˜**

åœ¨ä¼ ç»Ÿå•ä½“åº”ç”¨ä¸­ï¼Œæ‰€æœ‰åŠŸèƒ½éƒ½åœ¨ä¸€ä¸ªåº”ç”¨å†…éƒ¨ï¼Œå°±åƒä¸€ä¸ªå°é—­çš„æˆ¿å­ï¼Œåªéœ€è¦å®ˆå¥½å¤§é—¨å°±è¡Œã€‚ä½†å¾®æœåŠ¡æ¶æ„å°±åƒä¸€ä¸ªå°åŒºï¼Œæœ‰å¾ˆå¤šæ ‹æ¥¼ï¼ˆæœåŠ¡ï¼‰ï¼Œæ¯æ ‹æ¥¼ä¹‹é—´è¦ç›¸äº’è®¿é—®ï¼Œå®‰å…¨é—®é¢˜å°±å¤æ‚äº†ï¼š

```
å•ä½“åº”ç”¨å®‰å…¨æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å•ä½“åº”ç”¨         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç”¨æˆ·æ¨¡å—     â”‚ â”‚
â”‚  â”‚ è®¢å•æ¨¡å—     â”‚ â”‚  åªéœ€è¦å®ˆæŠ¤ä¸€ä¸ªå…¥å£
â”‚  â”‚ æ”¯ä»˜æ¨¡å—     â”‚ â”‚  â†â”€â”€â”€ å¤–éƒ¨è®¿é—®
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡å®‰å…¨æ¨¡å‹ï¼š
     å¤–éƒ¨è®¿é—®
        â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ APIç½‘å…³ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    æœåŠ¡é—´äº’ç›¸è°ƒç”¨
    â†™    â†“    â†˜
â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·  â”‚â”‚è®¢å•  â”‚â”‚æ”¯ä»˜  â”‚  æ¯ä¸ªæœåŠ¡éƒ½å¯èƒ½
â”‚æœåŠ¡  â”‚â”‚æœåŠ¡  â”‚â”‚æœåŠ¡  â”‚  æˆä¸ºæ”»å‡»ç›®æ ‡
â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å¾®æœåŠ¡å®‰å…¨çš„æ ¸å¿ƒé—®é¢˜**

| å®‰å…¨é—®é¢˜ | å…·ä½“è¯´æ˜ | å®é™…å½±å“ |
|---------|---------|---------|
| **æœåŠ¡æš´éœ²** | æ¯ä¸ªæœåŠ¡éƒ½æœ‰ç½‘ç»œç«¯å£ | æ”»å‡»é¢å¤§å¤§å¢åŠ  |
| **æœåŠ¡é—´é€šä¿¡** | æœåŠ¡ä¹‹é—´è¦äº’ç›¸è°ƒç”¨ | å†…éƒ¨é€šä¿¡ä¹Ÿå¯èƒ½è¢«çªƒå¬ |
| **èº«ä»½éªŒè¯** | å¦‚ä½•ç¡®è®¤è°ƒç”¨æ–¹æ˜¯è° | é˜²æ­¢æœåŠ¡å†’å…… |
| **æƒé™æ§åˆ¶** | ä¸åŒæœåŠ¡èƒ½åšä»€ä¹ˆ | é˜²æ­¢è¶Šæƒè®¿é—® |
| **æ•°æ®ä¼ è¾“** | æ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“ | å¯èƒ½è¢«æˆªè·æˆ–ç¯¡æ”¹ |

### 1.2 Dubboå®‰å…¨æ¶æ„å…¨æ™¯


**ğŸ—ï¸ Dubboå®‰å…¨é˜²æŠ¤ä½“ç³»**

Dubboçš„å®‰å…¨æœºåˆ¶å°±åƒå¤šé“é˜²çº¿ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸åŒçš„èŒè´£ï¼š

```
å®Œæ•´çš„å®‰å…¨é˜²æŠ¤é“¾è·¯ï¼š

ç¬¬ä¸€å±‚ï¼šç½‘ç»œä¼ è¾“åŠ å¯†ï¼ˆTLSï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆè´¹è€… â†â”€[åŠ å¯†é€šé“]â”€â†’ æä¾›è€…   â”‚  é˜²æ­¢æ•°æ®è¢«çªƒå¬
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒå±‚ï¼šèº«ä»½è®¤è¯ï¼ˆAuthenticationï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°åœ¨è°ƒç”¨ï¼ŸéªŒè¯è°ƒç”¨æ–¹èº«ä»½       â”‚  é˜²æ­¢éæ³•è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰å±‚ï¼šæƒé™æ§åˆ¶ï¼ˆAuthorizationï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èƒ½åšä»€ä¹ˆï¼Ÿæ£€æŸ¥è®¿é—®æƒé™         â”‚  é˜²æ­¢è¶Šæƒæ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å››å±‚ï¼šå®‰å…¨å®¡è®¡ï¼ˆAuditï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®°å½•æ‰€æœ‰æ“ä½œæ—¥å¿—               â”‚  äº‹åè¿½æº¯åˆ†æ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å®‰å…¨å¨èƒç±»å‹è®¤çŸ¥


**âš ï¸ å¸¸è§çš„å®‰å…¨æ”»å‡»æ‰‹æ®µ**

- **ä¸­é—´äººæ”»å‡»ï¼ˆMITMï¼‰**ï¼šå°±åƒæœ‰äººåœ¨ä½ å’Œæœ‹å‹é€šè¯æ—¶å·å¬ï¼Œç”šè‡³ç¯¡æ”¹å¯¹è¯å†…å®¹
- **æœåŠ¡å†’å……**ï¼šå‡è£…æ˜¯åˆæ³•æœåŠ¡æ¥éª—å–æ•°æ®ï¼Œç±»ä¼¼ç”µè¯è¯ˆéª—
- **é‡æ”¾æ”»å‡»**ï¼šæˆªè·ä½ çš„è¯·æ±‚ï¼Œç„¶ååå¤é‡å‘ï¼Œç±»ä¼¼å¤åˆ¶ä½ çš„é—¨ç¦å¡
- **æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰**ï¼šå¤§é‡è¯·æ±‚æ”»å‡»æœåŠ¡ï¼Œè®©æ­£å¸¸ç”¨æˆ·æ— æ³•ä½¿ç”¨

**ğŸ¯ å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒç›®æ ‡**

```
ä¿å¯†æ€§ï¼ˆConfidentialityï¼‰ï¼š
â†’ æ•°æ®ä¸è¢«æœªæˆæƒçš„äººçœ‹åˆ°
â†’ é€šè¿‡åŠ å¯†å®ç°

å®Œæ•´æ€§ï¼ˆIntegrityï¼‰ï¼š
â†’ æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«ç¯¡æ”¹
â†’ é€šè¿‡ç­¾åå’Œæ ¡éªŒå®ç°

å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ï¼š
â†’ æœåŠ¡æŒç»­å¯ç”¨ï¼Œä¸è¢«æ”»å‡»ä¸­æ–­
â†’ é€šè¿‡é™æµå’Œé˜²æŠ¤ç­–ç•¥å®ç°

å¯è¿½æº¯æ€§ï¼ˆAccountabilityï¼‰ï¼š
â†’ æ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•å¯æŸ¥
â†’ é€šè¿‡å®¡è®¡æ—¥å¿—å®ç°
```

---

## 2. ğŸ”’ TLSåŠ å¯†é€šä¿¡æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯TLSåŠ å¯†


**ğŸ”¸ TLSé€šä¿—ç†è§£**

TLSï¼ˆä¼ è¾“å±‚å®‰å…¨åè®®ï¼‰å°±åƒç»™ä½ çš„æ•°æ®åŒ…è£¹ä¸Šä¸€ä¸ªå¯†ç é”ï¼Œåªæœ‰æœ‰é’¥åŒ™çš„äººæ‰èƒ½æ‰“å¼€ã€‚æƒ³è±¡ä¸€ä¸‹ï¼š

```
æ²¡æœ‰åŠ å¯†çš„é€šä¿¡ï¼š
æ¶ˆè´¹è€…ï¼šæˆ‘è¦è®¢å•123çš„æ•°æ®
    â†“ï¼ˆæ˜æ–‡ä¼ è¾“ï¼Œä»»ä½•äººéƒ½èƒ½çœ‹ï¼‰
æä¾›è€…ï¼šå¥½çš„ï¼Œè¿™æ˜¯è®¢å•æ•°æ®...

ä½¿ç”¨TLSåŠ å¯†çš„é€šä¿¡ï¼š
æ¶ˆè´¹è€…ï¼š%$#@!*&^ï¼ˆåŠ å¯†åçš„ä¹±ç ï¼‰
    â†“ï¼ˆå³ä½¿è¢«æˆªè·ä¹Ÿçœ‹ä¸æ‡‚ï¼‰
æä¾›è€…ï¼š*&^%$#@!ï¼ˆåŠ å¯†å›å¤ï¼‰
    â†“ï¼ˆåˆ°è¾¾åè§£å¯†ï¼‰
æ¶ˆè´¹è€…ï¼šæ”¶åˆ°è®¢å•æ•°æ®ï¼
```

**ğŸ’¡ TLSå·¥ä½œåŸç†ç®€åŒ–ç†è§£**

TLSçš„å·¥ä½œè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

1. **æ¡æ‰‹é˜¶æ®µ**ï¼šåŒæ–¹å…ˆåå•†ä¸€ä¸ªå¯†é’¥ï¼ˆå°±åƒå…ˆçº¦å®šä¸€ä¸ªæš—å·ï¼‰
2. **é€šä¿¡é˜¶æ®µ**ï¼šç”¨è¿™ä¸ªå¯†é’¥åŠ å¯†æ‰€æœ‰æ•°æ®ä¼ è¾“

```
TLSæ¡æ‰‹è¿‡ç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

æ­¥éª¤1ï¼šæ¶ˆè´¹è€… â†’ æä¾›è€…
"ä½ å¥½ï¼Œæˆ‘æƒ³å»ºç«‹å®‰å…¨è¿æ¥"

æ­¥éª¤2ï¼šæä¾›è€… â†’ æ¶ˆè´¹è€…  
"å¥½çš„ï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦ï¼ˆèº«ä»½è¯æ˜ï¼‰"

æ­¥éª¤3ï¼šæ¶ˆè´¹è€…éªŒè¯è¯ä¹¦
"è¯ä¹¦æœ‰æ•ˆï¼Œç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯†é’¥"

æ­¥éª¤4ï¼šç”¨æä¾›è€…å…¬é’¥åŠ å¯†å¯†é’¥å‘é€
"è¿™æ˜¯æˆ‘ä»¬é€šä¿¡ç”¨çš„å¯†é’¥ï¼ˆå·²åŠ å¯†ï¼‰"

æ­¥éª¤5ï¼šå¼€å§‹åŠ å¯†é€šä¿¡
"ä»ç°åœ¨å¼€å§‹ï¼Œæ‰€æœ‰æ•°æ®éƒ½åŠ å¯†ä¼ è¾“"
```

### 2.2 Dubboä¸­å¯ç”¨TLS


**âš™ï¸ é…ç½®TLSåŠ å¯†ï¼ˆæä¾›è€…ç«¯ï¼‰**

æä¾›è€…éœ€è¦å‡†å¤‡æ•°å­—è¯ä¹¦ï¼Œå°±åƒå¼€åº—éœ€è¦è¥ä¸šæ‰§ç…§ï¼š

```yaml
# application.yml - æä¾›è€…é…ç½®
dubbo:
  protocol:
    name: dubbo
    port: 20880
    # å¯ç”¨TLSåŠ å¯†
    ssl-enabled: true
  ssl:
    # æœåŠ¡ç«¯è¯ä¹¦é…ç½®
    server-key-cert-chain: classpath:server-cert.pem  # è¯ä¹¦æ–‡ä»¶
    server-private-key: classpath:server-key.pem      # ç§é’¥æ–‡ä»¶
    # å¦‚æœéœ€è¦åŒå‘è®¤è¯ï¼ˆå¯é€‰ï¼‰
    client-trust-cert: classpath:ca-cert.pem          # ä¿¡ä»»çš„å®¢æˆ·ç«¯è¯ä¹¦
```

**âš™ï¸ é…ç½®TLSåŠ å¯†ï¼ˆæ¶ˆè´¹è€…ç«¯ï¼‰**

æ¶ˆè´¹è€…éœ€è¦ä¿¡ä»»æä¾›è€…çš„è¯ä¹¦ï¼š

```yaml
# application.yml - æ¶ˆè´¹è€…é…ç½®
dubbo:
  consumer:
    check: false
  ssl:
    # å®¢æˆ·ç«¯è¯ä¹¦é…ç½®
    client-key-cert-chain: classpath:client-cert.pem  # å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆåŒå‘è®¤è¯æ—¶ï¼‰
    client-private-key: classpath:client-key.pem      # å®¢æˆ·ç«¯ç§é’¥
    client-trust-cert: classpath:ca-cert.pem          # ä¿¡ä»»çš„CAè¯ä¹¦
```

### 2.3 è¯ä¹¦ç®¡ç†å®è·µ


**ğŸ“œ è¯ä¹¦çš„ç”Ÿæˆå’Œä½¿ç”¨**

è¯ä¹¦å°±åƒç½‘ç»œä¸–ç•Œçš„èº«ä»½è¯ï¼ŒåŒ…å«äº†æœåŠ¡çš„èº«ä»½ä¿¡æ¯ï¼š

| è¯ä¹¦ç±»å‹ | ç”¨é€”è¯´æ˜ | è°æ¥ä½¿ç”¨ |
|---------|---------|---------|
| **æœåŠ¡ç«¯è¯ä¹¦** | è¯æ˜æä¾›è€…èº«ä»½ | æä¾›è€…æŒæœ‰ |
| **å®¢æˆ·ç«¯è¯ä¹¦** | è¯æ˜æ¶ˆè´¹è€…èº«ä»½ï¼ˆåŒå‘è®¤è¯ï¼‰ | æ¶ˆè´¹è€…æŒæœ‰ |
| **CAæ ¹è¯ä¹¦** | éªŒè¯å…¶ä»–è¯ä¹¦çš„æœ‰æ•ˆæ€§ | åŒæ–¹éƒ½éœ€è¦ |

**ğŸ”§ è¯ä¹¦ç”Ÿæˆæ­¥éª¤ï¼ˆä½¿ç”¨OpenSSLï¼‰**

```bash
# 1. ç”Ÿæˆç§é’¥ï¼ˆå°±åƒç”Ÿæˆå¯†ç ï¼‰
openssl genrsa -out server-key.pem 2048

# 2. ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆç”³è¯·èº«ä»½è¯ï¼‰
openssl req -new -key server-key.pem -out server.csr

# 3. è‡ªç­¾åç”Ÿæˆè¯ä¹¦ï¼ˆé¢å‘èº«ä»½è¯ï¼‰
openssl x509 -req -in server.csr -signkey server-key.pem -out server-cert.pem -days 365
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ­£è§„CAæœºæ„é¢å‘çš„è¯ä¹¦ï¼Œè‡ªç­¾åè¯ä¹¦åªé€‚åˆå¼€å‘æµ‹è¯•ã€‚

---

## 3. ğŸ‘¤ æœåŠ¡é‰´æƒæœºåˆ¶è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯æœåŠ¡é‰´æƒ


**ğŸ”¸ é‰´æƒçš„é€šä¿—ç†è§£**

é‰´æƒï¼ˆAuthentication + Authorizationï¼‰åŒ…å«ä¸¤ä¸ªè¿‡ç¨‹ï¼š

```
è®¤è¯ï¼ˆAuthenticationï¼‰- ä½ æ˜¯è°ï¼Ÿ
å°±åƒé—¨ç¦ç³»ç»Ÿè¯†åˆ«ä½ çš„å·¥å¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      åˆ·å¡      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘˜å·¥   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚ é—¨ç¦    â”‚
â”‚  å¼ ä¸‰   â”‚                â”‚ ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                          éªŒè¯èº«ä»½ï¼š
                          è¿™æ˜¯å¼ ä¸‰çš„å¡ âœ“

æˆæƒï¼ˆAuthorizationï¼‰- èƒ½åšä»€ä¹ˆï¼Ÿ
è¯†åˆ«èº«ä»½åï¼Œæ£€æŸ¥æƒé™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¼ ä¸‰   â”‚  æˆ‘è¦è¿›è´¢åŠ¡å®¤  â”‚ æƒé™    â”‚
â”‚(æ™®é€šå‘˜å·¥)â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚ ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
                         æ£€æŸ¥æƒé™ï¼š
                         å¼ ä¸‰ä¸èƒ½è¿›è´¢åŠ¡å®¤ âœ—
```

### 3.2 Tokenè®¤è¯æœºåˆ¶


**ğŸ« Tokenæ˜¯ä»€ä¹ˆ**

Tokenå°±åƒä¸€ä¸ªä¸´æ—¶é€šè¡Œè¯ï¼ŒåŒ…å«äº†ç”¨æˆ·èº«ä»½å’Œæƒé™ä¿¡æ¯ï¼š

```
Tokenè®¤è¯æµç¨‹ï¼š

æ­¥éª¤1ï¼šç™»å½•è·å–Token
ç”¨æˆ·ç™»å½• â†’ éªŒè¯æˆåŠŸ â†’ é¢å‘Token
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Tokenå†…å®¹ï¼š      â”‚
          â”‚ - ç”¨æˆ·ID: 10001  â”‚
          â”‚ - è§’è‰²: admin    â”‚
          â”‚ - è¿‡æœŸæ—¶é—´: 2h   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2ï¼šæºå¸¦Tokenè®¿é—®æœåŠ¡
è¯·æ±‚å¤´ä¸­å¸¦ä¸ŠToken â†’ æœåŠ¡éªŒè¯Token â†’ å…è®¸è®¿é—®
```

**âš™ï¸ åœ¨Dubboä¸­å®ç°Tokenè®¤è¯**

Dubboæä¾›äº†Filteræœºåˆ¶æ¥å®ç°è®¤è¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªè®¤è¯Filterï¼š

```java
// æ¶ˆè´¹è€…ç«¯ï¼šå‘é€Token
@Activate(group = Constants.CONSUMER)
public class TokenConsumerFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // ä»ä¸Šä¸‹æ–‡è·å–Tokenï¼ˆæ¯”å¦‚ä»ThreadLocalï¼‰
        String token = TokenHolder.getToken();
        
        // å°†Tokenæ·»åŠ åˆ°RPCä¸Šä¸‹æ–‡ï¼Œä¼ é€’ç»™æä¾›è€…
        RpcContext.getContext().setAttachment("auth-token", token);
        
        // ç»§ç»­è°ƒç”¨
        return invoker.invoke(invocation);
    }
}
```

```java
// æä¾›è€…ç«¯ï¼šéªŒè¯Token
@Activate(group = Constants.PROVIDER)
public class TokenProviderFilter implements Filter {
    
    @Autowired
    private TokenService tokenService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // ä»RPCä¸Šä¸‹æ–‡è·å–Token
        String token = RpcContext.getContext()
                                 .getAttachment("auth-token");
        
        // éªŒè¯Token
        if (!tokenService.validateToken(token)) {
            throw new RpcException("è®¤è¯å¤±è´¥ï¼šTokenæ— æ•ˆ");
        }
        
        // Tokenæœ‰æ•ˆï¼Œç»§ç»­æ‰§è¡Œ
        return invoker.invoke(invocation);
    }
}
```

### 3.3 JWTè®¤è¯æ–¹æ¡ˆ


**ğŸ” JWTçš„ä¼˜åŠ¿**

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§è‡ªåŒ…å«çš„Tokenï¼Œå°±åƒä¸€ä¸ªåŠ å¯†çš„ä¿¡å°ï¼Œé‡Œé¢è£…ç€ç”¨æˆ·ä¿¡æ¯ï¼š

```
JWTç»“æ„ï¼ˆä¸‰éƒ¨åˆ†ç»„æˆï¼‰ï¼š

Header.Payload.Signature

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤´éƒ¨     â”‚ . â”‚  è½½è·ï¼ˆæ•°æ®ï¼‰â”‚ . â”‚  ç­¾å    â”‚
â”‚ ç®—æ³•ä¿¡æ¯ â”‚   â”‚  ç”¨æˆ·ID      â”‚   â”‚  é˜²ç¯¡æ”¹  â”‚
â”‚          â”‚   â”‚  è§’è‰²æƒé™    â”‚   â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ JWTçš„ç‰¹ç‚¹**

- âœ… **è‡ªåŒ…å«**ï¼šTokenæœ¬èº«åŒ…å«äº†æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼Œä¸éœ€è¦æŸ¥æ•°æ®åº“
- âœ… **é˜²ç¯¡æ”¹**ï¼šæœ‰ç­¾åä¿æŠ¤ï¼Œå†…å®¹è¢«ä¿®æ”¹ä¼šè¢«å‘ç°
- âœ… **è·¨æœåŠ¡**ï¼šå¯ä»¥åœ¨å¤šä¸ªæœåŠ¡é—´å…±äº«ä½¿ç”¨
- âš ï¸ **æ— æ³•æ’¤é”€**ï¼šTokenåœ¨æœ‰æ•ˆæœŸå†…ä¸€ç›´æœ‰æ•ˆï¼ˆå¯ä»¥é…åˆé»‘åå•è§£å†³ï¼‰

---

## 4. ğŸšª è®¿é—®æ§åˆ¶ç­–ç•¥é…ç½®


### 4.1 IPé»‘ç™½åå•æ§åˆ¶


**ğŸ”¸ IPè®¿é—®æ§åˆ¶åŸç†**

IPé»‘ç™½åå•å°±åƒå°åŒºçš„è®¿å®¢ç™»è®°ï¼Œåªå…è®¸ç‰¹å®šçš„äººè¿›å…¥ï¼š

```
ç™½åå•æ¨¡å¼ï¼ˆåªå…è®¸åˆ—è¡¨ä¸­çš„IPï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…è®¸è®¿é—®çš„IPåˆ—è¡¨ï¼š         â”‚
â”‚  192.168.1.100  âœ“           â”‚
â”‚  192.168.1.101  âœ“           â”‚
â”‚  192.168.1.102  âœ“           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å…¶ä»–IPå…¨éƒ¨æ‹’ç»

é»‘åå•æ¨¡å¼ï¼ˆç¦æ­¢åˆ—è¡¨ä¸­çš„IPï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¦æ­¢è®¿é—®çš„IPåˆ—è¡¨ï¼š         â”‚
â”‚  10.0.0.50  âœ—               â”‚
â”‚  10.0.0.51  âœ—               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å…¶ä»–IPå…¨éƒ¨å…è®¸
```

**âš™ï¸ Dubboä¸­é…ç½®IPè®¿é—®æ§åˆ¶**

```yaml
# åœ¨æ³¨å†Œä¸­å¿ƒé…ç½®ç™½åå•ï¼ˆæ¨èï¼‰
dubbo:
  provider:
    # åªå…è®¸è¿™äº›IPè®¿é—®
    accesslog: true
    filter: -default,ipWhiteList
  
  # è‡ªå®šä¹‰å‚æ•°
  parameters:
    # ç™½åå•IPåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰
    ip.whitelist: 192.168.1.100,192.168.1.101,192.168.1.0/24
```

**ğŸ”§ è‡ªå®šä¹‰IPè¿‡æ»¤å™¨å®ç°**

```java
@Activate(group = Constants.PROVIDER)
public class IpWhiteListFilter implements Filter {
    
    // ç™½åå•IPåˆ—è¡¨ï¼ˆå¯ä»¥ä»é…ç½®ä¸­å¿ƒåŠ¨æ€åŠ è½½ï¼‰
    private Set<String> whiteList = new HashSet<>(Arrays.asList(
        "192.168.1.100",
        "192.168.1.101"
    ));
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // è·å–è°ƒç”¨æ–¹IP
        String clientIp = RpcContext.getContext().getRemoteHost();
        
        // æ£€æŸ¥ç™½åå•
        if (!whiteList.contains(clientIp)) {
            throw new RpcException("è®¿é—®è¢«æ‹’ç»ï¼šIP " + clientIp + " ä¸åœ¨ç™½åå•ä¸­");
        }
        
        return invoker.invoke(invocation);
    }
}
```

### 4.2 åº”ç”¨çº§è®¿é—®æ§åˆ¶


**ğŸ¯ æŒ‰åº”ç”¨åç§°æ§åˆ¶è®¿é—®**

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ§åˆ¶å“ªäº›åº”ç”¨å¯ä»¥è°ƒç”¨æœåŠ¡ï¼Œè€Œä¸æ˜¯ç®€å•çš„IPæ§åˆ¶ï¼š

```
åº”ç”¨è®¿é—®æ§åˆ¶ç¤ºæ„ï¼š

å…è®¸çš„åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡   â”‚   â”‚  ç”¨æˆ·æœåŠ¡   â”‚
â”‚ order-app   â”‚   â”‚ user-app    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                 â†“
    âœ“ å…è®¸è®¿é—®     âœ“ å…è®¸è®¿é—®

ç¦æ­¢çš„åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•æœåŠ¡   â”‚
â”‚ test-app    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
    âœ— æ‹’ç»è®¿é—®
```

**âš™ï¸ é…ç½®åº”ç”¨è®¿é—®æ§åˆ¶**

```java
@Service(version = "1.0.0")
// ä½¿ç”¨å‚æ•°æ§åˆ¶è®¿é—®
@Parameter(key = "allowed.applications", value = "order-app,user-app")
public class PaymentServiceImpl implements PaymentService {
    // æœåŠ¡å®ç°
}
```

```java
// åº”ç”¨è®¿é—®æ§åˆ¶Filter
@Activate(group = Constants.PROVIDER)
public class ApplicationAccessFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // è·å–è°ƒç”¨æ–¹åº”ç”¨å
        String application = RpcContext.getContext()
                                       .getUrl()
                                       .getParameter("application");
        
        // ä»æœåŠ¡é…ç½®ä¸­è·å–å…è®¸çš„åº”ç”¨åˆ—è¡¨
        String allowedApps = invoker.getUrl()
                                    .getParameter("allowed.applications");
        
        if (allowedApps != null) {
            Set<String> allowed = new HashSet<>(
                Arrays.asList(allowedApps.split(","))
            );
            
            if (!allowed.contains(application)) {
                throw new RpcException(
                    "è®¿é—®è¢«æ‹’ç»ï¼šåº”ç”¨ " + application + " æ— æƒè®¿é—®æ­¤æœåŠ¡"
                );
            }
        }
        
        return invoker.invoke(invocation);
    }
}
```

---

## 5. ğŸ”‘ æ¥å£æƒé™ç®¡ç†å®ç°


### 5.1 åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼ˆRBACï¼‰


**ğŸ”¸ RBACæ¨¡å‹ç†è§£**

RBACå°±åƒå…¬å¸çš„æƒé™ä½“ç³»ï¼Œä¸åŒè§’è‰²æœ‰ä¸åŒçš„æƒé™ï¼š

```
è§’è‰²-æƒé™å…³ç³»å›¾ï¼š

è§’è‰²å±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†å‘˜ â”‚  â”‚  è´¢åŠ¡   â”‚  â”‚  æ™®é€šå‘˜å·¥â”‚
â”‚  Admin  â”‚  â”‚ Finance â”‚  â”‚  User   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚
     â†“            â†“            â†“
æƒé™å±‚ï¼š
å…¨éƒ¨æƒé™      æŸ¥çœ‹/å®¡æ‰¹      åªèƒ½æŸ¥çœ‹
  âœ“ å¢           âœ— å¢          âœ— å¢
  âœ“ åˆ            âœ— åˆ           âœ— åˆ 
  âœ“ æ”¹           âœ“ æ”¹          âœ— æ”¹
  âœ“ æŸ¥           âœ“ æŸ¥          âœ“ æŸ¥
```

**ğŸ’¡ åœ¨Dubboä¸­å®ç°RBAC**

å®šä¹‰æƒé™æ³¨è§£ï¼š

```java
// å®šä¹‰æ–¹æ³•çº§æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String[] value();  // éœ€è¦çš„æƒé™
}

// å®šä¹‰è§’è‰²çº§æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    String[] value();  // éœ€è¦çš„è§’è‰²
}
```

åœ¨æœåŠ¡æ–¹æ³•ä¸Šä½¿ç”¨ï¼š

```java
@Service
public class OrderServiceImpl implements OrderService {
    
    // åªæœ‰ç®¡ç†å‘˜å’Œè´¢åŠ¡å¯ä»¥æ‰§è¡Œ
    @RequireRole({"admin", "finance"})
    public void deleteOrder(Long orderId) {
        // åˆ é™¤è®¢å•
    }
    
    // éœ€è¦ç‰¹å®šæƒé™
    @RequirePermission({"order:read", "order:write"})
    public void updateOrder(Order order) {
        // æ›´æ–°è®¢å•
    }
}
```

### 5.2 æƒé™éªŒè¯Filter


**ğŸ”§ å®ç°æƒé™æ£€æŸ¥é€»è¾‘**

```java
@Activate(group = Constants.PROVIDER, order = -1000)
public class PermissionFilter implements Filter {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆä»Tokenä¸­è§£æï¼‰
        String userId = RpcContext.getContext()
                                  .getAttachment("user-id");
        
        // è·å–è¦è°ƒç”¨çš„æ–¹æ³•
        Method method = invocation.getMethodObject();
        
        // æ£€æŸ¥è§’è‰²æƒé™
        if (method.isAnnotationPresent(RequireRole.class)) {
            RequireRole roleAnno = method.getAnnotation(RequireRole.class);
            String[] requiredRoles = roleAnno.value();
            
            if (!permissionService.hasAnyRole(userId, requiredRoles)) {
                throw new RpcException(
                    "æƒé™ä¸è¶³ï¼šéœ€è¦è§’è‰² " + Arrays.toString(requiredRoles)
                );
            }
        }
        
        // æ£€æŸ¥æ“ä½œæƒé™
        if (method.isAnnotationPresent(RequirePermission.class)) {
            RequirePermission permAnno = method.getAnnotation(RequirePermission.class);
            String[] requiredPerms = permAnno.value();
            
            if (!permissionService.hasAllPermissions(userId, requiredPerms)) {
                throw new RpcException(
                    "æƒé™ä¸è¶³ï¼šéœ€è¦æƒé™ " + Arrays.toString(requiredPerms)
                );
            }
        }
        
        return invoker.invoke(invocation);
    }
}
```

### 5.3 åŠ¨æ€æƒé™é…ç½®


**ğŸ“Š æƒé™é…ç½®ç®¡ç†**

æƒé™é…ç½®æœ€å¥½èƒ½åŠ¨æ€è°ƒæ•´ï¼Œä¸éœ€è¦é‡å¯æœåŠ¡ï¼š

```yaml
# å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒçš„æƒé™é…ç½®
permissions:
  # è§’è‰²å®šä¹‰
  roles:
    admin:
      - order:*      # è®¢å•æ‰€æœ‰æƒé™
      - user:*       # ç”¨æˆ·æ‰€æœ‰æƒé™
      - payment:*    # æ”¯ä»˜æ‰€æœ‰æƒé™
    
    finance:
      - order:read
      - order:audit  # è®¢å•å®¡æ ¸
      - payment:read
      - payment:refund
    
    user:
      - order:read   # åªèƒ½æŸ¥çœ‹è®¢å•
      - user:read    # åªèƒ½æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
  
  # ç”¨æˆ·è§’è‰²åˆ†é…
  user-roles:
    user-10001: [admin]
    user-10002: [finance]
    user-10003: [user]
```

---

## 6. ğŸ” æ•°æ®åŠ å¯†ä¼ è¾“æ–¹æ¡ˆ


### 6.1 æ•æ„Ÿæ•°æ®åŠ å¯†


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦åŠ å¯†æ•æ„Ÿæ•°æ®**

å³ä½¿ä½¿ç”¨äº†TLSåŠ å¯†é€šä¿¡ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹ä»éœ€è¦å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œé¢å¤–åŠ å¯†ï¼š

```
æ•°æ®åŠ å¯†çš„ä¸‰ä¸ªå±‚æ¬¡ï¼š

ä¼ è¾“å±‚åŠ å¯†ï¼ˆTLSï¼‰ï¼š
ä¿æŠ¤æ•°æ®åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«çªƒå¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  [åŠ å¯†é€šé“]  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¶ˆè´¹è€…  â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ æä¾›è€…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨å±‚åŠ å¯†ï¼š
å¯¹æ•æ„Ÿå­—æ®µè¿›è¡ŒåŠ å¯†å­˜å‚¨å’Œä¼ è¾“
åŸå§‹æ•°æ®ï¼š{"password": "123456"}
åŠ å¯†åï¼š  {"password": "AES256(...)"}

ç«¯åˆ°ç«¯åŠ å¯†ï¼š
æ•°æ®ä»äº§ç”Ÿåˆ°ä½¿ç”¨å…¨ç¨‹åŠ å¯†
åªæœ‰çœŸæ­£éœ€è¦ä½¿ç”¨çš„åœ°æ–¹æ‰è§£å¯†
```

**ğŸ’¡ æ•æ„Ÿå­—æ®µåŠ å¯†å®è·µ**

```java
// å®šä¹‰åŠ å¯†æ³¨è§£
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Encrypted {
    String algorithm() default "AES";  // åŠ å¯†ç®—æ³•
}

// ä½¿ç”¨åŠ å¯†æ³¨è§£
public class UserDTO {
    private Long id;
    private String username;
    
    @Encrypted  // æ ‡è®°éœ€è¦åŠ å¯†çš„å­—æ®µ
    private String password;
    
    @Encrypted
    private String idCard;    // èº«ä»½è¯å·
    
    @Encrypted  
    private String bankCard;  // é“¶è¡Œå¡å·
}
```

### 6.2 åŠ å¯†Filterå®ç°


**ğŸ”§ è‡ªåŠ¨åŠ å¯†è§£å¯†å¤„ç†**

```java
@Activate(group = {Constants.PROVIDER, Constants.CONSUMER})
public class EncryptionFilter implements Filter {
    
    @Autowired
    private EncryptionService encryptionService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // æ¶ˆè´¹è€…ç«¯ï¼šåŠ å¯†è¯·æ±‚å‚æ•°
        if (RpcContext.getContext().isConsumerSide()) {
            Object[] args = invocation.getArguments();
            for (int i = 0; i < args.length; i++) {
                args[i] = encryptFields(args[i]);
            }
        }
        
        Result result = invoker.invoke(invocation);
        
        // æä¾›è€…ç«¯ï¼šè§£å¯†å“åº”æ•°æ®
        if (RpcContext.getContext().isProviderSide()) {
            Object value = result.getValue();
            result.setValue(decryptFields(value));
        }
        
        return result;
    }
    
    // åŠ å¯†å¯¹è±¡ä¸­çš„æ•æ„Ÿå­—æ®µ
    private Object encryptFields(Object obj) {
        if (obj == null) return null;
        
        Class<?> clazz = obj.getClass();
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(Encrypted.class)) {
                field.setAccessible(true);
                try {
                    String value = (String) field.get(obj);
                    if (value != null) {
                        // åŠ å¯†å­—æ®µå€¼
                        String encrypted = encryptionService.encrypt(value);
                        field.set(obj, encrypted);
                    }
                } catch (Exception e) {
                    // å¤„ç†å¼‚å¸¸
                }
            }
        }
        return obj;
    }
}
```

### 6.3 å›½å¯†ç®—æ³•æ”¯æŒ


**ğŸ‡¨ğŸ‡³ å›½äº§å¯†ç ç®—æ³•**

åœ¨æŸäº›è¡Œä¸šï¼ˆå¦‚é‡‘èã€æ”¿åŠ¡ï¼‰éœ€è¦ä½¿ç”¨å›½å¯†ç®—æ³•ï¼ˆSM2/SM3/SM4ï¼‰ï¼š

```
å¸¸ç”¨å›½å¯†ç®—æ³•å¯¹æ¯”ï¼š

ç®—æ³•ç±»å‹    å›½å¯†ç®—æ³•    å›½é™…ç®—æ³•      ç”¨é€”
éå¯¹ç§°åŠ å¯†   SM2        RSA          æ•°å­—ç­¾åã€å¯†é’¥äº¤æ¢
æ‘˜è¦ç®—æ³•     SM3        SHA-256      æ•°æ®å®Œæ•´æ€§æ ¡éªŒ
å¯¹ç§°åŠ å¯†     SM4        AES          æ•°æ®åŠ å¯†ä¼ è¾“
```

**âš™ï¸ é›†æˆå›½å¯†ç®—æ³•**

```xml
<!-- å¼•å…¥å›½å¯†ç®—æ³•åº“ -->
<dependency>
    <groupId>org.bouncycastle</groupId>
    <artifactId>bcprov-jdk15on</artifactId>
    <version>1.70</version>
</dependency>
```

```java
// å›½å¯†åŠ å¯†æœåŠ¡
@Service
public class SM4EncryptionService {
    
    private static final String ALGORITHM = "SM4/ECB/PKCS5Padding";
    
    public String encrypt(String data, String key) {
        // SM4åŠ å¯†å®ç°
        Cipher cipher = Cipher.getInstance(ALGORITHM, "BC");
        cipher.init(Cipher.ENCRYPT_MODE, new SecretKeySpec(key.getBytes(), "SM4"));
        byte[] encrypted = cipher.doFinal(data.getBytes());
        return Base64.getEncoder().encodeToString(encrypted);
    }
    
    public String decrypt(String encryptedData, String key) {
        // SM4è§£å¯†å®ç°
        Cipher cipher = Cipher.getInstance(ALGORITHM, "BC");
        cipher.init(Cipher.DECRYPT_MODE, new SecretKeySpec(key.getBytes(), "SM4"));
        byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(encryptedData));
        return new String(decrypted);
    }
}
```

---

## 7. ğŸ“ å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ


### 7.1 å®¡è®¡æ—¥å¿—çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—**

å®¡è®¡æ—¥å¿—å°±åƒç›‘æ§å½•åƒï¼Œè®°å½•æ‰€æœ‰é‡è¦æ“ä½œï¼Œç”¨äºï¼š

```
å®¡è®¡æ—¥å¿—çš„å››å¤§ä½œç”¨ï¼š

1. é—®é¢˜è¿½æº¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å‡ºç°é—®é¢˜æ—¶ï¼Œé€šè¿‡æ—¥å¿— â”‚
   â”‚ å¯ä»¥å›æº¯æ“ä½œé“¾è·¯     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
   å®šä½é—®é¢˜æ ¹æº

2. å®‰å…¨åˆ†æ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åˆ†æè®¿é—®æ¨¡å¼ï¼Œå‘ç°   â”‚
   â”‚ å¼‚å¸¸è¡Œä¸ºå’Œæ”»å‡»ä¼å›¾   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
   åŠæ—¶å‘ç°å®‰å…¨å¨èƒ

3. åˆè§„è¦æ±‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æ»¡è¶³æ³•è§„è¦æ±‚ï¼Œå¦‚     â”‚
   â”‚ ç­‰ä¿ã€PCI-DSSç­‰      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. æ€§èƒ½åˆ†æ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åˆ†ææ¥å£è°ƒç”¨æƒ…å†µ     â”‚
   â”‚ ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å®¡è®¡æ—¥å¿—è®°å½•å†…å®¹


**ğŸ“‹ å…³é”®å®¡è®¡ä¿¡æ¯**

ä¸€æ¡å®Œæ•´çš„å®¡è®¡æ—¥å¿—åº”è¯¥åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

| ä¿¡æ¯ç±»åˆ« | è®°å½•å†…å®¹ | ç”¨é€”è¯´æ˜ |
|---------|---------|---------|
| **è°** | ç”¨æˆ·IDã€åº”ç”¨åã€IPåœ°å€ | ç¡®å®šæ“ä½œä¸»ä½“ |
| **ä»€ä¹ˆæ—¶å€™** | æ—¶é—´æˆ³ã€è¯·æ±‚ID | ç¡®å®šæ“ä½œæ—¶é—´ |
| **åšäº†ä»€ä¹ˆ** | æ¥å£åã€æ–¹æ³•åã€æ“ä½œç±»å‹ | ç¡®å®šæ“ä½œå†…å®¹ |
| **ç»“æœå¦‚ä½•** | æˆåŠŸ/å¤±è´¥ã€é”™è¯¯ä¿¡æ¯ | ç¡®å®šæ“ä½œç»“æœ |
| **è¯¦ç»†ä¿¡æ¯** | è¯·æ±‚å‚æ•°ã€å“åº”æ•°æ® | é—®é¢˜åˆ†æä¾æ® |

### 7.3 å®¡è®¡æ—¥å¿—Filterå®ç°


**ğŸ”§ è®°å½•å®¡è®¡æ—¥å¿—**

```java
@Activate(group = {Constants.PROVIDER, Constants.CONSUMER})
public class AuditLogFilter implements Filter {
    
    @Autowired
    private AuditLogService auditLogService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        AuditLog auditLog = new AuditLog();
        long startTime = System.currentTimeMillis();
        
        try {
            // è®°å½•è¯·æ±‚ä¿¡æ¯
            auditLog.setRequestId(RpcContext.getContext().getRequestId());
            auditLog.setUserId(RpcContext.getContext().getAttachment("user-id"));
            auditLog.setApplication(RpcContext.getContext().getUrl()
                                              .getParameter("application"));
            auditLog.setClientIp(RpcContext.getContext().getRemoteHost());
            auditLog.setServiceName(invoker.getInterface().getName());
            auditLog.setMethodName(invocation.getMethodName());
            auditLog.setStartTime(new Date(startTime));
            
            // è®°å½•è¯·æ±‚å‚æ•°ï¼ˆæ•æ„Ÿä¿¡æ¯éœ€è„±æ•ï¼‰
            Object[] args = invocation.getArguments();
            auditLog.setRequestParams(maskSensitiveData(args));
            
            // æ‰§è¡Œè°ƒç”¨
            Result result = invoker.invoke(invocation);
            
            // è®°å½•å“åº”ä¿¡æ¯
            auditLog.setSuccess(true);
            auditLog.setResponseData(maskSensitiveData(result.getValue()));
            
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥ä¿¡æ¯
            auditLog.setSuccess(false);
            auditLog.setErrorMessage(e.getMessage());
            throw e;
            
        } finally {
            // è®°å½•è€—æ—¶
            auditLog.setDuration(System.currentTimeMillis() - startTime);
            
            // å¼‚æ­¥ä¿å­˜å®¡è®¡æ—¥å¿—
            auditLogService.saveAsync(auditLog);
        }
    }
    
    // æ•æ„Ÿæ•°æ®è„±æ•
    private String maskSensitiveData(Object data) {
        // è„±æ•å¤„ç†ï¼šå¯†ç ã€èº«ä»½è¯ã€é“¶è¡Œå¡ç­‰
        // ä¾‹å¦‚ï¼š13800138000 -> 138****8000
        return SensitiveDataMasker.mask(data);
    }
}
```

### 7.4 å®¡è®¡æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ


**ğŸ” æ—¥å¿—æŸ¥è¯¢ç³»ç»Ÿ**

å»ºç«‹å®¡è®¡æ—¥å¿—æŸ¥è¯¢ç³»ç»Ÿï¼Œä¾¿äºé—®é¢˜æ’æŸ¥ï¼š

```java
// å®¡è®¡æ—¥å¿—æŸ¥è¯¢æ¡ä»¶
public class AuditLogQuery {
    private String userId;         // ç”¨æˆ·ID
    private String application;    // åº”ç”¨å
    private String serviceName;    // æœåŠ¡å
    private String methodName;     // æ–¹æ³•å
    private Date startTime;        // å¼€å§‹æ—¶é—´
    private Date endTime;          // ç»“æŸæ—¶é—´
    private Boolean success;       // æ˜¯å¦æˆåŠŸ
    private String clientIp;       // å®¢æˆ·ç«¯IP
}

// æŸ¥è¯¢æ¥å£
@RestController
@RequestMapping("/audit-log")
public class AuditLogController {
    
    @Autowired
    private AuditLogService auditLogService;
    
    @PostMapping("/query")
    public PageResult<AuditLog> query(@RequestBody AuditLogQuery query) {
        // åˆ†é¡µæŸ¥è¯¢å®¡è®¡æ—¥å¿—
        return auditLogService.query(query);
    }
    
    @GetMapping("/export")
    public void export(@RequestParam("requestId") String requestId) {
        // å¯¼å‡ºç‰¹å®šè¯·æ±‚çš„å®Œæ•´è°ƒç”¨é“¾è·¯
        auditLogService.exportCallChain(requestId);
    }
}
```

---

## 8. ğŸ›¡ï¸ é˜²æŠ¤æ”»å‡»ç­–ç•¥å®è·µ


### 8.1 é™æµé˜²æŠ¤


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦é™æµ**

é™æµå°±åƒé«˜é€Ÿå…¬è·¯çš„é™é€Ÿï¼Œé˜²æ­¢æµé‡è¿‡å¤§å¯¼è‡´ç³»ç»Ÿå´©æºƒï¼š

```
æ— é™æµçš„é—®é¢˜ï¼š
æ­£å¸¸æµé‡ï¼š100 QPS â”€â”€â”€â”€â†’ ç³»ç»Ÿæ­£å¸¸ âœ“
çªå‘æµé‡ï¼š10000 QPS â”€â”€â†’ ç³»ç»Ÿå´©æºƒ âœ—

æœ‰é™æµçš„ä¿æŠ¤ï¼š
æ­£å¸¸æµé‡ï¼š100 QPS â”€â”€â”€â”€â†’ å…¨éƒ¨é€šè¿‡ âœ“
çªå‘æµé‡ï¼š10000 QPS â”€â”€â†’ é™åˆ¶åˆ°500 QPS
                       è¶…å‡ºéƒ¨åˆ†å¿«é€Ÿå¤±è´¥
                       ä¿æŠ¤ç³»ç»Ÿç¨³å®šè¿è¡Œ
```

**âš™ï¸ Dubboé™æµé…ç½®**

```yaml
# æœåŠ¡æä¾›è€…é™æµé…ç½®
dubbo:
  provider:
    # æ¯ç§’æœ€å¤šæ¥å—100ä¸ªè¯·æ±‚
    executes: 100
    # å•ä¸ªæ–¹æ³•é™æµ
    methods:
      getUserInfo:
        executes: 50      # è¯¥æ–¹æ³•é™æµ50
      updateUser:
        executes: 20      # æ›´æ–°æ“ä½œé™æµæ›´ä¸¥æ ¼
```

**ğŸ”§ è‡ªå®šä¹‰é™æµå™¨**

```java
// ä½¿ç”¨Guavaçš„RateLimiterå®ç°é™æµ
@Activate(group = Constants.PROVIDER)
public class RateLimitFilter implements Filter {
    
    // ä¸ºæ¯ä¸ªæœåŠ¡æ–¹æ³•åˆ›å»ºé™æµå™¨
    private final Map<String, RateLimiter> limiters = new ConcurrentHashMap<>();
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        String key = invoker.getInterface().getName() + "." 
                   + invocation.getMethodName();
        
        // è·å–æˆ–åˆ›å»ºé™æµå™¨ï¼ˆæ¯ç§’100ä¸ªä»¤ç‰Œï¼‰
        RateLimiter limiter = limiters.computeIfAbsent(key, 
            k -> RateLimiter.create(100.0));
        
        // å°è¯•è·å–ä»¤ç‰Œ
        if (!limiter.tryAcquire()) {
            throw new RpcException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        return invoker.invoke(invocation);
    }
}
```

### 8.2 é˜²é‡æ”¾æ”»å‡»


**ğŸ”¸ ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»**

é‡æ”¾æ”»å‡»å°±åƒæœ‰äººå½•ä¸‹ä½ è¯´çš„è¯ï¼Œç„¶ååå¤æ’­æ”¾æ¬ºéª—ç³»ç»Ÿï¼š

```
é‡æ”¾æ”»å‡»ç¤ºæ„ï¼š

æ­£å¸¸è¯·æ±‚ï¼š
ç”¨æˆ· â†’ æ”¯ä»˜100å…ƒ â†’ ç³»ç»Ÿå¤„ç† â†’ æ‰£æ¬¾æˆåŠŸ

é‡æ”¾æ”»å‡»ï¼š
æ”»å‡»è€…æˆªè·è¯·æ±‚ â†’ é‡å¤å‘é€10æ¬¡
â†’ ç³»ç»Ÿå¤„ç†10æ¬¡ â†’ æ‰£æ¬¾10æ¬¡ï¼
```

**ğŸ›¡ï¸ é˜²é‡æ”¾ç­–ç•¥**

```java
@Activate(group = Constants.PROVIDER)
public class AntiReplayFilter implements Filter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        // è¦æ±‚å®¢æˆ·ç«¯ä¼ é€’nonceï¼ˆéšæœºæ•°ï¼‰å’Œtimestampï¼ˆæ—¶é—´æˆ³ï¼‰
        String nonce = RpcContext.getContext().getAttachment("nonce");
        String timestamp = RpcContext.getContext().getAttachment("timestamp");
        
        // æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆè¶…è¿‡5åˆ†é’Ÿçš„è¯·æ±‚æ‹’ç»ï¼‰
        long requestTime = Long.parseLong(timestamp);
        if (System.currentTimeMillis() - requestTime > 5 * 60 * 1000) {
            throw new RpcException("è¯·æ±‚å·²è¿‡æœŸ");
        }
        
        // æ£€æŸ¥nonceæ˜¯å¦å·²ä½¿ç”¨ï¼ˆä½¿ç”¨Rediså­˜å‚¨ï¼‰
        String nonceKey = "nonce:" + nonce;
        Boolean isNew = redisTemplate.opsForValue()
                                     .setIfAbsent(nonceKey, "1", 5, TimeUnit.MINUTES);
        
        if (Boolean.FALSE.equals(isNew)) {
            throw new RpcException("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»");
        }
        
        return invoker.invoke(invocation);
    }
}
```

### 8.3 é˜²SQLæ³¨å…¥å’ŒXSS


**âš ï¸ å‚æ•°æ ¡éªŒå’Œè¿‡æ»¤**

è™½ç„¶Dubboæ˜¯RPCæ¡†æ¶ï¼Œä½†ä»éœ€é˜²æ­¢æ¶æ„å‚æ•°ï¼š

```java
@Activate(group = Constants.PROVIDER, order = -2000)
public class SecurityValidationFilter implements Filter {
    
    // SQLæ³¨å…¥å…³é”®å­—
    private static final String[] SQL_KEYWORDS = {
        "select", "insert", "update", "delete", "drop", 
        "truncate", "exec", "script", "union"
    };
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        Object[] args = invocation.getArguments();
        
        for (Object arg : args) {
            if (arg instanceof String) {
                String param = (String) arg;
                
                // æ£€æŸ¥SQLæ³¨å…¥
                for (String keyword : SQL_KEYWORDS) {
                    if (param.toLowerCase().contains(keyword)) {
                        throw new RpcException("å‚æ•°åŒ…å«éæ³•å­—ç¬¦");
                    }
                }
                
                // æ£€æŸ¥XSSæ”»å‡»
                if (param.contains("<script>") || param.contains("javascript:")) {
                    throw new RpcException("å‚æ•°åŒ…å«éæ³•è„šæœ¬");
                }
            }
        }
        
        return invoker.invoke(invocation);
    }
}
```

---

## 9. ğŸ”— èº«ä»½è®¤è¯é›†æˆæ–¹æ¡ˆ


### 9.1 OAuth 2.0é›†æˆ


**ğŸ”¸ OAuth 2.0æµç¨‹ç†è§£**

OAuth 2.0å°±åƒä¸€ä¸ªæˆæƒä¸­ä»‹ï¼Œè®©ç¬¬ä¸‰æ–¹åº”ç”¨èƒ½å®‰å…¨åœ°è®¿é—®ç”¨æˆ·èµ„æºï¼š

```
OAuth 2.0æˆæƒæµç¨‹ï¼ˆæˆæƒç æ¨¡å¼ï¼‰ï¼š

æ­¥éª¤1ï¼šç”¨æˆ·è®¿é—®
å®¢æˆ·ç«¯ â†’ é‡å®šå‘åˆ°è®¤è¯æœåŠ¡å™¨ â†’ ç”¨æˆ·ç™»å½•æˆæƒ

æ­¥éª¤2ï¼šè·å–æˆæƒç 
è®¤è¯æœåŠ¡å™¨ â†’ è¿”å›æˆæƒç  â†’ å®¢æˆ·ç«¯

æ­¥éª¤3ï¼šæ¢å–Token
å®¢æˆ·ç«¯ + æˆæƒç  â†’ è®¤è¯æœåŠ¡å™¨ â†’ è¿”å›Access Token

æ­¥éª¤4ï¼šè®¿é—®èµ„æº
å®¢æˆ·ç«¯ + Access Token â†’ èµ„æºæœåŠ¡å™¨ â†’ è¿”å›æ•°æ®
```

**âš™ï¸ åœ¨Dubboä¸­ä½¿ç”¨OAuth Token**

```java
// OAuth TokenéªŒè¯Filter
@Activate(group = Constants.PROVIDER)
public class OAuth2Filter implements Filter {
    
    @Autowired
    private OAuth2TokenService tokenService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        String accessToken = RpcContext.getContext()
                                       .getAttachment("access-token");
        
        // éªŒè¯Token
        OAuth2Authentication auth = tokenService.validateToken(accessToken);
        if (auth == null) {
            throw new RpcException("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ä¸Šä¸‹æ–‡
        RpcContext.getContext().setAttachment("user-id", auth.getUserId());
        RpcContext.getContext().setAttachment("roles", auth.getRoles());
        
        return invoker.invoke(invocation);
    }
}
```

### 9.2 å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰é›†æˆ


**ğŸ”¸ SSOåŸç†**

SSOï¼ˆSingle Sign-Onï¼‰è®©ç”¨æˆ·ä¸€æ¬¡ç™»å½•ï¼Œè®¿é—®å¤šä¸ªç³»ç»Ÿï¼š

```
SSOå·¥ä½œæµç¨‹ï¼š

1. ç”¨æˆ·é¦–æ¬¡è®¿é—®ç³»ç»ŸA
   â†’ é‡å®šå‘åˆ°SSOè®¤è¯ä¸­å¿ƒ
   â†’ ç”¨æˆ·ç™»å½•
   â†’ SSOé¢å‘å…¨å±€Session

2. ç”¨æˆ·è®¿é—®ç³»ç»ŸB
   â†’ æ£€æµ‹åˆ°SSO Session
   â†’ è‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€å†æ¬¡è¾“å…¥å¯†ç 

3. ç”¨æˆ·é€€å‡º
   â†’ åœ¨ä»»ä¸€ç³»ç»Ÿé€€å‡º
   â†’ SSOæ¸…é™¤å…¨å±€Session
   â†’ æ‰€æœ‰ç³»ç»Ÿéƒ½è‡ªåŠ¨é€€å‡º
```

**âš™ï¸ Dubboé›†æˆCAS/Keycloak**

```yaml
# é›†æˆKeycloaké…ç½®
dubbo:
  provider:
    filter: keycloakAuth
  
keycloak:
  realm: dubbo-services
  auth-server-url: http://localhost:8080/auth
  resource: dubbo-provider
  credentials:
    secret: your-client-secret
```

```java
// Keycloakè®¤è¯Filter
@Activate(group = Constants.PROVIDER)
public class KeycloakAuthFilter implements Filter {
    
    @Autowired
    private KeycloakService keycloakService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        String token = RpcContext.getContext().getAttachment("bearer-token");
        
        // éªŒè¯Keycloak Token
        AccessToken accessToken = keycloakService.verifyToken(token);
        if (accessToken == null) {
            throw new RpcException("è®¤è¯å¤±è´¥");
        }
        
        // æå–ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
        String userId = accessToken.getSubject();
        Set<String> roles = accessToken.getRealmAccess().getRoles();
        
        // å­˜å…¥ä¸Šä¸‹æ–‡ä¾›åç»­ä½¿ç”¨
        RpcContext.getContext().setAttachment("user-id", userId);
        RpcContext.getContext().setAttachment("user-roles", 
                                             String.join(",", roles));
        
        return invoker.invoke(invocation);
    }
}
```

### 9.3 APIå¯†é’¥è®¤è¯


**ğŸ”‘ ç®€å•çš„API Keyæ–¹å¼**

å¯¹äºæœåŠ¡é—´è°ƒç”¨ï¼Œå¯ä»¥ä½¿ç”¨ç®€å•çš„API Keyè®¤è¯ï¼š

```java
// API Keyè®¤è¯
@Activate(group = Constants.PROVIDER)
public class ApiKeyFilter implements Filter {
    
    @Autowired
    private ApiKeyService apiKeyService;
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) {
        String apiKey = RpcContext.getContext().getAttachment("api-key");
        String apiSecret = RpcContext.getContext().getAttachment("api-secret");
        
        // éªŒè¯API Key
        if (!apiKeyService.validate(apiKey, apiSecret)) {
            throw new RpcException("APIè®¤è¯å¤±è´¥");
        }
        
        // è·å–API Keyå…³è”çš„åº”ç”¨ä¿¡æ¯
        ApiKeyInfo keyInfo = apiKeyService.getKeyInfo(apiKey);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æƒè®¿é—®è¯¥æœåŠ¡
        String serviceName = invoker.getInterface().getName();
        if (!keyInfo.hasServiceAccess(serviceName)) {
            throw new RpcException("æ— æƒè®¿é—®è¯¥æœåŠ¡");
        }
        
        return invoker.invoke(invocation);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å®‰å…¨é˜²æŠ¤ä½“ç³»æ¶æ„


```
Dubboå®‰å…¨é˜²æŠ¤çš„å¤šå±‚æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬ä¸€å±‚ï¼šç½‘ç»œå®‰å…¨               â”‚
â”‚  â€¢ TLS/SSLåŠ å¯†ä¼ è¾“                      â”‚
â”‚  â€¢ è¯ä¹¦åŒå‘è®¤è¯                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬äºŒå±‚ï¼šèº«ä»½è®¤è¯               â”‚
â”‚  â€¢ Tokenè®¤è¯                            â”‚
â”‚  â€¢ OAuth 2.0                            â”‚
â”‚  â€¢ SSOå•ç‚¹ç™»å½•                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬ä¸‰å±‚ï¼šè®¿é—®æ§åˆ¶               â”‚
â”‚  â€¢ IPé»‘ç™½åå•                           â”‚
â”‚  â€¢ åº”ç”¨çº§æ§åˆ¶                           â”‚
â”‚  â€¢ æ¥å£æƒé™ç®¡ç†                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬å››å±‚ï¼šæ•°æ®å®‰å…¨               â”‚
â”‚  â€¢ æ•æ„Ÿæ•°æ®åŠ å¯†                         â”‚
â”‚  â€¢ ä¼ è¾“æ•°æ®ç­¾å                         â”‚
â”‚  â€¢ é˜²ç¯¡æ”¹ä¿æŠ¤                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬äº”å±‚ï¼šæ”»å‡»é˜²æŠ¤               â”‚
â”‚  â€¢ é™æµä¿æŠ¤                             â”‚
â”‚  â€¢ é˜²é‡æ”¾æ”»å‡»                           â”‚
â”‚  â€¢ å‚æ•°æ ¡éªŒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¬¬å…­å±‚ï¼šå®¡è®¡ç›‘æ§               â”‚
â”‚  â€¢ æ“ä½œæ—¥å¿—è®°å½•                         â”‚
â”‚  â€¢ å®‰å…¨äº‹ä»¶å‘Šè­¦                         â”‚
â”‚  â€¢ è¡Œä¸ºåˆ†æ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 å…³é”®æŠ€æœ¯é€‰å‹å»ºè®®


| å®‰å…¨éœ€æ±‚ | æ¨èæ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| **åŸºç¡€é€šä¿¡åŠ å¯†** | TLS 1.2+ | æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒå¿…å¤‡ |
| **æœåŠ¡é—´è®¤è¯** | JWT Token | è½»é‡çº§è®¤è¯éœ€æ±‚ |
| **ä¼ä¸šçº§è®¤è¯** | OAuth 2.0 + SSO | å¤§å‹ä¼ä¸šï¼Œå¤šç³»ç»Ÿé›†æˆ |
| **æ•°æ®åŠ å¯†** | AES-256 | æ•æ„Ÿæ•°æ®ä¼ è¾“ |
| **å›½å¯†è¦æ±‚** | SM2/SM3/SM4 | é‡‘èã€æ”¿åŠ¡è¡Œä¸š |
| **è®¿é—®æ§åˆ¶** | RBAC + IPç™½åå• | ç²¾ç»†åŒ–æƒé™ç®¡ç† |
| **æ”»å‡»é˜²æŠ¤** | é™æµ + é˜²é‡æ”¾ | é«˜å¹¶å‘ç³»ç»Ÿ |

### 10.3 æœ€ä½³å®è·µæ¸…å•


**âœ… ç”Ÿäº§ç¯å¢ƒå¿…åšé¡¹**

- [ ] **å¯ç”¨TLSåŠ å¯†**ï¼šæ‰€æœ‰æœåŠ¡é—´é€šä¿¡å¿…é¡»åŠ å¯†
- [ ] **å®æ–½èº«ä»½è®¤è¯**ï¼šæ²¡æœ‰è®¤è¯çš„æœåŠ¡ä¸è¦æš´éœ²
- [ ] **é…ç½®è®¿é—®æ§åˆ¶**ï¼šæœ€å°æƒé™åŸåˆ™ï¼Œèƒ½é™åˆ¶å°±é™åˆ¶
- [ ] **æ•æ„Ÿæ•°æ®åŠ å¯†**ï¼šå¯†ç ã€èº«ä»½è¯ç­‰äºŒæ¬¡åŠ å¯†
- [ ] **è®°å½•å®¡è®¡æ—¥å¿—**ï¼šå…³é”®æ“ä½œå¿…é¡»ç•™ç—•
- [ ] **é…ç½®é™æµç­–ç•¥**ï¼šé˜²æ­¢ç³»ç»Ÿè¢«æ‰“å®
- [ ] **å®šæœŸå®‰å…¨å®¡è®¡**ï¼šæ£€æŸ¥é…ç½®å’Œæ¼æ´

**âš ï¸ å¸¸è§å®‰å…¨è¯¯åŒº**

```
è¯¯åŒº1ï¼š"å†…ç½‘æœåŠ¡ä¸éœ€è¦åŠ å¯†"
âœ— é”™è¯¯ï¼šå†…ç½‘ä¹Ÿå¯èƒ½è¢«æ”»ç ´
âœ“ æ­£ç¡®ï¼šæ‰€æœ‰ç¯å¢ƒéƒ½åº”åŠ å¯†

è¯¯åŒº2ï¼š"è®¤è¯å½±å“æ€§èƒ½ï¼Œä¸ç”¨ä¹Ÿè¡Œ"
âœ— é”™è¯¯ï¼šæ€§èƒ½æŸå¤±è¿œå°äºå®‰å…¨é£é™©
âœ“ æ­£ç¡®ï¼šåˆç†çš„è®¤è¯å¼€é”€å¯æ¥å—

è¯¯åŒº3ï¼š"åªåœ¨ç½‘å…³åšå®‰å…¨é˜²æŠ¤"
âœ— é”™è¯¯ï¼šç½‘å…³è¢«ç»•è¿‡å°±å…¨å®Œäº†
âœ“ æ­£ç¡®ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¦æœ‰åŸºæœ¬é˜²æŠ¤

è¯¯åŒº4ï¼š"å®¡è®¡æ—¥å¿—å ç”¨èµ„æºï¼Œèƒ½çœå°±çœ"
âœ— é”™è¯¯ï¼šå‡ºé—®é¢˜æ—¶æ— æ³•è¿½æº¯
âœ“ æ­£ç¡®ï¼šå¼‚æ­¥è®°å½•ï¼Œå½±å“å¯æ§
```

### 10.4 å®‰å…¨åŠ å›ºæ£€æŸ¥è¡¨


**ğŸ” å®šæœŸæ£€æŸ¥é¡¹ç›®**

```
è¯ä¹¦ç®¡ç†ï¼š
â–¡ è¯ä¹¦æ˜¯å¦å¿«è¿‡æœŸï¼ˆæå‰30å¤©æ›´æ–°ï¼‰
â–¡ æ˜¯å¦ä½¿ç”¨å¼ºåŠ å¯†å¥—ä»¶ï¼ˆTLS 1.2+ï¼‰
â–¡ ç§é’¥æ˜¯å¦å®‰å…¨ä¿å­˜

è®¤è¯æˆæƒï¼š
â–¡ Tokenè¿‡æœŸæ—¶é—´æ˜¯å¦åˆç†ï¼ˆâ‰¤2å°æ—¶ï¼‰
â–¡ æƒé™é…ç½®æ˜¯å¦æœ€å°åŒ–
â–¡ æ˜¯å¦æœ‰å®šæœŸçš„æƒé™å®¡æŸ¥

è®¿é—®æ§åˆ¶ï¼š
â–¡ IPç™½åå•æ˜¯å¦åŠæ—¶æ›´æ–°
â–¡ é»‘åå•æ˜¯å¦æœ‰æ¸…ç†æœºåˆ¶
â–¡ æ˜¯å¦æœ‰å¼‚å¸¸è®¿é—®ç›‘æ§

æ•°æ®ä¿æŠ¤ï¼š
â–¡ æ•æ„Ÿå­—æ®µæ˜¯å¦åŠ å¯†
â–¡ æ—¥å¿—ä¸­æ˜¯å¦è„±æ•
â–¡ å¤‡ä»½æ•°æ®æ˜¯å¦åŠ å¯†

æ”»å‡»é˜²æŠ¤ï¼š
â–¡ é™æµé˜ˆå€¼æ˜¯å¦åˆç†
â–¡ æ˜¯å¦æœ‰DDoSé˜²æŠ¤
â–¡ å‚æ•°æ ¡éªŒæ˜¯å¦å®Œå–„

ç›‘æ§å®¡è®¡ï¼š
â–¡ å®¡è®¡æ—¥å¿—ä¿ç•™æœŸé™ï¼ˆâ‰¥6ä¸ªæœˆï¼‰
â–¡ æ˜¯å¦æœ‰å®‰å…¨äº‹ä»¶å‘Šè­¦
â–¡ æ˜¯å¦å®šæœŸåˆ†ææ—¥å¿—
```

### 10.5 åº”æ€¥å“åº”é¢„æ¡ˆ


**ğŸš¨ å®‰å…¨äº‹ä»¶å¤„ç†æµç¨‹**

```
å‘ç°å®‰å…¨äº‹ä»¶æ—¶çš„å¤„ç†æ­¥éª¤ï¼š

1. ç«‹å³å“åº”ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
   â†’ ç¡®è®¤äº‹ä»¶ç±»å‹å’Œå½±å“èŒƒå›´
   â†’ å¯åŠ¨åº”æ€¥é¢„æ¡ˆ
   â†’ é€šçŸ¥ç›¸å…³äººå‘˜

2. æ­¢æŸæªæ–½ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
   â†’ å°ç¦æ”»å‡»IP
   â†’ ä¸´æ—¶ä¸‹çº¿å—å½±å“æœåŠ¡
   â†’ å¯ç”¨å¤‡ç”¨æ–¹æ¡ˆ

3. é—®é¢˜åˆ†æï¼ˆ2å°æ—¶å†…ï¼‰
   â†’ æŸ¥çœ‹å®¡è®¡æ—¥å¿—
   â†’ åˆ†ææ”»å‡»æ‰‹æ®µ
   â†’ è¯„ä¼°æŸå¤±ç¨‹åº¦

4. ä¿®å¤åŠ å›ºï¼ˆ24å°æ—¶å†…ï¼‰
   â†’ ä¿®å¤å®‰å…¨æ¼æ´
   â†’ æ›´æ–°å®‰å…¨ç­–ç•¥
   â†’ æ¢å¤æœåŠ¡

5. æ€»ç»“æ”¹è¿›ï¼ˆ3å¤©å†…ï¼‰
   â†’ ç¼–å†™äº‹ä»¶æŠ¥å‘Š
   â†’ ä¼˜åŒ–é˜²æŠ¤æªæ–½
   â†’ å›¢é˜Ÿå®‰å…¨åŸ¹è®­
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®‰å…¨æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦å¤šå±‚é˜²æŠ¤
- TLSåŠ å¯†æ˜¯åŸºç¡€ï¼Œè®¤è¯æˆæƒæ˜¯æ ¸å¿ƒ
- æ•æ„Ÿæ•°æ®è¦åŠ å¯†ï¼Œæ‰€æœ‰æ“ä½œè¦å®¡è®¡
- é˜²æŠ¤ç­–ç•¥è¦é€‚åº¦ï¼Œä¸èƒ½å½±å“æ­£å¸¸ä¸šåŠ¡
- å®‰å…¨é…ç½®è¦å®šæœŸæ£€æŸ¥å’Œæ›´æ–°
- åˆ¶å®šåº”æ€¥é¢„æ¡ˆï¼Œå‘ç”Ÿé—®é¢˜èƒ½å¿«é€Ÿå“åº”