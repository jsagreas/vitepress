---
title: 5ã€OpenFeignå®¹é”™é™çº§æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [å®¹é”™é™çº§æ ¸å¿ƒæ¦‚å¿µ](#1-å®¹é”™é™çº§æ ¸å¿ƒæ¦‚å¿µ)
2. [Hystrixç†”æ–­å™¨é›†æˆ](#2-Hystrixç†”æ–­å™¨é›†æˆ)
3. [Resilience4jç†”æ–­å™¨é›†æˆ](#3-Resilience4jç†”æ–­å™¨é›†æˆ)
4. [é‡è¯•æœºåˆ¶é…ç½®](#4-é‡è¯•æœºåˆ¶é…ç½®)
5. [ç†”æ–­é™çº§ç­–ç•¥](#5-ç†”æ–­é™çº§ç­–ç•¥)
6. [Fallbacké™çº§æ–¹æ³•](#6-Fallbacké™çº§æ–¹æ³•)
7. [FallbackFactoryå·¥å‚](#7-FallbackFactoryå·¥å‚)
8. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#8-å¼‚å¸¸å¤„ç†ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹é”™é™çº§æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®¹é”™é™çº§


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ æ‰“ç”µè¯ç»™æœ‹å‹ï¼Œå¦‚æœå¯¹æ–¹ä¸æ¥ç”µè¯ï¼ˆæœåŠ¡å¤±è´¥ï¼‰ï¼Œä½ ä¸ä¼šä¸€ç›´ç­‰ï¼Œè€Œæ˜¯æ”¹å‘çŸ­ä¿¡ï¼ˆé™çº§æ–¹æ¡ˆï¼‰ã€‚

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·è¯·æ±‚ â†’ OpenFeignè°ƒç”¨æœåŠ¡ â†’ è¿”å›ç»“æœ âœ…

æœåŠ¡æ•…éšœï¼š
ç”¨æˆ·è¯·æ±‚ â†’ OpenFeignè°ƒç”¨æœåŠ¡ â†’ è¶…æ—¶/å¤±è´¥ âŒ
         â†“
      è§¦å‘é™çº§é€»è¾‘
         â†“
      è¿”å›å¤‡ç”¨ç»“æœ âœ…ï¼ˆè™½ç„¶ä¸æ˜¯æœ€å¥½çš„ï¼Œä½†ä¿è¯äº†å¯ç”¨æ€§ï¼‰
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š

ğŸ”¸ **å®¹é”™ï¼ˆFault Toleranceï¼‰**ï¼š
- å«ä¹‰ï¼šç³»ç»Ÿé‡åˆ°é”™è¯¯æ—¶èƒ½ç»§ç»­è¿è¡Œçš„èƒ½åŠ›
- ç›®çš„ï¼šé˜²æ­¢å•ä¸ªæœåŠ¡æ•…éšœå½±å“æ•´ä¸ªç³»ç»Ÿ
- ç±»æ¯”ï¼šç”µå½±é™¢æŸä¸ªæ”¾æ˜ å…åäº†ï¼Œå…¶ä»–å…ç»§ç»­è¥ä¸š

ğŸ”¸ **é™çº§ï¼ˆDegradationï¼‰**ï¼š
- å«ä¹‰ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œæä¾›æ›¿ä»£æ–¹æ¡ˆ
- ç›®çš„ï¼šä¿è¯ç”¨æˆ·ä½“éªŒï¼Œè¿”å›å‹å¥½æç¤º
- ç±»æ¯”ï¼šé¤å…æŸé“èœæ²¡äº†ï¼Œæ¨èå…¶ä»–èœå“

ğŸ”¸ **ç†”æ–­ï¼ˆCircuit Breakerï¼‰**ï¼š
- å«ä¹‰ï¼šæ£€æµ‹åˆ°æœåŠ¡é¢‘ç¹å¤±è´¥æ—¶ï¼Œæš‚æ—¶é˜»æ–­è¯·æ±‚
- ç›®çš„ï¼šé¿å…é›ªå´©æ•ˆåº”ï¼Œç»™æ•…éšœæœåŠ¡æ¢å¤æ—¶é—´
- ç±»æ¯”ï¼šä¿é™©ä¸ï¼Œç”µæµè¿‡å¤§æ—¶è‡ªåŠ¨æ–­ç”µä¿æŠ¤

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®¹é”™é™çº§


**çœŸå®åœºæ™¯é—®é¢˜**ï¼š

```
ç”µå•†ç³»ç»Ÿåœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ä¸‹å• â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â†’ åº“å­˜æœåŠ¡ï¼ˆæ£€æŸ¥åº“å­˜ï¼‰
     â”œâ”€â”€â†’ ä¼˜æƒ æœåŠ¡ï¼ˆè®¡ç®—æŠ˜æ‰£ï¼‰â† çªç„¶æŒ‚äº†ï¼âŒ
     â”œâ”€â”€â†’ è®¢å•æœåŠ¡ï¼ˆåˆ›å»ºè®¢å•ï¼‰
     â””â”€â”€â†’ æ”¯ä»˜æœåŠ¡ï¼ˆå¤„ç†æ”¯ä»˜ï¼‰

é—®é¢˜ï¼šä¼˜æƒ æœåŠ¡æŒ‚äº†ï¼Œæ•´ä¸ªä¸‹å•æµç¨‹å¡ä½
ç»“æœï¼šç”¨æˆ·æ— æ³•ä¸‹å•ï¼Œä¸šåŠ¡æŸå¤±ğŸ’°
```

**å®¹é”™é™çº§æ–¹æ¡ˆ**ï¼š

```
æ™ºèƒ½é™çº§å¤„ç†ï¼š
ä¼˜æƒ æœåŠ¡å¤±è´¥ â†’ è§¦å‘é™çº§
              â†“
         è¿”å›é»˜è®¤ä¼˜æƒ ï¼ˆå¦‚æ— ä¼˜æƒ ï¼‰
              â†“
         è®¢å•ç»§ç»­å¤„ç† âœ…
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šå®¹é”™é™çº§ä¸æ˜¯è®©æœåŠ¡100%å¯ç”¨ï¼Œè€Œæ˜¯åœ¨æ•…éšœæ—¶**ä¼˜é›…åœ°å¤±è´¥**ï¼Œä¿è¯æ ¸å¿ƒä¸šåŠ¡ä¸å—å½±å“ã€‚

### 1.3 å®¹é”™é™çº§çš„ä¸‰å¤§æœºåˆ¶


| æœºåˆ¶ | ä½œç”¨æ—¶æœº | ä¸»è¦ç›®çš„ | å®é™…ç±»æ¯” |
|------|---------|---------|---------|
| **é‡è¯•** | å¶å‘æ€§å¤±è´¥ | å¢åŠ æˆåŠŸç‡ | æ‰“ç”µè¯æ²¡æ¥é€šï¼Œå†æ‰“ä¸€æ¬¡ |
| **ç†”æ–­** | æŒç»­æ€§æ•…éšœ | å¿«é€Ÿå¤±è´¥ï¼Œé¿å…é›ªå´© | ä¿é™©ä¸è·³é—¸ï¼Œåœæ­¢ä¾›ç”µ |
| **é™çº§** | æœåŠ¡ä¸å¯ç”¨ | æä¾›å¤‡ç”¨æ–¹æ¡ˆ | ç”µæ¢¯åäº†ï¼Œèµ°æ¥¼æ¢¯ |

---

## 2. ğŸ”¥ Hystrixç†”æ–­å™¨é›†æˆ


### 2.1 Hystrixæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šHystrixï¼ˆå¸Œè…Šç¥è¯ä¸­çš„æ€ªå…½ï¼‰æ˜¯Netflixå¼€å‘çš„å®¹é”™åº“ï¼Œåƒä¸€ä¸ª**æ™ºèƒ½ä¿é•–**ï¼Œä¿æŠ¤ä½ çš„æœåŠ¡ä¸è¢«æ•…éšœæ‹–å®ã€‚

> âš ï¸ **æ³¨æ„**ï¼šHystrixå·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼ˆä¸å†æ›´æ–°ï¼‰ï¼Œå»ºè®®æ–°é¡¹ç›®ä½¿ç”¨Resilience4jï¼Œä½†å¾ˆå¤šè€é¡¹ç›®ä»åœ¨ä½¿ç”¨ã€‚

### 2.2 æ ¸å¿ƒå·¥ä½œåŸç†


```
è¯·æ±‚æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘èµ·è¯·æ±‚ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç†”æ–­å™¨æ£€æŸ¥çŠ¶æ€â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
  â”Œâ”€â”€â”´â”€â”€â”
  â”‚OPEN?â”‚â”€â”€æ˜¯â”€â”€â†’ ç›´æ¥è¿”å›é™çº§ç»“æœ
  â””â”€â”€â”¬â”€â”€â”˜
     â”‚å¦
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œè¿œç¨‹è°ƒç”¨ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
  â”Œâ”€â”€â”´â”€â”€â”
  â”‚æˆåŠŸ?â”‚â”€â”€æ˜¯â”€â”€â†’ è¿”å›ç»“æœ
  â””â”€â”€â”¬â”€â”€â”˜
     â”‚å¦
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®°å½•å¤±è´¥æ¬¡æ•° â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
  â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”
  â”‚è¾¾åˆ°é˜ˆå€¼?â”‚â”€â”€æ˜¯â”€â”€â†’ ç†”æ–­å™¨æ‰“å¼€
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 é›†æˆé…ç½®æ­¥éª¤


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<!-- æ³¨æ„ï¼šHystrixå·²åœæ­¢ç»´æŠ¤ï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šå¼€å¯Hystrixæ”¯æŒ**

```yaml
# application.yml
feign:
  hystrix:
    enabled: true  # å¼€å¯Hystrixæ”¯æŒ
```

**æ­¥éª¤3ï¼šé…ç½®ç†”æ–­å‚æ•°**

```yaml
hystrix:
  command:
    default:  # å…¨å±€é…ç½®
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 3000  # è¶…æ—¶æ—¶é—´3ç§’
      circuitBreaker:
        enabled: true                     # å¯ç”¨ç†”æ–­å™¨
        requestVolumeThreshold: 10        # è§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚æ•°
        errorThresholdPercentage: 50      # é”™è¯¯ç‡è¾¾åˆ°50%è§¦å‘ç†”æ–­
        sleepWindowInMilliseconds: 5000   # ç†”æ–­å5ç§’è¿›å…¥åŠå¼€çŠ¶æ€
```

**å‚æ•°å«ä¹‰è¯¦è§£**ï¼š

ğŸ”¸ **timeoutInMilliseconds**ï¼ˆè¶…æ—¶æ—¶é—´ï¼‰
- å«ä¹‰ï¼šè°ƒç”¨æœåŠ¡çš„æœ€å¤§ç­‰å¾…æ—¶é—´
- ç¤ºä¾‹ï¼šè®¾ç½®3000msï¼Œè¶…è¿‡3ç§’æœªå“åº”å°±è®¤ä¸ºå¤±è´¥
- ç±»æ¯”ï¼šæ‰“ç”µè¯ç­‰30ç§’è¿˜æ²¡äººæ¥å°±æŒ‚æ–­

ğŸ”¸ **requestVolumeThreshold**ï¼ˆè¯·æ±‚æ•°é˜ˆå€¼ï¼‰
- å«ä¹‰ï¼šç»Ÿè®¡çª—å£å†…æœ€å°‘è¯·æ±‚æ•°ï¼Œä½äºæ­¤å€¼ä¸ç†”æ–­
- ç¤ºä¾‹ï¼šè®¾ç½®10ï¼Œå¿…é¡»æœ‰10æ¬¡è¯·æ±‚æ‰å¼€å§‹ç»Ÿè®¡å¤±è´¥ç‡
- ç±»æ¯”ï¼šè‡³å°‘è¦æœ‰10ä¸ªæ ·æœ¬æ‰èƒ½åˆ¤æ–­è´¨é‡

ğŸ”¸ **errorThresholdPercentage**ï¼ˆé”™è¯¯ç‡é˜ˆå€¼ï¼‰
- å«ä¹‰ï¼šè§¦å‘ç†”æ–­çš„é”™è¯¯ç™¾åˆ†æ¯”
- ç¤ºä¾‹ï¼šè®¾ç½®50%ï¼Œä¸€åŠè¯·æ±‚å¤±è´¥å°±ç†”æ–­
- ç±»æ¯”ï¼šè€ƒè¯•åŠæ ¼çº¿ï¼Œä½äº50åˆ†å°±ä¸åŠæ ¼

ğŸ”¸ **sleepWindowInMilliseconds**ï¼ˆç†”æ–­æ—¶é—´çª—å£ï¼‰
- å«ä¹‰ï¼šç†”æ–­åå¤šä¹…å°è¯•æ¢å¤
- ç¤ºä¾‹ï¼š5000msåè¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå°è¯•æ”¾è¡Œè¯·æ±‚
- ç±»æ¯”ï¼šä¿é™©ä¸è·³é—¸åï¼Œç­‰5ç§’å†å°è¯•æ¢å¤ä¾›ç”µ

### 2.4 å®é™…ä½¿ç”¨ç¤ºä¾‹


```java
// å®šä¹‰Feignå®¢æˆ·ç«¯
@FeignClient(name = "product-service", fallback = ProductFallback.class)
public interface ProductClient {
    @GetMapping("/product/{id}")
    Product getProductById(@PathVariable Long id);
}

// é™çº§å®ç°ç±»
@Component
public class ProductFallback implements ProductClient {
    @Override
    public Product getProductById(Long id) {
        // è¿”å›é™çº§æ•°æ®
        Product product = new Product();
        product.setId(id);
        product.setName("å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        product.setPrice(0.0);
        return product;
    }
}
```

---

## 3. ğŸ†• Resilience4jç†”æ–­å™¨é›†æˆ


### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©Resilience4j


**å¯¹æ¯”Hystrixçš„ä¼˜åŠ¿**ï¼š

| å¯¹æ¯”é¡¹ | Hystrix | Resilience4j |
|--------|---------|--------------|
| **ç»´æŠ¤çŠ¶æ€** | åœæ­¢æ›´æ–° | æŒç»­ç»´æŠ¤ âœ… |
| **ä¾èµ–** | é‡é‡çº§ï¼Œä¾èµ–RxJava | è½»é‡çº§ï¼Œæ— å…¶ä»–ä¾èµ– |
| **æ€§èƒ½** | åŸºäºçº¿ç¨‹æ± éš”ç¦» | åŸºäºä¿¡å·é‡ï¼Œæ€§èƒ½æ›´å¥½ |
| **é…ç½®** | å¤æ‚ | ç®€å•ç›´è§‚ |
| **Spring Booté›†æˆ** | éœ€è¦ç‰¹æ®Šé…ç½® | åŸç”Ÿæ”¯æŒ |

> ğŸ’¡ **æ¨è**ï¼šæ–°é¡¹ç›®å¼ºçƒˆå»ºè®®ä½¿ç”¨Resilience4jï¼Œå®ƒæ˜¯Springå®˜æ–¹æ¨èçš„å®¹é”™æ–¹æ¡ˆã€‚

### 3.2 æ ¸å¿ƒç»„ä»¶


**Resilience4jæä¾›5å¤§å®¹é”™æ¨¡å—**ï¼š

```
Resilience4jå®¹é”™å·¥å…·ç®±ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CircuitBreaker  ç†”æ–­å™¨  â”‚ â† é˜²æ­¢æ•…éšœæ‰©æ•£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RateLimiter    é™æµå™¨   â”‚ â† æ§åˆ¶è¯·æ±‚é€Ÿç‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Retry          é‡è¯•å™¨   â”‚ â† è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TimeLimiter    è¶…æ—¶å™¨   â”‚ â† æ§åˆ¶å“åº”æ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bulkhead       èˆ±å£éš”ç¦» â”‚ â† èµ„æºéš”ç¦»
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 é›†æˆé…ç½®


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<!-- Resilience4jæ ¸å¿ƒ -->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
</dependency>

<!-- Feigné›†æˆ -->
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-feign</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®ç†”æ–­å™¨**

```yaml
resilience4j:
  circuitbreaker:
    instances:
      productService:  # æœåŠ¡åç§°
        # ç†”æ–­å™¨é…ç½®
        failureRateThreshold: 50              # å¤±è´¥ç‡50%è§¦å‘ç†”æ–­
        slowCallRateThreshold: 50             # æ…¢è°ƒç”¨ç‡50%è§¦å‘ç†”æ–­
        slowCallDurationThreshold: 2000       # è¶…è¿‡2ç§’ç®—æ…¢è°ƒç”¨
        slidingWindowSize: 10                 # æ»‘åŠ¨çª—å£å¤§å°10æ¬¡è¯·æ±‚
        minimumNumberOfCalls: 5               # æœ€å°‘5æ¬¡è°ƒç”¨æ‰è®¡ç®—
        waitDurationInOpenState: 10000        # ç†”æ–­åç­‰å¾…10ç§’
        permittedNumberOfCallsInHalfOpenState: 3  # åŠå¼€çŠ¶æ€å…è®¸3æ¬¡æµ‹è¯•
        automaticTransitionFromOpenToHalfOpenEnabled: true  # è‡ªåŠ¨è¿›å…¥åŠå¼€
```

**å…³é”®å‚æ•°è¯¦è§£**ï¼š

ğŸ”¸ **failureRateThreshold**ï¼ˆå¤±è´¥ç‡é˜ˆå€¼ï¼‰
```
è®¡ç®—å…¬å¼ï¼šå¤±è´¥ç‡ = å¤±è´¥æ¬¡æ•° / æ€»è¯·æ±‚æ•° Ã— 100%
ç¤ºä¾‹ï¼š10æ¬¡è¯·æ±‚ä¸­5æ¬¡å¤±è´¥ï¼Œå¤±è´¥ç‡50%
è§¦å‘ï¼šè¾¾åˆ°50%å°±ç†”æ–­
```

ğŸ”¸ **slidingWindowSize**ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
```
å«ä¹‰ï¼šç»Ÿè®¡æœ€è¿‘Næ¬¡è¯·æ±‚çš„ç»“æœ
ç±»æ¯”ï¼šè€ƒå¯Ÿå­¦ç”Ÿæˆç»©ï¼Œçœ‹æœ€è¿‘10æ¬¡è€ƒè¯•
å¥½å¤„ï¼šå®æ—¶åæ˜ å½“å‰çŠ¶æ€
```

ğŸ”¸ **waitDurationInOpenState**ï¼ˆç†”æ–­ç­‰å¾…æ—¶é—´ï¼‰
```
å«ä¹‰ï¼šç†”æ–­åç­‰å¾…å¤šä¹…å°è¯•æ¢å¤
è¿‡ç¨‹ï¼šOPEN â†’ ç­‰å¾…10ç§’ â†’ HALF_OPEN
ç›®çš„ï¼šç»™æ•…éšœæœåŠ¡æ¢å¤æ—¶é—´
```

### 3.4 ä½¿ç”¨ç¤ºä¾‹


```java
@FeignClient(
    name = "product-service",
    configuration = FeignConfig.class
)
public interface ProductClient {
    @GetMapping("/product/{id}")
    Product getProductById(@PathVariable Long id);
}

// Feigné…ç½®ç±»
@Configuration
public class FeignConfig {
    @Bean
    public Feign.Builder feignBuilder() {
        // é›†æˆResilience4j
        return Resilience4jFeign.builder()
            .circuitBreakerRegistry(CircuitBreakerRegistry.ofDefaults());
    }
}
```

---

## 4. ğŸ”„ é‡è¯•æœºåˆ¶é…ç½®


### 4.1 ä»€ä¹ˆæ˜¯é‡è¯•æœºåˆ¶


**é€šä¿—ç†è§£**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨å¤±è´¥äº†ï¼Œè‡ªåŠ¨å†è¯•å‡ æ¬¡ï¼Œå°±åƒæ‰“ç”µè¯æ²¡æ¥é€šï¼Œè‡ªåŠ¨é‡æ‹¨ã€‚

```
é‡è¯•æµç¨‹ï¼š
ç¬¬1æ¬¡è°ƒç”¨ â†’ å¤±è´¥ âŒ
    â†“
ç­‰å¾…500ms
    â†“
ç¬¬2æ¬¡è°ƒç”¨ â†’ å¤±è´¥ âŒ
    â†“
ç­‰å¾…1000ms
    â†“
ç¬¬3æ¬¡è°ƒç”¨ â†’ æˆåŠŸ âœ…
```

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„å¶å‘å¤±è´¥
- âœ… æœåŠ¡çŸ­æš‚ä¸å¯ç”¨ï¼ˆå¦‚é‡å¯ï¼‰
- âœ… æ•°æ®åº“æ­»é”ç­‰ä¸´æ—¶é—®é¢˜
- âŒ æœåŠ¡é€»è¾‘é”™è¯¯ï¼ˆé‡è¯•æ— æ„ä¹‰ï¼‰

### 4.2 Feignå†…ç½®é‡è¯•é…ç½®


```yaml
# application.yml
feign:
  client:
    config:
      default:  # å…¨å±€é…ç½®
        connectTimeout: 5000      # è¿æ¥è¶…æ—¶5ç§’
        readTimeout: 10000        # è¯»å–è¶…æ—¶10ç§’
      product-service:  # é’ˆå¯¹ç‰¹å®šæœåŠ¡
        connectTimeout: 3000
        readTimeout: 5000
```

**è‡ªå®šä¹‰é‡è¯•å™¨**ï¼š

```java
@Configuration
public class FeignRetryConfig {
    
    @Bean
    public Retryer feignRetryer() {
        // å‚æ•°ï¼šåˆå§‹é—´éš”ã€æœ€å¤§é—´éš”ã€æœ€å¤§é‡è¯•æ¬¡æ•°
        return new Retryer.Default(
            100,    // åˆå§‹é‡è¯•é—´éš”100ms
            1000,   // æœ€å¤§é‡è¯•é—´éš”1ç§’
            3       // æœ€å¤šé‡è¯•3æ¬¡
        );
    }
}
```

### 4.3 Resilience4jé‡è¯•é…ç½®


```yaml
resilience4j:
  retry:
    instances:
      productService:
        maxAttempts: 3                    # æœ€å¤šé‡è¯•3æ¬¡
        waitDuration: 500                 # æ¯æ¬¡ç­‰å¾…500ms
        retryExceptions:                  # å“ªäº›å¼‚å¸¸éœ€è¦é‡è¯•
          - java.net.ConnectException
          - java.net.SocketTimeoutException
        ignoreExceptions:                 # å“ªäº›å¼‚å¸¸ä¸é‡è¯•
          - java.lang.IllegalArgumentException
```

**é‡è¯•ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ç±»å‹ | é‡è¯•é—´éš” | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **å›ºå®šé—´éš”** | æ¯æ¬¡ç›¸åŒ | ç®€å•åœºæ™¯ | æ¯æ¬¡ç­‰500ms |
| **é€’å¢é—´éš”** | é€æ¸å¢åŠ  | é¿å…é¢‘ç¹é‡è¯• | 500msâ†’1sâ†’2s |
| **æŒ‡æ•°é€€é¿** | æŒ‡æ•°å¢é•¿ | é˜²æ­¢é›ªå´© | 500msâ†’1sâ†’2sâ†’4s |
| **éšæœºé—´éš”** | éšæœºå»¶è¿Ÿ | é¿å…åŒæ—¶é‡è¯• | 500msÂ±200ms |

**è‡ªå®šä¹‰é‡è¯•é€»è¾‘**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private ProductClient productClient;
    
    @Retry(name = "productService", fallbackMethod = "getProductFallback")
    public Product getProduct(Long id) {
        return productClient.getProductById(id);
    }
    
    // é‡è¯•å¤±è´¥åçš„é™çº§æ–¹æ³•
    private Product getProductFallback(Long id, Exception e) {
        log.error("è·å–å•†å“å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡: {}", e.getMessage());
        Product defaultProduct = new Product();
        defaultProduct.setId(id);
        defaultProduct.setName("å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥");
        return defaultProduct;
    }
}
```

---

## 5. âš¡ ç†”æ–­é™çº§ç­–ç•¥


### 5.1 ç†”æ–­å™¨ä¸‰æ€æ¨¡å‹


```
ç†”æ–­å™¨çŠ¶æ€è½¬æ¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLOSED â”‚ â† åˆå§‹çŠ¶æ€ï¼šæ­£å¸¸å·¥ä½œ
â”‚ (å…³é—­)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚å¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPEN   â”‚ â† ç†”æ–­æ‰“å¼€ï¼šæ‹’ç»æ‰€æœ‰è¯·æ±‚
â”‚ (æ‰“å¼€)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ç­‰å¾…ä¸€å®šæ—¶é—´
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚HALF_OPEN â”‚ â† åŠå¼€çŠ¶æ€ï¼šå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•
â”‚ (åŠå¼€)   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
  â”Œâ”€â”€â”´â”€â”€â”
  â”‚æˆåŠŸ?â”‚
  â””â”€â”€â”¬â”€â”€â”˜
     â”‚æ˜¯          â”‚å¦
     â–¼            â–¼
  å›åˆ°CLOSED   å›åˆ°OPEN
```

**çŠ¶æ€è¯´æ˜**ï¼š

ğŸ”¸ **CLOSEDï¼ˆå…³é—­çŠ¶æ€ï¼‰**
- å«ä¹‰ï¼šç†”æ–­å™¨å…³é—­ï¼Œè¯·æ±‚æ­£å¸¸é€šè¿‡
- ç›‘æ§ï¼šç»Ÿè®¡å¤±è´¥ç‡
- è½¬æ¢ï¼šå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ â†’ OPEN

ğŸ”¸ **OPENï¼ˆæ‰“å¼€çŠ¶æ€ï¼‰**
- å«ä¹‰ï¼šç†”æ–­å™¨æ‰“å¼€ï¼Œå¿«é€Ÿå¤±è´¥
- è¡Œä¸ºï¼šç›´æ¥è¿”å›é™çº§ç»“æœï¼Œä¸è°ƒç”¨æœåŠ¡
- è½¬æ¢ï¼šç­‰å¾…ä¸€å®šæ—¶é—´ â†’ HALF_OPEN

ğŸ”¸ **HALF_OPENï¼ˆåŠå¼€çŠ¶æ€ï¼‰**
- å«ä¹‰ï¼šè¯•æ¢æ€§æ¢å¤
- è¡Œä¸ºï¼šå…è®¸å°‘é‡è¯·æ±‚é€šè¿‡
- è½¬æ¢ï¼šæˆåŠŸ â†’ CLOSEDï¼Œå¤±è´¥ â†’ OPEN

### 5.2 é™çº§ç­–ç•¥ç±»å‹


**æŒ‰ä¸šåŠ¡é‡è¦æ€§é™çº§**ï¼š

```
æ ¸å¿ƒä¸šåŠ¡ â†’ ä¿éšœçº§é™çº§ï¼ˆå¿…é¡»å¯ç”¨ï¼‰
    â”œâ”€ è®¢å•æ”¯ä»˜ï¼šç»ä¸èƒ½é™çº§
    â”œâ”€ åº“å­˜æ£€æŸ¥ï¼šè¿”å›é»˜è®¤åº“å­˜
    â””â”€ ç‰©æµæŸ¥è¯¢ï¼šè¿”å›"æŸ¥è¯¢ä¸­"

éæ ¸å¿ƒä¸šåŠ¡ â†’ å¯é™çº§ï¼ˆç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼‰
    â”œâ”€ å•†å“è¯„è®ºï¼šè¿”å›ç©ºåˆ—è¡¨
    â”œâ”€ æ¨èå•†å“ï¼šè¿”å›çƒ­é—¨å•†å“
    â””â”€ å¹¿å‘ŠæœåŠ¡ï¼šä¸å±•ç¤ºå¹¿å‘Š
```

**æŒ‰æ•°æ®æ—¶æ•ˆæ€§é™çº§**ï¼š

| é™çº§æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | å®ç°æ–¹å¼ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **å®æ—¶æ•°æ®** | æ•°æ®è¦æ±‚å®æ—¶ | è°ƒç”¨å¤±è´¥è¿”å›é”™è¯¯ | è‚¡ç¥¨ä»·æ ¼ |
| **ç¼“å­˜æ•°æ®** | å…è®¸ç¨æœ‰å»¶è¿Ÿ | è¿”å›ç¼“å­˜çš„æ—§æ•°æ® | å•†å“è¯¦æƒ… |
| **é™æ€æ•°æ®** | æ•°æ®å˜åŒ–ä¸å¤§ | è¿”å›é»˜è®¤é…ç½® | åˆ†ç±»åˆ—è¡¨ |
| **ç©ºæ•°æ®** | éå¿…éœ€ä¿¡æ¯ | è¿”å›ç©ºå¯¹è±¡ | å¹¿å‘Šä½ |

### 5.3 å¤šçº§é™çº§ç­–ç•¥


```
é™çº§çº§åˆ«è®¾è®¡ï¼š
Level 1: è°ƒç”¨å¤‡ç”¨æœåŠ¡
    â†“ å¤±è´¥
Level 2: è¿”å›ç¼“å­˜æ•°æ®
    â†“ å¤±è´¥
Level 3: è¿”å›é™çº§æ•°æ®
    â†“ å¤±è´¥
Level 4: è¿”å›å‹å¥½æç¤º
```

**ä»£ç å®ç°**ï¼š

```java
@Service
public class ProductService {
    
    @Autowired
    private ProductClient productClient;
    @Autowired
    private RedisTemplate redisTemplate;
    
    public Product getProduct(Long id) {
        try {
            // Level 1: è°ƒç”¨ä¸»æœåŠ¡
            return productClient.getProductById(id);
        } catch (Exception e1) {
            try {
                // Level 2: è°ƒç”¨å¤‡ç”¨æœåŠ¡
                return productClient.getProductFromBackup(id);
            } catch (Exception e2) {
                // Level 3: è¿”å›ç¼“å­˜æ•°æ®
                Product cached = (Product) redisTemplate.opsForValue()
                    .get("product:" + id);
                if (cached != null) {
                    cached.setNote("æ•°æ®æ¥è‡ªç¼“å­˜");
                    return cached;
                }
                // Level 4: è¿”å›é™çº§æ•°æ®
                return createFallbackProduct(id);
            }
        }
    }
    
    private Product createFallbackProduct(Long id) {
        Product product = new Product();
        product.setId(id);
        product.setName("å•†å“ä¿¡æ¯æš‚æ—¶æ— æ³•åŠ è½½");
        product.setStatus("unavailable");
        return product;
    }
}
```

---

## 6. ğŸ¯ Fallbacké™çº§æ–¹æ³•


### 6.1 FallbackåŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šFallbackå°±æ˜¯**å¤‡èƒæ–¹æ¡ˆ**ï¼Œæ­£å¸¸æ–¹æ³•è°ƒç”¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œçš„å¤‡ç”¨æ–¹æ³•ã€‚

```
æ­£å¸¸æµç¨‹ï¼š
è°ƒç”¨æ–¹æ³•A â†’ æˆåŠŸ â†’ è¿”å›ç»“æœ

é™çº§æµç¨‹ï¼š
è°ƒç”¨æ–¹æ³•A â†’ å¤±è´¥ â†’ è§¦å‘Fallbackæ–¹æ³•B â†’ è¿”å›é™çº§ç»“æœ
```

### 6.2 Fallbackå®ç°æ–¹å¼


**æ–¹å¼1ï¼šå®ç°FeignClientæ¥å£**

```java
// 1. å®šä¹‰Feignæ¥å£
@FeignClient(name = "order-service", fallback = OrderFallback.class)
public interface OrderClient {
    @GetMapping("/order/{id}")
    Order getOrderById(@PathVariable Long id);
    
    @PostMapping("/order")
    Order createOrder(@RequestBody Order order);
}

// 2. å®ç°é™çº§ç±»
@Component
public class OrderFallback implements OrderClient {
    
    @Override
    public Order getOrderById(Long id) {
        // é™çº§é€»è¾‘ï¼šè¿”å›é»˜è®¤è®¢å•
        Order order = new Order();
        order.setId(id);
        order.setStatus("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        return order;
    }
    
    @Override
    public Order createOrder(Order order) {
        // é™çº§é€»è¾‘ï¼šè¿”å›åˆ›å»ºå¤±è´¥ä¿¡æ¯
        order.setStatus("åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        return order;
    }
}
```

**æ–¹å¼2ï¼šä½¿ç”¨@FeignClientçš„fallbackå±æ€§**

```java
@FeignClient(
    name = "user-service",
    fallback = UserServiceFallback.class
)
public interface UserClient {
    @GetMapping("/user/{id}")
    User getUserById(@PathVariable Long id);
}

@Component
public class UserServiceFallback implements UserClient {
    @Override
    public User getUserById(Long id) {
        User user = new User();
        user.setId(id);
        user.setUsername("ä¸´æ—¶ç”¨æˆ·");
        user.setStatus("offline");
        return user;
    }
}
```

### 6.3 Fallbackæœ€ä½³å®è·µ


**åŸåˆ™1ï¼šè¿”å›æœ‰æ„ä¹‰çš„é™çº§æ•°æ®**

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šè¿”å›null
@Override
public Product getProductById(Long id) {
    return null;  // å¯èƒ½å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸
}

// âœ… å¥½çš„åšæ³•ï¼šè¿”å›æ˜ç¡®çš„é™çº§å¯¹è±¡
@Override
public Product getProductById(Long id) {
    Product product = new Product();
    product.setId(id);
    product.setName("å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥");
    product.setPrice(0.0);
    product.setAvailable(false);
    product.setErrorMessage("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
    return product;
}
```

**åŸåˆ™2ï¼šè®°å½•é™çº§æ—¥å¿—**

```java
@Component
@Slf4j
public class ProductFallback implements ProductClient {
    
    @Override
    public Product getProductById(Long id) {
        log.warn("å•†å“æœåŠ¡é™çº§ï¼Œå•†å“ID: {}", id);
        // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendAlert("ProductService", "æœåŠ¡é™çº§");
        return createFallbackProduct(id);
    }
}
```

**åŸåˆ™3ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯å®šåˆ¶é™çº§ç­–ç•¥**

```java
@Component
public class PaymentFallback implements PaymentClient {
    
    @Override
    public PaymentResult pay(PaymentRequest request) {
        // æ”¯ä»˜æ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼Œä¸èƒ½éšæ„é™çº§
        // è®°å½•å¤±è´¥ä¿¡æ¯ï¼Œè¿”å›æ˜ç¡®çš„å¤±è´¥çŠ¶æ€
        log.error("æ”¯ä»˜æœåŠ¡ä¸å¯ç”¨ï¼Œè®¢å•å·: {}", request.getOrderId());
        
        PaymentResult result = new PaymentResult();
        result.setSuccess(false);
        result.setMessage("æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        result.setNeedRetry(true);  // æ ‡è®°éœ€è¦é‡è¯•
        
        // å‘é€ç´§æ€¥å‘Šè­¦
        alertService.sendUrgentAlert("PaymentService down!");
        
        return result;
    }
}
```

---

## 7. ğŸ­ FallbackFactoryå·¥å‚


### 7.1 FallbackFactory vs Fallback


**æ ¸å¿ƒåŒºåˆ«**ï¼š

```
Fallbackï¼š
- æ— æ³•è·å–å¼‚å¸¸ä¿¡æ¯
- åªçŸ¥é“è°ƒç”¨å¤±è´¥äº†
- æ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€å¤„ç†

FallbackFactoryï¼š
- å¯ä»¥è·å–å…·ä½“å¼‚å¸¸
- æ ¹æ®ä¸åŒå¼‚å¸¸åšä¸åŒå¤„ç†
- æ›´çµæ´»çš„é™çº§ç­–ç•¥
```

| å¯¹æ¯”é¡¹ | Fallback | FallbackFactory |
|--------|----------|----------------|
| **å¼‚å¸¸ä¿¡æ¯** | âŒ æ— æ³•è·å– | âœ… å¯ä»¥è·å– |
| **çµæ´»æ€§** | ä½ | é«˜ |
| **å®ç°å¤æ‚åº¦** | ç®€å• | ç¨å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•é™çº§ | éœ€è¦å¼‚å¸¸è¯¦æƒ… |

### 7.2 FallbackFactoryä½¿ç”¨


**æ­¥éª¤1ï¼šå®šä¹‰FeignClient**

```java
@FeignClient(
    name = "product-service",
    fallbackFactory = ProductFallbackFactory.class  // ä½¿ç”¨å·¥å‚
)
public interface ProductClient {
    @GetMapping("/product/{id}")
    Product getProductById(@PathVariable Long id);
    
    @GetMapping("/products")
    List<Product> getAllProducts();
}
```

**æ­¥éª¤2ï¼šå®ç°FallbackFactory**

```java
@Component
@Slf4j
public class ProductFallbackFactory implements FallbackFactory<ProductClient> {
    
    @Override
    public ProductClient create(Throwable cause) {
        // æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„é™çº§å®ç°
        return new ProductClient() {
            
            @Override
            public Product getProductById(Long id) {
                // å¯ä»¥è·å–åˆ°å…·ä½“å¼‚å¸¸
                log.error("è·å–å•†å“å¤±è´¥ï¼ŒID: {}, å¼‚å¸¸: {}", id, cause.getMessage());
                
                // æ ¹æ®ä¸åŒå¼‚å¸¸è¿”å›ä¸åŒé™çº§ç»“æœ
                if (cause instanceof TimeoutException) {
                    return createTimeoutProduct(id);
                } else if (cause instanceof FeignException.ServiceUnavailable) {
                    return createServiceUnavailableProduct(id);
                } else {
                    return createDefaultProduct(id);
                }
            }
            
            @Override
            public List<Product> getAllProducts() {
                log.error("è·å–å•†å“åˆ—è¡¨å¤±è´¥: {}", cause.getMessage());
                return Collections.emptyList();
            }
        };
    }
    
    private Product createTimeoutProduct(Long id) {
        Product product = new Product();
        product.setId(id);
        product.setName("è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
        product.setErrorType("TIMEOUT");
        return product;
    }
    
    private Product createServiceUnavailableProduct(Long id) {
        Product product = new Product();
        product.setId(id);
        product.setName("æœåŠ¡ç»´æŠ¤ä¸­");
        product.setErrorType("SERVICE_DOWN");
        return product;
    }
    
    private Product createDefaultProduct(Long id) {
        Product product = new Product();
        product.setId(id);
        product.setName("å•†å“ä¿¡æ¯æš‚æ—¶æ— æ³•è·å–");
        product.setErrorType("UNKNOWN");
        return product;
    }
}
```

### 7.3 é«˜çº§åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šæ ¹æ®å¼‚å¸¸å‘é€ä¸åŒå‘Šè­¦**

```java
@Component
public class OrderFallbackFactory implements FallbackFactory<OrderClient> {
    
    @Autowired
    private AlertService alertService;
    
    @Override
    public OrderClient create(Throwable cause) {
        return new OrderClient() {
            @Override
            public Order createOrder(Order order) {
                // è¶…æ—¶å¼‚å¸¸ - å‘é€æ™®é€šå‘Šè­¦
                if (cause instanceof TimeoutException) {
                    alertService.sendWarning("è®¢å•æœåŠ¡å“åº”è¶…æ—¶");
                }
                // æœåŠ¡ä¸å¯ç”¨ - å‘é€ç´§æ€¥å‘Šè­¦
                else if (cause instanceof FeignException.ServiceUnavailable) {
                    alertService.sendUrgent("è®¢å•æœåŠ¡å®•æœºï¼");
                }
                // å…¶ä»–å¼‚å¸¸ - è®°å½•æ—¥å¿—
                else {
                    log.error("è®¢å•åˆ›å»ºå¤±è´¥: ", cause);
                }
                
                return createFailedOrder(order);
            }
        };
    }
}
```

**åœºæ™¯2ï¼šæ ¹æ®å¼‚å¸¸å†³å®šæ˜¯å¦é‡è¯•**

```java
@Override
public ProductClient create(Throwable cause) {
    return new ProductClient() {
        @Override
        public Product getProductById(Long id) {
            Product result = new Product();
            result.setId(id);
            
            // ç½‘ç»œå¼‚å¸¸ - å»ºè®®é‡è¯•
            if (cause instanceof SocketTimeoutException) {
                result.setRetryable(true);
                result.setMessage("ç½‘ç»œè¶…æ—¶ï¼Œå»ºè®®é‡è¯•");
            }
            // ä¸šåŠ¡å¼‚å¸¸ - ä¸å»ºè®®é‡è¯•
            else if (cause instanceof FeignException.BadRequest) {
                result.setRetryable(false);
                result.setMessage("è¯·æ±‚å‚æ•°é”™è¯¯");
            }
            
            return result;
        }
    };
}
```

---

## 8. ğŸš¨ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 8.1 å¼‚å¸¸åˆ†ç±»å¤„ç†


**Feignå¼‚å¸¸ç±»å‹**ï¼š

```
Feignå¼‚å¸¸ä½“ç³»ï¼š
FeignExceptionï¼ˆæ ¹å¼‚å¸¸ï¼‰
    â”œâ”€ FeignException.BadRequest (400)
    â”œâ”€ FeignException.Unauthorized (401)
    â”œâ”€ FeignException.Forbidden (403)
    â”œâ”€ FeignException.NotFound (404)
    â”œâ”€ FeignException.InternalServerError (500)
    â”œâ”€ FeignException.ServiceUnavailable (503)
    â””â”€ RetryableExceptionï¼ˆå¯é‡è¯•å¼‚å¸¸ï¼‰
```

**å¼‚å¸¸å¤„ç†ç­–ç•¥è¡¨**ï¼š

| å¼‚å¸¸ç±»å‹ | HTTPçŠ¶æ€ç  | æ˜¯å¦é‡è¯• | å¤„ç†æ–¹å¼ |
|---------|-----------|---------|---------|
| **BadRequest** | 400 | âŒ | è¿”å›å‚æ•°é”™è¯¯æç¤º |
| **Unauthorized** | 401 | âŒ | æç¤ºç™»å½•æˆ–æƒé™ä¸è¶³ |
| **NotFound** | 404 | âŒ | è¿”å›èµ„æºä¸å­˜åœ¨ |
| **Timeout** | - | âœ… | é‡è¯•3æ¬¡ |
| **ServiceUnavailable** | 503 | âœ… | è§¦å‘ç†”æ–­é™çº§ |
| **InternalServerError** | 500 | âŒ | è®°å½•æ—¥å¿—ï¼Œè¿”å›é”™è¯¯ |

### 8.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


```java
@Component
@Slf4j
public class FeignErrorDecoder implements ErrorDecoder {
    
    @Override
    public Exception decode(String methodKey, Response response) {
        int status = response.status();
        
        // æ ¹æ®HTTPçŠ¶æ€ç è¿”å›ä¸åŒå¼‚å¸¸
        switch (status) {
            case 400:
                return new BusinessException("è¯·æ±‚å‚æ•°é”™è¯¯");
            case 401:
                return new AuthException("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•");
            case 404:
                return new NotFoundException("è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨");
            case 500:
                return new ServiceException("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
            case 503:
                return new ServiceUnavailableException("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
            default:
                return new FeignException.errorStatus(methodKey, response);
        }
    }
}
```

**é…ç½®é”™è¯¯è§£ç å™¨**ï¼š

```java
@Configuration
public class FeignConfig {
    
    @Bean
    public ErrorDecoder errorDecoder() {
        return new FeignErrorDecoder();
    }
}
```

### 8.3 ç»Ÿä¸€å¼‚å¸¸å¤„ç†


**å®šä¹‰å¼‚å¸¸å¤„ç†å™¨**ï¼š

```java
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    // å¤„ç†Feignè°ƒç”¨å¼‚å¸¸
    @ExceptionHandler(FeignException.class)
    public Result handleFeignException(FeignException e) {
        log.error("Feignè°ƒç”¨å¼‚å¸¸: ", e);
        
        if (e instanceof FeignException.ServiceUnavailable) {
            return Result.error("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        } else if (e instanceof FeignException.NotFound) {
            return Result.error("è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨");
        } else {
            return Result.error("æœåŠ¡è°ƒç”¨å¤±è´¥: " + e.getMessage());
        }
    }
    
    // å¤„ç†è¶…æ—¶å¼‚å¸¸
    @ExceptionHandler(TimeoutException.class)
    public Result handleTimeout(TimeoutException e) {
        log.error("è¯·æ±‚è¶…æ—¶: ", e);
        return Result.error("è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    // å¤„ç†ä¸šåŠ¡å¼‚å¸¸
    @ExceptionHandler(BusinessException.class)
    public Result handleBusinessException(BusinessException e) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        return Result.error(e.getMessage());
    }
}
```

### 8.4 å¼‚å¸¸ç›‘æ§ä¸å‘Šè­¦


**å¼‚å¸¸ç»Ÿè®¡**ï¼š

```java
@Aspect
@Component
@Slf4j
public class FeignExceptionMonitor {
    
    private final Map<String, AtomicLong> exceptionCount = new ConcurrentHashMap<>();
    
    @Around("@annotation(org.springframework.cloud.openfeign.FeignClient)")
    public Object monitor(ProceedingJoinPoint pjp) throws Throwable {
        String serviceName = getServiceName(pjp);
        
        try {
            return pjp.proceed();
        } catch (Exception e) {
            // ç»Ÿè®¡å¼‚å¸¸æ¬¡æ•°
            exceptionCount.computeIfAbsent(serviceName, k -> new AtomicLong())
                         .incrementAndGet();
            
            // å¼‚å¸¸æ¬¡æ•°è¿‡å¤šæ—¶å‘Šè­¦
            if (exceptionCount.get(serviceName).get() > 100) {
                alertService.sendAlert(serviceName + "å¼‚å¸¸æ¬¡æ•°è¿‡å¤š");
            }
            
            throw e;
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å…³é”®æ¦‚å¿µå›é¡¾


```
å®¹é”™é™çº§æ ¸å¿ƒä¸‰è¦ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é‡è¯•   â”‚ â† è§£å†³å¶å‘æ€§å¤±è´¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç†”æ–­   â”‚ â† é˜²æ­¢æ•…éšœæ‰©æ•£
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é™çº§   â”‚ â† æä¾›å¤‡ç”¨æ–¹æ¡ˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ”¸ **é‡è¯•æœºåˆ¶**
- ä½œç”¨ï¼šæé«˜æˆåŠŸç‡ï¼Œåº”å¯¹ç½‘ç»œæŠ–åŠ¨
- æ³¨æ„ï¼šé¿å…é‡è¯•é£æš´ï¼Œè®¾ç½®åˆç†æ¬¡æ•°
- æœ€ä½³å®è·µï¼šæŒ‡æ•°é€€é¿ + æœ€å¤§é‡è¯•æ¬¡æ•°

ğŸ”¸ **ç†”æ–­æœºåˆ¶**
- ä½œç”¨ï¼šå¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢é›ªå´©
- ä¸‰æ€ï¼šCLOSED â†’ OPEN â†’ HALF_OPEN
- å…³é”®ï¼šåˆç†è®¾ç½®é˜ˆå€¼å’Œæ¢å¤æ—¶é—´

ğŸ”¸ **é™çº§æœºåˆ¶**
- ä½œç”¨ï¼šä¿è¯å¯ç”¨æ€§ï¼Œæä¾›å¤‡ç”¨æ–¹æ¡ˆ
- æ–¹å¼ï¼šFallback / FallbackFactory
- åŸåˆ™ï¼šè¿”å›æœ‰æ„ä¹‰çš„é™çº§æ•°æ®

### 9.2 æŠ€æœ¯é€‰å‹å¯¹æ¯”


| æŠ€æœ¯ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|-----|------|---------|
| **Hystrix** | æˆç†Ÿç¨³å®š | åœæ­¢ç»´æŠ¤ | è€é¡¹ç›®ç»´æŠ¤ |
| **Resilience4j** | è½»é‡é«˜æ•ˆ | å­¦ä¹ æˆæœ¬ | æ–°é¡¹ç›®æ¨è âœ… |
| **Sentinel** | åŠŸèƒ½ä¸°å¯Œ | ä¾èµ–Spring Cloud Alibaba | é˜¿é‡Œç³»é¡¹ç›® |

### 9.3 å®è·µå»ºè®®


> âœ… **DOï¼ˆåº”è¯¥åšçš„ï¼‰**
> - ä¸ºæ‰€æœ‰è¿œç¨‹è°ƒç”¨é…ç½®è¶…æ—¶æ—¶é—´
> - æ ¸å¿ƒæ¥å£å¿…é¡»æœ‰é™çº§æ–¹æ¡ˆ
> - ä½¿ç”¨FallbackFactoryè·å–å¼‚å¸¸è¯¦æƒ…
> - ç›‘æ§ç†”æ–­å™¨çŠ¶æ€å¹¶å‘Šè­¦
> - å®šæœŸæ¼”ç»ƒé™çº§æµç¨‹

> âŒ **DON'Tï¼ˆä¸åº”è¯¥åšçš„ï¼‰**
> - ä¸è¦ç›²ç›®é‡è¯•ï¼ˆå¯èƒ½åŠ é‡æ•…éšœï¼‰
> - é™çº§æ•°æ®ä¸è¦è¿”å›null
> - ä¸è¦å¿½ç•¥å¼‚å¸¸æ—¥å¿—
> - ç†”æ–­é˜ˆå€¼ä¸è¦è®¾ç½®è¿‡ä½
> - ä¸è¦æ‰€æœ‰å¼‚å¸¸éƒ½è§¦å‘é™çº§

### 9.4 æ•…éšœå¤„ç†æµç¨‹


```
æœåŠ¡è°ƒç”¨å¤±è´¥å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨æœåŠ¡å¤±è´¥ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚å¯é‡è¯•å¼‚å¸¸?â”‚
    â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
       æ˜¯  â”‚å¦
       â”‚   â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚æ‰§è¡Œé‡è¯•é€»è¾‘â”‚
    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚é‡è¯•æˆåŠŸ? â”‚
    â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
       æ˜¯  â”‚å¦
       â”‚   â”‚
   è¿”å›ç»“æœ â”‚
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚è§¦å‘ç†”æ–­æ£€æŸ¥ â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚è¾¾åˆ°ç†”æ–­é˜ˆå€¼?â”‚
    â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       æ˜¯  â”‚å¦
       â”‚   â”‚
   ç†”æ–­å™¨  â”‚
   æ‰“å¼€    â”‚
       â”‚   â”‚
    â”Œâ”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚æ‰§è¡Œé™çº§é€»è¾‘â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚è¿”å›é™çº§ç»“æœ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.5 è®°å¿†å£è¯€


```
ğŸ¯ å®¹é”™é™çº§è®°å¿ƒé—´ï¼Œ
   ä¸‰å¤§æœºåˆ¶ä¿å¹³å®‰ã€‚

ğŸ”„ é‡è¯•å¤„ç†å¶å‘é”™ï¼Œ
   æ¬¡æ•°é—´éš”è¦è®¾å¥½ã€‚

ğŸ”¥ ç†”æ–­ä¿æŠ¤é˜²é›ªå´©ï¼Œ
   ä¸‰æ€è½¬æ¢è¦æ˜äº†ã€‚

ğŸ›¡ï¸ é™çº§æ–¹æ¡ˆè¦å‡†å¤‡ï¼Œ
   å‹å¥½æç¤ºä¸èƒ½å°‘ã€‚

ğŸ“Š ç›‘æ§å‘Šè­¦è¦è·Ÿä¸Šï¼Œ
   é—®é¢˜å‘ç°å¤„ç†æ—©ã€‚
```