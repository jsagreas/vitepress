---
title: 6ã€OpenFeignç”Ÿäº§ç¯å¢ƒå®è·µ
---
## ğŸ“š ç›®å½•


1. [æ¥å£è®¾è®¡è§„èŒƒ](#1-æ¥å£è®¾è®¡è§„èŒƒ)
2. [å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ](#2-å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ)
3. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#3-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
4. [è°ƒç”¨é“¾è·¯è¿½è¸ª](#4-è°ƒç”¨é“¾è·¯è¿½è¸ª)
5. [å•å…ƒæµ‹è¯•æ–¹æ³•](#5-å•å…ƒæµ‹è¯•æ–¹æ³•)
6. [å¸¸è§é—®é¢˜è§£å†³](#6-å¸¸è§é—®é¢˜è§£å†³)
7. [ç›‘æ§æŒ‡æ ‡æ”¶é›†](#7-ç›‘æ§æŒ‡æ ‡æ”¶é›†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ æ¥å£è®¾è®¡è§„èŒƒ



### 1.1 ä»€ä¹ˆæ˜¯æ¥å£è®¾è®¡è§„èŒƒ



**é€šä¿—ç†è§£**ï¼šå°±åƒå»ºæˆ¿å­è¦æœ‰å›¾çº¸ä¸€æ ·ï¼Œå¾®æœåŠ¡ä¹‹é—´é€šè¿‡OpenFeignè°ƒç”¨ä¹Ÿéœ€è¦éµå¾ªä¸€å¥—"æ–½å·¥è§„èŒƒ"ï¼Œè¿™æ ·ä»£ç æ‰èƒ½å†™å¾—æ¸…æ™°ã€æ˜“ç»´æŠ¤ã€ä¸å‡ºé”™ã€‚

> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**
> 
> æ¥å£è®¾è®¡è§„èŒƒå°±æ˜¯ä¸€å¥—"çº¦å®šä¿—æˆçš„å†™æ³•"ï¼Œå‘Šè¯‰ä½ ï¼š
> - æ¥å£åº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ
> - å‚æ•°æ€ä¹ˆä¼ é€’ï¼Ÿ
> - è¿”å›å€¼æ€ä¹ˆå®šä¹‰ï¼Ÿ
> - æ€ä¹ˆå‘½åæ‰è§„èŒƒï¼Ÿ

### 1.2 æ¥å£å®šä¹‰ä½ç½®è§„èŒƒ



**é—®é¢˜åœºæ™¯**ï¼šå°æ˜å¼€å‘äº†ä¸€ä¸ªè®¢å•æœåŠ¡ï¼Œéœ€è¦è°ƒç”¨å•†å“æœåŠ¡è·å–å•†å“ä¿¡æ¯ï¼ŒFeignæ¥å£åº”è¯¥å†™åœ¨å“ªé‡Œï¼Ÿ

```
ğŸ“¦ é¡¹ç›®ç»“æ„æ¨èï¼ˆé€šä¿—æ˜“æ‡‚ç‰ˆï¼‰

æ–¹æ¡ˆä¸€ï¼šç‹¬ç«‹APIæ¨¡å—ï¼ˆæ¨èğŸ‘ï¼‰
project-root/
â”œâ”€â”€ common-api/              â† ä¸“é—¨å­˜æ”¾Feignæ¥å£çš„æ¨¡å—
â”‚   â”œâ”€â”€ order-api/           â† è®¢å•æœåŠ¡çš„æ¥å£å®šä¹‰
â”‚   â””â”€â”€ product-api/         â† å•†å“æœåŠ¡çš„æ¥å£å®šä¹‰
â”œâ”€â”€ order-service/           â† è®¢å•æœåŠ¡å®ç°
â””â”€â”€ product-service/         â† å•†å“æœåŠ¡å®ç°

æ–¹æ¡ˆäºŒï¼šæœåŠ¡å†…å®šä¹‰ï¼ˆä¸æ¨èâŒï¼‰
order-service/
â””â”€â”€ feign/                   â† æŠŠåˆ«çš„æœåŠ¡æ¥å£éƒ½å†™è¿™é‡Œ
    â””â”€â”€ ProductClient.java   â† å®¹æ˜“æ··ä¹±ï¼Œä¸å¥½ç»´æŠ¤
```

**ä¸ºä»€ä¹ˆè¦ç‹¬ç«‹APIæ¨¡å—ï¼Ÿ**

| å¯¹æ¯”é¡¹ | ç‹¬ç«‹APIæ¨¡å— | æœåŠ¡å†…å®šä¹‰ |
|--------|------------|-----------|
| ğŸ“¦ **å¤ç”¨æ€§** | å¤šä¸ªæœåŠ¡éƒ½èƒ½ç”¨åŒä¸€ä¸ªæ¥å£ | æ¯ä¸ªæœåŠ¡éƒ½è¦å¤åˆ¶ä¸€ä»½ |
| ğŸ”§ **ç»´æŠ¤æ€§** | æ”¹ä¸€å¤„ï¼Œæ‰€æœ‰åœ°æ–¹éƒ½æ›´æ–° | æ”¹æ¥å£è¦åˆ°å¤„æ”¹ï¼Œå®¹æ˜“æ¼ |
| ğŸ¯ **æ¸…æ™°åº¦** | æ¥å£å’Œå®ç°åˆ†ç¦»ï¼ŒèŒè´£æ¸…æ¥š | æ¥å£å’Œå®ç°æ··åœ¨ä¸€èµ· |
| âš¡ **ç‰ˆæœ¬ç®¡ç†** | ç»Ÿä¸€ç‰ˆæœ¬å·ï¼Œå¥½æ§åˆ¶ | ç‰ˆæœ¬å®¹æ˜“ä¸ä¸€è‡´ |

### 1.3 æ¥å£å‘½åè§„èŒƒ



**åŸºæœ¬åŸåˆ™**ï¼šè§åçŸ¥æ„ï¼Œä¸€çœ¼å°±çŸ¥é“è¿™ä¸ªæ¥å£æ˜¯å¹²ä»€ä¹ˆçš„

```java
// âœ… å¥½çš„å‘½åï¼ˆæ¨èï¼‰
@FeignClient(name = "product-service")
public interface ProductClient {
    
    // æŸ¥è¯¢å•†å“è¯¦æƒ… - è¯­ä¹‰æ˜ç¡®
    @GetMapping("/api/products/{id}")
    ProductDTO getProductById(@PathVariable Long id);
    
    // æ‰¹é‡æŸ¥è¯¢å•†å“ - è¯´æ˜äº†æ˜¯æ‰¹é‡æ“ä½œ
    @PostMapping("/api/products/batch")
    List<ProductDTO> getProductsByIds(@RequestBody List<Long> ids);
    
    // æ›´æ–°åº“å­˜ - åŠ¨è¯+åè¯ï¼Œæ¸…æ¥šæ˜äº†
    @PutMapping("/api/products/{id}/stock")
    void updateStock(@PathVariable Long id, @RequestParam Integer quantity);
}

// âŒ ä¸å¥½çš„å‘½åï¼ˆä¸æ¨èï¼‰
@FeignClient(name = "product-service")
public interface ProductAPI {
    
    // å‘½åå¤ªéšæ„ï¼Œçœ‹ä¸å‡ºæ˜¯å¹²ä»€ä¹ˆçš„
    @GetMapping("/api/products/{id}")
    ProductDTO get(@PathVariable Long id);
    
    // ç¼©å†™å¤ªå¤šï¼Œéš¾ç†è§£
    @PostMapping("/api/products/batch")
    List<ProductDTO> getBatch(@RequestBody List<Long> ids);
    
    // å‘½åä¸è§„èŒƒï¼Œupdateä»€ä¹ˆï¼Ÿ
    @PutMapping("/api/products/{id}/stock")
    void update(@PathVariable Long id, @RequestParam Integer quantity);
}
```

**å‘½åè§„åˆ™æ€»ç»“**ï¼š

ğŸ”¸ **æ¥å£ç±»å**ï¼š`æœåŠ¡å + Client`
- `OrderClient`ã€`ProductClient`ã€`UserClient`

ğŸ”¸ **æ–¹æ³•å**ï¼š`åŠ¨è¯ + ä¸šåŠ¡å¯¹è±¡ + Byæ¡ä»¶`
- `getOrderById`ã€`updateUserInfo`ã€`deleteProductByIds`

ğŸ”¸ **å‚æ•°å**ï¼šæœ‰æ„ä¹‰çš„ä¸šåŠ¡åç§°
- ç”¨`userId`è€Œä¸æ˜¯`id`
- ç”¨`pageSize`è€Œä¸æ˜¯`size`

### 1.4 å‚æ•°ä¼ é€’è§„èŒƒ



**æ ¸å¿ƒé—®é¢˜**ï¼šæ•°æ®æ€ä¹ˆä»AæœåŠ¡ä¼ åˆ°BæœåŠ¡ï¼Ÿ

```
å®¢æˆ·ç«¯ï¼ˆè®¢å•æœåŠ¡ï¼‰              æœåŠ¡ç«¯ï¼ˆå•†å“æœåŠ¡ï¼‰
      |                              |
      |---- å‚æ•°ä¼ é€’æ–¹å¼ ------------>|
      |                              |
      
å¸¸è§ä¼ é€’æ–¹å¼ï¼š
1ï¸âƒ£ @PathVariable  â†’  è·¯å¾„å‚æ•°ï¼ˆURLé‡Œçš„å‚æ•°ï¼‰
2ï¸âƒ£ @RequestParam   â†’  æŸ¥è¯¢å‚æ•°ï¼ˆ?åé¢çš„å‚æ•°ï¼‰
3ï¸âƒ£ @RequestBody    â†’  è¯·æ±‚ä½“å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰
4ï¸âƒ£ @RequestHeader  â†’  è¯·æ±‚å¤´å‚æ•°ï¼ˆæ”¾åœ¨Headeré‡Œï¼‰
```

**å®æˆ˜ç¤ºä¾‹**ï¼š

```java
@FeignClient(name = "order-service")
public interface OrderClient {
    
    // âœ… æ–¹å¼1ï¼šè·¯å¾„å‚æ•° - é€‚åˆå•ä¸ªå¿…å¡«å‚æ•°
    @GetMapping("/api/orders/{orderId}")
    OrderDTO getOrder(@PathVariable("orderId") Long orderId);
    
    // âœ… æ–¹å¼2ï¼šæŸ¥è¯¢å‚æ•° - é€‚åˆå¯é€‰å‚æ•°æˆ–ç®€å•å‚æ•°
    @GetMapping("/api/orders/search")
    List<OrderDTO> searchOrders(
        @RequestParam(required = false) String status,
        @RequestParam(required = false) Integer pageNum
    );
    
    // âœ… æ–¹å¼3ï¼šè¯·æ±‚ä½“ - é€‚åˆå¤æ‚å¯¹è±¡æˆ–æ‰¹é‡æ•°æ®
    @PostMapping("/api/orders/create")
    Long createOrder(@RequestBody OrderCreateRequest request);
    
    // âœ… æ–¹å¼4ï¼šè¯·æ±‚å¤´ - é€‚åˆä¼ é€’tokenã€è¿½è¸ªIDç­‰
    @GetMapping("/api/orders/user")
    List<OrderDTO> getUserOrders(
        @RequestHeader("Authorization") String token,
        @RequestHeader("X-Request-Id") String requestId
    );
}
```

**é€‰æ‹©å»ºè®®**ï¼š

| å‚æ•°ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|---------|---------|------|
| ğŸ”¹ **@PathVariable** | å•ä¸ªå¿…å¡«å‚æ•°ï¼Œèµ„æºæ ‡è¯† | `/orders/{id}` |
| ğŸ”¹ **@RequestParam** | ç®€å•æŸ¥è¯¢æ¡ä»¶ï¼Œå¯é€‰å‚æ•° | `/orders?status=PAID` |
| ğŸ”¹ **@RequestBody** | å¤æ‚å¯¹è±¡ï¼Œæ‰¹é‡æ“ä½œ | åˆ›å»ºè®¢å•ã€æ‰¹é‡æŸ¥è¯¢ |
| ğŸ”¹ **@RequestHeader** | è®¤è¯ä¿¡æ¯ï¼Œè¿½è¸ªä¿¡æ¯ | tokenã€requestId |

### 1.5 è¿”å›å€¼è®¾è®¡è§„èŒƒ



**ç»Ÿä¸€å“åº”æ ¼å¼**ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½ç”¨åŒä¸€ç§æ•°æ®ç»“æ„è¿”å›

```java
// ç»Ÿä¸€å“åº”åŒ…è£…ç±»ï¼ˆæ¨èä½¿ç”¨ï¼‰
public class Result<T> {
    private Integer code;      // å“åº”ç ï¼š200æˆåŠŸï¼Œ500å¤±è´¥
    private String message;    // æç¤ºä¿¡æ¯ï¼šæˆåŠŸæç¤ºæˆ–é”™è¯¯åŸå› 
    private T data;           // å®é™…æ•°æ®ï¼šè®¢å•ã€å•†å“ç­‰ä¸šåŠ¡æ•°æ®
    
    // æˆåŠŸè¿”å›
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.code = 200;
        result.message = "æ“ä½œæˆåŠŸ";
        result.data = data;
        return result;
    }
    
    // å¤±è´¥è¿”å›
    public static <T> Result<T> error(String message) {
        Result<T> result = new Result<>();
        result.code = 500;
        result.message = message;
        return result;
    }
}

// Feignæ¥å£ä½¿ç”¨ç»Ÿä¸€è¿”å›æ ¼å¼
@FeignClient(name = "order-service")
public interface OrderClient {
    
    // âœ… ä½¿ç”¨ç»Ÿä¸€è¿”å›æ ¼å¼
    @GetMapping("/api/orders/{id}")
    Result<OrderDTO> getOrder(@PathVariable Long id);
    
    // âœ… åˆ—è¡¨æŸ¥è¯¢ä¹Ÿç”¨ç»Ÿä¸€æ ¼å¼
    @GetMapping("/api/orders/list")
    Result<List<OrderDTO>> getOrderList(@RequestParam Long userId);
}
```

**ä¸ºä»€ä¹ˆè¦ç»Ÿä¸€è¿”å›æ ¼å¼ï¼Ÿ**

ğŸ¯ **è°ƒç”¨æ–¹å¥½å¤„ç†**ï¼šä¸ç”¨çŒœè¿”å›çš„æ˜¯ä»€ä¹ˆï¼Œéƒ½æŒ‰Resultè§£æ
ğŸ¯ **é”™è¯¯å¥½åŒºåˆ†**ï¼šé€šè¿‡codeç å°±çŸ¥é“æˆåŠŸè¿˜æ˜¯å¤±è´¥
ğŸ¯ **ä¿¡æ¯æ›´å®Œæ•´**ï¼šæˆåŠŸæœ‰æ•°æ®ï¼Œå¤±è´¥æœ‰åŸå› 

---

## 2. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ



### 2.1 ä¸ºä»€ä¹ˆè¦å¤„ç†å¼‚å¸¸



**çœŸå®åœºæ™¯**ï¼šç”¨æˆ·ä¸‹å•æ—¶ï¼Œè°ƒç”¨å•†å“æœåŠ¡æŸ¥åº“å­˜ï¼Œçªç„¶ç½‘ç»œæ–­äº†...

```
ä¸‹å•æµç¨‹å¼‚å¸¸ç¤ºæ„ï¼š
ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡ â†’ è°ƒç”¨å•†å“æœåŠ¡(ç½‘ç»œå¼‚å¸¸ï¼)
                          â†“
                      æ€ä¹ˆåŠï¼Ÿâ“
                      
å¦‚æœä¸å¤„ç†ï¼šç³»ç»Ÿç›´æ¥æŠ¥é”™500ï¼Œç”¨æˆ·çœ‹åˆ°ä¸€å †ä¹±ç 
å¦‚æœå¤„ç†å¥½ï¼šæç¤º"å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"
```

> âš ï¸ **é‡è¦æé†’**
> 
> å¾®æœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œè°ƒç”¨ï¼Œç½‘ç»œä¸ç¨³å®šã€æœåŠ¡å®•æœºéƒ½æ˜¯å¸¸æ€ï¼
> ä¸å¤„ç†å¼‚å¸¸ = ç»™ç”¨æˆ·çœ‹bug = ç”¨æˆ·æµå¤± ğŸ’”

### 2.2 Feignå¼‚å¸¸çš„ç±»å‹



**Feignè°ƒç”¨å¯èƒ½å‡ºç°çš„é—®é¢˜**ï¼š

| å¼‚å¸¸ç±»å‹ | ä»€ä¹ˆæ„æ€ | å¸¸è§åŸå›  | ä¸¾ä¾‹ |
|---------|---------|---------|------|
| ğŸ”´ **FeignException** | Feignè°ƒç”¨å¤±è´¥çš„æ€»å¼‚å¸¸ | ç½‘ç»œé—®é¢˜ã€æœåŠ¡é—®é¢˜ | ç½‘ç»œè¶…æ—¶ |
| ğŸ”´ **RetryableException** | å¯ä»¥é‡è¯•çš„å¼‚å¸¸ | ä¸´æ—¶ç½‘ç»œæŠ–åŠ¨ | è¯»å–è¶…æ—¶ |
| ğŸ”´ **DecodeException** | å“åº”è§£æå¤±è´¥ | è¿”å›æ•°æ®æ ¼å¼ä¸å¯¹ | è¿”å›äº†HTMLä¸æ˜¯JSON |
| ğŸ”´ **ConnectException** | è¿æ¥ä¸ä¸ŠæœåŠ¡ | æœåŠ¡æŒ‚äº†æˆ–åœ°å€é”™è¯¯ | å•†å“æœåŠ¡å®•æœº |

### 2.3 å…¨å±€å¼‚å¸¸å¤„ç†å™¨



**å®ç°æ–¹å¼**ï¼šç”¨ä¸€ä¸ª"å¼‚å¸¸ç®¡å®¶"ç»Ÿä¸€å¤„ç†æ‰€æœ‰Feignè°ƒç”¨çš„å¼‚å¸¸

```java
// å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼ˆæ¨èæ–¹å¼ï¼‰
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    // å¤„ç†Feignè°ƒç”¨å¼‚å¸¸
    @ExceptionHandler(FeignException.class)
    public Result<?> handleFeignException(FeignException e) {
        
        // æ ¹æ®HTTPçŠ¶æ€ç åˆ¤æ–­é—®é¢˜
        int status = e.status();
        
        if (status == 404) {
            return Result.error("è¯·æ±‚çš„æœåŠ¡ä¸å­˜åœ¨");
        } else if (status == 500) {
            return Result.error("æœåŠ¡ç«¯å¤„ç†å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        } else if (status == 503) {
            return Result.error("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        } else {
            return Result.error("æœåŠ¡è°ƒç”¨å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    // å¤„ç†è¿æ¥å¼‚å¸¸
    @ExceptionHandler(ConnectException.class)
    public Result<?> handleConnectException(ConnectException e) {
        return Result.error("æ— æ³•è¿æ¥åˆ°æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜");
    }
}
```

**å·¥ä½œåŸç†**ï¼š

```
è°ƒç”¨æµç¨‹ï¼š
OrderService â†’ Feignè°ƒç”¨ â†’ ProductService
                 â†“ å‡ºç°å¼‚å¸¸
        GlobalExceptionHandleræ•è·
                 â†“
        è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
```

### 2.4 è‡ªå®šä¹‰å¼‚å¸¸è§£ç å™¨



**é—®é¢˜**ï¼šæœåŠ¡ç«¯è¿”å›çš„ä¸šåŠ¡å¼‚å¸¸ï¼ŒFeignæ€ä¹ˆçŸ¥é“ï¼Ÿ

```java
// è‡ªå®šä¹‰å¼‚å¸¸è§£ç å™¨
@Component
public class CustomErrorDecoder implements ErrorDecoder {
    
    @Override
    public Exception decode(String methodKey, Response response) {
        
        // è·å–å“åº”çŠ¶æ€ç 
        int status = response.status();
        
        // è·å–å“åº”å†…å®¹
        String body = "æœªçŸ¥é”™è¯¯";
        try {
            body = Util.toString(response.body().asReader(StandardCharsets.UTF_8));
        } catch (IOException e) {
            // è¯»å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æç¤º
        }
        
        // æ ¹æ®çŠ¶æ€ç è¿”å›ä¸åŒå¼‚å¸¸
        if (status == 400) {
            return new BusinessException("å‚æ•°é”™è¯¯ï¼š" + body);
        } else if (status == 401) {
            return new BusinessException("æœªæˆæƒï¼Œè¯·å…ˆç™»å½•");
        } else if (status == 404) {
            return new BusinessException("èµ„æºä¸å­˜åœ¨");
        } else {
            return new BusinessException("æœåŠ¡å¼‚å¸¸ï¼š" + body);
        }
    }
}

// é…ç½®ä½¿ç”¨è‡ªå®šä¹‰è§£ç å™¨
@Configuration
public class FeignConfig {
    
    @Bean
    public ErrorDecoder errorDecoder() {
        return new CustomErrorDecoder();
    }
}
```

**è§£ç å™¨çš„ä½œç”¨**ï¼šæŠŠHTTPçŠ¶æ€ç å’Œå“åº”å†…å®¹ï¼Œç¿»è¯‘æˆæˆ‘ä»¬èƒ½ç†è§£çš„ä¸šåŠ¡å¼‚å¸¸

### 2.5 æœåŠ¡é™çº§å¤„ç†



**ä»€ä¹ˆæ˜¯é™çº§**ï¼šå½“è°ƒç”¨çš„æœåŠ¡å‡ºé—®é¢˜æ—¶ï¼Œæœ‰ä¸ª"å¤‡ç”¨æ–¹æ¡ˆ"ï¼Œä¸è®©ç³»ç»ŸæŒ‚æ‰

```java
// å®šä¹‰é™çº§å¤„ç†ç±»
@Component
public class ProductClientFallback implements ProductClient {
    
    @Override
    public Result<ProductDTO> getProduct(Long id) {
        // è¿”å›é»˜è®¤å•†å“ä¿¡æ¯ï¼ˆé™çº§æ•°æ®ï¼‰
        ProductDTO defaultProduct = new ProductDTO();
        defaultProduct.setId(id);
        defaultProduct.setName("å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
        defaultProduct.setPrice(0.0);
        
        return Result.success(defaultProduct);
    }
}

// Feignæ¥å£é…ç½®é™çº§
@FeignClient(
    name = "product-service",
    fallback = ProductClientFallback.class  // æŒ‡å®šé™çº§å¤„ç†ç±»
)
public interface ProductClient {
    
    @GetMapping("/api/products/{id}")
    Result<ProductDTO> getProduct(@PathVariable Long id);
}
```

**é™çº§æµç¨‹**ï¼š

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·æŸ¥è¯¢å•†å“ â†’ ProductService â†’ è¿”å›å•†å“è¯¦æƒ… âœ…

æœåŠ¡å¼‚å¸¸æ—¶ï¼š
ç”¨æˆ·æŸ¥è¯¢å•†å“ â†’ ProductService(æŒ‚äº†ï¼) 
              â†“
         è§¦å‘é™çº§é€»è¾‘
              â†“
         è¿”å›é»˜è®¤å•†å“ä¿¡æ¯ âœ…ï¼ˆè™½ç„¶ä¸å®Œç¾ï¼Œä½†ä¸ä¼šæŠ¥é”™ï¼‰
```

---

## 3. âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§



### 3.1 è¿æ¥æ± ä¼˜åŒ–



**é—®é¢˜**ï¼šæ¯æ¬¡è°ƒç”¨éƒ½å»ºç«‹æ–°è¿æ¥ï¼Œå¤ªæ…¢äº†ï¼

> ğŸ’¡ **è¿æ¥æ± åŸç†**ï¼ˆé€šä¿—è§£é‡Šï¼‰
> 
> å°±åƒå»é“¶è¡ŒåŠä¸šåŠ¡ï¼š
> - **æ²¡æœ‰è¿æ¥æ± **ï¼šæ¯æ¬¡éƒ½è¦é‡æ–°æ’é˜Ÿã€éªŒè¯èº«ä»½ï¼ˆæ…¢ï¼‰
> - **æœ‰è¿æ¥æ± **ï¼šæå‰å‡†å¤‡å¥½å‡ ä¸ªçª—å£ï¼Œæ¥äº†ç›´æ¥åŠï¼ˆå¿«ï¼‰

```java
// é…ç½®è¿æ¥æ± ï¼ˆapplication.ymlï¼‰
feign:
  httpclient:
    enabled: true                    # å¯ç”¨HttpClient
    max-connections: 200             # æœ€å¤§è¿æ¥æ•°ï¼ˆæ€»å…±200ä¸ªè¿æ¥ï¼‰
    max-connections-per-route: 50    # æ¯ä¸ªæœåŠ¡æœ€å¤š50ä¸ªè¿æ¥
    connection-timeout: 2000         # è¿æ¥è¶…æ—¶2ç§’
    
#  # æˆ–è€…ä½¿ç”¨OkHttpï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
  okhttp:
    enabled: true
```

**å‚æ•°å«ä¹‰**ï¼š

| å‚æ•° | é€šä¿—è§£é‡Š | æ¨èå€¼ |
|------|---------|-------|
| `max-connections` | æœ€å¤šèƒ½åŒæ—¶å¼€å¤šå°‘ä¸ªè¿æ¥ | 200 |
| `max-connections-per-route` | å¯¹å•ä¸ªæœåŠ¡æœ€å¤šç”¨å‡ ä¸ªè¿æ¥ | 50 |
| `connection-timeout` | è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | 2000 |

### 3.2 è¶…æ—¶æ—¶é—´é…ç½®



**æ ¸å¿ƒé—®é¢˜**ï¼šç­‰å¤šä¹…æ‰ç®—"ç­‰ä¸åˆ°äº†"ï¼Ÿ

```yaml
# å…¨å±€è¶…æ—¶é…ç½®

feign:
  client:
    config:
      default:  # é»˜è®¤é…ç½®ï¼Œå¯¹æ‰€æœ‰æœåŠ¡ç”Ÿæ•ˆ
        connectTimeout: 2000    # è¿æ¥è¶…æ—¶ï¼š2ç§’
        readTimeout: 5000       # è¯»å–è¶…æ—¶ï¼š5ç§’
      
#      # é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„é…ç½®ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
      product-service:
        connectTimeout: 3000    # å•†å“æœåŠ¡è¿æ¥è¶…æ—¶3ç§’
        readTimeout: 10000      # å•†å“æœåŠ¡è¯»å–è¶…æ—¶10ç§’
```

**è¶…æ—¶é…ç½®ç­–ç•¥**ï¼š

```
å¿«é€Ÿæ¥å£ï¼ˆæŸ¥è¯¢ï¼‰ï¼š
connectTimeout: 1-2ç§’
readTimeout: 3-5ç§’

æ…¢é€Ÿæ¥å£ï¼ˆè®¡ç®—ã€IOå¯†é›†ï¼‰ï¼š
connectTimeout: 2-3ç§’  
readTimeout: 10-30ç§’

æ ¸å¿ƒæ¥å£ï¼ˆæ”¯ä»˜ã€ä¸‹å•ï¼‰ï¼š
connectTimeout: 3-5ç§’
readTimeout: 30-60ç§’
```

### 3.3 æ•°æ®å‹ç¼©



**åŸç†**ï¼šä¼ è¾“æ•°æ®å‰å…ˆ"å‹ç¼©"ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“é‡

```yaml
# å¼€å¯è¯·æ±‚å’Œå“åº”å‹ç¼©

feign:
  compression:
    request:
      enabled: true                    # å¼€å¯è¯·æ±‚å‹ç¼©
      mime-types: text/xml,application/json  # å‹ç¼©è¿™äº›ç±»å‹çš„æ•°æ®
      min-request-size: 2048          # è¶…è¿‡2KBæ‰å‹ç¼©
    response:
      enabled: true                    # å¼€å¯å“åº”å‹ç¼©
      useGzipDecoder: true             # ä½¿ç”¨Gzipè§£ç 
```

**å‹ç¼©æ•ˆæœå¯¹æ¯”**ï¼š

```
ç¤ºä¾‹ï¼šä¼ è¾“10000ä¸ªå•†å“åˆ—è¡¨

ä¸å‹ç¼©ï¼š
  æ•°æ®å¤§å°ï¼š500KB
  ä¼ è¾“æ—¶é—´ï¼š2ç§’

å¼€å¯å‹ç¼©ï¼š
  å‹ç¼©åå¤§å°ï¼š100KBï¼ˆå‹ç¼©ç‡80%ï¼‰
  ä¼ è¾“æ—¶é—´ï¼š0.5ç§’ âš¡ï¼ˆå¿«4å€ï¼‰
```

### 3.4 æ‰¹é‡è°ƒç”¨ä¼˜åŒ–



**åœºæ™¯**ï¼šè®¢å•æœåŠ¡éœ€è¦æŸ¥è¯¢100ä¸ªå•†å“çš„ä¿¡æ¯ï¼Œæ€ä¹ˆè°ƒç”¨æœ€å¿«ï¼Ÿ

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šå¾ªç¯è°ƒç”¨100æ¬¡
for (Long productId : productIds) {
    ProductDTO product = productClient.getProduct(productId);
    // 100æ¬¡ç½‘ç»œè°ƒç”¨ï¼Œå¤ªæ…¢äº†ï¼
}

// âœ… å¥½çš„åšæ³•ï¼šä¸€æ¬¡æ‰¹é‡æŸ¥è¯¢
@FeignClient(name = "product-service")
public interface ProductClient {
    
    // æ‰¹é‡æŸ¥è¯¢æ¥å£
    @PostMapping("/api/products/batch")
    Result<List<ProductDTO>> getProductsBatch(@RequestBody List<Long> productIds);
}

// è°ƒç”¨æ—¶
List<ProductDTO> products = productClient.getProductsBatch(productIds);
// åªæœ‰1æ¬¡ç½‘ç»œè°ƒç”¨ï¼Œå¿«å¤šäº†ï¼
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

| è°ƒç”¨æ–¹å¼ | ç½‘ç»œè¯·æ±‚æ¬¡æ•° | è€—æ—¶ |
|---------|------------|------|
| å¾ªç¯è°ƒç”¨ | 100æ¬¡ | çº¦3ç§’ |
| æ‰¹é‡è°ƒç”¨ | 1æ¬¡ | çº¦0.1ç§’ |

---

## 4. ğŸ” è°ƒç”¨é“¾è·¯è¿½è¸ª



### 4.1 ä¸ºä»€ä¹ˆéœ€è¦é“¾è·¯è¿½è¸ª



**çœŸå®é—®é¢˜**ï¼šç”¨æˆ·åé¦ˆ"ä¸‹å•å¾ˆæ…¢"ï¼Œæ€ä¹ˆæ’æŸ¥ï¼Ÿ

```
ä¸‹å•æµç¨‹æ¶‰åŠå¤šä¸ªæœåŠ¡ï¼š
ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡ â†’ å•†å“æœåŠ¡ï¼ˆæŸ¥åº“å­˜ï¼‰
                   â†“
                åº“å­˜æœåŠ¡ï¼ˆæ‰£åº“å­˜ï¼‰
                   â†“
                æ”¯ä»˜æœåŠ¡ï¼ˆåˆ›å»ºæ”¯ä»˜å•ï¼‰
                
åˆ°åº•æ˜¯å“ªä¸ªæœåŠ¡æ…¢ï¼Ÿ â“
```

> ğŸ’¡ **é“¾è·¯è¿½è¸ª**ï¼šç»™æ¯ä¸ªè¯·æ±‚å‘ä¸€ä¸ª"èº«ä»½è¯å·"ï¼Œè®°å½•å®ƒç»è¿‡äº†å“ªäº›æœåŠ¡ï¼Œåœ¨æ¯ä¸ªæœåŠ¡èŠ±äº†å¤šä¹…

### 4.2 Sleuthé“¾è·¯è¿½è¸ª



**SleuthåŸç†**ï¼šè‡ªåŠ¨ç»™æ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€IDï¼Œè·Ÿè¸ªæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹

```xml
<!-- å¼•å…¥ä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š

```
è®¢å•æœåŠ¡æ—¥å¿—ï¼š
[order-service,abc123,abc123,true] æ¥æ”¶åˆ°ä¸‹å•è¯·æ±‚

å•†å“æœåŠ¡æ—¥å¿—ï¼š
[product-service,abc123,def456,true] æŸ¥è¯¢å•†å“åº“å­˜

åº“å­˜æœåŠ¡æ—¥å¿—ï¼š
[stock-service,abc123,ghi789,true] æ‰£å‡åº“å­˜æˆåŠŸ
```

**æ—¥å¿—æ ¼å¼è§£è¯»**ï¼š

```
[æœåŠ¡å, TraceId, SpanId, æ˜¯å¦è¾“å‡º]
         â†‘        â†‘       â†‘
         |        |       |
    è¯·æ±‚å”¯ä¸€ID  å½“å‰æ“ä½œID  æ˜¯å¦é‡‡æ ·
    
TraceIdï¼šabc123ï¼ˆæ•´ä¸ªè¯·æ±‚é“¾è·¯çš„å”¯ä¸€æ ‡è¯†ï¼‰
SpanIdï¼šæ¯ä¸ªæœåŠ¡æ“ä½œçš„å”¯ä¸€æ ‡è¯†
```

### 4.3 Zipkinå¯è§†åŒ–è¿½è¸ª



**Zipkinä½œç”¨**ï¼šæŠŠè¿½è¸ªæ•°æ®ç”¨å›¾è¡¨å±•ç¤ºï¼Œä¸€çœ¼çœ‹å‡ºå“ªé‡Œæ…¢

```yaml
# é…ç½®Zipkin

spring:
  zipkin:
    base-url: http://localhost:9411  # ZipkinæœåŠ¡åœ°å€
  sleuth:
    sampler:
      probability: 1.0                # é‡‡æ ·ç‡100%ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®0.1ï¼‰
```

**Zipkinç•Œé¢å±•ç¤º**ï¼š

```
è¯·æ±‚é“¾è·¯æ—¶åºå›¾ï¼š
                    æ€»è€—æ—¶ï¼š580ms
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡                         200ms   â”‚
â”‚  â”œâ”€ å•†å“æœåŠ¡                    150ms   â”‚
â”‚  â”‚   â””â”€ ç¼“å­˜æŸ¥è¯¢                 50ms   â”‚
â”‚  â”œâ”€ åº“å­˜æœåŠ¡                    100ms   â”‚
â”‚  â””â”€ æ”¯ä»˜æœåŠ¡                    130ms   â”‚ â† å‘ç°æ”¯ä»˜æœåŠ¡æœ€æ…¢ï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 è‡ªå®šä¹‰é“¾è·¯ä¿¡æ¯



**åœºæ™¯**ï¼šæƒ³åœ¨è¿½è¸ªä¿¡æ¯é‡ŒåŠ ä¸Šç”¨æˆ·IDã€è®¢å•å·ç­‰ä¸šåŠ¡ä¿¡æ¯

```java
@Service
public class OrderService {
    
    @Autowired
    private Tracer tracer;  // Sleuthçš„è¿½è¸ªå™¨
    
    public void createOrder(OrderRequest request) {
        
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        Span span = tracer.currentSpan();
        if (span != null) {
            span.tag("userId", request.getUserId().toString());
            span.tag("orderId", request.getOrderId());
            span.tag("totalAmount", request.getAmount().toString());
        }
        
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

**æ•ˆæœ**ï¼šåœ¨Zipkiné‡Œèƒ½çœ‹åˆ°è¿™äº›ä¸šåŠ¡ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜

---

## 5. ğŸ§ª å•å…ƒæµ‹è¯•æ–¹æ³•



### 5.1 ä¸ºä»€ä¹ˆè¦æµ‹è¯•Feignæ¥å£



**æ²¡æœ‰æµ‹è¯•çš„åæœ**ï¼š

```
å¼€å‘ï¼šå†™å®Œä»£ç ï¼Œè‡ªä¿¡æ»¡æ»¡ ğŸ˜Š
ä¸Šçº¿ï¼šè°ƒç”¨å¤±è´¥ï¼ŒæœåŠ¡å´©æºƒ ğŸ’¥
ç”¨æˆ·ï¼šè®¢å•ä¸¢äº†ï¼ŒæŠ•è¯‰çˆ†ç‚¸ ğŸ˜¡
è€æ¿ï¼šè¿™ä¸ªæœˆå¥–é‡‘æ²¡äº† ğŸ˜­
```

> âš ï¸ **æµ‹è¯•çš„é‡è¦æ€§**
> 
> æµ‹è¯•ä¸æ˜¯æµªè´¹æ—¶é—´ï¼Œè€Œæ˜¯åœ¨ç»™ä»£ç "ä¹°ä¿é™©"ï¼

### 5.2 Mockæµ‹è¯•æ–¹å¼



**MockåŸç†**ï¼šä¸çœŸæ­£è°ƒç”¨æœåŠ¡ï¼Œè€Œæ˜¯"å‡è£…"è°ƒç”¨æˆåŠŸ

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class OrderServiceTest {
    
    @Autowired
    private OrderService orderService;
    
    @MockBean  // æ¨¡æ‹ŸFeignå®¢æˆ·ç«¯
    private ProductClient productClient;
    
    @Test
    public void testCreateOrder() {
        // 1. å‡†å¤‡æµ‹è¯•æ•°æ®
        Long productId = 1L;
        
        // 2. æ¨¡æ‹ŸFeignè°ƒç”¨è¿”å›çš„æ•°æ®
        ProductDTO mockProduct = new ProductDTO();
        mockProduct.setId(productId);
        mockProduct.setName("æµ‹è¯•å•†å“");
        mockProduct.setPrice(99.0);
        mockProduct.setStock(100);
        
        // 3. å‘Šè¯‰Mockï¼šè°ƒç”¨æ—¶è¿”å›è¿™ä¸ªå‡æ•°æ®
        when(productClient.getProduct(productId))
            .thenReturn(Result.success(mockProduct));
        
        // 4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆä¼šç”¨åˆ°ä¸Šé¢çš„å‡æ•°æ®ï¼‰
        OrderDTO order = orderService.createOrder(productId, 2);
        
        // 5. éªŒè¯ç»“æœ
        assertNotNull(order);
        assertEquals(198.0, order.getTotalAmount());
    }
}
```

**Mockæµ‹è¯•çš„å¥½å¤„**ï¼š

ğŸ¯ **ä¸ä¾èµ–çœŸå®æœåŠ¡**ï¼šå…¶ä»–æœåŠ¡æŒ‚äº†ä¹Ÿèƒ½æµ‹è¯•
ğŸ¯ **é€Ÿåº¦å¿«**ï¼šä¸ç”¨ç­‰ç½‘ç»œè¯·æ±‚
ğŸ¯ **æ•°æ®å¯æ§**ï¼šæƒ³æµ‹ä»€ä¹ˆæƒ…å†µå°±é€ ä»€ä¹ˆæ•°æ®

### 5.3 WireMockæ¨¡æ‹ŸæœåŠ¡



**WireMockä½œç”¨**ï¼šå¯åŠ¨ä¸€ä¸ª"å‡çš„æœåŠ¡"ï¼Œæ¨¡æ‹ŸçœŸå®HTTPè°ƒç”¨

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class OrderServiceIntegrationTest {
    
    @Rule
    public WireMockRule wireMockRule = new WireMockRule(8089);
    
    @Autowired
    private OrderService orderService;
    
    @Test
    public void testCallProductService() {
        // 1. é…ç½®å‡æœåŠ¡çš„å“åº”è§„åˆ™
        stubFor(get(urlEqualTo("/api/products/1"))
            .willReturn(aResponse()
                .withStatus(200)
                .withHeader("Content-Type", "application/json")
                .withBody("{\"code\":200,\"data\":{\"id\":1,\"name\":\"å•†å“A\"}}")
            ));
        
        // 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼ˆä¼šè¯·æ±‚ä¸Šé¢çš„å‡æœåŠ¡ï¼‰
        OrderDTO order = orderService.createOrder(1L, 2);
        
        // 3. éªŒè¯æ˜¯å¦çœŸçš„è°ƒç”¨äº†
        verify(getRequestedFor(urlEqualTo("/api/products/1")));
        
        // 4. éªŒè¯ä¸šåŠ¡ç»“æœ
        assertNotNull(order);
    }
}
```

### 5.4 å¥‘çº¦æµ‹è¯•



**ä»€ä¹ˆæ˜¯å¥‘çº¦æµ‹è¯•**ï¼šç¡®ä¿"è°ƒç”¨æ–¹æœŸæœ›çš„æ¥å£"å’Œ"æœåŠ¡æ–¹æä¾›çš„æ¥å£"æ˜¯ä¸€è‡´çš„

```java
// æœåŠ¡æä¾›æ–¹ï¼ˆå•†å“æœåŠ¡ï¼‰å®šä¹‰å¥‘çº¦
@AutoConfigureMessageVerifier
public class ProductContractTest {
    
    @Test
    public void should_return_product_by_id() {
        // å®šä¹‰å¥‘çº¦ï¼šGET /api/products/1 åº”è¯¥è¿”å›å•†å“ä¿¡æ¯
        given()
            .queryParam("id", 1)
        .when()
            .get("/api/products")
        .then()
            .statusCode(200)
            .body("data.id", equalTo(1))
            .body("data.name", notNullValue());
    }
}

// æœåŠ¡è°ƒç”¨æ–¹ï¼ˆè®¢å•æœåŠ¡ï¼‰éªŒè¯å¥‘çº¦
@SpringBootTest
public class ProductClientContractTest {
    
    @Autowired
    private ProductClient productClient;
    
    @Test
    public void should_call_product_service() {
        // è°ƒç”¨Feignæ¥å£
        Result<ProductDTO> result = productClient.getProduct(1L);
        
        // éªŒè¯è¿”å›çš„æ•°æ®ç¬¦åˆå¥‘çº¦
        assertNotNull(result);
        assertEquals(200, result.getCode());
        assertNotNull(result.getData());
    }
}
```

---

## 6. ğŸ”§ å¸¸è§é—®é¢˜è§£å†³



### 6.1 è¶…æ—¶é—®é¢˜æ’æŸ¥



**ç°è±¡**ï¼šè°ƒç”¨æœåŠ¡æ—¶ç»å¸¸è¶…æ—¶

**æ’æŸ¥æ­¥éª¤**ï¼š

```
æ­¥éª¤1ï¸âƒ£ï¼šæ£€æŸ¥è¶…æ—¶é…ç½®æ˜¯å¦åˆç†
  â†’ æŸ¥çœ‹ feign.client.config.default.readTimeout
  â†’ ç¡®è®¤æ˜¯å¦è®¾ç½®äº†å…¨å±€å’ŒæœåŠ¡çº§åˆ«çš„è¶…æ—¶

æ­¥éª¤2ï¸âƒ£ï¼šç¡®è®¤æ˜¯å“ªä¸ªç¯èŠ‚è¶…æ—¶
  â†’ è¿æ¥è¶…æ—¶ï¼Ÿ â†’ æ£€æŸ¥ç½‘ç»œã€æœåŠ¡åœ°å€
  â†’ è¯»å–è¶…æ—¶ï¼Ÿ â†’ æ£€æŸ¥æœåŠ¡å¤„ç†é€Ÿåº¦

æ­¥éª¤3ï¸âƒ£ï¼šè°ƒæ•´è¶…æ—¶æ—¶é—´
  â†’ æ…¢æ¥å£åŠ é•¿è¶…æ—¶æ—¶é—´
  â†’ å¿«æ¥å£ç¼©çŸ­è¶…æ—¶æ—¶é—´

æ­¥éª¤4ï¸âƒ£ï¼šä¼˜åŒ–æœåŠ¡æ€§èƒ½
  â†’ åŠ ç¼“å­˜ã€åŠ ç´¢å¼•ã€ä¼˜åŒ–SQL
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
feign:
  client:
    config:
      slow-service:  # æ…¢æœåŠ¡ç‰¹æ®Šå¤„ç†
        connectTimeout: 5000
        readTimeout: 30000
```

### 6.2 å‚æ•°ä¼ é€’å¤±è´¥



**é—®é¢˜**ï¼šå‚æ•°ä¼ è¿‡å»äº†ï¼Œä½†æœåŠ¡ç«¯æ¥æ”¶ä¸åˆ°

```java
// âŒ é”™è¯¯å†™æ³•ï¼šGETè¯·æ±‚ç”¨@RequestBody
@GetMapping("/api/orders")
Result<List<OrderDTO>> getOrders(@RequestBody OrderQuery query);
// GETè¯·æ±‚ä¸èƒ½ç”¨RequestBodyï¼

// âœ… æ­£ç¡®å†™æ³•ï¼šç”¨@SpringQueryMap
@GetMapping("/api/orders")
Result<List<OrderDTO>> getOrders(@SpringQueryMap OrderQuery query);
// è‡ªåŠ¨æŠŠå¯¹è±¡è½¬æˆæŸ¥è¯¢å‚æ•°

// âŒ é”™è¯¯å†™æ³•ï¼šPOSTè¯·æ±‚å¿˜è®°åŠ @RequestBody
@PostMapping("/api/orders")
Result<Long> createOrder(OrderRequest request);
// POSTçš„å¯¹è±¡å‚æ•°å¿…é¡»åŠ @RequestBody

// âœ… æ­£ç¡®å†™æ³•
@PostMapping("/api/orders")
Result<Long> createOrder(@RequestBody OrderRequest request);
```

### 6.3 æœåŠ¡è°ƒç”¨å¤±è´¥



**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| ğŸ”´ **Connect refused** | æœåŠ¡æ²¡å¯åŠ¨ | å¯åŠ¨å¯¹åº”æœåŠ¡ |
| ğŸ”´ **UnknownHostException** | æœåŠ¡åé”™è¯¯ | æ£€æŸ¥@FeignClientçš„name |
| ğŸ”´ **404 Not Found** | URLè·¯å¾„é”™è¯¯ | æ£€æŸ¥@GetMappingçš„è·¯å¾„ |
| ğŸ”´ **400 Bad Request** | å‚æ•°æ ¼å¼é”™è¯¯ | æ£€æŸ¥å‚æ•°æ³¨è§£å’Œç±»å‹ |
| ğŸ”´ **500 Internal Error** | æœåŠ¡ç«¯å¼‚å¸¸ | æŸ¥çœ‹æœåŠ¡ç«¯æ—¥å¿— |

### 6.4 å¾ªç¯ä¾èµ–é—®é¢˜



**åœºæ™¯**ï¼šAæœåŠ¡è°ƒç”¨BæœåŠ¡ï¼ŒBæœåŠ¡åˆè°ƒç”¨AæœåŠ¡

```
âŒ å¾ªç¯è°ƒç”¨å¯¼è‡´é—®é¢˜ï¼š
OrderService â†’ ProductService â†’ OrderService â†’ æ­»å¾ªç¯ï¼
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```
æ–¹æ¡ˆ1ï¸âƒ£ï¼šé‡æ–°è®¾è®¡è°ƒç”¨å…³ç³»
  â†’ è®©è°ƒç”¨å…³ç³»å•å‘æµåŠ¨
  â†’ OrderService â†’ ProductServiceï¼ˆä¸å†å›è°ƒï¼‰

æ–¹æ¡ˆ2ï¸âƒ£ï¼šæŠ½å–å…¬å…±æœåŠ¡
  â†’ æŠŠå…¬å…±é€»è¾‘æŠ½åˆ°ç‹¬ç«‹æœåŠ¡
  â†’ OrderService â†˜
                 â†’ CommonService
  â†’ ProductService â†—

æ–¹æ¡ˆ3ï¸âƒ£ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
  â†’ OrderService â†’ MQ â†’ ProductService
  â†’ å¼‚æ­¥è§£è€¦ï¼Œä¸ç›´æ¥è°ƒç”¨
```

---

## 7. ğŸ“Š ç›‘æ§æŒ‡æ ‡æ”¶é›†



### 7.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡



**éœ€è¦ç›‘æ§ä»€ä¹ˆï¼Ÿ**

| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | é€šä¿—è§£é‡Š | æ­£å¸¸å€¼ |
|---------|---------|---------|--------|
| ğŸ“ˆ **è°ƒç”¨é‡** | QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ | æ¯ç§’è°ƒç”¨å¤šå°‘æ¬¡ | æ ¹æ®ä¸šåŠ¡ |
| â±ï¸ **å“åº”æ—¶é—´** | P99ã€P95ã€å¹³å‡å€¼ | å¤§éƒ¨åˆ†è¯·æ±‚å¤šå¿«å®Œæˆ | <200ms |
| âŒ **é”™è¯¯ç‡** | å¤±è´¥æ¬¡æ•°/æ€»æ¬¡æ•° | æœ‰å¤šå°‘è¯·æ±‚å¤±è´¥äº† | <1% |
| ğŸ”„ **é‡è¯•æ¬¡æ•°** | é‡è¯•ç»Ÿè®¡ | è°ƒç”¨å¤±è´¥é‡è¯•äº†å‡ æ¬¡ | <10% |
| ğŸ”Œ **è¿æ¥æ± ** | æ´»è·ƒè¿æ¥æ•° | æ­£åœ¨ç”¨å‡ ä¸ªè¿æ¥ | <æœ€å¤§å€¼80% |

### 7.2 é›†æˆPrometheus



**Prometheusä½œç”¨**ï¼šæ”¶é›†å’Œå­˜å‚¨ç›‘æ§æ•°æ®

```xml
<!-- å¼•å…¥ä¾èµ– -->
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

```yaml
# å¼€å¯ç›‘æ§ç«¯ç‚¹

management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,info  # æš´éœ²ç›‘æ§æ¥å£
  metrics:
    tags:
      application: ${spring.application.name}  # æ·»åŠ åº”ç”¨åæ ‡ç­¾
```

**è®¿é—®ç›‘æ§æ•°æ®**ï¼š

```bash
# æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡

curl http://localhost:8080/actuator/prometheus

# è¾“å‡ºç¤ºä¾‹ï¼š

# HELP feign_Client_seconds Feignè°ƒç”¨è€—æ—¶

# TYPE feign_Client_seconds summary

feign_Client_seconds_count{client="ProductClient",method="getProduct"} 1543
feign_Client_seconds_sum{client="ProductClient",method="getProduct"} 123.45
```

### 7.3 Grafanaå¯è§†åŒ–çœ‹æ¿



**Grafanaä½œç”¨**ï¼šæŠŠç›‘æ§æ•°æ®ç”»æˆå›¾è¡¨

**é…ç½®æ­¥éª¤**ï¼š

```
æ­¥éª¤1ï¸âƒ£ï¼šå¯åŠ¨Grafana
docker run -d -p 3000:3000 grafana/grafana

æ­¥éª¤2ï¸âƒ£ï¼šæ·»åŠ Prometheusæ•°æ®æº
  â†’ Grafanaç•Œé¢ â†’ Configuration â†’ Data Sources
  â†’ é€‰æ‹©Prometheusï¼Œå¡«å…¥åœ°å€ï¼šhttp://localhost:9090

æ­¥éª¤3ï¸âƒ£ï¼šå¯¼å…¥Dashboardæ¨¡æ¿
  â†’ ä½¿ç”¨æ¨¡æ¿IDï¼š11378ï¼ˆSpring Bootç»Ÿè®¡ï¼‰
  â†’ æˆ–è‡ªå®šä¹‰é¢æ¿

æ­¥éª¤4ï¸âƒ£ï¼šæŸ¥çœ‹ç›‘æ§å›¾è¡¨
  â†’ è°ƒç”¨é‡æ›²çº¿å›¾
  â†’ å“åº”æ—¶é—´åˆ†å¸ƒå›¾  
  â†’ é”™è¯¯ç‡è¶‹åŠ¿å›¾
```

**çœ‹æ¿ç¤ºä¾‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Feignè°ƒç”¨ç›‘æ§çœ‹æ¿                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  ğŸ“Š è°ƒç”¨é‡(QPS)                         â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘  125/s                   â”‚
â”‚                                         â”‚
â”‚  â±ï¸ å“åº”æ—¶é—´(P99)                       â”‚
â”‚  â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  180ms                    â”‚
â”‚                                         â”‚
â”‚  âŒ é”™è¯¯ç‡                              â”‚
â”‚  â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0.5%                     â”‚
â”‚                                         â”‚
â”‚  ğŸ”„ é‡è¯•ç‡                              â”‚
â”‚  â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  2.3%                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 å‘Šè­¦è§„åˆ™é…ç½®



**ä»€ä¹ˆæ—¶å€™éœ€è¦å‘Šè­¦ï¼Ÿ**

```yaml
# Prometheuså‘Šè­¦è§„åˆ™é…ç½®

groups:
  - name: feign_alerts
    rules:
#      # é”™è¯¯ç‡è¶…è¿‡5%å‘Šè­¦
      - alert: FeignHighErrorRate
        expr: |
          sum(rate(feign_Client_seconds_count{status="error"}[5m])) 
          / 
          sum(rate(feign_Client_seconds_count[5m])) > 0.05
        for: 2m
        annotations:
          summary: "Feignè°ƒç”¨é”™è¯¯ç‡è¿‡é«˜"
          description: "{{ $labels.client }}é”™è¯¯ç‡è¾¾åˆ°{{ $value }}%"
      
#      # å“åº”æ—¶é—´è¶…è¿‡1ç§’å‘Šè­¦
      - alert: FeignSlowResponse  
        expr: |
          histogram_quantile(0.99, 
            rate(feign_Client_seconds_bucket[5m])
          ) > 1
        for: 5m
        annotations:
          summary: "Feignè°ƒç”¨å“åº”æ…¢"
          description: "{{ $labels.client }}çš„P99å“åº”æ—¶é—´{{ $value }}ç§’"
```

**å‘Šè­¦é€šçŸ¥é…ç½®**ï¼š

```yaml
# å‘Šè­¦æ¥æ”¶å™¨é…ç½®

receivers:
  - name: 'team-ops'
    webhook_configs:
      - url: 'http://alertmanager:9093/api/webhooks/dingtalk'  # é’‰é’‰é€šçŸ¥
    email_configs:
      - to: 'ops@company.com'  # é‚®ä»¶é€šçŸ¥

# å‘Šè­¦è·¯ç”±è§„åˆ™

route:
  receiver: 'team-ops'
  group_by: ['alertname', 'client']
  group_wait: 30s       # ç­‰30ç§’å†å‘é€ï¼ˆèšåˆç›¸åŒå‘Šè­¦ï¼‰
  group_interval: 5m    # åŒç»„å‘Šè­¦é—´éš”5åˆ†é’Ÿ
  repeat_interval: 1h   # é‡å¤å‘Šè­¦é—´éš”1å°æ—¶
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 æ¥å£è®¾è®¡å…³é”®ç‚¹



âœ… **ç‹¬ç«‹APIæ¨¡å—**ï¼šæ¥å£å®šä¹‰å•ç‹¬æŠ½å–ï¼Œæ–¹ä¾¿å¤ç”¨å’Œç»´æŠ¤
âœ… **å‘½åè¦è§„èŒƒ**ï¼šè§åçŸ¥æ„ï¼Œ`æœåŠ¡åClient`ã€`åŠ¨è¯+å¯¹è±¡`
âœ… **å‚æ•°ä¼ é€’è¦å¯¹**ï¼šGETç”¨QueryMapï¼ŒPOSTç”¨RequestBody
âœ… **ç»Ÿä¸€è¿”å›æ ¼å¼**ï¼šç”¨ResultåŒ…è£…ï¼Œcode+message+data

### 8.2 å¼‚å¸¸å¤„ç†å…³é”®ç‚¹



âœ… **å…¨å±€å¼‚å¸¸å¤„ç†**ï¼šç”¨`@RestControllerAdvice`ç»Ÿä¸€å¤„ç†
âœ… **è‡ªå®šä¹‰è§£ç å™¨**ï¼šæŠŠHTTPé”™è¯¯ç¿»è¯‘æˆä¸šåŠ¡å¼‚å¸¸  
âœ… **é…ç½®é™çº§é€»è¾‘**ï¼šæœåŠ¡æŒ‚äº†æœ‰å¤‡ç”¨æ–¹æ¡ˆï¼Œä¸è®©ç³»ç»Ÿå´©æºƒ
âœ… **å‹å¥½é”™è¯¯æç¤º**ï¼šå‘Šè¯‰ç”¨æˆ·å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä¸è¦è¿”å›ä¸€å †ä¹±ç 

### 8.3 æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹



âœ… **ç”¨è¿æ¥æ± **ï¼šæå‰å‡†å¤‡å¥½è¿æ¥ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»ºç«‹
âœ… **é…è¶…æ—¶æ—¶é—´**ï¼šå¿«æ…¢æ¥å£åˆ†å¼€é…ç½®ï¼Œä¸è¦ä¸€åˆ€åˆ‡
âœ… **å¼€å¯å‹ç¼©**ï¼šæ•°æ®å¤§äº2KBè‡ªåŠ¨å‹ç¼©ï¼Œä¼ è¾“æ›´å¿«
âœ… **æ‰¹é‡è°ƒç”¨**ï¼šèƒ½ä¸€æ¬¡è°ƒç”¨çš„åˆ«å¾ªç¯å¤šæ¬¡è°ƒç”¨

### 8.4 é“¾è·¯è¿½è¸ªå…³é”®ç‚¹



âœ… **é›†æˆSleuth**ï¼šè‡ªåŠ¨ç”ŸæˆTraceIdï¼Œæ—¥å¿—é‡Œèƒ½çœ‹åˆ°
âœ… **ä½¿ç”¨Zipkin**ï¼šå¯è§†åŒ–è°ƒç”¨é“¾è·¯ï¼Œä¸€çœ¼çœ‹å‡ºå“ªé‡Œæ…¢
âœ… **æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾**ï¼šä¸šåŠ¡å­—æ®µï¼ˆç”¨æˆ·IDã€è®¢å•å·ï¼‰ä¹Ÿè®°å½•
âœ… **åˆç†é‡‡æ ·ç‡**ï¼šç”Ÿäº§ç¯å¢ƒ10%é‡‡æ ·ï¼Œå¼€å‘ç¯å¢ƒ100%

### 8.5 æµ‹è¯•æ–¹æ³•å…³é”®ç‚¹



âœ… **Mockæµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ç”¨@MockBeanï¼Œä¸ä¾èµ–çœŸå®æœåŠ¡
âœ… **WireMocké›†æˆæµ‹è¯•**ï¼šå¯åŠ¨å‡æœåŠ¡ï¼Œæ¨¡æ‹ŸçœŸå®HTTPè°ƒç”¨
âœ… **å¥‘çº¦æµ‹è¯•**ï¼šç¡®ä¿æ¥å£æä¾›æ–¹å’Œè°ƒç”¨æ–¹ä¸€è‡´
âœ… **æµ‹è¯•è¦†ç›–**ï¼šæ­£å¸¸ã€å¼‚å¸¸ã€è¾¹ç•Œæƒ…å†µéƒ½è¦æµ‹åˆ°

### 8.6 å¸¸è§é—®é¢˜å…³é”®ç‚¹



âœ… **è¶…æ—¶é—®é¢˜**ï¼šæ£€æŸ¥é…ç½®ã€ä¼˜åŒ–æœåŠ¡ã€è°ƒæ•´æ—¶é—´
âœ… **å‚æ•°é—®é¢˜**ï¼šGETç”¨SpringQueryMapã€POSTç”¨RequestBody
âœ… **è°ƒç”¨å¤±è´¥**ï¼šçœ‹é”™è¯¯ç ã€æŸ¥æ—¥å¿—ã€æ£€æŸ¥é…ç½®
âœ… **å¾ªç¯ä¾èµ–**ï¼šé‡æ–°è®¾è®¡ã€æŠ½å…¬å…±æœåŠ¡ã€ç”¨MQè§£è€¦

### 8.7 ç›‘æ§å‘Šè­¦å…³é”®ç‚¹



âœ… **æ ¸å¿ƒæŒ‡æ ‡**ï¼šQPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€é‡è¯•ç‡
âœ… **Prometheusæ”¶é›†**ï¼šæš´éœ²metricsç«¯ç‚¹ï¼Œå®šæ—¶é‡‡é›†
âœ… **Grafanaå±•ç¤º**ï¼šå¯¼å…¥æ¨¡æ¿ï¼Œå¯è§†åŒ–å›¾è¡¨
âœ… **é…ç½®å‘Šè­¦**ï¼šé”™è¯¯ç‡>5%ã€å“åº”æ—¶é—´>1såŠæ—¶é€šçŸ¥

---

# ğŸ¯ æœ€ä½³å®è·µæ¸…å•



## âœ… å¼€å‘é˜¶æ®µ


- [ ] æ¥å£å®šä¹‰æ”¾åœ¨ç‹¬ç«‹çš„APIæ¨¡å—
- [ ] æ¥å£å‘½åéµå¾ªè§„èŒƒï¼ˆæœåŠ¡å+Clientï¼‰
- [ ] é…ç½®ç»Ÿä¸€è¿”å›æ ¼å¼Result
- [ ] ç¼–å†™Mockå•å…ƒæµ‹è¯•

## âœ… ä¸Šçº¿é˜¶æ®µ  


- [ ] é…ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- [ ] é…ç½®è¿æ¥æ± å‚æ•°
- [ ] å¼€å¯è¯·æ±‚å“åº”å‹ç¼©
- [ ] å®ç°é™çº§é€»è¾‘

## âœ… è¿ç»´é˜¶æ®µ


- [ ] é›†æˆSleuthå’ŒZipkinè¿½è¸ª
- [ ] æ¥å…¥Prometheusç›‘æ§
- [ ] é…ç½®Grafanaçœ‹æ¿
- [ ] è®¾ç½®å‘Šè­¦è§„åˆ™

## âœ… ä¼˜åŒ–é˜¶æ®µ


- [ ] æ‰¹é‡è°ƒç”¨æ›¿ä»£å¾ªç¯è°ƒç”¨
- [ ] æ…¢æ¥å£åŠ ç¼“å­˜
- [ ] å®šæœŸreviewè¶…æ—¶é…ç½®
- [ ] åˆ†æç›‘æ§æ•°æ®æŒç»­ä¼˜åŒ–

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**
> 
> 1. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬ç”¨æ³•ï¼Œå†å­¦ä¹ é«˜çº§ç‰¹æ€§
> 2. **å¤šåŠ¨æ‰‹å®è·µ**ï¼šæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½å†™ä»£ç éªŒè¯
> 3. **å…³æ³¨ç›‘æ§æ•°æ®**ï¼šæ•°æ®ä¼šå‘Šè¯‰ä½ å“ªé‡Œæœ‰é—®é¢˜
> 4. **æŒç»­ä¼˜åŒ–**ï¼šæ€§èƒ½ä¼˜åŒ–æ˜¯ä¸ªæŒç»­çš„è¿‡ç¨‹
>
> **è®°ä½**ï¼šOpenFeignåªæ˜¯å·¥å…·ï¼Œå…³é”®æ˜¯ç†è§£å¾®æœåŠ¡é€šä¿¡çš„æœ¬è´¨ï¼