---
title: 3ã€OpenFeigné«˜çº§åŠŸèƒ½åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [è‡ªå®šä¹‰æ‹¦æˆªå™¨å®ç°](#1-è‡ªå®šä¹‰æ‹¦æˆªå™¨å®ç°)
2. [è¯·æ±‚å¤´ä¼ é€’æœºåˆ¶](#2-è¯·æ±‚å¤´ä¼ é€’æœºåˆ¶)
3. [ç»§æ‰¿æ”¯æŒç‰¹æ€§](#3-ç»§æ‰¿æ”¯æŒç‰¹æ€§)
4. [å‹ç¼©é…ç½®å¯ç”¨](#4-å‹ç¼©é…ç½®å¯ç”¨)
5. [æ–‡ä»¶ä¸Šä¼ ä¸‹è½½](#5-æ–‡ä»¶ä¸Šä¼ ä¸‹è½½)
6. [OAuth2è®¤è¯é›†æˆ](#6-OAuth2è®¤è¯é›†æˆ)
7. [å¤šç¯å¢ƒé…ç½®ç®¡ç†](#7-å¤šç¯å¢ƒé…ç½®ç®¡ç†)
8. [åŠ¨æ€URLé…ç½®](#8-åŠ¨æ€URLé…ç½®)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ è‡ªå®šä¹‰æ‹¦æˆªå™¨å®ç°


### 1.1 ä»€ä¹ˆæ˜¯Feignæ‹¦æˆªå™¨


**é€šä¿—ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒæ˜¯"æ£€æŸ¥ç«™"ï¼Œæ¯æ¬¡ä½ é€šè¿‡OpenFeignå‘é€è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šå…ˆç»è¿‡è¿™ä¸ªæ£€æŸ¥ç«™ï¼Œä½ å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›ç»Ÿä¸€çš„å¤„ç†ã€‚

```
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ â†’ æ‹¦æˆªå™¨å¤„ç† â†’ å®é™…å‘é€è¯·æ±‚ â†’ å¾—åˆ°å“åº”
                  â†‘
            (æ·»åŠ tokenã€æ—¥å¿—ç­‰)
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**
- ç»Ÿä¸€æ·»åŠ è¯·æ±‚å¤´ï¼ˆæ¯”å¦‚tokenè®¤è¯ï¼‰
- è®°å½•è¯·æ±‚æ—¥å¿—
- ç»Ÿè®¡è¯·æ±‚è€—æ—¶
- å‚æ•°åŠ å¯†å¤„ç†

### 1.2 å®ç°è‡ªå®šä¹‰æ‹¦æˆªå™¨


**æ­¥éª¤1ï¼šåˆ›å»ºæ‹¦æˆªå™¨ç±»**

```java
// å®ç°RequestInterceptoræ¥å£
@Component
public class FeignAuthInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // ä»å½“å‰è¯·æ±‚ä¸­è·å–token
        String token = getCurrentToken();
        
        // æ·»åŠ åˆ°Feignè¯·æ±‚å¤´ä¸­
        if (token != null) {
            template.header("Authorization", "Bearer " + token);
        }
        
        // æ·»åŠ å…¶ä»–å…¬å…±è¯·æ±‚å¤´
        template.header("Client-Type", "Web");
    }
    
    private String getCurrentToken() {
        // ä»è¯·æ±‚ä¸Šä¸‹æ–‡æˆ–Sessionä¸­è·å–token
        // è¿™é‡Œç®€åŒ–å¤„ç†
        return "your-token-here";
    }
}
```

**æ­¥éª¤2ï¼šåº”ç”¨åˆ°æŒ‡å®šå®¢æˆ·ç«¯**

```java
// æ–¹å¼1ï¼šå…¨å±€ç”Ÿæ•ˆï¼ˆæ‰€æœ‰Feignå®¢æˆ·ç«¯éƒ½ä¼šç”¨ï¼‰
@Configuration
public class FeignConfig {
    @Bean
    public RequestInterceptor authInterceptor() {
        return new FeignAuthInterceptor();
    }
}

// æ–¹å¼2ï¼šåªå¯¹æŸä¸ªå®¢æˆ·ç«¯ç”Ÿæ•ˆ
@FeignClient(name = "user-service", configuration = FeignConfig.class)
public interface UserClient {
    @GetMapping("/users/{id}")
    User getUser(@PathVariable Long id);
}
```

### 1.3 å®ç”¨æ‹¦æˆªå™¨ç¤ºä¾‹


**ğŸ“‹ æ—¥å¿—æ‹¦æˆªå™¨**

```java
@Slf4j
@Component
public class FeignLogInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        log.info("Feignè¯·æ±‚: {} {}", template.method(), template.url());
        log.info("è¯·æ±‚å¤´: {}", template.headers());
        
        // å¦‚æœæœ‰è¯·æ±‚ä½“ï¼Œä¹Ÿå¯ä»¥è®°å½•
        if (template.body() != null) {
            log.info("è¯·æ±‚ä½“: {}", new String(template.body()));
        }
    }
}
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- `RequestTemplate`ï¼šåŒ…å«äº†è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆURLã€è¯·æ±‚å¤´ã€å‚æ•°ç­‰ï¼‰
- æ‹¦æˆªå™¨åœ¨è¯·æ±‚å‘é€å‰æ‰§è¡Œï¼Œå¯ä»¥ä¿®æ”¹è¯·æ±‚å†…å®¹
- å¤šä¸ªæ‹¦æˆªå™¨ä¼šæŒ‰ç…§é…ç½®é¡ºåºä¾æ¬¡æ‰§è¡Œ

---

## 2. ğŸ“¨ è¯·æ±‚å¤´ä¼ é€’æœºåˆ¶


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ä¼ é€’è¯·æ±‚å¤´


**å®é™…åœºæ™¯**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C
         (å¸¦token)  (éœ€è¦ä¼ é€’token)  (éœ€è¦éªŒè¯token)
```

åœ¨å¾®æœåŠ¡ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ç»è¿‡å¤šä¸ªæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ã€‚å¦‚æœä¸ä¼ é€’ï¼Œåé¢çš„æœåŠ¡å°±æ— æ³•è¯†åˆ«æ˜¯è°åœ¨è®¿é—®ã€‚

### 2.2 è¯·æ±‚å¤´ä¼ é€’çš„å®ç°æ–¹å¼


**æ–¹å¼1ï¼šæ‰‹åŠ¨ä¼ é€’ï¼ˆæœ€åŸºç¡€ï¼‰**

```java
@FeignClient(name = "order-service")
public interface OrderClient {
    
    // æ‰‹åŠ¨æŒ‡å®šè¦ä¼ é€’çš„è¯·æ±‚å¤´
    @GetMapping("/orders")
    List<Order> getOrders(@RequestHeader("Authorization") String token);
}

// ä½¿ç”¨æ—¶
String token = request.getHeader("Authorization");
orderClient.getOrders(token);  // æ‰‹åŠ¨ä¼ é€’
```

**æ–¹å¼2ï¼šæ‹¦æˆªå™¨è‡ªåŠ¨ä¼ é€’ï¼ˆæ¨èï¼‰**

```java
@Component
public class FeignHeaderInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // è·å–å½“å‰HTTPè¯·æ±‚
        ServletRequestAttributes attrs = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attrs != null) {
            HttpServletRequest request = attrs.getRequest();
            
            // ä¼ é€’å¸¸ç”¨è¯·æ±‚å¤´
            String[] headers = {"Authorization", "User-Agent", "X-Request-Id"};
            for (String header : headers) {
                String value = request.getHeader(header);
                if (value != null) {
                    template.header(header, value);
                }
            }
        }
    }
}
```

### 2.3 é…ç½®è¦ç‚¹


**âš ï¸ æ³¨æ„äº‹é¡¹**

| ä¼ é€’æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **æ‰‹åŠ¨ä¼ é€’** | åªéœ€è¦ä¼ é€’å°‘æ•°è¯·æ±‚å¤´ | æ˜ç¡®å¯æ§ | æ¯æ¬¡éƒ½è¦å†™ä»£ç  |
| **æ‹¦æˆªå™¨ä¼ é€’** | éœ€è¦ç»Ÿä¸€ä¼ é€’å¤šä¸ªè¯·æ±‚å¤´ | ä¸€æ¬¡é…ç½®ï¼Œåˆ°å¤„ç”Ÿæ•ˆ | å¯èƒ½ä¼ é€’ä¸éœ€è¦çš„å¤´ |
| **é…ç½®æ–‡ä»¶** | å›ºå®šçš„è¯·æ±‚å¤´ | ç®€å•ç›´è§‚ | ä¸å¤Ÿçµæ´» |

**é…ç½®æ–‡ä»¶æ–¹å¼ç¤ºä¾‹**ï¼š
```yaml
feign:
  client:
    config:
      default:  # å¯¹æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæ•ˆ
        request-interceptors:
          - com.example.FeignHeaderInterceptor
```

---

## 3. ğŸ§¬ ç»§æ‰¿æ”¯æŒç‰¹æ€§


### 3.1 ä»€ä¹ˆæ˜¯Feignç»§æ‰¿


**é€šä¿—è§£é‡Š**ï¼šå°±åƒé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ç»§æ‰¿ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª"æ¥å£æ¨¡æ¿"ï¼Œç„¶åè®©Feignå®¢æˆ·ç«¯ç»§æ‰¿å®ƒï¼Œé¿å…é‡å¤å®šä¹‰ç›¸åŒçš„æ¥å£ã€‚

**ä¼ ç»Ÿæ–¹å¼ï¼ˆé‡å¤å®šä¹‰ï¼‰**ï¼š
```java
// æœåŠ¡æä¾›æ–¹
@RestController
public class UserController {
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) { ... }
}

// æœåŠ¡è°ƒç”¨æ–¹ï¼ˆé‡å¤å®šä¹‰ä¸€éï¼‰
@FeignClient(name = "user-service")
public interface UserClient {
    @GetMapping("/users/{id}")  // é‡å¤äº†ï¼
    User getUser(@PathVariable Long id);
}
```

**ç»§æ‰¿æ–¹å¼ï¼ˆé¿å…é‡å¤ï¼‰**ï¼š
```java
// å…¬å…±æ¥å£æ¨¡å—ï¼ˆå…±äº«ï¼‰
public interface UserApi {
    @GetMapping("/users/{id}")
    User getUser(@PathVariable Long id);
}

// æœåŠ¡æä¾›æ–¹ï¼ˆå®ç°æ¥å£ï¼‰
@RestController
public class UserController implements UserApi {
    @Override
    public User getUser(Long id) { ... }
}

// æœåŠ¡è°ƒç”¨æ–¹ï¼ˆç»§æ‰¿æ¥å£ï¼‰
@FeignClient(name = "user-service")
public interface UserClient extends UserApi {
    // ä¸éœ€è¦é‡å¤å®šä¹‰ï¼Œç›´æ¥ç»§æ‰¿ï¼
}
```

### 3.2 å®ç°æ­¥éª¤


**æ­¥éª¤1ï¼šåˆ›å»ºå…¬å…±APIæ¨¡å—**

```
é¡¹ç›®ç»“æ„ï¼š
common-api/
  â””â”€â”€ UserApi.java      (å…¬å…±æ¥å£)
user-service/
  â””â”€â”€ UserController.java  (å®ç°æ¥å£)
order-service/
  â””â”€â”€ UserClient.java      (Feignç»§æ‰¿æ¥å£)
```

**æ­¥éª¤2ï¼šå®šä¹‰å…¬å…±æ¥å£**

```java
// common-apiæ¨¡å—
public interface UserApi {
    
    @GetMapping("/api/users/{id}")
    User getUserById(@PathVariable("id") Long id);
    
    @PostMapping("/api/users")
    User createUser(@RequestBody User user);
    
    @DeleteMapping("/api/users/{id}")
    void deleteUser(@PathVariable("id") Long id);
}
```

**æ­¥éª¤3ï¼šæœåŠ¡æä¾›æ–¹å®ç°**

```java
@RestController
@RequestMapping("/api")
public class UserController implements UserApi {
    
    @Override
    public User getUserById(Long id) {
        // å…·ä½“å®ç°
        return userService.findById(id);
    }
    
    @Override
    public User createUser(User user) {
        return userService.save(user);
    }
    
    @Override
    public void deleteUser(Long id) {
        userService.deleteById(id);
    }
}
```

**æ­¥éª¤4ï¼šFeignå®¢æˆ·ç«¯ç»§æ‰¿**

```java
@FeignClient(name = "user-service")
public interface UserClient extends UserApi {
    // ç»§æ‰¿æ‰€æœ‰æ¥å£æ–¹æ³•ï¼Œæ— éœ€é‡å¤å®šä¹‰
    // å¦‚æœéœ€è¦é¢å¤–æ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
}
```

### 3.3 ä¼˜ç¼ºç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**
- é¿å…æ¥å£é‡å¤å®šä¹‰
- ä¿è¯æ¥å£ä¸€è‡´æ€§ï¼ˆæä¾›æ–¹å’Œè°ƒç”¨æ–¹ç»Ÿä¸€ï¼‰
- æ¥å£å˜æ›´æ—¶åªéœ€ä¿®æ”¹ä¸€å¤„

**âŒ ç¼ºç‚¹**
- å¢åŠ äº†æ¨¡å—ä¾èµ–ï¼ˆéƒ½è¦ä¾èµ–common-apiï¼‰
- æœåŠ¡è€¦åˆåº¦æé«˜
- ä¸ç¬¦åˆå¾®æœåŠ¡å®Œå…¨ç‹¬ç«‹çš„ç†å¿µ

**ğŸ¯ ä½¿ç”¨å»ºè®®**
- å†…éƒ¨ç³»ç»Ÿã€å›¢é˜Ÿåä½œç´§å¯† â†’ é€‚åˆä½¿ç”¨
- å¯¹å¤–æä¾›æœåŠ¡ã€æ¾è€¦åˆè¦æ±‚é«˜ â†’ ä¸å»ºè®®ä½¿ç”¨

---

## 4. ğŸ“¦ å‹ç¼©é…ç½®å¯ç”¨


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å‹ç¼©


**å®é™…é—®é¢˜**ï¼š
```
åœºæ™¯ï¼šæŸ¥è¯¢å¤§é‡è®¢å•æ•°æ®
æœªå‹ç¼©ï¼šè¿”å›æ•°æ® 5MB
å‹ç¼©åï¼šè¿”å›æ•°æ® 500KB  (å‹ç¼©ç‡90%)
èŠ‚çœæµé‡ï¼š4.5MB
```

**ğŸ”¸ å‹ç¼©çš„å¥½å¤„**
- å‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡
- é™ä½ç½‘ç»œå¸¦å®½å ç”¨
- æå‡ä¼ è¾“é€Ÿåº¦
- èŠ‚çœæµé‡è´¹ç”¨

### 4.2 å¯ç”¨è¯·æ±‚å‹ç¼©


**é…ç½®æ–¹å¼ï¼ˆapplication.ymlï¼‰**ï¼š

```yaml
feign:
  compression:
    request:
      enabled: true                    # å¼€å¯è¯·æ±‚å‹ç¼©
      mime-types:                      # å“ªäº›ç±»å‹çš„æ•°æ®éœ€è¦å‹ç¼©
        - text/xml
        - application/xml
        - application/json
      min-request-size: 2048          # è¶…è¿‡2KBæ‰å‹ç¼©ï¼ˆå¤ªå°å‹ç¼©åè€Œæµªè´¹ï¼‰
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- `min-request-size: 2048`ï¼šåªæœ‰è¯·æ±‚ä½“å¤§äº2KBæ‰å‹ç¼©
  - å¤ªå°çš„æ•°æ®å‹ç¼©åè€Œå¢åŠ CPUæ¶ˆè€—ï¼Œå¾—ä¸å¿å¤±
  - 2KBæ˜¯ä¸€ä¸ªç»éªŒå€¼ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

### 4.3 å¯ç”¨å“åº”å‹ç¼©


```yaml
feign:
  compression:
    response:
      enabled: true                    # å¼€å¯å“åº”å‹ç¼©
      useGzipDecoder: true            # ä½¿ç”¨Gzipè§£å‹
```

### 4.4 å®Œæ•´é…ç½®ç¤ºä¾‹


```yaml
feign:
  compression:
    # è¯·æ±‚å‹ç¼©
    request:
      enabled: true
      mime-types: 
        - application/json
        - application/xml
      min-request-size: 2048
    
    # å“åº”å‹ç¼©
    response:
      enabled: true
      useGzipDecoder: true
```

**âš ï¸ æ³¨æ„äº‹é¡¹**

| é…ç½®é¡¹ | è¯´æ˜ | å»ºè®®å€¼ |
|-------|------|--------|
| **min-request-size** | æœ€å°å‹ç¼©é˜ˆå€¼ | 2KB-4KB |
| **mime-types** | å‹ç¼©æ•°æ®ç±»å‹ | JSONã€XMLç­‰æ–‡æœ¬æ ¼å¼ |
| **enabled** | æ˜¯å¦å¯ç”¨ | å¤§æ•°æ®é‡åœºæ™¯å¼€å¯ |

**ğŸ¯ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**
- âœ… ä¼ è¾“æ•°æ®é‡å¤§ï¼ˆ>10KBï¼‰
- âœ… ç½‘ç»œå¸¦å®½å—é™
- âœ… é¢‘ç¹çš„æ•°æ®ä¼ è¾“
- âŒ æ•°æ®é‡å¾ˆå°ï¼ˆ<2KBï¼‰
- âŒ å¯¹CPUæ€§èƒ½è¦æ±‚é«˜

---

## 5. ğŸ“‚ æ–‡ä»¶ä¸Šä¼ ä¸‹è½½


### 5.1 æ–‡ä»¶ä¸Šä¼ å®ç°


**æ ¸å¿ƒåŸç†**ï¼šé€šè¿‡`MultipartFile`ç±»å‹å‚æ•°å®ç°æ–‡ä»¶ä¸Šä¼ 

**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<!-- æ”¯æŒFeignæ–‡ä»¶ä¸Šä¼  -->
<dependency>
    <groupId>io.github.openfeign.form</groupId>
    <artifactId>feign-form</artifactId>
    <version>3.8.0</version>
</dependency>
<dependency>
    <groupId>io.github.openfeign.form</groupId>
    <artifactId>feign-form-spring</artifactId>
    <version>3.8.0</version>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®Encoder**

```java
@Configuration
public class FeignMultipartConfig {
    
    @Bean
    public Encoder feignFormEncoder() {
        return new SpringFormEncoder(new SpringEncoder(new ObjectFactory<HttpMessageConverters>() {
            @Override
            public HttpMessageConverters getObject() {
                return new HttpMessageConverters(new RestTemplate().getMessageConverters());
            }
        }));
    }
}
```

**æ­¥éª¤3ï¼šå®šä¹‰Feignæ¥å£**

```java
@FeignClient(name = "file-service", configuration = FeignMultipartConfig.class)
public interface FileClient {
    
    // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
    @PostMapping(value = "/upload", 
                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    String uploadFile(@RequestPart("file") MultipartFile file);
    
    // ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
    @PostMapping(value = "/upload/batch",
                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    String uploadFiles(@RequestPart("files") MultipartFile[] files);
    
    // ä¸Šä¼ æ–‡ä»¶ + å‚æ•°
    @PostMapping(value = "/upload/with-params",
                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    String uploadWithParams(
        @RequestPart("file") MultipartFile file,
        @RequestParam("userId") String userId,
        @RequestParam("type") String type
    );
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@RestController
public class UploadController {
    
    @Autowired
    private FileClient fileClient;
    
    @PostMapping("/api/upload")
    public String upload(@RequestPart("file") MultipartFile file) {
        // ç›´æ¥è°ƒç”¨Feignå®¢æˆ·ç«¯ä¸Šä¼ 
        return fileClient.uploadFile(file);
    }
}
```

### 5.2 æ–‡ä»¶ä¸‹è½½å®ç°


**æ–¹å¼1ï¼šä½¿ç”¨Responseå¯¹è±¡**

```java
@FeignClient(name = "file-service")
public interface FileClient {
    
    @GetMapping("/download/{fileId}")
    Response downloadFile(@PathVariable("fileId") String fileId);
}

// ä½¿ç”¨
Response response = fileClient.downloadFile("123");
Response.Body body = response.body();
InputStream inputStream = body.asInputStream();
// å¤„ç†è¾“å…¥æµ...
```

**æ–¹å¼2ï¼šç›´æ¥è¿”å›å­—èŠ‚æ•°ç»„ï¼ˆå°æ–‡ä»¶ï¼‰**

```java
@FeignClient(name = "file-service")
public interface FileClient {
    
    @GetMapping("/download/{fileId}")
    byte[] downloadFile(@PathVariable("fileId") String fileId);
}

// ä½¿ç”¨
byte[] fileData = fileClient.downloadFile("123");
// ä¿å­˜æ–‡ä»¶...
```

### 5.3 å®ç”¨æŠ€å·§


**ğŸ’¡ ä¸Šä¼ å¤§æ–‡ä»¶ä¼˜åŒ–**

```yaml
feign:
  client:
    config:
      file-service:
        connect-timeout: 30000      # è¿æ¥è¶…æ—¶30ç§’
        read-timeout: 60000         # è¯»å–è¶…æ—¶60ç§’
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- æ–‡ä»¶ä¸Šä¼ å¿…é¡»è®¾ç½® `consumes = MediaType.MULTIPART_FORM_DATA_VALUE`
- å¤§æ–‡ä»¶ä¸Šä¼ è¦é€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´
- ä¸‹è½½å¤§æ–‡ä»¶å»ºè®®ä½¿ç”¨æµå¼å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º

---

## 6. ğŸ” OAuth2è®¤è¯é›†æˆ


### 6.1 OAuth2è®¤è¯æµç¨‹


**é€šä¿—ç†è§£**ï¼šOAuth2å°±åƒæ˜¯"æˆæƒç "æœºåˆ¶

```
ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·ç™»å½•ï¼Œè·å–token
ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒ â†’ è¿”å›access_token

ç¬¬äºŒæ­¥ï¼šæºå¸¦tokenè®¿é—®æœåŠ¡
ç”¨æˆ· â†’ æœåŠ¡A(å¸¦token) â†’ æœåŠ¡B(ä¼ é€’token) â†’ éªŒè¯é€šè¿‡
```

### 6.2 é›†æˆæ­¥éª¤


**æ­¥éª¤1ï¼šæ·»åŠ OAuth2ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-oauth2</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®OAuth2æ‹¦æˆªå™¨**

```java
@Component
public class OAuth2FeignInterceptor implements RequestInterceptor {
    
    @Autowired
    private OAuth2ClientContext oauth2ClientContext;
    
    @Override
    public void apply(RequestTemplate template) {
        // è·å–å½“å‰OAuth2ä»¤ç‰Œ
        OAuth2AccessToken accessToken = oauth2ClientContext.getAccessToken();
        
        if (accessToken != null) {
            // æ·»åŠ åˆ°è¯·æ±‚å¤´
            template.header("Authorization", 
                "Bearer " + accessToken.getValue());
        }
    }
}
```

**æ­¥éª¤3ï¼šåº”ç”¨åˆ°Feignå®¢æˆ·ç«¯**

```java
@FeignClient(name = "protected-service", 
             configuration = OAuth2FeignConfig.class)
public interface ProtectedClient {
    
    @GetMapping("/api/data")
    String getData();
}

@Configuration
class OAuth2FeignConfig {
    @Bean
    public RequestInterceptor oauth2Interceptor(OAuth2ClientContext context) {
        return new OAuth2FeignInterceptor(context);
    }
}
```

### 6.3 ä»¤ç‰Œåˆ·æ–°æœºåˆ¶


**è‡ªåŠ¨åˆ·æ–°é…ç½®**ï¼š

```yaml
security:
  oauth2:
    client:
      client-id: your-client-id
      client-secret: your-client-secret
      access-token-uri: http://auth-server/oauth/token
      user-authorization-uri: http://auth-server/oauth/authorize
    resource:
      token-info-uri: http://auth-server/oauth/check_token
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- `access_token`ï¼šè®¿é—®ä»¤ç‰Œï¼Œæœ‰è¿‡æœŸæ—¶é—´
- `refresh_token`ï¼šåˆ·æ–°ä»¤ç‰Œï¼Œç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
- Spring Security OAuth2ä¼šè‡ªåŠ¨å¤„ç†ä»¤ç‰Œåˆ·æ–°

---

## 7. ğŸŒ å¤šç¯å¢ƒé…ç½®ç®¡ç†


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦å¤šç¯å¢ƒé…ç½®


**å®é™…åœºæ™¯**ï¼š
```
å¼€å‘ç¯å¢ƒ(dev)ï¼š   user-service â†’ http://localhost:8080
æµ‹è¯•ç¯å¢ƒ(test)ï¼š  user-service â†’ http://test-server:8080
ç”Ÿäº§ç¯å¢ƒ(prod)ï¼š  user-service â†’ http://prod-server:8080
```

åŒä¸€ä¸ªæœåŠ¡åœ¨ä¸åŒç¯å¢ƒä¸‹åœ°å€ä¸åŒï¼Œéœ€è¦çµæ´»é…ç½®ã€‚

### 7.2 åŸºäºProfileçš„é…ç½®


**æ–¹å¼1ï¼šå¤šé…ç½®æ–‡ä»¶**

```
application.yml              # å…¬å…±é…ç½®
application-dev.yml          # å¼€å‘ç¯å¢ƒ
application-test.yml         # æµ‹è¯•ç¯å¢ƒ
application-prod.yml         # ç”Ÿäº§ç¯å¢ƒ
```

**application-dev.yml**ï¼š
```yaml
feign:
  client:
    config:
      user-service:
        url: http://localhost:8081
      order-service:
        url: http://localhost:8082
```

**application-prod.yml**ï¼š
```yaml
feign:
  client:
    config:
      user-service:
        url: http://user-service:8081
      order-service:
        url: http://order-service:8082
```

**æ¿€æ´»é…ç½®**ï¼š
```yaml
# application.yml
spring:
  profiles:
    active: dev  # ä½¿ç”¨devç¯å¢ƒé…ç½®
```

### 7.3 åŸºäºNacosçš„åŠ¨æ€é…ç½®


**é…ç½®ç¤ºä¾‹ï¼ˆNacosé…ç½®ä¸­å¿ƒï¼‰**ï¼š

```yaml
# Data ID: feign-config.yml
# Group: DEFAULT_GROUP
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 5000
      user-service:
        url: ${user.service.url}    # æ”¯æŒå˜é‡
        connect-timeout: 3000
```

**åº”ç”¨é…ç½®**ï¼š
```yaml
spring:
  cloud:
    nacos:
      config:
        server-addr: localhost:8848
        file-extension: yml
        shared-configs:
          - data-id: feign-config.yml
            refresh: true            # æ”¯æŒåŠ¨æ€åˆ·æ–°
```

### 7.4 é…ç½®ä¼˜å…ˆçº§


**ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰**ï¼š

| é…ç½®æ–¹å¼ | ä¼˜å…ˆçº§ | ä½¿ç”¨åœºæ™¯ |
|---------|-------|---------|
| **ä»£ç ä¸­çš„@FeignClienté…ç½®** | æœ€é«˜ | ç‰¹å®šå®¢æˆ·ç«¯ä¸“å±é…ç½® |
| **ç‰¹å®šå®¢æˆ·ç«¯é…ç½®** | é«˜ | `feign.client.config.user-service` |
| **é»˜è®¤é…ç½®** | ä¸­ | `feign.client.config.default` |
| **å…¨å±€é…ç½®** | ä½ | `feign.xxx` |

**ğŸ’¡ é…ç½®è¦†ç›–ç¤ºä¾‹**ï¼š
```yaml
feign:
  client:
    config:
      default:                    # å…¨å±€é»˜è®¤é…ç½®
        connect-timeout: 5000
        read-timeout: 10000
      
      user-service:              # è¦†ç›–user-serviceçš„é…ç½®
        connect-timeout: 3000    # è¦†ç›–ä¸º3ç§’
        # read-timeoutç»§æ‰¿é»˜è®¤çš„10ç§’
```

---

## 8. ğŸ¯ åŠ¨æ€URLé…ç½®


### 8.1 ä»€ä¹ˆæ˜¯åŠ¨æ€URL


**é€šä¿—ç†è§£**ï¼šæœåŠ¡åœ°å€ä¸æ˜¯å†™æ­»çš„ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æŒ‡å®š

**é™æ€URLï¼ˆå†™æ­»ï¼‰**ï¼š
```java
@FeignClient(name = "user-service", url = "http://localhost:8080")
public interface UserClient { }
```

**åŠ¨æ€URLï¼ˆçµæ´»ï¼‰**ï¼š
```java
@FeignClient(name = "user-service")  // ä¸æŒ‡å®šurl
public interface UserClient {
    @GetMapping("/users/{id}")
    User getUser(URI baseUri, @PathVariable Long id);  // åŠ¨æ€ä¼ å…¥URL
}
```

### 8.2 å®ç°æ–¹å¼


**æ–¹å¼1ï¼šä½¿ç”¨@RequestLine**

```java
@FeignClient(name = "dynamic-client", url = "placeholder")
public interface DynamicClient {
    
    @RequestLine("GET /api/users/{id}")
    User getUser(URI baseUri, @Param("id") Long id);
}

// ä½¿ç”¨
URI uri = new URI("http://dynamic-server:8080");
User user = dynamicClient.getUser(uri, 1L);
```

**æ–¹å¼2ï¼šä½¿ç”¨Feign.Builderï¼ˆæ¨èï¼‰**

```java
@Configuration
public class DynamicFeignConfig {
    
    @Bean
    public UserClient userClient() {
        return Feign.builder()
                .target(UserClient.class, getDynamicUrl());
    }
    
    private String getDynamicUrl() {
        // ä»é…ç½®ä¸­å¿ƒã€æ•°æ®åº“ç­‰è·å–URL
        return "http://dynamic-server:8080";
    }
}
```

**æ–¹å¼3ï¼šç»“åˆé…ç½®æ–‡ä»¶**

```java
@Component
public class DynamicUrlInterceptor implements RequestInterceptor {
    
    @Value("${dynamic.service.url}")
    private String dynamicUrl;
    
    @Override
    public void apply(RequestTemplate template) {
        // å¦‚æœURLæ˜¯å ä½ç¬¦ï¼Œæ›¿æ¢ä¸ºçœŸå®URL
        if (template.url().contains("placeholder")) {
            template.target(dynamicUrl);
        }
    }
}
```

### 8.3 å®ç”¨åœºæ™¯


**åœºæ™¯1ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿ**

```java
// æ ¹æ®ç§Ÿæˆ·IDè®¿é—®ä¸åŒçš„æœåŠ¡å®ä¾‹
public User getUserByTenant(String tenantId, Long userId) {
    String url = getTenantUrl(tenantId);  // è·å–ç§Ÿæˆ·å¯¹åº”çš„URL
    return Feign.builder()
            .target(UserClient.class, url)
            .getUser(userId);
}
```

**åœºæ™¯2ï¼šç°åº¦å‘å¸ƒ**

```yaml
# é…ç½®æ–‡ä»¶
service:
  urls:
    stable: http://stable-server:8080    # ç¨³å®šç‰ˆæœ¬
    canary: http://canary-server:8080    # ç°åº¦ç‰ˆæœ¬
```

```java
// æ ¹æ®ç”¨æˆ·åˆ†ç»„é€‰æ‹©ä¸åŒç‰ˆæœ¬
public String getServiceUrl(User user) {
    if (isCanaryUser(user)) {
        return canaryUrl;  // ç°åº¦ç”¨æˆ·
    }
    return stableUrl;      // æ™®é€šç”¨æˆ·
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- åŠ¨æ€URLä¼šå¢åŠ å¤æ‚åº¦ï¼Œä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨
- å»ºè®®é…åˆæœåŠ¡å‘ç°ï¼ˆNacosã€Eurekaï¼‰ä½¿ç”¨
- æ³¨æ„URLçš„ç¼“å­˜å’Œåˆ·æ–°æœºåˆ¶

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‹¦æˆªå™¨ï¼šè¯·æ±‚çš„"æ£€æŸ¥ç«™"ï¼Œç”¨äºç»Ÿä¸€å¤„ç†è®¤è¯ã€æ—¥å¿—ç­‰
ğŸ”¸ è¯·æ±‚å¤´ä¼ é€’ï¼šå¾®æœåŠ¡é—´ä¼ é€’ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„å…³é”®
ğŸ”¸ ç»§æ‰¿æ”¯æŒï¼šé¿å…æ¥å£é‡å¤å®šä¹‰ï¼Œä¿æŒä¸€è‡´æ€§
ğŸ”¸ å‹ç¼©é…ç½®ï¼šå‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡ï¼Œæå‡æ€§èƒ½
ğŸ”¸ æ–‡ä»¶ä¼ è¾“ï¼šé€šè¿‡MultipartFileå®ç°æ–‡ä»¶ä¸Šä¼ ä¸‹è½½
ğŸ”¸ OAuth2é›†æˆï¼šå®ç°å®‰å…¨çš„æœåŠ¡é—´è®¤è¯
ğŸ”¸ å¤šç¯å¢ƒé…ç½®ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„æœåŠ¡åœ°å€
ğŸ”¸ åŠ¨æ€URLï¼šè¿è¡Œæ—¶çµæ´»æŒ‡å®šæœåŠ¡åœ°å€
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‹¦æˆªå™¨çš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- æ‹¦æˆªå™¨åœ¨è¯·æ±‚å‘é€å‰æ‰§è¡Œ
- å¯ä»¥ä¿®æ”¹è¯·æ±‚çš„ä»»ä½•å†…å®¹ï¼ˆè¯·æ±‚å¤´ã€å‚æ•°ç­‰ï¼‰
- å¤šä¸ªæ‹¦æˆªå™¨æŒ‰é…ç½®é¡ºåºæ‰§è¡Œ
- ç±»ä¼¼äºSpring MVCçš„æ‹¦æˆªå™¨æœºåˆ¶
```

**ğŸ”¹ è¯·æ±‚å¤´ä¼ é€’çš„å¿…è¦æ€§**
```
å¾®æœåŠ¡åœºæ™¯ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³(éªŒè¯token) â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C
                                â†“       â†“       â†“
                            éœ€è¦token éœ€è¦token éœ€è¦token

æ²¡æœ‰ä¼ é€’ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¦é‡æ–°éªŒè¯
æœ‰ä¼ é€’ï¼šä¸€æ¬¡éªŒè¯ï¼Œå…¨é“¾è·¯é€šç”¨
```

**ğŸ”¹ å‹ç¼©é…ç½®çš„æƒè¡¡**
```
å‹ç¼©çš„ä»£ä»·ï¼š
âœ… å‡å°‘ç½‘ç»œä¼ è¾“ (å¥½å¤„)
âŒ å¢åŠ CPUæ¶ˆè€— (ä»£ä»·)

ä½¿ç”¨åŸåˆ™ï¼š
æ•°æ®é‡å¤§(>10KB) â†’ å‹ç¼©åˆ’ç®—
æ•°æ®é‡å°(<2KB) â†’ ä¸å‹ç¼©æ›´å¥½
```

### 9.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ åœºæ™¯1ï¼šç»Ÿä¸€è®¤è¯**
```java
// æ‰€æœ‰Feignè°ƒç”¨è‡ªåŠ¨æºå¸¦token
@Component
public class AuthInterceptor implements RequestInterceptor {
    public void apply(RequestTemplate template) {
        template.header("Authorization", "Bearer " + getToken());
    }
}
```

**ğŸ¯ åœºæ™¯2ï¼šæœåŠ¡é—´æ–‡ä»¶ä¼ è¾“**
```java
// ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡Aï¼ŒæœåŠ¡Aè½¬å‘åˆ°æœåŠ¡Bå­˜å‚¨
@PostMapping("/upload")
public String upload(MultipartFile file) {
    return fileClient.uploadFile(file);  // Feignè½¬å‘æ–‡ä»¶
}
```

**ğŸ¯ åœºæ™¯3ï¼šå¤šç¯å¢ƒéƒ¨ç½²**
```yaml
# å¼€å‘ç¯å¢ƒè¿æœ¬åœ°æœåŠ¡
spring.profiles.active: dev

# ç”Ÿäº§ç¯å¢ƒè¿ç”Ÿäº§æœåŠ¡
spring.profiles.active: prod
```

### 9.4 æœ€ä½³å®è·µå»ºè®®


**âœ… æ¨èåšæ³•**
- ä½¿ç”¨æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†è®¤è¯ã€æ—¥å¿—
- å¤§æ•°æ®é‡ä¼ è¾“å¯ç”¨å‹ç¼©
- å¤šç¯å¢ƒé…ç½®ä½¿ç”¨Profileç®¡ç†
- æ•æ„Ÿä¿¡æ¯ï¼ˆtokenï¼‰ä¸è¦ç¡¬ç¼–ç 

**âŒ é¿å…åšæ³•**
- ä¸è¦åœ¨æ¯ä¸ªæ¥å£éƒ½æ‰‹åŠ¨ä¼ é€’è¯·æ±‚å¤´
- å°æ–‡ä»¶ä¸è¦å¯ç”¨å‹ç¼©ï¼ˆæµªè´¹CPUï¼‰
- ä¸è¦æ»¥ç”¨ç»§æ‰¿ç‰¹æ€§ï¼ˆä¼šå¢åŠ è€¦åˆï¼‰
- åŠ¨æ€URLä¸è¦è¿‡åº¦ä½¿ç”¨ï¼ˆå¢åŠ å¤æ‚åº¦ï¼‰

**ğŸ’¡ è®°å¿†å£è¯€**
```
æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†å¾ˆé‡è¦ï¼Œ
è¯·æ±‚å¤´ä¼ é€’é“¾è·¯è¦çŸ¥é“ï¼Œ
å‹ç¼©é…ç½®çœ‹æ•°æ®å¤§å°ï¼Œ
å¤šç¯å¢ƒç®¡ç†Profileæå®šäº†ã€‚
```

### 9.5 å¸¸è§é—®é¢˜ä¸è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| **è¯·æ±‚å¤´ä¸¢å¤±** | æ²¡æœ‰é…ç½®ä¼ é€’æœºåˆ¶ | ä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨ä¼ é€’ |
| **æ–‡ä»¶ä¸Šä¼ å¤±è´¥** | ç¼ºå°‘feign-formä¾èµ– | æ·»åŠ ä¾èµ–å¹¶é…ç½®Encoder |
| **è¶…æ—¶é”™è¯¯** | é»˜è®¤è¶…æ—¶æ—¶é—´å¤ªçŸ­ | å¢åŠ connect-timeoutå’Œread-timeout |
| **å‹ç¼©ä¸ç”Ÿæ•ˆ** | æ•°æ®é‡å°äºé˜ˆå€¼ | æ£€æŸ¥min-request-sizeé…ç½® |
| **å¤šç¯å¢ƒé…ç½®æ··ä¹±** | æ²¡æœ‰ä½¿ç”¨Profile | ä½¿ç”¨spring.profiles.activeç®¡ç† |

**æ ¸å¿ƒè®°å¿†**ï¼š
- OpenFeigné«˜çº§ç‰¹æ€§æ˜¯ä¸ºäº†è§£å†³**çœŸå®ä¸šåŠ¡åœºæ™¯é—®é¢˜**
- ä¸è¦ä¸ºäº†ç”¨è€Œç”¨ï¼Œ**æŒ‰éœ€é€‰æ‹©åˆé€‚çš„åŠŸèƒ½**
- é…ç½®è¦**åˆç†**ï¼Œè¿‡åº¦é…ç½®åè€Œå¢åŠ å¤æ‚åº¦
- å®è·µä¸­**å¤šæµ‹è¯•**ï¼Œç¡®ä¿åŠŸèƒ½ç¬¦åˆé¢„æœŸ