---
title: 1ã€æœåŠ¡æ³¨å†Œå‘ç°é›†æˆå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡æ³¨å†Œå‘ç°æ ¸å¿ƒæ¦‚å¿µ](#1-æœåŠ¡æ³¨å†Œå‘ç°æ ¸å¿ƒæ¦‚å¿µ)
2. [Eurekaé›†æˆé…ç½®è¯¦è§£](#2-Eurekaé›†æˆé…ç½®è¯¦è§£)
3. [Nacosé›†æˆé…ç½®è¯¦è§£](#3-Nacosé›†æˆé…ç½®è¯¦è§£)
4. [Consulé›†æˆé…ç½®è¯¦è§£](#4-Consulé›†æˆé…ç½®è¯¦è§£)
5. [æœåŠ¡å®ä¾‹è·å–æœºåˆ¶](#5-æœåŠ¡å®ä¾‹è·å–æœºåˆ¶)
6. [åŠ¨æ€æœåŠ¡åˆ—è¡¨æ›´æ–°](#6-åŠ¨æ€æœåŠ¡åˆ—è¡¨æ›´æ–°)
7. [æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥](#7-æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥)
8. [æ•…éšœè½¬ç§»å®ç°](#8-æ•…éšœè½¬ç§»å®ç°)
9. [å¤šæ³¨å†Œä¸­å¿ƒæ”¯æŒ](#9-å¤šæ³¨å†Œä¸­å¿ƒæ”¯æŒ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æœåŠ¡æ³¨å†Œå‘ç°æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œå‘ç°


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒä½ å»å•†åœºæ‰¾åº—é“º
> - **æœåŠ¡æ³¨å†Œ**ï¼šæ¯ä¸ªåº—é“ºåœ¨å•†åœºå…¥å£å¤„ç™»è®°è‡ªå·±çš„ä½ç½®ï¼ˆ3æ¥¼AåŒº301å·ï¼‰
> - **æœåŠ¡å‘ç°**ï¼šä½ åœ¨å…¥å£çš„å¯¼è§ˆå›¾ä¸ŠæŸ¥æ‰¾æƒ³å»çš„åº—é“ºä½ç½®
> - **å¥åº·æ£€æŸ¥**ï¼šå•†åœºå®šæœŸç¡®è®¤åº—é“ºæ˜¯å¦è¿˜åœ¨è¥ä¸š

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
æœåŠ¡æ³¨å†Œï¼šå¾®æœåŠ¡å¯åŠ¨æ—¶ï¼ŒæŠŠè‡ªå·±çš„åœ°å€ï¼ˆIP+ç«¯å£ï¼‰å‘Šè¯‰æ³¨å†Œä¸­å¿ƒ
æœåŠ¡å‘ç°ï¼šå¾®æœåŠ¡éœ€è¦è°ƒç”¨åˆ«äººæ—¶ï¼Œä»æ³¨å†Œä¸­å¿ƒæŸ¥è¯¢å¯¹æ–¹çš„åœ°å€
æ³¨å†Œä¸­å¿ƒï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¾®æœåŠ¡åœ°å€çš„"ç”µè¯ç°¿"
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡æ³¨å†Œå‘ç°


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```
è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡ï¼š
ç¡¬ç¼–ç æ–¹å¼ â†’ http://192.168.1.100:8080/stock

âŒ é—®é¢˜1ï¼šIPåœ°å€å†™æ­»ï¼Œåº“å­˜æœåŠ¡è¿ç§»åéœ€è¦æ”¹ä»£ç 
âŒ é—®é¢˜2ï¼šåº“å­˜æœåŠ¡æ‰©å±•åˆ°3å°ï¼Œæ— æ³•è‡ªåŠ¨è´Ÿè½½å‡è¡¡
âŒ é—®é¢˜3ï¼šæŸå°åº“å­˜æœåŠ¡å®•æœºï¼Œè®¢å•æœåŠ¡ä¸çŸ¥é“è¦æ¢ä¸€å°
```

**ä½¿ç”¨æ³¨å†Œä¸­å¿ƒå**ï¼š
```
æœåŠ¡å¯åŠ¨æµç¨‹ï¼š
åº“å­˜æœåŠ¡-A â†’ æ³¨å†Œåˆ°Nacos â†’ åœ°å€ï¼š192.168.1.100:8080
åº“å­˜æœåŠ¡-B â†’ æ³¨å†Œåˆ°Nacos â†’ åœ°å€ï¼š192.168.1.101:8080
åº“å­˜æœåŠ¡-C â†’ æ³¨å†Œåˆ°Nacos â†’ åœ°å€ï¼š192.168.1.102:8080

è®¢å•æœåŠ¡è°ƒç”¨ï¼š
1. é—®Nacosï¼š"åº“å­˜æœåŠ¡"æœ‰å“ªäº›å®ä¾‹ï¼Ÿ
2. Nacosè¿”å›ï¼šAã€Bã€Cä¸‰ä¸ªåœ°å€
3. è®¢å•æœåŠ¡è‡ªå·±é€‰ä¸€ä¸ªï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
4. å¦‚æœAå®•æœºï¼ŒNacosè‡ªåŠ¨å‰”é™¤ï¼Œè®¢å•æœåŠ¡è‡ªåŠ¨é€‰Bæˆ–C

âœ… è§£å†³äº†åœ°å€ç¡¬ç¼–ç ã€è‡ªåŠ¨è´Ÿè½½å‡è¡¡ã€æ•…éšœè‡ªåŠ¨è½¬ç§»
```

### 1.3 ä¸‰å¤§ä¸»æµæ³¨å†Œä¸­å¿ƒå¯¹æ¯”


| ç‰¹æ€§ | **Eureka** | **Nacos** | **Consul** |
|------|-----------|-----------|------------|
| ğŸ¢ **å‡ºå“æ–¹** | `Netflixï¼ˆå·²åœæ›´ï¼‰` | `é˜¿é‡Œå·´å·´` | `HashiCorp` |
| ğŸ”„ **CAPç†è®º** | `APï¼ˆé«˜å¯ç”¨ï¼‰` | `AP+CPå¯åˆ‡æ¢` | `CPï¼ˆå¼ºä¸€è‡´ï¼‰` |
| ğŸŒ **è¯­è¨€æ”¯æŒ** | `ä»…Java` | `å¤šè¯­è¨€SDK` | `å¤šè¯­è¨€æ”¯æŒ` |
| ğŸ’¾ **æŒä¹…åŒ–** | `å†…å­˜å­˜å‚¨` | `æ”¯æŒMySQL` | `æ”¯æŒKVå­˜å‚¨` |
| ğŸ”§ **é…ç½®ä¸­å¿ƒ** | `âŒ ä¸æ”¯æŒ` | `âœ… å†…ç½®æ”¯æŒ` | `âœ… æ”¯æŒ` |
| ğŸ“Š **æ§åˆ¶å°** | `ç®€å•UI` | `åŠŸèƒ½ä¸°å¯Œ` | `åŠŸèƒ½å®Œå–„` |
| ğŸ¯ **æ¨èåœºæ™¯** | `è€é¡¹ç›®ç»´æŠ¤` | `å›½å†…å¾®æœåŠ¡é¦–é€‰` | `å¤šè¯­è¨€ç¯å¢ƒ` |

**ğŸ”¹ è®°å¿†å£è¯€**ï¼š
- **Eureka**ï¼šNetflixè€å°†ï¼ŒAPæ¨¡å¼ï¼Œå·²é€€å½¹ä½†è¿˜åœ¨æœå½¹
- **Nacos**ï¼šå›½äº§æ–°ç§€ï¼ŒåŠŸèƒ½å…¨é¢ï¼Œé…ç½®æ³¨å†Œä¸€æŠŠæŠ“
- **Consul**ï¼šå›½é™…èŒƒå„¿ï¼Œå¤šè¯­è¨€é€šåƒï¼Œå¼ºä¸€è‡´æ€§

---

## 2. ğŸ“¦ Eurekaé›†æˆé…ç½®è¯¦è§£


### 2.1 EurekaåŸºæœ¬æ¶æ„


**ğŸ—ï¸ æ ¸å¿ƒè§’è‰²**ï¼š
```
                    Eureka Server
                    (æ³¨å†Œä¸­å¿ƒæœåŠ¡å™¨)
                          â†‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                 â†“                 â†“
   æœåŠ¡æä¾›è€…A        æœåŠ¡æä¾›è€…B        æœåŠ¡æ¶ˆè´¹è€…
   (æ³¨å†ŒæœåŠ¡)         (æ³¨å†ŒæœåŠ¡)         (å‘ç°æœåŠ¡)
```

**è¿è¡Œæœºåˆ¶**ï¼š
- **æœåŠ¡æä¾›è€…**ï¼šå¯åŠ¨åå‘Eureka Serveræ³¨å†Œï¼Œå®šæœŸå‘é€å¿ƒè·³
- **Eureka Server**ï¼šå­˜å‚¨æœåŠ¡åˆ—è¡¨ï¼Œæä¾›æŸ¥è¯¢æ¥å£
- **æœåŠ¡æ¶ˆè´¹è€…**ï¼šä»Eurekaè·å–æœåŠ¡åˆ—è¡¨ï¼Œå®šæœŸæ›´æ–°ç¼“å­˜

### 2.2 æ­å»ºEureka Server


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<!-- Eureka Serverä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šå¯ç”¨Eureka Server**
```java
@SpringBootApplication
@EnableEurekaServer  // å…³é”®æ³¨è§£ï¼šå¯ç”¨EurekaæœåŠ¡ç«¯
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ–‡ä»¶**
```yaml
server:
  port: 8761  # Eurekaé»˜è®¤ç«¯å£

eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: false  # è‡ªå·±ä¸æ³¨å†Œåˆ°è‡ªå·±
    fetch-registry: false        # ä¸ä»å…¶ä»–Eurekaè·å–æœåŠ¡åˆ—è¡¨
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
```

> âš ï¸ **æ–°æ‰‹æ˜“é”™ç‚¹**
> 
> `register-with-eureka: false` å¾ˆé‡è¦ï¼
> - Eureka Serverè‡ªå·±ä¸éœ€è¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
> - å¦‚æœè®¾ä¸ºtrueï¼Œä¼šå‡ºç°è‡ªå·±æ³¨å†Œè‡ªå·±çš„æ­»å¾ªç¯

### 2.3 æœåŠ¡æä¾›è€…æ³¨å†Œåˆ°Eureka


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<!-- Eureka Clientä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šå¯ç”¨æœåŠ¡æ³¨å†Œ**
```java
@SpringBootApplication
@EnableDiscoveryClient  // å¯ç”¨æœåŠ¡å‘ç°å®¢æˆ·ç«¯
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ³¨å†Œä¿¡æ¯**
```yaml
spring:
  application:
    name: order-service  # æœåŠ¡åç§°ï¼Œæ¶ˆè´¹è€…é€šè¿‡è¿™ä¸ªåå­—æ‰¾åˆ°ä½ 

server:
  port: 8080

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/  # æ³¨å†Œä¸­å¿ƒåœ°å€
  instance:
    prefer-ip-address: true  # ä½¿ç”¨IPåœ°å€æ³¨å†Œ
    instance-id: ${spring.cloud.client.ip-address}:${server.port}  # å®ä¾‹ID
```

**ğŸ”¹ å…³é”®å‚æ•°è¯´æ˜**ï¼š
- `spring.application.name`ï¼šæœåŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œå…¶ä»–æœåŠ¡é€šè¿‡è¿™ä¸ªåå­—è°ƒç”¨
- `prefer-ip-address: true`ï¼šæ³¨å†Œæ—¶ä½¿ç”¨IPè€Œä¸æ˜¯ä¸»æœºåï¼Œé¿å…DNSè§£æé—®é¢˜
- `instance-id`ï¼šå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºåŒºåˆ†åŒä¸€æœåŠ¡çš„ä¸åŒå®ä¾‹

### 2.4 æœåŠ¡æ¶ˆè´¹è€…ä»Eurekaè·å–æœåŠ¡


**ä½¿ç”¨RestTemplateè°ƒç”¨**ï¼š
```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // å…³é”®ï¼šå¯ç”¨è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

**è°ƒç”¨æœåŠ¡**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public String createOrder() {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åè°ƒç”¨ï¼Œä¸éœ€è¦çŸ¥é“å…·ä½“IP
        String stockUrl = "http://stock-service/stock/deduct";
        String result = restTemplate.getForObject(stockUrl, String.class);
        return "è®¢å•åˆ›å»ºæˆåŠŸï¼š" + result;
    }
}
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**
> 
> `http://stock-service` è¿™ä¸ªåœ°å€çœ‹èµ·æ¥å¾ˆç¥å¥‡ï¼š
> 1. `stock-service`æ˜¯æœåŠ¡åï¼Œä¸æ˜¯çœŸå®çš„åŸŸå
> 2. `@LoadBalanced`è®©RestTemplateå…·å¤‡æœåŠ¡å‘ç°èƒ½åŠ›
> 3. è°ƒç”¨æ—¶è‡ªåŠ¨ä»Eurekaè·å–`stock-service`çš„çœŸå®åœ°å€
> 4. å¦‚æœæœ‰å¤šä¸ªå®ä¾‹ï¼Œè‡ªåŠ¨åšè´Ÿè½½å‡è¡¡

### 2.5 Eurekaè‡ªæˆ‘ä¿æŠ¤æœºåˆ¶


**ğŸ›¡ï¸ ä»€ä¹ˆæ˜¯è‡ªæˆ‘ä¿æŠ¤**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
æœåŠ¡A â†’ æ¯30ç§’å‘å¿ƒè·³ â†’ Eurekaæ”¶åˆ° â†’ æ ‡è®°ä¸ºå¥åº·

ç½‘ç»œæŠ–åŠ¨ï¼š
æœåŠ¡A â†’ å¿ƒè·³ä¸¢å¤± â†’ Eurekaè®¤ä¸ºæœåŠ¡AæŒ‚äº† â†’ å‰”é™¤æœåŠ¡A
ä½†å®é™…ä¸Šï¼šæœåŠ¡Aæ˜¯å¥½çš„ï¼Œåªæ˜¯ç½‘ç»œé—®é¢˜ï¼

è‡ªæˆ‘ä¿æŠ¤è§¦å‘ï¼š
å½“15åˆ†é’Ÿå†…è¶…è¿‡85%çš„æœåŠ¡éƒ½æ²¡å‘å¿ƒè·³
â†’ Eurekaè®¤ä¸ºæ˜¯è‡ªå·±ç½‘ç»œé—®é¢˜ï¼Œä¸æ˜¯æœåŠ¡æŒ‚äº†
â†’ è¿›å…¥è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼šä¸å‰”é™¤ä»»ä½•æœåŠ¡
â†’ å®å¯ä¿ç•™å¯èƒ½å·²æŒ‚çš„æœåŠ¡ï¼Œä¹Ÿä¸è¯¯æ€å¥åº·æœåŠ¡
```

**é…ç½®è‡ªæˆ‘ä¿æŠ¤**ï¼š
```yaml
eureka:
  server:
    enable-self-preservation: true  # ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯
    eviction-interval-timer-in-ms: 60000  # æ¸…ç†é—´éš”60ç§’
```

**ğŸ”¸ å¼€å‘ç¯å¢ƒå¯ä»¥å…³é—­**ï¼š
```yaml
eureka:
  server:
    enable-self-preservation: false  # å¼€å‘æ—¶å…³é—­ï¼Œæ–¹ä¾¿æµ‹è¯•
```

---

## 3. ğŸš€ Nacosé›†æˆé…ç½®è¯¦è§£


### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©Nacos


**Nacosçš„ä¸‰å¤§ä¼˜åŠ¿**ï¼š
```
1. åŠŸèƒ½äºŒåˆä¸€ï¼šæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒ
   Eurekaåªèƒ½åšæ³¨å†Œä¸­å¿ƒï¼Œé…ç½®ç®¡ç†è¿˜éœ€è¦Config Server
   Nacosä¸€ä¸ªç»„ä»¶æå®šï¼Œç®€åŒ–æ¶æ„

2. æ§åˆ¶å°å¼ºå¤§ï¼š
   Eurekaæ§åˆ¶å°åŠŸèƒ½ç®€å•ï¼Œåªèƒ½çœ‹æœåŠ¡åˆ—è¡¨
   Nacoså¯ä»¥æ‰‹åŠ¨ä¸Šä¸‹çº¿ã€è°ƒæ•´æƒé‡ã€æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯

3. æŒä¹…åŒ–å­˜å‚¨ï¼š
   Eurekaé‡å¯åæ•°æ®ä¸¢å¤±
   Nacosæ”¯æŒMySQLå­˜å‚¨ï¼Œæ•°æ®æŒä¹…åŒ–
```

### 3.2 å®‰è£…å¯åŠ¨Nacos


**æ–¹å¼ä¸€ï¼šå•æœºå¯åŠ¨**
```bash
# ä¸‹è½½Nacosï¼ˆä»¥2.1.0ä¸ºä¾‹ï¼‰
wget https://github.com/alibaba/nacos/releases/download/2.1.0/nacos-server-2.1.0.tar.gz

# è§£å‹
tar -zxvf nacos-server-2.1.0.tar.gz

# å•æœºæ¨¡å¼å¯åŠ¨
cd nacos/bin
sh startup.sh -m standalone

# è®¿é—®æ§åˆ¶å°
http://localhost:8848/nacos
é»˜è®¤è´¦å·å¯†ç ï¼šnacos/nacos
```

**æ–¹å¼äºŒï¼šDockerå¯åŠ¨**
```bash
# å•æœºæ¨¡å¼
docker run -d \
  --name nacos \
  -p 8848:8848 \
  -e MODE=standalone \
  nacos/nacos-server:v2.1.0
```

### 3.3 æœåŠ¡æ³¨å†Œåˆ°Nacos


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**
```xml
<!-- NacosæœåŠ¡å‘ç°ä¾èµ– -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®æ–‡ä»¶**
```yaml
spring:
  application:
    name: order-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # NacosæœåŠ¡å™¨åœ°å€
        namespace: dev               # å‘½åç©ºé—´ï¼Œç”¨äºç¯å¢ƒéš”ç¦»
        group: DEFAULT_GROUP         # åˆ†ç»„ï¼Œç”¨äºä¸šåŠ¡éš”ç¦»
        
server:
  port: 8080
```

**ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ç±»**
```java
@SpringBootApplication
@EnableDiscoveryClient
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

> ğŸ“Œ **Nacosç‹¬æœ‰æ¦‚å¿µ**
> 
> **Namespaceï¼ˆå‘½åç©ºé—´ï¼‰**ï¼š
> - ç”¨äºç¯å¢ƒéš”ç¦»ï¼šdevã€testã€prod
> - ä¸åŒnamespaceçš„æœåŠ¡äº’ç›¸çœ‹ä¸åˆ°
> 
> **Groupï¼ˆåˆ†ç»„ï¼‰**ï¼š
> - ç”¨äºä¸šåŠ¡éš”ç¦»ï¼šè®¢å•ç»„ã€åº“å­˜ç»„
> - åŒä¸€namespaceä¸‹çš„ç»†åˆ†
> 
> **å±‚çº§å…³ç³»**ï¼š
> ```
> Namespace(dev)
>   â”œâ”€â”€ Group(è®¢å•ç»„)
>   â”‚     â”œâ”€â”€ order-service
>   â”‚     â””â”€â”€ order-query-service
>   â””â”€â”€ Group(åº“å­˜ç»„)
>         â””â”€â”€ stock-service
> ```

### 3.4 Nacosé«˜çº§ç‰¹æ€§


**ğŸ”¸ ä¸´æ—¶å®ä¾‹ vs æŒä¹…å®ä¾‹**

| ç‰¹æ€§ | **ä¸´æ—¶å®ä¾‹** | **æŒä¹…å®ä¾‹** |
|------|------------|------------|
| æ³¨å†Œæ–¹å¼ | `å¿ƒè·³ä¸ŠæŠ¥` | `ä¸»åŠ¨æ³¨å†Œ` |
| å¥åº·æ£€æŸ¥ | `å®¢æˆ·ç«¯ä¸»åŠ¨å‘å¿ƒè·³` | `Nacosä¸»åŠ¨æ¢æµ‹` |
| å®ä¾‹ä¸‹çº¿ | `å¿ƒè·³è¶…æ—¶è‡ªåŠ¨åˆ é™¤` | `éœ€è¦ä¸»åŠ¨æ³¨é”€` |
| é€‚ç”¨åœºæ™¯ | `å¾®æœåŠ¡åº”ç”¨ï¼ˆé»˜è®¤ï¼‰` | `ä¼ ç»Ÿåº”ç”¨ã€æ•°æ®åº“` |

**é…ç½®ä¸´æ—¶å®ä¾‹**ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: true  # true=ä¸´æ—¶å®ä¾‹ï¼Œfalse=æŒä¹…å®ä¾‹
```

**ğŸ”¸ æƒé‡é…ç½®**
```yaml
spring:
  cloud:
    nacos:
      discovery:
        weight: 1  # æƒé‡å€¼0-100ï¼Œæƒé‡è¶Šå¤§ï¼Œè¢«è®¿é—®çš„æ¦‚ç‡è¶Šå¤§
```

**æƒé‡åº”ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šç°åº¦å‘å¸ƒ
æ–°ç‰ˆæœ¬æœåŠ¡ weight=10  â†’ æ¥æ”¶10%æµé‡
è€ç‰ˆæœ¬æœåŠ¡ weight=90  â†’ æ¥æ”¶90%æµé‡

åœºæ™¯2ï¼šæœºå™¨æ€§èƒ½å·®å¼‚
é«˜é…æœºå™¨ weight=80  â†’ å¤„ç†æ›´å¤šè¯·æ±‚
ä½é…æœºå™¨ weight=20  â†’ å¤„ç†è¾ƒå°‘è¯·æ±‚
```

**ğŸ”¸ é›†ç¾¤é…ç½®**
```yaml
spring:
  cloud:
    nacos:
      discovery:
        cluster-name: SH  # é›†ç¾¤åç§°ï¼šä¸Šæµ·æœºæˆ¿
```

**é›†ç¾¤è°ƒç”¨ç­–ç•¥**ï¼š
```
é»˜è®¤ç­–ç•¥ï¼šä¼˜å…ˆåŒé›†ç¾¤è°ƒç”¨
è®¢å•æœåŠ¡(SHé›†ç¾¤) è°ƒç”¨ åº“å­˜æœåŠ¡
â†’ ä¼˜å…ˆè°ƒç”¨åº“å­˜æœåŠ¡çš„SHé›†ç¾¤å®ä¾‹
â†’ SHé›†ç¾¤å…¨æŒ‚äº†ï¼Œæ‰è°ƒç”¨å…¶ä»–é›†ç¾¤

å¥½å¤„ï¼šå‡å°‘è·¨æœºæˆ¿è°ƒç”¨ï¼Œé™ä½å»¶è¿Ÿ
```

### 3.5 Nacosæ§åˆ¶å°æ“ä½œ


**æœåŠ¡åˆ—è¡¨ç®¡ç†**ï¼š
```
æ§åˆ¶å°è·¯å¾„ï¼šæœåŠ¡ç®¡ç† â†’ æœåŠ¡åˆ—è¡¨

å¯æ“ä½œï¼š
âœ… æŸ¥çœ‹æœåŠ¡çš„æ‰€æœ‰å®ä¾‹
âœ… æŸ¥çœ‹å®ä¾‹çš„è¯¦ç»†ä¿¡æ¯ï¼ˆIPã€ç«¯å£ã€å¥åº·çŠ¶æ€ï¼‰
âœ… æ‰‹åŠ¨ä¸Šçº¿/ä¸‹çº¿å®ä¾‹ï¼ˆç”¨äºç°åº¦å‘å¸ƒã€ç»´æŠ¤ï¼‰
âœ… è°ƒæ•´å®ä¾‹æƒé‡ï¼ˆæµé‡è°ƒé…ï¼‰
âœ… ç¼–è¾‘å®ä¾‹å…ƒæ•°æ®ï¼ˆè‡ªå®šä¹‰æ ‡ç­¾ï¼‰
```

**å®ç”¨æŠ€å·§**ï¼š
```
åœºæ™¯1ï¼šæŸå°æœºå™¨è¦ç»´æŠ¤
æ“ä½œï¼šæ§åˆ¶å°æ‰¾åˆ°è¯¥å®ä¾‹ â†’ ç‚¹å‡»"ä¸‹çº¿" â†’ æµé‡è‡ªåŠ¨è½¬åˆ°å…¶ä»–å®ä¾‹

åœºæ™¯2ï¼šæ–°ç‰ˆæœ¬ç°åº¦æµ‹è¯•
æ“ä½œï¼šæ–°ç‰ˆæœ¬å®ä¾‹æƒé‡è®¾ä¸º10 â†’ è§‚å¯Ÿ10%æµé‡è¡¨ç° â†’ é€æ­¥æé«˜æƒé‡

åœºæ™¯3ï¼šç´§æ€¥æ‰©å®¹
æ“ä½œï¼šå¯åŠ¨æ–°å®ä¾‹ â†’ è‡ªåŠ¨æ³¨å†Œåˆ°Nacos â†’ ç«‹å³åˆ†æ‹…æµé‡
```

---

## 4. ğŸ”§ Consulé›†æˆé…ç½®è¯¦è§£


### 4.1 Consulçš„ç‰¹ç‚¹


**Consul vs Nacos/Eureka**ï¼š
```
Consulçš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼š
âœ… å¤šæ•°æ®ä¸­å¿ƒæ”¯æŒï¼šå¤©ç„¶æ”¯æŒå¤šåœ°åŸŸéƒ¨ç½²
âœ… æœåŠ¡ç½‘æ ¼ï¼šå†…ç½®Service Meshèƒ½åŠ›
âœ… KVå­˜å‚¨ï¼šå¯ä»¥å­˜å‚¨é…ç½®ã€å…ƒæ•°æ®
âœ… å¥åº·æ£€æŸ¥çµæ´»ï¼šæ”¯æŒHTTPã€TCPã€Scriptå¤šç§æ–¹å¼

é€‚ç”¨åœºæ™¯ï¼š
ğŸ¯ è·¨åœ°åŸŸå¾®æœåŠ¡æ¶æ„
ğŸ¯ å¤šè¯­è¨€æ··åˆå¼€å‘ï¼ˆGoã€Pythonã€Javaï¼‰
ğŸ¯ éœ€è¦Service Meshèƒ½åŠ›
```

### 4.2 å®‰è£…Consul


**æ–¹å¼ä¸€ï¼šäºŒè¿›åˆ¶å®‰è£…**
```bash
# ä¸‹è½½Consul
wget https://releases.hashicorp.com/consul/1.15.0/consul_1.15.0_linux_amd64.zip

# è§£å‹
unzip consul_1.15.0_linux_amd64.zip

# å¼€å‘æ¨¡å¼å¯åŠ¨
./consul agent -dev

# è®¿é—®UI
http://localhost:8500
```

**æ–¹å¼äºŒï¼šDockerå®‰è£…**
```bash
docker run -d \
  --name consul \
  -p 8500:8500 \
  consul:1.15.0 agent -dev -ui -client=0.0.0.0
```

### 4.3 æœåŠ¡æ³¨å†Œåˆ°Consul


**æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶**
```yaml
spring:
  application:
    name: order-service
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
        health-check-path: /actuator/health  # å¥åº·æ£€æŸ¥è·¯å¾„
        health-check-interval: 10s           # æ£€æŸ¥é—´éš”
        instance-id: ${spring.application.name}:${server.port}

server:
  port: 8080

# å¼€å¯å¥åº·æ£€æŸ¥ç«¯ç‚¹
management:
  endpoints:
    web:
      exposure:
        include: health
```

> âš ï¸ **Consulå¥åº·æ£€æŸ¥å¿…é¡»é…ç½®**
> 
> Consulé»˜è®¤é€šè¿‡HTTPè°ƒç”¨`/actuator/health`æ£€æŸ¥æœåŠ¡çŠ¶æ€
> - å¿…é¡»å¼•å…¥`spring-boot-starter-actuator`ä¾èµ–
> - å¿…é¡»æš´éœ²healthç«¯ç‚¹
> - å¦åˆ™æœåŠ¡ä¼šä¸€ç›´æ˜¾ç¤º"ä¸å¥åº·"çŠ¶æ€

### 4.4 Consulå¤šæ•°æ®ä¸­å¿ƒ


**æ•°æ®ä¸­å¿ƒæ¦‚å¿µ**ï¼š
```
æ•°æ®ä¸­å¿ƒ = ä¸€ä¸ªåœ°ç†åŒºåŸŸçš„Consulé›†ç¾¤

ç¤ºä¾‹æ¶æ„ï¼š
åŒ—äº¬æ•°æ®ä¸­å¿ƒ(dc-beijing)
  â”œâ”€â”€ Consul Serveré›†ç¾¤
  â””â”€â”€ å¾®æœåŠ¡å®ä¾‹

ä¸Šæµ·æ•°æ®ä¸­å¿ƒ(dc-shanghai)
  â”œâ”€â”€ Consul Serveré›†ç¾¤
  â””â”€â”€ å¾®æœåŠ¡å®ä¾‹

å¹¿å·æ•°æ®ä¸­å¿ƒ(dc-guangzhou)
  â”œâ”€â”€ Consul Serveré›†ç¾¤
  â””â”€â”€ å¾®æœåŠ¡å®ä¾‹
```

**è·¨æ•°æ®ä¸­å¿ƒæœåŠ¡å‘ç°**ï¼š
```yaml
spring:
  cloud:
    consul:
      discovery:
        datacenter: dc-beijing  # æŒ‡å®šæ•°æ®ä¸­å¿ƒ
        query-passing: true     # åªè¿”å›å¥åº·çš„æœåŠ¡
```

**è°ƒç”¨é€»è¾‘**ï¼š
```
åŒ—äº¬çš„è®¢å•æœåŠ¡ è°ƒç”¨ åº“å­˜æœåŠ¡ï¼š
1. ä¼˜å…ˆè°ƒç”¨æœ¬åœ°æ•°æ®ä¸­å¿ƒ(dc-beijing)çš„åº“å­˜æœåŠ¡
2. æœ¬åœ°æ— å¯ç”¨å®ä¾‹ï¼ŒæŸ¥è¯¢å…¶ä»–æ•°æ®ä¸­å¿ƒ
3. é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„æ•°æ®ä¸­å¿ƒå®ä¾‹
```

---

## 5. ğŸ” æœåŠ¡å®ä¾‹è·å–æœºåˆ¶


### 5.1 æœåŠ¡å®ä¾‹æ•°æ®ç»“æ„


**ä¸€ä¸ªæœåŠ¡å®ä¾‹åŒ…å«å“ªäº›ä¿¡æ¯**ï¼š
```
ServiceInstanceå¯¹è±¡ï¼š
{
  "serviceId": "stock-service",      // æœåŠ¡å
  "host": "192.168.1.100",          // IPåœ°å€
  "port": 8080,                     // ç«¯å£
  "secure": false,                  // æ˜¯å¦HTTPS
  "metadata": {                     // å…ƒæ•°æ®
    "version": "v1.0",
    "zone": "beijing"
  },
  "uri": "http://192.168.1.100:8080",
  "scheme": "http",
  "instanceId": "192.168.1.100:8080"
}
```

### 5.2 è·å–æœåŠ¡å®ä¾‹çš„æ–¹å¼


**æ–¹å¼ä¸€ï¼šä½¿ç”¨DiscoveryClient**
```java
@Service
public class ServiceDiscoveryDemo {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    public void printServiceInstances() {
        // è·å–æ‰€æœ‰æœåŠ¡å
        List<String> services = discoveryClient.getServices();
        System.out.println("æ‰€æœ‰æœåŠ¡ï¼š" + services);
        
        // è·å–æŒ‡å®šæœåŠ¡çš„æ‰€æœ‰å®ä¾‹
        List<ServiceInstance> instances = 
            discoveryClient.getInstances("stock-service");
        
        for (ServiceInstance instance : instances) {
            System.out.println("å®ä¾‹åœ°å€ï¼š" + instance.getUri());
            System.out.println("å…ƒæ•°æ®ï¼š" + instance.getMetadata());
        }
    }
}
```

**æ–¹å¼äºŒï¼šä½¿ç”¨LoadBalancerClient**
```java
@Service
public class LoadBalancerDemo {
    
    @Autowired
    private LoadBalancerClient loadBalancerClient;
    
    public String callStockService() {
        // ä»å¤šä¸ªå®ä¾‹ä¸­é€‰æ‹©ä¸€ä¸ªï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
        ServiceInstance instance = 
            loadBalancerClient.choose("stock-service");
        
        String url = instance.getUri() + "/stock/deduct";
        
        // ä½¿ç”¨é€‰ä¸­çš„å®ä¾‹è°ƒç”¨
        RestTemplate restTemplate = new RestTemplate();
        return restTemplate.getForObject(url, String.class);
    }
}
```

**æ–¹å¼ä¸‰ï¼šä½¿ç”¨@LoadBalancedçš„RestTemplateï¼ˆæœ€å¸¸ç”¨ï¼‰**
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;  // å·²é…ç½®@LoadBalanced
    
    public String createOrder() {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡
        String url = "http://stock-service/stock/deduct";
        return restTemplate.getForObject(url, String.class);
    }
}
```

**ğŸ”¹ ä¸‰ç§æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | **ä½¿ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|-----|------------|---------|---------|
| `DiscoveryClient` | `éœ€è¦è·å–æ‰€æœ‰å®ä¾‹ä¿¡æ¯` | `çµæ´»ï¼Œå¯è‡ªå®šä¹‰é€»è¾‘` | `éœ€è¦æ‰‹åŠ¨è´Ÿè½½å‡è¡¡` |
| `LoadBalancerClient` | `éœ€è¦æ‰‹åŠ¨é€‰æ‹©å®ä¾‹` | `æä¾›è´Ÿè½½å‡è¡¡èƒ½åŠ›` | `ä»£ç ç¨å¤æ‚` |
| `@LoadBalanced` | `æ™®é€šæœåŠ¡è°ƒç”¨` | `ç®€å•ï¼Œè‡ªåŠ¨è´Ÿè½½å‡è¡¡` | `çµæ´»æ€§ç¨ä½` |

---

## 6. ğŸ”„ åŠ¨æ€æœåŠ¡åˆ—è¡¨æ›´æ–°


### 6.1 æœåŠ¡åˆ—è¡¨æ›´æ–°æœºåˆ¶


**æ•´ä½“æµç¨‹**ï¼š
```
æœåŠ¡æ³¨å†Œ â†’ æ³¨å†Œä¸­å¿ƒå­˜å‚¨ â†’ æœåŠ¡æ¶ˆè´¹è€…å®šæœŸæ‹‰å– â†’ æœ¬åœ°ç¼“å­˜æ›´æ–°

è¯¦ç»†è¿‡ç¨‹ï¼š
1. åº“å­˜æœåŠ¡å¯åŠ¨ â†’ æ³¨å†Œåˆ°Nacos â†’ æœåŠ¡åˆ—è¡¨å˜æ›´
2. Nacoså­˜å‚¨æœ€æ–°çš„æœåŠ¡åˆ—è¡¨
3. è®¢å•æœåŠ¡æ¯30ç§’æ‹‰å–ä¸€æ¬¡æœåŠ¡åˆ—è¡¨ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
4. å‘ç°åº“å­˜æœåŠ¡æœ‰å˜åŒ– â†’ æ›´æ–°æœ¬åœ°ç¼“å­˜
5. ä¸‹æ¬¡è°ƒç”¨æ—¶ä½¿ç”¨æœ€æ–°çš„æœåŠ¡åˆ—è¡¨
```

**ä¸‰ç§æ›´æ–°æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | **å®ç°åŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|-----|------------|---------|---------|
| `å®šæ—¶æ‹‰å–` | `å®¢æˆ·ç«¯å®šæ—¶æŸ¥è¯¢æ³¨å†Œä¸­å¿ƒ` | `ç®€å•ï¼ŒæœåŠ¡ç«¯å‹åŠ›å°` | `å®æ—¶æ€§å·®ï¼ˆæœ€å¤šå»¶è¿Ÿ30ç§’ï¼‰` |
| `é•¿è½®è¯¢` | `å®¢æˆ·ç«¯ç­‰å¾…ï¼Œæœ‰å˜æ›´ç«‹å³è¿”å›` | `å®æ—¶æ€§å¥½` | `å ç”¨è¿æ¥` |
| `æ¨é€` | `æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€å˜æ›´` | `å®æ—¶æ€§æœ€å¥½` | `æœåŠ¡ç«¯å®ç°å¤æ‚` |

### 6.2 Eurekaçš„æ›´æ–°æœºåˆ¶


**å®šæ—¶æ‹‰å–**ï¼š
```yaml
eureka:
  client:
    registry-fetch-interval-seconds: 30  # æ¯30ç§’æ‹‰å–ä¸€æ¬¡æœåŠ¡åˆ—è¡¨
    
  instance:
    lease-renewal-interval-in-seconds: 30  # å¿ƒè·³é—´éš”30ç§’
    lease-expiration-duration-in-seconds: 90  # 90ç§’æ²¡å¿ƒè·³å°±å‰”é™¤
```

**æ›´æ–°æµç¨‹å›¾**ï¼š
```
æ—¶é—´è½´ï¼š
0ç§’   - è®¢å•æœåŠ¡æ‹‰å–æœåŠ¡åˆ—è¡¨ â†’ åº“å­˜æœåŠ¡ï¼šAã€B
30ç§’  - åº“å­˜æœåŠ¡Cå¯åŠ¨å¹¶æ³¨å†Œ
35ç§’  - è®¢å•æœåŠ¡æ‹‰å–æœåŠ¡åˆ—è¡¨ â†’ åº“å­˜æœåŠ¡ï¼šAã€Bã€Cï¼ˆå‘ç°æ–°å®ä¾‹ï¼‰
60ç§’  - åº“å­˜æœåŠ¡Aå®•æœºï¼Œåœæ­¢å‘å¿ƒè·³
90ç§’  - Eurekaæ£€æµ‹åˆ°Aå¿ƒè·³è¶…æ—¶ â†’ æ ‡è®°ä¸ºä¸‹çº¿
95ç§’  - è®¢å•æœåŠ¡æ‹‰å–æœåŠ¡åˆ—è¡¨ â†’ åº“å­˜æœåŠ¡ï¼šBã€Cï¼ˆAå·²ç§»é™¤ï¼‰
```

> ğŸ’¡ **ç†è§£å»¶è¿Ÿ**
> 
> æ–°æœåŠ¡ä¸Šçº¿åˆ°è¢«å‘ç°ï¼Œæœ€é•¿å»¶è¿Ÿï¼š
> - Eurekaï¼šå¿ƒè·³é—´éš”(30ç§’) + æ‹‰å–é—´éš”(30ç§’) = 60ç§’
> - å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼šå¿ƒè·³15ç§’ï¼Œæ‹‰å–15ç§’ = 30ç§’å»¶è¿Ÿ

### 6.3 Nacosçš„æ›´æ–°æœºåˆ¶


**æ¨é€+æ‹‰å–ç»“åˆ**ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        watch:
          enabled: true  # å¼€å¯æœåŠ¡åˆ—è¡¨ç›‘å¬ï¼ˆæ¨é€æ¨¡å¼ï¼‰
```

**Nacosçš„ä¼˜åŠ¿**ï¼š
```
æ‹‰å–æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š
- å®¢æˆ·ç«¯æ¯10ç§’æ‹‰å–ä¸€æ¬¡
- ç±»ä¼¼Eureka

æ¨é€æ¨¡å¼ï¼ˆwatch.enabled=trueï¼‰ï¼š
- ä½¿ç”¨UDPé•¿è¿æ¥ç›‘å¬
- æœåŠ¡åˆ—è¡¨å˜æ›´ â†’ Nacosç«‹å³æ¨é€ â†’ å®¢æˆ·ç«¯å®æ—¶æ›´æ–°
- å»¶è¿Ÿå¯ä»¥é™åˆ°1ç§’å†…
```

**æ›´æ–°æµç¨‹**ï¼š
```
æ¨é€æ¨¡å¼ï¼š
1. è®¢å•æœåŠ¡å¯åŠ¨ â†’ å»ºç«‹UDPè¿æ¥ â†’ ç›‘å¬æœåŠ¡å˜æ›´
2. åº“å­˜æœåŠ¡Cæ³¨å†Œ â†’ Nacosç«‹å³æ¨é€å˜æ›´ â†’ è®¢å•æœåŠ¡1ç§’å†…æ„ŸçŸ¥
3. åº“å­˜æœåŠ¡Aä¸‹çº¿ â†’ Nacosç«‹å³æ¨é€ â†’ è®¢å•æœåŠ¡ç«‹å³å‰”é™¤

å¯¹æ¯”ï¼š
Eurekaï¼šæœ€é•¿60ç§’å»¶è¿Ÿ
Nacosæ¨é€ï¼š1ç§’å†…å®æ—¶æ›´æ–°
```

### 6.4 æ‰‹åŠ¨åˆ·æ–°æœåŠ¡åˆ—è¡¨


**åœºæ™¯**ï¼šç´§æ€¥æƒ…å†µä¸‹éœ€è¦ç«‹å³åˆ·æ–°
```java
@RestController
@RequestMapping("/admin")
public class AdminController {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    /**
     * æ‰‹åŠ¨è§¦å‘æœåŠ¡åˆ—è¡¨åˆ·æ–°
     */
    @PostMapping("/refresh-services")
    public String refreshServices() {
        // Eurekaæ–¹å¼ï¼šè§¦å‘ç¼“å­˜åˆ·æ–°
        if (discoveryClient instanceof EurekaDiscoveryClient) {
            ((EurekaDiscoveryClient) discoveryClient)
                .getEurekaClient()
                .getApplications()
                .shuffleInstances(true);  // é‡æ–°æ´—ç‰Œ
        }
        
        return "æœåŠ¡åˆ—è¡¨å·²åˆ·æ–°";
    }
}
```

---

## 7. ğŸ’“ æœåŠ¡å¥åº·çŠ¶æ€æ£€æŸ¥


### 7.1 å¥åº·æ£€æŸ¥çš„é‡è¦æ€§


> ğŸ¥ **åŒ»ç–—ç±»æ¯”**
> 
> æœåŠ¡å¥åº·æ£€æŸ¥å°±åƒå®šæœŸä½“æ£€ï¼š
> - **å¿ƒè·³æ£€æµ‹**ï¼šæ¯éš”ä¸€æ®µæ—¶é—´é—®"è¿˜æ´»ç€å—ï¼Ÿ"
> - **æ·±åº¦æ£€æŸ¥**ï¼šä¸ä»…è¦æ´»ç€ï¼Œè¿˜è¦èƒ½æ­£å¸¸å·¥ä½œ
> - **è‡ªåŠ¨éš”ç¦»**ï¼šæ£€æŸ¥ä¸é€šè¿‡çš„æœåŠ¡è‡ªåŠ¨ä¸‹çº¿

**å¥åº·æ£€æŸ¥çš„ä½œç”¨**ï¼š
```
1. åŠæ—¶å‘ç°æ•…éšœï¼š
   æ•°æ®åº“è¿æ¥æ–­äº† â†’ å¥åº·æ£€æŸ¥å¤±è´¥ â†’ è‡ªåŠ¨ä¸‹çº¿

2. é¿å…æµé‡æ‰“åˆ°æ•…éšœèŠ‚ç‚¹ï¼š
   æœåŠ¡Aå¥åº·æ£€æŸ¥å¤±è´¥ â†’ Nacosæ ‡è®°ä¸ºä¸å¥åº· â†’ æµé‡ä¸å†è½¬å‘

3. æ”¯æŒä¼˜é›…ä¸Šä¸‹çº¿ï¼š
   æœåŠ¡å¯åŠ¨ â†’ å…ˆæ ‡è®°ä¸ºä¸å¥åº· â†’ é¢„çƒ­å®Œæˆ â†’ æ ‡è®°ä¸ºå¥åº· â†’ å¼€å§‹æ¥æ”¶æµé‡
```

### 7.2 Eurekaçš„å¥åº·æ£€æŸ¥


**å¿ƒè·³æœºåˆ¶**ï¼š
```yaml
eureka:
  instance:
    lease-renewal-interval-in-seconds: 30  # æ¯30ç§’å‘ä¸€æ¬¡å¿ƒè·³
    lease-expiration-duration-in-seconds: 90  # 90ç§’æ”¶ä¸åˆ°å¿ƒè·³å°±ä¸‹çº¿
```

**å¿ƒè·³æµç¨‹**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
è®¢å•æœåŠ¡ â†’ æ¯30ç§’å‘å¿ƒè·³ â†’ Eurekaè®°å½•æœ€åå¿ƒè·³æ—¶é—´

æ•…éšœæƒ…å†µï¼š
è®¢å•æœåŠ¡å®•æœº â†’ åœæ­¢å‘å¿ƒè·³ â†’ Eureka 90ç§’åæ£€æµ‹åˆ°è¶…æ—¶ â†’ å‰”é™¤è¯¥å®ä¾‹

ç½‘ç»œæŠ–åŠ¨ï¼š
è®¢å•æœåŠ¡æ­£å¸¸ï¼Œä½†ç½‘ç»œä¸¢åŒ… â†’ å¿ƒè·³æœªåˆ°è¾¾ â†’ Eurekaåˆ¤æ–­ä¸ºæ•…éšœ
â†’ è§¦å‘è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ï¼ˆä¿ç•™å®ä¾‹ï¼Œä¸å‰”é™¤ï¼‰
```

**è‡ªå®šä¹‰å¥åº·æ£€æŸ¥**ï¼š
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try {
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            Connection conn = dataSource.getConnection();
            conn.close();
            return Health.up().build();  // å¥åº·
        } catch (Exception e) {
            return Health.down()
                .withDetail("error", e.getMessage())
                .build();  // ä¸å¥åº·
        }
    }
}
```

### 7.3 Nacosçš„å¥åº·æ£€æŸ¥


**ä¸´æ—¶å®ä¾‹ï¼ˆé»˜è®¤ï¼‰**ï¼š
```
å®¢æˆ·ç«¯ä¸»åŠ¨ä¸ŠæŠ¥ï¼š
1. æœåŠ¡å¯åŠ¨ â†’ æ³¨å†Œåˆ°Nacos
2. æ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
3. 15ç§’å†…æ²¡æ”¶åˆ°å¿ƒè·³ â†’ æ ‡è®°ä¸ºä¸å¥åº·
4. 30ç§’å†…æ²¡æ”¶åˆ°å¿ƒè·³ â†’ ç›´æ¥åˆ é™¤å®ä¾‹
```

**æŒä¹…å®ä¾‹**ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false  # ä½¿ç”¨æŒä¹…å®ä¾‹
        heart-beat-interval: 5000  # å¿ƒè·³é—´éš”5ç§’
```

**æŒä¹…å®ä¾‹å¥åº·æ£€æŸ¥**ï¼š
```
Nacosä¸»åŠ¨æ¢æµ‹ï¼š
1. Nacosæ¯éš”ä¸€å®šæ—¶é—´ä¸»åŠ¨è°ƒç”¨æœåŠ¡çš„å¥åº·æ£€æŸ¥æ¥å£
2. HTTPæ–¹å¼ï¼šè®¿é—® /actuator/health
3. TCPæ–¹å¼ï¼šå°è¯•å»ºç«‹TCPè¿æ¥
4. æ¢æµ‹å¤±è´¥ â†’ æ ‡è®°ä¸ºä¸å¥åº·ï¼ˆä½†ä¸åˆ é™¤ï¼‰
5. æ¢å¤åè‡ªåŠ¨æ ‡è®°ä¸ºå¥åº·
```

### 7.4 Consulçš„å¥åº·æ£€æŸ¥


**å¤šç§æ£€æŸ¥æ–¹å¼**ï¼š
```yaml
spring:
  cloud:
    consul:
      discovery:
        health-check-path: /actuator/health  # HTTPæ£€æŸ¥
        health-check-interval: 10s           # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        health-check-timeout: 5s             # è¶…æ—¶æ—¶é—´5ç§’
        health-check-critical-timeout: 30s   # è¿ç»­å¤±è´¥30ç§’åå‰”é™¤
```

**å¥åº·æ£€æŸ¥ç±»å‹**ï¼š

| ç±»å‹ | **é…ç½®ç¤ºä¾‹** | **è¯´æ˜** |
|-----|------------|---------|
| `HTTP` | `health-check-path: /health` | `GETè¯·æ±‚ï¼Œè¿”å›200è¡¨ç¤ºå¥åº·` |
| `TCP` | `health-check-tcp: true` | `å°è¯•å»ºç«‹TCPè¿æ¥` |
| `Script` | `health-check-script: check.sh` | `æ‰§è¡Œè„šæœ¬ï¼Œé€€å‡ºç 0è¡¨ç¤ºå¥åº·` |
| `TTL` | `health-check-ttl: 30s` | `æœåŠ¡ä¸»åŠ¨æ›´æ–°å¥åº·çŠ¶æ€` |

**Scriptå¥åº·æ£€æŸ¥ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# check.sh

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
nc -z localhost 8080
if [ $? -eq 0 ]; then
  echo "Service is healthy"
  exit 0
else
  echo "Service is down"
  exit 1
fi
```

### 7.5 è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘


**ç»¼åˆå¥åº·æ£€æŸ¥**ï¼š
```java
@Component
public class ComprehensiveHealthIndicator implements HealthIndicator {
    
    @Autowired
    private DataSource dataSource;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Override
    public Health health() {
        Map<String, Object> details = new HashMap<>();
        
        // æ£€æŸ¥æ•°æ®åº“
        boolean dbHealthy = checkDatabase();
        details.put("database", dbHealthy ? "UP" : "DOWN");
        
        // æ£€æŸ¥Redis
        boolean redisHealthy = checkRedis();
        details.put("redis", redisHealthy ? "UP" : "DOWN");
        
        // æ£€æŸ¥ç£ç›˜ç©ºé—´
        boolean diskHealthy = checkDiskSpace();
        details.put("disk", diskHealthy ? "UP" : "DOWN");
        
        // åªè¦æœ‰ä¸€ä¸ªä¸å¥åº·ï¼Œå°±æ ‡è®°ä¸ºDOWN
        if (dbHealthy && redisHealthy && diskHealthy) {
            return Health.up().withDetails(details).build();
        } else {
            return Health.down().withDetails(details).build();
        }
    }
    
    private boolean checkDatabase() {
        try {
            dataSource.getConnection().close();
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    private boolean checkRedis() {
        try {
            redisTemplate.opsForValue().get("health-check");
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    private boolean checkDiskSpace() {
        File disk = new File("/");
        long usableSpace = disk.getUsableSpace();
        long totalSpace = disk.getTotalSpace();
        double usagePercent = 1.0 - ((double) usableSpace / totalSpace);
        return usagePercent < 0.9;  // ç£ç›˜ä½¿ç”¨ç‡ä½äº90%ä¸ºå¥åº·
    }
}
```

---

## 8. ğŸ”„ æ•…éšœè½¬ç§»å®ç°


### 8.1 ä»€ä¹ˆæ˜¯æ•…éšœè½¬ç§»


> ğŸš— **äº¤é€šç±»æ¯”**
> 
> å°±åƒå¼€è½¦é‡åˆ°å µè½¦ï¼š
> - **ä¸»è·¯å µäº†**ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨è·¯çº¿
> - **æ”¶è´¹ç«™å…³é—­**ï¼šé€‰æ‹©å…¶ä»–æ”¶è´¹ç«™
> - **ç›®çš„åœ°å…³é—¨**ï¼šæ‰¾é™„è¿‘çš„å¤‡ç”¨åœ°ç‚¹

**æ•…éšœè½¬ç§»çš„æ ¸å¿ƒ**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
è®¢å•æœåŠ¡ â†’ è°ƒç”¨åº“å­˜æœåŠ¡A â†’ æˆåŠŸ

Aæ•…éšœï¼š
è®¢å•æœåŠ¡ â†’ è°ƒç”¨åº“å­˜æœåŠ¡A â†’ å¤±è´¥
         â†’ è‡ªåŠ¨é‡è¯•åº“å­˜æœåŠ¡B â†’ æˆåŠŸ  â† è¿™å°±æ˜¯æ•…éšœè½¬ç§»
```

### 8.2 å®¢æˆ·ç«¯æ•…éšœè½¬ç§»


**Ribbonçš„é‡è¯•æœºåˆ¶**ï¼š
```yaml
# Ribboné…ç½®
ribbon:
  ConnectTimeout: 3000              # è¿æ¥è¶…æ—¶3ç§’
  ReadTimeout: 5000                 # è¯»å–è¶…æ—¶5ç§’
  MaxAutoRetries: 1                 # åŒä¸€å®ä¾‹æœ€å¤šé‡è¯•1æ¬¡
  MaxAutoRetriesNextServer: 2       # æ¢å®ä¾‹æœ€å¤šé‡è¯•2æ¬¡
  OkToRetryOnAllOperations: false   # åªå¯¹GETè¯·æ±‚é‡è¯•
```

**é‡è¯•æµç¨‹**ï¼š
```
åœºæ™¯ï¼šè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡ï¼Œæœ‰3ä¸ªå®ä¾‹Aã€Bã€C

ç¬¬1æ¬¡è°ƒç”¨ï¼š
è®¢å•æœåŠ¡ â†’ é€‰æ‹©å®ä¾‹A â†’ è¿æ¥è¶…æ—¶(3ç§’) 
         â†’ é‡è¯•å®ä¾‹A â†’ å†æ¬¡è¶…æ—¶
         â†’ MaxAutoRetries=1ï¼Œä¸å†é‡è¯•A

ç¬¬2æ¬¡è°ƒç”¨ï¼ˆæ¢å®ä¾‹ï¼‰ï¼š
è®¢å•æœåŠ¡ â†’ é€‰æ‹©å®ä¾‹B â†’ è¯»å–è¶…æ—¶(5ç§’)
         â†’ é‡è¯•å®ä¾‹B â†’ æˆåŠŸè¿”å›

ç¬¬3æ¬¡è°ƒç”¨ï¼ˆå†æ¢å®ä¾‹ï¼‰ï¼š
å¦‚æœBä¹Ÿå¤±è´¥ â†’ é€‰æ‹©å®ä¾‹C â†’ MaxAutoRetriesNextServer=2å…è®¸
å¦‚æœCä¹Ÿå¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸ï¼Œè°ƒç”¨å¤±è´¥
```

> âš ï¸ **é‡è¯•çš„å‘**
> 
> `OkToRetryOnAllOperations: false` éå¸¸é‡è¦ï¼
> - trueï¼šæ‰€æœ‰è¯·æ±‚éƒ½é‡è¯•ï¼ˆå±é™©ï¼ï¼‰
> - falseï¼šåªå¯¹GETé‡è¯•
> 
> **ä¸ºä»€ä¹ˆPOSTä¸èƒ½é‡è¯•ï¼Ÿ**
> ```
> POSTè¯·æ±‚åˆ›å»ºè®¢å•ï¼š
> ç¬¬1æ¬¡ â†’ è¶…æ—¶(ä½†å®é™…å·²åˆ›å»ºè®¢å•)
> ç¬¬2æ¬¡é‡è¯• â†’ æˆåŠŸ(åˆåˆ›å»ºäº†ä¸€ä¸ªè®¢å•)
> ç»“æœï¼šè®¢å•é‡å¤äº†ï¼
> 
> GETè¯·æ±‚æŸ¥è¯¢è®¢å•ï¼š
> ç¬¬1æ¬¡ â†’ è¶…æ—¶
> ç¬¬2æ¬¡é‡è¯• â†’ æˆåŠŸ
> ç»“æœï¼šæ²¡é—®é¢˜ï¼ŒæŸ¥è¯¢æ˜¯å¹‚ç­‰çš„
> ```

**Spring Cloud LoadBalanceré‡è¯•**ï¼š
```yaml
spring:
  cloud:
    loadbalancer:
      retry:
        enabled: true
        max-retries-on-same-service-instance: 1
        max-retries-on-next-service-instance: 2
        retry-on-all-operations: false
```

### 8.3 æ³¨å†Œä¸­å¿ƒæ•…éšœè½¬ç§»


**Eurekaçš„é«˜å¯ç”¨é›†ç¾¤**ï¼š
```yaml
# Eureka Server 1ï¼ˆåŒ—äº¬ï¼‰
eureka:
  instance:
    hostname: eureka-beijing
  client:
    service-url:
      defaultZone: http://eureka-shanghai:8762/eureka/  # æ³¨å†Œåˆ°å¯¹æ–¹

# Eureka Server 2ï¼ˆä¸Šæµ·ï¼‰
eureka:
  instance:
    hostname: eureka-shanghai
  client:
    service-url:
      defaultZone: http://eureka-beijing:8761/eureka/  # æ³¨å†Œåˆ°å¯¹æ–¹
```

**å®¢æˆ·ç«¯é…ç½®å¤šä¸ªæ³¨å†Œä¸­å¿ƒ**ï¼š
```yaml
eureka:
  client:
    service-url:
      defaultZone: http://eureka-beijing:8761/eureka/,http://eureka-shanghai:8762/eureka/
```

**æ•…éšœè½¬ç§»é€»è¾‘**ï¼š
```
1. å®¢æˆ·ç«¯å‘åŒ—äº¬Eurekaæ³¨å†Œ
2. åŒ—äº¬Eurekaå®•æœº
3. å®¢æˆ·ç«¯è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸Šæµ·Eureka
4. ç»§ç»­æ³¨å†Œå’Œå¿ƒè·³
5. åŒ—äº¬Eurekaæ¢å¤åï¼Œå®¢æˆ·ç«¯é‡æ–°è¿æ¥
```

**Nacosé›†ç¾¤æ•…éšœè½¬ç§»**ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.1.100:8848,192.168.1.101:8848,192.168.1.102:8848
```

**å¤šæ³¨å†Œä¸­å¿ƒè¿æ¥ç­–ç•¥**ï¼š
```
åˆå§‹è¿æ¥ï¼š
å®¢æˆ·ç«¯éšæœºé€‰æ‹©ä¸€ä¸ªNacosèŠ‚ç‚¹è¿æ¥

èŠ‚ç‚¹æ•…éšœï¼š
å½“å‰èŠ‚ç‚¹ä¸å¯ç”¨ â†’ åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

å¥åº·æ£€æŸ¥ï¼š
æ¯éš”5ç§’æ£€æµ‹å½“å‰èŠ‚ç‚¹æ˜¯å¦å¥åº·
ä¸å¥åº· â†’ ç«‹å³åˆ‡æ¢
å¥åº· â†’ ç»§ç»­ä½¿ç”¨
```

### 8.4 æœåŠ¡é™çº§ä¸ç†”æ–­


**é…åˆSentinelå®ç°**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @SentinelResource(
        value = "deductStock",
        fallback = "deductStockFallback"  // é™çº§æ–¹æ³•
    )
    public String deductStock(Long productId) {
        // è°ƒç”¨åº“å­˜æœåŠ¡
        String url = "http://stock-service/stock/deduct/" + productId;
        return restTemplate.getForObject(url, String.class);
    }
    
    /**
     * é™çº§æ–¹æ³•ï¼šåº“å­˜æœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
     */
    public String deductStockFallback(Long productId, Throwable ex) {
        // è®°å½•å¼‚å¸¸
        System.err.println("åº“å­˜æœåŠ¡è°ƒç”¨å¤±è´¥ï¼š" + ex.getMessage());
        
        // è¿”å›é™çº§å“åº”
        return "åº“å­˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•";
    }
}
```

**ç†”æ–­å™¨çŠ¶æ€æœº**ï¼š
```
å…³é—­çŠ¶æ€(Closed)
  â†“ é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼(å¦‚50%)
åŠå¼€çŠ¶æ€(Half-Open)
  â†“ å…è®¸å°‘é‡è¯·æ±‚å°è¯•
  â”œâ”€ æˆåŠŸ â†’ å…³é—­çŠ¶æ€(æ¢å¤)
  â””â”€ å¤±è´¥ â†’ æ‰“å¼€çŠ¶æ€

æ‰“å¼€çŠ¶æ€(Open)
  â†“ ç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œå¿«é€Ÿå¤±è´¥
  â†“ ç­‰å¾…ä¸€æ®µæ—¶é—´å
åŠå¼€çŠ¶æ€(Half-Open)
```

**é…ç½®ç†”æ–­è§„åˆ™**ï¼š
```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080  # Sentinelæ§åˆ¶å°
      
# ç†”æ–­è§„åˆ™ï¼ˆåœ¨Sentinelæ§åˆ¶å°é…ç½®ï¼‰
è§„åˆ™ï¼š
- èµ„æºåï¼šdeductStock
- é˜ˆå€¼ç±»å‹ï¼šé”™è¯¯ç‡
- é˜ˆå€¼ï¼š50%ï¼ˆé”™è¯¯ç‡è¶…è¿‡50%è§¦å‘ç†”æ–­ï¼‰
- ç†”æ–­æ—¶é•¿ï¼š10ç§’
- æœ€å°è¯·æ±‚æ•°ï¼š5ï¼ˆè‡³å°‘5ä¸ªè¯·æ±‚æ‰è®¡ç®—é”™è¯¯ç‡ï¼‰
```

---

## 9. ğŸ”— å¤šæ³¨å†Œä¸­å¿ƒæ”¯æŒ


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦å¤šæ³¨å†Œä¸­å¿ƒ


**ä½¿ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šæ··åˆæ¶æ„è¿ç§»
è€ç³»ç»Ÿä½¿ç”¨Eureka
æ–°ç³»ç»Ÿä½¿ç”¨Nacos
è¿ç§»æœŸéœ€è¦ä¸¤ä¸ªæ³¨å†Œä¸­å¿ƒå…±å­˜

åœºæ™¯2ï¼šå¤šäº‘éƒ¨ç½²
é˜¿é‡Œäº‘ç”¨Nacos
AWSç”¨Consul
éœ€è¦åŒæ—¶æ³¨å†Œåˆ°ä¸¤ä¸ªä¸­å¿ƒ

åœºæ™¯3ï¼šç°åº¦å‘å¸ƒ
æ ¸å¿ƒæœåŠ¡æ³¨å†Œåˆ°ç¨³å®šçš„Eureka
æ–°åŠŸèƒ½æœåŠ¡æ³¨å†Œåˆ°Nacosæµ‹è¯•
```

### 9.2 åŒæ—¶æ³¨å†Œåˆ°å¤šä¸ªæ³¨å†Œä¸­å¿ƒ


**æ·»åŠ å¤šä¸ªä¾èµ–**ï¼š
```xml
<!-- Nacosä¾èµ– -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<!-- Eurekaä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶**ï¼š
```yaml
spring:
  application:
    name: order-service
  cloud:
    # Nacosé…ç½®
    nacos:
      discovery:
        server-addr: localhost:8848
        enabled: true
    
# Eurekaé…ç½®
eureka:
  client:
    enabled: true
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
```

**æ•ˆæœ**ï¼š
```
è®¢å•æœåŠ¡å¯åŠ¨åï¼š
1. æ³¨å†Œåˆ°Nacos â†’ æ–°æœåŠ¡å¯ä»¥å‘ç°
2. æ³¨å†Œåˆ°Eureka â†’ è€æœåŠ¡å¯ä»¥å‘ç°
3. åŒæ—¶è¢«ä¸¤ä¸ªæ³¨å†Œä¸­å¿ƒç®¡ç†
```

### 9.3 æ ¹æ®ç¯å¢ƒé€‰æ‹©æ³¨å†Œä¸­å¿ƒ


**Profileé…ç½®**ï¼š
```yaml
# application.ymlï¼ˆå…¬å…±é…ç½®ï¼‰
spring:
  application:
    name: order-service

---
# application-dev.ymlï¼ˆå¼€å‘ç¯å¢ƒç”¨Nacosï¼‰
spring:
  config:
    activate:
      on-profile: dev
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848

---
# application-prod.ymlï¼ˆç”Ÿäº§ç¯å¢ƒç”¨Eurekaï¼‰
spring:
  config:
    activate:
      on-profile: prod

eureka:
  client:
    service-url:
      defaultZone: http://eureka-prod:8761/eureka/
```

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
java -jar order-service.jar --spring.profiles.active=dev

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
java -jar order-service.jar --spring.profiles.active=prod
```

### 9.4 æœåŠ¡è°ƒç”¨è·¨æ³¨å†Œä¸­å¿ƒ


**åœºæ™¯**ï¼šè®¢å•æœåŠ¡åœ¨Nacosï¼Œåº“å­˜æœåŠ¡åœ¨Eureka

**æ–¹æ¡ˆä¸€ï¼šåŒæ³¨å†Œ**
```
è®¢å•æœåŠ¡ï¼š
æ³¨å†Œåˆ°Nacos âœ“
æ³¨å†Œåˆ°Eureka âœ“  â†’ å¯ä»¥è¢«Eurekaçš„æœåŠ¡å‘ç°

åº“å­˜æœåŠ¡ï¼š
æ³¨å†Œåˆ°Eureka âœ“
æ³¨å†Œåˆ°Nacos âœ“  â†’ å¯ä»¥è¢«Nacosçš„æœåŠ¡å‘ç°

ä¼˜ç‚¹ï¼šç®€å•ï¼ŒåŒå‘å¯è§
ç¼ºç‚¹ï¼šç»´æŠ¤ä¸¤å¥—æ³¨å†Œä¿¡æ¯
```

**æ–¹æ¡ˆäºŒï¼šç½‘å…³è½¬å‘**
```
æ¶æ„ï¼š
è®¢å•æœåŠ¡(Nacos) â†’ APIç½‘å…³ â†’ åº“å­˜æœåŠ¡(Eureka)

ç½‘å…³åŒæ—¶è¿æ¥Nacoså’ŒEurekaï¼š
1. è®¢å•æœåŠ¡è°ƒç”¨ç½‘å…³
2. ç½‘å…³ä»Eurekaè·å–åº“å­˜æœåŠ¡åœ°å€
3. ç½‘å…³è½¬å‘è¯·æ±‚åˆ°åº“å­˜æœåŠ¡

ä¼˜ç‚¹ï¼šæœåŠ¡åªéœ€æ³¨å†Œä¸€ä¸ªä¸­å¿ƒ
ç¼ºç‚¹ï¼šå¢åŠ ç½‘å…³è¿™ä¸€è·³
```

**æ–¹æ¡ˆä¸‰ï¼šè‡ªå®šä¹‰æœåŠ¡å‘ç°**
```java
@Configuration
public class MultiRegistryConfig {
    
    @Bean
    public CompositeDiscoveryClient compositeDiscoveryClient(
        List<DiscoveryClient> discoveryClients) {
        return new CompositeDiscoveryClient(discoveryClients);
    }
}

// CompositeDiscoveryClientä¼šèšåˆæ‰€æœ‰æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡
// è°ƒç”¨æ—¶è‡ªåŠ¨ä»Nacoså’ŒEurekaä¸­æŸ¥æ‰¾
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡æ³¨å†Œå‘ç°æœ¬è´¨ï¼šå¾®æœåŠ¡ç‰ˆçš„"é€šè®¯å½•"ï¼Œè§£å†³æœåŠ¡é—´å¦‚ä½•æ‰¾åˆ°å½¼æ­¤
ğŸ”¸ ä¸‰å¤§æ³¨å†Œä¸­å¿ƒï¼šEureka(è€å°†)ã€Nacos(æ–°ç§€)ã€Consul(å›½é™…èŒƒ)
ğŸ”¸ æœåŠ¡å®ä¾‹ï¼šåŒ…å«IPã€ç«¯å£ã€å…ƒæ•°æ®ç­‰ä¿¡æ¯çš„å®Œæ•´åœ°å€
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šç¡®ä¿æµé‡åªæ‰“åˆ°å¥åº·çš„æœåŠ¡å®ä¾‹
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å®ä¾‹
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦æ³¨å†Œä¸­å¿ƒ**
```
æ²¡æœ‰æ³¨å†Œä¸­å¿ƒï¼š
è®¢å•æœåŠ¡ â†’ ç¡¬ç¼–ç IP â†’ http://192.168.1.100:8080/stock
âŒ IPå˜äº†è¦æ”¹ä»£ç 
âŒ æ‰©å®¹äº†ä¸çŸ¥é“æ–°åœ°å€
âŒ å®•æœºäº†ç»§ç»­è°ƒç”¨æŒ‚æ‰çš„æœåŠ¡

æœ‰äº†æ³¨å†Œä¸­å¿ƒï¼š
è®¢å•æœåŠ¡ â†’ é—®æ³¨å†Œä¸­å¿ƒ â†’ è·å–æœ€æ–°åœ°å€åˆ—è¡¨ â†’ è‡ªåŠ¨è´Ÿè½½å‡è¡¡
âœ… IPå˜äº†è‡ªåŠ¨æ›´æ–°
âœ… æ‰©å®¹äº†è‡ªåŠ¨å‘ç°
âœ… å®•æœºäº†è‡ªåŠ¨å‰”é™¤
```

**ğŸ”¹ Eureka vs Nacos vs Consulå¦‚ä½•é€‰æ‹©**
```
é€‰æ‹©Eurekaï¼š
- è€é¡¹ç›®å·²ç»åœ¨ç”¨ï¼Œç¨³å®šå°±å¥½
- åªéœ€è¦æœåŠ¡æ³¨å†Œå‘ç°ï¼Œä¸éœ€è¦é…ç½®ä¸­å¿ƒ
- å›¢é˜Ÿå¯¹NetflixæŠ€æœ¯æ ˆç†Ÿæ‚‰

é€‰æ‹©Nacosï¼š
- æ–°é¡¹ç›®ï¼Œè¿½æ±‚åŠŸèƒ½å…¨é¢
- éœ€è¦é…ç½®ä¸­å¿ƒ + æ³¨å†Œä¸­å¿ƒ
- å›½å†…éƒ¨ç½²ï¼Œæœ‰ä¸­æ–‡æ–‡æ¡£å’Œç¤¾åŒº

é€‰æ‹©Consulï¼š
- å¤šè¯­è¨€æ··åˆå¼€å‘
- éœ€è¦è·¨æ•°æ®ä¸­å¿ƒéƒ¨ç½²
- éœ€è¦å¼ºä¸€è‡´æ€§ä¿è¯
```

**ğŸ”¹ æœåŠ¡å¥åº·æ£€æŸ¥çš„æ·±å±‚ç†è§£**
```
ä¸‰ä¸ªå±‚æ¬¡çš„å¥åº·ï¼š
1. è¿›ç¨‹æ´»ç€ï¼ˆå¿ƒè·³æ£€æµ‹ï¼‰
2. ç«¯å£èƒ½è®¿é—®ï¼ˆTCPæ£€æŸ¥ï¼‰
3. åŠŸèƒ½æ­£å¸¸ï¼ˆHTTPå¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼‰

æœ€ä½³å®è·µï¼š
è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ â†’ æ£€æŸ¥æ•°æ®åº“ã€Redisç­‰ä¾èµ–
â†’ ä¾èµ–æŒ‚äº†ä¸»åŠ¨æ ‡è®°ä¸ºä¸å¥åº·
â†’ é¿å…æµé‡æ‰“åˆ°"æ´»ç€ä½†å¹²ä¸äº†æ´»"çš„å®ä¾‹
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®**

**Nacosç”Ÿäº§é…ç½®**ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: nacos-cluster  # ä½¿ç”¨é›†ç¾¤åœ°å€
        namespace: prod             # ç”Ÿäº§ç¯å¢ƒå‘½åç©ºé—´
        ephemeral: true             # ä¸´æ—¶å®ä¾‹ï¼Œæ•…éšœå¿«é€Ÿå‰”é™¤
        heart-beat-interval: 5000   # 5ç§’å¿ƒè·³
        ip-delete-timeout: 30000    # 30ç§’æ— å¿ƒè·³åˆ é™¤
        watch:
          enabled: true             # å¼€å¯æ¨é€ï¼Œå®æ—¶æ„ŸçŸ¥å˜æ›´
```

**Eurekaç”Ÿäº§é…ç½®**ï¼š
```yaml
eureka:
  instance:
    lease-renewal-interval-in-seconds: 15    # 15ç§’å¿ƒè·³
    lease-expiration-duration-in-seconds: 45 # 45ç§’å‰”é™¤
    prefer-ip-address: true
    
  client:
    registry-fetch-interval-seconds: 15      # 15ç§’æ‹‰å–
    enable-self-preservation: true           # å¼€å¯è‡ªæˆ‘ä¿æŠ¤
```

**å¥åº·æ£€æŸ¥é…ç½®**ï¼š
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
      
# è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
spring:
  cloud:
    nacos:
      discovery:
        metadata:
          health-check-url: http://${spring.cloud.client.ip-address}:${server.port}/actuator/health
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ é—®é¢˜1ï¼šæ–°æœåŠ¡ä¸Šçº¿åï¼Œå…¶ä»–æœåŠ¡å¾ˆä¹…æ‰èƒ½å‘ç°**
```
åŸå› ï¼šæœåŠ¡åˆ—è¡¨æ›´æ–°æœ‰å»¶è¿Ÿ

è§£å†³æ–¹æ¡ˆï¼š
1. ç¼©çŸ­æ‹‰å–é—´éš”ï¼ˆregistry-fetch-interval-seconds: 10ï¼‰
2. ä½¿ç”¨Nacosçš„æ¨é€æ¨¡å¼ï¼ˆwatch.enabled: trueï¼‰
3. æ‰‹åŠ¨åˆ·æ–°æœåŠ¡åˆ—è¡¨ï¼ˆæä¾›ç®¡ç†æ¥å£ï¼‰
```

**â“ é—®é¢˜2ï¼šæœåŠ¡å®•æœºåï¼Œè¿˜åœ¨ç»§ç»­æ¥æ”¶æµé‡**
```
åŸå› ï¼šå¥åº·æ£€æŸ¥æ²¡é…ç½®æˆ–é—´éš”å¤ªé•¿

è§£å†³æ–¹æ¡ˆï¼š
1. é…ç½®åˆç†çš„å¿ƒè·³é—´éš”ï¼ˆä¸è¶…è¿‡30ç§’ï¼‰
2. é…ç½®åˆç†çš„å‰”é™¤æ—¶é—´ï¼ˆå¿ƒè·³é—´éš”çš„3å€ï¼‰
3. è‡ªå®šä¹‰å¥åº·æ£€æŸ¥ï¼Œæ£€æŸ¥å…³é”®ä¾èµ–
```

**â“ é—®é¢˜3ï¼šæ³¨å†Œä¸­å¿ƒå®•æœºï¼Œæ‰€æœ‰æœåŠ¡ä¸å¯ç”¨**
```
åŸå› ï¼šæ²¡æœ‰é…ç½®é«˜å¯ç”¨é›†ç¾¤

è§£å†³æ–¹æ¡ˆï¼š
1. éƒ¨ç½²æ³¨å†Œä¸­å¿ƒé›†ç¾¤ï¼ˆè‡³å°‘3ä¸ªèŠ‚ç‚¹ï¼‰
2. å®¢æˆ·ç«¯é…ç½®å¤šä¸ªæ³¨å†Œä¸­å¿ƒåœ°å€
3. å¯ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆæœåŠ¡åˆ—è¡¨ç¼“å­˜åˆ°æœ¬åœ°ï¼‰
```

**â“ é—®é¢˜4ï¼šè°ƒç”¨æœåŠ¡æ—¶å¶å°”å¤±è´¥**
```
åŸå› ï¼šæœåŠ¡å®ä¾‹å¥åº·çŠ¶æ€ä¸ç¨³å®š

è§£å†³æ–¹æ¡ˆï¼š
1. é…ç½®é‡è¯•æœºåˆ¶ï¼ˆRibbonæˆ–LoadBalancerï¼‰
2. é…ç½®ç†”æ–­é™çº§ï¼ˆSentinelæˆ–Hystrixï¼‰
3. è°ƒæ•´å¥åº·æ£€æŸ¥æ•æ„Ÿåº¦
```

### 10.5 å­¦ä¹ æ£€æŸ¥æ¸…å•


**âœ… åŸºç¡€æŒæ¡**
- [ ] ç†è§£æœåŠ¡æ³¨å†Œå‘ç°çš„æ ¸å¿ƒåŸç†
- [ ] èƒ½é…ç½®Nacos/EurekaæœåŠ¡æ³¨å†Œ
- [ ] èƒ½ä½¿ç”¨@LoadBalancedçš„RestTemplateè°ƒç”¨æœåŠ¡
- [ ] ç†è§£å¿ƒè·³æœºåˆ¶å’Œå¥åº·æ£€æŸ¥

**âœ… è¿›é˜¶æŒæ¡**
- [ ] èƒ½é…ç½®Eureka/Nacos/Consulä¸‰ç§æ³¨å†Œä¸­å¿ƒ
- [ ] ç†è§£ä¸´æ—¶å®ä¾‹vsæŒä¹…å®ä¾‹çš„åŒºåˆ«
- [ ] èƒ½é…ç½®è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘
- [ ] ç†è§£æœåŠ¡åˆ—è¡¨æ›´æ–°çš„æ‹‰å–å’Œæ¨é€æ¨¡å¼

**âœ… é«˜çº§æŒæ¡**
- [ ] èƒ½é…ç½®æ³¨å†Œä¸­å¿ƒé«˜å¯ç”¨é›†ç¾¤
- [ ] èƒ½å®ç°æ•…éšœè½¬ç§»å’Œé‡è¯•æœºåˆ¶
- [ ] èƒ½é…ç½®å¤šæ³¨å†Œä¸­å¿ƒå…±å­˜
- [ ] èƒ½å¤„ç†è·¨æ³¨å†Œä¸­å¿ƒæœåŠ¡è°ƒç”¨

**ğŸ“Š æŒæ¡åº¦è‡ªè¯„**ï¼š
```
ç†è®ºç†è§£ï¼šâ­â­â­â­â­ (__/5)
é…ç½®èƒ½åŠ›ï¼šâ­â­â­â­â˜† (__/5)
é—®é¢˜æ’æŸ¥ï¼šâ­â­â­â­â˜† (__/5)
æ¶æ„è®¾è®¡ï¼šâ­â­â­â˜†â˜† (__/5)
```

### 10.6 æ ¸å¿ƒè®°å¿†å£è¯€


**ğŸ¯ æ³¨å†Œä¸­å¿ƒé€‰æ‹©**
```
è€é¡¹ç›®Eurekaï¼Œæ–°é¡¹ç›®Nacos
å¤šè¯­è¨€Consulï¼Œç¨³å®šå‹å€’ä¸€åˆ‡
```

**ğŸ¯ å¥åº·æ£€æŸ¥é…ç½®**
```
å¿ƒè·³é—´éš”åˆ«å¤ªé•¿ï¼Œä¸‰å€æ—¶é—´å°±å‰”é™¤
è‡ªå®šä¹‰æ£€æŸ¥çœ‹ä¾èµ–ï¼Œæ•°æ®åº“Rediséƒ½è¦æŸ¥
```

**ğŸ¯ é«˜å¯ç”¨éƒ¨ç½²**
```
æ³¨å†Œä¸­å¿ƒè¦é›†ç¾¤ï¼Œå®¢æˆ·ç«¯é…å¤šåœ°å€
æœ¬åœ°ç¼“å­˜é˜²é›ªå´©ï¼Œæ¨é€æ‹‰å–ç»“åˆç”¨
```

**ğŸ¯ æ•…éšœå¤„ç†**
```
é‡è¯•æœºåˆ¶é˜²æŠ–åŠ¨ï¼Œç†”æ–­é™çº§ä¿ç¨³å®š
ç›‘æ§å‘Šè­¦è¦åˆ°ä½ï¼Œå‘ç°é—®é¢˜å¿«å®šä½
```

---

**ğŸ“ å­¦ä¹ å»ºè®®**ï¼š
1. **åŠ¨æ‰‹å®è·µ**ï¼šæ­å»ºNacos+å¤šä¸ªå¾®æœåŠ¡ï¼Œè§‚å¯Ÿæ³¨å†Œå‘ç°è¿‡ç¨‹
2. **æ¨¡æ‹Ÿæ•…éšœ**ï¼šæ‰‹åŠ¨åœæ­¢æœåŠ¡ï¼Œè§‚å¯Ÿå¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
3. **æ€§èƒ½æµ‹è¯•**ï¼šå¯¹æ¯”ä¸åŒæ³¨å†Œä¸­å¿ƒçš„æ€§èƒ½å’Œå®æ—¶æ€§
4. **é˜…è¯»æºç **ï¼šç ”ç©¶Ribbon/LoadBalancerçš„è´Ÿè½½å‡è¡¡å®ç°

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼š7.2 è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸é…ç½® - æ·±å…¥ç†è§£å¦‚ä½•ä¼˜é›…åœ°åˆ†é…æµé‡