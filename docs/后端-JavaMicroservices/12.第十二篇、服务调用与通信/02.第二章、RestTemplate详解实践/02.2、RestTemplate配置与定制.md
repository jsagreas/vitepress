---
title: 2ã€RestTemplateé…ç½®ä¸å®šåˆ¶
---
## ğŸ“š ç›®å½•

1. [RestTemplateæ„å»ºå™¨](#1-RestTemplateæ„å»ºå™¨)
2. [è¯·æ±‚å·¥å‚é…ç½®](#2-è¯·æ±‚å·¥å‚é…ç½®)
3. [æ¶ˆæ¯è½¬æ¢å™¨](#3-æ¶ˆæ¯è½¬æ¢å™¨)
4. [è¶…æ—¶é…ç½®è¯¦è§£](#4-è¶…æ—¶é…ç½®è¯¦è§£)
5. [æ‹¦æˆªå™¨æœºåˆ¶](#5-æ‹¦æˆªå™¨æœºåˆ¶)
6. [é”™è¯¯å¤„ç†å™¨](#6-é”™è¯¯å¤„ç†å™¨)
7. [SSLè¯ä¹¦é…ç½®](#7-SSLè¯ä¹¦é…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ RestTemplateæ„å»ºå™¨


### 1.1 ä»€ä¹ˆæ˜¯RestTemplateBuilder


**é€šä¿—ç†è§£**ï¼šå°±åƒè£…ä¿®æˆ¿å­ï¼Œä½ å¯ä»¥é€‰æ‹©ç²¾è£…ä¿®ï¼ˆè‡ªå·±é…ç½®å„ç§ç»†èŠ‚ï¼‰æˆ–è€…æ¯›å¯æˆ¿ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰

```
é»˜è®¤æ–¹å¼ vs æ„å»ºå™¨æ–¹å¼ï¼š

é»˜è®¤åˆ›å»ºï¼š
RestTemplate restTemplate = new RestTemplate();
â†“
é—®é¢˜ï¼šåªèƒ½ç”¨é»˜è®¤é…ç½®ï¼Œä¸å¤Ÿçµæ´»

æ„å»ºå™¨åˆ›å»ºï¼š
RestTemplate restTemplate = builder
    .setConnectTimeout(Duration.ofSeconds(5))  // è¿æ¥è¶…æ—¶5ç§’
    .setReadTimeout(Duration.ofSeconds(10))    // è¯»å–è¶…æ—¶10ç§’
    .build();
â†“
ä¼˜åŠ¿ï¼šå¯ä»¥æŒ‰éœ€å®šåˆ¶å„ç§é…ç½®
```

### 1.2 RestTemplateBuilderæ ¸å¿ƒèƒ½åŠ›


**ğŸ¯ æ„å»ºå™¨èƒ½åšä»€ä¹ˆ**

| é…ç½®é¡¹ | **ä½œç”¨** | **é€šä¿—ç†è§£** |
|--------|---------|-------------|
| è¶…æ—¶è®¾ç½® | `æ§åˆ¶ç­‰å¾…æ—¶é—´` | å°±åƒç½‘è´­è®¾ç½®è‡ªåŠ¨å–æ¶ˆè®¢å•æ—¶é—´ |
| æ‹¦æˆªå™¨ | `ç»Ÿä¸€å¤„ç†è¯·æ±‚/å“åº”` | ç±»ä¼¼å¿«é€’ä¸­è½¬ç«™ç»Ÿä¸€æ£€æŸ¥åŒ…è£¹ |
| é”™è¯¯å¤„ç† | `è‡ªå®šä¹‰é”™è¯¯å“åº”` | å°±åƒå®¢æœç»Ÿä¸€å¤„ç†æŠ•è¯‰ |
| æ¶ˆæ¯è½¬æ¢ | `æ•°æ®æ ¼å¼è½¬æ¢` | ç±»ä¼¼ç¿»è¯‘å™¨è½¬æ¢ä¸åŒè¯­è¨€ |

**ğŸ’¡ å®é™…é…ç½®ç¤ºä¾‹**

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate(RestTemplateBuilder builder) {
        return builder
            // è¿æ¥è¶…æ—¶ï¼š5ç§’å†…å¿…é¡»å»ºç«‹è¿æ¥
            .setConnectTimeout(Duration.ofSeconds(5))
            
            // è¯»å–è¶…æ—¶ï¼š10ç§’å†…å¿…é¡»è¯»å®Œæ•°æ®
            .setReadTimeout(Duration.ofSeconds(10))
            
            // æ·»åŠ æ‹¦æˆªå™¨ï¼šç»Ÿä¸€åŠ è¯·æ±‚å¤´
            .interceptors(new MyInterceptor())
            
            // é”™è¯¯å¤„ç†ï¼šè‡ªå®šä¹‰é”™è¯¯å“åº”
            .errorHandler(new MyErrorHandler())
            
            .build();
    }
}
```

**ğŸ“Š é…ç½®ç”Ÿæ•ˆæµç¨‹**

```
è¯·æ±‚å‘èµ·
   â†“
[æ‹¦æˆªå™¨å‰ç½®å¤„ç†] â†’ æ·»åŠ é€šç”¨è¯·æ±‚å¤´ã€æ—¥å¿—è®°å½•
   â†“
[è¿æ¥è¶…æ—¶æ£€æŸ¥] â†’ 5ç§’å†…è¿ä¸ä¸ŠæœåŠ¡å™¨å°±æŠ¥é”™
   â†“
[å‘é€è¯·æ±‚æ•°æ®] â†’ å‘ç›®æ ‡æœåŠ¡å™¨ä¼ è¾“æ•°æ®
   â†“
[è¯»å–è¶…æ—¶æ£€æŸ¥] â†’ 10ç§’å†…è¯»ä¸å®Œæ•°æ®å°±æŠ¥é”™
   â†“
[æ¶ˆæ¯è½¬æ¢å¤„ç†] â†’ JSONè½¬Javaå¯¹è±¡
   â†“
[æ‹¦æˆªå™¨åç½®å¤„ç†] â†’ è®°å½•å“åº”æ—¥å¿—
   â†“
[é”™è¯¯å¤„ç†åˆ¤æ–­] â†’ å¦‚æœæœ‰é”™è¯¯ï¼ŒæŒ‰è‡ªå®šä¹‰è§„åˆ™å¤„ç†
   â†“
è¿”å›ç»“æœ
```

---

## 2. ğŸ­ è¯·æ±‚å·¥å‚é…ç½®


### 2.1 ClientHttpRequestFactoryæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šè¿™æ˜¯RestTemplateå‘é€HTTPè¯·æ±‚çš„"åº•å±‚å¼•æ“"ï¼Œå°±åƒæ±½è½¦çš„å‘åŠ¨æœº

```
ç±»æ¯”ç†è§£ï¼š

RestTemplate = æ±½è½¦å¤–å£³ï¼ˆæ“ä½œç•Œé¢ï¼‰
ClientHttpRequestFactory = å‘åŠ¨æœºï¼ˆåº•å±‚å®ç°ï¼‰

ä¸åŒçš„å‘åŠ¨æœºæœ‰ä¸åŒç‰¹ç‚¹ï¼š
â€¢ SimpleClientHttpRequestFactory â†’ ç»æµå‹ï¼ˆJDKè‡ªå¸¦ï¼‰
â€¢ HttpComponentsClientHttpRequestFactory â†’ ä¸“ä¸šå‹ï¼ˆApache HttpClientï¼‰
â€¢ OkHttp3ClientHttpRequestFactory â†’ é«˜æ€§èƒ½å‹ï¼ˆOkHttpï¼‰
```

### 2.2 å¸¸ç”¨è¯·æ±‚å·¥å‚å¯¹æ¯”


**ğŸ” ä¸‰ç§ä¸»æµæ–¹æ¡ˆ**

| å·¥å‚ç±»å‹ | **åº•å±‚æŠ€æœ¯** | **ä¼˜åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|-------------|
| **SimpleClient** | `JDK HttpURLConnection` | æ— éœ€é¢å¤–ä¾èµ– | ç®€å•åœºæ™¯ã€å¿«é€Ÿå¼€å‘ |
| **HttpComponents** | `Apache HttpClient` | åŠŸèƒ½å¼ºå¤§ã€é…ç½®çµæ´» | ä¼ä¸šçº§åº”ç”¨ã€å¤æ‚éœ€æ±‚ |
| **OkHttp3** | `OkHttpæ¡†æ¶` | æ€§èƒ½ä¼˜å¼‚ã€è¿æ¥æ±  | é«˜å¹¶å‘åœºæ™¯ |

**ğŸ’» HttpComponentsé…ç½®ç¤ºä¾‹**ï¼ˆæœ€å¸¸ç”¨ï¼‰

```java
@Bean
public RestTemplate restTemplate() {
    // 1. åˆ›å»ºè¿æ¥ç®¡ç†å™¨ï¼ˆç®¡ç†HTTPè¿æ¥ï¼‰
    PoolingHttpClientConnectionManager connectionManager = 
        new PoolingHttpClientConnectionManager();
    
    // æœ€å¤§è¿æ¥æ•°ï¼š200ä¸ªï¼ˆåƒåœè½¦åœºæœ€å¤šåœ200è¾†è½¦ï¼‰
    connectionManager.setMaxTotal(200);
    
    // æ¯ä¸ªåŸŸåæœ€å¤š50ä¸ªè¿æ¥ï¼ˆæ¯ä¸ªå•†åœºæœ€å¤šåœ50è¾†è½¦ï¼‰
    connectionManager.setDefaultMaxPerRoute(50);
    
    // 2. åˆ›å»ºHttpClientå®¢æˆ·ç«¯
    CloseableHttpClient httpClient = HttpClients.custom()
        .setConnectionManager(connectionManager)
        .build();
    
    // 3. åˆ›å»ºè¯·æ±‚å·¥å‚
    HttpComponentsClientHttpRequestFactory factory = 
        new HttpComponentsClientHttpRequestFactory(httpClient);
    
    // 4. åˆ›å»ºRestTemplate
    return new RestTemplate(factory);
}
```

**ğŸ”„ è¿æ¥æ± å·¥ä½œåŸç†**

```
è¯·æ±‚æµç¨‹å›¾ï¼š

ç”¨æˆ·è¯·æ±‚1 â”€â”
ç”¨æˆ·è¯·æ±‚2 â”€â”¤
ç”¨æˆ·è¯·æ±‚3 â”€â”¤â†’ [è¿æ¥æ± ] â†’ å¤ç”¨å·²æœ‰è¿æ¥ â†’ ç›®æ ‡æœåŠ¡å™¨
ç”¨æˆ·è¯·æ±‚4 â”€â”¤     â†“
ç”¨æˆ·è¯·æ±‚5 â”€â”˜   è¾¾åˆ°ä¸Šé™ï¼Ÿ
              â†“ æ˜¯
           [ç­‰å¾…é˜Ÿåˆ—]
              â†“
           æœ‰è¿æ¥é‡Šæ”¾ï¼Ÿ
              â†“ æ˜¯
           è·å–è¿æ¥ä½¿ç”¨

è¿æ¥æ± å¥½å¤„ï¼š
âœ“ é¿å…é¢‘ç¹åˆ›å»ºè¿æ¥ï¼ˆèŠ‚çœèµ„æºï¼‰
âœ“ æé«˜å“åº”é€Ÿåº¦ï¼ˆè¿æ¥å¤ç”¨ï¼‰
âœ“ æ§åˆ¶å¹¶å‘æ•°é‡ï¼ˆé˜²æ­¢è¿‡è½½ï¼‰
```

---

## 3. ğŸ”„ æ¶ˆæ¯è½¬æ¢å™¨


### 3.1 MessageConverterçš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šæ¶ˆæ¯è½¬æ¢å™¨å°±åƒ"ç¿»è¯‘å®˜"ï¼Œè´Ÿè´£åœ¨Javaå¯¹è±¡å’ŒHTTPæ•°æ®ä¹‹é—´è½¬æ¢

```
è½¬æ¢åœºæ™¯ï¼š

å‘é€è¯·æ±‚æ—¶ï¼š
Javaå¯¹è±¡(User) â†’ JSONå­—ç¬¦ä¸² â†’ å‘é€åˆ°æœåŠ¡å™¨
  {"name":"å¼ ä¸‰", "age":25}

æ¥æ”¶å“åº”æ—¶ï¼š
JSONå­—ç¬¦ä¸² â†’ Javaå¯¹è±¡(User) â†’ ä¸šåŠ¡ä»£ç ä½¿ç”¨
  {"name":"å¼ ä¸‰", "age":25}
```

### 3.2 å¸¸è§æ¶ˆæ¯è½¬æ¢å™¨


**ğŸ“‹ Spring Bootå†…ç½®è½¬æ¢å™¨**

```
è‡ªåŠ¨è£…é…çš„è½¬æ¢å™¨ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

1ï¸âƒ£ ByteArrayHttpMessageConverter
   ä½œç”¨ï¼šå¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼ˆå›¾ç‰‡ã€æ–‡ä»¶ï¼‰
   
2ï¸âƒ£ StringHttpMessageConverter
   ä½œç”¨ï¼šå¤„ç†çº¯æ–‡æœ¬ï¼ˆtext/plainï¼‰
   
3ï¸âƒ£ MappingJackson2HttpMessageConverter â­
   ä½œç”¨ï¼šå¤„ç†JSONï¼ˆæœ€å¸¸ç”¨ï¼‰
   
4ï¸âƒ£ FormHttpMessageConverter
   ä½œç”¨ï¼šå¤„ç†è¡¨å•æäº¤ï¼ˆform-dataï¼‰
```

### 3.3 è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨


**ğŸ’¡ å®é™…éœ€æ±‚åœºæ™¯**ï¼šå‡è®¾æœåŠ¡å™¨è¿”å›çš„æ—¥æœŸæ ¼å¼æ˜¯æ—¶é—´æˆ³ï¼Œä½ æƒ³è‡ªåŠ¨è½¬ä¸ºDateå¯¹è±¡

```java
@Configuration
public class MessageConverterConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        RestTemplate restTemplate = new RestTemplate();
        
        // è·å–å·²æœ‰çš„è½¬æ¢å™¨åˆ—è¡¨
        List<HttpMessageConverter<?>> converters = 
            restTemplate.getMessageConverters();
        
        // é…ç½®JSONè½¬æ¢å™¨
        for (HttpMessageConverter<?> converter : converters) {
            if (converter instanceof MappingJackson2HttpMessageConverter) {
                MappingJackson2HttpMessageConverter jsonConverter = 
                    (MappingJackson2HttpMessageConverter) converter;
                
                // é…ç½®ObjectMapperï¼ˆJSONå¤„ç†å™¨ï¼‰
                ObjectMapper mapper = jsonConverter.getObjectMapper();
                
                // æ—¥æœŸæ ¼å¼åŒ–ï¼šæ—¶é—´æˆ³ â†’ Dateå¯¹è±¡
                mapper.configure(
                    DeserializationFeature.READ_DATE_TIMESTAMPS_AS_NANOSECONDS, 
                    false
                );
            }
        }
        
        return restTemplate;
    }
}
```

**ğŸ” è½¬æ¢å™¨åŒ¹é…æµç¨‹**

```
å“åº”æ•°æ®åˆ°è¾¾
   â†“
æ£€æŸ¥Content-Type: application/json
   â†“
éå†è½¬æ¢å™¨åˆ—è¡¨
   â†“
StringConverteræ”¯æŒå—ï¼Ÿ â†’ å¦
   â†“
ByteArrayConverteræ”¯æŒå—ï¼Ÿ â†’ å¦
   â†“
MappingJackson2Converteræ”¯æŒå—ï¼Ÿ â†’ æ˜¯ï¼
   â†“
ä½¿ç”¨Jacksonè½¬æ¢JSON â†’ Javaå¯¹è±¡
   â†“
è¿”å›ç»™è°ƒç”¨æ–¹
```

---

## 4. â±ï¸ è¶…æ—¶é…ç½®è¯¦è§£


### 4.1 ä¸¤ç§è¶…æ—¶çš„åŒºåˆ«


**é€šä¿—ç±»æ¯”**ï¼šæ‰“ç”µè¯ç»™å®¢æœ

```
è¿æ¥è¶…æ—¶ï¼ˆConnect Timeoutï¼‰ï¼š
â†“
æ‹¨å·ç­‰å¾…æ¥é€šçš„æ—¶é—´
â€¢ åœºæ™¯ï¼šç”µè¯æ‰“è¿‡å»ï¼Œå˜Ÿå˜Ÿå˜Ÿ...ç­‰å¾…å®¢æœæ¥å¬
â€¢ å¦‚æœ5ç§’æ²¡äººæ¥ â†’ è¿æ¥è¶…æ—¶
â€¢ åŸå› ï¼šæœåŠ¡å™¨å®•æœºã€ç½‘ç»œä¸é€š

è¯»å–è¶…æ—¶ï¼ˆRead Timeoutï¼‰ï¼š
â†“
ç­‰å¾…å¯¹æ–¹è¯´è¯çš„æ—¶é—´
â€¢ åœºæ™¯ï¼šç”µè¯æ¥é€šäº†ï¼Œä½†å®¢æœåŠå¤©ä¸å›å¤
â€¢ å¦‚æœ10ç§’æ²¡å›å¤ â†’ è¯»å–è¶…æ—¶
â€¢ åŸå› ï¼šæœåŠ¡å™¨å¤„ç†æ…¢ã€å“åº”æ•°æ®å¤§
```

### 4.2 è¶…æ—¶é…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šä½¿ç”¨RestTemplateBuilder**ï¼ˆæ¨èï¼‰

```java
@Bean
public RestTemplate restTemplate(RestTemplateBuilder builder) {
    return builder
        // è¿æ¥è¶…æ—¶5ç§’
        .setConnectTimeout(Duration.ofSeconds(5))
        
        // è¯»å–è¶…æ—¶10ç§’
        .setReadTimeout(Duration.ofSeconds(10))
        
        .build();
}
```

**æ–¹å¼äºŒï¼šç›´æ¥é…ç½®å·¥å‚**

```java
@Bean
public RestTemplate restTemplate() {
    HttpComponentsClientHttpRequestFactory factory = 
        new HttpComponentsClientHttpRequestFactory();
    
    // è¿æ¥è¶…æ—¶ï¼š5000æ¯«ç§’ = 5ç§’
    factory.setConnectTimeout(5000);
    
    // è¯»å–è¶…æ—¶ï¼š10000æ¯«ç§’ = 10ç§’
    factory.setReadTimeout(10000);
    
    return new RestTemplate(factory);
}
```

**âš™ï¸ è¶…æ—¶å€¼è®¾ç½®å»ºè®®**

| åœºæ™¯ç±»å‹ | **è¿æ¥è¶…æ—¶** | **è¯»å–è¶…æ—¶** | **è¯´æ˜** |
|---------|------------|------------|---------|
| å†…ç½‘è°ƒç”¨ | `2-5ç§’` | `5-10ç§’` | ç½‘ç»œç¨³å®šï¼Œå“åº”å¿« |
| å¤–ç½‘è°ƒç”¨ | `5-10ç§’` | `10-30ç§’` | ç½‘ç»œä¸ç¨³å®šï¼Œå¯èƒ½æ…¢ |
| æ–‡ä»¶ä¸‹è½½ | `5ç§’` | `60-300ç§’` | è¿æ¥å¿«ï¼Œä¸‹è½½æ…¢ |
| å¤æ‚æŸ¥è¯¢ | `3ç§’` | `30-60ç§’` | æ•°æ®å¤„ç†è€—æ—¶é•¿ |

**âš ï¸ è¶…æ—¶å¼‚å¸¸å¤„ç†**

```java
try {
    String result = restTemplate.getForObject(url, String.class);
} catch (ResourceAccessException e) {
    // åˆ¤æ–­æ˜¯å“ªç§è¶…æ—¶
    if (e.getCause() instanceof SocketTimeoutException) {
        if (e.getMessage().contains("connect")) {
            // è¿æ¥è¶…æ—¶ï¼šæœåŠ¡å™¨å¯èƒ½æŒ‚äº†
            log.error("æœåŠ¡å™¨è¿æ¥ä¸ä¸Š");
        } else {
            // è¯»å–è¶…æ—¶ï¼šæœåŠ¡å™¨å“åº”å¤ªæ…¢
            log.error("æœåŠ¡å™¨å“åº”è¶…æ—¶");
        }
    }
}
```

---

## 5. ğŸ¯ æ‹¦æˆªå™¨æœºåˆ¶


### 5.1 æ‹¦æˆªå™¨æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒæœºåœºå®‰æ£€ï¼Œæ‰€æœ‰è¯·æ±‚å’Œå“åº”éƒ½è¦ç»è¿‡å®ƒæ£€æŸ¥

```
è¯·æ±‚æµç¨‹ï¼š

ä¸šåŠ¡ä»£ç å‘èµ·è¯·æ±‚
   â†“
[æ‹¦æˆªå™¨1] â†’ æ·»åŠ è®¤è¯token
   â†“
[æ‹¦æˆªå™¨2] â†’ è®°å½•è¯·æ±‚æ—¥å¿—
   â†“
[æ‹¦æˆªå™¨3] â†’ æ·»åŠ è¯·æ±‚ID
   â†“
å‘é€åˆ°æœåŠ¡å™¨
   â†“
æ”¶åˆ°å“åº”
   â†“
[æ‹¦æˆªå™¨3] â†’ è®°å½•å“åº”æ—¶é—´
   â†“
[æ‹¦æˆªå™¨2] â†’ è®°å½•å“åº”æ—¥å¿—
   â†“
[æ‹¦æˆªå™¨1] â†’ è§£æå“åº”å¤´
   â†“
è¿”å›ç»™ä¸šåŠ¡ä»£ç 
```

### 5.2 æ‹¦æˆªå™¨å®ç°


**ğŸ’» åˆ›å»ºè‡ªå®šä¹‰æ‹¦æˆªå™¨**

```java
public class LoggingInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(
        HttpRequest request, 
        byte[] body, 
        ClientHttpRequestExecution execution
    ) throws IOException {
        
        // å‰ç½®å¤„ç†ï¼šè¯·æ±‚å‘å‡ºå‰
        long startTime = System.currentTimeMillis();
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        log.info("è¯·æ±‚URL: {}", request.getURI());
        log.info("è¯·æ±‚æ–¹æ³•: {}", request.getMethod());
        
        // æ‰§è¡ŒçœŸæ­£çš„è¯·æ±‚ï¼ˆæ”¾è¡Œï¼‰
        ClientHttpResponse response = execution.execute(request, body);
        
        // åç½®å¤„ç†ï¼šæ”¶åˆ°å“åº”å
        long duration = System.currentTimeMillis() - startTime;
        log.info("å“åº”è€—æ—¶: {}ms", duration);
        log.info("å“åº”çŠ¶æ€: {}", response.getStatusCode());
        
        return response;
    }
}
```

**ğŸ”§ æ³¨å†Œæ‹¦æˆªå™¨**

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate(RestTemplateBuilder builder) {
        return builder
            .interceptors(
                new LoggingInterceptor(),      // æ—¥å¿—æ‹¦æˆªå™¨
                new AuthInterceptor(),          // è®¤è¯æ‹¦æˆªå™¨
                new RetryInterceptor()          // é‡è¯•æ‹¦æˆªå™¨
            )
            .build();
    }
}
```

### 5.3 å®ç”¨æ‹¦æˆªå™¨ç¤ºä¾‹


**ğŸ” è®¤è¯æ‹¦æˆªå™¨ï¼šç»Ÿä¸€æ·»åŠ Token**

```java
public class AuthInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(
        HttpRequest request, byte[] body, 
        ClientHttpRequestExecution execution
    ) throws IOException {
        
        // è·å–tokenï¼ˆä»Redisã€ThreadLocalç­‰ï¼‰
        String token = TokenHolder.getToken();
        
        // æ·»åŠ åˆ°è¯·æ±‚å¤´
        if (token != null) {
            request.getHeaders().add("Authorization", "Bearer " + token);
        }
        
        return execution.execute(request, body);
    }
}
```

**ğŸ”„ é‡è¯•æ‹¦æˆªå™¨ï¼šå¤±è´¥è‡ªåŠ¨é‡è¯•**

```java
public class RetryInterceptor implements ClientHttpRequestInterceptor {
    
    private static final int MAX_RETRY = 3;  // æœ€å¤šé‡è¯•3æ¬¡
    
    @Override
    public ClientHttpResponse intercept(
        HttpRequest request, byte[] body, 
        ClientHttpRequestExecution execution
    ) throws IOException {
        
        for (int i = 0; i < MAX_RETRY; i++) {
            try {
                return execution.execute(request, body);
            } catch (IOException e) {
                if (i == MAX_RETRY - 1) {
                    throw e;  // æœ€åä¸€æ¬¡è¿˜å¤±è´¥ï¼Œå°±æŠ›å¼‚å¸¸
                }
                // å¦åˆ™ç­‰å¾…åé‡è¯•
                Thread.sleep(1000 * (i + 1));  // é€’å¢ç­‰å¾…æ—¶é—´
            }
        }
        
        return null;
    }
}
```

---

## 6. ğŸš¨ é”™è¯¯å¤„ç†å™¨


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†å™¨


**é»˜è®¤è¡Œä¸ºçš„é—®é¢˜**ï¼š

```
æœåŠ¡å™¨è¿”å›4xx/5xxé”™è¯¯
   â†“
RestTemplateç›´æ¥æŠ›å¼‚å¸¸
   â†“
ä¸šåŠ¡ä»£ç try-catchæ•è·
   â†“
é—®é¢˜ï¼š
â€¢ æ¯æ¬¡è°ƒç”¨éƒ½è¦å†™try-catchï¼Œéº»çƒ¦
â€¢ ä¸åŒé”™è¯¯ç å¤„ç†é€»è¾‘é‡å¤
â€¢ æ— æ³•ç»Ÿä¸€å¤„ç†ä¸šåŠ¡é”™è¯¯
```

**ä½¿ç”¨é”™è¯¯å¤„ç†å™¨å**ï¼š

```
æœåŠ¡å™¨è¿”å›é”™è¯¯
   â†“
é”™è¯¯å¤„ç†å™¨ç»Ÿä¸€å¤„ç†
   â†“
æ ¹æ®é”™è¯¯ç åˆ†ç±»å¤„ç†
   â†“
è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
```

### 6.2 è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨


**ğŸ’¡ å®ç°è‡ªå®šä¹‰é”™è¯¯å¤„ç†**

```java
public class CustomErrorHandler implements ResponseErrorHandler {
    
    // åˆ¤æ–­æ˜¯å¦æœ‰é”™è¯¯
    @Override
    public boolean hasError(ClientHttpResponse response) throws IOException {
        // HTTPçŠ¶æ€ç æ˜¯4xxæˆ–5xxå°±ç®—é”™è¯¯
        return response.getStatusCode().is4xxClientError() 
            || response.getStatusCode().is5xxServerError();
    }
    
    // å¤„ç†é”™è¯¯
    @Override
    public void handleError(ClientHttpResponse response) throws IOException {
        HttpStatus statusCode = response.getStatusCode();
        
        // è¯»å–å“åº”å†…å®¹
        String errorMsg = StreamUtils.copyToString(
            response.getBody(), 
            StandardCharsets.UTF_8
        );
        
        // æ ¹æ®çŠ¶æ€ç åˆ†ç±»å¤„ç†
        if (statusCode.is4xxClientError()) {
            // å®¢æˆ·ç«¯é”™è¯¯ï¼ˆè¯·æ±‚æœ‰é—®é¢˜ï¼‰
            switch (statusCode) {
                case UNAUTHORIZED:  // 401
                    throw new AuthException("æœªæˆæƒï¼Œè¯·å…ˆç™»å½•");
                case FORBIDDEN:  // 403
                    throw new AuthException("æ— æƒé™è®¿é—®");
                case NOT_FOUND:  // 404
                    throw new NotFoundException("èµ„æºä¸å­˜åœ¨");
                default:
                    throw new ClientException("è¯·æ±‚å‚æ•°é”™è¯¯: " + errorMsg);
            }
        } else {
            // æœåŠ¡å™¨é”™è¯¯
            switch (statusCode) {
                case INTERNAL_SERVER_ERROR:  // 500
                    throw new ServerException("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
                case SERVICE_UNAVAILABLE:  // 503
                    throw new ServerException("æœåŠ¡æš‚æ—¶ä¸å¯ç”¨");
                default:
                    throw new ServerException("æœåŠ¡å™¨é”™è¯¯: " + errorMsg);
            }
        }
    }
}
```

**ğŸ”§ æ³¨å†Œé”™è¯¯å¤„ç†å™¨**

```java
@Bean
public RestTemplate restTemplate(RestTemplateBuilder builder) {
    return builder
        .errorHandler(new CustomErrorHandler())
        .build();
}
```

**ğŸ“Š é”™è¯¯å¤„ç†æµç¨‹**

```
HTTPå“åº”åˆ°è¾¾
   â†“
çŠ¶æ€ç æ£€æŸ¥
   â”œâ†’ 2xxæˆåŠŸ â†’ ç›´æ¥è¿”å›æ•°æ®
   â””â†’ 4xx/5xx â†’ è¿›å…¥é”™è¯¯å¤„ç†å™¨
       â†“
   hasError() åˆ¤æ–­
       â†“ true
   handleError() å¤„ç†
       â†“
   æ ¹æ®çŠ¶æ€ç åˆ†ç±»
       â”œâ†’ 401/403 â†’ æŠ›è®¤è¯å¼‚å¸¸
       â”œâ†’ 404 â†’ æŠ›èµ„æºä¸å­˜åœ¨å¼‚å¸¸
       â”œâ†’ 500 â†’ æŠ›æœåŠ¡å™¨å¼‚å¸¸
       â””â†’ å…¶ä»– â†’ æŠ›é€šç”¨å¼‚å¸¸
```

---

## 7. ğŸ”’ SSLè¯ä¹¦é…ç½®


### 7.1 ä»€ä¹ˆæ˜¯SSLè¯ä¹¦


**é€šä¿—ç†è§£**ï¼šSSLè¯ä¹¦å°±åƒç½‘ç«™çš„"èº«ä»½è¯"ï¼Œè¯æ˜è¿™ä¸ªç½‘ç«™æ˜¯å¯ä¿¡çš„

```
HTTPSé€šä¿¡è¿‡ç¨‹ï¼š

å®¢æˆ·ç«¯ â†’ ä½ å¥½ï¼Œæˆ‘è¦è®¿é—®ä½ 
   â†“
æœåŠ¡å™¨ â†’ è¿™æ˜¯æˆ‘çš„è¯ä¹¦ï¼ˆèº«ä»½è¯ï¼‰
   â†“
å®¢æˆ·ç«¯ â†’ éªŒè¯è¯ä¹¦æ˜¯å¦å¯ä¿¡
   â”œâ†’ å¯ä¿¡ï¼šå»ºç«‹åŠ å¯†è¿æ¥
   â””â†’ ä¸å¯ä¿¡ï¼šæ‹’ç»è¿æ¥

å¸¸è§åœºæ™¯ï¼š
â€¢ è®¿é—®é“¶è¡Œç½‘ç«™ï¼šå¿…é¡»éªŒè¯è¯ä¹¦
â€¢ å†…éƒ¨æµ‹è¯•ç¯å¢ƒï¼šå¯èƒ½ç”¨è‡ªç­¾åè¯ä¹¦ï¼ˆä¸å—ä¿¡ä»»ï¼‰
â€¢ å…¬å¸å†…ç½‘æœåŠ¡ï¼šå¯èƒ½éœ€è¦å¯¼å…¥ä¼ä¸šè¯ä¹¦
```

### 7.2 è·³è¿‡SSLéªŒè¯ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰


**âš ï¸ è­¦å‘Š**ï¼šç”Ÿäº§ç¯å¢ƒç»å¯¹ä¸èƒ½è·³è¿‡SSLéªŒè¯ï¼

```java
@Bean
public RestTemplate restTemplate() throws Exception {
    // åˆ›å»ºä¿¡ä»»æ‰€æœ‰è¯ä¹¦çš„ä¿¡ä»»ç®¡ç†å™¨
    TrustManager[] trustAllCerts = new TrustManager[]{
        new X509TrustManager() {
            public void checkClientTrusted(X509Certificate[] chain, String authType) {}
            public void checkServerTrusted(X509Certificate[] chain, String authType) {}
            public X509Certificate[] getAcceptedIssuers() { return null; }
        }
    };
    
    // å®‰è£…ä¿¡ä»»ç®¡ç†å™¨
    SSLContext sslContext = SSLContext.getInstance("TLS");
    sslContext.init(null, trustAllCerts, new SecureRandom());
    
    // é…ç½®HttpClient
    CloseableHttpClient httpClient = HttpClients.custom()
        .setSSLContext(sslContext)
        .setSSLHostnameVerifier((hostname, session) -> true)  // è·³è¿‡ä¸»æœºåéªŒè¯
        .build();
    
    HttpComponentsClientHttpRequestFactory factory = 
        new HttpComponentsClientHttpRequestFactory(httpClient);
    
    return new RestTemplate(factory);
}
```

### 7.3 ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰


**ğŸ’¼ ä¼ä¸šå†…ç½‘è¯ä¹¦é…ç½®**

```java
@Bean
public RestTemplate restTemplate() throws Exception {
    // 1. åŠ è½½è¯ä¹¦æ–‡ä»¶
    KeyStore keyStore = KeyStore.getInstance("JKS");
    try (InputStream is = new FileInputStream("path/to/keystore.jks")) {
        keyStore.load(is, "password".toCharArray());
    }
    
    // 2. åˆ›å»ºSSLä¸Šä¸‹æ–‡
    SSLContext sslContext = SSLContextBuilder.create()
        .loadTrustMaterial(keyStore, new TrustSelfSignedStrategy())
        .build();
    
    // 3. é…ç½®HttpClient
    CloseableHttpClient httpClient = HttpClients.custom()
        .setSSLContext(sslContext)
        .build();
    
    // 4. åˆ›å»ºRestTemplate
    HttpComponentsClientHttpRequestFactory factory = 
        new HttpComponentsClientHttpRequestFactory(httpClient);
    
    return new RestTemplate(factory);
}
```

**ğŸ”‘ SSLé…ç½®å¯¹æ¯”**

| é…ç½®æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨æ€§** | **å¤æ‚åº¦** |
|---------|------------|-----------|-----------|
| è·³è¿‡éªŒè¯ | `æµ‹è¯•ç¯å¢ƒ` | âŒ ä½ï¼ˆå®¹æ˜“è¢«æ”»å‡»ï¼‰ | â­ ç®€å• |
| ç³»ç»Ÿè¯ä¹¦ | `å…¬ç½‘HTTPS` | âœ… é«˜ | â­â­ ä¸­ç­‰ |
| è‡ªå®šä¹‰è¯ä¹¦ | `ä¼ä¸šå†…ç½‘` | âœ… é«˜ | â­â­â­ å¤æ‚ |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ RestTemplateé…ç½®ä¸‰å¤§æ”¯æŸ±**

```
1ï¸âƒ£ è¯·æ±‚å·¥å‚ï¼ˆåº•å±‚å¼•æ“ï¼‰
   â”œâ”€ SimpleClientï¼šç®€å•åœºæ™¯
   â”œâ”€ HttpComponentsï¼šä¼ä¸šçº§åº”ç”¨ï¼ˆæ¨èï¼‰
   â””â”€ OkHttpï¼šé«˜å¹¶å‘åœºæ™¯

2ï¸âƒ£ è¶…æ—¶é…ç½®ï¼ˆæ€§èƒ½ä¿éšœï¼‰
   â”œâ”€ è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´
   â””â”€ è¯»å–è¶…æ—¶ï¼šè¯»å–æ•°æ®çš„æœ€é•¿ç­‰å¾…æ—¶é—´

3ï¸âƒ£ æ‹¦æˆªå™¨ï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰
   â”œâ”€ æ—¥å¿—è®°å½•
   â”œâ”€ è®¤è¯æˆæƒ
   â”œâ”€ è¯·æ±‚é‡è¯•
   â””â”€ æ•°æ®åŠ å¯†
```

### 8.2 å…³é”®é…ç½®å»ºè®®


**âš™ï¸ ç”Ÿäº§ç¯å¢ƒé…ç½®æ¸…å•**

```
âœ… å¿…é¡»é…ç½®é¡¹ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼š5ç§’ï¼ˆé˜²æ­¢è¿æ¥æŒ‚æ­»ï¼‰
â€¢ è¯»å–è¶…æ—¶ï¼š10ç§’ï¼ˆé˜²æ­¢å“åº”è¶…æ—¶ï¼‰
â€¢ è¿æ¥æ± å¤§å°ï¼š200ï¼ˆæ”¯æŒå¹¶å‘ï¼‰
â€¢ æ¯åŸŸåè¿æ¥æ•°ï¼š50ï¼ˆé¿å…å•ç‚¹å‹åŠ›ï¼‰

âœ… æ¨èé…ç½®é¡¹ï¼š
â€¢ æ—¥å¿—æ‹¦æˆªå™¨ï¼šæ–¹ä¾¿é—®é¢˜æ’æŸ¥
â€¢ è®¤è¯æ‹¦æˆªå™¨ï¼šç»Ÿä¸€å¤„ç†token
â€¢ é”™è¯¯å¤„ç†å™¨ï¼šå‹å¥½çš„é”™è¯¯æç¤º

âš ï¸ è°¨æ…é…ç½®é¡¹ï¼š
â€¢ SSLè·³è¿‡éªŒè¯ï¼šä»…æµ‹è¯•ç¯å¢ƒ
â€¢ æ— é™é‡è¯•ï¼šå¯èƒ½å¯¼è‡´é›ªå´©
â€¢ è¿‡é•¿è¶…æ—¶ï¼šå½±å“ç”¨æˆ·ä½“éªŒ
```

### 8.3 å¸¸è§é—®é¢˜è§£å†³


**ğŸ” é—®é¢˜è¯Šæ–­æŒ‡å—**

```
é—®é¢˜1ï¼šè¯·æ±‚ç»å¸¸è¶…æ—¶
æ’æŸ¥æ–¹å‘ï¼š
1. æ£€æŸ¥è¶…æ—¶é…ç½®æ˜¯å¦åˆç†
2. æŸ¥çœ‹æœåŠ¡ç«¯æ€§èƒ½æ˜¯å¦æ­£å¸¸
3. ç½‘ç»œæ˜¯å¦ç¨³å®š
è§£å†³æ–¹æ¡ˆï¼š
â†’ é€‚å½“å¢åŠ è¶…æ—¶æ—¶é—´
â†’ ä¼˜åŒ–æœåŠ¡ç«¯å¤„ç†é€»è¾‘
â†’ æ·»åŠ é‡è¯•æœºåˆ¶

é—®é¢˜2ï¼šè¿æ¥æ± è€—å°½
æ’æŸ¥æ–¹å‘ï¼š
1. æ˜¯å¦æ­£ç¡®é‡Šæ”¾è¿æ¥
2. è¿æ¥æ± å¤§å°æ˜¯å¦è¶³å¤Ÿ
3. æ˜¯å¦æœ‰è¿æ¥æ³„æ¼
è§£å†³æ–¹æ¡ˆï¼š
â†’ å¢å¤§è¿æ¥æ± å¤§å°
â†’ ä½¿ç”¨try-with-resourcesç¡®ä¿å…³é—­
â†’ é…ç½®è¿æ¥è¶…æ—¶è‡ªåŠ¨å›æ”¶

é—®é¢˜3ï¼šSSLè¯ä¹¦é”™è¯¯
æ’æŸ¥æ–¹å‘ï¼š
1. è¯ä¹¦æ˜¯å¦è¿‡æœŸ
2. æ˜¯å¦ä¿¡ä»»çš„CAé¢å‘
3. ä¸»æœºåæ˜¯å¦åŒ¹é…
è§£å†³æ–¹æ¡ˆï¼š
â†’ æ›´æ–°è¯ä¹¦
â†’ å¯¼å…¥è¯ä¹¦åˆ°ä¿¡ä»»åº“
â†’ é…ç½®ä¸»æœºåéªŒè¯è§„åˆ™
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
RestTemplateé…ç½®è¦ç‚¹è®°ï¼š
æ„å»ºå™¨å®šåˆ¶æœ€çµæ´»ï¼Œå·¥å‚é€‰æ‹©çœ‹åœºæ™¯
è¶…æ—¶è®¾ç½®è¦åˆç†ï¼Œæ‹¦æˆªå™¨é‡Œåšé€šç”¨
æ¶ˆæ¯è½¬æ¢è‡ªåŠ¨åŒ–ï¼Œé”™è¯¯å¤„ç†è¦å‹å¥½
è¯ä¹¦é…ç½®ä¿å®‰å…¨ï¼Œç”Ÿäº§æµ‹è¯•è¦åˆ†æ¸…
```