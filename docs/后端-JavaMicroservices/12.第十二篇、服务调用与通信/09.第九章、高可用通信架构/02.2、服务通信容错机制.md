---
title: 2ã€æœåŠ¡é€šä¿¡å®¹é”™æœºåˆ¶
---
## ğŸ“š ç›®å½•


1. [å®¹é”™æœºåˆ¶æ¦‚è¿°](#1-å®¹é”™æœºåˆ¶æ¦‚è¿°)
2. [é‡è¯•æœºåˆ¶è®¾è®¡](#2-é‡è¯•æœºåˆ¶è®¾è®¡)
3. [è¶…æ—¶æ§åˆ¶ç­–ç•¥](#3-è¶…æ—¶æ§åˆ¶ç­–ç•¥)
4. [ç†”æ–­é™çº§å®ç°](#4-ç†”æ–­é™çº§å®ç°)
5. [èˆ±å£éš”ç¦»æ¨¡å¼](#5-èˆ±å£éš”ç¦»æ¨¡å¼)
6. [é™æµç®—æ³•åº”ç”¨](#6-é™æµç®—æ³•åº”ç”¨)
7. [ç¼“å­˜å®¹é”™ç­–ç•¥](#7-ç¼“å­˜å®¹é”™ç­–ç•¥)
8. [å¼‚å¸¸æ¢å¤æœºåˆ¶](#8-å¼‚å¸¸æ¢å¤æœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹é”™æœºåˆ¶æ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡é€šä¿¡å®¹é”™



**é€šä¿—ç†è§£**ï¼šå°±åƒå¼€è½¦æ—¶çš„å®‰å…¨æªæ–½ï¼ˆå®‰å…¨å¸¦ã€å®‰å…¨æ°”å›Šã€ABSï¼‰ï¼Œå®¹é”™æœºåˆ¶å°±æ˜¯æœåŠ¡è°ƒç”¨æ—¶çš„"å®‰å…¨é˜²æŠ¤"ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
æ‰“ç”µè¯ç»™æœ‹å‹ â†â†’ æœåŠ¡Aè°ƒç”¨æœåŠ¡B

å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š
â€¢ å¯¹æ–¹æ²¡æ¥ï¼ˆè¶…æ—¶ï¼‰      â†’ éœ€è¦é‡æ‹¨ï¼ˆé‡è¯•ï¼‰
â€¢ å¯¹æ–¹æ‰‹æœºå…³æœºï¼ˆæ•…éšœï¼‰   â†’ å‘çŸ­ä¿¡ä»£æ›¿ï¼ˆé™çº§ï¼‰
â€¢ å¯¹æ–¹ä¸€ç›´å çº¿ï¼ˆè¿‡è½½ï¼‰   â†’ ç¨åå†æ‰“ï¼ˆé™æµï¼‰
â€¢ ç”µè¯çº¿è·¯æ•…éšœï¼ˆç†”æ–­ï¼‰   â†’ æš‚åœæ‹¨æ‰“ï¼Œé¿å…æµªè´¹
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **å®¹é”™ï¼ˆFault Toleranceï¼‰**ï¼šç³»ç»Ÿåœ¨éƒ¨åˆ†ç»„ä»¶å‡ºé”™æ—¶ï¼Œä»èƒ½ç»§ç»­è¿è¡Œ
- **ç›®æ ‡**ï¼šä¿è¯æœåŠ¡ç¨³å®šæ€§ï¼Œé¿å…å•ç‚¹æ•…éšœå¯¼è‡´æ•´ä½“å´©æºƒ
- **åŸåˆ™**ï¼šå¿«é€Ÿå¤±è´¥ã€ä¼˜é›…é™çº§ã€è‡ªåŠ¨æ¢å¤

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®¹é”™æœºåˆ¶



**å¾®æœåŠ¡ç¯å¢ƒçš„æŒ‘æˆ˜**ï¼š
```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
åº”ç”¨ â†’ æ•°æ®åº“
é—®é¢˜èŒƒå›´ï¼šæœ¬åœ°è°ƒç”¨ï¼Œå¯æ§

å¾®æœåŠ¡æ¶æ„ï¼š
æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C â†’ æœåŠ¡D
                â†“
              æœåŠ¡E
              
é—®é¢˜èŒƒå›´ï¼š
â€¢ ç½‘ç»œä¸ç¨³å®šï¼ˆå»¶è¿Ÿã€ä¸¢åŒ…ï¼‰
â€¢ æœåŠ¡å¯èƒ½æ•…éšœï¼ˆå®•æœºã€é‡å¯ï¼‰
â€¢ æµé‡çªå¢ï¼ˆé«˜å³°æœŸï¼‰
â€¢ ä¾èµ–é“¾æ¡é•¿ï¼ˆé›ªå´©æ•ˆåº”ï¼‰
```

**æ•…éšœä¼ æ’­ç¤ºä¾‹**ï¼š
```
æ— å®¹é”™ä¿æŠ¤ï¼š
ç”¨æˆ· â†’ [è®¢å•æœåŠ¡] â†’ [åº“å­˜æœåŠ¡-æ•…éšœ]
                        â†“
                     è¯·æ±‚é˜»å¡
                        â†“
                  è®¢å•æœåŠ¡çº¿ç¨‹è€—å°½
                        â†“
                    æ•´ä½“ç³»ç»Ÿå´©æºƒ

æœ‰å®¹é”™ä¿æŠ¤ï¼š
ç”¨æˆ· â†’ [è®¢å•æœåŠ¡] â†’ [ç†”æ–­å™¨] Ã—â†’ [åº“å­˜æœåŠ¡-æ•…éšœ]
           â†“
      è¿”å›é™çº§å“åº”
           â†“
     ç³»ç»Ÿç»§ç»­è¿è¡Œï¼ˆåŠŸèƒ½å—é™ä½†å¯ç”¨ï¼‰
```

### 1.3 å®¹é”™æœºåˆ¶å…¨æ™¯å›¾



```
          ç”¨æˆ·è¯·æ±‚
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   é™æµæ§åˆ¶      â”‚ â† å…¥å£é˜²æŠ¤ï¼Œæ§åˆ¶æµé‡
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   é‡è¯•æœºåˆ¶      â”‚ â† ç¬æ—¶æ•…éšœè‡ªåŠ¨æ¢å¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   è¶…æ—¶æ§åˆ¶      â”‚ â† é¿å…æ— é™ç­‰å¾…
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç†”æ–­é™çº§      â”‚ â† å¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢é›ªå´©
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   èˆ±å£éš”ç¦»      â”‚ â† èµ„æºéš”ç¦»ï¼Œé™åˆ¶å½±å“èŒƒå›´
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ç¼“å­˜å®¹é”™      â”‚ â† æ•°æ®å…œåº•ï¼Œå‡å°‘ä¾èµ–
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
         å“åº”ç»“æœ
```

---

## 2. ğŸ”„ é‡è¯•æœºåˆ¶è®¾è®¡



### 2.1 é‡è¯•æœºåˆ¶æ ¸å¿ƒæ€æƒ³



**ä»€ä¹ˆæ˜¯é‡è¯•**ï¼šå½“æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å†æ¬¡å°è¯•è°ƒç”¨ï¼Œåº”å¯¹ä¸´æ—¶æ€§æ•…éšœã€‚

**é€‚ç”¨åœºæ™¯**ï¼š
```
âœ… é€‚åˆé‡è¯•çš„æƒ…å†µï¼š
â€¢ ç½‘ç»œæŠ–åŠ¨ï¼ˆå¶å‘çš„è¶…æ—¶ï¼‰
â€¢ æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼ˆé‡å¯ä¸­ï¼‰
â€¢ è´Ÿè½½å‡è¡¡èŠ‚ç‚¹åˆ‡æ¢
â€¢ æ•°æ®åº“ä¸»ä»åˆ‡æ¢

âŒ ä¸é€‚åˆé‡è¯•çš„æƒ…å†µï¼š
â€¢ ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ï¼‰
â€¢ æƒé™éªŒè¯å¤±è´¥
â€¢ èµ„æºä¸å­˜åœ¨ï¼ˆ404ï¼‰
â€¢ æ•°æ®å·²å¤„ç†ï¼ˆé¿å…é‡å¤ï¼‰
```

### 2.2 é‡è¯•ç­–ç•¥è¯¦è§£



**ç­–ç•¥ç±»å‹å¯¹æ¯”**ï¼š

| ç­–ç•¥ç±»å‹ | **å·¥ä½œæ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|------------|-------------|-----------|
| **ç«‹å³é‡è¯•** | `å¤±è´¥åç«‹åˆ»é‡è¯•` | `ç½‘ç»œé—ªæ–­` | `æ¢å¤å¿«ï¼Œä½†å¯èƒ½åŠ é‡æ•…éšœ` |
| **å›ºå®šå»¶è¿Ÿ** | `ç­‰å¾…å›ºå®šæ—¶é—´åé‡è¯•` | `æœåŠ¡é‡å¯` | `ç®€å•ï¼Œä½†ä¸å¤Ÿçµæ´»` |
| **æŒ‡æ•°é€€é¿** | `æ¯æ¬¡å»¶è¿Ÿæ—¶é—´ç¿»å€` | `æœåŠ¡è¿‡è½½` | `æ™ºèƒ½ï¼Œé¿å…é›ªå´©` |
| **éšæœºå»¶è¿Ÿ** | `å»¶è¿Ÿæ—¶é—´åŠ å…¥éšæœºå› å­` | `é˜²æ­¢é‡è¯•é£æš´` | `åˆ†æ•£å‹åŠ›ï¼Œæ¨èä½¿ç”¨` |

**æŒ‡æ•°é€€é¿ç®—æ³•**ï¼š
```
é‡è¯•æ¬¡æ•°    å»¶è¿Ÿæ—¶é—´        è®¡ç®—æ–¹å¼
   1        100ms         åˆå§‹å»¶è¿Ÿ
   2        200ms         100ms Ã— 2Â¹
   3        400ms         100ms Ã— 2Â²
   4        800ms         100ms Ã— 2Â³
   5        1600ms        100ms Ã— 2â´
   
åŠ å…¥éšæœºå› å­ï¼ˆJitterï¼‰ï¼š
å®é™…å»¶è¿Ÿ = åŸºç¡€å»¶è¿Ÿ Ã— (1 + random(0, 0.3))
ç›®çš„ï¼šé¿å…æ‰€æœ‰è¯·æ±‚åŒæ—¶é‡è¯•
```

### 2.3 Spring Cloud é‡è¯•å®ç°



**ä½¿ç”¨ Spring Retry**ï¼š

```java
// é…ç½®æ–‡ä»¶ï¼šapplication.yml
spring:
  cloud:
    loadbalancer:
      retry:
        enabled: true  # å¼€å¯é‡è¯•
    
# é‡è¯•é…ç½®

resilience4j:
  retry:
    instances:
      orderService:
        max-attempts: 3              # æœ€å¤šé‡è¯•3æ¬¡
        wait-duration: 1s            # æ¯æ¬¡ç­‰å¾…1ç§’
        retry-exceptions:            # å“ªäº›å¼‚å¸¸éœ€è¦é‡è¯•
          - java.net.SocketTimeoutException
          - org.springframework.web.client.ResourceAccessException
        ignore-exceptions:           # å“ªäº›å¼‚å¸¸ä¸é‡è¯•
          - java.lang.IllegalArgumentException
```

**ä»£ç å®ç°**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // ä½¿ç”¨æ³¨è§£æ–¹å¼é…ç½®é‡è¯•
    @Retry(name = "orderService", fallbackMethod = "getInventoryFallback")
    public Integer getInventory(Long productId) {
        String url = "http://inventory-service/api/inventory/" + productId;
        return restTemplate.getForObject(url, Integer.class);
    }
    
    // é‡è¯•å¤±è´¥åçš„é™çº§æ–¹æ³•
    private Integer getInventoryFallback(Long productId, Exception e) {
        // è¿”å›é»˜è®¤å€¼æˆ–ä»ç¼“å­˜è·å–
        return 0;
    }
}
```

### 2.4 é‡è¯•æœ€ä½³å®è·µ



**æ ¸å¿ƒåŸåˆ™**ï¼š
```
ğŸ”¸ è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°
â€¢ é¿å…æ— é™é‡è¯•æ¶ˆè€—èµ„æº
â€¢ æ¨èï¼š2-3æ¬¡å³å¯

ğŸ”¸ ä½¿ç”¨æŒ‡æ•°é€€é¿ + éšæœºå› å­
â€¢ é¿å…é‡è¯•é£æš´
â€¢ ç»™æœåŠ¡æ¢å¤æ—¶é—´

ğŸ”¸ åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•
â€¢ å¹‚ç­‰æ“ä½œï¼šå¯ä»¥é‡è¯•
â€¢ éå¹‚ç­‰æ“ä½œï¼šæ…é‡å¤„ç†

ğŸ”¸ è®°å½•é‡è¯•æ—¥å¿—
â€¢ ç›‘æ§é‡è¯•é¢‘ç‡
â€¢ åˆ†ææ•…éšœåŸå› 
```

**é‡è¯•ç›‘æ§**ï¼š
```java
@Component
public class RetryEventListener {
    
    @EventListener
    public void onRetryEvent(RetryOnErrorEvent event) {
        log.warn("é‡è¯•å‘ç”Ÿ: æœåŠ¡={}, æ¬¡æ•°={}, åŸå› ={}", 
            event.getName(), 
            event.getNumberOfRetryAttempts(),
            event.getLastThrowable().getMessage()
        );
    }
}
```

---

## 3. â±ï¸ è¶…æ—¶æ§åˆ¶ç­–ç•¥



### 3.1 è¶…æ—¶æ§åˆ¶çš„é‡è¦æ€§



**ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶**ï¼š
```
æ²¡æœ‰è¶…æ—¶æ§åˆ¶çš„é—®é¢˜ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æœåŠ¡ç«¯å¤„ç†ç¼“æ…¢/æ— å“åº”
     â†“
 çº¿ç¨‹ä¸€ç›´ç­‰å¾…
     â†“
 çº¿ç¨‹æ± èµ„æºè€—å°½
     â†“
æ–°è¯·æ±‚æ— æ³•å¤„ç†ï¼Œç³»ç»Ÿç˜«ç—ª

æœ‰è¶…æ—¶æ§åˆ¶ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æœåŠ¡ç«¯å¤„ç†ç¼“æ…¢
     â†“
ç­‰å¾…è¶…æ—¶ï¼ˆå¦‚3ç§’ï¼‰
     â†“
å¿«é€Ÿè¿”å›é”™è¯¯ï¼Œé‡Šæ”¾çº¿ç¨‹
     â†“
ç³»ç»Ÿç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚
```

### 3.2 è¶…æ—¶æ—¶é—´è®¾ç½®ç­–ç•¥



**è¶…æ—¶æ—¶é—´å±‚çº§**ï¼š
```
           æ€»è¶…æ—¶ï¼š5ç§’
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   è¿æ¥è¶…æ—¶ï¼š1ç§’   â”‚ â† å»ºç«‹è¿æ¥çš„æœ€å¤§æ—¶é—´
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   è¯»å–è¶…æ—¶ï¼š4ç§’   â”‚ â† ç­‰å¾…å“åº”çš„æœ€å¤§æ—¶é—´
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
æ€»è¶…æ—¶ = è¿æ¥è¶…æ—¶ + è¯»å–è¶…æ—¶
```

**æ¨èé…ç½®**ï¼š
```
å¿«é€ŸæŸ¥è¯¢ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼š500ms
â€¢ è¯»å–è¶…æ—¶ï¼š1s
â€¢ æ€»è¶…æ—¶ï¼š1.5s

æ™®é€šä¸šåŠ¡ï¼ˆå¦‚è®¢å•æŸ¥è¯¢ï¼‰ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼š1s
â€¢ è¯»å–è¶…æ—¶ï¼š3s
â€¢ æ€»è¶…æ—¶ï¼š4s

å¤æ‚è®¡ç®—ï¼ˆå¦‚æŠ¥è¡¨ç”Ÿæˆï¼‰ï¼š
â€¢ è¿æ¥è¶…æ—¶ï¼š2s
â€¢ è¯»å–è¶…æ—¶ï¼š10s
â€¢ æ€»è¶…æ—¶ï¼š12s
```

### 3.3 è¶…æ—¶é…ç½®å®ç°



**RestTemplate é…ç½®**ï¼š
```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        // åˆ›å»ºHTTPå®¢æˆ·ç«¯å·¥å‚
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        
        // è¿æ¥è¶…æ—¶ï¼š1ç§’
        factory.setConnectTimeout(1000);
        
        // è¯»å–è¶…æ—¶ï¼š3ç§’
        factory.setReadTimeout(3000);
        
        // è¿æ¥è¯·æ±‚è¶…æ—¶ï¼šä»è¿æ¥æ± è·å–è¿æ¥çš„è¶…æ—¶æ—¶é—´
        factory.setConnectionRequestTimeout(500);
        
        return new RestTemplate(factory);
    }
}
```

**Feign è¶…æ—¶é…ç½®**ï¼š
```java
// application.yml
feign:
  client:
    config:
      default:  # å…¨å±€é…ç½®
        connectTimeout: 1000      # è¿æ¥è¶…æ—¶1ç§’
        readTimeout: 3000         # è¯»å–è¶…æ—¶3ç§’
      
      inventory-service:  # ç‰¹å®šæœåŠ¡é…ç½®
        connectTimeout: 500
        readTimeout: 2000
```

### 3.4 è¶…æ—¶å¼‚å¸¸å¤„ç†



**å¼‚å¸¸å¤„ç†ç¤ºä¾‹**ï¼š
```java
@Service
public class ProductService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public ProductDTO getProduct(Long id) {
        try {
            String url = "http://product-service/api/products/" + id;
            return restTemplate.getForObject(url, ProductDTO.class);
            
        } catch (ResourceAccessException e) {
            // è¿æ¥è¶…æ—¶æˆ–è¯»å–è¶…æ—¶
            if (e.getCause() instanceof SocketTimeoutException) {
                log.error("æœåŠ¡è°ƒç”¨è¶…æ—¶: {}", e.getMessage());
                // è¿”å›é™çº§æ•°æ®æˆ–æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸
                return getProductFromCache(id);
            }
            throw e;
        }
    }
}
```

**è¶…æ—¶ä¼ é€’é—®é¢˜**ï¼š
```
è°ƒç”¨é“¾è¶…æ—¶è®¾ç½®ï¼š
ç”¨æˆ· â†’ [AæœåŠ¡-5s] â†’ [BæœåŠ¡-4s] â†’ [CæœåŠ¡-3s]

é—®é¢˜ï¼šAæœåŠ¡è¶…æ—¶5ç§’ï¼Œä½†BæœåŠ¡4ç§’å°±è¶…æ—¶äº†
å»ºè®®ï¼šä¸Šæ¸¸è¶…æ—¶ > ä¸‹æ¸¸è¶…æ—¶ + ç½‘ç»œå»¶è¿Ÿ

æ­£ç¡®è®¾ç½®ï¼š
ç”¨æˆ· â†’ [AæœåŠ¡-10s] â†’ [BæœåŠ¡-6s] â†’ [CæœåŠ¡-3s]
```

---

## 4. âš¡ ç†”æ–­é™çº§å®ç°



### 4.1 ç†”æ–­å™¨æ ¸å¿ƒåŸç†



**ä»€ä¹ˆæ˜¯ç†”æ–­å™¨**ï¼š
```
ç”µè·¯ç†”æ–­å™¨ç±»æ¯”ï¼š
å®¶é‡Œç”µè·¯è¿‡è½½ â†’ ç†”æ–­å™¨è·³é—¸ â†’ åˆ‡æ–­ç”µè·¯ â†’ ä¿æŠ¤ç”µå™¨

æœåŠ¡ç†”æ–­å™¨ï¼š
æœåŠ¡è°ƒç”¨å¤±è´¥å¤šæ¬¡ â†’ ç†”æ–­å™¨å¼€å¯ â†’ å¿«é€Ÿå¤±è´¥ â†’ ä¿æŠ¤ç³»ç»Ÿ
```

**ç†”æ–­å™¨ä¸‰ç§çŠ¶æ€**ï¼š
```
     æ­£å¸¸è°ƒç”¨
        â†“
   [å…³é—­çŠ¶æ€]
    (Closed)
        â†“ å¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼
        â†“
   [å¼€å¯çŠ¶æ€]
    (Open)
   å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨
        â†“ ç­‰å¾…ä¸€æ®µæ—¶é—´
        â†“
   [åŠå¼€çŠ¶æ€]
  (Half-Open)
   å°è¯•å°‘é‡è¯·æ±‚
        â†“
   æˆåŠŸ â†“    â†“ å¤±è´¥
        â†“    â†“
     [å…³é—­]  [å¼€å¯]
```

**çŠ¶æ€è½¬æ¢æ—¶åº**ï¼š
```
æ—¶é—´è½´ï¼š0sâ”€â”€â”€â”€10sâ”€â”€â”€â”€15sâ”€â”€â”€â”€20sâ”€â”€â”€â”€30sâ”€â”€â”€â”€40s
        â”‚     â”‚     â”‚     â”‚     â”‚     â”‚
è¯·æ±‚ï¼š æˆåŠŸ   å¤±è´¥   å¤±è´¥   å¤±è´¥   æˆåŠŸ   æˆåŠŸ
        â”‚     â”‚     â”‚     â”‚     â”‚     â”‚
çŠ¶æ€ï¼š [å…³é—­] [å…³é—­] [å…³é—­] [å¼€å¯] [åŠå¼€] [å…³é—­]
                     â†‘           â†‘
              å¤±è´¥ç‡>50%    å°è¯•è°ƒç”¨æˆåŠŸ
```

### 4.2 Resilience4j ç†”æ–­å™¨é…ç½®



**é…ç½®å‚æ•°è¯¦è§£**ï¼š
```yaml
resilience4j:
  circuitbreaker:
    instances:
      inventoryService:
#        # æ»‘åŠ¨çª—å£å¤§å°ï¼šç»Ÿè®¡æœ€è¿‘10æ¬¡è°ƒç”¨
        sliding-window-size: 10
        
#        # å¤±è´¥ç‡é˜ˆå€¼ï¼šè¶…è¿‡50%åˆ™ç†”æ–­
        failure-rate-threshold: 50
        
#        # æ…¢è°ƒç”¨é˜ˆå€¼ï¼šè¶…è¿‡2ç§’ç®—æ…¢è°ƒç”¨
        slow-call-duration-threshold: 2s
        
#        # æ…¢è°ƒç”¨ç‡é˜ˆå€¼ï¼šè¶…è¿‡50%æ…¢è°ƒç”¨åˆ™ç†”æ–­
        slow-call-rate-threshold: 50
        
#        # ç†”æ–­å™¨å¼€å¯æ—¶é•¿ï¼š10ç§’åå°è¯•æ¢å¤
        wait-duration-in-open-state: 10s
        
#        # åŠå¼€çŠ¶æ€å…è®¸çš„è°ƒç”¨æ•°ï¼š3æ¬¡
        permitted-number-of-calls-in-half-open-state: 3
        
#        # æœ€å°è°ƒç”¨æ¬¡æ•°ï¼šè‡³å°‘5æ¬¡è°ƒç”¨æ‰ç»Ÿè®¡
        minimum-number-of-calls: 5
```

**ä»£ç å®ç°**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // ä½¿ç”¨ç†”æ–­å™¨
    @CircuitBreaker(name = "inventoryService", fallbackMethod = "inventoryFallback")
    public Integer checkInventory(Long productId) {
        String url = "http://inventory-service/api/check/" + productId;
        return restTemplate.getForObject(url, Integer.class);
    }
    
    // ç†”æ–­åçš„é™çº§æ–¹æ³•
    private Integer inventoryFallback(Long productId, Exception e) {
        log.warn("åº“å­˜æœåŠ¡ç†”æ–­ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ: {}", e.getMessage());
        
        // é™çº§ç­–ç•¥ï¼š
        // 1. è¿”å›é»˜è®¤å€¼
        // 2. ä»ç¼“å­˜è·å–
        // 3. è¿”å›å…œåº•æ•°æ®
        return getInventoryFromCache(productId);
    }
}
```

### 4.3 é™çº§ç­–ç•¥è®¾è®¡



**é™çº§æ–¹æ¡ˆé€‰æ‹©**ï¼š

| åœºæ™¯ | **é™çº§ç­–ç•¥** | **ç¤ºä¾‹** |
|-----|------------|---------|
| **æŸ¥è¯¢ç±»** | `è¿”å›ç¼“å­˜æ•°æ®` | `å•†å“è¯¦æƒ…ã€ç”¨æˆ·ä¿¡æ¯` |
| **å†™å…¥ç±»** | `å¼‚æ­¥å¤„ç†` | `è®°å½•åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç¨åå¤„ç†` |
| **å®æ—¶æ€§ä¸é«˜** | `è¿”å›é»˜è®¤å€¼` | `æ¨èå•†å“åˆ—è¡¨è¿”å›çƒ­é—¨å•†å“` |
| **æ ¸å¿ƒåŠŸèƒ½** | `è¿”å›é”™è¯¯æç¤º` | `æ”¯ä»˜å¤±è´¥ï¼Œæç¤ºç¨åé‡è¯•` |

**å¤šçº§é™çº§ç¤ºä¾‹**ï¼š
```java
public ProductDTO getProductInfo(Long id) {
    try {
        // 1. æ­£å¸¸è°ƒç”¨
        return callProductService(id);
        
    } catch (CircuitBreakerOpenException e) {
        // 2. ç†”æ–­é™çº§ï¼šä»ç¼“å­˜è·å–
        ProductDTO cached = getFromCache(id);
        if (cached != null) {
            return cached;
        }
        
        // 3. ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼šä»æ•°æ®åº“è·å–åŸºæœ¬ä¿¡æ¯
        ProductDTO basic = getBasicFromDB(id);
        if (basic != null) {
            return basic;
        }
        
        // 4. æœ€ç»ˆé™çº§ï¼šè¿”å›å…œåº•æ•°æ®
        return getDefaultProduct();
    }
}
```

### 4.4 ç†”æ–­ç›‘æ§ä¸å‘Šè­¦



**ç›‘æ§æŒ‡æ ‡**ï¼š
```java
@Component
public class CircuitBreakerMonitor {
    
    @EventListener
    public void onCircuitBreakerEvent(CircuitBreakerOnStateTransitionEvent event) {
        // è®°å½•çŠ¶æ€å˜åŒ–
        log.warn("ç†”æ–­å™¨çŠ¶æ€å˜åŒ–: {} -> {}", 
            event.getStateTransition().getFromState(),
            event.getStateTransition().getToState()
        );
        
        // å‘é€å‘Šè­¦
        if (event.getStateTransition().getToState() == CircuitBreaker.State.OPEN) {
            alertService.sendAlert("æœåŠ¡ç†”æ–­", 
                "æœåŠ¡: " + event.getCircuitBreakerName() + " å·²ç†”æ–­");
        }
    }
}
```

---

## 5. ğŸš¢ èˆ±å£éš”ç¦»æ¨¡å¼



### 5.1 èˆ±å£éš”ç¦»æ ¸å¿ƒæ€æƒ³



**æ³°å¦å°¼å…‹å·çš„æ•™è®­**ï¼š
```
æ³°å¦å°¼å…‹å·æ²‰æ²¡åŸå› ï¼š
èˆ¹ä½“ç ´æŸ â†’ æµ·æ°´æ¶Œå…¥ â†’ æ•´èˆ¹ä¸‹æ²‰
         
å¦‚æœæœ‰èˆ±å£éš”ç¦»ï¼š
èˆ¹ä½“ç ´æŸ â†’ ä¸€ä¸ªèˆ±å®¤è¿›æ°´ â†’ å…¶ä»–èˆ±å®¤å®‰å…¨ â†’ èˆ¹è¿˜èƒ½æ¼‚æµ®

æœåŠ¡éš”ç¦»åŒç†ï¼š
ä¸€ä¸ªæœåŠ¡æ•…éšœ â†’ åªå½±å“è¯¥æœåŠ¡çº¿ç¨‹æ±  â†’ å…¶ä»–æœåŠ¡æ­£å¸¸è¿è¡Œ
```

**èµ„æºéš”ç¦»ç¤ºæ„**ï¼š
```
æ— éš”ç¦»ï¼ˆå…±äº«çº¿ç¨‹æ± ï¼‰ï¼š
         [å…±äº«çº¿ç¨‹æ± -100ä¸ªçº¿ç¨‹]
               â†™  â†“  â†˜
    è®¢å•æœåŠ¡  åº“å­˜æœåŠ¡  æ”¯ä»˜æœåŠ¡
       â†“
  åº“å­˜æœåŠ¡é˜»å¡ï¼Œå ç”¨æ‰€æœ‰çº¿ç¨‹
       â†“
  è®¢å•å’Œæ”¯ä»˜æœåŠ¡ä¹Ÿæ— æ³•ä½¿ç”¨ï¼Œç³»ç»Ÿç˜«ç—ª

æœ‰éš”ç¦»ï¼ˆç‹¬ç«‹çº¿ç¨‹æ± ï¼‰ï¼š
[è®¢å•çº¿ç¨‹æ± -30]  [åº“å­˜çº¿ç¨‹æ± -40]  [æ”¯ä»˜çº¿ç¨‹æ± -30]
      â†“               â†“               â†“
  è®¢å•æœåŠ¡        åº“å­˜æœåŠ¡         æ”¯ä»˜æœåŠ¡
                     â†“
              åº“å­˜æœåŠ¡é˜»å¡ï¼Œåªå ç”¨è‡ªå·±çš„40ä¸ªçº¿ç¨‹
                     â†“
          è®¢å•å’Œæ”¯ä»˜æœåŠ¡ä¸å—å½±å“ï¼Œç»§ç»­è¿è¡Œ
```

### 5.2 çº¿ç¨‹æ± éš”ç¦»å®ç°



**Resilience4j Bulkhead é…ç½®**ï¼š
```yaml
resilience4j:
  bulkhead:
    instances:
      inventoryService:
        max-concurrent-calls: 20      # æœ€å¤§å¹¶å‘è°ƒç”¨æ•°
        max-wait-duration: 100ms      # ç­‰å¾…æ—¶é—´
        
  thread-pool-bulkhead:
    instances:
      paymentService:
        max-thread-pool-size: 10      # æœ€å¤§çº¿ç¨‹æ•°
        core-thread-pool-size: 5      # æ ¸å¿ƒçº¿ç¨‹æ•°
        queue-capacity: 20            # é˜Ÿåˆ—å®¹é‡
        keep-alive-duration: 20ms     # çº¿ç¨‹å­˜æ´»æ—¶é—´
```

**ä»£ç ä½¿ç”¨**ï¼š
```java
@Service
public class OrderService {
    
    // ä¿¡å·é‡éš”ç¦»ï¼ˆè½»é‡çº§ï¼‰
    @Bulkhead(name = "inventoryService", type = Bulkhead.Type.SEMAPHORE)
    public Integer checkInventory(Long productId) {
        return inventoryClient.check(productId);
    }
    
    // çº¿ç¨‹æ± éš”ç¦»ï¼ˆé‡é‡çº§ï¼Œæ›´å®‰å…¨ï¼‰
    @Bulkhead(name = "paymentService", type = Bulkhead.Type.THREADPOOL)
    public PaymentResult processPayment(PaymentRequest request) {
        return paymentClient.pay(request);
    }
}
```

### 5.3 éš”ç¦»ç­–ç•¥é€‰æ‹©



**ä¿¡å·é‡ vs çº¿ç¨‹æ± **ï¼š

| ç‰¹æ€§ | **ä¿¡å·é‡éš”ç¦»** | **çº¿ç¨‹æ± éš”ç¦»** |
|-----|--------------|--------------|
| **èµ„æºæ¶ˆè€—** | `ä½ï¼Œåªæ§åˆ¶å¹¶å‘æ•°` | `é«˜ï¼Œéœ€è¦åˆ›å»ºçº¿ç¨‹` |
| **éš”ç¦»ç¨‹åº¦** | `å¼±ï¼ŒåŒä¸€çº¿ç¨‹æ‰§è¡Œ` | `å¼ºï¼Œç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œ` |
| **è¶…æ—¶æ§åˆ¶** | `ä¸æ”¯æŒ` | `æ”¯æŒ` |
| **é€‚ç”¨åœºæ™¯** | `å¿«é€Ÿè°ƒç”¨ï¼Œå†…éƒ¨æœåŠ¡` | `æ…¢é€Ÿè°ƒç”¨ï¼Œå¤–éƒ¨æœåŠ¡` |

**é€‰æ‹©å»ºè®®**ï¼š
```
âœ… ä½¿ç”¨ä¿¡å·é‡éš”ç¦»ï¼š
â€¢ è°ƒç”¨å†…éƒ¨æœåŠ¡ï¼ˆåŒä¸€æœºæˆ¿ï¼‰
â€¢ å“åº”æ—¶é—´ç¨³å®šï¼ˆ<100msï¼‰
â€¢ èµ„æºå—é™çš„ç¯å¢ƒ

âœ… ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»ï¼š
â€¢ è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼ˆè·¨ç½‘ç»œï¼‰
â€¢ å“åº”æ—¶é—´ä¸ç¡®å®š
â€¢ éœ€è¦è¶…æ—¶ä¿æŠ¤
â€¢ æ ¸å¿ƒä¸šåŠ¡éš”ç¦»
```

### 5.4 éš”ç¦»é…ç½®æœ€ä½³å®è·µ



**èµ„æºåˆ†é…åŸåˆ™**ï¼š
```java
// æœåŠ¡å™¨æ€»èµ„æºï¼š200ä¸ªçº¿ç¨‹
// æŒ‰é‡è¦æ€§å’Œè°ƒç”¨é¢‘ç‡åˆ†é…

// æ ¸å¿ƒæœåŠ¡ï¼ˆæ”¯ä»˜ï¼‰ï¼š40% = 80çº¿ç¨‹
ThreadPoolBulkhead paymentBulkhead = ThreadPoolBulkhead.of(
    "payment", 
    ThreadPoolBulkheadConfig.custom()
        .maxThreadPoolSize(80)
        .coreThreadPoolSize(40)
        .build()
);

// é‡è¦æœåŠ¡ï¼ˆè®¢å•ï¼‰ï¼š30% = 60çº¿ç¨‹
ThreadPoolBulkhead orderBulkhead = ThreadPoolBulkhead.of(
    "order",
    ThreadPoolBulkheadConfig.custom()
        .maxThreadPoolSize(60)
        .coreThreadPoolSize(30)
        .build()
);

// ä¸€èˆ¬æœåŠ¡ï¼ˆæ¨èï¼‰ï¼š20% = 40çº¿ç¨‹
ThreadPoolBulkhead recommendBulkhead = ThreadPoolBulkhead.of(
    "recommend",
    ThreadPoolBulkheadConfig.custom()
        .maxThreadPoolSize(40)
        .coreThreadPoolSize(20)
        .build()
);

// ä¿ç•™èµ„æºï¼š10% = 20çº¿ç¨‹ï¼ˆåº”æ€¥ä½¿ç”¨ï¼‰
```

---

## 6. ğŸš¦ é™æµç®—æ³•åº”ç”¨



### 6.1 é™æµçš„å¿…è¦æ€§



**ä¸ºä»€ä¹ˆè¦é™æµ**ï¼š
```
ç°å®åœºæ™¯ï¼š
æ™¯åŒºé™æµï¼šæ¯å¤©æœ€å¤š10000äººï¼Œè¶…è¿‡ä¸è®©è¿›
        â†“
    ä¿æŠ¤æ™¯åŒºè®¾æ–½ï¼Œä¿è¯æ¸¸å®¢ä½“éªŒ

æœåŠ¡é™æµï¼šæ¯ç§’æœ€å¤š1000è¯·æ±‚ï¼Œè¶…è¿‡æ‹’ç»
        â†“
    ä¿æŠ¤æœåŠ¡ç¨³å®šï¼Œé¿å…è¿‡è½½å´©æºƒ
```

**é™æµçš„ä½œç”¨**ï¼š
- **ä¿æŠ¤ç³»ç»Ÿ**ï¼šé˜²æ­¢æµé‡è¿‡å¤§å¯¼è‡´ç³»ç»Ÿå´©æºƒ
- **ä¿è¯æœåŠ¡è´¨é‡**ï¼šç¡®ä¿æ­£å¸¸ç”¨æˆ·çš„ä½“éªŒ
- **é˜²æ­¢æ¶æ„æ”»å‡»**ï¼šåº”å¯¹DDoSç­‰æ”»å‡»
- **æˆæœ¬æ§åˆ¶**ï¼šé™åˆ¶èµ„æºä½¿ç”¨ï¼Œæ§åˆ¶æˆæœ¬

### 6.2 å¸¸ç”¨é™æµç®—æ³•



**å››å¤§é™æµç®—æ³•å¯¹æ¯”**ï¼š

```
1. å›ºå®šçª—å£ç®—æ³•
æ—¶é—´çª—å£ï¼š  [0-1ç§’]    [1-2ç§’]    [2-3ç§’]
é™åˆ¶ï¼š       100æ¬¡      100æ¬¡      100æ¬¡
é—®é¢˜ï¼šçª—å£è¾¹ç•Œæµé‡çªåˆº

ç¤ºä¾‹ï¼š
0.9ç§’ï¼š100æ¬¡ âœ“
1.0ç§’ï¼š100æ¬¡ âœ“  â†’ åœ¨1ç§’å†…å®é™…200æ¬¡ï¼


2. æ»‘åŠ¨çª—å£ç®—æ³•
æ—¶é—´çª—å£éšè¯·æ±‚æ»‘åŠ¨ï¼Œç»Ÿè®¡ç²¾ç¡®
    â”Œâ”€â”€â”€â”€â”€1ç§’çª—å£â”€â”€â”€â”€â”€â”
    â”œâ”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¼â”€â”€â”¤
    10 20 30 10 15 15  â†’ æ€»è®¡100æ¬¡
       â””â”€â”€â”€â”€â”€1ç§’çª—å£â”€â”€â”€â”€â”€â”˜
          20 30 10 15 15 10  â†’ æ€»è®¡100æ¬¡


3. æ¼æ¡¶ç®—æ³•
è¯·æ±‚åƒæ°´æµï¼ŒåŒ€é€Ÿæµå‡º
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è¯·æ±‚  â”‚
    â””â”€â”€â”€â†“â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¼æ¡¶  â”‚ â† å›ºå®šå®¹é‡
    â”‚ â–“â–“â–“â–“   â”‚
    â””â”€â”€â”€â†“â”€â”€â”€â”€â”˜
      åŒ€é€Ÿæµå‡ºï¼ˆå¦‚æ¯ç§’10ä¸ªï¼‰
      
ç‰¹ç‚¹ï¼šæµå‡ºé€Ÿç‡æ’å®šï¼Œå‰Šå³°å¡«è°·


4. ä»¤ç‰Œæ¡¶ç®—æ³•
å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œæœ‰ä»¤ç‰Œæ‰èƒ½é€šè¿‡
    [ä»¤ç‰Œç”Ÿæˆå™¨] â†’ æ¯ç§’10ä¸ªä»¤ç‰Œ
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä»¤ç‰Œæ¡¶    â”‚ â† æœ€å¤š100ä¸ªä»¤ç‰Œ
    â”‚ â—â—â—â—â—â—    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    è¯·æ±‚è·å–ä»¤ç‰Œ â†’ æœ‰ä»¤ç‰Œé€šè¿‡ï¼Œæ— ä»¤ç‰Œæ‹’ç»
    
ç‰¹ç‚¹ï¼šå…è®¸çªå‘æµé‡ï¼ˆæ¡¶å†…æœ‰ä½™é‡ï¼‰
```

### 6.3 é™æµå®ç°æ–¹å¼



**Resilience4j RateLimiter**ï¼š
```yaml
resilience4j:
  ratelimiter:
    instances:
      orderService:
        limit-for-period: 100          # æ¯ä¸ªå‘¨æœŸå…è®¸100æ¬¡è¯·æ±‚
        limit-refresh-period: 1s       # å‘¨æœŸæ—¶é•¿1ç§’
        timeout-duration: 0s           # è·å–è®¸å¯çš„ç­‰å¾…æ—¶é—´
        
      queryService:
        limit-for-period: 500
        limit-refresh-period: 1s
        timeout-duration: 100ms        # ç­‰å¾…100msï¼Œè¶…æ—¶åˆ™æ‹’ç»
```

**ä»£ç å®ç°**ï¼š
```java
@Service
public class OrderService {
    
    // æ¥å£é™æµ
    @RateLimiter(name = "orderService")
    public OrderDTO createOrder(OrderRequest request) {
        // ä¸šåŠ¡é€»è¾‘
        return orderRepository.save(request);
    }
    
    // æ‰‹åŠ¨ä½¿ç”¨é™æµå™¨
    public void manualRateLimit() {
        io.github.resilience4j.ratelimiter.RateLimiter limiter = 
            RateLimiter.ofDefaults("manual");
        
        // å°è¯•è·å–è®¸å¯
        boolean permitted = limiter.acquirePermission();
        if (permitted) {
            // æ‰§è¡Œä¸šåŠ¡
            processRequest();
        } else {
            // é™æµæ‹’ç»
            throw new RateLimitExceededException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
    }
}
```

### 6.4 åˆ†å¸ƒå¼é™æµæ–¹æ¡ˆ



**åŸºäº Redis çš„é™æµ**ï¼š
```java
@Service
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * æ»‘åŠ¨çª—å£é™æµ
     * @param key é™æµé”®ï¼ˆå¦‚ï¼šuser:123:apiï¼‰
     * @param limit é™æµæ•°é‡
     * @param window æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
     */
    public boolean tryAcquire(String key, int limit, int window) {
        long now = System.currentTimeMillis();
        long windowStart = now - window * 1000;
        
        // Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script = 
            "redis.call('zremrangebyscore', KEYS[1], 0, ARGV[1]) " +
            "local count = redis.call('zcard', KEYS[1]) " +
            "if count < tonumber(ARGV[2]) then " +
            "  redis.call('zadd', KEYS[1], ARGV[3], ARGV[3]) " +
            "  redis.call('expire', KEYS[1], ARGV[4]) " +
            "  return 1 " +
            "end " +
            "return 0";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(windowStart),
            String.valueOf(limit),
            String.valueOf(now),
            String.valueOf(window)
        );
        
        return result != null && result == 1;
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@RestController
public class OrderController {
    
    @Autowired
    private RedisRateLimiter rateLimiter;
    
    @PostMapping("/order")
    public Result createOrder(@RequestBody OrderRequest request) {
        // ç”¨æˆ·çº§åˆ«é™æµï¼šæ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤š10æ¬¡ä¸‹å•
        String key = "order:user:" + request.getUserId();
        
        if (!rateLimiter.tryAcquire(key, 10, 60)) {
            return Result.error("æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        return orderService.create(request);
    }
}
```

---

## 7. ğŸ’¾ ç¼“å­˜å®¹é”™ç­–ç•¥



### 7.1 ç¼“å­˜åœ¨å®¹é”™ä¸­çš„ä½œç”¨



**ç¼“å­˜å®¹é”™ä»·å€¼**ï¼š
```
æœåŠ¡è°ƒç”¨é“¾ï¼š
ç”¨æˆ· â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æ•°æ®åº“

é—®é¢˜ï¼šæœåŠ¡Bæ•…éšœï¼ŒæœåŠ¡Aæ— æ³•è·å–æ•°æ®

è§£å†³ï¼šæœåŠ¡Aä½¿ç”¨ç¼“å­˜
ç”¨æˆ· â†’ æœåŠ¡A â†’ [ç¼“å­˜]
             â†“ miss
             æœåŠ¡Bï¼ˆæ•…éšœï¼‰
             â†“
         è¿”å›ç¼“å­˜æ•°æ®ï¼ˆå¯èƒ½è¿‡æœŸä½†å¯ç”¨ï¼‰
```

### 7.2 å¤šçº§ç¼“å­˜æ¶æ„



**ç¼“å­˜å±‚çº§è®¾è®¡**ï¼š
```
       ç”¨æˆ·è¯·æ±‚
          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æœ¬åœ°ç¼“å­˜  â”‚ â† è¿›ç¨‹å†…ï¼ˆå¦‚Caffeineï¼‰æœ€å¿«ï¼Œå®¹é‡å°
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ miss
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Redisç¼“å­˜ â”‚ â† åˆ†å¸ƒå¼ï¼Œé€Ÿåº¦å¿«ï¼Œå®¹é‡ä¸­
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ miss
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è¿œç¨‹æœåŠ¡  â”‚ â† æºæ•°æ®ï¼Œæœ€æ…¢ï¼Œæœ€å¯é 
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Service
public class ProductService {
    
    @Autowired
    private Cache<Long, ProductDTO> localCache;  // Caffeineæœ¬åœ°ç¼“å­˜
    
    @Autowired
    private RedisTemplate<String, ProductDTO> redis;
    
    @Autowired
    private ProductClient productClient;
    
    public ProductDTO getProduct(Long id) {
        // L1ï¼šæœ¬åœ°ç¼“å­˜
        ProductDTO product = localCache.getIfPresent(id);
        if (product != null) {
            return product;
        }
        
        // L2ï¼šRedisç¼“å­˜
        String key = "product:" + id;
        product = redis.opsForValue().get(key);
        if (product != null) {
            localCache.put(id, product);
            return product;
        }
        
        // L3ï¼šè¿œç¨‹è°ƒç”¨
        try {
            product = productClient.getById(id);
            // æ›´æ–°ç¼“å­˜
            redis.opsForValue().set(key, product, 1, TimeUnit.HOURS);
            localCache.put(id, product);
            return product;
            
        } catch (Exception e) {
            // L4ï¼šé™çº§ç­–ç•¥ - è¿”å›è¿‡æœŸç¼“å­˜
            product = redis.opsForValue().get(key + ":backup");
            if (product != null) {
                log.warn("æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ä»½ç¼“å­˜: {}", id);
                return product;
            }
            throw e;
        }
    }
}
```

### 7.3 ç¼“å­˜æ›´æ–°ç­–ç•¥



**æ›´æ–°æ¨¡å¼å¯¹æ¯”**ï¼š

| æ¨¡å¼ | **å·¥ä½œæ–¹å¼** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|-----|------------|---------|---------|------------|
| **Cache-Aside** | `ä¸šåŠ¡ä»£ç ç®¡ç†ç¼“å­˜` | `ç®€å•çµæ´»` | `ä»£ç ä¾µå…¥` | `å¤§éƒ¨åˆ†åœºæ™¯` |
| **Read-Through** | `ç¼“å­˜å±‚è‡ªåŠ¨åŠ è½½` | `å¯¹ä¸šåŠ¡é€æ˜` | `å®ç°å¤æ‚` | `è¯»å¤šå†™å°‘` |
| **Write-Through** | `åŒæ­¥å†™ç¼“å­˜å’ŒDB` | `ä¸€è‡´æ€§å¥½` | `å†™æ€§èƒ½å·®` | `å¼ºä¸€è‡´æ€§éœ€æ±‚` |
| **Write-Behind** | `å¼‚æ­¥å†™å›DB` | `å†™æ€§èƒ½å¥½` | `å¯èƒ½ä¸¢æ•°æ®` | `é«˜å¹¶å‘å†™å…¥` |

**å®è·µç¤ºä¾‹**ï¼š
```java
// Cache-Aside æ¨¡å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰
public ProductDTO getProduct(Long id) {
    // 1. å…ˆæŸ¥ç¼“å­˜
    ProductDTO cached = cache.get(id);
    if (cached != null) {
        return cached;
    }
    
    // 2. ç¼“å­˜missï¼ŒæŸ¥æ•°æ®åº“
    ProductDTO product = productRepository.findById(id);
    
    // 3. å†™å…¥ç¼“å­˜
    if (product != null) {
        cache.put(id, product);
    }
    
    return product;
}

// æ›´æ–°æ—¶åˆ é™¤ç¼“å­˜
public void updateProduct(ProductDTO product) {
    productRepository.save(product);
    cache.evict(product.getId());  // åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½
}
```

### 7.4 ç¼“å­˜å®¹é”™æœ€ä½³å®è·µ



**æ ¸å¿ƒåŸåˆ™**ï¼š
```
ğŸ”¸ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ çƒ­ç‚¹æ•°æ®ï¼šçŸ­è¿‡æœŸï¼ˆ5-10åˆ†é’Ÿï¼‰
â€¢ å†·æ•°æ®ï¼šé•¿è¿‡æœŸï¼ˆ1-2å°æ—¶ï¼‰
â€¢ åŸºç¡€æ•°æ®ï¼šæé•¿è¿‡æœŸï¼ˆ1å¤©ï¼‰

ğŸ”¸ ä½¿ç”¨å¤‡ä»½ç¼“å­˜
â€¢ ä¸»ç¼“å­˜ï¼šæ­£å¸¸è¿‡æœŸ
â€¢ å¤‡ä»½ç¼“å­˜ï¼šæé•¿è¿‡æœŸï¼ˆä»…é™çº§ä½¿ç”¨ï¼‰

ğŸ”¸ ç¼“å­˜é¢„çƒ­
â€¢ ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½çƒ­ç‚¹æ•°æ®
â€¢ é˜²æ­¢ç¼“å­˜é›ªå´©

ğŸ”¸ é˜²æ­¢ç¼“å­˜ç©¿é€
â€¢ ç©ºå€¼ä¹Ÿç¼“å­˜ï¼ˆçŸ­æ—¶é—´ï¼‰
â€¢ ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨
```

**ç¼“å­˜ç©¿é€é˜²æŠ¤**ï¼š
```java
public ProductDTO getProduct(Long id) {
    String key = "product:" + id;
    
    // 1. æŸ¥ç¼“å­˜
    ProductDTO product = cache.get(key);
    if (product != null) {
        return product;
    }
    
    // 2. æŸ¥æ•°æ®åº“
    product = productRepository.findById(id);
    
    // 3. æ•°æ®ä¸å­˜åœ¨ä¹Ÿç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€
    if (product == null) {
        cache.put(key, new ProductDTO(), 5, TimeUnit.MINUTES);
        return null;
    }
    
    cache.put(key, product, 1, TimeUnit.HOURS);
    return product;
}
```

---

## 8. ğŸ”§ å¼‚å¸¸æ¢å¤æœºåˆ¶



### 8.1 è‡ªåŠ¨æ¢å¤ç­–ç•¥



**æ¢å¤æœºåˆ¶ç±»å‹**ï¼š
```
1. æœåŠ¡è‡ªæ„ˆ
æœåŠ¡æ•…éšœ â†’ å¥åº·æ£€æŸ¥å¤±è´¥ â†’ è‡ªåŠ¨é‡å¯ â†’ æ¢å¤æœåŠ¡

2. æµé‡åˆ‡æ¢
ä¸»æœåŠ¡æ•…éšœ â†’ æ£€æµ‹åˆ°å¼‚å¸¸ â†’ åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡ â†’ ç»§ç»­æä¾›æœåŠ¡

3. æ•°æ®åŒæ­¥
ä¸»æ•°æ®åº“æ•…éšœ â†’ åˆ‡æ¢åˆ°ä»åº“ â†’ æ•°æ®åŒæ­¥ â†’ ä¿æŒä¸€è‡´æ€§
```

### 8.2 å¥åº·æ£€æŸ¥æœºåˆ¶



**Spring Boot Actuator å¥åº·æ£€æŸ¥**ï¼š
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Autowired
    private ProductClient productClient;
    
    @Override
    public Health health() {
        try {
            // æ£€æŸ¥ä¾èµ–æœåŠ¡æ˜¯å¦å¥åº·
            productClient.ping();
            return Health.up()
                .withDetail("productService", "å¯ç”¨")
                .build();
                
        } catch (Exception e) {
            return Health.down()
                .withDetail("productService", "ä¸å¯ç”¨")
                .withDetail("error", e.getMessage())
                .build();
        }
    }
}
```

**é…ç½®å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼š
```yaml
management:
  endpoint:
    health:
      show-details: always
  health:
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
```

### 8.3 æ•…éšœè½¬ç§»å®ç°



**ä¸»å¤‡åˆ‡æ¢ç¤ºä¾‹**ï¼š
```java
@Service
public class PaymentService {
    
    @Autowired
    private PaymentClient primaryClient;    // ä¸»æ”¯ä»˜æœåŠ¡
    
    @Autowired
    private PaymentClient backupClient;     // å¤‡ç”¨æ”¯ä»˜æœåŠ¡
    
    public PaymentResult pay(PaymentRequest request) {
        try {
            // å°è¯•ä¸»æœåŠ¡
            return primaryClient.pay(request);
            
        } catch (Exception e) {
            log.warn("ä¸»æ”¯ä»˜æœåŠ¡å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡: {}", e.getMessage());
            
            try {
                // åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡
                return backupClient.pay(request);
                
            } catch (Exception ex) {
                log.error("å¤‡ç”¨æ”¯ä»˜æœåŠ¡ä¹Ÿå¤±è´¥: {}", ex.getMessage());
                // è®°å½•å¤±è´¥è®¢å•ï¼Œåç»­è¡¥å¿
                saveFailedPayment(request);
                throw new PaymentException("æ”¯ä»˜æœåŠ¡ä¸å¯ç”¨");
            }
        }
    }
}
```

### 8.4 æ•°æ®ä¸€è‡´æ€§ä¿éšœ



**æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private KafkaTemplate<String, OrderEvent> kafka;
    
    @Transactional
    public OrderDTO createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order();
        order.setStatus("PENDING");
        orderRepository.save(order);
        
        // 2. å‘é€äº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        OrderEvent event = new OrderEvent(order.getId(), "CREATE");
        kafka.send("order-topic", event);
        
        // 3. å¼‚æ­¥å¤„ç†åç»­æµç¨‹
        // - æ‰£å‡åº“å­˜
        // - åˆ›å»ºæ”¯ä»˜å•
        // - å‘é€é€šçŸ¥
        
        return OrderDTO.from(order);
    }
    
    // å®šæ—¶ä»»åŠ¡æ£€æŸ¥æœªå®Œæˆè®¢å•
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void checkPendingOrders() {
        List<Order> pending = orderRepository.findByStatus("PENDING");
        
        for (Order order : pending) {
            if (order.isTimeout()) {
                // è¶…æ—¶è®¢å•ï¼Œè¿›è¡Œè¡¥å¿
                compensateOrder(order);
            }
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 9.1 å®¹é”™æœºåˆ¶å…¨æ™¯å›é¡¾



**ä¸ƒå¤§å®¹é”™æœºåˆ¶å…³ç³»**ï¼š
```
        [ç”¨æˆ·è¯·æ±‚]
            â†“
      1. [é™æµæ§åˆ¶]
         æ¯ç§’1000ä¸ªè¯·æ±‚
            â†“
      2. [è¶…æ—¶æ§åˆ¶]
         æœ€å¤šç­‰å¾…3ç§’
            â†“
      3. [é‡è¯•æœºåˆ¶]
         å¤±è´¥åé‡è¯•2æ¬¡
            â†“
      4. [ç†”æ–­é™çº§]
         å¤±è´¥ç‡>50%ç†”æ–­
            â†“
      5. [èˆ±å£éš”ç¦»]
         ç‹¬ç«‹çº¿ç¨‹æ± æ‰§è¡Œ
            â†“
      6. [ç¼“å­˜å®¹é”™]
         ä¼˜å…ˆè¿”å›ç¼“å­˜
            â†“
      7. [å¼‚å¸¸æ¢å¤]
         è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æœåŠ¡
```

### 9.2 æŠ€æœ¯é€‰å‹å»ºè®®



| å®¹é”™æœºåˆ¶ | **æ¨èæŠ€æœ¯** | **é€‚ç”¨åœºæ™¯** | **æ ¸å¿ƒé…ç½®** |
|---------|------------|-------------|------------|
| **é‡è¯•** | `Spring Retry` | `ç½‘ç»œæŠ–åŠ¨ã€ä¸´æ—¶æ•…éšœ` | `æœ€å¤š3æ¬¡ï¼ŒæŒ‡æ•°é€€é¿` |
| **è¶…æ—¶** | `RestTemplate/Feign` | `æ‰€æœ‰è¿œç¨‹è°ƒç”¨` | `è¿æ¥1sï¼Œè¯»å–3s` |
| **ç†”æ–­** | `Resilience4j` | `ä¸‹æ¸¸æœåŠ¡ä¸ç¨³å®š` | `å¤±è´¥ç‡50%ï¼Œç­‰å¾…10s` |
| **éš”ç¦»** | `Resilience4j Bulkhead` | `å…³é”®æœåŠ¡ä¿æŠ¤` | `çº¿ç¨‹æ± éš”ç¦»` |
| **é™æµ** | `Resilience4j/Redis` | `æµé‡æ§åˆ¶` | `ä»¤ç‰Œæ¡¶ç®—æ³•` |
| **ç¼“å­˜** | `Caffeine + Redis` | `çƒ­ç‚¹æ•°æ®` | `å¤šçº§ç¼“å­˜` |

### 9.3 å®æ–½æ­¥éª¤æŒ‡å—



**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é˜²æŠ¤**
```
âœ… é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆæ‰€æœ‰æœåŠ¡ï¼‰
âœ… å¯ç”¨é‡è¯•æœºåˆ¶ï¼ˆGETè¯·æ±‚ï¼‰
âœ… æ·»åŠ åŸºç¡€ç›‘æ§
```

**ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒä¿æŠ¤**
```
âœ… å®ç°ç†”æ–­é™çº§ï¼ˆå…³é”®æœåŠ¡ï¼‰
âœ… é…ç½®èˆ±å£éš”ç¦»ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
âœ… éƒ¨ç½²å¤šçº§ç¼“å­˜
```

**ç¬¬ä¸‰é˜¶æ®µï¼šå…¨é¢å®¹é”™**
```
âœ… å®æ–½é™æµç­–ç•¥ï¼ˆå…¨å±€+æ¥å£çº§ï¼‰
âœ… å»ºç«‹å¼‚å¸¸æ¢å¤æœºåˆ¶
âœ… å®Œå–„ç›‘æ§å‘Šè­¦
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³



**é—®é¢˜1ï¼šé‡è¯•é£æš´**
```
ç°è±¡ï¼šå¤§é‡è¯·æ±‚åŒæ—¶é‡è¯•ï¼ŒåŠ é‡ç³»ç»Ÿè´Ÿæ‹…
è§£å†³ï¼š
â€¢ ä½¿ç”¨æŒ‡æ•°é€€é¿ + éšæœºå› å­
â€¢ é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°
â€¢ ä¸åŒæœåŠ¡é”™å¼€é‡è¯•æ—¶é—´
```

**é—®é¢˜2ï¼šç¼“å­˜é›ªå´©**
```
ç°è±¡ï¼šå¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚æ‰“åˆ°æ•°æ®åº“
è§£å†³ï¼š
â€¢ è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
â€¢ ç¼“å­˜é¢„çƒ­
â€¢ æ°¸ä¸è¿‡æœŸ + å¼‚æ­¥æ›´æ–°
```

**é—®é¢˜3ï¼šç†”æ–­è¯¯åˆ¤**
```
ç°è±¡ï¼šå¶å‘æ•…éšœå¯¼è‡´ä¸å¿…è¦çš„ç†”æ–­
è§£å†³ï¼š
â€¢ æé«˜æœ€å°è°ƒç”¨æ¬¡æ•°é˜ˆå€¼
â€¢ è°ƒæ•´å¤±è´¥ç‡é˜ˆå€¼
â€¢ ä½¿ç”¨æ»‘åŠ¨çª—å£ç»Ÿè®¡
```

### 9.5 ç›‘æ§ä¸è¿ç»´



**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```
ğŸ”¸ é‡è¯•æŒ‡æ ‡
â€¢ é‡è¯•æ¬¡æ•°
â€¢ é‡è¯•æˆåŠŸç‡
â€¢ é‡è¯•å»¶è¿Ÿ

ğŸ”¸ ç†”æ–­æŒ‡æ ‡
â€¢ ç†”æ–­æ¬¡æ•°
â€¢ ç†”æ–­æ—¶é•¿
â€¢ é™çº§è°ƒç”¨æ¬¡æ•°

ğŸ”¸ é™æµæŒ‡æ ‡
â€¢ é™æµæ‹¦æˆªæ•°
â€¢ é€šè¿‡ç‡
â€¢ å“åº”æ—¶é—´

ğŸ”¸ ç¼“å­˜æŒ‡æ ‡
â€¢ å‘½ä¸­ç‡
â€¢ ç©¿é€æ¬¡æ•°
â€¢ å†…å­˜ä½¿ç”¨ç‡
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
é™æµè¶…æ—¶å…ˆæŠŠå…³ï¼Œé‡è¯•ç†”æ–­é˜²é›ªå´©
èˆ±å£éš”ç¦»æŠ¤æ ¸å¿ƒï¼Œç¼“å­˜é™çº§ä¿å¯ç”¨
ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œå®¹é”™æœºåˆ¶è®°å¿ƒé—´
```

---

# ğŸ¯ å®æˆ˜å»ºè®®



## é…ç½®æ¨¡æ¿


```yaml
# application.yml - ç”Ÿäº§ç¯å¢ƒå®¹é”™é…ç½®æ¨¡æ¿

resilience4j:
#  # ç†”æ–­å™¨
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 100
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 10
  
#  # é‡è¯•
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 1s
        retry-exceptions:
          - java.net.SocketTimeoutException
  
#  # é™æµ
  ratelimiter:
    configs:
      default:
        limit-for-period: 100
        limit-refresh-period: 1s
  
#  # èˆ±å£
  bulkhead:
    configs:
      default:
        max-concurrent-calls: 50

# è¶…æ—¶é…ç½®

feign:
  client:
    config:
      default:
        connectTimeout: 1000
        readTimeout: 3000
```

## æœ€ä½³å®è·µæ¸…å•


- âœ… æ‰€æœ‰è¿œç¨‹è°ƒç”¨å¿…é¡»é…ç½®è¶…æ—¶
- âœ… æ ¸å¿ƒæ¥å£å¿…é¡»æœ‰é™çº§æ–¹æ¡ˆ
- âœ… å…³é”®æœåŠ¡å¿…é¡»éš”ç¦»èµ„æº
- âœ… çƒ­ç‚¹æ•°æ®å¿…é¡»ä½¿ç”¨ç¼“å­˜
- âœ… é‡è¦æ“ä½œå¿…é¡»æœ‰é‡è¯•æœºåˆ¶
- âœ… é«˜å¹¶å‘æ¥å£å¿…é¡»æœ‰é™æµ
- âœ… æ‰€æœ‰å®¹é”™éƒ½è¦æœ‰ç›‘æ§å‘Šè­¦