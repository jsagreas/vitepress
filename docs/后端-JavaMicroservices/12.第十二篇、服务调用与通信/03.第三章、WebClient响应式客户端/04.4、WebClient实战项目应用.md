---
title: 4ã€WebClientå®æˆ˜é¡¹ç›®åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [WebClientå®æˆ˜åŸºç¡€](#1-WebClientå®æˆ˜åŸºç¡€)
2. [è°ƒç”¨è¿œç¨‹æœåŠ¡ç¤ºä¾‹](#2-è°ƒç”¨è¿œç¨‹æœåŠ¡ç¤ºä¾‹)
3. [å“åº”å¼æ•°æ®å¤„ç†](#3-å“åº”å¼æ•°æ®å¤„ç†)
4. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#4-å¼‚å¸¸å¤„ç†ç­–ç•¥)
5. [ç»Ÿä¸€å°è£…è®¾è®¡](#5-ç»Ÿä¸€å°è£…è®¾è®¡)
6. [æ€§èƒ½ç›‘æ§é›†æˆ](#6-æ€§èƒ½ç›‘æ§é›†æˆ)
7. [è°ƒè¯•æŠ€å·§åˆ†äº«](#7-è°ƒè¯•æŠ€å·§åˆ†äº«)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ WebClientå®æˆ˜åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯WebClientå®æˆ˜åº”ç”¨


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ ç”¨æ‰‹æœºAPPè°ƒç”¨åå°æ¥å£ä¸€æ ·ï¼Œå¾®æœåŠ¡ä¹‹é—´ä¹Ÿéœ€è¦äº’ç›¸è°ƒç”¨ã€‚WebClientå°±æ˜¯ä¸“é—¨ç”¨æ¥åšè¿™ä»¶äº‹çš„å·¥å…·ï¼Œè€Œä¸”å®ƒæ”¯æŒ**å“åº”å¼ç¼–ç¨‹**ï¼ˆä¸é˜»å¡ã€é«˜æ•ˆç‡ï¼‰ã€‚

```
ä¼ ç»Ÿè°ƒç”¨æ–¹å¼ï¼ˆé˜»å¡å¼ï¼‰ï¼š
æœåŠ¡A ----[ç­‰å¾…]----> æœåŠ¡B
       (çº¿ç¨‹å‚»ç­‰)    

WebClientæ–¹å¼ï¼ˆå“åº”å¼ï¼‰ï¼š
æœåŠ¡A ----[ç»§ç»­å¹²æ´»]----> æœåŠ¡B
       (æœ‰ç»“æœå†é€šçŸ¥æˆ‘)
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸš€ **é«˜æ€§èƒ½**ï¼šä¸é˜»å¡çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹èƒ½å¤„ç†æ›´å¤šè¯·æ±‚
- ğŸ”„ **å¼‚æ­¥å¤„ç†**ï¼šå‘å‡ºè¯·æ±‚åå¯ä»¥ç»§ç»­å¹²åˆ«çš„äº‹
- ğŸ’ª **åŠŸèƒ½å¼ºå¤§**ï¼šæ”¯æŒå„ç§å¤æ‚åœºæ™¯ï¼ˆè¶…æ—¶ã€é‡è¯•ã€ç†”æ–­ç­‰ï¼‰

### 1.2 å®æˆ˜åº”ç”¨åœºæ™¯


**çœŸå®ä¸šåŠ¡åœºæ™¯**ï¼š

```
ç”µå•†è®¢å•ç³»ç»Ÿå®ä¾‹ï¼š

è®¢å•æœåŠ¡ -------> ç”¨æˆ·æœåŠ¡ï¼ˆæŸ¥ç”¨æˆ·ä¿¡æ¯ï¼‰
   |
   +-----------> åº“å­˜æœåŠ¡ï¼ˆæ£€æŸ¥åº“å­˜ï¼‰
   |
   +-----------> æ”¯ä»˜æœåŠ¡ï¼ˆå‘èµ·æ”¯ä»˜ï¼‰
   
æ¯ä¸ªç®­å¤´éƒ½æ˜¯ä¸€æ¬¡è¿œç¨‹è°ƒç”¨ï¼Œéœ€è¦ç”¨WebClient
```

| åº”ç”¨åœºæ™¯ | è¯´æ˜ | ä½¿ç”¨é¢‘ç‡ |
|---------|------|---------|
| **æœåŠ¡é—´è°ƒç”¨** | `å¾®æœåŠ¡Aè°ƒç”¨å¾®æœåŠ¡Bçš„æ¥å£` | â­â­â­â­â­ |
| **ç¬¬ä¸‰æ–¹API** | `è°ƒç”¨å¾®ä¿¡ã€æ”¯ä»˜å®ç­‰å¤–éƒ¨æ¥å£` | â­â­â­â­ |
| **æ•°æ®èšåˆ** | `åŒæ—¶è°ƒç”¨å¤šä¸ªæœåŠ¡ï¼Œæ±‡æ€»ç»“æœ` | â­â­â­â­ |
| **å¼‚æ­¥é€šçŸ¥** | `å‘é€æ¶ˆæ¯åä¸ç­‰å¾…ç»“æœ` | â­â­â­ |

---

## 2. ğŸ“ è°ƒç”¨è¿œç¨‹æœåŠ¡ç¤ºä¾‹


### 2.1 åŸºç¡€GETè¯·æ±‚è°ƒç”¨


**ä¸šåŠ¡åœºæ™¯**ï¼šè®¢å•æœåŠ¡éœ€è¦è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯

```java
@Service
public class OrderService {
    
    @Autowired
    private WebClient webClient;
    
    // åœºæ™¯ï¼šåˆ›å»ºè®¢å•æ—¶ï¼Œéœ€è¦éªŒè¯ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    public Mono<UserInfo> getUserInfo(Long userId) {
        return webClient
            .get()  // GETè¯·æ±‚
            .uri("/api/users/{id}", userId)  // è·¯å¾„å‚æ•°
            .retrieve()  // å‘èµ·è¯·æ±‚
            .bodyToMono(UserInfo.class);  // è½¬æ¢ä¸ºUserInfoå¯¹è±¡
    }
}
```

**ä»£ç è§£é‡Š**ï¼š
- `get()`ï¼šæŒ‡å®šHTTPæ–¹æ³•ä¸ºGET
- `uri()`ï¼šè®¾ç½®è¯·æ±‚è·¯å¾„ï¼Œ`{id}`ä¼šè¢«userIdæ›¿æ¢
- `retrieve()`ï¼šçœŸæ­£å‘èµ·ç½‘ç»œè¯·æ±‚
- `bodyToMono()`ï¼šæŠŠè¿”å›çš„JSONè½¬æˆJavaå¯¹è±¡

### 2.2 POSTè¯·æ±‚æºå¸¦è¯·æ±‚ä½“


**ä¸šåŠ¡åœºæ™¯**ï¼šè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜

```java
// æ‰£å‡åº“å­˜çš„è¯·æ±‚å¯¹è±¡
public class StockRequest {
    private Long productId;  // å•†å“ID
    private Integer quantity;  // æ‰£å‡æ•°é‡
    // getter/setterçœç•¥
}

public Mono<StockResponse> reduceStock(StockRequest request) {
    return webClient
        .post()  // POSTè¯·æ±‚
        .uri("/api/stock/reduce")
        .bodyValue(request)  // å‘é€è¯·æ±‚ä½“ï¼ˆè‡ªåŠ¨è½¬JSONï¼‰
        .retrieve()
        .bodyToMono(StockResponse.class);
}
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š
- `post()`ï¼šPOSTè¯·æ±‚å¸¸ç”¨äºä¿®æ”¹æ•°æ®
- `bodyValue()`ï¼šè‡ªåŠ¨æŠŠJavaå¯¹è±¡è½¬æˆJSONå‘é€
- è¿”å›`Mono<T>`ï¼šå¼‚æ­¥ç»“æœï¼Œä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹

### 2.3 æ·»åŠ è¯·æ±‚å¤´å’Œå‚æ•°


**ä¸šåŠ¡åœºæ™¯**ï¼šè°ƒç”¨éœ€è¦è®¤è¯çš„ç¬¬ä¸‰æ–¹API

```java
public Mono<PaymentResult> callPaymentApi(PaymentRequest request) {
    return webClient
        .post()
        .uri(uriBuilder -> uriBuilder
            .path("/api/payment/create")
            .queryParam("notify", "true")  // æ·»åŠ URLå‚æ•°
            .build())
        .header("Authorization", "Bearer " + getToken())  // æ·»åŠ Token
        .header("Content-Type", "application/json")
        .bodyValue(request)
        .retrieve()
        .bodyToMono(PaymentResult.class);
}
```

**å®ç”¨æŠ€å·§**ï¼š
```
è¯·æ±‚å¤´çš„å¸¸è§ç”¨é€”ï¼š
âœ… Authorizationï¼šè®¤è¯ä»¤ç‰Œ
âœ… Content-Typeï¼šå†…å®¹ç±»å‹
âœ… Acceptï¼šæœŸæœ›çš„å“åº”æ ¼å¼
âœ… X-Request-Idï¼šé“¾è·¯è¿½è¸ªID
```

### 2.4 å¹¶å‘è°ƒç”¨å¤šä¸ªæœåŠ¡


**ä¸šåŠ¡åœºæ™¯**ï¼šåˆ›å»ºè®¢å•æ—¶åŒæ—¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å’Œæ£€æŸ¥åº“å­˜

```java
public Mono<OrderCreateResult> createOrder(OrderRequest request) {
    // åŒæ—¶å‘èµ·ä¸¤ä¸ªè¯·æ±‚
    Mono<UserInfo> userMono = getUserInfo(request.getUserId());
    Mono<StockInfo> stockMono = checkStock(request.getProductId());
    
    // ç­‰å¾…ä¸¤ä¸ªè¯·æ±‚éƒ½å®Œæˆï¼Œåˆå¹¶ç»“æœ
    return Mono.zip(userMono, stockMono)
        .flatMap(tuple -> {
            UserInfo user = tuple.getT1();  // ç¬¬ä¸€ä¸ªç»“æœ
            StockInfo stock = tuple.getT2();  // ç¬¬äºŒä¸ªç»“æœ
            
            // éªŒè¯é€šè¿‡ååˆ›å»ºè®¢å•
            if (stock.getQuantity() >= request.getQuantity()) {
                return saveOrder(user, request);
            } else {
                return Mono.error(new RuntimeException("åº“å­˜ä¸è¶³"));
            }
        });
}
```

**å¹¶å‘è°ƒç”¨çš„ä¼˜åŠ¿**ï¼š
```
ä¸²è¡Œè°ƒç”¨ï¼š
ç”¨æˆ·ä¿¡æ¯ (100ms) â†’ åº“å­˜æ£€æŸ¥ (100ms) = æ€»è€—æ—¶ 200ms

å¹¶å‘è°ƒç”¨ï¼š
ç”¨æˆ·ä¿¡æ¯ (100ms) â”
                  â”œâ†’ æ€»è€—æ—¶ 100ms
åº“å­˜æ£€æŸ¥ (100ms) â”˜
```

---

## 3. ğŸ”„ å“åº”å¼æ•°æ®å¤„ç†


### 3.1 ç†è§£å“åº”å¼è¿”å›å€¼


**Mono vs Fluxçš„åŒºåˆ«**ï¼ˆé€šä¿—ç†è§£ï¼‰ï¼š

```
Monoï¼šæ°´é¾™å¤´åªæ”¾å‡ºä¸€æ»´æ°´ï¼ˆå•ä¸ªç»“æœï¼‰
      é€‚ç”¨åœºæ™¯ï¼šæŸ¥è¯¢å•ä¸ªç”¨æˆ·ã€å•ä¸ªè®¢å•

Fluxï¼šæ°´é¾™å¤´æŒç»­å‡ºæ°´ï¼ˆå¤šä¸ªç»“æœæµï¼‰
      é€‚ç”¨åœºæ™¯ï¼šæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ã€è®¢å•æµæ°´
```

**ä»£ç ç¤ºä¾‹å¯¹æ¯”**ï¼š

```java
// Monoï¼šè¿”å›å•ä¸ªç”¨æˆ·
public Mono<User> getUser(Long id) {
    return webClient.get()
        .uri("/api/users/{id}", id)
        .retrieve()
        .bodyToMono(User.class);  // å•ä¸ªå¯¹è±¡ç”¨Mono
}

// Fluxï¼šè¿”å›ç”¨æˆ·åˆ—è¡¨
public Flux<User> getAllUsers() {
    return webClient.get()
        .uri("/api/users")
        .retrieve()
        .bodyToFlux(User.class);  // åˆ—è¡¨/æµç”¨Flux
}
```

### 3.2 æ•°æ®è½¬æ¢å’Œæ˜ å°„


**ä¸šåŠ¡åœºæ™¯**ï¼šè·å–ç”¨æˆ·ä¿¡æ¯åï¼Œåªå–å‡ºéœ€è¦çš„å­—æ®µ

```java
public Mono<String> getUserName(Long userId) {
    return webClient.get()
        .uri("/api/users/{id}", userId)
        .retrieve()
        .bodyToMono(UserInfo.class)
        .map(user -> user.getName());  // æå–å§“åå­—æ®µ
}

// æ›´å¤æ‚çš„è½¬æ¢
public Mono<OrderDTO> buildOrderDTO(Long orderId) {
    return webClient.get()
        .uri("/api/orders/{id}", orderId)
        .retrieve()
        .bodyToMono(Order.class)
        .map(order -> {
            // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
            OrderDTO dto = new OrderDTO();
            dto.setOrderNo(order.getOrderNo());
            dto.setAmount(order.getAmount() / 100.0);  // åˆ†è½¬å…ƒ
            dto.setStatusText(convertStatus(order.getStatus()));
            return dto;
        });
}
```

**è½¬æ¢æ“ä½œç¬¦è¯´æ˜**ï¼š
- `map()`ï¼šä¸€å¯¹ä¸€è½¬æ¢ï¼Œè¾“å…¥Aè¾“å‡ºB
- `flatMap()`ï¼šä¸€å¯¹å¤šæˆ–éœ€è¦å†æ¬¡è°ƒç”¨çš„è½¬æ¢
- `filter()`ï¼šè¿‡æ»¤æ•°æ®ï¼Œåªä¿ç•™ç¬¦åˆæ¡ä»¶çš„

### 3.3 å¤šä¸ªæœåŠ¡æ•°æ®èšåˆ


**ä¸šåŠ¡åœºæ™¯**ï¼šè®¢å•è¯¦æƒ…é¡µéœ€è¦èšåˆå¤šä¸ªæœåŠ¡çš„æ•°æ®

```java
public Mono<OrderDetailVO> getOrderDetail(Long orderId) {
    // 1. å…ˆæŸ¥è®¢å•åŸºæœ¬ä¿¡æ¯
    return webClient.get()
        .uri("/api/orders/{id}", orderId)
        .retrieve()
        .bodyToMono(Order.class)
        .flatMap(order -> {
            // 2. æ ¹æ®è®¢å•ä¿¡æ¯ï¼Œå†æŸ¥ç”¨æˆ·å’Œå•†å“
            Mono<User> userMono = getUserInfo(order.getUserId());
            Mono<Product> productMono = getProductInfo(order.getProductId());
            
            // 3. åˆå¹¶ä¸‰ä¸ªæ•°æ®æº
            return Mono.zip(Mono.just(order), userMono, productMono)
                .map(tuple -> {
                    OrderDetailVO vo = new OrderDetailVO();
                    vo.setOrder(tuple.getT1());      // è®¢å•
                    vo.setUser(tuple.getT2());       // ç”¨æˆ·
                    vo.setProduct(tuple.getT3());    // å•†å“
                    return vo;
                });
        });
}
```

**æ•°æ®èšåˆæµç¨‹å›¾**ï¼š
```
                  getOrderDetail(orderId)
                         |
                         â†“
                  [æŸ¥è¯¢è®¢å•ä¿¡æ¯]
                         |
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                     â†“
         [æŸ¥ç”¨æˆ·ä¿¡æ¯]           [æŸ¥å•†å“ä¿¡æ¯]
              â†“                     â†“
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                   [åˆå¹¶ç»“æœ]
                         â†“
                  è¿”å›å®Œæ•´è¯¦æƒ…
```

### 3.4 æ¡ä»¶å¤„ç†å’Œè¿‡æ»¤


```java
public Mono<Order> getValidOrder(Long orderId) {
    return webClient.get()
        .uri("/api/orders/{id}", orderId)
        .retrieve()
        .bodyToMono(Order.class)
        .filter(order -> order.getStatus() != OrderStatus.CANCELLED)  // è¿‡æ»¤å·²å–æ¶ˆè®¢å•
        .switchIfEmpty(Mono.error(new OrderCancelledException()));  // ç©ºå€¼å¤„ç†
}

// åˆ—è¡¨è¿‡æ»¤ç¤ºä¾‹
public Flux<Product> getAvailableProducts() {
    return webClient.get()
        .uri("/api/products")
        .retrieve()
        .bodyToFlux(Product.class)
        .filter(p -> p.getStock() > 0)  // åªè¦æœ‰åº“å­˜çš„
        .filter(p -> p.getPrice() < 1000);  // ä»·æ ¼å°äº1000çš„
}
```

---

## 4. âš ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 4.1 HTTPçŠ¶æ€ç å¼‚å¸¸å¤„ç†


**é—®é¢˜åœºæ™¯**ï¼šè°ƒç”¨çš„æœåŠ¡è¿”å›404æˆ–500ç­‰é”™è¯¯çŠ¶æ€ç 

```java
public Mono<User> getUserWithErrorHandle(Long userId) {
    return webClient.get()
        .uri("/api/users/{id}", userId)
        .retrieve()
        .onStatus(
            status -> status.value() == 404,  // 404æ—¶çš„å¤„ç†
            response -> Mono.error(new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"))
        )
        .onStatus(
            HttpStatus::is5xxServerError,  // 5xxæœåŠ¡å™¨é”™è¯¯
            response -> Mono.error(new RemoteServiceException("æœåŠ¡å¼‚å¸¸"))
        )
        .bodyToMono(User.class);
}
```

**çŠ¶æ€ç å¤„ç†ç­–ç•¥è¡¨**ï¼š

| çŠ¶æ€ç èŒƒå›´ | å«ä¹‰ | å¤„ç†å»ºè®® |
|----------|------|---------|
| **2xx** | `æˆåŠŸ` | `æ­£å¸¸å¤„ç†å“åº”ä½“` |
| **4xx** | `å®¢æˆ·ç«¯é”™è¯¯` | `æ£€æŸ¥è¯·æ±‚å‚æ•°ã€æƒé™ç­‰` |
| **404** | `èµ„æºä¸å­˜åœ¨` | `è¿”å›å‹å¥½æç¤ºæˆ–é»˜è®¤å€¼` |
| **5xx** | `æœåŠ¡ç«¯é”™è¯¯` | `é‡è¯•æˆ–é™çº§å¤„ç†` |

### 4.2 ç½‘ç»œè¶…æ—¶å¼‚å¸¸å¤„ç†


**ä¸šåŠ¡åœºæ™¯**ï¼šè¿œç¨‹æœåŠ¡å“åº”æ…¢ï¼Œéœ€è¦è®¾ç½®è¶…æ—¶å’Œé‡è¯•

```java
public Mono<PaymentResult> payWithRetry(PaymentRequest request) {
    return webClient.post()
        .uri("/api/payment/pay")
        .bodyValue(request)
        .retrieve()
        .bodyToMono(PaymentResult.class)
        .timeout(Duration.ofSeconds(3))  // 3ç§’è¶…æ—¶
        .retry(2)  // å¤±è´¥é‡è¯•2æ¬¡
        .onErrorResume(TimeoutException.class, e -> {
            // è¶…æ—¶åçš„é™çº§å¤„ç†
            log.error("æ”¯ä»˜æ¥å£è¶…æ—¶", e);
            return Mono.just(PaymentResult.timeout());
        });
}
```

**é‡è¯•ç­–ç•¥è¯¦è§£**ï¼š
```
retry(2) çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

ç¬¬1æ¬¡è¯·æ±‚ â†’ å¤±è´¥
    â†“
ç¬¬2æ¬¡è¯·æ±‚ â†’ å¤±è´¥
    â†“
ç¬¬3æ¬¡è¯·æ±‚ â†’ æˆåŠŸ/å¤±è´¥

âš ï¸ æ³¨æ„ï¼šä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½é€‚åˆé‡è¯•
âœ… é€‚åˆé‡è¯•ï¼šæŸ¥è¯¢ã€å¹‚ç­‰æ“ä½œ
âŒ ä¸é€‚åˆï¼šæ”¯ä»˜ã€ä¸‹å•ç­‰éå¹‚ç­‰æ“ä½œ
```

### 4.3 ç»Ÿä¸€å¼‚å¸¸å…œåº•å¤„ç†


```java
public Mono<OrderInfo> getOrderWithFallback(Long orderId) {
    return webClient.get()
        .uri("/api/orders/{id}", orderId)
        .retrieve()
        .bodyToMono(OrderInfo.class)
        .onErrorResume(e -> {
            // è®°å½•é”™è¯¯æ—¥å¿—
            log.error("æŸ¥è¯¢è®¢å•å¤±è´¥ï¼ŒorderId={}", orderId, e);
            
            // æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„é»˜è®¤å€¼
            if (e instanceof WebClientResponseException.NotFound) {
                return Mono.empty();  // 404è¿”å›ç©º
            } else if (e instanceof TimeoutException) {
                return Mono.just(OrderInfo.createTimeoutPlaceholder());
            } else {
                return Mono.error(new BizException("è®¢å•æœåŠ¡å¼‚å¸¸"));
            }
        });
}
```

### 4.4 å“åº”ä½“å¼‚å¸¸æå–


**åœºæ™¯**ï¼šåç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯åœ¨å“åº”ä½“é‡Œ

```java
public Mono<User> getUserWithBodyError(Long userId) {
    return webClient.get()
        .uri("/api/users/{id}", userId)
        .retrieve()
        .onStatus(HttpStatus::isError, response -> 
            response.bodyToMono(ErrorResponse.class)  // æå–é”™è¯¯è¯¦æƒ…
                .flatMap(error -> Mono.error(
                    new BizException(error.getCode(), error.getMessage())
                ))
        )
        .bodyToMono(User.class);
}

// é”™è¯¯å“åº”å¯¹è±¡
@Data
class ErrorResponse {
    private String code;
    private String message;
}
```

---

## 5. ğŸ—ï¸ ç»Ÿä¸€å°è£…è®¾è®¡


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å°è£…


**ç—›ç‚¹é—®é¢˜**ï¼š
```
âŒ æ¯æ¬¡è°ƒç”¨éƒ½è¦é‡å¤å†™è¶…æ—¶ã€é‡è¯•ã€å¼‚å¸¸å¤„ç†
âŒ æ—¥å¿—è®°å½•ä¸ç»Ÿä¸€ï¼Œæ’æŸ¥é—®é¢˜å›°éš¾
âŒ ç›‘æ§åŸ‹ç‚¹åˆ°å¤„éƒ½æ˜¯ï¼Œä»£ç æ··ä¹±
```

**å°è£…åçš„å¥½å¤„**ï¼š
```
âœ… è°ƒç”¨ä»£ç ç®€æ´ï¼Œåªå…³æ³¨ä¸šåŠ¡é€»è¾‘
âœ… ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
âœ… æ–¹ä¾¿æ·»åŠ é“¾è·¯è¿½è¸ªã€æ€§èƒ½ç›‘æ§
```

### 5.2 åŸºç¡€å°è£…å·¥å…·ç±»


```java
@Component
public class WebClientHelper {
    
    @Autowired
    private WebClient webClient;
    
    /**
     * GETè¯·æ±‚å°è£…
     * @param uri è¯·æ±‚è·¯å¾„
     * @param responseType å“åº”ç±»å‹
     * @return å“åº”ç»“æœ
     */
    public <T> Mono<T> get(String uri, Class<T> responseType) {
        return webClient.get()
            .uri(uri)
            .retrieve()
            .onStatus(HttpStatus::isError, this::handleError)
            .bodyToMono(responseType)
            .timeout(Duration.ofSeconds(5))
            .doOnSubscribe(s -> log.info("å‘èµ·GETè¯·æ±‚: {}", uri))
            .doOnSuccess(r -> log.info("è¯·æ±‚æˆåŠŸ: {}", uri))
            .doOnError(e -> log.error("è¯·æ±‚å¤±è´¥: {}", uri, e));
    }
    
    /**
     * POSTè¯·æ±‚å°è£…
     */
    public <T, R> Mono<R> post(String uri, T body, Class<R> responseType) {
        return webClient.post()
            .uri(uri)
            .bodyValue(body)
            .retrieve()
            .onStatus(HttpStatus::isError, this::handleError)
            .bodyToMono(responseType)
            .timeout(Duration.ofSeconds(5))
            .doOnSubscribe(s -> log.info("å‘èµ·POSTè¯·æ±‚: {}, body={}", uri, body))
            .doOnSuccess(r -> log.info("è¯·æ±‚æˆåŠŸ: {}", uri))
            .doOnError(e -> log.error("è¯·æ±‚å¤±è´¥: {}", uri, e));
    }
    
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    private Mono<Throwable> handleError(ClientResponse response) {
        return response.bodyToMono(String.class)
            .flatMap(body -> Mono.error(
                new RemoteServiceException(response.statusCode().value(), body)
            ));
    }
}
```

### 5.3 ä¸šåŠ¡å±‚ä¼˜é›…ä½¿ç”¨


```java
@Service
public class OrderService {
    
    @Autowired
    private WebClientHelper webClientHelper;
    
    // ä½¿ç”¨å°è£…åï¼šä»£ç å˜å¾—å¾ˆç®€æ´
    public Mono<UserInfo> getUserInfo(Long userId) {
        return webClientHelper.get(
            "/api/users/" + userId, 
            UserInfo.class
        );
    }
    
    public Mono<StockResponse> reduceStock(StockRequest request) {
        return webClientHelper.post(
            "/api/stock/reduce",
            request,
            StockResponse.class
        );
    }
}
```

### 5.4 å¸¦é‡è¯•å’Œç†”æ–­çš„å¢å¼ºå°è£…


```java
@Component
public class ResilientWebClient {
    
    @Autowired
    private WebClient webClient;
    
    // æ”¯æŒé‡è¯•çš„è¯·æ±‚
    public <T> Mono<T> getWithRetry(String uri, Class<T> type, int maxRetries) {
        return webClient.get()
            .uri(uri)
            .retrieve()
            .bodyToMono(type)
            .retryWhen(Retry.backoff(maxRetries, Duration.ofMillis(100))
                .filter(this::shouldRetry)  // åªé‡è¯•ç‰¹å®šå¼‚å¸¸
                .doBeforeRetry(signal -> 
                    log.warn("é‡è¯•è¯·æ±‚: {}, ç¬¬{}æ¬¡", uri, signal.totalRetries() + 1)
                )
            );
    }
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
    private boolean shouldRetry(Throwable e) {
        return e instanceof WebClientRequestException  // ç½‘ç»œå¼‚å¸¸
            || e instanceof TimeoutException;  // è¶…æ—¶
    }
    
    // æ”¯æŒé™çº§çš„è¯·æ±‚
    public <T> Mono<T> getWithFallback(String uri, Class<T> type, T fallbackValue) {
        return webClient.get()
            .uri(uri)
            .retrieve()
            .bodyToMono(type)
            .timeout(Duration.ofSeconds(3))
            .onErrorReturn(fallbackValue);  // å¤±è´¥è¿”å›é»˜è®¤å€¼
    }
}
```

---

## 6. ğŸ“Š æ€§èƒ½ç›‘æ§é›†æˆ


### 6.1 å“åº”æ—¶é—´ç›‘æ§


**ç›®æ ‡**ï¼šè®°å½•æ¯ä¸ªæ¥å£çš„è°ƒç”¨è€—æ—¶ï¼Œå‘ç°æ€§èƒ½ç“¶é¢ˆ

```java
@Component
public class MonitoredWebClient {
    
    @Autowired
    private WebClient webClient;
    
    @Autowired
    private MeterRegistry meterRegistry;  // Micrometerç›‘æ§
    
    public <T> Mono<T> monitoredGet(String serviceName, String uri, Class<T> type) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        return webClient.get()
            .uri(uri)
            .retrieve()
            .bodyToMono(type)
            .doFinally(signalType -> {
                // è®°å½•è€—æ—¶
                sample.stop(Timer.builder("http.client.requests")
                    .tag("service", serviceName)
                    .tag("uri", uri)
                    .tag("status", signalType.toString())
                    .register(meterRegistry));
            });
    }
}
```

**ç›‘æ§æ•ˆæœå±•ç¤º**ï¼š
```
Metricsè¾“å‡ºç¤ºä¾‹ï¼š
http.client.requests{service="user-service", uri="/api/users/123", status="onComplete"} 
  count: 100
  mean: 45ms
  max: 230ms
  
å¯ä»¥åœ¨Grafanaçœ‹åˆ°ï¼š
ğŸ“ˆ å¹³å‡å“åº”æ—¶é—´ï¼š45ms
ğŸ“ˆ æœ€å¤§å“åº”æ—¶é—´ï¼š230ms
ğŸ“ˆ è°ƒç”¨æ¬¡æ•°ï¼š100æ¬¡
```

### 6.2 æˆåŠŸç‡ç›‘æ§


```java
public <T> Mono<T> monitoredRequest(String uri, Class<T> type) {
    Counter successCounter = Counter.builder("http.success")
        .tag("uri", uri)
        .register(meterRegistry);
    
    Counter failCounter = Counter.builder("http.fail")
        .tag("uri", uri)
        .register(meterRegistry);
    
    return webClient.get()
        .uri(uri)
        .retrieve()
        .bodyToMono(type)
        .doOnSuccess(r -> successCounter.increment())  // æˆåŠŸ+1
        .doOnError(e -> failCounter.increment());  // å¤±è´¥+1
}
```

**æˆåŠŸç‡è®¡ç®—å…¬å¼**ï¼š
```
æˆåŠŸç‡ = æˆåŠŸæ¬¡æ•° / (æˆåŠŸæ¬¡æ•° + å¤±è´¥æ¬¡æ•°) Ã— 100%

ç¤ºä¾‹ï¼š
http.success{uri="/api/users"} = 950
http.fail{uri="/api/users"} = 50
æˆåŠŸç‡ = 950 / 1000 = 95%
```

### 6.3 é›†æˆé“¾è·¯è¿½è¸ª


**ç›®æ ‡**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿½è¸ªè¯·æ±‚é“¾è·¯

```java
@Component
public class TracedWebClient {
    
    @Autowired
    private WebClient webClient;
    
    @Autowired
    private Tracer tracer;  // Sleuthæˆ–å…¶ä»–è¿½è¸ªå·¥å…·
    
    public <T> Mono<T> tracedGet(String uri, Class<T> type) {
        Span span = tracer.nextSpan().name("http-get").start();
        
        return webClient.get()
            .uri(uri)
            .header("X-B3-TraceId", span.context().traceIdString())  // ä¼ é€’TraceId
            .retrieve()
            .bodyToMono(type)
            .doFinally(signal -> {
                if (signal == SignalType.ON_ERROR) {
                    span.tag("error", "true");
                }
                span.finish();
            })
            .contextWrite(context -> context.put(Span.class, span));
    }
}
```

**é“¾è·¯è¿½è¸ªæ•ˆæœ**ï¼š
```
è¯·æ±‚é“¾è·¯ç¤ºä¾‹ï¼š
[è®¢å•æœåŠ¡] traceId=abc123
    â†“ httpè°ƒç”¨
[ç”¨æˆ·æœåŠ¡] traceId=abc123 spanId=span1
    â†“ httpè°ƒç”¨  
[ç§¯åˆ†æœåŠ¡] traceId=abc123 spanId=span2

æ‰€æœ‰æ—¥å¿—éƒ½å¸¦ä¸ŠtraceIdï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
```

---

## 7. ğŸ”§ è°ƒè¯•æŠ€å·§åˆ†äº«


### 7.1 è¯·æ±‚å“åº”æ—¥å¿—è®°å½•


```java
public <T> Mono<T> debugRequest(String uri, Class<T> type) {
    return webClient.get()
        .uri(uri)
        .retrieve()
        .bodyToMono(type)
        // è¯·æ±‚å¼€å§‹
        .doOnSubscribe(s -> 
            log.debug(">>> å‘é€è¯·æ±‚: GET {}", uri)
        )
        // è¯·æ±‚æˆåŠŸ
        .doOnSuccess(response -> 
            log.debug("<<< å“åº”æˆåŠŸ: {}", JSON.toJSONString(response))
        )
        // è¯·æ±‚å¤±è´¥
        .doOnError(error -> 
            log.error("<<< å“åº”å¤±è´¥: {}", error.getMessage(), error)
        );
}
```

### 7.2 æŠ“å–åŸå§‹å“åº”å†…å®¹


**åœºæ™¯**ï¼šæœ‰æ—¶å€™éœ€è¦çœ‹åˆ°åŸå§‹çš„JSONå­—ç¬¦ä¸²

```java
public Mono<String> getRawResponse(String uri) {
    return webClient.get()
        .uri(uri)
        .retrieve()
        .bodyToMono(String.class)  // è·å–åŸå§‹å­—ç¬¦ä¸²
        .doOnSuccess(raw -> log.info("åŸå§‹å“åº”: {}", raw));
}

// ç„¶åæ‰‹åŠ¨è§£æ
public Mono<User> parseManually(String uri) {
    return getRawResponse(uri)
        .map(json -> {
            // å¯ä»¥ç”¨JSONå·¥å…·æ‰‹åŠ¨è§£æï¼Œæ–¹ä¾¿è°ƒè¯•
            return JSON.parseObject(json, User.class);
        });
}
```

### 7.3 æ¨¡æ‹Ÿå¼‚å¸¸åœºæ™¯æµ‹è¯•


```java
@Component
public class WebClientTester {
    
    // æ¨¡æ‹Ÿè¶…æ—¶
    public Mono<String> testTimeout() {
        return webClient.get()
            .uri("/api/slow")  // æ•…æ„è®¿é—®æ…¢æ¥å£
            .retrieve()
            .bodyToMono(String.class)
            .timeout(Duration.ofMillis(100))  // è®¾ç½®å¾ˆçŸ­çš„è¶…æ—¶
            .doOnError(TimeoutException.class, e -> 
                log.info("æˆåŠŸè§¦å‘è¶…æ—¶å¼‚å¸¸")
            );
    }
    
    // æ¨¡æ‹Ÿ404
    public Mono<String> test404() {
        return webClient.get()
            .uri("/api/notexist")  // ä¸å­˜åœ¨çš„è·¯å¾„
            .retrieve()
            .bodyToMono(String.class)
            .onErrorResume(WebClientResponseException.NotFound.class, e -> {
                log.info("æˆåŠŸè§¦å‘404å¼‚å¸¸");
                return Mono.just("é»˜è®¤å€¼");
            });
    }
}
```

### 7.4 ä½¿ç”¨WireMockè¿›è¡ŒMockæµ‹è¯•


```java
@SpringBootTest
class WebClientTest {
    
    @Autowired
    private WebClient webClient;
    
    @Test
    void testUserService() {
        // å¯åŠ¨MockæœåŠ¡å™¨
        WireMockServer mockServer = new WireMockServer(8089);
        mockServer.start();
        
        // é…ç½®Mockå“åº”
        mockServer.stubFor(get("/api/users/1")
            .willReturn(aResponse()
                .withStatus(200)
                .withHeader("Content-Type", "application/json")
                .withBody("{\"id\":1,\"name\":\"å¼ ä¸‰\"}")));
        
        // æµ‹è¯•WebClientè°ƒç”¨
        User user = webClient.get()
            .uri("http://localhost:8089/api/users/1")
            .retrieve()
            .bodyToMono(User.class)
            .block();
        
        assertEquals("å¼ ä¸‰", user.getName());
        mockServer.stop();
    }
}
```

### 7.5 å¸¸è§é—®é¢˜æ’æŸ¥æ¸…å•


> ğŸ’¡ **è°ƒç”¨å¤±è´¥æ—¶çš„æ£€æŸ¥æ­¥éª¤**

```
1ï¸âƒ£ æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
   âœ“ ping ç›®æ ‡æœåŠ¡å™¨
   âœ“ telnet ç«¯å£æ˜¯å¦é€š

2ï¸âƒ£ æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®
   âœ“ åè®®ï¼šhttpè¿˜æ˜¯https
   âœ“ è·¯å¾„ï¼šæ˜¯å¦æ‹¼å†™é”™è¯¯
   âœ“ å‚æ•°ï¼šæ˜¯å¦æ­£ç¡®ä¼ é€’

3ï¸âƒ£ æ£€æŸ¥è¯·æ±‚å¤´
   âœ“ Content-Typeæ˜¯å¦åŒ¹é…
   âœ“ Authorizationæ˜¯å¦è¿‡æœŸ

4ï¸âƒ£ æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
   âœ“ çŠ¶æ€ç ï¼š404/500ç­‰
   âœ“ å“åº”ä½“ï¼šé”™è¯¯è¯¦æƒ…
   âœ“ å †æ ˆä¿¡æ¯ï¼šå®šä½ä»£ç ä½ç½®
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ WebClientæ˜¯å“åº”å¼HTTPå®¢æˆ·ç«¯ï¼Œæ¯”RestTemplateæ›´é«˜æ•ˆ
ğŸ”¸ Monoè¿”å›0-1ä¸ªç»“æœï¼ŒFluxè¿”å›0-Nä¸ªç»“æœ
ğŸ”¸ å¼‚å¸¸å¤„ç†åŒ…æ‹¬ï¼šçŠ¶æ€ç å¤„ç†ã€è¶…æ—¶å¤„ç†ã€é™çº§å¤„ç†
ğŸ”¸ ç»Ÿä¸€å°è£…èƒ½æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
ğŸ”¸ ç›‘æ§å’Œæ—¥å¿—å¯¹ç”Ÿäº§ç¯å¢ƒè‡³å…³é‡è¦
```

### 8.2 å®æˆ˜æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆä¸€èˆ¬3-5ç§’ï¼‰
- å¯¹éå¹‚ç­‰æ“ä½œè°¨æ…ä½¿ç”¨é‡è¯•
- è®°å½•å®Œæ•´çš„è¯·æ±‚æ—¥å¿—ä¾¿äºæ’æŸ¥
- ä½¿ç”¨ç»Ÿä¸€å°è£…å‡å°‘é‡å¤ä»£ç 
- æ·»åŠ ç›‘æ§å’Œé“¾è·¯è¿½è¸ª

**âŒ é¿å…çš„å‘**ï¼š
- ä¸è®¾ç½®è¶…æ—¶ï¼Œå¯¼è‡´çº¿ç¨‹ä¸€ç›´ç­‰å¾…
- å¯¹æ”¯ä»˜ç­‰æ“ä½œç›²ç›®é‡è¯•
- å¼‚å¸¸ä¿¡æ¯åæ‰ä¸æ‰“æ—¥å¿—
- æ¯ä¸ªåœ°æ–¹éƒ½é‡å¤å†™è°ƒç”¨ä»£ç 

### 8.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


```
ğŸš€ æå‡æ€§èƒ½çš„å…³é”®ç‚¹ï¼š

1. è¿æ¥æ± é…ç½®
   - åˆç†è®¾ç½®æœ€å¤§è¿æ¥æ•°
   - å¤ç”¨HTTPè¿æ¥

2. å¹¶å‘è°ƒç”¨
   - å¤šä¸ªç‹¬ç«‹è¯·æ±‚å¹¶å‘æ‰§è¡Œ
   - ä½¿ç”¨Mono.zipåˆå¹¶ç»“æœ

3. å¼‚æ­¥å¤„ç†
   - å……åˆ†åˆ©ç”¨å“åº”å¼éé˜»å¡ç‰¹æ€§
   - é¿å…block()é˜»å¡è°ƒç”¨

4. ç¼“å­˜ç­–ç•¥
   - å¯¹ä¸å¸¸å˜åŒ–çš„æ•°æ®åŠ ç¼“å­˜
   - å‡å°‘é‡å¤çš„è¿œç¨‹è°ƒç”¨
```

### 8.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


**å…³é”®APIé€Ÿè®°**ï¼š
- `get()/post()`ï¼šè®¾ç½®HTTPæ–¹æ³•
- `uri()`ï¼šè®¾ç½®è¯·æ±‚è·¯å¾„
- `bodyValue()`ï¼šè®¾ç½®è¯·æ±‚ä½“
- `retrieve()`ï¼šå‘èµ·è¯·æ±‚
- `bodyToMono()/bodyToFlux()`ï¼šå¤„ç†å“åº”
- `timeout()`ï¼šè®¾ç½®è¶…æ—¶
- `retry()`ï¼šè®¾ç½®é‡è¯•
- `onErrorResume()`ï¼šå¼‚å¸¸é™çº§

**è°ƒè¯•æŠ€å·§é€Ÿè®°**ï¼š
- æ‰“å¼€DEBUGæ—¥å¿—çœ‹è¯¦ç»†è¿‡ç¨‹
- ç”¨`doOnXxx()`è®°å½•å„ä¸ªé˜¶æ®µ
- WireMockæ¨¡æ‹Ÿå„ç§åœºæ™¯
- ç›‘æ§é¢æ¿è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡