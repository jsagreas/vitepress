---
title: 2ã€å¼‚æ­¥é€šä¿¡æ¨¡å¼å®è·µ
---
## ğŸ“š ç›®å½•

1. [å¼‚æ­¥é€šä¿¡åŸºç¡€æ¦‚å¿µ](#1-å¼‚æ­¥é€šä¿¡åŸºç¡€æ¦‚å¿µ)
2. [æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡](#2-æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡)
3. [äº‹ä»¶é©±åŠ¨æ¶æ„](#3-äº‹ä»¶é©±åŠ¨æ¶æ„)
4. [å‘å¸ƒè®¢é˜…æ¨¡å¼](#4-å‘å¸ƒè®¢é˜…æ¨¡å¼)
5. [æ¶ˆæ¯å¯é æ€§ä¿è¯](#5-æ¶ˆæ¯å¯é æ€§ä¿è¯)
6. [å¼‚æ­¥å¤„ç†ç­–ç•¥](#6-å¼‚æ­¥å¤„ç†ç­–ç•¥)
7. [å›è°ƒæœºåˆ¶è®¾è®¡](#7-å›è°ƒæœºåˆ¶è®¾è®¡)
8. [çŠ¶æ€ä¸€è‡´æ€§å¤„ç†](#8-çŠ¶æ€ä¸€è‡´æ€§å¤„ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¼‚æ­¥é€šä¿¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥é€šä¿¡


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼š
> - **åŒæ­¥æ–¹å¼**ï¼šä½ ç«™åœ¨æŸœå°å‰ï¼Œç­‰å¨å¸ˆåšå®Œèœæ‰èƒ½ç¦»å¼€ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
> - **å¼‚æ­¥æ–¹å¼**ï¼šä½ ç‚¹å®Œé¤æ‹¿ä¸ªå·ç ç‰Œï¼Œè¯¥å¹²å˜›å¹²å˜›ï¼Œèœå¥½äº†å«ä½ ï¼ˆéé˜»å¡ï¼‰

**æ ¸å¿ƒå®šä¹‰**
```
å¼‚æ­¥é€šä¿¡ï¼šæœåŠ¡Aå‘é€è¯·æ±‚åä¸ç­‰å¾…å“åº”ï¼Œç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡
ä¼˜åŠ¿ï¼šæé«˜ç³»ç»Ÿååé‡ï¼Œé¿å…èµ„æºæµªè´¹
é€‚ç”¨ï¼šè€—æ—¶æ“ä½œã€æ‰¹é‡å¤„ç†ã€æ¾è€¦åˆåœºæ™¯
```

### 1.2 åŒæ­¥vså¼‚æ­¥å¯¹æ¯”


**ğŸ“Š æ ¸å¿ƒå·®å¼‚å¯¹æ¯”**

| ç‰¹æ€§ | **åŒæ­¥é€šä¿¡** | **å¼‚æ­¥é€šä¿¡** |
|------|------------|-------------|
| ğŸ”„ **è°ƒç”¨æ–¹å¼** | `è¯·æ±‚åç­‰å¾…å“åº”` | `è¯·æ±‚åç»§ç»­æ‰§è¡Œ` |
| â±ï¸ **æ€§èƒ½å½±å“** | `é˜»å¡ç­‰å¾…ï¼Œèµ„æºå ç”¨` | `éé˜»å¡ï¼Œèµ„æºé«˜æ•ˆåˆ©ç”¨` |
| ğŸ”— **æœåŠ¡è€¦åˆ** | `å¼ºè€¦åˆï¼Œå¿…é¡»åŒæ—¶åœ¨çº¿` | `æ¾è€¦åˆï¼Œå¯ç¦»çº¿å¤„ç†` |
| ğŸ¯ **é€‚ç”¨åœºæ™¯** | `å³æ—¶å“åº”éœ€æ±‚` | `å¯å»¶è¿Ÿå¤„ç†åœºæ™¯` |
| ğŸ“ˆ **ååé‡** | `å—é™äºå“åº”æ—¶é—´` | `é«˜ååé‡` |

**å®é™…åœºæ™¯å¯¹æ¯”**
```
ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥ï¼š
åŒæ­¥ï¼šç”¨æˆ·ç­‰å¾…é‚®ä»¶å‘é€å®Œæˆæ‰èƒ½ç»§ç»­æ“ä½œ âŒ
å¼‚æ­¥ï¼šæäº¤å‘é€ä»»åŠ¡åç«‹å³è¿”å›ï¼Œåå°æ…¢æ…¢å‘ âœ…

ğŸ“Š ç”Ÿæˆæ•°æ®æŠ¥è¡¨ï¼š
åŒæ­¥ï¼šå‰ç«¯ç­‰å¾…10åˆ†é’ŸæŠ¥è¡¨ç”Ÿæˆå®Œæˆ âŒ  
å¼‚æ­¥ï¼šæäº¤ä»»åŠ¡åå»å¿™åˆ«çš„ï¼Œå®Œæˆåé€šçŸ¥ âœ…
```

### 1.3 å¼‚æ­¥é€šä¿¡çš„æ ¸å¿ƒä»·å€¼


**ğŸ’ æ ¸å¿ƒä¼˜åŠ¿**
```
1ï¸âƒ£ æå‡æ€§èƒ½
   - ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œç³»ç»Ÿå“åº”æ›´å¿«
   - å¹¶å‘å¤„ç†èƒ½åŠ›å¤§å¹…æå‡
   
2ï¸âƒ£ é™ä½è€¦åˆ
   - æœåŠ¡é—´ä¸éœ€è¦åŒæ—¶åœ¨çº¿
   - ä¸€æ–¹æ•…éšœä¸å½±å“å¦ä¸€æ–¹æäº¤è¯·æ±‚
   
3ï¸âƒ£ å‰Šå³°å¡«è°·
   - é«˜å³°æœŸä»»åŠ¡å…ˆæ’é˜Ÿï¼Œæ…¢æ…¢å¤„ç†
   - é¿å…ç¬é—´æµé‡å‹å®ç³»ç»Ÿ
   
4ï¸âƒ£ æé«˜å¯é æ€§
   - æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¸æ€•æœåŠ¡é‡å¯
   - å¤±è´¥é‡è¯•æœºåˆ¶ä¿è¯æœ€ç»ˆæˆåŠŸ
```

**ğŸš¨ æ³¨æ„äº‹é¡¹**
```
å¼‚æ­¥â‰ æ›´å¥½ï¼Œéœ€è¦æƒè¡¡ï¼š
- å¤æ‚åº¦å¢åŠ ï¼šéœ€è¦æ¶ˆæ¯ä¸­é—´ä»¶ã€çŠ¶æ€ç®¡ç†
- ä¸€è‡´æ€§æŒ‘æˆ˜ï¼šæ•°æ®æœ€ç»ˆä¸€è‡´æ€§é—®é¢˜
- è°ƒè¯•å›°éš¾ï¼šè¯·æ±‚é“¾è·¯å˜é•¿ï¼Œæ’æŸ¥é—®é¢˜å¤æ‚
- å®æ—¶æ€§é™ä½ï¼šä¸é€‚åˆå¼ºå®æ—¶æ€§éœ€æ±‚
```

---

## 2. ğŸ“¬ æ¶ˆæ¯é˜Ÿåˆ—é€šä¿¡


### 2.1 æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
æ¶ˆæ¯é˜Ÿåˆ—ï¼šæœåŠ¡é—´ä¼ é€’æ¶ˆæ¯çš„ä¸­é—´ä»¶
å·¥ä½œåŸç†ï¼šç”Ÿäº§è€…å‘æ¶ˆæ¯â†’é˜Ÿåˆ—å­˜å‚¨â†’æ¶ˆè´¹è€…å–æ¶ˆæ¯

ä¸‰å¤§è§’è‰²ï¼š
â”œâ”€â”€ ç”Ÿäº§è€…(Producer)ï¼šå‘é€æ¶ˆæ¯çš„æœåŠ¡
â”œâ”€â”€ é˜Ÿåˆ—(Queue)ï¼šå­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨  
â””â”€â”€ æ¶ˆè´¹è€…(Consumer)ï¼šæ¥æ”¶å¤„ç†æ¶ˆæ¯çš„æœåŠ¡
```

**ğŸ“Š æ¶ˆæ¯ä¼ é€’æµç¨‹**
```
è®¢å•æœåŠ¡          æ¶ˆæ¯é˜Ÿåˆ—          åº“å­˜æœåŠ¡
(ç”Ÿäº§è€…)          (ä¸­é—´ä»¶)          (æ¶ˆè´¹è€…)
   |                 |                 |
   |--[1]å‘é€æ¶ˆæ¯---->|                 |
   |  è®¢å•åˆ›å»ºäº‹ä»¶    |                 |
   |                 |--[2]å­˜å‚¨æ¶ˆæ¯---->|
   |                 |                 |
   |                 |<--[3]æ‹‰å–æ¶ˆæ¯----|
   |                 |                 |
   |                 |                 |--[4]å¤„ç†æ¶ˆæ¯
   |                 |                 |   (æ‰£å‡åº“å­˜)
   |                 |<--[5]ç¡®è®¤å®Œæˆ----|
```

### 2.2 ä¸»æµæ¶ˆæ¯é˜Ÿåˆ—é€‰å‹


**ğŸ”§ å¸¸ç”¨MQå¯¹æ¯”**

| MQäº§å“ | **æ€§èƒ½** | **å¯é æ€§** | **ç”Ÿæ€** | **é€‚ç”¨åœºæ™¯** |
|--------|---------|-----------|---------|-------------|
| ğŸš€ **RabbitMQ** | `2ä¸‡/ç§’` | `â­â­â­â­` | `ä¸°å¯Œ` | `ä¼ä¸šçº§åº”ç”¨` |
| âš¡ **Kafka** | `100ä¸‡/ç§’` | `â­â­â­â­â­` | `å¤§æ•°æ®ç”Ÿæ€` | `æ—¥å¿—æ”¶é›†ã€æµå¤„ç†` |
| ğŸ”¥ **RocketMQ** | `10ä¸‡/ç§’` | `â­â­â­â­â­` | `é˜¿é‡Œç”Ÿæ€` | `ç”µå•†ã€é‡‘è` |
| ğŸ“¨ **ActiveMQ** | `1ä¸‡/ç§’` | `â­â­â­` | `ä¼ ç»Ÿ` | `è€é¡¹ç›®ç»´æŠ¤` |

**ğŸ¯ é€‰å‹å»ºè®®**
```
RabbitMQï¼š
âœ… è½»é‡çº§ï¼ŒåŠŸèƒ½å®Œå–„ï¼Œè·¯ç”±çµæ´»
âœ… é€‚åˆä¸­å°è§„æ¨¡ã€å¤æ‚è·¯ç”±åœºæ™¯
âŒ ååé‡ç›¸å¯¹è¾ƒä½

Kafkaï¼š
âœ… è¶…é«˜ååé‡ï¼Œåˆ†å¸ƒå¼è®¾è®¡
âœ… é€‚åˆå¤§æ•°æ®ã€æ—¥å¿—æ”¶é›†ã€äº‹ä»¶æµ
âŒ åŠŸèƒ½ç›¸å¯¹å•ä¸€ï¼Œå»¶è¿Ÿç•¥é«˜

RocketMQï¼š
âœ… é«˜æ€§èƒ½+ä¸°å¯ŒåŠŸèƒ½ï¼Œé‡‘èçº§å¯é æ€§
âœ… é€‚åˆç”µå•†ã€æ”¯ä»˜ç­‰æ ¸å¿ƒä¸šåŠ¡
âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜
```

### 2.3 æ¶ˆæ¯é˜Ÿåˆ—å®æˆ˜ç¤ºä¾‹


**ğŸ’» RabbitMQå®ç°ç¤ºä¾‹**

```java
// 1. ç”Ÿäº§è€…ï¼šè®¢å•æœåŠ¡å‘é€æ¶ˆæ¯
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å‘é€å¼‚æ­¥æ¶ˆæ¯é€šçŸ¥åº“å­˜æœåŠ¡
        OrderMessage msg = new OrderMessage(
            order.getId(), 
            order.getProductId(), 
            order.getQuantity()
        );
        rabbitTemplate.convertAndSend("order.exchange", "order.created", msg);
        
        // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…åº“å­˜å¤„ç†
        System.out.println("è®¢å•åˆ›å»ºæˆåŠŸï¼Œå¼‚æ­¥æ‰£å‡åº“å­˜");
    }
}

// 2. æ¶ˆè´¹è€…ï¼šåº“å­˜æœåŠ¡æ¥æ”¶æ¶ˆæ¯
@Component
public class InventoryConsumer {
    
    @RabbitListener(queues = "inventory.queue")
    public void handleOrderCreated(OrderMessage message) {
        try {
            // æ‰£å‡åº“å­˜
            inventoryService.deduct(
                message.getProductId(), 
                message.getQuantity()
            );
            System.out.println("åº“å­˜æ‰£å‡æˆåŠŸ");
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œå¯ä»¥é‡è¯•æˆ–è®°å½•
            log.error("åº“å­˜æ‰£å‡å¤±è´¥", e);
        }
    }
}
```

**ğŸ”‘ å…³é”®ç†è§£**
```
ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š
1. è®¢å•æœåŠ¡åˆ›å»ºè®¢å•åç«‹å³è¿”å›ï¼Œç”¨æˆ·ä½“éªŒå¥½
2. åº“å­˜æ‰£å‡äº¤ç»™å¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
3. å³ä½¿åº“å­˜æœåŠ¡æš‚æ—¶æŒ‚äº†ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±
4. é«˜å³°æœŸè®¢å•å †ç§¯åœ¨é˜Ÿåˆ—ï¼Œæ…¢æ…¢æ¶ˆåŒ–ï¼Œä¸ä¼šå´©æºƒ
```

### 2.4 æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒé…ç½®


**âš™ï¸ é˜Ÿåˆ—é…ç½®è¦ç‚¹**

```java
// RabbitMQé…ç½®ç¤ºä¾‹
@Configuration
public class RabbitMQConfig {
    
    // 1. å®šä¹‰é˜Ÿåˆ—ï¼ˆæŒä¹…åŒ–ï¼‰
    @Bean
    public Queue inventoryQueue() {
        return QueueBuilder.durable("inventory.queue")
            .ttl(3600000)  // æ¶ˆæ¯1å°æ—¶è¿‡æœŸ
            .maxLength(10000)  // é˜Ÿåˆ—æœ€å¤§é•¿åº¦
            .build();
    }
    
    // 2. å®šä¹‰äº¤æ¢æœº
    @Bean
    public TopicExchange orderExchange() {
        return new TopicExchange("order.exchange", true, false);
    }
    
    // 3. ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢æœº
    @Bean
    public Binding inventoryBinding() {
        return BindingBuilder
            .bind(inventoryQueue())
            .to(orderExchange())
            .with("order.created");  // è·¯ç”±é”®
    }
}
```

**ğŸ’¡ é…ç½®è¯´æ˜**
```
durable=trueï¼šé˜Ÿåˆ—æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±
ttlï¼šæ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼Œé¿å…è¿‡æœŸæ¶ˆæ¯å †ç§¯
maxLengthï¼šé˜Ÿåˆ—é•¿åº¦é™åˆ¶ï¼Œé˜²æ­¢æ— é™å¢é•¿
è·¯ç”±é”®ï¼šçµæ´»çš„æ¶ˆæ¯è·¯ç”±è§„åˆ™
```

---

## 3. ğŸ­ äº‹ä»¶é©±åŠ¨æ¶æ„


### 3.1 äº‹ä»¶é©±åŠ¨æ ¸å¿ƒæ€æƒ³


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨**

> **ç”Ÿæ´»ç±»æ¯”**ï¼šä½ åœ¨å•†åœºä¹°ä¸œè¥¿ï¼Œåˆ·å¡åå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
> - ğŸ’³ é“¶è¡Œæ‰£æ¬¾ï¼ˆä¸»è¦ä¸šåŠ¡ï¼‰
> - ğŸ“§ å‘é€æ¶ˆè´¹çŸ­ä¿¡ï¼ˆäº‹ä»¶1ï¼‰
> - ğŸ ç´¯ç§¯ç§¯åˆ†ï¼ˆäº‹ä»¶2ï¼‰
> - ğŸ“Š æ›´æ–°æ¶ˆè´¹ç»Ÿè®¡ï¼ˆäº‹ä»¶3ï¼‰
> 
> è¿™äº›éƒ½æ˜¯"æ”¯ä»˜æˆåŠŸ"è¿™ä¸ª**äº‹ä»¶**è§¦å‘çš„åç»­åŠ¨ä½œ

**æ ¸å¿ƒæ¦‚å¿µ**
```
äº‹ä»¶é©±åŠ¨æ¶æ„(EDA)ï¼š
- é€šè¿‡äº‹ä»¶ä¼ é€’çŠ¶æ€å˜åŒ–
- æœåŠ¡ä¸ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯å‘å¸ƒ/è®¢é˜…äº‹ä»¶
- å½»åº•è§£è€¦ï¼Œå„å¸å…¶èŒ

å…³é”®è¦ç´ ï¼š
ğŸ”¸ äº‹ä»¶ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦çŠ¶æ€å˜åŒ–
ğŸ”¸ äº‹ä»¶å‘å¸ƒè€…ï¼šäº§ç”Ÿäº‹ä»¶çš„æœåŠ¡
ğŸ”¸ äº‹ä»¶æ¶ˆè´¹è€…ï¼šç›‘å¬å¹¶å¤„ç†äº‹ä»¶çš„æœåŠ¡
ğŸ”¸ äº‹ä»¶æ€»çº¿ï¼šä¼ é€’äº‹ä»¶çš„é€šé“
```

### 3.2 äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡


**ğŸ—ï¸ æ¶æ„ç¤ºæ„å›¾**
```
è®¢å•æœåŠ¡               äº‹ä»¶æ€»çº¿                å…¶ä»–æœåŠ¡
   |                     |                      |
   |--[å‘å¸ƒäº‹ä»¶]--------->|                      |
   |  OrderCreated       |                      |
   |                     |---[åˆ†å‘äº‹ä»¶]-------->| åº“å­˜æœåŠ¡
   |                     |                      |  â†“ æ‰£å‡åº“å­˜
   |                     |                      |
   |                     |---[åˆ†å‘äº‹ä»¶]-------->| ç§¯åˆ†æœåŠ¡  
   |                     |                      |  â†“ å¢åŠ ç§¯åˆ†
   |                     |                      |
   |                     |---[åˆ†å‘äº‹ä»¶]-------->| é€šçŸ¥æœåŠ¡
   |                     |                      |  â†“ å‘é€çŸ­ä¿¡
```

**ğŸ’» ä»£ç å®ç°**

```java
// 1. å®šä¹‰äº‹ä»¶
@Data
public class OrderCreatedEvent {
    private String orderId;
    private String userId;
    private BigDecimal amount;
    private LocalDateTime createTime;
}

// 2. å‘å¸ƒäº‹ä»¶ï¼ˆè®¢å•æœåŠ¡ï¼‰
@Service
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setOrderId(order.getId());
        event.setUserId(order.getUserId());
        event.setAmount(order.getAmount());
        eventPublisher.publishEvent(event);
        
        // è®¢å•æœåŠ¡åˆ°æ­¤ç»“æŸï¼Œå…¶ä»–æœåŠ¡è‡ªå·±ç›‘å¬å¤„ç†
    }
}

// 3. ç›‘å¬äº‹ä»¶ï¼ˆåº“å­˜æœåŠ¡ï¼‰
@Component
public class InventoryEventListener {
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        System.out.println("æ”¶åˆ°è®¢å•åˆ›å»ºäº‹ä»¶ï¼š" + event.getOrderId());
        // æ‰£å‡åº“å­˜é€»è¾‘
        inventoryService.deductStock(event.getOrderId());
    }
}

// 4. ç›‘å¬äº‹ä»¶ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰
@Component  
public class PointsEventListener {
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        System.out.println("æ”¶åˆ°è®¢å•åˆ›å»ºäº‹ä»¶ï¼Œå¢åŠ ç§¯åˆ†");
        // å¢åŠ ç§¯åˆ†é€»è¾‘
        pointsService.addPoints(event.getUserId(), event.getAmount());
    }
}
```

**ğŸ”‘ å…³é”®ç†è§£**
```
äº‹ä»¶é©±åŠ¨çš„ä¼˜åŠ¿ï¼š
âœ… è®¢å•æœåŠ¡åªç®¡åˆ›å»ºè®¢å•+å‘å¸ƒäº‹ä»¶ï¼Œä¸å…³å¿ƒåç»­
âœ… æ–°å¢ä¸šåŠ¡ï¼ˆå¦‚æ¨èæœåŠ¡ï¼‰åªéœ€ç›‘å¬äº‹ä»¶ï¼Œæ— éœ€æ”¹è®¢å•æœåŠ¡
âœ… æœåŠ¡é—´å®Œå…¨è§£è€¦ï¼Œå„è‡ªç‹¬ç«‹æ¼”è¿›
âœ… æŸä¸ªæœåŠ¡æŒ‚äº†ä¸å½±å“å…¶ä»–æœåŠ¡

ä¼ ç»Ÿè°ƒç”¨ vs äº‹ä»¶é©±åŠ¨ï¼š
âŒ ä¼ ç»Ÿï¼šè®¢å•â†’è°ƒç”¨åº“å­˜â†’è°ƒç”¨ç§¯åˆ†â†’è°ƒç”¨é€šçŸ¥ï¼ˆé“¾å¼ä¾èµ–ï¼‰
âœ… äº‹ä»¶ï¼šè®¢å•å‘å¸ƒäº‹ä»¶ï¼Œå…¶ä»–æœåŠ¡è‡ªå·±ç›‘å¬ï¼ˆæ˜Ÿå‹ç‹¬ç«‹ï¼‰
```

### 3.3 äº‹ä»¶è®¾è®¡æœ€ä½³å®è·µ


**ğŸ“‹ äº‹ä»¶è®¾è®¡åŸåˆ™**

```
1ï¸âƒ£ äº‹ä»¶å‘½åè§„èŒƒ
   - ä½¿ç”¨è¿‡å»å¼ï¼šOrderCreatedã€PaymentCompleted
   - è¡¨è¾¾ä¸šåŠ¡å«ä¹‰ï¼šç”¨æˆ·æ³¨å†Œã€è®¢å•å–æ¶ˆ
   
2ï¸âƒ£ äº‹ä»¶å†…å®¹è®¾è®¡
   - åŒ…å«å…³é”®æ ‡è¯†ï¼šorderIdã€userId
   - åŒ…å«å¿…è¦ä¿¡æ¯ï¼šæ—¶é—´æˆ³ã€é‡‘é¢ç­‰
   - é¿å…æºå¸¦è¿‡å¤šæ•°æ®ï¼šä¸æ˜¯æ•°æ®åŒæ­¥
   
3ï¸âƒ£ äº‹ä»¶åˆ†ç±»
   - ä¸šåŠ¡äº‹ä»¶ï¼šOrderCreatedï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
   - ç³»ç»Ÿäº‹ä»¶ï¼šServiceStartedï¼ˆç³»ç»Ÿçº§ï¼‰
   - é›†æˆäº‹ä»¶ï¼šThirdPartyNotifiedï¼ˆå¤–éƒ¨é›†æˆï¼‰
```

**âš ï¸ å¸¸è§è¯¯åŒº**
```
âŒ æŠŠäº‹ä»¶å½“æˆRPCè°ƒç”¨
   - äº‹ä»¶æ˜¯"é€šçŸ¥"ï¼Œä¸æ˜¯"è¯·æ±‚"
   - å‘å¸ƒè€…ä¸å…³å¿ƒå¤„ç†ç»“æœ
   
âŒ äº‹ä»¶æºå¸¦å¤§é‡æ•°æ®
   - äº‹ä»¶åªæ˜¯"å‘ç”Ÿäº†ä»€ä¹ˆ"
   - è¯¦ç»†æ•°æ®è®©æ¶ˆè´¹è€…è‡ªå·±å»æŸ¥
   
âŒ æ»¥ç”¨äº‹ä»¶
   - ç®€å•åŒæ­¥æ“ä½œç”¨ç›´æ¥è°ƒç”¨
   - äº‹ä»¶é€‚åˆè§£è€¦å’Œå¼‚æ­¥åœºæ™¯
```

---

## 4. ğŸ“¡ å‘å¸ƒè®¢é˜…æ¨¡å¼


### 4.1 å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
å‘å¸ƒè®¢é˜…(Pub/Sub)ï¼š
- å‘å¸ƒè€…ï¼šå‘å¸ƒæ¶ˆæ¯åˆ°ä¸»é¢˜(Topic)
- è®¢é˜…è€…ï¼šè®¢é˜…æ„Ÿå…´è¶£çš„ä¸»é¢˜
- æ¶ˆæ¯ä»£ç†ï¼šç®¡ç†ä¸»é¢˜å’Œæ¶ˆæ¯åˆ†å‘

ç‰¹ç‚¹ï¼š
âœ… ä¸€å¯¹å¤šé€šä¿¡ï¼šä¸€æ¡æ¶ˆæ¯å¤šä¸ªæ¥æ”¶è€…
âœ… åŠ¨æ€è®¢é˜…ï¼šè®¢é˜…è€…å¯éšæ—¶åŠ å…¥é€€å‡º
âœ… è§£è€¦ï¼šå‘å¸ƒè€…ä¸çŸ¥é“è°åœ¨è®¢é˜…
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> å°±åƒå¾®ä¿¡å…¬ä¼—å·ï¼š
> - å…¬ä¼—å·å‘æ–‡ç«  = å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯
> - ä½ å…³æ³¨å…¬ä¼—å· = è®¢é˜…è€…è®¢é˜…ä¸»é¢˜
> - å¾®ä¿¡æœåŠ¡å™¨ = æ¶ˆæ¯ä»£ç†
> - ä½ å’Œå…¶ä»–ç²‰ä¸éƒ½èƒ½æ”¶åˆ° = ä¸€å¯¹å¤š

### 4.2 å‘å¸ƒè®¢é˜…vsç‚¹å¯¹ç‚¹


**ğŸ“Š ä¸¤ç§æ¨¡å¼å¯¹æ¯”**

| ç‰¹æ€§ | **å‘å¸ƒè®¢é˜…(Topic)** | **ç‚¹å¯¹ç‚¹(Queue)** |
|------|-------------------|------------------|
| ğŸ“¬ **æ¶ˆæ¯åˆ†å‘** | `ä¸€æ¡æ¶ˆæ¯â†’å¤šä¸ªæ¶ˆè´¹è€…` | `ä¸€æ¡æ¶ˆæ¯â†’ä¸€ä¸ªæ¶ˆè´¹è€…` |
| ğŸ¯ **æ¶ˆè´¹æ–¹å¼** | `æ‰€æœ‰è®¢é˜…è€…éƒ½æ”¶åˆ°` | `ç«äº‰æ¶ˆè´¹ï¼Œä¸€äººå¤„ç†` |
| ğŸ”„ **æ¶ˆæ¯ä¿ç•™** | `è®¢é˜…åæ‰èƒ½æ”¶åˆ°æ–°æ¶ˆæ¯` | `æŒä¹…åŒ–ï¼Œç­‰å¾…æ¶ˆè´¹` |
| ğŸ’¡ **é€‚ç”¨åœºæ™¯** | `å¹¿æ’­é€šçŸ¥ã€äº‹ä»¶åˆ†å‘` | `ä»»åŠ¡é˜Ÿåˆ—ã€è´Ÿè½½å‡è¡¡` |

**åœºæ™¯ç¤ºä¾‹å¯¹æ¯”**
```
ğŸ“§ å‘é€ç³»ç»Ÿé€šçŸ¥ï¼š
å‘å¸ƒè®¢é˜…ï¼šæ‰€æœ‰åœ¨çº¿ç”¨æˆ·éƒ½æ”¶åˆ° âœ…
ç‚¹å¯¹ç‚¹ï¼šåªæœ‰ä¸€ä¸ªç”¨æˆ·æ”¶åˆ° âŒ

ğŸ“¦ å¤„ç†è®¢å•ä»»åŠ¡ï¼š
å‘å¸ƒè®¢é˜…ï¼šæ‰€æœ‰æœåŠ¡éƒ½å¤„ç†ï¼Œé‡å¤äº† âŒ
ç‚¹å¯¹ç‚¹ï¼šä¸€ä¸ªæœåŠ¡å¤„ç†ï¼Œå…¶ä»–ç­‰ä¸‹ä¸€ä¸ª âœ…
```

### 4.3 å®ç°å‘å¸ƒè®¢é˜…


**ğŸ’» Rediså®ç°Pub/Sub**

```java
// 1. é…ç½®Redisç›‘å¬å™¨
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisMessageListenerContainer container(
        RedisConnectionFactory factory) {
        
        RedisMessageListenerContainer container = 
            new RedisMessageListenerContainer();
        container.setConnectionFactory(factory);
        
        // è®¢é˜…ä¸»é¢˜
        container.addMessageListener(
            orderListener(), 
            new PatternTopic("order.*")  // è®¢é˜…orderå¼€å¤´çš„ä¸»é¢˜
        );
        return container;
    }
}

// 2. å‘å¸ƒæ¶ˆæ¯
@Service
public class OrderService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    public void notifyOrderCreated(String orderId) {
        // å‘å¸ƒåˆ°order.createdä¸»é¢˜
        redisTemplate.convertAndSend(
            "order.created", 
            "è®¢å•åˆ›å»ºï¼š" + orderId
        );
    }
}

// 3. è®¢é˜…æ¶ˆæ¯
@Component
public class OrderMessageListener implements MessageListener {
    
    @Override
    public void onMessage(Message message, byte[] pattern) {
        String topic = new String(pattern);
        String content = new String(message.getBody());
        
        System.out.println("æ”¶åˆ°ä¸»é¢˜[" + topic + "]æ¶ˆæ¯ï¼š" + content);
        
        // å¤„ç†æ¶ˆæ¯
        if (topic.equals("order.created")) {
            handleOrderCreated(content);
        }
    }
}
```

**ğŸ’¡ å…³é”®ç‚¹è¯´æ˜**
```
PatternTopic("order.*")ï¼š
- æ”¯æŒé€šé…ç¬¦è®¢é˜…
- order.createdã€order.cancelledéƒ½èƒ½æ”¶åˆ°
- çµæ´»çš„ä¸»é¢˜åŒ¹é…è§„åˆ™

æ¶ˆæ¯å¹¿æ’­ï¼š
- æ‰€æœ‰è®¢é˜…order.*çš„æœåŠ¡éƒ½èƒ½æ”¶åˆ°
- é€‚åˆäº‹ä»¶é€šçŸ¥ã€çŠ¶æ€åŒæ­¥åœºæ™¯
```

### 4.4 Kafkaçš„å‘å¸ƒè®¢é˜…


**ğŸ”¥ Kafkaä¸»é¢˜è®¢é˜…**

```java
// 1. å‘å¸ƒæ¶ˆæ¯åˆ°ä¸»é¢˜
@Service
public class OrderProducer {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    public void sendOrderEvent(String orderId, String event) {
        // å‘é€åˆ°order-eventsä¸»é¢˜
        kafkaTemplate.send("order-events", orderId, event);
    }
}

// 2. æ¶ˆè´¹è€…ç»„è®¢é˜…
@Component
public class InventoryConsumer {
    
    // æ¶ˆè´¹è€…ç»„ï¼šinventory-group
    @KafkaListener(
        topics = "order-events",
        groupId = "inventory-group"
    )
    public void consume(String message) {
        System.out.println("åº“å­˜æœåŠ¡æ”¶åˆ°ï¼š" + message);
        // å¤„ç†åº“å­˜ç›¸å…³é€»è¾‘
    }
}

@Component  
public class NotificationConsumer {
    
    // æ¶ˆè´¹è€…ç»„ï¼šnotification-group
    @KafkaListener(
        topics = "order-events", 
        groupId = "notification-group"
    )
    public void consume(String message) {
        System.out.println("é€šçŸ¥æœåŠ¡æ”¶åˆ°ï¼š" + message);
        // å‘é€é€šçŸ¥é€»è¾‘
    }
}
```

**ğŸ”‘ æ¶ˆè´¹è€…ç»„æ¦‚å¿µ**
```
åŒä¸€ä¸»é¢˜ï¼Œä¸åŒæ¶ˆè´¹è€…ç»„ï¼š
â”œâ”€â”€ inventory-groupï¼ˆåº“å­˜æœåŠ¡ï¼‰
â”‚   â””â”€â”€ æ”¶åˆ°æ¶ˆæ¯ï¼šè®¢å•001åˆ›å»º
â”œâ”€â”€ notification-groupï¼ˆé€šçŸ¥æœåŠ¡ï¼‰
â”‚   â””â”€â”€ æ”¶åˆ°æ¶ˆæ¯ï¼šè®¢å•001åˆ›å»º  
â””â”€â”€ points-groupï¼ˆç§¯åˆ†æœåŠ¡ï¼‰
    â””â”€â”€ æ”¶åˆ°æ¶ˆæ¯ï¼šè®¢å•001åˆ›å»º

æ¯ä¸ªç»„éƒ½èƒ½æ”¶åˆ°å®Œæ•´æ¶ˆæ¯ï¼Œå®ç°å¹¿æ’­æ•ˆæœ
```

---

## 5. ğŸ›¡ï¸ æ¶ˆæ¯å¯é æ€§ä¿è¯


### 5.1 æ¶ˆæ¯ä¸¢å¤±é—®é¢˜åˆ†æ


**âš ï¸ æ¶ˆæ¯å¯èƒ½åœ¨å“ªé‡Œä¸¢å¤±**
```
æ¶ˆæ¯ä¼ é€’ä¸‰é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”Ÿäº§è€…  â”‚â”€[1]â†’ â”‚æ¶ˆæ¯é˜Ÿåˆ—â”‚â”€[2]â†’ â”‚æ¶ˆè´¹è€…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸¢å¤±é£é™©ç‚¹ï¼š
ğŸ”´ [1]ç”Ÿäº§é˜¶æ®µï¼šç½‘ç»œæ•…éšœï¼Œæ¶ˆæ¯æ²¡å‘å‡ºå»
ğŸ”´ [2]å­˜å‚¨é˜¶æ®µï¼šMQå®•æœºï¼Œå†…å­˜æ¶ˆæ¯ä¸¢å¤±
ğŸ”´ [3]æ¶ˆè´¹é˜¶æ®µï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆæ¯è¢«ä¸¢å¼ƒ
```

**ğŸ¯ å¯é æ€§ä¸‰æ¿æ–§**
```
1ï¸âƒ£ ç”Ÿäº§ç«¯ç¡®è®¤ï¼šç¡®ä¿æ¶ˆæ¯æˆåŠŸå‘é€
2ï¸âƒ£ æ¶ˆæ¯æŒä¹…åŒ–ï¼šç¡®ä¿æ¶ˆæ¯ä¸ä¼šå› å®•æœºä¸¢å¤±
3ï¸âƒ£ æ¶ˆè´¹ç«¯ç¡®è®¤ï¼šç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†
```

### 5.2 ç”Ÿäº§ç«¯å¯é æ€§ä¿è¯


**ğŸ’» å‘é€ç¡®è®¤æœºåˆ¶**

```java
// 1. RabbitMQå‘é€ç¡®è®¤
@Service
public class ReliableOrderProducer {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendOrderMessage(Order order) {
        // å¼€å¯å‘é€ç¡®è®¤
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š" + cause);
                // é‡è¯•æˆ–è®°å½•åˆ°DBï¼Œåç»­è¡¥å¿
                saveToRetryTable(order);
            }
        });
        
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend("order.exchange", "order.key", order);
    }
    
    // å‘é€å¤±è´¥ï¼Œä¿å­˜åˆ°é‡è¯•è¡¨
    private void saveToRetryTable(Order order) {
        RetryMessage retry = new RetryMessage();
        retry.setMessage(JSON.toJSONString(order));
        retry.setRetryCount(0);
        retryRepository.save(retry);
    }
}
```

**ğŸ”„ é‡è¯•ç­–ç•¥**
```java
// å®šæ—¶ä»»åŠ¡ï¼šæ‰«æé‡è¯•è¡¨ï¼Œé‡æ–°å‘é€
@Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œ
public void retryFailedMessages() {
    List<RetryMessage> messages = retryRepository.findPending();
    
    for (RetryMessage msg : messages) {
        if (msg.getRetryCount() < 3) {  // æœ€å¤šé‡è¯•3æ¬¡
            try {
                rabbitTemplate.convertAndSend("order.exchange", "order.key", msg.getMessage());
                retryRepository.delete(msg);  // æˆåŠŸåˆ™åˆ é™¤
            } catch (Exception e) {
                msg.setRetryCount(msg.getRetryCount() + 1);
                retryRepository.save(msg);  // å¤±è´¥åˆ™å¢åŠ é‡è¯•æ¬¡æ•°
            }
        } else {
            // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œè®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—æˆ–äººå·¥å¤„ç†
            moveToDeadLetter(msg);
        }
    }
}
```

**ğŸ’¡ å…³é”®ç†è§£**
```
ä¸ºä»€ä¹ˆè¦ç¡®è®¤æœºåˆ¶ï¼š
- ç½‘ç»œä¸å¯é ï¼Œå‘é€å¯èƒ½å¤±è´¥
- MQå¯èƒ½æ‹’ç»æ¶ˆæ¯ï¼ˆé˜Ÿåˆ—æ»¡ã€æƒé™ç­‰ï¼‰
- åŠæ—¶å‘ç°å¤±è´¥ï¼Œè¿›è¡Œè¡¥å¿

é‡è¯•æ³¨æ„äº‹é¡¹ï¼š
âœ… è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé¿å…æ— é™é‡è¯•
âœ… æŒ‡æ•°é€€é¿ï¼šé—´éš”é€’å¢ï¼ˆ1sã€2sã€4s...ï¼‰
âœ… å¹‚ç­‰æ€§ï¼šé‡å¤å‘é€ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
```

### 5.3 æ¶ˆæ¯æŒä¹…åŒ–


**ğŸ’¾ æŒä¹…åŒ–é…ç½®**

```java
// RabbitMQæŒä¹…åŒ–ä¸‰è¦ç´ 
@Configuration
public class PersistenceConfig {
    
    // 1. é˜Ÿåˆ—æŒä¹…åŒ–
    @Bean
    public Queue durableQueue() {
        return QueueBuilder
            .durable("order.queue")  // durable=true
            .build();
    }
    
    // 2. äº¤æ¢æœºæŒä¹…åŒ–
    @Bean
    public Exchange durableExchange() {
        return ExchangeBuilder
            .topicExchange("order.exchange")
            .durable(true)  // æŒä¹…åŒ–äº¤æ¢æœº
            .build();
    }
    
    // 3. æ¶ˆæ¯æŒä¹…åŒ–
    public void sendPersistentMessage(Order order) {
        MessageProperties props = new MessageProperties();
        props.setDeliveryMode(MessageDeliveryMode.PERSISTENT);  // æŒä¹…åŒ–
        
        Message message = new Message(
            JSON.toJSONString(order).getBytes(), 
            props
        );
        rabbitTemplate.send("order.exchange", "order.key", message);
    }
}
```

**ğŸ“Š æŒä¹…åŒ–æ€§èƒ½æƒè¡¡**
```
æŒä¹…åŒ–ä¼˜ç¼ºç‚¹ï¼š
âœ… ä¼˜ç‚¹ï¼šMQé‡å¯åæ¶ˆæ¯ä¸ä¸¢å¤±
âŒ ç¼ºç‚¹ï¼šæ€§èƒ½ä¸‹é™ï¼ˆç£ç›˜IOï¼‰

æ€§èƒ½å¯¹æ¯”ï¼š
éæŒä¹…åŒ–ï¼š10ä¸‡æ¡/ç§’
æŒä¹…åŒ–ï¼š  3ä¸‡æ¡/ç§’

å»ºè®®ï¼š
ğŸ”¸ æ ¸å¿ƒä¸šåŠ¡ï¼šå¿…é¡»æŒä¹…åŒ–ï¼ˆè®¢å•ã€æ”¯ä»˜ï¼‰
ğŸ”¸ éæ ¸å¿ƒä¸šåŠ¡ï¼šå¯ä»¥ä¸æŒä¹…åŒ–ï¼ˆæ—¥å¿—ã€ç›‘æ§ï¼‰
ğŸ”¸ æŠ˜ä¸­æ–¹æ¡ˆï¼šå¼‚æ­¥æ‰¹é‡åˆ·ç›˜ï¼ˆæå‡æ€§èƒ½ï¼‰
```

### 5.4 æ¶ˆè´¹ç«¯å¯é æ€§ä¿è¯


**âœ… æ‰‹åŠ¨ç¡®è®¤æœºåˆ¶**

```java
@Component
public class ReliableConsumer {
    
    @RabbitListener(
        queues = "order.queue",
        ackMode = "MANUAL"  // æ‰‹åŠ¨ç¡®è®¤
    )
    public void handleMessage(
        @Payload String message,
        Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) long tag
    ) {
        try {
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            Order order = JSON.parseObject(message, Order.class);
            orderService.process(order);
            
            // ä¸šåŠ¡æˆåŠŸï¼Œæ‰‹åŠ¨ç¡®è®¤
            channel.basicAck(tag, false);
            System.out.println("æ¶ˆæ¯å¤„ç†æˆåŠŸ");
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ï¼ˆä¸é‡æ–°å…¥é˜Ÿï¼‰
            channel.basicReject(tag, false);
            System.err.println("ä¸šåŠ¡å¼‚å¸¸ï¼Œæ¶ˆæ¯ä¸¢å¼ƒ");
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ï¼ˆé‡æ–°å…¥é˜Ÿï¼‰
            channel.basicNack(tag, false, true);
            System.err.println("ç³»ç»Ÿå¼‚å¸¸ï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ");
        }
    }
}
```

**ğŸ”‘ ç¡®è®¤æ¨¡å¼è¯¦è§£**
```
ä¸‰ç§ç¡®è®¤æ–¹å¼ï¼š
1. basicAck(tag, false)
   - ç¡®è®¤æ¶ˆæ¯ï¼Œä»é˜Ÿåˆ—åˆ é™¤
   - falseè¡¨ç¤ºåªç¡®è®¤å½“å‰æ¶ˆæ¯

2. basicReject(tag, false)  
   - æ‹’ç»æ¶ˆæ¯ï¼Œfalseè¡¨ç¤ºä¸é‡æ–°å…¥é˜Ÿ
   - ç”¨äºä¸šåŠ¡å¼‚å¸¸ï¼Œæ¶ˆæ¯æœ‰é—®é¢˜

3. basicNack(tag, false, true)
   - æ‹’ç»æ¶ˆæ¯ï¼Œtrueè¡¨ç¤ºé‡æ–°å…¥é˜Ÿ
   - ç”¨äºç³»ç»Ÿå¼‚å¸¸ï¼Œæ¶ˆæ¯æœ¬èº«æ²¡é—®é¢˜

è‡ªåŠ¨ç¡®è®¤çš„é—®é¢˜ï¼š
âŒ æ¶ˆæ¯ä¸€å–å‡ºå°±ç¡®è®¤ï¼Œå¤„ç†å¤±è´¥ä¹Ÿä¸¢å¤±
âŒ æ— æ³•åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
âœ… æ‰‹åŠ¨ç¡®è®¤æ›´çµæ´»å¯æ§
```

---

## 6. âš™ï¸ å¼‚æ­¥å¤„ç†ç­–ç•¥


### 6.1 å¼‚æ­¥ä»»åŠ¡å¤„ç†æ¨¡å¼


**ğŸ“‹ å¸¸è§å¼‚æ­¥å¤„ç†æ–¹å¼**
```
1ï¸âƒ£ çº¿ç¨‹æ± å¼‚æ­¥
   - é€‚ç”¨ï¼šå•åº”ç”¨å†…çš„ç®€å•å¼‚æ­¥
   - ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œå“åº”å¿«
   - ç¼ºç‚¹ï¼šä»»åŠ¡ä¸¢å¤±é£é™©ï¼Œæ— æ³•è·¨æœåŠ¡

2ï¸âƒ£ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥
   - é€‚ç”¨ï¼šè·¨æœåŠ¡ã€é«˜å¯é åœºæ™¯
   - ä¼˜ç‚¹ï¼šè§£è€¦ã€å¯é ã€å‰Šå³°
   - ç¼ºç‚¹ï¼šå¤æ‚åº¦é«˜ï¼Œå»¶è¿Ÿç•¥é«˜

3ï¸âƒ£ ä»»åŠ¡è°ƒåº¦å¼‚æ­¥
   - é€‚ç”¨ï¼šå®šæ—¶ã€æ‰¹é‡ä»»åŠ¡
   - ä¼˜ç‚¹ï¼šç»Ÿä¸€ç®¡ç†ï¼Œå¯è§†åŒ–
   - ç¼ºç‚¹ï¼šå®æ—¶æ€§å·®
```

### 6.2 Springå¼‚æ­¥å¤„ç†


**ğŸ’» @Asyncæ³¨è§£ä½¿ç”¨**

```java
// 1. å¯ç”¨å¼‚æ­¥
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean("taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("async-");
        executor.initialize();
        return executor;
    }
}

// 2. å¼‚æ­¥æ–¹æ³•
@Service
public class NotificationService {
    
    @Async("taskExecutor")
    public void sendEmail(String to, String content) {
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        Thread.sleep(2000);
        System.out.println("é‚®ä»¶å·²å‘é€ç»™ï¼š" + to);
    }
    
    @Async
    public CompletableFuture<String> sendSmsAsync(String phone) {
        // å¼‚æ­¥å‘é€çŸ­ä¿¡
        Thread.sleep(1000);
        String result = "çŸ­ä¿¡å·²å‘é€ç»™ï¼š" + phone;
        return CompletableFuture.completedFuture(result);
    }
}

// 3. è°ƒç”¨å¼‚æ­¥æ–¹æ³•
@Service
public class OrderService {
    
    @Autowired
    private NotificationService notificationService;
    
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å¼‚æ­¥å‘é€é€šçŸ¥ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
        notificationService.sendEmail(
            order.getUserEmail(), 
            "è®¢å•åˆ›å»ºæˆåŠŸ"
        );
        
        // ç«‹å³è¿”å›ï¼Œé‚®ä»¶åœ¨åå°å‘é€
        System.out.println("è®¢å•åˆ›å»ºå®Œæˆ");
    }
}
```

**âš ï¸ @Asyncæ³¨æ„äº‹é¡¹**
```
å¸¸è§å‘ç‚¹ï¼š
1. åŒç±»è°ƒç”¨æ— æ•ˆ
   âŒ this.sendEmail()  // ä¸ä¼šå¼‚æ­¥
   âœ… æ³¨å…¥beanè°ƒç”¨      // æ‰ä¼šå¼‚æ­¥

2. è¿”å›å€¼å¤„ç†
   âŒ voidï¼šæ— æ³•çŸ¥é“æ‰§è¡Œç»“æœ
   âœ… Future/CompletableFutureï¼šå¯è·å–ç»“æœ

3. å¼‚å¸¸å¤„ç†
   - å¼‚æ­¥æ–¹æ³•æŠ›å¼‚å¸¸ï¼Œä¸»çº¿ç¨‹æ— æ³•æ•è·
   - éœ€è¦é…ç½®AsyncUncaughtExceptionHandler
```

### 6.3 CompletableFutureé«˜çº§ç”¨æ³•


**ğŸš€ å¼‚æ­¥ç¼–æ’ç¤ºä¾‹**

```java
@Service
public class OrderService {
    
    public void processOrder(String orderId) {
        // ä¸‰ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼šæŸ¥è¯¢è®¢å•ã€æŸ¥åº“å­˜ã€æŸ¥ç”¨æˆ·
        CompletableFuture<Order> orderFuture = 
            CompletableFuture.supplyAsync(() -> queryOrder(orderId));
            
        CompletableFuture<Stock> stockFuture = 
            CompletableFuture.supplyAsync(() -> queryStock(orderId));
            
        CompletableFuture<User> userFuture = 
            CompletableFuture.supplyAsync(() -> queryUser(orderId));
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œç„¶åç»„åˆç»“æœ
        CompletableFuture.allOf(orderFuture, stockFuture, userFuture)
            .thenAccept(v -> {
                Order order = orderFuture.join();
                Stock stock = stockFuture.join();
                User user = userFuture.join();
                
                // ç»„åˆç»“æœï¼Œè¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†
                processResult(order, stock, user);
            });
    }
}
```

**ğŸ“Š å¼‚æ­¥ç¼–æ’åœºæ™¯**
```
ä¸²è¡Œ vs å¹¶è¡Œï¼š
âŒ ä¸²è¡Œæ‰§è¡Œï¼š3ç§’ + 2ç§’ + 1ç§’ = 6ç§’
âœ… å¹¶è¡Œæ‰§è¡Œï¼šmax(3ç§’, 2ç§’, 1ç§’) = 3ç§’

CompletableFutureèƒ½åŠ›ï¼š
- supplyAsyncï¼šå¼‚æ­¥æ‰§è¡Œæœ‰è¿”å›å€¼ä»»åŠ¡
- thenApplyï¼šä»»åŠ¡å®Œæˆåè½¬æ¢ç»“æœ
- thenCombineï¼šç»„åˆä¸¤ä¸ªä»»åŠ¡ç»“æœ
- allOfï¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
- anyOfï¼šç­‰å¾…ä»»æ„ä¸€ä¸ªä»»åŠ¡å®Œæˆ
```

### 6.4 å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ


**âœ… å®è·µå»ºè®®**
```
1ï¸âƒ£ åˆç†ä½¿ç”¨å¼‚æ­¥
   âœ… è€—æ—¶æ“ä½œï¼šå‘é‚®ä»¶ã€è°ƒå¤–éƒ¨API
   âœ… å¯å»¶è¿Ÿä»»åŠ¡ï¼šç”ŸæˆæŠ¥è¡¨ã€æ•°æ®ç»Ÿè®¡
   âŒ å…³é”®ä¸šåŠ¡ï¼šæ”¯ä»˜ã€æ‰£æ¬¾ç­‰

2ï¸âƒ£ å¼‚å¸¸å¤„ç†
   - è®°å½•æ—¥å¿—ï¼šä¾¿äºæ’æŸ¥é—®é¢˜
   - é‡è¯•æœºåˆ¶ï¼šä¸´æ—¶æ•…éšœå¯é‡è¯•
   - é™çº§æ–¹æ¡ˆï¼šå¤±è´¥åçš„å¤‡é€‰å¤„ç†

3ï¸âƒ£ çº¿ç¨‹æ± é…ç½®
   - æ ¸å¿ƒçº¿ç¨‹ï¼šå¸¸é©»çº¿ç¨‹æ•°
   - æœ€å¤§çº¿ç¨‹ï¼šå³°å€¼æ—¶çš„çº¿ç¨‹æ•°
   - é˜Ÿåˆ—å¤§å°ï¼šç¼“å†²ä»»åŠ¡æ•°é‡
   - æ‹’ç»ç­–ç•¥ï¼šé˜Ÿåˆ—æ»¡æ—¶çš„å¤„ç†æ–¹å¼

4ï¸âƒ£ ç›‘æ§å‘Šè­¦
   - ä»»åŠ¡æˆåŠŸç‡
   - å¹³å‡æ‰§è¡Œæ—¶é—´
   - é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
```

---

## 7. ğŸ”„ å›è°ƒæœºåˆ¶è®¾è®¡


### 7.1 å›è°ƒçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å›è°ƒ**
> **ç”Ÿæ´»ç±»æ¯”**ï¼šä½ åœ¨é¤å…ç‚¹é¤
> - ä¼ ç»Ÿæ–¹å¼ï¼šç«™ç€ç­‰ï¼Œèœå¥½äº†æ‹¿èµ°ï¼ˆåŒæ­¥ï¼‰
> - å›è°ƒæ–¹å¼ï¼šç•™ä¸ªå·ç ç‰Œï¼Œèœå¥½äº†å«ä½ ï¼ˆå›è°ƒï¼‰

**æ ¸å¿ƒå®šä¹‰**
```
å›è°ƒæœºåˆ¶ï¼š
- è°ƒç”¨æ–¹å‘èµ·è¯·æ±‚æ—¶ï¼Œå‘Šè¯‰å¯¹æ–¹"å¤„ç†å®Œäº†é€šçŸ¥æˆ‘"
- å¯¹æ–¹å¤„ç†å®Œåï¼Œä¸»åŠ¨é€šçŸ¥è°ƒç”¨æ–¹
- å®ç°çœŸæ­£çš„å¼‚æ­¥è§£è€¦

å›è°ƒä¸‰è¦ç´ ï¼š
1. å›è°ƒåœ°å€ï¼šå¯¹æ–¹é€šçŸ¥æˆ‘çš„URL
2. ä¸šåŠ¡æ•°æ®ï¼šè¯·æ±‚çš„å”¯ä¸€æ ‡è¯†
3. å›è°ƒé€»è¾‘ï¼šæ”¶åˆ°é€šçŸ¥åçš„å¤„ç†
```

### 7.2 HTTPå›è°ƒå®ç°


**ğŸ’» æ”¯ä»˜å›è°ƒç¤ºä¾‹**

```java
// 1. å‘èµ·æ”¯ä»˜ï¼Œæä¾›å›è°ƒåœ°å€
@Service
public class PaymentService {
    
    public void createPayment(Order order) {
        PaymentRequest request = new PaymentRequest();
        request.setOrderId(order.getId());
        request.setAmount(order.getAmount());
        request.setCallbackUrl("https://myapp.com/api/payment/callback");
        
        // è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
        paymentClient.pay(request);
        
        // ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…æ”¯ä»˜ç»“æœ
        System.out.println("æ”¯ä»˜è¯·æ±‚å·²æäº¤");
    }
}

// 2. æ¥æ”¶å›è°ƒé€šçŸ¥
@RestController
@RequestMapping("/api/payment")
public class PaymentCallbackController {
    
    @PostMapping("/callback")
    public String handleCallback(@RequestBody PaymentCallback callback) {
        String orderId = callback.getOrderId();
        String status = callback.getStatus();
        
        // éªŒè¯ç­¾åï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
        if (!verifySign(callback)) {
            return "FAIL";
        }
        
        // å¤„ç†æ”¯ä»˜ç»“æœ
        if ("SUCCESS".equals(status)) {
            orderService.updateStatus(orderId, OrderStatus.PAID);
            System.out.println("è®¢å•æ”¯ä»˜æˆåŠŸï¼š" + orderId);
        } else {
            orderService.updateStatus(orderId, OrderStatus.FAILED);
            System.out.println("è®¢å•æ”¯ä»˜å¤±è´¥ï¼š" + orderId);
        }
        
        // è¿”å›æˆåŠŸï¼Œå‘Šè¯‰å¯¹æ–¹åˆ«å†é€šçŸ¥äº†
        return "SUCCESS";
    }
}
```

**ğŸ”‘ å›è°ƒå…³é”®ç‚¹**
```
1. å¹‚ç­‰æ€§è®¾è®¡
   - åŒä¸€é€šçŸ¥å¯èƒ½é‡å¤å‘é€
   - éœ€è¦æ ¹æ®orderIdå»é‡ï¼Œé¿å…é‡å¤å¤„ç†

2. ç­¾åéªŒè¯
   - é˜²æ­¢æ¶æ„ä¼ªé€ å›è°ƒ
   - ä½¿ç”¨å¯†é’¥å¯¹æ•°æ®ç­¾åæ ¡éªŒ

3. å“åº”è§„èŒƒ
   - æ˜ç¡®å‘Šè¯‰å¯¹æ–¹æ˜¯å¦æˆåŠŸ
   - "SUCCESS"åœæ­¢é€šçŸ¥ï¼Œ"FAIL"ç»§ç»­é‡è¯•

4. è¶…æ—¶å¤„ç†
   - å¯¹æ–¹å¯èƒ½æ°¸è¿œä¸å›è°ƒ
   - è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¸»åŠ¨æŸ¥è¯¢ç»“æœ
```

### 7.3 æ¶ˆæ¯é˜Ÿåˆ—å›è°ƒ


**ğŸ“¬ MQå®ç°å›è°ƒé€šçŸ¥**

```java
// 1. è®¢å•æœåŠ¡ï¼šå‘é€æ¶ˆæ¯+ç­‰å¾…å›è°ƒ
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å‘é€æ¶ˆæ¯åˆ°åº“å­˜æœåŠ¡
        StockRequest request = new StockRequest();
        request.setOrderId(order.getId());
        request.setProductId(order.getProductId());
        request.setQuantity(order.getQuantity());
        
        rabbitTemplate.convertAndSend("stock.request", request);
        System.out.println("åº“å­˜æ‰£å‡è¯·æ±‚å·²å‘é€");
    }
}

// 2. åº“å­˜æœåŠ¡ï¼šå¤„ç†è¯·æ±‚+å‘é€å›è°ƒ
@Component
public class StockConsumer {
    
    @RabbitListener(queues = "stock.request")
    public void handleStockRequest(StockRequest request) {
        try {
            // æ‰£å‡åº“å­˜
            stockService.deduct(request.getProductId(), request.getQuantity());
            
            // å‘é€æˆåŠŸå›è°ƒ
            StockCallback callback = new StockCallback();
            callback.setOrderId(request.getOrderId());
            callback.setStatus("SUCCESS");
            rabbitTemplate.convertAndSend("stock.callback", callback);
            
        } catch (Exception e) {
            // å‘é€å¤±è´¥å›è°ƒ
            StockCallback callback = new StockCallback();
            callback.setOrderId(request.getOrderId());
            callback.setStatus("FAILED");
            callback.setReason(e.getMessage());
            rabbitTemplate.convertAndSend("stock.callback", callback);
        }
    }
}

// 3. è®¢å•æœåŠ¡ï¼šæ¥æ”¶å›è°ƒ
@Component
public class OrderCallbackConsumer {
    
    @RabbitListener(queues = "stock.callback")
    public void handleCallback(StockCallback callback) {
        String orderId = callback.getOrderId();
        
        if ("SUCCESS".equals(callback.getStatus())) {
            orderService.updateStatus(orderId, OrderStatus.STOCK_DEDUCTED);
            System.out.println("åº“å­˜æ‰£å‡æˆåŠŸï¼Œè®¢å•ç»§ç»­");
        } else {
            orderService.updateStatus(orderId, OrderStatus.STOCK_FAILED);
            System.out.println("åº“å­˜æ‰£å‡å¤±è´¥ï¼Œè®¢å•å–æ¶ˆ");
        }
    }
}
```

**ğŸ’¡ MQå›è°ƒä¼˜åŠ¿**
```
å¯¹æ¯”HTTPå›è°ƒï¼š
âœ… å¯é æ€§é«˜ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¸æ€•ä¸¢å¤±
âœ… è§£è€¦æ›´å¥½ï¼šä¸éœ€è¦æš´éœ²HTTPæ¥å£
âœ… é¡ºåºä¿è¯ï¼šå¯ä»¥ä¿è¯æ¶ˆæ¯é¡ºåº
âŒ å®æ—¶æ€§ç•¥å·®ï¼šæœ‰ä¸€å®šå»¶è¿Ÿ

é€‚ç”¨åœºæ™¯ï¼š
- å†…éƒ¨æœåŠ¡é—´å›è°ƒï¼šç”¨MQ
- å¤–éƒ¨ç³»ç»Ÿå›è°ƒï¼šç”¨HTTP
```

### 7.4 å›è°ƒè¶…æ—¶å¤„ç†


**â° è¶…æ—¶æœºåˆ¶è®¾è®¡**

```java
// 1. å‘èµ·è¯·æ±‚æ—¶è®¾ç½®è¶…æ—¶æ—¶é—´
@Service
public class OrderService {
    
    public void createOrder(Order order) {
        // ä¿å­˜è®¢å•ï¼ŒçŠ¶æ€ä¸ºå¾…ç¡®è®¤
        order.setStatus(OrderStatus.PENDING);
        order.setCreateTime(LocalDateTime.now());
        orderRepository.save(order);
        
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend("stock.request", order);
        
        // è®¾ç½®å»¶è¿Ÿæ¶ˆæ¯ï¼Œ30ç§’åæ£€æŸ¥
        DelayedMessage delayed = new DelayedMessage();
        delayed.setOrderId(order.getId());
        delayed.setDelay(30000);  // 30ç§’
        rabbitTemplate.convertAndSend("order.check", delayed);
    }
}

// 2. å®šæ—¶æ£€æŸ¥è®¢å•çŠ¶æ€
@Component
public class OrderTimeoutChecker {
    
    @RabbitListener(queues = "order.check")
    public void checkTimeout(DelayedMessage message) {
        Order order = orderRepository.findById(message.getOrderId());
        
        // 30ç§’åè¿˜æ˜¯PENDINGçŠ¶æ€ï¼Œè¯´æ˜æ²¡æ”¶åˆ°å›è°ƒ
        if (order.getStatus() == OrderStatus.PENDING) {
            // ä¸»åŠ¨æŸ¥è¯¢åº“å­˜æœåŠ¡ç»“æœ
            StockResult result = stockClient.queryResult(order.getId());
            
            if (result.isSuccess()) {
                order.setStatus(OrderStatus.STOCK_DEDUCTED);
            } else {
                order.setStatus(OrderStatus.STOCK_FAILED);
            }
            orderRepository.save(order);
        }
    }
}
```

**ğŸ”‘ è¶…æ—¶å¤„ç†ç­–ç•¥**
```
ä¸‰ç§è¶…æ—¶å¤„ç†æ–¹å¼ï¼š

1. ä¸»åŠ¨æŸ¥è¯¢
   - è¶…æ—¶åä¸»åŠ¨æŸ¥ç»“æœ
   - é€‚åˆå¯¹æ–¹æä¾›æŸ¥è¯¢æ¥å£

2. å–æ¶ˆæ“ä½œ
   - è¶…æ—¶ç›´æ¥è®¤ä¸ºå¤±è´¥
   - é€‚åˆå…è®¸å¤±è´¥çš„åœºæ™¯

3. äººå·¥ä»‹å…¥
   - è¶…æ—¶è½¬äººå·¥å¤„ç†
   - é€‚åˆé‡‘é¢å¤§ã€é‡è¦è®¢å•
```

---

## 8. ğŸ” çŠ¶æ€ä¸€è‡´æ€§å¤„ç†


### 8.1 åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜


**âš ï¸ ä¸€è‡´æ€§é—®é¢˜äº§ç”Ÿ**
```
ç»å…¸åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•
1. åˆ›å»ºè®¢å•     âœ…
2. æ‰£å‡åº“å­˜     âœ…
3. æ‰£å‡ä½™é¢     âŒ å¤±è´¥äº†

é—®é¢˜ï¼š
- è®¢å•åˆ›å»ºäº†ï¼Œä½™é¢æ²¡æ‰£
- åº“å­˜æ‰£äº†ï¼Œä½†è®¢å•åº”è¯¥å–æ¶ˆ
- æ•°æ®ä¸ä¸€è‡´äº†ï¼
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼š
> - ä¸‹å•æˆåŠŸï¼ˆè®¢å•æœåŠ¡ï¼‰
> - æ‰£æ¬¾å¤±è´¥ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰
> - å•†å“å´å‘è´§äº†ï¼ˆç‰©æµæœåŠ¡ï¼‰
> 
> è¿™å°±æ˜¯åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼

### 8.2 æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆ


**ğŸ’¾ æœ€å¸¸ç”¨çš„å¯é æ–¹æ¡ˆ**

```java
// 1. è®¢å•æœåŠ¡ï¼šæœ¬åœ°äº‹åŠ¡ä¿è¯
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 2. ä¿å­˜æœ¬åœ°æ¶ˆæ¯è¡¨ï¼ˆåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼‰
        LocalMessage message = new LocalMessage();
        message.setType("STOCK_DEDUCT");
        message.setContent(JSON.toJSONString(order));
        message.setStatus(MessageStatus.PENDING);
        messageRepository.save(message);
        
        // äº‹åŠ¡æäº¤ï¼Œè®¢å•å’Œæ¶ˆæ¯ä¸€èµ·æˆåŠŸ
    }
}

// 2. å®šæ—¶ä»»åŠ¡ï¼šæ‰«æå¹¶å‘é€æ¶ˆæ¯
@Component
public class MessageSender {
    
    @Scheduled(fixedDelay = 5000)  // æ¯5ç§’æ‰§è¡Œ
    public void sendPendingMessages() {
        List<LocalMessage> messages = 
            messageRepository.findByStatus(MessageStatus.PENDING);
        
        for (LocalMessage msg : messages) {
            try {
                // å‘é€åˆ°MQ
                rabbitTemplate.convertAndSend("stock.request", msg.getContent());
                
                // æ›´æ–°çŠ¶æ€ä¸ºå·²å‘é€
                msg.setStatus(MessageStatus.SENT);
                messageRepository.save(msg);
                
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œä¸‹æ¬¡ç»§ç»­å°è¯•
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥", e);
            }
        }
    }
}

// 3. æ¥æ”¶å›è°ƒï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€
@Component
public class OrderCallbackConsumer {
    
    @RabbitListener(queues = "stock.callback")
    public void handleCallback(StockCallback callback) {
        // æ›´æ–°æœ¬åœ°æ¶ˆæ¯è¡¨
        LocalMessage message = messageRepository
            .findByOrderId(callback.getOrderId());
        message.setStatus(MessageStatus.CONSUMED);
        messageRepository.save(message);
    }
}
```

**ğŸ“Š æœ¬åœ°æ¶ˆæ¯è¡¨æµç¨‹**
```
è®¢å•æœåŠ¡                æ¶ˆæ¯è¡¨                åº“å­˜æœåŠ¡
   |                      |                      |
   |--[1]ä¿å­˜è®¢å•-------->|                      |
   |--[2]ä¿å­˜æ¶ˆæ¯-------->|                      |
   |    (åŒä¸€äº‹åŠ¡)        |                      |
   |                      |                      |
   |                      |--[3]å®šæ—¶æ‰«æ-------->|
   |                      |   å‘é€MQ             |
   |                      |                      |
   |                      |<--[4]å¤„ç†å®Œæˆå›è°ƒ----|
   |                      |                      |
   |--[5]æ›´æ–°æ¶ˆæ¯çŠ¶æ€---->|                      |
```

**ğŸ’¡ æ–¹æ¡ˆä¼˜åŠ¿**
```
âœ… åˆ©ç”¨æœ¬åœ°äº‹åŠ¡ä¿è¯ï¼šè®¢å•å’Œæ¶ˆæ¯è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
âœ… æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼šæŒä¹…åŒ–åœ¨æœ¬åœ°æ•°æ®åº“
âœ… æœ€ç»ˆä¸€è‡´æ€§ï¼šå®šæ—¶é‡è¯•ç¡®ä¿æ¶ˆæ¯æœ€ç»ˆå‘é€æˆåŠŸ
âœ… å®ç°ç®€å•ï¼šä¸éœ€è¦é¢å¤–ç»„ä»¶

é€‚ç”¨åœºæ™¯ï¼š
- å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„æ ¸å¿ƒä¸šåŠ¡
- è®¢å•ã€æ”¯ä»˜ç­‰å…³é”®æµç¨‹
```

### 8.3 TCCäº‹åŠ¡æ¨¡å¼


**ğŸ”„ ä¸¤é˜¶æ®µè¡¥å¿æ–¹æ¡ˆ**

```
TCCä¸‰ä¸ªé˜¶æ®µï¼š
1. Tryï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
2. Confirmï¼šç¡®è®¤æ‰§è¡Œï¼ŒçœŸæ­£æ‰£å‡
3. Cancelï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº
```

**ğŸ’» TCCå®ç°ç¤ºä¾‹**

```java
// 1. è®¢å•æœåŠ¡ï¼šä¸»äº‹åŠ¡åè°ƒè€…
@Service
public class OrderService {
    
    @GlobalTransactional  // TCCå…¨å±€äº‹åŠ¡
    public void createOrder(Order order) {
        // 1. Tryé˜¶æ®µï¼šå†»ç»“åº“å­˜
        stockService.tryDeduct(order.getProductId(), order.getQuantity());
        
        // 2. Tryé˜¶æ®µï¼šå†»ç»“ä½™é¢
        accountService.tryDeduct(order.getUserId(), order.getAmount());
        
        // 3. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // å¦‚æœå…¨éƒ¨æˆåŠŸï¼Œè‡ªåŠ¨Confirm
        // å¦‚æœä»»ä½•å¤±è´¥ï¼Œè‡ªåŠ¨Cancel
    }
}

// 2. åº“å­˜æœåŠ¡ï¼šå®ç°Try-Confirm-Cancel
@Service
public class StockService {
    
    // Tryï¼šå†»ç»“åº“å­˜
    @TwoPhaseBusinessAction(
        name = "stockDeduct",
        commitMethod = "confirmDeduct",
        rollbackMethod = "cancelDeduct"
    )
    public void tryDeduct(String productId, int quantity) {
        Stock stock = stockRepository.findByProductId(productId);
        
        // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        if (stock.getAvailable() < quantity) {
            throw new InsufficientStockException();
        }
        
        // å†»ç»“åº“å­˜ï¼ˆå¯ç”¨åº“å­˜-quantityï¼Œå†»ç»“åº“å­˜+quantityï¼‰
        stock.setAvailable(stock.getAvailable() - quantity);
        stock.setFrozen(stock.getFrozen() + quantity);
        stockRepository.save(stock);
    }
    
    // Confirmï¼šçœŸæ­£æ‰£å‡
    public void confirmDeduct(String productId, int quantity) {
        Stock stock = stockRepository.findByProductId(productId);
        // æ‰£å‡å†»ç»“åº“å­˜ï¼ˆå†»ç»“åº“å­˜-quantityï¼Œæ€»åº“å­˜-quantityï¼‰
        stock.setFrozen(stock.getFrozen() - quantity);
        stock.setTotal(stock.getTotal() - quantity);
        stockRepository.save(stock);
    }
    
    // Cancelï¼šæ¢å¤åº“å­˜
    public void cancelDeduct(String productId, int quantity) {
        Stock stock = stockRepository.findByProductId(productId);
        // é‡Šæ”¾å†»ç»“åº“å­˜ï¼ˆå†»ç»“åº“å­˜-quantityï¼Œå¯ç”¨åº“å­˜+quantityï¼‰
        stock.setFrozen(stock.getFrozen() - quantity);
        stock.setAvailable(stock.getAvailable() + quantity);
        stockRepository.save(stock);
    }
}
```

**ğŸ”‘ TCCæ ¸å¿ƒç†è§£**
```
åº“å­˜å˜åŒ–è¿‡ç¨‹ï¼š
åˆå§‹ï¼šæ€»åº“å­˜100ï¼Œå¯ç”¨100ï¼Œå†»ç»“0

Tryé˜¶æ®µï¼ˆå†»ç»“10ä¸ªï¼‰ï¼š
- æ€»åº“å­˜ï¼š100
- å¯ç”¨ï¼š90  ï¼ˆ100-10ï¼‰
- å†»ç»“ï¼š10  ï¼ˆ0+10ï¼‰

Confirmé˜¶æ®µï¼ˆç¡®è®¤æ‰£å‡ï¼‰ï¼š
- æ€»åº“å­˜ï¼š90  ï¼ˆ100-10ï¼‰
- å¯ç”¨ï¼š90
- å†»ç»“ï¼š0   ï¼ˆ10-10ï¼‰

Cancelé˜¶æ®µï¼ˆå–æ¶ˆï¼Œæ¢å¤ï¼‰ï¼š
- æ€»åº“å­˜ï¼š100
- å¯ç”¨ï¼š100  ï¼ˆ90+10ï¼‰
- å†»ç»“ï¼š0   ï¼ˆ10-10ï¼‰
```

**âš ï¸ TCCæ³¨æ„äº‹é¡¹**
```
ä¼˜ç‚¹ï¼š
âœ… å¼ºä¸€è‡´æ€§ï¼šå®æ—¶ä¿è¯å„æœåŠ¡çŠ¶æ€ä¸€è‡´
âœ… æ€§èƒ½å¥½ï¼šä¸é•¿æ—¶é—´å ç”¨èµ„æº

ç¼ºç‚¹ï¼š
âŒ å®ç°å¤æ‚ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¦å®ç°ä¸‰ä¸ªæ–¹æ³•
âŒ ä¾µå…¥æ€§å¼ºï¼šä¸šåŠ¡ä»£ç è¦æ”¹é€ 
âŒ èµ„æºé”å®šï¼šTryé˜¶æ®µä¼šé”å®šèµ„æº

é€‚ç”¨åœºæ™¯ï¼š
- å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜ï¼ˆæ”¯ä»˜ã€äº¤æ˜“ï¼‰
- å®æ—¶æ€§è¦æ±‚é«˜ï¼ˆç§’æ€ã€æŠ¢è´­ï¼‰
```

### 8.4 SAGAäº‹åŠ¡æ¨¡å¼


**ğŸ¯ é•¿äº‹åŠ¡è¡¥å¿æ–¹æ¡ˆ**

```
SAGAæ€æƒ³ï¼š
- å°†é•¿äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªæœ¬åœ°äº‹åŠ¡
- é¡ºåºæ‰§è¡Œï¼ŒæˆåŠŸç»§ç»­ï¼Œå¤±è´¥å›æ»š
- æ¯ä¸ªäº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
```

**æµç¨‹ç¤ºæ„**
```
æ­£å‘æµç¨‹ï¼ˆæˆåŠŸï¼‰ï¼š
è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç§¯åˆ†æœåŠ¡
  T1        T2        T3        T4
  âœ…        âœ…        âœ…        âœ…

å¤±è´¥å›æ»šï¼ˆæ”¯ä»˜å¤±è´¥ï¼‰ï¼š
è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç§¯åˆ†æœåŠ¡
  T1        T2        T3        T4
  âœ…        âœ…        âŒ        
  C1 â†      C2 â†      
ï¼ˆå–æ¶ˆè®¢å•ï¼‰ï¼ˆæ¢å¤åº“å­˜ï¼‰
```

**ğŸ’» SAGAå®ç°ç¤ºä¾‹**

```java
// 1. ç¼–æ’å‹SAGA
@Service
public class OrderSaga {
    
    public void executeOrder(Order order) {
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            orderService.create(order);
            
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            stockService.deduct(order);
            
            // æ­¥éª¤3ï¼šæ‰£å‡ä½™é¢
            accountService.deduct(order);
            
            // æ­¥éª¤4ï¼šå¢åŠ ç§¯åˆ†
            pointsService.add(order);
            
            System.out.println("è®¢å•å¤„ç†æˆåŠŸ");
            
        } catch (StockException e) {
            // åº“å­˜ä¸è¶³ï¼Œå–æ¶ˆè®¢å•
            orderService.cancel(order);
            
        } catch (AccountException e) {
            // ä½™é¢ä¸è¶³ï¼Œæ¢å¤åº“å­˜+å–æ¶ˆè®¢å•
            stockService.restore(order);
            orderService.cancel(order);
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸ï¼Œå›æ»šæ‰€æœ‰æ“ä½œ
            pointsService.deduct(order);
            accountService.restore(order);
            stockService.restore(order);
            orderService.cancel(order);
        }
    }
}

// 2. è¡¥å¿æ“ä½œç¤ºä¾‹
@Service
public class StockService {
    
    // æ­£å‘æ“ä½œï¼šæ‰£å‡åº“å­˜
    public void deduct(Order order) {
        Stock stock = stockRepository.findByProductId(order.getProductId());
        stock.setQuantity(stock.getQuantity() - order.getQuantity());
        stockRepository.save(stock);
    }
    
    // è¡¥å¿æ“ä½œï¼šæ¢å¤åº“å­˜
    public void restore(Order order) {
        Stock stock = stockRepository.findByProductId(order.getProductId());
        stock.setQuantity(stock.getQuantity() + order.getQuantity());
        stockRepository.save(stock);
    }
}
```

**ğŸ“Š SAGA vs TCCå¯¹æ¯”**

| ç‰¹æ€§ | **SAGA** | **TCC** |
|------|---------|---------|
| ğŸ¯ **ä¸€è‡´æ€§** | `æœ€ç»ˆä¸€è‡´æ€§` | `å¼ºä¸€è‡´æ€§` |
| âš¡ **æ€§èƒ½** | `é«˜ï¼ˆå¼‚æ­¥ï¼‰` | `ä¸­ï¼ˆèµ„æºé”å®šï¼‰` |
| ğŸ”§ **å¤æ‚åº¦** | `ä¸­ç­‰` | `é«˜` |
| ğŸ”„ **å›æ»šæ–¹å¼** | `è¡¥å¿æ“ä½œ` | `Cancelæ“ä½œ` |
| ğŸ’¼ **é€‚ç”¨åœºæ™¯** | `é•¿æµç¨‹ã€å¯è¡¥å¿` | `çŸ­æµç¨‹ã€å¼ºä¸€è‡´` |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¼‚æ­¥é€šä¿¡æœ¬è´¨ï¼šå‘é€è¯·æ±‚åä¸ç­‰å¾…å“åº”ï¼Œç»§ç»­æ‰§è¡Œ
ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—ï¼šè§£è€¦æœåŠ¡ã€å‰Šå³°å¡«è°·ã€æé«˜å¯é æ€§çš„ä¸­é—´ä»¶
ğŸ”¸ äº‹ä»¶é©±åŠ¨ï¼šé€šè¿‡äº‹ä»¶ä¼ é€’çŠ¶æ€å˜åŒ–ï¼Œå®ç°æ¾è€¦åˆæ¶æ„
ğŸ”¸ å‘å¸ƒè®¢é˜…ï¼šä¸€å¯¹å¤šé€šä¿¡æ¨¡å¼,å¹¿æ’­æ¶ˆæ¯ç»™å¤šä¸ªè®¢é˜…è€…
ğŸ”¸ æ¶ˆæ¯å¯é æ€§ï¼šç”Ÿäº§ç¡®è®¤+æŒä¹…åŒ–+æ¶ˆè´¹ç¡®è®¤ä¸‰æ¿æ–§
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼š@Asyncã€CompletableFutureã€æ¶ˆæ¯é˜Ÿåˆ—å¤šç§æ–¹å¼
ğŸ”¸ å›è°ƒæœºåˆ¶ï¼šHTTPå›è°ƒã€MQå›è°ƒã€è¶…æ—¶å¤„ç†çš„è®¾è®¡
ğŸ”¸ åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼šæœ¬åœ°æ¶ˆæ¯è¡¨ã€TCCã€SAGAå¤šç§æ–¹æ¡ˆ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¼‚æ­¥é€šä¿¡çš„ä»·å€¼**
```
ä»€ä¹ˆæ—¶å€™ç”¨å¼‚æ­¥ï¼š
âœ… è€—æ—¶æ“ä½œï¼šå‘é‚®ä»¶ã€ç”ŸæˆæŠ¥è¡¨ã€è°ƒå¤–éƒ¨API
âœ… å…è®¸å»¶è¿Ÿï¼šæ—¥å¿—è®°å½•ã€æ•°æ®ç»Ÿè®¡ã€é€šçŸ¥æ¨é€
âœ… å‰Šå³°å¡«è°·ï¼šç§’æ€æ´»åŠ¨ã€æ‰¹é‡ä»»åŠ¡

ä»€ä¹ˆæ—¶å€™ä¸ç”¨å¼‚æ­¥ï¼š
âŒ å¼ºå®æ—¶æ€§ï¼šç”¨æˆ·ç™»å½•ã€å®æ—¶æŸ¥è¯¢
âŒ å¼ºä¸€è‡´æ€§ï¼šè½¬è´¦æ‰£æ¬¾ã€åº“å­˜æ‰£å‡ï¼ˆéœ€ç‰¹æ®Šæ–¹æ¡ˆï¼‰
âŒ ç®€å•æ“ä½œï¼šæœ¬åœ°è®¡ç®—ã€ç®€å•æŸ¥è¯¢
```

**ğŸ”¹ æ¶ˆæ¯é˜Ÿåˆ—é€‰å‹**
```
ä¸­å°è§„æ¨¡ï¼ˆ10ä¸‡/å¤©ä»¥å†…ï¼‰ï¼š
â†’ RabbitMQï¼šåŠŸèƒ½ä¸°å¯Œï¼Œå¼€ç®±å³ç”¨

å¤§è§„æ¨¡æµå¤„ç†ï¼ˆç™¾ä¸‡/å¤©ä»¥ä¸Šï¼‰ï¼š
â†’ Kafkaï¼šé«˜ååé‡ï¼Œåˆ†å¸ƒå¼è®¾è®¡

é‡‘èçº§å¯é æ€§ï¼š
â†’ RocketMQï¼šäº‹åŠ¡æ¶ˆæ¯ï¼Œå¯é æ€§é«˜

æŠ€æœ¯æ ˆé€‰æ‹©ï¼š
â†’ Springç”Ÿæ€ï¼šRabbitMQã€Kafkaéƒ½æ”¯æŒå¥½
â†’ é˜¿é‡Œç³»ï¼šRocketMQä¸Spring Cloud Alibabaé›†æˆ
```

**ğŸ”¹ å¯é æ€§ä¿éšœ**
```
ä¸‰ä¸ªå±‚é¢çš„ä¿éšœï¼š
1. ç”Ÿäº§ç«¯ï¼šå‘é€ç¡®è®¤+é‡è¯•æœºåˆ¶
2. MQç«¯ï¼šæ¶ˆæ¯æŒä¹…åŒ–+é›†ç¾¤éƒ¨ç½²
3. æ¶ˆè´¹ç«¯ï¼šæ‰‹åŠ¨ç¡®è®¤+å¹‚ç­‰å¤„ç†

å®è·µå»ºè®®ï¼š
- æ ¸å¿ƒä¸šåŠ¡ï¼šå¼€å¯æ‰€æœ‰ä¿éšœæœºåˆ¶
- éæ ¸å¿ƒä¸šåŠ¡ï¼šé€‚å½“é™ä½è¦æ±‚æå‡æ€§èƒ½
- ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§æ¶ˆæ¯ç§¯å‹å’Œå¤±è´¥
```

**ğŸ”¹ ä¸€è‡´æ€§æ–¹æ¡ˆé€‰æ‹©**
```
æœ¬åœ°æ¶ˆæ¯è¡¨ï¼š
âœ… å®ç°ç®€å•ï¼Œå¯é æ€§é«˜
âœ… é€‚åˆå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯
âŒ æœ‰å»¶è¿Ÿï¼Œæœ€ç»ˆä¸€è‡´æ€§

TCCï¼š
âœ… å¼ºä¸€è‡´æ€§ï¼Œæ€§èƒ½å¥½
âŒ å®ç°å¤æ‚ï¼Œä¾µå…¥æ€§å¼º
âœ… é€‚åˆæ ¸å¿ƒé‡‘èä¸šåŠ¡

SAGAï¼š
âœ… é•¿æµç¨‹æ”¯æŒå¥½ï¼Œè¡¥å¿çµæ´»
âŒ è¡¥å¿é€»è¾‘è¦è€ƒè™‘å‘¨å…¨
âœ… é€‚åˆå¤æ‚ä¸šåŠ¡æµç¨‹
```

### 9.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ å…¸å‹ä¸šåŠ¡åœºæ™¯åº”ç”¨**

```
ğŸ“¦ ç”µå•†è®¢å•æµç¨‹ï¼š
åŒæ­¥ï¼šç”¨æˆ·ä¸‹å• â†’ åˆ›å»ºè®¢å•
å¼‚æ­¥ï¼šè®¢å•åˆ›å»ºæˆåŠŸ â†’ 
  - æ‰£å‡åº“å­˜ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  - å‘é€çŸ­ä¿¡ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
  - å¢åŠ ç§¯åˆ†ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
  - æ•°æ®ç»Ÿè®¡ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

ğŸ“§ é‚®ä»¶å‘é€ç³»ç»Ÿï¼š
åŒæ­¥ï¼šç”¨æˆ·æäº¤ â†’ ä¿å­˜è‰ç¨¿
å¼‚æ­¥ï¼šå‘é€ä»»åŠ¡ â†’
  - æ‰¹é‡å‘é€ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
  - å‘é€çŠ¶æ€å›è°ƒï¼ˆHTTPå›è°ƒï¼‰
  - å¤±è´¥é‡è¯•ï¼ˆé‡è¯•é˜Ÿåˆ—ï¼‰

ğŸ’° æ”¯ä»˜æµç¨‹ï¼š
åŒæ­¥ï¼šå‘èµ·æ”¯ä»˜ â†’ åˆ›å»ºæ”¯ä»˜å•
å¼‚æ­¥ï¼šç­‰å¾…æ”¯ä»˜ç»“æœ â†’
  - ç¬¬ä¸‰æ–¹å›è°ƒï¼ˆHTTPå›è°ƒï¼‰
  - è¶…æ—¶æ£€æŸ¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
  - çŠ¶æ€åŒæ­¥ï¼ˆæœ¬åœ°æ¶ˆæ¯è¡¨ï¼‰
```

**ğŸ¯ æ–¹æ¡ˆç»„åˆä½¿ç”¨**
```
å®é™…é¡¹ç›®ä¸­é€šå¸¸ç»„åˆä½¿ç”¨ï¼š

è®¢å•ç³»ç»Ÿæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è®¢å•æœåŠ¡ï¼ˆä¸»æµç¨‹ï¼‰          â”‚
â”‚  1. åˆ›å»ºè®¢å•ï¼ˆåŒæ­¥ï¼‰                â”‚
â”‚  2. å‘å¸ƒOrderCreatedäº‹ä»¶ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åº“å­˜æœåŠ¡ â”‚         â”‚ç§¯åˆ†æœåŠ¡ â”‚
â”‚ç›‘å¬äº‹ä»¶ â”‚         â”‚ç›‘å¬äº‹ä»¶ â”‚
â”‚æ‰£å‡åº“å­˜ â”‚         â”‚å¢åŠ ç§¯åˆ† â”‚
â”‚(æ¶ˆæ¯é˜Ÿåˆ—)â”‚        â”‚(æ¶ˆæ¯é˜Ÿåˆ—)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
 å¤„ç†ç»“æœå›è°ƒ
ï¼ˆæœ¬åœ°æ¶ˆæ¯è¡¨ä¿è¯å¯é æ€§ï¼‰
```

### 9.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ æ€§èƒ½è°ƒä¼˜è¦ç‚¹**

```
1ï¸âƒ£ æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–
- æ‰¹é‡å‘é€ï¼šå‡å°‘ç½‘ç»œå¼€é”€
  rabbitTemplate.convertAndSend(messages, 100);  // æ‰¹é‡100æ¡
  
- é¢„å–è®¾ç½®ï¼šæ§åˆ¶æ¶ˆè´¹é€Ÿåº¦
  spring.rabbitmq.listener.prefetch=10  // ä¸€æ¬¡é¢„å–10æ¡
  
- è¿æ¥æ± ï¼šå¤ç”¨è¿æ¥
  spring.rabbitmq.cache.connection.mode=channel

2ï¸âƒ£ å¼‚æ­¥å¤„ç†ä¼˜åŒ–  
- çº¿ç¨‹æ± è°ƒä¼˜ï¼š
  æ ¸å¿ƒçº¿ç¨‹ = CPUæ ¸å¿ƒæ•° Ã— 2
  æœ€å¤§çº¿ç¨‹ = CPUæ ¸å¿ƒæ•° Ã— 4
  é˜Ÿåˆ—å¤§å° = æ ¹æ®å†…å­˜å’Œä»»åŠ¡é‡è¯„ä¼°
  
- è¶…æ—¶è®¾ç½®ï¼šé¿å…æ— é™ç­‰å¾…
  @Async(timeout = 5000)  // 5ç§’è¶…æ—¶

3ï¸âƒ£ åºåˆ—åŒ–ä¼˜åŒ–
- ä½¿ç”¨é«˜æ•ˆåºåˆ—åŒ–ï¼š
  âŒ JavaåŸç”Ÿåºåˆ—åŒ–ï¼ˆæ…¢ã€ä½“ç§¯å¤§ï¼‰
  âœ… JSONï¼ˆé€šç”¨ã€å¯è¯»ï¼‰
  âœ… Protobufï¼ˆå¿«ã€ä½“ç§¯å°ï¼‰

4ï¸âƒ£ ç›‘æ§æŒ‡æ ‡
- æ¶ˆæ¯ç§¯å‹ï¼šqueue.message.count
- æ¶ˆè´¹é€Ÿç‡ï¼šconsumer.rate
- å¤„ç†è€—æ—¶ï¼šprocess.duration
- å¤±è´¥ç‡ï¼šfailure.rate
```

### 9.5 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”§ å®æˆ˜é—®é¢˜å¤„ç†**

**Q1: æ¶ˆæ¯é‡å¤æ¶ˆè´¹æ€ä¹ˆåŠï¼Ÿ**
```
A: å®ç°å¹‚ç­‰æ€§å¤„ç†

æ–¹æ¡ˆ1ï¼šå”¯ä¸€IDå»é‡
@Component
public class IdempotentConsumer {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @RabbitListener(queues = "order.queue")
    public void consume(OrderMessage msg) {
        String key = "msg:" + msg.getId();
        
        // å°è¯•è®¾ç½®ï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è¿”å›false
        Boolean success = redisTemplate
            .opsForValue()
            .setIfAbsent(key, "1", 1, TimeUnit.HOURS);
        
        if (success) {
            // ç¬¬ä¸€æ¬¡å¤„ç†
            processOrder(msg);
        } else {
            // å·²å¤„ç†è¿‡ï¼Œè·³è¿‡
            System.out.println("æ¶ˆæ¯å·²å¤„ç†ï¼š" + msg.getId());
        }
    }
}

æ–¹æ¡ˆ2ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ
CREATE TABLE orders (
    id VARCHAR(50) PRIMARY KEY,  -- è®¢å•IDå”¯ä¸€
    ...
);

æ’å…¥æ—¶è¿åå”¯ä¸€çº¦æŸ = é‡å¤æ¶ˆæ¯ï¼Œç›´æ¥å¿½ç•¥
```

**Q2: æ¶ˆæ¯ç§¯å‹æ€ä¹ˆå¤„ç†ï¼Ÿ**
```
A: å¤šç®¡é½ä¸‹è§£å†³

1. å¢åŠ æ¶ˆè´¹è€…
@RabbitListener(queues = "order.queue", concurrency = "5-10")
// 5-10ä¸ªå¹¶å‘æ¶ˆè´¹è€…

2. æ‰¹é‡æ¶ˆè´¹
@RabbitListener(queues = "order.queue")
public void consumeBatch(List<OrderMessage> messages) {
    // æ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡
    orderService.batchProcess(messages);
}

3. é™çº§å¤„ç†
if (queue.size() > 10000) {
    // ç§¯å‹è¿‡å¤šï¼Œéƒ¨åˆ†æ¶ˆæ¯é™çº§å¤„ç†
    processSimple(msg);  // ç®€åŒ–æµç¨‹
} else {
    processNormal(msg);  // æ­£å¸¸æµç¨‹
}

4. ç´§æ€¥æ‰©å®¹
- å¢åŠ æœåŠ¡å™¨å®ä¾‹
- æé«˜çº¿ç¨‹æ± å¤§å°
- ä¸´æ—¶å…³é—­éæ ¸å¿ƒæ¶ˆè´¹è€…
```

**Q3: å¦‚ä½•ä¿è¯æ¶ˆæ¯é¡ºåºï¼Ÿ**
```
A: è®¾è®¡é¡ºåºä¿è¯æœºåˆ¶

æ–¹æ¡ˆ1ï¼šå•é˜Ÿåˆ—å•æ¶ˆè´¹è€…
// åŒä¸€ç”¨æˆ·çš„æ¶ˆæ¯å‘åˆ°åŒä¸€é˜Ÿåˆ—
String queueName = "order.user." + userId;
rabbitTemplate.convertAndSend(queueName, msg);

// æ¯ä¸ªé˜Ÿåˆ—ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œä¿è¯é¡ºåº
@RabbitListener(queues = "order.user.${userId}")

æ–¹æ¡ˆ2ï¼šKafkaåˆ†åŒºé¡ºåº
// åŒä¸€keyå‘åˆ°åŒä¸€åˆ†åŒº
kafkaTemplate.send("order-topic", userId, message);

// åˆ†åŒºå†…é¡ºåºæ¶ˆè´¹
@KafkaListener(topics = "order-topic")

æ–¹æ¡ˆ3ï¼šæ¶ˆæ¯ç¼–å·
@Data
public class OrderMessage {
    private Long sequence;  // é¡ºåºå·
    
    // æ¶ˆè´¹æ—¶æ£€æŸ¥é¡ºåº
    if (msg.getSequence() == expectedSeq) {
        process(msg);
        expectedSeq++;
    } else {
        // æš‚å­˜ï¼Œç­‰å¾…å‰é¢çš„æ¶ˆæ¯
        buffer.put(msg.getSequence(), msg);
    }
}
```

**Q4: å¼‚æ­¥è½¬åŒæ­¥æ€ä¹ˆå®ç°ï¼Ÿ**
```
A: ä½¿ç”¨Futureæˆ–å›è°ƒç­‰å¾…

æ–¹æ¡ˆ1ï¼šCompletableFuture
public String syncCall() {
    CompletableFuture<String> future = 
        CompletableFuture.supplyAsync(() -> {
            // å¼‚æ­¥è°ƒç”¨
            return remoteService.call();
        });
    
    // ç­‰å¾…ç»“æœï¼ˆæœ€å¤š3ç§’ï¼‰
    return future.get(3, TimeUnit.SECONDS);
}

æ–¹æ¡ˆ2ï¼šCountDownLatch
CountDownLatch latch = new CountDownLatch(1);
AtomicReference<String> result = new AtomicReference<>();

// å‘é€å¼‚æ­¥è¯·æ±‚
asyncService.call(response -> {
    result.set(response);
    latch.countDown();  // é€šçŸ¥å®Œæˆ
});

// ç­‰å¾…ç»“æœ
latch.await(3, TimeUnit.SECONDS);
return result.get();

æ–¹æ¡ˆ3ï¼šä¸´æ—¶å›è°ƒé˜Ÿåˆ—ï¼ˆRabbitMQï¼‰
String replyQueue = rabbitTemplate.execute(channel -> {
    return channel.queueDeclare().getQueue();
});

message.setReplyTo(replyQueue);  // è®¾ç½®å›å¤é˜Ÿåˆ—
rabbitTemplate.send(message);

// é˜»å¡ç­‰å¾…å›å¤
Message reply = rabbitTemplate.receive(replyQueue, 3000);
```

### 9.6 å­¦ä¹ è·¯å¾„ä¸è¿›é˜¶


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯çº¿**

```
ğŸ¯ åˆçº§é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰
âœ… ç†è§£åŒæ­¥vså¼‚æ­¥æ¦‚å¿µ
âœ… æŒæ¡@AsyncåŸºæœ¬ç”¨æ³•
âœ… äº†è§£æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬åŸç†
âœ… å®è·µRabbitMQç®€å•æ”¶å‘

ğŸ“ å®è·µé¡¹ç›®ï¼š
- å®ç°ç”¨æˆ·æ³¨å†Œå‘é€é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
- è®¢å•åˆ›å»ºå¼‚æ­¥æ‰£åº“å­˜ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

ğŸ¯ ä¸­çº§é˜¶æ®µï¼ˆ2-4å‘¨ï¼‰
âœ… æŒæ¡äº‹ä»¶é©±åŠ¨æ¶æ„
âœ… ç†è§£å‘å¸ƒè®¢é˜…æ¨¡å¼
âœ… å®ç°æ¶ˆæ¯å¯é æ€§ä¿è¯
âœ… æŒæ¡å›è°ƒæœºåˆ¶è®¾è®¡

ğŸ“ å®è·µé¡¹ç›®ï¼š
- å®ç°ç”µå•†è®¢å•å¼‚æ­¥æµç¨‹
- æ”¯ä»˜å›è°ƒå¤„ç†ç³»ç»Ÿ

ğŸ¯ é«˜çº§é˜¶æ®µï¼ˆ1-2æœˆï¼‰
âœ… æŒæ¡åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ
âœ… ç†è§£TCCã€SAGAåŸç†
âœ… æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§
âœ… è§£å†³å„ç§å®é™…é—®é¢˜

ğŸ“ å®è·µé¡¹ç›®ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
- é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿ
```

**ğŸ”— æ¨èå­¦ä¹ èµ„æº**

```
ğŸ“– ä¹¦ç±æ¨èï¼š
1. ã€Šæ·±å…¥ç†è§£æ¶ˆæ¯é˜Ÿåˆ—ã€‹- ç³»ç»Ÿè®²è§£MQåŸç†
2. ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹- å¼‚æ­¥é€šä¿¡æ¨¡å¼
3. ã€Šåˆ†å¸ƒå¼äº‹åŠ¡å®æˆ˜ã€‹- ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ

ğŸ¥ è§†é¢‘è¯¾ç¨‹ï¼š
- RabbitMQä»å…¥é—¨åˆ°ç²¾é€š
- Kafkaæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜
- Spring Cloudå¾®æœåŠ¡å®æˆ˜

ğŸ’» å¼€æºé¡¹ç›®ï¼š
- Seataï¼šåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶
- RocketMQï¼šé˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—
- Spring Cloud Streamï¼šæ¶ˆæ¯é©±åŠ¨æ¡†æ¶
```

### 9.7 æœ€ä½³å®è·µæ¸…å•


**âœ… å¼‚æ­¥é€šä¿¡è®¾è®¡æ£€æŸ¥æ¸…å•**

```
ğŸ”¸ æ¶æ„è®¾è®¡
â–¡ æ˜ç¡®å“ªäº›åœºæ™¯ä½¿ç”¨åŒæ­¥ï¼Œå“ªäº›ä½¿ç”¨å¼‚æ­¥
â–¡ é€‰æ‹©åˆé€‚çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQ/Kafka/RocketMQï¼‰
â–¡ è®¾è®¡åˆç†çš„äº‹ä»¶æ¨¡å‹å’Œä¸»é¢˜
â–¡ è§„åˆ’æœåŠ¡é—´çš„ä¾èµ–å…³ç³»

ğŸ”¸ å¯é æ€§ä¿éšœ
â–¡ å¼€å¯ç”Ÿäº§ç«¯å‘é€ç¡®è®¤
â–¡ é…ç½®æ¶ˆæ¯æŒä¹…åŒ–
â–¡ å®ç°æ¶ˆè´¹ç«¯æ‰‹åŠ¨ç¡®è®¤
â–¡ è®¾è®¡å¹‚ç­‰æ€§å¤„ç†
â–¡ å®ç°é‡è¯•å’Œæ­»ä¿¡é˜Ÿåˆ—

ğŸ”¸ æ€§èƒ½ä¼˜åŒ–
â–¡ åˆç†é…ç½®çº¿ç¨‹æ± å‚æ•°
â–¡ ä½¿ç”¨æ‰¹é‡å‘é€å‡å°‘å¼€é”€
â–¡ é€‰æ‹©é«˜æ•ˆçš„åºåˆ—åŒ–æ–¹å¼
â–¡ ç›‘æ§æ¶ˆæ¯ç§¯å‹æƒ…å†µ

ğŸ”¸ ä¸€è‡´æ€§å¤„ç†
â–¡ é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§æ–¹æ¡ˆï¼ˆæœ¬åœ°æ¶ˆæ¯è¡¨/TCC/SAGAï¼‰
â–¡ å®ç°è¡¥å¿å’Œå›æ»šé€»è¾‘
â–¡ å¤„ç†è¶…æ—¶å’Œå¼‚å¸¸æƒ…å†µ
â–¡ è®¾è®¡çŠ¶æ€æœºç®¡ç†æµç¨‹

ğŸ”¸ ç›‘æ§è¿ç»´
â–¡ ç›‘æ§æ¶ˆæ¯å‘é€æˆåŠŸç‡
â–¡ ç›‘æ§æ¶ˆæ¯æ¶ˆè´¹å»¶è¿Ÿ
â–¡ è®¾ç½®å‘Šè­¦é˜ˆå€¼
â–¡ å‡†å¤‡åº”æ€¥é¢„æ¡ˆ
```

### 9.8 æ ¸å¿ƒè®°å¿†å£è¯€


**ğŸ¯ è®°å¿†è¦ç‚¹**

```
å¼‚æ­¥é€šä¿¡ä¸‰å¤§ä»¶ï¼š
æ¶ˆæ¯é˜Ÿåˆ—ã€äº‹ä»¶é©±åŠ¨ã€å›è°ƒæœºåˆ¶

å¯é æ€§ä¸‰æ¿æ–§ï¼š
ç”Ÿäº§ç¡®è®¤ã€æ¶ˆæ¯æŒä¹…ã€æ¶ˆè´¹ç¡®è®¤

ä¸€è‡´æ€§ä¸‰æ–¹æ¡ˆï¼š
æœ¬åœ°æ¶ˆæ¯ã€TCCè¡¥å¿ã€SAGAç¼–æ’

æ€§èƒ½ä¼˜åŒ–ä¸‰è¦ç´ ï¼š
æ‰¹é‡å¤„ç†ã€çº¿ç¨‹è°ƒä¼˜ã€åºåˆ—åŒ–é€‰æ‹©

é—®é¢˜å¤„ç†ä¸‰æ­¥éª¤ï¼š
å¹‚ç­‰å»é‡ã€ç§¯å‹æ‰©å®¹ã€é¡ºåºä¿è¯
```

**ğŸ’¡ å…³é”®ç†è§£**

> **å¼‚æ­¥é€šä¿¡çš„æœ¬è´¨**ï¼šç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œç”¨å¤æ‚åº¦æ¢æ€§èƒ½
> 
> **é€‰æ‹©åŸåˆ™**ï¼šèƒ½åŒæ­¥å°±åŒæ­¥ï¼Œå¿…é¡»å¼‚æ­¥æ‰å¼‚æ­¥
> 
> **å¯é æ€§åŸåˆ™**ï¼šæ ¸å¿ƒä¸šåŠ¡ä¸¥æ ¼ä¿éšœï¼Œéæ ¸å¿ƒé€‚åº¦å®¹å¿
> 
> **ä¸€è‡´æ€§åŸåˆ™**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ–¹æ¡ˆï¼Œä¸è¦è¿‡åº¦è®¾è®¡

---

**ğŸ“ å­¦ä¹ å»ºè®®**

1. **å¾ªåºæ¸è¿›**ï¼šå…ˆæŒæ¡åŸºç¡€æ¦‚å¿µï¼Œå†å­¦é«˜çº§æ–¹æ¡ˆ
2. **åŠ¨æ‰‹å®è·µ**ï¼šç†è®ºå¿…é¡»ç»“åˆä»£ç å®è·µ
3. **é—®é¢˜å¯¼å‘**ï¼šé‡åˆ°é—®é¢˜æŸ¥èµ„æ–™ã€çœ‹æºç 
4. **æ€»ç»“æç‚¼**ï¼šå®šæœŸå›é¡¾æ€»ç»“ï¼Œå½¢æˆçŸ¥è¯†ä½“ç³»

**ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ **

- æ·±å…¥å­¦ä¹ åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼ˆSeataï¼‰
- ç ”ç©¶æ¶ˆæ¯é˜Ÿåˆ—é«˜çº§ç‰¹æ€§ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ã€å»¶è¿Ÿé˜Ÿåˆ—ï¼‰
- å®è·µé«˜å¹¶å‘åœºæ™¯ä¸‹çš„å¼‚æ­¥å¤„ç†ä¼˜åŒ–
- å­¦ä¹ å¾®æœåŠ¡é“¾è·¯è¿½è¸ªï¼ˆSleuthã€Zipkinï¼‰

---

**ğŸ“Œ æœ¬ç« é‡ç‚¹å›é¡¾**

```
æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š
âœ… å¼‚æ­¥é€šä¿¡çš„æ¦‚å¿µã€ä»·å€¼å’Œé€‚ç”¨åœºæ™¯
âœ… æ¶ˆæ¯é˜Ÿåˆ—çš„å·¥ä½œåŸç†å’Œå¸¸ç”¨äº§å“å¯¹æ¯”
âœ… äº‹ä»¶é©±åŠ¨æ¶æ„çš„è®¾è®¡æ€æƒ³å’Œå®ç°æ–¹å¼
âœ… å‘å¸ƒè®¢é˜…æ¨¡å¼çš„ç‰¹ç‚¹å’Œåº”ç”¨åœºæ™¯
âœ… æ¶ˆæ¯å¯é æ€§çš„ä¸‰å±‚ä¿éšœæœºåˆ¶
âœ… å¼‚æ­¥å¤„ç†çš„å¤šç§ç­–ç•¥å’Œå®ç°æ–¹å¼
âœ… å›è°ƒæœºåˆ¶çš„è®¾è®¡å’Œè¶…æ—¶å¤„ç†
âœ… åˆ†å¸ƒå¼ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆ

å®è·µèƒ½åŠ›ï¼š
âœ… èƒ½ä½¿ç”¨RabbitMQ/Kafkaå®ç°å¼‚æ­¥é€šä¿¡
âœ… èƒ½è®¾è®¡äº‹ä»¶é©±åŠ¨çš„å¾®æœåŠ¡æ¶æ„
âœ… èƒ½ä¿è¯æ¶ˆæ¯çš„å¯é ä¼ é€’
âœ… èƒ½å¤„ç†åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§
âœ… èƒ½è§£å†³æ¶ˆæ¯ç§¯å‹ã€é‡å¤æ¶ˆè´¹ç­‰å®é™…é—®é¢˜
âœ… èƒ½è¿›è¡Œæ€§èƒ½è°ƒä¼˜å’Œç›‘æ§å‘Šè­¦
```

**æ­å–œä½ å®Œæˆã€Šå¼‚æ­¥é€šä¿¡æ¨¡å¼å®è·µã€‹çš„å­¦ä¹ ï¼** ğŸ‰

æŒæ¡äº†è¿™äº›çŸ¥è¯†ï¼Œä½ å·²ç»å…·å¤‡äº†æ„å»ºå¯é ã€é«˜æ€§èƒ½å¾®æœåŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒèƒ½åŠ›ã€‚ç»§ç»­åŠ æ²¹ï¼Œå‘æ›´é«˜çº§çš„åˆ†å¸ƒå¼æ¶æ„æŒ‘æˆ˜ï¼