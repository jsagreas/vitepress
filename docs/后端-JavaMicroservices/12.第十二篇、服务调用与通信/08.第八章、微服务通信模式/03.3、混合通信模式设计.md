---
title: 3ã€æ··åˆé€šä¿¡æ¨¡å¼è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [æ··åˆé€šä¿¡æ¨¡å¼æ¦‚è¿°](#1-æ··åˆé€šä¿¡æ¨¡å¼æ¦‚è¿°)
2. [åŒæ­¥å¼‚æ­¥ç»“åˆæ¨¡å¼](#2-åŒæ­¥å¼‚æ­¥ç»“åˆæ¨¡å¼)
3. [è¯»å†™åˆ†ç¦»é€šä¿¡](#3-è¯»å†™åˆ†ç¦»é€šä¿¡)
4. [CQRSå‘½ä»¤æŸ¥è¯¢åˆ†ç¦»](#4-CQRSå‘½ä»¤æŸ¥è¯¢åˆ†ç¦»)
5. [äº‹ä»¶æº¯æºæ¨¡å¼](#5-äº‹ä»¶æº¯æºæ¨¡å¼)
6. [Sagaåˆ†å¸ƒå¼äº‹åŠ¡](#6-Sagaåˆ†å¸ƒå¼äº‹åŠ¡)
7. [è¡¥å¿äº‹åŠ¡æœºåˆ¶](#7-è¡¥å¿äº‹åŠ¡æœºåˆ¶)
8. [æœ€ç»ˆä¸€è‡´æ€§ä¿è¯](#8-æœ€ç»ˆä¸€è‡´æ€§ä¿è¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ··åˆé€šä¿¡æ¨¡å¼æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ··åˆé€šä¿¡æ¨¡å¼


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> æƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼šç‚¹å•æ—¶éœ€è¦ç«‹å³ç¡®è®¤ï¼ˆåŒæ­¥ï¼‰ï¼Œä½†åšèœæ˜¯åœ¨åå¨æ…¢æ…¢åšï¼ˆå¼‚æ­¥ï¼‰ã€‚æ··åˆé€šä¿¡å°±æ˜¯è¿™æ ·ï¼ŒæŠŠåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ç»“åˆèµ·æ¥ï¼Œå„å–æ‰€é•¿ã€‚

**æ ¸å¿ƒå®šä¹‰**
```
æ··åˆé€šä¿¡æ¨¡å¼ï¼šåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯çµæ´»ç»„åˆä½¿ç”¨
åŒæ­¥è°ƒç”¨å’Œå¼‚æ­¥æ¶ˆæ¯ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿çš„é€šä¿¡ç­–ç•¥

ç®€å•ç†è§£ï¼š
- éœ€è¦ç«‹å³å“åº”çš„ â†’ ç”¨åŒæ­¥è°ƒç”¨ï¼ˆRESTã€gRPCï¼‰
- å¯ä»¥å»¶åå¤„ç†çš„ â†’ ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼ˆRabbitMQã€Kafkaï¼‰
- å¤æ‚ä¸šåŠ¡æµç¨‹ â†’ ä¸¤è€…ç»“åˆä½¿ç”¨
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ¨¡å¼


**å•ä¸€æ¨¡å¼çš„å±€é™**ï¼š

| é€šä¿¡æ–¹å¼ | **ä¼˜åŠ¿** | **å±€é™** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| ğŸ”„ **çº¯åŒæ­¥** | `ç«‹å³å“åº”`<br>`ç®€å•ç›´è§‚` | `æœåŠ¡è€¦åˆå¼º`<br>`å®¹é”™æ€§å·®` | `æŸ¥è¯¢ç±»æ“ä½œ` |
| ğŸ“¨ **çº¯å¼‚æ­¥** | `è§£è€¦æ€§å¥½`<br>`é«˜å¯ç”¨` | `å¤æ‚åº¦é«˜`<br>`è°ƒè¯•å›°éš¾` | `åå°ä»»åŠ¡` |
| âš¡ **æ··åˆæ¨¡å¼** | `çµæ´»é€‰æ‹©`<br>`ä¼˜åŠ¿äº’è¡¥` | `è®¾è®¡å¤æ‚` | `å¤æ‚ä¸šåŠ¡æµç¨‹` |

**å®é™…ä¸šåŠ¡éœ€æ±‚**ï¼š
```
ç”µå•†ä¸‹å•æµç¨‹åˆ†æï¼š

ç«‹å³éœ€è¦çš„ï¼ˆåŒæ­¥ï¼‰ï¼š
âœ… åº“å­˜æ£€æŸ¥ â†’ å¿…é¡»é©¬ä¸ŠçŸ¥é“æœ‰æ²¡æœ‰è´§
âœ… ä»·æ ¼è®¡ç®— â†’ ç”¨æˆ·è¦çœ‹åˆ°å®æ—¶ä»·æ ¼
âœ… è®¢å•åˆ›å»º â†’ éœ€è¦ç«‹å³è¿”å›è®¢å•å·

å¯ä»¥å»¶åçš„ï¼ˆå¼‚æ­¥ï¼‰ï¼š
ğŸ“¨ å‘é€é‚®ä»¶ â†’ æ™šå‡ ç§’æ”¶åˆ°ä¹Ÿæ²¡å…³ç³»
ğŸ“¨ ç§¯åˆ†è®¡ç®— â†’ å¯ä»¥åå°æ…¢æ…¢ç®—
ğŸ“¨ æ•°æ®ç»Ÿè®¡ â†’ ä¸å½±å“ä¸‹å•æµç¨‹

ç»“è®ºï¼šéœ€è¦æ··åˆä½¿ç”¨ï¼
```

### 1.3 æ··åˆæ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³


```
è®¾è®¡åŸåˆ™ï¼š

åŒæ­¥ç”¨äºï¼š
ğŸ¯ ä¸»æµç¨‹æ§åˆ¶ â†’ éœ€è¦ç«‹å³åé¦ˆçš„æ“ä½œ
ğŸ¯ å¼ºä¸€è‡´æ€§è¦æ±‚ â†’ æ•°æ®å¿…é¡»å®æ—¶å‡†ç¡®
ğŸ¯ ç”¨æˆ·äº¤äº’ â†’ ç”¨æˆ·ç­‰å¾…çš„æ“ä½œ

å¼‚æ­¥ç”¨äºï¼š
ğŸ“® å‰¯ä½œç”¨å¤„ç† â†’ å‘é‚®ä»¶ã€å‘çŸ­ä¿¡ç­‰
ğŸ“® æœ€ç»ˆä¸€è‡´æ€§ â†’ æ•°æ®å¯ä»¥ç¨ååŒæ­¥
ğŸ“® é•¿æ—¶é—´ä»»åŠ¡ â†’ å¤§æ•°æ®å¤„ç†ã€æŠ¥è¡¨ç”Ÿæˆ

æ··åˆç­–ç•¥ï¼š
âš¡ ä¸»æµç¨‹åŒæ­¥ï¼Œå‰¯ä½œç”¨å¼‚æ­¥
âš¡ è¯»æ“ä½œåŒæ­¥ï¼Œå†™æ“ä½œå¼‚æ­¥
âš¡ æŸ¥è¯¢åŒæ­¥ï¼Œå‘½ä»¤å¼‚æ­¥ï¼ˆCQRSï¼‰
```

---

## 2. ğŸ”„ åŒæ­¥å¼‚æ­¥ç»“åˆæ¨¡å¼


### 2.1 åŸºæœ¬ç»“åˆç­–ç•¥


**åœºæ™¯ä¸€ï¼šä¸»æµç¨‹åŒæ­¥ï¼Œå‰¯ä½œç”¨å¼‚æ­¥**

```
ä¸‹å•æµç¨‹è®¾è®¡ï¼š

ç”¨æˆ·è¯·æ±‚ä¸‹å•
    â†“
[åŒæ­¥] æ£€æŸ¥åº“å­˜ â”€â”€â”€â”€â†’ åº“å­˜æœåŠ¡
    â†“
[åŒæ­¥] åˆ›å»ºè®¢å• â”€â”€â”€â”€â†’ è®¢å•æœåŠ¡
    â†“
ç«‹å³è¿”å›è®¢å•å· â”€â”€â”€â”€â†’ ç”¨æˆ·
    â†“
[å¼‚æ­¥] å‘é€ç¡®è®¤é‚®ä»¶ â”€â”€â†’ æ¶ˆæ¯é˜Ÿåˆ— â”€â”€â†’ é‚®ä»¶æœåŠ¡
[å¼‚æ­¥] æ›´æ–°ç§¯åˆ† â”€â”€â”€â”€â†’ æ¶ˆæ¯é˜Ÿåˆ— â”€â”€â†’ ç§¯åˆ†æœåŠ¡
[å¼‚æ­¥] æ•°æ®ç»Ÿè®¡ â”€â”€â”€â”€â†’ æ¶ˆæ¯é˜Ÿåˆ— â”€â”€â†’ åˆ†ææœåŠ¡
```

**ä»£ç ç¤ºä¾‹ï¼ˆç²¾ç®€ç‰ˆï¼‰**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;  // åŒæ­¥è°ƒç”¨
    
    @Autowired
    private RabbitTemplate rabbitTemplate;    // å¼‚æ­¥æ¶ˆæ¯
    
    public OrderResponse createOrder(OrderRequest request) {
        // 1. åŒæ­¥æ£€æŸ¥åº“å­˜ï¼ˆå¿…é¡»ç«‹å³çŸ¥é“ç»“æœï¼‰
        boolean hasStock = inventoryClient.checkStock(request.getProductId());
        if (!hasStock) {
            throw new OutOfStockException("åº“å­˜ä¸è¶³");
        }
        
        // 2. åŒæ­¥åˆ›å»ºè®¢å•ï¼ˆéœ€è¦ç«‹å³è¿”å›è®¢å•å·ï¼‰
        Order order = saveOrder(request);
        
        // 3. å¼‚æ­¥å‘é€åç»­æ¶ˆæ¯ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
        sendAsyncMessages(order);
        
        // 4. ç«‹å³è¿”å›ç»“æœç»™ç”¨æˆ·
        return new OrderResponse(order.getId());
    }
    
    private void sendAsyncMessages(Order order) {
        // å‘é‚®ä»¶ï¼ˆå¼‚æ­¥ï¼‰
        rabbitTemplate.convertAndSend("email.queue", 
            new EmailEvent(order));
        
        // æ›´æ–°ç§¯åˆ†ï¼ˆå¼‚æ­¥ï¼‰
        rabbitTemplate.convertAndSend("points.queue", 
            new PointsEvent(order));
    }
}
```

### 2.2 è¶…æ—¶é™çº§ç­–ç•¥


> âš ï¸ **é‡è¦æé†’**  
> åŒæ­¥è°ƒç”¨å¯èƒ½è¶…æ—¶ï¼Œéœ€è¦è®¾è®¡é™çº§æ–¹æ¡ˆï¼Œä¿è¯ç”¨æˆ·ä½“éªŒ

**é™çº§ç­–ç•¥è®¾è®¡**ï¼š

```
ç­–ç•¥1ï¼šå¿«é€Ÿå¤±è´¥
åŒæ­¥è°ƒç”¨ â†’ è®¾ç½®è¶…æ—¶ï¼ˆå¦‚2ç§’ï¼‰â†’ è¶…æ—¶åˆ™å¤±è´¥ â†’ è¿”å›å‹å¥½æç¤º

ç­–ç•¥2ï¼šå¼‚æ­¥è¡¥å¿
åŒæ­¥è°ƒç”¨ â†’ è¶…æ—¶ â†’ å…ˆåˆ›å»ºè®¢å• â†’ å¼‚æ­¥è¡¥å¿æ£€æŸ¥

ç­–ç•¥3ï¼šç¼“å­˜æ‰˜åº•
åŒæ­¥è°ƒç”¨ â†’ è¶…æ—¶ â†’ ä½¿ç”¨ç¼“å­˜æ•°æ® â†’ å¼‚æ­¥æ›´æ–°ç¼“å­˜
```

**è¶…æ—¶å¤„ç†ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    // è®¾ç½®è¶…æ—¶æ—¶é—´å’Œé™çº§æ–¹æ³•
    @HystrixCommand(
        fallbackMethod = "createOrderFallback",
        commandProperties = {
            @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds", 
                           value = "2000")  // 2ç§’è¶…æ—¶
        }
    )
    public OrderResponse createOrder(OrderRequest request) {
        // åŒæ­¥æ£€æŸ¥åº“å­˜
        inventoryClient.checkStock(request.getProductId());
        // ...åˆ›å»ºè®¢å•
    }
    
    // é™çº§æ–¹æ³•ï¼šè¶…æ—¶åçš„å¤„ç†
    public OrderResponse createOrderFallback(OrderRequest request) {
        // 1. å…ˆåˆ›å»ºè®¢å•ï¼ˆä¹è§‚ç­–ç•¥ï¼‰
        Order order = saveOrderWithPending(request);
        
        // 2. å¼‚æ­¥è¡¥å¿æ£€æŸ¥åº“å­˜
        rabbitTemplate.convertAndSend("inventory.check.queue", 
            new InventoryCheckEvent(order.getId()));
        
        // 3. è¿”å›ç»™ç”¨æˆ·ï¼ˆæ ‡è®°ä¸ºå¾…ç¡®è®¤ï¼‰
        return new OrderResponse(order.getId(), "è®¢å•åˆ›å»ºä¸­ï¼Œè¯·ç¨åæŸ¥çœ‹");
    }
}
```

### 2.3 æœ€ä½³å®è·µå»ºè®®


```
ğŸ¯ ç»“åˆåŸåˆ™ï¼š

1. æ ¸å¿ƒæµç¨‹åŒæ­¥
   - ç”¨æˆ·å¿…é¡»çŸ¥é“çš„ç»“æœ
   - å½±å“ä¸šåŠ¡æµç¨‹çš„æ“ä½œ
   
2. è¾…åŠ©åŠŸèƒ½å¼‚æ­¥
   - é€šçŸ¥ç±»æ“ä½œ
   - ç»Ÿè®¡åˆ†æ
   - æ—¥å¿—è®°å½•

3. è®¾ç½®åˆç†è¶…æ—¶
   - åŒæ­¥è°ƒç”¨ï¼š1-3ç§’
   - å…³é”®ä¸šåŠ¡ï¼šé€‚å½“æ”¾å®½
   - ä¸€èˆ¬æŸ¥è¯¢ï¼šä¸¥æ ¼æ§åˆ¶

4. å¼‚æ­¥è¡¥å¿æœºåˆ¶
   - åŒæ­¥å¤±è´¥ â†’ å¼‚æ­¥é‡è¯•
   - è®°å½•å¤±è´¥æ—¥å¿—
   - å®šæ—¶è¡¥å¿ä»»åŠ¡
```

---

## 3. ğŸ“– è¯»å†™åˆ†ç¦»é€šä¿¡


### 3.1 è¯»å†™åˆ†ç¦»çš„æœ¬è´¨


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> å›¾ä¹¦é¦†å€Ÿä¹¦å’Œè¿˜ä¹¦æ˜¯ä¸¤ä¸ªçª—å£ï¼šæŸ¥è¯¢åœ¨å“ªæœ¬ä¹¦åœ¨"æ£€ç´¢çª—å£"ï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰ï¼Œå€Ÿè¿˜ä¹¦åœ¨"åŠç†çª—å£"ï¼ˆéœ€è¦ç™»è®°ï¼‰ã€‚è¯»å†™åˆ†ç¦»å°±æ˜¯æŠŠæŸ¥è¯¢å’Œä¿®æ”¹åˆ†å¼€å¤„ç†ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
è¯»å†™åˆ†ç¦»ï¼šå°†æ•°æ®çš„è¯»å–å’Œå†™å…¥åˆ†å¼€å¤„ç†

è¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰ï¼š
- é¢‘ç‡é«˜ã€å¹¶å‘å¤§
- å¯¹å®æ—¶æ€§è¦æ±‚ä¸ä¸¥æ ¼
- å¯ä»¥ä½¿ç”¨ç¼“å­˜ã€ä»åº“

å†™æ“ä½œï¼ˆä¿®æ”¹ï¼‰ï¼š
- é¢‘ç‡ä½ã€ä¸€è‡´æ€§è¦æ±‚é«˜  
- éœ€è¦ä¿è¯æ•°æ®å‡†ç¡®
- å†™å…¥ä¸»åº“ï¼ŒåŒæ­¥åˆ°ä»åº“
```

### 3.2 é€šä¿¡å±‚é¢çš„è¯»å†™åˆ†ç¦»


**æ¶æ„è®¾è®¡**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
APIç½‘å…³
    â†“
  /   \
è¯»è¯·æ±‚  å†™è¯·æ±‚
 â†“      â†“
æŸ¥è¯¢æœåŠ¡ å‘½ä»¤æœåŠ¡
 â†“      â†“
è¯»åº“    ä¸»åº“
(ä»åº“)   â†“
       åŒæ­¥
        â†“
       ä»åº“
```

**å®ç°æ–¹æ¡ˆ**ï¼š

| æ–¹æ¡ˆ | **è¯»æ“ä½œ** | **å†™æ“ä½œ** | **æ•°æ®åŒæ­¥** |
|-----|-----------|-----------|-------------|
| ğŸ”¹ **æ•°æ®åº“ä¸»ä»** | `æŸ¥è¯¢ä»åº“` | `å†™å…¥ä¸»åº“` | `ä¸»ä»å¤åˆ¶` |
| ğŸ”¹ **ç¼“å­˜åˆ†ç¦»** | `è¯»Redis` | `å†™DB+æ›´æ–°ç¼“å­˜` | `ç¼“å­˜åŒæ­¥` |
| ğŸ”¹ **æœåŠ¡åˆ†ç¦»** | `æŸ¥è¯¢æœåŠ¡` | `å‘½ä»¤æœåŠ¡` | `äº‹ä»¶åŒæ­¥` |

**ä»£ç ç¤ºä¾‹**ï¼š

```java
// è¯»å†™åˆ†ç¦»çš„APIè®¾è®¡
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    @Autowired
    private ProductQueryService queryService;  // æŸ¥è¯¢æœåŠ¡
    
    @Autowired
    private ProductCommandService commandService;  // å‘½ä»¤æœåŠ¡
    
    // è¯»æ“ä½œï¼šæŸ¥è¯¢å•†å“ï¼ˆèµ°ä»åº“/ç¼“å­˜ï¼‰
    @GetMapping("/{id}")
    public Product getProduct(@PathVariable Long id) {
        return queryService.getById(id);  // å¿«é€ŸæŸ¥è¯¢
    }
    
    // å†™æ“ä½œï¼šæ›´æ–°å•†å“ï¼ˆå†™ä¸»åº“ï¼‰
    @PutMapping("/{id}")
    public void updateProduct(@PathVariable Long id, 
                             @RequestBody ProductDTO dto) {
        commandService.update(id, dto);  // å†™å…¥å¹¶åŒæ­¥
    }
}

// æŸ¥è¯¢æœåŠ¡ï¼ˆä¼˜åŒ–è¯»æ€§èƒ½ï¼‰
@Service
public class ProductQueryService {
    
    @Autowired
    private RedisTemplate<String, Product> redis;
    
    @Autowired
    private ProductRepository repository;  // ä»åº“
    
    public Product getById(Long id) {
        // 1. å…ˆæŸ¥ç¼“å­˜
        String key = "product:" + id;
        Product product = redis.opsForValue().get(key);
        
        if (product != null) {
            return product;  // ç¼“å­˜å‘½ä¸­
        }
        
        // 2. æŸ¥è¯¢ä»åº“
        product = repository.findById(id);
        
        // 3. å†™å…¥ç¼“å­˜
        redis.opsForValue().set(key, product, 10, TimeUnit.MINUTES);
        
        return product;
    }
}

// å‘½ä»¤æœåŠ¡ï¼ˆä¿è¯å†™ä¸€è‡´æ€§ï¼‰
@Service
public class ProductCommandService {
    
    @Autowired
    private ProductRepository repository;  // ä¸»åº“
    
    @Autowired
    private RedisTemplate<String, Product> redis;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Transactional
    public void update(Long id, ProductDTO dto) {
        // 1. æ›´æ–°ä¸»åº“
        Product product = repository.findById(id);
        product.updateFrom(dto);
        repository.save(product);
        
        // 2. åˆ é™¤ç¼“å­˜ï¼ˆä¸‹æ¬¡æŸ¥è¯¢æ—¶ä¼šé‡æ–°åŠ è½½ï¼‰
        redis.delete("product:" + id);
        
        // 3. å‘é€æ›´æ–°äº‹ä»¶ï¼ˆé€šçŸ¥å…¶ä»–æœåŠ¡ï¼‰
        rabbitTemplate.convertAndSend("product.updated", 
            new ProductUpdatedEvent(id));
    }
}
```

### 3.3 è¯»å†™åˆ†ç¦»çš„æ•°æ®åŒæ­¥


**åŒæ­¥ç­–ç•¥**ï¼š

```
ç­–ç•¥1ï¼šæ•°æ®åº“ä¸»ä»åŒæ­¥
ä¸»åº“å†™å…¥ â†’ äºŒè¿›åˆ¶æ—¥å¿— â†’ ä»åº“å›æ”¾ â†’ æ•°æ®åŒæ­¥
å»¶è¿Ÿï¼šæ¯«ç§’çº§åˆ°ç§’çº§

ç­–ç•¥2ï¼šç¼“å­˜æ›´æ–°ç­–ç•¥
å†™å…¥æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜ â†’ ä¸‹æ¬¡æŸ¥è¯¢é‡å»ºç¼“å­˜
ä¼˜åŠ¿ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§

ç­–ç•¥3ï¼šäº‹ä»¶é©±åŠ¨åŒæ­¥
å†™æœåŠ¡å‘å¸ƒäº‹ä»¶ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ è¯»æœåŠ¡è®¢é˜…æ›´æ–°
ä¼˜åŠ¿ï¼šæœåŠ¡è§£è€¦
```

---

## 4. ğŸ¨ CQRSå‘½ä»¤æŸ¥è¯¢åˆ†ç¦»


### 4.1 CQRSæ ¸å¿ƒæ€æƒ³


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> CQRSï¼ˆCommand Query Responsibility Segregationï¼‰å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼Œæ˜¯è¯»å†™åˆ†ç¦»çš„è¿›é˜¶ç‰ˆæœ¬ï¼Œä¸ä»…åˆ†ç¦»æ•°æ®åº“ï¼Œè¿˜åˆ†ç¦»æ•´ä¸ªæ•°æ®æ¨¡å‹ã€‚

**CQRS vs ä¼ ç»Ÿæ¨¡å¼**ï¼š

```
ä¼ ç»Ÿæ¨¡å¼ï¼ˆåŒä¸€æ¨¡å‹ï¼‰ï¼š
         User
    +-----------+
    | id        |
    | name      |     è¯»å†™éƒ½ç”¨åŒä¸€ä¸ªæ¨¡å‹
    | email     |  â†  æŸ¥è¯¢å’Œä¿®æ”¹éƒ½æ“ä½œè¿™ä¸ª
    | password  |
    +-----------+

CQRSæ¨¡å¼ï¼ˆåˆ†ç¦»æ¨¡å‹ï¼‰ï¼š

å‘½ä»¤æ¨¡å‹ï¼ˆå†™ï¼‰        æŸ¥è¯¢æ¨¡å‹ï¼ˆè¯»ï¼‰
  UserCommand         UserQuery
+-----------+      +---------------+
| id        |      | id            |
| name      |      | name          |
| email     |      | email         |
| password  |      | displayName   |  ä¼˜åŒ–æŸ¥è¯¢
+-----------+      | lastLoginTime |  ä¸“ç”¨å­—æ®µ
                   +---------------+
```

### 4.2 CQRSæ¶æ„è®¾è®¡


**å®Œæ•´æ¶æ„å›¾**ï¼š

```
å®¢æˆ·ç«¯
  â†“
APIç½‘å…³
  â†“
 /  \
å‘½ä»¤ç«¯  æŸ¥è¯¢ç«¯
 â†“      â†“
å‘½ä»¤   æŸ¥è¯¢
å¤„ç†å™¨  å¤„ç†å™¨
 â†“      â†“
å†™åº“   è¯»åº“
 â†“      â†‘
äº‹ä»¶   äº‹ä»¶
å‘å¸ƒ   è®¢é˜…
 â†“      â†‘
  æ¶ˆæ¯é˜Ÿåˆ—
```

**ä»£ç å®ç°**ï¼š

```java
// 1. å‘½ä»¤æ¨¡å‹ï¼ˆå†™å…¥ç”¨ï¼‰
@Entity
@Table(name = "users")
public class UserCommand {
    private Long id;
    private String name;
    private String email;
    private String password;
    private LocalDateTime createdAt;
    
    // åªæœ‰ä¿®æ”¹æ–¹æ³•
    public void updateEmail(String email) {
        this.email = email;
    }
}

// 2. æŸ¥è¯¢æ¨¡å‹ï¼ˆè¯»å–ç”¨ï¼‰
@Data
public class UserQuery {
    private Long id;
    private String name;
    private String email;
    private String displayName;  // è®¡ç®—å­—æ®µ
    private LocalDateTime lastLoginTime;  // å†—ä½™å­—æ®µ
    private int orderCount;  // å…³è”ç»Ÿè®¡
    
    // åªæœ‰æŸ¥è¯¢æ–¹æ³•ï¼Œæ²¡æœ‰ä¿®æ”¹æ–¹æ³•
}

// 3. å‘½ä»¤å¤„ç†å™¨
@Service
public class UserCommandHandler {
    
    @Autowired
    private UserCommandRepository repository;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Transactional
    public void handle(UpdateUserCommand command) {
        // 1. æ›´æ–°å‘½ä»¤æ¨¡å‹
        UserCommand user = repository.findById(command.getUserId());
        user.updateEmail(command.getEmail());
        repository.save(user);
        
        // 2. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        eventPublisher.publishEvent(
            new UserUpdatedEvent(user.getId(), user.getEmail())
        );
    }
}

// 4. æŸ¥è¯¢å¤„ç†å™¨
@Service
public class UserQueryHandler {
    
    @Autowired
    private UserQueryRepository queryRepository;
    
    public UserQuery getUser(Long id) {
        // ç›´æ¥ä»ä¼˜åŒ–çš„æŸ¥è¯¢æ¨¡å‹è¯»å–
        return queryRepository.findById(id);
    }
    
    public List<UserQuery> searchUsers(String keyword) {
        // æŸ¥è¯¢æ¨¡å‹å¯ä»¥æœ‰ä¸“é—¨çš„ç´¢å¼•
        return queryRepository.searchByKeyword(keyword);
    }
}

// 5. äº‹ä»¶ç›‘å¬å™¨ï¼ˆåŒæ­¥æŸ¥è¯¢æ¨¡å‹ï¼‰
@Component
public class UserEventListener {
    
    @Autowired
    private UserQueryRepository queryRepository;
    
    @EventListener
    public void handleUserUpdated(UserUpdatedEvent event) {
        // æ›´æ–°æŸ¥è¯¢æ¨¡å‹
        UserQuery userQuery = queryRepository.findById(event.getUserId());
        userQuery.setEmail(event.getEmail());
        userQuery.setDisplayName(event.getEmail().split("@")[0]);
        queryRepository.save(userQuery);
    }
}
```

### 4.3 CQRSçš„ä¼˜åŠ¿ä¸åœºæ™¯


**é€‚ç”¨åœºæ™¯**ï¼š

```
âœ… é€‚åˆä½¿ç”¨CQRSï¼š

1. è¯»å†™æ¯”ä¾‹å·®å¼‚å¤§
   - è¯»æ“ä½œ >> å†™æ“ä½œï¼ˆå¦‚å•†å“æµè§ˆï¼‰
   - å¯ä»¥åˆ†åˆ«ä¼˜åŒ–æ€§èƒ½

2. æŸ¥è¯¢éœ€æ±‚å¤æ‚
   - éœ€è¦å¤šè¡¨å…³è”
   - éœ€è¦å¤æ‚è®¡ç®—
   - å¯ä»¥ç”¨æŸ¥è¯¢æ¨¡å‹é¢„è®¡ç®—

3. ä¸åŒçš„ä¸€è‡´æ€§è¦æ±‚
   - å†™è¦æ±‚å¼ºä¸€è‡´æ€§
   - è¯»å¯ä»¥æœ€ç»ˆä¸€è‡´æ€§

âŒ ä¸é€‚åˆCQRSï¼š

1. ç®€å•CRUDåº”ç”¨
   - è¯»å†™æ¨¡å¼ç›¸ä¼¼
   - å¢åŠ å¤æ‚åº¦ä¸å€¼å¾—

2. å¼ºå®æ—¶æ€§è¦æ±‚
   - å¿…é¡»ç«‹å³çœ‹åˆ°æ›´æ–°
   - åŒæ­¥æˆæœ¬é«˜

3. å›¢é˜Ÿç»éªŒä¸è¶³
   - å­¦ä¹ æˆæœ¬é«˜
   - ç»´æŠ¤å¤æ‚
```

---

## 5. ğŸ“œ äº‹ä»¶æº¯æºæ¨¡å¼


### 5.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æº¯æº


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> é“¶è¡Œè´¦æˆ·ä¸æ˜¯åªè®°å½•å½“å‰ä½™é¢ï¼Œè€Œæ˜¯è®°å½•æ¯ä¸€ç¬”äº¤æ˜“ï¼ˆå­˜æ¬¾ã€å–æ¬¾ï¼‰ã€‚è¦çŸ¥é“ä½™é¢ï¼Œå°±å›æ”¾æ‰€æœ‰äº¤æ˜“è®°å½•ã€‚äº‹ä»¶æº¯æºå°±æ˜¯è¿™ä¸ªæ€è·¯ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
ä¼ ç»Ÿæ¨¡å¼ï¼šåªå­˜å‚¨å½“å‰çŠ¶æ€
è´¦æˆ·ä½™é¢ = 1000å…ƒ  ï¼ˆåªçŸ¥é“ç°åœ¨ï¼‰

äº‹ä»¶æº¯æºï¼šå­˜å‚¨æ‰€æœ‰äº‹ä»¶
å­˜æ¬¾ +500å…ƒ
å–æ¬¾ -200å…ƒ    ï¼ˆçŸ¥é“æ‰€æœ‰å†å²ï¼‰
å­˜æ¬¾ +800å…ƒ
è½¬è´¦ -100å…ƒ
---
å½“å‰ä½™é¢ = 500 + (-200) + 800 + (-100) = 1000å…ƒ
```

### 5.2 äº‹ä»¶æº¯æºæ¶æ„


**æ¶æ„è®¾è®¡**ï¼š

```
å‘½ä»¤ â†’ å¤„ç†å™¨ â†’ äº‹ä»¶ â†’ äº‹ä»¶å­˜å‚¨
                â†“
              äº‹ä»¶æµ
                â†“
            äº‹ä»¶å›æ”¾ â†’ å½“å‰çŠ¶æ€
```

**å®ç°ç¤ºä¾‹**ï¼š

```java
// 1. äº‹ä»¶å®šä¹‰
public interface DomainEvent {
    Long getAggregateId();
    LocalDateTime getOccurredOn();
}

public class MoneyDepositedEvent implements DomainEvent {
    private Long accountId;
    private BigDecimal amount;
    private LocalDateTime occurredOn;
    
    // getters...
}

public class MoneyWithdrawnEvent implements DomainEvent {
    private Long accountId;
    private BigDecimal amount;
    private LocalDateTime occurredOn;
    
    // getters...
}

// 2. èšåˆæ ¹ï¼ˆé€šè¿‡äº‹ä»¶é‡å»ºçŠ¶æ€ï¼‰
public class Account {
    private Long id;
    private BigDecimal balance;
    private List<DomainEvent> changes = new ArrayList<>();
    
    // åº”ç”¨äº‹ä»¶ï¼ˆæ”¹å˜çŠ¶æ€ï¼‰
    public void apply(MoneyDepositedEvent event) {
        this.balance = this.balance.add(event.getAmount());
    }
    
    public void apply(MoneyWithdrawnEvent event) {
        this.balance = this.balance.subtract(event.getAmount());
    }
    
    // å­˜æ¬¾å‘½ä»¤
    public void deposit(BigDecimal amount) {
        // åˆ›å»ºäº‹ä»¶
        MoneyDepositedEvent event = new MoneyDepositedEvent(id, amount);
        
        // åº”ç”¨äº‹ä»¶
        apply(event);
        
        // è®°å½•å˜æ›´
        changes.add(event);
    }
    
    // ä»äº‹ä»¶é‡å»ºçŠ¶æ€
    public static Account fromEvents(Long id, List<DomainEvent> events) {
        Account account = new Account();
        account.id = id;
        account.balance = BigDecimal.ZERO;
        
        // å›æ”¾æ‰€æœ‰äº‹ä»¶
        for (DomainEvent event : events) {
            if (event instanceof MoneyDepositedEvent) {
                account.apply((MoneyDepositedEvent) event);
            } else if (event instanceof MoneyWithdrawnEvent) {
                account.apply((MoneyWithdrawnEvent) event);
            }
        }
        
        return account;
    }
}

// 3. äº‹ä»¶å­˜å‚¨
@Service
public class EventStore {
    
    @Autowired
    private EventRepository repository;
    
    // ä¿å­˜äº‹ä»¶
    public void save(DomainEvent event) {
        EventEntity entity = new EventEntity();
        entity.setAggregateId(event.getAggregateId());
        entity.setEventType(event.getClass().getName());
        entity.setEventData(JSON.toJSONString(event));
        entity.setOccurredOn(event.getOccurredOn());
        
        repository.save(entity);
    }
    
    // åŠ è½½äº‹ä»¶
    public List<DomainEvent> loadEvents(Long aggregateId) {
        List<EventEntity> entities = repository.findByAggregateId(aggregateId);
        
        return entities.stream()
            .map(this::deserializeEvent)
            .collect(Collectors.toList());
    }
}

// 4. åº”ç”¨æœåŠ¡
@Service
public class AccountService {
    
    @Autowired
    private EventStore eventStore;
    
    public void deposit(Long accountId, BigDecimal amount) {
        // 1. åŠ è½½å†å²äº‹ä»¶
        List<DomainEvent> events = eventStore.loadEvents(accountId);
        
        // 2. é‡å»ºè´¦æˆ·çŠ¶æ€
        Account account = Account.fromEvents(accountId, events);
        
        // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        account.deposit(amount);
        
        // 4. ä¿å­˜æ–°äº‹ä»¶
        for (DomainEvent event : account.getChanges()) {
            eventStore.save(event);
        }
    }
}
```

### 5.3 äº‹ä»¶æº¯æºçš„ä¼˜åŠ¿


```
âœ… æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. å®Œæ•´çš„å®¡è®¡æ—¥å¿—
   - æ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•
   - å¯ä»¥è¿½æº¯ä»»æ„æ—¶åˆ»çš„çŠ¶æ€
   
2. æ—¶é—´æ—…è¡Œ
   - å¯ä»¥å›åˆ°è¿‡å»ä»»æ„æ—¶é—´ç‚¹
   - é‡ç°å½“æ—¶çš„ä¸šåŠ¡çŠ¶æ€

3. äº‹ä»¶é‡æ”¾
   - å¯ä»¥é‡æ–°è®¡ç®—
   - ä¿®å¤å†å²bug

4. åˆ†æä¸æ´å¯Ÿ
   - å¯ä»¥åˆ†æç”¨æˆ·è¡Œä¸º
   - å‘ç°ä¸šåŠ¡æ¨¡å¼

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š

1. å­˜å‚¨å¼€é”€å¤§
2. æŸ¥è¯¢æ€§èƒ½å¯èƒ½è¾ƒå·®ï¼ˆéœ€è¦å›æ”¾ï¼‰
3. äº‹ä»¶ç‰ˆæœ¬ç®¡ç†å¤æ‚
4. é€‚åˆæ ¸å¿ƒé¢†åŸŸæ¨¡å‹ï¼Œä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦
```

---

## 6. ğŸ”„ Sagaåˆ†å¸ƒå¼äº‹åŠ¡


### 6.1 Sagaæ¨¡å¼ä»‹ç»


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> æ—…è¡Œé¢„å®šï¼šå…ˆè®¢æœºç¥¨ã€å†è®¢é…’åº—ã€æœ€åç§Ÿè½¦ã€‚å¦‚æœç§Ÿè½¦å¤±è´¥ï¼Œéœ€è¦é€€é…’åº—ã€é€€æœºç¥¨ã€‚Sagaå°±æ˜¯ç®¡ç†è¿™ä¸€ç³»åˆ—æ­¥éª¤çš„åè°ƒè€…ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š
```
Sagaæ¨¡å¼ï¼šå°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´æ€§

æ™®é€šäº‹åŠ¡ï¼ˆå¼ºä¸€è‡´ï¼‰ï¼š
å¼€å§‹äº‹åŠ¡
  æ‰§è¡Œæ­¥éª¤1
  æ‰§è¡Œæ­¥éª¤2    å…¨éƒ¨æˆåŠŸæ‰æäº¤
  æ‰§è¡Œæ­¥éª¤3    ä»»ä¸€å¤±è´¥å…¨éƒ¨å›æ»š
æäº¤/å›æ»š

Sagaäº‹åŠ¡ï¼ˆæœ€ç»ˆä¸€è‡´ï¼‰ï¼š
æ‰§è¡Œæ­¥éª¤1 â†’ æˆåŠŸæäº¤
æ‰§è¡Œæ­¥éª¤2 â†’ æˆåŠŸæäº¤  
æ‰§è¡Œæ­¥éª¤3 â†’ å¤±è´¥ â†’ è¡¥å¿æ­¥éª¤2 â†’ è¡¥å¿æ­¥éª¤1
```

### 6.2 Sagaçš„ä¸¤ç§å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šç¼–æ’å¼Sagaï¼ˆOrchestrationï¼‰**

```
è®¢å•æœåŠ¡ï¼ˆåè°ƒè€…ï¼‰
    â†“
 [1]åˆ›å»ºè®¢å•
    â†“
 [2]è°ƒç”¨åº“å­˜æœåŠ¡ â†’ æ‰£å‡åº“å­˜
    â†“
 [3]è°ƒç”¨æ”¯ä»˜æœåŠ¡ â†’ æ‰£æ¬¾
    â†“
 [4]è°ƒç”¨ç§¯åˆ†æœåŠ¡ â†’ å¢åŠ ç§¯åˆ†
    â†“
 [5]å®Œæˆè®¢å•

å¦‚æœ[3]å¤±è´¥ï¼š
    â†“
å›æ»š[2] â†’ æ¢å¤åº“å­˜
    â†“
å›æ»š[1] â†’ å–æ¶ˆè®¢å•
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderSagaOrchestrator {
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private PointsService pointsService;
    
    public OrderResult executeOrderSaga(OrderRequest request) {
        String sagaId = UUID.randomUUID().toString();
        List<String> completedSteps = new ArrayList<>();
        
        try {
            // æ­¥éª¤1ï¼šæ‰£å‡åº“å­˜
            inventoryService.deductStock(request.getProductId(), request.getQuantity());
            completedSteps.add("inventory");
            
            // æ­¥éª¤2ï¼šæ‰£æ¬¾æ”¯ä»˜
            paymentService.charge(request.getUserId(), request.getAmount());
            completedSteps.add("payment");
            
            // æ­¥éª¤3ï¼šå¢åŠ ç§¯åˆ†
            pointsService.addPoints(request.getUserId(), request.getPoints());
            completedSteps.add("points");
            
            // å…¨éƒ¨æˆåŠŸ
            return OrderResult.success();
            
        } catch (Exception e) {
            // å¤±è´¥ï¼Œæ‰§è¡Œè¡¥å¿
            compensate(completedSteps, request);
            return OrderResult.failure(e.getMessage());
        }
    }
    
    private void compensate(List<String> completedSteps, OrderRequest request) {
        // é€†åºè¡¥å¿
        Collections.reverse(completedSteps);
        
        for (String step : completedSteps) {
            try {
                switch (step) {
                    case "inventory":
                        inventoryService.restoreStock(request.getProductId(), 
                                                     request.getQuantity());
                        break;
                    case "payment":
                        paymentService.refund(request.getUserId(), 
                                            request.getAmount());
                        break;
                    case "points":
                        pointsService.deductPoints(request.getUserId(), 
                                                  request.getPoints());
                        break;
                }
            } catch (Exception e) {
                // è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ï¼Œäººå·¥ä»‹å…¥
                log.error("è¡¥å¿å¤±è´¥: step={}, error={}", step, e.getMessage());
            }
        }
    }
}
```

**æ–¹å¼äºŒï¼šååŒå¼Sagaï¼ˆChoreographyï¼‰**

```
å„æœåŠ¡é€šè¿‡äº‹ä»¶ååŒï¼Œæ²¡æœ‰ä¸­å¿ƒåè°ƒè€…

è®¢å•æœåŠ¡
  â†“ å‘å¸ƒäº‹ä»¶ï¼šOrderCreated
åº“å­˜æœåŠ¡ï¼ˆç›‘å¬ï¼‰
  â†“ æ‰£å‡åº“å­˜ â†’ å‘å¸ƒäº‹ä»¶ï¼šStockDeducted
æ”¯ä»˜æœåŠ¡ï¼ˆç›‘å¬ï¼‰
  â†“ æ‰£æ¬¾ â†’ å‘å¸ƒäº‹ä»¶ï¼šPaymentCompleted
ç§¯åˆ†æœåŠ¡ï¼ˆç›‘å¬ï¼‰
  â†“ å¢åŠ ç§¯åˆ† â†’ å‘å¸ƒäº‹ä»¶ï¼šPointsAdded

å¦‚æœæ”¯ä»˜å¤±è´¥ï¼š
  â†“ å‘å¸ƒäº‹ä»¶ï¼šPaymentFailed
åº“å­˜æœåŠ¡ï¼ˆç›‘å¬ï¼‰
  â†“ æ¢å¤åº“å­˜
è®¢å•æœåŠ¡ï¼ˆç›‘å¬ï¼‰
  â†“ å–æ¶ˆè®¢å•
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = new Order(request);
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶
        eventPublisher.publishEvent(
            new OrderCreatedEvent(order.getId(), request)
        );
    }
    
    // ç›‘å¬æ”¯ä»˜å¤±è´¥äº‹ä»¶
    @EventListener
    public void handlePaymentFailed(PaymentFailedEvent event) {
        // å–æ¶ˆè®¢å•
        Order order = orderRepository.findById(event.getOrderId());
        order.cancel();
        orderRepository.save(order);
    }
}

// åº“å­˜æœåŠ¡
@Service
public class InventoryService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    // ç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            deductStock(event.getProductId(), event.getQuantity());
            
            // å‘å¸ƒæˆåŠŸäº‹ä»¶
            eventPublisher.publishEvent(
                new StockDeductedEvent(event.getOrderId())
            );
        } catch (Exception e) {
            // å‘å¸ƒå¤±è´¥äº‹ä»¶
            eventPublisher.publishEvent(
                new StockDeductionFailedEvent(event.getOrderId())
            );
        }
    }
    
    // ç›‘å¬æ”¯ä»˜å¤±è´¥äº‹ä»¶
    @EventListener
    public void handlePaymentFailed(PaymentFailedEvent event) {
        // æ¢å¤åº“å­˜
        restoreStock(event.getProductId(), event.getQuantity());
    }
}
```

### 6.3 ä¸¤ç§æ–¹å¼å¯¹æ¯”


| ç‰¹æ€§ | **ç¼–æ’å¼Saga** | **ååŒå¼Saga** |
|-----|---------------|---------------|
| ğŸ¯ **æ§åˆ¶æ–¹å¼** | `ä¸­å¿ƒåè°ƒå™¨` | `äº‹ä»¶é©±åŠ¨` |
| ğŸ”§ **å¤æ‚åº¦** | `é›†ä¸­å¤æ‚` | `åˆ†æ•£å¤æ‚` |
| ğŸ“Š **å¯è§†åŒ–** | `æµç¨‹æ¸…æ™°` | `è¾ƒéš¾ç†è§£` |
| ğŸ”„ **è€¦åˆåº¦** | `è¾ƒé«˜` | `è¾ƒä½` |
| âš¡ **é€‚ç”¨åœºæ™¯** | `æµç¨‹å›ºå®š` | `æµç¨‹çµæ´»` |

---

## 7. âš–ï¸ è¡¥å¿äº‹åŠ¡æœºåˆ¶


### 7.1 è¡¥å¿æœºåˆ¶è®¾è®¡åŸåˆ™


> âš ï¸ **é‡è¦æ¦‚å¿µ**  
> è¡¥å¿ä¸æ˜¯å›æ»šï¼ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡å¯ä»¥å›æ»šï¼ˆæ’¤é”€ï¼‰ï¼Œä½†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå·²æäº¤çš„äº‹åŠ¡æ— æ³•æ’¤é”€ï¼Œåªèƒ½é€šè¿‡è¡¥å¿æ“ä½œæ¥æŠµæ¶ˆå½±å“ã€‚

**è¡¥å¿vså›æ»š**ï¼š

```
æ•°æ®åº“å›æ»šï¼ˆACIDäº‹åŠ¡ï¼‰ï¼š
  æ‰£æ¬¾100å…ƒ â†’ å¤±è´¥ â†’ [æ’¤é”€]æ‰£æ¬¾ â†’ å¥½åƒæ²¡å‘ç”Ÿè¿‡

åˆ†å¸ƒå¼è¡¥å¿ï¼ˆSagaï¼‰ï¼š
  æ‰£æ¬¾100å…ƒ â†’ [å·²æäº¤] â†’ å¤±è´¥ â†’ é€€æ¬¾100å…ƒ â†’ æœ€ç»ˆä½™é¢ä¸å˜
  ï¼ˆä¸¤ç¬”è®°å½•éƒ½å­˜åœ¨ï¼‰
```

### 7.2 è¡¥å¿æ“ä½œè®¾è®¡


**è¡¥å¿æ“ä½œçš„ç‰¹ç‚¹**ï¼š

```
âœ… è¡¥å¿å¿…é¡»æ»¡è¶³ï¼š

1. å¹‚ç­‰æ€§
   - å¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
   - é˜²æ­¢é‡å¤è¡¥å¿

2. å¯é‡è¯•
   - è¡¥å¿å¤±è´¥å¯ä»¥é‡è¯•
   - æœ€ç»ˆèƒ½å¤ŸæˆåŠŸ

3. ä¸šåŠ¡é€»è¾‘å®Œæ•´
   - ä¸åªæ˜¯æ•°æ®å›æ»š
   - è¦è€ƒè™‘ä¸šåŠ¡è¯­ä¹‰
```

**è¡¥å¿æ–¹æ³•è®¾è®¡ç¤ºä¾‹**ï¼š

```java
@Service
public class PaymentService {
    
    // æ­£å‘æ“ä½œï¼šæ‰£æ¬¾
    @Transactional
    public PaymentResult charge(Long userId, BigDecimal amount) {
        Account account = accountRepository.findByUserId(userId);
        
        // æ£€æŸ¥ä½™é¢
        if (account.getBalance().compareTo(amount) < 0) {
            throw new InsufficientBalanceException();
        }
        
        // æ‰£æ¬¾
        account.setBalance(account.getBalance().subtract(amount));
        accountRepository.save(account);
        
        // è®°å½•æµæ°´ï¼ˆé‡è¦ï¼ï¼‰
        Transaction tx = new Transaction();
        tx.setUserId(userId);
        tx.setAmount(amount);
tx.setType("CHARGE");
        tx.setStatus("SUCCESS");
        transactionRepository.save(tx);
        
        return new PaymentResult(tx.getId(), "SUCCESS");
    }
    
    // è¡¥å¿æ“ä½œï¼šé€€æ¬¾
    @Transactional
    public void refund(Long userId, BigDecimal amount) {
        // å¹‚ç­‰æ€§æ£€æŸ¥ï¼šé¿å…é‡å¤é€€æ¬¾
        String idempotencyKey = "refund_" + userId + "_" + amount;
        if (refundLogRepository.existsByKey(idempotencyKey)) {
            log.warn("é‡å¤é€€æ¬¾è¯·æ±‚ï¼Œå¿½ç•¥: {}", idempotencyKey);
            return;
        }
        
        Account account = accountRepository.findByUserId(userId);
        
        // é€€æ¬¾
        account.setBalance(account.getBalance().add(amount));
        accountRepository.save(account);
        
        // è®°å½•é€€æ¬¾æµæ°´
        Transaction tx = new Transaction();
        tx.setUserId(userId);
        tx.setAmount(amount);
        tx.setType("REFUND");
        tx.setStatus("SUCCESS");
        transactionRepository.save(tx);
        
        // è®°å½•å¹‚ç­‰æ—¥å¿—
        RefundLog log = new RefundLog();
        log.setIdempotencyKey(idempotencyKey);
        log.setTransactionId(tx.getId());
        refundLogRepository.save(log);
    }
}
```

### 7.3 è¡¥å¿å¤±è´¥å¤„ç†


**å¤±è´¥å¤„ç†ç­–ç•¥**ï¼š

```
è¡¥å¿å¤±è´¥çš„å¤„ç†æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨é‡è¯•
ç¬¬1æ¬¡å¤±è´¥ â†’ ç­‰å¾…5ç§’ â†’ é‡è¯•
ç¬¬2æ¬¡å¤±è´¥ â†’ ç­‰å¾…30ç§’ â†’ é‡è¯•
ç¬¬3æ¬¡å¤±è´¥ â†’ ç­‰å¾…5åˆ†é’Ÿ â†’ é‡è¯•
è¶…è¿‡3æ¬¡ â†’ è¿›å…¥æ–¹æ¡ˆ2

æ–¹æ¡ˆ2ï¼šäººå·¥ä»‹å…¥
è®°å½•åˆ°è¡¥å¿å¤±è´¥è¡¨ â†’ å‘é€å‘Šè­¦ â†’ äººå·¥å¤„ç†

æ–¹æ¡ˆ3ï¼šæœ€ç»ˆä¸€è‡´æ€§ä¿è¯
å®šæ—¶æ‰«ææœªå®Œæˆçš„è¡¥å¿ â†’ ç»§ç»­é‡è¯•
```

**ä»£ç å®ç°**ï¼š

```java
@Service
public class CompensationService {
    
    @Autowired
    private PaymentService paymentService;
    
    // å¸¦é‡è¯•çš„è¡¥å¿
    @Retryable(
        value = {Exception.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 5000, multiplier = 6)
    )
    public void compensateWithRetry(Long userId, BigDecimal amount) {
        try {
            paymentService.refund(userId, amount);
        } catch (Exception e) {
            log.error("è¡¥å¿å¤±è´¥: userId={}, amount={}", userId, amount, e);
            throw e;  // è§¦å‘é‡è¯•
        }
    }
    
    // é‡è¯•è€—å°½åçš„å¤„ç†
    @Recover
    public void recover(Exception e, Long userId, BigDecimal amount) {
        // è®°å½•åˆ°å¤±è´¥è¡¨
        CompensationFailureLog failureLog = new CompensationFailureLog();
        failureLog.setUserId(userId);
        failureLog.setAmount(amount);
        failureLog.setError(e.getMessage());
        failureLog.setStatus("PENDING_MANUAL");
        failureLogRepository.save(failureLog);
        
        // å‘é€å‘Šè­¦
        alertService.sendAlert("è¡¥å¿å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†", failureLog);
    }
    
    // å®šæ—¶ä»»åŠ¡ï¼šé‡æ–°å°è¯•å¤±è´¥çš„è¡¥å¿
    @Scheduled(fixedRate = 300000)  // æ¯5åˆ†é’Ÿ
    public void retryFailedCompensations() {
        List<CompensationFailureLog> failedLogs = 
            failureLogRepository.findByStatus("PENDING_MANUAL");
        
        for (CompensationFailureLog log : failedLogs) {
            try {
                paymentService.refund(log.getUserId(), log.getAmount());
                log.setStatus("COMPENSATED");
                failureLogRepository.save(log);
            } catch (Exception e) {
                log.setRetryCount(log.getRetryCount() + 1);
                failureLogRepository.save(log);
            }
        }
    }
}
```

---

## 8. ğŸ¯ æœ€ç»ˆä¸€è‡´æ€§ä¿è¯


### 8.1 ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> è½¬è´¦ï¼šä½ çš„è´¦æˆ·ç«‹å³æ‰£æ¬¾ï¼Œå¯¹æ–¹è´¦æˆ·å¯èƒ½å‡ ç§’åæ‰åˆ°è´¦ã€‚çŸ­æš‚ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šä¸€è‡´ã€‚è¿™å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§ã€‚

**ä¸€è‡´æ€§çº§åˆ«å¯¹æ¯”**ï¼š

```
å¼ºä¸€è‡´æ€§ï¼ˆä¼ ç»Ÿæ•°æ®åº“ï¼‰ï¼š
æ—¶åˆ»1ï¼šAè´¦æˆ·1000å…ƒï¼ŒBè´¦æˆ·500å…ƒ
è½¬è´¦100å…ƒ...
æ—¶åˆ»2ï¼šAè´¦æˆ·900å…ƒï¼ŒBè´¦æˆ·600å…ƒ
      â†‘ ä»»ä½•æ—¶åˆ»æŸ¥è¯¢éƒ½æ˜¯ä¸€è‡´çš„

æœ€ç»ˆä¸€è‡´æ€§ï¼ˆåˆ†å¸ƒå¼ç³»ç»Ÿï¼‰ï¼š
æ—¶åˆ»1ï¼šAè´¦æˆ·1000å…ƒï¼ŒBè´¦æˆ·500å…ƒ
è½¬è´¦100å…ƒ...
æ—¶åˆ»2ï¼šAè´¦æˆ·900å…ƒï¼ŒBè´¦æˆ·500å…ƒ â† çŸ­æš‚ä¸ä¸€è‡´
æ—¶åˆ»3ï¼šAè´¦æˆ·900å…ƒï¼ŒBè´¦æˆ·600å…ƒ â† æœ€ç»ˆä¸€è‡´
```

### 8.2 å®ç°æœ€ç»ˆä¸€è‡´æ€§çš„æ¨¡å¼


**æ¨¡å¼ä¸€ï¼šå¯é äº‹ä»¶æ¨¡å¼**

```
æµç¨‹è®¾è®¡ï¼š
1. æœ¬åœ°äº‹åŠ¡ + äº‹ä»¶è¡¨
2. å®šæ—¶å‘é€äº‹ä»¶
3. æ¶ˆè´¹è€…å¤„ç†
4. ç¡®è®¤å¤„ç†æˆåŠŸ

å…·ä½“æ­¥éª¤ï¼š
è®¢å•æœåŠ¡ï¼š
  å¼€å§‹æœ¬åœ°äº‹åŠ¡
    åˆ›å»ºè®¢å•
    æ’å…¥äº‹ä»¶è¡¨ï¼ˆOrderCreatedäº‹ä»¶ï¼‰
  æäº¤äº‹åŠ¡

å®šæ—¶ä»»åŠ¡ï¼š
  æ‰«æäº‹ä»¶è¡¨
  å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
  æ ‡è®°å·²å‘é€

ç§¯åˆ†æœåŠ¡ï¼š
  æ¥æ”¶äº‹ä»¶
  å¢åŠ ç§¯åˆ†
  è¿”å›ACK
```

**ä»£ç å®ç°**ï¼š

```java
// 1. æœ¬åœ°äº‹åŠ¡ + äº‹ä»¶è¡¨
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private EventOutboxRepository outboxRepository;
    
    @Transactional
    public void createOrder(OrderRequest request) {
        // ä¸šåŠ¡æ“ä½œ
        Order order = new Order(request);
        orderRepository.save(order);
        
        // ä¿å­˜äº‹ä»¶åˆ°outboxè¡¨ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
        EventOutbox event = new EventOutbox();
        event.setAggregateId(order.getId());
        event.setEventType("OrderCreated");
        event.setEventData(JSON.toJSONString(order));
        event.setStatus("PENDING");
        outboxRepository.save(event);
        
        // æäº¤äº‹åŠ¡ï¼ˆè®¢å•å’Œäº‹ä»¶éƒ½æˆåŠŸä¿å­˜ï¼‰
    }
}

// 2. å®šæ—¶ä»»åŠ¡å‘é€äº‹ä»¶
@Component
public class EventPublisher {
    
    @Autowired
    private EventOutboxRepository outboxRepository;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Scheduled(fixedRate = 5000)  // æ¯5ç§’
    public void publishEvents() {
        // æŸ¥è¯¢æœªå‘é€çš„äº‹ä»¶
        List<EventOutbox> events = 
            outboxRepository.findByStatus("PENDING");
        
        for (EventOutbox event : events) {
            try {
                // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
                rabbitTemplate.convertAndSend(
                    "order.events",
                    event.getEventType(),
                    event.getEventData()
                );
                
                // æ ‡è®°å·²å‘é€
                event.setStatus("PUBLISHED");
                outboxRepository.save(event);
                
            } catch (Exception e) {
                log.error("å‘é€äº‹ä»¶å¤±è´¥: {}", event.getId(), e);
                // ä¸‹æ¬¡ç»§ç»­é‡è¯•
            }
        }
    }
}

// 3. æ¶ˆè´¹è€…å¤„ç†
@Component
public class PointsEventConsumer {
    
    @Autowired
    private PointsService pointsService;
    
    @RabbitListener(queues = "order.events")
    public void handleOrderCreated(String eventData) {
        try {
            OrderCreatedEvent event = JSON.parseObject(eventData, 
                                                       OrderCreatedEvent.class);
            
            // å¹‚ç­‰æ€§æ£€æŸ¥
            if (pointsService.isProcessed(event.getOrderId())) {
                return;  // å·²å¤„ç†è¿‡ï¼Œè·³è¿‡
            }
            
            // å¢åŠ ç§¯åˆ†
            pointsService.addPoints(event.getUserId(), event.getPoints());
            
            // è®°å½•å·²å¤„ç†
            pointsService.markProcessed(event.getOrderId());
            
        } catch (Exception e) {
            log.error("å¤„ç†äº‹ä»¶å¤±è´¥", e);
            throw new AmqpRejectAndDontRequeueException(e);  // é‡è¯•
        }
    }
}
```

**æ¨¡å¼äºŒï¼šTCCï¼ˆTry-Confirm-Cancelï¼‰**

```
ä¸‰é˜¶æ®µæäº¤ï¼š

é˜¶æ®µ1 - Tryï¼ˆé¢„ç•™ï¼‰ï¼š
  é¢„ç•™èµ„æºï¼Œä½†ä¸æäº¤
  åº“å­˜æœåŠ¡ï¼šå†»ç»“åº“å­˜
  æ”¯ä»˜æœåŠ¡ï¼šå†»ç»“é‡‘é¢

é˜¶æ®µ2 - Confirmï¼ˆç¡®è®¤ï¼‰ï¼š
  ç¡®è®¤æäº¤æ‰€æœ‰æ“ä½œ
  åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜
  æ”¯ä»˜æœåŠ¡ï¼šæ‰£æ¬¾

é˜¶æ®µ3 - Cancelï¼ˆå–æ¶ˆï¼‰ï¼š
  å¦‚æœå¤±è´¥ï¼Œå–æ¶ˆé¢„ç•™
  åº“å­˜æœåŠ¡ï¼šè§£å†»åº“å­˜
  æ”¯ä»˜æœåŠ¡ï¼šè§£å†»é‡‘é¢
```

**TCCå®ç°**ï¼š

```java
// åº“å­˜æœåŠ¡çš„TCCå®ç°
@Service
public class InventoryTccService {
    
    // Tryï¼šé¢„ç•™åº“å­˜
    @Transactional
    public boolean tryReserve(Long productId, int quantity, String txId) {
        Product product = productRepository.findById(productId);
        
        if (product.getAvailableStock() < quantity) {
            return false;  // åº“å­˜ä¸è¶³
        }
        
        // å†»ç»“åº“å­˜
        product.setAvailableStock(product.getAvailableStock() - quantity);
        product.setFrozenStock(product.getFrozenStock() + quantity);
        productRepository.save(product);
        
        // è®°å½•é¢„ç•™
        Reservation reservation = new Reservation();
        reservation.setTxId(txId);
        reservation.setProductId(productId);
        reservation.setQuantity(quantity);
        reservation.setStatus("RESERVED");
        reservationRepository.save(reservation);
        
        return true;
    }
    
    // Confirmï¼šç¡®è®¤æ‰£å‡
    @Transactional
    public void confirm(String txId) {
        Reservation reservation = reservationRepository.findByTxId(txId);
        
        Product product = productRepository.findById(reservation.getProductId());
        
        // æ‰£å‡å†»ç»“åº“å­˜
        product.setFrozenStock(product.getFrozenStock() - reservation.getQuantity());
        productRepository.save(product);
        
        // æ ‡è®°ç¡®è®¤
        reservation.setStatus("CONFIRMED");
        reservationRepository.save(reservation);
    }
    
    // Cancelï¼šå–æ¶ˆé¢„ç•™
    @Transactional
    public void cancel(String txId) {
        Reservation reservation = reservationRepository.findByTxId(txId);
        
        Product product = productRepository.findById(reservation.getProductId());
        
        // æ¢å¤åº“å­˜
        product.setAvailableStock(product.getAvailableStock() + reservation.getQuantity());
        product.setFrozenStock(product.getFrozenStock() - reservation.getQuantity());
        productRepository.save(product);
        
        // æ ‡è®°å–æ¶ˆ
        reservation.setStatus("CANCELLED");
        reservationRepository.save(reservation);
    }
}

// TCCåè°ƒå™¨
@Service
public class TccCoordinator {
    
    @Autowired
    private InventoryTccService inventoryTcc;
    
    @Autowired
    private PaymentTccService paymentTcc;
    
    public OrderResult executeOrder(OrderRequest request) {
        String txId = UUID.randomUUID().toString();
        
        try {
            // Phase 1: Try
            if (!inventoryTcc.tryReserve(request.getProductId(), 
                                         request.getQuantity(), txId)) {
                return OrderResult.failure("åº“å­˜ä¸è¶³");
            }
            
            if (!paymentTcc.tryFreeze(request.getUserId(), 
                                      request.getAmount(), txId)) {
                inventoryTcc.cancel(txId);
                return OrderResult.failure("ä½™é¢ä¸è¶³");
            }
            
            // Phase 2: Confirm
            inventoryTcc.confirm(txId);
            paymentTcc.confirm(txId);
            
            return OrderResult.success();
            
        } catch (Exception e) {
            // Phase 3: Cancel
            try {
                inventoryTcc.cancel(txId);
                paymentTcc.cancel(txId);
            } catch (Exception ce) {
                log.error("å–æ¶ˆå¤±è´¥", ce);
            }
            return OrderResult.failure(e.getMessage());
        }
    }
}
```

### 8.3 æœ€ç»ˆä¸€è‡´æ€§çš„ç›‘æ§


**ç›‘æ§æŒ‡æ ‡**ï¼š

```
ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š

1. äº‹ä»¶å¤„ç†å»¶è¿Ÿ
   - äº‹ä»¶å‘å¸ƒåˆ°å¤„ç†çš„æ—¶é—´
   - ç›®æ ‡ï¼š< 5ç§’

2. è¡¥å¿æˆåŠŸç‡
   - è¡¥å¿æ“ä½œæˆåŠŸæ¬¡æ•°/æ€»æ¬¡æ•°
   - ç›®æ ‡ï¼š> 99%

3. ä¸€è‡´æ€§æ—¶é—´çª—å£
   - ä»ä¸ä¸€è‡´åˆ°æœ€ç»ˆä¸€è‡´çš„æ—¶é—´
   - ç›®æ ‡ï¼š< 10ç§’

4. äººå·¥ä»‹å…¥æ¬¡æ•°
   - éœ€è¦äººå·¥å¤„ç†çš„å¼‚å¸¸
   - ç›®æ ‡ï¼š< 0.1%
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 æ··åˆé€šä¿¡æ¨¡å¼é€‰æ‹©æŒ‡å—


```
ğŸ¯ åœºæ™¯å†³ç­–æ ‘ï¼š

éœ€è¦ç«‹å³å“åº”ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨åŒæ­¥è°ƒç”¨ï¼ˆREST/gRPCï¼‰
  â””â”€ å¦ â†’ ä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯ï¼ˆMQï¼‰

æ•°æ®é‡å¤§ä¸”æŸ¥è¯¢é¢‘ç¹ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ è¯»å†™åˆ†ç¦» + CQRS
  â””â”€ å¦ â†’ æ™®é€šæ¨¡å¼

éœ€è¦å®Œæ•´å®¡è®¡æ—¥å¿—ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ äº‹ä»¶æº¯æº
  â””â”€ å¦ â†’ ä¼ ç»Ÿå­˜å‚¨

è·¨å¤šä¸ªæœåŠ¡çš„äº‹åŠ¡ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ Sagaæ¨¡å¼
  â”‚      â”œâ”€ æµç¨‹å›ºå®š â†’ ç¼–æ’å¼
  â”‚      â””â”€ æµç¨‹çµæ´» â†’ ååŒå¼
  â””â”€ å¦ â†’ æœ¬åœ°äº‹åŠ¡
```

### 9.2 å„æ¨¡å¼å¯¹æ¯”æ€»ç»“


| æ¨¡å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **å¤æ‚åº¦** | **ä¸€è‡´æ€§** |
|-----|------------|---------|-----------|-----------|
| ğŸ”„ **åŒæ­¥å¼‚æ­¥ç»“åˆ** | `é€šç”¨åœºæ™¯` | `çµæ´»å‡è¡¡` | â­â­ | `å¯æ§` |
| ğŸ“– **è¯»å†™åˆ†ç¦»** | `è¯»å¤šå†™å°‘` | `æ€§èƒ½ä¼˜åŒ–` | â­â­â­ | `æœ€ç»ˆä¸€è‡´` |
| ğŸ¨ **CQRS** | `å¤æ‚æŸ¥è¯¢` | `å„è‡ªä¼˜åŒ–` | â­â­â­â­ | `æœ€ç»ˆä¸€è‡´` |
| ğŸ“œ **äº‹ä»¶æº¯æº** | `å®¡è®¡éœ€æ±‚` | `å®Œæ•´å†å²` | â­â­â­â­â­ | `äº‹ä»¶å›æ”¾` |
| ğŸ”„ **Saga** | `åˆ†å¸ƒå¼äº‹åŠ¡` | `æœåŠ¡è§£è€¦` | â­â­â­â­ | `æœ€ç»ˆä¸€è‡´` |

### 9.3 å®è·µå»ºè®®


```
ğŸ’¡ æ–°æ‰‹å…¥é—¨è·¯å¾„ï¼š

ç¬¬1æ­¥ï¼šåŒæ­¥å¼‚æ­¥ç»“åˆ
- æœ€å®¹æ˜“ç†è§£å’Œå®ç°
- é€‚åˆå¤§å¤šæ•°åœºæ™¯
- å…ˆæŒæ¡å¥½åŸºç¡€

ç¬¬2æ­¥ï¼šè¯»å†™åˆ†ç¦»
- åœ¨ç¬¬1æ­¥åŸºç¡€ä¸Šä¼˜åŒ–
- è§£å†³æ€§èƒ½ç“¶é¢ˆ
- å¼•å…¥ç¼“å­˜ç­–ç•¥

ç¬¬3æ­¥ï¼šSagaåˆ†å¸ƒå¼äº‹åŠ¡
- è§£å†³è·¨æœåŠ¡äº‹åŠ¡é—®é¢˜
- å…ˆç”¨ç¼–æ’å¼ï¼ˆæ›´ç›´è§‚ï¼‰
- ç†è§£è¡¥å¿æœºåˆ¶

ç¬¬4æ­¥ï¼šCQRSå’Œäº‹ä»¶æº¯æº
- è§£å†³å¤æ‚ä¸šåŠ¡åœºæ™¯
- éœ€è¦å›¢é˜Ÿç»éªŒæ”¯æ’‘
- è°¨æ…ä½¿ç”¨ï¼Œä¸è¦è¿‡åº¦è®¾è®¡
```

### 9.4 å¸¸è§é™·é˜±ä¸é¿å‘


```
âš ï¸ å¸¸è§é”™è¯¯ï¼š

1. è¿‡åº¦è®¾è®¡
   âŒ ç®€å•CRUDä¹Ÿç”¨CQRS
   âœ… æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©

2. å¿½ç•¥å¹‚ç­‰æ€§
   âŒ é‡å¤æ¶ˆæ¯å¯¼è‡´æ•°æ®é”™è¯¯
   âœ… æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½è¦å¹‚ç­‰

3. è¡¥å¿ä¸å®Œæ•´
   âŒ åªå›æ»šæ•°æ®ï¼Œä¸è€ƒè™‘ä¸šåŠ¡è¯­ä¹‰
   âœ… è®¾è®¡å®Œæ•´çš„è¡¥å¿é€»è¾‘

4. ç¼ºå°‘ç›‘æ§
   âŒ å‡ºé—®é¢˜æ‰å‘ç°
   âœ… æå‰ç›‘æ§å…³é”®æŒ‡æ ‡

5. å¿½ç•¥å¤±è´¥åœºæ™¯
   âŒ åªè€ƒè™‘æ­£å¸¸æµç¨‹
   âœ… è®¾è®¡å¤±è´¥é‡è¯•å’Œé™çº§
```

### 9.5 æ ¸å¿ƒè®°å¿†è¦ç‚¹


> ğŸ§  **è®°å¿†å£è¯€**  
> åŒæ­¥å¿«é€Ÿç«‹å³åº”ï¼Œå¼‚æ­¥è§£è€¦å‰Šå³°å¿™  
> è¯»å†™åˆ†ç¦»æŸ¥è¯¢å¿«ï¼ŒCQRSæ¨¡å‹å„ä¼˜åŒ–  
> äº‹ä»¶æº¯æºè®°å†å²ï¼ŒSagaäº‹åŠ¡ä¿ä¸€è‡´  
> è¡¥å¿æœºåˆ¶è¦å¹‚ç­‰ï¼Œæœ€ç»ˆä¸€è‡´æ˜¯ç›®æ ‡

**å…³é”®æ¦‚å¿µé€Ÿè®°**ï¼š
- **æ··åˆæ¨¡å¼** = åŒæ­¥ + å¼‚æ­¥ï¼Œä¼˜åŠ¿äº’è¡¥
- **è¯»å†™åˆ†ç¦»** = æŸ¥è¯¢ä¼˜åŒ– + å†™å…¥ä¿è¯
- **CQRS** = å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»ï¼Œæ¨¡å‹ç‹¬ç«‹
- **äº‹ä»¶æº¯æº** = å­˜å‚¨äº‹ä»¶ï¼Œå›æ”¾çŠ¶æ€
- **Saga** = æœ¬åœ°äº‹åŠ¡ + è¡¥å¿æœºåˆ¶
- **æœ€ç»ˆä¸€è‡´** = çŸ­æš‚ä¸ä¸€è‡´ï¼Œæœ€ç»ˆæ”¶æ•›

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> æ··åˆé€šä¿¡æ¨¡å¼æ˜¯å¾®æœåŠ¡æ¶æ„çš„è¿›é˜¶å†…å®¹ï¼Œå»ºè®®å…ˆæŒæ¡åŸºç¡€çš„åŒæ­¥å’Œå¼‚æ­¥é€šä¿¡ï¼Œå†é€æ­¥å­¦ä¹ è¿™äº›é«˜çº§æ¨¡å¼ã€‚å®è·µä¸­è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æ¨¡å¼ï¼Œä¸è¦è¿‡åº¦è®¾è®¡ï¼Œä¿æŒç³»ç»Ÿçš„ç®€å•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚